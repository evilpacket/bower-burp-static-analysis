{
    "url": "http://localhost:9999/avoidwork/keigai/lib/keigai.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location.href</b> and written to <b>the 'href' property of a DOM element</b> via the following statements:<ul><li>uri = !server ? location.href : \"\";</li><li>obj.href = uri;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/avoidwork/keigai/lib/keigai.js",
                "path": "/avoidwork/keigai/lib/keigai.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9hdm9pZHdvcmsva2VpZ2FpL2xpYi9rZWlnYWkuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjM5MDYzDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA3OjU5OjE5IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwNzo1OToxOCBHTVQNCg0KLyoqCiAqIExpZ2h0d2VpZ2h0IGRhdGEgc3RvcmUgbGlicmFyeSwgd2l0aCBhIHV0aWxpdHkgYmVsdAogKgogKiBAYXV0aG9yIEphc29uIE11bGxpZ2FuIDxqYXNvbi5tdWxsaWdhbkBhdm9pZHdvcmsuY29tPgogKiBAY29weXJpZ2h0IDIwMTQgSmFzb24gTXVsbGlnYW4KICogQGxpY2Vuc2UgQlNELTMgPGh0dHBzOi8vcmF3LmdpdGh1Yi5jb20vYXZvaWR3b3JrL2tlaWdhaS9tYXN0ZXIvTElDRU5TRT4KICogQGxpbmsgaHR0cDovL2tlaWdhaS5pbwogKiBAbW9kdWxlIGtlaWdhaQogKiBAdmVyc2lvbiAwLjkuMAogKi8KKCBmdW5jdGlvbiAoIGdsb2JhbCApIHsKCnZhciBkb2N1bWVudCAgPSBnbG9iYWwuZG9jdW1lbnQsCiAgICBsb2NhdGlvbiAgPSBnbG9iYWwubG9jYXRpb24sCiAgICBuYXZpZ2F0b3IgPSBnbG9iYWwubmF2aWdhdG9yLAogICAgc2VydmVyICAgID0gdHlwZW9mIHByb2Nlc3MgIT0gInVuZGVmaW5lZCIsCiAgICB3ZWJXb3JrZXIgPSB0eXBlb2YgQmxvYiAhPSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgV29ya2VyICE9ICJ1bmRlZmluZWQiLAogICAgTUFYICAgICAgID0gMTAsCiAgICBWRVJTSU9OUyAgPSAxMDAsCiAgICBDQUNIRSAgICAgPSA1MDAsCiAgICBFVkVOVFMgICAgPSBbInJlYWR5c3RhdGVjaGFuZ2UiLCAiYWJvcnQiLCAibG9hZCIsICJsb2Fkc3RhcnQiLCAibG9hZGVuZCIsICJlcnJvciIsICJwcm9ncmVzcyIsICJ0aW1lb3V0Il0sCiAgICBmb3JtYXQsIGh0dHAsIGh0dHBzLCBsaWIsIG1vbmdvZGIsIHVybCwgUkVOREVSLCBUSU1FLCBXT1JLRVI7CgppZiAoIHNlcnZlciApIHsKCXVybCAgICAgPSByZXF1aXJlKCAidXJsIiApOwoJaHR0cCAgICA9IHJlcXVpcmUoICJodHRwIiApOwoJaHR0cHMgICA9IHJlcXVpcmUoICJodHRwcyIgKTsKCW1vbmdvZGIgPSByZXF1aXJlKCAibW9uZ29kYiIgKS5Nb25nb0NsaWVudDsKCWZvcm1hdCAgPSByZXF1aXJlKCAidXRpbCIgKS5mb3JtYXQ7CgoJaWYgKCB0eXBlb2YgUHJvbWlzZSA9PSAidW5kZWZpbmVkIiApIHsKCQlQcm9taXNlID0gcmVxdWlyZSggImVzNi1wcm9taXNlIiApLlByb21pc2U7Cgl9CgoJaWYgKCB0eXBlb2YgU3RvcmFnZSA9PSAidW5kZWZpbmVkIiApIHsKCQlsb2NhbFN0b3JhZ2UgPSByZXF1aXJlKCAibG9jYWxTdG9yYWdlIiApOwoJfQoKCWlmICggdHlwZW9mIFhNTEh0dHBSZXF1ZXN0ID09ICJ1bmRlZmluZWQiICkgewoJCVhNTEh0dHBSZXF1ZXN0ID0gbnVsbDsKCX0KCglpZiAoIHR5cGVvZiBidG9hID09ICJ1bmRlZmluZWQiICkgewoJCWJ0b2EgPSByZXF1aXJlKCAiYnRvYSIgKTsKCX0KfQplbHNlIGlmICggdHlwZW9mIEJ1ZmZlciA9PSAidW5kZWZpbmVkIiApIHsKCUJ1ZmZlciA9IGZ1bmN0aW9uICgpIHt9Owp9CgpsaWIgPSAoIGZ1bmN0aW9uICgpIHsKInVzZSBzdHJpY3QiOwoKdmFyIGV4dGVybmFsLCBoYXMsIHNsaWNlOwoKLyoqCiAqIFJlZ2V4IHBhdHRlcm5zIHVzZWQgdGhyb3VnaCBrZWlnYWkKICoKICogYHVybGAgd2FzIGF1dGhvcmVkIGJ5IERpZWdvIFBlcmluaQogKgogKiBAbmFtZXNwYWNlIHJlZ2V4CiAqIEBwcml2YXRlCiAqIEB0eXBlIHtPYmplY3R9CiAqLwp2YXIgcmVnZXggPSB7CglhZnRlcl9zcGFjZSAgICAgICAgICA6IC9ccysuKi8sCglhbGxvdyAgICAgICAgICAgICAgICA6IC9eYWxsb3ckL2ksCglhbGxvd19jb3JzICAgICAgICAgICA6IC9eYWNjZXNzLWNvbnRyb2wtYWxsb3ctbWV0aG9kcyQvaSwKCWFuZCAgICAgICAgICAgICAgICAgIDogL14mLywKCWFyZ3MgICAgICAgICAgICAgICAgIDogL1woKC4qKVwpLywKCWF1dGggICAgICAgICAgICAgICAgIDogL1wvXC8oLiopXEAvLAoJYm9vbCAgICAgICAgICAgICAgICAgOiAvXih0cnVlfGZhbHNlKT8kLywKCWNhcHMgICAgICAgICAgICAgICAgIDogL1tBLVpdLywKCWNkYXRhICAgICAgICAgICAgICAgIDogL1wmfDx8PnxcInxcJ3xcdHxccnxcbnxcQHxcJC8sCgljaGVja2VkX2Rpc2FibGVkICAgICA6IC9jaGVja2VkfGRpc2FibGVkL2ksCgljb21wbGV0ZV9sb2FkZWQgICAgICA6IC9eKGNvbXBsZXRlfGxvYWRlZCkkL2ksCgljc3ZfcXVvdGUgICAgICAgICAgICA6IC9eXHN8XCJ8XG58LHxccyQvLAoJZGVsICAgICAgICAgICAgICAgICAgOiAvXmRlbC8sCglkb21haW4gICAgICAgICAgICAgICA6IC9eW1x3Li1fXStcLltBLVphLXpdezIsfSQvLAoJZG93biAgICAgICAgICAgICAgICAgOiAvZG93bi8sCgllbmRzbGFzaCAgICAgICAgICAgICA6IC9cLyQvLAoJZW9sX25sICAgICAgICAgICAgICAgOiAvXG4kLywKCWVsZW1lbnRfdXBkYXRlICAgICAgIDogL2lkfGlubmVySFRNTHxpbm5lclRleHR8dGV4dENvbnRlbnR8dHlwZXxzcmMvLAoJZ2V0X2hlYWRlcnMgICAgICAgICAgOiAvXihoZWFkfGdldHxvcHRpb25zKSQvLAoJZ2V0X3JlbW92ZV9zZXQgICAgICAgOiAvZ2V0fHJlbW92ZXxzZXQvLAoJaGFzaCAgICAgICAgICAgICAgICAgOiAvXlwjLywKCWhlYWRlcl9yZXBsYWNlICAgICAgIDogLzouKi8sCgloZWFkZXJfdmFsdWVfcmVwbGFjZSA6IC8uKjpccysvLAoJaHRtbCAgICAgICAgICAgICAgICAgOiAvXjwuKj4kLywKCWh0dHBfYm9keSAgICAgICAgICAgIDogLzIwMHwyMDF8MjAyfDIwM3wyMDYvLAoJaHR0cF9wb3J0cyAgICAgICAgICAgOiAvODB8NDQzLywKCWllICAgICAgICAgICAgICAgICAgIDogL21zaWV8aWUvaSwKCWlwICAgICAgICAgICAgICAgICAgIDogL14oPzooPzoyNVswLTVdfDJbMC00XVswLTldfFswMV0/WzAtOV1bMC05XT8pXC4pezN9KD86MjVbMC01XXwyWzAtNF1bMC05XXxbMDFdP1swLTldWzAtOV0/KSQvLAoJaXNfeG1sICAgICAgICAgICAgICAgOiAvXjxcP3htbC4qXD8+LywKCWpzb25fbWF5YmUgICAgICAgICAgIDogL2pzb258cGxhaW58amF2YXNjcmlwdC8sCglqc29uX3dyYXAgICAgICAgICAgICA6IC9eW1xbXHtdLywKCWtsYXNzICAgICAgICAgICAgICAgIDogL15cLi8sCglubyAgICAgICAgICAgICAgICAgICA6IC9uby1zdG9yZXxuby1jYWNoZS9pLAoJbm90X2RvdG5vdGF0aW9uICAgICAgOiAvLXxccy8sCglub3RfZW5kcG9pbnQgICAgICAgICA6IC8uKlwvLywKCW51bGxfdW5kZWZpbmVkICAgICAgIDogL251bGx8dW5kZWZpbmVkLywKCW51bWJlciAgICAgICAgICAgICAgIDogLyheLT9cZFxkKlwuXGQqJCl8KF4tP1xkXGQqJCl8KF4tP1wuXGRcZCokKXxudW1iZXIvLAoJbnVtYmVyX2Zvcm1hdF8xICAgICAgOiAvLipcLi8sCgludW1iZXJfZm9ybWF0XzIgICAgICA6IC9cLi4qLywKCW51bWJlcl9wcmVzZW50ICAgICAgIDogL1xkezEsfS8sCgludW1iZXJfc3RyaW5nICAgICAgICA6IC9udW1iZXJ8c3RyaW5nL2ksCgludW1iZXJfc3RyaW5nX29iamVjdCA6IC9udW1iZXJ8b2JqZWN0fHN0cmluZy9pLAoJb2JqZWN0X3R5cGUgICAgICAgICAgOiAvXFtvYmplY3QgT2JqZWN0XF0vLAoJcGF0Y2ggICAgICAgICAgICAgICAgOiAvXnBhdGNoJC8sCglwcmltaXRpdmUgICAgICAgICAgICA6IC9eKGJvb2xlYW58ZnVuY3Rpb258bnVtYmVyfHN0cmluZykkLywKCXByaXYgICAgICAgICAgICAgICAgIDogL3ByaXZhdGUvLAoJcHV0X3Bvc3QgICAgICAgICAgICAgOiAvXihwb3N0fHB1dCkkL2ksCglyYWRpb19jaGVja2JveCAgICAgICA6IC9eKHJhZGlvfGNoZWNrYm94KSQvaSwKCXJvb3QgICAgICAgICAgICAgICAgIDogL15cL1teXC9dLywKCXNlbGVjdCAgICAgICAgICAgICAgIDogL3NlbGVjdC9pLAoJc2VsZWN0b3JfaXMgICAgICAgICAgOiAvXjovLAoJc2VsZWN0b3JfY29tcGxleCAgICAgOiAvXHMrfFw+fFwrfFx+fFw6fFxbLywKCXNldF9kZWwgICAgICAgICAgICAgIDogL14oc2V0fGRlbHxkZWxldGUpJC8sCglzcGFjZV9oeXBoZW4gICAgICAgICA6IC9cc3wtLywKCXN0cmluZ19vYmplY3QgICAgICAgIDogL3N0cmluZ3xvYmplY3QvaSwKCXN2ZyAgICAgICAgICAgICAgICAgIDogL3N2Zy8sCgl0b3BfYm90dG9tICAgICAgICAgICA6IC90b3B8Ym90dG9tL2ksCgl1cmwgICAgICAgICAgICAgICAgICA6IC9eKD86KD86aHR0cHM/fGZ0cCk6XC9cLykoPzpcUysoPzo6XFMqKT9AKT8oPzooPyExMCg/OlwuXGR7MSwzfSl7M30pKD8hMTI3KD86XC5cZHsxLDN9KXszfSkoPyExNjlcLjI1NCg/OlwuXGR7MSwzfSl7Mn0pKD8hMTkyXC4xNjgoPzpcLlxkezEsM30pezJ9KSg/ITE3MlwuKD86MVs2LTldfDJcZHwzWzAtMV0pKD86XC5cZHsxLDN9KXsyfSkoPzpbMS05XVxkP3wxXGRcZHwyWzAxXVxkfDIyWzAtM10pKD86XC4oPzoxP1xkezEsMn18MlswLTRdXGR8MjVbMC01XSkpezJ9KD86XC4oPzpbMS05XVxkP3wxXGRcZHwyWzAtNF1cZHwyNVswLTRdKSl8KD86KD86W2Etelx1MDBhMS1cdWZmZmYwLTldKy0/KSpbYS16XHUwMGExLVx1ZmZmZjAtOV0rKSg/OlwuKD86W2Etelx1MDBhMS1cdWZmZmYwLTldKy0/KSpbYS16XHUwMGExLVx1ZmZmZjAtOV0rKSooPzpcLig/OlthLXpcdTAwYTEtXHVmZmZmXXsyLH0pKSkoPzo6XGR7Miw1fSk/KD86XC9bXlxzXSopPyQvaSwKCXdvcmQgICAgICAgICAgICAgICAgIDogL15cdyskLywKCXhkb21haW5yZXF1ZXN0ICAgICAgIDogL14oZ2V0fHBvc3QpJC9pLAoJeG1sICAgICAgICAgICAgICAgICAgOiAveG1sL2kKfTsKCi8qKgogKiBAbmFtZXNwYWNlIGxydQogKi8KdmFyIGxydSA9IHsKCS8qKgoJICogTFJVIGZhY3RvcnkKCSAqCgkgKiBAbWV0aG9kIGZhY3RvcnkKCSAqIEBtZW1iZXJPZiBscnUKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5MUlV9CgkgKiBAZXhhbXBsZQoJICogdmFyIGxydSA9IGtlaWdhaS51dGlsLmxydSggNTAgKTsKCSAqLwoJIGZhY3RvcnkgOiBmdW5jdGlvbiAoIG1heCApIHsKCQlyZXR1cm4gbmV3IExSVSggbWF4ICk7Cgl9Cn07CgovKioKICogQ3JlYXRlcyBhIG5ldyBMZWFzdCBSZWNlbnRseSBVc2VkIGNhY2hlCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpCiAqIEBwYXJhbSAge051bWJlcn0gbWF4IFtPcHRpb25hbF0gTWF4IHNpemUgb2YgY2FjaGUsIGRlZmF1bHQgaXMgMTAwMAogKiBAZXhhbXBsZQogKiB2YXIgbHJ1ID0ga2VpZ2FpLnV0aWwubHJ1KCA1MCApOwogKi8KZnVuY3Rpb24gTFJVICggbWF4ICkgewoJdGhpcy5jYWNoZSAgPSB7fTsKCXRoaXMubWF4ICAgID0gbWF4IHx8IDEwMDA7Cgl0aGlzLmZpcnN0ICA9IG51bGw7Cgl0aGlzLmxhc3QgICA9IG51bGw7Cgl0aGlzLmxlbmd0aCA9IDA7Cn0KCi8qKgogKiBTZXR0aW5nIGNvbnN0cnVjdG9yIGxvb3AKICoKICogQG1ldGhvZCBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpLkxSVQogKiBAdHlwZSB7RnVuY3Rpb259CiAqIEBwcml2YXRlCiAqLwpMUlUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTFJVOwoKLyoqCiAqIEV2aWN0cyB0aGUgbGVhc3QgcmVjZW50bHkgdXNlZCBpdGVtIGZyb20gY2FjaGUKICoKICogQG1ldGhvZCBldmljdAogKiBAbWVtYmVyT2Yga2VpZ2FpLkxSVQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuTFJVfQogKiBAZXhhbXBsZQogKiBscnUuZXZpY3QoKTsKICovCkxSVS5wcm90b3R5cGUuZXZpY3QgPSBmdW5jdGlvbiAoKSB7CglpZiAoIHRoaXMubGFzdCAhPT0gbnVsbCApIHsKCQl0aGlzLnJlbW92ZSggdGhpcy5sYXN0ICk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogR2V0cyBjYWNoZWQgaXRlbSBhbmQgbW92ZXMgaXQgdG8gdGhlIGZyb250CiAqCiAqIEBtZXRob2QgZ2V0CiAqIEBtZW1iZXJPZiBrZWlnYWkuTFJVCiAqIEBwYXJhbSAge1N0cmluZ30ga2V5IEl0ZW0ga2V5CiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5MUlVJdGVtfQogKiBAZXhhbXBsZQogKiB2YXIgaXRlbSA9IGxydS5nZXQoICJrZXkiICk7CiAqLwpMUlUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uICgga2V5ICkgewoJdmFyIGl0ZW0gPSB0aGlzLmNhY2hlW2tleV07CgoJaWYgKCBpdGVtID09PSB1bmRlZmluZWQgKSB7CgkJcmV0dXJuOwoJfQoKCXRoaXMuc2V0KCBrZXksIGl0ZW0udmFsdWUgKTsKCglyZXR1cm4gaXRlbS52YWx1ZTsKfTsKCi8qKgogKiBSZW1vdmVzIGl0ZW0gZnJvbSBjYWNoZQogKgogKiBAbWV0aG9kIHJlbW92ZQogKiBAbWVtYmVyT2Yga2VpZ2FpLkxSVQogKiBAcGFyYW0gIHtTdHJpbmd9IGtleSBJdGVtIGtleQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuTFJVSXRlbX0KICogQGV4YW1wbGUKICogbHJ1LnJlbW92ZSggImtleSIgKTsKICovCkxSVS5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKCBrZXkgKSB7Cgl2YXIgaXRlbSA9IHRoaXMuY2FjaGVbIGtleSBdOwoKCWlmICggaXRlbSApIHsKCQlkZWxldGUgdGhpcy5jYWNoZVtrZXldOwoKCQl0aGlzLmxlbmd0aC0tOwoKCQlpZiAoIGl0ZW0ucHJldmlvdXMgIT09IG51bGwgKSB7CgkJCXRoaXMuY2FjaGVbaXRlbS5wcmV2aW91c10ubmV4dCA9IGl0ZW0ubmV4dDsKCQl9CgoJCWlmICggaXRlbS5uZXh0ICE9PSBudWxsICkgewoJCQl0aGlzLmNhY2hlW2l0ZW0ubmV4dF0ucHJldmlvdXMgPSBpdGVtLnByZXZpb3VzOwoJCX0KCgkJaWYgKCB0aGlzLmZpcnN0ID09PSBrZXkgKSB7CgkJCXRoaXMuZmlyc3QgPSBpdGVtLnByZXZpb3VzOwoJCX0KCgkJaWYgKCB0aGlzLmxhc3QgPT09IGtleSApIHsKCQkJdGhpcy5sYXN0ID0gaXRlbS5uZXh0OwoJCX0KCX0KCglyZXR1cm4gaXRlbTsKfTsKCi8qKgogKiBTZXRzIGl0ZW0gaW4gY2FjaGUgYXMgYGZpcnN0YAogKgogKiBAbWV0aG9kIHNldAogKiBAbWVtYmVyT2Yga2VpZ2FpLkxSVQogKiBAcGFyYW0gIHtTdHJpbmd9IGtleSAgIEl0ZW0ga2V5CiAqIEBwYXJhbSAge01peGVkfSAgdmFsdWUgSXRlbSB2YWx1ZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuTFJVfQogKiBAZXhhbXBsZQogKiBscnUuc2V0KCAia2V5Iiwge3g6IHRydWV9ICk7CiAqLwpMUlUucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uICgga2V5LCB2YWx1ZSApIHsKCXZhciBpdGVtID0gdGhpcy5yZW1vdmUoIGtleSApOwoKCWlmICggaXRlbSA9PT0gdW5kZWZpbmVkICkgewoJCWl0ZW0gPSBuZXcgTFJVSXRlbSggdmFsdWUgKTsKCX0KCWVsc2UgewoJCWl0ZW0udmFsdWUgPSB2YWx1ZTsKCX0KCglpdGVtLm5leHQgICAgICAgPSBudWxsOwoJaXRlbS5wcmV2aW91cyAgID0gdGhpcy5maXJzdDsKCXRoaXMuY2FjaGVba2V5XSA9IGl0ZW07CgoJaWYgKCB0aGlzLmZpcnN0ICE9PSBudWxsICkgewoJCXRoaXMuY2FjaGVbdGhpcy5maXJzdF0ubmV4dCA9IGtleTsKCX0KCgl0aGlzLmZpcnN0ID0ga2V5OwoKCWlmICggdGhpcy5sYXN0ID09PSBudWxsICkgewoJCXRoaXMubGFzdCA9IGtleTsKCX0KCglpZiAoICsrdGhpcy5sZW5ndGggPiB0aGlzLm1heCApIHsKCQl0aGlzLmV2aWN0KCk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogQ3JlYXRlcyBhIG5ldyBMUlVJdGVtCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpCiAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIEl0ZW0gdmFsdWUKICogQHByaXZhdGUKICovCmZ1bmN0aW9uIExSVUl0ZW0gKCB2YWx1ZSApIHsKCXRoaXMubmV4dCAgICAgPSBudWxsOwoJdGhpcy5wcmV2aW91cyA9IG51bGw7Cgl0aGlzLnZhbHVlICAgID0gdmFsdWU7Cn0KCi8qKgogKiBTZXR0aW5nIGNvbnN0cnVjdG9yIGxvb3AKICoKICogQG1ldGhvZCBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpLkxSVUl0ZW0KICogQHR5cGUge0Z1bmN0aW9ufQogKi8KTFJVSXRlbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBMUlVJdGVtOwoKLyoqCiAqIEBuYW1lc3BhY2Ugb2JzZXJ2YWJsZQogKi8KdmFyIG9ic2VydmFibGUgPSB7CgkvKioKCSAqIE9ic2VydmFibGUgZmFjdG9yeQoJICoKCSAqIEBtZXRob2QgZmFjdG9yeQoJICogQG1lbWJlck9mIG9ic2VydmFibGUKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5PYnNlcnZhYmxlfQoJICogQGV4YW1wbGUKCSAqIHZhciBvYnNlcnZlciA9IGtlaWdhaS51dGlsLm9ic2VydmVyKCA1MCApOwoJICovCgkgZmFjdG9yeSA6IGZ1bmN0aW9uICggYXJnICkgewoJCXJldHVybiBuZXcgT2JzZXJ2YWJsZSggYXJnICk7Cgl9Cn07CgovKioKICogQ3JlYXRlcyBhIG5ldyBPYnNlcnZhYmxlCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpCiAqIEBwYXJhbSAge051bWJlcn0gYXJnIE1heGltdW0gbGlzdGVuZXJzLCBkZWZhdWx0IGlzIDEwCiAqIEBleGFtcGxlCiAqIHZhciBvYnNlcnZlciA9IGtlaWdhaS51dGlsLm9ic2VydmVyKCA1MCApOwogKi8KZnVuY3Rpb24gT2JzZXJ2YWJsZSAoIGFyZyApIHsKCXRoaXMubGltaXQgICAgID0gYXJnIHx8IE1BWDsKCXRoaXMubGlzdGVuZXJzID0ge307Cgl0aGlzLmhvb2tzICAgICA9IHt9Owp9CgovKioKICogU2V0dGluZyBjb25zdHJ1Y3RvciBsb29wCiAqCiAqIEBtZXRob2QgY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaS5PYnNlcnZhYmxlCiAqIEB0eXBlIHtGdW5jdGlvbn0KICogQHByaXZhdGUKICovCk9ic2VydmFibGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gT2JzZXJ2YWJsZTsKCi8qKgogKiBEaXNwYXRjaGVzIGFuIGV2ZW50LCB3aXRoIG9wdGlvbmFsIGFyZ3VtZW50cwogKgogKiBAbWV0aG9kIGRpc3BhdGNoCiAqIEBtZW1iZXJPZiBrZWlnYWkuT2JzZXJ2YWJsZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuT2JzZXJ2YWJsZX0KICogQGV4YW1wbGUKICogb2JzZXJ2ZXIuZGlzcGF0Y2goICJldmVudCIsIC4uLiApOwogKi8KT2JzZXJ2YWJsZS5wcm90b3R5cGUuZGlzcGF0Y2ggPSBmdW5jdGlvbiAoKSB7Cgl2YXIgYXJncyA9IGFycmF5LmNhc3QoIGFyZ3VtZW50cyApLAoJICAgIGV2ICAgPSBhcmdzLnNoaWZ0KCk7CgoJaWYgKCBldiAmJiB0aGlzLmxpc3RlbmVyc1tldl0gKSB7CgkJdXRpbGl0eS5pdGVyYXRlKCB0aGlzLmxpc3RlbmVyc1tldl0sIGZ1bmN0aW9uICggaSApIHsKCQkJaS5oYW5kbGVyLmFwcGx5KCBpLnNjb3BlLCBhcmdzICk7CgkJfSApOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEhvb2tzIGludG8gYHRhcmdldGAgZm9yIGEgRE9NIGV2ZW50CiAqCiAqIEBtZXRob2QgaG9vawogKiBAbWVtYmVyT2Yga2VpZ2FpLk9ic2VydmFibGUKICogQHBhcmFtICB7T2JqZWN0fSB0YXJnZXQgRWxlbWVudAogKiBAcGFyYW0gIHtTdHJpbmd9IGV2ICAgICBFdmVudAogKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgICBFbGVtZW50CiAqIEBleGFtcGxlCiAqIG9ic2VydmVyLmhvb2soIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICJhIiApLCAiY2xpY2siICk7CiAqLwpPYnNlcnZhYmxlLnByb3RvdHlwZS5ob29rID0gZnVuY3Rpb24gKCB0YXJnZXQsIGV2ICkgewoJdmFyIHNlbGYgPSB0aGlzOwoKCWlmICggdHlwZW9mIHRhcmdldC5hZGRFdmVudExpc3RlbmVyICE9ICJmdW5jdGlvbiIgKSB7CgkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7Cgl9CgoJdXRpbGl0eS5nZW5JZCggdGFyZ2V0ICk7CgoJdGhpcy5ob29rc1t0YXJnZXQuaWRdID0gZnVuY3Rpb24gKCBhcmcgKSB7CgkJc2VsZi5kaXNwYXRjaCggZXYsIGFyZyApOwoJfTsKCgl0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lciggZXYsIHRoaXMuaG9va3NbdGFyZ2V0LmlkXSwgZmFsc2UgKTsKCglyZXR1cm4gdGFyZ2V0Owp9OwoKLyoqCiAqIFJlbW92ZXMgYWxsLCBvciBhIHNwZWNpZmljIGxpc3RlbmVyIGZvciBhbiBldmVudAogKgogKiBAbWV0aG9kIG9mZgogKiBAbWVtYmVyT2Yga2VpZ2FpLk9ic2VydmFibGUKICogQHBhcmFtIHtTdHJpbmd9IGV2IEV2ZW50IG5hbWUKICogQHBhcmFtIHtTdHJpbmd9IGlkIFtPcHRpb25hbF0gTGlzdGVuZXIgSUQKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLk9ic2VydmFibGV9CiAqIEBleGFtcGxlCiAqIG9ic2VydmVyLm9mZiggImNsaWNrIiwgIm15SG9vayIgKTsKICovCk9ic2VydmFibGUucHJvdG90eXBlLm9mZiA9IGZ1bmN0aW9uICggZXYsIGlkICkgewoJaWYgKCB0aGlzLmxpc3RlbmVyc1tldl0gKSB7CgkJaWYgKCBpZCApIHsKCQkJZGVsZXRlIHRoaXMubGlzdGVuZXJzW2V2XVtpZF07CgkJfQoJCWVsc2UgewoJCQlkZWxldGUgdGhpcy5saXN0ZW5lcnNbZXZdOwoJCX0KCX0KCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBBZGRzIGEgbGlzdGVuZXIgZm9yIGFuIGV2ZW50CiAqCiAqIEBtZXRob2Qgb24KICogQG1lbWJlck9mIGtlaWdhaS5PYnNlcnZhYmxlCiAqIEBwYXJhbSAge1N0cmluZ30gICBldiAgICAgIEV2ZW50IG5hbWUKICogQHBhcmFtICB7RnVuY3Rpb259IGhhbmRsZXIgSGFuZGxlcgogKiBAcGFyYW0gIHtTdHJpbmd9ICAgaWQgICAgICBbT3B0aW9uYWxdIEhhbmRsZXIgSUQKICogQHBhcmFtICB7U3RyaW5nfSAgIHNjb3BlICAgW09wdGlvbmFsXSBIYW5kbGVyIHNjb3BlLCBkZWZhdWx0IGlzIGB0aGlzYAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuT2JzZXJ2YWJsZX0KICogQGV4YW1wbGUKICogb2JzZXJ2ZXIub24oICJjbGljayIsIGZ1bmN0aW9uICggZXYgKSB7CiAqICAgLi4uCiAqIH0sICJteUhvb2siICk7CiAqLwpPYnNlcnZhYmxlLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uICggZXYsIGhhbmRsZXIsIGlkLCBzY29wZSApIHsKCWlkICAgID0gaWQgICAgfHwgdXRpbGl0eS51dWlkKCk7CglzY29wZSA9IHNjb3BlIHx8IHRoaXM7CgoJaWYgKCAhdGhpcy5saXN0ZW5lcnNbZXZdICkgewoJCXRoaXMubGlzdGVuZXJzW2V2XSA9IHt9OwoJfQoKCWlmICggYXJyYXkua2V5cyggdGhpcy5saXN0ZW5lcnNbZXZdICkubGVuZ3RoID49IHRoaXMubGltaXQgKSB7CgkJdGhyb3coIG5ldyBFcnJvciggIlBvc3NpYmxlIG1lbW9yeSBsZWFrLCBtb3JlIHRoYW4gIiArIHRoaXMubGltaXQgKyAiIGxpc3RlbmVycyBmb3IgZXZlbnQ6ICIgKyBldiApICk7Cgl9CgoJdGhpcy5saXN0ZW5lcnNbZXZdW2lkXSA9IHtzY29wZTogc2NvcGUsIGhhbmRsZXI6IGhhbmRsZXJ9OwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEFkZHMgYSBzaG9ydCBsaXZlZCBsaXN0ZW5lciBmb3IgYW4gZXZlbnQKICoKICogQG1ldGhvZCBvbmNlCiAqIEBtZW1iZXJPZiBrZWlnYWkuT2JzZXJ2YWJsZQogKiBAcGFyYW0gIHtTdHJpbmd9ICAgZXYgICAgICBFdmVudCBuYW1lCiAqIEBwYXJhbSAge0Z1bmN0aW9ufSBoYW5kbGVyIEhhbmRsZXIKICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICAgICAgW09wdGlvbmFsXSBIYW5kbGVyIElECiAqIEBwYXJhbSAge1N0cmluZ30gICBzY29wZSAgIFtPcHRpb25hbF0gSGFuZGxlciBzY29wZSwgZGVmYXVsdCBpcyBgdGhpc2AKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLk9ic2VydmFibGV9CiAqIEBleGFtcGxlCiAqIG9ic2VydmVyLm9uY2UoICJjbGljayIsIGZ1bmN0aW9uICggZXYgKSB7CiAqICAgLi4uCiAqIH0gKTsKICovCk9ic2VydmFibGUucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiAoIGV2LCBoYW5kbGVyLCBpZCwgc2NvcGUgICkgewoJdmFyIHNlbGYgPSB0aGlzOwoKCWlkICAgID0gaWQgICAgfHwgdXRpbGl0eS51dWlkKCk7CglzY29wZSA9IHNjb3BlIHx8IHRoaXM7CgoJcmV0dXJuIHRoaXMub24oIGV2LCBmdW5jdGlvbiAoKSB7CgkJaGFuZGxlci5hcHBseSggc2NvcGUsIFtdLmNvbmNhdCggYXJyYXkuY2FzdCggYXJndW1lbnRzICkgKSApOwoJCXNlbGYub2ZmKCBldiwgaWQgKTsKCX0sIGlkLCBzY29wZSApOwp9OwoKLyoqCiAqIFVuaG9va3MgZnJvbSBgdGFyZ2V0YCBmb3IgYSBET00gZXZlbnQKICoKICogQG1ldGhvZCB1bmhvb2sKICogQG1lbWJlck9mIGtlaWdhaS5PYnNlcnZhYmxlCiAqIEBwYXJhbSAge09iamVjdH0gdGFyZ2V0IEVsZW1lbnQKICogQHBhcmFtICB7U3RyaW5nfSBldiAgICAgRXZlbnQKICogQHJldHVybiB7T2JqZWN0fSAgICAgICAgRWxlbWVudAogKiBAZXhhbXBsZQogKiBvYnNlcnZlci51bmhvb2soIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICJhIiApLCAiY2xpY2siICk7CiAqLwpPYnNlcnZhYmxlLnByb3RvdHlwZS51bmhvb2sgPSBmdW5jdGlvbiAoIHRhcmdldCwgZXYgKSB7Cgl0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lciggZXYsIHRoaXMuaG9va3NbdGFyZ2V0LmlkXSwgZmFsc2UgKTsKCWRlbGV0ZSB0aGlzLmhvb2tzW3RhcmdldC5pZF07CgoJcmV0dXJuIHRhcmdldDsKfTsKCi8qKgogKiBAbmFtZXNwYWNlIGJhc2UKICogQHByaXZhdGUKICovCnZhciBiYXNlID0gewoJLyoqCgkgKiBCYXNlIGZhY3RvcnkKCSAqCgkgKiBAbWVtYmVyT2YgYmFzZQoJICogQG1ldGhvZCBmYWN0b3J5CgkgKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KCSAqLwoJZmFjdG9yeSA6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gbmV3IEJhc2UoKTsKCX0KfTsKCi8qKgogKiBCYXNlIE9iamVjdAogKgogKiBAY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaQogKi8KZnVuY3Rpb24gQmFzZSAoKSB7CgkvKioKCSAqIHtAbGluayBrZWlnYWkuT2JzZXJ2YWJsZX0KCSAqCgkgKiBAYWJzdHJhY3QKCSAqIEB0eXBlIHtPYmplY3R9CgkgKi8KCXRoaXMub2JzZXJ2ZXIgPSBudWxsOwp9CgovKioKICogU2V0dGluZyBjb25zdHJ1Y3RvciBsb29wCiAqCiAqIEBtZXRob2QgY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaS5CYXNlCiAqIEB0eXBlIHtGdW5jdGlvbn0KICogQHByaXZhdGUKICovCkJhc2UucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQmFzZTsKCi8qKgogKiBBZGRzIGFuIGV2ZW50IGxpc3RlbmVyCiAqCiAqIEBtZXRob2QgYWRkRXZlbnRMaXN0ZW5lcgogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSAgIGV2ICAgICAgIEV2ZW50IG5hbWUKICogQHBhcmFtICB7RnVuY3Rpb259IGxpc3RlbmVyIEZ1bmN0aW9uIHRvIGV4ZWN1dGUKICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICAgICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgSUQKICogQHBhcmFtICB7U3RyaW5nfSAgIHNjb3BlICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgc2NvcGUsIGRlZmF1bHQgaXMgYHRoaXNgCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKiBAZXhhbXBsZQogKiBvYmouYWRkRXZlbnRMaXN0ZW5lciggImV2ZW50IiwgZnVuY3Rpb24gKCBldiApIHsKICogICAuLi4KICogfSwgIm15SG9vayIgKTsKICovCkJhc2UucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbiAoIGV2LCBsaXN0ZW5lciwgaWQsIHNjb3BlICkgewoJdGhpcy5vYnNlcnZlci5vbiggZXYsIGxpc3RlbmVyLCBpZCwgc2NvcGUgfHwgdGhpcyApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEFkZHMgYW4gZXZlbnQgbGlzdGVuZXIKICoKICogQG1ldGhvZCBhZGRMaXN0ZW5lcgogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSAgIGV2ICAgICAgIEV2ZW50IG5hbWUKICogQHBhcmFtICB7RnVuY3Rpb259IGxpc3RlbmVyIEZ1bmN0aW9uIHRvIGV4ZWN1dGUKICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICAgICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgSUQKICogQHBhcmFtICB7U3RyaW5nfSAgIHNjb3BlICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgc2NvcGUsIGRlZmF1bHQgaXMgYHRoaXNgCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKiBAZXhhbXBsZQogKiBvYmouYWRkRXZlbnRMaXN0ZW5lciggImV2ZW50IiwgZnVuY3Rpb24gKCBldiApIHsKICogICAuLi4KICogfSwgIm15SG9vayIgKTsKICovCkJhc2UucHJvdG90eXBlLmFkZExpc3RlbmVyID0gZnVuY3Rpb24gKCBldiwgbGlzdGVuZXIsIGlkLCBzY29wZSApIHsKCXRoaXMub2JzZXJ2ZXIub24oIGV2LCBsaXN0ZW5lciwgaWQsIHNjb3BlIHx8IHRoaXMgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBEaXNwYXRjaGVzIGFuIGV2ZW50LCB3aXRoIG9wdGlvbmFsIGFyZ3VtZW50cwogKgogKiBAbWV0aG9kIGRpc3BhdGNoCiAqIEBtZW1iZXJPZiBrZWlnYWkuQmFzZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICogQGV4YW1wbGUKICogb2JqLmRpc3BhdGNoKCAiZXZlbnQiLCAuLi4gKTsKICovCkJhc2UucHJvdG90eXBlLmRpc3BhdGNoID0gZnVuY3Rpb24gKCkgewoJdGhpcy5vYnNlcnZlci5kaXNwYXRjaC5hcHBseSggdGhpcy5vYnNlcnZlciwgW10uY29uY2F0KCBhcnJheS5jYXN0KCBhcmd1bWVudHMgKSApICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogRGlzcGF0Y2hlcyBhbiBldmVudCwgd2l0aCBvcHRpb25hbCBhcmd1bWVudHMKICoKICogQG1ldGhvZCBkaXNwYXRjaEV2ZW50CiAqIEBtZW1iZXJPZiBrZWlnYWkuQmFzZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICogQGV4YW1wbGUKICogb2JqLmRpc3BhdGNoRXZlbnQoICJldmVudCIsIC4uLiApOwogKi8KQmFzZS5wcm90b3R5cGUuZGlzcGF0Y2hFdmVudCA9IGZ1bmN0aW9uICgpIHsKCXRoaXMub2JzZXJ2ZXIuZGlzcGF0Y2guYXBwbHkoIHRoaXMub2JzZXJ2ZXIsIFtdLmNvbmNhdCggYXJyYXkuY2FzdCggYXJndW1lbnRzICkgKSApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIERpc3BhdGNoZXMgYW4gZXZlbnQsIHdpdGggb3B0aW9uYWwgYXJndW1lbnRzCiAqCiAqIEBtZXRob2QgZW1pdAogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkJhc2V9CiAqIEBleGFtcGxlCiAqIG9iai5lbWl0KCAiZXZlbnQiLCAuLi4gKTsKICovCkJhc2UucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbiAoKSB7Cgl0aGlzLm9ic2VydmVyLmRpc3BhdGNoLmFwcGx5KCB0aGlzLm9ic2VydmVyLCBbXS5jb25jYXQoIGFycmF5LmNhc3QoIGFyZ3VtZW50cyApICkgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBIb29rcyBpbnRvIGB0YXJnZXRgIGZvciBhbiBldmVudAogKgogKiBAbWV0aG9kIGhvb2sKICogQG1lbWJlck9mIGtlaWdhaS5CYXNlCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKiBAZXhhbXBsZQogKiBvYmouaG9vayggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggImEiICksICJjbGljayIgKTsKICovCkJhc2UucHJvdG90eXBlLmhvb2sgPSBmdW5jdGlvbiAoKSB7Cgl0aGlzLm9ic2VydmVyLmhvb2suYXBwbHkoIHRoaXMub2JzZXJ2ZXIsIFtdLmNvbmNhdCggYXJyYXkuY2FzdCggYXJndW1lbnRzICkgKSApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEdldHMgbGlzdGVuZXJzCiAqCiAqIEBtZXRob2QgbGlzdGVuZXJzCiAqIEBtZW1iZXJPZiBrZWlnYWkuQmFzZQogKiBAcGFyYW0gIHtTdHJpbmd9IGV2IFtPcHRpb25hbF0gRXZlbnQgbmFtZQogKiBAcmV0dXJuIHtPYmplY3R9IExpc3RlbmVycwogKiBAZXhhbXBsZQogKiBrZWlnYWkudXRpbC5pdGVyYXRlKCBvYmoubGlzdGVuZXJzKCksIGZ1bmN0aW9uICggZm4sIGlkICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpCYXNlLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbiAoIGV2ICkgewoJcmV0dXJuIGV2ID8gdGhpcy5vYnNlcnZlci5saXN0ZW5lcnNbZXZdIDogdGhpcy5saXN0ZW5lcnM7Cn07CgovKioKICogUmVtb3ZlcyBhbiBldmVudCBsaXN0ZW5lcgogKgogKiBAbWV0aG9kIG9mZgogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSBldiBFdmVudCBuYW1lCiAqIEBwYXJhbSAge1N0cmluZ30gaWQgW09wdGlvbmFsXSBMaXN0ZW5lciBJRAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICogQGV4YW1wbGUKICogb2JqLm9mZiggImV2ZW50IiwgIm15SG9vayIgKTsKICovCkJhc2UucHJvdG90eXBlLm9mZiA9IGZ1bmN0aW9uICggZXYsIGlkICkgewoJdGhpcy5vYnNlcnZlci5vZmYoIGV2LCBpZCApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEFkZHMgYW4gZXZlbnQgbGlzdGVuZXIKICoKICogQG1ldGhvZCBvbgogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSAgIGV2ICAgICAgIEV2ZW50IG5hbWUKICogQHBhcmFtICB7RnVuY3Rpb259IGxpc3RlbmVyIEZ1bmN0aW9uIHRvIGV4ZWN1dGUKICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICAgICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgSUQKICogQHBhcmFtICB7U3RyaW5nfSAgIHNjb3BlICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgc2NvcGUsIGRlZmF1bHQgaXMgYHRoaXNgCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKiBAZXhhbXBsZQogKiBvYmoub24oICJldmVudCIsIGZ1bmN0aW9uICggZXYgKSB7CiAqICAgLi4uCiAqIH0sICJteUhvb2siICk7CiAqLwpCYXNlLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uICggZXYsIGxpc3RlbmVyLCBpZCwgc2NvcGUgKSB7Cgl0aGlzLm9ic2VydmVyLm9uKCBldiwgbGlzdGVuZXIsIGlkLCBzY29wZSB8fCB0aGlzICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogQWRkcyBhIHNob3J0IGxpdmVkIGV2ZW50IGxpc3RlbmVyCiAqCiAqIEBtZXRob2Qgb25jZQogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSAgIGV2ICAgICAgIEV2ZW50IG5hbWUKICogQHBhcmFtICB7RnVuY3Rpb259IGxpc3RlbmVyIEZ1bmN0aW9uIHRvIGV4ZWN1dGUKICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICAgICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgSUQKICogQHBhcmFtICB7U3RyaW5nfSAgIHNjb3BlICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgc2NvcGUsIGRlZmF1bHQgaXMgYHRoaXNgCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKiBAZXhhbXBsZQogKiBvYmoub25jZSggImV2ZW50IiwgZnVuY3Rpb24gKCBldiApIHsKICogICAuLi4KICogfSApOwogKi8KQmFzZS5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uICggZXYsIGxpc3RlbmVyLCBpZCwgc2NvcGUgKSB7Cgl0aGlzLm9ic2VydmVyLm9uY2UoIGV2LCBsaXN0ZW5lciwgaWQsIHNjb3BlIHx8IHRoaXMgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBSZW1vdmVzIGFuIGV2ZW50IGxpc3RlbmVyCiAqCiAqIEBtZXRob2QgcmVtb3ZlRXZlbnRMaXN0ZW5lcgogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSBldiBFdmVudCBuYW1lCiAqIEBwYXJhbSAge1N0cmluZ30gaWQgW09wdGlvbmFsXSBMaXN0ZW5lciBJRAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICogQGV4YW1wbGUKICogb2JqLnJlbW92ZUxpc3RlbmVyKCAiZXZlbnQiLCAibXlIb29rIiApOwogKi8KQmFzZS5wcm90b3R5cGUucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uICggZXYsIGlkICkgewoJdGhpcy5vYnNlcnZlci5vZmYoIGV2LCBpZCApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIFJlbW92ZXMgYW4gZXZlbnQgbGlzdGVuZXIKICoKICogQG1ldGhvZCByZW1vdmVMaXN0ZW5lcgogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSBldiBFdmVudCBuYW1lCiAqIEBwYXJhbSAge1N0cmluZ30gaWQgW09wdGlvbmFsXSBMaXN0ZW5lciBJRAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICogQGV4YW1wbGUKICogb2JqLnJlbW92ZUxpc3RlbmVyKCAiZXZlbnQiLCAibXlIb29rIiApOwogKi8KQmFzZS5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiAoIGV2LCBpZCApIHsKCXRoaXMub2JzZXJ2ZXIub2ZmKCBldiwgaWQgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBAbmFtZXNwYWNlIGFycmF5CiAqLwp2YXIgYXJyYXkgPSB7CgkvKioKCSAqIEFkZHMgJ2FyZycgdG8gJ29iaicgaWYgaXQgaXMgbm90IGZvdW5kCgkgKgoJICogQG1ldGhvZCBhZGQKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byByZWNlaXZlICdhcmcnCgkgKiBAcGFyYW0gIHtNaXhlZH0gYXJnIEFyZ3VtZW50IHRvIHNldCBpbiAnb2JqJwoJICogQHJldHVybiB7QXJyYXl9ICAgICBBcnJheSB0aGF0IHdhcyBxdWVyaWVkCgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbMSwgMl07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkuYWRkKCBteUFycmF5LCAzICk7IC8vIFsxLCAyLCAzXQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuYWRkKCBteUFycmF5LCAxICk7IC8vIFsxLCAyLCAzXQoJICovCglhZGQgOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCWlmICggIWFycmF5LmNvbnRhaW5zKCBvYmosIGFyZyApICkgewoJCQlvYmoucHVzaCggYXJnICk7CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFByZWZvcm1zIGEgYmluYXJ5IHNlYXJjaCBvbiBhIHNvcnRlZCBBcnJheQoJICoKCSAqIEBtZXRob2QgYmluSW5kZXgKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBzZWFyY2gKCSAqIEBwYXJhbSAge01peGVkfSBhcmcgVmFsdWUgdG8gZmluZCBpbmRleCBvZgoJICogQHJldHVybiB7TnVtYmVyfSAgICBJbmRleCBvZiBgYXJnYCB3aXRoaW4gYG9iamAKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSA9IFsxLCA1LCAxMCwgMTUsIDIwLCAyNSwgLi4uXTsKCSAqCgkgKiBrZWlnYWkudXRpbC5hcnJheS5iaW5JbmRleCggbXlBcnJheSwgNSApOyAvLyAxCgkgKi8KCWJpbkluZGV4IDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQl2YXIgbWluID0gMCwKCQkgICAgbWF4ID0gb2JqLmxlbmd0aCAtIDEsCgkJICAgIGlkeCwgdmFsOwoKCQl3aGlsZSAoIG1pbiA8PSBtYXggKSB7CgkJCWlkeCA9IE1hdGguZmxvb3IoICggbWluICsgbWF4ICkgLyAyICk7CgkJCXZhbCA9IG9ialtpZHhdOwoKCQkJaWYgKCB2YWwgPCBhcmcgKSB7CgkJCQltaW4gPSBpZHggKyAxOwoJCQl9CgkJCWVsc2UgaWYgKCB2YWwgPiBhcmcgKSB7CgkJCQltYXggPSBpZHggLSAxOwoJCQl9CgkJCWVsc2UgewoJCQkJcmV0dXJuIGlkeDsKCQkJfQoJCX0KCgkJcmV0dXJuIC0xOwoJfSwKCgkvKioKCSAqIFJldHVybnMgYW4gT2JqZWN0ICggTm9kZUxpc3QsIGV0Yy4gKSBhcyBhbiBBcnJheQoJICoKCSAqIEBtZXRob2QgY2FzdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtPYmplY3R9ICBvYmogT2JqZWN0IHRvIGNhc3QKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGtleSBbT3B0aW9uYWxdIFJldHVybnMga2V5IG9yIHZhbHVlLCBvbmx5IGFwcGxpZXMgdG8gT2JqZWN0cyB3aXRob3V0IGEgbGVuZ3RoIHByb3BlcnR5CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgT2JqZWN0IGFzIGFuIEFycmF5CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuY2FzdCggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCggIi4uLiIgKSApOwoJICovCgljYXN0IDogZnVuY3Rpb24gKCBvYmosIGtleSApIHsKCQlrZXkgICA9ICgga2V5ID09PSB0cnVlICk7CgkJdmFyIG8gPSBbXTsKCgkJaWYgKCAhaXNOYU4oIG9iai5sZW5ndGggKSApIHsKCQkJbyA9IHNsaWNlLmNhbGwoIG9iaiApOwoJCX0KCQllbHNlIGlmICgga2V5ICkgewoJCQlvID0gYXJyYXkua2V5cyggb2JqICk7CgkJfQoJCWVsc2UgewoJCQl1dGlsaXR5Lml0ZXJhdGUoIG9iaiwgZnVuY3Rpb24gKCBpICkgewoJCQkJby5wdXNoKCBpICk7CgkJCX0gKTsKCQl9CgoJCXJldHVybiBvOwoJfSwKCgkvKioKCSAqIFRyYW5zZm9ybXMgYW4gQXJyYXkgdG8gYSAyRCBBcnJheSBvZiBjaHVua3MKCSAqCgkgKiBAbWV0aG9kIGNodW5rCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgb2JqICBBcnJheSB0byBwcm9jZXNzCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IHNpemUgQ2h1bmsgc2l6ZSAoIGludGVnZXIgKQoJICogQHJldHVybiB7QXJyYXl9ICAgICAgIENodW5rZWQgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5jaHVuayggWzAsIDEsIDIsIDNdLCAyICk7IC8vIFtbMCwgMV0sIFsyLCAzXV0KCSAqLwoJY2h1bmsgOiBmdW5jdGlvbiAoIG9iaiwgc2l6ZSApIHsKCQl2YXIgcmVzdWx0ID0gW10sCgkJICAgIG50aCAgICA9IG51bWJlci5yb3VuZCggKCBvYmoubGVuZ3RoIC8gc2l6ZSApLCAidXAiICksCgkJICAgIHN0YXJ0ICA9IDAsCgkJICAgIGkgICAgICA9IC0xOwoKCQl3aGlsZSAoICsraSA8IG50aCApIHsKCQkJc3RhcnQgPSBpICogc2l6ZTsKCQkJcmVzdWx0LnB1c2goIGFycmF5LmxpbWl0KCBvYmosIHN0YXJ0LCBzaXplICkgKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogQ2xlYXJzIGFuIEFycmF5IHdpdGhvdXQgZGVzdHJveWluZyBpdAoJICoKCSAqIEBtZXRob2QgY2xlYXIKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBjbGVhcgoJICogQHJldHVybiB7QXJyYXl9ICAgICBDbGVhcmVkIEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbMSwgMiwgMywgNCwgNV07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkuY2xlYXIoIG15QXJyYXkgKTsKCSAqIG15QXJyYXkubGVuZ3RoOyAvLyAwCgkgKi8KCWNsZWFyIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIG9iai5sZW5ndGggPiAwID8gYXJyYXkucmVtb3ZlKCBvYmosIDAsIG9iai5sZW5ndGggKSA6IG9iajsKCX0sCgoJLyoqCgkgKiBDbG9uZXMgYW4gQXJyYXkKCSAqCgkgKiBAbWV0aG9kIGNsb25lCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gY2xvbmUKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgQ2xvbmUgb2YgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSAgICAgID0gWzEsIDIsIDMsIDQsIDVdLAoJICogICAgIG15QXJyYXlDbG9uZSA9IGtlaWdhaS51dGlsLmFycmF5LmNsb25lKCBteUFycmF5ICk7CgkgKgoJICogbXlBcnJheUNsb25lLnB1c2goIDYgKTsKCSAqCgkgKiBteUFycmF5Lmxlbmd0aDsgICAgICAvLyA1CgkgKiBteUFycmF5Q2xvbmUubGVuZ3RoOyAvLyA2CgkgKi8KCWNsb25lIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIG9iai5zbGljZSgpOwoJfSwKCgkvKioKCSAqIERldGVybWluZXMgaWYgb2JqIGNvbnRhaW5zIGFyZwoJICoKCSAqIEBtZXRob2QgY29udGFpbnMKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBzZWFyY2gKCSAqIEBwYXJhbSAge01peGVkfSBhcmcgVmFsdWUgdG8gbG9vayBmb3IKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgVHJ1ZSBpZiBmb3VuZCwgZmFsc2UgaWYgbm90CgkgKiBAZXhhbXBsZQoJICogaWYgKCBrZWlnYWkudXRpbC5hcnJheS5jb250YWlucyggWzFdLCAxICkgKSB7IC4uLiB9CgkgKi8KCWNvbnRhaW5zIDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQlyZXR1cm4gb2JqLmluZGV4T2YoIGFyZyApID4gLTE7Cgl9LAoKCS8qKgoJICogQ3JlYXRlcyBhIG5ldyBBcnJheSBvZiB0aGUgcmVzdWx0IG9mIGBmbmAgZXhlY3V0ZWQgYWdhaW5zdCBldmVyeSBpbmRleCBvZiBgb2JqYAoJICoKCSAqIEBtZXRob2QgY29sbGVjdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gICAgb2JqIEFycmF5IHRvIGl0ZXJhdGUKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiAgRnVuY3Rpb24gdG8gZXhlY3V0ZSBhZ2FpbnN0IGluZGljZXMKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgTmV3IEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIHJlc3VsdHMgPSBrZWlnYWkudXRpbC5hcnJheS5jb2xsZWN0KCBbLi4uXSwgZnVuY3Rpb24gKCAuLi4gKSB7IC4uLiB9ICk7CgkgKi8KCWNvbGxlY3QgOiBmdW5jdGlvbiAoIG9iaiwgZm4gKSB7CgkJdmFyIHJlc3VsdCA9IFtdOwoKCQlhcnJheS5lYWNoKCBvYmosIGZ1bmN0aW9uICggaSApIHsKCQkJcmVzdWx0LnB1c2goIGZuKCBpICkgKTsKCQl9ICk7CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogQ29tcGFjdHMgYSBBcnJheSBieSByZW1vdmluZyBgbnVsbGAgb3IgYHVuZGVmaW5lZGAgaW5kaWNlcwoJICoKCSAqIEBtZXRob2QgY29tcGFjdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gICBvYmogIEFycmF5IHRvIGNvbXBhY3QKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGRpZmYgSW5kaWNhdGVzIHRvIHJldHVybiByZXN1bHRpbmcgQXJyYXkgb25seSBpZiB0aGVyZSdzIGEgZGlmZmVyZW5jZQoJICogQHJldHVybiB7QXJyYXl9ICAgICAgICBDb21wYWN0ZWQgY29weSBvZiBgb2JqYCwgb3IgbnVsbCAoIGlmIGBkaWZmYCBpcyBwYXNzZWQgJiBubyBkaWZmIGlzIGZvdW5kICkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5jb21wYWN0KCBbbnVsbCwgImEiLCAiYiIsICJjIiwgbnVsbCwgImQiXSApOyAvLyBbImEiLCAiYiIsICJjIiwgImQiXQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuY29tcGFjdCggWyJhIiwgImIiLCAiYyIsICJkIl0sIHRydWUgKTsgICAgICAgLy8gbnVsbAoJICovCgljb21wYWN0IDogZnVuY3Rpb24gKCBvYmosIGRpZmYgKSB7CgkJZGlmZiA9ICggZGlmZiA9PT0gdHJ1ZSApOwoJCXZhciByZXN1bHQ7CgoJCXJlc3VsdCA9IG9iai5maWx0ZXIoIGZ1bmN0aW9uICggaSApIHsKCQkJcmV0dXJuICFyZWdleC5udWxsX3VuZGVmaW5lZC50ZXN0KCBpICk7CgkJfSApOwoKCQlyZXR1cm4gIWRpZmYgPyByZXN1bHQgOiAoIHJlc3VsdC5sZW5ndGggPCBvYmoubGVuZ3RoID8gcmVzdWx0IDogbnVsbCApOwoJfSwKCgkvKioKCSAqIENvdW50cyBgdmFsdWVgIGluIGBvYmpgCgkgKgoJICogQG1ldGhvZCBjb3VudAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqICAgQXJyYXkgdG8gc2VhcmNoCgkgKiBAcGFyYW0gIHtNaXhlZH0gdmFsdWUgVmFsdWUgdG8gY29tcGFyZQoJICogQHJldHVybiB7QXJyYXl9ICAgICAgIEFycmF5IG9mIGNvdW50cwoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmNvdW50KCBbImFwcGxlIiwgImJhbmFuYSIsICJvcmFuZ2UiLCAiYXBwbGUiXSwgImFwcGxlIiApOyAvLyAyCgkgKi8KCWNvdW50IDogZnVuY3Rpb24gKCBvYmosIHZhbHVlICkgewoJCXJldHVybiBvYmouZmlsdGVyKCBmdW5jdGlvbiAoIGkgKSB7CgkJCXJldHVybiAoIGkgPT09IHZhbHVlICk7CgkJfSApLmxlbmd0aDsKCX0sCgoJLyoqCgkgKiBGaW5kcyB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIHR3byBBcnJheXMKCSAqCgkgKiBAbWV0aG9kIGRpZmYKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iajEgU291cmNlIEFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMiBDb21wYXJpc29uIEFycmF5CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICBBcnJheSBvZiB0aGUgZGlmZmVyZW5jZXMKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5kaWZmKCBbImEiXSwgWyJhIiwgImIiXSApOyAvLyBbImIiXQoJICovCglkaWZmIDogZnVuY3Rpb24gKCBvYmoxLCBvYmoyICkgewoJCXZhciByZXN1bHQgPSBbXTsKCgkJYXJyYXkuZWFjaCggb2JqMSwgZnVuY3Rpb24gKCBpICkgewoJCQlpZiAoICFhcnJheS5jb250YWlucyggb2JqMiwgaSApICkgewoJCQkJYXJyYXkuYWRkKCByZXN1bHQsIGkgKTsKCQkJfQoJCX0gKTsKCgkJYXJyYXkuZWFjaCggb2JqMiwgZnVuY3Rpb24gKCBpICkgewoJCQlpZiAoICFhcnJheS5jb250YWlucyggb2JqMSwgaSApICkgewoJCQkJYXJyYXkuYWRkKCByZXN1bHQsIGkgKTsKCQkJfQoJCX0gKTsKCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBJdGVyYXRlcyBgb2JqYCBhbmQgZXhlY3V0ZXMgYGZuYCB3aXRoIGFyZ3VtZW50cyBbYHZhbHVlYCwgYGluZGV4YF0uCgkgKiBSZXR1cm5pbmcgYGZhbHNlYCBoYWx0cyBpdGVyYXRpb24uCgkgKgoJICogQG1ldGhvZCBlYWNoCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgICBvYmogICBBcnJheSB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZm4gICAgRnVuY3Rpb24gdG8gZXhlY3V0ZSBvbiBpbmRleCB2YWx1ZXMKCSAqIEBwYXJhbSAge0Jvb2xlYW59ICBhc3luYyBbT3B0aW9uYWxdIEFzeW5jaHJvbm91cyBpdGVyYXRpb24KCSAqIEBwYXJhbSAge051bWJlcn0gICBzaXplICBbT3B0aW9uYWxdIEJhdGNoIHNpemUgZm9yIGFzeW5jIGl0ZXJhdGlvbiwgZGVmYXVsdCBpcyAxMAoJICogQHJldHVybiB7QXJyYXl9ICAgICAgICAgIEFycmF5CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuZWFjaCggWyAuLi4gXSwgZnVuY3Rpb24gKCAuLi4gKSB7IC4uLiB9ICk7CgkgKiBrZWlnYWkudXRpbC5hcnJheS5lYWNoKCBbIC4uLiBdLCBmdW5jdGlvbiAoIC4uLiApIHsgLi4uIH0sIHRydWUsIDEwMCApOyAvLyBwcm9jZXNzaW5nIGJhdGNoZXMgb2YgYSAxMDAKCSAqLwoJZWFjaCA6IGZ1bmN0aW9uICggb2JqLCBmbiwgYXN5bmMsIHNpemUgKSB7CgkJdmFyIG50aCA9IG9iai5sZW5ndGgsCgkJICAgIGksIG9mZnNldDsKCgkJaWYgKCBhc3luYyAhPT0gdHJ1ZSApIHsKCQkJaSA9IC0xOwoJCQl3aGlsZSAoICsraSA8IG50aCApIHsKCQkJCWlmICggZm4uY2FsbCggb2JqLCBvYmpbaV0sIGkgKSA9PT0gZmFsc2UgKSB7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9CgkJZWxzZSB7CgkJCXNpemUgICA9IHNpemUgfHwgMTA7CgkJCW9mZnNldCA9IDA7CgoJCQlpZiAoIHNpemUgPiBudGggKSB7CgkJCQlzaXplID0gbnRoOwoJCQl9CgoJCQl1dGlsaXR5LnJlcGVhdCggZnVuY3Rpb24gKCkgewoJCQkJdmFyIGkgPSAtMSwKCQkJCSAgICBpZHg7CgoJCQkJd2hpbGUgKCArK2kgPCBzaXplICkgewoJCQkJCWlkeCA9IGkgKyBvZmZzZXQ7CgoJCQkJCWlmICggaWR4ID09PSBudGggfHwgZm4uY2FsbCggb2JqLCBvYmpbaWR4XSwgaWR4ICkgPT09IGZhbHNlICkgewoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfQoKCQkJCW9mZnNldCArPSBzaXplOwoKCQkJCWlmICggb2Zmc2V0ID49IG50aCApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0sIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBmYWxzZSApOwoJCX0KCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBJdGVyYXRlcyBgb2JqYCBpbiByZXZlcnNlIGFuZCBleGVjdXRlcyBgZm5gIHdpdGggYXJndW1lbnRzIFtgdmFsdWVgLCBgaW5kZXhgXS4KCSAqIFJldHVybmluZyBgZmFsc2VgIGhhbHRzIGl0ZXJhdGlvbi4KCSAqCgkgKiBAbWV0aG9kIGVhY2hSZXZlcnNlCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgICBvYmogICBBcnJheSB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZm4gICAgRnVuY3Rpb24gdG8gZXhlY3V0ZSBvbiBpbmRleCB2YWx1ZXMKCSAqIEBwYXJhbSAge0Jvb2xlYW59ICBhc3luYyBbT3B0aW9uYWxdIEFzeW5jaHJvbm91cyBpdGVyYXRpb24KCSAqIEBwYXJhbSAge051bWJlcn0gICBzaXplICBbT3B0aW9uYWxdIEJhdGNoIHNpemUgZm9yIGFzeW5jIGl0ZXJhdGlvbiwgZGVmYXVsdCBpcyAxMAoJICogQHJldHVybiB7QXJyYXl9ICAgICAgICAgIEFycmF5CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuZWFjaFJldmVyc2UoIFsgLi4uIF0sIGZ1bmN0aW9uICggLi4uICkgeyAuLi4gfSApOwoJICoga2VpZ2FpLnV0aWwuYXJyYXkuZWFjaFJldmVyc2UoIFsgLi4uIF0sIGZ1bmN0aW9uICggLi4uICkgeyAuLi4gfSwgdHJ1ZSwgMTAwICk7IC8vIHByb2Nlc3NpbmcgYmF0Y2hlcyBvZiBhIDEwMAoJICovCgllYWNoUmV2ZXJzZSA6IGZ1bmN0aW9uICggb2JqLCBmbiwgYXN5bmMsIHNpemUgKSB7CgkJdmFyIG50aCA9IG9iai5sZW5ndGgsCgkJCWksIG9mZnNldDsKCgkJaWYgKCBhc3luYyAhPT0gdHJ1ZSApIHsKCQkJaSA9IG50aDsKCQkJd2hpbGUgKCAtLWkgPiAtMSApIHsKCQkJCWlmICggZm4uY2FsbCggb2JqLCBvYmpbaV0sIGkgKSA9PT0gZmFsc2UgKSB7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9CgkJZWxzZSB7CgkJCXNpemUgICA9IHNpemUgfHwgMTA7CgkJCW9mZnNldCA9IG50aCAtIDE7CgoJCQlpZiAoIHNpemUgPiBudGggKSB7CgkJCQlzaXplID0gbnRoOwoJCQl9CgoJCQl1dGlsaXR5LnJlcGVhdCggZnVuY3Rpb24gKCkgewoJCQkJdmFyIGkgPSAtMSwKCQkJCQlpZHg7CgoJCQkJd2hpbGUgKCArK2kgPCBzaXplICkgewoJCQkJCWlkeCA9IG9mZnNldCAtIGk7CgoJCQkJCWlmICggaWR4IDwgMCB8fCBmbi5jYWxsKCBvYmosIG9ialtpZHhdLCBpZHggKSA9PT0gZmFsc2UgKSB7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9CgoJCQkJb2Zmc2V0IC09IHNpemU7CgoJCQkJaWYgKCBvZmZzZXQgPCAwICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGZhbHNlICk7CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIERldGVybWluZXMgaWYgYW4gQXJyYXkgaXMgZW1wdHkKCSAqCgkgKiBAbWV0aG9kIGVtcHR5CgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gaW5zcGVjdAoJICogQHJldHVybiB7Qm9vbGVhbn0gICBgdHJ1ZWAgaWYgdGhlcmUncyBubyBpbmRpY2VzCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuZW1wdHkoIFtdICk7ICAgIC8vIHRydWUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmVtcHR5KCBbImEiXSApOyAvLyBmYWxzZQoJICovCgllbXB0eSA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiAoIG9iai5sZW5ndGggPT09IDAgKTsKCX0sCgoJLyoqCgkgKiBEZXRlcm1pbmVzIGlmIHR3byBBcnJheXMgYXJlIGVxdWFsCgkgKgoJICogQG1ldGhvZCBlcXVhbAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMSBBcnJheSB0byBjb21wYXJlCgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMiBBcnJheSB0byBjb21wYXJlCgkgKiBAcmV0dXJuIHtCb29sZWFufSBgdHJ1ZWAgaWYgdGhlIEFycmF5cyBtYXRjaAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmVxdWFsKCBbImEiXSwgWyJhIl0gKTsgICAgICAvLyB0cnVlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5lcXVhbCggWyJhIl0sIFsiYSIsICJiIl0gKTsgLy8gZmFsc2UKCSAqLwoJZXF1YWwgOiBmdW5jdGlvbiAoIG9iajEsIG9iajIgKSB7CgkJcmV0dXJuICgganNvbi5lbmNvZGUoIG9iajEgKSA9PT0ganNvbi5lbmNvZGUoIG9iajIgKSApOwoJfSwKCgkvKioKCSAqIEZpYm9uYWNjaSBnZW5lcmF0b3IKCSAqCgkgKiBAbWV0aG9kIGZpYgoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGFyZyBbT3B0aW9uYWxdIEFtb3VudCBvZiBudW1iZXJzIHRvIGdlbmVyYXRlLCBkZWZhdWx0IGlzIDEwMAoJICogQHJldHVybiB7QXJyYXl9ICAgICAgQXJyYXkgb2YgbnVtYmVycwoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmZpYiggNSApIC8vIFsxLCAxLCAyLCAzLCA1XTsKCSAqIGtlaWdhaS51dGlsLmFycmF5LmZpYiggNiApIC8vIFsxLCAxLCAyLCAzLCA1LCA4XTsKCSAqLwoJZmliIDogZnVuY3Rpb24gKCBhcmcgKSB7CgkJdmFyIHJlc3VsdCA9IFsxLCAxXSwKCQkgICAgZmlyc3QgID0gcmVzdWx0WzBdLAoJCSAgICBzZWNvbmQgPSByZXN1bHRbMV0sCgkJICAgIHN1bTsKCgkJLy8gU3VidHJhY3RpbmcgMSB0byBhY2NvdW50IGZvciBgZmlyc3RgICYgYHNlY29uZGAKCQlhcmcgPSAoIGFyZyB8fCAxMDAgKSAtIDE7CgkJCgkJaWYgKCBpc05hTiggYXJnICkgfHwgYXJnIDwgMiApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQl3aGlsZSAoIC0tYXJnICkgewoJCQlzdW0gICAgPSBmaXJzdCArIHNlY29uZDsKCQkJZmlyc3QgID0gc2Vjb25kOwoJCQlzZWNvbmQgPSBzdW07CgkJCXJlc3VsdC5wdXNoKCBzdW0gKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogRmlsbHMgYG9iamAgd2l0aCB0aGUgZXZhbHV0aW9uIG9mIGBhcmdgLCBvcHRpb25hbGx5IGZyb20gYHN0YXJ0YCB0byBgb2Zmc2V0YAoJICoKCSAqIEBtZXRob2QgZmlsbAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gIG9iaiAgIEFycmF5IHRvIGZpbGwKCSAqIEBwYXJhbSAge01peGVkfSAgYXJnICAgU3RyaW5nLCBOdW1iZXIgb2YgRnVuY3Rpb24gdG8gZmlsbCB3aXRoCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IHN0YXJ0IFtPcHRpb25hbF0gSW5kZXggdG8gYmVnaW4gZmlsbGluZyBhdAoJICogQHBhcmFtICB7TnVtYmVyfSBlbmQgICBbT3B0aW9uYWxdIE9mZnNldCBmcm9tIHN0YXJ0IHRvIHN0b3AgZmlsbGluZyBhdAoJICogQHJldHVybiB7QXJyYXl9ICAgICAgICBGaWxsZWQgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSA9IFsiYSIsICJiIiwgImMiXTsKCSAqCgkgKiBrZWlnYWkudXRpbC5hcnJheS5maWxsKCBteUFycmF5LCBmdW5jdGlvbiAoIGkgKSB7IHJldHVybiBpICsgImEiOyB9ICk7CgkgKiBteUFycmF5WzBdOyAvLyAiYWEiCgkgKi8KCWZpbGwgOiBmdW5jdGlvbiAoIG9iaiwgYXJnLCBzdGFydCwgb2Zmc2V0ICkgewoJCXZhciBmbiAgPSB0eXBlb2YgYXJnID09ICJmdW5jdGlvbiIsCgkJICAgIGwgICA9IG9iai5sZW5ndGgsCgkJICAgIGkgICA9ICFpc05hTiggc3RhcnQgKSA/IHN0YXJ0IDogMCwKCQkgICAgbnRoID0gIWlzTmFOKCBvZmZzZXQgKSA/IGkgKyBvZmZzZXQgOiBsIC0gMTsKCgkJaWYgKCBudGggPiAoIGwgLSAxICkgKSB7CgkJCW50aCA9IGwgLSAxOwoJCX0KCgkJd2hpbGUgKCBpIDw9IG50aCApIHsKCQkJb2JqW2ldID0gZm4gPyBhcmcoIG9ialtpXSApIDogYXJnOwoJCQlpKys7CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFJldHVybnMgdGhlIGZpcnN0IEFycmF5IGluZGV4CgkgKgoJICogQG1ldGhvZCBmaXJzdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqIFRoZSBhcnJheQoJICogQHJldHVybiB7TWl4ZWR9ICAgICBUaGUgZmlyc3Qgbm9kZSBvZiB0aGUgYXJyYXkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5maXJzdCggWyJhIiwgImIiXSApOyAvLyAiYSIKCSAqLwoJZmlyc3QgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gb2JqWzBdOwoJfSwKCgkvKioKCSAqIEZsYXR0ZW5zIGEgMkQgQXJyYXkKCSAqCgkgKiBAbWV0aG9kIGZsYXQKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiAyRCBBcnJheSB0byBmbGF0dGVuCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgIEZsYXR0ZW4gQXJyYXkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5mbGF0KCBbWzAsIDFdLCBbMiwgM11dICk7IC8vIFswLCAxLCAyLCAzXQoJICovCglmbGF0IDogZnVuY3Rpb24gKCBvYmogKSB7CgkJdmFyIHJlc3VsdCA9IFtdOwoKCQlyZXN1bHQgPSBvYmoucmVkdWNlKCBmdW5jdGlvbiAoIGEsIGIgKSB7CgkJCXJldHVybiBhLmNvbmNhdCggYiApOwoJCX0sIHJlc3VsdCApOwoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIEl0ZXJhdGVzIGBvYmpgIGFuZCBleGVjdXRlcyBgZm5gIHdpdGggYXJndW1lbnRzIFtgdmFsdWVgLCBgaW5kZXhgXS4KCSAqIFJldHVybmluZyBgZmFsc2VgIGhhbHRzIGl0ZXJhdGlvbi4KCSAqCgkgKiBAbWV0aG9kIGZvckVhY2gKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHNlZSBhcnJheS5lYWNoCgkgKiBAcGFyYW0gIHtBcnJheX0gICAgb2JqICAgQXJyYXkgdG8gaXRlcmF0ZQoJICogQHBhcmFtICB7RnVuY3Rpb259IGZuICAgIEZ1bmN0aW9uIHRvIGV4ZWN1dGUgb24gaW5kZXggdmFsdWVzCgkgKiBAcGFyYW0gIHtCb29sZWFufSAgYXN5bmMgW09wdGlvbmFsXSBBc3luY2hyb25vdXMgaXRlcmF0aW9uCgkgKiBAcGFyYW0gIHtOdW1iZXJ9ICAgc2l6ZSAgW09wdGlvbmFsXSBCYXRjaCBzaXplIGZvciBhc3luYyBpdGVyYXRpb24sIGRlZmF1bHQgaXMgMTAKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgICBBcnJheQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmZvckVhY2goIFsgLi4uIF0sIGZ1bmN0aW9uICggLi4uICkgeyAuLi4gfSApOwoJICoga2VpZ2FpLnV0aWwuYXJyYXkuZm9yRWFjaCggWyAuLi4gXSwgZnVuY3Rpb24gKCAuLi4gKSB7IC4uLiB9LCB0cnVlLCAxMDAgKTsgLy8gcHJvY2Vzc2luZyBiYXRjaGVzIG9mIGEgMTAwCgkgKi8KCWZvckVhY2ggOiBmdW5jdGlvbiAoIG9iaiwgZm4sIGFzeW5jLCBzaXplICkgewoJCXJldHVybiBhcnJheS5lYWNoKCBvYmosIGZuLCBhc3luYywgc2l6ZSApOwoJfSwKCgkvKioKCSAqIENyZWF0ZXMgYSAyRCBBcnJheSBmcm9tIGFuIE9iamVjdAoJICoKCSAqIEBtZXRob2QgZnJvbU9iamVjdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiBPYmplY3QgdG8gY29udmVydAoJICogQHJldHVybiB7QXJyYXl9ICAgICAgMkQgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5mcm9tT2JqZWN0KCB7bmFtZTogIkpvaG4iLCBzZXg6ICJtYWxlIn0gKTsgLy8gW1sibmFtZSIsICJKb2huIl0sIFsic2V4IiwgIm1hbGUiXV0KCSAqLwoJZnJvbU9iamVjdCA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBhcnJheS5taW5nbGUoIGFycmF5LmtleXMoIG9iaiApLCBhcnJheS5jYXN0KCBvYmogKSApOwoJfSwKCgkvKioKCSAqIEZhY2FkZSBvZiBpbmRleE9mCgkgKgoJICogQG1ldGhvZCBpbmRleAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqIEFycmF5IHRvIHNlYXJjaAoJICogQHBhcmFtICB7TWl4ZWR9IGFyZyBWYWx1ZSB0byBmaW5kIGluZGV4IG9mCgkgKiBAcmV0dXJuIHtOdW1iZXJ9ICAgIFRoZSBwb3NpdGlvbiBvZiBhcmcgaW4gaW5zdGFuY2UKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5pbmRleCggWyJhIiwgImIiLCAiYyJdLCAiYiIgKTsgLy8gMQoJICovCglpbmRleCA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJcmV0dXJuIG9iai5pbmRleE9mKCBhcmcgKTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIGFuIEFzc29jaWF0aXZlIEFycmF5IGFzIGFuIEluZGV4ZWQgQXJyYXkKCSAqCgkgKiBAbWV0aG9kIGluZGV4ZWQKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBpbmRleAoJICogQHJldHVybiB7QXJyYXl9ICAgICBJbmRleGVkIEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbImEiLCAiYiIsICJjIl07CgkgKgoJICogbXlBcnJheS5wcm9wID0gImQiOwoJICoga2VpZ2FpLnV0aWwuYXJyYXkuaW5kZXhlZCggbXlBcnJheSApOyBbImEiLCAiYiIsICJjIiwgImQiXTsKCSAqLwoJaW5kZXhlZCA6IGZ1bmN0aW9uICggb2JqICkgewoJCXZhciBpbmRleGVkID0gW107CgoJCXV0aWxpdHkuaXRlcmF0ZSggb2JqLCBmdW5jdGlvbiAoIHYgKSB7CgkJCWluZGV4ZWQucHVzaCggdiApOwoJCX0gKTsKCgkJcmV0dXJuIGluZGV4ZWQ7Cgl9LAoKCS8qKgoJICogRmluZHMgdGhlIGludGVyc2VjdGlvbnMgYmV0d2VlbiBvYmoxIGFuZCBvYmoyCgkgKgoJICogQG1ldGhvZCBpbnRlcnNlY3QKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iajEgU291cmNlIEFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMiBDb21wYXJpc29uIEFycmF5CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICBBcnJheSBvZiB0aGUgaW50ZXJzZWN0aW9ucwoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmludGVyc2VjdCggWyJhIiwgImIiLCAiZCJdLCBbImIiLCAiYyIsICJkIl0gKTsgLy8gWyJiIiwgImQiXQoJICovCglpbnRlcnNlY3QgOiBmdW5jdGlvbiAoIG9iajEsIG9iajIgKSB7CgkJdmFyIGEgPSBvYmoxLmxlbmd0aCA+IG9iajIubGVuZ3RoID8gb2JqMSA6IG9iajIsCgkJICAgIGIgPSAoIGEgPT09IG9iajEgPyBvYmoyIDogb2JqMSApOwoKCQlyZXR1cm4gYS5maWx0ZXIoIGZ1bmN0aW9uICgga2V5ICkgewoJCQlyZXR1cm4gYXJyYXkuY29udGFpbnMoIGIsIGtleSApOwoJCX0gKTsKCX0sCgoJLyoqCgkgKiBLZWVwcyBldmVyeSBlbGVtZW50IG9mIGBvYmpgIGZvciB3aGljaCBgZm5gIGV2YWx1YXRlcyB0byB0cnVlCgkgKgoJICogQG1ldGhvZCBrZWVwSWYKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9ICAgIG9iaiBBcnJheSB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZm4gIEZ1bmN0aW9uIHRvIHRlc3QgaW5kaWNlcyBhZ2FpbnN0CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgIEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbImEiLCAiYiIsICJjIl07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkua2VlcElmKCBteUFycmF5LCBmdW5jdGlvbiAoIGkgKSB7IHJldHVybiAvYXxjLy50ZXN0KCBpICk7IH0gKTsKCSAqIG15QXJyYXlbMV07IC8vICJjIgoJICovCglrZWVwSWYgOiBmdW5jdGlvbiAoIG9iaiwgZm4gKSB7CgkJaWYgKCB0eXBlb2YgZm4gIT0gImZ1bmN0aW9uIiApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQl2YXIgcmVzdWx0ID0gW10sCgkJICAgIHJlbW92ZSA9IFtdOwoKCQlyZXN1bHQgPSBvYmouZmlsdGVyKCBmbiApOwoJCXJlbW92ZSA9IGFycmF5LmRpZmYoIG9iaiwgcmVzdWx0ICk7CgoJCWFycmF5LmVhY2goIHJlbW92ZSwgZnVuY3Rpb24gKCBpICkgewoJCQlhcnJheS5yZW1vdmUoIG9iaiwgYXJyYXkuaW5kZXgoIG9iaiwgaSApICk7CgkJfSApOwoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFJldHVybnMgdGhlIGtleXMgaW4gYW4gIkFzc29jaWF0aXZlIEFycmF5IgoJICoKCSAqIEBtZXRob2Qga2V5cwoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtNaXhlZH0gb2JqIEFycmF5IG9yIE9iamVjdCB0byBleHRyYWN0IGtleXMgZnJvbQoJICogQHJldHVybiB7QXJyYXl9ICAgICBBcnJheSBvZiB0aGUga2V5cwoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmtleXMoIHthYmM6IHRydWUsIHh5ejogZmFsc2V9ICk7IC8vIFsiYWJjIiwgInh5eiJdCgkgKi8KCWtleXMgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gT2JqZWN0LmtleXMoIG9iaiApOwoJfSwKCgkvKioKCSAqIFNvcnRzIGFuIEFycmF5IGJhc2VkIG9uIGtleSB2YWx1ZXMsIGxpa2UgYW4gU1FMIE9SREVSIEJZIGNsYXVzZQoJICoKCSAqIEBtZXRob2Qga2V5U29ydAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gIG9iaiAgIEFycmF5IHRvIHNvcnQKCSAqIEBwYXJhbSAge1N0cmluZ30gcXVlcnkgU29ydCBxdWVyeSwgZS5nLiAibmFtZSwgYWdlIGRlc2MsIGNvdW50cnkiCgkgKiBAcGFyYW0gIHtTdHJpbmd9IHN1YiAgIFtPcHRpb25hbF0gS2V5IHdoaWNoIGhvbGRzIGRhdGEsIGUuZy4gIntkYXRhOiB7fX0iID0gImRhdGEiCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgIFNvcnRlZCBBcnJheQoJICogQGV4YW1wbGUKCSAqIHZhciBteUFycmF5ID0gW3thYmM6IDEyMzEyNCwgeHl6OiA1fSwge2FiYzogMTIzMTI0LCB4eXo6IDZ9LCB7YWJjOiAyLCB4eXo6IDV9XTsKCSAqCgkgKiBrZWlnYWkudXRpbC5hcnJheS5rZXlTb3J0KCBteUFycmF5LCAiYWJjIiApOyAgICAgICAgICAgLy8gW3thYmM6IDIsIHh5ejogNX0sIHthYmM6IDEyMzEyNCwgeHl6OiA1fSwge2FiYzogMTIzMTI0LCB4eXo6IDZ9XTsKCSAqIGtlaWdhaS51dGlsLmFycmF5LmtleVNvcnQoIG15QXJyYXksICJhYmMsIHh5eiBkZXNjIiApOyAvLyBbe2FiYzogMiwgeHl6OiA1fSwge2FiYzogMTIzMTI0LCB4eXo6IDZ9LCB7YWJjOiAxMjMxMjQsIHh5ejogNX1dOwoJICovCglrZXlTb3J0IDogZnVuY3Rpb24gKCBvYmosIHF1ZXJ5LCBzdWIgKSB7CgkJcXVlcnkgICAgICAgPSBxdWVyeS5yZXBsYWNlKCAvXHMqYXNjL2lnLCAiIiApLnJlcGxhY2UoIC9ccypkZXNjL2lnLCAiIGRlc2MiICk7CgkJdmFyIHF1ZXJpZXMgPSBzdHJpbmcuZXhwbG9kZSggcXVlcnkgKS5tYXAoIGZ1bmN0aW9uICggaSApIHsgcmV0dXJuIGkuc3BsaXQoICIgIiApOyB9ICksCgkJICAgIHNvcnRzICAgPSBbXSwKCQkgICAgYnJhY2VTICA9ICJbXCIiLAoJCSAgICBicmFjZUUgID0gIlwiXSI7CgoJCWlmICggc3ViICYmIHN1YiAhPT0gIiIgKSB7CgkJCXN1YiA9ICIuIiArIHN1YjsKCQl9CgkJZWxzZSB7CgkJCXN1YiA9ICIiOwoJCX0KCgkJYXJyYXkuZWFjaCggcXVlcmllcywgZnVuY3Rpb24gKCBpICkgewoJCQl2YXIgcyA9ICIuIiwKCQkJICAgIGUgPSAiIjsKCgkJCWlmICggcmVnZXgubm90X2RvdG5vdGF0aW9uLnRlc3QoIGlbMF0gKSApIHsKCQkJCXMgPSBicmFjZVM7CgkJCQllID0gYnJhY2VFOwoJCQl9CgoJCQlzb3J0cy5wdXNoKCAidHJ5IHsiICk7CgoJCQlpZiAoIGlbMV0gPT09ICJkZXNjIiApIHsKCQkJCXNvcnRzLnB1c2goICJpZiAoIGEiICsgc3ViICsgcyArIGlbMF0gKyBlICsgIiA8IGIiICsgc3ViICsgcyArIGlbMF0gKyBlICsgIiApIHJldHVybiAxOyIgKTsKCQkJCXNvcnRzLnB1c2goICJpZiAoIGEiICsgc3ViICsgcyArIGlbMF0gKyBlICsgIiA+IGIiICsgc3ViICsgcyArIGlbMF0gKyBlICsgIiApIHJldHVybiAtMTsiICk7CgkJCX0KCQkJZWxzZSB7CgkJCQlzb3J0cy5wdXNoKCAiaWYgKCBhIiArIHN1YiArIHMgKyBpWzBdICsgZSArICIgPCBiIiArIHN1YiArIHMgKyBpWzBdICsgZSArICIgKSByZXR1cm4gLTE7IiApOwoJCQkJc29ydHMucHVzaCggImlmICggYSIgKyBzdWIgKyBzICsgaVswXSArIGUgKyAiID4gYiIgKyBzdWIgKyBzICsgaVswXSArIGUgKyAiICkgcmV0dXJuIDE7IiApOwoJCQl9CgoJCQlzb3J0cy5wdXNoKCAifSBjYXRjaCAoZSkgeyIgKTsKCQkJc29ydHMucHVzaCggInRyeSB7IiApOwoJCQlzb3J0cy5wdXNoKCAiaWYgKCBhIiArIHN1YiArIHMgKyBpWzBdICsgZSArICIgIT09IHVuZGVmaW5lZCApIHJldHVybiAiICsgKCBpWzFdID09PSAiZGVzYyIgPyAiLTEiIDogIjEiKSArICI7IiApOwoJCQlzb3J0cy5wdXNoKCAifSBjYXRjaCAoZSkge30iICk7CgkJCXNvcnRzLnB1c2goICJ0cnkgeyIgKTsKCQkJc29ydHMucHVzaCggImlmICggYiIgKyBzdWIgKyBzICsgaVswXSArIGUgKyAiICE9PSB1bmRlZmluZWQgKSByZXR1cm4gIiArICggaVsxXSA9PT0gImRlc2MiID8gIjEiIDogIi0xIikgKyAiOyIgKTsKCQkJc29ydHMucHVzaCggIn0gY2F0Y2ggKGUpIHt9IiApOwoJCQlzb3J0cy5wdXNoKCAifSIgKTsKCQl9ICk7CgoJCXNvcnRzLnB1c2goICJyZXR1cm4gMDsiICk7CgoJCXJldHVybiBvYmouc29ydCggbmV3IEZ1bmN0aW9uKCAiYSIsICJiIiwgc29ydHMuam9pbiggIlxuIiApICkgKTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIHRoZSBsYXN0IGluZGV4IG9mIHRoZSBBcnJheQoJICoKCSAqIEBtZXRob2QgbGFzdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gIG9iaiBBcnJheQoJICogQHBhcmFtICB7TnVtYmVyfSBhcmcgW09wdGlvbmFsXSBOZWdhdGl2ZSBvZmZzZXQgZnJvbSBsYXN0IGluZGV4IHRvIHJldHVybgoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgTGFzdCBpbmRleCggcyApIG9mIEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbMSwgMiwgMywgNF07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkubGFzdCggbXlBcnJheSApOyAgICAvLyA0CgkgKiBrZWlnYWkudXRpbC5hcnJheS5sYXN0KCBteUFycmF5LCAyICk7IC8vIFszLCA0XQoJICovCglsYXN0IDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQl2YXIgbiA9IG9iai5sZW5ndGggLSAxOwoKCQlpZiAoIGFyZyA+PSAoIG4gKyAxICkgKSB7CgkJCXJldHVybiBvYmo7CgkJfQoJCWVsc2UgaWYgKCBpc05hTiggYXJnICkgfHwgYXJnID09PSAxICkgewoJCQlyZXR1cm4gb2JqW25dOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIGFycmF5LmxpbWl0KCBvYmosICggbiAtICggLS1hcmcgKSApLCBuICk7CgkJfQoJfSwKCgkvKioKCSAqIFJldHVybnMgYSBsaW1pdGVkIHJhbmdlIG9mIGluZGljZXMgZnJvbSB0aGUgQXJyYXkKCSAqCgkgKiBAbWV0aG9kIGxpbWl0CgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgb2JqICAgIEFycmF5IHRvIGl0ZXJhdGUKCSAqIEBwYXJhbSAge051bWJlcn0gc3RhcnQgIFN0YXJ0aW5nIGluZGV4CgkgKiBAcGFyYW0gIHtOdW1iZXJ9IG9mZnNldCBOdW1iZXIgb2YgaW5kaWNlcyB0byByZXR1cm4KCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgIEFycmF5IG9mIGluZGljZXMKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSA9IFsxLCAyLCAzLCA0XTsKCSAqCgkgKiBrZWlnYWkudXRpbC5hcnJheS5saW1pdCggbXlBcnJheSwgMCwgMiApOyAvLyBbMSwgMl0KCSAqIGtlaWdhaS51dGlsLmFycmF5LmxpbWl0KCBteUFycmF5LCAyLCAyICk7IC8vIFszLCA0XQoJICovCglsaW1pdCA6IGZ1bmN0aW9uICggb2JqLCBzdGFydCwgb2Zmc2V0ICkgewoJCXZhciByZXN1bHQgPSBbXSwKCQkgICAgaSAgICAgID0gc3RhcnQgLSAxLAoJCSAgICBudGggICAgPSBzdGFydCArIG9mZnNldCwKCQkgICAgbWF4ICAgID0gb2JqLmxlbmd0aDsKCgkJaWYgKCBtYXggPiAwICkgewoJCQl3aGlsZSAoICsraSA8IG50aCAmJiBpIDwgbWF4ICkgewoJCQkJcmVzdWx0LnB1c2goIG9ialtpXSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIEZpbmRzIHRoZSBtYXhpbXVtIHZhbHVlIGluIGFuIEFycmF5CgkgKgoJICogQG1ldGhvZCBtYXgKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBwcm9jZXNzCgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgIE51bWJlciwgU3RyaW5nLCBldGMuCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkubWF4KCBbNSwgMywgOSwgMSwgNF0gKTsgLy8gOQoJICovCgltYXggOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gYXJyYXkubGFzdCggb2JqLnNvcnQoIGFycmF5LnNvcnQgKSApOwoJfSwKCgkvKioKCSAqIEZpbmRzIHRoZSBtZWFuIG9mIGFuIEFycmF5ICggb2YgbnVtYmVycyApCgkgKgoJICogQG1ldGhvZCBtZWFuCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gcHJvY2VzcwoJICogQHJldHVybiB7TnVtYmVyfSAgICBNZWFuIG9mIHRoZSBBcnJheSAoIGZsb2F0IG9yIGludGVnZXIgKQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5Lm1lYW4oIFsxLCAzLCA1XSApOyAvLyAzCgkgKi8KCW1lYW4gOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gb2JqLmxlbmd0aCA+IDAgPyAoIGFycmF5LnN1bSggb2JqICkgLyBvYmoubGVuZ3RoICkgOiB1bmRlZmluZWQ7Cgl9LAoKCS8qKgoJICogRmluZHMgdGhlIG1lZGlhbiB2YWx1ZSBvZiBhbiBBcnJheSAoIG9mIG51bWJlcnMgKQoJICoKCSAqIEBtZXRob2QgbWVkaWFuCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gcHJvY2VzcwoJICogQHJldHVybiB7TnVtYmVyfSAgICBNZWRpYW4gbnVtYmVyIG9mIHRoZSBBcnJheSAoIGZsb2F0IG9yIGludGVnZXIgKQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5Lm1lZGlhbiggWzUsIDEsIDMsIDhdICk7IC8vIDQKCSAqIGtlaWdhaS51dGlsLmFycmF5Lm1lZGlhbiggWzUsIDEsIDNdICk7ICAgIC8vIDMKCSAqLwoJbWVkaWFuIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJdmFyIG50aCAgICA9IG9iai5sZW5ndGgsCgkJICAgIG1pZCAgICA9IG51bWJlci5yb3VuZCggbnRoIC8gMiwgImRvd24iICksCgkJICAgIHNvcnRlZCA9IG9iai5zb3J0KCBhcnJheS5zb3J0ICk7CgoJCXJldHVybiBudW1iZXIub2RkKCBudGggKSA/IHNvcnRlZFttaWRdIDogKCAoIHNvcnRlZFttaWQgLSAxXSArIHNvcnRlZFttaWRdICkgLyAyICk7Cgl9LAoKCS8qKgoJICogTWVyZ2VzIGBhcmdgIGludG8gYG9iamAsIGV4Y2x1ZGluZyBkdXBsaWNhdGUgaW5kaWNlcwoJICoKCSAqIEBtZXRob2QgbWVyZ2UKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iajEgQXJyYXkgdG8gcmVjZWl2ZSBpbmRpY2VzCgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMiBBcnJheSB0byBtZXJnZQoJICogQHJldHVybiB7QXJyYXl9ICAgICAgRmlyc3QgYXJndW1lbnQKCSAqIEBleGFtcGxlCgkgKiB2YXIgYSA9IFsiYSIsICJiIiwgImMiXSwKCSAqICAgICBiID0gWyJkIl07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkubWVyZ2UoIGEsIGIgKTsKCSAqIGFbM107IC8vICJkIgoJICovCgltZXJnZSA6IGZ1bmN0aW9uICggb2JqMSwgb2JqMiApIHsKCQlhcnJheS5lYWNoKCBvYmoyLCBmdW5jdGlvbiAoIGkgKSB7CgkJCWFycmF5LmFkZCggb2JqMSwgaSApOwoJCX0gKTsKCgkJcmV0dXJuIG9iajE7Cgl9LAoKCS8qKgoJICogRmluZHMgdGhlIG1pbmltdW0gdmFsdWUgaW4gYW4gQXJyYXkKCSAqCgkgKiBAbWV0aG9kIG1pbgoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqIEFycmF5IHRvIHByb2Nlc3MKCSAqIEByZXR1cm4ge01peGVkfSAgICAgTnVtYmVyLCBTdHJpbmcsIGV0Yy4KCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5taW4oIFs1LCAzLCA5LCAxLCA0XSApOyAvLyAxCgkgKi8KCW1pbiA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBvYmouc29ydCggYXJyYXkuc29ydCApWzBdOwoJfSwKCgkvKioKCSAqIE1pbmdsZXMgQXJyYXlzIGFuZCByZXR1cm5zIGEgMkQgQXJyYXkKCSAqCgkgKiBAbWV0aG9kIG1pbmdsZQoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMSBBcnJheSB0byBtaW5nbGUKCSAqIEBwYXJhbSAge0FycmF5fSBvYmoyIEFycmF5IHRvIG1pbmdsZQoJICogQHJldHVybiB7QXJyYXl9ICAgICAgMkQgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiB2YXIgYSA9IFsiYSIsICJiIl0sCgkgKiAgICAgYiA9IFsiYyIsICJkIl07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkubWluZ2xlKCBhLCBiICk7IC8vIFtbImEiLCAiYyJdLCBbImIiLCAiZCJdXQoJICovCgltaW5nbGUgOiBmdW5jdGlvbiAoIG9iajEsIG9iajIgKSB7CgkJdmFyIHJlc3VsdDsKCgkJcmVzdWx0ID0gb2JqMS5tYXAoIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCQlyZXR1cm4gW2ksIG9iajJbaWR4XV07CgkJfSApOwoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIEZpbmRzIHRoZSBtb2RlIHZhbHVlIG9mIGFuIEFycmF5CgkgKgoJICogQG1ldGhvZCBtb2RlCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gcHJvY2VzcwoJICogQHJldHVybiB7TWl4ZWR9ICAgICBNb2RlIHZhbHVlIG9mIHRoZSBBcnJheQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5Lm1vZGUoIFsxLCAzLCA3LCAxLCAyLCAxMCwgNywgNywgMywgMTBdICk7ICAgICAvLyA3CgkgKiBrZWlnYWkudXRpbC5hcnJheS5tb2RlKCBbMSwgMywgNywgMSwgMiwgMTAsIDcsIDcsIDMsIDEwLCAxMF0gKTsgLy8gWzcsIDEwXQoJICovCgltb2RlIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJdmFyIHZhbHVlcyA9IHt9LAoJCSAgICBjb3VudCAgPSAwLAoJCSAgICBtb2RlICAgPSBbXSwKCQkgICAgbnRoLCByZXN1bHQ7CgoJCS8vIENvdW50aW5nIHZhbHVlcwoJCWFycmF5LmVhY2goIG9iaiwgZnVuY3Rpb24gKCBpICkgewoJCQlpZiAoICFpc05hTiggdmFsdWVzW2ldICkgKSB7CgkJCQl2YWx1ZXNbaV0rKzsKCQkJfQoJCQllbHNlIHsKCQkJCXZhbHVlc1tpXSA9IDE7CgkJCX0KCQl9ICk7CgoJCS8vIEZpbmRpbmcgdGhlIGhpZ2hlc3Qgb2NjdXJyaW5nIGNvdW50CgkJY291bnQgPSBhcnJheS5tYXgoIGFycmF5LmNhc3QoIHZhbHVlcyApICk7CgoJCS8vIEZpbmRpbmcgdmFsdWVzIHRoYXQgbWF0Y2ggdGhlIGNvdW50CgkJdXRpbGl0eS5pdGVyYXRlKCB2YWx1ZXMsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJaWYgKCB2ID09PSBjb3VudCApIHsKCQkJCW1vZGUucHVzaCggbnVtYmVyLnBhcnNlKCBrICkgKTsKCQkJfQoJCX0gKTsKCgkJLy8gRGV0ZXJtaW5pbmcgdGhlIHJlc3VsdAoJCW50aCA9IG1vZGUubGVuZ3RoOwoKCQlpZiAoIG50aCA+IDAgKSB7CgkJCXJlc3VsdCA9IG50aCA9PT0gMSA/IG1vZGVbMF0gOiBtb2RlOwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGFuIEFycmF5IG9mIHBlcmNlbnRhZ2VzIGZyb20gYW4gQXJyYXkgb2YgTnVtYmVycyAoaW50cy9mbG9hdHMpCgkgKgoJICogQG1ldGhvZCBwZXJjZW50cwoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gIG9iaiAgICAgICBBcnJheSB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IHByZWNpc2lvbiBbT3B0aW9uYWxdIFJvdW5kaW5nIHByZWNpc2lvbgoJICogQHBhcmFtICB7TnVtYmVyfSB0b3RhbCAgICAgW09wdGlvbmFsXSBWYWx1ZSB0byBjb21wYXJlIGFnYWluc3QKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgICAgIEFycmF5IG9mIHBlcmNlbnRzCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkucGVyY2VudHMoIFsxLCAyLCAzLCAzN10gKTsgLy8gWzIsIDUsIDcsIDg2XQoJICovCglwZXJjZW50cyA6IGZ1bmN0aW9uICggb2JqLCBwcmVjaXNpb24sIHRvdGFsICkgewoJCXZhciByZXN1bHQgPSBbXSwKCQkgICAgY3VzdG9tID0gZmFsc2UsCgkJICAgIGxhc3QsIHBhZGRpbmcsIHN1bTsKCgkJcHJlY2lzaW9uID0gcHJlY2lzaW9uIHx8IDA7CgkJCgkJaWYgKCB0b3RhbCA9PT0gdW5kZWZpbmVkICkgewoJCQl0b3RhbCA9IGFycmF5LnN1bSggb2JqICk7CgkJfQoJCWVsc2UgewoJCQljdXN0b20gPSB0cnVlOwoJCX0KCgkJYXJyYXkuZWFjaCggb2JqLCBmdW5jdGlvbiAoIGkgKSB7CgkJCXJlc3VsdC5wdXNoKCBudW1iZXIucGFyc2UoICggKCBpIC8gdG90YWwgKSAqIDEwMCApLnRvRml4ZWQoIHByZWNpc2lvbiApICkgKTsKCQl9ICk7CgoJCS8vIERlYWxpbmcgd2l0aCB0aGUgYXdlc29tZW5lc3Mgb2YgSmF2YVNjcmlwdCAiaW50ZWdlcnMiCgkJaWYgKCAhY3VzdG9tICkgewoJCQlzdW0gPSBhcnJheS5zdW0oIHJlc3VsdCApOwoKCQkJaWYgKCBzdW0gPCAxMDAgKSB7CgkJCQlwYWRkaW5nID0gbnVtYmVyLnBhcnNlKCBudW1iZXIuZGlmZiggc3VtLCAxMDAgKS50b0ZpeGVkKCBwcmVjaXNpb24gKSApOwoJCQkJbGFzdCAgICA9IGFycmF5Lmxhc3QoIHJlc3VsdCApICsgcGFkZGluZzsKCQkJCXJlc3VsdFtyZXN1bHQubGVuZ3RoIC0gMV0gPSBsYXN0OwoJCQl9CgkJCWVsc2UgaWYgKCBzdW0gPiAxMDAgKSB7CgkJCQlwYWRkaW5nID0gbnVtYmVyLnBhcnNlKCBudW1iZXIuZGlmZiggc3VtLCAxMDAgKS50b0ZpeGVkKCBwcmVjaXNpb24gKSApOwoJCQkJbGFzdCAgICA9IG51bWJlci5wYXJzZSggKCBhcnJheS5sYXN0KCByZXN1bHQgKSAtIHBhZGRpbmcgKS50b0ZpeGVkKCBwcmVjaXNpb24gKSApOwoJCQkJcmVzdWx0W3Jlc3VsdC5sZW5ndGggLSAxXSA9IGxhc3Q7CgkJCX0KCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogRmluZHMgdGhlIHJhbmdlIG9mIHRoZSBBcnJheSAoIG9mIG51bWJlcnMgKSB2YWx1ZXMKCSAqCgkgKiBAbWV0aG9kIHJhbmdlCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gcHJvY2VzcwoJICogQHJldHVybiB7TnVtYmVyfSAgICBSYW5nZSBvZiB0aGUgYXJyYXkgKCBmbG9hdCBvciBpbnRlZ2VyICkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5yYW5nZSggWzUsIDEsIDMsIDhdICk7IC8vIDcKCSAqLwoJcmFuZ2UgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gYXJyYXkubWF4KCBvYmogKSAtIGFycmF5Lm1pbiggb2JqICk7Cgl9LAoKCS8qKgoJICogU2VhcmNoZXMgYSAyRCBBcnJheSBgb2JqYCBmb3IgdGhlIGZpcnN0IG1hdGNoIG9mIGBhcmdgIGFzIGEgc2Vjb25kIGluZGV4CgkgKgoJICogQG1ldGhvZCByYXNzb2MKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiAyRCBBcnJheSB0byBzZWFyY2gKCSAqIEBwYXJhbSAge01peGVkfSBhcmcgUHJpbWl0aXZlIHRvIGZpbmQKCSAqIEByZXR1cm4ge01peGVkfSAgICAgQXJyYXkgb3IgdW5kZWZpbmVkCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkucmFzc29jKCBbWzEsIDNdLCBbNywgMl0sIFs0LCAzXV0sIDMgKTsgLy8gWzEsIDNdCgkgKi8KCXJhc3NvYyA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJdmFyIHJlc3VsdDsKCgkJYXJyYXkuZWFjaCggb2JqLCBmdW5jdGlvbiAoIGksIGlkeCApIHsKCQkJaWYgKCBpWzFdID09PSBhcmcgKSB7CgkJCQlyZXN1bHQgPSBvYmpbaWR4XTsKCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9ICk7CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogUmV0dXJucyBBcnJheSBjb250YWluaW5nIHRoZSBpdGVtcyBpbiBgb2JqYCBmb3Igd2hpY2ggYGZuKClgIGlzIG5vdCB0cnVlCgkgKgoJICogQG1ldGhvZCByZWplY3QKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9ICAgIG9iaiBBcnJheSB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZm4gIEZ1bmN0aW9uIHRvIGV4ZWN1dGUgYWdhaW5zdCBgb2JqYCBpbmRpY2VzCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgIEFycmF5IG9mIGluZGljZXMgd2hpY2ggZm4oKSBpcyBub3QgdHJ1ZQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LnJlamVjdCggWzAsIDEsIDIsIDMsIDQsIDVdLCBmdW5jdGlvbiAoIGkgKSB7IHJldHVybiBpICUgMiA+IDA7IH0gKTsgLy8gWzAsIDIsIDRdCgkgKi8KCXJlamVjdCA6IGZ1bmN0aW9uICggb2JqLCBmbiApIHsKCQlyZXR1cm4gYXJyYXkuZGlmZiggb2JqLCBvYmouZmlsdGVyKCBmbiApICk7Cgl9LAoKCS8qKgoJICogUmVtb3ZlcyBpbmRpY2VzIGZyb20gYW4gQXJyYXkgd2l0aG91dCByZWNyZWF0aW5nIGl0CgkgKgoJICogQG1ldGhvZCByZW1vdmUKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9ICBvYmogICBBcnJheSB0byByZW1vdmUgZnJvbQoJICogQHBhcmFtICB7TWl4ZWR9ICBzdGFydCBTdGFydGluZyBpbmRleCwgb3IgdmFsdWUgdG8gZmluZCB3aXRoaW4gb2JqCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGVuZCAgIFtPcHRpb25hbF0gRW5kaW5nIGluZGV4CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgIE1vZGlmaWVkIEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbImEiLCAiYiIsICJjIiwgImQiLCAiZSJdOwoJICoKCSAqIGtlaWdhaS51dGlsLmFycmF5LnJlbW92ZSggbXlBcnJheSwgMiwgMyApOwoJICogbXlBcnJheVsyXTsgLy8gImUiCgkgKi8KCXJlbW92ZSA6IGZ1bmN0aW9uICggb2JqLCBzdGFydCwgZW5kICkgewoJCWlmICggaXNOYU4oIHN0YXJ0ICkgKSB7CgkJCXN0YXJ0ID0gb2JqLmluZGV4T2YoIHN0YXJ0ICk7CgoJCQlpZiAoIHN0YXJ0ID09PSAtMSApIHsKCQkJCXJldHVybiBvYmo7CgkJCX0KCQl9CgkJZWxzZSB7CgkJCXN0YXJ0ID0gc3RhcnQgfHwgMDsKCQl9CgoJCXZhciBsZW5ndGggICAgPSBvYmoubGVuZ3RoLAoJCSAgICByZW1haW5pbmcgPSBvYmouc2xpY2UoICggZW5kIHx8IHN0YXJ0ICkgKyAxIHx8IGxlbmd0aCApOwoKCQlvYmoubGVuZ3RoID0gc3RhcnQgPCAwID8gKCBsZW5ndGggKyBzdGFydCApIDogc3RhcnQ7CgkJb2JqLnB1c2guYXBwbHkoIG9iaiwgcmVtYWluaW5nICk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogRGVsZXRlcyBldmVyeSBlbGVtZW50IG9mIGBvYmpgIGZvciB3aGljaCBgZm5gIGV2YWx1YXRlcyB0byB0cnVlCgkgKgoJICogQG1ldGhvZCByZW1vdmVJZgoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gICAgb2JqIEFycmF5IHRvIGl0ZXJhdGUKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiAgRnVuY3Rpb24gdG8gdGVzdCBpbmRpY2VzIGFnYWluc3QKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSA9IFsiYSIsICJiIiwgImMiXTsKCSAqCgkgKiBrZWlnYWkudXRpbC5hcnJheS5yZW1vdmVJZiggbXlBcnJheSwgZnVuY3Rpb24gKCBpICkgeyByZXR1cm4gL2F8Yy8udGVzdCggaSApOyB9ICk7CgkgKiBteUFycmF5WzBdOyAvLyAiYiIKCSAqLwoJcmVtb3ZlSWYgOiBmdW5jdGlvbiAoIG9iaiwgZm4gKSB7CgkJdmFyIHJlbW92ZTsKCgkJaWYgKCB0eXBlb2YgZm4gIT0gImZ1bmN0aW9uIiApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQlyZW1vdmUgPSBvYmouZmlsdGVyKCBmbiApOwoKCQlhcnJheS5lYWNoKCByZW1vdmUsIGZ1bmN0aW9uICggaSApIHsKCQkJYXJyYXkucmVtb3ZlKCBvYmosIGFycmF5LmluZGV4ICggb2JqLCBpICkgKTsKCQl9ICk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogRGVsZXRlcyBlbGVtZW50cyBvZiBgb2JqYCB1bnRpbCBgZm5gIGV2YWx1YXRlcyB0byBmYWxzZQoJICoKCSAqIEBtZXRob2QgcmVtb3ZlV2hpbGUKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9ICAgIG9iaiBBcnJheSB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZm4gIEZ1bmN0aW9uIHRvIHRlc3QgaW5kaWNlcyBhZ2FpbnN0CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgIEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbImEiLCAiYiIsICJjIl07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkucmVtb3ZlV2hpbGUoIG15QXJyYXksIGZ1bmN0aW9uICggaSApIHsgcmV0dXJuIC9hfGMvLnRlc3QoIGkgKTsgfSApOwoJICogbXlBcnJheVswXTsgICAgIC8vICJiIgoJICogbXlBcnJheS5sZW5ndGg7IC8vIDIKCSAqLwoJcmVtb3ZlV2hpbGUgOiBmdW5jdGlvbiAoIG9iaiwgZm4gKSB7CgkJaWYgKCB0eXBlb2YgZm4gIT0gImZ1bmN0aW9uIiApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQl2YXIgcmVtb3ZlID0gW107CgoJCWFycmF5LmVhY2goIG9iaiwgZnVuY3Rpb24gKCBpICkgewoJCQlpZiAoIGZuKCBpICkgIT09IGZhbHNlICkgewoJCQkJcmVtb3ZlLnB1c2goIGkgKTsKCQkJfQoJCQllbHNlIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0gKTsKCgkJYXJyYXkuZWFjaCggcmVtb3ZlLCBmdW5jdGlvbiAoIGkgKSB7CgkJCWFycmF5LnJlbW92ZSggb2JqLCBhcnJheS5pbmRleCggb2JqLCBpICkgKTsKCQl9ICk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogUmVwbGFjZXMgdGhlIGNvbnRlbnRzIG9mIGBvYmpgIHdpdGggYGFyZ2AKCSAqCgkgKiBAbWV0aG9kIHJlcGxhY2UKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iajEgQXJyYXkgdG8gbW9kaWZ5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMiBBcnJheSB0byB2YWx1ZXMgdG8gcHVzaCBpbnRvIGBvYmoxYAoJICogQHJldHVybiB7QXJyYXl9ICAgICAgQXJyYXkgdG8gbW9kaWZ5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbImEiLCAiYiIsICJjIl07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkucmVwbGFjZSggbXlBcnJheSwgW3RydWUsIGZhbHNlXSApOwoJICogbXlBcnJheVswXTsgICAgIC8vIHRydWUKCSAqIG15QXJyYXkubGVuZ3RoOyAvLyAyCgkgKi8KCXJlcGxhY2UgOiBmdW5jdGlvbiAoIG9iajEsIG9iajIgKSB7CgkJYXJyYXkucmVtb3ZlKCBvYmoxLCAwLCBvYmoxLmxlbmd0aCApOwoJCWFycmF5LmVhY2goIG9iajIsIGZ1bmN0aW9uICggaSApIHsKCQkJb2JqMS5wdXNoKCBpICk7CgkJfSApOwoKCQlyZXR1cm4gb2JqMTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIHRoZSAicmVzdCIgb2YgYG9iamAgZnJvbSBgYXJnYAoJICoKCSAqIEBtZXRob2QgcmVzdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gIG9iaiBBcnJheSB0byBwcm9jZXNzCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGFyZyBbT3B0aW9uYWxdIFN0YXJ0IHBvc2l0aW9uIG9mIHN1YnNldCBvZiBgb2JqYCAoIHBvc2l0aXZlIG51bWJlciBvbmx5ICkKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgIEFycmF5IG9mIGEgc3Vic2V0IG9mIGBvYmpgCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkucmVzdCggWzEsIDIsIDMsIDQsIDUsIDZdICk7ICAgIC8vIFsyLCAzLCA0LCA1LCA2XQoJICoga2VpZ2FpLnV0aWwuYXJyYXkucmVzdCggWzEsIDIsIDMsIDQsIDUsIDZdLCAzICk7IC8vIFs0LCA1LCA2XQoJICovCglyZXN0IDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQlhcmcgPSBhcmcgfHwgMTsKCgkJaWYgKCBhcmcgPCAxICkgewoJCQlhcmcgPSAxOwoJCX0KCgkJcmV0dXJuIGFycmF5LmxpbWl0KCBvYmosIGFyZywgb2JqLmxlbmd0aCApOwoJfSwKCgkvKioKCSAqIEZpbmRzIHRoZSBsYXN0IGluZGV4IG9mIGBhcmdgIGluIGBvYmpgCgkgKgoJICogQG1ldGhvZCByaW5kZXgKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBzZWFyY2gKCSAqIEBwYXJhbSAge01peGVkfSBhcmcgUHJpbWl0aXZlIHRvIGZpbmQKCSAqIEByZXR1cm4ge01peGVkfSAgICAgSW5kZXggb3IgdW5kZWZpbmVkCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkucmluZGV4KCBbMSwgMiwgMywgMiwgMV0sIDIgKTsgLy8gMwoJICovCglyaW5kZXggOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCXZhciByZXN1bHQgPSAtMTsKCgkJYXJyYXkuZWFjaCggb2JqLCBmdW5jdGlvbiAoIGksIGlkeCApIHsKCQkJaWYgKCBpID09PSBhcmcgKSB7CgkJCQlyZXN1bHQgPSBpZHg7CgkJCX0KCQl9ICk7CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogUmV0dXJucyBuZXcgQXJyYXkgd2l0aCBgYXJnYCBtb3ZlZCB0byB0aGUgZmlyc3QgaW5kZXgKCSAqCgkgKiBAbWV0aG9kIHJvdGF0ZQoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gIG9iaiBBcnJheSB0byByb3RhdGUKCSAqIEBwYXJhbSAge051bWJlcn0gYXJnIEluZGV4IHRvIGJlY29tZSB0aGUgZmlyc3QgaW5kZXgsIGlmIG5lZ2F0aXZlIHRoZSByb3RhdGlvbiBpcyBpbiB0aGUgb3Bwb3NpdGUgZGlyZWN0aW9uCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICBOZXdseSByb3RhdGVkIEFycmF5CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkucm90YXRlKCBbMCwgMSwgMiwgMywgNF0sICAzIClbMF0gLy8gMjsKCSAqIGtlaWdhaS51dGlsLmFycmF5LnJvdGF0ZSggWzAsIDEsIDIsIDMsIDRdLCAtMiApWzBdIC8vIDM7CgkgKi8KCXJvdGF0ZSA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJdmFyIG50aCA9IG9iai5sZW5ndGgsCgkJICAgIHJlc3VsdDsKCgkJaWYgKCBhcmcgPT09IDAgKSB7CgkJCXJlc3VsdCA9IG9iajsKCQl9CgkJZWxzZSB7CgkJCWlmICggYXJnIDwgMCApIHsKCQkJCWFyZyArPSBudGg7CgkJCX0KCQkJZWxzZSB7CgkJCQlhcmctLTsKCQkJfQoKCQkJcmVzdWx0ID0gYXJyYXkubGltaXQoIG9iaiwgYXJnLCBudGggKTsKCQkJcmVzdWx0ID0gcmVzdWx0LmNvbmNhdCggYXJyYXkubGltaXQoIG9iaiwgMCwgYXJnICkgKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogR2VuZXJhdGVzIGEgc2VyaWVzIEFycmF5CgkgKgoJICogQG1ldGhvZCBzZXJpZXMKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7TnVtYmVyfSBzdGFydCAgU3RhcnQgdmFsdWUgdGhlIHNlcmllcwoJICogQHBhcmFtICB7TnVtYmVyfSBlbmQgICAgW09wdGlvbmFsXSBUaGUgZW5kIG9mIHRoZSBzZXJpZXMKCSAqIEBwYXJhbSAge051bWJlcn0gb2Zmc2V0IFtPcHRpb25hbF0gT2Zmc2V0IGZvciBpbmRpY2VzLCBkZWZhdWx0IGlzIDEKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgIEFycmF5IG9mIG5ldyBzZXJpZXMKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5zZXJpZXMoIDAsIDUgKTsgICAgIC8vIFswLCAxLCAyLCAzLCA0XQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuc2VyaWVzKCAwLCAyNSwgNSApOyAvLyBbMCwgNSwgMTAsIDE1LCAyMF0KCSAqLwoJc2VyaWVzIDogZnVuY3Rpb24gKCBzdGFydCwgZW5kLCBvZmZzZXQgKSB7CgkJc3RhcnQgICAgICA9IHN0YXJ0ICB8fCAwOwoJCWVuZCAgICAgICAgPSBlbmQgICAgfHwgc3RhcnQ7CgkJb2Zmc2V0ICAgICA9IG9mZnNldCB8fCAxOwoJCXZhciByZXN1bHQgPSBbXSwKCQkgICAgbiAgICAgID0gLTEsCgkJICAgIG50aCAgICA9IE1hdGgubWF4KCAwLCBNYXRoLmNlaWwoICggZW5kIC0gc3RhcnQgKSAvIG9mZnNldCApICk7CgoJCXdoaWxlICggKytuIDwgbnRoICkgewoJCQlyZXN1bHRbbl0gID0gc3RhcnQ7CgkJCXN0YXJ0ICAgICArPSBvZmZzZXQ7CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIFNvcnRzIHRoZSBBcnJheSBieSBwYXJzaW5nIHZhbHVlcwoJICoKCSAqIEBtZXRob2Qgc29ydAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtNaXhlZH0gYSBBcmd1bWVudCB0byBjb21wYXJlCgkgKiBAcGFyYW0gIHtNaXhlZH0gYiBBcmd1bWVudCB0byBjb21wYXJlCgkgKiBAcmV0dXJuIHtOdW1iZXJ9ICBOdW1iZXIgaW5kaWNhdGluZyBzb3J0IG9yZGVyCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuc29ydCggMiwgMyApOyAvLyAtMQoJICovCglzb3J0IDogZnVuY3Rpb24gKCBhLCBiICkgewoJCXZhciB0eXBlcyA9IHthOiB0eXBlb2YgYSwgYjogdHlwZW9mIGJ9LAoJCSAgICBjLCBkLCByZXN1bHQ7CgoJCWlmICggdHlwZXMuYSA9PT0gIm51bWJlciIgJiYgdHlwZXMuYiA9PT0gIm51bWJlciIgKSB7CgkJCXJlc3VsdCA9IGEgLSBiOwoJCX0KCQllbHNlIHsKCQkJYyA9IGEudG9TdHJpbmcoKTsKCQkJZCA9IGIudG9TdHJpbmcoKTsKCgkJCWlmICggYyA8IGQgKSB7CgkJCQlyZXN1bHQgPSAtMTsKCQkJfQoJCQllbHNlIGlmICggYyA+IGQgKSB7CgkJCQlyZXN1bHQgPSAxOwoJCQl9CgkJCWVsc2UgaWYgKCB0eXBlcy5hID09PSB0eXBlcy5iICkgewoJCQkJcmVzdWx0ID0gMDsKCQkJfQoJCQllbHNlIGlmICggdHlwZXMuYSA9PT0gImJvb2xlYW4iICkgewoJCQkJcmVzdWx0ID0gLTE7CgkJCX0KCQkJZWxzZSB7CgkJCQlyZXN1bHQgPSAxOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIFNvcnRzIGBvYmpgIHVzaW5nIGBhcnJheS5zb3J0YAoJICoKCSAqIEBtZXRob2Qgc29ydGVkCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gc29ydAoJICogQHJldHVybiB7QXJyYXl9ICAgICBTb3J0ZWQgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSA9IFs1LCA5LCAyLCA0XTsKCSAqCgkgKiBrZWlnYWkudXRpbC5hcnJheS5zb3J0ZWQoIG15QXJyYXkgKTsKCSAqIG15QXJyYXlbMF07IC8vIDIKCSAqLwoJc29ydGVkIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIG9iai5zb3J0KCBhcnJheS5zb3J0ICk7Cgl9LAoKCS8qKgoJICogU3BsaXRzIGFuIEFycmF5IGJ5IGRpdmlzb3IKCSAqCgkgKiBAbWV0aG9kIHNwbGl0CgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgb2JqICAgICBBcnJheSB0byBwcm9jZXNzCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGRpdmlzb3IgSW50ZWdlciB0byBkaXZpZGUgdGhlIEFycmF5IGJ5CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgICAgU3BsaXQgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSA9IFtdLAoJICogICAgIGkgICAgICAgPSAtMSwKCSAqICAgICByZXN1bHRzOwoJICoKCSAqIHdoaWxlICggKytpIDwgMTAwICkgewoJICogICBteUFycmF5LnB1c2goIGkgKyAxICk7CgkgKiB9CgkgKgoJICogcmVzdWx0cyA9IGtlaWdhaS51dGlsLmFycmF5LnNwbGl0KCBteUFycmF5LCAyMSApOwoJICogcmVzdWx0cy5sZW5ndGg7ICAgICAvLyAyMQoJICogcmVzdWx0c1swXS5sZW5ndGg7ICAvLyA1CgkgKiByZXN1bHRzWzE5XS5sZW5ndGg7IC8vIDQKCSAqIHJlc3VsdHNbMTldWzBdOyAgICAgLy8gOTkKCSAqIHJlc3VsdHNbMjBdLmxlbmd0aDsgLy8gMQoJICogcmVzdWx0c1syMF1bMF07ICAgICAvLyAxMDAKCSAqLwoJc3BsaXQgOiBmdW5jdGlvbiAoIG9iaiwgZGl2aXNvciApIHsKCQl2YXIgcmVzdWx0ICA9IFtdLAoJCSAgICB0b3RhbCAgID0gb2JqLmxlbmd0aCwKCQkgICAgbnRoICAgICA9IE1hdGguY2VpbCggdG90YWwgLyBkaXZpc29yICksCgkJICAgIGxvdyAgICAgPSBNYXRoLmZsb29yKCB0b3RhbCAvIGRpdmlzb3IgKSwKCQkgICAgbG93ZXIgICA9IE1hdGguY2VpbCggdG90YWwgLyBudGggKSwKCQkgICAgbG93ZXJlZCA9IGZhbHNlLAoJCSAgICBzdGFydCAgID0gMCwKCQkgICAgaSAgICAgICA9IC0xOwoKCQkvLyBGaW5kaW5nIHRoZSBmb2xkCgkJaWYgKCBudW1iZXIuZGlmZiggdG90YWwsICggZGl2aXNvciAqIG50aCApICkgPiBudGggKSB7CgkJCWxvd2VyID0gdG90YWwgLSAoIGxvdyAqIGRpdmlzb3IgKSArIGxvdyAtIDE7CgkJfQoJCWVsc2UgaWYgKCB0b3RhbCAlIGRpdmlzb3IgPiAwICYmIGxvd2VyICogbnRoID49IHRvdGFsICkgewoJCQlsb3dlci0tOwoJCX0KCgkJd2hpbGUgKCArK2kgPCBkaXZpc29yICkgewoJCQlpZiAoIGkgPiAwICkgewoJCQkJc3RhcnQgPSBzdGFydCArIG50aDsKCQkJfQoKCQkJaWYgKCAhbG93ZXJlZCAmJiBsb3dlciA8IGRpdmlzb3IgJiYgaSA9PT0gbG93ZXIgKSB7CgkJCQktLW50aDsKCQkJCWxvd2VyZWQgPSB0cnVlOwoJCQl9CgoJCQlyZXN1bHQucHVzaCggYXJyYXkubGltaXQoIG9iaiwgc3RhcnQsIG50aCApICk7CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIEZpbmRzIHRoZSBzdGFuZGFyZCBkZXZpYXRpb24gb2YgYW4gQXJyYXkgKCBvZiBudW1iZXJzICkKCSAqCgkgKiBAbWV0aG9kIHN0ZGRldgoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqIEFycmF5IHRvIHByb2Nlc3MKCSAqIEByZXR1cm4ge051bWJlcn0gICAgU3RhbmRhcmQgZGV2aWF0aW9uIG9mIHRoZSBBcnJheSAoIGZsb2F0IG9yIGludGVnZXIgKQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LnN0ZGRldiggWzEsIDMsIDVdICk7IC8vIDEuNjMyOTkzMTYxODU1NDUyCgkgKi8KCXN0ZGRldiA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBNYXRoLnNxcnQoIGFycmF5LnZhcmlhbmNlKCBvYmogKSApOwoJfSwKCgkvKioKCSAqIEdldHMgdGhlIHN1bW1hdGlvbiBvZiBhbiBBcnJheSBvZiBudW1iZXJzCgkgKgoJICogQG1ldGhvZCBzdW0KCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBzdW0KCSAqIEByZXR1cm4ge051bWJlcn0gICAgU3VtbWF0aW9uIG9mIEFycmF5CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuc3VtKCBbMiwgNCwgMywgMV0gKTsgLy8gMTAKCSAqLwoJc3VtIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJdmFyIHJlc3VsdCA9IDA7CgoJCWlmICggb2JqLmxlbmd0aCA+IDAgKSB7CgkJCXJlc3VsdCA9IG9iai5yZWR1Y2UoIGZ1bmN0aW9uICggcHJldiwgY3VyICkgewoJCQkJcmV0dXJuIHByZXYgKyBjdXI7CgkJCX0gKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogVGFrZXMgdGhlIGZpcnN0IGBuYCBpbmRpY2VzIGZyb20gYG9iamAKCSAqCgkgKiBAbWV0aG9kIHRha2UKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9ICBvYmogQXJyYXkgdG8gcHJvY2VzcwoJICogQHBhcmFtICB7TnVtYmVyfSBuICAgT2Zmc2V0IGZyb20gMCB0byByZXR1cm4KCSAqIEByZXR1cm4ge0FycmF5fSAgICAgIFN1YnNldCBvZiBgb2JqYAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LnRha2UoIFsxLCAyLCAzLCA0XSwgMiApOyAvLyBbMSwgMl0KCSAqLwoJdGFrZSA6IGZ1bmN0aW9uICggb2JqLCBuICkgewoJCXJldHVybiBhcnJheS5saW1pdCggb2JqLCAwLCBuICk7Cgl9LAoKCS8qKgoJICogQ2FzdHMgYW4gQXJyYXkgdG8gT2JqZWN0CgkgKgoJICogQG1ldGhvZCB0b09iamVjdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gYXIgQXJyYXkgdG8gdHJhbnNmb3JtCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgTmV3IG9iamVjdAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LnRvT2JqZWN0KCBbImFiYyIsICJkZWYiXSApOyAvLyB7MDogImFiYyIsIDE6ICJkZWYifQoJICovCgl0b09iamVjdCA6IGZ1bmN0aW9uICggYXIgKSB7CgkJdmFyIG9iaiA9IHt9LAoJCSAgICBpICAgPSBhci5sZW5ndGg7CgoJCXdoaWxlICggaS0tICkgewoJCQlvYmpbaS50b1N0cmluZygpXSA9IGFyW2ldOwoJCX0KCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBHZXRzIHRoZSB0b3RhbCBrZXlzIGluIGFuIEFycmF5CgkgKgoJICogQG1ldGhvZCB0b3RhbAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqIEFycmF5IHRvIGZpbmQgdGhlIGxlbmd0aCBvZgoJICogQHJldHVybiB7TnVtYmVyfSAgICBOdW1iZXIgb2Yga2V5cyBpbiBBcnJheQoJICogQGV4YW1wbGUKCSAqIHZhciBteUFycmF5ID0gW3RydWUsIHRydWUsIGZhbHNlXTsKCSAqCgkgKiBteUFycmF5LmV4dHJhID0gdHJ1ZTsKCSAqIGtlaWdhaS51dGlsLmFycmF5LnRvdGFsKCBteUFycmF5ICk7IC8vIDQKCSAqLwoJdG90YWwgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gYXJyYXkuaW5kZXhlZCggb2JqICkubGVuZ3RoOwoJfSwKCgkvKioKCSAqIFJldHVybnMgYW4gQXJyYXkgb2YgdW5pcXVlIGluZGljZXMgb2YgYG9iamAKCSAqCgkgKiBAbWV0aG9kIHVuaXF1ZQoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqIEFycmF5IHRvIHByb2Nlc3MKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgQXJyYXkgb2YgdW5pcXVlIGluZGljZXMKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS51bmlxdWUoIFsiYSIsICJiIiwgImEiLCAiYyIsICJiIiwgImQiXSApOyAvLyBbImEiLCAiYiIsICJjIiwgImQiXQoJICovCgl1bmlxdWUgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQl2YXIgcmVzdWx0ID0gW107CgoJCWFycmF5LmVhY2goIG9iaiwgZnVuY3Rpb24gKCBpICkgewoJCQlhcnJheS5hZGQoIHJlc3VsdCwgaSApOwoJCX0gKTsKCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBGaW5kcyB0aGUgdmFyaWFuY2Ugb2YgYW4gQXJyYXkgKCBvZiBudW1iZXJzICkKCSAqCgkgKiBAbWV0aG9kIHZhcmlhbmNlCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gcHJvY2VzcwoJICogQHJldHVybiB7TnVtYmVyfSAgICBWYXJpYW5jZSBvZiB0aGUgQXJyYXkgKCBmbG9hdCBvciBpbnRlZ2VyICkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS52YXJpYW5jZSggWzEsIDMsIDVdICk7IC8vIDIuNjY2NjY2NjY2NjY2NjY2NQoJICovCgl2YXJpYW5jZSA6IGZ1bmN0aW9uICggb2JqICkgewoJCXZhciBudGggPSBvYmoubGVuZ3RoLAoJCSAgICBuICAgPSAwLAoJCSAgICBtZWFuOwoKCQlpZiAoIG50aCA+IDAgKSB7CgkJCW1lYW4gPSBhcnJheS5tZWFuKCBvYmogKTsKCgkJCWFycmF5LmVhY2goIG9iaiwgZnVuY3Rpb24gKCBpICkgewoJCQkJbiArPSBtYXRoLnNxciggaSAtIG1lYW4gKTsKCQkJfSApOwoKCQkJcmV0dXJuIG4gLyBudGg7CgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gbjsKCQl9Cgl9LAoKCS8qKgoJICogQ29udmVydHMgYW55IGFyZ3VtZW50cyB0byBBcnJheXMsIHRoZW4gbWVyZ2VzIGVsZW1lbnRzIG9mIGBvYmpgIHdpdGggY29ycmVzcG9uZGluZyBlbGVtZW50cyBmcm9tIGVhY2ggYXJndW1lbnQKCSAqCgkgKiBAbWV0aG9kIHppcAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqICBBcnJheSB0byB0cmFuc2Zvcm0KCSAqIEBwYXJhbSAge01peGVkfSBhcmdzIEFyZ3VtZW50IGluc3RhbmNlIG9yIEFycmF5IHRvIG1lcmdlCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICBBcnJheQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LnppcCggWzAsIDFdLCAxICk7IC8vIFtbMCwgMV0sIFsxLCBudWxsXV0KCSAqLwoJemlwIDogZnVuY3Rpb24gKCBvYmosIGFyZ3MgKSB7CgkJdmFyIHJlc3VsdCA9IFtdOwoKCQkvLyBQcmVwYXJpbmcgYXJncwoJCWlmICggISggYXJncyBpbnN0YW5jZW9mIEFycmF5ICkgKSB7CgkJCWFyZ3MgPSB0eXBlb2YgYXJncyA9PSAib2JqZWN0IiA/IGFycmF5LmNhc3QoIGFyZ3MgKSA6IFthcmdzXTsKCQl9CgoJCWFycmF5LmVhY2goIGFyZ3MsIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCQlpZiAoICEoIGkgaW5zdGFuY2VvZiBBcnJheSApICkgewoJCQkJdGhpc1tpZHhdID0gW2ldOwoJCQl9CgkJfSApOwoKCQkvLyBCdWlsZGluZyByZXN1bHQgQXJyYXkKCQlhcnJheS5lYWNoKCBvYmosIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCQlyZXN1bHRbaWR4XSA9IFtpXTsKCQkJYXJyYXkuZWFjaCggYXJncywgZnVuY3Rpb24gKCB4ICkgewoJCQkJcmVzdWx0W2lkeF0ucHVzaCggeFtpZHhdIHx8IG51bGwgKTsKCQkJfSApOwoJCX0gKTsKCgkJcmV0dXJuIHJlc3VsdDsKCX0KfTsKCi8qKgogKiBAbmFtZXNwYWNlIGNhY2hlCiAqIEBwcml2YXRlCiAqLwp2YXIgY2FjaGUgPSB7CgkvKioKCSAqIENvbGxlY3Rpb24gVVJJcwoJICoKCSAqIEBtZW1iZXJPZiBjYWNoZQoJICogQHR5cGUge09iamVjdH0KCSAqLwoJbHJ1IDogbHJ1LmZhY3RvcnkoIENBQ0hFICksCgoJLyoqCgkgKiBHYXJiYWdlIGNvbGxlY3RvciBmb3IgdGhlIGNhY2hlZCBpdGVtcwoJICoKCSAqIEBtZXRob2QgY2xlYW4KCSAqIEBtZW1iZXJPZiBjYWNoZQoJICogQHJldHVybiB7VW5kZWZpbmVkfSB1bmRlZmluZWQKCSAqLwoJY2xlYW4gOiBmdW5jdGlvbiAoKSB7CgkJYXJyYXkuZWFjaCggYXJyYXkua2V5cyggY2FjaGUubHJ1LmNhY2hlICksIGZ1bmN0aW9uICggaSApIHsKCQkJaWYgKCBjYWNoZS5leHBpcmVkKCBpICkgKSB7CgkJCQljYWNoZS5leHBpcmUoIGkgKTsKCQkJfQoJCX0gKTsKCX0sCgoJLyoqCgkgKiBFeHBpcmVzIGEgVVJJIGZyb20gdGhlIGxvY2FsIGNhY2hlCgkgKgoJICogQG1ldGhvZCBleHBpcmUKCSAqIEBtZW1iZXJPZiBjYWNoZQoJICogQHBhcmFtICB7U3RyaW5nfSB1cmkgVVJJIG9mIHRoZSBsb2NhbCByZXByZXNlbnRhdGlvbgoJICogQHJldHVybiB7Qm9vbGVhbn0gYHRydWVgIGlmIHN1Y2Nlc3NmdWwKCSAqLwoJZXhwaXJlIDogZnVuY3Rpb24gKCB1cmkgKSB7CgkJaWYgKCBjYWNoZS5scnUuY2FjaGVbdXJpXSApIHsKCQkJY2FjaGUubHJ1LnJlbW92ZSggdXJpICk7CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCS8qKgoJICogRGV0ZXJtaW5lcyBpZiBhIFVSSSBoYXMgZXhwaXJlZAoJICoKCSAqIEBtZXRob2QgZXhwaXJlZAoJICogQG1lbWJlck9mIGNhY2hlCgkgKiBAcGFyYW0gIHtPYmplY3R9IHVyaSBDYWNoZWQgVVJJIG9iamVjdAoJICogQHJldHVybiB7Qm9vbGVhbn0gICAgVHJ1ZSBpZiB0aGUgVVJJIGhhcyBleHBpcmVkCgkgKi8KCWV4cGlyZWQgOiBmdW5jdGlvbiAoIHVyaSApIHsKCQl2YXIgaXRlbSA9IGNhY2hlLmxydS5jYWNoZVt1cmldOwoKCQlyZXR1cm4gaXRlbSAmJiBpdGVtLnZhbHVlLmV4cGlyZXMgPCBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIHRoZSBjYWNoZWQgb2JqZWN0IHtoZWFkZXJzLCByZXNwb25zZX0gb2YgdGhlIFVSSSBvciBmYWxzZQoJICoKCSAqIEBtZXRob2QgZ2V0CgkgKiBAbWVtYmVyT2YgY2FjaGUKCSAqIEBwYXJhbSAge1N0cmluZ30gIHVyaSAgICBVUkkvSWRlbnRpZmllciBmb3IgdGhlIHJlc291cmNlIHRvIHJldHJpZXZlIGZyb20gY2FjaGUKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGV4cGlyZSBbT3B0aW9uYWxdIElmICdmYWxzZScgdGhlIFVSSSB3aWxsIG5vdCBleHBpcmUKCSAqIEBwYXJhbSAge0Jvb2xlYW59IHNpbGVudCBbT3B0aW9uYWxdIElmICd0cnVlJywgdGhlIGV2ZW50IHdpbGwgbm90IGZpcmUKCSAqIEByZXR1cm4ge01peGVkfSAgICAgICAgICBVUkkgT2JqZWN0IHtoZWFkZXJzLCByZXNwb25zZX0gb3IgRmFsc2UKCSAqLwoJZ2V0IDogZnVuY3Rpb24gKCB1cmksIGV4cGlyZSApIHsKCQl1cmkgICAgICA9IHV0aWxpdHkucGFyc2UoIHVyaSApLmhyZWY7CgkJdmFyIGl0ZW0gPSBjYWNoZS5scnUuZ2V0KCB1cmkgKTsKCgkJaWYgKCAhaXRlbSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCBleHBpcmUgIT09IGZhbHNlICYmIGNhY2hlLmV4cGlyZWQoIHVyaSApICkgewoJCQljYWNoZS5leHBpcmUoIHVyaSApOwoKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJcmV0dXJuIHV0aWxpdHkuY2xvbmUoIGl0ZW0sIHRydWUgKTsKCX0sCgoJLyoqCgkgKiBTZXRzLCBvciB1cGRhdGVzIGFuIGl0ZW0gaW4gY2FjaGUuaXRlbXMKCSAqCgkgKiBAbWV0aG9kIHNldAoJICogQG1lbWJlck9mIGNhY2hlCgkgKiBAcGFyYW0gIHtTdHJpbmd9IHVyaSAgICAgIFVSSSB0byBzZXQgb3IgdXBkYXRlCgkgKiBAcGFyYW0gIHtTdHJpbmd9IHByb3BlcnR5IFByb3BlcnR5IG9mIHRoZSBjYWNoZWQgVVJJIHRvIHNldAoJICogQHBhcmFtICB7TWl4ZWR9IHZhbHVlICAgICBWYWx1ZSB0byBzZXQKCSAqIEByZXR1cm4ge01peGVkfSAgICAgICAgICAgVVJJIE9iamVjdCB7aGVhZGVycywgcmVzcG9uc2V9IG9yIHVuZGVmaW5lZAoJICovCglzZXQgOiBmdW5jdGlvbiAoIHVyaSwgcHJvcGVydHksIHZhbHVlICkgewoJCXVyaSAgICAgID0gdXRpbGl0eS5wYXJzZSggdXJpICkuaHJlZjsKCQl2YXIgaXRlbSA9IGNhY2hlLmxydS5nZXQoIHVyaSApOwoKCQlpZiAoICFpdGVtICkgewoJCQlpdGVtID0gewoJCQkJcGVybWlzc2lvbiA6IDAKCQkJfTsKCQl9CgoJCWlmICggcHJvcGVydHkgPT09ICJwZXJtaXNzaW9uIiApIHsKCQkJaXRlbS5wZXJtaXNzaW9uIHw9IHZhbHVlOwoJCX0KCQllbHNlIGlmICggcHJvcGVydHkgPT09ICIhcGVybWlzc2lvbiIgKSB7CgkJCWl0ZW0ucGVybWlzc2lvbiAmPSB+dmFsdWU7CgkJfQoJCWVsc2UgewoJCQlpdGVtW3Byb3BlcnR5XSA9IHZhbHVlOwoJCX0KCgkJY2FjaGUubHJ1LnNldCggdXJpLCBpdGVtICk7CgoJCXJldHVybiBpdGVtOwoJfQp9OwoKLyoqCiAqIEN1c3RvbSBPYmplY3QgcmV0dXJuZWQgZnJvbSBgY2xpZW50LnJlcXVlc3QoKWAKICoKICogQGNvbnN0cnVjdG9yCiAqIEBtZW1iZXJPZiBrZWlnYWkKICogQGV4dGVuZHMge2tlaWdhaS5CYXNlfQogKiBAcGFyYW0ge09iamVjdH0geGhyIFhNTEh0dHBSZXF1ZXN0CiAqLwpmdW5jdGlvbiBLWE1MSHR0cFJlcXVlc3QgKCB4aHIgKSB7Cgl0aGlzLm9ic2VydmVyID0gb2JzZXJ2YWJsZS5mYWN0b3J5KCk7Cgl0aGlzLmRlZmVyICAgID0gZGVmZXJyZWQuZmFjdG9yeSgpOwoJdGhpcy54aHIgICAgICA9IHhocjsKfQoKLyoqCiAqIEV4dGVuZGluZyBCYXNlCiAqCiAqIEBtZW1iZXJPZiBrZWlnYWkuS1hNTEh0dHBSZXF1ZXN0CiAqIEB0eXBlIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICovCktYTUxIdHRwUmVxdWVzdC5wcm90b3R5cGUgPSBiYXNlLmZhY3RvcnkoKTsKCi8qKgogKiBTZXR0aW5nIGNvbnN0cnVjdG9yIGxvb3AKICoKICogQG1ldGhvZCBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpLktYTUxIdHRwUmVxdWVzdAogKiBAdHlwZSB7RnVuY3Rpb259CiAqIEBwcml2YXRlCiAqLwpLWE1MSHR0cFJlcXVlc3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gS1hNTEh0dHBSZXF1ZXN0OwoKLyoqCiAqIEBuYW1lc3BhY2UgY2xpZW50CiAqLwp2YXIgY2xpZW50ID0gewoJLyoqCgkgKiBJbnRlcm5ldCBFeHBsb3JlciBicm93c2VyCgkgKgoJICogQG1lbWJlck9mIGNsaWVudAoJICogQHR5cGUge0Jvb2xlYW59CgkgKiBAcHJpdmF0ZQoJICovCglpZSA6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gIXNlcnZlciAmJiByZWdleC5pZS50ZXN0KCBuYXZpZ2F0b3IudXNlckFnZW50ICk7Cgl9KCksCgoJLyoqCgkgKiBDbGllbnQgdmVyc2lvbgoJICoKCSAqIEBtZW1iZXJPZiBjbGllbnQKCSAqIEB0eXBlIHtOdW1iZXJ9CgkgKiBAcHJpdmF0ZQoJICovCgl2ZXJzaW9uIDogZnVuY3Rpb24gKCkgewoJCXZhciB2ZXJzaW9uID0gMDsKCgkJaWYgKCB0aGlzLmllICkgewoJCQl2ZXJzaW9uID0gbmF2aWdhdG9yLnVzZXJBZ2VudC5yZXBsYWNlKC8oLiptc2llfDsuKikvZ2ksICIiKTsKCQkJdmVyc2lvbiA9IG51bWJlci5wYXJzZSggc3RyaW5nLnRyaW0oIHZlcnNpb24gKSApOwoJCX0KCgkJcmV0dXJuIHZlcnNpb247Cgl9LAoKCS8qKgoJICogUXVpY2sgd2F5IHRvIHNlZSBpZiBhIFVSSSBhbGxvd3MgYSBzcGVjaWZpYyB2ZXJiCgkgKgoJICogQG1ldGhvZCBhbGxvd3MKCSAqIEBtZW1iZXJPZiBjbGllbnQKCSAqIEBwYXJhbSAge1N0cmluZ30gdXJpICBVUkkgdG8gcXVlcnkKCSAqIEBwYXJhbSAge1N0cmluZ30gdmVyYiBIVFRQIHZlcmIKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgICBgdHJ1ZWAgaWYgdGhlIHZlcmIgaXMgYWxsb3dlZCwgdW5kZWZpbmVkIGlmIHVua25vd24KCSAqIEBwcml2YXRlCgkgKi8KCWFsbG93cyA6IGZ1bmN0aW9uICggdXJpLCB2ZXJiICkgewoJCWlmICggc3RyaW5nLmlzRW1wdHkoIHVyaSApIHx8IHN0cmluZy5pc0VtcHR5KCB2ZXJiICkgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApOwoJCX0KCgkJdXJpICAgICAgICA9IHV0aWxpdHkucGFyc2UoIHVyaSApLmhyZWY7CgkJdmVyYiAgICAgICA9IHZlcmIudG9Mb3dlckNhc2UoKTsKCQl2YXIgcmVzdWx0ID0gZmFsc2UsCgkJICAgIGJpdCAgICA9IDA7CgoJCWlmICggIWNhY2hlLmdldCggdXJpLCBmYWxzZSApICkgewoJCQlyZXN1bHQgPSB1bmRlZmluZWQ7CgkJfQoJCWVsc2UgewoJCQlpZiAoIHJlZ2V4LmRlbC50ZXN0KCB2ZXJiICkgKSB7CgkJCQliaXQgPSAxOwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5nZXRfaGVhZGVycy50ZXN0KCB2ZXJiICkgKSB7CgkJCQliaXQgPSA0OwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5wdXRfcG9zdC50ZXN0KCB2ZXJiICkgKSB7CgkJCQliaXQgPSAyOwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5wYXRjaC50ZXN0KCB2ZXJiICkgKSB7CgkJCQliaXQgPSA4OwoJCQl9CgoJCQlyZXN1bHQgPSBCb29sZWFuKCBjbGllbnQucGVybWlzc2lvbnMoIHVyaSwgdmVyYiApLmJpdCAmIGJpdCApOwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBHZXRzIGJpdCB2YWx1ZSBiYXNlZCBvbiBhcmdzCgkgKgoJICogQG1ldGhvZCBiaXQKCSAqIEBtZW1iZXJPZiBjbGllbnQKCSAqIEBwYXJhbSAge0FycmF5fSBhcmdzIEFycmF5IG9mIGNvbW1hbmRzIHRoZSBVUkkgYWNjZXB0cwoJICogQHJldHVybiB7TnVtYmVyfSBUbyBiZSBzZXQgYXMgYSBiaXQKCSAqIEBwcml2YXRlCgkgKi8KCWJpdCA6IGZ1bmN0aW9uICggYXJncyApIHsKCQl2YXIgcmVzdWx0ID0gMDsKCgkJYXJyYXkuZWFjaCggYXJncywgZnVuY3Rpb24gKCB2ZXJiICkgewoJCQl2ZXJiID0gdmVyYi50b0xvd2VyQ2FzZSgpOwoKCQkJaWYgKCByZWdleC5nZXRfaGVhZGVycy50ZXN0KCB2ZXJiICkgKSB7CgkJCQlyZXN1bHQgfD0gNDsKCQkJfQoJCQllbHNlIGlmICggcmVnZXgucHV0X3Bvc3QudGVzdCggdmVyYiApICkgewoJCQkJcmVzdWx0IHw9IDI7CgkJCX0KCQkJZWxzZSBpZiAoIHJlZ2V4LnBhdGNoLnRlc3QoIHZlcmIgKSApIHsKCQkJCXJlc3VsdCB8PSA4OwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5kZWwudGVzdCggdmVyYiApICkgewoJCQkJcmVzdWx0IHw9IDE7CgkJCX0KCQl9ICk7CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogRGV0ZXJtaW5lcyBpZiBhIFVSSSBpcyBhIENPUlMgZW5kIHBvaW50CgkgKgoJICogQG1ldGhvZCBjb3JzCgkgKiBAbWVtYmVyT2YgY2xpZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IHVyaSAgVVJJIHRvIHBhcnNlCgkgKiBAcmV0dXJuIHtCb29sZWFufSAgICAgVHJ1ZSBpZiBDT1JTCgkgKiBAcHJpdmF0ZQoJICovCgljb3JzIDogZnVuY3Rpb24gKCB1cmkgKSB7CgkJcmV0dXJuICggIXNlcnZlciAmJiB1cmkuaW5kZXhPZiggIi8vIiApID4gLTEgJiYgdXJpLmluZGV4T2YoICIvLyIgKyBsb2NhdGlvbi5ob3N0ICkgPT09IC0xICk7Cgl9LAoKCS8qKgoJICogQ2FjaGVzIHRoZSBoZWFkZXJzIGZyb20gdGhlIFhIUiByZXNwb25zZQoJICoKCSAqIEBtZXRob2QgaGVhZGVycwoJICogQG1lbWJlck9mIGNsaWVudAoJICogQHBhcmFtICB7T2JqZWN0fSB4aHIgIFhNTEh0dHBSZXF1ZXN0IE9iamVjdAoJICogQHBhcmFtICB7U3RyaW5nfSB1cmkgIFVSSSB0byByZXF1ZXN0CgkgKiBAcGFyYW0gIHtTdHJpbmd9IHR5cGUgVHlwZSBvZiByZXF1ZXN0CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgQ2FjaGVkIFVSSSByZXByZXNlbnRhdGlvbgoJICogQHByaXZhdGUKCSAqLwoJaGVhZGVycyA6IGZ1bmN0aW9uICggeGhyLCB1cmksIHR5cGUgKSB7CgkJdmFyIGhlYWRlcnMgPSBzdHJpbmcudHJpbSggeGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpICkuc3BsaXQoICJcbiIgKSwKCQkgICAgaXRlbXMgICA9IHt9LAoJCSAgICBvICAgICAgID0ge30sCgkJICAgIGFsbG93ICAgPSBudWxsLAoJCSAgICBleHBpcmVzID0gbmV3IERhdGUoKSwKCQkgICAgY29ycyAgICA9IGNsaWVudC5jb3JzKCB1cmkgKTsKCgkJYXJyYXkuZWFjaCggaGVhZGVycywgZnVuY3Rpb24gKCBpICkgewoJCQl2YXIgaGVhZGVyID0gaS5zcGxpdCggIjogIiApOwoKCQkJaXRlbXNbaGVhZGVyWzBdLnRvTG93ZXJDYXNlKCldID0gc3RyaW5nLnRyaW0oIGhlYWRlclsxXSApOwoKCQkJaWYgKCBhbGxvdyA9PT0gbnVsbCApIHsKCQkJCWlmICggKCAhY29ycyAmJiByZWdleC5hbGxvdy50ZXN0KCBoZWFkZXIgKSApIHx8ICggY29ycyAmJiByZWdleC5hbGxvd19jb3JzLnRlc3QoIGhlYWRlciApICkgKSB7CgkJCQkJYWxsb3cgPSBoZWFkZXJbMV07CgkJCQl9CgkJCX0KCQl9ICk7CgoJCWlmICggcmVnZXgubm8udGVzdCggaXRlbXNbImNhY2hlLWNvbnRyb2wiXSApICkgewoJCQlleHBpcmVzID0gZXhwaXJlcy5nZXRUaW1lKCk7CgkJfQoJCWVsc2UgaWYgKCBpdGVtc1siY2FjaGUtY29udHJvbCJdICYmIHJlZ2V4Lm51bWJlcl9wcmVzZW50LnRlc3QoIGl0ZW1zWyJjYWNoZS1jb250cm9sIl0gKSApIHsKCQkJZXhwaXJlcyA9IGV4cGlyZXMuc2V0U2Vjb25kcyggZXhwaXJlcy5nZXRTZWNvbmRzKCkgKyBudW1iZXIucGFyc2UoIHJlZ2V4Lm51bWJlcl9wcmVzZW50LmV4ZWMoIGl0ZW1zWyJjYWNoZS1jb250cm9sIl0gKVswXSwgMTAgKSApOwoJCX0KCQllbHNlIGlmICggaXRlbXMuZXhwaXJlcyApIHsKCQkJZXhwaXJlcyA9IG5ldyBEYXRlKCBpdGVtcy5leHBpcmVzICkuZ2V0VGltZSgpOwoJCX0KCQllbHNlIHsKCQkJZXhwaXJlcyA9IGV4cGlyZXMuZ2V0VGltZSgpOwoJCX0KCgkJby5leHBpcmVzICAgID0gZXhwaXJlczsKCQlvLmhlYWRlcnMgICAgPSBpdGVtczsKCQlvLnRpbWVzdGFtcCAgPSBuZXcgRGF0ZSgpOwoJCW8ucGVybWlzc2lvbiA9IGNsaWVudC5iaXQoIGFsbG93ICE9PSBudWxsID8gc3RyaW5nLmV4cGxvZGUoIGFsbG93ICkgOiBbdHlwZV0gKTsKCgkJaWYgKCB0eXBlID09PSAiZ2V0IiApIHsKCQkJY2FjaGUuc2V0KCB1cmksICJleHBpcmVzIiwgICAgby5leHBpcmVzICk7CgkJCWNhY2hlLnNldCggdXJpLCAiaGVhZGVycyIsICAgIG8uaGVhZGVycyApOwoJCQljYWNoZS5zZXQoIHVyaSwgInRpbWVzdGFtcCIsICBvLnRpbWVzdGFtcCApOwoJCQljYWNoZS5zZXQoIHVyaSwgInBlcm1pc3Npb24iLCBvLnBlcm1pc3Npb24gKTsKCQl9CgoJCXJldHVybiBvOwoJfSwKCgkvKioKCSAqIFBhcnNlcyBhbiBYSFIgcmVzcG9uc2UKCSAqCgkgKiBAbWV0aG9kIHBhcnNlCgkgKiBAbWVtYmVyT2YgY2xpZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IHhociAgWEhSIE9iamVjdAoJICogQHBhcmFtICB7U3RyaW5nfSB0eXBlIFtPcHRpb25hbF0gY29udGVudC10eXBlIGhlYWRlciB2YWx1ZQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgIEFycmF5LCBCb29sZWFuLCBEb2N1bWVudCwgTnVtYmVyLCBPYmplY3Qgb3IgU3RyaW5nCgkgKiBAcHJpdmF0ZQoJICovCglwYXJzZSA6IGZ1bmN0aW9uICggeGhyLCB0eXBlICkgewoJCXR5cGUgPSB0eXBlIHx8ICIiOwoJCXZhciByZXN1bHQsIG9iajsKCgkJaWYgKCAoIHJlZ2V4Lmpzb25fbWF5YmUudGVzdCggdHlwZSApIHx8IHN0cmluZy5pc0VtcHR5KCB0eXBlICkgKSAmJiAoIHJlZ2V4Lmpzb25fd3JhcC50ZXN0KCB4aHIucmVzcG9uc2VUZXh0ICkgJiYgQm9vbGVhbiggb2JqID0ganNvbi5kZWNvZGUoIHhoci5yZXNwb25zZVRleHQsIHRydWUgKSApICkgKSB7CgkJCXJlc3VsdCA9IG9iajsKCQl9CgkJZWxzZSBpZiAoIHR5cGUgPT09ICJ0ZXh0L2NzdiIgKSB7CgkJCXJlc3VsdCA9IGNzdi5kZWNvZGUoIHhoci5yZXNwb25zZVRleHQgKTsKCQl9CgkJZWxzZSBpZiAoIHR5cGUgPT09ICJ0ZXh0L3RzdiIgKSB7CgkJCXJlc3VsdCA9IGNzdi5kZWNvZGUoIHhoci5yZXNwb25zZVRleHQsICJcdCIgKTsKCQl9CgkJZWxzZSBpZiAoIHJlZ2V4LnhtbC50ZXN0KCB0eXBlICkgKSB7CgkJCWlmICggdHlwZSAhPT0gInRleHQveG1sIiApIHsKCQkJCXhoci5vdmVycmlkZU1pbWVUeXBlKCAidGV4dC94bWwiICk7CgkJCX0KCgkJCXJlc3VsdCA9IHhoci5yZXNwb25zZVhNTDsKCQl9CgkJZWxzZSBpZiAoIHR5cGUgPT09ICJ0ZXh0L3BsYWluIiAmJiByZWdleC5pc194bWwudGVzdCggeGhyLnJlc3BvbnNlVGV4dCApICYmIHhtbC52YWxpZCggeGhyLnJlc3BvbnNlVGV4dCApICkgewoJCQlyZXN1bHQgPSB4bWwuZGVjb2RlKCB4aHIucmVzcG9uc2VUZXh0ICk7CgkJfQoJCWVsc2UgewoJCQlyZXN1bHQgPSB4aHIucmVzcG9uc2VUZXh0OwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIHRoZSBwZXJtaXNzaW9uIG9mIHRoZSBjYWNoZWQgVVJJCgkgKgoJICogQG1ldGhvZCBwZXJtaXNzaW9ucwoJICogQG1lbWJlck9mIGNsaWVudAoJICogQHBhcmFtICB7U3RyaW5nfSB1cmkgVVJJIHRvIHF1ZXJ5CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBDb250YWlucyBhbiBBcnJheSBvZiBhdmFpbGFibGUgY29tbWFuZHMsIHRoZSBwZXJtaXNzaW9uIGJpdCBhbmQgYSBtYXAKCSAqIEBwcml2YXRlCgkgKi8KCXBlcm1pc3Npb25zIDogZnVuY3Rpb24gKCB1cmkgKSB7CgkJdmFyIGNhY2hlZCA9IGNhY2hlLmdldCggdXJpLCBmYWxzZSApLAoJCSAgICBiaXQgICAgPSAhY2FjaGVkID8gMCA6IGNhY2hlZC5wZXJtaXNzaW9uLAoJCSAgICByZXN1bHQgPSB7YWxsb3dzOiBbXSwgYml0OiBiaXQsIG1hcDoge3BhcnRpYWw6IDgsIHJlYWQ6IDQsIHdyaXRlOiAyLCAiZGVsZXRlIjogMSwgdW5rbm93bjogMH19OwoKCQlpZiAoIGJpdCAmIDEgKSB7CgkJCXJlc3VsdC5hbGxvd3MucHVzaCggIkRFTEVURSIgKTsKCQl9CgoJCWlmICggYml0ICYgMiApIHsKCQkJcmVzdWx0LmFsbG93cy5wdXNoKCAiUE9TVCIgKTsKCQkJcmVzdWx0LmFsbG93cy5wdXNoKCAiUFVUIiApOwoJCX0KCgkJaWYgKCBiaXQgJiA0ICkgewoJCQlyZXN1bHQuYWxsb3dzLnB1c2goICJHRVQiICk7CgkJfQoKCQlpZiAoIGJpdCAmIDggKSB7CgkJCXJlc3VsdC5hbGxvd3MucHVzaCggIlBBVENIIiApOwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGEgSlNPTlAgcmVxdWVzdAoJICoKCSAqIEBtZXRob2QganNvbnAKCSAqIEBtZW1iZXJPZiBjbGllbnQKCSAqIEBwYXJhbSAge1N0cmluZ30gdXJpICBVUkkgdG8gcmVxdWVzdAoJICogQHBhcmFtICB7TWl4ZWR9ICBhcmdzIEN1c3RvbSBKU09OUCBoYW5kbGVyIHBhcmFtZXRlciBuYW1lLCBkZWZhdWx0IGlzICJjYWxsYmFjayI7IG9yIGN1c3RvbSBoZWFkZXJzIGZvciBHRVQgcmVxdWVzdCAoIENPUlMgKQoJICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmpzb25wKCAiaHR0cDovL3NvbWVkb21haW4uY29tL3Jlc291cmNlP2NhbGxiYWNrPSIsIGZ1bmN0aW9uICggYXJnICkgewoJICogICAvLyBgYXJnYCBpcyB0aGUgY29lcmNlZCByZXNwb25zZSBib2R5CgkgKiB9LCBmdW5jdGlvbiAoIGVyciApIHsKCSAqICAgLy8gSGFuZGxlIGBlcnJgCgkgKiB9ICk7CgkgKi8KCWpzb25wIDogZnVuY3Rpb24gKCB1cmksIGFyZ3MgKSB7CgkJdmFyIGRlZmVyICAgID0gZGVmZXJyZWQuZmFjdG9yeSgpLAoJCSAgICBjYWxsYmFjayA9ICJjYWxsYmFjayIsCgkJICAgIGNiaWQsIHM7CgoJCWlmICggZXh0ZXJuYWwgPT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAhZ2xvYmFsLmtlaWdhaSApIHsKCQkJCWdsb2JhbC5rZWlnYWkgPSB7Y2FsbGJhY2s6IHt9fTsKCQkJfQoKCQkJZXh0ZXJuYWwgPSAia2VpZ2FpIjsKCQl9CgoJCWlmICggYXJncyBpbnN0YW5jZW9mIE9iamVjdCAmJiAhYXJncy5jYWxsYmFjayApIHsKCQkJY2FsbGJhY2sgPSBhcmdzLmNhbGxiYWNrOwoJCX0KCgkJZG8gewoJCQljYmlkID0gdXRpbGl0eS5nZW5JZCgpLnNsaWNlKCAwLCAxMCApOwoJCX0KCQl3aGlsZSAoIGdsb2JhbC5jYWxsYmFja1tjYmlkXSApOwoKCQl1cmkgPSB1cmkucmVwbGFjZSggY2FsbGJhY2sgKyAiPT8iLCBjYWxsYmFjayArICI9IiArIGV4dGVybmFsICsgIi5jYWxsYmFjay4iICsgY2JpZCApOwoKCQlnbG9iYWwuY2FsbGJhY2tbY2JpZF0gPSBmdW5jdGlvbiAoIGFyZyApIHsKCQkJdXRpbGl0eS5jbGVhclRpbWVycyggY2JpZCApOwoJCQlkZWxldGUgZ2xvYmFsLmNhbGxiYWNrW2NiaWRdOwoJCQlkZWZlci5yZXNvbHZlKCBhcmcgKTsKCQkJZWxlbWVudC5kZXN0cm95KCBzICk7CgkJfTsKCgkJcyA9IGVsZW1lbnQuY3JlYXRlKCAic2NyaXB0Iiwge3NyYzogdXJpLCB0eXBlOiAidGV4dC9qYXZhc2NyaXB0In0sIHV0aWxpdHkuZG9tKCAiaGVhZCIgKVswXSApOwoJCQoJCXV0aWxpdHkuZGVmZXIoIGZ1bmN0aW9uICgpIHsKCQkJZGVmZXIucmVqZWN0KCB1bmRlZmluZWQgKTsKCQl9LCAzMDAwMCwgY2JpZCApOwoKCQlyZXR1cm4gZGVmZXI7Cgl9LAoKCS8qKgoJICogS1hNTEh0dHBSZXF1ZXN0IGZhY3RvcnkKCSAqCgkgKiBAbWV0aG9kIGt4aHIKCSAqIEBtZW1iZXJPZiBjbGllbnQKCSAqIEBwYXJhbSB7T2JqZWN0fSB4aHIgWE1MSHR0cFJlcXVlc3QKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5LWE1MSHR0cFJlcXVlc3R9CgkgKiBAcHJpdmF0ZQoJICovCglreGhyIDogZnVuY3Rpb24gKCB4aHIgKSB7CgkJdmFyIG9iaiA9IG5ldyBLWE1MSHR0cFJlcXVlc3QoIHhociApOwoKCQkvLyBXcmFwcGluZyBkZWZlcnJlZCBtZXRob2RzIG9uIG9iagoJCWFycmF5LmVhY2goIGFycmF5LmtleXMoIERlZmVycmVkLnByb3RvdHlwZSApLCBmdW5jdGlvbiAoIGkgKSB7CgkJCW9ialtpXSA9IGZ1bmN0aW9uICgpIHsKCQkJCXJldHVybiBvYmouZGVmZXJbaV0uYXBwbHkoIG9iai5kZWZlciwgYXJyYXkuY2FzdCggYXJndW1lbnRzICkgKTsKCQkJfTsKCQl9ICk7CgoJCS8vIEhvb2tpbmcgb2JzZXJ2ZXIgZm9yIHN0YW5kYXJkIGV2ZW50cwoJCWFycmF5LmVhY2goIEVWRU5UUywgZnVuY3Rpb24gKCBpICkgewoJCQlvYmouaG9vayggb2JqLnhociwgaSApOwoJCX0gKTsKCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGFuIFhtbEh0dHBSZXF1ZXN0IHRvIGEgVVJJICggYWxpYXNlZCB0byBtdWx0aXBsZSBtZXRob2RzICkKCSAqCgkgKiBUaGUgcmV0dXJuZWQgRGVmZXJyZWQgd2lsbCBoYXZlIGFuIC54aHIKCSAqCgkgKiBAbWV0aG9kIHJlcXVlc3QKCSAqIEBtZW1iZXJPZiBjbGllbnQKCSAqIEBwYXJhbSAge1N0cmluZ30gICB1cmkgICAgIFVSSSB0byBxdWVyeQoJICogQHBhcmFtICB7U3RyaW5nfSAgIHR5cGUgICAgW09wdGlvbmFsXSBUeXBlIG9mIHJlcXVlc3QgKCBERUxFVEUvR0VUL1BPU1QvUFVUL1BBVENIL0hFQUQvT1BUSU9OUyApLCBkZWZhdWx0IGlzIGBHRVRgCgkgKiBAcGFyYW0gIHtNaXhlZH0gICAgYXJncyAgICBbT3B0aW9uYWxdIERhdGEgdG8gc2VuZCB3aXRoIHRoZSByZXF1ZXN0CgkgKiBAcGFyYW0gIHtPYmplY3R9ICAgaGVhZGVycyBbT3B0aW9uYWxdIEN1c3RvbSByZXF1ZXN0IGhlYWRlcnMgKCBjYW4gYmUgdXNlZCB0byBzZXQgd2l0aENyZWRlbnRpYWxzICkKCSAqIEByZXR1cm4ge09iamVjdH0gICB7QGxpbmsga2VpZ2FpLktYTUxIdHRwUmVxdWVzdH0KCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5yZXF1ZXN0KCAiaHR0cDovL2tlaWdhaS5pbyIgKS50aGVuKCBmdW5jdGlvbiAoIGFyZyApIHsKCSAqICAgLy8gYGFyZ2AgaXMgdGhlIGNvZXJjZWQgcmVzcG9uc2UgYm9keQoJICogfSwgZnVuY3Rpb24gKCBlcnIgKSB7CgkgKiAgIC8vIEhhbmRsZSBgZXJyYAoJICogfSApOwoJICovCglyZXF1ZXN0IDogZnVuY3Rpb24gKCB1cmksIHR5cGUsIGFyZ3MsIGhlYWRlcnMgKSB7CgkJdmFyIGNvcnMsIGt4aHIsIHBheWxvYWQsIGNhY2hlZCwgY29udGVudFR5cGUsIGRvYywgYWIsIGJsb2I7CgoJCXR5cGUgPSB0eXBlIHx8ICJHRVQiOwoKCQlpZiAoICggcmVnZXgucHV0X3Bvc3QudGVzdCggdHlwZSApIHx8IHJlZ2V4LnBhdGNoLnRlc3QoIHR5cGUgKSApICYmIGFyZ3MgPT09IHVuZGVmaW5lZCApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQl1cmkgICAgICAgICA9IHV0aWxpdHkucGFyc2UoIHVyaSApLmhyZWY7CgkJdHlwZSAgICAgICAgPSB0eXBlLnRvTG93ZXJDYXNlKCk7CgkJaGVhZGVycyAgICAgPSBoZWFkZXJzIGluc3RhbmNlb2YgT2JqZWN0ID8gaGVhZGVycyA6IG51bGw7CgkJY29ycyAgICAgICAgPSBjbGllbnQuY29ycyggdXJpICk7CgkJa3hociAgICAgICAgPSBjbGllbnQua3hociggIWNsaWVudC5pZSB8fCAoICFjb3JzIHx8IGNsaWVudC52ZXJzaW9uID4gOSApID8gbmV3IFhNTEh0dHBSZXF1ZXN0KCkgOiBuZXcgWERvbWFpblJlcXVlc3QoKSApOwoJCXBheWxvYWQgICAgID0gKCByZWdleC5wdXRfcG9zdC50ZXN0KCB0eXBlICkgfHwgcmVnZXgucGF0Y2gudGVzdCggdHlwZSApICkgJiYgYXJncyA/IGFyZ3MgOiBudWxsOwoJCWNhY2hlZCAgICAgID0gdHlwZSA9PT0gImdldCIgPyBjYWNoZS5nZXQoIHVyaSApIDogZmFsc2U7CgkJY29udGVudFR5cGUgPSBudWxsOwoJCWRvYyAgICAgICAgID0gdHlwZW9mIERvY3VtZW50ICE9ICJ1bmRlZmluZWQiOwoJCWFiICAgICAgICAgID0gdHlwZW9mIEFycmF5QnVmZmVyICE9ICJ1bmRlZmluZWQiOwoJCWJsb2IgICAgICAgID0gdHlwZW9mIEJsb2IgIT0gInVuZGVmaW5lZCI7CgoJCS8vIE9ubHkgR0VUICYgUE9TVCBpcyBzdXBwb3J0ZWQgYnkgWERvbWFpblJlcXVlc3QgKHNvIHVzZWxlc3MhKQoJCWlmICggY29ycyAmJiBjbGllbnQuaWUgJiYgY2xpZW50LnZlcnNpb24gPT09IDkgJiYgIXJlZ2V4Lnhkb21haW5yZXF1ZXN0LnRlc3QoIHR5cGUgKSApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5ub3RBdmFpbGFibGUgKTsKCQl9CgoJCS8vIEhvb2tpbmcgY3VzdG9tIGV2ZW50cwoJCWt4aHIub24oICJyZWFkeXN0YXRlY2hhbmdlIiwgZnVuY3Rpb24gKCBldiApIHsKCQkJc3dpdGNoICggdGhpcy54aHIucmVhZHlTdGF0ZSApIHsKCQkJCWNhc2UgMToKCQkJCQl0aGlzLmRpc3BhdGNoKCAiYmVmb3JlWEhSIiwgdGhpcy54aHIsIGV2ICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDQ6CgkJCQkJdGhpcy5kaXNwYXRjaCggImFmdGVyWEhSIiwgdGhpcy54aHIsIGV2ICk7CgkJCQkJYnJlYWs7CgkJCX0KCQl9ICk7CgoJCWlmICggIWNvcnMgJiYgIXJlZ2V4LmdldF9oZWFkZXJzLnRlc3QoIHR5cGUgKSAmJiBjbGllbnQuYWxsb3dzKCB1cmksIHR5cGUgKSA9PT0gZmFsc2UgKSB7CgkJCXV0aWxpdHkuZGVsYXkoIGZ1bmN0aW9uICgpIHsKCQkJCWt4aHIuZGlzcGF0Y2goICJiZWZvcmVYSFIiLCBreGhyLnhociwgbnVsbCApOwoJCQkJa3hoci5kaXNwYXRjaCggImFmdGVyWEhSIiwga3hoci54aHIsIG51bGwgKTsKCQkJfSApOwoKCQkJa3hoci54aHIuc3RhdHVzID0gNDA1OwoJCQlreGhyLnJlamVjdCggbnVsbCApOwoJCX0KCgkJaWYgKCB0eXBlID09PSAiZ2V0IiAmJiBCb29sZWFuKCBjYWNoZWQgKSApIHsKCQkJLy8gRGVjb3JhdGluZyBYSFIgZm9yIHByb3h5IGJlaGF2aW9yCgkJCWlmICggc2VydmVyICkgewoJCQkJa3hoci54aHIucmVhZHlTdGF0ZSAgPSA0OwoJCQkJa3hoci54aHIuc3RhdHVzICAgICAgPSAyMDA7CgkJCQlreGhyLnhoci5fcmVzaGVhZGVycyA9IGNhY2hlZC5oZWFkZXJzOwoJCQl9CgoJCQl1dGlsaXR5LmRlbGF5KCBmdW5jdGlvbiAoKSB7CgkJCQlreGhyLmRpc3BhdGNoKCAiYmVmb3JlWEhSIiwga3hoci54aHIsIG51bGwgKTsKCQkJCWt4aHIuZGlzcGF0Y2goICJhZnRlclhIUiIsIGt4aHIueGhyLCBudWxsICk7CgkJCX0gKTsKCgkJCWt4aHIucmVzb2x2ZSggY2FjaGVkLnJlc3BvbnNlICk7CgkJfQoJCWVsc2UgewoJCQl1dGlsaXR5LmRlbGF5KCBmdW5jdGlvbiAoKSB7CgkJCQlreGhyLnhoci5vcGVuKCB0eXBlLnRvVXBwZXJDYXNlKCksIHVyaSwgdHJ1ZSApOwoKCQkJCS8vIFNldHRpbmcgY29udGVudC10eXBlIHZhbHVlCgkJCQlpZiAoIGhlYWRlcnMgIT09IG51bGwgJiYgaGVhZGVycy5oYXNPd25Qcm9wZXJ0eSggImNvbnRlbnQtdHlwZSIgKSApIHsKCQkJCQljb250ZW50VHlwZSA9IGhlYWRlcnNbImNvbnRlbnQtdHlwZSJdOwoJCQkJfQoKCQkJCWlmICggY29ycyAmJiBjb250ZW50VHlwZSA9PT0gbnVsbCApIHsKCQkJCQljb250ZW50VHlwZSA9ICJ0ZXh0L3BsYWluIjsKCQkJCX0KCgkJCQkvLyBUcmFuc2Zvcm1pbmcgcGF5bG9hZAoJCQkJaWYgKCBwYXlsb2FkICE9PSBudWxsICkgewoJCQkJCWlmICggcGF5bG9hZC5oYXNPd25Qcm9wZXJ0eSggInhtbCIgKSApIHsKCQkJCQkJcGF5bG9hZCA9IHBheWxvYWQueG1sOwoJCQkJCX0KCgkJCQkJaWYgKCBkb2MgJiYgcGF5bG9hZCBpbnN0YW5jZW9mIERvY3VtZW50ICkgewoJCQkJCQlwYXlsb2FkID0geG1sLmRlY29kZSggcGF5bG9hZCApOwoJCQkJCX0KCgkJCQkJaWYgKCB0eXBlb2YgcGF5bG9hZCA9PSAic3RyaW5nIiAmJiByZWdleC5pc194bWwudGVzdCggcGF5bG9hZCApICkgewoJCQkJCQljb250ZW50VHlwZSA9ICJhcHBsaWNhdGlvbi94bWwiOwoJCQkJCX0KCgkJCQkJaWYgKCAhKCBhYiAmJiBwYXlsb2FkIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIgKSAmJiAhKCBibG9iICYmIHBheWxvYWQgaW5zdGFuY2VvZiBCbG9iICkgJiYgISggcGF5bG9hZCBpbnN0YW5jZW9mIEJ1ZmZlciApICYmIHBheWxvYWQgaW5zdGFuY2VvZiBPYmplY3QgKSB7CgkJCQkJCWNvbnRlbnRUeXBlID0gImFwcGxpY2F0aW9uL2pzb24iOwoJCQkJCQlwYXlsb2FkID0ganNvbi5lbmNvZGUoIHBheWxvYWQgKTsKCQkJCQl9CgoJCQkJCWlmICggY29udGVudFR5cGUgPT09IG51bGwgJiYgKCAoIGFiICYmIHBheWxvYWQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciApIHx8ICggYmxvYiAmJiBwYXlsb2FkIGluc3RhbmNlb2YgQmxvYiApICkgKSB7CgkJCQkJCWNvbnRlbnRUeXBlID0gImFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSI7CgkJCQkJfQoKCQkJCQlpZiAoIGNvbnRlbnRUeXBlID09PSBudWxsICkgewoJCQkJCQljb250ZW50VHlwZSA9ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgiOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTZXR0aW5nIGhlYWRlcnMgZm9yIGV2ZXJ5dGhpbmcgZXhjZXB0IElFOSBDT1JTIHJlcXVlc3RzCgkJCQlpZiAoICFjbGllbnQuaWUgfHwgKCAhY29ycyB8fCBjbGllbnQudmVyc2lvbiA+IDkgKSApIHsKCQkJCQlpZiAoIGhlYWRlcnMgPT09IG51bGwgKSB7CgkJCQkJCWhlYWRlcnMgPSB7fTsKCQkJCQl9CgoJCQkJCWlmICggdHlwZW9mIGNhY2hlZCA9PSAib2JqZWN0IiAmJiBjYWNoZWQuaGVhZGVycy5oYXNPd25Qcm9wZXJ0eSggImV0YWciICkgKSB7CgkJCQkJCWhlYWRlcnMuZXRhZyA9IGNhY2hlZC5oZWFkZXJzLmV0YWc7CgkJCQkJfQoKCQkJCQlpZiAoIGNvbnRlbnRUeXBlICE9PSBudWxsICkgewoJCQkJCQloZWFkZXJzWyJjb250ZW50LXR5cGUiXSA9IGNvbnRlbnRUeXBlOwoJCQkJCX0KCgkJCQkJaWYgKCBoZWFkZXJzLmhhc093blByb3BlcnR5KCAiY2FsbGJhY2siICkgKSB7CgkJCQkJCWRlbGV0ZSBoZWFkZXJzLmNhbGxiYWNrOwoJCQkJCX0KCgkJCQkJaGVhZGVyc1sieC1yZXF1ZXN0ZWQtd2l0aCJdID0gIlhNTEh0dHBSZXF1ZXN0IjsKCgkJCQkJdXRpbGl0eS5pdGVyYXRlKCBoZWFkZXJzLCBmdW5jdGlvbiAoIHYsIGsgKSB7CgkJCQkJCWlmICggdiAhPT0gbnVsbCAmJiBrICE9PSAid2l0aENyZWRlbnRpYWxzIikgewoJCQkJCQkJa3hoci54aHIuc2V0UmVxdWVzdEhlYWRlciggaywgdiApOwoJCQkJCQl9CgkJCQkJfSApOwoKCQkJCQkvLyBDcm9zcyBPcmlnaW4gUmVzb3VyY2UgU2hhcmluZyAoIENPUlMgKQoJCQkJCWlmICggdHlwZW9mIGt4aHIueGhyLndpdGhDcmVkZW50aWFscyA9PSAiYm9vbGVhbiIgJiYgaGVhZGVycyAhPT0gbnVsbCAmJiB0eXBlb2YgaGVhZGVycy53aXRoQ3JlZGVudGlhbHMgPT0gImJvb2xlYW4iICkgewoJCQkJCQlreGhyLnhoci53aXRoQ3JlZGVudGlhbHMgPSBoZWFkZXJzLndpdGhDcmVkZW50aWFsczsKCQkJCQl9CgkJCQl9CgoJCQkJa3hoci5vbiggImxvYWQiLCBmdW5jdGlvbiAoKSB7CgkJCQkJdmFyIHNlbGYgICA9IHRoaXMsCgkJCQkJICAgIHhkciAgICA9IGNsaWVudC5pZSAmJiB0aGlzLnhoci5yZWFkeVN0YXRlID09PSB1bmRlZmluZWQsCgkJCQkJICAgIHNoYXJlZCA9IHRydWUsCgkJCQkJICAgIG8sIHIsIHQsIHJlZGlyZWN0OwoKCQkJCQlpZiAoICF4ZHIgJiYgdGhpcy54aHIucmVhZHlTdGF0ZSA9PT0gNCApIHsKCQkJCQkJc3dpdGNoICggdGhpcy54aHIuc3RhdHVzICkgewoJCQkJCQkJY2FzZSAyMDA6CgkJCQkJCQljYXNlIDIwMToKCQkJCQkJCWNhc2UgMjAyOgoJCQkJCQkJY2FzZSAyMDM6CgkJCQkJCQljYXNlIDIwNDoKCQkJCQkJCWNhc2UgMjA1OgoJCQkJCQkJY2FzZSAyMDY6CgkJCQkJCQkJbyA9IGNsaWVudC5oZWFkZXJzKCB0aGlzLnhociwgdXJpLCB0eXBlICk7CgoJCQkJCQkJCWlmICggdHlwZSA9PT0gImhlYWQiICkgewoJCQkJCQkJCQlyZXR1cm4gdGhpcy5yZXNvbHZlKCBvLmhlYWRlcnMgKTsKCQkJCQkJCQl9CgkJCQkJCQkJZWxzZSBpZiAoIHR5cGUgPT09ICJvcHRpb25zIiApIHsKCQkJCQkJCQkJcmV0dXJuIHRoaXMucmVzb2x2ZSggby5oZWFkZXJzICk7CgkJCQkJCQkJfQoJCQkJCQkJCWVsc2UgaWYgKCB0eXBlICE9PSAiZGVsZXRlIiApIHsKCQkJCQkJCQkJaWYgKCBzZXJ2ZXIgJiYgcmVnZXgucHJpdi50ZXN0KCBvLmhlYWRlcnNbImNhY2hlLWNvbnRyb2wiXSApICkgewoJCQkJCQkJCQkJc2hhcmVkID0gZmFsc2U7CgkJCQkJCQkJCX0KCgkJCQkJCQkJCWlmICggcmVnZXguaHR0cF9ib2R5LnRlc3QoIHRoaXMueGhyLnN0YXR1cyApICkgewoJCQkJCQkJCQkJdCA9IG8uaGVhZGVyc1siY29udGVudC10eXBlIl0gfHwgIiI7CgkJCQkJCQkJCQlyID0gY2xpZW50LnBhcnNlKCB0aGlzLnhociwgdCApOwoKCQkJCQkJCQkJCWlmICggciA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkJCQkJCXRoaXMucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLnNlcnZlckVycm9yICkgKTsKCQkJCQkJCQkJCX0KCQkJCQkJCQkJfQoKCQkJCQkJCQkJaWYgKCB0eXBlID09PSAiZ2V0IiAmJiBzaGFyZWQgKSB7CgkJCQkJCQkJCQljYWNoZS5zZXQoIHVyaSwgInJlc3BvbnNlIiwgKCBvLnJlc3BvbnNlID0gdXRpbGl0eS5jbG9uZSggciwgdHJ1ZSApICkgKTsKCQkJCQkJCQkJfQoJCQkJCQkJCQllbHNlIHsKCQkJCQkJCQkJCWNhY2hlLmV4cGlyZSggdXJpLCB0cnVlICk7CgkJCQkJCQkJCX0KCQkJCQkJCQl9CgkJCQkJCQkJZWxzZSBpZiAoIHR5cGUgPT09ICJkZWxldGUiICkgewoJCQkJCQkJCQljYWNoZS5leHBpcmUoIHVyaSwgdHJ1ZSApOwoJCQkJCQkJCX0KCgkJCQkJCQkJc3dpdGNoICggdGhpcy54aHIuc3RhdHVzICkgewoJCQkJCQkJCQljYXNlIDIwMDoKCQkJCQkJCQkJY2FzZSAyMDI6CgkJCQkJCQkJCWNhc2UgMjAzOgoJCQkJCQkJCQljYXNlIDIwNjoKCQkJCQkJCQkJCXRoaXMucmVzb2x2ZSggciApOwoJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCWNhc2UgMjAxOgoJCQkJCQkJCQkJaWYgKCAoIG8uaGVhZGVycy5sb2NhdGlvbiA9PT0gdW5kZWZpbmVkIHx8IHN0cmluZy5pc0VtcHR5KCBvLmhlYWRlcnMubG9jYXRpb24gKSApICYmICFzdHJpbmcuaXNVcmwoIHIgKSApIHsKCQkJCQkJCQkJCQl0aGlzLnJlc29sdmUoIHIgKTsKCQkJCQkJCQkJCX0KCQkJCQkJCQkJCWVsc2UgewoJCQkJCQkJCQkJCXJlZGlyZWN0ID0gc3RyaW5nLnRyaW0gKCBvLmhlYWRlcnMuTG9jYXRpb24gfHwgciApOwoJCQkJCQkJCQkJCWNsaWVudC5yZXF1ZXN0KCByZWRpcmVjdCApLnRoZW4oIGZ1bmN0aW9uICggYXJnICkgewoJCQkJCQkJCQkJCQlzZWxmLnJlc29sdmUgKCBhcmcgKTsKCQkJCQkJCQkJCQl9LCBmdW5jdGlvbiAoIGUgKSB7CgkJCQkJCQkJCQkJCXNlbGYucmVqZWN0KCBlICk7CgkJCQkJCQkJCQkJfSApOwoJCQkJCQkJCQkJfQoJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCWNhc2UgMjA0OgoJCQkJCQkJCQljYXNlIDIwNToKCQkJCQkJCQkJCXRoaXMucmVzb2x2ZSggbnVsbCApOwoJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJfQoJCQkJCQkJCWJyZWFrOwoJCQkJCQkJY2FzZSAzMDQ6CgkJCQkJCQkJdGhpcy5yZXNvbHZlKCByICk7CgkJCQkJCQkJYnJlYWs7CgkJCQkJCQljYXNlIDQwMToKCQkJCQkJCQl0aGlzLnJlamVjdCggbmV3IEVycm9yKCB0aGlzLnhoci5yZXNwb25zZVRleHQgfHwgbGFiZWwuc2VydmVyVW5hdXRob3JpemVkICkgKTsKCQkJCQkJCQlicmVhazsKCQkJCQkJCWNhc2UgNDAzOgoJCQkJCQkJCWNhY2hlLnNldCggdXJpLCAiIXBlcm1pc3Npb24iLCBjbGllbnQuYml0KCBbdHlwZV0gKSApOwoJCQkJCQkJCXRoaXMucmVqZWN0KCBuZXcgRXJyb3IoIHRoaXMueGhyLnJlc3BvbnNlVGV4dCB8fCBsYWJlbC5zZXJ2ZXJGb3JiaWRkZW4gKSApOwoJCQkJCQkJCWJyZWFrOwoJCQkJCQkJY2FzZSA0MDU6CgkJCQkJCQkJY2FjaGUuc2V0KCB1cmksICIhcGVybWlzc2lvbiIsIGNsaWVudC5iaXQoIFt0eXBlXSApICk7CgkJCQkJCQkJdGhpcy5yZWplY3QoIG5ldyBFcnJvciggdGhpcy54aHIucmVzcG9uc2VUZXh0IHx8IGxhYmVsLnNlcnZlckludmFsaWRNZXRob2QgKSApOwoJCQkJCQkJCWJyZWFrOwoJCQkJCQkJZGVmYXVsdDoKCQkJCQkJCQl0aGlzLnJlamVjdCggbmV3IEVycm9yKCB0aGlzLnhoci5yZXNwb25zZVRleHQgfHwgbGFiZWwuc2VydmVyRXJyb3IgKSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWVsc2UgaWYgKCB4ZHIgKSB7CgkJCQkJCXIgPSBjbGllbnQucGFyc2UoIHRoaXMueGhyLCAidGV4dC9wbGFpbiIgKTsKCQkJCQkJY2FjaGUuc2V0KCB1cmksICJwZXJtaXNzaW9uIiwgY2xpZW50LmJpdCggWyJnZXQiXSApICk7CgkJCQkJCWNhY2hlLnNldCggdXJpLCAicmVzcG9uc2UiLCByICk7CgkJCQkJCXRoaXMucmVzb2x2ZSggciApOwoJCQkJCX0KCQkJCX0gKTsKCgkJCQlreGhyLm9uKCAiZXJyb3IiLCBmdW5jdGlvbiAoIGUgKSB7CgkJCQkJdGhpcy5yZWplY3QoIGUgKTsKCQkJCX0gKTsKCgkJCQkvLyBTZW5kaW5nIHJlcXVlc3QKCQkJCWt4aHIueGhyLnNlbmQoIHBheWxvYWQgIT09IG51bGwgPyBwYXlsb2FkIDogdW5kZWZpbmVkICk7CgkJCX0gKTsKCQl9CgoJCXJldHVybiBreGhyOwoJfSwKCgkvKioKCSAqIFNjcm9sbHMgdG8gYSBwb3NpdGlvbiBpbiB0aGUgdmlldyB1c2luZyBhIHR3byBwb2ludCBiZXppZXIgY3VydmUKCSAqCgkgKiBAbWV0aG9kIHNjcm9sbAoJICogQG1lbWJlck9mIGNsaWVudAoJICogQHBhcmFtICB7QXJyYXl9ICBkZXN0IENvb3JkaW5hdGVzCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IG1zICAgW09wdGlvbmFsXSBNaWxsaXNlY29uZHMgdG8gc2Nyb2xsLCBkZWZhdWx0IGlzIDI1MCwgbWluIGlzIDEwMAoJICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsgRGVmZXJyZWR9CgkgKiBAcHJpdmF0ZQoJICovCglzY3JvbGwgOiBmdW5jdGlvbiAoIGRlc3QsIG1zICkgewoJCXZhciBkZWZlciA9IGRlZmVycmVkKCksCgkJICAgIHN0YXJ0ID0gY2xpZW50LnNjcm9sbFBvcygpLAoJCSAgICB0ICAgICA9IDA7CgoJCW1zID0gKCAhaXNOYU4oIG1zICkgPyBtcyA6IDI1MCApIC8gMTAwOwoKCQl1dGlsaXR5LnJlcGVhdCggZnVuY3Rpb24gKCkgewoJCQl2YXIgcG9zID0gbWF0aC5iZXppZXIoIHN0YXJ0WzBdLCBzdGFydFsxXSwgZGVzdFswXSwgZGVzdFsxXSwgKyt0IC8gMTAwICk7CgoJCQl3aW5kb3cuc2Nyb2xsVG8oIHBvc1swXSwgcG9zWzFdICk7CgoJCQlpZiAoIHQgPT09IDEwMCApIHsKCQkJCWRlZmVyLnJlc29sdmUoIHRydWUgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sIG1zLCAic2Nyb2xsaW5nIiApOwoKCQlyZXR1cm4gZGVmZXI7Cgl9LAoKCS8qKgoJICogUmV0dXJucyB0aGUgY3VycmVudCBzY3JvbGwgcG9zaXRpb24gb2YgdGhlIFZpZXcKCSAqCgkgKiBAbWV0aG9kIHNjcm9sbFBvcwoJICogQG1lbWJlck9mIGNsaWVudAoJICogQHJldHVybiB7QXJyYXl9IERlc2NyaWJlcyB0aGUgc2Nyb2xsIHBvc2l0aW9uCgkgKiBAcHJpdmF0ZQoJICovCglzY3JvbGxQb3MgOiBmdW5jdGlvbiAoKSB7CgkJcmV0dXJuIFsKCQkJd2luZG93LnNjcm9sbFggfHwgMCwKCQkJd2luZG93LnNjcm9sbFkgfHwgMAoJCV07Cgl9Cn07CgovKioKICogQG5hbWVzcGFjZSBjc3YKICovCnZhciBjc3YgPSB7CgkvKioKCSAqIENvbnZlcnRzIENTViB0byBhbiBBcnJheSBvZiBPYmplY3RzCgkgKgoJICogQG1ldGhvZCBkZWNvZGUKCSAqIEBtZW1iZXJPZiBjc3YKCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnICAgICAgIENTViBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gZGVsaW1pdGVyIFtPcHRpb25hbF0gRGVsaW1pdGVyIHRvIHNwbGl0IGNvbHVtbnMgb24sIGRlZmF1bHQgaXMgIiwiCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgICAgICBBcnJheSBvZiBPYmplY3RzCgkgKi8KCWRlY29kZSA6IGZ1bmN0aW9uICggYXJnLCBkZWxpbWl0ZXIgKSB7CgkJZGVsaW1pdGVyICA9IGRlbGltaXRlciB8fCAiLCI7CgkJdmFyIHJlZ2V4ICA9IG5ldyBSZWdFeHAoIGRlbGltaXRlciArICIoPz0oPzpbXlwiXXxcIig/OlteXCJdKVteXCJdKlwiKSokKSIgKSwKCQkgICAgcm93cyAgID0gc3RyaW5nLnRyaW0oIGFyZyApLnNwbGl0KCAiXG4iICksCgkJICAgIGtleXMgICA9IHJvd3Muc2hpZnQoKS5zcGxpdCggZGVsaW1pdGVyICksCgkJICAgIHJlc3VsdCA9IFtdLAoJCSAgICBudGggICAgPSByb3dzLmxlbmd0aCwKCQkgICAgeCAgICAgID0ga2V5cy5sZW5ndGgsCgkJICAgIGkgICAgICA9IC0xLAoJCSAgICBuLCBvYmosIHJvdzsKCgkJd2hpbGUgKCArK2kgPCBudGggKSB7CgkJCW9iaiA9IHt9OwoJCQlyb3cgPSByb3dzW2ldLnNwbGl0KCByZWdleCApOwoKCQkJbiA9IC0xOwoJCQl3aGlsZSAoICsrbiAgPCB4ICkgewoJCQkJb2JqW2tleXNbbl1dID0gdXRpbGl0eS5jb2VyY2UoICggcm93W25dIHx8ICIiICkucmVwbGFjZSggL14ifCIkL2csICIiICkgKTsKCQkJfQoKCQkJcmVzdWx0LnB1c2goIG9iaiApOwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBFbmNvZGVzIGFuIEFycmF5LCBKU09OLCBvciBPYmplY3QgYXMgQ1NWCgkgKgoJICogQG1ldGhvZCBlbmNvZGUKCSAqIEBtZW1iZXJPZiBjc3YKCSAqIEBwYXJhbSAge01peGVkfSAgIGFyZyAgICAgICBKU09OLCBBcnJheSBvciBPYmplY3QKCSAqIEBwYXJhbSAge1N0cmluZ30gIGRlbGltaXRlciBbT3B0aW9uYWxdIENoYXJhY3RlciB0byBzZXBhcmF0ZSBmaWVsZHMKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGhlYWRlciAgICBbT3B0aW9uYWxdIGBmYWxzZWAgdG8gZGlzYWJsZSBrZXlzIG5hbWVzIGFzIGZpcnN0IHJvdwoJICogQHJldHVybiB7U3RyaW5nfSAgICAgICAgICAgIENTViBzdHJpbmcKCSAqIEBleGFtcGxlCgkgKiB2YXIgY3N2ID0ga2VpZ2FpLnV0aWwuY3N2LmVuY29kZSggW3twcm9wOiJ2YWx1ZSJ9LCB7cHJvcDoidmFsdWUyIn1dICk7CgkgKgoJICogY29uc29sZS5sb2coIGNzdiApOwoJICogInByb3AKCSAqICB2YWx1ZQoJICogIHZhbHVlMiIKCSAqLwoJZW5jb2RlIDogZnVuY3Rpb24gKCBhcmcsIGRlbGltaXRlciwgaGVhZGVyICkgewoJCXZhciBvYmogICAgPSBqc29uLmRlY29kZSggYXJnLCB0cnVlICkgfHwgYXJnLAoJCSAgICByZXN1bHQgPSAiIjsKCgkJZGVsaW1pdGVyICA9IGRlbGltaXRlciB8fCAiLCI7CgkJaGVhZGVyICAgICA9ICggaGVhZGVyICE9PSBmYWxzZSApOwoKCQkvLyBQcmVwYXJlcyBpbnB1dCBiYXNlZCBvbiBDU1YgcnVsZXMKCQlmdW5jdGlvbiBwcmVwYXJlICggaW5wdXQgKSB7CgkJCXZhciBvdXRwdXQ7CgoJCQlpZiAoIGlucHV0IGluc3RhbmNlb2YgQXJyYXkgKSB7CgkJCQlvdXRwdXQgPSAiXCIiICsgaW5wdXQudG9TdHJpbmcoKSArICJcIiI7CgoJCQkJaWYgKCByZWdleC5vYmplY3RfdHlwZS50ZXN0KCBvdXRwdXQgKSApIHsKCQkJCQlvdXRwdXQgPSAiXCIiICsgY3N2LmVuY29kZSggaW5wdXQsIGRlbGltaXRlciApICsgIlwiIjsKCQkJCX0KCQkJfQoJCQllbHNlIGlmICggaW5wdXQgaW5zdGFuY2VvZiBPYmplY3QgKSB7CgkJCQlvdXRwdXQgPSAiXCIiICsgY3N2LmVuY29kZSggaW5wdXQsIGRlbGltaXRlciApICsgIlwiIjsKCQkJfQoJCQllbHNlIGlmICggcmVnZXguY3N2X3F1b3RlLnRlc3QoIGlucHV0ICkgKSB7CgkJCQlvdXRwdXQgPSAiXCIiICsgaW5wdXQucmVwbGFjZSggLyIvZywgIlwiXCIiICkgKyAiXCIiOwoJCQl9CgkJCWVsc2UgewoJCQkJb3V0cHV0ID0gaW5wdXQ7CgkJCX0KCgkJCXJldHVybiBvdXRwdXQ7CgkJfQoKCQlpZiAoIG9iaiBpbnN0YW5jZW9mIEFycmF5ICkgewoJCQlpZiAoIG9ialswXSBpbnN0YW5jZW9mIE9iamVjdCApIHsKCQkJCWlmICggaGVhZGVyICkgewoJCQkJCXJlc3VsdCA9ICggYXJyYXkua2V5cyggb2JqWzBdICkuam9pbiggZGVsaW1pdGVyICkgKyAiXG4iICk7CgkJCQl9CgoJCQkJcmVzdWx0ICs9IG9iai5tYXAoIGZ1bmN0aW9uICggaSApIHsKCQkJCQlyZXR1cm4gY3N2LmVuY29kZSggaSwgZGVsaW1pdGVyLCBmYWxzZSApOwoJCQkJfSApLmpvaW4oICJcbiIgKTsKCQkJfQoJCQllbHNlIHsKCQkJCXJlc3VsdCArPSAoIHByZXBhcmUoIG9iaiwgZGVsaW1pdGVyICkgKyAiXG4iICk7CgkJCX0KCgkJfQoJCWVsc2UgewoJCQlpZiAoIGhlYWRlciApIHsKCQkJCXJlc3VsdCA9ICggYXJyYXkua2V5cyggb2JqICkuam9pbiggZGVsaW1pdGVyICkgKyAiXG4iICk7CgkJCX0KCgkJCXJlc3VsdCArPSAoIGFycmF5LmNhc3QoIG9iaiApLm1hcCggcHJlcGFyZSApLmpvaW4oIGRlbGltaXRlciApICsgIlxuIiApOwoJCX0KCgkJcmV0dXJuIHJlc3VsdC5yZXBsYWNlKCByZWdleC5lb2xfbmwgLCAiIik7Cgl9Cn07CgovKioKICogQG5hbWVzcGFjZSBmaWx0ZXIKICovCnZhciBmaWx0ZXIgPSB7CgkvKioKCSAqIERhdGFMaXN0RmlsdGVyIGZhY3RvcnkKCSAqCgkgKiBAbWV0aG9kIGZhY3RvcnkKCSAqIEBtZW1iZXJPZiBmaWx0ZXIKCSAqIEBwYXJhbSAge09iamVjdH0gdGFyZ2V0ICAgRWxlbWVudCB0byByZWNlaXZlIHRoZSBmaWx0ZXIKCSAqIEBwYXJhbSAge09iamVjdH0gbGlzdCAgICAge0BsaW5rIGtlaWdhaS5EYXRhTGlzdH0KCSAqIEBwYXJhbSAge1N0cmluZ30gZmlsdGVycyAgQ29tbWEgZGVsaW1pdGVkIHN0cmluZyBvZiBmaWVsZHMgdG8gZmlsdGVyIGJ5CgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGRlYm91bmNlIFtPcHRpb25hbF0gTWlsbGlzZWNvbmRzIHRvIGRlYm91bmNlLCBkZWZhdWx0IGlzIGAyNTBgCgkgKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUxpc3RGaWx0ZXJ9CgkgKiBAZXhhbXBsZQoJICogdmFyIHN0b3JlICA9IGtlaWdhaS5zdG9yZSggWy4uLl0gKSwKCSAqICAgICBsaXN0ICAgPSBrZWlnYWkubGlzdCggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNsaXN0IiApLCBzdG9yZSwgInt7ZmllbGR9fSIgKSwKCSAqICAgICBmaWx0ZXIgPSBrZWlnYWkuZmlsdGVyKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiaW5wdXQuZmlsdGVyIiApLCBsaXN0LCAiZmllbGQiICk7CgkgKi8KCWZhY3RvcnkgOiBmdW5jdGlvbiAoIHRhcmdldCwgbGlzdCwgZmlsdGVycywgZGVib3VuY2UgKSB7CgkJdmFyIHJlZiA9IFtsaXN0XSwKCQkgICAgb2JqOwoKCQlkZWJvdW5jZSA9IGRlYm91bmNlIHx8IDI1MDsKCgkJaWYgKCAhKCB0YXJnZXQgaW5zdGFuY2VvZiBFbGVtZW50ICkgfHwgKCBsaXN0ICYmICFsaXN0LnN0b3JlICkgfHwgKCB0eXBlb2YgZmlsdGVycyAhPSAic3RyaW5nIiB8fCBzdHJpbmcuaXNFbXB0eSggZmlsdGVycyApICkgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApOwoJCX0KCgkJb2JqID0gbmV3IERhdGFMaXN0RmlsdGVyKCB0YXJnZXQsIHJlZlswXSwgZGVib3VuY2UgKS5zZXQoIGZpbHRlcnMgKTsKCgkJLy8gRGVjb3JhdGluZyBgdGFyZ2V0YCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBpbnB1dCBgdHlwZWAKCQllbGVtZW50LmF0dHIoIHRhcmdldCwgInR5cGUiLCAidGV4dCIgKTsKCgkJLy8gU2V0dGluZyB1cCBhIGNoYWluIG9mIEV2ZW50cwoJCW9iai5vYnNlcnZlci5ob29rKCBvYmouZWxlbWVudCwgImtleXVwIiApOwoJCW9iai5vYnNlcnZlci5ob29rKCBvYmouZWxlbWVudCwgImlucHV0IiApOwoJCW9iai5vbiggImtleXVwIiwgb2JqLnVwZGF0ZSwgImtleXVwIiApOwoJCW9iai5vbiggImlucHV0Iiwgb2JqLnVwZGF0ZSwgImlucHV0IiApOwoKCQlyZXR1cm4gb2JqOwoJfQp9OwoKLyoqCiAqIENyZWF0ZXMgYSBuZXcgRGF0YUxpc3RGaWx0ZXIKICoKICogQGNvbnN0cnVjdG9yCiAqIEBtZW1iZXJPZiBrZWlnYWkKICogQGV4dGVuZHMge2tlaWdhaS5CYXNlfQogKiBAcGFyYW0gIHtPYmplY3R9IG9iaiAgICAgIEVsZW1lbnQgdG8gcmVjZWl2ZSB0aGUgZmlsdGVyCiAqIEBwYXJhbSAge09iamVjdH0gbGlzdCAgICAge0BsaW5rIGtlaWdhaS5EYXRhTGlzdH0KICogQHBhcmFtICB7TnVtYmVyfSBkZWJvdW5jZSBbT3B0aW9uYWxdIE1pbGxpc2Vjb25kcyB0byBkZWJvdW5jZQogKiBAZXhhbXBsZQogKiB2YXIgc3RvcmUgID0ga2VpZ2FpLnN0b3JlKCBbLi4uXSApLAogKiAgICAgbGlzdCAgID0ga2VpZ2FpLmxpc3QoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjbGlzdCIgKSwgc3RvcmUsICJ7e2ZpZWxkfX0iICksCiAqICAgICBmaWx0ZXIgPSBrZWlnYWkuZmlsdGVyKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiaW5wdXQuZmlsdGVyIiApLCBsaXN0LCAiZmllbGQiICk7CiAqLwpmdW5jdGlvbiBEYXRhTGlzdEZpbHRlciAoIGVsZW1lbnQsIGxpc3QsIGRlYm91bmNlICkgewoJdGhpcy5kZWJvdW5jZSA9IGRlYm91bmNlOwoJdGhpcy5lbGVtZW50ICA9IGVsZW1lbnQ7Cgl0aGlzLmZpbHRlcnMgID0ge307Cgl0aGlzLmxpc3QgICAgID0gbGlzdDsKCXRoaXMub2JzZXJ2ZXIgPSBvYnNlcnZhYmxlLmZhY3RvcnkoKTsKfQoKLyoqCiAqIEV4dGVuZGluZyBCYXNlCiAqCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3RGaWx0ZXIKICogQHR5cGUge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKi8KRGF0YUxpc3RGaWx0ZXIucHJvdG90eXBlID0gYmFzZS5mYWN0b3J5KCk7CgovKioKICogU2V0dGluZyBjb25zdHJ1Y3RvciBsb29wCiAqCiAqIEBtZXRob2QgY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhTGlzdEZpbHRlcgogKiBAdHlwZSB7RnVuY3Rpb259CiAqIEBwcml2YXRlCiAqLwpEYXRhTGlzdEZpbHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEYXRhTGlzdEZpbHRlcjsKCi8qKgogKiBTZXQgdGhlIGZpbHRlcnMKICoKICogQ3JlYXRlIGFuIG9iamVjdCBiYXNlZCBvbiBjb21tYSBzZXBhcmF0ZWQga2V5IHN0cmluZwogKgogKiBAbWV0aG9kIHNldAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFMaXN0RmlsdGVyCiAqIEBwYXJhbSAge1N0cmluZ30gZmllbGRzIENvbW1hIHNlcGFyYXRlZCBmaWx0ZXJzCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhTGlzdEZpbHRlcn0KICogQGV4YW1wbGUKICogZmlsdGVyLnNldCggImZpcnN0TmFtZSwgbGFzdE5hbWUsIGVtYWlsIiApOwogKi8KRGF0YUxpc3RGaWx0ZXIucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uICggZmllbGRzICkgewoJdmFyIG9iaiA9IHt9OwoKCWFycmF5LmVhY2goIHN0cmluZy5leHBsb2RlKCBmaWVsZHMgKSwgZnVuY3Rpb24gKCB2ICkgewoJCW9ialt2XSA9ICIiOwoJfSApOwoKCXRoaXMuZmlsdGVycyA9IG9iajsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBSZW1vdmVzIGxpc3RlbmVycywgYW5kIERPTSBob29rcyB0byBhdm9pZCBtZW1vcnkgbGVha3MKICoKICogQG1ldGhvZCB0ZWFyZG93bgogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFMaXN0RmlsdGVyCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhTGlzdEZpbHRlcn0KICogQGV4YW1wbGUKICogZmlsdGVyLnRlYXJkb3duKCk7CiAqLwpEYXRhTGlzdEZpbHRlci5wcm90b3R5cGUudGVhcmRvd24gPSBmdW5jdGlvbiAoKSB7Cgl0aGlzLm9ic2VydmVyLnVuaG9vayggdGhpcy5lbGVtZW50LCAia2V5dXAiICk7Cgl0aGlzLm9ic2VydmVyLnVuaG9vayggdGhpcy5lbGVtZW50LCAiaW5wdXQiICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogQXBwbGllcyB0aGUgaW5wdXQgdmFsdWUgYXMgYSBmaWx0ZXIgYWdhaW5zdCB0aGUgRGF0YUxpc3QgYmFzZWQgb24gc3BlY2lmaWMgZmllbGRzCiAqCiAqIEBtZXRob2QgdXBkYXRlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3RGaWx0ZXIKICogQGZpcmVzIGtlaWdhaS5EYXRhTGlzdCNiZWZvcmVGaWx0ZXIgRmlyZXMgYmVmb3JlIGZpbHRlcgogKiBAZmlyZXMga2VpZ2FpLkRhdGFMaXN0I2FmdGVyRmlsdGVyIEZpcmVzIGFmdGVyIGZpbHRlcgogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUxpc3RGaWx0ZXJ9CiAqIEBleGFtcGxlCiAqIGZpbHRlci51cGRhdGUoKTsgLy8gRGVib3VuY2VkIGV4ZWN1dGlvbgogKi8KRGF0YUxpc3RGaWx0ZXIucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uICgpIHsKCXZhciBzZWxmID0gdGhpczsKCgl1dGlsaXR5LmRlZmVyKCBmdW5jdGlvbiAoKSB7CgkJdmFyIHZhbCA9IGVsZW1lbnQudmFsKCBzZWxmLmVsZW1lbnQgKS50b1N0cmluZygpOwoJCQoJCXNlbGYubGlzdC5kaXNwYXRjaCggImJlZm9yZUZpbHRlciIsIHNlbGYuZWxlbWVudCwgdmFsICk7CgoJCWlmICggIXN0cmluZy5pc0VtcHR5KCB2YWwgKSApIHsKCQkJdXRpbGl0eS5pdGVyYXRlKCBzZWxmLmZpbHRlcnMsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCXZhciBxdWVyaWVzID0gc3RyaW5nLmV4cGxvZGUoIHZhbCApOwoKCQkJCS8vIElnbm9yaW5nIHRyYWlsaW5nIGNvbW1hcwoJCQkJcXVlcmllcyA9IHF1ZXJpZXMuZmlsdGVyKCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJcmV0dXJuICFzdHJpbmcuaXNFbXB0eSggaSApOwoJCQkJfSApOwoKCQkJCS8vIFNoYXBpbmcgdmFsaWQgcGF0dGVybgoJCQkJYXJyYXkuZWFjaCggcXVlcmllcywgZnVuY3Rpb24gKCBpLCBpZHggKSB7CgkJCQkJdGhpc1tpZHhdID0gIl4uKiIgKyBzdHJpbmcuZXNjYXBlKCBpICkucmVwbGFjZSggLyheXCp8XCokKS9nLCAiIiApLnJlcGxhY2UoIC9cKi9nLCAiLioiICkgKyAiLioiOwoJCQkJfSApOwoKCQkJCXRoaXNba10gPSBxdWVyaWVzLmpvaW4oICIsIiApOwoJCQl9ICk7CgoJCQlzZWxmLmxpc3QuZmlsdGVyID0gc2VsZi5maWx0ZXJzOwoJCX0KCQllbHNlIHsKCQkJc2VsZi5saXN0LmZpbHRlciA9IG51bGw7CgkJfQoKCQlzZWxmLmxpc3QucGFnZUluZGV4ID0gMTsKCQlzZWxmLmxpc3QucmVmcmVzaCgpOwoKCQlzZWxmLmxpc3QuZGlzcGF0Y2goICJhZnRlckZpbHRlciIsIHNlbGYuZWxlbWVudCApOwoJfSwgdGhpcy5kZWJvdW5jZSwgdGhpcy5lbGVtZW50LmlkICsgIkRlYm91bmNlIik7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogQG5hbWVzcGFjZSBncmlkCiAqLwp2YXIgZ3JpZCA9IHsKCS8qKgoJICogRGF0YUdyaWQgZmFjdG9yeQoJICoKCSAqIEBtZXRob2QgZmFjdG9yeQoJICogQG1lbWJlck9mIGdyaWQKCSAqIEBmaXJlcyBrZWlnYWkuRGF0YUdyaWQjY2hhbmdlIEZpcmVzIHdoZW4gdGhlIERPTSBjaGFuZ2VzCgkgKiBAcGFyYW0gIHtPYmplY3R9ICB0YXJnZXQgICAgICBFbGVtZW50IHRvIHJlY2VpdmUgRGF0YUdyaWQKCSAqIEBwYXJhbSAge09iamVjdH0gIHN0b3JlICAgICAgIERhdGFTdG9yZQoJICogQHBhcmFtICB7QXJyYXl9ICAgZmllbGRzICAgICAgQXJyYXkgb2YgZmllbGRzIHRvIGRpc3BsYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgIHNvcnRhYmxlICAgIFtPcHRpb25hbF0gQXJyYXkgb2Ygc29ydGFibGUgY29sdW1ucy9maWVsZHMKCSAqIEBwYXJhbSAge09iamVjdH0gIG9wdGlvbnMgICAgIFtPcHRpb25hbF0gRGF0YUxpc3Qgb3B0aW9ucwoJICogQHBhcmFtICB7Qm9vbGVhbn0gZmlsdGVyZWQgICAgW09wdGlvbmFsXSBDcmVhdGUgYW4gaW5wdXQgdG8gZmlsdGVyIHRoZSBkYXRhIGdyaWQKCSAqIEBwYXJhbSAge051bWJlcn0gIGRlYm91bmNlICAgIFtPcHRpb25hbF0gRGF0YUxpc3RGaWx0ZXIgaW5wdXQgZGVib3VuY2UsIGRlZmF1bHQgaXMgMjUwCgkgKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUdyaWR9CgkgKiBAZXhhbXBsZQoJICogdmFyIGZpZWxkcyAgPSBbIm5hbWUiLCAiYWdlIl0sCgkgKiAgICAgb3B0aW9ucyA9IHtwYWdlU2l6ZTogNSwgb3JkZXI6ICJhZ2UgZGVzYywgbmFtZSJ9LAoJICogICAgIHN0b3JlICAgPSBrZWlnYWkuc3RvcmUoKSwKCSAqICAgICBncmlkICAgID0ga2VpZ2FpLmdyaWQoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjZ3JpZCIgKSwgc3RvcmUsIGZpZWxkcywgZmllbGRzLCBvcHRpb25zLCB0cnVlICk7CgkgKgoJICogc3RvcmUuc2V0VXJpKCAiZGF0YS5qc29uIiApLnRoZW4oIG51bGwsIGZ1bmN0aW9uICggZSApIHsKCSAqICAgLi4uCgkgKiB9ICk7CgkgKi8KCWZhY3RvcnkgOiBmdW5jdGlvbiAoIHRhcmdldCwgc3RvcmUsIGZpZWxkcywgc29ydGFibGUsIG9wdGlvbnMsIGZpbHRlcmVkLCBkZWJvdW5jZSApIHsKCQl2YXIgcmVmID0gW3N0b3JlXSwKCQkgICAgb2JqLCB0ZW1wbGF0ZSwgaGVhZGVyLCB3aWR0aCwgY3NzLCBzb3J0OwoKCQlvYmogICAgICAgPSBuZXcgRGF0YUdyaWQoIHRhcmdldCwgcmVmWzBdLCBmaWVsZHMsIHNvcnRhYmxlLCBvcHRpb25zLCBmaWx0ZXJlZCApOwoJCXRlbXBsYXRlICA9ICIiOwoJCWhlYWRlciAgICA9IGVsZW1lbnQuY3JlYXRlKCAibGkiLCB7fSwgZWxlbWVudC5jcmVhdGUoICJ1bCIsIHsiY2xhc3MiOiAiaGVhZGVyIn0sIG9iai5lbGVtZW50ICkgKTsKCQl3aWR0aCAgICAgPSAoIDEwMCAvIG9iai5maWVsZHMubGVuZ3RoICkgKyAiJSI7CgkJY3NzICAgICAgID0gImRpc3BsYXk6aW5saW5lLWJsb2NrO3dpZHRoOiIgKyB3aWR0aDsKCQlzb3J0ICAgICAgPSBvYmoub3B0aW9ucy5vcmRlciA/IHN0cmluZy5leHBsb2RlKCBvYmoub3B0aW9ucy5vcmRlciApIDogW107CgoJCS8vIENyZWF0aW5nIERhdGFMaXN0IHRlbXBsYXRlIGJhc2VkIG9uIGZpZWxkcwoJCWFycmF5LmVhY2goIG9iai5maWVsZHMsIGZ1bmN0aW9uICggaSApIHsKCQkJdmFyIHRyaW1tZWQgPSBpLnJlcGxhY2UoIC8uKlwuL2csICIiICksCgkJCSAgICBlbCAgICAgID0gZWxlbWVudC5jcmVhdGUoICJzcGFuIiwge2lubmVySFRNTDogc3RyaW5nLmNhcGl0YWxpemUoIHN0cmluZy51bkNhbWVsQ2FzZSggc3RyaW5nLnVuaHlwaGVuYXRlKCB0cmltbWVkLCB0cnVlICkgKS5yZXBsYWNlKCAvX3wtL2csICIgIiApLCB0cnVlICksIHN0eWxlOiBjc3MsICJkYXRhLWZpZWxkIjogaX0sIGhlYWRlciApOwoKCQkJLy8gQWRkaW5nIENTUyBjbGFzcyBpZiAiY29sdW1uIiBpcyBzb3J0YWJsZQoJCQlpZiAoIGFycmF5LmNvbnRhaW5zKCBvYmouc29ydGFibGUsIGkgKSApIHsKCQkJCWVsZW1lbnQua2xhc3MoIGVsLCAic29ydGFibGUiLCB0cnVlICk7CgoJCQkJLy8gQXBwbHlpbmcgZGVmYXVsdCBzb3J0LCBpZiBzcGVjaWZpZWQKCQkJCWlmICggc29ydC5maWx0ZXIoIGZ1bmN0aW9uICggeCApIHsgcmV0dXJuICggeC5pbmRleE9mKCBpICkgPT09IDAgKTsgfSApLmxlbmd0aCA+IDAgKSB7CgkJCQkJZWxlbWVudC5kYXRhKCBlbCwgInNvcnQiLCBhcnJheS5jb250YWlucyggc29ydCwgaSArICIgZGVzYyIgKSA/ICJkZXNjIiA6ICJhc2MiICk7CgkJCQl9CgkJCX0KCgkJCXRlbXBsYXRlICs9ICI8c3BhbiBjbGFzcz1cIiIgKyBpICsgIlwiIGRhdGEtZmllbGQ9XCIiICsgaSArICJcIiBzdHlsZT1cIiIgKyBjc3MgKyAiXCI+e3siICsgaSArICJ9fTwvc3Bhbj4iOwoJCX0gKTsKCgkJLy8gU2V0dGluZyBjbGljayBoYW5kbGVyIG9uIHNvcnRhYmxlICJjb2x1bW5zIgoJCWlmICggb2JqLnNvcnRhYmxlLmxlbmd0aCA+IDAgKSB7CgkJCW9iai5vYnNlcnZlci5ob29rKCBoZWFkZXIucGFyZW50Tm9kZSwgImNsaWNrIiwgb2JqLnNvcnQsICJzb3J0Iiwgb2JqICk7CgkJfQoKCQkvLyBDcmVhdGluZyBEYXRhTGlzdAoJCXJlZi5wdXNoKCBsaXN0LmZhY3RvcnkoIG9iai5lbGVtZW50LCByZWZbMF0sIHRlbXBsYXRlLCBvYmoub3B0aW9ucyApICk7CgoJCS8vIFNldHRpbmcgYnktcmVmZXJlbmNlIERhdGFMaXN0IG9uIERhdGFHcmlkCgkJb2JqLmxpc3QgPSByZWZbMV07CgoJCWlmICggb2JqLmZpbHRlcmVkID09PSB0cnVlICkgewoJCQkvLyBDcmVhdGluZyBEYXRhTGlzdEZpbHRlcgoJCQlyZWYucHVzaCggZmlsdGVyLmZhY3RvcnkoIGVsZW1lbnQuY3JlYXRlKCAiaW5wdXQiLCB7ImNsYXNzIjogImZpbHRlciIsIHBsYWNlaG9sZGVyOiAiRmlsdGVyIn0sIG9iai5lbGVtZW50LCAiZmlyc3QiICksIHJlZlsxXSwgb2JqLmZpZWxkcy5qb2luKCAiLCIgKSwgZGVib3VuY2UgfHwgMjUwICkgKTsKCQkJCgkJCS8vIFNldHRpbmcgYnktcmVmZXJlbmNlIERhdGFMaXN0RmlsdGVyIG9uIERhdGFHcmlkCgkJCW9iai5maWx0ZXIgPSByZWZbMl07CgkJfQoKCQkvLyBTZXR0aW5nIHVwIGEgY2hhaW4gb2YgRXZlbnRzCgkJb2JqLm9uKCAiYmVmb3JlUmVmcmVzaCIsIGZ1bmN0aW9uICggYXJnICkgewoJCQllbGVtZW50LmRpc3BhdGNoKCBhcmcsICJiZWZvcmVSZWZyZXNoIiApOwoJCX0sICJidWJibGUiICk7CgoJCW9iai5vbiggImFmdGVyUmVmcmVzaCIsIGZ1bmN0aW9uICggYXJnICkgewoJCQllbGVtZW50LmRpc3BhdGNoKCBhcmcsICJhZnRlclJlZnJlc2giICk7CgkJfSwgImJ1YmJsZSIgKTsKCgkJb2JqLm9uKCAiY2xpY2siLCBmdW5jdGlvbiAoIGUgKSB7CgkJCWlmICggZWxlbWVudC5oYXNDbGFzcyggZS5jdXJyZW50VGFyZ2V0LCAiaGVhZGVyIiApICkgewoJCQkJb2JqLnNvcnQoIGUgKTsKCQkJfQoJCX0sICJoZWFkZXIiICk7CgoJCW9iai5saXN0Lm9uKCAiY2hhbmdlIiwgZnVuY3Rpb24gKCkgewoJCQlvYmouZGlzcGF0Y2guYXBwbHkoIG9iaiwgWyJjaGFuZ2UiXS5jb25jYXQoIGFycmF5LmNhc3QoIGFyZ3VtZW50cyApICkgKTsKCQl9LCAiY2hhbmdlIiApOwoKCQlvYmoubGlzdC5vbiggImJlZm9yZUZpbHRlciIsIGZ1bmN0aW9uICgpIHsKCQkJb2JqLmRpc3BhdGNoLmFwcGx5KCBvYmosIFsiYmVmb3JlRmlsdGVyIl0uY29uY2F0KCBhcnJheS5jYXN0KCBhcmd1bWVudHMgKSApICk7CgkJfSwgImJlZm9yZUZpbHRlciIgKTsKCgkJb2JqLmxpc3Qub24oICJhZnRlckZpbHRlciIsIGZ1bmN0aW9uICgpIHsKCQkJb2JqLmRpc3BhdGNoLmFwcGx5KCBvYmosIFsiYWZ0ZXJGaWx0ZXIiXS5jb25jYXQoIGFycmF5LmNhc3QoIGFyZ3VtZW50cyApICkgKTsKCQl9LCAiYWZ0ZXJGaWx0ZXIiICk7CgoJCXJldHVybiBvYmo7Cgl9Cn07CgovKioKICogQ3JlYXRlcyBhIG5ldyBEYXRhR3JpZAogKgogKiBAY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaQogKiBAZXh0ZW5kcyB7a2VpZ2FpLkJhc2V9CiAqIEBwYXJhbSAge09iamVjdH0gIHRhcmdldCAgIEVsZW1lbnQgdG8gcmVjZWl2ZSBEYXRhR3JpZAogKiBAcGFyYW0gIHtPYmplY3R9ICBzdG9yZSAgICBEYXRhU3RvcmUKICogQHBhcmFtICB7QXJyYXl9ICAgZmllbGRzICAgQXJyYXkgb2YgZmllbGRzIHRvIGRpc3BsYXkKICogQHBhcmFtICB7QXJyYXl9ICAgc29ydGFibGUgW09wdGlvbmFsXSBBcnJheSBvZiBzb3J0YWJsZSBjb2x1bW5zL2ZpZWxkcwogKiBAcGFyYW0gIHtPYmplY3R9ICBvcHRpb25zICBbT3B0aW9uYWxdIERhdGFMaXN0IG9wdGlvbnMKICogQHBhcmFtICB7Qm9vbGVhbn0gZmlsdGVyZWQgW09wdGlvbmFsXSBDcmVhdGUgYW4gaW5wdXQgdG8gZmlsdGVyIHRoZSBEYXRhR3JpZAogKiBAZXhhbXBsZQogKiB2YXIgZmllbGRzICA9IFsibmFtZSIsICJhZ2UiXSwKICogICAgIG9wdGlvbnMgPSB7cGFnZVNpemU6IDUsIG9yZGVyOiAiYWdlIGRlc2MsIG5hbWUifSwKICogICAgIHN0b3JlICAgPSBrZWlnYWkuc3RvcmUoIFsuLi5dICksCiAqICAgICBncmlkICAgID0ga2VpZ2FpLmdyaWQoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjZ3JpZCIgKSwgc3RvcmUsIGZpZWxkcywgZmllbGRzLCBvcHRpb25zLCB0cnVlICk7CiAqLwpmdW5jdGlvbiBEYXRhR3JpZCAoIHRhcmdldCwgc3RvcmUsIGZpZWxkcywgc29ydGFibGUsIG9wdGlvbnMsIGZpbHRlcmVkICkgewoJdmFyIHNvcnRPcmRlcjsKCglpZiAoIG9wdGlvbnMub3JkZXIgJiYgIXN0cmluZy5pc0VtcHR5KCBvcHRpb25zLm9yZGVyICkgKSB7CgkJc29ydE9yZGVyID0gc3RyaW5nLmV4cGxvZGUoIG9wdGlvbnMub3JkZXIgKS5tYXAoIGZ1bmN0aW9uICggaSApIHsKCQkJcmV0dXJuIGkucmVwbGFjZSggcmVnZXguYWZ0ZXJfc3BhY2UsICIiICk7CgkJfSApOwoJfQoKCXRoaXMuZWxlbWVudCAgID0gZWxlbWVudC5jcmVhdGUoICJzZWN0aW9uIiwgeyJjbGFzcyI6ICJncmlkIn0sIHRhcmdldCApOwoJdGhpcy5maWVsZHMgICAgPSBmaWVsZHM7Cgl0aGlzLmZpbHRlciAgICA9IG51bGw7Cgl0aGlzLmZpbHRlcmVkICA9IGZpbHRlcmVkID09PSB0cnVlOwoJdGhpcy5saXN0ICAgICAgPSBudWxsOwoJdGhpcy5vYnNlcnZlciAgPSBvYnNlcnZhYmxlLmZhY3RvcnkoKTsKCXRoaXMub3B0aW9ucyAgID0gb3B0aW9ucyAgIHx8IHt9OwoJdGhpcy5zdG9yZSAgICAgPSBzdG9yZTsKCXRoaXMuc29ydGFibGUgID0gc29ydGFibGUgIHx8IFtdOwoJdGhpcy5zb3J0T3JkZXIgPSBzb3J0T3JkZXIgfHwgc29ydGFibGUgfHwgW107Cn0KCi8qKgogKiBFeHRlbmRpbmcgQmFzZQogKgogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFHcmlkCiAqIEB0eXBlIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICovCkRhdGFHcmlkLnByb3RvdHlwZSA9IGJhc2UuZmFjdG9yeSgpOwoKLyoqCiAqIFNldHRpbmcgY29uc3RydWN0b3IgbG9vcAogKgogKiBAbWV0aG9kIGNvbnN0cnVjdG9yCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUdyaWQKICogQHR5cGUge0Z1bmN0aW9ufQogKiBAcHJpdmF0ZQogKi8KRGF0YUdyaWQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRGF0YUdyaWQ7CgovKioKICogQWRkcyBhbiBpdGVtIHRvIHRoZSBEYXRhR3JpZAogKgogKiBAbWV0aG9kIGFkZAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFHcmlkCiAqIEBwYXJhbSB7T2JqZWN0fSByZWNvcmQgTmV3IERhdGFTdG9yZSByZWNvcmQgKHNoYXBlcyBzaG91bGQgbWF0Y2gpCiAqIEByZXR1cm4ge09iamVjdH0gICAgICAge0BsaW5rIGtlaWdhaS5EYXRhR3JpZH0KICogQGV4YW1wbGUKICogZ3JpZC5hZGQoIHtuYW1lOiAiSm9obiBEb2UiLCBhZ2U6IDM0fSApOwogKi8KRGF0YUdyaWQucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uICggcmVjb3JkICkgewoJdmFyIHNlbGYgPSB0aGlzOwoKCXRoaXMuc3RvcmUuc2V0KCBudWxsLCByZWNvcmQgKS50aGVuKCBudWxsLCBmdW5jdGlvbiAoIGUgKSB7CgkJdXRpbGl0eS5lcnJvciggZSApOwoJCXNlbGYuZGlzcGF0Y2goICJlcnJvciIsIGUgKTsKCX0gKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBFeHBvcnRzIGRhdGEgZ3JpZCByZWNvcmRzCiAqCiAqIEBtZXRob2QgZHVtcAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFHcmlkCiAqIEByZXR1cm4ge0FycmF5fSBSZWNvcmQgc2V0CiAqIEBleGFtcGxlCiAqIHZhciBkYXRhID0gZ3JpZC5kdW1wKCk7CiAqLwpEYXRhR3JpZC5wcm90b3R5cGUuZHVtcCA9IGZ1bmN0aW9uICgpIHsKCXJldHVybiB0aGlzLnN0b3JlLmR1bXAoIHRoaXMubGlzdC5yZWNvcmRzLCB0aGlzLmZpZWxkcyApOwp9OwoKLyoqCiAqIFJlZnJlc2hlcyB0aGUgRGF0YUdyaWQKICoKICogQG1ldGhvZCByZWZyZXNoCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUdyaWQKICogQGZpcmVzIGtlaWdhaS5EYXRhR3JpZCNiZWZvcmVSZWZyZXNoIEZpcmVzIGJlZm9yZSByZWZyZXNoCiAqIEBmaXJlcyBrZWlnYWkuRGF0YUdyaWQjYWZ0ZXJSZWZyZXNoIEZpcmVzIGFmdGVyIHJlZnJlc2gKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRhdGFHcmlkfQogKiBAZXhhbXBsZQogKiBncmlkLnJlZnJlc2goKTsKICovCkRhdGFHcmlkLnByb3RvdHlwZS5yZWZyZXNoID0gZnVuY3Rpb24gKCkgewoJdmFyIHNvcnQgPSBbXSwKCSAgICBzZWxmID0gdGhpczsKCgl0aGlzLmRpc3BhdGNoKCAiYmVmb3JlUmVmcmVzaCIsIHRoaXMuZWxlbWVudCApOwoKCWlmICggdGhpcy5zb3J0T3JkZXIubGVuZ3RoID4gMCApIHsKCQlhcnJheS5lYWNoKCB0aGlzLnNvcnRPcmRlciwgZnVuY3Rpb24gKCBpICkgewoJCQl2YXIgb2JqID0gZWxlbWVudC5maW5kKCBzZWxmLmVsZW1lbnQsICIuaGVhZGVyIHNwYW5bZGF0YS1maWVsZD0nIiArIGkgKyAiJ10iIClbMF07CgoJCQlzb3J0LnB1c2goIHN0cmluZy50cmltKCBpICsgIiAiICsgKCBlbGVtZW50LmRhdGEoIG9iaiwgInNvcnQiICkgfHwgIiIgKSApICk7CgkJfSApOwoKCQl0aGlzLm9wdGlvbnMub3JkZXIgPSB0aGlzLmxpc3Qub3JkZXIgPSBzb3J0LmpvaW4oICIsICIgKTsKCX0KCgl0aGlzLmxpc3Qud2hlcmUgPSBudWxsOwoJdXRpbGl0eS5tZXJnZSggdGhpcy5saXN0LCB0aGlzLm9wdGlvbnMgKTsKCXRoaXMubGlzdC5yZWZyZXNoKCk7CgoJdGhpcy5kaXNwYXRjaCggImFmdGVyUmVmcmVzaCIsIHRoaXMuZWxlbWVudCApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIFJlbW92ZXMgYW4gaXRlbSBmcm9tIHRoZSBEYXRhR3JpZAogKgogKiBAbWV0aG9kIHJlbW92ZQogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFHcmlkCiAqIEBwYXJhbSB7TWl4ZWR9IHJlY29yZCBSZWNvcmQsIGtleSBvciBpbmRleAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUdyaWR9CiAqIEBleGFtcGxlCiAqIGdyaWQucmVtb3ZlKCAia2V5IiApOwogKi8KRGF0YUdyaWQucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uICggcmVjb3JkICkgewoJdmFyIHNlbGYgPSB0aGlzOwoKCXRoaXMuc3RvcmUuZGVsKCByZWNvcmQgKS50aGVuKCBudWxsLCBmdW5jdGlvbiAoIGUgKSB7CgkJdXRpbGl0eS5lcnJvciggZSApOwoJCXNlbGYuZGlzcGF0Y2goICJlcnJvciIsIGUgKTsKCX0gKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBTb3J0cyB0aGUgRGF0YUdyaWQgd2hlbiBhIGNvbHVtbiBoZWFkZXIgaXMgY2xpY2tlZAogKgogKiBAbWV0aG9kIHNvcnQKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhR3JpZAogKiBAcGFyYW0gIHtPYmplY3R9IGV2IEV2ZW50CiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhR3JpZH0KICovCkRhdGFHcmlkLnByb3RvdHlwZS5zb3J0ID0gZnVuY3Rpb24gKCBldiApIHsKCXZhciB0YXJnZXQgPSB1dGlsaXR5LnRhcmdldCggZXYgKSwKCSAgICBmaWVsZDsKCgkvLyBTdG9wcGluZyBldmVudCBwcm9wb2dhdGlvbgoJdXRpbGl0eS5zdG9wKCBldiApOwoKCS8vIFJlZnJlc2hpbmcgbGlzdCBpZiB0YXJnZXQgaXMgc29ydGFibGUKCWlmICggZWxlbWVudC5oYXNDbGFzcyggdGFyZ2V0LCAic29ydGFibGUiICkgKSB7CgkJZmllbGQgPSBlbGVtZW50LmRhdGEoIHRhcmdldCwgImZpZWxkIiApOwoJCWVsZW1lbnQuZGF0YSggdGFyZ2V0LCAic29ydCIsIGVsZW1lbnQuZGF0YSggdGFyZ2V0LCAic29ydCIgKSA9PT0gImFzYyIgPyAiZGVzYyIgOiAiYXNjIiApOwoJCWFycmF5LnJlbW92ZSggdGhpcy5zb3J0T3JkZXIsIGZpZWxkICk7CgkJdGhpcy5zb3J0T3JkZXIuc3BsaWNlKCAwLCAwLCBmaWVsZCApOwoJCXRoaXMucmVmcmVzaCgpOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIFRlYXJzIGRvd24gdGhlIERhdGFHcmlkCiAqCiAqIEBtZXRob2QgdGVhcmRvd24KICogQG1lbWJlck9mIGtlaWdhaS5EYXRhR3JpZAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUdyaWR9CiAqIEBleGFtcGxlCiAqIGdyaWQudGVhcmRvd24oKTsKICovCkRhdGFHcmlkLnByb3RvdHlwZS50ZWFyZG93biA9IGZ1bmN0aW9uICgpIHsKCWlmICggdGhpcy5maWx0ZXIgIT09IG51bGwgKSB7CgkJdGhpcy5maWx0ZXIudGVhcmRvd24oKTsKCQl0aGlzLmZpbHRlciA9IG51bGw7Cgl9CgoJdGhpcy5saXN0LnRlYXJkb3duKCk7Cgl0aGlzLm9ic2VydmVyLnVuaG9vayggZWxlbWVudC5maW5kKCB0aGlzLmVsZW1lbnQsICIuaGVhZGVyIiApWzBdLCAiY2xpY2siICk7CgllbGVtZW50LmRlc3Ryb3koIHRoaXMuZWxlbWVudCApOwoJdGhpcy5lbGVtZW50ID0gbnVsbDsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBVcGRhdGVzIGFuIGl0ZW0gaW4gdGhlIERhdGFHcmlkCiAqCiAqIEBtZXRob2QgdXBkYXRlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUdyaWQKICogQHBhcmFtIHtNaXhlZH0gIGtleSAgS2V5IG9yIGluZGV4CiAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIE5ldyBwcm9wZXJ0eSB2YWx1ZXMKICogQHJldHVybiB7T2JqZWN0fSAgICAge0BsaW5rIGtlaWdhaS5EYXRhR3JpZH0KICogQGV4YW1wbGUKICogZ3JpZC51cGRhdGUoICJrZXkiLCB7bmFtZTogIkppbSBTbWl0aCJ9ICk7CiAqLwpEYXRhR3JpZC5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKCBrZXksIGRhdGEgKSB7Cgl2YXIgc2VsZiA9IHRoaXM7CgoJdGhpcy5zdG9yZS51cGRhdGUoIGtleSwgZGF0YSApLnRoZW4oIG51bGwsIGZ1bmN0aW9uICggZSApIHsKCQl1dGlsaXR5LmVycm9yKCBlICk7CgkJc2VsZi5kaXNwYXRjaCggImVycm9yIiwgZSApOwoJfSApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEBuYW1lc3BhY2UgbGlzdAogKi8KdmFyIGxpc3QgPSB7CgkvKioKCSAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgRGF0YUxpc3QKCSAqCgkgKiBAbWV0aG9kIGZhY3RvcnkKCSAqIEBtZW1iZXJPZiBsaXN0CgkgKiBAZmlyZXMga2VpZ2FpLkRhdGFMaXN0I2NoYW5nZSBGaXJlcyB3aGVuIHRoZSBET00gY2hhbmdlcwoJICogQHBhcmFtICB7T2JqZWN0fSB0YXJnZXQgICBFbGVtZW50IHRvIHJlY2VpdmUgdGhlIERhdGFMaXN0CgkgKiBAcGFyYW0gIHtPYmplY3R9IHN0b3JlICAgIHtAbGluayBrZWlnYWkuRGF0YVN0b3JlfQoJICogQHBhcmFtICB7TWl4ZWR9ICB0ZW1wbGF0ZSBSZWNvcmQgZmllbGQsIHRlbXBsYXRlICggJC50cGwgKSwgb3IgU3RyaW5nLCBlLmcuICI8cD50aGlzIGlzIGEge3tmaWVsZH19IHNhbXBsZS48L3A+IiwgZmllbGRzIGFyZSBtYXJrZWQgd2l0aCB7eyB9fQoJICogQHBhcmFtICB7T2JqZWN0fSBvcHRpb25zICBPcHRpb25hbCBwYXJhbWV0ZXJzIHRvIHNldCBvbiB0aGUgRGF0YUxpc3QKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhTGlzdH0KCSAqIEBleGFtcGxlCgkgKiB2YXIgc3RvcmUgPSBrZWlnYWkuc3RvcmUoIFsuLi5dICksCgkgKiAgICAgbGlzdCAgPSBrZWlnYWkubGlzdCggZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI2xpc3QiKSwgc3RvcmUsICJ7e25hbWV9fSIsIHtvcmRlcjogIm5hbWUifSApOwoJICovCglmYWN0b3J5IDogZnVuY3Rpb24gKCB0YXJnZXQsIHN0b3JlLCB0ZW1wbGF0ZSwgb3B0aW9ucyApIHsKCQl2YXIgcmVmID0gW3N0b3JlXSwKCQkgICAgb2JqOwoKCQlpZiAoICEoIHRhcmdldCBpbnN0YW5jZW9mIEVsZW1lbnQgKSB8fCB0eXBlb2Ygc3RvcmUgIT0gIm9iamVjdCIgfHwgIXJlZ2V4LnN0cmluZ19vYmplY3QudGVzdCggdHlwZW9mIHRlbXBsYXRlICkgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApOwoJCX0KCgkJLy8gQ3JlYXRpbmcgaW5zdGFuY2UKCQlvYmogPSBuZXcgRGF0YUxpc3QoIGVsZW1lbnQuY3JlYXRlKCAidWwiLCB7ImNsYXNzIjogImxpc3QifSwgdGFyZ2V0ICksIHJlZlswXSwgdGVtcGxhdGUgKTsKCgkJaWYgKCBvcHRpb25zIGluc3RhbmNlb2YgT2JqZWN0ICkgewoJCQlpZiAoIG9wdGlvbnMubGlzdEZpbHRlcmVkICYmIG9wdGlvbnMubGlzdEZpbHRlciApIHsKCQkJCW9iai5saXN0RmlsdGVyID0gZmlsdGVyLmZhY3RvcnkoIGVsZW1lbnQuY3JlYXRlKCAiaW5wdXQiLCB7ImlkIjogb2JqLmVsZW1lbnQuaWQgKyAiLWZpbHRlciIsICJjbGFzcyI6ICJmaWx0ZXIiLCBwbGFjZWhvbGRlcjogIkZpbHRlciJ9LCB0YXJnZXQsICJmaXJzdCIgKSwgb2JqLCBvcHRpb25zLmxpc3RGaWx0ZXIsIG9wdGlvbnMuZGVib3VuY2UgfHwgMjUwICk7CgkJCQlkZWxldGUgb3B0aW9ucy5saXN0RmlsdGVyOwoJCQkJZGVsZXRlIG9wdGlvbnMubGlzdEZpbHRlcmVkOwoJCQl9CgoJCQl1dGlsaXR5Lm1lcmdlKCBvYmosIG9wdGlvbnMgKTsKCQl9CgoJCW9iai5zdG9yZS5saXN0cy5wdXNoKCBvYmogKTsKCgkJLy8gU2V0dGluZyB1cCBhIGNoYWluIG9mIEV2ZW50cwoJCW9iai5vbiggImJlZm9yZVJlZnJlc2giLCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJZWxlbWVudC5kaXNwYXRjaCggYXJnLCAiYmVmb3JlUmVmcmVzaCIgKTsKCQl9LCAiYnViYmxlIiApOwoKCQlvYmoub24oICJhZnRlclJlZnJlc2giLCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJZWxlbWVudC5kaXNwYXRjaCggYXJnLCAiYWZ0ZXJSZWZyZXNoIiApOwoJCX0sICJidWJibGUiICk7CgoJCW9iai5vbiggImNoYW5nZSIsIGZ1bmN0aW9uICggYXJnICkgewoJCQllbGVtZW50LmRpc3BhdGNoKCBvYmouZWxlbWVudCwgImNoYW5nZSIsIGFyZyApOwoJCX0sICJjaGFuZ2UiICk7CgoJCW9iai5vbiggImNsaWNrIiwgZnVuY3Rpb24gKCBlICkgewoJCQl2YXIgdGFyZ2V0ID0gdXRpbGl0eS50YXJnZXQoIGUgKSwKCQkJICAgIHBhZ2U7CgoJCQl1dGlsaXR5LnN0b3AoIGUgKTsKCgkJCWlmICggdGFyZ2V0Lm5vZGVOYW1lID09PSAiQSIgKSB7CgkJCQlwYWdlID0gZWxlbWVudC5kYXRhKCB0YXJnZXQsICJwYWdlIiApOwoKCQkJCWlmICggIWlzTmFOKCBwYWdlICkgKSB7CgkJCQkJb2JqLnBhZ2UoIHBhZ2UgKTsKCQkJCX0KCQkJfQoJCX0sICJwYWdpbmF0aW9uIiApOwoKCQlpZiAoIHR5cGVvZiBNdXRhdGlvbk9ic2VydmVyID09ICJmdW5jdGlvbiIgKSB7CgkJCW9iai5tdXRhdGlvbiA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCW9iai5kaXNwYXRjaCggImNoYW5nZSIsIGFyZyApOwoJCQl9ICk7CgoJCQlvYmoubXV0YXRpb24ub2JzZXJ2ZSggb2JqLmVsZW1lbnQsIHtjaGlsZExpc3Q6IHRydWUsIHN1YnRyZWU6IHRydWV9ICk7CgkJfQoKCQkvLyBSZW5kZXJpbmcgaWYgbm90IHRpZWQgdG8gYW4gQVBJIG9yIGRhdGEgaXMgcmVhZHkKCQlpZiAoIG9iai5zdG9yZS51cmkgPT09IG51bGwgfHwgb2JqLnN0b3JlLmxvYWRlZCApIHsKCQkJb2JqLnJlZnJlc2goKTsKCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogQ2FsY3VsYXRlcyB0aGUgdG90YWwgcGFnZXMKCSAqCgkgKiBAbWV0aG9kIHBhZ2VzCgkgKiBAbWVtYmVyT2YgbGlzdAoJICogQHJldHVybiB7TnVtYmVyfSBUb3RhbCBwYWdlcwoJICogQHByaXZhdGUKCSAqLwoJcGFnZXMgOiBmdW5jdGlvbiAoKSB7CgkJaWYgKCBpc05hTiggdGhpcy5wYWdlU2l6ZSApICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCQl9CgoJCXJldHVybiBNYXRoLmNlaWwoICggIXRoaXMuZmlsdGVyID8gdGhpcy50b3RhbCA6IHRoaXMuZmlsdGVyZWQubGVuZ3RoICkgLyB0aGlzLnBhZ2VTaXplICk7Cgl9LAoKCS8qKgoJICogQ2FsY3VsYXRlcyB0aGUgcGFnZSBzaXplIGFzIGFuIEFycmF5IG9mIHN0YXJ0ICYgZmluaXNoCgkgKgoJICogQG1ldGhvZCByYW5nZQoJICogQG1lbWJlck9mIGxpc3QKCSAqIEByZXR1cm4ge0FycmF5fSAgQXJyYXkgb2Ygc3RhcnQgJiBlbmQgbnVtYmVycwoJICogQHByaXZhdGUKCSAqLwoJcmFuZ2UgOiBmdW5jdGlvbiAoKSB7CgkJdmFyIHN0YXJ0ID0gKCB0aGlzLnBhZ2VJbmRleCAqIHRoaXMucGFnZVNpemUgKSAtIHRoaXMucGFnZVNpemUsCgkJICAgIGVuZCAgID0gdGhpcy5wYWdlU2l6ZTsKCgkJcmV0dXJuIFtzdGFydCwgZW5kXTsKCX0KfTsKCi8qKgogKiBDcmVhdGVzIGEgbmV3IERhdGFMaXN0CiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpCiAqIEBleHRlbmRzIHtrZWlnYWkuQmFzZX0KICogQGV4YW1wbGUKICogdmFyIHN0b3JlID0ga2VpZ2FpLnN0b3JlKCBbLi4uXSApLAogKiAgICAgbGlzdCAgPSBrZWlnYWkubGlzdCggZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI2xpc3QiKSwgc3RvcmUsICJ7e25hbWV9fSIsIHtvcmRlcjogIm5hbWUifSApOwogKi8KZnVuY3Rpb24gRGF0YUxpc3QgKCBlbGVtZW50LCBzdG9yZSwgdGVtcGxhdGUgKSB7Cgl0aGlzLmNhbGxiYWNrICAgID0gbnVsbDsKCXRoaXMuY3VycmVudCAgICAgPSBbXTsKCXRoaXMuZWxlbWVudCAgICAgPSBlbGVtZW50OwoJdGhpcy5lbXB0eU1zZyAgICA9IGxhYmVsLm5vRGF0YTsKCXRoaXMuZmlsdGVyICAgICAgPSBudWxsOwoJdGhpcy5maWx0ZXJlZCAgICA9IFtdOwoJdGhpcy5pZCAgICAgICAgICA9IHV0aWxpdHkuZ2VuSWQoKTsKCXRoaXMuaXRlbXMgICAgICAgPSBbXTsKCXRoaXMubGlzdEZpbHRlciAgPSBudWxsOwoJdGhpcy5tdXRhdGlvbiAgICA9IG51bGw7Cgl0aGlzLm9ic2VydmVyICAgID0gb2JzZXJ2YWJsZS5mYWN0b3J5KCk7Cgl0aGlzLnBhZ2VJbmRleCAgID0gMTsKCXRoaXMucGFnZVNpemUgICAgPSBudWxsOwoJdGhpcy5wYWdlUmFuZ2UgICA9IDU7Cgl0aGlzLnBhZ2luYXRpb24gID0gImJvdHRvbSI7IC8vICJ0b3AiIG9yICJib3R0b218dG9wIiBhcmUgYWxzbyB2YWxpZAoJdGhpcy5wbGFjZWhvbGRlciA9ICIiOwoJdGhpcy5vcmRlciAgICAgICA9ICIiOwoJdGhpcy5yZWNvcmRzICAgICA9IFtdOwoJdGhpcy50ZW1wbGF0ZSAgICA9IHRlbXBsYXRlOwoJdGhpcy50b3RhbCAgICAgICA9IDA7Cgl0aGlzLnN0b3JlICAgICAgID0gc3RvcmU7Cgl0aGlzLndoZXJlICAgICAgID0gbnVsbDsKfQoKLyoqCiAqIEV4dGVuZGluZyBCYXNlCiAqCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3QKICogQHR5cGUge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKi8KRGF0YUxpc3QucHJvdG90eXBlID0gYmFzZS5mYWN0b3J5KCk7CgovKioKICogU2V0dGluZyBjb25zdHJ1Y3RvciBsb29wCiAqCiAqIEBtZXRob2QgY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhTGlzdAogKiBAdHlwZSB7RnVuY3Rpb259CiAqIEBwcml2YXRlCiAqLwpEYXRhTGlzdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEYXRhTGlzdDsKCi8qKgogKiBBZGRzIGFuIGl0ZW0gdG8gdGhlIERhdGFMaXN0CiAqCiAqIEBtZXRob2QgYWRkCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3QKICogQHBhcmFtIHtPYmplY3R9IHJlY29yZCBOZXcgRGF0YVN0b3JlIHJlY29yZCAoc2hhcGVzIHNob3VsZCBtYXRjaCkKICogQHJldHVybiB7T2JqZWN0fSAgICAgICB7QGxpbmsga2VpZ2FpLkRhdGFMaXN0fQogKiBAZXhhbXBsZQogKiBsaXN0LmFkZCgge25hbWU6ICJKb2huIERvZSIsIGFnZTogMzR9ICk7CiAqLwpEYXRhTGlzdC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKCByZWNvcmQgKSB7Cgl2YXIgc2VsZiA9IHRoaXM7CgoJdGhpcy5zdG9yZS5zZXQoIG51bGwsIHJlY29yZCApLnRoZW4oIG51bGwsIGZ1bmN0aW9uICggZSApIHsKCQl1dGlsaXR5LmVycm9yKCBlICk7CgkJc2VsZi5kaXNwYXRjaCggImVycm9yIiwgZSApOwoJfSApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEV4cG9ydHMgZGF0YSBsaXN0IHJlY29yZHMKICoKICogQG1ldGhvZCBkdW1wCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3QKICogQHJldHVybiB7QXJyYXl9IFJlY29yZCBzZXQKICogQGV4YW1wbGUKICogdmFyIGRhdGEgPSBsaXN0LmR1bXAoKTsKICovCkRhdGFMaXN0LnByb3RvdHlwZS5kdW1wID0gZnVuY3Rpb24gKCkgewoJcmV0dXJuIHRoaXMuc3RvcmUuZHVtcCggdGhpcy5yZWNvcmRzICk7Cn07CgovKioKICogQ2hhbmdlcyB0aGUgcGFnZSBpbmRleCBvZiB0aGUgRGF0YUxpc3QKICoKICogQG1ldGhvZCBwYWdlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3QKICogQHBhcmFtICB7TnVtYmVyfSBuIFBhZ2UgdG8gdmlldwogKiBAcmV0dXJuIHtPYmplY3R9ICAge0BsaW5rIGtlaWdhaS5EYXRhTGlzdH0KICogQGV4YW1wbGUKICogbGlzdC5wYWdlKCAyICk7CiAqLwpEYXRhTGlzdC5wcm90b3R5cGUucGFnZSA9IGZ1bmN0aW9uICggbiApIHsKCXRoaXMucGFnZUluZGV4ID0gbjsKCglyZXR1cm4gdGhpcy5yZWZyZXNoKCk7Cn07CgovKioKICogQWRkcyBwYWdpbmF0aW9uIEVsZW1lbnRzIHRvIHRoZSBWaWV3LCBleGVjdXRlZCBmcm9tIGBEYXRhTGlzdC5yZWZyZXNoKClgCiAqCiAqIEBtZXRob2QgcGFnZXMKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhTGlzdAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUxpc3R9CiAqIEBleGFtcGxlCiAqIGxpc3QucGFnZXMoKTsKICovCkRhdGFMaXN0LnByb3RvdHlwZS5wYWdlcyA9IGZ1bmN0aW9uICgpIHsKCXZhciBzZWxmICA9IHRoaXMsCgkgICAgb2JqICAgPSB0aGlzLmVsZW1lbnQsCgkgICAgcGFnZSAgPSB0aGlzLnBhZ2VJbmRleCwKCSAgICBwb3MgICA9IHRoaXMucGFnaW5hdGlvbiwKCSAgICByYW5nZSA9IHRoaXMucGFnZVJhbmdlLAoJICAgIG1pZCAgID0gTWF0aC5mbG9vciggcmFuZ2UgLyAyICksCgkgICAgc3RhcnQgPSBwYWdlIC0gbWlkLAoJICAgIGVuZCAgID0gcGFnZSArIG1pZCwKCSAgICB0b3RhbCA9IGxpc3QucGFnZXMuY2FsbCggdGhpcyApLAoJICAgIGRpZmY7CgoJaWYgKCAhcmVnZXgudG9wX2JvdHRvbS50ZXN0KCBwb3MgKSApIHsKCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCX0KCgkvLyBSZW1vdmluZyB0aGUgZXhpc3RpbmcgY29udHJvbHMKCWFycmF5LmVhY2goIHV0aWxpdHkuZG9tKCAiIyIgKyBvYmouaWQgKyAiLXBhZ2VzLXRvcCwgIyIgKyBvYmouaWQgKyAiLXBhZ2VzLWJvdHRvbSIgKSwgZnVuY3Rpb24gKCBpICkgewoJCWlmICggaSApIHsKCQkJc2VsZi5vYnNlcnZlci51bmhvb2soIGksICJjbGljayIgKTsKCQkJZWxlbWVudC5kZXN0cm95KCBpICk7CgkJfQoJfSApOwoJCgkvLyBIYWx0aW5nIGJlY2F1c2UgdGhlcmUncyAxIHBhZ2UsIG9yIG5vdGhpbmcKCWlmICggKCB0aGlzLmZpbHRlciAmJiB0aGlzLmZpbHRlcmVkLmxlbmd0aCA9PT0gMCApIHx8IHRoaXMudG90YWwgPT09IDAgfHwgdG90YWwgPT09IDEgKSB7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLy8gR2V0dGluZyB0aGUgcmFuZ2UgdG8gZGlzcGxheQoJaWYgKCBzdGFydCA8IDEgKSB7CgkJZGlmZiAgPSBudW1iZXIuZGlmZiggc3RhcnQsIDEgKTsKCQlzdGFydCA9IHN0YXJ0ICsgZGlmZjsKCQllbmQgICA9IGVuZCAgICsgZGlmZjsKCX0KCglpZiAoIGVuZCA+IHRvdGFsICkgewoJCWVuZCAgID0gdG90YWw7CgkJc3RhcnQgPSAoIGVuZCAtIHJhbmdlICkgKyAxOwoKCQlpZiAoIHN0YXJ0IDwgMSApIHsKCQkJc3RhcnQgPSAxOwoJCX0KCX0KCglpZiAoIG51bWJlci5kaWZmKCBzdGFydCwgZW5kICkgPj0gcmFuZ2UgKSB7CgkJLS1lbmQ7Cgl9CgoJYXJyYXkuZWFjaCggc3RyaW5nLmV4cGxvZGUoIHBvcyApLCBmdW5jdGlvbiAoIGkgKSB7CgkJdmFyIGN1cnJlbnQgPSBmYWxzZSwKCQkgICAgbW9yZSAgICA9IHBhZ2UgPiAxLAoJCSAgICBuZXh0ICAgID0gKCBwYWdlICsgMSApIDw9IHRvdGFsLAoJCSAgICBsYXN0ICAgID0gKCBwYWdlID49IHRvdGFsICksCgkJICAgIGVsLCBuOwoKCQkvLyBTZXR0aW5nIHVwIHRoZSBsaXN0CgkJZWwgPSBlbGVtZW50LmNyZWF0ZSggInVsIiwgeyJjbGFzcyI6ICJsaXN0IHBhZ2VzIGhpZGRlbiAiICsgaSwgaWQ6IG9iai5pZCArICItcGFnZXMtIiArIGl9LCBvYmosIGkgPT09ICJib3R0b20iID8gImFmdGVyIiA6ICJiZWZvcmUiICk7CgoJCS8vIEZpcnN0IHBhZ2UKCQllbGVtZW50LmNyZWF0ZSggbW9yZSA/ICJhIiA6ICJzcGFuIiwgeyJjbGFzcyI6ICJmaXJzdCBwYWdlIiwgImRhdGEtcGFnZSI6IDEsIGlubmVySFRNTDogIiZsdDsmbHQ7In0sIGVsZW1lbnQuY3JlYXRlKCAibGkiLCB7fSwgZWwgKSApOwoKCQkvLyBQcmV2aW91cyBwYWdlCgkJZWxlbWVudC5jcmVhdGUoIG1vcmUgPyAiYSIgOiAic3BhbiIsIHsiY2xhc3MiOiAicHJldiBwYWdlIiwgImRhdGEtcGFnZSI6ICggcGFnZSAtIDEgKSwgaW5uZXJIVE1MOiAiJmx0OyJ9LCBlbGVtZW50LmNyZWF0ZSggImxpIiwge30sIGVsICkgKTsKCgkJLy8gUmVuZGVyaW5nIHRoZSBwYWdlIHJhbmdlCgkJZm9yICggbiA9IHN0YXJ0OyBuIDw9IGVuZDsgbisrICkgewoJCQljdXJyZW50ID0gKCBuID09PSBwYWdlICk7CgkJCWVsZW1lbnQuY3JlYXRlKCBjdXJyZW50ID8gInNwYW4iIDogImEiLCB7ImNsYXNzIjogY3VycmVudCA/ICJjdXJyZW50IHBhZ2UiIDogInBhZ2UiLCAiZGF0YS1wYWdlIjogbiwgaW5uZXJIVE1MOiBufSwgZWxlbWVudC5jcmVhdGUoICJsaSIsIHt9LCBlbCApICk7CgkJfQoKCQkvLyBOZXh0IHBhZ2UKCQllbGVtZW50LmNyZWF0ZSggbmV4dCA/ICJhIiA6ICJzcGFuIiwgeyJjbGFzcyI6ICJuZXh0IHBhZ2UiLCAiZGF0YS1wYWdlIjogbmV4dCA/ICggcGFnZSArIDEgKSA6IG51bGwsIGlubmVySFRNTDogIiZndDsifSwgZWxlbWVudC5jcmVhdGUoICJsaSIsIHt9LCBlbCApICk7CgoJCS8vIExhc3QgcGFnZQoJCWVsZW1lbnQuY3JlYXRlKCBsYXN0ID8gInNwYW4iIDogImEiLCB7ImNsYXNzIjogImxhc3QgcGFnZSIsICJkYXRhLXBhZ2UiOiBsYXN0ID8gbnVsbCA6IHRvdGFsLCBpbm5lckhUTUw6ICImZ3Q7Jmd0OyJ9LCBlbGVtZW50LmNyZWF0ZSggImxpIiwge30sIGVsICkgKTsKCgkJLy8gQWRkaW5nIHRvIERPTQoJCWVsZW1lbnQua2xhc3MoIGVsLCAiaGlkZGVuIiwgZmFsc2UgKTsKCgkJLy8gUGFnaW5hdGlvbiBsaXN0ZW5lcgoJCXNlbGYub2JzZXJ2ZXIuaG9vayggZWwsICJjbGljayIgKTsKCX0gKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBSZWZyZXNoZXMgZWxlbWVudAogKgogKiBAbWV0aG9kIHJlZnJlc2gKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhTGlzdAogKiBAZXh0ZW5kcyB7a2VpZ2FpLkJhc2V9CiAqIEBmaXJlcyBrZWlnYWkuRGF0YUxpc3QjYmVmb3JlUmVmcmVzaCBGaXJlcyBiZWZvcmUgcmVmcmVzaAogKiBAZmlyZXMga2VpZ2FpLkRhdGFMaXN0I2FmdGVyUmVmcmVzaCBGaXJlcyBhZnRlciByZWZyZXNoCiAqIEBmaXJlcyBrZWlnYWkuRGF0YUxpc3QjZXJyb3IgRmlyZXMgb24gZXJyb3IKICogQHBhcmFtICB7Qm9vbGVhbn0gY3JlYXRlIFtPcHRpb25hbF0gUmVjcmVhdGVzIGNhY2hlZCBWaWV3IG9mIGRhdGEKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRhdGFMaXN0fQogKiBAZXhhbXBsZQogKiBsaXN0LnJlZnJlc2goKTsKICovCkRhdGFMaXN0LnByb3RvdHlwZS5yZWZyZXNoID0gZnVuY3Rpb24gKCBjcmVhdGUgKSB7Cgl2YXIgc2VsZiAgICAgPSB0aGlzLAoJICAgIGVsICAgICAgID0gdGhpcy5lbGVtZW50LAoJICAgIHRlbXBsYXRlID0gKCB0eXBlb2YgdGhpcy50ZW1wbGF0ZSA9PSAib2JqZWN0IiApLAoJICAgIGZpbHRlciAgID0gdGhpcy5maWx0ZXIgIT09IG51bGwsCgkgICAgaXRlbXMgICAgPSBbXSwKCSAgICBjYWxsYmFjayA9ICggdHlwZW9mIHRoaXMuY2FsbGJhY2sgPT0gImZ1bmN0aW9uIiApLAoJICAgIHJlZyAgICAgID0gbmV3IFJlZ0V4cCgpLAoJICAgIHJlZ2lzdHJ5ID0gW10sIC8vIGtlZXBzIHRyYWNrIG9mIHJlY29yZHMgaW4gdGhlIGxpc3QgKCBmb3IgZmlsdGVyaW5nICkKCSAgICByYW5nZSAgICA9IFtdLAoJICAgIGZuLCBjZWlsaW5nLCBuZXh0OwoKCWNyZWF0ZSA9IGNyZWF0ZSA9PT0gdHJ1ZTsKCgl0aGlzLmRpc3BhdGNoKCAiYmVmb3JlUmVmcmVzaCIsIGVsICk7CgoJLy8gRnVuY3Rpb24gdG8gY3JlYXRlIHRlbXBsYXRlcyBmb3IgdGhlIGh0bWwgcmVwCglpZiAoICF0ZW1wbGF0ZSApIHsKCQlmbiA9IGZ1bmN0aW9uICggaSApIHsKCQkJdmFyIGh0bWwgID0gc2VsZi50ZW1wbGF0ZSwKCQkJICAgIGl0ZW1zID0gYXJyYXkudW5pcXVlKCBodG1sLm1hdGNoKCAvXHtce1tcd1wuXC1cW1xdXStcfVx9L2cgKSApOwoKCQkJLy8gUmVwbGFjaW5nIHJlY29yZCBrZXkKCQkJaHRtbCA9IGh0bWwucmVwbGFjZSggInt7IiArIHNlbGYuc3RvcmUua2V5ICsgIn19IiwgaS5rZXkgKTsKCQkJCgkJCS8vIFJlcGxhY2luZyBkb3Qgbm90YXRpb24gcHJvcGVydGllcwoJCQlhcnJheS5lYWNoKCBpdGVtcywgZnVuY3Rpb24gKCBhdHRyICkgewoJCQkJdmFyIGtleSAgID0gYXR0ci5yZXBsYWNlKCAvXHtce3xcfVx9L2csICIiICksCgkJCQkgICAgdmFsdWUgPSB1dGlsaXR5LndhbGsoIGkuZGF0YSwga2V5ICk7CgoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXZhbHVlID0gIiI7CgkJCQl9CgoJCQkJcmVnLmNvbXBpbGUoIHN0cmluZy5lc2NhcGUoIGF0dHIgKSwgImciICk7CgkJCQlodG1sID0gaHRtbC5yZXBsYWNlKCByZWcsIHZhbHVlICk7CgkJCX0gKTsKCgkJCS8vIEZpbGxpbmcgaW4gcGxhY2Vob2xkZXIgdmFsdWUKCQkJaHRtbCA9IGh0bWwucmVwbGFjZSggL1x7XHsuKlx9XH0vZywgc2VsZi5wbGFjZWhvbGRlciApOwoKCQkJcmV0dXJuICI8bGkgZGF0YS1rZXk9XCIiICsgaS5rZXkgKyAiXCI+IiArIGh0bWwgKyAiPC9saT4iOwoJCX07Cgl9CgllbHNlIHsKCQlmbiA9IGZ1bmN0aW9uICggaSApIHsKCQkJdmFyIG9iaiAgID0ganNvbi5lbmNvZGUoIHNlbGYudGVtcGxhdGUgKSwKCQkJICAgIGl0ZW1zID0gYXJyYXkudW5pcXVlKCBvYmoubWF0Y2goIC9ce1x7W1x3XC5cLVxbXF1dK1x9XH0vZyApICk7CgoJCQkvLyBSZXBsYWNpbmcgcmVjb3JkIGtleQoJCQlvYmogPSBvYmoucmVwbGFjZSggInt7IiArIHNlbGYuc3RvcmUua2V5ICsgIn19IiwgaS5rZXkgKTsKCQkJCgkJCS8vIFJlcGxhY2luZyBkb3Qgbm90YXRpb24gcHJvcGVydGllcwoJCQlhcnJheS5lYWNoKCBpdGVtcywgZnVuY3Rpb24gKCBhdHRyICkgewoJCQkJdmFyIGtleSAgID0gYXR0ci5yZXBsYWNlKCAvXHtce3xcfVx9L2csICIiICksCgkJCQkgICAgdmFsdWUgPSB1dGlsaXR5LndhbGsoIGkuZGF0YSwga2V5ICkgfHwgIiI7CgoJCQkJcmVnLmNvbXBpbGUoIHN0cmluZy5lc2NhcGUoIGF0dHIgKSwgImciICk7CgoJCQkJLy8gU3RyaXBwaW5nIGZpcnN0IGFuZCBsYXN0ICIgdG8gY29uY2F0IHRvIHZhbGlkIEpTT04KCQkJCW9iaiA9IG9iai5yZXBsYWNlKCByZWcsIGpzb24uZW5jb2RlKCB2YWx1ZSApLnJlcGxhY2UoIC8oXiIpfCgiJCkvZywgIiIgKSApOwoJCQl9ICk7CgoJCQkvLyBGaWxsaW5nIGluIHBsYWNlaG9sZGVyIHZhbHVlCgkJCW9iaiA9IGpzb24uZGVjb2RlKCBvYmoucmVwbGFjZSggL1x7XHsuKlx9XH0vZywgc2VsZi5wbGFjZWhvbGRlciApICk7CgoJCQlyZXR1cm4ge2xpOiBvYmp9OwoJCX07Cgl9CgoJLy8gTmV4dCBwaGFzZQoJbmV4dCA9IGZ1bmN0aW9uICggYXJncyApIHsKCQkvLyBDcmVhdGluZyB2aWV3IG9mIERhdGFTdG9yZQoJCXNlbGYucmVjb3JkcyAgPSBhcmdzOwoJCXNlbGYudG90YWwgICAgPSBzZWxmLnJlY29yZHMubGVuZ3RoOwoJCXNlbGYuZmlsdGVyZWQgPSBbXTsKCgkJLy8gUmVzZXR0aW5nICd2aWV3JyBzcGVjaWZpYyBhcnJheXMKCQlzZWxmLmN1cnJlbnQgID0gW107CgoJCS8vIEZpbHRlcmluZyByZWNvcmRzIChpZiBhcHBsaWNhYmxlKQoJCWlmICggZmlsdGVyICkgewoJCQlhcnJheS5lYWNoKCBzZWxmLnJlY29yZHMsIGZ1bmN0aW9uICggaSApIHsKCQkJCXV0aWxpdHkuaXRlcmF0ZSggc2VsZi5maWx0ZXIsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCQl2YXIgcmVnLCBrZXk7CgoJCQkJCWlmICggYXJyYXkuY29udGFpbnMoIHJlZ2lzdHJ5LCBpLmtleSApICkgewoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJCQoJCQkJCXYgICA9IHN0cmluZy5leHBsb2RlKCB2ICk7CgkJCQkJcmVnID0gbmV3IFJlZ0V4cCgpLAoJCQkJCWtleSA9ICggayA9PT0gc2VsZi5zdG9yZS5rZXkgKTsKCgkJCQkJYXJyYXkuZWFjaCggdiwgZnVuY3Rpb24gKCBxdWVyeSApIHsKCQkJCQkJdmFyIHZhbHVlID0gIWtleSA/IHV0aWxpdHkud2FsayggaS5kYXRhLCBrICkgOiAiIjsKCgkJCQkJCXV0aWxpdHkuY29tcGlsZSggcmVnLCBxdWVyeSwgImkiICk7CgoJCQkJCQlpZiAoICgga2V5ICYmIHJlZy50ZXN0KCBpLmtleSApICkgfHwgcmVnLnRlc3QoIHZhbHVlICkgKSB7CgkJCQkJCQlyZWdpc3RyeS5wdXNoKCBpLmtleSApOwoJCQkJCQkJc2VsZi5maWx0ZXJlZC5wdXNoKCBpICk7CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSApOwoJCQkJfSApOwoJCQl9ICk7CgkJfQoKCQkvLyBQYWdpbmF0aW9uCgkJaWYgKCBzZWxmLnBhZ2VTaXplICE9PSBudWxsICYmICFpc05hTiggc2VsZi5wYWdlSW5kZXggKSAmJiAhaXNOYU4oIHNlbGYucGFnZVNpemUgKSApIHsKCQkJY2VpbGluZyA9IGxpc3QucGFnZXMuY2FsbCggc2VsZiApOwoKCQkJLy8gUGFzc2VkIHRoZSBlbmQsIHNvIHB1dHRpbmcgeW91IG9uIHRoZSBlbmQKCQkJaWYgKCBjZWlsaW5nID4gMCAmJiBzZWxmLnBhZ2VJbmRleCA+IGNlaWxpbmcgKSB7CgkJCQlyZXR1cm4gc2VsZi5wYWdlKCBjZWlsaW5nICk7CgkJCX0KCgkJCS8vIFBhZ2luYXRpbmcgdGhlIGl0ZW1zCgkJCWVsc2UgaWYgKCBzZWxmLnRvdGFsID4gMCApIHsKCQkJCXJhbmdlICAgICAgICA9IGxpc3QucmFuZ2UuY2FsbCggc2VsZiApOwoJCQkJc2VsZi5jdXJyZW50ID0gYXJyYXkubGltaXQoICFmaWx0ZXIgPyBzZWxmLnJlY29yZHMgOiBzZWxmLmZpbHRlcmVkLCByYW5nZVswXSwgcmFuZ2VbMV0gKTsKCQkJfQoJCX0KCQllbHNlIHsKCQkJc2VsZi5jdXJyZW50ID0gIWZpbHRlciA/IHNlbGYucmVjb3JkcyA6IHNlbGYuZmlsdGVyZWQ7CgkJfQoKCQkvLyBQcm9jZXNzaW5nIHJlY29yZHMgJiBnZW5lcmF0aW5nIHRlbXBsYXRlcwoJCWFycmF5LmVhY2goIHNlbGYuY3VycmVudCwgZnVuY3Rpb24gKCBpICkgewoJCQl2YXIgaHRtbCA9IGZuKCBpICksCgkJCSAgICBoYXNoID0gYnRvYSggaHRtbCApOwoKCQkJaXRlbXMucHVzaCgge2tleTogaS5rZXksIHRlbXBsYXRlOiBodG1sLCBoYXNoOiBoYXNofSApOwoJCX0gKTsKCgkJLy8gVXBkYXRpbmcgZWxlbWVudAoJCXV0aWxpdHkucmVuZGVyKCBmdW5jdGlvbiAoKSB7CgkJCXZhciBkZXN0cm95ICAgPSBbXSwKCQkJICAgIGNhbGxiYWNrcyA9IFtdLAoJCQkgICAgaSwgbnRoOwoKCQkJaWYgKCBpdGVtcy5sZW5ndGggPT09IDAgKSB7CgkJCQllbGVtZW50Lmh0bWwoIGVsLCAiPGxpIGNsYXNzPVwiZW1wdHlcIj4iICsgc2VsZi5lbXB0eU1zZyArICI8L2xpPiIgKTsKCQkJfQoJCQllbHNlIHsKCQkJCWlmICggc2VsZi5pdGVtcy5sZW5ndGggPT09IDAgKSB7CgkJCQkJZWxlbWVudC5odG1sKCBlbCwgaXRlbXMubWFwKCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJCXJldHVybiBpLnRlbXBsYXRlOwoJCQkJCX0gKS5qb2luKCAiIiApICk7CgoJCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJCWFycmF5LmVhY2goIGFycmF5LmNhc3QoIGVsLmNoaWxkTm9kZXMgKSwgZnVuY3Rpb24gKCBpICkgewoJCQkJCQkJc2VsZi5jYWxsYmFjayggaSApOwoJCQkJCQl9ICk7CgkJCQkJfQoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJYXJyYXkuZWFjaCggaXRlbXMsIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCQkJCQlpZiAoIHNlbGYuaXRlbXNbaWR4XSAhPT0gdW5kZWZpbmVkICYmIHNlbGYuaXRlbXNbaWR4XS5oYXNoICE9PSBpLmhhc2ggKSB7CgkJCQkJCQllbGVtZW50LmRhdGEoIGVsZW1lbnQuaHRtbCggZWwuY2hpbGROb2Rlc1tpZHhdLCBpLnRlbXBsYXRlLnJlcGxhY2UoIC88bGkgZGF0YS1rZXk9XCJcZCtcIj58PFwvbGk+L2csICIiICkgKSwgImtleSIsIGkua2V5ICk7CgkJCQkJCQljYWxsYmFja3MucHVzaCggaWR4ICk7CgkJCQkJCX0KCQkJCQkJZWxzZSBpZiAoIHNlbGYuaXRlbXNbaWR4XSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkJZWxlbWVudC5jcmVhdGUoIGkudGVtcGxhdGUsIG51bGwsIGVsICk7CgkJCQkJCQljYWxsYmFja3MucHVzaCggaWR4ICk7CgkJCQkJCX0KCQkJCQl9ICk7CgoJCQkJCWlmICggaXRlbXMubGVuZ3RoIDwgc2VsZi5pdGVtcy5sZW5ndGggKSB7CgkJCQkJCWkgICA9IGl0ZW1zLmxlbmd0aCAtIDE7CgkJCQkJCW50aCA9IHNlbGYuaXRlbXMubGVuZ3RoOwoKCQkJCQkJd2hpbGUgKCArK2kgPCBudGggKSB7CgkJCQkJCQlkZXN0cm95LnB1c2goIGkgKTsKCQkJCQkJfQoKCQkJCQkJYXJyYXkuZWFjaCggZGVzdHJveS5yZXZlcnNlKCksIGZ1bmN0aW9uICggaSApIHsKCQkJCQkJCWVsZW1lbnQuZGVzdHJveSggZWwuY2hpbGROb2Rlc1sgaSBdICk7CgkJCQkJCX0gKTsKCQkJCQl9CgoJCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJCWFycmF5LmVhY2goIGNhbGxiYWNrcywgZnVuY3Rpb24gKCBpICkgewoJCQkJCQkJc2VsZi5jYWxsYmFjayggZWwuY2hpbGROb2Rlc1tpXSApOwoJCQkJCQl9ICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBVcGRhdGluZyByZWZlcmVuY2UgZm9yIG5leHQgY2hhbmdlCgkJCXNlbGYuaXRlbXMgPSBpdGVtczsKCgkJCS8vIFJlbmRlcmluZyBwYWdpbmF0aW9uIGVsZW1lbnRzCgkJCWlmICggc2VsZi5wYWdlU2l6ZSAhPT0gbnVsbCAmJiByZWdleC50b3BfYm90dG9tLnRlc3QoIHNlbGYucGFnaW5hdGlvbiApICYmICFpc05hTiggc2VsZi5wYWdlSW5kZXggKSAmJiAhaXNOYU4oIHNlbGYucGFnZVNpemUgKSApIHsKCQkJCXNlbGYucGFnZXMoKTsKCQkJfQoJCQllbHNlIHsKCQkJCWFycmF5LmVhY2goIHV0aWxpdHkuJCggIiMiICsgZWwuaWQgKyAiLXBhZ2VzLXRvcCwgIyIgKyBlbC5pZCArICItcGFnZXMtYm90dG9tIiApLCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJZWxlbWVudC5kZXN0cm95KCBpICk7CgkJCQl9ICk7CgkJCX0KCgkJCXNlbGYuZGlzcGF0Y2goICJhZnRlclJlZnJlc2giLCBlbCApOwoJCX0gKTsKCX07CgoJLy8gQ29uc3VtaW5nIHJlY29yZHMgYmFzZWQgb24gc29ydAoJaWYgKCB0aGlzLndoZXJlID09PSBudWxsICkgewoJCXN0cmluZy5pc0VtcHR5KCB0aGlzLm9yZGVyICkgPyBuZXh0KCB0aGlzLnN0b3JlLmdldCgpICkgOiB0aGlzLnN0b3JlLnNvcnQoIHRoaXMub3JkZXIsIGNyZWF0ZSApLnRoZW4oIG5leHQsIGZ1bmN0aW9uICggZSApIHsKCQkJdXRpbGl0eS5lcnJvciggZSApOwoJCQlzZWxmLmRpc3BhdGNoKCAiZXJyb3IiLCBlICk7CgkJfSApOwoJfQoJZWxzZSBpZiAoIHN0cmluZy5pc0VtcHR5KCB0aGlzLm9yZGVyICkgKSB7CgkJdGhpcy5zdG9yZS5zZWxlY3QoIHRoaXMud2hlcmUgKS50aGVuKCBuZXh0LCBmdW5jdGlvbiAoIGUgKSB7CgkJCXV0aWxpdHkuZXJyb3IoIGUgKTsKCQkJc2VsZi5kaXNwYXRjaCggImVycm9yIiwgZSApOwoJCX0gKTsKCX0KCWVsc2UgewoJCXRoaXMuc3RvcmUuc29ydCggdGhpcy5vcmRlciwgY3JlYXRlLCB0aGlzLndoZXJlICkudGhlbiggbmV4dCwgZnVuY3Rpb24gKCBlICkgewoJCQl1dGlsaXR5LmVycm9yKCBlICk7CgkJCXNlbGYuZGlzcGF0Y2goICJlcnJvciIsIGUgKTsKCQl9ICk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogUmVtb3ZlcyBhbiBpdGVtIGZyb20gdGhlIERhdGFMaXN0CiAqCiAqIEBtZXRob2QgcmVtb3ZlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3QKICogQHBhcmFtIHtNaXhlZH0gcmVjb3JkIFJlY29yZCwga2V5IG9yIGluZGV4CiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhTGlzdH0KICogQGV4YW1wbGUKICogLy8gQWRkaW5nIGEgY2xpY2sgaGFuZGxlciB0byAndHJhc2gnIEVsZW1lbnRzCiAqIGtlaWdhaS51dGlsLmFycmF5LmNhc3QoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoICIubGlzdCAudHJhc2giICkgKS5mb3JFYWNoKCBmdW5jdGlvbiAoIGkgKSB7CiAqICAgaS5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiAoIGV2ICkgewogKiAgICAgdmFyIGtleSA9IGtlaWdhaS51dGlsLmVsZW1lbnQuZGF0YSgga2VpZ2FpLnV0aWwudGFyZ2V0KCBldiApLnBhcmVudE5vZGUsICJrZXkiICk7CiAqCiAqICAgICBsaXN0LnJlbW92ZSgga2V5ICk7CiAqICAgfSwgZmFsc2UgKTsKICogfSApOwogKi8KRGF0YUxpc3QucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uICggcmVjb3JkICkgewoJdmFyIHNlbGYgPSB0aGlzOwoKCXRoaXMuc3RvcmUuZGVsKCByZWNvcmQgKS50aGVuKCBudWxsLCBmdW5jdGlvbiAoIGUgKSB7CgkJdXRpbGl0eS5lcnJvciggZSApOwoJCXNlbGYuZGlzcGF0Y2goICJlcnJvciIsIGUgKTsKCX0gKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBTb3J0cyBkYXRhIGxpc3QgJiByZWZyZXNoZXMgZWxlbWVudAogKgogKiBAbWV0aG9kIHNvcnQKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhTGlzdAogKiBAcGFyYW0gIHtTdHJpbmd9IG9yZGVyIFNRTCAiT1JERVIgQlkiIGNsYXVzZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUxpc3R9CiAqIEBleGFtcGxlCiAqIGxpc3Quc29ydCggImFnZSwgbmFtZSIgKTsKICovCkRhdGFMaXN0LnByb3RvdHlwZS5zb3J0ID0gZnVuY3Rpb24gKCBvcmRlciApIHsKCXRoaXMub3JkZXIgPSBvcmRlcjsKCglyZXR1cm4gdGhpcy5yZWZyZXNoKCk7Cn07CgovKioKICogVGVhcnMgZG93biByZWZlcmVuY2VzIHRvIHRoZSBEYXRhTGlzdAogKgogKiBAbWV0aG9kIHRlYXJkb3duCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3QKICogQHBhcmFtICB7Qm9vbGVhbn0gZGVzdHJveSBbT3B0aW9uYWxdIGB0cnVlYCB3aWxsIHJlbW92ZSB0aGUgRGF0YUxpc3QgZnJvbSB0aGUgRE9NCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhTGlzdH0KICogQGV4YW1wbGUKICogbGlzdC50ZWFyZG93bigpOwogKi8KRGF0YUxpc3QucHJvdG90eXBlLnRlYXJkb3duID0gZnVuY3Rpb24gKCBkZXN0cm95ICkgewoJZGVzdHJveSAgPSAoIGRlc3Ryb3kgPT09IHRydWUgKTsKCXZhciBzZWxmID0gdGhpcywKCSAgICBpZCAgID0gdGhpcy5lbGVtZW50LmlkOwoKCWFycmF5LmVhY2goIHRoaXMuc3RvcmUubGlzdHMsIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCWlmICggaS5pZCA9PT0gc2VsZi5pZCApIHsKCQkJYXJyYXkucmVtb3ZlKCB0aGlzLCBpZHggKTsKCgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9ICk7CgoJZGVsZXRlIHRoaXMub2JzZXJ2ZXIuaG9va3NbaWRdOwoKCWlmICggdGhpcy5saXN0RmlsdGVyICkgewoJCXRoaXMubGlzdEZpbHRlci50ZWFyZG93bigpOwoJfQoKCWlmICggZGVzdHJveSApIHsKCQllbGVtZW50LmRlc3Ryb3koIHRoaXMuZWxlbWVudCApOwoKCQlhcnJheS5lYWNoKCB1dGlsaXR5LiQoICIjIiArIGlkICsgIi1maWx0ZXIsICMiICsgaWQgKyAiLXBhZ2VzLXRvcCwgIyIgKyBpZCArICItcGFnZXMtYm90dG9tIiksIGZ1bmN0aW9uICggaSApIHsKCQkJZWxlbWVudC5kZXN0cm95KCBpICk7CgkJfSApOwoKCQl0aGlzLmVsZW1lbnQgPSBudWxsOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIFVwZGF0ZXMgYW4gaXRlbSBpbiB0aGUgRGF0YUxpc3QKICoKICogQG1ldGhvZCB1cGRhdGUKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhTGlzdAogKiBAcGFyYW0ge01peGVkfSAga2V5ICBLZXkgb3IgaW5kZXgKICogQHBhcmFtIHtPYmplY3R9IGRhdGEgTmV3IHByb3BlcnR5IHZhbHVlcwogKiBAcmV0dXJuIHtPYmplY3R9ICAgICB7QGxpbmsga2VpZ2FpLkRhdGFMaXN0fQogKiBAZXhhbXBsZQogKiBsaXN0LnVwZGF0ZSggImtleSIsIHtuYW1lOiAiSmltIFNtaXRoIn0gKTsKICovCkRhdGFMaXN0LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoIGtleSwgZGF0YSApIHsKCXZhciBzZWxmID0gdGhpczsKCgl0aGlzLnN0b3JlLnVwZGF0ZSgga2V5LCBkYXRhICkudGhlbiggbnVsbCwgZnVuY3Rpb24gKCBlICkgewoJCXV0aWxpdHkuZXJyb3IoIGUgKTsKCQlzZWxmLmRpc3BhdGNoKCAiZXJyb3IiLCBlICk7Cgl9ICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogQG5hbWVzcGFjZSBkZWZlcnJlZAogKi8KdmFyIGRlZmVycmVkID0gewoJLyoqCgkgKiBEZWZlcnJlZCBmYWN0b3J5CgkgKgoJICogQG1ldGhvZCBmYWN0b3J5CgkgKiBAbWVtYmVyT2YgZGVmZXJyZWQKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EZWZlcnJlZH0KCSAqIEBleGFtcGxlCgkgKiB2YXIgZGVmZXJyZWQgPSBrZWlnYWkudXRpbC5kZWZlcigpOwoJICoKCSAqIGRlZmVycmVkLnRoZW4oIGZ1bmN0aW9uICggLi4uICkgeyAuLi4gfSwgZnVuY3Rpb24gKCBlcnIgKSB7IC4uLiB9ICkKCSAqIGRlZmVycmVkLmFsd2F5cyggZnVuY3Rpb24gKCAuLi4gKSB7IC4uLiB9ICk7CgkgKgoJICogLi4uCgkgKgoJICogZGVmZXJyZWQucmVzb2x2ZSggdHJ1ZSApOwoJICovCgkgZmFjdG9yeSA6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gbmV3IERlZmVycmVkKCk7Cgl9Cn07CgovKioKICogQ3JlYXRlcyBhIG5ldyBEZWZlcnJlZAogKgogKiBAY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaQogKi8KZnVuY3Rpb24gRGVmZXJyZWQgKCkgewoJdmFyIHNlbGYgICAgICA9IHRoaXM7CgoJdGhpcy5wcm9taXNlICA9IHByb21pc2UuZmFjdG9yeSgpOwoJdGhpcy5vbkRvbmUgICA9IFtdOwoJdGhpcy5vbkFsd2F5cyA9IFtdOwoJdGhpcy5vbkZhaWwgICA9IFtdOwoKCS8vIFNldHRpbmcgaGFuZGxlcnMgdG8gZXhlY3V0ZSBBcnJheXMgb2YgRnVuY3Rpb25zCgl0aGlzLnByb21pc2UudGhlbiggZnVuY3Rpb24gKCBhcmcgKSB7CgkJYXJyYXkuZWFjaCggc2VsZi5vbkRvbmUsIGZ1bmN0aW9uICggaSApIHsKCQkJaSggYXJnICk7CgkJfSApOwoKCQlhcnJheS5lYWNoKCBzZWxmLm9uQWx3YXlzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCWkoIGFyZyApOwoJCX0gKTsKCgkJc2VsZi5vbkFsd2F5cyA9IFtdOwoJCXNlbGYub25Eb25lICAgPSBbXTsKCQlzZWxmLm9uRmFpbCAgID0gW107Cgl9LCBmdW5jdGlvbiAoIGFyZyApIHsKCQlhcnJheS5lYWNoKCBzZWxmLm9uRmFpbCwgZnVuY3Rpb24gKCBpICkgewoJCQlpKCBhcmcgKTsKCQl9ICk7CgoJCWFycmF5LmVhY2goIHNlbGYub25BbHdheXMsIGZ1bmN0aW9uICggaSApIHsKCQkJaSggYXJnICk7CgkJfSApOwoKCQlzZWxmLm9uQWx3YXlzID0gW107CgkJc2VsZi5vbkRvbmUgICA9IFtdOwoJCXNlbGYub25GYWlsICAgPSBbXTsKCX0gKTsKfQoKLyoqCiAqIFNldHRpbmcgY29uc3RydWN0b3IgbG9vcAogKgogKiBAbWV0aG9kIGNvbnN0cnVjdG9yCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGVmZXJyZWQKICogQHR5cGUge0Z1bmN0aW9ufQogKiBAcHJpdmF0ZQogKi8KRGVmZXJyZWQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRGVmZXJyZWQ7CgovKioKICogUmVnaXN0ZXJzIGEgZnVuY3Rpb24gdG8gZXhlY3V0ZSBhZnRlciBQcm9taXNlIGlzIHJlY29uY2lsZWQKICoKICogQG1ldGhvZCBhbHdheXMKICogQG1lbWJlck9mIGtlaWdhaS5EZWZlcnJlZAogKiBAcGFyYW0gIHtGdW5jdGlvbn0gYXJnIEZ1bmN0aW9uIHRvIGV4ZWN1dGUKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZXhhbXBsZQogKiB2YXIgZGVmZXJyZWQgPSBrZWlnYWkudXRpbC5kZWZlcigpOwogKgogKiBkZWZlcnJlZC5hbHdheXMoIGZ1bmN0aW9uICgpIHsKICogICAgIC4uLgogKiB9ICkudGhlbiggZnVuY3Rpb24gKCkgewogKiAgICAgLi4uCiAqIH0gKTsKICoKICogLi4uCiAqCiAqIGRlZmVycmVkLnJlc29sdmUoIHRydWUgKTsKICovCkRlZmVycmVkLnByb3RvdHlwZS5hbHdheXMgPSBmdW5jdGlvbiAoIGFyZyApIHsKCXRoaXMub25BbHdheXMucHVzaCggYXJnICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogUmVnaXN0ZXJzIGEgZnVuY3Rpb24gdG8gZXhlY3V0ZSBhZnRlciBQcm9taXNlIGlzIHJlc29sdmVkCiAqCiAqIEBtZXRob2QgZG9uZQogKiBAbWVtYmVyT2Yga2VpZ2FpLkRlZmVycmVkCiAqIEBwYXJhbSAge0Z1bmN0aW9ufSBhcmcgRnVuY3Rpb24gdG8gZXhlY3V0ZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGVmZXJyZWR9CiAqIEBleGFtcGxlCiAqIHZhciBkZWZlcnJlZCA9IGtlaWdhaS51dGlsLmRlZmVyKCk7CiAqCiAqIGRlZmVycmVkLmRvbmUoIGZ1bmN0aW9uICggLi4uICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpEZWZlcnJlZC5wcm90b3R5cGUuZG9uZSA9IGZ1bmN0aW9uICggYXJnICkgewoJdGhpcy5vbkRvbmUucHVzaCggYXJnICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogUmVnaXN0ZXJzIGEgZnVuY3Rpb24gdG8gZXhlY3V0ZSBhZnRlciBQcm9taXNlIGlzIHJlamVjdGVkCiAqCiAqIEBtZXRob2QgZmFpbAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRlZmVycmVkCiAqIEBwYXJhbSAge0Z1bmN0aW9ufSBhcmcgRnVuY3Rpb24gdG8gZXhlY3V0ZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGVmZXJyZWR9CiAqIEBleGFtcGxlCiAqIHZhciBkZWZlcnJlZCA9IGtlaWdhaS51dGlsLmRlZmVyKCk7CiAqCiAqIGRlZmVycmVkLmZhaWwoIGZ1bmN0aW9uICggLi4uICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpEZWZlcnJlZC5wcm90b3R5cGUuZmFpbCA9IGZ1bmN0aW9uICggYXJnICkgewoJdGhpcy5vbkZhaWwucHVzaCggYXJnICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogUmVqZWN0cyB0aGUgUHJvbWlzZQogKgogKiBAbWV0aG9kIHJlamVjdAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRlZmVycmVkCiAqIEBwYXJhbSAge01peGVkfSBhcmcgUmVqZWN0aW9uIG91dGNvbWUKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZXhhbXBsZQogKiB2YXIgZGVmZXJyZWQgPSBrZWlnYWkudXRpbC5kZWZlcigpOwogKgogKiBkZWZlcnJlZC5yZWplY3QoIG5ldyBFcnJvciggIlNvbWV0aGluZyB3ZW50IHdyb25nIiApICk7CiAqLwpEZWZlcnJlZC5wcm90b3R5cGUucmVqZWN0ID0gZnVuY3Rpb24gKCBhcmcgKSB7Cgl0aGlzLnByb21pc2UucmVqZWN0LmNhbGwoIHRoaXMucHJvbWlzZSwgYXJnICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogUmVzb2x2ZXMgdGhlIFByb21pc2UKICoKICogQG1ldGhvZCByZXNvbHZlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGVmZXJyZWQKICogQHBhcmFtICB7TWl4ZWR9IGFyZyBSZXNvbHV0aW9uIG91dGNvbWUKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZXhhbXBsZQogKiB2YXIgZGVmZXJyZWQgPSBrZWlnYWkudXRpbC5kZWZlcigpOwogKgogKiBkZWZlcnJlZC5yZXNvbHZlKCB0cnVlICk7CiAqLwpEZWZlcnJlZC5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uICggYXJnICkgewoJdGhpcy5wcm9taXNlLnJlc29sdmUuY2FsbCggdGhpcy5wcm9taXNlLCBhcmcgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBSZWdpc3RlcnMgaGFuZGxlcihzKSBmb3IgdGhlIFByb21pc2UKICoKICogQG1ldGhvZCB0aGVuCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGVmZXJyZWQKICogQHBhcmFtICB7RnVuY3Rpb259IHN1Y2Nlc3MgRXhlY3V0ZWQgd2hlbi9pZiBwcm9taXNlIGlzIHJlc29sdmVkCiAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmYWlsdXJlIFtPcHRpb25hbF0gRXhlY3V0ZWQgd2hlbi9pZiBwcm9taXNlIGlzIGJyb2tlbgogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBQcm9taXNlfQogKiBAZXhhbXBsZQogKiB2YXIgZGVmZXJyZWQgPSBrZWlnYWkudXRpbC5kZWZlcigpOwogKgogKiBkZWZlcnJlZC50aGVuKCBmdW5jdGlvbiAoIC4uLiApIHsgLi4uIH0sIGZ1bmN0aW9uICggZXJyICkgeyAuLi4gfSApCiAqICAgICAgICAgLnRoZW4oIGZ1bmN0aW9uICggLi4uICkgeyAuLi4gfSwgZnVuY3Rpb24gKCBlcnIgKSB7IC4uLiB9ICk7CiAqCiAqIC4uLgogKgogKiBkZWZlcnJlZC5yZXNvbHZlKCB0cnVlICk7CiAqLwpEZWZlcnJlZC5wcm90b3R5cGUudGhlbiA9IGZ1bmN0aW9uICggc3VjY2VzcywgZmFpbHVyZSApIHsKCXJldHVybiB0aGlzLnByb21pc2UudGhlbiggc3VjY2VzcywgZmFpbHVyZSApOwp9OwoKLyoqCiAqIEBuYW1lc3BhY2UgZWxlbWVudAogKi8KdmFyIGVsZW1lbnQgPSB7CgkvKioKCSAqIEFwcGVuZHMgYW4gRWxlbWVudCB0byBhbiBFbGVtZW50CgkgKgoJICogQG1lbWJlck9mIGFwcGVuZFRvCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogICBFbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IGNoaWxkIENoaWxkIEVsZW1lbnQKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuYXBwZW5kVG8oIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjdGFyZ2V0IiApLCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSApOwoJICovCglhcHBlbmRUbyA6IGZ1bmN0aW9uICggb2JqLCBjaGlsZCApIHsKCQlvYmouYXBwZW5kQ2hpbGQoIGNoaWxkICk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogR2V0cyBvciBzZXRzIGFuIEVsZW1lbnQgYXR0cmlidXRlCgkgKgoJICogQG1ldGhvZCBhdHRyCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogICBFbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IG5hbWUgIEF0dHJpYnV0ZSBuYW1lCgkgKiBAcGFyYW0gIHtNaXhlZH0gIHZhbHVlIEF0dHJpYnV0ZSB2YWx1ZQoJICogQHJldHVybiB7T2JqZWN0fSAgICAgICBFbGVtZW50CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC5hdHRyKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAic2VsZWN0IiApLCAic2VsZWN0ZWQiLCAib3B0aW9uIDEiICk7CgkgKi8KCWF0dHIgOiBmdW5jdGlvbiAoIG9iaiwga2V5LCB2YWx1ZSApIHsKCQl2YXIgdGFyZ2V0LCByZXN1bHQ7CgoJCWlmICggcmVnZXguc3ZnLnRlc3QoIG9iai5uYW1lc3BhY2VVUkkgKSApIHsKCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmVzdWx0ID0gb2JqLmdldEF0dHJpYnV0ZU5TKCBvYmoubmFtZXNwYWNlVVJJLCBrZXkgKTsKCgkJCQlpZiAoIHJlc3VsdCA9PT0gbnVsbCB8fCBzdHJpbmcuaXNFbXB0eSggcmVzdWx0ICkgKSB7CgkJCQkJcmVzdWx0ID0gdW5kZWZpbmVkOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJcmVzdWx0ID0gdXRpbGl0eS5jb2VyY2UoIHJlc3VsdCApOwoJCQkJfQoJCQl9CgkJCWVsc2UgewoJCQkJb2JqLnNldEF0dHJpYnV0ZU5TKCBvYmoubmFtZXNwYWNlVVJJLCBrZXksIHZhbHVlICk7CgkJCX0KCQl9CgkJZWxzZSB7CgkJCWlmICggdHlwZW9mIHZhbHVlID09ICJzdHJpbmciICkgewoJCQkJdmFsdWUgPSBzdHJpbmcudHJpbSggdmFsdWUgKTsKCQkJfQoKCQkJaWYgKCByZWdleC5jaGVja2VkX2Rpc2FibGVkLnRlc3QoIGtleSApICYmIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gdXRpbGl0eS5jb2VyY2UoIG9ialtrZXldICk7CgkJCX0KCQkJZWxzZSBpZiAoIHJlZ2V4LmNoZWNrZWRfZGlzYWJsZWQudGVzdCgga2V5ICkgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCW9ialtrZXldID0gdmFsdWU7CgkJCX0KCQkJZWxzZSBpZiAoIG9iai5ub2RlTmFtZSA9PT0gIlNFTEVDVCIgJiYga2V5ID09PSAic2VsZWN0ZWQiICYmIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gdXRpbGl0eS5kb20oICIjIiArIG9iai5pZCArICIgb3B0aW9uW3NlbGVjdGVkPVwic2VsZWN0ZWRcIl0iIClbMF0gfHwgdXRpbGl0eS5kb20oICIjIiArIG9iai5pZCArICIgb3B0aW9uIiApWzBdOwoJCQl9CgkJCWVsc2UgaWYgKCBvYmoubm9kZU5hbWUgPT09ICJTRUxFQ1QiICYmIGtleSA9PT0gInNlbGVjdGVkIiAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGFyZ2V0ID0gdXRpbGl0eS5kb20oICIjIiArIG9iai5pZCArICIgb3B0aW9uW3NlbGVjdGVkPVwic2VsZWN0ZWRcIl0iIClbMF07CgoJCQkJaWYgKCB0YXJnZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJCQl0YXJnZXQuc2VsZWN0ZWQgPSBmYWxzZTsKCQkJCQl0YXJnZXQucmVtb3ZlQXR0cmlidXRlKCAic2VsZWN0ZWQiICk7CgkJCQl9CgoJCQkJdGFyZ2V0ID0gdXRpbGl0eS5kb20oICIjIiArIG9iai5pZCArICIgb3B0aW9uW3ZhbHVlPVwiIiArIHZhbHVlICsgIlwiXSIgKVswXTsKCQkJCXRhcmdldC5zZWxlY3RlZCA9IHRydWU7CgkJCQl0YXJnZXQuc2V0QXR0cmlidXRlKCAic2VsZWN0ZWQiLCAic2VsZWN0ZWQiICk7CgkJCX0KCQkJZWxzZSBpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXN1bHQgPSBvYmouZ2V0QXR0cmlidXRlKCBrZXkgKTsKCgkJCQlpZiAoIHJlc3VsdCA9PT0gbnVsbCB8fCBzdHJpbmcuaXNFbXB0eSggcmVzdWx0ICkgKSB7CgkJCQkJcmVzdWx0ID0gdW5kZWZpbmVkOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJcmVzdWx0ID0gdXRpbGl0eS5jb2VyY2UoIHJlc3VsdCApOwoJCQkJfQoKCQkJCXJldHVybiByZXN1bHQ7CgkJCX0KCQkJZWxzZSB7CgkJCQlvYmouc2V0QXR0cmlidXRlKCBrZXksIHZhbHVlICk7CgkJCX0KCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogQ2xlYXJzIGFuIG9iamVjdCdzIGlubmVySFRNTCwgb3IgcmVzZXRzIGl0J3Mgc3RhdGUKCSAqCgkgKiBAbWV0aG9kIGNsZWFyCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuY2xlYXIoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApICk7CgkgKi8KCWNsZWFyIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJaWYgKCB0eXBlb2Ygb2JqLnJlc2V0ID09ICJmdW5jdGlvbiIgKSB7CgkJCW9iai5yZXNldCgpOwoJCX0KCQllbHNlIGlmICggb2JqLnZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW1lbnQudXBkYXRlKCBvYmosIHtpbm5lckhUTUw6ICIiLCB2YWx1ZTogIiJ9ICk7CgkJfQoJCWVsc2UgewoJCQllbGVtZW50LnVwZGF0ZSggb2JqLCB7aW5uZXJIVE1MOiAiIn0gKTsKCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogQ3JlYXRlcyBhbiBFbGVtZW50IGluIGRvY3VtZW50LmJvZHkgb3IgYSB0YXJnZXQgRWxlbWVudC4KCSAqIEFuIGlkIGlzIGdlbmVyYXRlZCBpZiBub3Qgc3BlY2lmaWVkIHdpdGggYXJncy4KCSAqCgkgKiBAbWV0aG9kIGNyZWF0ZQoJICogQG1lbWJlck9mIGVsZW1lbnQKCSAqIEBwYXJhbSAge1N0cmluZ30gdHlwZSBUeXBlIG9mIEVsZW1lbnQgdG8gY3JlYXRlLCBvciBIVE1MIFN0cmluZwoJICogQHBhcmFtICB7T2JqZWN0fSBhcmdzIFtPcHRpb25hbF0gUHJvcGVydGllcyB0byBzZXQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqICBbT3B0aW9uYWxdIFRhcmdldCBFbGVtZW50CgkgKiBAcGFyYW0gIHtNaXhlZH0gIHBvcyAgW09wdGlvbmFsXSAiZmlyc3QiLCAibGFzdCIgb3IgT2JqZWN0IGRlc2NyaWJpbmcgaG93IHRvIGFkZCB0aGUgbmV3IEVsZW1lbnQsIGUuZy4ge2JlZm9yZTogcmVmZXJlbmNlRWxlbWVudH0sIGRlZmF1bHQgaXMgImxhc3QiCgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgICAgRWxlbWVudCB0aGF0IHdhcyBjcmVhdGVkLCBvciBhbiBBcnJheSBpZiBgdHlwZWAgaXMgYSBTdHJpbmcgb2YgbXVsdGlwbGUgRWxlbWVudHMgKGZyYWcpCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC5jcmVhdGUoICJkaXYiLCB7aW5uZXJIVE1MOiAiSGVsbG8gV29ybGQhIn0sIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApICk7CgkgKiBrZWlnYWkudXRpbC5lbGVtZW50LmNyZWF0ZSggIiZsdDtkaXYmZ3Q7SGVsbG8gV29ybGQhJmx0Oy9kaXYmZ3Q7IiApOwoJICovCgljcmVhdGUgOiBmdW5jdGlvbiAoIHR5cGUsIGFyZ3MsIG9iaiwgcG9zICkgewoJCXZhciBzdmcgID0gZmFsc2UsCgkJICAgIGZyYWcgPSBmYWxzZSwKCQkgICAgZnJhZ21lbnQsIHVpZCwgcmVzdWx0OwoKCQkvLyBSZW1vdmluZyBwb3RlbnRpYWwgSFRNTCB0ZW1wbGF0ZSBmb3JtYXR0aW5nCgkJdHlwZSA9IHR5cGUucmVwbGFjZSggL1x0fFxufFxyL2csICIiICk7CgoJCWlmICggb2JqICkgewoJCQlzdmcgPSBvYmoubmFtZXNwYWNlVVJJICYmIHJlZ2V4LnN2Zy50ZXN0KCBvYmoubmFtZXNwYWNlVVJJICk7CgkJfQoJCWVsc2UgewoJCQlvYmogPSBkb2N1bWVudC5ib2R5OwoJCX0KCQkKCQlpZiAoIGFyZ3MgaW5zdGFuY2VvZiBPYmplY3QgJiYgYXJncy5pZCAmJiAhdXRpbGl0eS5kb20oICIjIiArIGFyZ3MuaWQgKSApIHsKCQkJdWlkID0gYXJncy5pZDsKCQkJZGVsZXRlIGFyZ3MuaWQ7CgkJfQoJCWVsc2UgaWYgKCAhc3ZnICkgewoJCQl1aWQgPSB1dGlsaXR5LmdlbklkKCB1bmRlZmluZWQsIHRydWUgKTsKCQl9CgoJCS8vIFN0cmluZyBpbmplY3Rpb24sIGNyZWF0ZSBhIGZyYWcgYW5kIGFwcGx5IGl0CgkJaWYgKCByZWdleC5odG1sLnRlc3QoIHR5cGUgKSApIHsKCQkJZnJhZyAgICAgPSB0cnVlOwoJCQlmcmFnbWVudCA9IGVsZW1lbnQuZnJhZyggdHlwZSApOwoJCQlyZXN1bHQgICA9IGZyYWdtZW50LmNoaWxkTm9kZXMubGVuZ3RoID09PSAxID8gZnJhZ21lbnQuY2hpbGROb2Rlc1swXSA6IGFycmF5LmNhc3QoIGZyYWdtZW50LmNoaWxkTm9kZXMgKTsKCQl9CgkJLy8gT3JpZ2luYWwgc3ludGF4CgkJZWxzZSB7CgkJCWlmICggIXN2ZyAmJiAhcmVnZXguc3ZnLnRlc3QoIHR5cGUgKSApIHsKCQkJCWZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggdHlwZSApOwoJCQl9CgkJCWVsc2UgewoJCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIsIHR5cGUgKTsKCQkJfQoKCQkJaWYgKCB1aWQgKSB7CgkJCQlmcmFnbWVudC5pZCA9IHVpZDsKCQkJfQoKCQkJaWYgKCBhcmdzIGluc3RhbmNlb2YgT2JqZWN0ICkgewoJCQkJZWxlbWVudC51cGRhdGUoIGZyYWdtZW50LCBhcmdzICk7CgkJCX0KCQl9CgoJCWlmICggIXBvcyB8fCBwb3MgPT09ICJsYXN0IiApIHsKCQkJb2JqLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoJCX0KCQllbHNlIGlmICggcG9zID09PSAiZmlyc3QiICkgewoJCQllbGVtZW50LnByZXBlbmRDaGlsZCggb2JqLCBmcmFnbWVudCApOwoJCX0KCQllbHNlIGlmICggcG9zID09PSAiYWZ0ZXIiICkgewoJCQlwb3MgPSB7YWZ0ZXI6IG9ian07CgkJCW9iaiA9IG9iai5wYXJlbnROb2RlOwoJCQlvYmouaW5zZXJ0QmVmb3JlKCBmcmFnbWVudCwgcG9zLmFmdGVyLm5leHRTaWJsaW5nICk7CgkJfQoJCWVsc2UgaWYgKCBwb3MuYWZ0ZXIgKSB7CgkJCW9iai5pbnNlcnRCZWZvcmUoIGZyYWdtZW50LCBwb3MuYWZ0ZXIubmV4dFNpYmxpbmcgKTsKCQl9CgkJZWxzZSBpZiAoIHBvcyA9PT0gImJlZm9yZSIgKSB7CgkJCXBvcyA9IHtiZWZvcmU6IG9ian07CgkJCW9iaiA9IG9iai5wYXJlbnROb2RlOwoJCQlvYmouaW5zZXJ0QmVmb3JlKCBmcmFnbWVudCwgcG9zLmJlZm9yZSApOwoJCX0KCQllbHNlIGlmICggcG9zLmJlZm9yZSApIHsKCQkJb2JqLmluc2VydEJlZm9yZSggZnJhZ21lbnQsIHBvcy5iZWZvcmUgKTsKCQl9CgkJZWxzZSB7CgkJCW9iai5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTsKCQl9CgoJCXJldHVybiAhZnJhZyA/IGZyYWdtZW50IDogcmVzdWx0OwoJfSwKCgkvKioKCSAqIEdldHMgb3Igc2V0cyBhIENTUyBzdHlsZSBhdHRyaWJ1dGUgb24gYW4gRWxlbWVudAoJICoKCSAqIEBtZXRob2QgY3NzCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogICBFbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGtleSAgIENTUyB0byBwdXQgaW4gYSBzdHlsZSB0YWcKCSAqIEBwYXJhbSAge1N0cmluZ30gdmFsdWUgW09wdGlvbmFsXSBWYWx1ZSB0byBzZXQKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuY3NzKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSwgImZvbnQtd2VpZ2h0IiwgImJvbGQiICk7CgkgKiBrZWlnYWkudXRpbC5lbGVtZW50LmNzcyggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICksICJmb250LXdlaWdodCIgKTsgLy8gImJvbGQiCgkgKi8KCWNzcyA6IGZ1bmN0aW9uICggb2JqLCBrZXksIHZhbHVlICkgewoJCWlmICggIXJlZ2V4LmNhcHMudGVzdCgga2V5ICkgKSB7CgkJCWtleSA9IHN0cmluZy50b0NhbWVsQ2FzZSgga2V5ICk7CgkJfQoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCW9iai5zdHlsZVtrZXldID0gdmFsdWU7CgkJCXJldHVybiBvYmo7CgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gb2JqLnN0eWxlW2tleV07CgkJfQoJfSwKCgkvKioKCSAqIERhdGEgYXR0cmlidXRlIGZhY2FkZSBhY3RpbmcgYXMgYSBnZXR0ZXIgKHdpdGggY29lcmNpb24pICYgc2V0dGVyCgkgKgoJICogQG1ldGhvZCBkYXRhCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogICBFbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGtleSAgIERhdGEga2V5CgkgKiBAcGFyYW0gIHtNaXhlZH0gIHZhbHVlIEJvb2xlYW4sIE51bWJlciBvciBTdHJpbmcgdG8gc2V0CgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgICAgIHVuZGVmaW5lZCwgRWxlbWVudCBvciB2YWx1ZQoJICogQGV4YW1wbGUKCSAqIC8vIFNldHRpbmcKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuZGF0YSggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICksICJpZCIsICJhYmMtMTIzNCIgKTsKCSAqCgkgKiAvLyBHZXR0aW5nCgkgKiBrZWlnYWkudXRpbC5lbGVtZW50LmRhdGEoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCAiaWQiICk7IC8vICJhYmMtMTIzNCIKCSAqCgkgKiAvLyBVbnNldHRpbmcKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuZGF0YSggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICksICJpZCIsIG51bGwgKTsKCSAqCgkgKiAvLyBTZXR0aW5nIGEgYG51bGxgIHZhbHVlIGNhbiBiZSBkb25lIGJ5IHVzaW5nIGEgU3RyaW5nCgkgKiBrZWlnYWkudXRpbC5lbGVtZW50LmRhdGEoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCAiaWQiLCAibnVsbCIgKTsKCSAqLwoJZGF0YSA6IGZ1bmN0aW9uICggb2JqLCBrZXksIHZhbHVlICkgewoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJb2JqLnNldEF0dHJpYnV0ZSggImRhdGEtIiArIGtleSwgcmVnZXguanNvbl93cmFwLnRlc3QoIHZhbHVlICkgPyBqc29uLmVuY29kZSggdmFsdWUgKSA6IHZhbHVlICk7CgoJCQlyZXR1cm4gb2JqOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIHV0aWxpdHkuY29lcmNlKCBvYmouZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsga2V5ICkgKTsKCQl9Cgl9LAoKCS8qKgoJICogRGVzdHJveXMgYW4gRWxlbWVudAoJICoKCSAqIEBtZXRob2QgZGVzdHJveQoJICogQG1lbWJlck9mIGVsZW1lbnQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqIEVsZW1lbnQKCSAqIEByZXR1cm4ge1VuZGVmaW5lZH0gdW5kZWZpbmVkCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC5kZXN0cm95KCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSApOwoJICovCglkZXN0cm95IDogZnVuY3Rpb24gKCBvYmogKSB7CgkJaWYgKCBvYmoucGFyZW50Tm9kZSAhPT0gbnVsbCApIHsKCQkJb2JqLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIG9iaiApOwoJCX0KCgkJcmV0dXJuIHVuZGVmaW5lZDsKCX0sCgoJLyoqCgkgKiBEaXNhYmxlcyBhbiBFbGVtZW50CgkgKgoJICogQG1ldGhvZCBkaXNhYmxlCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuZGlzYWJsZSggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICkgKTsKCSAqLwoJZGlzYWJsZSA6IGZ1bmN0aW9uICggb2JqICkgewoJCWlmICggdHlwZW9mIG9iai5kaXNhYmxlZCA9PSAiYm9vbGVhbiIgJiYgIW9iai5kaXNhYmxlZCApIHsKCQkJb2JqLmRpc2FibGVkID0gdHJ1ZTsKCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogRGlzcGF0Y2hlcyBhIERPTSBFdmVudCBmcm9tIGFuIEVsZW1lbnQKCSAqCgkgKiBgZGF0YWAgd2lsbCBhcHBlYXIgYXMgYEV2ZW50LmRldGFpbGAKCSAqCgkgKiBAbWV0aG9kIGRpc3BhdGNoCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSAgb2JqICAgICAgICBFbGVtZW50IHdoaWNoIGRpc3BhdGNoZXMgdGhlIEV2ZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9ICB0eXBlICAgICAgIFR5cGUgb2YgRXZlbnQgdG8gZGlzcGF0Y2gKCSAqIEBwYXJhbSAge09iamVjdH0gIGRhdGEgICAgICAgW09wdGlvbmFsXSBEYXRhIHRvIGluY2x1ZGUgd2l0aCB0aGUgRXZlbnQKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGJ1YmJsZXMgICAgW09wdGlvbmFsXSBEZXRlcm1pbmVzIGlmIHRoZSBFdmVudCBidWJibGVzLCBkZWZhdWx0cyB0byBgdHJ1ZWAKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGNhbmNlbGFibGUgW09wdGlvbmFsXSBEZXRlcm1pbmVzIGlmIHRoZSBFdmVudCBjYW4gYmUgY2FuY2VsZWQsIGRlZmF1bHRzIHRvIGB0cnVlYAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgICAgICAgICBFbGVtZW50IHdoaWNoIGRpc3BhdGNoZXMgdGhlIEV2ZW50CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC5kaXNwYXRjaCggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICksICJjbGljayIgKTsKCSAqLwoJZGlzcGF0Y2ggOiBmdW5jdGlvbiAoIG9iaiwgdHlwZSwgZGF0YSwgYnViYmxlcywgY2FuY2VsYWJsZSApIHsKCQl2YXIgZXY7CgoJCWlmICggIW9iaiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdHJ5IHsKCQkJZXYgPSBuZXcgQ3VzdG9tRXZlbnQoIHR5cGUgKTsKCQl9CgkJY2F0Y2ggKCBlICkgewoJCQlldiA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCAiQ3VzdG9tRXZlbnQiICk7CgkJfQoKCQlidWJibGVzICAgID0gKCBidWJibGVzICAgICE9PSBmYWxzZSApOwoJCWNhbmNlbGFibGUgPSAoIGNhbmNlbGFibGUgIT09IGZhbHNlICk7CgoJCWV2LmluaXRDdXN0b21FdmVudCggdHlwZSwgYnViYmxlcywgY2FuY2VsYWJsZSwgZGF0YSB8fCB7fSApOwoJCW9iai5kaXNwYXRjaEV2ZW50KCBldiApOwoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIEVuYWJsZXMgYW4gRWxlbWVudAoJICoKCSAqIEBtZXRob2QgZW5hYmxlCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuZW5hYmxlKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSApOwoJICovCgllbmFibGUgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlpZiAoIHR5cGVvZiBvYmouZGlzYWJsZWQgPT0gImJvb2xlYW4iICYmIG9iai5kaXNhYmxlZCApIHsKCQkJb2JqLmRpc2FibGVkID0gZmFsc2U7CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIEZpbmRzIGRlc2NlbmRhbnQgY2hpbGROb2RlcyBvZiBFbGVtZW50IG1hdGNoZWQgYnkgYXJnCgkgKgoJICogQG1ldGhvZCBmaW5kCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudCB0byBzZWFyY2gKCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnIENvbW1hIGRlbGltaXRlZCBzdHJpbmcgb2YgZGVzY2VuZGFudCBzZWxlY3RvcnMKCSAqIEByZXR1cm4ge01peGVkfSAgICAgIEFycmF5IG9mIEVsZW1lbnRzIG9yIHVuZGVmaW5lZAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuZmluZCggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICksICJwIiApOwoJICovCglmaW5kIDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQl2YXIgcmVzdWx0ID0gW107CgoJCXV0aWxpdHkuZ2VuSWQoIG9iaiwgdHJ1ZSApOwoKCQlhcnJheS5lYWNoKCBzdHJpbmcuZXhwbG9kZSggYXJnICksIGZ1bmN0aW9uICggaSApIHsKCQkJcmVzdWx0ID0gcmVzdWx0LmNvbmNhdCggdXRpbGl0eS5kb20oICIjIiArIG9iai5pZCArICIgIiArIGkgKSApOwoJCX0gKTsKCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGEgZG9jdW1lbnQgZnJhZ21lbnQKCSAqCgkgKiBAbWV0aG9kIGZyYWcKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBbT3B0aW9uYWxdIGlubmVySFRNTAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRG9jdW1lbnQgZnJhZ21lbnQKCSAqIEBleGFtcGxlCgkgKiB2YXIgZnJhZyA9IGtlaWdhaS51dGlsLmVsZW1lbnQuZnJhZyggIkhlbGxvIFdvcmxkISIgKTsKCSAqLwoJZnJhZyA6IGZ1bmN0aW9uICggYXJnICkgewoJCXZhciBvYmogPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWlmICggYXJnICkgewoJCQlhcnJheS5lYWNoKCBhcnJheS5jYXN0KCBlbGVtZW50LmNyZWF0ZSggImRpdiIsIHtpbm5lckhUTUw6IGFyZ30sIG9iaiApLmNoaWxkTm9kZXMgKSwgZnVuY3Rpb24gKCBpICkgewoJCQkJb2JqLmFwcGVuZENoaWxkKCBpICk7CgkJCX0gKTsKCgkJCW9iai5yZW1vdmVDaGlsZCggb2JqLmNoaWxkTm9kZXNbMF0gKTsKCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogRGV0ZXJtaW5lcyBpZiBFbGVtZW50IGhhcyBkZXNjZW5kYW50cyBtYXRjaGluZyBhcmcKCSAqCgkgKiBAbWV0aG9kIGhhcwoJICogQG1lbWJlck9mIGVsZW1lbnQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqIEVsZW1lbnQKCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnIFR5cGUgb2YgRWxlbWVudCB0byBmaW5kCgkgKiBAcmV0dXJuIHtCb29sZWFufSAgICBgdHJ1ZWAgaWYgMSBvciBtb3JlIEVsZW1lbnRzIGFyZSBmb3VuZAoJICogQGV4YW1wbGUKCSAqIGlmICgga2VpZ2FpLnV0aWwuZWxlbWVudC5oYXMoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCAicCIgKSApIHsKCSAqICAgLi4uCgkgKiB9CgkgKi8KCWhhcyA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJdmFyIHJlc3VsdCA9IGVsZW1lbnQuZmluZCggb2JqLCBhcmcgKTsKCgkJcmV0dXJuICggIWlzTmFOKCByZXN1bHQubGVuZ3RoICkgJiYgcmVzdWx0Lmxlbmd0aCA+IDAgKTsKCX0sCgoJLyoqCgkgKiBEZXRlcm1pbmVzIGlmIG9iaiBoYXMgYSBzcGVjaWZpYyBDU1MgY2xhc3MKCSAqCgkgKiBAbWV0aG9kIGhhc0NsYXNzCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgQ1NTIGNsYXNzIHRvIHRlc3QgZm9yCgkgKiBAcmV0dXJuIHtCb29sZWFufSAgICBgdHJ1ZWAgaWYgRWxlbWVudCBoYXMgYGFyZ2AKCSAqIEBleGFtcGxlCgkgKiBpZiAoIGtlaWdhaS51dGlsLmVsZW1lbnQuaGFzQ2xhc3MoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCAic29tZUNsYXNzIiApICkgewoJICogICAuLi4KCSAqIH0KCSAqLwoJaGFzQ2xhc3MgOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCXJldHVybiBvYmouY2xhc3NMaXN0LmNvbnRhaW5zKCBhcmcgKTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIGEgQm9vbGVhbiBpbmRpZGNhdGluZyBpZiB0aGUgT2JqZWN0IGlzIGhpZGRlbgoJICoKCSAqIEBtZXRob2QgaGlkZGVuCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHJldHVybiB7Qm9vbGVhbn0gICBgdHJ1ZWAgaWYgaGlkZGVuCgkgKiBAZXhhbXBsZQoJICogaWYgKCBrZWlnYWkudXRpbC5lbGVtZW50LmhpZGRlbiggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICkgKSApIHsKCSAqICAgLi4uCgkgKiB9CgkgKi8KCWhpZGRlbiA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBvYmouc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiIHx8ICggdHlwZW9mIG9iai5oaWRkZW4gPT0gImJvb2xlYW4iICYmIG9iai5oaWRkZW4gKTsKCX0sCgoJLyoqCgkgKiBHZXRzIG9yIHNldHMgYW4gRWxlbWVudHMgaW5uZXJIVE1MCgkgKgoJICogQG1ldGhvZCBodG1sCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgW09wdGlvbmFsXSBpbm5lckhUTUwgdmFsdWUKCSAqIEByZXR1cm4ge09iamVjdH0gICAgIEVsZW1lbnQKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5lbGVtZW50Lmh0bWwoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCAiSGVsbG8gV29ybGQhIiApOwoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC5odG1sKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSApOyAvLyAiSGVsbG8gV29ybGQhIgoJICovCglodG1sIDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQlpZiAoIGFyZyA9PT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gb2JqLmlubmVySFRNTDsKCQl9CgkJZWxzZSB7CgkJCSBvYmouaW5uZXJIVE1MID0gYXJnOwoJCQkgcmV0dXJuIG9iajsKCQl9Cgl9LAoKCS8qKgoJICogRGV0ZXJtaW5lcyBpZiBFbGVtZW50IGlzIGVxdWFsIHRvIGBhcmdgLCBzdXBwb3J0cyBub2RlTmFtZXMgJiBDU1MyKyBzZWxlY3RvcnMKCSAqCgkgKiBAbWV0aG9kIGlzCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgUHJvcGVydHkgdG8gcXVlcnkKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgIGB0cnVlYCBpZiBhIG1hdGNoCgkgKiBAZXhhbXBsZQoJICogaWYgKCBrZWlnYWkudXRpbC5lbGVtZW50LmlzKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSwgImRpdiIgKSApIHsKCSAqICAgLi4uCgkgKiB9CgkgKgoJICogaWYgKCBrZWlnYWkudXRpbC5lbGVtZW50LmlzKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSwgIjpmaXJzdC1jaGlsZCIgKSApIHsKCSAqICAgLi4uCgkgKiB9CgkgKi8KCWlzIDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQlpZiAoIHJlZ2V4LnNlbGVjdG9yX2lzLnRlc3QoIGFyZyApICkgewoJCQlyZXR1cm4gKCBlbGVtZW50LmZpbmQoIG9iai5wYXJlbnROb2RlLCBvYmoubm9kZU5hbWUudG9Mb3dlckNhc2UoKSArIGFyZyApLmZpbHRlciggZnVuY3Rpb24gKCBpICkgewoJCQkJcmV0dXJuIGkuaWQgPT09IG9iai5pZDsKCQkJfSApLmxlbmd0aCA9PT0gMSApOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIG5ldyBSZWdFeHAoIGFyZywgImkiICkudGVzdCggb2JqLm5vZGVOYW1lICk7CgkJfQoJfSwKCgkvKioKCSAqIEFkZHMgb3IgcmVtb3ZlcyBhIENTUyBjbGFzcwoJICoKCSAqIEBtZXRob2Qga2xhc3MKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9ICBvYmogRWxlbWVudAoJICogQHBhcmFtICB7U3RyaW5nfSAgYXJnIENsYXNzIHRvIGFkZCBvciByZW1vdmUgKCBjYW4gYmUgYSB3aWxkY2FyZCApCgkgKiBAcGFyYW0gIHtCb29sZWFufSBhZGQgQm9vbGVhbiB0byBhZGQgb3IgcmVtb3ZlLCBkZWZhdWx0cyB0byB0cnVlCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIC8vIEFkZGluZyBhIGNsYXNzCgkgKiBrZWlnYWkudXRpbC5lbGVtZW50LmtsYXNzKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSwgIm5ld0NsYXNzIiApOwoJICoKCSAqIC8vIFJlbW92aW5nIGEgY2xhc3MKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQua2xhc3MoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCAibmV3Q2xhc3MiLCBmYWxzZSApOwoJICovCglrbGFzcyA6IGZ1bmN0aW9uICggb2JqLCBhcmcsIGFkZCApIHsKCQlhZGQgPSAoIGFkZCAhPT0gZmFsc2UgKTsKCQlhcmcgPSBzdHJpbmcuZXhwbG9kZSggYXJnLCAiICIgKTsKCgkJaWYgKCBhZGQgKSB7CgkJCWFycmF5LmVhY2goIGFyZywgZnVuY3Rpb24gKCBpICkgewoJCQkJb2JqLmNsYXNzTGlzdC5hZGQoIGkgKTsKCQkJfSApOwoJCX0KCQllbHNlIHsKCQkJYXJyYXkuZWFjaCggYXJnLCBmdW5jdGlvbiAoIGkgKSB7CgkJCQlpZiAoIGkgIT09ICIqIiApIHsKCQkJCQlvYmouY2xhc3NMaXN0LnJlbW92ZSggaSApOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJYXJyYXkuZWFjaCggb2JqLmNsYXNzTGlzdCwgZnVuY3Rpb24gKCB4ICkgewoJCQkJCQl0aGlzLnJlbW92ZSggeCApOwoJCQkJCX0gKTsKCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9ICk7CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIEZpbmRzIHRoZSBwb3NpdGlvbiBvZiBhbiBFbGVtZW50CgkgKgoJICogQG1ldGhvZCBwb3NpdGlvbgoJICogQG1lbWJlck9mIGVsZW1lbnQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqIEVsZW1lbnQKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgIENvb3JkaW5hdGVzIFtsZWZ0LCB0b3AsIHJpZ2h0LCBib3R0b21dCgkgKiBAZXhhbXBsZQoJICogdmFyIHBvcyA9IGtlaWdhaS51dGlsLmVsZW1lbnQucG9zaXRpb24oIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApICk7CgkgKi8KCXBvc2l0aW9uIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJb2JqID0gb2JqIHx8IGRvY3VtZW50LmJvZHk7CgkJdmFyIGxlZnQsIHRvcCwgcmlnaHQsIGJvdHRvbSwgaGVpZ2h0LCB3aWR0aDsKCgkJbGVmdCAgID0gdG9wID0gMDsKCQl3aWR0aCAgPSBvYmoub2Zmc2V0V2lkdGg7CgkJaGVpZ2h0ID0gb2JqLm9mZnNldEhlaWdodDsKCgkJaWYgKCBvYmoub2Zmc2V0UGFyZW50ICkgewoJCQl0b3AgICAgPSBvYmoub2Zmc2V0VG9wOwoJCQlsZWZ0ICAgPSBvYmoub2Zmc2V0TGVmdDsKCgkJCXdoaWxlICggb2JqID0gb2JqLm9mZnNldFBhcmVudCApIHsKCQkJCWxlZnQgKz0gb2JqLm9mZnNldExlZnQ7CgkJCQl0b3AgICs9IG9iai5vZmZzZXRUb3A7CgkJCX0KCgkJCXJpZ2h0ICA9IGRvY3VtZW50LmJvZHkub2Zmc2V0V2lkdGggIC0gKCBsZWZ0ICsgd2lkdGggKTsKCQkJYm90dG9tID0gZG9jdW1lbnQuYm9keS5vZmZzZXRIZWlnaHQgLSAoIHRvcCAgKyBoZWlnaHQgKTsKCQl9CgkJZWxzZSB7CgkJCXJpZ2h0ICA9IHdpZHRoOwoJCQlib3R0b20gPSBoZWlnaHQ7CgkJfQoKCQlyZXR1cm4gW2xlZnQsIHRvcCwgcmlnaHQsIGJvdHRvbV07Cgl9LAoKCS8qKgoJICogUHJlcGVuZHMgYW4gRWxlbWVudCB0byBhbiBFbGVtZW50CgkgKgoJICogQG1ldGhvZCBwcmVwZW5kQ2hpbGQKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiAgIEVsZW1lbnQKCSAqIEBwYXJhbSAge09iamVjdH0gY2hpbGQgQ2hpbGQgRWxlbWVudAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgICBFbGVtZW50CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC5wcmVwZW5kQ2hpbGQoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjdGFyZ2V0IiApLCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSApOwoJICovCglwcmVwZW5kQ2hpbGQgOiBmdW5jdGlvbiAoIG9iaiwgY2hpbGQgKSB7CgkJcmV0dXJuIG9iai5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMCA/IG9iai5hcHBlbmRDaGlsZCggY2hpbGQgKSA6IG9iai5pbnNlcnRCZWZvcmUoIGNoaWxkLCBvYmouY2hpbGROb2Rlc1swXSApOwoJfSwKCgkvKioKCSAqIFJlbW92ZXMgYW4gRWxlbWVudCBhdHRyaWJ1dGUKCSAqCgkgKiBAbWV0aG9kIHJlbW92ZUF0dHIKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiBFbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGtleSBBdHRyaWJ1dGUgbmFtZQoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQucmVtb3ZlQXR0ciggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggImEiICksICJocmVmIiApOwoJICovCglyZW1vdmVBdHRyIDogZnVuY3Rpb24gKCBvYmosIGtleSApIHsKCQl2YXIgdGFyZ2V0OwoKCQlpZiAoIHJlZ2V4LnN2Zy50ZXN0KCBvYmoubmFtZXNwYWNlVVJJICkgKSB7CgkJCW9iai5yZW1vdmVBdHRyaWJ1dGVOUyggb2JqLm5hbWVzcGFjZVVSSSwga2V5ICk7CgkJfQoJCWVsc2UgewoJCQlpZiAoIG9iai5ub2RlTmFtZSA9PT0gIlNFTEVDVCIgJiYga2V5ID09PSAic2VsZWN0ZWQiKSB7CgkJCQl0YXJnZXQgPSB1dGlsaXR5LmRvbSggIiMiICsgb2JqLmlkICsgIiBvcHRpb25bc2VsZWN0ZWQ9XCJzZWxlY3RlZFwiXSIgKVswXTsKCgkJCQlpZiAoIHRhcmdldCApIHsKCQkJCQl0YXJnZXQuc2VsZWN0ZWQgPSBmYWxzZTsKCQkJCQl0YXJnZXQucmVtb3ZlQXR0cmlidXRlKCAic2VsZWN0ZWQiICk7CgkJCQl9CgkJCX0KCQkJZWxzZSB7CgkJCQlvYmoucmVtb3ZlQXR0cmlidXRlKCBrZXkgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBTY3JvbGxzIHRvIHRoZSBwb3NpdGlvbiBvZiBhbiBFbGVtZW50CgkgKgoJICogQG1ldGhvZCBzY3JvbGxUbwoJICogQG1lbWJlck9mIGVsZW1lbnQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqICAgICAgICBFbGVtZW50IHRvIHNjcm9sbCB0bwoJICogQHBhcmFtICB7TnVtYmVyfSBtcyAgICAgICAgIFtPcHRpb25hbF0gTWlsbGlzZWNvbmRzIHRvIHNjcm9sbCwgZGVmYXVsdCBpcyAyNTAsIG1pbiBpcyAxMDAKCSAqIEBwYXJhbSAge051bWJlcn0gb2Zmc2V0VG9wICBbT3B0aW9uYWxdIE9mZnNldCBmcm9tIHRvcCBvZiBFbGVtZW50CgkgKiBAcGFyYW0gIHtOdW1iZXJ9IG9mZnNldExlZnQgW09wdGlvbmFsXSBPZmZzZXQgZnJvbSBsZWZ0IG9mIEVsZW1lbnQKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIERlZmVycmVkfQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuc2Nyb2xsVG8oIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApICkudGhlbiggZnVuY3Rpb24gKCkgewoJICogICAuLi4KCSAqIH0gKTsKCSAqLwoJc2Nyb2xsVG8gOiBmdW5jdGlvbiAoIG9iaiwgbXMsIG9mZnNldFRvcCwgb2Zmc2V0TGVmdCApIHsKCQl2YXIgcG9zID0gYXJyYXkucmVtb3ZlKCBlbGVtZW50LnBvc2l0aW9uKCBvYmogKSwgMiwgMyApOwoKCQlpZiAoICFpc05hTiggb2Zmc2V0VG9wICkgKSB7CgkJCXBvc1swXSArPSBvZmZzZXRUb3A7CgkJfQoKCQlpZiAoICFpc05hTiggb2Zmc2V0TGVmdCApICkgewoJCQlwb3NbMV0gKz0gb2Zmc2V0TGVmdDsKCQl9CgoJCXJldHVybiBjbGllbnQuc2Nyb2xsKCBwb3MsIG1zICk7Cgl9LAoKCS8qKgoJICogU2VyaWFsaXplcyB0aGUgZWxlbWVudHMgb2YgYW4gRWxlbWVudAoJICoKCSAqIEBtZXRob2Qgc2VyaWFsaXplCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSAgb2JqICAgIEVsZW1lbnQKCSAqIEBwYXJhbSAge0Jvb2xlYW59IHN0cmluZyBbT3B0aW9uYWxdIHRydWUgaWYgeW91IHdhbnQgYSBxdWVyeSBzdHJpbmcsIGRlZmF1bHQgaXMgZmFsc2UgKCBKU09OICkKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGVuY29kZSBbT3B0aW9uYWxdIHRydWUgaWYgeW91IHdhbnQgdG8gVVJJIGVuY29kZSB0aGUgdmFsdWUsIGRlZmF1bHQgaXMgdHJ1ZQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgICAgIFN0cmluZyBvciBPYmplY3QKCSAqIEBleGFtcGxlCgkgKiB2YXIgdXNlcklucHV0ID0ga2VpZ2FpLnV0aWwuZWxlbWVudC5zZXJpYWxpemUoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICJmb3JtIiApICk7CgkgKi8KCXNlcmlhbGl6ZSA6IGZ1bmN0aW9uICggb2JqLCBzdHJpbmcsIGVuY29kZSApIHsKCQlzdHJpbmcgICAgICAgPSAoIHN0cmluZyA9PT0gdHJ1ZSApOwoJCWVuY29kZSAgICAgICA9ICggZW5jb2RlICE9PSBmYWxzZSApOwoJCXZhciByZWdpc3RyeSA9IHt9LAoJCSAgICBjaGlsZHJlbiwgcmVzdWx0OwoKCQljaGlsZHJlbiA9IG9iai5ub2RlTmFtZSA9PT0gIkZPUk0iID8gKCBvYmouZWxlbWVudHMgPyBhcnJheS5jYXN0KCBvYmouZWxlbWVudHMgKSA6IG9iai5maW5kKCAiYnV0dG9uLCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSIgKSApIDogW29ial07CgoJCWFycmF5LmVhY2goIGNoaWxkcmVuLCBmdW5jdGlvbiAoIGkgKSB7CgkJCXZhciBpZCA9IGkuaWQgfHwgaS5uYW1lIHx8IGkudHlwZTsKCgkJCWlmICggaS5ub2RlTmFtZSA9PT0gIkZPUk0iICkgewoJCQkJdXRpbGl0eS5tZXJnZSggcmVnaXN0cnksIGpzb24uZGVjb2RlKCBlbGVtZW50LnNlcmlhbGl6ZSggaSApICkgKTsKCQkJfQoJCQllbHNlIGlmICggIXJlZ2lzdHJ5W2lkXSApIHsKCQkJCXJlZ2lzdHJ5W2lkXSA9IGVsZW1lbnQudmFsKCBpICk7CgkJCX0KCQl9ICk7CgoJCWlmICggIXN0cmluZyApIHsKCQkJcmVzdWx0ID0gcmVnaXN0cnk7CgkJfQoJCWVsc2UgewoJCQlyZXN1bHQgPSAiIjsKCgkJCXV0aWxpdHkuaXRlcmF0ZSggcmVnaXN0cnksIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCWVuY29kZSA/IHJlc3VsdCArPSAiJiIgKyBlbmNvZGVVUklDb21wb25lbnQoIGsgKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCggdiApIDogcmVzdWx0ICs9ICImIiArIGsgKyAiPSIgKyB2OwoJCQl9ICk7CgoJCQlyZXN1bHQgPSByZXN1bHQucmVwbGFjZSggcmVnZXguYW5kLCAiPyIgKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogUmV0dXJucyB0aGUgc2l6ZSBvZiB0aGUgRWxlbWVudAoJICoKCSAqIEBtZXRob2Qgc2l6ZQoJICogQG1lbWJlck9mIGVsZW1lbnQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqIEVsZW1lbnQKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgIFt3aWR0aCwgaGVpZ2h0XQoJICogQGV4YW1wbGUKCSAqIHZhciBzaXplID0ga2VpZ2FpLnV0aWwuZWxlbWVudC5zaXplKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSApOwoJICovCglzaXplIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIFsKCQkJb2JqLm9mZnNldFdpZHRoICArIG51bWJlci5wYXJzZSggb2JqLnN0eWxlLnBhZGRpbmdMZWZ0IHx8IDAgKSArIG51bWJlci5wYXJzZSggb2JqLnN0eWxlLnBhZGRpbmdSaWdodCAgfHwgMCApICsgbnVtYmVyLnBhcnNlKCBvYmouc3R5bGUuYm9yZGVyTGVmdCB8fCAwICkgKyBudW1iZXIucGFyc2UoIG9iai5zdHlsZS5ib3JkZXJSaWdodCAgfHwgMCApLAoJCQlvYmoub2Zmc2V0SGVpZ2h0ICsgbnVtYmVyLnBhcnNlKCBvYmouc3R5bGUucGFkZGluZ1RvcCAgfHwgMCApICsgbnVtYmVyLnBhcnNlKCBvYmouc3R5bGUucGFkZGluZ0JvdHRvbSB8fCAwICkgKyBudW1iZXIucGFyc2UoIG9iai5zdHlsZS5ib3JkZXJUb3AgIHx8IDAgKSArIG51bWJlci5wYXJzZSggb2JqLnN0eWxlLmJvcmRlckJvdHRvbSB8fCAwICkKCQldOwoJfSwKCgkvKioKCSAqIEdldHRlciAvIHNldHRlciBmb3IgYW4gRWxlbWVudCdzIHRleHQKCSAqCgkgKiBAbWV0aG9kIHRleHQKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiBFbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBbT3B0aW9uYWxdIFZhbHVlIHRvIHNldAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIHZhciBvYmogID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICksCgkgKiAgICAgdGV4dCA9IGtlaWdhaS51dGlsLmVsZW1lbnQudGV4dCggb2JqICk7CgkgKgoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC50ZXh0KCBvYmosIHRleHQgKyAiLCBhbmQgc29tZSBtb3JlIHRleHQiICk7CgkgKi8KCXRleHQgOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCXZhciBrZXkgICAgID0gb2JqLnRleHRDb250ZW50ID8gInRleHRDb250ZW50IiA6ICJpbm5lclRleHQiLAoJCSAgICBwYXlsb2FkID0ge30sCgkJICAgIHNldCAgICAgPSBmYWxzZTsKCgkJaWYgKCB0eXBlb2YgYXJnICE9ICJ1bmRlZmluZWQiICkgewoJCQlzZXQgICAgICAgICAgPSB0cnVlOwoJCQlwYXlsb2FkW2tleV0gPSBhcmc7CgkJfQoKCQlyZXR1cm4gc2V0ID8gZWxlbWVudC51cGRhdGUoIG9iaiwgcGF5bG9hZCApIDogb2JqW2tleV07Cgl9LAoKCS8qKgoJICogVG9nZ2xlcyBhIENTUyBjbGFzcwoJICoKCSAqIEBtZXRob2QgdG9nZ2xlQ2xhc3MKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiBFbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBDU1MgY2xhc3MgdG8gdG9nZ2xlCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBFbGVtZW50CgkgKiBAZXhhbXBsZQoJICogdmFyIG9iaiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApOwoJICoKCSAqIG9iai5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiAoIGV2ICkgewoJICogICBrZWlnYWkudXRpbC5lbGVtZW50LnRvZ2dsZUNsYXNzKCBvYmosICJhY3RpdmUiICk7CgkgKiB9LCBmYWxzZSApOwoJICovCgl0b2dnbGVDbGFzcyA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJb2JqLmNsYXNzTGlzdC50b2dnbGUoIGFyZyApOwoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFVwZGF0ZXMgYW4gRWxlbWVudAoJICoKCSAqIEBtZXRob2QgdXBkYXRlCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSAgb2JqICBFbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IGFyZ3MgUHJvcGVydGllcyB0byBzZXQKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICBFbGVtZW50CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC51cGRhdGUoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCB7aW5uZXJIVE1MOiAiSGVsbG8gV29ybGQhIiwgImNsYXNzIjogIm5ldyJ9ICk7CgkgKi8KCXVwZGF0ZSA6IGZ1bmN0aW9uICggb2JqLCBhcmdzICkgewoJCXV0aWxpdHkuaXRlcmF0ZSggYXJncywgZnVuY3Rpb24gKCB2LCBrICkgewoJCQlpZiAoIHJlZ2V4LmVsZW1lbnRfdXBkYXRlLnRlc3QoIGsgKSApIHsKCQkJCW9ialtrXSA9IHY7CgkJCX0KCQkJZWxzZSBpZiAoIGsgPT09ICJjbGFzcyIgKSB7CgkJCQkhc3RyaW5nLmlzRW1wdHkoIHYgKSA/IGVsZW1lbnQua2xhc3MoIG9iaiwgdiApIDogZWxlbWVudC5rbGFzcyggb2JqLCAiKiIsIGZhbHNlICk7CgkJCX0KCQkJZWxzZSBpZiAoIGsuaW5kZXhPZiggImRhdGEtIiApID09PSAwICkgewoJCQkJZWxlbWVudC5kYXRhKCBvYmosIGsucmVwbGFjZSggImRhdGEtIiwgIiIgKSwgdiApOwoJCQl9CgkJCWVsc2UgewoJCQkJZWxlbWVudC5hdHRyICggb2JqLCBrLCB2ICk7CgkJCX0KCQl9ICk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogR2V0cyBvciBzZXRzIHRoZSB2YWx1ZSBvZiBFbGVtZW50CgkgKgoJICogQG1ldGhvZCB2YWwKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiAgIEVsZW1lbnQKCSAqIEBwYXJhbSAge01peGVkfSAgdmFsdWUgW09wdGlvbmFsXSBWYWx1ZSB0byBzZXQKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQudmFsKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiaW5wdXRbdHlwZT0ndGV4dCddIiApLCAibmV3IHZhbHVlIiApOwoJICovCgl2YWwgOiBmdW5jdGlvbiAoIG9iaiwgdmFsdWUgKSB7CgkJdmFyIGV2ID0gImlucHV0IiwKCQkgICAgb3V0cHV0OwoKCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCWlmICggcmVnZXgucmFkaW9fY2hlY2tib3gudGVzdCggb2JqLnR5cGUgKSApIHsKCQkJCWlmICggc3RyaW5nLmlzRW1wdHkoIG9iai5uYW1lICkgKSB7CgkJCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5leHBlY3RlZFByb3BlcnR5ICk7CgkJCQl9CgoJCQkJYXJyYXkuZWFjaCggdXRpbGl0eS5kb20oICJpbnB1dFtuYW1lPSciICsgb2JqLm5hbWUgKyAiJ10iICksIGZ1bmN0aW9uICggaSApIHsKCQkJCQlpZiAoIGkuY2hlY2tlZCApIHsKCQkJCQkJb3V0cHV0ID0gaS52YWx1ZTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0gKTsKCQkJfQoJCQllbHNlIGlmICggcmVnZXguc2VsZWN0LnRlc3QoIG9iai50eXBlICkgKSB7CgkJCQlvdXRwdXQgPSBvYmoub3B0aW9uc1tvYmouc2VsZWN0ZWRJbmRleF0udmFsdWU7CgkJCX0KCQkJZWxzZSBpZiAoIG9iai52YWx1ZSApIHsKCQkJCW91dHB1dCA9IG9iai52YWx1ZTsKCQkJfQoJCQllbHNlIHsKCQkJCW91dHB1dCA9IGVsZW1lbnQudGV4dCggb2JqICk7CgkJCX0KCgkJCWlmICggb3V0cHV0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvdXRwdXQgPSB1dGlsaXR5LmNvZXJjZSggb3V0cHV0ICk7CgoJCQkJaWYgKCB0eXBlb2Ygb3V0cHV0ID09ICJzdHJpbmciICkgewoJCQkJCW91dHB1dCA9IHN0cmluZy50cmltKCBvdXRwdXQgKTsKCQkJCX0KCQkJfQoJCQllbHNlIHsKCQkJCW91dHB1dCA9ICIiOwoJCQl9CgkJfQoJCWVsc2UgewoJCQl2YWx1ZSA9IHZhbHVlLnRvU3RyaW5nKCk7CgoJCQlpZiAoIHJlZ2V4LnJhZGlvX2NoZWNrYm94LnRlc3QoIG9iai50eXBlICkgKSB7CgkJCQlldiA9ICJjbGljayI7CgoJCQkJYXJyYXkuZWFjaCggdXRpbGl0eS5kb20oICJpbnB1dFtuYW1lPSciICsgb2JqLm5hbWUgKyAiJ10iICksIGZ1bmN0aW9uICggaSApIHsKCQkJCQlpZiAoIGkudmFsdWUgPT09IHZhbHVlICkgewoJCQkJCQlpLmNoZWNrZWQgPSB0cnVlOwoJCQkJCQlvdXRwdXQgPSBpOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSApOwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5zZWxlY3QudGVzdCggb2JqLnR5cGUgKSApIHsKCQkJCWV2ID0gImNoYW5nZSI7CgoJCQkJYXJyYXkuZWFjaCggZWxlbWVudC5maW5kKCBvYmosICI+ICoiICksIGZ1bmN0aW9uICggaSApIHsKCQkJCQlpZiAoIGkudmFsdWUgPT09IHZhbHVlICkgewoJCQkJCQlpLnNlbGVjdGVkID0gdHJ1ZTsKCQkJCQkJb3V0cHV0ID0gaTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0gKTsKCQkJfQoJCQllbHNlIHsKCQkJCW9iai52YWx1ZSAhPT0gdW5kZWZpbmVkID8gb2JqLnZhbHVlID0gdmFsdWUgOiBlbGVtZW50LnRleHQoIG9iaiwgdmFsdWUgKTsKCQkJfQoKCQkJZWxlbWVudC5kaXNwYXRjaCggb2JqLCBldiApOwoKCQkJb3V0cHV0ID0gb2JqOwoJCX0KCgkJcmV0dXJuIG91dHB1dDsKCX0KfTsKCi8qKgogKiBAbmFtZXNwYWNlIGpzb24KICovCnZhciBqc29uID0gewoJLyoqCgkgKiBEZWNvZGVzIHRoZSBhcmd1bWVudAoJICoKCSAqIEBtZXRob2QgZGVjb2RlCgkgKiBAbWVtYmVyT2YganNvbgoJICogQHBhcmFtICB7U3RyaW5nfSAgYXJnICAgIFN0cmluZyB0byBwYXJzZQoJICogQHBhcmFtICB7Qm9vbGVhbn0gc2lsZW50IFtPcHRpb25hbF0gU2lsZW50bHkgZmFpbAoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgICAgIEVudGl0eSByZXN1bHRpbmcgZnJvbSBwYXJzaW5nIEpTT04sIG9yIHVuZGVmaW5lZAoJICogQGV4YW1wbGUKCSAqIHZhciB4ID0ga2VpZ2FpLnV0aWwuanNvbi5kZWNvZGUoIC4uLiwgdHJ1ZSApOwoJICoKCSAqIGlmICggeCApIHsKCSAqICAgLi4uCgkgKiB9CgkgKiBlbHNlIHsKCSAqICAgLi4uIC8vIGludmFsaWQgSlNPTiwgd2l0aCBgRXJyb3JgIHN1cHByZXNzZWQgYnkgYHNpbGVudGAKCSAqIH0KCSAqLwoJZGVjb2RlIDogZnVuY3Rpb24gKCBhcmcsIHNpbGVudCApIHsKCQl0cnkgewoJCQlyZXR1cm4gSlNPTi5wYXJzZSggYXJnICk7CgkJfQoJCWNhdGNoICggZSApIHsKCQkJaWYgKCBzaWxlbnQgIT09IHRydWUgKSB7CgkJCQl1dGlsaXR5LmVycm9yKCBlLCBhcmd1bWVudHMsIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9Cgl9LAoKCS8qKgoJICogRW5jb2RlcyBgYXJnYCBhcyBKU09OCgkgKgoJICogQG1ldGhvZCBlbmNvZGUKCSAqIEBtZW1iZXJPZiBqc29uCgkgKiBAcGFyYW0gIHtNaXhlZH0gICBhcmcgICAgUHJpbWF0aXZlCgkgKiBAcGFyYW0gIHtCb29sZWFufSBzaWxlbnQgW09wdGlvbmFsXSBTaWxlbnRseSBmYWlsCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgICAgSlNPTiwgb3IgdW5kZWZpbmVkCgkgKiBAZXhhbXBsZQoJICogdmFyIHggPSBrZWlnYWkudXRpbC5qc29uLmVuY29kZSggLi4uLCB0cnVlICk7CgkgKgoJICogaWYgKCB4ICkgewoJICogICAuLi4KCSAqIH0KCSAqIGVsc2UgewoJICogICAuLi4gLy8gaW52YWxpZCBKU09OLCB3aXRoIGBFcnJvcmAgc3VwcHJlc3NlZCBieSBgc2lsZW50YAoJICogfQoJICovCgllbmNvZGUgOiBmdW5jdGlvbiAoIGFyZywgc2lsZW50ICkgewoJCXRyeSB7CgkJCXJldHVybiBKU09OLnN0cmluZ2lmeSggYXJnICk7CgkJfQoJCWNhdGNoICggZSApIHsKCQkJaWYgKCBzaWxlbnQgIT09IHRydWUgKSB7CgkJCQl1dGlsaXR5LmVycm9yKCBlLCBhcmd1bWVudHMsIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9Cgl9Cn07CgovKioKICogQG5hbWVzcGFjZSBsYWJlbAogKiBAcHJpdmF0ZQogKi8KdmFyIGxhYmVsID0gewoJLyoqCgkgKiBFeHBlY3RlZCBhIE51bWJlcgoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJZXhwZWN0ZWROdW1iZXIgOiAiRXhwZWN0ZWQgYSBOdW1iZXIiLAoKCS8qKgoJICogRXhwZWN0ZWQgYSBwcm9wZXJ0eSwgYW5kIGl0IHdhcyBub3Qgc2V0CgkgKgoJICogQHR5cGUge1N0cmluZ30KCSAqIEBtZW1iZXJPZiBsYWJlbAoJICovCglleHBlY3RlZFByb3BlcnR5IDogIkV4cGVjdGVkIGEgcHJvcGVydHksIGFuZCBpdCB3YXMgbm90IHNldCIsCgoJLyoqCgkgKiBFeHBlY3RlZCBhbiBPYmplY3QKCSAqCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQG1lbWJlck9mIGxhYmVsCgkgKi8KCWV4cGVjdGVkT2JqZWN0IDogIkV4cGVjdGVkIGFuIE9iamVjdCIsCgoJLyoqCgkgKiBPbmUgb3IgbW9yZSBhcmd1bWVudHMgaXMgaW52YWxpZAoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJaW52YWxpZEFyZ3VtZW50cyA6ICJPbmUgb3IgbW9yZSBhcmd1bWVudHMgaXMgaW52YWxpZCIsCgoJLyoqCgkgKiBJTlZBTElEX1NUQVRFX0VSUjogSGVhZGVycyBoYXZlIG5vdCBiZWVuIHJlY2VpdmVkCgkgKgoJICogQHR5cGUge1N0cmluZ30KCSAqIEBtZW1iZXJPZiBsYWJlbAoJICovCglpbnZhbGlkU3RhdGVOb0hlYWRlcnMgOiAiSU5WQUxJRF9TVEFURV9FUlI6IEhlYWRlcnMgaGF2ZSBub3QgYmVlbiByZWNlaXZlZCIsCgoJLyoqCgkgKiBTeW5jaHJvbm91cyBYTUxIdHRwUmVxdWVzdCByZXF1ZXN0cyBhcmUgbm90IHN1cHBvcnRlZAoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJaW52YWxpZFN0YXRlTm9TeW5jIDogIlN5bmNocm9ub3VzIFhNTEh0dHBSZXF1ZXN0IHJlcXVlc3RzIGFyZSBub3Qgc3VwcG9ydGVkIiwKCgkvKioKCSAqIElOVkFMSURfU1RBVEVfRVJSOiBPYmplY3QgaXMgbm90IG9wZW4KCSAqCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQG1lbWJlck9mIGxhYmVsCgkgKi8KCWludmFsaWRTdGF0ZU5vdE9wZW4gOiAiSU5WQUxJRF9TVEFURV9FUlI6IE9iamVjdCBpcyBub3Qgb3BlbiIsCgoJLyoqCgkgKiBJTlZBTElEX1NUQVRFX0VSUjogT2JqZWN0IGlzIHNlbmRpbmcKCSAqCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQG1lbWJlck9mIGxhYmVsCgkgKi8KCWludmFsaWRTdGF0ZU5vdFNlbmRpbmcgOiAiSU5WQUxJRF9TVEFURV9FUlI6IE9iamVjdCBpcyBzZW5kaW5nIiwKCgkvKioKCSAqIElOVkFMSURfU1RBVEVfRVJSOiBPYmplY3QgaXMgbm90IHVzYWJsZQoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJaW52YWxpZFN0YXRlTm90VXNhYmxlIDogIklOVkFMSURfU1RBVEVfRVJSOiBPYmplY3QgaXMgbm90IHVzYWJsZSIsCgoJLyoqCgkgKiBEZWZhdWx5IGBlbXB0eU1zZ2Agb2YgRGF0YUxpc3RzCgkgKgoJICogQHR5cGUge1N0cmluZ30KCSAqIEBtZW1iZXJPZiBsYWJlbAoJICovCglub0RhdGEgOiAiTm90aGluZyB0byBkaXNwbGF5IiwKCgkvKioKCSAqIFJlcXVlc3RlZCBtZXRob2QgaXMgbm90IGF2YWlsYWJsZQoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJbm90QXZhaWxhYmxlIDogIlJlcXVlc3RlZCBtZXRob2QgaXMgbm90IGF2YWlsYWJsZSIsCgoJLyoqCgkgKiBObyBwcmV2aW91cyB2ZXJzaW9uIG9mIGEgcmVjb3JkCgkgKgoJICogQHR5cGUge1N0cmluZ30KCSAqIEBtZW1iZXJPZiBsYWJlbAoJICovCglkYXRhc3RvcmVOb1ByZXZWZXJzaW9uIDogIk5vIHByZXZpb3VzIHZlcnNpb24gZm91bmQiLAoKCS8qKgoJICogU2VydmVyIGVycm9yIGhhcyBvY2N1cnJlZAoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJc2VydmVyRXJyb3IgOiAiU2VydmVyIGVycm9yIGhhcyBvY2N1cnJlZCIsCgoJLyoqCgkgKiBGb3JiaWRkZW4gdG8gYWNjZXNzIFVSSQoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJc2VydmVyRm9yYmlkZGVuIDogIkZvcmJpZGRlbiB0byBhY2Nlc3MgVVJJIiwKCgkvKioKCSAqIE1ldGhvZCBub3QgYWxsb3dlZAoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJc2VydmVySW52YWxpZE1ldGhvZCA6ICJNZXRob2Qgbm90IGFsbG93ZWQiLAoKCS8qKgoJICogQXV0aG9yaXphdGlvbiByZXF1aXJlZCB0byBhY2Nlc3MgVVJJCgkgKgoJICogQHR5cGUge1N0cmluZ30KCSAqIEBtZW1iZXJPZiBsYWJlbAoJICovCglzZXJ2ZXJVbmF1dGhvcml6ZWQgOiAiQXV0aG9yaXphdGlvbiByZXF1aXJlZCB0byBhY2Nlc3MgVVJJIiwKCgkvKioKCSAqIFlvdXIgYnJvd3NlciBpcyB0b28gb2xkIHRvIHVzZSBrZWlnYWksIHBsZWFzZSB1cGdyYWRlCgkgKgoJICogQHR5cGUge1N0cmluZ30KCSAqIEBtZW1iZXJPZiBsYWJlbAoJICovCgl1cGdyYWRlIDogIllvdXIgYnJvd3NlciBpcyB0b28gb2xkIHRvIHVzZSBrZWlnYWksIHBsZWFzZSB1cGdyYWRlIgp9OwoKLyoqCiAqIEBuYW1lc3BhY2UgbWF0aAogKi8KdmFyIG1hdGggPSB7CgkvKioKCSAqIEdlbmVyYXRlcyBiZXppZXIgY3VydmUgY29vcmRpbmF0ZXMgZm9yIHVwIHRvIDQgcG9pbnRzLCBsYXN0IHBhcmFtZXRlciBpcyBgdGAKCSAqCgkgKiBUd28gcG9pbnQgZXhhbXBsZTogKDAsIDEwLCAwLCAwLCAxKSBtZWFucyBtb3ZlIHN0cmFpZ2h0IHVwCgkgKgoJICogQG1ldGhvZCBiZXppZXIKCSAqIEBtZW1iZXJPZiBtYXRoCgkgKiBAcmV0dXJuIHtBcnJheX0gQ29vcmRpbmF0ZXMKCSAqIEBleGFtcGxlCgkgKiAvLyBNb3Zpbmcgc3RyYWlnaHQgZG93bgoJICogdmFyIHAxID0ga2VpZ2FpLnV0aWwubWF0aC5iZXppZXIoIDAsIDEwLCAyMDAwLCAxMCwgMCApLAoJICogICAgIHAyID0ga2VpZ2FpLnV0aWwubWF0aC5iZXppZXIoIDAsIDEwLCAyMDAwLCAxMCwgMC41ICksCgkgKiAgICAgcDMgPSBrZWlnYWkudXRpbC5tYXRoLmJlemllciggMCwgMTAsIDIwMDAsIDEwLCAwLjc1ICksCgkgKiAgICAgcDQgPSBrZWlnYWkudXRpbC5tYXRoLmJlemllciggMCwgMTAsIDIwMDAsIDEwLCAwLjkgKSwKCSAqICAgICBwNSA9IGtlaWdhaS51dGlsLm1hdGguYmV6aWVyKCAwLCAxMCwgMjAwMCwgMTAsIDEgKTsKCSAqLwoJYmV6aWVyIDogZnVuY3Rpb24gKCkgewoJCXZhciBhID0gYXJyYXkuY2FzdCggYXJndW1lbnRzICksCgkJICAgIHQgPSBhLnBvcCgpLAoJCSAgICBQID0gYXJyYXkuY2h1bmsoIGEsIDIgKSwKCQkgICAgbiA9IFAubGVuZ3RoLAoJCSAgICBjLCBTMCwgUTAsIFExLCBRMiwgQzAsIEMxLCBDMiwgQzM7CgoJCWlmICggbiA8IDIgfHwgbiA+IDQgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApOwoJCX0KCgkJLy8gU2V0dGluZyB2YXJpYWJsZXMKCQljICA9IFtdOwoJCVMwID0gMSAtIHQ7CgkJUTAgPSBtYXRoLnNxciggUzAgKTsKCQlRMSA9IDIgKiBTMCAqIHQ7CgkJUTIgPSBtYXRoLnNxciggdCApOwoJCUMwID0gTWF0aC5wb3coIFMwLCAzICk7CgkJQzEgPSAzICogUTAgKiB0OwoJCUMyID0gMyAqIFMwICogUTI7CgkJQzMgPSBNYXRoLnBvdyggdCwgMyApOwoKCQkvLyBTdHJhaWdodAoJCWlmICggbiA9PT0gMiApIHsKCQkJYy5wdXNoKCAoIFMwICogUFswXVswXSApICsgKCB0ICogUFsxXVswXSApICk7CgkJCWMucHVzaCggKCBTMCAqIFBbMF1bMV0gKSArICggdCAqIFBbMV1bMV0gKSApOwoJCX0KCQkvLyBRdWFkcmF0aWMKCQllbHNlIGlmICggbiA9PT0gMyApIHsKCQkJYy5wdXNoKCAoIFEwICogUFswXVswXSApICsgKCBRMSAqIFBbMV1bMF0gKSArICggUTIgKyBQWzJdWzBdICkgKTsKCQkJYy5wdXNoKCAoIFEwICogUFswXVsxXSApICsgKCBRMSAqIFBbMV1bMV0gKSArICggUTIgKyBQWzJdWzFdICkgKTsKCQl9CgkJLy8gQ3ViaWMKCQllbHNlIGlmICggbiA9PT0gNCApIHsKCQkJYy5wdXNoKCAoIEMwICogUFswXVswXSApICsgKCBDMSAqIFBbMV1bMF0gKSArICggQzIgKiBQWzJdWzBdICkgKyAoIEMzICogUFszXVswXSApICk7CgkJCWMucHVzaCggKCBDMCAqIFBbMF1bMV0gKSArICggQzEgKiBQWzFdWzFdICkgKyAoIEMyICogUFsyXVsxXSApICsgKCBDMyAqIFBbM11bMV0gKSApOwoJCX0KCgkJcmV0dXJuIGM7Cgl9LAoKCS8qKgoJICogRmluZHMgdGhlIGRpc3RhbmNlIGJldHdlZW4gMiBBcnJheXMgb2YgY29vcmRpbmF0ZXMKCSAqCgkgKiBAbWV0aG9kIGRpc3QKCSAqIEBtZW1iZXJPZiBtYXRoCgkgKiBAcGFyYW0gIHtBcnJheX0gYSBDb29yZGluYXRlcyBbeCwgeV0KCSAqIEBwYXJhbSAge0FycmF5fSBiIENvb3JkaW5hdGVzIFt4LCB5XQoJICogQHJldHVybiB7TnVtYmVyfSAgRGlzdGFuY2UgYmV0d2VlbiBgYWAgJiBgYmAKCSAqIEBleGFtcGxlCgkgKiB2YXIgZGlzdCA9IGtlaWdhaS51dGlsLm1hdGguZGlzdCggWzQsIDQwXSwgWy0xMCwgMTJdICk7CgkgKi8KCWRpc3QgOiBmdW5jdGlvbiAoIGEsIGIgKSB7CgkJcmV0dXJuIE1hdGguc3FydCggbWF0aC5zcXIoIGJbMF0gLSBhWzBdICkgKyBtYXRoLnNxciggYlsxXSAtIGFbMV0gKSApOwoJfSwKCgkvKioKCSAqIFNxdWFyZXMgYSBOdW1iZXIKCSAqCgkgKiBAbWV0aG9kIHNxcgoJICogQG1lbWJlck9mIG1hdGgKCSAqIEBwYXJhbSAge051bWJlcn0gbiBOdW1iZXIgdG8gc3F1YXJlCgkgKiBAcmV0dXJuIHtOdW1iZXJ9ICAgU3F1YXJlZCB2YWx1ZQoJICogQGV4YW1wbGUKCSAqIHZhciBzcXIgPSBrZWlnYWkudXRpbC5tYXRoLnNxciggMjMgKTsKCSAqLwoJc3FyIDogZnVuY3Rpb24gKCBuICkgewoJCXJldHVybiBNYXRoLnBvdyggbiwgMiApOwoJfQp9OwoKLyoqCiAqIEBuYW1lc3BhY2UgbnVtYmVyCiAqLwp2YXIgbnVtYmVyID0gewoJLyoqCgkgKiBSZXR1cm5zIHRoZSBkaWZmZXJlbmNlIG9mIGFyZwoJICoKCSAqIEBtZXRob2QgZGlmZgoJICogQG1lbWJlck9mIG51bWJlcgoJICogQHBhcmFtIHtOdW1iZXJ9IGFyZyBOdW1iZXIgdG8gY29tcGFyZQoJICogQHJldHVybiB7TnVtYmVyfSAgICBUaGUgYWJzb2x1dGUgZGlmZmVyZW5jZQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLm51bWJlci5kaWZmKCAtMywgOCApOyAvLyAxMQoJICovCglkaWZmIDogZnVuY3Rpb24gKCBudW0xLCBudW0yICkgewoJCWlmICggaXNOYU4oIG51bTEgKSB8fCBpc05hTiggbnVtMiApICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmV4cGVjdGVkTnVtYmVyICk7CgkJfQoKCQlyZXR1cm4gTWF0aC5hYnMoIG51bTEgLSBudW0yICk7Cgl9LAoKCS8qKgoJICogVGVzdHMgaWYgYW4gbnVtYmVyIGlzIGV2ZW4KCSAqCgkgKiBAbWV0aG9kIGV2ZW4KCSAqIEBtZW1iZXJPZiBudW1iZXIKCSAqIEBwYXJhbSB7TnVtYmVyfSBhcmcgTnVtYmVyIHRvIHRlc3QKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgVHJ1ZSBpZiBldmVuLCBvciB1bmRlZmluZWQKCSAqIEBleGFtcGxlCgkgKiB2YXIgbiA9IGtlaWdhaS51dGlsLm51bWJlci5yYW5kb20oIDEwICk7CgkgKgoJICogaWYgKCBrZWlnYWkudXRpbC5udW1iZXIuZXZlbiggbiApICkgewoJICogICAuLi4KCSAqIH0KCSAqLwoJZXZlbiA6IGZ1bmN0aW9uICggYXJnICkgewoJCXJldHVybiBhcmcgJSAyID09PSAwOwoJfSwKCgkvKioKCSAqIEZvcm1hdHMgYSBOdW1iZXIgdG8gYSBkZWxpbWl0ZWQgU3RyaW5nCgkgKgoJICogQG1ldGhvZCBmb3JtYXQKCSAqIEBtZW1iZXJPZiBudW1iZXIKCSAqIEBwYXJhbSAge051bWJlcn0gYXJnICAgICAgIE51bWJlciB0byBmb3JtYXQKCSAqIEBwYXJhbSAge1N0cmluZ30gZGVsaW1pdGVyIFtPcHRpb25hbF0gU3RyaW5nIHRvIGRlbGltaXQgdGhlIE51bWJlciB3aXRoCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGV2ZXJ5ICAgICBbT3B0aW9uYWxdIFBvc2l0aW9uIHRvIGluc2VydCB0aGUgZGVsaW1pdGVyLCBkZWZhdWx0IGlzIDMKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgICAgICAgIE51bWJlciByZXByZXNlbnRlZCBhcyBhIGNvbW1hIGRlbGltaXRlZCBTdHJpbmcKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5udW1iZXIuZm9ybWF0KCAxMDAwICk7IC8vICIxLDAwMCIKCSAqLwoJZm9ybWF0IDogZnVuY3Rpb24gKCBhcmcsIGRlbGltaXRlciwgZXZlcnkgKSB7CgkJaWYgKCBpc05hTiggYXJnICkgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuZXhwZWN0ZWROdW1iZXIgKTsKCQl9CgoJCWFyZyAgICAgICA9IGFyZy50b1N0cmluZygpOwoJCWRlbGltaXRlciA9IGRlbGltaXRlciB8fCAiLCI7CgkJZXZlcnkgICAgID0gZXZlcnkgICAgIHx8IDM7CgoJCXZhciBkID0gYXJnLmluZGV4T2YoICIuIiApID4gLTEgPyAiLiIgKyBhcmcucmVwbGFjZSggcmVnZXgubnVtYmVyX2Zvcm1hdF8xLCAiIiApIDogIiIsCgkJICAgIGEgPSBhcmcucmVwbGFjZSggcmVnZXgubnVtYmVyX2Zvcm1hdF8yLCAiIiApLnNwbGl0KCAiIiApLnJldmVyc2UoKSwKCQkgICAgcCA9IE1hdGguZmxvb3IoIGEubGVuZ3RoIC8gZXZlcnkgKSwKCQkgICAgaSA9IDEsIG4sIGI7CgoJCWZvciAoIGIgPSAwOyBiIDwgcDsgYisrICkgewoJCQluID0gaSA9PT0gMSA/IGV2ZXJ5IDogKCBldmVyeSAqIGkgKSArICggaSA9PT0gMiA/IDEgOiAoIGkgLSAxICkgKTsKCQkJYS5zcGxpY2UoIG4sIDAsIGRlbGltaXRlciApOwoJCQlpKys7CgkJfQoKCQlhID0gYS5yZXZlcnNlKCkuam9pbiggIiIgKTsKCgkJaWYgKCBhLmNoYXJBdCggMCApID09PSBkZWxpbWl0ZXIgKSB7CgkJCWEgPSBhLnN1YnN0cmluZyggMSApOwoJCX0KCgkJcmV0dXJuIGEgKyBkOwoJfSwKCgkvKioKCSAqIFJldHVybnMgaGFsZiBvZiBhLCBvciB0cnVlIGlmIGEgaXMgaGFsZiBvZiBiCgkgKgoJICogQG1ldGhvZCBoYWxmCgkgKiBAbWVtYmVyT2YgbnVtYmVyCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGEgTnVtYmVyIHRvIGRpdmlkZQoJICogQHBhcmFtICB7TnVtYmVyfSBiIFtPcHRpb25hbF0gTnVtYmVyIHRvIHRlc3QgYSBhZ2FpbnN0CgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgQm9vbGVhbiBpZiBiIGlzIHBhc3NlZCwgTnVtYmVyIGlmIGIgaXMgdW5kZWZpbmVkCgkgKiBAZXhhbXBsZQoJICogaWYgKCBrZWlnYWkudXRpbC5udW1iZXIuaGFsZiggMiwgNCApICkgewoJICogICAuLi4KCSAqIH0gKTsKCSAqLwoJaGFsZiA6IGZ1bmN0aW9uICggYSwgYiApIHsKCQlyZXR1cm4gYiA/ICggKCBhIC8gYiApID09PSAwLjUgKSA6ICggYSAvIDIgKTsKCX0sCgoJLyoqCgkgKiBUZXN0cyBpZiBhIG51bWJlciBpcyBvZGQKCSAqCgkgKiBAbWV0aG9kIG9kZAoJICogQG1lbWJlck9mIG51bWJlcgoJICogQHBhcmFtICB7TnVtYmVyfSBhcmcgTnVtYmVyIHRvIHRlc3QKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgIFRydWUgaWYgb2RkLCBvciB1bmRlZmluZWQKCSAqIEBleGFtcGxlCgkgKiB2YXIgbiA9IGtlaWdhaS51dGlsLm51bWJlci5yYW5kb20oIDEwICk7CgkgKgoJICogaWYgKCBrZWlnYWkudXRpbC5udW1iZXIub2RkKCBuICkgKSB7CgkgKiAgIC4uLgoJICogfQoJICovCglvZGQgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQlyZXR1cm4gIW51bWJlci5ldmVuKCBhcmcgKTsKCX0sCgoJLyoqCgkgKiBQYXJzZXMgdGhlIG51bWJlcgoJICoKCSAqIEBtZXRob2QgcGFyc2UKCSAqIEBtZW1iZXJPZiBudW1iZXIKCSAqIEBwYXJhbSAge01peGVkfSAgYXJnICBOdW1iZXIgdG8gcGFyc2UKCSAqIEBwYXJhbSAge051bWJlcn0gYmFzZSBJbnRlZ2VyIHJlcHJlc2VudGluZyB0aGUgYmFzZSBvciByYWRpeAoJICogQHJldHVybiB7TnVtYmVyfSAgICAgIEludGVnZXIgb3IgZmxvYXQKCSAqIEBleGFtcGxlCgkgKiAvLyBVbnN1cmUgaWYgYG5gIGlzIGFuIGludCBvciBhIGZsb2F0CgkgKiBrZWlnYWkudXRpbC5udW1iZXIucGFyc2UoIG4gKTsKCSAqLwoJcGFyc2UgOiBmdW5jdGlvbiAoIGFyZywgYmFzZSApIHsKCQlyZXR1cm4gKCBiYXNlID09PSB1bmRlZmluZWQgKSA/IHBhcnNlRmxvYXQoIGFyZyApIDogcGFyc2VJbnQoIGFyZywgYmFzZSApOwoJfSwKCgkvKioKCSAqIEdlbmVyYXRlcyBhIHJhbmRvbSBudW1iZXIgYmV0d2VlbiAwIGFuZCBgYXJnYAoJICoKCSAqIEBtZXRob2QgcmFuZG9tCgkgKiBAbWVtYmVyT2YgbnVtYmVyCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGFyZyBDZWlsaW5nIGZvciByYW5kb20gbnVtYmVyLCBkZWZhdWx0IGlzIDEwMAoJICogQHJldHVybiB7TnVtYmVyfSAgICAgUmFuZG9tIG51bWJlcgoJICogQGV4YW1wbGUKCSAqIHZhciBuID0ga2VpZ2FpLnV0aWwubWF0aC5yYW5kb20oIDEwICk7CgkgKi8KCXJhbmRvbSA6IGZ1bmN0aW9uICggYXJnICkgewoJCWFyZyA9IGFyZyB8fCAxMDA7CgoJCXJldHVybiBNYXRoLmZsb29yKCBNYXRoLnJhbmRvbSgpICogKCBhcmcgKyAxICkgKTsKCX0sCgoJLyoqCgkgKiBSb3VuZHMgYSBudW1iZXIgdXAgb3IgZG93bgoJICoKCSAqIEBtZXRob2Qgcm91bmQKCSAqIEBtZW1iZXJPZiBudW1iZXIKCSAqIEBwYXJhbSAge051bWJlcn0gYXJnICAgICAgIE51bWJlciB0byByb3VuZAoJICogQHBhcmFtICB7U3RyaW5nfSBkaXJlY3Rpb24gW09wdGlvbmFsXSAidXAiIG9yICJkb3duIgoJICogQHJldHVybiB7TnVtYmVyfSAgICAgICAgICAgUm91bmRlZCBpbnRlcmdlcgoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLm1hdGgucm91bmQoIG4sICJkb3duIiApOwoJICovCglyb3VuZCA6IGZ1bmN0aW9uICggYXJnLCBkaXJlY3Rpb24gKSB7CgkJYXJnID0gbnVtYmVyLnBhcnNlKCBhcmcgKTsKCgkJaWYgKCBkaXJlY3Rpb24gPT09IHVuZGVmaW5lZCB8fCBzdHJpbmcuaXNFbXB0eSggZGlyZWN0aW9uICkgKSB7CgkJCXJldHVybiBudW1iZXIucGFyc2UoIGFyZy50b0ZpeGVkKCAwICkgKTsKCQl9CgkJZWxzZSBpZiAoIHJlZ2V4LmRvd24udGVzdCggZGlyZWN0aW9uICkgKSB7CgkJCXJldHVybiB+figgYXJnICk7CgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gTWF0aC5jZWlsKCBhcmcgKTsKCQl9Cgl9Cn07CgovKioKICogQG5hbWVzcGFjZSBwcm9taXNlCiAqLwp2YXIgcHJvbWlzZSA9IHsKCS8qKgoJICogIlVuYm94ZWQiIFByb21pc2UgZmFjdG9yeQoJICoKCSAqIEBtZXRob2QgZmFjdG9yeQoJICogQG1lbWJlck9mIHByb21pc2UKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIFByb21pc2V9CgkgKi8KCWZhY3RvcnkgOiBmdW5jdGlvbiAoKSB7CgkJdmFyIHByb21pc2UsIHBDYXRjaCwgcFJlc29sdmUsIHBSZWplY3QsIHBUaGVuOwoJCQoJCXByb21pc2UgPSBuZXcgUHJvbWlzZSggZnVuY3Rpb24gKCByZXNvbHZlLCByZWplY3QgKSB7CgkJCXBSZXNvbHZlID0gcmVzb2x2ZTsKCQkJcFJlamVjdCAgPSByZWplY3Q7CgkJfSApOwoKCQlwQ2F0Y2ggPSBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBwcm9taXNlWyJjYXRjaCJdLmFwcGx5KCBwcm9taXNlLCBhcmd1bWVudHMgKTsKCQl9OwoKCQlwVGhlbiA9IGZ1bmN0aW9uICgpIHsKCQkJcmV0dXJuIHByb21pc2UudGhlbi5hcHBseSggcHJvbWlzZSwgYXJndW1lbnRzICk7CgkJfTsKCgkJcmV0dXJuIHsiY2F0Y2giOiBwQ2F0Y2gsIHJlc29sdmU6IHBSZXNvbHZlLCByZWplY3Q6IHBSZWplY3QsIHRoZW46IHBUaGVufTsKCX0KfTsKCi8qKgogKiBAbmFtZXNwYWNlIHN0b3JlCiAqLwp2YXIgc3RvcmUgPSB7CgkvKioKCSAqIERlY29yYXRlcyBhIERhdGFTdG9yZSBvbiBhbiBPYmplY3QKCSAqCgkgKiBAbWV0aG9kIGZhY3RvcnkKCSAqIEBtZW1iZXJPZiBzdG9yZQoJICogQHBhcmFtICB7TWl4ZWR9ICByZWNzIFtPcHRpb25hbF0gRGF0YSB0byBzZXQgd2l0aCB0aGlzLmJhdGNoCgkgKiBAcGFyYW0gIHtPYmplY3R9IGFyZ3MgW09wdGlvbmFsXSBBcmd1bWVudHMgdG8gc2V0IG9uIHRoZSBzdG9yZQoJICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRhdGFTdG9yZX0KCSAqIEBleGFtcGxlCgkgKiB2YXIgc3RvcmUgPSBrZWlnYWkuc3RvcmUobnVsbCwge2tleTogImd1aWQifSk7CgkgKgoJICogc3RvcmUuc2V0VXJpKCAiaHR0cDovLy4uLiIgKS50aGVuKCBmdW5jdGlvbiAoIHJlY29yZHMgKSB7CgkgKiAgIC8vIERvIHNvbWV0aGluZyB3aXRoIHRoZSByZWNvcmRzCgkgKiB9LCBmdW5jdGlvbiAoIGUgKSB7CgkgKiAgIC8vIEhhbmRsZSBgZWAKCSAqIH0gKTsKCSAqLwoJZmFjdG9yeSA6IGZ1bmN0aW9uICggcmVjcywgYXJncyApIHsKCQl2YXIgb2JqID0gbmV3IERhdGFTdG9yZSgpOwoKCQlpZiAoIGFyZ3MgaW5zdGFuY2VvZiBPYmplY3QgKSB7CgkJCXV0aWxpdHkubWVyZ2UoIG9iaiwgYXJncyApOwoJCX0KCgkJaWYgKCByZWNzICE9PSBudWxsICYmIHR5cGVvZiByZWNzID09ICJvYmplY3QiICkgewoJCQlvYmouYmF0Y2goICJzZXQiLCByZWNzICk7CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIERhdGFTdG9yZSB3b3JrZXIgaGFuZGxlcgoJICoKCSAqIEBtZXRob2Qgd29ya2VyCgkgKiBAbWVtYmVyT2Ygc3RvcmUKCSAqIEBwYXJhbSAge09iamVjdH0gZXYgRXZlbnQKCSAqIEByZXR1cm4ge1VuZGVmaW5lZH0gdW5kZWZpbmVkCgkgKiBAcHJpdmF0ZQoJICovCgl3b3JrZXIgOiBmdW5jdGlvbiAoIGV2ICkgewoJCXZhciBjbWQgICAgID0gZXYuZGF0YS5jbWQsCgkJICAgIHJlY29yZHMgPSBldi5kYXRhLnJlY29yZHMsCgkJICAgIGNsYXVzZXMsIGNvbmQsIGZ1bmN0aW9ucywgaW5kZXhlcywgaW5kZXgsIHJlc3VsdCwgc29ydGVkLCB3aGVyZSwgdmFsdWVzOwoKCQlpZiAoIGNtZCA9PT0gInNlbGVjdCIgKSB7CgkJCXdoZXJlICAgICA9IEpTT04ucGFyc2UoIGV2LmRhdGEud2hlcmUgKTsKCQkJZnVuY3Rpb25zID0gZXYuZGF0YS5mdW5jdGlvbnM7CgkJCWNsYXVzZXMgICA9IGFycmF5LmZyb21PYmplY3QoIHdoZXJlICk7CgkJCXNvcnRlZCAgICA9IGFycmF5LmZsYXQoIGNsYXVzZXMgKS5maWx0ZXIoIGZ1bmN0aW9uICggaSwgaWR4ICkgeyByZXR1cm4gaWR4ICUgMiA9PT0gMDsgfSApLnNvcnQoIGFycmF5LnNvcnQgKTsKCQkJaW5kZXggICAgID0gc29ydGVkLmpvaW4oICJ8IiApOwoJCQl2YWx1ZXMgICAgPSBzb3J0ZWQubWFwKCBmdW5jdGlvbiAoIGkgKSB7IHJldHVybiB3aGVyZVtpXTsgfSApLmpvaW4oICJ8IiApOwoJCQlpbmRleGVzICAgPSBldi5kYXRhLmluZGV4ZXM7CgkJCWNvbmQgICAgICA9ICJyZXR1cm4gKCAiOwoKCQkJaWYgKCBmdW5jdGlvbnMubGVuZ3RoID09PSAwICYmIGluZGV4ZXNbaW5kZXhdICkgewoJCQkJcmVzdWx0ID0gKCBpbmRleGVzW2luZGV4XVt2YWx1ZXNdIHx8IFtdICkubWFwKCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJcmV0dXJuIHJlY29yZHNbaV07CgkJCQl9ICk7CgkJCX0KCQkJZWxzZSB7CgkJCQlpZiAoIGNsYXVzZXMubGVuZ3RoID4gMSApIHsKCQkJCQlhcnJheS5lYWNoKCBjbGF1c2VzLCBmdW5jdGlvbiAoIGksIGlkeCApIHsKCQkJCQkJdmFyIGIxID0gIiggIjsKCgkJCQkJCWlmICggaWR4ID4gMCApIHsKCQkJCQkJCWIxID0gIiAmJiAoICI7CgkJCQkJCX0KCgkJCQkJCWlmICggYXJyYXkuY29udGFpbnMoIGZ1bmN0aW9ucywgaVswXSApICkgewoJCQkJCQkJY29uZCArPSBiMSArIGlbMV0gKyAiKCByZWMuZGF0YVtcIiIgKyBpWzBdICsgIlwiXSApICkiOwoJCQkJCQl9CgkJCQkJCWVsc2UgaWYgKCFpc05hTihpWzFdKSkgewoJCQkJCQkJY29uZCArPSBiMSArICJyZWMuZGF0YVtcIiIgKyBpWzBdICsgIlwiXSA9PT0gIiArIGlbMV0gKyAiICkiOwoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJY29uZCArPSBiMSArICJyZWMuZGF0YVtcIiIgKyBpWzBdICsgIlwiXSA9PT0gXCIiICsgaVsxXSArICJcIiApIjsKCQkJCQkJfQoJCQkJCX0gKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWlmICggYXJyYXkuY29udGFpbnMoIGZ1bmN0aW9ucywgY2xhdXNlc1swXVswXSApICkgewoJCQkJCQljb25kICs9IGNsYXVzZXNbMF1bMV0gKyAiKCByZWMuZGF0YVtcIiIgKyBjbGF1c2VzWzBdWzBdICsgIlwiXSApIjsKCQkJCQl9CgkJCQkJZWxzZSBpZiAoICFpc05hTiggY2xhdXNlc1swXVsxXSApICkgewoJCQkJCQljb25kICs9ICJyZWMuZGF0YVtcIiIgKyBjbGF1c2VzWzBdWzBdICsgIlwiXSA9PT0gIiArIGNsYXVzZXNbMF1bMV07CgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQljb25kICs9ICJyZWMuZGF0YVtcIiIgKyBjbGF1c2VzWzBdWzBdICsgIlwiXSA9PT0gXCIiICsgY2xhdXNlc1swXVsxXSArICJcIiI7CgkJCQkJfQoJCQkJfQoKCQkJCWNvbmQgKz0gIiApOyI7CgoJCQkJcmVzdWx0ID0gcmVjb3Jkcy5maWx0ZXIoIG5ldyBGdW5jdGlvbigicmVjIiwgY29uZCApICk7CgkJCX0KCQl9CgkJZWxzZSBpZiAoIGNtZCA9PT0gInNvcnQiICkgewoJCQlyZXN1bHQgPSBhcnJheS5rZXlTb3J0KCByZWNvcmRzLCBldi5kYXRhLnF1ZXJ5LCAiZGF0YSIgKTsKCQl9CgoJCXBvc3RNZXNzYWdlKCByZXN1bHQgKTsKCX0KfTsKCi8qKgogKiBDcmVhdGVzIGEgbmV3IERhdGFTdG9yZQogKgogKiBAY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaQogKiBAZXh0ZW5kcyB7a2VpZ2FpLkJhc2V9CiAqIEBleGFtcGxlCiAqIHZhciBzdG9yZSA9IGtlaWdhaS5zdG9yZSgpOwogKi8KZnVuY3Rpb24gRGF0YVN0b3JlICgpIHsKCXRoaXMuYXV0b3NhdmUgICAgPSBmYWxzZTsKCXRoaXMuY2FsbGJhY2sgICAgPSBudWxsOwoJdGhpcy5jcmVkZW50aWFscyA9IG51bGw7Cgl0aGlzLmxpc3RzICAgICAgID0gW107Cgl0aGlzLmV2ZW50cyAgICAgID0gdHJ1ZTsKCXRoaXMuZXhwaXJlcyAgICAgPSBudWxsOwoJdGhpcy5oZWFkZXJzICAgICA9IHtBY2NlcHQ6ICJhcHBsaWNhdGlvbi9qc29uIn07Cgl0aGlzLmlnbm9yZSAgICAgID0gW107Cgl0aGlzLmluZGV4ICAgICAgID0gW107Cgl0aGlzLmluZGV4ZXMgICAgID0ge2tleToge319OwoJdGhpcy5rZXkgICAgICAgICA9IG51bGw7Cgl0aGlzLmxvYWRlZCAgICAgID0gZmFsc2U7Cgl0aGlzLm1vbmdvZGIgICAgID0gIiI7Cgl0aGlzLm9ic2VydmVyICAgID0gb2JzZXJ2YWJsZS5mYWN0b3J5KCk7Cgl0aGlzLnJlY29yZHMgICAgID0gW107Cgl0aGlzLnNvdXJjZSAgICAgID0gbnVsbDsKCXRoaXMudG90YWwgICAgICAgPSAwOwoJdGhpcy52ZXJzaW9ucyAgICA9IHt9OwoJdGhpcy52ZXJzaW9uaW5nICA9IHRydWU7Cgl0aGlzLnZpZXdzICAgICAgID0ge307Cgl0aGlzLnVyaSAgICAgICAgID0gbnVsbDsKfQoKLyoqCiAqIEV4dGVuZGluZyBCYXNlCiAqCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUdyaWQKICogQHR5cGUge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKi8KRGF0YVN0b3JlLnByb3RvdHlwZSA9IGJhc2UuZmFjdG9yeSgpOwoKLyoqCiAqIFNldHRpbmcgY29uc3RydWN0b3IgbG9vcAogKgogKiBAbWV0aG9kIGNvbnN0cnVjdG9yCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEB0eXBlIHtGdW5jdGlvbn0KICogQHByaXZhdGUKICovCkRhdGFTdG9yZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEYXRhU3RvcmU7CgovKioKICogQmF0Y2ggc2V0cyBvciBkZWxldGVzIGRhdGEgaW4gdGhlIHN0b3JlCiAqCiAqIEBtZXRob2QgYmF0Y2gKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7U3RyaW5nfSAgdHlwZSBUeXBlIG9mIGFjdGlvbiB0byBwZXJmb3JtICggc2V0L2RlbC9kZWxldGUgKQogKiBAcGFyYW0gIHtBcnJheX0gICBkYXRhIEFycmF5IG9mIGtleXMgb3IgaW5kaWNlcyB0byBkZWxldGUsIG9yIE9iamVjdCBjb250YWluaW5nIG11bHRpcGxlIHJlY29yZHMgdG8gc2V0CiAqIEBwYXJhbSAge0Jvb2xlYW59IHN5bmMgW09wdGlvbmFsXSBTeW5jcyBzdG9yZSB3aXRoIGRhdGEsIGlmIHRydWUgZXZlcnl0aGluZyBpcyBlcmFzZWQKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNiZWZvcmVCYXRjaCBGaXJlcyBiZWZvcmUgdGhlIGJhdGNoIGlzIHF1ZXVlZAogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNhZnRlckJhdGNoIEZpcmVzIGFmdGVyIHRoZSBiYXRjaCBpcyBxdWV1ZWQKICogQGZpcmVzIGtlaWdhaS5EYXRhU3RvcmUjZmFpbGVkQmF0Y2ggRmlyZXMgd2hlbiBhbiBleGNlcHRpb24gb2NjdXJzCiAqIEBleGFtcGxlCiAqIHN0b3JlLmJhdGNoKCAic2V0IiwgWy4uLl0gKS50aGVuKCBmdW5jdGlvbiAoIHJlY29yZHMgKSB7CiAqICAgLi4uCiAqIH0sIGZ1bmN0aW9uICggZXJyICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLmJhdGNoID0gZnVuY3Rpb24gKCB0eXBlLCBkYXRhLCBzeW5jICkgewoJc3luYyAgICAgICAgICA9ICggc3luYyA9PT0gdHJ1ZSApOwoJdmFyIHNlbGYgICAgICA9IHRoaXMsCgkgICAgZXZlbnRzICAgID0gdGhpcy5ldmVudHMsCgkgICAgZGVmZXIgICAgID0gZGVmZXJyZWQuZmFjdG9yeSgpLAoJICAgIGRlZmVycmVkcyA9IFtdOwoKCWlmICggIXJlZ2V4LnNldF9kZWwudGVzdCggdHlwZSApIHx8ICggc3luYyAmJiByZWdleC5kZWwudGVzdCggdHlwZSApICkgfHwgdHlwZW9mIGRhdGEgIT0gIm9iamVjdCIgKSB7CgkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKSApOwoJfQoJZWxzZSB7CgkJaWYgKCBldmVudHMgKSB7CgkJCXRoaXMuZGlzcGF0Y2goICJiZWZvcmVCYXRjaCIsIGRhdGEgKTsKCQl9CgoJCWlmICggc3luYyApIHsKCQkJdGhpcy5jbGVhciggc3luYyApOwoJCX0KCgkJaWYgKCBkYXRhLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy5sb2FkZWQgPSB0cnVlOwoKCQkJaWYgKCBldmVudHMgKSB7CgkJCQl0aGlzLmRpc3BhdGNoKCAiYWZ0ZXJCYXRjaCIsIHRoaXMucmVjb3JkcyApOwoJCQl9CgoJCQlkZWZlci5yZXNvbHZlKCB0aGlzLnJlY29yZHMgKTsKCQl9CgkJZWxzZSB7CgkJCS8vIEJhdGNoIGRlbGV0aW9uIHdpbGwgY3JlYXRlIGEgc3BhcnNlIGFycmF5LCB3aGljaCB3aWxsIGJlIGNvbXBhY3RlZCBiZWZvcmUgcmUtaW5kZXhpbmcKCQkJaWYgKCB0eXBlID09PSAiZGVsIiApIHsKCQkJCWFycmF5LmVhY2goIGRhdGEsIGZ1bmN0aW9uICggaSApIHsKCQkJCQlkZWZlcnJlZHMucHVzaCggc2VsZi5kZWwoIGksIGZhbHNlLCB0cnVlICkgKTsKCQkJCX0gKTsKCQkJfQoJCQllbHNlIHsKCQkJCWFycmF5LmVhY2goIGRhdGEsIGZ1bmN0aW9uICggaSApIHsKCQkJCQlkZWZlcnJlZHMucHVzaCggc2VsZi5zZXQoIG51bGwsIGksIHRydWUgKSApOwoJCQkJfSApOwoJCQl9CgoJCQl0aGlzLmxvYWRlZCA9IGZhbHNlOwoKCQkJdXRpbGl0eS53aGVuKCBkZWZlcnJlZHMgKS50aGVuKCBmdW5jdGlvbiAoIGFyZ3MgKSB7CgkJCQlzZWxmLmxvYWRlZCA9IHRydWU7CgoJCQkJaWYgKCBldmVudHMgKSB7CgkJCQkJc2VsZi5kaXNwYXRjaCggImFmdGVyQmF0Y2giLCBhcmdzICk7CgkJCQl9CgoJCQkJLy8gRm9yY2luZyBhIGNsZWFyIG9mIHZpZXdzIHRvIGRlYWwgd2l0aCBhc3luYyBuYXR1cmUgb2Ygd29ya2VycyAmIHN0YWdnZXJlZCBsb2FkaW5nCgkJCQlhcnJheS5lYWNoKCBzZWxmLmxpc3RzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJaS5yZWZyZXNoKCB0cnVlICk7CgkJCQl9ICk7CgoJCQkJaWYgKCB0eXBlID09PSAiZGVsIiApIHsKCQkJCQlzZWxmLnJlY29yZHMgPSBhcnJheS5jb21wYWN0KCBzZWxmLnJlY29yZHMgKTsKCQkJCQlzZWxmLnJlaW5kZXgoKTsKCQkJCX0KCgkJCQlpZiAoIHNlbGYuYXV0b3NhdmUgKSB7CgkJCQkJc2VsZi5zYXZlKCk7CgkJCQl9CgoJCQkJZGVmZXIucmVzb2x2ZSggYXJncyApOwoJCQl9LCBmdW5jdGlvbiAoIGUgKSB7CgkJCQlpZiAoIGV2ZW50cyApIHsKCQkJCQlzZWxmLmRpc3BhdGNoKCAiZmFpbGVkQmF0Y2giLCBlICk7CgkJCQl9CgoJCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJCX0gKTsKCQl9Cgl9CgoJcmV0dXJuIGRlZmVyOwp9OwoKLyoqCiAqIEJ1aWxkcyBhIFVSSQogKgogKiBAbWV0aG9kIGJ1aWxkVXJpCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge1N0cmluZ30ga2V5IFJlY29yZCBrZXkKICogQHJldHVybiB7U3RyaW5nfSAgICAgVVJJCiAqIEBleGFtcGxlCiAqIHZhciB1cmkgPSBzdG9yZS5idWlsZFVyaSggImtleSIgKTsKICovCkRhdGFTdG9yZS5wcm90b3R5cGUuYnVpbGRVcmkgPSBmdW5jdGlvbiAoIGtleSApIHsKCXZhciBwYXJzZWQgPSB1dGlsaXR5LnBhcnNlKCB0aGlzLnVyaSApOwoKCXJldHVybiBwYXJzZWQucHJvdG9jb2wgKyAiLy8iICsgcGFyc2VkLmhvc3QgKyBwYXJzZWQucGF0aG5hbWUgKyAoIHJlZ2V4LmVuZHNsYXNoLnRlc3QoIHBhcnNlZC5wYXRobmFtZSApID8gIiIgOiAiLyIgKSArIGtleTsKfTsKCi8qKgogKiBDbGVhcnMgdGhlIGRhdGEgb2JqZWN0LCB1bnNldHMgdGhlIHVyaSBwcm9wZXJ0eQogKgogKiBAbWV0aG9kIGNsZWFyCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge0Jvb2xlYW59IHN5bmMgW09wdGlvbmFsXSBCb29sZWFuIHRvIGxpbWl0IGNsZWFyaW5nIG9mIHByb3BlcnRpZXMKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRhdGFTdG9yZX0KICogQGZpcmVzIGtlaWdhaS5EYXRhU3RvcmUjYmVmb3JlQ2xlYXIgRmlyZXMgYmVmb3JlIHRoZSBkYXRhIGlzIGNsZWFyZWQKICogQGZpcmVzIGtlaWdhaS5EYXRhU3RvcmUjYWZ0ZXJDbGVhciBGaXJlcyBhZnRlciB0aGUgZGF0YSBpcyBjbGVhcmVkCiAqIEBleGFtcGxlCiAqIC8vIFJlc3luY2luZyB0aGUgcmVjb3JkcywgaWYgd2lyZWQgdG8gYW4gQVBJCiAqIHN0b3JlLmNsZWFyKCB0cnVlICk7CiAqCiAqIC8vIFJlc2V0dGluZyB0aGUgc3RvcmUKICogc3RvcmUuY2xlYXIoKTsKICovCkRhdGFTdG9yZS5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoIHN5bmMgKSB7CglzeW5jICAgICAgID0gKCBzeW5jID09PSB0cnVlICk7Cgl2YXIgZXZlbnRzID0gKCB0aGlzLmV2ZW50cyA9PT0gdHJ1ZSApLAoJICAgIHJlc2F2ZSA9ICggdGhpcy5hdXRvc2F2ZSA9PT0gdHJ1ZSApOwoKCWlmICggIXN5bmMgKSB7CgkJaWYgKCBldmVudHMgKSB7CgkJCXRoaXMuZGlzcGF0Y2goICJiZWZvcmVDbGVhciIgKTsKCQl9CgoJCWFycmF5LmVhY2goIHRoaXMubGlzdHMsIGZ1bmN0aW9uICggaSApIHsKCQkJaWYgKCBpICkgewoJCQkJaS50ZWFyZG93biggdHJ1ZSApOwoJCQl9CgkJfSApOwoKCQl0aGlzLmF1dG9zYXZlICAgID0gZmFsc2U7CgkJdGhpcy5jYWxsYmFjayAgICA9IG51bGw7CgkJdGhpcy5jcmVkZW50aWFscyA9IG51bGw7CgkJdGhpcy5saXN0cyAgICAgICA9IFtdOwoJCXRoaXMuZXZlbnRzICAgICAgPSB0cnVlOwoJCXRoaXMuZXhwaXJlcyAgICAgPSBudWxsOwoJCXRoaXMuaGVhZGVycyAgICAgPSB7QWNjZXB0OiAiYXBwbGljYXRpb24vanNvbiJ9OwoJCXRoaXMuaWdub3JlICAgICAgPSBbXTsKCQl0aGlzLmluZGV4ICAgICAgID0gW107CgkJdGhpcy5pbmRleGVzICAgICA9IHtrZXk6IHt9fTsKCQl0aGlzLmtleSAgICAgICAgID0gbnVsbDsKCQl0aGlzLmxvYWRlZCAgICAgID0gZmFsc2U7CgkJdGhpcy5yZWNvcmRzICAgICA9IFtdOwoJCXRoaXMuc291cmNlICAgICAgPSBudWxsOwoJCXRoaXMudG90YWwgICAgICAgPSAwOwoJCXRoaXMudmVyc2lvbnMgICAgPSB7fTsKCQl0aGlzLnZlcnNpb25pbmcgID0gdHJ1ZTsKCQl0aGlzLnZpZXdzICAgICAgID0ge307CgkJdGhpcy51cmkgICAgICAgICA9IG51bGw7CgoJCWlmICggZXZlbnRzICkgewoJCQl0aGlzLmRpc3BhdGNoKCAiYWZ0ZXJDbGVhciIgKTsKCQl9Cgl9CgllbHNlIHsKCQl0aGlzLmluZGV4ZXMgICAgID0ge2tleToge319OwoJCXRoaXMubG9hZGVkICAgICAgPSBmYWxzZTsKCQl0aGlzLnJlY29yZHMgICAgID0gW107CgkJdGhpcy50b3RhbCAgICAgICA9IDA7CgkJdGhpcy52aWV3cyAgICAgICA9IHt9OwoKCQlhcnJheS5lYWNoKCB0aGlzLmxpc3RzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCWlmICggaSApIHsKCQkJCWkucmVmcmVzaCgpOwoJCQl9CgkJfSApOwoJfQoKCWlmICggcmVzYXZlICkgewoJCXRoaXMuc2F2ZSgpOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIERlbGV0ZXMgYSByZWNvcmQgYmFzZWQgb24ga2V5IG9yIGluZGV4CiAqCiAqIEBtZXRob2QgZGVsCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge01peGVkfSAgIHJlY29yZCAgUmVjb3JkLCBrZXkgb3IgaW5kZXgKICogQHBhcmFtICB7Qm9vbGVhbn0gcmVpbmRleCBbT3B0aW9uYWxdIGB0cnVlYCBpZiBEYXRhU3RvcmUgc2hvdWxkIGJlIHJlaW5kZXhlZAogKiBAcGFyYW0gIHtCb29sZWFufSBiYXRjaCAgIFtPcHRpb25hbF0gYHRydWVgIGlmIHBhcnQgb2YgYSBiYXRjaCBvcGVyYXRpb24KICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNiZWZvcmVEZWxldGUgRmlyZXMgYmVmb3JlIHRoZSByZWNvcmQgaXMgZGVsZXRlZAogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNhZnRlckRlbGV0ZSBGaXJlcyBhZnRlciB0aGUgcmVjb3JkIGlzIGRlbGV0ZWQKICogQGZpcmVzIGtlaWdhaS5EYXRhU3RvcmUjZmFpbGVkRGVsZXRlIEZpcmVzIGlmIHRoZSBzdG9yZSBpcyBSRVNUZnVsIGFuZCB0aGUgYWN0aW9uIGlzIGRlbmllZAogKiBAZXhhbXBsZQogKiBzdG9yZS5kZWwoICJrZXkiICkudGhlbiggZnVuY3Rpb24gKCkgewogKiAgIGNvbnNvbGUubG9nKCAiU3VjY2Vzc2Z1bGx5IGRlbGV0ZWQgIiArIGtleSApOwogKiB9LCBmdW5jdGlvbiAoIGVyciApIHsKICogICBjb25zb2xlLndhcm4oICJGYWlsZWQgdG8gZGVsZXRlICIgKyBrZXkgKyAiOiAiICsgZXJyLm1lc3NhZ2UgKTsKICogfSApOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5kZWwgPSBmdW5jdGlvbiAoIHJlY29yZCwgcmVpbmRleCwgYmF0Y2ggKSB7CglyZWNvcmQgICAgPSByZWNvcmQua2V5ID8gcmVjb3JkIDogdGhpcy5nZXQgKCByZWNvcmQgKTsKCXJlaW5kZXggICA9ICggcmVpbmRleCAhPT0gZmFsc2UgKTsKCWJhdGNoICAgICA9ICggYmF0Y2ggPT09IHRydWUgKTsKCXZhciBzZWxmICA9IHRoaXMsCgkgICAgZGVmZXIgPSBkZWZlcnJlZC5mYWN0b3J5KCk7CgoJaWYgKCByZWNvcmQgPT09IHVuZGVmaW5lZCApIHsKCQlkZWZlci5yZWplY3QoIG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApICk7Cgl9CgllbHNlIHsKCQlpZiAoIHRoaXMuZXZlbnRzICkgewoJCQlzZWxmLmRpc3BhdGNoKCAiYmVmb3JlRGVsZXRlIiwgcmVjb3JkICk7CgkJfQoKCQlpZiAoIHRoaXMudXJpID09PSBudWxsIHx8IHRoaXMuY2FsbGJhY2sgIT09IG51bGwgKSB7CgkJCXRoaXMuZGVsQ29tcGxldGUoIHJlY29yZCwgcmVpbmRleCwgYmF0Y2gsIGRlZmVyICk7CgkJfQoJCWVsc2UgewoJCQljbGllbnQucmVxdWVzdCggdGhpcy5idWlsZFVyaSggcmVjb3JkLmtleSApLCAiREVMRVRFIiwgbnVsbCwgdXRpbGl0eS5tZXJnZSgge3dpdGhDcmVkZW50aWFsczogdGhpcy5jcmVkZW50aWFsc30sIHRoaXMuaGVhZGVycyApICkudGhlbiggZnVuY3Rpb24gKCkgewoJCQkJc2VsZi5kZWxDb21wbGV0ZSggcmVjb3JkLCByZWluZGV4LCBiYXRjaCwgZGVmZXIgKTsKCQkJfSwgZnVuY3Rpb24gKCBlICkgewoJCQkJc2VsZi5kaXNwYXRjaCggImZhaWxlZERlbGV0ZSIsIGUgKTsKCQkJCWRlZmVyLnJlamVjdCggZSApOwoJCQl9ICk7CgkJfQoJfQoKCXJldHVybiBkZWZlcjsKfTsKCi8qKgogKiBEZWxldGUgY29tcGxldGlvbgogKgogKiBAbWV0aG9kIGRlbENvbXBsZXRlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge09iamVjdH0gIHJlY29yZCAgRGF0YVN0b3JlIHJlY29yZAogKiBAcGFyYW0gIHtCb29sZWFufSByZWluZGV4IGB0cnVlYCBpZiBEYXRhU3RvcmUgc2hvdWxkIGJlIHJlaW5kZXhlZAogKiBAcGFyYW0gIHtCb29sZWFufSBiYXRjaCAgIGB0cnVlYCBpZiBwYXJ0IG9mIGEgYmF0Y2ggb3BlcmF0aW9uCiAqIEBwYXJhbSAge09iamVjdH0gIGRlZmVyICAgRGVmZXJyZWQgaW5zdGFuY2UKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRhdGFTdG9yZX0KICogQHByaXZhdGUKICovCkRhdGFTdG9yZS5wcm90b3R5cGUuZGVsQ29tcGxldGUgPSBmdW5jdGlvbiAoIHJlY29yZCwgcmVpbmRleCwgYmF0Y2gsIGRlZmVyICkgewoJdmFyIHNlbGYgPSB0aGlzOwoKCWRlbGV0ZSB0aGlzLmluZGV4ZXMua2V5W3JlY29yZC5rZXldOwoJZGVsZXRlIHRoaXMudmVyc2lvbnNbcmVjb3JkLmtleV07CgoJdGhpcy50b3RhbC0tOwoJdGhpcy52aWV3cyA9IHt9OwoKCWlmICggIWJhdGNoICkgewoJCWFycmF5LnJlbW92ZSggdGhpcy5yZWNvcmRzLCByZWNvcmQuaW5kZXggKTsKCgkJaWYgKCByZWluZGV4ICkgewoJCQl0aGlzLnJlaW5kZXgoKTsKCQl9CgkJZWxzZSB7CgkJCWFycmF5LmVhY2goIHJlY29yZC5pbmRleGVzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCQlhcnJheS5yZW1vdmUoIHNlbGYuaW5kZXhlc1tpWzBdXVtpWzFdXSwgcmVjb3JkLmluZGV4ICk7CgoJCQkJaWYgKCBzZWxmLmluZGV4ZXNbaVswXV1baVsxXV0ubGVuZ3RoID09PSAwICkgewoJCQkJCWRlbGV0ZSBzZWxmLmluZGV4ZXNbaVswXV1baVsxXV07CgkJCQl9CgkJCX0gKTsKCQl9CgoJCWlmICggdGhpcy5hdXRvc2F2ZSApIHsKCQkJdGhpcy5wdXJnZSggcmVjb3JkLmtleSApOwoJCX0KCgkJaWYgKCB0aGlzLmV2ZW50cyApIHsKCQkJdGhpcy5kaXNwYXRjaCggImFmdGVyRGVsZXRlIiwgcmVjb3JkICk7CgkJfQoKCQlhcnJheS5lYWNoKCB0aGlzLmxpc3RzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCWkucmVmcmVzaCgpOwoJCX0gKTsKCX0KCWVsc2UgewoJCXRoaXMucmVjb3Jkc1tyZWNvcmQuaW5kZXhdID0gbnVsbDsKCX0KCglyZXR1cm4gZGVmZXIucmVzb2x2ZSggcmVjb3JkLmtleSApOwp9OwoKLyoqCiAqIEV4cG9ydHMgYSBzdWJzZXQgb3IgY29tcGxldGUgcmVjb3JkIHNldCBvZiBEYXRhU3RvcmUKICoKICogQG1ldGhvZCBkdW1wCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge0FycmF5fSBhcmdzICAgW09wdGlvbmFsXSBTdWItZGF0YSBzZXQgb2YgRGF0YVN0b3JlCiAqIEBwYXJhbSAge0FycmF5fSBmaWVsZHMgW09wdGlvbmFsXSBGaWVsZHMgdG8gZXhwb3J0LCBkZWZhdWx0cyB0byBhbGwKICogQHJldHVybiB7QXJyYXl9ICAgICAgICBSZWNvcmRzCiAqIEBleGFtcGxlCiAqIHZhciBkYXRhID0gc3RvcmUuZHVtcCgpOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5kdW1wID0gZnVuY3Rpb24gKCBhcmdzLCBmaWVsZHMgKSB7CglhcmdzICAgICAgID0gYXJncyB8fCB0aGlzLnJlY29yZHM7Cgl2YXIgc2VsZiAgID0gdGhpcywKCSAgICBjdXN0b20gPSAoIGZpZWxkcyBpbnN0YW5jZW9mIEFycmF5ICYmIGZpZWxkcy5sZW5ndGggPiAwICksCgkgICAga2V5ICAgID0gdGhpcy5rZXkgIT09IG51bGwsCgkgICAgZm47CgoJaWYgKCBjdXN0b20gKSB7CgkJZm4gPSBmdW5jdGlvbiAoIGkgKSB7CgkJCXZhciByZWNvcmQgPSB7fTsKCgkJCWFycmF5LmVhY2goIGZpZWxkcywgZnVuY3Rpb24gKCBmICkgewoJCQkJcmVjb3JkW2ZdID0gZiA9PT0gc2VsZi5rZXkgPyAoIGlzTmFOKCBpLmtleSApID8gaS5rZXkgOiBOdW1iZXIoIGkua2V5ICkgKSA6IHV0aWxpdHkuY2xvbmUoIGkuZGF0YVtmXSwgdHJ1ZSApOwoJCQl9ICk7CgoJCQlyZXR1cm4gcmVjb3JkOwoJCX07Cgl9CgllbHNlIHsKCQlmbiA9IGZ1bmN0aW9uICggaSApIHsKCQkJdmFyIHJlY29yZCA9IHt9OwoKCQkJaWYgKCBrZXkgKSB7CgkJCQlyZWNvcmRbc2VsZi5rZXldID0gaXNOYU4oIGkua2V5ICkgPyBpLmtleSA6IE51bWJlciggaS5rZXkgKTsKCQkJfQoKCQkJdXRpbGl0eS5pdGVyYXRlKCBpLmRhdGEsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCXJlY29yZFtrXSA9IHV0aWxpdHkuY2xvbmUoIHYsIHRydWUgKTsKCQkJfSApOwoKCQkJcmV0dXJuIHJlY29yZDsKCQl9OwoJfQoKCXJldHVybiBhcmdzLm1hcCggZm4gKTsKfTsKCi8qKgogKiBSZXRyaWV2ZXMgdGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBhIHJlY29yZChzKSBiYXNlZCBvbiBrZXkgb3IgaW5kZXgKICoKICogSWYgdGhlIGtleSBpcyBhbiBpbnRlZ2VyLCBjYXN0IHRvIGEgc3RyaW5nIGJlZm9yZSBzZW5kaW5nIGFzIGFuIGFyZ3VtZW50IQogKgogKiBAbWV0aG9kIGdldAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFTdG9yZQogKiBAcGFyYW0gIHtNaXhlZH0gIHJlY29yZCBLZXksIGluZGV4IG9yIEFycmF5IG9mIHBhZ2luYXRpb24gc3RhcnQgJiBlbmQ7IG9yIGNvbW1hIGRlbGltaXRlZCBTdHJpbmcgb2Yga2V5cyBvciBpbmRpY2VzCiAqIEBwYXJhbSAge051bWJlcn0gb2Zmc2V0IFtPcHRpb25hbF0gT2Zmc2V0IGZyb20gYHJlY29yZGAgZm9yIHBhZ2luYXRpb24KICogQHJldHVybiB7TWl4ZWR9ICAgICAgICAgSW5kaXZpZHVhbCByZWNvcmQsIG9yIEFycmF5IG9mIHJlY29yZHMKICogQGV4YW1wbGUKICogdmFyIHJlY29yZCA9IHN0b3JlLmdldCggImtleSIgKTsKICovCkRhdGFTdG9yZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKCByZWNvcmQsIG9mZnNldCApIHsKCXZhciB0eXBlID0gdHlwZW9mIHJlY29yZCwKCSAgICBzZWxmID0gdGhpcywKCSAgICByZXN1bHQ7CgoJaWYgKCB0eXBlID09PSAidW5kZWZpbmVkIiApIHsKCQlyZXN1bHQgPSB0aGlzLnJlY29yZHM7Cgl9CgllbHNlIGlmICggdHlwZSA9PT0gInN0cmluZyIgKSB7CgkJaWYgKCByZWNvcmQuaW5kZXhPZiggIiwiICkgPT09IC0xICkgewoJCQlyZXN1bHQgPSB0aGlzLnJlY29yZHNbdGhpcy5pbmRleGVzLmtleVtyZWNvcmRdXTsKCQl9CgkJZWxzZSB7CgkJCXJlc3VsdCA9IHN0cmluZy5leHBsb2RlKCByZWNvcmQgKS5tYXAoIGZ1bmN0aW9uICggaSApIHsKCQkJCWlmICggIWlzTmFOKCBpICkgKSB7CgkJCQkJcmV0dXJuIHNlbGYucmVjb3Jkc1twYXJzZUludCggaSwgMTAgKV07CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlyZXR1cm4gc2VsZi5yZWNvcmRzW3NlbGYuaW5kZXhlcy5rZXlbaV1dOwoJCQkJfQoJCQl9ICk7CgkJfQoJfQoJZWxzZSBpZiAoIHR5cGUgPT09ICJudW1iZXIiICkgewoJCWlmICggaXNOYU4oIG9mZnNldCApICkgewoJCQlyZXN1bHQgPSB0aGlzLnJlY29yZHNbcGFyc2VJbnQoIHJlY29yZCwgMTAgKV07CgkJfQoJCWVsc2UgewoJCQlyZXN1bHQgPSBhcnJheS5saW1pdCggdGhpcy5yZWNvcmRzLCBwYXJzZUludCggcmVjb3JkLCAxMCApLCBwYXJzZUludCggb2Zmc2V0LCAxMCApICk7CgkJfQoJfQoKCXJldHVybiB1dGlsaXR5LmNsb25lKCByZXN1bHQsIHRydWUgKTsKfSwKCi8qKgogKiBQZXJmb3JtcyBhbiAoSU5ORVIvTEVGVC9SSUdIVCkgSk9JTiBvbiB0d28gRGF0YVN0b3JlcwogKgogKiBAbWV0aG9kIGpvaW4KICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7U3RyaW5nfSBhcmcgICBEYXRhU3RvcmUgdG8gam9pbgogKiBAcGFyYW0gIHtTdHJpbmd9IGZpZWxkIEZpZWxkIGluIGJvdGggRGF0YVN0b3JlcwogKiBAcGFyYW0gIHtTdHJpbmd9IGpvaW4gIFR5cGUgb2YgSk9JTiB0byBwZXJmb3JtLCBkZWZhdWx0cyB0byBgaW5uZXJgCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EZWZlcnJlZH0KICogdmFyIGRhdGEgPSBzdG9yZS5qb2luKCBvdGhlclN0b3JlLCAiY29tbW9uRmllbGQiICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLmpvaW4gPSBmdW5jdGlvbiAoIGFyZywgZmllbGQsIGpvaW4gKSB7Cglqb2luICAgICAgICAgID0gam9pbiB8fCAiaW5uZXIiOwoJdmFyIHNlbGYgICAgICA9IHRoaXMsCgkgICAgZGVmZXIgICAgID0gZGVmZXJyZWQuZmFjdG9yeSgpLAoJICAgIHJlc3VsdHMgICA9IFtdLAoJICAgIGRlZmVycmVkcyA9IFtdLAoJICAgIGtleSAgICAgICA9IGZpZWxkID09PSB0aGlzLmtleSwKCSAgICBrZXlzICAgICAgPSBhcnJheS5tZXJnZSggYXJyYXkua2V5cyggdGhpcy5yZWNvcmRzWzBdLmRhdGEgKSwgYXJyYXkua2V5cyggYXJnLnJlY29yZHNbMF0uZGF0YSApICksCgkgICAgZm47CgoJaWYgKCBqb2luID09PSAiaW5uZXIiICkgewoJCWZuID0gZnVuY3Rpb24gKCBpICkgewoJCQl2YXIgd2hlcmUgID0ge30sCgkJCSAgICByZWNvcmQgPSBpLmRhdGEsCgkJCSAgICBkZWZlciAgPSBkZWZlcnJlZC5mYWN0b3J5KCk7CgoJCQl3aGVyZVtmaWVsZF0gPSBrZXkgPyBpLmtleSA6IHJlY29yZFtmaWVsZF07CgkJCQoJCQlhcmcuc2VsZWN0KCB3aGVyZSApLnRoZW4oIGZ1bmN0aW9uICggbWF0Y2ggKSB7CgkJCQlpZiAoIG1hdGNoLmxlbmd0aCA+IDIgKSB7CgkJCQkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmRhdGFiYXNlTW9yZVRoYW5PbmUgKSApOwoJCQkJfQoJCQkJZWxzZSBpZiAoIG1hdGNoLmxlbmd0aCA9PT0gMSApIHsKCQkJCQlyZXN1bHRzLnB1c2goIHV0aWxpdHkubWVyZ2UoIHJlY29yZCwgbWF0Y2hbMF0uZGF0YSApICk7CgkJCQkJZGVmZXIucmVzb2x2ZSggdHJ1ZSApOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJZGVmZXIucmVzb2x2ZSggZmFsc2UgKTsKCQkJCX0KCQkJfSApOwoKCQkJZGVmZXJyZWRzLnB1c2goIGRlZmVyICk7CgkJfTsKCX0KCWVsc2UgaWYgKCBqb2luID09PSAibGVmdCIgKSB7CgkJZm4gPSBmdW5jdGlvbiAoIGkgKSB7CgkJCXZhciB3aGVyZSAgPSB7fSwKCQkJCXJlY29yZCA9IGkuZGF0YSwKCQkJICAgIGRlZmVyICA9IGRlZmVycmVkLmZhY3RvcnkoKTsKCgkJCXdoZXJlW2ZpZWxkXSA9IGtleSA/IGkua2V5IDogcmVjb3JkW2ZpZWxkXTsKCgkJCWFyZy5zZWxlY3QoIHdoZXJlICkudGhlbiggZnVuY3Rpb24gKCBtYXRjaCApIHsKCQkJCWlmICggbWF0Y2gubGVuZ3RoID4gMiApIHsKCQkJCQlkZWZlci5yZWplY3QoIG5ldyBFcnJvciggbGFiZWwuZGF0YWJhc2VNb3JlVGhhbk9uZSApICk7CgkJCQl9CgkJCQllbHNlIGlmICggbWF0Y2gubGVuZ3RoID09PSAxICkgewoJCQkJCXJlc3VsdHMucHVzaCggdXRpbGl0eS5tZXJnZSggcmVjb3JkLCBtYXRjaFswXS5kYXRhICkgKTsKCQkJCQlkZWZlci5yZXNvbHZlKCB0cnVlICk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlhcnJheS5lYWNoKCBrZXlzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJCWlmICggcmVjb3JkW2ldID09PSB1bmRlZmluZWQgKSB7CgkJCQkJCQlyZWNvcmRbaV0gPSBudWxsOwoJCQkJCQl9CgkJCQkJfSApOwoKCQkJCQlyZXN1bHRzLnB1c2goIHJlY29yZCApOwoJCQkJCWRlZmVyLnJlc29sdmUoIHRydWUgKTsKCQkJCX0KCQkJfSApOwoKCQkJZGVmZXJyZWRzLnB1c2goIGRlZmVyICk7CgkJfTsKCX0KCWVsc2UgaWYgKCBqb2luID09PSAicmlnaHQiICkgewoJCWZuID0gZnVuY3Rpb24gKCBpICkgewoJCQl2YXIgd2hlcmUgID0ge30sCgkJCSAgICByZWNvcmQgPSBpLmRhdGEsCgkJCSAgICBkZWZlciAgPSBkZWZlcnJlZC5mYWN0b3J5KCk7CgoJCQl3aGVyZVtmaWVsZF0gPSBrZXkgPyBpLmtleSA6IHJlY29yZFtmaWVsZF07CgkJCQoJCQlzZWxmLnNlbGVjdCggd2hlcmUgKS50aGVuKCBmdW5jdGlvbiAoIG1hdGNoICkgewoJCQkJaWYgKCBtYXRjaC5sZW5ndGggPiAyICkgewoJCQkJCWRlZmVyLnJlamVjdCggbmV3IEVycm9yKCBsYWJlbC5kYXRhYmFzZU1vcmVUaGFuT25lICkgKTsKCQkJCX0KCQkJCWVsc2UgaWYgKCBtYXRjaC5sZW5ndGggPT09IDEgKSB7CgkJCQkJcmVzdWx0cy5wdXNoKCB1dGlsaXR5Lm1lcmdlKCByZWNvcmQsIG1hdGNoWzBdLmRhdGEgKSApOwoJCQkJCWRlZmVyLnJlc29sdmUoIHRydWUgKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWFycmF5LmVhY2goIGtleXMsIGZ1bmN0aW9uICggaSApIHsKCQkJCQkJaWYgKCByZWNvcmRbaV0gPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJCXJlY29yZFtpXSA9IG51bGw7CgkJCQkJCX0KCQkJCQl9ICk7CgoJCQkJCXJlc3VsdHMucHVzaCggcmVjb3JkICk7CgkJCQkJZGVmZXIucmVzb2x2ZSggdHJ1ZSApOwoJCQkJfQoJCQl9ICk7CgoJCQlkZWZlcnJlZHMucHVzaCggZGVmZXIgKTsKCQl9OwoJfQoKCWFycmF5LmVhY2goIHV0aWxpdHkuY2xvbmUoIGpvaW4gPT09ICJyaWdodCIgPyBhcmcucmVjb3JkcyA6IHRoaXMucmVjb3JkcywgdHJ1ZSApLCBmbiApOwoKCXV0aWxpdHkud2hlbiggZGVmZXJyZWRzICkudGhlbiggZnVuY3Rpb24gKCkgewoJCWRlZmVyLnJlc29sdmUoIHJlc3VsdHMgKTsKCX0sIGZ1bmN0aW9uICggZSApIHsKCQlkZWZlci5yZWplY3QoIGUgKTsKCX0gKTsKCQoJcmV0dXJuIGRlZmVyOwp9OwoKLyoqCiAqIFJldHJpZXZlcyBvbmx5IDEgZmllbGQvcHJvcGVydHkKICoKICogQG1ldGhvZCBvbmx5CiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge1N0cmluZ30gYXJnIEZpZWxkL3Byb3BlcnR5IHRvIHJldHJpZXZlCiAqIEByZXR1cm4ge0FycmF5fSAgICAgIEFycmF5IG9mIHZhbHVlcwogKiBAZXhhbXBsZQogKiB2YXIgYWdlcyA9IHN0b3JlLm9ubHkoICJhZ2UiICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLm9ubHkgPSBmdW5jdGlvbiAoIGFyZyApIHsKCWlmICggYXJnID09PSB0aGlzLmtleSApIHsKCQlyZXR1cm4gdGhpcy5yZWNvcmRzLm1hcCggZnVuY3Rpb24gKCBpICkgewoJCQlyZXR1cm4gaS5rZXk7CgkJfSApOwoJfQoJZWxzZSB7CgkJcmV0dXJuIHRoaXMucmVjb3Jkcy5tYXAoIGZ1bmN0aW9uICggaSApIHsKCQkJcmV0dXJuIGkuZGF0YVthcmddOwoJCX0gKTsKCX0KfTsKCi8qKgogKiBQdXJnZXMgRGF0YVN0b3JlIG9yIHJlY29yZCBmcm9tIHBlcnNpc3RhbnQgc3RvcmFnZQogKgogKiBAbWV0aG9kIHB1cmdlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge01peGVkfSBhcmcgIFtPcHRpb25hbF0gU3RyaW5nIG9yIE51bWJlciBmb3IgcmVjb3JkCiAqIEByZXR1cm4ge09iamVjdH0gICAgIFJlY29yZCBvciBzdG9yZQogKiBAZXhhbXBsZQogKiBzdG9yZS5wdXJnZSgpOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5wdXJnZSA9IGZ1bmN0aW9uICggYXJnICkgewoJcmV0dXJuIHRoaXMuc3RvcmFnZSggYXJnIHx8IHRoaXMsICJyZW1vdmUiICk7Cn07CgovKioKICogUmVpbmRleGVzIHRoZSBEYXRhU3RvcmUKICoKICogQG1ldGhvZCByZWluZGV4CiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhU3RvcmV9CiAqIEBleGFtcGxlCiAqIHN0b3JlLnJlaW5kZXgoKTsKICovCkRhdGFTdG9yZS5wcm90b3R5cGUucmVpbmRleCA9IGZ1bmN0aW9uICgpIHsKCXZhciBzZWxmID0gdGhpcywKCSAgICBpICAgID0gLTEsCgkgICAgdG1wICA9IFtdOwoKCXRoaXMudmlld3MgICA9IHt9OwoJdGhpcy5pbmRleGVzID0ge2tleToge319OwoKCWlmICggdGhpcy50b3RhbCA+IDAgKSB7CgkJYXJyYXkuZWFjaCggdGhpcy5yZWNvcmRzLCBmdW5jdGlvbiAoIHJlY29yZCApIHsKCQkJaWYgKCByZWNvcmQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRtcFsrK2ldICAgICA9IHJlY29yZDsKCQkJCXJlY29yZC5pbmRleCA9IGk7CgkJCQlzZWxmLmluZGV4ZXMua2V5W3JlY29yZC5rZXldID0gaTsKCQkJCXNlbGYuc2V0SW5kZXhlcyggcmVjb3JkICk7CgkJCX0KCQl9ICk7Cgl9CgoJdGhpcy5yZWNvcmRzID0gdG1wOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIFJlc3RvcmVzIERhdGFTdG9yZSBvciByZWNvcmQgcGVyc2lzdGFudCBzdG9yYWdlCiAqCiAqIEBtZXRob2QgcmVzdG9yZQogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFTdG9yZQogKiBAcGFyYW0gIHtNaXhlZH0gYXJnICBbT3B0aW9uYWxdIFN0cmluZyBvciBOdW1iZXIgZm9yIHJlY29yZAogKiBAcmV0dXJuIHtPYmplY3R9ICAgICBSZWNvcmQgb3Igc3RvcmUKICogQGV4YW1wbGUKICogc3RvcmUucmVzdG9yZSgpOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5yZXN0b3JlID0gZnVuY3Rpb24gKCBhcmcgKSB7CglyZXR1cm4gdGhpcy5zdG9yYWdlKCBhcmcgfHwgdGhpcywgImdldCIgKTsKfTsKCi8qKgogKiBTYXZlcyBEYXRhU3RvcmUgb3IgcmVjb3JkIHRvIHBlcnNpc3RhbnQgc3RvcmFnZSwgb3Igc2Vzc2lvblN0b3JhZ2UKICoKICogQG1ldGhvZCBzYXZlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge01peGVkfSBhcmcgIFtPcHRpb25hbF0gU3RyaW5nIG9yIE51bWJlciBmb3IgcmVjb3JkCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EZWZlcnJlZH0KICogQGV4YW1wbGUKICogc3RvcmUuc2F2ZSgpOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5zYXZlID0gZnVuY3Rpb24gKCBhcmcgKSB7CglyZXR1cm4gdGhpcy5zdG9yYWdlKCBhcmcgfHwgdGhpcywgInNldCIgKTsKfTsKCi8qKgogKiBTZWxlY3RzIHJlY29yZHMgKG5vdCBieSByZWZlcmVuY2UpIGJhc2VkIG9uIGFuIGV4cGxpY2l0IGRlc2NyaXB0aW9uCiAqCiAqIEBtZXRob2Qgc2VsZWN0CiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge09iamVjdH0gd2hlcmUgT2JqZWN0IGRlc2NyaWJpbmcgdGhlIFdIRVJFIGNsYXVzZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGVmZXJyZWR9CiAqIEBleGFtcGxlCiAqIHZhciBhZHVsdHM7CiAqCiAqIHN0b3JlLnNlbGVjdCgge2FnZTogZnVuY3Rpb24gKCBpICkgeyByZXR1cm4gaSA+PSAyMTsgfSB9ICkudGhlbiggZnVuY3Rpb24gKCByZWNvcmRzICkgewogKiAgIGFkdWx0cyA9IHJlY29yZHM7CiAqIH0sIGZ1bmN0aW9uICggZXJyICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnNlbGVjdCA9IGZ1bmN0aW9uICggd2hlcmUgKSB7Cgl2YXIgc2VsZiAgICAgID0gdGhpcywKCSAgICBkZWZlciAgICAgPSBkZWZlcnJlZC5mYWN0b3J5KCksCgkgICAgZnVuY3Rpb25zID0gW10sCgkgICAgY2xhdXNlcywgY29uZCwgaW5kZXgsIHJlc3VsdCwgc29ydGVkLCB2YWx1ZXMsIHdvcmtlcjsKCglpZiAoICEoIHdoZXJlIGluc3RhbmNlb2YgT2JqZWN0ICkgKSB7CgkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKSApOwoJfQoJZWxzZSB7CgkJdXRpbGl0eS5pdGVyYXRlKCB3aGVyZSwgZnVuY3Rpb24gKCB2LCBrICkgewoJCQlpZiAoIHR5cGVvZiB2ID09ICJmdW5jdGlvbiIgKSB7CgkJCQl0aGlzW2tdID0gdi50b1N0cmluZygpOwoJCQkJZnVuY3Rpb25zLnB1c2goIGsgKTsKCQkJfQoJCX0gKTsKCgkJaWYgKCB3ZWJXb3JrZXIgKSB7CgkJCXRyeSB7CgkJCQl3b3JrZXIgPSB1dGlsaXR5LndvcmtlciggZGVmZXIgKTsKCQkJCXdvcmtlci5wb3N0TWVzc2FnZSgge2NtZDogInNlbGVjdCIsIGluZGV4ZXM6IHRoaXMuaW5kZXhlcywgcmVjb3JkczogdGhpcy5yZWNvcmRzLCB3aGVyZToganNvbi5lbmNvZGUoIHdoZXJlICksIGZ1bmN0aW9uczogZnVuY3Rpb25zfSApOwoJCQl9CgkJCWNhdGNoICggZSApIHsKCQkJCS8vIFByb2JhYmx5IElFMTAsIHdoaWNoIGRvZXNuJ3QgaGF2ZSB0aGUgY29ycmVjdCBzZWN1cml0eSBmbGFnIGZvciBsb2NhbCBsb2FkaW5nCgkJCQl3ZWJXb3JrZXIgPSBmYWxzZTsKCgkJCQl0aGlzLnNlbGVjdCggd2hlcmUgKS50aGVuKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCQlkZWZlci5yZXNvbHZlKCBhcmcgKTsKCQkJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCQlkZWZlci5yZWplY3QoIGUgKTsKCQkJCX0gKTsKCQkJfQoJCX0KCQllbHNlIHsKCQkJY2xhdXNlcyA9IGFycmF5LmZyb21PYmplY3QoIHdoZXJlICk7CgkJCXNvcnRlZCAgPSBhcnJheS5mbGF0KCBjbGF1c2VzICkuZmlsdGVyKCBmdW5jdGlvbiAoIGksIGlkeCApIHsgcmV0dXJuIGlkeCAlIDIgPT09IDA7IH0gKS5zb3J0KCBhcnJheS5zb3J0ICk7CgkJCWluZGV4ICAgPSBzb3J0ZWQuam9pbiggInwiICk7CgkJCXZhbHVlcyAgPSBzb3J0ZWQubWFwKCBmdW5jdGlvbiAoIGkgKSB7IHJldHVybiB3aGVyZVtpXTsgfSApLmpvaW4oICJ8IiApOwoJCQljb25kICAgID0gInJldHVybiAoICI7CgoJCQlpZiAoIGZ1bmN0aW9ucy5sZW5ndGggPT09IDAgJiYgdGhpcy5pbmRleGVzW2luZGV4XSApIHsKCQkJCXJlc3VsdCA9ICggdGhpcy5pbmRleGVzW2luZGV4XVt2YWx1ZXNdIHx8IFtdICkubWFwKCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJcmV0dXJuIHNlbGYucmVjb3Jkc1tpXTsKCQkJCX0gKTsKCQkJfQoJCQllbHNlIHsKCQkJCWlmICggY2xhdXNlcy5sZW5ndGggPiAxICkgewoJCQkJCWFycmF5LmVhY2goIGNsYXVzZXMsIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCQkJCQl2YXIgYjEgPSAiKCAiOwoKCQkJCQkJaWYgKCBpZHggPiAwICkgewoJCQkJCQkJYjEgPSAiICYmICggIjsKCQkJCQkJfQoKCQkJCQkJaWYgKCBpWzFdIGluc3RhbmNlb2YgRnVuY3Rpb24gKSB7CgkJCQkJCQljb25kICs9IGIxICsgaVsxXS50b1N0cmluZygpICsgIiggcmVjLmRhdGFbXCIiICsgaVswXSArICJcIl0gKSApIjsKCQkJCQkJfQoJCQkJCQllbHNlIGlmICggIWlzTmFOKCBpWzFdICkgKSB7CgkJCQkJCQljb25kICs9IGIxICsgInJlYy5kYXRhW1wiIiArIGlbMF0gKyAiXCJdID09PSAiICsgaVsxXSArICIgKSI7CgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCQljb25kICs9IGIxICsgInJlYy5kYXRhW1wiIiArIGlbMF0gKyAiXCJdID09PSBcIiIgKyBpWzFdICsgIlwiICkiOwoJCQkJCQl9CgkJCQkJfSApOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJaWYgKCBjbGF1c2VzWzBdWzFdIGluc3RhbmNlb2YgRnVuY3Rpb24gKSB7CgkJCQkJCWNvbmQgKz0gY2xhdXNlc1swXVsxXS50b1N0cmluZygpICsgIiggcmVjLmRhdGFbXCIiICsgY2xhdXNlc1swXVswXSArICJcIl0gKSI7CgkJCQkJfQoJCQkJCWVsc2UgaWYgKCAhaXNOYU4oIGNsYXVzZXNbMF1bMV0gKSApIHsKCQkJCQkJY29uZCArPSAicmVjLmRhdGFbXCIiICsgY2xhdXNlc1swXVswXSArICJcIl0gPT09ICIgKyBjbGF1c2VzWzBdWzFdOwoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJY29uZCArPSAicmVjLmRhdGFbXCIiICsgY2xhdXNlc1swXVswXSArICJcIl0gPT09IFwiIiArIGNsYXVzZXNbMF1bMV0gKyAiXCIiOwoJCQkJCX0KCQkJCX0KCgkJCQljb25kICs9ICIgKTsiOwoKCQkJCXJlc3VsdCA9IHV0aWxpdHkuY2xvbmUoIHRoaXMucmVjb3JkcywgdHJ1ZSApLmZpbHRlciggbmV3IEZ1bmN0aW9uKCAicmVjIiwgY29uZCApICk7CgkJCX0KCgkJCWRlZmVyLnJlc29sdmUoIHJlc3VsdCApOwoJCX0KCX0KCglyZXR1cm4gZGVmZXI7Cn07CgovKioKICogQ3JlYXRlcyBvciB1cGRhdGVzIGFuIGV4aXN0aW5nIHJlY29yZAogKgogKiBAbWV0aG9kIHNldAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFTdG9yZQogKiBAcGFyYW0gIHtNaXhlZH0gICBrZXkgICAgICAgW09wdGlvbmFsXSBJbnRlZ2VyIG9yIFN0cmluZyB0byB1c2UgYXMgYSBQcmltYXJ5IEtleQogKiBAcGFyYW0gIHtPYmplY3R9ICBkYXRhICAgICAgS2V5OlZhbHVlIHBhaXJzIHRvIHNldCBhcyBmaWVsZCB2YWx1ZXMKICogQHBhcmFtICB7Qm9vbGVhbn0gYmF0Y2ggICAgIFtPcHRpb25hbF0gVHJ1ZSBpZiBjYWxsZWQgYnkgZGF0YS5iYXRjaAogKiBAcGFyYW0gIHtCb29sZWFufSBvdmVyd3JpdGUgW09wdGlvbmFsXSBPdmVyd3JpdGVzIHRoZSBleGlzdGluZyByZWNvcmQsIGlmIGZvdW5kCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EZWZlcnJlZH0KICogQGZpcmVzIGtlaWdhaS5EYXRhU3RvcmUjYmVmb3JlU2V0IEZpcmVzIGJlZm9yZSB0aGUgcmVjb3JkIGlzIHNldAogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNhZnRlclNldCBGaXJlcyBhZnRlciB0aGUgcmVjb3JkIGlzIHNldCwgdGhlIHJlY29yZCBpcyB0aGUgYXJndW1lbnQgZm9yIGxpc3RlbmVycwogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNmYWlsZWRTZXQgRmlyZXMgaWYgdGhlIHN0b3JlIGlzIFJFU1RmdWwgYW5kIHRoZSBhY3Rpb24gaXMgZGVuaWVkCiAqIEBleGFtcGxlCiAqIC8vIENyZWF0aW5nIGEgbmV3IHJlY29yZAogKiBzdG9yZS5zZXQoIG51bGwsIHsuLi59ICk7CiAqCiAqIC8vIFVwZGF0aW5nIGEgcmVjb3JkCiAqIHN0b3JlLnNldCggImtleSIsIHsuLi59ICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uICgga2V5LCBkYXRhLCBiYXRjaCwgb3ZlcndyaXRlICkgewoJZGF0YSAgICAgICA9IHV0aWxpdHkuY2xvbmUoIGRhdGEsIHRydWUgKTsKCWJhdGNoICAgICAgPSAoIGJhdGNoID09PSB0cnVlICk7CglvdmVyd3JpdGUgID0gKCBvdmVyd3JpdGUgPT09IHRydWUgKTsKCXZhciBzZWxmICAgPSB0aGlzLAoJICAgIGV2ZW50cyA9IHRoaXMuZXZlbnRzLAoJICAgIGRlZmVyICA9IGRlZmVycmVkLmZhY3RvcnkoKSwKCSAgICByZWNvcmQgPSBrZXkgIT09IG51bGwgPyB0aGlzLmdldCgga2V5ICkgfHwgbnVsbCA6IGRhdGFbdGhpcy5rZXldID8gdGhpcy5nZXQoIGRhdGFbdGhpcy5rZXldICkgfHwgbnVsbCA6IG51bGwsCgkgICAgbWV0aG9kID0gIlBPU1QiLAoJICAgIHBhcnNlZCA9IHV0aWxpdHkucGFyc2UoIHNlbGYudXJpIHx8ICIiICksCgkgICAgdXJpLCBvZGF0YSwgcmRlZmVyOwoKCWZ1bmN0aW9uIHBhdGNoICggb3ZlcndyaXRlLCBkYXRhLCBvZ2RhdGEgKSB7CgkJdmFyIG5kYXRhID0gW107CgoJCWlmICggb3ZlcndyaXRlICkgewoJCQlhcnJheS5lYWNoKCBhcnJheS5rZXlzKCBvZ2RhdGEgKSwgZnVuY3Rpb24gKCBrICkgewoJCQkJaWYgKCBrICE9PSBzZWxmLmtleSAmJiBkYXRhW2tdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJbmRhdGEucHVzaCggeyBvcDogInJlbW92ZSIsIHBhdGg6ICIvIiArIGsgfSApOwoJCQkJfQoJCQl9ICk7CgkJfQoKCQl1dGlsaXR5Lml0ZXJhdGUoIGRhdGEsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJaWYgKCBrICE9PSBzZWxmLmtleSAmJiBvZ2RhdGFba10gPT09IHVuZGVmaW5lZCApIHsKCQkJCW5kYXRhLnB1c2goIHsgb3A6ICJhZGQiLCBwYXRoOiAiLyIgKyBrLCB2YWx1ZTogdiB9ICk7CgkJCX0KCQkJZWxzZSBpZiAoIGpzb24uZW5jb2RlKCBvZ2RhdGFba10gKSAhPT0ganNvbi5lbmNvZGUoIHYgKSApIHsKCQkJCW5kYXRhLnB1c2goIHsgb3A6ICJyZXBsYWNlIiwgcGF0aDogIi8iICsgaywgdmFsdWU6IHYgfSApOwoJCQl9CgkJfSApOwoKCQlyZXR1cm4gbmRhdGE7Cgl9CgoJaWYgKCB0eXBlb2YgZGF0YSA9PSAic3RyaW5nIiApIHsKCQlpZiAoIGRhdGEuaW5kZXhPZiggIi8vIiApID09PSAtMSApIHsKCQkJLy8gUmVsYXRpdmUgcGF0aCB0byBzdG9yZSwgaS5lLiBhIGNoaWxkCgkJCWlmICggZGF0YS5jaGFyQXQoIDAgKSAhPT0gIi8iICkgewoJCQkJdXJpID0gdGhpcy5idWlsZFVyaSggZGF0YSApOwoJCQl9CgkJCS8vIFJvb3QgcGF0aCwgcmVsYXRpdmUgdG8gc3RvcmUsIGkuZS4gYSBkb21haW4KCQkJZWxzZSBpZiAoIHNlbGYudXJpICE9PSBudWxsICYmIHJlZ2V4LnJvb3QudGVzdCggZGF0YSApICkgewoJCQkJdXJpID0gcGFyc2VkLnByb3RvY29sICsgIi8vIiArIHBhcnNlZC5ob3N0ICsgZGF0YTsKCQkJfQoJCQllbHNlIHsKCQkJCXVyaSA9IGRhdGE7CgkJCX0KCQl9CgkJZWxzZSB7CgkJCXVyaSA9IGRhdGE7CgkJfQoKCQlrZXkgPSB1cmkucmVwbGFjZSggcmVnZXgubm90X2VuZHBvaW50LCAiIiApOwoKCQlpZiAoIHN0cmluZy5pc0VtcHR5KCBrZXkgKSApIHsKCQkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKSApOwoJCX0KCQllbHNlIHsKCQkJaWYgKCAhYmF0Y2ggJiYgZXZlbnRzICkgewoJCQkJc2VsZi5kaXNwYXRjaCggImJlZm9yZVNldCIsIHtrZXk6IGtleSwgZGF0YTogZGF0YX0gKTsKCQkJfQoKCQkJY2xpZW50LnJlcXVlc3QoIHVyaSwgIkdFVCIsIG51bGwsIHV0aWxpdHkubWVyZ2UoIHt3aXRoQ3JlZGVudGlhbHM6IHNlbGYuY3JlZGVudGlhbHN9LCBzZWxmLmhlYWRlcnMgKSApLnRoZW4oIGZ1bmN0aW9uICggYXJnICkgewoJCQkJc2VsZi5zZXRDb21wbGV0ZSggcmVjb3JkLCBrZXksIHNlbGYuc291cmNlID8gdXRpbGl0eS53YWxrKCBhcmcsIHNlbGYuc291cmNlICkgOiBhcmcsIGJhdGNoLCBvdmVyd3JpdGUsIGRlZmVyICk7CgkJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCXNlbGYuZGlzcGF0Y2goICJmYWlsZWRTZXQiLCBlICk7CgkJCQlkZWZlci5yZWplY3QoIGUgKTsKCQkJfSApOwoJCX0KCX0KCWVsc2UgewoJCWlmICggIWJhdGNoICYmIGV2ZW50cyApIHsKCQkJc2VsZi5kaXNwYXRjaCggImJlZm9yZVNldCIsIHtrZXk6IGtleSwgZGF0YTogZGF0YX0gKTsKCQl9CgoJCWlmICggYmF0Y2ggfHwgdGhpcy51cmkgPT09IG51bGwgKSB7CgkJCXRoaXMuc2V0Q29tcGxldGUoIHJlY29yZCwga2V5LCBkYXRhLCBiYXRjaCwgb3ZlcndyaXRlLCBkZWZlciApOwoJCX0KCQllbHNlIHsKCQkJaWYgKCBrZXkgIT09IG51bGwgKSB7CgkJCQl1cmkgICAgPSB0aGlzLmJ1aWxkVXJpKCBrZXkgKTsKCQkJCW1ldGhvZCA9ICJQQVRDSCI7CgkJCQlvZGF0YSAgPSB1dGlsaXR5LmNsb25lKCBkYXRhLCB0cnVlICk7CgkJCQlkYXRhICAgPSBwYXRjaCggb3ZlcndyaXRlLCBkYXRhLCB0aGlzLmR1bXAoIFsgcmVjb3JkIF0gKVsgMCBdICk7CgkJCX0KCQkJZWxzZSB7CgkJCQkvLyBEcm9wcGluZyBxdWVyeSBzdHJpbmcKCQkJCXVyaSA9IHBhcnNlZC5wcm90b2NvbCArICIvLyIgKyBwYXJzZWQuaG9zdCArIHBhcnNlZC5wYXRobmFtZTsKCQkJfQoKCQkJcmRlZmVyID0gY2xpZW50LnJlcXVlc3QoIHVyaSwgbWV0aG9kLCBkYXRhLCB1dGlsaXR5Lm1lcmdlKCB7d2l0aENyZWRlbnRpYWxzOiB0aGlzLmNyZWRlbnRpYWxzfSwgdGhpcy5oZWFkZXJzICkgKTsKCQkJcmRlZmVyLnRoZW4oIGZ1bmN0aW9uICggYXJnICkgewoJCQkJdmFyIGNoYW5nZTsKCgkJCQlpZiAoIHJkZWZlci54aHIuc3RhdHVzICE9PSAyMDQgJiYgcmRlZmVyLnhoci5zdGF0dXMgPCAzMDAgKSB7CgkJCQkJY2hhbmdlID0ga2V5ID09PSBudWxsID8gKCBzZWxmLnNvdXJjZSA/IHV0aWxpdHkud2FsayggYXJnLCBzZWxmLnNvdXJjZSApIDogYXJnICkgOiBvZGF0YTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWNoYW5nZSA9IG9kYXRhOwoJCQkJfQoKCQkJCXNlbGYuc2V0Q29tcGxldGUoIHJlY29yZCwga2V5LCBjaGFuZ2UsIGJhdGNoLCBvdmVyd3JpdGUsIGRlZmVyICk7CgkJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCWlmICggbWV0aG9kID09ICJQQVRDSCIgKSB7CgkJCQkJbWV0aG9kID0gIlBVVCI7CgkJCQkJZGF0YSAgID0gdXRpbGl0eS5jbG9uZSggb2RhdGEsIHRydWUgKTsKCgkJCQkJdXRpbGl0eS5pdGVyYXRlKCByZWNvcmQuZGF0YSwgZnVuY3Rpb24gKCB2LCBrICkgewoJCQkJCQlkYXRhW2tdID0gdjsKCQkJCQl9ICk7CgoJCQkJCWNsaWVudC5yZXF1ZXN0KCB1cmksIG1ldGhvZCwgZGF0YSwgdXRpbGl0eS5tZXJnZSgge3dpdGhDcmVkZW50aWFsczogc2VsZi5jcmVkZW50aWFsc30sIHNlbGYuaGVhZGVycyApICkudGhlbiggZnVuY3Rpb24gKCkgewoJCQkJCQlzZWxmLnNldENvbXBsZXRlKCByZWNvcmQsIGtleSwgb2RhdGEsIGJhdGNoLCBvdmVyd3JpdGUsIGRlZmVyICk7CgkJCQkJfSwgZnVuY3Rpb24gKCBlICkgewoJCQkJCQlzZWxmLmRpc3BhdGNoKCAiZmFpbGVkU2V0IiwgZSApOwoJCQkJCQlkZWZlci5yZWplY3QoIGUgKTsKCQkJCQl9ICk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlzZWxmLmRpc3BhdGNoKCAiZmFpbGVkU2V0IiwgZSApOwoJCQkJCWRlZmVyLnJlamVjdCggZSApOwoJCQkJfQoJCQl9ICk7CgkJfQoJfQoKCXJldHVybiBkZWZlcjsKfTsKCi8qKgogKiBTZXQgY29tcGxldGlvbgogKgogKiBAbWV0aG9kIHNldENvbXBsZXRlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge01peGVkfSAgIHJlY29yZCAgICBEYXRhU3RvcmUgcmVjb3JkLCBvciBgbnVsbGAgaWYgbmV3CiAqIEBwYXJhbSAge1N0cmluZ30gIGtleSAgICAgICBSZWNvcmQga2V5CiAqIEBwYXJhbSAge09iamVjdH0gIGRhdGEgICAgICBSZWNvcmQgZGF0YQogKiBAcGFyYW0gIHtCb29sZWFufSBiYXRjaCAgICAgYHRydWVgIGlmIHBhcnQgb2YgYSBiYXRjaCBvcGVyYXRpb24KICogQHBhcmFtICB7Qm9vbGVhbn0gb3ZlcndyaXRlIE92ZXJ3cml0ZXMgdGhlIGV4aXN0aW5nIHJlY29yZCwgaWYgZm91bmQKICogQHBhcmFtICB7T2JqZWN0fSAgZGVmZXIgICAgIERlZmVycmVkIGluc3RhbmNlCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhU3RvcmV9CiAqIEBwcml2YXRlCiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnNldENvbXBsZXRlID0gZnVuY3Rpb24gKCByZWNvcmQsIGtleSwgZGF0YSwgYmF0Y2gsIG92ZXJ3cml0ZSwgZGVmZXIgKSB7CgkvLyBDbGVhcmluZyB2aWV3cwoJdGhpcy52aWV3cyA9IHt9OwoKCS8vIFNldHRpbmcga2V5CglpZiAoIGtleSA9PT0gbnVsbCApIHsKCQlpZiAoIHRoaXMua2V5ICE9PSBudWxsICYmIGRhdGFbdGhpcy5rZXldICE9PSB1bmRlZmluZWQgJiYgZGF0YVt0aGlzLmtleV0gIT09IG51bGwgKSB7CgkJCWtleSA9IGRhdGFbdGhpcy5rZXldLnRvU3RyaW5nKCk7CgkJfQoJCWVsc2UgewoJCQlrZXkgPSB1dGlsaXR5LnV1aWQoKTsKCQl9Cgl9CgoJLy8gUmVtb3ZpbmcgcHJpbWFyeSBrZXkgZnJvbSBkYXRhCglpZiAoIHRoaXMua2V5ICkgewoJCWRlbGV0ZSBkYXRhW3RoaXMua2V5XTsKCX0KCgkvLyBDcmVhdGUKCWlmICggcmVjb3JkID09PSBudWxsICkgewoJCXJlY29yZCA9IHsKCQkJaW5kZXggICA6IHRoaXMudG90YWwrKywKCQkJa2V5ICAgICA6IGtleSwKCQkJZGF0YSAgICA6IGRhdGEsCgkJCWluZGV4ZXMgOiBbXQoJCX07CgoJCXRoaXMuaW5kZXhlcy5rZXlba2V5XSAgICAgICAgID0gcmVjb3JkLmluZGV4OwoJCXRoaXMucmVjb3Jkc1tyZWNvcmQuaW5kZXhdICAgID0gcmVjb3JkOwoKCQlpZiAoIHRoaXMudmVyc2lvbmluZyApIHsKCQkJdGhpcy52ZXJzaW9uc1tyZWNvcmQua2V5XSA9IGxydS5mYWN0b3J5KCBWRVJTSU9OUyApOwoJCQl0aGlzLnZlcnNpb25zW3JlY29yZC5rZXldLm50aCA9IDA7CgkJfQoJfQoJLy8gVXBkYXRlCgllbHNlIHsKCQlpZiAoIHRoaXMudmVyc2lvbmluZyApIHsKCQkJaWYgKCB0aGlzLnZlcnNpb25zW3JlY29yZC5rZXldID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLnZlcnNpb25zW3JlY29yZC5rZXldICAgICA9IGxydS5mYWN0b3J5KCBWRVJTSU9OUyApOwoJCQkJdGhpcy52ZXJzaW9uc1tyZWNvcmQua2V5XS5udGggPSAwOwoJCQl9CgoJCQl0aGlzLnZlcnNpb25zW3JlY29yZC5rZXldLnNldCggInYiICsgKCArK3RoaXMudmVyc2lvbnNbcmVjb3JkLmtleV0ubnRoICksIHRoaXMuZHVtcCggW3JlY29yZF0gKVswXSApOwoJCX0KCgkJLy8gQnkgcmVmZXJlbmNlCgkJcmVjb3JkID0gdGhpcy5yZWNvcmRzW3JlY29yZC5pbmRleF07CgoJCWlmICggb3ZlcndyaXRlICkgewoJCQlyZWNvcmQuZGF0YSA9IHt9OwoJCX0KCgkJdXRpbGl0eS5pdGVyYXRlKCBkYXRhLCBmdW5jdGlvbiAoIHYsIGsgKSB7CgkJCXJlY29yZC5kYXRhW2tdID0gdjsKCQl9ICk7CgoJCS8vIFNuYXBzaG90IHRoYXQncyBzYWZlIHRvIGhhbmQgb3V0CgkJcmVjb3JkID0gdXRpbGl0eS5jbG9uZSggcmVjb3JkLCB0cnVlICk7Cgl9CgoJdGhpcy5zZXRJbmRleGVzKCByZWNvcmQgKTsKCglpZiAoICFiYXRjaCApIHsKCQlpZiAoIHRoaXMuYXV0b3NhdmUgKSB7CgkJCXRoaXMuc2F2ZSgpOwoJCX0KCgkJaWYgKCB0aGlzLmV2ZW50cyApIHsKCQkJdGhpcy5kaXNwYXRjaCggImFmdGVyU2V0IiwgcmVjb3JkICk7CgkJfQoKCQlhcnJheS5lYWNoKCB0aGlzLmxpc3RzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCWkucmVmcmVzaCgpOwoJCX0gKTsKCX0KCglkZWZlci5yZXNvbHZlKCByZWNvcmQgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBHZXRzIG9yIHNldHMgYW4gZXhwbGljaXQgZXhwaXJhdGlvbiBvZiBkYXRhCiAqCiAqIEBtZXRob2Qgc2V0RXhwaXJlcwogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFTdG9yZQogKiBAcGFyYW0gIHtOdW1iZXJ9IGFyZyBNaWxsaXNlY29uZHMgdW50aWwgZGF0YSBpcyBzdGFsZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YVN0b3JlfQogKiBAZXhhbXBsZQogKiBzdG9yZS5zZXRFeHBpcmVzKCA1ICogNjAgKiAxMDAwICk7IC8vIFJlc3luY3MgZXZlcnkgNSBtaW51dGVzCiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnNldEV4cGlyZXMgPSBmdW5jdGlvbiAoIGFyZyApIHsKCXZhciBpZCAgICAgID0gdGhpcy5pZCArICJFeHBpcmUiLAoJICAgIGV4cGlyZXMgPSBhcmcsCgkgICAgc2VsZiAgICA9IHRoaXM7CgoJLy8gRXhwaXJ5IGNhbm5vdCBiZSBsZXNzIHRoYW4gYSBzZWNvbmQsIGFuZCBtdXN0IGJlIGEgdmFsaWQgc2NlbmFyaW8gZm9yIGNvbnN1bXB0aW9uOyBudWxsIHdpbGwgZGlzYWJsZSByZXBldGl0aXZlIGV4cGlyYXRpb24KCWlmICggKCBhcmcgIT09IG51bGwgJiYgdGhpcy51cmkgPT09IG51bGwgKSB8fCAoIGFyZyAhPT0gbnVsbCAmJiAoIGlzTmFOKCBhcmcgKSB8fCBhcmcgPCAxMDAwICkgKSApIHsKCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCX0KCglpZiAoIHRoaXMuZXhwaXJlcyA9PT0gYXJnICkgewoJCXJldHVybjsKCX0KCgl0aGlzLmV4cGlyZXMgPSBhcmc7CgoJdXRpbGl0eS5jbGVhclRpbWVycyggaWQgKTsKCglpZiAoIGFyZyA9PT0gbnVsbCApIHsKCQlyZXR1cm47Cgl9CgoJdXRpbGl0eS5yZXBlYXQoIGZ1bmN0aW9uICgpIHsKCQlpZiAoIHNlbGYudXJpID09PSBudWxsICkgewoJCQlzZWxmLnNldEV4cGlyZXMoIG51bGwgKTsKCgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXNlbGYuZGlzcGF0Y2goICJiZWZvcmVFeHBpcmUiKTsKCQljYWNoZS5leHBpcmUoIHNlbGYudXJpICk7CgkJc2VsZi5kaXNwYXRjaCggImV4cGlyZSIpOwoJCXNlbGYuZGlzcGF0Y2goICJhZnRlckV4cGlyZSIpOwoJfSwgZXhwaXJlcywgaWQsIGZhbHNlICk7Cn07CgovKioKICogU2V0cyBpbmRleGVzIGZvciBhIHJlY29yZCB1c2luZyBgc3RvcmUuaW5kZXhlc2AKICoKICogQ29tcG9zaXRlIGluZGV4ZXMgYXJlIHN1cHBvcnRlZCwgYnV0IHJlcXVpcmUga2V5cyBiZSBpbiBhbHBoYWJldGljYWwgb3JkZXIsIGUuZy4gImFnZXxuYW1lIgogKgogKiBAbWV0aG9kIHNldEluZGV4ZXMKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7T2JqZWN0fSBhcmcgRGF0YVN0b3JlIFJlY29yZAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YVN0b3JlfQogKiBAZXhhbXBsZQogKiBzdG9yZS5zZXRJbmRleGVzKCByZWNvcmQgKTsKICovCkRhdGFTdG9yZS5wcm90b3R5cGUuc2V0SW5kZXhlcyA9IGZ1bmN0aW9uICggYXJnICkgewoJdmFyIHNlbGYgICAgID0gdGhpcywKCSAgICBkZWxpbXRlciA9ICJ8IjsKCglhcmcuaW5kZXhlcyA9IFtdOwoKCWFycmF5LmVhY2goIHRoaXMuaW5kZXgsIGZ1bmN0aW9uICggaSApIHsKCQl2YXIga2V5cyAgID0gaS5zcGxpdCggZGVsaW10ZXIgKSwKCQkgICAgdmFsdWVzID0gIiI7CgoJCWlmICggc2VsZi5pbmRleGVzW2ldID09PSB1bmRlZmluZWQgKSB7CgkJCXNlbGYuaW5kZXhlc1tpXSA9IHt9OwoJCX0KCgkJYXJyYXkuZWFjaCgga2V5cywgZnVuY3Rpb24gKCBrLCBrZHggKSB7CgkJCXZhbHVlcyArPSAoIGtkeCA+IDAgPyBkZWxpbXRlciA6ICIiICkgKyBhcmcuZGF0YVtrXTsKCQl9ICk7CgoJCWlmICggc2VsZi5pbmRleGVzW2ldW3ZhbHVlc10gPT09IHVuZGVmaW5lZCApIHsKCQkJc2VsZi5pbmRleGVzW2ldW3ZhbHVlc10gPSBbXTsKCQl9CgoJCWlmICggIWFycmF5LmNvbnRhaW5zKCBzZWxmLmluZGV4ZXNbaV1bdmFsdWVzXSwgYXJnLmluZGV4ICkgKSB7CgkJCXNlbGYuaW5kZXhlc1tpXVt2YWx1ZXNdLnB1c2goIGFyZy5pbmRleCApOwoJCQlhcmcuaW5kZXhlcy5wdXNoKCBbaSwgdmFsdWVzXSApOwoJCX0KCX0gKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBTZXRzIHRoZSBSRVNUZnVsIEFQSSBlbmQgcG9pbnQKICoKICogQG1ldGhvZCBzZXRVcmkKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7U3RyaW5nfSBhcmcgQVBJIGNvbGxlY3Rpb24gZW5kIHBvaW50CiAqIEByZXR1cm4ge09iamVjdH0gICAgIERlZmVycmVkCiAqIEBleGFtcGxlCiAqIHN0b3JlLnNldFVyaSggIi4uLiIgKS50aGVuKCBmdW5jdGlvbiAoIHJlY29yZHMgKSB7CiAqICAgLi4uCiAqIH0sIGZ1bmN0aW9uICggZXJyICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnNldFVyaSA9IGZ1bmN0aW9uICggYXJnICkgewoJdmFyIGRlZmVyID0gZGVmZXJyZWQuZmFjdG9yeSgpLAoJICAgIHBhcnNlZDsKCglpZiAoIGFyZyAhPT0gbnVsbCAmJiBzdHJpbmcuaXNFbXB0eSggYXJnICkgKSB7CgkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKSApOwoJfQoKCWlmICggYXJnID09PSBudWxsICkgewoJCXRoaXMudXJpID0gYXJnOwoJfQoJZWxzZSB7CgkJcGFyc2VkICAgPSB1dGlsaXR5LnBhcnNlKCBhcmcgKTsKCQl0aGlzLnVyaSA9IHBhcnNlZC5wcm90b2NvbCArICIvLyIgKyBwYXJzZWQuaG9zdCArIHBhcnNlZC5wYXRoOwoKCQlpZiAoICFzdHJpbmcuaXNFbXB0eSggcGFyc2VkLmF1dGggKSAmJiAhdGhpcy5oZWFkZXJzLmF1dGhvcml6YXRpb24gJiYgIXRoaXMuaGVhZGVycy5BdXRob3JpemF0aW9uICkgewoJCQl0aGlzLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9ICJCYXNpYyAiICsgYnRvYSggZGVjb2RlVVJJQ29tcG9uZW50KCBwYXJzZWQuYXV0aCApICk7CgkJfQoKCQl0aGlzLm9uKCAiZXhwaXJlIiwgZnVuY3Rpb24gKCkgewoJCQl0aGlzLnN5bmMoKTsKCQl9LCAicmVzeW5jIiwgdGhpcyApOwoKCQljYWNoZS5leHBpcmUoIHRoaXMudXJpICk7CgoJCXRoaXMuc3luYygpLnRoZW4oIGZ1bmN0aW9uIChhcmcgKSB7CgkJCWRlZmVyLnJlc29sdmUoIGFyZyApOwoJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJfSApOwoJfQoKCXJldHVybiBkZWZlcjsKfTsKCi8qKgogKiBDcmVhdGVzLCBvciByZXR1cm5zIGEgY2FjaGVkIHZpZXcgb2YgdGhlIHJlY29yZHMgKG5vdCBieSByZWZlcmVuY2UpCiAqCiAqIEBtZXRob2Qgc29ydAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFTdG9yZQogKiBAcGFyYW0gIHtTdHJpbmd9IHF1ZXJ5ICBTUUwgKCBzdHlsZSApIG9yZGVyIGJ5CiAqIEBwYXJhbSAge1N0cmluZ30gY3JlYXRlIFtPcHRpb25hbCwgZGVmYXVsdCBiZWhhdmlvciBpcyB0cnVlLCB2YWx1ZSBpcyBmYWxzZV0gQm9vbGVhbiBkZXRlcm1pbmVzIHdoZXRoZXIgdG8gcmVjcmVhdGUgYSB2aWV3IGlmIGl0IGV4aXN0cwogKiBAcGFyYW0gIHtPYmplY3R9IHdoZXJlICBbT3B0aW9uYWxdIE9iamVjdCBkZXNjcmliaW5nIHRoZSBXSEVSRSBjbGF1c2UKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZXhhbXBsZQogKiBzdG9yZS5zb3J0KCAiYWdlIGRlc2MsIG5hbWUiICkudGhlbiggZnVuY3Rpb24gKCByZWNvcmRzICkgewogKiAgIC4uLgogKiB9LCBmdW5jdGlvbiAoIGVyciApIHsKICogICAuLi4KICogfSApOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5zb3J0ID0gZnVuY3Rpb24gKCBxdWVyeSwgY3JlYXRlLCB3aGVyZSApIHsKCWNyZWF0ZSAgICAgID0gKCBjcmVhdGUgPT09IHRydWUgfHwgKCB3aGVyZSBpbnN0YW5jZW9mIE9iamVjdCApICk7Cgl2YXIgc2VsZiAgICA9IHRoaXMsCgkgICAgdmlldyAgICA9IHN0cmluZy50b0NhbWVsQ2FzZSggc3RyaW5nLmV4cGxvZGUoIHF1ZXJ5ICkuam9pbiggIiAiICkgKSwKCSAgICBkZWZlciAgID0gZGVmZXJyZWQuZmFjdG9yeSgpLAoJICAgIG5leHQsIHdvcmtlcjsKCgkvLyBOZXh0IHBoYXNlCgluZXh0ID0gZnVuY3Rpb24gKCByZWNvcmRzICkgewoJCWlmICggc2VsZi50b3RhbCA9PT0gMCApIHsKCQkJZGVmZXIucmVzb2x2ZSggW10gKTsKCQl9CgkJZWxzZSBpZiAoICFjcmVhdGUgJiYgc2VsZi52aWV3c1t2aWV3XSApIHsKCQkJZGVmZXIucmVzb2x2ZSggc2VsZi52aWV3c1t2aWV3XSApOwoJCX0KCQllbHNlIGlmICggd2ViV29ya2VyICkgewoJCQlkZWZlci50aGVuKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCXNlbGYudmlld3Nbdmlld10gPSBhcmc7CgoJCQkJcmV0dXJuIHNlbGYudmlld3Nbdmlld107CgkJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCXV0aWxpdHkuZXJyb3IoIGUgKTsKCQkJfSApOwoKCQkJdHJ5IHsKCQkJCXdvcmtlciA9IHV0aWxpdHkud29ya2VyKCBkZWZlciApOwoJCQkJd29ya2VyLnBvc3RNZXNzYWdlKCB7Y21kOiAic29ydCIsIGluZGV4ZXM6IHNlbGYuaW5kZXhlcywgcmVjb3JkczogcmVjb3JkcywgcXVlcnk6IHF1ZXJ5fSApOwoJCQl9CgkJCWNhdGNoICggZSApIHsKCQkJCS8vIFByb2JhYmx5IElFMTAsIHdoaWNoIGRvZXNuJ3QgaGF2ZSB0aGUgY29ycmVjdCBzZWN1cml0eSBmbGFnIGZvciBsb2NhbCBsb2FkaW5nCgkJCQl3ZWJXb3JrZXIgPSBmYWxzZTsKCgkJCQlzZWxmLnZpZXdzW3ZpZXddID0gYXJyYXkua2V5U29ydCggcmVjb3JkcywgcXVlcnksICJkYXRhIiApOwoJCQkJZGVmZXIucmVzb2x2ZSggc2VsZi52aWV3c1t2aWV3XSApOwoJCQl9CgkJfQoJCWVsc2UgewoJCQlzZWxmLnZpZXdzW3ZpZXddID0gYXJyYXkua2V5U29ydCggcmVjb3JkcywgcXVlcnksICJkYXRhIiApOwoJCQlkZWZlci5yZXNvbHZlKCBzZWxmLnZpZXdzW3ZpZXddICk7CgkJfQoJfTsKCglpZiAoICF3aGVyZSApIHsKCQluZXh0KCB1dGlsaXR5LmNsb25lKCB0aGlzLnJlY29yZHMsIHRydWUgKSApOwoJfQoJZWxzZSB7CgkJdGhpcy5zZWxlY3QoIHdoZXJlICkudGhlbiggbmV4dCwgZnVuY3Rpb24gKCBlICkgewoJCQlkZWZlci5yZWplY3QoIGUgKTsKCQl9ICk7Cgl9CgoJcmV0dXJuIGRlZmVyOwp9OwoKLyoqCiAqIFN0b3JhZ2UgaW50ZXJmYWNlCiAqCiAqIFNRTC9Ob1NRTCBiYWNrZW5kcyB3aWxsIGJlIHVzZWQgaWYgY29uZmlndXJlZCBpbiBsaWV1IG9mIGxvY2FsU3RvcmFnZSAobm9kZS5qcyBvbmx5KQogKgogKiBAbWV0aG9kIHN0b3JhZ2UKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7TWl4ZWR9ICBvYmogIFJlY29yZCAoIE9iamVjdCwga2V5IG9yIGluZGV4ICkgb3Igc3RvcmUKICogQHBhcmFtICB7T2JqZWN0fSBvcCAgIE9wZXJhdGlvbiB0byBwZXJmb3JtICggZ2V0LCByZW1vdmUgb3Igc2V0ICkKICogQHBhcmFtICB7U3RyaW5nfSB0eXBlIFtPcHRpb25hbF0gVHlwZSBvZiBTdG9yYWdlIHRvIHVzZSAoIGxvY2FsLCBzZXNzaW9uIFtsb2NhbF0gKQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGVmZXJyZWR9CiAqIEBleGFtcGxlCiAqIHN0b3JlLnN0b3JhZ2UoIHN0b3JlLCAic2V0IiApOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5zdG9yYWdlID0gZnVuY3Rpb24gKCBvYmosIG9wLCB0eXBlICkgewoJdmFyIHNlbGYgICAgPSB0aGlzLAoJICAgIHJlY29yZCAgPSBmYWxzZSwKCSAgICBtb25nbyAgID0gIXN0cmluZy5pc0VtcHR5KCB0aGlzLm1vbmdvZGIgKSwKCSAgICBzZXNzaW9uID0gKCB0eXBlID09PSAic2Vzc2lvbiIgJiYgdHlwZW9mIHNlc3Npb25TdG9yYWdlICE9ICJ1bmRlZmluZWQiICksCgkgICAgZGVmZXIgICA9IGRlZmVycmVkLmZhY3RvcnkoKSwKCSAgICBkYXRhLCBrZXksIHJlc3VsdDsKCglpZiAoICFyZWdleC5udW1iZXJfc3RyaW5nX29iamVjdC50ZXN0KCB0eXBlb2Ygb2JqICkgfHwgIXJlZ2V4LmdldF9yZW1vdmVfc2V0LnRlc3QoIG9wICkgKSB7CgkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKSApOwoJfQoJZWxzZSB7CgkJcmVjb3JkID0gKCByZWdleC5udW1iZXJfc3RyaW5nLnRlc3QoIHR5cGVvZiBvYmogKSB8fCBvYmouaGFzT3duUHJvcGVydHkoICJkYXRhIiApICk7CgoJCWlmICggb3AgIT09ICJyZW1vdmUiICkgewoJCQlpZiAoIHJlY29yZCAmJiAhKCBvYmogaW5zdGFuY2VvZiBPYmplY3QgKSApIHsKCQkJCW9iaiA9IHRoaXMuZ2V0KCBvYmogKTsKCQkJfQoKCQkJa2V5ID0gcmVjb3JkID8gb2JqLmtleSA6IG9iai5pZDsKCQl9CgkJZWxzZSBpZiAoIG9wID09PSAicmVtb3ZlIiAmJiByZWNvcmQgKSB7CgkJCWtleSA9IG9iai5rZXkgfHwgb2JqOwoJCX0KCgkJaWYgKCBtb25nbyApIHsKCQkJbW9uZ29kYi5jb25uZWN0KCB0aGlzLm1vbmdvZGIsIGZ1bmN0aW9uICggZSwgZGIgKSB7CgkJCQlpZiAoIGUgKSB7CgkJCQkJaWYgKCBkYiApIHsKCQkJCQkJZGIuY2xvc2UoKTsKCQkJCQl9CgoJCQkJCXJldHVybiBkZWZlci5yZWplY3QoIGUgKTsKCQkJCX0KCgkJCQlkYi5jb2xsZWN0aW9uKCBzZWxmLmlkLCBmdW5jdGlvbiAoIGUsIGNvbGxlY3Rpb24gKSB7CgkJCQkJaWYgKCBlICkgewoJCQkJCQlkYi5jbG9zZSgpOwoJCQkJCQlyZXR1cm4gZGVmZXIucmVqZWN0KCBlICk7CgkJCQkJfQoKCQkJCQlpZiAoIG9wID09PSAiZ2V0IiApIHsKCQkJCQkJaWYgKCByZWNvcmQgKSB7CgkJCQkJCQljb2xsZWN0aW9uLmZpbmQoIHtfaWQ6IG9iai5rZXl9ICkubGltaXQoIDEgKS50b0FycmF5KCBmdW5jdGlvbiAoIGUsIHJlY3MgKSB7CgkJCQkJCQkJZGIuY2xvc2UoKTsKCgkJCQkJCQkJaWYgKCBlICkgewoJCQkJCQkJCQlkZWZlci5yZWplY3QoIGUgKTsKCQkJCQkJCQl9CgkJCQkJCQkJZWxzZSBpZiAoIHJlY3MubGVuZ3RoID09PSAwICkgewoJCQkJCQkJCQlkZWZlci5yZXNvbHZlKCBudWxsICk7CgkJCQkJCQkJfQoJCQkJCQkJCWVsc2UgewoJCQkJCQkJCQlkZWxldGUgcmVjc1swXS5faWQ7CgoJCQkJCQkJCQlzZWxmLnNldCgga2V5LCByZWNzWzBdLCB0cnVlICkudGhlbiggZnVuY3Rpb24gKCByZWMgKSB7CgkJCQkJCQkJCQlkZWZlci5yZXNvbHZlKCByZWMgKTsKCQkJCQkJCQkJfSwgZnVuY3Rpb24gKCBlICkgewoJCQkJCQkJCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJCQkJCQkJCX0gKTsKCQkJCQkJCQl9CgkJCQkJCQl9ICk7CgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCQljb2xsZWN0aW9uLmZpbmQoIHt9ICkudG9BcnJheSggZnVuY3Rpb24gKCBlLCByZWNzICkgewoJCQkJCQkJCXZhciBpLCBudGg7CgoJCQkJCQkJCWlmICggZSApIHsKCQkJCQkJCQkJZGIuY2xvc2UoKTsKCQkJCQkJCQkJcmV0dXJuIGRlZmVyLnJlamVjdCggZSApOwoJCQkJCQkJCX0KCgkJCQkJCQkJaSAgID0gLTE7CgkJCQkJCQkJbnRoID0gcmVjcy5sZW5ndGg7CgoJCQkJCQkJCWlmICggbnRoID4gMCApIHsKCQkJCQkJCQkJc2VsZi5yZWNvcmRzID0gcmVjcy5tYXAoIGZ1bmN0aW9uICggciApIHsKCQkJCQkJCQkJCXZhciByZWMgPSB7a2V5OiByLl9pZCwgaW5kZXg6ICsraSwgZGF0YToge319OwoKCQkJCQkJCQkJCXNlbGYuaW5kZXhlcy5rZXlbcmVjLmtleV0gPSByZWMuaW5kZXg7CgkJCQkJCQkJCQlyZWMuZGF0YSA9IHI7CgkJCQkJCQkJCQlkZWxldGUgcmVjLmRhdGEuX2lkOwoJCQkJCQkJCQkJc2VsZi5zZXRJbmRleGVzKCByZWMgKTsKCgkJCQkJCQkJCQlyZXR1cm4gcmVjOwoJCQkJCQkJCQl9ICk7CgoJCQkJCQkJCQlzZWxmLnRvdGFsID0gbnRoOwoJCQkJCQkJCX0KCgkJCQkJCQkJZGIuY2xvc2UoKTsKCQkJCQkJCQlkZWZlci5yZXNvbHZlKCBzZWxmLnJlY29yZHMgKTsKCQkJCQkJCX0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQllbHNlIGlmICggb3AgPT09ICJyZW1vdmUiICkgewoJCQkJCQljb2xsZWN0aW9uLnJlbW92ZSggcmVjb3JkID8ge19pZDoga2V5fSA6IHt9LCB7c2FmZTogdHJ1ZX0sIGZ1bmN0aW9uICggZSwgYXJnICkgewoJCQkJCQkJZGIuY2xvc2UoKTsKCgkJCQkJCQlpZiAoIGUgKSB7CgkJCQkJCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIHsKCQkJCQkJCQlkZWZlci5yZXNvbHZlKCBhcmcgKTsKCQkJCQkJCX0KCQkJCQkJfSApOwoJCQkJCX0KCQkJCQllbHNlIGlmICggb3AgPT09ICJzZXQiICkgewoJCQkJCQlpZiAoIHJlY29yZCApIHsKCQkJCQkJCWNvbGxlY3Rpb24udXBkYXRlKCB7X2lkOiBvYmoua2V5fSwgb2JqLmRhdGEsIHt3OiAxLCBzYWZlOiB0cnVlLCB1cHNlcnQ6IHRydWV9LCBmdW5jdGlvbiAoIGUsIGFyZyApIHsKCQkJCQkJCQlkYi5jbG9zZSgpOwoKCQkJCQkJCQlpZiAoIGUgKSB7CgkJCQkJCQkJCWRlZmVyLnJlamVjdCggZSApOwoJCQkJCQkJCX0KCQkJCQkJCQllbHNlIHsKCQkJCQkJCQkJZGVmZXIucmVzb2x2ZSggYXJnICk7CgkJCQkJCQkJfQoJCQkJCQkJfSApOwoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJLy8gUmVtb3ZpbmcgYWxsIGRvY3VtZW50cyAmIHJlLWluc2VydGluZwoJCQkJCQkJY29sbGVjdGlvbi5yZW1vdmUoIHt9LCB7dzogMSwgc2FmZTogdHJ1ZX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCQkJCQl2YXIgZGVmZXJyZWRzOwoKCQkJCQkJCQlpZiAoIGUgKSB7CgkJCQkJCQkJCWRiLmNsb3NlKCk7CgkJCQkJCQkJCXJldHVybiBkZWZlci5yZWplY3QoIGUgKTsKCgkJCQkJCQkJfQoJCQkJCQkJCWVsc2UgewoJCQkJCQkJCQlkZWZlcnJlZHMgPSBbXTsKCgkJCQkJCQkJCWFycmF5LmVhY2goIHNlbGYucmVjb3JkcywgZnVuY3Rpb24gKCBpICkgewoJCQkJCQkJCQkJdmFyIGRhdGEgICA9IHt9LAoJCQkJCQkJCQkJCWRlZmVyMiA9IGRlZmVycmVkLmZhY3RvcnkoKTsKCgkJCQkJCQkJCQlkZWZlcnJlZHMucHVzaCggZGVmZXIyICk7CgoJCQkJCQkJCQkJdXRpbGl0eS5pdGVyYXRlKCBpLmRhdGEsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCQkJCQkJCQlkYXRhW2tdID0gdjsKCQkJCQkJCQkJCX0gKTsKCgkJCQkJCQkJCQljb2xsZWN0aW9uLnVwZGF0ZSgge19pZDogaS5rZXl9LCBkYXRhLCB7dzoxLCBzYWZlOnRydWUsIHVwc2VydDp0cnVlfSwgZnVuY3Rpb24gKCBlLCBhcmcgKSB7CgkJCQkJCQkJCQkJaWYgKCBlICkgewoJCQkJCQkJCQkJCQlkZWZlcjIucmVqZWN0KCBlICk7CgkJCQkJCQkJCQkJfQoJCQkJCQkJCQkJCWVsc2UgewoJCQkJCQkJCQkJCQlkZWZlcjIucmVzb2x2ZSggYXJnICk7CgkJCQkJCQkJCQkJfQoJCQkJCQkJCQkJfSApOwoJCQkJCQkJCQl9ICk7CgoJCQkJCQkJCQl1dGlsaXR5LndoZW4oIGRlZmVycmVkcyApLnRoZW4oIGZ1bmN0aW9uICggcmVzdWx0ICkgewoJCQkJCQkJCQkJZGIuY2xvc2UoKTsKCQkJCQkJCQkJCWRlZmVyLnJlc29sdmUoIHJlc3VsdCApOwoJCQkJCQkJCQl9LCBmdW5jdGlvbiAoIGUgKSB7CgkJCQkJCQkJCQlkYi5jbG9zZSgpOwoJCQkJCQkJCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJCQkJCQkJCX0gKTsKCQkJCQkJCQl9CgkJCQkJCQl9ICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJZWxzZSB7CgkJCQkJCWRiLmNsb3NlKCk7CgkJCQkJCWRlZmVyLnJlamVjdCggbnVsbCApOwoJCQkJCX0KCQkJCX0gKTsKCQkJfSApOwoJCX0KCQllbHNlIHsKCQkJaWYgKCBvcCA9PT0gImdldCIgKSB7CgkJCQlyZXN1bHQgPSBzZXNzaW9uID8gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgga2V5ICkgOiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgga2V5ICk7CgoJCQkJaWYgKCByZXN1bHQgIT09IG51bGwgKSB7CgkJCQkJcmVzdWx0ID0ganNvbi5kZWNvZGUoIHJlc3VsdCApOwoKCQkJCQlpZiAoIHJlY29yZCApIHsKCQkJCQkJc2VsZi5zZXQoIGtleSwgcmVzdWx0LCB0cnVlICkudGhlbiggZnVuY3Rpb24gKCByZWMgKSB7CgkJCQkJCQlkZWZlci5yZXNvbHZlKCByZWMgKTsKCQkJCQkJfSwgZnVuY3Rpb24gKCBlICkgewoJCQkJCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJCQkJCX0gKTsKCQkJCQl9CgkJCQkJZWxzZSB7CgkJCQkJCXV0aWxpdHkubWVyZ2UoIHNlbGYsIHJlc3VsdCApOwoJCQkJCQlkZWZlci5yZXNvbHZlKCBzZWxmICk7CgkJCQkJfQoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJZGVmZXIucmVzb2x2ZSggc2VsZiApOwoJCQkJfQoKCQkJCS8vIERlY29yYXRpbmcgbG9hZGVkIHN0YXRlIGZvciB2YXJpb3VzIGNvZGUgcGF0aHMKCQkJCWRlZmVyLnRoZW4oIGZ1bmN0aW9uICgpIHsKCQkJCQlzZWxmLmxvYWRlZCA9IHRydWU7CgkJCQl9LCBmdW5jdGlvbiAoIGUgKSB7CgkJCQkJdGhyb3cgZTsKCQkJCX0gKTsKCQkJfQoJCQllbHNlIGlmICggb3AgPT09ICJyZW1vdmUiICkgewoJCQkJc2Vzc2lvbiA/IHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oIGtleSApIDogbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oIGtleSApOwoJCQkJZGVmZXIucmVzb2x2ZSggdGhpcyApOwoJCQl9CgkJCWVsc2UgaWYgKCBvcCA9PT0gInNldCIgKSB7CgkJCQlkYXRhID0ganNvbi5lbmNvZGUoIHJlY29yZCA/IG9iai5kYXRhIDoge3RvdGFsOiB0aGlzLnRvdGFsLCBpbmRleDogdGhpcy5pbmRleCwgaW5kZXhlczogdGhpcy5pbmRleGVzLCByZWNvcmRzOiB0aGlzLnJlY29yZHN9ICk7CgkJCQlzZXNzaW9uID8gc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgga2V5LCBkYXRhICkgOiBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgga2V5LCBkYXRhICk7CgkJCQlkZWZlci5yZXNvbHZlKCB0aGlzICk7CgkJCX0KCQkJZWxzZSB7CgkJCQlkZWZlci5yZWplY3QoIG51bGwgKTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZGVmZXI7Cn07CgovKioKICogU3luY3MgdGhlIERhdGFTdG9yZSB3aXRoIGEgVVJJIHJlcHJlc2VudGF0aW9uCiAqCiAqIEBtZXRob2Qgc3luYwogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFTdG9yZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGVmZXJyZWR9CiAqIEBmaXJlcyBrZWlnYWkuRGF0YVN0b3JlI2JlZm9yZVN5bmMgRmlyZXMgYmVmb3JlIHN5bmNpbmcgdGhlIERhdGFTdG9yZQogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNhZnRlclN5bmMgRmlyZXMgYWZ0ZXIgc3luY2luZyB0aGUgRGF0YVN0b3JlCiAqIEBmaXJlcyBrZWlnYWkuRGF0YVN0b3JlI2ZhaWxlZFN5bmMgRmlyZXMgd2hlbiBhbiBleGNlcHRpb24gb2NjdXJzCiAqIEBleGFtcGxlCiAqIHN0b3JlLnN5bmMoKS50aGVuKCBmdW5jdGlvbiAoIHJlY29yZHMgKSB7CiAqICAgLi4uCiAqIH0sIGZ1bmN0aW9uICggZXJyICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnN5bmMgPSBmdW5jdGlvbiAoKSB7Cgl2YXIgc2VsZiAgID0gdGhpcywKCSAgICBldmVudHMgPSAoIHRoaXMuZXZlbnRzID09PSB0cnVlICksCgkgICAgZGVmZXIgID0gZGVmZXJyZWQuZmFjdG9yeSgpLAoJICAgIHN1Y2Nlc3MsIGZhaWx1cmU7CgoJLyoqCgkgKiBSZXNvbHZlcyBwdWJsaWMgZGVmZXJyZWQKCSAqCgkgKiBAbWV0aG9kIHN1Y2Nlc3MKCSAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlLnN5bmMKCSAqIEBwcml2YXRlCgkgKiBAcGFyYW0gIHtPYmplY3R9IGFyZyBBUEkgcmVzcG9uc2UKCSAqIEByZXR1cm4ge1VuZGVmaW5lZH0gIHVuZGVmaW5lZAoJICovCglzdWNjZXNzID0gZnVuY3Rpb24gKCBhcmcgKSB7CgkJdmFyIGRhdGE7CgoJCWlmICggdHlwZW9mIGFyZyAhPSAib2JqZWN0IiApIHsKCQkJcmV0dXJuIGZhaWx1cmUoIG5ldyBFcnJvciggbGFiZWwuZXhwZWN0ZWRPYmplY3QgKSApOwoJCX0KCgkJaWYgKCBzZWxmLnNvdXJjZSAhPT0gbnVsbCApIHsKCQkJYXJnID0gdXRpbGl0eS53YWxrKCBhcmcsIHNlbGYuc291cmNlICk7CgkJfQoKCQlpZiAoIGFyZyBpbnN0YW5jZW9mIEFycmF5ICkgewoJCQlkYXRhID0gYXJnOwoJCX0KCQllbHNlIHsKCQkJZGF0YSA9IFthcmddOwoJCX0KCgkJc2VsZi5iYXRjaCggInNldCIsIGRhdGEsIHRydWUgKS50aGVuKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJaWYgKCBldmVudHMgKSB7CgkJCQlzZWxmLmRpc3BhdGNoKCAiYWZ0ZXJTeW5jIiwgYXJnICk7CgkJCX0KCgkJCWRlZmVyLnJlc29sdmUoIGFyZyApOwoJCX0sIGZhaWx1cmUgKTsKCX07CgoJLyoqCgkgKiBSZWplY3RzIHB1YmxpYyBkZWZlcnJlZAoJICoKCSAqIEBtZXRob2QgZmFpbHVyZQoJICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUuc3luYwoJICogQHByaXZhdGUKCSAqIEBwYXJhbSAge09iamVjdH0gZSBFcnJvciBpbnN0YW5jZQoJICogQHJldHVybiB7VW5kZWZpbmVkfSB1bmRlZmluZWQKCSAqLwoJZmFpbHVyZSA9IGZ1bmN0aW9uICggZSApIHsKCQlpZiAoIGV2ZW50cyApIHsKCQkJc2VsZi5kaXNwYXRjaCggImZhaWxlZFN5bmMiLCBlICk7CgkJfQoKCQlkZWZlci5yZWplY3QoIGUgKTsKCX07CgoJaWYgKCB0aGlzLnVyaSA9PT0gbnVsbCB8fCBzdHJpbmcuaXNFbXB0eSggdGhpcy51cmkgKSApIHsKCQlkZWZlci5yZWplY3QoIG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApICk7Cgl9CgllbHNlIHsKCQlpZiAoIGV2ZW50cyApIHsKCQkJdGhpcy5kaXNwYXRjaCggImJlZm9yZVN5bmMiLCB0aGlzLnVyaSApOwoJCX0KCgkJaWYgKCB0aGlzLmNhbGxiYWNrICE9PSBudWxsICkgewoJCQljbGllbnQuanNvbnAoIHRoaXMudXJpLCB7Y2FsbGJhY2s6IHRoaXMuY2FsbGJhY2t9ICkudGhlbiggc3VjY2VzcywgZmFpbHVyZSApOwoJCX0KCQllbHNlIHsKCQkJY2xpZW50LnJlcXVlc3QoIHRoaXMudXJpLCAiR0VUIiwgbnVsbCwgdXRpbGl0eS5tZXJnZSgge3dpdGhDcmVkZW50aWFsczogdGhpcy5jcmVkZW50aWFsc30sIHRoaXMuaGVhZGVycyApICkudGhlbiggc3VjY2VzcywgZmFpbHVyZSApOwoJCX0KCX0KCglyZXR1cm4gZGVmZXI7Cn07CgovKioKICogVGVhcnMgZG93biBhIHN0b3JlICYgZXhwaXJlcyBhbGwgcmVjb3JkcyBhc3NvY2lhdGVkIHRvIGFuIEFQSQogKgogKiBAbWV0aG9kIHRlYXJkb3duCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhU3RvcmV9CiAqIEBleGFtcGxlCiAqIHN0b3JlLnRlYXJkb3duKCk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnRlYXJkb3duID0gZnVuY3Rpb24gKCkgewoJdmFyIHVyaSA9IHRoaXMudXJpLAoJICAgIGlkOwoKCWlmICggdXJpICE9PSBudWxsICkgewoJCWNhY2hlLmV4cGlyZSggdXJpLCB0cnVlICk7CgoJCWlkID0gdGhpcy5pZCArICJEYXRhRXhwaXJlIjsKCQl1dGlsaXR5LmNsZWFyVGltZXJzKCBpZCApOwoKCQlhcnJheS5lYWNoKCB0aGlzLnJlY29yZHMsIGZ1bmN0aW9uICggaSApIHsKCQkJdmFyIHJlY29yZFVyaSA9IHVyaSArICIvIiArIGkua2V5OwoKCQkJY2FjaGUuZXhwaXJlKCByZWNvcmRVcmksIHRydWUgKTsKCQl9ICk7Cgl9CgoJYXJyYXkuZWFjaCggdGhpcy5saXN0cywgZnVuY3Rpb24gKCBpICkgewoJCWkudGVhcmRvd24oIHRydWUgKTsKCX0gKTsKCgl0aGlzLmNsZWFyKCB0cnVlICk7Cgl0aGlzLmRpc3BhdGNoKCAiYWZ0ZXJUZWFyZG93biIgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBVbmRvZXMgdGhlIGxhc3QgbW9kaWZpY2F0aW9uIHRvIGEgcmVjb3JkLCBpZiBpdCBleGlzdHMKICoKICogQG1ldGhvZCB1bmRvCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge01peGVkfSAga2V5ICAgICBLZXkgb3IgaW5kZXgKICogQHBhcmFtICB7U3RyaW5nfSB2ZXJzaW9uIFtPcHRpb25hbF0gVmVyc2lvbiB0byByZXN0b3JlCiAqIEByZXR1cm4ge09iamVjdH0gICAgICAgICBEZWZlcnJlZAogKiBAZXhhbXBsZQogKiAvLyBEaWRuJ3QgbGlrZSB0aGUgbmV3IHZlcnNpb24sIHNvIHVuZG8gdGhlIGNoYW5nZQogKiBzdG9yZS51bmRvKCAia2V5IiwgInYxIiApOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS51bmRvID0gZnVuY3Rpb24gKCBrZXksIHZlcnNpb24gKSB7Cgl2YXIgcmVjb3JkICAgPSB0aGlzLmdldCgga2V5ICksCgkgICAgZGVmZXIgICAgPSBkZWZlcnJlZC5mYWN0b3J5KCksCgkgICAgdmVyc2lvbnMgPSB0aGlzLnZlcnNpb25zW3JlY29yZC5rZXldLAoJICAgIHByZXZpb3VzOwoKCWlmICggcmVjb3JkID09PSB1bmRlZmluZWQgKSB7CgkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKSApOwoJfQoJZWxzZSB7CgkJaWYgKCB2ZXJzaW9ucyApIHsKCQkJcHJldmlvdXMgPSB2ZXJzaW9ucy5nZXQoIHZlcnNpb24gfHwgdmVyc2lvbnMuZmlyc3QgKTsKCgkJCWlmICggcHJldmlvdXMgPT09IHVuZGVmaW5lZCApIHsKCQkJCWRlZmVyLnJlamVjdCggbGFiZWwuZGF0YXN0b3JlTm9QcmV2VmVyc2lvbiApOwoJCQl9CgkJCWVsc2UgewoJCQkJdGhpcy5zZXQoIGtleSwgcHJldmlvdXMgKS50aGVuKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCQlkZWZlci5yZXNvbHZlKCBhcmcgKTsKCQkJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCQlkZWZlci5yZWplY3QoIGUgKTsKCQkJCX0gKTsKCQkJfQoJCX0KCQllbHNlIHsKCQkJZGVmZXIucmVqZWN0KCBsYWJlbC5kYXRhc3RvcmVOb1ByZXZWZXJzaW9uICk7CgkJfQoJfQoKCXJldHVybiBkZWZlcjsKfTsKCi8qKgogKiBSZXR1cm5zIEFycmF5IG9mIHVuaXF1ZSB2YWx1ZXMgb2YgYGtleWAKICoKICogQG1ldGhvZCB1bmlxdWUKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7U3RyaW5nfSBrZXkgRmllbGQgdG8gY29tcGFyZQogKiBAcmV0dXJuIHtBcnJheX0gICAgICBBcnJheSBvZiB2YWx1ZXMKICogQGV4YW1wbGUKICogdmFyIGFnZXMgPSBzdG9yZS51bmlxdWUoICJhZ2UiICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnVuaXF1ZSA9IGZ1bmN0aW9uICgga2V5ICkgewoJcmV0dXJuIGFycmF5LnVuaXF1ZSggdGhpcy5yZWNvcmRzLm1hcCggZnVuY3Rpb24gKCBpICkgewoJCXJldHVybiBpLmRhdGFba2V5XTsKCX0gKSApOwp9OwoKLyoqCiAqIEFwcGxpZXMgYSBkaWZmZXJlbmNlIHRvIGEgcmVjb3JkCiAqCiAqIFVzZSBgZGF0YS5zZXQoKWAgaWYgYGRhdGFgIGlzIHRoZSBjb21wbGV0ZSBmaWVsZCBzZXQKICoKICogQG1ldGhvZCB1cGRhdGUKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7TWl4ZWR9ICBrZXkgIEtleSBvciBpbmRleAogKiBAcGFyYW0gIHtPYmplY3R9IGRhdGEgS2V5OlZhbHVlIHBhaXJzIHRvIHNldCBhcyBmaWVsZCB2YWx1ZXMKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZXhhbXBsZQogKiBzdG9yZS51cGRhdGUoICJrZXkiLCB7YWdlOiAzNH0gKTsKICovCkRhdGFTdG9yZS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKCBrZXksIGRhdGEgKSB7Cgl2YXIgcmVjb3JkID0gdGhpcy5nZXQoIGtleSApLAoJICAgIGRlZmVyICA9IGRlZmVycmVkLmZhY3RvcnkoKTsKCglpZiAoIHJlY29yZCA9PT0gdW5kZWZpbmVkICkgewoJCWRlZmVyLnJlamVjdCggbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICkgKTsKCX0KCWVsc2UgewoJCXRoaXMuc2V0KCBrZXksIHV0aWxpdHkubWVyZ2UoIHJlY29yZC5kYXRhLCBkYXRhICkgKS50aGVuKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJZGVmZXIucmVzb2x2ZSggYXJnICk7CgkJfSwgZnVuY3Rpb24gKCBlICkgewoJCQlkZWZlci5yZWplY3QoIGUgKTsKCQl9ICk7Cgl9CgoJcmV0dXJuIGRlZmVyOwp9OwoKLyoqCiAqIEBuYW1lc3BhY2Ugc3RyaW5nCiAqLwp2YXIgc3RyaW5nID0gewoJLyoqCgkgKiBDYXBpdGFsaXplcyB0aGUgU3RyaW5nCgkgKgoJICogQG1ldGhvZCBjYXBpdGFsaXplCgkgKiBAbWVtYmVyT2Ygc3RyaW5nCgkgKiBAcGFyYW0gIHtTdHJpbmd9ICBvYmogU3RyaW5nIHRvIGNhcGl0YWxpemUKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGFsbCBbT3B0aW9uYWxdIENhcGl0YWxpemUgZWFjaCB3b3JkCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgQ2FwaXRhbGl6ZWQgU3RyaW5nCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuc3RyaW5nLmNhcGl0YWxpemUoICJoZWxsbyIgKTsgLy8gIkhlbGxvIgoJICovCgljYXBpdGFsaXplIDogZnVuY3Rpb24gKCBvYmosIGFsbCApIHsKCQlhbGwgPSAoIGFsbCA9PT0gdHJ1ZSApOwoKCQl2YXIgcmVzdWx0OwoKCQlpZiAoIGFsbCApIHsKCQkJcmVzdWx0ID0gc3RyaW5nLmV4cGxvZGUoIG9iaiwgIiAiICkubWFwKCBmdW5jdGlvbiAoIGkgKSB7CgkJCQlyZXR1cm4gaS5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgaS5zbGljZSggMSApOwoJCQl9ICkuam9pbigiICIpOwoJCX0KCQllbHNlIHsKCQkJcmVzdWx0ID0gb2JqLmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBvYmouc2xpY2UoIDEgKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogRXNjYXBlcyBtZXRhIGNoYXJhY3RlcnMgd2l0aGluIGEgc3RyaW5nCgkgKgoJICogQG1ldGhvZCBlc2NhcGUKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gb2JqIFN0cmluZyB0byBlc2NhcGUKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgIEVzY2FwZWQgc3RyaW5nCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuc3RyaW5nLmVzY2FwZSggIntoZWxsb30iICk7IC8vICJce2hlbGxvXH0iCgkgKi8KCWVzY2FwZSA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBvYmoucmVwbGFjZSggL1tcLVxbXF17fSgpKis/LixcXFwvXF5cJHwjXHNdL2csICJcXCQmIiApOwoJfSwKCgkvKioKCSAqIFNwbGl0cyBhIHN0cmluZyBvbiBjb21tYSwgb3IgYSBwYXJhbWV0ZXIsIGFuZCB0cmltcyBlYWNoIHZhbHVlIGluIHRoZSByZXN1bHRpbmcgQXJyYXkKCSAqCgkgKiBAbWV0aG9kIGV4cGxvZGUKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gb2JqIFN0cmluZyB0byBjYXBpdGFsaXplCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBTdHJpbmcgdG8gc3BsaXQgb24KCSAqIEByZXR1cm4ge0FycmF5fSAgICAgIEFycmF5IG9mIHRoZSBleHBsb2RlZCBTdHJpbmcKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5lYWNoKCBrZWlnYWkudXRpbC5zdHJpbmcuZXhwbG9kZSggImFiYywgZGVmIiApLCBmdW5jdGlvbiAoIGkgKSB7CgkgKiAgIC4uLgoJICogfSApOwoJICovCglleHBsb2RlIDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQlhcmcgPSBhcmcgfHwgIiwiOwoKCQlyZXR1cm4gc3RyaW5nLnRyaW0oIG9iaiApLnNwbGl0KCBuZXcgUmVnRXhwKCAiXFxzKiIgKyBhcmcgKyAiXFxzKiIgKSApOwoJfSwKCgkvKioKCSAqIENyZWF0ZXMgYSBTdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgYW4gT2JqZWN0LCBwcmVzZXJ2aW5nIEZ1bmN0aW9ucwoJICoKCSAqIE5lc3RlZCBPYmplY3RzIGFyZSBub3Qgc3VwcG9ydGVkCgkgKgoJICogQG1ldGhvZCBmcm9tT2JqZWN0CgkgKiBAbWVtYmVyT2Ygc3RyaW5nCgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiAgT2JqZWN0IHRvIGNvbnZlcnQKCSAqIEBwYXJhbSAge1N0cmluZ30gbmFtZSBbT3B0aW9uYWxdIE5hbWUgb2YgT2JqZWN0CgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgU3RyaW5nIHJlcHJlc2VudGF0aW9uCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuc3RyaW5nLmZyb21PYmplY3QoIHthOiB0cnVlLCBiOiBmYWxzZX0sICJzdGF0cyIgKTsgLy8gInN0YXRzID0geydhJzogdHJ1ZSwnYic6ZmFsc2V9IgoJICovCglmcm9tT2JqZWN0IDogZnVuY3Rpb24gKCBvYmosIG5hbWUgKSB7CgkJdmFyIHJlc3VsdCA9ICggbmFtZSA/IG5hbWUgKyAiID0geyIgOiAieyIgKSArICJcbiI7CgoJCXV0aWxpdHkuaXRlcmF0ZSggb2JqLCBmdW5jdGlvbiAoIHYsIGsgKSB7CgkJCXJlc3VsdCArPSAiXCIiICsgayArICJcIjoiICsgdi50b1N0cmluZygpICsgIixcbiI7CgkJfSApOwoKCQlyZXN1bHQgPSByZXN1bHQucmVwbGFjZSggL1xbb2JqZWN0IE9iamVjdFxdL2csICJ7fSIgKS5yZXBsYWNlKCAvLFxuJC8sICJcbiIgKSArICJ9IjsKCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBSZXBsYWNlcyBhbGwgc3BhY2VzIGluIGEgc3RyaW5nIHdpdGggZGFzaGVzCgkgKgoJICogQG1ldGhvZCBoeXBoZW5hdGUKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gb2JqICAgU3RyaW5nIHRvIGh5cGhlbmF0ZQoJICogQHBhcmFtIHtCb29sZWFufSBjYW1lbCBbT3B0aW9uYWxdIEh5cGhlbmF0ZSBjYW1lbENhc2UKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgICAgU3RyaW5nIHdpdGggZGFzaGVzIGluc3RlYWQgb2Ygc3BhY2VzCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuc3RyaW5nLmh5cGhlbmF0ZSggImhlbGxvIHdvcmxkIiApOyAvLyAiaGVsbG8td29ybGQiCgkgKi8KCWh5cGhlbmF0ZSA6IGZ1bmN0aW9uICggb2JqLCBjYW1lbCApIHsKCQl2YXIgcmVzdWx0ID0gc3RyaW5nLnRyaW0oIG9iaiApLnJlcGxhY2UoIC9ccysvZywgIi0iICk7CgoJCWlmICggY2FtZWwgPT09IHRydWUgKSB7CgkJCXJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKCAvKFtBLVpdKS9nLCAiLSQxIiApLnRvTG93ZXJDYXNlKCk7CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIFRlc3RzIGlmIGEgc3RyaW5nIGlzIGEgYm9vbGVhbgoJICoKCSAqIEBtZXRob2QgaXNCb29sZWFuCgkgKiBAbWVtYmVyT2Ygc3RyaW5nCgkgKiBAcGFyYW0gIHtTdHJpbmd9ICBvYmogU3RyaW5nIHRvIHRlc3QKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgICBSZXN1bHQgb2YgdGVzdAoJICogQGV4YW1wbGUKCSAqIGlmICgga2VpZ2FpLnV0aWwuc3RyaW5nLmlzQm9vbGVhbiggLi4uICkgewoJICogICAuLi4KCSAqIH0gKTsKCSAqLwoJaXNCb29sZWFuIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIHJlZ2V4LmJvb2wudGVzdCggb2JqICk7Cgl9LAoKCS8qKgoJICogVGVzdHMgaWYgYSBzdHJpbmcgaXMgZW1wdHkKCSAqCgkgKiBAbWV0aG9kIGlzRW1wdHkKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gIG9iaiBTdHJpbmcgdG8gdGVzdAoJICogQHJldHVybiB7Qm9vbGVhbn0gICAgIFJlc3VsdCBvZiB0ZXN0CgkgKiBAZXhhbXBsZQoJICogaWYgKCAha2VpZ2FpLnV0aWwuc3RyaW5nLmlzRW1wdHkoIC4uLiApIHsKCSAqICAgLi4uCgkgKiB9ICk7CgkgKi8KCWlzRW1wdHkgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gc3RyaW5nLnRyaW0oIG9iaiApID09PSAiIjsKCX0sCgoJLyoqCgkgKiBUZXN0cyBpZiBhIHN0cmluZyBpcyBhIG51bWJlcgoJICoKCSAqIEBtZXRob2QgaXNOdW1iZXIKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gIG9iaiBTdHJpbmcgdG8gdGVzdAoJICogQHJldHVybiB7Qm9vbGVhbn0gICAgIFJlc3VsdCBvZiB0ZXN0CgkgKiBAZXhhbXBsZQoJICogaWYgKCBrZWlnYWkudXRpbC5zdHJpbmcuaXNOdW1iZXIoIC4uLiApIHsKCSAqICAgLi4uCgkgKiB9ICk7CgkgKi8KCWlzTnVtYmVyIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIHJlZ2V4Lm51bWJlci50ZXN0KCBvYmogKTsKCX0sCgoJLyoqCgkgKiBUZXN0cyBpZiBhIHN0cmluZyBpcyBhIFVSTAoJICoKCSAqIEBtZXRob2QgaXNVcmwKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gIG9iaiBTdHJpbmcgdG8gdGVzdAoJICogQHJldHVybiB7Qm9vbGVhbn0gICAgIFJlc3VsdCBvZiB0ZXN0CgkgKiBAZXhhbXBsZQoJICogaWYgKCBrZWlnYWkudXRpbC5zdHJpbmcuaXNVcmwoIC4uLiApIHsKCSAqICAgLi4uCgkgKiB9ICk7CgkgKi8KCWlzVXJsIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIHJlZ2V4LnVybC50ZXN0KCBvYmogKTsKCX0sCgoJLyoqCgkgKiBUcmFuc2Zvcm1zIHRoZSBjYXNlIG9mIGEgU3RyaW5nIGludG8gQ2FtZWxDYXNlCgkgKgoJICogQG1ldGhvZCB0b0NhbWVsQ2FzZQoJICogQG1lbWJlck9mIHN0cmluZwoJICogQHBhcmFtICB7U3RyaW5nfSBvYmogU3RyaW5nIHRvIGNhcGl0YWxpemUKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgIENhbWVsIGNhc2UgU3RyaW5nCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuc3RyaW5nLnRvQ2FtZWxDYXNlKCAiaGVsbG8gd29ybGQiICk7IC8vICJoZWxsb1dvcmxkIgoJICovCgl0b0NhbWVsQ2FzZSA6IGZ1bmN0aW9uICggb2JqICkgewoJCXZhciBzID0gc3RyaW5nLnRyaW0oIG9iaiApLnJlcGxhY2UoIC9cLnxffC18XEB8XFt8XF18XCh8XCl8XCN8XCR8XCV8XF58XCZ8XCp8XHMrL2csICIgIiApLnRvTG93ZXJDYXNlKCkuc3BsaXQoIHJlZ2V4LnNwYWNlX2h5cGhlbiApLAoJCSAgICByID0gW107CgoJCWFycmF5LmVhY2goIHMsIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCQlyLnB1c2goIGlkeCA9PT0gMCA/IGkgOiBzdHJpbmcuY2FwaXRhbGl6ZSggaSApICk7CgkJfSk7CgoJCXJldHVybiByLmpvaW4oICIiICk7Cgl9LAoKCS8qKgoJICogUmV0dXJucyBzaW5ndWxhciBmb3JtIG9mIHRoZSBzdHJpbmcKCSAqCgkgKiBAbWV0aG9kIHNpbmd1bGFyCgkgKiBAbWVtYmVyT2Ygc3RyaW5nCgkgKiBAcGFyYW0gIHtTdHJpbmd9IG9iaiBTdHJpbmcgdG8gdHJhbnNmb3JtCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICBUcmFuc2Zvcm1lZCBzdHJpbmcKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5zdHJpbmcuc2luZ3VsYXIoICJjYW5zIiApOyAvLyAiY2FuIgoJICovCglzaW5ndWxhciA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBvYmoucmVwbGFjZSggL29lP3MkLywgIm8iICkucmVwbGFjZSggL2llcyQvLCAieSIgKS5yZXBsYWNlKCAvc2VzJC8sICJzZSIgKS5yZXBsYWNlKCAvcyQvLCAiIiApOwoJfSwKCgkvKioKCSAqIENhc3RzIGEgU3RyaW5nIHRvIGEgRnVuY3Rpb24KCSAqCgkgKiBAbWV0aG9kIHRvRnVuY3Rpb24KCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gb2JqIFN0cmluZyB0byBjYXN0CgkgKiBAcmV0dXJuIHtGdW5jdGlvbn0gICBGdW5jdGlvbgoJICogQGV4YW1wbGUKCSAqIHZhciBmbiA9IHNvbWVGdW5jdGlvbi50b1N0cmluZygpOwoJICoKCSAqIC4uLgoJICoKCSAqIHZhciBmdW5jID0ga2VpZ2FpLnV0aWwuc3RyaW5nLnRvRnVuY3Rpb24oIGZuICk7CgkgKi8KCXRvRnVuY3Rpb24gOiBmdW5jdGlvbiAoIG9iaiApIHsKCQl2YXIgYXJncyA9IHN0cmluZy50cmltKCBvYmoucmVwbGFjZSggL14uKlwoLywgIiIgKS5yZXBsYWNlKCAvW1x0fFxyfFxufFwifFwnXSsvZywgIiIgKS5yZXBsYWNlKCAvXCkuKi8sICIiICkgKSwKCQkgICAgYm9keSA9IHN0cmluZy50cmltKCBvYmoucmVwbGFjZSggL14uKlx7LywgIiIgKS5yZXBsYWNlKCAvXH0kLywgIiIgKSApOwoKCQlyZXR1cm4gRnVuY3Rpb24uYXBwbHkoIEZ1bmN0aW9uLCBzdHJpbmcuZXhwbG9kZSggYXJncyApLmNvbmNhdCggW2JvZHldICkgKTsKCX0sCgoJLyoqCgkgKiBUcmltcyB0aGUgd2hpdGVzcGFjZSBhcm91bmQgYSBTdHJpbmcKCSAqCgkgKiBAbWV0aG9kIHRyaW0KCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gb2JqIFN0cmluZyB0byBjYXBpdGFsaXplCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICBUcmltbWVkIFN0cmluZwoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLnN0cmluZy50cmltKCAiICBoZWxsbyB3b3JsZCAiICk7IC8vICJoZWxsbyB3b3JsZCIKCSAqLwoJdHJpbSA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBvYmoucmVwbGFjZSggL14oXHMrfFx0K3xcbispfChccyt8XHQrfFxuKykkL2csICIiICk7Cgl9LAoKCS8qKgoJICogVW5jYW1lbGNhc2VzIHRoZSBTdHJpbmcKCSAqCgkgKiBAbWV0aG9kIHVuQ2FtZWxDYXNlCgkgKiBAbWVtYmVyT2Ygc3RyaW5nCgkgKiBAcGFyYW0gIHtTdHJpbmd9IG9iaiBTdHJpbmcgdG8gdW5jYW1lbGNhc2UKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgIFVuY2FtZWxjYXNlZCBTdHJpbmcKCSAqLwoJdW5DYW1lbENhc2UgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gc3RyaW5nLnRyaW0oIG9iai5yZXBsYWNlKCAvKFtBLVpdKS9nLCAiICQxIiApLnRvTG93ZXJDYXNlKCkgKTsKCX0sCgoJLyoqCgkgKiBVbmNhcGl0YWxpemVzIHRoZSBTdHJpbmcKCSAqCgkgKiBAbWV0aG9kIHVuY2FwaXRhbGl6ZQoJICogQG1lbWJlck9mIHN0cmluZwoJICogQHBhcmFtICB7U3RyaW5nfSBvYmogU3RyaW5nIHRvIHVuY2FwaXRhbGl6ZQoJICogQHJldHVybiB7U3RyaW5nfSAgICAgVW5jYXBpdGFsaXplZCBTdHJpbmcKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5zdHJpbmcudW5jYXBpdGFsaXplKCAiSGVsbG8iICk7IC8vICJoZWxsbyIKCSAqLwoJdW5jYXBpdGFsaXplIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJb2JqID0gc3RyaW5nLnRyaW0oIG9iaiApOwoKCQlyZXR1cm4gb2JqLmNoYXJBdCggMCApLnRvTG93ZXJDYXNlKCkgKyBvYmouc2xpY2UoIDEgKTsKCX0sCgoJLyoqCgkgKiBSZXBsYWNlcyBhbGwgaHlwaGVucyB3aXRoIHNwYWNlcwoJICoKCSAqIEBtZXRob2QgdW5oeXBoZW5hdGUKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gIG9iaiAgU3RyaW5nIHRvIHVuaHlwZW5hdGUKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGNhcHMgW09wdGlvbmFsXSBUcnVlIHRvIGNhcGl0YWxpemUgZWFjaCB3b3JkCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgIFVuaHlwaGVuYXRlZCBTdHJpbmcKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5zdHJpbmcudW5oeXBoZW5hdGUoICJoZWxsby13b3JsZCIgKTsgICAgICAgLy8gImhlbGxvIHdvcmxkIgoJICoga2VpZ2FpLnV0aWwuc3RyaW5nLnVuaHlwaGVuYXRlKCAiaGVsbG8td29ybGQiLCB0cnVlICk7IC8vICJIZWxsbyBXb3JsZCIKCSAqLwoJdW5oeXBoZW5hdGUgOiBmdW5jdGlvbiAoIG9iaiwgY2FwcyApIHsKCQlpZiAoIGNhcHMgIT09IHRydWUgKSB7CgkJCXJldHVybiBzdHJpbmcuZXhwbG9kZSggb2JqLCAiLSIgKS5qb2luKCAiICIgKTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiBzdHJpbmcuZXhwbG9kZSggb2JqLCAiLSIgKS5tYXAoIGZ1bmN0aW9uICggaSApIHsKCQkJCXJldHVybiBzdHJpbmcuY2FwaXRhbGl6ZSggaSApOwoJCQl9ICkuam9pbiggIiAiICk7CgkJfQoJfQp9OwoKLyoqCiAqIEBuYW1lc3BhY2UgdXRpbGl0eQogKi8KdmFyIHV0aWxpdHkgPSB7CgkvKioKCSAqIENvbGxlY3Rpb24gb2YgdGltZXJzCgkgKgoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEB0eXBlIHtPYmplY3R9CgkgKiBAcHJpdmF0ZQoJICovCgl0aW1lciA6IHt9LAoKCS8qKgoJICogQ29sbGVjdGlvbiBvZiByZXBlYXRpbmcgZnVuY3Rpb25zCgkgKgoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEB0eXBlIHtPYmplY3R9CgkgKiBAcHJpdmF0ZQoJICovCglyZXBlYXRpbmc6IHt9LAoKCS8qKgoJICogQ3JlYXRlcyBFbGVtZW50cyBvciBRdWVyaWVzIHRoZSBET00gdXNpbmcgQ1NTIHNlbGVjdG9ycwoJICoKCSAqIEBtZXRob2QgJAoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge01peGVkfSBhcmcgSFRNTCwgb3IgQ29tbWEgZGVsaW1pdGVkIHN0cmluZyBvZiBDU1Mgc2VsZWN0b3JzCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgIEFycmF5IG9mIG1hdGNoaW5nIEVsZW1lbnRzCgkgKiBAZXhhbXBsZQoJICogdmFyICQgPSBrZWlnYWkudXRpbC4kOwoJICoKCSAqIC8vIExvb2tpbmcgZm9yIEVsZW1lbnRzCgkgKiAkKCAiLnNvbWVDbGFzcyIgKS5mb3JFYWNoKCBmdW5jdGlvbiAoIGkgKSB7CgkgKiAgIC4uLgoJICogfSApOwoJICoKCSAqIC8vIENyZWF0aW5nIGFuIEgxIEVsZW1lbnQKCSAqICQoICImbHQ7aDEmZ3Q7IiApLmZvckVhY2goIGZ1bmN0aW9uICggaSApIHsKCSAqICAgLi4uCgkgKiB9ICk7CgkgKi8KCSQgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQl2YXIgcmVzdWx0OwoKCQkvLyBOb3RoaW5nCgkJaWYgKCAhYXJnICkgewoJCX0KCQkvLyBIVE1MCgkJZWxzZSBpZiAoIHJlZ2V4Lmh0bWwudGVzdCggYXJnICkgKSB7CgkJCXJlc3VsdCA9IFtlbGVtZW50LmNyZWF0ZSggYXJnICldOwoJCX0KCQkvLyBDU1Mgc2VsZWN0b3IocykKCQllbHNlIHsKCQkJYXJnID0gc3RyaW5nLnRyaW0oIGFyZyApOwoKCQkJaWYgKCBhcmcuaW5kZXhPZiggIiwiICkgPT09IC0xICkgewoJCQkJcmVzdWx0ID0gdXRpbGl0eS5kb20oIGFyZyApOwoKCQkJCWlmICggcmVzdWx0ICkgewoJCQkJCWlmICggaXNOYU4oIHJlc3VsdC5sZW5ndGggKSApIHsKCQkJCQkJcmVzdWx0ID0gW3Jlc3VsdF07CgkJCQkJfQoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJcmVzdWx0ID0gW107CgkJCQl9CgkJCX0KCQkJZWxzZSB7CgkJCQlyZXN1bHQgPSBbXTsKCgkJCQlhcnJheS5lYWNoKCBzdHJpbmcuZXhwbG9kZSggYXJnICksIGZ1bmN0aW9uICggcXVlcnkgKSB7CgkJCQkJdmFyIG9iaiA9IHV0aWxpdHkuZG9tKCBxdWVyeSApOwoKCQkJCQlpZiAoIG9iaiBpbnN0YW5jZW9mIEFycmF5ICkgewoJCQkJCQlyZXN1bHQgPSByZXN1bHQuY29uY2F0KCBvYmogKTsKCQkJCQl9CgkJCQkJZWxzZSBpZiAoIG9iaiApIHsKCQkJCQkJcmVzdWx0LnB1c2goIG9iaiApOwoJCQkJCX0KCQkJCX0gKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGFuIGluc3RhbmNlIG9mIEJhc2UKCSAqCgkgKiBAbWV0aG9kIGJhc2UKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtPYmplY3R9IGFyZyBbT3B0aW9uYWxdIERlY29yYXRpdmUgT2JqZWN0CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBJbnN0YW5jZSBvZiBCYXNlCgkgKi8KCWJhc2UgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQl2YXIgb2JqID0gbmV3IEJhc2UoKTsKCgkJaWYgKCBhcmcgaW5zdGFuY2VvZiBPYmplY3QgKSB7CgkJCXV0aWxpdHkubWVyZ2UoIG9iaiwgYXJnICk7CgkJfQoKCQlvYmoub2JzZXJ2ZXIgPSBvYnNlcnZhYmxlLmZhY3RvcnkoKTsKCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBCbG9iIGZhY3RvcnkKCSAqCgkgKiBAbWV0aG9kIGJsb2IKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBTdHJpbmcgdG8gY29udmVydCB0byBhIEJsb2IKCSAqIEByZXR1cm4ge09iamVjdH0gICAgIEJsb2IKCSAqIEBwcml2YXRlCgkgKi8KCWJsb2IgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQl2YXIgb2JqOwoKCQl0cnkgewoJCQlvYmogPSBuZXcgQmxvYiggW2FyZ10sIHt0eXBlOiAiYXBwbGljYXRpb24vamF2YXNjcmlwdCJ9ICk7CgkJfQoJCWNhdGNoICggZSApIHsKCQkJaWYgKCAhZ2xvYmFsLkJsb2JCdWlsZGVyICkgewoJCQkJZ2xvYmFsLkJsb2JCdWlsZGVyID0gZ2xvYmFsLk1TQmxvYkJ1aWxkZXIgfHwgZ2xvYmFsLldlYktpdEJsb2JCdWlsZGVyIHx8IGdsb2JhbC5Nb3pCbG9iQnVpbGRlcjsKCQkJfQoKCQkJb2JqID0gbmV3IGdsb2JhbC5CbG9iQnVpbGRlcigpLmFwcGVuZCggYXJnICkuZ2V0QmxvYigpOwoJCX0KCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBDbGVhcnMgZGVmZXJyZWQgJiByZXBlYXRpbmcgZnVuY3Rpb25zCgkgKgoJICogQG1ldGhvZCBjbGVhclRpbWVycwoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge1N0cmluZ30gaWQgSUQgb2YgdGltZXIoIHMgKQoJICogQHJldHVybiB7VW5kZWZpbmVkfSB1bmRlZmluZWQKCSAqIEBwcml2YXRlCgkgKi8KCWNsZWFyVGltZXJzIDogZnVuY3Rpb24gKCBpZCApIHsKCQlpZiAoIGlkID09PSB1bmRlZmluZWQgfHwgc3RyaW5nLmlzRW1wdHkoIGlkICkgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApOwoJCX0KCgkJLy8gZGVmZXJyZWQKCQlpZiAoIHV0aWxpdHkudGltZXJbaWRdICkgewoJCQljbGVhclRpbWVvdXQoIHV0aWxpdHkudGltZXJbaWRdICk7CgkJCWRlbGV0ZSB1dGlsaXR5LnRpbWVyW2lkXTsKCQl9CgoJCS8vIHJlcGVhdGluZwoJCWlmICggdXRpbGl0eS5yZXBlYXRpbmdbaWRdICkgewoJCQljbGVhclRpbWVvdXQoIHV0aWxpdHkucmVwZWF0aW5nW2lkXSApOwoJCQlkZWxldGUgdXRpbGl0eS5yZXBlYXRpbmdbaWRdOwoJCX0KCX0sCgoJLyoqCgkgKiBDbG9uZXMgYW4gT2JqZWN0CgkgKgoJICogQG1ldGhvZCBjbG9uZQoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge09iamVjdH0gIG9iaiAgICAgT2JqZWN0IHRvIGNsb25lCgkgKiBAcGFyYW0gIHtCb29sZWFufSBzaGFsbG93IFtPcHRpb25hbF0gQ3JlYXRlIGEgc2hhbGxvdyBjbG9uZSwgd2hpY2ggZG9lc24ndCBtYWludGFpbiBwcm90b3R5cGVzLCBkZWZhdWx0IGlzIGBmYWxzZWAKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgICAgQ2xvbmUgb2Ygb2JqCgkgKiBAZXhhbXBsZQoJICogdmFyIHggPSB7YTogdHJ1ZSwgYjogZmFsc2V9LAoJICogICAgIHkgPSBrZWlnYWkudXRpbC5jbG9uZSggeCwgdHJ1ZSApOwoJICoKCSAqIHkuYTsgLy8gdHJ1ZQoJICovCgljbG9uZSA6IGZ1bmN0aW9uICggb2JqLCBzaGFsbG93ICkgewoJCXZhciBjbG9uZTsKCgkJaWYgKCBzaGFsbG93ID09PSB0cnVlICkgewoJCQlyZXR1cm4gb2JqICE9PSB1bmRlZmluZWQgJiYgb2JqICE9PSBudWxsID8ganNvbi5kZWNvZGUoIGpzb24uZW5jb2RlKCBvYmogKSApIDogb2JqOwoJCX0KCQllbHNlIGlmICggIW9iaiB8fCByZWdleC5wcmltaXRpdmUudGVzdCggdHlwZW9mIG9iaiApIHx8ICggb2JqIGluc3RhbmNlb2YgUmVnRXhwICkgKSB7CgkJCXJldHVybiBvYmo7CgkJfQoJCWVsc2UgaWYgKCBvYmogaW5zdGFuY2VvZiBBcnJheSApIHsKCQkJcmV0dXJuIG9iai5zbGljZSgpOwoJCX0KCQllbHNlIGlmICggIXNlcnZlciAmJiAhY2xpZW50LmllICYmIG9iaiBpbnN0YW5jZW9mIERvY3VtZW50ICkgewoJCQlyZXR1cm4geG1sLmRlY29kZSggeG1sLmVuY29kZSggb2JqICkgKTsKCQl9CgkJZWxzZSBpZiAoIHR5cGVvZiBvYmouX19wcm90b19fICE9ICJ1bmRlZmluZWQiICkgewoJCQlyZXR1cm4gdXRpbGl0eS5leHRlbmQoIG9iai5fX3Byb3RvX18sIG9iaiApOwoJCX0KCQllbHNlIGlmICggb2JqIGluc3RhbmNlb2YgT2JqZWN0ICkgewoJCQkvLyBJZiBKU09OIGVuY29kaW5nIGZhaWxzIGR1ZSB0byByZWN1cnNpb24sIHRoZSBvcmlnaW5hbCBPYmplY3QgaXMgcmV0dXJuZWQgYmVjYXVzZSBpdCdzIGFzc3VtZWQgdGhpcyBpcyBmb3IgZGVjb3JhdGlvbgoJCQljbG9uZSA9IGpzb24uZW5jb2RlKCBvYmosIHRydWUgKTsKCgkJCWlmICggY2xvbmUgIT09IHVuZGVmaW5lZCApIHsKCQkJCWNsb25lID0ganNvbi5kZWNvZGUoIGNsb25lICk7CgoJCQkJLy8gRGVjb3JhdGluZyBGdW5jdGlvbnMgdGhhdCB3b3VsZCBiZSBsb3N0IHdpdGggSlNPTiBlbmNvZGluZy9kZWNvZGluZwoJCQkJdXRpbGl0eS5pdGVyYXRlKCBvYmosIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCQlpZiAoIHR5cGVvZiB2ID09ICJmdW5jdGlvbiIgKSB7CgkJCQkJCWNsb25lW2tdID0gdjsKCQkJCQl9CgkJCQl9ICk7CgkJCX0KCQkJZWxzZSB7CgkJCQljbG9uZSA9IG9iajsKCQkJfQoKCQkJcmV0dXJuIGNsb25lOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIG9iajsKCQl9Cgl9LAoKCS8qKgoJICogQ29lcmNlcyBhIFN0cmluZyB0byBhIFR5cGUKCSAqCgkgKiBAbWV0aG9kIGNvZXJjZQoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge1N0cmluZ30gdmFsdWUgU3RyaW5nIHRvIGNvZXJjZQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgICBQcmltaXRpdmUgdmVyc2lvbiBvZiB0aGUgU3RyaW5nCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuY29lcmNlKCAiMSIgKTsgLy8gMQoJICovCgljb2VyY2UgOiBmdW5jdGlvbiAoIHZhbHVlICkgewoJCXZhciB0bXA7CgoJCWlmICggdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9CgkJZWxzZSBpZiAoIHZhbHVlID09PSAidHJ1ZSIgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCQllbHNlIGlmICggdmFsdWUgPT09ICJmYWxzZSIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJZWxzZSBpZiAoIHZhbHVlID09PSAibnVsbCIgKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCQllbHNlIGlmICggdmFsdWUgPT09ICJ1bmRlZmluZWQiICkgewoJCQlyZXR1cm4gdW5kZWZpbmVkOwoJCX0KCQllbHNlIGlmICggdmFsdWUgPT09ICIiICkgewoJCQlyZXR1cm4gdmFsdWU7CgkJfQoJCWVsc2UgaWYgKCAhaXNOYU4oIHRtcCA9IE51bWJlciggdmFsdWUgKSApICkgewoJCQlyZXR1cm4gdG1wOwoJCX0KCQllbHNlIGlmICggcmVnZXguanNvbl93cmFwLnRlc3QoIHZhbHVlICkgKSB7CgkJCXJldHVybiBqc29uLmRlY29kZSggdmFsdWUsIHRydWUgKSB8fCB2YWx1ZTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiB2YWx1ZTsKCQl9Cgl9LAoKCS8qKgoJICogUmVjb21waWxlcyBhIFJlZ0V4cCBieSByZWZlcmVuY2UKCSAqCgkgKiBUaGlzIGlzIGlkZWFsIHdoZW4geW91IG5lZWQgdG8gcmVjb21waWxlIGEgcmVnZXggZm9yIHVzZSB3aXRoaW4gYSBjb25kaXRpb25hbCBzdGF0ZW1lbnQKCSAqCgkgKiBAbWV0aG9kIGNvbXBpbGUKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtPYmplY3R9IHJlZ2V4ICAgICBSZWdFeHAKCSAqIEBwYXJhbSAge1N0cmluZ30gcGF0dGVybiAgIFJlZ3VsYXIgZXhwcmVzc2lvbiBwYXR0ZXJuCgkgKiBAcGFyYW0gIHtTdHJpbmd9IG1vZGlmaWVycyBNb2RpZmllcnMgdG8gYXBwbHkgdG8gdGhlIHBhdHRlcm4KCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgICAgICAgIHRydWUKCSAqIEBwcml2YXRlCgkgKi8KCWNvbXBpbGUgOiBmdW5jdGlvbiAoIHJlZywgcGF0dGVybiwgbW9kaWZpZXJzICkgewoJCXJlZy5jb21waWxlKCBwYXR0ZXJuLCBtb2RpZmllcnMgKTsKCgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qKgoJICogQ3VycmllcyBhIEZ1bmN0aW9uCgkgKgoJICogTm90ZTogRnVuY3Rpb24gdG8gY3VycnkgbXVzdCByZXR1cm4gYSBGdW5jdGlvbgoJICoKCSAqIEBtZXRob2QgY3VycnkKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcmV0dXJuIHtGdW5jdGlvbn0gQ3VycmllZCBGdW5jdGlvbgoJICogQGV4YW1wbGUKCSAqIGZ1bmN0aW9uIGYgKCBhLCBiICkgewoJICogICByZXR1cm4gZnVuY3Rpb24gKCBuICkgewoJICogICAgIHJldHVybiAoIGEgKyBiICkgKiBuOwoJICogICB9OwoJICogfQoJICoKCSAqIHZhciBnID0ga2VpZ2FpLnV0aWwuY3VycnkoIGYsIDIsIDggKTsKCSAqCgkgKiBnKCA1ICk7IC8vIDUwCgkgKi8KCWN1cnJ5IDogZnVuY3Rpb24gKCkgewoJCXZhciBhcmdzID0gYXJyYXkuY2FzdCggYXJndW1lbnRzICksCgkJICAgIGZuICAgPSBhcmdzLnNoaWZ0KCksCgkJICAgIGNmbiAgPSBmbi5hcHBseSggZm4sIGFyZ3MgKTsKCgkJcmV0dXJuIGZ1bmN0aW9uICgpIHsKCQkJcmV0dXJuIGNmbi5hcHBseSggY2ZuLCBhcmd1bWVudHMgKTsKCQl9OwoJfSwKCgkvKioKCSAqIERlZmVycyB0aGUgZXhlY3V0aW9uIG9mIEZ1bmN0aW9uIGJ5IGF0IGxlYXN0IHRoZSBzdXBwbGllZCBtaWxsaXNlY29uZHMuCgkgKiBUaW1pbmcgbWF5IHZhcnkgdW5kZXIgImhlYXZ5IGxvYWQiIHJlbGF0aXZlIHRvIHRoZSBDUFUgJiBjbGllbnQgSmF2YVNjcmlwdCBlbmdpbmUuCgkgKgoJICogQG1ldGhvZCBkZWZlcgoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiAgICAgRnVuY3Rpb24gdG8gZGVmZXIgZXhlY3V0aW9uIG9mCgkgKiBAcGFyYW0gIHtOdW1iZXJ9ICAgbXMgICAgIE1pbGxpc2Vjb25kcyB0byBkZWZlciBleGVjdXRpb24KCSAqIEBwYXJhbSAge051bWJlcn0gICBpZCAgICAgW09wdGlvbmFsXSBJRCBvZiB0aGUgZGVmZXJyZWQgZnVuY3Rpb24KCSAqIEBwYXJhbSAge0Jvb2xlYW59ICByZXBlYXQgW09wdGlvbmFsXSBEZXNjcmliZXMgdGhlIGV4ZWN1dGlvbiwgZGVmYXVsdCBpcyBgZmFsc2VgCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgICAgIElEIG9mIHRoZSB0aW1lcgoJICogQHByaXZhdGUKCSAqLwoJZGVmZXIgOiBmdW5jdGlvbiAoIGZuLCBtcywgaWQsIHJlcGVhdCApIHsKCQl2YXIgb3A7CgoJCW1zICAgICA9IG1zIHx8IDA7CgkJcmVwZWF0ID0gKCByZXBlYXQgPT09IHRydWUgKTsKCgkJaWYgKCBpZCAhPT0gdW5kZWZpbmVkICkgewoJCQl1dGlsaXR5LmNsZWFyVGltZXJzKCBpZCApOwoJCX0KCQllbHNlIHsKCQkJaWQgPSB1dGlsaXR5LnV1aWQoIHRydWUgKTsKCQl9CgoJCW9wID0gZnVuY3Rpb24gKCkgewoJCQl1dGlsaXR5LmNsZWFyVGltZXJzKCBpZCApOwoJCQlmbigpOwoJCX07CgoJCXV0aWxpdHlbcmVwZWF0ID8gInJlcGVhdGluZyIgOiAidGltZXIiXVtpZF0gPSBzZXRUaW1lb3V0KCBvcCwgbXMgKTsKCgkJcmV0dXJuIGlkOwoJfSwKCgkvKioKCSAqIEFzeW5jIGRlbGF5IHN0cmF0ZWd5CgkgKgoJICogQG1ldGhvZCBkZWxheQoJICogQG1lbWJlck9mIHByb21pc2UKCSAqIEByZXR1cm4ge0Z1bmN0aW9ufSBEZWxheSBtZXRob2QKCSAqIEBwcml2YXRlCgkgKi8KCWRlbGF5IDogZnVuY3Rpb24gKCkgewoJCWlmICggdHlwZW9mIHNldEltbWVkaWF0ZSAhPSAidW5kZWZpbmVkIiApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uICggYXJnICkgewoJCQkJc2V0SW1tZWRpYXRlKCBhcmcgKTsKCQkJfTsKCQl9CgkJZWxzZSBpZiAoIHR5cGVvZiBwcm9jZXNzICE9ICJ1bmRlZmluZWQiICkgewoJCQlyZXR1cm4gcHJvY2Vzcy5uZXh0VGljazsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCXNldFRpbWVvdXQoIGFyZywgMCApOwoJCQl9OwoJCX0KCX0oKSwKCgkvKioKCSAqIFF1ZXJpZXMgRE9NIHdpdGggZmFzdGVzdCBtZXRob2QKCSAqCgkgKiBAbWV0aG9kIGRvbQoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnIERPTSBxdWVyeQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgdW5kZWZpbmVkLCBFbGVtZW50LCBvciBBcnJheSBvZiBFbGVtZW50cwoJICogQHByaXZhdGUKCSAqLwoJZG9tIDogZnVuY3Rpb24gKCBhcmcgKSB7CgkJdmFyIHJlc3VsdDsKCgkJaWYgKCAhcmVnZXguc2VsZWN0b3JfY29tcGxleC50ZXN0KCBhcmcgKSApIHsKCQkJaWYgKCByZWdleC5oYXNoLnRlc3QoIGFyZyApICkgewoJCQkJcmVzdWx0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIGFyZy5yZXBsYWNlKCByZWdleC5oYXNoLCAiIiApICkgfHwgdW5kZWZpbmVkOwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5rbGFzcy50ZXN0KCBhcmcgKSApIHsKCQkJCXJlc3VsdCA9IGFycmF5LmNhc3QoIGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIGFyZy5yZXBsYWNlKCByZWdleC5rbGFzcywgIiIgKSApICk7CgkJCX0KCQkJZWxzZSBpZiAoIHJlZ2V4LndvcmQudGVzdCggYXJnICkgKSB7CgkJCQlyZXN1bHQgPSBhcnJheS5jYXN0KCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSggYXJnICkgKTsKCQkJfQoJCQllbHNlIHsKCQkJCXJlc3VsdCA9IGFycmF5LmNhc3QoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIGFyZyApICk7CgkJCX0KCQl9CgkJZWxzZSB7CgkJCXJlc3VsdCA9IGFycmF5LmNhc3QoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIGFyZyApICk7CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIEVuY29kZXMgYSBVVUlEIHRvIGEgRE9NIGZyaWVuZGx5IElECgkgKgoJICogQG1ldGhvZCBkb21JZAoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge1N0cmluZ30gVVVJRAoJICogQHJldHVybiB7U3RyaW5nfSBET00gZnJpZW5kbHkgSUQKCSAqIEBwcml2YXRlCgkgKi8KCWRvbUlkIDogZnVuY3Rpb24gKCBhcmcgKSB7CgkJcmV0dXJuICJhIiArIGFyZy5yZXBsYWNlKCAvLS9nLCAiIiApLnNsaWNlKCAxICk7Cgl9LAoKCS8qKgoJICogRXJyb3IgaGFuZGxpbmcsIHdpdGggaGlzdG9yeSBpbiBgZXJyb3IubG9nYAoJICoKCSAqIEBtZXRob2QgZXJyb3IKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtNaXhlZH0gICBlICAgICAgIEVycm9yIG9iamVjdCBvciBtZXNzYWdlIHRvIGRpc3BsYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgIGFyZ3MgICAgQXJyYXkgb2YgYXJndW1lbnRzIGZyb20gdGhlIGNhbGxzdGFjawoJICogQHBhcmFtICB7TWl4ZWR9ICAgc2NvcGUgICBFbnRpdHkgdGhhdCB3YXMgInRoaXMiCgkgKiBAcGFyYW0gIHtCb29sZWFufSB3YXJuaW5nIFtPcHRpb25hbF0gV2lsbCBkaXNwbGF5IGFzIGNvbnNvbGUgd2FybmluZyBpZiB0cnVlCgkgKiBAcmV0dXJuIHtVbmRlZmluZWR9ICAgICAgIHVuZGVmaW5lZAoJICogQHByaXZhdGUKCSAqLwoJZXJyb3IgOiBmdW5jdGlvbiAoIGUsIGFyZ3MsIHNjb3BlLCB3YXJuaW5nICkgewoJCXZhciBvID0gewoJCQkiYXJndW1lbnRzIiA6IGFyZ3MgPyBhcnJheS5jYXN0KCBhcmdzICkgOiBbXSwKCQkJbWVzc2FnZSAgICAgOiBlLm1lc3NhZ2UgfHwgZSwKCQkJbnVtYmVyICAgICAgOiBlLm51bWJlciA/ICggZS5udW1iZXIgJiAweEZGRkYgKSA6IHVuZGVmaW5lZCwKCQkJc2NvcGUgICAgICAgOiBzY29wZSwKCQkJc3RhY2sgICAgICAgOiBlLnN0YWNrIHx8IHVuZGVmaW5lZCwKCQkJdGltZXN0YW1wICAgOiBuZXcgRGF0ZSgpLnRvVVRDU3RyaW5nKCksCgkJCXR5cGUgICAgICAgIDogZS50eXBlIHx8ICJUeXBlRXJyb3IiCgkJfTsKCgkJdXRpbGl0eS5sb2coIG8uc3RhY2sgfHwgby5tZXNzYWdlLCB3YXJuaW5nICE9PSB0cnVlID8gImVycm9yIiA6ICJ3YXJuIiApOwoKCQlyZXR1cm4gdW5kZWZpbmVkOwoJfSwKCgkvKioKCSAqIENyZWF0ZXMgYSAiY2xhc3MiIGV4dGVuZGluZyBPYmplY3QsIHdpdGggb3B0aW9uYWwgZGVjb3JhdGlvbgoJICoKCSAqIEBtZXRob2QgZXh0ZW5kCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogT2JqZWN0IHRvIGV4dGVuZAoJICogQHBhcmFtICB7T2JqZWN0fSBhcmcgW09wdGlvbmFsXSBPYmplY3QgZm9yIGRlY29yYXRpb24KCSAqIEByZXR1cm4ge09iamVjdH0gICAgIERlY29yYXRlZCBvYmoKCSAqIEBleGFtcGxlCgkgKiB2YXIgZXh0ZW5kT2JqID0ga2VpZ2FpLnV0aWwuZXh0ZW5kKCBzb21lT2JqLCB7bmV3UHJvcGVydHk6IHZhbHVlfSApOwoJICovCglleHRlbmQgOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCXZhciBvOwoKCQlpZiAoIG9iaiA9PT0gdW5kZWZpbmVkICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCQl9CgoJCW8gPSBPYmplY3QuY3JlYXRlKCBvYmogKTsKCgkJaWYgKCBhcmcgaW5zdGFuY2VvZiBPYmplY3QgKSB7CgkJCXV0aWxpdHkubWVyZ2UoIG8sIGFyZyApOwoJCX0KCgkJcmV0dXJuIG87Cgl9LAoKCS8qKgoJICogR2VuZXJhdGVzIGFuIElEIHZhbHVlCgkgKgoJICogQG1ldGhvZCBnZW5JZAoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge01peGVkfSAgIG9iaiBbT3B0aW9uYWxdIE9iamVjdCB0byByZWNlaXZlIGlkCgkgKiBAcGFyYW0gIHtCb29sZWFufSBkb20gW09wdGlvbmFsXSBWZXJpZnkgdGhlIElEIGlzIHVuaXF1ZSBpbiB0aGUgRE9NLCBkZWZhdWx0IGlzIGZhbHNlCgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgICAgT2JqZWN0IG9yIGlkCgkgKiBAcHJpdmF0ZQoJICovCglnZW5JZCA6IGZ1bmN0aW9uICggb2JqLCBkb20gKSB7CgkJZG9tID0gKCBkb20gPT09IHRydWUgKTsKCQl2YXIgaWQ7CgoJCWlmICggb2JqICYmICggb2JqLmlkIHx8ICggb2JqIGluc3RhbmNlb2YgQXJyYXkgKSB8fCAoIHR5cGVvZiBvYmogPT0gInN0cmluZyIgfHwgb2JqIGluc3RhbmNlb2YgU3RyaW5nICkgKSApIHsKCQkJcmV0dXJuIG9iajsKCQl9CgoJCWlmICggZG9tICkgewoJCQlkbyB7CgkJCQlpZCA9IHV0aWxpdHkuZG9tSWQoIHV0aWxpdHkudXVpZCggdHJ1ZSApICk7CgkJCX0KCQkJd2hpbGUgKCB1dGlsaXR5LmRvbSggIiMiICsgaWQgKSApOwoJCX0KCQllbHNlIHsKCQkJaWQgPSB1dGlsaXR5LmRvbUlkKCB1dGlsaXR5LnV1aWQoIHRydWUgKSApOwoJCX0KCgkJaWYgKCB0eXBlb2Ygb2JqID09ICJvYmplY3QiICkgewoJCQlvYmouaWQgPSBpZDsKCgkJCXJldHVybiBvYmo7CgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gaWQ7CgkJfQoJfSwKCgkvKioKCSAqIEl0ZXJhdGVzIGFuIE9iamVjdCBhbmQgZXhlY3V0ZXMgYSBmdW5jdGlvbiBhZ2FpbnN0IHRoZSBwcm9wZXJ0aWVzLgoJICogUmV0dXJuaW5nIGBmYWxzZWAgaGFsdHMgaXRlcmF0aW9uLgoJICoKCSAqIEBtZXRob2QgaXRlcmF0ZQoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge09iamVjdH0gICBvYmogT2JqZWN0IHRvIGl0ZXJhdGUKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiAgRnVuY3Rpb24gdG8gZXhlY3V0ZSBhZ2FpbnN0IHByb3BlcnRpZXMKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgT2JqZWN0CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuaXRlcmF0ZSggey4uLn0sIGZ1bmN0aW9uICggdmFsdWUsIGtleSApIHsKCSAqICAgLi4uCgkgKiB9ICk7CgkgKi8KCWl0ZXJhdGUgOiBmdW5jdGlvbiAoIG9iaiwgZm4gKSB7CgkJaWYgKCB0eXBlb2YgZm4gIT0gImZ1bmN0aW9uIiApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQlhcnJheS5lYWNoKCBPYmplY3Qua2V5cyggb2JqICksIGZ1bmN0aW9uICggaSApIHsKCQkJcmV0dXJuIGZuLmNhbGwoIG9iaiwgb2JqW2ldLCBpICk7CgkJfSApOwoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFdyaXRlcyBhcmd1bWVudCB0byB0aGUgY29uc29sZQoJICoKCSAqIEBtZXRob2QgbG9nCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgICAgU3RyaW5nIHRvIHdyaXRlIHRvIHRoZSBjb25zb2xlCgkgKiBAcGFyYW0gIHtTdHJpbmd9IHRhcmdldCBbT3B0aW9uYWxdIFRhcmdldCBjb25zb2xlLCBkZWZhdWx0IGlzICJsb2ciCgkgKiBAcmV0dXJuIHtVbmRlZmluZWR9ICAgICB1bmRlZmluZWQKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5sb2coICJTb21ldGhpbmcgYmFkIGhhcHBlbmVkIiwgIndhcm4iICk7CgkgKi8KCWxvZyA6IGZ1bmN0aW9uICggYXJnLCB0YXJnZXQgKSB7CgkJdmFyIHRzLCBtc2c7CgoJCWlmICggdHlwZW9mIGNvbnNvbGUgIT0gInVuZGVmaW5lZCIgKSB7CgkJCXRzICA9IHR5cGVvZiBhcmcgIT0gIm9iamVjdCI7CgkJCW1zZyA9IHRzID8gIlsiICsgbmV3IERhdGUoKS50b0xvY2FsZVRpbWVTdHJpbmcoKSArICJdICIgKyBhcmcgOiBhcmc7CgkJCWNvbnNvbGVbdGFyZ2V0IHx8ICJsb2ciXSggbXNnICk7CgkJfQoJfSwKCgkvKioKCSAqIE1lcmdlcyBvYmogd2l0aCBhcmcKCSAqCgkgKiBAbWV0aG9kIG1lcmdlCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogT2JqZWN0IHRvIGRlY29yYXRlCgkgKiBAcGFyYW0gIHtPYmplY3R9IGFyZyBEZWNvcmF0aW9uCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBEZWNvcmF0ZWQgT2JqZWN0CgkgKiBAZXhhbXBsZQoJICogdmFyIG9iaiA9IHthOiB0cnVlfTsKCSAqCgkgKiBrZWlnYWkudXRpbC5tZXJnZSggb2JqLCB7YjogZmFsc2V9ICkKCSAqIG9iai5iOyAvLyBmYWxzZQoJICovCgltZXJnZSA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJdXRpbGl0eS5pdGVyYXRlKCBhcmcsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJaWYgKCAoIG9ialtrXSBpbnN0YW5jZW9mIEFycmF5ICkgJiYgKCB2IGluc3RhbmNlb2YgQXJyYXkgKSApIHsKCQkJCWFycmF5Lm1lcmdlKCBvYmpba10sIHYgKTsKCQkJfQoJCQllbHNlIGlmICggKCBvYmpba10gaW5zdGFuY2VvZiBPYmplY3QgKSAmJiAoIHYgaW5zdGFuY2VvZiBPYmplY3QgKSApIHsKCQkJCXV0aWxpdHkuaXRlcmF0ZSggdiwgZnVuY3Rpb24gKCB4LCB5ICkgewoJCQkJCW9ialtrXVt5XSA9IHV0aWxpdHkuY2xvbmUoIHggKTsKCQkJCX0gKTsKCQkJfQoJCQllbHNlIHsKCQkJCW9ialtrXSA9IHV0aWxpdHkuY2xvbmUoIHYgKTsKCQkJfQoJCX0gKTsKCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBQYXJzZXMgYSBVUkkgaW50byBhbiBPYmplY3QKCSAqCgkgKiBAbWV0aG9kIHBhcnNlCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7U3RyaW5nfSB1cmkgVVJJIHRvIHBhcnNlCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBQYXJzZWQgVVJJCgkgKiBAZXhhbXBsZQoJICogdmFyIHBhcnNlZCA9IGtlaWdhaS51dGlsLnBhcnNlKCBsb2NhdGlvbi5ocmVmICk7CgkgKgoJICogcGFyc2VkOwoJICogewoJICogICBhdXRoICAgICA6ICIiLAoJICogICBoYXNoICAgICA6ICIiLAoJICogICBob3N0ICAgICA6ICIiLAoJICogICBob3N0bmFtZSA6ICIiLAoJICogICBxdWVyeSAgICA6IHt9LAoJICogICBwYXRobmFtZSA6ICIiLAoJICogICBwb3J0ICAgICA6IG4sCgkgKiAgIHByb3RvY29sIDogIiIsCgkgKiAgIHNlYXJjaCAgIDogIiIsCgkgKiB9CgkgKi8KCXBhcnNlIDogZnVuY3Rpb24gKCB1cmkgKSB7CgkJdmFyIG9iaiAgICA9IHt9LAoJCSAgICBwYXJzZWQgPSB7fTsKCgkJaWYgKCB1cmkgPT09IHVuZGVmaW5lZCApIHsKCQkJdXJpID0gIXNlcnZlciA/IGxvY2F0aW9uLmhyZWYgOiAiIjsKCQl9CgoJCWlmICggIXNlcnZlciApIHsKCQkJb2JqID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7CgkJCW9iai5ocmVmID0gdXJpOwoJCX0KCQllbHNlIHsKCQkJb2JqID0gdXJsLnBhcnNlKCB1cmkgKTsKCQl9CgoJCWlmICggc2VydmVyICkgewoJCQl1dGlsaXR5Lml0ZXJhdGUoIG9iaiwgZnVuY3Rpb24gKCB2LCBrICkgewoJCQkJaWYgKCB2ID09PSBudWxsICkgewoJCQkJCW9ialtrXSA9IHVuZGVmaW5lZDsKCQkJCX0KCQkJfSApOwoJCX0KCgkJcGFyc2VkID0gewoJCQlhdXRoICAgICA6IHNlcnZlciA/IG51bGwgOiByZWdleC5hdXRoLmV4ZWMoIHVyaSApLAoJCQlwcm90b2NvbCA6IG9iai5wcm90b2NvbCB8fCAiaHR0cDoiLAoJCQlob3N0bmFtZSA6IG9iai5ob3N0bmFtZSB8fCAibG9jYWxob3N0IiwKCQkJcG9ydCAgICAgOiBvYmoucG9ydCA/IG51bWJlci5wYXJzZSggb2JqLnBvcnQsIDEwICkgOiAiIiwKCQkJcGF0aG5hbWUgOiBvYmoucGF0aG5hbWUsCgkJCXNlYXJjaCAgIDogb2JqLnNlYXJjaCAgIHx8ICIiLAoJCQloYXNoICAgICA6IG9iai5oYXNoICAgICB8fCAiIiwKCQkJaG9zdCAgICAgOiBvYmouaG9zdCAgICAgfHwgImxvY2FsaG9zdCIKCQl9OwoKCQkvLyAnY2F1c2UgSUUgaXMgLi4uIElFOyByZXF1aXJlZCBmb3IgZGF0YS5iYXRjaCgpCgkJaWYgKCBjbGllbnQuaWUgKSB7CgkJCWlmICggcGFyc2VkLnByb3RvY29sID09PSAiOiIgKSB7CgkJCQlwYXJzZWQucHJvdG9jb2wgPSBsb2NhdGlvbi5wcm90b2NvbDsKCQkJfQoKCQkJaWYgKCBzdHJpbmcuaXNFbXB0eSggcGFyc2VkLmhvc3RuYW1lICkgKSB7CgkJCQlwYXJzZWQuaG9zdG5hbWUgPSBsb2NhdGlvbi5ob3N0bmFtZTsKCQkJfQoKCQkJaWYgKCBzdHJpbmcuaXNFbXB0eSggcGFyc2VkLmhvc3QgKSApIHsKCQkJCXBhcnNlZC5ob3N0ID0gbG9jYXRpb24uaG9zdDsKCQkJfQoKCQkJaWYgKCBwYXJzZWQucGF0aG5hbWUuY2hhckF0KCAwICkgIT09ICIvIiApIHsKCQkJCXBhcnNlZC5wYXRobmFtZSA9ICIvIiArIHBhcnNlZC5wYXRobmFtZTsKCQkJfQoJCX0KCgkJcGFyc2VkLmF1dGggID0gb2JqLmF1dGggfHwgKCBwYXJzZWQuYXV0aCA9PT0gbnVsbCA/ICIiIDogcGFyc2VkLmF1dGhbMV0gKTsKCQlwYXJzZWQuaHJlZiAgPSBvYmouaHJlZiB8fCAoIHBhcnNlZC5wcm90b2NvbCArICIvLyIgKyAoIHN0cmluZy5pc0VtcHR5KCBwYXJzZWQuYXV0aCApID8gIiIgOiBwYXJzZWQuYXV0aCArICJAIiApICsgcGFyc2VkLmhvc3QgKyBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICsgcGFyc2VkLmhhc2ggKTsKCQlwYXJzZWQucGF0aCAgPSBvYmoucGF0aCB8fCBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoOwoJCXBhcnNlZC5xdWVyeSA9IHV0aWxpdHkucXVlcnlTdHJpbmcoIG51bGwsIHBhcnNlZC5zZWFyY2ggKTsKCgkJcmV0dXJuIHBhcnNlZDsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGEgcGFydGlhbGx5IGFwcGxpZWQgRnVuY3Rpb24KCSAqCgkgKiBAbWV0aG9kIHBhcnRpYWwKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcmV0dXJuIHtGdW5jdGlvbn0gUGFydGlhbCBGdW5jdGlvbgoJICogQGV4YW1wbGUKCSAqIGZ1bmN0aW9uIGYgKCBhLCBiICkgewoJICogICByZXR1cm4gYSArIGI7CgkgKiB9CgkgKgoJICogdmFyIGcgPSBrZWlnYWkudXRpbC5wYXJ0aWFsKCBmLCAyICk7CgkgKgoJICogZyggMiApOyAvLyA0CgkgKi8KCXBhcnRpYWwgOiBmdW5jdGlvbiAoKSB7CgkJdmFyIGFyZ3MgPSBhcnJheS5jYXN0KCBhcmd1bWVudHMgKSwKCQkgICAgZm4gICA9IGFyZ3Muc2hpZnQoKTsKCgkJcmV0dXJuIGZ1bmN0aW9uICgpIHsKCQkJcmV0dXJuIGZuLmFwcGx5KCBmbiwgYXJncy5jb25jYXQoIGFycmF5LmNhc3QoIGFyZ3VtZW50cyApICkgKTsKCQl9OwoJfSwKCgkvKioKCSAqIFByZXZlbnRzIGRlZmF1bHQgYmVoYXZpb3Igb2YgYW4gRXZlbnQKCSAqCgkgKiBAbWV0aG9kIHByZXZlbnQKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtPYmplY3R9IGV2IEV2ZW50CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgIEV2ZW50CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwucHJldmVudCggRXZlbnQgKTsKCSAqLwoJcHJldmVudCA6IGZ1bmN0aW9uICggZXYgKSB7CgkJaWYgKCB0eXBlb2YgZXYucHJldmVudERlZmF1bHQgPT0gImZ1bmN0aW9uIiApIHsKCQkJZXYucHJldmVudERlZmF1bHQoKTsKCQl9CgoJCXJldHVybiBldjsKCX0sCgoJLyoqCgkgKiBQYXJzZXMgYSBxdWVyeSBzdHJpbmcgJiBjb2VyY2VzIHZhbHVlcwoJICoKCSAqIEBtZXRob2QgcXVlcnlTdHJpbmcKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyAgICAgW09wdGlvbmFsXSBLZXkgdG8gZmluZCBpbiB0aGUgcXVlcnlzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gcXN0cmluZyBbT3B0aW9uYWxdIFF1ZXJ5IHN0cmluZyB0byBwYXJzZQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgICAgIFZhbHVlIG9yIE9iamVjdCBvZiBrZXk6dmFsdWUgcGFpcnMKCSAqIEBwcml2YXRlCgkgKi8KCXF1ZXJ5U3RyaW5nIDogZnVuY3Rpb24gKCBhcmcsIHFzdHJpbmcgKSB7CgkJdmFyIG9iaiAgICA9IHt9LAoJCSAgICByZXN1bHQgPSBxc3RyaW5nICE9PSB1bmRlZmluZWQgPyAoIHFzdHJpbmcuaW5kZXhPZiggIj8iICkgPiAtMSA/IHFzdHJpbmcucmVwbGFjZSggLy4qXD8vLCAiIiApIDogbnVsbCApIDogKCBzZXJ2ZXIgfHwgc3RyaW5nLmlzRW1wdHkoIGxvY2F0aW9uLnNlYXJjaCApID8gbnVsbCA6IGxvY2F0aW9uLnNlYXJjaC5yZXBsYWNlKCAiPyIsICIiICkgKTsKCgkJaWYgKCByZXN1bHQgIT09IG51bGwgJiYgIXN0cmluZy5pc0VtcHR5KCByZXN1bHQgKSApIHsKCQkJcmVzdWx0ID0gcmVzdWx0LnNwbGl0KCAiJiIgKTsKCQkJYXJyYXkuZWFjaCggcmVzdWx0LCBmdW5jdGlvbiAoIHByb3AgKSB7CgkJCQl2YXIgaXRlbSA9IHByb3Auc3BsaXQoICI9IiApOwoKCQkJCWlmICggc3RyaW5nLmlzRW1wdHkoIGl0ZW1bMF0gKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKCBpdGVtWzFdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJaXRlbVsxXSA9ICIiOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJaXRlbVsxXSA9IHV0aWxpdHkuY29lcmNlKCBkZWNvZGVVUklDb21wb25lbnQoIGl0ZW1bMV0gKSApOwoJCQkJfQoKCQkJCWlmICggb2JqW2l0ZW1bMF1dID09PSB1bmRlZmluZWQgKSB7CgkJCQkJb2JqW2l0ZW1bMF1dID0gaXRlbVsxXTsKCQkJCX0KCQkJCWVsc2UgaWYgKCAhKCBvYmpbaXRlbVswXV0gaW5zdGFuY2VvZiBBcnJheSApICkgewoJCQkJCW9ialtpdGVtWzBdXSA9IFtvYmpbaXRlbVswXV1dOwoJCQkJCW9ialtpdGVtWzBdXS5wdXNoKCBpdGVtWzFdICk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlvYmpbaXRlbVswXV0ucHVzaCggaXRlbVsxXSApOwoJCQkJfQoJCQl9ICk7CgkJfQoKCQlpZiAoIGFyZyAhPT0gbnVsbCAmJiBhcmcgIT09IHVuZGVmaW5lZCApIHsKCQkJb2JqID0gb2JqW2FyZ107CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIEFjY2VwdHMgRGVmZXJyZWRzIG9yIFByb21pc2VzIGFzIGFyZ3VtZW50cywgb3IgYW4gQXJyYXkgb2YgZWl0aGVyCgkgKgoJICogQG1ldGhvZCByYWNlCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQoJICogQGV4YW1wbGUKCSAqIHZhciBkZWZlcnJlZHMgPSBbXSwKCSAqICAgICBkZWZlcjEgICAgPSBrZWlnYWkudXRpbC5kZWZlcigpLAoJICogICAgIGRlZmVyMiAgICA9IGtlaWdhaS51dGlsLmRlZmVyKCk7CgkgKgoJICogZGVmZXJyZWRzLnB1c2goIGRlZmVyMSApOwoJICogZGVmZXJyZWRzLnB1c2goIGRlZmVyMiApOwoJICoKCSAqIC8vIEV4ZWN1dGVzIHdoZW4gb25lIGRlZmVycmVkIGlzIHJlc29sdmVkIG9yIHJlamVjdGVkCgkgKiBrZWlnYWkudXRpbC5yYWNlKCBkZWZlcnJlZHMgKS50aGVuKCBmdW5jdGlvbiAoIGFyZyApICkgewoJICogICAuLi4KCSAqIH0sIGZ1bmN0aW9uICggZXJyICkgewoJICogICAuLi4KCSAqIH0gKTsKCSAqCgkgKiAuLi4KCSAqCgkgKiBkZWZlcjEucmVzb2x2ZSggdHJ1ZSApOwoJICogZGVmZXIyLnJlc29sdmUoIHRydWUgKTsKCSAqLwoJcmFjZSA6IGZ1bmN0aW9uICgpIHsKCQl2YXIgZGVmZXIgPSBkZWZlcnJlZC5mYWN0b3J5KCksCgkJICAgIGFyZ3MgID0gYXJyYXkuY2FzdCggYXJndW1lbnRzICk7CgoJCS8vIERpZCB3ZSByZWNlaXZlIGFuIEFycmF5PyBpZiBzbyBpdCBvdmVycmlkZXMgYW55IG90aGVyIGFyZ3VtZW50cwoJCWlmICggYXJnc1swXSBpbnN0YW5jZW9mIEFycmF5ICkgewoJCQlhcmdzID0gYXJnc1swXTsKCQl9CgoJCS8vIE5vbmUsIGVuZCBvbiBuZXh0IHRpY2sKCQlpZiAoIGFyZ3MubGVuZ3RoID09PSAwICkgewoJCQlkZWZlci5yZXNvbHZlKCBudWxsICk7CgkJfQoJCS8vIFNldHVwIGFuZCB3YWl0CgkJZWxzZSB7CgkJCVByb21pc2UucmFjZSggYXJncyApLnRoZW4oIGZ1bmN0aW9uICggcmVzdWx0cyApIHsKCQkJCWRlZmVyLnJlc29sdmUoIHJlc3VsdHMgKTsKCQkJfSwgZnVuY3Rpb24gKCBlICkgewoJCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJCX0gKTsKCQl9CgoJCXJldHVybiBkZWZlcjsKCX0sCgoJLyoqCgkgKiBBc3luY2hyb25vdXMgRE9NIHJlbmRlcmluZyAoY2Fubm90IGJlIGNhbmNlbGxlZCwgc3VnZ2VzdGVkIGZvciByZWFjdGl2ZSBiZWhhdmlvcikKCSAqCgkgKiBAbWV0aG9kIHJlbmRlcgoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiBGdW5jdGlvbiB0byBleGVjdXRlIG9uIG5leHQgJ2ZyYW1lJwoJICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLnJlbmRlciggZnVuY3Rpb24gKCkgewoJICogICAgIHJldHVybiBrZWl0YWkudXRpbC5lbGVtZW50Lmh0bWwoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjaWQiICksICJIZWxsbyBXb3JsZCIgKQoJICogfSApLnRoZW4oIGZ1bmN0aW9uICggYXJnICkgewoJICogICAgIC8vIGFyZyBpcyB0aGUgcmV0dXJuIHZhbHVlIG9mIHlvdXIgZnVuY3Rpb24KCSAqIH0sIGZ1bmN0aW9uICggZSApIHsKCSAqICAgICAvLyBIYW5kbGUgZQoJICogfSApOwoJICovCglyZW5kZXIgOiBmdW5jdGlvbiAoIGZuICkgewoJCXZhciBkZWZlciA9IGRlZmVycmVkLmZhY3RvcnkoKTsKCgkJUkVOREVSKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJdHJ5IHsKCQkJCWRlZmVyLnJlc29sdmUoIGZuKCBhcmcgKSApOwoJCQl9CgkJCWNhdGNoICggZSApIHsKCQkJCWRlZmVyLnJlamVjdCggZSApOwoJCQl9CgkJfSApOwoKCQlyZXR1cm4gZGVmZXI7Cgl9LAoKCS8qKgoJICogQ3JlYXRlcyBhIHJlY3Vyc2l2ZSBmdW5jdGlvbi4gUmV0dXJuIGZhbHNlIGZyb20gdGhlIGZ1bmN0aW9uIHRvIGhhbHQgcmVjdXJzaW9uLgoJICoKCSAqIEBtZXRob2QgcmVwZWF0CgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7RnVuY3Rpb259IGZuICBGdW5jdGlvbiB0byBleGVjdXRlIHJlcGVhdGVkbHkKCSAqIEBwYXJhbSAge051bWJlcn0gICBtcyAgTWlsbGlzZWNvbmRzIHRvIHN0YWdnZXIgdGhlIGV4ZWN1dGlvbgoJICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICBbT3B0aW9uYWxdIFRpbWVvdXQgSUQKCSAqIEBwYXJhbSAge0Jvb2xlYW59ICBub3cgRXhlY3V0ZXMgYGZuYCBhbmQgdGhlbiBzZXR1cCByZXBldGl0aW9uLCBkZWZhdWx0IGlzIGB0cnVlYAoJICogQHJldHVybiB7U3RyaW5nfSAgICAgICBUaW1lb3V0IElECgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwucmVwZWF0KCBmdW5jdGlvbiAoKSB7CgkgKiAgIC4uLgoJICoKCSAqICAgLy8gQ2FuY2VsbGluZyByZXBldGl0aW9uIGF0IHNvbWUgcG9pbnQgaW4gdGhlIGZ1dHVyZQoJICogICBpZiAoIHNvbWVDb25kaXRpb24gKSB7CgkgKiAgICAgcmV0dXJuIGZhbHNlOwoJICogICB9CgkgKiB9LCAxMDAwLCAicmVwZWF0aW5nIiApOwoJICovCglyZXBlYXQgOiBmdW5jdGlvbiAoIGZuLCBtcywgaWQsIG5vdyApIHsKCQltcyAgPSBtcyB8fCAxMDsKCQlpZCAgPSBpZCB8fCB1dGlsaXR5LnV1aWQoIHRydWUgKTsKCQlub3cgPSAoIG5vdyAhPT0gZmFsc2UgKTsKCgkJLy8gQ291bGQgYmUgdmFsaWQgdG8gcmV0dXJuIGZhbHNlIGZyb20gaW5pdGlhbCBleGVjdXRpb24KCQlpZiAoIG5vdyAmJiBmbigpID09PSBmYWxzZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ3JlYXRpbmcgcmVwZWF0aW5nIGV4ZWN1dGlvbgoJCXV0aWxpdHkuZGVmZXIoIGZ1bmN0aW9uICgpIHsKCQkJdmFyIHJlY3Vyc2l2ZSA9IGZ1bmN0aW9uICggZm4sIG1zLCBpZCApIHsKCQkJCXZhciByZWN1cnNpdmUgPSB0aGlzOwoKCQkJCWlmICggZm4oKSAhPT0gZmFsc2UgKSB7CgkJCQkJdXRpbGl0eS5yZXBlYXRpbmdbaWRdID0gc2V0VGltZW91dCggZnVuY3Rpb24gKCkgewoJCQkJCQlyZWN1cnNpdmUuY2FsbCggcmVjdXJzaXZlLCBmbiwgbXMsIGlkICk7CgkJCQkJfSwgbXMgKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWRlbGV0ZSB1dGlsaXR5LnJlcGVhdGluZ1tpZF07CgkJCQl9CgkJCX07CgoJCQlyZWN1cnNpdmUuY2FsbCggcmVjdXJzaXZlLCBmbiwgbXMsIGlkICk7CgkJfSwgbXMsIGlkLCB0cnVlICk7CgoJCXJldHVybiBpZDsKCX0sCgoJLyoqCgkgKiBTdG9wcyBhbiBFdmVudCBmcm9tIGJ1YmJsaW5nLCAmIHByZXZlbnRzIGRlZmF1bHQgYmVoYXZpb3IKCSAqCgkgKiBAbWV0aG9kIHN0b3AKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtPYmplY3R9IGV2IEV2ZW50CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgIEV2ZW50CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuc3RvcCggRXZlbnQgKTsKCSAqLwoJc3RvcCA6IGZ1bmN0aW9uICggZXYgKSB7CgkJaWYgKCB0eXBlb2YgZXYuc3RvcFByb3BhZ2F0aW9uID09ICJmdW5jdGlvbiIgKSB7CgkJCWV2LnN0b3BQcm9wYWdhdGlvbigpOwoJCX0KCgkJdXRpbGl0eS5wcmV2ZW50KCBldiApOwoKCQlyZXR1cm4gZXY7Cgl9LAoKCS8qKgoJICogUmV0dXJucyB0aGUgRXZlbnQgdGFyZ2V0CgkgKgoJICogQG1ldGhvZCB0YXJnZXQKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtPYmplY3R9IGV2IEV2ZW50CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgIEV2ZW50IHRhcmdldAoJICogQGV4YW1wbGUKCSAqIHZhciB0YXJnZXQgPSBrZWlnYWkudXRpbC50YXJnZXQoIEV2ZW50ICk7CgkgKi8KCXRhcmdldCA6IGZ1bmN0aW9uICggZXYgKSB7CgkJcmV0dXJuIGV2LnRhcmdldCB8fCBldi5zcmNFbGVtZW50OwoJfSwKCgkvKioKCSAqIEdlbmVyYXRlcyBhIHZlcnNpb24gNCBVVUlECgkgKgoJICogQG1ldGhvZCB1dWlkCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7Qm9vbGVhbn0gc3RyaXAgW09wdGlvbmFsXSBTdHJpcHMgLSBmcm9tIFVVSUQKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgICAgIFVVSUQKCSAqIEBleGFtcGxlCgkgKiB2YXIgdXVpZDQgPSBrZWlnYWkudXRpbC51dWlkKCk7CgkgKi8KCXV1aWQgOiBmdW5jdGlvbiAoIHN0cmlwICkgewoJCXZhciBzID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gKCAoICggMSArIE1hdGgucmFuZG9tKCkgKSAqIDB4MTAwMDAgKSB8IDAgKS50b1N0cmluZyggMTYgKS5zdWJzdHJpbmcoIDEgKTsgfSwKCQkgICAgciA9IFs4LCA5LCAiYSIsICJiIl0sCgkJICAgIG87CgoJCW8gPSAoIHMoKSArIHMoKSArICItIiArIHMoKSArICItNCIgKyBzKCkuc3Vic3RyKCAwLCAzICkgKyAiLSIgKyByW01hdGguZmxvb3IoIE1hdGgucmFuZG9tKCkgKiA0ICldICsgcygpLnN1YnN0ciggMCwgMyApICsgIi0iICsgcygpICsgcygpICsgcygpICk7CgoJCWlmICggc3RyaXAgPT09IHRydWUgKSB7CgkJCW8gPSBvLnJlcGxhY2UoIC8tL2csICIiICk7CgkJfQoKCQlyZXR1cm4gbzsKCX0sCgoJLyoqCgkgKiBXYWxrcyBgb2JqYCBhbmQgcmV0dXJucyBgYXJnYCwgZm9yIHdoZW4geW91IGNhbid0IGVhc2lseSBhY2Nlc3MgYGFyZ2AKCSAqCgkgKiBAbWV0aG9kICB3YWxrCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7TWl4ZWR9ICBvYmogIE9iamVjdCBvciBBcnJheQoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgIFN0cmluZyBkZXNjcmliaW5nIHRoZSBwcm9wZXJ0eSB0byByZXR1cm4KCSAqIEByZXR1cm4ge01peGVkfSAgICAgICBUYXJnZXQgb3IgdW5kZWZpbmVkCgkgKiBAZXhhbXBsZQoJICogdmFyIG9iaiA9IHthOiBbe2I6IHRydWV9XX07CgkgKgoJICoga2VpZ2FpLnV0aWwud2Fsayggb2JqLCAiYVswXS5iIiApOyAvLyB0cnVlCgkgKi8KCXdhbGsgOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCXZhciBvdXRwdXQgPSBvYmo7CgoJCWFycmF5LmVhY2goIGFyZy5yZXBsYWNlKCAvXF0kLywgIiIgKS5yZXBsYWNlKCAvXF0vZywgIi4iICkucmVwbGFjZSggL1wuXC4vZywgIi4iICkuc3BsaXQoIC9cLnxcWy8gKSwgZnVuY3Rpb24gKCBpICkgewoJCQlpZiAoIG91dHB1dFtpXSA9PT0gdW5kZWZpbmVkIHx8IG91dHB1dFtpXSA9PT0gbnVsbCApIHsKCQkJCW91dHB1dCA9IHVuZGVmaW5lZDsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJb3V0cHV0ID0gb3V0cHV0W2ldOwoJCX0gKTsKCgkJcmV0dXJuIG91dHB1dDsKCX0sCgoJLyoqCgkgKiBBY2NlcHRzIERlZmVycmVkcyBvciBQcm9taXNlcyBhcyBhcmd1bWVudHMsIG9yIGFuIEFycmF5IG9mIGVpdGhlcgoJICoKCSAqIEBtZXRob2Qgd2hlbgoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EZWZlcnJlZH0KCSAqIEBleGFtcGxlCgkgKiB2YXIgZGVmZXJyZWRzID0gW10sCgkgKiAgICAgZGVmZXIxICAgID0ga2VpZ2FpLnV0aWwuZGVmZXIoKSwKCSAqICAgICBkZWZlcjIgICAgPSBrZWlnYWkudXRpbC5kZWZlcigpOwoJICoKCSAqIGRlZmVycmVkcy5wdXNoKCBkZWZlcjEgKTsKCSAqIGRlZmVycmVkcy5wdXNoKCBkZWZlcjIgKTsKCSAqCgkgKiAvLyBFeGVjdXRlcyB3aGVuIGJvdGggZGVmZXJyZWRzIGhhdmUgcmVzb2x2ZWQgb3Igb25lIGhhcyByZWplY3RlZAoJICoga2VpZ2FpLnV0aWwud2hlbiggZGVmZXJyZWRzICkudGhlbiggZnVuY3Rpb24gKCBhcmdzICkgKSB7CgkgKiAgIC4uLgoJICogfSwgZnVuY3Rpb24gKCBlcnIgKSB7CgkgKiAgIC4uLgoJICogfSApOwoJICoKCSAqIC4uLgoJICoKCSAqIGRlZmVyMS5yZXNvbHZlKCB0cnVlICk7CgkgKiBkZWZlcjIucmVzb2x2ZSggdHJ1ZSApOwoJICovCgl3aGVuIDogZnVuY3Rpb24gKCkgewoJCXZhciBkZWZlciA9IGRlZmVycmVkLmZhY3RvcnkoKSwKCQkgICAgYXJncyAgPSBhcnJheS5jYXN0KCBhcmd1bWVudHMgKTsKCgkJLy8gRGlkIHdlIHJlY2VpdmUgYW4gQXJyYXk/IGlmIHNvIGl0IG92ZXJyaWRlcyBhbnkgb3RoZXIgYXJndW1lbnRzCgkJaWYgKCBhcmdzWzBdIGluc3RhbmNlb2YgQXJyYXkgKSB7CgkJCWFyZ3MgPSBhcmdzWzBdOwoJCX0KCgkJLy8gTm9uZSwgZW5kIG9uIG5leHQgdGljawoJCWlmICggYXJncy5sZW5ndGggPT09IDAgKSB7CgkJCWRlZmVyLnJlc29sdmUoIG51bGwgKTsKCQl9CgkJLy8gU2V0dXAgYW5kIHdhaXQKCQllbHNlIHsKCQkJUHJvbWlzZS5hbGwoIGFyZ3MgKS50aGVuKCBmdW5jdGlvbiAoIHJlc3VsdHMgKSB7CgkJCQlkZWZlci5yZXNvbHZlKCByZXN1bHRzICk7CgkJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCWRlZmVyLnJlamVjdCggZSApOwoJCQl9ICk7CgkJfQoKCQlyZXR1cm4gZGVmZXI7Cgl9LAoKCS8qKgoJICogV29ya2VyIGZhY3RvcnkKCSAqCgkgKiBAbWV0aG9kIHdvcmtlcgoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge09iamVjdH0gZGVmZXIgRGVmZXJyZWQgdG8gcmVjZWl2ZSBtZXNzYWdlIGZyb20gV29ya2VyCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgIFdvcmtlcgoJICogQHByaXZhdGUKCSAqLwoJd29ya2VyIDogZnVuY3Rpb24gKCBkZWZlciApIHsKCQl2YXIgb2JqID0gbmV3IFdvcmtlciggV09SS0VSICk7CgoJCW9iai5vbmVycm9yID0gZnVuY3Rpb24gKCBlcnIgKSB7CgkJCWRlZmVyLnJlamVjdCggZXJyICk7CgkJCW9iai50ZXJtaW5hdGUoKTsKCQl9OwoKCQlvYmoub25tZXNzYWdlID0gZnVuY3Rpb24gKCBldiApIHsKCQkJZGVmZXIucmVzb2x2ZSggZXYuZGF0YSApOwoJCQlvYmoudGVybWluYXRlKCk7CgkJfTsKCgkJcmV0dXJuIG9iajsKCX0KfTsKCi8qKgogKiBYTUxIdHRwUmVxdWVzdCBzaGltIGZvciBub2RlLmpzCiAqCiAqIEBtZXRob2QgeGhyCiAqIEBwcml2YXRlCiAqIEByZXR1cm4ge09iamVjdH0gWE1MSHR0cFJlcXVlc3QgaW5zdGFuY2UKICovCmZ1bmN0aW9uIHhociAoKSB7Cgl2YXIgVU5TRU5UICAgICAgICAgICA9IDAsCgkgICAgT1BFTkVEICAgICAgICAgICA9IDEsCgkgICAgSEVBREVSU19SRUNFSVZFRCA9IDIsCgkgICAgTE9BRElORyAgICAgICAgICA9IDMsCgkgICAgRE9ORSAgICAgICAgICAgICA9IDQsCgkgICAgRVJSX1JFRlVTRUQgICAgICA9IC9FQ09OTlJFRlVTRUQvLAoJICAgIHJlYWR5ICAgICAgICAgICAgPSBuZXcgUmVnRXhwKCBIRUFERVJTX1JFQ0VJVkVEICsgInwiICsgTE9BRElORyApLAoJICAgIFhNTEh0dHBSZXF1ZXN0LCBoZWFkZXJzLCBkaXNwYXRjaCwgc3VjY2VzcywgZmFpbHVyZSwgc3RhdGU7CgoJaGVhZGVycyA9IHsKCQkidXNlci1hZ2VudCIgICA6ICJrZWlnYWkvMC45LjAgbm9kZS5qcy8iICsgcHJvY2Vzcy52ZXJzaW9ucy5ub2RlLnJlcGxhY2UoIC9edi8sICIiICkgKyAiICgiICsgc3RyaW5nLmNhcGl0YWxpemUoIHByb2Nlc3MucGxhdGZvcm0gKSArICIgVjgvIiArIHByb2Nlc3MudmVyc2lvbnMudjggKyAiICkiLAoJCSJjb250ZW50LXR5cGUiIDogInRleHQvcGxhaW4iLAoJCSJhY2NlcHQiICAgICAgIDogIiovKiIKCX07CgoJLyoqCgkgKiBEaXNwYXRjaGVzIGFuIGV2ZW50CgkgKgoJICogQG1ldGhvZCBkaXNwYXRjaAoJICogQG1lbWJlck9mIHhocgoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgRXZlbnQgdG8gZGlzcGF0Y2gKCSAqIEByZXR1cm4ge09iamVjdH0gICAgIFhNTEh0dHBSZXF1ZXN0IGluc3RhbmNlCgkgKi8KCWRpc3BhdGNoID0gZnVuY3Rpb24gKCBhcmcgKSB7CgkJdmFyIGZuID0gIm9uIiArIGFyZzsKCgkJaWYgKCB0eXBlb2YgdGhpc1tmbl0gPT0gImZ1bmN0aW9uIiApIHsKCQkJdGhpc1tmbl0oKTsKCQl9CgoJCXRoaXMuZGlzcGF0Y2hFdmVudCggYXJnICk7CgoJCXJldHVybiB0aGlzOwoJfTsKCgkvKioKCSAqIENoYW5nZXMgdGhlIHJlYWR5U3RhdGUgb2YgYW4gWE1MSHR0cFJlcXVlc3QKCSAqCgkgKiBAbWV0aG9kIHN0YXRlCgkgKiBAbWVtYmVyT2YgeGhyCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBOZXcgcmVhZHlTdGF0ZQoJICogQHJldHVybiB7T2JqZWN0fSAgICAgWE1MSHR0cFJlcXVlc3QgaW5zdGFuY2UKCSAqLwoJc3RhdGUgPSBmdW5jdGlvbiAoIGFyZyApIHsKCQlpZiAoIHRoaXMucmVhZHlTdGF0ZSAhPT0gYXJnICkgewoJCQl0aGlzLnJlYWR5U3RhdGUgPSBhcmc7CgkJCWRpc3BhdGNoLmNhbGwoIHRoaXMsICJyZWFkeXN0YXRlY2hhbmdlIiApOwoKCQkJaWYgKCB0aGlzLnJlYWR5U3RhdGUgPT09IERPTkUgJiYgIXRoaXMuX2Vycm9yICkgewoJCQkJZGlzcGF0Y2guY2FsbCggdGhpcywgImxvYWQiICk7CgkJCQlkaXNwYXRjaC5jYWxsKCB0aGlzLCAibG9hZGVuZCIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogUmVzcG9uc2UgaGFuZGxlcgoJICoKCSAqIEBtZXRob2Qgc3VjY2VzcwoJICogQG1lbWJlck9mIHhocgoJICogQHBhcmFtICB7T2JqZWN0fSByZXMgSFRUUChTKSBSZXNwb25zZSBPYmplY3QKCSAqIEByZXR1cm4ge1VuZGVmaW5lZH0gIHVuZGVmaW5lZAoJICovCglzdWNjZXNzID0gZnVuY3Rpb24gKCByZXMgKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzdGF0ZS5jYWxsKCB0aGlzLCBIRUFERVJTX1JFQ0VJVkVEICk7CgkJdGhpcy5zdGF0dXMgICAgICA9IHJlcy5zdGF0dXNDb2RlOwoJCXRoaXMuX3Jlc2hlYWRlcnMgPSByZXMuaGVhZGVyczsKCgkJaWYgKCB0aGlzLl9yZXNoZWFkZXJzWyJzZXQtY29va2llIl0gJiYgdGhpcy5fcmVzaGVhZGVyc1sic2V0LWNvb2tpZSJdIGluc3RhbmNlb2YgQXJyYXkgKSB7CgkJCXRoaXMuX3Jlc2hlYWRlcnNbInNldC1jb29raWUiXSA9IHRoaXMuX3Jlc2hlYWRlcnNbInNldC1jb29raWUiXS5qb2luKCAiOyIgKTsKCQl9CgoJCXJlcy5vbiggImRhdGEiLCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJcmVzLnNldEVuY29kaW5nKCAidXRmOCIgKTsKCgkJCWlmICggc2VsZi5fc2VuZCApIHsKCQkJCWlmICggYXJnICkgewoJCQkJCXNlbGYucmVzcG9uc2VUZXh0ICs9IGFyZzsKCQkJCX0KCgkJCQlzdGF0ZS5jYWxsKCBzZWxmLCBMT0FESU5HICk7CgkJCX0KCQl9ICk7CgoJCXJlcy5vbiggImVuZCIsIGZ1bmN0aW9uICgpIHsKCQkJaWYgKCBzZWxmLl9zZW5kICkgewoJCQkJc3RhdGUuY2FsbCggc2VsZiwgRE9ORSApOwoJCQkJc2VsZi5fc2VuZCA9IGZhbHNlOwoJCQl9CgkJfSApOwoJfTsKCgkvKioKCSAqIFJlc3BvbnNlIGVycm9yIGhhbmRsZXIKCSAqCgkgKiBAbWV0aG9kIGZhaWx1cmUKCSAqIEBtZW1iZXJPZiB4aHIKCSAqIEBwYXJhbSAge09iamVjdH0gZSBFcnJvcgoJICogQHJldHVybiB7VW5kZWZpbmVkfSB1bmRlZmluZWQKCSAqLwoJZmFpbHVyZSA9IGZ1bmN0aW9uICggZSApIHsKCQl0aGlzLnN0YXR1cyAgICAgICA9IEVSUl9SRUZVU0VELnRlc3QoIGUubWVzc2FnZSApID8gNTAzIDogNTAwOwoJCXRoaXMuc3RhdHVzVGV4dCAgID0gIiI7CgkJdGhpcy5yZXNwb25zZVRleHQgPSBlLm1lc3NhZ2U7CgkJdGhpcy5fZXJyb3IgICAgICAgPSB0cnVlOwoJCXRoaXMuX3NlbmQgICAgICAgID0gZmFsc2U7CgkJZGlzcGF0Y2guY2FsbCggdGhpcywgImVycm9yIiApOwoJCXN0YXRlLmNhbGwoIHRoaXMsIERPTkUgKTsKCX07CgoJLyoqCgkgKiBDcmVhdGVzIGEgbmV3IFhNTEh0dHBSZXF1ZXN0CgkgKgoJICogQGNvbnN0cnVjdG9yCgkgKiBAcHJpdmF0ZQoJICogQG1lbWJlck9mIHhocgoJICogQHJldHVybiB7T2JqZWN0fSBYTUxIdHRwUmVxdWVzdCBpbnN0YW5jZQoJICovCglYTUxIdHRwUmVxdWVzdCA9IGZ1bmN0aW9uICgpIHsKCQl0aGlzLm9uYWJvcnQgICAgICAgICAgICA9IG51bGw7CgkJdGhpcy5vbmVycm9yICAgICAgICAgICAgPSBudWxsOwoJCXRoaXMub25sb2FkICAgICAgICAgICAgID0gbnVsbDsKCQl0aGlzLm9ubG9hZGVuZCAgICAgICAgICA9IG51bGw7CgkJdGhpcy5vbmxvYWRzdGFydCAgICAgICAgPSBudWxsOwoJCXRoaXMub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKCQl0aGlzLnJlYWR5U3RhdGUgICAgICAgICA9IFVOU0VOVDsKCQl0aGlzLnJlc3BvbnNlICAgICAgICAgICA9IG51bGw7CgkJdGhpcy5yZXNwb25zZVRleHQgICAgICAgPSAiIjsKCQl0aGlzLnJlc3BvbnNlVHlwZSAgICAgICA9ICIiOwoJCXRoaXMucmVzcG9uc2VYTUwgICAgICAgID0gbnVsbDsKCQl0aGlzLnN0YXR1cyAgICAgICAgICAgICA9IFVOU0VOVDsKCQl0aGlzLnN0YXR1c1RleHQgICAgICAgICA9ICIiOwoJCXRoaXMub2JzZXJ2ZXIgICAgICAgICAgID0gb2JzZXJ2YWJsZS5mYWN0b3J5KCk7CgoJCS8vIFBzdWVkbyBwcml2YXRlIGZvciBwcm90b3R5cGUgY2hhaW4KCQl0aGlzLl9lcnJvciAgICAgICAgICAgICA9IGZhbHNlOwoJCXRoaXMuX2hlYWRlcnMgICAgICAgICAgID0ge307CgkJdGhpcy5fcGFyYW1zICAgICAgICAgICAgPSB7fTsKCQl0aGlzLl9yZXF1ZXN0ICAgICAgICAgICA9IG51bGw7CgkJdGhpcy5fcmVzaGVhZGVycyAgICAgICAgPSB7fTsKCQl0aGlzLl9zZW5kICAgICAgICAgICAgICA9IGZhbHNlOwoJfTsKCgkvKioKCSAqIEV4dGVuZGluZyBCYXNlCgkgKgoJICogQG1lbWJlck9mIGtlaWdhaS5YTUxIdHRwUmVxdWVzdAoJICogQHR5cGUge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQoJICovCglYTUxIdHRwUmVxdWVzdC5wcm90b3R5cGUgPSBiYXNlLmZhY3RvcnkoKTsKCgkvKioKCSAqIFNldHRpbmcgY29uc3RydWN0b3IgbG9vcAoJICoKCSAqIEBtZXRob2QgY29uc3RydWN0b3IKCSAqIEBtZW1iZXJPZiBrZWlnYWkuWE1MSHR0cFJlcXVlc3QKCSAqIEB0eXBlIHtGdW5jdGlvbn0KCSAqIEBwcml2YXRlCgkgKi8KCVhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFhNTEh0dHBSZXF1ZXN0OwoKCS8qKgoJICogQWJvcnRzIGEgcmVxdWVzdAoJICoKCSAqIEBtZXRob2QgYWJvcnQKCSAqIEBtZW1iZXJPZiBYTUxIdHRwUmVxdWVzdAoJICogQHJldHVybiB7T2JqZWN0fSBYTUxIdHRwUmVxdWVzdCBpbnN0YW5jZQoJICovCglYTUxIdHRwUmVxdWVzdC5wcm90b3R5cGUuYWJvcnQgPSBmdW5jdGlvbiAoKSB7CgkJaWYgKCB0aGlzLl9yZXF1ZXN0ICE9PSBudWxsICkgewoJCQl0aGlzLl9yZXF1ZXN0LmFib3J0KCk7CgkJCXRoaXMuX3JlcXVlc3QgICAgID0gbnVsbDsKCQkJdGhpcy5yZXNwb25zZVRleHQgPSAiIjsKCQkJdGhpcy5yZXNwb25zZVhNTCAgPSAiIjsKCQkJdGhpcy5fZXJyb3IgICAgICAgPSB0cnVlOwoJCQl0aGlzLl9oZWFkZXJzICAgICA9IHt9OwoKCQkJaWYgKCB0aGlzLl9zZW5kID09PSB0cnVlIHx8IHJlYWR5LnRlc3QoIHRoaXMucmVhZHlTdGF0ZSApICkgewoJCQkJdGhpcy5fc2VuZCA9IGZhbHNlOwoJCQkJc3RhdGUuY2FsbCggdGhpcywgRE9ORSApOwoJCQl9CgoJCQlkaXNwYXRjaC5jYWxsKCB0aGlzLCAiYWJvcnQiICk7CgkJCXRoaXMucmVhZHlTdGF0ZSA9IFVOU0VOVDsKCQl9CgoJCXJldHVybiB0aGlzOwoJfTsKCgkvKioKCSAqIEdldHMgYWxsIHJlc3BvbnNlIGhlYWRlcnMKCSAqCgkgKiBAbWV0aG9kIGdldEFsbFJlc3BvbnNlSGVhZGVycwoJICogQG1lbWJlck9mIFhNTEh0dHBSZXF1ZXN0CgkgKiBAcmV0dXJuIHtPYmplY3R9IFJlc3BvbnNlIGhlYWRlcnMKCSAqLwoJWE1MSHR0cFJlcXVlc3QucHJvdG90eXBlLmdldEFsbFJlc3BvbnNlSGVhZGVycyA9IGZ1bmN0aW9uICgpIHsKCQl2YXIgcmVzdWx0ID0gIiI7CgoJCWlmICggdGhpcy5yZWFkeVN0YXRlIDwgSEVBREVSU19SRUNFSVZFRCApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkU3RhdGVOb0hlYWRlcnMgKTsKCQl9CgoJCXV0aWxpdHkuaXRlcmF0ZSggdGhpcy5fcmVzaGVhZGVycywgZnVuY3Rpb24gKCB2LCBrICkgewoJCQlyZXN1bHQgKz0gayArICI6ICIgKyB2ICsgIlxuIjsKCQl9ICk7CgoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCS8qKgoJICogR2V0cyBhIHNwZWNpZmljIHJlc3BvbnNlIGhlYWRlcgoJICoKCSAqIEBtZXRob2QgZ2V0UmVzcG9uc2VIZWFkZXIKCSAqIEBtZW1iZXJPZiBYTUxIdHRwUmVxdWVzdAoJICogQHBhcmFtICB7U3RyaW5nfSBoZWFkZXIgSGVhZGVyIHRvIGdldAoJICogQHJldHVybiB7U3RyaW5nfSAgICAgICAgUmVzcG9uc2UgaGVhZGVyIHZhbHVlCgkgKi8KCVhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5nZXRSZXNwb25zZUhlYWRlciA9IGZ1bmN0aW9uICggaGVhZGVyICkgewoJCXZhciByZXN1bHQ7CgoJCWlmICggdGhpcy5yZWFkeVN0YXRlIDwgSEVBREVSU19SRUNFSVZFRCB8fCB0aGlzLl9lcnJvciApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkU3RhdGVOb0hlYWRlcnMgKTsKCQl9CgoJCXJlc3VsdCA9IHRoaXMuX3Jlc2hlYWRlcnNbaGVhZGVyXSB8fCB0aGlzLl9yZXNoZWFkZXJzW2hlYWRlci50b0xvd2VyQ2FzZSgpXTsKCgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJLyoqCgkgKiBQcmVwYXJlcyBhbiBYTUxIdHRwUmVxdWVzdCBpbnN0YW5jZSB0byBtYWtlIGEgcmVxdWVzdAoJICoKCSAqIEBtZXRob2Qgb3BlbgoJICogQG1lbWJlck9mIFhNTEh0dHBSZXF1ZXN0CgkgKiBAcGFyYW0gIHtTdHJpbmd9ICBtZXRob2QgICBIVFRQIG1ldGhvZAoJICogQHBhcmFtICB7U3RyaW5nfSAgdXJsICAgICAgVVJMIHRvIHJlY2VpdmUgcmVxdWVzdAoJICogQHBhcmFtICB7Qm9vbGVhbn0gYXN5bmMgICAgW09wdGlvbmFsXSBBc3luY2hyb25vdXMgcmVxdWVzdAoJICogQHBhcmFtICB7U3RyaW5nfSAgdXNlciAgICAgW09wdGlvbmFsXSBCYXNpYyBhdXRoIHVzZXJuYW1lCgkgKiBAcGFyYW0gIHtTdHJpbmd9ICBwYXNzd29yZCBbT3B0aW9uYWxdIEJhc2ljIGF1dGggcGFzc3dvcmQKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgICAgIFhNTEh0dHBSZXF1ZXN0IGluc3RhbmNlCgkgKi8KCVhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5vcGVuID0gZnVuY3Rpb24gKCBtZXRob2QsIHVybCwgYXN5bmMsIHVzZXIsIHBhc3N3b3JkICkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJaWYgKCBhc3luYyAhPT0gdHJ1ZSApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkU3RhdGVOb1N5bmMgKTsKCQl9CgoJCXRoaXMuYWJvcnQoKTsKCQl0aGlzLl9lcnJvciAgPSBmYWxzZTsKCQl0aGlzLl9wYXJhbXMgPSB7CgkJCW1ldGhvZCAgIDogbWV0aG9kLAoJCQl1cmwgICAgICA6IHVybCwKCQkJYXN5bmMgICAgOiBhc3luYyAgICB8fCB0cnVlLAoJCQl1c2VyICAgICA6IHVzZXIgICAgIHx8IG51bGwsCgkJCXBhc3N3b3JkIDogcGFzc3dvcmQgfHwgbnVsbAoJCX07CgoJCXV0aWxpdHkuaXRlcmF0ZSggaGVhZGVycywgZnVuY3Rpb24gKCB2LCBrICkgewoJCQlzZWxmLl9oZWFkZXJzW2tdID0gdjsKCQl9ICk7CgoJCXRoaXMucmVhZHlTdGF0ZSA9IE9QRU5FRDsKCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogT3ZlcnJpZGVzIHRoZSBDb250ZW50LVR5cGUgb2YgdGhlIHJlcXVlc3QKCSAqCgkgKiBAbWV0aG9kIG92ZXJyaWRlTWltZVR5cGUKCSAqIEBtZW1iZXJPZiBYTUxIdHRwUmVxdWVzdAoJICogQHBhcmFtICB7U3RyaW5nfSBtaW1lIE1pbWUgdHlwZSBvZiB0aGUgcmVxdWVzdCAoIG1lZGlhIHR5cGUgKQoJICogQHJldHVybiB7T2JqZWN0fSAgICAgIFhNTEh0dHBSZXF1ZXN0IGluc3RhbmNlCgkgKi8KCVhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5vdmVycmlkZU1pbWVUeXBlID0gZnVuY3Rpb24gKCBtaW1lICkgewoJCXRoaXMuX2hlYWRlcnNbImNvbnRlbnQtdHlwZSJdID0gbWltZTsKCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogU2VuZHMgYW4gWE1MSHR0cFJlcXVlc3QgcmVxdWVzdAoJICoKCSAqIEBtZXRob2Qgc2VuZAoJICogQG1lbWJlck9mIFhNTEh0dHBSZXF1ZXN0CgkgKiBAcGFyYW0gIHtNaXhlZH0gZGF0YSBbT3B0aW9uYWxdIFBheWxvYWQgdG8gc2VuZCB3aXRoIHRoZSByZXF1ZXN0CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBYTUxIdHRwUmVxdWVzdCBpbnN0YW5jZQoJICovCglYTUxIdHRwUmVxdWVzdC5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uICggZGF0YSApIHsKCQlkYXRhICAgICA9IGRhdGEgfHwgbnVsbDsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJICAgIG9wdGlvbnMsIHBhcnNlZCwgcmVxdWVzdCwgb2JqOwoKCQlpZiAoIHRoaXMucmVhZHlTdGF0ZSA8IE9QRU5FRCApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkU3RhdGVOb3RPcGVuICk7CgkJfQoJCWVsc2UgaWYgKCB0aGlzLl9zZW5kICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRTdGF0ZU5vdFNlbmRpbmcgKTsKCQl9CgoJCXBhcnNlZCAgICAgID0gdXRpbGl0eS5wYXJzZSggdGhpcy5fcGFyYW1zLnVybCApOwoJCXBhcnNlZC5wb3J0ID0gcGFyc2VkLnBvcnQgfHwgKCBwYXJzZWQucHJvdG9jb2wgPT09ICJodHRwczoiID8gNDQzIDogODAgKTsKCgkJaWYgKCB0aGlzLl9wYXJhbXMudXNlciAhPT0gbnVsbCAmJiB0aGlzLl9wYXJhbXMucGFzc3dvcmQgIT09IG51bGwgKSB7CgkJCXBhcnNlZC5hdXRoID0gdGhpcy5fcGFyYW1zLnVzZXIgKyAiOiIgKyB0aGlzLl9wYXJhbXMucGFzc3dvcmQ7CgkJfQoKCQkvLyBTcGVjaWZ5aW5nIENvbnRlbnQtTGVuZ3RoIGFjY29yZGluZ2x5CgkJaWYgKCByZWdleC5wdXRfcG9zdC50ZXN0KCB0aGlzLl9wYXJhbXMubWV0aG9kICkgKSB7CgkJCWlmICggZGF0YSA9PT0gbnVsbCApIHsKCQkJCXRoaXMuX2hlYWRlcnNbImNvbnRlbnQtbGVuZ3RoIl0gPSAwOwoJCQl9CgkJCWVsc2UgaWYgKCB0eXBlb2YgZGF0YSA9PSAic3RyaW5nIiApIHsKCQkJCXRoaXMuX2hlYWRlcnNbImNvbnRlbnQtbGVuZ3RoIl0gPSBCdWZmZXIuYnl0ZUxlbmd0aCggZGF0YSApOwoJCQl9CgkJCWVsc2UgaWYgKCBkYXRhIGluc3RhbmNlb2YgQnVmZmVyIHx8IHR5cGVvZiBkYXRhLnRvU3RyaW5nID09ICJmdW5jdGlvbiIgKSB7CgkJCQlkYXRhID0gZGF0YS50b1N0cmluZygpOwoJCQkJdGhpcy5faGVhZGVyc1siY29udGVudC1sZW5ndGgiXSA9IEJ1ZmZlci5ieXRlTGVuZ3RoKCBkYXRhICk7CgkJCX0KCQkJZWxzZSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCQkJfQoJCX0KCgkJdGhpcy5faGVhZGVycy5ob3N0ID0gcGFyc2VkLmhvc3Q7CgoJCWlmICggdGhpcy5faGVhZGVyc1sieC1yZXF1ZXN0ZWQtd2l0aCJdID09PSAiWE1MSHR0cFJlcXVlc3QiICkgewoJCQlkZWxldGUgdGhpcy5faGVhZGVyc1sieC1yZXF1ZXN0ZWQtd2l0aCJdOwoJCX0KCgkJb3B0aW9ucyA9IHsKCQkJaG9zdG5hbWUgOiBwYXJzZWQuaG9zdG5hbWUsCgkJCXBhdGggICAgIDogcGFyc2VkLnBhdGgsCgkJCXBvcnQgICAgIDogcGFyc2VkLnBvcnQsCgkJCW1ldGhvZCAgIDogdGhpcy5fcGFyYW1zLm1ldGhvZCwKCQkJaGVhZGVycyAgOiB0aGlzLl9oZWFkZXJzCgkJfTsKCgkJaWYgKCBwYXJzZWQucHJvdG9jb2wgPT09ICJodHRwczoiICkgewoJCQlvcHRpb25zLnJlamVjdFVuYXV0aG9yaXplZCA9IGZhbHNlOwoJCQlvcHRpb25zLmFnZW50ICAgICAgICAgICAgICA9IGZhbHNlOwoJCX0KCgkJaWYgKCBwYXJzZWQuYXV0aCApIHsKCQkJb3B0aW9ucy5hdXRoID0gcGFyc2VkLmF1dGg7CgkJfQoKCQl0aGlzLl9zZW5kID0gdHJ1ZTsKCQlkaXNwYXRjaC5jYWxsKCB0aGlzLCAicmVhZHlzdGF0ZWNoYW5nZSIgKTsKCgkJb2JqID0gcGFyc2VkLnByb3RvY29sID09PSAiaHR0cDoiID8gaHR0cCA6IGh0dHBzOwoKCQlyZXF1ZXN0ID0gb2JqLnJlcXVlc3QoIG9wdGlvbnMsIGZ1bmN0aW9uICggYXJnICkgewoJCQlzdWNjZXNzLmNhbGwoIHNlbGYsIGFyZyApOwoJCX0gKS5vbiggImVycm9yIiwgZnVuY3Rpb24gKCBlICkgewoJCQlmYWlsdXJlLmNhbGwoIHNlbGYsIGUgKTsKCQl9ICk7CgoJCWRhdGEgPT09IG51bGwgPyByZXF1ZXN0LnNldFNvY2tldEtlZXBBbGl2ZSggdHJ1ZSApIDogcmVxdWVzdC53cml0ZSggZGF0YSwgInV0ZjgiICk7CgkJdGhpcy5fcmVxdWVzdCA9IHJlcXVlc3Q7CgkJcmVxdWVzdC5lbmQoKTsKCgkJZGlzcGF0Y2guY2FsbCggdGhpcywgImxvYWRzdGFydCIgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogU2V0cyBhIHJlcXVlc3QgaGVhZGVyIG9mIGFuIFhNTEh0dHBSZXF1ZXN0IGluc3RhbmNlCgkgKgoJICogQG1ldGhvZCBzZXRSZXF1ZXN0SGVhZGVyCgkgKiBAbWVtYmVyT2YgWE1MSHR0cFJlcXVlc3QKCSAqIEBwYXJhbSB7U3RyaW5nfSBoZWFkZXIgSFRUUCBoZWFkZXIKCSAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSAgSGVhZGVyIHZhbHVlCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgIFhNTEh0dHBSZXF1ZXN0IGluc3RhbmNlCgkgKi8KCVhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5zZXRSZXF1ZXN0SGVhZGVyID0gZnVuY3Rpb24gKCBoZWFkZXIsIHZhbHVlICkgewoJCWlmICggdGhpcy5yZWFkeVN0YXRlICE9PSBPUEVORUQgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuaW52YWxpZFN0YXRlTm90VXNhYmxlICk7CgkJfQoJCWVsc2UgaWYgKCB0aGlzLl9zZW5kICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRTdGF0ZU5vdFNlbmRpbmcgKTsKCQl9CgoJCXRoaXMuX2hlYWRlcnNbaGVhZGVyLnRvTG93ZXJDYXNlKCldID0gdmFsdWU7CgoJCXJldHVybiB0aGlzOwoJfTsKCglyZXR1cm4gWE1MSHR0cFJlcXVlc3Q7Cn0KCi8qKgogKiBAbmFtZXNwYWNlIHhtbAogKiBAcHJpdmF0ZQogKi8KdmFyIHhtbCA9IHsKCS8qKgoJICogUmV0dXJucyBYTUwgKERvY3VtZW50KSBPYmplY3QgZnJvbSBhIFN0cmluZwoJICoKCSAqIEBtZXRob2QgZGVjb2RlCgkgKiBAbWVtYmVyT2YgeG1sCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBYTUwgU3RyaW5nCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBYTUwgT2JqZWN0IG9yIHVuZGVmaW5lZAoJICovCglkZWNvZGUgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQlpZiAoIHR5cGVvZiBhcmcgIT0gInN0cmluZyIgfHwgc3RyaW5nLmlzRW1wdHkoIGFyZyApICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCQl9CgoJCXJldHVybiBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKCBhcmcsICJ0ZXh0L3htbCIgKTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIFhNTCBTdHJpbmcgZnJvbSBhbiBPYmplY3Qgb3IgQXJyYXkKCSAqCgkgKiBAbWV0aG9kIGVuY29kZQoJICogQG1lbWJlck9mIHhtbAoJICogQHBhcmFtICB7TWl4ZWR9IGFyZyBPYmplY3Qgb3IgQXJyYXkgdG8gY2FzdCB0byBYTUwgU3RyaW5nCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgIFhNTCBTdHJpbmcgb3IgdW5kZWZpbmVkCgkgKi8KCWVuY29kZSA6IGZ1bmN0aW9uICggYXJnLCB3cmFwICkgewoJCXRyeSB7CgkJCWlmICggYXJnID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCQkJfQoKCQkJd3JhcCAgICA9ICggd3JhcCAhPT0gZmFsc2UgKTsKCQkJdmFyIHggICA9IHdyYXAgPyAiPHhtbD4iIDogIiIsCgkJCSAgICB0b3AgPSAoIGFyZ3VtZW50c1syXSAhPT0gZmFsc2UgKSwKCQkJICAgIG5vZGU7CgoJCQkvKioKCQkJICogRW5jb2RlcyBhIHZhbHVlIGFzIGEgbm9kZQoJCQkgKgoJCQkgKiBAbWV0aG9kIG5vZGUKCQkJICogQG1lbWJlck9mIHhtbC5lbmNvZGUKCQkJICogQHByaXZhdGUKCQkJICogQHBhcmFtICB7U3RyaW5nfSBuYW1lICBOb2RlIG5hbWUKCQkJICogQHBhcmFtICB7U3RyaW5nfSB2YWx1ZSBOb2RlIHZhbHVlCgkJCSAqIEByZXR1cm4ge1N0cmluZ30gICAgICAgTm9kZQoJCQkgKi8KCQkJbm9kZSA9IGZ1bmN0aW9uICggbmFtZSwgdmFsdWUgKSB7CgkJCQl2YXIgb3V0cHV0ID0gIjxuPnY8L24+IjsKCgkJCQlvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSggInYiLCAoIHJlZ2V4LmNkYXRhLnRlc3QoIHZhbHVlICkgPyAiPCFbQ0RBVEFbIiArIHZhbHVlICsgIl1dPiIgOiB2YWx1ZSApICk7CgkJCQlyZXR1cm4gb3V0cHV0LnJlcGxhY2UoLzwoXC8pP24+L2csICI8JDEiICsgbmFtZSArICI+Iik7CgkJCX07CgoJCQlpZiAoIGFyZyAhPT0gbnVsbCAmJiBhcmcueG1sICkgewoJCQkJYXJnID0gYXJnLnhtbDsKCQkJfQoKCQkJaWYgKCBhcmcgaW5zdGFuY2VvZiBEb2N1bWVudCApIHsKCQkJCWFyZyA9ICggbmV3IFhNTFNlcmlhbGl6ZXIoKSApLnNlcmlhbGl6ZVRvU3RyaW5nKCBhcmcgKTsKCQkJfQoKCQkJaWYgKCByZWdleC5ib29sZWFuX251bWJlcl9zdHJpbmcudGVzdCggdHlwZW9mIGFyZyApICkgewoJCQkJeCArPSBub2RlKCAiaXRlbSIsIGFyZyApOwoJCQl9CgkJCWVsc2UgaWYgKCB0eXBlb2YgYXJnID09ICJvYmplY3QiICkgewoJCQkJdXRpbGl0eS5pdGVyYXRlKCBhcmcsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCQl4ICs9IHhtbC5lbmNvZGUoIHYsICggdHlwZW9mIHYgPT0gIm9iamVjdCIgKSwgZmFsc2UgKS5yZXBsYWNlKCAvaXRlbXx4bWwvZywgaXNOYU4oIGsgKSA/IGsgOiAiaXRlbSIgKTsKCQkJCX0gKTsKCQkJfQoKCQkJeCArPSB3cmFwID8gIjwveG1sPiIgOiAiIjsKCgkJCWlmICggdG9wICkgewoJCQkJeCA9ICI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJVVEY4XCI/PiIgKyB4OwoJCQl9CgoJCQlyZXR1cm4geDsKCQl9CgkJY2F0Y2ggKCBlICkgewoJCQl1dGlsaXR5LmVycm9yKCBlLCBhcmd1bWVudHMsIHRoaXMgKTsKCgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoJfSwKCgkvKioKCSAqIFZhbGlkYXRlcyBgYXJnYCBpcyBYTUwKCSAqCgkgKiBAbWV0aG9kIHZhbGlkCgkgKiBAbWVtYmVyT2YgeG1sCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBTdHJpbmcgdG8gdmFsaWRhdGUKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgIGB0cnVlYCBpZiB2YWxpZCBYTUwKCSAqLwoJdmFsaWQgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQlyZXR1cm4gKCB4bWwuZGVjb2RlKCBhcmcgKS5nZXRFbGVtZW50c0J5VGFnTmFtZSggInBhcnNlcmVycm9yIiApLmxlbmd0aCA9PT0gMCApOwoJfQp9OwoKLyoqCiAqIEJvb3RzdHJhcHMgZW52aXJvbm1lbnQKICoKICogQG1ldGhvZCBib290c3RyYXAKICogQHByaXZhdGUKICogQHJldHVybiB7VW5kZWZpbmVkfSB1bmRlZmluZWQKICovCmZ1bmN0aW9uIGJvb3RzdHJhcCAoKSB7CgkvLyBTZWNvbmQgcGhhc2UKCWZ1bmN0aW9uIGluaXQgKCkgewoJCVRJTUUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCgkJLy8gQ2FjaGUgZ2FyYmFnZSBjb2xsZWN0b3IgKGV2ZXJ5IG1pbnV0ZSkKCQl1dGlsaXR5LnJlcGVhdCggZnVuY3Rpb24gKCkgewoJCQljYWNoZS5jbGVhbigpOwoJCX0sIDYwMDAwLCAiY2FjaGVHYXJiYWdlQ29sbGVjdG9yIiApOwoJfQoKCS8vIFJlcGVhdGluZyBmdW5jdGlvbiB0byBjYWxsIGluaXQoKQoJZnVuY3Rpb24gZm4gKCkgewoJCWlmICggcmVnZXguY29tcGxldGVfbG9hZGVkLnRlc3QoIGRvY3VtZW50LnJlYWR5U3RhdGUgKSApIHsKCQkJaW5pdCgpOwoKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0KCgkvLyBEZXNjcmliaW5nIHRoZSBDbGllbnQKCWlmICggIXNlcnZlciApIHsKCQljbGllbnQudmVyc2lvbiA9IGNsaWVudC52ZXJzaW9uKCk7CgoJCS8vIElFOCBhbmQgb2xkZXIgaXMgbm90IHN1cHBvcnRlZAoJCWlmICggY2xpZW50LmllICYmIGNsaWVudC52ZXJzaW9uIDwgOSApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC51cGdyYWRlICk7CgkJfQoKCQkvLyBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIHNoaW0gZm9yIElFOQoJCWlmICggRWxlbWVudC5wcm90b3R5cGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9PT0gdW5kZWZpbmVkICkgewoJCQlFbGVtZW50LnByb3RvdHlwZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lID0gZnVuY3Rpb24gKCBhcmcgKSB7CgkJCQlyZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCggIi4iICsgYXJnICk7CgkJCX07CgkJfQoKCQkvLyBjbGFzc0xpc3Qgc2hpbSBmb3IgSUU5CgkJaWYgKCAhZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsYXNzTGlzdCApIHsKCQkJKCBmdW5jdGlvbiAoIHZpZXcgKSB7CgkJCQl2YXIgQ2xhc3NMaXN0LCBnZXR0ZXIsIHByb3RvLCB0YXJnZXQsIGRlc2NyaXB0b3I7CgoJCQkJaWYgKCAhKCAiSFRNTEVsZW1lbnQiIGluIHZpZXcgKSAmJiAhKCAiRWxlbWVudCIgaW4gdmlldyApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlDbGFzc0xpc3QgPSBmdW5jdGlvbiAoIG9iaiApIHsKCQkJCQl2YXIgY2xhc3NlcyA9IHN0cmluZy5leHBsb2RlKCBvYmouY2xhc3NOYW1lLCAiICIgKSwKCQkJCQkgICAgc2VsZiAgICA9IHRoaXM7CgoJCQkJCWFycmF5LmVhY2goIGNsYXNzZXMsIGZ1bmN0aW9uICggaSApIHsKCQkJCQkJc2VsZi5wdXNoKCBpICk7CgkJCQkJfSApOwoKCQkJCQl0aGlzLnVwZGF0ZUNsYXNzTmFtZSA9IGZ1bmN0aW9uICgpIHsKCQkJCQkJb2JqLmNsYXNzTmFtZSA9IHRoaXMuam9pbiggIiAiICk7CgkJCQkJfTsKCQkJCX07CgoJCQkJZ2V0dGVyID0gZnVuY3Rpb24gKCkgewoJCQkJCXJldHVybiBuZXcgQ2xhc3NMaXN0KCB0aGlzICk7CgkJCQl9OwoKCQkJCXByb3RvICA9IENsYXNzTGlzdC5wcm90b3R5cGUgPSBbXTsKCQkJCXRhcmdldCA9ICggdmlldy5IVE1MRWxlbWVudCB8fCB2aWV3LkVsZW1lbnQgKS5wcm90b3R5cGU7CgoJCQkJcHJvdG8uYWRkID0gZnVuY3Rpb24gKCBhcmcgKSB7CgkJCQkJaWYgKCAhYXJyYXkuY29udGFpbnMoIHRoaXMsIGFyZyApICkgewoJCQkJCQl0aGlzLnB1c2goIGFyZyApOwoJCQkJCQl0aGlzLnVwZGF0ZUNsYXNzTmFtZSgpOwoJCQkJCX0KCQkJCX07CgoJCQkJcHJvdG8uY29udGFpbnMgPSBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCQlyZXR1cm4gYXJyYXkuY29udGFpbnMoIHRoaXMsIGFyZyApOwoJCQkJfTsKCgkJCQlwcm90by5yZW1vdmUgPSBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCQlpZiAoIGFycmF5LmNvbnRhaW5zKCB0aGlzLCBhcmcgKSApIHsKCQkJCQkJYXJyYXkucmVtb3ZlKCB0aGlzLCBhcmcgKTsKCQkJCQkJdGhpcy51cGRhdGVDbGFzc05hbWUoKTsKCQkJCQl9CgkJCQl9OwoKCQkJCXByb3RvLnRvZ2dsZSA9IGZ1bmN0aW9uICggYXJnICkgewoJCQkJCWFycmF5W2FycmF5LmNvbnRhaW5zKCB0aGlzLCBhcmcgKSA/ICJyZW1vdmUiIDogImFkZCJdKCB0aGlzLCBhcmcgKTsKCQkJCQl0aGlzLnVwZGF0ZUNsYXNzTmFtZSgpOwoJCQkJfTsKCgkJCQlpZiAoIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSApIHsKCQkJCQlkZXNjcmlwdG9yID0gewoJCQkJCQlnZXQgICAgICAgICAgOiBnZXR0ZXIsCgkJCQkJCWVudW1lcmFibGUgICA6IHRydWUsCgkJCQkJCWNvbmZpZ3VyYWJsZSA6IHRydWUKCQkJCQl9OwoKCQkJCQlPYmplY3QuZGVmaW5lUHJvcGVydHkoIHRhcmdldCwgImNsYXNzTGlzdCIsIGRlc2NyaXB0b3IgKTsKCQkJCX0KCQkJCWVsc2UgaWYgKCBPYmplY3QucHJvdG90eXBlLl9fZGVmaW5lR2V0dGVyX18pIHsKCQkJCQl0YXJnZXQuX19kZWZpbmVHZXR0ZXJfXyggImNsYXNzTGlzdCIsIGdldHRlciApOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJdGhyb3cgbmV3IEVycm9yKCAiQ291bGQgbm90IGNyZWF0ZSBjbGFzc0xpc3Qgc2hpbSIgKTsKCQkJCX0KCQkJfSApKCBnbG9iYWwgKTsKCQl9Cgl9CgllbHNlIHsKCQkvLyBYSFIgc2hpbQoJCVhNTEh0dHBSZXF1ZXN0ID0geGhyKCk7Cgl9CgoJLy8gQ2FjaGluZyBmdW5jdGlvbnMKCWhhcyAgID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCXNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKCS8vIERhdGFTdG9yZSBXb3JrZXIgInNjcmlwdCIKCWlmICggd2ViV29ya2VyICkgewoJCVdPUktFUiA9IGdsb2JhbC5VUkwuY3JlYXRlT2JqZWN0VVJMKCB1dGlsaXR5LmJsb2IoICJ2YXIgIiArIHN0cmluZy5mcm9tT2JqZWN0KCBhcnJheSwgImFycmF5IiApICsgIiwgIiArIHN0cmluZy5mcm9tT2JqZWN0KCByZWdleCwgInJlZ2V4IiApICsgIiwgIiArIHN0cmluZy5mcm9tT2JqZWN0KCBzdHJpbmcsICJzdHJpbmciICkgKyAiLCAiICsgc3RyaW5nLmZyb21PYmplY3QoIHV0aWxpdHksICJ1dGlsaXR5IiApICsgIjsgb25tZXNzYWdlID0gIiArIHN0b3JlLndvcmtlci50b1N0cmluZygpICsgIjsiICkgKTsKCX0KCgkvLyBTZXR0aW5nIHVwIGB1dGlsaXR5LnJlbmRlcigpYAoJUkVOREVSID0gZ2xvYmFsLnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCBmdW5jdGlvbiAoIGZuICkgewoJCXZhciBvZmZzZXQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIFRJTUU7CgoJCXV0aWxpdHkuZGVmZXIoIGZ1bmN0aW9uICgpIHsKCQkJZm4oIG9mZnNldCApOwoJCX0sIDE2LCBvZmZzZXQgKTsKCX07CgoJLy8gSW5pdGlhbGl6aW5nCglpZiAoIHR5cGVvZiBleHBvcnRzICE9ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiB8fCByZWdleC5jb21wbGV0ZV9sb2FkZWQudGVzdCggZG9jdW1lbnQucmVhZHlTdGF0ZSApICkgewoJCWluaXQoKTsKCX0KCWVsc2UgaWYgKCB0eXBlb2YgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciA9PSAiZnVuY3Rpb24iICkgewoJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJET01Db250ZW50TG9hZGVkIiAsIGZ1bmN0aW9uICgpIHsKCQkJaW5pdCgpOwoJCX0sIGZhbHNlICk7Cgl9CgllbHNlIGlmICggdHlwZW9mIGRvY3VtZW50LmF0dGFjaEV2ZW50ID09ICJmdW5jdGlvbiIgKSB7CgkJZG9jdW1lbnQuYXR0YWNoRXZlbnQoICJvbnJlYWR5c3RhdGVjaGFuZ2UiICwgZm4gKTsKCX0KCWVsc2UgewoJCXV0aWxpdHkucmVwZWF0KCBmbiApOwoJfQp9CgovLyBCb290c3RyYXBwaW5nCmJvb3RzdHJhcCgpOwoKLy8gSW50ZXJmYWNlCnJldHVybiB7CglmaWx0ZXIgIDogZmlsdGVyLmZhY3RvcnksCglsaXN0ICAgIDogbGlzdC5mYWN0b3J5LAoJZ3JpZCAgICA6IGdyaWQuZmFjdG9yeSwKCXN0b3JlICAgOiBzdG9yZS5mYWN0b3J5LAoJdXRpbCAgICA6IHsKCQkkICAgICAgICA6IHV0aWxpdHkuJCwKCQlhcnJheSAgICA6IGFycmF5LAoJCWJhc2UgICAgIDogdXRpbGl0eS5iYXNlLAoJCWNsb25lICAgIDogdXRpbGl0eS5jbG9uZSwKCQljb2VyY2UgICA6IHV0aWxpdHkuY29lcmNlLAoJCWN1cnJ5ICAgIDogdXRpbGl0eS5jdXJyeSwKCQljc3YgICAgICA6IGNzdiwKCQlkZWZlciAgICA6IGRlZmVycmVkLmZhY3RvcnksCgkJZWxlbWVudCAgOiBlbGVtZW50LAoJCWV4dGVuZCAgIDogdXRpbGl0eS5leHRlbmQsCgkJZ2VuSWQgICAgOiB1dGlsaXR5LmdlbklkLAoJCWl0ZXJhdGUgIDogdXRpbGl0eS5pdGVyYXRlLAoJCWpzb24gICAgIDoganNvbiwKCQlqc29ucCAgICA6IGNsaWVudC5qc29ucCwKCQlsb2cgICAgICA6IHV0aWxpdHkubG9nLAoJCWxydSAgICAgIDogbHJ1LmZhY3RvcnksCgkJbWF0aCAgICAgOiBtYXRoLAoJCW1lcmdlICAgIDogdXRpbGl0eS5tZXJnZSwKCQludW1iZXIgICA6IG51bWJlciwKCQlvYnNlcnZlciA6IG9ic2VydmFibGUuZmFjdG9yeSwKCQlwYXJzZSAgICA6IHV0aWxpdHkucGFyc2UsCgkJcGFydGlhbCAgOiB1dGlsaXR5LnBhcnRpYWwsCgkJcHJldmVudCAgOiB1dGlsaXR5LnByZXZlbnQsCgkJcmFjZSAgICAgOiB1dGlsaXR5LnJhY2UsCgkJcmVuZGVyICAgOiB1dGlsaXR5LnJlbmRlciwKCQlyZXBlYXQgICA6IHV0aWxpdHkucmVwZWF0LAoJCXJlcXVlc3QgIDogY2xpZW50LnJlcXVlc3QsCgkJc3RvcCAgICAgOiB1dGlsaXR5LnN0b3AsCgkJc3RyaW5nICAgOiBzdHJpbmcsCgkJdGFyZ2V0ICAgOiB1dGlsaXR5LnRhcmdldCwKCQl1dWlkICAgICA6IHV0aWxpdHkudXVpZCwKCQl3YWxrICAgICA6IHV0aWxpdHkud2FsaywKCQl3aGVuICAgICA6IHV0aWxpdHkud2hlbgoJfSwKCXZlcnNpb24gOiAiMC45LjAiCn07Cn0gKSgpOwoKLy8gTm9kZSwgQU1EICYgd2luZG93IHN1cHBvcnRlZAppZiAoIHR5cGVvZiBleHBvcnRzICE9ICJ1bmRlZmluZWQiICkgewoJbW9kdWxlLmV4cG9ydHMgPSBsaWI7Cn0KZWxzZSBpZiAoIHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiApIHsKCWRlZmluZSggZnVuY3Rpb24gKCkgewoJCXJldHVybiBsaWI7Cgl9ICk7Cn0KZWxzZSB7CglnbG9iYWwua2VpZ2FpID0gbGliOwp9Cn0gKSggdGhpcyApOwo=",
                "body": "LyoqCiAqIExpZ2h0d2VpZ2h0IGRhdGEgc3RvcmUgbGlicmFyeSwgd2l0aCBhIHV0aWxpdHkgYmVsdAogKgogKiBAYXV0aG9yIEphc29uIE11bGxpZ2FuIDxqYXNvbi5tdWxsaWdhbkBhdm9pZHdvcmsuY29tPgogKiBAY29weXJpZ2h0IDIwMTQgSmFzb24gTXVsbGlnYW4KICogQGxpY2Vuc2UgQlNELTMgPGh0dHBzOi8vcmF3LmdpdGh1Yi5jb20vYXZvaWR3b3JrL2tlaWdhaS9tYXN0ZXIvTElDRU5TRT4KICogQGxpbmsgaHR0cDovL2tlaWdhaS5pbwogKiBAbW9kdWxlIGtlaWdhaQogKiBAdmVyc2lvbiAwLjkuMAogKi8KKCBmdW5jdGlvbiAoIGdsb2JhbCApIHsKCnZhciBkb2N1bWVudCAgPSBnbG9iYWwuZG9jdW1lbnQsCiAgICBsb2NhdGlvbiAgPSBnbG9iYWwubG9jYXRpb24sCiAgICBuYXZpZ2F0b3IgPSBnbG9iYWwubmF2aWdhdG9yLAogICAgc2VydmVyICAgID0gdHlwZW9mIHByb2Nlc3MgIT0gInVuZGVmaW5lZCIsCiAgICB3ZWJXb3JrZXIgPSB0eXBlb2YgQmxvYiAhPSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgV29ya2VyICE9ICJ1bmRlZmluZWQiLAogICAgTUFYICAgICAgID0gMTAsCiAgICBWRVJTSU9OUyAgPSAxMDAsCiAgICBDQUNIRSAgICAgPSA1MDAsCiAgICBFVkVOVFMgICAgPSBbInJlYWR5c3RhdGVjaGFuZ2UiLCAiYWJvcnQiLCAibG9hZCIsICJsb2Fkc3RhcnQiLCAibG9hZGVuZCIsICJlcnJvciIsICJwcm9ncmVzcyIsICJ0aW1lb3V0Il0sCiAgICBmb3JtYXQsIGh0dHAsIGh0dHBzLCBsaWIsIG1vbmdvZGIsIHVybCwgUkVOREVSLCBUSU1FLCBXT1JLRVI7CgppZiAoIHNlcnZlciApIHsKCXVybCAgICAgPSByZXF1aXJlKCAidXJsIiApOwoJaHR0cCAgICA9IHJlcXVpcmUoICJodHRwIiApOwoJaHR0cHMgICA9IHJlcXVpcmUoICJodHRwcyIgKTsKCW1vbmdvZGIgPSByZXF1aXJlKCAibW9uZ29kYiIgKS5Nb25nb0NsaWVudDsKCWZvcm1hdCAgPSByZXF1aXJlKCAidXRpbCIgKS5mb3JtYXQ7CgoJaWYgKCB0eXBlb2YgUHJvbWlzZSA9PSAidW5kZWZpbmVkIiApIHsKCQlQcm9taXNlID0gcmVxdWlyZSggImVzNi1wcm9taXNlIiApLlByb21pc2U7Cgl9CgoJaWYgKCB0eXBlb2YgU3RvcmFnZSA9PSAidW5kZWZpbmVkIiApIHsKCQlsb2NhbFN0b3JhZ2UgPSByZXF1aXJlKCAibG9jYWxTdG9yYWdlIiApOwoJfQoKCWlmICggdHlwZW9mIFhNTEh0dHBSZXF1ZXN0ID09ICJ1bmRlZmluZWQiICkgewoJCVhNTEh0dHBSZXF1ZXN0ID0gbnVsbDsKCX0KCglpZiAoIHR5cGVvZiBidG9hID09ICJ1bmRlZmluZWQiICkgewoJCWJ0b2EgPSByZXF1aXJlKCAiYnRvYSIgKTsKCX0KfQplbHNlIGlmICggdHlwZW9mIEJ1ZmZlciA9PSAidW5kZWZpbmVkIiApIHsKCUJ1ZmZlciA9IGZ1bmN0aW9uICgpIHt9Owp9CgpsaWIgPSAoIGZ1bmN0aW9uICgpIHsKInVzZSBzdHJpY3QiOwoKdmFyIGV4dGVybmFsLCBoYXMsIHNsaWNlOwoKLyoqCiAqIFJlZ2V4IHBhdHRlcm5zIHVzZWQgdGhyb3VnaCBrZWlnYWkKICoKICogYHVybGAgd2FzIGF1dGhvcmVkIGJ5IERpZWdvIFBlcmluaQogKgogKiBAbmFtZXNwYWNlIHJlZ2V4CiAqIEBwcml2YXRlCiAqIEB0eXBlIHtPYmplY3R9CiAqLwp2YXIgcmVnZXggPSB7CglhZnRlcl9zcGFjZSAgICAgICAgICA6IC9ccysuKi8sCglhbGxvdyAgICAgICAgICAgICAgICA6IC9eYWxsb3ckL2ksCglhbGxvd19jb3JzICAgICAgICAgICA6IC9eYWNjZXNzLWNvbnRyb2wtYWxsb3ctbWV0aG9kcyQvaSwKCWFuZCAgICAgICAgICAgICAgICAgIDogL14mLywKCWFyZ3MgICAgICAgICAgICAgICAgIDogL1woKC4qKVwpLywKCWF1dGggICAgICAgICAgICAgICAgIDogL1wvXC8oLiopXEAvLAoJYm9vbCAgICAgICAgICAgICAgICAgOiAvXih0cnVlfGZhbHNlKT8kLywKCWNhcHMgICAgICAgICAgICAgICAgIDogL1tBLVpdLywKCWNkYXRhICAgICAgICAgICAgICAgIDogL1wmfDx8PnxcInxcJ3xcdHxccnxcbnxcQHxcJC8sCgljaGVja2VkX2Rpc2FibGVkICAgICA6IC9jaGVja2VkfGRpc2FibGVkL2ksCgljb21wbGV0ZV9sb2FkZWQgICAgICA6IC9eKGNvbXBsZXRlfGxvYWRlZCkkL2ksCgljc3ZfcXVvdGUgICAgICAgICAgICA6IC9eXHN8XCJ8XG58LHxccyQvLAoJZGVsICAgICAgICAgICAgICAgICAgOiAvXmRlbC8sCglkb21haW4gICAgICAgICAgICAgICA6IC9eW1x3Li1fXStcLltBLVphLXpdezIsfSQvLAoJZG93biAgICAgICAgICAgICAgICAgOiAvZG93bi8sCgllbmRzbGFzaCAgICAgICAgICAgICA6IC9cLyQvLAoJZW9sX25sICAgICAgICAgICAgICAgOiAvXG4kLywKCWVsZW1lbnRfdXBkYXRlICAgICAgIDogL2lkfGlubmVySFRNTHxpbm5lclRleHR8dGV4dENvbnRlbnR8dHlwZXxzcmMvLAoJZ2V0X2hlYWRlcnMgICAgICAgICAgOiAvXihoZWFkfGdldHxvcHRpb25zKSQvLAoJZ2V0X3JlbW92ZV9zZXQgICAgICAgOiAvZ2V0fHJlbW92ZXxzZXQvLAoJaGFzaCAgICAgICAgICAgICAgICAgOiAvXlwjLywKCWhlYWRlcl9yZXBsYWNlICAgICAgIDogLzouKi8sCgloZWFkZXJfdmFsdWVfcmVwbGFjZSA6IC8uKjpccysvLAoJaHRtbCAgICAgICAgICAgICAgICAgOiAvXjwuKj4kLywKCWh0dHBfYm9keSAgICAgICAgICAgIDogLzIwMHwyMDF8MjAyfDIwM3wyMDYvLAoJaHR0cF9wb3J0cyAgICAgICAgICAgOiAvODB8NDQzLywKCWllICAgICAgICAgICAgICAgICAgIDogL21zaWV8aWUvaSwKCWlwICAgICAgICAgICAgICAgICAgIDogL14oPzooPzoyNVswLTVdfDJbMC00XVswLTldfFswMV0/WzAtOV1bMC05XT8pXC4pezN9KD86MjVbMC01XXwyWzAtNF1bMC05XXxbMDFdP1swLTldWzAtOV0/KSQvLAoJaXNfeG1sICAgICAgICAgICAgICAgOiAvXjxcP3htbC4qXD8+LywKCWpzb25fbWF5YmUgICAgICAgICAgIDogL2pzb258cGxhaW58amF2YXNjcmlwdC8sCglqc29uX3dyYXAgICAgICAgICAgICA6IC9eW1xbXHtdLywKCWtsYXNzICAgICAgICAgICAgICAgIDogL15cLi8sCglubyAgICAgICAgICAgICAgICAgICA6IC9uby1zdG9yZXxuby1jYWNoZS9pLAoJbm90X2RvdG5vdGF0aW9uICAgICAgOiAvLXxccy8sCglub3RfZW5kcG9pbnQgICAgICAgICA6IC8uKlwvLywKCW51bGxfdW5kZWZpbmVkICAgICAgIDogL251bGx8dW5kZWZpbmVkLywKCW51bWJlciAgICAgICAgICAgICAgIDogLyheLT9cZFxkKlwuXGQqJCl8KF4tP1xkXGQqJCl8KF4tP1wuXGRcZCokKXxudW1iZXIvLAoJbnVtYmVyX2Zvcm1hdF8xICAgICAgOiAvLipcLi8sCgludW1iZXJfZm9ybWF0XzIgICAgICA6IC9cLi4qLywKCW51bWJlcl9wcmVzZW50ICAgICAgIDogL1xkezEsfS8sCgludW1iZXJfc3RyaW5nICAgICAgICA6IC9udW1iZXJ8c3RyaW5nL2ksCgludW1iZXJfc3RyaW5nX29iamVjdCA6IC9udW1iZXJ8b2JqZWN0fHN0cmluZy9pLAoJb2JqZWN0X3R5cGUgICAgICAgICAgOiAvXFtvYmplY3QgT2JqZWN0XF0vLAoJcGF0Y2ggICAgICAgICAgICAgICAgOiAvXnBhdGNoJC8sCglwcmltaXRpdmUgICAgICAgICAgICA6IC9eKGJvb2xlYW58ZnVuY3Rpb258bnVtYmVyfHN0cmluZykkLywKCXByaXYgICAgICAgICAgICAgICAgIDogL3ByaXZhdGUvLAoJcHV0X3Bvc3QgICAgICAgICAgICAgOiAvXihwb3N0fHB1dCkkL2ksCglyYWRpb19jaGVja2JveCAgICAgICA6IC9eKHJhZGlvfGNoZWNrYm94KSQvaSwKCXJvb3QgICAgICAgICAgICAgICAgIDogL15cL1teXC9dLywKCXNlbGVjdCAgICAgICAgICAgICAgIDogL3NlbGVjdC9pLAoJc2VsZWN0b3JfaXMgICAgICAgICAgOiAvXjovLAoJc2VsZWN0b3JfY29tcGxleCAgICAgOiAvXHMrfFw+fFwrfFx+fFw6fFxbLywKCXNldF9kZWwgICAgICAgICAgICAgIDogL14oc2V0fGRlbHxkZWxldGUpJC8sCglzcGFjZV9oeXBoZW4gICAgICAgICA6IC9cc3wtLywKCXN0cmluZ19vYmplY3QgICAgICAgIDogL3N0cmluZ3xvYmplY3QvaSwKCXN2ZyAgICAgICAgICAgICAgICAgIDogL3N2Zy8sCgl0b3BfYm90dG9tICAgICAgICAgICA6IC90b3B8Ym90dG9tL2ksCgl1cmwgICAgICAgICAgICAgICAgICA6IC9eKD86KD86aHR0cHM/fGZ0cCk6XC9cLykoPzpcUysoPzo6XFMqKT9AKT8oPzooPyExMCg/OlwuXGR7MSwzfSl7M30pKD8hMTI3KD86XC5cZHsxLDN9KXszfSkoPyExNjlcLjI1NCg/OlwuXGR7MSwzfSl7Mn0pKD8hMTkyXC4xNjgoPzpcLlxkezEsM30pezJ9KSg/ITE3MlwuKD86MVs2LTldfDJcZHwzWzAtMV0pKD86XC5cZHsxLDN9KXsyfSkoPzpbMS05XVxkP3wxXGRcZHwyWzAxXVxkfDIyWzAtM10pKD86XC4oPzoxP1xkezEsMn18MlswLTRdXGR8MjVbMC01XSkpezJ9KD86XC4oPzpbMS05XVxkP3wxXGRcZHwyWzAtNF1cZHwyNVswLTRdKSl8KD86KD86W2Etelx1MDBhMS1cdWZmZmYwLTldKy0/KSpbYS16XHUwMGExLVx1ZmZmZjAtOV0rKSg/OlwuKD86W2Etelx1MDBhMS1cdWZmZmYwLTldKy0/KSpbYS16XHUwMGExLVx1ZmZmZjAtOV0rKSooPzpcLig/OlthLXpcdTAwYTEtXHVmZmZmXXsyLH0pKSkoPzo6XGR7Miw1fSk/KD86XC9bXlxzXSopPyQvaSwKCXdvcmQgICAgICAgICAgICAgICAgIDogL15cdyskLywKCXhkb21haW5yZXF1ZXN0ICAgICAgIDogL14oZ2V0fHBvc3QpJC9pLAoJeG1sICAgICAgICAgICAgICAgICAgOiAveG1sL2kKfTsKCi8qKgogKiBAbmFtZXNwYWNlIGxydQogKi8KdmFyIGxydSA9IHsKCS8qKgoJICogTFJVIGZhY3RvcnkKCSAqCgkgKiBAbWV0aG9kIGZhY3RvcnkKCSAqIEBtZW1iZXJPZiBscnUKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5MUlV9CgkgKiBAZXhhbXBsZQoJICogdmFyIGxydSA9IGtlaWdhaS51dGlsLmxydSggNTAgKTsKCSAqLwoJIGZhY3RvcnkgOiBmdW5jdGlvbiAoIG1heCApIHsKCQlyZXR1cm4gbmV3IExSVSggbWF4ICk7Cgl9Cn07CgovKioKICogQ3JlYXRlcyBhIG5ldyBMZWFzdCBSZWNlbnRseSBVc2VkIGNhY2hlCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpCiAqIEBwYXJhbSAge051bWJlcn0gbWF4IFtPcHRpb25hbF0gTWF4IHNpemUgb2YgY2FjaGUsIGRlZmF1bHQgaXMgMTAwMAogKiBAZXhhbXBsZQogKiB2YXIgbHJ1ID0ga2VpZ2FpLnV0aWwubHJ1KCA1MCApOwogKi8KZnVuY3Rpb24gTFJVICggbWF4ICkgewoJdGhpcy5jYWNoZSAgPSB7fTsKCXRoaXMubWF4ICAgID0gbWF4IHx8IDEwMDA7Cgl0aGlzLmZpcnN0ICA9IG51bGw7Cgl0aGlzLmxhc3QgICA9IG51bGw7Cgl0aGlzLmxlbmd0aCA9IDA7Cn0KCi8qKgogKiBTZXR0aW5nIGNvbnN0cnVjdG9yIGxvb3AKICoKICogQG1ldGhvZCBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpLkxSVQogKiBAdHlwZSB7RnVuY3Rpb259CiAqIEBwcml2YXRlCiAqLwpMUlUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gTFJVOwoKLyoqCiAqIEV2aWN0cyB0aGUgbGVhc3QgcmVjZW50bHkgdXNlZCBpdGVtIGZyb20gY2FjaGUKICoKICogQG1ldGhvZCBldmljdAogKiBAbWVtYmVyT2Yga2VpZ2FpLkxSVQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuTFJVfQogKiBAZXhhbXBsZQogKiBscnUuZXZpY3QoKTsKICovCkxSVS5wcm90b3R5cGUuZXZpY3QgPSBmdW5jdGlvbiAoKSB7CglpZiAoIHRoaXMubGFzdCAhPT0gbnVsbCApIHsKCQl0aGlzLnJlbW92ZSggdGhpcy5sYXN0ICk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogR2V0cyBjYWNoZWQgaXRlbSBhbmQgbW92ZXMgaXQgdG8gdGhlIGZyb250CiAqCiAqIEBtZXRob2QgZ2V0CiAqIEBtZW1iZXJPZiBrZWlnYWkuTFJVCiAqIEBwYXJhbSAge1N0cmluZ30ga2V5IEl0ZW0ga2V5CiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5MUlVJdGVtfQogKiBAZXhhbXBsZQogKiB2YXIgaXRlbSA9IGxydS5nZXQoICJrZXkiICk7CiAqLwpMUlUucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uICgga2V5ICkgewoJdmFyIGl0ZW0gPSB0aGlzLmNhY2hlW2tleV07CgoJaWYgKCBpdGVtID09PSB1bmRlZmluZWQgKSB7CgkJcmV0dXJuOwoJfQoKCXRoaXMuc2V0KCBrZXksIGl0ZW0udmFsdWUgKTsKCglyZXR1cm4gaXRlbS52YWx1ZTsKfTsKCi8qKgogKiBSZW1vdmVzIGl0ZW0gZnJvbSBjYWNoZQogKgogKiBAbWV0aG9kIHJlbW92ZQogKiBAbWVtYmVyT2Yga2VpZ2FpLkxSVQogKiBAcGFyYW0gIHtTdHJpbmd9IGtleSBJdGVtIGtleQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuTFJVSXRlbX0KICogQGV4YW1wbGUKICogbHJ1LnJlbW92ZSggImtleSIgKTsKICovCkxSVS5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24gKCBrZXkgKSB7Cgl2YXIgaXRlbSA9IHRoaXMuY2FjaGVbIGtleSBdOwoKCWlmICggaXRlbSApIHsKCQlkZWxldGUgdGhpcy5jYWNoZVtrZXldOwoKCQl0aGlzLmxlbmd0aC0tOwoKCQlpZiAoIGl0ZW0ucHJldmlvdXMgIT09IG51bGwgKSB7CgkJCXRoaXMuY2FjaGVbaXRlbS5wcmV2aW91c10ubmV4dCA9IGl0ZW0ubmV4dDsKCQl9CgoJCWlmICggaXRlbS5uZXh0ICE9PSBudWxsICkgewoJCQl0aGlzLmNhY2hlW2l0ZW0ubmV4dF0ucHJldmlvdXMgPSBpdGVtLnByZXZpb3VzOwoJCX0KCgkJaWYgKCB0aGlzLmZpcnN0ID09PSBrZXkgKSB7CgkJCXRoaXMuZmlyc3QgPSBpdGVtLnByZXZpb3VzOwoJCX0KCgkJaWYgKCB0aGlzLmxhc3QgPT09IGtleSApIHsKCQkJdGhpcy5sYXN0ID0gaXRlbS5uZXh0OwoJCX0KCX0KCglyZXR1cm4gaXRlbTsKfTsKCi8qKgogKiBTZXRzIGl0ZW0gaW4gY2FjaGUgYXMgYGZpcnN0YAogKgogKiBAbWV0aG9kIHNldAogKiBAbWVtYmVyT2Yga2VpZ2FpLkxSVQogKiBAcGFyYW0gIHtTdHJpbmd9IGtleSAgIEl0ZW0ga2V5CiAqIEBwYXJhbSAge01peGVkfSAgdmFsdWUgSXRlbSB2YWx1ZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuTFJVfQogKiBAZXhhbXBsZQogKiBscnUuc2V0KCAia2V5Iiwge3g6IHRydWV9ICk7CiAqLwpMUlUucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uICgga2V5LCB2YWx1ZSApIHsKCXZhciBpdGVtID0gdGhpcy5yZW1vdmUoIGtleSApOwoKCWlmICggaXRlbSA9PT0gdW5kZWZpbmVkICkgewoJCWl0ZW0gPSBuZXcgTFJVSXRlbSggdmFsdWUgKTsKCX0KCWVsc2UgewoJCWl0ZW0udmFsdWUgPSB2YWx1ZTsKCX0KCglpdGVtLm5leHQgICAgICAgPSBudWxsOwoJaXRlbS5wcmV2aW91cyAgID0gdGhpcy5maXJzdDsKCXRoaXMuY2FjaGVba2V5XSA9IGl0ZW07CgoJaWYgKCB0aGlzLmZpcnN0ICE9PSBudWxsICkgewoJCXRoaXMuY2FjaGVbdGhpcy5maXJzdF0ubmV4dCA9IGtleTsKCX0KCgl0aGlzLmZpcnN0ID0ga2V5OwoKCWlmICggdGhpcy5sYXN0ID09PSBudWxsICkgewoJCXRoaXMubGFzdCA9IGtleTsKCX0KCglpZiAoICsrdGhpcy5sZW5ndGggPiB0aGlzLm1heCApIHsKCQl0aGlzLmV2aWN0KCk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogQ3JlYXRlcyBhIG5ldyBMUlVJdGVtCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpCiAqIEBwYXJhbSB7TWl4ZWR9IHZhbHVlIEl0ZW0gdmFsdWUKICogQHByaXZhdGUKICovCmZ1bmN0aW9uIExSVUl0ZW0gKCB2YWx1ZSApIHsKCXRoaXMubmV4dCAgICAgPSBudWxsOwoJdGhpcy5wcmV2aW91cyA9IG51bGw7Cgl0aGlzLnZhbHVlICAgID0gdmFsdWU7Cn0KCi8qKgogKiBTZXR0aW5nIGNvbnN0cnVjdG9yIGxvb3AKICoKICogQG1ldGhvZCBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpLkxSVUl0ZW0KICogQHR5cGUge0Z1bmN0aW9ufQogKi8KTFJVSXRlbS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBMUlVJdGVtOwoKLyoqCiAqIEBuYW1lc3BhY2Ugb2JzZXJ2YWJsZQogKi8KdmFyIG9ic2VydmFibGUgPSB7CgkvKioKCSAqIE9ic2VydmFibGUgZmFjdG9yeQoJICoKCSAqIEBtZXRob2QgZmFjdG9yeQoJICogQG1lbWJlck9mIG9ic2VydmFibGUKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5PYnNlcnZhYmxlfQoJICogQGV4YW1wbGUKCSAqIHZhciBvYnNlcnZlciA9IGtlaWdhaS51dGlsLm9ic2VydmVyKCA1MCApOwoJICovCgkgZmFjdG9yeSA6IGZ1bmN0aW9uICggYXJnICkgewoJCXJldHVybiBuZXcgT2JzZXJ2YWJsZSggYXJnICk7Cgl9Cn07CgovKioKICogQ3JlYXRlcyBhIG5ldyBPYnNlcnZhYmxlCiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpCiAqIEBwYXJhbSAge051bWJlcn0gYXJnIE1heGltdW0gbGlzdGVuZXJzLCBkZWZhdWx0IGlzIDEwCiAqIEBleGFtcGxlCiAqIHZhciBvYnNlcnZlciA9IGtlaWdhaS51dGlsLm9ic2VydmVyKCA1MCApOwogKi8KZnVuY3Rpb24gT2JzZXJ2YWJsZSAoIGFyZyApIHsKCXRoaXMubGltaXQgICAgID0gYXJnIHx8IE1BWDsKCXRoaXMubGlzdGVuZXJzID0ge307Cgl0aGlzLmhvb2tzICAgICA9IHt9Owp9CgovKioKICogU2V0dGluZyBjb25zdHJ1Y3RvciBsb29wCiAqCiAqIEBtZXRob2QgY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaS5PYnNlcnZhYmxlCiAqIEB0eXBlIHtGdW5jdGlvbn0KICogQHByaXZhdGUKICovCk9ic2VydmFibGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gT2JzZXJ2YWJsZTsKCi8qKgogKiBEaXNwYXRjaGVzIGFuIGV2ZW50LCB3aXRoIG9wdGlvbmFsIGFyZ3VtZW50cwogKgogKiBAbWV0aG9kIGRpc3BhdGNoCiAqIEBtZW1iZXJPZiBrZWlnYWkuT2JzZXJ2YWJsZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuT2JzZXJ2YWJsZX0KICogQGV4YW1wbGUKICogb2JzZXJ2ZXIuZGlzcGF0Y2goICJldmVudCIsIC4uLiApOwogKi8KT2JzZXJ2YWJsZS5wcm90b3R5cGUuZGlzcGF0Y2ggPSBmdW5jdGlvbiAoKSB7Cgl2YXIgYXJncyA9IGFycmF5LmNhc3QoIGFyZ3VtZW50cyApLAoJICAgIGV2ICAgPSBhcmdzLnNoaWZ0KCk7CgoJaWYgKCBldiAmJiB0aGlzLmxpc3RlbmVyc1tldl0gKSB7CgkJdXRpbGl0eS5pdGVyYXRlKCB0aGlzLmxpc3RlbmVyc1tldl0sIGZ1bmN0aW9uICggaSApIHsKCQkJaS5oYW5kbGVyLmFwcGx5KCBpLnNjb3BlLCBhcmdzICk7CgkJfSApOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEhvb2tzIGludG8gYHRhcmdldGAgZm9yIGEgRE9NIGV2ZW50CiAqCiAqIEBtZXRob2QgaG9vawogKiBAbWVtYmVyT2Yga2VpZ2FpLk9ic2VydmFibGUKICogQHBhcmFtICB7T2JqZWN0fSB0YXJnZXQgRWxlbWVudAogKiBAcGFyYW0gIHtTdHJpbmd9IGV2ICAgICBFdmVudAogKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgICBFbGVtZW50CiAqIEBleGFtcGxlCiAqIG9ic2VydmVyLmhvb2soIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICJhIiApLCAiY2xpY2siICk7CiAqLwpPYnNlcnZhYmxlLnByb3RvdHlwZS5ob29rID0gZnVuY3Rpb24gKCB0YXJnZXQsIGV2ICkgewoJdmFyIHNlbGYgPSB0aGlzOwoKCWlmICggdHlwZW9mIHRhcmdldC5hZGRFdmVudExpc3RlbmVyICE9ICJmdW5jdGlvbiIgKSB7CgkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7Cgl9CgoJdXRpbGl0eS5nZW5JZCggdGFyZ2V0ICk7CgoJdGhpcy5ob29rc1t0YXJnZXQuaWRdID0gZnVuY3Rpb24gKCBhcmcgKSB7CgkJc2VsZi5kaXNwYXRjaCggZXYsIGFyZyApOwoJfTsKCgl0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lciggZXYsIHRoaXMuaG9va3NbdGFyZ2V0LmlkXSwgZmFsc2UgKTsKCglyZXR1cm4gdGFyZ2V0Owp9OwoKLyoqCiAqIFJlbW92ZXMgYWxsLCBvciBhIHNwZWNpZmljIGxpc3RlbmVyIGZvciBhbiBldmVudAogKgogKiBAbWV0aG9kIG9mZgogKiBAbWVtYmVyT2Yga2VpZ2FpLk9ic2VydmFibGUKICogQHBhcmFtIHtTdHJpbmd9IGV2IEV2ZW50IG5hbWUKICogQHBhcmFtIHtTdHJpbmd9IGlkIFtPcHRpb25hbF0gTGlzdGVuZXIgSUQKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLk9ic2VydmFibGV9CiAqIEBleGFtcGxlCiAqIG9ic2VydmVyLm9mZiggImNsaWNrIiwgIm15SG9vayIgKTsKICovCk9ic2VydmFibGUucHJvdG90eXBlLm9mZiA9IGZ1bmN0aW9uICggZXYsIGlkICkgewoJaWYgKCB0aGlzLmxpc3RlbmVyc1tldl0gKSB7CgkJaWYgKCBpZCApIHsKCQkJZGVsZXRlIHRoaXMubGlzdGVuZXJzW2V2XVtpZF07CgkJfQoJCWVsc2UgewoJCQlkZWxldGUgdGhpcy5saXN0ZW5lcnNbZXZdOwoJCX0KCX0KCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBBZGRzIGEgbGlzdGVuZXIgZm9yIGFuIGV2ZW50CiAqCiAqIEBtZXRob2Qgb24KICogQG1lbWJlck9mIGtlaWdhaS5PYnNlcnZhYmxlCiAqIEBwYXJhbSAge1N0cmluZ30gICBldiAgICAgIEV2ZW50IG5hbWUKICogQHBhcmFtICB7RnVuY3Rpb259IGhhbmRsZXIgSGFuZGxlcgogKiBAcGFyYW0gIHtTdHJpbmd9ICAgaWQgICAgICBbT3B0aW9uYWxdIEhhbmRsZXIgSUQKICogQHBhcmFtICB7U3RyaW5nfSAgIHNjb3BlICAgW09wdGlvbmFsXSBIYW5kbGVyIHNjb3BlLCBkZWZhdWx0IGlzIGB0aGlzYAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuT2JzZXJ2YWJsZX0KICogQGV4YW1wbGUKICogb2JzZXJ2ZXIub24oICJjbGljayIsIGZ1bmN0aW9uICggZXYgKSB7CiAqICAgLi4uCiAqIH0sICJteUhvb2siICk7CiAqLwpPYnNlcnZhYmxlLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uICggZXYsIGhhbmRsZXIsIGlkLCBzY29wZSApIHsKCWlkICAgID0gaWQgICAgfHwgdXRpbGl0eS51dWlkKCk7CglzY29wZSA9IHNjb3BlIHx8IHRoaXM7CgoJaWYgKCAhdGhpcy5saXN0ZW5lcnNbZXZdICkgewoJCXRoaXMubGlzdGVuZXJzW2V2XSA9IHt9OwoJfQoKCWlmICggYXJyYXkua2V5cyggdGhpcy5saXN0ZW5lcnNbZXZdICkubGVuZ3RoID49IHRoaXMubGltaXQgKSB7CgkJdGhyb3coIG5ldyBFcnJvciggIlBvc3NpYmxlIG1lbW9yeSBsZWFrLCBtb3JlIHRoYW4gIiArIHRoaXMubGltaXQgKyAiIGxpc3RlbmVycyBmb3IgZXZlbnQ6ICIgKyBldiApICk7Cgl9CgoJdGhpcy5saXN0ZW5lcnNbZXZdW2lkXSA9IHtzY29wZTogc2NvcGUsIGhhbmRsZXI6IGhhbmRsZXJ9OwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEFkZHMgYSBzaG9ydCBsaXZlZCBsaXN0ZW5lciBmb3IgYW4gZXZlbnQKICoKICogQG1ldGhvZCBvbmNlCiAqIEBtZW1iZXJPZiBrZWlnYWkuT2JzZXJ2YWJsZQogKiBAcGFyYW0gIHtTdHJpbmd9ICAgZXYgICAgICBFdmVudCBuYW1lCiAqIEBwYXJhbSAge0Z1bmN0aW9ufSBoYW5kbGVyIEhhbmRsZXIKICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICAgICAgW09wdGlvbmFsXSBIYW5kbGVyIElECiAqIEBwYXJhbSAge1N0cmluZ30gICBzY29wZSAgIFtPcHRpb25hbF0gSGFuZGxlciBzY29wZSwgZGVmYXVsdCBpcyBgdGhpc2AKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLk9ic2VydmFibGV9CiAqIEBleGFtcGxlCiAqIG9ic2VydmVyLm9uY2UoICJjbGljayIsIGZ1bmN0aW9uICggZXYgKSB7CiAqICAgLi4uCiAqIH0gKTsKICovCk9ic2VydmFibGUucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiAoIGV2LCBoYW5kbGVyLCBpZCwgc2NvcGUgICkgewoJdmFyIHNlbGYgPSB0aGlzOwoKCWlkICAgID0gaWQgICAgfHwgdXRpbGl0eS51dWlkKCk7CglzY29wZSA9IHNjb3BlIHx8IHRoaXM7CgoJcmV0dXJuIHRoaXMub24oIGV2LCBmdW5jdGlvbiAoKSB7CgkJaGFuZGxlci5hcHBseSggc2NvcGUsIFtdLmNvbmNhdCggYXJyYXkuY2FzdCggYXJndW1lbnRzICkgKSApOwoJCXNlbGYub2ZmKCBldiwgaWQgKTsKCX0sIGlkLCBzY29wZSApOwp9OwoKLyoqCiAqIFVuaG9va3MgZnJvbSBgdGFyZ2V0YCBmb3IgYSBET00gZXZlbnQKICoKICogQG1ldGhvZCB1bmhvb2sKICogQG1lbWJlck9mIGtlaWdhaS5PYnNlcnZhYmxlCiAqIEBwYXJhbSAge09iamVjdH0gdGFyZ2V0IEVsZW1lbnQKICogQHBhcmFtICB7U3RyaW5nfSBldiAgICAgRXZlbnQKICogQHJldHVybiB7T2JqZWN0fSAgICAgICAgRWxlbWVudAogKiBAZXhhbXBsZQogKiBvYnNlcnZlci51bmhvb2soIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICJhIiApLCAiY2xpY2siICk7CiAqLwpPYnNlcnZhYmxlLnByb3RvdHlwZS51bmhvb2sgPSBmdW5jdGlvbiAoIHRhcmdldCwgZXYgKSB7Cgl0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lciggZXYsIHRoaXMuaG9va3NbdGFyZ2V0LmlkXSwgZmFsc2UgKTsKCWRlbGV0ZSB0aGlzLmhvb2tzW3RhcmdldC5pZF07CgoJcmV0dXJuIHRhcmdldDsKfTsKCi8qKgogKiBAbmFtZXNwYWNlIGJhc2UKICogQHByaXZhdGUKICovCnZhciBiYXNlID0gewoJLyoqCgkgKiBCYXNlIGZhY3RvcnkKCSAqCgkgKiBAbWVtYmVyT2YgYmFzZQoJICogQG1ldGhvZCBmYWN0b3J5CgkgKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KCSAqLwoJZmFjdG9yeSA6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gbmV3IEJhc2UoKTsKCX0KfTsKCi8qKgogKiBCYXNlIE9iamVjdAogKgogKiBAY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaQogKi8KZnVuY3Rpb24gQmFzZSAoKSB7CgkvKioKCSAqIHtAbGluayBrZWlnYWkuT2JzZXJ2YWJsZX0KCSAqCgkgKiBAYWJzdHJhY3QKCSAqIEB0eXBlIHtPYmplY3R9CgkgKi8KCXRoaXMub2JzZXJ2ZXIgPSBudWxsOwp9CgovKioKICogU2V0dGluZyBjb25zdHJ1Y3RvciBsb29wCiAqCiAqIEBtZXRob2QgY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaS5CYXNlCiAqIEB0eXBlIHtGdW5jdGlvbn0KICogQHByaXZhdGUKICovCkJhc2UucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQmFzZTsKCi8qKgogKiBBZGRzIGFuIGV2ZW50IGxpc3RlbmVyCiAqCiAqIEBtZXRob2QgYWRkRXZlbnRMaXN0ZW5lcgogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSAgIGV2ICAgICAgIEV2ZW50IG5hbWUKICogQHBhcmFtICB7RnVuY3Rpb259IGxpc3RlbmVyIEZ1bmN0aW9uIHRvIGV4ZWN1dGUKICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICAgICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgSUQKICogQHBhcmFtICB7U3RyaW5nfSAgIHNjb3BlICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgc2NvcGUsIGRlZmF1bHQgaXMgYHRoaXNgCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKiBAZXhhbXBsZQogKiBvYmouYWRkRXZlbnRMaXN0ZW5lciggImV2ZW50IiwgZnVuY3Rpb24gKCBldiApIHsKICogICAuLi4KICogfSwgIm15SG9vayIgKTsKICovCkJhc2UucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbiAoIGV2LCBsaXN0ZW5lciwgaWQsIHNjb3BlICkgewoJdGhpcy5vYnNlcnZlci5vbiggZXYsIGxpc3RlbmVyLCBpZCwgc2NvcGUgfHwgdGhpcyApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEFkZHMgYW4gZXZlbnQgbGlzdGVuZXIKICoKICogQG1ldGhvZCBhZGRMaXN0ZW5lcgogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSAgIGV2ICAgICAgIEV2ZW50IG5hbWUKICogQHBhcmFtICB7RnVuY3Rpb259IGxpc3RlbmVyIEZ1bmN0aW9uIHRvIGV4ZWN1dGUKICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICAgICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgSUQKICogQHBhcmFtICB7U3RyaW5nfSAgIHNjb3BlICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgc2NvcGUsIGRlZmF1bHQgaXMgYHRoaXNgCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKiBAZXhhbXBsZQogKiBvYmouYWRkRXZlbnRMaXN0ZW5lciggImV2ZW50IiwgZnVuY3Rpb24gKCBldiApIHsKICogICAuLi4KICogfSwgIm15SG9vayIgKTsKICovCkJhc2UucHJvdG90eXBlLmFkZExpc3RlbmVyID0gZnVuY3Rpb24gKCBldiwgbGlzdGVuZXIsIGlkLCBzY29wZSApIHsKCXRoaXMub2JzZXJ2ZXIub24oIGV2LCBsaXN0ZW5lciwgaWQsIHNjb3BlIHx8IHRoaXMgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBEaXNwYXRjaGVzIGFuIGV2ZW50LCB3aXRoIG9wdGlvbmFsIGFyZ3VtZW50cwogKgogKiBAbWV0aG9kIGRpc3BhdGNoCiAqIEBtZW1iZXJPZiBrZWlnYWkuQmFzZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICogQGV4YW1wbGUKICogb2JqLmRpc3BhdGNoKCAiZXZlbnQiLCAuLi4gKTsKICovCkJhc2UucHJvdG90eXBlLmRpc3BhdGNoID0gZnVuY3Rpb24gKCkgewoJdGhpcy5vYnNlcnZlci5kaXNwYXRjaC5hcHBseSggdGhpcy5vYnNlcnZlciwgW10uY29uY2F0KCBhcnJheS5jYXN0KCBhcmd1bWVudHMgKSApICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogRGlzcGF0Y2hlcyBhbiBldmVudCwgd2l0aCBvcHRpb25hbCBhcmd1bWVudHMKICoKICogQG1ldGhvZCBkaXNwYXRjaEV2ZW50CiAqIEBtZW1iZXJPZiBrZWlnYWkuQmFzZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICogQGV4YW1wbGUKICogb2JqLmRpc3BhdGNoRXZlbnQoICJldmVudCIsIC4uLiApOwogKi8KQmFzZS5wcm90b3R5cGUuZGlzcGF0Y2hFdmVudCA9IGZ1bmN0aW9uICgpIHsKCXRoaXMub2JzZXJ2ZXIuZGlzcGF0Y2guYXBwbHkoIHRoaXMub2JzZXJ2ZXIsIFtdLmNvbmNhdCggYXJyYXkuY2FzdCggYXJndW1lbnRzICkgKSApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIERpc3BhdGNoZXMgYW4gZXZlbnQsIHdpdGggb3B0aW9uYWwgYXJndW1lbnRzCiAqCiAqIEBtZXRob2QgZW1pdAogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkJhc2V9CiAqIEBleGFtcGxlCiAqIG9iai5lbWl0KCAiZXZlbnQiLCAuLi4gKTsKICovCkJhc2UucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbiAoKSB7Cgl0aGlzLm9ic2VydmVyLmRpc3BhdGNoLmFwcGx5KCB0aGlzLm9ic2VydmVyLCBbXS5jb25jYXQoIGFycmF5LmNhc3QoIGFyZ3VtZW50cyApICkgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBIb29rcyBpbnRvIGB0YXJnZXRgIGZvciBhbiBldmVudAogKgogKiBAbWV0aG9kIGhvb2sKICogQG1lbWJlck9mIGtlaWdhaS5CYXNlCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKiBAZXhhbXBsZQogKiBvYmouaG9vayggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggImEiICksICJjbGljayIgKTsKICovCkJhc2UucHJvdG90eXBlLmhvb2sgPSBmdW5jdGlvbiAoKSB7Cgl0aGlzLm9ic2VydmVyLmhvb2suYXBwbHkoIHRoaXMub2JzZXJ2ZXIsIFtdLmNvbmNhdCggYXJyYXkuY2FzdCggYXJndW1lbnRzICkgKSApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEdldHMgbGlzdGVuZXJzCiAqCiAqIEBtZXRob2QgbGlzdGVuZXJzCiAqIEBtZW1iZXJPZiBrZWlnYWkuQmFzZQogKiBAcGFyYW0gIHtTdHJpbmd9IGV2IFtPcHRpb25hbF0gRXZlbnQgbmFtZQogKiBAcmV0dXJuIHtPYmplY3R9IExpc3RlbmVycwogKiBAZXhhbXBsZQogKiBrZWlnYWkudXRpbC5pdGVyYXRlKCBvYmoubGlzdGVuZXJzKCksIGZ1bmN0aW9uICggZm4sIGlkICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpCYXNlLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbiAoIGV2ICkgewoJcmV0dXJuIGV2ID8gdGhpcy5vYnNlcnZlci5saXN0ZW5lcnNbZXZdIDogdGhpcy5saXN0ZW5lcnM7Cn07CgovKioKICogUmVtb3ZlcyBhbiBldmVudCBsaXN0ZW5lcgogKgogKiBAbWV0aG9kIG9mZgogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSBldiBFdmVudCBuYW1lCiAqIEBwYXJhbSAge1N0cmluZ30gaWQgW09wdGlvbmFsXSBMaXN0ZW5lciBJRAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICogQGV4YW1wbGUKICogb2JqLm9mZiggImV2ZW50IiwgIm15SG9vayIgKTsKICovCkJhc2UucHJvdG90eXBlLm9mZiA9IGZ1bmN0aW9uICggZXYsIGlkICkgewoJdGhpcy5vYnNlcnZlci5vZmYoIGV2LCBpZCApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEFkZHMgYW4gZXZlbnQgbGlzdGVuZXIKICoKICogQG1ldGhvZCBvbgogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSAgIGV2ICAgICAgIEV2ZW50IG5hbWUKICogQHBhcmFtICB7RnVuY3Rpb259IGxpc3RlbmVyIEZ1bmN0aW9uIHRvIGV4ZWN1dGUKICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICAgICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgSUQKICogQHBhcmFtICB7U3RyaW5nfSAgIHNjb3BlICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgc2NvcGUsIGRlZmF1bHQgaXMgYHRoaXNgCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKiBAZXhhbXBsZQogKiBvYmoub24oICJldmVudCIsIGZ1bmN0aW9uICggZXYgKSB7CiAqICAgLi4uCiAqIH0sICJteUhvb2siICk7CiAqLwpCYXNlLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uICggZXYsIGxpc3RlbmVyLCBpZCwgc2NvcGUgKSB7Cgl0aGlzLm9ic2VydmVyLm9uKCBldiwgbGlzdGVuZXIsIGlkLCBzY29wZSB8fCB0aGlzICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogQWRkcyBhIHNob3J0IGxpdmVkIGV2ZW50IGxpc3RlbmVyCiAqCiAqIEBtZXRob2Qgb25jZQogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSAgIGV2ICAgICAgIEV2ZW50IG5hbWUKICogQHBhcmFtICB7RnVuY3Rpb259IGxpc3RlbmVyIEZ1bmN0aW9uIHRvIGV4ZWN1dGUKICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICAgICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgSUQKICogQHBhcmFtICB7U3RyaW5nfSAgIHNjb3BlICAgIFtPcHRpb25hbF0gTGlzdGVuZXIgc2NvcGUsIGRlZmF1bHQgaXMgYHRoaXNgCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKiBAZXhhbXBsZQogKiBvYmoub25jZSggImV2ZW50IiwgZnVuY3Rpb24gKCBldiApIHsKICogICAuLi4KICogfSApOwogKi8KQmFzZS5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uICggZXYsIGxpc3RlbmVyLCBpZCwgc2NvcGUgKSB7Cgl0aGlzLm9ic2VydmVyLm9uY2UoIGV2LCBsaXN0ZW5lciwgaWQsIHNjb3BlIHx8IHRoaXMgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBSZW1vdmVzIGFuIGV2ZW50IGxpc3RlbmVyCiAqCiAqIEBtZXRob2QgcmVtb3ZlRXZlbnRMaXN0ZW5lcgogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSBldiBFdmVudCBuYW1lCiAqIEBwYXJhbSAge1N0cmluZ30gaWQgW09wdGlvbmFsXSBMaXN0ZW5lciBJRAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICogQGV4YW1wbGUKICogb2JqLnJlbW92ZUxpc3RlbmVyKCAiZXZlbnQiLCAibXlIb29rIiApOwogKi8KQmFzZS5wcm90b3R5cGUucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uICggZXYsIGlkICkgewoJdGhpcy5vYnNlcnZlci5vZmYoIGV2LCBpZCApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIFJlbW92ZXMgYW4gZXZlbnQgbGlzdGVuZXIKICoKICogQG1ldGhvZCByZW1vdmVMaXN0ZW5lcgogKiBAbWVtYmVyT2Yga2VpZ2FpLkJhc2UKICogQHBhcmFtICB7U3RyaW5nfSBldiBFdmVudCBuYW1lCiAqIEBwYXJhbSAge1N0cmluZ30gaWQgW09wdGlvbmFsXSBMaXN0ZW5lciBJRAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICogQGV4YW1wbGUKICogb2JqLnJlbW92ZUxpc3RlbmVyKCAiZXZlbnQiLCAibXlIb29rIiApOwogKi8KQmFzZS5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiAoIGV2LCBpZCApIHsKCXRoaXMub2JzZXJ2ZXIub2ZmKCBldiwgaWQgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBAbmFtZXNwYWNlIGFycmF5CiAqLwp2YXIgYXJyYXkgPSB7CgkvKioKCSAqIEFkZHMgJ2FyZycgdG8gJ29iaicgaWYgaXQgaXMgbm90IGZvdW5kCgkgKgoJICogQG1ldGhvZCBhZGQKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byByZWNlaXZlICdhcmcnCgkgKiBAcGFyYW0gIHtNaXhlZH0gYXJnIEFyZ3VtZW50IHRvIHNldCBpbiAnb2JqJwoJICogQHJldHVybiB7QXJyYXl9ICAgICBBcnJheSB0aGF0IHdhcyBxdWVyaWVkCgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbMSwgMl07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkuYWRkKCBteUFycmF5LCAzICk7IC8vIFsxLCAyLCAzXQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuYWRkKCBteUFycmF5LCAxICk7IC8vIFsxLCAyLCAzXQoJICovCglhZGQgOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCWlmICggIWFycmF5LmNvbnRhaW5zKCBvYmosIGFyZyApICkgewoJCQlvYmoucHVzaCggYXJnICk7CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFByZWZvcm1zIGEgYmluYXJ5IHNlYXJjaCBvbiBhIHNvcnRlZCBBcnJheQoJICoKCSAqIEBtZXRob2QgYmluSW5kZXgKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBzZWFyY2gKCSAqIEBwYXJhbSAge01peGVkfSBhcmcgVmFsdWUgdG8gZmluZCBpbmRleCBvZgoJICogQHJldHVybiB7TnVtYmVyfSAgICBJbmRleCBvZiBgYXJnYCB3aXRoaW4gYG9iamAKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSA9IFsxLCA1LCAxMCwgMTUsIDIwLCAyNSwgLi4uXTsKCSAqCgkgKiBrZWlnYWkudXRpbC5hcnJheS5iaW5JbmRleCggbXlBcnJheSwgNSApOyAvLyAxCgkgKi8KCWJpbkluZGV4IDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQl2YXIgbWluID0gMCwKCQkgICAgbWF4ID0gb2JqLmxlbmd0aCAtIDEsCgkJICAgIGlkeCwgdmFsOwoKCQl3aGlsZSAoIG1pbiA8PSBtYXggKSB7CgkJCWlkeCA9IE1hdGguZmxvb3IoICggbWluICsgbWF4ICkgLyAyICk7CgkJCXZhbCA9IG9ialtpZHhdOwoKCQkJaWYgKCB2YWwgPCBhcmcgKSB7CgkJCQltaW4gPSBpZHggKyAxOwoJCQl9CgkJCWVsc2UgaWYgKCB2YWwgPiBhcmcgKSB7CgkJCQltYXggPSBpZHggLSAxOwoJCQl9CgkJCWVsc2UgewoJCQkJcmV0dXJuIGlkeDsKCQkJfQoJCX0KCgkJcmV0dXJuIC0xOwoJfSwKCgkvKioKCSAqIFJldHVybnMgYW4gT2JqZWN0ICggTm9kZUxpc3QsIGV0Yy4gKSBhcyBhbiBBcnJheQoJICoKCSAqIEBtZXRob2QgY2FzdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtPYmplY3R9ICBvYmogT2JqZWN0IHRvIGNhc3QKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGtleSBbT3B0aW9uYWxdIFJldHVybnMga2V5IG9yIHZhbHVlLCBvbmx5IGFwcGxpZXMgdG8gT2JqZWN0cyB3aXRob3V0IGEgbGVuZ3RoIHByb3BlcnR5CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgT2JqZWN0IGFzIGFuIEFycmF5CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuY2FzdCggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCggIi4uLiIgKSApOwoJICovCgljYXN0IDogZnVuY3Rpb24gKCBvYmosIGtleSApIHsKCQlrZXkgICA9ICgga2V5ID09PSB0cnVlICk7CgkJdmFyIG8gPSBbXTsKCgkJaWYgKCAhaXNOYU4oIG9iai5sZW5ndGggKSApIHsKCQkJbyA9IHNsaWNlLmNhbGwoIG9iaiApOwoJCX0KCQllbHNlIGlmICgga2V5ICkgewoJCQlvID0gYXJyYXkua2V5cyggb2JqICk7CgkJfQoJCWVsc2UgewoJCQl1dGlsaXR5Lml0ZXJhdGUoIG9iaiwgZnVuY3Rpb24gKCBpICkgewoJCQkJby5wdXNoKCBpICk7CgkJCX0gKTsKCQl9CgoJCXJldHVybiBvOwoJfSwKCgkvKioKCSAqIFRyYW5zZm9ybXMgYW4gQXJyYXkgdG8gYSAyRCBBcnJheSBvZiBjaHVua3MKCSAqCgkgKiBAbWV0aG9kIGNodW5rCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgb2JqICBBcnJheSB0byBwcm9jZXNzCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IHNpemUgQ2h1bmsgc2l6ZSAoIGludGVnZXIgKQoJICogQHJldHVybiB7QXJyYXl9ICAgICAgIENodW5rZWQgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5jaHVuayggWzAsIDEsIDIsIDNdLCAyICk7IC8vIFtbMCwgMV0sIFsyLCAzXV0KCSAqLwoJY2h1bmsgOiBmdW5jdGlvbiAoIG9iaiwgc2l6ZSApIHsKCQl2YXIgcmVzdWx0ID0gW10sCgkJICAgIG50aCAgICA9IG51bWJlci5yb3VuZCggKCBvYmoubGVuZ3RoIC8gc2l6ZSApLCAidXAiICksCgkJICAgIHN0YXJ0ICA9IDAsCgkJICAgIGkgICAgICA9IC0xOwoKCQl3aGlsZSAoICsraSA8IG50aCApIHsKCQkJc3RhcnQgPSBpICogc2l6ZTsKCQkJcmVzdWx0LnB1c2goIGFycmF5LmxpbWl0KCBvYmosIHN0YXJ0LCBzaXplICkgKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogQ2xlYXJzIGFuIEFycmF5IHdpdGhvdXQgZGVzdHJveWluZyBpdAoJICoKCSAqIEBtZXRob2QgY2xlYXIKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBjbGVhcgoJICogQHJldHVybiB7QXJyYXl9ICAgICBDbGVhcmVkIEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbMSwgMiwgMywgNCwgNV07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkuY2xlYXIoIG15QXJyYXkgKTsKCSAqIG15QXJyYXkubGVuZ3RoOyAvLyAwCgkgKi8KCWNsZWFyIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIG9iai5sZW5ndGggPiAwID8gYXJyYXkucmVtb3ZlKCBvYmosIDAsIG9iai5sZW5ndGggKSA6IG9iajsKCX0sCgoJLyoqCgkgKiBDbG9uZXMgYW4gQXJyYXkKCSAqCgkgKiBAbWV0aG9kIGNsb25lCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gY2xvbmUKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgQ2xvbmUgb2YgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSAgICAgID0gWzEsIDIsIDMsIDQsIDVdLAoJICogICAgIG15QXJyYXlDbG9uZSA9IGtlaWdhaS51dGlsLmFycmF5LmNsb25lKCBteUFycmF5ICk7CgkgKgoJICogbXlBcnJheUNsb25lLnB1c2goIDYgKTsKCSAqCgkgKiBteUFycmF5Lmxlbmd0aDsgICAgICAvLyA1CgkgKiBteUFycmF5Q2xvbmUubGVuZ3RoOyAvLyA2CgkgKi8KCWNsb25lIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIG9iai5zbGljZSgpOwoJfSwKCgkvKioKCSAqIERldGVybWluZXMgaWYgb2JqIGNvbnRhaW5zIGFyZwoJICoKCSAqIEBtZXRob2QgY29udGFpbnMKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBzZWFyY2gKCSAqIEBwYXJhbSAge01peGVkfSBhcmcgVmFsdWUgdG8gbG9vayBmb3IKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgVHJ1ZSBpZiBmb3VuZCwgZmFsc2UgaWYgbm90CgkgKiBAZXhhbXBsZQoJICogaWYgKCBrZWlnYWkudXRpbC5hcnJheS5jb250YWlucyggWzFdLCAxICkgKSB7IC4uLiB9CgkgKi8KCWNvbnRhaW5zIDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQlyZXR1cm4gb2JqLmluZGV4T2YoIGFyZyApID4gLTE7Cgl9LAoKCS8qKgoJICogQ3JlYXRlcyBhIG5ldyBBcnJheSBvZiB0aGUgcmVzdWx0IG9mIGBmbmAgZXhlY3V0ZWQgYWdhaW5zdCBldmVyeSBpbmRleCBvZiBgb2JqYAoJICoKCSAqIEBtZXRob2QgY29sbGVjdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gICAgb2JqIEFycmF5IHRvIGl0ZXJhdGUKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiAgRnVuY3Rpb24gdG8gZXhlY3V0ZSBhZ2FpbnN0IGluZGljZXMKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgTmV3IEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIHJlc3VsdHMgPSBrZWlnYWkudXRpbC5hcnJheS5jb2xsZWN0KCBbLi4uXSwgZnVuY3Rpb24gKCAuLi4gKSB7IC4uLiB9ICk7CgkgKi8KCWNvbGxlY3QgOiBmdW5jdGlvbiAoIG9iaiwgZm4gKSB7CgkJdmFyIHJlc3VsdCA9IFtdOwoKCQlhcnJheS5lYWNoKCBvYmosIGZ1bmN0aW9uICggaSApIHsKCQkJcmVzdWx0LnB1c2goIGZuKCBpICkgKTsKCQl9ICk7CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogQ29tcGFjdHMgYSBBcnJheSBieSByZW1vdmluZyBgbnVsbGAgb3IgYHVuZGVmaW5lZGAgaW5kaWNlcwoJICoKCSAqIEBtZXRob2QgY29tcGFjdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gICBvYmogIEFycmF5IHRvIGNvbXBhY3QKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGRpZmYgSW5kaWNhdGVzIHRvIHJldHVybiByZXN1bHRpbmcgQXJyYXkgb25seSBpZiB0aGVyZSdzIGEgZGlmZmVyZW5jZQoJICogQHJldHVybiB7QXJyYXl9ICAgICAgICBDb21wYWN0ZWQgY29weSBvZiBgb2JqYCwgb3IgbnVsbCAoIGlmIGBkaWZmYCBpcyBwYXNzZWQgJiBubyBkaWZmIGlzIGZvdW5kICkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5jb21wYWN0KCBbbnVsbCwgImEiLCAiYiIsICJjIiwgbnVsbCwgImQiXSApOyAvLyBbImEiLCAiYiIsICJjIiwgImQiXQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuY29tcGFjdCggWyJhIiwgImIiLCAiYyIsICJkIl0sIHRydWUgKTsgICAgICAgLy8gbnVsbAoJICovCgljb21wYWN0IDogZnVuY3Rpb24gKCBvYmosIGRpZmYgKSB7CgkJZGlmZiA9ICggZGlmZiA9PT0gdHJ1ZSApOwoJCXZhciByZXN1bHQ7CgoJCXJlc3VsdCA9IG9iai5maWx0ZXIoIGZ1bmN0aW9uICggaSApIHsKCQkJcmV0dXJuICFyZWdleC5udWxsX3VuZGVmaW5lZC50ZXN0KCBpICk7CgkJfSApOwoKCQlyZXR1cm4gIWRpZmYgPyByZXN1bHQgOiAoIHJlc3VsdC5sZW5ndGggPCBvYmoubGVuZ3RoID8gcmVzdWx0IDogbnVsbCApOwoJfSwKCgkvKioKCSAqIENvdW50cyBgdmFsdWVgIGluIGBvYmpgCgkgKgoJICogQG1ldGhvZCBjb3VudAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqICAgQXJyYXkgdG8gc2VhcmNoCgkgKiBAcGFyYW0gIHtNaXhlZH0gdmFsdWUgVmFsdWUgdG8gY29tcGFyZQoJICogQHJldHVybiB7QXJyYXl9ICAgICAgIEFycmF5IG9mIGNvdW50cwoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmNvdW50KCBbImFwcGxlIiwgImJhbmFuYSIsICJvcmFuZ2UiLCAiYXBwbGUiXSwgImFwcGxlIiApOyAvLyAyCgkgKi8KCWNvdW50IDogZnVuY3Rpb24gKCBvYmosIHZhbHVlICkgewoJCXJldHVybiBvYmouZmlsdGVyKCBmdW5jdGlvbiAoIGkgKSB7CgkJCXJldHVybiAoIGkgPT09IHZhbHVlICk7CgkJfSApLmxlbmd0aDsKCX0sCgoJLyoqCgkgKiBGaW5kcyB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIHR3byBBcnJheXMKCSAqCgkgKiBAbWV0aG9kIGRpZmYKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iajEgU291cmNlIEFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMiBDb21wYXJpc29uIEFycmF5CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICBBcnJheSBvZiB0aGUgZGlmZmVyZW5jZXMKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5kaWZmKCBbImEiXSwgWyJhIiwgImIiXSApOyAvLyBbImIiXQoJICovCglkaWZmIDogZnVuY3Rpb24gKCBvYmoxLCBvYmoyICkgewoJCXZhciByZXN1bHQgPSBbXTsKCgkJYXJyYXkuZWFjaCggb2JqMSwgZnVuY3Rpb24gKCBpICkgewoJCQlpZiAoICFhcnJheS5jb250YWlucyggb2JqMiwgaSApICkgewoJCQkJYXJyYXkuYWRkKCByZXN1bHQsIGkgKTsKCQkJfQoJCX0gKTsKCgkJYXJyYXkuZWFjaCggb2JqMiwgZnVuY3Rpb24gKCBpICkgewoJCQlpZiAoICFhcnJheS5jb250YWlucyggb2JqMSwgaSApICkgewoJCQkJYXJyYXkuYWRkKCByZXN1bHQsIGkgKTsKCQkJfQoJCX0gKTsKCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBJdGVyYXRlcyBgb2JqYCBhbmQgZXhlY3V0ZXMgYGZuYCB3aXRoIGFyZ3VtZW50cyBbYHZhbHVlYCwgYGluZGV4YF0uCgkgKiBSZXR1cm5pbmcgYGZhbHNlYCBoYWx0cyBpdGVyYXRpb24uCgkgKgoJICogQG1ldGhvZCBlYWNoCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgICBvYmogICBBcnJheSB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZm4gICAgRnVuY3Rpb24gdG8gZXhlY3V0ZSBvbiBpbmRleCB2YWx1ZXMKCSAqIEBwYXJhbSAge0Jvb2xlYW59ICBhc3luYyBbT3B0aW9uYWxdIEFzeW5jaHJvbm91cyBpdGVyYXRpb24KCSAqIEBwYXJhbSAge051bWJlcn0gICBzaXplICBbT3B0aW9uYWxdIEJhdGNoIHNpemUgZm9yIGFzeW5jIGl0ZXJhdGlvbiwgZGVmYXVsdCBpcyAxMAoJICogQHJldHVybiB7QXJyYXl9ICAgICAgICAgIEFycmF5CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuZWFjaCggWyAuLi4gXSwgZnVuY3Rpb24gKCAuLi4gKSB7IC4uLiB9ICk7CgkgKiBrZWlnYWkudXRpbC5hcnJheS5lYWNoKCBbIC4uLiBdLCBmdW5jdGlvbiAoIC4uLiApIHsgLi4uIH0sIHRydWUsIDEwMCApOyAvLyBwcm9jZXNzaW5nIGJhdGNoZXMgb2YgYSAxMDAKCSAqLwoJZWFjaCA6IGZ1bmN0aW9uICggb2JqLCBmbiwgYXN5bmMsIHNpemUgKSB7CgkJdmFyIG50aCA9IG9iai5sZW5ndGgsCgkJICAgIGksIG9mZnNldDsKCgkJaWYgKCBhc3luYyAhPT0gdHJ1ZSApIHsKCQkJaSA9IC0xOwoJCQl3aGlsZSAoICsraSA8IG50aCApIHsKCQkJCWlmICggZm4uY2FsbCggb2JqLCBvYmpbaV0sIGkgKSA9PT0gZmFsc2UgKSB7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9CgkJZWxzZSB7CgkJCXNpemUgICA9IHNpemUgfHwgMTA7CgkJCW9mZnNldCA9IDA7CgoJCQlpZiAoIHNpemUgPiBudGggKSB7CgkJCQlzaXplID0gbnRoOwoJCQl9CgoJCQl1dGlsaXR5LnJlcGVhdCggZnVuY3Rpb24gKCkgewoJCQkJdmFyIGkgPSAtMSwKCQkJCSAgICBpZHg7CgoJCQkJd2hpbGUgKCArK2kgPCBzaXplICkgewoJCQkJCWlkeCA9IGkgKyBvZmZzZXQ7CgoJCQkJCWlmICggaWR4ID09PSBudGggfHwgZm4uY2FsbCggb2JqLCBvYmpbaWR4XSwgaWR4ICkgPT09IGZhbHNlICkgewoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfQoKCQkJCW9mZnNldCArPSBzaXplOwoKCQkJCWlmICggb2Zmc2V0ID49IG50aCApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0sIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBmYWxzZSApOwoJCX0KCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBJdGVyYXRlcyBgb2JqYCBpbiByZXZlcnNlIGFuZCBleGVjdXRlcyBgZm5gIHdpdGggYXJndW1lbnRzIFtgdmFsdWVgLCBgaW5kZXhgXS4KCSAqIFJldHVybmluZyBgZmFsc2VgIGhhbHRzIGl0ZXJhdGlvbi4KCSAqCgkgKiBAbWV0aG9kIGVhY2hSZXZlcnNlCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgICBvYmogICBBcnJheSB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZm4gICAgRnVuY3Rpb24gdG8gZXhlY3V0ZSBvbiBpbmRleCB2YWx1ZXMKCSAqIEBwYXJhbSAge0Jvb2xlYW59ICBhc3luYyBbT3B0aW9uYWxdIEFzeW5jaHJvbm91cyBpdGVyYXRpb24KCSAqIEBwYXJhbSAge051bWJlcn0gICBzaXplICBbT3B0aW9uYWxdIEJhdGNoIHNpemUgZm9yIGFzeW5jIGl0ZXJhdGlvbiwgZGVmYXVsdCBpcyAxMAoJICogQHJldHVybiB7QXJyYXl9ICAgICAgICAgIEFycmF5CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuZWFjaFJldmVyc2UoIFsgLi4uIF0sIGZ1bmN0aW9uICggLi4uICkgeyAuLi4gfSApOwoJICoga2VpZ2FpLnV0aWwuYXJyYXkuZWFjaFJldmVyc2UoIFsgLi4uIF0sIGZ1bmN0aW9uICggLi4uICkgeyAuLi4gfSwgdHJ1ZSwgMTAwICk7IC8vIHByb2Nlc3NpbmcgYmF0Y2hlcyBvZiBhIDEwMAoJICovCgllYWNoUmV2ZXJzZSA6IGZ1bmN0aW9uICggb2JqLCBmbiwgYXN5bmMsIHNpemUgKSB7CgkJdmFyIG50aCA9IG9iai5sZW5ndGgsCgkJCWksIG9mZnNldDsKCgkJaWYgKCBhc3luYyAhPT0gdHJ1ZSApIHsKCQkJaSA9IG50aDsKCQkJd2hpbGUgKCAtLWkgPiAtMSApIHsKCQkJCWlmICggZm4uY2FsbCggb2JqLCBvYmpbaV0sIGkgKSA9PT0gZmFsc2UgKSB7CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9CgkJZWxzZSB7CgkJCXNpemUgICA9IHNpemUgfHwgMTA7CgkJCW9mZnNldCA9IG50aCAtIDE7CgoJCQlpZiAoIHNpemUgPiBudGggKSB7CgkJCQlzaXplID0gbnRoOwoJCQl9CgoJCQl1dGlsaXR5LnJlcGVhdCggZnVuY3Rpb24gKCkgewoJCQkJdmFyIGkgPSAtMSwKCQkJCQlpZHg7CgoJCQkJd2hpbGUgKCArK2kgPCBzaXplICkgewoJCQkJCWlkeCA9IG9mZnNldCAtIGk7CgoJCQkJCWlmICggaWR4IDwgMCB8fCBmbi5jYWxsKCBvYmosIG9ialtpZHhdLCBpZHggKSA9PT0gZmFsc2UgKSB7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9CgoJCQkJb2Zmc2V0IC09IHNpemU7CgoJCQkJaWYgKCBvZmZzZXQgPCAwICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGZhbHNlICk7CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIERldGVybWluZXMgaWYgYW4gQXJyYXkgaXMgZW1wdHkKCSAqCgkgKiBAbWV0aG9kIGVtcHR5CgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gaW5zcGVjdAoJICogQHJldHVybiB7Qm9vbGVhbn0gICBgdHJ1ZWAgaWYgdGhlcmUncyBubyBpbmRpY2VzCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuZW1wdHkoIFtdICk7ICAgIC8vIHRydWUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmVtcHR5KCBbImEiXSApOyAvLyBmYWxzZQoJICovCgllbXB0eSA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiAoIG9iai5sZW5ndGggPT09IDAgKTsKCX0sCgoJLyoqCgkgKiBEZXRlcm1pbmVzIGlmIHR3byBBcnJheXMgYXJlIGVxdWFsCgkgKgoJICogQG1ldGhvZCBlcXVhbAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMSBBcnJheSB0byBjb21wYXJlCgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMiBBcnJheSB0byBjb21wYXJlCgkgKiBAcmV0dXJuIHtCb29sZWFufSBgdHJ1ZWAgaWYgdGhlIEFycmF5cyBtYXRjaAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmVxdWFsKCBbImEiXSwgWyJhIl0gKTsgICAgICAvLyB0cnVlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5lcXVhbCggWyJhIl0sIFsiYSIsICJiIl0gKTsgLy8gZmFsc2UKCSAqLwoJZXF1YWwgOiBmdW5jdGlvbiAoIG9iajEsIG9iajIgKSB7CgkJcmV0dXJuICgganNvbi5lbmNvZGUoIG9iajEgKSA9PT0ganNvbi5lbmNvZGUoIG9iajIgKSApOwoJfSwKCgkvKioKCSAqIEZpYm9uYWNjaSBnZW5lcmF0b3IKCSAqCgkgKiBAbWV0aG9kIGZpYgoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGFyZyBbT3B0aW9uYWxdIEFtb3VudCBvZiBudW1iZXJzIHRvIGdlbmVyYXRlLCBkZWZhdWx0IGlzIDEwMAoJICogQHJldHVybiB7QXJyYXl9ICAgICAgQXJyYXkgb2YgbnVtYmVycwoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmZpYiggNSApIC8vIFsxLCAxLCAyLCAzLCA1XTsKCSAqIGtlaWdhaS51dGlsLmFycmF5LmZpYiggNiApIC8vIFsxLCAxLCAyLCAzLCA1LCA4XTsKCSAqLwoJZmliIDogZnVuY3Rpb24gKCBhcmcgKSB7CgkJdmFyIHJlc3VsdCA9IFsxLCAxXSwKCQkgICAgZmlyc3QgID0gcmVzdWx0WzBdLAoJCSAgICBzZWNvbmQgPSByZXN1bHRbMV0sCgkJICAgIHN1bTsKCgkJLy8gU3VidHJhY3RpbmcgMSB0byBhY2NvdW50IGZvciBgZmlyc3RgICYgYHNlY29uZGAKCQlhcmcgPSAoIGFyZyB8fCAxMDAgKSAtIDE7CgkJCgkJaWYgKCBpc05hTiggYXJnICkgfHwgYXJnIDwgMiApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQl3aGlsZSAoIC0tYXJnICkgewoJCQlzdW0gICAgPSBmaXJzdCArIHNlY29uZDsKCQkJZmlyc3QgID0gc2Vjb25kOwoJCQlzZWNvbmQgPSBzdW07CgkJCXJlc3VsdC5wdXNoKCBzdW0gKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogRmlsbHMgYG9iamAgd2l0aCB0aGUgZXZhbHV0aW9uIG9mIGBhcmdgLCBvcHRpb25hbGx5IGZyb20gYHN0YXJ0YCB0byBgb2Zmc2V0YAoJICoKCSAqIEBtZXRob2QgZmlsbAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gIG9iaiAgIEFycmF5IHRvIGZpbGwKCSAqIEBwYXJhbSAge01peGVkfSAgYXJnICAgU3RyaW5nLCBOdW1iZXIgb2YgRnVuY3Rpb24gdG8gZmlsbCB3aXRoCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IHN0YXJ0IFtPcHRpb25hbF0gSW5kZXggdG8gYmVnaW4gZmlsbGluZyBhdAoJICogQHBhcmFtICB7TnVtYmVyfSBlbmQgICBbT3B0aW9uYWxdIE9mZnNldCBmcm9tIHN0YXJ0IHRvIHN0b3AgZmlsbGluZyBhdAoJICogQHJldHVybiB7QXJyYXl9ICAgICAgICBGaWxsZWQgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSA9IFsiYSIsICJiIiwgImMiXTsKCSAqCgkgKiBrZWlnYWkudXRpbC5hcnJheS5maWxsKCBteUFycmF5LCBmdW5jdGlvbiAoIGkgKSB7IHJldHVybiBpICsgImEiOyB9ICk7CgkgKiBteUFycmF5WzBdOyAvLyAiYWEiCgkgKi8KCWZpbGwgOiBmdW5jdGlvbiAoIG9iaiwgYXJnLCBzdGFydCwgb2Zmc2V0ICkgewoJCXZhciBmbiAgPSB0eXBlb2YgYXJnID09ICJmdW5jdGlvbiIsCgkJICAgIGwgICA9IG9iai5sZW5ndGgsCgkJICAgIGkgICA9ICFpc05hTiggc3RhcnQgKSA/IHN0YXJ0IDogMCwKCQkgICAgbnRoID0gIWlzTmFOKCBvZmZzZXQgKSA/IGkgKyBvZmZzZXQgOiBsIC0gMTsKCgkJaWYgKCBudGggPiAoIGwgLSAxICkgKSB7CgkJCW50aCA9IGwgLSAxOwoJCX0KCgkJd2hpbGUgKCBpIDw9IG50aCApIHsKCQkJb2JqW2ldID0gZm4gPyBhcmcoIG9ialtpXSApIDogYXJnOwoJCQlpKys7CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFJldHVybnMgdGhlIGZpcnN0IEFycmF5IGluZGV4CgkgKgoJICogQG1ldGhvZCBmaXJzdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqIFRoZSBhcnJheQoJICogQHJldHVybiB7TWl4ZWR9ICAgICBUaGUgZmlyc3Qgbm9kZSBvZiB0aGUgYXJyYXkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5maXJzdCggWyJhIiwgImIiXSApOyAvLyAiYSIKCSAqLwoJZmlyc3QgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gb2JqWzBdOwoJfSwKCgkvKioKCSAqIEZsYXR0ZW5zIGEgMkQgQXJyYXkKCSAqCgkgKiBAbWV0aG9kIGZsYXQKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiAyRCBBcnJheSB0byBmbGF0dGVuCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgIEZsYXR0ZW4gQXJyYXkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5mbGF0KCBbWzAsIDFdLCBbMiwgM11dICk7IC8vIFswLCAxLCAyLCAzXQoJICovCglmbGF0IDogZnVuY3Rpb24gKCBvYmogKSB7CgkJdmFyIHJlc3VsdCA9IFtdOwoKCQlyZXN1bHQgPSBvYmoucmVkdWNlKCBmdW5jdGlvbiAoIGEsIGIgKSB7CgkJCXJldHVybiBhLmNvbmNhdCggYiApOwoJCX0sIHJlc3VsdCApOwoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIEl0ZXJhdGVzIGBvYmpgIGFuZCBleGVjdXRlcyBgZm5gIHdpdGggYXJndW1lbnRzIFtgdmFsdWVgLCBgaW5kZXhgXS4KCSAqIFJldHVybmluZyBgZmFsc2VgIGhhbHRzIGl0ZXJhdGlvbi4KCSAqCgkgKiBAbWV0aG9kIGZvckVhY2gKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHNlZSBhcnJheS5lYWNoCgkgKiBAcGFyYW0gIHtBcnJheX0gICAgb2JqICAgQXJyYXkgdG8gaXRlcmF0ZQoJICogQHBhcmFtICB7RnVuY3Rpb259IGZuICAgIEZ1bmN0aW9uIHRvIGV4ZWN1dGUgb24gaW5kZXggdmFsdWVzCgkgKiBAcGFyYW0gIHtCb29sZWFufSAgYXN5bmMgW09wdGlvbmFsXSBBc3luY2hyb25vdXMgaXRlcmF0aW9uCgkgKiBAcGFyYW0gIHtOdW1iZXJ9ICAgc2l6ZSAgW09wdGlvbmFsXSBCYXRjaCBzaXplIGZvciBhc3luYyBpdGVyYXRpb24sIGRlZmF1bHQgaXMgMTAKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgICBBcnJheQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmZvckVhY2goIFsgLi4uIF0sIGZ1bmN0aW9uICggLi4uICkgeyAuLi4gfSApOwoJICoga2VpZ2FpLnV0aWwuYXJyYXkuZm9yRWFjaCggWyAuLi4gXSwgZnVuY3Rpb24gKCAuLi4gKSB7IC4uLiB9LCB0cnVlLCAxMDAgKTsgLy8gcHJvY2Vzc2luZyBiYXRjaGVzIG9mIGEgMTAwCgkgKi8KCWZvckVhY2ggOiBmdW5jdGlvbiAoIG9iaiwgZm4sIGFzeW5jLCBzaXplICkgewoJCXJldHVybiBhcnJheS5lYWNoKCBvYmosIGZuLCBhc3luYywgc2l6ZSApOwoJfSwKCgkvKioKCSAqIENyZWF0ZXMgYSAyRCBBcnJheSBmcm9tIGFuIE9iamVjdAoJICoKCSAqIEBtZXRob2QgZnJvbU9iamVjdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiBPYmplY3QgdG8gY29udmVydAoJICogQHJldHVybiB7QXJyYXl9ICAgICAgMkQgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5mcm9tT2JqZWN0KCB7bmFtZTogIkpvaG4iLCBzZXg6ICJtYWxlIn0gKTsgLy8gW1sibmFtZSIsICJKb2huIl0sIFsic2V4IiwgIm1hbGUiXV0KCSAqLwoJZnJvbU9iamVjdCA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBhcnJheS5taW5nbGUoIGFycmF5LmtleXMoIG9iaiApLCBhcnJheS5jYXN0KCBvYmogKSApOwoJfSwKCgkvKioKCSAqIEZhY2FkZSBvZiBpbmRleE9mCgkgKgoJICogQG1ldGhvZCBpbmRleAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqIEFycmF5IHRvIHNlYXJjaAoJICogQHBhcmFtICB7TWl4ZWR9IGFyZyBWYWx1ZSB0byBmaW5kIGluZGV4IG9mCgkgKiBAcmV0dXJuIHtOdW1iZXJ9ICAgIFRoZSBwb3NpdGlvbiBvZiBhcmcgaW4gaW5zdGFuY2UKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5pbmRleCggWyJhIiwgImIiLCAiYyJdLCAiYiIgKTsgLy8gMQoJICovCglpbmRleCA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJcmV0dXJuIG9iai5pbmRleE9mKCBhcmcgKTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIGFuIEFzc29jaWF0aXZlIEFycmF5IGFzIGFuIEluZGV4ZWQgQXJyYXkKCSAqCgkgKiBAbWV0aG9kIGluZGV4ZWQKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBpbmRleAoJICogQHJldHVybiB7QXJyYXl9ICAgICBJbmRleGVkIEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbImEiLCAiYiIsICJjIl07CgkgKgoJICogbXlBcnJheS5wcm9wID0gImQiOwoJICoga2VpZ2FpLnV0aWwuYXJyYXkuaW5kZXhlZCggbXlBcnJheSApOyBbImEiLCAiYiIsICJjIiwgImQiXTsKCSAqLwoJaW5kZXhlZCA6IGZ1bmN0aW9uICggb2JqICkgewoJCXZhciBpbmRleGVkID0gW107CgoJCXV0aWxpdHkuaXRlcmF0ZSggb2JqLCBmdW5jdGlvbiAoIHYgKSB7CgkJCWluZGV4ZWQucHVzaCggdiApOwoJCX0gKTsKCgkJcmV0dXJuIGluZGV4ZWQ7Cgl9LAoKCS8qKgoJICogRmluZHMgdGhlIGludGVyc2VjdGlvbnMgYmV0d2VlbiBvYmoxIGFuZCBvYmoyCgkgKgoJICogQG1ldGhvZCBpbnRlcnNlY3QKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iajEgU291cmNlIEFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMiBDb21wYXJpc29uIEFycmF5CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICBBcnJheSBvZiB0aGUgaW50ZXJzZWN0aW9ucwoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmludGVyc2VjdCggWyJhIiwgImIiLCAiZCJdLCBbImIiLCAiYyIsICJkIl0gKTsgLy8gWyJiIiwgImQiXQoJICovCglpbnRlcnNlY3QgOiBmdW5jdGlvbiAoIG9iajEsIG9iajIgKSB7CgkJdmFyIGEgPSBvYmoxLmxlbmd0aCA+IG9iajIubGVuZ3RoID8gb2JqMSA6IG9iajIsCgkJICAgIGIgPSAoIGEgPT09IG9iajEgPyBvYmoyIDogb2JqMSApOwoKCQlyZXR1cm4gYS5maWx0ZXIoIGZ1bmN0aW9uICgga2V5ICkgewoJCQlyZXR1cm4gYXJyYXkuY29udGFpbnMoIGIsIGtleSApOwoJCX0gKTsKCX0sCgoJLyoqCgkgKiBLZWVwcyBldmVyeSBlbGVtZW50IG9mIGBvYmpgIGZvciB3aGljaCBgZm5gIGV2YWx1YXRlcyB0byB0cnVlCgkgKgoJICogQG1ldGhvZCBrZWVwSWYKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9ICAgIG9iaiBBcnJheSB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZm4gIEZ1bmN0aW9uIHRvIHRlc3QgaW5kaWNlcyBhZ2FpbnN0CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgIEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbImEiLCAiYiIsICJjIl07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkua2VlcElmKCBteUFycmF5LCBmdW5jdGlvbiAoIGkgKSB7IHJldHVybiAvYXxjLy50ZXN0KCBpICk7IH0gKTsKCSAqIG15QXJyYXlbMV07IC8vICJjIgoJICovCglrZWVwSWYgOiBmdW5jdGlvbiAoIG9iaiwgZm4gKSB7CgkJaWYgKCB0eXBlb2YgZm4gIT0gImZ1bmN0aW9uIiApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQl2YXIgcmVzdWx0ID0gW10sCgkJICAgIHJlbW92ZSA9IFtdOwoKCQlyZXN1bHQgPSBvYmouZmlsdGVyKCBmbiApOwoJCXJlbW92ZSA9IGFycmF5LmRpZmYoIG9iaiwgcmVzdWx0ICk7CgoJCWFycmF5LmVhY2goIHJlbW92ZSwgZnVuY3Rpb24gKCBpICkgewoJCQlhcnJheS5yZW1vdmUoIG9iaiwgYXJyYXkuaW5kZXgoIG9iaiwgaSApICk7CgkJfSApOwoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFJldHVybnMgdGhlIGtleXMgaW4gYW4gIkFzc29jaWF0aXZlIEFycmF5IgoJICoKCSAqIEBtZXRob2Qga2V5cwoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtNaXhlZH0gb2JqIEFycmF5IG9yIE9iamVjdCB0byBleHRyYWN0IGtleXMgZnJvbQoJICogQHJldHVybiB7QXJyYXl9ICAgICBBcnJheSBvZiB0aGUga2V5cwoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LmtleXMoIHthYmM6IHRydWUsIHh5ejogZmFsc2V9ICk7IC8vIFsiYWJjIiwgInh5eiJdCgkgKi8KCWtleXMgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gT2JqZWN0LmtleXMoIG9iaiApOwoJfSwKCgkvKioKCSAqIFNvcnRzIGFuIEFycmF5IGJhc2VkIG9uIGtleSB2YWx1ZXMsIGxpa2UgYW4gU1FMIE9SREVSIEJZIGNsYXVzZQoJICoKCSAqIEBtZXRob2Qga2V5U29ydAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gIG9iaiAgIEFycmF5IHRvIHNvcnQKCSAqIEBwYXJhbSAge1N0cmluZ30gcXVlcnkgU29ydCBxdWVyeSwgZS5nLiAibmFtZSwgYWdlIGRlc2MsIGNvdW50cnkiCgkgKiBAcGFyYW0gIHtTdHJpbmd9IHN1YiAgIFtPcHRpb25hbF0gS2V5IHdoaWNoIGhvbGRzIGRhdGEsIGUuZy4gIntkYXRhOiB7fX0iID0gImRhdGEiCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgIFNvcnRlZCBBcnJheQoJICogQGV4YW1wbGUKCSAqIHZhciBteUFycmF5ID0gW3thYmM6IDEyMzEyNCwgeHl6OiA1fSwge2FiYzogMTIzMTI0LCB4eXo6IDZ9LCB7YWJjOiAyLCB4eXo6IDV9XTsKCSAqCgkgKiBrZWlnYWkudXRpbC5hcnJheS5rZXlTb3J0KCBteUFycmF5LCAiYWJjIiApOyAgICAgICAgICAgLy8gW3thYmM6IDIsIHh5ejogNX0sIHthYmM6IDEyMzEyNCwgeHl6OiA1fSwge2FiYzogMTIzMTI0LCB4eXo6IDZ9XTsKCSAqIGtlaWdhaS51dGlsLmFycmF5LmtleVNvcnQoIG15QXJyYXksICJhYmMsIHh5eiBkZXNjIiApOyAvLyBbe2FiYzogMiwgeHl6OiA1fSwge2FiYzogMTIzMTI0LCB4eXo6IDZ9LCB7YWJjOiAxMjMxMjQsIHh5ejogNX1dOwoJICovCglrZXlTb3J0IDogZnVuY3Rpb24gKCBvYmosIHF1ZXJ5LCBzdWIgKSB7CgkJcXVlcnkgICAgICAgPSBxdWVyeS5yZXBsYWNlKCAvXHMqYXNjL2lnLCAiIiApLnJlcGxhY2UoIC9ccypkZXNjL2lnLCAiIGRlc2MiICk7CgkJdmFyIHF1ZXJpZXMgPSBzdHJpbmcuZXhwbG9kZSggcXVlcnkgKS5tYXAoIGZ1bmN0aW9uICggaSApIHsgcmV0dXJuIGkuc3BsaXQoICIgIiApOyB9ICksCgkJICAgIHNvcnRzICAgPSBbXSwKCQkgICAgYnJhY2VTICA9ICJbXCIiLAoJCSAgICBicmFjZUUgID0gIlwiXSI7CgoJCWlmICggc3ViICYmIHN1YiAhPT0gIiIgKSB7CgkJCXN1YiA9ICIuIiArIHN1YjsKCQl9CgkJZWxzZSB7CgkJCXN1YiA9ICIiOwoJCX0KCgkJYXJyYXkuZWFjaCggcXVlcmllcywgZnVuY3Rpb24gKCBpICkgewoJCQl2YXIgcyA9ICIuIiwKCQkJICAgIGUgPSAiIjsKCgkJCWlmICggcmVnZXgubm90X2RvdG5vdGF0aW9uLnRlc3QoIGlbMF0gKSApIHsKCQkJCXMgPSBicmFjZVM7CgkJCQllID0gYnJhY2VFOwoJCQl9CgoJCQlzb3J0cy5wdXNoKCAidHJ5IHsiICk7CgoJCQlpZiAoIGlbMV0gPT09ICJkZXNjIiApIHsKCQkJCXNvcnRzLnB1c2goICJpZiAoIGEiICsgc3ViICsgcyArIGlbMF0gKyBlICsgIiA8IGIiICsgc3ViICsgcyArIGlbMF0gKyBlICsgIiApIHJldHVybiAxOyIgKTsKCQkJCXNvcnRzLnB1c2goICJpZiAoIGEiICsgc3ViICsgcyArIGlbMF0gKyBlICsgIiA+IGIiICsgc3ViICsgcyArIGlbMF0gKyBlICsgIiApIHJldHVybiAtMTsiICk7CgkJCX0KCQkJZWxzZSB7CgkJCQlzb3J0cy5wdXNoKCAiaWYgKCBhIiArIHN1YiArIHMgKyBpWzBdICsgZSArICIgPCBiIiArIHN1YiArIHMgKyBpWzBdICsgZSArICIgKSByZXR1cm4gLTE7IiApOwoJCQkJc29ydHMucHVzaCggImlmICggYSIgKyBzdWIgKyBzICsgaVswXSArIGUgKyAiID4gYiIgKyBzdWIgKyBzICsgaVswXSArIGUgKyAiICkgcmV0dXJuIDE7IiApOwoJCQl9CgoJCQlzb3J0cy5wdXNoKCAifSBjYXRjaCAoZSkgeyIgKTsKCQkJc29ydHMucHVzaCggInRyeSB7IiApOwoJCQlzb3J0cy5wdXNoKCAiaWYgKCBhIiArIHN1YiArIHMgKyBpWzBdICsgZSArICIgIT09IHVuZGVmaW5lZCApIHJldHVybiAiICsgKCBpWzFdID09PSAiZGVzYyIgPyAiLTEiIDogIjEiKSArICI7IiApOwoJCQlzb3J0cy5wdXNoKCAifSBjYXRjaCAoZSkge30iICk7CgkJCXNvcnRzLnB1c2goICJ0cnkgeyIgKTsKCQkJc29ydHMucHVzaCggImlmICggYiIgKyBzdWIgKyBzICsgaVswXSArIGUgKyAiICE9PSB1bmRlZmluZWQgKSByZXR1cm4gIiArICggaVsxXSA9PT0gImRlc2MiID8gIjEiIDogIi0xIikgKyAiOyIgKTsKCQkJc29ydHMucHVzaCggIn0gY2F0Y2ggKGUpIHt9IiApOwoJCQlzb3J0cy5wdXNoKCAifSIgKTsKCQl9ICk7CgoJCXNvcnRzLnB1c2goICJyZXR1cm4gMDsiICk7CgoJCXJldHVybiBvYmouc29ydCggbmV3IEZ1bmN0aW9uKCAiYSIsICJiIiwgc29ydHMuam9pbiggIlxuIiApICkgKTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIHRoZSBsYXN0IGluZGV4IG9mIHRoZSBBcnJheQoJICoKCSAqIEBtZXRob2QgbGFzdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gIG9iaiBBcnJheQoJICogQHBhcmFtICB7TnVtYmVyfSBhcmcgW09wdGlvbmFsXSBOZWdhdGl2ZSBvZmZzZXQgZnJvbSBsYXN0IGluZGV4IHRvIHJldHVybgoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgTGFzdCBpbmRleCggcyApIG9mIEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbMSwgMiwgMywgNF07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkubGFzdCggbXlBcnJheSApOyAgICAvLyA0CgkgKiBrZWlnYWkudXRpbC5hcnJheS5sYXN0KCBteUFycmF5LCAyICk7IC8vIFszLCA0XQoJICovCglsYXN0IDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQl2YXIgbiA9IG9iai5sZW5ndGggLSAxOwoKCQlpZiAoIGFyZyA+PSAoIG4gKyAxICkgKSB7CgkJCXJldHVybiBvYmo7CgkJfQoJCWVsc2UgaWYgKCBpc05hTiggYXJnICkgfHwgYXJnID09PSAxICkgewoJCQlyZXR1cm4gb2JqW25dOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIGFycmF5LmxpbWl0KCBvYmosICggbiAtICggLS1hcmcgKSApLCBuICk7CgkJfQoJfSwKCgkvKioKCSAqIFJldHVybnMgYSBsaW1pdGVkIHJhbmdlIG9mIGluZGljZXMgZnJvbSB0aGUgQXJyYXkKCSAqCgkgKiBAbWV0aG9kIGxpbWl0CgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgb2JqICAgIEFycmF5IHRvIGl0ZXJhdGUKCSAqIEBwYXJhbSAge051bWJlcn0gc3RhcnQgIFN0YXJ0aW5nIGluZGV4CgkgKiBAcGFyYW0gIHtOdW1iZXJ9IG9mZnNldCBOdW1iZXIgb2YgaW5kaWNlcyB0byByZXR1cm4KCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgIEFycmF5IG9mIGluZGljZXMKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSA9IFsxLCAyLCAzLCA0XTsKCSAqCgkgKiBrZWlnYWkudXRpbC5hcnJheS5saW1pdCggbXlBcnJheSwgMCwgMiApOyAvLyBbMSwgMl0KCSAqIGtlaWdhaS51dGlsLmFycmF5LmxpbWl0KCBteUFycmF5LCAyLCAyICk7IC8vIFszLCA0XQoJICovCglsaW1pdCA6IGZ1bmN0aW9uICggb2JqLCBzdGFydCwgb2Zmc2V0ICkgewoJCXZhciByZXN1bHQgPSBbXSwKCQkgICAgaSAgICAgID0gc3RhcnQgLSAxLAoJCSAgICBudGggICAgPSBzdGFydCArIG9mZnNldCwKCQkgICAgbWF4ICAgID0gb2JqLmxlbmd0aDsKCgkJaWYgKCBtYXggPiAwICkgewoJCQl3aGlsZSAoICsraSA8IG50aCAmJiBpIDwgbWF4ICkgewoJCQkJcmVzdWx0LnB1c2goIG9ialtpXSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIEZpbmRzIHRoZSBtYXhpbXVtIHZhbHVlIGluIGFuIEFycmF5CgkgKgoJICogQG1ldGhvZCBtYXgKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBwcm9jZXNzCgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgIE51bWJlciwgU3RyaW5nLCBldGMuCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkubWF4KCBbNSwgMywgOSwgMSwgNF0gKTsgLy8gOQoJICovCgltYXggOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gYXJyYXkubGFzdCggb2JqLnNvcnQoIGFycmF5LnNvcnQgKSApOwoJfSwKCgkvKioKCSAqIEZpbmRzIHRoZSBtZWFuIG9mIGFuIEFycmF5ICggb2YgbnVtYmVycyApCgkgKgoJICogQG1ldGhvZCBtZWFuCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gcHJvY2VzcwoJICogQHJldHVybiB7TnVtYmVyfSAgICBNZWFuIG9mIHRoZSBBcnJheSAoIGZsb2F0IG9yIGludGVnZXIgKQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5Lm1lYW4oIFsxLCAzLCA1XSApOyAvLyAzCgkgKi8KCW1lYW4gOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gb2JqLmxlbmd0aCA+IDAgPyAoIGFycmF5LnN1bSggb2JqICkgLyBvYmoubGVuZ3RoICkgOiB1bmRlZmluZWQ7Cgl9LAoKCS8qKgoJICogRmluZHMgdGhlIG1lZGlhbiB2YWx1ZSBvZiBhbiBBcnJheSAoIG9mIG51bWJlcnMgKQoJICoKCSAqIEBtZXRob2QgbWVkaWFuCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gcHJvY2VzcwoJICogQHJldHVybiB7TnVtYmVyfSAgICBNZWRpYW4gbnVtYmVyIG9mIHRoZSBBcnJheSAoIGZsb2F0IG9yIGludGVnZXIgKQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5Lm1lZGlhbiggWzUsIDEsIDMsIDhdICk7IC8vIDQKCSAqIGtlaWdhaS51dGlsLmFycmF5Lm1lZGlhbiggWzUsIDEsIDNdICk7ICAgIC8vIDMKCSAqLwoJbWVkaWFuIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJdmFyIG50aCAgICA9IG9iai5sZW5ndGgsCgkJICAgIG1pZCAgICA9IG51bWJlci5yb3VuZCggbnRoIC8gMiwgImRvd24iICksCgkJICAgIHNvcnRlZCA9IG9iai5zb3J0KCBhcnJheS5zb3J0ICk7CgoJCXJldHVybiBudW1iZXIub2RkKCBudGggKSA/IHNvcnRlZFttaWRdIDogKCAoIHNvcnRlZFttaWQgLSAxXSArIHNvcnRlZFttaWRdICkgLyAyICk7Cgl9LAoKCS8qKgoJICogTWVyZ2VzIGBhcmdgIGludG8gYG9iamAsIGV4Y2x1ZGluZyBkdXBsaWNhdGUgaW5kaWNlcwoJICoKCSAqIEBtZXRob2QgbWVyZ2UKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iajEgQXJyYXkgdG8gcmVjZWl2ZSBpbmRpY2VzCgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMiBBcnJheSB0byBtZXJnZQoJICogQHJldHVybiB7QXJyYXl9ICAgICAgRmlyc3QgYXJndW1lbnQKCSAqIEBleGFtcGxlCgkgKiB2YXIgYSA9IFsiYSIsICJiIiwgImMiXSwKCSAqICAgICBiID0gWyJkIl07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkubWVyZ2UoIGEsIGIgKTsKCSAqIGFbM107IC8vICJkIgoJICovCgltZXJnZSA6IGZ1bmN0aW9uICggb2JqMSwgb2JqMiApIHsKCQlhcnJheS5lYWNoKCBvYmoyLCBmdW5jdGlvbiAoIGkgKSB7CgkJCWFycmF5LmFkZCggb2JqMSwgaSApOwoJCX0gKTsKCgkJcmV0dXJuIG9iajE7Cgl9LAoKCS8qKgoJICogRmluZHMgdGhlIG1pbmltdW0gdmFsdWUgaW4gYW4gQXJyYXkKCSAqCgkgKiBAbWV0aG9kIG1pbgoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqIEFycmF5IHRvIHByb2Nlc3MKCSAqIEByZXR1cm4ge01peGVkfSAgICAgTnVtYmVyLCBTdHJpbmcsIGV0Yy4KCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5taW4oIFs1LCAzLCA5LCAxLCA0XSApOyAvLyAxCgkgKi8KCW1pbiA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBvYmouc29ydCggYXJyYXkuc29ydCApWzBdOwoJfSwKCgkvKioKCSAqIE1pbmdsZXMgQXJyYXlzIGFuZCByZXR1cm5zIGEgMkQgQXJyYXkKCSAqCgkgKiBAbWV0aG9kIG1pbmdsZQoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMSBBcnJheSB0byBtaW5nbGUKCSAqIEBwYXJhbSAge0FycmF5fSBvYmoyIEFycmF5IHRvIG1pbmdsZQoJICogQHJldHVybiB7QXJyYXl9ICAgICAgMkQgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiB2YXIgYSA9IFsiYSIsICJiIl0sCgkgKiAgICAgYiA9IFsiYyIsICJkIl07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkubWluZ2xlKCBhLCBiICk7IC8vIFtbImEiLCAiYyJdLCBbImIiLCAiZCJdXQoJICovCgltaW5nbGUgOiBmdW5jdGlvbiAoIG9iajEsIG9iajIgKSB7CgkJdmFyIHJlc3VsdDsKCgkJcmVzdWx0ID0gb2JqMS5tYXAoIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCQlyZXR1cm4gW2ksIG9iajJbaWR4XV07CgkJfSApOwoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIEZpbmRzIHRoZSBtb2RlIHZhbHVlIG9mIGFuIEFycmF5CgkgKgoJICogQG1ldGhvZCBtb2RlCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gcHJvY2VzcwoJICogQHJldHVybiB7TWl4ZWR9ICAgICBNb2RlIHZhbHVlIG9mIHRoZSBBcnJheQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5Lm1vZGUoIFsxLCAzLCA3LCAxLCAyLCAxMCwgNywgNywgMywgMTBdICk7ICAgICAvLyA3CgkgKiBrZWlnYWkudXRpbC5hcnJheS5tb2RlKCBbMSwgMywgNywgMSwgMiwgMTAsIDcsIDcsIDMsIDEwLCAxMF0gKTsgLy8gWzcsIDEwXQoJICovCgltb2RlIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJdmFyIHZhbHVlcyA9IHt9LAoJCSAgICBjb3VudCAgPSAwLAoJCSAgICBtb2RlICAgPSBbXSwKCQkgICAgbnRoLCByZXN1bHQ7CgoJCS8vIENvdW50aW5nIHZhbHVlcwoJCWFycmF5LmVhY2goIG9iaiwgZnVuY3Rpb24gKCBpICkgewoJCQlpZiAoICFpc05hTiggdmFsdWVzW2ldICkgKSB7CgkJCQl2YWx1ZXNbaV0rKzsKCQkJfQoJCQllbHNlIHsKCQkJCXZhbHVlc1tpXSA9IDE7CgkJCX0KCQl9ICk7CgoJCS8vIEZpbmRpbmcgdGhlIGhpZ2hlc3Qgb2NjdXJyaW5nIGNvdW50CgkJY291bnQgPSBhcnJheS5tYXgoIGFycmF5LmNhc3QoIHZhbHVlcyApICk7CgoJCS8vIEZpbmRpbmcgdmFsdWVzIHRoYXQgbWF0Y2ggdGhlIGNvdW50CgkJdXRpbGl0eS5pdGVyYXRlKCB2YWx1ZXMsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJaWYgKCB2ID09PSBjb3VudCApIHsKCQkJCW1vZGUucHVzaCggbnVtYmVyLnBhcnNlKCBrICkgKTsKCQkJfQoJCX0gKTsKCgkJLy8gRGV0ZXJtaW5pbmcgdGhlIHJlc3VsdAoJCW50aCA9IG1vZGUubGVuZ3RoOwoKCQlpZiAoIG50aCA+IDAgKSB7CgkJCXJlc3VsdCA9IG50aCA9PT0gMSA/IG1vZGVbMF0gOiBtb2RlOwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGFuIEFycmF5IG9mIHBlcmNlbnRhZ2VzIGZyb20gYW4gQXJyYXkgb2YgTnVtYmVycyAoaW50cy9mbG9hdHMpCgkgKgoJICogQG1ldGhvZCBwZXJjZW50cwoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gIG9iaiAgICAgICBBcnJheSB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IHByZWNpc2lvbiBbT3B0aW9uYWxdIFJvdW5kaW5nIHByZWNpc2lvbgoJICogQHBhcmFtICB7TnVtYmVyfSB0b3RhbCAgICAgW09wdGlvbmFsXSBWYWx1ZSB0byBjb21wYXJlIGFnYWluc3QKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgICAgIEFycmF5IG9mIHBlcmNlbnRzCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkucGVyY2VudHMoIFsxLCAyLCAzLCAzN10gKTsgLy8gWzIsIDUsIDcsIDg2XQoJICovCglwZXJjZW50cyA6IGZ1bmN0aW9uICggb2JqLCBwcmVjaXNpb24sIHRvdGFsICkgewoJCXZhciByZXN1bHQgPSBbXSwKCQkgICAgY3VzdG9tID0gZmFsc2UsCgkJICAgIGxhc3QsIHBhZGRpbmcsIHN1bTsKCgkJcHJlY2lzaW9uID0gcHJlY2lzaW9uIHx8IDA7CgkJCgkJaWYgKCB0b3RhbCA9PT0gdW5kZWZpbmVkICkgewoJCQl0b3RhbCA9IGFycmF5LnN1bSggb2JqICk7CgkJfQoJCWVsc2UgewoJCQljdXN0b20gPSB0cnVlOwoJCX0KCgkJYXJyYXkuZWFjaCggb2JqLCBmdW5jdGlvbiAoIGkgKSB7CgkJCXJlc3VsdC5wdXNoKCBudW1iZXIucGFyc2UoICggKCBpIC8gdG90YWwgKSAqIDEwMCApLnRvRml4ZWQoIHByZWNpc2lvbiApICkgKTsKCQl9ICk7CgoJCS8vIERlYWxpbmcgd2l0aCB0aGUgYXdlc29tZW5lc3Mgb2YgSmF2YVNjcmlwdCAiaW50ZWdlcnMiCgkJaWYgKCAhY3VzdG9tICkgewoJCQlzdW0gPSBhcnJheS5zdW0oIHJlc3VsdCApOwoKCQkJaWYgKCBzdW0gPCAxMDAgKSB7CgkJCQlwYWRkaW5nID0gbnVtYmVyLnBhcnNlKCBudW1iZXIuZGlmZiggc3VtLCAxMDAgKS50b0ZpeGVkKCBwcmVjaXNpb24gKSApOwoJCQkJbGFzdCAgICA9IGFycmF5Lmxhc3QoIHJlc3VsdCApICsgcGFkZGluZzsKCQkJCXJlc3VsdFtyZXN1bHQubGVuZ3RoIC0gMV0gPSBsYXN0OwoJCQl9CgkJCWVsc2UgaWYgKCBzdW0gPiAxMDAgKSB7CgkJCQlwYWRkaW5nID0gbnVtYmVyLnBhcnNlKCBudW1iZXIuZGlmZiggc3VtLCAxMDAgKS50b0ZpeGVkKCBwcmVjaXNpb24gKSApOwoJCQkJbGFzdCAgICA9IG51bWJlci5wYXJzZSggKCBhcnJheS5sYXN0KCByZXN1bHQgKSAtIHBhZGRpbmcgKS50b0ZpeGVkKCBwcmVjaXNpb24gKSApOwoJCQkJcmVzdWx0W3Jlc3VsdC5sZW5ndGggLSAxXSA9IGxhc3Q7CgkJCX0KCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogRmluZHMgdGhlIHJhbmdlIG9mIHRoZSBBcnJheSAoIG9mIG51bWJlcnMgKSB2YWx1ZXMKCSAqCgkgKiBAbWV0aG9kIHJhbmdlCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gcHJvY2VzcwoJICogQHJldHVybiB7TnVtYmVyfSAgICBSYW5nZSBvZiB0aGUgYXJyYXkgKCBmbG9hdCBvciBpbnRlZ2VyICkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5yYW5nZSggWzUsIDEsIDMsIDhdICk7IC8vIDcKCSAqLwoJcmFuZ2UgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gYXJyYXkubWF4KCBvYmogKSAtIGFycmF5Lm1pbiggb2JqICk7Cgl9LAoKCS8qKgoJICogU2VhcmNoZXMgYSAyRCBBcnJheSBgb2JqYCBmb3IgdGhlIGZpcnN0IG1hdGNoIG9mIGBhcmdgIGFzIGEgc2Vjb25kIGluZGV4CgkgKgoJICogQG1ldGhvZCByYXNzb2MKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiAyRCBBcnJheSB0byBzZWFyY2gKCSAqIEBwYXJhbSAge01peGVkfSBhcmcgUHJpbWl0aXZlIHRvIGZpbmQKCSAqIEByZXR1cm4ge01peGVkfSAgICAgQXJyYXkgb3IgdW5kZWZpbmVkCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkucmFzc29jKCBbWzEsIDNdLCBbNywgMl0sIFs0LCAzXV0sIDMgKTsgLy8gWzEsIDNdCgkgKi8KCXJhc3NvYyA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJdmFyIHJlc3VsdDsKCgkJYXJyYXkuZWFjaCggb2JqLCBmdW5jdGlvbiAoIGksIGlkeCApIHsKCQkJaWYgKCBpWzFdID09PSBhcmcgKSB7CgkJCQlyZXN1bHQgPSBvYmpbaWR4XTsKCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9ICk7CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogUmV0dXJucyBBcnJheSBjb250YWluaW5nIHRoZSBpdGVtcyBpbiBgb2JqYCBmb3Igd2hpY2ggYGZuKClgIGlzIG5vdCB0cnVlCgkgKgoJICogQG1ldGhvZCByZWplY3QKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9ICAgIG9iaiBBcnJheSB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZm4gIEZ1bmN0aW9uIHRvIGV4ZWN1dGUgYWdhaW5zdCBgb2JqYCBpbmRpY2VzCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgIEFycmF5IG9mIGluZGljZXMgd2hpY2ggZm4oKSBpcyBub3QgdHJ1ZQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LnJlamVjdCggWzAsIDEsIDIsIDMsIDQsIDVdLCBmdW5jdGlvbiAoIGkgKSB7IHJldHVybiBpICUgMiA+IDA7IH0gKTsgLy8gWzAsIDIsIDRdCgkgKi8KCXJlamVjdCA6IGZ1bmN0aW9uICggb2JqLCBmbiApIHsKCQlyZXR1cm4gYXJyYXkuZGlmZiggb2JqLCBvYmouZmlsdGVyKCBmbiApICk7Cgl9LAoKCS8qKgoJICogUmVtb3ZlcyBpbmRpY2VzIGZyb20gYW4gQXJyYXkgd2l0aG91dCByZWNyZWF0aW5nIGl0CgkgKgoJICogQG1ldGhvZCByZW1vdmUKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9ICBvYmogICBBcnJheSB0byByZW1vdmUgZnJvbQoJICogQHBhcmFtICB7TWl4ZWR9ICBzdGFydCBTdGFydGluZyBpbmRleCwgb3IgdmFsdWUgdG8gZmluZCB3aXRoaW4gb2JqCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGVuZCAgIFtPcHRpb25hbF0gRW5kaW5nIGluZGV4CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgIE1vZGlmaWVkIEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbImEiLCAiYiIsICJjIiwgImQiLCAiZSJdOwoJICoKCSAqIGtlaWdhaS51dGlsLmFycmF5LnJlbW92ZSggbXlBcnJheSwgMiwgMyApOwoJICogbXlBcnJheVsyXTsgLy8gImUiCgkgKi8KCXJlbW92ZSA6IGZ1bmN0aW9uICggb2JqLCBzdGFydCwgZW5kICkgewoJCWlmICggaXNOYU4oIHN0YXJ0ICkgKSB7CgkJCXN0YXJ0ID0gb2JqLmluZGV4T2YoIHN0YXJ0ICk7CgoJCQlpZiAoIHN0YXJ0ID09PSAtMSApIHsKCQkJCXJldHVybiBvYmo7CgkJCX0KCQl9CgkJZWxzZSB7CgkJCXN0YXJ0ID0gc3RhcnQgfHwgMDsKCQl9CgoJCXZhciBsZW5ndGggICAgPSBvYmoubGVuZ3RoLAoJCSAgICByZW1haW5pbmcgPSBvYmouc2xpY2UoICggZW5kIHx8IHN0YXJ0ICkgKyAxIHx8IGxlbmd0aCApOwoKCQlvYmoubGVuZ3RoID0gc3RhcnQgPCAwID8gKCBsZW5ndGggKyBzdGFydCApIDogc3RhcnQ7CgkJb2JqLnB1c2guYXBwbHkoIG9iaiwgcmVtYWluaW5nICk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogRGVsZXRlcyBldmVyeSBlbGVtZW50IG9mIGBvYmpgIGZvciB3aGljaCBgZm5gIGV2YWx1YXRlcyB0byB0cnVlCgkgKgoJICogQG1ldGhvZCByZW1vdmVJZgoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gICAgb2JqIEFycmF5IHRvIGl0ZXJhdGUKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiAgRnVuY3Rpb24gdG8gdGVzdCBpbmRpY2VzIGFnYWluc3QKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSA9IFsiYSIsICJiIiwgImMiXTsKCSAqCgkgKiBrZWlnYWkudXRpbC5hcnJheS5yZW1vdmVJZiggbXlBcnJheSwgZnVuY3Rpb24gKCBpICkgeyByZXR1cm4gL2F8Yy8udGVzdCggaSApOyB9ICk7CgkgKiBteUFycmF5WzBdOyAvLyAiYiIKCSAqLwoJcmVtb3ZlSWYgOiBmdW5jdGlvbiAoIG9iaiwgZm4gKSB7CgkJdmFyIHJlbW92ZTsKCgkJaWYgKCB0eXBlb2YgZm4gIT0gImZ1bmN0aW9uIiApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQlyZW1vdmUgPSBvYmouZmlsdGVyKCBmbiApOwoKCQlhcnJheS5lYWNoKCByZW1vdmUsIGZ1bmN0aW9uICggaSApIHsKCQkJYXJyYXkucmVtb3ZlKCBvYmosIGFycmF5LmluZGV4ICggb2JqLCBpICkgKTsKCQl9ICk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogRGVsZXRlcyBlbGVtZW50cyBvZiBgb2JqYCB1bnRpbCBgZm5gIGV2YWx1YXRlcyB0byBmYWxzZQoJICoKCSAqIEBtZXRob2QgcmVtb3ZlV2hpbGUKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9ICAgIG9iaiBBcnJheSB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZm4gIEZ1bmN0aW9uIHRvIHRlc3QgaW5kaWNlcyBhZ2FpbnN0CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgIEFycmF5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbImEiLCAiYiIsICJjIl07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkucmVtb3ZlV2hpbGUoIG15QXJyYXksIGZ1bmN0aW9uICggaSApIHsgcmV0dXJuIC9hfGMvLnRlc3QoIGkgKTsgfSApOwoJICogbXlBcnJheVswXTsgICAgIC8vICJiIgoJICogbXlBcnJheS5sZW5ndGg7IC8vIDIKCSAqLwoJcmVtb3ZlV2hpbGUgOiBmdW5jdGlvbiAoIG9iaiwgZm4gKSB7CgkJaWYgKCB0eXBlb2YgZm4gIT0gImZ1bmN0aW9uIiApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQl2YXIgcmVtb3ZlID0gW107CgoJCWFycmF5LmVhY2goIG9iaiwgZnVuY3Rpb24gKCBpICkgewoJCQlpZiAoIGZuKCBpICkgIT09IGZhbHNlICkgewoJCQkJcmVtb3ZlLnB1c2goIGkgKTsKCQkJfQoJCQllbHNlIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0gKTsKCgkJYXJyYXkuZWFjaCggcmVtb3ZlLCBmdW5jdGlvbiAoIGkgKSB7CgkJCWFycmF5LnJlbW92ZSggb2JqLCBhcnJheS5pbmRleCggb2JqLCBpICkgKTsKCQl9ICk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogUmVwbGFjZXMgdGhlIGNvbnRlbnRzIG9mIGBvYmpgIHdpdGggYGFyZ2AKCSAqCgkgKiBAbWV0aG9kIHJlcGxhY2UKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iajEgQXJyYXkgdG8gbW9kaWZ5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqMiBBcnJheSB0byB2YWx1ZXMgdG8gcHVzaCBpbnRvIGBvYmoxYAoJICogQHJldHVybiB7QXJyYXl9ICAgICAgQXJyYXkgdG8gbW9kaWZ5CgkgKiBAZXhhbXBsZQoJICogdmFyIG15QXJyYXkgPSBbImEiLCAiYiIsICJjIl07CgkgKgoJICoga2VpZ2FpLnV0aWwuYXJyYXkucmVwbGFjZSggbXlBcnJheSwgW3RydWUsIGZhbHNlXSApOwoJICogbXlBcnJheVswXTsgICAgIC8vIHRydWUKCSAqIG15QXJyYXkubGVuZ3RoOyAvLyAyCgkgKi8KCXJlcGxhY2UgOiBmdW5jdGlvbiAoIG9iajEsIG9iajIgKSB7CgkJYXJyYXkucmVtb3ZlKCBvYmoxLCAwLCBvYmoxLmxlbmd0aCApOwoJCWFycmF5LmVhY2goIG9iajIsIGZ1bmN0aW9uICggaSApIHsKCQkJb2JqMS5wdXNoKCBpICk7CgkJfSApOwoKCQlyZXR1cm4gb2JqMTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIHRoZSAicmVzdCIgb2YgYG9iamAgZnJvbSBgYXJnYAoJICoKCSAqIEBtZXRob2QgcmVzdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gIG9iaiBBcnJheSB0byBwcm9jZXNzCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGFyZyBbT3B0aW9uYWxdIFN0YXJ0IHBvc2l0aW9uIG9mIHN1YnNldCBvZiBgb2JqYCAoIHBvc2l0aXZlIG51bWJlciBvbmx5ICkKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgIEFycmF5IG9mIGEgc3Vic2V0IG9mIGBvYmpgCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkucmVzdCggWzEsIDIsIDMsIDQsIDUsIDZdICk7ICAgIC8vIFsyLCAzLCA0LCA1LCA2XQoJICoga2VpZ2FpLnV0aWwuYXJyYXkucmVzdCggWzEsIDIsIDMsIDQsIDUsIDZdLCAzICk7IC8vIFs0LCA1LCA2XQoJICovCglyZXN0IDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQlhcmcgPSBhcmcgfHwgMTsKCgkJaWYgKCBhcmcgPCAxICkgewoJCQlhcmcgPSAxOwoJCX0KCgkJcmV0dXJuIGFycmF5LmxpbWl0KCBvYmosIGFyZywgb2JqLmxlbmd0aCApOwoJfSwKCgkvKioKCSAqIEZpbmRzIHRoZSBsYXN0IGluZGV4IG9mIGBhcmdgIGluIGBvYmpgCgkgKgoJICogQG1ldGhvZCByaW5kZXgKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBzZWFyY2gKCSAqIEBwYXJhbSAge01peGVkfSBhcmcgUHJpbWl0aXZlIHRvIGZpbmQKCSAqIEByZXR1cm4ge01peGVkfSAgICAgSW5kZXggb3IgdW5kZWZpbmVkCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkucmluZGV4KCBbMSwgMiwgMywgMiwgMV0sIDIgKTsgLy8gMwoJICovCglyaW5kZXggOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCXZhciByZXN1bHQgPSAtMTsKCgkJYXJyYXkuZWFjaCggb2JqLCBmdW5jdGlvbiAoIGksIGlkeCApIHsKCQkJaWYgKCBpID09PSBhcmcgKSB7CgkJCQlyZXN1bHQgPSBpZHg7CgkJCX0KCQl9ICk7CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogUmV0dXJucyBuZXcgQXJyYXkgd2l0aCBgYXJnYCBtb3ZlZCB0byB0aGUgZmlyc3QgaW5kZXgKCSAqCgkgKiBAbWV0aG9kIHJvdGF0ZQoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gIG9iaiBBcnJheSB0byByb3RhdGUKCSAqIEBwYXJhbSAge051bWJlcn0gYXJnIEluZGV4IHRvIGJlY29tZSB0aGUgZmlyc3QgaW5kZXgsIGlmIG5lZ2F0aXZlIHRoZSByb3RhdGlvbiBpcyBpbiB0aGUgb3Bwb3NpdGUgZGlyZWN0aW9uCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICBOZXdseSByb3RhdGVkIEFycmF5CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkucm90YXRlKCBbMCwgMSwgMiwgMywgNF0sICAzIClbMF0gLy8gMjsKCSAqIGtlaWdhaS51dGlsLmFycmF5LnJvdGF0ZSggWzAsIDEsIDIsIDMsIDRdLCAtMiApWzBdIC8vIDM7CgkgKi8KCXJvdGF0ZSA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJdmFyIG50aCA9IG9iai5sZW5ndGgsCgkJICAgIHJlc3VsdDsKCgkJaWYgKCBhcmcgPT09IDAgKSB7CgkJCXJlc3VsdCA9IG9iajsKCQl9CgkJZWxzZSB7CgkJCWlmICggYXJnIDwgMCApIHsKCQkJCWFyZyArPSBudGg7CgkJCX0KCQkJZWxzZSB7CgkJCQlhcmctLTsKCQkJfQoKCQkJcmVzdWx0ID0gYXJyYXkubGltaXQoIG9iaiwgYXJnLCBudGggKTsKCQkJcmVzdWx0ID0gcmVzdWx0LmNvbmNhdCggYXJyYXkubGltaXQoIG9iaiwgMCwgYXJnICkgKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogR2VuZXJhdGVzIGEgc2VyaWVzIEFycmF5CgkgKgoJICogQG1ldGhvZCBzZXJpZXMKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7TnVtYmVyfSBzdGFydCAgU3RhcnQgdmFsdWUgdGhlIHNlcmllcwoJICogQHBhcmFtICB7TnVtYmVyfSBlbmQgICAgW09wdGlvbmFsXSBUaGUgZW5kIG9mIHRoZSBzZXJpZXMKCSAqIEBwYXJhbSAge051bWJlcn0gb2Zmc2V0IFtPcHRpb25hbF0gT2Zmc2V0IGZvciBpbmRpY2VzLCBkZWZhdWx0IGlzIDEKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgIEFycmF5IG9mIG5ldyBzZXJpZXMKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5zZXJpZXMoIDAsIDUgKTsgICAgIC8vIFswLCAxLCAyLCAzLCA0XQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuc2VyaWVzKCAwLCAyNSwgNSApOyAvLyBbMCwgNSwgMTAsIDE1LCAyMF0KCSAqLwoJc2VyaWVzIDogZnVuY3Rpb24gKCBzdGFydCwgZW5kLCBvZmZzZXQgKSB7CgkJc3RhcnQgICAgICA9IHN0YXJ0ICB8fCAwOwoJCWVuZCAgICAgICAgPSBlbmQgICAgfHwgc3RhcnQ7CgkJb2Zmc2V0ICAgICA9IG9mZnNldCB8fCAxOwoJCXZhciByZXN1bHQgPSBbXSwKCQkgICAgbiAgICAgID0gLTEsCgkJICAgIG50aCAgICA9IE1hdGgubWF4KCAwLCBNYXRoLmNlaWwoICggZW5kIC0gc3RhcnQgKSAvIG9mZnNldCApICk7CgoJCXdoaWxlICggKytuIDwgbnRoICkgewoJCQlyZXN1bHRbbl0gID0gc3RhcnQ7CgkJCXN0YXJ0ICAgICArPSBvZmZzZXQ7CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIFNvcnRzIHRoZSBBcnJheSBieSBwYXJzaW5nIHZhbHVlcwoJICoKCSAqIEBtZXRob2Qgc29ydAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtNaXhlZH0gYSBBcmd1bWVudCB0byBjb21wYXJlCgkgKiBAcGFyYW0gIHtNaXhlZH0gYiBBcmd1bWVudCB0byBjb21wYXJlCgkgKiBAcmV0dXJuIHtOdW1iZXJ9ICBOdW1iZXIgaW5kaWNhdGluZyBzb3J0IG9yZGVyCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuc29ydCggMiwgMyApOyAvLyAtMQoJICovCglzb3J0IDogZnVuY3Rpb24gKCBhLCBiICkgewoJCXZhciB0eXBlcyA9IHthOiB0eXBlb2YgYSwgYjogdHlwZW9mIGJ9LAoJCSAgICBjLCBkLCByZXN1bHQ7CgoJCWlmICggdHlwZXMuYSA9PT0gIm51bWJlciIgJiYgdHlwZXMuYiA9PT0gIm51bWJlciIgKSB7CgkJCXJlc3VsdCA9IGEgLSBiOwoJCX0KCQllbHNlIHsKCQkJYyA9IGEudG9TdHJpbmcoKTsKCQkJZCA9IGIudG9TdHJpbmcoKTsKCgkJCWlmICggYyA8IGQgKSB7CgkJCQlyZXN1bHQgPSAtMTsKCQkJfQoJCQllbHNlIGlmICggYyA+IGQgKSB7CgkJCQlyZXN1bHQgPSAxOwoJCQl9CgkJCWVsc2UgaWYgKCB0eXBlcy5hID09PSB0eXBlcy5iICkgewoJCQkJcmVzdWx0ID0gMDsKCQkJfQoJCQllbHNlIGlmICggdHlwZXMuYSA9PT0gImJvb2xlYW4iICkgewoJCQkJcmVzdWx0ID0gLTE7CgkJCX0KCQkJZWxzZSB7CgkJCQlyZXN1bHQgPSAxOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIFNvcnRzIGBvYmpgIHVzaW5nIGBhcnJheS5zb3J0YAoJICoKCSAqIEBtZXRob2Qgc29ydGVkCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gc29ydAoJICogQHJldHVybiB7QXJyYXl9ICAgICBTb3J0ZWQgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSA9IFs1LCA5LCAyLCA0XTsKCSAqCgkgKiBrZWlnYWkudXRpbC5hcnJheS5zb3J0ZWQoIG15QXJyYXkgKTsKCSAqIG15QXJyYXlbMF07IC8vIDIKCSAqLwoJc29ydGVkIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIG9iai5zb3J0KCBhcnJheS5zb3J0ICk7Cgl9LAoKCS8qKgoJICogU3BsaXRzIGFuIEFycmF5IGJ5IGRpdmlzb3IKCSAqCgkgKiBAbWV0aG9kIHNwbGl0CgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgb2JqICAgICBBcnJheSB0byBwcm9jZXNzCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGRpdmlzb3IgSW50ZWdlciB0byBkaXZpZGUgdGhlIEFycmF5IGJ5CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgICAgU3BsaXQgQXJyYXkKCSAqIEBleGFtcGxlCgkgKiB2YXIgbXlBcnJheSA9IFtdLAoJICogICAgIGkgICAgICAgPSAtMSwKCSAqICAgICByZXN1bHRzOwoJICoKCSAqIHdoaWxlICggKytpIDwgMTAwICkgewoJICogICBteUFycmF5LnB1c2goIGkgKyAxICk7CgkgKiB9CgkgKgoJICogcmVzdWx0cyA9IGtlaWdhaS51dGlsLmFycmF5LnNwbGl0KCBteUFycmF5LCAyMSApOwoJICogcmVzdWx0cy5sZW5ndGg7ICAgICAvLyAyMQoJICogcmVzdWx0c1swXS5sZW5ndGg7ICAvLyA1CgkgKiByZXN1bHRzWzE5XS5sZW5ndGg7IC8vIDQKCSAqIHJlc3VsdHNbMTldWzBdOyAgICAgLy8gOTkKCSAqIHJlc3VsdHNbMjBdLmxlbmd0aDsgLy8gMQoJICogcmVzdWx0c1syMF1bMF07ICAgICAvLyAxMDAKCSAqLwoJc3BsaXQgOiBmdW5jdGlvbiAoIG9iaiwgZGl2aXNvciApIHsKCQl2YXIgcmVzdWx0ICA9IFtdLAoJCSAgICB0b3RhbCAgID0gb2JqLmxlbmd0aCwKCQkgICAgbnRoICAgICA9IE1hdGguY2VpbCggdG90YWwgLyBkaXZpc29yICksCgkJICAgIGxvdyAgICAgPSBNYXRoLmZsb29yKCB0b3RhbCAvIGRpdmlzb3IgKSwKCQkgICAgbG93ZXIgICA9IE1hdGguY2VpbCggdG90YWwgLyBudGggKSwKCQkgICAgbG93ZXJlZCA9IGZhbHNlLAoJCSAgICBzdGFydCAgID0gMCwKCQkgICAgaSAgICAgICA9IC0xOwoKCQkvLyBGaW5kaW5nIHRoZSBmb2xkCgkJaWYgKCBudW1iZXIuZGlmZiggdG90YWwsICggZGl2aXNvciAqIG50aCApICkgPiBudGggKSB7CgkJCWxvd2VyID0gdG90YWwgLSAoIGxvdyAqIGRpdmlzb3IgKSArIGxvdyAtIDE7CgkJfQoJCWVsc2UgaWYgKCB0b3RhbCAlIGRpdmlzb3IgPiAwICYmIGxvd2VyICogbnRoID49IHRvdGFsICkgewoJCQlsb3dlci0tOwoJCX0KCgkJd2hpbGUgKCArK2kgPCBkaXZpc29yICkgewoJCQlpZiAoIGkgPiAwICkgewoJCQkJc3RhcnQgPSBzdGFydCArIG50aDsKCQkJfQoKCQkJaWYgKCAhbG93ZXJlZCAmJiBsb3dlciA8IGRpdmlzb3IgJiYgaSA9PT0gbG93ZXIgKSB7CgkJCQktLW50aDsKCQkJCWxvd2VyZWQgPSB0cnVlOwoJCQl9CgoJCQlyZXN1bHQucHVzaCggYXJyYXkubGltaXQoIG9iaiwgc3RhcnQsIG50aCApICk7CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIEZpbmRzIHRoZSBzdGFuZGFyZCBkZXZpYXRpb24gb2YgYW4gQXJyYXkgKCBvZiBudW1iZXJzICkKCSAqCgkgKiBAbWV0aG9kIHN0ZGRldgoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqIEFycmF5IHRvIHByb2Nlc3MKCSAqIEByZXR1cm4ge051bWJlcn0gICAgU3RhbmRhcmQgZGV2aWF0aW9uIG9mIHRoZSBBcnJheSAoIGZsb2F0IG9yIGludGVnZXIgKQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LnN0ZGRldiggWzEsIDMsIDVdICk7IC8vIDEuNjMyOTkzMTYxODU1NDUyCgkgKi8KCXN0ZGRldiA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBNYXRoLnNxcnQoIGFycmF5LnZhcmlhbmNlKCBvYmogKSApOwoJfSwKCgkvKioKCSAqIEdldHMgdGhlIHN1bW1hdGlvbiBvZiBhbiBBcnJheSBvZiBudW1iZXJzCgkgKgoJICogQG1ldGhvZCBzdW0KCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9IG9iaiBBcnJheSB0byBzdW0KCSAqIEByZXR1cm4ge051bWJlcn0gICAgU3VtbWF0aW9uIG9mIEFycmF5CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuYXJyYXkuc3VtKCBbMiwgNCwgMywgMV0gKTsgLy8gMTAKCSAqLwoJc3VtIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJdmFyIHJlc3VsdCA9IDA7CgoJCWlmICggb2JqLmxlbmd0aCA+IDAgKSB7CgkJCXJlc3VsdCA9IG9iai5yZWR1Y2UoIGZ1bmN0aW9uICggcHJldiwgY3VyICkgewoJCQkJcmV0dXJuIHByZXYgKyBjdXI7CgkJCX0gKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogVGFrZXMgdGhlIGZpcnN0IGBuYCBpbmRpY2VzIGZyb20gYG9iamAKCSAqCgkgKiBAbWV0aG9kIHRha2UKCSAqIEBtZW1iZXJPZiBhcnJheQoJICogQHBhcmFtICB7QXJyYXl9ICBvYmogQXJyYXkgdG8gcHJvY2VzcwoJICogQHBhcmFtICB7TnVtYmVyfSBuICAgT2Zmc2V0IGZyb20gMCB0byByZXR1cm4KCSAqIEByZXR1cm4ge0FycmF5fSAgICAgIFN1YnNldCBvZiBgb2JqYAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LnRha2UoIFsxLCAyLCAzLCA0XSwgMiApOyAvLyBbMSwgMl0KCSAqLwoJdGFrZSA6IGZ1bmN0aW9uICggb2JqLCBuICkgewoJCXJldHVybiBhcnJheS5saW1pdCggb2JqLCAwLCBuICk7Cgl9LAoKCS8qKgoJICogQ2FzdHMgYW4gQXJyYXkgdG8gT2JqZWN0CgkgKgoJICogQG1ldGhvZCB0b09iamVjdAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gYXIgQXJyYXkgdG8gdHJhbnNmb3JtCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgTmV3IG9iamVjdAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LnRvT2JqZWN0KCBbImFiYyIsICJkZWYiXSApOyAvLyB7MDogImFiYyIsIDE6ICJkZWYifQoJICovCgl0b09iamVjdCA6IGZ1bmN0aW9uICggYXIgKSB7CgkJdmFyIG9iaiA9IHt9LAoJCSAgICBpICAgPSBhci5sZW5ndGg7CgoJCXdoaWxlICggaS0tICkgewoJCQlvYmpbaS50b1N0cmluZygpXSA9IGFyW2ldOwoJCX0KCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBHZXRzIHRoZSB0b3RhbCBrZXlzIGluIGFuIEFycmF5CgkgKgoJICogQG1ldGhvZCB0b3RhbAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqIEFycmF5IHRvIGZpbmQgdGhlIGxlbmd0aCBvZgoJICogQHJldHVybiB7TnVtYmVyfSAgICBOdW1iZXIgb2Yga2V5cyBpbiBBcnJheQoJICogQGV4YW1wbGUKCSAqIHZhciBteUFycmF5ID0gW3RydWUsIHRydWUsIGZhbHNlXTsKCSAqCgkgKiBteUFycmF5LmV4dHJhID0gdHJ1ZTsKCSAqIGtlaWdhaS51dGlsLmFycmF5LnRvdGFsKCBteUFycmF5ICk7IC8vIDQKCSAqLwoJdG90YWwgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gYXJyYXkuaW5kZXhlZCggb2JqICkubGVuZ3RoOwoJfSwKCgkvKioKCSAqIFJldHVybnMgYW4gQXJyYXkgb2YgdW5pcXVlIGluZGljZXMgb2YgYG9iamAKCSAqCgkgKiBAbWV0aG9kIHVuaXF1ZQoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqIEFycmF5IHRvIHByb2Nlc3MKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgQXJyYXkgb2YgdW5pcXVlIGluZGljZXMKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS51bmlxdWUoIFsiYSIsICJiIiwgImEiLCAiYyIsICJiIiwgImQiXSApOyAvLyBbImEiLCAiYiIsICJjIiwgImQiXQoJICovCgl1bmlxdWUgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQl2YXIgcmVzdWx0ID0gW107CgoJCWFycmF5LmVhY2goIG9iaiwgZnVuY3Rpb24gKCBpICkgewoJCQlhcnJheS5hZGQoIHJlc3VsdCwgaSApOwoJCX0gKTsKCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBGaW5kcyB0aGUgdmFyaWFuY2Ugb2YgYW4gQXJyYXkgKCBvZiBudW1iZXJzICkKCSAqCgkgKiBAbWV0aG9kIHZhcmlhbmNlCgkgKiBAbWVtYmVyT2YgYXJyYXkKCSAqIEBwYXJhbSAge0FycmF5fSBvYmogQXJyYXkgdG8gcHJvY2VzcwoJICogQHJldHVybiB7TnVtYmVyfSAgICBWYXJpYW5jZSBvZiB0aGUgQXJyYXkgKCBmbG9hdCBvciBpbnRlZ2VyICkKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS52YXJpYW5jZSggWzEsIDMsIDVdICk7IC8vIDIuNjY2NjY2NjY2NjY2NjY2NQoJICovCgl2YXJpYW5jZSA6IGZ1bmN0aW9uICggb2JqICkgewoJCXZhciBudGggPSBvYmoubGVuZ3RoLAoJCSAgICBuICAgPSAwLAoJCSAgICBtZWFuOwoKCQlpZiAoIG50aCA+IDAgKSB7CgkJCW1lYW4gPSBhcnJheS5tZWFuKCBvYmogKTsKCgkJCWFycmF5LmVhY2goIG9iaiwgZnVuY3Rpb24gKCBpICkgewoJCQkJbiArPSBtYXRoLnNxciggaSAtIG1lYW4gKTsKCQkJfSApOwoKCQkJcmV0dXJuIG4gLyBudGg7CgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gbjsKCQl9Cgl9LAoKCS8qKgoJICogQ29udmVydHMgYW55IGFyZ3VtZW50cyB0byBBcnJheXMsIHRoZW4gbWVyZ2VzIGVsZW1lbnRzIG9mIGBvYmpgIHdpdGggY29ycmVzcG9uZGluZyBlbGVtZW50cyBmcm9tIGVhY2ggYXJndW1lbnQKCSAqCgkgKiBAbWV0aG9kIHppcAoJICogQG1lbWJlck9mIGFycmF5CgkgKiBAcGFyYW0gIHtBcnJheX0gb2JqICBBcnJheSB0byB0cmFuc2Zvcm0KCSAqIEBwYXJhbSAge01peGVkfSBhcmdzIEFyZ3VtZW50IGluc3RhbmNlIG9yIEFycmF5IHRvIG1lcmdlCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICBBcnJheQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmFycmF5LnppcCggWzAsIDFdLCAxICk7IC8vIFtbMCwgMV0sIFsxLCBudWxsXV0KCSAqLwoJemlwIDogZnVuY3Rpb24gKCBvYmosIGFyZ3MgKSB7CgkJdmFyIHJlc3VsdCA9IFtdOwoKCQkvLyBQcmVwYXJpbmcgYXJncwoJCWlmICggISggYXJncyBpbnN0YW5jZW9mIEFycmF5ICkgKSB7CgkJCWFyZ3MgPSB0eXBlb2YgYXJncyA9PSAib2JqZWN0IiA/IGFycmF5LmNhc3QoIGFyZ3MgKSA6IFthcmdzXTsKCQl9CgoJCWFycmF5LmVhY2goIGFyZ3MsIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCQlpZiAoICEoIGkgaW5zdGFuY2VvZiBBcnJheSApICkgewoJCQkJdGhpc1tpZHhdID0gW2ldOwoJCQl9CgkJfSApOwoKCQkvLyBCdWlsZGluZyByZXN1bHQgQXJyYXkKCQlhcnJheS5lYWNoKCBvYmosIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCQlyZXN1bHRbaWR4XSA9IFtpXTsKCQkJYXJyYXkuZWFjaCggYXJncywgZnVuY3Rpb24gKCB4ICkgewoJCQkJcmVzdWx0W2lkeF0ucHVzaCggeFtpZHhdIHx8IG51bGwgKTsKCQkJfSApOwoJCX0gKTsKCgkJcmV0dXJuIHJlc3VsdDsKCX0KfTsKCi8qKgogKiBAbmFtZXNwYWNlIGNhY2hlCiAqIEBwcml2YXRlCiAqLwp2YXIgY2FjaGUgPSB7CgkvKioKCSAqIENvbGxlY3Rpb24gVVJJcwoJICoKCSAqIEBtZW1iZXJPZiBjYWNoZQoJICogQHR5cGUge09iamVjdH0KCSAqLwoJbHJ1IDogbHJ1LmZhY3RvcnkoIENBQ0hFICksCgoJLyoqCgkgKiBHYXJiYWdlIGNvbGxlY3RvciBmb3IgdGhlIGNhY2hlZCBpdGVtcwoJICoKCSAqIEBtZXRob2QgY2xlYW4KCSAqIEBtZW1iZXJPZiBjYWNoZQoJICogQHJldHVybiB7VW5kZWZpbmVkfSB1bmRlZmluZWQKCSAqLwoJY2xlYW4gOiBmdW5jdGlvbiAoKSB7CgkJYXJyYXkuZWFjaCggYXJyYXkua2V5cyggY2FjaGUubHJ1LmNhY2hlICksIGZ1bmN0aW9uICggaSApIHsKCQkJaWYgKCBjYWNoZS5leHBpcmVkKCBpICkgKSB7CgkJCQljYWNoZS5leHBpcmUoIGkgKTsKCQkJfQoJCX0gKTsKCX0sCgoJLyoqCgkgKiBFeHBpcmVzIGEgVVJJIGZyb20gdGhlIGxvY2FsIGNhY2hlCgkgKgoJICogQG1ldGhvZCBleHBpcmUKCSAqIEBtZW1iZXJPZiBjYWNoZQoJICogQHBhcmFtICB7U3RyaW5nfSB1cmkgVVJJIG9mIHRoZSBsb2NhbCByZXByZXNlbnRhdGlvbgoJICogQHJldHVybiB7Qm9vbGVhbn0gYHRydWVgIGlmIHN1Y2Nlc3NmdWwKCSAqLwoJZXhwaXJlIDogZnVuY3Rpb24gKCB1cmkgKSB7CgkJaWYgKCBjYWNoZS5scnUuY2FjaGVbdXJpXSApIHsKCQkJY2FjaGUubHJ1LnJlbW92ZSggdXJpICk7CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCS8qKgoJICogRGV0ZXJtaW5lcyBpZiBhIFVSSSBoYXMgZXhwaXJlZAoJICoKCSAqIEBtZXRob2QgZXhwaXJlZAoJICogQG1lbWJlck9mIGNhY2hlCgkgKiBAcGFyYW0gIHtPYmplY3R9IHVyaSBDYWNoZWQgVVJJIG9iamVjdAoJICogQHJldHVybiB7Qm9vbGVhbn0gICAgVHJ1ZSBpZiB0aGUgVVJJIGhhcyBleHBpcmVkCgkgKi8KCWV4cGlyZWQgOiBmdW5jdGlvbiAoIHVyaSApIHsKCQl2YXIgaXRlbSA9IGNhY2hlLmxydS5jYWNoZVt1cmldOwoKCQlyZXR1cm4gaXRlbSAmJiBpdGVtLnZhbHVlLmV4cGlyZXMgPCBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIHRoZSBjYWNoZWQgb2JqZWN0IHtoZWFkZXJzLCByZXNwb25zZX0gb2YgdGhlIFVSSSBvciBmYWxzZQoJICoKCSAqIEBtZXRob2QgZ2V0CgkgKiBAbWVtYmVyT2YgY2FjaGUKCSAqIEBwYXJhbSAge1N0cmluZ30gIHVyaSAgICBVUkkvSWRlbnRpZmllciBmb3IgdGhlIHJlc291cmNlIHRvIHJldHJpZXZlIGZyb20gY2FjaGUKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGV4cGlyZSBbT3B0aW9uYWxdIElmICdmYWxzZScgdGhlIFVSSSB3aWxsIG5vdCBleHBpcmUKCSAqIEBwYXJhbSAge0Jvb2xlYW59IHNpbGVudCBbT3B0aW9uYWxdIElmICd0cnVlJywgdGhlIGV2ZW50IHdpbGwgbm90IGZpcmUKCSAqIEByZXR1cm4ge01peGVkfSAgICAgICAgICBVUkkgT2JqZWN0IHtoZWFkZXJzLCByZXNwb25zZX0gb3IgRmFsc2UKCSAqLwoJZ2V0IDogZnVuY3Rpb24gKCB1cmksIGV4cGlyZSApIHsKCQl1cmkgICAgICA9IHV0aWxpdHkucGFyc2UoIHVyaSApLmhyZWY7CgkJdmFyIGl0ZW0gPSBjYWNoZS5scnUuZ2V0KCB1cmkgKTsKCgkJaWYgKCAhaXRlbSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCBleHBpcmUgIT09IGZhbHNlICYmIGNhY2hlLmV4cGlyZWQoIHVyaSApICkgewoJCQljYWNoZS5leHBpcmUoIHVyaSApOwoKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJcmV0dXJuIHV0aWxpdHkuY2xvbmUoIGl0ZW0sIHRydWUgKTsKCX0sCgoJLyoqCgkgKiBTZXRzLCBvciB1cGRhdGVzIGFuIGl0ZW0gaW4gY2FjaGUuaXRlbXMKCSAqCgkgKiBAbWV0aG9kIHNldAoJICogQG1lbWJlck9mIGNhY2hlCgkgKiBAcGFyYW0gIHtTdHJpbmd9IHVyaSAgICAgIFVSSSB0byBzZXQgb3IgdXBkYXRlCgkgKiBAcGFyYW0gIHtTdHJpbmd9IHByb3BlcnR5IFByb3BlcnR5IG9mIHRoZSBjYWNoZWQgVVJJIHRvIHNldAoJICogQHBhcmFtICB7TWl4ZWR9IHZhbHVlICAgICBWYWx1ZSB0byBzZXQKCSAqIEByZXR1cm4ge01peGVkfSAgICAgICAgICAgVVJJIE9iamVjdCB7aGVhZGVycywgcmVzcG9uc2V9IG9yIHVuZGVmaW5lZAoJICovCglzZXQgOiBmdW5jdGlvbiAoIHVyaSwgcHJvcGVydHksIHZhbHVlICkgewoJCXVyaSAgICAgID0gdXRpbGl0eS5wYXJzZSggdXJpICkuaHJlZjsKCQl2YXIgaXRlbSA9IGNhY2hlLmxydS5nZXQoIHVyaSApOwoKCQlpZiAoICFpdGVtICkgewoJCQlpdGVtID0gewoJCQkJcGVybWlzc2lvbiA6IDAKCQkJfTsKCQl9CgoJCWlmICggcHJvcGVydHkgPT09ICJwZXJtaXNzaW9uIiApIHsKCQkJaXRlbS5wZXJtaXNzaW9uIHw9IHZhbHVlOwoJCX0KCQllbHNlIGlmICggcHJvcGVydHkgPT09ICIhcGVybWlzc2lvbiIgKSB7CgkJCWl0ZW0ucGVybWlzc2lvbiAmPSB+dmFsdWU7CgkJfQoJCWVsc2UgewoJCQlpdGVtW3Byb3BlcnR5XSA9IHZhbHVlOwoJCX0KCgkJY2FjaGUubHJ1LnNldCggdXJpLCBpdGVtICk7CgoJCXJldHVybiBpdGVtOwoJfQp9OwoKLyoqCiAqIEN1c3RvbSBPYmplY3QgcmV0dXJuZWQgZnJvbSBgY2xpZW50LnJlcXVlc3QoKWAKICoKICogQGNvbnN0cnVjdG9yCiAqIEBtZW1iZXJPZiBrZWlnYWkKICogQGV4dGVuZHMge2tlaWdhaS5CYXNlfQogKiBAcGFyYW0ge09iamVjdH0geGhyIFhNTEh0dHBSZXF1ZXN0CiAqLwpmdW5jdGlvbiBLWE1MSHR0cFJlcXVlc3QgKCB4aHIgKSB7Cgl0aGlzLm9ic2VydmVyID0gb2JzZXJ2YWJsZS5mYWN0b3J5KCk7Cgl0aGlzLmRlZmVyICAgID0gZGVmZXJyZWQuZmFjdG9yeSgpOwoJdGhpcy54aHIgICAgICA9IHhocjsKfQoKLyoqCiAqIEV4dGVuZGluZyBCYXNlCiAqCiAqIEBtZW1iZXJPZiBrZWlnYWkuS1hNTEh0dHBSZXF1ZXN0CiAqIEB0eXBlIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICovCktYTUxIdHRwUmVxdWVzdC5wcm90b3R5cGUgPSBiYXNlLmZhY3RvcnkoKTsKCi8qKgogKiBTZXR0aW5nIGNvbnN0cnVjdG9yIGxvb3AKICoKICogQG1ldGhvZCBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpLktYTUxIdHRwUmVxdWVzdAogKiBAdHlwZSB7RnVuY3Rpb259CiAqIEBwcml2YXRlCiAqLwpLWE1MSHR0cFJlcXVlc3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gS1hNTEh0dHBSZXF1ZXN0OwoKLyoqCiAqIEBuYW1lc3BhY2UgY2xpZW50CiAqLwp2YXIgY2xpZW50ID0gewoJLyoqCgkgKiBJbnRlcm5ldCBFeHBsb3JlciBicm93c2VyCgkgKgoJICogQG1lbWJlck9mIGNsaWVudAoJICogQHR5cGUge0Jvb2xlYW59CgkgKiBAcHJpdmF0ZQoJICovCglpZSA6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gIXNlcnZlciAmJiByZWdleC5pZS50ZXN0KCBuYXZpZ2F0b3IudXNlckFnZW50ICk7Cgl9KCksCgoJLyoqCgkgKiBDbGllbnQgdmVyc2lvbgoJICoKCSAqIEBtZW1iZXJPZiBjbGllbnQKCSAqIEB0eXBlIHtOdW1iZXJ9CgkgKiBAcHJpdmF0ZQoJICovCgl2ZXJzaW9uIDogZnVuY3Rpb24gKCkgewoJCXZhciB2ZXJzaW9uID0gMDsKCgkJaWYgKCB0aGlzLmllICkgewoJCQl2ZXJzaW9uID0gbmF2aWdhdG9yLnVzZXJBZ2VudC5yZXBsYWNlKC8oLiptc2llfDsuKikvZ2ksICIiKTsKCQkJdmVyc2lvbiA9IG51bWJlci5wYXJzZSggc3RyaW5nLnRyaW0oIHZlcnNpb24gKSApOwoJCX0KCgkJcmV0dXJuIHZlcnNpb247Cgl9LAoKCS8qKgoJICogUXVpY2sgd2F5IHRvIHNlZSBpZiBhIFVSSSBhbGxvd3MgYSBzcGVjaWZpYyB2ZXJiCgkgKgoJICogQG1ldGhvZCBhbGxvd3MKCSAqIEBtZW1iZXJPZiBjbGllbnQKCSAqIEBwYXJhbSAge1N0cmluZ30gdXJpICBVUkkgdG8gcXVlcnkKCSAqIEBwYXJhbSAge1N0cmluZ30gdmVyYiBIVFRQIHZlcmIKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgICBgdHJ1ZWAgaWYgdGhlIHZlcmIgaXMgYWxsb3dlZCwgdW5kZWZpbmVkIGlmIHVua25vd24KCSAqIEBwcml2YXRlCgkgKi8KCWFsbG93cyA6IGZ1bmN0aW9uICggdXJpLCB2ZXJiICkgewoJCWlmICggc3RyaW5nLmlzRW1wdHkoIHVyaSApIHx8IHN0cmluZy5pc0VtcHR5KCB2ZXJiICkgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApOwoJCX0KCgkJdXJpICAgICAgICA9IHV0aWxpdHkucGFyc2UoIHVyaSApLmhyZWY7CgkJdmVyYiAgICAgICA9IHZlcmIudG9Mb3dlckNhc2UoKTsKCQl2YXIgcmVzdWx0ID0gZmFsc2UsCgkJICAgIGJpdCAgICA9IDA7CgoJCWlmICggIWNhY2hlLmdldCggdXJpLCBmYWxzZSApICkgewoJCQlyZXN1bHQgPSB1bmRlZmluZWQ7CgkJfQoJCWVsc2UgewoJCQlpZiAoIHJlZ2V4LmRlbC50ZXN0KCB2ZXJiICkgKSB7CgkJCQliaXQgPSAxOwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5nZXRfaGVhZGVycy50ZXN0KCB2ZXJiICkgKSB7CgkJCQliaXQgPSA0OwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5wdXRfcG9zdC50ZXN0KCB2ZXJiICkgKSB7CgkJCQliaXQgPSAyOwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5wYXRjaC50ZXN0KCB2ZXJiICkgKSB7CgkJCQliaXQgPSA4OwoJCQl9CgoJCQlyZXN1bHQgPSBCb29sZWFuKCBjbGllbnQucGVybWlzc2lvbnMoIHVyaSwgdmVyYiApLmJpdCAmIGJpdCApOwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBHZXRzIGJpdCB2YWx1ZSBiYXNlZCBvbiBhcmdzCgkgKgoJICogQG1ldGhvZCBiaXQKCSAqIEBtZW1iZXJPZiBjbGllbnQKCSAqIEBwYXJhbSAge0FycmF5fSBhcmdzIEFycmF5IG9mIGNvbW1hbmRzIHRoZSBVUkkgYWNjZXB0cwoJICogQHJldHVybiB7TnVtYmVyfSBUbyBiZSBzZXQgYXMgYSBiaXQKCSAqIEBwcml2YXRlCgkgKi8KCWJpdCA6IGZ1bmN0aW9uICggYXJncyApIHsKCQl2YXIgcmVzdWx0ID0gMDsKCgkJYXJyYXkuZWFjaCggYXJncywgZnVuY3Rpb24gKCB2ZXJiICkgewoJCQl2ZXJiID0gdmVyYi50b0xvd2VyQ2FzZSgpOwoKCQkJaWYgKCByZWdleC5nZXRfaGVhZGVycy50ZXN0KCB2ZXJiICkgKSB7CgkJCQlyZXN1bHQgfD0gNDsKCQkJfQoJCQllbHNlIGlmICggcmVnZXgucHV0X3Bvc3QudGVzdCggdmVyYiApICkgewoJCQkJcmVzdWx0IHw9IDI7CgkJCX0KCQkJZWxzZSBpZiAoIHJlZ2V4LnBhdGNoLnRlc3QoIHZlcmIgKSApIHsKCQkJCXJlc3VsdCB8PSA4OwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5kZWwudGVzdCggdmVyYiApICkgewoJCQkJcmVzdWx0IHw9IDE7CgkJCX0KCQl9ICk7CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogRGV0ZXJtaW5lcyBpZiBhIFVSSSBpcyBhIENPUlMgZW5kIHBvaW50CgkgKgoJICogQG1ldGhvZCBjb3JzCgkgKiBAbWVtYmVyT2YgY2xpZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IHVyaSAgVVJJIHRvIHBhcnNlCgkgKiBAcmV0dXJuIHtCb29sZWFufSAgICAgVHJ1ZSBpZiBDT1JTCgkgKiBAcHJpdmF0ZQoJICovCgljb3JzIDogZnVuY3Rpb24gKCB1cmkgKSB7CgkJcmV0dXJuICggIXNlcnZlciAmJiB1cmkuaW5kZXhPZiggIi8vIiApID4gLTEgJiYgdXJpLmluZGV4T2YoICIvLyIgKyBsb2NhdGlvbi5ob3N0ICkgPT09IC0xICk7Cgl9LAoKCS8qKgoJICogQ2FjaGVzIHRoZSBoZWFkZXJzIGZyb20gdGhlIFhIUiByZXNwb25zZQoJICoKCSAqIEBtZXRob2QgaGVhZGVycwoJICogQG1lbWJlck9mIGNsaWVudAoJICogQHBhcmFtICB7T2JqZWN0fSB4aHIgIFhNTEh0dHBSZXF1ZXN0IE9iamVjdAoJICogQHBhcmFtICB7U3RyaW5nfSB1cmkgIFVSSSB0byByZXF1ZXN0CgkgKiBAcGFyYW0gIHtTdHJpbmd9IHR5cGUgVHlwZSBvZiByZXF1ZXN0CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgQ2FjaGVkIFVSSSByZXByZXNlbnRhdGlvbgoJICogQHByaXZhdGUKCSAqLwoJaGVhZGVycyA6IGZ1bmN0aW9uICggeGhyLCB1cmksIHR5cGUgKSB7CgkJdmFyIGhlYWRlcnMgPSBzdHJpbmcudHJpbSggeGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpICkuc3BsaXQoICJcbiIgKSwKCQkgICAgaXRlbXMgICA9IHt9LAoJCSAgICBvICAgICAgID0ge30sCgkJICAgIGFsbG93ICAgPSBudWxsLAoJCSAgICBleHBpcmVzID0gbmV3IERhdGUoKSwKCQkgICAgY29ycyAgICA9IGNsaWVudC5jb3JzKCB1cmkgKTsKCgkJYXJyYXkuZWFjaCggaGVhZGVycywgZnVuY3Rpb24gKCBpICkgewoJCQl2YXIgaGVhZGVyID0gaS5zcGxpdCggIjogIiApOwoKCQkJaXRlbXNbaGVhZGVyWzBdLnRvTG93ZXJDYXNlKCldID0gc3RyaW5nLnRyaW0oIGhlYWRlclsxXSApOwoKCQkJaWYgKCBhbGxvdyA9PT0gbnVsbCApIHsKCQkJCWlmICggKCAhY29ycyAmJiByZWdleC5hbGxvdy50ZXN0KCBoZWFkZXIgKSApIHx8ICggY29ycyAmJiByZWdleC5hbGxvd19jb3JzLnRlc3QoIGhlYWRlciApICkgKSB7CgkJCQkJYWxsb3cgPSBoZWFkZXJbMV07CgkJCQl9CgkJCX0KCQl9ICk7CgoJCWlmICggcmVnZXgubm8udGVzdCggaXRlbXNbImNhY2hlLWNvbnRyb2wiXSApICkgewoJCQlleHBpcmVzID0gZXhwaXJlcy5nZXRUaW1lKCk7CgkJfQoJCWVsc2UgaWYgKCBpdGVtc1siY2FjaGUtY29udHJvbCJdICYmIHJlZ2V4Lm51bWJlcl9wcmVzZW50LnRlc3QoIGl0ZW1zWyJjYWNoZS1jb250cm9sIl0gKSApIHsKCQkJZXhwaXJlcyA9IGV4cGlyZXMuc2V0U2Vjb25kcyggZXhwaXJlcy5nZXRTZWNvbmRzKCkgKyBudW1iZXIucGFyc2UoIHJlZ2V4Lm51bWJlcl9wcmVzZW50LmV4ZWMoIGl0ZW1zWyJjYWNoZS1jb250cm9sIl0gKVswXSwgMTAgKSApOwoJCX0KCQllbHNlIGlmICggaXRlbXMuZXhwaXJlcyApIHsKCQkJZXhwaXJlcyA9IG5ldyBEYXRlKCBpdGVtcy5leHBpcmVzICkuZ2V0VGltZSgpOwoJCX0KCQllbHNlIHsKCQkJZXhwaXJlcyA9IGV4cGlyZXMuZ2V0VGltZSgpOwoJCX0KCgkJby5leHBpcmVzICAgID0gZXhwaXJlczsKCQlvLmhlYWRlcnMgICAgPSBpdGVtczsKCQlvLnRpbWVzdGFtcCAgPSBuZXcgRGF0ZSgpOwoJCW8ucGVybWlzc2lvbiA9IGNsaWVudC5iaXQoIGFsbG93ICE9PSBudWxsID8gc3RyaW5nLmV4cGxvZGUoIGFsbG93ICkgOiBbdHlwZV0gKTsKCgkJaWYgKCB0eXBlID09PSAiZ2V0IiApIHsKCQkJY2FjaGUuc2V0KCB1cmksICJleHBpcmVzIiwgICAgby5leHBpcmVzICk7CgkJCWNhY2hlLnNldCggdXJpLCAiaGVhZGVycyIsICAgIG8uaGVhZGVycyApOwoJCQljYWNoZS5zZXQoIHVyaSwgInRpbWVzdGFtcCIsICBvLnRpbWVzdGFtcCApOwoJCQljYWNoZS5zZXQoIHVyaSwgInBlcm1pc3Npb24iLCBvLnBlcm1pc3Npb24gKTsKCQl9CgoJCXJldHVybiBvOwoJfSwKCgkvKioKCSAqIFBhcnNlcyBhbiBYSFIgcmVzcG9uc2UKCSAqCgkgKiBAbWV0aG9kIHBhcnNlCgkgKiBAbWVtYmVyT2YgY2xpZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IHhociAgWEhSIE9iamVjdAoJICogQHBhcmFtICB7U3RyaW5nfSB0eXBlIFtPcHRpb25hbF0gY29udGVudC10eXBlIGhlYWRlciB2YWx1ZQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgIEFycmF5LCBCb29sZWFuLCBEb2N1bWVudCwgTnVtYmVyLCBPYmplY3Qgb3IgU3RyaW5nCgkgKiBAcHJpdmF0ZQoJICovCglwYXJzZSA6IGZ1bmN0aW9uICggeGhyLCB0eXBlICkgewoJCXR5cGUgPSB0eXBlIHx8ICIiOwoJCXZhciByZXN1bHQsIG9iajsKCgkJaWYgKCAoIHJlZ2V4Lmpzb25fbWF5YmUudGVzdCggdHlwZSApIHx8IHN0cmluZy5pc0VtcHR5KCB0eXBlICkgKSAmJiAoIHJlZ2V4Lmpzb25fd3JhcC50ZXN0KCB4aHIucmVzcG9uc2VUZXh0ICkgJiYgQm9vbGVhbiggb2JqID0ganNvbi5kZWNvZGUoIHhoci5yZXNwb25zZVRleHQsIHRydWUgKSApICkgKSB7CgkJCXJlc3VsdCA9IG9iajsKCQl9CgkJZWxzZSBpZiAoIHR5cGUgPT09ICJ0ZXh0L2NzdiIgKSB7CgkJCXJlc3VsdCA9IGNzdi5kZWNvZGUoIHhoci5yZXNwb25zZVRleHQgKTsKCQl9CgkJZWxzZSBpZiAoIHR5cGUgPT09ICJ0ZXh0L3RzdiIgKSB7CgkJCXJlc3VsdCA9IGNzdi5kZWNvZGUoIHhoci5yZXNwb25zZVRleHQsICJcdCIgKTsKCQl9CgkJZWxzZSBpZiAoIHJlZ2V4LnhtbC50ZXN0KCB0eXBlICkgKSB7CgkJCWlmICggdHlwZSAhPT0gInRleHQveG1sIiApIHsKCQkJCXhoci5vdmVycmlkZU1pbWVUeXBlKCAidGV4dC94bWwiICk7CgkJCX0KCgkJCXJlc3VsdCA9IHhoci5yZXNwb25zZVhNTDsKCQl9CgkJZWxzZSBpZiAoIHR5cGUgPT09ICJ0ZXh0L3BsYWluIiAmJiByZWdleC5pc194bWwudGVzdCggeGhyLnJlc3BvbnNlVGV4dCApICYmIHhtbC52YWxpZCggeGhyLnJlc3BvbnNlVGV4dCApICkgewoJCQlyZXN1bHQgPSB4bWwuZGVjb2RlKCB4aHIucmVzcG9uc2VUZXh0ICk7CgkJfQoJCWVsc2UgewoJCQlyZXN1bHQgPSB4aHIucmVzcG9uc2VUZXh0OwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIHRoZSBwZXJtaXNzaW9uIG9mIHRoZSBjYWNoZWQgVVJJCgkgKgoJICogQG1ldGhvZCBwZXJtaXNzaW9ucwoJICogQG1lbWJlck9mIGNsaWVudAoJICogQHBhcmFtICB7U3RyaW5nfSB1cmkgVVJJIHRvIHF1ZXJ5CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBDb250YWlucyBhbiBBcnJheSBvZiBhdmFpbGFibGUgY29tbWFuZHMsIHRoZSBwZXJtaXNzaW9uIGJpdCBhbmQgYSBtYXAKCSAqIEBwcml2YXRlCgkgKi8KCXBlcm1pc3Npb25zIDogZnVuY3Rpb24gKCB1cmkgKSB7CgkJdmFyIGNhY2hlZCA9IGNhY2hlLmdldCggdXJpLCBmYWxzZSApLAoJCSAgICBiaXQgICAgPSAhY2FjaGVkID8gMCA6IGNhY2hlZC5wZXJtaXNzaW9uLAoJCSAgICByZXN1bHQgPSB7YWxsb3dzOiBbXSwgYml0OiBiaXQsIG1hcDoge3BhcnRpYWw6IDgsIHJlYWQ6IDQsIHdyaXRlOiAyLCAiZGVsZXRlIjogMSwgdW5rbm93bjogMH19OwoKCQlpZiAoIGJpdCAmIDEgKSB7CgkJCXJlc3VsdC5hbGxvd3MucHVzaCggIkRFTEVURSIgKTsKCQl9CgoJCWlmICggYml0ICYgMiApIHsKCQkJcmVzdWx0LmFsbG93cy5wdXNoKCAiUE9TVCIgKTsKCQkJcmVzdWx0LmFsbG93cy5wdXNoKCAiUFVUIiApOwoJCX0KCgkJaWYgKCBiaXQgJiA0ICkgewoJCQlyZXN1bHQuYWxsb3dzLnB1c2goICJHRVQiICk7CgkJfQoKCQlpZiAoIGJpdCAmIDggKSB7CgkJCXJlc3VsdC5hbGxvd3MucHVzaCggIlBBVENIIiApOwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGEgSlNPTlAgcmVxdWVzdAoJICoKCSAqIEBtZXRob2QganNvbnAKCSAqIEBtZW1iZXJPZiBjbGllbnQKCSAqIEBwYXJhbSAge1N0cmluZ30gdXJpICBVUkkgdG8gcmVxdWVzdAoJICogQHBhcmFtICB7TWl4ZWR9ICBhcmdzIEN1c3RvbSBKU09OUCBoYW5kbGVyIHBhcmFtZXRlciBuYW1lLCBkZWZhdWx0IGlzICJjYWxsYmFjayI7IG9yIGN1c3RvbSBoZWFkZXJzIGZvciBHRVQgcmVxdWVzdCAoIENPUlMgKQoJICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmpzb25wKCAiaHR0cDovL3NvbWVkb21haW4uY29tL3Jlc291cmNlP2NhbGxiYWNrPSIsIGZ1bmN0aW9uICggYXJnICkgewoJICogICAvLyBgYXJnYCBpcyB0aGUgY29lcmNlZCByZXNwb25zZSBib2R5CgkgKiB9LCBmdW5jdGlvbiAoIGVyciApIHsKCSAqICAgLy8gSGFuZGxlIGBlcnJgCgkgKiB9ICk7CgkgKi8KCWpzb25wIDogZnVuY3Rpb24gKCB1cmksIGFyZ3MgKSB7CgkJdmFyIGRlZmVyICAgID0gZGVmZXJyZWQuZmFjdG9yeSgpLAoJCSAgICBjYWxsYmFjayA9ICJjYWxsYmFjayIsCgkJICAgIGNiaWQsIHM7CgoJCWlmICggZXh0ZXJuYWwgPT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAhZ2xvYmFsLmtlaWdhaSApIHsKCQkJCWdsb2JhbC5rZWlnYWkgPSB7Y2FsbGJhY2s6IHt9fTsKCQkJfQoKCQkJZXh0ZXJuYWwgPSAia2VpZ2FpIjsKCQl9CgoJCWlmICggYXJncyBpbnN0YW5jZW9mIE9iamVjdCAmJiAhYXJncy5jYWxsYmFjayApIHsKCQkJY2FsbGJhY2sgPSBhcmdzLmNhbGxiYWNrOwoJCX0KCgkJZG8gewoJCQljYmlkID0gdXRpbGl0eS5nZW5JZCgpLnNsaWNlKCAwLCAxMCApOwoJCX0KCQl3aGlsZSAoIGdsb2JhbC5jYWxsYmFja1tjYmlkXSApOwoKCQl1cmkgPSB1cmkucmVwbGFjZSggY2FsbGJhY2sgKyAiPT8iLCBjYWxsYmFjayArICI9IiArIGV4dGVybmFsICsgIi5jYWxsYmFjay4iICsgY2JpZCApOwoKCQlnbG9iYWwuY2FsbGJhY2tbY2JpZF0gPSBmdW5jdGlvbiAoIGFyZyApIHsKCQkJdXRpbGl0eS5jbGVhclRpbWVycyggY2JpZCApOwoJCQlkZWxldGUgZ2xvYmFsLmNhbGxiYWNrW2NiaWRdOwoJCQlkZWZlci5yZXNvbHZlKCBhcmcgKTsKCQkJZWxlbWVudC5kZXN0cm95KCBzICk7CgkJfTsKCgkJcyA9IGVsZW1lbnQuY3JlYXRlKCAic2NyaXB0Iiwge3NyYzogdXJpLCB0eXBlOiAidGV4dC9qYXZhc2NyaXB0In0sIHV0aWxpdHkuZG9tKCAiaGVhZCIgKVswXSApOwoJCQoJCXV0aWxpdHkuZGVmZXIoIGZ1bmN0aW9uICgpIHsKCQkJZGVmZXIucmVqZWN0KCB1bmRlZmluZWQgKTsKCQl9LCAzMDAwMCwgY2JpZCApOwoKCQlyZXR1cm4gZGVmZXI7Cgl9LAoKCS8qKgoJICogS1hNTEh0dHBSZXF1ZXN0IGZhY3RvcnkKCSAqCgkgKiBAbWV0aG9kIGt4aHIKCSAqIEBtZW1iZXJPZiBjbGllbnQKCSAqIEBwYXJhbSB7T2JqZWN0fSB4aHIgWE1MSHR0cFJlcXVlc3QKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5LWE1MSHR0cFJlcXVlc3R9CgkgKiBAcHJpdmF0ZQoJICovCglreGhyIDogZnVuY3Rpb24gKCB4aHIgKSB7CgkJdmFyIG9iaiA9IG5ldyBLWE1MSHR0cFJlcXVlc3QoIHhociApOwoKCQkvLyBXcmFwcGluZyBkZWZlcnJlZCBtZXRob2RzIG9uIG9iagoJCWFycmF5LmVhY2goIGFycmF5LmtleXMoIERlZmVycmVkLnByb3RvdHlwZSApLCBmdW5jdGlvbiAoIGkgKSB7CgkJCW9ialtpXSA9IGZ1bmN0aW9uICgpIHsKCQkJCXJldHVybiBvYmouZGVmZXJbaV0uYXBwbHkoIG9iai5kZWZlciwgYXJyYXkuY2FzdCggYXJndW1lbnRzICkgKTsKCQkJfTsKCQl9ICk7CgoJCS8vIEhvb2tpbmcgb2JzZXJ2ZXIgZm9yIHN0YW5kYXJkIGV2ZW50cwoJCWFycmF5LmVhY2goIEVWRU5UUywgZnVuY3Rpb24gKCBpICkgewoJCQlvYmouaG9vayggb2JqLnhociwgaSApOwoJCX0gKTsKCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGFuIFhtbEh0dHBSZXF1ZXN0IHRvIGEgVVJJICggYWxpYXNlZCB0byBtdWx0aXBsZSBtZXRob2RzICkKCSAqCgkgKiBUaGUgcmV0dXJuZWQgRGVmZXJyZWQgd2lsbCBoYXZlIGFuIC54aHIKCSAqCgkgKiBAbWV0aG9kIHJlcXVlc3QKCSAqIEBtZW1iZXJPZiBjbGllbnQKCSAqIEBwYXJhbSAge1N0cmluZ30gICB1cmkgICAgIFVSSSB0byBxdWVyeQoJICogQHBhcmFtICB7U3RyaW5nfSAgIHR5cGUgICAgW09wdGlvbmFsXSBUeXBlIG9mIHJlcXVlc3QgKCBERUxFVEUvR0VUL1BPU1QvUFVUL1BBVENIL0hFQUQvT1BUSU9OUyApLCBkZWZhdWx0IGlzIGBHRVRgCgkgKiBAcGFyYW0gIHtNaXhlZH0gICAgYXJncyAgICBbT3B0aW9uYWxdIERhdGEgdG8gc2VuZCB3aXRoIHRoZSByZXF1ZXN0CgkgKiBAcGFyYW0gIHtPYmplY3R9ICAgaGVhZGVycyBbT3B0aW9uYWxdIEN1c3RvbSByZXF1ZXN0IGhlYWRlcnMgKCBjYW4gYmUgdXNlZCB0byBzZXQgd2l0aENyZWRlbnRpYWxzICkKCSAqIEByZXR1cm4ge09iamVjdH0gICB7QGxpbmsga2VpZ2FpLktYTUxIdHRwUmVxdWVzdH0KCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5yZXF1ZXN0KCAiaHR0cDovL2tlaWdhaS5pbyIgKS50aGVuKCBmdW5jdGlvbiAoIGFyZyApIHsKCSAqICAgLy8gYGFyZ2AgaXMgdGhlIGNvZXJjZWQgcmVzcG9uc2UgYm9keQoJICogfSwgZnVuY3Rpb24gKCBlcnIgKSB7CgkgKiAgIC8vIEhhbmRsZSBgZXJyYAoJICogfSApOwoJICovCglyZXF1ZXN0IDogZnVuY3Rpb24gKCB1cmksIHR5cGUsIGFyZ3MsIGhlYWRlcnMgKSB7CgkJdmFyIGNvcnMsIGt4aHIsIHBheWxvYWQsIGNhY2hlZCwgY29udGVudFR5cGUsIGRvYywgYWIsIGJsb2I7CgoJCXR5cGUgPSB0eXBlIHx8ICJHRVQiOwoKCQlpZiAoICggcmVnZXgucHV0X3Bvc3QudGVzdCggdHlwZSApIHx8IHJlZ2V4LnBhdGNoLnRlc3QoIHR5cGUgKSApICYmIGFyZ3MgPT09IHVuZGVmaW5lZCApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQl1cmkgICAgICAgICA9IHV0aWxpdHkucGFyc2UoIHVyaSApLmhyZWY7CgkJdHlwZSAgICAgICAgPSB0eXBlLnRvTG93ZXJDYXNlKCk7CgkJaGVhZGVycyAgICAgPSBoZWFkZXJzIGluc3RhbmNlb2YgT2JqZWN0ID8gaGVhZGVycyA6IG51bGw7CgkJY29ycyAgICAgICAgPSBjbGllbnQuY29ycyggdXJpICk7CgkJa3hociAgICAgICAgPSBjbGllbnQua3hociggIWNsaWVudC5pZSB8fCAoICFjb3JzIHx8IGNsaWVudC52ZXJzaW9uID4gOSApID8gbmV3IFhNTEh0dHBSZXF1ZXN0KCkgOiBuZXcgWERvbWFpblJlcXVlc3QoKSApOwoJCXBheWxvYWQgICAgID0gKCByZWdleC5wdXRfcG9zdC50ZXN0KCB0eXBlICkgfHwgcmVnZXgucGF0Y2gudGVzdCggdHlwZSApICkgJiYgYXJncyA/IGFyZ3MgOiBudWxsOwoJCWNhY2hlZCAgICAgID0gdHlwZSA9PT0gImdldCIgPyBjYWNoZS5nZXQoIHVyaSApIDogZmFsc2U7CgkJY29udGVudFR5cGUgPSBudWxsOwoJCWRvYyAgICAgICAgID0gdHlwZW9mIERvY3VtZW50ICE9ICJ1bmRlZmluZWQiOwoJCWFiICAgICAgICAgID0gdHlwZW9mIEFycmF5QnVmZmVyICE9ICJ1bmRlZmluZWQiOwoJCWJsb2IgICAgICAgID0gdHlwZW9mIEJsb2IgIT0gInVuZGVmaW5lZCI7CgoJCS8vIE9ubHkgR0VUICYgUE9TVCBpcyBzdXBwb3J0ZWQgYnkgWERvbWFpblJlcXVlc3QgKHNvIHVzZWxlc3MhKQoJCWlmICggY29ycyAmJiBjbGllbnQuaWUgJiYgY2xpZW50LnZlcnNpb24gPT09IDkgJiYgIXJlZ2V4Lnhkb21haW5yZXF1ZXN0LnRlc3QoIHR5cGUgKSApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5ub3RBdmFpbGFibGUgKTsKCQl9CgoJCS8vIEhvb2tpbmcgY3VzdG9tIGV2ZW50cwoJCWt4aHIub24oICJyZWFkeXN0YXRlY2hhbmdlIiwgZnVuY3Rpb24gKCBldiApIHsKCQkJc3dpdGNoICggdGhpcy54aHIucmVhZHlTdGF0ZSApIHsKCQkJCWNhc2UgMToKCQkJCQl0aGlzLmRpc3BhdGNoKCAiYmVmb3JlWEhSIiwgdGhpcy54aHIsIGV2ICk7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDQ6CgkJCQkJdGhpcy5kaXNwYXRjaCggImFmdGVyWEhSIiwgdGhpcy54aHIsIGV2ICk7CgkJCQkJYnJlYWs7CgkJCX0KCQl9ICk7CgoJCWlmICggIWNvcnMgJiYgIXJlZ2V4LmdldF9oZWFkZXJzLnRlc3QoIHR5cGUgKSAmJiBjbGllbnQuYWxsb3dzKCB1cmksIHR5cGUgKSA9PT0gZmFsc2UgKSB7CgkJCXV0aWxpdHkuZGVsYXkoIGZ1bmN0aW9uICgpIHsKCQkJCWt4aHIuZGlzcGF0Y2goICJiZWZvcmVYSFIiLCBreGhyLnhociwgbnVsbCApOwoJCQkJa3hoci5kaXNwYXRjaCggImFmdGVyWEhSIiwga3hoci54aHIsIG51bGwgKTsKCQkJfSApOwoKCQkJa3hoci54aHIuc3RhdHVzID0gNDA1OwoJCQlreGhyLnJlamVjdCggbnVsbCApOwoJCX0KCgkJaWYgKCB0eXBlID09PSAiZ2V0IiAmJiBCb29sZWFuKCBjYWNoZWQgKSApIHsKCQkJLy8gRGVjb3JhdGluZyBYSFIgZm9yIHByb3h5IGJlaGF2aW9yCgkJCWlmICggc2VydmVyICkgewoJCQkJa3hoci54aHIucmVhZHlTdGF0ZSAgPSA0OwoJCQkJa3hoci54aHIuc3RhdHVzICAgICAgPSAyMDA7CgkJCQlreGhyLnhoci5fcmVzaGVhZGVycyA9IGNhY2hlZC5oZWFkZXJzOwoJCQl9CgoJCQl1dGlsaXR5LmRlbGF5KCBmdW5jdGlvbiAoKSB7CgkJCQlreGhyLmRpc3BhdGNoKCAiYmVmb3JlWEhSIiwga3hoci54aHIsIG51bGwgKTsKCQkJCWt4aHIuZGlzcGF0Y2goICJhZnRlclhIUiIsIGt4aHIueGhyLCBudWxsICk7CgkJCX0gKTsKCgkJCWt4aHIucmVzb2x2ZSggY2FjaGVkLnJlc3BvbnNlICk7CgkJfQoJCWVsc2UgewoJCQl1dGlsaXR5LmRlbGF5KCBmdW5jdGlvbiAoKSB7CgkJCQlreGhyLnhoci5vcGVuKCB0eXBlLnRvVXBwZXJDYXNlKCksIHVyaSwgdHJ1ZSApOwoKCQkJCS8vIFNldHRpbmcgY29udGVudC10eXBlIHZhbHVlCgkJCQlpZiAoIGhlYWRlcnMgIT09IG51bGwgJiYgaGVhZGVycy5oYXNPd25Qcm9wZXJ0eSggImNvbnRlbnQtdHlwZSIgKSApIHsKCQkJCQljb250ZW50VHlwZSA9IGhlYWRlcnNbImNvbnRlbnQtdHlwZSJdOwoJCQkJfQoKCQkJCWlmICggY29ycyAmJiBjb250ZW50VHlwZSA9PT0gbnVsbCApIHsKCQkJCQljb250ZW50VHlwZSA9ICJ0ZXh0L3BsYWluIjsKCQkJCX0KCgkJCQkvLyBUcmFuc2Zvcm1pbmcgcGF5bG9hZAoJCQkJaWYgKCBwYXlsb2FkICE9PSBudWxsICkgewoJCQkJCWlmICggcGF5bG9hZC5oYXNPd25Qcm9wZXJ0eSggInhtbCIgKSApIHsKCQkJCQkJcGF5bG9hZCA9IHBheWxvYWQueG1sOwoJCQkJCX0KCgkJCQkJaWYgKCBkb2MgJiYgcGF5bG9hZCBpbnN0YW5jZW9mIERvY3VtZW50ICkgewoJCQkJCQlwYXlsb2FkID0geG1sLmRlY29kZSggcGF5bG9hZCApOwoJCQkJCX0KCgkJCQkJaWYgKCB0eXBlb2YgcGF5bG9hZCA9PSAic3RyaW5nIiAmJiByZWdleC5pc194bWwudGVzdCggcGF5bG9hZCApICkgewoJCQkJCQljb250ZW50VHlwZSA9ICJhcHBsaWNhdGlvbi94bWwiOwoJCQkJCX0KCgkJCQkJaWYgKCAhKCBhYiAmJiBwYXlsb2FkIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIgKSAmJiAhKCBibG9iICYmIHBheWxvYWQgaW5zdGFuY2VvZiBCbG9iICkgJiYgISggcGF5bG9hZCBpbnN0YW5jZW9mIEJ1ZmZlciApICYmIHBheWxvYWQgaW5zdGFuY2VvZiBPYmplY3QgKSB7CgkJCQkJCWNvbnRlbnRUeXBlID0gImFwcGxpY2F0aW9uL2pzb24iOwoJCQkJCQlwYXlsb2FkID0ganNvbi5lbmNvZGUoIHBheWxvYWQgKTsKCQkJCQl9CgoJCQkJCWlmICggY29udGVudFR5cGUgPT09IG51bGwgJiYgKCAoIGFiICYmIHBheWxvYWQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciApIHx8ICggYmxvYiAmJiBwYXlsb2FkIGluc3RhbmNlb2YgQmxvYiApICkgKSB7CgkJCQkJCWNvbnRlbnRUeXBlID0gImFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSI7CgkJCQkJfQoKCQkJCQlpZiAoIGNvbnRlbnRUeXBlID09PSBudWxsICkgewoJCQkJCQljb250ZW50VHlwZSA9ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgiOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTZXR0aW5nIGhlYWRlcnMgZm9yIGV2ZXJ5dGhpbmcgZXhjZXB0IElFOSBDT1JTIHJlcXVlc3RzCgkJCQlpZiAoICFjbGllbnQuaWUgfHwgKCAhY29ycyB8fCBjbGllbnQudmVyc2lvbiA+IDkgKSApIHsKCQkJCQlpZiAoIGhlYWRlcnMgPT09IG51bGwgKSB7CgkJCQkJCWhlYWRlcnMgPSB7fTsKCQkJCQl9CgoJCQkJCWlmICggdHlwZW9mIGNhY2hlZCA9PSAib2JqZWN0IiAmJiBjYWNoZWQuaGVhZGVycy5oYXNPd25Qcm9wZXJ0eSggImV0YWciICkgKSB7CgkJCQkJCWhlYWRlcnMuZXRhZyA9IGNhY2hlZC5oZWFkZXJzLmV0YWc7CgkJCQkJfQoKCQkJCQlpZiAoIGNvbnRlbnRUeXBlICE9PSBudWxsICkgewoJCQkJCQloZWFkZXJzWyJjb250ZW50LXR5cGUiXSA9IGNvbnRlbnRUeXBlOwoJCQkJCX0KCgkJCQkJaWYgKCBoZWFkZXJzLmhhc093blByb3BlcnR5KCAiY2FsbGJhY2siICkgKSB7CgkJCQkJCWRlbGV0ZSBoZWFkZXJzLmNhbGxiYWNrOwoJCQkJCX0KCgkJCQkJaGVhZGVyc1sieC1yZXF1ZXN0ZWQtd2l0aCJdID0gIlhNTEh0dHBSZXF1ZXN0IjsKCgkJCQkJdXRpbGl0eS5pdGVyYXRlKCBoZWFkZXJzLCBmdW5jdGlvbiAoIHYsIGsgKSB7CgkJCQkJCWlmICggdiAhPT0gbnVsbCAmJiBrICE9PSAid2l0aENyZWRlbnRpYWxzIikgewoJCQkJCQkJa3hoci54aHIuc2V0UmVxdWVzdEhlYWRlciggaywgdiApOwoJCQkJCQl9CgkJCQkJfSApOwoKCQkJCQkvLyBDcm9zcyBPcmlnaW4gUmVzb3VyY2UgU2hhcmluZyAoIENPUlMgKQoJCQkJCWlmICggdHlwZW9mIGt4aHIueGhyLndpdGhDcmVkZW50aWFscyA9PSAiYm9vbGVhbiIgJiYgaGVhZGVycyAhPT0gbnVsbCAmJiB0eXBlb2YgaGVhZGVycy53aXRoQ3JlZGVudGlhbHMgPT0gImJvb2xlYW4iICkgewoJCQkJCQlreGhyLnhoci53aXRoQ3JlZGVudGlhbHMgPSBoZWFkZXJzLndpdGhDcmVkZW50aWFsczsKCQkJCQl9CgkJCQl9CgoJCQkJa3hoci5vbiggImxvYWQiLCBmdW5jdGlvbiAoKSB7CgkJCQkJdmFyIHNlbGYgICA9IHRoaXMsCgkJCQkJICAgIHhkciAgICA9IGNsaWVudC5pZSAmJiB0aGlzLnhoci5yZWFkeVN0YXRlID09PSB1bmRlZmluZWQsCgkJCQkJICAgIHNoYXJlZCA9IHRydWUsCgkJCQkJICAgIG8sIHIsIHQsIHJlZGlyZWN0OwoKCQkJCQlpZiAoICF4ZHIgJiYgdGhpcy54aHIucmVhZHlTdGF0ZSA9PT0gNCApIHsKCQkJCQkJc3dpdGNoICggdGhpcy54aHIuc3RhdHVzICkgewoJCQkJCQkJY2FzZSAyMDA6CgkJCQkJCQljYXNlIDIwMToKCQkJCQkJCWNhc2UgMjAyOgoJCQkJCQkJY2FzZSAyMDM6CgkJCQkJCQljYXNlIDIwNDoKCQkJCQkJCWNhc2UgMjA1OgoJCQkJCQkJY2FzZSAyMDY6CgkJCQkJCQkJbyA9IGNsaWVudC5oZWFkZXJzKCB0aGlzLnhociwgdXJpLCB0eXBlICk7CgoJCQkJCQkJCWlmICggdHlwZSA9PT0gImhlYWQiICkgewoJCQkJCQkJCQlyZXR1cm4gdGhpcy5yZXNvbHZlKCBvLmhlYWRlcnMgKTsKCQkJCQkJCQl9CgkJCQkJCQkJZWxzZSBpZiAoIHR5cGUgPT09ICJvcHRpb25zIiApIHsKCQkJCQkJCQkJcmV0dXJuIHRoaXMucmVzb2x2ZSggby5oZWFkZXJzICk7CgkJCQkJCQkJfQoJCQkJCQkJCWVsc2UgaWYgKCB0eXBlICE9PSAiZGVsZXRlIiApIHsKCQkJCQkJCQkJaWYgKCBzZXJ2ZXIgJiYgcmVnZXgucHJpdi50ZXN0KCBvLmhlYWRlcnNbImNhY2hlLWNvbnRyb2wiXSApICkgewoJCQkJCQkJCQkJc2hhcmVkID0gZmFsc2U7CgkJCQkJCQkJCX0KCgkJCQkJCQkJCWlmICggcmVnZXguaHR0cF9ib2R5LnRlc3QoIHRoaXMueGhyLnN0YXR1cyApICkgewoJCQkJCQkJCQkJdCA9IG8uaGVhZGVyc1siY29udGVudC10eXBlIl0gfHwgIiI7CgkJCQkJCQkJCQlyID0gY2xpZW50LnBhcnNlKCB0aGlzLnhociwgdCApOwoKCQkJCQkJCQkJCWlmICggciA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkJCQkJCXRoaXMucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLnNlcnZlckVycm9yICkgKTsKCQkJCQkJCQkJCX0KCQkJCQkJCQkJfQoKCQkJCQkJCQkJaWYgKCB0eXBlID09PSAiZ2V0IiAmJiBzaGFyZWQgKSB7CgkJCQkJCQkJCQljYWNoZS5zZXQoIHVyaSwgInJlc3BvbnNlIiwgKCBvLnJlc3BvbnNlID0gdXRpbGl0eS5jbG9uZSggciwgdHJ1ZSApICkgKTsKCQkJCQkJCQkJfQoJCQkJCQkJCQllbHNlIHsKCQkJCQkJCQkJCWNhY2hlLmV4cGlyZSggdXJpLCB0cnVlICk7CgkJCQkJCQkJCX0KCQkJCQkJCQl9CgkJCQkJCQkJZWxzZSBpZiAoIHR5cGUgPT09ICJkZWxldGUiICkgewoJCQkJCQkJCQljYWNoZS5leHBpcmUoIHVyaSwgdHJ1ZSApOwoJCQkJCQkJCX0KCgkJCQkJCQkJc3dpdGNoICggdGhpcy54aHIuc3RhdHVzICkgewoJCQkJCQkJCQljYXNlIDIwMDoKCQkJCQkJCQkJY2FzZSAyMDI6CgkJCQkJCQkJCWNhc2UgMjAzOgoJCQkJCQkJCQljYXNlIDIwNjoKCQkJCQkJCQkJCXRoaXMucmVzb2x2ZSggciApOwoJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCWNhc2UgMjAxOgoJCQkJCQkJCQkJaWYgKCAoIG8uaGVhZGVycy5sb2NhdGlvbiA9PT0gdW5kZWZpbmVkIHx8IHN0cmluZy5pc0VtcHR5KCBvLmhlYWRlcnMubG9jYXRpb24gKSApICYmICFzdHJpbmcuaXNVcmwoIHIgKSApIHsKCQkJCQkJCQkJCQl0aGlzLnJlc29sdmUoIHIgKTsKCQkJCQkJCQkJCX0KCQkJCQkJCQkJCWVsc2UgewoJCQkJCQkJCQkJCXJlZGlyZWN0ID0gc3RyaW5nLnRyaW0gKCBvLmhlYWRlcnMuTG9jYXRpb24gfHwgciApOwoJCQkJCQkJCQkJCWNsaWVudC5yZXF1ZXN0KCByZWRpcmVjdCApLnRoZW4oIGZ1bmN0aW9uICggYXJnICkgewoJCQkJCQkJCQkJCQlzZWxmLnJlc29sdmUgKCBhcmcgKTsKCQkJCQkJCQkJCQl9LCBmdW5jdGlvbiAoIGUgKSB7CgkJCQkJCQkJCQkJCXNlbGYucmVqZWN0KCBlICk7CgkJCQkJCQkJCQkJfSApOwoJCQkJCQkJCQkJfQoJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCWNhc2UgMjA0OgoJCQkJCQkJCQljYXNlIDIwNToKCQkJCQkJCQkJCXRoaXMucmVzb2x2ZSggbnVsbCApOwoJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJfQoJCQkJCQkJCWJyZWFrOwoJCQkJCQkJY2FzZSAzMDQ6CgkJCQkJCQkJdGhpcy5yZXNvbHZlKCByICk7CgkJCQkJCQkJYnJlYWs7CgkJCQkJCQljYXNlIDQwMToKCQkJCQkJCQl0aGlzLnJlamVjdCggbmV3IEVycm9yKCB0aGlzLnhoci5yZXNwb25zZVRleHQgfHwgbGFiZWwuc2VydmVyVW5hdXRob3JpemVkICkgKTsKCQkJCQkJCQlicmVhazsKCQkJCQkJCWNhc2UgNDAzOgoJCQkJCQkJCWNhY2hlLnNldCggdXJpLCAiIXBlcm1pc3Npb24iLCBjbGllbnQuYml0KCBbdHlwZV0gKSApOwoJCQkJCQkJCXRoaXMucmVqZWN0KCBuZXcgRXJyb3IoIHRoaXMueGhyLnJlc3BvbnNlVGV4dCB8fCBsYWJlbC5zZXJ2ZXJGb3JiaWRkZW4gKSApOwoJCQkJCQkJCWJyZWFrOwoJCQkJCQkJY2FzZSA0MDU6CgkJCQkJCQkJY2FjaGUuc2V0KCB1cmksICIhcGVybWlzc2lvbiIsIGNsaWVudC5iaXQoIFt0eXBlXSApICk7CgkJCQkJCQkJdGhpcy5yZWplY3QoIG5ldyBFcnJvciggdGhpcy54aHIucmVzcG9uc2VUZXh0IHx8IGxhYmVsLnNlcnZlckludmFsaWRNZXRob2QgKSApOwoJCQkJCQkJCWJyZWFrOwoJCQkJCQkJZGVmYXVsdDoKCQkJCQkJCQl0aGlzLnJlamVjdCggbmV3IEVycm9yKCB0aGlzLnhoci5yZXNwb25zZVRleHQgfHwgbGFiZWwuc2VydmVyRXJyb3IgKSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWVsc2UgaWYgKCB4ZHIgKSB7CgkJCQkJCXIgPSBjbGllbnQucGFyc2UoIHRoaXMueGhyLCAidGV4dC9wbGFpbiIgKTsKCQkJCQkJY2FjaGUuc2V0KCB1cmksICJwZXJtaXNzaW9uIiwgY2xpZW50LmJpdCggWyJnZXQiXSApICk7CgkJCQkJCWNhY2hlLnNldCggdXJpLCAicmVzcG9uc2UiLCByICk7CgkJCQkJCXRoaXMucmVzb2x2ZSggciApOwoJCQkJCX0KCQkJCX0gKTsKCgkJCQlreGhyLm9uKCAiZXJyb3IiLCBmdW5jdGlvbiAoIGUgKSB7CgkJCQkJdGhpcy5yZWplY3QoIGUgKTsKCQkJCX0gKTsKCgkJCQkvLyBTZW5kaW5nIHJlcXVlc3QKCQkJCWt4aHIueGhyLnNlbmQoIHBheWxvYWQgIT09IG51bGwgPyBwYXlsb2FkIDogdW5kZWZpbmVkICk7CgkJCX0gKTsKCQl9CgoJCXJldHVybiBreGhyOwoJfSwKCgkvKioKCSAqIFNjcm9sbHMgdG8gYSBwb3NpdGlvbiBpbiB0aGUgdmlldyB1c2luZyBhIHR3byBwb2ludCBiZXppZXIgY3VydmUKCSAqCgkgKiBAbWV0aG9kIHNjcm9sbAoJICogQG1lbWJlck9mIGNsaWVudAoJICogQHBhcmFtICB7QXJyYXl9ICBkZXN0IENvb3JkaW5hdGVzCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IG1zICAgW09wdGlvbmFsXSBNaWxsaXNlY29uZHMgdG8gc2Nyb2xsLCBkZWZhdWx0IGlzIDI1MCwgbWluIGlzIDEwMAoJICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsgRGVmZXJyZWR9CgkgKiBAcHJpdmF0ZQoJICovCglzY3JvbGwgOiBmdW5jdGlvbiAoIGRlc3QsIG1zICkgewoJCXZhciBkZWZlciA9IGRlZmVycmVkKCksCgkJICAgIHN0YXJ0ID0gY2xpZW50LnNjcm9sbFBvcygpLAoJCSAgICB0ICAgICA9IDA7CgoJCW1zID0gKCAhaXNOYU4oIG1zICkgPyBtcyA6IDI1MCApIC8gMTAwOwoKCQl1dGlsaXR5LnJlcGVhdCggZnVuY3Rpb24gKCkgewoJCQl2YXIgcG9zID0gbWF0aC5iZXppZXIoIHN0YXJ0WzBdLCBzdGFydFsxXSwgZGVzdFswXSwgZGVzdFsxXSwgKyt0IC8gMTAwICk7CgoJCQl3aW5kb3cuc2Nyb2xsVG8oIHBvc1swXSwgcG9zWzFdICk7CgoJCQlpZiAoIHQgPT09IDEwMCApIHsKCQkJCWRlZmVyLnJlc29sdmUoIHRydWUgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sIG1zLCAic2Nyb2xsaW5nIiApOwoKCQlyZXR1cm4gZGVmZXI7Cgl9LAoKCS8qKgoJICogUmV0dXJucyB0aGUgY3VycmVudCBzY3JvbGwgcG9zaXRpb24gb2YgdGhlIFZpZXcKCSAqCgkgKiBAbWV0aG9kIHNjcm9sbFBvcwoJICogQG1lbWJlck9mIGNsaWVudAoJICogQHJldHVybiB7QXJyYXl9IERlc2NyaWJlcyB0aGUgc2Nyb2xsIHBvc2l0aW9uCgkgKiBAcHJpdmF0ZQoJICovCglzY3JvbGxQb3MgOiBmdW5jdGlvbiAoKSB7CgkJcmV0dXJuIFsKCQkJd2luZG93LnNjcm9sbFggfHwgMCwKCQkJd2luZG93LnNjcm9sbFkgfHwgMAoJCV07Cgl9Cn07CgovKioKICogQG5hbWVzcGFjZSBjc3YKICovCnZhciBjc3YgPSB7CgkvKioKCSAqIENvbnZlcnRzIENTViB0byBhbiBBcnJheSBvZiBPYmplY3RzCgkgKgoJICogQG1ldGhvZCBkZWNvZGUKCSAqIEBtZW1iZXJPZiBjc3YKCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnICAgICAgIENTViBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gZGVsaW1pdGVyIFtPcHRpb25hbF0gRGVsaW1pdGVyIHRvIHNwbGl0IGNvbHVtbnMgb24sIGRlZmF1bHQgaXMgIiwiCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgICAgICBBcnJheSBvZiBPYmplY3RzCgkgKi8KCWRlY29kZSA6IGZ1bmN0aW9uICggYXJnLCBkZWxpbWl0ZXIgKSB7CgkJZGVsaW1pdGVyICA9IGRlbGltaXRlciB8fCAiLCI7CgkJdmFyIHJlZ2V4ICA9IG5ldyBSZWdFeHAoIGRlbGltaXRlciArICIoPz0oPzpbXlwiXXxcIig/OlteXCJdKVteXCJdKlwiKSokKSIgKSwKCQkgICAgcm93cyAgID0gc3RyaW5nLnRyaW0oIGFyZyApLnNwbGl0KCAiXG4iICksCgkJICAgIGtleXMgICA9IHJvd3Muc2hpZnQoKS5zcGxpdCggZGVsaW1pdGVyICksCgkJICAgIHJlc3VsdCA9IFtdLAoJCSAgICBudGggICAgPSByb3dzLmxlbmd0aCwKCQkgICAgeCAgICAgID0ga2V5cy5sZW5ndGgsCgkJICAgIGkgICAgICA9IC0xLAoJCSAgICBuLCBvYmosIHJvdzsKCgkJd2hpbGUgKCArK2kgPCBudGggKSB7CgkJCW9iaiA9IHt9OwoJCQlyb3cgPSByb3dzW2ldLnNwbGl0KCByZWdleCApOwoKCQkJbiA9IC0xOwoJCQl3aGlsZSAoICsrbiAgPCB4ICkgewoJCQkJb2JqW2tleXNbbl1dID0gdXRpbGl0eS5jb2VyY2UoICggcm93W25dIHx8ICIiICkucmVwbGFjZSggL14ifCIkL2csICIiICkgKTsKCQkJfQoKCQkJcmVzdWx0LnB1c2goIG9iaiApOwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBFbmNvZGVzIGFuIEFycmF5LCBKU09OLCBvciBPYmplY3QgYXMgQ1NWCgkgKgoJICogQG1ldGhvZCBlbmNvZGUKCSAqIEBtZW1iZXJPZiBjc3YKCSAqIEBwYXJhbSAge01peGVkfSAgIGFyZyAgICAgICBKU09OLCBBcnJheSBvciBPYmplY3QKCSAqIEBwYXJhbSAge1N0cmluZ30gIGRlbGltaXRlciBbT3B0aW9uYWxdIENoYXJhY3RlciB0byBzZXBhcmF0ZSBmaWVsZHMKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGhlYWRlciAgICBbT3B0aW9uYWxdIGBmYWxzZWAgdG8gZGlzYWJsZSBrZXlzIG5hbWVzIGFzIGZpcnN0IHJvdwoJICogQHJldHVybiB7U3RyaW5nfSAgICAgICAgICAgIENTViBzdHJpbmcKCSAqIEBleGFtcGxlCgkgKiB2YXIgY3N2ID0ga2VpZ2FpLnV0aWwuY3N2LmVuY29kZSggW3twcm9wOiJ2YWx1ZSJ9LCB7cHJvcDoidmFsdWUyIn1dICk7CgkgKgoJICogY29uc29sZS5sb2coIGNzdiApOwoJICogInByb3AKCSAqICB2YWx1ZQoJICogIHZhbHVlMiIKCSAqLwoJZW5jb2RlIDogZnVuY3Rpb24gKCBhcmcsIGRlbGltaXRlciwgaGVhZGVyICkgewoJCXZhciBvYmogICAgPSBqc29uLmRlY29kZSggYXJnLCB0cnVlICkgfHwgYXJnLAoJCSAgICByZXN1bHQgPSAiIjsKCgkJZGVsaW1pdGVyICA9IGRlbGltaXRlciB8fCAiLCI7CgkJaGVhZGVyICAgICA9ICggaGVhZGVyICE9PSBmYWxzZSApOwoKCQkvLyBQcmVwYXJlcyBpbnB1dCBiYXNlZCBvbiBDU1YgcnVsZXMKCQlmdW5jdGlvbiBwcmVwYXJlICggaW5wdXQgKSB7CgkJCXZhciBvdXRwdXQ7CgoJCQlpZiAoIGlucHV0IGluc3RhbmNlb2YgQXJyYXkgKSB7CgkJCQlvdXRwdXQgPSAiXCIiICsgaW5wdXQudG9TdHJpbmcoKSArICJcIiI7CgoJCQkJaWYgKCByZWdleC5vYmplY3RfdHlwZS50ZXN0KCBvdXRwdXQgKSApIHsKCQkJCQlvdXRwdXQgPSAiXCIiICsgY3N2LmVuY29kZSggaW5wdXQsIGRlbGltaXRlciApICsgIlwiIjsKCQkJCX0KCQkJfQoJCQllbHNlIGlmICggaW5wdXQgaW5zdGFuY2VvZiBPYmplY3QgKSB7CgkJCQlvdXRwdXQgPSAiXCIiICsgY3N2LmVuY29kZSggaW5wdXQsIGRlbGltaXRlciApICsgIlwiIjsKCQkJfQoJCQllbHNlIGlmICggcmVnZXguY3N2X3F1b3RlLnRlc3QoIGlucHV0ICkgKSB7CgkJCQlvdXRwdXQgPSAiXCIiICsgaW5wdXQucmVwbGFjZSggLyIvZywgIlwiXCIiICkgKyAiXCIiOwoJCQl9CgkJCWVsc2UgewoJCQkJb3V0cHV0ID0gaW5wdXQ7CgkJCX0KCgkJCXJldHVybiBvdXRwdXQ7CgkJfQoKCQlpZiAoIG9iaiBpbnN0YW5jZW9mIEFycmF5ICkgewoJCQlpZiAoIG9ialswXSBpbnN0YW5jZW9mIE9iamVjdCApIHsKCQkJCWlmICggaGVhZGVyICkgewoJCQkJCXJlc3VsdCA9ICggYXJyYXkua2V5cyggb2JqWzBdICkuam9pbiggZGVsaW1pdGVyICkgKyAiXG4iICk7CgkJCQl9CgoJCQkJcmVzdWx0ICs9IG9iai5tYXAoIGZ1bmN0aW9uICggaSApIHsKCQkJCQlyZXR1cm4gY3N2LmVuY29kZSggaSwgZGVsaW1pdGVyLCBmYWxzZSApOwoJCQkJfSApLmpvaW4oICJcbiIgKTsKCQkJfQoJCQllbHNlIHsKCQkJCXJlc3VsdCArPSAoIHByZXBhcmUoIG9iaiwgZGVsaW1pdGVyICkgKyAiXG4iICk7CgkJCX0KCgkJfQoJCWVsc2UgewoJCQlpZiAoIGhlYWRlciApIHsKCQkJCXJlc3VsdCA9ICggYXJyYXkua2V5cyggb2JqICkuam9pbiggZGVsaW1pdGVyICkgKyAiXG4iICk7CgkJCX0KCgkJCXJlc3VsdCArPSAoIGFycmF5LmNhc3QoIG9iaiApLm1hcCggcHJlcGFyZSApLmpvaW4oIGRlbGltaXRlciApICsgIlxuIiApOwoJCX0KCgkJcmV0dXJuIHJlc3VsdC5yZXBsYWNlKCByZWdleC5lb2xfbmwgLCAiIik7Cgl9Cn07CgovKioKICogQG5hbWVzcGFjZSBmaWx0ZXIKICovCnZhciBmaWx0ZXIgPSB7CgkvKioKCSAqIERhdGFMaXN0RmlsdGVyIGZhY3RvcnkKCSAqCgkgKiBAbWV0aG9kIGZhY3RvcnkKCSAqIEBtZW1iZXJPZiBmaWx0ZXIKCSAqIEBwYXJhbSAge09iamVjdH0gdGFyZ2V0ICAgRWxlbWVudCB0byByZWNlaXZlIHRoZSBmaWx0ZXIKCSAqIEBwYXJhbSAge09iamVjdH0gbGlzdCAgICAge0BsaW5rIGtlaWdhaS5EYXRhTGlzdH0KCSAqIEBwYXJhbSAge1N0cmluZ30gZmlsdGVycyAgQ29tbWEgZGVsaW1pdGVkIHN0cmluZyBvZiBmaWVsZHMgdG8gZmlsdGVyIGJ5CgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGRlYm91bmNlIFtPcHRpb25hbF0gTWlsbGlzZWNvbmRzIHRvIGRlYm91bmNlLCBkZWZhdWx0IGlzIGAyNTBgCgkgKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUxpc3RGaWx0ZXJ9CgkgKiBAZXhhbXBsZQoJICogdmFyIHN0b3JlICA9IGtlaWdhaS5zdG9yZSggWy4uLl0gKSwKCSAqICAgICBsaXN0ICAgPSBrZWlnYWkubGlzdCggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNsaXN0IiApLCBzdG9yZSwgInt7ZmllbGR9fSIgKSwKCSAqICAgICBmaWx0ZXIgPSBrZWlnYWkuZmlsdGVyKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiaW5wdXQuZmlsdGVyIiApLCBsaXN0LCAiZmllbGQiICk7CgkgKi8KCWZhY3RvcnkgOiBmdW5jdGlvbiAoIHRhcmdldCwgbGlzdCwgZmlsdGVycywgZGVib3VuY2UgKSB7CgkJdmFyIHJlZiA9IFtsaXN0XSwKCQkgICAgb2JqOwoKCQlkZWJvdW5jZSA9IGRlYm91bmNlIHx8IDI1MDsKCgkJaWYgKCAhKCB0YXJnZXQgaW5zdGFuY2VvZiBFbGVtZW50ICkgfHwgKCBsaXN0ICYmICFsaXN0LnN0b3JlICkgfHwgKCB0eXBlb2YgZmlsdGVycyAhPSAic3RyaW5nIiB8fCBzdHJpbmcuaXNFbXB0eSggZmlsdGVycyApICkgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApOwoJCX0KCgkJb2JqID0gbmV3IERhdGFMaXN0RmlsdGVyKCB0YXJnZXQsIHJlZlswXSwgZGVib3VuY2UgKS5zZXQoIGZpbHRlcnMgKTsKCgkJLy8gRGVjb3JhdGluZyBgdGFyZ2V0YCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBpbnB1dCBgdHlwZWAKCQllbGVtZW50LmF0dHIoIHRhcmdldCwgInR5cGUiLCAidGV4dCIgKTsKCgkJLy8gU2V0dGluZyB1cCBhIGNoYWluIG9mIEV2ZW50cwoJCW9iai5vYnNlcnZlci5ob29rKCBvYmouZWxlbWVudCwgImtleXVwIiApOwoJCW9iai5vYnNlcnZlci5ob29rKCBvYmouZWxlbWVudCwgImlucHV0IiApOwoJCW9iai5vbiggImtleXVwIiwgb2JqLnVwZGF0ZSwgImtleXVwIiApOwoJCW9iai5vbiggImlucHV0Iiwgb2JqLnVwZGF0ZSwgImlucHV0IiApOwoKCQlyZXR1cm4gb2JqOwoJfQp9OwoKLyoqCiAqIENyZWF0ZXMgYSBuZXcgRGF0YUxpc3RGaWx0ZXIKICoKICogQGNvbnN0cnVjdG9yCiAqIEBtZW1iZXJPZiBrZWlnYWkKICogQGV4dGVuZHMge2tlaWdhaS5CYXNlfQogKiBAcGFyYW0gIHtPYmplY3R9IG9iaiAgICAgIEVsZW1lbnQgdG8gcmVjZWl2ZSB0aGUgZmlsdGVyCiAqIEBwYXJhbSAge09iamVjdH0gbGlzdCAgICAge0BsaW5rIGtlaWdhaS5EYXRhTGlzdH0KICogQHBhcmFtICB7TnVtYmVyfSBkZWJvdW5jZSBbT3B0aW9uYWxdIE1pbGxpc2Vjb25kcyB0byBkZWJvdW5jZQogKiBAZXhhbXBsZQogKiB2YXIgc3RvcmUgID0ga2VpZ2FpLnN0b3JlKCBbLi4uXSApLAogKiAgICAgbGlzdCAgID0ga2VpZ2FpLmxpc3QoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjbGlzdCIgKSwgc3RvcmUsICJ7e2ZpZWxkfX0iICksCiAqICAgICBmaWx0ZXIgPSBrZWlnYWkuZmlsdGVyKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiaW5wdXQuZmlsdGVyIiApLCBsaXN0LCAiZmllbGQiICk7CiAqLwpmdW5jdGlvbiBEYXRhTGlzdEZpbHRlciAoIGVsZW1lbnQsIGxpc3QsIGRlYm91bmNlICkgewoJdGhpcy5kZWJvdW5jZSA9IGRlYm91bmNlOwoJdGhpcy5lbGVtZW50ICA9IGVsZW1lbnQ7Cgl0aGlzLmZpbHRlcnMgID0ge307Cgl0aGlzLmxpc3QgICAgID0gbGlzdDsKCXRoaXMub2JzZXJ2ZXIgPSBvYnNlcnZhYmxlLmZhY3RvcnkoKTsKfQoKLyoqCiAqIEV4dGVuZGluZyBCYXNlCiAqCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3RGaWx0ZXIKICogQHR5cGUge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKi8KRGF0YUxpc3RGaWx0ZXIucHJvdG90eXBlID0gYmFzZS5mYWN0b3J5KCk7CgovKioKICogU2V0dGluZyBjb25zdHJ1Y3RvciBsb29wCiAqCiAqIEBtZXRob2QgY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhTGlzdEZpbHRlcgogKiBAdHlwZSB7RnVuY3Rpb259CiAqIEBwcml2YXRlCiAqLwpEYXRhTGlzdEZpbHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEYXRhTGlzdEZpbHRlcjsKCi8qKgogKiBTZXQgdGhlIGZpbHRlcnMKICoKICogQ3JlYXRlIGFuIG9iamVjdCBiYXNlZCBvbiBjb21tYSBzZXBhcmF0ZWQga2V5IHN0cmluZwogKgogKiBAbWV0aG9kIHNldAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFMaXN0RmlsdGVyCiAqIEBwYXJhbSAge1N0cmluZ30gZmllbGRzIENvbW1hIHNlcGFyYXRlZCBmaWx0ZXJzCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhTGlzdEZpbHRlcn0KICogQGV4YW1wbGUKICogZmlsdGVyLnNldCggImZpcnN0TmFtZSwgbGFzdE5hbWUsIGVtYWlsIiApOwogKi8KRGF0YUxpc3RGaWx0ZXIucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uICggZmllbGRzICkgewoJdmFyIG9iaiA9IHt9OwoKCWFycmF5LmVhY2goIHN0cmluZy5leHBsb2RlKCBmaWVsZHMgKSwgZnVuY3Rpb24gKCB2ICkgewoJCW9ialt2XSA9ICIiOwoJfSApOwoKCXRoaXMuZmlsdGVycyA9IG9iajsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBSZW1vdmVzIGxpc3RlbmVycywgYW5kIERPTSBob29rcyB0byBhdm9pZCBtZW1vcnkgbGVha3MKICoKICogQG1ldGhvZCB0ZWFyZG93bgogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFMaXN0RmlsdGVyCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhTGlzdEZpbHRlcn0KICogQGV4YW1wbGUKICogZmlsdGVyLnRlYXJkb3duKCk7CiAqLwpEYXRhTGlzdEZpbHRlci5wcm90b3R5cGUudGVhcmRvd24gPSBmdW5jdGlvbiAoKSB7Cgl0aGlzLm9ic2VydmVyLnVuaG9vayggdGhpcy5lbGVtZW50LCAia2V5dXAiICk7Cgl0aGlzLm9ic2VydmVyLnVuaG9vayggdGhpcy5lbGVtZW50LCAiaW5wdXQiICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogQXBwbGllcyB0aGUgaW5wdXQgdmFsdWUgYXMgYSBmaWx0ZXIgYWdhaW5zdCB0aGUgRGF0YUxpc3QgYmFzZWQgb24gc3BlY2lmaWMgZmllbGRzCiAqCiAqIEBtZXRob2QgdXBkYXRlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3RGaWx0ZXIKICogQGZpcmVzIGtlaWdhaS5EYXRhTGlzdCNiZWZvcmVGaWx0ZXIgRmlyZXMgYmVmb3JlIGZpbHRlcgogKiBAZmlyZXMga2VpZ2FpLkRhdGFMaXN0I2FmdGVyRmlsdGVyIEZpcmVzIGFmdGVyIGZpbHRlcgogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUxpc3RGaWx0ZXJ9CiAqIEBleGFtcGxlCiAqIGZpbHRlci51cGRhdGUoKTsgLy8gRGVib3VuY2VkIGV4ZWN1dGlvbgogKi8KRGF0YUxpc3RGaWx0ZXIucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uICgpIHsKCXZhciBzZWxmID0gdGhpczsKCgl1dGlsaXR5LmRlZmVyKCBmdW5jdGlvbiAoKSB7CgkJdmFyIHZhbCA9IGVsZW1lbnQudmFsKCBzZWxmLmVsZW1lbnQgKS50b1N0cmluZygpOwoJCQoJCXNlbGYubGlzdC5kaXNwYXRjaCggImJlZm9yZUZpbHRlciIsIHNlbGYuZWxlbWVudCwgdmFsICk7CgoJCWlmICggIXN0cmluZy5pc0VtcHR5KCB2YWwgKSApIHsKCQkJdXRpbGl0eS5pdGVyYXRlKCBzZWxmLmZpbHRlcnMsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCXZhciBxdWVyaWVzID0gc3RyaW5nLmV4cGxvZGUoIHZhbCApOwoKCQkJCS8vIElnbm9yaW5nIHRyYWlsaW5nIGNvbW1hcwoJCQkJcXVlcmllcyA9IHF1ZXJpZXMuZmlsdGVyKCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJcmV0dXJuICFzdHJpbmcuaXNFbXB0eSggaSApOwoJCQkJfSApOwoKCQkJCS8vIFNoYXBpbmcgdmFsaWQgcGF0dGVybgoJCQkJYXJyYXkuZWFjaCggcXVlcmllcywgZnVuY3Rpb24gKCBpLCBpZHggKSB7CgkJCQkJdGhpc1tpZHhdID0gIl4uKiIgKyBzdHJpbmcuZXNjYXBlKCBpICkucmVwbGFjZSggLyheXCp8XCokKS9nLCAiIiApLnJlcGxhY2UoIC9cKi9nLCAiLioiICkgKyAiLioiOwoJCQkJfSApOwoKCQkJCXRoaXNba10gPSBxdWVyaWVzLmpvaW4oICIsIiApOwoJCQl9ICk7CgoJCQlzZWxmLmxpc3QuZmlsdGVyID0gc2VsZi5maWx0ZXJzOwoJCX0KCQllbHNlIHsKCQkJc2VsZi5saXN0LmZpbHRlciA9IG51bGw7CgkJfQoKCQlzZWxmLmxpc3QucGFnZUluZGV4ID0gMTsKCQlzZWxmLmxpc3QucmVmcmVzaCgpOwoKCQlzZWxmLmxpc3QuZGlzcGF0Y2goICJhZnRlckZpbHRlciIsIHNlbGYuZWxlbWVudCApOwoJfSwgdGhpcy5kZWJvdW5jZSwgdGhpcy5lbGVtZW50LmlkICsgIkRlYm91bmNlIik7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogQG5hbWVzcGFjZSBncmlkCiAqLwp2YXIgZ3JpZCA9IHsKCS8qKgoJICogRGF0YUdyaWQgZmFjdG9yeQoJICoKCSAqIEBtZXRob2QgZmFjdG9yeQoJICogQG1lbWJlck9mIGdyaWQKCSAqIEBmaXJlcyBrZWlnYWkuRGF0YUdyaWQjY2hhbmdlIEZpcmVzIHdoZW4gdGhlIERPTSBjaGFuZ2VzCgkgKiBAcGFyYW0gIHtPYmplY3R9ICB0YXJnZXQgICAgICBFbGVtZW50IHRvIHJlY2VpdmUgRGF0YUdyaWQKCSAqIEBwYXJhbSAge09iamVjdH0gIHN0b3JlICAgICAgIERhdGFTdG9yZQoJICogQHBhcmFtICB7QXJyYXl9ICAgZmllbGRzICAgICAgQXJyYXkgb2YgZmllbGRzIHRvIGRpc3BsYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgIHNvcnRhYmxlICAgIFtPcHRpb25hbF0gQXJyYXkgb2Ygc29ydGFibGUgY29sdW1ucy9maWVsZHMKCSAqIEBwYXJhbSAge09iamVjdH0gIG9wdGlvbnMgICAgIFtPcHRpb25hbF0gRGF0YUxpc3Qgb3B0aW9ucwoJICogQHBhcmFtICB7Qm9vbGVhbn0gZmlsdGVyZWQgICAgW09wdGlvbmFsXSBDcmVhdGUgYW4gaW5wdXQgdG8gZmlsdGVyIHRoZSBkYXRhIGdyaWQKCSAqIEBwYXJhbSAge051bWJlcn0gIGRlYm91bmNlICAgIFtPcHRpb25hbF0gRGF0YUxpc3RGaWx0ZXIgaW5wdXQgZGVib3VuY2UsIGRlZmF1bHQgaXMgMjUwCgkgKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUdyaWR9CgkgKiBAZXhhbXBsZQoJICogdmFyIGZpZWxkcyAgPSBbIm5hbWUiLCAiYWdlIl0sCgkgKiAgICAgb3B0aW9ucyA9IHtwYWdlU2l6ZTogNSwgb3JkZXI6ICJhZ2UgZGVzYywgbmFtZSJ9LAoJICogICAgIHN0b3JlICAgPSBrZWlnYWkuc3RvcmUoKSwKCSAqICAgICBncmlkICAgID0ga2VpZ2FpLmdyaWQoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjZ3JpZCIgKSwgc3RvcmUsIGZpZWxkcywgZmllbGRzLCBvcHRpb25zLCB0cnVlICk7CgkgKgoJICogc3RvcmUuc2V0VXJpKCAiZGF0YS5qc29uIiApLnRoZW4oIG51bGwsIGZ1bmN0aW9uICggZSApIHsKCSAqICAgLi4uCgkgKiB9ICk7CgkgKi8KCWZhY3RvcnkgOiBmdW5jdGlvbiAoIHRhcmdldCwgc3RvcmUsIGZpZWxkcywgc29ydGFibGUsIG9wdGlvbnMsIGZpbHRlcmVkLCBkZWJvdW5jZSApIHsKCQl2YXIgcmVmID0gW3N0b3JlXSwKCQkgICAgb2JqLCB0ZW1wbGF0ZSwgaGVhZGVyLCB3aWR0aCwgY3NzLCBzb3J0OwoKCQlvYmogICAgICAgPSBuZXcgRGF0YUdyaWQoIHRhcmdldCwgcmVmWzBdLCBmaWVsZHMsIHNvcnRhYmxlLCBvcHRpb25zLCBmaWx0ZXJlZCApOwoJCXRlbXBsYXRlICA9ICIiOwoJCWhlYWRlciAgICA9IGVsZW1lbnQuY3JlYXRlKCAibGkiLCB7fSwgZWxlbWVudC5jcmVhdGUoICJ1bCIsIHsiY2xhc3MiOiAiaGVhZGVyIn0sIG9iai5lbGVtZW50ICkgKTsKCQl3aWR0aCAgICAgPSAoIDEwMCAvIG9iai5maWVsZHMubGVuZ3RoICkgKyAiJSI7CgkJY3NzICAgICAgID0gImRpc3BsYXk6aW5saW5lLWJsb2NrO3dpZHRoOiIgKyB3aWR0aDsKCQlzb3J0ICAgICAgPSBvYmoub3B0aW9ucy5vcmRlciA/IHN0cmluZy5leHBsb2RlKCBvYmoub3B0aW9ucy5vcmRlciApIDogW107CgoJCS8vIENyZWF0aW5nIERhdGFMaXN0IHRlbXBsYXRlIGJhc2VkIG9uIGZpZWxkcwoJCWFycmF5LmVhY2goIG9iai5maWVsZHMsIGZ1bmN0aW9uICggaSApIHsKCQkJdmFyIHRyaW1tZWQgPSBpLnJlcGxhY2UoIC8uKlwuL2csICIiICksCgkJCSAgICBlbCAgICAgID0gZWxlbWVudC5jcmVhdGUoICJzcGFuIiwge2lubmVySFRNTDogc3RyaW5nLmNhcGl0YWxpemUoIHN0cmluZy51bkNhbWVsQ2FzZSggc3RyaW5nLnVuaHlwaGVuYXRlKCB0cmltbWVkLCB0cnVlICkgKS5yZXBsYWNlKCAvX3wtL2csICIgIiApLCB0cnVlICksIHN0eWxlOiBjc3MsICJkYXRhLWZpZWxkIjogaX0sIGhlYWRlciApOwoKCQkJLy8gQWRkaW5nIENTUyBjbGFzcyBpZiAiY29sdW1uIiBpcyBzb3J0YWJsZQoJCQlpZiAoIGFycmF5LmNvbnRhaW5zKCBvYmouc29ydGFibGUsIGkgKSApIHsKCQkJCWVsZW1lbnQua2xhc3MoIGVsLCAic29ydGFibGUiLCB0cnVlICk7CgoJCQkJLy8gQXBwbHlpbmcgZGVmYXVsdCBzb3J0LCBpZiBzcGVjaWZpZWQKCQkJCWlmICggc29ydC5maWx0ZXIoIGZ1bmN0aW9uICggeCApIHsgcmV0dXJuICggeC5pbmRleE9mKCBpICkgPT09IDAgKTsgfSApLmxlbmd0aCA+IDAgKSB7CgkJCQkJZWxlbWVudC5kYXRhKCBlbCwgInNvcnQiLCBhcnJheS5jb250YWlucyggc29ydCwgaSArICIgZGVzYyIgKSA/ICJkZXNjIiA6ICJhc2MiICk7CgkJCQl9CgkJCX0KCgkJCXRlbXBsYXRlICs9ICI8c3BhbiBjbGFzcz1cIiIgKyBpICsgIlwiIGRhdGEtZmllbGQ9XCIiICsgaSArICJcIiBzdHlsZT1cIiIgKyBjc3MgKyAiXCI+e3siICsgaSArICJ9fTwvc3Bhbj4iOwoJCX0gKTsKCgkJLy8gU2V0dGluZyBjbGljayBoYW5kbGVyIG9uIHNvcnRhYmxlICJjb2x1bW5zIgoJCWlmICggb2JqLnNvcnRhYmxlLmxlbmd0aCA+IDAgKSB7CgkJCW9iai5vYnNlcnZlci5ob29rKCBoZWFkZXIucGFyZW50Tm9kZSwgImNsaWNrIiwgb2JqLnNvcnQsICJzb3J0Iiwgb2JqICk7CgkJfQoKCQkvLyBDcmVhdGluZyBEYXRhTGlzdAoJCXJlZi5wdXNoKCBsaXN0LmZhY3RvcnkoIG9iai5lbGVtZW50LCByZWZbMF0sIHRlbXBsYXRlLCBvYmoub3B0aW9ucyApICk7CgoJCS8vIFNldHRpbmcgYnktcmVmZXJlbmNlIERhdGFMaXN0IG9uIERhdGFHcmlkCgkJb2JqLmxpc3QgPSByZWZbMV07CgoJCWlmICggb2JqLmZpbHRlcmVkID09PSB0cnVlICkgewoJCQkvLyBDcmVhdGluZyBEYXRhTGlzdEZpbHRlcgoJCQlyZWYucHVzaCggZmlsdGVyLmZhY3RvcnkoIGVsZW1lbnQuY3JlYXRlKCAiaW5wdXQiLCB7ImNsYXNzIjogImZpbHRlciIsIHBsYWNlaG9sZGVyOiAiRmlsdGVyIn0sIG9iai5lbGVtZW50LCAiZmlyc3QiICksIHJlZlsxXSwgb2JqLmZpZWxkcy5qb2luKCAiLCIgKSwgZGVib3VuY2UgfHwgMjUwICkgKTsKCQkJCgkJCS8vIFNldHRpbmcgYnktcmVmZXJlbmNlIERhdGFMaXN0RmlsdGVyIG9uIERhdGFHcmlkCgkJCW9iai5maWx0ZXIgPSByZWZbMl07CgkJfQoKCQkvLyBTZXR0aW5nIHVwIGEgY2hhaW4gb2YgRXZlbnRzCgkJb2JqLm9uKCAiYmVmb3JlUmVmcmVzaCIsIGZ1bmN0aW9uICggYXJnICkgewoJCQllbGVtZW50LmRpc3BhdGNoKCBhcmcsICJiZWZvcmVSZWZyZXNoIiApOwoJCX0sICJidWJibGUiICk7CgoJCW9iai5vbiggImFmdGVyUmVmcmVzaCIsIGZ1bmN0aW9uICggYXJnICkgewoJCQllbGVtZW50LmRpc3BhdGNoKCBhcmcsICJhZnRlclJlZnJlc2giICk7CgkJfSwgImJ1YmJsZSIgKTsKCgkJb2JqLm9uKCAiY2xpY2siLCBmdW5jdGlvbiAoIGUgKSB7CgkJCWlmICggZWxlbWVudC5oYXNDbGFzcyggZS5jdXJyZW50VGFyZ2V0LCAiaGVhZGVyIiApICkgewoJCQkJb2JqLnNvcnQoIGUgKTsKCQkJfQoJCX0sICJoZWFkZXIiICk7CgoJCW9iai5saXN0Lm9uKCAiY2hhbmdlIiwgZnVuY3Rpb24gKCkgewoJCQlvYmouZGlzcGF0Y2guYXBwbHkoIG9iaiwgWyJjaGFuZ2UiXS5jb25jYXQoIGFycmF5LmNhc3QoIGFyZ3VtZW50cyApICkgKTsKCQl9LCAiY2hhbmdlIiApOwoKCQlvYmoubGlzdC5vbiggImJlZm9yZUZpbHRlciIsIGZ1bmN0aW9uICgpIHsKCQkJb2JqLmRpc3BhdGNoLmFwcGx5KCBvYmosIFsiYmVmb3JlRmlsdGVyIl0uY29uY2F0KCBhcnJheS5jYXN0KCBhcmd1bWVudHMgKSApICk7CgkJfSwgImJlZm9yZUZpbHRlciIgKTsKCgkJb2JqLmxpc3Qub24oICJhZnRlckZpbHRlciIsIGZ1bmN0aW9uICgpIHsKCQkJb2JqLmRpc3BhdGNoLmFwcGx5KCBvYmosIFsiYWZ0ZXJGaWx0ZXIiXS5jb25jYXQoIGFycmF5LmNhc3QoIGFyZ3VtZW50cyApICkgKTsKCQl9LCAiYWZ0ZXJGaWx0ZXIiICk7CgoJCXJldHVybiBvYmo7Cgl9Cn07CgovKioKICogQ3JlYXRlcyBhIG5ldyBEYXRhR3JpZAogKgogKiBAY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaQogKiBAZXh0ZW5kcyB7a2VpZ2FpLkJhc2V9CiAqIEBwYXJhbSAge09iamVjdH0gIHRhcmdldCAgIEVsZW1lbnQgdG8gcmVjZWl2ZSBEYXRhR3JpZAogKiBAcGFyYW0gIHtPYmplY3R9ICBzdG9yZSAgICBEYXRhU3RvcmUKICogQHBhcmFtICB7QXJyYXl9ICAgZmllbGRzICAgQXJyYXkgb2YgZmllbGRzIHRvIGRpc3BsYXkKICogQHBhcmFtICB7QXJyYXl9ICAgc29ydGFibGUgW09wdGlvbmFsXSBBcnJheSBvZiBzb3J0YWJsZSBjb2x1bW5zL2ZpZWxkcwogKiBAcGFyYW0gIHtPYmplY3R9ICBvcHRpb25zICBbT3B0aW9uYWxdIERhdGFMaXN0IG9wdGlvbnMKICogQHBhcmFtICB7Qm9vbGVhbn0gZmlsdGVyZWQgW09wdGlvbmFsXSBDcmVhdGUgYW4gaW5wdXQgdG8gZmlsdGVyIHRoZSBEYXRhR3JpZAogKiBAZXhhbXBsZQogKiB2YXIgZmllbGRzICA9IFsibmFtZSIsICJhZ2UiXSwKICogICAgIG9wdGlvbnMgPSB7cGFnZVNpemU6IDUsIG9yZGVyOiAiYWdlIGRlc2MsIG5hbWUifSwKICogICAgIHN0b3JlICAgPSBrZWlnYWkuc3RvcmUoIFsuLi5dICksCiAqICAgICBncmlkICAgID0ga2VpZ2FpLmdyaWQoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjZ3JpZCIgKSwgc3RvcmUsIGZpZWxkcywgZmllbGRzLCBvcHRpb25zLCB0cnVlICk7CiAqLwpmdW5jdGlvbiBEYXRhR3JpZCAoIHRhcmdldCwgc3RvcmUsIGZpZWxkcywgc29ydGFibGUsIG9wdGlvbnMsIGZpbHRlcmVkICkgewoJdmFyIHNvcnRPcmRlcjsKCglpZiAoIG9wdGlvbnMub3JkZXIgJiYgIXN0cmluZy5pc0VtcHR5KCBvcHRpb25zLm9yZGVyICkgKSB7CgkJc29ydE9yZGVyID0gc3RyaW5nLmV4cGxvZGUoIG9wdGlvbnMub3JkZXIgKS5tYXAoIGZ1bmN0aW9uICggaSApIHsKCQkJcmV0dXJuIGkucmVwbGFjZSggcmVnZXguYWZ0ZXJfc3BhY2UsICIiICk7CgkJfSApOwoJfQoKCXRoaXMuZWxlbWVudCAgID0gZWxlbWVudC5jcmVhdGUoICJzZWN0aW9uIiwgeyJjbGFzcyI6ICJncmlkIn0sIHRhcmdldCApOwoJdGhpcy5maWVsZHMgICAgPSBmaWVsZHM7Cgl0aGlzLmZpbHRlciAgICA9IG51bGw7Cgl0aGlzLmZpbHRlcmVkICA9IGZpbHRlcmVkID09PSB0cnVlOwoJdGhpcy5saXN0ICAgICAgPSBudWxsOwoJdGhpcy5vYnNlcnZlciAgPSBvYnNlcnZhYmxlLmZhY3RvcnkoKTsKCXRoaXMub3B0aW9ucyAgID0gb3B0aW9ucyAgIHx8IHt9OwoJdGhpcy5zdG9yZSAgICAgPSBzdG9yZTsKCXRoaXMuc29ydGFibGUgID0gc29ydGFibGUgIHx8IFtdOwoJdGhpcy5zb3J0T3JkZXIgPSBzb3J0T3JkZXIgfHwgc29ydGFibGUgfHwgW107Cn0KCi8qKgogKiBFeHRlbmRpbmcgQmFzZQogKgogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFHcmlkCiAqIEB0eXBlIHtPYmplY3R9IHtAbGluayBrZWlnYWkuQmFzZX0KICovCkRhdGFHcmlkLnByb3RvdHlwZSA9IGJhc2UuZmFjdG9yeSgpOwoKLyoqCiAqIFNldHRpbmcgY29uc3RydWN0b3IgbG9vcAogKgogKiBAbWV0aG9kIGNvbnN0cnVjdG9yCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUdyaWQKICogQHR5cGUge0Z1bmN0aW9ufQogKiBAcHJpdmF0ZQogKi8KRGF0YUdyaWQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRGF0YUdyaWQ7CgovKioKICogQWRkcyBhbiBpdGVtIHRvIHRoZSBEYXRhR3JpZAogKgogKiBAbWV0aG9kIGFkZAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFHcmlkCiAqIEBwYXJhbSB7T2JqZWN0fSByZWNvcmQgTmV3IERhdGFTdG9yZSByZWNvcmQgKHNoYXBlcyBzaG91bGQgbWF0Y2gpCiAqIEByZXR1cm4ge09iamVjdH0gICAgICAge0BsaW5rIGtlaWdhaS5EYXRhR3JpZH0KICogQGV4YW1wbGUKICogZ3JpZC5hZGQoIHtuYW1lOiAiSm9obiBEb2UiLCBhZ2U6IDM0fSApOwogKi8KRGF0YUdyaWQucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uICggcmVjb3JkICkgewoJdmFyIHNlbGYgPSB0aGlzOwoKCXRoaXMuc3RvcmUuc2V0KCBudWxsLCByZWNvcmQgKS50aGVuKCBudWxsLCBmdW5jdGlvbiAoIGUgKSB7CgkJdXRpbGl0eS5lcnJvciggZSApOwoJCXNlbGYuZGlzcGF0Y2goICJlcnJvciIsIGUgKTsKCX0gKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBFeHBvcnRzIGRhdGEgZ3JpZCByZWNvcmRzCiAqCiAqIEBtZXRob2QgZHVtcAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFHcmlkCiAqIEByZXR1cm4ge0FycmF5fSBSZWNvcmQgc2V0CiAqIEBleGFtcGxlCiAqIHZhciBkYXRhID0gZ3JpZC5kdW1wKCk7CiAqLwpEYXRhR3JpZC5wcm90b3R5cGUuZHVtcCA9IGZ1bmN0aW9uICgpIHsKCXJldHVybiB0aGlzLnN0b3JlLmR1bXAoIHRoaXMubGlzdC5yZWNvcmRzLCB0aGlzLmZpZWxkcyApOwp9OwoKLyoqCiAqIFJlZnJlc2hlcyB0aGUgRGF0YUdyaWQKICoKICogQG1ldGhvZCByZWZyZXNoCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUdyaWQKICogQGZpcmVzIGtlaWdhaS5EYXRhR3JpZCNiZWZvcmVSZWZyZXNoIEZpcmVzIGJlZm9yZSByZWZyZXNoCiAqIEBmaXJlcyBrZWlnYWkuRGF0YUdyaWQjYWZ0ZXJSZWZyZXNoIEZpcmVzIGFmdGVyIHJlZnJlc2gKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRhdGFHcmlkfQogKiBAZXhhbXBsZQogKiBncmlkLnJlZnJlc2goKTsKICovCkRhdGFHcmlkLnByb3RvdHlwZS5yZWZyZXNoID0gZnVuY3Rpb24gKCkgewoJdmFyIHNvcnQgPSBbXSwKCSAgICBzZWxmID0gdGhpczsKCgl0aGlzLmRpc3BhdGNoKCAiYmVmb3JlUmVmcmVzaCIsIHRoaXMuZWxlbWVudCApOwoKCWlmICggdGhpcy5zb3J0T3JkZXIubGVuZ3RoID4gMCApIHsKCQlhcnJheS5lYWNoKCB0aGlzLnNvcnRPcmRlciwgZnVuY3Rpb24gKCBpICkgewoJCQl2YXIgb2JqID0gZWxlbWVudC5maW5kKCBzZWxmLmVsZW1lbnQsICIuaGVhZGVyIHNwYW5bZGF0YS1maWVsZD0nIiArIGkgKyAiJ10iIClbMF07CgoJCQlzb3J0LnB1c2goIHN0cmluZy50cmltKCBpICsgIiAiICsgKCBlbGVtZW50LmRhdGEoIG9iaiwgInNvcnQiICkgfHwgIiIgKSApICk7CgkJfSApOwoKCQl0aGlzLm9wdGlvbnMub3JkZXIgPSB0aGlzLmxpc3Qub3JkZXIgPSBzb3J0LmpvaW4oICIsICIgKTsKCX0KCgl0aGlzLmxpc3Qud2hlcmUgPSBudWxsOwoJdXRpbGl0eS5tZXJnZSggdGhpcy5saXN0LCB0aGlzLm9wdGlvbnMgKTsKCXRoaXMubGlzdC5yZWZyZXNoKCk7CgoJdGhpcy5kaXNwYXRjaCggImFmdGVyUmVmcmVzaCIsIHRoaXMuZWxlbWVudCApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIFJlbW92ZXMgYW4gaXRlbSBmcm9tIHRoZSBEYXRhR3JpZAogKgogKiBAbWV0aG9kIHJlbW92ZQogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFHcmlkCiAqIEBwYXJhbSB7TWl4ZWR9IHJlY29yZCBSZWNvcmQsIGtleSBvciBpbmRleAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUdyaWR9CiAqIEBleGFtcGxlCiAqIGdyaWQucmVtb3ZlKCAia2V5IiApOwogKi8KRGF0YUdyaWQucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uICggcmVjb3JkICkgewoJdmFyIHNlbGYgPSB0aGlzOwoKCXRoaXMuc3RvcmUuZGVsKCByZWNvcmQgKS50aGVuKCBudWxsLCBmdW5jdGlvbiAoIGUgKSB7CgkJdXRpbGl0eS5lcnJvciggZSApOwoJCXNlbGYuZGlzcGF0Y2goICJlcnJvciIsIGUgKTsKCX0gKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBTb3J0cyB0aGUgRGF0YUdyaWQgd2hlbiBhIGNvbHVtbiBoZWFkZXIgaXMgY2xpY2tlZAogKgogKiBAbWV0aG9kIHNvcnQKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhR3JpZAogKiBAcGFyYW0gIHtPYmplY3R9IGV2IEV2ZW50CiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhR3JpZH0KICovCkRhdGFHcmlkLnByb3RvdHlwZS5zb3J0ID0gZnVuY3Rpb24gKCBldiApIHsKCXZhciB0YXJnZXQgPSB1dGlsaXR5LnRhcmdldCggZXYgKSwKCSAgICBmaWVsZDsKCgkvLyBTdG9wcGluZyBldmVudCBwcm9wb2dhdGlvbgoJdXRpbGl0eS5zdG9wKCBldiApOwoKCS8vIFJlZnJlc2hpbmcgbGlzdCBpZiB0YXJnZXQgaXMgc29ydGFibGUKCWlmICggZWxlbWVudC5oYXNDbGFzcyggdGFyZ2V0LCAic29ydGFibGUiICkgKSB7CgkJZmllbGQgPSBlbGVtZW50LmRhdGEoIHRhcmdldCwgImZpZWxkIiApOwoJCWVsZW1lbnQuZGF0YSggdGFyZ2V0LCAic29ydCIsIGVsZW1lbnQuZGF0YSggdGFyZ2V0LCAic29ydCIgKSA9PT0gImFzYyIgPyAiZGVzYyIgOiAiYXNjIiApOwoJCWFycmF5LnJlbW92ZSggdGhpcy5zb3J0T3JkZXIsIGZpZWxkICk7CgkJdGhpcy5zb3J0T3JkZXIuc3BsaWNlKCAwLCAwLCBmaWVsZCApOwoJCXRoaXMucmVmcmVzaCgpOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIFRlYXJzIGRvd24gdGhlIERhdGFHcmlkCiAqCiAqIEBtZXRob2QgdGVhcmRvd24KICogQG1lbWJlck9mIGtlaWdhaS5EYXRhR3JpZAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUdyaWR9CiAqIEBleGFtcGxlCiAqIGdyaWQudGVhcmRvd24oKTsKICovCkRhdGFHcmlkLnByb3RvdHlwZS50ZWFyZG93biA9IGZ1bmN0aW9uICgpIHsKCWlmICggdGhpcy5maWx0ZXIgIT09IG51bGwgKSB7CgkJdGhpcy5maWx0ZXIudGVhcmRvd24oKTsKCQl0aGlzLmZpbHRlciA9IG51bGw7Cgl9CgoJdGhpcy5saXN0LnRlYXJkb3duKCk7Cgl0aGlzLm9ic2VydmVyLnVuaG9vayggZWxlbWVudC5maW5kKCB0aGlzLmVsZW1lbnQsICIuaGVhZGVyIiApWzBdLCAiY2xpY2siICk7CgllbGVtZW50LmRlc3Ryb3koIHRoaXMuZWxlbWVudCApOwoJdGhpcy5lbGVtZW50ID0gbnVsbDsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBVcGRhdGVzIGFuIGl0ZW0gaW4gdGhlIERhdGFHcmlkCiAqCiAqIEBtZXRob2QgdXBkYXRlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUdyaWQKICogQHBhcmFtIHtNaXhlZH0gIGtleSAgS2V5IG9yIGluZGV4CiAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIE5ldyBwcm9wZXJ0eSB2YWx1ZXMKICogQHJldHVybiB7T2JqZWN0fSAgICAge0BsaW5rIGtlaWdhaS5EYXRhR3JpZH0KICogQGV4YW1wbGUKICogZ3JpZC51cGRhdGUoICJrZXkiLCB7bmFtZTogIkppbSBTbWl0aCJ9ICk7CiAqLwpEYXRhR3JpZC5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKCBrZXksIGRhdGEgKSB7Cgl2YXIgc2VsZiA9IHRoaXM7CgoJdGhpcy5zdG9yZS51cGRhdGUoIGtleSwgZGF0YSApLnRoZW4oIG51bGwsIGZ1bmN0aW9uICggZSApIHsKCQl1dGlsaXR5LmVycm9yKCBlICk7CgkJc2VsZi5kaXNwYXRjaCggImVycm9yIiwgZSApOwoJfSApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEBuYW1lc3BhY2UgbGlzdAogKi8KdmFyIGxpc3QgPSB7CgkvKioKCSAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgRGF0YUxpc3QKCSAqCgkgKiBAbWV0aG9kIGZhY3RvcnkKCSAqIEBtZW1iZXJPZiBsaXN0CgkgKiBAZmlyZXMga2VpZ2FpLkRhdGFMaXN0I2NoYW5nZSBGaXJlcyB3aGVuIHRoZSBET00gY2hhbmdlcwoJICogQHBhcmFtICB7T2JqZWN0fSB0YXJnZXQgICBFbGVtZW50IHRvIHJlY2VpdmUgdGhlIERhdGFMaXN0CgkgKiBAcGFyYW0gIHtPYmplY3R9IHN0b3JlICAgIHtAbGluayBrZWlnYWkuRGF0YVN0b3JlfQoJICogQHBhcmFtICB7TWl4ZWR9ICB0ZW1wbGF0ZSBSZWNvcmQgZmllbGQsIHRlbXBsYXRlICggJC50cGwgKSwgb3IgU3RyaW5nLCBlLmcuICI8cD50aGlzIGlzIGEge3tmaWVsZH19IHNhbXBsZS48L3A+IiwgZmllbGRzIGFyZSBtYXJrZWQgd2l0aCB7eyB9fQoJICogQHBhcmFtICB7T2JqZWN0fSBvcHRpb25zICBPcHRpb25hbCBwYXJhbWV0ZXJzIHRvIHNldCBvbiB0aGUgRGF0YUxpc3QKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhTGlzdH0KCSAqIEBleGFtcGxlCgkgKiB2YXIgc3RvcmUgPSBrZWlnYWkuc3RvcmUoIFsuLi5dICksCgkgKiAgICAgbGlzdCAgPSBrZWlnYWkubGlzdCggZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI2xpc3QiKSwgc3RvcmUsICJ7e25hbWV9fSIsIHtvcmRlcjogIm5hbWUifSApOwoJICovCglmYWN0b3J5IDogZnVuY3Rpb24gKCB0YXJnZXQsIHN0b3JlLCB0ZW1wbGF0ZSwgb3B0aW9ucyApIHsKCQl2YXIgcmVmID0gW3N0b3JlXSwKCQkgICAgb2JqOwoKCQlpZiAoICEoIHRhcmdldCBpbnN0YW5jZW9mIEVsZW1lbnQgKSB8fCB0eXBlb2Ygc3RvcmUgIT0gIm9iamVjdCIgfHwgIXJlZ2V4LnN0cmluZ19vYmplY3QudGVzdCggdHlwZW9mIHRlbXBsYXRlICkgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApOwoJCX0KCgkJLy8gQ3JlYXRpbmcgaW5zdGFuY2UKCQlvYmogPSBuZXcgRGF0YUxpc3QoIGVsZW1lbnQuY3JlYXRlKCAidWwiLCB7ImNsYXNzIjogImxpc3QifSwgdGFyZ2V0ICksIHJlZlswXSwgdGVtcGxhdGUgKTsKCgkJaWYgKCBvcHRpb25zIGluc3RhbmNlb2YgT2JqZWN0ICkgewoJCQlpZiAoIG9wdGlvbnMubGlzdEZpbHRlcmVkICYmIG9wdGlvbnMubGlzdEZpbHRlciApIHsKCQkJCW9iai5saXN0RmlsdGVyID0gZmlsdGVyLmZhY3RvcnkoIGVsZW1lbnQuY3JlYXRlKCAiaW5wdXQiLCB7ImlkIjogb2JqLmVsZW1lbnQuaWQgKyAiLWZpbHRlciIsICJjbGFzcyI6ICJmaWx0ZXIiLCBwbGFjZWhvbGRlcjogIkZpbHRlciJ9LCB0YXJnZXQsICJmaXJzdCIgKSwgb2JqLCBvcHRpb25zLmxpc3RGaWx0ZXIsIG9wdGlvbnMuZGVib3VuY2UgfHwgMjUwICk7CgkJCQlkZWxldGUgb3B0aW9ucy5saXN0RmlsdGVyOwoJCQkJZGVsZXRlIG9wdGlvbnMubGlzdEZpbHRlcmVkOwoJCQl9CgoJCQl1dGlsaXR5Lm1lcmdlKCBvYmosIG9wdGlvbnMgKTsKCQl9CgoJCW9iai5zdG9yZS5saXN0cy5wdXNoKCBvYmogKTsKCgkJLy8gU2V0dGluZyB1cCBhIGNoYWluIG9mIEV2ZW50cwoJCW9iai5vbiggImJlZm9yZVJlZnJlc2giLCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJZWxlbWVudC5kaXNwYXRjaCggYXJnLCAiYmVmb3JlUmVmcmVzaCIgKTsKCQl9LCAiYnViYmxlIiApOwoKCQlvYmoub24oICJhZnRlclJlZnJlc2giLCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJZWxlbWVudC5kaXNwYXRjaCggYXJnLCAiYWZ0ZXJSZWZyZXNoIiApOwoJCX0sICJidWJibGUiICk7CgoJCW9iai5vbiggImNoYW5nZSIsIGZ1bmN0aW9uICggYXJnICkgewoJCQllbGVtZW50LmRpc3BhdGNoKCBvYmouZWxlbWVudCwgImNoYW5nZSIsIGFyZyApOwoJCX0sICJjaGFuZ2UiICk7CgoJCW9iai5vbiggImNsaWNrIiwgZnVuY3Rpb24gKCBlICkgewoJCQl2YXIgdGFyZ2V0ID0gdXRpbGl0eS50YXJnZXQoIGUgKSwKCQkJICAgIHBhZ2U7CgoJCQl1dGlsaXR5LnN0b3AoIGUgKTsKCgkJCWlmICggdGFyZ2V0Lm5vZGVOYW1lID09PSAiQSIgKSB7CgkJCQlwYWdlID0gZWxlbWVudC5kYXRhKCB0YXJnZXQsICJwYWdlIiApOwoKCQkJCWlmICggIWlzTmFOKCBwYWdlICkgKSB7CgkJCQkJb2JqLnBhZ2UoIHBhZ2UgKTsKCQkJCX0KCQkJfQoJCX0sICJwYWdpbmF0aW9uIiApOwoKCQlpZiAoIHR5cGVvZiBNdXRhdGlvbk9ic2VydmVyID09ICJmdW5jdGlvbiIgKSB7CgkJCW9iai5tdXRhdGlvbiA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCW9iai5kaXNwYXRjaCggImNoYW5nZSIsIGFyZyApOwoJCQl9ICk7CgoJCQlvYmoubXV0YXRpb24ub2JzZXJ2ZSggb2JqLmVsZW1lbnQsIHtjaGlsZExpc3Q6IHRydWUsIHN1YnRyZWU6IHRydWV9ICk7CgkJfQoKCQkvLyBSZW5kZXJpbmcgaWYgbm90IHRpZWQgdG8gYW4gQVBJIG9yIGRhdGEgaXMgcmVhZHkKCQlpZiAoIG9iai5zdG9yZS51cmkgPT09IG51bGwgfHwgb2JqLnN0b3JlLmxvYWRlZCApIHsKCQkJb2JqLnJlZnJlc2goKTsKCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogQ2FsY3VsYXRlcyB0aGUgdG90YWwgcGFnZXMKCSAqCgkgKiBAbWV0aG9kIHBhZ2VzCgkgKiBAbWVtYmVyT2YgbGlzdAoJICogQHJldHVybiB7TnVtYmVyfSBUb3RhbCBwYWdlcwoJICogQHByaXZhdGUKCSAqLwoJcGFnZXMgOiBmdW5jdGlvbiAoKSB7CgkJaWYgKCBpc05hTiggdGhpcy5wYWdlU2l6ZSApICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCQl9CgoJCXJldHVybiBNYXRoLmNlaWwoICggIXRoaXMuZmlsdGVyID8gdGhpcy50b3RhbCA6IHRoaXMuZmlsdGVyZWQubGVuZ3RoICkgLyB0aGlzLnBhZ2VTaXplICk7Cgl9LAoKCS8qKgoJICogQ2FsY3VsYXRlcyB0aGUgcGFnZSBzaXplIGFzIGFuIEFycmF5IG9mIHN0YXJ0ICYgZmluaXNoCgkgKgoJICogQG1ldGhvZCByYW5nZQoJICogQG1lbWJlck9mIGxpc3QKCSAqIEByZXR1cm4ge0FycmF5fSAgQXJyYXkgb2Ygc3RhcnQgJiBlbmQgbnVtYmVycwoJICogQHByaXZhdGUKCSAqLwoJcmFuZ2UgOiBmdW5jdGlvbiAoKSB7CgkJdmFyIHN0YXJ0ID0gKCB0aGlzLnBhZ2VJbmRleCAqIHRoaXMucGFnZVNpemUgKSAtIHRoaXMucGFnZVNpemUsCgkJICAgIGVuZCAgID0gdGhpcy5wYWdlU2l6ZTsKCgkJcmV0dXJuIFtzdGFydCwgZW5kXTsKCX0KfTsKCi8qKgogKiBDcmVhdGVzIGEgbmV3IERhdGFMaXN0CiAqCiAqIEBjb25zdHJ1Y3RvcgogKiBAbWVtYmVyT2Yga2VpZ2FpCiAqIEBleHRlbmRzIHtrZWlnYWkuQmFzZX0KICogQGV4YW1wbGUKICogdmFyIHN0b3JlID0ga2VpZ2FpLnN0b3JlKCBbLi4uXSApLAogKiAgICAgbGlzdCAgPSBrZWlnYWkubGlzdCggZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiI2xpc3QiKSwgc3RvcmUsICJ7e25hbWV9fSIsIHtvcmRlcjogIm5hbWUifSApOwogKi8KZnVuY3Rpb24gRGF0YUxpc3QgKCBlbGVtZW50LCBzdG9yZSwgdGVtcGxhdGUgKSB7Cgl0aGlzLmNhbGxiYWNrICAgID0gbnVsbDsKCXRoaXMuY3VycmVudCAgICAgPSBbXTsKCXRoaXMuZWxlbWVudCAgICAgPSBlbGVtZW50OwoJdGhpcy5lbXB0eU1zZyAgICA9IGxhYmVsLm5vRGF0YTsKCXRoaXMuZmlsdGVyICAgICAgPSBudWxsOwoJdGhpcy5maWx0ZXJlZCAgICA9IFtdOwoJdGhpcy5pZCAgICAgICAgICA9IHV0aWxpdHkuZ2VuSWQoKTsKCXRoaXMuaXRlbXMgICAgICAgPSBbXTsKCXRoaXMubGlzdEZpbHRlciAgPSBudWxsOwoJdGhpcy5tdXRhdGlvbiAgICA9IG51bGw7Cgl0aGlzLm9ic2VydmVyICAgID0gb2JzZXJ2YWJsZS5mYWN0b3J5KCk7Cgl0aGlzLnBhZ2VJbmRleCAgID0gMTsKCXRoaXMucGFnZVNpemUgICAgPSBudWxsOwoJdGhpcy5wYWdlUmFuZ2UgICA9IDU7Cgl0aGlzLnBhZ2luYXRpb24gID0gImJvdHRvbSI7IC8vICJ0b3AiIG9yICJib3R0b218dG9wIiBhcmUgYWxzbyB2YWxpZAoJdGhpcy5wbGFjZWhvbGRlciA9ICIiOwoJdGhpcy5vcmRlciAgICAgICA9ICIiOwoJdGhpcy5yZWNvcmRzICAgICA9IFtdOwoJdGhpcy50ZW1wbGF0ZSAgICA9IHRlbXBsYXRlOwoJdGhpcy50b3RhbCAgICAgICA9IDA7Cgl0aGlzLnN0b3JlICAgICAgID0gc3RvcmU7Cgl0aGlzLndoZXJlICAgICAgID0gbnVsbDsKfQoKLyoqCiAqIEV4dGVuZGluZyBCYXNlCiAqCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3QKICogQHR5cGUge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKi8KRGF0YUxpc3QucHJvdG90eXBlID0gYmFzZS5mYWN0b3J5KCk7CgovKioKICogU2V0dGluZyBjb25zdHJ1Y3RvciBsb29wCiAqCiAqIEBtZXRob2QgY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhTGlzdAogKiBAdHlwZSB7RnVuY3Rpb259CiAqIEBwcml2YXRlCiAqLwpEYXRhTGlzdC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEYXRhTGlzdDsKCi8qKgogKiBBZGRzIGFuIGl0ZW0gdG8gdGhlIERhdGFMaXN0CiAqCiAqIEBtZXRob2QgYWRkCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3QKICogQHBhcmFtIHtPYmplY3R9IHJlY29yZCBOZXcgRGF0YVN0b3JlIHJlY29yZCAoc2hhcGVzIHNob3VsZCBtYXRjaCkKICogQHJldHVybiB7T2JqZWN0fSAgICAgICB7QGxpbmsga2VpZ2FpLkRhdGFMaXN0fQogKiBAZXhhbXBsZQogKiBsaXN0LmFkZCgge25hbWU6ICJKb2huIERvZSIsIGFnZTogMzR9ICk7CiAqLwpEYXRhTGlzdC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gKCByZWNvcmQgKSB7Cgl2YXIgc2VsZiA9IHRoaXM7CgoJdGhpcy5zdG9yZS5zZXQoIG51bGwsIHJlY29yZCApLnRoZW4oIG51bGwsIGZ1bmN0aW9uICggZSApIHsKCQl1dGlsaXR5LmVycm9yKCBlICk7CgkJc2VsZi5kaXNwYXRjaCggImVycm9yIiwgZSApOwoJfSApOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIEV4cG9ydHMgZGF0YSBsaXN0IHJlY29yZHMKICoKICogQG1ldGhvZCBkdW1wCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3QKICogQHJldHVybiB7QXJyYXl9IFJlY29yZCBzZXQKICogQGV4YW1wbGUKICogdmFyIGRhdGEgPSBsaXN0LmR1bXAoKTsKICovCkRhdGFMaXN0LnByb3RvdHlwZS5kdW1wID0gZnVuY3Rpb24gKCkgewoJcmV0dXJuIHRoaXMuc3RvcmUuZHVtcCggdGhpcy5yZWNvcmRzICk7Cn07CgovKioKICogQ2hhbmdlcyB0aGUgcGFnZSBpbmRleCBvZiB0aGUgRGF0YUxpc3QKICoKICogQG1ldGhvZCBwYWdlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3QKICogQHBhcmFtICB7TnVtYmVyfSBuIFBhZ2UgdG8gdmlldwogKiBAcmV0dXJuIHtPYmplY3R9ICAge0BsaW5rIGtlaWdhaS5EYXRhTGlzdH0KICogQGV4YW1wbGUKICogbGlzdC5wYWdlKCAyICk7CiAqLwpEYXRhTGlzdC5wcm90b3R5cGUucGFnZSA9IGZ1bmN0aW9uICggbiApIHsKCXRoaXMucGFnZUluZGV4ID0gbjsKCglyZXR1cm4gdGhpcy5yZWZyZXNoKCk7Cn07CgovKioKICogQWRkcyBwYWdpbmF0aW9uIEVsZW1lbnRzIHRvIHRoZSBWaWV3LCBleGVjdXRlZCBmcm9tIGBEYXRhTGlzdC5yZWZyZXNoKClgCiAqCiAqIEBtZXRob2QgcGFnZXMKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhTGlzdAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUxpc3R9CiAqIEBleGFtcGxlCiAqIGxpc3QucGFnZXMoKTsKICovCkRhdGFMaXN0LnByb3RvdHlwZS5wYWdlcyA9IGZ1bmN0aW9uICgpIHsKCXZhciBzZWxmICA9IHRoaXMsCgkgICAgb2JqICAgPSB0aGlzLmVsZW1lbnQsCgkgICAgcGFnZSAgPSB0aGlzLnBhZ2VJbmRleCwKCSAgICBwb3MgICA9IHRoaXMucGFnaW5hdGlvbiwKCSAgICByYW5nZSA9IHRoaXMucGFnZVJhbmdlLAoJICAgIG1pZCAgID0gTWF0aC5mbG9vciggcmFuZ2UgLyAyICksCgkgICAgc3RhcnQgPSBwYWdlIC0gbWlkLAoJICAgIGVuZCAgID0gcGFnZSArIG1pZCwKCSAgICB0b3RhbCA9IGxpc3QucGFnZXMuY2FsbCggdGhpcyApLAoJICAgIGRpZmY7CgoJaWYgKCAhcmVnZXgudG9wX2JvdHRvbS50ZXN0KCBwb3MgKSApIHsKCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCX0KCgkvLyBSZW1vdmluZyB0aGUgZXhpc3RpbmcgY29udHJvbHMKCWFycmF5LmVhY2goIHV0aWxpdHkuZG9tKCAiIyIgKyBvYmouaWQgKyAiLXBhZ2VzLXRvcCwgIyIgKyBvYmouaWQgKyAiLXBhZ2VzLWJvdHRvbSIgKSwgZnVuY3Rpb24gKCBpICkgewoJCWlmICggaSApIHsKCQkJc2VsZi5vYnNlcnZlci51bmhvb2soIGksICJjbGljayIgKTsKCQkJZWxlbWVudC5kZXN0cm95KCBpICk7CgkJfQoJfSApOwoJCgkvLyBIYWx0aW5nIGJlY2F1c2UgdGhlcmUncyAxIHBhZ2UsIG9yIG5vdGhpbmcKCWlmICggKCB0aGlzLmZpbHRlciAmJiB0aGlzLmZpbHRlcmVkLmxlbmd0aCA9PT0gMCApIHx8IHRoaXMudG90YWwgPT09IDAgfHwgdG90YWwgPT09IDEgKSB7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLy8gR2V0dGluZyB0aGUgcmFuZ2UgdG8gZGlzcGxheQoJaWYgKCBzdGFydCA8IDEgKSB7CgkJZGlmZiAgPSBudW1iZXIuZGlmZiggc3RhcnQsIDEgKTsKCQlzdGFydCA9IHN0YXJ0ICsgZGlmZjsKCQllbmQgICA9IGVuZCAgICsgZGlmZjsKCX0KCglpZiAoIGVuZCA+IHRvdGFsICkgewoJCWVuZCAgID0gdG90YWw7CgkJc3RhcnQgPSAoIGVuZCAtIHJhbmdlICkgKyAxOwoKCQlpZiAoIHN0YXJ0IDwgMSApIHsKCQkJc3RhcnQgPSAxOwoJCX0KCX0KCglpZiAoIG51bWJlci5kaWZmKCBzdGFydCwgZW5kICkgPj0gcmFuZ2UgKSB7CgkJLS1lbmQ7Cgl9CgoJYXJyYXkuZWFjaCggc3RyaW5nLmV4cGxvZGUoIHBvcyApLCBmdW5jdGlvbiAoIGkgKSB7CgkJdmFyIGN1cnJlbnQgPSBmYWxzZSwKCQkgICAgbW9yZSAgICA9IHBhZ2UgPiAxLAoJCSAgICBuZXh0ICAgID0gKCBwYWdlICsgMSApIDw9IHRvdGFsLAoJCSAgICBsYXN0ICAgID0gKCBwYWdlID49IHRvdGFsICksCgkJICAgIGVsLCBuOwoKCQkvLyBTZXR0aW5nIHVwIHRoZSBsaXN0CgkJZWwgPSBlbGVtZW50LmNyZWF0ZSggInVsIiwgeyJjbGFzcyI6ICJsaXN0IHBhZ2VzIGhpZGRlbiAiICsgaSwgaWQ6IG9iai5pZCArICItcGFnZXMtIiArIGl9LCBvYmosIGkgPT09ICJib3R0b20iID8gImFmdGVyIiA6ICJiZWZvcmUiICk7CgoJCS8vIEZpcnN0IHBhZ2UKCQllbGVtZW50LmNyZWF0ZSggbW9yZSA/ICJhIiA6ICJzcGFuIiwgeyJjbGFzcyI6ICJmaXJzdCBwYWdlIiwgImRhdGEtcGFnZSI6IDEsIGlubmVySFRNTDogIiZsdDsmbHQ7In0sIGVsZW1lbnQuY3JlYXRlKCAibGkiLCB7fSwgZWwgKSApOwoKCQkvLyBQcmV2aW91cyBwYWdlCgkJZWxlbWVudC5jcmVhdGUoIG1vcmUgPyAiYSIgOiAic3BhbiIsIHsiY2xhc3MiOiAicHJldiBwYWdlIiwgImRhdGEtcGFnZSI6ICggcGFnZSAtIDEgKSwgaW5uZXJIVE1MOiAiJmx0OyJ9LCBlbGVtZW50LmNyZWF0ZSggImxpIiwge30sIGVsICkgKTsKCgkJLy8gUmVuZGVyaW5nIHRoZSBwYWdlIHJhbmdlCgkJZm9yICggbiA9IHN0YXJ0OyBuIDw9IGVuZDsgbisrICkgewoJCQljdXJyZW50ID0gKCBuID09PSBwYWdlICk7CgkJCWVsZW1lbnQuY3JlYXRlKCBjdXJyZW50ID8gInNwYW4iIDogImEiLCB7ImNsYXNzIjogY3VycmVudCA/ICJjdXJyZW50IHBhZ2UiIDogInBhZ2UiLCAiZGF0YS1wYWdlIjogbiwgaW5uZXJIVE1MOiBufSwgZWxlbWVudC5jcmVhdGUoICJsaSIsIHt9LCBlbCApICk7CgkJfQoKCQkvLyBOZXh0IHBhZ2UKCQllbGVtZW50LmNyZWF0ZSggbmV4dCA/ICJhIiA6ICJzcGFuIiwgeyJjbGFzcyI6ICJuZXh0IHBhZ2UiLCAiZGF0YS1wYWdlIjogbmV4dCA/ICggcGFnZSArIDEgKSA6IG51bGwsIGlubmVySFRNTDogIiZndDsifSwgZWxlbWVudC5jcmVhdGUoICJsaSIsIHt9LCBlbCApICk7CgoJCS8vIExhc3QgcGFnZQoJCWVsZW1lbnQuY3JlYXRlKCBsYXN0ID8gInNwYW4iIDogImEiLCB7ImNsYXNzIjogImxhc3QgcGFnZSIsICJkYXRhLXBhZ2UiOiBsYXN0ID8gbnVsbCA6IHRvdGFsLCBpbm5lckhUTUw6ICImZ3Q7Jmd0OyJ9LCBlbGVtZW50LmNyZWF0ZSggImxpIiwge30sIGVsICkgKTsKCgkJLy8gQWRkaW5nIHRvIERPTQoJCWVsZW1lbnQua2xhc3MoIGVsLCAiaGlkZGVuIiwgZmFsc2UgKTsKCgkJLy8gUGFnaW5hdGlvbiBsaXN0ZW5lcgoJCXNlbGYub2JzZXJ2ZXIuaG9vayggZWwsICJjbGljayIgKTsKCX0gKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBSZWZyZXNoZXMgZWxlbWVudAogKgogKiBAbWV0aG9kIHJlZnJlc2gKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhTGlzdAogKiBAZXh0ZW5kcyB7a2VpZ2FpLkJhc2V9CiAqIEBmaXJlcyBrZWlnYWkuRGF0YUxpc3QjYmVmb3JlUmVmcmVzaCBGaXJlcyBiZWZvcmUgcmVmcmVzaAogKiBAZmlyZXMga2VpZ2FpLkRhdGFMaXN0I2FmdGVyUmVmcmVzaCBGaXJlcyBhZnRlciByZWZyZXNoCiAqIEBmaXJlcyBrZWlnYWkuRGF0YUxpc3QjZXJyb3IgRmlyZXMgb24gZXJyb3IKICogQHBhcmFtICB7Qm9vbGVhbn0gY3JlYXRlIFtPcHRpb25hbF0gUmVjcmVhdGVzIGNhY2hlZCBWaWV3IG9mIGRhdGEKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRhdGFMaXN0fQogKiBAZXhhbXBsZQogKiBsaXN0LnJlZnJlc2goKTsKICovCkRhdGFMaXN0LnByb3RvdHlwZS5yZWZyZXNoID0gZnVuY3Rpb24gKCBjcmVhdGUgKSB7Cgl2YXIgc2VsZiAgICAgPSB0aGlzLAoJICAgIGVsICAgICAgID0gdGhpcy5lbGVtZW50LAoJICAgIHRlbXBsYXRlID0gKCB0eXBlb2YgdGhpcy50ZW1wbGF0ZSA9PSAib2JqZWN0IiApLAoJICAgIGZpbHRlciAgID0gdGhpcy5maWx0ZXIgIT09IG51bGwsCgkgICAgaXRlbXMgICAgPSBbXSwKCSAgICBjYWxsYmFjayA9ICggdHlwZW9mIHRoaXMuY2FsbGJhY2sgPT0gImZ1bmN0aW9uIiApLAoJICAgIHJlZyAgICAgID0gbmV3IFJlZ0V4cCgpLAoJICAgIHJlZ2lzdHJ5ID0gW10sIC8vIGtlZXBzIHRyYWNrIG9mIHJlY29yZHMgaW4gdGhlIGxpc3QgKCBmb3IgZmlsdGVyaW5nICkKCSAgICByYW5nZSAgICA9IFtdLAoJICAgIGZuLCBjZWlsaW5nLCBuZXh0OwoKCWNyZWF0ZSA9IGNyZWF0ZSA9PT0gdHJ1ZTsKCgl0aGlzLmRpc3BhdGNoKCAiYmVmb3JlUmVmcmVzaCIsIGVsICk7CgoJLy8gRnVuY3Rpb24gdG8gY3JlYXRlIHRlbXBsYXRlcyBmb3IgdGhlIGh0bWwgcmVwCglpZiAoICF0ZW1wbGF0ZSApIHsKCQlmbiA9IGZ1bmN0aW9uICggaSApIHsKCQkJdmFyIGh0bWwgID0gc2VsZi50ZW1wbGF0ZSwKCQkJICAgIGl0ZW1zID0gYXJyYXkudW5pcXVlKCBodG1sLm1hdGNoKCAvXHtce1tcd1wuXC1cW1xdXStcfVx9L2cgKSApOwoKCQkJLy8gUmVwbGFjaW5nIHJlY29yZCBrZXkKCQkJaHRtbCA9IGh0bWwucmVwbGFjZSggInt7IiArIHNlbGYuc3RvcmUua2V5ICsgIn19IiwgaS5rZXkgKTsKCQkJCgkJCS8vIFJlcGxhY2luZyBkb3Qgbm90YXRpb24gcHJvcGVydGllcwoJCQlhcnJheS5lYWNoKCBpdGVtcywgZnVuY3Rpb24gKCBhdHRyICkgewoJCQkJdmFyIGtleSAgID0gYXR0ci5yZXBsYWNlKCAvXHtce3xcfVx9L2csICIiICksCgkJCQkgICAgdmFsdWUgPSB1dGlsaXR5LndhbGsoIGkuZGF0YSwga2V5ICk7CgoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXZhbHVlID0gIiI7CgkJCQl9CgoJCQkJcmVnLmNvbXBpbGUoIHN0cmluZy5lc2NhcGUoIGF0dHIgKSwgImciICk7CgkJCQlodG1sID0gaHRtbC5yZXBsYWNlKCByZWcsIHZhbHVlICk7CgkJCX0gKTsKCgkJCS8vIEZpbGxpbmcgaW4gcGxhY2Vob2xkZXIgdmFsdWUKCQkJaHRtbCA9IGh0bWwucmVwbGFjZSggL1x7XHsuKlx9XH0vZywgc2VsZi5wbGFjZWhvbGRlciApOwoKCQkJcmV0dXJuICI8bGkgZGF0YS1rZXk9XCIiICsgaS5rZXkgKyAiXCI+IiArIGh0bWwgKyAiPC9saT4iOwoJCX07Cgl9CgllbHNlIHsKCQlmbiA9IGZ1bmN0aW9uICggaSApIHsKCQkJdmFyIG9iaiAgID0ganNvbi5lbmNvZGUoIHNlbGYudGVtcGxhdGUgKSwKCQkJICAgIGl0ZW1zID0gYXJyYXkudW5pcXVlKCBvYmoubWF0Y2goIC9ce1x7W1x3XC5cLVxbXF1dK1x9XH0vZyApICk7CgoJCQkvLyBSZXBsYWNpbmcgcmVjb3JkIGtleQoJCQlvYmogPSBvYmoucmVwbGFjZSggInt7IiArIHNlbGYuc3RvcmUua2V5ICsgIn19IiwgaS5rZXkgKTsKCQkJCgkJCS8vIFJlcGxhY2luZyBkb3Qgbm90YXRpb24gcHJvcGVydGllcwoJCQlhcnJheS5lYWNoKCBpdGVtcywgZnVuY3Rpb24gKCBhdHRyICkgewoJCQkJdmFyIGtleSAgID0gYXR0ci5yZXBsYWNlKCAvXHtce3xcfVx9L2csICIiICksCgkJCQkgICAgdmFsdWUgPSB1dGlsaXR5LndhbGsoIGkuZGF0YSwga2V5ICkgfHwgIiI7CgoJCQkJcmVnLmNvbXBpbGUoIHN0cmluZy5lc2NhcGUoIGF0dHIgKSwgImciICk7CgoJCQkJLy8gU3RyaXBwaW5nIGZpcnN0IGFuZCBsYXN0ICIgdG8gY29uY2F0IHRvIHZhbGlkIEpTT04KCQkJCW9iaiA9IG9iai5yZXBsYWNlKCByZWcsIGpzb24uZW5jb2RlKCB2YWx1ZSApLnJlcGxhY2UoIC8oXiIpfCgiJCkvZywgIiIgKSApOwoJCQl9ICk7CgoJCQkvLyBGaWxsaW5nIGluIHBsYWNlaG9sZGVyIHZhbHVlCgkJCW9iaiA9IGpzb24uZGVjb2RlKCBvYmoucmVwbGFjZSggL1x7XHsuKlx9XH0vZywgc2VsZi5wbGFjZWhvbGRlciApICk7CgoJCQlyZXR1cm4ge2xpOiBvYmp9OwoJCX07Cgl9CgoJLy8gTmV4dCBwaGFzZQoJbmV4dCA9IGZ1bmN0aW9uICggYXJncyApIHsKCQkvLyBDcmVhdGluZyB2aWV3IG9mIERhdGFTdG9yZQoJCXNlbGYucmVjb3JkcyAgPSBhcmdzOwoJCXNlbGYudG90YWwgICAgPSBzZWxmLnJlY29yZHMubGVuZ3RoOwoJCXNlbGYuZmlsdGVyZWQgPSBbXTsKCgkJLy8gUmVzZXR0aW5nICd2aWV3JyBzcGVjaWZpYyBhcnJheXMKCQlzZWxmLmN1cnJlbnQgID0gW107CgoJCS8vIEZpbHRlcmluZyByZWNvcmRzIChpZiBhcHBsaWNhYmxlKQoJCWlmICggZmlsdGVyICkgewoJCQlhcnJheS5lYWNoKCBzZWxmLnJlY29yZHMsIGZ1bmN0aW9uICggaSApIHsKCQkJCXV0aWxpdHkuaXRlcmF0ZSggc2VsZi5maWx0ZXIsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCQl2YXIgcmVnLCBrZXk7CgoJCQkJCWlmICggYXJyYXkuY29udGFpbnMoIHJlZ2lzdHJ5LCBpLmtleSApICkgewoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJCQoJCQkJCXYgICA9IHN0cmluZy5leHBsb2RlKCB2ICk7CgkJCQkJcmVnID0gbmV3IFJlZ0V4cCgpLAoJCQkJCWtleSA9ICggayA9PT0gc2VsZi5zdG9yZS5rZXkgKTsKCgkJCQkJYXJyYXkuZWFjaCggdiwgZnVuY3Rpb24gKCBxdWVyeSApIHsKCQkJCQkJdmFyIHZhbHVlID0gIWtleSA/IHV0aWxpdHkud2FsayggaS5kYXRhLCBrICkgOiAiIjsKCgkJCQkJCXV0aWxpdHkuY29tcGlsZSggcmVnLCBxdWVyeSwgImkiICk7CgoJCQkJCQlpZiAoICgga2V5ICYmIHJlZy50ZXN0KCBpLmtleSApICkgfHwgcmVnLnRlc3QoIHZhbHVlICkgKSB7CgkJCQkJCQlyZWdpc3RyeS5wdXNoKCBpLmtleSApOwoJCQkJCQkJc2VsZi5maWx0ZXJlZC5wdXNoKCBpICk7CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSApOwoJCQkJfSApOwoJCQl9ICk7CgkJfQoKCQkvLyBQYWdpbmF0aW9uCgkJaWYgKCBzZWxmLnBhZ2VTaXplICE9PSBudWxsICYmICFpc05hTiggc2VsZi5wYWdlSW5kZXggKSAmJiAhaXNOYU4oIHNlbGYucGFnZVNpemUgKSApIHsKCQkJY2VpbGluZyA9IGxpc3QucGFnZXMuY2FsbCggc2VsZiApOwoKCQkJLy8gUGFzc2VkIHRoZSBlbmQsIHNvIHB1dHRpbmcgeW91IG9uIHRoZSBlbmQKCQkJaWYgKCBjZWlsaW5nID4gMCAmJiBzZWxmLnBhZ2VJbmRleCA+IGNlaWxpbmcgKSB7CgkJCQlyZXR1cm4gc2VsZi5wYWdlKCBjZWlsaW5nICk7CgkJCX0KCgkJCS8vIFBhZ2luYXRpbmcgdGhlIGl0ZW1zCgkJCWVsc2UgaWYgKCBzZWxmLnRvdGFsID4gMCApIHsKCQkJCXJhbmdlICAgICAgICA9IGxpc3QucmFuZ2UuY2FsbCggc2VsZiApOwoJCQkJc2VsZi5jdXJyZW50ID0gYXJyYXkubGltaXQoICFmaWx0ZXIgPyBzZWxmLnJlY29yZHMgOiBzZWxmLmZpbHRlcmVkLCByYW5nZVswXSwgcmFuZ2VbMV0gKTsKCQkJfQoJCX0KCQllbHNlIHsKCQkJc2VsZi5jdXJyZW50ID0gIWZpbHRlciA/IHNlbGYucmVjb3JkcyA6IHNlbGYuZmlsdGVyZWQ7CgkJfQoKCQkvLyBQcm9jZXNzaW5nIHJlY29yZHMgJiBnZW5lcmF0aW5nIHRlbXBsYXRlcwoJCWFycmF5LmVhY2goIHNlbGYuY3VycmVudCwgZnVuY3Rpb24gKCBpICkgewoJCQl2YXIgaHRtbCA9IGZuKCBpICksCgkJCSAgICBoYXNoID0gYnRvYSggaHRtbCApOwoKCQkJaXRlbXMucHVzaCgge2tleTogaS5rZXksIHRlbXBsYXRlOiBodG1sLCBoYXNoOiBoYXNofSApOwoJCX0gKTsKCgkJLy8gVXBkYXRpbmcgZWxlbWVudAoJCXV0aWxpdHkucmVuZGVyKCBmdW5jdGlvbiAoKSB7CgkJCXZhciBkZXN0cm95ICAgPSBbXSwKCQkJICAgIGNhbGxiYWNrcyA9IFtdLAoJCQkgICAgaSwgbnRoOwoKCQkJaWYgKCBpdGVtcy5sZW5ndGggPT09IDAgKSB7CgkJCQllbGVtZW50Lmh0bWwoIGVsLCAiPGxpIGNsYXNzPVwiZW1wdHlcIj4iICsgc2VsZi5lbXB0eU1zZyArICI8L2xpPiIgKTsKCQkJfQoJCQllbHNlIHsKCQkJCWlmICggc2VsZi5pdGVtcy5sZW5ndGggPT09IDAgKSB7CgkJCQkJZWxlbWVudC5odG1sKCBlbCwgaXRlbXMubWFwKCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJCXJldHVybiBpLnRlbXBsYXRlOwoJCQkJCX0gKS5qb2luKCAiIiApICk7CgoJCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJCWFycmF5LmVhY2goIGFycmF5LmNhc3QoIGVsLmNoaWxkTm9kZXMgKSwgZnVuY3Rpb24gKCBpICkgewoJCQkJCQkJc2VsZi5jYWxsYmFjayggaSApOwoJCQkJCQl9ICk7CgkJCQkJfQoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJYXJyYXkuZWFjaCggaXRlbXMsIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCQkJCQlpZiAoIHNlbGYuaXRlbXNbaWR4XSAhPT0gdW5kZWZpbmVkICYmIHNlbGYuaXRlbXNbaWR4XS5oYXNoICE9PSBpLmhhc2ggKSB7CgkJCQkJCQllbGVtZW50LmRhdGEoIGVsZW1lbnQuaHRtbCggZWwuY2hpbGROb2Rlc1tpZHhdLCBpLnRlbXBsYXRlLnJlcGxhY2UoIC88bGkgZGF0YS1rZXk9XCJcZCtcIj58PFwvbGk+L2csICIiICkgKSwgImtleSIsIGkua2V5ICk7CgkJCQkJCQljYWxsYmFja3MucHVzaCggaWR4ICk7CgkJCQkJCX0KCQkJCQkJZWxzZSBpZiAoIHNlbGYuaXRlbXNbaWR4XSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCQkJZWxlbWVudC5jcmVhdGUoIGkudGVtcGxhdGUsIG51bGwsIGVsICk7CgkJCQkJCQljYWxsYmFja3MucHVzaCggaWR4ICk7CgkJCQkJCX0KCQkJCQl9ICk7CgoJCQkJCWlmICggaXRlbXMubGVuZ3RoIDwgc2VsZi5pdGVtcy5sZW5ndGggKSB7CgkJCQkJCWkgICA9IGl0ZW1zLmxlbmd0aCAtIDE7CgkJCQkJCW50aCA9IHNlbGYuaXRlbXMubGVuZ3RoOwoKCQkJCQkJd2hpbGUgKCArK2kgPCBudGggKSB7CgkJCQkJCQlkZXN0cm95LnB1c2goIGkgKTsKCQkJCQkJfQoKCQkJCQkJYXJyYXkuZWFjaCggZGVzdHJveS5yZXZlcnNlKCksIGZ1bmN0aW9uICggaSApIHsKCQkJCQkJCWVsZW1lbnQuZGVzdHJveSggZWwuY2hpbGROb2Rlc1sgaSBdICk7CgkJCQkJCX0gKTsKCQkJCQl9CgoJCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJCWFycmF5LmVhY2goIGNhbGxiYWNrcywgZnVuY3Rpb24gKCBpICkgewoJCQkJCQkJc2VsZi5jYWxsYmFjayggZWwuY2hpbGROb2Rlc1tpXSApOwoJCQkJCQl9ICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBVcGRhdGluZyByZWZlcmVuY2UgZm9yIG5leHQgY2hhbmdlCgkJCXNlbGYuaXRlbXMgPSBpdGVtczsKCgkJCS8vIFJlbmRlcmluZyBwYWdpbmF0aW9uIGVsZW1lbnRzCgkJCWlmICggc2VsZi5wYWdlU2l6ZSAhPT0gbnVsbCAmJiByZWdleC50b3BfYm90dG9tLnRlc3QoIHNlbGYucGFnaW5hdGlvbiApICYmICFpc05hTiggc2VsZi5wYWdlSW5kZXggKSAmJiAhaXNOYU4oIHNlbGYucGFnZVNpemUgKSApIHsKCQkJCXNlbGYucGFnZXMoKTsKCQkJfQoJCQllbHNlIHsKCQkJCWFycmF5LmVhY2goIHV0aWxpdHkuJCggIiMiICsgZWwuaWQgKyAiLXBhZ2VzLXRvcCwgIyIgKyBlbC5pZCArICItcGFnZXMtYm90dG9tIiApLCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJZWxlbWVudC5kZXN0cm95KCBpICk7CgkJCQl9ICk7CgkJCX0KCgkJCXNlbGYuZGlzcGF0Y2goICJhZnRlclJlZnJlc2giLCBlbCApOwoJCX0gKTsKCX07CgoJLy8gQ29uc3VtaW5nIHJlY29yZHMgYmFzZWQgb24gc29ydAoJaWYgKCB0aGlzLndoZXJlID09PSBudWxsICkgewoJCXN0cmluZy5pc0VtcHR5KCB0aGlzLm9yZGVyICkgPyBuZXh0KCB0aGlzLnN0b3JlLmdldCgpICkgOiB0aGlzLnN0b3JlLnNvcnQoIHRoaXMub3JkZXIsIGNyZWF0ZSApLnRoZW4oIG5leHQsIGZ1bmN0aW9uICggZSApIHsKCQkJdXRpbGl0eS5lcnJvciggZSApOwoJCQlzZWxmLmRpc3BhdGNoKCAiZXJyb3IiLCBlICk7CgkJfSApOwoJfQoJZWxzZSBpZiAoIHN0cmluZy5pc0VtcHR5KCB0aGlzLm9yZGVyICkgKSB7CgkJdGhpcy5zdG9yZS5zZWxlY3QoIHRoaXMud2hlcmUgKS50aGVuKCBuZXh0LCBmdW5jdGlvbiAoIGUgKSB7CgkJCXV0aWxpdHkuZXJyb3IoIGUgKTsKCQkJc2VsZi5kaXNwYXRjaCggImVycm9yIiwgZSApOwoJCX0gKTsKCX0KCWVsc2UgewoJCXRoaXMuc3RvcmUuc29ydCggdGhpcy5vcmRlciwgY3JlYXRlLCB0aGlzLndoZXJlICkudGhlbiggbmV4dCwgZnVuY3Rpb24gKCBlICkgewoJCQl1dGlsaXR5LmVycm9yKCBlICk7CgkJCXNlbGYuZGlzcGF0Y2goICJlcnJvciIsIGUgKTsKCQl9ICk7Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogUmVtb3ZlcyBhbiBpdGVtIGZyb20gdGhlIERhdGFMaXN0CiAqCiAqIEBtZXRob2QgcmVtb3ZlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3QKICogQHBhcmFtIHtNaXhlZH0gcmVjb3JkIFJlY29yZCwga2V5IG9yIGluZGV4CiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhTGlzdH0KICogQGV4YW1wbGUKICogLy8gQWRkaW5nIGEgY2xpY2sgaGFuZGxlciB0byAndHJhc2gnIEVsZW1lbnRzCiAqIGtlaWdhaS51dGlsLmFycmF5LmNhc3QoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoICIubGlzdCAudHJhc2giICkgKS5mb3JFYWNoKCBmdW5jdGlvbiAoIGkgKSB7CiAqICAgaS5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiAoIGV2ICkgewogKiAgICAgdmFyIGtleSA9IGtlaWdhaS51dGlsLmVsZW1lbnQuZGF0YSgga2VpZ2FpLnV0aWwudGFyZ2V0KCBldiApLnBhcmVudE5vZGUsICJrZXkiICk7CiAqCiAqICAgICBsaXN0LnJlbW92ZSgga2V5ICk7CiAqICAgfSwgZmFsc2UgKTsKICogfSApOwogKi8KRGF0YUxpc3QucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uICggcmVjb3JkICkgewoJdmFyIHNlbGYgPSB0aGlzOwoKCXRoaXMuc3RvcmUuZGVsKCByZWNvcmQgKS50aGVuKCBudWxsLCBmdW5jdGlvbiAoIGUgKSB7CgkJdXRpbGl0eS5lcnJvciggZSApOwoJCXNlbGYuZGlzcGF0Y2goICJlcnJvciIsIGUgKTsKCX0gKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBTb3J0cyBkYXRhIGxpc3QgJiByZWZyZXNoZXMgZWxlbWVudAogKgogKiBAbWV0aG9kIHNvcnQKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhTGlzdAogKiBAcGFyYW0gIHtTdHJpbmd9IG9yZGVyIFNRTCAiT1JERVIgQlkiIGNsYXVzZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YUxpc3R9CiAqIEBleGFtcGxlCiAqIGxpc3Quc29ydCggImFnZSwgbmFtZSIgKTsKICovCkRhdGFMaXN0LnByb3RvdHlwZS5zb3J0ID0gZnVuY3Rpb24gKCBvcmRlciApIHsKCXRoaXMub3JkZXIgPSBvcmRlcjsKCglyZXR1cm4gdGhpcy5yZWZyZXNoKCk7Cn07CgovKioKICogVGVhcnMgZG93biByZWZlcmVuY2VzIHRvIHRoZSBEYXRhTGlzdAogKgogKiBAbWV0aG9kIHRlYXJkb3duCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUxpc3QKICogQHBhcmFtICB7Qm9vbGVhbn0gZGVzdHJveSBbT3B0aW9uYWxdIGB0cnVlYCB3aWxsIHJlbW92ZSB0aGUgRGF0YUxpc3QgZnJvbSB0aGUgRE9NCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhTGlzdH0KICogQGV4YW1wbGUKICogbGlzdC50ZWFyZG93bigpOwogKi8KRGF0YUxpc3QucHJvdG90eXBlLnRlYXJkb3duID0gZnVuY3Rpb24gKCBkZXN0cm95ICkgewoJZGVzdHJveSAgPSAoIGRlc3Ryb3kgPT09IHRydWUgKTsKCXZhciBzZWxmID0gdGhpcywKCSAgICBpZCAgID0gdGhpcy5lbGVtZW50LmlkOwoKCWFycmF5LmVhY2goIHRoaXMuc3RvcmUubGlzdHMsIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCWlmICggaS5pZCA9PT0gc2VsZi5pZCApIHsKCQkJYXJyYXkucmVtb3ZlKCB0aGlzLCBpZHggKTsKCgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9ICk7CgoJZGVsZXRlIHRoaXMub2JzZXJ2ZXIuaG9va3NbaWRdOwoKCWlmICggdGhpcy5saXN0RmlsdGVyICkgewoJCXRoaXMubGlzdEZpbHRlci50ZWFyZG93bigpOwoJfQoKCWlmICggZGVzdHJveSApIHsKCQllbGVtZW50LmRlc3Ryb3koIHRoaXMuZWxlbWVudCApOwoKCQlhcnJheS5lYWNoKCB1dGlsaXR5LiQoICIjIiArIGlkICsgIi1maWx0ZXIsICMiICsgaWQgKyAiLXBhZ2VzLXRvcCwgIyIgKyBpZCArICItcGFnZXMtYm90dG9tIiksIGZ1bmN0aW9uICggaSApIHsKCQkJZWxlbWVudC5kZXN0cm95KCBpICk7CgkJfSApOwoKCQl0aGlzLmVsZW1lbnQgPSBudWxsOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIFVwZGF0ZXMgYW4gaXRlbSBpbiB0aGUgRGF0YUxpc3QKICoKICogQG1ldGhvZCB1cGRhdGUKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhTGlzdAogKiBAcGFyYW0ge01peGVkfSAga2V5ICBLZXkgb3IgaW5kZXgKICogQHBhcmFtIHtPYmplY3R9IGRhdGEgTmV3IHByb3BlcnR5IHZhbHVlcwogKiBAcmV0dXJuIHtPYmplY3R9ICAgICB7QGxpbmsga2VpZ2FpLkRhdGFMaXN0fQogKiBAZXhhbXBsZQogKiBsaXN0LnVwZGF0ZSggImtleSIsIHtuYW1lOiAiSmltIFNtaXRoIn0gKTsKICovCkRhdGFMaXN0LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoIGtleSwgZGF0YSApIHsKCXZhciBzZWxmID0gdGhpczsKCgl0aGlzLnN0b3JlLnVwZGF0ZSgga2V5LCBkYXRhICkudGhlbiggbnVsbCwgZnVuY3Rpb24gKCBlICkgewoJCXV0aWxpdHkuZXJyb3IoIGUgKTsKCQlzZWxmLmRpc3BhdGNoKCAiZXJyb3IiLCBlICk7Cgl9ICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogQG5hbWVzcGFjZSBkZWZlcnJlZAogKi8KdmFyIGRlZmVycmVkID0gewoJLyoqCgkgKiBEZWZlcnJlZCBmYWN0b3J5CgkgKgoJICogQG1ldGhvZCBmYWN0b3J5CgkgKiBAbWVtYmVyT2YgZGVmZXJyZWQKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EZWZlcnJlZH0KCSAqIEBleGFtcGxlCgkgKiB2YXIgZGVmZXJyZWQgPSBrZWlnYWkudXRpbC5kZWZlcigpOwoJICoKCSAqIGRlZmVycmVkLnRoZW4oIGZ1bmN0aW9uICggLi4uICkgeyAuLi4gfSwgZnVuY3Rpb24gKCBlcnIgKSB7IC4uLiB9ICkKCSAqIGRlZmVycmVkLmFsd2F5cyggZnVuY3Rpb24gKCAuLi4gKSB7IC4uLiB9ICk7CgkgKgoJICogLi4uCgkgKgoJICogZGVmZXJyZWQucmVzb2x2ZSggdHJ1ZSApOwoJICovCgkgZmFjdG9yeSA6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gbmV3IERlZmVycmVkKCk7Cgl9Cn07CgovKioKICogQ3JlYXRlcyBhIG5ldyBEZWZlcnJlZAogKgogKiBAY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaQogKi8KZnVuY3Rpb24gRGVmZXJyZWQgKCkgewoJdmFyIHNlbGYgICAgICA9IHRoaXM7CgoJdGhpcy5wcm9taXNlICA9IHByb21pc2UuZmFjdG9yeSgpOwoJdGhpcy5vbkRvbmUgICA9IFtdOwoJdGhpcy5vbkFsd2F5cyA9IFtdOwoJdGhpcy5vbkZhaWwgICA9IFtdOwoKCS8vIFNldHRpbmcgaGFuZGxlcnMgdG8gZXhlY3V0ZSBBcnJheXMgb2YgRnVuY3Rpb25zCgl0aGlzLnByb21pc2UudGhlbiggZnVuY3Rpb24gKCBhcmcgKSB7CgkJYXJyYXkuZWFjaCggc2VsZi5vbkRvbmUsIGZ1bmN0aW9uICggaSApIHsKCQkJaSggYXJnICk7CgkJfSApOwoKCQlhcnJheS5lYWNoKCBzZWxmLm9uQWx3YXlzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCWkoIGFyZyApOwoJCX0gKTsKCgkJc2VsZi5vbkFsd2F5cyA9IFtdOwoJCXNlbGYub25Eb25lICAgPSBbXTsKCQlzZWxmLm9uRmFpbCAgID0gW107Cgl9LCBmdW5jdGlvbiAoIGFyZyApIHsKCQlhcnJheS5lYWNoKCBzZWxmLm9uRmFpbCwgZnVuY3Rpb24gKCBpICkgewoJCQlpKCBhcmcgKTsKCQl9ICk7CgoJCWFycmF5LmVhY2goIHNlbGYub25BbHdheXMsIGZ1bmN0aW9uICggaSApIHsKCQkJaSggYXJnICk7CgkJfSApOwoKCQlzZWxmLm9uQWx3YXlzID0gW107CgkJc2VsZi5vbkRvbmUgICA9IFtdOwoJCXNlbGYub25GYWlsICAgPSBbXTsKCX0gKTsKfQoKLyoqCiAqIFNldHRpbmcgY29uc3RydWN0b3IgbG9vcAogKgogKiBAbWV0aG9kIGNvbnN0cnVjdG9yCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGVmZXJyZWQKICogQHR5cGUge0Z1bmN0aW9ufQogKiBAcHJpdmF0ZQogKi8KRGVmZXJyZWQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gRGVmZXJyZWQ7CgovKioKICogUmVnaXN0ZXJzIGEgZnVuY3Rpb24gdG8gZXhlY3V0ZSBhZnRlciBQcm9taXNlIGlzIHJlY29uY2lsZWQKICoKICogQG1ldGhvZCBhbHdheXMKICogQG1lbWJlck9mIGtlaWdhaS5EZWZlcnJlZAogKiBAcGFyYW0gIHtGdW5jdGlvbn0gYXJnIEZ1bmN0aW9uIHRvIGV4ZWN1dGUKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZXhhbXBsZQogKiB2YXIgZGVmZXJyZWQgPSBrZWlnYWkudXRpbC5kZWZlcigpOwogKgogKiBkZWZlcnJlZC5hbHdheXMoIGZ1bmN0aW9uICgpIHsKICogICAgIC4uLgogKiB9ICkudGhlbiggZnVuY3Rpb24gKCkgewogKiAgICAgLi4uCiAqIH0gKTsKICoKICogLi4uCiAqCiAqIGRlZmVycmVkLnJlc29sdmUoIHRydWUgKTsKICovCkRlZmVycmVkLnByb3RvdHlwZS5hbHdheXMgPSBmdW5jdGlvbiAoIGFyZyApIHsKCXRoaXMub25BbHdheXMucHVzaCggYXJnICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogUmVnaXN0ZXJzIGEgZnVuY3Rpb24gdG8gZXhlY3V0ZSBhZnRlciBQcm9taXNlIGlzIHJlc29sdmVkCiAqCiAqIEBtZXRob2QgZG9uZQogKiBAbWVtYmVyT2Yga2VpZ2FpLkRlZmVycmVkCiAqIEBwYXJhbSAge0Z1bmN0aW9ufSBhcmcgRnVuY3Rpb24gdG8gZXhlY3V0ZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGVmZXJyZWR9CiAqIEBleGFtcGxlCiAqIHZhciBkZWZlcnJlZCA9IGtlaWdhaS51dGlsLmRlZmVyKCk7CiAqCiAqIGRlZmVycmVkLmRvbmUoIGZ1bmN0aW9uICggLi4uICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpEZWZlcnJlZC5wcm90b3R5cGUuZG9uZSA9IGZ1bmN0aW9uICggYXJnICkgewoJdGhpcy5vbkRvbmUucHVzaCggYXJnICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogUmVnaXN0ZXJzIGEgZnVuY3Rpb24gdG8gZXhlY3V0ZSBhZnRlciBQcm9taXNlIGlzIHJlamVjdGVkCiAqCiAqIEBtZXRob2QgZmFpbAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRlZmVycmVkCiAqIEBwYXJhbSAge0Z1bmN0aW9ufSBhcmcgRnVuY3Rpb24gdG8gZXhlY3V0ZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGVmZXJyZWR9CiAqIEBleGFtcGxlCiAqIHZhciBkZWZlcnJlZCA9IGtlaWdhaS51dGlsLmRlZmVyKCk7CiAqCiAqIGRlZmVycmVkLmZhaWwoIGZ1bmN0aW9uICggLi4uICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpEZWZlcnJlZC5wcm90b3R5cGUuZmFpbCA9IGZ1bmN0aW9uICggYXJnICkgewoJdGhpcy5vbkZhaWwucHVzaCggYXJnICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogUmVqZWN0cyB0aGUgUHJvbWlzZQogKgogKiBAbWV0aG9kIHJlamVjdAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRlZmVycmVkCiAqIEBwYXJhbSAge01peGVkfSBhcmcgUmVqZWN0aW9uIG91dGNvbWUKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZXhhbXBsZQogKiB2YXIgZGVmZXJyZWQgPSBrZWlnYWkudXRpbC5kZWZlcigpOwogKgogKiBkZWZlcnJlZC5yZWplY3QoIG5ldyBFcnJvciggIlNvbWV0aGluZyB3ZW50IHdyb25nIiApICk7CiAqLwpEZWZlcnJlZC5wcm90b3R5cGUucmVqZWN0ID0gZnVuY3Rpb24gKCBhcmcgKSB7Cgl0aGlzLnByb21pc2UucmVqZWN0LmNhbGwoIHRoaXMucHJvbWlzZSwgYXJnICk7CgoJcmV0dXJuIHRoaXM7Cn07CgovKioKICogUmVzb2x2ZXMgdGhlIFByb21pc2UKICoKICogQG1ldGhvZCByZXNvbHZlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGVmZXJyZWQKICogQHBhcmFtICB7TWl4ZWR9IGFyZyBSZXNvbHV0aW9uIG91dGNvbWUKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZXhhbXBsZQogKiB2YXIgZGVmZXJyZWQgPSBrZWlnYWkudXRpbC5kZWZlcigpOwogKgogKiBkZWZlcnJlZC5yZXNvbHZlKCB0cnVlICk7CiAqLwpEZWZlcnJlZC5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uICggYXJnICkgewoJdGhpcy5wcm9taXNlLnJlc29sdmUuY2FsbCggdGhpcy5wcm9taXNlLCBhcmcgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBSZWdpc3RlcnMgaGFuZGxlcihzKSBmb3IgdGhlIFByb21pc2UKICoKICogQG1ldGhvZCB0aGVuCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGVmZXJyZWQKICogQHBhcmFtICB7RnVuY3Rpb259IHN1Y2Nlc3MgRXhlY3V0ZWQgd2hlbi9pZiBwcm9taXNlIGlzIHJlc29sdmVkCiAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmYWlsdXJlIFtPcHRpb25hbF0gRXhlY3V0ZWQgd2hlbi9pZiBwcm9taXNlIGlzIGJyb2tlbgogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBQcm9taXNlfQogKiBAZXhhbXBsZQogKiB2YXIgZGVmZXJyZWQgPSBrZWlnYWkudXRpbC5kZWZlcigpOwogKgogKiBkZWZlcnJlZC50aGVuKCBmdW5jdGlvbiAoIC4uLiApIHsgLi4uIH0sIGZ1bmN0aW9uICggZXJyICkgeyAuLi4gfSApCiAqICAgICAgICAgLnRoZW4oIGZ1bmN0aW9uICggLi4uICkgeyAuLi4gfSwgZnVuY3Rpb24gKCBlcnIgKSB7IC4uLiB9ICk7CiAqCiAqIC4uLgogKgogKiBkZWZlcnJlZC5yZXNvbHZlKCB0cnVlICk7CiAqLwpEZWZlcnJlZC5wcm90b3R5cGUudGhlbiA9IGZ1bmN0aW9uICggc3VjY2VzcywgZmFpbHVyZSApIHsKCXJldHVybiB0aGlzLnByb21pc2UudGhlbiggc3VjY2VzcywgZmFpbHVyZSApOwp9OwoKLyoqCiAqIEBuYW1lc3BhY2UgZWxlbWVudAogKi8KdmFyIGVsZW1lbnQgPSB7CgkvKioKCSAqIEFwcGVuZHMgYW4gRWxlbWVudCB0byBhbiBFbGVtZW50CgkgKgoJICogQG1lbWJlck9mIGFwcGVuZFRvCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogICBFbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IGNoaWxkIENoaWxkIEVsZW1lbnQKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuYXBwZW5kVG8oIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjdGFyZ2V0IiApLCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSApOwoJICovCglhcHBlbmRUbyA6IGZ1bmN0aW9uICggb2JqLCBjaGlsZCApIHsKCQlvYmouYXBwZW5kQ2hpbGQoIGNoaWxkICk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogR2V0cyBvciBzZXRzIGFuIEVsZW1lbnQgYXR0cmlidXRlCgkgKgoJICogQG1ldGhvZCBhdHRyCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogICBFbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IG5hbWUgIEF0dHJpYnV0ZSBuYW1lCgkgKiBAcGFyYW0gIHtNaXhlZH0gIHZhbHVlIEF0dHJpYnV0ZSB2YWx1ZQoJICogQHJldHVybiB7T2JqZWN0fSAgICAgICBFbGVtZW50CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC5hdHRyKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAic2VsZWN0IiApLCAic2VsZWN0ZWQiLCAib3B0aW9uIDEiICk7CgkgKi8KCWF0dHIgOiBmdW5jdGlvbiAoIG9iaiwga2V5LCB2YWx1ZSApIHsKCQl2YXIgdGFyZ2V0LCByZXN1bHQ7CgoJCWlmICggcmVnZXguc3ZnLnRlc3QoIG9iai5uYW1lc3BhY2VVUkkgKSApIHsKCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmVzdWx0ID0gb2JqLmdldEF0dHJpYnV0ZU5TKCBvYmoubmFtZXNwYWNlVVJJLCBrZXkgKTsKCgkJCQlpZiAoIHJlc3VsdCA9PT0gbnVsbCB8fCBzdHJpbmcuaXNFbXB0eSggcmVzdWx0ICkgKSB7CgkJCQkJcmVzdWx0ID0gdW5kZWZpbmVkOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJcmVzdWx0ID0gdXRpbGl0eS5jb2VyY2UoIHJlc3VsdCApOwoJCQkJfQoJCQl9CgkJCWVsc2UgewoJCQkJb2JqLnNldEF0dHJpYnV0ZU5TKCBvYmoubmFtZXNwYWNlVVJJLCBrZXksIHZhbHVlICk7CgkJCX0KCQl9CgkJZWxzZSB7CgkJCWlmICggdHlwZW9mIHZhbHVlID09ICJzdHJpbmciICkgewoJCQkJdmFsdWUgPSBzdHJpbmcudHJpbSggdmFsdWUgKTsKCQkJfQoKCQkJaWYgKCByZWdleC5jaGVja2VkX2Rpc2FibGVkLnRlc3QoIGtleSApICYmIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gdXRpbGl0eS5jb2VyY2UoIG9ialtrZXldICk7CgkJCX0KCQkJZWxzZSBpZiAoIHJlZ2V4LmNoZWNrZWRfZGlzYWJsZWQudGVzdCgga2V5ICkgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCW9ialtrZXldID0gdmFsdWU7CgkJCX0KCQkJZWxzZSBpZiAoIG9iai5ub2RlTmFtZSA9PT0gIlNFTEVDVCIgJiYga2V5ID09PSAic2VsZWN0ZWQiICYmIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXR1cm4gdXRpbGl0eS5kb20oICIjIiArIG9iai5pZCArICIgb3B0aW9uW3NlbGVjdGVkPVwic2VsZWN0ZWRcIl0iIClbMF0gfHwgdXRpbGl0eS5kb20oICIjIiArIG9iai5pZCArICIgb3B0aW9uIiApWzBdOwoJCQl9CgkJCWVsc2UgaWYgKCBvYmoubm9kZU5hbWUgPT09ICJTRUxFQ1QiICYmIGtleSA9PT0gInNlbGVjdGVkIiAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGFyZ2V0ID0gdXRpbGl0eS5kb20oICIjIiArIG9iai5pZCArICIgb3B0aW9uW3NlbGVjdGVkPVwic2VsZWN0ZWRcIl0iIClbMF07CgoJCQkJaWYgKCB0YXJnZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJCQl0YXJnZXQuc2VsZWN0ZWQgPSBmYWxzZTsKCQkJCQl0YXJnZXQucmVtb3ZlQXR0cmlidXRlKCAic2VsZWN0ZWQiICk7CgkJCQl9CgoJCQkJdGFyZ2V0ID0gdXRpbGl0eS5kb20oICIjIiArIG9iai5pZCArICIgb3B0aW9uW3ZhbHVlPVwiIiArIHZhbHVlICsgIlwiXSIgKVswXTsKCQkJCXRhcmdldC5zZWxlY3RlZCA9IHRydWU7CgkJCQl0YXJnZXQuc2V0QXR0cmlidXRlKCAic2VsZWN0ZWQiLCAic2VsZWN0ZWQiICk7CgkJCX0KCQkJZWxzZSBpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXN1bHQgPSBvYmouZ2V0QXR0cmlidXRlKCBrZXkgKTsKCgkJCQlpZiAoIHJlc3VsdCA9PT0gbnVsbCB8fCBzdHJpbmcuaXNFbXB0eSggcmVzdWx0ICkgKSB7CgkJCQkJcmVzdWx0ID0gdW5kZWZpbmVkOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJcmVzdWx0ID0gdXRpbGl0eS5jb2VyY2UoIHJlc3VsdCApOwoJCQkJfQoKCQkJCXJldHVybiByZXN1bHQ7CgkJCX0KCQkJZWxzZSB7CgkJCQlvYmouc2V0QXR0cmlidXRlKCBrZXksIHZhbHVlICk7CgkJCX0KCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogQ2xlYXJzIGFuIG9iamVjdCdzIGlubmVySFRNTCwgb3IgcmVzZXRzIGl0J3Mgc3RhdGUKCSAqCgkgKiBAbWV0aG9kIGNsZWFyCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuY2xlYXIoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApICk7CgkgKi8KCWNsZWFyIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJaWYgKCB0eXBlb2Ygb2JqLnJlc2V0ID09ICJmdW5jdGlvbiIgKSB7CgkJCW9iai5yZXNldCgpOwoJCX0KCQllbHNlIGlmICggb2JqLnZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW1lbnQudXBkYXRlKCBvYmosIHtpbm5lckhUTUw6ICIiLCB2YWx1ZTogIiJ9ICk7CgkJfQoJCWVsc2UgewoJCQllbGVtZW50LnVwZGF0ZSggb2JqLCB7aW5uZXJIVE1MOiAiIn0gKTsKCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogQ3JlYXRlcyBhbiBFbGVtZW50IGluIGRvY3VtZW50LmJvZHkgb3IgYSB0YXJnZXQgRWxlbWVudC4KCSAqIEFuIGlkIGlzIGdlbmVyYXRlZCBpZiBub3Qgc3BlY2lmaWVkIHdpdGggYXJncy4KCSAqCgkgKiBAbWV0aG9kIGNyZWF0ZQoJICogQG1lbWJlck9mIGVsZW1lbnQKCSAqIEBwYXJhbSAge1N0cmluZ30gdHlwZSBUeXBlIG9mIEVsZW1lbnQgdG8gY3JlYXRlLCBvciBIVE1MIFN0cmluZwoJICogQHBhcmFtICB7T2JqZWN0fSBhcmdzIFtPcHRpb25hbF0gUHJvcGVydGllcyB0byBzZXQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqICBbT3B0aW9uYWxdIFRhcmdldCBFbGVtZW50CgkgKiBAcGFyYW0gIHtNaXhlZH0gIHBvcyAgW09wdGlvbmFsXSAiZmlyc3QiLCAibGFzdCIgb3IgT2JqZWN0IGRlc2NyaWJpbmcgaG93IHRvIGFkZCB0aGUgbmV3IEVsZW1lbnQsIGUuZy4ge2JlZm9yZTogcmVmZXJlbmNlRWxlbWVudH0sIGRlZmF1bHQgaXMgImxhc3QiCgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgICAgRWxlbWVudCB0aGF0IHdhcyBjcmVhdGVkLCBvciBhbiBBcnJheSBpZiBgdHlwZWAgaXMgYSBTdHJpbmcgb2YgbXVsdGlwbGUgRWxlbWVudHMgKGZyYWcpCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC5jcmVhdGUoICJkaXYiLCB7aW5uZXJIVE1MOiAiSGVsbG8gV29ybGQhIn0sIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApICk7CgkgKiBrZWlnYWkudXRpbC5lbGVtZW50LmNyZWF0ZSggIiZsdDtkaXYmZ3Q7SGVsbG8gV29ybGQhJmx0Oy9kaXYmZ3Q7IiApOwoJICovCgljcmVhdGUgOiBmdW5jdGlvbiAoIHR5cGUsIGFyZ3MsIG9iaiwgcG9zICkgewoJCXZhciBzdmcgID0gZmFsc2UsCgkJICAgIGZyYWcgPSBmYWxzZSwKCQkgICAgZnJhZ21lbnQsIHVpZCwgcmVzdWx0OwoKCQkvLyBSZW1vdmluZyBwb3RlbnRpYWwgSFRNTCB0ZW1wbGF0ZSBmb3JtYXR0aW5nCgkJdHlwZSA9IHR5cGUucmVwbGFjZSggL1x0fFxufFxyL2csICIiICk7CgoJCWlmICggb2JqICkgewoJCQlzdmcgPSBvYmoubmFtZXNwYWNlVVJJICYmIHJlZ2V4LnN2Zy50ZXN0KCBvYmoubmFtZXNwYWNlVVJJICk7CgkJfQoJCWVsc2UgewoJCQlvYmogPSBkb2N1bWVudC5ib2R5OwoJCX0KCQkKCQlpZiAoIGFyZ3MgaW5zdGFuY2VvZiBPYmplY3QgJiYgYXJncy5pZCAmJiAhdXRpbGl0eS5kb20oICIjIiArIGFyZ3MuaWQgKSApIHsKCQkJdWlkID0gYXJncy5pZDsKCQkJZGVsZXRlIGFyZ3MuaWQ7CgkJfQoJCWVsc2UgaWYgKCAhc3ZnICkgewoJCQl1aWQgPSB1dGlsaXR5LmdlbklkKCB1bmRlZmluZWQsIHRydWUgKTsKCQl9CgoJCS8vIFN0cmluZyBpbmplY3Rpb24sIGNyZWF0ZSBhIGZyYWcgYW5kIGFwcGx5IGl0CgkJaWYgKCByZWdleC5odG1sLnRlc3QoIHR5cGUgKSApIHsKCQkJZnJhZyAgICAgPSB0cnVlOwoJCQlmcmFnbWVudCA9IGVsZW1lbnQuZnJhZyggdHlwZSApOwoJCQlyZXN1bHQgICA9IGZyYWdtZW50LmNoaWxkTm9kZXMubGVuZ3RoID09PSAxID8gZnJhZ21lbnQuY2hpbGROb2Rlc1swXSA6IGFycmF5LmNhc3QoIGZyYWdtZW50LmNoaWxkTm9kZXMgKTsKCQl9CgkJLy8gT3JpZ2luYWwgc3ludGF4CgkJZWxzZSB7CgkJCWlmICggIXN2ZyAmJiAhcmVnZXguc3ZnLnRlc3QoIHR5cGUgKSApIHsKCQkJCWZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggdHlwZSApOwoJCQl9CgkJCWVsc2UgewoJCQkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIsIHR5cGUgKTsKCQkJfQoKCQkJaWYgKCB1aWQgKSB7CgkJCQlmcmFnbWVudC5pZCA9IHVpZDsKCQkJfQoKCQkJaWYgKCBhcmdzIGluc3RhbmNlb2YgT2JqZWN0ICkgewoJCQkJZWxlbWVudC51cGRhdGUoIGZyYWdtZW50LCBhcmdzICk7CgkJCX0KCQl9CgoJCWlmICggIXBvcyB8fCBwb3MgPT09ICJsYXN0IiApIHsKCQkJb2JqLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoJCX0KCQllbHNlIGlmICggcG9zID09PSAiZmlyc3QiICkgewoJCQllbGVtZW50LnByZXBlbmRDaGlsZCggb2JqLCBmcmFnbWVudCApOwoJCX0KCQllbHNlIGlmICggcG9zID09PSAiYWZ0ZXIiICkgewoJCQlwb3MgPSB7YWZ0ZXI6IG9ian07CgkJCW9iaiA9IG9iai5wYXJlbnROb2RlOwoJCQlvYmouaW5zZXJ0QmVmb3JlKCBmcmFnbWVudCwgcG9zLmFmdGVyLm5leHRTaWJsaW5nICk7CgkJfQoJCWVsc2UgaWYgKCBwb3MuYWZ0ZXIgKSB7CgkJCW9iai5pbnNlcnRCZWZvcmUoIGZyYWdtZW50LCBwb3MuYWZ0ZXIubmV4dFNpYmxpbmcgKTsKCQl9CgkJZWxzZSBpZiAoIHBvcyA9PT0gImJlZm9yZSIgKSB7CgkJCXBvcyA9IHtiZWZvcmU6IG9ian07CgkJCW9iaiA9IG9iai5wYXJlbnROb2RlOwoJCQlvYmouaW5zZXJ0QmVmb3JlKCBmcmFnbWVudCwgcG9zLmJlZm9yZSApOwoJCX0KCQllbHNlIGlmICggcG9zLmJlZm9yZSApIHsKCQkJb2JqLmluc2VydEJlZm9yZSggZnJhZ21lbnQsIHBvcy5iZWZvcmUgKTsKCQl9CgkJZWxzZSB7CgkJCW9iai5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTsKCQl9CgoJCXJldHVybiAhZnJhZyA/IGZyYWdtZW50IDogcmVzdWx0OwoJfSwKCgkvKioKCSAqIEdldHMgb3Igc2V0cyBhIENTUyBzdHlsZSBhdHRyaWJ1dGUgb24gYW4gRWxlbWVudAoJICoKCSAqIEBtZXRob2QgY3NzCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogICBFbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGtleSAgIENTUyB0byBwdXQgaW4gYSBzdHlsZSB0YWcKCSAqIEBwYXJhbSAge1N0cmluZ30gdmFsdWUgW09wdGlvbmFsXSBWYWx1ZSB0byBzZXQKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuY3NzKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSwgImZvbnQtd2VpZ2h0IiwgImJvbGQiICk7CgkgKiBrZWlnYWkudXRpbC5lbGVtZW50LmNzcyggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICksICJmb250LXdlaWdodCIgKTsgLy8gImJvbGQiCgkgKi8KCWNzcyA6IGZ1bmN0aW9uICggb2JqLCBrZXksIHZhbHVlICkgewoJCWlmICggIXJlZ2V4LmNhcHMudGVzdCgga2V5ICkgKSB7CgkJCWtleSA9IHN0cmluZy50b0NhbWVsQ2FzZSgga2V5ICk7CgkJfQoKCQlpZiAoIHZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCW9iai5zdHlsZVtrZXldID0gdmFsdWU7CgkJCXJldHVybiBvYmo7CgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gb2JqLnN0eWxlW2tleV07CgkJfQoJfSwKCgkvKioKCSAqIERhdGEgYXR0cmlidXRlIGZhY2FkZSBhY3RpbmcgYXMgYSBnZXR0ZXIgKHdpdGggY29lcmNpb24pICYgc2V0dGVyCgkgKgoJICogQG1ldGhvZCBkYXRhCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogICBFbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGtleSAgIERhdGEga2V5CgkgKiBAcGFyYW0gIHtNaXhlZH0gIHZhbHVlIEJvb2xlYW4sIE51bWJlciBvciBTdHJpbmcgdG8gc2V0CgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgICAgIHVuZGVmaW5lZCwgRWxlbWVudCBvciB2YWx1ZQoJICogQGV4YW1wbGUKCSAqIC8vIFNldHRpbmcKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuZGF0YSggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICksICJpZCIsICJhYmMtMTIzNCIgKTsKCSAqCgkgKiAvLyBHZXR0aW5nCgkgKiBrZWlnYWkudXRpbC5lbGVtZW50LmRhdGEoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCAiaWQiICk7IC8vICJhYmMtMTIzNCIKCSAqCgkgKiAvLyBVbnNldHRpbmcKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuZGF0YSggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICksICJpZCIsIG51bGwgKTsKCSAqCgkgKiAvLyBTZXR0aW5nIGEgYG51bGxgIHZhbHVlIGNhbiBiZSBkb25lIGJ5IHVzaW5nIGEgU3RyaW5nCgkgKiBrZWlnYWkudXRpbC5lbGVtZW50LmRhdGEoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCAiaWQiLCAibnVsbCIgKTsKCSAqLwoJZGF0YSA6IGZ1bmN0aW9uICggb2JqLCBrZXksIHZhbHVlICkgewoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJb2JqLnNldEF0dHJpYnV0ZSggImRhdGEtIiArIGtleSwgcmVnZXguanNvbl93cmFwLnRlc3QoIHZhbHVlICkgPyBqc29uLmVuY29kZSggdmFsdWUgKSA6IHZhbHVlICk7CgoJCQlyZXR1cm4gb2JqOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIHV0aWxpdHkuY29lcmNlKCBvYmouZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsga2V5ICkgKTsKCQl9Cgl9LAoKCS8qKgoJICogRGVzdHJveXMgYW4gRWxlbWVudAoJICoKCSAqIEBtZXRob2QgZGVzdHJveQoJICogQG1lbWJlck9mIGVsZW1lbnQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqIEVsZW1lbnQKCSAqIEByZXR1cm4ge1VuZGVmaW5lZH0gdW5kZWZpbmVkCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC5kZXN0cm95KCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSApOwoJICovCglkZXN0cm95IDogZnVuY3Rpb24gKCBvYmogKSB7CgkJaWYgKCBvYmoucGFyZW50Tm9kZSAhPT0gbnVsbCApIHsKCQkJb2JqLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIG9iaiApOwoJCX0KCgkJcmV0dXJuIHVuZGVmaW5lZDsKCX0sCgoJLyoqCgkgKiBEaXNhYmxlcyBhbiBFbGVtZW50CgkgKgoJICogQG1ldGhvZCBkaXNhYmxlCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuZGlzYWJsZSggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICkgKTsKCSAqLwoJZGlzYWJsZSA6IGZ1bmN0aW9uICggb2JqICkgewoJCWlmICggdHlwZW9mIG9iai5kaXNhYmxlZCA9PSAiYm9vbGVhbiIgJiYgIW9iai5kaXNhYmxlZCApIHsKCQkJb2JqLmRpc2FibGVkID0gdHJ1ZTsKCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogRGlzcGF0Y2hlcyBhIERPTSBFdmVudCBmcm9tIGFuIEVsZW1lbnQKCSAqCgkgKiBgZGF0YWAgd2lsbCBhcHBlYXIgYXMgYEV2ZW50LmRldGFpbGAKCSAqCgkgKiBAbWV0aG9kIGRpc3BhdGNoCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSAgb2JqICAgICAgICBFbGVtZW50IHdoaWNoIGRpc3BhdGNoZXMgdGhlIEV2ZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9ICB0eXBlICAgICAgIFR5cGUgb2YgRXZlbnQgdG8gZGlzcGF0Y2gKCSAqIEBwYXJhbSAge09iamVjdH0gIGRhdGEgICAgICAgW09wdGlvbmFsXSBEYXRhIHRvIGluY2x1ZGUgd2l0aCB0aGUgRXZlbnQKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGJ1YmJsZXMgICAgW09wdGlvbmFsXSBEZXRlcm1pbmVzIGlmIHRoZSBFdmVudCBidWJibGVzLCBkZWZhdWx0cyB0byBgdHJ1ZWAKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGNhbmNlbGFibGUgW09wdGlvbmFsXSBEZXRlcm1pbmVzIGlmIHRoZSBFdmVudCBjYW4gYmUgY2FuY2VsZWQsIGRlZmF1bHRzIHRvIGB0cnVlYAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgICAgICAgICBFbGVtZW50IHdoaWNoIGRpc3BhdGNoZXMgdGhlIEV2ZW50CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC5kaXNwYXRjaCggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICksICJjbGljayIgKTsKCSAqLwoJZGlzcGF0Y2ggOiBmdW5jdGlvbiAoIG9iaiwgdHlwZSwgZGF0YSwgYnViYmxlcywgY2FuY2VsYWJsZSApIHsKCQl2YXIgZXY7CgoJCWlmICggIW9iaiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdHJ5IHsKCQkJZXYgPSBuZXcgQ3VzdG9tRXZlbnQoIHR5cGUgKTsKCQl9CgkJY2F0Y2ggKCBlICkgewoJCQlldiA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCAiQ3VzdG9tRXZlbnQiICk7CgkJfQoKCQlidWJibGVzICAgID0gKCBidWJibGVzICAgICE9PSBmYWxzZSApOwoJCWNhbmNlbGFibGUgPSAoIGNhbmNlbGFibGUgIT09IGZhbHNlICk7CgoJCWV2LmluaXRDdXN0b21FdmVudCggdHlwZSwgYnViYmxlcywgY2FuY2VsYWJsZSwgZGF0YSB8fCB7fSApOwoJCW9iai5kaXNwYXRjaEV2ZW50KCBldiApOwoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIEVuYWJsZXMgYW4gRWxlbWVudAoJICoKCSAqIEBtZXRob2QgZW5hYmxlCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuZW5hYmxlKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSApOwoJICovCgllbmFibGUgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlpZiAoIHR5cGVvZiBvYmouZGlzYWJsZWQgPT0gImJvb2xlYW4iICYmIG9iai5kaXNhYmxlZCApIHsKCQkJb2JqLmRpc2FibGVkID0gZmFsc2U7CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIEZpbmRzIGRlc2NlbmRhbnQgY2hpbGROb2RlcyBvZiBFbGVtZW50IG1hdGNoZWQgYnkgYXJnCgkgKgoJICogQG1ldGhvZCBmaW5kCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudCB0byBzZWFyY2gKCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnIENvbW1hIGRlbGltaXRlZCBzdHJpbmcgb2YgZGVzY2VuZGFudCBzZWxlY3RvcnMKCSAqIEByZXR1cm4ge01peGVkfSAgICAgIEFycmF5IG9mIEVsZW1lbnRzIG9yIHVuZGVmaW5lZAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuZmluZCggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICksICJwIiApOwoJICovCglmaW5kIDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQl2YXIgcmVzdWx0ID0gW107CgoJCXV0aWxpdHkuZ2VuSWQoIG9iaiwgdHJ1ZSApOwoKCQlhcnJheS5lYWNoKCBzdHJpbmcuZXhwbG9kZSggYXJnICksIGZ1bmN0aW9uICggaSApIHsKCQkJcmVzdWx0ID0gcmVzdWx0LmNvbmNhdCggdXRpbGl0eS5kb20oICIjIiArIG9iai5pZCArICIgIiArIGkgKSApOwoJCX0gKTsKCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGEgZG9jdW1lbnQgZnJhZ21lbnQKCSAqCgkgKiBAbWV0aG9kIGZyYWcKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBbT3B0aW9uYWxdIGlubmVySFRNTAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRG9jdW1lbnQgZnJhZ21lbnQKCSAqIEBleGFtcGxlCgkgKiB2YXIgZnJhZyA9IGtlaWdhaS51dGlsLmVsZW1lbnQuZnJhZyggIkhlbGxvIFdvcmxkISIgKTsKCSAqLwoJZnJhZyA6IGZ1bmN0aW9uICggYXJnICkgewoJCXZhciBvYmogPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWlmICggYXJnICkgewoJCQlhcnJheS5lYWNoKCBhcnJheS5jYXN0KCBlbGVtZW50LmNyZWF0ZSggImRpdiIsIHtpbm5lckhUTUw6IGFyZ30sIG9iaiApLmNoaWxkTm9kZXMgKSwgZnVuY3Rpb24gKCBpICkgewoJCQkJb2JqLmFwcGVuZENoaWxkKCBpICk7CgkJCX0gKTsKCgkJCW9iai5yZW1vdmVDaGlsZCggb2JqLmNoaWxkTm9kZXNbMF0gKTsKCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogRGV0ZXJtaW5lcyBpZiBFbGVtZW50IGhhcyBkZXNjZW5kYW50cyBtYXRjaGluZyBhcmcKCSAqCgkgKiBAbWV0aG9kIGhhcwoJICogQG1lbWJlck9mIGVsZW1lbnQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqIEVsZW1lbnQKCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnIFR5cGUgb2YgRWxlbWVudCB0byBmaW5kCgkgKiBAcmV0dXJuIHtCb29sZWFufSAgICBgdHJ1ZWAgaWYgMSBvciBtb3JlIEVsZW1lbnRzIGFyZSBmb3VuZAoJICogQGV4YW1wbGUKCSAqIGlmICgga2VpZ2FpLnV0aWwuZWxlbWVudC5oYXMoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCAicCIgKSApIHsKCSAqICAgLi4uCgkgKiB9CgkgKi8KCWhhcyA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJdmFyIHJlc3VsdCA9IGVsZW1lbnQuZmluZCggb2JqLCBhcmcgKTsKCgkJcmV0dXJuICggIWlzTmFOKCByZXN1bHQubGVuZ3RoICkgJiYgcmVzdWx0Lmxlbmd0aCA+IDAgKTsKCX0sCgoJLyoqCgkgKiBEZXRlcm1pbmVzIGlmIG9iaiBoYXMgYSBzcGVjaWZpYyBDU1MgY2xhc3MKCSAqCgkgKiBAbWV0aG9kIGhhc0NsYXNzCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgQ1NTIGNsYXNzIHRvIHRlc3QgZm9yCgkgKiBAcmV0dXJuIHtCb29sZWFufSAgICBgdHJ1ZWAgaWYgRWxlbWVudCBoYXMgYGFyZ2AKCSAqIEBleGFtcGxlCgkgKiBpZiAoIGtlaWdhaS51dGlsLmVsZW1lbnQuaGFzQ2xhc3MoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCAic29tZUNsYXNzIiApICkgewoJICogICAuLi4KCSAqIH0KCSAqLwoJaGFzQ2xhc3MgOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCXJldHVybiBvYmouY2xhc3NMaXN0LmNvbnRhaW5zKCBhcmcgKTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIGEgQm9vbGVhbiBpbmRpZGNhdGluZyBpZiB0aGUgT2JqZWN0IGlzIGhpZGRlbgoJICoKCSAqIEBtZXRob2QgaGlkZGVuCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHJldHVybiB7Qm9vbGVhbn0gICBgdHJ1ZWAgaWYgaGlkZGVuCgkgKiBAZXhhbXBsZQoJICogaWYgKCBrZWlnYWkudXRpbC5lbGVtZW50LmhpZGRlbiggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICkgKSApIHsKCSAqICAgLi4uCgkgKiB9CgkgKi8KCWhpZGRlbiA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBvYmouc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiIHx8ICggdHlwZW9mIG9iai5oaWRkZW4gPT0gImJvb2xlYW4iICYmIG9iai5oaWRkZW4gKTsKCX0sCgoJLyoqCgkgKiBHZXRzIG9yIHNldHMgYW4gRWxlbWVudHMgaW5uZXJIVE1MCgkgKgoJICogQG1ldGhvZCBodG1sCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgW09wdGlvbmFsXSBpbm5lckhUTUwgdmFsdWUKCSAqIEByZXR1cm4ge09iamVjdH0gICAgIEVsZW1lbnQKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5lbGVtZW50Lmh0bWwoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCAiSGVsbG8gV29ybGQhIiApOwoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC5odG1sKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSApOyAvLyAiSGVsbG8gV29ybGQhIgoJICovCglodG1sIDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQlpZiAoIGFyZyA9PT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gb2JqLmlubmVySFRNTDsKCQl9CgkJZWxzZSB7CgkJCSBvYmouaW5uZXJIVE1MID0gYXJnOwoJCQkgcmV0dXJuIG9iajsKCQl9Cgl9LAoKCS8qKgoJICogRGV0ZXJtaW5lcyBpZiBFbGVtZW50IGlzIGVxdWFsIHRvIGBhcmdgLCBzdXBwb3J0cyBub2RlTmFtZXMgJiBDU1MyKyBzZWxlY3RvcnMKCSAqCgkgKiBAbWV0aG9kIGlzCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogRWxlbWVudAoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgUHJvcGVydHkgdG8gcXVlcnkKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgIGB0cnVlYCBpZiBhIG1hdGNoCgkgKiBAZXhhbXBsZQoJICogaWYgKCBrZWlnYWkudXRpbC5lbGVtZW50LmlzKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSwgImRpdiIgKSApIHsKCSAqICAgLi4uCgkgKiB9CgkgKgoJICogaWYgKCBrZWlnYWkudXRpbC5lbGVtZW50LmlzKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSwgIjpmaXJzdC1jaGlsZCIgKSApIHsKCSAqICAgLi4uCgkgKiB9CgkgKi8KCWlzIDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQlpZiAoIHJlZ2V4LnNlbGVjdG9yX2lzLnRlc3QoIGFyZyApICkgewoJCQlyZXR1cm4gKCBlbGVtZW50LmZpbmQoIG9iai5wYXJlbnROb2RlLCBvYmoubm9kZU5hbWUudG9Mb3dlckNhc2UoKSArIGFyZyApLmZpbHRlciggZnVuY3Rpb24gKCBpICkgewoJCQkJcmV0dXJuIGkuaWQgPT09IG9iai5pZDsKCQkJfSApLmxlbmd0aCA9PT0gMSApOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIG5ldyBSZWdFeHAoIGFyZywgImkiICkudGVzdCggb2JqLm5vZGVOYW1lICk7CgkJfQoJfSwKCgkvKioKCSAqIEFkZHMgb3IgcmVtb3ZlcyBhIENTUyBjbGFzcwoJICoKCSAqIEBtZXRob2Qga2xhc3MKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9ICBvYmogRWxlbWVudAoJICogQHBhcmFtICB7U3RyaW5nfSAgYXJnIENsYXNzIHRvIGFkZCBvciByZW1vdmUgKCBjYW4gYmUgYSB3aWxkY2FyZCApCgkgKiBAcGFyYW0gIHtCb29sZWFufSBhZGQgQm9vbGVhbiB0byBhZGQgb3IgcmVtb3ZlLCBkZWZhdWx0cyB0byB0cnVlCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIC8vIEFkZGluZyBhIGNsYXNzCgkgKiBrZWlnYWkudXRpbC5lbGVtZW50LmtsYXNzKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSwgIm5ld0NsYXNzIiApOwoJICoKCSAqIC8vIFJlbW92aW5nIGEgY2xhc3MKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQua2xhc3MoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCAibmV3Q2xhc3MiLCBmYWxzZSApOwoJICovCglrbGFzcyA6IGZ1bmN0aW9uICggb2JqLCBhcmcsIGFkZCApIHsKCQlhZGQgPSAoIGFkZCAhPT0gZmFsc2UgKTsKCQlhcmcgPSBzdHJpbmcuZXhwbG9kZSggYXJnLCAiICIgKTsKCgkJaWYgKCBhZGQgKSB7CgkJCWFycmF5LmVhY2goIGFyZywgZnVuY3Rpb24gKCBpICkgewoJCQkJb2JqLmNsYXNzTGlzdC5hZGQoIGkgKTsKCQkJfSApOwoJCX0KCQllbHNlIHsKCQkJYXJyYXkuZWFjaCggYXJnLCBmdW5jdGlvbiAoIGkgKSB7CgkJCQlpZiAoIGkgIT09ICIqIiApIHsKCQkJCQlvYmouY2xhc3NMaXN0LnJlbW92ZSggaSApOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJYXJyYXkuZWFjaCggb2JqLmNsYXNzTGlzdCwgZnVuY3Rpb24gKCB4ICkgewoJCQkJCQl0aGlzLnJlbW92ZSggeCApOwoJCQkJCX0gKTsKCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9ICk7CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIEZpbmRzIHRoZSBwb3NpdGlvbiBvZiBhbiBFbGVtZW50CgkgKgoJICogQG1ldGhvZCBwb3NpdGlvbgoJICogQG1lbWJlck9mIGVsZW1lbnQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqIEVsZW1lbnQKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgIENvb3JkaW5hdGVzIFtsZWZ0LCB0b3AsIHJpZ2h0LCBib3R0b21dCgkgKiBAZXhhbXBsZQoJICogdmFyIHBvcyA9IGtlaWdhaS51dGlsLmVsZW1lbnQucG9zaXRpb24oIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApICk7CgkgKi8KCXBvc2l0aW9uIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJb2JqID0gb2JqIHx8IGRvY3VtZW50LmJvZHk7CgkJdmFyIGxlZnQsIHRvcCwgcmlnaHQsIGJvdHRvbSwgaGVpZ2h0LCB3aWR0aDsKCgkJbGVmdCAgID0gdG9wID0gMDsKCQl3aWR0aCAgPSBvYmoub2Zmc2V0V2lkdGg7CgkJaGVpZ2h0ID0gb2JqLm9mZnNldEhlaWdodDsKCgkJaWYgKCBvYmoub2Zmc2V0UGFyZW50ICkgewoJCQl0b3AgICAgPSBvYmoub2Zmc2V0VG9wOwoJCQlsZWZ0ICAgPSBvYmoub2Zmc2V0TGVmdDsKCgkJCXdoaWxlICggb2JqID0gb2JqLm9mZnNldFBhcmVudCApIHsKCQkJCWxlZnQgKz0gb2JqLm9mZnNldExlZnQ7CgkJCQl0b3AgICs9IG9iai5vZmZzZXRUb3A7CgkJCX0KCgkJCXJpZ2h0ICA9IGRvY3VtZW50LmJvZHkub2Zmc2V0V2lkdGggIC0gKCBsZWZ0ICsgd2lkdGggKTsKCQkJYm90dG9tID0gZG9jdW1lbnQuYm9keS5vZmZzZXRIZWlnaHQgLSAoIHRvcCAgKyBoZWlnaHQgKTsKCQl9CgkJZWxzZSB7CgkJCXJpZ2h0ICA9IHdpZHRoOwoJCQlib3R0b20gPSBoZWlnaHQ7CgkJfQoKCQlyZXR1cm4gW2xlZnQsIHRvcCwgcmlnaHQsIGJvdHRvbV07Cgl9LAoKCS8qKgoJICogUHJlcGVuZHMgYW4gRWxlbWVudCB0byBhbiBFbGVtZW50CgkgKgoJICogQG1ldGhvZCBwcmVwZW5kQ2hpbGQKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiAgIEVsZW1lbnQKCSAqIEBwYXJhbSAge09iamVjdH0gY2hpbGQgQ2hpbGQgRWxlbWVudAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgICBFbGVtZW50CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC5wcmVwZW5kQ2hpbGQoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjdGFyZ2V0IiApLCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSApOwoJICovCglwcmVwZW5kQ2hpbGQgOiBmdW5jdGlvbiAoIG9iaiwgY2hpbGQgKSB7CgkJcmV0dXJuIG9iai5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMCA/IG9iai5hcHBlbmRDaGlsZCggY2hpbGQgKSA6IG9iai5pbnNlcnRCZWZvcmUoIGNoaWxkLCBvYmouY2hpbGROb2Rlc1swXSApOwoJfSwKCgkvKioKCSAqIFJlbW92ZXMgYW4gRWxlbWVudCBhdHRyaWJ1dGUKCSAqCgkgKiBAbWV0aG9kIHJlbW92ZUF0dHIKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiBFbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGtleSBBdHRyaWJ1dGUgbmFtZQoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQucmVtb3ZlQXR0ciggZG9jdW1lbnQucXVlcnlTZWxlY3RvciggImEiICksICJocmVmIiApOwoJICovCglyZW1vdmVBdHRyIDogZnVuY3Rpb24gKCBvYmosIGtleSApIHsKCQl2YXIgdGFyZ2V0OwoKCQlpZiAoIHJlZ2V4LnN2Zy50ZXN0KCBvYmoubmFtZXNwYWNlVVJJICkgKSB7CgkJCW9iai5yZW1vdmVBdHRyaWJ1dGVOUyggb2JqLm5hbWVzcGFjZVVSSSwga2V5ICk7CgkJfQoJCWVsc2UgewoJCQlpZiAoIG9iai5ub2RlTmFtZSA9PT0gIlNFTEVDVCIgJiYga2V5ID09PSAic2VsZWN0ZWQiKSB7CgkJCQl0YXJnZXQgPSB1dGlsaXR5LmRvbSggIiMiICsgb2JqLmlkICsgIiBvcHRpb25bc2VsZWN0ZWQ9XCJzZWxlY3RlZFwiXSIgKVswXTsKCgkJCQlpZiAoIHRhcmdldCApIHsKCQkJCQl0YXJnZXQuc2VsZWN0ZWQgPSBmYWxzZTsKCQkJCQl0YXJnZXQucmVtb3ZlQXR0cmlidXRlKCAic2VsZWN0ZWQiICk7CgkJCQl9CgkJCX0KCQkJZWxzZSB7CgkJCQlvYmoucmVtb3ZlQXR0cmlidXRlKCBrZXkgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBTY3JvbGxzIHRvIHRoZSBwb3NpdGlvbiBvZiBhbiBFbGVtZW50CgkgKgoJICogQG1ldGhvZCBzY3JvbGxUbwoJICogQG1lbWJlck9mIGVsZW1lbnQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqICAgICAgICBFbGVtZW50IHRvIHNjcm9sbCB0bwoJICogQHBhcmFtICB7TnVtYmVyfSBtcyAgICAgICAgIFtPcHRpb25hbF0gTWlsbGlzZWNvbmRzIHRvIHNjcm9sbCwgZGVmYXVsdCBpcyAyNTAsIG1pbiBpcyAxMDAKCSAqIEBwYXJhbSAge051bWJlcn0gb2Zmc2V0VG9wICBbT3B0aW9uYWxdIE9mZnNldCBmcm9tIHRvcCBvZiBFbGVtZW50CgkgKiBAcGFyYW0gIHtOdW1iZXJ9IG9mZnNldExlZnQgW09wdGlvbmFsXSBPZmZzZXQgZnJvbSBsZWZ0IG9mIEVsZW1lbnQKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIERlZmVycmVkfQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQuc2Nyb2xsVG8oIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApICkudGhlbiggZnVuY3Rpb24gKCkgewoJICogICAuLi4KCSAqIH0gKTsKCSAqLwoJc2Nyb2xsVG8gOiBmdW5jdGlvbiAoIG9iaiwgbXMsIG9mZnNldFRvcCwgb2Zmc2V0TGVmdCApIHsKCQl2YXIgcG9zID0gYXJyYXkucmVtb3ZlKCBlbGVtZW50LnBvc2l0aW9uKCBvYmogKSwgMiwgMyApOwoKCQlpZiAoICFpc05hTiggb2Zmc2V0VG9wICkgKSB7CgkJCXBvc1swXSArPSBvZmZzZXRUb3A7CgkJfQoKCQlpZiAoICFpc05hTiggb2Zmc2V0TGVmdCApICkgewoJCQlwb3NbMV0gKz0gb2Zmc2V0TGVmdDsKCQl9CgoJCXJldHVybiBjbGllbnQuc2Nyb2xsKCBwb3MsIG1zICk7Cgl9LAoKCS8qKgoJICogU2VyaWFsaXplcyB0aGUgZWxlbWVudHMgb2YgYW4gRWxlbWVudAoJICoKCSAqIEBtZXRob2Qgc2VyaWFsaXplCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSAgb2JqICAgIEVsZW1lbnQKCSAqIEBwYXJhbSAge0Jvb2xlYW59IHN0cmluZyBbT3B0aW9uYWxdIHRydWUgaWYgeW91IHdhbnQgYSBxdWVyeSBzdHJpbmcsIGRlZmF1bHQgaXMgZmFsc2UgKCBKU09OICkKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGVuY29kZSBbT3B0aW9uYWxdIHRydWUgaWYgeW91IHdhbnQgdG8gVVJJIGVuY29kZSB0aGUgdmFsdWUsIGRlZmF1bHQgaXMgdHJ1ZQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgICAgIFN0cmluZyBvciBPYmplY3QKCSAqIEBleGFtcGxlCgkgKiB2YXIgdXNlcklucHV0ID0ga2VpZ2FpLnV0aWwuZWxlbWVudC5zZXJpYWxpemUoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICJmb3JtIiApICk7CgkgKi8KCXNlcmlhbGl6ZSA6IGZ1bmN0aW9uICggb2JqLCBzdHJpbmcsIGVuY29kZSApIHsKCQlzdHJpbmcgICAgICAgPSAoIHN0cmluZyA9PT0gdHJ1ZSApOwoJCWVuY29kZSAgICAgICA9ICggZW5jb2RlICE9PSBmYWxzZSApOwoJCXZhciByZWdpc3RyeSA9IHt9LAoJCSAgICBjaGlsZHJlbiwgcmVzdWx0OwoKCQljaGlsZHJlbiA9IG9iai5ub2RlTmFtZSA9PT0gIkZPUk0iID8gKCBvYmouZWxlbWVudHMgPyBhcnJheS5jYXN0KCBvYmouZWxlbWVudHMgKSA6IG9iai5maW5kKCAiYnV0dG9uLCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSIgKSApIDogW29ial07CgoJCWFycmF5LmVhY2goIGNoaWxkcmVuLCBmdW5jdGlvbiAoIGkgKSB7CgkJCXZhciBpZCA9IGkuaWQgfHwgaS5uYW1lIHx8IGkudHlwZTsKCgkJCWlmICggaS5ub2RlTmFtZSA9PT0gIkZPUk0iICkgewoJCQkJdXRpbGl0eS5tZXJnZSggcmVnaXN0cnksIGpzb24uZGVjb2RlKCBlbGVtZW50LnNlcmlhbGl6ZSggaSApICkgKTsKCQkJfQoJCQllbHNlIGlmICggIXJlZ2lzdHJ5W2lkXSApIHsKCQkJCXJlZ2lzdHJ5W2lkXSA9IGVsZW1lbnQudmFsKCBpICk7CgkJCX0KCQl9ICk7CgoJCWlmICggIXN0cmluZyApIHsKCQkJcmVzdWx0ID0gcmVnaXN0cnk7CgkJfQoJCWVsc2UgewoJCQlyZXN1bHQgPSAiIjsKCgkJCXV0aWxpdHkuaXRlcmF0ZSggcmVnaXN0cnksIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCWVuY29kZSA/IHJlc3VsdCArPSAiJiIgKyBlbmNvZGVVUklDb21wb25lbnQoIGsgKSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCggdiApIDogcmVzdWx0ICs9ICImIiArIGsgKyAiPSIgKyB2OwoJCQl9ICk7CgoJCQlyZXN1bHQgPSByZXN1bHQucmVwbGFjZSggcmVnZXguYW5kLCAiPyIgKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogUmV0dXJucyB0aGUgc2l6ZSBvZiB0aGUgRWxlbWVudAoJICoKCSAqIEBtZXRob2Qgc2l6ZQoJICogQG1lbWJlck9mIGVsZW1lbnQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqIEVsZW1lbnQKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgIFt3aWR0aCwgaGVpZ2h0XQoJICogQGV4YW1wbGUKCSAqIHZhciBzaXplID0ga2VpZ2FpLnV0aWwuZWxlbWVudC5zaXplKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiI3NvbWV0aGluZyIgKSApOwoJICovCglzaXplIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIFsKCQkJb2JqLm9mZnNldFdpZHRoICArIG51bWJlci5wYXJzZSggb2JqLnN0eWxlLnBhZGRpbmdMZWZ0IHx8IDAgKSArIG51bWJlci5wYXJzZSggb2JqLnN0eWxlLnBhZGRpbmdSaWdodCAgfHwgMCApICsgbnVtYmVyLnBhcnNlKCBvYmouc3R5bGUuYm9yZGVyTGVmdCB8fCAwICkgKyBudW1iZXIucGFyc2UoIG9iai5zdHlsZS5ib3JkZXJSaWdodCAgfHwgMCApLAoJCQlvYmoub2Zmc2V0SGVpZ2h0ICsgbnVtYmVyLnBhcnNlKCBvYmouc3R5bGUucGFkZGluZ1RvcCAgfHwgMCApICsgbnVtYmVyLnBhcnNlKCBvYmouc3R5bGUucGFkZGluZ0JvdHRvbSB8fCAwICkgKyBudW1iZXIucGFyc2UoIG9iai5zdHlsZS5ib3JkZXJUb3AgIHx8IDAgKSArIG51bWJlci5wYXJzZSggb2JqLnN0eWxlLmJvcmRlckJvdHRvbSB8fCAwICkKCQldOwoJfSwKCgkvKioKCSAqIEdldHRlciAvIHNldHRlciBmb3IgYW4gRWxlbWVudCdzIHRleHQKCSAqCgkgKiBAbWV0aG9kIHRleHQKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiBFbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBbT3B0aW9uYWxdIFZhbHVlIHRvIHNldAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIHZhciBvYmogID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvciggIiNzb21ldGhpbmciICksCgkgKiAgICAgdGV4dCA9IGtlaWdhaS51dGlsLmVsZW1lbnQudGV4dCggb2JqICk7CgkgKgoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC50ZXh0KCBvYmosIHRleHQgKyAiLCBhbmQgc29tZSBtb3JlIHRleHQiICk7CgkgKi8KCXRleHQgOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCXZhciBrZXkgICAgID0gb2JqLnRleHRDb250ZW50ID8gInRleHRDb250ZW50IiA6ICJpbm5lclRleHQiLAoJCSAgICBwYXlsb2FkID0ge30sCgkJICAgIHNldCAgICAgPSBmYWxzZTsKCgkJaWYgKCB0eXBlb2YgYXJnICE9ICJ1bmRlZmluZWQiICkgewoJCQlzZXQgICAgICAgICAgPSB0cnVlOwoJCQlwYXlsb2FkW2tleV0gPSBhcmc7CgkJfQoKCQlyZXR1cm4gc2V0ID8gZWxlbWVudC51cGRhdGUoIG9iaiwgcGF5bG9hZCApIDogb2JqW2tleV07Cgl9LAoKCS8qKgoJICogVG9nZ2xlcyBhIENTUyBjbGFzcwoJICoKCSAqIEBtZXRob2QgdG9nZ2xlQ2xhc3MKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiBFbGVtZW50CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBDU1MgY2xhc3MgdG8gdG9nZ2xlCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBFbGVtZW50CgkgKiBAZXhhbXBsZQoJICogdmFyIG9iaiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApOwoJICoKCSAqIG9iai5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiAoIGV2ICkgewoJICogICBrZWlnYWkudXRpbC5lbGVtZW50LnRvZ2dsZUNsYXNzKCBvYmosICJhY3RpdmUiICk7CgkgKiB9LCBmYWxzZSApOwoJICovCgl0b2dnbGVDbGFzcyA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJb2JqLmNsYXNzTGlzdC50b2dnbGUoIGFyZyApOwoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFVwZGF0ZXMgYW4gRWxlbWVudAoJICoKCSAqIEBtZXRob2QgdXBkYXRlCgkgKiBAbWVtYmVyT2YgZWxlbWVudAoJICogQHBhcmFtICB7T2JqZWN0fSAgb2JqICBFbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IGFyZ3MgUHJvcGVydGllcyB0byBzZXQKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICBFbGVtZW50CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuZWxlbWVudC51cGRhdGUoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjc29tZXRoaW5nIiApLCB7aW5uZXJIVE1MOiAiSGVsbG8gV29ybGQhIiwgImNsYXNzIjogIm5ldyJ9ICk7CgkgKi8KCXVwZGF0ZSA6IGZ1bmN0aW9uICggb2JqLCBhcmdzICkgewoJCXV0aWxpdHkuaXRlcmF0ZSggYXJncywgZnVuY3Rpb24gKCB2LCBrICkgewoJCQlpZiAoIHJlZ2V4LmVsZW1lbnRfdXBkYXRlLnRlc3QoIGsgKSApIHsKCQkJCW9ialtrXSA9IHY7CgkJCX0KCQkJZWxzZSBpZiAoIGsgPT09ICJjbGFzcyIgKSB7CgkJCQkhc3RyaW5nLmlzRW1wdHkoIHYgKSA/IGVsZW1lbnQua2xhc3MoIG9iaiwgdiApIDogZWxlbWVudC5rbGFzcyggb2JqLCAiKiIsIGZhbHNlICk7CgkJCX0KCQkJZWxzZSBpZiAoIGsuaW5kZXhPZiggImRhdGEtIiApID09PSAwICkgewoJCQkJZWxlbWVudC5kYXRhKCBvYmosIGsucmVwbGFjZSggImRhdGEtIiwgIiIgKSwgdiApOwoJCQl9CgkJCWVsc2UgewoJCQkJZWxlbWVudC5hdHRyICggb2JqLCBrLCB2ICk7CgkJCX0KCQl9ICk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogR2V0cyBvciBzZXRzIHRoZSB2YWx1ZSBvZiBFbGVtZW50CgkgKgoJICogQG1ldGhvZCB2YWwKCSAqIEBtZW1iZXJPZiBlbGVtZW50CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiAgIEVsZW1lbnQKCSAqIEBwYXJhbSAge01peGVkfSAgdmFsdWUgW09wdGlvbmFsXSBWYWx1ZSB0byBzZXQKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgRWxlbWVudAoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLmVsZW1lbnQudmFsKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCAiaW5wdXRbdHlwZT0ndGV4dCddIiApLCAibmV3IHZhbHVlIiApOwoJICovCgl2YWwgOiBmdW5jdGlvbiAoIG9iaiwgdmFsdWUgKSB7CgkJdmFyIGV2ID0gImlucHV0IiwKCQkgICAgb3V0cHV0OwoKCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCWlmICggcmVnZXgucmFkaW9fY2hlY2tib3gudGVzdCggb2JqLnR5cGUgKSApIHsKCQkJCWlmICggc3RyaW5nLmlzRW1wdHkoIG9iai5uYW1lICkgKSB7CgkJCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5leHBlY3RlZFByb3BlcnR5ICk7CgkJCQl9CgoJCQkJYXJyYXkuZWFjaCggdXRpbGl0eS5kb20oICJpbnB1dFtuYW1lPSciICsgb2JqLm5hbWUgKyAiJ10iICksIGZ1bmN0aW9uICggaSApIHsKCQkJCQlpZiAoIGkuY2hlY2tlZCApIHsKCQkJCQkJb3V0cHV0ID0gaS52YWx1ZTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0gKTsKCQkJfQoJCQllbHNlIGlmICggcmVnZXguc2VsZWN0LnRlc3QoIG9iai50eXBlICkgKSB7CgkJCQlvdXRwdXQgPSBvYmoub3B0aW9uc1tvYmouc2VsZWN0ZWRJbmRleF0udmFsdWU7CgkJCX0KCQkJZWxzZSBpZiAoIG9iai52YWx1ZSApIHsKCQkJCW91dHB1dCA9IG9iai52YWx1ZTsKCQkJfQoJCQllbHNlIHsKCQkJCW91dHB1dCA9IGVsZW1lbnQudGV4dCggb2JqICk7CgkJCX0KCgkJCWlmICggb3V0cHV0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlvdXRwdXQgPSB1dGlsaXR5LmNvZXJjZSggb3V0cHV0ICk7CgoJCQkJaWYgKCB0eXBlb2Ygb3V0cHV0ID09ICJzdHJpbmciICkgewoJCQkJCW91dHB1dCA9IHN0cmluZy50cmltKCBvdXRwdXQgKTsKCQkJCX0KCQkJfQoJCQllbHNlIHsKCQkJCW91dHB1dCA9ICIiOwoJCQl9CgkJfQoJCWVsc2UgewoJCQl2YWx1ZSA9IHZhbHVlLnRvU3RyaW5nKCk7CgoJCQlpZiAoIHJlZ2V4LnJhZGlvX2NoZWNrYm94LnRlc3QoIG9iai50eXBlICkgKSB7CgkJCQlldiA9ICJjbGljayI7CgoJCQkJYXJyYXkuZWFjaCggdXRpbGl0eS5kb20oICJpbnB1dFtuYW1lPSciICsgb2JqLm5hbWUgKyAiJ10iICksIGZ1bmN0aW9uICggaSApIHsKCQkJCQlpZiAoIGkudmFsdWUgPT09IHZhbHVlICkgewoJCQkJCQlpLmNoZWNrZWQgPSB0cnVlOwoJCQkJCQlvdXRwdXQgPSBpOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSApOwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5zZWxlY3QudGVzdCggb2JqLnR5cGUgKSApIHsKCQkJCWV2ID0gImNoYW5nZSI7CgoJCQkJYXJyYXkuZWFjaCggZWxlbWVudC5maW5kKCBvYmosICI+ICoiICksIGZ1bmN0aW9uICggaSApIHsKCQkJCQlpZiAoIGkudmFsdWUgPT09IHZhbHVlICkgewoJCQkJCQlpLnNlbGVjdGVkID0gdHJ1ZTsKCQkJCQkJb3V0cHV0ID0gaTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0gKTsKCQkJfQoJCQllbHNlIHsKCQkJCW9iai52YWx1ZSAhPT0gdW5kZWZpbmVkID8gb2JqLnZhbHVlID0gdmFsdWUgOiBlbGVtZW50LnRleHQoIG9iaiwgdmFsdWUgKTsKCQkJfQoKCQkJZWxlbWVudC5kaXNwYXRjaCggb2JqLCBldiApOwoKCQkJb3V0cHV0ID0gb2JqOwoJCX0KCgkJcmV0dXJuIG91dHB1dDsKCX0KfTsKCi8qKgogKiBAbmFtZXNwYWNlIGpzb24KICovCnZhciBqc29uID0gewoJLyoqCgkgKiBEZWNvZGVzIHRoZSBhcmd1bWVudAoJICoKCSAqIEBtZXRob2QgZGVjb2RlCgkgKiBAbWVtYmVyT2YganNvbgoJICogQHBhcmFtICB7U3RyaW5nfSAgYXJnICAgIFN0cmluZyB0byBwYXJzZQoJICogQHBhcmFtICB7Qm9vbGVhbn0gc2lsZW50IFtPcHRpb25hbF0gU2lsZW50bHkgZmFpbAoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgICAgIEVudGl0eSByZXN1bHRpbmcgZnJvbSBwYXJzaW5nIEpTT04sIG9yIHVuZGVmaW5lZAoJICogQGV4YW1wbGUKCSAqIHZhciB4ID0ga2VpZ2FpLnV0aWwuanNvbi5kZWNvZGUoIC4uLiwgdHJ1ZSApOwoJICoKCSAqIGlmICggeCApIHsKCSAqICAgLi4uCgkgKiB9CgkgKiBlbHNlIHsKCSAqICAgLi4uIC8vIGludmFsaWQgSlNPTiwgd2l0aCBgRXJyb3JgIHN1cHByZXNzZWQgYnkgYHNpbGVudGAKCSAqIH0KCSAqLwoJZGVjb2RlIDogZnVuY3Rpb24gKCBhcmcsIHNpbGVudCApIHsKCQl0cnkgewoJCQlyZXR1cm4gSlNPTi5wYXJzZSggYXJnICk7CgkJfQoJCWNhdGNoICggZSApIHsKCQkJaWYgKCBzaWxlbnQgIT09IHRydWUgKSB7CgkJCQl1dGlsaXR5LmVycm9yKCBlLCBhcmd1bWVudHMsIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9Cgl9LAoKCS8qKgoJICogRW5jb2RlcyBgYXJnYCBhcyBKU09OCgkgKgoJICogQG1ldGhvZCBlbmNvZGUKCSAqIEBtZW1iZXJPZiBqc29uCgkgKiBAcGFyYW0gIHtNaXhlZH0gICBhcmcgICAgUHJpbWF0aXZlCgkgKiBAcGFyYW0gIHtCb29sZWFufSBzaWxlbnQgW09wdGlvbmFsXSBTaWxlbnRseSBmYWlsCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgICAgSlNPTiwgb3IgdW5kZWZpbmVkCgkgKiBAZXhhbXBsZQoJICogdmFyIHggPSBrZWlnYWkudXRpbC5qc29uLmVuY29kZSggLi4uLCB0cnVlICk7CgkgKgoJICogaWYgKCB4ICkgewoJICogICAuLi4KCSAqIH0KCSAqIGVsc2UgewoJICogICAuLi4gLy8gaW52YWxpZCBKU09OLCB3aXRoIGBFcnJvcmAgc3VwcHJlc3NlZCBieSBgc2lsZW50YAoJICogfQoJICovCgllbmNvZGUgOiBmdW5jdGlvbiAoIGFyZywgc2lsZW50ICkgewoJCXRyeSB7CgkJCXJldHVybiBKU09OLnN0cmluZ2lmeSggYXJnICk7CgkJfQoJCWNhdGNoICggZSApIHsKCQkJaWYgKCBzaWxlbnQgIT09IHRydWUgKSB7CgkJCQl1dGlsaXR5LmVycm9yKCBlLCBhcmd1bWVudHMsIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9Cgl9Cn07CgovKioKICogQG5hbWVzcGFjZSBsYWJlbAogKiBAcHJpdmF0ZQogKi8KdmFyIGxhYmVsID0gewoJLyoqCgkgKiBFeHBlY3RlZCBhIE51bWJlcgoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJZXhwZWN0ZWROdW1iZXIgOiAiRXhwZWN0ZWQgYSBOdW1iZXIiLAoKCS8qKgoJICogRXhwZWN0ZWQgYSBwcm9wZXJ0eSwgYW5kIGl0IHdhcyBub3Qgc2V0CgkgKgoJICogQHR5cGUge1N0cmluZ30KCSAqIEBtZW1iZXJPZiBsYWJlbAoJICovCglleHBlY3RlZFByb3BlcnR5IDogIkV4cGVjdGVkIGEgcHJvcGVydHksIGFuZCBpdCB3YXMgbm90IHNldCIsCgoJLyoqCgkgKiBFeHBlY3RlZCBhbiBPYmplY3QKCSAqCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQG1lbWJlck9mIGxhYmVsCgkgKi8KCWV4cGVjdGVkT2JqZWN0IDogIkV4cGVjdGVkIGFuIE9iamVjdCIsCgoJLyoqCgkgKiBPbmUgb3IgbW9yZSBhcmd1bWVudHMgaXMgaW52YWxpZAoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJaW52YWxpZEFyZ3VtZW50cyA6ICJPbmUgb3IgbW9yZSBhcmd1bWVudHMgaXMgaW52YWxpZCIsCgoJLyoqCgkgKiBJTlZBTElEX1NUQVRFX0VSUjogSGVhZGVycyBoYXZlIG5vdCBiZWVuIHJlY2VpdmVkCgkgKgoJICogQHR5cGUge1N0cmluZ30KCSAqIEBtZW1iZXJPZiBsYWJlbAoJICovCglpbnZhbGlkU3RhdGVOb0hlYWRlcnMgOiAiSU5WQUxJRF9TVEFURV9FUlI6IEhlYWRlcnMgaGF2ZSBub3QgYmVlbiByZWNlaXZlZCIsCgoJLyoqCgkgKiBTeW5jaHJvbm91cyBYTUxIdHRwUmVxdWVzdCByZXF1ZXN0cyBhcmUgbm90IHN1cHBvcnRlZAoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJaW52YWxpZFN0YXRlTm9TeW5jIDogIlN5bmNocm9ub3VzIFhNTEh0dHBSZXF1ZXN0IHJlcXVlc3RzIGFyZSBub3Qgc3VwcG9ydGVkIiwKCgkvKioKCSAqIElOVkFMSURfU1RBVEVfRVJSOiBPYmplY3QgaXMgbm90IG9wZW4KCSAqCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQG1lbWJlck9mIGxhYmVsCgkgKi8KCWludmFsaWRTdGF0ZU5vdE9wZW4gOiAiSU5WQUxJRF9TVEFURV9FUlI6IE9iamVjdCBpcyBub3Qgb3BlbiIsCgoJLyoqCgkgKiBJTlZBTElEX1NUQVRFX0VSUjogT2JqZWN0IGlzIHNlbmRpbmcKCSAqCgkgKiBAdHlwZSB7U3RyaW5nfQoJICogQG1lbWJlck9mIGxhYmVsCgkgKi8KCWludmFsaWRTdGF0ZU5vdFNlbmRpbmcgOiAiSU5WQUxJRF9TVEFURV9FUlI6IE9iamVjdCBpcyBzZW5kaW5nIiwKCgkvKioKCSAqIElOVkFMSURfU1RBVEVfRVJSOiBPYmplY3QgaXMgbm90IHVzYWJsZQoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJaW52YWxpZFN0YXRlTm90VXNhYmxlIDogIklOVkFMSURfU1RBVEVfRVJSOiBPYmplY3QgaXMgbm90IHVzYWJsZSIsCgoJLyoqCgkgKiBEZWZhdWx5IGBlbXB0eU1zZ2Agb2YgRGF0YUxpc3RzCgkgKgoJICogQHR5cGUge1N0cmluZ30KCSAqIEBtZW1iZXJPZiBsYWJlbAoJICovCglub0RhdGEgOiAiTm90aGluZyB0byBkaXNwbGF5IiwKCgkvKioKCSAqIFJlcXVlc3RlZCBtZXRob2QgaXMgbm90IGF2YWlsYWJsZQoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJbm90QXZhaWxhYmxlIDogIlJlcXVlc3RlZCBtZXRob2QgaXMgbm90IGF2YWlsYWJsZSIsCgoJLyoqCgkgKiBObyBwcmV2aW91cyB2ZXJzaW9uIG9mIGEgcmVjb3JkCgkgKgoJICogQHR5cGUge1N0cmluZ30KCSAqIEBtZW1iZXJPZiBsYWJlbAoJICovCglkYXRhc3RvcmVOb1ByZXZWZXJzaW9uIDogIk5vIHByZXZpb3VzIHZlcnNpb24gZm91bmQiLAoKCS8qKgoJICogU2VydmVyIGVycm9yIGhhcyBvY2N1cnJlZAoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJc2VydmVyRXJyb3IgOiAiU2VydmVyIGVycm9yIGhhcyBvY2N1cnJlZCIsCgoJLyoqCgkgKiBGb3JiaWRkZW4gdG8gYWNjZXNzIFVSSQoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJc2VydmVyRm9yYmlkZGVuIDogIkZvcmJpZGRlbiB0byBhY2Nlc3MgVVJJIiwKCgkvKioKCSAqIE1ldGhvZCBub3QgYWxsb3dlZAoJICoKCSAqIEB0eXBlIHtTdHJpbmd9CgkgKiBAbWVtYmVyT2YgbGFiZWwKCSAqLwoJc2VydmVySW52YWxpZE1ldGhvZCA6ICJNZXRob2Qgbm90IGFsbG93ZWQiLAoKCS8qKgoJICogQXV0aG9yaXphdGlvbiByZXF1aXJlZCB0byBhY2Nlc3MgVVJJCgkgKgoJICogQHR5cGUge1N0cmluZ30KCSAqIEBtZW1iZXJPZiBsYWJlbAoJICovCglzZXJ2ZXJVbmF1dGhvcml6ZWQgOiAiQXV0aG9yaXphdGlvbiByZXF1aXJlZCB0byBhY2Nlc3MgVVJJIiwKCgkvKioKCSAqIFlvdXIgYnJvd3NlciBpcyB0b28gb2xkIHRvIHVzZSBrZWlnYWksIHBsZWFzZSB1cGdyYWRlCgkgKgoJICogQHR5cGUge1N0cmluZ30KCSAqIEBtZW1iZXJPZiBsYWJlbAoJICovCgl1cGdyYWRlIDogIllvdXIgYnJvd3NlciBpcyB0b28gb2xkIHRvIHVzZSBrZWlnYWksIHBsZWFzZSB1cGdyYWRlIgp9OwoKLyoqCiAqIEBuYW1lc3BhY2UgbWF0aAogKi8KdmFyIG1hdGggPSB7CgkvKioKCSAqIEdlbmVyYXRlcyBiZXppZXIgY3VydmUgY29vcmRpbmF0ZXMgZm9yIHVwIHRvIDQgcG9pbnRzLCBsYXN0IHBhcmFtZXRlciBpcyBgdGAKCSAqCgkgKiBUd28gcG9pbnQgZXhhbXBsZTogKDAsIDEwLCAwLCAwLCAxKSBtZWFucyBtb3ZlIHN0cmFpZ2h0IHVwCgkgKgoJICogQG1ldGhvZCBiZXppZXIKCSAqIEBtZW1iZXJPZiBtYXRoCgkgKiBAcmV0dXJuIHtBcnJheX0gQ29vcmRpbmF0ZXMKCSAqIEBleGFtcGxlCgkgKiAvLyBNb3Zpbmcgc3RyYWlnaHQgZG93bgoJICogdmFyIHAxID0ga2VpZ2FpLnV0aWwubWF0aC5iZXppZXIoIDAsIDEwLCAyMDAwLCAxMCwgMCApLAoJICogICAgIHAyID0ga2VpZ2FpLnV0aWwubWF0aC5iZXppZXIoIDAsIDEwLCAyMDAwLCAxMCwgMC41ICksCgkgKiAgICAgcDMgPSBrZWlnYWkudXRpbC5tYXRoLmJlemllciggMCwgMTAsIDIwMDAsIDEwLCAwLjc1ICksCgkgKiAgICAgcDQgPSBrZWlnYWkudXRpbC5tYXRoLmJlemllciggMCwgMTAsIDIwMDAsIDEwLCAwLjkgKSwKCSAqICAgICBwNSA9IGtlaWdhaS51dGlsLm1hdGguYmV6aWVyKCAwLCAxMCwgMjAwMCwgMTAsIDEgKTsKCSAqLwoJYmV6aWVyIDogZnVuY3Rpb24gKCkgewoJCXZhciBhID0gYXJyYXkuY2FzdCggYXJndW1lbnRzICksCgkJICAgIHQgPSBhLnBvcCgpLAoJCSAgICBQID0gYXJyYXkuY2h1bmsoIGEsIDIgKSwKCQkgICAgbiA9IFAubGVuZ3RoLAoJCSAgICBjLCBTMCwgUTAsIFExLCBRMiwgQzAsIEMxLCBDMiwgQzM7CgoJCWlmICggbiA8IDIgfHwgbiA+IDQgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApOwoJCX0KCgkJLy8gU2V0dGluZyB2YXJpYWJsZXMKCQljICA9IFtdOwoJCVMwID0gMSAtIHQ7CgkJUTAgPSBtYXRoLnNxciggUzAgKTsKCQlRMSA9IDIgKiBTMCAqIHQ7CgkJUTIgPSBtYXRoLnNxciggdCApOwoJCUMwID0gTWF0aC5wb3coIFMwLCAzICk7CgkJQzEgPSAzICogUTAgKiB0OwoJCUMyID0gMyAqIFMwICogUTI7CgkJQzMgPSBNYXRoLnBvdyggdCwgMyApOwoKCQkvLyBTdHJhaWdodAoJCWlmICggbiA9PT0gMiApIHsKCQkJYy5wdXNoKCAoIFMwICogUFswXVswXSApICsgKCB0ICogUFsxXVswXSApICk7CgkJCWMucHVzaCggKCBTMCAqIFBbMF1bMV0gKSArICggdCAqIFBbMV1bMV0gKSApOwoJCX0KCQkvLyBRdWFkcmF0aWMKCQllbHNlIGlmICggbiA9PT0gMyApIHsKCQkJYy5wdXNoKCAoIFEwICogUFswXVswXSApICsgKCBRMSAqIFBbMV1bMF0gKSArICggUTIgKyBQWzJdWzBdICkgKTsKCQkJYy5wdXNoKCAoIFEwICogUFswXVsxXSApICsgKCBRMSAqIFBbMV1bMV0gKSArICggUTIgKyBQWzJdWzFdICkgKTsKCQl9CgkJLy8gQ3ViaWMKCQllbHNlIGlmICggbiA9PT0gNCApIHsKCQkJYy5wdXNoKCAoIEMwICogUFswXVswXSApICsgKCBDMSAqIFBbMV1bMF0gKSArICggQzIgKiBQWzJdWzBdICkgKyAoIEMzICogUFszXVswXSApICk7CgkJCWMucHVzaCggKCBDMCAqIFBbMF1bMV0gKSArICggQzEgKiBQWzFdWzFdICkgKyAoIEMyICogUFsyXVsxXSApICsgKCBDMyAqIFBbM11bMV0gKSApOwoJCX0KCgkJcmV0dXJuIGM7Cgl9LAoKCS8qKgoJICogRmluZHMgdGhlIGRpc3RhbmNlIGJldHdlZW4gMiBBcnJheXMgb2YgY29vcmRpbmF0ZXMKCSAqCgkgKiBAbWV0aG9kIGRpc3QKCSAqIEBtZW1iZXJPZiBtYXRoCgkgKiBAcGFyYW0gIHtBcnJheX0gYSBDb29yZGluYXRlcyBbeCwgeV0KCSAqIEBwYXJhbSAge0FycmF5fSBiIENvb3JkaW5hdGVzIFt4LCB5XQoJICogQHJldHVybiB7TnVtYmVyfSAgRGlzdGFuY2UgYmV0d2VlbiBgYWAgJiBgYmAKCSAqIEBleGFtcGxlCgkgKiB2YXIgZGlzdCA9IGtlaWdhaS51dGlsLm1hdGguZGlzdCggWzQsIDQwXSwgWy0xMCwgMTJdICk7CgkgKi8KCWRpc3QgOiBmdW5jdGlvbiAoIGEsIGIgKSB7CgkJcmV0dXJuIE1hdGguc3FydCggbWF0aC5zcXIoIGJbMF0gLSBhWzBdICkgKyBtYXRoLnNxciggYlsxXSAtIGFbMV0gKSApOwoJfSwKCgkvKioKCSAqIFNxdWFyZXMgYSBOdW1iZXIKCSAqCgkgKiBAbWV0aG9kIHNxcgoJICogQG1lbWJlck9mIG1hdGgKCSAqIEBwYXJhbSAge051bWJlcn0gbiBOdW1iZXIgdG8gc3F1YXJlCgkgKiBAcmV0dXJuIHtOdW1iZXJ9ICAgU3F1YXJlZCB2YWx1ZQoJICogQGV4YW1wbGUKCSAqIHZhciBzcXIgPSBrZWlnYWkudXRpbC5tYXRoLnNxciggMjMgKTsKCSAqLwoJc3FyIDogZnVuY3Rpb24gKCBuICkgewoJCXJldHVybiBNYXRoLnBvdyggbiwgMiApOwoJfQp9OwoKLyoqCiAqIEBuYW1lc3BhY2UgbnVtYmVyCiAqLwp2YXIgbnVtYmVyID0gewoJLyoqCgkgKiBSZXR1cm5zIHRoZSBkaWZmZXJlbmNlIG9mIGFyZwoJICoKCSAqIEBtZXRob2QgZGlmZgoJICogQG1lbWJlck9mIG51bWJlcgoJICogQHBhcmFtIHtOdW1iZXJ9IGFyZyBOdW1iZXIgdG8gY29tcGFyZQoJICogQHJldHVybiB7TnVtYmVyfSAgICBUaGUgYWJzb2x1dGUgZGlmZmVyZW5jZQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLm51bWJlci5kaWZmKCAtMywgOCApOyAvLyAxMQoJICovCglkaWZmIDogZnVuY3Rpb24gKCBudW0xLCBudW0yICkgewoJCWlmICggaXNOYU4oIG51bTEgKSB8fCBpc05hTiggbnVtMiApICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmV4cGVjdGVkTnVtYmVyICk7CgkJfQoKCQlyZXR1cm4gTWF0aC5hYnMoIG51bTEgLSBudW0yICk7Cgl9LAoKCS8qKgoJICogVGVzdHMgaWYgYW4gbnVtYmVyIGlzIGV2ZW4KCSAqCgkgKiBAbWV0aG9kIGV2ZW4KCSAqIEBtZW1iZXJPZiBudW1iZXIKCSAqIEBwYXJhbSB7TnVtYmVyfSBhcmcgTnVtYmVyIHRvIHRlc3QKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgVHJ1ZSBpZiBldmVuLCBvciB1bmRlZmluZWQKCSAqIEBleGFtcGxlCgkgKiB2YXIgbiA9IGtlaWdhaS51dGlsLm51bWJlci5yYW5kb20oIDEwICk7CgkgKgoJICogaWYgKCBrZWlnYWkudXRpbC5udW1iZXIuZXZlbiggbiApICkgewoJICogICAuLi4KCSAqIH0KCSAqLwoJZXZlbiA6IGZ1bmN0aW9uICggYXJnICkgewoJCXJldHVybiBhcmcgJSAyID09PSAwOwoJfSwKCgkvKioKCSAqIEZvcm1hdHMgYSBOdW1iZXIgdG8gYSBkZWxpbWl0ZWQgU3RyaW5nCgkgKgoJICogQG1ldGhvZCBmb3JtYXQKCSAqIEBtZW1iZXJPZiBudW1iZXIKCSAqIEBwYXJhbSAge051bWJlcn0gYXJnICAgICAgIE51bWJlciB0byBmb3JtYXQKCSAqIEBwYXJhbSAge1N0cmluZ30gZGVsaW1pdGVyIFtPcHRpb25hbF0gU3RyaW5nIHRvIGRlbGltaXQgdGhlIE51bWJlciB3aXRoCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGV2ZXJ5ICAgICBbT3B0aW9uYWxdIFBvc2l0aW9uIHRvIGluc2VydCB0aGUgZGVsaW1pdGVyLCBkZWZhdWx0IGlzIDMKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgICAgICAgIE51bWJlciByZXByZXNlbnRlZCBhcyBhIGNvbW1hIGRlbGltaXRlZCBTdHJpbmcKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5udW1iZXIuZm9ybWF0KCAxMDAwICk7IC8vICIxLDAwMCIKCSAqLwoJZm9ybWF0IDogZnVuY3Rpb24gKCBhcmcsIGRlbGltaXRlciwgZXZlcnkgKSB7CgkJaWYgKCBpc05hTiggYXJnICkgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuZXhwZWN0ZWROdW1iZXIgKTsKCQl9CgoJCWFyZyAgICAgICA9IGFyZy50b1N0cmluZygpOwoJCWRlbGltaXRlciA9IGRlbGltaXRlciB8fCAiLCI7CgkJZXZlcnkgICAgID0gZXZlcnkgICAgIHx8IDM7CgoJCXZhciBkID0gYXJnLmluZGV4T2YoICIuIiApID4gLTEgPyAiLiIgKyBhcmcucmVwbGFjZSggcmVnZXgubnVtYmVyX2Zvcm1hdF8xLCAiIiApIDogIiIsCgkJICAgIGEgPSBhcmcucmVwbGFjZSggcmVnZXgubnVtYmVyX2Zvcm1hdF8yLCAiIiApLnNwbGl0KCAiIiApLnJldmVyc2UoKSwKCQkgICAgcCA9IE1hdGguZmxvb3IoIGEubGVuZ3RoIC8gZXZlcnkgKSwKCQkgICAgaSA9IDEsIG4sIGI7CgoJCWZvciAoIGIgPSAwOyBiIDwgcDsgYisrICkgewoJCQluID0gaSA9PT0gMSA/IGV2ZXJ5IDogKCBldmVyeSAqIGkgKSArICggaSA9PT0gMiA/IDEgOiAoIGkgLSAxICkgKTsKCQkJYS5zcGxpY2UoIG4sIDAsIGRlbGltaXRlciApOwoJCQlpKys7CgkJfQoKCQlhID0gYS5yZXZlcnNlKCkuam9pbiggIiIgKTsKCgkJaWYgKCBhLmNoYXJBdCggMCApID09PSBkZWxpbWl0ZXIgKSB7CgkJCWEgPSBhLnN1YnN0cmluZyggMSApOwoJCX0KCgkJcmV0dXJuIGEgKyBkOwoJfSwKCgkvKioKCSAqIFJldHVybnMgaGFsZiBvZiBhLCBvciB0cnVlIGlmIGEgaXMgaGFsZiBvZiBiCgkgKgoJICogQG1ldGhvZCBoYWxmCgkgKiBAbWVtYmVyT2YgbnVtYmVyCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGEgTnVtYmVyIHRvIGRpdmlkZQoJICogQHBhcmFtICB7TnVtYmVyfSBiIFtPcHRpb25hbF0gTnVtYmVyIHRvIHRlc3QgYSBhZ2FpbnN0CgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgQm9vbGVhbiBpZiBiIGlzIHBhc3NlZCwgTnVtYmVyIGlmIGIgaXMgdW5kZWZpbmVkCgkgKiBAZXhhbXBsZQoJICogaWYgKCBrZWlnYWkudXRpbC5udW1iZXIuaGFsZiggMiwgNCApICkgewoJICogICAuLi4KCSAqIH0gKTsKCSAqLwoJaGFsZiA6IGZ1bmN0aW9uICggYSwgYiApIHsKCQlyZXR1cm4gYiA/ICggKCBhIC8gYiApID09PSAwLjUgKSA6ICggYSAvIDIgKTsKCX0sCgoJLyoqCgkgKiBUZXN0cyBpZiBhIG51bWJlciBpcyBvZGQKCSAqCgkgKiBAbWV0aG9kIG9kZAoJICogQG1lbWJlck9mIG51bWJlcgoJICogQHBhcmFtICB7TnVtYmVyfSBhcmcgTnVtYmVyIHRvIHRlc3QKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgIFRydWUgaWYgb2RkLCBvciB1bmRlZmluZWQKCSAqIEBleGFtcGxlCgkgKiB2YXIgbiA9IGtlaWdhaS51dGlsLm51bWJlci5yYW5kb20oIDEwICk7CgkgKgoJICogaWYgKCBrZWlnYWkudXRpbC5udW1iZXIub2RkKCBuICkgKSB7CgkgKiAgIC4uLgoJICogfQoJICovCglvZGQgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQlyZXR1cm4gIW51bWJlci5ldmVuKCBhcmcgKTsKCX0sCgoJLyoqCgkgKiBQYXJzZXMgdGhlIG51bWJlcgoJICoKCSAqIEBtZXRob2QgcGFyc2UKCSAqIEBtZW1iZXJPZiBudW1iZXIKCSAqIEBwYXJhbSAge01peGVkfSAgYXJnICBOdW1iZXIgdG8gcGFyc2UKCSAqIEBwYXJhbSAge051bWJlcn0gYmFzZSBJbnRlZ2VyIHJlcHJlc2VudGluZyB0aGUgYmFzZSBvciByYWRpeAoJICogQHJldHVybiB7TnVtYmVyfSAgICAgIEludGVnZXIgb3IgZmxvYXQKCSAqIEBleGFtcGxlCgkgKiAvLyBVbnN1cmUgaWYgYG5gIGlzIGFuIGludCBvciBhIGZsb2F0CgkgKiBrZWlnYWkudXRpbC5udW1iZXIucGFyc2UoIG4gKTsKCSAqLwoJcGFyc2UgOiBmdW5jdGlvbiAoIGFyZywgYmFzZSApIHsKCQlyZXR1cm4gKCBiYXNlID09PSB1bmRlZmluZWQgKSA/IHBhcnNlRmxvYXQoIGFyZyApIDogcGFyc2VJbnQoIGFyZywgYmFzZSApOwoJfSwKCgkvKioKCSAqIEdlbmVyYXRlcyBhIHJhbmRvbSBudW1iZXIgYmV0d2VlbiAwIGFuZCBgYXJnYAoJICoKCSAqIEBtZXRob2QgcmFuZG9tCgkgKiBAbWVtYmVyT2YgbnVtYmVyCgkgKiBAcGFyYW0gIHtOdW1iZXJ9IGFyZyBDZWlsaW5nIGZvciByYW5kb20gbnVtYmVyLCBkZWZhdWx0IGlzIDEwMAoJICogQHJldHVybiB7TnVtYmVyfSAgICAgUmFuZG9tIG51bWJlcgoJICogQGV4YW1wbGUKCSAqIHZhciBuID0ga2VpZ2FpLnV0aWwubWF0aC5yYW5kb20oIDEwICk7CgkgKi8KCXJhbmRvbSA6IGZ1bmN0aW9uICggYXJnICkgewoJCWFyZyA9IGFyZyB8fCAxMDA7CgoJCXJldHVybiBNYXRoLmZsb29yKCBNYXRoLnJhbmRvbSgpICogKCBhcmcgKyAxICkgKTsKCX0sCgoJLyoqCgkgKiBSb3VuZHMgYSBudW1iZXIgdXAgb3IgZG93bgoJICoKCSAqIEBtZXRob2Qgcm91bmQKCSAqIEBtZW1iZXJPZiBudW1iZXIKCSAqIEBwYXJhbSAge051bWJlcn0gYXJnICAgICAgIE51bWJlciB0byByb3VuZAoJICogQHBhcmFtICB7U3RyaW5nfSBkaXJlY3Rpb24gW09wdGlvbmFsXSAidXAiIG9yICJkb3duIgoJICogQHJldHVybiB7TnVtYmVyfSAgICAgICAgICAgUm91bmRlZCBpbnRlcmdlcgoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLm1hdGgucm91bmQoIG4sICJkb3duIiApOwoJICovCglyb3VuZCA6IGZ1bmN0aW9uICggYXJnLCBkaXJlY3Rpb24gKSB7CgkJYXJnID0gbnVtYmVyLnBhcnNlKCBhcmcgKTsKCgkJaWYgKCBkaXJlY3Rpb24gPT09IHVuZGVmaW5lZCB8fCBzdHJpbmcuaXNFbXB0eSggZGlyZWN0aW9uICkgKSB7CgkJCXJldHVybiBudW1iZXIucGFyc2UoIGFyZy50b0ZpeGVkKCAwICkgKTsKCQl9CgkJZWxzZSBpZiAoIHJlZ2V4LmRvd24udGVzdCggZGlyZWN0aW9uICkgKSB7CgkJCXJldHVybiB+figgYXJnICk7CgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gTWF0aC5jZWlsKCBhcmcgKTsKCQl9Cgl9Cn07CgovKioKICogQG5hbWVzcGFjZSBwcm9taXNlCiAqLwp2YXIgcHJvbWlzZSA9IHsKCS8qKgoJICogIlVuYm94ZWQiIFByb21pc2UgZmFjdG9yeQoJICoKCSAqIEBtZXRob2QgZmFjdG9yeQoJICogQG1lbWJlck9mIHByb21pc2UKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIFByb21pc2V9CgkgKi8KCWZhY3RvcnkgOiBmdW5jdGlvbiAoKSB7CgkJdmFyIHByb21pc2UsIHBDYXRjaCwgcFJlc29sdmUsIHBSZWplY3QsIHBUaGVuOwoJCQoJCXByb21pc2UgPSBuZXcgUHJvbWlzZSggZnVuY3Rpb24gKCByZXNvbHZlLCByZWplY3QgKSB7CgkJCXBSZXNvbHZlID0gcmVzb2x2ZTsKCQkJcFJlamVjdCAgPSByZWplY3Q7CgkJfSApOwoKCQlwQ2F0Y2ggPSBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBwcm9taXNlWyJjYXRjaCJdLmFwcGx5KCBwcm9taXNlLCBhcmd1bWVudHMgKTsKCQl9OwoKCQlwVGhlbiA9IGZ1bmN0aW9uICgpIHsKCQkJcmV0dXJuIHByb21pc2UudGhlbi5hcHBseSggcHJvbWlzZSwgYXJndW1lbnRzICk7CgkJfTsKCgkJcmV0dXJuIHsiY2F0Y2giOiBwQ2F0Y2gsIHJlc29sdmU6IHBSZXNvbHZlLCByZWplY3Q6IHBSZWplY3QsIHRoZW46IHBUaGVufTsKCX0KfTsKCi8qKgogKiBAbmFtZXNwYWNlIHN0b3JlCiAqLwp2YXIgc3RvcmUgPSB7CgkvKioKCSAqIERlY29yYXRlcyBhIERhdGFTdG9yZSBvbiBhbiBPYmplY3QKCSAqCgkgKiBAbWV0aG9kIGZhY3RvcnkKCSAqIEBtZW1iZXJPZiBzdG9yZQoJICogQHBhcmFtICB7TWl4ZWR9ICByZWNzIFtPcHRpb25hbF0gRGF0YSB0byBzZXQgd2l0aCB0aGlzLmJhdGNoCgkgKiBAcGFyYW0gIHtPYmplY3R9IGFyZ3MgW09wdGlvbmFsXSBBcmd1bWVudHMgdG8gc2V0IG9uIHRoZSBzdG9yZQoJICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRhdGFTdG9yZX0KCSAqIEBleGFtcGxlCgkgKiB2YXIgc3RvcmUgPSBrZWlnYWkuc3RvcmUobnVsbCwge2tleTogImd1aWQifSk7CgkgKgoJICogc3RvcmUuc2V0VXJpKCAiaHR0cDovLy4uLiIgKS50aGVuKCBmdW5jdGlvbiAoIHJlY29yZHMgKSB7CgkgKiAgIC8vIERvIHNvbWV0aGluZyB3aXRoIHRoZSByZWNvcmRzCgkgKiB9LCBmdW5jdGlvbiAoIGUgKSB7CgkgKiAgIC8vIEhhbmRsZSBgZWAKCSAqIH0gKTsKCSAqLwoJZmFjdG9yeSA6IGZ1bmN0aW9uICggcmVjcywgYXJncyApIHsKCQl2YXIgb2JqID0gbmV3IERhdGFTdG9yZSgpOwoKCQlpZiAoIGFyZ3MgaW5zdGFuY2VvZiBPYmplY3QgKSB7CgkJCXV0aWxpdHkubWVyZ2UoIG9iaiwgYXJncyApOwoJCX0KCgkJaWYgKCByZWNzICE9PSBudWxsICYmIHR5cGVvZiByZWNzID09ICJvYmplY3QiICkgewoJCQlvYmouYmF0Y2goICJzZXQiLCByZWNzICk7CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIERhdGFTdG9yZSB3b3JrZXIgaGFuZGxlcgoJICoKCSAqIEBtZXRob2Qgd29ya2VyCgkgKiBAbWVtYmVyT2Ygc3RvcmUKCSAqIEBwYXJhbSAge09iamVjdH0gZXYgRXZlbnQKCSAqIEByZXR1cm4ge1VuZGVmaW5lZH0gdW5kZWZpbmVkCgkgKiBAcHJpdmF0ZQoJICovCgl3b3JrZXIgOiBmdW5jdGlvbiAoIGV2ICkgewoJCXZhciBjbWQgICAgID0gZXYuZGF0YS5jbWQsCgkJICAgIHJlY29yZHMgPSBldi5kYXRhLnJlY29yZHMsCgkJICAgIGNsYXVzZXMsIGNvbmQsIGZ1bmN0aW9ucywgaW5kZXhlcywgaW5kZXgsIHJlc3VsdCwgc29ydGVkLCB3aGVyZSwgdmFsdWVzOwoKCQlpZiAoIGNtZCA9PT0gInNlbGVjdCIgKSB7CgkJCXdoZXJlICAgICA9IEpTT04ucGFyc2UoIGV2LmRhdGEud2hlcmUgKTsKCQkJZnVuY3Rpb25zID0gZXYuZGF0YS5mdW5jdGlvbnM7CgkJCWNsYXVzZXMgICA9IGFycmF5LmZyb21PYmplY3QoIHdoZXJlICk7CgkJCXNvcnRlZCAgICA9IGFycmF5LmZsYXQoIGNsYXVzZXMgKS5maWx0ZXIoIGZ1bmN0aW9uICggaSwgaWR4ICkgeyByZXR1cm4gaWR4ICUgMiA9PT0gMDsgfSApLnNvcnQoIGFycmF5LnNvcnQgKTsKCQkJaW5kZXggICAgID0gc29ydGVkLmpvaW4oICJ8IiApOwoJCQl2YWx1ZXMgICAgPSBzb3J0ZWQubWFwKCBmdW5jdGlvbiAoIGkgKSB7IHJldHVybiB3aGVyZVtpXTsgfSApLmpvaW4oICJ8IiApOwoJCQlpbmRleGVzICAgPSBldi5kYXRhLmluZGV4ZXM7CgkJCWNvbmQgICAgICA9ICJyZXR1cm4gKCAiOwoKCQkJaWYgKCBmdW5jdGlvbnMubGVuZ3RoID09PSAwICYmIGluZGV4ZXNbaW5kZXhdICkgewoJCQkJcmVzdWx0ID0gKCBpbmRleGVzW2luZGV4XVt2YWx1ZXNdIHx8IFtdICkubWFwKCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJcmV0dXJuIHJlY29yZHNbaV07CgkJCQl9ICk7CgkJCX0KCQkJZWxzZSB7CgkJCQlpZiAoIGNsYXVzZXMubGVuZ3RoID4gMSApIHsKCQkJCQlhcnJheS5lYWNoKCBjbGF1c2VzLCBmdW5jdGlvbiAoIGksIGlkeCApIHsKCQkJCQkJdmFyIGIxID0gIiggIjsKCgkJCQkJCWlmICggaWR4ID4gMCApIHsKCQkJCQkJCWIxID0gIiAmJiAoICI7CgkJCQkJCX0KCgkJCQkJCWlmICggYXJyYXkuY29udGFpbnMoIGZ1bmN0aW9ucywgaVswXSApICkgewoJCQkJCQkJY29uZCArPSBiMSArIGlbMV0gKyAiKCByZWMuZGF0YVtcIiIgKyBpWzBdICsgIlwiXSApICkiOwoJCQkJCQl9CgkJCQkJCWVsc2UgaWYgKCFpc05hTihpWzFdKSkgewoJCQkJCQkJY29uZCArPSBiMSArICJyZWMuZGF0YVtcIiIgKyBpWzBdICsgIlwiXSA9PT0gIiArIGlbMV0gKyAiICkiOwoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJY29uZCArPSBiMSArICJyZWMuZGF0YVtcIiIgKyBpWzBdICsgIlwiXSA9PT0gXCIiICsgaVsxXSArICJcIiApIjsKCQkJCQkJfQoJCQkJCX0gKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWlmICggYXJyYXkuY29udGFpbnMoIGZ1bmN0aW9ucywgY2xhdXNlc1swXVswXSApICkgewoJCQkJCQljb25kICs9IGNsYXVzZXNbMF1bMV0gKyAiKCByZWMuZGF0YVtcIiIgKyBjbGF1c2VzWzBdWzBdICsgIlwiXSApIjsKCQkJCQl9CgkJCQkJZWxzZSBpZiAoICFpc05hTiggY2xhdXNlc1swXVsxXSApICkgewoJCQkJCQljb25kICs9ICJyZWMuZGF0YVtcIiIgKyBjbGF1c2VzWzBdWzBdICsgIlwiXSA9PT0gIiArIGNsYXVzZXNbMF1bMV07CgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQljb25kICs9ICJyZWMuZGF0YVtcIiIgKyBjbGF1c2VzWzBdWzBdICsgIlwiXSA9PT0gXCIiICsgY2xhdXNlc1swXVsxXSArICJcIiI7CgkJCQkJfQoJCQkJfQoKCQkJCWNvbmQgKz0gIiApOyI7CgoJCQkJcmVzdWx0ID0gcmVjb3Jkcy5maWx0ZXIoIG5ldyBGdW5jdGlvbigicmVjIiwgY29uZCApICk7CgkJCX0KCQl9CgkJZWxzZSBpZiAoIGNtZCA9PT0gInNvcnQiICkgewoJCQlyZXN1bHQgPSBhcnJheS5rZXlTb3J0KCByZWNvcmRzLCBldi5kYXRhLnF1ZXJ5LCAiZGF0YSIgKTsKCQl9CgoJCXBvc3RNZXNzYWdlKCByZXN1bHQgKTsKCX0KfTsKCi8qKgogKiBDcmVhdGVzIGEgbmV3IERhdGFTdG9yZQogKgogKiBAY29uc3RydWN0b3IKICogQG1lbWJlck9mIGtlaWdhaQogKiBAZXh0ZW5kcyB7a2VpZ2FpLkJhc2V9CiAqIEBleGFtcGxlCiAqIHZhciBzdG9yZSA9IGtlaWdhaS5zdG9yZSgpOwogKi8KZnVuY3Rpb24gRGF0YVN0b3JlICgpIHsKCXRoaXMuYXV0b3NhdmUgICAgPSBmYWxzZTsKCXRoaXMuY2FsbGJhY2sgICAgPSBudWxsOwoJdGhpcy5jcmVkZW50aWFscyA9IG51bGw7Cgl0aGlzLmxpc3RzICAgICAgID0gW107Cgl0aGlzLmV2ZW50cyAgICAgID0gdHJ1ZTsKCXRoaXMuZXhwaXJlcyAgICAgPSBudWxsOwoJdGhpcy5oZWFkZXJzICAgICA9IHtBY2NlcHQ6ICJhcHBsaWNhdGlvbi9qc29uIn07Cgl0aGlzLmlnbm9yZSAgICAgID0gW107Cgl0aGlzLmluZGV4ICAgICAgID0gW107Cgl0aGlzLmluZGV4ZXMgICAgID0ge2tleToge319OwoJdGhpcy5rZXkgICAgICAgICA9IG51bGw7Cgl0aGlzLmxvYWRlZCAgICAgID0gZmFsc2U7Cgl0aGlzLm1vbmdvZGIgICAgID0gIiI7Cgl0aGlzLm9ic2VydmVyICAgID0gb2JzZXJ2YWJsZS5mYWN0b3J5KCk7Cgl0aGlzLnJlY29yZHMgICAgID0gW107Cgl0aGlzLnNvdXJjZSAgICAgID0gbnVsbDsKCXRoaXMudG90YWwgICAgICAgPSAwOwoJdGhpcy52ZXJzaW9ucyAgICA9IHt9OwoJdGhpcy52ZXJzaW9uaW5nICA9IHRydWU7Cgl0aGlzLnZpZXdzICAgICAgID0ge307Cgl0aGlzLnVyaSAgICAgICAgID0gbnVsbDsKfQoKLyoqCiAqIEV4dGVuZGluZyBCYXNlCiAqCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YUdyaWQKICogQHR5cGUge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQogKi8KRGF0YVN0b3JlLnByb3RvdHlwZSA9IGJhc2UuZmFjdG9yeSgpOwoKLyoqCiAqIFNldHRpbmcgY29uc3RydWN0b3IgbG9vcAogKgogKiBAbWV0aG9kIGNvbnN0cnVjdG9yCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEB0eXBlIHtGdW5jdGlvbn0KICogQHByaXZhdGUKICovCkRhdGFTdG9yZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEYXRhU3RvcmU7CgovKioKICogQmF0Y2ggc2V0cyBvciBkZWxldGVzIGRhdGEgaW4gdGhlIHN0b3JlCiAqCiAqIEBtZXRob2QgYmF0Y2gKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7U3RyaW5nfSAgdHlwZSBUeXBlIG9mIGFjdGlvbiB0byBwZXJmb3JtICggc2V0L2RlbC9kZWxldGUgKQogKiBAcGFyYW0gIHtBcnJheX0gICBkYXRhIEFycmF5IG9mIGtleXMgb3IgaW5kaWNlcyB0byBkZWxldGUsIG9yIE9iamVjdCBjb250YWluaW5nIG11bHRpcGxlIHJlY29yZHMgdG8gc2V0CiAqIEBwYXJhbSAge0Jvb2xlYW59IHN5bmMgW09wdGlvbmFsXSBTeW5jcyBzdG9yZSB3aXRoIGRhdGEsIGlmIHRydWUgZXZlcnl0aGluZyBpcyBlcmFzZWQKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNiZWZvcmVCYXRjaCBGaXJlcyBiZWZvcmUgdGhlIGJhdGNoIGlzIHF1ZXVlZAogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNhZnRlckJhdGNoIEZpcmVzIGFmdGVyIHRoZSBiYXRjaCBpcyBxdWV1ZWQKICogQGZpcmVzIGtlaWdhaS5EYXRhU3RvcmUjZmFpbGVkQmF0Y2ggRmlyZXMgd2hlbiBhbiBleGNlcHRpb24gb2NjdXJzCiAqIEBleGFtcGxlCiAqIHN0b3JlLmJhdGNoKCAic2V0IiwgWy4uLl0gKS50aGVuKCBmdW5jdGlvbiAoIHJlY29yZHMgKSB7CiAqICAgLi4uCiAqIH0sIGZ1bmN0aW9uICggZXJyICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLmJhdGNoID0gZnVuY3Rpb24gKCB0eXBlLCBkYXRhLCBzeW5jICkgewoJc3luYyAgICAgICAgICA9ICggc3luYyA9PT0gdHJ1ZSApOwoJdmFyIHNlbGYgICAgICA9IHRoaXMsCgkgICAgZXZlbnRzICAgID0gdGhpcy5ldmVudHMsCgkgICAgZGVmZXIgICAgID0gZGVmZXJyZWQuZmFjdG9yeSgpLAoJICAgIGRlZmVycmVkcyA9IFtdOwoKCWlmICggIXJlZ2V4LnNldF9kZWwudGVzdCggdHlwZSApIHx8ICggc3luYyAmJiByZWdleC5kZWwudGVzdCggdHlwZSApICkgfHwgdHlwZW9mIGRhdGEgIT0gIm9iamVjdCIgKSB7CgkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKSApOwoJfQoJZWxzZSB7CgkJaWYgKCBldmVudHMgKSB7CgkJCXRoaXMuZGlzcGF0Y2goICJiZWZvcmVCYXRjaCIsIGRhdGEgKTsKCQl9CgoJCWlmICggc3luYyApIHsKCQkJdGhpcy5jbGVhciggc3luYyApOwoJCX0KCgkJaWYgKCBkYXRhLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy5sb2FkZWQgPSB0cnVlOwoKCQkJaWYgKCBldmVudHMgKSB7CgkJCQl0aGlzLmRpc3BhdGNoKCAiYWZ0ZXJCYXRjaCIsIHRoaXMucmVjb3JkcyApOwoJCQl9CgoJCQlkZWZlci5yZXNvbHZlKCB0aGlzLnJlY29yZHMgKTsKCQl9CgkJZWxzZSB7CgkJCS8vIEJhdGNoIGRlbGV0aW9uIHdpbGwgY3JlYXRlIGEgc3BhcnNlIGFycmF5LCB3aGljaCB3aWxsIGJlIGNvbXBhY3RlZCBiZWZvcmUgcmUtaW5kZXhpbmcKCQkJaWYgKCB0eXBlID09PSAiZGVsIiApIHsKCQkJCWFycmF5LmVhY2goIGRhdGEsIGZ1bmN0aW9uICggaSApIHsKCQkJCQlkZWZlcnJlZHMucHVzaCggc2VsZi5kZWwoIGksIGZhbHNlLCB0cnVlICkgKTsKCQkJCX0gKTsKCQkJfQoJCQllbHNlIHsKCQkJCWFycmF5LmVhY2goIGRhdGEsIGZ1bmN0aW9uICggaSApIHsKCQkJCQlkZWZlcnJlZHMucHVzaCggc2VsZi5zZXQoIG51bGwsIGksIHRydWUgKSApOwoJCQkJfSApOwoJCQl9CgoJCQl0aGlzLmxvYWRlZCA9IGZhbHNlOwoKCQkJdXRpbGl0eS53aGVuKCBkZWZlcnJlZHMgKS50aGVuKCBmdW5jdGlvbiAoIGFyZ3MgKSB7CgkJCQlzZWxmLmxvYWRlZCA9IHRydWU7CgoJCQkJaWYgKCBldmVudHMgKSB7CgkJCQkJc2VsZi5kaXNwYXRjaCggImFmdGVyQmF0Y2giLCBhcmdzICk7CgkJCQl9CgoJCQkJLy8gRm9yY2luZyBhIGNsZWFyIG9mIHZpZXdzIHRvIGRlYWwgd2l0aCBhc3luYyBuYXR1cmUgb2Ygd29ya2VycyAmIHN0YWdnZXJlZCBsb2FkaW5nCgkJCQlhcnJheS5lYWNoKCBzZWxmLmxpc3RzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJaS5yZWZyZXNoKCB0cnVlICk7CgkJCQl9ICk7CgoJCQkJaWYgKCB0eXBlID09PSAiZGVsIiApIHsKCQkJCQlzZWxmLnJlY29yZHMgPSBhcnJheS5jb21wYWN0KCBzZWxmLnJlY29yZHMgKTsKCQkJCQlzZWxmLnJlaW5kZXgoKTsKCQkJCX0KCgkJCQlpZiAoIHNlbGYuYXV0b3NhdmUgKSB7CgkJCQkJc2VsZi5zYXZlKCk7CgkJCQl9CgoJCQkJZGVmZXIucmVzb2x2ZSggYXJncyApOwoJCQl9LCBmdW5jdGlvbiAoIGUgKSB7CgkJCQlpZiAoIGV2ZW50cyApIHsKCQkJCQlzZWxmLmRpc3BhdGNoKCAiZmFpbGVkQmF0Y2giLCBlICk7CgkJCQl9CgoJCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJCX0gKTsKCQl9Cgl9CgoJcmV0dXJuIGRlZmVyOwp9OwoKLyoqCiAqIEJ1aWxkcyBhIFVSSQogKgogKiBAbWV0aG9kIGJ1aWxkVXJpCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge1N0cmluZ30ga2V5IFJlY29yZCBrZXkKICogQHJldHVybiB7U3RyaW5nfSAgICAgVVJJCiAqIEBleGFtcGxlCiAqIHZhciB1cmkgPSBzdG9yZS5idWlsZFVyaSggImtleSIgKTsKICovCkRhdGFTdG9yZS5wcm90b3R5cGUuYnVpbGRVcmkgPSBmdW5jdGlvbiAoIGtleSApIHsKCXZhciBwYXJzZWQgPSB1dGlsaXR5LnBhcnNlKCB0aGlzLnVyaSApOwoKCXJldHVybiBwYXJzZWQucHJvdG9jb2wgKyAiLy8iICsgcGFyc2VkLmhvc3QgKyBwYXJzZWQucGF0aG5hbWUgKyAoIHJlZ2V4LmVuZHNsYXNoLnRlc3QoIHBhcnNlZC5wYXRobmFtZSApID8gIiIgOiAiLyIgKSArIGtleTsKfTsKCi8qKgogKiBDbGVhcnMgdGhlIGRhdGEgb2JqZWN0LCB1bnNldHMgdGhlIHVyaSBwcm9wZXJ0eQogKgogKiBAbWV0aG9kIGNsZWFyCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge0Jvb2xlYW59IHN5bmMgW09wdGlvbmFsXSBCb29sZWFuIHRvIGxpbWl0IGNsZWFyaW5nIG9mIHByb3BlcnRpZXMKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRhdGFTdG9yZX0KICogQGZpcmVzIGtlaWdhaS5EYXRhU3RvcmUjYmVmb3JlQ2xlYXIgRmlyZXMgYmVmb3JlIHRoZSBkYXRhIGlzIGNsZWFyZWQKICogQGZpcmVzIGtlaWdhaS5EYXRhU3RvcmUjYWZ0ZXJDbGVhciBGaXJlcyBhZnRlciB0aGUgZGF0YSBpcyBjbGVhcmVkCiAqIEBleGFtcGxlCiAqIC8vIFJlc3luY2luZyB0aGUgcmVjb3JkcywgaWYgd2lyZWQgdG8gYW4gQVBJCiAqIHN0b3JlLmNsZWFyKCB0cnVlICk7CiAqCiAqIC8vIFJlc2V0dGluZyB0aGUgc3RvcmUKICogc3RvcmUuY2xlYXIoKTsKICovCkRhdGFTdG9yZS5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbiAoIHN5bmMgKSB7CglzeW5jICAgICAgID0gKCBzeW5jID09PSB0cnVlICk7Cgl2YXIgZXZlbnRzID0gKCB0aGlzLmV2ZW50cyA9PT0gdHJ1ZSApLAoJICAgIHJlc2F2ZSA9ICggdGhpcy5hdXRvc2F2ZSA9PT0gdHJ1ZSApOwoKCWlmICggIXN5bmMgKSB7CgkJaWYgKCBldmVudHMgKSB7CgkJCXRoaXMuZGlzcGF0Y2goICJiZWZvcmVDbGVhciIgKTsKCQl9CgoJCWFycmF5LmVhY2goIHRoaXMubGlzdHMsIGZ1bmN0aW9uICggaSApIHsKCQkJaWYgKCBpICkgewoJCQkJaS50ZWFyZG93biggdHJ1ZSApOwoJCQl9CgkJfSApOwoKCQl0aGlzLmF1dG9zYXZlICAgID0gZmFsc2U7CgkJdGhpcy5jYWxsYmFjayAgICA9IG51bGw7CgkJdGhpcy5jcmVkZW50aWFscyA9IG51bGw7CgkJdGhpcy5saXN0cyAgICAgICA9IFtdOwoJCXRoaXMuZXZlbnRzICAgICAgPSB0cnVlOwoJCXRoaXMuZXhwaXJlcyAgICAgPSBudWxsOwoJCXRoaXMuaGVhZGVycyAgICAgPSB7QWNjZXB0OiAiYXBwbGljYXRpb24vanNvbiJ9OwoJCXRoaXMuaWdub3JlICAgICAgPSBbXTsKCQl0aGlzLmluZGV4ICAgICAgID0gW107CgkJdGhpcy5pbmRleGVzICAgICA9IHtrZXk6IHt9fTsKCQl0aGlzLmtleSAgICAgICAgID0gbnVsbDsKCQl0aGlzLmxvYWRlZCAgICAgID0gZmFsc2U7CgkJdGhpcy5yZWNvcmRzICAgICA9IFtdOwoJCXRoaXMuc291cmNlICAgICAgPSBudWxsOwoJCXRoaXMudG90YWwgICAgICAgPSAwOwoJCXRoaXMudmVyc2lvbnMgICAgPSB7fTsKCQl0aGlzLnZlcnNpb25pbmcgID0gdHJ1ZTsKCQl0aGlzLnZpZXdzICAgICAgID0ge307CgkJdGhpcy51cmkgICAgICAgICA9IG51bGw7CgoJCWlmICggZXZlbnRzICkgewoJCQl0aGlzLmRpc3BhdGNoKCAiYWZ0ZXJDbGVhciIgKTsKCQl9Cgl9CgllbHNlIHsKCQl0aGlzLmluZGV4ZXMgICAgID0ge2tleToge319OwoJCXRoaXMubG9hZGVkICAgICAgPSBmYWxzZTsKCQl0aGlzLnJlY29yZHMgICAgID0gW107CgkJdGhpcy50b3RhbCAgICAgICA9IDA7CgkJdGhpcy52aWV3cyAgICAgICA9IHt9OwoKCQlhcnJheS5lYWNoKCB0aGlzLmxpc3RzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCWlmICggaSApIHsKCQkJCWkucmVmcmVzaCgpOwoJCQl9CgkJfSApOwoJfQoKCWlmICggcmVzYXZlICkgewoJCXRoaXMuc2F2ZSgpOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIERlbGV0ZXMgYSByZWNvcmQgYmFzZWQgb24ga2V5IG9yIGluZGV4CiAqCiAqIEBtZXRob2QgZGVsCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge01peGVkfSAgIHJlY29yZCAgUmVjb3JkLCBrZXkgb3IgaW5kZXgKICogQHBhcmFtICB7Qm9vbGVhbn0gcmVpbmRleCBbT3B0aW9uYWxdIGB0cnVlYCBpZiBEYXRhU3RvcmUgc2hvdWxkIGJlIHJlaW5kZXhlZAogKiBAcGFyYW0gIHtCb29sZWFufSBiYXRjaCAgIFtPcHRpb25hbF0gYHRydWVgIGlmIHBhcnQgb2YgYSBiYXRjaCBvcGVyYXRpb24KICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNiZWZvcmVEZWxldGUgRmlyZXMgYmVmb3JlIHRoZSByZWNvcmQgaXMgZGVsZXRlZAogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNhZnRlckRlbGV0ZSBGaXJlcyBhZnRlciB0aGUgcmVjb3JkIGlzIGRlbGV0ZWQKICogQGZpcmVzIGtlaWdhaS5EYXRhU3RvcmUjZmFpbGVkRGVsZXRlIEZpcmVzIGlmIHRoZSBzdG9yZSBpcyBSRVNUZnVsIGFuZCB0aGUgYWN0aW9uIGlzIGRlbmllZAogKiBAZXhhbXBsZQogKiBzdG9yZS5kZWwoICJrZXkiICkudGhlbiggZnVuY3Rpb24gKCkgewogKiAgIGNvbnNvbGUubG9nKCAiU3VjY2Vzc2Z1bGx5IGRlbGV0ZWQgIiArIGtleSApOwogKiB9LCBmdW5jdGlvbiAoIGVyciApIHsKICogICBjb25zb2xlLndhcm4oICJGYWlsZWQgdG8gZGVsZXRlICIgKyBrZXkgKyAiOiAiICsgZXJyLm1lc3NhZ2UgKTsKICogfSApOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5kZWwgPSBmdW5jdGlvbiAoIHJlY29yZCwgcmVpbmRleCwgYmF0Y2ggKSB7CglyZWNvcmQgICAgPSByZWNvcmQua2V5ID8gcmVjb3JkIDogdGhpcy5nZXQgKCByZWNvcmQgKTsKCXJlaW5kZXggICA9ICggcmVpbmRleCAhPT0gZmFsc2UgKTsKCWJhdGNoICAgICA9ICggYmF0Y2ggPT09IHRydWUgKTsKCXZhciBzZWxmICA9IHRoaXMsCgkgICAgZGVmZXIgPSBkZWZlcnJlZC5mYWN0b3J5KCk7CgoJaWYgKCByZWNvcmQgPT09IHVuZGVmaW5lZCApIHsKCQlkZWZlci5yZWplY3QoIG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApICk7Cgl9CgllbHNlIHsKCQlpZiAoIHRoaXMuZXZlbnRzICkgewoJCQlzZWxmLmRpc3BhdGNoKCAiYmVmb3JlRGVsZXRlIiwgcmVjb3JkICk7CgkJfQoKCQlpZiAoIHRoaXMudXJpID09PSBudWxsIHx8IHRoaXMuY2FsbGJhY2sgIT09IG51bGwgKSB7CgkJCXRoaXMuZGVsQ29tcGxldGUoIHJlY29yZCwgcmVpbmRleCwgYmF0Y2gsIGRlZmVyICk7CgkJfQoJCWVsc2UgewoJCQljbGllbnQucmVxdWVzdCggdGhpcy5idWlsZFVyaSggcmVjb3JkLmtleSApLCAiREVMRVRFIiwgbnVsbCwgdXRpbGl0eS5tZXJnZSgge3dpdGhDcmVkZW50aWFsczogdGhpcy5jcmVkZW50aWFsc30sIHRoaXMuaGVhZGVycyApICkudGhlbiggZnVuY3Rpb24gKCkgewoJCQkJc2VsZi5kZWxDb21wbGV0ZSggcmVjb3JkLCByZWluZGV4LCBiYXRjaCwgZGVmZXIgKTsKCQkJfSwgZnVuY3Rpb24gKCBlICkgewoJCQkJc2VsZi5kaXNwYXRjaCggImZhaWxlZERlbGV0ZSIsIGUgKTsKCQkJCWRlZmVyLnJlamVjdCggZSApOwoJCQl9ICk7CgkJfQoJfQoKCXJldHVybiBkZWZlcjsKfTsKCi8qKgogKiBEZWxldGUgY29tcGxldGlvbgogKgogKiBAbWV0aG9kIGRlbENvbXBsZXRlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge09iamVjdH0gIHJlY29yZCAgRGF0YVN0b3JlIHJlY29yZAogKiBAcGFyYW0gIHtCb29sZWFufSByZWluZGV4IGB0cnVlYCBpZiBEYXRhU3RvcmUgc2hvdWxkIGJlIHJlaW5kZXhlZAogKiBAcGFyYW0gIHtCb29sZWFufSBiYXRjaCAgIGB0cnVlYCBpZiBwYXJ0IG9mIGEgYmF0Y2ggb3BlcmF0aW9uCiAqIEBwYXJhbSAge09iamVjdH0gIGRlZmVyICAgRGVmZXJyZWQgaW5zdGFuY2UKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRhdGFTdG9yZX0KICogQHByaXZhdGUKICovCkRhdGFTdG9yZS5wcm90b3R5cGUuZGVsQ29tcGxldGUgPSBmdW5jdGlvbiAoIHJlY29yZCwgcmVpbmRleCwgYmF0Y2gsIGRlZmVyICkgewoJdmFyIHNlbGYgPSB0aGlzOwoKCWRlbGV0ZSB0aGlzLmluZGV4ZXMua2V5W3JlY29yZC5rZXldOwoJZGVsZXRlIHRoaXMudmVyc2lvbnNbcmVjb3JkLmtleV07CgoJdGhpcy50b3RhbC0tOwoJdGhpcy52aWV3cyA9IHt9OwoKCWlmICggIWJhdGNoICkgewoJCWFycmF5LnJlbW92ZSggdGhpcy5yZWNvcmRzLCByZWNvcmQuaW5kZXggKTsKCgkJaWYgKCByZWluZGV4ICkgewoJCQl0aGlzLnJlaW5kZXgoKTsKCQl9CgkJZWxzZSB7CgkJCWFycmF5LmVhY2goIHJlY29yZC5pbmRleGVzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCQlhcnJheS5yZW1vdmUoIHNlbGYuaW5kZXhlc1tpWzBdXVtpWzFdXSwgcmVjb3JkLmluZGV4ICk7CgoJCQkJaWYgKCBzZWxmLmluZGV4ZXNbaVswXV1baVsxXV0ubGVuZ3RoID09PSAwICkgewoJCQkJCWRlbGV0ZSBzZWxmLmluZGV4ZXNbaVswXV1baVsxXV07CgkJCQl9CgkJCX0gKTsKCQl9CgoJCWlmICggdGhpcy5hdXRvc2F2ZSApIHsKCQkJdGhpcy5wdXJnZSggcmVjb3JkLmtleSApOwoJCX0KCgkJaWYgKCB0aGlzLmV2ZW50cyApIHsKCQkJdGhpcy5kaXNwYXRjaCggImFmdGVyRGVsZXRlIiwgcmVjb3JkICk7CgkJfQoKCQlhcnJheS5lYWNoKCB0aGlzLmxpc3RzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCWkucmVmcmVzaCgpOwoJCX0gKTsKCX0KCWVsc2UgewoJCXRoaXMucmVjb3Jkc1tyZWNvcmQuaW5kZXhdID0gbnVsbDsKCX0KCglyZXR1cm4gZGVmZXIucmVzb2x2ZSggcmVjb3JkLmtleSApOwp9OwoKLyoqCiAqIEV4cG9ydHMgYSBzdWJzZXQgb3IgY29tcGxldGUgcmVjb3JkIHNldCBvZiBEYXRhU3RvcmUKICoKICogQG1ldGhvZCBkdW1wCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge0FycmF5fSBhcmdzICAgW09wdGlvbmFsXSBTdWItZGF0YSBzZXQgb2YgRGF0YVN0b3JlCiAqIEBwYXJhbSAge0FycmF5fSBmaWVsZHMgW09wdGlvbmFsXSBGaWVsZHMgdG8gZXhwb3J0LCBkZWZhdWx0cyB0byBhbGwKICogQHJldHVybiB7QXJyYXl9ICAgICAgICBSZWNvcmRzCiAqIEBleGFtcGxlCiAqIHZhciBkYXRhID0gc3RvcmUuZHVtcCgpOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5kdW1wID0gZnVuY3Rpb24gKCBhcmdzLCBmaWVsZHMgKSB7CglhcmdzICAgICAgID0gYXJncyB8fCB0aGlzLnJlY29yZHM7Cgl2YXIgc2VsZiAgID0gdGhpcywKCSAgICBjdXN0b20gPSAoIGZpZWxkcyBpbnN0YW5jZW9mIEFycmF5ICYmIGZpZWxkcy5sZW5ndGggPiAwICksCgkgICAga2V5ICAgID0gdGhpcy5rZXkgIT09IG51bGwsCgkgICAgZm47CgoJaWYgKCBjdXN0b20gKSB7CgkJZm4gPSBmdW5jdGlvbiAoIGkgKSB7CgkJCXZhciByZWNvcmQgPSB7fTsKCgkJCWFycmF5LmVhY2goIGZpZWxkcywgZnVuY3Rpb24gKCBmICkgewoJCQkJcmVjb3JkW2ZdID0gZiA9PT0gc2VsZi5rZXkgPyAoIGlzTmFOKCBpLmtleSApID8gaS5rZXkgOiBOdW1iZXIoIGkua2V5ICkgKSA6IHV0aWxpdHkuY2xvbmUoIGkuZGF0YVtmXSwgdHJ1ZSApOwoJCQl9ICk7CgoJCQlyZXR1cm4gcmVjb3JkOwoJCX07Cgl9CgllbHNlIHsKCQlmbiA9IGZ1bmN0aW9uICggaSApIHsKCQkJdmFyIHJlY29yZCA9IHt9OwoKCQkJaWYgKCBrZXkgKSB7CgkJCQlyZWNvcmRbc2VsZi5rZXldID0gaXNOYU4oIGkua2V5ICkgPyBpLmtleSA6IE51bWJlciggaS5rZXkgKTsKCQkJfQoKCQkJdXRpbGl0eS5pdGVyYXRlKCBpLmRhdGEsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCXJlY29yZFtrXSA9IHV0aWxpdHkuY2xvbmUoIHYsIHRydWUgKTsKCQkJfSApOwoKCQkJcmV0dXJuIHJlY29yZDsKCQl9OwoJfQoKCXJldHVybiBhcmdzLm1hcCggZm4gKTsKfTsKCi8qKgogKiBSZXRyaWV2ZXMgdGhlIGN1cnJlbnQgdmVyc2lvbiBvZiBhIHJlY29yZChzKSBiYXNlZCBvbiBrZXkgb3IgaW5kZXgKICoKICogSWYgdGhlIGtleSBpcyBhbiBpbnRlZ2VyLCBjYXN0IHRvIGEgc3RyaW5nIGJlZm9yZSBzZW5kaW5nIGFzIGFuIGFyZ3VtZW50IQogKgogKiBAbWV0aG9kIGdldAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFTdG9yZQogKiBAcGFyYW0gIHtNaXhlZH0gIHJlY29yZCBLZXksIGluZGV4IG9yIEFycmF5IG9mIHBhZ2luYXRpb24gc3RhcnQgJiBlbmQ7IG9yIGNvbW1hIGRlbGltaXRlZCBTdHJpbmcgb2Yga2V5cyBvciBpbmRpY2VzCiAqIEBwYXJhbSAge051bWJlcn0gb2Zmc2V0IFtPcHRpb25hbF0gT2Zmc2V0IGZyb20gYHJlY29yZGAgZm9yIHBhZ2luYXRpb24KICogQHJldHVybiB7TWl4ZWR9ICAgICAgICAgSW5kaXZpZHVhbCByZWNvcmQsIG9yIEFycmF5IG9mIHJlY29yZHMKICogQGV4YW1wbGUKICogdmFyIHJlY29yZCA9IHN0b3JlLmdldCggImtleSIgKTsKICovCkRhdGFTdG9yZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKCByZWNvcmQsIG9mZnNldCApIHsKCXZhciB0eXBlID0gdHlwZW9mIHJlY29yZCwKCSAgICBzZWxmID0gdGhpcywKCSAgICByZXN1bHQ7CgoJaWYgKCB0eXBlID09PSAidW5kZWZpbmVkIiApIHsKCQlyZXN1bHQgPSB0aGlzLnJlY29yZHM7Cgl9CgllbHNlIGlmICggdHlwZSA9PT0gInN0cmluZyIgKSB7CgkJaWYgKCByZWNvcmQuaW5kZXhPZiggIiwiICkgPT09IC0xICkgewoJCQlyZXN1bHQgPSB0aGlzLnJlY29yZHNbdGhpcy5pbmRleGVzLmtleVtyZWNvcmRdXTsKCQl9CgkJZWxzZSB7CgkJCXJlc3VsdCA9IHN0cmluZy5leHBsb2RlKCByZWNvcmQgKS5tYXAoIGZ1bmN0aW9uICggaSApIHsKCQkJCWlmICggIWlzTmFOKCBpICkgKSB7CgkJCQkJcmV0dXJuIHNlbGYucmVjb3Jkc1twYXJzZUludCggaSwgMTAgKV07CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlyZXR1cm4gc2VsZi5yZWNvcmRzW3NlbGYuaW5kZXhlcy5rZXlbaV1dOwoJCQkJfQoJCQl9ICk7CgkJfQoJfQoJZWxzZSBpZiAoIHR5cGUgPT09ICJudW1iZXIiICkgewoJCWlmICggaXNOYU4oIG9mZnNldCApICkgewoJCQlyZXN1bHQgPSB0aGlzLnJlY29yZHNbcGFyc2VJbnQoIHJlY29yZCwgMTAgKV07CgkJfQoJCWVsc2UgewoJCQlyZXN1bHQgPSBhcnJheS5saW1pdCggdGhpcy5yZWNvcmRzLCBwYXJzZUludCggcmVjb3JkLCAxMCApLCBwYXJzZUludCggb2Zmc2V0LCAxMCApICk7CgkJfQoJfQoKCXJldHVybiB1dGlsaXR5LmNsb25lKCByZXN1bHQsIHRydWUgKTsKfSwKCi8qKgogKiBQZXJmb3JtcyBhbiAoSU5ORVIvTEVGVC9SSUdIVCkgSk9JTiBvbiB0d28gRGF0YVN0b3JlcwogKgogKiBAbWV0aG9kIGpvaW4KICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7U3RyaW5nfSBhcmcgICBEYXRhU3RvcmUgdG8gam9pbgogKiBAcGFyYW0gIHtTdHJpbmd9IGZpZWxkIEZpZWxkIGluIGJvdGggRGF0YVN0b3JlcwogKiBAcGFyYW0gIHtTdHJpbmd9IGpvaW4gIFR5cGUgb2YgSk9JTiB0byBwZXJmb3JtLCBkZWZhdWx0cyB0byBgaW5uZXJgCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EZWZlcnJlZH0KICogdmFyIGRhdGEgPSBzdG9yZS5qb2luKCBvdGhlclN0b3JlLCAiY29tbW9uRmllbGQiICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLmpvaW4gPSBmdW5jdGlvbiAoIGFyZywgZmllbGQsIGpvaW4gKSB7Cglqb2luICAgICAgICAgID0gam9pbiB8fCAiaW5uZXIiOwoJdmFyIHNlbGYgICAgICA9IHRoaXMsCgkgICAgZGVmZXIgICAgID0gZGVmZXJyZWQuZmFjdG9yeSgpLAoJICAgIHJlc3VsdHMgICA9IFtdLAoJICAgIGRlZmVycmVkcyA9IFtdLAoJICAgIGtleSAgICAgICA9IGZpZWxkID09PSB0aGlzLmtleSwKCSAgICBrZXlzICAgICAgPSBhcnJheS5tZXJnZSggYXJyYXkua2V5cyggdGhpcy5yZWNvcmRzWzBdLmRhdGEgKSwgYXJyYXkua2V5cyggYXJnLnJlY29yZHNbMF0uZGF0YSApICksCgkgICAgZm47CgoJaWYgKCBqb2luID09PSAiaW5uZXIiICkgewoJCWZuID0gZnVuY3Rpb24gKCBpICkgewoJCQl2YXIgd2hlcmUgID0ge30sCgkJCSAgICByZWNvcmQgPSBpLmRhdGEsCgkJCSAgICBkZWZlciAgPSBkZWZlcnJlZC5mYWN0b3J5KCk7CgoJCQl3aGVyZVtmaWVsZF0gPSBrZXkgPyBpLmtleSA6IHJlY29yZFtmaWVsZF07CgkJCQoJCQlhcmcuc2VsZWN0KCB3aGVyZSApLnRoZW4oIGZ1bmN0aW9uICggbWF0Y2ggKSB7CgkJCQlpZiAoIG1hdGNoLmxlbmd0aCA+IDIgKSB7CgkJCQkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmRhdGFiYXNlTW9yZVRoYW5PbmUgKSApOwoJCQkJfQoJCQkJZWxzZSBpZiAoIG1hdGNoLmxlbmd0aCA9PT0gMSApIHsKCQkJCQlyZXN1bHRzLnB1c2goIHV0aWxpdHkubWVyZ2UoIHJlY29yZCwgbWF0Y2hbMF0uZGF0YSApICk7CgkJCQkJZGVmZXIucmVzb2x2ZSggdHJ1ZSApOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJZGVmZXIucmVzb2x2ZSggZmFsc2UgKTsKCQkJCX0KCQkJfSApOwoKCQkJZGVmZXJyZWRzLnB1c2goIGRlZmVyICk7CgkJfTsKCX0KCWVsc2UgaWYgKCBqb2luID09PSAibGVmdCIgKSB7CgkJZm4gPSBmdW5jdGlvbiAoIGkgKSB7CgkJCXZhciB3aGVyZSAgPSB7fSwKCQkJCXJlY29yZCA9IGkuZGF0YSwKCQkJICAgIGRlZmVyICA9IGRlZmVycmVkLmZhY3RvcnkoKTsKCgkJCXdoZXJlW2ZpZWxkXSA9IGtleSA/IGkua2V5IDogcmVjb3JkW2ZpZWxkXTsKCgkJCWFyZy5zZWxlY3QoIHdoZXJlICkudGhlbiggZnVuY3Rpb24gKCBtYXRjaCApIHsKCQkJCWlmICggbWF0Y2gubGVuZ3RoID4gMiApIHsKCQkJCQlkZWZlci5yZWplY3QoIG5ldyBFcnJvciggbGFiZWwuZGF0YWJhc2VNb3JlVGhhbk9uZSApICk7CgkJCQl9CgkJCQllbHNlIGlmICggbWF0Y2gubGVuZ3RoID09PSAxICkgewoJCQkJCXJlc3VsdHMucHVzaCggdXRpbGl0eS5tZXJnZSggcmVjb3JkLCBtYXRjaFswXS5kYXRhICkgKTsKCQkJCQlkZWZlci5yZXNvbHZlKCB0cnVlICk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlhcnJheS5lYWNoKCBrZXlzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJCWlmICggcmVjb3JkW2ldID09PSB1bmRlZmluZWQgKSB7CgkJCQkJCQlyZWNvcmRbaV0gPSBudWxsOwoJCQkJCQl9CgkJCQkJfSApOwoKCQkJCQlyZXN1bHRzLnB1c2goIHJlY29yZCApOwoJCQkJCWRlZmVyLnJlc29sdmUoIHRydWUgKTsKCQkJCX0KCQkJfSApOwoKCQkJZGVmZXJyZWRzLnB1c2goIGRlZmVyICk7CgkJfTsKCX0KCWVsc2UgaWYgKCBqb2luID09PSAicmlnaHQiICkgewoJCWZuID0gZnVuY3Rpb24gKCBpICkgewoJCQl2YXIgd2hlcmUgID0ge30sCgkJCSAgICByZWNvcmQgPSBpLmRhdGEsCgkJCSAgICBkZWZlciAgPSBkZWZlcnJlZC5mYWN0b3J5KCk7CgoJCQl3aGVyZVtmaWVsZF0gPSBrZXkgPyBpLmtleSA6IHJlY29yZFtmaWVsZF07CgkJCQoJCQlzZWxmLnNlbGVjdCggd2hlcmUgKS50aGVuKCBmdW5jdGlvbiAoIG1hdGNoICkgewoJCQkJaWYgKCBtYXRjaC5sZW5ndGggPiAyICkgewoJCQkJCWRlZmVyLnJlamVjdCggbmV3IEVycm9yKCBsYWJlbC5kYXRhYmFzZU1vcmVUaGFuT25lICkgKTsKCQkJCX0KCQkJCWVsc2UgaWYgKCBtYXRjaC5sZW5ndGggPT09IDEgKSB7CgkJCQkJcmVzdWx0cy5wdXNoKCB1dGlsaXR5Lm1lcmdlKCByZWNvcmQsIG1hdGNoWzBdLmRhdGEgKSApOwoJCQkJCWRlZmVyLnJlc29sdmUoIHRydWUgKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWFycmF5LmVhY2goIGtleXMsIGZ1bmN0aW9uICggaSApIHsKCQkJCQkJaWYgKCByZWNvcmRbaV0gPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJCXJlY29yZFtpXSA9IG51bGw7CgkJCQkJCX0KCQkJCQl9ICk7CgoJCQkJCXJlc3VsdHMucHVzaCggcmVjb3JkICk7CgkJCQkJZGVmZXIucmVzb2x2ZSggdHJ1ZSApOwoJCQkJfQoJCQl9ICk7CgoJCQlkZWZlcnJlZHMucHVzaCggZGVmZXIgKTsKCQl9OwoJfQoKCWFycmF5LmVhY2goIHV0aWxpdHkuY2xvbmUoIGpvaW4gPT09ICJyaWdodCIgPyBhcmcucmVjb3JkcyA6IHRoaXMucmVjb3JkcywgdHJ1ZSApLCBmbiApOwoKCXV0aWxpdHkud2hlbiggZGVmZXJyZWRzICkudGhlbiggZnVuY3Rpb24gKCkgewoJCWRlZmVyLnJlc29sdmUoIHJlc3VsdHMgKTsKCX0sIGZ1bmN0aW9uICggZSApIHsKCQlkZWZlci5yZWplY3QoIGUgKTsKCX0gKTsKCQoJcmV0dXJuIGRlZmVyOwp9OwoKLyoqCiAqIFJldHJpZXZlcyBvbmx5IDEgZmllbGQvcHJvcGVydHkKICoKICogQG1ldGhvZCBvbmx5CiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge1N0cmluZ30gYXJnIEZpZWxkL3Byb3BlcnR5IHRvIHJldHJpZXZlCiAqIEByZXR1cm4ge0FycmF5fSAgICAgIEFycmF5IG9mIHZhbHVlcwogKiBAZXhhbXBsZQogKiB2YXIgYWdlcyA9IHN0b3JlLm9ubHkoICJhZ2UiICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLm9ubHkgPSBmdW5jdGlvbiAoIGFyZyApIHsKCWlmICggYXJnID09PSB0aGlzLmtleSApIHsKCQlyZXR1cm4gdGhpcy5yZWNvcmRzLm1hcCggZnVuY3Rpb24gKCBpICkgewoJCQlyZXR1cm4gaS5rZXk7CgkJfSApOwoJfQoJZWxzZSB7CgkJcmV0dXJuIHRoaXMucmVjb3Jkcy5tYXAoIGZ1bmN0aW9uICggaSApIHsKCQkJcmV0dXJuIGkuZGF0YVthcmddOwoJCX0gKTsKCX0KfTsKCi8qKgogKiBQdXJnZXMgRGF0YVN0b3JlIG9yIHJlY29yZCBmcm9tIHBlcnNpc3RhbnQgc3RvcmFnZQogKgogKiBAbWV0aG9kIHB1cmdlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge01peGVkfSBhcmcgIFtPcHRpb25hbF0gU3RyaW5nIG9yIE51bWJlciBmb3IgcmVjb3JkCiAqIEByZXR1cm4ge09iamVjdH0gICAgIFJlY29yZCBvciBzdG9yZQogKiBAZXhhbXBsZQogKiBzdG9yZS5wdXJnZSgpOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5wdXJnZSA9IGZ1bmN0aW9uICggYXJnICkgewoJcmV0dXJuIHRoaXMuc3RvcmFnZSggYXJnIHx8IHRoaXMsICJyZW1vdmUiICk7Cn07CgovKioKICogUmVpbmRleGVzIHRoZSBEYXRhU3RvcmUKICoKICogQG1ldGhvZCByZWluZGV4CiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhU3RvcmV9CiAqIEBleGFtcGxlCiAqIHN0b3JlLnJlaW5kZXgoKTsKICovCkRhdGFTdG9yZS5wcm90b3R5cGUucmVpbmRleCA9IGZ1bmN0aW9uICgpIHsKCXZhciBzZWxmID0gdGhpcywKCSAgICBpICAgID0gLTEsCgkgICAgdG1wICA9IFtdOwoKCXRoaXMudmlld3MgICA9IHt9OwoJdGhpcy5pbmRleGVzID0ge2tleToge319OwoKCWlmICggdGhpcy50b3RhbCA+IDAgKSB7CgkJYXJyYXkuZWFjaCggdGhpcy5yZWNvcmRzLCBmdW5jdGlvbiAoIHJlY29yZCApIHsKCQkJaWYgKCByZWNvcmQgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRtcFsrK2ldICAgICA9IHJlY29yZDsKCQkJCXJlY29yZC5pbmRleCA9IGk7CgkJCQlzZWxmLmluZGV4ZXMua2V5W3JlY29yZC5rZXldID0gaTsKCQkJCXNlbGYuc2V0SW5kZXhlcyggcmVjb3JkICk7CgkJCX0KCQl9ICk7Cgl9CgoJdGhpcy5yZWNvcmRzID0gdG1wOwoKCXJldHVybiB0aGlzOwp9OwoKLyoqCiAqIFJlc3RvcmVzIERhdGFTdG9yZSBvciByZWNvcmQgcGVyc2lzdGFudCBzdG9yYWdlCiAqCiAqIEBtZXRob2QgcmVzdG9yZQogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFTdG9yZQogKiBAcGFyYW0gIHtNaXhlZH0gYXJnICBbT3B0aW9uYWxdIFN0cmluZyBvciBOdW1iZXIgZm9yIHJlY29yZAogKiBAcmV0dXJuIHtPYmplY3R9ICAgICBSZWNvcmQgb3Igc3RvcmUKICogQGV4YW1wbGUKICogc3RvcmUucmVzdG9yZSgpOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5yZXN0b3JlID0gZnVuY3Rpb24gKCBhcmcgKSB7CglyZXR1cm4gdGhpcy5zdG9yYWdlKCBhcmcgfHwgdGhpcywgImdldCIgKTsKfTsKCi8qKgogKiBTYXZlcyBEYXRhU3RvcmUgb3IgcmVjb3JkIHRvIHBlcnNpc3RhbnQgc3RvcmFnZSwgb3Igc2Vzc2lvblN0b3JhZ2UKICoKICogQG1ldGhvZCBzYXZlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge01peGVkfSBhcmcgIFtPcHRpb25hbF0gU3RyaW5nIG9yIE51bWJlciBmb3IgcmVjb3JkCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EZWZlcnJlZH0KICogQGV4YW1wbGUKICogc3RvcmUuc2F2ZSgpOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5zYXZlID0gZnVuY3Rpb24gKCBhcmcgKSB7CglyZXR1cm4gdGhpcy5zdG9yYWdlKCBhcmcgfHwgdGhpcywgInNldCIgKTsKfTsKCi8qKgogKiBTZWxlY3RzIHJlY29yZHMgKG5vdCBieSByZWZlcmVuY2UpIGJhc2VkIG9uIGFuIGV4cGxpY2l0IGRlc2NyaXB0aW9uCiAqCiAqIEBtZXRob2Qgc2VsZWN0CiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge09iamVjdH0gd2hlcmUgT2JqZWN0IGRlc2NyaWJpbmcgdGhlIFdIRVJFIGNsYXVzZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGVmZXJyZWR9CiAqIEBleGFtcGxlCiAqIHZhciBhZHVsdHM7CiAqCiAqIHN0b3JlLnNlbGVjdCgge2FnZTogZnVuY3Rpb24gKCBpICkgeyByZXR1cm4gaSA+PSAyMTsgfSB9ICkudGhlbiggZnVuY3Rpb24gKCByZWNvcmRzICkgewogKiAgIGFkdWx0cyA9IHJlY29yZHM7CiAqIH0sIGZ1bmN0aW9uICggZXJyICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnNlbGVjdCA9IGZ1bmN0aW9uICggd2hlcmUgKSB7Cgl2YXIgc2VsZiAgICAgID0gdGhpcywKCSAgICBkZWZlciAgICAgPSBkZWZlcnJlZC5mYWN0b3J5KCksCgkgICAgZnVuY3Rpb25zID0gW10sCgkgICAgY2xhdXNlcywgY29uZCwgaW5kZXgsIHJlc3VsdCwgc29ydGVkLCB2YWx1ZXMsIHdvcmtlcjsKCglpZiAoICEoIHdoZXJlIGluc3RhbmNlb2YgT2JqZWN0ICkgKSB7CgkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKSApOwoJfQoJZWxzZSB7CgkJdXRpbGl0eS5pdGVyYXRlKCB3aGVyZSwgZnVuY3Rpb24gKCB2LCBrICkgewoJCQlpZiAoIHR5cGVvZiB2ID09ICJmdW5jdGlvbiIgKSB7CgkJCQl0aGlzW2tdID0gdi50b1N0cmluZygpOwoJCQkJZnVuY3Rpb25zLnB1c2goIGsgKTsKCQkJfQoJCX0gKTsKCgkJaWYgKCB3ZWJXb3JrZXIgKSB7CgkJCXRyeSB7CgkJCQl3b3JrZXIgPSB1dGlsaXR5LndvcmtlciggZGVmZXIgKTsKCQkJCXdvcmtlci5wb3N0TWVzc2FnZSgge2NtZDogInNlbGVjdCIsIGluZGV4ZXM6IHRoaXMuaW5kZXhlcywgcmVjb3JkczogdGhpcy5yZWNvcmRzLCB3aGVyZToganNvbi5lbmNvZGUoIHdoZXJlICksIGZ1bmN0aW9uczogZnVuY3Rpb25zfSApOwoJCQl9CgkJCWNhdGNoICggZSApIHsKCQkJCS8vIFByb2JhYmx5IElFMTAsIHdoaWNoIGRvZXNuJ3QgaGF2ZSB0aGUgY29ycmVjdCBzZWN1cml0eSBmbGFnIGZvciBsb2NhbCBsb2FkaW5nCgkJCQl3ZWJXb3JrZXIgPSBmYWxzZTsKCgkJCQl0aGlzLnNlbGVjdCggd2hlcmUgKS50aGVuKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCQlkZWZlci5yZXNvbHZlKCBhcmcgKTsKCQkJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCQlkZWZlci5yZWplY3QoIGUgKTsKCQkJCX0gKTsKCQkJfQoJCX0KCQllbHNlIHsKCQkJY2xhdXNlcyA9IGFycmF5LmZyb21PYmplY3QoIHdoZXJlICk7CgkJCXNvcnRlZCAgPSBhcnJheS5mbGF0KCBjbGF1c2VzICkuZmlsdGVyKCBmdW5jdGlvbiAoIGksIGlkeCApIHsgcmV0dXJuIGlkeCAlIDIgPT09IDA7IH0gKS5zb3J0KCBhcnJheS5zb3J0ICk7CgkJCWluZGV4ICAgPSBzb3J0ZWQuam9pbiggInwiICk7CgkJCXZhbHVlcyAgPSBzb3J0ZWQubWFwKCBmdW5jdGlvbiAoIGkgKSB7IHJldHVybiB3aGVyZVtpXTsgfSApLmpvaW4oICJ8IiApOwoJCQljb25kICAgID0gInJldHVybiAoICI7CgoJCQlpZiAoIGZ1bmN0aW9ucy5sZW5ndGggPT09IDAgJiYgdGhpcy5pbmRleGVzW2luZGV4XSApIHsKCQkJCXJlc3VsdCA9ICggdGhpcy5pbmRleGVzW2luZGV4XVt2YWx1ZXNdIHx8IFtdICkubWFwKCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJcmV0dXJuIHNlbGYucmVjb3Jkc1tpXTsKCQkJCX0gKTsKCQkJfQoJCQllbHNlIHsKCQkJCWlmICggY2xhdXNlcy5sZW5ndGggPiAxICkgewoJCQkJCWFycmF5LmVhY2goIGNsYXVzZXMsIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCQkJCQl2YXIgYjEgPSAiKCAiOwoKCQkJCQkJaWYgKCBpZHggPiAwICkgewoJCQkJCQkJYjEgPSAiICYmICggIjsKCQkJCQkJfQoKCQkJCQkJaWYgKCBpWzFdIGluc3RhbmNlb2YgRnVuY3Rpb24gKSB7CgkJCQkJCQljb25kICs9IGIxICsgaVsxXS50b1N0cmluZygpICsgIiggcmVjLmRhdGFbXCIiICsgaVswXSArICJcIl0gKSApIjsKCQkJCQkJfQoJCQkJCQllbHNlIGlmICggIWlzTmFOKCBpWzFdICkgKSB7CgkJCQkJCQljb25kICs9IGIxICsgInJlYy5kYXRhW1wiIiArIGlbMF0gKyAiXCJdID09PSAiICsgaVsxXSArICIgKSI7CgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCQljb25kICs9IGIxICsgInJlYy5kYXRhW1wiIiArIGlbMF0gKyAiXCJdID09PSBcIiIgKyBpWzFdICsgIlwiICkiOwoJCQkJCQl9CgkJCQkJfSApOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJaWYgKCBjbGF1c2VzWzBdWzFdIGluc3RhbmNlb2YgRnVuY3Rpb24gKSB7CgkJCQkJCWNvbmQgKz0gY2xhdXNlc1swXVsxXS50b1N0cmluZygpICsgIiggcmVjLmRhdGFbXCIiICsgY2xhdXNlc1swXVswXSArICJcIl0gKSI7CgkJCQkJfQoJCQkJCWVsc2UgaWYgKCAhaXNOYU4oIGNsYXVzZXNbMF1bMV0gKSApIHsKCQkJCQkJY29uZCArPSAicmVjLmRhdGFbXCIiICsgY2xhdXNlc1swXVswXSArICJcIl0gPT09ICIgKyBjbGF1c2VzWzBdWzFdOwoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJY29uZCArPSAicmVjLmRhdGFbXCIiICsgY2xhdXNlc1swXVswXSArICJcIl0gPT09IFwiIiArIGNsYXVzZXNbMF1bMV0gKyAiXCIiOwoJCQkJCX0KCQkJCX0KCgkJCQljb25kICs9ICIgKTsiOwoKCQkJCXJlc3VsdCA9IHV0aWxpdHkuY2xvbmUoIHRoaXMucmVjb3JkcywgdHJ1ZSApLmZpbHRlciggbmV3IEZ1bmN0aW9uKCAicmVjIiwgY29uZCApICk7CgkJCX0KCgkJCWRlZmVyLnJlc29sdmUoIHJlc3VsdCApOwoJCX0KCX0KCglyZXR1cm4gZGVmZXI7Cn07CgovKioKICogQ3JlYXRlcyBvciB1cGRhdGVzIGFuIGV4aXN0aW5nIHJlY29yZAogKgogKiBAbWV0aG9kIHNldAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFTdG9yZQogKiBAcGFyYW0gIHtNaXhlZH0gICBrZXkgICAgICAgW09wdGlvbmFsXSBJbnRlZ2VyIG9yIFN0cmluZyB0byB1c2UgYXMgYSBQcmltYXJ5IEtleQogKiBAcGFyYW0gIHtPYmplY3R9ICBkYXRhICAgICAgS2V5OlZhbHVlIHBhaXJzIHRvIHNldCBhcyBmaWVsZCB2YWx1ZXMKICogQHBhcmFtICB7Qm9vbGVhbn0gYmF0Y2ggICAgIFtPcHRpb25hbF0gVHJ1ZSBpZiBjYWxsZWQgYnkgZGF0YS5iYXRjaAogKiBAcGFyYW0gIHtCb29sZWFufSBvdmVyd3JpdGUgW09wdGlvbmFsXSBPdmVyd3JpdGVzIHRoZSBleGlzdGluZyByZWNvcmQsIGlmIGZvdW5kCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EZWZlcnJlZH0KICogQGZpcmVzIGtlaWdhaS5EYXRhU3RvcmUjYmVmb3JlU2V0IEZpcmVzIGJlZm9yZSB0aGUgcmVjb3JkIGlzIHNldAogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNhZnRlclNldCBGaXJlcyBhZnRlciB0aGUgcmVjb3JkIGlzIHNldCwgdGhlIHJlY29yZCBpcyB0aGUgYXJndW1lbnQgZm9yIGxpc3RlbmVycwogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNmYWlsZWRTZXQgRmlyZXMgaWYgdGhlIHN0b3JlIGlzIFJFU1RmdWwgYW5kIHRoZSBhY3Rpb24gaXMgZGVuaWVkCiAqIEBleGFtcGxlCiAqIC8vIENyZWF0aW5nIGEgbmV3IHJlY29yZAogKiBzdG9yZS5zZXQoIG51bGwsIHsuLi59ICk7CiAqCiAqIC8vIFVwZGF0aW5nIGEgcmVjb3JkCiAqIHN0b3JlLnNldCggImtleSIsIHsuLi59ICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uICgga2V5LCBkYXRhLCBiYXRjaCwgb3ZlcndyaXRlICkgewoJZGF0YSAgICAgICA9IHV0aWxpdHkuY2xvbmUoIGRhdGEsIHRydWUgKTsKCWJhdGNoICAgICAgPSAoIGJhdGNoID09PSB0cnVlICk7CglvdmVyd3JpdGUgID0gKCBvdmVyd3JpdGUgPT09IHRydWUgKTsKCXZhciBzZWxmICAgPSB0aGlzLAoJICAgIGV2ZW50cyA9IHRoaXMuZXZlbnRzLAoJICAgIGRlZmVyICA9IGRlZmVycmVkLmZhY3RvcnkoKSwKCSAgICByZWNvcmQgPSBrZXkgIT09IG51bGwgPyB0aGlzLmdldCgga2V5ICkgfHwgbnVsbCA6IGRhdGFbdGhpcy5rZXldID8gdGhpcy5nZXQoIGRhdGFbdGhpcy5rZXldICkgfHwgbnVsbCA6IG51bGwsCgkgICAgbWV0aG9kID0gIlBPU1QiLAoJICAgIHBhcnNlZCA9IHV0aWxpdHkucGFyc2UoIHNlbGYudXJpIHx8ICIiICksCgkgICAgdXJpLCBvZGF0YSwgcmRlZmVyOwoKCWZ1bmN0aW9uIHBhdGNoICggb3ZlcndyaXRlLCBkYXRhLCBvZ2RhdGEgKSB7CgkJdmFyIG5kYXRhID0gW107CgoJCWlmICggb3ZlcndyaXRlICkgewoJCQlhcnJheS5lYWNoKCBhcnJheS5rZXlzKCBvZ2RhdGEgKSwgZnVuY3Rpb24gKCBrICkgewoJCQkJaWYgKCBrICE9PSBzZWxmLmtleSAmJiBkYXRhW2tdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJbmRhdGEucHVzaCggeyBvcDogInJlbW92ZSIsIHBhdGg6ICIvIiArIGsgfSApOwoJCQkJfQoJCQl9ICk7CgkJfQoKCQl1dGlsaXR5Lml0ZXJhdGUoIGRhdGEsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJaWYgKCBrICE9PSBzZWxmLmtleSAmJiBvZ2RhdGFba10gPT09IHVuZGVmaW5lZCApIHsKCQkJCW5kYXRhLnB1c2goIHsgb3A6ICJhZGQiLCBwYXRoOiAiLyIgKyBrLCB2YWx1ZTogdiB9ICk7CgkJCX0KCQkJZWxzZSBpZiAoIGpzb24uZW5jb2RlKCBvZ2RhdGFba10gKSAhPT0ganNvbi5lbmNvZGUoIHYgKSApIHsKCQkJCW5kYXRhLnB1c2goIHsgb3A6ICJyZXBsYWNlIiwgcGF0aDogIi8iICsgaywgdmFsdWU6IHYgfSApOwoJCQl9CgkJfSApOwoKCQlyZXR1cm4gbmRhdGE7Cgl9CgoJaWYgKCB0eXBlb2YgZGF0YSA9PSAic3RyaW5nIiApIHsKCQlpZiAoIGRhdGEuaW5kZXhPZiggIi8vIiApID09PSAtMSApIHsKCQkJLy8gUmVsYXRpdmUgcGF0aCB0byBzdG9yZSwgaS5lLiBhIGNoaWxkCgkJCWlmICggZGF0YS5jaGFyQXQoIDAgKSAhPT0gIi8iICkgewoJCQkJdXJpID0gdGhpcy5idWlsZFVyaSggZGF0YSApOwoJCQl9CgkJCS8vIFJvb3QgcGF0aCwgcmVsYXRpdmUgdG8gc3RvcmUsIGkuZS4gYSBkb21haW4KCQkJZWxzZSBpZiAoIHNlbGYudXJpICE9PSBudWxsICYmIHJlZ2V4LnJvb3QudGVzdCggZGF0YSApICkgewoJCQkJdXJpID0gcGFyc2VkLnByb3RvY29sICsgIi8vIiArIHBhcnNlZC5ob3N0ICsgZGF0YTsKCQkJfQoJCQllbHNlIHsKCQkJCXVyaSA9IGRhdGE7CgkJCX0KCQl9CgkJZWxzZSB7CgkJCXVyaSA9IGRhdGE7CgkJfQoKCQlrZXkgPSB1cmkucmVwbGFjZSggcmVnZXgubm90X2VuZHBvaW50LCAiIiApOwoKCQlpZiAoIHN0cmluZy5pc0VtcHR5KCBrZXkgKSApIHsKCQkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKSApOwoJCX0KCQllbHNlIHsKCQkJaWYgKCAhYmF0Y2ggJiYgZXZlbnRzICkgewoJCQkJc2VsZi5kaXNwYXRjaCggImJlZm9yZVNldCIsIHtrZXk6IGtleSwgZGF0YTogZGF0YX0gKTsKCQkJfQoKCQkJY2xpZW50LnJlcXVlc3QoIHVyaSwgIkdFVCIsIG51bGwsIHV0aWxpdHkubWVyZ2UoIHt3aXRoQ3JlZGVudGlhbHM6IHNlbGYuY3JlZGVudGlhbHN9LCBzZWxmLmhlYWRlcnMgKSApLnRoZW4oIGZ1bmN0aW9uICggYXJnICkgewoJCQkJc2VsZi5zZXRDb21wbGV0ZSggcmVjb3JkLCBrZXksIHNlbGYuc291cmNlID8gdXRpbGl0eS53YWxrKCBhcmcsIHNlbGYuc291cmNlICkgOiBhcmcsIGJhdGNoLCBvdmVyd3JpdGUsIGRlZmVyICk7CgkJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCXNlbGYuZGlzcGF0Y2goICJmYWlsZWRTZXQiLCBlICk7CgkJCQlkZWZlci5yZWplY3QoIGUgKTsKCQkJfSApOwoJCX0KCX0KCWVsc2UgewoJCWlmICggIWJhdGNoICYmIGV2ZW50cyApIHsKCQkJc2VsZi5kaXNwYXRjaCggImJlZm9yZVNldCIsIHtrZXk6IGtleSwgZGF0YTogZGF0YX0gKTsKCQl9CgoJCWlmICggYmF0Y2ggfHwgdGhpcy51cmkgPT09IG51bGwgKSB7CgkJCXRoaXMuc2V0Q29tcGxldGUoIHJlY29yZCwga2V5LCBkYXRhLCBiYXRjaCwgb3ZlcndyaXRlLCBkZWZlciApOwoJCX0KCQllbHNlIHsKCQkJaWYgKCBrZXkgIT09IG51bGwgKSB7CgkJCQl1cmkgICAgPSB0aGlzLmJ1aWxkVXJpKCBrZXkgKTsKCQkJCW1ldGhvZCA9ICJQQVRDSCI7CgkJCQlvZGF0YSAgPSB1dGlsaXR5LmNsb25lKCBkYXRhLCB0cnVlICk7CgkJCQlkYXRhICAgPSBwYXRjaCggb3ZlcndyaXRlLCBkYXRhLCB0aGlzLmR1bXAoIFsgcmVjb3JkIF0gKVsgMCBdICk7CgkJCX0KCQkJZWxzZSB7CgkJCQkvLyBEcm9wcGluZyBxdWVyeSBzdHJpbmcKCQkJCXVyaSA9IHBhcnNlZC5wcm90b2NvbCArICIvLyIgKyBwYXJzZWQuaG9zdCArIHBhcnNlZC5wYXRobmFtZTsKCQkJfQoKCQkJcmRlZmVyID0gY2xpZW50LnJlcXVlc3QoIHVyaSwgbWV0aG9kLCBkYXRhLCB1dGlsaXR5Lm1lcmdlKCB7d2l0aENyZWRlbnRpYWxzOiB0aGlzLmNyZWRlbnRpYWxzfSwgdGhpcy5oZWFkZXJzICkgKTsKCQkJcmRlZmVyLnRoZW4oIGZ1bmN0aW9uICggYXJnICkgewoJCQkJdmFyIGNoYW5nZTsKCgkJCQlpZiAoIHJkZWZlci54aHIuc3RhdHVzICE9PSAyMDQgJiYgcmRlZmVyLnhoci5zdGF0dXMgPCAzMDAgKSB7CgkJCQkJY2hhbmdlID0ga2V5ID09PSBudWxsID8gKCBzZWxmLnNvdXJjZSA/IHV0aWxpdHkud2FsayggYXJnLCBzZWxmLnNvdXJjZSApIDogYXJnICkgOiBvZGF0YTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWNoYW5nZSA9IG9kYXRhOwoJCQkJfQoKCQkJCXNlbGYuc2V0Q29tcGxldGUoIHJlY29yZCwga2V5LCBjaGFuZ2UsIGJhdGNoLCBvdmVyd3JpdGUsIGRlZmVyICk7CgkJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCWlmICggbWV0aG9kID09ICJQQVRDSCIgKSB7CgkJCQkJbWV0aG9kID0gIlBVVCI7CgkJCQkJZGF0YSAgID0gdXRpbGl0eS5jbG9uZSggb2RhdGEsIHRydWUgKTsKCgkJCQkJdXRpbGl0eS5pdGVyYXRlKCByZWNvcmQuZGF0YSwgZnVuY3Rpb24gKCB2LCBrICkgewoJCQkJCQlkYXRhW2tdID0gdjsKCQkJCQl9ICk7CgoJCQkJCWNsaWVudC5yZXF1ZXN0KCB1cmksIG1ldGhvZCwgZGF0YSwgdXRpbGl0eS5tZXJnZSgge3dpdGhDcmVkZW50aWFsczogc2VsZi5jcmVkZW50aWFsc30sIHNlbGYuaGVhZGVycyApICkudGhlbiggZnVuY3Rpb24gKCkgewoJCQkJCQlzZWxmLnNldENvbXBsZXRlKCByZWNvcmQsIGtleSwgb2RhdGEsIGJhdGNoLCBvdmVyd3JpdGUsIGRlZmVyICk7CgkJCQkJfSwgZnVuY3Rpb24gKCBlICkgewoJCQkJCQlzZWxmLmRpc3BhdGNoKCAiZmFpbGVkU2V0IiwgZSApOwoJCQkJCQlkZWZlci5yZWplY3QoIGUgKTsKCQkJCQl9ICk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlzZWxmLmRpc3BhdGNoKCAiZmFpbGVkU2V0IiwgZSApOwoJCQkJCWRlZmVyLnJlamVjdCggZSApOwoJCQkJfQoJCQl9ICk7CgkJfQoJfQoKCXJldHVybiBkZWZlcjsKfTsKCi8qKgogKiBTZXQgY29tcGxldGlvbgogKgogKiBAbWV0aG9kIHNldENvbXBsZXRlCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge01peGVkfSAgIHJlY29yZCAgICBEYXRhU3RvcmUgcmVjb3JkLCBvciBgbnVsbGAgaWYgbmV3CiAqIEBwYXJhbSAge1N0cmluZ30gIGtleSAgICAgICBSZWNvcmQga2V5CiAqIEBwYXJhbSAge09iamVjdH0gIGRhdGEgICAgICBSZWNvcmQgZGF0YQogKiBAcGFyYW0gIHtCb29sZWFufSBiYXRjaCAgICAgYHRydWVgIGlmIHBhcnQgb2YgYSBiYXRjaCBvcGVyYXRpb24KICogQHBhcmFtICB7Qm9vbGVhbn0gb3ZlcndyaXRlIE92ZXJ3cml0ZXMgdGhlIGV4aXN0aW5nIHJlY29yZCwgaWYgZm91bmQKICogQHBhcmFtICB7T2JqZWN0fSAgZGVmZXIgICAgIERlZmVycmVkIGluc3RhbmNlCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhU3RvcmV9CiAqIEBwcml2YXRlCiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnNldENvbXBsZXRlID0gZnVuY3Rpb24gKCByZWNvcmQsIGtleSwgZGF0YSwgYmF0Y2gsIG92ZXJ3cml0ZSwgZGVmZXIgKSB7CgkvLyBDbGVhcmluZyB2aWV3cwoJdGhpcy52aWV3cyA9IHt9OwoKCS8vIFNldHRpbmcga2V5CglpZiAoIGtleSA9PT0gbnVsbCApIHsKCQlpZiAoIHRoaXMua2V5ICE9PSBudWxsICYmIGRhdGFbdGhpcy5rZXldICE9PSB1bmRlZmluZWQgJiYgZGF0YVt0aGlzLmtleV0gIT09IG51bGwgKSB7CgkJCWtleSA9IGRhdGFbdGhpcy5rZXldLnRvU3RyaW5nKCk7CgkJfQoJCWVsc2UgewoJCQlrZXkgPSB1dGlsaXR5LnV1aWQoKTsKCQl9Cgl9CgoJLy8gUmVtb3ZpbmcgcHJpbWFyeSBrZXkgZnJvbSBkYXRhCglpZiAoIHRoaXMua2V5ICkgewoJCWRlbGV0ZSBkYXRhW3RoaXMua2V5XTsKCX0KCgkvLyBDcmVhdGUKCWlmICggcmVjb3JkID09PSBudWxsICkgewoJCXJlY29yZCA9IHsKCQkJaW5kZXggICA6IHRoaXMudG90YWwrKywKCQkJa2V5ICAgICA6IGtleSwKCQkJZGF0YSAgICA6IGRhdGEsCgkJCWluZGV4ZXMgOiBbXQoJCX07CgoJCXRoaXMuaW5kZXhlcy5rZXlba2V5XSAgICAgICAgID0gcmVjb3JkLmluZGV4OwoJCXRoaXMucmVjb3Jkc1tyZWNvcmQuaW5kZXhdICAgID0gcmVjb3JkOwoKCQlpZiAoIHRoaXMudmVyc2lvbmluZyApIHsKCQkJdGhpcy52ZXJzaW9uc1tyZWNvcmQua2V5XSA9IGxydS5mYWN0b3J5KCBWRVJTSU9OUyApOwoJCQl0aGlzLnZlcnNpb25zW3JlY29yZC5rZXldLm50aCA9IDA7CgkJfQoJfQoJLy8gVXBkYXRlCgllbHNlIHsKCQlpZiAoIHRoaXMudmVyc2lvbmluZyApIHsKCQkJaWYgKCB0aGlzLnZlcnNpb25zW3JlY29yZC5rZXldID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLnZlcnNpb25zW3JlY29yZC5rZXldICAgICA9IGxydS5mYWN0b3J5KCBWRVJTSU9OUyApOwoJCQkJdGhpcy52ZXJzaW9uc1tyZWNvcmQua2V5XS5udGggPSAwOwoJCQl9CgoJCQl0aGlzLnZlcnNpb25zW3JlY29yZC5rZXldLnNldCggInYiICsgKCArK3RoaXMudmVyc2lvbnNbcmVjb3JkLmtleV0ubnRoICksIHRoaXMuZHVtcCggW3JlY29yZF0gKVswXSApOwoJCX0KCgkJLy8gQnkgcmVmZXJlbmNlCgkJcmVjb3JkID0gdGhpcy5yZWNvcmRzW3JlY29yZC5pbmRleF07CgoJCWlmICggb3ZlcndyaXRlICkgewoJCQlyZWNvcmQuZGF0YSA9IHt9OwoJCX0KCgkJdXRpbGl0eS5pdGVyYXRlKCBkYXRhLCBmdW5jdGlvbiAoIHYsIGsgKSB7CgkJCXJlY29yZC5kYXRhW2tdID0gdjsKCQl9ICk7CgoJCS8vIFNuYXBzaG90IHRoYXQncyBzYWZlIHRvIGhhbmQgb3V0CgkJcmVjb3JkID0gdXRpbGl0eS5jbG9uZSggcmVjb3JkLCB0cnVlICk7Cgl9CgoJdGhpcy5zZXRJbmRleGVzKCByZWNvcmQgKTsKCglpZiAoICFiYXRjaCApIHsKCQlpZiAoIHRoaXMuYXV0b3NhdmUgKSB7CgkJCXRoaXMuc2F2ZSgpOwoJCX0KCgkJaWYgKCB0aGlzLmV2ZW50cyApIHsKCQkJdGhpcy5kaXNwYXRjaCggImFmdGVyU2V0IiwgcmVjb3JkICk7CgkJfQoKCQlhcnJheS5lYWNoKCB0aGlzLmxpc3RzLCBmdW5jdGlvbiAoIGkgKSB7CgkJCWkucmVmcmVzaCgpOwoJCX0gKTsKCX0KCglkZWZlci5yZXNvbHZlKCByZWNvcmQgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBHZXRzIG9yIHNldHMgYW4gZXhwbGljaXQgZXhwaXJhdGlvbiBvZiBkYXRhCiAqCiAqIEBtZXRob2Qgc2V0RXhwaXJlcwogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFTdG9yZQogKiBAcGFyYW0gIHtOdW1iZXJ9IGFyZyBNaWxsaXNlY29uZHMgdW50aWwgZGF0YSBpcyBzdGFsZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YVN0b3JlfQogKiBAZXhhbXBsZQogKiBzdG9yZS5zZXRFeHBpcmVzKCA1ICogNjAgKiAxMDAwICk7IC8vIFJlc3luY3MgZXZlcnkgNSBtaW51dGVzCiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnNldEV4cGlyZXMgPSBmdW5jdGlvbiAoIGFyZyApIHsKCXZhciBpZCAgICAgID0gdGhpcy5pZCArICJFeHBpcmUiLAoJICAgIGV4cGlyZXMgPSBhcmcsCgkgICAgc2VsZiAgICA9IHRoaXM7CgoJLy8gRXhwaXJ5IGNhbm5vdCBiZSBsZXNzIHRoYW4gYSBzZWNvbmQsIGFuZCBtdXN0IGJlIGEgdmFsaWQgc2NlbmFyaW8gZm9yIGNvbnN1bXB0aW9uOyBudWxsIHdpbGwgZGlzYWJsZSByZXBldGl0aXZlIGV4cGlyYXRpb24KCWlmICggKCBhcmcgIT09IG51bGwgJiYgdGhpcy51cmkgPT09IG51bGwgKSB8fCAoIGFyZyAhPT0gbnVsbCAmJiAoIGlzTmFOKCBhcmcgKSB8fCBhcmcgPCAxMDAwICkgKSApIHsKCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCX0KCglpZiAoIHRoaXMuZXhwaXJlcyA9PT0gYXJnICkgewoJCXJldHVybjsKCX0KCgl0aGlzLmV4cGlyZXMgPSBhcmc7CgoJdXRpbGl0eS5jbGVhclRpbWVycyggaWQgKTsKCglpZiAoIGFyZyA9PT0gbnVsbCApIHsKCQlyZXR1cm47Cgl9CgoJdXRpbGl0eS5yZXBlYXQoIGZ1bmN0aW9uICgpIHsKCQlpZiAoIHNlbGYudXJpID09PSBudWxsICkgewoJCQlzZWxmLnNldEV4cGlyZXMoIG51bGwgKTsKCgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXNlbGYuZGlzcGF0Y2goICJiZWZvcmVFeHBpcmUiKTsKCQljYWNoZS5leHBpcmUoIHNlbGYudXJpICk7CgkJc2VsZi5kaXNwYXRjaCggImV4cGlyZSIpOwoJCXNlbGYuZGlzcGF0Y2goICJhZnRlckV4cGlyZSIpOwoJfSwgZXhwaXJlcywgaWQsIGZhbHNlICk7Cn07CgovKioKICogU2V0cyBpbmRleGVzIGZvciBhIHJlY29yZCB1c2luZyBgc3RvcmUuaW5kZXhlc2AKICoKICogQ29tcG9zaXRlIGluZGV4ZXMgYXJlIHN1cHBvcnRlZCwgYnV0IHJlcXVpcmUga2V5cyBiZSBpbiBhbHBoYWJldGljYWwgb3JkZXIsIGUuZy4gImFnZXxuYW1lIgogKgogKiBAbWV0aG9kIHNldEluZGV4ZXMKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7T2JqZWN0fSBhcmcgRGF0YVN0b3JlIFJlY29yZAogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGF0YVN0b3JlfQogKiBAZXhhbXBsZQogKiBzdG9yZS5zZXRJbmRleGVzKCByZWNvcmQgKTsKICovCkRhdGFTdG9yZS5wcm90b3R5cGUuc2V0SW5kZXhlcyA9IGZ1bmN0aW9uICggYXJnICkgewoJdmFyIHNlbGYgICAgID0gdGhpcywKCSAgICBkZWxpbXRlciA9ICJ8IjsKCglhcmcuaW5kZXhlcyA9IFtdOwoKCWFycmF5LmVhY2goIHRoaXMuaW5kZXgsIGZ1bmN0aW9uICggaSApIHsKCQl2YXIga2V5cyAgID0gaS5zcGxpdCggZGVsaW10ZXIgKSwKCQkgICAgdmFsdWVzID0gIiI7CgoJCWlmICggc2VsZi5pbmRleGVzW2ldID09PSB1bmRlZmluZWQgKSB7CgkJCXNlbGYuaW5kZXhlc1tpXSA9IHt9OwoJCX0KCgkJYXJyYXkuZWFjaCgga2V5cywgZnVuY3Rpb24gKCBrLCBrZHggKSB7CgkJCXZhbHVlcyArPSAoIGtkeCA+IDAgPyBkZWxpbXRlciA6ICIiICkgKyBhcmcuZGF0YVtrXTsKCQl9ICk7CgoJCWlmICggc2VsZi5pbmRleGVzW2ldW3ZhbHVlc10gPT09IHVuZGVmaW5lZCApIHsKCQkJc2VsZi5pbmRleGVzW2ldW3ZhbHVlc10gPSBbXTsKCQl9CgoJCWlmICggIWFycmF5LmNvbnRhaW5zKCBzZWxmLmluZGV4ZXNbaV1bdmFsdWVzXSwgYXJnLmluZGV4ICkgKSB7CgkJCXNlbGYuaW5kZXhlc1tpXVt2YWx1ZXNdLnB1c2goIGFyZy5pbmRleCApOwoJCQlhcmcuaW5kZXhlcy5wdXNoKCBbaSwgdmFsdWVzXSApOwoJCX0KCX0gKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBTZXRzIHRoZSBSRVNUZnVsIEFQSSBlbmQgcG9pbnQKICoKICogQG1ldGhvZCBzZXRVcmkKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7U3RyaW5nfSBhcmcgQVBJIGNvbGxlY3Rpb24gZW5kIHBvaW50CiAqIEByZXR1cm4ge09iamVjdH0gICAgIERlZmVycmVkCiAqIEBleGFtcGxlCiAqIHN0b3JlLnNldFVyaSggIi4uLiIgKS50aGVuKCBmdW5jdGlvbiAoIHJlY29yZHMgKSB7CiAqICAgLi4uCiAqIH0sIGZ1bmN0aW9uICggZXJyICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnNldFVyaSA9IGZ1bmN0aW9uICggYXJnICkgewoJdmFyIGRlZmVyID0gZGVmZXJyZWQuZmFjdG9yeSgpLAoJICAgIHBhcnNlZDsKCglpZiAoIGFyZyAhPT0gbnVsbCAmJiBzdHJpbmcuaXNFbXB0eSggYXJnICkgKSB7CgkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKSApOwoJfQoKCWlmICggYXJnID09PSBudWxsICkgewoJCXRoaXMudXJpID0gYXJnOwoJfQoJZWxzZSB7CgkJcGFyc2VkICAgPSB1dGlsaXR5LnBhcnNlKCBhcmcgKTsKCQl0aGlzLnVyaSA9IHBhcnNlZC5wcm90b2NvbCArICIvLyIgKyBwYXJzZWQuaG9zdCArIHBhcnNlZC5wYXRoOwoKCQlpZiAoICFzdHJpbmcuaXNFbXB0eSggcGFyc2VkLmF1dGggKSAmJiAhdGhpcy5oZWFkZXJzLmF1dGhvcml6YXRpb24gJiYgIXRoaXMuaGVhZGVycy5BdXRob3JpemF0aW9uICkgewoJCQl0aGlzLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9ICJCYXNpYyAiICsgYnRvYSggZGVjb2RlVVJJQ29tcG9uZW50KCBwYXJzZWQuYXV0aCApICk7CgkJfQoKCQl0aGlzLm9uKCAiZXhwaXJlIiwgZnVuY3Rpb24gKCkgewoJCQl0aGlzLnN5bmMoKTsKCQl9LCAicmVzeW5jIiwgdGhpcyApOwoKCQljYWNoZS5leHBpcmUoIHRoaXMudXJpICk7CgoJCXRoaXMuc3luYygpLnRoZW4oIGZ1bmN0aW9uIChhcmcgKSB7CgkJCWRlZmVyLnJlc29sdmUoIGFyZyApOwoJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJfSApOwoJfQoKCXJldHVybiBkZWZlcjsKfTsKCi8qKgogKiBDcmVhdGVzLCBvciByZXR1cm5zIGEgY2FjaGVkIHZpZXcgb2YgdGhlIHJlY29yZHMgKG5vdCBieSByZWZlcmVuY2UpCiAqCiAqIEBtZXRob2Qgc29ydAogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFTdG9yZQogKiBAcGFyYW0gIHtTdHJpbmd9IHF1ZXJ5ICBTUUwgKCBzdHlsZSApIG9yZGVyIGJ5CiAqIEBwYXJhbSAge1N0cmluZ30gY3JlYXRlIFtPcHRpb25hbCwgZGVmYXVsdCBiZWhhdmlvciBpcyB0cnVlLCB2YWx1ZSBpcyBmYWxzZV0gQm9vbGVhbiBkZXRlcm1pbmVzIHdoZXRoZXIgdG8gcmVjcmVhdGUgYSB2aWV3IGlmIGl0IGV4aXN0cwogKiBAcGFyYW0gIHtPYmplY3R9IHdoZXJlICBbT3B0aW9uYWxdIE9iamVjdCBkZXNjcmliaW5nIHRoZSBXSEVSRSBjbGF1c2UKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZXhhbXBsZQogKiBzdG9yZS5zb3J0KCAiYWdlIGRlc2MsIG5hbWUiICkudGhlbiggZnVuY3Rpb24gKCByZWNvcmRzICkgewogKiAgIC4uLgogKiB9LCBmdW5jdGlvbiAoIGVyciApIHsKICogICAuLi4KICogfSApOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5zb3J0ID0gZnVuY3Rpb24gKCBxdWVyeSwgY3JlYXRlLCB3aGVyZSApIHsKCWNyZWF0ZSAgICAgID0gKCBjcmVhdGUgPT09IHRydWUgfHwgKCB3aGVyZSBpbnN0YW5jZW9mIE9iamVjdCApICk7Cgl2YXIgc2VsZiAgICA9IHRoaXMsCgkgICAgdmlldyAgICA9IHN0cmluZy50b0NhbWVsQ2FzZSggc3RyaW5nLmV4cGxvZGUoIHF1ZXJ5ICkuam9pbiggIiAiICkgKSwKCSAgICBkZWZlciAgID0gZGVmZXJyZWQuZmFjdG9yeSgpLAoJICAgIG5leHQsIHdvcmtlcjsKCgkvLyBOZXh0IHBoYXNlCgluZXh0ID0gZnVuY3Rpb24gKCByZWNvcmRzICkgewoJCWlmICggc2VsZi50b3RhbCA9PT0gMCApIHsKCQkJZGVmZXIucmVzb2x2ZSggW10gKTsKCQl9CgkJZWxzZSBpZiAoICFjcmVhdGUgJiYgc2VsZi52aWV3c1t2aWV3XSApIHsKCQkJZGVmZXIucmVzb2x2ZSggc2VsZi52aWV3c1t2aWV3XSApOwoJCX0KCQllbHNlIGlmICggd2ViV29ya2VyICkgewoJCQlkZWZlci50aGVuKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCXNlbGYudmlld3Nbdmlld10gPSBhcmc7CgoJCQkJcmV0dXJuIHNlbGYudmlld3Nbdmlld107CgkJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCXV0aWxpdHkuZXJyb3IoIGUgKTsKCQkJfSApOwoKCQkJdHJ5IHsKCQkJCXdvcmtlciA9IHV0aWxpdHkud29ya2VyKCBkZWZlciApOwoJCQkJd29ya2VyLnBvc3RNZXNzYWdlKCB7Y21kOiAic29ydCIsIGluZGV4ZXM6IHNlbGYuaW5kZXhlcywgcmVjb3JkczogcmVjb3JkcywgcXVlcnk6IHF1ZXJ5fSApOwoJCQl9CgkJCWNhdGNoICggZSApIHsKCQkJCS8vIFByb2JhYmx5IElFMTAsIHdoaWNoIGRvZXNuJ3QgaGF2ZSB0aGUgY29ycmVjdCBzZWN1cml0eSBmbGFnIGZvciBsb2NhbCBsb2FkaW5nCgkJCQl3ZWJXb3JrZXIgPSBmYWxzZTsKCgkJCQlzZWxmLnZpZXdzW3ZpZXddID0gYXJyYXkua2V5U29ydCggcmVjb3JkcywgcXVlcnksICJkYXRhIiApOwoJCQkJZGVmZXIucmVzb2x2ZSggc2VsZi52aWV3c1t2aWV3XSApOwoJCQl9CgkJfQoJCWVsc2UgewoJCQlzZWxmLnZpZXdzW3ZpZXddID0gYXJyYXkua2V5U29ydCggcmVjb3JkcywgcXVlcnksICJkYXRhIiApOwoJCQlkZWZlci5yZXNvbHZlKCBzZWxmLnZpZXdzW3ZpZXddICk7CgkJfQoJfTsKCglpZiAoICF3aGVyZSApIHsKCQluZXh0KCB1dGlsaXR5LmNsb25lKCB0aGlzLnJlY29yZHMsIHRydWUgKSApOwoJfQoJZWxzZSB7CgkJdGhpcy5zZWxlY3QoIHdoZXJlICkudGhlbiggbmV4dCwgZnVuY3Rpb24gKCBlICkgewoJCQlkZWZlci5yZWplY3QoIGUgKTsKCQl9ICk7Cgl9CgoJcmV0dXJuIGRlZmVyOwp9OwoKLyoqCiAqIFN0b3JhZ2UgaW50ZXJmYWNlCiAqCiAqIFNRTC9Ob1NRTCBiYWNrZW5kcyB3aWxsIGJlIHVzZWQgaWYgY29uZmlndXJlZCBpbiBsaWV1IG9mIGxvY2FsU3RvcmFnZSAobm9kZS5qcyBvbmx5KQogKgogKiBAbWV0aG9kIHN0b3JhZ2UKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7TWl4ZWR9ICBvYmogIFJlY29yZCAoIE9iamVjdCwga2V5IG9yIGluZGV4ICkgb3Igc3RvcmUKICogQHBhcmFtICB7T2JqZWN0fSBvcCAgIE9wZXJhdGlvbiB0byBwZXJmb3JtICggZ2V0LCByZW1vdmUgb3Igc2V0ICkKICogQHBhcmFtICB7U3RyaW5nfSB0eXBlIFtPcHRpb25hbF0gVHlwZSBvZiBTdG9yYWdlIHRvIHVzZSAoIGxvY2FsLCBzZXNzaW9uIFtsb2NhbF0gKQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGVmZXJyZWR9CiAqIEBleGFtcGxlCiAqIHN0b3JlLnN0b3JhZ2UoIHN0b3JlLCAic2V0IiApOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS5zdG9yYWdlID0gZnVuY3Rpb24gKCBvYmosIG9wLCB0eXBlICkgewoJdmFyIHNlbGYgICAgPSB0aGlzLAoJICAgIHJlY29yZCAgPSBmYWxzZSwKCSAgICBtb25nbyAgID0gIXN0cmluZy5pc0VtcHR5KCB0aGlzLm1vbmdvZGIgKSwKCSAgICBzZXNzaW9uID0gKCB0eXBlID09PSAic2Vzc2lvbiIgJiYgdHlwZW9mIHNlc3Npb25TdG9yYWdlICE9ICJ1bmRlZmluZWQiICksCgkgICAgZGVmZXIgICA9IGRlZmVycmVkLmZhY3RvcnkoKSwKCSAgICBkYXRhLCBrZXksIHJlc3VsdDsKCglpZiAoICFyZWdleC5udW1iZXJfc3RyaW5nX29iamVjdC50ZXN0KCB0eXBlb2Ygb2JqICkgfHwgIXJlZ2V4LmdldF9yZW1vdmVfc2V0LnRlc3QoIG9wICkgKSB7CgkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKSApOwoJfQoJZWxzZSB7CgkJcmVjb3JkID0gKCByZWdleC5udW1iZXJfc3RyaW5nLnRlc3QoIHR5cGVvZiBvYmogKSB8fCBvYmouaGFzT3duUHJvcGVydHkoICJkYXRhIiApICk7CgoJCWlmICggb3AgIT09ICJyZW1vdmUiICkgewoJCQlpZiAoIHJlY29yZCAmJiAhKCBvYmogaW5zdGFuY2VvZiBPYmplY3QgKSApIHsKCQkJCW9iaiA9IHRoaXMuZ2V0KCBvYmogKTsKCQkJfQoKCQkJa2V5ID0gcmVjb3JkID8gb2JqLmtleSA6IG9iai5pZDsKCQl9CgkJZWxzZSBpZiAoIG9wID09PSAicmVtb3ZlIiAmJiByZWNvcmQgKSB7CgkJCWtleSA9IG9iai5rZXkgfHwgb2JqOwoJCX0KCgkJaWYgKCBtb25nbyApIHsKCQkJbW9uZ29kYi5jb25uZWN0KCB0aGlzLm1vbmdvZGIsIGZ1bmN0aW9uICggZSwgZGIgKSB7CgkJCQlpZiAoIGUgKSB7CgkJCQkJaWYgKCBkYiApIHsKCQkJCQkJZGIuY2xvc2UoKTsKCQkJCQl9CgoJCQkJCXJldHVybiBkZWZlci5yZWplY3QoIGUgKTsKCQkJCX0KCgkJCQlkYi5jb2xsZWN0aW9uKCBzZWxmLmlkLCBmdW5jdGlvbiAoIGUsIGNvbGxlY3Rpb24gKSB7CgkJCQkJaWYgKCBlICkgewoJCQkJCQlkYi5jbG9zZSgpOwoJCQkJCQlyZXR1cm4gZGVmZXIucmVqZWN0KCBlICk7CgkJCQkJfQoKCQkJCQlpZiAoIG9wID09PSAiZ2V0IiApIHsKCQkJCQkJaWYgKCByZWNvcmQgKSB7CgkJCQkJCQljb2xsZWN0aW9uLmZpbmQoIHtfaWQ6IG9iai5rZXl9ICkubGltaXQoIDEgKS50b0FycmF5KCBmdW5jdGlvbiAoIGUsIHJlY3MgKSB7CgkJCQkJCQkJZGIuY2xvc2UoKTsKCgkJCQkJCQkJaWYgKCBlICkgewoJCQkJCQkJCQlkZWZlci5yZWplY3QoIGUgKTsKCQkJCQkJCQl9CgkJCQkJCQkJZWxzZSBpZiAoIHJlY3MubGVuZ3RoID09PSAwICkgewoJCQkJCQkJCQlkZWZlci5yZXNvbHZlKCBudWxsICk7CgkJCQkJCQkJfQoJCQkJCQkJCWVsc2UgewoJCQkJCQkJCQlkZWxldGUgcmVjc1swXS5faWQ7CgoJCQkJCQkJCQlzZWxmLnNldCgga2V5LCByZWNzWzBdLCB0cnVlICkudGhlbiggZnVuY3Rpb24gKCByZWMgKSB7CgkJCQkJCQkJCQlkZWZlci5yZXNvbHZlKCByZWMgKTsKCQkJCQkJCQkJfSwgZnVuY3Rpb24gKCBlICkgewoJCQkJCQkJCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJCQkJCQkJCX0gKTsKCQkJCQkJCQl9CgkJCQkJCQl9ICk7CgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCQljb2xsZWN0aW9uLmZpbmQoIHt9ICkudG9BcnJheSggZnVuY3Rpb24gKCBlLCByZWNzICkgewoJCQkJCQkJCXZhciBpLCBudGg7CgoJCQkJCQkJCWlmICggZSApIHsKCQkJCQkJCQkJZGIuY2xvc2UoKTsKCQkJCQkJCQkJcmV0dXJuIGRlZmVyLnJlamVjdCggZSApOwoJCQkJCQkJCX0KCgkJCQkJCQkJaSAgID0gLTE7CgkJCQkJCQkJbnRoID0gcmVjcy5sZW5ndGg7CgoJCQkJCQkJCWlmICggbnRoID4gMCApIHsKCQkJCQkJCQkJc2VsZi5yZWNvcmRzID0gcmVjcy5tYXAoIGZ1bmN0aW9uICggciApIHsKCQkJCQkJCQkJCXZhciByZWMgPSB7a2V5OiByLl9pZCwgaW5kZXg6ICsraSwgZGF0YToge319OwoKCQkJCQkJCQkJCXNlbGYuaW5kZXhlcy5rZXlbcmVjLmtleV0gPSByZWMuaW5kZXg7CgkJCQkJCQkJCQlyZWMuZGF0YSA9IHI7CgkJCQkJCQkJCQlkZWxldGUgcmVjLmRhdGEuX2lkOwoJCQkJCQkJCQkJc2VsZi5zZXRJbmRleGVzKCByZWMgKTsKCgkJCQkJCQkJCQlyZXR1cm4gcmVjOwoJCQkJCQkJCQl9ICk7CgoJCQkJCQkJCQlzZWxmLnRvdGFsID0gbnRoOwoJCQkJCQkJCX0KCgkJCQkJCQkJZGIuY2xvc2UoKTsKCQkJCQkJCQlkZWZlci5yZXNvbHZlKCBzZWxmLnJlY29yZHMgKTsKCQkJCQkJCX0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQllbHNlIGlmICggb3AgPT09ICJyZW1vdmUiICkgewoJCQkJCQljb2xsZWN0aW9uLnJlbW92ZSggcmVjb3JkID8ge19pZDoga2V5fSA6IHt9LCB7c2FmZTogdHJ1ZX0sIGZ1bmN0aW9uICggZSwgYXJnICkgewoJCQkJCQkJZGIuY2xvc2UoKTsKCgkJCQkJCQlpZiAoIGUgKSB7CgkJCQkJCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJCQkJCQl9CgkJCQkJCQllbHNlIHsKCQkJCQkJCQlkZWZlci5yZXNvbHZlKCBhcmcgKTsKCQkJCQkJCX0KCQkJCQkJfSApOwoJCQkJCX0KCQkJCQllbHNlIGlmICggb3AgPT09ICJzZXQiICkgewoJCQkJCQlpZiAoIHJlY29yZCApIHsKCQkJCQkJCWNvbGxlY3Rpb24udXBkYXRlKCB7X2lkOiBvYmoua2V5fSwgb2JqLmRhdGEsIHt3OiAxLCBzYWZlOiB0cnVlLCB1cHNlcnQ6IHRydWV9LCBmdW5jdGlvbiAoIGUsIGFyZyApIHsKCQkJCQkJCQlkYi5jbG9zZSgpOwoKCQkJCQkJCQlpZiAoIGUgKSB7CgkJCQkJCQkJCWRlZmVyLnJlamVjdCggZSApOwoJCQkJCQkJCX0KCQkJCQkJCQllbHNlIHsKCQkJCQkJCQkJZGVmZXIucmVzb2x2ZSggYXJnICk7CgkJCQkJCQkJfQoJCQkJCQkJfSApOwoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJLy8gUmVtb3ZpbmcgYWxsIGRvY3VtZW50cyAmIHJlLWluc2VydGluZwoJCQkJCQkJY29sbGVjdGlvbi5yZW1vdmUoIHt9LCB7dzogMSwgc2FmZTogdHJ1ZX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCQkJCQl2YXIgZGVmZXJyZWRzOwoKCQkJCQkJCQlpZiAoIGUgKSB7CgkJCQkJCQkJCWRiLmNsb3NlKCk7CgkJCQkJCQkJCXJldHVybiBkZWZlci5yZWplY3QoIGUgKTsKCgkJCQkJCQkJfQoJCQkJCQkJCWVsc2UgewoJCQkJCQkJCQlkZWZlcnJlZHMgPSBbXTsKCgkJCQkJCQkJCWFycmF5LmVhY2goIHNlbGYucmVjb3JkcywgZnVuY3Rpb24gKCBpICkgewoJCQkJCQkJCQkJdmFyIGRhdGEgICA9IHt9LAoJCQkJCQkJCQkJCWRlZmVyMiA9IGRlZmVycmVkLmZhY3RvcnkoKTsKCgkJCQkJCQkJCQlkZWZlcnJlZHMucHVzaCggZGVmZXIyICk7CgoJCQkJCQkJCQkJdXRpbGl0eS5pdGVyYXRlKCBpLmRhdGEsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCQkJCQkJCQlkYXRhW2tdID0gdjsKCQkJCQkJCQkJCX0gKTsKCgkJCQkJCQkJCQljb2xsZWN0aW9uLnVwZGF0ZSgge19pZDogaS5rZXl9LCBkYXRhLCB7dzoxLCBzYWZlOnRydWUsIHVwc2VydDp0cnVlfSwgZnVuY3Rpb24gKCBlLCBhcmcgKSB7CgkJCQkJCQkJCQkJaWYgKCBlICkgewoJCQkJCQkJCQkJCQlkZWZlcjIucmVqZWN0KCBlICk7CgkJCQkJCQkJCQkJfQoJCQkJCQkJCQkJCWVsc2UgewoJCQkJCQkJCQkJCQlkZWZlcjIucmVzb2x2ZSggYXJnICk7CgkJCQkJCQkJCQkJfQoJCQkJCQkJCQkJfSApOwoJCQkJCQkJCQl9ICk7CgoJCQkJCQkJCQl1dGlsaXR5LndoZW4oIGRlZmVycmVkcyApLnRoZW4oIGZ1bmN0aW9uICggcmVzdWx0ICkgewoJCQkJCQkJCQkJZGIuY2xvc2UoKTsKCQkJCQkJCQkJCWRlZmVyLnJlc29sdmUoIHJlc3VsdCApOwoJCQkJCQkJCQl9LCBmdW5jdGlvbiAoIGUgKSB7CgkJCQkJCQkJCQlkYi5jbG9zZSgpOwoJCQkJCQkJCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJCQkJCQkJCX0gKTsKCQkJCQkJCQl9CgkJCQkJCQl9ICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJZWxzZSB7CgkJCQkJCWRiLmNsb3NlKCk7CgkJCQkJCWRlZmVyLnJlamVjdCggbnVsbCApOwoJCQkJCX0KCQkJCX0gKTsKCQkJfSApOwoJCX0KCQllbHNlIHsKCQkJaWYgKCBvcCA9PT0gImdldCIgKSB7CgkJCQlyZXN1bHQgPSBzZXNzaW9uID8gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgga2V5ICkgOiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgga2V5ICk7CgoJCQkJaWYgKCByZXN1bHQgIT09IG51bGwgKSB7CgkJCQkJcmVzdWx0ID0ganNvbi5kZWNvZGUoIHJlc3VsdCApOwoKCQkJCQlpZiAoIHJlY29yZCApIHsKCQkJCQkJc2VsZi5zZXQoIGtleSwgcmVzdWx0LCB0cnVlICkudGhlbiggZnVuY3Rpb24gKCByZWMgKSB7CgkJCQkJCQlkZWZlci5yZXNvbHZlKCByZWMgKTsKCQkJCQkJfSwgZnVuY3Rpb24gKCBlICkgewoJCQkJCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJCQkJCX0gKTsKCQkJCQl9CgkJCQkJZWxzZSB7CgkJCQkJCXV0aWxpdHkubWVyZ2UoIHNlbGYsIHJlc3VsdCApOwoJCQkJCQlkZWZlci5yZXNvbHZlKCBzZWxmICk7CgkJCQkJfQoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJZGVmZXIucmVzb2x2ZSggc2VsZiApOwoJCQkJfQoKCQkJCS8vIERlY29yYXRpbmcgbG9hZGVkIHN0YXRlIGZvciB2YXJpb3VzIGNvZGUgcGF0aHMKCQkJCWRlZmVyLnRoZW4oIGZ1bmN0aW9uICgpIHsKCQkJCQlzZWxmLmxvYWRlZCA9IHRydWU7CgkJCQl9LCBmdW5jdGlvbiAoIGUgKSB7CgkJCQkJdGhyb3cgZTsKCQkJCX0gKTsKCQkJfQoJCQllbHNlIGlmICggb3AgPT09ICJyZW1vdmUiICkgewoJCQkJc2Vzc2lvbiA/IHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oIGtleSApIDogbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oIGtleSApOwoJCQkJZGVmZXIucmVzb2x2ZSggdGhpcyApOwoJCQl9CgkJCWVsc2UgaWYgKCBvcCA9PT0gInNldCIgKSB7CgkJCQlkYXRhID0ganNvbi5lbmNvZGUoIHJlY29yZCA/IG9iai5kYXRhIDoge3RvdGFsOiB0aGlzLnRvdGFsLCBpbmRleDogdGhpcy5pbmRleCwgaW5kZXhlczogdGhpcy5pbmRleGVzLCByZWNvcmRzOiB0aGlzLnJlY29yZHN9ICk7CgkJCQlzZXNzaW9uID8gc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgga2V5LCBkYXRhICkgOiBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgga2V5LCBkYXRhICk7CgkJCQlkZWZlci5yZXNvbHZlKCB0aGlzICk7CgkJCX0KCQkJZWxzZSB7CgkJCQlkZWZlci5yZWplY3QoIG51bGwgKTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZGVmZXI7Cn07CgovKioKICogU3luY3MgdGhlIERhdGFTdG9yZSB3aXRoIGEgVVJJIHJlcHJlc2VudGF0aW9uCiAqCiAqIEBtZXRob2Qgc3luYwogKiBAbWVtYmVyT2Yga2VpZ2FpLkRhdGFTdG9yZQogKiBAcmV0dXJuIHtPYmplY3R9IHtAbGluayBrZWlnYWkuRGVmZXJyZWR9CiAqIEBmaXJlcyBrZWlnYWkuRGF0YVN0b3JlI2JlZm9yZVN5bmMgRmlyZXMgYmVmb3JlIHN5bmNpbmcgdGhlIERhdGFTdG9yZQogKiBAZmlyZXMga2VpZ2FpLkRhdGFTdG9yZSNhZnRlclN5bmMgRmlyZXMgYWZ0ZXIgc3luY2luZyB0aGUgRGF0YVN0b3JlCiAqIEBmaXJlcyBrZWlnYWkuRGF0YVN0b3JlI2ZhaWxlZFN5bmMgRmlyZXMgd2hlbiBhbiBleGNlcHRpb24gb2NjdXJzCiAqIEBleGFtcGxlCiAqIHN0b3JlLnN5bmMoKS50aGVuKCBmdW5jdGlvbiAoIHJlY29yZHMgKSB7CiAqICAgLi4uCiAqIH0sIGZ1bmN0aW9uICggZXJyICkgewogKiAgIC4uLgogKiB9ICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnN5bmMgPSBmdW5jdGlvbiAoKSB7Cgl2YXIgc2VsZiAgID0gdGhpcywKCSAgICBldmVudHMgPSAoIHRoaXMuZXZlbnRzID09PSB0cnVlICksCgkgICAgZGVmZXIgID0gZGVmZXJyZWQuZmFjdG9yeSgpLAoJICAgIHN1Y2Nlc3MsIGZhaWx1cmU7CgoJLyoqCgkgKiBSZXNvbHZlcyBwdWJsaWMgZGVmZXJyZWQKCSAqCgkgKiBAbWV0aG9kIHN1Y2Nlc3MKCSAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlLnN5bmMKCSAqIEBwcml2YXRlCgkgKiBAcGFyYW0gIHtPYmplY3R9IGFyZyBBUEkgcmVzcG9uc2UKCSAqIEByZXR1cm4ge1VuZGVmaW5lZH0gIHVuZGVmaW5lZAoJICovCglzdWNjZXNzID0gZnVuY3Rpb24gKCBhcmcgKSB7CgkJdmFyIGRhdGE7CgoJCWlmICggdHlwZW9mIGFyZyAhPSAib2JqZWN0IiApIHsKCQkJcmV0dXJuIGZhaWx1cmUoIG5ldyBFcnJvciggbGFiZWwuZXhwZWN0ZWRPYmplY3QgKSApOwoJCX0KCgkJaWYgKCBzZWxmLnNvdXJjZSAhPT0gbnVsbCApIHsKCQkJYXJnID0gdXRpbGl0eS53YWxrKCBhcmcsIHNlbGYuc291cmNlICk7CgkJfQoKCQlpZiAoIGFyZyBpbnN0YW5jZW9mIEFycmF5ICkgewoJCQlkYXRhID0gYXJnOwoJCX0KCQllbHNlIHsKCQkJZGF0YSA9IFthcmddOwoJCX0KCgkJc2VsZi5iYXRjaCggInNldCIsIGRhdGEsIHRydWUgKS50aGVuKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJaWYgKCBldmVudHMgKSB7CgkJCQlzZWxmLmRpc3BhdGNoKCAiYWZ0ZXJTeW5jIiwgYXJnICk7CgkJCX0KCgkJCWRlZmVyLnJlc29sdmUoIGFyZyApOwoJCX0sIGZhaWx1cmUgKTsKCX07CgoJLyoqCgkgKiBSZWplY3RzIHB1YmxpYyBkZWZlcnJlZAoJICoKCSAqIEBtZXRob2QgZmFpbHVyZQoJICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUuc3luYwoJICogQHByaXZhdGUKCSAqIEBwYXJhbSAge09iamVjdH0gZSBFcnJvciBpbnN0YW5jZQoJICogQHJldHVybiB7VW5kZWZpbmVkfSB1bmRlZmluZWQKCSAqLwoJZmFpbHVyZSA9IGZ1bmN0aW9uICggZSApIHsKCQlpZiAoIGV2ZW50cyApIHsKCQkJc2VsZi5kaXNwYXRjaCggImZhaWxlZFN5bmMiLCBlICk7CgkJfQoKCQlkZWZlci5yZWplY3QoIGUgKTsKCX07CgoJaWYgKCB0aGlzLnVyaSA9PT0gbnVsbCB8fCBzdHJpbmcuaXNFbXB0eSggdGhpcy51cmkgKSApIHsKCQlkZWZlci5yZWplY3QoIG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApICk7Cgl9CgllbHNlIHsKCQlpZiAoIGV2ZW50cyApIHsKCQkJdGhpcy5kaXNwYXRjaCggImJlZm9yZVN5bmMiLCB0aGlzLnVyaSApOwoJCX0KCgkJaWYgKCB0aGlzLmNhbGxiYWNrICE9PSBudWxsICkgewoJCQljbGllbnQuanNvbnAoIHRoaXMudXJpLCB7Y2FsbGJhY2s6IHRoaXMuY2FsbGJhY2t9ICkudGhlbiggc3VjY2VzcywgZmFpbHVyZSApOwoJCX0KCQllbHNlIHsKCQkJY2xpZW50LnJlcXVlc3QoIHRoaXMudXJpLCAiR0VUIiwgbnVsbCwgdXRpbGl0eS5tZXJnZSgge3dpdGhDcmVkZW50aWFsczogdGhpcy5jcmVkZW50aWFsc30sIHRoaXMuaGVhZGVycyApICkudGhlbiggc3VjY2VzcywgZmFpbHVyZSApOwoJCX0KCX0KCglyZXR1cm4gZGVmZXI7Cn07CgovKioKICogVGVhcnMgZG93biBhIHN0b3JlICYgZXhwaXJlcyBhbGwgcmVjb3JkcyBhc3NvY2lhdGVkIHRvIGFuIEFQSQogKgogKiBAbWV0aG9kIHRlYXJkb3duCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EYXRhU3RvcmV9CiAqIEBleGFtcGxlCiAqIHN0b3JlLnRlYXJkb3duKCk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnRlYXJkb3duID0gZnVuY3Rpb24gKCkgewoJdmFyIHVyaSA9IHRoaXMudXJpLAoJICAgIGlkOwoKCWlmICggdXJpICE9PSBudWxsICkgewoJCWNhY2hlLmV4cGlyZSggdXJpLCB0cnVlICk7CgoJCWlkID0gdGhpcy5pZCArICJEYXRhRXhwaXJlIjsKCQl1dGlsaXR5LmNsZWFyVGltZXJzKCBpZCApOwoKCQlhcnJheS5lYWNoKCB0aGlzLnJlY29yZHMsIGZ1bmN0aW9uICggaSApIHsKCQkJdmFyIHJlY29yZFVyaSA9IHVyaSArICIvIiArIGkua2V5OwoKCQkJY2FjaGUuZXhwaXJlKCByZWNvcmRVcmksIHRydWUgKTsKCQl9ICk7Cgl9CgoJYXJyYXkuZWFjaCggdGhpcy5saXN0cywgZnVuY3Rpb24gKCBpICkgewoJCWkudGVhcmRvd24oIHRydWUgKTsKCX0gKTsKCgl0aGlzLmNsZWFyKCB0cnVlICk7Cgl0aGlzLmRpc3BhdGNoKCAiYWZ0ZXJUZWFyZG93biIgKTsKCglyZXR1cm4gdGhpczsKfTsKCi8qKgogKiBVbmRvZXMgdGhlIGxhc3QgbW9kaWZpY2F0aW9uIHRvIGEgcmVjb3JkLCBpZiBpdCBleGlzdHMKICoKICogQG1ldGhvZCB1bmRvCiAqIEBtZW1iZXJPZiBrZWlnYWkuRGF0YVN0b3JlCiAqIEBwYXJhbSAge01peGVkfSAga2V5ICAgICBLZXkgb3IgaW5kZXgKICogQHBhcmFtICB7U3RyaW5nfSB2ZXJzaW9uIFtPcHRpb25hbF0gVmVyc2lvbiB0byByZXN0b3JlCiAqIEByZXR1cm4ge09iamVjdH0gICAgICAgICBEZWZlcnJlZAogKiBAZXhhbXBsZQogKiAvLyBEaWRuJ3QgbGlrZSB0aGUgbmV3IHZlcnNpb24sIHNvIHVuZG8gdGhlIGNoYW5nZQogKiBzdG9yZS51bmRvKCAia2V5IiwgInYxIiApOwogKi8KRGF0YVN0b3JlLnByb3RvdHlwZS51bmRvID0gZnVuY3Rpb24gKCBrZXksIHZlcnNpb24gKSB7Cgl2YXIgcmVjb3JkICAgPSB0aGlzLmdldCgga2V5ICksCgkgICAgZGVmZXIgICAgPSBkZWZlcnJlZC5mYWN0b3J5KCksCgkgICAgdmVyc2lvbnMgPSB0aGlzLnZlcnNpb25zW3JlY29yZC5rZXldLAoJICAgIHByZXZpb3VzOwoKCWlmICggcmVjb3JkID09PSB1bmRlZmluZWQgKSB7CgkJZGVmZXIucmVqZWN0KCBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKSApOwoJfQoJZWxzZSB7CgkJaWYgKCB2ZXJzaW9ucyApIHsKCQkJcHJldmlvdXMgPSB2ZXJzaW9ucy5nZXQoIHZlcnNpb24gfHwgdmVyc2lvbnMuZmlyc3QgKTsKCgkJCWlmICggcHJldmlvdXMgPT09IHVuZGVmaW5lZCApIHsKCQkJCWRlZmVyLnJlamVjdCggbGFiZWwuZGF0YXN0b3JlTm9QcmV2VmVyc2lvbiApOwoJCQl9CgkJCWVsc2UgewoJCQkJdGhpcy5zZXQoIGtleSwgcHJldmlvdXMgKS50aGVuKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCQlkZWZlci5yZXNvbHZlKCBhcmcgKTsKCQkJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCQlkZWZlci5yZWplY3QoIGUgKTsKCQkJCX0gKTsKCQkJfQoJCX0KCQllbHNlIHsKCQkJZGVmZXIucmVqZWN0KCBsYWJlbC5kYXRhc3RvcmVOb1ByZXZWZXJzaW9uICk7CgkJfQoJfQoKCXJldHVybiBkZWZlcjsKfTsKCi8qKgogKiBSZXR1cm5zIEFycmF5IG9mIHVuaXF1ZSB2YWx1ZXMgb2YgYGtleWAKICoKICogQG1ldGhvZCB1bmlxdWUKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7U3RyaW5nfSBrZXkgRmllbGQgdG8gY29tcGFyZQogKiBAcmV0dXJuIHtBcnJheX0gICAgICBBcnJheSBvZiB2YWx1ZXMKICogQGV4YW1wbGUKICogdmFyIGFnZXMgPSBzdG9yZS51bmlxdWUoICJhZ2UiICk7CiAqLwpEYXRhU3RvcmUucHJvdG90eXBlLnVuaXF1ZSA9IGZ1bmN0aW9uICgga2V5ICkgewoJcmV0dXJuIGFycmF5LnVuaXF1ZSggdGhpcy5yZWNvcmRzLm1hcCggZnVuY3Rpb24gKCBpICkgewoJCXJldHVybiBpLmRhdGFba2V5XTsKCX0gKSApOwp9OwoKLyoqCiAqIEFwcGxpZXMgYSBkaWZmZXJlbmNlIHRvIGEgcmVjb3JkCiAqCiAqIFVzZSBgZGF0YS5zZXQoKWAgaWYgYGRhdGFgIGlzIHRoZSBjb21wbGV0ZSBmaWVsZCBzZXQKICoKICogQG1ldGhvZCB1cGRhdGUKICogQG1lbWJlck9mIGtlaWdhaS5EYXRhU3RvcmUKICogQHBhcmFtICB7TWl4ZWR9ICBrZXkgIEtleSBvciBpbmRleAogKiBAcGFyYW0gIHtPYmplY3R9IGRhdGEgS2V5OlZhbHVlIHBhaXJzIHRvIHNldCBhcyBmaWVsZCB2YWx1ZXMKICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQogKiBAZXhhbXBsZQogKiBzdG9yZS51cGRhdGUoICJrZXkiLCB7YWdlOiAzNH0gKTsKICovCkRhdGFTdG9yZS5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKCBrZXksIGRhdGEgKSB7Cgl2YXIgcmVjb3JkID0gdGhpcy5nZXQoIGtleSApLAoJICAgIGRlZmVyICA9IGRlZmVycmVkLmZhY3RvcnkoKTsKCglpZiAoIHJlY29yZCA9PT0gdW5kZWZpbmVkICkgewoJCWRlZmVyLnJlamVjdCggbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICkgKTsKCX0KCWVsc2UgewoJCXRoaXMuc2V0KCBrZXksIHV0aWxpdHkubWVyZ2UoIHJlY29yZC5kYXRhLCBkYXRhICkgKS50aGVuKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJZGVmZXIucmVzb2x2ZSggYXJnICk7CgkJfSwgZnVuY3Rpb24gKCBlICkgewoJCQlkZWZlci5yZWplY3QoIGUgKTsKCQl9ICk7Cgl9CgoJcmV0dXJuIGRlZmVyOwp9OwoKLyoqCiAqIEBuYW1lc3BhY2Ugc3RyaW5nCiAqLwp2YXIgc3RyaW5nID0gewoJLyoqCgkgKiBDYXBpdGFsaXplcyB0aGUgU3RyaW5nCgkgKgoJICogQG1ldGhvZCBjYXBpdGFsaXplCgkgKiBAbWVtYmVyT2Ygc3RyaW5nCgkgKiBAcGFyYW0gIHtTdHJpbmd9ICBvYmogU3RyaW5nIHRvIGNhcGl0YWxpemUKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGFsbCBbT3B0aW9uYWxdIENhcGl0YWxpemUgZWFjaCB3b3JkCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgQ2FwaXRhbGl6ZWQgU3RyaW5nCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuc3RyaW5nLmNhcGl0YWxpemUoICJoZWxsbyIgKTsgLy8gIkhlbGxvIgoJICovCgljYXBpdGFsaXplIDogZnVuY3Rpb24gKCBvYmosIGFsbCApIHsKCQlhbGwgPSAoIGFsbCA9PT0gdHJ1ZSApOwoKCQl2YXIgcmVzdWx0OwoKCQlpZiAoIGFsbCApIHsKCQkJcmVzdWx0ID0gc3RyaW5nLmV4cGxvZGUoIG9iaiwgIiAiICkubWFwKCBmdW5jdGlvbiAoIGkgKSB7CgkJCQlyZXR1cm4gaS5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgaS5zbGljZSggMSApOwoJCQl9ICkuam9pbigiICIpOwoJCX0KCQllbHNlIHsKCQkJcmVzdWx0ID0gb2JqLmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBvYmouc2xpY2UoIDEgKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogRXNjYXBlcyBtZXRhIGNoYXJhY3RlcnMgd2l0aGluIGEgc3RyaW5nCgkgKgoJICogQG1ldGhvZCBlc2NhcGUKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gb2JqIFN0cmluZyB0byBlc2NhcGUKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgIEVzY2FwZWQgc3RyaW5nCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuc3RyaW5nLmVzY2FwZSggIntoZWxsb30iICk7IC8vICJce2hlbGxvXH0iCgkgKi8KCWVzY2FwZSA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBvYmoucmVwbGFjZSggL1tcLVxbXF17fSgpKis/LixcXFwvXF5cJHwjXHNdL2csICJcXCQmIiApOwoJfSwKCgkvKioKCSAqIFNwbGl0cyBhIHN0cmluZyBvbiBjb21tYSwgb3IgYSBwYXJhbWV0ZXIsIGFuZCB0cmltcyBlYWNoIHZhbHVlIGluIHRoZSByZXN1bHRpbmcgQXJyYXkKCSAqCgkgKiBAbWV0aG9kIGV4cGxvZGUKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gb2JqIFN0cmluZyB0byBjYXBpdGFsaXplCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBTdHJpbmcgdG8gc3BsaXQgb24KCSAqIEByZXR1cm4ge0FycmF5fSAgICAgIEFycmF5IG9mIHRoZSBleHBsb2RlZCBTdHJpbmcKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5hcnJheS5lYWNoKCBrZWlnYWkudXRpbC5zdHJpbmcuZXhwbG9kZSggImFiYywgZGVmIiApLCBmdW5jdGlvbiAoIGkgKSB7CgkgKiAgIC4uLgoJICogfSApOwoJICovCglleHBsb2RlIDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQlhcmcgPSBhcmcgfHwgIiwiOwoKCQlyZXR1cm4gc3RyaW5nLnRyaW0oIG9iaiApLnNwbGl0KCBuZXcgUmVnRXhwKCAiXFxzKiIgKyBhcmcgKyAiXFxzKiIgKSApOwoJfSwKCgkvKioKCSAqIENyZWF0ZXMgYSBTdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgYW4gT2JqZWN0LCBwcmVzZXJ2aW5nIEZ1bmN0aW9ucwoJICoKCSAqIE5lc3RlZCBPYmplY3RzIGFyZSBub3Qgc3VwcG9ydGVkCgkgKgoJICogQG1ldGhvZCBmcm9tT2JqZWN0CgkgKiBAbWVtYmVyT2Ygc3RyaW5nCgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiAgT2JqZWN0IHRvIGNvbnZlcnQKCSAqIEBwYXJhbSAge1N0cmluZ30gbmFtZSBbT3B0aW9uYWxdIE5hbWUgb2YgT2JqZWN0CgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgU3RyaW5nIHJlcHJlc2VudGF0aW9uCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuc3RyaW5nLmZyb21PYmplY3QoIHthOiB0cnVlLCBiOiBmYWxzZX0sICJzdGF0cyIgKTsgLy8gInN0YXRzID0geydhJzogdHJ1ZSwnYic6ZmFsc2V9IgoJICovCglmcm9tT2JqZWN0IDogZnVuY3Rpb24gKCBvYmosIG5hbWUgKSB7CgkJdmFyIHJlc3VsdCA9ICggbmFtZSA/IG5hbWUgKyAiID0geyIgOiAieyIgKSArICJcbiI7CgoJCXV0aWxpdHkuaXRlcmF0ZSggb2JqLCBmdW5jdGlvbiAoIHYsIGsgKSB7CgkJCXJlc3VsdCArPSAiXCIiICsgayArICJcIjoiICsgdi50b1N0cmluZygpICsgIixcbiI7CgkJfSApOwoKCQlyZXN1bHQgPSByZXN1bHQucmVwbGFjZSggL1xbb2JqZWN0IE9iamVjdFxdL2csICJ7fSIgKS5yZXBsYWNlKCAvLFxuJC8sICJcbiIgKSArICJ9IjsKCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBSZXBsYWNlcyBhbGwgc3BhY2VzIGluIGEgc3RyaW5nIHdpdGggZGFzaGVzCgkgKgoJICogQG1ldGhvZCBoeXBoZW5hdGUKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gb2JqICAgU3RyaW5nIHRvIGh5cGhlbmF0ZQoJICogQHBhcmFtIHtCb29sZWFufSBjYW1lbCBbT3B0aW9uYWxdIEh5cGhlbmF0ZSBjYW1lbENhc2UKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgICAgU3RyaW5nIHdpdGggZGFzaGVzIGluc3RlYWQgb2Ygc3BhY2VzCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuc3RyaW5nLmh5cGhlbmF0ZSggImhlbGxvIHdvcmxkIiApOyAvLyAiaGVsbG8td29ybGQiCgkgKi8KCWh5cGhlbmF0ZSA6IGZ1bmN0aW9uICggb2JqLCBjYW1lbCApIHsKCQl2YXIgcmVzdWx0ID0gc3RyaW5nLnRyaW0oIG9iaiApLnJlcGxhY2UoIC9ccysvZywgIi0iICk7CgoJCWlmICggY2FtZWwgPT09IHRydWUgKSB7CgkJCXJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKCAvKFtBLVpdKS9nLCAiLSQxIiApLnRvTG93ZXJDYXNlKCk7CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIFRlc3RzIGlmIGEgc3RyaW5nIGlzIGEgYm9vbGVhbgoJICoKCSAqIEBtZXRob2QgaXNCb29sZWFuCgkgKiBAbWVtYmVyT2Ygc3RyaW5nCgkgKiBAcGFyYW0gIHtTdHJpbmd9ICBvYmogU3RyaW5nIHRvIHRlc3QKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgICBSZXN1bHQgb2YgdGVzdAoJICogQGV4YW1wbGUKCSAqIGlmICgga2VpZ2FpLnV0aWwuc3RyaW5nLmlzQm9vbGVhbiggLi4uICkgewoJICogICAuLi4KCSAqIH0gKTsKCSAqLwoJaXNCb29sZWFuIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIHJlZ2V4LmJvb2wudGVzdCggb2JqICk7Cgl9LAoKCS8qKgoJICogVGVzdHMgaWYgYSBzdHJpbmcgaXMgZW1wdHkKCSAqCgkgKiBAbWV0aG9kIGlzRW1wdHkKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gIG9iaiBTdHJpbmcgdG8gdGVzdAoJICogQHJldHVybiB7Qm9vbGVhbn0gICAgIFJlc3VsdCBvZiB0ZXN0CgkgKiBAZXhhbXBsZQoJICogaWYgKCAha2VpZ2FpLnV0aWwuc3RyaW5nLmlzRW1wdHkoIC4uLiApIHsKCSAqICAgLi4uCgkgKiB9ICk7CgkgKi8KCWlzRW1wdHkgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gc3RyaW5nLnRyaW0oIG9iaiApID09PSAiIjsKCX0sCgoJLyoqCgkgKiBUZXN0cyBpZiBhIHN0cmluZyBpcyBhIG51bWJlcgoJICoKCSAqIEBtZXRob2QgaXNOdW1iZXIKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gIG9iaiBTdHJpbmcgdG8gdGVzdAoJICogQHJldHVybiB7Qm9vbGVhbn0gICAgIFJlc3VsdCBvZiB0ZXN0CgkgKiBAZXhhbXBsZQoJICogaWYgKCBrZWlnYWkudXRpbC5zdHJpbmcuaXNOdW1iZXIoIC4uLiApIHsKCSAqICAgLi4uCgkgKiB9ICk7CgkgKi8KCWlzTnVtYmVyIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIHJlZ2V4Lm51bWJlci50ZXN0KCBvYmogKTsKCX0sCgoJLyoqCgkgKiBUZXN0cyBpZiBhIHN0cmluZyBpcyBhIFVSTAoJICoKCSAqIEBtZXRob2QgaXNVcmwKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gIG9iaiBTdHJpbmcgdG8gdGVzdAoJICogQHJldHVybiB7Qm9vbGVhbn0gICAgIFJlc3VsdCBvZiB0ZXN0CgkgKiBAZXhhbXBsZQoJICogaWYgKCBrZWlnYWkudXRpbC5zdHJpbmcuaXNVcmwoIC4uLiApIHsKCSAqICAgLi4uCgkgKiB9ICk7CgkgKi8KCWlzVXJsIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIHJlZ2V4LnVybC50ZXN0KCBvYmogKTsKCX0sCgoJLyoqCgkgKiBUcmFuc2Zvcm1zIHRoZSBjYXNlIG9mIGEgU3RyaW5nIGludG8gQ2FtZWxDYXNlCgkgKgoJICogQG1ldGhvZCB0b0NhbWVsQ2FzZQoJICogQG1lbWJlck9mIHN0cmluZwoJICogQHBhcmFtICB7U3RyaW5nfSBvYmogU3RyaW5nIHRvIGNhcGl0YWxpemUKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgIENhbWVsIGNhc2UgU3RyaW5nCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuc3RyaW5nLnRvQ2FtZWxDYXNlKCAiaGVsbG8gd29ybGQiICk7IC8vICJoZWxsb1dvcmxkIgoJICovCgl0b0NhbWVsQ2FzZSA6IGZ1bmN0aW9uICggb2JqICkgewoJCXZhciBzID0gc3RyaW5nLnRyaW0oIG9iaiApLnJlcGxhY2UoIC9cLnxffC18XEB8XFt8XF18XCh8XCl8XCN8XCR8XCV8XF58XCZ8XCp8XHMrL2csICIgIiApLnRvTG93ZXJDYXNlKCkuc3BsaXQoIHJlZ2V4LnNwYWNlX2h5cGhlbiApLAoJCSAgICByID0gW107CgoJCWFycmF5LmVhY2goIHMsIGZ1bmN0aW9uICggaSwgaWR4ICkgewoJCQlyLnB1c2goIGlkeCA9PT0gMCA/IGkgOiBzdHJpbmcuY2FwaXRhbGl6ZSggaSApICk7CgkJfSk7CgoJCXJldHVybiByLmpvaW4oICIiICk7Cgl9LAoKCS8qKgoJICogUmV0dXJucyBzaW5ndWxhciBmb3JtIG9mIHRoZSBzdHJpbmcKCSAqCgkgKiBAbWV0aG9kIHNpbmd1bGFyCgkgKiBAbWVtYmVyT2Ygc3RyaW5nCgkgKiBAcGFyYW0gIHtTdHJpbmd9IG9iaiBTdHJpbmcgdG8gdHJhbnNmb3JtCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICBUcmFuc2Zvcm1lZCBzdHJpbmcKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5zdHJpbmcuc2luZ3VsYXIoICJjYW5zIiApOyAvLyAiY2FuIgoJICovCglzaW5ndWxhciA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBvYmoucmVwbGFjZSggL29lP3MkLywgIm8iICkucmVwbGFjZSggL2llcyQvLCAieSIgKS5yZXBsYWNlKCAvc2VzJC8sICJzZSIgKS5yZXBsYWNlKCAvcyQvLCAiIiApOwoJfSwKCgkvKioKCSAqIENhc3RzIGEgU3RyaW5nIHRvIGEgRnVuY3Rpb24KCSAqCgkgKiBAbWV0aG9kIHRvRnVuY3Rpb24KCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gb2JqIFN0cmluZyB0byBjYXN0CgkgKiBAcmV0dXJuIHtGdW5jdGlvbn0gICBGdW5jdGlvbgoJICogQGV4YW1wbGUKCSAqIHZhciBmbiA9IHNvbWVGdW5jdGlvbi50b1N0cmluZygpOwoJICoKCSAqIC4uLgoJICoKCSAqIHZhciBmdW5jID0ga2VpZ2FpLnV0aWwuc3RyaW5nLnRvRnVuY3Rpb24oIGZuICk7CgkgKi8KCXRvRnVuY3Rpb24gOiBmdW5jdGlvbiAoIG9iaiApIHsKCQl2YXIgYXJncyA9IHN0cmluZy50cmltKCBvYmoucmVwbGFjZSggL14uKlwoLywgIiIgKS5yZXBsYWNlKCAvW1x0fFxyfFxufFwifFwnXSsvZywgIiIgKS5yZXBsYWNlKCAvXCkuKi8sICIiICkgKSwKCQkgICAgYm9keSA9IHN0cmluZy50cmltKCBvYmoucmVwbGFjZSggL14uKlx7LywgIiIgKS5yZXBsYWNlKCAvXH0kLywgIiIgKSApOwoKCQlyZXR1cm4gRnVuY3Rpb24uYXBwbHkoIEZ1bmN0aW9uLCBzdHJpbmcuZXhwbG9kZSggYXJncyApLmNvbmNhdCggW2JvZHldICkgKTsKCX0sCgoJLyoqCgkgKiBUcmltcyB0aGUgd2hpdGVzcGFjZSBhcm91bmQgYSBTdHJpbmcKCSAqCgkgKiBAbWV0aG9kIHRyaW0KCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gb2JqIFN0cmluZyB0byBjYXBpdGFsaXplCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICBUcmltbWVkIFN0cmluZwoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLnN0cmluZy50cmltKCAiICBoZWxsbyB3b3JsZCAiICk7IC8vICJoZWxsbyB3b3JsZCIKCSAqLwoJdHJpbSA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiBvYmoucmVwbGFjZSggL14oXHMrfFx0K3xcbispfChccyt8XHQrfFxuKykkL2csICIiICk7Cgl9LAoKCS8qKgoJICogVW5jYW1lbGNhc2VzIHRoZSBTdHJpbmcKCSAqCgkgKiBAbWV0aG9kIHVuQ2FtZWxDYXNlCgkgKiBAbWVtYmVyT2Ygc3RyaW5nCgkgKiBAcGFyYW0gIHtTdHJpbmd9IG9iaiBTdHJpbmcgdG8gdW5jYW1lbGNhc2UKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgIFVuY2FtZWxjYXNlZCBTdHJpbmcKCSAqLwoJdW5DYW1lbENhc2UgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQlyZXR1cm4gc3RyaW5nLnRyaW0oIG9iai5yZXBsYWNlKCAvKFtBLVpdKS9nLCAiICQxIiApLnRvTG93ZXJDYXNlKCkgKTsKCX0sCgoJLyoqCgkgKiBVbmNhcGl0YWxpemVzIHRoZSBTdHJpbmcKCSAqCgkgKiBAbWV0aG9kIHVuY2FwaXRhbGl6ZQoJICogQG1lbWJlck9mIHN0cmluZwoJICogQHBhcmFtICB7U3RyaW5nfSBvYmogU3RyaW5nIHRvIHVuY2FwaXRhbGl6ZQoJICogQHJldHVybiB7U3RyaW5nfSAgICAgVW5jYXBpdGFsaXplZCBTdHJpbmcKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5zdHJpbmcudW5jYXBpdGFsaXplKCAiSGVsbG8iICk7IC8vICJoZWxsbyIKCSAqLwoJdW5jYXBpdGFsaXplIDogZnVuY3Rpb24gKCBvYmogKSB7CgkJb2JqID0gc3RyaW5nLnRyaW0oIG9iaiApOwoKCQlyZXR1cm4gb2JqLmNoYXJBdCggMCApLnRvTG93ZXJDYXNlKCkgKyBvYmouc2xpY2UoIDEgKTsKCX0sCgoJLyoqCgkgKiBSZXBsYWNlcyBhbGwgaHlwaGVucyB3aXRoIHNwYWNlcwoJICoKCSAqIEBtZXRob2QgdW5oeXBoZW5hdGUKCSAqIEBtZW1iZXJPZiBzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gIG9iaiAgU3RyaW5nIHRvIHVuaHlwZW5hdGUKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGNhcHMgW09wdGlvbmFsXSBUcnVlIHRvIGNhcGl0YWxpemUgZWFjaCB3b3JkCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgIFVuaHlwaGVuYXRlZCBTdHJpbmcKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5zdHJpbmcudW5oeXBoZW5hdGUoICJoZWxsby13b3JsZCIgKTsgICAgICAgLy8gImhlbGxvIHdvcmxkIgoJICoga2VpZ2FpLnV0aWwuc3RyaW5nLnVuaHlwaGVuYXRlKCAiaGVsbG8td29ybGQiLCB0cnVlICk7IC8vICJIZWxsbyBXb3JsZCIKCSAqLwoJdW5oeXBoZW5hdGUgOiBmdW5jdGlvbiAoIG9iaiwgY2FwcyApIHsKCQlpZiAoIGNhcHMgIT09IHRydWUgKSB7CgkJCXJldHVybiBzdHJpbmcuZXhwbG9kZSggb2JqLCAiLSIgKS5qb2luKCAiICIgKTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiBzdHJpbmcuZXhwbG9kZSggb2JqLCAiLSIgKS5tYXAoIGZ1bmN0aW9uICggaSApIHsKCQkJCXJldHVybiBzdHJpbmcuY2FwaXRhbGl6ZSggaSApOwoJCQl9ICkuam9pbiggIiAiICk7CgkJfQoJfQp9OwoKLyoqCiAqIEBuYW1lc3BhY2UgdXRpbGl0eQogKi8KdmFyIHV0aWxpdHkgPSB7CgkvKioKCSAqIENvbGxlY3Rpb24gb2YgdGltZXJzCgkgKgoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEB0eXBlIHtPYmplY3R9CgkgKiBAcHJpdmF0ZQoJICovCgl0aW1lciA6IHt9LAoKCS8qKgoJICogQ29sbGVjdGlvbiBvZiByZXBlYXRpbmcgZnVuY3Rpb25zCgkgKgoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEB0eXBlIHtPYmplY3R9CgkgKiBAcHJpdmF0ZQoJICovCglyZXBlYXRpbmc6IHt9LAoKCS8qKgoJICogQ3JlYXRlcyBFbGVtZW50cyBvciBRdWVyaWVzIHRoZSBET00gdXNpbmcgQ1NTIHNlbGVjdG9ycwoJICoKCSAqIEBtZXRob2QgJAoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge01peGVkfSBhcmcgSFRNTCwgb3IgQ29tbWEgZGVsaW1pdGVkIHN0cmluZyBvZiBDU1Mgc2VsZWN0b3JzCgkgKiBAcmV0dXJuIHtBcnJheX0gICAgIEFycmF5IG9mIG1hdGNoaW5nIEVsZW1lbnRzCgkgKiBAZXhhbXBsZQoJICogdmFyICQgPSBrZWlnYWkudXRpbC4kOwoJICoKCSAqIC8vIExvb2tpbmcgZm9yIEVsZW1lbnRzCgkgKiAkKCAiLnNvbWVDbGFzcyIgKS5mb3JFYWNoKCBmdW5jdGlvbiAoIGkgKSB7CgkgKiAgIC4uLgoJICogfSApOwoJICoKCSAqIC8vIENyZWF0aW5nIGFuIEgxIEVsZW1lbnQKCSAqICQoICImbHQ7aDEmZ3Q7IiApLmZvckVhY2goIGZ1bmN0aW9uICggaSApIHsKCSAqICAgLi4uCgkgKiB9ICk7CgkgKi8KCSQgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQl2YXIgcmVzdWx0OwoKCQkvLyBOb3RoaW5nCgkJaWYgKCAhYXJnICkgewoJCX0KCQkvLyBIVE1MCgkJZWxzZSBpZiAoIHJlZ2V4Lmh0bWwudGVzdCggYXJnICkgKSB7CgkJCXJlc3VsdCA9IFtlbGVtZW50LmNyZWF0ZSggYXJnICldOwoJCX0KCQkvLyBDU1Mgc2VsZWN0b3IocykKCQllbHNlIHsKCQkJYXJnID0gc3RyaW5nLnRyaW0oIGFyZyApOwoKCQkJaWYgKCBhcmcuaW5kZXhPZiggIiwiICkgPT09IC0xICkgewoJCQkJcmVzdWx0ID0gdXRpbGl0eS5kb20oIGFyZyApOwoKCQkJCWlmICggcmVzdWx0ICkgewoJCQkJCWlmICggaXNOYU4oIHJlc3VsdC5sZW5ndGggKSApIHsKCQkJCQkJcmVzdWx0ID0gW3Jlc3VsdF07CgkJCQkJfQoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJcmVzdWx0ID0gW107CgkJCQl9CgkJCX0KCQkJZWxzZSB7CgkJCQlyZXN1bHQgPSBbXTsKCgkJCQlhcnJheS5lYWNoKCBzdHJpbmcuZXhwbG9kZSggYXJnICksIGZ1bmN0aW9uICggcXVlcnkgKSB7CgkJCQkJdmFyIG9iaiA9IHV0aWxpdHkuZG9tKCBxdWVyeSApOwoKCQkJCQlpZiAoIG9iaiBpbnN0YW5jZW9mIEFycmF5ICkgewoJCQkJCQlyZXN1bHQgPSByZXN1bHQuY29uY2F0KCBvYmogKTsKCQkJCQl9CgkJCQkJZWxzZSBpZiAoIG9iaiApIHsKCQkJCQkJcmVzdWx0LnB1c2goIG9iaiApOwoJCQkJCX0KCQkJCX0gKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGFuIGluc3RhbmNlIG9mIEJhc2UKCSAqCgkgKiBAbWV0aG9kIGJhc2UKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtPYmplY3R9IGFyZyBbT3B0aW9uYWxdIERlY29yYXRpdmUgT2JqZWN0CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBJbnN0YW5jZSBvZiBCYXNlCgkgKi8KCWJhc2UgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQl2YXIgb2JqID0gbmV3IEJhc2UoKTsKCgkJaWYgKCBhcmcgaW5zdGFuY2VvZiBPYmplY3QgKSB7CgkJCXV0aWxpdHkubWVyZ2UoIG9iaiwgYXJnICk7CgkJfQoKCQlvYmoub2JzZXJ2ZXIgPSBvYnNlcnZhYmxlLmZhY3RvcnkoKTsKCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBCbG9iIGZhY3RvcnkKCSAqCgkgKiBAbWV0aG9kIGJsb2IKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBTdHJpbmcgdG8gY29udmVydCB0byBhIEJsb2IKCSAqIEByZXR1cm4ge09iamVjdH0gICAgIEJsb2IKCSAqIEBwcml2YXRlCgkgKi8KCWJsb2IgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQl2YXIgb2JqOwoKCQl0cnkgewoJCQlvYmogPSBuZXcgQmxvYiggW2FyZ10sIHt0eXBlOiAiYXBwbGljYXRpb24vamF2YXNjcmlwdCJ9ICk7CgkJfQoJCWNhdGNoICggZSApIHsKCQkJaWYgKCAhZ2xvYmFsLkJsb2JCdWlsZGVyICkgewoJCQkJZ2xvYmFsLkJsb2JCdWlsZGVyID0gZ2xvYmFsLk1TQmxvYkJ1aWxkZXIgfHwgZ2xvYmFsLldlYktpdEJsb2JCdWlsZGVyIHx8IGdsb2JhbC5Nb3pCbG9iQnVpbGRlcjsKCQkJfQoKCQkJb2JqID0gbmV3IGdsb2JhbC5CbG9iQnVpbGRlcigpLmFwcGVuZCggYXJnICkuZ2V0QmxvYigpOwoJCX0KCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBDbGVhcnMgZGVmZXJyZWQgJiByZXBlYXRpbmcgZnVuY3Rpb25zCgkgKgoJICogQG1ldGhvZCBjbGVhclRpbWVycwoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge1N0cmluZ30gaWQgSUQgb2YgdGltZXIoIHMgKQoJICogQHJldHVybiB7VW5kZWZpbmVkfSB1bmRlZmluZWQKCSAqIEBwcml2YXRlCgkgKi8KCWNsZWFyVGltZXJzIDogZnVuY3Rpb24gKCBpZCApIHsKCQlpZiAoIGlkID09PSB1bmRlZmluZWQgfHwgc3RyaW5nLmlzRW1wdHkoIGlkICkgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuaW52YWxpZEFyZ3VtZW50cyApOwoJCX0KCgkJLy8gZGVmZXJyZWQKCQlpZiAoIHV0aWxpdHkudGltZXJbaWRdICkgewoJCQljbGVhclRpbWVvdXQoIHV0aWxpdHkudGltZXJbaWRdICk7CgkJCWRlbGV0ZSB1dGlsaXR5LnRpbWVyW2lkXTsKCQl9CgoJCS8vIHJlcGVhdGluZwoJCWlmICggdXRpbGl0eS5yZXBlYXRpbmdbaWRdICkgewoJCQljbGVhclRpbWVvdXQoIHV0aWxpdHkucmVwZWF0aW5nW2lkXSApOwoJCQlkZWxldGUgdXRpbGl0eS5yZXBlYXRpbmdbaWRdOwoJCX0KCX0sCgoJLyoqCgkgKiBDbG9uZXMgYW4gT2JqZWN0CgkgKgoJICogQG1ldGhvZCBjbG9uZQoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge09iamVjdH0gIG9iaiAgICAgT2JqZWN0IHRvIGNsb25lCgkgKiBAcGFyYW0gIHtCb29sZWFufSBzaGFsbG93IFtPcHRpb25hbF0gQ3JlYXRlIGEgc2hhbGxvdyBjbG9uZSwgd2hpY2ggZG9lc24ndCBtYWludGFpbiBwcm90b3R5cGVzLCBkZWZhdWx0IGlzIGBmYWxzZWAKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgICAgQ2xvbmUgb2Ygb2JqCgkgKiBAZXhhbXBsZQoJICogdmFyIHggPSB7YTogdHJ1ZSwgYjogZmFsc2V9LAoJICogICAgIHkgPSBrZWlnYWkudXRpbC5jbG9uZSggeCwgdHJ1ZSApOwoJICoKCSAqIHkuYTsgLy8gdHJ1ZQoJICovCgljbG9uZSA6IGZ1bmN0aW9uICggb2JqLCBzaGFsbG93ICkgewoJCXZhciBjbG9uZTsKCgkJaWYgKCBzaGFsbG93ID09PSB0cnVlICkgewoJCQlyZXR1cm4gb2JqICE9PSB1bmRlZmluZWQgJiYgb2JqICE9PSBudWxsID8ganNvbi5kZWNvZGUoIGpzb24uZW5jb2RlKCBvYmogKSApIDogb2JqOwoJCX0KCQllbHNlIGlmICggIW9iaiB8fCByZWdleC5wcmltaXRpdmUudGVzdCggdHlwZW9mIG9iaiApIHx8ICggb2JqIGluc3RhbmNlb2YgUmVnRXhwICkgKSB7CgkJCXJldHVybiBvYmo7CgkJfQoJCWVsc2UgaWYgKCBvYmogaW5zdGFuY2VvZiBBcnJheSApIHsKCQkJcmV0dXJuIG9iai5zbGljZSgpOwoJCX0KCQllbHNlIGlmICggIXNlcnZlciAmJiAhY2xpZW50LmllICYmIG9iaiBpbnN0YW5jZW9mIERvY3VtZW50ICkgewoJCQlyZXR1cm4geG1sLmRlY29kZSggeG1sLmVuY29kZSggb2JqICkgKTsKCQl9CgkJZWxzZSBpZiAoIHR5cGVvZiBvYmouX19wcm90b19fICE9ICJ1bmRlZmluZWQiICkgewoJCQlyZXR1cm4gdXRpbGl0eS5leHRlbmQoIG9iai5fX3Byb3RvX18sIG9iaiApOwoJCX0KCQllbHNlIGlmICggb2JqIGluc3RhbmNlb2YgT2JqZWN0ICkgewoJCQkvLyBJZiBKU09OIGVuY29kaW5nIGZhaWxzIGR1ZSB0byByZWN1cnNpb24sIHRoZSBvcmlnaW5hbCBPYmplY3QgaXMgcmV0dXJuZWQgYmVjYXVzZSBpdCdzIGFzc3VtZWQgdGhpcyBpcyBmb3IgZGVjb3JhdGlvbgoJCQljbG9uZSA9IGpzb24uZW5jb2RlKCBvYmosIHRydWUgKTsKCgkJCWlmICggY2xvbmUgIT09IHVuZGVmaW5lZCApIHsKCQkJCWNsb25lID0ganNvbi5kZWNvZGUoIGNsb25lICk7CgoJCQkJLy8gRGVjb3JhdGluZyBGdW5jdGlvbnMgdGhhdCB3b3VsZCBiZSBsb3N0IHdpdGggSlNPTiBlbmNvZGluZy9kZWNvZGluZwoJCQkJdXRpbGl0eS5pdGVyYXRlKCBvYmosIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCQlpZiAoIHR5cGVvZiB2ID09ICJmdW5jdGlvbiIgKSB7CgkJCQkJCWNsb25lW2tdID0gdjsKCQkJCQl9CgkJCQl9ICk7CgkJCX0KCQkJZWxzZSB7CgkJCQljbG9uZSA9IG9iajsKCQkJfQoKCQkJcmV0dXJuIGNsb25lOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIG9iajsKCQl9Cgl9LAoKCS8qKgoJICogQ29lcmNlcyBhIFN0cmluZyB0byBhIFR5cGUKCSAqCgkgKiBAbWV0aG9kIGNvZXJjZQoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge1N0cmluZ30gdmFsdWUgU3RyaW5nIHRvIGNvZXJjZQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgICBQcmltaXRpdmUgdmVyc2lvbiBvZiB0aGUgU3RyaW5nCgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuY29lcmNlKCAiMSIgKTsgLy8gMQoJICovCgljb2VyY2UgOiBmdW5jdGlvbiAoIHZhbHVlICkgewoJCXZhciB0bXA7CgoJCWlmICggdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9CgkJZWxzZSBpZiAoIHZhbHVlID09PSAidHJ1ZSIgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCQllbHNlIGlmICggdmFsdWUgPT09ICJmYWxzZSIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJZWxzZSBpZiAoIHZhbHVlID09PSAibnVsbCIgKSB7CgkJCXJldHVybiBudWxsOwoJCX0KCQllbHNlIGlmICggdmFsdWUgPT09ICJ1bmRlZmluZWQiICkgewoJCQlyZXR1cm4gdW5kZWZpbmVkOwoJCX0KCQllbHNlIGlmICggdmFsdWUgPT09ICIiICkgewoJCQlyZXR1cm4gdmFsdWU7CgkJfQoJCWVsc2UgaWYgKCAhaXNOYU4oIHRtcCA9IE51bWJlciggdmFsdWUgKSApICkgewoJCQlyZXR1cm4gdG1wOwoJCX0KCQllbHNlIGlmICggcmVnZXguanNvbl93cmFwLnRlc3QoIHZhbHVlICkgKSB7CgkJCXJldHVybiBqc29uLmRlY29kZSggdmFsdWUsIHRydWUgKSB8fCB2YWx1ZTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiB2YWx1ZTsKCQl9Cgl9LAoKCS8qKgoJICogUmVjb21waWxlcyBhIFJlZ0V4cCBieSByZWZlcmVuY2UKCSAqCgkgKiBUaGlzIGlzIGlkZWFsIHdoZW4geW91IG5lZWQgdG8gcmVjb21waWxlIGEgcmVnZXggZm9yIHVzZSB3aXRoaW4gYSBjb25kaXRpb25hbCBzdGF0ZW1lbnQKCSAqCgkgKiBAbWV0aG9kIGNvbXBpbGUKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtPYmplY3R9IHJlZ2V4ICAgICBSZWdFeHAKCSAqIEBwYXJhbSAge1N0cmluZ30gcGF0dGVybiAgIFJlZ3VsYXIgZXhwcmVzc2lvbiBwYXR0ZXJuCgkgKiBAcGFyYW0gIHtTdHJpbmd9IG1vZGlmaWVycyBNb2RpZmllcnMgdG8gYXBwbHkgdG8gdGhlIHBhdHRlcm4KCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgICAgICAgIHRydWUKCSAqIEBwcml2YXRlCgkgKi8KCWNvbXBpbGUgOiBmdW5jdGlvbiAoIHJlZywgcGF0dGVybiwgbW9kaWZpZXJzICkgewoJCXJlZy5jb21waWxlKCBwYXR0ZXJuLCBtb2RpZmllcnMgKTsKCgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qKgoJICogQ3VycmllcyBhIEZ1bmN0aW9uCgkgKgoJICogTm90ZTogRnVuY3Rpb24gdG8gY3VycnkgbXVzdCByZXR1cm4gYSBGdW5jdGlvbgoJICoKCSAqIEBtZXRob2QgY3VycnkKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcmV0dXJuIHtGdW5jdGlvbn0gQ3VycmllZCBGdW5jdGlvbgoJICogQGV4YW1wbGUKCSAqIGZ1bmN0aW9uIGYgKCBhLCBiICkgewoJICogICByZXR1cm4gZnVuY3Rpb24gKCBuICkgewoJICogICAgIHJldHVybiAoIGEgKyBiICkgKiBuOwoJICogICB9OwoJICogfQoJICoKCSAqIHZhciBnID0ga2VpZ2FpLnV0aWwuY3VycnkoIGYsIDIsIDggKTsKCSAqCgkgKiBnKCA1ICk7IC8vIDUwCgkgKi8KCWN1cnJ5IDogZnVuY3Rpb24gKCkgewoJCXZhciBhcmdzID0gYXJyYXkuY2FzdCggYXJndW1lbnRzICksCgkJICAgIGZuICAgPSBhcmdzLnNoaWZ0KCksCgkJICAgIGNmbiAgPSBmbi5hcHBseSggZm4sIGFyZ3MgKTsKCgkJcmV0dXJuIGZ1bmN0aW9uICgpIHsKCQkJcmV0dXJuIGNmbi5hcHBseSggY2ZuLCBhcmd1bWVudHMgKTsKCQl9OwoJfSwKCgkvKioKCSAqIERlZmVycyB0aGUgZXhlY3V0aW9uIG9mIEZ1bmN0aW9uIGJ5IGF0IGxlYXN0IHRoZSBzdXBwbGllZCBtaWxsaXNlY29uZHMuCgkgKiBUaW1pbmcgbWF5IHZhcnkgdW5kZXIgImhlYXZ5IGxvYWQiIHJlbGF0aXZlIHRvIHRoZSBDUFUgJiBjbGllbnQgSmF2YVNjcmlwdCBlbmdpbmUuCgkgKgoJICogQG1ldGhvZCBkZWZlcgoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiAgICAgRnVuY3Rpb24gdG8gZGVmZXIgZXhlY3V0aW9uIG9mCgkgKiBAcGFyYW0gIHtOdW1iZXJ9ICAgbXMgICAgIE1pbGxpc2Vjb25kcyB0byBkZWZlciBleGVjdXRpb24KCSAqIEBwYXJhbSAge051bWJlcn0gICBpZCAgICAgW09wdGlvbmFsXSBJRCBvZiB0aGUgZGVmZXJyZWQgZnVuY3Rpb24KCSAqIEBwYXJhbSAge0Jvb2xlYW59ICByZXBlYXQgW09wdGlvbmFsXSBEZXNjcmliZXMgdGhlIGV4ZWN1dGlvbiwgZGVmYXVsdCBpcyBgZmFsc2VgCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgICAgIElEIG9mIHRoZSB0aW1lcgoJICogQHByaXZhdGUKCSAqLwoJZGVmZXIgOiBmdW5jdGlvbiAoIGZuLCBtcywgaWQsIHJlcGVhdCApIHsKCQl2YXIgb3A7CgoJCW1zICAgICA9IG1zIHx8IDA7CgkJcmVwZWF0ID0gKCByZXBlYXQgPT09IHRydWUgKTsKCgkJaWYgKCBpZCAhPT0gdW5kZWZpbmVkICkgewoJCQl1dGlsaXR5LmNsZWFyVGltZXJzKCBpZCApOwoJCX0KCQllbHNlIHsKCQkJaWQgPSB1dGlsaXR5LnV1aWQoIHRydWUgKTsKCQl9CgoJCW9wID0gZnVuY3Rpb24gKCkgewoJCQl1dGlsaXR5LmNsZWFyVGltZXJzKCBpZCApOwoJCQlmbigpOwoJCX07CgoJCXV0aWxpdHlbcmVwZWF0ID8gInJlcGVhdGluZyIgOiAidGltZXIiXVtpZF0gPSBzZXRUaW1lb3V0KCBvcCwgbXMgKTsKCgkJcmV0dXJuIGlkOwoJfSwKCgkvKioKCSAqIEFzeW5jIGRlbGF5IHN0cmF0ZWd5CgkgKgoJICogQG1ldGhvZCBkZWxheQoJICogQG1lbWJlck9mIHByb21pc2UKCSAqIEByZXR1cm4ge0Z1bmN0aW9ufSBEZWxheSBtZXRob2QKCSAqIEBwcml2YXRlCgkgKi8KCWRlbGF5IDogZnVuY3Rpb24gKCkgewoJCWlmICggdHlwZW9mIHNldEltbWVkaWF0ZSAhPSAidW5kZWZpbmVkIiApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uICggYXJnICkgewoJCQkJc2V0SW1tZWRpYXRlKCBhcmcgKTsKCQkJfTsKCQl9CgkJZWxzZSBpZiAoIHR5cGVvZiBwcm9jZXNzICE9ICJ1bmRlZmluZWQiICkgewoJCQlyZXR1cm4gcHJvY2Vzcy5uZXh0VGljazsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCXNldFRpbWVvdXQoIGFyZywgMCApOwoJCQl9OwoJCX0KCX0oKSwKCgkvKioKCSAqIFF1ZXJpZXMgRE9NIHdpdGggZmFzdGVzdCBtZXRob2QKCSAqCgkgKiBAbWV0aG9kIGRvbQoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnIERPTSBxdWVyeQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgdW5kZWZpbmVkLCBFbGVtZW50LCBvciBBcnJheSBvZiBFbGVtZW50cwoJICogQHByaXZhdGUKCSAqLwoJZG9tIDogZnVuY3Rpb24gKCBhcmcgKSB7CgkJdmFyIHJlc3VsdDsKCgkJaWYgKCAhcmVnZXguc2VsZWN0b3JfY29tcGxleC50ZXN0KCBhcmcgKSApIHsKCQkJaWYgKCByZWdleC5oYXNoLnRlc3QoIGFyZyApICkgewoJCQkJcmVzdWx0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIGFyZy5yZXBsYWNlKCByZWdleC5oYXNoLCAiIiApICkgfHwgdW5kZWZpbmVkOwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5rbGFzcy50ZXN0KCBhcmcgKSApIHsKCQkJCXJlc3VsdCA9IGFycmF5LmNhc3QoIGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIGFyZy5yZXBsYWNlKCByZWdleC5rbGFzcywgIiIgKSApICk7CgkJCX0KCQkJZWxzZSBpZiAoIHJlZ2V4LndvcmQudGVzdCggYXJnICkgKSB7CgkJCQlyZXN1bHQgPSBhcnJheS5jYXN0KCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSggYXJnICkgKTsKCQkJfQoJCQllbHNlIHsKCQkJCXJlc3VsdCA9IGFycmF5LmNhc3QoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIGFyZyApICk7CgkJCX0KCQl9CgkJZWxzZSB7CgkJCXJlc3VsdCA9IGFycmF5LmNhc3QoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIGFyZyApICk7CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIEVuY29kZXMgYSBVVUlEIHRvIGEgRE9NIGZyaWVuZGx5IElECgkgKgoJICogQG1ldGhvZCBkb21JZAoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge1N0cmluZ30gVVVJRAoJICogQHJldHVybiB7U3RyaW5nfSBET00gZnJpZW5kbHkgSUQKCSAqIEBwcml2YXRlCgkgKi8KCWRvbUlkIDogZnVuY3Rpb24gKCBhcmcgKSB7CgkJcmV0dXJuICJhIiArIGFyZy5yZXBsYWNlKCAvLS9nLCAiIiApLnNsaWNlKCAxICk7Cgl9LAoKCS8qKgoJICogRXJyb3IgaGFuZGxpbmcsIHdpdGggaGlzdG9yeSBpbiBgZXJyb3IubG9nYAoJICoKCSAqIEBtZXRob2QgZXJyb3IKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtNaXhlZH0gICBlICAgICAgIEVycm9yIG9iamVjdCBvciBtZXNzYWdlIHRvIGRpc3BsYXkKCSAqIEBwYXJhbSAge0FycmF5fSAgIGFyZ3MgICAgQXJyYXkgb2YgYXJndW1lbnRzIGZyb20gdGhlIGNhbGxzdGFjawoJICogQHBhcmFtICB7TWl4ZWR9ICAgc2NvcGUgICBFbnRpdHkgdGhhdCB3YXMgInRoaXMiCgkgKiBAcGFyYW0gIHtCb29sZWFufSB3YXJuaW5nIFtPcHRpb25hbF0gV2lsbCBkaXNwbGF5IGFzIGNvbnNvbGUgd2FybmluZyBpZiB0cnVlCgkgKiBAcmV0dXJuIHtVbmRlZmluZWR9ICAgICAgIHVuZGVmaW5lZAoJICogQHByaXZhdGUKCSAqLwoJZXJyb3IgOiBmdW5jdGlvbiAoIGUsIGFyZ3MsIHNjb3BlLCB3YXJuaW5nICkgewoJCXZhciBvID0gewoJCQkiYXJndW1lbnRzIiA6IGFyZ3MgPyBhcnJheS5jYXN0KCBhcmdzICkgOiBbXSwKCQkJbWVzc2FnZSAgICAgOiBlLm1lc3NhZ2UgfHwgZSwKCQkJbnVtYmVyICAgICAgOiBlLm51bWJlciA/ICggZS5udW1iZXIgJiAweEZGRkYgKSA6IHVuZGVmaW5lZCwKCQkJc2NvcGUgICAgICAgOiBzY29wZSwKCQkJc3RhY2sgICAgICAgOiBlLnN0YWNrIHx8IHVuZGVmaW5lZCwKCQkJdGltZXN0YW1wICAgOiBuZXcgRGF0ZSgpLnRvVVRDU3RyaW5nKCksCgkJCXR5cGUgICAgICAgIDogZS50eXBlIHx8ICJUeXBlRXJyb3IiCgkJfTsKCgkJdXRpbGl0eS5sb2coIG8uc3RhY2sgfHwgby5tZXNzYWdlLCB3YXJuaW5nICE9PSB0cnVlID8gImVycm9yIiA6ICJ3YXJuIiApOwoKCQlyZXR1cm4gdW5kZWZpbmVkOwoJfSwKCgkvKioKCSAqIENyZWF0ZXMgYSAiY2xhc3MiIGV4dGVuZGluZyBPYmplY3QsIHdpdGggb3B0aW9uYWwgZGVjb3JhdGlvbgoJICoKCSAqIEBtZXRob2QgZXh0ZW5kCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogT2JqZWN0IHRvIGV4dGVuZAoJICogQHBhcmFtICB7T2JqZWN0fSBhcmcgW09wdGlvbmFsXSBPYmplY3QgZm9yIGRlY29yYXRpb24KCSAqIEByZXR1cm4ge09iamVjdH0gICAgIERlY29yYXRlZCBvYmoKCSAqIEBleGFtcGxlCgkgKiB2YXIgZXh0ZW5kT2JqID0ga2VpZ2FpLnV0aWwuZXh0ZW5kKCBzb21lT2JqLCB7bmV3UHJvcGVydHk6IHZhbHVlfSApOwoJICovCglleHRlbmQgOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCXZhciBvOwoKCQlpZiAoIG9iaiA9PT0gdW5kZWZpbmVkICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCQl9CgoJCW8gPSBPYmplY3QuY3JlYXRlKCBvYmogKTsKCgkJaWYgKCBhcmcgaW5zdGFuY2VvZiBPYmplY3QgKSB7CgkJCXV0aWxpdHkubWVyZ2UoIG8sIGFyZyApOwoJCX0KCgkJcmV0dXJuIG87Cgl9LAoKCS8qKgoJICogR2VuZXJhdGVzIGFuIElEIHZhbHVlCgkgKgoJICogQG1ldGhvZCBnZW5JZAoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge01peGVkfSAgIG9iaiBbT3B0aW9uYWxdIE9iamVjdCB0byByZWNlaXZlIGlkCgkgKiBAcGFyYW0gIHtCb29sZWFufSBkb20gW09wdGlvbmFsXSBWZXJpZnkgdGhlIElEIGlzIHVuaXF1ZSBpbiB0aGUgRE9NLCBkZWZhdWx0IGlzIGZhbHNlCgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgICAgT2JqZWN0IG9yIGlkCgkgKiBAcHJpdmF0ZQoJICovCglnZW5JZCA6IGZ1bmN0aW9uICggb2JqLCBkb20gKSB7CgkJZG9tID0gKCBkb20gPT09IHRydWUgKTsKCQl2YXIgaWQ7CgoJCWlmICggb2JqICYmICggb2JqLmlkIHx8ICggb2JqIGluc3RhbmNlb2YgQXJyYXkgKSB8fCAoIHR5cGVvZiBvYmogPT0gInN0cmluZyIgfHwgb2JqIGluc3RhbmNlb2YgU3RyaW5nICkgKSApIHsKCQkJcmV0dXJuIG9iajsKCQl9CgoJCWlmICggZG9tICkgewoJCQlkbyB7CgkJCQlpZCA9IHV0aWxpdHkuZG9tSWQoIHV0aWxpdHkudXVpZCggdHJ1ZSApICk7CgkJCX0KCQkJd2hpbGUgKCB1dGlsaXR5LmRvbSggIiMiICsgaWQgKSApOwoJCX0KCQllbHNlIHsKCQkJaWQgPSB1dGlsaXR5LmRvbUlkKCB1dGlsaXR5LnV1aWQoIHRydWUgKSApOwoJCX0KCgkJaWYgKCB0eXBlb2Ygb2JqID09ICJvYmplY3QiICkgewoJCQlvYmouaWQgPSBpZDsKCgkJCXJldHVybiBvYmo7CgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gaWQ7CgkJfQoJfSwKCgkvKioKCSAqIEl0ZXJhdGVzIGFuIE9iamVjdCBhbmQgZXhlY3V0ZXMgYSBmdW5jdGlvbiBhZ2FpbnN0IHRoZSBwcm9wZXJ0aWVzLgoJICogUmV0dXJuaW5nIGBmYWxzZWAgaGFsdHMgaXRlcmF0aW9uLgoJICoKCSAqIEBtZXRob2QgaXRlcmF0ZQoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge09iamVjdH0gICBvYmogT2JqZWN0IHRvIGl0ZXJhdGUKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiAgRnVuY3Rpb24gdG8gZXhlY3V0ZSBhZ2FpbnN0IHByb3BlcnRpZXMKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgT2JqZWN0CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuaXRlcmF0ZSggey4uLn0sIGZ1bmN0aW9uICggdmFsdWUsIGtleSApIHsKCSAqICAgLi4uCgkgKiB9ICk7CgkgKi8KCWl0ZXJhdGUgOiBmdW5jdGlvbiAoIG9iaiwgZm4gKSB7CgkJaWYgKCB0eXBlb2YgZm4gIT0gImZ1bmN0aW9uIiApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQlhcnJheS5lYWNoKCBPYmplY3Qua2V5cyggb2JqICksIGZ1bmN0aW9uICggaSApIHsKCQkJcmV0dXJuIGZuLmNhbGwoIG9iaiwgb2JqW2ldLCBpICk7CgkJfSApOwoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFdyaXRlcyBhcmd1bWVudCB0byB0aGUgY29uc29sZQoJICoKCSAqIEBtZXRob2QgbG9nCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgICAgU3RyaW5nIHRvIHdyaXRlIHRvIHRoZSBjb25zb2xlCgkgKiBAcGFyYW0gIHtTdHJpbmd9IHRhcmdldCBbT3B0aW9uYWxdIFRhcmdldCBjb25zb2xlLCBkZWZhdWx0IGlzICJsb2ciCgkgKiBAcmV0dXJuIHtVbmRlZmluZWR9ICAgICB1bmRlZmluZWQKCSAqIEBleGFtcGxlCgkgKiBrZWlnYWkudXRpbC5sb2coICJTb21ldGhpbmcgYmFkIGhhcHBlbmVkIiwgIndhcm4iICk7CgkgKi8KCWxvZyA6IGZ1bmN0aW9uICggYXJnLCB0YXJnZXQgKSB7CgkJdmFyIHRzLCBtc2c7CgoJCWlmICggdHlwZW9mIGNvbnNvbGUgIT0gInVuZGVmaW5lZCIgKSB7CgkJCXRzICA9IHR5cGVvZiBhcmcgIT0gIm9iamVjdCI7CgkJCW1zZyA9IHRzID8gIlsiICsgbmV3IERhdGUoKS50b0xvY2FsZVRpbWVTdHJpbmcoKSArICJdICIgKyBhcmcgOiBhcmc7CgkJCWNvbnNvbGVbdGFyZ2V0IHx8ICJsb2ciXSggbXNnICk7CgkJfQoJfSwKCgkvKioKCSAqIE1lcmdlcyBvYmogd2l0aCBhcmcKCSAqCgkgKiBAbWV0aG9kIG1lcmdlCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogT2JqZWN0IHRvIGRlY29yYXRlCgkgKiBAcGFyYW0gIHtPYmplY3R9IGFyZyBEZWNvcmF0aW9uCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBEZWNvcmF0ZWQgT2JqZWN0CgkgKiBAZXhhbXBsZQoJICogdmFyIG9iaiA9IHthOiB0cnVlfTsKCSAqCgkgKiBrZWlnYWkudXRpbC5tZXJnZSggb2JqLCB7YjogZmFsc2V9ICkKCSAqIG9iai5iOyAvLyBmYWxzZQoJICovCgltZXJnZSA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJdXRpbGl0eS5pdGVyYXRlKCBhcmcsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJaWYgKCAoIG9ialtrXSBpbnN0YW5jZW9mIEFycmF5ICkgJiYgKCB2IGluc3RhbmNlb2YgQXJyYXkgKSApIHsKCQkJCWFycmF5Lm1lcmdlKCBvYmpba10sIHYgKTsKCQkJfQoJCQllbHNlIGlmICggKCBvYmpba10gaW5zdGFuY2VvZiBPYmplY3QgKSAmJiAoIHYgaW5zdGFuY2VvZiBPYmplY3QgKSApIHsKCQkJCXV0aWxpdHkuaXRlcmF0ZSggdiwgZnVuY3Rpb24gKCB4LCB5ICkgewoJCQkJCW9ialtrXVt5XSA9IHV0aWxpdHkuY2xvbmUoIHggKTsKCQkJCX0gKTsKCQkJfQoJCQllbHNlIHsKCQkJCW9ialtrXSA9IHV0aWxpdHkuY2xvbmUoIHYgKTsKCQkJfQoJCX0gKTsKCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBQYXJzZXMgYSBVUkkgaW50byBhbiBPYmplY3QKCSAqCgkgKiBAbWV0aG9kIHBhcnNlCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7U3RyaW5nfSB1cmkgVVJJIHRvIHBhcnNlCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBQYXJzZWQgVVJJCgkgKiBAZXhhbXBsZQoJICogdmFyIHBhcnNlZCA9IGtlaWdhaS51dGlsLnBhcnNlKCBsb2NhdGlvbi5ocmVmICk7CgkgKgoJICogcGFyc2VkOwoJICogewoJICogICBhdXRoICAgICA6ICIiLAoJICogICBoYXNoICAgICA6ICIiLAoJICogICBob3N0ICAgICA6ICIiLAoJICogICBob3N0bmFtZSA6ICIiLAoJICogICBxdWVyeSAgICA6IHt9LAoJICogICBwYXRobmFtZSA6ICIiLAoJICogICBwb3J0ICAgICA6IG4sCgkgKiAgIHByb3RvY29sIDogIiIsCgkgKiAgIHNlYXJjaCAgIDogIiIsCgkgKiB9CgkgKi8KCXBhcnNlIDogZnVuY3Rpb24gKCB1cmkgKSB7CgkJdmFyIG9iaiAgICA9IHt9LAoJCSAgICBwYXJzZWQgPSB7fTsKCgkJaWYgKCB1cmkgPT09IHVuZGVmaW5lZCApIHsKCQkJdXJpID0gIXNlcnZlciA/IGxvY2F0aW9uLmhyZWYgOiAiIjsKCQl9CgoJCWlmICggIXNlcnZlciApIHsKCQkJb2JqID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7CgkJCW9iai5ocmVmID0gdXJpOwoJCX0KCQllbHNlIHsKCQkJb2JqID0gdXJsLnBhcnNlKCB1cmkgKTsKCQl9CgoJCWlmICggc2VydmVyICkgewoJCQl1dGlsaXR5Lml0ZXJhdGUoIG9iaiwgZnVuY3Rpb24gKCB2LCBrICkgewoJCQkJaWYgKCB2ID09PSBudWxsICkgewoJCQkJCW9ialtrXSA9IHVuZGVmaW5lZDsKCQkJCX0KCQkJfSApOwoJCX0KCgkJcGFyc2VkID0gewoJCQlhdXRoICAgICA6IHNlcnZlciA/IG51bGwgOiByZWdleC5hdXRoLmV4ZWMoIHVyaSApLAoJCQlwcm90b2NvbCA6IG9iai5wcm90b2NvbCB8fCAiaHR0cDoiLAoJCQlob3N0bmFtZSA6IG9iai5ob3N0bmFtZSB8fCAibG9jYWxob3N0IiwKCQkJcG9ydCAgICAgOiBvYmoucG9ydCA/IG51bWJlci5wYXJzZSggb2JqLnBvcnQsIDEwICkgOiAiIiwKCQkJcGF0aG5hbWUgOiBvYmoucGF0aG5hbWUsCgkJCXNlYXJjaCAgIDogb2JqLnNlYXJjaCAgIHx8ICIiLAoJCQloYXNoICAgICA6IG9iai5oYXNoICAgICB8fCAiIiwKCQkJaG9zdCAgICAgOiBvYmouaG9zdCAgICAgfHwgImxvY2FsaG9zdCIKCQl9OwoKCQkvLyAnY2F1c2UgSUUgaXMgLi4uIElFOyByZXF1aXJlZCBmb3IgZGF0YS5iYXRjaCgpCgkJaWYgKCBjbGllbnQuaWUgKSB7CgkJCWlmICggcGFyc2VkLnByb3RvY29sID09PSAiOiIgKSB7CgkJCQlwYXJzZWQucHJvdG9jb2wgPSBsb2NhdGlvbi5wcm90b2NvbDsKCQkJfQoKCQkJaWYgKCBzdHJpbmcuaXNFbXB0eSggcGFyc2VkLmhvc3RuYW1lICkgKSB7CgkJCQlwYXJzZWQuaG9zdG5hbWUgPSBsb2NhdGlvbi5ob3N0bmFtZTsKCQkJfQoKCQkJaWYgKCBzdHJpbmcuaXNFbXB0eSggcGFyc2VkLmhvc3QgKSApIHsKCQkJCXBhcnNlZC5ob3N0ID0gbG9jYXRpb24uaG9zdDsKCQkJfQoKCQkJaWYgKCBwYXJzZWQucGF0aG5hbWUuY2hhckF0KCAwICkgIT09ICIvIiApIHsKCQkJCXBhcnNlZC5wYXRobmFtZSA9ICIvIiArIHBhcnNlZC5wYXRobmFtZTsKCQkJfQoJCX0KCgkJcGFyc2VkLmF1dGggID0gb2JqLmF1dGggfHwgKCBwYXJzZWQuYXV0aCA9PT0gbnVsbCA/ICIiIDogcGFyc2VkLmF1dGhbMV0gKTsKCQlwYXJzZWQuaHJlZiAgPSBvYmouaHJlZiB8fCAoIHBhcnNlZC5wcm90b2NvbCArICIvLyIgKyAoIHN0cmluZy5pc0VtcHR5KCBwYXJzZWQuYXV0aCApID8gIiIgOiBwYXJzZWQuYXV0aCArICJAIiApICsgcGFyc2VkLmhvc3QgKyBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICsgcGFyc2VkLmhhc2ggKTsKCQlwYXJzZWQucGF0aCAgPSBvYmoucGF0aCB8fCBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoOwoJCXBhcnNlZC5xdWVyeSA9IHV0aWxpdHkucXVlcnlTdHJpbmcoIG51bGwsIHBhcnNlZC5zZWFyY2ggKTsKCgkJcmV0dXJuIHBhcnNlZDsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGEgcGFydGlhbGx5IGFwcGxpZWQgRnVuY3Rpb24KCSAqCgkgKiBAbWV0aG9kIHBhcnRpYWwKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcmV0dXJuIHtGdW5jdGlvbn0gUGFydGlhbCBGdW5jdGlvbgoJICogQGV4YW1wbGUKCSAqIGZ1bmN0aW9uIGYgKCBhLCBiICkgewoJICogICByZXR1cm4gYSArIGI7CgkgKiB9CgkgKgoJICogdmFyIGcgPSBrZWlnYWkudXRpbC5wYXJ0aWFsKCBmLCAyICk7CgkgKgoJICogZyggMiApOyAvLyA0CgkgKi8KCXBhcnRpYWwgOiBmdW5jdGlvbiAoKSB7CgkJdmFyIGFyZ3MgPSBhcnJheS5jYXN0KCBhcmd1bWVudHMgKSwKCQkgICAgZm4gICA9IGFyZ3Muc2hpZnQoKTsKCgkJcmV0dXJuIGZ1bmN0aW9uICgpIHsKCQkJcmV0dXJuIGZuLmFwcGx5KCBmbiwgYXJncy5jb25jYXQoIGFycmF5LmNhc3QoIGFyZ3VtZW50cyApICkgKTsKCQl9OwoJfSwKCgkvKioKCSAqIFByZXZlbnRzIGRlZmF1bHQgYmVoYXZpb3Igb2YgYW4gRXZlbnQKCSAqCgkgKiBAbWV0aG9kIHByZXZlbnQKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtPYmplY3R9IGV2IEV2ZW50CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgIEV2ZW50CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwucHJldmVudCggRXZlbnQgKTsKCSAqLwoJcHJldmVudCA6IGZ1bmN0aW9uICggZXYgKSB7CgkJaWYgKCB0eXBlb2YgZXYucHJldmVudERlZmF1bHQgPT0gImZ1bmN0aW9uIiApIHsKCQkJZXYucHJldmVudERlZmF1bHQoKTsKCQl9CgoJCXJldHVybiBldjsKCX0sCgoJLyoqCgkgKiBQYXJzZXMgYSBxdWVyeSBzdHJpbmcgJiBjb2VyY2VzIHZhbHVlcwoJICoKCSAqIEBtZXRob2QgcXVlcnlTdHJpbmcKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyAgICAgW09wdGlvbmFsXSBLZXkgdG8gZmluZCBpbiB0aGUgcXVlcnlzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gcXN0cmluZyBbT3B0aW9uYWxdIFF1ZXJ5IHN0cmluZyB0byBwYXJzZQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgICAgIFZhbHVlIG9yIE9iamVjdCBvZiBrZXk6dmFsdWUgcGFpcnMKCSAqIEBwcml2YXRlCgkgKi8KCXF1ZXJ5U3RyaW5nIDogZnVuY3Rpb24gKCBhcmcsIHFzdHJpbmcgKSB7CgkJdmFyIG9iaiAgICA9IHt9LAoJCSAgICByZXN1bHQgPSBxc3RyaW5nICE9PSB1bmRlZmluZWQgPyAoIHFzdHJpbmcuaW5kZXhPZiggIj8iICkgPiAtMSA/IHFzdHJpbmcucmVwbGFjZSggLy4qXD8vLCAiIiApIDogbnVsbCApIDogKCBzZXJ2ZXIgfHwgc3RyaW5nLmlzRW1wdHkoIGxvY2F0aW9uLnNlYXJjaCApID8gbnVsbCA6IGxvY2F0aW9uLnNlYXJjaC5yZXBsYWNlKCAiPyIsICIiICkgKTsKCgkJaWYgKCByZXN1bHQgIT09IG51bGwgJiYgIXN0cmluZy5pc0VtcHR5KCByZXN1bHQgKSApIHsKCQkJcmVzdWx0ID0gcmVzdWx0LnNwbGl0KCAiJiIgKTsKCQkJYXJyYXkuZWFjaCggcmVzdWx0LCBmdW5jdGlvbiAoIHByb3AgKSB7CgkJCQl2YXIgaXRlbSA9IHByb3Auc3BsaXQoICI9IiApOwoKCQkJCWlmICggc3RyaW5nLmlzRW1wdHkoIGl0ZW1bMF0gKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKCBpdGVtWzFdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJaXRlbVsxXSA9ICIiOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJaXRlbVsxXSA9IHV0aWxpdHkuY29lcmNlKCBkZWNvZGVVUklDb21wb25lbnQoIGl0ZW1bMV0gKSApOwoJCQkJfQoKCQkJCWlmICggb2JqW2l0ZW1bMF1dID09PSB1bmRlZmluZWQgKSB7CgkJCQkJb2JqW2l0ZW1bMF1dID0gaXRlbVsxXTsKCQkJCX0KCQkJCWVsc2UgaWYgKCAhKCBvYmpbaXRlbVswXV0gaW5zdGFuY2VvZiBBcnJheSApICkgewoJCQkJCW9ialtpdGVtWzBdXSA9IFtvYmpbaXRlbVswXV1dOwoJCQkJCW9ialtpdGVtWzBdXS5wdXNoKCBpdGVtWzFdICk7CgkJCQl9CgkJCQllbHNlIHsKCQkJCQlvYmpbaXRlbVswXV0ucHVzaCggaXRlbVsxXSApOwoJCQkJfQoJCQl9ICk7CgkJfQoKCQlpZiAoIGFyZyAhPT0gbnVsbCAmJiBhcmcgIT09IHVuZGVmaW5lZCApIHsKCQkJb2JqID0gb2JqW2FyZ107CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIEFjY2VwdHMgRGVmZXJyZWRzIG9yIFByb21pc2VzIGFzIGFyZ3VtZW50cywgb3IgYW4gQXJyYXkgb2YgZWl0aGVyCgkgKgoJICogQG1ldGhvZCByYWNlCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQoJICogQGV4YW1wbGUKCSAqIHZhciBkZWZlcnJlZHMgPSBbXSwKCSAqICAgICBkZWZlcjEgICAgPSBrZWlnYWkudXRpbC5kZWZlcigpLAoJICogICAgIGRlZmVyMiAgICA9IGtlaWdhaS51dGlsLmRlZmVyKCk7CgkgKgoJICogZGVmZXJyZWRzLnB1c2goIGRlZmVyMSApOwoJICogZGVmZXJyZWRzLnB1c2goIGRlZmVyMiApOwoJICoKCSAqIC8vIEV4ZWN1dGVzIHdoZW4gb25lIGRlZmVycmVkIGlzIHJlc29sdmVkIG9yIHJlamVjdGVkCgkgKiBrZWlnYWkudXRpbC5yYWNlKCBkZWZlcnJlZHMgKS50aGVuKCBmdW5jdGlvbiAoIGFyZyApICkgewoJICogICAuLi4KCSAqIH0sIGZ1bmN0aW9uICggZXJyICkgewoJICogICAuLi4KCSAqIH0gKTsKCSAqCgkgKiAuLi4KCSAqCgkgKiBkZWZlcjEucmVzb2x2ZSggdHJ1ZSApOwoJICogZGVmZXIyLnJlc29sdmUoIHRydWUgKTsKCSAqLwoJcmFjZSA6IGZ1bmN0aW9uICgpIHsKCQl2YXIgZGVmZXIgPSBkZWZlcnJlZC5mYWN0b3J5KCksCgkJICAgIGFyZ3MgID0gYXJyYXkuY2FzdCggYXJndW1lbnRzICk7CgoJCS8vIERpZCB3ZSByZWNlaXZlIGFuIEFycmF5PyBpZiBzbyBpdCBvdmVycmlkZXMgYW55IG90aGVyIGFyZ3VtZW50cwoJCWlmICggYXJnc1swXSBpbnN0YW5jZW9mIEFycmF5ICkgewoJCQlhcmdzID0gYXJnc1swXTsKCQl9CgoJCS8vIE5vbmUsIGVuZCBvbiBuZXh0IHRpY2sKCQlpZiAoIGFyZ3MubGVuZ3RoID09PSAwICkgewoJCQlkZWZlci5yZXNvbHZlKCBudWxsICk7CgkJfQoJCS8vIFNldHVwIGFuZCB3YWl0CgkJZWxzZSB7CgkJCVByb21pc2UucmFjZSggYXJncyApLnRoZW4oIGZ1bmN0aW9uICggcmVzdWx0cyApIHsKCQkJCWRlZmVyLnJlc29sdmUoIHJlc3VsdHMgKTsKCQkJfSwgZnVuY3Rpb24gKCBlICkgewoJCQkJZGVmZXIucmVqZWN0KCBlICk7CgkJCX0gKTsKCQl9CgoJCXJldHVybiBkZWZlcjsKCX0sCgoJLyoqCgkgKiBBc3luY2hyb25vdXMgRE9NIHJlbmRlcmluZyAoY2Fubm90IGJlIGNhbmNlbGxlZCwgc3VnZ2VzdGVkIGZvciByZWFjdGl2ZSBiZWhhdmlvcikKCSAqCgkgKiBAbWV0aG9kIHJlbmRlcgoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiBGdW5jdGlvbiB0byBleGVjdXRlIG9uIG5leHQgJ2ZyYW1lJwoJICogQHJldHVybiB7T2JqZWN0fSB7QGxpbmsga2VpZ2FpLkRlZmVycmVkfQoJICogQGV4YW1wbGUKCSAqIGtlaWdhaS51dGlsLnJlbmRlciggZnVuY3Rpb24gKCkgewoJICogICAgIHJldHVybiBrZWl0YWkudXRpbC5lbGVtZW50Lmh0bWwoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICIjaWQiICksICJIZWxsbyBXb3JsZCIgKQoJICogfSApLnRoZW4oIGZ1bmN0aW9uICggYXJnICkgewoJICogICAgIC8vIGFyZyBpcyB0aGUgcmV0dXJuIHZhbHVlIG9mIHlvdXIgZnVuY3Rpb24KCSAqIH0sIGZ1bmN0aW9uICggZSApIHsKCSAqICAgICAvLyBIYW5kbGUgZQoJICogfSApOwoJICovCglyZW5kZXIgOiBmdW5jdGlvbiAoIGZuICkgewoJCXZhciBkZWZlciA9IGRlZmVycmVkLmZhY3RvcnkoKTsKCgkJUkVOREVSKCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJdHJ5IHsKCQkJCWRlZmVyLnJlc29sdmUoIGZuKCBhcmcgKSApOwoJCQl9CgkJCWNhdGNoICggZSApIHsKCQkJCWRlZmVyLnJlamVjdCggZSApOwoJCQl9CgkJfSApOwoKCQlyZXR1cm4gZGVmZXI7Cgl9LAoKCS8qKgoJICogQ3JlYXRlcyBhIHJlY3Vyc2l2ZSBmdW5jdGlvbi4gUmV0dXJuIGZhbHNlIGZyb20gdGhlIGZ1bmN0aW9uIHRvIGhhbHQgcmVjdXJzaW9uLgoJICoKCSAqIEBtZXRob2QgcmVwZWF0CgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7RnVuY3Rpb259IGZuICBGdW5jdGlvbiB0byBleGVjdXRlIHJlcGVhdGVkbHkKCSAqIEBwYXJhbSAge051bWJlcn0gICBtcyAgTWlsbGlzZWNvbmRzIHRvIHN0YWdnZXIgdGhlIGV4ZWN1dGlvbgoJICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICBbT3B0aW9uYWxdIFRpbWVvdXQgSUQKCSAqIEBwYXJhbSAge0Jvb2xlYW59ICBub3cgRXhlY3V0ZXMgYGZuYCBhbmQgdGhlbiBzZXR1cCByZXBldGl0aW9uLCBkZWZhdWx0IGlzIGB0cnVlYAoJICogQHJldHVybiB7U3RyaW5nfSAgICAgICBUaW1lb3V0IElECgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwucmVwZWF0KCBmdW5jdGlvbiAoKSB7CgkgKiAgIC4uLgoJICoKCSAqICAgLy8gQ2FuY2VsbGluZyByZXBldGl0aW9uIGF0IHNvbWUgcG9pbnQgaW4gdGhlIGZ1dHVyZQoJICogICBpZiAoIHNvbWVDb25kaXRpb24gKSB7CgkgKiAgICAgcmV0dXJuIGZhbHNlOwoJICogICB9CgkgKiB9LCAxMDAwLCAicmVwZWF0aW5nIiApOwoJICovCglyZXBlYXQgOiBmdW5jdGlvbiAoIGZuLCBtcywgaWQsIG5vdyApIHsKCQltcyAgPSBtcyB8fCAxMDsKCQlpZCAgPSBpZCB8fCB1dGlsaXR5LnV1aWQoIHRydWUgKTsKCQlub3cgPSAoIG5vdyAhPT0gZmFsc2UgKTsKCgkJLy8gQ291bGQgYmUgdmFsaWQgdG8gcmV0dXJuIGZhbHNlIGZyb20gaW5pdGlhbCBleGVjdXRpb24KCQlpZiAoIG5vdyAmJiBmbigpID09PSBmYWxzZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ3JlYXRpbmcgcmVwZWF0aW5nIGV4ZWN1dGlvbgoJCXV0aWxpdHkuZGVmZXIoIGZ1bmN0aW9uICgpIHsKCQkJdmFyIHJlY3Vyc2l2ZSA9IGZ1bmN0aW9uICggZm4sIG1zLCBpZCApIHsKCQkJCXZhciByZWN1cnNpdmUgPSB0aGlzOwoKCQkJCWlmICggZm4oKSAhPT0gZmFsc2UgKSB7CgkJCQkJdXRpbGl0eS5yZXBlYXRpbmdbaWRdID0gc2V0VGltZW91dCggZnVuY3Rpb24gKCkgewoJCQkJCQlyZWN1cnNpdmUuY2FsbCggcmVjdXJzaXZlLCBmbiwgbXMsIGlkICk7CgkJCQkJfSwgbXMgKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWRlbGV0ZSB1dGlsaXR5LnJlcGVhdGluZ1tpZF07CgkJCQl9CgkJCX07CgoJCQlyZWN1cnNpdmUuY2FsbCggcmVjdXJzaXZlLCBmbiwgbXMsIGlkICk7CgkJfSwgbXMsIGlkLCB0cnVlICk7CgoJCXJldHVybiBpZDsKCX0sCgoJLyoqCgkgKiBTdG9wcyBhbiBFdmVudCBmcm9tIGJ1YmJsaW5nLCAmIHByZXZlbnRzIGRlZmF1bHQgYmVoYXZpb3IKCSAqCgkgKiBAbWV0aG9kIHN0b3AKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtPYmplY3R9IGV2IEV2ZW50CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgIEV2ZW50CgkgKiBAZXhhbXBsZQoJICoga2VpZ2FpLnV0aWwuc3RvcCggRXZlbnQgKTsKCSAqLwoJc3RvcCA6IGZ1bmN0aW9uICggZXYgKSB7CgkJaWYgKCB0eXBlb2YgZXYuc3RvcFByb3BhZ2F0aW9uID09ICJmdW5jdGlvbiIgKSB7CgkJCWV2LnN0b3BQcm9wYWdhdGlvbigpOwoJCX0KCgkJdXRpbGl0eS5wcmV2ZW50KCBldiApOwoKCQlyZXR1cm4gZXY7Cgl9LAoKCS8qKgoJICogUmV0dXJucyB0aGUgRXZlbnQgdGFyZ2V0CgkgKgoJICogQG1ldGhvZCB0YXJnZXQKCSAqIEBtZW1iZXJPZiB1dGlsaXR5CgkgKiBAcGFyYW0gIHtPYmplY3R9IGV2IEV2ZW50CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgIEV2ZW50IHRhcmdldAoJICogQGV4YW1wbGUKCSAqIHZhciB0YXJnZXQgPSBrZWlnYWkudXRpbC50YXJnZXQoIEV2ZW50ICk7CgkgKi8KCXRhcmdldCA6IGZ1bmN0aW9uICggZXYgKSB7CgkJcmV0dXJuIGV2LnRhcmdldCB8fCBldi5zcmNFbGVtZW50OwoJfSwKCgkvKioKCSAqIEdlbmVyYXRlcyBhIHZlcnNpb24gNCBVVUlECgkgKgoJICogQG1ldGhvZCB1dWlkCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7Qm9vbGVhbn0gc3RyaXAgW09wdGlvbmFsXSBTdHJpcHMgLSBmcm9tIFVVSUQKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgICAgIFVVSUQKCSAqIEBleGFtcGxlCgkgKiB2YXIgdXVpZDQgPSBrZWlnYWkudXRpbC51dWlkKCk7CgkgKi8KCXV1aWQgOiBmdW5jdGlvbiAoIHN0cmlwICkgewoJCXZhciBzID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gKCAoICggMSArIE1hdGgucmFuZG9tKCkgKSAqIDB4MTAwMDAgKSB8IDAgKS50b1N0cmluZyggMTYgKS5zdWJzdHJpbmcoIDEgKTsgfSwKCQkgICAgciA9IFs4LCA5LCAiYSIsICJiIl0sCgkJICAgIG87CgoJCW8gPSAoIHMoKSArIHMoKSArICItIiArIHMoKSArICItNCIgKyBzKCkuc3Vic3RyKCAwLCAzICkgKyAiLSIgKyByW01hdGguZmxvb3IoIE1hdGgucmFuZG9tKCkgKiA0ICldICsgcygpLnN1YnN0ciggMCwgMyApICsgIi0iICsgcygpICsgcygpICsgcygpICk7CgoJCWlmICggc3RyaXAgPT09IHRydWUgKSB7CgkJCW8gPSBvLnJlcGxhY2UoIC8tL2csICIiICk7CgkJfQoKCQlyZXR1cm4gbzsKCX0sCgoJLyoqCgkgKiBXYWxrcyBgb2JqYCBhbmQgcmV0dXJucyBgYXJnYCwgZm9yIHdoZW4geW91IGNhbid0IGVhc2lseSBhY2Nlc3MgYGFyZ2AKCSAqCgkgKiBAbWV0aG9kICB3YWxrCgkgKiBAbWVtYmVyT2YgdXRpbGl0eQoJICogQHBhcmFtICB7TWl4ZWR9ICBvYmogIE9iamVjdCBvciBBcnJheQoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgIFN0cmluZyBkZXNjcmliaW5nIHRoZSBwcm9wZXJ0eSB0byByZXR1cm4KCSAqIEByZXR1cm4ge01peGVkfSAgICAgICBUYXJnZXQgb3IgdW5kZWZpbmVkCgkgKiBAZXhhbXBsZQoJICogdmFyIG9iaiA9IHthOiBbe2I6IHRydWV9XX07CgkgKgoJICoga2VpZ2FpLnV0aWwud2Fsayggb2JqLCAiYVswXS5iIiApOyAvLyB0cnVlCgkgKi8KCXdhbGsgOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCXZhciBvdXRwdXQgPSBvYmo7CgoJCWFycmF5LmVhY2goIGFyZy5yZXBsYWNlKCAvXF0kLywgIiIgKS5yZXBsYWNlKCAvXF0vZywgIi4iICkucmVwbGFjZSggL1wuXC4vZywgIi4iICkuc3BsaXQoIC9cLnxcWy8gKSwgZnVuY3Rpb24gKCBpICkgewoJCQlpZiAoIG91dHB1dFtpXSA9PT0gdW5kZWZpbmVkIHx8IG91dHB1dFtpXSA9PT0gbnVsbCApIHsKCQkJCW91dHB1dCA9IHVuZGVmaW5lZDsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJb3V0cHV0ID0gb3V0cHV0W2ldOwoJCX0gKTsKCgkJcmV0dXJuIG91dHB1dDsKCX0sCgoJLyoqCgkgKiBBY2NlcHRzIERlZmVycmVkcyBvciBQcm9taXNlcyBhcyBhcmd1bWVudHMsIG9yIGFuIEFycmF5IG9mIGVpdGhlcgoJICoKCSAqIEBtZXRob2Qgd2hlbgoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEByZXR1cm4ge09iamVjdH0ge0BsaW5rIGtlaWdhaS5EZWZlcnJlZH0KCSAqIEBleGFtcGxlCgkgKiB2YXIgZGVmZXJyZWRzID0gW10sCgkgKiAgICAgZGVmZXIxICAgID0ga2VpZ2FpLnV0aWwuZGVmZXIoKSwKCSAqICAgICBkZWZlcjIgICAgPSBrZWlnYWkudXRpbC5kZWZlcigpOwoJICoKCSAqIGRlZmVycmVkcy5wdXNoKCBkZWZlcjEgKTsKCSAqIGRlZmVycmVkcy5wdXNoKCBkZWZlcjIgKTsKCSAqCgkgKiAvLyBFeGVjdXRlcyB3aGVuIGJvdGggZGVmZXJyZWRzIGhhdmUgcmVzb2x2ZWQgb3Igb25lIGhhcyByZWplY3RlZAoJICoga2VpZ2FpLnV0aWwud2hlbiggZGVmZXJyZWRzICkudGhlbiggZnVuY3Rpb24gKCBhcmdzICkgKSB7CgkgKiAgIC4uLgoJICogfSwgZnVuY3Rpb24gKCBlcnIgKSB7CgkgKiAgIC4uLgoJICogfSApOwoJICoKCSAqIC4uLgoJICoKCSAqIGRlZmVyMS5yZXNvbHZlKCB0cnVlICk7CgkgKiBkZWZlcjIucmVzb2x2ZSggdHJ1ZSApOwoJICovCgl3aGVuIDogZnVuY3Rpb24gKCkgewoJCXZhciBkZWZlciA9IGRlZmVycmVkLmZhY3RvcnkoKSwKCQkgICAgYXJncyAgPSBhcnJheS5jYXN0KCBhcmd1bWVudHMgKTsKCgkJLy8gRGlkIHdlIHJlY2VpdmUgYW4gQXJyYXk/IGlmIHNvIGl0IG92ZXJyaWRlcyBhbnkgb3RoZXIgYXJndW1lbnRzCgkJaWYgKCBhcmdzWzBdIGluc3RhbmNlb2YgQXJyYXkgKSB7CgkJCWFyZ3MgPSBhcmdzWzBdOwoJCX0KCgkJLy8gTm9uZSwgZW5kIG9uIG5leHQgdGljawoJCWlmICggYXJncy5sZW5ndGggPT09IDAgKSB7CgkJCWRlZmVyLnJlc29sdmUoIG51bGwgKTsKCQl9CgkJLy8gU2V0dXAgYW5kIHdhaXQKCQllbHNlIHsKCQkJUHJvbWlzZS5hbGwoIGFyZ3MgKS50aGVuKCBmdW5jdGlvbiAoIHJlc3VsdHMgKSB7CgkJCQlkZWZlci5yZXNvbHZlKCByZXN1bHRzICk7CgkJCX0sIGZ1bmN0aW9uICggZSApIHsKCQkJCWRlZmVyLnJlamVjdCggZSApOwoJCQl9ICk7CgkJfQoKCQlyZXR1cm4gZGVmZXI7Cgl9LAoKCS8qKgoJICogV29ya2VyIGZhY3RvcnkKCSAqCgkgKiBAbWV0aG9kIHdvcmtlcgoJICogQG1lbWJlck9mIHV0aWxpdHkKCSAqIEBwYXJhbSAge09iamVjdH0gZGVmZXIgRGVmZXJyZWQgdG8gcmVjZWl2ZSBtZXNzYWdlIGZyb20gV29ya2VyCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgIFdvcmtlcgoJICogQHByaXZhdGUKCSAqLwoJd29ya2VyIDogZnVuY3Rpb24gKCBkZWZlciApIHsKCQl2YXIgb2JqID0gbmV3IFdvcmtlciggV09SS0VSICk7CgoJCW9iai5vbmVycm9yID0gZnVuY3Rpb24gKCBlcnIgKSB7CgkJCWRlZmVyLnJlamVjdCggZXJyICk7CgkJCW9iai50ZXJtaW5hdGUoKTsKCQl9OwoKCQlvYmoub25tZXNzYWdlID0gZnVuY3Rpb24gKCBldiApIHsKCQkJZGVmZXIucmVzb2x2ZSggZXYuZGF0YSApOwoJCQlvYmoudGVybWluYXRlKCk7CgkJfTsKCgkJcmV0dXJuIG9iajsKCX0KfTsKCi8qKgogKiBYTUxIdHRwUmVxdWVzdCBzaGltIGZvciBub2RlLmpzCiAqCiAqIEBtZXRob2QgeGhyCiAqIEBwcml2YXRlCiAqIEByZXR1cm4ge09iamVjdH0gWE1MSHR0cFJlcXVlc3QgaW5zdGFuY2UKICovCmZ1bmN0aW9uIHhociAoKSB7Cgl2YXIgVU5TRU5UICAgICAgICAgICA9IDAsCgkgICAgT1BFTkVEICAgICAgICAgICA9IDEsCgkgICAgSEVBREVSU19SRUNFSVZFRCA9IDIsCgkgICAgTE9BRElORyAgICAgICAgICA9IDMsCgkgICAgRE9ORSAgICAgICAgICAgICA9IDQsCgkgICAgRVJSX1JFRlVTRUQgICAgICA9IC9FQ09OTlJFRlVTRUQvLAoJICAgIHJlYWR5ICAgICAgICAgICAgPSBuZXcgUmVnRXhwKCBIRUFERVJTX1JFQ0VJVkVEICsgInwiICsgTE9BRElORyApLAoJICAgIFhNTEh0dHBSZXF1ZXN0LCBoZWFkZXJzLCBkaXNwYXRjaCwgc3VjY2VzcywgZmFpbHVyZSwgc3RhdGU7CgoJaGVhZGVycyA9IHsKCQkidXNlci1hZ2VudCIgICA6ICJrZWlnYWkvMC45LjAgbm9kZS5qcy8iICsgcHJvY2Vzcy52ZXJzaW9ucy5ub2RlLnJlcGxhY2UoIC9edi8sICIiICkgKyAiICgiICsgc3RyaW5nLmNhcGl0YWxpemUoIHByb2Nlc3MucGxhdGZvcm0gKSArICIgVjgvIiArIHByb2Nlc3MudmVyc2lvbnMudjggKyAiICkiLAoJCSJjb250ZW50LXR5cGUiIDogInRleHQvcGxhaW4iLAoJCSJhY2NlcHQiICAgICAgIDogIiovKiIKCX07CgoJLyoqCgkgKiBEaXNwYXRjaGVzIGFuIGV2ZW50CgkgKgoJICogQG1ldGhvZCBkaXNwYXRjaAoJICogQG1lbWJlck9mIHhocgoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgRXZlbnQgdG8gZGlzcGF0Y2gKCSAqIEByZXR1cm4ge09iamVjdH0gICAgIFhNTEh0dHBSZXF1ZXN0IGluc3RhbmNlCgkgKi8KCWRpc3BhdGNoID0gZnVuY3Rpb24gKCBhcmcgKSB7CgkJdmFyIGZuID0gIm9uIiArIGFyZzsKCgkJaWYgKCB0eXBlb2YgdGhpc1tmbl0gPT0gImZ1bmN0aW9uIiApIHsKCQkJdGhpc1tmbl0oKTsKCQl9CgoJCXRoaXMuZGlzcGF0Y2hFdmVudCggYXJnICk7CgoJCXJldHVybiB0aGlzOwoJfTsKCgkvKioKCSAqIENoYW5nZXMgdGhlIHJlYWR5U3RhdGUgb2YgYW4gWE1MSHR0cFJlcXVlc3QKCSAqCgkgKiBAbWV0aG9kIHN0YXRlCgkgKiBAbWVtYmVyT2YgeGhyCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBOZXcgcmVhZHlTdGF0ZQoJICogQHJldHVybiB7T2JqZWN0fSAgICAgWE1MSHR0cFJlcXVlc3QgaW5zdGFuY2UKCSAqLwoJc3RhdGUgPSBmdW5jdGlvbiAoIGFyZyApIHsKCQlpZiAoIHRoaXMucmVhZHlTdGF0ZSAhPT0gYXJnICkgewoJCQl0aGlzLnJlYWR5U3RhdGUgPSBhcmc7CgkJCWRpc3BhdGNoLmNhbGwoIHRoaXMsICJyZWFkeXN0YXRlY2hhbmdlIiApOwoKCQkJaWYgKCB0aGlzLnJlYWR5U3RhdGUgPT09IERPTkUgJiYgIXRoaXMuX2Vycm9yICkgewoJCQkJZGlzcGF0Y2guY2FsbCggdGhpcywgImxvYWQiICk7CgkJCQlkaXNwYXRjaC5jYWxsKCB0aGlzLCAibG9hZGVuZCIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogUmVzcG9uc2UgaGFuZGxlcgoJICoKCSAqIEBtZXRob2Qgc3VjY2VzcwoJICogQG1lbWJlck9mIHhocgoJICogQHBhcmFtICB7T2JqZWN0fSByZXMgSFRUUChTKSBSZXNwb25zZSBPYmplY3QKCSAqIEByZXR1cm4ge1VuZGVmaW5lZH0gIHVuZGVmaW5lZAoJICovCglzdWNjZXNzID0gZnVuY3Rpb24gKCByZXMgKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzdGF0ZS5jYWxsKCB0aGlzLCBIRUFERVJTX1JFQ0VJVkVEICk7CgkJdGhpcy5zdGF0dXMgICAgICA9IHJlcy5zdGF0dXNDb2RlOwoJCXRoaXMuX3Jlc2hlYWRlcnMgPSByZXMuaGVhZGVyczsKCgkJaWYgKCB0aGlzLl9yZXNoZWFkZXJzWyJzZXQtY29va2llIl0gJiYgdGhpcy5fcmVzaGVhZGVyc1sic2V0LWNvb2tpZSJdIGluc3RhbmNlb2YgQXJyYXkgKSB7CgkJCXRoaXMuX3Jlc2hlYWRlcnNbInNldC1jb29raWUiXSA9IHRoaXMuX3Jlc2hlYWRlcnNbInNldC1jb29raWUiXS5qb2luKCAiOyIgKTsKCQl9CgoJCXJlcy5vbiggImRhdGEiLCBmdW5jdGlvbiAoIGFyZyApIHsKCQkJcmVzLnNldEVuY29kaW5nKCAidXRmOCIgKTsKCgkJCWlmICggc2VsZi5fc2VuZCApIHsKCQkJCWlmICggYXJnICkgewoJCQkJCXNlbGYucmVzcG9uc2VUZXh0ICs9IGFyZzsKCQkJCX0KCgkJCQlzdGF0ZS5jYWxsKCBzZWxmLCBMT0FESU5HICk7CgkJCX0KCQl9ICk7CgoJCXJlcy5vbiggImVuZCIsIGZ1bmN0aW9uICgpIHsKCQkJaWYgKCBzZWxmLl9zZW5kICkgewoJCQkJc3RhdGUuY2FsbCggc2VsZiwgRE9ORSApOwoJCQkJc2VsZi5fc2VuZCA9IGZhbHNlOwoJCQl9CgkJfSApOwoJfTsKCgkvKioKCSAqIFJlc3BvbnNlIGVycm9yIGhhbmRsZXIKCSAqCgkgKiBAbWV0aG9kIGZhaWx1cmUKCSAqIEBtZW1iZXJPZiB4aHIKCSAqIEBwYXJhbSAge09iamVjdH0gZSBFcnJvcgoJICogQHJldHVybiB7VW5kZWZpbmVkfSB1bmRlZmluZWQKCSAqLwoJZmFpbHVyZSA9IGZ1bmN0aW9uICggZSApIHsKCQl0aGlzLnN0YXR1cyAgICAgICA9IEVSUl9SRUZVU0VELnRlc3QoIGUubWVzc2FnZSApID8gNTAzIDogNTAwOwoJCXRoaXMuc3RhdHVzVGV4dCAgID0gIiI7CgkJdGhpcy5yZXNwb25zZVRleHQgPSBlLm1lc3NhZ2U7CgkJdGhpcy5fZXJyb3IgICAgICAgPSB0cnVlOwoJCXRoaXMuX3NlbmQgICAgICAgID0gZmFsc2U7CgkJZGlzcGF0Y2guY2FsbCggdGhpcywgImVycm9yIiApOwoJCXN0YXRlLmNhbGwoIHRoaXMsIERPTkUgKTsKCX07CgoJLyoqCgkgKiBDcmVhdGVzIGEgbmV3IFhNTEh0dHBSZXF1ZXN0CgkgKgoJICogQGNvbnN0cnVjdG9yCgkgKiBAcHJpdmF0ZQoJICogQG1lbWJlck9mIHhocgoJICogQHJldHVybiB7T2JqZWN0fSBYTUxIdHRwUmVxdWVzdCBpbnN0YW5jZQoJICovCglYTUxIdHRwUmVxdWVzdCA9IGZ1bmN0aW9uICgpIHsKCQl0aGlzLm9uYWJvcnQgICAgICAgICAgICA9IG51bGw7CgkJdGhpcy5vbmVycm9yICAgICAgICAgICAgPSBudWxsOwoJCXRoaXMub25sb2FkICAgICAgICAgICAgID0gbnVsbDsKCQl0aGlzLm9ubG9hZGVuZCAgICAgICAgICA9IG51bGw7CgkJdGhpcy5vbmxvYWRzdGFydCAgICAgICAgPSBudWxsOwoJCXRoaXMub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKCQl0aGlzLnJlYWR5U3RhdGUgICAgICAgICA9IFVOU0VOVDsKCQl0aGlzLnJlc3BvbnNlICAgICAgICAgICA9IG51bGw7CgkJdGhpcy5yZXNwb25zZVRleHQgICAgICAgPSAiIjsKCQl0aGlzLnJlc3BvbnNlVHlwZSAgICAgICA9ICIiOwoJCXRoaXMucmVzcG9uc2VYTUwgICAgICAgID0gbnVsbDsKCQl0aGlzLnN0YXR1cyAgICAgICAgICAgICA9IFVOU0VOVDsKCQl0aGlzLnN0YXR1c1RleHQgICAgICAgICA9ICIiOwoJCXRoaXMub2JzZXJ2ZXIgICAgICAgICAgID0gb2JzZXJ2YWJsZS5mYWN0b3J5KCk7CgoJCS8vIFBzdWVkbyBwcml2YXRlIGZvciBwcm90b3R5cGUgY2hhaW4KCQl0aGlzLl9lcnJvciAgICAgICAgICAgICA9IGZhbHNlOwoJCXRoaXMuX2hlYWRlcnMgICAgICAgICAgID0ge307CgkJdGhpcy5fcGFyYW1zICAgICAgICAgICAgPSB7fTsKCQl0aGlzLl9yZXF1ZXN0ICAgICAgICAgICA9IG51bGw7CgkJdGhpcy5fcmVzaGVhZGVycyAgICAgICAgPSB7fTsKCQl0aGlzLl9zZW5kICAgICAgICAgICAgICA9IGZhbHNlOwoJfTsKCgkvKioKCSAqIEV4dGVuZGluZyBCYXNlCgkgKgoJICogQG1lbWJlck9mIGtlaWdhaS5YTUxIdHRwUmVxdWVzdAoJICogQHR5cGUge09iamVjdH0ge0BsaW5rIGtlaWdhaS5CYXNlfQoJICovCglYTUxIdHRwUmVxdWVzdC5wcm90b3R5cGUgPSBiYXNlLmZhY3RvcnkoKTsKCgkvKioKCSAqIFNldHRpbmcgY29uc3RydWN0b3IgbG9vcAoJICoKCSAqIEBtZXRob2QgY29uc3RydWN0b3IKCSAqIEBtZW1iZXJPZiBrZWlnYWkuWE1MSHR0cFJlcXVlc3QKCSAqIEB0eXBlIHtGdW5jdGlvbn0KCSAqIEBwcml2YXRlCgkgKi8KCVhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFhNTEh0dHBSZXF1ZXN0OwoKCS8qKgoJICogQWJvcnRzIGEgcmVxdWVzdAoJICoKCSAqIEBtZXRob2QgYWJvcnQKCSAqIEBtZW1iZXJPZiBYTUxIdHRwUmVxdWVzdAoJICogQHJldHVybiB7T2JqZWN0fSBYTUxIdHRwUmVxdWVzdCBpbnN0YW5jZQoJICovCglYTUxIdHRwUmVxdWVzdC5wcm90b3R5cGUuYWJvcnQgPSBmdW5jdGlvbiAoKSB7CgkJaWYgKCB0aGlzLl9yZXF1ZXN0ICE9PSBudWxsICkgewoJCQl0aGlzLl9yZXF1ZXN0LmFib3J0KCk7CgkJCXRoaXMuX3JlcXVlc3QgICAgID0gbnVsbDsKCQkJdGhpcy5yZXNwb25zZVRleHQgPSAiIjsKCQkJdGhpcy5yZXNwb25zZVhNTCAgPSAiIjsKCQkJdGhpcy5fZXJyb3IgICAgICAgPSB0cnVlOwoJCQl0aGlzLl9oZWFkZXJzICAgICA9IHt9OwoKCQkJaWYgKCB0aGlzLl9zZW5kID09PSB0cnVlIHx8IHJlYWR5LnRlc3QoIHRoaXMucmVhZHlTdGF0ZSApICkgewoJCQkJdGhpcy5fc2VuZCA9IGZhbHNlOwoJCQkJc3RhdGUuY2FsbCggdGhpcywgRE9ORSApOwoJCQl9CgoJCQlkaXNwYXRjaC5jYWxsKCB0aGlzLCAiYWJvcnQiICk7CgkJCXRoaXMucmVhZHlTdGF0ZSA9IFVOU0VOVDsKCQl9CgoJCXJldHVybiB0aGlzOwoJfTsKCgkvKioKCSAqIEdldHMgYWxsIHJlc3BvbnNlIGhlYWRlcnMKCSAqCgkgKiBAbWV0aG9kIGdldEFsbFJlc3BvbnNlSGVhZGVycwoJICogQG1lbWJlck9mIFhNTEh0dHBSZXF1ZXN0CgkgKiBAcmV0dXJuIHtPYmplY3R9IFJlc3BvbnNlIGhlYWRlcnMKCSAqLwoJWE1MSHR0cFJlcXVlc3QucHJvdG90eXBlLmdldEFsbFJlc3BvbnNlSGVhZGVycyA9IGZ1bmN0aW9uICgpIHsKCQl2YXIgcmVzdWx0ID0gIiI7CgoJCWlmICggdGhpcy5yZWFkeVN0YXRlIDwgSEVBREVSU19SRUNFSVZFRCApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkU3RhdGVOb0hlYWRlcnMgKTsKCQl9CgoJCXV0aWxpdHkuaXRlcmF0ZSggdGhpcy5fcmVzaGVhZGVycywgZnVuY3Rpb24gKCB2LCBrICkgewoJCQlyZXN1bHQgKz0gayArICI6ICIgKyB2ICsgIlxuIjsKCQl9ICk7CgoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCS8qKgoJICogR2V0cyBhIHNwZWNpZmljIHJlc3BvbnNlIGhlYWRlcgoJICoKCSAqIEBtZXRob2QgZ2V0UmVzcG9uc2VIZWFkZXIKCSAqIEBtZW1iZXJPZiBYTUxIdHRwUmVxdWVzdAoJICogQHBhcmFtICB7U3RyaW5nfSBoZWFkZXIgSGVhZGVyIHRvIGdldAoJICogQHJldHVybiB7U3RyaW5nfSAgICAgICAgUmVzcG9uc2UgaGVhZGVyIHZhbHVlCgkgKi8KCVhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5nZXRSZXNwb25zZUhlYWRlciA9IGZ1bmN0aW9uICggaGVhZGVyICkgewoJCXZhciByZXN1bHQ7CgoJCWlmICggdGhpcy5yZWFkeVN0YXRlIDwgSEVBREVSU19SRUNFSVZFRCB8fCB0aGlzLl9lcnJvciApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkU3RhdGVOb0hlYWRlcnMgKTsKCQl9CgoJCXJlc3VsdCA9IHRoaXMuX3Jlc2hlYWRlcnNbaGVhZGVyXSB8fCB0aGlzLl9yZXNoZWFkZXJzW2hlYWRlci50b0xvd2VyQ2FzZSgpXTsKCgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJLyoqCgkgKiBQcmVwYXJlcyBhbiBYTUxIdHRwUmVxdWVzdCBpbnN0YW5jZSB0byBtYWtlIGEgcmVxdWVzdAoJICoKCSAqIEBtZXRob2Qgb3BlbgoJICogQG1lbWJlck9mIFhNTEh0dHBSZXF1ZXN0CgkgKiBAcGFyYW0gIHtTdHJpbmd9ICBtZXRob2QgICBIVFRQIG1ldGhvZAoJICogQHBhcmFtICB7U3RyaW5nfSAgdXJsICAgICAgVVJMIHRvIHJlY2VpdmUgcmVxdWVzdAoJICogQHBhcmFtICB7Qm9vbGVhbn0gYXN5bmMgICAgW09wdGlvbmFsXSBBc3luY2hyb25vdXMgcmVxdWVzdAoJICogQHBhcmFtICB7U3RyaW5nfSAgdXNlciAgICAgW09wdGlvbmFsXSBCYXNpYyBhdXRoIHVzZXJuYW1lCgkgKiBAcGFyYW0gIHtTdHJpbmd9ICBwYXNzd29yZCBbT3B0aW9uYWxdIEJhc2ljIGF1dGggcGFzc3dvcmQKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgICAgIFhNTEh0dHBSZXF1ZXN0IGluc3RhbmNlCgkgKi8KCVhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5vcGVuID0gZnVuY3Rpb24gKCBtZXRob2QsIHVybCwgYXN5bmMsIHVzZXIsIHBhc3N3b3JkICkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJaWYgKCBhc3luYyAhPT0gdHJ1ZSApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkU3RhdGVOb1N5bmMgKTsKCQl9CgoJCXRoaXMuYWJvcnQoKTsKCQl0aGlzLl9lcnJvciAgPSBmYWxzZTsKCQl0aGlzLl9wYXJhbXMgPSB7CgkJCW1ldGhvZCAgIDogbWV0aG9kLAoJCQl1cmwgICAgICA6IHVybCwKCQkJYXN5bmMgICAgOiBhc3luYyAgICB8fCB0cnVlLAoJCQl1c2VyICAgICA6IHVzZXIgICAgIHx8IG51bGwsCgkJCXBhc3N3b3JkIDogcGFzc3dvcmQgfHwgbnVsbAoJCX07CgoJCXV0aWxpdHkuaXRlcmF0ZSggaGVhZGVycywgZnVuY3Rpb24gKCB2LCBrICkgewoJCQlzZWxmLl9oZWFkZXJzW2tdID0gdjsKCQl9ICk7CgoJCXRoaXMucmVhZHlTdGF0ZSA9IE9QRU5FRDsKCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogT3ZlcnJpZGVzIHRoZSBDb250ZW50LVR5cGUgb2YgdGhlIHJlcXVlc3QKCSAqCgkgKiBAbWV0aG9kIG92ZXJyaWRlTWltZVR5cGUKCSAqIEBtZW1iZXJPZiBYTUxIdHRwUmVxdWVzdAoJICogQHBhcmFtICB7U3RyaW5nfSBtaW1lIE1pbWUgdHlwZSBvZiB0aGUgcmVxdWVzdCAoIG1lZGlhIHR5cGUgKQoJICogQHJldHVybiB7T2JqZWN0fSAgICAgIFhNTEh0dHBSZXF1ZXN0IGluc3RhbmNlCgkgKi8KCVhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5vdmVycmlkZU1pbWVUeXBlID0gZnVuY3Rpb24gKCBtaW1lICkgewoJCXRoaXMuX2hlYWRlcnNbImNvbnRlbnQtdHlwZSJdID0gbWltZTsKCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogU2VuZHMgYW4gWE1MSHR0cFJlcXVlc3QgcmVxdWVzdAoJICoKCSAqIEBtZXRob2Qgc2VuZAoJICogQG1lbWJlck9mIFhNTEh0dHBSZXF1ZXN0CgkgKiBAcGFyYW0gIHtNaXhlZH0gZGF0YSBbT3B0aW9uYWxdIFBheWxvYWQgdG8gc2VuZCB3aXRoIHRoZSByZXF1ZXN0CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBYTUxIdHRwUmVxdWVzdCBpbnN0YW5jZQoJICovCglYTUxIdHRwUmVxdWVzdC5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uICggZGF0YSApIHsKCQlkYXRhICAgICA9IGRhdGEgfHwgbnVsbDsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJICAgIG9wdGlvbnMsIHBhcnNlZCwgcmVxdWVzdCwgb2JqOwoKCQlpZiAoIHRoaXMucmVhZHlTdGF0ZSA8IE9QRU5FRCApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5pbnZhbGlkU3RhdGVOb3RPcGVuICk7CgkJfQoJCWVsc2UgaWYgKCB0aGlzLl9zZW5kICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRTdGF0ZU5vdFNlbmRpbmcgKTsKCQl9CgoJCXBhcnNlZCAgICAgID0gdXRpbGl0eS5wYXJzZSggdGhpcy5fcGFyYW1zLnVybCApOwoJCXBhcnNlZC5wb3J0ID0gcGFyc2VkLnBvcnQgfHwgKCBwYXJzZWQucHJvdG9jb2wgPT09ICJodHRwczoiID8gNDQzIDogODAgKTsKCgkJaWYgKCB0aGlzLl9wYXJhbXMudXNlciAhPT0gbnVsbCAmJiB0aGlzLl9wYXJhbXMucGFzc3dvcmQgIT09IG51bGwgKSB7CgkJCXBhcnNlZC5hdXRoID0gdGhpcy5fcGFyYW1zLnVzZXIgKyAiOiIgKyB0aGlzLl9wYXJhbXMucGFzc3dvcmQ7CgkJfQoKCQkvLyBTcGVjaWZ5aW5nIENvbnRlbnQtTGVuZ3RoIGFjY29yZGluZ2x5CgkJaWYgKCByZWdleC5wdXRfcG9zdC50ZXN0KCB0aGlzLl9wYXJhbXMubWV0aG9kICkgKSB7CgkJCWlmICggZGF0YSA9PT0gbnVsbCApIHsKCQkJCXRoaXMuX2hlYWRlcnNbImNvbnRlbnQtbGVuZ3RoIl0gPSAwOwoJCQl9CgkJCWVsc2UgaWYgKCB0eXBlb2YgZGF0YSA9PSAic3RyaW5nIiApIHsKCQkJCXRoaXMuX2hlYWRlcnNbImNvbnRlbnQtbGVuZ3RoIl0gPSBCdWZmZXIuYnl0ZUxlbmd0aCggZGF0YSApOwoJCQl9CgkJCWVsc2UgaWYgKCBkYXRhIGluc3RhbmNlb2YgQnVmZmVyIHx8IHR5cGVvZiBkYXRhLnRvU3RyaW5nID09ICJmdW5jdGlvbiIgKSB7CgkJCQlkYXRhID0gZGF0YS50b1N0cmluZygpOwoJCQkJdGhpcy5faGVhZGVyc1siY29udGVudC1sZW5ndGgiXSA9IEJ1ZmZlci5ieXRlTGVuZ3RoKCBkYXRhICk7CgkJCX0KCQkJZWxzZSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCQkJfQoJCX0KCgkJdGhpcy5faGVhZGVycy5ob3N0ID0gcGFyc2VkLmhvc3Q7CgoJCWlmICggdGhpcy5faGVhZGVyc1sieC1yZXF1ZXN0ZWQtd2l0aCJdID09PSAiWE1MSHR0cFJlcXVlc3QiICkgewoJCQlkZWxldGUgdGhpcy5faGVhZGVyc1sieC1yZXF1ZXN0ZWQtd2l0aCJdOwoJCX0KCgkJb3B0aW9ucyA9IHsKCQkJaG9zdG5hbWUgOiBwYXJzZWQuaG9zdG5hbWUsCgkJCXBhdGggICAgIDogcGFyc2VkLnBhdGgsCgkJCXBvcnQgICAgIDogcGFyc2VkLnBvcnQsCgkJCW1ldGhvZCAgIDogdGhpcy5fcGFyYW1zLm1ldGhvZCwKCQkJaGVhZGVycyAgOiB0aGlzLl9oZWFkZXJzCgkJfTsKCgkJaWYgKCBwYXJzZWQucHJvdG9jb2wgPT09ICJodHRwczoiICkgewoJCQlvcHRpb25zLnJlamVjdFVuYXV0aG9yaXplZCA9IGZhbHNlOwoJCQlvcHRpb25zLmFnZW50ICAgICAgICAgICAgICA9IGZhbHNlOwoJCX0KCgkJaWYgKCBwYXJzZWQuYXV0aCApIHsKCQkJb3B0aW9ucy5hdXRoID0gcGFyc2VkLmF1dGg7CgkJfQoKCQl0aGlzLl9zZW5kID0gdHJ1ZTsKCQlkaXNwYXRjaC5jYWxsKCB0aGlzLCAicmVhZHlzdGF0ZWNoYW5nZSIgKTsKCgkJb2JqID0gcGFyc2VkLnByb3RvY29sID09PSAiaHR0cDoiID8gaHR0cCA6IGh0dHBzOwoKCQlyZXF1ZXN0ID0gb2JqLnJlcXVlc3QoIG9wdGlvbnMsIGZ1bmN0aW9uICggYXJnICkgewoJCQlzdWNjZXNzLmNhbGwoIHNlbGYsIGFyZyApOwoJCX0gKS5vbiggImVycm9yIiwgZnVuY3Rpb24gKCBlICkgewoJCQlmYWlsdXJlLmNhbGwoIHNlbGYsIGUgKTsKCQl9ICk7CgoJCWRhdGEgPT09IG51bGwgPyByZXF1ZXN0LnNldFNvY2tldEtlZXBBbGl2ZSggdHJ1ZSApIDogcmVxdWVzdC53cml0ZSggZGF0YSwgInV0ZjgiICk7CgkJdGhpcy5fcmVxdWVzdCA9IHJlcXVlc3Q7CgkJcmVxdWVzdC5lbmQoKTsKCgkJZGlzcGF0Y2guY2FsbCggdGhpcywgImxvYWRzdGFydCIgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9OwoKCS8qKgoJICogU2V0cyBhIHJlcXVlc3QgaGVhZGVyIG9mIGFuIFhNTEh0dHBSZXF1ZXN0IGluc3RhbmNlCgkgKgoJICogQG1ldGhvZCBzZXRSZXF1ZXN0SGVhZGVyCgkgKiBAbWVtYmVyT2YgWE1MSHR0cFJlcXVlc3QKCSAqIEBwYXJhbSB7U3RyaW5nfSBoZWFkZXIgSFRUUCBoZWFkZXIKCSAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSAgSGVhZGVyIHZhbHVlCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgIFhNTEh0dHBSZXF1ZXN0IGluc3RhbmNlCgkgKi8KCVhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5zZXRSZXF1ZXN0SGVhZGVyID0gZnVuY3Rpb24gKCBoZWFkZXIsIHZhbHVlICkgewoJCWlmICggdGhpcy5yZWFkeVN0YXRlICE9PSBPUEVORUQgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuaW52YWxpZFN0YXRlTm90VXNhYmxlICk7CgkJfQoJCWVsc2UgaWYgKCB0aGlzLl9zZW5kICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRTdGF0ZU5vdFNlbmRpbmcgKTsKCQl9CgoJCXRoaXMuX2hlYWRlcnNbaGVhZGVyLnRvTG93ZXJDYXNlKCldID0gdmFsdWU7CgoJCXJldHVybiB0aGlzOwoJfTsKCglyZXR1cm4gWE1MSHR0cFJlcXVlc3Q7Cn0KCi8qKgogKiBAbmFtZXNwYWNlIHhtbAogKiBAcHJpdmF0ZQogKi8KdmFyIHhtbCA9IHsKCS8qKgoJICogUmV0dXJucyBYTUwgKERvY3VtZW50KSBPYmplY3QgZnJvbSBhIFN0cmluZwoJICoKCSAqIEBtZXRob2QgZGVjb2RlCgkgKiBAbWVtYmVyT2YgeG1sCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBYTUwgU3RyaW5nCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBYTUwgT2JqZWN0IG9yIHVuZGVmaW5lZAoJICovCglkZWNvZGUgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQlpZiAoIHR5cGVvZiBhcmcgIT0gInN0cmluZyIgfHwgc3RyaW5nLmlzRW1wdHkoIGFyZyApICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCQl9CgoJCXJldHVybiBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKCBhcmcsICJ0ZXh0L3htbCIgKTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIFhNTCBTdHJpbmcgZnJvbSBhbiBPYmplY3Qgb3IgQXJyYXkKCSAqCgkgKiBAbWV0aG9kIGVuY29kZQoJICogQG1lbWJlck9mIHhtbAoJICogQHBhcmFtICB7TWl4ZWR9IGFyZyBPYmplY3Qgb3IgQXJyYXkgdG8gY2FzdCB0byBYTUwgU3RyaW5nCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgIFhNTCBTdHJpbmcgb3IgdW5kZWZpbmVkCgkgKi8KCWVuY29kZSA6IGZ1bmN0aW9uICggYXJnLCB3cmFwICkgewoJCXRyeSB7CgkJCWlmICggYXJnID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmludmFsaWRBcmd1bWVudHMgKTsKCQkJfQoKCQkJd3JhcCAgICA9ICggd3JhcCAhPT0gZmFsc2UgKTsKCQkJdmFyIHggICA9IHdyYXAgPyAiPHhtbD4iIDogIiIsCgkJCSAgICB0b3AgPSAoIGFyZ3VtZW50c1syXSAhPT0gZmFsc2UgKSwKCQkJICAgIG5vZGU7CgoJCQkvKioKCQkJICogRW5jb2RlcyBhIHZhbHVlIGFzIGEgbm9kZQoJCQkgKgoJCQkgKiBAbWV0aG9kIG5vZGUKCQkJICogQG1lbWJlck9mIHhtbC5lbmNvZGUKCQkJICogQHByaXZhdGUKCQkJICogQHBhcmFtICB7U3RyaW5nfSBuYW1lICBOb2RlIG5hbWUKCQkJICogQHBhcmFtICB7U3RyaW5nfSB2YWx1ZSBOb2RlIHZhbHVlCgkJCSAqIEByZXR1cm4ge1N0cmluZ30gICAgICAgTm9kZQoJCQkgKi8KCQkJbm9kZSA9IGZ1bmN0aW9uICggbmFtZSwgdmFsdWUgKSB7CgkJCQl2YXIgb3V0cHV0ID0gIjxuPnY8L24+IjsKCgkJCQlvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSggInYiLCAoIHJlZ2V4LmNkYXRhLnRlc3QoIHZhbHVlICkgPyAiPCFbQ0RBVEFbIiArIHZhbHVlICsgIl1dPiIgOiB2YWx1ZSApICk7CgkJCQlyZXR1cm4gb3V0cHV0LnJlcGxhY2UoLzwoXC8pP24+L2csICI8JDEiICsgbmFtZSArICI+Iik7CgkJCX07CgoJCQlpZiAoIGFyZyAhPT0gbnVsbCAmJiBhcmcueG1sICkgewoJCQkJYXJnID0gYXJnLnhtbDsKCQkJfQoKCQkJaWYgKCBhcmcgaW5zdGFuY2VvZiBEb2N1bWVudCApIHsKCQkJCWFyZyA9ICggbmV3IFhNTFNlcmlhbGl6ZXIoKSApLnNlcmlhbGl6ZVRvU3RyaW5nKCBhcmcgKTsKCQkJfQoKCQkJaWYgKCByZWdleC5ib29sZWFuX251bWJlcl9zdHJpbmcudGVzdCggdHlwZW9mIGFyZyApICkgewoJCQkJeCArPSBub2RlKCAiaXRlbSIsIGFyZyApOwoJCQl9CgkJCWVsc2UgaWYgKCB0eXBlb2YgYXJnID09ICJvYmplY3QiICkgewoJCQkJdXRpbGl0eS5pdGVyYXRlKCBhcmcsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCQl4ICs9IHhtbC5lbmNvZGUoIHYsICggdHlwZW9mIHYgPT0gIm9iamVjdCIgKSwgZmFsc2UgKS5yZXBsYWNlKCAvaXRlbXx4bWwvZywgaXNOYU4oIGsgKSA/IGsgOiAiaXRlbSIgKTsKCQkJCX0gKTsKCQkJfQoKCQkJeCArPSB3cmFwID8gIjwveG1sPiIgOiAiIjsKCgkJCWlmICggdG9wICkgewoJCQkJeCA9ICI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJVVEY4XCI/PiIgKyB4OwoJCQl9CgoJCQlyZXR1cm4geDsKCQl9CgkJY2F0Y2ggKCBlICkgewoJCQl1dGlsaXR5LmVycm9yKCBlLCBhcmd1bWVudHMsIHRoaXMgKTsKCgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoJfSwKCgkvKioKCSAqIFZhbGlkYXRlcyBgYXJnYCBpcyBYTUwKCSAqCgkgKiBAbWV0aG9kIHZhbGlkCgkgKiBAbWVtYmVyT2YgeG1sCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBTdHJpbmcgdG8gdmFsaWRhdGUKCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgIGB0cnVlYCBpZiB2YWxpZCBYTUwKCSAqLwoJdmFsaWQgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQlyZXR1cm4gKCB4bWwuZGVjb2RlKCBhcmcgKS5nZXRFbGVtZW50c0J5VGFnTmFtZSggInBhcnNlcmVycm9yIiApLmxlbmd0aCA9PT0gMCApOwoJfQp9OwoKLyoqCiAqIEJvb3RzdHJhcHMgZW52aXJvbm1lbnQKICoKICogQG1ldGhvZCBib290c3RyYXAKICogQHByaXZhdGUKICogQHJldHVybiB7VW5kZWZpbmVkfSB1bmRlZmluZWQKICovCmZ1bmN0aW9uIGJvb3RzdHJhcCAoKSB7CgkvLyBTZWNvbmQgcGhhc2UKCWZ1bmN0aW9uIGluaXQgKCkgewoJCVRJTUUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCgkJLy8gQ2FjaGUgZ2FyYmFnZSBjb2xsZWN0b3IgKGV2ZXJ5IG1pbnV0ZSkKCQl1dGlsaXR5LnJlcGVhdCggZnVuY3Rpb24gKCkgewoJCQljYWNoZS5jbGVhbigpOwoJCX0sIDYwMDAwLCAiY2FjaGVHYXJiYWdlQ29sbGVjdG9yIiApOwoJfQoKCS8vIFJlcGVhdGluZyBmdW5jdGlvbiB0byBjYWxsIGluaXQoKQoJZnVuY3Rpb24gZm4gKCkgewoJCWlmICggcmVnZXguY29tcGxldGVfbG9hZGVkLnRlc3QoIGRvY3VtZW50LnJlYWR5U3RhdGUgKSApIHsKCQkJaW5pdCgpOwoKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0KCgkvLyBEZXNjcmliaW5nIHRoZSBDbGllbnQKCWlmICggIXNlcnZlciApIHsKCQljbGllbnQudmVyc2lvbiA9IGNsaWVudC52ZXJzaW9uKCk7CgoJCS8vIElFOCBhbmQgb2xkZXIgaXMgbm90IHN1cHBvcnRlZAoJCWlmICggY2xpZW50LmllICYmIGNsaWVudC52ZXJzaW9uIDwgOSApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC51cGdyYWRlICk7CgkJfQoKCQkvLyBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIHNoaW0gZm9yIElFOQoJCWlmICggRWxlbWVudC5wcm90b3R5cGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9PT0gdW5kZWZpbmVkICkgewoJCQlFbGVtZW50LnByb3RvdHlwZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lID0gZnVuY3Rpb24gKCBhcmcgKSB7CgkJCQlyZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCggIi4iICsgYXJnICk7CgkJCX07CgkJfQoKCQkvLyBjbGFzc0xpc3Qgc2hpbSBmb3IgSUU5CgkJaWYgKCAhZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsYXNzTGlzdCApIHsKCQkJKCBmdW5jdGlvbiAoIHZpZXcgKSB7CgkJCQl2YXIgQ2xhc3NMaXN0LCBnZXR0ZXIsIHByb3RvLCB0YXJnZXQsIGRlc2NyaXB0b3I7CgoJCQkJaWYgKCAhKCAiSFRNTEVsZW1lbnQiIGluIHZpZXcgKSAmJiAhKCAiRWxlbWVudCIgaW4gdmlldyApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlDbGFzc0xpc3QgPSBmdW5jdGlvbiAoIG9iaiApIHsKCQkJCQl2YXIgY2xhc3NlcyA9IHN0cmluZy5leHBsb2RlKCBvYmouY2xhc3NOYW1lLCAiICIgKSwKCQkJCQkgICAgc2VsZiAgICA9IHRoaXM7CgoJCQkJCWFycmF5LmVhY2goIGNsYXNzZXMsIGZ1bmN0aW9uICggaSApIHsKCQkJCQkJc2VsZi5wdXNoKCBpICk7CgkJCQkJfSApOwoKCQkJCQl0aGlzLnVwZGF0ZUNsYXNzTmFtZSA9IGZ1bmN0aW9uICgpIHsKCQkJCQkJb2JqLmNsYXNzTmFtZSA9IHRoaXMuam9pbiggIiAiICk7CgkJCQkJfTsKCQkJCX07CgoJCQkJZ2V0dGVyID0gZnVuY3Rpb24gKCkgewoJCQkJCXJldHVybiBuZXcgQ2xhc3NMaXN0KCB0aGlzICk7CgkJCQl9OwoKCQkJCXByb3RvICA9IENsYXNzTGlzdC5wcm90b3R5cGUgPSBbXTsKCQkJCXRhcmdldCA9ICggdmlldy5IVE1MRWxlbWVudCB8fCB2aWV3LkVsZW1lbnQgKS5wcm90b3R5cGU7CgoJCQkJcHJvdG8uYWRkID0gZnVuY3Rpb24gKCBhcmcgKSB7CgkJCQkJaWYgKCAhYXJyYXkuY29udGFpbnMoIHRoaXMsIGFyZyApICkgewoJCQkJCQl0aGlzLnB1c2goIGFyZyApOwoJCQkJCQl0aGlzLnVwZGF0ZUNsYXNzTmFtZSgpOwoJCQkJCX0KCQkJCX07CgoJCQkJcHJvdG8uY29udGFpbnMgPSBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCQlyZXR1cm4gYXJyYXkuY29udGFpbnMoIHRoaXMsIGFyZyApOwoJCQkJfTsKCgkJCQlwcm90by5yZW1vdmUgPSBmdW5jdGlvbiAoIGFyZyApIHsKCQkJCQlpZiAoIGFycmF5LmNvbnRhaW5zKCB0aGlzLCBhcmcgKSApIHsKCQkJCQkJYXJyYXkucmVtb3ZlKCB0aGlzLCBhcmcgKTsKCQkJCQkJdGhpcy51cGRhdGVDbGFzc05hbWUoKTsKCQkJCQl9CgkJCQl9OwoKCQkJCXByb3RvLnRvZ2dsZSA9IGZ1bmN0aW9uICggYXJnICkgewoJCQkJCWFycmF5W2FycmF5LmNvbnRhaW5zKCB0aGlzLCBhcmcgKSA/ICJyZW1vdmUiIDogImFkZCJdKCB0aGlzLCBhcmcgKTsKCQkJCQl0aGlzLnVwZGF0ZUNsYXNzTmFtZSgpOwoJCQkJfTsKCgkJCQlpZiAoIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSApIHsKCQkJCQlkZXNjcmlwdG9yID0gewoJCQkJCQlnZXQgICAgICAgICAgOiBnZXR0ZXIsCgkJCQkJCWVudW1lcmFibGUgICA6IHRydWUsCgkJCQkJCWNvbmZpZ3VyYWJsZSA6IHRydWUKCQkJCQl9OwoKCQkJCQlPYmplY3QuZGVmaW5lUHJvcGVydHkoIHRhcmdldCwgImNsYXNzTGlzdCIsIGRlc2NyaXB0b3IgKTsKCQkJCX0KCQkJCWVsc2UgaWYgKCBPYmplY3QucHJvdG90eXBlLl9fZGVmaW5lR2V0dGVyX18pIHsKCQkJCQl0YXJnZXQuX19kZWZpbmVHZXR0ZXJfXyggImNsYXNzTGlzdCIsIGdldHRlciApOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJdGhyb3cgbmV3IEVycm9yKCAiQ291bGQgbm90IGNyZWF0ZSBjbGFzc0xpc3Qgc2hpbSIgKTsKCQkJCX0KCQkJfSApKCBnbG9iYWwgKTsKCQl9Cgl9CgllbHNlIHsKCQkvLyBYSFIgc2hpbQoJCVhNTEh0dHBSZXF1ZXN0ID0geGhyKCk7Cgl9CgoJLy8gQ2FjaGluZyBmdW5jdGlvbnMKCWhhcyAgID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCXNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKCS8vIERhdGFTdG9yZSBXb3JrZXIgInNjcmlwdCIKCWlmICggd2ViV29ya2VyICkgewoJCVdPUktFUiA9IGdsb2JhbC5VUkwuY3JlYXRlT2JqZWN0VVJMKCB1dGlsaXR5LmJsb2IoICJ2YXIgIiArIHN0cmluZy5mcm9tT2JqZWN0KCBhcnJheSwgImFycmF5IiApICsgIiwgIiArIHN0cmluZy5mcm9tT2JqZWN0KCByZWdleCwgInJlZ2V4IiApICsgIiwgIiArIHN0cmluZy5mcm9tT2JqZWN0KCBzdHJpbmcsICJzdHJpbmciICkgKyAiLCAiICsgc3RyaW5nLmZyb21PYmplY3QoIHV0aWxpdHksICJ1dGlsaXR5IiApICsgIjsgb25tZXNzYWdlID0gIiArIHN0b3JlLndvcmtlci50b1N0cmluZygpICsgIjsiICkgKTsKCX0KCgkvLyBTZXR0aW5nIHVwIGB1dGlsaXR5LnJlbmRlcigpYAoJUkVOREVSID0gZ2xvYmFsLnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCBmdW5jdGlvbiAoIGZuICkgewoJCXZhciBvZmZzZXQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIFRJTUU7CgoJCXV0aWxpdHkuZGVmZXIoIGZ1bmN0aW9uICgpIHsKCQkJZm4oIG9mZnNldCApOwoJCX0sIDE2LCBvZmZzZXQgKTsKCX07CgoJLy8gSW5pdGlhbGl6aW5nCglpZiAoIHR5cGVvZiBleHBvcnRzICE9ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiB8fCByZWdleC5jb21wbGV0ZV9sb2FkZWQudGVzdCggZG9jdW1lbnQucmVhZHlTdGF0ZSApICkgewoJCWluaXQoKTsKCX0KCWVsc2UgaWYgKCB0eXBlb2YgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciA9PSAiZnVuY3Rpb24iICkgewoJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJET01Db250ZW50TG9hZGVkIiAsIGZ1bmN0aW9uICgpIHsKCQkJaW5pdCgpOwoJCX0sIGZhbHNlICk7Cgl9CgllbHNlIGlmICggdHlwZW9mIGRvY3VtZW50LmF0dGFjaEV2ZW50ID09ICJmdW5jdGlvbiIgKSB7CgkJZG9jdW1lbnQuYXR0YWNoRXZlbnQoICJvbnJlYWR5c3RhdGVjaGFuZ2UiICwgZm4gKTsKCX0KCWVsc2UgewoJCXV0aWxpdHkucmVwZWF0KCBmbiApOwoJfQp9CgovLyBCb290c3RyYXBwaW5nCmJvb3RzdHJhcCgpOwoKLy8gSW50ZXJmYWNlCnJldHVybiB7CglmaWx0ZXIgIDogZmlsdGVyLmZhY3RvcnksCglsaXN0ICAgIDogbGlzdC5mYWN0b3J5LAoJZ3JpZCAgICA6IGdyaWQuZmFjdG9yeSwKCXN0b3JlICAgOiBzdG9yZS5mYWN0b3J5LAoJdXRpbCAgICA6IHsKCQkkICAgICAgICA6IHV0aWxpdHkuJCwKCQlhcnJheSAgICA6IGFycmF5LAoJCWJhc2UgICAgIDogdXRpbGl0eS5iYXNlLAoJCWNsb25lICAgIDogdXRpbGl0eS5jbG9uZSwKCQljb2VyY2UgICA6IHV0aWxpdHkuY29lcmNlLAoJCWN1cnJ5ICAgIDogdXRpbGl0eS5jdXJyeSwKCQljc3YgICAgICA6IGNzdiwKCQlkZWZlciAgICA6IGRlZmVycmVkLmZhY3RvcnksCgkJZWxlbWVudCAgOiBlbGVtZW50LAoJCWV4dGVuZCAgIDogdXRpbGl0eS5leHRlbmQsCgkJZ2VuSWQgICAgOiB1dGlsaXR5LmdlbklkLAoJCWl0ZXJhdGUgIDogdXRpbGl0eS5pdGVyYXRlLAoJCWpzb24gICAgIDoganNvbiwKCQlqc29ucCAgICA6IGNsaWVudC5qc29ucCwKCQlsb2cgICAgICA6IHV0aWxpdHkubG9nLAoJCWxydSAgICAgIDogbHJ1LmZhY3RvcnksCgkJbWF0aCAgICAgOiBtYXRoLAoJCW1lcmdlICAgIDogdXRpbGl0eS5tZXJnZSwKCQludW1iZXIgICA6IG51bWJlciwKCQlvYnNlcnZlciA6IG9ic2VydmFibGUuZmFjdG9yeSwKCQlwYXJzZSAgICA6IHV0aWxpdHkucGFyc2UsCgkJcGFydGlhbCAgOiB1dGlsaXR5LnBhcnRpYWwsCgkJcHJldmVudCAgOiB1dGlsaXR5LnByZXZlbnQsCgkJcmFjZSAgICAgOiB1dGlsaXR5LnJhY2UsCgkJcmVuZGVyICAgOiB1dGlsaXR5LnJlbmRlciwKCQlyZXBlYXQgICA6IHV0aWxpdHkucmVwZWF0LAoJCXJlcXVlc3QgIDogY2xpZW50LnJlcXVlc3QsCgkJc3RvcCAgICAgOiB1dGlsaXR5LnN0b3AsCgkJc3RyaW5nICAgOiBzdHJpbmcsCgkJdGFyZ2V0ICAgOiB1dGlsaXR5LnRhcmdldCwKCQl1dWlkICAgICA6IHV0aWxpdHkudXVpZCwKCQl3YWxrICAgICA6IHV0aWxpdHkud2FsaywKCQl3aGVuICAgICA6IHV0aWxpdHkud2hlbgoJfSwKCXZlcnNpb24gOiAiMC45LjAiCn07Cn0gKSgpOwoKLy8gTm9kZSwgQU1EICYgd2luZG93IHN1cHBvcnRlZAppZiAoIHR5cGVvZiBleHBvcnRzICE9ICJ1bmRlZmluZWQiICkgewoJbW9kdWxlLmV4cG9ydHMgPSBsaWI7Cn0KZWxzZSBpZiAoIHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiApIHsKCWRlZmluZSggZnVuY3Rpb24gKCkgewoJCXJldHVybiBsaWI7Cgl9ICk7Cn0KZWxzZSB7CglnbG9iYWwua2VpZ2FpID0gbGliOwp9Cn0gKSggdGhpcyApOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 07:59:18 GMT",
                    "Content-Length": "239063",
                    "Date": "Fri, 07 Nov 2014 07:59:19 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}