{
    "url": "http://localhost:9999/driftyco/ng-cordova/demo/www/lib/ionic/js/ionic.bundle.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>window.name = window.name.replace(NG_DEFER_BOOTSTRAP, '');</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/driftyco/ng-cordova/demo/www/lib/ionic/js/ionic.bundle.js",
                "path": "/driftyco/ng-cordova/demo/www/lib/ionic/js/ionic.bundle.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kcmlmdHljby9uZy1jb3Jkb3ZhL2RlbW8vd3d3L2xpYi9pb25pYy9qcy9pb25pYy5idW5kbGUuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTU2OTkxMA0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vamF2YXNjcmlwdA0KRGF0ZTogRnJpLCAwNyBOb3YgMjAxNCAxOTowMDowNCBHTVQNCkxhc3QtTW9kaWZpZWQ6IEZyaSwgMDcgTm92IDIwMTQgMTg6NTk6MzUgR01UDQoNCi8qIQogKiBpb25pYy5idW5kbGUuanMgaXMgYSBjb25jYXRlbmF0aW9uIG9mOgogKiBpb25pYy5qcywgYW5ndWxhci5qcywgYW5ndWxhci1hbmltYXRlLmpzLAogKiBhbmd1bGFyLXNhbml0aXplLmpzLCBhbmd1bGFyLXVpLXJvdXRlci5qcywKICogYW5kIGlvbmljLWFuZ3VsYXIuanMKICovCgovKiEKICogQ29weXJpZ2h0IDIwMTQgRHJpZnR5IENvLgogKiBodHRwOi8vZHJpZnR5LmNvbS8KICoKICogSW9uaWMsIHYxLjAuMC1iZXRhLjExCiAqIEEgcG93ZXJmdWwgSFRNTDUgbW9iaWxlIGFwcCBmcmFtZXdvcmsuCiAqIGh0dHA6Ly9pb25pY2ZyYW1ld29yay5jb20vCiAqCiAqIEJ5IEBtYXhseW5jaCwgQGJlbmpzcGVycnksIEBhZGFtZGJyYWRsZXkgPDMKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLiBQbGVhc2Ugc2VlIExJQ0VOU0UgZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAqCiAqLwoKKGZ1bmN0aW9uKCkgewoKLy8gQ3JlYXRlIG5hbWVzcGFjZXMKLy8KICB3aW5kb3cuaW9uaWMgPSB7CiAgICBjb250cm9sbGVyczoge30sCiAgICB2aWV3czoge30sCiAgICB2ZXJzaW9uOiAnMS4wLjAtYmV0YS4xMScKICB9OwoKICAoZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgaW9uaWMpIHsKCiAgICB2YXIgcmVhZHlDYWxsYmFja3MgPSBbXTsKICAgIHZhciBpc0RvbVJlYWR5ID0gZmFsc2U7CgogICAgZnVuY3Rpb24gZG9tUmVhZHkoKSB7CiAgICAgIGlzRG9tUmVhZHkgPSB0cnVlOwogICAgICBmb3IodmFyIHg9MDsgeDxyZWFkeUNhbGxiYWNrcy5sZW5ndGg7IHgrKykgewogICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShyZWFkeUNhbGxiYWNrc1t4XSk7CiAgICAgIH0KICAgICAgcmVhZHlDYWxsYmFja3MgPSBbXTsKICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbVJlYWR5KTsKICAgIH0KICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21SZWFkeSk7CgogICAgLy8gRnJvbSB0aGUgbWFuIGhpbXNlbGYsIE1yLiBQYXVsIElyaXNoLgogICAgLy8gVGhlIHJlcXVlc3RBbmltYXRpb25GcmFtZSBwb2x5ZmlsbAogICAgLy8gUHV0IGl0IG9uIHdpbmRvdyBqdXN0IHRvIHByZXNlcnZlIGl0cyBjb250ZXh0CiAgICAvLyB3aXRob3V0IGhhdmluZyB0byB1c2UgLmNhbGwKICAgIHdpbmRvdy5fckFGID0gKGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSAgICAgICB8fAogICAgICAgIHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICB3aW5kb3cubW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lICAgIHx8CiAgICAgICAgZnVuY3Rpb24oIGNhbGxiYWNrICl7CiAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChjYWxsYmFjaywgMTYpOwogICAgICAgIH07CiAgICB9KSgpOwoKICAgIHZhciBjYW5jZWxBbmltYXRpb25GcmFtZSA9IHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICB3aW5kb3cud2Via2l0Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgd2luZG93Lm1vekNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgIHdpbmRvdy53ZWJraXRDYW5jZWxSZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgdXRpbGl0eQogICAgICogQG5hbWUgaW9uaWMuRG9tVXRpbAogICAgICogQG1vZHVsZSBpb25pYwogICAgICovCiAgICBpb25pYy5Eb21VdGlsID0gewogICAgICAvL0NhbGwgd2l0aCBwcm9wZXIgY29udGV4dAogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI3JlcXVlc3RBbmltYXRpb25GcmFtZQogICAgICAgKiBAYWxpYXMgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lCiAgICAgICAqIEBkZXNjcmlwdGlvbiBDYWxscyBbcmVxdWVzdEFuaW1hdGlvbkZyYW1lXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSksIG9yIGEgcG9seWZpbGwgaWYgbm90IGF2YWlsYWJsZS4KICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGUgbmV4dCBmcmFtZQogICAgICAgKiBoYXBwZW5zLgogICAgICAgKi8KICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lOiBmdW5jdGlvbihjYikgewogICAgICAgIHJldHVybiB3aW5kb3cuX3JBRihjYik7CiAgICAgIH0sCgogICAgICBjYW5jZWxBbmltYXRpb25GcmFtZTogZnVuY3Rpb24ocmVxdWVzdElkKSB7CiAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUocmVxdWVzdElkKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjYW5pbWF0aW9uRnJhbWVUaHJvdHRsZQogICAgICAgKiBAYWxpYXMgaW9uaWMuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZQogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogV2hlbiBnaXZlbiBhIGNhbGxiYWNrLCBpZiB0aGF0IGNhbGxiYWNrIGlzIGNhbGxlZCAxMDAgdGltZXMgYmV0d2VlbgogICAgICAgKiBhbmltYXRpb24gZnJhbWVzLCBhZGRpbmcgVGhyb3R0bGUgd2lsbCBtYWtlIGl0IG9ubHkgcnVuIHRoZSBsYXN0IG9mCiAgICAgICAqIHRoZSAxMDAgY2FsbHMuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIGEgZnVuY3Rpb24gd2hpY2ggd2lsbCBiZSB0aHJvdHRsZWQgdG8KICAgICAgICogcmVxdWVzdEFuaW1hdGlvbkZyYW1lCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbn0gQSBmdW5jdGlvbiB3aGljaCB3aWxsIHRoZW4gY2FsbCB0aGUgcGFzc2VkIGluIGNhbGxiYWNrLgogICAgICAgKiBUaGUgcGFzc2VkIGluIGNhbGxiYWNrIHdpbGwgcmVjZWl2ZSB0aGUgY29udGV4dCB0aGUgcmV0dXJuZWQgZnVuY3Rpb24gaXMKICAgICAgICogY2FsbGVkIHdpdGguCiAgICAgICAqLwogICAgICBhbmltYXRpb25GcmFtZVRocm90dGxlOiBmdW5jdGlvbihjYikgewogICAgICAgIHZhciBhcmdzLCBpc1F1ZXVlZCwgY29udGV4dDsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgICAgICBpZiAoIWlzUXVldWVkKSB7CiAgICAgICAgICAgIGlzUXVldWVkID0gdHJ1ZTsKICAgICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGNiLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICAgIGlzUXVldWVkID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI2dldFBvc2l0aW9uSW5QYXJlbnQKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEZpbmQgYW4gZWxlbWVudCdzIHNjcm9sbCBvZmZzZXQgd2l0aGluIGl0cyBjb250YWluZXIuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCBUaGUgZWxlbWVudCB0byBmaW5kIHRoZSBvZmZzZXQgb2YuCiAgICAgICAqIEByZXR1cm5zIHtvYmplY3R9IEEgcG9zaXRpb24gb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICAgKiAgIC0gYHtudW1iZXJ9YCBgbGVmdGAgVGhlIGxlZnQgb2Zmc2V0IG9mIHRoZSBlbGVtZW50LgogICAgICAgKiAgIC0gYHtudW1iZXJ9YCBgdG9wYCBUaGUgdG9wIG9mZnNldCBvZiB0aGUgZWxlbWVudC4KICAgICAgICovCiAgICAgIGdldFBvc2l0aW9uSW5QYXJlbnQ6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGxlZnQ6IGVsLm9mZnNldExlZnQsCiAgICAgICAgICB0b3A6IGVsLm9mZnNldFRvcAogICAgICAgIH07CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI3JlYWR5CiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBDYWxsIGEgZnVuY3Rpb24gd2hlbiB0aGUgRE9NIGlzIHJlYWR5LCBvciBpZiBpdCBpcyBhbHJlYWR5IHJlYWR5CiAgICAgICAqIGNhbGwgdGhlIGZ1bmN0aW9uIGltbWVkaWF0ZWx5LgogICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gYmUgY2FsbGVkLgogICAgICAgKi8KICAgICAgcmVhZHk6IGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgaWYoaXNEb21SZWFkeSB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiKSB7CiAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoY2IpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZWFkeUNhbGxiYWNrcy5wdXNoKGNiKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI2dldFRleHRCb3VuZHMKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEdldCBhIHJlY3QgcmVwcmVzZW50aW5nIHRoZSBib3VuZHMgb2YgdGhlIGdpdmVuIHRleHROb2RlLgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IHRleHROb2RlIFRoZSB0ZXh0Tm9kZSB0byBmaW5kIHRoZSBib3VuZHMgb2YuCiAgICAgICAqIEByZXR1cm5zIHtvYmplY3R9IEFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIGJvdW5kcyBvZiB0aGUgbm9kZS4gUHJvcGVydGllczoKICAgICAgICogICAtIGB7bnVtYmVyfWAgYGxlZnRgIFRoZSBsZWZ0IHBvc2l0dG9uIG9mIHRoZSB0ZXh0Tm9kZS4KICAgICAgICogICAtIGB7bnVtYmVyfWAgYHJpZ2h0YCBUaGUgcmlnaHQgcG9zaXR0b24gb2YgdGhlIHRleHROb2RlLgogICAgICAgKiAgIC0gYHtudW1iZXJ9YCBgdG9wYCBUaGUgdG9wIHBvc2l0dG9uIG9mIHRoZSB0ZXh0Tm9kZS4KICAgICAgICogICAtIGB7bnVtYmVyfWAgYGJvdHRvbWAgVGhlIGJvdHRvbSBwb3NpdGlvbiBvZiB0aGUgdGV4dE5vZGUuCiAgICAgICAqICAgLSBge251bWJlcn1gIGB3aWR0aGAgVGhlIHdpZHRoIG9mIHRoZSB0ZXh0Tm9kZS4KICAgICAgICogICAtIGB7bnVtYmVyfWAgYGhlaWdodGAgVGhlIGhlaWdodCBvZiB0aGUgdGV4dE5vZGUuCiAgICAgICAqLwogICAgICBnZXRUZXh0Qm91bmRzOiBmdW5jdGlvbih0ZXh0Tm9kZSkgewogICAgICAgIGlmKGRvY3VtZW50LmNyZWF0ZVJhbmdlKSB7CiAgICAgICAgICB2YXIgcmFuZ2UgPSBkb2N1bWVudC5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgcmFuZ2Uuc2VsZWN0Tm9kZUNvbnRlbnRzKHRleHROb2RlKTsKICAgICAgICAgIGlmKHJhbmdlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCkgewogICAgICAgICAgICB2YXIgcmVjdCA9IHJhbmdlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICBpZihyZWN0KSB7CiAgICAgICAgICAgICAgdmFyIHN4ID0gd2luZG93LnNjcm9sbFg7CiAgICAgICAgICAgICAgdmFyIHN5ID0gd2luZG93LnNjcm9sbFk7CgogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB0b3A6IHJlY3QudG9wICsgc3ksCiAgICAgICAgICAgICAgICBsZWZ0OiByZWN0LmxlZnQgKyBzeCwKICAgICAgICAgICAgICAgIHJpZ2h0OiByZWN0LmxlZnQgKyBzeCArIHJlY3Qud2lkdGgsCiAgICAgICAgICAgICAgICBib3R0b206IHJlY3QudG9wICsgc3kgKyByZWN0LmhlaWdodCwKICAgICAgICAgICAgICAgIHdpZHRoOiByZWN0LndpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0OiByZWN0LmhlaWdodAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI2dldENoaWxkSW5kZXgKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEdldCB0aGUgZmlyc3QgaW5kZXggb2YgYSBjaGlsZCBub2RlIHdpdGhpbiB0aGUgZ2l2ZW4gZWxlbWVudCBvZiB0aGUKICAgICAgICogc3BlY2lmaWVkIHR5cGUuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCBUaGUgZWxlbWVudCB0byBmaW5kIHRoZSBpbmRleCBvZi4KICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIG5vZGVOYW1lIHRvIG1hdGNoIGNoaWxkcmVuIG9mIGVsZW1lbnQgYWdhaW5zdC4KICAgICAgICogQHJldHVybnMge251bWJlcn0gVGhlIGluZGV4LCBvciAtMSwgb2YgYSBjaGlsZCB3aXRoIG5vZGVOYW1lIG1hdGNoaW5nIHR5cGUuCiAgICAgICAqLwogICAgICBnZXRDaGlsZEluZGV4OiBmdW5jdGlvbihlbGVtZW50LCB0eXBlKSB7CiAgICAgICAgaWYodHlwZSkgewogICAgICAgICAgdmFyIGNoID0gZWxlbWVudC5wYXJlbnROb2RlLmNoaWxkcmVuOwogICAgICAgICAgdmFyIGM7CiAgICAgICAgICBmb3IodmFyIGkgPSAwLCBrID0gMCwgaiA9IGNoLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICAgICAgICBjID0gY2hbaV07CiAgICAgICAgICAgIGlmKGMubm9kZU5hbWUgJiYgYy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09IHR5cGUpIHsKICAgICAgICAgICAgICBpZihjID09IGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrKys7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGVsZW1lbnQucGFyZW50Tm9kZS5jaGlsZHJlbikuaW5kZXhPZihlbGVtZW50KTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAcHJpdmF0ZQogICAgICAgKi8KICAgICAgc3dhcE5vZGVzOiBmdW5jdGlvbihzcmMsIGRlc3QpIHsKICAgICAgICBkZXN0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHNyYywgZGVzdCk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQHByaXZhdGUKICAgICAgICovCiAgICAgIGNlbnRlckVsZW1lbnRCeU1hcmdpbjogZnVuY3Rpb24oZWwpIHsKICAgICAgICBlbC5zdHlsZS5tYXJnaW5MZWZ0ID0gKC1lbC5vZmZzZXRXaWR0aCkgLyAyICsgJ3B4JzsKICAgICAgICBlbC5zdHlsZS5tYXJnaW5Ub3AgPSAoLWVsLm9mZnNldEhlaWdodCkgLyAyICsgJ3B4JzsKICAgICAgfSwKICAgICAgLy9DZW50ZXIgdHdpY2UsIGFmdGVyIHJhZiwgdG8gZml4IGEgYnVnIHdpdGggaW9zIGFuZCBzaG93aW5nIGVsZW1lbnRzCiAgICAgIC8vdGhhdCBoYXZlIGp1c3QgYmVlbiBhdHRhY2hlZCB0byB0aGUgRE9NLgogICAgICBjZW50ZXJFbGVtZW50QnlNYXJnaW5Ud2ljZTogZnVuY3Rpb24oZWwpIHsKICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICBpb25pYy5Eb21VdGlsLmNlbnRlckVsZW1lbnRCeU1hcmdpbihlbCk7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpb25pYy5Eb21VdGlsLmNlbnRlckVsZW1lbnRCeU1hcmdpbihlbCk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaW9uaWMuRG9tVXRpbC5jZW50ZXJFbGVtZW50QnlNYXJnaW4oZWwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9LAoKICAgICAgZWxlbWVudElzRGVzY2VuZGFudDogZnVuY3Rpb24oZWwsIHBhcmVudCwgc3RvcEF0KSB7CiAgICAgICAgdmFyIGN1cnJlbnQgPSBlbDsKICAgICAgICBkbyB7CiAgICAgICAgICBpZiAoY3VycmVudCA9PT0gcGFyZW50KSByZXR1cm4gdHJ1ZTsKICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LnBhcmVudE5vZGU7CiAgICAgICAgfSB3aGlsZSAoY3VycmVudCAmJiBjdXJyZW50ICE9PSBzdG9wQXQpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjZ2V0UGFyZW50V2l0aENsYXNzCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudAogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lCiAgICAgICAqIEByZXR1cm5zIHtET01FbGVtZW50fSBUaGUgY2xvc2VzdCBwYXJlbnQgb2YgZWxlbWVudCBtYXRjaGluZyB0aGUKICAgICAgICogY2xhc3NOYW1lLCBvciBudWxsLgogICAgICAgKi8KICAgICAgZ2V0UGFyZW50V2l0aENsYXNzOiBmdW5jdGlvbihlLCBjbGFzc05hbWUsIGRlcHRoKSB7CiAgICAgICAgZGVwdGggPSBkZXB0aCB8fCAxMDsKICAgICAgICB3aGlsZShlLnBhcmVudE5vZGUgJiYgZGVwdGgtLSkgewogICAgICAgICAgaWYoZS5wYXJlbnROb2RlLmNsYXNzTGlzdCAmJiBlLnBhcmVudE5vZGUuY2xhc3NMaXN0LmNvbnRhaW5zKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGUucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIGUgPSBlLnBhcmVudE5vZGU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI2dldFBhcmVudE9yU2VsZldpdGhDbGFzcwogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzTmFtZQogICAgICAgKiBAcmV0dXJucyB7RE9NRWxlbWVudH0gVGhlIGNsb3Nlc3QgcGFyZW50IG9yIHNlbGYgbWF0Y2hpbmcgdGhlCiAgICAgICAqIGNsYXNzTmFtZSwgb3IgbnVsbC4KICAgICAgICovCiAgICAgIGdldFBhcmVudE9yU2VsZldpdGhDbGFzczogZnVuY3Rpb24oZSwgY2xhc3NOYW1lLCBkZXB0aCkgewogICAgICAgIGRlcHRoID0gZGVwdGggfHwgMTA7CiAgICAgICAgd2hpbGUoZSAmJiBkZXB0aC0tKSB7CiAgICAgICAgICBpZihlLmNsYXNzTGlzdCAmJiBlLmNsYXNzTGlzdC5jb250YWlucyhjbGFzc05hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBlOwogICAgICAgICAgfQogICAgICAgICAgZSA9IGUucGFyZW50Tm9kZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsI3JlY3RDb250YWlucwogICAgICAgKiBAcGFyYW0ge251bWJlcn0geAogICAgICAgKiBAcGFyYW0ge251bWJlcn0geQogICAgICAgKiBAcGFyYW0ge251bWJlcn0geDEKICAgICAgICogQHBhcmFtIHtudW1iZXJ9IHkxCiAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MgogICAgICAgKiBAcGFyYW0ge251bWJlcn0geTIKICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIge3gseX0gZml0cyB3aXRoaW4gdGhlIHJlY3RhbmdsZSBkZWZpbmVkIGJ5CiAgICAgICAqIHt4MSx5MSx4Mix5Mn0uCiAgICAgICAqLwogICAgICByZWN0Q29udGFpbnM6IGZ1bmN0aW9uKHgsIHksIHgxLCB5MSwgeDIsIHkyKSB7CiAgICAgICAgaWYoeCA8IHgxIHx8IHggPiB4MikgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmKHkgPCB5MSB8fCB5ID4geTIpIHJldHVybiBmYWxzZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfTsKCiAgICAvL1Nob3J0Y3V0cwogICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gaW9uaWMuRG9tVXRpbC5yZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CiAgICBpb25pYy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IGlvbmljLkRvbVV0aWwuY2FuY2VsQW5pbWF0aW9uRnJhbWU7CiAgICBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlID0gaW9uaWMuRG9tVXRpbC5hbmltYXRpb25GcmFtZVRocm90dGxlOwogIH0pKHdpbmRvdywgZG9jdW1lbnQsIGlvbmljKTsKCiAgLyoqCiAgICogaW9uLWV2ZW50cy5qcwogICAqCiAgICogQXV0aG9yOiBNYXggTHluY2ggPG1heEBkcmlmdHkuY29tPgogICAqCiAgICogRnJhbWV3b3JrIGV2ZW50cyBoYW5kbGVzIHZhcmlvdXMgbW9iaWxlIGJyb3dzZXIgZXZlbnRzLCBhbmQKICAgKiBkZXRlY3RzIHNwZWNpYWwgZXZlbnRzIGxpa2UgdGFwL3N3aXBlL2V0Yy4gYW5kIGVtaXRzIHRoZW0KICAgKiBhcyBjdXN0b20gZXZlbnRzIHRoYXQgY2FuIGJlIHVzZWQgaW4gYW4gYXBwLgogICAqCiAgICogUG9ydGlvbnMgbG92aW5nbHkgYWRhcHRlZCBmcm9tIGdpdGh1Yi5jb20vbWFrZXIvcmF0Y2hldCBhbmQgZ2l0aHViLmNvbS9hbGV4Z2lic29uL3RhcC5qcyAtIHRoYW5rcyBndXlzIQogICAqLwoKICAoZnVuY3Rpb24oaW9uaWMpIHsKCiAgICAvLyBDdXN0b20gZXZlbnQgcG9seWZpbGwKICAgIGlvbmljLkN1c3RvbUV2ZW50ID0gKGZ1bmN0aW9uKCkgewogICAgICBpZiggdHlwZW9mIHdpbmRvdy5DdXN0b21FdmVudCA9PT0gJ2Z1bmN0aW9uJyApIHJldHVybiBDdXN0b21FdmVudDsKCiAgICAgIHZhciBjdXN0b21FdmVudCA9IGZ1bmN0aW9uKGV2ZW50LCBwYXJhbXMpIHsKICAgICAgICB2YXIgZXZ0OwogICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7CiAgICAgICAgICBidWJibGVzOiBmYWxzZSwKICAgICAgICAgIGNhbmNlbGFibGU6IGZhbHNlLAogICAgICAgICAgZGV0YWlsOiB1bmRlZmluZWQKICAgICAgICB9OwogICAgICAgIHRyeSB7CiAgICAgICAgICBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiQ3VzdG9tRXZlbnQiKTsKICAgICAgICAgIGV2dC5pbml0Q3VzdG9tRXZlbnQoZXZlbnQsIHBhcmFtcy5idWJibGVzLCBwYXJhbXMuY2FuY2VsYWJsZSwgcGFyYW1zLmRldGFpbCk7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIC8vIGZhbGxiYWNrIGZvciBicm93c2VycyB0aGF0IGRvbid0IHN1cHBvcnQgY3JlYXRlRXZlbnQoJ0N1c3RvbUV2ZW50JykKICAgICAgICAgIGV2dCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJFdmVudCIpOwogICAgICAgICAgZm9yICh2YXIgcGFyYW0gaW4gcGFyYW1zKSB7CiAgICAgICAgICAgIGV2dFtwYXJhbV0gPSBwYXJhbXNbcGFyYW1dOwogICAgICAgICAgfQogICAgICAgICAgZXZ0LmluaXRFdmVudChldmVudCwgcGFyYW1zLmJ1YmJsZXMsIHBhcmFtcy5jYW5jZWxhYmxlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGV2dDsKICAgICAgfTsKICAgICAgY3VzdG9tRXZlbnQucHJvdG90eXBlID0gd2luZG93LkV2ZW50LnByb3RvdHlwZTsKICAgICAgcmV0dXJuIGN1c3RvbUV2ZW50OwogICAgfSkoKTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgdXRpbGl0eQogICAgICogQG5hbWUgaW9uaWMuRXZlbnRDb250cm9sbGVyCiAgICAgKiBAbW9kdWxlIGlvbmljCiAgICAgKi8KICAgIGlvbmljLkV2ZW50Q29udHJvbGxlciA9IHsKICAgICAgVklSVFVBTElaRURfRVZFTlRTOiBbJ3RhcCcsICdzd2lwZScsICdzd2lwZXJpZ2h0JywgJ3N3aXBlbGVmdCcsICdkcmFnJywgJ2hvbGQnLCAncmVsZWFzZSddLAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuRXZlbnRDb250cm9sbGVyI3RyaWdnZXIKICAgICAgICogQGFsaWFzIGlvbmljLnRyaWdnZXIKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50VHlwZSBUaGUgZXZlbnQgdG8gdHJpZ2dlci4KICAgICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgVGhlIGRhdGEgZm9yIHRoZSBldmVudC4gSGludDogcGFzcyBpbgogICAgICAgKiBge3RhcmdldDogdGFyZ2V0RWxlbWVudH1gCiAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IGJ1YmJsZXMgV2hldGhlciB0aGUgZXZlbnQgc2hvdWxkIGJ1YmJsZSB1cCB0aGUgRE9NLgogICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBjYW5jZWxhYmxlIFdoZXRoZXIgdGhlIGV2ZW50IHNob3VsZCBiZSBjYW5jZWxhYmxlLgogICAgICAgKi8KICAgICAgLy8gVHJpZ2dlciBhIG5ldyBldmVudAogICAgICB0cmlnZ2VyOiBmdW5jdGlvbihldmVudFR5cGUsIGRhdGEsIGJ1YmJsZXMsIGNhbmNlbGFibGUpIHsKICAgICAgICB2YXIgZXZlbnQgPSBuZXcgaW9uaWMuQ3VzdG9tRXZlbnQoZXZlbnRUeXBlLCB7CiAgICAgICAgICBkZXRhaWw6IGRhdGEsCiAgICAgICAgICBidWJibGVzOiAhIWJ1YmJsZXMsCiAgICAgICAgICBjYW5jZWxhYmxlOiAhIWNhbmNlbGFibGUKICAgICAgICB9KTsKCiAgICAgICAgLy8gTWFrZSBzdXJlIHRvIHRyaWdnZXIgdGhlIGV2ZW50IG9uIHRoZSBnaXZlbiB0YXJnZXQsIG9yIGRpc3BhdGNoIGl0IGZyb20KICAgICAgICAvLyB0aGUgd2luZG93IGlmIHdlIGRvbid0IGhhdmUgYW4gZXZlbnQgdGFyZ2V0CiAgICAgICAgZGF0YSAmJiBkYXRhLnRhcmdldCAmJiBkYXRhLnRhcmdldC5kaXNwYXRjaEV2ZW50ICYmIGRhdGEudGFyZ2V0LmRpc3BhdGNoRXZlbnQoZXZlbnQpIHx8IHdpbmRvdy5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLkV2ZW50Q29udHJvbGxlciNvbgogICAgICAgKiBAYWxpYXMgaW9uaWMub24KICAgICAgICogQGRlc2NyaXB0aW9uIExpc3RlbiB0byBhbiBldmVudCBvbiBhbiBlbGVtZW50LgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUgZXZlbnQgdG8gbGlzdGVuIGZvci4KICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGxpc3RlbmVyIHRvIGJlIGNhbGxlZC4KICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIGxpc3RlbiBmb3IgdGhlIGV2ZW50IG9uLgogICAgICAgKi8KICAgICAgb246IGZ1bmN0aW9uKHR5cGUsIGNhbGxiYWNrLCBlbGVtZW50KSB7CiAgICAgICAgdmFyIGUgPSBlbGVtZW50IHx8IHdpbmRvdzsKCiAgICAgICAgLy8gQmluZCBhIGdlc3R1cmUgaWYgaXQncyBhIHZpcnR1YWwgZXZlbnQKICAgICAgICBmb3IodmFyIGkgPSAwLCBqID0gdGhpcy5WSVJUVUFMSVpFRF9FVkVOVFMubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICBpZih0eXBlID09IHRoaXMuVklSVFVBTElaRURfRVZFTlRTW2ldKSB7CiAgICAgICAgICAgIHZhciBnZXN0dXJlID0gbmV3IGlvbmljLkdlc3R1cmUoZWxlbWVudCk7CiAgICAgICAgICAgIGdlc3R1cmUub24odHlwZSwgY2FsbGJhY2spOwogICAgICAgICAgICByZXR1cm4gZ2VzdHVyZTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE90aGVyd2lzZSBiaW5kIGEgbm9ybWFsIGV2ZW50CiAgICAgICAgZS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGNhbGxiYWNrKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLkV2ZW50Q29udHJvbGxlciNvZmYKICAgICAgICogQGFsaWFzIGlvbmljLm9mZgogICAgICAgKiBAZGVzY3JpcHRpb24gUmVtb3ZlIGFuIGV2ZW50IGxpc3RlbmVyLgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZQogICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjawogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQKICAgICAgICovCiAgICAgIG9mZjogZnVuY3Rpb24odHlwZSwgY2FsbGJhY2ssIGVsZW1lbnQpIHsKICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgY2FsbGJhY2spOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuRXZlbnRDb250cm9sbGVyI29uR2VzdHVyZQogICAgICAgKiBAYWxpYXMgaW9uaWMub25HZXN0dXJlCiAgICAgICAqIEBkZXNjcmlwdGlvbiBBZGQgYW4gZXZlbnQgbGlzdGVuZXIgZm9yIGEgZ2VzdHVyZSBvbiBhbiBlbGVtZW50LgogICAgICAgKgogICAgICAgKiBBdmFpbGFibGUgZXZlbnRUeXBlcyAoZnJvbSBbaGFtbWVyLmpzXShodHRwOi8vZWlnaHRtZWRpYS5naXRodWIuaW8vaGFtbWVyLmpzLykpOgogICAgICAgKgogICAgICAgKiBgaG9sZGAsIGB0YXBgLCBgZG91YmxldGFwYCwgYGRyYWdgLCBgZHJhZ3N0YXJ0YCwgYGRyYWdlbmRgLCBgZHJhZ3VwYCwgYGRyYWdkb3duYCwgPGJyLz4KICAgICAgICogYGRyYWdsZWZ0YCwgYGRyYWdyaWdodGAsIGBzd2lwZWAsIGBzd2lwZXVwYCwgYHN3aXBlZG93bmAsIGBzd2lwZWxlZnRgLCBgc3dpcGVyaWdodGAsIDxici8+CiAgICAgICAqIGB0cmFuc2Zvcm1gLCBgdHJhbnNmb3Jtc3RhcnRgLCBgdHJhbnNmb3JtZW5kYCwgYHJvdGF0ZWAsIGBwaW5jaGAsIGBwaW5jaGluYCwgYHBpbmNob3V0YCwgPC9icj4KICAgICAgICogYHRvdWNoYCwgYHJlbGVhc2VgCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudFR5cGUgVGhlIGdlc3R1cmUgZXZlbnQgdG8gbGlzdGVuIGZvci4KICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihlKX0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGUgZ2VzdHVyZQogICAgICAgKiBoYXBwZW5zLgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgVGhlIGFuZ3VsYXIgZWxlbWVudCB0byBsaXN0ZW4gZm9yIHRoZSBldmVudCBvbi4KICAgICAgICovCiAgICAgIG9uR2VzdHVyZTogZnVuY3Rpb24odHlwZSwgY2FsbGJhY2ssIGVsZW1lbnQpIHsKICAgICAgICB2YXIgZ2VzdHVyZSA9IG5ldyBpb25pYy5HZXN0dXJlKGVsZW1lbnQpOwogICAgICAgIGdlc3R1cmUub24odHlwZSwgY2FsbGJhY2spOwogICAgICAgIHJldHVybiBnZXN0dXJlOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuRXZlbnRDb250cm9sbGVyI29mZkdlc3R1cmUKICAgICAgICogQGFsaWFzIGlvbmljLm9mZkdlc3R1cmUKICAgICAgICogQGRlc2NyaXB0aW9uIFJlbW92ZSBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBnZXN0dXJlIG9uIGFuIGVsZW1lbnQuCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudFR5cGUgVGhlIGdlc3R1cmUgZXZlbnQuCiAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZSl9IGNhbGxiYWNrIFRoZSBsaXN0ZW5lciB0aGF0IHdhcyBhZGRlZCBlYXJsaWVyLgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgVGhlIGVsZW1lbnQgdGhlIGxpc3RlbmVyIHdhcyBhZGRlZCBvbi4KICAgICAgICovCiAgICAgIG9mZkdlc3R1cmU6IGZ1bmN0aW9uKGdlc3R1cmUsIHR5cGUsIGNhbGxiYWNrKSB7CiAgICAgICAgZ2VzdHVyZS5vZmYodHlwZSwgY2FsbGJhY2spOwogICAgICB9LAoKICAgICAgaGFuZGxlUG9wU3RhdGU6IGZ1bmN0aW9uKGV2ZW50KSB7fQogICAgfTsKCgogICAgLy8gTWFwIHNvbWUgY29udmVuaWVudCB0b3AtbGV2ZWwgZnVuY3Rpb25zIGZvciBldmVudCBoYW5kbGluZwogICAgaW9uaWMub24gPSBmdW5jdGlvbigpIHsgaW9uaWMuRXZlbnRDb250cm9sbGVyLm9uLmFwcGx5KGlvbmljLkV2ZW50Q29udHJvbGxlciwgYXJndW1lbnRzKTsgfTsKICAgIGlvbmljLm9mZiA9IGZ1bmN0aW9uKCkgeyBpb25pYy5FdmVudENvbnRyb2xsZXIub2ZmLmFwcGx5KGlvbmljLkV2ZW50Q29udHJvbGxlciwgYXJndW1lbnRzKTsgfTsKICAgIGlvbmljLnRyaWdnZXIgPSBpb25pYy5FdmVudENvbnRyb2xsZXIudHJpZ2dlcjsvL2Z1bmN0aW9uKCkgeyBpb25pYy5FdmVudENvbnRyb2xsZXIudHJpZ2dlci5hcHBseShpb25pYy5FdmVudENvbnRyb2xsZXIudHJpZ2dlciwgYXJndW1lbnRzKTsgfTsKICAgIGlvbmljLm9uR2VzdHVyZSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gaW9uaWMuRXZlbnRDb250cm9sbGVyLm9uR2VzdHVyZS5hcHBseShpb25pYy5FdmVudENvbnRyb2xsZXIub25HZXN0dXJlLCBhcmd1bWVudHMpOyB9OwogICAgaW9uaWMub2ZmR2VzdHVyZSA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gaW9uaWMuRXZlbnRDb250cm9sbGVyLm9mZkdlc3R1cmUuYXBwbHkoaW9uaWMuRXZlbnRDb250cm9sbGVyLm9mZkdlc3R1cmUsIGFyZ3VtZW50cyk7IH07CgogIH0pKHdpbmRvdy5pb25pYyk7CgogIC8qKgogICAqIFNpbXBsZSBnZXN0dXJlIGNvbnRyb2xsZXJzIHdpdGggc29tZSBjb21tb24gZ2VzdHVyZXMgdGhhdCBlbWl0CiAgICogZ2VzdHVyZSBldmVudHMuCiAgICoKICAgKiBQb3J0ZWQgZnJvbSBnaXRodWIuY29tL0VpZ2h0TWVkaWEvaGFtbWVyLmpzIEdlc3R1cmVzIC0gdGhhbmtzIQogICAqLwogIChmdW5jdGlvbihpb25pYykgewoKICAgIC8qKgogICAgICogaW9uaWMuR2VzdHVyZXMKICAgICAqIHVzZSB0aGlzIHRvIGNyZWF0ZSBpbnN0YW5jZXMKICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBlbGVtZW50CiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgICAgb3B0aW9ucwogICAgICogQHJldHVybnMge2lvbmljLkdlc3R1cmVzLkluc3RhbmNlfQogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKi8KICAgIGlvbmljLkdlc3R1cmUgPSBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CiAgICAgIHJldHVybiBuZXcgaW9uaWMuR2VzdHVyZXMuSW5zdGFuY2UoZWxlbWVudCwgb3B0aW9ucyB8fCB7fSk7CiAgICB9OwoKICAgIGlvbmljLkdlc3R1cmVzID0ge307CgogICAgLy8gZGVmYXVsdCBzZXR0aW5ncwogICAgaW9uaWMuR2VzdHVyZXMuZGVmYXVsdHMgPSB7CiAgICAgIC8vIGFkZCBjc3MgdG8gdGhlIGVsZW1lbnQgdG8gcHJldmVudCB0aGUgYnJvd3NlciBmcm9tIGRvaW5nCiAgICAgIC8vIGl0cyBuYXRpdmUgYmVoYXZpb3IuIHRoaXMgZG9lc250IHByZXZlbnQgdGhlIHNjcm9sbGluZywKICAgICAgLy8gYnV0IGNhbmNlbHMgdGhlIGNvbnRleHRtZW51LCB0YXAgaGlnaGxpZ2h0aW5nIGV0YwogICAgICAvLyBzZXQgdG8gZmFsc2UgdG8gZGlzYWJsZSB0aGlzCiAgICAgIHN0b3BfYnJvd3Nlcl9iZWhhdmlvcjogJ2Rpc2FibGUtdXNlci1iZWhhdmlvcicKICAgIH07CgogICAgLy8gZGV0ZWN0IHRvdWNoZXZlbnRzCiAgICBpb25pYy5HZXN0dXJlcy5IQVNfUE9JTlRFUkVWRU5UUyA9IHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQgfHwgd2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkOwogICAgaW9uaWMuR2VzdHVyZXMuSEFTX1RPVUNIRVZFTlRTID0gKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdyk7CgogICAgLy8gZG9udCB1c2UgbW91c2VldmVudHMgb24gbW9iaWxlIGRldmljZXMKICAgIGlvbmljLkdlc3R1cmVzLk1PQklMRV9SRUdFWCA9IC9tb2JpbGV8dGFibGV0fGlwKGFkfGhvbmV8b2QpfGFuZHJvaWR8c2lsay9pOwogICAgaW9uaWMuR2VzdHVyZXMuTk9fTU9VU0VFVkVOVFMgPSBpb25pYy5HZXN0dXJlcy5IQVNfVE9VQ0hFVkVOVFMgJiYgd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goaW9uaWMuR2VzdHVyZXMuTU9CSUxFX1JFR0VYKTsKCiAgICAvLyBldmVudHR5cGVzIHBlciB0b3VjaGV2ZW50IChzdGFydCwgbW92ZSwgZW5kKQogICAgLy8gYXJlIGZpbGxlZCBieSBpb25pYy5HZXN0dXJlcy5ldmVudC5kZXRlcm1pbmVFdmVudFR5cGVzIG9uIHNldHVwCiAgICBpb25pYy5HZXN0dXJlcy5FVkVOVF9UWVBFUyA9IHt9OwoKICAgIC8vIGRpcmVjdGlvbiBkZWZpbmVzCiAgICBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fRE9XTiA9ICdkb3duJzsKICAgIGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9MRUZUID0gJ2xlZnQnOwogICAgaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1VQID0gJ3VwJzsKICAgIGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9SSUdIVCA9ICdyaWdodCc7CgogICAgLy8gcG9pbnRlciB0eXBlCiAgICBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX01PVVNFID0gJ21vdXNlJzsKICAgIGlvbmljLkdlc3R1cmVzLlBPSU5URVJfVE9VQ0ggPSAndG91Y2gnOwogICAgaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9QRU4gPSAncGVuJzsKCiAgICAvLyB0b3VjaCBldmVudCBkZWZpbmVzCiAgICBpb25pYy5HZXN0dXJlcy5FVkVOVF9TVEFSVCA9ICdzdGFydCc7CiAgICBpb25pYy5HZXN0dXJlcy5FVkVOVF9NT1ZFID0gJ21vdmUnOwogICAgaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EID0gJ2VuZCc7CgogICAgLy8gaGFtbWVyIGRvY3VtZW50IHdoZXJlIHRoZSBiYXNlIGV2ZW50cyBhcmUgYWRkZWQgYXQKICAgIGlvbmljLkdlc3R1cmVzLkRPQ1VNRU5UID0gd2luZG93LmRvY3VtZW50OwoKICAgIC8vIHBsdWdpbnMgbmFtZXNwYWNlCiAgICBpb25pYy5HZXN0dXJlcy5wbHVnaW5zID0ge307CgogICAgLy8gaWYgdGhlIHdpbmRvdyBldmVudHMgYXJlIHNldC4uLgogICAgaW9uaWMuR2VzdHVyZXMuUkVBRFkgPSBmYWxzZTsKCiAgICAvKioKICAgICAqIHNldHVwIGV2ZW50cyB0byBkZXRlY3QgZ2VzdHVyZXMgb24gdGhlIGRvY3VtZW50CiAgICAgKi8KICAgIGZ1bmN0aW9uIHNldHVwKCkgewogICAgICBpZihpb25pYy5HZXN0dXJlcy5SRUFEWSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gZmluZCB3aGF0IGV2ZW50dHlwZXMgd2UgYWRkIGxpc3RlbmVycyB0bwogICAgICBpb25pYy5HZXN0dXJlcy5ldmVudC5kZXRlcm1pbmVFdmVudFR5cGVzKCk7CgogICAgICAvLyBSZWdpc3RlciBhbGwgZ2VzdHVyZXMgaW5zaWRlIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzCiAgICAgIGZvcih2YXIgbmFtZSBpbiBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcykgewogICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24ucmVnaXN0ZXIoaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXNbbmFtZV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQWRkIHRvdWNoIGV2ZW50cyBvbiB0aGUgZG9jdW1lbnQKICAgICAgaW9uaWMuR2VzdHVyZXMuZXZlbnQub25Ub3VjaChpb25pYy5HZXN0dXJlcy5ET0NVTUVOVCwgaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRSwgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmRldGVjdCk7CiAgICAgIGlvbmljLkdlc3R1cmVzLmV2ZW50Lm9uVG91Y2goaW9uaWMuR2VzdHVyZXMuRE9DVU1FTlQsIGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORCwgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmRldGVjdCk7CgogICAgICAvLyBpb25pYy5HZXN0dXJlcyBpcyByZWFkeS4uLiEKICAgICAgaW9uaWMuR2VzdHVyZXMuUkVBRFkgPSB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogY3JlYXRlIG5ldyBoYW1tZXIgaW5zdGFuY2UKICAgICAqIGFsbCBtZXRob2RzIHNob3VsZCByZXR1cm4gdGhlIGluc3RhbmNlIGl0c2VsZiwgc28gaXQgaXMgY2hhaW5hYmxlLgogICAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgICAgICBlbGVtZW50CiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgICAgICAgIFtvcHRpb25zPXt9XQogICAgICogQHJldHVybnMge2lvbmljLkdlc3R1cmVzLkluc3RhbmNlfQogICAgICogQG5hbWUgR2VzdHVyZS5JbnN0YW5jZQogICAgICogQGNvbnN0cnVjdG9yCiAgICAgKi8KICAgIGlvbmljLkdlc3R1cmVzLkluc3RhbmNlID0gZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucykgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAvLyBBIG51bGwgZWxlbWVudCB3YXMgcGFzc2VkIGludG8gdGhlIGluc3RhbmNlLCB3aGljaCBtZWFucwogICAgICAvLyB3aGF0ZXZlciBsb29rdXAgd2FzIGRvbmUgdG8gZmluZCB0aGlzIGVsZW1lbnQgZmFpbGVkIHRvIGZpbmQgaXQKICAgICAgLy8gc28gd2UgY2FuJ3QgbGlzdGVuIGZvciBldmVudHMgb24gaXQuCiAgICAgIGlmKGVsZW1lbnQgPT09IG51bGwpIHsKICAgICAgICB2b2lkIDA7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBzZXR1cCBpb25pYy5HZXN0dXJlc0pTIHdpbmRvdyBldmVudHMgYW5kIHJlZ2lzdGVyIGFsbCBnZXN0dXJlcwogICAgICAvLyB0aGlzIGFsc28gc2V0cyB1cCB0aGUgZGVmYXVsdCBvcHRpb25zCiAgICAgIHNldHVwKCk7CgogICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwoKICAgICAgLy8gc3RhcnQvc3RvcCBkZXRlY3Rpb24gb3B0aW9uCiAgICAgIHRoaXMuZW5hYmxlZCA9IHRydWU7CgogICAgICAvLyBtZXJnZSBvcHRpb25zCiAgICAgIHRoaXMub3B0aW9ucyA9IGlvbmljLkdlc3R1cmVzLnV0aWxzLmV4dGVuZCgKICAgICAgICBpb25pYy5HZXN0dXJlcy51dGlscy5leHRlbmQoe30sIGlvbmljLkdlc3R1cmVzLmRlZmF1bHRzKSwKICAgICAgICAgIG9wdGlvbnMgfHwge30pOwoKICAgICAgLy8gYWRkIHNvbWUgY3NzIHRvIHRoZSBlbGVtZW50IHRvIHByZXZlbnQgdGhlIGJyb3dzZXIgZnJvbSBkb2luZyBpdHMgbmF0aXZlIGJlaGF2b2lyCiAgICAgIGlmKHRoaXMub3B0aW9ucy5zdG9wX2Jyb3dzZXJfYmVoYXZpb3IpIHsKICAgICAgICBpb25pYy5HZXN0dXJlcy51dGlscy5zdG9wRGVmYXVsdEJyb3dzZXJCZWhhdmlvcih0aGlzLmVsZW1lbnQsIHRoaXMub3B0aW9ucy5zdG9wX2Jyb3dzZXJfYmVoYXZpb3IpOwogICAgICB9CgogICAgICAvLyBzdGFydCBkZXRlY3Rpb24gb24gdG91Y2hzdGFydAogICAgICBpb25pYy5HZXN0dXJlcy5ldmVudC5vblRvdWNoKGVsZW1lbnQsIGlvbmljLkdlc3R1cmVzLkVWRU5UX1NUQVJULCBmdW5jdGlvbihldikgewogICAgICAgIGlmKHNlbGYuZW5hYmxlZCkgewogICAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLnN0YXJ0RGV0ZWN0KHNlbGYsIGV2KTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gcmV0dXJuIGluc3RhbmNlCiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCgogICAgaW9uaWMuR2VzdHVyZXMuSW5zdGFuY2UucHJvdG90eXBlID0gewogICAgICAvKioKICAgICAgICogYmluZCBldmVudHMgdG8gdGhlIGluc3RhbmNlCiAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgZ2VzdHVyZQogICAgICAgKiBAcGFyYW0gICB7RnVuY3Rpb259ICAgIGhhbmRsZXIKICAgICAgICogQHJldHVybnMge2lvbmljLkdlc3R1cmVzLkluc3RhbmNlfQogICAgICAgKi8KICAgICAgb246IGZ1bmN0aW9uIG9uRXZlbnQoZ2VzdHVyZSwgaGFuZGxlcil7CiAgICAgICAgdmFyIGdlc3R1cmVzID0gZ2VzdHVyZS5zcGxpdCgnICcpOwogICAgICAgIGZvcih2YXIgdD0wOyB0PGdlc3R1cmVzLmxlbmd0aDsgdCsrKSB7CiAgICAgICAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihnZXN0dXJlc1t0XSwgaGFuZGxlciwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogdW5iaW5kIGV2ZW50cyB0byB0aGUgaW5zdGFuY2UKICAgICAgICogQHBhcmFtICAge1N0cmluZ30gICAgICBnZXN0dXJlCiAgICAgICAqIEBwYXJhbSAgIHtGdW5jdGlvbn0gICAgaGFuZGxlcgogICAgICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9CiAgICAgICAqLwogICAgICBvZmY6IGZ1bmN0aW9uIG9mZkV2ZW50KGdlc3R1cmUsIGhhbmRsZXIpewogICAgICAgIHZhciBnZXN0dXJlcyA9IGdlc3R1cmUuc3BsaXQoJyAnKTsKICAgICAgICBmb3IodmFyIHQ9MDsgdDxnZXN0dXJlcy5sZW5ndGg7IHQrKykgewogICAgICAgICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZ2VzdHVyZXNbdF0sIGhhbmRsZXIsIGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIHRyaWdnZXIgZ2VzdHVyZSBldmVudAogICAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgIGdlc3R1cmUKICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgICBldmVudERhdGEKICAgICAgICogQHJldHVybnMge2lvbmljLkdlc3R1cmVzLkluc3RhbmNlfQogICAgICAgKi8KICAgICAgdHJpZ2dlcjogZnVuY3Rpb24gdHJpZ2dlckV2ZW50KGdlc3R1cmUsIGV2ZW50RGF0YSl7CiAgICAgICAgLy8gY3JlYXRlIERPTSBldmVudAogICAgICAgIHZhciBldmVudCA9IGlvbmljLkdlc3R1cmVzLkRPQ1VNRU5ULmNyZWF0ZUV2ZW50KCdFdmVudCcpOwogICAgICAgIGV2ZW50LmluaXRFdmVudChnZXN0dXJlLCB0cnVlLCB0cnVlKTsKICAgICAgICBldmVudC5nZXN0dXJlID0gZXZlbnREYXRhOwoKICAgICAgICAvLyB0cmlnZ2VyIG9uIHRoZSB0YXJnZXQgaWYgaXQgaXMgaW4gdGhlIGluc3RhbmNlIGVsZW1lbnQsCiAgICAgICAgLy8gdGhpcyBpcyBmb3IgZXZlbnQgZGVsZWdhdGlvbiB0cmlja3MKICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKICAgICAgICBpZihpb25pYy5HZXN0dXJlcy51dGlscy5oYXNQYXJlbnQoZXZlbnREYXRhLnRhcmdldCwgZWxlbWVudCkpIHsKICAgICAgICAgIGVsZW1lbnQgPSBldmVudERhdGEudGFyZ2V0OwogICAgICAgIH0KCiAgICAgICAgZWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogZW5hYmxlIG9mIGRpc2FibGUgaGFtbWVyLmpzIGRldGVjdGlvbgogICAgICAgKiBAcGFyYW0gICB7Qm9vbGVhbn0gICBzdGF0ZQogICAgICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9CiAgICAgICAqLwogICAgICBlbmFibGU6IGZ1bmN0aW9uIGVuYWJsZShzdGF0ZSkgewogICAgICAgIHRoaXMuZW5hYmxlZCA9IHN0YXRlOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogdGhpcyBob2xkcyB0aGUgbGFzdCBtb3ZlIGV2ZW50LAogICAgICogdXNlZCB0byBmaXggZW1wdHkgdG91Y2hlbmQgaXNzdWUKICAgICAqIHNlZSB0aGUgb25Ub3VjaCBldmVudCBmb3IgYW4gZXhwbGFuYXRpb24KICAgICAqIHR5cGUge09iamVjdH0KICAgICAqLwogICAgdmFyIGxhc3RfbW92ZV9ldmVudCA9IG51bGw7CgoKICAgIC8qKgogICAgICogd2hlbiB0aGUgbW91c2UgaXMgaG9sZCBkb3duLCB0aGlzIGlzIHRydWUKICAgICAqIHR5cGUge0Jvb2xlYW59CiAgICAgKi8KICAgIHZhciBlbmFibGVfZGV0ZWN0ID0gZmFsc2U7CgoKICAgIC8qKgogICAgICogd2hlbiB0b3VjaCBldmVudHMgaGF2ZSBiZWVuIGZpcmVkLCB0aGlzIGlzIHRydWUKICAgICAqIHR5cGUge0Jvb2xlYW59CiAgICAgKi8KICAgIHZhciB0b3VjaF90cmlnZ2VyZWQgPSBmYWxzZTsKCgogICAgaW9uaWMuR2VzdHVyZXMuZXZlbnQgPSB7CiAgICAgIC8qKgogICAgICAgKiBzaW1wbGUgYWRkRXZlbnRMaXN0ZW5lcgogICAgICAgKiBAcGFyYW0gICB7SFRNTEVsZW1lbnR9ICAgZWxlbWVudAogICAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgICAgdHlwZQogICAgICAgKiBAcGFyYW0gICB7RnVuY3Rpb259ICAgICAgaGFuZGxlcgogICAgICAgKi8KICAgICAgYmluZERvbTogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgaGFuZGxlcikgewogICAgICAgIHZhciB0eXBlcyA9IHR5cGUuc3BsaXQoJyAnKTsKICAgICAgICBmb3IodmFyIHQ9MDsgdDx0eXBlcy5sZW5ndGg7IHQrKykgewogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHR5cGVzW3RdLCBoYW5kbGVyLCBmYWxzZSk7CiAgICAgICAgfQogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiB0b3VjaCBldmVudHMgd2l0aCBtb3VzZSBmYWxsYmFjawogICAgICAgKiBAcGFyYW0gICB7SFRNTEVsZW1lbnR9ICAgZWxlbWVudAogICAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgICAgZXZlbnRUeXBlICAgICAgICBsaWtlIGlvbmljLkdlc3R1cmVzLkVWRU5UX01PVkUKICAgICAgICogQHBhcmFtICAge0Z1bmN0aW9ufSAgICAgIGhhbmRsZXIKICAgICAgICovCiAgICAgIG9uVG91Y2g6IGZ1bmN0aW9uIG9uVG91Y2goZWxlbWVudCwgZXZlbnRUeXBlLCBoYW5kbGVyKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICB0aGlzLmJpbmREb20oZWxlbWVudCwgaW9uaWMuR2VzdHVyZXMuRVZFTlRfVFlQRVNbZXZlbnRUeXBlXSwgZnVuY3Rpb24gYmluZERvbU9uVG91Y2goZXYpIHsKICAgICAgICAgIHZhciBzb3VyY2VFdmVudFR5cGUgPSBldi50eXBlLnRvTG93ZXJDYXNlKCk7CgogICAgICAgICAgLy8gb25tb3VzZXVwLCBidXQgd2hlbiB0b3VjaGVuZCBoYXMgYmVlbiBmaXJlZCB3ZSBkbyBub3RoaW5nLgogICAgICAgICAgLy8gdGhpcyBpcyBmb3IgdG91Y2hkZXZpY2VzIHdoaWNoIGFsc28gZmlyZSBhIG1vdXNldXAgb24gdG91Y2hlbmQKICAgICAgICAgIGlmKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvbW91c2UvKSAmJiB0b3VjaF90cmlnZ2VyZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIG1vdXNlYnV0dG9uIG11c3QgYmUgZG93biBvciBhIHRvdWNoIGV2ZW50CiAgICAgICAgICBlbHNlIGlmKCBzb3VyY2VFdmVudFR5cGUubWF0Y2goL3RvdWNoLykgfHwgICAvLyB0b3VjaCBldmVudHMgYXJlIGFsd2F5cyBvbiBzY3JlZW4KICAgICAgICAgICAgc291cmNlRXZlbnRUeXBlLm1hdGNoKC9wb2ludGVyZG93bi8pIHx8IC8vIHBvaW50ZXJldmVudHMgdG91Y2gKICAgICAgICAgICAgKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvbW91c2UvKSAmJiBldi53aGljaCA9PT0gMSkgICAvLyBtb3VzZSBpcyBwcmVzc2VkCiAgICAgICAgICAgICl7CiAgICAgICAgICAgIGVuYWJsZV9kZXRlY3QgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIG1vdXNlIGlzbid0IHByZXNzZWQKICAgICAgICAgIGVsc2UgaWYoc291cmNlRXZlbnRUeXBlLm1hdGNoKC9tb3VzZS8pICYmIGV2LndoaWNoICE9PSAxKSB7CiAgICAgICAgICAgIGVuYWJsZV9kZXRlY3QgPSBmYWxzZTsKICAgICAgICAgIH0KCgogICAgICAgICAgLy8gd2UgYXJlIGluIGEgdG91Y2ggZXZlbnQsIHNldCB0aGUgdG91Y2ggdHJpZ2dlcmVkIGJvb2wgdG8gdHJ1ZSwKICAgICAgICAgIC8vIHRoaXMgZm9yIHRoZSBjb25mbGljdHMgdGhhdCBtYXkgb2NjdXIgb24gaW9zIGFuZCBhbmRyb2lkCiAgICAgICAgICBpZihzb3VyY2VFdmVudFR5cGUubWF0Y2goL3RvdWNofHBvaW50ZXIvKSkgewogICAgICAgICAgICB0b3VjaF90cmlnZ2VyZWQgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGNvdW50IHRoZSB0b3RhbCB0b3VjaGVzIG9uIHRoZSBzY3JlZW4KICAgICAgICAgIHZhciBjb3VudF90b3VjaGVzID0gMDsKCiAgICAgICAgICAvLyB3aGVuIHRvdWNoIGhhcyBiZWVuIHRyaWdnZXJlZCBpbiB0aGlzIGRldGVjdGlvbiBzZXNzaW9uCiAgICAgICAgICAvLyBhbmQgd2UgYXJlIG5vdyBoYW5kbGluZyBhIG1vdXNlIGV2ZW50LCB3ZSBzdG9wIHRoYXQgdG8gcHJldmVudCBjb25mbGljdHMKICAgICAgICAgIGlmKGVuYWJsZV9kZXRlY3QpIHsKICAgICAgICAgICAgLy8gdXBkYXRlIHBvaW50ZXJldmVudAogICAgICAgICAgICBpZihpb25pYy5HZXN0dXJlcy5IQVNfUE9JTlRFUkVWRU5UUyAmJiBldmVudFR5cGUgIT0gaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EKSB7CiAgICAgICAgICAgICAgY291bnRfdG91Y2hlcyA9IGlvbmljLkdlc3R1cmVzLlBvaW50ZXJFdmVudC51cGRhdGVQb2ludGVyKGV2ZW50VHlwZSwgZXYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHRvdWNoCiAgICAgICAgICAgIGVsc2UgaWYoc291cmNlRXZlbnRUeXBlLm1hdGNoKC90b3VjaC8pKSB7CiAgICAgICAgICAgICAgY291bnRfdG91Y2hlcyA9IGV2LnRvdWNoZXMubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG1vdXNlCiAgICAgICAgICAgIGVsc2UgaWYoIXRvdWNoX3RyaWdnZXJlZCkgewogICAgICAgICAgICAgIGNvdW50X3RvdWNoZXMgPSBzb3VyY2VFdmVudFR5cGUubWF0Y2goL3VwLykgPyAwIDogMTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgd2UgYXJlIGluIGEgZW5kIGV2ZW50LCBidXQgd2hlbiB3ZSByZW1vdmUgb25lIHRvdWNoIGFuZAogICAgICAgICAgICAvLyB3ZSBzdGlsbCBoYXZlIGVub3VnaCwgc2V0IGV2ZW50VHlwZSB0byBtb3ZlCiAgICAgICAgICAgIGlmKGNvdW50X3RvdWNoZXMgPiAwICYmIGV2ZW50VHlwZSA9PSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQpIHsKICAgICAgICAgICAgICBldmVudFR5cGUgPSBpb25pYy5HZXN0dXJlcy5FVkVOVF9NT1ZFOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG5vIHRvdWNoZXMsIGZvcmNlIHRoZSBlbmQgZXZlbnQKICAgICAgICAgICAgZWxzZSBpZighY291bnRfdG91Y2hlcykgewogICAgICAgICAgICAgIGV2ZW50VHlwZSA9IGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gc3RvcmUgdGhlIGxhc3QgbW92ZSBldmVudAogICAgICAgICAgICBpZihjb3VudF90b3VjaGVzIHx8IGxhc3RfbW92ZV9ldmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGxhc3RfbW92ZV9ldmVudCA9IGV2OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyB0cmlnZ2VyIHRoZSBoYW5kbGVyCiAgICAgICAgICAgIGhhbmRsZXIuY2FsbChpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24sIHNlbGYuY29sbGVjdEV2ZW50RGF0YShlbGVtZW50LCBldmVudFR5cGUsIHNlbGYuZ2V0VG91Y2hMaXN0KGxhc3RfbW92ZV9ldmVudCwgZXZlbnRUeXBlKSwgZXYpKTsKCiAgICAgICAgICAgIC8vIHJlbW92ZSBwb2ludGVyZXZlbnQgZnJvbSBsaXN0CiAgICAgICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLkhBU19QT0lOVEVSRVZFTlRTICYmIGV2ZW50VHlwZSA9PSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQpIHsKICAgICAgICAgICAgICBjb3VudF90b3VjaGVzID0gaW9uaWMuR2VzdHVyZXMuUG9pbnRlckV2ZW50LnVwZGF0ZVBvaW50ZXIoZXZlbnRUeXBlLCBldik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvL2RlYnVnKHNvdXJjZUV2ZW50VHlwZSArIiAiKyBldmVudFR5cGUpOwoKICAgICAgICAgIC8vIG9uIHRoZSBlbmQgd2UgcmVzZXQgZXZlcnl0aGluZwogICAgICAgICAgaWYoIWNvdW50X3RvdWNoZXMpIHsKICAgICAgICAgICAgbGFzdF9tb3ZlX2V2ZW50ID0gbnVsbDsKICAgICAgICAgICAgZW5hYmxlX2RldGVjdCA9IGZhbHNlOwogICAgICAgICAgICB0b3VjaF90cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgaW9uaWMuR2VzdHVyZXMuUG9pbnRlckV2ZW50LnJlc2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIHdlIGhhdmUgZGlmZmVyZW50IGV2ZW50cyBmb3IgZWFjaCBkZXZpY2UvYnJvd3NlcgogICAgICAgKiBkZXRlcm1pbmUgd2hhdCB3ZSBuZWVkIGFuZCBzZXQgdGhlbSBpbiB0aGUgaW9uaWMuR2VzdHVyZXMuRVZFTlRfVFlQRVMgY29uc3RhbnQKICAgICAgICovCiAgICAgIGRldGVybWluZUV2ZW50VHlwZXM6IGZ1bmN0aW9uIGRldGVybWluZUV2ZW50VHlwZXMoKSB7CiAgICAgICAgLy8gZGV0ZXJtaW5lIHRoZSBldmVudHR5cGUgd2Ugd2FudCB0byBzZXQKICAgICAgICB2YXIgdHlwZXM7CgogICAgICAgIC8vIHBvaW50ZXJFdmVudHMgbWFnaWMKICAgICAgICBpZihpb25pYy5HZXN0dXJlcy5IQVNfUE9JTlRFUkVWRU5UUykgewogICAgICAgICAgdHlwZXMgPSBpb25pYy5HZXN0dXJlcy5Qb2ludGVyRXZlbnQuZ2V0RXZlbnRzKCk7CiAgICAgICAgfQogICAgICAgIC8vIG9uIEFuZHJvaWQsIGlPUywgYmxhY2tiZXJyeSwgd2luZG93cyBtb2JpbGUgd2UgZG9udCB3YW50IGFueSBtb3VzZWV2ZW50cwogICAgICAgIGVsc2UgaWYoaW9uaWMuR2VzdHVyZXMuTk9fTU9VU0VFVkVOVFMpIHsKICAgICAgICAgIHR5cGVzID0gWwogICAgICAgICAgICAndG91Y2hzdGFydCcsCiAgICAgICAgICAgICd0b3VjaG1vdmUnLAogICAgICAgICAgICAndG91Y2hlbmQgdG91Y2hjYW5jZWwnXTsKICAgICAgICB9CiAgICAgICAgLy8gZm9yIG5vbiBwb2ludGVyIGV2ZW50cyBicm93c2VycyBhbmQgbWl4ZWQgYnJvd3NlcnMsCiAgICAgICAgLy8gbGlrZSBjaHJvbWUgb24gd2luZG93czggdG91Y2ggbGFwdG9wCiAgICAgICAgZWxzZSB7CiAgICAgICAgICB0eXBlcyA9IFsKICAgICAgICAgICAgJ3RvdWNoc3RhcnQgbW91c2Vkb3duJywKICAgICAgICAgICAgJ3RvdWNobW92ZSBtb3VzZW1vdmUnLAogICAgICAgICAgICAndG91Y2hlbmQgdG91Y2hjYW5jZWwgbW91c2V1cCddOwogICAgICAgIH0KCiAgICAgICAgaW9uaWMuR2VzdHVyZXMuRVZFTlRfVFlQRVNbaW9uaWMuR2VzdHVyZXMuRVZFTlRfU1RBUlRdICA9IHR5cGVzWzBdOwogICAgICAgIGlvbmljLkdlc3R1cmVzLkVWRU5UX1RZUEVTW2lvbmljLkdlc3R1cmVzLkVWRU5UX01PVkVdICAgPSB0eXBlc1sxXTsKICAgICAgICBpb25pYy5HZXN0dXJlcy5FVkVOVF9UWVBFU1tpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkRdICAgID0gdHlwZXNbMl07CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIGNyZWF0ZSB0b3VjaGxpc3QgZGVwZW5kaW5nIG9uIHRoZSBldmVudAogICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICBldgogICAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICBldmVudFR5cGUgICB1c2VkIGJ5IHRoZSBmYWtlbXVsdGl0b3VjaCBwbHVnaW4KICAgICAgICovCiAgICAgIGdldFRvdWNoTGlzdDogZnVuY3Rpb24gZ2V0VG91Y2hMaXN0KGV2LyosIGV2ZW50VHlwZSovKSB7CiAgICAgICAgLy8gZ2V0IHRoZSBmYWtlIHBvaW50ZXJFdmVudCB0b3VjaGxpc3QKICAgICAgICBpZihpb25pYy5HZXN0dXJlcy5IQVNfUE9JTlRFUkVWRU5UUykgewogICAgICAgICAgcmV0dXJuIGlvbmljLkdlc3R1cmVzLlBvaW50ZXJFdmVudC5nZXRUb3VjaExpc3QoKTsKICAgICAgICB9CiAgICAgICAgLy8gZ2V0IHRoZSB0b3VjaGxpc3QKICAgICAgICBlbHNlIGlmKGV2LnRvdWNoZXMpIHsKICAgICAgICAgIHJldHVybiBldi50b3VjaGVzOwogICAgICAgIH0KICAgICAgICAvLyBtYWtlIGZha2UgdG91Y2hsaXN0IGZyb20gbW91c2UgcG9zaXRpb24KICAgICAgICBlbHNlIHsKICAgICAgICAgIGV2LmlkZW50aWZpZXIgPSAxOwogICAgICAgICAgcmV0dXJuIFtldl07CiAgICAgICAgfQogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBjb2xsZWN0IGV2ZW50IGRhdGEgZm9yIGlvbmljLkdlc3R1cmVzIGpzCiAgICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBlbGVtZW50CiAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgICBldmVudFR5cGUgICAgICAgIGxpa2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRQogICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgICAgZXZlbnREYXRhCiAgICAgICAqLwogICAgICBjb2xsZWN0RXZlbnREYXRhOiBmdW5jdGlvbiBjb2xsZWN0RXZlbnREYXRhKGVsZW1lbnQsIGV2ZW50VHlwZSwgdG91Y2hlcywgZXYpIHsKCiAgICAgICAgLy8gZmluZCBvdXQgcG9pbnRlclR5cGUKICAgICAgICB2YXIgcG9pbnRlclR5cGUgPSBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX1RPVUNIOwogICAgICAgIGlmKGV2LnR5cGUubWF0Y2goL21vdXNlLykgfHwgaW9uaWMuR2VzdHVyZXMuUG9pbnRlckV2ZW50Lm1hdGNoVHlwZShpb25pYy5HZXN0dXJlcy5QT0lOVEVSX01PVVNFLCBldikpIHsKICAgICAgICAgIHBvaW50ZXJUeXBlID0gaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9NT1VTRTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBjZW50ZXIgICAgICA6IGlvbmljLkdlc3R1cmVzLnV0aWxzLmdldENlbnRlcih0b3VjaGVzKSwKICAgICAgICAgIHRpbWVTdGFtcCAgIDogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgICAgICB0YXJnZXQgICAgICA6IGV2LnRhcmdldCwKICAgICAgICAgIHRvdWNoZXMgICAgIDogdG91Y2hlcywKICAgICAgICAgIGV2ZW50VHlwZSAgIDogZXZlbnRUeXBlLAogICAgICAgICAgcG9pbnRlclR5cGUgOiBwb2ludGVyVHlwZSwKICAgICAgICAgIHNyY0V2ZW50ICAgIDogZXYsCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBwcmV2ZW50IHRoZSBicm93c2VyIGRlZmF1bHQgYWN0aW9ucwogICAgICAgICAgICogbW9zdGx5IHVzZWQgdG8gZGlzYWJsZSBzY3JvbGxpbmcgb2YgdGhlIGJyb3dzZXIKICAgICAgICAgICAqLwogICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZih0aGlzLnNyY0V2ZW50LnByZXZlbnRNYW5pcHVsYXRpb24pIHsKICAgICAgICAgICAgICB0aGlzLnNyY0V2ZW50LnByZXZlbnRNYW5pcHVsYXRpb24oKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYodGhpcy5zcmNFdmVudC5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICAgIC8vdGhpcy5zcmNFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogc3RvcCBidWJibGluZyB0aGUgZXZlbnQgdXAgdG8gaXRzIHBhcmVudHMKICAgICAgICAgICAqLwogICAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5zcmNFdmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBpbW1lZGlhdGVseSBzdG9wIGdlc3R1cmUgZGV0ZWN0aW9uCiAgICAgICAgICAgKiBtaWdodCBiZSB1c2VmdWwgYWZ0ZXIgYSBzd2lwZSB3YXMgZGV0ZWN0ZWQKICAgICAgICAgICAqIEByZXR1cm4geyp9CiAgICAgICAgICAgKi8KICAgICAgICAgIHN0b3BEZXRlY3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLnN0b3BEZXRlY3QoKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICB9OwoKICAgIGlvbmljLkdlc3R1cmVzLlBvaW50ZXJFdmVudCA9IHsKICAgICAgLyoqCiAgICAgICAqIGhvbGRzIGFsbCBwb2ludGVycwogICAgICAgKiB0eXBlIHtPYmplY3R9CiAgICAgICAqLwogICAgICBwb2ludGVyczoge30sCgogICAgICAvKioKICAgICAgICogZ2V0IGEgbGlzdCBvZiBwb2ludGVycwogICAgICAgKiBAcmV0dXJucyB7QXJyYXl9ICAgICB0b3VjaGxpc3QKICAgICAgICovCiAgICAgIGdldFRvdWNoTGlzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHZhciB0b3VjaGxpc3QgPSBbXTsKCiAgICAgICAgLy8gd2UgY2FuIHVzZSBmb3JFYWNoIHNpbmNlIHBvaW50ZXJFdmVudHMgb25seSBpcyBpbiBJRTEwCiAgICAgICAgT2JqZWN0LmtleXMoc2VsZi5wb2ludGVycykuc29ydCgpLmZvckVhY2goZnVuY3Rpb24oaWQpIHsKICAgICAgICAgIHRvdWNobGlzdC5wdXNoKHNlbGYucG9pbnRlcnNbaWRdKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdG91Y2hsaXN0OwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIHVwZGF0ZSB0aGUgcG9zaXRpb24gb2YgYSBwb2ludGVyCiAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgdHlwZSAgICAgICAgICAgICBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQKICAgICAgICogQHBhcmFtICAge09iamVjdH0gICBwb2ludGVyRXZlbnQKICAgICAgICovCiAgICAgIHVwZGF0ZVBvaW50ZXI6IGZ1bmN0aW9uKHR5cGUsIHBvaW50ZXJFdmVudCkgewogICAgICAgIGlmKHR5cGUgPT0gaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EKSB7CiAgICAgICAgICB0aGlzLnBvaW50ZXJzID0ge307CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgcG9pbnRlckV2ZW50LmlkZW50aWZpZXIgPSBwb2ludGVyRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgdGhpcy5wb2ludGVyc1twb2ludGVyRXZlbnQucG9pbnRlcklkXSA9IHBvaW50ZXJFdmVudDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnBvaW50ZXJzKS5sZW5ndGg7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogY2hlY2sgaWYgZXYgbWF0Y2hlcyBwb2ludGVydHlwZQogICAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgICAgcG9pbnRlclR5cGUgICAgIGlvbmljLkdlc3R1cmVzLlBPSU5URVJfTU9VU0UKICAgICAgICogQHBhcmFtICAge1BvaW50ZXJFdmVudH0gIGV2CiAgICAgICAqLwogICAgICBtYXRjaFR5cGU6IGZ1bmN0aW9uKHBvaW50ZXJUeXBlLCBldikgewogICAgICAgIGlmKCFldi5wb2ludGVyVHlwZSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdmFyIHR5cGVzID0ge307CiAgICAgICAgdHlwZXNbaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9NT1VTRV0gPSAoZXYucG9pbnRlclR5cGUgPT0gZXYuTVNQT0lOVEVSX1RZUEVfTU9VU0UgfHwgZXYucG9pbnRlclR5cGUgPT0gaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9NT1VTRSk7CiAgICAgICAgdHlwZXNbaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9UT1VDSF0gPSAoZXYucG9pbnRlclR5cGUgPT0gZXYuTVNQT0lOVEVSX1RZUEVfVE9VQ0ggfHwgZXYucG9pbnRlclR5cGUgPT0gaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9UT1VDSCk7CiAgICAgICAgdHlwZXNbaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9QRU5dID0gKGV2LnBvaW50ZXJUeXBlID09IGV2Lk1TUE9JTlRFUl9UWVBFX1BFTiB8fCBldi5wb2ludGVyVHlwZSA9PSBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX1BFTik7CiAgICAgICAgcmV0dXJuIHR5cGVzW3BvaW50ZXJUeXBlXTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogZ2V0IGV2ZW50cwogICAgICAgKi8KICAgICAgZ2V0RXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gWwogICAgICAgICAgJ3BvaW50ZXJkb3duIE1TUG9pbnRlckRvd24nLAogICAgICAgICAgJ3BvaW50ZXJtb3ZlIE1TUG9pbnRlck1vdmUnLAogICAgICAgICAgJ3BvaW50ZXJ1cCBwb2ludGVyY2FuY2VsIE1TUG9pbnRlclVwIE1TUG9pbnRlckNhbmNlbCcKICAgICAgICBdOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIHJlc2V0IHRoZSBsaXN0CiAgICAgICAqLwogICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5wb2ludGVycyA9IHt9OwogICAgICB9CiAgICB9OwoKCiAgICBpb25pYy5HZXN0dXJlcy51dGlscyA9IHsKICAgICAgLyoqCiAgICAgICAqIGV4dGVuZCBtZXRob2QsCiAgICAgICAqIGFsc28gdXNlZCBmb3IgY2xvbmluZyB3aGVuIGRlc3QgaXMgYW4gZW1wdHkgb2JqZWN0CiAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgIGRlc3QKICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgc3JjCiAgICAgICAqIEBwYXJhbQl7Qm9vbGVhbn0JbWVyZ2UJCWRvIGEgbWVyZ2UKICAgICAgICogQHJldHVybnMge09iamVjdH0gICAgZGVzdAogICAgICAgKi8KICAgICAgZXh0ZW5kOiBmdW5jdGlvbiBleHRlbmQoZGVzdCwgc3JjLCBtZXJnZSkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIHsKICAgICAgICAgIGlmKGRlc3Rba2V5XSAhPT0gdW5kZWZpbmVkICYmIG1lcmdlKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgZGVzdFtrZXldID0gc3JjW2tleV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZXN0OwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBmaW5kIGlmIGEgbm9kZSBpcyBpbiB0aGUgZ2l2ZW4gcGFyZW50CiAgICAgICAqIHVzZWQgZm9yIGV2ZW50IGRlbGVnYXRpb24gdHJpY2tzCiAgICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBub2RlCiAgICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBwYXJlbnQKICAgICAgICogQHJldHVybnMge2Jvb2xlYW59ICAgICAgIGhhc19wYXJlbnQKICAgICAgICovCiAgICAgIGhhc1BhcmVudDogZnVuY3Rpb24obm9kZSwgcGFyZW50KSB7CiAgICAgICAgd2hpbGUobm9kZSl7CiAgICAgICAgICBpZihub2RlID09IHBhcmVudCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogZ2V0IHRoZSBjZW50ZXIgb2YgYWxsIHRoZSB0b3VjaGVzCiAgICAgICAqIEBwYXJhbSAgIHtBcnJheX0gICAgIHRvdWNoZXMKICAgICAgICogQHJldHVybnMge09iamVjdH0gICAgY2VudGVyCiAgICAgICAqLwogICAgICBnZXRDZW50ZXI6IGZ1bmN0aW9uIGdldENlbnRlcih0b3VjaGVzKSB7CiAgICAgICAgdmFyIHZhbHVlc1ggPSBbXSwgdmFsdWVzWSA9IFtdOwoKICAgICAgICBmb3IodmFyIHQ9IDAsbGVuPXRvdWNoZXMubGVuZ3RoOyB0PGxlbjsgdCsrKSB7CiAgICAgICAgICB2YWx1ZXNYLnB1c2godG91Y2hlc1t0XS5wYWdlWCk7CiAgICAgICAgICB2YWx1ZXNZLnB1c2godG91Y2hlc1t0XS5wYWdlWSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgcGFnZVg6ICgoTWF0aC5taW4uYXBwbHkoTWF0aCwgdmFsdWVzWCkgKyBNYXRoLm1heC5hcHBseShNYXRoLCB2YWx1ZXNYKSkgLyAyKSwKICAgICAgICAgIHBhZ2VZOiAoKE1hdGgubWluLmFwcGx5KE1hdGgsIHZhbHVlc1kpICsgTWF0aC5tYXguYXBwbHkoTWF0aCwgdmFsdWVzWSkpIC8gMikKICAgICAgICB9OwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBjYWxjdWxhdGUgdGhlIHZlbG9jaXR5IGJldHdlZW4gdHdvIHBvaW50cwogICAgICAgKiBAcGFyYW0gICB7TnVtYmVyfSAgICBkZWx0YV90aW1lCiAgICAgICAqIEBwYXJhbSAgIHtOdW1iZXJ9ICAgIGRlbHRhX3gKICAgICAgICogQHBhcmFtICAge051bWJlcn0gICAgZGVsdGFfeQogICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSAgICB2ZWxvY2l0eQogICAgICAgKi8KICAgICAgZ2V0VmVsb2NpdHk6IGZ1bmN0aW9uIGdldFZlbG9jaXR5KGRlbHRhX3RpbWUsIGRlbHRhX3gsIGRlbHRhX3kpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgeDogTWF0aC5hYnMoZGVsdGFfeCAvIGRlbHRhX3RpbWUpIHx8IDAsCiAgICAgICAgICB5OiBNYXRoLmFicyhkZWx0YV95IC8gZGVsdGFfdGltZSkgfHwgMAogICAgICAgIH07CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIGNhbGN1bGF0ZSB0aGUgYW5nbGUgYmV0d2VlbiB0d28gY29vcmRpbmF0ZXMKICAgICAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gxCiAgICAgICAqIEBwYXJhbSAgIHtUb3VjaH0gICAgIHRvdWNoMgogICAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSAgICBhbmdsZQogICAgICAgKi8KICAgICAgZ2V0QW5nbGU6IGZ1bmN0aW9uIGdldEFuZ2xlKHRvdWNoMSwgdG91Y2gyKSB7CiAgICAgICAgdmFyIHkgPSB0b3VjaDIucGFnZVkgLSB0b3VjaDEucGFnZVksCiAgICAgICAgICB4ID0gdG91Y2gyLnBhZ2VYIC0gdG91Y2gxLnBhZ2VYOwogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHksIHgpICogMTgwIC8gTWF0aC5QSTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogYW5nbGUgdG8gZGlyZWN0aW9uIGRlZmluZQogICAgICAgKiBAcGFyYW0gICB7VG91Y2h9ICAgICB0b3VjaDEKICAgICAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gyCiAgICAgICAqIEByZXR1cm5zIHtTdHJpbmd9ICAgIGRpcmVjdGlvbiBjb25zdGFudCwgbGlrZSBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fTEVGVAogICAgICAgKi8KICAgICAgZ2V0RGlyZWN0aW9uOiBmdW5jdGlvbiBnZXREaXJlY3Rpb24odG91Y2gxLCB0b3VjaDIpIHsKICAgICAgICB2YXIgeCA9IE1hdGguYWJzKHRvdWNoMS5wYWdlWCAtIHRvdWNoMi5wYWdlWCksCiAgICAgICAgICB5ID0gTWF0aC5hYnModG91Y2gxLnBhZ2VZIC0gdG91Y2gyLnBhZ2VZKTsKCiAgICAgICAgaWYoeCA+PSB5KSB7CiAgICAgICAgICByZXR1cm4gdG91Y2gxLnBhZ2VYIC0gdG91Y2gyLnBhZ2VYID4gMCA/IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9MRUZUIDogaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1JJR0hUOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIHJldHVybiB0b3VjaDEucGFnZVkgLSB0b3VjaDIucGFnZVkgPiAwID8gaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1VQIDogaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX0RPV047CiAgICAgICAgfQogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBjYWxjdWxhdGUgdGhlIGRpc3RhbmNlIGJldHdlZW4gdHdvIHRvdWNoZXMKICAgICAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gxCiAgICAgICAqIEBwYXJhbSAgIHtUb3VjaH0gICAgIHRvdWNoMgogICAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSAgICBkaXN0YW5jZQogICAgICAgKi8KICAgICAgZ2V0RGlzdGFuY2U6IGZ1bmN0aW9uIGdldERpc3RhbmNlKHRvdWNoMSwgdG91Y2gyKSB7CiAgICAgICAgdmFyIHggPSB0b3VjaDIucGFnZVggLSB0b3VjaDEucGFnZVgsCiAgICAgICAgICB5ID0gdG91Y2gyLnBhZ2VZIC0gdG91Y2gxLnBhZ2VZOwogICAgICAgIHJldHVybiBNYXRoLnNxcnQoKHgqeCkgKyAoeSp5KSk7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIGNhbGN1bGF0ZSB0aGUgc2NhbGUgZmFjdG9yIGJldHdlZW4gdHdvIHRvdWNoTGlzdHMgKGZpbmdlcnMpCiAgICAgICAqIG5vIHNjYWxlIGlzIDEsIGFuZCBnb2VzIGRvd24gdG8gMCB3aGVuIHBpbmNoZWQgdG9nZXRoZXIsIGFuZCBiaWdnZXIgd2hlbiBwaW5jaGVkIG91dAogICAgICAgKiBAcGFyYW0gICB7QXJyYXl9ICAgICBzdGFydAogICAgICAgKiBAcGFyYW0gICB7QXJyYXl9ICAgICBlbmQKICAgICAgICogQHJldHVybnMge051bWJlcn0gICAgc2NhbGUKICAgICAgICovCiAgICAgIGdldFNjYWxlOiBmdW5jdGlvbiBnZXRTY2FsZShzdGFydCwgZW5kKSB7CiAgICAgICAgLy8gbmVlZCB0d28gZmluZ2Vycy4uLgogICAgICAgIGlmKHN0YXJ0Lmxlbmd0aCA+PSAyICYmIGVuZC5sZW5ndGggPj0gMikgewogICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGlzdGFuY2UoZW5kWzBdLCBlbmRbMV0pIC8KICAgICAgICAgICAgdGhpcy5nZXREaXN0YW5jZShzdGFydFswXSwgc3RhcnRbMV0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogY2FsY3VsYXRlIHRoZSByb3RhdGlvbiBkZWdyZWVzIGJldHdlZW4gdHdvIHRvdWNoTGlzdHMgKGZpbmdlcnMpCiAgICAgICAqIEBwYXJhbSAgIHtBcnJheX0gICAgIHN0YXJ0CiAgICAgICAqIEBwYXJhbSAgIHtBcnJheX0gICAgIGVuZAogICAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSAgICByb3RhdGlvbgogICAgICAgKi8KICAgICAgZ2V0Um90YXRpb246IGZ1bmN0aW9uIGdldFJvdGF0aW9uKHN0YXJ0LCBlbmQpIHsKICAgICAgICAvLyBuZWVkIHR3byBmaW5nZXJzCiAgICAgICAgaWYoc3RhcnQubGVuZ3RoID49IDIgJiYgZW5kLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRBbmdsZShlbmRbMV0sIGVuZFswXSkgLQogICAgICAgICAgICB0aGlzLmdldEFuZ2xlKHN0YXJ0WzFdLCBzdGFydFswXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBib29sZWFuIGlmIHRoZSBkaXJlY3Rpb24gaXMgdmVydGljYWwKICAgICAgICogQHBhcmFtICAgIHtTdHJpbmd9ICAgIGRpcmVjdGlvbgogICAgICAgKiBAcmV0dXJucyAge0Jvb2xlYW59ICAgaXNfdmVydGljYWwKICAgICAgICovCiAgICAgIGlzVmVydGljYWw6IGZ1bmN0aW9uIGlzVmVydGljYWwoZGlyZWN0aW9uKSB7CiAgICAgICAgcmV0dXJuIChkaXJlY3Rpb24gPT0gaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1VQIHx8IGRpcmVjdGlvbiA9PSBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fRE9XTik7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIHN0b3AgYnJvd3NlciBkZWZhdWx0IGJlaGF2aW9yIHdpdGggY3NzIGNsYXNzCiAgICAgICAqIEBwYXJhbSAgIHtIdG1sRWxlbWVudH0gICBlbGVtZW50CiAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgICAgICBjc3NfY2xhc3MKICAgICAgICovCiAgICAgIHN0b3BEZWZhdWx0QnJvd3NlckJlaGF2aW9yOiBmdW5jdGlvbiBzdG9wRGVmYXVsdEJyb3dzZXJCZWhhdmlvcihlbGVtZW50LCBjc3NfY2xhc3MpIHsKICAgICAgICAvLyBjaGFuZ2VkIGZyb20gbWFraW5nIG1hbnkgc3R5bGUgY2hhbmdlcyB0byBqdXN0IGFkZGluZyBhIHByZXNldCBjbGFzc25hbWUKICAgICAgICAvLyBsZXNzIERPTSBtYW5pcHVsYXRpb25zLCBsZXNzIGNvZGUsIGFuZCBlYXNpZXIgdG8gY29udHJvbCBpbiB0aGUgQ1NTIHNpZGUgb2YgdGhpbmdzCiAgICAgICAgLy8gaGFtbWVyLmpzIGRvZXNuJ3QgY29tZSB3aXRoIENTUywgYnV0IGlvbmljIGRvZXMsIHdoaWNoIGlzIHdoeSB3ZSBwcmVmZXIgdGhpcyBtZXRob2QKICAgICAgICBpZihlbGVtZW50ICYmIGVsZW1lbnQuY2xhc3NMaXN0KSB7CiAgICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoY3NzX2NsYXNzKTsKICAgICAgICAgIGVsZW1lbnQub25zZWxlY3RzdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgfTsKCgogICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uID0gewogICAgICAvLyBjb250YWlucyBhbGwgcmVnaXN0cmVkIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzIGluIHRoZSBjb3JyZWN0IG9yZGVyCiAgICAgIGdlc3R1cmVzOiBbXSwKCiAgICAgIC8vIGRhdGEgb2YgdGhlIGN1cnJlbnQgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBkZXRlY3Rpb24gc2Vzc2lvbgogICAgICBjdXJyZW50OiBudWxsLAoKICAgICAgLy8gdGhlIHByZXZpb3VzIGlvbmljLkdlc3R1cmVzLmdlc3R1cmUgc2Vzc2lvbiBkYXRhCiAgICAgIC8vIGlzIGEgZnVsbCBjbG9uZSBvZiB0aGUgcHJldmlvdXMgZ2VzdHVyZS5jdXJyZW50IG9iamVjdAogICAgICBwcmV2aW91czogbnVsbCwKCiAgICAgIC8vIHdoZW4gdGhpcyBiZWNvbWVzIHRydWUsIG5vIGdlc3R1cmVzIGFyZSBmaXJlZAogICAgICBzdG9wcGVkOiBmYWxzZSwKCgogICAgICAvKioKICAgICAgICogc3RhcnQgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBkZXRlY3Rpb24KICAgICAgICogQHBhcmFtICAge2lvbmljLkdlc3R1cmVzLkluc3RhbmNlfSAgIGluc3QKICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgICAgICAgICBldmVudERhdGEKICAgICAgICovCiAgICAgIHN0YXJ0RGV0ZWN0OiBmdW5jdGlvbiBzdGFydERldGVjdChpbnN0LCBldmVudERhdGEpIHsKICAgICAgICAvLyBhbHJlYWR5IGJ1c3kgd2l0aCBhIGlvbmljLkdlc3R1cmVzLmdlc3R1cmUgZGV0ZWN0aW9uIG9uIGFuIGVsZW1lbnQKICAgICAgICBpZih0aGlzLmN1cnJlbnQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RvcHBlZCA9IGZhbHNlOwoKICAgICAgICB0aGlzLmN1cnJlbnQgPSB7CiAgICAgICAgICBpbnN0ICAgICAgICA6IGluc3QsIC8vIHJlZmVyZW5jZSB0byBpb25pYy5HZXN0dXJlc0luc3RhbmNlIHdlJ3JlIHdvcmtpbmcgZm9yCiAgICAgICAgICBzdGFydEV2ZW50ICA6IGlvbmljLkdlc3R1cmVzLnV0aWxzLmV4dGVuZCh7fSwgZXZlbnREYXRhKSwgLy8gc3RhcnQgZXZlbnREYXRhIGZvciBkaXN0YW5jZXMsIHRpbWluZyBldGMKICAgICAgICAgIGxhc3RFdmVudCAgIDogZmFsc2UsIC8vIGxhc3QgZXZlbnREYXRhCiAgICAgICAgICBuYW1lICAgICAgICA6ICcnIC8vIGN1cnJlbnQgZ2VzdHVyZSB3ZSdyZSBpbi9kZXRlY3RlZCwgY2FuIGJlICd0YXAnLCAnaG9sZCcgZXRjCiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5kZXRlY3QoZXZlbnREYXRhKTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBkZXRlY3Rpb24KICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgZXZlbnREYXRhCiAgICAgICAqLwogICAgICBkZXRlY3Q6IGZ1bmN0aW9uIGRldGVjdChldmVudERhdGEpIHsKICAgICAgICBpZighdGhpcy5jdXJyZW50IHx8IHRoaXMuc3RvcHBlZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gZXh0ZW5kIGV2ZW50IGRhdGEgd2l0aCBjYWxjdWxhdGlvbnMgYWJvdXQgc2NhbGUsIGRpc3RhbmNlIGV0YwogICAgICAgIGV2ZW50RGF0YSA9IHRoaXMuZXh0ZW5kRXZlbnREYXRhKGV2ZW50RGF0YSk7CgogICAgICAgIC8vIGluc3RhbmNlIG9wdGlvbnMKICAgICAgICB2YXIgaW5zdF9vcHRpb25zID0gdGhpcy5jdXJyZW50Lmluc3Qub3B0aW9uczsKCiAgICAgICAgLy8gY2FsbCBpb25pYy5HZXN0dXJlcy5nZXN0dXJlIGhhbmRsZXJzCiAgICAgICAgZm9yKHZhciBnPTAsbGVuPXRoaXMuZ2VzdHVyZXMubGVuZ3RoOyBnPGxlbjsgZysrKSB7CiAgICAgICAgICB2YXIgZ2VzdHVyZSA9IHRoaXMuZ2VzdHVyZXNbZ107CgogICAgICAgICAgLy8gb25seSB3aGVuIHRoZSBpbnN0YW5jZSBvcHRpb25zIGhhdmUgZW5hYmxlZCB0aGlzIGdlc3R1cmUKICAgICAgICAgIGlmKCF0aGlzLnN0b3BwZWQgJiYgaW5zdF9vcHRpb25zW2dlc3R1cmUubmFtZV0gIT09IGZhbHNlKSB7CiAgICAgICAgICAgIC8vIGlmIGEgaGFuZGxlciByZXR1cm5zIGZhbHNlLCB3ZSBzdG9wIHdpdGggdGhlIGRldGVjdGlvbgogICAgICAgICAgICBpZihnZXN0dXJlLmhhbmRsZXIuY2FsbChnZXN0dXJlLCBldmVudERhdGEsIHRoaXMuY3VycmVudC5pbnN0KSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICB0aGlzLnN0b3BEZXRlY3QoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gc3RvcmUgYXMgcHJldmlvdXMgZXZlbnQgZXZlbnQKICAgICAgICBpZih0aGlzLmN1cnJlbnQpIHsKICAgICAgICAgIHRoaXMuY3VycmVudC5sYXN0RXZlbnQgPSBldmVudERhdGE7CiAgICAgICAgfQoKICAgICAgICAvLyBlbmRldmVudCwgYnV0IG5vdCB0aGUgbGFzdCB0b3VjaCwgc28gZG9udCBzdG9wCiAgICAgICAgaWYoZXZlbnREYXRhLmV2ZW50VHlwZSA9PSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQgJiYgIWV2ZW50RGF0YS50b3VjaGVzLmxlbmd0aC0xKSB7CiAgICAgICAgICB0aGlzLnN0b3BEZXRlY3QoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBldmVudERhdGE7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIGNsZWFyIHRoZSBpb25pYy5HZXN0dXJlcy5nZXN0dXJlIHZhcnMKICAgICAgICogdGhpcyBpcyBjYWxsZWQgb24gZW5kRGV0ZWN0LCBidXQgY2FuIGFsc28gYmUgdXNlZCB3aGVuIGEgZmluYWwgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBoYXMgYmVlbiBkZXRlY3RlZAogICAgICAgKiB0byBzdG9wIG90aGVyIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzIGZyb20gYmVpbmcgZmlyZWQKICAgICAgICovCiAgICAgIHN0b3BEZXRlY3Q6IGZ1bmN0aW9uIHN0b3BEZXRlY3QoKSB7CiAgICAgICAgLy8gY2xvbmUgY3VycmVudCBkYXRhIHRvIHRoZSBzdG9yZSBhcyB0aGUgcHJldmlvdXMgZ2VzdHVyZQogICAgICAgIC8vIHVzZWQgZm9yIHRoZSBkb3VibGUgdGFwIGdlc3R1cmUsIHNpbmNlIHRoaXMgaXMgYW4gb3RoZXIgZ2VzdHVyZSBkZXRlY3Qgc2Vzc2lvbgogICAgICAgIHRoaXMucHJldmlvdXMgPSBpb25pYy5HZXN0dXJlcy51dGlscy5leHRlbmQoe30sIHRoaXMuY3VycmVudCk7CgogICAgICAgIC8vIHJlc2V0IHRoZSBjdXJyZW50CiAgICAgICAgdGhpcy5jdXJyZW50ID0gbnVsbDsKCiAgICAgICAgLy8gc3RvcHBlZCEKICAgICAgICB0aGlzLnN0b3BwZWQgPSB0cnVlOwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBleHRlbmQgZXZlbnREYXRhIGZvciBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcwogICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgIGV2CiAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9ICAgZXYKICAgICAgICovCiAgICAgIGV4dGVuZEV2ZW50RGF0YTogZnVuY3Rpb24gZXh0ZW5kRXZlbnREYXRhKGV2KSB7CiAgICAgICAgdmFyIHN0YXJ0RXYgPSB0aGlzLmN1cnJlbnQuc3RhcnRFdmVudDsKCiAgICAgICAgLy8gaWYgdGhlIHRvdWNoZXMgY2hhbmdlLCBzZXQgdGhlIG5ldyB0b3VjaGVzIG92ZXIgdGhlIHN0YXJ0RXZlbnQgdG91Y2hlcwogICAgICAgIC8vIHRoaXMgYmVjYXVzZSB0b3VjaGV2ZW50cyBkb24ndCBoYXZlIGFsbCB0aGUgdG91Y2hlcyBvbiB0b3VjaHN0YXJ0LCBvciB0aGUKICAgICAgICAvLyB1c2VyIG11c3QgcGxhY2UgaGlzIGZpbmdlcnMgYXQgdGhlIEVYQUNUIHNhbWUgdGltZSBvbiB0aGUgc2NyZWVuLCB3aGljaCBpcyBub3QgcmVhbGlzdGljCiAgICAgICAgLy8gYnV0LCBzb21ldGltZXMgaXQgaGFwcGVucyB0aGF0IGJvdGggZmluZ2VycyBhcmUgdG91Y2hpbmcgYXQgdGhlIEVYQUNUIHNhbWUgdGltZQogICAgICAgIGlmKHN0YXJ0RXYgJiYgKGV2LnRvdWNoZXMubGVuZ3RoICE9IHN0YXJ0RXYudG91Y2hlcy5sZW5ndGggfHwgZXYudG91Y2hlcyA9PT0gc3RhcnRFdi50b3VjaGVzKSkgewogICAgICAgICAgLy8gZXh0ZW5kIDEgbGV2ZWwgZGVlcCB0byBnZXQgdGhlIHRvdWNobGlzdCB3aXRoIHRoZSB0b3VjaCBvYmplY3RzCiAgICAgICAgICBzdGFydEV2LnRvdWNoZXMgPSBbXTsKICAgICAgICAgIGZvcih2YXIgaT0wLGxlbj1ldi50b3VjaGVzLmxlbmd0aDsgaTxsZW47IGkrKykgewogICAgICAgICAgICBzdGFydEV2LnRvdWNoZXMucHVzaChpb25pYy5HZXN0dXJlcy51dGlscy5leHRlbmQoe30sIGV2LnRvdWNoZXNbaV0pKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBkZWx0YV90aW1lID0gZXYudGltZVN0YW1wIC0gc3RhcnRFdi50aW1lU3RhbXAsCiAgICAgICAgICBkZWx0YV94ID0gZXYuY2VudGVyLnBhZ2VYIC0gc3RhcnRFdi5jZW50ZXIucGFnZVgsCiAgICAgICAgICBkZWx0YV95ID0gZXYuY2VudGVyLnBhZ2VZIC0gc3RhcnRFdi5jZW50ZXIucGFnZVksCiAgICAgICAgICB2ZWxvY2l0eSA9IGlvbmljLkdlc3R1cmVzLnV0aWxzLmdldFZlbG9jaXR5KGRlbHRhX3RpbWUsIGRlbHRhX3gsIGRlbHRhX3kpOwoKICAgICAgICBpb25pYy5HZXN0dXJlcy51dGlscy5leHRlbmQoZXYsIHsKICAgICAgICAgIGRlbHRhVGltZSAgIDogZGVsdGFfdGltZSwKCiAgICAgICAgICBkZWx0YVggICAgICA6IGRlbHRhX3gsCiAgICAgICAgICBkZWx0YVkgICAgICA6IGRlbHRhX3ksCgogICAgICAgICAgdmVsb2NpdHlYICAgOiB2ZWxvY2l0eS54LAogICAgICAgICAgdmVsb2NpdHlZICAgOiB2ZWxvY2l0eS55LAoKICAgICAgICAgIGRpc3RhbmNlICAgIDogaW9uaWMuR2VzdHVyZXMudXRpbHMuZ2V0RGlzdGFuY2Uoc3RhcnRFdi5jZW50ZXIsIGV2LmNlbnRlciksCiAgICAgICAgICBhbmdsZSAgICAgICA6IGlvbmljLkdlc3R1cmVzLnV0aWxzLmdldEFuZ2xlKHN0YXJ0RXYuY2VudGVyLCBldi5jZW50ZXIpLAogICAgICAgICAgZGlyZWN0aW9uICAgOiBpb25pYy5HZXN0dXJlcy51dGlscy5nZXREaXJlY3Rpb24oc3RhcnRFdi5jZW50ZXIsIGV2LmNlbnRlciksCgogICAgICAgICAgc2NhbGUgICAgICAgOiBpb25pYy5HZXN0dXJlcy51dGlscy5nZXRTY2FsZShzdGFydEV2LnRvdWNoZXMsIGV2LnRvdWNoZXMpLAogICAgICAgICAgcm90YXRpb24gICAgOiBpb25pYy5HZXN0dXJlcy51dGlscy5nZXRSb3RhdGlvbihzdGFydEV2LnRvdWNoZXMsIGV2LnRvdWNoZXMpLAoKICAgICAgICAgIHN0YXJ0RXZlbnQgIDogc3RhcnRFdgogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gZXY7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIHJlZ2lzdGVyIG5ldyBnZXN0dXJlCiAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgIGdlc3R1cmUgb2JqZWN0LCBzZWUgZ2VzdHVyZXMuanMgZm9yIGRvY3VtZW50YXRpb24KICAgICAgICogQHJldHVybnMge0FycmF5fSAgICAgZ2VzdHVyZXMKICAgICAgICovCiAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiByZWdpc3RlcihnZXN0dXJlKSB7CiAgICAgICAgLy8gYWRkIGFuIGVuYWJsZSBnZXN0dXJlIG9wdGlvbnMgaWYgdGhlcmUgaXMgbm8gZ2l2ZW4KICAgICAgICB2YXIgb3B0aW9ucyA9IGdlc3R1cmUuZGVmYXVsdHMgfHwge307CiAgICAgICAgaWYob3B0aW9uc1tnZXN0dXJlLm5hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIG9wdGlvbnNbZ2VzdHVyZS5uYW1lXSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICAvLyBleHRlbmQgaW9uaWMuR2VzdHVyZXMgZGVmYXVsdCBvcHRpb25zIHdpdGggdGhlIGlvbmljLkdlc3R1cmVzLmdlc3R1cmUgb3B0aW9ucwogICAgICAgIGlvbmljLkdlc3R1cmVzLnV0aWxzLmV4dGVuZChpb25pYy5HZXN0dXJlcy5kZWZhdWx0cywgb3B0aW9ucywgdHJ1ZSk7CgogICAgICAgIC8vIHNldCBpdHMgaW5kZXgKICAgICAgICBnZXN0dXJlLmluZGV4ID0gZ2VzdHVyZS5pbmRleCB8fCAxMDAwOwoKICAgICAgICAvLyBhZGQgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSB0byB0aGUgbGlzdAogICAgICAgIHRoaXMuZ2VzdHVyZXMucHVzaChnZXN0dXJlKTsKCiAgICAgICAgLy8gc29ydCB0aGUgbGlzdCBieSBpbmRleAogICAgICAgIHRoaXMuZ2VzdHVyZXMuc29ydChmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICBpZiAoYS5pbmRleCA8IGIuaW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGEuaW5kZXggPiBiLmluZGV4KSB7CiAgICAgICAgICAgIHJldHVybiAxOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiB0aGlzLmdlc3R1cmVzOwogICAgICB9CiAgICB9OwoKCiAgICBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcyA9IGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzIHx8IHt9OwoKICAgIC8qKgogICAgICogQ3VzdG9tIGdlc3R1cmVzCiAgICAgKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAqCiAgICAgKiBHZXN0dXJlIG9iamVjdAogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAqIFRoZSBvYmplY3Qgc3RydWN0dXJlIG9mIGEgZ2VzdHVyZToKICAgICAqCiAgICAgKiB7IG5hbWU6ICdteWdlc3R1cmUnLAogICAqICAgaW5kZXg6IDEzMzcsCiAgICogICBkZWZhdWx0czogewogICAqICAgICBteWdlc3R1cmVfb3B0aW9uOiB0cnVlCiAgICogICB9CiAgICogICBoYW5kbGVyOiBmdW5jdGlvbih0eXBlLCBldiwgaW5zdCkgewogICAqICAgICAvLyB0cmlnZ2VyIGdlc3R1cmUgZXZlbnQKICAgKiAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOwogICAqICAgfQogICAqIH0KCiAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICBuYW1lCiAgICAgKiB0aGlzIHNob3VsZCBiZSB0aGUgbmFtZSBvZiB0aGUgZ2VzdHVyZSwgbG93ZXJjYXNlCiAgICAgKiBpdCBpcyBhbHNvIGJlaW5nIHVzZWQgdG8gZGlzYWJsZS9lbmFibGUgdGhlIGdlc3R1cmUgcGVyIGluc3RhbmNlIGNvbmZpZy4KICAgICAqCiAgICAgKiBAcGFyYW0gICB7TnVtYmVyfSAgICBbaW5kZXg9MTAwMF0KICAgICAqIHRoZSBpbmRleCBvZiB0aGUgZ2VzdHVyZSwgd2hlcmUgaXQgaXMgZ29pbmcgdG8gYmUgaW4gdGhlIHN0YWNrIG9mIGdlc3R1cmVzIGRldGVjdGlvbgogICAgICogbGlrZSB3aGVuIHlvdSBidWlsZCBhbiBnZXN0dXJlIHRoYXQgZGVwZW5kcyBvbiB0aGUgZHJhZyBnZXN0dXJlLCBpdCBpcyBhIGdvb2QKICAgICAqIGlkZWEgdG8gcGxhY2UgaXQgYWZ0ZXIgdGhlIGluZGV4IG9mIHRoZSBkcmFnIGdlc3R1cmUuCiAgICAgKgogICAgICogQHBhcmFtICAge09iamVjdH0gICAgW2RlZmF1bHRzPXt9XQogICAgICogdGhlIGRlZmF1bHQgc2V0dGluZ3Mgb2YgdGhlIGdlc3R1cmUuIHRoZXNlIGFyZSBhZGRlZCB0byB0aGUgaW5zdGFuY2Ugc2V0dGluZ3MsCiAgICAgKiBhbmQgY2FuIGJlIG92ZXJydWxlZCBwZXIgaW5zdGFuY2UuIHlvdSBjYW4gYWxzbyBhZGQgdGhlIG5hbWUgb2YgdGhlIGdlc3R1cmUsCiAgICAgKiBidXQgdGhpcyBpcyBhbHNvIGFkZGVkIGJ5IGRlZmF1bHQgKGFuZCBzZXQgdG8gdHJ1ZSkuCiAgICAgKgogICAgICogQHBhcmFtICAge0Z1bmN0aW9ufSAgaGFuZGxlcgogICAgICogdGhpcyBoYW5kbGVzIHRoZSBnZXN0dXJlIGRldGVjdGlvbiBvZiB5b3VyIGN1c3RvbSBnZXN0dXJlIGFuZCByZWNlaXZlcyB0aGUKICAgICAqIGZvbGxvd2luZyBhcmd1bWVudHM6CiAgICAgKgogICAgICogICAgICBAcGFyYW0gIHtPYmplY3R9ICAgIGV2ZW50RGF0YQogICAgICogICAgICBldmVudCBkYXRhIGNvbnRhaW5pbmcgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICogICAgICAgICAgdGltZVN0YW1wICAge051bWJlcn0gICAgICAgIHRpbWUgdGhlIGV2ZW50IG9jY3VycmVkCiAgICAgKiAgICAgICAgICB0YXJnZXQgICAgICB7SFRNTEVsZW1lbnR9ICAgdGFyZ2V0IGVsZW1lbnQKICAgICAqICAgICAgICAgIHRvdWNoZXMgICAgIHtBcnJheX0gICAgICAgICB0b3VjaGVzIChmaW5nZXJzLCBwb2ludGVycywgbW91c2UpIG9uIHRoZSBzY3JlZW4KICAgICAqICAgICAgICAgIHBvaW50ZXJUeXBlIHtTdHJpbmd9ICAgICAgICBraW5kIG9mIHBvaW50ZXIgdGhhdCB3YXMgdXNlZC4gbWF0Y2hlcyBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX01PVVNFfFRPVUNICiAgICAgKiAgICAgICAgICBjZW50ZXIgICAgICB7T2JqZWN0fSAgICAgICAgY2VudGVyIHBvc2l0aW9uIG9mIHRoZSB0b3VjaGVzLiBjb250YWlucyBwYWdlWCBhbmQgcGFnZVkKICAgICAqICAgICAgICAgIGRlbHRhVGltZSAgIHtOdW1iZXJ9ICAgICAgICB0aGUgdG90YWwgdGltZSBvZiB0aGUgdG91Y2hlcyBpbiB0aGUgc2NyZWVuCiAgICAgKiAgICAgICAgICBkZWx0YVggICAgICB7TnVtYmVyfSAgICAgICAgdGhlIGRlbHRhIG9uIHggYXhpcyB3ZSBoYXZlZCBtb3ZlZAogICAgICogICAgICAgICAgZGVsdGFZICAgICAge051bWJlcn0gICAgICAgIHRoZSBkZWx0YSBvbiB5IGF4aXMgd2UgaGF2ZWQgbW92ZWQKICAgICAqICAgICAgICAgIHZlbG9jaXR5WCAgIHtOdW1iZXJ9ICAgICAgICB0aGUgdmVsb2NpdHkgb24gdGhlIHgKICAgICAqICAgICAgICAgIHZlbG9jaXR5WSAgIHtOdW1iZXJ9ICAgICAgICB0aGUgdmVsb2NpdHkgb24geQogICAgICogICAgICAgICAgYW5nbGUgICAgICAge051bWJlcn0gICAgICAgIHRoZSBhbmdsZSB3ZSBhcmUgbW92aW5nCiAgICAgKiAgICAgICAgICBkaXJlY3Rpb24gICB7U3RyaW5nfSAgICAgICAgdGhlIGRpcmVjdGlvbiB3ZSBhcmUgbW92aW5nLiBtYXRjaGVzIGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9VUHxET1dOfExFRlR8UklHSFQKICAgICAqICAgICAgICAgIGRpc3RhbmNlICAgIHtOdW1iZXJ9ICAgICAgICB0aGUgZGlzdGFuY2Ugd2UgaGF2ZWQgbW92ZWQKICAgICAqICAgICAgICAgIHNjYWxlICAgICAgIHtOdW1iZXJ9ICAgICAgICBzY2FsaW5nIG9mIHRoZSB0b3VjaGVzLCBuZWVkcyAyIHRvdWNoZXMKICAgICAqICAgICAgICAgIHJvdGF0aW9uICAgIHtOdW1iZXJ9ICAgICAgICByb3RhdGlvbiBvZiB0aGUgdG91Y2hlcywgbmVlZHMgMiB0b3VjaGVzICoKICAgICAqICAgICAgICAgIGV2ZW50VHlwZSAgIHtTdHJpbmd9ICAgICAgICBtYXRjaGVzIGlvbmljLkdlc3R1cmVzLkVWRU5UX1NUQVJUfE1PVkV8RU5ECiAgICAgKiAgICAgICAgICBzcmNFdmVudCAgICB7T2JqZWN0fSAgICAgICAgdGhlIHNvdXJjZSBldmVudCwgbGlrZSBUb3VjaFN0YXJ0IG9yIE1vdXNlRG93biAqCiAgICAgKiAgICAgICAgICBzdGFydEV2ZW50ICB7T2JqZWN0fSAgICAgICAgY29udGFpbnMgdGhlIHNhbWUgcHJvcGVydGllcyBhcyBhYm92ZSwKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXQgZnJvbSB0aGUgZmlyc3QgdG91Y2guIHRoaXMgaXMgdXNlZCB0byBjYWxjdWxhdGUKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXN0YW5jZXMsIGRlbHRhVGltZSwgc2NhbGluZyBldGMKICAgICAqCiAgICAgKiAgICAgIEBwYXJhbSAge2lvbmljLkdlc3R1cmVzLkluc3RhbmNlfSAgICBpbnN0CiAgICAgKiAgICAgIHRoZSBpbnN0YW5jZSB3ZSBhcmUgZG9pbmcgdGhlIGRldGVjdGlvbiBmb3IuIHlvdSBjYW4gZ2V0IHRoZSBvcHRpb25zIGZyb20KICAgICAqICAgICAgdGhlIGluc3Qub3B0aW9ucyBvYmplY3QgYW5kIHRyaWdnZXIgdGhlIGdlc3R1cmUgZXZlbnQgYnkgY2FsbGluZyBpbnN0LnRyaWdnZXIKICAgICAqCiAgICAgKgogICAgICogSGFuZGxlIGdlc3R1cmVzCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICogaW5zaWRlIHRoZSBoYW5kbGVyIHlvdSBjYW4gZ2V0L3NldCBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb25pYy5jdXJyZW50LiBUaGlzIGlzIHRoZSBjdXJyZW50CiAgICAgKiBkZXRlY3Rpb24gc2Vzc2lvbmljLiBJdCBoYXMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzCiAgICAgKiAgICAgIEBwYXJhbSAge1N0cmluZ30gICAgbmFtZQogICAgICogICAgICBjb250YWlucyB0aGUgbmFtZSBvZiB0aGUgZ2VzdHVyZSB3ZSBoYXZlIGRldGVjdGVkLiBpdCBoYXMgbm90IGEgcmVhbCBmdW5jdGlvbiwKICAgICAqICAgICAgb25seSB0byBjaGVjayBpbiBvdGhlciBnZXN0dXJlcyBpZiBzb21ldGhpbmcgaXMgZGV0ZWN0ZWQuCiAgICAgKiAgICAgIGxpa2UgaW4gdGhlIGRyYWcgZ2VzdHVyZSB3ZSBzZXQgaXQgdG8gJ2RyYWcnIGFuZCBpbiB0aGUgc3dpcGUgZ2VzdHVyZSB3ZSBjYW4KICAgICAqICAgICAgY2hlY2sgaWYgdGhlIGN1cnJlbnQgZ2VzdHVyZSBpcyAnZHJhZycgYnkgYWNjZXNzaW5nIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbmljLmN1cnJlbnQubmFtZQogICAgICoKICAgICAqICAgICAgcmVhZG9ubHkKICAgICAqICAgICAgQHBhcmFtICB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9ICAgIGluc3QKICAgICAqICAgICAgdGhlIGluc3RhbmNlIHdlIGRvIHRoZSBkZXRlY3Rpb24gZm9yCiAgICAgKgogICAgICogICAgICByZWFkb25seQogICAgICogICAgICBAcGFyYW0gIHtPYmplY3R9ICAgIHN0YXJ0RXZlbnQKICAgICAqICAgICAgY29udGFpbnMgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGZpcnN0IGdlc3R1cmUgZGV0ZWN0aW9uIGluIHRoaXMgc2Vzc2lvbmljLgogICAgICogICAgICBVc2VkIGZvciBjYWxjdWxhdGlvbnMgYWJvdXQgdGltaW5nLCBkaXN0YW5jZSwgZXRjLgogICAgICoKICAgICAqICAgICAgcmVhZG9ubHkKICAgICAqICAgICAgQHBhcmFtICB7T2JqZWN0fSAgICBsYXN0RXZlbnQKICAgICAqICAgICAgY29udGFpbnMgYWxsIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBsYXN0IGdlc3R1cmUgZGV0ZWN0IGluIHRoaXMgc2Vzc2lvbmljLgogICAgICoKICAgICAqIGFmdGVyIHRoZSBnZXN0dXJlIGRldGVjdGlvbiBzZXNzaW9uIGhhcyBiZWVuIGNvbXBsZXRlZCAodXNlciBoYXMgcmVsZWFzZWQgdGhlIHNjcmVlbikKICAgICAqIHRoZSBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb25pYy5jdXJyZW50IG9iamVjdCBpcyBjb3BpZWQgaW50byBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb25pYy5wcmV2aW91cywKICAgICAqIHRoaXMgaXMgdXNlZnVsbCBmb3IgZ2VzdHVyZXMgbGlrZSBkb3VibGV0YXAsIHdoZXJlIHlvdSBuZWVkIHRvIGtub3cgaWYgdGhlCiAgICAgKiBwcmV2aW91cyBnZXN0dXJlIHdhcyBhIHRhcAogICAgICoKICAgICAqIG9wdGlvbnMgdGhhdCBoYXZlIGJlZW4gc2V0IGJ5IHRoZSBpbnN0YW5jZSBjYW4gYmUgcmVjZWl2ZWQgYnkgY2FsbGluZyBpbnN0Lm9wdGlvbnMKICAgICAqCiAgICAgKiBZb3UgY2FuIHRyaWdnZXIgYSBnZXN0dXJlIGV2ZW50IGJ5IGNhbGxpbmcgaW5zdC50cmlnZ2VyKCJteWdlc3R1cmUiLCBldmVudCkuCiAgICAgKiBUaGUgZmlyc3QgcGFyYW0gaXMgdGhlIG5hbWUgb2YgeW91ciBnZXN0dXJlLCB0aGUgc2Vjb25kIHRoZSBldmVudCBhcmd1bWVudAogICAgICoKICAgICAqCiAgICAgKiBSZWdpc3RlciBnZXN0dXJlcwogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAqIFdoZW4gYW4gZ2VzdHVyZSBpcyBhZGRlZCB0byB0aGUgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMgb2JqZWN0LCBpdCBpcyBhdXRvIHJlZ2lzdGVyZWQKICAgICAqIGF0IHRoZSBzZXR1cCBvZiB0aGUgZmlyc3QgaW9uaWMuR2VzdHVyZXMgaW5zdGFuY2UuIFlvdSBjYW4gYWxzbyBjYWxsIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbmljLnJlZ2lzdGVyCiAgICAgKiBtYW51YWxseSBhbmQgcGFzcyB5b3VyIGdlc3R1cmUgb2JqZWN0IGFzIGEgcGFyYW0KICAgICAqCiAgICAgKi8KCiAgICAvKioKICAgICAqIEhvbGQKICAgICAqIFRvdWNoIHN0YXlzIGF0IHRoZSBzYW1lIHBsYWNlIGZvciB4IHRpbWUKICAgICAqIGV2ZW50cyAgaG9sZAogICAgICovCiAgICBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcy5Ib2xkID0gewogICAgICBuYW1lOiAnaG9sZCcsCiAgICAgIGluZGV4OiAxMCwKICAgICAgZGVmYXVsdHM6IHsKICAgICAgICBob2xkX3RpbWVvdXQJOiA1MDAsCiAgICAgICAgaG9sZF90aHJlc2hvbGQJOiAxCiAgICAgIH0sCiAgICAgIHRpbWVyOiBudWxsLAogICAgICBoYW5kbGVyOiBmdW5jdGlvbiBob2xkR2VzdHVyZShldiwgaW5zdCkgewogICAgICAgIHN3aXRjaChldi5ldmVudFR5cGUpIHsKICAgICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfU1RBUlQ6CiAgICAgICAgICAgIC8vIGNsZWFyIGFueSBydW5uaW5nIHRpbWVycwogICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgogICAgICAgICAgICAvLyBzZXQgdGhlIGdlc3R1cmUgc28gd2UgY2FuIGNoZWNrIGluIHRoZSB0aW1lb3V0IGlmIGl0IHN0aWxsIGlzCiAgICAgICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPSB0aGlzLm5hbWU7CgogICAgICAgICAgICAvLyBzZXQgdGltZXIgYW5kIGlmIGFmdGVyIHRoZSB0aW1lb3V0IGl0IHN0aWxsIGlzIGhvbGQsCiAgICAgICAgICAgIC8vIHdlIHRyaWdnZXIgdGhlIGhvbGQgZXZlbnQKICAgICAgICAgICAgdGhpcy50aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYoaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSA9PSAnaG9sZCcpIHsKICAgICAgICAgICAgICAgIGlvbmljLnRhcC5jYW5jZWxDbGljaygpOwogICAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKCdob2xkJywgZXYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgaW5zdC5vcHRpb25zLmhvbGRfdGltZW91dCk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIC8vIHdoZW4geW91IG1vdmUgb3IgZW5kIHdlIGNsZWFyIHRoZSB0aW1lcgogICAgICAgICAgY2FzZSBpb25pYy5HZXN0dXJlcy5FVkVOVF9NT1ZFOgogICAgICAgICAgICBpZihldi5kaXN0YW5jZSA+IGluc3Qub3B0aW9ucy5ob2xkX3RocmVzaG9sZCkgewogICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORDoKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogVGFwL0RvdWJsZVRhcAogICAgICogUXVpY2sgdG91Y2ggYXQgYSBwbGFjZSBvciBkb3VibGUgYXQgdGhlIHNhbWUgcGxhY2UKICAgICAqIGV2ZW50cyAgdGFwLCBkb3VibGV0YXAKICAgICAqLwogICAgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuVGFwID0gewogICAgICBuYW1lOiAndGFwJywKICAgICAgaW5kZXg6IDEwMCwKICAgICAgZGVmYXVsdHM6IHsKICAgICAgICB0YXBfbWF4X3RvdWNodGltZQk6IDI1MCwKICAgICAgICB0YXBfbWF4X2Rpc3RhbmNlCTogMTAsCiAgICAgICAgdGFwX2Fsd2F5cwkJCTogdHJ1ZSwKICAgICAgICBkb3VibGV0YXBfZGlzdGFuY2UJOiAyMCwKICAgICAgICBkb3VibGV0YXBfaW50ZXJ2YWwJOiAzMDAKICAgICAgfSwKICAgICAgaGFuZGxlcjogZnVuY3Rpb24gdGFwR2VzdHVyZShldiwgaW5zdCkgewogICAgICAgIGlmKGV2LmV2ZW50VHlwZSA9PSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQgJiYgZXYuc3JjRXZlbnQudHlwZSAhPSAndG91Y2hjYW5jZWwnKSB7CiAgICAgICAgICAvLyBwcmV2aW91cyBnZXN0dXJlLCBmb3IgdGhlIGRvdWJsZSB0YXAgc2luY2UgdGhlc2UgYXJlIHR3byBkaWZmZXJlbnQgZ2VzdHVyZSBkZXRlY3Rpb25zCiAgICAgICAgICB2YXIgcHJldiA9IGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5wcmV2aW91cywKICAgICAgICAgICAgZGlkX2RvdWJsZXRhcCA9IGZhbHNlOwoKICAgICAgICAgIC8vIHdoZW4gdGhlIHRvdWNodGltZSBpcyBoaWdoZXIgdGhlbiB0aGUgbWF4IHRvdWNoIHRpbWUKICAgICAgICAgIC8vIG9yIHdoZW4gdGhlIG1vdmluZyBkaXN0YW5jZSBpcyB0b28gbXVjaAogICAgICAgICAgaWYoZXYuZGVsdGFUaW1lID4gaW5zdC5vcHRpb25zLnRhcF9tYXhfdG91Y2h0aW1lIHx8CiAgICAgICAgICAgIGV2LmRpc3RhbmNlID4gaW5zdC5vcHRpb25zLnRhcF9tYXhfZGlzdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGNoZWNrIGlmIGRvdWJsZSB0YXAKICAgICAgICAgIGlmKHByZXYgJiYgcHJldi5uYW1lID09ICd0YXAnICYmCiAgICAgICAgICAgIChldi50aW1lU3RhbXAgLSBwcmV2Lmxhc3RFdmVudC50aW1lU3RhbXApIDwgaW5zdC5vcHRpb25zLmRvdWJsZXRhcF9pbnRlcnZhbCAmJgogICAgICAgICAgICBldi5kaXN0YW5jZSA8IGluc3Qub3B0aW9ucy5kb3VibGV0YXBfZGlzdGFuY2UpIHsKICAgICAgICAgICAgaW5zdC50cmlnZ2VyKCdkb3VibGV0YXAnLCBldik7CiAgICAgICAgICAgIGRpZF9kb3VibGV0YXAgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGRvIGEgc2luZ2xlIHRhcAogICAgICAgICAgaWYoIWRpZF9kb3VibGV0YXAgfHwgaW5zdC5vcHRpb25zLnRhcF9hbHdheXMpIHsKICAgICAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSA9ICd0YXAnOwogICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ3RhcCcsIGV2KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogU3dpcGUKICAgICAqIHRyaWdnZXJzIHN3aXBlIGV2ZW50cyB3aGVuIHRoZSBlbmQgdmVsb2NpdHkgaXMgYWJvdmUgdGhlIHRocmVzaG9sZAogICAgICogZXZlbnRzICBzd2lwZSwgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0LCBzd2lwZXVwLCBzd2lwZWRvd24KICAgICAqLwogICAgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuU3dpcGUgPSB7CiAgICAgIG5hbWU6ICdzd2lwZScsCiAgICAgIGluZGV4OiA0MCwKICAgICAgZGVmYXVsdHM6IHsKICAgICAgICAvLyBzZXQgMCBmb3IgdW5saW1pdGVkLCBidXQgdGhpcyBjYW4gY29uZmxpY3Qgd2l0aCB0cmFuc2Zvcm0KICAgICAgICBzd2lwZV9tYXhfdG91Y2hlcyAgOiAxLAogICAgICAgIHN3aXBlX3ZlbG9jaXR5ICAgICA6IDAuNwogICAgICB9LAogICAgICBoYW5kbGVyOiBmdW5jdGlvbiBzd2lwZUdlc3R1cmUoZXYsIGluc3QpIHsKICAgICAgICBpZihldi5ldmVudFR5cGUgPT0gaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EKSB7CiAgICAgICAgICAvLyBtYXggdG91Y2hlcwogICAgICAgICAgaWYoaW5zdC5vcHRpb25zLnN3aXBlX21heF90b3VjaGVzID4gMCAmJgogICAgICAgICAgICBldi50b3VjaGVzLmxlbmd0aCA+IGluc3Qub3B0aW9ucy5zd2lwZV9tYXhfdG91Y2hlcykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgLy8gd2hlbiB0aGUgZGlzdGFuY2Ugd2UgbW92ZWQgaXMgdG9vIHNtYWxsIHdlIHNraXAgdGhpcyBnZXN0dXJlCiAgICAgICAgICAvLyBvciB3ZSBjYW4gYmUgYWxyZWFkeSBpbiBkcmFnZ2luZwogICAgICAgICAgaWYoZXYudmVsb2NpdHlYID4gaW5zdC5vcHRpb25zLnN3aXBlX3ZlbG9jaXR5IHx8CiAgICAgICAgICAgIGV2LnZlbG9jaXR5WSA+IGluc3Qub3B0aW9ucy5zd2lwZV92ZWxvY2l0eSkgewogICAgICAgICAgICAvLyB0cmlnZ2VyIHN3aXBlIGV2ZW50cwogICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lLCBldik7CiAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKyBldi5kaXJlY3Rpb24sIGV2KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogRHJhZwogICAgICogTW92ZSB3aXRoIHggZmluZ2VycyAoZGVmYXVsdCAxKSBhcm91bmQgb24gdGhlIHBhZ2UuIEJsb2NraW5nIHRoZSBzY3JvbGxpbmcgd2hlbgogICAgICogbW92aW5nIGxlZnQgYW5kIHJpZ2h0IGlzIGEgZ29vZCBwcmFjdGljZS4gV2hlbiBhbGwgdGhlIGRyYWcgZXZlbnRzIGFyZSBibG9ja2luZwogICAgICogeW91IGRpc2FibGUgc2Nyb2xsaW5nIG9uIHRoYXQgYXJlYS4KICAgICAqIGV2ZW50cyAgZHJhZywgZHJhcGxlZnQsIGRyYWdyaWdodCwgZHJhZ3VwLCBkcmFnZG93bgogICAgICovCiAgICBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcy5EcmFnID0gewogICAgICBuYW1lOiAnZHJhZycsCiAgICAgIGluZGV4OiA1MCwKICAgICAgZGVmYXVsdHM6IHsKICAgICAgICBkcmFnX21pbl9kaXN0YW5jZSA6IDEwLAogICAgICAgIC8vIFNldCBjb3JyZWN0X2Zvcl9kcmFnX21pbl9kaXN0YW5jZSB0byB0cnVlIHRvIG1ha2UgdGhlIHN0YXJ0aW5nIHBvaW50IG9mIHRoZSBkcmFnCiAgICAgICAgLy8gYmUgY2FsY3VsYXRlZCBmcm9tIHdoZXJlIHRoZSBkcmFnIHdhcyB0cmlnZ2VyZWQsIG5vdCBmcm9tIHdoZXJlIHRoZSB0b3VjaCBzdGFydGVkLgogICAgICAgIC8vIFVzZWZ1bCB0byBhdm9pZCBhIGplcmstc3RhcnRpbmcgZHJhZywgd2hpY2ggY2FuIG1ha2UgZmluZS1hZGp1c3RtZW50cwogICAgICAgIC8vIHRocm91Z2ggZHJhZ2dpbmcgZGlmZmljdWx0LCBhbmQgYmUgdmlzdWFsbHkgdW5hcHBlYWxpbmcuCiAgICAgICAgY29ycmVjdF9mb3JfZHJhZ19taW5fZGlzdGFuY2UgOiB0cnVlLAogICAgICAgIC8vIHNldCAwIGZvciB1bmxpbWl0ZWQsIGJ1dCB0aGlzIGNhbiBjb25mbGljdCB3aXRoIHRyYW5zZm9ybQogICAgICAgIGRyYWdfbWF4X3RvdWNoZXMgIDogMSwKICAgICAgICAvLyBwcmV2ZW50IGRlZmF1bHQgYnJvd3NlciBiZWhhdmlvciB3aGVuIGRyYWdnaW5nIG9jY3VycwogICAgICAgIC8vIGJlIGNhcmVmdWwgd2l0aCBpdCwgaXQgbWFrZXMgdGhlIGVsZW1lbnQgYSBibG9ja2luZyBlbGVtZW50CiAgICAgICAgLy8gd2hlbiB5b3UgYXJlIHVzaW5nIHRoZSBkcmFnIGdlc3R1cmUsIGl0IGlzIGEgZ29vZCBwcmFjdGljZSB0byBzZXQgdGhpcyB0cnVlCiAgICAgICAgZHJhZ19ibG9ja19ob3Jpem9udGFsICAgOiB0cnVlLAogICAgICAgIGRyYWdfYmxvY2tfdmVydGljYWwgICAgIDogdHJ1ZSwKICAgICAgICAvLyBkcmFnX2xvY2tfdG9fYXhpcyBrZWVwcyB0aGUgZHJhZyBnZXN0dXJlIG9uIHRoZSBheGlzIHRoYXQgaXQgc3RhcnRlZCBvbiwKICAgICAgICAvLyBJdCBkaXNhbGxvd3MgdmVydGljYWwgZGlyZWN0aW9ucyBpZiB0aGUgaW5pdGlhbCBkaXJlY3Rpb24gd2FzIGhvcml6b250YWwsIGFuZCB2aWNlIHZlcnNhLgogICAgICAgIGRyYWdfbG9ja190b19heGlzICAgICAgIDogZmFsc2UsCiAgICAgICAgLy8gZHJhZyBsb2NrIG9ubHkga2lja3MgaW4gd2hlbiBkaXN0YW5jZSA+IGRyYWdfbG9ja19taW5fZGlzdGFuY2UKICAgICAgICAvLyBUaGlzIHdheSwgbG9ja2luZyBvY2N1cnMgb25seSB3aGVuIHRoZSBkaXN0YW5jZSBoYXMgYmVjb21lIGxhcmdlIGVub3VnaCB0byByZWxpYWJseSBkZXRlcm1pbmUgdGhlIGRpcmVjdGlvbgogICAgICAgIGRyYWdfbG9ja19taW5fZGlzdGFuY2UgOiAyNQogICAgICB9LAogICAgICB0cmlnZ2VyZWQ6IGZhbHNlLAogICAgICBoYW5kbGVyOiBmdW5jdGlvbiBkcmFnR2VzdHVyZShldiwgaW5zdCkgewogICAgICAgIC8vIGN1cnJlbnQgZ2VzdHVyZSBpc250IGRyYWcsIGJ1dCBkcmFnZ2VkIGlzIHRydWUKICAgICAgICAvLyB0aGlzIG1lYW5zIGFuIG90aGVyIGdlc3R1cmUgaXMgYnVzeS4gbm93IGNhbGwgZHJhZ2VuZAogICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgIT0gdGhpcy5uYW1lICYmIHRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnZW5kJywgZXYpOwogICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIG1heCB0b3VjaGVzCiAgICAgICAgaWYoaW5zdC5vcHRpb25zLmRyYWdfbWF4X3RvdWNoZXMgPiAwICYmCiAgICAgICAgICBldi50b3VjaGVzLmxlbmd0aCA+IGluc3Qub3B0aW9ucy5kcmFnX21heF90b3VjaGVzKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBzd2l0Y2goZXYuZXZlbnRUeXBlKSB7CiAgICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX1NUQVJUOgogICAgICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX01PVkU6CiAgICAgICAgICAgIC8vIHdoZW4gdGhlIGRpc3RhbmNlIHdlIG1vdmVkIGlzIHRvbyBzbWFsbCB3ZSBza2lwIHRoaXMgZ2VzdHVyZQogICAgICAgICAgICAvLyBvciB3ZSBjYW4gYmUgYWxyZWFkeSBpbiBkcmFnZ2luZwogICAgICAgICAgICBpZihldi5kaXN0YW5jZSA8IGluc3Qub3B0aW9ucy5kcmFnX21pbl9kaXN0YW5jZSAmJgogICAgICAgICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgIT0gdGhpcy5uYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyB3ZSBhcmUgZHJhZ2dpbmchCiAgICAgICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgIT0gdGhpcy5uYW1lKSB7CiAgICAgICAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSA9IHRoaXMubmFtZTsKICAgICAgICAgICAgICBpZiAoaW5zdC5vcHRpb25zLmNvcnJlY3RfZm9yX2RyYWdfbWluX2Rpc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAvLyBXaGVuIGEgZHJhZyBpcyB0cmlnZ2VyZWQsIHNldCB0aGUgZXZlbnQgY2VudGVyIHRvIGRyYWdfbWluX2Rpc3RhbmNlIHBpeGVscyBmcm9tIHRoZSBvcmlnaW5hbCBldmVudCBjZW50ZXIuCiAgICAgICAgICAgICAgICAvLyBXaXRob3V0IHRoaXMgY29ycmVjdGlvbiwgdGhlIGRyYWdnZWQgZGlzdGFuY2Ugd291bGQganVtcHN0YXJ0IGF0IGRyYWdfbWluX2Rpc3RhbmNlIHBpeGVscyBpbnN0ZWFkIG9mIGF0IDAuCiAgICAgICAgICAgICAgICAvLyBJdCBtaWdodCBiZSB1c2VmdWwgdG8gc2F2ZSB0aGUgb3JpZ2luYWwgc3RhcnQgcG9pbnQgc29tZXdoZXJlCiAgICAgICAgICAgICAgICB2YXIgZmFjdG9yID0gTWF0aC5hYnMoaW5zdC5vcHRpb25zLmRyYWdfbWluX2Rpc3RhbmNlL2V2LmRpc3RhbmNlKTsKICAgICAgICAgICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50LnN0YXJ0RXZlbnQuY2VudGVyLnBhZ2VYICs9IGV2LmRlbHRhWCAqIGZhY3RvcjsKICAgICAgICAgICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50LnN0YXJ0RXZlbnQuY2VudGVyLnBhZ2VZICs9IGV2LmRlbHRhWSAqIGZhY3RvcjsKCiAgICAgICAgICAgICAgICAvLyByZWNhbGN1bGF0ZSBldmVudCBkYXRhIHVzaW5nIG5ldyBzdGFydCBwb2ludAogICAgICAgICAgICAgICAgZXYgPSBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uZXh0ZW5kRXZlbnREYXRhKGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGxvY2sgZHJhZyB0byBheGlzPwogICAgICAgICAgICBpZihpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uY3VycmVudC5sYXN0RXZlbnQuZHJhZ19sb2NrZWRfdG9fYXhpcyB8fCAoaW5zdC5vcHRpb25zLmRyYWdfbG9ja190b19heGlzICYmIGluc3Qub3B0aW9ucy5kcmFnX2xvY2tfbWluX2Rpc3RhbmNlPD1ldi5kaXN0YW5jZSkpIHsKICAgICAgICAgICAgICBldi5kcmFnX2xvY2tlZF90b19heGlzID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbGFzdF9kaXJlY3Rpb24gPSBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uY3VycmVudC5sYXN0RXZlbnQuZGlyZWN0aW9uOwogICAgICAgICAgICBpZihldi5kcmFnX2xvY2tlZF90b19heGlzICYmIGxhc3RfZGlyZWN0aW9uICE9PSBldi5kaXJlY3Rpb24pIHsKICAgICAgICAgICAgICAvLyBrZWVwIGRpcmVjdGlvbiBvbiB0aGUgYXhpcyB0aGF0IHRoZSBkcmFnIGdlc3R1cmUgc3RhcnRlZCBvbgogICAgICAgICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLnV0aWxzLmlzVmVydGljYWwobGFzdF9kaXJlY3Rpb24pKSB7CiAgICAgICAgICAgICAgICBldi5kaXJlY3Rpb24gPSAoZXYuZGVsdGFZIDwgMCkgPyBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fVVAgOiBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fRE9XTjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBldi5kaXJlY3Rpb24gPSAoZXYuZGVsdGFYIDwgMCkgPyBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fTEVGVCA6IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9SSUdIVDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZpcnN0IHRpbWUsIHRyaWdnZXIgZHJhZ3N0YXJ0IGV2ZW50CiAgICAgICAgICAgIGlmKCF0aGlzLnRyaWdnZXJlZCkgewogICAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKydzdGFydCcsIGV2KTsKICAgICAgICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHRyaWdnZXIgbm9ybWFsIGV2ZW50CiAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUsIGV2KTsKCiAgICAgICAgICAgIC8vIGRpcmVjdGlvbiBldmVudCwgbGlrZSBkcmFnZG93bgogICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsgZXYuZGlyZWN0aW9uLCBldik7CgogICAgICAgICAgICAvLyBibG9jayB0aGUgYnJvd3NlciBldmVudHMKICAgICAgICAgICAgaWYoIChpbnN0Lm9wdGlvbnMuZHJhZ19ibG9ja192ZXJ0aWNhbCAmJiBpb25pYy5HZXN0dXJlcy51dGlscy5pc1ZlcnRpY2FsKGV2LmRpcmVjdGlvbikpIHx8CiAgICAgICAgICAgICAgKGluc3Qub3B0aW9ucy5kcmFnX2Jsb2NrX2hvcml6b250YWwgJiYgIWlvbmljLkdlc3R1cmVzLnV0aWxzLmlzVmVydGljYWwoZXYuZGlyZWN0aW9uKSkpIHsKICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EOgogICAgICAgICAgICAvLyB0cmlnZ2VyIGRyYWdlbmQKICAgICAgICAgICAgaWYodGhpcy50cmlnZ2VyZWQpIHsKICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnZW5kJywgZXYpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogVHJhbnNmb3JtCiAgICAgKiBVc2VyIHdhbnQgdG8gc2NhbGUgb3Igcm90YXRlIHdpdGggMiBmaW5nZXJzCiAgICAgKiBldmVudHMgIHRyYW5zZm9ybSwgcGluY2gsIHBpbmNoaW4sIHBpbmNob3V0LCByb3RhdGUKICAgICAqLwogICAgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuVHJhbnNmb3JtID0gewogICAgICBuYW1lOiAndHJhbnNmb3JtJywKICAgICAgaW5kZXg6IDQ1LAogICAgICBkZWZhdWx0czogewogICAgICAgIC8vIGZhY3Rvciwgbm8gc2NhbGUgaXMgMSwgem9vbWluIGlzIHRvIDAgYW5kIHpvb21vdXQgdW50aWwgaGlnaGVyIHRoZW4gMQogICAgICAgIHRyYW5zZm9ybV9taW5fc2NhbGUgICAgIDogMC4wMSwKICAgICAgICAvLyByb3RhdGlvbiBpbiBkZWdyZWVzCiAgICAgICAgdHJhbnNmb3JtX21pbl9yb3RhdGlvbiAgOiAxLAogICAgICAgIC8vIHByZXZlbnQgZGVmYXVsdCBicm93c2VyIGJlaGF2aW9yIHdoZW4gdHdvIHRvdWNoZXMgYXJlIG9uIHRoZSBzY3JlZW4KICAgICAgICAvLyBidXQgaXQgbWFrZXMgdGhlIGVsZW1lbnQgYSBibG9ja2luZyBlbGVtZW50CiAgICAgICAgLy8gd2hlbiB5b3UgYXJlIHVzaW5nIHRoZSB0cmFuc2Zvcm0gZ2VzdHVyZSwgaXQgaXMgYSBnb29kIHByYWN0aWNlIHRvIHNldCB0aGlzIHRydWUKICAgICAgICB0cmFuc2Zvcm1fYWx3YXlzX2Jsb2NrICA6IGZhbHNlCiAgICAgIH0sCiAgICAgIHRyaWdnZXJlZDogZmFsc2UsCiAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIHRyYW5zZm9ybUdlc3R1cmUoZXYsIGluc3QpIHsKICAgICAgICAvLyBjdXJyZW50IGdlc3R1cmUgaXNudCBkcmFnLCBidXQgZHJhZ2dlZCBpcyB0cnVlCiAgICAgICAgLy8gdGhpcyBtZWFucyBhbiBvdGhlciBnZXN0dXJlIGlzIGJ1c3kuIG5vdyBjYWxsIGRyYWdlbmQKICAgICAgICBpZihpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uY3VycmVudC5uYW1lICE9IHRoaXMubmFtZSAmJiB0aGlzLnRyaWdnZXJlZCkgewogICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArJ2VuZCcsIGV2KTsKICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBhdGxlYXN0IG11bHRpdG91Y2gKICAgICAgICBpZihldi50b3VjaGVzLmxlbmd0aCA8IDIpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIHByZXZlbnQgZGVmYXVsdCB3aGVuIHR3byBmaW5nZXJzIGFyZSBvbiB0aGUgc2NyZWVuCiAgICAgICAgaWYoaW5zdC5vcHRpb25zLnRyYW5zZm9ybV9hbHdheXNfYmxvY2spIHsKICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICBzd2l0Y2goZXYuZXZlbnRUeXBlKSB7CiAgICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX1NUQVJUOgogICAgICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX01PVkU6CiAgICAgICAgICAgIHZhciBzY2FsZV90aHJlc2hvbGQgPSBNYXRoLmFicygxLWV2LnNjYWxlKTsKICAgICAgICAgICAgdmFyIHJvdGF0aW9uX3RocmVzaG9sZCA9IE1hdGguYWJzKGV2LnJvdGF0aW9uKTsKCiAgICAgICAgICAgIC8vIHdoZW4gdGhlIGRpc3RhbmNlIHdlIG1vdmVkIGlzIHRvbyBzbWFsbCB3ZSBza2lwIHRoaXMgZ2VzdHVyZQogICAgICAgICAgICAvLyBvciB3ZSBjYW4gYmUgYWxyZWFkeSBpbiBkcmFnZ2luZwogICAgICAgICAgICBpZihzY2FsZV90aHJlc2hvbGQgPCBpbnN0Lm9wdGlvbnMudHJhbnNmb3JtX21pbl9zY2FsZSAmJgogICAgICAgICAgICAgIHJvdGF0aW9uX3RocmVzaG9sZCA8IGluc3Qub3B0aW9ucy50cmFuc2Zvcm1fbWluX3JvdGF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyB3ZSBhcmUgdHJhbnNmb3JtaW5nIQogICAgICAgICAgICBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uY3VycmVudC5uYW1lID0gdGhpcy5uYW1lOwoKICAgICAgICAgICAgLy8gZmlyc3QgdGltZSwgdHJpZ2dlciBkcmFnc3RhcnQgZXZlbnQKICAgICAgICAgICAgaWYoIXRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArJ3N0YXJ0JywgZXYpOwogICAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOyAvLyBiYXNpYyB0cmFuc2Zvcm0gZXZlbnQKCiAgICAgICAgICAgIC8vIHRyaWdnZXIgcm90YXRlIGV2ZW50CiAgICAgICAgICAgIGlmKHJvdGF0aW9uX3RocmVzaG9sZCA+IGluc3Qub3B0aW9ucy50cmFuc2Zvcm1fbWluX3JvdGF0aW9uKSB7CiAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKCdyb3RhdGUnLCBldik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHRyaWdnZXIgcGluY2ggZXZlbnQKICAgICAgICAgICAgaWYoc2NhbGVfdGhyZXNob2xkID4gaW5zdC5vcHRpb25zLnRyYW5zZm9ybV9taW5fc2NhbGUpIHsKICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ3BpbmNoJywgZXYpOwogICAgICAgICAgICAgIGluc3QudHJpZ2dlcigncGluY2gnKyAoKGV2LnNjYWxlIDwgMSkgPyAnaW4nIDogJ291dCcpLCBldik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQ6CiAgICAgICAgICAgIC8vIHRyaWdnZXIgZHJhZ2VuZAogICAgICAgICAgICBpZih0aGlzLnRyaWdnZXJlZCkgewogICAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKydlbmQnLCBldik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCgogICAgLyoqCiAgICAgKiBUb3VjaAogICAgICogQ2FsbGVkIGFzIGZpcnN0LCB0ZWxscyB0aGUgdXNlciBoYXMgdG91Y2hlZCB0aGUgc2NyZWVuCiAgICAgKiBldmVudHMgIHRvdWNoCiAgICAgKi8KICAgIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzLlRvdWNoID0gewogICAgICBuYW1lOiAndG91Y2gnLAogICAgICBpbmRleDogLUluZmluaXR5LAogICAgICBkZWZhdWx0czogewogICAgICAgIC8vIGNhbGwgcHJldmVudERlZmF1bHQgYXQgdG91Y2hzdGFydCwgYW5kIG1ha2VzIHRoZSBlbGVtZW50IGJsb2NraW5nIGJ5CiAgICAgICAgLy8gZGlzYWJsaW5nIHRoZSBzY3JvbGxpbmcgb2YgdGhlIHBhZ2UsIGJ1dCBpdCBpbXByb3ZlcyBnZXN0dXJlcyBsaWtlCiAgICAgICAgLy8gdHJhbnNmb3JtaW5nIGFuZCBkcmFnZ2luZy4KICAgICAgICAvLyBiZSBjYXJlZnVsIHdpdGggdXNpbmcgdGhpcywgaXQgY2FuIGJlIHZlcnkgYW5ub3lpbmcgZm9yIHVzZXJzIHRvIGJlIHN0dWNrCiAgICAgICAgLy8gb24gdGhlIHBhZ2UKICAgICAgICBwcmV2ZW50X2RlZmF1bHQ6IGZhbHNlLAoKICAgICAgICAvLyBkaXNhYmxlIG1vdXNlIGV2ZW50cywgc28gb25seSB0b3VjaCAob3IgcGVuISkgaW5wdXQgdHJpZ2dlcnMgZXZlbnRzCiAgICAgICAgcHJldmVudF9tb3VzZWV2ZW50czogZmFsc2UKICAgICAgfSwKICAgICAgaGFuZGxlcjogZnVuY3Rpb24gdG91Y2hHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgaWYoaW5zdC5vcHRpb25zLnByZXZlbnRfbW91c2VldmVudHMgJiYgZXYucG9pbnRlclR5cGUgPT0gaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9NT1VTRSkgewogICAgICAgICAgZXYuc3RvcERldGVjdCgpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYoaW5zdC5vcHRpb25zLnByZXZlbnRfZGVmYXVsdCkgewogICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CgogICAgICAgIGlmKGV2LmV2ZW50VHlwZSA9PSAgaW9uaWMuR2VzdHVyZXMuRVZFTlRfU1RBUlQpIHsKICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUsIGV2KTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogUmVsZWFzZQogICAgICogQ2FsbGVkIGFzIGxhc3QsIHRlbGxzIHRoZSB1c2VyIGhhcyByZWxlYXNlZCB0aGUgc2NyZWVuCiAgICAgKiBldmVudHMgIHJlbGVhc2UKICAgICAqLwogICAgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuUmVsZWFzZSA9IHsKICAgICAgbmFtZTogJ3JlbGVhc2UnLAogICAgICBpbmRleDogSW5maW5pdHksCiAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIHJlbGVhc2VHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgaWYoZXYuZXZlbnRUeXBlID09ICBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQpIHsKICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUsIGV2KTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfSkod2luZG93LmlvbmljKTsKCiAgKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQsIGlvbmljKSB7CgogICAgdmFyIElPUyA9ICdpb3MnOwogICAgdmFyIEFORFJPSUQgPSAnYW5kcm9pZCc7CiAgICB2YXIgV0lORE9XU19QSE9ORSA9ICd3aW5kb3dzcGhvbmUnOwoKICAgIC8qKgogICAgICogQG5nZG9jIHV0aWxpdHkKICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtCiAgICAgKiBAbW9kdWxlIGlvbmljCiAgICAgKi8KICAgIGlvbmljLlBsYXRmb3JtID0gewoKICAgICAgLy8gUHV0IG5hdmlnYXRvciBvbiBwbGF0Zm9ybSBzbyBpdCBjYW4gYmUgbW9ja2VkIGFuZCBzZXQKICAgICAgLy8gdGhlIGJyb3dzZXIgZG9lcyBub3QgYWxsb3cgd2luZG93Lm5hdmlnYXRvciB0byBiZSBzZXQKICAgICAgbmF2aWdhdG9yOiB3aW5kb3cubmF2aWdhdG9yLAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNpc1JlYWR5CiAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSBkZXZpY2UgaXMgcmVhZHkuCiAgICAgICAqLwogICAgICBpc1JlYWR5OiBmYWxzZSwKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNpc0Z1bGxTY3JlZW4KICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGRldmljZSBpcyBmdWxsc2NyZWVuLgogICAgICAgKi8KICAgICAgaXNGdWxsU2NyZWVuOiBmYWxzZSwKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNwbGF0Zm9ybXMKICAgICAgICogQHJldHVybnMge0FycmF5KHN0cmluZyl9IEFuIGFycmF5IG9mIGFsbCBwbGF0Zm9ybXMgZm91bmQuCiAgICAgICAqLwogICAgICBwbGF0Zm9ybXM6IG51bGwsCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jZ3JhZGUKICAgICAgICogQHJldHVybnMge3N0cmluZ30gV2hhdCBncmFkZSB0aGUgY3VycmVudCBwbGF0Zm9ybSBpcy4KICAgICAgICovCiAgICAgIGdyYWRlOiBudWxsLAogICAgICB1YTogbmF2aWdhdG9yLnVzZXJBZ2VudCwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI3JlYWR5CiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBUcmlnZ2VyIGEgY2FsbGJhY2sgb25jZSB0aGUgZGV2aWNlIGlzIHJlYWR5LCBvciBpbW1lZGlhdGVseQogICAgICAgKiBpZiB0aGUgZGV2aWNlIGlzIGFscmVhZHkgcmVhZHkuIFRoaXMgbWV0aG9kIGNhbiBiZSBydW4gZnJvbQogICAgICAgKiBhbnl3aGVyZSBhbmQgZG9lcyBub3QgbmVlZCB0byBiZSB3cmFwcGVkIGJ5IGFueSBhZGRpdG9uYWwgbWV0aG9kcy4KICAgICAgICogV2hlbiB0aGUgYXBwIGlzIHdpdGhpbiBhIFdlYlZpZXcgKENvcmRvdmEpLCBpdCdsbCBmaXJlCiAgICAgICAqIHRoZSBjYWxsYmFjayBvbmNlIHRoZSBkZXZpY2UgaXMgcmVhZHkuIElmIHRoZSBhcHAgaXMgd2l0aGluCiAgICAgICAqIGEgd2ViIGJyb3dzZXIsIGl0J2xsIGZpcmUgdGhlIGNhbGxiYWNrIGFmdGVyIGB3aW5kb3cubG9hZGAuCiAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBjYWxsLgogICAgICAgKi8KICAgICAgcmVhZHk6IGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgLy8gcnVuIHRocm91Z2ggdGFza3MgdG8gY29tcGxldGUgbm93IHRoYXQgdGhlIGRldmljZSBpcyByZWFkeQogICAgICAgIGlmKHRoaXMuaXNSZWFkeSkgewogICAgICAgICAgY2IoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gdGhlIHBsYXRmb3JtIGlzbid0IHJlYWR5IHlldCwgYWRkIGl0IHRvIHRoaXMgYXJyYXkKICAgICAgICAgIC8vIHdoaWNoIHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIHBsYXRmb3JtIGlzIHJlYWR5CiAgICAgICAgICByZWFkeUNhbGxiYWNrcy5wdXNoKGNiKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQHByaXZhdGUKICAgICAgICovCiAgICAgIGRldGVjdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaW9uaWMuUGxhdGZvcm0uX2NoZWNrUGxhdGZvcm1zKCk7CgogICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpewogICAgICAgICAgLy8gb25seSBhZGQgdG8gdGhlIGJvZHkgY2xhc3MgaWYgd2UgZ290IHBsYXRmb3JtIGluZm8KICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBpb25pYy5QbGF0Zm9ybS5wbGF0Zm9ybXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdwbGF0Zm9ybS0nICsgaW9uaWMuUGxhdGZvcm0ucGxhdGZvcm1zW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI3NldEdyYWRlCiAgICAgICAqIEBkZXNjcmlwdGlvbiBTZXQgdGhlIGdyYWRlIG9mIHRoZSBkZXZpY2U6ICdhJywgJ2InLCBvciAnYycuICdhJyBpcyB0aGUgYmVzdAogICAgICAgKiAobW9zdCBjc3MgZmVhdHVyZXMgZW5hYmxlZCksICdjJyBpcyB0aGUgd29yc3QuICBCeSBkZWZhdWx0LCBzZXRzIHRoZSBncmFkZQogICAgICAgKiBkZXBlbmRpbmcgb24gdGhlIGN1cnJlbnQgZGV2aWNlLgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZ3JhZGUgVGhlIG5ldyBncmFkZSB0byBzZXQuCiAgICAgICAqLwogICAgICBzZXRHcmFkZTogZnVuY3Rpb24oZ3JhZGUpIHsKICAgICAgICB2YXIgb2xkR3JhZGUgPSB0aGlzLmdyYWRlOwogICAgICAgIHRoaXMuZ3JhZGUgPSBncmFkZTsKICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAob2xkR3JhZGUpIHsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdncmFkZS0nICsgb2xkR3JhZGUpOwogICAgICAgICAgfQogICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdncmFkZS0nICsgZ3JhZGUpOwogICAgICAgIH0pOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jZGV2aWNlCiAgICAgICAqIEBkZXNjcmlwdGlvbiBSZXR1cm4gdGhlIGN1cnJlbnQgZGV2aWNlIChnaXZlbiBieSBjb3Jkb3ZhKS4KICAgICAgICogQHJldHVybnMge29iamVjdH0gVGhlIGRldmljZSBvYmplY3QuCiAgICAgICAqLwogICAgICBkZXZpY2U6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmKHdpbmRvdy5kZXZpY2UpIHJldHVybiB3aW5kb3cuZGV2aWNlOwogICAgICAgIGlmKHRoaXMuaXNXZWJWaWV3KCkpIHZvaWQgMDsKICAgICAgICByZXR1cm4ge307CiAgICAgIH0sCgogICAgICBfY2hlY2tQbGF0Zm9ybXM6IGZ1bmN0aW9uKHBsYXRmb3JtcykgewogICAgICAgIHRoaXMucGxhdGZvcm1zID0gW107CiAgICAgICAgdmFyIGdyYWRlID0gJ2EnOwoKICAgICAgICBpZih0aGlzLmlzV2ViVmlldygpKSB7CiAgICAgICAgICB0aGlzLnBsYXRmb3Jtcy5wdXNoKCd3ZWJ2aWV3Jyk7CiAgICAgICAgICB0aGlzLnBsYXRmb3Jtcy5wdXNoKCdjb3Jkb3ZhJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMucGxhdGZvcm1zLnB1c2goJ2Jyb3dzZXInKTsKICAgICAgICB9CiAgICAgICAgaWYodGhpcy5pc0lQYWQoKSkgdGhpcy5wbGF0Zm9ybXMucHVzaCgnaXBhZCcpOwoKICAgICAgICB2YXIgcGxhdGZvcm0gPSB0aGlzLnBsYXRmb3JtKCk7CiAgICAgICAgaWYocGxhdGZvcm0pIHsKICAgICAgICAgIHRoaXMucGxhdGZvcm1zLnB1c2gocGxhdGZvcm0pOwoKICAgICAgICAgIHZhciB2ZXJzaW9uID0gdGhpcy52ZXJzaW9uKCk7CiAgICAgICAgICBpZih2ZXJzaW9uKSB7CiAgICAgICAgICAgIHZhciB2ID0gdmVyc2lvbi50b1N0cmluZygpOwogICAgICAgICAgICBpZih2LmluZGV4T2YoJy4nKSA+IDApIHsKICAgICAgICAgICAgICB2ID0gdi5yZXBsYWNlKCcuJywgJ18nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2ICs9ICdfMCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5wbGF0Zm9ybXMucHVzaChwbGF0Zm9ybSArIHYuc3BsaXQoJ18nKVswXSk7CiAgICAgICAgICAgIHRoaXMucGxhdGZvcm1zLnB1c2gocGxhdGZvcm0gKyB2KTsKCiAgICAgICAgICAgIGlmKHRoaXMuaXNBbmRyb2lkKCkgJiYgdmVyc2lvbiA8IDQuNCkgewogICAgICAgICAgICAgIGdyYWRlID0gKHZlcnNpb24gPCA0ID8gJ2MnIDogJ2InKTsKICAgICAgICAgICAgfSBlbHNlIGlmKHRoaXMuaXNXaW5kb3dzUGhvbmUoKSkgewogICAgICAgICAgICAgIGdyYWRlID0gJ2InOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNldEdyYWRlKGdyYWRlKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2lzV2ViVmlldwogICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gQ2hlY2sgaWYgd2UgYXJlIHJ1bm5pbmcgd2l0aGluIGEgV2ViVmlldyAoc3VjaCBhcyBDb3Jkb3ZhKS4KICAgICAgICovCiAgICAgIGlzV2ViVmlldzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICEoIXdpbmRvdy5jb3Jkb3ZhICYmICF3aW5kb3cuUGhvbmVHYXAgJiYgIXdpbmRvdy5waG9uZWdhcCk7CiAgICAgIH0sCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2lzSVBhZAogICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB3ZSBhcmUgcnVubmluZyBvbiBpUGFkLgogICAgICAgKi8KICAgICAgaXNJUGFkOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiggL2lQYWQvaS50ZXN0KGlvbmljLlBsYXRmb3JtLm5hdmlnYXRvci5wbGF0Zm9ybSkgKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIC9pUGFkL2kudGVzdCh0aGlzLnVhKTsKICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jaXNJT1MKICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgd2UgYXJlIHJ1bm5pbmcgb24gaU9TLgogICAgICAgKi8KICAgICAgaXNJT1M6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmlzKElPUyk7CiAgICAgIH0sCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2lzQW5kcm9pZAogICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB3ZSBhcmUgcnVubmluZyBvbiBBbmRyb2lkLgogICAgICAgKi8KICAgICAgaXNBbmRyb2lkOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5pcyhBTkRST0lEKTsKICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jaXNXaW5kb3dzUGhvbmUKICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgd2UgYXJlIHJ1bm5pbmcgb24gV2luZG93cyBQaG9uZS4KICAgICAgICovCiAgICAgIGlzV2luZG93c1Bob25lOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5pcyhXSU5ET1dTX1BIT05FKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI3BsYXRmb3JtCiAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBuYW1lIG9mIHRoZSBjdXJyZW50IHBsYXRmb3JtLgogICAgICAgKi8KICAgICAgcGxhdGZvcm06IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIHNpbmdsZXRvbiB0byBnZXQgdGhlIHBsYXRmb3JtIG5hbWUKICAgICAgICBpZihwbGF0Zm9ybU5hbWUgPT09IG51bGwpIHRoaXMuc2V0UGxhdGZvcm0odGhpcy5kZXZpY2UoKS5wbGF0Zm9ybSk7CiAgICAgICAgcmV0dXJuIHBsYXRmb3JtTmFtZTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAcHJpdmF0ZQogICAgICAgKi8KICAgICAgc2V0UGxhdGZvcm06IGZ1bmN0aW9uKG4pIHsKICAgICAgICBpZih0eXBlb2YgbiAhPSAndW5kZWZpbmVkJyAmJiBuICE9PSBudWxsICYmIG4ubGVuZ3RoKSB7CiAgICAgICAgICBwbGF0Zm9ybU5hbWUgPSBuLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfSBlbHNlIGlmKHRoaXMudWEuaW5kZXhPZignQW5kcm9pZCcpID4gMCkgewogICAgICAgICAgcGxhdGZvcm1OYW1lID0gQU5EUk9JRDsKICAgICAgICB9IGVsc2UgaWYodGhpcy51YS5pbmRleE9mKCdpUGhvbmUnKSA+IC0xIHx8IHRoaXMudWEuaW5kZXhPZignaVBhZCcpID4gLTEgfHwgdGhpcy51YS5pbmRleE9mKCdpUG9kJykgPiAtMSkgewogICAgICAgICAgcGxhdGZvcm1OYW1lID0gSU9TOwogICAgICAgIH0gZWxzZSBpZih0aGlzLnVhLmluZGV4T2YoJ1dpbmRvd3MgUGhvbmUnKSA+IC0xKSB7CiAgICAgICAgICBwbGF0Zm9ybU5hbWUgPSBXSU5ET1dTX1BIT05FOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwbGF0Zm9ybU5hbWUgPSBpb25pYy5QbGF0Zm9ybS5uYXZpZ2F0b3IucGxhdGZvcm0gJiYgbmF2aWdhdG9yLnBsYXRmb3JtLnRvTG93ZXJDYXNlKCkuc3BsaXQoJyAnKVswXSB8fCAnJzsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSN2ZXJzaW9uCiAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSB2ZXJzaW9uIG9mIHRoZSBjdXJyZW50IGRldmljZSBwbGF0Zm9ybS4KICAgICAgICovCiAgICAgIHZlcnNpb246IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIHNpbmdsZXRvbiB0byBnZXQgdGhlIHBsYXRmb3JtIHZlcnNpb24KICAgICAgICBpZihwbGF0Zm9ybVZlcnNpb24gPT09IG51bGwpIHRoaXMuc2V0VmVyc2lvbih0aGlzLmRldmljZSgpLnZlcnNpb24pOwogICAgICAgIHJldHVybiBwbGF0Zm9ybVZlcnNpb247CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQHByaXZhdGUKICAgICAgICovCiAgICAgIHNldFZlcnNpb246IGZ1bmN0aW9uKHYpIHsKICAgICAgICBpZih0eXBlb2YgdiAhPSAndW5kZWZpbmVkJyAmJiB2ICE9PSBudWxsKSB7CiAgICAgICAgICB2ID0gdi5zcGxpdCgnLicpOwogICAgICAgICAgdiA9IHBhcnNlRmxvYXQodlswXSArICcuJyArICh2Lmxlbmd0aCA+IDEgPyB2WzFdIDogMCkpOwogICAgICAgICAgaWYoIWlzTmFOKHYpKSB7CiAgICAgICAgICAgIHBsYXRmb3JtVmVyc2lvbiA9IHY7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHBsYXRmb3JtVmVyc2lvbiA9IDA7CgogICAgICAgIC8vIGZhbGxiYWNrIHRvIHVzZXItYWdlbnQgY2hlY2tpbmcKICAgICAgICB2YXIgcE5hbWUgPSB0aGlzLnBsYXRmb3JtKCk7CiAgICAgICAgdmFyIHZlcnNpb25NYXRjaCA9IHsKICAgICAgICAgICdhbmRyb2lkJzogL0FuZHJvaWQgKFxkKykuKFxkKyk/LywKICAgICAgICAgICdpb3MnOiAvT1MgKFxkKylfKFxkKyk/LywKICAgICAgICAgICd3aW5kb3dzcGhvbmUnOiAvV2luZG93cyBQaG9uZSAoXGQrKS4oXGQrKT8vCiAgICAgICAgfTsKICAgICAgICBpZih2ZXJzaW9uTWF0Y2hbcE5hbWVdKSB7CiAgICAgICAgICB2ID0gdGhpcy51YS5tYXRjaCggdmVyc2lvbk1hdGNoW3BOYW1lXSApOwogICAgICAgICAgaWYodiAmJiAgdi5sZW5ndGggPiAyKSB7CiAgICAgICAgICAgIHBsYXRmb3JtVmVyc2lvbiA9IHBhcnNlRmxvYXQoIHZbMV0gKyAnLicgKyB2WzJdICk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLy8gQ2hlY2sgaWYgdGhlIHBsYXRmb3JtIGlzIHRoZSBvbmUgZGV0ZWN0ZWQgYnkgY29yZG92YQogICAgICBpczogZnVuY3Rpb24odHlwZSkgewogICAgICAgIHR5cGUgPSB0eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgLy8gY2hlY2sgaWYgaXQgaGFzIGFuIGFycmF5IG9mIHBsYXRmb3JtcwogICAgICAgIGlmKHRoaXMucGxhdGZvcm1zKSB7CiAgICAgICAgICBmb3IodmFyIHggPSAwOyB4IDwgdGhpcy5wbGF0Zm9ybXMubGVuZ3RoOyB4KyspIHsKICAgICAgICAgICAgaWYodGhpcy5wbGF0Zm9ybXNbeF0gPT09IHR5cGUpIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyBleGFjdCBtYXRjaAogICAgICAgIHZhciBwTmFtZSA9IHRoaXMucGxhdGZvcm0oKTsKICAgICAgICBpZihwTmFtZSkgewogICAgICAgICAgcmV0dXJuIHBOYW1lID09PSB0eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBBIHF1aWNrIGhhY2sgZm9yIHRvIGNoZWNrIHVzZXJBZ2VudAogICAgICAgIHJldHVybiB0aGlzLnVhLnRvTG93ZXJDYXNlKCkuaW5kZXhPZih0eXBlKSA+PSAwOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jZXhpdEFwcAogICAgICAgKiBAZGVzY3JpcHRpb24gRXhpdCB0aGUgYXBwLgogICAgICAgKi8KICAgICAgZXhpdEFwcDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZWFkeShmdW5jdGlvbigpewogICAgICAgICAgbmF2aWdhdG9yLmFwcCAmJiBuYXZpZ2F0b3IuYXBwLmV4aXRBcHAgJiYgbmF2aWdhdG9yLmFwcC5leGl0QXBwKCk7CiAgICAgICAgfSk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNzaG93U3RhdHVzQmFyCiAgICAgICAqIEBkZXNjcmlwdGlvbiBTaG93cyBvciBoaWRlcyB0aGUgZGV2aWNlIHN0YXR1cyBiYXIgKGluIENvcmRvdmEpLgogICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IHNob3VsZFNob3cgV2hldGhlciBvciBub3QgdG8gc2hvdyB0aGUgc3RhdHVzIGJhci4KICAgICAgICovCiAgICAgIHNob3dTdGF0dXNCYXI6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgIC8vIE9ubHkgdXNlZnVsIHdoZW4gcnVuIHdpdGhpbiBjb3Jkb3ZhCiAgICAgICAgdGhpcy5fc2hvd1N0YXR1c0JhciA9IHZhbDsKICAgICAgICB0aGlzLnJlYWR5KGZ1bmN0aW9uKCl7CiAgICAgICAgICAvLyBydW4gdGhpcyBvbmx5IHdoZW4gb3IgaWYgdGhlIHBsYXRmb3JtIChjb3Jkb3ZhKSBpcyByZWFkeQogICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGlmKGlvbmljLlBsYXRmb3JtLl9zaG93U3RhdHVzQmFyKSB7CiAgICAgICAgICAgICAgLy8gdGhleSBkbyBub3Qgd2FudCBpdCB0byBiZSBmdWxsIHNjcmVlbgogICAgICAgICAgICAgIHdpbmRvdy5TdGF0dXNCYXIgJiYgd2luZG93LlN0YXR1c0Jhci5zaG93KCk7CiAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdzdGF0dXMtYmFyLWhpZGUnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBpdCBzaG91bGQgYmUgZnVsbCBzY3JlZW4KICAgICAgICAgICAgICB3aW5kb3cuU3RhdHVzQmFyICYmIHdpbmRvdy5TdGF0dXNCYXIuaGlkZSgpOwogICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgnc3RhdHVzLWJhci1oaWRlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jZnVsbFNjcmVlbgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2V0cyB3aGV0aGVyIHRoZSBhcHAgaXMgZnVsbHNjcmVlbiBvciBub3QgKGluIENvcmRvdmEpLgogICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93RnVsbFNjcmVlbiBXaGV0aGVyIG9yIG5vdCB0byBzZXQgdGhlIGFwcCB0byBmdWxsc2NyZWVuLiBEZWZhdWx0cyB0byB0cnVlLgogICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93U3RhdHVzQmFyIFdoZXRoZXIgb3Igbm90IHRvIHNob3cgdGhlIGRldmljZSdzIHN0YXR1cyBiYXIuIERlZmF1bHRzIHRvIGZhbHNlLgogICAgICAgKi8KICAgICAgZnVsbFNjcmVlbjogZnVuY3Rpb24oc2hvd0Z1bGxTY3JlZW4sIHNob3dTdGF0dXNCYXIpIHsKICAgICAgICAvLyBzaG93RnVsbFNjcmVlbjogZGVmYXVsdCBpcyB0cnVlIGlmIG5vIHBhcmFtIHByb3ZpZGVkCiAgICAgICAgdGhpcy5pc0Z1bGxTY3JlZW4gPSAoc2hvd0Z1bGxTY3JlZW4gIT09IGZhbHNlKTsKCiAgICAgICAgLy8gYWRkL3JlbW92ZSB0aGUgZnVsbHNjcmVlbiBjbGFzc25hbWUgdG8gdGhlIGJvZHkKICAgICAgICBpb25pYy5Eb21VdGlsLnJlYWR5KGZ1bmN0aW9uKCl7CiAgICAgICAgICAvLyBydW4gdGhpcyBvbmx5IHdoZW4gb3IgaWYgdGhlIERPTSBpcyByZWFkeQogICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGlmKGlvbmljLlBsYXRmb3JtLmlzRnVsbFNjcmVlbikgewogICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgnZnVsbHNjcmVlbicpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnZnVsbHNjcmVlbicpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIC8vIHNob3dTdGF0dXNCYXI6IGRlZmF1bHQgaXMgZmFsc2UgaWYgbm8gcGFyYW0gcHJvdmlkZWQKICAgICAgICAgIGlvbmljLlBsYXRmb3JtLnNob3dTdGF0dXNCYXIoIChzaG93U3RhdHVzQmFyID09PSB0cnVlKSApOwogICAgICAgIH0pOwogICAgICB9CgogICAgfTsKCiAgICB2YXIgcGxhdGZvcm1OYW1lID0gbnVsbCwgLy8ganVzdCB0aGUgbmFtZSwgbGlrZSBpT1Mgb3IgQW5kcm9pZAogICAgICBwbGF0Zm9ybVZlcnNpb24gPSBudWxsLCAvLyBhIGZsb2F0IG9mIHRoZSBtYWpvciBhbmQgbWlub3IsIGxpa2UgNy4xCiAgICAgIHJlYWR5Q2FsbGJhY2tzID0gW107CgogICAgLy8gc2V0dXAgbGlzdGVuZXJzIHRvIGtub3cgd2hlbiB0aGUgZGV2aWNlIGlzIHJlYWR5IHRvIGdvCiAgICBmdW5jdGlvbiBvbldpbmRvd0xvYWQoKSB7CiAgICAgIGlmKGlvbmljLlBsYXRmb3JtLmlzV2ViVmlldygpKSB7CiAgICAgICAgLy8gdGhlIHdpbmRvdyBhbmQgc2NyaXB0cyBhcmUgZnVsbHkgbG9hZGVkLCBhbmQgYSBjb3Jkb3ZhL3Bob25lZ2FwCiAgICAgICAgLy8gb2JqZWN0IGV4aXN0cyB0aGVuIGxldCdzIGxpc3RlbiBmb3IgdGhlIGRldmljZXJlYWR5CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiZGV2aWNlcmVhZHkiLCBvblBsYXRmb3JtUmVhZHksIGZhbHNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB0aGUgd2luZG93IGFuZCBzY3JpcHRzIGFyZSBmdWxseSBsb2FkZWQsIGJ1dCB0aGUgd2luZG93IG9iamVjdCBkb2Vzbid0IGhhdmUgdGhlCiAgICAgICAgLy8gY29yZG92YS9waG9uZWdhcCBvYmplY3QsIHNvIGl0cyBqdXN0IGEgYnJvd3Nlciwgbm90IGEgd2VidmlldyB3cmFwcGVkIHcvIGNvcmRvdmEKICAgICAgICBvblBsYXRmb3JtUmVhZHkoKTsKICAgICAgfQogICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigibG9hZCIsIG9uV2luZG93TG9hZCwgZmFsc2UpOwogICAgfQogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBvbldpbmRvd0xvYWQsIGZhbHNlKTsKCiAgICBmdW5jdGlvbiBvblBsYXRmb3JtUmVhZHkoKSB7CiAgICAgIC8vIHRoZSBkZXZpY2UgaXMgYWxsIHNldCB0byBnbywgaW5pdCBvdXIgb3duIHN0dWZmIHRoZW4gZmlyZSBvZmYgb3VyIGV2ZW50CiAgICAgIGlvbmljLlBsYXRmb3JtLmlzUmVhZHkgPSB0cnVlOwogICAgICBpb25pYy5QbGF0Zm9ybS5kZXRlY3QoKTsKICAgICAgZm9yKHZhciB4PTA7IHg8cmVhZHlDYWxsYmFja3MubGVuZ3RoOyB4KyspIHsKICAgICAgICAvLyBmaXJlIG9mZiBhbGwgdGhlIGNhbGxiYWNrcyB0aGF0IHdlcmUgYWRkZWQgYmVmb3JlIHRoZSBwbGF0Zm9ybSB3YXMgcmVhZHkKICAgICAgICByZWFkeUNhbGxiYWNrc1t4XSgpOwogICAgICB9CiAgICAgIHJlYWR5Q2FsbGJhY2tzID0gW107CiAgICAgIGlvbmljLnRyaWdnZXIoJ3BsYXRmb3JtcmVhZHknLCB7IHRhcmdldDogZG9jdW1lbnQgfSk7CgogICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ3BsYXRmb3JtLXJlYWR5Jyk7CiAgICAgIH0pOwogICAgfQoKICB9KSh0aGlzLCBkb2N1bWVudCwgaW9uaWMpOwoKICAoZnVuY3Rpb24oZG9jdW1lbnQsIGlvbmljKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgLy8gSW9uaWMgQ1NTIHBvbHlmaWxscwogICAgaW9uaWMuQ1NTID0ge307CgogICAgKGZ1bmN0aW9uKCkgewoKICAgICAgLy8gdHJhbnNmb3JtCiAgICAgIHZhciBpLCBrZXlzID0gWyd3ZWJraXRUcmFuc2Zvcm0nLCAndHJhbnNmb3JtJywgJy13ZWJraXQtdHJhbnNmb3JtJywgJ3dlYmtpdC10cmFuc2Zvcm0nLAogICAgICAgICctbW96LXRyYW5zZm9ybScsICdtb3otdHJhbnNmb3JtJywgJ01velRyYW5zZm9ybScsICdtb3pUcmFuc2Zvcm0nLCAnbXNUcmFuc2Zvcm0nXTsKCiAgICAgIGZvcihpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZihkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGVba2V5c1tpXV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgaW9uaWMuQ1NTLlRSQU5TRk9STSA9IGtleXNbaV07CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIHRyYW5zaXRpb24KICAgICAga2V5cyA9IFsnd2Via2l0VHJhbnNpdGlvbicsICdtb3pUcmFuc2l0aW9uJywgJ21zVHJhbnNpdGlvbicsICd0cmFuc2l0aW9uJ107CiAgICAgIGZvcihpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZihkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGVba2V5c1tpXV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgaW9uaWMuQ1NTLlRSQU5TSVRJT04gPSBrZXlzW2ldOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgfSkoKTsKCiAgICAvLyBjbGFzc0xpc3QgcG9seWZpbGwgZm9yIHRoZW0gb2xkZXIgQW5kcm9pZHMKICAgIC8vIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL2Rldm9uZ292ZXR0LzEzODE4MzkKICAgIGlmICghKCJjbGFzc0xpc3QiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5ICYmIHR5cGVvZiBIVE1MRWxlbWVudCAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEhUTUxFbGVtZW50LnByb3RvdHlwZSwgJ2NsYXNzTGlzdCcsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlKGZuKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgeCwgY2xhc3NlcyA9IHNlbGYuY2xhc3NOYW1lLnNwbGl0KC9ccysvKTsKCiAgICAgICAgICAgICAgZm9yKHg9MDsgeDxhcmd1bWVudHMubGVuZ3RoOyB4KyspIHsKICAgICAgICAgICAgICAgIGZuKGNsYXNzZXMsIGNsYXNzZXMuaW5kZXhPZihhcmd1bWVudHNbeF0pLCBhcmd1bWVudHNbeF0pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgc2VsZi5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oIiAiKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBhZGQ6IHVwZGF0ZShmdW5jdGlvbihjbGFzc2VzLCBpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgICB+aW5kZXggfHwgY2xhc3Nlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfSksCgogICAgICAgICAgICByZW1vdmU6IHVwZGF0ZShmdW5jdGlvbihjbGFzc2VzLCBpbmRleCkgewogICAgICAgICAgICAgIH5pbmRleCAmJiBjbGFzc2VzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgIH0pLAoKICAgICAgICAgICAgdG9nZ2xlOiB1cGRhdGUoZnVuY3Rpb24oY2xhc3NlcywgaW5kZXgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgfmluZGV4ID8gY2xhc3Nlcy5zcGxpY2UoaW5kZXgsIDEpIDogY2xhc3Nlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfSksCgogICAgICAgICAgICBjb250YWluczogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm4gISF+c2VsZi5jbGFzc05hbWUuc3BsaXQoL1xzKy8pLmluZGV4T2YodmFsdWUpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaXRlbTogZnVuY3Rpb24oaSkgewogICAgICAgICAgICAgIHJldHVybiBzZWxmLmNsYXNzTmFtZS5zcGxpdCgvXHMrLylbaV0gfHwgbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgfSkoZG9jdW1lbnQsIGlvbmljKTsKCgogIC8qKgogICAqIEBuZ2RvYyBwYWdlCiAgICogQG5hbWUgdGFwCiAgICogQG1vZHVsZSBpb25pYwogICAqIEBkZXNjcmlwdGlvbgogICAqIE9uIHRvdWNoIGRldmljZXMgc3VjaCBhcyBhIHBob25lIG9yIHRhYmxldCwgc29tZSBicm93c2VycyBpbXBsZW1lbnQgYSAzMDBtcyBkZWxheSBiZXR3ZWVuCiAgICogdGhlIHRpbWUgdGhlIHVzZXIgc3RvcHMgdG91Y2hpbmcgdGhlIGRpc3BsYXkgYW5kIHRoZSBtb21lbnQgdGhlIGJyb3dzZXIgZXhlY3V0ZXMgdGhlCiAgICogY2xpY2suIFRoaXMgZGVsYXkgd2FzIGluaXRpYWxseSBpbnRyb2R1Y2VkIHNvIHRoZSBicm93c2VyIGNhbiBrbm93IHdoZXRoZXIgdGhlIHVzZXIgd2FudHMgdG8KICAgKiBkb3VibGUtdGFwIHRvIHpvb20gaW4gb24gdGhlIHdlYnBhZ2UuICBCYXNpY2FsbHksIHRoZSBicm93c2VyIHdhaXRzIHJvdWdobHkgMzAwbXMgdG8gc2VlIGlmCiAgICogdGhlIHVzZXIgaXMgZG91YmxlLXRhcHBpbmcsIG9yIGp1c3QgdGFwcGluZyBvbiB0aGUgZGlzcGxheSBvbmNlLgogICAqCiAgICogT3V0IG9mIHRoZSBib3gsIElvbmljIGF1dG9tYXRpY2FsbHkgcmVtb3ZlcyB0aGUgMzAwbXMgZGVsYXkgaW4gb3JkZXIgdG8gbWFrZSBJb25pYyBhcHBzCiAgICogZmVlbCBtb3JlICJuYXRpdmUiIGxpa2UuIFJlc3VsdGluZ2x5LCBvdGhlciBzb2x1dGlvbnMgc3VjaCBhcwogICAqIFtmYXN0Y2xpY2tdKGh0dHBzOi8vZ2l0aHViLmNvbS9mdGxhYnMvZmFzdGNsaWNrKSBhbmQgQW5ndWxhcidzCiAgICogW25nVG91Y2hdKGh0dHBzOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZ1RvdWNoKSBzaG91bGQgbm90IGJlIGluY2x1ZGVkLCB0byBhdm9pZCBjb25mbGljdHMuCiAgICoKICAgKiBTb21lIGJyb3dzZXJzIGFscmVhZHkgcmVtb3ZlIHRoZSBkZWxheSB3aXRoIGNlcnRhaW4gc2V0dGluZ3MsIHN1Y2ggYXMgdGhlIENTUyBwcm9wZXJ0eQogICAqIGB0b3VjaC1ldmVudHM6IG5vbmVgIG9yIHdpdGggc3BlY2lmaWMgbWV0YSB0YWcgdmlld3BvcnQgdmFsdWVzLiBIb3dldmVyLCBlYWNoIG9mIHRoZXNlCiAgICogYnJvd3NlcnMgc3RpbGwgaGFuZGxlIGNsaWNrcyBkaWZmZXJlbnRseSwgc3VjaCBhcyB3aGVuIHRvIGZpcmUgb2ZmIG9yIGNhbmNlbCB0aGUgZXZlbnQKICAgKiAobGlrZSBzY3JvbGxpbmcgd2hlbiB0aGUgdGFyZ2V0IGlzIGEgYnV0dG9uLCBvciBob2xkaW5nIGEgYnV0dG9uIGRvd24pLgogICAqIEZvciBicm93c2VycyB0aGF0IGFscmVhZHkgcmVtb3ZlIHRoZSAzMDBtcyBkZWxheSwgY29uc2lkZXIgSW9uaWMncyB0YXAgc3lzdGVtIGFzIGEgd2F5IHRvCiAgICogbm9ybWFsaXplIGhvdyBjbGlja3MgYXJlIGhhbmRsZWQgYWNyb3NzIHRoZSB2YXJpb3VzIGRldmljZXMgc28gdGhlcmUncyBhbiBleHBlY3RlZCByZXNwb25zZQogICAqIG5vIG1hdHRlciB3aGF0IHRoZSBkZXZpY2UsIHBsYXRmb3JtIG9yIHZlcnNpb24uIEFkZGl0aW9uYWxseSwgSW9uaWMgd2lsbCBwcmV2ZW50CiAgICogZ2hvc3RjbGlja3Mgd2hpY2ggZXZlbiBicm93c2VycyB0aGF0IHJlbW92ZSB0aGUgZGVsYXkgc3RpbGwgZXhwZXJpZW5jZS4KICAgKgogICAqIEluIHNvbWUgY2FzZXMsIHRoaXJkLXBhcnR5IGxpYnJhcmllcyBtYXkgYWxzbyBiZSB3b3JraW5nIHdpdGggdG91Y2ggZXZlbnRzIHdoaWNoIGNhbiBpbnRlcmZlcmUKICAgKiB3aXRoIHRoZSB0YXAgc3lzdGVtLiBGb3IgZXhhbXBsZSwgbWFwcGluZyBsaWJyYXJpZXMgbGlrZSBHb29nbGUgb3IgTGVhZmxldCBNYXBzIG9mdGVuIGltcGxlbWVudAogICAqIGEgdG91Y2ggZGV0ZWN0aW9uIHN5c3RlbSB3aGljaCBjb25mbGljdHMgd2l0aCBJb25pYydzIHRhcCBzeXN0ZW0uCiAgICoKICAgKiAjIyMgRGlzYWJsaW5nIHRoZSB0YXAgc3lzdGVtCiAgICoKICAgKiBUbyBkaXNhYmxlIHRoZSB0YXAgZm9yIGFuIGVsZW1lbnQgYW5kIGFsbCBvZiBpdHMgY2hpbGRyZW4gZWxlbWVudHMsCiAgICogYWRkIHRoZSBhdHRyaWJ1dGUgYGRhdGEtdGFwLWRpc2FibGVkPSJ0cnVlImAuCiAgICoKICAgKiBgYGBodG1sCiAgICogPGRpdiBkYXRhLXRhcC1kaXNhYmxlZD0idHJ1ZSI+CiAgICogICAgIDxkaXYgaWQ9Imdvb2dsZS1tYXAiPjwvZGl2PgogICAqIDwvZGl2PgogICAqIGBgYAogICAqCiAgICogIyMjIEFkZGl0aW9uYWwgTm90ZXM6CiAgICoKICAgKiAtIElvbmljIHRhcCAgd29ya3Mgd2l0aCBJb25pYydzIEphdmFTY3JpcHQgc2Nyb2xsaW5nCiAgICogLSBFbGVtZW50cyBjYW4gY29tZSBhbmQgZ28gZnJvbSB0aGUgRE9NIGFuZCBJb25pYyB0YXAgZG9lc24ndCBrZWVwIGFkZGluZyBhbmQgcmVtb3ZpbmcKICAgKiAgIGxpc3RlbmVycwogICAqIC0gTm8gInRhcCBkZWxheSIgYWZ0ZXIgdGhlIGZpcnN0ICJ0YXAiICh5b3UgY2FuIHRhcCBhcyBmYXN0IGFzIHlvdSB3YW50LCB0aGV5IGFsbCBjbGljaykKICAgKiAtIE1pbmltYWwgZXZlbnRzIGxpc3RlbmVycywgb25seSBiZWluZyBhZGRlZCB0byBkb2N1bWVudAogICAqIC0gQ29ycmVjdCBmb2N1cyBpbi9vdXQgb24gZWFjaCBpbnB1dCB0eXBlIChzZWxlY3QsIHRleHRlYXJlYSwgcmFuZ2UpIG9uIGVhY2ggcGxhdGZvcm0vZGV2aWNlCiAgICogLSBTaG93cyBhbmQgaGlkZXMgdmlydHVhbCBrZXlib2FyZCBjb3JyZWN0bHkgZm9yIGVhY2ggcGxhdGZvcm0vZGV2aWNlCiAgICogLSBXb3JrcyB3aXRoIGxhYmVscyBzdXJyb3VuZGluZyBpbnB1dHMKICAgKiAtIERvZXMgbm90IGZpcmUgb2ZmIGEgY2xpY2sgaWYgdGhlIHVzZXIgbW92ZXMgdGhlIHBvaW50ZXIgdG9vIGZhcgogICAqIC0gQWRkcyBhbmQgcmVtb3ZlcyBhbiAnYWN0aXZhdGVkJyBjc3MgY2xhc3MKICAgKiAtIE11bHRpcGxlIFt1bml0IHRlc3RzXShodHRwczovL2dpdGh1Yi5jb20vZHJpZnR5Y28vaW9uaWMvYmxvYi9tYXN0ZXIvdGVzdC91bml0L3V0aWxzL3RhcC51bml0LmpzKSBmb3IgZWFjaCBzY2VuYXJpbwogICAqCiAgICovCiAgLyoKCiAgIElPTklDIFRBUAogICAtLS0tLS0tLS0tLS0tLS0KICAgLSBCb3RoIHRvdWNoIGFuZCBtb3VzZSBldmVudHMgYXJlIGFkZGVkIHRvIHRoZSBkb2N1bWVudC5ib2R5IG9uIERPTSByZWFkeQogICAtIElmIGEgdG91Y2ggZXZlbnQgaGFwcGVucywgaXQgZG9lcyBub3QgdXNlIG1vdXNlIGV2ZW50IGxpc3RlbmVycwogICAtIE9uIHRvdWNoZW5kLCBpZiB0aGUgZGlzdGFuY2UgYmV0d2VlbiBzdGFydCBhbmQgZW5kIHdhcyBzbWFsbCwgdHJpZ2dlciBhIGNsaWNrCiAgIC0gSW4gdGhlIHRyaWdnZXJlZCBjbGljayBldmVudCwgYWRkIGEgJ2lzSW9uaWNUYXAnIHByb3BlcnR5CiAgIC0gVGhlIHRyaWdnZXJlZCBjbGljayByZWNlaXZlcyB0aGUgc2FtZSB4LHkgY29vcmRpbmF0ZXMgYXMgYXMgdGhlIGVuZCBldmVudAogICAtIE9uIGRvY3VtZW50LmJvZHkgY2xpY2sgbGlzdGVuZXIgKHdpdGggdXNlQ2FwdHVyZT10cnVlKSwgb25seSBhbGxvdyBjbGlja3Mgd2l0aCAnaXNJb25pY1RhcCcKICAgLSBUcmlnZ2VyaW5nIGNsaWNrcyB3aXRoIG1vdXNlIGV2ZW50cyB3b3JrIHRoZSBzYW1lIGFzIHRvdWNoLCBleGNlcHQgd2l0aCBtb3VzZWRvd24vbW91c2V1cAogICAtIFRhcHBpbmcgaW5wdXRzIGlzIGRpc2FibGVkIGR1cmluZyBzY3JvbGxpbmcKICAgKi8KCiAgdmFyIHRhcERvYzsgLy8gdGhlIGVsZW1lbnQgd2hpY2ggdGhlIGxpc3RlbmVycyBhcmUgb24gKGRvY3VtZW50LmJvZHkpCiAgdmFyIHRhcEFjdGl2ZUVsZTsgLy8gdGhlIGVsZW1lbnQgd2hpY2ggaXMgYWN0aXZlIChwcm9iYWJseSBoYXMgZm9jdXMpCiAgdmFyIHRhcEVuYWJsZWRUb3VjaEV2ZW50czsKICB2YXIgdGFwTW91c2VSZXNldFRpbWVyOwogIHZhciB0YXBQb2ludGVyTW92ZWQ7CiAgdmFyIHRhcFBvaW50ZXJTdGFydDsKICB2YXIgdGFwVG91Y2hGb2N1c2VkSW5wdXQ7CiAgdmFyIHRhcExhc3RUb3VjaFRhcmdldDsKICB2YXIgdGFwVG91Y2hNb3ZlTGlzdGVuZXIgPSAndG91Y2htb3ZlJzsKCi8vIGhvdyBtdWNoIHRoZSBjb29yZGluYXRlcyBjYW4gYmUgb2ZmIGJldHdlZW4gc3RhcnQvZW5kLCBidXQgc3RpbGwgYSBjbGljawogIHZhciBUQVBfUkVMRUFTRV9UT0xFUkFOQ0UgPSA2OyAvLyBkZWZhdWx0IHRvbGVyYW5jZQogIHZhciBUQVBfUkVMRUFTRV9CVVRUT05fVE9MRVJBTkNFID0gNTA7IC8vIGJ1dHRvbiBlbGVtZW50cyBzaG91bGQgaGF2ZSBhIGxhcmdlciB0b2xlcmFuY2UKCiAgdmFyIHRhcEV2ZW50TGlzdGVuZXJzID0gewogICAgJ2NsaWNrJzogdGFwQ2xpY2tHYXRlS2VlcGVyLAoKICAgICdtb3VzZWRvd24nOiB0YXBNb3VzZURvd24sCiAgICAnbW91c2V1cCc6IHRhcE1vdXNlVXAsCiAgICAnbW91c2Vtb3ZlJzogdGFwTW91c2VNb3ZlLAoKICAgICd0b3VjaHN0YXJ0JzogdGFwVG91Y2hTdGFydCwKICAgICd0b3VjaGVuZCc6IHRhcFRvdWNoRW5kLAogICAgJ3RvdWNoY2FuY2VsJzogdGFwVG91Y2hDYW5jZWwsCiAgICAndG91Y2htb3ZlJzogdGFwVG91Y2hNb3ZlLAoKICAgICdwb2ludGVyZG93bic6IHRhcFRvdWNoU3RhcnQsCiAgICAncG9pbnRlcnVwJzogdGFwVG91Y2hFbmQsCiAgICAncG9pbnRlcmNhbmNlbCc6IHRhcFRvdWNoQ2FuY2VsLAogICAgJ3BvaW50ZXJtb3ZlJzogdGFwVG91Y2hNb3ZlLAoKICAgICdNU1BvaW50ZXJEb3duJzogdGFwVG91Y2hTdGFydCwKICAgICdNU1BvaW50ZXJVcCc6IHRhcFRvdWNoRW5kLAogICAgJ01TUG9pbnRlckNhbmNlbCc6IHRhcFRvdWNoQ2FuY2VsLAogICAgJ01TUG9pbnRlck1vdmUnOiB0YXBUb3VjaE1vdmUsCgogICAgJ2ZvY3VzaW4nOiB0YXBGb2N1c0luLAogICAgJ2ZvY3Vzb3V0JzogdGFwRm9jdXNPdXQKICB9OwoKICBpb25pYy50YXAgPSB7CgogICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGVsZSkgewogICAgICB0YXBEb2MgPSBlbGU7CgogICAgICB0YXBFdmVudExpc3RlbmVyKCdjbGljaycsIHRydWUsIHRydWUpOwogICAgICB0YXBFdmVudExpc3RlbmVyKCdtb3VzZXVwJyk7CiAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicpOwoKICAgICAgaWYoIHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQgKSB7CiAgICAgICAgdGFwRXZlbnRMaXN0ZW5lcigncG9pbnRlcmRvd24nKTsKICAgICAgICB0YXBFdmVudExpc3RlbmVyKCdwb2ludGVydXAnKTsKICAgICAgICB0YXBFdmVudExpc3RlbmVyKCdwb2ludGNhbmNlbCcpOwogICAgICAgIHRhcFRvdWNoTW92ZUxpc3RlbmVyID0gJ3BvaW50ZXJtb3ZlJzsKCiAgICAgIH0gZWxzZSBpZiAod2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkKSB7CiAgICAgICAgdGFwRXZlbnRMaXN0ZW5lcignTVNQb2ludGVyRG93bicpOwogICAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ01TUG9pbnRlclVwJyk7CiAgICAgICAgdGFwRXZlbnRMaXN0ZW5lcignTVNQb2ludGVyQ2FuY2VsJyk7CiAgICAgICAgdGFwVG91Y2hNb3ZlTGlzdGVuZXIgPSAnTVNQb2ludGVyTW92ZSc7CgogICAgICB9IGVsc2UgewogICAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnKTsKICAgICAgICB0YXBFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcpOwogICAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJyk7CiAgICAgIH0KCiAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ2ZvY3VzaW4nKTsKICAgICAgdGFwRXZlbnRMaXN0ZW5lcignZm9jdXNvdXQnKTsKCiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IodmFyIHR5cGUgaW4gdGFwRXZlbnRMaXN0ZW5lcnMpIHsKICAgICAgICAgIHRhcEV2ZW50TGlzdGVuZXIodHlwZSwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICB0YXBEb2MgPSBudWxsOwogICAgICAgIHRhcEFjdGl2ZUVsZSA9IG51bGw7CiAgICAgICAgdGFwRW5hYmxlZFRvdWNoRXZlbnRzID0gZmFsc2U7CiAgICAgICAgdGFwUG9pbnRlck1vdmVkID0gZmFsc2U7CiAgICAgICAgdGFwUG9pbnRlclN0YXJ0ID0gbnVsbDsKICAgICAgfTsKICAgIH0sCgogICAgaWdub3JlU2Nyb2xsU3RhcnQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgcmV0dXJuIChlLmRlZmF1bHRQcmV2ZW50ZWQpIHx8ICAvLyBkZWZhdWx0UHJldmVudGVkIGhhcyBiZWVuIGFzc2lnbmVkIGJ5IGFub3RoZXIgY29tcG9uZW50IGhhbmRsaW5nIHRoZSBldmVudAogICAgICAgIChlLnRhcmdldC5pc0NvbnRlbnRFZGl0YWJsZSkgfHwKICAgICAgICAoL14oZmlsZXxyYW5nZSkkL2kpLnRlc3QoZS50YXJnZXQudHlwZSkgfHwKICAgICAgICAoZS50YXJnZXQuZGF0YXNldCA/IGUudGFyZ2V0LmRhdGFzZXQucHJldmVudFNjcm9sbCA6IGUudGFyZ2V0LmdldEF0dHJpYnV0ZSgnZGF0YS1wcmV2ZW50LWRlZmF1bHQnKSkgPT0gJ3RydWUnIHx8IC8vIG1hbnVhbGx5IHNldCB3aXRoaW4gYW4gZWxlbWVudHMgYXR0cmlidXRlcwogICAgICAgICghISgvXihvYmplY3R8ZW1iZWQpJC9pKS50ZXN0KGUudGFyZ2V0LnRhZ05hbWUpKSB8fCAgLy8gZmxhc2gvbW92aWUvb2JqZWN0IHRvdWNoZXMgc2hvdWxkIG5vdCB0cnkgdG8gc2Nyb2xsCiAgICAgICAgaW9uaWMudGFwLmlzRWxlbWVudFRhcERpc2FibGVkKGUudGFyZ2V0KTsgLy8gY2hlY2sgaWYgdGhpcyBlbGVtZW50LCBvciBhbiBhbmNlc3RvciwgaGFzIGBkYXRhLXRhcC1kaXNhYmxlZGAgYXR0cmlidXRlCiAgICB9LAoKICAgIGlzVGV4dElucHV0OiBmdW5jdGlvbihlbGUpIHsKICAgICAgcmV0dXJuICEhZWxlICYmCiAgICAgICAgKGVsZS50YWdOYW1lID09ICdURVhUQVJFQScgfHwKICAgICAgICAgIGVsZS5jb250ZW50RWRpdGFibGUgPT09ICd0cnVlJyB8fAogICAgICAgICAgKGVsZS50YWdOYW1lID09ICdJTlBVVCcgJiYgISgvXihyYWRpb3xjaGVja2JveHxyYW5nZXxmaWxlfHN1Ym1pdHxyZXNldCkkL2kpLnRlc3QoZWxlLnR5cGUpKSApOwogICAgfSwKCiAgICBpc0RhdGVJbnB1dDogZnVuY3Rpb24oZWxlKSB7CiAgICAgIHJldHVybiAhIWVsZSAmJgogICAgICAgIChlbGUudGFnTmFtZSA9PSAnSU5QVVQnICYmICgvXihkYXRlfHRpbWV8ZGF0ZXRpbWUtbG9jYWx8bW9udGh8d2VlaykkL2kpLnRlc3QoZWxlLnR5cGUpKTsKICAgIH0sCgogICAgaXNMYWJlbFdpdGhUZXh0SW5wdXQ6IGZ1bmN0aW9uKGVsZSkgewogICAgICB2YXIgY29udGFpbmVyID0gdGFwQ29udGFpbmluZ0VsZW1lbnQoZWxlLCBmYWxzZSk7CgogICAgICByZXR1cm4gISFjb250YWluZXIgJiYKICAgICAgICBpb25pYy50YXAuaXNUZXh0SW5wdXQoIHRhcFRhcmdldEVsZW1lbnQoIGNvbnRhaW5lciApICk7CiAgICB9LAoKICAgIGNvbnRhaW5zT3JJc1RleHRJbnB1dDogZnVuY3Rpb24oZWxlKSB7CiAgICAgIHJldHVybiBpb25pYy50YXAuaXNUZXh0SW5wdXQoZWxlKSB8fCBpb25pYy50YXAuaXNMYWJlbFdpdGhUZXh0SW5wdXQoZWxlKTsKICAgIH0sCgogICAgY2xvbmVGb2N1c2VkSW5wdXQ6IGZ1bmN0aW9uKGNvbnRhaW5lciwgc2Nyb2xsSW50YW5jZSkgewogICAgICBpZihpb25pYy50YXAuaGFzQ2hlY2tlZENsb25lKSByZXR1cm47CiAgICAgIGlvbmljLnRhcC5oYXNDaGVja2VkQ2xvbmUgPSB0cnVlOwoKICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGZvY3VzSW5wdXQgPSBjb250YWluZXIucXVlcnlTZWxlY3RvcignOmZvY3VzJyk7CiAgICAgICAgaWYoIGlvbmljLnRhcC5pc1RleHRJbnB1dChmb2N1c0lucHV0KSApIHsKICAgICAgICAgIHZhciBjbG9uZWRJbnB1dCA9IGZvY3VzSW5wdXQucGFyZW50RWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuY2xvbmVkLXRleHQtaW5wdXQnKTsKICAgICAgICAgIGlmKCFjbG9uZWRJbnB1dCkgewogICAgICAgICAgICBjbG9uZWRJbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoZm9jdXNJbnB1dC50YWdOYW1lKTsKICAgICAgICAgICAgY2xvbmVkSW5wdXQucGxhY2Vob2xkZXIgPSBmb2N1c0lucHV0LnBsYWNlaG9sZGVyOwogICAgICAgICAgICBjbG9uZWRJbnB1dC50eXBlID0gZm9jdXNJbnB1dC50eXBlOwogICAgICAgICAgICBjbG9uZWRJbnB1dC52YWx1ZSA9IGZvY3VzSW5wdXQudmFsdWU7CiAgICAgICAgICAgIGNsb25lZElucHV0LnN0eWxlID0gZm9jdXNJbnB1dC5zdHlsZTsKICAgICAgICAgICAgY2xvbmVkSW5wdXQuY2xhc3NOYW1lID0gZm9jdXNJbnB1dC5jbGFzc05hbWU7CiAgICAgICAgICAgIGNsb25lZElucHV0LmNsYXNzTGlzdC5hZGQoJ2Nsb25lZC10ZXh0LWlucHV0Jyk7CiAgICAgICAgICAgIGNsb25lZElucHV0LnJlYWRPbmx5ID0gdHJ1ZTsKICAgICAgICAgICAgZm9jdXNJbnB1dC5wYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShjbG9uZWRJbnB1dCwgZm9jdXNJbnB1dCk7CiAgICAgICAgICAgIGZvY3VzSW5wdXQuc3R5bGUudG9wID0gZm9jdXNJbnB1dC5vZmZzZXRUb3A7CiAgICAgICAgICAgIGZvY3VzSW5wdXQuY2xhc3NMaXN0LmFkZCgncHJldmlvdXMtaW5wdXQtZm9jdXMnKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICBoYXNDaGVja2VkQ2xvbmU6IGZhbHNlLAoKICAgIHJlbW92ZUNsb25lZElucHV0czogZnVuY3Rpb24oY29udGFpbmVyLCBzY3JvbGxJbnRhbmNlKSB7CiAgICAgIGlvbmljLnRhcC5oYXNDaGVja2VkQ2xvbmUgPSBmYWxzZTsKCiAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpewogICAgICAgIHZhciBjbG9uZWRJbnB1dHMgPSBjb250YWluZXIucXVlcnlTZWxlY3RvckFsbCgnLmNsb25lZC10ZXh0LWlucHV0Jyk7CiAgICAgICAgdmFyIHByZXZpb3VzSW5wdXRGb2N1cyA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yQWxsKCcucHJldmlvdXMtaW5wdXQtZm9jdXMnKTsKICAgICAgICB2YXIgeDsKCiAgICAgICAgZm9yKHg9MDsgeDxjbG9uZWRJbnB1dHMubGVuZ3RoOyB4KyspIHsKICAgICAgICAgIGNsb25lZElucHV0c1t4XS5wYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKCBjbG9uZWRJbnB1dHNbeF0gKTsKICAgICAgICB9CgogICAgICAgIGZvcih4PTA7IHg8cHJldmlvdXNJbnB1dEZvY3VzLmxlbmd0aDsgeCsrKSB7CiAgICAgICAgICBwcmV2aW91c0lucHV0Rm9jdXNbeF0uY2xhc3NMaXN0LnJlbW92ZSgncHJldmlvdXMtaW5wdXQtZm9jdXMnKTsKICAgICAgICAgIHByZXZpb3VzSW5wdXRGb2N1c1t4XS5zdHlsZS50b3AgPSAnJzsKICAgICAgICAgIHByZXZpb3VzSW5wdXRGb2N1c1t4XS5mb2N1cygpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIHJlcXVpcmVzTmF0aXZlQ2xpY2s6IGZ1bmN0aW9uKGVsZSkgewogICAgICBpZighZWxlIHx8IGVsZS5kaXNhYmxlZCB8fCAoL14oZmlsZXxyYW5nZSkkL2kpLnRlc3QoZWxlLnR5cGUpIHx8ICgvXihvYmplY3R8dmlkZW8pJC9pKS50ZXN0KGVsZS50YWdOYW1lKSB8fCBpb25pYy50YXAuaXNMYWJlbENvbnRhaW5pbmdGaWxlSW5wdXQoZWxlKSApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gaW9uaWMudGFwLmlzRWxlbWVudFRhcERpc2FibGVkKGVsZSk7CiAgICB9LAoKICAgIGlzTGFiZWxDb250YWluaW5nRmlsZUlucHV0OiBmdW5jdGlvbihlbGUpIHsKICAgICAgdmFyIGxibCA9IHRhcENvbnRhaW5pbmdFbGVtZW50KGVsZSk7CiAgICAgIGlmKGxibC50YWdOYW1lICE9PSAnTEFCRUwnKSByZXR1cm4gZmFsc2U7CiAgICAgIHZhciBmaWxlSW5wdXQgPSBsYmwucXVlcnlTZWxlY3RvcignaW5wdXRbdHlwZT1maWxlXScpOwogICAgICBpZihmaWxlSW5wdXQgJiYgZmlsZUlucHV0LmRpc2FibGVkID09PSBmYWxzZSkgcmV0dXJuIHRydWU7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgaXNFbGVtZW50VGFwRGlzYWJsZWQ6IGZ1bmN0aW9uKGVsZSkgewogICAgICBpZihlbGUgJiYgZWxlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBlbGU7CiAgICAgICAgd2hpbGUoZWxlbWVudCkgewogICAgICAgICAgaWYoIChlbGVtZW50LmRhdGFzZXQgPyBlbGVtZW50LmRhdGFzZXQudGFwRGlzYWJsZWQgOiBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS10YXAtZGlzYWJsZWQnKSkgPT0gJ3RydWUnICkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudEVsZW1lbnQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgc2V0VG9sZXJhbmNlOiBmdW5jdGlvbihyZWxlYXNlVG9sZXJhbmNlLCByZWxlYXNlQnV0dG9uVG9sZXJhbmNlKSB7CiAgICAgIFRBUF9SRUxFQVNFX1RPTEVSQU5DRSA9IHJlbGVhc2VUb2xlcmFuY2U7CiAgICAgIFRBUF9SRUxFQVNFX0JVVFRPTl9UT0xFUkFOQ0UgPSByZWxlYXNlQnV0dG9uVG9sZXJhbmNlOwogICAgfSwKCiAgICBjYW5jZWxDbGljazogZnVuY3Rpb24oKSB7CiAgICAgIC8vIHVzZWQgdG8gY2FuY2VsIGFueSBzaW11bGF0ZWQgY2xpY2tzIHdoaWNoIG1heSBoYXBwZW4gb24gYSB0b3VjaGVuZC9tb3VzZXVwCiAgICAgIC8vIGdlc3R1cmVzIHVzZXMgdGhpcyBtZXRob2Qgd2l0aGluIGl0cyB0YXAgYW5kIGhvbGQgZXZlbnRzCiAgICAgIHRhcFBvaW50ZXJNb3ZlZCA9IHRydWU7CiAgICB9CgogIH07CgogIGZ1bmN0aW9uIHRhcEV2ZW50TGlzdGVuZXIodHlwZSwgZW5hYmxlLCB1c2VDYXB0dXJlKSB7CiAgICBpZihlbmFibGUgIT09IGZhbHNlKSB7CiAgICAgIHRhcERvYy5hZGRFdmVudExpc3RlbmVyKHR5cGUsIHRhcEV2ZW50TGlzdGVuZXJzW3R5cGVdLCB1c2VDYXB0dXJlKTsKICAgIH0gZWxzZSB7CiAgICAgIHRhcERvYy5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIHRhcEV2ZW50TGlzdGVuZXJzW3R5cGVdKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHRhcENsaWNrKGUpIHsKICAgIC8vIHNpbXVsYXRlIGEgbm9ybWFsIGNsaWNrIGJ5IHJ1bm5pbmcgdGhlIGVsZW1lbnQncyBjbGljayBtZXRob2QgdGhlbiBmb2N1cyBvbiBpdAogICAgdmFyIGNvbnRhaW5lciA9IHRhcENvbnRhaW5pbmdFbGVtZW50KGUudGFyZ2V0KTsKICAgIHZhciBlbGUgPSB0YXBUYXJnZXRFbGVtZW50KGNvbnRhaW5lcik7CgogICAgaWYoIGlvbmljLnRhcC5yZXF1aXJlc05hdGl2ZUNsaWNrKGVsZSkgfHwgdGFwUG9pbnRlck1vdmVkICkgcmV0dXJuIGZhbHNlOwoKICAgIHZhciBjID0gZ2V0UG9pbnRlckNvb3JkaW5hdGVzKGUpOwoKICAgIHZvaWQgMDsKICAgIHRyaWdnZXJNb3VzZUV2ZW50KCdjbGljaycsIGVsZSwgYy54LCBjLnkpOwoKICAgIC8vIGlmIGl0J3MgYW4gaW5wdXQsIGZvY3VzIGluIG9uIHRoZSB0YXJnZXQsIG90aGVyd2lzZSBibHVyCiAgICB0YXBIYW5kbGVGb2N1cyhlbGUpOwogIH0KCiAgZnVuY3Rpb24gdHJpZ2dlck1vdXNlRXZlbnQodHlwZSwgZWxlLCB4LCB5KSB7CiAgICAvLyB1c2luZyBpbml0TW91c2VFdmVudCBpbnN0ZWFkIG9mIE1vdXNlRXZlbnQgZm9yIG91ciBBbmRyb2lkIGZyaWVuZHMKICAgIHZhciBjbGlja0V2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7CiAgICBjbGlja0V2ZW50LmluaXRNb3VzZUV2ZW50KHR5cGUsIHRydWUsIHRydWUsIHdpbmRvdywgMSwgMCwgMCwgeCwgeSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDAsIG51bGwpOwogICAgY2xpY2tFdmVudC5pc0lvbmljVGFwID0gdHJ1ZTsKICAgIGVsZS5kaXNwYXRjaEV2ZW50KGNsaWNrRXZlbnQpOwogIH0KCiAgZnVuY3Rpb24gdGFwQ2xpY2tHYXRlS2VlcGVyKGUpIHsKICAgIGlmKGUudGFyZ2V0LnR5cGUgPT0gJ3N1Ym1pdCcgJiYgZS5kZXRhaWwgPT09IDApIHsKICAgICAgLy8gZG8gbm90IHByZXZlbnQgY2xpY2sgaWYgaXQgY2FtZSBmcm9tIGFuICJFbnRlciIgb3IgIkdvIiBrZXlwcmVzcyBzdWJtaXQKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIGRvIG5vdCBhbGxvdyB0aHJvdWdoIGFueSBjbGljayBldmVudHMgdGhhdCB3ZXJlIG5vdCBjcmVhdGVkIGJ5IGlvbmljLnRhcAogICAgaWYoIChpb25pYy5zY3JvbGwuaXNTY3JvbGxpbmcgJiYgaW9uaWMudGFwLmNvbnRhaW5zT3JJc1RleHRJbnB1dChlLnRhcmdldCkgKSB8fAogICAgICAoIWUuaXNJb25pY1RhcCAmJiAhaW9uaWMudGFwLnJlcXVpcmVzTmF0aXZlQ2xpY2soZS50YXJnZXQpKSApIHsKICAgICAgdm9pZCAwOwogICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwoKICAgICAgaWYoICFpb25pYy50YXAuaXNMYWJlbFdpdGhUZXh0SW5wdXQoZS50YXJnZXQpICkgewogICAgICAgIC8vIGxhYmVscyBjbGlja3MgZnJvbSBuYXRpdmUgc2hvdWxkIG5vdCBwcmV2ZW50RGVmYXVsdCBvdGhlcnNpemUga2V5Ym9hcmQgd2lsbCBub3Qgc2hvdyBvbiBpbnB1dCBmb2N1cwogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKLy8gTU9VU0UKICBmdW5jdGlvbiB0YXBNb3VzZURvd24oZSkgewogICAgaWYoZS5pc0lvbmljVGFwIHx8IHRhcElnbm9yZUV2ZW50KGUpKSByZXR1cm47CgogICAgaWYodGFwRW5hYmxlZFRvdWNoRXZlbnRzKSB7CiAgICAgIHZvaWQgMDsKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICAgIGlmKCAoIWlvbmljLnRhcC5pc1RleHRJbnB1dChlLnRhcmdldCkgfHwgdGFwTGFzdFRvdWNoVGFyZ2V0ICE9PSBlLnRhcmdldCkgJiYgISgvXihzZWxlY3R8b3B0aW9uKSQvaSkudGVzdChlLnRhcmdldC50YWdOYW1lKSApIHsKICAgICAgICAvLyBJZiB5b3UgcHJldmVudERlZmF1bHQgb24gYSB0ZXh0IGlucHV0IHRoZW4geW91IGNhbm5vdCBtb3ZlIGl0cyB0ZXh0IGNhcmV0L2N1cnNvci4KICAgICAgICAvLyBBbGxvdyB0aHJvdWdoIG9ubHkgdGhlIHRleHQgaW5wdXQgZGVmYXVsdC4gSG93ZXZlciwgd2l0aG91dCBwcmV2ZW50RGVmYXVsdCBvbiBhbgogICAgICAgIC8vIGlucHV0IHRoZSAzMDBtcyBkZWxheSBjYW4gY2hhbmdlIGZvY3VzIG9uIGlucHV0cyBhZnRlciB0aGUga2V5Ym9hcmQgc2hvd3MgdXAuCiAgICAgICAgLy8gVGhlIGZvY3VzaW4gZXZlbnQgaGFuZGxlcyB0aGUgY2hhbmNlIG9mIGZvY3VzIGNoYW5naW5nIGFmdGVyIHRoZSBrZXlib2FyZCBzaG93cy4KICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICB0YXBQb2ludGVyTW92ZWQgPSBmYWxzZTsKICAgIHRhcFBvaW50ZXJTdGFydCA9IGdldFBvaW50ZXJDb29yZGluYXRlcyhlKTsKCiAgICB0YXBFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnKTsKICAgIGlvbmljLmFjdGl2YXRvci5zdGFydChlKTsKICB9CgogIGZ1bmN0aW9uIHRhcE1vdXNlVXAoZSkgewogICAgaWYodGFwRW5hYmxlZFRvdWNoRXZlbnRzKSB7CiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmKCB0YXBJZ25vcmVFdmVudChlKSB8fCAoL14oc2VsZWN0fG9wdGlvbikkL2kpLnRlc3QoZS50YXJnZXQudGFnTmFtZSkgKSByZXR1cm4gZmFsc2U7CgogICAgaWYoICF0YXBIYXNQb2ludGVyTW92ZWQoZSkgKSB7CiAgICAgIHRhcENsaWNrKGUpOwogICAgfQogICAgdGFwRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgZmFsc2UpOwogICAgaW9uaWMuYWN0aXZhdG9yLmVuZCgpOwogICAgdGFwUG9pbnRlck1vdmVkID0gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiB0YXBNb3VzZU1vdmUoZSkgewogICAgaWYoIHRhcEhhc1BvaW50ZXJNb3ZlZChlKSApIHsKICAgICAgdGFwRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgZmFsc2UpOwogICAgICBpb25pYy5hY3RpdmF0b3IuZW5kKCk7CiAgICAgIHRhcFBvaW50ZXJNb3ZlZCA9IHRydWU7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CgoKLy8gVE9VQ0gKICBmdW5jdGlvbiB0YXBUb3VjaFN0YXJ0KGUpIHsKICAgIGlmKCB0YXBJZ25vcmVFdmVudChlKSApIHJldHVybjsKCiAgICB0YXBQb2ludGVyTW92ZWQgPSBmYWxzZTsKCiAgICB0YXBFbmFibGVUb3VjaEV2ZW50cygpOwogICAgdGFwUG9pbnRlclN0YXJ0ID0gZ2V0UG9pbnRlckNvb3JkaW5hdGVzKGUpOwoKICAgIHRhcEV2ZW50TGlzdGVuZXIodGFwVG91Y2hNb3ZlTGlzdGVuZXIpOwogICAgaW9uaWMuYWN0aXZhdG9yLnN0YXJ0KGUpOwoKICAgIGlmKCBpb25pYy5QbGF0Zm9ybS5pc0lPUygpICYmIGlvbmljLnRhcC5pc0xhYmVsV2l0aFRleHRJbnB1dChlLnRhcmdldCkgKSB7CiAgICAgIC8vIGlmIHRoZSB0YXBwZWQgZWxlbWVudCBpcyBhIGxhYmVsLCB3aGljaCBoYXMgYSBjaGlsZCBpbnB1dAogICAgICAvLyB0aGVuIHByZXZlbnREZWZhdWx0IHNvIGlPUyBkb2Vzbid0IHVnbHkgYXV0byBzY3JvbGwgdG8gdGhlIGlucHV0CiAgICAgIC8vIGJ1dCBkbyBub3QgcHJldmVudCBkZWZhdWx0IG9uIEFuZHJvaWQgb3IgZWxzZSB5b3UgY2Fubm90IG1vdmUgdGhlIHRleHQgY2FyZXQKICAgICAgLy8gYW5kIGRvIG5vdCBwcmV2ZW50IGRlZmF1bHQgb24gQW5kcm9pZCBvciBlbHNlIG5vIHZpcnR1YWwga2V5Ym9hcmQgc2hvd3MgdXAKCiAgICAgIHZhciB0ZXh0SW5wdXQgPSB0YXBUYXJnZXRFbGVtZW50KCB0YXBDb250YWluaW5nRWxlbWVudChlLnRhcmdldCkgKTsKICAgICAgaWYoIHRleHRJbnB1dCAhPT0gdGFwQWN0aXZlRWxlICkgewogICAgICAgIC8vIGRvbid0IHByZXZlbnREZWZhdWx0IG9uIGFuIGFscmVhZHkgZm9jdXNlZCBpbnB1dCBvciBlbHNlIGlPUydzIHRleHQgY2FyZXQgaXNuJ3QgdXNhYmxlCiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0YXBUb3VjaEVuZChlKSB7CiAgICBpZiggdGFwSWdub3JlRXZlbnQoZSkgKSByZXR1cm47CgogICAgdGFwRW5hYmxlVG91Y2hFdmVudHMoKTsKICAgIGlmKCAhdGFwSGFzUG9pbnRlck1vdmVkKGUpICkgewogICAgICB0YXBDbGljayhlKTsKCiAgICAgIGlmKCAoL14oc2VsZWN0fG9wdGlvbikkL2kpLnRlc3QoZS50YXJnZXQudGFnTmFtZSkgKSB7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICB9CgogICAgdGFwTGFzdFRvdWNoVGFyZ2V0ID0gZS50YXJnZXQ7CiAgICB0YXBUb3VjaENhbmNlbCgpOwogIH0KCiAgZnVuY3Rpb24gdGFwVG91Y2hNb3ZlKGUpIHsKICAgIGlmKCB0YXBIYXNQb2ludGVyTW92ZWQoZSkgKSB7CiAgICAgIHRhcFBvaW50ZXJNb3ZlZCA9IHRydWU7CiAgICAgIHRhcEV2ZW50TGlzdGVuZXIodGFwVG91Y2hNb3ZlTGlzdGVuZXIsIGZhbHNlKTsKICAgICAgaW9uaWMuYWN0aXZhdG9yLmVuZCgpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0YXBUb3VjaENhbmNlbChlKSB7CiAgICB0YXBFdmVudExpc3RlbmVyKHRhcFRvdWNoTW92ZUxpc3RlbmVyLCBmYWxzZSk7CiAgICBpb25pYy5hY3RpdmF0b3IuZW5kKCk7CiAgICB0YXBQb2ludGVyTW92ZWQgPSBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIHRhcEVuYWJsZVRvdWNoRXZlbnRzKCkgewogICAgdGFwRW5hYmxlZFRvdWNoRXZlbnRzID0gdHJ1ZTsKICAgIGNsZWFyVGltZW91dCh0YXBNb3VzZVJlc2V0VGltZXIpOwogICAgdGFwTW91c2VSZXNldFRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICB0YXBFbmFibGVkVG91Y2hFdmVudHMgPSBmYWxzZTsKICAgIH0sIDIwMDApOwogIH0KCiAgZnVuY3Rpb24gdGFwSWdub3JlRXZlbnQoZSkgewogICAgaWYoZS5pc1RhcEhhbmRsZWQpIHJldHVybiB0cnVlOwogICAgZS5pc1RhcEhhbmRsZWQgPSB0cnVlOwoKICAgIGlmKCBpb25pYy5zY3JvbGwuaXNTY3JvbGxpbmcgJiYgaW9uaWMudGFwLmNvbnRhaW5zT3JJc1RleHRJbnB1dChlLnRhcmdldCkgKSB7CiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0YXBIYW5kbGVGb2N1cyhlbGUpIHsKICAgIHRhcFRvdWNoRm9jdXNlZElucHV0ID0gbnVsbDsKCiAgICB2YXIgdHJpZ2dlckZvY3VzSW4gPSBmYWxzZTsKCiAgICBpZihlbGUudGFnTmFtZSA9PSAnU0VMRUNUJykgewogICAgICAvLyB0cmljayB0byBmb3JjZSBBbmRyb2lkIG9wdGlvbnMgdG8gc2hvdyB1cAogICAgICB0cmlnZ2VyTW91c2VFdmVudCgnbW91c2Vkb3duJywgZWxlLCAwLCAwKTsKICAgICAgZWxlLmZvY3VzICYmIGVsZS5mb2N1cygpOwogICAgICB0cmlnZ2VyRm9jdXNJbiA9IHRydWU7CgogICAgfSBlbHNlIGlmKHRhcEFjdGl2ZUVsZW1lbnQoKSA9PT0gZWxlKSB7CiAgICAgIC8vIGFscmVhZHkgaXMgdGhlIGFjdGl2ZSBlbGVtZW50IGFuZCBoYXMgZm9jdXMKICAgICAgdHJpZ2dlckZvY3VzSW4gPSB0cnVlOwoKICAgIH0gZWxzZSBpZiggKC9eKGlucHV0fHRleHRhcmVhKSQvaSkudGVzdChlbGUudGFnTmFtZSkgKSB7CiAgICAgIHRyaWdnZXJGb2N1c0luID0gdHJ1ZTsKICAgICAgZWxlLmZvY3VzICYmIGVsZS5mb2N1cygpOwogICAgICBlbGUudmFsdWUgPSBlbGUudmFsdWU7CiAgICAgIGlmKCB0YXBFbmFibGVkVG91Y2hFdmVudHMgKSB7CiAgICAgICAgdGFwVG91Y2hGb2N1c2VkSW5wdXQgPSBlbGU7CiAgICAgIH0KCiAgICB9IGVsc2UgewogICAgICB0YXBGb2N1c091dEFjdGl2ZSgpOwogICAgfQoKICAgIGlmKHRyaWdnZXJGb2N1c0luKSB7CiAgICAgIHRhcEFjdGl2ZUVsZW1lbnQoZWxlKTsKICAgICAgaW9uaWMudHJpZ2dlcignaW9uaWMuZm9jdXNpbicsIHsKICAgICAgICB0YXJnZXQ6IGVsZQogICAgICB9LCB0cnVlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHRhcEZvY3VzT3V0QWN0aXZlKCkgewogICAgdmFyIGVsZSA9IHRhcEFjdGl2ZUVsZW1lbnQoKTsKICAgIGlmKGVsZSAmJiAoL14oaW5wdXR8dGV4dGFyZWF8c2VsZWN0KSQvaSkudGVzdChlbGUudGFnTmFtZSkgKSB7CiAgICAgIHZvaWQgMDsKICAgICAgZWxlLmJsdXIoKTsKICAgIH0KICAgIHRhcEFjdGl2ZUVsZW1lbnQobnVsbCk7CiAgfQoKICBmdW5jdGlvbiB0YXBGb2N1c0luKGUpIHsKICAgIC8vIEJlY2F1c2UgYSB0ZXh0IGlucHV0IGRvZXNuJ3QgcHJldmVudERlZmF1bHQgKHNvIHRoZSBjYXJldCBzdGlsbCB3b3JrcykgdGhlcmUncyBhIGNoYW5jZQogICAgLy8gdGhhdCBpdCdzIG1vdXNlZG93biBldmVudCAzMDBtcyBsYXRlciB3aWxsIGNoYW5nZSB0aGUgZm9jdXMgdG8gYW5vdGhlciBlbGVtZW50IGFmdGVyCiAgICAvLyB0aGUga2V5Ym9hcmQgc2hvd3MgdXAuCgogICAgaWYoIHRhcEVuYWJsZWRUb3VjaEV2ZW50cyAmJgogICAgICBpb25pYy50YXAuaXNUZXh0SW5wdXQoIHRhcEFjdGl2ZUVsZW1lbnQoKSApICYmCiAgICAgIGlvbmljLnRhcC5pc1RleHRJbnB1dCh0YXBUb3VjaEZvY3VzZWRJbnB1dCkgJiYKICAgICAgdGFwVG91Y2hGb2N1c2VkSW5wdXQgIT09IGUudGFyZ2V0ICkgewoKICAgICAgLy8gMSkgVGhlIHBvaW50ZXIgaXMgZnJvbSB0b3VjaCBldmVudHMKICAgICAgLy8gMikgVGhlcmUgaXMgYW4gYWN0aXZlIGVsZW1lbnQgd2hpY2ggaXMgYSB0ZXh0IGlucHV0CiAgICAgIC8vIDMpIEEgdGV4dCBpbnB1dCB3YXMganVzdCBzZXQgdG8gYmUgZm9jdXNlZCBvbiBieSBhIHRvdWNoIGV2ZW50CiAgICAgIC8vIDQpIEEgbmV3IGZvY3VzIGhhcyBiZWVuIHNldCwgaG93ZXZlciB0aGUgdGFyZ2V0IGlzbid0IHRoZSBvbmUgdGhlIHRvdWNoIGV2ZW50IHdhbnRlZAogICAgICB2b2lkIDA7CiAgICAgIHRhcFRvdWNoRm9jdXNlZElucHV0LmZvY3VzKCk7CiAgICAgIHRhcFRvdWNoRm9jdXNlZElucHV0ID0gbnVsbDsKICAgIH0KICAgIGlvbmljLnNjcm9sbC5pc1Njcm9sbGluZyA9IGZhbHNlOwogIH0KCiAgZnVuY3Rpb24gdGFwRm9jdXNPdXQoKSB7CiAgICB0YXBBY3RpdmVFbGVtZW50KG51bGwpOwogIH0KCiAgZnVuY3Rpb24gdGFwQWN0aXZlRWxlbWVudChlbGUpIHsKICAgIGlmKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgdGFwQWN0aXZlRWxlID0gZWxlOwogICAgfQogICAgcmV0dXJuIHRhcEFjdGl2ZUVsZSB8fCBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwogIH0KCiAgZnVuY3Rpb24gdGFwSGFzUG9pbnRlck1vdmVkKGVuZEV2ZW50KSB7CiAgICBpZighZW5kRXZlbnQgfHwgZW5kRXZlbnQudGFyZ2V0Lm5vZGVUeXBlICE9PSAxIHx8ICF0YXBQb2ludGVyU3RhcnQgfHwgKCB0YXBQb2ludGVyU3RhcnQueCA9PT0gMCAmJiB0YXBQb2ludGVyU3RhcnQueSA9PT0gMCApKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHZhciBlbmRDb29yZGluYXRlcyA9IGdldFBvaW50ZXJDb29yZGluYXRlcyhlbmRFdmVudCk7CgogICAgdmFyIGhhc0NsYXNzTGlzdCA9ICEhKGVuZEV2ZW50LnRhcmdldC5jbGFzc0xpc3QgJiYgZW5kRXZlbnQudGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucyk7CiAgICB2YXIgcmVsZWFzZVRvbGVyYW5jZSA9IGhhc0NsYXNzTGlzdCAmIGVuZEV2ZW50LnRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoJ2J1dHRvbicpID8KICAgICAgVEFQX1JFTEVBU0VfQlVUVE9OX1RPTEVSQU5DRSA6CiAgICAgIFRBUF9SRUxFQVNFX1RPTEVSQU5DRTsKCiAgICByZXR1cm4gTWF0aC5hYnModGFwUG9pbnRlclN0YXJ0LnggLSBlbmRDb29yZGluYXRlcy54KSA+IHJlbGVhc2VUb2xlcmFuY2UgfHwKICAgICAgTWF0aC5hYnModGFwUG9pbnRlclN0YXJ0LnkgLSBlbmRDb29yZGluYXRlcy55KSA+IHJlbGVhc2VUb2xlcmFuY2U7CiAgfQoKICBmdW5jdGlvbiBnZXRQb2ludGVyQ29vcmRpbmF0ZXMoZXZlbnQpIHsKICAgIC8vIFRoaXMgbWV0aG9kIGNhbiBnZXQgY29vcmRpbmF0ZXMgZm9yIGJvdGggYSBtb3VzZSBjbGljawogICAgLy8gb3IgYSB0b3VjaCBkZXBlbmRpbmcgb24gdGhlIGdpdmVuIGV2ZW50CiAgICB2YXIgYyA9IHsgeDowLCB5OjAgfTsKICAgIGlmKGV2ZW50KSB7CiAgICAgIHZhciB0b3VjaGVzID0gZXZlbnQudG91Y2hlcyAmJiBldmVudC50b3VjaGVzLmxlbmd0aCA/IGV2ZW50LnRvdWNoZXMgOiBbZXZlbnRdOwogICAgICB2YXIgZSA9IChldmVudC5jaGFuZ2VkVG91Y2hlcyAmJiBldmVudC5jaGFuZ2VkVG91Y2hlc1swXSkgfHwgdG91Y2hlc1swXTsKICAgICAgaWYoZSkgewogICAgICAgIGMueCA9IGUuY2xpZW50WCB8fCBlLnBhZ2VYIHx8IDA7CiAgICAgICAgYy55ID0gZS5jbGllbnRZIHx8IGUucGFnZVkgfHwgMDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGM7CiAgfQoKICBmdW5jdGlvbiB0YXBDb250YWluaW5nRWxlbWVudChlbGUsIGFsbG93U2VsZikgewogICAgdmFyIGNsaW1iRWxlID0gZWxlOwogICAgZm9yKHZhciB4PTA7IHg8NjsgeCsrKSB7CiAgICAgIGlmKCFjbGltYkVsZSkgYnJlYWs7CiAgICAgIGlmKGNsaW1iRWxlLnRhZ05hbWUgPT09ICdMQUJFTCcpIHJldHVybiBjbGltYkVsZTsKICAgICAgY2xpbWJFbGUgPSBjbGltYkVsZS5wYXJlbnRFbGVtZW50OwogICAgfQogICAgaWYoYWxsb3dTZWxmICE9PSBmYWxzZSkgcmV0dXJuIGVsZTsKICB9CgogIGZ1bmN0aW9uIHRhcFRhcmdldEVsZW1lbnQoZWxlKSB7CiAgICBpZihlbGUgJiYgZWxlLnRhZ05hbWUgPT09ICdMQUJFTCcpIHsKICAgICAgaWYoZWxlLmNvbnRyb2wpIHJldHVybiBlbGUuY29udHJvbDsKCiAgICAgIC8vIG9sZGVyIGRldmljZXMgZG8gbm90IHN1cHBvcnQgdGhlICJjb250cm9sIiBwcm9wZXJ0eQogICAgICBpZihlbGUucXVlcnlTZWxlY3RvcikgewogICAgICAgIHZhciBjb250cm9sID0gZWxlLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0LHRleHRhcmVhLHNlbGVjdCcpOwogICAgICAgIGlmKGNvbnRyb2wpIHJldHVybiBjb250cm9sOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZWxlOwogIH0KCiAgaW9uaWMuRG9tVXRpbC5yZWFkeShmdW5jdGlvbigpewogICAgdmFyIG5nID0gdHlwZW9mIGFuZ3VsYXIgIT09ICd1bmRlZmluZWQnID8gYW5ndWxhciA6IG51bGw7CiAgICAvL2RvIG5vdGhpbmcgZm9yIGUyZSB0ZXN0cwogICAgaWYgKCFuZyB8fCAobmcgJiYgIW5nLnNjZW5hcmlvKSkgewogICAgICBpb25pYy50YXAucmVnaXN0ZXIoZG9jdW1lbnQpOwogICAgfQogIH0pOwoKICAoZnVuY3Rpb24oZG9jdW1lbnQsIGlvbmljKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgdmFyIHF1ZXVlRWxlbWVudHMgPSB7fTsgICAvLyBlbGVtZW50cyB0aGF0IHNob3VsZCBnZXQgYW4gYWN0aXZlIHN0YXRlIGluIFhYIG1pbGxpc2Vjb25kcwogICAgdmFyIGFjdGl2ZUVsZW1lbnRzID0ge307ICAvLyBlbGVtZW50cyB0aGF0IGFyZSBjdXJyZW50bHkgYWN0aXZlCiAgICB2YXIga2V5SWQgPSAwOyAgICAgICAgICAgIC8vIGEgY291bnRlciBmb3IgdW5pcXVlIGtleXMgZm9yIHRoZSBhYm92ZSBvamVjdHMKICAgIHZhciBBQ1RJVkFURURfQ0xBU1MgPSAnYWN0aXZhdGVkJzsKCiAgICBpb25pYy5hY3RpdmF0b3IgPSB7CgogICAgICBzdGFydDogZnVuY3Rpb24oZSkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgLy8gd2hlbiBhbiBlbGVtZW50IGlzIHRvdWNoZWQvY2xpY2tlZCwgaXQgY2xpbWJzIHVwIGEgZmV3CiAgICAgICAgLy8gcGFyZW50cyB0byBzZWUgaWYgaXQgaXMgYW4gLml0ZW0gb3IgLmJ1dHRvbiBlbGVtZW50CiAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgICBpZiAoIGlvbmljLnRhcC5yZXF1aXJlc05hdGl2ZUNsaWNrKGUudGFyZ2V0KSApIHJldHVybjsKICAgICAgICAgIHZhciBlbGUgPSBlLnRhcmdldDsKICAgICAgICAgIHZhciBlbGVUb0FjdGl2YXRlOwoKICAgICAgICAgIGZvcih2YXIgeD0wOyB4PDQ7IHgrKykgewogICAgICAgICAgICBpZighZWxlIHx8IGVsZS5ub2RlVHlwZSAhPT0gMSkgYnJlYWs7CiAgICAgICAgICAgIGlmKGVsZVRvQWN0aXZhdGUgJiYgZWxlLmNsYXNzTGlzdC5jb250YWlucygnaXRlbScpKSB7CiAgICAgICAgICAgICAgZWxlVG9BY3RpdmF0ZSA9IGVsZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiggZWxlLnRhZ05hbWUgPT0gJ0EnIHx8IGVsZS50YWdOYW1lID09ICdCVVRUT04nIHx8IGVsZS5oYXNBdHRyaWJ1dGUoJ25nLWNsaWNrJykgKSB7CiAgICAgICAgICAgICAgZWxlVG9BY3RpdmF0ZSA9IGVsZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiggZWxlLmNsYXNzTGlzdC5jb250YWlucygnYnV0dG9uJykgKSB7CiAgICAgICAgICAgICAgZWxlVG9BY3RpdmF0ZSA9IGVsZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGUgPSBlbGUucGFyZW50RWxlbWVudDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZihlbGVUb0FjdGl2YXRlKSB7CiAgICAgICAgICAgIC8vIHF1ZXVlIHRoYXQgdGhpcyBlbGVtZW50IHNob3VsZCBiZSBzZXQgdG8gYWN0aXZlCiAgICAgICAgICAgIHF1ZXVlRWxlbWVudHNba2V5SWRdID0gZWxlVG9BY3RpdmF0ZTsKCiAgICAgICAgICAgIC8vIGluIFhYIG1pbGxpc2Vjb25kcywgc2V0IHRoZSBxdWV1ZWQgZWxlbWVudHMgdG8gYWN0aXZlCiAgICAgICAgICAgIGlmKGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnKSB7CiAgICAgICAgICAgICAgc2VsZi5fYWN0aXZhdGVUaW1lb3V0ID0gc2V0VGltZW91dChhY3RpdmF0ZUVsZW1lbnRzLCA4MCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFjdGl2YXRlRWxlbWVudHMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBrZXlJZCA9IChrZXlJZCA+IDE5ID8gMCA6IGtleUlkICsgMSk7CiAgICAgICAgICB9CgogICAgICAgIH0pOwogICAgICB9LAoKICAgICAgZW5kOiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBjbGVhciBvdXQgYW55IGFjdGl2ZS9xdWV1ZWQgZWxlbWVudHMgYWZ0ZXIgWFggbWlsbGlzZWNvbmRzCiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX2FjdGl2YXRlVGltZW91dCk7CiAgICAgICAgc2V0VGltZW91dChjbGVhciwgMjAwKTsKICAgICAgfQoKICAgIH07CgogICAgZnVuY3Rpb24gY2xlYXIoKSB7CiAgICAgIC8vIGNsZWFyIG91dCBhbnkgZWxlbWVudHMgdGhhdCBhcmUgcXVldWVkIHRvIGJlIHNldCB0byBhY3RpdmUKICAgICAgcXVldWVFbGVtZW50cyA9IHt9OwoKICAgICAgLy8gaW4gdGhlIG5leHQgZnJhbWUsIHJlbW92ZSB0aGUgYWN0aXZlIGNsYXNzIGZyb20gYWxsIGFjdGl2ZSBlbGVtZW50cwogICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZGVhY3RpdmF0ZUVsZW1lbnRzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBhY3RpdmF0ZUVsZW1lbnRzKCkgewogICAgICAvLyBhY3RpdmF0ZSBhbGwgZWxlbWVudHMgaW4gdGhlIHF1ZXVlCiAgICAgIGZvcih2YXIga2V5IGluIHF1ZXVlRWxlbWVudHMpIHsKICAgICAgICBpZihxdWV1ZUVsZW1lbnRzW2tleV0pIHsKICAgICAgICAgIHF1ZXVlRWxlbWVudHNba2V5XS5jbGFzc0xpc3QuYWRkKEFDVElWQVRFRF9DTEFTUyk7CiAgICAgICAgICBhY3RpdmVFbGVtZW50c1trZXldID0gcXVldWVFbGVtZW50c1trZXldOwogICAgICAgIH0KICAgICAgfQogICAgICBxdWV1ZUVsZW1lbnRzID0ge307CiAgICB9CgogICAgZnVuY3Rpb24gZGVhY3RpdmF0ZUVsZW1lbnRzKCkgewogICAgICBmb3IodmFyIGtleSBpbiBhY3RpdmVFbGVtZW50cykgewogICAgICAgIGlmKGFjdGl2ZUVsZW1lbnRzW2tleV0pIHsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnRzW2tleV0uY2xhc3NMaXN0LnJlbW92ZShBQ1RJVkFURURfQ0xBU1MpOwogICAgICAgICAgZGVsZXRlIGFjdGl2ZUVsZW1lbnRzW2tleV07CiAgICAgICAgfQogICAgICB9CiAgICB9CgogIH0pKGRvY3VtZW50LCBpb25pYyk7CgogIChmdW5jdGlvbihpb25pYykgewoKICAgIC8qIGZvciBuZXh0VWlkKCkgZnVuY3Rpb24gYmVsb3cgKi8KICAgIHZhciB1aWQgPSBbJzAnLCcwJywnMCddOwoKICAgIC8qKgogICAgICogVmFyaW91cyB1dGlsaXRpZXMgdXNlZCB0aHJvdWdob3V0IElvbmljCiAgICAgKgogICAgICogU29tZSBvZiB0aGVzZSBhcmUgYWRvcHRlZCBmcm9tIHVuZGVyc2NvcmUuanMgYW5kIGJhY2tib25lLmpzLCBib3RoIGFsc28gTUlUIGxpY2Vuc2VkLgogICAgICovCiAgICBpb25pYy5VdGlscyA9IHsKCiAgICAgIGFycmF5TW92ZTogZnVuY3Rpb24gKGFyciwgb2xkX2luZGV4LCBuZXdfaW5kZXgpIHsKICAgICAgICBpZiAobmV3X2luZGV4ID49IGFyci5sZW5ndGgpIHsKICAgICAgICAgIHZhciBrID0gbmV3X2luZGV4IC0gYXJyLmxlbmd0aDsKICAgICAgICAgIHdoaWxlICgoay0tKSArIDEpIHsKICAgICAgICAgICAgYXJyLnB1c2godW5kZWZpbmVkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYXJyLnNwbGljZShuZXdfaW5kZXgsIDAsIGFyci5zcGxpY2Uob2xkX2luZGV4LCAxKVswXSk7CiAgICAgICAgcmV0dXJuIGFycjsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBSZXR1cm4gYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIGdpdmVuIGNvbnRleHQKICAgICAgICovCiAgICAgIHByb3h5OiBmdW5jdGlvbihmdW5jLCBjb250ZXh0KSB7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgICB9OwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIE9ubHkgY2FsbCBhIGZ1bmN0aW9uIG9uY2UgaW4gdGhlIGdpdmVuIGludGVydmFsLgogICAgICAgKgogICAgICAgKiBAcGFyYW0gZnVuYyB7RnVuY3Rpb259IHRoZSBmdW5jdGlvbiB0byBjYWxsCiAgICAgICAqIEBwYXJhbSB3YWl0IHtpbnR9IGhvdyBsb25nIHRvIHdhaXQgYmVmb3JlL2FmdGVyIHRvIGFsbG93IGZ1bmN0aW9uIGNhbGxzCiAgICAgICAqIEBwYXJhbSBpbW1lZGlhdGUge2Jvb2xlYW59IHdoZXRoZXIgdG8gY2FsbCBpbW1lZGlhdGVseSBvciBhZnRlciB0aGUgd2FpdCBpbnRlcnZhbAogICAgICAgKi8KICAgICAgZGVib3VuY2U6IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgICAgIHZhciB0aW1lb3V0LCBhcmdzLCBjb250ZXh0LCB0aW1lc3RhbXAsIHJlc3VsdDsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBsYXN0ID0gKG5ldyBEYXRlKCkpIC0gdGltZXN0YW1wOwogICAgICAgICAgICBpZiAobGFzdCA8IHdhaXQpIHsKICAgICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCAtIGxhc3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICAgIGlmICghaW1tZWRpYXRlKSByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgICAgICBpZiAoIXRpbWVvdXQpIHsKICAgICAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNhbGxOb3cpIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogVGhyb3R0bGUgdGhlIGdpdmVuIGZ1biwgb25seSBhbGxvd2luZyBpdCB0byBiZQogICAgICAgKiBjYWxsZWQgYXQgbW9zdCBldmVyeSBgd2FpdGAgbXMuCiAgICAgICAqLwogICAgICB0aHJvdHRsZTogZnVuY3Rpb24oZnVuYywgd2FpdCwgb3B0aW9ucykgewogICAgICAgIHZhciBjb250ZXh0LCBhcmdzLCByZXN1bHQ7CiAgICAgICAgdmFyIHRpbWVvdXQgPSBudWxsOwogICAgICAgIHZhciBwcmV2aW91cyA9IDA7CiAgICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHByZXZpb3VzID0gb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSA/IDAgOiBEYXRlLm5vdygpOwogICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgICBpZiAoIXByZXZpb3VzICYmIG9wdGlvbnMubGVhZGluZyA9PT0gZmFsc2UpIHByZXZpb3VzID0gbm93OwogICAgICAgICAgdmFyIHJlbWFpbmluZyA9IHdhaXQgLSAobm93IC0gcHJldmlvdXMpOwogICAgICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICAgICAgaWYgKHJlbWFpbmluZyA8PSAwKSB7CiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICAgIHByZXZpb3VzID0gbm93OwogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgfSBlbHNlIGlmICghdGltZW91dCAmJiBvcHRpb25zLnRyYWlsaW5nICE9PSBmYWxzZSkgewogICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgcmVtYWluaW5nKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfTsKICAgICAgfSwKICAgICAgLy8gQm9ycm93ZWQgZnJvbSBCYWNrYm9uZS5qcydzIGV4dGVuZAogICAgICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAgICAgLy8gU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKICAgICAgLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KICAgICAgaW5oZXJpdDogZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgICAgICB2YXIgcGFyZW50ID0gdGhpczsKICAgICAgICB2YXIgY2hpbGQ7CgogICAgICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgICAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAgICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgogICAgICAgIGlmIChwcm90b1Byb3BzICYmIHByb3RvUHJvcHMuaGFzT3duUHJvcGVydHkoJ2NvbnN0cnVjdG9yJykpIHsKICAgICAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hpbGQgPSBmdW5jdGlvbigpeyByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CiAgICAgICAgfQoKICAgICAgICAvLyBBZGQgc3RhdGljIHByb3BlcnRpZXMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLCBpZiBzdXBwbGllZC4KICAgICAgICBpb25pYy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgICAgICAvLyBTZXQgdGhlIHByb3RvdHlwZSBjaGFpbiB0byBpbmhlcml0IGZyb20gYHBhcmVudGAsIHdpdGhvdXQgY2FsbGluZwogICAgICAgIC8vIGBwYXJlbnRgJ3MgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICAgICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgICAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICAgICAgICBjaGlsZC5wcm90b3R5cGUgPSBuZXcgU3Vycm9nYXRlKCk7CgogICAgICAgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAogICAgICAgIC8vIGlmIHN1cHBsaWVkLgogICAgICAgIGlmIChwcm90b1Byb3BzKSBpb25pYy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCiAgICAgICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgICAgIC8vIGxhdGVyLgogICAgICAgIGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7CgogICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgfSwKCiAgICAgIC8vIEV4dGVuZCBhZGFwdGVkIGZyb20gVW5kZXJzY29yZS5qcwogICAgICBleHRlbmQ6IGZ1bmN0aW9uKG9iaikgewogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIHNvdXJjZSA9IGFyZ3NbaV07CiAgICAgICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gc291cmNlKSB7CiAgICAgICAgICAgICAgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmo7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQSBjb25zaXN0ZW50IHdheSBvZiBjcmVhdGluZyB1bmlxdWUgSURzIGluIGFuZ3VsYXIuIFRoZSBJRCBpcyBhIHNlcXVlbmNlIG9mIGFscGhhIG51bWVyaWMKICAgICAgICogY2hhcmFjdGVycyBzdWNoIGFzICcwMTJBQkMnLiBUaGUgcmVhc29uIHdoeSB3ZSBhcmUgbm90IHVzaW5nIHNpbXBseSBhIG51bWJlciBjb3VudGVyIGlzIHRoYXQKICAgICAgICogdGhlIG51bWJlciBzdHJpbmcgZ2V0cyBsb25nZXIgb3ZlciB0aW1lLCBhbmQgaXQgY2FuIGFsc28gb3ZlcmZsb3csIHdoZXJlIGFzIHRoZSBuZXh0SWQKICAgICAgICogd2lsbCBncm93IG11Y2ggc2xvd2VyLCBpdCBpcyBhIHN0cmluZywgYW5kIGl0IHdpbGwgbmV2ZXIgb3ZlcmZsb3cuCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogICAgICAgKi8KICAgICAgbmV4dFVpZDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGluZGV4ID0gdWlkLmxlbmd0aDsKICAgICAgICB2YXIgZGlnaXQ7CgogICAgICAgIHdoaWxlKGluZGV4KSB7CiAgICAgICAgICBpbmRleC0tOwogICAgICAgICAgZGlnaXQgPSB1aWRbaW5kZXhdLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgICBpZiAoZGlnaXQgPT0gNTcgLyonOScqLykgewogICAgICAgICAgICB1aWRbaW5kZXhdID0gJ0EnOwogICAgICAgICAgICByZXR1cm4gdWlkLmpvaW4oJycpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGRpZ2l0ID09IDkwICAvKidaJyovKSB7CiAgICAgICAgICAgIHVpZFtpbmRleF0gPSAnMCc7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1aWRbaW5kZXhdID0gU3RyaW5nLmZyb21DaGFyQ29kZShkaWdpdCArIDEpOwogICAgICAgICAgICByZXR1cm4gdWlkLmpvaW4oJycpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB1aWQudW5zaGlmdCgnMCcpOwogICAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICAgIH0KICAgIH07CgogICAgLy8gQmluZCBhIGZldyBvZiB0aGUgbW9zdCB1c2VmdWwgZnVuY3Rpb25zIHRvIHRoZSBpb25pYyBzY29wZQogICAgaW9uaWMuaW5oZXJpdCA9IGlvbmljLlV0aWxzLmluaGVyaXQ7CiAgICBpb25pYy5leHRlbmQgPSBpb25pYy5VdGlscy5leHRlbmQ7CiAgICBpb25pYy50aHJvdHRsZSA9IGlvbmljLlV0aWxzLnRocm90dGxlOwogICAgaW9uaWMucHJveHkgPSBpb25pYy5VdGlscy5wcm94eTsKICAgIGlvbmljLmRlYm91bmNlID0gaW9uaWMuVXRpbHMuZGVib3VuY2U7CgogIH0pKHdpbmRvdy5pb25pYyk7CgogIC8qKgogICAqIEBuZ2RvYyBwYWdlCiAgICogQG5hbWUga2V5Ym9hcmQKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICogT24gYm90aCBBbmRyb2lkIGFuZCBpT1MsIElvbmljIHdpbGwgYXR0ZW1wdCB0byBwcmV2ZW50IHRoZSBrZXlib2FyZCBmcm9tCiAgICogb2JzY3VyaW5nIGlucHV0cyBhbmQgZm9jdXNhYmxlIGVsZW1lbnRzIHdoZW4gaXQgYXBwZWFycyBieSBzY3JvbGxpbmcgdGhlbQogICAqIGludG8gdmlldy4gIEluIG9yZGVyIGZvciB0aGlzIHRvIHdvcmssIGFueSBmb2N1c2FibGUgZWxlbWVudHMgbXVzdCBiZSB3aXRoaW4KICAgKiBhIFtTY3JvbGwgVmlld10oaHR0cDovL2lvbmljZnJhbWV3b3JrLmNvbS9kb2NzL2FwaS9kaXJlY3RpdmUvaW9uU2Nyb2xsLykKICAgKiBvciBhIGRpcmVjdGl2ZSBzdWNoIGFzIFtDb250ZW50XShodHRwOi8vaW9uaWNmcmFtZXdvcmsuY29tL2RvY3MvYXBpL2RpcmVjdGl2ZS9pb25Db250ZW50LykKICAgKiB0aGF0IGhhcyBhIFNjcm9sbCBWaWV3LgogICAqCiAgICogSXQgd2lsbCBhbHNvIGF0dGVtcHQgdG8gcHJldmVudCB0aGUgbmF0aXZlIG92ZXJmbG93IHNjcm9sbGluZyBvbiBmb2N1cywKICAgKiB3aGljaCBjYW4gY2F1c2UgbGF5b3V0IGlzc3VlcyBzdWNoIGFzIHB1c2hpbmcgaGVhZGVycyB1cCBhbmQgb3V0IG9mIHZpZXcuCiAgICoKICAgKiBUaGUga2V5Ym9hcmQgZml4ZXMgd29yayBiZXN0IGluIGNvbmp1bmN0aW9uIHdpdGggdGhlCiAgICogW0lvbmljIEtleWJvYXJkIFBsdWdpbl0oaHR0cHM6Ly9naXRodWIuY29tL2RyaWZ0eWNvL2lvbmljLXBsdWdpbnMta2V5Ym9hcmQpLAogICAqIGFsdGhvdWdoIGl0IHdpbGwgcGVyZm9ybSByZWFzb25hYmx5IHdlbGwgd2l0aG91dC4gIEhvd2V2ZXIsIGlmIHlvdSBhcmUgdXNpbmcKICAgKiBDb3Jkb3ZhIHRoZXJlIGlzIG5vIHJlYXNvbiBub3QgdG8gdXNlIHRoZSBwbHVnaW4uCiAgICoKICAgKiAjIyMgSGlkZSB3aGVuIGtleWJvYXJkIHNob3dzCiAgICoKICAgKiBUbyBoaWRlIGFuIGVsZW1lbnQgd2hlbiB0aGUga2V5Ym9hcmQgaXMgb3BlbiwgYWRkIHRoZSBjbGFzcyBgaGlkZS1vbi1rZXlib2FyZC1vcGVuYC4KICAgKgogICAqIGBgYGh0bWwKICAgKiA8ZGl2IGNsYXNzPSJoaWRlLW9uLWtleWJvYXJkLW9wZW4iPgogICAqICAgPGRpdiBpZD0iZ29vZ2xlLW1hcCI+PC9kaXY+CiAgICogPC9kaXY+CiAgICogYGBgCiAgICogLS0tLS0tLS0tLQogICAqCiAgICogIyMjIFBsdWdpbiBVc2FnZQogICAqIEluZm9ybWF0aW9uIG9uIHVzaW5nIHRoZSBwbHVnaW4gY2FuIGJlIGZvdW5kIGF0CiAgICogW2h0dHBzOi8vZ2l0aHViLmNvbS9kcmlmdHljby9pb25pYy1wbHVnaW5zLWtleWJvYXJkXShodHRwczovL2dpdGh1Yi5jb20vZHJpZnR5Y28vaW9uaWMtcGx1Z2lucy1rZXlib2FyZCkuCiAgICoKICAgKiAtLS0tLS0tLS0tCiAgICoKICAgKiAjIyMgQW5kcm9pZCBOb3RlcwogICAqIC0gSWYgeW91ciBhcHAgaXMgcnVubmluZyBpbiBmdWxsc2NyZWVuLCBpLmUuIHlvdSBoYXZlCiAgICogICBgPHByZWZlcmVuY2UgbmFtZT0iRnVsbHNjcmVlbiIgdmFsdWU9InRydWUiIC8+YCBpbiB5b3VyIGBjb25maWcueG1sYCBmaWxlCiAgICogICB5b3Ugd2lsbCBuZWVkIHRvIHNldCBgaW9uaWMuUGxhdGZvcm0uaXNGdWxsU2NyZWVuID0gdHJ1ZWAgbWFudWFsbHkuCiAgICoKICAgKiAtIFlvdSBjYW4gY29uZmlndXJlIHRoZSBiZWhhdmlvciBvZiB0aGUgd2ViIHZpZXcgd2hlbiB0aGUga2V5Ym9hcmQgc2hvd3MgYnkgc2V0dGluZwogICAqICAgW2FuZHJvaWQ6d2luZG93U29mdElucHV0TW9kZV0oaHR0cDovL2RldmVsb3Blci5hbmRyb2lkLmNvbS9yZWZlcmVuY2UvYW5kcm9pZC9SLmF0dHIuaHRtbCN3aW5kb3dTb2Z0SW5wdXRNb2RlKQogICAqICAgdG8gZWl0aGVyIGBhZGp1c3RQYW5gLCBgYWRqdXN0UmVzaXplYCBvciBgYWRqdXN0Tm90aGluZ2AgaW4geW91ciBhcHAncwogICAqICAgYWN0aXZpdHkgaW4gYEFuZHJvaWRNYW5pZmVzdC54bWxgLiBgYWRqdXN0UmVzaXplYCBpcyB0aGUgcmVjb21tZW5kZWQgc2V0dGluZwogICAqICAgZm9yIElvbmljLCBidXQgaWYgZm9yIHNvbWUgcmVhc29uIHlvdSBkbyB1c2UgYGFkanVzdFBhbmAgeW91IHdpbGwgbmVlZCB0bwogICAqICAgc2V0IGBpb25pYy5QbGF0Zm9ybS5pc0Z1bGxTY3JlZW4gPSB0cnVlYC4KICAgKgogICAqICAgYGBgeG1sCiAgICogICA8YWN0aXZpdHkgYW5kcm9pZDp3aW5kb3dTb2Z0SW5wdXRNb2RlPSJhZGp1c3RSZXNpemUiPgogICAqCiAgICogICBgYGAKICAgKgogICAqICMjIyBpT1MgTm90ZXMKICAgKiAtIElmIHRoZSBjb250ZW50IG9mIHlvdXIgYXBwIChpbmNsdWRpbmcgdGhlIGhlYWRlcikgaXMgYmVpbmcgcHVzaGVkIHVwIGFuZAogICAqICAgb3V0IG9mIHZpZXcgb24gaW5wdXQgZm9jdXMsIHRyeSBzZXR0aW5nIGBjb3Jkb3ZhLnBsdWdpbnMuS2V5Ym9hcmQuZGlzYWJsZVNjcm9sbCh0cnVlKWAuCiAgICogICBUaGlzIGRvZXMgKipub3QqKiBkaXNhYmxlIHNjcm9sbGluZyBpbiB0aGUgSW9uaWMgc2Nyb2xsIHZpZXcsIHJhdGhlciBpdAogICAqICAgZGlzYWJsZXMgdGhlIG5hdGl2ZSBvdmVyZmxvdyBzY3JvbGxpbmcgdGhhdCBoYXBwZW5zIGF1dG9tYXRpY2FsbHkgYXMgYQogICAqICAgcmVzdWx0IG9mIGZvY3VzaW5nIG9uIGlucHV0cyBiZWxvdyB0aGUga2V5Ym9hcmQuCiAgICoKICAgKi8KCiAgdmFyIGtleWJvYXJkVmlld3BvcnRIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgdmFyIGtleWJvYXJkSXNPcGVuOwogIHZhciBrZXlib2FyZEFjdGl2ZUVsZW1lbnQ7CiAgdmFyIGtleWJvYXJkRm9jdXNPdXRUaW1lcjsKICB2YXIga2V5Ym9hcmRGb2N1c0luVGltZXI7CiAgdmFyIGtleWJvYXJkTGFzdFNob3cgPSAwOwoKICB2YXIgS0VZQk9BUkRfT1BFTl9DU1MgPSAna2V5Ym9hcmQtb3Blbic7CiAgdmFyIFNDUk9MTF9DT05UQUlORVJfQ1NTID0gJ3Njcm9sbCc7CgogIGlvbmljLmtleWJvYXJkID0gewogICAgaXNPcGVuOiBmYWxzZSwKICAgIGhlaWdodDogbnVsbCwKICAgIGxhbmRzY2FwZTogZmFsc2UsCiAgfTsKCiAgZnVuY3Rpb24ga2V5Ym9hcmRJbml0KCkgewogICAgaWYoIGtleWJvYXJkSGFzUGx1Z2luKCkgKSB7CiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCduYXRpdmUua2V5Ym9hcmRzaG93Jywga2V5Ym9hcmROYXRpdmVTaG93KTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ25hdGl2ZS5rZXlib2FyZGhpZGUnLCBrZXlib2FyZEZvY3VzT3V0KTsKCiAgICAgIC8vZGVwcmVjYXRlZAogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbmF0aXZlLnNob3drZXlib2FyZCcsIGtleWJvYXJkTmF0aXZlU2hvdyk7CiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCduYXRpdmUuaGlkZWtleWJvYXJkJywga2V5Ym9hcmRGb2N1c091dCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdmb2N1c291dCcsIGtleWJvYXJkRm9jdXNPdXQpOwogICAgfQoKICAgIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcignaW9uaWMuZm9jdXNpbicsIGtleWJvYXJkQnJvd3NlckZvY3VzSW4pOwogICAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdmb2N1c2luJywga2V5Ym9hcmRCcm93c2VyRm9jdXNJbik7CgogICAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdvcmllbnRhdGlvbmNoYW5nZScsIGtleWJvYXJkT3JpZW50YXRpb25DaGFuZ2UpOwoKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBrZXlib2FyZEluaXQpOwogIH0KCiAgZnVuY3Rpb24ga2V5Ym9hcmROYXRpdmVTaG93KGUpIHsKICAgIGNsZWFyVGltZW91dChrZXlib2FyZEZvY3VzT3V0VGltZXIpOwogICAgaW9uaWMua2V5Ym9hcmQuaGVpZ2h0ID0gZS5rZXlib2FyZEhlaWdodDsKICB9CgogIGZ1bmN0aW9uIGtleWJvYXJkQnJvd3NlckZvY3VzSW4oZSkgewogICAgaWYoICFlLnRhcmdldCB8fCAhaW9uaWMudGFwLmlzVGV4dElucHV0KGUudGFyZ2V0KSB8fCBpb25pYy50YXAuaXNEYXRlSW5wdXQoZS50YXJnZXQpIHx8ICFrZXlib2FyZElzV2l0aGluU2Nyb2xsKGUudGFyZ2V0KSApIHJldHVybjsKCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5Ym9hcmRPbktleURvd24sIGZhbHNlKTsKCiAgICBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCA9IDA7CiAgICBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoJy5zY3JvbGwtY29udGVudCcpLnNjcm9sbFRvcCA9IDA7CgogICAga2V5Ym9hcmRBY3RpdmVFbGVtZW50ID0gZS50YXJnZXQ7CgogICAga2V5Ym9hcmRTZXRTaG93KGUpOwogIH0KCiAgZnVuY3Rpb24ga2V5Ym9hcmRTZXRTaG93KGUpIHsKICAgIGNsZWFyVGltZW91dChrZXlib2FyZEZvY3VzSW5UaW1lcik7CiAgICBjbGVhclRpbWVvdXQoa2V5Ym9hcmRGb2N1c091dFRpbWVyKTsKCiAgICBrZXlib2FyZEZvY3VzSW5UaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgaWYgKCBrZXlib2FyZExhc3RTaG93ICsgMzUwID4gRGF0ZS5ub3coKSApIHJldHVybjsKICAgICAga2V5Ym9hcmRMYXN0U2hvdyA9IERhdGUubm93KCk7CiAgICAgIHZhciBrZXlib2FyZEhlaWdodDsKICAgICAgdmFyIGVsZW1lbnRCb3VuZHMgPSBrZXlib2FyZEFjdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHZhciBjb3VudCA9IDA7CgogICAgICB2YXIgcG9sbEtleWJvYXJkSGVpZ2h0ID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXsKCiAgICAgICAga2V5Ym9hcmRIZWlnaHQgPSBrZXlib2FyZEdldEhlaWdodCgpOwogICAgICAgIGlmIChjb3VudCA+IDEwKXsKICAgICAgICAgIGNsZWFySW50ZXJ2YWwocG9sbEtleWJvYXJkSGVpZ2h0KTsKICAgICAgICAgIC8vd2FpdGVkIGxvbmcgZW5vdWdoLCBqdXN0IGd1ZXNzCiAgICAgICAgICBrZXlib2FyZEhlaWdodCA9IDI3NTsKICAgICAgICB9CiAgICAgICAgaWYgKGtleWJvYXJkSGVpZ2h0KXsKICAgICAgICAgIGtleWJvYXJkU2hvdyhlLnRhcmdldCwgZWxlbWVudEJvdW5kcy50b3AsIGVsZW1lbnRCb3VuZHMuYm90dG9tLCBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0LCBrZXlib2FyZEhlaWdodCk7CiAgICAgICAgICBjbGVhckludGVydmFsKHBvbGxLZXlib2FyZEhlaWdodCk7CiAgICAgICAgfQogICAgICAgIGNvdW50Kys7CgogICAgICB9LCAxMDApOwogICAgfSwgMzIpOwogIH0KCiAgZnVuY3Rpb24ga2V5Ym9hcmRTaG93KGVsZW1lbnQsIGVsZW1lbnRUb3AsIGVsZW1lbnRCb3R0b20sIHZpZXdwb3J0SGVpZ2h0LCBrZXlib2FyZEhlaWdodCkgewogICAgdmFyIGRldGFpbHMgPSB7CiAgICAgIHRhcmdldDogZWxlbWVudCwKICAgICAgZWxlbWVudFRvcDogTWF0aC5yb3VuZChlbGVtZW50VG9wKSwKICAgICAgZWxlbWVudEJvdHRvbTogTWF0aC5yb3VuZChlbGVtZW50Qm90dG9tKSwKICAgICAga2V5Ym9hcmRIZWlnaHQ6IGtleWJvYXJkSGVpZ2h0LAogICAgICB2aWV3cG9ydEhlaWdodDogdmlld3BvcnRIZWlnaHQKICAgIH07CgogICAgZGV0YWlscy5oYXNQbHVnaW4gPSBrZXlib2FyZEhhc1BsdWdpbigpOwoKICAgIGRldGFpbHMuY29udGVudEhlaWdodCA9IHZpZXdwb3J0SGVpZ2h0IC0ga2V5Ym9hcmRIZWlnaHQ7CgogICAgdm9pZCAwOwoKICAgIC8vIGZpZ3VyZSBvdXQgaWYgdGhlIGVsZW1lbnQgaXMgdW5kZXIgdGhlIGtleWJvYXJkCiAgICBkZXRhaWxzLmlzRWxlbWVudFVuZGVyS2V5Ym9hcmQgPSAoZGV0YWlscy5lbGVtZW50Qm90dG9tID4gZGV0YWlscy5jb250ZW50SGVpZ2h0KTsKCiAgICBpb25pYy5rZXlib2FyZC5pc09wZW4gPSB0cnVlOwoKICAgIC8vIHNlbmQgZXZlbnQgc28gdGhlIHNjcm9sbCB2aWV3IGFkanVzdHMKICAgIGtleWJvYXJkQWN0aXZlRWxlbWVudCA9IGVsZW1lbnQ7CiAgICBpb25pYy50cmlnZ2VyKCdzY3JvbGxDaGlsZEludG9WaWV3JywgZGV0YWlscywgdHJ1ZSk7CgogICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZChLRVlCT0FSRF9PUEVOX0NTUyk7CiAgICB9KTsKCiAgICAvLyBhbnkgc2hvd2luZyBwYXJ0IG9mIHRoZSBkb2N1bWVudCB0aGF0IGlzbid0IHdpdGhpbiB0aGUgc2Nyb2xsIHRoZSB1c2VyCiAgICAvLyBjb3VsZCB0b3VjaG1vdmUgYW5kIGNhdXNlIHNvbWUgdWdseSBjaGFuZ2VzIHRvIHRoZSBhcHAsIHNvIGRpc2FibGUKICAgIC8vIGFueSB0b3VjaG1vdmUgZXZlbnRzIHdoaWxlIHRoZSBrZXlib2FyZCBpcyBvcGVuIHVzaW5nIGUucHJldmVudERlZmF1bHQoKQogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywga2V5Ym9hcmRQcmV2ZW50RGVmYXVsdCwgZmFsc2UpOwoKICAgIHJldHVybiBkZXRhaWxzOwogIH0KCiAgZnVuY3Rpb24ga2V5Ym9hcmRGb2N1c091dChlKSB7CiAgICBjbGVhclRpbWVvdXQoa2V5Ym9hcmRGb2N1c091dFRpbWVyKTsKCiAgICBrZXlib2FyZEZvY3VzT3V0VGltZXIgPSBzZXRUaW1lb3V0KGtleWJvYXJkSGlkZSwgMzUwKTsKICB9CgogIGZ1bmN0aW9uIGtleWJvYXJkSGlkZSgpIHsKICAgIHZvaWQgMDsKICAgIGlvbmljLmtleWJvYXJkLmlzT3BlbiA9IGZhbHNlOwoKICAgIGlvbmljLnRyaWdnZXIoJ3Jlc2V0U2Nyb2xsVmlldycsIHsKICAgICAgdGFyZ2V0OiBrZXlib2FyZEFjdGl2ZUVsZW1lbnQKICAgIH0sIHRydWUpOwoKICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpewogICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoS0VZQk9BUkRfT1BFTl9DU1MpOwogICAgfSk7CgogICAgLy8gdGhlIGtleWJvYXJkIGlzIGdvbmUgbm93LCByZW1vdmUgdGhlIHRvdWNobW92ZSB0aGF0IGRpc2FibGVzIG5hdGl2ZSBzY3JvbGwKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGtleWJvYXJkUHJldmVudERlZmF1bHQpOwogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGtleWJvYXJkT25LZXlEb3duKTsKICB9CgogIGZ1bmN0aW9uIGtleWJvYXJkVXBkYXRlVmlld3BvcnRIZWlnaHQoKSB7CiAgICBpZiggd2luZG93LmlubmVySGVpZ2h0ID4ga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCApIHsKICAgICAga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGtleWJvYXJkT25LZXlEb3duKGUpIHsKICAgIGlmKCBpb25pYy5zY3JvbGwuaXNTY3JvbGxpbmcgKSB7CiAgICAgIGtleWJvYXJkUHJldmVudERlZmF1bHQoZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBrZXlib2FyZFByZXZlbnREZWZhdWx0KGUpIHsKICAgIGlmKCBlLnRhcmdldC50YWdOYW1lICE9PSAnVEVYVEFSRUEnICkgewogICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBrZXlib2FyZE9yaWVudGF0aW9uQ2hhbmdlKCkgewogICAgdmFyIHVwZGF0ZWRWaWV3cG9ydEhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDsKCiAgICAvL3RvbyBzbG93LCBoYXZlIHRvIHdhaXQgZm9yIHVwZGF0ZWQgaGVpZ2h0CiAgICBpZiAodXBkYXRlZFZpZXdwb3J0SGVpZ2h0ID09PSBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0KXsKICAgICAgdmFyIGNvdW50ID0gMDsKICAgICAgdmFyIHBvbGxWaWV3cG9ydEhlaWdodCA9IHNldEludGVydmFsKGZ1bmN0aW9uKCl7CiAgICAgICAgLy9naXZlIHVwCiAgICAgICAgaWYgKGNvdW50ID4gMTApewogICAgICAgICAgY2xlYXJJbnRlcnZhbChwb2xsVmlld3BvcnRIZWlnaHQpOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlZFZpZXdwb3J0SGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwoKICAgICAgICBpZiAodXBkYXRlZFZpZXdwb3J0SGVpZ2h0ICE9PSBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0KXsKICAgICAgICAgIGlmICh1cGRhdGVkVmlld3BvcnRIZWlnaHQgPCBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0KXsKICAgICAgICAgICAgaW9uaWMua2V5Ym9hcmQubGFuZHNjYXBlID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBpb25pYy5rZXlib2FyZC5sYW5kc2NhcGUgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGtleWJvYXJkVmlld3BvcnRIZWlnaHQgPSB1cGRhdGVkVmlld3BvcnRIZWlnaHQ7CiAgICAgICAgICBjbGVhckludGVydmFsKHBvbGxWaWV3cG9ydEhlaWdodCk7CiAgICAgICAgfQogICAgICAgIGNvdW50Kys7CgogICAgICB9LCA1MCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCA9IHVwZGF0ZWRWaWV3cG9ydEhlaWdodDsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGtleWJvYXJkR2V0SGVpZ2h0KCkgewogICAgLy8gY2hlY2sgaWYgd2UgYXJlIGFscmVhZHkgaGF2ZSBhIGtleWJvYXJkIGhlaWdodCBmcm9tIHRoZSBwbHVnaW4KICAgIGlmICggaW9uaWMua2V5Ym9hcmQuaGVpZ2h0ICkgewogICAgICByZXR1cm4gaW9uaWMua2V5Ym9hcmQuaGVpZ2h0OwogICAgfQoKICAgIGlmICggaW9uaWMuUGxhdGZvcm0uaXNBbmRyb2lkKCkgKXsKICAgICAgLy9zaG91bGQgYmUgdXNpbmcgdGhlIHBsdWdpbiwgbm8gd2F5IHRvIGtub3cgaG93IGJpZyB0aGUga2V5Ym9hcmQgaXMsIHNvIGd1ZXNzCiAgICAgIGlmICggaW9uaWMuUGxhdGZvcm0uaXNGdWxsU2NyZWVuICl7CiAgICAgICAgcmV0dXJuIDI3NTsKICAgICAgfQogICAgICAvL290aGVyd2lzZSwgd2FpdCBmb3IgdGhlIHNjcmVlbiB0byByZXNpemUKICAgICAgaWYgKCB3aW5kb3cuaW5uZXJIZWlnaHQgPCBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0ICl7CiAgICAgICAgcmV0dXJuIGtleWJvYXJkVmlld3BvcnRIZWlnaHQgLSB3aW5kb3cuaW5uZXJIZWlnaHQ7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KICAgIH0KCiAgICAvLyBmYWxsYmFjayBmb3Igd2hlbiBpdHMgdGhlIHdlYnZpZXcgd2l0aG91dCB0aGUgcGx1Z2luCiAgICAvLyBvciBmb3IganVzdCB0aGUgc3RhbmRhcmQgd2ViIGJyb3dzZXIKICAgIGlmKCBpb25pYy5QbGF0Zm9ybS5pc0lPUygpICkgewogICAgICBpZiAoIGlvbmljLmtleWJvYXJkLmxhbmRzY2FwZSApewogICAgICAgIHJldHVybiAyMDY7CiAgICAgIH0KCiAgICAgIGlmICghaW9uaWMuUGxhdGZvcm0uaXNXZWJWaWV3KCkpewogICAgICAgIHJldHVybiAyMTY7CiAgICAgIH0KCiAgICAgIHJldHVybiAyNjA7CiAgICB9CgogICAgLy8gc2FmZSBndWVzcwogICAgcmV0dXJuIDI3NTsKICB9CgogIGZ1bmN0aW9uIGtleWJvYXJkSXNXaXRoaW5TY3JvbGwoZWxlKSB7CiAgICB3aGlsZShlbGUpIHsKICAgICAgaWYoZWxlLmNsYXNzTGlzdC5jb250YWlucyhTQ1JPTExfQ09OVEFJTkVSX0NTUykpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBlbGUgPSBlbGUucGFyZW50RWxlbWVudDsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGtleWJvYXJkSGFzUGx1Z2luKCkgewogICAgcmV0dXJuICEhKHdpbmRvdy5jb3Jkb3ZhICYmIGNvcmRvdmEucGx1Z2lucyAmJiBjb3Jkb3ZhLnBsdWdpbnMuS2V5Ym9hcmQpOwogIH0KCiAgaW9uaWMuUGxhdGZvcm0ucmVhZHkoZnVuY3Rpb24oKSB7CiAgICBrZXlib2FyZFVwZGF0ZVZpZXdwb3J0SGVpZ2h0KCk7CgogICAgLy8gQW5kcm9pZCBzb21ldGltZXMgcmVwb3J0cyBiYWQgaW5uZXJIZWlnaHQgb24gd2luZG93LmxvYWQKICAgIC8vIHRyeSBpdCBhZ2FpbiBpbiBhIGxpbCBiaXQgdG8gcGxheSBpdCBzYWZlCiAgICBzZXRUaW1lb3V0KGtleWJvYXJkVXBkYXRlVmlld3BvcnRIZWlnaHQsIDk5OSk7CgogICAgLy8gb25seSBpbml0aWFsaXplIHRoZSBhZGp1c3RtZW50cyBmb3IgdGhlIHZpcnR1YWwga2V5Ym9hcmQKICAgIC8vIGlmIGEgdG91Y2hzdGFydCBldmVudCBoYXBwZW5zCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0Jywga2V5Ym9hcmRJbml0LCBmYWxzZSk7CiAgfSk7CgoKCiAgdmFyIHZpZXdwb3J0VGFnOwogIHZhciB2aWV3cG9ydFByb3BlcnRpZXMgPSB7fTsKCiAgaW9uaWMudmlld3BvcnQgPSB7CiAgICBvcmllbnRhdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgIC8vIDAgPSBQb3J0cmFpdAogICAgICAvLyA5MCA9IExhbmRzY2FwZQogICAgICAvLyBub3QgdXNpbmcgd2luZG93Lm9yaWVudGF0aW9uIGJlY2F1c2UgZWFjaCBkZXZpY2UgaGFzIGEgZGlmZmVyZW50IGltcGxlbWVudGF0aW9uCiAgICAgIHJldHVybiAod2luZG93LmlubmVyV2lkdGggPiB3aW5kb3cuaW5uZXJIZWlnaHQgPyA5MCA6IDApOwogICAgfQogIH07CgogIGZ1bmN0aW9uIHZpZXdwb3J0TG9hZFRhZygpIHsKICAgIHZhciB4OwoKICAgIGZvcih4PTA7IHg8ZG9jdW1lbnQuaGVhZC5jaGlsZHJlbi5sZW5ndGg7IHgrKykgewogICAgICBpZihkb2N1bWVudC5oZWFkLmNoaWxkcmVuW3hdLm5hbWUgPT0gJ3ZpZXdwb3J0JykgewogICAgICAgIHZpZXdwb3J0VGFnID0gZG9jdW1lbnQuaGVhZC5jaGlsZHJlblt4XTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIGlmKHZpZXdwb3J0VGFnKSB7CiAgICAgIHZhciBwcm9wcyA9IHZpZXdwb3J0VGFnLmNvbnRlbnQudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9ccysvZywgJycpLnNwbGl0KCcsJyk7CiAgICAgIHZhciBrZXlWYWx1ZTsKICAgICAgZm9yKHg9MDsgeDxwcm9wcy5sZW5ndGg7IHgrKykgewogICAgICAgIGlmKHByb3BzW3hdKSB7CiAgICAgICAgICBrZXlWYWx1ZSA9IHByb3BzW3hdLnNwbGl0KCc9Jyk7CiAgICAgICAgICB2aWV3cG9ydFByb3BlcnRpZXNbIGtleVZhbHVlWzBdIF0gPSAoa2V5VmFsdWUubGVuZ3RoID4gMSA/IGtleVZhbHVlWzFdIDogJ18nKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmlld3BvcnRVcGRhdGUoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHZpZXdwb3J0VXBkYXRlKCkgewogICAgLy8gdW5pdCB0ZXN0cyBpbiB2aWV3cG9ydC51bml0LmpzCgogICAgdmFyIGluaXRXaWR0aCA9IHZpZXdwb3J0UHJvcGVydGllcy53aWR0aDsKICAgIHZhciBpbml0SGVpZ2h0ID0gdmlld3BvcnRQcm9wZXJ0aWVzLmhlaWdodDsKICAgIHZhciBwID0gaW9uaWMuUGxhdGZvcm07CiAgICB2YXIgdmVyc2lvbiA9IHAudmVyc2lvbigpOwogICAgdmFyIERFVklDRV9XSURUSCA9ICdkZXZpY2Utd2lkdGgnOwogICAgdmFyIERFVklDRV9IRUlHSFQgPSAnZGV2aWNlLWhlaWdodCc7CiAgICB2YXIgb3JpZW50YXRpb24gPSBpb25pYy52aWV3cG9ydC5vcmllbnRhdGlvbigpOwoKICAgIC8vIE1vc3QgdGltZXMgd2UncmUgcmVtb3ZpbmcgdGhlIGhlaWdodCBhbmQgYWRkaW5nIHRoZSB3aWR0aAogICAgLy8gU28gdGhpcyBpcyB0aGUgZGVmYXVsdCB0byBzdGFydCB3aXRoLCB0aGVuIG1vZGlmeSBwZXIgcGxhdGZvcm0vdmVyc2lvbi9vcmVpbnRhdGlvbgogICAgZGVsZXRlIHZpZXdwb3J0UHJvcGVydGllcy5oZWlnaHQ7CiAgICB2aWV3cG9ydFByb3BlcnRpZXMud2lkdGggPSBERVZJQ0VfV0lEVEg7CgogICAgaWYoIHAuaXNJUGFkKCkgKSB7CiAgICAgIC8vIGlQYWQKCiAgICAgIGlmKCB2ZXJzaW9uID4gNyApIHsKICAgICAgICAvLyBpUGFkID49IDcuMQogICAgICAgIC8vIGh0dHBzOi8vaXNzdWVzLmFwYWNoZS5vcmcvamlyYS9icm93c2UvQ0ItNDMyMwogICAgICAgIGRlbGV0ZSB2aWV3cG9ydFByb3BlcnRpZXMud2lkdGg7CgogICAgICB9IGVsc2UgewogICAgICAgIC8vIGlQYWQgPD0gNy4wCgogICAgICAgIGlmKCBwLmlzV2ViVmlldygpICkgewogICAgICAgICAgLy8gaVBhZCA8PSA3LjAgV2ViVmlldwoKICAgICAgICAgIGlmKCBvcmllbnRhdGlvbiA9PSA5MCApIHsKICAgICAgICAgICAgLy8gaVBhZCA8PSA3LjAgV2ViVmlldyBMYW5kc2NhcGUKICAgICAgICAgICAgdmlld3BvcnRQcm9wZXJ0aWVzLmhlaWdodCA9ICcwJzsKCiAgICAgICAgICB9IGVsc2UgaWYodmVyc2lvbiA9PSA3KSB7CiAgICAgICAgICAgIC8vIGlQYWQgPD0gNy4wIFdlYlZpZXcgUG9ydGFpdAogICAgICAgICAgICB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0ID0gREVWSUNFX0hFSUdIVDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gaVBhZCA8PSA2LjEgQnJvd3NlcgogICAgICAgICAgaWYodmVyc2lvbiA8IDcpIHsKICAgICAgICAgICAgdmlld3BvcnRQcm9wZXJ0aWVzLmhlaWdodCA9ICcwJzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICB9IGVsc2UgaWYoIHAuaXNJT1MoKSApIHsKICAgICAgLy8gaVBob25lCgogICAgICBpZiggcC5pc1dlYlZpZXcoKSApIHsKICAgICAgICAvLyBpUGhvbmUgV2ViVmlldwoKICAgICAgICBpZih2ZXJzaW9uID4gNykgewogICAgICAgICAgLy8gaVBob25lID49IDcuMSBXZWJWaWV3CiAgICAgICAgICBkZWxldGUgdmlld3BvcnRQcm9wZXJ0aWVzLndpZHRoOwoKICAgICAgICB9IGVsc2UgaWYodmVyc2lvbiA8IDcpIHsKICAgICAgICAgIC8vIGlQaG9uZSA8PSA2LjEgV2ViVmlldwogICAgICAgICAgLy8gaWYgaGVpZ2h0IHdhcyBzZXQgaXQgbmVlZHMgdG8gZ2V0IHJlbW92ZWQgd2l0aCB0aGlzIGhhY2sgZm9yIDw9IDYuMQogICAgICAgICAgaWYoIGluaXRIZWlnaHQgKSB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0ID0gJzAnOwoKICAgICAgICB9IGVsc2UgaWYodmVyc2lvbiA9PSA3KSB7CiAgICAgICAgICAvL2lQaG9uZSA9PSA3LjAgV2ViVmlldwogICAgICAgICAgdmlld3BvcnRQcm9wZXJ0aWVzLmhlaWdodCA9IERFVklDRV9IRUlHSFQ7CiAgICAgICAgfQoKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBpUGhvbmUgQnJvd3NlcgoKICAgICAgICBpZiAodmVyc2lvbiA8IDcpIHsKICAgICAgICAgIC8vIGlQaG9uZSA8PSA2LjEgQnJvd3NlcgogICAgICAgICAgLy8gaWYgaGVpZ2h0IHdhcyBzZXQgaXQgbmVlZHMgdG8gZ2V0IHJlbW92ZWQgd2l0aCB0aGlzIGhhY2sgZm9yIDw9IDYuMQogICAgICAgICAgaWYoIGluaXRIZWlnaHQgKSB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0ID0gJzAnOwogICAgICAgIH0KICAgICAgfQoKICAgIH0KCiAgICAvLyBvbmx5IHVwZGF0ZSB0aGUgdmlld3BvcnQgdGFnIGlmIHRoZXJlIHdhcyBhIGNoYW5nZQogICAgaWYoaW5pdFdpZHRoICE9PSB2aWV3cG9ydFByb3BlcnRpZXMud2lkdGggfHwgaW5pdEhlaWdodCAhPT0gdmlld3BvcnRQcm9wZXJ0aWVzLmhlaWdodCkgewogICAgICB2aWV3cG9ydFRhZ1VwZGF0ZSgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdmlld3BvcnRUYWdVcGRhdGUoKSB7CiAgICB2YXIga2V5LCBwcm9wcyA9IFtdOwogICAgZm9yKGtleSBpbiB2aWV3cG9ydFByb3BlcnRpZXMpIHsKICAgICAgaWYoIHZpZXdwb3J0UHJvcGVydGllc1trZXldICkgewogICAgICAgIHByb3BzLnB1c2goa2V5ICsgKHZpZXdwb3J0UHJvcGVydGllc1trZXldID09ICdfJyA/ICcnIDogJz0nICsgdmlld3BvcnRQcm9wZXJ0aWVzW2tleV0pICk7CiAgICAgIH0KICAgIH0KCiAgICB2aWV3cG9ydFRhZy5jb250ZW50ID0gcHJvcHMuam9pbignLCAnKTsKICB9CgogIGlvbmljLlBsYXRmb3JtLnJlYWR5KGZ1bmN0aW9uKCkgewogICAgdmlld3BvcnRMb2FkVGFnKCk7CgogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm9yaWVudGF0aW9uY2hhbmdlIiwgZnVuY3Rpb24oKXsKICAgICAgc2V0VGltZW91dCh2aWV3cG9ydFVwZGF0ZSwgMTAwMCk7CiAgICB9LCBmYWxzZSk7CiAgfSk7CgogIChmdW5jdGlvbihpb25pYykgewogICAgJ3VzZSBzdHJpY3QnOwogICAgaW9uaWMudmlld3MuVmlldyA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH07CgogICAgaW9uaWMudmlld3MuVmlldy5pbmhlcml0ID0gaW9uaWMuaW5oZXJpdDsKCiAgICBpb25pYy5leHRlbmQoaW9uaWMudmlld3MuVmlldy5wcm90b3R5cGUsIHsKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7fQogICAgfSk7CgogIH0pKHdpbmRvdy5pb25pYyk7CgogIC8qCiAgICogU2Nyb2xsZXIKICAgKiBodHRwOi8vZ2l0aHViLmNvbS96eW5nYS9zY3JvbGxlcgogICAqCiAgICogQ29weXJpZ2h0IDIwMTEsIFp5bmdhIEluYy4KICAgKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuCiAgICogaHR0cHM6Ly9yYXcuZ2l0aHViLmNvbS96eW5nYS9zY3JvbGxlci9tYXN0ZXIvTUlULUxJQ0VOU0UudHh0CiAgICoKICAgKiBCYXNlZCBvbiB0aGUgd29yayBvZjogVW5pZnkgUHJvamVjdCAodW5pZnktcHJvamVjdC5vcmcpCiAgICogaHR0cDovL3VuaWZ5LXByb2plY3Qub3JnCiAgICogQ29weXJpZ2h0IDIwMTEsIERldXRzY2hlIFRlbGVrb20gQUcKICAgKiBMaWNlbnNlOiBNSVQgKyBBcGFjaGUgKFYyKQogICAqLwoKICAvKiBqc2hpbnQgZXFudWxsOiB0cnVlICovCgogIC8qKgogICAqIEdlbmVyaWMgYW5pbWF0aW9uIGNsYXNzIHdpdGggc3VwcG9ydCBmb3IgZHJvcHBlZCBmcmFtZXMgYm90aCBvcHRpb25hbCBlYXNpbmcgYW5kIGR1cmF0aW9uLgogICAqCiAgICogT3B0aW9uYWwgZHVyYXRpb24gaXMgdXNlZnVsIHdoZW4gdGhlIGxpZmV0aW1lIGlzIGRlZmluZWQgYnkgYW5vdGhlciBjb25kaXRpb24gdGhhbiB0aW1lCiAgICogZS5nLiBzcGVlZCBvZiBhbiBhbmltYXRpbmcgb2JqZWN0LCBldGMuCiAgICoKICAgKiBEcm9wcGVkIGZyYW1lIGxvZ2ljIGFsbG93cyB0byBrZWVwIHVzaW5nIHRoZSBzYW1lIHVwZGF0ZXIgbG9naWMgaW5kZXBlbmRlbnQgZnJvbSB0aGUgYWN0dWFsCiAgICogcmVuZGVyaW5nLiBUaGlzIGVhc2VzIGEgbG90IG9mIGNhc2VzIHdoZXJlIGl0IG1pZ2h0IGJlIHByZXR0eSBjb21wbGV4IHRvIGJyZWFrIGRvd24gYSBzdGF0ZQogICAqIGJhc2VkIG9uIHRoZSBwdXJlIHRpbWUgZGlmZmVyZW5jZS4KICAgKi8KICB2YXIgenluZ2FDb3JlID0geyBlZmZlY3Q6IHt9IH07CiAgKGZ1bmN0aW9uKGdsb2JhbCkgewogICAgdmFyIHRpbWUgPSBEYXRlLm5vdyB8fCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICtuZXcgRGF0ZSgpOwogICAgfTsKICAgIHZhciBkZXNpcmVkRnJhbWVzID0gNjA7CiAgICB2YXIgbWlsbGlzZWNvbmRzUGVyU2Vjb25kID0gMTAwMDsKICAgIHZhciBydW5uaW5nID0ge307CiAgICB2YXIgY291bnRlciA9IDE7CgogICAgenluZ2FDb3JlLmVmZmVjdC5BbmltYXRlID0gewoKICAgICAgLyoqCiAgICAgICAqIEEgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIHdyYXBwZXIgLyBwb2x5ZmlsbC4KICAgICAgICoKICAgICAgICogQHBhcmFtIGNhbGxiYWNrIHtGdW5jdGlvbn0gVGhlIGNhbGxiYWNrIHRvIGJlIGludm9rZWQgYmVmb3JlIHRoZSBuZXh0IHJlcGFpbnQuCiAgICAgICAqIEBwYXJhbSByb290IHtIVE1MRWxlbWVudH0gVGhlIHJvb3QgZWxlbWVudCBmb3IgdGhlIHJlcGFpbnQKICAgICAgICovCiAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZTogKGZ1bmN0aW9uKCkgewoKICAgICAgICAvLyBDaGVjayBmb3IgcmVxdWVzdCBhbmltYXRpb24gRnJhbWUgc3VwcG9ydAogICAgICAgIHZhciByZXF1ZXN0RnJhbWUgPSBnbG9iYWwucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8IGdsb2JhbC53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgZ2xvYmFsLm1velJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCBnbG9iYWwub1JlcXVlc3RBbmltYXRpb25GcmFtZTsKICAgICAgICB2YXIgaXNOYXRpdmUgPSAhIXJlcXVlc3RGcmFtZTsKCiAgICAgICAgaWYgKHJlcXVlc3RGcmFtZSAmJiAhL3JlcXVlc3RBbmltYXRpb25GcmFtZVwoXClccypce1xzKlxbbmF0aXZlIGNvZGVcXVxzKlx9L2kudGVzdChyZXF1ZXN0RnJhbWUudG9TdHJpbmcoKSkpIHsKICAgICAgICAgIGlzTmF0aXZlID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNOYXRpdmUpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbihjYWxsYmFjaywgcm9vdCkgewogICAgICAgICAgICByZXF1ZXN0RnJhbWUoY2FsbGJhY2ssIHJvb3QpOwogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHZhciBUQVJHRVRfRlBTID0gNjA7CiAgICAgICAgdmFyIHJlcXVlc3RzID0ge307CiAgICAgICAgdmFyIHJlcXVlc3RDb3VudCA9IDA7CiAgICAgICAgdmFyIHJhZkhhbmRsZSA9IDE7CiAgICAgICAgdmFyIGludGVydmFsSGFuZGxlID0gbnVsbDsKICAgICAgICB2YXIgbGFzdEFjdGl2ZSA9ICtuZXcgRGF0ZSgpOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FsbGJhY2ssIHJvb3QpIHsKICAgICAgICAgIHZhciBjYWxsYmFja0hhbmRsZSA9IHJhZkhhbmRsZSsrOwoKICAgICAgICAgIC8vIFN0b3JlIGNhbGxiYWNrCiAgICAgICAgICByZXF1ZXN0c1tjYWxsYmFja0hhbmRsZV0gPSBjYWxsYmFjazsKICAgICAgICAgIHJlcXVlc3RDb3VudCsrOwoKICAgICAgICAgIC8vIENyZWF0ZSB0aW1lb3V0IGF0IGZpcnN0IHJlcXVlc3QKICAgICAgICAgIGlmIChpbnRlcnZhbEhhbmRsZSA9PT0gbnVsbCkgewoKICAgICAgICAgICAgaW50ZXJ2YWxIYW5kbGUgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgdmFyIHRpbWUgPSArbmV3IERhdGUoKTsKICAgICAgICAgICAgICB2YXIgY3VycmVudFJlcXVlc3RzID0gcmVxdWVzdHM7CgogICAgICAgICAgICAgIC8vIFJlc2V0IGRhdGEgc3RydWN0dXJlIGJlZm9yZSBleGVjdXRpbmcgY2FsbGJhY2tzCiAgICAgICAgICAgICAgcmVxdWVzdHMgPSB7fTsKICAgICAgICAgICAgICByZXF1ZXN0Q291bnQgPSAwOwoKICAgICAgICAgICAgICBmb3IodmFyIGtleSBpbiBjdXJyZW50UmVxdWVzdHMpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50UmVxdWVzdHMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICBjdXJyZW50UmVxdWVzdHNba2V5XSh0aW1lKTsKICAgICAgICAgICAgICAgICAgbGFzdEFjdGl2ZSA9IHRpbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBEaXNhYmxlIHRoZSB0aW1lb3V0IHdoZW4gbm90aGluZyBoYXBwZW5zIGZvciBhIGNlcnRhaW4KICAgICAgICAgICAgICAvLyBwZXJpb2Qgb2YgdGltZQogICAgICAgICAgICAgIGlmICh0aW1lIC0gbGFzdEFjdGl2ZSA+IDI1MDApIHsKICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWxIYW5kbGUpOwogICAgICAgICAgICAgICAgaW50ZXJ2YWxIYW5kbGUgPSBudWxsOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0sIDEwMDAgLyBUQVJHRVRfRlBTKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gY2FsbGJhY2tIYW5kbGU7CiAgICAgICAgfTsKCiAgICAgIH0pKCksCgoKICAgICAgLyoqCiAgICAgICAqIFN0b3BzIHRoZSBnaXZlbiBhbmltYXRpb24uCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSBpZCB7SW50ZWdlcn0gVW5pcXVlIGFuaW1hdGlvbiBJRAogICAgICAgKiBAcmV0dXJuIHtCb29sZWFufSBXaGV0aGVyIHRoZSBhbmltYXRpb24gd2FzIHN0b3BwZWQgKGFrYSwgd2FzIHJ1bm5pbmcgYmVmb3JlKQogICAgICAgKi8KICAgICAgc3RvcDogZnVuY3Rpb24oaWQpIHsKICAgICAgICB2YXIgY2xlYXJlZCA9IHJ1bm5pbmdbaWRdICE9IG51bGw7CiAgICAgICAgaWYgKGNsZWFyZWQpIHsKICAgICAgICAgIHJ1bm5pbmdbaWRdID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBjbGVhcmVkOwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBXaGV0aGVyIHRoZSBnaXZlbiBhbmltYXRpb24gaXMgc3RpbGwgcnVubmluZy4KICAgICAgICoKICAgICAgICogQHBhcmFtIGlkIHtJbnRlZ2VyfSBVbmlxdWUgYW5pbWF0aW9uIElECiAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IFdoZXRoZXIgdGhlIGFuaW1hdGlvbiBpcyBzdGlsbCBydW5uaW5nCiAgICAgICAqLwogICAgICBpc1J1bm5pbmc6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgcmV0dXJuIHJ1bm5pbmdbaWRdICE9IG51bGw7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIFN0YXJ0IHRoZSBhbmltYXRpb24uCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSBzdGVwQ2FsbGJhY2sge0Z1bmN0aW9ufSBQb2ludGVyIHRvIGZ1bmN0aW9uIHdoaWNoIGlzIGV4ZWN1dGVkIG9uIGV2ZXJ5IHN0ZXAuCiAgICAgICAqICAgU2lnbmF0dXJlIG9mIHRoZSBtZXRob2Qgc2hvdWxkIGJlIGBmdW5jdGlvbihwZXJjZW50LCBub3csIHZpcnR1YWwpIHsgcmV0dXJuIGNvbnRpbnVlV2l0aEFuaW1hdGlvbjsgfWAKICAgICAgICogQHBhcmFtIHZlcmlmeUNhbGxiYWNrIHtGdW5jdGlvbn0gRXhlY3V0ZWQgYmVmb3JlIGV2ZXJ5IGFuaW1hdGlvbiBzdGVwLgogICAgICAgKiAgIFNpZ25hdHVyZSBvZiB0aGUgbWV0aG9kIHNob3VsZCBiZSBgZnVuY3Rpb24oKSB7IHJldHVybiBjb250aW51ZVdpdGhBbmltYXRpb247IH1gCiAgICAgICAqIEBwYXJhbSBjb21wbGV0ZWRDYWxsYmFjayB7RnVuY3Rpb259CiAgICAgICAqICAgU2lnbmF0dXJlIG9mIHRoZSBtZXRob2Qgc2hvdWxkIGJlIGBmdW5jdGlvbihkcm9wcGVkRnJhbWVzLCBmaW5pc2hlZEFuaW1hdGlvbikge31gCiAgICAgICAqIEBwYXJhbSBkdXJhdGlvbiB7SW50ZWdlcn0gTWlsbGlzZWNvbmRzIHRvIHJ1biB0aGUgYW5pbWF0aW9uCiAgICAgICAqIEBwYXJhbSBlYXNpbmdNZXRob2Qge0Z1bmN0aW9ufSBQb2ludGVyIHRvIGVhc2luZyBmdW5jdGlvbgogICAgICAgKiAgIFNpZ25hdHVyZSBvZiB0aGUgbWV0aG9kIHNob3VsZCBiZSBgZnVuY3Rpb24ocGVyY2VudCkgeyByZXR1cm4gbW9kaWZpZWRWYWx1ZTsgfWAKICAgICAgICogQHBhcmFtIHJvb3Qge0VsZW1lbnR9IFJlbmRlciByb290LCB3aGVuIGF2YWlsYWJsZS4gVXNlZCBmb3IgaW50ZXJuYWwKICAgICAgICogICB1c2FnZSBvZiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUuCiAgICAgICAqIEByZXR1cm4ge0ludGVnZXJ9IElkZW50aWZpZXIgb2YgYW5pbWF0aW9uLiBDYW4gYmUgdXNlZCB0byBzdG9wIGl0IGFueSB0aW1lLgogICAgICAgKi8KICAgICAgc3RhcnQ6IGZ1bmN0aW9uKHN0ZXBDYWxsYmFjaywgdmVyaWZ5Q2FsbGJhY2ssIGNvbXBsZXRlZENhbGxiYWNrLCBkdXJhdGlvbiwgZWFzaW5nTWV0aG9kLCByb290KSB7CgogICAgICAgIHZhciBzdGFydCA9IHRpbWUoKTsKICAgICAgICB2YXIgbGFzdEZyYW1lID0gc3RhcnQ7CiAgICAgICAgdmFyIHBlcmNlbnQgPSAwOwogICAgICAgIHZhciBkcm9wQ291bnRlciA9IDA7CiAgICAgICAgdmFyIGlkID0gY291bnRlcisrOwoKICAgICAgICBpZiAoIXJvb3QpIHsKICAgICAgICAgIHJvb3QgPSBkb2N1bWVudC5ib2R5OwogICAgICAgIH0KCiAgICAgICAgLy8gQ29tcGFjdGluZyBydW5uaW5nIGRiIGF1dG9tYXRpY2FsbHkgZXZlcnkgZmV3IG5ldyBhbmltYXRpb25zCiAgICAgICAgaWYgKGlkICUgMjAgPT09IDApIHsKICAgICAgICAgIHZhciBuZXdSdW5uaW5nID0ge307CiAgICAgICAgICBmb3IgKHZhciB1c2VkSWQgaW4gcnVubmluZykgewogICAgICAgICAgICBuZXdSdW5uaW5nW3VzZWRJZF0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcnVubmluZyA9IG5ld1J1bm5pbmc7CiAgICAgICAgfQoKICAgICAgICAvLyBUaGlzIGlzIHRoZSBpbnRlcm5hbCBzdGVwIG1ldGhvZCB3aGljaCBpcyBjYWxsZWQgZXZlcnkgZmV3IG1pbGxpc2Vjb25kcwogICAgICAgIHZhciBzdGVwID0gZnVuY3Rpb24odmlydHVhbCkgewoKICAgICAgICAgIC8vIE5vcm1hbGl6ZSB2aXJ0dWFsIHZhbHVlCiAgICAgICAgICB2YXIgcmVuZGVyID0gdmlydHVhbCAhPT0gdHJ1ZTsKCiAgICAgICAgICAvLyBHZXQgY3VycmVudCB0aW1lCiAgICAgICAgICB2YXIgbm93ID0gdGltZSgpOwoKICAgICAgICAgIC8vIFZlcmlmaWNhdGlvbiBpcyBleGVjdXRlZCBiZWZvcmUgbmV4dCBhbmltYXRpb24gc3RlcAogICAgICAgICAgaWYgKCFydW5uaW5nW2lkXSB8fCAodmVyaWZ5Q2FsbGJhY2sgJiYgIXZlcmlmeUNhbGxiYWNrKGlkKSkpIHsKCiAgICAgICAgICAgIHJ1bm5pbmdbaWRdID0gbnVsbDsKICAgICAgICAgICAgY29tcGxldGVkQ2FsbGJhY2sgJiYgY29tcGxldGVkQ2FsbGJhY2soZGVzaXJlZEZyYW1lcyAtIChkcm9wQ291bnRlciAvICgobm93IC0gc3RhcnQpIC8gbWlsbGlzZWNvbmRzUGVyU2Vjb25kKSksIGlkLCBmYWxzZSk7CiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICB9CgogICAgICAgICAgLy8gRm9yIHRoZSBjdXJyZW50IHJlbmRlcmluZyB0byBhcHBseSBsZXQncyB1cGRhdGUgb21pdHRlZCBzdGVwcyBpbiBtZW1vcnkuCiAgICAgICAgICAvLyBUaGlzIGlzIGltcG9ydGFudCB0byBicmluZyBpbnRlcm5hbCBzdGF0ZSB2YXJpYWJsZXMgdXAtdG8tZGF0ZSB3aXRoIHByb2dyZXNzIGluIHRpbWUuCiAgICAgICAgICBpZiAocmVuZGVyKSB7CgogICAgICAgICAgICB2YXIgZHJvcHBlZEZyYW1lcyA9IE1hdGgucm91bmQoKG5vdyAtIGxhc3RGcmFtZSkgLyAobWlsbGlzZWNvbmRzUGVyU2Vjb25kIC8gZGVzaXJlZEZyYW1lcykpIC0gMTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBNYXRoLm1pbihkcm9wcGVkRnJhbWVzLCA0KTsgaisrKSB7CiAgICAgICAgICAgICAgc3RlcCh0cnVlKTsKICAgICAgICAgICAgICBkcm9wQ291bnRlcisrOwogICAgICAgICAgICB9CgogICAgICAgICAgfQoKICAgICAgICAgIC8vIENvbXB1dGUgcGVyY2VudCB2YWx1ZQogICAgICAgICAgaWYgKGR1cmF0aW9uKSB7CiAgICAgICAgICAgIHBlcmNlbnQgPSAobm93IC0gc3RhcnQpIC8gZHVyYXRpb247CiAgICAgICAgICAgIGlmIChwZXJjZW50ID4gMSkgewogICAgICAgICAgICAgIHBlcmNlbnQgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gRXhlY3V0ZSBzdGVwIGNhbGxiYWNrLCB0aGVuLi4uCiAgICAgICAgICB2YXIgdmFsdWUgPSBlYXNpbmdNZXRob2QgPyBlYXNpbmdNZXRob2QocGVyY2VudCkgOiBwZXJjZW50OwogICAgICAgICAgaWYgKChzdGVwQ2FsbGJhY2sodmFsdWUsIG5vdywgcmVuZGVyKSA9PT0gZmFsc2UgfHwgcGVyY2VudCA9PT0gMSkgJiYgcmVuZGVyKSB7CiAgICAgICAgICAgIHJ1bm5pbmdbaWRdID0gbnVsbDsKICAgICAgICAgICAgY29tcGxldGVkQ2FsbGJhY2sgJiYgY29tcGxldGVkQ2FsbGJhY2soZGVzaXJlZEZyYW1lcyAtIChkcm9wQ291bnRlciAvICgobm93IC0gc3RhcnQpIC8gbWlsbGlzZWNvbmRzUGVyU2Vjb25kKSksIGlkLCBwZXJjZW50ID09PSAxIHx8IGR1cmF0aW9uID09IG51bGwpOwogICAgICAgICAgfSBlbHNlIGlmIChyZW5kZXIpIHsKICAgICAgICAgICAgbGFzdEZyYW1lID0gbm93OwogICAgICAgICAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHN0ZXAsIHJvb3QpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vIE1hcmsgYXMgcnVubmluZwogICAgICAgIHJ1bm5pbmdbaWRdID0gdHJ1ZTsKCiAgICAgICAgLy8gSW5pdCBmaXJzdCBzdGVwCiAgICAgICAgenluZ2FDb3JlLmVmZmVjdC5BbmltYXRlLnJlcXVlc3RBbmltYXRpb25GcmFtZShzdGVwLCByb290KTsKCiAgICAgICAgLy8gUmV0dXJuIHVuaXF1ZSBhbmltYXRpb24gSUQKICAgICAgICByZXR1cm4gaWQ7CiAgICAgIH0KICAgIH07CiAgfSkodGhpcyk7CgogIC8qCiAgICogU2Nyb2xsZXIKICAgKiBodHRwOi8vZ2l0aHViLmNvbS96eW5nYS9zY3JvbGxlcgogICAqCiAgICogQ29weXJpZ2h0IDIwMTEsIFp5bmdhIEluYy4KICAgKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuCiAgICogaHR0cHM6Ly9yYXcuZ2l0aHViLmNvbS96eW5nYS9zY3JvbGxlci9tYXN0ZXIvTUlULUxJQ0VOU0UudHh0CiAgICoKICAgKiBCYXNlZCBvbiB0aGUgd29yayBvZjogVW5pZnkgUHJvamVjdCAodW5pZnktcHJvamVjdC5vcmcpCiAgICogaHR0cDovL3VuaWZ5LXByb2plY3Qub3JnCiAgICogQ29weXJpZ2h0IDIwMTEsIERldXRzY2hlIFRlbGVrb20gQUcKICAgKiBMaWNlbnNlOiBNSVQgKyBBcGFjaGUgKFYyKQogICAqLwoKICB2YXIgU2Nyb2xsZXI7CgogIChmdW5jdGlvbihpb25pYykgewogICAgdmFyIE5PT1AgPSBmdW5jdGlvbigpe307CgogICAgLy8gRWFzaW5nIEVxdWF0aW9ucyAoYykgMjAwMyBSb2JlcnQgUGVubmVyLCBhbGwgcmlnaHRzIHJlc2VydmVkLgogICAgLy8gT3BlbiBzb3VyY2UgdW5kZXIgdGhlIEJTRCBMaWNlbnNlLgoKICAgIC8qKgogICAgICogQHBhcmFtIHBvcyB7TnVtYmVyfSBwb3NpdGlvbiBiZXR3ZWVuIDAgKHN0YXJ0IG9mIGVmZmVjdCkgYW5kIDEgKGVuZCBvZiBlZmZlY3QpCiAgICAgKiovCiAgICB2YXIgZWFzZU91dEN1YmljID0gZnVuY3Rpb24ocG9zKSB7CiAgICAgIHJldHVybiAoTWF0aC5wb3coKHBvcyAtIDEpLCAzKSArIDEpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBwYXJhbSBwb3Mge051bWJlcn0gcG9zaXRpb24gYmV0d2VlbiAwIChzdGFydCBvZiBlZmZlY3QpIGFuZCAxIChlbmQgb2YgZWZmZWN0KQogICAgICoqLwogICAgdmFyIGVhc2VJbk91dEN1YmljID0gZnVuY3Rpb24ocG9zKSB7CiAgICAgIGlmICgocG9zIC89IDAuNSkgPCAxKSB7CiAgICAgICAgcmV0dXJuIDAuNSAqIE1hdGgucG93KHBvcywgMyk7CiAgICAgIH0KCiAgICAgIHJldHVybiAwLjUgKiAoTWF0aC5wb3coKHBvcyAtIDIpLCAzKSArIDIpOwogICAgfTsKCgogICAgLyoqCiAgICAgKiBpb25pYy52aWV3cy5TY3JvbGwKICAgICAqIEEgcG93ZXJmdWwgc2Nyb2xsIHZpZXcgd2l0aCBzdXBwb3J0IGZvciBib3VuY2luZywgcHVsbCB0byByZWZyZXNoLCBhbmQgcGFnaW5nLgogICAgICogQHBhcmFtICAge09iamVjdH0gICAgICAgIG9wdGlvbnMgb3B0aW9ucyBmb3IgdGhlIHNjcm9sbCB2aWV3CiAgICAgKiBAY2xhc3MgQSBzY3JvbGwgdmlldyBzeXN0ZW0KICAgICAqIEBtZW1iZXJvZiBpb25pYy52aWV3cwogICAgICovCiAgICBpb25pYy52aWV3cy5TY3JvbGwgPSBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQoewogICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICB0aGlzLl9fY29udGFpbmVyID0gb3B0aW9ucy5lbDsKICAgICAgICB0aGlzLl9fY29udGVudCA9IG9wdGlvbnMuZWwuZmlyc3RFbGVtZW50Q2hpbGQ7CgogICAgICAgIC8vUmVtb3ZlIGFueSBzY3JvbGxUb3AgYXR0YWNoZWQgdG8gdGhlc2UgZWxlbWVudHM7IHRoZXkgYXJlIHZpcnR1YWwgc2Nyb2xsIG5vdwogICAgICAgIC8vVGhpcyBhbHNvIHN0b3BzIG9uLWxvYWQtc2Nyb2xsLXRvLXdpbmRvdy5sb2NhdGlvbi5oYXNoIHRoYXQgdGhlIGJyb3dzZXIgZG9lcwogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoc2VsZi5fX2NvbnRhaW5lciAmJiBzZWxmLl9fY29udGVudCkgewogICAgICAgICAgICBzZWxmLl9fY29udGFpbmVyLnNjcm9sbFRvcCA9IDA7CiAgICAgICAgICAgIHNlbGYuX19jb250ZW50LnNjcm9sbFRvcCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMub3B0aW9ucyA9IHsKCiAgICAgICAgICAvKiogRGlzYWJsZSBzY3JvbGxpbmcgb24geC1heGlzIGJ5IGRlZmF1bHQgKi8KICAgICAgICAgIHNjcm9sbGluZ1g6IGZhbHNlLAogICAgICAgICAgc2Nyb2xsYmFyWDogdHJ1ZSwKCiAgICAgICAgICAvKiogRW5hYmxlIHNjcm9sbGluZyBvbiB5LWF4aXMgKi8KICAgICAgICAgIHNjcm9sbGluZ1k6IHRydWUsCiAgICAgICAgICBzY3JvbGxiYXJZOiB0cnVlLAoKICAgICAgICAgIHN0YXJ0WDogMCwKICAgICAgICAgIHN0YXJ0WTogMCwKCiAgICAgICAgICAvKiogVGhlIGFtb3VudCB0byBkYW1wZW4gbW91c2V3aGVlbCBldmVudHMgKi8KICAgICAgICAgIHdoZWVsRGFtcGVuOiA2LAoKICAgICAgICAgIC8qKiBUaGUgbWluaW11bSBzaXplIHRoZSBzY3JvbGxiYXJzIHNjYWxlIHRvIHdoaWxlIHNjcm9sbGluZyAqLwogICAgICAgICAgbWluU2Nyb2xsYmFyU2l6ZVg6IDUsCiAgICAgICAgICBtaW5TY3JvbGxiYXJTaXplWTogNSwKCiAgICAgICAgICAvKiogU2Nyb2xsYmFyIGZhZGluZyBhZnRlciBzY3JvbGxpbmcgKi8KICAgICAgICAgIHNjcm9sbGJhcnNGYWRlOiB0cnVlLAogICAgICAgICAgc2Nyb2xsYmFyRmFkZURlbGF5OiAzMDAsCiAgICAgICAgICAvKiogVGhlIGluaXRpYWwgZmFkZSBkZWxheSB3aGVuIHRoZSBwYW5lIGlzIHJlc2l6ZWQgb3IgaW5pdGlhbGl6ZWQgKi8KICAgICAgICAgIHNjcm9sbGJhclJlc2l6ZUZhZGVEZWxheTogMTAwMCwKCiAgICAgICAgICAvKiogRW5hYmxlIGFuaW1hdGlvbnMgZm9yIGRlY2VsZXJhdGlvbiwgc25hcCBiYWNrLCB6b29taW5nIGFuZCBzY3JvbGxpbmcgKi8KICAgICAgICAgIGFuaW1hdGluZzogdHJ1ZSwKCiAgICAgICAgICAvKiogZHVyYXRpb24gZm9yIGFuaW1hdGlvbnMgdHJpZ2dlcmVkIGJ5IHNjcm9sbFRvL3pvb21UbyAqLwogICAgICAgICAgYW5pbWF0aW9uRHVyYXRpb246IDI1MCwKCiAgICAgICAgICAvKiogRW5hYmxlIGJvdW5jaW5nIChjb250ZW50IGNhbiBiZSBzbG93bHkgbW92ZWQgb3V0c2lkZSBhbmQganVtcHMgYmFjayBhZnRlciByZWxlYXNpbmcpICovCiAgICAgICAgICBib3VuY2luZzogdHJ1ZSwKCiAgICAgICAgICAvKiogRW5hYmxlIGxvY2tpbmcgdG8gdGhlIG1haW4gYXhpcyBpZiB1c2VyIG1vdmVzIG9ubHkgc2xpZ2h0bHkgb24gb25lIG9mIHRoZW0gYXQgc3RhcnQgKi8KICAgICAgICAgIGxvY2tpbmc6IHRydWUsCgogICAgICAgICAgLyoqIEVuYWJsZSBwYWdpbmF0aW9uIG1vZGUgKHN3aXRjaGluZyBiZXR3ZWVuIGZ1bGwgcGFnZSBjb250ZW50IHBhbmVzKSAqLwogICAgICAgICAgcGFnaW5nOiBmYWxzZSwKCiAgICAgICAgICAvKiogRW5hYmxlIHNuYXBwaW5nIG9mIGNvbnRlbnQgdG8gYSBjb25maWd1cmVkIHBpeGVsIGdyaWQgKi8KICAgICAgICAgIHNuYXBwaW5nOiBmYWxzZSwKCiAgICAgICAgICAvKiogRW5hYmxlIHpvb21pbmcgb2YgY29udGVudCB2aWEgQVBJLCBmaW5nZXJzIGFuZCBtb3VzZSB3aGVlbCAqLwogICAgICAgICAgem9vbWluZzogZmFsc2UsCgogICAgICAgICAgLyoqIE1pbmltdW0gem9vbSBsZXZlbCAqLwogICAgICAgICAgbWluWm9vbTogMC41LAoKICAgICAgICAgIC8qKiBNYXhpbXVtIHpvb20gbGV2ZWwgKi8KICAgICAgICAgIG1heFpvb206IDMsCgogICAgICAgICAgLyoqIE11bHRpcGx5IG9yIGRlY3JlYXNlIHNjcm9sbGluZyBzcGVlZCAqKi8KICAgICAgICAgIHNwZWVkTXVsdGlwbGllcjogMSwKCiAgICAgICAgICBkZWNlbGVyYXRpb246IDAuOTcsCgogICAgICAgICAgLyoqIENhbGxiYWNrIHRoYXQgaXMgZmlyZWQgb24gdGhlIGxhdGVyIG9mIHRvdWNoIGVuZCBvciBkZWNlbGVyYXRpb24gZW5kLAogICAgICAgICAgIHByb3ZpZGVkIHRoYXQgYW5vdGhlciBzY3JvbGxpbmcgYWN0aW9uIGhhcyBub3QgYmVndW4uIFVzZWQgdG8ga25vdwogICAgICAgICAgIHdoZW4gdG8gZmFkZSBvdXQgYSBzY3JvbGxiYXIuICovCiAgICAgICAgICBzY3JvbGxpbmdDb21wbGV0ZTogTk9PUCwKCiAgICAgICAgICAvKiogVGhpcyBjb25maWd1cmVzIHRoZSBhbW91bnQgb2YgY2hhbmdlIGFwcGxpZWQgdG8gZGVjZWxlcmF0aW9uIHdoZW4gcmVhY2hpbmcgYm91bmRhcmllcyAgKiovCiAgICAgICAgICBwZW5ldHJhdGlvbkRlY2VsZXJhdGlvbiA6IDAuMDMsCgogICAgICAgICAgLyoqIFRoaXMgY29uZmlndXJlcyB0aGUgYW1vdW50IG9mIGNoYW5nZSBhcHBsaWVkIHRvIGFjY2VsZXJhdGlvbiB3aGVuIHJlYWNoaW5nIGJvdW5kYXJpZXMgICoqLwogICAgICAgICAgcGVuZXRyYXRpb25BY2NlbGVyYXRpb24gOiAwLjA4LAoKICAgICAgICAgIC8vIFRoZSBtcyBpbnRlcnZhbCBmb3IgdHJpZ2dlcmluZyBzY3JvbGwgZXZlbnRzCiAgICAgICAgICBzY3JvbGxFdmVudEludGVydmFsOiAxMCwKCiAgICAgICAgICBnZXRDb250ZW50V2lkdGg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgoc2VsZi5fX2NvbnRlbnQuc2Nyb2xsV2lkdGgsIHNlbGYuX19jb250ZW50Lm9mZnNldFdpZHRoKTsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXRDb250ZW50SGVpZ2h0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGgubWF4KHNlbGYuX19jb250ZW50LnNjcm9sbEhlaWdodCwgc2VsZi5fX2NvbnRlbnQub2Zmc2V0SGVpZ2h0ICsgc2VsZi5fX2NvbnRlbnQub2Zmc2V0VG9wKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb3B0aW9ucykgewogICAgICAgICAgdGhpcy5vcHRpb25zW2tleV0gPSBvcHRpb25zW2tleV07CiAgICAgICAgfQoKICAgICAgICB0aGlzLmhpbnRSZXNpemUgPSBpb25pYy5kZWJvdW5jZShmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYucmVzaXplKCk7CiAgICAgICAgfSwgMTAwMCwgdHJ1ZSk7CgogICAgICAgIHRoaXMub25TY3JvbGwgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICBpZighaW9uaWMuc2Nyb2xsLmlzU2Nyb2xsaW5nKSB7CiAgICAgICAgICAgIHNldFRpbWVvdXQoc2VsZi5zZXRTY3JvbGxTdGFydCwgNTApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHNlbGYuc2Nyb2xsVGltZXIpOwogICAgICAgICAgICBzZWxmLnNjcm9sbFRpbWVyID0gc2V0VGltZW91dChzZWxmLnNldFNjcm9sbFN0b3AsIDgwKTsKICAgICAgICAgIH0KCiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5zZXRTY3JvbGxTdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaW9uaWMuc2Nyb2xsLmlzU2Nyb2xsaW5nID0gTWF0aC5hYnMoaW9uaWMuc2Nyb2xsLmxhc3RUb3AgLSBzZWxmLl9fc2Nyb2xsVG9wKSA+IDE7CiAgICAgICAgICBjbGVhclRpbWVvdXQoc2VsZi5zY3JvbGxUaW1lcik7CiAgICAgICAgICBzZWxmLnNjcm9sbFRpbWVyID0gc2V0VGltZW91dChzZWxmLnNldFNjcm9sbFN0b3AsIDgwKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnNldFNjcm9sbFN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlvbmljLnNjcm9sbC5pc1Njcm9sbGluZyA9IGZhbHNlOwogICAgICAgICAgaW9uaWMuc2Nyb2xsLmxhc3RUb3AgPSBzZWxmLl9fc2Nyb2xsVG9wOwogICAgICAgIH07CgogICAgICAgIHRoaXMudHJpZ2dlclNjcm9sbEV2ZW50ID0gaW9uaWMudGhyb3R0bGUoZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxmLm9uU2Nyb2xsKCk7CiAgICAgICAgICBpb25pYy50cmlnZ2VyKCdzY3JvbGwnLCB7CiAgICAgICAgICAgIHNjcm9sbFRvcDogc2VsZi5fX3Njcm9sbFRvcCwKICAgICAgICAgICAgc2Nyb2xsTGVmdDogc2VsZi5fX3Njcm9sbExlZnQsCiAgICAgICAgICAgIHRhcmdldDogc2VsZi5fX2NvbnRhaW5lcgogICAgICAgICAgfSk7CiAgICAgICAgfSwgdGhpcy5vcHRpb25zLnNjcm9sbEV2ZW50SW50ZXJ2YWwpOwoKICAgICAgICB0aGlzLnRyaWdnZXJTY3JvbGxFbmRFdmVudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaW9uaWMudHJpZ2dlcignc2Nyb2xsZW5kJywgewogICAgICAgICAgICBzY3JvbGxUb3A6IHNlbGYuX19zY3JvbGxUb3AsCiAgICAgICAgICAgIHNjcm9sbExlZnQ6IHNlbGYuX19zY3JvbGxMZWZ0LAogICAgICAgICAgICB0YXJnZXQ6IHNlbGYuX19jb250YWluZXIKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHRoaXMuX19zY3JvbGxMZWZ0ID0gdGhpcy5vcHRpb25zLnN0YXJ0WDsKICAgICAgICB0aGlzLl9fc2Nyb2xsVG9wID0gdGhpcy5vcHRpb25zLnN0YXJ0WTsKCiAgICAgICAgLy8gR2V0IHRoZSByZW5kZXIgdXBkYXRlIGZ1bmN0aW9uLCBpbml0aWFsaXplIGV2ZW50IGhhbmRsZXJzLAogICAgICAgIC8vIGFuZCBjYWxjdWxhdGUgdGhlIHNpemUgb2YgdGhlIHNjcm9sbCBjb250YWluZXIKICAgICAgICB0aGlzLl9fY2FsbGJhY2sgPSB0aGlzLmdldFJlbmRlckZuKCk7CiAgICAgICAgdGhpcy5fX2luaXRFdmVudEhhbmRsZXJzKCk7CiAgICAgICAgdGhpcy5fX2NyZWF0ZVNjcm9sbGJhcnMoKTsKCiAgICAgIH0sCgogICAgICBydW46IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucmVzaXplKCk7CgogICAgICAgIC8vIEZhZGUgdGhlbSBvdXQKICAgICAgICB0aGlzLl9fZmFkZVNjcm9sbGJhcnMoJ291dCcsIHRoaXMub3B0aW9ucy5zY3JvbGxiYXJSZXNpemVGYWRlRGVsYXkpOwogICAgICB9LAoKCgogICAgICAvKgogICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICBJTlRFUk5BTCBGSUVMRFMgOjogU1RBVFVTCiAgICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICovCgogICAgICAvKiogV2hldGhlciBvbmx5IGEgc2luZ2xlIGZpbmdlciBpcyB1c2VkIGluIHRvdWNoIGhhbmRsaW5nICovCiAgICAgIF9faXNTaW5nbGVUb3VjaDogZmFsc2UsCgogICAgICAvKiogV2hldGhlciBhIHRvdWNoIGV2ZW50IHNlcXVlbmNlIGlzIGluIHByb2dyZXNzICovCiAgICAgIF9faXNUcmFja2luZzogZmFsc2UsCgogICAgICAvKiogV2hldGhlciBhIGRlY2VsZXJhdGlvbiBhbmltYXRpb24gd2VudCB0byBjb21wbGV0aW9uLiAqLwogICAgICBfX2RpZERlY2VsZXJhdGlvbkNvbXBsZXRlOiBmYWxzZSwKCiAgICAgIC8qKgogICAgICAgKiBXaGV0aGVyIGEgZ2VzdHVyZSB6b29tL3JvdGF0ZSBldmVudCBpcyBpbiBwcm9ncmVzcy4gQWN0aXZhdGVzIHdoZW4KICAgICAgICogYSBnZXN0dXJlc3RhcnQgZXZlbnQgaGFwcGVucy4gVGhpcyBoYXMgaGlnaGVyIHByaW9yaXR5IHRoYW4gZHJhZ2dpbmcuCiAgICAgICAqLwogICAgICBfX2lzR2VzdHVyaW5nOiBmYWxzZSwKCiAgICAgIC8qKgogICAgICAgKiBXaGV0aGVyIHRoZSB1c2VyIGhhcyBtb3ZlZCBieSBzdWNoIGEgZGlzdGFuY2UgdGhhdCB3ZSBoYXZlIGVuYWJsZWQKICAgICAgICogZHJhZ2dpbmcgbW9kZS4gSGludDogSXQncyBvbmx5IGVuYWJsZWQgYWZ0ZXIgc29tZSBwaXhlbHMgb2YgbW92ZW1lbnQgdG8KICAgICAgICogbm90IGludGVycnVwdCB3aXRoIGNsaWNrcyBldGMuCiAgICAgICAqLwogICAgICBfX2lzRHJhZ2dpbmc6IGZhbHNlLAoKICAgICAgLyoqCiAgICAgICAqIE5vdCB0b3VjaGluZyBhbmQgZHJhZ2dpbmcgYW55bW9yZSwgYW5kIHNtb290aGx5IGFuaW1hdGluZyB0aGUKICAgICAgICogdG91Y2ggc2VxdWVuY2UgdXNpbmcgZGVjZWxlcmF0aW9uLgogICAgICAgKi8KICAgICAgX19pc0RlY2VsZXJhdGluZzogZmFsc2UsCgogICAgICAvKioKICAgICAgICogU21vb3RobHkgYW5pbWF0aW5nIHRoZSBjdXJyZW50bHkgY29uZmlndXJlZCBjaGFuZ2UKICAgICAgICovCiAgICAgIF9faXNBbmltYXRpbmc6IGZhbHNlLAoKCgogICAgICAvKgogICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICBJTlRFUk5BTCBGSUVMRFMgOjogRElNRU5TSU9OUwogICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAqLwoKICAgICAgLyoqIEF2YWlsYWJsZSBvdXRlciBsZWZ0IHBvc2l0aW9uIChmcm9tIGRvY3VtZW50IHBlcnNwZWN0aXZlKSAqLwogICAgICBfX2NsaWVudExlZnQ6IDAsCgogICAgICAvKiogQXZhaWxhYmxlIG91dGVyIHRvcCBwb3NpdGlvbiAoZnJvbSBkb2N1bWVudCBwZXJzcGVjdGl2ZSkgKi8KICAgICAgX19jbGllbnRUb3A6IDAsCgogICAgICAvKiogQXZhaWxhYmxlIG91dGVyIHdpZHRoICovCiAgICAgIF9fY2xpZW50V2lkdGg6IDAsCgogICAgICAvKiogQXZhaWxhYmxlIG91dGVyIGhlaWdodCAqLwogICAgICBfX2NsaWVudEhlaWdodDogMCwKCiAgICAgIC8qKiBPdXRlciB3aWR0aCBvZiBjb250ZW50ICovCiAgICAgIF9fY29udGVudFdpZHRoOiAwLAoKICAgICAgLyoqIE91dGVyIGhlaWdodCBvZiBjb250ZW50ICovCiAgICAgIF9fY29udGVudEhlaWdodDogMCwKCiAgICAgIC8qKiBTbmFwcGluZyB3aWR0aCBmb3IgY29udGVudCAqLwogICAgICBfX3NuYXBXaWR0aDogMTAwLAoKICAgICAgLyoqIFNuYXBwaW5nIGhlaWdodCBmb3IgY29udGVudCAqLwogICAgICBfX3NuYXBIZWlnaHQ6IDEwMCwKCiAgICAgIC8qKiBIZWlnaHQgdG8gYXNzaWduIHRvIHJlZnJlc2ggYXJlYSAqLwogICAgICBfX3JlZnJlc2hIZWlnaHQ6IG51bGwsCgogICAgICAvKiogV2hldGhlciB0aGUgcmVmcmVzaCBwcm9jZXNzIGlzIGVuYWJsZWQgd2hlbiB0aGUgZXZlbnQgaXMgcmVsZWFzZWQgbm93ICovCiAgICAgIF9fcmVmcmVzaEFjdGl2ZTogZmFsc2UsCgogICAgICAvKiogQ2FsbGJhY2sgdG8gZXhlY3V0ZSBvbiBhY3RpdmF0aW9uLiBUaGlzIGlzIGZvciBzaWduYWxsaW5nIHRoZSB1c2VyIGFib3V0IGEgcmVmcmVzaCBpcyBhYm91dCB0byBoYXBwZW4gd2hlbiBoZSByZWxlYXNlICovCiAgICAgIF9fcmVmcmVzaEFjdGl2YXRlOiBudWxsLAoKICAgICAgLyoqIENhbGxiYWNrIHRvIGV4ZWN1dGUgb24gZGVhY3RpdmF0aW9uLiBUaGlzIGlzIGZvciBzaWduYWxsaW5nIHRoZSB1c2VyIGFib3V0IHRoZSByZWZyZXNoIGJlaW5nIGNhbmNlbGxlZCAqLwogICAgICBfX3JlZnJlc2hEZWFjdGl2YXRlOiBudWxsLAoKICAgICAgLyoqIENhbGxiYWNrIHRvIGV4ZWN1dGUgdG8gc3RhcnQgdGhlIGFjdHVhbCByZWZyZXNoLiBDYWxsIHtAbGluayAjcmVmcmVzaEZpbmlzaH0gd2hlbiBkb25lICovCiAgICAgIF9fcmVmcmVzaFN0YXJ0OiBudWxsLAoKICAgICAgLyoqIFpvb20gbGV2ZWwgKi8KICAgICAgX196b29tTGV2ZWw6IDEsCgogICAgICAvKiogU2Nyb2xsIHBvc2l0aW9uIG9uIHgtYXhpcyAqLwogICAgICBfX3Njcm9sbExlZnQ6IDAsCgogICAgICAvKiogU2Nyb2xsIHBvc2l0aW9uIG9uIHktYXhpcyAqLwogICAgICBfX3Njcm9sbFRvcDogMCwKCiAgICAgIC8qKiBNYXhpbXVtIGFsbG93ZWQgc2Nyb2xsIHBvc2l0aW9uIG9uIHgtYXhpcyAqLwogICAgICBfX21heFNjcm9sbExlZnQ6IDAsCgogICAgICAvKiogTWF4aW11bSBhbGxvd2VkIHNjcm9sbCBwb3NpdGlvbiBvbiB5LWF4aXMgKi8KICAgICAgX19tYXhTY3JvbGxUb3A6IDAsCgogICAgICAvKiBTY2hlZHVsZWQgbGVmdCBwb3NpdGlvbiAoZmluYWwgcG9zaXRpb24gd2hlbiBhbmltYXRpbmcpICovCiAgICAgIF9fc2NoZWR1bGVkTGVmdDogMCwKCiAgICAgIC8qIFNjaGVkdWxlZCB0b3AgcG9zaXRpb24gKGZpbmFsIHBvc2l0aW9uIHdoZW4gYW5pbWF0aW5nKSAqLwogICAgICBfX3NjaGVkdWxlZFRvcDogMCwKCiAgICAgIC8qIFNjaGVkdWxlZCB6b29tIGxldmVsIChmaW5hbCBzY2FsZSB3aGVuIGFuaW1hdGluZykgKi8KICAgICAgX19zY2hlZHVsZWRab29tOiAwLAoKCgogICAgICAvKgogICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICBJTlRFUk5BTCBGSUVMRFMgOjogTEFTVCBQT1NJVElPTlMKICAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgKi8KCiAgICAgIC8qKiBMZWZ0IHBvc2l0aW9uIG9mIGZpbmdlciBhdCBzdGFydCAqLwogICAgICBfX2xhc3RUb3VjaExlZnQ6IG51bGwsCgogICAgICAvKiogVG9wIHBvc2l0aW9uIG9mIGZpbmdlciBhdCBzdGFydCAqLwogICAgICBfX2xhc3RUb3VjaFRvcDogbnVsbCwKCiAgICAgIC8qKiBUaW1lc3RhbXAgb2YgbGFzdCBtb3ZlIG9mIGZpbmdlci4gVXNlZCB0byBsaW1pdCB0cmFja2luZyByYW5nZSBmb3IgZGVjZWxlcmF0aW9uIHNwZWVkLiAqLwogICAgICBfX2xhc3RUb3VjaE1vdmU6IG51bGwsCgogICAgICAvKiogTGlzdCBvZiBwb3NpdGlvbnMsIHVzZXMgdGhyZWUgaW5kZXhlcyBmb3IgZWFjaCBzdGF0ZTogbGVmdCwgdG9wLCB0aW1lc3RhbXAgKi8KICAgICAgX19wb3NpdGlvbnM6IG51bGwsCgoKCiAgICAgIC8qCiAgICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgIElOVEVSTkFMIEZJRUxEUyA6OiBERUNFTEVSQVRJT04gU1VQUE9SVAogICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAqLwoKICAgICAgLyoqIE1pbmltdW0gbGVmdCBzY3JvbGwgcG9zaXRpb24gZHVyaW5nIGRlY2VsZXJhdGlvbiAqLwogICAgICBfX21pbkRlY2VsZXJhdGlvblNjcm9sbExlZnQ6IG51bGwsCgogICAgICAvKiogTWluaW11bSB0b3Agc2Nyb2xsIHBvc2l0aW9uIGR1cmluZyBkZWNlbGVyYXRpb24gKi8KICAgICAgX19taW5EZWNlbGVyYXRpb25TY3JvbGxUb3A6IG51bGwsCgogICAgICAvKiogTWF4aW11bSBsZWZ0IHNjcm9sbCBwb3NpdGlvbiBkdXJpbmcgZGVjZWxlcmF0aW9uICovCiAgICAgIF9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsTGVmdDogbnVsbCwKCiAgICAgIC8qKiBNYXhpbXVtIHRvcCBzY3JvbGwgcG9zaXRpb24gZHVyaW5nIGRlY2VsZXJhdGlvbiAqLwogICAgICBfX21heERlY2VsZXJhdGlvblNjcm9sbFRvcDogbnVsbCwKCiAgICAgIC8qKiBDdXJyZW50IGZhY3RvciB0byBtb2RpZnkgaG9yaXpvbnRhbCBzY3JvbGwgcG9zaXRpb24gd2l0aCBvbiBldmVyeSBzdGVwICovCiAgICAgIF9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYOiBudWxsLAoKICAgICAgLyoqIEN1cnJlbnQgZmFjdG9yIHRvIG1vZGlmeSB2ZXJ0aWNhbCBzY3JvbGwgcG9zaXRpb24gd2l0aCBvbiBldmVyeSBzdGVwICovCiAgICAgIF9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZOiBudWxsLAoKCiAgICAgIC8qKiB0aGUgYnJvd3Nlci1zcGVjaWZpYyBwcm9wZXJ0eSB0byB1c2UgZm9yIHRyYW5zZm9ybXMgKi8KICAgICAgX190cmFuc2Zvcm1Qcm9wZXJ0eTogbnVsbCwKICAgICAgX19wZXJzcGVjdGl2ZVByb3BlcnR5OiBudWxsLAoKICAgICAgLyoqIHNjcm9sbGJhciBpbmRpY2F0b3JzICovCiAgICAgIF9faW5kaWNhdG9yWDogbnVsbCwKICAgICAgX19pbmRpY2F0b3JZOiBudWxsLAoKICAgICAgLyoqIFRpbWVvdXQgZm9yIHNjcm9sbGJhciBmYWRpbmcgKi8KICAgICAgX19zY3JvbGxiYXJGYWRlVGltZW91dDogbnVsbCwKCiAgICAgIC8qKiB3aGV0aGVyIHdlJ3ZlIHRyaWVkIHRvIHdhaXQgZm9yIHNpemUgYWxyZWFkeSAqLwogICAgICBfX2RpZFdhaXRGb3JTaXplOiBudWxsLAogICAgICBfX3NpemVyVGltZW91dDogbnVsbCwKCiAgICAgIF9faW5pdEV2ZW50SGFuZGxlcnM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgLy8gRXZlbnQgSGFuZGxlcgogICAgICAgIHZhciBjb250YWluZXIgPSB0aGlzLl9fY29udGFpbmVyOwoKICAgICAgICAvL0Jyb2FkY2FzdGVkIHdoZW4ga2V5Ym9hcmQgaXMgc2hvd24gb24gc29tZSBwbGF0Zm9ybXMuCiAgICAgICAgLy9TZWUganMvdXRpbHMva2V5Ym9hcmQuanMKICAgICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsQ2hpbGRJbnRvVmlldycsIGZ1bmN0aW9uKGUpIHsKCiAgICAgICAgICAvL2Rpc3RhbmNlIGZyb20gYm90dG9tIG9mIHNjcm9sbHZpZXcgdG8gdG9wIG9mIHZpZXdwb3J0CiAgICAgICAgICB2YXIgc2Nyb2xsQm90dG9tT2Zmc2V0VG9Ub3A7CgogICAgICAgICAgaWYoICFzZWxmLmlzU2Nyb2xsZWRJbnRvVmlldyApIHsKICAgICAgICAgICAgLy8gc2hyaW5rIHNjcm9sbHZpZXcgc28gd2UgY2FuIGFjdHVhbGx5IHNjcm9sbCBpZiB0aGUgaW5wdXQgaXMgaGlkZGVuCiAgICAgICAgICAgIC8vIGlmIGl0IGlzbid0IHNocmluayBzbyB3ZSBjYW4gc2Nyb2xsIHRvIGlucHV0cyB1bmRlciB0aGUga2V5Ym9hcmQKICAgICAgICAgICAgaWYgKGlvbmljLlBsYXRmb3JtLmlzSU9TKCkgfHwgaW9uaWMuUGxhdGZvcm0uaXNGdWxsU2NyZWVuKXsKICAgICAgICAgICAgICAvLyBpZiB0aGVyZSBhcmUgdGhpbmdzIGJlbG93IHRoZSBzY3JvbGwgdmlldyBhY2NvdW50IGZvciB0aGVtIGFuZAogICAgICAgICAgICAgIC8vIHN1YnRyYWN0IHRoZW0gZnJvbSB0aGUga2V5Ym9hcmQgaGVpZ2h0IHdoZW4gcmVzaXppbmcKICAgICAgICAgICAgICBzY3JvbGxCb3R0b21PZmZzZXRUb1RvcCA9IGNvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b207CiAgICAgICAgICAgICAgdmFyIHNjcm9sbEJvdHRvbU9mZnNldFRvQm90dG9tID0gZS5kZXRhaWwudmlld3BvcnRIZWlnaHQgLSBzY3JvbGxCb3R0b21PZmZzZXRUb1RvcDsKICAgICAgICAgICAgICB2YXIga2V5Ym9hcmRPZmZzZXQgPSBNYXRoLm1heCgwLCBlLmRldGFpbC5rZXlib2FyZEhlaWdodCAtIHNjcm9sbEJvdHRvbU9mZnNldFRvQm90dG9tKTsKICAgICAgICAgICAgICBjb250YWluZXIuc3R5bGUuaGVpZ2h0ID0gKGNvbnRhaW5lci5jbGllbnRIZWlnaHQgLSBrZXlib2FyZE9mZnNldCkgKyAicHgiOwogICAgICAgICAgICAgIGNvbnRhaW5lci5zdHlsZS5vdmVyZmxvdyA9ICJ2aXNpYmxlIjsKICAgICAgICAgICAgICAvL3VwZGF0ZSBzY3JvbGwgdmlldwogICAgICAgICAgICAgIHNlbGYucmVzaXplKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZi5pc1Njcm9sbGVkSW50b1ZpZXcgPSB0cnVlOwogICAgICAgICAgfQoKICAgICAgICAgIC8vSWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZCB1bmRlciB0aGUga2V5Ym9hcmQuLi4KICAgICAgICAgIGlmKCBlLmRldGFpbC5pc0VsZW1lbnRVbmRlcktleWJvYXJkICkgewogICAgICAgICAgICB2YXIgZGVsYXk7CiAgICAgICAgICAgIC8vIFdhaXQgb24gYW5kcm9pZCBmb3Igd2ViIHZpZXcgdG8gcmVzaXplCiAgICAgICAgICAgIGlmICggaW9uaWMuUGxhdGZvcm0uaXNBbmRyb2lkKCkgJiYgIWlvbmljLlBsYXRmb3JtLmlzRnVsbFNjcmVlbiApIHsKICAgICAgICAgICAgICAvLyBhbmRyb2lkIHkgdSByZXNpemUgc28gc2xvdwogICAgICAgICAgICAgIGlmICggaW9uaWMuUGxhdGZvcm0udmVyc2lvbigpIDwgNC40KSB7CiAgICAgICAgICAgICAgICBkZWxheSA9IDUwMDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gcHJvYmFibHkgb3ZlcmtpbGwgZm9yIGNocm9tZQogICAgICAgICAgICAgICAgZGVsYXkgPSAzNTA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlbGF5ID0gODA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vUHV0IGVsZW1lbnQgaW4gbWlkZGxlIG9mIHZpc2libGUgc2NyZWVuCiAgICAgICAgICAgIC8vV2FpdCBmb3IgYW5kcm9pZCB0byB1cGRhdGUgdmlldyBoZWlnaHQgYW5kIHJlc2l6ZSgpIHRvIHJlc2V0IHNjcm9sbCBwb3NpdGlvbgogICAgICAgICAgICBpb25pYy5zY3JvbGwuaXNTY3JvbGxpbmcgPSB0cnVlOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgLy9taWRkbGUgb2YgdGhlIHNjcm9sbHZpZXcsIHdoZXJlIHdlIHdhbnQgdG8gc2Nyb2xsIHRvCiAgICAgICAgICAgICAgdmFyIHNjcm9sbE1pZHBvaW50T2Zmc2V0ID0gY29udGFpbmVyLmNsaWVudEhlaWdodCAqIDAuNTsKCiAgICAgICAgICAgICAgc2Nyb2xsQm90dG9tT2Zmc2V0VG9Ub3AgPSBjb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tOwogICAgICAgICAgICAgIC8vZGlzdGFuY2UgZnJvbSB0b3Agb2YgZm9jdXNlZCBlbGVtZW50IHRvIHRoZSBib3R0b20gb2YgdGhlIHNjcm9sbCB2aWV3CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUb3BPZmZzZXRUb1Njcm9sbEJvdHRvbSA9IGUuZGV0YWlsLmVsZW1lbnRUb3AgLSBzY3JvbGxCb3R0b21PZmZzZXRUb1RvcDsKCiAgICAgICAgICAgICAgdmFyIHNjcm9sbFRvcCA9IGVsZW1lbnRUb3BPZmZzZXRUb1Njcm9sbEJvdHRvbSAgKyBzY3JvbGxNaWRwb2ludE9mZnNldDsKCiAgICAgICAgICAgICAgaWYgKHNjcm9sbFRvcCA+IDApewogICAgICAgICAgICAgICAgaW9uaWMudGFwLmNsb25lRm9jdXNlZElucHV0KGNvbnRhaW5lciwgc2VsZik7CiAgICAgICAgICAgICAgICBzZWxmLnNjcm9sbEJ5KDAsIHNjcm9sbFRvcCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICBzZWxmLm9uU2Nyb2xsKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBkZWxheSk7CiAgICAgICAgICB9CgogICAgICAgICAgLy9Pbmx5IHRoZSBmaXJzdCBzY3JvbGxWaWV3IHBhcmVudCBvZiB0aGUgZWxlbWVudCB0aGF0IGJyb2FkY2FzdGVkIHRoaXMgZXZlbnQKICAgICAgICAgIC8vKHRoZSBhY3RpdmUgZWxlbWVudCB0aGF0IG5lZWRzIHRvIGJlIHNob3duKSBzaG91bGQgcmVjZWl2ZSB0aGlzIGV2ZW50CiAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIH0pOwoKICAgICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigncmVzZXRTY3JvbGxWaWV3JywgZnVuY3Rpb24oZSkgewogICAgICAgICAgLy9yZXR1cm4gc2Nyb2xsdmlldyB0byBvcmlnaW5hbCBoZWlnaHQgb25jZSBrZXlib2FyZCBoYXMgaGlkZGVuCiAgICAgICAgICBzZWxmLmlzU2Nyb2xsZWRJbnRvVmlldyA9IGZhbHNlOwogICAgICAgICAgY29udGFpbmVyLnN0eWxlLmhlaWdodCA9ICIiOwogICAgICAgICAgY29udGFpbmVyLnN0eWxlLm92ZXJmbG93ID0gIiI7CiAgICAgICAgICBzZWxmLnJlc2l6ZSgpOwogICAgICAgICAgaW9uaWMuc2Nyb2xsLmlzU2Nyb2xsaW5nID0gZmFsc2U7CiAgICAgICAgfSk7CgogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50VG91Y2hlcyhlKSB7CiAgICAgICAgICByZXR1cm4gZS50b3VjaGVzICYmIGUudG91Y2hlcy5sZW5ndGggPyBlLnRvdWNoZXMgOiBbewogICAgICAgICAgICBwYWdlWDogZS5wYWdlWCwKICAgICAgICAgICAgcGFnZVk6IGUucGFnZVkKICAgICAgICAgIH1dOwogICAgICAgIH0KCiAgICAgICAgc2VsZi50b3VjaFN0YXJ0ID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgc2VsZi5zdGFydENvb3JkaW5hdGVzID0gZ2V0UG9pbnRlckNvb3JkaW5hdGVzKGUpOwoKICAgICAgICAgIGlmICggaW9uaWMudGFwLmlnbm9yZVNjcm9sbFN0YXJ0KGUpICkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgc2VsZi5fX2lzRG93biA9IHRydWU7CgogICAgICAgICAgaWYoIGlvbmljLnRhcC5jb250YWluc09ySXNUZXh0SW5wdXQoZS50YXJnZXQpIHx8IGUudGFyZ2V0LnRhZ05hbWUgPT09ICdTRUxFQ1QnICkgewogICAgICAgICAgICAvLyBkbyBub3Qgc3RhcnQgaWYgdGhlIHRhcmdldCBpcyBhIHRleHQgaW5wdXQKICAgICAgICAgICAgLy8gaWYgdGhlcmUgaXMgYSB0b3VjaG1vdmUgb24gdGhpcyBpbnB1dCwgdGhlbiB3ZSBjYW4gc3RhcnQgdGhlIHNjcm9sbAogICAgICAgICAgICBzZWxmLl9faGFzU3RhcnRlZCA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgc2VsZi5fX2lzU2VsZWN0YWJsZSA9IHRydWU7CiAgICAgICAgICBzZWxmLl9fZW5hYmxlU2Nyb2xsWSA9IHRydWU7CiAgICAgICAgICBzZWxmLl9faGFzU3RhcnRlZCA9IHRydWU7CiAgICAgICAgICBzZWxmLmRvVG91Y2hTdGFydChnZXRFdmVudFRvdWNoZXMoZSksIGUudGltZVN0YW1wKTsKICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9OwoKICAgICAgICBzZWxmLnRvdWNoTW92ZSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIGlmKCFzZWxmLl9faXNEb3duIHx8CiAgICAgICAgICAgIGUuZGVmYXVsdFByZXZlbnRlZCB8fAogICAgICAgICAgICAoZS50YXJnZXQudGFnTmFtZSA9PT0gJ1RFWFRBUkVBJyAmJiBlLnRhcmdldC5wYXJlbnRFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJzpmb2N1cycpKSApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGlmKCAhc2VsZi5fX2hhc1N0YXJ0ZWQgJiYgKCBpb25pYy50YXAuY29udGFpbnNPcklzVGV4dElucHV0KGUudGFyZ2V0KSB8fCBlLnRhcmdldC50YWdOYW1lID09PSAnU0VMRUNUJyApICkgewogICAgICAgICAgICAvLyB0aGUgdGFyZ2V0IGlzIGEgdGV4dCBpbnB1dCBhbmQgc2Nyb2xsIGhhcyBzdGFydGVkCiAgICAgICAgICAgIC8vIHNpbmNlIHRoZSB0ZXh0IGlucHV0IGRvZXNuJ3Qgc3RhcnQgb24gdG91Y2hTdGFydCwgZG8gaXQgaGVyZQogICAgICAgICAgICBzZWxmLl9faGFzU3RhcnRlZCA9IHRydWU7CiAgICAgICAgICAgIHNlbGYuZG9Ub3VjaFN0YXJ0KGdldEV2ZW50VG91Y2hlcyhlKSwgZS50aW1lU3RhbXApOwogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBpZihzZWxmLnN0YXJ0Q29vcmRpbmF0ZXMpIHsKICAgICAgICAgICAgLy8gd2UgaGF2ZSBzdGFydCBjb29yZGluYXRlcywgc28gZ2V0IHRoaXMgdG91Y2ggbW92ZSdzIGN1cnJlbnQgY29vcmRpbmF0ZXMKICAgICAgICAgICAgdmFyIGN1cnJlbnRDb29yZGluYXRlcyA9IGdldFBvaW50ZXJDb29yZGluYXRlcyhlKTsKCiAgICAgICAgICAgIGlmKCBzZWxmLl9faXNTZWxlY3RhYmxlICYmCiAgICAgICAgICAgICAgaW9uaWMudGFwLmlzVGV4dElucHV0KGUudGFyZ2V0KSAmJgogICAgICAgICAgICAgIE1hdGguYWJzKHNlbGYuc3RhcnRDb29yZGluYXRlcy54IC0gY3VycmVudENvb3JkaW5hdGVzLngpID4gMjAgKSB7CiAgICAgICAgICAgICAgLy8gdXNlciBzbGlkIHRoZSB0ZXh0IGlucHV0J3MgY2FyZXQgb24gaXRzIHggYXhpcywgZGlzYWJsZSBhbnkgZnV0dXJlIHkgc2Nyb2xsaW5nCiAgICAgICAgICAgICAgc2VsZi5fX2VuYWJsZVNjcm9sbFkgPSBmYWxzZTsKICAgICAgICAgICAgICBzZWxmLl9faXNTZWxlY3RhYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoIHNlbGYuX19lbmFibGVTY3JvbGxZICYmIE1hdGguYWJzKHNlbGYuc3RhcnRDb29yZGluYXRlcy55IC0gY3VycmVudENvb3JkaW5hdGVzLnkpID4gMTAgKSB7CiAgICAgICAgICAgICAgLy8gdXNlciBzY3JvbGxlZCB0aGUgZW50aXJlIHZpZXcgb24gdGhlIHkgYXhpcwogICAgICAgICAgICAgIC8vIGRpc2FibGVkIGJlaW5nIGFibGUgdG8gc2VsZWN0IHRleHQgb24gYW4gaW5wdXQKICAgICAgICAgICAgICAvLyBoaWRlIHRoZSBpbnB1dCB3aGljaCBoYXMgZm9jdXMsIGFuZCBzaG93IGEgY2xvbmVkIG9uZSB0aGF0IGRvZXNuJ3QgaGF2ZSBmb2N1cwogICAgICAgICAgICAgIHNlbGYuX19pc1NlbGVjdGFibGUgPSBmYWxzZTsKICAgICAgICAgICAgICBpb25pYy50YXAuY2xvbmVGb2N1c2VkSW5wdXQoY29udGFpbmVyLCBzZWxmKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHNlbGYuZG9Ub3VjaE1vdmUoZ2V0RXZlbnRUb3VjaGVzKGUpLCBlLnRpbWVTdGFtcCwgZS5zY2FsZSk7CiAgICAgICAgICBzZWxmLl9faXNEb3duID0gdHJ1ZTsKICAgICAgICB9OwoKICAgICAgICBzZWxmLnRvdWNoRW5kID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgaWYoIXNlbGYuX19pc0Rvd24pIHJldHVybjsKCiAgICAgICAgICBzZWxmLmRvVG91Y2hFbmQoZS50aW1lU3RhbXApOwogICAgICAgICAgc2VsZi5fX2lzRG93biA9IGZhbHNlOwogICAgICAgICAgc2VsZi5fX2hhc1N0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICAgIHNlbGYuX19pc1NlbGVjdGFibGUgPSB0cnVlOwogICAgICAgICAgc2VsZi5fX2VuYWJsZVNjcm9sbFkgPSB0cnVlOwoKICAgICAgICAgIGlmKCAhc2VsZi5fX2lzRHJhZ2dpbmcgJiYgIXNlbGYuX19pc0RlY2VsZXJhdGluZyAmJiAhc2VsZi5fX2lzQW5pbWF0aW5nICkgewogICAgICAgICAgICBpb25pYy50YXAucmVtb3ZlQ2xvbmVkSW5wdXRzKGNvbnRhaW5lciwgc2VsZik7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgc2VsZi5vcHRpb25zLm9yZ1Njcm9sbGluZ0NvbXBsZXRlID0gc2VsZi5vcHRpb25zLnNjcm9sbGluZ0NvbXBsZXRlOwogICAgICAgIHNlbGYub3B0aW9ucy5zY3JvbGxpbmdDb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaW9uaWMudGFwLnJlbW92ZUNsb25lZElucHV0cyhjb250YWluZXIsIHNlbGYpOwogICAgICAgICAgc2VsZi5vcHRpb25zLm9yZ1Njcm9sbGluZ0NvbXBsZXRlKCk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdykgewogICAgICAgICAgLy8gVG91Y2ggRXZlbnRzCiAgICAgICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2hzdGFydCIsIHNlbGYudG91Y2hTdGFydCwgZmFsc2UpOwogICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2htb3ZlIiwgc2VsZi50b3VjaE1vdmUsIGZhbHNlKTsKICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInRvdWNoZW5kIiwgc2VsZi50b3VjaEVuZCwgZmFsc2UpOwogICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2hjYW5jZWwiLCBzZWxmLnRvdWNoRW5kLCBmYWxzZSk7CgogICAgICAgIH0gZWxzZSBpZiAod2luZG93Lm5hdmlnYXRvci5wb2ludGVyRW5hYmxlZCkgewogICAgICAgICAgLy8gUG9pbnRlciBFdmVudHMKICAgICAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIHNlbGYudG91Y2hTdGFydCwgZmFsc2UpOwogICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcm1vdmUiLCBzZWxmLnRvdWNoTW92ZSwgZmFsc2UpOwogICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcnVwIiwgc2VsZi50b3VjaEVuZCwgZmFsc2UpOwogICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigicG9pbnRlcmNhbmNlbCIsIHNlbGYudG91Y2hFbmQsIGZhbHNlKTsKCiAgICAgICAgfSBlbHNlIGlmICh3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQpIHsKICAgICAgICAgIC8vIElFMTAsIFdQOCAoUG9pbnRlciBFdmVudHMpCiAgICAgICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyRG93biIsIHNlbGYudG91Y2hTdGFydCwgZmFsc2UpOwogICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyTW92ZSIsIHNlbGYudG91Y2hNb3ZlLCBmYWxzZSk7CiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJVcCIsIHNlbGYudG91Y2hFbmQsIGZhbHNlKTsKICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIk1TUG9pbnRlckNhbmNlbCIsIHNlbGYudG91Y2hFbmQsIGZhbHNlKTsKCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIE1vdXNlIEV2ZW50cwogICAgICAgICAgdmFyIG1vdXNlZG93biA9IGZhbHNlOwoKICAgICAgICAgIHNlbGYubW91c2VEb3duID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICBpZiAoIGlvbmljLnRhcC5pZ25vcmVTY3JvbGxTdGFydChlKSB8fCBlLnRhcmdldC50YWdOYW1lID09PSAnU0VMRUNUJyApIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZi5kb1RvdWNoU3RhcnQoZ2V0RXZlbnRUb3VjaGVzKGUpLCBlLnRpbWVTdGFtcCk7CgogICAgICAgICAgICBpZiggIWlvbmljLnRhcC5pc1RleHRJbnB1dChlLnRhcmdldCkgKSB7CiAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1vdXNlZG93biA9IHRydWU7CiAgICAgICAgICB9OwoKICAgICAgICAgIHNlbGYubW91c2VNb3ZlID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICBpZiAoIW1vdXNlZG93biB8fCBlLmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlbGYuZG9Ub3VjaE1vdmUoZ2V0RXZlbnRUb3VjaGVzKGUpLCBlLnRpbWVTdGFtcCk7CgogICAgICAgICAgICBtb3VzZWRvd24gPSB0cnVlOwogICAgICAgICAgfTsKCiAgICAgICAgICBzZWxmLm1vdXNlVXAgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGlmICghbW91c2Vkb3duKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzZWxmLmRvVG91Y2hFbmQoZS50aW1lU3RhbXApOwoKICAgICAgICAgICAgbW91c2Vkb3duID0gZmFsc2U7CiAgICAgICAgICB9OwoKICAgICAgICAgIHNlbGYubW91c2VXaGVlbCA9IGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoZnVuY3Rpb24oZSkgewogICAgICAgICAgICB2YXIgc2Nyb2xsUGFyZW50ID0gaW9uaWMuRG9tVXRpbC5nZXRQYXJlbnRPclNlbGZXaXRoQ2xhc3MoZS50YXJnZXQsICdpb25pYy1zY3JvbGwnKTsKICAgICAgICAgICAgaWYgKHNjcm9sbFBhcmVudCA9PT0gc2VsZi5fX2NvbnRhaW5lcikgewoKICAgICAgICAgICAgICBzZWxmLmhpbnRSZXNpemUoKTsKICAgICAgICAgICAgICBzZWxmLnNjcm9sbEJ5KAogICAgICAgICAgICAgICAgICBlLndoZWVsRGVsdGFYL3NlbGYub3B0aW9ucy53aGVlbERhbXBlbiwKICAgICAgICAgICAgICAgICAgLWUud2hlZWxEZWx0YVkvc2VsZi5vcHRpb25zLndoZWVsRGFtcGVuCiAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgc2VsZi5fX2ZhZGVTY3JvbGxiYXJzKCdpbicpOwogICAgICAgICAgICAgIGNsZWFyVGltZW91dChzZWxmLl9fd2hlZWxIaWRlQmFyVGltZW91dCk7CiAgICAgICAgICAgICAgc2VsZi5fX3doZWVsSGlkZUJhclRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2VsZi5fX2ZhZGVTY3JvbGxiYXJzKCdvdXQnKTsKICAgICAgICAgICAgICB9LCAxMDApOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgc2VsZi5tb3VzZURvd24sIGZhbHNlKTsKICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIHNlbGYubW91c2VNb3ZlLCBmYWxzZSk7CiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJtb3VzZXVwIiwgc2VsZi5tb3VzZVVwLCBmYWxzZSk7CiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgc2VsZi5tb3VzZVdoZWVsLCBmYWxzZSk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgX19yZW1vdmVFdmVudEhhbmRsZXJzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgY29udGFpbmVyID0gdGhpcy5fX2NvbnRhaW5lcjsKCiAgICAgICAgY29udGFpbmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBzZWxmLnRvdWNoU3RhcnQpOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHNlbGYudG91Y2hNb3ZlKTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHNlbGYudG91Y2hFbmQpOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgc2VsZi50b3VjaENhbmNlbCk7CgogICAgICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCJwb2ludGVyZG93biIsIHNlbGYudG91Y2hTdGFydCk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigicG9pbnRlcm1vdmUiLCBzZWxmLnRvdWNoTW92ZSk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigicG9pbnRlcnVwIiwgc2VsZi50b3VjaEVuZCk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigicG9pbnRlcmNhbmNlbCIsIHNlbGYudG91Y2hFbmQpOwoKICAgICAgICBjb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyRG93biIsIHNlbGYudG91Y2hTdGFydCk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyTW92ZSIsIHNlbGYudG91Y2hNb3ZlKTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJVcCIsIHNlbGYudG91Y2hFbmQpOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIk1TUG9pbnRlckNhbmNlbCIsIHNlbGYudG91Y2hFbmQpOwoKICAgICAgICBjb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgc2VsZi5tb3VzZURvd24pOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlbW92ZSIsIHNlbGYubW91c2VNb3ZlKTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZXVwIiwgc2VsZi5tb3VzZVVwKTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXdoZWVsJywgc2VsZi5tb3VzZVdoZWVsKTsKICAgICAgfSwKCiAgICAgIC8qKiBDcmVhdGUgYSBzY3JvbGwgYmFyIGRpdiB3aXRoIHRoZSBnaXZlbiBkaXJlY3Rpb24gKiovCiAgICAgIF9fY3JlYXRlU2Nyb2xsYmFyOiBmdW5jdGlvbihkaXJlY3Rpb24pIHsKICAgICAgICB2YXIgYmFyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksCiAgICAgICAgICBpbmRpY2F0b3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCiAgICAgICAgaW5kaWNhdG9yLmNsYXNzTmFtZSA9ICdzY3JvbGwtYmFyLWluZGljYXRvcic7CgogICAgICAgIGlmKGRpcmVjdGlvbiA9PSAnaCcpIHsKICAgICAgICAgIGJhci5jbGFzc05hbWUgPSAnc2Nyb2xsLWJhciBzY3JvbGwtYmFyLWgnOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiYXIuY2xhc3NOYW1lID0gJ3Njcm9sbC1iYXIgc2Nyb2xsLWJhci12JzsKICAgICAgICB9CgogICAgICAgIGJhci5hcHBlbmRDaGlsZChpbmRpY2F0b3IpOwogICAgICAgIHJldHVybiBiYXI7CiAgICAgIH0sCgogICAgICBfX2NyZWF0ZVNjcm9sbGJhcnM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBpbmRpY2F0b3JYLCBpbmRpY2F0b3JZOwoKICAgICAgICBpZih0aGlzLm9wdGlvbnMuc2Nyb2xsaW5nWCkgewogICAgICAgICAgaW5kaWNhdG9yWCA9IHsKICAgICAgICAgICAgZWw6IHRoaXMuX19jcmVhdGVTY3JvbGxiYXIoJ2gnKSwKICAgICAgICAgICAgc2l6ZVJhdGlvOiAxCiAgICAgICAgICB9OwogICAgICAgICAgaW5kaWNhdG9yWC5pbmRpY2F0b3IgPSBpbmRpY2F0b3JYLmVsLmNoaWxkcmVuWzBdOwoKICAgICAgICAgIGlmKHRoaXMub3B0aW9ucy5zY3JvbGxiYXJYKSB7CiAgICAgICAgICAgIHRoaXMuX19jb250YWluZXIuYXBwZW5kQ2hpbGQoaW5kaWNhdG9yWC5lbCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9faW5kaWNhdG9yWCA9IGluZGljYXRvclg7CiAgICAgICAgfQoKICAgICAgICBpZih0aGlzLm9wdGlvbnMuc2Nyb2xsaW5nWSkgewogICAgICAgICAgaW5kaWNhdG9yWSA9IHsKICAgICAgICAgICAgZWw6IHRoaXMuX19jcmVhdGVTY3JvbGxiYXIoJ3YnKSwKICAgICAgICAgICAgc2l6ZVJhdGlvOiAxCiAgICAgICAgICB9OwogICAgICAgICAgaW5kaWNhdG9yWS5pbmRpY2F0b3IgPSBpbmRpY2F0b3JZLmVsLmNoaWxkcmVuWzBdOwoKICAgICAgICAgIGlmKHRoaXMub3B0aW9ucy5zY3JvbGxiYXJZKSB7CiAgICAgICAgICAgIHRoaXMuX19jb250YWluZXIuYXBwZW5kQ2hpbGQoaW5kaWNhdG9yWS5lbCk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9faW5kaWNhdG9yWSA9IGluZGljYXRvclk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgX19yZXNpemVTY3JvbGxiYXJzOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIC8vIFVwZGF0ZSBob3JpeiBiYXIKICAgICAgICBpZihzZWxmLl9faW5kaWNhdG9yWCkgewogICAgICAgICAgdmFyIHdpZHRoID0gTWF0aC5tYXgoTWF0aC5yb3VuZChzZWxmLl9fY2xpZW50V2lkdGggKiBzZWxmLl9fY2xpZW50V2lkdGggLyAoc2VsZi5fX2NvbnRlbnRXaWR0aCkpLCAyMCk7CiAgICAgICAgICBpZih3aWR0aCA+IHNlbGYuX19jb250ZW50V2lkdGgpIHsKICAgICAgICAgICAgd2lkdGggPSAwOwogICAgICAgICAgfQogICAgICAgICAgc2VsZi5fX2luZGljYXRvclguc2l6ZSA9IHdpZHRoOwogICAgICAgICAgc2VsZi5fX2luZGljYXRvclgubWluU2NhbGUgPSB0aGlzLm9wdGlvbnMubWluU2Nyb2xsYmFyU2l6ZVggLyB3aWR0aDsKICAgICAgICAgIHNlbGYuX19pbmRpY2F0b3JYLmluZGljYXRvci5zdHlsZS53aWR0aCA9IHdpZHRoICsgJ3B4JzsKICAgICAgICAgIHNlbGYuX19pbmRpY2F0b3JYLm1heFBvcyA9IHNlbGYuX19jbGllbnRXaWR0aCAtIHdpZHRoOwogICAgICAgICAgc2VsZi5fX2luZGljYXRvclguc2l6ZVJhdGlvID0gc2VsZi5fX21heFNjcm9sbExlZnQgPyBzZWxmLl9faW5kaWNhdG9yWC5tYXhQb3MgLyBzZWxmLl9fbWF4U2Nyb2xsTGVmdCA6IDE7CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgdmVydCBiYXIKICAgICAgICBpZihzZWxmLl9faW5kaWNhdG9yWSkgewogICAgICAgICAgdmFyIGhlaWdodCA9IE1hdGgubWF4KE1hdGgucm91bmQoc2VsZi5fX2NsaWVudEhlaWdodCAqIHNlbGYuX19jbGllbnRIZWlnaHQgLyAoc2VsZi5fX2NvbnRlbnRIZWlnaHQpKSwgMjApOwogICAgICAgICAgaWYoaGVpZ2h0ID4gc2VsZi5fX2NvbnRlbnRIZWlnaHQpIHsKICAgICAgICAgICAgaGVpZ2h0ID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHNlbGYuX19pbmRpY2F0b3JZLnNpemUgPSBoZWlnaHQ7CiAgICAgICAgICBzZWxmLl9faW5kaWNhdG9yWS5taW5TY2FsZSA9IHRoaXMub3B0aW9ucy5taW5TY3JvbGxiYXJTaXplWSAvIGhlaWdodDsKICAgICAgICAgIHNlbGYuX19pbmRpY2F0b3JZLm1heFBvcyA9IHNlbGYuX19jbGllbnRIZWlnaHQgLSBoZWlnaHQ7CiAgICAgICAgICBzZWxmLl9faW5kaWNhdG9yWS5pbmRpY2F0b3Iuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgJ3B4JzsKICAgICAgICAgIHNlbGYuX19pbmRpY2F0b3JZLnNpemVSYXRpbyA9IHNlbGYuX19tYXhTY3JvbGxUb3AgPyBzZWxmLl9faW5kaWNhdG9yWS5tYXhQb3MgLyBzZWxmLl9fbWF4U2Nyb2xsVG9wIDogMTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogTW92ZSBhbmQgc2NhbGUgdGhlIHNjcm9sbGJhcnMgYXMgdGhlIHBhZ2Ugc2Nyb2xscy4KICAgICAgICovCiAgICAgIF9fcmVwb3NpdGlvblNjcm9sbGJhcnM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpcywgd2lkdGgsIGhlaWdodFNjYWxlLAogICAgICAgICAgd2lkdGhEaWZmLCBoZWlnaHREaWZmLAogICAgICAgICAgeCwgeSwKICAgICAgICAgIHhzdG9wID0gMCwgeXN0b3AgPSAwOwoKICAgICAgICBpZihzZWxmLl9faW5kaWNhdG9yWCkgewogICAgICAgICAgLy8gSGFuZGxlIHRoZSBYIHNjcm9sbGJhcgoKICAgICAgICAgIC8vIERvbid0IGdvIGFsbCB0aGUgd2F5IHRvIHRoZSByaWdodCBpZiB3ZSBoYXZlIGEgdmVydGljYWwgc2Nyb2xsYmFyIGFzIHdlbGwKICAgICAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JZKSB4c3RvcCA9IDEwOwoKICAgICAgICAgIHggPSBNYXRoLnJvdW5kKHNlbGYuX19pbmRpY2F0b3JYLnNpemVSYXRpbyAqIHNlbGYuX19zY3JvbGxMZWZ0KSB8fCAwLAoKICAgICAgICAgICAgLy8gVGhlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gdGhlIGxhc3QgY29udGVudCBYIHBvc2l0aW9uLCBhbmQgb3VyIG92ZXJzY3JvbGxlZCBvbmUKICAgICAgICAgICAgd2lkdGhEaWZmID0gc2VsZi5fX3Njcm9sbExlZnQgLSAoc2VsZi5fX21heFNjcm9sbExlZnQgLSB4c3RvcCk7CgogICAgICAgICAgaWYoc2VsZi5fX3Njcm9sbExlZnQgPCAwKSB7CgogICAgICAgICAgICB3aWR0aFNjYWxlID0gTWF0aC5tYXgoc2VsZi5fX2luZGljYXRvclgubWluU2NhbGUsCiAgICAgICAgICAgICAgICAoc2VsZi5fX2luZGljYXRvclguc2l6ZSAtIE1hdGguYWJzKHNlbGYuX19zY3JvbGxMZWZ0KSkgLyBzZWxmLl9faW5kaWNhdG9yWC5zaXplKTsKCiAgICAgICAgICAgIC8vIFN0YXkgYXQgbGVmdAogICAgICAgICAgICB4ID0gMDsKCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSBzY2FsZSBpcyB0cmFuc2Zvcm1lZCBmcm9tIHRoZSBsZWZ0L2NlbnRlciBvcmlnaW4gcG9pbnQKICAgICAgICAgICAgc2VsZi5fX2luZGljYXRvclguaW5kaWNhdG9yLnN0eWxlW3NlbGYuX190cmFuc2Zvcm1PcmlnaW5Qcm9wZXJ0eV0gPSAnbGVmdCBjZW50ZXInOwogICAgICAgICAgfSBlbHNlIGlmKHdpZHRoRGlmZiA+IDApIHsKCiAgICAgICAgICAgIHdpZHRoU2NhbGUgPSBNYXRoLm1heChzZWxmLl9faW5kaWNhdG9yWC5taW5TY2FsZSwKICAgICAgICAgICAgICAgIChzZWxmLl9faW5kaWNhdG9yWC5zaXplIC0gd2lkdGhEaWZmKSAvIHNlbGYuX19pbmRpY2F0b3JYLnNpemUpOwoKICAgICAgICAgICAgLy8gU3RheSBhdCB0aGUgZnVydGhlc3QgeCBmb3IgdGhlIHNjcm9sbGFibGUgdmlld3BvcnQKICAgICAgICAgICAgeCA9IHNlbGYuX19pbmRpY2F0b3JYLm1heFBvcyAtIHhzdG9wOwoKICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHNjYWxlIGlzIHRyYW5zZm9ybWVkIGZyb20gdGhlIHJpZ2h0L2NlbnRlciBvcmlnaW4gcG9pbnQKICAgICAgICAgICAgc2VsZi5fX2luZGljYXRvclguaW5kaWNhdG9yLnN0eWxlW3NlbGYuX190cmFuc2Zvcm1PcmlnaW5Qcm9wZXJ0eV0gPSAncmlnaHQgY2VudGVyJzsKCiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgLy8gTm9ybWFsIG1vdGlvbgogICAgICAgICAgICB4ID0gTWF0aC5taW4oc2VsZi5fX21heFNjcm9sbExlZnQsIE1hdGgubWF4KDAsIHgpKTsKICAgICAgICAgICAgd2lkdGhTY2FsZSA9IDE7CgogICAgICAgICAgfQoKICAgICAgICAgIHNlbGYuX19pbmRpY2F0b3JYLmluZGljYXRvci5zdHlsZVtzZWxmLl9fdHJhbnNmb3JtUHJvcGVydHldID0gJ3RyYW5zbGF0ZTNkKCcgKyB4ICsgJ3B4LCAwLCAwKSBzY2FsZVgoJyArIHdpZHRoU2NhbGUgKyAnKSc7CiAgICAgICAgfQoKICAgICAgICBpZihzZWxmLl9faW5kaWNhdG9yWSkgewoKICAgICAgICAgIHkgPSBNYXRoLnJvdW5kKHNlbGYuX19pbmRpY2F0b3JZLnNpemVSYXRpbyAqIHNlbGYuX19zY3JvbGxUb3ApIHx8IDA7CgogICAgICAgICAgLy8gRG9uJ3QgZ28gYWxsIHRoZSB3YXkgdG8gdGhlIHJpZ2h0IGlmIHdlIGhhdmUgYSB2ZXJ0aWNhbCBzY3JvbGxiYXIgYXMgd2VsbAogICAgICAgICAgaWYoc2VsZi5fX2luZGljYXRvclgpIHlzdG9wID0gMTA7CgogICAgICAgICAgaGVpZ2h0RGlmZiA9IHNlbGYuX19zY3JvbGxUb3AgLSAoc2VsZi5fX21heFNjcm9sbFRvcCAtIHlzdG9wKTsKCiAgICAgICAgICBpZihzZWxmLl9fc2Nyb2xsVG9wIDwgMCkgewoKICAgICAgICAgICAgaGVpZ2h0U2NhbGUgPSBNYXRoLm1heChzZWxmLl9faW5kaWNhdG9yWS5taW5TY2FsZSwgKHNlbGYuX19pbmRpY2F0b3JZLnNpemUgLSBNYXRoLmFicyhzZWxmLl9fc2Nyb2xsVG9wKSkgLyBzZWxmLl9faW5kaWNhdG9yWS5zaXplKTsKCiAgICAgICAgICAgIC8vIFN0YXkgYXQgdG9wCiAgICAgICAgICAgIHkgPSAwOwoKICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHNjYWxlIGlzIHRyYW5zZm9ybWVkIGZyb20gdGhlIGNlbnRlci90b3Agb3JpZ2luIHBvaW50CiAgICAgICAgICAgIHNlbGYuX19pbmRpY2F0b3JZLmluZGljYXRvci5zdHlsZVtzZWxmLl9fdHJhbnNmb3JtT3JpZ2luUHJvcGVydHldID0gJ2NlbnRlciB0b3AnOwoKICAgICAgICAgIH0gZWxzZSBpZihoZWlnaHREaWZmID4gMCkgewoKICAgICAgICAgICAgaGVpZ2h0U2NhbGUgPSBNYXRoLm1heChzZWxmLl9faW5kaWNhdG9yWS5taW5TY2FsZSwgKHNlbGYuX19pbmRpY2F0b3JZLnNpemUgLSBoZWlnaHREaWZmKSAvIHNlbGYuX19pbmRpY2F0b3JZLnNpemUpOwoKICAgICAgICAgICAgLy8gU3RheSBhdCBib3R0b20gb2Ygc2Nyb2xsYWJsZSB2aWV3cG9ydAogICAgICAgICAgICB5ID0gc2VsZi5fX2luZGljYXRvclkubWF4UG9zIC0geXN0b3A7CgogICAgICAgICAgICAvLyBNYWtlIHN1cmUgc2NhbGUgaXMgdHJhbnNmb3JtZWQgZnJvbSB0aGUgY2VudGVyL2JvdHRvbSBvcmlnaW4gcG9pbnQKICAgICAgICAgICAgc2VsZi5fX2luZGljYXRvclkuaW5kaWNhdG9yLnN0eWxlW3NlbGYuX190cmFuc2Zvcm1PcmlnaW5Qcm9wZXJ0eV0gPSAnY2VudGVyIGJvdHRvbSc7CgogICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIC8vIE5vcm1hbCBtb3Rpb24KICAgICAgICAgICAgeSA9IE1hdGgubWluKHNlbGYuX19tYXhTY3JvbGxUb3AsIE1hdGgubWF4KDAsIHkpKTsKICAgICAgICAgICAgaGVpZ2h0U2NhbGUgPSAxOwoKICAgICAgICAgIH0KCiAgICAgICAgICBzZWxmLl9faW5kaWNhdG9yWS5pbmRpY2F0b3Iuc3R5bGVbc2VsZi5fX3RyYW5zZm9ybVByb3BlcnR5XSA9ICd0cmFuc2xhdGUzZCgwLCcgKyB5ICsgJ3B4LCAwKSBzY2FsZVkoJyArIGhlaWdodFNjYWxlICsgJyknOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIF9fZmFkZVNjcm9sbGJhcnM6IGZ1bmN0aW9uKGRpcmVjdGlvbiwgZGVsYXkpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIGlmKCF0aGlzLm9wdGlvbnMuc2Nyb2xsYmFyc0ZhZGUpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBjbGFzc05hbWUgPSAnc2Nyb2xsLWJhci1mYWRlLW91dCc7CgogICAgICAgIGlmKHNlbGYub3B0aW9ucy5zY3JvbGxiYXJzRmFkZSA9PT0gdHJ1ZSkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHNlbGYuX19zY3JvbGxiYXJGYWRlVGltZW91dCk7CgogICAgICAgICAgaWYoZGlyZWN0aW9uID09ICdpbicpIHsKICAgICAgICAgICAgaWYoc2VsZi5fX2luZGljYXRvclgpIHsgc2VsZi5fX2luZGljYXRvclguaW5kaWNhdG9yLmNsYXNzTGlzdC5yZW1vdmUoY2xhc3NOYW1lKTsgfQogICAgICAgICAgICBpZihzZWxmLl9faW5kaWNhdG9yWSkgeyBzZWxmLl9faW5kaWNhdG9yWS5pbmRpY2F0b3IuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOyB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxmLl9fc2Nyb2xsYmFyRmFkZVRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JYKSB7IHNlbGYuX19pbmRpY2F0b3JYLmluZGljYXRvci5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7IH0KICAgICAgICAgICAgICBpZihzZWxmLl9faW5kaWNhdG9yWSkgeyBzZWxmLl9faW5kaWNhdG9yWS5pbmRpY2F0b3IuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOyB9CiAgICAgICAgICAgIH0sIGRlbGF5IHx8IHNlbGYub3B0aW9ucy5zY3JvbGxiYXJGYWRlRGVsYXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKCiAgICAgIF9fc2Nyb2xsaW5nQ29tcGxldGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICBzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nQ29tcGxldGUoKTsKCiAgICAgICAgc2VsZi5fX2ZhZGVTY3JvbGxiYXJzKCdvdXQnKTsKICAgICAgfSwKCiAgICAgIHJlc2l6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gVXBkYXRlIFNjcm9sbGVyIGRpbWVuc2lvbnMgZm9yIGNoYW5nZWQgY29udGVudAogICAgICAgIC8vIEFkZCBwYWRkaW5nIHRvIGJvdHRvbSBvZiBjb250ZW50CiAgICAgICAgdGhpcy5zZXREaW1lbnNpb25zKAogICAgICAgICAgdGhpcy5fX2NvbnRhaW5lci5jbGllbnRXaWR0aCwKICAgICAgICAgIHRoaXMuX19jb250YWluZXIuY2xpZW50SGVpZ2h0LAogICAgICAgICAgdGhpcy5vcHRpb25zLmdldENvbnRlbnRXaWR0aCgpLAogICAgICAgICAgdGhpcy5vcHRpb25zLmdldENvbnRlbnRIZWlnaHQoKQogICAgICAgICk7CiAgICAgIH0sCiAgICAgIC8qCiAgICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgIFBVQkxJQyBBUEkKICAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgKi8KCiAgICAgIGdldFJlbmRlckZuOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHZhciBjb250ZW50ID0gdGhpcy5fX2NvbnRlbnQ7CgogICAgICAgIHZhciBkb2NTdHlsZSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZTsKCiAgICAgICAgdmFyIGVuZ2luZTsKICAgICAgICBpZiAoJ01vekFwcGVhcmFuY2UnIGluIGRvY1N0eWxlKSB7CiAgICAgICAgICBlbmdpbmUgPSAnZ2Vja28nOwogICAgICAgIH0gZWxzZSBpZiAoJ1dlYmtpdEFwcGVhcmFuY2UnIGluIGRvY1N0eWxlKSB7CiAgICAgICAgICBlbmdpbmUgPSAnd2Via2l0JzsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuYXZpZ2F0b3IuY3B1Q2xhc3MgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICBlbmdpbmUgPSAndHJpZGVudCc7CiAgICAgICAgfQoKICAgICAgICB2YXIgdmVuZG9yUHJlZml4ID0gewogICAgICAgICAgdHJpZGVudDogJ21zJywKICAgICAgICAgIGdlY2tvOiAnTW96JywKICAgICAgICAgIHdlYmtpdDogJ1dlYmtpdCcsCiAgICAgICAgICBwcmVzdG86ICdPJwogICAgICAgIH1bZW5naW5lXTsKCiAgICAgICAgdmFyIGhlbHBlckVsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICB2YXIgdW5kZWY7CgogICAgICAgIHZhciBwZXJzcGVjdGl2ZVByb3BlcnR5ID0gdmVuZG9yUHJlZml4ICsgIlBlcnNwZWN0aXZlIjsKICAgICAgICB2YXIgdHJhbnNmb3JtUHJvcGVydHkgPSB2ZW5kb3JQcmVmaXggKyAiVHJhbnNmb3JtIjsKICAgICAgICB2YXIgdHJhbnNmb3JtT3JpZ2luUHJvcGVydHkgPSB2ZW5kb3JQcmVmaXggKyAnVHJhbnNmb3JtT3JpZ2luJzsKCiAgICAgICAgc2VsZi5fX3BlcnNwZWN0aXZlUHJvcGVydHkgPSB0cmFuc2Zvcm1Qcm9wZXJ0eTsKICAgICAgICBzZWxmLl9fdHJhbnNmb3JtUHJvcGVydHkgPSB0cmFuc2Zvcm1Qcm9wZXJ0eTsKICAgICAgICBzZWxmLl9fdHJhbnNmb3JtT3JpZ2luUHJvcGVydHkgPSB0cmFuc2Zvcm1PcmlnaW5Qcm9wZXJ0eTsKCiAgICAgICAgaWYgKGhlbHBlckVsZW0uc3R5bGVbcGVyc3BlY3RpdmVQcm9wZXJ0eV0gIT09IHVuZGVmKSB7CgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGxlZnQsIHRvcCwgem9vbSwgd2FzUmVzaXplKSB7CiAgICAgICAgICAgIGNvbnRlbnQuc3R5bGVbdHJhbnNmb3JtUHJvcGVydHldID0gJ3RyYW5zbGF0ZTNkKCcgKyAoLWxlZnQpICsgJ3B4LCcgKyAoLXRvcCkgKyAncHgsMCkgc2NhbGUoJyArIHpvb20gKyAnKSc7CiAgICAgICAgICAgIHNlbGYuX19yZXBvc2l0aW9uU2Nyb2xsYmFycygpOwogICAgICAgICAgICBpZighd2FzUmVzaXplKSB7CiAgICAgICAgICAgICAgc2VsZi50cmlnZ2VyU2Nyb2xsRXZlbnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgfSBlbHNlIGlmIChoZWxwZXJFbGVtLnN0eWxlW3RyYW5zZm9ybVByb3BlcnR5XSAhPT0gdW5kZWYpIHsKCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24obGVmdCwgdG9wLCB6b29tLCB3YXNSZXNpemUpIHsKICAgICAgICAgICAgY29udGVudC5zdHlsZVt0cmFuc2Zvcm1Qcm9wZXJ0eV0gPSAndHJhbnNsYXRlKCcgKyAoLWxlZnQpICsgJ3B4LCcgKyAoLXRvcCkgKyAncHgpIHNjYWxlKCcgKyB6b29tICsgJyknOwogICAgICAgICAgICBzZWxmLl9fcmVwb3NpdGlvblNjcm9sbGJhcnMoKTsKICAgICAgICAgICAgaWYoIXdhc1Jlc2l6ZSkgewogICAgICAgICAgICAgIHNlbGYudHJpZ2dlclNjcm9sbEV2ZW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGxlZnQsIHRvcCwgem9vbSwgd2FzUmVzaXplKSB7CiAgICAgICAgICAgIGNvbnRlbnQuc3R5bGUubWFyZ2luTGVmdCA9IGxlZnQgPyAoLWxlZnQvem9vbSkgKyAncHgnIDogJyc7CiAgICAgICAgICAgIGNvbnRlbnQuc3R5bGUubWFyZ2luVG9wID0gdG9wID8gKC10b3Avem9vbSkgKyAncHgnIDogJyc7CiAgICAgICAgICAgIGNvbnRlbnQuc3R5bGUuem9vbSA9IHpvb20gfHwgJyc7CiAgICAgICAgICAgIHNlbGYuX19yZXBvc2l0aW9uU2Nyb2xsYmFycygpOwogICAgICAgICAgICBpZighd2FzUmVzaXplKSB7CiAgICAgICAgICAgICAgc2VsZi50cmlnZ2VyU2Nyb2xsRXZlbnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgfQogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBDb25maWd1cmVzIHRoZSBkaW1lbnNpb25zIG9mIHRoZSBjbGllbnQgKG91dGVyKSBhbmQgY29udGVudCAoaW5uZXIpIGVsZW1lbnRzLgogICAgICAgKiBSZXF1aXJlcyB0aGUgYXZhaWxhYmxlIHNwYWNlIGZvciB0aGUgb3V0ZXIgZWxlbWVudCBhbmQgdGhlIG91dGVyIHNpemUgb2YgdGhlIGlubmVyIGVsZW1lbnQuCiAgICAgICAqIEFsbCB2YWx1ZXMgd2hpY2ggYXJlIGZhbHN5IChudWxsIG9yIHplcm8gZXRjLikgYXJlIGlnbm9yZWQgYW5kIHRoZSBvbGQgdmFsdWUgaXMga2VwdC4KICAgICAgICoKICAgICAgICogQHBhcmFtIGNsaWVudFdpZHRoIHtJbnRlZ2VyfSBJbm5lciB3aWR0aCBvZiBvdXRlciBlbGVtZW50CiAgICAgICAqIEBwYXJhbSBjbGllbnRIZWlnaHQge0ludGVnZXJ9IElubmVyIGhlaWdodCBvZiBvdXRlciBlbGVtZW50CiAgICAgICAqIEBwYXJhbSBjb250ZW50V2lkdGgge0ludGVnZXJ9IE91dGVyIHdpZHRoIG9mIGlubmVyIGVsZW1lbnQKICAgICAgICogQHBhcmFtIGNvbnRlbnRIZWlnaHQge0ludGVnZXJ9IE91dGVyIGhlaWdodCBvZiBpbm5lciBlbGVtZW50CiAgICAgICAqLwogICAgICBzZXREaW1lbnNpb25zOiBmdW5jdGlvbihjbGllbnRXaWR0aCwgY2xpZW50SGVpZ2h0LCBjb250ZW50V2lkdGgsIGNvbnRlbnRIZWlnaHQpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIC8vIE9ubHkgdXBkYXRlIHZhbHVlcyB3aGljaCBhcmUgZGVmaW5lZAogICAgICAgIGlmIChjbGllbnRXaWR0aCA9PT0gK2NsaWVudFdpZHRoKSB7CiAgICAgICAgICBzZWxmLl9fY2xpZW50V2lkdGggPSBjbGllbnRXaWR0aDsKICAgICAgICB9CgogICAgICAgIGlmIChjbGllbnRIZWlnaHQgPT09ICtjbGllbnRIZWlnaHQpIHsKICAgICAgICAgIHNlbGYuX19jbGllbnRIZWlnaHQgPSBjbGllbnRIZWlnaHQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoY29udGVudFdpZHRoID09PSArY29udGVudFdpZHRoKSB7CiAgICAgICAgICBzZWxmLl9fY29udGVudFdpZHRoID0gY29udGVudFdpZHRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbnRlbnRIZWlnaHQgPT09ICtjb250ZW50SGVpZ2h0KSB7CiAgICAgICAgICBzZWxmLl9fY29udGVudEhlaWdodCA9IGNvbnRlbnRIZWlnaHQ7CiAgICAgICAgfQoKICAgICAgICAvLyBSZWZyZXNoIG1heGltdW1zCiAgICAgICAgc2VsZi5fX2NvbXB1dGVTY3JvbGxNYXgoKTsKICAgICAgICBzZWxmLl9fcmVzaXplU2Nyb2xsYmFycygpOwoKICAgICAgICAvLyBSZWZyZXNoIHNjcm9sbCBwb3NpdGlvbgogICAgICAgIHNlbGYuc2Nyb2xsVG8oc2VsZi5fX3Njcm9sbExlZnQsIHNlbGYuX19zY3JvbGxUb3AsIHRydWUsIG51bGwsIHRydWUpOwoKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogU2V0cyB0aGUgY2xpZW50IGNvb3JkaW5hdGVzIGluIHJlbGF0aW9uIHRvIHRoZSBkb2N1bWVudC4KICAgICAgICoKICAgICAgICogQHBhcmFtIGxlZnQge0ludGVnZXJ9IExlZnQgcG9zaXRpb24gb2Ygb3V0ZXIgZWxlbWVudAogICAgICAgKiBAcGFyYW0gdG9wIHtJbnRlZ2VyfSBUb3AgcG9zaXRpb24gb2Ygb3V0ZXIgZWxlbWVudAogICAgICAgKi8KICAgICAgc2V0UG9zaXRpb246IGZ1bmN0aW9uKGxlZnQsIHRvcCkgewoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHNlbGYuX19jbGllbnRMZWZ0ID0gbGVmdCB8fCAwOwogICAgICAgIHNlbGYuX19jbGllbnRUb3AgPSB0b3AgfHwgMDsKCiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIENvbmZpZ3VyZXMgdGhlIHNuYXBwaW5nICh3aGVuIHNuYXBwaW5nIGlzIGFjdGl2ZSkKICAgICAgICoKICAgICAgICogQHBhcmFtIHdpZHRoIHtJbnRlZ2VyfSBTbmFwcGluZyB3aWR0aAogICAgICAgKiBAcGFyYW0gaGVpZ2h0IHtJbnRlZ2VyfSBTbmFwcGluZyBoZWlnaHQKICAgICAgICovCiAgICAgIHNldFNuYXBTaXplOiBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgc2VsZi5fX3NuYXBXaWR0aCA9IHdpZHRoOwogICAgICAgIHNlbGYuX19zbmFwSGVpZ2h0ID0gaGVpZ2h0OwoKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogQWN0aXZhdGVzIHB1bGwtdG8tcmVmcmVzaC4gQSBzcGVjaWFsIHpvbmUgb24gdGhlIHRvcCBvZiB0aGUgbGlzdCB0byBzdGFydCBhIGxpc3QgcmVmcmVzaCB3aGVuZXZlcgogICAgICAgKiB0aGUgdXNlciBldmVudCBpcyByZWxlYXNlZCBkdXJpbmcgdmlzaWJpbGl0eSBvZiB0aGlzIHpvbmUuIFRoaXMgd2FzIGludHJvZHVjZWQgYnkgc29tZSBhcHBzIG9uIGlPUyBsaWtlCiAgICAgICAqIHRoZSBvZmZpY2lhbCBUd2l0dGVyIGNsaWVudC4KICAgICAgICoKICAgICAgICogQHBhcmFtIGhlaWdodCB7SW50ZWdlcn0gSGVpZ2h0IG9mIHB1bGwtdG8tcmVmcmVzaCB6b25lIG9uIHRvcCBvZiByZW5kZXJlZCBsaXN0CiAgICAgICAqIEBwYXJhbSBhY3RpdmF0ZUNhbGxiYWNrIHtGdW5jdGlvbn0gQ2FsbGJhY2sgdG8gZXhlY3V0ZSBvbiBhY3RpdmF0aW9uLiBUaGlzIGlzIGZvciBzaWduYWxsaW5nIHRoZSB1c2VyIGFib3V0IGEgcmVmcmVzaCBpcyBhYm91dCB0byBoYXBwZW4gd2hlbiBoZSByZWxlYXNlLgogICAgICAgKiBAcGFyYW0gZGVhY3RpdmF0ZUNhbGxiYWNrIHtGdW5jdGlvbn0gQ2FsbGJhY2sgdG8gZXhlY3V0ZSBvbiBkZWFjdGl2YXRpb24uIFRoaXMgaXMgZm9yIHNpZ25hbGxpbmcgdGhlIHVzZXIgYWJvdXQgdGhlIHJlZnJlc2ggYmVpbmcgY2FuY2VsbGVkLgogICAgICAgKiBAcGFyYW0gc3RhcnRDYWxsYmFjayB7RnVuY3Rpb259IENhbGxiYWNrIHRvIGV4ZWN1dGUgdG8gc3RhcnQgdGhlIHJlYWwgYXN5bmMgcmVmcmVzaCBhY3Rpb24uIENhbGwge0BsaW5rICNmaW5pc2hQdWxsVG9SZWZyZXNofSBhZnRlciBmaW5pc2ggb2YgcmVmcmVzaC4KICAgICAgICovCiAgICAgIGFjdGl2YXRlUHVsbFRvUmVmcmVzaDogZnVuY3Rpb24oaGVpZ2h0LCBhY3RpdmF0ZUNhbGxiYWNrLCBkZWFjdGl2YXRlQ2FsbGJhY2ssIHN0YXJ0Q2FsbGJhY2spIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBzZWxmLl9fcmVmcmVzaEhlaWdodCA9IGhlaWdodDsKICAgICAgICBzZWxmLl9fcmVmcmVzaEFjdGl2YXRlID0gYWN0aXZhdGVDYWxsYmFjazsKICAgICAgICBzZWxmLl9fcmVmcmVzaERlYWN0aXZhdGUgPSBkZWFjdGl2YXRlQ2FsbGJhY2s7CiAgICAgICAgc2VsZi5fX3JlZnJlc2hTdGFydCA9IHN0YXJ0Q2FsbGJhY2s7CgogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBTdGFydHMgcHVsbC10by1yZWZyZXNoIG1hbnVhbGx5LgogICAgICAgKi8KICAgICAgdHJpZ2dlclB1bGxUb1JlZnJlc2g6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIFVzZSBwdWJsaXNoIGluc3RlYWQgb2Ygc2Nyb2xsVG8gdG8gYWxsb3cgc2Nyb2xsaW5nIHRvIG91dCBvZiBib3VuZGFyeSBwb3NpdGlvbgogICAgICAgIC8vIFdlIGRvbid0IG5lZWQgdG8gbm9ybWFsaXplIHNjcm9sbExlZnQsIHpvb21MZXZlbCwgZXRjLiBoZXJlIGJlY2F1c2Ugd2Ugb25seSB5LXNjcm9sbGluZyB3aGVuIHB1bGwtdG8tcmVmcmVzaCBpcyBlbmFibGVkCiAgICAgICAgdGhpcy5fX3B1Ymxpc2godGhpcy5fX3Njcm9sbExlZnQsIC10aGlzLl9fcmVmcmVzaEhlaWdodCwgdGhpcy5fX3pvb21MZXZlbCwgdHJ1ZSk7CgogICAgICAgIGlmICh0aGlzLl9fcmVmcmVzaFN0YXJ0KSB7CiAgICAgICAgICB0aGlzLl9fcmVmcmVzaFN0YXJ0KCk7CiAgICAgICAgfQogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBTaWduYWxpemVzIHRoYXQgcHVsbC10by1yZWZyZXNoIGlzIGZpbmlzaGVkLgogICAgICAgKi8KICAgICAgZmluaXNoUHVsbFRvUmVmcmVzaDogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgc2VsZi5fX3JlZnJlc2hBY3RpdmUgPSBmYWxzZTsKICAgICAgICBpZiAoc2VsZi5fX3JlZnJlc2hEZWFjdGl2YXRlKSB7CiAgICAgICAgICBzZWxmLl9fcmVmcmVzaERlYWN0aXZhdGUoKTsKICAgICAgICB9CgogICAgICAgIHNlbGYuc2Nyb2xsVG8oc2VsZi5fX3Njcm9sbExlZnQsIHNlbGYuX19zY3JvbGxUb3AsIHRydWUpOwoKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogUmV0dXJucyB0aGUgc2Nyb2xsIHBvc2l0aW9uIGFuZCB6b29taW5nIHZhbHVlcwogICAgICAgKgogICAgICAgKiBAcmV0dXJuIHtNYXB9IGBsZWZ0YCBhbmQgYHRvcGAgc2Nyb2xsIHBvc2l0aW9uIGFuZCBgem9vbWAgbGV2ZWwKICAgICAgICovCiAgICAgIGdldFZhbHVlczogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGxlZnQ6IHNlbGYuX19zY3JvbGxMZWZ0LAogICAgICAgICAgdG9wOiBzZWxmLl9fc2Nyb2xsVG9wLAogICAgICAgICAgem9vbTogc2VsZi5fX3pvb21MZXZlbAogICAgICAgIH07CgogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBSZXR1cm5zIHRoZSBtYXhpbXVtIHNjcm9sbCB2YWx1ZXMKICAgICAgICoKICAgICAgICogQHJldHVybiB7TWFwfSBgbGVmdGAgYW5kIGB0b3BgIG1heGltdW0gc2Nyb2xsIHZhbHVlcwogICAgICAgKi8KICAgICAgZ2V0U2Nyb2xsTWF4OiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgbGVmdDogc2VsZi5fX21heFNjcm9sbExlZnQsCiAgICAgICAgICB0b3A6IHNlbGYuX19tYXhTY3JvbGxUb3AKICAgICAgICB9OwoKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogWm9vbXMgdG8gdGhlIGdpdmVuIGxldmVsLiBTdXBwb3J0cyBvcHRpb25hbCBhbmltYXRpb24uIFpvb21zCiAgICAgICAqIHRoZSBjZW50ZXIgd2hlbiBubyBjb29yZGluYXRlcyBhcmUgZ2l2ZW4uCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSBsZXZlbCB7TnVtYmVyfSBMZXZlbCB0byB6b29tIHRvCiAgICAgICAqIEBwYXJhbSBhbmltYXRlIHtCb29sZWFufSBXaGV0aGVyIHRvIHVzZSBhbmltYXRpb24KICAgICAgICogQHBhcmFtIG9yaWdpbkxlZnQge051bWJlcn0gWm9vbSBpbiBhdCBnaXZlbiBsZWZ0IGNvb3JkaW5hdGUKICAgICAgICogQHBhcmFtIG9yaWdpblRvcCB7TnVtYmVyfSBab29tIGluIGF0IGdpdmVuIHRvcCBjb29yZGluYXRlCiAgICAgICAqLwogICAgICB6b29tVG86IGZ1bmN0aW9uKGxldmVsLCBhbmltYXRlLCBvcmlnaW5MZWZ0LCBvcmlnaW5Ub3ApIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBpZiAoIXNlbGYub3B0aW9ucy56b29taW5nKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlpvb21pbmcgaXMgbm90IGVuYWJsZWQhIik7CiAgICAgICAgfQoKICAgICAgICAvLyBTdG9wIGRlY2VsZXJhdGlvbgogICAgICAgIGlmIChzZWxmLl9faXNEZWNlbGVyYXRpbmcpIHsKICAgICAgICAgIHp5bmdhQ29yZS5lZmZlY3QuQW5pbWF0ZS5zdG9wKHNlbGYuX19pc0RlY2VsZXJhdGluZyk7CiAgICAgICAgICBzZWxmLl9faXNEZWNlbGVyYXRpbmcgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciBvbGRMZXZlbCA9IHNlbGYuX196b29tTGV2ZWw7CgogICAgICAgIC8vIE5vcm1hbGl6ZSBpbnB1dCBvcmlnaW4gdG8gY2VudGVyIG9mIHZpZXdwb3J0IGlmIG5vdCBkZWZpbmVkCiAgICAgICAgaWYgKG9yaWdpbkxlZnQgPT0gbnVsbCkgewogICAgICAgICAgb3JpZ2luTGVmdCA9IHNlbGYuX19jbGllbnRXaWR0aCAvIDI7CiAgICAgICAgfQoKICAgICAgICBpZiAob3JpZ2luVG9wID09IG51bGwpIHsKICAgICAgICAgIG9yaWdpblRvcCA9IHNlbGYuX19jbGllbnRIZWlnaHQgLyAyOwogICAgICAgIH0KCiAgICAgICAgLy8gTGltaXQgbGV2ZWwgYWNjb3JkaW5nIHRvIGNvbmZpZ3VyYXRpb24KICAgICAgICBsZXZlbCA9IE1hdGgubWF4KE1hdGgubWluKGxldmVsLCBzZWxmLm9wdGlvbnMubWF4Wm9vbSksIHNlbGYub3B0aW9ucy5taW5ab29tKTsKCiAgICAgICAgLy8gUmVjb21wdXRlIG1heGltdW0gdmFsdWVzIHdoaWxlIHRlbXBvcmFyeSB0d2Vha2luZyBtYXhpbXVtIHNjcm9sbCByYW5nZXMKICAgICAgICBzZWxmLl9fY29tcHV0ZVNjcm9sbE1heChsZXZlbCk7CgogICAgICAgIC8vIFJlY29tcHV0ZSBsZWZ0IGFuZCB0b3AgY29vcmRpbmF0ZXMgYmFzZWQgb24gbmV3IHpvb20gbGV2ZWwKICAgICAgICB2YXIgbGVmdCA9ICgob3JpZ2luTGVmdCArIHNlbGYuX19zY3JvbGxMZWZ0KSAqIGxldmVsIC8gb2xkTGV2ZWwpIC0gb3JpZ2luTGVmdDsKICAgICAgICB2YXIgdG9wID0gKChvcmlnaW5Ub3AgKyBzZWxmLl9fc2Nyb2xsVG9wKSAqIGxldmVsIC8gb2xkTGV2ZWwpIC0gb3JpZ2luVG9wOwoKICAgICAgICAvLyBMaW1pdCB4LWF4aXMKICAgICAgICBpZiAobGVmdCA+IHNlbGYuX19tYXhTY3JvbGxMZWZ0KSB7CiAgICAgICAgICBsZWZ0ID0gc2VsZi5fX21heFNjcm9sbExlZnQ7CiAgICAgICAgfSBlbHNlIGlmIChsZWZ0IDwgMCkgewogICAgICAgICAgbGVmdCA9IDA7CiAgICAgICAgfQoKICAgICAgICAvLyBMaW1pdCB5LWF4aXMKICAgICAgICBpZiAodG9wID4gc2VsZi5fX21heFNjcm9sbFRvcCkgewogICAgICAgICAgdG9wID0gc2VsZi5fX21heFNjcm9sbFRvcDsKICAgICAgICB9IGVsc2UgaWYgKHRvcCA8IDApIHsKICAgICAgICAgIHRvcCA9IDA7CiAgICAgICAgfQoKICAgICAgICAvLyBQdXNoIHZhbHVlcyBvdXQKICAgICAgICBzZWxmLl9fcHVibGlzaChsZWZ0LCB0b3AsIGxldmVsLCBhbmltYXRlKTsKCiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIFpvb21zIHRoZSBjb250ZW50IGJ5IHRoZSBnaXZlbiBmYWN0b3IuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSBmYWN0b3Ige051bWJlcn0gWm9vbSBieSBnaXZlbiBmYWN0b3IKICAgICAgICogQHBhcmFtIGFuaW1hdGUge0Jvb2xlYW59IFdoZXRoZXIgdG8gdXNlIGFuaW1hdGlvbgogICAgICAgKiBAcGFyYW0gb3JpZ2luTGVmdCB7TnVtYmVyfSBab29tIGluIGF0IGdpdmVuIGxlZnQgY29vcmRpbmF0ZQogICAgICAgKiBAcGFyYW0gb3JpZ2luVG9wIHtOdW1iZXJ9IFpvb20gaW4gYXQgZ2l2ZW4gdG9wIGNvb3JkaW5hdGUKICAgICAgICovCiAgICAgIHpvb21CeTogZnVuY3Rpb24oZmFjdG9yLCBhbmltYXRlLCBvcmlnaW5MZWZ0LCBvcmlnaW5Ub3ApIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBzZWxmLnpvb21UbyhzZWxmLl9fem9vbUxldmVsICogZmFjdG9yLCBhbmltYXRlLCBvcmlnaW5MZWZ0LCBvcmlnaW5Ub3ApOwoKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogU2Nyb2xscyB0byB0aGUgZ2l2ZW4gcG9zaXRpb24uIFJlc3BlY3QgbGltaXRhdGlvbnMgYW5kIHNuYXBwaW5nIGF1dG9tYXRpY2FsbHkuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSBsZWZ0IHtOdW1iZXJ9IEhvcml6b250YWwgc2Nyb2xsIHBvc2l0aW9uLCBrZWVwcyBjdXJyZW50IGlmIHZhbHVlIGlzIDxjb2RlPm51bGw8L2NvZGU+CiAgICAgICAqIEBwYXJhbSB0b3Age051bWJlcn0gVmVydGljYWwgc2Nyb2xsIHBvc2l0aW9uLCBrZWVwcyBjdXJyZW50IGlmIHZhbHVlIGlzIDxjb2RlPm51bGw8L2NvZGU+CiAgICAgICAqIEBwYXJhbSBhbmltYXRlIHtCb29sZWFufSBXaGV0aGVyIHRoZSBzY3JvbGxpbmcgc2hvdWxkIGhhcHBlbiB1c2luZyBhbiBhbmltYXRpb24KICAgICAgICogQHBhcmFtIHpvb20ge051bWJlcn0gWm9vbSBsZXZlbCB0byBnbyB0bwogICAgICAgKi8KICAgICAgc2Nyb2xsVG86IGZ1bmN0aW9uKGxlZnQsIHRvcCwgYW5pbWF0ZSwgem9vbSwgd2FzUmVzaXplKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAvLyBTdG9wIGRlY2VsZXJhdGlvbgogICAgICAgIGlmIChzZWxmLl9faXNEZWNlbGVyYXRpbmcpIHsKICAgICAgICAgIHp5bmdhQ29yZS5lZmZlY3QuQW5pbWF0ZS5zdG9wKHNlbGYuX19pc0RlY2VsZXJhdGluZyk7CiAgICAgICAgICBzZWxmLl9faXNEZWNlbGVyYXRpbmcgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIC8vIENvcnJlY3QgY29vcmRpbmF0ZXMgYmFzZWQgb24gbmV3IHpvb20gbGV2ZWwKICAgICAgICBpZiAoem9vbSAhPSBudWxsICYmIHpvb20gIT09IHNlbGYuX196b29tTGV2ZWwpIHsKCiAgICAgICAgICBpZiAoIXNlbGYub3B0aW9ucy56b29taW5nKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiWm9vbWluZyBpcyBub3QgZW5hYmxlZCEiKTsKICAgICAgICAgIH0KCiAgICAgICAgICBsZWZ0ICo9IHpvb207CiAgICAgICAgICB0b3AgKj0gem9vbTsKCiAgICAgICAgICAvLyBSZWNvbXB1dGUgbWF4aW11bSB2YWx1ZXMgd2hpbGUgdGVtcG9yYXJ5IHR3ZWFraW5nIG1heGltdW0gc2Nyb2xsIHJhbmdlcwogICAgICAgICAgc2VsZi5fX2NvbXB1dGVTY3JvbGxNYXgoem9vbSk7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgLy8gS2VlcCB6b29tIHdoZW4gbm90IGRlZmluZWQKICAgICAgICAgIHpvb20gPSBzZWxmLl9fem9vbUxldmVsOwoKICAgICAgICB9CgogICAgICAgIGlmICghc2VsZi5vcHRpb25zLnNjcm9sbGluZ1gpIHsKCiAgICAgICAgICBsZWZ0ID0gc2VsZi5fX3Njcm9sbExlZnQ7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5wYWdpbmcpIHsKICAgICAgICAgICAgbGVmdCA9IE1hdGgucm91bmQobGVmdCAvIHNlbGYuX19jbGllbnRXaWR0aCkgKiBzZWxmLl9fY2xpZW50V2lkdGg7CiAgICAgICAgICB9IGVsc2UgaWYgKHNlbGYub3B0aW9ucy5zbmFwcGluZykgewogICAgICAgICAgICBsZWZ0ID0gTWF0aC5yb3VuZChsZWZ0IC8gc2VsZi5fX3NuYXBXaWR0aCkgKiBzZWxmLl9fc25hcFdpZHRoOwogICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIGlmICghc2VsZi5vcHRpb25zLnNjcm9sbGluZ1kpIHsKCiAgICAgICAgICB0b3AgPSBzZWxmLl9fc2Nyb2xsVG9wOwoKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMucGFnaW5nKSB7CiAgICAgICAgICAgIHRvcCA9IE1hdGgucm91bmQodG9wIC8gc2VsZi5fX2NsaWVudEhlaWdodCkgKiBzZWxmLl9fY2xpZW50SGVpZ2h0OwogICAgICAgICAgfSBlbHNlIGlmIChzZWxmLm9wdGlvbnMuc25hcHBpbmcpIHsKICAgICAgICAgICAgdG9wID0gTWF0aC5yb3VuZCh0b3AgLyBzZWxmLl9fc25hcEhlaWdodCkgKiBzZWxmLl9fc25hcEhlaWdodDsKICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICAvLyBMaW1pdCBmb3IgYWxsb3dlZCByYW5nZXMKICAgICAgICBsZWZ0ID0gTWF0aC5tYXgoTWF0aC5taW4oc2VsZi5fX21heFNjcm9sbExlZnQsIGxlZnQpLCAwKTsKICAgICAgICB0b3AgPSBNYXRoLm1heChNYXRoLm1pbihzZWxmLl9fbWF4U2Nyb2xsVG9wLCB0b3ApLCAwKTsKCiAgICAgICAgLy8gRG9uJ3QgYW5pbWF0ZSB3aGVuIG5vIGNoYW5nZSBkZXRlY3RlZCwgc3RpbGwgY2FsbCBwdWJsaXNoIHRvIG1ha2Ugc3VyZQogICAgICAgIC8vIHRoYXQgcmVuZGVyZWQgcG9zaXRpb24gaXMgcmVhbGx5IGluLXN5bmMgd2l0aCBpbnRlcm5hbCBkYXRhCiAgICAgICAgaWYgKGxlZnQgPT09IHNlbGYuX19zY3JvbGxMZWZ0ICYmIHRvcCA9PT0gc2VsZi5fX3Njcm9sbFRvcCkgewogICAgICAgICAgYW5pbWF0ZSA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgLy8gUHVibGlzaCBuZXcgdmFsdWVzCiAgICAgICAgc2VsZi5fX3B1Ymxpc2gobGVmdCwgdG9wLCB6b29tLCBhbmltYXRlLCB3YXNSZXNpemUpOwoKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogU2Nyb2xsIGJ5IHRoZSBnaXZlbiBvZmZzZXQKICAgICAgICoKICAgICAgICogQHBhcmFtIGxlZnQge051bWJlcn0gU2Nyb2xsIHgtYXhpcyBieSBnaXZlbiBvZmZzZXQKICAgICAgICogQHBhcmFtIHRvcCB7TnVtYmVyfSBTY3JvbGwgeS1heGlzIGJ5IGdpdmVuIG9mZnNldAogICAgICAgKiBAcGFyYW0gYW5pbWF0ZSB7Qm9vbGVhbn0gV2hldGhlciB0byBhbmltYXRlIHRoZSBnaXZlbiBjaGFuZ2UKICAgICAgICovCiAgICAgIHNjcm9sbEJ5OiBmdW5jdGlvbihsZWZ0LCB0b3AsIGFuaW1hdGUpIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICB2YXIgc3RhcnRMZWZ0ID0gc2VsZi5fX2lzQW5pbWF0aW5nID8gc2VsZi5fX3NjaGVkdWxlZExlZnQgOiBzZWxmLl9fc2Nyb2xsTGVmdDsKICAgICAgICB2YXIgc3RhcnRUb3AgPSBzZWxmLl9faXNBbmltYXRpbmcgPyBzZWxmLl9fc2NoZWR1bGVkVG9wIDogc2VsZi5fX3Njcm9sbFRvcDsKCiAgICAgICAgc2VsZi5zY3JvbGxUbyhzdGFydExlZnQgKyAobGVmdCB8fCAwKSwgc3RhcnRUb3AgKyAodG9wIHx8IDApLCBhbmltYXRlKTsKCiAgICAgIH0sCgoKCiAgICAgIC8qCiAgICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgIEVWRU5UIENBTExCQUNLUwogICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIE1vdXNlIHdoZWVsIGhhbmRsZXIgZm9yIHpvb21pbmcgc3VwcG9ydAogICAgICAgKi8KICAgICAgZG9Nb3VzZVpvb206IGZ1bmN0aW9uKHdoZWVsRGVsdGEsIHRpbWVTdGFtcCwgcGFnZVgsIHBhZ2VZKSB7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICB2YXIgY2hhbmdlID0gd2hlZWxEZWx0YSA+IDAgPyAwLjk3IDogMS4wMzsKCiAgICAgICAgcmV0dXJuIHNlbGYuem9vbVRvKHNlbGYuX196b29tTGV2ZWwgKiBjaGFuZ2UsIGZhbHNlLCBwYWdlWCAtIHNlbGYuX19jbGllbnRMZWZ0LCBwYWdlWSAtIHNlbGYuX19jbGllbnRUb3ApOwoKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBUb3VjaCBzdGFydCBoYW5kbGVyIGZvciBzY3JvbGxpbmcgc3VwcG9ydAogICAgICAgKi8KICAgICAgZG9Ub3VjaFN0YXJ0OiBmdW5jdGlvbih0b3VjaGVzLCB0aW1lU3RhbXApIHsKICAgICAgICB0aGlzLmhpbnRSZXNpemUoKTsKCiAgICAgICAgaWYgKHRpbWVTdGFtcCBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgICAgIHRpbWVTdGFtcCA9IHRpbWVTdGFtcC52YWx1ZU9mKCk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgdGltZVN0YW1wICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGltZVN0YW1wID0gRGF0ZS5ub3coKTsKICAgICAgICB9CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgLy8gUmVzZXQgaW50ZXJydXB0ZWRBbmltYXRpb24gZmxhZwogICAgICAgIHNlbGYuX19pbnRlcnJ1cHRlZEFuaW1hdGlvbiA9IHRydWU7CgogICAgICAgIC8vIFN0b3AgZGVjZWxlcmF0aW9uCiAgICAgICAgaWYgKHNlbGYuX19pc0RlY2VsZXJhdGluZykgewogICAgICAgICAgenluZ2FDb3JlLmVmZmVjdC5BbmltYXRlLnN0b3Aoc2VsZi5fX2lzRGVjZWxlcmF0aW5nKTsKICAgICAgICAgIHNlbGYuX19pc0RlY2VsZXJhdGluZyA9IGZhbHNlOwogICAgICAgICAgc2VsZi5fX2ludGVycnVwdGVkQW5pbWF0aW9uID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIC8vIFN0b3AgYW5pbWF0aW9uCiAgICAgICAgaWYgKHNlbGYuX19pc0FuaW1hdGluZykgewogICAgICAgICAgenluZ2FDb3JlLmVmZmVjdC5BbmltYXRlLnN0b3Aoc2VsZi5fX2lzQW5pbWF0aW5nKTsKICAgICAgICAgIHNlbGYuX19pc0FuaW1hdGluZyA9IGZhbHNlOwogICAgICAgICAgc2VsZi5fX2ludGVycnVwdGVkQW5pbWF0aW9uID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIC8vIFVzZSBjZW50ZXIgcG9pbnQgd2hlbiBkZWFsaW5nIHdpdGggdHdvIGZpbmdlcnMKICAgICAgICB2YXIgY3VycmVudFRvdWNoTGVmdCwgY3VycmVudFRvdWNoVG9wOwogICAgICAgIHZhciBpc1NpbmdsZVRvdWNoID0gdG91Y2hlcy5sZW5ndGggPT09IDE7CiAgICAgICAgaWYgKGlzU2luZ2xlVG91Y2gpIHsKICAgICAgICAgIGN1cnJlbnRUb3VjaExlZnQgPSB0b3VjaGVzWzBdLnBhZ2VYOwogICAgICAgICAgY3VycmVudFRvdWNoVG9wID0gdG91Y2hlc1swXS5wYWdlWTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3VycmVudFRvdWNoTGVmdCA9IE1hdGguYWJzKHRvdWNoZXNbMF0ucGFnZVggKyB0b3VjaGVzWzFdLnBhZ2VYKSAvIDI7CiAgICAgICAgICBjdXJyZW50VG91Y2hUb3AgPSBNYXRoLmFicyh0b3VjaGVzWzBdLnBhZ2VZICsgdG91Y2hlc1sxXS5wYWdlWSkgLyAyOwogICAgICAgIH0KCiAgICAgICAgLy8gU3RvcmUgaW5pdGlhbCBwb3NpdGlvbnMKICAgICAgICBzZWxmLl9faW5pdGlhbFRvdWNoTGVmdCA9IGN1cnJlbnRUb3VjaExlZnQ7CiAgICAgICAgc2VsZi5fX2luaXRpYWxUb3VjaFRvcCA9IGN1cnJlbnRUb3VjaFRvcDsKCiAgICAgICAgLy8gU3RvcmUgaW5pdGlhbCB0b3VjaExpc3QgZm9yIHNjYWxlIGNhbGN1bGF0aW9uCiAgICAgICAgc2VsZi5fX2luaXRpYWxUb3VjaGVzID0gdG91Y2hlczsKCiAgICAgICAgLy8gU3RvcmUgY3VycmVudCB6b29tIGxldmVsCiAgICAgICAgc2VsZi5fX3pvb21MZXZlbFN0YXJ0ID0gc2VsZi5fX3pvb21MZXZlbDsKCiAgICAgICAgLy8gU3RvcmUgaW5pdGlhbCB0b3VjaCBwb3NpdGlvbnMKICAgICAgICBzZWxmLl9fbGFzdFRvdWNoTGVmdCA9IGN1cnJlbnRUb3VjaExlZnQ7CiAgICAgICAgc2VsZi5fX2xhc3RUb3VjaFRvcCA9IGN1cnJlbnRUb3VjaFRvcDsKCiAgICAgICAgLy8gU3RvcmUgaW5pdGlhbCBtb3ZlIHRpbWUgc3RhbXAKICAgICAgICBzZWxmLl9fbGFzdFRvdWNoTW92ZSA9IHRpbWVTdGFtcDsKCiAgICAgICAgLy8gUmVzZXQgaW5pdGlhbCBzY2FsZQogICAgICAgIHNlbGYuX19sYXN0U2NhbGUgPSAxOwoKICAgICAgICAvLyBSZXNldCBsb2NraW5nIGZsYWdzCiAgICAgICAgc2VsZi5fX2VuYWJsZVNjcm9sbFggPSAhaXNTaW5nbGVUb3VjaCAmJiBzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nWDsKICAgICAgICBzZWxmLl9fZW5hYmxlU2Nyb2xsWSA9ICFpc1NpbmdsZVRvdWNoICYmIHNlbGYub3B0aW9ucy5zY3JvbGxpbmdZOwoKICAgICAgICAvLyBSZXNldCB0cmFja2luZyBmbGFnCiAgICAgICAgc2VsZi5fX2lzVHJhY2tpbmcgPSB0cnVlOwoKICAgICAgICAvLyBSZXNldCBkZWNlbGVyYXRpb24gY29tcGxldGUgZmxhZwogICAgICAgIHNlbGYuX19kaWREZWNlbGVyYXRpb25Db21wbGV0ZSA9IGZhbHNlOwoKICAgICAgICAvLyBEcmFnZ2luZyBzdGFydHMgZGlyZWN0bHkgd2l0aCB0d28gZmluZ2Vycywgb3RoZXJ3aXNlIGxhenkgd2l0aCBhbiBvZmZzZXQKICAgICAgICBzZWxmLl9faXNEcmFnZ2luZyA9ICFpc1NpbmdsZVRvdWNoOwoKICAgICAgICAvLyBTb21lIGZlYXR1cmVzIGFyZSBkaXNhYmxlZCBpbiBtdWx0aSB0b3VjaCBzY2VuYXJpb3MKICAgICAgICBzZWxmLl9faXNTaW5nbGVUb3VjaCA9IGlzU2luZ2xlVG91Y2g7CgogICAgICAgIC8vIENsZWFyaW5nIGRhdGEgc3RydWN0dXJlCiAgICAgICAgc2VsZi5fX3Bvc2l0aW9ucyA9IFtdOwoKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogVG91Y2ggbW92ZSBoYW5kbGVyIGZvciBzY3JvbGxpbmcgc3VwcG9ydAogICAgICAgKi8KICAgICAgZG9Ub3VjaE1vdmU6IGZ1bmN0aW9uKHRvdWNoZXMsIHRpbWVTdGFtcCwgc2NhbGUpIHsKICAgICAgICBpZiAodGltZVN0YW1wIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgICAgdGltZVN0YW1wID0gdGltZVN0YW1wLnZhbHVlT2YoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiB0aW1lU3RhbXAgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aW1lU3RhbXAgPSBEYXRlLm5vdygpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAvLyBJZ25vcmUgZXZlbnQgd2hlbiB0cmFja2luZyBpcyBub3QgZW5hYmxlZCAoZXZlbnQgbWlnaHQgYmUgb3V0c2lkZSBvZiBlbGVtZW50KQogICAgICAgIGlmICghc2VsZi5fX2lzVHJhY2tpbmcpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBjdXJyZW50VG91Y2hMZWZ0LCBjdXJyZW50VG91Y2hUb3A7CgogICAgICAgIC8vIENvbXB1dGUgbW92ZSBiYXNlZCBhcm91bmQgb2YgY2VudGVyIG9mIGZpbmdlcnMKICAgICAgICBpZiAodG91Y2hlcy5sZW5ndGggPT09IDIpIHsKICAgICAgICAgIGN1cnJlbnRUb3VjaExlZnQgPSBNYXRoLmFicyh0b3VjaGVzWzBdLnBhZ2VYICsgdG91Y2hlc1sxXS5wYWdlWCkgLyAyOwogICAgICAgICAgY3VycmVudFRvdWNoVG9wID0gTWF0aC5hYnModG91Y2hlc1swXS5wYWdlWSArIHRvdWNoZXNbMV0ucGFnZVkpIC8gMjsKCiAgICAgICAgICAvLyBDYWxjdWxhdGUgc2NhbGUgd2hlbiBub3QgcHJlc2VudCBhbmQgb25seSB3aGVuIHRvdWNoZXMgYXJlIHVzZWQKICAgICAgICAgIGlmICghc2NhbGUgJiYgc2VsZi5vcHRpb25zLnpvb21pbmcpIHsKICAgICAgICAgICAgc2NhbGUgPSBzZWxmLl9fZ2V0U2NhbGUoc2VsZi5fX2luaXRpYWxUb3VjaGVzLCB0b3VjaGVzKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3VycmVudFRvdWNoTGVmdCA9IHRvdWNoZXNbMF0ucGFnZVg7CiAgICAgICAgICBjdXJyZW50VG91Y2hUb3AgPSB0b3VjaGVzWzBdLnBhZ2VZOwogICAgICAgIH0KCiAgICAgICAgdmFyIHBvc2l0aW9ucyA9IHNlbGYuX19wb3NpdGlvbnM7CgogICAgICAgIC8vIEFyZSB3ZSBhbHJlYWR5IGlzIGRyYWdnaW5nIG1vZGU/CiAgICAgICAgaWYgKHNlbGYuX19pc0RyYWdnaW5nKSB7CgogICAgICAgICAgLy8gQ29tcHV0ZSBtb3ZlIGRpc3RhbmNlCiAgICAgICAgICB2YXIgbW92ZVggPSBjdXJyZW50VG91Y2hMZWZ0IC0gc2VsZi5fX2xhc3RUb3VjaExlZnQ7CiAgICAgICAgICB2YXIgbW92ZVkgPSBjdXJyZW50VG91Y2hUb3AgLSBzZWxmLl9fbGFzdFRvdWNoVG9wOwoKICAgICAgICAgIC8vIFJlYWQgcHJldmlvdXMgc2Nyb2xsIHBvc2l0aW9uIGFuZCB6b29taW5nCiAgICAgICAgICB2YXIgc2Nyb2xsTGVmdCA9IHNlbGYuX19zY3JvbGxMZWZ0OwogICAgICAgICAgdmFyIHNjcm9sbFRvcCA9IHNlbGYuX19zY3JvbGxUb3A7CiAgICAgICAgICB2YXIgbGV2ZWwgPSBzZWxmLl9fem9vbUxldmVsOwoKICAgICAgICAgIC8vIFdvcmsgd2l0aCBzY2FsaW5nCiAgICAgICAgICBpZiAoc2NhbGUgIT0gbnVsbCAmJiBzZWxmLm9wdGlvbnMuem9vbWluZykgewoKICAgICAgICAgICAgdmFyIG9sZExldmVsID0gbGV2ZWw7CgogICAgICAgICAgICAvLyBSZWNvbXB1dGUgbGV2ZWwgYmFzZWQgb24gcHJldmlvdXMgc2NhbGUgYW5kIG5ldyBzY2FsZQogICAgICAgICAgICBsZXZlbCA9IGxldmVsIC8gc2VsZi5fX2xhc3RTY2FsZSAqIHNjYWxlOwoKICAgICAgICAgICAgLy8gTGltaXQgbGV2ZWwgYWNjb3JkaW5nIHRvIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgbGV2ZWwgPSBNYXRoLm1heChNYXRoLm1pbihsZXZlbCwgc2VsZi5vcHRpb25zLm1heFpvb20pLCBzZWxmLm9wdGlvbnMubWluWm9vbSk7CgogICAgICAgICAgICAvLyBPbmx5IGRvIGZ1cnRoZXIgY29tcHV0aW9uIHdoZW4gY2hhbmdlIGhhcHBlbmVkCiAgICAgICAgICAgIGlmIChvbGRMZXZlbCAhPT0gbGV2ZWwpIHsKCiAgICAgICAgICAgICAgLy8gQ29tcHV0ZSByZWxhdGl2ZSBldmVudCBwb3NpdGlvbiB0byBjb250YWluZXIKICAgICAgICAgICAgICB2YXIgY3VycmVudFRvdWNoTGVmdFJlbCA9IGN1cnJlbnRUb3VjaExlZnQgLSBzZWxmLl9fY2xpZW50TGVmdDsKICAgICAgICAgICAgICB2YXIgY3VycmVudFRvdWNoVG9wUmVsID0gY3VycmVudFRvdWNoVG9wIC0gc2VsZi5fX2NsaWVudFRvcDsKCiAgICAgICAgICAgICAgLy8gUmVjb21wdXRlIGxlZnQgYW5kIHRvcCBjb29yZGluYXRlcyBiYXNlZCBvbiBuZXcgem9vbSBsZXZlbAogICAgICAgICAgICAgIHNjcm9sbExlZnQgPSAoKGN1cnJlbnRUb3VjaExlZnRSZWwgKyBzY3JvbGxMZWZ0KSAqIGxldmVsIC8gb2xkTGV2ZWwpIC0gY3VycmVudFRvdWNoTGVmdFJlbDsKICAgICAgICAgICAgICBzY3JvbGxUb3AgPSAoKGN1cnJlbnRUb3VjaFRvcFJlbCArIHNjcm9sbFRvcCkgKiBsZXZlbCAvIG9sZExldmVsKSAtIGN1cnJlbnRUb3VjaFRvcFJlbDsKCiAgICAgICAgICAgICAgLy8gUmVjb21wdXRlIG1heCBzY3JvbGwgdmFsdWVzCiAgICAgICAgICAgICAgc2VsZi5fX2NvbXB1dGVTY3JvbGxNYXgobGV2ZWwpOwoKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmIChzZWxmLl9fZW5hYmxlU2Nyb2xsWCkgewoKICAgICAgICAgICAgc2Nyb2xsTGVmdCAtPSBtb3ZlWCAqIHRoaXMub3B0aW9ucy5zcGVlZE11bHRpcGxpZXI7CiAgICAgICAgICAgIHZhciBtYXhTY3JvbGxMZWZ0ID0gc2VsZi5fX21heFNjcm9sbExlZnQ7CgogICAgICAgICAgICBpZiAoc2Nyb2xsTGVmdCA+IG1heFNjcm9sbExlZnQgfHwgc2Nyb2xsTGVmdCA8IDApIHsKCiAgICAgICAgICAgICAgLy8gU2xvdyBkb3duIG9uIHRoZSBlZGdlcwogICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuYm91bmNpbmcpIHsKCiAgICAgICAgICAgICAgICBzY3JvbGxMZWZ0ICs9IChtb3ZlWCAvIDIgICogdGhpcy5vcHRpb25zLnNwZWVkTXVsdGlwbGllcik7CgogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2Nyb2xsTGVmdCA+IG1heFNjcm9sbExlZnQpIHsKCiAgICAgICAgICAgICAgICBzY3JvbGxMZWZ0ID0gbWF4U2Nyb2xsTGVmdDsKCiAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICBzY3JvbGxMZWZ0ID0gMDsKCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQ29tcHV0ZSBuZXcgdmVydGljYWwgc2Nyb2xsIHBvc2l0aW9uCiAgICAgICAgICBpZiAoc2VsZi5fX2VuYWJsZVNjcm9sbFkpIHsKCiAgICAgICAgICAgIHNjcm9sbFRvcCAtPSBtb3ZlWSAqIHRoaXMub3B0aW9ucy5zcGVlZE11bHRpcGxpZXI7CiAgICAgICAgICAgIHZhciBtYXhTY3JvbGxUb3AgPSBzZWxmLl9fbWF4U2Nyb2xsVG9wOwoKICAgICAgICAgICAgaWYgKHNjcm9sbFRvcCA+IG1heFNjcm9sbFRvcCB8fCBzY3JvbGxUb3AgPCAwKSB7CgogICAgICAgICAgICAgIC8vIFNsb3cgZG93biBvbiB0aGUgZWRnZXMKICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmJvdW5jaW5nIHx8IChzZWxmLl9fcmVmcmVzaEhlaWdodCAmJiBzY3JvbGxUb3AgPCAwKSkgewoKICAgICAgICAgICAgICAgIHNjcm9sbFRvcCArPSAobW92ZVkgLyAyICogdGhpcy5vcHRpb25zLnNwZWVkTXVsdGlwbGllcik7CgogICAgICAgICAgICAgICAgLy8gU3VwcG9ydCBwdWxsLXRvLXJlZnJlc2ggKG9ubHkgd2hlbiBvbmx5IHkgaXMgc2Nyb2xsYWJsZSkKICAgICAgICAgICAgICAgIGlmICghc2VsZi5fX2VuYWJsZVNjcm9sbFggJiYgc2VsZi5fX3JlZnJlc2hIZWlnaHQgIT0gbnVsbCkgewoKICAgICAgICAgICAgICAgICAgaWYgKCFzZWxmLl9fcmVmcmVzaEFjdGl2ZSAmJiBzY3JvbGxUb3AgPD0gLXNlbGYuX19yZWZyZXNoSGVpZ2h0KSB7CgogICAgICAgICAgICAgICAgICAgIHNlbGYuX19yZWZyZXNoQWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5fX3JlZnJlc2hBY3RpdmF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hBY3RpdmF0ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2VsZi5fX3JlZnJlc2hBY3RpdmUgJiYgc2Nyb2xsVG9wID4gLXNlbGYuX19yZWZyZXNoSGVpZ2h0KSB7CgogICAgICAgICAgICAgICAgICAgIHNlbGYuX19yZWZyZXNoQWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGYuX19yZWZyZXNoRGVhY3RpdmF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hEZWFjdGl2YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNjcm9sbFRvcCA+IG1heFNjcm9sbFRvcCkgewoKICAgICAgICAgICAgICAgIHNjcm9sbFRvcCA9IG1heFNjcm9sbFRvcDsKCiAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICBzY3JvbGxUb3AgPSAwOwoKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBLZWVwIGxpc3QgZnJvbSBncm93aW5nIGluZmluaXRlbHkgKGhvbGRpbmcgbWluIDEwLCBtYXggMjAgbWVhc3VyZSBwb2ludHMpCiAgICAgICAgICBpZiAocG9zaXRpb25zLmxlbmd0aCA+IDYwKSB7CiAgICAgICAgICAgIHBvc2l0aW9ucy5zcGxpY2UoMCwgMzApOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFRyYWNrIHNjcm9sbCBtb3ZlbWVudCBmb3IgZGVjbGVyYXRpb24KICAgICAgICAgIHBvc2l0aW9ucy5wdXNoKHNjcm9sbExlZnQsIHNjcm9sbFRvcCwgdGltZVN0YW1wKTsKCiAgICAgICAgICAvLyBTeW5jIHNjcm9sbCBwb3NpdGlvbgogICAgICAgICAgc2VsZi5fX3B1Ymxpc2goc2Nyb2xsTGVmdCwgc2Nyb2xsVG9wLCBsZXZlbCk7CgogICAgICAgICAgLy8gT3RoZXJ3aXNlIGZpZ3VyZSBvdXQgd2hldGhlciB3ZSBhcmUgc3dpdGNoaW5nIGludG8gZHJhZ2dpbmcgbW9kZSBub3cuCiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICB2YXIgbWluaW11bVRyYWNraW5nRm9yU2Nyb2xsID0gc2VsZi5vcHRpb25zLmxvY2tpbmcgPyAzIDogMDsKICAgICAgICAgIHZhciBtaW5pbXVtVHJhY2tpbmdGb3JEcmFnID0gNTsKCiAgICAgICAgICB2YXIgZGlzdGFuY2VYID0gTWF0aC5hYnMoY3VycmVudFRvdWNoTGVmdCAtIHNlbGYuX19pbml0aWFsVG91Y2hMZWZ0KTsKICAgICAgICAgIHZhciBkaXN0YW5jZVkgPSBNYXRoLmFicyhjdXJyZW50VG91Y2hUb3AgLSBzZWxmLl9faW5pdGlhbFRvdWNoVG9wKTsKCiAgICAgICAgICBzZWxmLl9fZW5hYmxlU2Nyb2xsWCA9IHNlbGYub3B0aW9ucy5zY3JvbGxpbmdYICYmIGRpc3RhbmNlWCA+PSBtaW5pbXVtVHJhY2tpbmdGb3JTY3JvbGw7CiAgICAgICAgICBzZWxmLl9fZW5hYmxlU2Nyb2xsWSA9IHNlbGYub3B0aW9ucy5zY3JvbGxpbmdZICYmIGRpc3RhbmNlWSA+PSBtaW5pbXVtVHJhY2tpbmdGb3JTY3JvbGw7CgogICAgICAgICAgcG9zaXRpb25zLnB1c2goc2VsZi5fX3Njcm9sbExlZnQsIHNlbGYuX19zY3JvbGxUb3AsIHRpbWVTdGFtcCk7CgogICAgICAgICAgc2VsZi5fX2lzRHJhZ2dpbmcgPSAoc2VsZi5fX2VuYWJsZVNjcm9sbFggfHwgc2VsZi5fX2VuYWJsZVNjcm9sbFkpICYmIChkaXN0YW5jZVggPj0gbWluaW11bVRyYWNraW5nRm9yRHJhZyB8fCBkaXN0YW5jZVkgPj0gbWluaW11bVRyYWNraW5nRm9yRHJhZyk7CiAgICAgICAgICBpZiAoc2VsZi5fX2lzRHJhZ2dpbmcpIHsKICAgICAgICAgICAgc2VsZi5fX2ludGVycnVwdGVkQW5pbWF0aW9uID0gZmFsc2U7CiAgICAgICAgICAgIHNlbGYuX19mYWRlU2Nyb2xsYmFycygnaW4nKTsKICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgbGFzdCB0b3VjaCBwb3NpdGlvbnMgYW5kIHRpbWUgc3RhbXAgZm9yIG5leHQgZXZlbnQKICAgICAgICBzZWxmLl9fbGFzdFRvdWNoTGVmdCA9IGN1cnJlbnRUb3VjaExlZnQ7CiAgICAgICAgc2VsZi5fX2xhc3RUb3VjaFRvcCA9IGN1cnJlbnRUb3VjaFRvcDsKICAgICAgICBzZWxmLl9fbGFzdFRvdWNoTW92ZSA9IHRpbWVTdGFtcDsKICAgICAgICBzZWxmLl9fbGFzdFNjYWxlID0gc2NhbGU7CgogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBUb3VjaCBlbmQgaGFuZGxlciBmb3Igc2Nyb2xsaW5nIHN1cHBvcnQKICAgICAgICovCiAgICAgIGRvVG91Y2hFbmQ6IGZ1bmN0aW9uKHRpbWVTdGFtcCkgewogICAgICAgIGlmICh0aW1lU3RhbXAgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgICB0aW1lU3RhbXAgPSB0aW1lU3RhbXAudmFsdWVPZigpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHRpbWVTdGFtcCAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRpbWVTdGFtcCA9IERhdGUubm93KCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIC8vIElnbm9yZSBldmVudCB3aGVuIHRyYWNraW5nIGlzIG5vdCBlbmFibGVkIChubyB0b3VjaHN0YXJ0IGV2ZW50IG9uIGVsZW1lbnQpCiAgICAgICAgLy8gVGhpcyBpcyByZXF1aXJlZCBhcyB0aGlzIGxpc3RlbmVyICgndG91Y2htb3ZlJykgc2l0cyBvbiB0aGUgZG9jdW1lbnQgYW5kIG5vdCBvbiB0aGUgZWxlbWVudCBpdHNlbGYuCiAgICAgICAgaWYgKCFzZWxmLl9faXNUcmFja2luZykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gTm90IHRvdWNoaW5nIGFueW1vcmUgKHdoZW4gdHdvIGZpbmdlciBoaXQgdGhlIHNjcmVlbiB0aGVyZSBhcmUgdHdvIHRvdWNoIGVuZCBldmVudHMpCiAgICAgICAgc2VsZi5fX2lzVHJhY2tpbmcgPSBmYWxzZTsKCiAgICAgICAgLy8gQmUgc3VyZSB0byByZXNldCB0aGUgZHJhZ2dpbmcgZmxhZyBub3cuIEhlcmUgd2UgYWxzbyBkZXRlY3Qgd2hldGhlcgogICAgICAgIC8vIHRoZSBmaW5nZXIgaGFzIG1vdmVkIGZhc3QgZW5vdWdoIHRvIHN3aXRjaCBpbnRvIGEgZGVjZWxlcmF0aW9uIGFuaW1hdGlvbi4KICAgICAgICBpZiAoc2VsZi5fX2lzRHJhZ2dpbmcpIHsKCiAgICAgICAgICAvLyBSZXNldCBkcmFnZ2luZyBmbGFnCiAgICAgICAgICBzZWxmLl9faXNEcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgICAgIC8vIFN0YXJ0IGRlY2VsZXJhdGlvbgogICAgICAgICAgLy8gVmVyaWZ5IHRoYXQgdGhlIGxhc3QgbW92ZSBkZXRlY3RlZCB3YXMgaW4gc29tZSByZWxldmFudCB0aW1lIGZyYW1lCiAgICAgICAgICBpZiAoc2VsZi5fX2lzU2luZ2xlVG91Y2ggJiYgc2VsZi5vcHRpb25zLmFuaW1hdGluZyAmJiAodGltZVN0YW1wIC0gc2VsZi5fX2xhc3RUb3VjaE1vdmUpIDw9IDEwMCkgewoKICAgICAgICAgICAgLy8gVGhlbiBmaWd1cmUgb3V0IHdoYXQgdGhlIHNjcm9sbCBwb3NpdGlvbiB3YXMgYWJvdXQgMTAwbXMgYWdvCiAgICAgICAgICAgIHZhciBwb3NpdGlvbnMgPSBzZWxmLl9fcG9zaXRpb25zOwogICAgICAgICAgICB2YXIgZW5kUG9zID0gcG9zaXRpb25zLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIHZhciBzdGFydFBvcyA9IGVuZFBvczsKCiAgICAgICAgICAgIC8vIE1vdmUgcG9pbnRlciB0byBwb3NpdGlvbiBtZWFzdXJlZCAxMDBtcyBhZ28KICAgICAgICAgICAgZm9yICh2YXIgaSA9IGVuZFBvczsgaSA+IDAgJiYgcG9zaXRpb25zW2ldID4gKHNlbGYuX19sYXN0VG91Y2hNb3ZlIC0gMTAwKTsgaSAtPSAzKSB7CiAgICAgICAgICAgICAgc3RhcnRQb3MgPSBpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiBzdGFydCBhbmQgc3RvcCBwb3NpdGlvbiBpcyBpZGVudGljYWwgaW4gYSAxMDBtcyB0aW1lZnJhbWUsCiAgICAgICAgICAgIC8vIHdlIGNhbm5vdCBjb21wdXRlIGFueSB1c2VmdWwgZGVjZWxlcmF0aW9uLgogICAgICAgICAgICBpZiAoc3RhcnRQb3MgIT09IGVuZFBvcykgewoKICAgICAgICAgICAgICAvLyBDb21wdXRlIHJlbGF0aXZlIG1vdmVtZW50IGJldHdlZW4gdGhlc2UgdHdvIHBvaW50cwogICAgICAgICAgICAgIHZhciB0aW1lT2Zmc2V0ID0gcG9zaXRpb25zW2VuZFBvc10gLSBwb3NpdGlvbnNbc3RhcnRQb3NdOwogICAgICAgICAgICAgIHZhciBtb3ZlZExlZnQgPSBzZWxmLl9fc2Nyb2xsTGVmdCAtIHBvc2l0aW9uc1tzdGFydFBvcyAtIDJdOwogICAgICAgICAgICAgIHZhciBtb3ZlZFRvcCA9IHNlbGYuX19zY3JvbGxUb3AgLSBwb3NpdGlvbnNbc3RhcnRQb3MgLSAxXTsKCiAgICAgICAgICAgICAgLy8gQmFzZWQgb24gNTBtcyBjb21wdXRlIHRoZSBtb3ZlbWVudCB0byBhcHBseSBmb3IgZWFjaCByZW5kZXIgc3RlcAogICAgICAgICAgICAgIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVggPSBtb3ZlZExlZnQgLyB0aW1lT2Zmc2V0ICogKDEwMDAgLyA2MCk7CiAgICAgICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSA9IG1vdmVkVG9wIC8gdGltZU9mZnNldCAqICgxMDAwIC8gNjApOwoKICAgICAgICAgICAgICAvLyBIb3cgbXVjaCB2ZWxvY2l0eSBpcyByZXF1aXJlZCB0byBzdGFydCB0aGUgZGVjZWxlcmF0aW9uCiAgICAgICAgICAgICAgdmFyIG1pblZlbG9jaXR5VG9TdGFydERlY2VsZXJhdGlvbiA9IHNlbGYub3B0aW9ucy5wYWdpbmcgfHwgc2VsZi5vcHRpb25zLnNuYXBwaW5nID8gNCA6IDE7CgogICAgICAgICAgICAgIC8vIFZlcmlmeSB0aGF0IHdlIGhhdmUgZW5vdWdoIHZlbG9jaXR5IHRvIHN0YXJ0IGRlY2VsZXJhdGlvbgogICAgICAgICAgICAgIGlmIChNYXRoLmFicyhzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYKSA+IG1pblZlbG9jaXR5VG9TdGFydERlY2VsZXJhdGlvbiB8fCBNYXRoLmFicyhzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZKSA+IG1pblZlbG9jaXR5VG9TdGFydERlY2VsZXJhdGlvbikgewoKICAgICAgICAgICAgICAgIC8vIERlYWN0aXZhdGUgcHVsbC10by1yZWZyZXNoIHdoZW4gZGVjZWxlcmF0aW5nCiAgICAgICAgICAgICAgICBpZiAoIXNlbGYuX19yZWZyZXNoQWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgIHNlbGYuX19zdGFydERlY2VsZXJhdGlvbih0aW1lU3RhbXApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWxmLl9fc2Nyb2xsaW5nQ29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICgodGltZVN0YW1wIC0gc2VsZi5fX2xhc3RUb3VjaE1vdmUpID4gMTAwKSB7CiAgICAgICAgICAgIHNlbGYuX19zY3JvbGxpbmdDb21wbGV0ZSgpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhpcyB3YXMgYSBzbG93ZXIgbW92ZSBpdCBpcyBwZXIgZGVmYXVsdCBub24gZGVjZWxlcmF0ZWQsIGJ1dCB0aGlzCiAgICAgICAgLy8gc3RpbGwgbWVhbnMgdGhhdCB3ZSB3YW50IHNuYXAgYmFjayB0byB0aGUgYm91bmRzIHdoaWNoIGlzIGRvbmUgaGVyZS4KICAgICAgICAvLyBUaGlzIGlzIHBsYWNlZCBvdXRzaWRlIHRoZSBjb25kaXRpb24gYWJvdmUgdG8gaW1wcm92ZSBlZGdlIGNhc2Ugc3RhYmlsaXR5CiAgICAgICAgLy8gZS5nLiB0b3VjaGVuZCBmaXJlZCB3aXRob3V0IGVuYWJsZWQgZHJhZ2dpbmcuIFRoaXMgc2hvdWxkIG5vcm1hbGx5IGRvIG5vdAogICAgICAgIC8vIGhhdmUgbW9kaWZpZWQgdGhlIHNjcm9sbCBwb3NpdGlvbnMgb3IgZXZlbiBzaG93ZWQgdGhlIHNjcm9sbGJhcnMgdGhvdWdoLgogICAgICAgIGlmICghc2VsZi5fX2lzRGVjZWxlcmF0aW5nKSB7CgogICAgICAgICAgaWYgKHNlbGYuX19yZWZyZXNoQWN0aXZlICYmIHNlbGYuX19yZWZyZXNoU3RhcnQpIHsKCiAgICAgICAgICAgIC8vIFVzZSBwdWJsaXNoIGluc3RlYWQgb2Ygc2Nyb2xsVG8gdG8gYWxsb3cgc2Nyb2xsaW5nIHRvIG91dCBvZiBib3VuZGFyeSBwb3NpdGlvbgogICAgICAgICAgICAvLyBXZSBkb24ndCBuZWVkIHRvIG5vcm1hbGl6ZSBzY3JvbGxMZWZ0LCB6b29tTGV2ZWwsIGV0Yy4gaGVyZSBiZWNhdXNlIHdlIG9ubHkgeS1zY3JvbGxpbmcgd2hlbiBwdWxsLXRvLXJlZnJlc2ggaXMgZW5hYmxlZAogICAgICAgICAgICBzZWxmLl9fcHVibGlzaChzZWxmLl9fc2Nyb2xsTGVmdCwgLXNlbGYuX19yZWZyZXNoSGVpZ2h0LCBzZWxmLl9fem9vbUxldmVsLCB0cnVlKTsKCiAgICAgICAgICAgIGlmIChzZWxmLl9fcmVmcmVzaFN0YXJ0KSB7CiAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hTdGFydCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIGlmIChzZWxmLl9faW50ZXJydXB0ZWRBbmltYXRpb24gfHwgc2VsZi5fX2lzRHJhZ2dpbmcpIHsKICAgICAgICAgICAgICBzZWxmLl9fc2Nyb2xsaW5nQ29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLnNjcm9sbFRvKHNlbGYuX19zY3JvbGxMZWZ0LCBzZWxmLl9fc2Nyb2xsVG9wLCB0cnVlLCBzZWxmLl9fem9vbUxldmVsKTsKCiAgICAgICAgICAgIC8vIERpcmVjdGx5IHNpZ25hbGl6ZSBkZWFjdGl2YXRpb24gKG5vdGhpbmcgdG9kbyBvbiByZWZyZXNoPykKICAgICAgICAgICAgaWYgKHNlbGYuX19yZWZyZXNoQWN0aXZlKSB7CgogICAgICAgICAgICAgIHNlbGYuX19yZWZyZXNoQWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgaWYgKHNlbGYuX19yZWZyZXNoRGVhY3RpdmF0ZSkgewogICAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hEZWFjdGl2YXRlKCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRnVsbHkgY2xlYW51cCBsaXN0CiAgICAgICAgc2VsZi5fX3Bvc2l0aW9ucy5sZW5ndGggPSAwOwoKICAgICAgfSwKCgoKICAgICAgLyoKICAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgUFJJVkFURSBBUEkKICAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBBcHBsaWVzIHRoZSBzY3JvbGwgcG9zaXRpb24gdG8gdGhlIGNvbnRlbnQgZWxlbWVudAogICAgICAgKgogICAgICAgKiBAcGFyYW0gbGVmdCB7TnVtYmVyfSBMZWZ0IHNjcm9sbCBwb3NpdGlvbgogICAgICAgKiBAcGFyYW0gdG9wIHtOdW1iZXJ9IFRvcCBzY3JvbGwgcG9zaXRpb24KICAgICAgICogQHBhcmFtIGFuaW1hdGUge0Jvb2xlYW59IFdoZXRoZXIgYW5pbWF0aW9uIHNob3VsZCBiZSB1c2VkIHRvIG1vdmUgdG8gdGhlIG5ldyBjb29yZGluYXRlcwogICAgICAgKi8KICAgICAgX19wdWJsaXNoOiBmdW5jdGlvbihsZWZ0LCB0b3AsIHpvb20sIGFuaW1hdGUsIHdhc1Jlc2l6ZSkgewoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIC8vIFJlbWVtYmVyIHdoZXRoZXIgd2UgaGFkIGFuIGFuaW1hdGlvbiwgdGhlbiB3ZSB0cnkgdG8gY29udGludWUgYmFzZWQgb24gdGhlIGN1cnJlbnQgImRyaXZlIiBvZiB0aGUgYW5pbWF0aW9uCiAgICAgICAgdmFyIHdhc0FuaW1hdGluZyA9IHNlbGYuX19pc0FuaW1hdGluZzsKICAgICAgICBpZiAod2FzQW5pbWF0aW5nKSB7CiAgICAgICAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUuc3RvcCh3YXNBbmltYXRpbmcpOwogICAgICAgICAgc2VsZi5fX2lzQW5pbWF0aW5nID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoYW5pbWF0ZSAmJiBzZWxmLm9wdGlvbnMuYW5pbWF0aW5nKSB7CgogICAgICAgICAgLy8gS2VlcCBzY2hlZHVsZWQgcG9zaXRpb25zIGZvciBzY3JvbGxCeS96b29tQnkgZnVuY3Rpb25hbGl0eQogICAgICAgICAgc2VsZi5fX3NjaGVkdWxlZExlZnQgPSBsZWZ0OwogICAgICAgICAgc2VsZi5fX3NjaGVkdWxlZFRvcCA9IHRvcDsKICAgICAgICAgIHNlbGYuX19zY2hlZHVsZWRab29tID0gem9vbTsKCiAgICAgICAgICB2YXIgb2xkTGVmdCA9IHNlbGYuX19zY3JvbGxMZWZ0OwogICAgICAgICAgdmFyIG9sZFRvcCA9IHNlbGYuX19zY3JvbGxUb3A7CiAgICAgICAgICB2YXIgb2xkWm9vbSA9IHNlbGYuX196b29tTGV2ZWw7CgogICAgICAgICAgdmFyIGRpZmZMZWZ0ID0gbGVmdCAtIG9sZExlZnQ7CiAgICAgICAgICB2YXIgZGlmZlRvcCA9IHRvcCAtIG9sZFRvcDsKICAgICAgICAgIHZhciBkaWZmWm9vbSA9IHpvb20gLSBvbGRab29tOwoKICAgICAgICAgIHZhciBzdGVwID0gZnVuY3Rpb24ocGVyY2VudCwgbm93LCByZW5kZXIpIHsKCiAgICAgICAgICAgIGlmIChyZW5kZXIpIHsKCiAgICAgICAgICAgICAgc2VsZi5fX3Njcm9sbExlZnQgPSBvbGRMZWZ0ICsgKGRpZmZMZWZ0ICogcGVyY2VudCk7CiAgICAgICAgICAgICAgc2VsZi5fX3Njcm9sbFRvcCA9IG9sZFRvcCArIChkaWZmVG9wICogcGVyY2VudCk7CiAgICAgICAgICAgICAgc2VsZi5fX3pvb21MZXZlbCA9IG9sZFpvb20gKyAoZGlmZlpvb20gKiBwZXJjZW50KTsKCiAgICAgICAgICAgICAgLy8gUHVzaCB2YWx1ZXMgb3V0CiAgICAgICAgICAgICAgaWYgKHNlbGYuX19jYWxsYmFjaykgewogICAgICAgICAgICAgICAgc2VsZi5fX2NhbGxiYWNrKHNlbGYuX19zY3JvbGxMZWZ0LCBzZWxmLl9fc2Nyb2xsVG9wLCBzZWxmLl9fem9vbUxldmVsLCB3YXNSZXNpemUpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgdmFyIHZlcmlmeSA9IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9faXNBbmltYXRpbmcgPT09IGlkOwogICAgICAgICAgfTsKCiAgICAgICAgICB2YXIgY29tcGxldGVkID0gZnVuY3Rpb24ocmVuZGVyZWRGcmFtZXNQZXJTZWNvbmQsIGFuaW1hdGlvbklkLCB3YXNGaW5pc2hlZCkgewogICAgICAgICAgICBpZiAoYW5pbWF0aW9uSWQgPT09IHNlbGYuX19pc0FuaW1hdGluZykgewogICAgICAgICAgICAgIHNlbGYuX19pc0FuaW1hdGluZyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzZWxmLl9fZGlkRGVjZWxlcmF0aW9uQ29tcGxldGUgfHwgd2FzRmluaXNoZWQpIHsKICAgICAgICAgICAgICBzZWxmLl9fc2Nyb2xsaW5nQ29tcGxldGUoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy56b29taW5nKSB7CiAgICAgICAgICAgICAgc2VsZi5fX2NvbXB1dGVTY3JvbGxNYXgoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICAvLyBXaGVuIGNvbnRpbnVpbmcgYmFzZWQgb24gcHJldmlvdXMgYW5pbWF0aW9uIHdlIGNob29zZSBhbiBlYXNlLW91dCBhbmltYXRpb24gaW5zdGVhZCBvZiBlYXNlLWluLW91dAogICAgICAgICAgc2VsZi5fX2lzQW5pbWF0aW5nID0genluZ2FDb3JlLmVmZmVjdC5BbmltYXRlLnN0YXJ0KHN0ZXAsIHZlcmlmeSwgY29tcGxldGVkLCBzZWxmLm9wdGlvbnMuYW5pbWF0aW9uRHVyYXRpb24sIHdhc0FuaW1hdGluZyA/IGVhc2VPdXRDdWJpYyA6IGVhc2VJbk91dEN1YmljKTsKCiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICBzZWxmLl9fc2NoZWR1bGVkTGVmdCA9IHNlbGYuX19zY3JvbGxMZWZ0ID0gbGVmdDsKICAgICAgICAgIHNlbGYuX19zY2hlZHVsZWRUb3AgPSBzZWxmLl9fc2Nyb2xsVG9wID0gdG9wOwogICAgICAgICAgc2VsZi5fX3NjaGVkdWxlZFpvb20gPSBzZWxmLl9fem9vbUxldmVsID0gem9vbTsKCiAgICAgICAgICAvLyBQdXNoIHZhbHVlcyBvdXQKICAgICAgICAgIGlmIChzZWxmLl9fY2FsbGJhY2spIHsKICAgICAgICAgICAgc2VsZi5fX2NhbGxiYWNrKGxlZnQsIHRvcCwgem9vbSwgd2FzUmVzaXplKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBGaXggbWF4IHNjcm9sbCByYW5nZXMKICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuem9vbWluZykgewogICAgICAgICAgICBzZWxmLl9fY29tcHV0ZVNjcm9sbE1heCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogUmVjb21wdXRlcyBzY3JvbGwgbWluaW11bSB2YWx1ZXMgYmFzZWQgb24gY2xpZW50IGRpbWVuc2lvbnMgYW5kIGNvbnRlbnQgZGltZW5zaW9ucy4KICAgICAgICovCiAgICAgIF9fY29tcHV0ZVNjcm9sbE1heDogZnVuY3Rpb24oem9vbUxldmVsKSB7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgaWYgKHpvb21MZXZlbCA9PSBudWxsKSB7CiAgICAgICAgICB6b29tTGV2ZWwgPSBzZWxmLl9fem9vbUxldmVsOwogICAgICAgIH0KCiAgICAgICAgc2VsZi5fX21heFNjcm9sbExlZnQgPSBNYXRoLm1heCgoc2VsZi5fX2NvbnRlbnRXaWR0aCAqIHpvb21MZXZlbCkgLSBzZWxmLl9fY2xpZW50V2lkdGgsIDApOwogICAgICAgIHNlbGYuX19tYXhTY3JvbGxUb3AgPSBNYXRoLm1heCgoc2VsZi5fX2NvbnRlbnRIZWlnaHQgKiB6b29tTGV2ZWwpIC0gc2VsZi5fX2NsaWVudEhlaWdodCwgMCk7CgogICAgICAgIGlmKCFzZWxmLl9fZGlkV2FpdEZvclNpemUgJiYgIXNlbGYuX19tYXhTY3JvbGxMZWZ0ICYmICFzZWxmLl9fbWF4U2Nyb2xsVG9wKSB7CiAgICAgICAgICBzZWxmLl9fZGlkV2FpdEZvclNpemUgPSB0cnVlOwogICAgICAgICAgc2VsZi5fX3dhaXRGb3JTaXplKCk7CiAgICAgICAgfQogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBJZiB0aGUgc2Nyb2xsIHZpZXcgaXNuJ3Qgc2l6ZWQgY29ycmVjdGx5IG9uIHN0YXJ0LCB3YWl0IHVudGlsIHdlIGhhdmUgYXQgbGVhc3Qgc29tZSBzaXplCiAgICAgICAqLwogICAgICBfX3dhaXRGb3JTaXplOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBjbGVhclRpbWVvdXQoc2VsZi5fX3NpemVyVGltZW91dCk7CgogICAgICAgIHZhciBzaXplciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZi5yZXNpemUoKTsKCiAgICAgICAgICBpZigoc2VsZi5vcHRpb25zLnNjcm9sbGluZ1ggJiYgIXNlbGYuX19tYXhTY3JvbGxMZWZ0KSB8fCAoc2VsZi5vcHRpb25zLnNjcm9sbGluZ1kgJiYgIXNlbGYuX19tYXhTY3JvbGxUb3ApKSB7CiAgICAgICAgICAgIC8vc2VsZi5fX3NpemVyVGltZW91dCA9IHNldFRpbWVvdXQoc2l6ZXIsIDEwMDApOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHNpemVyKCk7CiAgICAgICAgc2VsZi5fX3NpemVyVGltZW91dCA9IHNldFRpbWVvdXQoc2l6ZXIsIDEwMDApOwogICAgICB9LAoKICAgICAgLyoKICAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgQU5JTUFUSU9OIChERUNFTEVSQVRJT04pIFNVUFBPUlQKICAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBDYWxsZWQgd2hlbiBhIHRvdWNoIHNlcXVlbmNlIGVuZCBhbmQgdGhlIHNwZWVkIG9mIHRoZSBmaW5nZXIgd2FzIGhpZ2ggZW5vdWdoCiAgICAgICAqIHRvIHN3aXRjaCBpbnRvIGRlY2VsZXJhdGlvbiBtb2RlLgogICAgICAgKi8KICAgICAgX19zdGFydERlY2VsZXJhdGlvbjogZnVuY3Rpb24odGltZVN0YW1wKSB7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5wYWdpbmcpIHsKCiAgICAgICAgICB2YXIgc2Nyb2xsTGVmdCA9IE1hdGgubWF4KE1hdGgubWluKHNlbGYuX19zY3JvbGxMZWZ0LCBzZWxmLl9fbWF4U2Nyb2xsTGVmdCksIDApOwogICAgICAgICAgdmFyIHNjcm9sbFRvcCA9IE1hdGgubWF4KE1hdGgubWluKHNlbGYuX19zY3JvbGxUb3AsIHNlbGYuX19tYXhTY3JvbGxUb3ApLCAwKTsKICAgICAgICAgIHZhciBjbGllbnRXaWR0aCA9IHNlbGYuX19jbGllbnRXaWR0aDsKICAgICAgICAgIHZhciBjbGllbnRIZWlnaHQgPSBzZWxmLl9fY2xpZW50SGVpZ2h0OwoKICAgICAgICAgIC8vIFdlIGxpbWl0IGRlY2VsZXJhdGlvbiBub3QgdG8gdGhlIG1pbi9tYXggdmFsdWVzIG9mIHRoZSBhbGxvd2VkIHJhbmdlLCBidXQgdG8gdGhlIHNpemUgb2YgdGhlIHZpc2libGUgY2xpZW50IGFyZWEuCiAgICAgICAgICAvLyBFYWNoIHBhZ2Ugc2hvdWxkIGhhdmUgZXhhY3RseSB0aGUgc2l6ZSBvZiB0aGUgY2xpZW50IGFyZWEuCiAgICAgICAgICBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCA9IE1hdGguZmxvb3Ioc2Nyb2xsTGVmdCAvIGNsaWVudFdpZHRoKSAqIGNsaWVudFdpZHRoOwogICAgICAgICAgc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbFRvcCA9IE1hdGguZmxvb3Ioc2Nyb2xsVG9wIC8gY2xpZW50SGVpZ2h0KSAqIGNsaWVudEhlaWdodDsKICAgICAgICAgIHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxMZWZ0ID0gTWF0aC5jZWlsKHNjcm9sbExlZnQgLyBjbGllbnRXaWR0aCkgKiBjbGllbnRXaWR0aDsKICAgICAgICAgIHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxUb3AgPSBNYXRoLmNlaWwoc2Nyb2xsVG9wIC8gY2xpZW50SGVpZ2h0KSAqIGNsaWVudEhlaWdodDsKCiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCA9IDA7CiAgICAgICAgICBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsVG9wID0gMDsKICAgICAgICAgIHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxMZWZ0ID0gc2VsZi5fX21heFNjcm9sbExlZnQ7CiAgICAgICAgICBzZWxmLl9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsVG9wID0gc2VsZi5fX21heFNjcm9sbFRvcDsKCiAgICAgICAgfQoKICAgICAgICAvLyBXcmFwIGNsYXNzIG1ldGhvZAogICAgICAgIHZhciBzdGVwID0gZnVuY3Rpb24ocGVyY2VudCwgbm93LCByZW5kZXIpIHsKICAgICAgICAgIHNlbGYuX19zdGVwVGhyb3VnaERlY2VsZXJhdGlvbihyZW5kZXIpOwogICAgICAgIH07CgogICAgICAgIC8vIEhvdyBtdWNoIHZlbG9jaXR5IGlzIHJlcXVpcmVkIHRvIGtlZXAgdGhlIGRlY2VsZXJhdGlvbiBydW5uaW5nCiAgICAgICAgc2VsZi5fX21pblZlbG9jaXR5VG9LZWVwRGVjZWxlcmF0aW5nID0gc2VsZi5vcHRpb25zLnNuYXBwaW5nID8gNCA6IDAuMTsKCiAgICAgICAgLy8gRGV0ZWN0IHdoZXRoZXIgaXQncyBzdGlsbCB3b3J0aCB0byBjb250aW51ZSBhbmltYXRpbmcgc3RlcHMKICAgICAgICAvLyBJZiB3ZSBhcmUgYWxyZWFkeSBzbG93IGVub3VnaCB0byBub3QgYmVpbmcgdXNlciBwZXJjZWl2YWJsZSBhbnltb3JlLCB3ZSBzdG9wIHRoZSB3aG9sZSBwcm9jZXNzIGhlcmUuCiAgICAgICAgdmFyIHZlcmlmeSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHNob3VsZENvbnRpbnVlID0gTWF0aC5hYnMoc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WCkgPj0gc2VsZi5fX21pblZlbG9jaXR5VG9LZWVwRGVjZWxlcmF0aW5nIHx8CiAgICAgICAgICAgIE1hdGguYWJzKHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVkpID49IHNlbGYuX19taW5WZWxvY2l0eVRvS2VlcERlY2VsZXJhdGluZzsKICAgICAgICAgIGlmICghc2hvdWxkQ29udGludWUpIHsKICAgICAgICAgICAgc2VsZi5fX2RpZERlY2VsZXJhdGlvbkNvbXBsZXRlID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vTWFrZSBzdXJlIHRoZSBzY3JvbGwgdmFsdWVzIGFyZSB3aXRoaW4gdGhlIGJvdW5kYXJpZXMgYWZ0ZXIgYSBib3VuY2UsCiAgICAgICAgICAgIC8vbm90IGJlbG93IDAgb3IgYWJvdmUgbWF4aW11bQogICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmJvdW5jaW5nKSB7CiAgICAgICAgICAgICAgc2VsZi5zY3JvbGxUbygKICAgICAgICAgICAgICAgIE1hdGgubWluKCBNYXRoLm1heChzZWxmLl9fc2Nyb2xsTGVmdCwgMCksIHNlbGYuX19tYXhTY3JvbGxMZWZ0ICksCiAgICAgICAgICAgICAgICBNYXRoLm1pbiggTWF0aC5tYXgoc2VsZi5fX3Njcm9sbFRvcCwgMCksIHNlbGYuX19tYXhTY3JvbGxUb3AgKSwKICAgICAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHNob3VsZENvbnRpbnVlOwogICAgICAgIH07CgogICAgICAgIHZhciBjb21wbGV0ZWQgPSBmdW5jdGlvbihyZW5kZXJlZEZyYW1lc1BlclNlY29uZCwgYW5pbWF0aW9uSWQsIHdhc0ZpbmlzaGVkKSB7CiAgICAgICAgICBzZWxmLl9faXNEZWNlbGVyYXRpbmcgPSBmYWxzZTsKICAgICAgICAgIGlmIChzZWxmLl9fZGlkRGVjZWxlcmF0aW9uQ29tcGxldGUpIHsKICAgICAgICAgICAgc2VsZi5fX3Njcm9sbGluZ0NvbXBsZXRlKCk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQW5pbWF0ZSB0byBncmlkIHdoZW4gc25hcHBpbmcgaXMgYWN0aXZlLCBvdGhlcndpc2UganVzdCBmaXggb3V0LW9mLWJvdW5kYXJ5IHBvc2l0aW9ucwogICAgICAgICAgaWYoc2VsZi5vcHRpb25zLnBhZ2luZykgewogICAgICAgICAgICBzZWxmLnNjcm9sbFRvKHNlbGYuX19zY3JvbGxMZWZ0LCBzZWxmLl9fc2Nyb2xsVG9wLCBzZWxmLm9wdGlvbnMuc25hcHBpbmcpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vIFN0YXJ0IGFuaW1hdGlvbiBhbmQgc3dpdGNoIG9uIGZsYWcKICAgICAgICBzZWxmLl9faXNEZWNlbGVyYXRpbmcgPSB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUuc3RhcnQoc3RlcCwgdmVyaWZ5LCBjb21wbGV0ZWQpOwoKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogQ2FsbGVkIG9uIGV2ZXJ5IHN0ZXAgb2YgdGhlIGFuaW1hdGlvbgogICAgICAgKgogICAgICAgKiBAcGFyYW0gaW5NZW1vcnkge0Jvb2xlYW59IFdoZXRoZXIgdG8gbm90IHJlbmRlciB0aGUgY3VycmVudCBzdGVwLCBidXQga2VlcCBpdCBpbiBtZW1vcnkgb25seS4gVXNlZCBpbnRlcm5hbGx5IG9ubHkhCiAgICAgICAqLwogICAgICBfX3N0ZXBUaHJvdWdoRGVjZWxlcmF0aW9uOiBmdW5jdGlvbihyZW5kZXIpIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKCiAgICAgICAgLy8KICAgICAgICAvLyBDT01QVVRFIE5FWFQgU0NST0xMIFBPU0lUSU9OCiAgICAgICAgLy8KCiAgICAgICAgLy8gQWRkIGRlY2VsZXJhdGlvbiB0byBzY3JvbGwgcG9zaXRpb24KICAgICAgICB2YXIgc2Nyb2xsTGVmdCA9IHNlbGYuX19zY3JvbGxMZWZ0ICsgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WDsvLyAqIHNlbGYub3B0aW9ucy5kZWNlbGVyYXRpb24pOwogICAgICAgIHZhciBzY3JvbGxUb3AgPSBzZWxmLl9fc2Nyb2xsVG9wICsgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WTsvLyAqIHNlbGYub3B0aW9ucy5kZWNlbGVyYXRpb24pOwoKCiAgICAgICAgLy8KICAgICAgICAvLyBIQVJEIExJTUlUIFNDUk9MTCBQT1NJVElPTiBGT1IgTk9OIEJPVU5DSU5HIE1PREUKICAgICAgICAvLwoKICAgICAgICBpZiAoIXNlbGYub3B0aW9ucy5ib3VuY2luZykgewoKICAgICAgICAgIHZhciBzY3JvbGxMZWZ0Rml4ZWQgPSBNYXRoLm1heChNYXRoLm1pbihzZWxmLl9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCwgc2Nyb2xsTGVmdCksIHNlbGYuX19taW5EZWNlbGVyYXRpb25TY3JvbGxMZWZ0KTsKICAgICAgICAgIGlmIChzY3JvbGxMZWZ0Rml4ZWQgIT09IHNjcm9sbExlZnQpIHsKICAgICAgICAgICAgc2Nyb2xsTGVmdCA9IHNjcm9sbExlZnRGaXhlZDsKICAgICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WCA9IDA7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHNjcm9sbFRvcEZpeGVkID0gTWF0aC5tYXgoTWF0aC5taW4oc2VsZi5fX21heERlY2VsZXJhdGlvblNjcm9sbFRvcCwgc2Nyb2xsVG9wKSwgc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbFRvcCk7CiAgICAgICAgICBpZiAoc2Nyb2xsVG9wRml4ZWQgIT09IHNjcm9sbFRvcCkgewogICAgICAgICAgICBzY3JvbGxUb3AgPSBzY3JvbGxUb3BGaXhlZDsKICAgICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSA9IDA7CiAgICAgICAgICB9CgogICAgICAgIH0KCgogICAgICAgIC8vCiAgICAgICAgLy8gVVBEQVRFIFNDUk9MTCBQT1NJVElPTgogICAgICAgIC8vCgogICAgICAgIGlmIChyZW5kZXIpIHsKCiAgICAgICAgICBzZWxmLl9fcHVibGlzaChzY3JvbGxMZWZ0LCBzY3JvbGxUb3AsIHNlbGYuX196b29tTGV2ZWwpOwoKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgIHNlbGYuX19zY3JvbGxMZWZ0ID0gc2Nyb2xsTGVmdDsKICAgICAgICAgIHNlbGYuX19zY3JvbGxUb3AgPSBzY3JvbGxUb3A7CgogICAgICAgIH0KCgogICAgICAgIC8vCiAgICAgICAgLy8gU0xPVyBET1dOCiAgICAgICAgLy8KCiAgICAgICAgLy8gU2xvdyBkb3duIHZlbG9jaXR5IG9uIGV2ZXJ5IGl0ZXJhdGlvbgogICAgICAgIGlmICghc2VsZi5vcHRpb25zLnBhZ2luZykgewoKICAgICAgICAgIC8vIFRoaXMgaXMgdGhlIGZhY3RvciBhcHBsaWVkIHRvIGV2ZXJ5IGl0ZXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAvLyB0byBzbG93IGRvd24gdGhlIHByb2Nlc3MuIFRoaXMgc2hvdWxkIGVtdWxhdGUgbmF0dXJhbCBiZWhhdmlvciB3aGVyZQogICAgICAgICAgLy8gb2JqZWN0cyBzbG93IGRvd24gd2hlbiB0aGUgaW5pdGlhdG9yIG9mIHRoZSBtb3ZlbWVudCBpcyByZW1vdmVkCiAgICAgICAgICB2YXIgZnJpY3Rpb25GYWN0b3IgPSBzZWxmLm9wdGlvbnMuZGVjZWxlcmF0aW9uOwoKICAgICAgICAgIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVggKj0gZnJpY3Rpb25GYWN0b3I7CiAgICAgICAgICBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZICo9IGZyaWN0aW9uRmFjdG9yOwoKICAgICAgICB9CgoKICAgICAgICAvLwogICAgICAgIC8vIEJPVU5DSU5HIFNVUFBPUlQKICAgICAgICAvLwoKICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmJvdW5jaW5nKSB7CgogICAgICAgICAgdmFyIHNjcm9sbE91dHNpZGVYID0gMDsKICAgICAgICAgIHZhciBzY3JvbGxPdXRzaWRlWSA9IDA7CgogICAgICAgICAgLy8gVGhpcyBjb25maWd1cmVzIHRoZSBhbW91bnQgb2YgY2hhbmdlIGFwcGxpZWQgdG8gZGVjZWxlcmF0aW9uL2FjY2VsZXJhdGlvbiB3aGVuIHJlYWNoaW5nIGJvdW5kYXJpZXMKICAgICAgICAgIHZhciBwZW5ldHJhdGlvbkRlY2VsZXJhdGlvbiA9IHNlbGYub3B0aW9ucy5wZW5ldHJhdGlvbkRlY2VsZXJhdGlvbjsKICAgICAgICAgIHZhciBwZW5ldHJhdGlvbkFjY2VsZXJhdGlvbiA9IHNlbGYub3B0aW9ucy5wZW5ldHJhdGlvbkFjY2VsZXJhdGlvbjsKCiAgICAgICAgICAvLyBDaGVjayBsaW1pdHMKICAgICAgICAgIGlmIChzY3JvbGxMZWZ0IDwgc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbExlZnQpIHsKICAgICAgICAgICAgc2Nyb2xsT3V0c2lkZVggPSBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCAtIHNjcm9sbExlZnQ7CiAgICAgICAgICB9IGVsc2UgaWYgKHNjcm9sbExlZnQgPiBzZWxmLl9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCkgewogICAgICAgICAgICBzY3JvbGxPdXRzaWRlWCA9IHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxMZWZ0IC0gc2Nyb2xsTGVmdDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc2Nyb2xsVG9wIDwgc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbFRvcCkgewogICAgICAgICAgICBzY3JvbGxPdXRzaWRlWSA9IHNlbGYuX19taW5EZWNlbGVyYXRpb25TY3JvbGxUb3AgLSBzY3JvbGxUb3A7CiAgICAgICAgICB9IGVsc2UgaWYgKHNjcm9sbFRvcCA+IHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxUb3ApIHsKICAgICAgICAgICAgc2Nyb2xsT3V0c2lkZVkgPSBzZWxmLl9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsVG9wIC0gc2Nyb2xsVG9wOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFNsb3cgZG93biB1bnRpbCBzbG93IGVub3VnaCwgdGhlbiBmbGlwIGJhY2sgdG8gc25hcCBwb3NpdGlvbgogICAgICAgICAgaWYgKHNjcm9sbE91dHNpZGVYICE9PSAwKSB7CiAgICAgICAgICAgIHZhciBpc0hlYWRpbmdPdXR3YXJkc1ggPSBzY3JvbGxPdXRzaWRlWCAqIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVggPD0gc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbExlZnQ7CiAgICAgICAgICAgIGlmIChpc0hlYWRpbmdPdXR3YXJkc1gpIHsKICAgICAgICAgICAgICBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYICs9IHNjcm9sbE91dHNpZGVYICogcGVuZXRyYXRpb25EZWNlbGVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlzU3RvcHBlZFggPSBNYXRoLmFicyhzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYKSA8PSBzZWxmLl9fbWluVmVsb2NpdHlUb0tlZXBEZWNlbGVyYXRpbmc7CiAgICAgICAgICAgIC8vSWYgd2UncmUgbm90IGhlYWRpbmcgb3V0d2FyZHMsIG9yIGlmIHRoZSBhYm92ZSBzdGF0ZW1lbnQgZ290IHVzIGJlbG93IG1pbkRlY2VsZXJhdGlvbiwgZ28gYmFjayB0b3dhcmRzIGJvdW5kcwogICAgICAgICAgICBpZiAoIWlzSGVhZGluZ091dHdhcmRzWCB8fCBpc1N0b3BwZWRYKSB7CiAgICAgICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WCA9IHNjcm9sbE91dHNpZGVYICogcGVuZXRyYXRpb25BY2NlbGVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc2Nyb2xsT3V0c2lkZVkgIT09IDApIHsKICAgICAgICAgICAgdmFyIGlzSGVhZGluZ091dHdhcmRzWSA9IHNjcm9sbE91dHNpZGVZICogc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSA8PSBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsVG9wOwogICAgICAgICAgICBpZiAoaXNIZWFkaW5nT3V0d2FyZHNZKSB7CiAgICAgICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSArPSBzY3JvbGxPdXRzaWRlWSAqIHBlbmV0cmF0aW9uRGVjZWxlcmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc1N0b3BwZWRZID0gTWF0aC5hYnMoc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSkgPD0gc2VsZi5fX21pblZlbG9jaXR5VG9LZWVwRGVjZWxlcmF0aW5nOwogICAgICAgICAgICAvL0lmIHdlJ3JlIG5vdCBoZWFkaW5nIG91dHdhcmRzLCBvciBpZiB0aGUgYWJvdmUgc3RhdGVtZW50IGdvdCB1cyBiZWxvdyBtaW5EZWNlbGVyYXRpb24sIGdvIGJhY2sgdG93YXJkcyBib3VuZHMKICAgICAgICAgICAgaWYgKCFpc0hlYWRpbmdPdXR3YXJkc1kgfHwgaXNTdG9wcGVkWSkgewogICAgICAgICAgICAgIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVkgPSBzY3JvbGxPdXRzaWRlWSAqIHBlbmV0cmF0aW9uQWNjZWxlcmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBjYWxjdWxhdGUgdGhlIGRpc3RhbmNlIGJldHdlZW4gdHdvIHRvdWNoZXMKICAgICAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gxCiAgICAgICAqIEBwYXJhbSAgIHtUb3VjaH0gICAgIHRvdWNoMgogICAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSAgICBkaXN0YW5jZQogICAgICAgKi8KICAgICAgX19nZXREaXN0YW5jZTogZnVuY3Rpb24gZ2V0RGlzdGFuY2UodG91Y2gxLCB0b3VjaDIpIHsKICAgICAgICB2YXIgeCA9IHRvdWNoMi5wYWdlWCAtIHRvdWNoMS5wYWdlWCwKICAgICAgICAgIHkgPSB0b3VjaDIucGFnZVkgLSB0b3VjaDEucGFnZVk7CiAgICAgICAgcmV0dXJuIE1hdGguc3FydCgoeCp4KSArICh5KnkpKTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogY2FsY3VsYXRlIHRoZSBzY2FsZSBmYWN0b3IgYmV0d2VlbiB0d28gdG91Y2hMaXN0cyAoZmluZ2VycykKICAgICAgICogbm8gc2NhbGUgaXMgMSwgYW5kIGdvZXMgZG93biB0byAwIHdoZW4gcGluY2hlZCB0b2dldGhlciwgYW5kIGJpZ2dlciB3aGVuIHBpbmNoZWQgb3V0CiAgICAgICAqIEBwYXJhbSAgIHtBcnJheX0gICAgIHN0YXJ0CiAgICAgICAqIEBwYXJhbSAgIHtBcnJheX0gICAgIGVuZAogICAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSAgICBzY2FsZQogICAgICAgKi8KICAgICAgX19nZXRTY2FsZTogZnVuY3Rpb24gZ2V0U2NhbGUoc3RhcnQsIGVuZCkgewoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIC8vIG5lZWQgdHdvIGZpbmdlcnMuLi4KICAgICAgICBpZihzdGFydC5sZW5ndGggPj0gMiAmJiBlbmQubGVuZ3RoID49IDIpIHsKICAgICAgICAgIHJldHVybiBzZWxmLl9fZ2V0RGlzdGFuY2UoZW5kWzBdLCBlbmRbMV0pIC8KICAgICAgICAgICAgc2VsZi5fX2dldERpc3RhbmNlKHN0YXJ0WzBdLCBzdGFydFsxXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAxOwogICAgICB9CiAgICB9KTsKCiAgICBpb25pYy5zY3JvbGwgPSB7CiAgICAgIGlzU2Nyb2xsaW5nOiBmYWxzZSwKICAgICAgbGFzdFRvcDogMAogICAgfTsKCiAgfSkoaW9uaWMpOwoKICAoZnVuY3Rpb24oaW9uaWMpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICBpb25pYy52aWV3cy5IZWFkZXJCYXIgPSBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQoewogICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgICAgdGhpcy5lbCA9IG9wdHMuZWw7CgogICAgICAgIGlvbmljLmV4dGVuZCh0aGlzLCB7CiAgICAgICAgICBhbGlnblRpdGxlOiAnY2VudGVyJwogICAgICAgIH0sIG9wdHMpOwoKICAgICAgICB0aGlzLmFsaWduKCk7CiAgICAgIH0sCgogICAgICBhbGlnbjogZnVuY3Rpb24oYWxpZ24pIHsKCiAgICAgICAgYWxpZ24gfHwgKGFsaWduID0gdGhpcy5hbGlnblRpdGxlKTsKCiAgICAgICAgLy8gRmluZCB0aGUgdGl0bGVFbCBlbGVtZW50CiAgICAgICAgdmFyIHRpdGxlRWwgPSB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3IoJy50aXRsZScpOwogICAgICAgIGlmKCF0aXRsZUVsKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgLy9XZSBoYXZlIHRvIHJBRiBoZXJlIHNvIGFsbCBvZiB0aGUgZWxlbWVudHMgaGF2ZSB0aW1lIHRvIGluaXRpYWxpemUKICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgaSwgYywgY2hpbGRTaXplOwogICAgICAgICAgdmFyIGNoaWxkTm9kZXMgPSBzZWxmLmVsLmNoaWxkTm9kZXM7CiAgICAgICAgICB2YXIgbGVmdFdpZHRoID0gMDsKICAgICAgICAgIHZhciByaWdodFdpZHRoID0gMDsKICAgICAgICAgIHZhciBpc0NvdW50aW5nUmlnaHRXaWR0aCA9IGZhbHNlOwoKICAgICAgICAgIC8vIENvbXB1dGUgaG93IHdpZGUgdGhlIGxlZnQgY2hpbGRyZW4gYXJlCiAgICAgICAgICAvLyBTa2lwIGFsbCB0aXRsZXMgKHRoZXJlIG1heSBzdGlsbCBiZSB0d28gdGl0bGVzLCBvbmUgbGVhdmluZyB0aGUgZG9tKQogICAgICAgICAgLy8gT25jZSB3ZSBlbmNvdW50ZXIgYSB0aXRsZUVsLCByZWFsaXplIHdlIGFyZSBub3cgY291bnRpbmcgdGhlIHJpZ2h0LWJ1dHRvbnMsIG5vdCBsZWZ0CiAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBjaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGMgPSBjaGlsZE5vZGVzW2ldOwogICAgICAgICAgICBpZiAoYy50YWdOYW1lICYmIGMudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09ICdoMScpIHsKICAgICAgICAgICAgICBpc0NvdW50aW5nUmlnaHRXaWR0aCA9IHRydWU7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNoaWxkU2l6ZSA9IG51bGw7CiAgICAgICAgICAgIGlmKGMubm9kZVR5cGUgPT0gMykgewogICAgICAgICAgICAgIHZhciBib3VuZHMgPSBpb25pYy5Eb21VdGlsLmdldFRleHRCb3VuZHMoYyk7CiAgICAgICAgICAgICAgaWYoYm91bmRzKSB7CiAgICAgICAgICAgICAgICBjaGlsZFNpemUgPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYoYy5ub2RlVHlwZSA9PSAxKSB7CiAgICAgICAgICAgICAgY2hpbGRTaXplID0gYy5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihjaGlsZFNpemUpIHsKICAgICAgICAgICAgICBpZiAoaXNDb3VudGluZ1JpZ2h0V2lkdGgpIHsKICAgICAgICAgICAgICAgIHJpZ2h0V2lkdGggKz0gY2hpbGRTaXplOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsZWZ0V2lkdGggKz0gY2hpbGRTaXplOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHZhciBtYXJnaW4gPSBNYXRoLm1heChsZWZ0V2lkdGgsIHJpZ2h0V2lkdGgpICsgMTA7CgogICAgICAgICAgLy9SZXNldCBsZWZ0IGFuZCByaWdodCBiZWZvcmUgc2V0dGluZyBhZ2FpbgogICAgICAgICAgdGl0bGVFbC5zdHlsZS5sZWZ0ID0gdGl0bGVFbC5zdHlsZS5yaWdodCA9ICcnOwoKICAgICAgICAgIC8vIFNpemUgYW5kIGFsaWduIHRoZSBoZWFkZXIgdGl0bGVFbCBiYXNlZCBvbiB0aGUgc2l6ZXMgb2YgdGhlIGxlZnQgYW5kCiAgICAgICAgICAvLyByaWdodCBjaGlsZHJlbiwgYW5kIHRoZSBkZXNpcmVkIGFsaWdubWVudCBtb2RlCiAgICAgICAgICBpZihhbGlnbiA9PSAnY2VudGVyJykgewogICAgICAgICAgICBpZihtYXJnaW4gPiAxMCkgewogICAgICAgICAgICAgIHRpdGxlRWwuc3R5bGUubGVmdCA9IG1hcmdpbiArICdweCc7CiAgICAgICAgICAgICAgdGl0bGVFbC5zdHlsZS5yaWdodCA9IG1hcmdpbiArICdweCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYodGl0bGVFbC5vZmZzZXRXaWR0aCA8IHRpdGxlRWwuc2Nyb2xsV2lkdGgpIHsKICAgICAgICAgICAgICBpZihyaWdodFdpZHRoID4gMCkgewogICAgICAgICAgICAgICAgdGl0bGVFbC5zdHlsZS5yaWdodCA9IChyaWdodFdpZHRoICsgNSkgKyAncHgnOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmKGFsaWduID09ICdsZWZ0JykgewogICAgICAgICAgICB0aXRsZUVsLmNsYXNzTGlzdC5hZGQoJ3RpdGxlLWxlZnQnKTsKICAgICAgICAgICAgaWYobGVmdFdpZHRoID4gMCkgewogICAgICAgICAgICAgIHRpdGxlRWwuc3R5bGUubGVmdCA9IChsZWZ0V2lkdGggKyAxNSkgKyAncHgnOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYoYWxpZ24gPT0gJ3JpZ2h0JykgewogICAgICAgICAgICB0aXRsZUVsLmNsYXNzTGlzdC5hZGQoJ3RpdGxlLXJpZ2h0Jyk7CiAgICAgICAgICAgIGlmKHJpZ2h0V2lkdGggPiAwKSB7CiAgICAgICAgICAgICAgdGl0bGVFbC5zdHlsZS5yaWdodCA9IChyaWdodFdpZHRoICsgMTUpICsgJ3B4JzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKCiAgfSkoaW9uaWMpOwoKICAoZnVuY3Rpb24oaW9uaWMpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICB2YXIgSVRFTV9DTEFTUyA9ICdpdGVtJzsKICAgIHZhciBJVEVNX0NPTlRFTlRfQ0xBU1MgPSAnaXRlbS1jb250ZW50JzsKICAgIHZhciBJVEVNX1NMSURJTkdfQ0xBU1MgPSAnaXRlbS1zbGlkaW5nJzsKICAgIHZhciBJVEVNX09QVElPTlNfQ0xBU1MgPSAnaXRlbS1vcHRpb25zJzsKICAgIHZhciBJVEVNX1BMQUNFSE9MREVSX0NMQVNTID0gJ2l0ZW0tcGxhY2Vob2xkZXInOwogICAgdmFyIElURU1fUkVPUkRFUklOR19DTEFTUyA9ICdpdGVtLXJlb3JkZXJpbmcnOwogICAgdmFyIElURU1fUkVPUkRFUl9CVE5fQ0xBU1MgPSAnaXRlbS1yZW9yZGVyJzsKCiAgICB2YXIgRHJhZ09wID0gZnVuY3Rpb24oKSB7fTsKICAgIERyYWdPcC5wcm90b3R5cGUgPSB7CiAgICAgIHN0YXJ0OiBmdW5jdGlvbihlKSB7CiAgICAgIH0sCiAgICAgIGRyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgfSwKICAgICAgZW5kOiBmdW5jdGlvbihlKSB7CiAgICAgIH0sCiAgICAgIGlzU2FtZUl0ZW06IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH07CgogICAgdmFyIFNsaWRlRHJhZyA9IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgdGhpcy5kcmFnVGhyZXNob2xkWCA9IG9wdHMuZHJhZ1RocmVzaG9sZFggfHwgMTA7CiAgICAgIHRoaXMuZWwgPSBvcHRzLmVsOwogICAgICB0aGlzLmNhblN3aXBlID0gb3B0cy5jYW5Td2lwZTsKICAgIH07CgogICAgU2xpZGVEcmFnLnByb3RvdHlwZSA9IG5ldyBEcmFnT3AoKTsKCiAgICBTbGlkZURyYWcucHJvdG90eXBlLnN0YXJ0ID0gZnVuY3Rpb24oZSkgewogICAgICB2YXIgY29udGVudCwgYnV0dG9ucywgb2Zmc2V0WCwgYnV0dG9uc1dpZHRoOwoKICAgICAgaWYgKCF0aGlzLmNhblN3aXBlKCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmKGUudGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucyhJVEVNX0NPTlRFTlRfQ0xBU1MpKSB7CiAgICAgICAgY29udGVudCA9IGUudGFyZ2V0OwogICAgICB9IGVsc2UgaWYoZS50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKElURU1fQ0xBU1MpKSB7CiAgICAgICAgY29udGVudCA9IGUudGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoJy4nICsgSVRFTV9DT05URU5UX0NMQVNTKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb250ZW50ID0gaW9uaWMuRG9tVXRpbC5nZXRQYXJlbnRXaXRoQ2xhc3MoZS50YXJnZXQsIElURU1fQ09OVEVOVF9DTEFTUyk7CiAgICAgIH0KCiAgICAgIC8vIElmIHdlIGRvbid0IGhhdmUgYSBjb250ZW50IGFyZWEgYXMgb25lIG9mIG91ciBjaGlsZHJlbiAob3Igb3Vyc2VsdmVzKSwgc2tpcAogICAgICBpZighY29udGVudCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gTWFrZSBzdXJlIHdlIGFyZW4ndCBhbmltYXRpbmcgYXMgd2Ugc2xpZGUKICAgICAgY29udGVudC5jbGFzc0xpc3QucmVtb3ZlKElURU1fU0xJRElOR19DTEFTUyk7CgogICAgICAvLyBHcmFiIHRoZSBzdGFydGluZyBYIHBvaW50IGZvciB0aGUgaXRlbSAoZm9yIGV4YW1wbGUsIHNvIHdlIGNhbiB0ZWxsIHdoZXRoZXIgaXQgaXMgb3BlbiBvciBjbG9zZWQgdG8gc3RhcnQpCiAgICAgIG9mZnNldFggPSBwYXJzZUZsb2F0KGNvbnRlbnQuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0ucmVwbGFjZSgndHJhbnNsYXRlM2QoJywgJycpLnNwbGl0KCcsJylbMF0pIHx8IDA7CgogICAgICAvLyBHcmFiIHRoZSBidXR0b25zCiAgICAgIGJ1dHRvbnMgPSBjb250ZW50LnBhcmVudE5vZGUucXVlcnlTZWxlY3RvcignLicgKyBJVEVNX09QVElPTlNfQ0xBU1MpOwogICAgICBpZighYnV0dG9ucykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBidXR0b25zLmNsYXNzTGlzdC5yZW1vdmUoJ2ludmlzaWJsZScpOwoKICAgICAgYnV0dG9uc1dpZHRoID0gYnV0dG9ucy5vZmZzZXRXaWR0aDsKCiAgICAgIHRoaXMuX2N1cnJlbnREcmFnID0gewogICAgICAgIGJ1dHRvbnM6IGJ1dHRvbnMsCiAgICAgICAgYnV0dG9uc1dpZHRoOiBidXR0b25zV2lkdGgsCiAgICAgICAgY29udGVudDogY29udGVudCwKICAgICAgICBzdGFydE9mZnNldFg6IG9mZnNldFgKICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDaGVjayBpZiB0aGlzIGlzIHRoZSBzYW1lIGl0ZW0gdGhhdCB3YXMgcHJldmlvdXNseSBkcmFnZ2VkLgogICAgICovCiAgICBTbGlkZURyYWcucHJvdG90eXBlLmlzU2FtZUl0ZW0gPSBmdW5jdGlvbihvcCkgewogICAgICBpZihvcC5fbGFzdERyYWcgJiYgdGhpcy5fY3VycmVudERyYWcpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY3VycmVudERyYWcuY29udGVudCA9PSBvcC5fbGFzdERyYWcuY29udGVudDsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIFNsaWRlRHJhZy5wcm90b3R5cGUuY2xlYW4gPSBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBsYXN0RHJhZyA9IHRoaXMuX2xhc3REcmFnOwoKICAgICAgaWYoIWxhc3REcmFnKSByZXR1cm47CgogICAgICBsYXN0RHJhZy5jb250ZW50LnN0eWxlW2lvbmljLkNTUy5UUkFOU0lUSU9OXSA9ICcnOwogICAgICBsYXN0RHJhZy5jb250ZW50LnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJyc7CiAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgbGFzdERyYWcuYnV0dG9ucyAmJiBsYXN0RHJhZy5idXR0b25zLmNsYXNzTGlzdC5hZGQoJ2ludmlzaWJsZScpOwogICAgICAgIH0sIDI1MCk7CiAgICAgIH0pOwogICAgfTsKCiAgICBTbGlkZURyYWcucHJvdG90eXBlLmRyYWcgPSBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlKGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGJ1dHRvbnNXaWR0aDsKCiAgICAgIC8vIFdlIHJlYWxseSBhcmVuJ3QgZHJhZ2dpbmcKICAgICAgaWYoIXRoaXMuX2N1cnJlbnREcmFnKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBDaGVjayBpZiB3ZSBzaG91bGQgc3RhcnQgZHJhZ2dpbmcuIENoZWNrIGlmIHdlJ3ZlIGRyYWdnZWQgcGFzdCB0aGUgdGhyZXNob2xkLAogICAgICAvLyBvciB3ZSBhcmUgc3RhcnRpbmcgZnJvbSB0aGUgb3BlbiBzdGF0ZS4KICAgICAgaWYoIXRoaXMuX2lzRHJhZ2dpbmcgJiYKICAgICAgICAoKE1hdGguYWJzKGUuZ2VzdHVyZS5kZWx0YVgpID4gdGhpcy5kcmFnVGhyZXNob2xkWCkgfHwKICAgICAgICAgIChNYXRoLmFicyh0aGlzLl9jdXJyZW50RHJhZy5zdGFydE9mZnNldFgpID4gMCkpKQogICAgICB7CiAgICAgICAgdGhpcy5faXNEcmFnZ2luZyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmKHRoaXMuX2lzRHJhZ2dpbmcpIHsKICAgICAgICBidXR0b25zV2lkdGggPSB0aGlzLl9jdXJyZW50RHJhZy5idXR0b25zV2lkdGg7CgogICAgICAgIC8vIEdyYWIgdGhlIG5ldyBYIHBvaW50LCBjYXBwaW5nIGl0IGF0IHplcm8KICAgICAgICB2YXIgbmV3WCA9IE1hdGgubWluKDAsIHRoaXMuX2N1cnJlbnREcmFnLnN0YXJ0T2Zmc2V0WCArIGUuZ2VzdHVyZS5kZWx0YVgpOwoKICAgICAgICAvLyBJZiB0aGUgbmV3IFggcG9zaXRpb24gaXMgcGFzdCB0aGUgYnV0dG9ucywgd2UgbmVlZCB0byBzbG93IGRvd24gdGhlIGRyYWcgKHJ1YmJlciBiYW5kIHN0eWxlKQogICAgICAgIGlmKG5ld1ggPCAtYnV0dG9uc1dpZHRoKSB7CiAgICAgICAgICAvLyBDYWxjdWxhdGUgdGhlIG5ldyBYIHBvc2l0aW9uLCBjYXBwZWQgYXQgdGhlIHRvcCBvZiB0aGUgYnV0dG9ucwogICAgICAgICAgbmV3WCA9IE1hdGgubWluKC1idXR0b25zV2lkdGgsIC1idXR0b25zV2lkdGggKyAoKChlLmdlc3R1cmUuZGVsdGFYICsgYnV0dG9uc1dpZHRoKSAqIDAuNCkpKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2N1cnJlbnREcmFnLmNvbnRlbnQuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAndHJhbnNsYXRlM2QoJyArIG5ld1ggKyAncHgsIDAsIDApJzsKICAgICAgICB0aGlzLl9jdXJyZW50RHJhZy5jb250ZW50LnN0eWxlW2lvbmljLkNTUy5UUkFOU0lUSU9OXSA9ICdub25lJzsKICAgICAgfQogICAgfSk7CgogICAgU2xpZGVEcmFnLnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbihlLCBkb25lQ2FsbGJhY2spIHsKICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgIC8vIFRoZXJlIGlzIG5vIGRyYWcsIGp1c3QgZW5kIGltbWVkaWF0ZWx5CiAgICAgIGlmKCF0aGlzLl9jdXJyZW50RHJhZykgewogICAgICAgIGRvbmVDYWxsYmFjayAmJiBkb25lQ2FsbGJhY2soKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIElmIHdlIGFyZSBjdXJyZW50bHkgZHJhZ2dpbmcsIHdlIHdhbnQgdG8gc25hcCBiYWNrIGludG8gcGxhY2UKICAgICAgLy8gVGhlIGZpbmFsIHJlc3RpbmcgcG9pbnQgWCB3aWxsIGJlIHRoZSB3aWR0aCBvZiB0aGUgZXhwb3NlZCBidXR0b25zCiAgICAgIHZhciByZXN0aW5nUG9pbnQgPSAtdGhpcy5fY3VycmVudERyYWcuYnV0dG9uc1dpZHRoOwoKICAgICAgLy8gQ2hlY2sgaWYgdGhlIGRyYWcgZGlkbid0IGNsZWFyIHRoZSBidXR0b25zIG1pZC1wb2ludAogICAgICAvLyBhbmQgd2UgYXJlbid0IG1vdmluZyBmYXN0IGVub3VnaCB0byBzd2lwZSBvcGVuCiAgICAgIGlmKGUuZ2VzdHVyZS5kZWx0YVggPiAtKHRoaXMuX2N1cnJlbnREcmFnLmJ1dHRvbnNXaWR0aC8yKSkgewoKICAgICAgICAvLyBJZiB3ZSBhcmUgZ29pbmcgbGVmdCBidXQgdG9vIHNsb3csIG9yIGdvaW5nIHJpZ2h0LCBnbyBiYWNrIHRvIHJlc3RpbmcKICAgICAgICBpZihlLmdlc3R1cmUuZGlyZWN0aW9uID09ICJsZWZ0IiAmJiBNYXRoLmFicyhlLmdlc3R1cmUudmVsb2NpdHlYKSA8IDAuMykgewogICAgICAgICAgcmVzdGluZ1BvaW50ID0gMDsKICAgICAgICB9IGVsc2UgaWYoZS5nZXN0dXJlLmRpcmVjdGlvbiA9PSAicmlnaHQiKSB7CiAgICAgICAgICByZXN0aW5nUG9pbnQgPSAwOwogICAgICAgIH0KCiAgICAgIH0KCiAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICBpZihyZXN0aW5nUG9pbnQgPT09IDApIHsKICAgICAgICAgIF90aGlzLl9jdXJyZW50RHJhZy5jb250ZW50LnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJyc7CiAgICAgICAgICB2YXIgYnV0dG9ucyA9IF90aGlzLl9jdXJyZW50RHJhZy5idXR0b25zOwogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgYnV0dG9ucyAmJiBidXR0b25zLmNsYXNzTGlzdC5hZGQoJ2ludmlzaWJsZScpOwogICAgICAgICAgfSwgMjUwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgX3RoaXMuX2N1cnJlbnREcmFnLmNvbnRlbnQuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAndHJhbnNsYXRlM2QoJyArIHJlc3RpbmdQb2ludCArICdweCwgMCwgMCknOwogICAgICAgIH0KICAgICAgICBfdGhpcy5fY3VycmVudERyYWcuY29udGVudC5zdHlsZVtpb25pYy5DU1MuVFJBTlNJVElPTl0gPSAnJzsKCgogICAgICAgIC8vIEtpbGwgdGhlIGN1cnJlbnQgZHJhZwogICAgICAgIF90aGlzLl9sYXN0RHJhZyA9IF90aGlzLl9jdXJyZW50RHJhZzsKICAgICAgICBfdGhpcy5fY3VycmVudERyYWcgPSBudWxsOwoKICAgICAgICAvLyBXZSBhcmUgZG9uZSwgbm90aWZ5IGNhbGxlcgogICAgICAgIGRvbmVDYWxsYmFjayAmJiBkb25lQ2FsbGJhY2soKTsKICAgICAgfSk7CiAgICB9OwoKICAgIHZhciBSZW9yZGVyRHJhZyA9IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgdGhpcy5kcmFnVGhyZXNob2xkWSA9IG9wdHMuZHJhZ1RocmVzaG9sZFkgfHwgMDsKICAgICAgdGhpcy5vblJlb3JkZXIgPSBvcHRzLm9uUmVvcmRlcjsKICAgICAgdGhpcy5saXN0RWwgPSBvcHRzLmxpc3RFbDsKICAgICAgdGhpcy5lbCA9IG9wdHMuZWw7CiAgICAgIHRoaXMuc2Nyb2xsRWwgPSBvcHRzLnNjcm9sbEVsOwogICAgICB0aGlzLnNjcm9sbFZpZXcgPSBvcHRzLnNjcm9sbFZpZXc7CiAgICAgIC8vIEdldCB0aGUgVHJ1ZSBUb3Agb2YgdGhlIGxpc3QgZWwgaHR0cDovL3d3dy5xdWlya3Ntb2RlLm9yZy9qcy9maW5kcG9zLmh0bWwKICAgICAgdGhpcy5saXN0RWxUcnVlVG9wID0gMDsKICAgICAgaWYgKHRoaXMubGlzdEVsLm9mZnNldFBhcmVudCkgewogICAgICAgIHZhciBvYmogPSB0aGlzLmxpc3RFbDsKICAgICAgICBkbyB7CiAgICAgICAgICB0aGlzLmxpc3RFbFRydWVUb3AgKz0gb2JqLm9mZnNldFRvcDsKICAgICAgICAgIG9iaiA9IG9iai5vZmZzZXRQYXJlbnQ7CiAgICAgICAgfSB3aGlsZSAob2JqKTsKICAgICAgfQogICAgfTsKCiAgICBSZW9yZGVyRHJhZy5wcm90b3R5cGUgPSBuZXcgRHJhZ09wKCk7CgogICAgUmVvcmRlckRyYWcucHJvdG90eXBlLl9tb3ZlRWxlbWVudCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIHkgPSBlLmdlc3R1cmUuY2VudGVyLnBhZ2VZICsKICAgICAgICB0aGlzLnNjcm9sbFZpZXcuZ2V0VmFsdWVzKCkudG9wIC0KICAgICAgICAodGhpcy5fY3VycmVudERyYWcuZWxlbWVudEhlaWdodCAvIDIpIC0KICAgICAgICB0aGlzLmxpc3RFbFRydWVUb3A7CiAgICAgIHRoaXMuZWwuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAndHJhbnNsYXRlM2QoMCwgJyt5KydweCwgMCknOwogICAgfTsKCiAgICBSZW9yZGVyRHJhZy5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBjb250ZW50OwoKICAgICAgdmFyIHN0YXJ0SW5kZXggPSBpb25pYy5Eb21VdGlsLmdldENoaWxkSW5kZXgodGhpcy5lbCwgdGhpcy5lbC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgdmFyIGVsZW1lbnRIZWlnaHQgPSB0aGlzLmVsLnNjcm9sbEhlaWdodDsKICAgICAgdmFyIHBsYWNlaG9sZGVyID0gdGhpcy5lbC5jbG9uZU5vZGUodHJ1ZSk7CgogICAgICBwbGFjZWhvbGRlci5jbGFzc0xpc3QuYWRkKElURU1fUExBQ0VIT0xERVJfQ0xBU1MpOwoKICAgICAgdGhpcy5lbC5wYXJlbnROb2RlLmluc2VydEJlZm9yZShwbGFjZWhvbGRlciwgdGhpcy5lbCk7CiAgICAgIHRoaXMuZWwuY2xhc3NMaXN0LmFkZChJVEVNX1JFT1JERVJJTkdfQ0xBU1MpOwoKICAgICAgdGhpcy5fY3VycmVudERyYWcgPSB7CiAgICAgICAgZWxlbWVudEhlaWdodDogZWxlbWVudEhlaWdodCwKICAgICAgICBzdGFydEluZGV4OiBzdGFydEluZGV4LAogICAgICAgIHBsYWNlaG9sZGVyOiBwbGFjZWhvbGRlciwKICAgICAgICBzY3JvbGxIZWlnaHQ6IHNjcm9sbCwKICAgICAgICBsaXN0OiBwbGFjZWhvbGRlci5wYXJlbnROb2RlCiAgICAgIH07CgogICAgICB0aGlzLl9tb3ZlRWxlbWVudChlKTsKICAgIH07CgogICAgUmVvcmRlckRyYWcucHJvdG90eXBlLmRyYWcgPSBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlKGZ1bmN0aW9uKGUpIHsKICAgICAgLy8gV2UgcmVhbGx5IGFyZW4ndCBkcmFnZ2luZwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIGlmKCF0aGlzLl9jdXJyZW50RHJhZykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHNjcm9sbFkgPSAwOwogICAgICB2YXIgcGFnZVkgPSBlLmdlc3R1cmUuY2VudGVyLnBhZ2VZOwogICAgICB2YXIgb2Zmc2V0ID0gdGhpcy5saXN0RWxUcnVlVG9wOwoKICAgICAgLy9JZiB3ZSBoYXZlIGEgc2Nyb2xsVmlldywgY2hlY2sgc2Nyb2xsIGJvdW5kYXJpZXMgZm9yIGRyYWdnZWQgZWxlbWVudCBhbmQgc2Nyb2xsIGlmIG5lY2Vzc2FyeQogICAgICBpZiAodGhpcy5zY3JvbGxWaWV3KSB7CgogICAgICAgIHZhciBjb250YWluZXIgPSB0aGlzLnNjcm9sbFZpZXcuX19jb250YWluZXI7CiAgICAgICAgc2Nyb2xsWSA9IHRoaXMuc2Nyb2xsVmlldy5nZXRWYWx1ZXMoKS50b3A7CgogICAgICAgIHZhciBjb250YWluZXJUb3AgPSBjb250YWluZXIub2Zmc2V0VG9wOwogICAgICAgIHZhciBwaXhlbHNQYXN0VG9wID0gY29udGFpbmVyVG9wIC0gcGFnZVkgKyB0aGlzLl9jdXJyZW50RHJhZy5lbGVtZW50SGVpZ2h0LzI7CiAgICAgICAgdmFyIHBpeGVsc1Bhc3RCb3R0b20gPSBwYWdlWSArIHRoaXMuX2N1cnJlbnREcmFnLmVsZW1lbnRIZWlnaHQvMiAtIGNvbnRhaW5lclRvcCAtIGNvbnRhaW5lci5vZmZzZXRIZWlnaHQ7CgogICAgICAgIGlmIChlLmdlc3R1cmUuZGVsdGFZIDwgMCAmJiBwaXhlbHNQYXN0VG9wID4gMCAmJiBzY3JvbGxZID4gMCkgewogICAgICAgICAgdGhpcy5zY3JvbGxWaWV3LnNjcm9sbEJ5KG51bGwsIC1waXhlbHNQYXN0VG9wKTsKICAgICAgICAgIC8vVHJpZ2dlciBhbm90aGVyIGRyYWcgc28gdGhlIHNjcm9sbGluZyBrZWVwcyBnb2luZwogICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzZWxmLmRyYWcoZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKGUuZ2VzdHVyZS5kZWx0YVkgPiAwICYmIHBpeGVsc1Bhc3RCb3R0b20gPiAwKSB7CiAgICAgICAgICBpZiAoc2Nyb2xsWSA8IHRoaXMuc2Nyb2xsVmlldy5nZXRTY3JvbGxNYXgoKS50b3ApIHsKICAgICAgICAgICAgdGhpcy5zY3JvbGxWaWV3LnNjcm9sbEJ5KG51bGwsIHBpeGVsc1Bhc3RCb3R0b20pOwogICAgICAgICAgICAvL1RyaWdnZXIgYW5vdGhlciBkcmFnIHNvIHRoZSBzY3JvbGxpbmcga2VlcHMgZ29pbmcKICAgICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYuZHJhZyhlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBDaGVjayBpZiB3ZSBzaG91bGQgc3RhcnQgZHJhZ2dpbmcuIENoZWNrIGlmIHdlJ3ZlIGRyYWdnZWQgcGFzdCB0aGUgdGhyZXNob2xkLAogICAgICAvLyBvciB3ZSBhcmUgc3RhcnRpbmcgZnJvbSB0aGUgb3BlbiBzdGF0ZS4KICAgICAgaWYoIXRoaXMuX2lzRHJhZ2dpbmcgJiYgTWF0aC5hYnMoZS5nZXN0dXJlLmRlbHRhWSkgPiB0aGlzLmRyYWdUaHJlc2hvbGRZKSB7CiAgICAgICAgdGhpcy5faXNEcmFnZ2luZyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGlmKHRoaXMuX2lzRHJhZ2dpbmcpIHsKICAgICAgICB0aGlzLl9tb3ZlRWxlbWVudChlKTsKCiAgICAgICAgdGhpcy5fY3VycmVudERyYWcuY3VycmVudFkgPSBzY3JvbGxZICsgcGFnZVkgLSBvZmZzZXQ7CgogICAgICAgIC8vIHRoaXMuX3Jlb3JkZXJJdGVtcygpOwogICAgICB9CiAgICB9KTsKCiAgICAvLyBXaGVuIGFuIGl0ZW0gaXMgZHJhZ2dlZCwgd2UgbmVlZCB0byByZW9yZGVyIGFueSBpdGVtcyBmb3Igc29ydGluZyBwdXJwb3NlcwogICAgUmVvcmRlckRyYWcucHJvdG90eXBlLl9nZXRSZW9yZGVySW5kZXggPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgcGxhY2Vob2xkZXIgPSB0aGlzLl9jdXJyZW50RHJhZy5wbGFjZWhvbGRlcjsKICAgICAgdmFyIHNpYmxpbmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5fY3VycmVudERyYWcucGxhY2Vob2xkZXIucGFyZW50Tm9kZS5jaGlsZHJlbikKICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICByZXR1cm4gZWwubm9kZU5hbWUgPT09IHNlbGYuZWwubm9kZU5hbWUgJiYgZWwgIT09IHNlbGYuZWw7CiAgICAgICAgfSk7CgogICAgICB2YXIgZHJhZ09mZnNldFRvcCA9IHRoaXMuX2N1cnJlbnREcmFnLmN1cnJlbnRZOwogICAgICB2YXIgZWw7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBzaWJsaW5ncy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgIGVsID0gc2libGluZ3NbaV07CiAgICAgICAgaWYgKGkgPT09IGxlbiAtIDEpIHsKICAgICAgICAgIGlmIChkcmFnT2Zmc2V0VG9wID4gZWwub2Zmc2V0VG9wKSB7CiAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoaSA9PT0gMCkgewogICAgICAgICAgaWYgKGRyYWdPZmZzZXRUb3AgPCBlbC5vZmZzZXRUb3AgKyBlbC5vZmZzZXRIZWlnaHQpIHsKICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChkcmFnT2Zmc2V0VG9wID4gZWwub2Zmc2V0VG9wIC0gZWwub2Zmc2V0SGVpZ2h0IC8gMiAmJgogICAgICAgICAgZHJhZ09mZnNldFRvcCA8IGVsLm9mZnNldFRvcCArIGVsLm9mZnNldEhlaWdodCAqIDEuNSkgewogICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9jdXJyZW50RHJhZy5zdGFydEluZGV4OwogICAgfTsKCiAgICBSZW9yZGVyRHJhZy5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24oZSwgZG9uZUNhbGxiYWNrKSB7CiAgICAgIGlmKCF0aGlzLl9jdXJyZW50RHJhZykgewogICAgICAgIGRvbmVDYWxsYmFjayAmJiBkb25lQ2FsbGJhY2soKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBwbGFjZWhvbGRlciA9IHRoaXMuX2N1cnJlbnREcmFnLnBsYWNlaG9sZGVyOwogICAgICB2YXIgZmluYWxJbmRleCA9IHRoaXMuX2dldFJlb3JkZXJJbmRleCgpOwoKICAgICAgLy8gUmVwb3NpdGlvbiB0aGUgZWxlbWVudAogICAgICB0aGlzLmVsLmNsYXNzTGlzdC5yZW1vdmUoSVRFTV9SRU9SREVSSU5HX0NMQVNTKTsKICAgICAgdGhpcy5lbC5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICcnOwoKICAgICAgcGxhY2Vob2xkZXIucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGhpcy5lbCwgcGxhY2Vob2xkZXIpOwogICAgICBwbGFjZWhvbGRlci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHBsYWNlaG9sZGVyKTsKCiAgICAgIHRoaXMub25SZW9yZGVyICYmIHRoaXMub25SZW9yZGVyKHRoaXMuZWwsIHRoaXMuX2N1cnJlbnREcmFnLnN0YXJ0SW5kZXgsIGZpbmFsSW5kZXgpOwoKICAgICAgdGhpcy5fY3VycmVudERyYWcgPSBudWxsOwogICAgICBkb25lQ2FsbGJhY2sgJiYgZG9uZUNhbGxiYWNrKCk7CiAgICB9OwoKCgogICAgLyoqCiAgICAgKiBUaGUgTGlzdFZpZXcgaGFuZGxlcyBhIGxpc3Qgb2YgaXRlbXMuIEl0IHdpbGwgcHJvY2VzcyBkcmFnIGFuaW1hdGlvbnMsIGVkaXQgbW9kZSwKICAgICAqIGFuZCBvdGhlciBvcGVyYXRpb25zIHRoYXQgYXJlIGNvbW1vbiBvbiBtb2JpbGUgbGlzdHMgb3IgdGFibGUgdmlld3MuCiAgICAgKi8KICAgIGlvbmljLnZpZXdzLkxpc3RWaWV3ID0gaW9uaWMudmlld3MuVmlldy5pbmhlcml0KHsKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0cykgewogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIG9wdHMgPSBpb25pYy5leHRlbmQoewogICAgICAgICAgb25SZW9yZGVyOiBmdW5jdGlvbihlbCwgb2xkSW5kZXgsIG5ld0luZGV4KSB7fSwKICAgICAgICAgIHZpcnR1YWxSZW1vdmVUaHJlc2hvbGQ6IC0yMDAsCiAgICAgICAgICB2aXJ0dWFsQWRkVGhyZXNob2xkOiAyMDAsCiAgICAgICAgICBjYW5Td2lwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0sIG9wdHMpOwoKICAgICAgICBpb25pYy5leHRlbmQodGhpcywgb3B0cyk7CgogICAgICAgIGlmKCF0aGlzLml0ZW1IZWlnaHQgJiYgdGhpcy5saXN0RWwpIHsKICAgICAgICAgIHRoaXMuaXRlbUhlaWdodCA9IHRoaXMubGlzdEVsLmNoaWxkcmVuWzBdICYmIHBhcnNlSW50KHRoaXMubGlzdEVsLmNoaWxkcmVuWzBdLnN0eWxlLmhlaWdodCwgMTApOwogICAgICAgIH0KCiAgICAgICAgLy9pb25pYy52aWV3cy5MaXN0Vmlldy5fX3N1cGVyX18uaW5pdGlhbGl6ZS5jYWxsKHRoaXMsIG9wdHMpOwoKICAgICAgICB0aGlzLm9uUmVmcmVzaCA9IG9wdHMub25SZWZyZXNoIHx8IGZ1bmN0aW9uKCkge307CiAgICAgICAgdGhpcy5vblJlZnJlc2hPcGVuaW5nID0gb3B0cy5vblJlZnJlc2hPcGVuaW5nIHx8IGZ1bmN0aW9uKCkge307CiAgICAgICAgdGhpcy5vblJlZnJlc2hIb2xkaW5nID0gb3B0cy5vblJlZnJlc2hIb2xkaW5nIHx8IGZ1bmN0aW9uKCkge307CgogICAgICAgIHdpbmRvdy5pb25pYy5vbkdlc3R1cmUoJ3JlbGVhc2UnLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICBfdGhpcy5faGFuZGxlRW5kRHJhZyhlKTsKICAgICAgICB9LCB0aGlzLmVsKTsKCiAgICAgICAgd2luZG93LmlvbmljLm9uR2VzdHVyZSgnZHJhZycsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIF90aGlzLl9oYW5kbGVEcmFnKGUpOwogICAgICAgIH0sIHRoaXMuZWwpOwogICAgICAgIC8vIFN0YXJ0IHRoZSBkcmFnIHN0YXRlcwogICAgICAgIHRoaXMuX2luaXREcmFnKCk7CiAgICAgIH0sCiAgICAgIC8qKgogICAgICAgKiBDYWxsZWQgdG8gdGVsbCB0aGUgbGlzdCB0byBzdG9wIHJlZnJlc2hpbmcuIFRoaXMgaXMgdXNlZnVsCiAgICAgICAqIGlmIHlvdSBhcmUgcmVmcmVzaGluZyB0aGUgbGlzdCBhbmQgYXJlIGRvbmUgd2l0aCByZWZyZXNoaW5nLgogICAgICAgKi8KICAgICAgc3RvcFJlZnJlc2hpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciByZWZyZXNoZXIgPSB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3IoJy5saXN0LXJlZnJlc2hlcicpOwogICAgICAgIHJlZnJlc2hlci5zdHlsZS5oZWlnaHQgPSAnMHB4JzsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBJZiB3ZSBzY3JvbGxlZCBhbmQgaGF2ZSB2aXJ0dWFsIG1vZGUgZW5hYmxlZCwgY29tcHV0ZSB0aGUgd2luZG93CiAgICAgICAqIG9mIGFjdGl2ZSBlbGVtZW50cyBpbiBvcmRlciB0byBmaWd1cmUgb3V0IHRoZSB2aWV3cG9ydCB0byByZW5kZXIuCiAgICAgICAqLwogICAgICBkaWRTY3JvbGw6IGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZih0aGlzLmlzVmlydHVhbCkgewogICAgICAgICAgdmFyIGl0ZW1IZWlnaHQgPSB0aGlzLml0ZW1IZWlnaHQ7CgogICAgICAgICAgLy8gVE9ETzogVGhpcyB3b3VsZCBiZSBpbmFjY3VyYXRlIGlmIHdlIGFyZSB3aW5kb3dlZAogICAgICAgICAgdmFyIHRvdGFsSXRlbXMgPSB0aGlzLmxpc3RFbC5jaGlsZHJlbi5sZW5ndGg7CgogICAgICAgICAgLy8gR3JhYiB0aGUgdG90YWwgaGVpZ2h0IG9mIHRoZSBsaXN0CiAgICAgICAgICB2YXIgc2Nyb2xsSGVpZ2h0ID0gZS50YXJnZXQuc2Nyb2xsSGVpZ2h0OwoKICAgICAgICAgIC8vIEdldCB0aGUgdmlld3BvcnQgaGVpZ2h0CiAgICAgICAgICB2YXIgdmlld3BvcnRIZWlnaHQgPSB0aGlzLmVsLnBhcmVudE5vZGUub2Zmc2V0SGVpZ2h0OwoKICAgICAgICAgIC8vIHNjcm9sbFRvcCBpcyB0aGUgY3VycmVudCBzY3JvbGwgcG9zaXRpb24KICAgICAgICAgIHZhciBzY3JvbGxUb3AgPSBlLnNjcm9sbFRvcDsKCiAgICAgICAgICAvLyBIaWdoIHdhdGVyIGlzIHRoZSBwaXhlbCBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgZWxlbWVudCB0byBpbmNsdWRlIChldmVyeXRoaW5nIGJlZm9yZQogICAgICAgICAgLy8gdGhhdCB3aWxsIGJlIHJlbW92ZWQpCiAgICAgICAgICB2YXIgaGlnaFdhdGVyID0gTWF0aC5tYXgoMCwgZS5zY3JvbGxUb3AgKyB0aGlzLnZpcnR1YWxSZW1vdmVUaHJlc2hvbGQpOwoKICAgICAgICAgIC8vIExvdyB3YXRlciBpcyB0aGUgcGl4ZWwgcG9zaXRpb24gb2YgdGhlIGxhc3QgZWxlbWVudCB0byBpbmNsdWRlIChldmVyeXRoaW5nIGFmdGVyCiAgICAgICAgICAvLyB0aGF0IHdpbGwgYmUgcmVtb3ZlZCkKICAgICAgICAgIHZhciBsb3dXYXRlciA9IE1hdGgubWluKHNjcm9sbEhlaWdodCwgTWF0aC5hYnMoZS5zY3JvbGxUb3ApICsgdmlld3BvcnRIZWlnaHQgKyB0aGlzLnZpcnR1YWxBZGRUaHJlc2hvbGQpOwoKICAgICAgICAgIC8vIENvbXB1dGUgaG93IG1hbnkgaXRlbXMgcGVyIHZpZXdwb3J0IHNpemUgY2FuIHNob3cKICAgICAgICAgIHZhciBpdGVtc1BlclZpZXdwb3J0ID0gTWF0aC5mbG9vcigobG93V2F0ZXIgLSBoaWdoV2F0ZXIpIC8gaXRlbUhlaWdodCk7CgogICAgICAgICAgLy8gR2V0IHRoZSBmaXJzdCBhbmQgbGFzdCBlbGVtZW50cyBpbiB0aGUgbGlzdCBiYXNlZCBvbiBob3cgbWFueSBjYW4gZml0CiAgICAgICAgICAvLyBiZXR3ZWVuIHRoZSBwaXhlbCByYW5nZSBvZiBsb3dXYXRlciBhbmQgaGlnaFdhdGVyCiAgICAgICAgICB2YXIgZmlyc3QgPSBwYXJzZUludChNYXRoLmFicyhoaWdoV2F0ZXIgLyBpdGVtSGVpZ2h0KSwgMTApOwogICAgICAgICAgdmFyIGxhc3QgPSBwYXJzZUludChNYXRoLmFicyhsb3dXYXRlciAvIGl0ZW1IZWlnaHQpLCAxMCk7CgogICAgICAgICAgLy8gR2V0IHRoZSBpdGVtcyB3ZSBuZWVkIHRvIHJlbW92ZQogICAgICAgICAgdGhpcy5fdmlydHVhbEl0ZW1zVG9SZW1vdmUgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzLmxpc3RFbC5jaGlsZHJlbiwgMCwgZmlyc3QpOwoKICAgICAgICAgIC8vIEdyYWIgdGhlIG5vZGVzIHdlIHdpbGwgYmUgc2hvd2luZwogICAgICAgICAgdmFyIG5vZGVzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5saXN0RWwuY2hpbGRyZW4sIGZpcnN0LCBmaXJzdCArIGl0ZW1zUGVyVmlld3BvcnQpOwoKICAgICAgICAgIHRoaXMucmVuZGVyVmlld3BvcnQgJiYgdGhpcy5yZW5kZXJWaWV3cG9ydChoaWdoV2F0ZXIsIGxvd1dhdGVyLCBmaXJzdCwgbGFzdCk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgZGlkU3RvcFNjcm9sbGluZzogZnVuY3Rpb24oZSkgewogICAgICAgIGlmKHRoaXMuaXNWaXJ0dWFsKSB7CiAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgdGhpcy5fdmlydHVhbEl0ZW1zVG9SZW1vdmUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGVsID0gdGhpcy5fdmlydHVhbEl0ZW1zVG9SZW1vdmVbaV07CiAgICAgICAgICAgIC8vZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbCk7CiAgICAgICAgICAgIHRoaXMuZGlkSGlkZUl0ZW0gJiYgdGhpcy5kaWRIaWRlSXRlbShpKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIE9uY2Ugc2Nyb2xsaW5nIHN0b3BzLCBjaGVjayBpZiB3ZSBuZWVkIHRvIHJlbW92ZSBvbGQgaXRlbXMKCiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIENsZWFyIGFueSBhY3RpdmUgZHJhZyBlZmZlY3RzIG9uIHRoZSBsaXN0LgogICAgICAgKi8KICAgICAgY2xlYXJEcmFnRWZmZWN0czogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYodGhpcy5fbGFzdERyYWdPcCkgewogICAgICAgICAgdGhpcy5fbGFzdERyYWdPcC5jbGVhbiAmJiB0aGlzLl9sYXN0RHJhZ09wLmNsZWFuKCk7CiAgICAgICAgICB0aGlzLl9sYXN0RHJhZ09wID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBfaW5pdERyYWc6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vaW9uaWMudmlld3MuTGlzdFZpZXcuX19zdXBlcl9fLl9pbml0RHJhZy5jYWxsKHRoaXMpOwoKICAgICAgICAvLyBTdG9yZSB0aGUgbGFzdCBvbmUKICAgICAgICB0aGlzLl9sYXN0RHJhZ09wID0gdGhpcy5fZHJhZ09wOwoKICAgICAgICB0aGlzLl9kcmFnT3AgPSBudWxsOwogICAgICB9LAoKICAgICAgLy8gUmV0dXJuIHRoZSBsaXN0IGl0ZW0gZnJvbSB0aGUgZ2l2ZW4gdGFyZ2V0CiAgICAgIF9nZXRJdGVtOiBmdW5jdGlvbih0YXJnZXQpIHsKICAgICAgICB3aGlsZSh0YXJnZXQpIHsKICAgICAgICAgIGlmKHRhcmdldC5jbGFzc0xpc3QgJiYgdGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucyhJVEVNX0NMQVNTKSkgewogICAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAoKCiAgICAgIF9zdGFydERyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICB2YXIgZGlkU3RhcnQgPSBmYWxzZTsKCiAgICAgICAgdGhpcy5faXNEcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgICB2YXIgbGFzdERyYWdPcCA9IHRoaXMuX2xhc3REcmFnT3A7CiAgICAgICAgdmFyIGl0ZW07CgogICAgICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSByZW9yZGVyIGRyYWcKICAgICAgICBpZihpb25pYy5Eb21VdGlsLmdldFBhcmVudE9yU2VsZldpdGhDbGFzcyhlLnRhcmdldCwgSVRFTV9SRU9SREVSX0JUTl9DTEFTUykgJiYgKGUuZ2VzdHVyZS5kaXJlY3Rpb24gPT0gJ3VwJyB8fCBlLmdlc3R1cmUuZGlyZWN0aW9uID09ICdkb3duJykpIHsKICAgICAgICAgIGl0ZW0gPSB0aGlzLl9nZXRJdGVtKGUudGFyZ2V0KTsKCiAgICAgICAgICBpZihpdGVtKSB7CiAgICAgICAgICAgIHRoaXMuX2RyYWdPcCA9IG5ldyBSZW9yZGVyRHJhZyh7CiAgICAgICAgICAgICAgbGlzdEVsOiB0aGlzLmVsLAogICAgICAgICAgICAgIGVsOiBpdGVtLAogICAgICAgICAgICAgIHNjcm9sbEVsOiB0aGlzLnNjcm9sbEVsLAogICAgICAgICAgICAgIHNjcm9sbFZpZXc6IHRoaXMuc2Nyb2xsVmlldywKICAgICAgICAgICAgICBvblJlb3JkZXI6IGZ1bmN0aW9uKGVsLCBzdGFydCwgZW5kKSB7CiAgICAgICAgICAgICAgICBfdGhpcy5vblJlb3JkZXIgJiYgX3RoaXMub25SZW9yZGVyKGVsLCBzdGFydCwgZW5kKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLl9kcmFnT3Auc3RhcnQoZSk7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE9yIGNoZWNrIGlmIHRoaXMgaXMgYSBzd2lwZSB0byB0aGUgc2lkZSBkcmFnCiAgICAgICAgZWxzZSBpZighdGhpcy5fZGlkRHJhZ1VwT3JEb3duICYmIChlLmdlc3R1cmUuZGlyZWN0aW9uID09ICdsZWZ0JyB8fCBlLmdlc3R1cmUuZGlyZWN0aW9uID09ICdyaWdodCcpICYmIE1hdGguYWJzKGUuZ2VzdHVyZS5kZWx0YVgpID4gNSkgewoKICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGlzIGlzIGFuIGl0ZW0gd2l0aCBidXR0b25zCiAgICAgICAgICBpdGVtID0gdGhpcy5fZ2V0SXRlbShlLnRhcmdldCk7CiAgICAgICAgICBpZihpdGVtICYmIGl0ZW0ucXVlcnlTZWxlY3RvcignLml0ZW0tb3B0aW9ucycpKSB7CiAgICAgICAgICAgIHRoaXMuX2RyYWdPcCA9IG5ldyBTbGlkZURyYWcoeyBlbDogdGhpcy5lbCwgY2FuU3dpcGU6IHRoaXMuY2FuU3dpcGUgfSk7CiAgICAgICAgICAgIHRoaXMuX2RyYWdPcC5zdGFydChlKTsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gSWYgd2UgaGFkIGEgbGFzdCBkcmFnIG9wZXJhdGlvbiBhbmQgdGhpcyBpcyBhIG5ldyBvbmUgb24gYSBkaWZmZXJlbnQgaXRlbSwgY2xlYW4gdGhhdCBsYXN0IG9uZQogICAgICAgIGlmKGxhc3REcmFnT3AgJiYgdGhpcy5fZHJhZ09wICYmICF0aGlzLl9kcmFnT3AuaXNTYW1lSXRlbShsYXN0RHJhZ09wKSAmJiBlLmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgIGxhc3REcmFnT3AuY2xlYW4gJiYgbGFzdERyYWdPcC5jbGVhbigpOwogICAgICAgIH0KICAgICAgfSwKCgogICAgICBfaGFuZGxlRW5kRHJhZzogZnVuY3Rpb24oZSkgewogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHRoaXMuX2RpZERyYWdVcE9yRG93biA9IGZhbHNlOwoKICAgICAgICBpZighdGhpcy5fZHJhZ09wKSB7CiAgICAgICAgICAvL2lvbmljLnZpZXdzLkxpc3RWaWV3Ll9fc3VwZXJfXy5faGFuZGxlRW5kRHJhZy5jYWxsKHRoaXMsIGUpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fZHJhZ09wLmVuZChlLCBmdW5jdGlvbigpIHsKICAgICAgICAgIF90aGlzLl9pbml0RHJhZygpOwogICAgICAgIH0pOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFByb2Nlc3MgdGhlIGRyYWcgZXZlbnQgdG8gbW92ZSB0aGUgaXRlbSB0byB0aGUgbGVmdCBvciByaWdodC4KICAgICAgICovCiAgICAgIF9oYW5kbGVEcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIF90aGlzID0gdGhpcywgY29udGVudCwgYnV0dG9uczsKCiAgICAgICAgaWYoTWF0aC5hYnMoZS5nZXN0dXJlLmRlbHRhWSkgPiA1KSB7CiAgICAgICAgICB0aGlzLl9kaWREcmFnVXBPckRvd24gPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgd2UgZ2V0IGEgZHJhZyBldmVudCwgbWFrZSBzdXJlIHdlIGFyZW4ndCBpbiBhbm90aGVyIGRyYWcsIHRoZW4gY2hlY2sgaWYgd2Ugc2hvdWxkCiAgICAgICAgLy8gc3RhcnQgb25lCiAgICAgICAgaWYoIXRoaXMuaXNEcmFnZ2luZyAmJiAhdGhpcy5fZHJhZ09wKSB7CiAgICAgICAgICB0aGlzLl9zdGFydERyYWcoZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBObyBkcmFnIHN0aWxsLCBwYXNzIGl0IHVwCiAgICAgICAgaWYoIXRoaXMuX2RyYWdPcCkgewogICAgICAgICAgLy9pb25pYy52aWV3cy5MaXN0Vmlldy5fX3N1cGVyX18uX2hhbmRsZURyYWcuY2FsbCh0aGlzLCBlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGUuZ2VzdHVyZS5zcmNFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHRoaXMuX2RyYWdPcC5kcmFnKGUpOwogICAgICB9CgogICAgfSk7CgogIH0pKGlvbmljKTsKCiAgKGZ1bmN0aW9uKGlvbmljKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgaW9uaWMudmlld3MuTW9kYWwgPSBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQoewogICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgICAgb3B0cyA9IGlvbmljLmV4dGVuZCh7CiAgICAgICAgICBmb2N1c0ZpcnN0SW5wdXQ6IGZhbHNlLAogICAgICAgICAgdW5mb2N1c09uSGlkZTogdHJ1ZSwKICAgICAgICAgIGZvY3VzRmlyc3REZWxheTogNjAwLAogICAgICAgICAgYmFja2Ryb3BDbGlja1RvQ2xvc2U6IHRydWUsCiAgICAgICAgICBoYXJkd2FyZUJhY2tCdXR0b25DbG9zZTogdHJ1ZSwKICAgICAgICB9LCBvcHRzKTsKCiAgICAgICAgaW9uaWMuZXh0ZW5kKHRoaXMsIG9wdHMpOwoKICAgICAgICB0aGlzLmVsID0gb3B0cy5lbDsKICAgICAgfSwKICAgICAgc2hvdzogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBpZihzZWxmLmZvY3VzRmlyc3RJbnB1dCkgewogICAgICAgICAgLy8gTGV0IGFueSBhbmltYXRpb25zIHJ1biBmaXJzdAogICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBpbnB1dCA9IHNlbGYuZWwucXVlcnlTZWxlY3RvcignaW5wdXQsIHRleHRhcmVhJyk7CiAgICAgICAgICAgIGlucHV0ICYmIGlucHV0LmZvY3VzICYmIGlucHV0LmZvY3VzKCk7CiAgICAgICAgICB9LCBzZWxmLmZvY3VzRmlyc3REZWxheSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBoaWRlOiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBVbmZvY3VzIGFsbCBlbGVtZW50cwogICAgICAgIGlmKHRoaXMudW5mb2N1c09uSGlkZSkgewogICAgICAgICAgdmFyIGlucHV0cyA9IHRoaXMuZWwucXVlcnlTZWxlY3RvckFsbCgnaW5wdXQsIHRleHRhcmVhJyk7CiAgICAgICAgICAvLyBMZXQgYW55IGFuaW1hdGlvbnMgcnVuIGZpcnN0CiAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGlucHV0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGlucHV0c1tpXS5ibHVyICYmIGlucHV0c1tpXS5ibHVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogIH0pKGlvbmljKTsKCiAgKGZ1bmN0aW9uKGlvbmljKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgLyoqCiAgICAgKiBUaGUgc2lkZSBtZW51IHZpZXcgaGFuZGxlcyBvbmUgb2YgdGhlIHNpZGUgbWVudSdzIGluIGEgU2lkZSBNZW51IENvbnRyb2xsZXIKICAgICAqIGNvbmZpZ3VyYXRpb24uCiAgICAgKiBJdCB0YWtlcyBhIERPTSByZWZlcmVuY2UgdG8gdGhhdCBzaWRlIG1lbnUgZWxlbWVudC4KICAgICAqLwogICAgaW9uaWMudmlld3MuU2lkZU1lbnUgPSBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQoewogICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgICAgdGhpcy5lbCA9IG9wdHMuZWw7CiAgICAgICAgdGhpcy5pc0VuYWJsZWQgPSAodHlwZW9mIG9wdHMuaXNFbmFibGVkID09PSAndW5kZWZpbmVkJykgPyB0cnVlIDogb3B0cy5pc0VuYWJsZWQ7CiAgICAgICAgdGhpcy5zZXRXaWR0aChvcHRzLndpZHRoKTsKICAgICAgfSwKCiAgICAgIGdldEZ1bGxXaWR0aDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMud2lkdGg7CiAgICAgIH0sCiAgICAgIHNldFdpZHRoOiBmdW5jdGlvbih3aWR0aCkgewogICAgICAgIHRoaXMud2lkdGggPSB3aWR0aDsKICAgICAgICB0aGlzLmVsLnN0eWxlLndpZHRoID0gd2lkdGggKyAncHgnOwogICAgICB9LAogICAgICBzZXRJc0VuYWJsZWQ6IGZ1bmN0aW9uKGlzRW5hYmxlZCkgewogICAgICAgIHRoaXMuaXNFbmFibGVkID0gaXNFbmFibGVkOwogICAgICB9LAogICAgICBicmluZ1VwOiBmdW5jdGlvbigpIHsKICAgICAgICBpZih0aGlzLmVsLnN0eWxlLnpJbmRleCAhPT0gJzAnKSB7CiAgICAgICAgICB0aGlzLmVsLnN0eWxlLnpJbmRleCA9ICcwJzsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHB1c2hEb3duOiBmdW5jdGlvbigpIHsKICAgICAgICBpZih0aGlzLmVsLnN0eWxlLnpJbmRleCAhPT0gJy0xJykgewogICAgICAgICAgdGhpcy5lbC5zdHlsZS56SW5kZXggPSAnLTEnOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogICAgaW9uaWMudmlld3MuU2lkZU1lbnVDb250ZW50ID0gaW9uaWMudmlld3MuVmlldy5pbmhlcml0KHsKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0cykgewogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIGlvbmljLmV4dGVuZCh0aGlzLCB7CiAgICAgICAgICBhbmltYXRpb25DbGFzczogJ21lbnUtYW5pbWF0ZWQnLAogICAgICAgICAgb25EcmFnOiBmdW5jdGlvbihlKSB7fSwKICAgICAgICAgIG9uRW5kRHJhZzogZnVuY3Rpb24oZSkge30sCiAgICAgICAgfSwgb3B0cyk7CgogICAgICAgIGlvbmljLm9uR2VzdHVyZSgnZHJhZycsIGlvbmljLnByb3h5KHRoaXMuX29uRHJhZywgdGhpcyksIHRoaXMuZWwpOwogICAgICAgIGlvbmljLm9uR2VzdHVyZSgncmVsZWFzZScsIGlvbmljLnByb3h5KHRoaXMuX29uRW5kRHJhZywgdGhpcyksIHRoaXMuZWwpOwogICAgICB9LAogICAgICBfb25EcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdGhpcy5vbkRyYWcgJiYgdGhpcy5vbkRyYWcoZSk7CiAgICAgIH0sCiAgICAgIF9vbkVuZERyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB0aGlzLm9uRW5kRHJhZyAmJiB0aGlzLm9uRW5kRHJhZyhlKTsKICAgICAgfSwKICAgICAgZGlzYWJsZUFuaW1hdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5lbC5jbGFzc0xpc3QucmVtb3ZlKHRoaXMuYW5pbWF0aW9uQ2xhc3MpOwogICAgICB9LAogICAgICBlbmFibGVBbmltYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZWwuY2xhc3NMaXN0LmFkZCh0aGlzLmFuaW1hdGlvbkNsYXNzKTsKICAgICAgfSwKICAgICAgZ2V0VHJhbnNsYXRlWDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQodGhpcy5lbC5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXS5yZXBsYWNlKCd0cmFuc2xhdGUzZCgnLCAnJykuc3BsaXQoJywnKVswXSk7CiAgICAgIH0sCiAgICAgIHNldFRyYW5zbGF0ZVg6IGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoZnVuY3Rpb24oeCkgewogICAgICAgIHRoaXMuZWwuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAndHJhbnNsYXRlM2QoJyArIHggKyAncHgsIDAsIDApJzsKICAgICAgfSkKICAgIH0pOwoKICB9KShpb25pYyk7CgogIC8qCiAgICogQWRhcHRlZCBmcm9tIFN3aXBlLmpzIDIuMAogICAqCiAgICogQnJhZCBCaXJkc2FsbAogICAqIENvcHlyaWdodCAyMDEzLCBNSVQgTGljZW5zZQogICAqCiAgICovCgogIChmdW5jdGlvbihpb25pYykgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGlvbmljLnZpZXdzLlNsaWRlciA9IGlvbmljLnZpZXdzLlZpZXcuaW5oZXJpdCh7CiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAgICAgdmFyIHNsaWRlciA9IHRoaXM7CgogICAgICAgIC8vIHV0aWxpdGllcwogICAgICAgIHZhciBub29wID0gZnVuY3Rpb24oKSB7fTsgLy8gc2ltcGxlIG5vIG9wZXJhdGlvbiBmdW5jdGlvbgogICAgICAgIHZhciBvZmZsb2FkRm4gPSBmdW5jdGlvbihmbikgeyBzZXRUaW1lb3V0KGZuIHx8IG5vb3AsIDApOyB9OyAvLyBvZmZsb2FkIGEgZnVuY3Rpb25zIGV4ZWN1dGlvbgoKICAgICAgICAvLyBjaGVjayBicm93c2VyIGNhcGFiaWxpdGllcwogICAgICAgIHZhciBicm93c2VyID0gewogICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcjogISF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciwKICAgICAgICAgIHRvdWNoOiAoJ29udG91Y2hzdGFydCcgaW4gd2luZG93KSB8fCB3aW5kb3cuRG9jdW1lbnRUb3VjaCAmJiBkb2N1bWVudCBpbnN0YW5jZW9mIERvY3VtZW50VG91Y2gsCiAgICAgICAgICB0cmFuc2l0aW9uczogKGZ1bmN0aW9uKHRlbXApIHsKICAgICAgICAgICAgdmFyIHByb3BzID0gWyd0cmFuc2l0aW9uUHJvcGVydHknLCAnV2Via2l0VHJhbnNpdGlvbicsICdNb3pUcmFuc2l0aW9uJywgJ09UcmFuc2l0aW9uJywgJ21zVHJhbnNpdGlvbiddOwogICAgICAgICAgICBmb3IgKCB2YXIgaSBpbiBwcm9wcyApIGlmICh0ZW1wLnN0eWxlWyBwcm9wc1tpXSBdICE9PSB1bmRlZmluZWQpIHJldHVybiB0cnVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9KShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzd2lwZScpKQogICAgICAgIH07CgoKICAgICAgICB2YXIgY29udGFpbmVyID0gb3B0aW9ucy5lbDsKCiAgICAgICAgLy8gcXVpdCBpZiBubyByb290IGVsZW1lbnQKICAgICAgICBpZiAoIWNvbnRhaW5lcikgcmV0dXJuOwogICAgICAgIHZhciBlbGVtZW50ID0gY29udGFpbmVyLmNoaWxkcmVuWzBdOwogICAgICAgIHZhciBzbGlkZXMsIHNsaWRlUG9zLCB3aWR0aCwgbGVuZ3RoOwogICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICAgIHZhciBpbmRleCA9IHBhcnNlSW50KG9wdGlvbnMuc3RhcnRTbGlkZSwgMTApIHx8IDA7CiAgICAgICAgdmFyIHNwZWVkID0gb3B0aW9ucy5zcGVlZCB8fCAzMDA7CiAgICAgICAgb3B0aW9ucy5jb250aW51b3VzID0gb3B0aW9ucy5jb250aW51b3VzICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmNvbnRpbnVvdXMgOiB0cnVlOwoKICAgICAgICBmdW5jdGlvbiBzZXR1cCgpIHsKCiAgICAgICAgICAvLyBjYWNoZSBzbGlkZXMKICAgICAgICAgIHNsaWRlcyA9IGVsZW1lbnQuY2hpbGRyZW47CiAgICAgICAgICBsZW5ndGggPSBzbGlkZXMubGVuZ3RoOwoKICAgICAgICAgIC8vIHNldCBjb250aW51b3VzIHRvIGZhbHNlIGlmIG9ubHkgb25lIHNsaWRlCiAgICAgICAgICBpZiAoc2xpZGVzLmxlbmd0aCA8IDIpIG9wdGlvbnMuY29udGludW91cyA9IGZhbHNlOwoKICAgICAgICAgIC8vc3BlY2lhbCBjYXNlIGlmIHR3byBzbGlkZXMKICAgICAgICAgIGlmIChicm93c2VyLnRyYW5zaXRpb25zICYmIG9wdGlvbnMuY29udGludW91cyAmJiBzbGlkZXMubGVuZ3RoIDwgMykgewogICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKHNsaWRlc1swXS5jbG9uZU5vZGUodHJ1ZSkpOwogICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGVsZW1lbnQuY2hpbGRyZW5bMV0uY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICAgICAgc2xpZGVzID0gZWxlbWVudC5jaGlsZHJlbjsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBjcmVhdGUgYW4gYXJyYXkgdG8gc3RvcmUgY3VycmVudCBwb3NpdGlvbnMgb2YgZWFjaCBzbGlkZQogICAgICAgICAgc2xpZGVQb3MgPSBuZXcgQXJyYXkoc2xpZGVzLmxlbmd0aCk7CgogICAgICAgICAgLy8gZGV0ZXJtaW5lIHdpZHRoIG9mIGVhY2ggc2xpZGUKICAgICAgICAgIHdpZHRoID0gY29udGFpbmVyLm9mZnNldFdpZHRoIHx8IGNvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aDsKCiAgICAgICAgICBlbGVtZW50LnN0eWxlLndpZHRoID0gKHNsaWRlcy5sZW5ndGggKiB3aWR0aCkgKyAncHgnOwoKICAgICAgICAgIC8vIHN0YWNrIGVsZW1lbnRzCiAgICAgICAgICB2YXIgcG9zID0gc2xpZGVzLmxlbmd0aDsKICAgICAgICAgIHdoaWxlKHBvcy0tKSB7CgogICAgICAgICAgICB2YXIgc2xpZGUgPSBzbGlkZXNbcG9zXTsKCiAgICAgICAgICAgIHNsaWRlLnN0eWxlLndpZHRoID0gd2lkdGggKyAncHgnOwogICAgICAgICAgICBzbGlkZS5zZXRBdHRyaWJ1dGUoJ2RhdGEtaW5kZXgnLCBwb3MpOwoKICAgICAgICAgICAgaWYgKGJyb3dzZXIudHJhbnNpdGlvbnMpIHsKICAgICAgICAgICAgICBzbGlkZS5zdHlsZS5sZWZ0ID0gKHBvcyAqIC13aWR0aCkgKyAncHgnOwogICAgICAgICAgICAgIG1vdmUocG9zLCBpbmRleCA+IHBvcyA/IC13aWR0aCA6IChpbmRleCA8IHBvcyA/IHdpZHRoIDogMCksIDApOwogICAgICAgICAgICB9CgogICAgICAgICAgfQoKICAgICAgICAgIC8vIHJlcG9zaXRpb24gZWxlbWVudHMgYmVmb3JlIGFuZCBhZnRlciBpbmRleAogICAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cyAmJiBicm93c2VyLnRyYW5zaXRpb25zKSB7CiAgICAgICAgICAgIG1vdmUoY2lyY2xlKGluZGV4LTEpLCAtd2lkdGgsIDApOwogICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleCsxKSwgd2lkdGgsIDApOwogICAgICAgICAgfQoKICAgICAgICAgIGlmICghYnJvd3Nlci50cmFuc2l0aW9ucykgZWxlbWVudC5zdHlsZS5sZWZ0ID0gKGluZGV4ICogLXdpZHRoKSArICdweCc7CgogICAgICAgICAgY29udGFpbmVyLnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgogICAgICAgICAgb3B0aW9ucy5zbGlkZXNDaGFuZ2VkICYmIG9wdGlvbnMuc2xpZGVzQ2hhbmdlZCgpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gcHJldigpIHsKCiAgICAgICAgICBpZiAob3B0aW9ucy5jb250aW51b3VzKSBzbGlkZShpbmRleC0xKTsKICAgICAgICAgIGVsc2UgaWYgKGluZGV4KSBzbGlkZShpbmRleC0xKTsKCiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBuZXh0KCkgewoKICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMpIHNsaWRlKGluZGV4KzEpOwogICAgICAgICAgZWxzZSBpZiAoaW5kZXggPCBzbGlkZXMubGVuZ3RoIC0gMSkgc2xpZGUoaW5kZXgrMSk7CgogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2lyY2xlKGluZGV4KSB7CgogICAgICAgICAgLy8gYSBzaW1wbGUgcG9zaXRpdmUgbW9kdWxvIHVzaW5nIHNsaWRlcy5sZW5ndGgKICAgICAgICAgIHJldHVybiAoc2xpZGVzLmxlbmd0aCArIChpbmRleCAlIHNsaWRlcy5sZW5ndGgpKSAlIHNsaWRlcy5sZW5ndGg7CgogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2xpZGUodG8sIHNsaWRlU3BlZWQpIHsKCiAgICAgICAgICAvLyBkbyBub3RoaW5nIGlmIGFscmVhZHkgb24gcmVxdWVzdGVkIHNsaWRlCiAgICAgICAgICBpZiAoaW5kZXggPT0gdG8pIHJldHVybjsKCiAgICAgICAgICBpZiAoYnJvd3Nlci50cmFuc2l0aW9ucykgewoKICAgICAgICAgICAgdmFyIGRpcmVjdGlvbiA9IE1hdGguYWJzKGluZGV4LXRvKSAvIChpbmRleC10byk7IC8vIDE6IGJhY2t3YXJkLCAtMTogZm9yd2FyZAoKICAgICAgICAgICAgLy8gZ2V0IHRoZSBhY3R1YWwgcG9zaXRpb24gb2YgdGhlIHNsaWRlCiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMpIHsKICAgICAgICAgICAgICB2YXIgbmF0dXJhbF9kaXJlY3Rpb24gPSBkaXJlY3Rpb247CiAgICAgICAgICAgICAgZGlyZWN0aW9uID0gLXNsaWRlUG9zW2NpcmNsZSh0byldIC8gd2lkdGg7CgogICAgICAgICAgICAgIC8vIGlmIGdvaW5nIGZvcndhcmQgYnV0IHRvIDwgaW5kZXgsIHVzZSB0byA9IHNsaWRlcy5sZW5ndGggKyB0bwogICAgICAgICAgICAgIC8vIGlmIGdvaW5nIGJhY2t3YXJkIGJ1dCB0byA+IGluZGV4LCB1c2UgdG8gPSAtc2xpZGVzLmxlbmd0aCArIHRvCiAgICAgICAgICAgICAgaWYgKGRpcmVjdGlvbiAhPT0gbmF0dXJhbF9kaXJlY3Rpb24pIHRvID0gIC1kaXJlY3Rpb24gKiBzbGlkZXMubGVuZ3RoICsgdG87CgogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZGlmZiA9IE1hdGguYWJzKGluZGV4LXRvKSAtIDE7CgogICAgICAgICAgICAvLyBtb3ZlIGFsbCB0aGUgc2xpZGVzIGJldHdlZW4gaW5kZXggYW5kIHRvIGluIHRoZSByaWdodCBkaXJlY3Rpb24KICAgICAgICAgICAgd2hpbGUgKGRpZmYtLSkgbW92ZSggY2lyY2xlKCh0byA+IGluZGV4ID8gdG8gOiBpbmRleCkgLSBkaWZmIC0gMSksIHdpZHRoICogZGlyZWN0aW9uLCAwKTsKCiAgICAgICAgICAgIHRvID0gY2lyY2xlKHRvKTsKCiAgICAgICAgICAgIG1vdmUoaW5kZXgsIHdpZHRoICogZGlyZWN0aW9uLCBzbGlkZVNwZWVkIHx8IHNwZWVkKTsKICAgICAgICAgICAgbW92ZSh0bywgMCwgc2xpZGVTcGVlZCB8fCBzcGVlZCk7CgogICAgICAgICAgICBpZiAob3B0aW9ucy5jb250aW51b3VzKSBtb3ZlKGNpcmNsZSh0byAtIGRpcmVjdGlvbiksIC0od2lkdGggKiBkaXJlY3Rpb24pLCAwKTsgLy8gd2UgbmVlZCB0byBnZXQgdGhlIG5leHQgaW4gcGxhY2UKCiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgdG8gPSBjaXJjbGUodG8pOwogICAgICAgICAgICBhbmltYXRlKGluZGV4ICogLXdpZHRoLCB0byAqIC13aWR0aCwgc2xpZGVTcGVlZCB8fCBzcGVlZCk7CiAgICAgICAgICAgIC8vbm8gZmFsbGJhY2sgZm9yIGEgY2lyY3VsYXIgY29udGludW91cyBpZiB0aGUgYnJvd3NlciBkb2VzIG5vdCBhY2NlcHQgdHJhbnNpdGlvbnMKICAgICAgICAgIH0KCiAgICAgICAgICBpbmRleCA9IHRvOwogICAgICAgICAgb2ZmbG9hZEZuKG9wdGlvbnMuY2FsbGJhY2sgJiYgb3B0aW9ucy5jYWxsYmFjayhpbmRleCwgc2xpZGVzW2luZGV4XSkpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbW92ZShpbmRleCwgZGlzdCwgc3BlZWQpIHsKCiAgICAgICAgICB0cmFuc2xhdGUoaW5kZXgsIGRpc3QsIHNwZWVkKTsKICAgICAgICAgIHNsaWRlUG9zW2luZGV4XSA9IGRpc3Q7CgogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdHJhbnNsYXRlKGluZGV4LCBkaXN0LCBzcGVlZCkgewoKICAgICAgICAgIHZhciBzbGlkZSA9IHNsaWRlc1tpbmRleF07CiAgICAgICAgICB2YXIgc3R5bGUgPSBzbGlkZSAmJiBzbGlkZS5zdHlsZTsKCiAgICAgICAgICBpZiAoIXN0eWxlKSByZXR1cm47CgogICAgICAgICAgc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0KICAgICAgICAgICAgc3R5bGUuTW96VHJhbnNpdGlvbkR1cmF0aW9uID0KICAgICAgICAgICAgICBzdHlsZS5tc1RyYW5zaXRpb25EdXJhdGlvbiA9CiAgICAgICAgICAgICAgICBzdHlsZS5PVHJhbnNpdGlvbkR1cmF0aW9uID0KICAgICAgICAgICAgICAgICAgc3R5bGUudHJhbnNpdGlvbkR1cmF0aW9uID0gc3BlZWQgKyAnbXMnOwoKICAgICAgICAgIHN0eWxlLndlYmtpdFRyYW5zZm9ybSA9ICd0cmFuc2xhdGUoJyArIGRpc3QgKyAncHgsMCknICsgJ3RyYW5zbGF0ZVooMCknOwogICAgICAgICAgc3R5bGUubXNUcmFuc2Zvcm0gPQogICAgICAgICAgICBzdHlsZS5Nb3pUcmFuc2Zvcm0gPQogICAgICAgICAgICAgIHN0eWxlLk9UcmFuc2Zvcm0gPSAndHJhbnNsYXRlWCgnICsgZGlzdCArICdweCknOwoKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGFuaW1hdGUoZnJvbSwgdG8sIHNwZWVkKSB7CgogICAgICAgICAgLy8gaWYgbm90IGFuIGFuaW1hdGlvbiwganVzdCByZXBvc2l0aW9uCiAgICAgICAgICBpZiAoIXNwZWVkKSB7CgogICAgICAgICAgICBlbGVtZW50LnN0eWxlLmxlZnQgPSB0byArICdweCc7CiAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHN0YXJ0ID0gK25ldyBEYXRlKCk7CgogICAgICAgICAgdmFyIHRpbWVyID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgdGltZUVsYXAgPSArbmV3IERhdGUoKSAtIHN0YXJ0OwoKICAgICAgICAgICAgaWYgKHRpbWVFbGFwID4gc3BlZWQpIHsKCiAgICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5sZWZ0ID0gdG8gKyAncHgnOwoKICAgICAgICAgICAgICBpZiAoZGVsYXkpIGJlZ2luKCk7CgogICAgICAgICAgICAgIG9wdGlvbnMudHJhbnNpdGlvbkVuZCAmJiBvcHRpb25zLnRyYW5zaXRpb25FbmQuY2FsbChldmVudCwgaW5kZXgsIHNsaWRlc1tpbmRleF0pOwoKICAgICAgICAgICAgICBjbGVhckludGVydmFsKHRpbWVyKTsKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICB9CgogICAgICAgICAgICBlbGVtZW50LnN0eWxlLmxlZnQgPSAoKCAodG8gLSBmcm9tKSAqIChNYXRoLmZsb29yKCh0aW1lRWxhcCAvIHNwZWVkKSAqIDEwMCkgLyAxMDApICkgKyBmcm9tKSArICdweCc7CgogICAgICAgICAgfSwgNCk7CgogICAgICAgIH0KCiAgICAgICAgLy8gc2V0dXAgYXV0byBzbGlkZXNob3cKICAgICAgICB2YXIgZGVsYXkgPSBvcHRpb25zLmF1dG8gfHwgMDsKICAgICAgICB2YXIgaW50ZXJ2YWw7CgogICAgICAgIGZ1bmN0aW9uIGJlZ2luKCkgewoKICAgICAgICAgIGludGVydmFsID0gc2V0VGltZW91dChuZXh0LCBkZWxheSk7CgogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc3RvcCgpIHsKCiAgICAgICAgICBkZWxheSA9IG9wdGlvbnMuYXV0byB8fCAwOwogICAgICAgICAgY2xlYXJUaW1lb3V0KGludGVydmFsKTsKCiAgICAgICAgfQoKCiAgICAgICAgLy8gc2V0dXAgaW5pdGlhbCB2YXJzCiAgICAgICAgdmFyIHN0YXJ0ID0ge307CiAgICAgICAgdmFyIGRlbHRhID0ge307CiAgICAgICAgdmFyIGlzU2Nyb2xsaW5nOwoKICAgICAgICAvLyBzZXR1cCBldmVudCBjYXB0dXJpbmcKICAgICAgICB2YXIgZXZlbnRzID0gewoKICAgICAgICAgIGhhbmRsZUV2ZW50OiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZihldmVudC50eXBlID09ICdtb3VzZWRvd24nIHx8IGV2ZW50LnR5cGUgPT0gJ21vdXNldXAnIHx8IGV2ZW50LnR5cGUgPT0gJ21vdXNlbW92ZScpIHsKICAgICAgICAgICAgICBldmVudC50b3VjaGVzID0gW3sKICAgICAgICAgICAgICAgIHBhZ2VYOiBldmVudC5wYWdlWCwKICAgICAgICAgICAgICAgIHBhZ2VZOiBldmVudC5wYWdlWQogICAgICAgICAgICAgIH1dOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2l0Y2ggKGV2ZW50LnR5cGUpIHsKICAgICAgICAgICAgICBjYXNlICdtb3VzZWRvd24nOiB0aGlzLnN0YXJ0KGV2ZW50KTsgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAndG91Y2hzdGFydCc6IHRoaXMuc3RhcnQoZXZlbnQpOyBicmVhazsKICAgICAgICAgICAgICBjYXNlICd0b3VjaG1vdmUnOiB0aGlzLnRvdWNobW92ZShldmVudCk7IGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ21vdXNlbW92ZSc6IHRoaXMudG91Y2htb3ZlKGV2ZW50KTsgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAndG91Y2hlbmQnOiBvZmZsb2FkRm4odGhpcy5lbmQoZXZlbnQpKTsgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnbW91c2V1cCc6IG9mZmxvYWRGbih0aGlzLmVuZChldmVudCkpOyBicmVhazsKICAgICAgICAgICAgICBjYXNlICd3ZWJraXRUcmFuc2l0aW9uRW5kJzoKICAgICAgICAgICAgICBjYXNlICdtc1RyYW5zaXRpb25FbmQnOgogICAgICAgICAgICAgIGNhc2UgJ29UcmFuc2l0aW9uRW5kJzoKICAgICAgICAgICAgICBjYXNlICdvdHJhbnNpdGlvbmVuZCc6CiAgICAgICAgICAgICAgY2FzZSAndHJhbnNpdGlvbmVuZCc6IG9mZmxvYWRGbih0aGlzLnRyYW5zaXRpb25FbmQoZXZlbnQpKTsgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAncmVzaXplJzogb2ZmbG9hZEZuKHNldHVwKTsgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvcHRpb25zLnN0b3BQcm9wYWdhdGlvbikgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgICAgICAgfSwKICAgICAgICAgIHN0YXJ0OiBmdW5jdGlvbihldmVudCkgewoKICAgICAgICAgICAgdmFyIHRvdWNoZXMgPSBldmVudC50b3VjaGVzWzBdOwoKICAgICAgICAgICAgLy8gbWVhc3VyZSBzdGFydCB2YWx1ZXMKICAgICAgICAgICAgc3RhcnQgPSB7CgogICAgICAgICAgICAgIC8vIGdldCBpbml0aWFsIHRvdWNoIGNvb3JkcwogICAgICAgICAgICAgIHg6IHRvdWNoZXMucGFnZVgsCiAgICAgICAgICAgICAgeTogdG91Y2hlcy5wYWdlWSwKCiAgICAgICAgICAgICAgLy8gc3RvcmUgdGltZSB0byBkZXRlcm1pbmUgdG91Y2ggZHVyYXRpb24KICAgICAgICAgICAgICB0aW1lOiArbmV3IERhdGUoKQoKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIHVzZWQgZm9yIHRlc3RpbmcgZmlyc3QgbW92ZSBldmVudAogICAgICAgICAgICBpc1Njcm9sbGluZyA9IHVuZGVmaW5lZDsKCiAgICAgICAgICAgIC8vIHJlc2V0IGRlbHRhIGFuZCBlbmQgbWVhc3VyZW1lbnRzCiAgICAgICAgICAgIGRlbHRhID0ge307CgogICAgICAgICAgICAvLyBhdHRhY2ggdG91Y2htb3ZlIGFuZCB0b3VjaGVuZCBsaXN0ZW5lcnMKICAgICAgICAgICAgaWYoYnJvd3Nlci50b3VjaCkgewogICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGhpcywgZmFsc2UpOwogICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLCBmYWxzZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLCBmYWxzZSk7CiAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcywgZmFsc2UpOwogICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICB0b3VjaG1vdmU6IGZ1bmN0aW9uKGV2ZW50KSB7CgogICAgICAgICAgICAvLyBlbnN1cmUgc3dpcGluZyB3aXRoIG9uZSB0b3VjaCBhbmQgbm90IHBpbmNoaW5nCiAgICAgICAgICAgIC8vIGVuc3VyZSBzbGlkaW5nIGlzIGVuYWJsZWQKICAgICAgICAgICAgaWYgKGV2ZW50LnRvdWNoZXMubGVuZ3RoID4gMSB8fAogICAgICAgICAgICAgIGV2ZW50LnNjYWxlICYmIGV2ZW50LnNjYWxlICE9PSAxIHx8CiAgICAgICAgICAgICAgc2xpZGVyLnNsaWRlSXNEaXNhYmxlZCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdGlvbnMuZGlzYWJsZVNjcm9sbCkgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICAgIHZhciB0b3VjaGVzID0gZXZlbnQudG91Y2hlc1swXTsKCiAgICAgICAgICAgIC8vIG1lYXN1cmUgY2hhbmdlIGluIHggYW5kIHkKICAgICAgICAgICAgZGVsdGEgPSB7CiAgICAgICAgICAgICAgeDogdG91Y2hlcy5wYWdlWCAtIHN0YXJ0LngsCiAgICAgICAgICAgICAgeTogdG91Y2hlcy5wYWdlWSAtIHN0YXJ0LnkKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIGRldGVybWluZSBpZiBzY3JvbGxpbmcgdGVzdCBoYXMgcnVuIC0gb25lIHRpbWUgdGVzdAogICAgICAgICAgICBpZiAoIHR5cGVvZiBpc1Njcm9sbGluZyA9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgIGlzU2Nyb2xsaW5nID0gISEoIGlzU2Nyb2xsaW5nIHx8IE1hdGguYWJzKGRlbHRhLngpIDwgTWF0aC5hYnMoZGVsdGEueSkgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaWYgdXNlciBpcyBub3QgdHJ5aW5nIHRvIHNjcm9sbCB2ZXJ0aWNhbGx5CiAgICAgICAgICAgIGlmICghaXNTY3JvbGxpbmcpIHsKCiAgICAgICAgICAgICAgLy8gcHJldmVudCBuYXRpdmUgc2Nyb2xsaW5nCiAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICAgICAgLy8gc3RvcCBzbGlkZXNob3cKICAgICAgICAgICAgICBzdG9wKCk7CgogICAgICAgICAgICAgIC8vIGluY3JlYXNlIHJlc2lzdGFuY2UgaWYgZmlyc3Qgb3IgbGFzdCBzbGlkZQogICAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMpIHsgLy8gd2UgZG9uJ3QgYWRkIHJlc2lzdGFuY2UgYXQgdGhlIGVuZAoKICAgICAgICAgICAgICAgIHRyYW5zbGF0ZShjaXJjbGUoaW5kZXgtMSksIGRlbHRhLnggKyBzbGlkZVBvc1tjaXJjbGUoaW5kZXgtMSldLCAwKTsKICAgICAgICAgICAgICAgIHRyYW5zbGF0ZShpbmRleCwgZGVsdGEueCArIHNsaWRlUG9zW2luZGV4XSwgMCk7CiAgICAgICAgICAgICAgICB0cmFuc2xhdGUoY2lyY2xlKGluZGV4KzEpLCBkZWx0YS54ICsgc2xpZGVQb3NbY2lyY2xlKGluZGV4KzEpXSwgMCk7CgogICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgZGVsdGEueCA9CiAgICAgICAgICAgICAgICAgIGRlbHRhLnggLwogICAgICAgICAgICAgICAgICAoICghaW5kZXggJiYgZGVsdGEueCA+IDAgfHwgICAgICAgICAvLyBpZiBmaXJzdCBzbGlkZSBhbmQgc2xpZGluZyBsZWZ0CiAgICAgICAgICAgICAgICAgICAgaW5kZXggPT0gc2xpZGVzLmxlbmd0aCAtIDEgJiYgICAgIC8vIG9yIGlmIGxhc3Qgc2xpZGUgYW5kIHNsaWRpbmcgcmlnaHQKICAgICAgICAgICAgICAgICAgICBkZWx0YS54IDwgMCAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIGlmIHNsaWRpbmcgYXQgYWxsCiAgICAgICAgICAgICAgICAgICAgKSA/CiAgICAgICAgICAgICAgICAgICAgKCBNYXRoLmFicyhkZWx0YS54KSAvIHdpZHRoICsgMSApICAgICAgLy8gZGV0ZXJtaW5lIHJlc2lzdGFuY2UgbGV2ZWwKICAgICAgICAgICAgICAgICAgICA6IDEgKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBubyByZXNpc3RhbmNlIGlmIGZhbHNlCgogICAgICAgICAgICAgICAgLy8gdHJhbnNsYXRlIDE6MQogICAgICAgICAgICAgICAgdHJhbnNsYXRlKGluZGV4LTEsIGRlbHRhLnggKyBzbGlkZVBvc1tpbmRleC0xXSwgMCk7CiAgICAgICAgICAgICAgICB0cmFuc2xhdGUoaW5kZXgsIGRlbHRhLnggKyBzbGlkZVBvc1tpbmRleF0sIDApOwogICAgICAgICAgICAgICAgdHJhbnNsYXRlKGluZGV4KzEsIGRlbHRhLnggKyBzbGlkZVBvc1tpbmRleCsxXSwgMCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfQoKICAgICAgICAgIH0sCiAgICAgICAgICBlbmQ6IGZ1bmN0aW9uKGV2ZW50KSB7CgogICAgICAgICAgICAvLyBtZWFzdXJlIGR1cmF0aW9uCiAgICAgICAgICAgIHZhciBkdXJhdGlvbiA9ICtuZXcgRGF0ZSgpIC0gc3RhcnQudGltZTsKCiAgICAgICAgICAgIC8vIGRldGVybWluZSBpZiBzbGlkZSBhdHRlbXB0IHRyaWdnZXJzIG5leHQvcHJldiBzbGlkZQogICAgICAgICAgICB2YXIgaXNWYWxpZFNsaWRlID0KICAgICAgICAgICAgICBOdW1iZXIoZHVyYXRpb24pIDwgMjUwICYmICAgICAgICAgLy8gaWYgc2xpZGUgZHVyYXRpb24gaXMgbGVzcyB0aGFuIDI1MG1zCiAgICAgICAgICAgICAgTWF0aC5hYnMoZGVsdGEueCkgPiAyMCB8fCAgICAgICAgIC8vIGFuZCBpZiBzbGlkZSBhbXQgaXMgZ3JlYXRlciB0aGFuIDIwcHgKICAgICAgICAgICAgICBNYXRoLmFicyhkZWx0YS54KSA+IHdpZHRoLzI7ICAgICAgLy8gb3IgaWYgc2xpZGUgYW10IGlzIGdyZWF0ZXIgdGhhbiBoYWxmIHRoZSB3aWR0aAoKICAgICAgICAgICAgLy8gZGV0ZXJtaW5lIGlmIHNsaWRlIGF0dGVtcHQgaXMgcGFzdCBzdGFydCBhbmQgZW5kCiAgICAgICAgICAgIHZhciBpc1Bhc3RCb3VuZHMgPSAoIWluZGV4ICYmIGRlbHRhLnggPiAwKSB8fCAgICAgIC8vIGlmIGZpcnN0IHNsaWRlIGFuZCBzbGlkZSBhbXQgaXMgZ3JlYXRlciB0aGFuIDAKICAgICAgICAgICAgICAoaW5kZXggPT0gc2xpZGVzLmxlbmd0aCAtIDEgJiYgZGVsdGEueCA8IDApOyAvLyBvciBpZiBsYXN0IHNsaWRlIGFuZCBzbGlkZSBhbXQgaXMgbGVzcyB0aGFuIDAKCiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMpIGlzUGFzdEJvdW5kcyA9IGZhbHNlOwoKICAgICAgICAgICAgLy8gZGV0ZXJtaW5lIGRpcmVjdGlvbiBvZiBzd2lwZSAodHJ1ZTpyaWdodCwgZmFsc2U6bGVmdCkKICAgICAgICAgICAgdmFyIGRpcmVjdGlvbiA9IGRlbHRhLnggPCAwOwoKICAgICAgICAgICAgLy8gaWYgbm90IHNjcm9sbGluZyB2ZXJ0aWNhbGx5CiAgICAgICAgICAgIGlmICghaXNTY3JvbGxpbmcpIHsKCiAgICAgICAgICAgICAgaWYgKGlzVmFsaWRTbGlkZSAmJiAhaXNQYXN0Qm91bmRzKSB7CgogICAgICAgICAgICAgICAgaWYgKGRpcmVjdGlvbikgewoKICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgeyAvLyB3ZSBuZWVkIHRvIGdldCB0aGUgbmV4dCBpbiB0aGlzIGRpcmVjdGlvbiBpbiBwbGFjZQoKICAgICAgICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleC0xKSwgLXdpZHRoLCAwKTsKICAgICAgICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleCsyKSwgd2lkdGgsIDApOwoKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBtb3ZlKGluZGV4LTEsIC13aWR0aCwgMCk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIG1vdmUoaW5kZXgsIHNsaWRlUG9zW2luZGV4XS13aWR0aCwgc3BlZWQpOwogICAgICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleCsxKSwgc2xpZGVQb3NbY2lyY2xlKGluZGV4KzEpXS13aWR0aCwgc3BlZWQpOwogICAgICAgICAgICAgICAgICBpbmRleCA9IGNpcmNsZShpbmRleCsxKTsKCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jb250aW51b3VzKSB7IC8vIHdlIG5lZWQgdG8gZ2V0IHRoZSBuZXh0IGluIHRoaXMgZGlyZWN0aW9uIGluIHBsYWNlCgogICAgICAgICAgICAgICAgICAgIG1vdmUoY2lyY2xlKGluZGV4KzEpLCB3aWR0aCwgMCk7CiAgICAgICAgICAgICAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgtMiksIC13aWR0aCwgMCk7CgogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1vdmUoaW5kZXgrMSwgd2lkdGgsIDApOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBtb3ZlKGluZGV4LCBzbGlkZVBvc1tpbmRleF0rd2lkdGgsIHNwZWVkKTsKICAgICAgICAgICAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgtMSksIHNsaWRlUG9zW2NpcmNsZShpbmRleC0xKV0rd2lkdGgsIHNwZWVkKTsKICAgICAgICAgICAgICAgICAgaW5kZXggPSBjaXJjbGUoaW5kZXgtMSk7CgogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG9wdGlvbnMuY2FsbGJhY2sgJiYgb3B0aW9ucy5jYWxsYmFjayhpbmRleCwgc2xpZGVzW2luZGV4XSk7CgogICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgewoKICAgICAgICAgICAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgtMSksIC13aWR0aCwgc3BlZWQpOwogICAgICAgICAgICAgICAgICBtb3ZlKGluZGV4LCAwLCBzcGVlZCk7CiAgICAgICAgICAgICAgICAgIG1vdmUoY2lyY2xlKGluZGV4KzEpLCB3aWR0aCwgc3BlZWQpOwoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICBtb3ZlKGluZGV4LTEsIC13aWR0aCwgc3BlZWQpOwogICAgICAgICAgICAgICAgICBtb3ZlKGluZGV4LCAwLCBzcGVlZCk7CiAgICAgICAgICAgICAgICAgIG1vdmUoaW5kZXgrMSwgd2lkdGgsIHNwZWVkKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8ga2lsbCB0b3VjaG1vdmUgYW5kIHRvdWNoZW5kIGV2ZW50IGxpc3RlbmVycyB1bnRpbCB0b3VjaHN0YXJ0IGNhbGxlZCBhZ2FpbgogICAgICAgICAgICBpZihicm93c2VyLnRvdWNoKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9LAogICAgICAgICAgdHJhbnNpdGlvbkVuZDogZnVuY3Rpb24oZXZlbnQpIHsKCiAgICAgICAgICAgIGlmIChwYXJzZUludChldmVudC50YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLWluZGV4JyksIDEwKSA9PSBpbmRleCkgewoKICAgICAgICAgICAgICBpZiAoZGVsYXkpIGJlZ2luKCk7CgogICAgICAgICAgICAgIG9wdGlvbnMudHJhbnNpdGlvbkVuZCAmJiBvcHRpb25zLnRyYW5zaXRpb25FbmQuY2FsbChldmVudCwgaW5kZXgsIHNsaWRlc1tpbmRleF0pOwoKICAgICAgICAgICAgfQoKICAgICAgICAgIH0KCiAgICAgICAgfTsKCiAgICAgICAgLy8gUHVibGljIEFQSQogICAgICAgIHRoaXMudXBkYXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KHNldHVwKTsKICAgICAgICB9OwogICAgICAgIHRoaXMuc2V0dXAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHNldHVwKCk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5lbmFibGVTbGlkZSA9IGZ1bmN0aW9uKHNob3VsZEVuYWJsZSkgewogICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgdGhpcy5zbGlkZUlzRGlzYWJsZWQgPSAhc2hvdWxkRW5hYmxlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICF0aGlzLnNsaWRlSXNEaXNhYmxlZDsKICAgICAgICB9LAogICAgICAgICAgdGhpcy5zbGlkZSA9IGZ1bmN0aW9uKHRvLCBzcGVlZCkgewogICAgICAgICAgICAvLyBjYW5jZWwgc2xpZGVzaG93CiAgICAgICAgICAgIHN0b3AoKTsKCiAgICAgICAgICAgIHNsaWRlKHRvLCBzcGVlZCk7CiAgICAgICAgICB9OwoKICAgICAgICB0aGlzLnByZXYgPSB0aGlzLnByZXZpb3VzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyBjYW5jZWwgc2xpZGVzaG93CiAgICAgICAgICBzdG9wKCk7CgogICAgICAgICAgcHJldigpOwogICAgICAgIH07CgogICAgICAgIHRoaXMubmV4dCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gY2FuY2VsIHNsaWRlc2hvdwogICAgICAgICAgc3RvcCgpOwoKICAgICAgICAgIG5leHQoKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIGNhbmNlbCBzbGlkZXNob3cKICAgICAgICAgIHN0b3AoKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBiZWdpbigpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuY3VycmVudEluZGV4ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyByZXR1cm4gY3VycmVudCBpbmRleCBwb3NpdGlvbgogICAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICAgIH07CgogICAgICAgIHRoaXMuc2xpZGVzQ291bnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIHJldHVybiB0b3RhbCBudW1iZXIgb2Ygc2xpZGVzCiAgICAgICAgICByZXR1cm4gbGVuZ3RoOwogICAgICAgIH07CgogICAgICAgIHRoaXMua2lsbCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gY2FuY2VsIHNsaWRlc2hvdwogICAgICAgICAgc3RvcCgpOwoKICAgICAgICAgIC8vIHJlc2V0IGVsZW1lbnQKICAgICAgICAgIGVsZW1lbnQuc3R5bGUud2lkdGggPSAnJzsKICAgICAgICAgIGVsZW1lbnQuc3R5bGUubGVmdCA9ICcnOwoKICAgICAgICAgIC8vIHJlc2V0IHNsaWRlcwogICAgICAgICAgdmFyIHBvcyA9IHNsaWRlcy5sZW5ndGg7CiAgICAgICAgICB3aGlsZShwb3MtLSkgewoKICAgICAgICAgICAgdmFyIHNsaWRlID0gc2xpZGVzW3Bvc107CiAgICAgICAgICAgIHNsaWRlLnN0eWxlLndpZHRoID0gJyc7CiAgICAgICAgICAgIHNsaWRlLnN0eWxlLmxlZnQgPSAnJzsKCiAgICAgICAgICAgIGlmIChicm93c2VyLnRyYW5zaXRpb25zKSB0cmFuc2xhdGUocG9zLCAwLCAwKTsKCiAgICAgICAgICB9CgogICAgICAgICAgLy8gcmVtb3ZlZCBldmVudCBsaXN0ZW5lcnMKICAgICAgICAgIGlmIChicm93c2VyLmFkZEV2ZW50TGlzdGVuZXIpIHsKCiAgICAgICAgICAgIC8vIHJlbW92ZSBjdXJyZW50IGV2ZW50IGxpc3RlbmVycwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd3ZWJraXRUcmFuc2l0aW9uRW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbXNUcmFuc2l0aW9uRW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignb1RyYW5zaXRpb25FbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdvdHJhbnNpdGlvbmVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIGV2ZW50cywgZmFsc2UpOwoKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UgewoKICAgICAgICAgICAgd2luZG93Lm9ucmVzaXplID0gbnVsbDsKCiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyB0cmlnZ2VyIHNldHVwCiAgICAgICAgICBzZXR1cCgpOwoKICAgICAgICAgIC8vIHN0YXJ0IGF1dG8gc2xpZGVzaG93IGlmIGFwcGxpY2FibGUKICAgICAgICAgIGlmIChkZWxheSkgYmVnaW4oKTsKCgogICAgICAgICAgLy8gYWRkIGV2ZW50IGxpc3RlbmVycwogICAgICAgICAgaWYgKGJyb3dzZXIuYWRkRXZlbnRMaXN0ZW5lcikgewoKICAgICAgICAgICAgLy8gc2V0IHRvdWNoc3RhcnQgZXZlbnQgb24gZWxlbWVudAogICAgICAgICAgICBpZiAoYnJvd3Nlci50b3VjaCkgewogICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChicm93c2VyLnRyYW5zaXRpb25zKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRUcmFuc2l0aW9uRW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtc1RyYW5zaXRpb25FbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ29UcmFuc2l0aW9uRW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdvdHJhbnNpdGlvbmVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndHJhbnNpdGlvbmVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBzZXQgcmVzaXplIGV2ZW50IG9uIHdpbmRvdwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgZXZlbnRzLCBmYWxzZSk7CgogICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIHdpbmRvdy5vbnJlc2l6ZSA9IGZ1bmN0aW9uICgpIHsgc2V0dXAoKTsgfTsgLy8gdG8gcGxheSBuaWNlIHdpdGggb2xkIElFCgogICAgICAgICAgfQogICAgICAgIH07CgogICAgICB9CiAgICB9KTsKCiAgfSkoaW9uaWMpOwoKICAoZnVuY3Rpb24oaW9uaWMpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICBpb25pYy52aWV3cy5Ub2dnbGUgPSBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQoewogICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICB0aGlzLmVsID0gb3B0cy5lbDsKICAgICAgICB0aGlzLmNoZWNrYm94ID0gb3B0cy5jaGVja2JveDsKICAgICAgICB0aGlzLnRyYWNrID0gb3B0cy50cmFjazsKICAgICAgICB0aGlzLmhhbmRsZSA9IG9wdHMuaGFuZGxlOwogICAgICAgIHRoaXMub3BlblBlcmNlbnQgPSAtMTsKICAgICAgICB0aGlzLm9uQ2hhbmdlID0gb3B0cy5vbkNoYW5nZSB8fCBmdW5jdGlvbigpIHt9OwoKICAgICAgICB0aGlzLnRyaWdnZXJUaHJlc2hvbGQgPSBvcHRzLnRyaWdnZXJUaHJlc2hvbGQgfHwgMjA7CgogICAgICAgIHRoaXMuZHJhZ1N0YXJ0SGFuZGxlciA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHNlbGYuZHJhZ1N0YXJ0KGUpOwogICAgICAgIH07CiAgICAgICAgdGhpcy5kcmFnSGFuZGxlciA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHNlbGYuZHJhZyhlKTsKICAgICAgICB9OwogICAgICAgIHRoaXMuaG9sZEhhbmRsZXIgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICBzZWxmLmhvbGQoZSk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLnJlbGVhc2VIYW5kbGVyID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgc2VsZi5yZWxlYXNlKGUpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuZHJhZ1N0YXJ0R2VzdHVyZSA9IGlvbmljLm9uR2VzdHVyZSgnZHJhZ3N0YXJ0JywgdGhpcy5kcmFnU3RhcnRIYW5kbGVyLCB0aGlzLmVsKTsKICAgICAgICB0aGlzLmRyYWdHZXN0dXJlID0gaW9uaWMub25HZXN0dXJlKCdkcmFnJywgdGhpcy5kcmFnSGFuZGxlciwgdGhpcy5lbCk7CiAgICAgICAgdGhpcy5kcmFnSG9sZEdlc3R1cmUgPSBpb25pYy5vbkdlc3R1cmUoJ2hvbGQnLCB0aGlzLmhvbGRIYW5kbGVyLCB0aGlzLmVsKTsKICAgICAgICB0aGlzLmRyYWdSZWxlYXNlR2VzdHVyZSA9IGlvbmljLm9uR2VzdHVyZSgncmVsZWFzZScsIHRoaXMucmVsZWFzZUhhbmRsZXIsIHRoaXMuZWwpOwogICAgICB9LAoKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgaW9uaWMub2ZmR2VzdHVyZSh0aGlzLmRyYWdTdGFydEdlc3R1cmUsICdkcmFnc3RhcnQnLCB0aGlzLmRyYWdTdGFydEdlc3R1cmUpOwogICAgICAgIGlvbmljLm9mZkdlc3R1cmUodGhpcy5kcmFnR2VzdHVyZSwgJ2RyYWcnLCB0aGlzLmRyYWdHZXN0dXJlKTsKICAgICAgICBpb25pYy5vZmZHZXN0dXJlKHRoaXMuZHJhZ0hvbGRHZXN0dXJlLCAnaG9sZCcsIHRoaXMuaG9sZEhhbmRsZXIpOwogICAgICAgIGlvbmljLm9mZkdlc3R1cmUodGhpcy5kcmFnUmVsZWFzZUdlc3R1cmUsICdyZWxlYXNlJywgdGhpcy5yZWxlYXNlSGFuZGxlcik7CiAgICAgIH0sCgogICAgICB0YXA6IGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZih0aGlzLmVsLmdldEF0dHJpYnV0ZSgnZGlzYWJsZWQnKSAhPT0gJ2Rpc2FibGVkJykgewogICAgICAgICAgdGhpcy52YWwoICF0aGlzLmNoZWNrYm94LmNoZWNrZWQgKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBkcmFnU3RhcnQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZih0aGlzLmNoZWNrYm94LmRpc2FibGVkKSByZXR1cm47CgogICAgICAgIHRoaXMuX2RyYWdJbmZvID0gewogICAgICAgICAgd2lkdGg6IHRoaXMuZWwub2Zmc2V0V2lkdGgsCiAgICAgICAgICBsZWZ0OiB0aGlzLmVsLm9mZnNldExlZnQsCiAgICAgICAgICByaWdodDogdGhpcy5lbC5vZmZzZXRMZWZ0ICsgdGhpcy5lbC5vZmZzZXRXaWR0aCwKICAgICAgICAgIHRyaWdnZXJYOiB0aGlzLmVsLm9mZnNldFdpZHRoIC8gMiwKICAgICAgICAgIGluaXRpYWxTdGF0ZTogdGhpcy5jaGVja2JveC5jaGVja2VkCiAgICAgICAgfTsKCiAgICAgICAgLy8gU3RvcCBhbnkgcGFyZW50IGRyYWdnaW5nCiAgICAgICAgZS5nZXN0dXJlLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgIC8vIFRyaWdnZXIgaG9sZCBzdHlsZXMKICAgICAgICB0aGlzLmhvbGQoZSk7CiAgICAgIH0sCgogICAgICBkcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIGlmKCF0aGlzLl9kcmFnSW5mbykgeyByZXR1cm47IH0KCiAgICAgICAgLy8gU3RvcCBhbnkgcGFyZW50IGRyYWdnaW5nCiAgICAgICAgZS5nZXN0dXJlLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbihhbW91bnQpIHsKICAgICAgICAgIGlmICghc2VsZi5fZHJhZ0luZm8pIHsgcmV0dXJuOyB9CgogICAgICAgICAgdmFyIHNsaWRlUGFnZUxlZnQgPSBzZWxmLnRyYWNrLm9mZnNldExlZnQgKyAoc2VsZi5oYW5kbGUub2Zmc2V0V2lkdGggLyAyKTsKICAgICAgICAgIHZhciBzbGlkZVBhZ2VSaWdodCA9IHNlbGYudHJhY2sub2Zmc2V0TGVmdCArIHNlbGYudHJhY2sub2Zmc2V0V2lkdGggLSAoc2VsZi5oYW5kbGUub2Zmc2V0V2lkdGggLyAyKTsKICAgICAgICAgIHZhciBkeCA9IGUuZ2VzdHVyZS5kZWx0YVg7CgogICAgICAgICAgdmFyIHB4ID0gZS5nZXN0dXJlLnRvdWNoZXNbMF0ucGFnZVggLSBzZWxmLl9kcmFnSW5mby5sZWZ0OwogICAgICAgICAgdmFyIG14ID0gc2VsZi5fZHJhZ0luZm8ud2lkdGggLSBzZWxmLnRyaWdnZXJUaHJlc2hvbGQ7CgogICAgICAgICAgLy8gVGhlIGluaXRpYWwgc3RhdGUgd2FzIG9uLCBzbyAidGVuZCB0b3dhcmRzIiBvbgogICAgICAgICAgaWYoc2VsZi5fZHJhZ0luZm8uaW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgIGlmKHB4IDwgc2VsZi50cmlnZ2VyVGhyZXNob2xkKSB7CiAgICAgICAgICAgICAgc2VsZi5zZXRPcGVuUGVyY2VudCgwKTsKICAgICAgICAgICAgfSBlbHNlIGlmKHB4ID4gc2VsZi5fZHJhZ0luZm8udHJpZ2dlclgpIHsKICAgICAgICAgICAgICBzZWxmLnNldE9wZW5QZXJjZW50KDEwMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFRoZSBpbml0aWFsIHN0YXRlIHdhcyBvZmYsIHNvICJ0ZW5kIHRvd2FyZHMiIG9mZgogICAgICAgICAgICBpZihweCA8IHNlbGYuX2RyYWdJbmZvLnRyaWdnZXJYKSB7CiAgICAgICAgICAgICAgc2VsZi5zZXRPcGVuUGVyY2VudCgwKTsKICAgICAgICAgICAgfSBlbHNlIGlmKHB4ID4gbXgpIHsKICAgICAgICAgICAgICBzZWxmLnNldE9wZW5QZXJjZW50KDEwMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwKCiAgICAgIGVuZERyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB0aGlzLl9kcmFnSW5mbyA9IG51bGw7CiAgICAgIH0sCgogICAgICBob2xkOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdGhpcy5lbC5jbGFzc0xpc3QuYWRkKCdkcmFnZ2luZycpOwogICAgICB9LAogICAgICByZWxlYXNlOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdGhpcy5lbC5jbGFzc0xpc3QucmVtb3ZlKCdkcmFnZ2luZycpOwogICAgICAgIHRoaXMuZW5kRHJhZyhlKTsKICAgICAgfSwKCgogICAgICBzZXRPcGVuUGVyY2VudDogZnVuY3Rpb24ob3BlblBlcmNlbnQpIHsKICAgICAgICAvLyBvbmx5IG1ha2UgYSBjaGFuZ2UgaWYgdGhlIG5ldyBvcGVuIHBlcmNlbnQgaGFzIGNoYW5nZWQKICAgICAgICBpZih0aGlzLm9wZW5QZXJjZW50IDwgMCB8fCAob3BlblBlcmNlbnQgPCAodGhpcy5vcGVuUGVyY2VudCAtIDMpIHx8IG9wZW5QZXJjZW50ID4gKHRoaXMub3BlblBlcmNlbnQgKyAzKSApICkgewogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudCA9IG9wZW5QZXJjZW50OwoKICAgICAgICAgIGlmKG9wZW5QZXJjZW50ID09PSAwKSB7CiAgICAgICAgICAgIHRoaXMudmFsKGZhbHNlKTsKICAgICAgICAgIH0gZWxzZSBpZihvcGVuUGVyY2VudCA9PT0gMTAwKSB7CiAgICAgICAgICAgIHRoaXMudmFsKHRydWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG9wZW5QaXhlbCA9IE1hdGgucm91bmQoIChvcGVuUGVyY2VudCAvIDEwMCkgKiB0aGlzLnRyYWNrLm9mZnNldFdpZHRoIC0gKHRoaXMuaGFuZGxlLm9mZnNldFdpZHRoKSApOwogICAgICAgICAgICBvcGVuUGl4ZWwgPSAob3BlblBpeGVsIDwgMSA/IDAgOiBvcGVuUGl4ZWwpOwogICAgICAgICAgICB0aGlzLmhhbmRsZS5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICd0cmFuc2xhdGUzZCgnICsgb3BlblBpeGVsICsgJ3B4LDAsMCknOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKCiAgICAgIHZhbDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZih2YWx1ZSA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gZmFsc2UpIHsKICAgICAgICAgIGlmKHRoaXMuaGFuZGxlLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dICE9PSAiIikgewogICAgICAgICAgICB0aGlzLmhhbmRsZS5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICIiOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5jaGVja2JveC5jaGVja2VkID0gdmFsdWU7CiAgICAgICAgICB0aGlzLm9wZW5QZXJjZW50ID0gKHZhbHVlID8gMTAwIDogMCk7CiAgICAgICAgICB0aGlzLm9uQ2hhbmdlICYmIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuY2hlY2tib3guY2hlY2tlZDsKICAgICAgfQoKICAgIH0pOwoKICB9KShpb25pYyk7CgogIChmdW5jdGlvbihpb25pYykgewogICAgJ3VzZSBzdHJpY3QnOwogICAgaW9uaWMuY29udHJvbGxlcnMuVmlld0NvbnRyb2xsZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKCiAgICBpb25pYy5jb250cm9sbGVycy5WaWV3Q29udHJvbGxlci5pbmhlcml0ID0gaW9uaWMuaW5oZXJpdDsKCiAgICBpb25pYy5leHRlbmQoaW9uaWMuY29udHJvbGxlcnMuVmlld0NvbnRyb2xsZXIucHJvdG90eXBlLCB7CiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkge30sCiAgICAgIC8vIERlc3Ryb3kgdGhpcyB2aWV3IGNvbnRyb2xsZXIsIGluY2x1ZGluZyBhbGwgY2hpbGQgdmlld3MKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgIH0KICAgIH0pOwoKICB9KSh3aW5kb3cuaW9uaWMpOwoKICAoZnVuY3Rpb24oaW9uaWMpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICAvKioKICAgICAqIFRoZSBTaWRlTWVudUNvbnRyb2xsZXIgaXMgYSBjb250cm9sbGVyIHdpdGggYSBsZWZ0IGFuZC9vciByaWdodCBtZW51IHRoYXQKICAgICAqIGNhbiBiZSBzbGlkIG91dCBhbmQgdG9nZ2xlZC4gU2VlbiBvbiBtYW55IGFuIGFwcC4KICAgICAqCiAgICAgKiBUaGUgcmlnaHQgb3IgbGVmdCBtZW51IGNhbiBiZSBkaXNhYmxlZCBvciBub3QgdXNlZCBhdCBhbGwsIGlmIGRlc2lyZWQuCiAgICAgKi8KICAgIGlvbmljLmNvbnRyb2xsZXJzLlNpZGVNZW51Q29udHJvbGxlciA9IGlvbmljLmNvbnRyb2xsZXJzLlZpZXdDb250cm9sbGVyLmluaGVyaXQoewogICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICB0aGlzLmxlZnQgPSBvcHRpb25zLmxlZnQ7CiAgICAgICAgdGhpcy5yaWdodCA9IG9wdGlvbnMucmlnaHQ7CiAgICAgICAgdGhpcy5jb250ZW50ID0gb3B0aW9ucy5jb250ZW50OwogICAgICAgIHRoaXMuZHJhZ1RocmVzaG9sZFggPSBvcHRpb25zLmRyYWdUaHJlc2hvbGRYIHx8IDEwOwoKICAgICAgICB0aGlzLl9yaWdodFNob3dpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLl9sZWZ0U2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMuX2lzRHJhZ2dpbmcgPSBmYWxzZTsKCiAgICAgICAgaWYodGhpcy5jb250ZW50KSB7CiAgICAgICAgICB0aGlzLmNvbnRlbnQub25EcmFnID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICBzZWxmLl9oYW5kbGVEcmFnKGUpOwogICAgICAgICAgfTsKCiAgICAgICAgICB0aGlzLmNvbnRlbnQub25FbmREcmFnID1mdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHNlbGYuX2VuZERyYWcoZSk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIFNldCB0aGUgY29udGVudCB2aWV3IGNvbnRyb2xsZXIgaWYgbm90IHBhc3NlZCBpbiB0aGUgY29uc3RydWN0b3Igb3B0aW9ucy4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtvYmplY3R9IGNvbnRlbnQKICAgICAgICovCiAgICAgIHNldENvbnRlbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHRoaXMuY29udGVudCA9IGNvbnRlbnQ7CgogICAgICAgIHRoaXMuY29udGVudC5vbkRyYWcgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICBzZWxmLl9oYW5kbGVEcmFnKGUpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuY29udGVudC5lbmREcmFnID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgc2VsZi5fZW5kRHJhZyhlKTsKICAgICAgICB9OwogICAgICB9LAoKICAgICAgaXNPcGVuTGVmdDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0T3BlbkFtb3VudCgpID4gMDsKICAgICAgfSwKCiAgICAgIGlzT3BlblJpZ2h0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRPcGVuQW1vdW50KCkgPCAwOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFRvZ2dsZSB0aGUgbGVmdCBtZW51IHRvIG9wZW4gMTAwJQogICAgICAgKi8KICAgICAgdG9nZ2xlTGVmdDogZnVuY3Rpb24oc2hvdWxkT3BlbikgewogICAgICAgIHZhciBvcGVuQW1vdW50ID0gdGhpcy5nZXRPcGVuQW1vdW50KCk7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHNob3VsZE9wZW4gPSBvcGVuQW1vdW50IDw9IDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuY29udGVudC5lbmFibGVBbmltYXRpb24oKTsKICAgICAgICBpZighc2hvdWxkT3BlbikgewogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgxMDApOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBUb2dnbGUgdGhlIHJpZ2h0IG1lbnUgdG8gb3BlbiAxMDAlCiAgICAgICAqLwogICAgICB0b2dnbGVSaWdodDogZnVuY3Rpb24oc2hvdWxkT3BlbikgewogICAgICAgIHZhciBvcGVuQW1vdW50ID0gdGhpcy5nZXRPcGVuQW1vdW50KCk7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICAgIHNob3VsZE9wZW4gPSBvcGVuQW1vdW50ID49IDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuY29udGVudC5lbmFibGVBbmltYXRpb24oKTsKICAgICAgICBpZighc2hvdWxkT3BlbikgewogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgtMTAwKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQ2xvc2UgYWxsIG1lbnVzLgogICAgICAgKi8KICAgICAgY2xvc2U6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMub3BlblBlcmNlbnRhZ2UoMCk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQHJldHVybiB7ZmxvYXR9IFRoZSBhbW91bnQgdGhlIHNpZGUgbWVudSBpcyBvcGVuLCBlaXRoZXIgcG9zaXRpdmUgb3IgbmVnYXRpdmUgZm9yIGxlZnQgKHBvc2l0aXZlKSwgb3IgcmlnaHQgKG5lZ2F0aXZlKQogICAgICAgKi8KICAgICAgZ2V0T3BlbkFtb3VudDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudCAmJiB0aGlzLmNvbnRlbnQuZ2V0VHJhbnNsYXRlWCgpIHx8IDA7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQHJldHVybiB7ZmxvYXR9IFRoZSByYXRpbyBvZiBvcGVuIGFtb3VudCBvdmVyIG1lbnUgd2lkdGguIEZvciBleGFtcGxlLCBhCiAgICAgICAqIG1lbnUgb2Ygd2lkdGggMTAwIG9wZW4gNTAgcGl4ZWxzIHdvdWxkIGJlIG9wZW4gNTAlIG9yIGEgcmF0aW8gb2YgMC41LiBWYWx1ZSBpcyBuZWdhdGl2ZQogICAgICAgKiBmb3IgcmlnaHQgbWVudS4KICAgICAgICovCiAgICAgIGdldE9wZW5SYXRpbzogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFtb3VudCA9IHRoaXMuZ2V0T3BlbkFtb3VudCgpOwogICAgICAgIGlmKGFtb3VudCA+PSAwKSB7CiAgICAgICAgICByZXR1cm4gYW1vdW50IC8gdGhpcy5sZWZ0LndpZHRoOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYW1vdW50IC8gdGhpcy5yaWdodC53aWR0aDsKICAgICAgfSwKCiAgICAgIGlzT3BlbjogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0T3BlbkFtb3VudCgpICE9PSAwOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEByZXR1cm4ge2Zsb2F0fSBUaGUgcGVyY2VudGFnZSBvZiBvcGVuIGFtb3VudCBvdmVyIG1lbnUgd2lkdGguIEZvciBleGFtcGxlLCBhCiAgICAgICAqIG1lbnUgb2Ygd2lkdGggMTAwIG9wZW4gNTAgcGl4ZWxzIHdvdWxkIGJlIG9wZW4gNTAlLiBWYWx1ZSBpcyBuZWdhdGl2ZQogICAgICAgKiBmb3IgcmlnaHQgbWVudS4KICAgICAgICovCiAgICAgIGdldE9wZW5QZXJjZW50YWdlOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRPcGVuUmF0aW8oKSAqIDEwMDsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBPcGVuIHRoZSBtZW51IHdpdGggYSBnaXZlbiBwZXJjZW50YWdlIGFtb3VudC4KICAgICAgICogQHBhcmFtIHtmbG9hdH0gcGVyY2VudGFnZSBUaGUgcGVyY2VudGFnZSAocG9zaXRpdmUgb3IgbmVnYXRpdmUgZm9yIGxlZnQvcmlnaHQpIHRvIG9wZW4gdGhlIG1lbnUuCiAgICAgICAqLwogICAgICBvcGVuUGVyY2VudGFnZTogZnVuY3Rpb24ocGVyY2VudGFnZSkgewogICAgICAgIHZhciBwID0gcGVyY2VudGFnZSAvIDEwMDsKCiAgICAgICAgaWYodGhpcy5sZWZ0ICYmIHBlcmNlbnRhZ2UgPj0gMCkgewogICAgICAgICAgdGhpcy5vcGVuQW1vdW50KHRoaXMubGVmdC53aWR0aCAqIHApOwogICAgICAgIH0gZWxzZSBpZih0aGlzLnJpZ2h0ICYmIHBlcmNlbnRhZ2UgPCAwKSB7CiAgICAgICAgICB2YXIgbWF4UmlnaHQgPSB0aGlzLnJpZ2h0LndpZHRoOwogICAgICAgICAgdGhpcy5vcGVuQW1vdW50KHRoaXMucmlnaHQud2lkdGggKiBwKTsKICAgICAgICB9CgogICAgICAgIGlmKHBlcmNlbnRhZ2UgIT09IDApIHsKICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgnbWVudS1vcGVuJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnbWVudS1vcGVuJyk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIE9wZW4gdGhlIG1lbnUgdGhlIGdpdmVuIHBpeGVsIGFtb3VudC4KICAgICAgICogQHBhcmFtIHtmbG9hdH0gYW1vdW50IHRoZSBwaXhlbCBhbW91bnQgdG8gb3BlbiB0aGUgbWVudS4gUG9zaXRpdmUgdmFsdWUgZm9yIGxlZnQgbWVudSwKICAgICAgICogbmVnYXRpdmUgdmFsdWUgZm9yIHJpZ2h0IG1lbnUgKG9ubHkgb25lIG1lbnUgd2lsbCBiZSB2aXNpYmxlIGF0IGEgdGltZSkuCiAgICAgICAqLwogICAgICBvcGVuQW1vdW50OiBmdW5jdGlvbihhbW91bnQpIHsKICAgICAgICB2YXIgbWF4TGVmdCA9IHRoaXMubGVmdCAmJiB0aGlzLmxlZnQud2lkdGggfHwgMDsKICAgICAgICB2YXIgbWF4UmlnaHQgPSB0aGlzLnJpZ2h0ICYmIHRoaXMucmlnaHQud2lkdGggfHwgMDsKCiAgICAgICAgLy8gQ2hlY2sgaWYgd2UgY2FuIG1vdmUgdG8gdGhhdCBzaWRlLCBkZXBlbmRpbmcgaWYgdGhlIGxlZnQvcmlnaHQgcGFuZWwgaXMgZW5hYmxlZAogICAgICAgIGlmKCEodGhpcy5sZWZ0ICYmIHRoaXMubGVmdC5pc0VuYWJsZWQpICYmIGFtb3VudCA+IDApIHsKICAgICAgICAgIHRoaXMuY29udGVudC5zZXRUcmFuc2xhdGVYKDApOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYoISh0aGlzLnJpZ2h0ICYmIHRoaXMucmlnaHQuaXNFbmFibGVkKSAmJiBhbW91bnQgPCAwKSB7CiAgICAgICAgICB0aGlzLmNvbnRlbnQuc2V0VHJhbnNsYXRlWCgwKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMuX2xlZnRTaG93aW5nICYmIGFtb3VudCA+IG1heExlZnQpIHsKICAgICAgICAgIHRoaXMuY29udGVudC5zZXRUcmFuc2xhdGVYKG1heExlZnQpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5fcmlnaHRTaG93aW5nICYmIGFtb3VudCA8IC1tYXhSaWdodCkgewogICAgICAgICAgdGhpcy5jb250ZW50LnNldFRyYW5zbGF0ZVgoLW1heFJpZ2h0KTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29udGVudC5zZXRUcmFuc2xhdGVYKGFtb3VudCk7CgogICAgICAgIGlmKGFtb3VudCA+PSAwKSB7CiAgICAgICAgICB0aGlzLl9sZWZ0U2hvd2luZyA9IHRydWU7CiAgICAgICAgICB0aGlzLl9yaWdodFNob3dpbmcgPSBmYWxzZTsKCiAgICAgICAgICBpZihhbW91bnQgPiAwKSB7CiAgICAgICAgICAgIC8vIFB1c2ggdGhlIHotaW5kZXggb2YgdGhlIHJpZ2h0IG1lbnUgZG93bgogICAgICAgICAgICB0aGlzLnJpZ2h0ICYmIHRoaXMucmlnaHQucHVzaERvd24gJiYgdGhpcy5yaWdodC5wdXNoRG93bigpOwogICAgICAgICAgICAvLyBCcmluZyB0aGUgei1pbmRleCBvZiB0aGUgbGVmdCBtZW51IHVwCiAgICAgICAgICAgIHRoaXMubGVmdCAmJiB0aGlzLmxlZnQuYnJpbmdVcCAmJiB0aGlzLmxlZnQuYnJpbmdVcCgpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9yaWdodFNob3dpbmcgPSB0cnVlOwogICAgICAgICAgdGhpcy5fbGVmdFNob3dpbmcgPSBmYWxzZTsKCiAgICAgICAgICAvLyBCcmluZyB0aGUgei1pbmRleCBvZiB0aGUgcmlnaHQgbWVudSB1cAogICAgICAgICAgdGhpcy5yaWdodCAmJiB0aGlzLnJpZ2h0LmJyaW5nVXAgJiYgdGhpcy5yaWdodC5icmluZ1VwKCk7CiAgICAgICAgICAvLyBQdXNoIHRoZSB6LWluZGV4IG9mIHRoZSBsZWZ0IG1lbnUgZG93bgogICAgICAgICAgdGhpcy5sZWZ0ICYmIHRoaXMubGVmdC5wdXNoRG93biAmJiB0aGlzLmxlZnQucHVzaERvd24oKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogR2l2ZW4gYW4gZXZlbnQgb2JqZWN0LCBmaW5kIHRoZSBmaW5hbCByZXN0aW5nIHBvc2l0aW9uIG9mIHRoaXMgc2lkZQogICAgICAgKiBtZW51LiBGb3IgZXhhbXBsZSwgaWYgdGhlIHVzZXIgInRocm93cyIgdGhlIGNvbnRlbnQgdG8gdGhlIHJpZ2h0IGFuZAogICAgICAgKiByZWxlYXNlcyB0aGUgdG91Y2gsIHRoZSBsZWZ0IG1lbnUgc2hvdWxkIHNuYXAgb3BlbiAoYW5pbWF0ZWQsIG9mIGNvdXJzZSkuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7RXZlbnR9IGUgdGhlIGdlc3R1cmUgZXZlbnQgdG8gdXNlIGZvciBzbmFwcGluZwogICAgICAgKi8KICAgICAgc25hcFRvUmVzdDogZnVuY3Rpb24oZSkgewogICAgICAgIC8vIFdlIHdhbnQgdG8gYW5pbWF0ZSBhdCB0aGUgZW5kIG9mIHRoaXMKICAgICAgICB0aGlzLmNvbnRlbnQuZW5hYmxlQW5pbWF0aW9uKCk7CiAgICAgICAgdGhpcy5faXNEcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgICAvLyBDaGVjayBob3cgbXVjaCB0aGUgcGFuZWwgaXMgb3BlbiBhZnRlciB0aGUgZHJhZywgYW5kCiAgICAgICAgLy8gd2hhdCB0aGUgZHJhZyB2ZWxvY2l0eSBpcwogICAgICAgIHZhciByYXRpbyA9IHRoaXMuZ2V0T3BlblJhdGlvKCk7CgogICAgICAgIGlmKHJhdGlvID09PSAwKSB7CiAgICAgICAgICAvLyBKdXN0IHRvIGJlIHNhZmUKICAgICAgICAgIHRoaXMub3BlblBlcmNlbnRhZ2UoMCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgdmVsb2NpdHlUaHJlc2hvbGQgPSAwLjM7CiAgICAgICAgdmFyIHZlbG9jaXR5WCA9IGUuZ2VzdHVyZS52ZWxvY2l0eVg7CiAgICAgICAgdmFyIGRpcmVjdGlvbiA9IGUuZ2VzdHVyZS5kaXJlY3Rpb247CgogICAgICAgIC8vIExlc3MgdGhhbiBoYWxmLCBnb2luZyBsZWZ0CiAgICAgICAgLy9pZihyYXRpbyA+IDAgJiYgcmF0aW8gPCAwLjUgJiYgZGlyZWN0aW9uID09ICdsZWZ0JyAmJiB2ZWxvY2l0eVggPCB2ZWxvY2l0eVRocmVzaG9sZCkgewogICAgICAgIC8vdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKICAgICAgICAvL30KCiAgICAgICAgLy8gR29pbmcgcmlnaHQsIGxlc3MgdGhhbiBoYWxmLCB0b28gc2xvdyAoc25hcCBiYWNrKQogICAgICAgIGlmKHJhdGlvID4gMCAmJiByYXRpbyA8IDAuNSAmJiBkaXJlY3Rpb24gPT0gJ3JpZ2h0JyAmJiB2ZWxvY2l0eVggPCB2ZWxvY2l0eVRocmVzaG9sZCkgewogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKICAgICAgICB9CgogICAgICAgIC8vIEdvaW5nIGxlZnQsIG1vcmUgdGhhbiBoYWxmLCB0b28gc2xvdyAoc25hcCBiYWNrKQogICAgICAgIGVsc2UgaWYocmF0aW8gPiAwLjUgJiYgZGlyZWN0aW9uID09ICdsZWZ0JyAmJiB2ZWxvY2l0eVggPCB2ZWxvY2l0eVRocmVzaG9sZCkgewogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgxMDApOwogICAgICAgIH0KCiAgICAgICAgLy8gR29pbmcgbGVmdCwgbGVzcyB0aGFuIGhhbGYsIHRvbyBzbG93IChzbmFwIGJhY2spCiAgICAgICAgZWxzZSBpZihyYXRpbyA8IDAgJiYgcmF0aW8gPiAtMC41ICYmIGRpcmVjdGlvbiA9PSAnbGVmdCcgJiYgdmVsb2NpdHlYIDwgdmVsb2NpdHlUaHJlc2hvbGQpIHsKICAgICAgICAgIHRoaXMub3BlblBlcmNlbnRhZ2UoMCk7CiAgICAgICAgfQoKICAgICAgICAvLyBHb2luZyByaWdodCwgbW9yZSB0aGFuIGhhbGYsIHRvbyBzbG93IChzbmFwIGJhY2spCiAgICAgICAgZWxzZSBpZihyYXRpbyA8IDAuNSAmJiBkaXJlY3Rpb24gPT0gJ3JpZ2h0JyAmJiB2ZWxvY2l0eVggPCB2ZWxvY2l0eVRocmVzaG9sZCkgewogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgtMTAwKTsKICAgICAgICB9CgogICAgICAgIC8vIEdvaW5nIHJpZ2h0LCBtb3JlIHRoYW4gaGFsZiwgb3IgcXVpY2tseSAoc25hcCBvcGVuKQogICAgICAgIGVsc2UgaWYoZGlyZWN0aW9uID09ICdyaWdodCcgJiYgcmF0aW8gPj0gMCAmJiAocmF0aW8gPj0gMC41IHx8IHZlbG9jaXR5WCA+IHZlbG9jaXR5VGhyZXNob2xkKSkgewogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgxMDApOwogICAgICAgIH0KCiAgICAgICAgLy8gR29pbmcgbGVmdCwgbW9yZSB0aGFuIGhhbGYsIG9yIHF1aWNrbHkgKHNwYW4gb3BlbikKICAgICAgICBlbHNlIGlmKGRpcmVjdGlvbiA9PSAnbGVmdCcgJiYgcmF0aW8gPD0gMCAmJiAocmF0aW8gPD0gLTAuNSB8fCB2ZWxvY2l0eVggPiB2ZWxvY2l0eVRocmVzaG9sZCkpIHsKICAgICAgICAgIHRoaXMub3BlblBlcmNlbnRhZ2UoLTEwMCk7CiAgICAgICAgfQoKICAgICAgICAvLyBTbmFwIGJhY2sgZm9yIHNhZmV0eQogICAgICAgIGVsc2UgewogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvLyBFbmQgYSBkcmFnIHdpdGggdGhlIGdpdmVuIGV2ZW50CiAgICAgIF9lbmREcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgICAgaWYodGhpcy5faXNEcmFnZ2luZykgewogICAgICAgICAgdGhpcy5zbmFwVG9SZXN0KGUpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9zdGFydFggPSBudWxsOwogICAgICAgIHRoaXMuX2xhc3RYID0gbnVsbDsKICAgICAgICB0aGlzLl9vZmZzZXRYID0gbnVsbDsKICAgICAgfSwKCiAgICAgIC8vIEhhbmRsZSBhIGRyYWcgZXZlbnQKICAgICAgX2hhbmRsZURyYWc6IGZ1bmN0aW9uKGUpIHsKCiAgICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSBzdGFydCBjb29yZHMsIGdyYWIgYW5kIHN0b3JlIHRoZW0KICAgICAgICBpZighdGhpcy5fc3RhcnRYKSB7CiAgICAgICAgICB0aGlzLl9zdGFydFggPSBlLmdlc3R1cmUudG91Y2hlc1swXS5wYWdlWDsKICAgICAgICAgIHRoaXMuX2xhc3RYID0gdGhpcy5fc3RhcnRYOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBHcmFiIHRoZSBjdXJyZW50IHRhcCBjb29yZHMKICAgICAgICAgIHRoaXMuX2xhc3RYID0gZS5nZXN0dXJlLnRvdWNoZXNbMF0ucGFnZVg7CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxjdWxhdGUgZGlmZmVyZW5jZSBmcm9tIHRoZSB0YXAgcG9pbnRzCiAgICAgICAgaWYoIXRoaXMuX2lzRHJhZ2dpbmcgJiYgTWF0aC5hYnModGhpcy5fbGFzdFggLSB0aGlzLl9zdGFydFgpID4gdGhpcy5kcmFnVGhyZXNob2xkWCkgewogICAgICAgICAgLy8gaWYgdGhlIGRpZmZlcmVuY2UgaXMgZ3JlYXRlciB0aGFuIHRocmVzaG9sZCwgc3RhcnQgZHJhZ2dpbmcgdXNpbmcgdGhlIGN1cnJlbnQKICAgICAgICAgIC8vIHBvaW50IGFzIHRoZSBzdGFydGluZyBwb2ludAogICAgICAgICAgdGhpcy5fc3RhcnRYID0gdGhpcy5fbGFzdFg7CgogICAgICAgICAgdGhpcy5faXNEcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAvLyBJbml0aWFsaXplIGRyYWdnaW5nCiAgICAgICAgICB0aGlzLmNvbnRlbnQuZGlzYWJsZUFuaW1hdGlvbigpOwogICAgICAgICAgdGhpcy5fb2Zmc2V0WCA9IHRoaXMuZ2V0T3BlbkFtb3VudCgpOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5faXNEcmFnZ2luZykgewogICAgICAgICAgdGhpcy5vcGVuQW1vdW50KHRoaXMuX29mZnNldFggKyAodGhpcy5fbGFzdFggLSB0aGlzLl9zdGFydFgpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICB9KShpb25pYyk7Cgp9KSgpOwovKiEKICogaW9uaWMuYnVuZGxlLmpzIGlzIGEgY29uY2F0ZW5hdGlvbiBvZjoKICogaW9uaWMuanMsIGFuZ3VsYXIuanMsIGFuZ3VsYXItYW5pbWF0ZS5qcywKICogYW5ndWxhci1zYW5pdGl6ZS5qcywgYW5ndWxhci11aS1yb3V0ZXIuanMsCiAqIGFuZCBpb25pYy1hbmd1bGFyLmpzCiAqLwoKLyoqCiAqIEBsaWNlbnNlIEFuZ3VsYXJKUyB2MS4yLjE3CiAqIChjKSAyMDEwLTIwMTQgR29vZ2xlLCBJbmMuIGh0dHA6Ly9hbmd1bGFyanMub3JnCiAqIExpY2Vuc2U6IE1JVAogKi8KKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCkgeyd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBUaGlzIG9iamVjdCBwcm92aWRlcyBhIHV0aWxpdHkgZm9yIHByb2R1Y2luZyByaWNoIEVycm9yIG1lc3NhZ2VzIHdpdGhpbgogICAqIEFuZ3VsYXIuIEl0IGNhbiBiZSBjYWxsZWQgYXMgZm9sbG93czoKICAgKgogICAqIHZhciBleGFtcGxlTWluRXJyID0gbWluRXJyKCdleGFtcGxlJyk7CiAgICogdGhyb3cgZXhhbXBsZU1pbkVycignb25lJywgJ1RoaXMgezB9IGlzIHsxfScsIGZvbywgYmFyKTsKICAgKgogICAqIFRoZSBhYm92ZSBjcmVhdGVzIGFuIGluc3RhbmNlIG9mIG1pbkVyciBpbiB0aGUgZXhhbXBsZSBuYW1lc3BhY2UuIFRoZQogICAqIHJlc3VsdGluZyBlcnJvciB3aWxsIGhhdmUgYSBuYW1lc3BhY2VkIGVycm9yIGNvZGUgb2YgZXhhbXBsZS5vbmUuICBUaGUKICAgKiByZXN1bHRpbmcgZXJyb3Igd2lsbCByZXBsYWNlIHswfSB3aXRoIHRoZSB2YWx1ZSBvZiBmb28sIGFuZCB7MX0gd2l0aCB0aGUKICAgKiB2YWx1ZSBvZiBiYXIuIFRoZSBvYmplY3QgaXMgbm90IHJlc3RyaWN0ZWQgaW4gdGhlIG51bWJlciBvZiBhcmd1bWVudHMgaXQgY2FuCiAgICogdGFrZS4KICAgKgogICAqIElmIGZld2VyIGFyZ3VtZW50cyBhcmUgc3BlY2lmaWVkIHRoYW4gbmVjZXNzYXJ5IGZvciBpbnRlcnBvbGF0aW9uLCB0aGUgZXh0cmEKICAgKiBpbnRlcnBvbGF0aW9uIG1hcmtlcnMgd2lsbCBiZSBwcmVzZXJ2ZWQgaW4gdGhlIGZpbmFsIHN0cmluZy4KICAgKgogICAqIFNpbmNlIGRhdGEgd2lsbCBiZSBwYXJzZWQgc3RhdGljYWxseSBkdXJpbmcgYSBidWlsZCBzdGVwLCBzb21lIHJlc3RyaWN0aW9ucwogICAqIGFyZSBhcHBsaWVkIHdpdGggcmVzcGVjdCB0byBob3cgbWluRXJyIGluc3RhbmNlcyBhcmUgY3JlYXRlZCBhbmQgY2FsbGVkLgogICAqIEluc3RhbmNlcyBzaG91bGQgaGF2ZSBuYW1lcyBvZiB0aGUgZm9ybSBuYW1lc3BhY2VNaW5FcnIgZm9yIGEgbWluRXJyIGNyZWF0ZWQKICAgKiB1c2luZyBtaW5FcnIoJ25hbWVzcGFjZScpIC4gRXJyb3IgY29kZXMsIG5hbWVzcGFjZXMgYW5kIHRlbXBsYXRlIHN0cmluZ3MKICAgKiBzaG91bGQgYWxsIGJlIHN0YXRpYyBzdHJpbmdzLCBub3QgdmFyaWFibGVzIG9yIGdlbmVyYWwgZXhwcmVzc2lvbnMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlIFRoZSBuYW1lc3BhY2UgdG8gdXNlIGZvciB0aGUgbmV3IG1pbkVyciBpbnN0YW5jZS4KICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29kZTpzdHJpbmcsIHRlbXBsYXRlOnN0cmluZywgLi4udGVtcGxhdGVBcmdzKTogRXJyb3J9IG1pbkVyciBpbnN0YW5jZQogICAqLwoKICBmdW5jdGlvbiBtaW5FcnIobW9kdWxlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICB2YXIgY29kZSA9IGFyZ3VtZW50c1swXSwKICAgICAgICBwcmVmaXggPSAnWycgKyAobW9kdWxlID8gbW9kdWxlICsgJzonIDogJycpICsgY29kZSArICddICcsCiAgICAgICAgdGVtcGxhdGUgPSBhcmd1bWVudHNbMV0sCiAgICAgICAgdGVtcGxhdGVBcmdzID0gYXJndW1lbnRzLAogICAgICAgIHN0cmluZ2lmeSA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgIGlmICh0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHJldHVybiBvYmoudG9TdHJpbmcoKS5yZXBsYWNlKC8gXHtbXHNcU10qJC8sICcnKTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuICd1bmRlZmluZWQnOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBvYmo7CiAgICAgICAgfSwKICAgICAgICBtZXNzYWdlLCBpOwoKICAgICAgbWVzc2FnZSA9IHByZWZpeCArIHRlbXBsYXRlLnJlcGxhY2UoL1x7XGQrXH0vZywgZnVuY3Rpb24gKG1hdGNoKSB7CiAgICAgICAgdmFyIGluZGV4ID0gK21hdGNoLnNsaWNlKDEsIC0xKSwgYXJnOwoKICAgICAgICBpZiAoaW5kZXggKyAyIDwgdGVtcGxhdGVBcmdzLmxlbmd0aCkgewogICAgICAgICAgYXJnID0gdGVtcGxhdGVBcmdzW2luZGV4ICsgMl07CiAgICAgICAgICBpZiAodHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICByZXR1cm4gYXJnLnRvU3RyaW5nKCkucmVwbGFjZSgvID9ce1tcc1xTXSokLywgJycpOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJnID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICByZXR1cm4gJ3VuZGVmaW5lZCc7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHJldHVybiB0b0pzb24oYXJnKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBhcmc7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgfSk7CgogICAgICBtZXNzYWdlID0gbWVzc2FnZSArICdcbmh0dHA6Ly9lcnJvcnMuYW5ndWxhcmpzLm9yZy8xLjIuMTcvJyArCiAgICAgICAgKG1vZHVsZSA/IG1vZHVsZSArICcvJyA6ICcnKSArIGNvZGU7CiAgICAgIGZvciAoaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBtZXNzYWdlID0gbWVzc2FnZSArIChpID09IDIgPyAnPycgOiAnJicpICsgJ3AnICsgKGktMikgKyAnPScgKwogICAgICAgICAgZW5jb2RlVVJJQ29tcG9uZW50KHN0cmluZ2lmeShhcmd1bWVudHNbaV0pKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG5ldyBFcnJvcihtZXNzYWdlKTsKICAgIH07CiAgfQoKICAvKiBXZSBuZWVkIHRvIHRlbGwganNoaW50IHdoYXQgdmFyaWFibGVzIGFyZSBiZWluZyBleHBvcnRlZCAqLwogIC8qIGdsb2JhbAogICAtYW5ndWxhciwKICAgLW1zaWUsCiAgIC1qcUxpdGUsCiAgIC1qUXVlcnksCiAgIC1zbGljZSwKICAgLXB1c2gsCiAgIC10b1N0cmluZywKICAgLW5nTWluRXJyLAogICAtYW5ndWxhck1vZHVsZSwKICAgLW5vZGVOYW1lXywKICAgLXVpZCwKCiAgIC1sb3dlcmNhc2UsCiAgIC11cHBlcmNhc2UsCiAgIC1tYW51YWxMb3dlcmNhc2UsCiAgIC1tYW51YWxVcHBlcmNhc2UsCiAgIC1ub2RlTmFtZV8sCiAgIC1pc0FycmF5TGlrZSwKICAgLWZvckVhY2gsCiAgIC1zb3J0ZWRLZXlzLAogICAtZm9yRWFjaFNvcnRlZCwKICAgLXJldmVyc2VQYXJhbXMsCiAgIC1uZXh0VWlkLAogICAtc2V0SGFzaEtleSwKICAgLWV4dGVuZCwKICAgLWludCwKICAgLWluaGVyaXQsCiAgIC1ub29wLAogICAtaWRlbnRpdHksCiAgIC12YWx1ZUZuLAogICAtaXNVbmRlZmluZWQsCiAgIC1pc0RlZmluZWQsCiAgIC1pc09iamVjdCwKICAgLWlzU3RyaW5nLAogICAtaXNOdW1iZXIsCiAgIC1pc0RhdGUsCiAgIC1pc0FycmF5LAogICAtaXNGdW5jdGlvbiwKICAgLWlzUmVnRXhwLAogICAtaXNXaW5kb3csCiAgIC1pc1Njb3BlLAogICAtaXNGaWxlLAogICAtaXNCbG9iLAogICAtaXNCb29sZWFuLAogICAtdHJpbSwKICAgLWlzRWxlbWVudCwKICAgLW1ha2VNYXAsCiAgIC1tYXAsCiAgIC1zaXplLAogICAtaW5jbHVkZXMsCiAgIC1pbmRleE9mLAogICAtYXJyYXlSZW1vdmUsCiAgIC1pc0xlYWZOb2RlLAogICAtY29weSwKICAgLXNoYWxsb3dDb3B5LAogICAtZXF1YWxzLAogICAtY3NwLAogICAtY29uY2F0LAogICAtc2xpY2VBcmdzLAogICAtYmluZCwKICAgLXRvSnNvblJlcGxhY2VyLAogICAtdG9Kc29uLAogICAtZnJvbUpzb24sCiAgIC10b0Jvb2xlYW4sCiAgIC1zdGFydGluZ1RhZywKICAgLXRyeURlY29kZVVSSUNvbXBvbmVudCwKICAgLXBhcnNlS2V5VmFsdWUsCiAgIC10b0tleVZhbHVlLAogICAtZW5jb2RlVXJpU2VnbWVudCwKICAgLWVuY29kZVVyaVF1ZXJ5LAogICAtYW5ndWxhckluaXQsCiAgIC1ib290c3RyYXAsCiAgIC1zbmFrZV9jYXNlLAogICAtYmluZEpRdWVyeSwKICAgLWFzc2VydEFyZywKICAgLWFzc2VydEFyZ0ZuLAogICAtYXNzZXJ0Tm90SGFzT3duUHJvcGVydHksCiAgIC1nZXR0ZXIsCiAgIC1nZXRCbG9ja0VsZW1lbnRzLAogICAtaGFzT3duUHJvcGVydHksCgogICAqLwoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogIC8qKgogICAqIEBuZ2RvYyBtb2R1bGUKICAgKiBAbmFtZSBuZwogICAqIEBtb2R1bGUgbmcKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqICMgbmcgKGNvcmUgbW9kdWxlKQogICAqIFRoZSBuZyBtb2R1bGUgaXMgbG9hZGVkIGJ5IGRlZmF1bHQgd2hlbiBhbiBBbmd1bGFySlMgYXBwbGljYXRpb24gaXMgc3RhcnRlZC4gVGhlIG1vZHVsZSBpdHNlbGYKICAgKiBjb250YWlucyB0aGUgZXNzZW50aWFsIGNvbXBvbmVudHMgZm9yIGFuIEFuZ3VsYXJKUyBhcHBsaWNhdGlvbiB0byBmdW5jdGlvbi4gVGhlIHRhYmxlIGJlbG93CiAgICogbGlzdHMgYSBoaWdoIGxldmVsIGJyZWFrZG93biBvZiBlYWNoIG9mIHRoZSBzZXJ2aWNlcy9mYWN0b3JpZXMsIGZpbHRlcnMsIGRpcmVjdGl2ZXMgYW5kIHRlc3RpbmcKICAgKiBjb21wb25lbnRzIGF2YWlsYWJsZSB3aXRoaW4gdGhpcyBjb3JlIG1vZHVsZS4KICAgKgogICAqIDxkaXYgZG9jLW1vZHVsZS1jb21wb25lbnRzPSJuZyI+PC9kaXY+CiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIubG93ZXJjYXNlCiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIHNwZWNpZmllZCBzdHJpbmcgdG8gbG93ZXJjYXNlLgogICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgU3RyaW5nIHRvIGJlIGNvbnZlcnRlZCB0byBsb3dlcmNhc2UuCiAgICogQHJldHVybnMge3N0cmluZ30gTG93ZXJjYXNlZCBzdHJpbmcuCiAgICovCiAgdmFyIGxvd2VyY2FzZSA9IGZ1bmN0aW9uKHN0cmluZyl7cmV0dXJuIGlzU3RyaW5nKHN0cmluZykgPyBzdHJpbmcudG9Mb3dlckNhc2UoKSA6IHN0cmluZzt9OwogIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIudXBwZXJjYXNlCiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24gQ29udmVydHMgdGhlIHNwZWNpZmllZCBzdHJpbmcgdG8gdXBwZXJjYXNlLgogICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgU3RyaW5nIHRvIGJlIGNvbnZlcnRlZCB0byB1cHBlcmNhc2UuCiAgICogQHJldHVybnMge3N0cmluZ30gVXBwZXJjYXNlZCBzdHJpbmcuCiAgICovCiAgdmFyIHVwcGVyY2FzZSA9IGZ1bmN0aW9uKHN0cmluZyl7cmV0dXJuIGlzU3RyaW5nKHN0cmluZykgPyBzdHJpbmcudG9VcHBlckNhc2UoKSA6IHN0cmluZzt9OwoKCiAgdmFyIG1hbnVhbExvd2VyY2FzZSA9IGZ1bmN0aW9uKHMpIHsKICAgIC8qIGpzaGludCBiaXR3aXNlOiBmYWxzZSAqLwogICAgcmV0dXJuIGlzU3RyaW5nKHMpCiAgICAgID8gcy5yZXBsYWNlKC9bQS1aXS9nLCBmdW5jdGlvbihjaCkge3JldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgfCAzMik7fSkKICAgICAgOiBzOwogIH07CiAgdmFyIG1hbnVhbFVwcGVyY2FzZSA9IGZ1bmN0aW9uKHMpIHsKICAgIC8qIGpzaGludCBiaXR3aXNlOiBmYWxzZSAqLwogICAgcmV0dXJuIGlzU3RyaW5nKHMpCiAgICAgID8gcy5yZXBsYWNlKC9bYS16XS9nLCBmdW5jdGlvbihjaCkge3JldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoLmNoYXJDb2RlQXQoMCkgJiB+MzIpO30pCiAgICAgIDogczsKICB9OwoKCi8vIFN0cmluZyN0b0xvd2VyQ2FzZSBhbmQgU3RyaW5nI3RvVXBwZXJDYXNlIGRvbid0IHByb2R1Y2UgY29ycmVjdCByZXN1bHRzIGluIGJyb3dzZXJzIHdpdGggVHVya2lzaAovLyBsb2NhbGUsIGZvciB0aGlzIHJlYXNvbiB3ZSBuZWVkIHRvIGRldGVjdCB0aGlzIGNhc2UgYW5kIHJlZGVmaW5lIGxvd2VyY2FzZS91cHBlcmNhc2UgbWV0aG9kcwovLyB3aXRoIGNvcnJlY3QgYnV0IHNsb3dlciBhbHRlcm5hdGl2ZXMuCiAgaWYgKCdpJyAhPT0gJ0knLnRvTG93ZXJDYXNlKCkpIHsKICAgIGxvd2VyY2FzZSA9IG1hbnVhbExvd2VyY2FzZTsKICAgIHVwcGVyY2FzZSA9IG1hbnVhbFVwcGVyY2FzZTsKICB9CgoKICB2YXIgLyoqIGhvbGRzIG1ham9yIHZlcnNpb24gbnVtYmVyIGZvciBJRSBvciBOYU4gZm9yIHJlYWwgYnJvd3NlcnMgKi8KICAgIG1zaWUsCiAgICBqcUxpdGUsICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nIHNpbmNlIGpRdWVyeSBjb3VsZCBiZSBsb2FkZWQgYWZ0ZXIgdXMuCiAgICBqUXVlcnksICAgICAgICAgICAvLyBkZWxheSBiaW5kaW5nCiAgICBzbGljZSAgICAgICAgICAgICA9IFtdLnNsaWNlLAogICAgcHVzaCAgICAgICAgICAgICAgPSBbXS5wdXNoLAogICAgdG9TdHJpbmcgICAgICAgICAgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAogICAgbmdNaW5FcnIgICAgICAgICAgPSBtaW5FcnIoJ25nJyksCgogICAgLyoqIEBuYW1lIGFuZ3VsYXIgKi8KICAgIGFuZ3VsYXIgICAgICAgICAgID0gd2luZG93LmFuZ3VsYXIgfHwgKHdpbmRvdy5hbmd1bGFyID0ge30pLAogICAgYW5ndWxhck1vZHVsZSwKICAgIG5vZGVOYW1lXywKICAgIHVpZCAgICAgICAgICAgICAgID0gWycwJywgJzAnLCAnMCddOwoKICAvKioKICAgKiBJRSAxMSBjaGFuZ2VkIHRoZSBmb3JtYXQgb2YgdGhlIFVzZXJBZ2VudCBzdHJpbmcuCiAgICogU2VlIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9tczUzNzUwMy5hc3B4CiAgICovCiAgbXNpZSA9IGludCgoL21zaWUgKFxkKykvLmV4ZWMobG93ZXJjYXNlKG5hdmlnYXRvci51c2VyQWdlbnQpKSB8fCBbXSlbMV0pOwogIGlmIChpc05hTihtc2llKSkgewogICAgbXNpZSA9IGludCgoL3RyaWRlbnRcLy4qOyBydjooXGQrKS8uZXhlYyhsb3dlcmNhc2UobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSk7CiAgfQoKCiAgLyoqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0geyp9IG9iagogICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBgb2JqYCBpcyBhbiBhcnJheSBvciBhcnJheS1saWtlIG9iamVjdCAoTm9kZUxpc3QsIEFyZ3VtZW50cywKICAgKiAgICAgICAgICAgICAgICAgICBTdHJpbmcgLi4uKQogICAqLwogIGZ1bmN0aW9uIGlzQXJyYXlMaWtlKG9iaikgewogICAgaWYgKG9iaiA9PSBudWxsIHx8IGlzV2luZG93KG9iaikpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHZhciBsZW5ndGggPSBvYmoubGVuZ3RoOwoKICAgIGlmIChvYmoubm9kZVR5cGUgPT09IDEgJiYgbGVuZ3RoKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHJldHVybiBpc1N0cmluZyhvYmopIHx8IGlzQXJyYXkob2JqKSB8fCBsZW5ndGggPT09IDAgfHwKICAgICAgdHlwZW9mIGxlbmd0aCA9PT0gJ251bWJlcicgJiYgbGVuZ3RoID4gMCAmJiAobGVuZ3RoIC0gMSkgaW4gb2JqOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5mb3JFYWNoCiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBJbnZva2VzIHRoZSBgaXRlcmF0b3JgIGZ1bmN0aW9uIG9uY2UgZm9yIGVhY2ggaXRlbSBpbiBgb2JqYCBjb2xsZWN0aW9uLCB3aGljaCBjYW4gYmUgZWl0aGVyIGFuCiAgICogb2JqZWN0IG9yIGFuIGFycmF5LiBUaGUgYGl0ZXJhdG9yYCBmdW5jdGlvbiBpcyBpbnZva2VkIHdpdGggYGl0ZXJhdG9yKHZhbHVlLCBrZXkpYCwgd2hlcmUgYHZhbHVlYAogICAqIGlzIHRoZSB2YWx1ZSBvZiBhbiBvYmplY3QgcHJvcGVydHkgb3IgYW4gYXJyYXkgZWxlbWVudCBhbmQgYGtleWAgaXMgdGhlIG9iamVjdCBwcm9wZXJ0eSBrZXkgb3IKICAgKiBhcnJheSBlbGVtZW50IGluZGV4LiBTcGVjaWZ5aW5nIGEgYGNvbnRleHRgIGZvciB0aGUgZnVuY3Rpb24gaXMgb3B0aW9uYWwuCiAgICoKICAgKiBJdCBpcyB3b3J0aCBub3RpbmcgdGhhdCBgLmZvckVhY2hgIGRvZXMgbm90IGl0ZXJhdGUgb3ZlciBpbmhlcml0ZWQgcHJvcGVydGllcyBiZWNhdXNlIGl0IGZpbHRlcnMKICAgKiB1c2luZyB0aGUgYGhhc093blByb3BlcnR5YCBtZXRob2QuCiAgICoKICAgYGBganMKICAgdmFyIHZhbHVlcyA9IHtuYW1lOiAnbWlza28nLCBnZW5kZXI6ICdtYWxlJ307CiAgIHZhciBsb2cgPSBbXTsKICAgYW5ndWxhci5mb3JFYWNoKHZhbHVlcywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgdGhpcy5wdXNoKGtleSArICc6ICcgKyB2YWx1ZSk7CiAgICAgfSwgbG9nKTsKICAgZXhwZWN0KGxvZykudG9FcXVhbChbJ25hbWU6IG1pc2tvJywgJ2dlbmRlcjogbWFsZSddKTsKICAgYGBgCiAgICoKICAgKiBAcGFyYW0ge09iamVjdHxBcnJheX0gb2JqIE9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gaXRlcmF0b3IgSXRlcmF0b3IgZnVuY3Rpb24uCiAgICogQHBhcmFtIHtPYmplY3Q9fSBjb250ZXh0IE9iamVjdCB0byBiZWNvbWUgY29udGV4dCAoYHRoaXNgKSBmb3IgdGhlIGl0ZXJhdG9yIGZ1bmN0aW9uLgogICAqIEByZXR1cm5zIHtPYmplY3R8QXJyYXl9IFJlZmVyZW5jZSB0byBgb2JqYC4KICAgKi8KICBmdW5jdGlvbiBmb3JFYWNoKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciBrZXk7CiAgICBpZiAob2JqKSB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKG9iaikpIHsKICAgICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICAgIC8vIE5lZWQgdG8gY2hlY2sgaWYgaGFzT3duUHJvcGVydHkgZXhpc3RzLAogICAgICAgICAgLy8gYXMgb24gSUU4IHRoZSByZXN1bHQgb2YgcXVlcnlTZWxlY3RvckFsbCBpcyBhbiBvYmplY3Qgd2l0aG91dCBhIGhhc093blByb3BlcnR5IGZ1bmN0aW9uCiAgICAgICAgICBpZiAoa2V5ICE9ICdwcm90b3R5cGUnICYmIGtleSAhPSAnbGVuZ3RoJyAmJiBrZXkgIT0gJ25hbWUnICYmICghb2JqLmhhc093blByb3BlcnR5IHx8IG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSkgewogICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChvYmouZm9yRWFjaCAmJiBvYmouZm9yRWFjaCAhPT0gZm9yRWFjaCkgewogICAgICAgIG9iai5mb3JFYWNoKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgICAgfSBlbHNlIGlmIChpc0FycmF5TGlrZShvYmopKSB7CiAgICAgICAgZm9yIChrZXkgPSAwOyBrZXkgPCBvYmoubGVuZ3RoOyBrZXkrKykKICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChrZXkgaW4gb2JqKSB7CiAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvYmo7CiAgfQoKICBmdW5jdGlvbiBzb3J0ZWRLZXlzKG9iaikgewogICAgdmFyIGtleXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBrZXlzLnNvcnQoKTsKICB9CgogIGZ1bmN0aW9uIGZvckVhY2hTb3J0ZWQob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIGtleXMgPSBzb3J0ZWRLZXlzKG9iaik7CiAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleXNbaV1dLCBrZXlzW2ldKTsKICAgIH0KICAgIHJldHVybiBrZXlzOwogIH0KCgogIC8qKgogICAqIHdoZW4gdXNpbmcgZm9yRWFjaCB0aGUgcGFyYW1zIGFyZSB2YWx1ZSwga2V5LCBidXQgaXQgaXMgb2Z0ZW4gdXNlZnVsIHRvIGhhdmUga2V5LCB2YWx1ZS4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZywgKil9IGl0ZXJhdG9yRm4KICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKiwgc3RyaW5nKX0KICAgKi8KICBmdW5jdGlvbiByZXZlcnNlUGFyYW1zKGl0ZXJhdG9yRm4pIHsKICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSwga2V5KSB7IGl0ZXJhdG9yRm4oa2V5LCB2YWx1ZSk7IH07CiAgfQoKICAvKioKICAgKiBBIGNvbnNpc3RlbnQgd2F5IG9mIGNyZWF0aW5nIHVuaXF1ZSBJRHMgaW4gYW5ndWxhci4gVGhlIElEIGlzIGEgc2VxdWVuY2Ugb2YgYWxwaGEgbnVtZXJpYwogICAqIGNoYXJhY3RlcnMgc3VjaCBhcyAnMDEyQUJDJy4gVGhlIHJlYXNvbiB3aHkgd2UgYXJlIG5vdCB1c2luZyBzaW1wbHkgYSBudW1iZXIgY291bnRlciBpcyB0aGF0CiAgICogdGhlIG51bWJlciBzdHJpbmcgZ2V0cyBsb25nZXIgb3ZlciB0aW1lLCBhbmQgaXQgY2FuIGFsc28gb3ZlcmZsb3csIHdoZXJlIGFzIHRoZSBuZXh0SWQKICAgKiB3aWxsIGdyb3cgbXVjaCBzbG93ZXIsIGl0IGlzIGEgc3RyaW5nLCBhbmQgaXQgd2lsbCBuZXZlciBvdmVyZmxvdy4KICAgKgogICAqIEByZXR1cm5zIHtzdHJpbmd9IGFuIHVuaXF1ZSBhbHBoYS1udW1lcmljIHN0cmluZwogICAqLwogIGZ1bmN0aW9uIG5leHRVaWQoKSB7CiAgICB2YXIgaW5kZXggPSB1aWQubGVuZ3RoOwogICAgdmFyIGRpZ2l0OwoKICAgIHdoaWxlKGluZGV4KSB7CiAgICAgIGluZGV4LS07CiAgICAgIGRpZ2l0ID0gdWlkW2luZGV4XS5jaGFyQ29kZUF0KDApOwogICAgICBpZiAoZGlnaXQgPT0gNTcgLyonOScqLykgewogICAgICAgIHVpZFtpbmRleF0gPSAnQSc7CiAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgfQogICAgICBpZiAoZGlnaXQgPT0gOTAgIC8qJ1onKi8pIHsKICAgICAgICB1aWRbaW5kZXhdID0gJzAnOwogICAgICB9IGVsc2UgewogICAgICAgIHVpZFtpbmRleF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGRpZ2l0ICsgMSk7CiAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgfQogICAgfQogICAgdWlkLnVuc2hpZnQoJzAnKTsKICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgfQoKCiAgLyoqCiAgICogU2V0IG9yIGNsZWFyIHRoZSBoYXNoa2V5IGZvciBhbiBvYmplY3QuCiAgICogQHBhcmFtIG9iaiBvYmplY3QKICAgKiBAcGFyYW0gaCB0aGUgaGFzaGtleSAoIXRydXRoeSB0byBkZWxldGUgdGhlIGhhc2hrZXkpCiAgICovCiAgZnVuY3Rpb24gc2V0SGFzaEtleShvYmosIGgpIHsKICAgIGlmIChoKSB7CiAgICAgIG9iai4kJGhhc2hLZXkgPSBoOwogICAgfQogICAgZWxzZSB7CiAgICAgIGRlbGV0ZSBvYmouJCRoYXNoS2V5OwogICAgfQogIH0KCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5leHRlbmQKICAgKiBAbW9kdWxlIG5nCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEV4dGVuZHMgdGhlIGRlc3RpbmF0aW9uIG9iamVjdCBgZHN0YCBieSBjb3B5aW5nIGFsbCBvZiB0aGUgcHJvcGVydGllcyBmcm9tIHRoZSBgc3JjYCBvYmplY3QocykKICAgKiB0byBgZHN0YC4gWW91IGNhbiBzcGVjaWZ5IG11bHRpcGxlIGBzcmNgIG9iamVjdHMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZHN0IERlc3RpbmF0aW9uIG9iamVjdC4KICAgKiBAcGFyYW0gey4uLk9iamVjdH0gc3JjIFNvdXJjZSBvYmplY3QocykuCiAgICogQHJldHVybnMge09iamVjdH0gUmVmZXJlbmNlIHRvIGBkc3RgLgogICAqLwogIGZ1bmN0aW9uIGV4dGVuZChkc3QpIHsKICAgIHZhciBoID0gZHN0LiQkaGFzaEtleTsKICAgIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iaiAhPT0gZHN0KSB7CiAgICAgICAgZm9yRWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICAgIGRzdFtrZXldID0gdmFsdWU7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIHNldEhhc2hLZXkoZHN0LGgpOwogICAgcmV0dXJuIGRzdDsKICB9CgogIGZ1bmN0aW9uIGludChzdHIpIHsKICAgIHJldHVybiBwYXJzZUludChzdHIsIDEwKTsKICB9CgoKICBmdW5jdGlvbiBpbmhlcml0KHBhcmVudCwgZXh0cmEpIHsKICAgIHJldHVybiBleHRlbmQobmV3IChleHRlbmQoZnVuY3Rpb24oKSB7fSwge3Byb3RvdHlwZTpwYXJlbnR9KSkoKSwgZXh0cmEpOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5ub29wCiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBIGZ1bmN0aW9uIHRoYXQgcGVyZm9ybXMgbm8gb3BlcmF0aW9ucy4gVGhpcyBmdW5jdGlvbiBjYW4gYmUgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlIGluIHRoZQogICAqIGZ1bmN0aW9uYWwgc3R5bGUuCiAgIGBgYGpzCiAgIGZ1bmN0aW9uIGZvbyhjYWxsYmFjaykgewogICAgICAgdmFyIHJlc3VsdCA9IGNhbGN1bGF0ZVJlc3VsdCgpOwogICAgICAgKGNhbGxiYWNrIHx8IGFuZ3VsYXIubm9vcCkocmVzdWx0KTsKICAgICB9CiAgIGBgYAogICAqLwogIGZ1bmN0aW9uIG5vb3AoKSB7fQogIG5vb3AuJGluamVjdCA9IFtdOwoKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5pZGVudGl0eQogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQSBmdW5jdGlvbiB0aGF0IHJldHVybnMgaXRzIGZpcnN0IGFyZ3VtZW50LiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWZ1bCB3aGVuIHdyaXRpbmcgY29kZSBpbiB0aGUKICAgKiBmdW5jdGlvbmFsIHN0eWxlLgogICAqCiAgIGBgYGpzCiAgIGZ1bmN0aW9uIHRyYW5zZm9ybWVyKHRyYW5zZm9ybWF0aW9uRm4sIHZhbHVlKSB7CiAgICAgICByZXR1cm4gKHRyYW5zZm9ybWF0aW9uRm4gfHwgYW5ndWxhci5pZGVudGl0eSkodmFsdWUpOwogICAgIH07CiAgIGBgYAogICAqLwogIGZ1bmN0aW9uIGlkZW50aXR5KCQpIHtyZXR1cm4gJDt9CiAgaWRlbnRpdHkuJGluamVjdCA9IFtdOwoKCiAgZnVuY3Rpb24gdmFsdWVGbih2YWx1ZSkge3JldHVybiBmdW5jdGlvbigpIHtyZXR1cm4gdmFsdWU7fTt9CgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuaXNVbmRlZmluZWQKICAgKiBAbW9kdWxlIG5nCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgdW5kZWZpbmVkLgogICAqCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyB1bmRlZmluZWQuCiAgICovCiAgZnVuY3Rpb24gaXNVbmRlZmluZWQodmFsdWUpe3JldHVybiB0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnO30KCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuaXNEZWZpbmVkCiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGRlZmluZWQuCiAgICoKICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGRlZmluZWQuCiAgICovCiAgZnVuY3Rpb24gaXNEZWZpbmVkKHZhbHVlKXtyZXR1cm4gdHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJzt9CgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLmlzT2JqZWN0CiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGFuIGBPYmplY3RgLiBVbmxpa2UgYHR5cGVvZmAgaW4gSmF2YVNjcmlwdCwgYG51bGxgcyBhcmUgbm90CiAgICogY29uc2lkZXJlZCB0byBiZSBvYmplY3RzLiBOb3RlIHRoYXQgSmF2YVNjcmlwdCBhcnJheXMgYXJlIG9iamVjdHMuCiAgICoKICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGBPYmplY3RgIGJ1dCBub3QgYG51bGxgLgogICAqLwogIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKXtyZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnO30KCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuaXNTdHJpbmcKICAgKiBAbW9kdWxlIG5nCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBgU3RyaW5nYC4KICAgKgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgU3RyaW5nYC4KICAgKi8KICBmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZyc7fQoKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5pc051bWJlcgogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBOdW1iZXJgLgogICAqCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBOdW1iZXJgLgogICAqLwogIGZ1bmN0aW9uIGlzTnVtYmVyKHZhbHVlKXtyZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJzt9CgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLmlzRGF0ZQogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGV0ZXJtaW5lcyBpZiBhIHZhbHVlIGlzIGEgZGF0ZS4KICAgKgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRGF0ZWAuCiAgICovCiAgZnVuY3Rpb24gaXNEYXRlKHZhbHVlKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IERhdGVdJzsKICB9CgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLmlzQXJyYXkKICAgKiBAbW9kdWxlIG5nCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYEFycmF5YC4KICAgKgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYW4gYEFycmF5YC4KICAgKi8KICBmdW5jdGlvbiBpc0FycmF5KHZhbHVlKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfQoKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5pc0Z1bmN0aW9uCiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYEZ1bmN0aW9uYC4KICAgKgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBgRnVuY3Rpb25gLgogICAqLwogIGZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsdWUpe3JldHVybiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbic7fQoKCiAgLyoqCiAgICogRGV0ZXJtaW5lcyBpZiBhIHZhbHVlIGlzIGEgcmVndWxhciBleHByZXNzaW9uIG9iamVjdC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBSZWdFeHBgLgogICAqLwogIGZ1bmN0aW9uIGlzUmVnRXhwKHZhbHVlKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IFJlZ0V4cF0nOwogIH0KCgogIC8qKgogICAqIENoZWNrcyBpZiBgb2JqYCBpcyBhIHdpbmRvdyBvYmplY3QuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7Kn0gb2JqIE9iamVjdCB0byBjaGVjawogICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGBvYmpgIGlzIGEgd2luZG93IG9iai4KICAgKi8KICBmdW5jdGlvbiBpc1dpbmRvdyhvYmopIHsKICAgIHJldHVybiBvYmogJiYgb2JqLmRvY3VtZW50ICYmIG9iai5sb2NhdGlvbiAmJiBvYmouYWxlcnQgJiYgb2JqLnNldEludGVydmFsOwogIH0KCgogIGZ1bmN0aW9uIGlzU2NvcGUob2JqKSB7CiAgICByZXR1cm4gb2JqICYmIG9iai4kZXZhbEFzeW5jICYmIG9iai4kd2F0Y2g7CiAgfQoKCiAgZnVuY3Rpb24gaXNGaWxlKG9iaikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgRmlsZV0nOwogIH0KCgogIGZ1bmN0aW9uIGlzQmxvYihvYmopIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IEJsb2JdJzsKICB9CgoKICBmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJzsKICB9CgoKICB2YXIgdHJpbSA9IChmdW5jdGlvbigpIHsKICAgIC8vIG5hdGl2ZSB0cmltIGlzIHdheSBmYXN0ZXI6IGh0dHA6Ly9qc3BlcmYuY29tL2FuZ3VsYXItdHJpbS10ZXN0CiAgICAvLyBidXQgSUUgZG9lc24ndCBoYXZlIGl0Li4uIDotKAogICAgLy8gVE9ETzogd2Ugc2hvdWxkIG1vdmUgdGhpcyBpbnRvIElFL0VTNSBwb2x5ZmlsbAogICAgaWYgKCFTdHJpbmcucHJvdG90eXBlLnRyaW0pIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGlzU3RyaW5nKHZhbHVlKSA/IHZhbHVlLnJlcGxhY2UoL15cc1xzKi8sICcnKS5yZXBsYWNlKC9cc1xzKiQvLCAnJykgOiB2YWx1ZTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gaXNTdHJpbmcodmFsdWUpID8gdmFsdWUudHJpbSgpIDogdmFsdWU7CiAgICB9OwogIH0pKCk7CgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLmlzRWxlbWVudAogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIERPTSBlbGVtZW50IChvciB3cmFwcGVkIGpRdWVyeSBlbGVtZW50KS4KICAgKgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudCAob3Igd3JhcHBlZCBqUXVlcnkgZWxlbWVudCkuCiAgICovCiAgZnVuY3Rpb24gaXNFbGVtZW50KG5vZGUpIHsKICAgIHJldHVybiAhIShub2RlICYmCiAgICAgIChub2RlLm5vZGVOYW1lICAvLyB3ZSBhcmUgYSBkaXJlY3QgZWxlbWVudAogICAgICAgIHx8IChub2RlLnByb3AgJiYgbm9kZS5hdHRyICYmIG5vZGUuZmluZCkpKTsgIC8vIHdlIGhhdmUgYW4gb24gYW5kIGZpbmQgbWV0aG9kIHBhcnQgb2YgalF1ZXJ5IEFQSQogIH0KCiAgLyoqCiAgICogQHBhcmFtIHN0ciAna2V5MSxrZXkyLC4uLicKICAgKiBAcmV0dXJucyB7b2JqZWN0fSBpbiB0aGUgZm9ybSBvZiB7a2V5MTp0cnVlLCBrZXkyOnRydWUsIC4uLn0KICAgKi8KICBmdW5jdGlvbiBtYWtlTWFwKHN0cikgewogICAgdmFyIG9iaiA9IHt9LCBpdGVtcyA9IHN0ci5zcGxpdCgiLCIpLCBpOwogICAgZm9yICggaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKyApCiAgICAgIG9ialsgaXRlbXNbaV0gXSA9IHRydWU7CiAgICByZXR1cm4gb2JqOwogIH0KCgogIGlmIChtc2llIDwgOSkgewogICAgbm9kZU5hbWVfID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICBlbGVtZW50ID0gZWxlbWVudC5ub2RlTmFtZSA/IGVsZW1lbnQgOiBlbGVtZW50WzBdOwogICAgICByZXR1cm4gKGVsZW1lbnQuc2NvcGVOYW1lICYmIGVsZW1lbnQuc2NvcGVOYW1lICE9ICdIVE1MJykKICAgICAgICA/IHVwcGVyY2FzZShlbGVtZW50LnNjb3BlTmFtZSArICc6JyArIGVsZW1lbnQubm9kZU5hbWUpIDogZWxlbWVudC5ub2RlTmFtZTsKICAgIH07CiAgfSBlbHNlIHsKICAgIG5vZGVOYW1lXyA9IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQubm9kZU5hbWUgPyBlbGVtZW50Lm5vZGVOYW1lIDogZWxlbWVudFswXS5ub2RlTmFtZTsKICAgIH07CiAgfQoKCiAgZnVuY3Rpb24gbWFwKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJlc3VsdHMucHVzaChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9CgoKICAvKioKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZXRlcm1pbmVzIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gYXJyYXksIHRoZSBudW1iZXIgb2YgcHJvcGVydGllcyBhbiBvYmplY3QgaGFzLCBvcgogICAqIHRoZSBsZW5ndGggb2YgYSBzdHJpbmcuCiAgICoKICAgKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgdG8gYXVnbWVudCB0aGUgT2JqZWN0IHR5cGUgaW4gQW5ndWxhciBleHByZXNzaW9ucy4gU2VlCiAgICoge0BsaW5rIGFuZ3VsYXIuT2JqZWN0fSBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBBbmd1bGFyIGFycmF5cy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fHN0cmluZ30gb2JqIE9iamVjdCwgYXJyYXksIG9yIHN0cmluZyB0byBpbnNwZWN0LgogICAqIEBwYXJhbSB7Ym9vbGVhbn0gW293blByb3BzT25seT1mYWxzZV0gQ291bnQgb25seSAib3duIiBwcm9wZXJ0aWVzIGluIGFuIG9iamVjdAogICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBzaXplIG9mIGBvYmpgIG9yIGAwYCBpZiBgb2JqYCBpcyBuZWl0aGVyIGFuIG9iamVjdCBub3IgYW4gYXJyYXkuCiAgICovCiAgZnVuY3Rpb24gc2l6ZShvYmosIG93blByb3BzT25seSkgewogICAgdmFyIGNvdW50ID0gMCwga2V5OwoKICAgIGlmIChpc0FycmF5KG9iaikgfHwgaXNTdHJpbmcob2JqKSkgewogICAgICByZXR1cm4gb2JqLmxlbmd0aDsKICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob2JqKSkgewogICAgICBmb3IgKGtleSBpbiBvYmopCiAgICAgICAgaWYgKCFvd25Qcm9wc09ubHkgfHwgb2JqLmhhc093blByb3BlcnR5KGtleSkpCiAgICAgICAgICBjb3VudCsrOwogICAgfQoKICAgIHJldHVybiBjb3VudDsKICB9CgoKICBmdW5jdGlvbiBpbmNsdWRlcyhhcnJheSwgb2JqKSB7CiAgICByZXR1cm4gaW5kZXhPZihhcnJheSwgb2JqKSAhPSAtMTsKICB9CgogIGZ1bmN0aW9uIGluZGV4T2YoYXJyYXksIG9iaikgewogICAgaWYgKGFycmF5LmluZGV4T2YpIHJldHVybiBhcnJheS5pbmRleE9mKG9iaik7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgICBpZiAob2JqID09PSBhcnJheVtpXSkgcmV0dXJuIGk7CiAgICB9CiAgICByZXR1cm4gLTE7CiAgfQoKICBmdW5jdGlvbiBhcnJheVJlbW92ZShhcnJheSwgdmFsdWUpIHsKICAgIHZhciBpbmRleCA9IGluZGV4T2YoYXJyYXksIHZhbHVlKTsKICAgIGlmIChpbmRleCA+PTApCiAgICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7CiAgICByZXR1cm4gdmFsdWU7CiAgfQoKICBmdW5jdGlvbiBpc0xlYWZOb2RlIChub2RlKSB7CiAgICBpZiAobm9kZSkgewogICAgICBzd2l0Y2ggKG5vZGUubm9kZU5hbWUpIHsKICAgICAgICBjYXNlICJPUFRJT04iOgogICAgICAgIGNhc2UgIlBSRSI6CiAgICAgICAgY2FzZSAiVElUTEUiOgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuY29weQogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ3JlYXRlcyBhIGRlZXAgY29weSBvZiBgc291cmNlYCwgd2hpY2ggc2hvdWxkIGJlIGFuIG9iamVjdCBvciBhbiBhcnJheS4KICAgKgogICAqICogSWYgbm8gZGVzdGluYXRpb24gaXMgc3VwcGxpZWQsIGEgY29weSBvZiB0aGUgb2JqZWN0IG9yIGFycmF5IGlzIGNyZWF0ZWQuCiAgICogKiBJZiBhIGRlc3RpbmF0aW9uIGlzIHByb3ZpZGVkLCBhbGwgb2YgaXRzIGVsZW1lbnRzIChmb3IgYXJyYXkpIG9yIHByb3BlcnRpZXMgKGZvciBvYmplY3RzKQogICAqICAgYXJlIGRlbGV0ZWQgYW5kIHRoZW4gYWxsIGVsZW1lbnRzL3Byb3BlcnRpZXMgZnJvbSB0aGUgc291cmNlIGFyZSBjb3BpZWQgdG8gaXQuCiAgICogKiBJZiBgc291cmNlYCBpcyBub3QgYW4gb2JqZWN0IG9yIGFycmF5IChpbmMuIGBudWxsYCBhbmQgYHVuZGVmaW5lZGApLCBgc291cmNlYCBpcyByZXR1cm5lZC4KICAgKiAqIElmIGBzb3VyY2VgIGlzIGlkZW50aWNhbCB0byAnZGVzdGluYXRpb24nIGFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93bi4KICAgKgogICAqIEBwYXJhbSB7Kn0gc291cmNlIFRoZSBzb3VyY2UgdGhhdCB3aWxsIGJlIHVzZWQgdG8gbWFrZSBhIGNvcHkuCiAgICogICAgICAgICAgICAgICAgICAgQ2FuIGJlIGFueSB0eXBlLCBpbmNsdWRpbmcgcHJpbWl0aXZlcywgYG51bGxgLCBhbmQgYHVuZGVmaW5lZGAuCiAgICogQHBhcmFtIHsoT2JqZWN0fEFycmF5KT19IGRlc3RpbmF0aW9uIERlc3RpbmF0aW9uIGludG8gd2hpY2ggdGhlIHNvdXJjZSBpcyBjb3BpZWQuIElmCiAgICogICAgIHByb3ZpZGVkLCBtdXN0IGJlIG9mIHRoZSBzYW1lIHR5cGUgYXMgYHNvdXJjZWAuCiAgICogQHJldHVybnMgeyp9IFRoZSBjb3B5IG9yIHVwZGF0ZWQgYGRlc3RpbmF0aW9uYCwgaWYgYGRlc3RpbmF0aW9uYCB3YXMgc3BlY2lmaWVkLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkNvbnRyb2xsZXIiPgogICA8Zm9ybSBub3ZhbGlkYXRlIGNsYXNzPSJzaW1wbGUtZm9ybSI+CiAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idXNlci5uYW1lIiAvPjxiciAvPgogICBFLW1haWw6IDxpbnB1dCB0eXBlPSJlbWFpbCIgbmctbW9kZWw9InVzZXIuZW1haWwiIC8+PGJyIC8+CiAgIEdlbmRlcjogPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0idXNlci5nZW5kZXIiIHZhbHVlPSJtYWxlIiAvPm1hbGUKICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0idXNlci5nZW5kZXIiIHZhbHVlPSJmZW1hbGUiIC8+ZmVtYWxlPGJyIC8+CiAgIDxidXR0b24gbmctY2xpY2s9InJlc2V0KCkiPlJFU0VUPC9idXR0b24+CiAgIDxidXR0b24gbmctY2xpY2s9InVwZGF0ZSh1c2VyKSI+U0FWRTwvYnV0dG9uPgogICA8L2Zvcm0+CiAgIDxwcmU+Zm9ybSA9IHt7dXNlciB8IGpzb259fTwvcHJlPgogICA8cHJlPm1hc3RlciA9IHt7bWFzdGVyIHwganNvbn19PC9wcmU+CiAgIDwvZGl2PgoKICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ29udHJvbGxlcigkc2NvcGUpIHsKICAgICRzY29wZS5tYXN0ZXI9IHt9OwoKICAgICRzY29wZS51cGRhdGUgPSBmdW5jdGlvbih1c2VyKSB7CiAgICAgIC8vIEV4YW1wbGUgd2l0aCAxIGFyZ3VtZW50CiAgICAgICRzY29wZS5tYXN0ZXI9IGFuZ3VsYXIuY29weSh1c2VyKTsKICAgIH07CgogICAgJHNjb3BlLnJlc2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIC8vIEV4YW1wbGUgd2l0aCAyIGFyZ3VtZW50cwogICAgICBhbmd1bGFyLmNvcHkoJHNjb3BlLm1hc3RlciwgJHNjb3BlLnVzZXIpOwogICAgfTsKCiAgICAkc2NvcGUucmVzZXQoKTsKICB9CiAgIDwvc2NyaXB0PgogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICBmdW5jdGlvbiBjb3B5KHNvdXJjZSwgZGVzdGluYXRpb24sIHN0YWNrU291cmNlLCBzdGFja0Rlc3QpIHsKICAgIGlmIChpc1dpbmRvdyhzb3VyY2UpIHx8IGlzU2NvcGUoc291cmNlKSkgewogICAgICB0aHJvdyBuZ01pbkVycignY3B3cycsCiAgICAgICAgIkNhbid0IGNvcHkhIE1ha2luZyBjb3BpZXMgb2YgV2luZG93IG9yIFNjb3BlIGluc3RhbmNlcyBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgfQoKICAgIGlmICghZGVzdGluYXRpb24pIHsKICAgICAgZGVzdGluYXRpb24gPSBzb3VyY2U7CiAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICBpZiAoaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgICBkZXN0aW5hdGlvbiA9IGNvcHkoc291cmNlLCBbXSwgc3RhY2tTb3VyY2UsIHN0YWNrRGVzdCk7CiAgICAgICAgfSBlbHNlIGlmIChpc0RhdGUoc291cmNlKSkgewogICAgICAgICAgZGVzdGluYXRpb24gPSBuZXcgRGF0ZShzb3VyY2UuZ2V0VGltZSgpKTsKICAgICAgICB9IGVsc2UgaWYgKGlzUmVnRXhwKHNvdXJjZSkpIHsKICAgICAgICAgIGRlc3RpbmF0aW9uID0gbmV3IFJlZ0V4cChzb3VyY2Uuc291cmNlKTsKICAgICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgICAgIGRlc3RpbmF0aW9uID0gY29weShzb3VyY2UsIHt9LCBzdGFja1NvdXJjZSwgc3RhY2tEZXN0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChzb3VyY2UgPT09IGRlc3RpbmF0aW9uKSB0aHJvdyBuZ01pbkVycignY3BpJywKICAgICAgICAiQ2FuJ3QgY29weSEgU291cmNlIGFuZCBkZXN0aW5hdGlvbiBhcmUgaWRlbnRpY2FsLiIpOwoKICAgICAgc3RhY2tTb3VyY2UgPSBzdGFja1NvdXJjZSB8fCBbXTsKICAgICAgc3RhY2tEZXN0ID0gc3RhY2tEZXN0IHx8IFtdOwoKICAgICAgaWYgKGlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgICB2YXIgaW5kZXggPSBpbmRleE9mKHN0YWNrU291cmNlLCBzb3VyY2UpOwogICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHJldHVybiBzdGFja0Rlc3RbaW5kZXhdOwoKICAgICAgICBzdGFja1NvdXJjZS5wdXNoKHNvdXJjZSk7CiAgICAgICAgc3RhY2tEZXN0LnB1c2goZGVzdGluYXRpb24pOwogICAgICB9CgogICAgICB2YXIgcmVzdWx0OwogICAgICBpZiAoaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgZGVzdGluYXRpb24ubGVuZ3RoID0gMDsKICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBzb3VyY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHJlc3VsdCA9IGNvcHkoc291cmNlW2ldLCBudWxsLCBzdGFja1NvdXJjZSwgc3RhY2tEZXN0KTsKICAgICAgICAgIGlmIChpc09iamVjdChzb3VyY2VbaV0pKSB7CiAgICAgICAgICAgIHN0YWNrU291cmNlLnB1c2goc291cmNlW2ldKTsKICAgICAgICAgICAgc3RhY2tEZXN0LnB1c2gocmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICAgIGRlc3RpbmF0aW9uLnB1c2gocmVzdWx0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGggPSBkZXN0aW5hdGlvbi4kJGhhc2hLZXk7CiAgICAgICAgZm9yRWFjaChkZXN0aW5hdGlvbiwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgZGVsZXRlIGRlc3RpbmF0aW9uW2tleV07CiAgICAgICAgfSk7CiAgICAgICAgZm9yICggdmFyIGtleSBpbiBzb3VyY2UpIHsKICAgICAgICAgIHJlc3VsdCA9IGNvcHkoc291cmNlW2tleV0sIG51bGwsIHN0YWNrU291cmNlLCBzdGFja0Rlc3QpOwogICAgICAgICAgaWYgKGlzT2JqZWN0KHNvdXJjZVtrZXldKSkgewogICAgICAgICAgICBzdGFja1NvdXJjZS5wdXNoKHNvdXJjZVtrZXldKTsKICAgICAgICAgICAgc3RhY2tEZXN0LnB1c2gocmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICAgIGRlc3RpbmF0aW9uW2tleV0gPSByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHNldEhhc2hLZXkoZGVzdGluYXRpb24saCk7CiAgICAgIH0KCiAgICB9CiAgICByZXR1cm4gZGVzdGluYXRpb247CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgc2hhbGxvdyBjb3B5IG9mIGFuIG9iamVjdCwgYW4gYXJyYXkgb3IgYSBwcmltaXRpdmUKICAgKi8KICBmdW5jdGlvbiBzaGFsbG93Q29weShzcmMsIGRzdCkgewogICAgaWYgKGlzQXJyYXkoc3JjKSkgewogICAgICBkc3QgPSBkc3QgfHwgW107CgogICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBzcmMubGVuZ3RoOyBpKyspIHsKICAgICAgICBkc3RbaV0gPSBzcmNbaV07CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qoc3JjKSkgewogICAgICBkc3QgPSBkc3QgfHwge307CgogICAgICBmb3IgKHZhciBrZXkgaW4gc3JjKSB7CiAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoc3JjLCBrZXkpICYmICEoa2V5LmNoYXJBdCgwKSA9PT0gJyQnICYmIGtleS5jaGFyQXQoMSkgPT09ICckJykpIHsKICAgICAgICAgIGRzdFtrZXldID0gc3JjW2tleV07CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGRzdCB8fCBzcmM7CiAgfQoKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5lcXVhbHMKICAgKiBAbW9kdWxlIG5nCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERldGVybWluZXMgaWYgdHdvIG9iamVjdHMgb3IgdHdvIHZhbHVlcyBhcmUgZXF1aXZhbGVudC4gU3VwcG9ydHMgdmFsdWUgdHlwZXMsIHJlZ3VsYXIKICAgKiBleHByZXNzaW9ucywgYXJyYXlzIGFuZCBvYmplY3RzLgogICAqCiAgICogVHdvIG9iamVjdHMgb3IgdmFsdWVzIGFyZSBjb25zaWRlcmVkIGVxdWl2YWxlbnQgaWYgYXQgbGVhc3Qgb25lIG9mIHRoZSBmb2xsb3dpbmcgaXMgdHJ1ZToKICAgKgogICAqICogQm90aCBvYmplY3RzIG9yIHZhbHVlcyBwYXNzIGA9PT1gIGNvbXBhcmlzb24uCiAgICogKiBCb3RoIG9iamVjdHMgb3IgdmFsdWVzIGFyZSBvZiB0aGUgc2FtZSB0eXBlIGFuZCBhbGwgb2YgdGhlaXIgcHJvcGVydGllcyBhcmUgZXF1YWwgYnkKICAgKiAgIGNvbXBhcmluZyB0aGVtIHdpdGggYGFuZ3VsYXIuZXF1YWxzYC4KICAgKiAqIEJvdGggdmFsdWVzIGFyZSBOYU4uIChJbiBKYXZhU2NyaXB0LCBOYU4gPT0gTmFOID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIE5hTiBhcyBlcXVhbCkKICAgKiAqIEJvdGggdmFsdWVzIHJlcHJlc2VudCB0aGUgc2FtZSByZWd1bGFyIGV4cHJlc3Npb24gKEluIEphdmFTY3JpcHQsCiAgICogICAvYWJjLyA9PSAvYWJjLyA9PiBmYWxzZS4gQnV0IHdlIGNvbnNpZGVyIHR3byByZWd1bGFyIGV4cHJlc3Npb25zIGFzIGVxdWFsIHdoZW4gdGhlaXIgdGV4dHVhbAogICAqICAgcmVwcmVzZW50YXRpb24gbWF0Y2hlcykuCiAgICoKICAgKiBEdXJpbmcgYSBwcm9wZXJ0eSBjb21wYXJpc29uLCBwcm9wZXJ0aWVzIG9mIGBmdW5jdGlvbmAgdHlwZSBhbmQgcHJvcGVydGllcyB3aXRoIG5hbWVzCiAgICogdGhhdCBiZWdpbiB3aXRoIGAkYCBhcmUgaWdub3JlZC4KICAgKgogICAqIFNjb3BlIGFuZCBET01XaW5kb3cgb2JqZWN0cyBhcmUgYmVpbmcgY29tcGFyZWQgb25seSBieSBpZGVudGlmeSAoYD09PWApLgogICAqCiAgICogQHBhcmFtIHsqfSBvMSBPYmplY3Qgb3IgdmFsdWUgdG8gY29tcGFyZS4KICAgKiBAcGFyYW0geyp9IG8yIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGFyZ3VtZW50cyBhcmUgZXF1YWwuCiAgICovCiAgZnVuY3Rpb24gZXF1YWxzKG8xLCBvMikgewogICAgaWYgKG8xID09PSBvMikgcmV0dXJuIHRydWU7CiAgICBpZiAobzEgPT09IG51bGwgfHwgbzIgPT09IG51bGwpIHJldHVybiBmYWxzZTsKICAgIGlmIChvMSAhPT0gbzEgJiYgbzIgIT09IG8yKSByZXR1cm4gdHJ1ZTsgLy8gTmFOID09PSBOYU4KICAgIHZhciB0MSA9IHR5cGVvZiBvMSwgdDIgPSB0eXBlb2YgbzIsIGxlbmd0aCwga2V5LCBrZXlTZXQ7CiAgICBpZiAodDEgPT0gdDIpIHsKICAgICAgaWYgKHQxID09ICdvYmplY3QnKSB7CiAgICAgICAgaWYgKGlzQXJyYXkobzEpKSB7CiAgICAgICAgICBpZiAoIWlzQXJyYXkobzIpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICBpZiAoKGxlbmd0aCA9IG8xLmxlbmd0aCkgPT0gbzIubGVuZ3RoKSB7CiAgICAgICAgICAgIGZvcihrZXk9MDsga2V5PGxlbmd0aDsga2V5KyspIHsKICAgICAgICAgICAgICBpZiAoIWVxdWFscyhvMVtrZXldLCBvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoaXNEYXRlKG8xKSkgewogICAgICAgICAgcmV0dXJuIGlzRGF0ZShvMikgJiYgbzEuZ2V0VGltZSgpID09IG8yLmdldFRpbWUoKTsKICAgICAgICB9IGVsc2UgaWYgKGlzUmVnRXhwKG8xKSAmJiBpc1JlZ0V4cChvMikpIHsKICAgICAgICAgIHJldHVybiBvMS50b1N0cmluZygpID09IG8yLnRvU3RyaW5nKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpc1Njb3BlKG8xKSB8fCBpc1Njb3BlKG8yKSB8fCBpc1dpbmRvdyhvMSkgfHwgaXNXaW5kb3cobzIpIHx8IGlzQXJyYXkobzIpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICBrZXlTZXQgPSB7fTsKICAgICAgICAgIGZvcihrZXkgaW4gbzEpIHsKICAgICAgICAgICAgaWYgKGtleS5jaGFyQXQoMCkgPT09ICckJyB8fCBpc0Z1bmN0aW9uKG8xW2tleV0pKSBjb250aW51ZTsKICAgICAgICAgICAgaWYgKCFlcXVhbHMobzFba2V5XSwgbzJba2V5XSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAga2V5U2V0W2tleV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZm9yKGtleSBpbiBvMikgewogICAgICAgICAgICBpZiAoIWtleVNldC5oYXNPd25Qcm9wZXJ0eShrZXkpICYmCiAgICAgICAgICAgICAga2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmCiAgICAgICAgICAgICAgbzJba2V5XSAhPT0gdW5kZWZpbmVkICYmCiAgICAgICAgICAgICAgIWlzRnVuY3Rpb24obzJba2V5XSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KCgogIGZ1bmN0aW9uIGNzcCgpIHsKICAgIHJldHVybiAoZG9jdW1lbnQuc2VjdXJpdHlQb2xpY3kgJiYgZG9jdW1lbnQuc2VjdXJpdHlQb2xpY3kuaXNBY3RpdmUpIHx8CiAgICAgIChkb2N1bWVudC5xdWVyeVNlbGVjdG9yICYmCiAgICAgICAgISEoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW25nLWNzcF0nKSB8fCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1uZy1jc3BdJykpKTsKICB9CgoKICBmdW5jdGlvbiBjb25jYXQoYXJyYXkxLCBhcnJheTIsIGluZGV4KSB7CiAgICByZXR1cm4gYXJyYXkxLmNvbmNhdChzbGljZS5jYWxsKGFycmF5MiwgaW5kZXgpKTsKICB9CgogIGZ1bmN0aW9uIHNsaWNlQXJncyhhcmdzLCBzdGFydEluZGV4KSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcmdzLCBzdGFydEluZGV4IHx8IDApOwogIH0KCgogIC8qIGpzaGludCAtVzEwMSAqLwogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuYmluZAogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHdoaWNoIGNhbGxzIGZ1bmN0aW9uIGBmbmAgYm91bmQgdG8gYHNlbGZgIChgc2VsZmAgYmVjb21lcyB0aGUgYHRoaXNgIGZvcgogICAqIGBmbmApLiBZb3UgY2FuIHN1cHBseSBvcHRpb25hbCBgYXJnc2AgdGhhdCBhcmUgcHJlYm91bmQgdG8gdGhlIGZ1bmN0aW9uLiBUaGlzIGZlYXR1cmUgaXMgYWxzbwogICAqIGtub3duIGFzIFtwYXJ0aWFsIGFwcGxpY2F0aW9uXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1BhcnRpYWxfYXBwbGljYXRpb24pLCBhcwogICAqIGRpc3Rpbmd1aXNoZWQgZnJvbSBbZnVuY3Rpb24gY3VycnlpbmddKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3VycnlpbmcjQ29udHJhc3Rfd2l0aF9wYXJ0aWFsX2Z1bmN0aW9uX2FwcGxpY2F0aW9uKS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBzZWxmIENvbnRleHQgd2hpY2ggYGZuYCBzaG91bGQgYmUgZXZhbHVhdGVkIGluLgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gRnVuY3Rpb24gdG8gYmUgYm91bmQuCiAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIGFyZ3VtZW50cyB0byBiZSBwcmVib3VuZCB0byB0aGUgYGZuYCBmdW5jdGlvbiBjYWxsLgogICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBGdW5jdGlvbiB0aGF0IHdyYXBzIHRoZSBgZm5gIHdpdGggYWxsIHRoZSBzcGVjaWZpZWQgYmluZGluZ3MuCiAgICovCiAgLyoganNoaW50ICtXMTAxICovCiAgZnVuY3Rpb24gYmluZChzZWxmLCBmbikgewogICAgdmFyIGN1cnJ5QXJncyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyID8gc2xpY2VBcmdzKGFyZ3VtZW50cywgMikgOiBbXTsKICAgIGlmIChpc0Z1bmN0aW9uKGZuKSAmJiAhKGZuIGluc3RhbmNlb2YgUmVnRXhwKSkgewogICAgICByZXR1cm4gY3VycnlBcmdzLmxlbmd0aAogICAgICAgID8gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGgKICAgICAgICAgID8gZm4uYXBwbHkoc2VsZiwgY3VycnlBcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpKQogICAgICAgICAgOiBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MpOwogICAgICB9CiAgICAgICAgOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aAogICAgICAgICAgPyBmbi5hcHBseShzZWxmLCBhcmd1bWVudHMpCiAgICAgICAgICA6IGZuLmNhbGwoc2VsZik7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAvLyBpbiBJRSwgbmF0aXZlIG1ldGhvZHMgYXJlIG5vdCBmdW5jdGlvbnMgc28gdGhleSBjYW5ub3QgYmUgYm91bmQgKG5vdGU6IHRoZXkgZG9uJ3QgbmVlZCB0byBiZSkKICAgICAgcmV0dXJuIGZuOwogICAgfQogIH0KCgogIGZ1bmN0aW9uIHRvSnNvblJlcGxhY2VyKGtleSwgdmFsdWUpIHsKICAgIHZhciB2YWwgPSB2YWx1ZTsKCiAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYga2V5LmNoYXJBdCgwKSA9PT0gJyQnKSB7CiAgICAgIHZhbCA9IHVuZGVmaW5lZDsKICAgIH0gZWxzZSBpZiAoaXNXaW5kb3codmFsdWUpKSB7CiAgICAgIHZhbCA9ICckV0lORE9XJzsKICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgIGRvY3VtZW50ID09PSB2YWx1ZSkgewogICAgICB2YWwgPSAnJERPQ1VNRU5UJzsKICAgIH0gZWxzZSBpZiAoaXNTY29wZSh2YWx1ZSkpIHsKICAgICAgdmFsID0gJyRTQ09QRSc7CiAgICB9CgogICAgcmV0dXJuIHZhbDsKICB9CgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLnRvSnNvbgogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2VyaWFsaXplcyBpbnB1dCBpbnRvIGEgSlNPTi1mb3JtYXR0ZWQgc3RyaW5nLiBQcm9wZXJ0aWVzIHdpdGggbGVhZGluZyAkIGNoYXJhY3RlcnMgd2lsbCBiZQogICAqIHN0cmlwcGVkIHNpbmNlIGFuZ3VsYXIgdXNlcyB0aGlzIG5vdGF0aW9uIGludGVybmFsbHkuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdHxBcnJheXxEYXRlfHN0cmluZ3xudW1iZXJ9IG9iaiBJbnB1dCB0byBiZSBzZXJpYWxpemVkIGludG8gSlNPTi4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBwcmV0dHkgSWYgc2V0IHRvIHRydWUsIHRoZSBKU09OIG91dHB1dCB3aWxsIGNvbnRhaW4gbmV3bGluZXMgYW5kIHdoaXRlc3BhY2UuCiAgICogQHJldHVybnMge3N0cmluZ3x1bmRlZmluZWR9IEpTT04taWZpZWQgc3RyaW5nIHJlcHJlc2VudGluZyBgb2JqYC4KICAgKi8KICBmdW5jdGlvbiB0b0pzb24ob2JqLCBwcmV0dHkpIHsKICAgIGlmICh0eXBlb2Ygb2JqID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHVuZGVmaW5lZDsKICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmosIHRvSnNvblJlcGxhY2VyLCBwcmV0dHkgPyAnICAnIDogbnVsbCk7CiAgfQoKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5mcm9tSnNvbgogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGVzZXJpYWxpemVzIGEgSlNPTiBzdHJpbmcuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30ganNvbiBKU09OIHN0cmluZyB0byBkZXNlcmlhbGl6ZS4KICAgKiBAcmV0dXJucyB7T2JqZWN0fEFycmF5fHN0cmluZ3xudW1iZXJ9IERlc2VyaWFsaXplZCB0aGluZ3kuCiAgICovCiAgZnVuY3Rpb24gZnJvbUpzb24oanNvbikgewogICAgcmV0dXJuIGlzU3RyaW5nKGpzb24pCiAgICAgID8gSlNPTi5wYXJzZShqc29uKQogICAgICA6IGpzb247CiAgfQoKCiAgZnVuY3Rpb24gdG9Cb29sZWFuKHZhbHVlKSB7CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHZhbHVlID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgdmFsdWUubGVuZ3RoICE9PSAwKSB7CiAgICAgIHZhciB2ID0gbG93ZXJjYXNlKCIiICsgdmFsdWUpOwogICAgICB2YWx1ZSA9ICEodiA9PSAnZicgfHwgdiA9PSAnMCcgfHwgdiA9PSAnZmFsc2UnIHx8IHYgPT0gJ25vJyB8fCB2ID09ICduJyB8fCB2ID09ICdbXScpOwogICAgfSBlbHNlIHsKICAgICAgdmFsdWUgPSBmYWxzZTsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9CgogIC8qKgogICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgZWxlbWVudC4KICAgKi8KICBmdW5jdGlvbiBzdGFydGluZ1RhZyhlbGVtZW50KSB7CiAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpLmNsb25lKCk7CiAgICB0cnkgewogICAgICAvLyB0dXJucyBvdXQgSUUgZG9lcyBub3QgbGV0IHlvdSBzZXQgLmh0bWwoKSBvbiBlbGVtZW50cyB3aGljaAogICAgICAvLyBhcmUgbm90IGFsbG93ZWQgdG8gaGF2ZSBjaGlsZHJlbi4gU28gd2UganVzdCBpZ25vcmUgaXQuCiAgICAgIGVsZW1lbnQuZW1wdHkoKTsKICAgIH0gY2F0Y2goZSkge30KICAgIC8vIEFzIFBlciBET00gU3RhbmRhcmRzCiAgICB2YXIgVEVYVF9OT0RFID0gMzsKICAgIHZhciBlbGVtSHRtbCA9IGpxTGl0ZSgnPGRpdj4nKS5hcHBlbmQoZWxlbWVudCkuaHRtbCgpOwogICAgdHJ5IHsKICAgICAgcmV0dXJuIGVsZW1lbnRbMF0ubm9kZVR5cGUgPT09IFRFWFRfTk9ERSA/IGxvd2VyY2FzZShlbGVtSHRtbCkgOgogICAgICAgIGVsZW1IdG1sLgogICAgICAgICAgbWF0Y2goL14oPFtePl0rPikvKVsxXS4KICAgICAgICAgIHJlcGxhY2UoL148KFtcd1wtXSspLywgZnVuY3Rpb24obWF0Y2gsIG5vZGVOYW1lKSB7IHJldHVybiAnPCcgKyBsb3dlcmNhc2Uobm9kZU5hbWUpOyB9KTsKICAgIH0gY2F0Y2goZSkgewogICAgICByZXR1cm4gbG93ZXJjYXNlKGVsZW1IdG1sKTsKICAgIH0KCiAgfQoKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgLyoqCiAgICogVHJpZXMgdG8gZGVjb2RlIHRoZSBVUkkgY29tcG9uZW50IHdpdGhvdXQgdGhyb3dpbmcgYW4gZXhjZXB0aW9uLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0gc3RyIHZhbHVlIHBvdGVudGlhbCBVUkkgY29tcG9uZW50IHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgY2FuIGJlIGRlY29kZWQKICAgKiB3aXRoIHRoZSBkZWNvZGVVUklDb21wb25lbnQgZnVuY3Rpb24uCiAgICovCiAgZnVuY3Rpb24gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgIH0gY2F0Y2goZSkgewogICAgICAvLyBJZ25vcmUgYW55IGludmFsaWQgdXJpIGNvbXBvbmVudAogICAgfQogIH0KCgogIC8qKgogICAqIFBhcnNlcyBhbiBlc2NhcGVkIHVybCBxdWVyeSBzdHJpbmcgaW50byBrZXktdmFsdWUgcGFpcnMuCiAgICogQHJldHVybnMge09iamVjdC48c3RyaW5nLGJvb2xlYW58QXJyYXk+fQogICAqLwogIGZ1bmN0aW9uIHBhcnNlS2V5VmFsdWUoLyoqc3RyaW5nKi9rZXlWYWx1ZSkgewogICAgdmFyIG9iaiA9IHt9LCBrZXlfdmFsdWUsIGtleTsKICAgIGZvckVhY2goKGtleVZhbHVlIHx8ICIiKS5zcGxpdCgnJicpLCBmdW5jdGlvbihrZXlWYWx1ZSkgewogICAgICBpZiAoIGtleVZhbHVlICkgewogICAgICAgIGtleV92YWx1ZSA9IGtleVZhbHVlLnNwbGl0KCc9Jyk7CiAgICAgICAga2V5ID0gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KGtleV92YWx1ZVswXSk7CiAgICAgICAgaWYgKCBpc0RlZmluZWQoa2V5KSApIHsKICAgICAgICAgIHZhciB2YWwgPSBpc0RlZmluZWQoa2V5X3ZhbHVlWzFdKSA/IHRyeURlY29kZVVSSUNvbXBvbmVudChrZXlfdmFsdWVbMV0pIDogdHJ1ZTsKICAgICAgICAgIGlmICghb2JqW2tleV0pIHsKICAgICAgICAgICAgb2JqW2tleV0gPSB2YWw7CiAgICAgICAgICB9IGVsc2UgaWYoaXNBcnJheShvYmpba2V5XSkpIHsKICAgICAgICAgICAgb2JqW2tleV0ucHVzaCh2YWwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb2JqW2tleV0gPSBbb2JqW2tleV0sdmFsXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG9iajsKICB9CgogIGZ1bmN0aW9uIHRvS2V5VmFsdWUob2JqKSB7CiAgICB2YXIgcGFydHMgPSBbXTsKICAgIGZvckVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgIGZvckVhY2godmFsdWUsIGZ1bmN0aW9uKGFycmF5VmFsdWUpIHsKICAgICAgICAgIHBhcnRzLnB1c2goZW5jb2RlVXJpUXVlcnkoa2V5LCB0cnVlKSArCiAgICAgICAgICAgIChhcnJheVZhbHVlID09PSB0cnVlID8gJycgOiAnPScgKyBlbmNvZGVVcmlRdWVyeShhcnJheVZhbHVlLCB0cnVlKSkpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcnRzLnB1c2goZW5jb2RlVXJpUXVlcnkoa2V5LCB0cnVlKSArCiAgICAgICAgICAodmFsdWUgPT09IHRydWUgPyAnJyA6ICc9JyArIGVuY29kZVVyaVF1ZXJ5KHZhbHVlLCB0cnVlKSkpOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBwYXJ0cy5sZW5ndGggPyBwYXJ0cy5qb2luKCcmJykgOiAnJzsKICB9CgoKICAvKioKICAgKiBXZSBuZWVkIG91ciBjdXN0b20gbWV0aG9kIGJlY2F1c2UgZW5jb2RlVVJJQ29tcG9uZW50IGlzIHRvbyBhZ2dyZXNzaXZlIGFuZCBkb2Vzbid0IGZvbGxvdwogICAqIGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYudHh0IHdpdGggcmVnYXJkcyB0byB0aGUgY2hhcmFjdGVyIHNldCAocGNoYXIpIGFsbG93ZWQgaW4gcGF0aAogICAqIHNlZ21lbnRzOgogICAqICAgIHNlZ21lbnQgICAgICAgPSAqcGNoYXIKICAgKiAgICBwY2hhciAgICAgICAgID0gdW5yZXNlcnZlZCAvIHBjdC1lbmNvZGVkIC8gc3ViLWRlbGltcyAvICI6IiAvICJAIgogICAqICAgIHBjdC1lbmNvZGVkICAgPSAiJSIgSEVYRElHIEhFWERJRwogICAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAgICogICAgc3ViLWRlbGltcyAgICA9ICIhIiAvICIkIiAvICImIiAvICInIiAvICIoIiAvICIpIgogICAqICAgICAgICAgICAgICAgICAgICAgLyAiKiIgLyAiKyIgLyAiLCIgLyAiOyIgLyAiPSIKICAgKi8KICBmdW5jdGlvbiBlbmNvZGVVcmlTZWdtZW50KHZhbCkgewogICAgcmV0dXJuIGVuY29kZVVyaVF1ZXJ5KHZhbCwgdHJ1ZSkuCiAgICAgIHJlcGxhY2UoLyUyNi9naSwgJyYnKS4KICAgICAgcmVwbGFjZSgvJTNEL2dpLCAnPScpLgogICAgICByZXBsYWNlKC8lMkIvZ2ksICcrJyk7CiAgfQoKCiAgLyoqCiAgICogVGhpcyBtZXRob2QgaXMgaW50ZW5kZWQgZm9yIGVuY29kaW5nICprZXkqIG9yICp2YWx1ZSogcGFydHMgb2YgcXVlcnkgY29tcG9uZW50LiBXZSBuZWVkIGEgY3VzdG9tCiAgICogbWV0aG9kIGJlY2F1c2UgZW5jb2RlVVJJQ29tcG9uZW50IGlzIHRvbyBhZ2dyZXNzaXZlIGFuZCBlbmNvZGVzIHN0dWZmIHRoYXQgZG9lc24ndCBoYXZlIHRvIGJlCiAgICogZW5jb2RlZCBwZXIgaHR0cDovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzk4NjoKICAgKiAgICBxdWVyeSAgICAgICA9ICooIHBjaGFyIC8gIi8iIC8gIj8iICkKICAgKiAgICBwY2hhciAgICAgICAgID0gdW5yZXNlcnZlZCAvIHBjdC1lbmNvZGVkIC8gc3ViLWRlbGltcyAvICI6IiAvICJAIgogICAqICAgIHVucmVzZXJ2ZWQgICAgPSBBTFBIQSAvIERJR0lUIC8gIi0iIC8gIi4iIC8gIl8iIC8gIn4iCiAgICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAgICogICAgc3ViLWRlbGltcyAgICA9ICIhIiAvICIkIiAvICImIiAvICInIiAvICIoIiAvICIpIgogICAqICAgICAgICAgICAgICAgICAgICAgLyAiKiIgLyAiKyIgLyAiLCIgLyAiOyIgLyAiPSIKICAgKi8KICBmdW5jdGlvbiBlbmNvZGVVcmlRdWVyeSh2YWwsIHBjdEVuY29kZVNwYWNlcykgewogICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpLgogICAgICByZXBsYWNlKC8lNDAvZ2ksICdAJykuCiAgICAgIHJlcGxhY2UoLyUzQS9naSwgJzonKS4KICAgICAgcmVwbGFjZSgvJTI0L2csICckJykuCiAgICAgIHJlcGxhY2UoLyUyQy9naSwgJywnKS4KICAgICAgcmVwbGFjZSgvJTIwL2csIChwY3RFbmNvZGVTcGFjZXMgPyAnJTIwJyA6ICcrJykpOwogIH0KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0FwcAogICAqIEBtb2R1bGUgbmcKICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwYXJhbSB7YW5ndWxhci5Nb2R1bGV9IG5nQXBwIGFuIG9wdGlvbmFsIGFwcGxpY2F0aW9uCiAgICogICB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlfSBuYW1lIHRvIGxvYWQuCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIFVzZSB0aGlzIGRpcmVjdGl2ZSB0byAqKmF1dG8tYm9vdHN0cmFwKiogYW4gQW5ndWxhckpTIGFwcGxpY2F0aW9uLiBUaGUgYG5nQXBwYCBkaXJlY3RpdmUKICAgKiBkZXNpZ25hdGVzIHRoZSAqKnJvb3QgZWxlbWVudCoqIG9mIHRoZSBhcHBsaWNhdGlvbiBhbmQgaXMgdHlwaWNhbGx5IHBsYWNlZCBuZWFyIHRoZSByb290IGVsZW1lbnQKICAgKiBvZiB0aGUgcGFnZSAtIGUuZy4gb24gdGhlIGA8Ym9keT5gIG9yIGA8aHRtbD5gIHRhZ3MuCiAgICoKICAgKiBPbmx5IG9uZSBBbmd1bGFySlMgYXBwbGljYXRpb24gY2FuIGJlIGF1dG8tYm9vdHN0cmFwcGVkIHBlciBIVE1MIGRvY3VtZW50LiBUaGUgZmlyc3QgYG5nQXBwYAogICAqIGZvdW5kIGluIHRoZSBkb2N1bWVudCB3aWxsIGJlIHVzZWQgdG8gZGVmaW5lIHRoZSByb290IGVsZW1lbnQgdG8gYXV0by1ib290c3RyYXAgYXMgYW4KICAgKiBhcHBsaWNhdGlvbi4gVG8gcnVuIG11bHRpcGxlIGFwcGxpY2F0aW9ucyBpbiBhbiBIVE1MIGRvY3VtZW50IHlvdSBtdXN0IG1hbnVhbGx5IGJvb3RzdHJhcCB0aGVtIHVzaW5nCiAgICoge0BsaW5rIGFuZ3VsYXIuYm9vdHN0cmFwfSBpbnN0ZWFkLiBBbmd1bGFySlMgYXBwbGljYXRpb25zIGNhbm5vdCBiZSBuZXN0ZWQgd2l0aGluIGVhY2ggb3RoZXIuCiAgICoKICAgKiBZb3UgY2FuIHNwZWNpZnkgYW4gKipBbmd1bGFySlMgbW9kdWxlKiogdG8gYmUgdXNlZCBhcyB0aGUgcm9vdCBtb2R1bGUgZm9yIHRoZSBhcHBsaWNhdGlvbi4gIFRoaXMKICAgKiBtb2R1bGUgd2lsbCBiZSBsb2FkZWQgaW50byB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yfSB3aGVuIHRoZSBhcHBsaWNhdGlvbiBpcyBib290c3RyYXBwZWQgYW5kCiAgICogc2hvdWxkIGNvbnRhaW4gdGhlIGFwcGxpY2F0aW9uIGNvZGUgbmVlZGVkIG9yIGhhdmUgZGVwZW5kZW5jaWVzIG9uIG90aGVyIG1vZHVsZXMgdGhhdCB3aWxsCiAgICogY29udGFpbiB0aGUgY29kZS4gU2VlIHtAbGluayBhbmd1bGFyLm1vZHVsZX0gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICoKICAgKiBJbiB0aGUgZXhhbXBsZSBiZWxvdyBpZiB0aGUgYG5nQXBwYCBkaXJlY3RpdmUgd2VyZSBub3QgcGxhY2VkIG9uIHRoZSBgaHRtbGAgZWxlbWVudCB0aGVuIHRoZQogICAqIGRvY3VtZW50IHdvdWxkIG5vdCBiZSBjb21waWxlZCwgdGhlIGBBcHBDb250cm9sbGVyYCB3b3VsZCBub3QgYmUgaW5zdGFudGlhdGVkIGFuZCB0aGUgYHt7IGErYiB9fWAKICAgKiB3b3VsZCBub3QgYmUgcmVzb2x2ZWQgdG8gYDNgLgogICAqCiAgICogYG5nQXBwYCBpcyB0aGUgZWFzaWVzdCwgYW5kIG1vc3QgY29tbW9uLCB3YXkgdG8gYm9vdHN0cmFwIGFuIGFwcGxpY2F0aW9uLgogICAqCiAgIDxleGFtcGxlIG1vZHVsZT0ibmdBcHBEZW1vIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctY29udHJvbGxlcj0ibmdBcHBEZW1vQ29udHJvbGxlciI+CiAgIEkgY2FuIGFkZDoge3thfX0gKyB7e2J9fSA9ICB7eyBhK2IgfX0KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgYW5ndWxhci5tb2R1bGUoJ25nQXBwRGVtbycsIFtdKS5jb250cm9sbGVyKCduZ0FwcERlbW9Db250cm9sbGVyJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgJHNjb3BlLmEgPSAxOwogICAgICRzY29wZS5iID0gMjsKICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqCiAgICovCiAgZnVuY3Rpb24gYW5ndWxhckluaXQoZWxlbWVudCwgYm9vdHN0cmFwKSB7CiAgICB2YXIgZWxlbWVudHMgPSBbZWxlbWVudF0sCiAgICAgIGFwcEVsZW1lbnQsCiAgICAgIG1vZHVsZSwKICAgICAgbmFtZXMgPSBbJ25nOmFwcCcsICduZy1hcHAnLCAneC1uZy1hcHAnLCAnZGF0YS1uZy1hcHAnXSwKICAgICAgTkdfQVBQX0NMQVNTX1JFR0VYUCA9IC9cc25nWzpcLV1hcHAoOlxzKihbXHdcZF9dKyk7Pyk/XHMvOwoKICAgIGZ1bmN0aW9uIGFwcGVuZChlbGVtZW50KSB7CiAgICAgIGVsZW1lbnQgJiYgZWxlbWVudHMucHVzaChlbGVtZW50KTsKICAgIH0KCiAgICBmb3JFYWNoKG5hbWVzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgIG5hbWVzW25hbWVdID0gdHJ1ZTsKICAgICAgYXBwZW5kKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG5hbWUpKTsKICAgICAgbmFtZSA9IG5hbWUucmVwbGFjZSgnOicsICdcXDonKTsKICAgICAgaWYgKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCkgewogICAgICAgIGZvckVhY2goZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIG5hbWUpLCBhcHBlbmQpOwogICAgICAgIGZvckVhY2goZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcuJyArIG5hbWUgKyAnXFw6JyksIGFwcGVuZCk7CiAgICAgICAgZm9yRWFjaChlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1snICsgbmFtZSArICddJyksIGFwcGVuZCk7CiAgICAgIH0KICAgIH0pOwoKICAgIGZvckVhY2goZWxlbWVudHMsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgaWYgKCFhcHBFbGVtZW50KSB7CiAgICAgICAgdmFyIGNsYXNzTmFtZSA9ICcgJyArIGVsZW1lbnQuY2xhc3NOYW1lICsgJyAnOwogICAgICAgIHZhciBtYXRjaCA9IE5HX0FQUF9DTEFTU19SRUdFWFAuZXhlYyhjbGFzc05hbWUpOwogICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgYXBwRWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICBtb2R1bGUgPSAobWF0Y2hbMl0gfHwgJycpLnJlcGxhY2UoL1xzKy9nLCAnLCcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQuYXR0cmlidXRlcywgZnVuY3Rpb24oYXR0cikgewogICAgICAgICAgICBpZiAoIWFwcEVsZW1lbnQgJiYgbmFtZXNbYXR0ci5uYW1lXSkgewogICAgICAgICAgICAgIGFwcEVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgICAgICAgIG1vZHVsZSA9IGF0dHIudmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBpZiAoYXBwRWxlbWVudCkgewogICAgICBib290c3RyYXAoYXBwRWxlbWVudCwgbW9kdWxlID8gW21vZHVsZV0gOiBbXSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLmJvb3RzdHJhcAogICAqIEBtb2R1bGUgbmcKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2UgdGhpcyBmdW5jdGlvbiB0byBtYW51YWxseSBzdGFydCB1cCBhbmd1bGFyIGFwcGxpY2F0aW9uLgogICAqCiAgICogU2VlOiB7QGxpbmsgZ3VpZGUvYm9vdHN0cmFwIEJvb3RzdHJhcH0KICAgKgogICAqIE5vdGUgdGhhdCBuZ1NjZW5hcmlvLWJhc2VkIGVuZC10by1lbmQgdGVzdHMgY2Fubm90IHVzZSB0aGlzIGZ1bmN0aW9uIHRvIGJvb3RzdHJhcCBtYW51YWxseS4KICAgKiBUaGV5IG11c3QgdXNlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdBcHAgbmdBcHB9LgogICAqCiAgICogQW5ndWxhciB3aWxsIGRldGVjdCBpZiBpdCBoYXMgYmVlbiBsb2FkZWQgaW50byB0aGUgYnJvd3NlciBtb3JlIHRoYW4gb25jZSBhbmQgb25seSBhbGxvdyB0aGUKICAgKiBmaXJzdCBsb2FkZWQgc2NyaXB0IHRvIGJlIGJvb3RzdHJhcHBlZCBhbmQgd2lsbCByZXBvcnQgYSB3YXJuaW5nIHRvIHRoZSBicm93c2VyIGNvbnNvbGUgZm9yCiAgICogZWFjaCBvZiB0aGUgc3Vic2VxdWVudCBzY3JpcHRzLiAgIFRoaXMgcHJldmVudHMgc3RyYW5nZSByZXN1bHRzIGluIGFwcGxpY2F0aW9ucywgd2hlcmUgb3RoZXJ3aXNlCiAgICogbXVsdGlwbGUgaW5zdGFuY2VzIG9mIEFuZ3VsYXIgdHJ5IHRvIHdvcmsgb24gdGhlIERPTS4KICAgKgogICAqIDxleGFtcGxlIG5hbWU9Im11bHRpLWJvb3RzdHJhcCIgbW9kdWxlPSJtdWx0aS1ib290c3RyYXAiPgogICAqIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAqIDxzY3JpcHQgc3JjPSIuLi8uLi8uLi9hbmd1bGFyLmpzIj48L3NjcmlwdD4KICAgKiA8ZGl2IG5nLWNvbnRyb2xsZXI9IkJyb2tlblRhYmxlIj4KICAgKiAgIDx0YWJsZT4KICAgKiAgIDx0cj4KICAgKiAgICAgPHRoIG5nLXJlcGVhdD0iaGVhZGluZyBpbiBoZWFkaW5ncyI+e3toZWFkaW5nfX08L3RoPgogICAqICAgPC90cj4KICAgKiAgIDx0ciBuZy1yZXBlYXQ9ImZpbGxpbmcgaW4gZmlsbGluZ3MiPgogICAqICAgICA8dGQgbmctcmVwZWF0PSJmaWxsIGluIGZpbGxpbmciPnt7ZmlsbH19PC90ZD4KICAgKiAgIDwvdHI+CiAgICogPC90YWJsZT4KICAgKiA8L2Rpdj4KICAgKiA8L2ZpbGU+CiAgICogPGZpbGUgbmFtZT0iY29udHJvbGxlci5qcyI+CiAgICogdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdtdWx0aS1ib290c3RyYXAnLCBbXSkKICAgKgogICAqIC5jb250cm9sbGVyKCdCcm9rZW5UYWJsZScsIGZ1bmN0aW9uKCRzY29wZSkgewogKiAgICAgJHNjb3BlLmhlYWRpbmdzID0gWydPbmUnLCAnVHdvJywgJ1RocmVlJ107CiAqICAgICAkc2NvcGUuZmlsbGluZ3MgPSBbWzEsIDIsIDNdLCBbJ0EnLCAnQicsICdDJ10sIFs3LCA4LCA5XV07CiAqIH0pOwogICAqIDwvZmlsZT4KICAgKiA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgKiBpdCgnc2hvdWxkIG9ubHkgaW5zZXJ0IG9uZSB0YWJsZSBjZWxsIGZvciBlYWNoIGl0ZW0gaW4gJHNjb3BlLmZpbGxpbmdzJywgZnVuY3Rpb24oKSB7CiAqICBleHBlY3QoZWxlbWVudC5hbGwoYnkuY3NzKCd0ZCcpKS5jb3VudCgpKQogKiAgICAgIC50b0JlKDkpOwogKiB9KTsKICAgKiA8L2ZpbGU+CiAgICogPC9leGFtcGxlPgogICAqCiAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IERPTSBlbGVtZW50IHdoaWNoIGlzIHRoZSByb290IG9mIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAgICogQHBhcmFtIHtBcnJheTxTdHJpbmd8RnVuY3Rpb258QXJyYXk+PX0gbW9kdWxlcyBhbiBhcnJheSBvZiBtb2R1bGVzIHRvIGxvYWQgaW50byB0aGUgYXBwbGljYXRpb24uCiAgICogICAgIEVhY2ggaXRlbSBpbiB0aGUgYXJyYXkgc2hvdWxkIGJlIHRoZSBuYW1lIG9mIGEgcHJlZGVmaW5lZCBtb2R1bGUgb3IgYSAoREkgYW5ub3RhdGVkKQogICAqICAgICBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgaW52b2tlZCBieSB0aGUgaW5qZWN0b3IgYXMgYSBydW4gYmxvY2suCiAgICogICAgIFNlZToge0BsaW5rIGFuZ3VsYXIubW9kdWxlIG1vZHVsZXN9CiAgICogQHJldHVybnMge2F1dG8uJGluamVjdG9yfSBSZXR1cm5zIHRoZSBuZXdseSBjcmVhdGVkIGluamVjdG9yIGZvciB0aGlzIGFwcC4KICAgKi8KICBmdW5jdGlvbiBib290c3RyYXAoZWxlbWVudCwgbW9kdWxlcykgewogICAgdmFyIGRvQm9vdHN0cmFwID0gZnVuY3Rpb24oKSB7CiAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CgogICAgICBpZiAoZWxlbWVudC5pbmplY3RvcigpKSB7CiAgICAgICAgdmFyIHRhZyA9IChlbGVtZW50WzBdID09PSBkb2N1bWVudCkgPyAnZG9jdW1lbnQnIDogc3RhcnRpbmdUYWcoZWxlbWVudCk7CiAgICAgICAgdGhyb3cgbmdNaW5FcnIoJ2J0c3RycGQnLCAiQXBwIEFscmVhZHkgQm9vdHN0cmFwcGVkIHdpdGggdGhpcyBFbGVtZW50ICd7MH0nIiwgdGFnKTsKICAgICAgfQoKICAgICAgbW9kdWxlcyA9IG1vZHVsZXMgfHwgW107CiAgICAgIG1vZHVsZXMudW5zaGlmdChbJyRwcm92aWRlJywgZnVuY3Rpb24oJHByb3ZpZGUpIHsKICAgICAgICAkcHJvdmlkZS52YWx1ZSgnJHJvb3RFbGVtZW50JywgZWxlbWVudCk7CiAgICAgIH1dKTsKICAgICAgbW9kdWxlcy51bnNoaWZ0KCduZycpOwogICAgICB2YXIgaW5qZWN0b3IgPSBjcmVhdGVJbmplY3Rvcihtb2R1bGVzKTsKICAgICAgaW5qZWN0b3IuaW52b2tlKFsnJHJvb3RTY29wZScsICckcm9vdEVsZW1lbnQnLCAnJGNvbXBpbGUnLCAnJGluamVjdG9yJywgJyRhbmltYXRlJywKICAgICAgICAgIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBjb21waWxlLCBpbmplY3RvciwgYW5pbWF0ZSkgewogICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5kYXRhKCckaW5qZWN0b3InLCBpbmplY3Rvcik7CiAgICAgICAgICAgICAgY29tcGlsZShlbGVtZW50KShzY29wZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfV0KICAgICAgKTsKICAgICAgcmV0dXJuIGluamVjdG9yOwogICAgfTsKCiAgICB2YXIgTkdfREVGRVJfQk9PVFNUUkFQID0gL15OR19ERUZFUl9CT09UU1RSQVAhLzsKCiAgICBpZiAod2luZG93ICYmICFOR19ERUZFUl9CT09UU1RSQVAudGVzdCh3aW5kb3cubmFtZSkpIHsKICAgICAgcmV0dXJuIGRvQm9vdHN0cmFwKCk7CiAgICB9CgogICAgd2luZG93Lm5hbWUgPSB3aW5kb3cubmFtZS5yZXBsYWNlKE5HX0RFRkVSX0JPT1RTVFJBUCwgJycpOwogICAgYW5ndWxhci5yZXN1bWVCb290c3RyYXAgPSBmdW5jdGlvbihleHRyYU1vZHVsZXMpIHsKICAgICAgZm9yRWFjaChleHRyYU1vZHVsZXMsIGZ1bmN0aW9uKG1vZHVsZSkgewogICAgICAgIG1vZHVsZXMucHVzaChtb2R1bGUpOwogICAgICB9KTsKICAgICAgZG9Cb290c3RyYXAoKTsKICAgIH07CiAgfQoKICB2YXIgU05BS0VfQ0FTRV9SRUdFWFAgPSAvW0EtWl0vZzsKICBmdW5jdGlvbiBzbmFrZV9jYXNlKG5hbWUsIHNlcGFyYXRvcikgewogICAgc2VwYXJhdG9yID0gc2VwYXJhdG9yIHx8ICdfJzsKICAgIHJldHVybiBuYW1lLnJlcGxhY2UoU05BS0VfQ0FTRV9SRUdFWFAsIGZ1bmN0aW9uKGxldHRlciwgcG9zKSB7CiAgICAgIHJldHVybiAocG9zID8gc2VwYXJhdG9yIDogJycpICsgbGV0dGVyLnRvTG93ZXJDYXNlKCk7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGJpbmRKUXVlcnkoKSB7CiAgICAvLyBiaW5kIHRvIGpRdWVyeSBpZiBwcmVzZW50OwogICAgalF1ZXJ5ID0gd2luZG93LmpRdWVyeTsKICAgIC8vIFVzZSBqUXVlcnkgaWYgaXQgZXhpc3RzIHdpdGggcHJvcGVyIGZ1bmN0aW9uYWxpdHksIG90aGVyd2lzZSBkZWZhdWx0IHRvIHVzLgogICAgLy8gQW5ndWxhciAxLjIrIHJlcXVpcmVzIGpRdWVyeSAxLjcuMSsgZm9yIG9uKCkvb2ZmKCkgc3VwcG9ydC4KICAgIGlmIChqUXVlcnkgJiYgalF1ZXJ5LmZuLm9uKSB7CiAgICAgIGpxTGl0ZSA9IGpRdWVyeTsKICAgICAgZXh0ZW5kKGpRdWVyeS5mbiwgewogICAgICAgIHNjb3BlOiBKUUxpdGVQcm90b3R5cGUuc2NvcGUsCiAgICAgICAgaXNvbGF0ZVNjb3BlOiBKUUxpdGVQcm90b3R5cGUuaXNvbGF0ZVNjb3BlLAogICAgICAgIGNvbnRyb2xsZXI6IEpRTGl0ZVByb3RvdHlwZS5jb250cm9sbGVyLAogICAgICAgIGluamVjdG9yOiBKUUxpdGVQcm90b3R5cGUuaW5qZWN0b3IsCiAgICAgICAgaW5oZXJpdGVkRGF0YTogSlFMaXRlUHJvdG90eXBlLmluaGVyaXRlZERhdGEKICAgICAgfSk7CiAgICAgIC8vIE1ldGhvZCBzaWduYXR1cmU6CiAgICAgIC8vICAgICBqcUxpdGVQYXRjaEpRdWVyeVJlbW92ZShuYW1lLCBkaXNwYXRjaFRoaXMsIGZpbHRlckVsZW1zLCBnZXR0ZXJJZk5vQXJndW1lbnRzKQogICAgICBqcUxpdGVQYXRjaEpRdWVyeVJlbW92ZSgncmVtb3ZlJywgdHJ1ZSwgdHJ1ZSwgZmFsc2UpOwogICAgICBqcUxpdGVQYXRjaEpRdWVyeVJlbW92ZSgnZW1wdHknLCBmYWxzZSwgZmFsc2UsIGZhbHNlKTsKICAgICAganFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUoJ2h0bWwnLCBmYWxzZSwgZmFsc2UsIHRydWUpOwogICAgfSBlbHNlIHsKICAgICAganFMaXRlID0gSlFMaXRlOwogICAgfQogICAgYW5ndWxhci5lbGVtZW50ID0ganFMaXRlOwogIH0KCiAgLyoqCiAgICogdGhyb3cgZXJyb3IgaWYgdGhlIGFyZ3VtZW50IGlzIGZhbHN5LgogICAqLwogIGZ1bmN0aW9uIGFzc2VydEFyZyhhcmcsIG5hbWUsIHJlYXNvbikgewogICAgaWYgKCFhcmcpIHsKICAgICAgdGhyb3cgbmdNaW5FcnIoJ2FyZXEnLCAiQXJndW1lbnQgJ3swfScgaXMgezF9IiwgKG5hbWUgfHwgJz8nKSwgKHJlYXNvbiB8fCAicmVxdWlyZWQiKSk7CiAgICB9CiAgICByZXR1cm4gYXJnOwogIH0KCiAgZnVuY3Rpb24gYXNzZXJ0QXJnRm4oYXJnLCBuYW1lLCBhY2NlcHRBcnJheUFubm90YXRpb24pIHsKICAgIGlmIChhY2NlcHRBcnJheUFubm90YXRpb24gJiYgaXNBcnJheShhcmcpKSB7CiAgICAgIGFyZyA9IGFyZ1thcmcubGVuZ3RoIC0gMV07CiAgICB9CgogICAgYXNzZXJ0QXJnKGlzRnVuY3Rpb24oYXJnKSwgbmFtZSwgJ25vdCBhIGZ1bmN0aW9uLCBnb3QgJyArCiAgICAgIChhcmcgJiYgdHlwZW9mIGFyZyA9PSAnb2JqZWN0JyA/IGFyZy5jb25zdHJ1Y3Rvci5uYW1lIHx8ICdPYmplY3QnIDogdHlwZW9mIGFyZykpOwogICAgcmV0dXJuIGFyZzsKICB9CgogIC8qKgogICAqIHRocm93IGVycm9yIGlmIHRoZSBuYW1lIGdpdmVuIGlzIGhhc093blByb3BlcnR5CiAgICogQHBhcmFtICB7U3RyaW5nfSBuYW1lICAgIHRoZSBuYW1lIHRvIHRlc3QKICAgKiBAcGFyYW0gIHtTdHJpbmd9IGNvbnRleHQgdGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIG5hbWUgaXMgdXNlZCwgc3VjaCBhcyBtb2R1bGUgb3IgZGlyZWN0aXZlCiAgICovCiAgZnVuY3Rpb24gYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkobmFtZSwgY29udGV4dCkgewogICAgaWYgKG5hbWUgPT09ICdoYXNPd25Qcm9wZXJ0eScpIHsKICAgICAgdGhyb3cgbmdNaW5FcnIoJ2JhZG5hbWUnLCAiaGFzT3duUHJvcGVydHkgaXMgbm90IGEgdmFsaWQgezB9IG5hbWUiLCBjb250ZXh0KTsKICAgIH0KICB9CgogIC8qKgogICAqIFJldHVybiB0aGUgdmFsdWUgYWNjZXNzaWJsZSBmcm9tIHRoZSBvYmplY3QgYnkgcGF0aC4gQW55IHVuZGVmaW5lZCB0cmF2ZXJzYWxzIGFyZSBpZ25vcmVkCiAgICogQHBhcmFtIHtPYmplY3R9IG9iaiBzdGFydGluZyBvYmplY3QKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aCBwYXRoIHRvIHRyYXZlcnNlCiAgICogQHBhcmFtIHtib29sZWFufSBbYmluZEZuVG9TY29wZT10cnVlXQogICAqIEByZXR1cm5zIHtPYmplY3R9IHZhbHVlIGFzIGFjY2Vzc2libGUgYnkgcGF0aAogICAqLwovL1RPRE8obWlza28pOiB0aGlzIGZ1bmN0aW9uIG5lZWRzIHRvIGJlIHJlbW92ZWQKICBmdW5jdGlvbiBnZXR0ZXIob2JqLCBwYXRoLCBiaW5kRm5Ub1Njb3BlKSB7CiAgICBpZiAoIXBhdGgpIHJldHVybiBvYmo7CiAgICB2YXIga2V5cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgIHZhciBrZXk7CiAgICB2YXIgbGFzdEluc3RhbmNlID0gb2JqOwogICAgdmFyIGxlbiA9IGtleXMubGVuZ3RoOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgaWYgKG9iaikgewogICAgICAgIG9iaiA9IChsYXN0SW5zdGFuY2UgPSBvYmopW2tleV07CiAgICAgIH0KICAgIH0KICAgIGlmICghYmluZEZuVG9TY29wZSAmJiBpc0Z1bmN0aW9uKG9iaikpIHsKICAgICAgcmV0dXJuIGJpbmQobGFzdEluc3RhbmNlLCBvYmopOwogICAgfQogICAgcmV0dXJuIG9iajsKICB9CgogIC8qKgogICAqIFJldHVybiB0aGUgRE9NIHNpYmxpbmdzIGJldHdlZW4gdGhlIGZpcnN0IGFuZCBsYXN0IG5vZGUgaW4gdGhlIGdpdmVuIGFycmF5LgogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IGxpa2Ugb2JqZWN0CiAgICogQHJldHVybnMge0RPTUVsZW1lbnR9IG9iamVjdCBjb250YWluaW5nIHRoZSBlbGVtZW50cwogICAqLwogIGZ1bmN0aW9uIGdldEJsb2NrRWxlbWVudHMobm9kZXMpIHsKICAgIHZhciBzdGFydE5vZGUgPSBub2Rlc1swXSwKICAgICAgZW5kTm9kZSA9IG5vZGVzW25vZGVzLmxlbmd0aCAtIDFdOwogICAgaWYgKHN0YXJ0Tm9kZSA9PT0gZW5kTm9kZSkgewogICAgICByZXR1cm4ganFMaXRlKHN0YXJ0Tm9kZSk7CiAgICB9CgogICAgdmFyIGVsZW1lbnQgPSBzdGFydE5vZGU7CiAgICB2YXIgZWxlbWVudHMgPSBbZWxlbWVudF07CgogICAgZG8gewogICAgICBlbGVtZW50ID0gZWxlbWVudC5uZXh0U2libGluZzsKICAgICAgaWYgKCFlbGVtZW50KSBicmVhazsKICAgICAgZWxlbWVudHMucHVzaChlbGVtZW50KTsKICAgIH0gd2hpbGUgKGVsZW1lbnQgIT09IGVuZE5vZGUpOwoKICAgIHJldHVybiBqcUxpdGUoZWxlbWVudHMpOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIHR5cGUKICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZQogICAqIEBtb2R1bGUgbmcKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIEludGVyZmFjZSBmb3IgY29uZmlndXJpbmcgYW5ndWxhciB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30uCiAgICovCgogIGZ1bmN0aW9uIHNldHVwTW9kdWxlTG9hZGVyKHdpbmRvdykgewoKICAgIHZhciAkaW5qZWN0b3JNaW5FcnIgPSBtaW5FcnIoJyRpbmplY3RvcicpOwogICAgdmFyIG5nTWluRXJyID0gbWluRXJyKCduZycpOwoKICAgIGZ1bmN0aW9uIGVuc3VyZShvYmosIG5hbWUsIGZhY3RvcnkpIHsKICAgICAgcmV0dXJuIG9ialtuYW1lXSB8fCAob2JqW25hbWVdID0gZmFjdG9yeSgpKTsKICAgIH0KCiAgICB2YXIgYW5ndWxhciA9IGVuc3VyZSh3aW5kb3csICdhbmd1bGFyJywgT2JqZWN0KTsKCiAgICAvLyBXZSBuZWVkIHRvIGV4cG9zZSBgYW5ndWxhci4kJG1pbkVycmAgdG8gbW9kdWxlcyBzdWNoIGFzIGBuZ1Jlc291cmNlYCB0aGF0IHJlZmVyZW5jZSBpdCBkdXJpbmcgYm9vdHN0cmFwCiAgICBhbmd1bGFyLiQkbWluRXJyID0gYW5ndWxhci4kJG1pbkVyciB8fCBtaW5FcnI7CgogICAgcmV0dXJuIGVuc3VyZShhbmd1bGFyLCAnbW9kdWxlJywgZnVuY3Rpb24oKSB7CiAgICAgIC8qKiBAdHlwZSB7T2JqZWN0LjxzdHJpbmcsIGFuZ3VsYXIuTW9kdWxlPn0gKi8KICAgICAgdmFyIG1vZHVsZXMgPSB7fTsKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICogQG5hbWUgYW5ndWxhci5tb2R1bGUKICAgICAgICogQG1vZHVsZSBuZwogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICoKICAgICAgICogVGhlIGBhbmd1bGFyLm1vZHVsZWAgaXMgYSBnbG9iYWwgcGxhY2UgZm9yIGNyZWF0aW5nLCByZWdpc3RlcmluZyBhbmQgcmV0cmlldmluZyBBbmd1bGFyCiAgICAgICAqIG1vZHVsZXMuCiAgICAgICAqIEFsbCBtb2R1bGVzIChhbmd1bGFyIGNvcmUgb3IgM3JkIHBhcnR5KSB0aGF0IHNob3VsZCBiZSBhdmFpbGFibGUgdG8gYW4gYXBwbGljYXRpb24gbXVzdCBiZQogICAgICAgKiByZWdpc3RlcmVkIHVzaW5nIHRoaXMgbWVjaGFuaXNtLgogICAgICAgKgogICAgICAgKiBXaGVuIHBhc3NlZCB0d28gb3IgbW9yZSBhcmd1bWVudHMsIGEgbmV3IG1vZHVsZSBpcyBjcmVhdGVkLiAgSWYgcGFzc2VkIG9ubHkgb25lIGFyZ3VtZW50LCBhbgogICAgICAgKiBleGlzdGluZyBtb2R1bGUgKHRoZSBuYW1lIHBhc3NlZCBhcyB0aGUgZmlyc3QgYXJndW1lbnQgdG8gYG1vZHVsZWApIGlzIHJldHJpZXZlZC4KICAgICAgICoKICAgICAgICoKICAgICAgICogIyBNb2R1bGUKICAgICAgICoKICAgICAgICogQSBtb2R1bGUgaXMgYSBjb2xsZWN0aW9uIG9mIHNlcnZpY2VzLCBkaXJlY3RpdmVzLCBmaWx0ZXJzLCBhbmQgY29uZmlndXJhdGlvbiBpbmZvcm1hdGlvbi4KICAgICAgICogYGFuZ3VsYXIubW9kdWxlYCBpcyB1c2VkIHRvIGNvbmZpZ3VyZSB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0uCiAgICAgICAqCiAgICAgICAqIGBgYGpzCiAgICAgICAqIC8vIENyZWF0ZSBhIG5ldyBtb2R1bGUKICAgICAgICogdmFyIG15TW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ215TW9kdWxlJywgW10pOwogICAgICAgKgogICAgICAgKiAvLyByZWdpc3RlciBhIG5ldyBzZXJ2aWNlCiAgICAgICAqIG15TW9kdWxlLnZhbHVlKCdhcHBOYW1lJywgJ015Q29vbEFwcCcpOwogICAgICAgKgogICAgICAgKiAvLyBjb25maWd1cmUgZXhpc3Rpbmcgc2VydmljZXMgaW5zaWRlIGluaXRpYWxpemF0aW9uIGJsb2Nrcy4KICAgICAgICogbXlNb2R1bGUuY29uZmlnKFsnJGxvY2F0aW9uUHJvdmlkZXInLCBmdW5jdGlvbigkbG9jYXRpb25Qcm92aWRlcikgewogICAgICogICAvLyBDb25maWd1cmUgZXhpc3RpbmcgcHJvdmlkZXJzCiAgICAgKiAgICRsb2NhdGlvblByb3ZpZGVyLmhhc2hQcmVmaXgoJyEnKTsKICAgICAqIH1dKTsKICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqIFRoZW4geW91IGNhbiBjcmVhdGUgYW4gaW5qZWN0b3IgYW5kIGxvYWQgeW91ciBtb2R1bGVzIGxpa2UgdGhpczoKICAgICAgICoKICAgICAgICogYGBganMKICAgICAgICogdmFyIGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcihbJ25nJywgJ215TW9kdWxlJ10pCiAgICAgICAqIGBgYAogICAgICAgKgogICAgICAgKiBIb3dldmVyIGl0J3MgbW9yZSBsaWtlbHkgdGhhdCB5b3UnbGwganVzdCB1c2UKICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0FwcCBuZ0FwcH0gb3IKICAgICAgICoge0BsaW5rIGFuZ3VsYXIuYm9vdHN0cmFwfSB0byBzaW1wbGlmeSB0aGlzIHByb2Nlc3MgZm9yIHlvdS4KICAgICAgICoKICAgICAgICogQHBhcmFtIHshc3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBtb2R1bGUgdG8gY3JlYXRlIG9yIHJldHJpZXZlLgogICAgICAgPDw8PDwqIEBwYXJhbSB7IUFycmF5LjxzdHJpbmc+PX0gcmVxdWlyZXMgSWYgc3BlY2lmaWVkIHRoZW4gbmV3IG1vZHVsZSBpcyBiZWluZyBjcmVhdGVkLiBJZgogICAgICAgPj4+Pj4qICAgICAgICB1bnNwZWNpZmllZCB0aGVuIHRoZSBtb2R1bGUgaXMgYmVpbmcgcmV0cmlldmVkIGZvciBmdXJ0aGVyIGNvbmZpZ3VyYXRpb24uCiAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZ0ZuIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gZm9yIHRoZSBtb2R1bGUuIFNhbWUgYXMKICAgICAgICogICAgICAgIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb25maWcgTW9kdWxlI2NvbmZpZygpfS4KICAgICAgICogQHJldHVybnMge21vZHVsZX0gbmV3IG1vZHVsZSB3aXRoIHRoZSB7QGxpbmsgYW5ndWxhci5Nb2R1bGV9IGFwaS4KICAgICAgICovCiAgICAgIHJldHVybiBmdW5jdGlvbiBtb2R1bGUobmFtZSwgcmVxdWlyZXMsIGNvbmZpZ0ZuKSB7CiAgICAgICAgdmFyIGFzc2VydE5vdEhhc093blByb3BlcnR5ID0gZnVuY3Rpb24obmFtZSwgY29udGV4dCkgewogICAgICAgICAgaWYgKG5hbWUgPT09ICdoYXNPd25Qcm9wZXJ0eScpIHsKICAgICAgICAgICAgdGhyb3cgbmdNaW5FcnIoJ2JhZG5hbWUnLCAnaGFzT3duUHJvcGVydHkgaXMgbm90IGEgdmFsaWQgezB9IG5hbWUnLCBjb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCAnbW9kdWxlJyk7CiAgICAgICAgaWYgKHJlcXVpcmVzICYmIG1vZHVsZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgIG1vZHVsZXNbbmFtZV0gPSBudWxsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZW5zdXJlKG1vZHVsZXMsIG5hbWUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKCFyZXF1aXJlcykgewogICAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ25vbW9kJywgIk1vZHVsZSAnezB9JyBpcyBub3QgYXZhaWxhYmxlISBZb3UgZWl0aGVyIG1pc3NwZWxsZWQgIiArCiAgICAgICAgICAgICAgInRoZSBtb2R1bGUgbmFtZSBvciBmb3Jnb3QgdG8gbG9hZCBpdC4gSWYgcmVnaXN0ZXJpbmcgYSBtb2R1bGUgZW5zdXJlIHRoYXQgeW91ICIgKwogICAgICAgICAgICAgICJzcGVjaWZ5IHRoZSBkZXBlbmRlbmNpZXMgYXMgdGhlIHNlY29uZCBhcmd1bWVudC4iLCBuYW1lKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvKiogQHR5cGUgeyFBcnJheS48QXJyYXkuPCo+Pn0gKi8KICAgICAgICAgIHZhciBpbnZva2VRdWV1ZSA9IFtdOwoKICAgICAgICAgIC8qKiBAdHlwZSB7IUFycmF5LjxGdW5jdGlvbj59ICovCiAgICAgICAgICB2YXIgcnVuQmxvY2tzID0gW107CgogICAgICAgICAgdmFyIGNvbmZpZyA9IGludm9rZUxhdGVyKCckaW5qZWN0b3InLCAnaW52b2tlJyk7CgogICAgICAgICAgLyoqIEB0eXBlIHthbmd1bGFyLk1vZHVsZX0gKi8KICAgICAgICAgIHZhciBtb2R1bGVJbnN0YW5jZSA9IHsKICAgICAgICAgICAgLy8gUHJpdmF0ZSBzdGF0ZQogICAgICAgICAgICBfaW52b2tlUXVldWU6IGludm9rZVF1ZXVlLAogICAgICAgICAgICBfcnVuQmxvY2tzOiBydW5CbG9ja3MsCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3JlcXVpcmVzCiAgICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAgICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fSBMaXN0IG9mIG1vZHVsZSBuYW1lcyB3aGljaCBtdXN0IGJlIGxvYWRlZCBiZWZvcmUgdGhpcyBtb2R1bGUuCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBIb2xkcyB0aGUgbGlzdCBvZiBtb2R1bGVzIHdoaWNoIHRoZSBpbmplY3RvciB3aWxsIGxvYWQgYmVmb3JlIHRoZSBjdXJyZW50IG1vZHVsZSBpcwogICAgICAgICAgICAgKiBsb2FkZWQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZXF1aXJlczogcmVxdWlyZXMsCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI25hbWUKICAgICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBOYW1lIG9mIHRoZSBtb2R1bGUuCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgbmFtZTogbmFtZSwKCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNwcm92aWRlcgogICAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcm92aWRlclR5cGUgQ29uc3RydWN0aW9uIGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgdGhlCiAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlLgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2VlIHtAbGluayBhdXRvLiRwcm92aWRlI3Byb3ZpZGVyICRwcm92aWRlLnByb3ZpZGVyKCl9LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcHJvdmlkZXI6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdwcm92aWRlcicpLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmFjdG9yeQogICAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcm92aWRlckZ1bmN0aW9uIEZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2UuCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTZWUge0BsaW5rIGF1dG8uJHByb3ZpZGUjZmFjdG9yeSAkcHJvdmlkZS5mYWN0b3J5KCl9LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZmFjdG9yeTogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ2ZhY3RvcnknKSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3NlcnZpY2UKICAgICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBzZXJ2aWNlIG5hbWUKICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQSBjb25zdHJ1Y3RvciBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgaW5zdGFudGlhdGVkLgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2VlIHtAbGluayBhdXRvLiRwcm92aWRlI3NlcnZpY2UgJHByb3ZpZGUuc2VydmljZSgpfS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHNlcnZpY2U6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICdzZXJ2aWNlJyksCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSN2YWx1ZQogICAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgKiBAcGFyYW0geyp9IG9iamVjdCBTZXJ2aWNlIGluc3RhbmNlIG9iamVjdC4KICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgYXV0by4kcHJvdmlkZSN2YWx1ZSAkcHJvdmlkZS52YWx1ZSgpfS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHZhbHVlOiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAndmFsdWUnKSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbnN0YW50CiAgICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgY29uc3RhbnQgbmFtZQogICAgICAgICAgICAgKiBAcGFyYW0geyp9IG9iamVjdCBDb25zdGFudCB2YWx1ZS4KICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIEJlY2F1c2UgdGhlIGNvbnN0YW50IGFyZSBmaXhlZCwgdGhleSBnZXQgYXBwbGllZCBiZWZvcmUgb3RoZXIgcHJvdmlkZSBtZXRob2RzLgogICAgICAgICAgICAgKiBTZWUge0BsaW5rIGF1dG8uJHByb3ZpZGUjY29uc3RhbnQgJHByb3ZpZGUuY29uc3RhbnQoKX0uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjb25zdGFudDogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ2NvbnN0YW50JywgJ3Vuc2hpZnQnKSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2FuaW1hdGlvbgogICAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIGFuaW1hdGlvbiBuYW1lCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGFuaW1hdGlvbkZhY3RvcnkgRmFjdG9yeSBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIGFuCiAgICAgICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uLgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogKipOT1RFKio6IGFuaW1hdGlvbnMgdGFrZSBlZmZlY3Qgb25seSBpZiB0aGUgKipuZ0FuaW1hdGUqKiBtb2R1bGUgaXMgbG9hZGVkLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBEZWZpbmVzIGFuIGFuaW1hdGlvbiBob29rIHRoYXQgY2FuIGJlIGxhdGVyIHVzZWQgd2l0aAogICAgICAgICAgICAgKiB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlICRhbmltYXRlfSBzZXJ2aWNlIGFuZCBkaXJlY3RpdmVzIHRoYXQgdXNlIHRoaXMgc2VydmljZS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogYGBganMKICAgICAgICAgICAgICogbW9kdWxlLmFuaW1hdGlvbignLmFuaW1hdGlvbi1uYW1lJywgZnVuY3Rpb24oJGluamVjdDEsICRpbmplY3QyKSB7CiAgICAgICAgICAgKiAgIHJldHVybiB7CiAgICAgICAgICAgKiAgICAgZXZlbnROYW1lIDogZnVuY3Rpb24oZWxlbWVudCwgZG9uZSkgewogICAgICAgICAgICogICAgICAgLy9jb2RlIHRvIHJ1biB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgKiAgICAgICAvL29uY2UgY29tcGxldGUsIHRoZW4gcnVuIGRvbmUoKQogICAgICAgICAgICogICAgICAgcmV0dXJuIGZ1bmN0aW9uIGNhbmNlbGxhdGlvbkZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAqICAgICAgICAgLy9jb2RlIHRvIGNhbmNlbCB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgKiAgICAgICB9CiAgICAgICAgICAgKiAgICAgfQogICAgICAgICAgICogICB9CiAgICAgICAgICAgKiB9KQogICAgICAgICAgICAgKiBgYGAKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogU2VlIHtAbGluayBuZ0FuaW1hdGUuJGFuaW1hdGVQcm92aWRlciNyZWdpc3RlciAkYW5pbWF0ZVByb3ZpZGVyLnJlZ2lzdGVyKCl9IGFuZAogICAgICAgICAgICAgKiB7QGxpbmsgbmdBbmltYXRlIG5nQW5pbWF0ZSBtb2R1bGV9IGZvciBtb3JlIGluZm9ybWF0aW9uLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgYW5pbWF0aW9uOiBpbnZva2VMYXRlcignJGFuaW1hdGVQcm92aWRlcicsICdyZWdpc3RlcicpLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZmlsdGVyCiAgICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRmlsdGVyIG5hbWUuCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZpbHRlckZhY3RvcnkgRmFjdG9yeSBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mIGZpbHRlci4KICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGZpbHRlclByb3ZpZGVyI3JlZ2lzdGVyICRmaWx0ZXJQcm92aWRlci5yZWdpc3RlcigpfS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGZpbHRlcjogaW52b2tlTGF0ZXIoJyRmaWx0ZXJQcm92aWRlcicsICdyZWdpc3RlcicpLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29udHJvbGxlcgogICAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdH0gbmFtZSBDb250cm9sbGVyIG5hbWUsIG9yIGFuIG9iamVjdCBtYXAgb2YgY29udHJvbGxlcnMgd2hlcmUgdGhlCiAgICAgICAgICAgICAqICAgIGtleXMgYXJlIHRoZSBuYW1lcyBhbmQgdGhlIHZhbHVlcyBhcmUgdGhlIGNvbnN0cnVjdG9ycy4KICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQ29udHJvbGxlciBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGNvbnRyb2xsZXJQcm92aWRlciNyZWdpc3RlciAkY29udHJvbGxlclByb3ZpZGVyLnJlZ2lzdGVyKCl9LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY29udHJvbGxlcjogaW52b2tlTGF0ZXIoJyRjb250cm9sbGVyUHJvdmlkZXInLCAncmVnaXN0ZXInKSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2RpcmVjdGl2ZQogICAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdH0gbmFtZSBEaXJlY3RpdmUgbmFtZSwgb3IgYW4gb2JqZWN0IG1hcCBvZiBkaXJlY3RpdmVzIHdoZXJlIHRoZQogICAgICAgICAgICAgKiAgICBrZXlzIGFyZSB0aGUgbmFtZXMgYW5kIHRoZSB2YWx1ZXMgYXJlIHRoZSBmYWN0b3JpZXMuCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGRpcmVjdGl2ZUZhY3RvcnkgRmFjdG9yeSBmdW5jdGlvbiBmb3IgY3JlYXRpbmcgbmV3IGluc3RhbmNlIG9mCiAgICAgICAgICAgICAqIGRpcmVjdGl2ZXMuCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlICRjb21waWxlUHJvdmlkZXIuZGlyZWN0aXZlKCl9LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZGlyZWN0aXZlOiBpbnZva2VMYXRlcignJGNvbXBpbGVQcm92aWRlcicsICdkaXJlY3RpdmUnKSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZwogICAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZ0ZuIEV4ZWN1dGUgdGhpcyBmdW5jdGlvbiBvbiBtb2R1bGUgbG9hZC4gVXNlZnVsIGZvciBzZXJ2aWNlCiAgICAgICAgICAgICAqICAgIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBVc2UgdGhpcyBtZXRob2QgdG8gcmVnaXN0ZXIgd29yayB3aGljaCBuZWVkcyB0byBiZSBwZXJmb3JtZWQgb24gbW9kdWxlIGxvYWRpbmcuCiAgICAgICAgICAgICAqIEZvciBtb3JlIGFib3V0IGhvdyB0byBjb25maWd1cmUgc2VydmljZXMsIHNlZQogICAgICAgICAgICAgKiB7QGxpbmsgcHJvdmlkZXJzI3Byb3ZpZGVyc19wcm92aWRlci1yZWNpcGUgUHJvdmlkZXIgUmVjaXBlfS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNvbmZpZzogY29uZmlnLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjcnVuCiAgICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gaW5pdGlhbGl6YXRpb25GbiBFeGVjdXRlIHRoaXMgZnVuY3Rpb24gYWZ0ZXIgaW5qZWN0b3IgY3JlYXRpb24uCiAgICAgICAgICAgICAqICAgIFVzZWZ1bCBmb3IgYXBwbGljYXRpb24gaW5pdGlhbGl6YXRpb24uCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBVc2UgdGhpcyBtZXRob2QgdG8gcmVnaXN0ZXIgd29yayB3aGljaCBzaG91bGQgYmUgcGVyZm9ybWVkIHdoZW4gdGhlIGluamVjdG9yIGlzIGRvbmUKICAgICAgICAgICAgICogbG9hZGluZyBhbGwgbW9kdWxlcy4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJ1bjogZnVuY3Rpb24oYmxvY2spIHsKICAgICAgICAgICAgICBydW5CbG9ja3MucHVzaChibG9jayk7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgaWYgKGNvbmZpZ0ZuKSB7CiAgICAgICAgICAgIGNvbmZpZyhjb25maWdGbik7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuICBtb2R1bGVJbnN0YW5jZTsKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm92aWRlcgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZAogICAgICAgICAgICogQHBhcmFtIHtTdHJpbmc9fSBpbnNlcnRNZXRob2QKICAgICAgICAgICAqIEByZXR1cm5zIHthbmd1bGFyLk1vZHVsZX0KICAgICAgICAgICAqLwogICAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF0ZXIocHJvdmlkZXIsIG1ldGhvZCwgaW5zZXJ0TWV0aG9kKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpbnZva2VRdWV1ZVtpbnNlcnRNZXRob2QgfHwgJ3B1c2gnXShbcHJvdmlkZXIsIG1ldGhvZCwgYXJndW1lbnRzXSk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZUluc3RhbmNlOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9OwogICAgfSk7CgogIH0KCiAgLyogZ2xvYmFsCiAgIGFuZ3VsYXJNb2R1bGU6IHRydWUsCiAgIHZlcnNpb246IHRydWUsCgogICAkTG9jYWxlUHJvdmlkZXIsCiAgICRDb21waWxlUHJvdmlkZXIsCgogICBodG1sQW5jaG9yRGlyZWN0aXZlLAogICBpbnB1dERpcmVjdGl2ZSwKICAgaW5wdXREaXJlY3RpdmUsCiAgIGZvcm1EaXJlY3RpdmUsCiAgIHNjcmlwdERpcmVjdGl2ZSwKICAgc2VsZWN0RGlyZWN0aXZlLAogICBzdHlsZURpcmVjdGl2ZSwKICAgb3B0aW9uRGlyZWN0aXZlLAogICBuZ0JpbmREaXJlY3RpdmUsCiAgIG5nQmluZEh0bWxEaXJlY3RpdmUsCiAgIG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlLAogICBuZ0NsYXNzRGlyZWN0aXZlLAogICBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSwKICAgbmdDbGFzc09kZERpcmVjdGl2ZSwKICAgbmdDc3BEaXJlY3RpdmUsCiAgIG5nQ2xvYWtEaXJlY3RpdmUsCiAgIG5nQ29udHJvbGxlckRpcmVjdGl2ZSwKICAgbmdGb3JtRGlyZWN0aXZlLAogICBuZ0hpZGVEaXJlY3RpdmUsCiAgIG5nSWZEaXJlY3RpdmUsCiAgIG5nSW5jbHVkZURpcmVjdGl2ZSwKICAgbmdJbmNsdWRlRmlsbENvbnRlbnREaXJlY3RpdmUsCiAgIG5nSW5pdERpcmVjdGl2ZSwKICAgbmdOb25CaW5kYWJsZURpcmVjdGl2ZSwKICAgbmdQbHVyYWxpemVEaXJlY3RpdmUsCiAgIG5nUmVwZWF0RGlyZWN0aXZlLAogICBuZ1Nob3dEaXJlY3RpdmUsCiAgIG5nU3R5bGVEaXJlY3RpdmUsCiAgIG5nU3dpdGNoRGlyZWN0aXZlLAogICBuZ1N3aXRjaFdoZW5EaXJlY3RpdmUsCiAgIG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSwKICAgbmdPcHRpb25zRGlyZWN0aXZlLAogICBuZ1RyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgIG5nTW9kZWxEaXJlY3RpdmUsCiAgIG5nTGlzdERpcmVjdGl2ZSwKICAgbmdDaGFuZ2VEaXJlY3RpdmUsCiAgIHJlcXVpcmVkRGlyZWN0aXZlLAogICByZXF1aXJlZERpcmVjdGl2ZSwKICAgbmdWYWx1ZURpcmVjdGl2ZSwKICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXMsCiAgIG5nRXZlbnREaXJlY3RpdmVzLAoKICAgJEFuY2hvclNjcm9sbFByb3ZpZGVyLAogICAkQW5pbWF0ZVByb3ZpZGVyLAogICAkQnJvd3NlclByb3ZpZGVyLAogICAkQ2FjaGVGYWN0b3J5UHJvdmlkZXIsCiAgICRDb250cm9sbGVyUHJvdmlkZXIsCiAgICREb2N1bWVudFByb3ZpZGVyLAogICAkRXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyLAogICAkRmlsdGVyUHJvdmlkZXIsCiAgICRJbnRlcnBvbGF0ZVByb3ZpZGVyLAogICAkSW50ZXJ2YWxQcm92aWRlciwKICAgJEh0dHBQcm92aWRlciwKICAgJEh0dHBCYWNrZW5kUHJvdmlkZXIsCiAgICRMb2NhdGlvblByb3ZpZGVyLAogICAkTG9nUHJvdmlkZXIsCiAgICRQYXJzZVByb3ZpZGVyLAogICAkUm9vdFNjb3BlUHJvdmlkZXIsCiAgICRRUHJvdmlkZXIsCiAgICQkU2FuaXRpemVVcmlQcm92aWRlciwKICAgJFNjZVByb3ZpZGVyLAogICAkU2NlRGVsZWdhdGVQcm92aWRlciwKICAgJFNuaWZmZXJQcm92aWRlciwKICAgJFRlbXBsYXRlQ2FjaGVQcm92aWRlciwKICAgJFRpbWVvdXRQcm92aWRlciwKICAgJCRSQUZQcm92aWRlciwKICAgJCRBc3luY0NhbGxiYWNrUHJvdmlkZXIsCiAgICRXaW5kb3dQcm92aWRlcgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIGFuZ3VsYXIudmVyc2lvbgogICAqIEBtb2R1bGUgbmcKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBbiBvYmplY3QgdGhhdCBjb250YWlucyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY3VycmVudCBBbmd1bGFySlMgdmVyc2lvbi4gVGhpcyBvYmplY3QgaGFzIHRoZQogICAqIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAqCiAgICogLSBgZnVsbGAg4oCTIGB7c3RyaW5nfWAg4oCTIEZ1bGwgdmVyc2lvbiBzdHJpbmcsIHN1Y2ggYXMgIjAuOS4xOCIuCiAgICogLSBgbWFqb3JgIOKAkyBge251bWJlcn1gIOKAkyBNYWpvciB2ZXJzaW9uIG51bWJlciwgc3VjaCBhcyAiMCIuCiAgICogLSBgbWlub3JgIOKAkyBge251bWJlcn1gIOKAkyBNaW5vciB2ZXJzaW9uIG51bWJlciwgc3VjaCBhcyAiOSIuCiAgICogLSBgZG90YCDigJMgYHtudW1iZXJ9YCDigJMgRG90IHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIxOCIuCiAgICogLSBgY29kZU5hbWVgIOKAkyBge3N0cmluZ31gIOKAkyBDb2RlIG5hbWUgb2YgdGhlIHJlbGVhc2UsIHN1Y2ggYXMgImppZ2dsaW5nLWFybWZhdCIuCiAgICovCiAgdmFyIHZlcnNpb24gPSB7CiAgICBmdWxsOiAnMS4yLjE3JywgICAgLy8gYWxsIG9mIHRoZXNlIHBsYWNlaG9sZGVyIHN0cmluZ3Mgd2lsbCBiZSByZXBsYWNlZCBieSBncnVudCdzCiAgICBtYWpvcjogMSwgICAgLy8gcGFja2FnZSB0YXNrCiAgICBtaW5vcjogMiwKICAgIGRvdDogMTcsCiAgICBjb2RlTmFtZTogJ3F1YW50dW0tZGlzZW50YW5nbGVtZW50JwogIH07CgoKICBmdW5jdGlvbiBwdWJsaXNoRXh0ZXJuYWxBUEkoYW5ndWxhcil7CiAgICBleHRlbmQoYW5ndWxhciwgewogICAgICAnYm9vdHN0cmFwJzogYm9vdHN0cmFwLAogICAgICAnY29weSc6IGNvcHksCiAgICAgICdleHRlbmQnOiBleHRlbmQsCiAgICAgICdlcXVhbHMnOiBlcXVhbHMsCiAgICAgICdlbGVtZW50JzoganFMaXRlLAogICAgICAnZm9yRWFjaCc6IGZvckVhY2gsCiAgICAgICdpbmplY3Rvcic6IGNyZWF0ZUluamVjdG9yLAogICAgICAnbm9vcCc6bm9vcCwKICAgICAgJ2JpbmQnOmJpbmQsCiAgICAgICd0b0pzb24nOiB0b0pzb24sCiAgICAgICdmcm9tSnNvbic6IGZyb21Kc29uLAogICAgICAnaWRlbnRpdHknOmlkZW50aXR5LAogICAgICAnaXNVbmRlZmluZWQnOiBpc1VuZGVmaW5lZCwKICAgICAgJ2lzRGVmaW5lZCc6IGlzRGVmaW5lZCwKICAgICAgJ2lzU3RyaW5nJzogaXNTdHJpbmcsCiAgICAgICdpc0Z1bmN0aW9uJzogaXNGdW5jdGlvbiwKICAgICAgJ2lzT2JqZWN0JzogaXNPYmplY3QsCiAgICAgICdpc051bWJlcic6IGlzTnVtYmVyLAogICAgICAnaXNFbGVtZW50JzogaXNFbGVtZW50LAogICAgICAnaXNBcnJheSc6IGlzQXJyYXksCiAgICAgICd2ZXJzaW9uJzogdmVyc2lvbiwKICAgICAgJ2lzRGF0ZSc6IGlzRGF0ZSwKICAgICAgJ2xvd2VyY2FzZSc6IGxvd2VyY2FzZSwKICAgICAgJ3VwcGVyY2FzZSc6IHVwcGVyY2FzZSwKICAgICAgJ2NhbGxiYWNrcyc6IHtjb3VudGVyOiAwfSwKICAgICAgJyQkbWluRXJyJzogbWluRXJyLAogICAgICAnJCRjc3AnOiBjc3AKICAgIH0pOwoKICAgIGFuZ3VsYXJNb2R1bGUgPSBzZXR1cE1vZHVsZUxvYWRlcih3aW5kb3cpOwogICAgdHJ5IHsKICAgICAgYW5ndWxhck1vZHVsZSgnbmdMb2NhbGUnKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgYW5ndWxhck1vZHVsZSgnbmdMb2NhbGUnLCBbXSkucHJvdmlkZXIoJyRsb2NhbGUnLCAkTG9jYWxlUHJvdmlkZXIpOwogICAgfQoKICAgIGFuZ3VsYXJNb2R1bGUoJ25nJywgWyduZ0xvY2FsZSddLCBbJyRwcm92aWRlJywKICAgICAgZnVuY3Rpb24gbmdNb2R1bGUoJHByb3ZpZGUpIHsKICAgICAgICAvLyAkJHNhbml0aXplVXJpUHJvdmlkZXIgbmVlZHMgdG8gYmUgYmVmb3JlICRjb21waWxlUHJvdmlkZXIgYXMgaXQgaXMgdXNlZCBieSBpdC4KICAgICAgICAkcHJvdmlkZS5wcm92aWRlcih7CiAgICAgICAgICAkJHNhbml0aXplVXJpOiAkJFNhbml0aXplVXJpUHJvdmlkZXIKICAgICAgICB9KTsKICAgICAgICAkcHJvdmlkZS5wcm92aWRlcignJGNvbXBpbGUnLCAkQ29tcGlsZVByb3ZpZGVyKS4KICAgICAgICAgIGRpcmVjdGl2ZSh7CiAgICAgICAgICAgIGE6IGh0bWxBbmNob3JEaXJlY3RpdmUsCiAgICAgICAgICAgIGlucHV0OiBpbnB1dERpcmVjdGl2ZSwKICAgICAgICAgICAgdGV4dGFyZWE6IGlucHV0RGlyZWN0aXZlLAogICAgICAgICAgICBmb3JtOiBmb3JtRGlyZWN0aXZlLAogICAgICAgICAgICBzY3JpcHQ6IHNjcmlwdERpcmVjdGl2ZSwKICAgICAgICAgICAgc2VsZWN0OiBzZWxlY3REaXJlY3RpdmUsCiAgICAgICAgICAgIHN0eWxlOiBzdHlsZURpcmVjdGl2ZSwKICAgICAgICAgICAgb3B0aW9uOiBvcHRpb25EaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQmluZDogbmdCaW5kRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0JpbmRIdG1sOiBuZ0JpbmRIdG1sRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0JpbmRUZW1wbGF0ZTogbmdCaW5kVGVtcGxhdGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQ2xhc3M6IG5nQ2xhc3NEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQ2xhc3NFdmVuOiBuZ0NsYXNzRXZlbkRpcmVjdGl2ZSwKICAgICAgICAgICAgbmdDbGFzc09kZDogbmdDbGFzc09kZERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdDbG9hazogbmdDbG9ha0RpcmVjdGl2ZSwKICAgICAgICAgICAgbmdDb250cm9sbGVyOiBuZ0NvbnRyb2xsZXJEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nRm9ybTogbmdGb3JtRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0hpZGU6IG5nSGlkZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdJZjogbmdJZkRpcmVjdGl2ZSwKICAgICAgICAgICAgbmdJbmNsdWRlOiBuZ0luY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nSW5pdDogbmdJbml0RGlyZWN0aXZlLAogICAgICAgICAgICBuZ05vbkJpbmRhYmxlOiBuZ05vbkJpbmRhYmxlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1BsdXJhbGl6ZTogbmdQbHVyYWxpemVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nUmVwZWF0OiBuZ1JlcGVhdERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdTaG93OiBuZ1Nob3dEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nU3R5bGU6IG5nU3R5bGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nU3dpdGNoOiBuZ1N3aXRjaERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdTd2l0Y2hXaGVuOiBuZ1N3aXRjaFdoZW5EaXJlY3RpdmUsCiAgICAgICAgICAgIG5nU3dpdGNoRGVmYXVsdDogbmdTd2l0Y2hEZWZhdWx0RGlyZWN0aXZlLAogICAgICAgICAgICBuZ09wdGlvbnM6IG5nT3B0aW9uc0RpcmVjdGl2ZSwKICAgICAgICAgICAgbmdUcmFuc2NsdWRlOiBuZ1RyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nTW9kZWw6IG5nTW9kZWxEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nTGlzdDogbmdMaXN0RGlyZWN0aXZlLAogICAgICAgICAgICBuZ0NoYW5nZTogbmdDaGFuZ2VEaXJlY3RpdmUsCiAgICAgICAgICAgIHJlcXVpcmVkOiByZXF1aXJlZERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdSZXF1aXJlZDogcmVxdWlyZWREaXJlY3RpdmUsCiAgICAgICAgICAgIG5nVmFsdWU6IG5nVmFsdWVEaXJlY3RpdmUKICAgICAgICAgIH0pLgogICAgICAgICAgZGlyZWN0aXZlKHsKICAgICAgICAgICAgbmdJbmNsdWRlOiBuZ0luY2x1ZGVGaWxsQ29udGVudERpcmVjdGl2ZQogICAgICAgICAgfSkuCiAgICAgICAgICBkaXJlY3RpdmUobmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXMpLgogICAgICAgICAgZGlyZWN0aXZlKG5nRXZlbnREaXJlY3RpdmVzKTsKICAgICAgICAkcHJvdmlkZS5wcm92aWRlcih7CiAgICAgICAgICAkYW5jaG9yU2Nyb2xsOiAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgICAgICAgICAkYW5pbWF0ZTogJEFuaW1hdGVQcm92aWRlciwKICAgICAgICAgICRicm93c2VyOiAkQnJvd3NlclByb3ZpZGVyLAogICAgICAgICAgJGNhY2hlRmFjdG9yeTogJENhY2hlRmFjdG9yeVByb3ZpZGVyLAogICAgICAgICAgJGNvbnRyb2xsZXI6ICRDb250cm9sbGVyUHJvdmlkZXIsCiAgICAgICAgICAkZG9jdW1lbnQ6ICREb2N1bWVudFByb3ZpZGVyLAogICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXI6ICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgICAgICAgICAkZmlsdGVyOiAkRmlsdGVyUHJvdmlkZXIsCiAgICAgICAgICAkaW50ZXJwb2xhdGU6ICRJbnRlcnBvbGF0ZVByb3ZpZGVyLAogICAgICAgICAgJGludGVydmFsOiAkSW50ZXJ2YWxQcm92aWRlciwKICAgICAgICAgICRodHRwOiAkSHR0cFByb3ZpZGVyLAogICAgICAgICAgJGh0dHBCYWNrZW5kOiAkSHR0cEJhY2tlbmRQcm92aWRlciwKICAgICAgICAgICRsb2NhdGlvbjogJExvY2F0aW9uUHJvdmlkZXIsCiAgICAgICAgICAkbG9nOiAkTG9nUHJvdmlkZXIsCiAgICAgICAgICAkcGFyc2U6ICRQYXJzZVByb3ZpZGVyLAogICAgICAgICAgJHJvb3RTY29wZTogJFJvb3RTY29wZVByb3ZpZGVyLAogICAgICAgICAgJHE6ICRRUHJvdmlkZXIsCiAgICAgICAgICAkc2NlOiAkU2NlUHJvdmlkZXIsCiAgICAgICAgICAkc2NlRGVsZWdhdGU6ICRTY2VEZWxlZ2F0ZVByb3ZpZGVyLAogICAgICAgICAgJHNuaWZmZXI6ICRTbmlmZmVyUHJvdmlkZXIsCiAgICAgICAgICAkdGVtcGxhdGVDYWNoZTogJFRlbXBsYXRlQ2FjaGVQcm92aWRlciwKICAgICAgICAgICR0aW1lb3V0OiAkVGltZW91dFByb3ZpZGVyLAogICAgICAgICAgJHdpbmRvdzogJFdpbmRvd1Byb3ZpZGVyLAogICAgICAgICAgJCRyQUY6ICQkUkFGUHJvdmlkZXIsCiAgICAgICAgICAkJGFzeW5jQ2FsbGJhY2sgOiAkJEFzeW5jQ2FsbGJhY2tQcm92aWRlcgogICAgICAgIH0pOwogICAgICB9CiAgICBdKTsKICB9CgogIC8qIGdsb2JhbAoKICAgLUpRTGl0ZVByb3RvdHlwZSwKICAgLWFkZEV2ZW50TGlzdGVuZXJGbiwKICAgLXJlbW92ZUV2ZW50TGlzdGVuZXJGbiwKICAgLUJPT0xFQU5fQVRUUgogICAqLwoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovL0pRTGl0ZQovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuZWxlbWVudAogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogV3JhcHMgYSByYXcgRE9NIGVsZW1lbnQgb3IgSFRNTCBzdHJpbmcgYXMgYSBbalF1ZXJ5XShodHRwOi8vanF1ZXJ5LmNvbSkgZWxlbWVudC4KICAgKgogICAqIElmIGpRdWVyeSBpcyBhdmFpbGFibGUsIGBhbmd1bGFyLmVsZW1lbnRgIGlzIGFuIGFsaWFzIGZvciB0aGUKICAgKiBbalF1ZXJ5XShodHRwOi8vYXBpLmpxdWVyeS5jb20valF1ZXJ5LykgZnVuY3Rpb24uIElmIGpRdWVyeSBpcyBub3QgYXZhaWxhYmxlLCBgYW5ndWxhci5lbGVtZW50YAogICAqIGRlbGVnYXRlcyB0byBBbmd1bGFyJ3MgYnVpbHQtaW4gc3Vic2V0IG9mIGpRdWVyeSwgY2FsbGVkICJqUXVlcnkgbGl0ZSIgb3IgImpxTGl0ZS4iCiAgICoKICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1zdWNjZXNzIj5qcUxpdGUgaXMgYSB0aW55LCBBUEktY29tcGF0aWJsZSBzdWJzZXQgb2YgalF1ZXJ5IHRoYXQgYWxsb3dzCiAgICogQW5ndWxhciB0byBtYW5pcHVsYXRlIHRoZSBET00gaW4gYSBjcm9zcy1icm93c2VyIGNvbXBhdGlibGUgd2F5LiAqKmpxTGl0ZSoqIGltcGxlbWVudHMgb25seSB0aGUgbW9zdAogICAqIGNvbW1vbmx5IG5lZWRlZCBmdW5jdGlvbmFsaXR5IHdpdGggdGhlIGdvYWwgb2YgaGF2aW5nIGEgdmVyeSBzbWFsbCBmb290cHJpbnQuPC9kaXY+CiAgICoKICAgKiBUbyB1c2UgalF1ZXJ5LCBzaW1wbHkgbG9hZCBpdCBiZWZvcmUgYERPTUNvbnRlbnRMb2FkZWRgIGV2ZW50IGZpcmVkLgogICAqCiAgICogPGRpdiBjbGFzcz0iYWxlcnQiPioqTm90ZToqKiBhbGwgZWxlbWVudCByZWZlcmVuY2VzIGluIEFuZ3VsYXIgYXJlIGFsd2F5cyB3cmFwcGVkIHdpdGggalF1ZXJ5IG9yCiAgICoganFMaXRlOyB0aGV5IGFyZSBuZXZlciByYXcgRE9NIHJlZmVyZW5jZXMuPC9kaXY+CiAgICoKICAgKiAjIyBBbmd1bGFyJ3MganFMaXRlCiAgICoganFMaXRlIHByb3ZpZGVzIG9ubHkgdGhlIGZvbGxvd2luZyBqUXVlcnkgbWV0aG9kczoKICAgKgogICAqIC0gW2BhZGRDbGFzcygpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FkZENsYXNzLykKICAgKiAtIFtgYWZ0ZXIoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hZnRlci8pCiAgICogLSBbYGFwcGVuZCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FwcGVuZC8pCiAgICogLSBbYGF0dHIoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9hdHRyLykKICAgKiAtIFtgYmluZCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2JpbmQvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcywgc2VsZWN0b3JzIG9yIGV2ZW50RGF0YQogICAqIC0gW2BjaGlsZHJlbigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2NoaWxkcmVuLykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogICAqIC0gW2BjbG9uZSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2Nsb25lLykKICAgKiAtIFtgY29udGVudHMoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9jb250ZW50cy8pCiAgICogLSBbYGNzcygpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2Nzcy8pCiAgICogLSBbYGRhdGEoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9kYXRhLykKICAgKiAtIFtgZW1wdHkoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9lbXB0eS8pCiAgICogLSBbYGVxKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZXEvKQogICAqIC0gW2BmaW5kKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vZmluZC8pIC0gTGltaXRlZCB0byBsb29rdXBzIGJ5IHRhZyBuYW1lCiAgICogLSBbYGhhc0NsYXNzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaGFzQ2xhc3MvKQogICAqIC0gW2BodG1sKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vaHRtbC8pCiAgICogLSBbYG5leHQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9uZXh0LykgLSBEb2VzIG5vdCBzdXBwb3J0IHNlbGVjdG9ycwogICAqIC0gW2BvbigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29uLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMsIHNlbGVjdG9ycyBvciBldmVudERhdGEKICAgKiAtIFtgb2ZmKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vb2ZmLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMgb3Igc2VsZWN0b3JzCiAgICogLSBbYG9uZSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29uZS8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzIG9yIHNlbGVjdG9ycwogICAqIC0gW2BwYXJlbnQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wYXJlbnQvKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAgICogLSBbYHByZXBlbmQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9wcmVwZW5kLykKICAgKiAtIFtgcHJvcCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3Byb3AvKQogICAqIC0gW2ByZWFkeSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlYWR5LykKICAgKiAtIFtgcmVtb3ZlKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlLykKICAgKiAtIFtgcmVtb3ZlQXR0cigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUF0dHIvKQogICAqIC0gW2ByZW1vdmVDbGFzcygpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZUNsYXNzLykKICAgKiAtIFtgcmVtb3ZlRGF0YSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlbW92ZURhdGEvKQogICAqIC0gW2ByZXBsYWNlV2l0aCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3JlcGxhY2VXaXRoLykKICAgKiAtIFtgdGV4dCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RleHQvKQogICAqIC0gW2B0b2dnbGVDbGFzcygpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RvZ2dsZUNsYXNzLykKICAgKiAtIFtgdHJpZ2dlckhhbmRsZXIoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS90cmlnZ2VySGFuZGxlci8pIC0gUGFzc2VzIGEgZHVtbXkgZXZlbnQgb2JqZWN0IHRvIGhhbmRsZXJzLgogICAqIC0gW2B1bmJpbmQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS91bmJpbmQvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcwogICAqIC0gW2B2YWwoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS92YWwvKQogICAqIC0gW2B3cmFwKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vd3JhcC8pCiAgICoKICAgKiAjIyBqUXVlcnkvanFMaXRlIEV4dHJhcwogICAqIEFuZ3VsYXIgYWxzbyBwcm92aWRlcyB0aGUgZm9sbG93aW5nIGFkZGl0aW9uYWwgbWV0aG9kcyBhbmQgZXZlbnRzIHRvIGJvdGggalF1ZXJ5IGFuZCBqcUxpdGU6CiAgICoKICAgKiAjIyMgRXZlbnRzCiAgICogLSBgJGRlc3Ryb3lgIC0gQW5ndWxhckpTIGludGVyY2VwdHMgYWxsIGpxTGl0ZS9qUXVlcnkncyBET00gZGVzdHJ1Y3Rpb24gYXBpcyBhbmQgZmlyZXMgdGhpcyBldmVudAogICAqICAgIG9uIGFsbCBET00gbm9kZXMgYmVpbmcgcmVtb3ZlZC4gIFRoaXMgY2FuIGJlIHVzZWQgdG8gY2xlYW4gdXAgYW55IDNyZCBwYXJ0eSBiaW5kaW5ncyB0byB0aGUgRE9NCiAgICogICAgZWxlbWVudCBiZWZvcmUgaXQgaXMgcmVtb3ZlZC4KICAgKgogICAqICMjIyBNZXRob2RzCiAgICogLSBgY29udHJvbGxlcihuYW1lKWAgLSByZXRyaWV2ZXMgdGhlIGNvbnRyb2xsZXIgb2YgdGhlIGN1cnJlbnQgZWxlbWVudCBvciBpdHMgcGFyZW50LiBCeSBkZWZhdWx0CiAgICogICByZXRyaWV2ZXMgY29udHJvbGxlciBhc3NvY2lhdGVkIHdpdGggdGhlIGBuZ0NvbnRyb2xsZXJgIGRpcmVjdGl2ZS4gSWYgYG5hbWVgIGlzIHByb3ZpZGVkIGFzCiAgICogICBjYW1lbENhc2UgZGlyZWN0aXZlIG5hbWUsIHRoZW4gdGhlIGNvbnRyb2xsZXIgZm9yIHRoaXMgZGlyZWN0aXZlIHdpbGwgYmUgcmV0cmlldmVkIChlLmcuCiAgICogICBgJ25nTW9kZWwnYCkuCiAgICogLSBgaW5qZWN0b3IoKWAgLSByZXRyaWV2ZXMgdGhlIGluamVjdG9yIG9mIHRoZSBjdXJyZW50IGVsZW1lbnQgb3IgaXRzIHBhcmVudC4KICAgKiAtIGBzY29wZSgpYCAtIHJldHJpZXZlcyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9IG9mIHRoZSBjdXJyZW50CiAgICogICBlbGVtZW50IG9yIGl0cyBwYXJlbnQuCiAgICogLSBgaXNvbGF0ZVNjb3BlKClgIC0gcmV0cmlldmVzIGFuIGlzb2xhdGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9IGlmIG9uZSBpcyBhdHRhY2hlZCBkaXJlY3RseSB0byB0aGUKICAgKiAgIGN1cnJlbnQgZWxlbWVudC4gVGhpcyBnZXR0ZXIgc2hvdWxkIGJlIHVzZWQgb25seSBvbiBlbGVtZW50cyB0aGF0IGNvbnRhaW4gYSBkaXJlY3RpdmUgd2hpY2ggc3RhcnRzIGEgbmV3IGlzb2xhdGUKICAgKiAgIHNjb3BlLiBDYWxsaW5nIGBzY29wZSgpYCBvbiB0aGlzIGVsZW1lbnQgYWx3YXlzIHJldHVybnMgdGhlIG9yaWdpbmFsIG5vbi1pc29sYXRlIHNjb3BlLgogICAqIC0gYGluaGVyaXRlZERhdGEoKWAgLSBzYW1lIGFzIGBkYXRhKClgLCBidXQgd2Fsa3MgdXAgdGhlIERPTSB1bnRpbCBhIHZhbHVlIGlzIGZvdW5kIG9yIHRoZSB0b3AKICAgKiAgIHBhcmVudCBlbGVtZW50IGlzIHJlYWNoZWQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ3xET01FbGVtZW50fSBlbGVtZW50IEhUTUwgc3RyaW5nIG9yIERPTUVsZW1lbnQgdG8gYmUgd3JhcHBlZCBpbnRvIGpRdWVyeS4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBqUXVlcnkgb2JqZWN0LgogICAqLwoKICB2YXIganFDYWNoZSA9IEpRTGl0ZS5jYWNoZSA9IHt9LAogICAganFOYW1lID0gSlFMaXRlLmV4cGFuZG8gPSAnbmcnICsgbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICBqcUlkID0gMSwKICAgIGFkZEV2ZW50TGlzdGVuZXJGbiA9ICh3aW5kb3cuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcgogICAgICA/IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZuLCBmYWxzZSk7fQogICAgICA6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pO30pLAogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyCiAgICAgID8gZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTsgfQogICAgICA6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7ZWxlbWVudC5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOyB9KTsKCiAgLyoKICAgKiAhISEgVGhpcyBpcyBhbiB1bmRvY3VtZW50ZWQgInByaXZhdGUiIGZ1bmN0aW9uICEhIQogICAqLwogIHZhciBqcURhdGEgPSBKUUxpdGUuX2RhdGEgPSBmdW5jdGlvbihub2RlKSB7CiAgICAvL2pRdWVyeSBhbHdheXMgcmV0dXJucyBhbiBvYmplY3Qgb24gY2FjaGUgbWlzcwogICAgcmV0dXJuIHRoaXMuY2FjaGVbbm9kZVt0aGlzLmV4cGFuZG9dXSB8fCB7fTsKICB9OwoKICBmdW5jdGlvbiBqcU5leHRJZCgpIHsgcmV0dXJuICsranFJZDsgfQoKCiAgdmFyIFNQRUNJQUxfQ0hBUlNfUkVHRVhQID0gLyhbXDpcLVxfXSsoLikpL2c7CiAgdmFyIE1PWl9IQUNLX1JFR0VYUCA9IC9ebW96KFtBLVpdKS87CiAgdmFyIGpxTGl0ZU1pbkVyciA9IG1pbkVycignanFMaXRlJyk7CgogIC8qKgogICAqIENvbnZlcnRzIHNuYWtlX2Nhc2UgdG8gY2FtZWxDYXNlLgogICAqIEFsc28gdGhlcmUgaXMgc3BlY2lhbCBjYXNlIGZvciBNb3ogcHJlZml4IHN0YXJ0aW5nIHdpdGggdXBwZXIgY2FzZSBsZXR0ZXIuCiAgICogQHBhcmFtIG5hbWUgTmFtZSB0byBub3JtYWxpemUKICAgKi8KICBmdW5jdGlvbiBjYW1lbENhc2UobmFtZSkgewogICAgcmV0dXJuIG5hbWUuCiAgICAgIHJlcGxhY2UoU1BFQ0lBTF9DSEFSU19SRUdFWFAsIGZ1bmN0aW9uKF8sIHNlcGFyYXRvciwgbGV0dGVyLCBvZmZzZXQpIHsKICAgICAgICByZXR1cm4gb2Zmc2V0ID8gbGV0dGVyLnRvVXBwZXJDYXNlKCkgOiBsZXR0ZXI7CiAgICAgIH0pLgogICAgICByZXBsYWNlKE1PWl9IQUNLX1JFR0VYUCwgJ01veiQxJyk7CiAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIGpRdWVyeSBtdXRhdGlvbiBwYXRjaAovLwovLyBJbiBjb25qdW5jdGlvbiB3aXRoIGJpbmRKUXVlcnkgaW50ZXJjZXB0cyBhbGwgalF1ZXJ5J3MgRE9NIGRlc3RydWN0aW9uIGFwaXMgYW5kIGZpcmVzIGEKLy8gJGRlc3Ryb3kgZXZlbnQgb24gYWxsIERPTSBub2RlcyBiZWluZyByZW1vdmVkLgovLwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgZnVuY3Rpb24ganFMaXRlUGF0Y2hKUXVlcnlSZW1vdmUobmFtZSwgZGlzcGF0Y2hUaGlzLCBmaWx0ZXJFbGVtcywgZ2V0dGVySWZOb0FyZ3VtZW50cykgewogICAgdmFyIG9yaWdpbmFsSnFGbiA9IGpRdWVyeS5mbltuYW1lXTsKICAgIG9yaWdpbmFsSnFGbiA9IG9yaWdpbmFsSnFGbi4kb3JpZ2luYWwgfHwgb3JpZ2luYWxKcUZuOwogICAgcmVtb3ZlUGF0Y2guJG9yaWdpbmFsID0gb3JpZ2luYWxKcUZuOwogICAgalF1ZXJ5LmZuW25hbWVdID0gcmVtb3ZlUGF0Y2g7CgogICAgZnVuY3Rpb24gcmVtb3ZlUGF0Y2gocGFyYW0pIHsKICAgICAgLy8ganNoaW50IC1XMDQwCiAgICAgIHZhciBsaXN0ID0gZmlsdGVyRWxlbXMgJiYgcGFyYW0gPyBbdGhpcy5maWx0ZXIocGFyYW0pXSA6IFt0aGlzXSwKICAgICAgICBmaXJlRXZlbnQgPSBkaXNwYXRjaFRoaXMsCiAgICAgICAgc2V0LCBzZXRJbmRleCwgc2V0TGVuZ3RoLAogICAgICAgIGVsZW1lbnQsIGNoaWxkSW5kZXgsIGNoaWxkTGVuZ3RoLCBjaGlsZHJlbjsKCiAgICAgIGlmICghZ2V0dGVySWZOb0FyZ3VtZW50cyB8fCBwYXJhbSAhPSBudWxsKSB7CiAgICAgICAgd2hpbGUobGlzdC5sZW5ndGgpIHsKICAgICAgICAgIHNldCA9IGxpc3Quc2hpZnQoKTsKICAgICAgICAgIGZvcihzZXRJbmRleCA9IDAsIHNldExlbmd0aCA9IHNldC5sZW5ndGg7IHNldEluZGV4IDwgc2V0TGVuZ3RoOyBzZXRJbmRleCsrKSB7CiAgICAgICAgICAgIGVsZW1lbnQgPSBqcUxpdGUoc2V0W3NldEluZGV4XSk7CiAgICAgICAgICAgIGlmIChmaXJlRXZlbnQpIHsKICAgICAgICAgICAgICBlbGVtZW50LnRyaWdnZXJIYW5kbGVyKCckZGVzdHJveScpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGZpcmVFdmVudCA9ICFmaXJlRXZlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yKGNoaWxkSW5kZXggPSAwLCBjaGlsZExlbmd0aCA9IChjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGRyZW4oKSkubGVuZ3RoOwogICAgICAgICAgICAgICAgY2hpbGRJbmRleCA8IGNoaWxkTGVuZ3RoOwogICAgICAgICAgICAgICAgY2hpbGRJbmRleCsrKSB7CiAgICAgICAgICAgICAgbGlzdC5wdXNoKGpRdWVyeShjaGlsZHJlbltjaGlsZEluZGV4XSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvcmlnaW5hbEpxRm4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CgogIHZhciBTSU5HTEVfVEFHX1JFR0VYUCA9IC9ePChcdyspXHMqXC8/Pig/OjxcL1wxPnwpJC87CiAgdmFyIEhUTUxfUkVHRVhQID0gLzx8JiM/XHcrOy87CiAgdmFyIFRBR19OQU1FX1JFR0VYUCA9IC88KFtcdzpdKykvOwogIHZhciBYSFRNTF9UQUdfUkVHRVhQID0gLzwoPyFhcmVhfGJyfGNvbHxlbWJlZHxocnxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtKSgoW1x3Ol0rKVtePl0qKVwvPi9naTsKCiAgdmFyIHdyYXBNYXAgPSB7CiAgICAnb3B0aW9uJzogWzEsICc8c2VsZWN0IG11bHRpcGxlPSJtdWx0aXBsZSI+JywgJzwvc2VsZWN0PiddLAoKICAgICd0aGVhZCc6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAogICAgJ2NvbCc6IFsyLCAnPHRhYmxlPjxjb2xncm91cD4nLCAnPC9jb2xncm91cD48L3RhYmxlPiddLAogICAgJ3RyJzogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCiAgICAndGQnOiBbMywgJzx0YWJsZT48dGJvZHk+PHRyPicsICc8L3RyPjwvdGJvZHk+PC90YWJsZT4nXSwKICAgICdfZGVmYXVsdCc6IFswLCAiIiwgIiJdCiAgfTsKCiAgd3JhcE1hcC5vcHRncm91cCA9IHdyYXBNYXAub3B0aW9uOwogIHdyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CiAgd3JhcE1hcC50aCA9IHdyYXBNYXAudGQ7CgogIGZ1bmN0aW9uIGpxTGl0ZUlzVGV4dE5vZGUoaHRtbCkgewogICAgcmV0dXJuICFIVE1MX1JFR0VYUC50ZXN0KGh0bWwpOwogIH0KCiAgZnVuY3Rpb24ganFMaXRlQnVpbGRGcmFnbWVudChodG1sLCBjb250ZXh0KSB7CiAgICB2YXIgZWxlbSwgdG1wLCB0YWcsIHdyYXAsCiAgICAgIGZyYWdtZW50ID0gY29udGV4dC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgIG5vZGVzID0gW10sIGksIGosIGpqOwoKICAgIGlmIChqcUxpdGVJc1RleHROb2RlKGh0bWwpKSB7CiAgICAgIC8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQogICAgICBub2Rlcy5wdXNoKGNvbnRleHQuY3JlYXRlVGV4dE5vZGUoaHRtbCkpOwogICAgfSBlbHNlIHsKICAgICAgdG1wID0gZnJhZ21lbnQuYXBwZW5kQ2hpbGQoY29udGV4dC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7CiAgICAgIC8vIENvbnZlcnQgaHRtbCBpbnRvIERPTSBub2RlcwogICAgICB0YWcgPSAoVEFHX05BTUVfUkVHRVhQLmV4ZWMoaHRtbCkgfHwgWyIiLCAiIl0pWzFdLnRvTG93ZXJDYXNlKCk7CiAgICAgIHdyYXAgPSB3cmFwTWFwW3RhZ10gfHwgd3JhcE1hcC5fZGVmYXVsdDsKICAgICAgdG1wLmlubmVySFRNTCA9ICc8ZGl2PiYjMTYwOzwvZGl2PicgKwogICAgICAgIHdyYXBbMV0gKyBodG1sLnJlcGxhY2UoWEhUTUxfVEFHX1JFR0VYUCwgIjwkMT48LyQyPiIpICsgd3JhcFsyXTsKICAgICAgdG1wLnJlbW92ZUNoaWxkKHRtcC5maXJzdENoaWxkKTsKCiAgICAgIC8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAogICAgICBpID0gd3JhcFswXTsKICAgICAgd2hpbGUgKGktLSkgewogICAgICAgIHRtcCA9IHRtcC5sYXN0Q2hpbGQ7CiAgICAgIH0KCiAgICAgIGZvciAoaj0wLCBqaj10bXAuY2hpbGROb2Rlcy5sZW5ndGg7IGo8amo7ICsraikgbm9kZXMucHVzaCh0bXAuY2hpbGROb2Rlc1tqXSk7CgogICAgICB0bXAgPSBmcmFnbWVudC5maXJzdENoaWxkOwogICAgICB0bXAudGV4dENvbnRlbnQgPSAiIjsKICAgIH0KCiAgICAvLyBSZW1vdmUgd3JhcHBlciBmcm9tIGZyYWdtZW50CiAgICBmcmFnbWVudC50ZXh0Q29udGVudCA9ICIiOwogICAgZnJhZ21lbnQuaW5uZXJIVE1MID0gIiI7IC8vIENsZWFyIGlubmVyIEhUTUwKICAgIHJldHVybiBub2RlczsKICB9CgogIGZ1bmN0aW9uIGpxTGl0ZVBhcnNlSFRNTChodG1sLCBjb250ZXh0KSB7CiAgICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKICAgIHZhciBwYXJzZWQ7CgogICAgaWYgKChwYXJzZWQgPSBTSU5HTEVfVEFHX1JFR0VYUC5leGVjKGh0bWwpKSkgewogICAgICByZXR1cm4gW2NvbnRleHQuY3JlYXRlRWxlbWVudChwYXJzZWRbMV0pXTsKICAgIH0KCiAgICByZXR1cm4ganFMaXRlQnVpbGRGcmFnbWVudChodG1sLCBjb250ZXh0KTsKICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICBmdW5jdGlvbiBKUUxpdGUoZWxlbWVudCkgewogICAgaWYgKGVsZW1lbnQgaW5zdGFuY2VvZiBKUUxpdGUpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICB9CiAgICBpZiAoaXNTdHJpbmcoZWxlbWVudCkpIHsKICAgICAgZWxlbWVudCA9IHRyaW0oZWxlbWVudCk7CiAgICB9CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgSlFMaXRlKSkgewogICAgICBpZiAoaXNTdHJpbmcoZWxlbWVudCkgJiYgZWxlbWVudC5jaGFyQXQoMCkgIT0gJzwnKSB7CiAgICAgICAgdGhyb3cganFMaXRlTWluRXJyKCdub3NlbCcsICdMb29raW5nIHVwIGVsZW1lbnRzIHZpYSBzZWxlY3RvcnMgaXMgbm90IHN1cHBvcnRlZCBieSBqcUxpdGUhIFNlZTogaHR0cDovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvYW5ndWxhci5lbGVtZW50Jyk7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBKUUxpdGUoZWxlbWVudCk7CiAgICB9CgogICAgaWYgKGlzU3RyaW5nKGVsZW1lbnQpKSB7CiAgICAgIGpxTGl0ZUFkZE5vZGVzKHRoaXMsIGpxTGl0ZVBhcnNlSFRNTChlbGVtZW50KSk7CiAgICAgIHZhciBmcmFnbWVudCA9IGpxTGl0ZShkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCkpOwogICAgICBmcmFnbWVudC5hcHBlbmQodGhpcyk7CiAgICB9IGVsc2UgewogICAgICBqcUxpdGVBZGROb2Rlcyh0aGlzLCBlbGVtZW50KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGpxTGl0ZUNsb25lKGVsZW1lbnQpIHsKICAgIHJldHVybiBlbGVtZW50LmNsb25lTm9kZSh0cnVlKTsKICB9CgogIGZ1bmN0aW9uIGpxTGl0ZURlYWxvYyhlbGVtZW50KXsKICAgIGpxTGl0ZVJlbW92ZURhdGEoZWxlbWVudCk7CiAgICBmb3IgKCB2YXIgaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZE5vZGVzIHx8IFtdOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAganFMaXRlRGVhbG9jKGNoaWxkcmVuW2ldKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGpxTGl0ZU9mZihlbGVtZW50LCB0eXBlLCBmbiwgdW5zdXBwb3J0ZWQpIHsKICAgIGlmIChpc0RlZmluZWQodW5zdXBwb3J0ZWQpKSB0aHJvdyBqcUxpdGVNaW5FcnIoJ29mZmFyZ3MnLCAnanFMaXRlI29mZigpIGRvZXMgbm90IHN1cHBvcnQgdGhlIGBzZWxlY3RvcmAgYXJndW1lbnQnKTsKCiAgICB2YXIgZXZlbnRzID0ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSwKICAgICAgaGFuZGxlID0ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgICBpZiAoIWhhbmRsZSkgcmV0dXJuOyAvL25vIGxpc3RlbmVycyByZWdpc3RlcmVkCgogICAgaWYgKGlzVW5kZWZpbmVkKHR5cGUpKSB7CiAgICAgIGZvckVhY2goZXZlbnRzLCBmdW5jdGlvbihldmVudEhhbmRsZXIsIHR5cGUpIHsKICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgZXZlbnRIYW5kbGVyKTsKICAgICAgICBkZWxldGUgZXZlbnRzW3R5cGVdOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGZvckVhY2godHlwZS5zcGxpdCgnICcpLCBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGZuKSkgewogICAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGV2ZW50c1t0eXBlXSk7CiAgICAgICAgICBkZWxldGUgZXZlbnRzW3R5cGVdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBhcnJheVJlbW92ZShldmVudHNbdHlwZV0gfHwgW10sIGZuKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24ganFMaXRlUmVtb3ZlRGF0YShlbGVtZW50LCBuYW1lKSB7CiAgICB2YXIgZXhwYW5kb0lkID0gZWxlbWVudFtqcU5hbWVdLAogICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF07CgogICAgaWYgKGV4cGFuZG9TdG9yZSkgewogICAgICBpZiAobmFtZSkgewogICAgICAgIGRlbGV0ZSBqcUNhY2hlW2V4cGFuZG9JZF0uZGF0YVtuYW1lXTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChleHBhbmRvU3RvcmUuaGFuZGxlKSB7CiAgICAgICAgZXhwYW5kb1N0b3JlLmV2ZW50cy4kZGVzdHJveSAmJiBleHBhbmRvU3RvcmUuaGFuZGxlKHt9LCAnJGRlc3Ryb3knKTsKICAgICAgICBqcUxpdGVPZmYoZWxlbWVudCk7CiAgICAgIH0KICAgICAgZGVsZXRlIGpxQ2FjaGVbZXhwYW5kb0lkXTsKICAgICAgZWxlbWVudFtqcU5hbWVdID0gdW5kZWZpbmVkOyAvLyBpZSBkb2VzIG5vdCBhbGxvdyBkZWxldGlvbiBvZiBhdHRyaWJ1dGVzIG9uIGVsZW1lbnRzLgogICAgfQogIH0KCiAgZnVuY3Rpb24ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsIGtleSwgdmFsdWUpIHsKICAgIHZhciBleHBhbmRvSWQgPSBlbGVtZW50W2pxTmFtZV0sCiAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkIHx8IC0xXTsKCiAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICBpZiAoIWV4cGFuZG9TdG9yZSkgewogICAgICAgIGVsZW1lbnRbanFOYW1lXSA9IGV4cGFuZG9JZCA9IGpxTmV4dElkKCk7CiAgICAgICAgZXhwYW5kb1N0b3JlID0ganFDYWNoZVtleHBhbmRvSWRdID0ge307CiAgICAgIH0KICAgICAgZXhwYW5kb1N0b3JlW2tleV0gPSB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBleHBhbmRvU3RvcmUgJiYgZXhwYW5kb1N0b3JlW2tleV07CiAgICB9CiAgfQoKICBmdW5jdGlvbiBqcUxpdGVEYXRhKGVsZW1lbnQsIGtleSwgdmFsdWUpIHsKICAgIHZhciBkYXRhID0ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdkYXRhJyksCiAgICAgIGlzU2V0dGVyID0gaXNEZWZpbmVkKHZhbHVlKSwKICAgICAga2V5RGVmaW5lZCA9ICFpc1NldHRlciAmJiBpc0RlZmluZWQoa2V5KSwKICAgICAgaXNTaW1wbGVHZXR0ZXIgPSBrZXlEZWZpbmVkICYmICFpc09iamVjdChrZXkpOwoKICAgIGlmICghZGF0YSAmJiAhaXNTaW1wbGVHZXR0ZXIpIHsKICAgICAganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdkYXRhJywgZGF0YSA9IHt9KTsKICAgIH0KCiAgICBpZiAoaXNTZXR0ZXIpIHsKICAgICAgZGF0YVtrZXldID0gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICBpZiAoa2V5RGVmaW5lZCkgewogICAgICAgIGlmIChpc1NpbXBsZUdldHRlcikgewogICAgICAgICAgLy8gZG9uJ3QgY3JlYXRlIGRhdGEgaW4gdGhpcyBjYXNlLgogICAgICAgICAgcmV0dXJuIGRhdGEgJiYgZGF0YVtrZXldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBleHRlbmQoZGF0YSwga2V5KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGpxTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICBpZiAoIWVsZW1lbnQuZ2V0QXR0cmlidXRlKSByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gKCgiICIgKyAoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgfHwgJycpICsgIiAiKS5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKS4KICAgICAgaW5kZXhPZiggIiAiICsgc2VsZWN0b3IgKyAiICIgKSA+IC0xKTsKICB9CgogIGZ1bmN0aW9uIGpxTGl0ZVJlbW92ZUNsYXNzKGVsZW1lbnQsIGNzc0NsYXNzZXMpIHsKICAgIGlmIChjc3NDbGFzc2VzICYmIGVsZW1lbnQuc2V0QXR0cmlidXRlKSB7CiAgICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbihjc3NDbGFzcykgewogICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdjbGFzcycsIHRyaW0oCiAgICAgICAgICAgICgiICIgKyAoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgfHwgJycpICsgIiAiKQogICAgICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKQogICAgICAgICAgICAgIC5yZXBsYWNlKCIgIiArIHRyaW0oY3NzQ2xhc3MpICsgIiAiLCAiICIpKQogICAgICAgICk7CiAgICAgIH0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24ganFMaXRlQWRkQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3NlcykgewogICAgaWYgKGNzc0NsYXNzZXMgJiYgZWxlbWVudC5zZXRBdHRyaWJ1dGUpIHsKICAgICAgdmFyIGV4aXN0aW5nQ2xhc3NlcyA9ICgnICcgKyAoZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgfHwgJycpICsgJyAnKQogICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKTsKCiAgICAgIGZvckVhY2goY3NzQ2xhc3Nlcy5zcGxpdCgnICcpLCBmdW5jdGlvbihjc3NDbGFzcykgewogICAgICAgIGNzc0NsYXNzID0gdHJpbShjc3NDbGFzcyk7CiAgICAgICAgaWYgKGV4aXN0aW5nQ2xhc3Nlcy5pbmRleE9mKCcgJyArIGNzc0NsYXNzICsgJyAnKSA9PT0gLTEpIHsKICAgICAgICAgIGV4aXN0aW5nQ2xhc3NlcyArPSBjc3NDbGFzcyArICcgJzsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgdHJpbShleGlzdGluZ0NsYXNzZXMpKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGpxTGl0ZUFkZE5vZGVzKHJvb3QsIGVsZW1lbnRzKSB7CiAgICBpZiAoZWxlbWVudHMpIHsKICAgICAgZWxlbWVudHMgPSAoIWVsZW1lbnRzLm5vZGVOYW1lICYmIGlzRGVmaW5lZChlbGVtZW50cy5sZW5ndGgpICYmICFpc1dpbmRvdyhlbGVtZW50cykpCiAgICAgICAgPyBlbGVtZW50cwogICAgICAgIDogWyBlbGVtZW50cyBdOwogICAgICBmb3IodmFyIGk9MDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcm9vdC5wdXNoKGVsZW1lbnRzW2ldKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24ganFMaXRlQ29udHJvbGxlcihlbGVtZW50LCBuYW1lKSB7CiAgICByZXR1cm4ganFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCAnJCcgKyAobmFtZSB8fCAnbmdDb250cm9sbGVyJyApICsgJ0NvbnRyb2xsZXInKTsKICB9CgogIGZ1bmN0aW9uIGpxTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CgogICAgLy8gaWYgZWxlbWVudCBpcyB0aGUgZG9jdW1lbnQgb2JqZWN0IHdvcmsgd2l0aCB0aGUgaHRtbCBlbGVtZW50IGluc3RlYWQKICAgIC8vIHRoaXMgbWFrZXMgJChkb2N1bWVudCkuc2NvcGUoKSBwb3NzaWJsZQogICAgaWYoZWxlbWVudFswXS5ub2RlVHlwZSA9PSA5KSB7CiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LmZpbmQoJ2h0bWwnKTsKICAgIH0KICAgIHZhciBuYW1lcyA9IGlzQXJyYXkobmFtZSkgPyBuYW1lIDogW25hbWVdOwoKICAgIHdoaWxlIChlbGVtZW50Lmxlbmd0aCkgewogICAgICB2YXIgbm9kZSA9IGVsZW1lbnRbMF07CiAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IG5hbWVzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICBpZiAoKHZhbHVlID0gZWxlbWVudC5kYXRhKG5hbWVzW2ldKSkgIT09IHVuZGVmaW5lZCkgcmV0dXJuIHZhbHVlOwogICAgICB9CgogICAgICAvLyBJZiBkZWFsaW5nIHdpdGggYSBkb2N1bWVudCBmcmFnbWVudCBub2RlIHdpdGggYSBob3N0IGVsZW1lbnQsIGFuZCBubyBwYXJlbnQsIHVzZSB0aGUgaG9zdAogICAgICAvLyBlbGVtZW50IGFzIHRoZSBwYXJlbnQuIFRoaXMgZW5hYmxlcyBkaXJlY3RpdmVzIHdpdGhpbiBhIFNoYWRvdyBET00gb3IgcG9seWZpbGxlZCBTaGFkb3cgRE9NCiAgICAgIC8vIHRvIGxvb2t1cCBwYXJlbnQgY29udHJvbGxlcnMuCiAgICAgIGVsZW1lbnQgPSBqcUxpdGUobm9kZS5wYXJlbnROb2RlIHx8IChub2RlLm5vZGVUeXBlID09PSAxMSAmJiBub2RlLmhvc3QpKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGpxTGl0ZUVtcHR5KGVsZW1lbnQpIHsKICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZE5vZGVzID0gZWxlbWVudC5jaGlsZE5vZGVzOyBpIDwgY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICBqcUxpdGVEZWFsb2MoY2hpbGROb2Rlc1tpXSk7CiAgICB9CiAgICB3aGlsZSAoZWxlbWVudC5maXJzdENoaWxkKSB7CiAgICAgIGVsZW1lbnQucmVtb3ZlQ2hpbGQoZWxlbWVudC5maXJzdENoaWxkKTsKICAgIH0KICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIHdoaWNoIGFyZSBkZWNsYXJlZCBkaXJlY3RseS4KLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgdmFyIEpRTGl0ZVByb3RvdHlwZSA9IEpRTGl0ZS5wcm90b3R5cGUgPSB7CiAgICByZWFkeTogZnVuY3Rpb24oZm4pIHsKICAgICAgdmFyIGZpcmVkID0gZmFsc2U7CgogICAgICBmdW5jdGlvbiB0cmlnZ2VyKCkgewogICAgICAgIGlmIChmaXJlZCkgcmV0dXJuOwogICAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgICBmbigpOwogICAgICB9CgogICAgICAvLyBjaGVjayBpZiBkb2N1bWVudCBhbHJlYWR5IGlzIGxvYWRlZAogICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJyl7CiAgICAgICAgc2V0VGltZW91dCh0cmlnZ2VyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9uKCdET01Db250ZW50TG9hZGVkJywgdHJpZ2dlcik7IC8vIHdvcmtzIGZvciBtb2Rlcm4gYnJvd3NlcnMgYW5kIElFOQogICAgICAgIC8vIHdlIGNhbiBub3QgdXNlIGpxTGl0ZSBzaW5jZSB3ZSBhcmUgbm90IGRvbmUgbG9hZGluZyBhbmQgalF1ZXJ5IGNvdWxkIGJlIGxvYWRlZCBsYXRlci4KICAgICAgICAvLyBqc2hpbnQgLVcwNjQKICAgICAgICBKUUxpdGUod2luZG93KS5vbignbG9hZCcsIHRyaWdnZXIpOyAvLyBmYWxsYmFjayB0byB3aW5kb3cub25sb2FkIGZvciBvdGhlcnMKICAgICAgICAvLyBqc2hpbnQgK1cwNjQKICAgICAgfQogICAgfSwKICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHZhbHVlID0gW107CiAgICAgIGZvckVhY2godGhpcywgZnVuY3Rpb24oZSl7IHZhbHVlLnB1c2goJycgKyBlKTt9KTsKICAgICAgcmV0dXJuICdbJyArIHZhbHVlLmpvaW4oJywgJykgKyAnXSc7CiAgICB9LAoKICAgIGVxOiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gKGluZGV4ID49IDApID8ganFMaXRlKHRoaXNbaW5kZXhdKSA6IGpxTGl0ZSh0aGlzW3RoaXMubGVuZ3RoICsgaW5kZXhdKTsKICAgIH0sCgogICAgbGVuZ3RoOiAwLAogICAgcHVzaDogcHVzaCwKICAgIHNvcnQ6IFtdLnNvcnQsCiAgICBzcGxpY2U6IFtdLnNwbGljZQogIH07CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIGl0ZXJhdGluZyBnZXR0ZXIvc2V0dGVycy4KLy8gdGhlc2UgZnVuY3Rpb25zIHJldHVybiBzZWxmIG9uIHNldHRlciBhbmQKLy8gdmFsdWUgb24gZ2V0LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICB2YXIgQk9PTEVBTl9BVFRSID0ge307CiAgZm9yRWFjaCgnbXVsdGlwbGUsc2VsZWN0ZWQsY2hlY2tlZCxkaXNhYmxlZCxyZWFkT25seSxyZXF1aXJlZCxvcGVuJy5zcGxpdCgnLCcpLCBmdW5jdGlvbih2YWx1ZSkgewogICAgQk9PTEVBTl9BVFRSW2xvd2VyY2FzZSh2YWx1ZSldID0gdmFsdWU7CiAgfSk7CiAgdmFyIEJPT0xFQU5fRUxFTUVOVFMgPSB7fTsKICBmb3JFYWNoKCdpbnB1dCxzZWxlY3Qsb3B0aW9uLHRleHRhcmVhLGJ1dHRvbixmb3JtLGRldGFpbHMnLnNwbGl0KCcsJyksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBCT09MRUFOX0VMRU1FTlRTW3VwcGVyY2FzZSh2YWx1ZSldID0gdHJ1ZTsKICB9KTsKCiAgZnVuY3Rpb24gZ2V0Qm9vbGVhbkF0dHJOYW1lKGVsZW1lbnQsIG5hbWUpIHsKICAgIC8vIGNoZWNrIGRvbSBsYXN0IHNpbmNlIHdlIHdpbGwgbW9zdCBsaWtlbHkgZmFpbCBvbiBuYW1lCiAgICB2YXIgYm9vbGVhbkF0dHIgPSBCT09MRUFOX0FUVFJbbmFtZS50b0xvd2VyQ2FzZSgpXTsKCiAgICAvLyBib29sZWFuQXR0ciBpcyBoZXJlIHR3aWNlIHRvIG1pbmltaXplIERPTSBhY2Nlc3MKICAgIHJldHVybiBib29sZWFuQXR0ciAmJiBCT09MRUFOX0VMRU1FTlRTW2VsZW1lbnQubm9kZU5hbWVdICYmIGJvb2xlYW5BdHRyOwogIH0KCiAgZm9yRWFjaCh7CiAgICBkYXRhOiBqcUxpdGVEYXRhLAogICAgaW5oZXJpdGVkRGF0YToganFMaXRlSW5oZXJpdGVkRGF0YSwKCiAgICBzY29wZTogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAvLyBDYW4ndCB1c2UganFMaXRlRGF0YSBoZXJlIGRpcmVjdGx5IHNvIHdlIHN0YXkgY29tcGF0aWJsZSB3aXRoIGpRdWVyeSEKICAgICAgcmV0dXJuIGpxTGl0ZShlbGVtZW50KS5kYXRhKCckc2NvcGUnKSB8fCBqcUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQucGFyZW50Tm9kZSB8fCBlbGVtZW50LCBbJyRpc29sYXRlU2NvcGUnLCAnJHNjb3BlJ10pOwogICAgfSwKCiAgICBpc29sYXRlU2NvcGU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgLy8gQ2FuJ3QgdXNlIGpxTGl0ZURhdGEgaGVyZSBkaXJlY3RseSBzbyB3ZSBzdGF5IGNvbXBhdGlibGUgd2l0aCBqUXVlcnkhCiAgICAgIHJldHVybiBqcUxpdGUoZWxlbWVudCkuZGF0YSgnJGlzb2xhdGVTY29wZScpIHx8IGpxTGl0ZShlbGVtZW50KS5kYXRhKCckaXNvbGF0ZVNjb3BlTm9UZW1wbGF0ZScpOwogICAgfSwKCiAgICBjb250cm9sbGVyOiBqcUxpdGVDb250cm9sbGVyLAoKICAgIGluamVjdG9yOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgIHJldHVybiBqcUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckaW5qZWN0b3InKTsKICAgIH0sCgogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24oZWxlbWVudCxuYW1lKSB7CiAgICAgIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKG5hbWUpOwogICAgfSwKCiAgICBoYXNDbGFzczoganFMaXRlSGFzQ2xhc3MsCgogICAgY3NzOiBmdW5jdGlvbihlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgICBuYW1lID0gY2FtZWxDYXNlKG5hbWUpOwoKICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICBlbGVtZW50LnN0eWxlW25hbWVdID0gdmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHZhbDsKCiAgICAgICAgaWYgKG1zaWUgPD0gOCkgewogICAgICAgICAgLy8gdGhpcyBpcyBzb21lIElFIHNwZWNpZmljIHdlaXJkbmVzcyB0aGF0IGpRdWVyeSAxLjYuNCBkb2VzIG5vdCBzdXJlIHdoeQogICAgICAgICAgdmFsID0gZWxlbWVudC5jdXJyZW50U3R5bGUgJiYgZWxlbWVudC5jdXJyZW50U3R5bGVbbmFtZV07CiAgICAgICAgICBpZiAodmFsID09PSAnJykgdmFsID0gJ2F1dG8nOwogICAgICAgIH0KCiAgICAgICAgdmFsID0gdmFsIHx8IGVsZW1lbnQuc3R5bGVbbmFtZV07CgogICAgICAgIGlmIChtc2llIDw9IDgpIHsKICAgICAgICAgIC8vIGpxdWVyeSB3ZWlyZG5lc3MgOi0vCiAgICAgICAgICB2YWwgPSAodmFsID09PSAnJykgPyB1bmRlZmluZWQgOiB2YWw7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gIHZhbDsKICAgICAgfQogICAgfSwKCiAgICBhdHRyOiBmdW5jdGlvbihlbGVtZW50LCBuYW1lLCB2YWx1ZSl7CiAgICAgIHZhciBsb3dlcmNhc2VkTmFtZSA9IGxvd2VyY2FzZShuYW1lKTsKICAgICAgaWYgKEJPT0xFQU5fQVRUUltsb3dlcmNhc2VkTmFtZV0pIHsKICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgaWYgKCEhdmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudFtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIGxvd2VyY2FzZWROYW1lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGVsZW1lbnRbbmFtZV0gPSBmYWxzZTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUobG93ZXJjYXNlZE5hbWUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gKGVsZW1lbnRbbmFtZV0gfHwKICAgICAgICAgICAgKGVsZW1lbnQuYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0obmFtZSl8fCBub29wKS5zcGVjaWZpZWQpCiAgICAgICAgICAgID8gbG93ZXJjYXNlZE5hbWUKICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7CiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgICAvLyB0aGUgZXh0cmEgYXJndW1lbnQgIjIiIGlzIHRvIGdldCB0aGUgcmlnaHQgdGhpbmcgZm9yIGEuaHJlZiBpbiBJRSwgc2VlIGpRdWVyeSBjb2RlCiAgICAgICAgLy8gc29tZSBlbGVtZW50cyAoZS5nLiBEb2N1bWVudCkgZG9uJ3QgaGF2ZSBnZXQgYXR0cmlidXRlLCBzbyByZXR1cm4gdW5kZWZpbmVkCiAgICAgICAgdmFyIHJldCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKG5hbWUsIDIpOwogICAgICAgIC8vIG5vcm1hbGl6ZSBub24tZXhpc3RpbmcgYXR0cmlidXRlcyB0byB1bmRlZmluZWQgKGFzIGpRdWVyeSkKICAgICAgICByZXR1cm4gcmV0ID09PSBudWxsID8gdW5kZWZpbmVkIDogcmV0OwogICAgICB9CiAgICB9LAoKICAgIHByb3A6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7CiAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgZWxlbWVudFtuYW1lXSA9IHZhbHVlOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBlbGVtZW50W25hbWVdOwogICAgICB9CiAgICB9LAoKICAgIHRleHQ6IChmdW5jdGlvbigpIHsKICAgICAgdmFyIE5PREVfVFlQRV9URVhUX1BST1BFUlRZID0gW107CiAgICAgIGlmIChtc2llIDwgOSkgewogICAgICAgIE5PREVfVFlQRV9URVhUX1BST1BFUlRZWzFdID0gJ2lubmVyVGV4dCc7ICAgIC8qKiBFbGVtZW50ICoqLwogICAgICAgIE5PREVfVFlQRV9URVhUX1BST1BFUlRZWzNdID0gJ25vZGVWYWx1ZSc7ICAgIC8qKiBUZXh0ICoqLwogICAgICB9IGVsc2UgewogICAgICAgIE5PREVfVFlQRV9URVhUX1BST1BFUlRZWzFdID0gICAgICAgICAgICAgICAgIC8qKiBFbGVtZW50ICoqLwogICAgICAgICAgTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFlbM10gPSAndGV4dENvbnRlbnQnOyAgLyoqIFRleHQgKiovCiAgICAgIH0KICAgICAgZ2V0VGV4dC4kZHYgPSAnJzsKICAgICAgcmV0dXJuIGdldFRleHQ7CgogICAgICBmdW5jdGlvbiBnZXRUZXh0KGVsZW1lbnQsIHZhbHVlKSB7CiAgICAgICAgdmFyIHRleHRQcm9wID0gTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFlbZWxlbWVudC5ub2RlVHlwZV07CiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIHRleHRQcm9wID8gZWxlbWVudFt0ZXh0UHJvcF0gOiAnJzsKICAgICAgICB9CiAgICAgICAgZWxlbWVudFt0ZXh0UHJvcF0gPSB2YWx1ZTsKICAgICAgfQogICAgfSkoKSwKCiAgICB2YWw6IGZ1bmN0aW9uKGVsZW1lbnQsIHZhbHVlKSB7CiAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICBpZiAobm9kZU5hbWVfKGVsZW1lbnQpID09PSAnU0VMRUNUJyAmJiBlbGVtZW50Lm11bHRpcGxlKSB7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQub3B0aW9ucywgZnVuY3Rpb24gKG9wdGlvbikgewogICAgICAgICAgICBpZiAob3B0aW9uLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2gob3B0aW9uLnZhbHVlIHx8IG9wdGlvbi50ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA9PT0gMCA/IG51bGwgOiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBlbGVtZW50LnZhbHVlOwogICAgICB9CiAgICAgIGVsZW1lbnQudmFsdWUgPSB2YWx1ZTsKICAgIH0sCgogICAgaHRtbDogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgIHJldHVybiBlbGVtZW50LmlubmVySFRNTDsKICAgICAgfQogICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGROb2RlcyA9IGVsZW1lbnQuY2hpbGROb2RlczsgaSA8IGNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBqcUxpdGVEZWFsb2MoY2hpbGROb2Rlc1tpXSk7CiAgICAgIH0KICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSB2YWx1ZTsKICAgIH0sCgogICAgZW1wdHk6IGpxTGl0ZUVtcHR5CiAgfSwgZnVuY3Rpb24oZm4sIG5hbWUpewogICAgLyoqCiAgICAgKiBQcm9wZXJ0aWVzOiB3cml0ZXMgcmV0dXJuIHNlbGVjdGlvbiwgcmVhZHMgcmV0dXJuIGZpcnN0IHZhbHVlCiAgICAgKi8KICAgIEpRTGl0ZS5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbihhcmcxLCBhcmcyKSB7CiAgICAgIHZhciBpLCBrZXk7CgogICAgICAvLyBqcUxpdGVIYXNDbGFzcyBoYXMgb25seSB0d28gYXJndW1lbnRzLCBidXQgaXMgYSBnZXR0ZXItb25seSBmbiwgc28gd2UgbmVlZCB0byBzcGVjaWFsLWNhc2UgaXQKICAgICAgLy8gaW4gYSB3YXkgdGhhdCBzdXJ2aXZlcyBtaW5pZmljYXRpb24uCiAgICAgIC8vIGpxTGl0ZUVtcHR5IHRha2VzIG5vIGFyZ3VtZW50cyBidXQgaXMgYSBzZXR0ZXIuCiAgICAgIGlmIChmbiAhPT0ganFMaXRlRW1wdHkgJiYKICAgICAgICAoKChmbi5sZW5ndGggPT0gMiAmJiAoZm4gIT09IGpxTGl0ZUhhc0NsYXNzICYmIGZuICE9PSBqcUxpdGVDb250cm9sbGVyKSkgPyBhcmcxIDogYXJnMikgPT09IHVuZGVmaW5lZCkpIHsKICAgICAgICBpZiAoaXNPYmplY3QoYXJnMSkpIHsKCiAgICAgICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgYnV0IHRoZSBvYmplY3QgcHJvcGVydGllcyBhcmUgdGhlIGtleS92YWx1ZXMKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChmbiA9PT0ganFMaXRlRGF0YSkgewogICAgICAgICAgICAgIC8vIGRhdGEoKSB0YWtlcyB0aGUgd2hvbGUgb2JqZWN0IGluIGpRdWVyeQogICAgICAgICAgICAgIGZuKHRoaXNbaV0sIGFyZzEpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGZvciAoa2V5IGluIGFyZzEpIHsKICAgICAgICAgICAgICAgIGZuKHRoaXNbaV0sIGtleSwgYXJnMVtrZXldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIHJldHVybiBzZWxmIGZvciBjaGFpbmluZwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIHdlIGFyZSBhIHJlYWQsIHNvIHJlYWQgdGhlIGZpcnN0IGNoaWxkLgogICAgICAgICAgdmFyIHZhbHVlID0gZm4uJGR2OwogICAgICAgICAgLy8gT25seSBpZiB3ZSBoYXZlICRkdiBkbyB3ZSBpdGVyYXRlIG92ZXIgYWxsLCBvdGhlcndpc2UgaXQgaXMganVzdCB0aGUgZmlyc3QgZWxlbWVudC4KICAgICAgICAgIHZhciBqaiA9ICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/IE1hdGgubWluKHRoaXMubGVuZ3RoLCAxKSA6IHRoaXMubGVuZ3RoOwogICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBqajsgaisrKSB7CiAgICAgICAgICAgIHZhciBub2RlVmFsdWUgPSBmbih0aGlzW2pdLCBhcmcxLCBhcmcyKTsKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZSA/IHZhbHVlICsgbm9kZVZhbHVlIDogbm9kZVZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB3ZSBhcmUgYSB3cml0ZSwgc28gYXBwbHkgdG8gYWxsIGNoaWxkcmVuCiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGZuKHRoaXNbaV0sIGFyZzEsIGFyZzIpOwogICAgICAgIH0KICAgICAgICAvLyByZXR1cm4gc2VsZiBmb3IgY2hhaW5pbmcKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgfTsKICB9KTsKCiAgZnVuY3Rpb24gY3JlYXRlRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50cykgewogICAgdmFyIGV2ZW50SGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCwgdHlwZSkgewogICAgICBpZiAoIWV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7IC8vaWUKICAgICAgICB9OwogICAgICB9CgogICAgICBpZiAoIWV2ZW50LnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsgLy9pZQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGlmICghZXZlbnQudGFyZ2V0KSB7CiAgICAgICAgZXZlbnQudGFyZ2V0ID0gZXZlbnQuc3JjRWxlbWVudCB8fCBkb2N1bWVudDsKICAgICAgfQoKICAgICAgaWYgKGlzVW5kZWZpbmVkKGV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQpKSB7CiAgICAgICAgdmFyIHByZXZlbnQgPSBldmVudC5wcmV2ZW50RGVmYXVsdDsKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICBwcmV2ZW50LmNhbGwoZXZlbnQpOwogICAgICAgIH07CiAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IGZhbHNlOwogICAgICB9CgogICAgICBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZXZlbnQuZGVmYXVsdFByZXZlbnRlZCB8fCBldmVudC5yZXR1cm5WYWx1ZSA9PT0gZmFsc2U7CiAgICAgIH07CgogICAgICAvLyBDb3B5IGV2ZW50IGhhbmRsZXJzIGluIGNhc2UgZXZlbnQgaGFuZGxlcnMgYXJyYXkgaXMgbW9kaWZpZWQgZHVyaW5nIGV4ZWN1dGlvbi4KICAgICAgdmFyIGV2ZW50SGFuZGxlcnNDb3B5ID0gc2hhbGxvd0NvcHkoZXZlbnRzW3R5cGUgfHwgZXZlbnQudHlwZV0gfHwgW10pOwoKICAgICAgZm9yRWFjaChldmVudEhhbmRsZXJzQ29weSwgZnVuY3Rpb24oZm4pIHsKICAgICAgICBmbi5jYWxsKGVsZW1lbnQsIGV2ZW50KTsKICAgICAgfSk7CgogICAgICAvLyBSZW1vdmUgbW9ua2V5LXBhdGNoZWQgbWV0aG9kcyAoSUUpLAogICAgICAvLyBhcyB0aGV5IHdvdWxkIGNhdXNlIG1lbW9yeSBsZWFrcyBpbiBJRTguCiAgICAgIGlmIChtc2llIDw9IDgpIHsKICAgICAgICAvLyBJRTcvOCBkb2VzIG5vdCBhbGxvdyB0byBkZWxldGUgcHJvcGVydHkgb24gbmF0aXZlIG9iamVjdAogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gbnVsbDsKICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24gPSBudWxsOwogICAgICAgIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA9IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSXQgc2hvdWxkbid0IGFmZmVjdCBub3JtYWwgYnJvd3NlcnMgKG5hdGl2ZSBtZXRob2RzIGFyZSBkZWZpbmVkIG9uIHByb3RvdHlwZSkuCiAgICAgICAgZGVsZXRlIGV2ZW50LnByZXZlbnREZWZhdWx0OwogICAgICAgIGRlbGV0ZSBldmVudC5zdG9wUHJvcGFnYXRpb247CiAgICAgICAgZGVsZXRlIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZDsKICAgICAgfQogICAgfTsKICAgIGV2ZW50SGFuZGxlci5lbGVtID0gZWxlbWVudDsKICAgIHJldHVybiBldmVudEhhbmRsZXI7CiAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vIEZ1bmN0aW9ucyBpdGVyYXRpbmcgdHJhdmVyc2FsLgovLyBUaGVzZSBmdW5jdGlvbnMgY2hhaW4gcmVzdWx0cyBpbnRvIGEgc2luZ2xlCi8vIHNlbGVjdG9yLgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICBmb3JFYWNoKHsKICAgIHJlbW92ZURhdGE6IGpxTGl0ZVJlbW92ZURhdGEsCgogICAgZGVhbG9jOiBqcUxpdGVEZWFsb2MsCgogICAgb246IGZ1bmN0aW9uIG9uRm4oZWxlbWVudCwgdHlwZSwgZm4sIHVuc3VwcG9ydGVkKXsKICAgICAgaWYgKGlzRGVmaW5lZCh1bnN1cHBvcnRlZCkpIHRocm93IGpxTGl0ZU1pbkVycignb25hcmdzJywgJ2pxTGl0ZSNvbigpIGRvZXMgbm90IHN1cHBvcnQgdGhlIGBzZWxlY3RvcmAgb3IgYGV2ZW50RGF0YWAgcGFyYW1ldGVycycpOwoKICAgICAgdmFyIGV2ZW50cyA9IGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJyksCiAgICAgICAgaGFuZGxlID0ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnKTsKCiAgICAgIGlmICghZXZlbnRzKSBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycsIGV2ZW50cyA9IHt9KTsKICAgICAgaWYgKCFoYW5kbGUpIGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnaGFuZGxlJywgaGFuZGxlID0gY3JlYXRlRXZlbnRIYW5kbGVyKGVsZW1lbnQsIGV2ZW50cykpOwoKICAgICAgZm9yRWFjaCh0eXBlLnNwbGl0KCcgJyksIGZ1bmN0aW9uKHR5cGUpewogICAgICAgIHZhciBldmVudEZucyA9IGV2ZW50c1t0eXBlXTsKCiAgICAgICAgaWYgKCFldmVudEZucykgewogICAgICAgICAgaWYgKHR5cGUgPT0gJ21vdXNlZW50ZXInIHx8IHR5cGUgPT0gJ21vdXNlbGVhdmUnKSB7CiAgICAgICAgICAgIHZhciBjb250YWlucyA9IGRvY3VtZW50LmJvZHkuY29udGFpbnMgfHwgZG9jdW1lbnQuYm9keS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/CiAgICAgICAgICAgICAgZnVuY3Rpb24oIGEsIGIgKSB7CiAgICAgICAgICAgICAgICAvLyBqc2hpbnQgYml0d2lzZTogZmFsc2UKICAgICAgICAgICAgICAgIHZhciBhZG93biA9IGEubm9kZVR5cGUgPT09IDkgPyBhLmRvY3VtZW50RWxlbWVudCA6IGEsCiAgICAgICAgICAgICAgICAgIGJ1cCA9IGIgJiYgYi5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGJ1cCB8fCAhISggYnVwICYmIGJ1cC5ub2RlVHlwZSA9PT0gMSAmJiAoCiAgICAgICAgICAgICAgICAgIGFkb3duLmNvbnRhaW5zID8KICAgICAgICAgICAgICAgICAgICBhZG93bi5jb250YWlucyggYnVwICkgOgogICAgICAgICAgICAgICAgICAgIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYnVwICkgJiAxNgogICAgICAgICAgICAgICAgICApKTsKICAgICAgICAgICAgICB9IDoKICAgICAgICAgICAgICBmdW5jdGlvbiggYSwgYiApIHsKICAgICAgICAgICAgICAgIGlmICggYiApIHsKICAgICAgICAgICAgICAgICAgd2hpbGUgKCAoYiA9IGIucGFyZW50Tm9kZSkgKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCBiID09PSBhICkgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwoKICAgICAgICAgICAgLy8gUmVmZXIgdG8galF1ZXJ5J3MgaW1wbGVtZW50YXRpb24gb2YgbW91c2VlbnRlciAmIG1vdXNlbGVhdmUKICAgICAgICAgICAgLy8gUmVhZCBhYm91dCBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlOgogICAgICAgICAgICAvLyBodHRwOi8vd3d3LnF1aXJrc21vZGUub3JnL2pzL2V2ZW50c19tb3VzZS5odG1sI2xpbms4CiAgICAgICAgICAgIHZhciBldmVudG1hcCA9IHsgbW91c2VsZWF2ZSA6ICJtb3VzZW91dCIsIG1vdXNlZW50ZXIgOiAibW91c2VvdmVyIn07CgogICAgICAgICAgICBvbkZuKGVsZW1lbnQsIGV2ZW50bWFwW3R5cGVdLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLCByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldDsKICAgICAgICAgICAgICAvLyBGb3IgbW91c2VudGVyL2xlYXZlIGNhbGwgdGhlIGhhbmRsZXIgaWYgcmVsYXRlZCBpcyBvdXRzaWRlIHRoZSB0YXJnZXQuCiAgICAgICAgICAgICAgLy8gTkI6IE5vIHJlbGF0ZWRUYXJnZXQgaWYgdGhlIG1vdXNlIGxlZnQvZW50ZXJlZCB0aGUgYnJvd3NlciB3aW5kb3cKICAgICAgICAgICAgICBpZiAoICFyZWxhdGVkIHx8IChyZWxhdGVkICE9PSB0YXJnZXQgJiYgIWNvbnRhaW5zKHRhcmdldCwgcmVsYXRlZCkpICl7CiAgICAgICAgICAgICAgICBoYW5kbGUoZXZlbnQsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKGVsZW1lbnQsIHR5cGUsIGhhbmRsZSk7CiAgICAgICAgICAgIGV2ZW50c1t0eXBlXSA9IFtdOwogICAgICAgICAgfQogICAgICAgICAgZXZlbnRGbnMgPSBldmVudHNbdHlwZV07CiAgICAgICAgfQogICAgICAgIGV2ZW50Rm5zLnB1c2goZm4pOwogICAgICB9KTsKICAgIH0sCgogICAgb2ZmOiBqcUxpdGVPZmYsCgogICAgb25lOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbikgewogICAgICBlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwoKICAgICAgLy9hZGQgdGhlIGxpc3RlbmVyIHR3aWNlIHNvIHRoYXQgd2hlbiBpdCBpcyBjYWxsZWQKICAgICAgLy95b3UgY2FuIHJlbW92ZSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24gYW5kIHN0aWxsIGJlCiAgICAgIC8vYWJsZSB0byBjYWxsIGVsZW1lbnQub2ZmKGV2LCBmbikgbm9ybWFsbHkKICAgICAgZWxlbWVudC5vbih0eXBlLCBmdW5jdGlvbiBvbkZuKCkgewogICAgICAgIGVsZW1lbnQub2ZmKHR5cGUsIGZuKTsKICAgICAgICBlbGVtZW50Lm9mZih0eXBlLCBvbkZuKTsKICAgICAgfSk7CiAgICAgIGVsZW1lbnQub24odHlwZSwgZm4pOwogICAgfSwKCiAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24oZWxlbWVudCwgcmVwbGFjZU5vZGUpIHsKICAgICAgdmFyIGluZGV4LCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgIGpxTGl0ZURlYWxvYyhlbGVtZW50KTsKICAgICAgZm9yRWFjaChuZXcgSlFMaXRlKHJlcGxhY2VOb2RlKSwgZnVuY3Rpb24obm9kZSl7CiAgICAgICAgaWYgKGluZGV4KSB7CiAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIGluZGV4Lm5leHRTaWJsaW5nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZChub2RlLCBlbGVtZW50KTsKICAgICAgICB9CiAgICAgICAgaW5kZXggPSBub2RlOwogICAgICB9KTsKICAgIH0sCgogICAgY2hpbGRyZW46IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgdmFyIGNoaWxkcmVuID0gW107CiAgICAgIGZvckVhY2goZWxlbWVudC5jaGlsZE5vZGVzLCBmdW5jdGlvbihlbGVtZW50KXsKICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkKICAgICAgICAgIGNoaWxkcmVuLnB1c2goZWxlbWVudCk7CiAgICAgIH0pOwogICAgICByZXR1cm4gY2hpbGRyZW47CiAgICB9LAoKICAgIGNvbnRlbnRzOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgIHJldHVybiBlbGVtZW50LmNvbnRlbnREb2N1bWVudCB8fCBlbGVtZW50LmNoaWxkTm9kZXMgfHwgW107CiAgICB9LAoKICAgIGFwcGVuZDogZnVuY3Rpb24oZWxlbWVudCwgbm9kZSkgewogICAgICBmb3JFYWNoKG5ldyBKUUxpdGUobm9kZSksIGZ1bmN0aW9uKGNoaWxkKXsKICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSB8fCBlbGVtZW50Lm5vZGVUeXBlID09PSAxMSkgewogICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgcHJlcGVuZDogZnVuY3Rpb24oZWxlbWVudCwgbm9kZSkgewogICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgIHZhciBpbmRleCA9IGVsZW1lbnQuZmlyc3RDaGlsZDsKICAgICAgICBmb3JFYWNoKG5ldyBKUUxpdGUobm9kZSksIGZ1bmN0aW9uKGNoaWxkKXsKICAgICAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNoaWxkLCBpbmRleCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgd3JhcDogZnVuY3Rpb24oZWxlbWVudCwgd3JhcE5vZGUpIHsKICAgICAgd3JhcE5vZGUgPSBqcUxpdGUod3JhcE5vZGUpWzBdOwogICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgcGFyZW50LnJlcGxhY2VDaGlsZCh3cmFwTm9kZSwgZWxlbWVudCk7CiAgICAgIH0KICAgICAgd3JhcE5vZGUuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CiAgICB9LAoKICAgIHJlbW92ZTogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICBqcUxpdGVEZWFsb2MoZWxlbWVudCk7CiAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgIGlmIChwYXJlbnQpIHBhcmVudC5yZW1vdmVDaGlsZChlbGVtZW50KTsKICAgIH0sCgogICAgYWZ0ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIG5ld0VsZW1lbnQpIHsKICAgICAgdmFyIGluZGV4ID0gZWxlbWVudCwgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICBmb3JFYWNoKG5ldyBKUUxpdGUobmV3RWxlbWVudCksIGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZSwgaW5kZXgubmV4dFNpYmxpbmcpOwogICAgICAgIGluZGV4ID0gbm9kZTsKICAgICAgfSk7CiAgICB9LAoKICAgIGFkZENsYXNzOiBqcUxpdGVBZGRDbGFzcywKICAgIHJlbW92ZUNsYXNzOiBqcUxpdGVSZW1vdmVDbGFzcywKCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgc2VsZWN0b3IsIGNvbmRpdGlvbikgewogICAgICBpZiAoc2VsZWN0b3IpIHsKICAgICAgICBmb3JFYWNoKHNlbGVjdG9yLnNwbGl0KCcgJyksIGZ1bmN0aW9uKGNsYXNzTmFtZSl7CiAgICAgICAgICB2YXIgY2xhc3NDb25kaXRpb24gPSBjb25kaXRpb247CiAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY2xhc3NDb25kaXRpb24pKSB7CiAgICAgICAgICAgIGNsYXNzQ29uZGl0aW9uID0gIWpxTGl0ZUhhc0NsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICAoY2xhc3NDb25kaXRpb24gPyBqcUxpdGVBZGRDbGFzcyA6IGpxTGl0ZVJlbW92ZUNsYXNzKShlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAoKICAgIHBhcmVudDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICByZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwogICAgfSwKCiAgICBuZXh0OiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgIGlmIChlbGVtZW50Lm5leHRFbGVtZW50U2libGluZykgewogICAgICAgIHJldHVybiBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZzsKICAgICAgfQoKICAgICAgLy8gSUU4IGRvZXNuJ3QgaGF2ZSBuZXh0RWxlbWVudFNpYmxpbmcKICAgICAgdmFyIGVsbSA9IGVsZW1lbnQubmV4dFNpYmxpbmc7CiAgICAgIHdoaWxlIChlbG0gIT0gbnVsbCAmJiBlbG0ubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICBlbG0gPSBlbG0ubmV4dFNpYmxpbmc7CiAgICAgIH0KICAgICAgcmV0dXJuIGVsbTsKICAgIH0sCgogICAgZmluZDogZnVuY3Rpb24oZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgaWYgKGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUpIHsKICAgICAgICByZXR1cm4gZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShzZWxlY3Rvcik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICB9LAoKICAgIGNsb25lOiBqcUxpdGVDbG9uZSwKCiAgICB0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24oZWxlbWVudCwgZXZlbnROYW1lLCBldmVudERhdGEpIHsKICAgICAgdmFyIGV2ZW50Rm5zID0gKGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJykgfHwge30pW2V2ZW50TmFtZV07CgogICAgICBldmVudERhdGEgPSBldmVudERhdGEgfHwgW107CgogICAgICB2YXIgZXZlbnQgPSBbewogICAgICAgIHByZXZlbnREZWZhdWx0OiBub29wLAogICAgICAgIHN0b3BQcm9wYWdhdGlvbjogbm9vcAogICAgICB9XTsKCiAgICAgIGZvckVhY2goZXZlbnRGbnMsIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgZm4uYXBwbHkoZWxlbWVudCwgZXZlbnQuY29uY2F0KGV2ZW50RGF0YSkpOwogICAgICB9KTsKICAgIH0KICB9LCBmdW5jdGlvbihmbiwgbmFtZSl7CiAgICAvKioKICAgICAqIGNoYWluaW5nIGZ1bmN0aW9ucwogICAgICovCiAgICBKUUxpdGUucHJvdG90eXBlW25hbWVdID0gZnVuY3Rpb24oYXJnMSwgYXJnMiwgYXJnMykgewogICAgICB2YXIgdmFsdWU7CiAgICAgIGZvcih2YXIgaT0wOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgIHZhbHVlID0gZm4odGhpc1tpXSwgYXJnMSwgYXJnMiwgYXJnMyk7CiAgICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAvLyBhbnkgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyBhIHZhbHVlIG5lZWRzIHRvIGJlIHdyYXBwZWQKICAgICAgICAgICAgdmFsdWUgPSBqcUxpdGUodmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBqcUxpdGVBZGROb2Rlcyh2YWx1ZSwgZm4odGhpc1tpXSwgYXJnMSwgYXJnMiwgYXJnMykpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gaXNEZWZpbmVkKHZhbHVlKSA/IHZhbHVlIDogdGhpczsKICAgIH07CgogICAgLy8gYmluZCBsZWdhY3kgYmluZC91bmJpbmQgdG8gb24vb2ZmCiAgICBKUUxpdGUucHJvdG90eXBlLmJpbmQgPSBKUUxpdGUucHJvdG90eXBlLm9uOwogICAgSlFMaXRlLnByb3RvdHlwZS51bmJpbmQgPSBKUUxpdGUucHJvdG90eXBlLm9mZjsKICB9KTsKCiAgLyoqCiAgICogQ29tcHV0ZXMgYSBoYXNoIG9mIGFuICdvYmonLgogICAqIEhhc2ggb2YgYToKICAgKiAgc3RyaW5nIGlzIHN0cmluZwogICAqICBudW1iZXIgaXMgbnVtYmVyIGFzIHN0cmluZwogICAqICBvYmplY3QgaXMgZWl0aGVyIHJlc3VsdCBvZiBjYWxsaW5nICQkaGFzaEtleSBmdW5jdGlvbiBvbiB0aGUgb2JqZWN0IG9yIHVuaXF1ZWx5IGdlbmVyYXRlZCBpZCwKICAgKiAgICAgICAgIHRoYXQgaXMgYWxzbyBhc3NpZ25lZCB0byB0aGUgJCRoYXNoS2V5IHByb3BlcnR5IG9mIHRoZSBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0gb2JqCiAgICogQHJldHVybnMge3N0cmluZ30gaGFzaCBzdHJpbmcgc3VjaCB0aGF0IHRoZSBzYW1lIGlucHV0IHdpbGwgaGF2ZSB0aGUgc2FtZSBoYXNoIHN0cmluZy4KICAgKiAgICAgICAgIFRoZSByZXN1bHRpbmcgc3RyaW5nIGtleSBpcyBpbiAndHlwZTpoYXNoS2V5JyBmb3JtYXQuCiAgICovCiAgZnVuY3Rpb24gaGFzaEtleShvYmopIHsKICAgIHZhciBvYmpUeXBlID0gdHlwZW9mIG9iaiwKICAgICAga2V5OwoKICAgIGlmIChvYmpUeXBlID09ICdvYmplY3QnICYmIG9iaiAhPT0gbnVsbCkgewogICAgICBpZiAodHlwZW9mIChrZXkgPSBvYmouJCRoYXNoS2V5KSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgLy8gbXVzdCBpbnZva2Ugb24gb2JqZWN0IHRvIGtlZXAgdGhlIHJpZ2h0IHRoaXMKICAgICAgICBrZXkgPSBvYmouJCRoYXNoS2V5KCk7CiAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBrZXkgPSBvYmouJCRoYXNoS2V5ID0gbmV4dFVpZCgpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBrZXkgPSBvYmo7CiAgICB9CgogICAgcmV0dXJuIG9ialR5cGUgKyAnOicgKyBrZXk7CiAgfQoKICAvKioKICAgKiBIYXNoTWFwIHdoaWNoIGNhbiB1c2Ugb2JqZWN0cyBhcyBrZXlzCiAgICovCiAgZnVuY3Rpb24gSGFzaE1hcChhcnJheSl7CiAgICBmb3JFYWNoKGFycmF5LCB0aGlzLnB1dCwgdGhpcyk7CiAgfQogIEhhc2hNYXAucHJvdG90eXBlID0gewogICAgLyoqCiAgICAgKiBTdG9yZSBrZXkgdmFsdWUgcGFpcgogICAgICogQHBhcmFtIGtleSBrZXkgdG8gc3RvcmUgY2FuIGJlIGFueSB0eXBlCiAgICAgKiBAcGFyYW0gdmFsdWUgdmFsdWUgdG8gc3RvcmUgY2FuIGJlIGFueSB0eXBlCiAgICAgKi8KICAgIHB1dDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICB0aGlzW2hhc2hLZXkoa2V5KV0gPSB2YWx1ZTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBAcGFyYW0ga2V5CiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSB0aGUgdmFsdWUgZm9yIHRoZSBrZXkKICAgICAqLwogICAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgcmV0dXJuIHRoaXNbaGFzaEtleShrZXkpXTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBSZW1vdmUgdGhlIGtleS92YWx1ZSBwYWlyCiAgICAgKiBAcGFyYW0ga2V5CiAgICAgKi8KICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5KSB7CiAgICAgIHZhciB2YWx1ZSA9IHRoaXNba2V5ID0gaGFzaEtleShrZXkpXTsKICAgICAgZGVsZXRlIHRoaXNba2V5XTsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogIH07CgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBtb2R1bGUgbmcKICAgKiBAbmFtZSBhbmd1bGFyLmluamVjdG9yCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYW4gaW5qZWN0b3IgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCBmb3IgcmV0cmlldmluZyBzZXJ2aWNlcyBhcyB3ZWxsIGFzIGZvcgogICAqIGRlcGVuZGVuY3kgaW5qZWN0aW9uIChzZWUge0BsaW5rIGd1aWRlL2RpIGRlcGVuZGVuY3kgaW5qZWN0aW9ufSkuCiAgICoKCiAgICogQHBhcmFtIHtBcnJheS48c3RyaW5nfEZ1bmN0aW9uPn0gbW9kdWxlcyBBIGxpc3Qgb2YgbW9kdWxlIGZ1bmN0aW9ucyBvciB0aGVpciBhbGlhc2VzLiBTZWUKICAgKiAgICAgICAge0BsaW5rIGFuZ3VsYXIubW9kdWxlfS4gVGhlIGBuZ2AgbW9kdWxlIG11c3QgYmUgZXhwbGljaXRseSBhZGRlZC4KICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gSW5qZWN0b3IgZnVuY3Rpb24uIFNlZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4KICAgKgogICAqIEBleGFtcGxlCiAgICogVHlwaWNhbCB1c2FnZQogICAqIGBgYGpzCiAgICogICAvLyBjcmVhdGUgYW4gaW5qZWN0b3IKICAgKiAgIHZhciAkaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKFsnbmcnXSk7CiAgICoKICAgKiAgIC8vIHVzZSB0aGUgaW5qZWN0b3IgdG8ga2ljayBvZmYgeW91ciBhcHBsaWNhdGlvbgogICAqICAgLy8gdXNlIHRoZSB0eXBlIGluZmVyZW5jZSB0byBhdXRvIGluamVjdCBhcmd1bWVudHMsIG9yIHVzZSBpbXBsaWNpdCBpbmplY3Rpb24KICAgKiAgICRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJHJvb3RTY29wZSwgJGNvbXBpbGUsICRkb2N1bWVudCl7CiAqICAgICAkY29tcGlsZSgkZG9jdW1lbnQpKCRyb290U2NvcGUpOwogKiAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAqICAgfSk7CiAgICogYGBgCiAgICoKICAgKiBTb21ldGltZXMgeW91IHdhbnQgdG8gZ2V0IGFjY2VzcyB0byB0aGUgaW5qZWN0b3Igb2YgYSBjdXJyZW50bHkgcnVubmluZyBBbmd1bGFyIGFwcAogICAqIGZyb20gb3V0c2lkZSBBbmd1bGFyLiBQZXJoYXBzLCB5b3Ugd2FudCB0byBpbmplY3QgYW5kIGNvbXBpbGUgc29tZSBtYXJrdXAgYWZ0ZXIgdGhlCiAgICogYXBwbGljYXRpb24gaGFzIGJlZW4gYm9vdHN0cmFwcGVkLiBZb3UgY2FuIGRvIHRoaXMgdXNpbmcgdGhlIGV4dHJhIGBpbmplY3RvcigpYCBhZGRlZAogICAqIHRvIEpRdWVyeS9qcUxpdGUgZWxlbWVudHMuIFNlZSB7QGxpbmsgYW5ndWxhci5lbGVtZW50fS4KICAgKgogICAqICpUaGlzIGlzIGZhaXJseSByYXJlIGJ1dCBjb3VsZCBiZSB0aGUgY2FzZSBpZiBhIHRoaXJkIHBhcnR5IGxpYnJhcnkgaXMgaW5qZWN0aW5nIHRoZQogICAqIG1hcmt1cC4qCiAgICoKICAgKiBJbiB0aGUgZm9sbG93aW5nIGV4YW1wbGUgYSBuZXcgYmxvY2sgb2YgSFRNTCBjb250YWluaW5nIGEgYG5nLWNvbnRyb2xsZXJgCiAgICogZGlyZWN0aXZlIGlzIGFkZGVkIHRvIHRoZSBlbmQgb2YgdGhlIGRvY3VtZW50IGJvZHkgYnkgSlF1ZXJ5LiBXZSB0aGVuIGNvbXBpbGUgYW5kIGxpbmsKICAgKiBpdCBpbnRvIHRoZSBjdXJyZW50IEFuZ3VsYXJKUyBzY29wZS4KICAgKgogICAqIGBgYGpzCiAgICogdmFyICRkaXYgPSAkKCc8ZGl2IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+e3tjb250ZW50LmxhYmVsfX08L2Rpdj4nKTsKICAgKiAkKGRvY3VtZW50LmJvZHkpLmFwcGVuZCgkZGl2KTsKICAgKgogICAqIGFuZ3VsYXIuZWxlbWVudChkb2N1bWVudCkuaW5qZWN0b3IoKS5pbnZva2UoZnVuY3Rpb24oJGNvbXBpbGUpIHsKICogICB2YXIgc2NvcGUgPSBhbmd1bGFyLmVsZW1lbnQoJGRpdikuc2NvcGUoKTsKICogICAkY29tcGlsZSgkZGl2KShzY29wZSk7CiAqIH0pOwogICAqIGBgYAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIG1vZHVsZQogICAqIEBuYW1lIGF1dG8KICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIEltcGxpY2l0IG1vZHVsZSB3aGljaCBnZXRzIGF1dG9tYXRpY2FsbHkgYWRkZWQgdG8gZWFjaCB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4KICAgKi8KCiAgdmFyIEZOX0FSR1MgPSAvXmZ1bmN0aW9uXHMqW15cKF0qXChccyooW15cKV0qKVwpL207CiAgdmFyIEZOX0FSR19TUExJVCA9IC8sLzsKICB2YXIgRk5fQVJHID0gL15ccyooXz8pKFxTKz8pXDFccyokLzsKICB2YXIgU1RSSVBfQ09NTUVOVFMgPSAvKChcL1wvLiokKXwoXC9cKltcc1xTXSo/XCpcLykpL21nOwogIHZhciAkaW5qZWN0b3JNaW5FcnIgPSBtaW5FcnIoJyRpbmplY3RvcicpOwogIGZ1bmN0aW9uIGFubm90YXRlKGZuKSB7CiAgICB2YXIgJGluamVjdCwKICAgICAgZm5UZXh0LAogICAgICBhcmdEZWNsLAogICAgICBsYXN0OwoKICAgIGlmICh0eXBlb2YgZm4gPT0gJ2Z1bmN0aW9uJykgewogICAgICBpZiAoISgkaW5qZWN0ID0gZm4uJGluamVjdCkpIHsKICAgICAgICAkaW5qZWN0ID0gW107CiAgICAgICAgaWYgKGZuLmxlbmd0aCkgewogICAgICAgICAgZm5UZXh0ID0gZm4udG9TdHJpbmcoKS5yZXBsYWNlKFNUUklQX0NPTU1FTlRTLCAnJyk7CiAgICAgICAgICBhcmdEZWNsID0gZm5UZXh0Lm1hdGNoKEZOX0FSR1MpOwogICAgICAgICAgZm9yRWFjaChhcmdEZWNsWzFdLnNwbGl0KEZOX0FSR19TUExJVCksIGZ1bmN0aW9uKGFyZyl7CiAgICAgICAgICAgIGFyZy5yZXBsYWNlKEZOX0FSRywgZnVuY3Rpb24oYWxsLCB1bmRlcnNjb3JlLCBuYW1lKXsKICAgICAgICAgICAgICAkaW5qZWN0LnB1c2gobmFtZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZuLiRpbmplY3QgPSAkaW5qZWN0OwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzQXJyYXkoZm4pKSB7CiAgICAgIGxhc3QgPSBmbi5sZW5ndGggLSAxOwogICAgICBhc3NlcnRBcmdGbihmbltsYXN0XSwgJ2ZuJyk7CiAgICAgICRpbmplY3QgPSBmbi5zbGljZSgwLCBsYXN0KTsKICAgIH0gZWxzZSB7CiAgICAgIGFzc2VydEFyZ0ZuKGZuLCAnZm4nLCB0cnVlKTsKICAgIH0KICAgIHJldHVybiAkaW5qZWN0OwogIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRpbmplY3RvcgogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIGAkaW5qZWN0b3JgIGlzIHVzZWQgdG8gcmV0cmlldmUgb2JqZWN0IGluc3RhbmNlcyBhcyBkZWZpbmVkIGJ5CiAgICoge0BsaW5rIGF1dG8uJHByb3ZpZGUgcHJvdmlkZXJ9LCBpbnN0YW50aWF0ZSB0eXBlcywgaW52b2tlIG1ldGhvZHMsCiAgICogYW5kIGxvYWQgbW9kdWxlcy4KICAgKgogICAqIFRoZSBmb2xsb3dpbmcgYWx3YXlzIGhvbGRzIHRydWU6CiAgICoKICAgKiBgYGBqcwogICAqICAgdmFyICRpbmplY3RvciA9IGFuZ3VsYXIuaW5qZWN0b3IoKTsKICAgKiAgIGV4cGVjdCgkaW5qZWN0b3IuZ2V0KCckaW5qZWN0b3InKSkudG9CZSgkaW5qZWN0b3IpOwogICAqICAgZXhwZWN0KCRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJGluamVjdG9yKXsKICogICAgIHJldHVybiAkaW5qZWN0b3I7CiAqICAgfSkudG9CZSgkaW5qZWN0b3IpOwogICAqIGBgYAogICAqCiAgICogIyBJbmplY3Rpb24gRnVuY3Rpb24gQW5ub3RhdGlvbgogICAqCiAgICogSmF2YVNjcmlwdCBkb2VzIG5vdCBoYXZlIGFubm90YXRpb25zLCBhbmQgYW5ub3RhdGlvbnMgYXJlIG5lZWRlZCBmb3IgZGVwZW5kZW5jeSBpbmplY3Rpb24uIFRoZQogICAqIGZvbGxvd2luZyBhcmUgYWxsIHZhbGlkIHdheXMgb2YgYW5ub3RhdGluZyBmdW5jdGlvbiB3aXRoIGluamVjdGlvbiBhcmd1bWVudHMgYW5kIGFyZSBlcXVpdmFsZW50LgogICAqCiAgICogYGBganMKICAgKiAgIC8vIGluZmVycmVkIChvbmx5IHdvcmtzIGlmIGNvZGUgbm90IG1pbmlmaWVkL29iZnVzY2F0ZWQpCiAgICogICAkaW5qZWN0b3IuaW52b2tlKGZ1bmN0aW9uKHNlcnZpY2VBKXt9KTsKICAgKgogICAqICAgLy8gYW5ub3RhdGVkCiAgICogICBmdW5jdGlvbiBleHBsaWNpdChzZXJ2aWNlQSkge307CiAgICogICBleHBsaWNpdC4kaW5qZWN0ID0gWydzZXJ2aWNlQSddOwogICAqICAgJGluamVjdG9yLmludm9rZShleHBsaWNpdCk7CiAgICoKICAgKiAgIC8vIGlubGluZQogICAqICAgJGluamVjdG9yLmludm9rZShbJ3NlcnZpY2VBJywgZnVuY3Rpb24oc2VydmljZUEpe31dKTsKICAgKiBgYGAKICAgKgogICAqICMjIEluZmVyZW5jZQogICAqCiAgICogSW4gSmF2YVNjcmlwdCBjYWxsaW5nIGB0b1N0cmluZygpYCBvbiBhIGZ1bmN0aW9uIHJldHVybnMgdGhlIGZ1bmN0aW9uIGRlZmluaXRpb24uIFRoZSBkZWZpbml0aW9uCiAgICogY2FuIHRoZW4gYmUgcGFyc2VkIGFuZCB0aGUgZnVuY3Rpb24gYXJndW1lbnRzIGNhbiBiZSBleHRyYWN0ZWQuICpOT1RFOiogVGhpcyBkb2VzIG5vdCB3b3JrIHdpdGgKICAgKiBtaW5pZmljYXRpb24sIGFuZCBvYmZ1c2NhdGlvbiB0b29scyBzaW5jZSB0aGVzZSB0b29scyBjaGFuZ2UgdGhlIGFyZ3VtZW50IG5hbWVzLgogICAqCiAgICogIyMgYCRpbmplY3RgIEFubm90YXRpb24KICAgKiBCeSBhZGRpbmcgYW4gYCRpbmplY3RgIHByb3BlcnR5IG9udG8gYSBmdW5jdGlvbiB0aGUgaW5qZWN0aW9uIHBhcmFtZXRlcnMgY2FuIGJlIHNwZWNpZmllZC4KICAgKgogICAqICMjIElubGluZQogICAqIEFzIGFuIGFycmF5IG9mIGluamVjdGlvbiBuYW1lcywgd2hlcmUgdGhlIGxhc3QgaXRlbSBpbiB0aGUgYXJyYXkgaXMgdGhlIGZ1bmN0aW9uIHRvIGNhbGwuCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW5qZWN0b3IjZ2V0CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXR1cm4gYW4gaW5zdGFuY2Ugb2YgdGhlIHNlcnZpY2UuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UgdG8gcmV0cmlldmUuCiAgICogQHJldHVybiB7Kn0gVGhlIGluc3RhbmNlLgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGluamVjdG9yI2ludm9rZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogSW52b2tlIHRoZSBtZXRob2QgYW5kIHN1cHBseSB0aGUgbWV0aG9kIGFyZ3VtZW50cyBmcm9tIHRoZSBgJGluamVjdG9yYC4KICAgKgogICAqIEBwYXJhbSB7IUZ1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gaW52b2tlLiBGdW5jdGlvbiBwYXJhbWV0ZXJzIGFyZSBpbmplY3RlZCBhY2NvcmRpbmcgdG8gdGhlCiAgICogICB7QGxpbmsgZ3VpZGUvZGkgJGluamVjdCBBbm5vdGF0aW9ufSBydWxlcy4KICAgKiBAcGFyYW0ge09iamVjdD19IHNlbGYgVGhlIGB0aGlzYCBmb3IgdGhlIGludm9rZWQgbWV0aG9kLgogICAqIEBwYXJhbSB7T2JqZWN0PX0gbG9jYWxzIE9wdGlvbmFsIG9iamVjdC4gSWYgcHJlc2V0IHRoZW4gYW55IGFyZ3VtZW50IG5hbWVzIGFyZSByZWFkIGZyb20gdGhpcwogICAqICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdCBmaXJzdCwgYmVmb3JlIHRoZSBgJGluamVjdG9yYCBpcyBjb25zdWx0ZWQuCiAgICogQHJldHVybnMgeyp9IHRoZSB2YWx1ZSByZXR1cm5lZCBieSB0aGUgaW52b2tlZCBgZm5gIGZ1bmN0aW9uLgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGluamVjdG9yI2hhcwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQWxsb3dzIHRoZSB1c2VyIHRvIHF1ZXJ5IGlmIHRoZSBwYXJ0aWN1bGFyIHNlcnZpY2UgZXhpc3RzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IE5hbWUgb2YgdGhlIHNlcnZpY2UgdG8gcXVlcnkuCiAgICogQHJldHVybnMge2Jvb2xlYW59IHJldHVybnMgdHJ1ZSBpZiBpbmplY3RvciBoYXMgZ2l2ZW4gc2VydmljZS4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpbmplY3RvciNpbnN0YW50aWF0ZQogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBKUyB0eXBlLiBUaGUgbWV0aG9kIHRha2VzIGEgY29uc3RydWN0b3IgZnVuY3Rpb24sIGludm9rZXMgdGhlIG5ldwogICAqIG9wZXJhdG9yLCBhbmQgc3VwcGxpZXMgYWxsIG9mIHRoZSBhcmd1bWVudHMgdG8gdGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGFzIHNwZWNpZmllZCBieSB0aGUKICAgKiBjb25zdHJ1Y3RvciBhbm5vdGF0aW9uLgogICAqCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gVHlwZSBBbm5vdGF0ZWQgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzCiAgICogb2JqZWN0IGZpcnN0LCBiZWZvcmUgdGhlIGAkaW5qZWN0b3JgIGlzIGNvbnN1bHRlZC4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBuZXcgaW5zdGFuY2Ugb2YgYFR5cGVgLgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGluamVjdG9yI2Fubm90YXRlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXR1cm5zIGFuIGFycmF5IG9mIHNlcnZpY2UgbmFtZXMgd2hpY2ggdGhlIGZ1bmN0aW9uIGlzIHJlcXVlc3RpbmcgZm9yIGluamVjdGlvbi4gVGhpcyBBUEkgaXMKICAgKiB1c2VkIGJ5IHRoZSBpbmplY3RvciB0byBkZXRlcm1pbmUgd2hpY2ggc2VydmljZXMgbmVlZCB0byBiZSBpbmplY3RlZCBpbnRvIHRoZSBmdW5jdGlvbiB3aGVuIHRoZQogICAqIGZ1bmN0aW9uIGlzIGludm9rZWQuIFRoZXJlIGFyZSB0aHJlZSB3YXlzIGluIHdoaWNoIHRoZSBmdW5jdGlvbiBjYW4gYmUgYW5ub3RhdGVkIHdpdGggdGhlIG5lZWRlZAogICAqIGRlcGVuZGVuY2llcy4KICAgKgogICAqICMgQXJndW1lbnQgbmFtZXMKICAgKgogICAqIFRoZSBzaW1wbGVzdCBmb3JtIGlzIHRvIGV4dHJhY3QgdGhlIGRlcGVuZGVuY2llcyBmcm9tIHRoZSBhcmd1bWVudHMgb2YgdGhlIGZ1bmN0aW9uLiBUaGlzIGlzIGRvbmUKICAgKiBieSBjb252ZXJ0aW5nIHRoZSBmdW5jdGlvbiBpbnRvIGEgc3RyaW5nIHVzaW5nIGB0b1N0cmluZygpYCBtZXRob2QgYW5kIGV4dHJhY3RpbmcgdGhlIGFyZ3VtZW50CiAgICogbmFtZXMuCiAgICogYGBganMKICAgKiAgIC8vIEdpdmVuCiAgICogICBmdW5jdGlvbiBNeUNvbnRyb2xsZXIoJHNjb3BlLCAkcm91dGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0KICAgKgogICAqICAgLy8gVGhlbgogICAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKE15Q29udHJvbGxlcikpLnRvRXF1YWwoWyckc2NvcGUnLCAnJHJvdXRlJ10pOwogICAqIGBgYAogICAqCiAgICogVGhpcyBtZXRob2QgZG9lcyBub3Qgd29yayB3aXRoIGNvZGUgbWluaWZpY2F0aW9uIC8gb2JmdXNjYXRpb24uIEZvciB0aGlzIHJlYXNvbiB0aGUgZm9sbG93aW5nCiAgICogYW5ub3RhdGlvbiBzdHJhdGVnaWVzIGFyZSBzdXBwb3J0ZWQuCiAgICoKICAgKiAjIFRoZSBgJGluamVjdGAgcHJvcGVydHkKICAgKgogICAqIElmIGEgZnVuY3Rpb24gaGFzIGFuIGAkaW5qZWN0YCBwcm9wZXJ0eSBhbmQgaXRzIHZhbHVlIGlzIGFuIGFycmF5IG9mIHN0cmluZ3MsIHRoZW4gdGhlIHN0cmluZ3MKICAgKiByZXByZXNlbnQgbmFtZXMgb2Ygc2VydmljZXMgdG8gYmUgaW5qZWN0ZWQgaW50byB0aGUgZnVuY3Rpb24uCiAgICogYGBganMKICAgKiAgIC8vIEdpdmVuCiAgICogICB2YXIgTXlDb250cm9sbGVyID0gZnVuY3Rpb24ob2JmdXNjYXRlZFNjb3BlLCBvYmZ1c2NhdGVkUm91dGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0KICAgKiAgIC8vIERlZmluZSBmdW5jdGlvbiBkZXBlbmRlbmNpZXMKICAgKiAgIE15Q29udHJvbGxlclsnJGluamVjdCddID0gWyckc2NvcGUnLCAnJHJvdXRlJ107CiAgICoKICAgKiAgIC8vIFRoZW4KICAgKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZShNeUNvbnRyb2xsZXIpKS50b0VxdWFsKFsnJHNjb3BlJywgJyRyb3V0ZSddKTsKICAgKiBgYGAKICAgKgogICAqICMgVGhlIGFycmF5IG5vdGF0aW9uCiAgICoKICAgKiBJdCBpcyBvZnRlbiBkZXNpcmFibGUgdG8gaW5saW5lIEluamVjdGVkIGZ1bmN0aW9ucyBhbmQgdGhhdCdzIHdoZW4gc2V0dGluZyB0aGUgYCRpbmplY3RgIHByb3BlcnR5CiAgICogaXMgdmVyeSBpbmNvbnZlbmllbnQuIEluIHRoZXNlIHNpdHVhdGlvbnMgdXNpbmcgdGhlIGFycmF5IG5vdGF0aW9uIHRvIHNwZWNpZnkgdGhlIGRlcGVuZGVuY2llcyBpbgogICAqIGEgd2F5IHRoYXQgc3Vydml2ZXMgbWluaWZpY2F0aW9uIGlzIGEgYmV0dGVyIGNob2ljZToKICAgKgogICAqIGBgYGpzCiAgICogICAvLyBXZSB3aXNoIHRvIHdyaXRlIHRoaXMgKG5vdCBtaW5pZmljYXRpb24gLyBvYmZ1c2NhdGlvbiBzYWZlKQogICAqICAgaW5qZWN0b3IuaW52b2tlKGZ1bmN0aW9uKCRjb21waWxlLCAkcm9vdFNjb3BlKSB7CiAqICAgICAvLyAuLi4KICogICB9KTsKICAgKgogICAqICAgLy8gV2UgYXJlIGZvcmNlZCB0byB3cml0ZSBicmVhayBpbmxpbmluZwogICAqICAgdmFyIHRtcEZuID0gZnVuY3Rpb24ob2JmdXNjYXRlZENvbXBpbGUsIG9iZnVzY2F0ZWRSb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH07CiAgICogICB0bXBGbi4kaW5qZWN0ID0gWyckY29tcGlsZScsICckcm9vdFNjb3BlJ107CiAgICogICBpbmplY3Rvci5pbnZva2UodG1wRm4pOwogICAqCiAgICogICAvLyBUbyBiZXR0ZXIgc3VwcG9ydCBpbmxpbmUgZnVuY3Rpb24gdGhlIGlubGluZSBhbm5vdGF0aW9uIGlzIHN1cHBvcnRlZAogICAqICAgaW5qZWN0b3IuaW52b2tlKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKG9iZkNvbXBpbGUsIG9iZlJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfV0pOwogICAqCiAgICogICAvLyBUaGVyZWZvcmUKICAgKiAgIGV4cGVjdChpbmplY3Rvci5hbm5vdGF0ZSgKICAgKiAgICAgIFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKG9iZnVzXyRjb21waWxlLCBvYmZ1c18kcm9vdFNjb3BlKSB7fV0pCiAgICogICAgKS50b0VxdWFsKFsnJGNvbXBpbGUnLCAnJHJvb3RTY29wZSddKTsKICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXkuPHN0cmluZ3xGdW5jdGlvbj59IGZuIEZ1bmN0aW9uIGZvciB3aGljaCBkZXBlbmRlbnQgc2VydmljZSBuYW1lcyBuZWVkIHRvCiAgICogYmUgcmV0cmlldmVkIGFzIGRlc2NyaWJlZCBhYm92ZS4KICAgKgogICAqIEByZXR1cm5zIHtBcnJheS48c3RyaW5nPn0gVGhlIG5hbWVzIG9mIHRoZSBzZXJ2aWNlcyB3aGljaCB0aGUgZnVuY3Rpb24gcmVxdWlyZXMuCiAgICovCgoKCgogIC8qKgogICAqIEBuZ2RvYyBvYmplY3QKICAgKiBAbmFtZSAkcHJvdmlkZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBUaGUge0BsaW5rIGF1dG8uJHByb3ZpZGUgJHByb3ZpZGV9IHNlcnZpY2UgaGFzIGEgbnVtYmVyIG9mIG1ldGhvZHMgZm9yIHJlZ2lzdGVyaW5nIGNvbXBvbmVudHMKICAgKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4gTWFueSBvZiB0aGVzZSBmdW5jdGlvbnMgYXJlIGFsc28gZXhwb3NlZCBvbgogICAqIHtAbGluayBhbmd1bGFyLk1vZHVsZX0uCiAgICoKICAgKiBBbiBBbmd1bGFyICoqc2VydmljZSoqIGlzIGEgc2luZ2xldG9uIG9iamVjdCBjcmVhdGVkIGJ5IGEgKipzZXJ2aWNlIGZhY3RvcnkqKi4gIFRoZXNlICoqc2VydmljZQogICAqIGZhY3RvcmllcyoqIGFyZSBmdW5jdGlvbnMgd2hpY2gsIGluIHR1cm4sIGFyZSBjcmVhdGVkIGJ5IGEgKipzZXJ2aWNlIHByb3ZpZGVyKiouCiAgICogVGhlICoqc2VydmljZSBwcm92aWRlcnMqKiBhcmUgY29uc3RydWN0b3IgZnVuY3Rpb25zLiBXaGVuIGluc3RhbnRpYXRlZCB0aGV5IG11c3QgY29udGFpbiBhCiAgICogcHJvcGVydHkgY2FsbGVkIGAkZ2V0YCwgd2hpY2ggaG9sZHMgdGhlICoqc2VydmljZSBmYWN0b3J5KiogZnVuY3Rpb24uCiAgICoKICAgKiBXaGVuIHlvdSByZXF1ZXN0IGEgc2VydmljZSwgdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9IGlzIHJlc3BvbnNpYmxlIGZvciBmaW5kaW5nIHRoZQogICAqIGNvcnJlY3QgKipzZXJ2aWNlIHByb3ZpZGVyKiosIGluc3RhbnRpYXRpbmcgaXQgYW5kIHRoZW4gY2FsbGluZyBpdHMgYCRnZXRgICoqc2VydmljZSBmYWN0b3J5KioKICAgKiBmdW5jdGlvbiB0byBnZXQgdGhlIGluc3RhbmNlIG9mIHRoZSAqKnNlcnZpY2UqKi4KICAgKgogICAqIE9mdGVuIHNlcnZpY2VzIGhhdmUgbm8gY29uZmlndXJhdGlvbiBvcHRpb25zIGFuZCB0aGVyZSBpcyBubyBuZWVkIHRvIGFkZCBtZXRob2RzIHRvIHRoZSBzZXJ2aWNlCiAgICogcHJvdmlkZXIuICBUaGUgcHJvdmlkZXIgd2lsbCBiZSBubyBtb3JlIHRoYW4gYSBjb25zdHJ1Y3RvciBmdW5jdGlvbiB3aXRoIGEgYCRnZXRgIHByb3BlcnR5LiBGb3IKICAgKiB0aGVzZSBjYXNlcyB0aGUge0BsaW5rIGF1dG8uJHByb3ZpZGUgJHByb3ZpZGV9IHNlcnZpY2UgaGFzIGFkZGl0aW9uYWwgaGVscGVyIG1ldGhvZHMgdG8gcmVnaXN0ZXIKICAgKiBzZXJ2aWNlcyB3aXRob3V0IHNwZWNpZnlpbmcgYSBwcm92aWRlci4KICAgKgogICAqICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjcHJvdmlkZXIgcHJvdmlkZXIocHJvdmlkZXIpfSAtIHJlZ2lzdGVycyBhICoqc2VydmljZSBwcm92aWRlcioqIHdpdGggdGhlCiAgICogICAgIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9CiAgICogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNjb25zdGFudCBjb25zdGFudChvYmopfSAtIHJlZ2lzdGVycyBhIHZhbHVlL29iamVjdCB0aGF0IGNhbiBiZSBhY2Nlc3NlZCBieQogICAqICAgICBwcm92aWRlcnMgYW5kIHNlcnZpY2VzLgogICAqICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjdmFsdWUgdmFsdWUob2JqKX0gLSByZWdpc3RlcnMgYSB2YWx1ZS9vYmplY3QgdGhhdCBjYW4gb25seSBiZSBhY2Nlc3NlZCBieQogICAqICAgICBzZXJ2aWNlcywgbm90IHByb3ZpZGVycy4KICAgKiAqIHtAbGluayBhdXRvLiRwcm92aWRlI2ZhY3RvcnkgZmFjdG9yeShmbil9IC0gcmVnaXN0ZXJzIGEgc2VydmljZSAqKmZhY3RvcnkgZnVuY3Rpb24qKiwgYGZuYCwKICAgKiAgICAgdGhhdCB3aWxsIGJlIHdyYXBwZWQgaW4gYSAqKnNlcnZpY2UgcHJvdmlkZXIqKiBvYmplY3QsIHdob3NlIGAkZ2V0YCBwcm9wZXJ0eSB3aWxsIGNvbnRhaW4gdGhlCiAgICogICAgIGdpdmVuIGZhY3RvcnkgZnVuY3Rpb24uCiAgICogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNzZXJ2aWNlIHNlcnZpY2UoY2xhc3MpfSAtIHJlZ2lzdGVycyBhICoqY29uc3RydWN0b3IgZnVuY3Rpb24qKiwgYGNsYXNzYAogICAqICAgICB0aGF0IHdpbGwgYmUgd3JhcHBlZCBpbiBhICoqc2VydmljZSBwcm92aWRlcioqIG9iamVjdCwgd2hvc2UgYCRnZXRgIHByb3BlcnR5IHdpbGwgaW5zdGFudGlhdGUKICAgKiAgICAgIGEgbmV3IG9iamVjdCB1c2luZyB0aGUgZ2l2ZW4gY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICoKICAgKiBTZWUgdGhlIGluZGl2aWR1YWwgbWV0aG9kcyBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhbmQgZXhhbXBsZXMuCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkcHJvdmlkZSNwcm92aWRlcgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogUmVnaXN0ZXIgYSAqKnByb3ZpZGVyIGZ1bmN0aW9uKiogd2l0aCB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0uIFByb3ZpZGVyIGZ1bmN0aW9ucwogICAqIGFyZSBjb25zdHJ1Y3RvciBmdW5jdGlvbnMsIHdob3NlIGluc3RhbmNlcyBhcmUgcmVzcG9uc2libGUgZm9yICJwcm92aWRpbmciIGEgZmFjdG9yeSBmb3IgYQogICAqIHNlcnZpY2UuCiAgICoKICAgKiBTZXJ2aWNlIHByb3ZpZGVyIG5hbWVzIHN0YXJ0IHdpdGggdGhlIG5hbWUgb2YgdGhlIHNlcnZpY2UgdGhleSBwcm92aWRlIGZvbGxvd2VkIGJ5IGBQcm92aWRlcmAuCiAgICogRm9yIGV4YW1wbGUsIHRoZSB7QGxpbmsgbmcuJGxvZyAkbG9nfSBzZXJ2aWNlIGhhcyBhIHByb3ZpZGVyIGNhbGxlZAogICAqIHtAbGluayBuZy4kbG9nUHJvdmlkZXIgJGxvZ1Byb3ZpZGVyfS4KICAgKgogICAqIFNlcnZpY2UgcHJvdmlkZXIgb2JqZWN0cyBjYW4gaGF2ZSBhZGRpdGlvbmFsIG1ldGhvZHMgd2hpY2ggYWxsb3cgY29uZmlndXJhdGlvbiBvZiB0aGUgcHJvdmlkZXIKICAgKiBhbmQgaXRzIHNlcnZpY2UuIEltcG9ydGFudGx5LCB5b3UgY2FuIGNvbmZpZ3VyZSB3aGF0IGtpbmQgb2Ygc2VydmljZSBpcyBjcmVhdGVkIGJ5IHRoZSBgJGdldGAKICAgKiBtZXRob2QsIG9yIGhvdyB0aGF0IHNlcnZpY2Ugd2lsbCBhY3QuIEZvciBleGFtcGxlLCB0aGUge0BsaW5rIG5nLiRsb2dQcm92aWRlciAkbG9nUHJvdmlkZXJ9IGhhcyBhCiAgICogbWV0aG9kIHtAbGluayBuZy4kbG9nUHJvdmlkZXIjZGVidWdFbmFibGVkIGRlYnVnRW5hYmxlZH0KICAgKiB3aGljaCBsZXRzIHlvdSBzcGVjaWZ5IHdoZXRoZXIgdGhlIHtAbGluayBuZy4kbG9nICRsb2d9IHNlcnZpY2Ugd2lsbCBsb2cgZGVidWcgbWVzc2FnZXMgdG8gdGhlCiAgICogY29uc29sZSBvciBub3QuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuIE5PVEU6IHRoZSBwcm92aWRlciB3aWxsIGJlIGF2YWlsYWJsZSB1bmRlciBgbmFtZSArCiAgICdQcm92aWRlcidgIGtleS4KICAgKiBAcGFyYW0geyhPYmplY3R8ZnVuY3Rpb24oKSl9IHByb3ZpZGVyIElmIHRoZSBwcm92aWRlciBpczoKICAgKgogICAqICAgLSBgT2JqZWN0YDogdGhlbiBpdCBzaG91bGQgaGF2ZSBhIGAkZ2V0YCBtZXRob2QuIFRoZSBgJGdldGAgbWV0aG9kIHdpbGwgYmUgaW52b2tlZCB1c2luZwogICAqICAgICB7QGxpbmsgYXV0by4kaW5qZWN0b3IjaW52b2tlICRpbmplY3Rvci5pbnZva2UoKX0gd2hlbiBhbiBpbnN0YW5jZSBuZWVkcyB0byBiZSBjcmVhdGVkLgogICAqICAgLSBgQ29uc3RydWN0b3JgOiBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgcHJvdmlkZXIgd2lsbCBiZSBjcmVhdGVkIHVzaW5nCiAgICogICAgIHtAbGluayBhdXRvLiRpbmplY3RvciNpbnN0YW50aWF0ZSAkaW5qZWN0b3IuaW5zdGFudGlhdGUoKX0sIHRoZW4gdHJlYXRlZCBhcyBgb2JqZWN0YC4KICAgKgogICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKCiAgICogQGV4YW1wbGUKICAgKgogICAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzaG93cyBob3cgdG8gY3JlYXRlIGEgc2ltcGxlIGV2ZW50IHRyYWNraW5nIHNlcnZpY2UgYW5kIHJlZ2lzdGVyIGl0IHVzaW5nCiAgICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjcHJvdmlkZXIgJHByb3ZpZGUucHJvdmlkZXIoKX0uCiAgICoKICAgKiBgYGBqcwogICAqICAvLyBEZWZpbmUgdGhlIGV2ZW50VHJhY2tlciBwcm92aWRlcgogICAqICBmdW5jdGlvbiBFdmVudFRyYWNrZXJQcm92aWRlcigpIHsKICogICAgdmFyIHRyYWNraW5nVXJsID0gJy90cmFjayc7CiAqCiAqICAgIC8vIEEgcHJvdmlkZXIgbWV0aG9kIGZvciBjb25maWd1cmluZyB3aGVyZSB0aGUgdHJhY2tlZCBldmVudHMgc2hvdWxkIGJlZW4gc2F2ZWQKICogICAgdGhpcy5zZXRUcmFja2luZ1VybCA9IGZ1bmN0aW9uKHVybCkgewogKiAgICAgIHRyYWNraW5nVXJsID0gdXJsOwogKiAgICB9OwogKgogKiAgICAvLyBUaGUgc2VydmljZSBmYWN0b3J5IGZ1bmN0aW9uCiAqICAgIHRoaXMuJGdldCA9IFsnJGh0dHAnLCBmdW5jdGlvbigkaHR0cCkgewogKiAgICAgIHZhciB0cmFja2VkRXZlbnRzID0ge307CiAqICAgICAgcmV0dXJuIHsKICogICAgICAgIC8vIENhbGwgdGhpcyB0byB0cmFjayBhbiBldmVudAogKiAgICAgICAgZXZlbnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAqICAgICAgICAgIHZhciBjb3VudCA9IHRyYWNrZWRFdmVudHNbZXZlbnRdIHx8IDA7CiAqICAgICAgICAgIGNvdW50ICs9IDE7CiAqICAgICAgICAgIHRyYWNrZWRFdmVudHNbZXZlbnRdID0gY291bnQ7CiAqICAgICAgICAgIHJldHVybiBjb3VudDsKICogICAgICAgIH0sCiAqICAgICAgICAvLyBDYWxsIHRoaXMgdG8gc2F2ZSB0aGUgdHJhY2tlZCBldmVudHMgdG8gdGhlIHRyYWNraW5nVXJsCiAqICAgICAgICBzYXZlOiBmdW5jdGlvbigpIHsKICogICAgICAgICAgJGh0dHAucG9zdCh0cmFja2luZ1VybCwgdHJhY2tlZEV2ZW50cyk7CiAqICAgICAgICB9CiAqICAgICAgfTsKICogICAgfV07CiAqICB9CiAgICoKICAgKiAgZGVzY3JpYmUoJ2V2ZW50VHJhY2tlcicsIGZ1bmN0aW9uKCkgewogKiAgICB2YXIgcG9zdFNweTsKICoKICogICAgYmVmb3JlRWFjaChtb2R1bGUoZnVuY3Rpb24oJHByb3ZpZGUpIHsKICogICAgICAvLyBSZWdpc3RlciB0aGUgZXZlbnRUcmFja2VyIHByb3ZpZGVyCiAqICAgICAgJHByb3ZpZGUucHJvdmlkZXIoJ2V2ZW50VHJhY2tlcicsIEV2ZW50VHJhY2tlclByb3ZpZGVyKTsKICogICAgfSkpOwogKgogKiAgICBiZWZvcmVFYWNoKG1vZHVsZShmdW5jdGlvbihldmVudFRyYWNrZXJQcm92aWRlcikgewogKiAgICAgIC8vIENvbmZpZ3VyZSBldmVudFRyYWNrZXIgcHJvdmlkZXIKICogICAgICBldmVudFRyYWNrZXJQcm92aWRlci5zZXRUcmFja2luZ1VybCgnL2N1c3RvbS10cmFjaycpOwogKiAgICB9KSk7CiAqCiAqICAgIGl0KCd0cmFja3MgZXZlbnRzJywgaW5qZWN0KGZ1bmN0aW9uKGV2ZW50VHJhY2tlcikgewogKiAgICAgIGV4cGVjdChldmVudFRyYWNrZXIuZXZlbnQoJ2xvZ2luJykpLnRvRXF1YWwoMSk7CiAqICAgICAgZXhwZWN0KGV2ZW50VHJhY2tlci5ldmVudCgnbG9naW4nKSkudG9FcXVhbCgyKTsKICogICAgfSkpOwogKgogKiAgICBpdCgnc2F2ZXMgdG8gdGhlIHRyYWNraW5nIHVybCcsIGluamVjdChmdW5jdGlvbihldmVudFRyYWNrZXIsICRodHRwKSB7CiAqICAgICAgcG9zdFNweSA9IHNweU9uKCRodHRwLCAncG9zdCcpOwogKiAgICAgIGV2ZW50VHJhY2tlci5ldmVudCgnbG9naW4nKTsKICogICAgICBldmVudFRyYWNrZXIuc2F2ZSgpOwogKiAgICAgIGV4cGVjdChwb3N0U3B5KS50b0hhdmVCZWVuQ2FsbGVkKCk7CiAqICAgICAgZXhwZWN0KHBvc3RTcHkubW9zdFJlY2VudENhbGwuYXJnc1swXSkubm90LnRvRXF1YWwoJy90cmFjaycpOwogKiAgICAgIGV4cGVjdChwb3N0U3B5Lm1vc3RSZWNlbnRDYWxsLmFyZ3NbMF0pLnRvRXF1YWwoJy9jdXN0b20tdHJhY2snKTsKICogICAgICBleHBlY3QocG9zdFNweS5tb3N0UmVjZW50Q2FsbC5hcmdzWzFdKS50b0VxdWFsKHsgJ2xvZ2luJzogMSB9KTsKICogICAgfSkpOwogKiAgfSk7CiAgICogYGBgCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkcHJvdmlkZSNmYWN0b3J5CiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBSZWdpc3RlciBhICoqc2VydmljZSBmYWN0b3J5KiosIHdoaWNoIHdpbGwgYmUgY2FsbGVkIHRvIHJldHVybiB0aGUgc2VydmljZSBpbnN0YW5jZS4KICAgKiBUaGlzIGlzIHNob3J0IGZvciByZWdpc3RlcmluZyBhIHNlcnZpY2Ugd2hlcmUgaXRzIHByb3ZpZGVyIGNvbnNpc3RzIG9mIG9ubHkgYSBgJGdldGAgcHJvcGVydHksCiAgICogd2hpY2ggaXMgdGhlIGdpdmVuIHNlcnZpY2UgZmFjdG9yeSBmdW5jdGlvbi4KICAgKiBZb3Ugc2hvdWxkIHVzZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNmYWN0b3J5ICRwcm92aWRlLmZhY3RvcnkoZ2V0Rm4pfSBpZiB5b3UgZG8gbm90IG5lZWQgdG8KICAgKiBjb25maWd1cmUgeW91ciBzZXJ2aWNlIGluIGEgcHJvdmlkZXIuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSAkZ2V0Rm4gVGhlICRnZXRGbiBmb3IgdGhlIGluc3RhbmNlIGNyZWF0aW9uLiBJbnRlcm5hbGx5IHRoaXMgaXMgYSBzaG9ydCBoYW5kCiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGAkcHJvdmlkZS5wcm92aWRlcihuYW1lLCB7JGdldDogJGdldEZufSlgLgogICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICAgKgogICAqIEBleGFtcGxlCiAgICogSGVyZSBpcyBhbiBleGFtcGxlIG9mIHJlZ2lzdGVyaW5nIGEgc2VydmljZQogICAqIGBgYGpzCiAgICogICAkcHJvdmlkZS5mYWN0b3J5KCdwaW5nJywgWyckaHR0cCcsIGZ1bmN0aW9uKCRodHRwKSB7CiAqICAgICByZXR1cm4gZnVuY3Rpb24gcGluZygpIHsKICogICAgICAgcmV0dXJuICRodHRwLnNlbmQoJy9waW5nJyk7CiAqICAgICB9OwogKiAgIH1dKTsKICAgKiBgYGAKICAgKiBZb3Ugd291bGQgdGhlbiBpbmplY3QgYW5kIHVzZSB0aGlzIHNlcnZpY2UgbGlrZSB0aGlzOgogICAqIGBgYGpzCiAgICogICBzb21lTW9kdWxlLmNvbnRyb2xsZXIoJ0N0cmwnLCBbJ3BpbmcnLCBmdW5jdGlvbihwaW5nKSB7CiAqICAgICBwaW5nKCk7CiAqICAgfV0pOwogICAqIGBgYAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRwcm92aWRlI3NlcnZpY2UKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIFJlZ2lzdGVyIGEgKipzZXJ2aWNlIGNvbnN0cnVjdG9yKiosIHdoaWNoIHdpbGwgYmUgaW52b2tlZCB3aXRoIGBuZXdgIHRvIGNyZWF0ZSB0aGUgc2VydmljZQogICAqIGluc3RhbmNlLgogICAqIFRoaXMgaXMgc2hvcnQgZm9yIHJlZ2lzdGVyaW5nIGEgc2VydmljZSB3aGVyZSBpdHMgcHJvdmlkZXIncyBgJGdldGAgcHJvcGVydHkgaXMgdGhlIHNlcnZpY2UKICAgKiBjb25zdHJ1Y3RvciBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgdXNlZCB0byBpbnN0YW50aWF0ZSB0aGUgc2VydmljZSBpbnN0YW5jZS4KICAgKgogICAqIFlvdSBzaG91bGQgdXNlIHtAbGluayBhdXRvLiRwcm92aWRlI3NlcnZpY2UgJHByb3ZpZGUuc2VydmljZShjbGFzcyl9IGlmIHlvdSBkZWZpbmUgeW91ciBzZXJ2aWNlCiAgICogYXMgYSB0eXBlL2NsYXNzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGluc3RhbmNlLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbnN0cnVjdG9yIEEgY2xhc3MgKGNvbnN0cnVjdG9yIGZ1bmN0aW9uKSB0aGF0IHdpbGwgYmUgaW5zdGFudGlhdGVkLgogICAqIEByZXR1cm5zIHtPYmplY3R9IHJlZ2lzdGVyZWQgcHJvdmlkZXIgaW5zdGFuY2UKICAgKgogICAqIEBleGFtcGxlCiAgICogSGVyZSBpcyBhbiBleGFtcGxlIG9mIHJlZ2lzdGVyaW5nIGEgc2VydmljZSB1c2luZwogICAqIHtAbGluayBhdXRvLiRwcm92aWRlI3NlcnZpY2UgJHByb3ZpZGUuc2VydmljZShjbGFzcyl9LgogICAqIGBgYGpzCiAgICogICB2YXIgUGluZyA9IGZ1bmN0aW9uKCRodHRwKSB7CiAqICAgICB0aGlzLiRodHRwID0gJGh0dHA7CiAqICAgfTsKICAgKgogICAqICAgUGluZy4kaW5qZWN0ID0gWyckaHR0cCddOwogICAqCiAgICogICBQaW5nLnByb3RvdHlwZS5zZW5kID0gZnVuY3Rpb24oKSB7CiAqICAgICByZXR1cm4gdGhpcy4kaHR0cC5nZXQoJy9waW5nJyk7CiAqICAgfTsKICAgKiAgICRwcm92aWRlLnNlcnZpY2UoJ3BpbmcnLCBQaW5nKTsKICAgKiBgYGAKICAgKiBZb3Ugd291bGQgdGhlbiBpbmplY3QgYW5kIHVzZSB0aGlzIHNlcnZpY2UgbGlrZSB0aGlzOgogICAqIGBgYGpzCiAgICogICBzb21lTW9kdWxlLmNvbnRyb2xsZXIoJ0N0cmwnLCBbJ3BpbmcnLCBmdW5jdGlvbihwaW5nKSB7CiAqICAgICBwaW5nLnNlbmQoKTsKICogICB9XSk7CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHByb3ZpZGUjdmFsdWUKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIFJlZ2lzdGVyIGEgKip2YWx1ZSBzZXJ2aWNlKiogd2l0aCB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0sIHN1Y2ggYXMgYSBzdHJpbmcsIGEKICAgKiBudW1iZXIsIGFuIGFycmF5LCBhbiBvYmplY3Qgb3IgYSBmdW5jdGlvbi4gIFRoaXMgaXMgc2hvcnQgZm9yIHJlZ2lzdGVyaW5nIGEgc2VydmljZSB3aGVyZSBpdHMKICAgKiBwcm92aWRlcidzIGAkZ2V0YCBwcm9wZXJ0eSBpcyBhIGZhY3RvcnkgZnVuY3Rpb24gdGhhdCB0YWtlcyBubyBhcmd1bWVudHMgYW5kIHJldHVybnMgdGhlICoqdmFsdWUKICAgKiBzZXJ2aWNlKiouCiAgICoKICAgKiBWYWx1ZSBzZXJ2aWNlcyBhcmUgc2ltaWxhciB0byBjb25zdGFudCBzZXJ2aWNlcywgZXhjZXB0IHRoYXQgdGhleSBjYW5ub3QgYmUgaW5qZWN0ZWQgaW50byBhCiAgICogbW9kdWxlIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gKHNlZSB7QGxpbmsgYW5ndWxhci5Nb2R1bGUjY29uZmlnfSkgYnV0IHRoZXkgY2FuIGJlIG92ZXJyaWRkZW4gYnkKICAgKiBhbiBBbmd1bGFyCiAgICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjZGVjb3JhdG9yIGRlY29yYXRvcn0uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUuCiAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAqCiAgICogQGV4YW1wbGUKICAgKiBIZXJlIGFyZSBzb21lIGV4YW1wbGVzIG9mIGNyZWF0aW5nIHZhbHVlIHNlcnZpY2VzLgogICAqIGBgYGpzCiAgICogICAkcHJvdmlkZS52YWx1ZSgnQURNSU5fVVNFUicsICdhZG1pbicpOwogICAqCiAgICogICAkcHJvdmlkZS52YWx1ZSgnUm9sZUxvb2t1cCcsIHsgYWRtaW46IDAsIHdyaXRlcjogMSwgcmVhZGVyOiAyIH0pOwogICAqCiAgICogICAkcHJvdmlkZS52YWx1ZSgnaGFsZk9mJywgZnVuY3Rpb24odmFsdWUpIHsKICogICAgIHJldHVybiB2YWx1ZSAvIDI7CiAqICAgfSk7CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHByb3ZpZGUjY29uc3RhbnQKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIFJlZ2lzdGVyIGEgKipjb25zdGFudCBzZXJ2aWNlKiosIHN1Y2ggYXMgYSBzdHJpbmcsIGEgbnVtYmVyLCBhbiBhcnJheSwgYW4gb2JqZWN0IG9yIGEgZnVuY3Rpb24sCiAgICogd2l0aCB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0uIFVubGlrZSB7QGxpbmsgYXV0by4kcHJvdmlkZSN2YWx1ZSB2YWx1ZX0gaXQgY2FuIGJlCiAgICogaW5qZWN0ZWQgaW50byBhIG1vZHVsZSBjb25maWd1cmF0aW9uIGZ1bmN0aW9uIChzZWUge0BsaW5rIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZ30pIGFuZCBpdCBjYW5ub3QKICAgKiBiZSBvdmVycmlkZGVuIGJ5IGFuIEFuZ3VsYXIge0BsaW5rIGF1dG8uJHByb3ZpZGUjZGVjb3JhdG9yIGRlY29yYXRvcn0uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgY29uc3RhbnQuCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgY29uc3RhbnQgdmFsdWUuCiAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBpbnN0YW5jZQogICAqCiAgICogQGV4YW1wbGUKICAgKiBIZXJlIGEgc29tZSBleGFtcGxlcyBvZiBjcmVhdGluZyBjb25zdGFudHM6CiAgICogYGBganMKICAgKiAgICRwcm92aWRlLmNvbnN0YW50KCdTSEFSRF9IRUlHSFQnLCAzMDYpOwogICAqCiAgICogICAkcHJvdmlkZS5jb25zdGFudCgnTVlfQ09MT1VSUycsIFsncmVkJywgJ2JsdWUnLCAnZ3JleSddKTsKICAgKgogICAqICAgJHByb3ZpZGUuY29uc3RhbnQoJ2RvdWJsZScsIGZ1bmN0aW9uKHZhbHVlKSB7CiAqICAgICByZXR1cm4gdmFsdWUgKiAyOwogKiAgIH0pOwogICAqIGBgYAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRwcm92aWRlI2RlY29yYXRvcgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogUmVnaXN0ZXIgYSAqKnNlcnZpY2UgZGVjb3JhdG9yKiogd2l0aCB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0uIEEgc2VydmljZSBkZWNvcmF0b3IKICAgKiBpbnRlcmNlcHRzIHRoZSBjcmVhdGlvbiBvZiBhIHNlcnZpY2UsIGFsbG93aW5nIGl0IHRvIG92ZXJyaWRlIG9yIG1vZGlmeSB0aGUgYmVoYXZpb3VyIG9mIHRoZQogICAqIHNlcnZpY2UuIFRoZSBvYmplY3QgcmV0dXJuZWQgYnkgdGhlIGRlY29yYXRvciBtYXkgYmUgdGhlIG9yaWdpbmFsIHNlcnZpY2UsIG9yIGEgbmV3IHNlcnZpY2UKICAgKiBvYmplY3Qgd2hpY2ggcmVwbGFjZXMgb3Igd3JhcHMgYW5kIGRlbGVnYXRlcyB0byB0aGUgb3JpZ2luYWwgc2VydmljZS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBzZXJ2aWNlIHRvIGRlY29yYXRlLgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZGVjb3JhdG9yIFRoaXMgZnVuY3Rpb24gd2lsbCBiZSBpbnZva2VkIHdoZW4gdGhlIHNlcnZpY2UgbmVlZHMgdG8gYmUKICAgKiAgICBpbnN0YW50aWF0ZWQgYW5kIHNob3VsZCByZXR1cm4gdGhlIGRlY29yYXRlZCBzZXJ2aWNlIGluc3RhbmNlLiBUaGUgZnVuY3Rpb24gaXMgY2FsbGVkIHVzaW5nCiAgICogICAgdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciNpbnZva2UgaW5qZWN0b3IuaW52b2tlfSBtZXRob2QgYW5kIGlzIHRoZXJlZm9yZSBmdWxseSBpbmplY3RhYmxlLgogICAqICAgIExvY2FsIGluamVjdGlvbiBhcmd1bWVudHM6CiAgICoKICAgKiAgICAqIGAkZGVsZWdhdGVgIC0gVGhlIG9yaWdpbmFsIHNlcnZpY2UgaW5zdGFuY2UsIHdoaWNoIGNhbiBiZSBtb25rZXkgcGF0Y2hlZCwgY29uZmlndXJlZCwKICAgKiAgICAgIGRlY29yYXRlZCBvciBkZWxlZ2F0ZWQgdG8uCiAgICoKICAgKiBAZXhhbXBsZQogICAqIEhlcmUgd2UgZGVjb3JhdGUgdGhlIHtAbGluayBuZy4kbG9nICRsb2d9IHNlcnZpY2UgdG8gY29udmVydCB3YXJuaW5ncyB0byBlcnJvcnMgYnkgaW50ZXJjZXB0aW5nCiAgICogY2FsbHMgdG8ge0BsaW5rIG5nLiRsb2cjZXJyb3IgJGxvZy53YXJuKCl9LgogICAqIGBgYGpzCiAgICogICAkcHJvdmlkZS5kZWNvcmF0b3IoJyRsb2cnLCBbJyRkZWxlZ2F0ZScsIGZ1bmN0aW9uKCRkZWxlZ2F0ZSkgewogKiAgICAgJGRlbGVnYXRlLndhcm4gPSAkZGVsZWdhdGUuZXJyb3I7CiAqICAgICByZXR1cm4gJGRlbGVnYXRlOwogKiAgIH1dKTsKICAgKiBgYGAKICAgKi8KCgogIGZ1bmN0aW9uIGNyZWF0ZUluamVjdG9yKG1vZHVsZXNUb0xvYWQpIHsKICAgIHZhciBJTlNUQU5USUFUSU5HID0ge30sCiAgICAgIHByb3ZpZGVyU3VmZml4ID0gJ1Byb3ZpZGVyJywKICAgICAgcGF0aCA9IFtdLAogICAgICBsb2FkZWRNb2R1bGVzID0gbmV3IEhhc2hNYXAoKSwKICAgICAgcHJvdmlkZXJDYWNoZSA9IHsKICAgICAgICAkcHJvdmlkZTogewogICAgICAgICAgcHJvdmlkZXI6IHN1cHBvcnRPYmplY3QocHJvdmlkZXIpLAogICAgICAgICAgZmFjdG9yeTogc3VwcG9ydE9iamVjdChmYWN0b3J5KSwKICAgICAgICAgIHNlcnZpY2U6IHN1cHBvcnRPYmplY3Qoc2VydmljZSksCiAgICAgICAgICB2YWx1ZTogc3VwcG9ydE9iamVjdCh2YWx1ZSksCiAgICAgICAgICBjb25zdGFudDogc3VwcG9ydE9iamVjdChjb25zdGFudCksCiAgICAgICAgICBkZWNvcmF0b3I6IGRlY29yYXRvcgogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJvdmlkZXJJbmplY3RvciA9IChwcm92aWRlckNhY2hlLiRpbmplY3RvciA9CiAgICAgICAgY3JlYXRlSW50ZXJuYWxJbmplY3Rvcihwcm92aWRlckNhY2hlLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycigndW5wcicsICJVbmtub3duIHByb3ZpZGVyOiB7MH0iLCBwYXRoLmpvaW4oJyA8LSAnKSk7CiAgICAgICAgfSkpLAogICAgICBpbnN0YW5jZUNhY2hlID0ge30sCiAgICAgIGluc3RhbmNlSW5qZWN0b3IgPSAoaW5zdGFuY2VDYWNoZS4kaW5qZWN0b3IgPQogICAgICAgIGNyZWF0ZUludGVybmFsSW5qZWN0b3IoaW5zdGFuY2VDYWNoZSwgZnVuY3Rpb24oc2VydmljZW5hbWUpIHsKICAgICAgICAgIHZhciBwcm92aWRlciA9IHByb3ZpZGVySW5qZWN0b3IuZ2V0KHNlcnZpY2VuYW1lICsgcHJvdmlkZXJTdWZmaXgpOwogICAgICAgICAgcmV0dXJuIGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKHByb3ZpZGVyLiRnZXQsIHByb3ZpZGVyKTsKICAgICAgICB9KSk7CgoKICAgIGZvckVhY2gobG9hZE1vZHVsZXMobW9kdWxlc1RvTG9hZCksIGZ1bmN0aW9uKGZuKSB7IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKGZuIHx8IG5vb3ApOyB9KTsKCiAgICByZXR1cm4gaW5zdGFuY2VJbmplY3RvcjsKCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vICRwcm92aWRlcgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgZnVuY3Rpb24gc3VwcG9ydE9iamVjdChkZWxlZ2F0ZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChpc09iamVjdChrZXkpKSB7CiAgICAgICAgICBmb3JFYWNoKGtleSwgcmV2ZXJzZVBhcmFtcyhkZWxlZ2F0ZSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gZGVsZWdhdGUoa2V5LCB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9OwogICAgfQoKICAgIGZ1bmN0aW9uIHByb3ZpZGVyKG5hbWUsIHByb3ZpZGVyXykgewogICAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCAnc2VydmljZScpOwogICAgICBpZiAoaXNGdW5jdGlvbihwcm92aWRlcl8pIHx8IGlzQXJyYXkocHJvdmlkZXJfKSkgewogICAgICAgIHByb3ZpZGVyXyA9IHByb3ZpZGVySW5qZWN0b3IuaW5zdGFudGlhdGUocHJvdmlkZXJfKTsKICAgICAgfQogICAgICBpZiAoIXByb3ZpZGVyXy4kZ2V0KSB7CiAgICAgICAgdGhyb3cgJGluamVjdG9yTWluRXJyKCdwZ2V0JywgIlByb3ZpZGVyICd7MH0nIG11c3QgZGVmaW5lICRnZXQgZmFjdG9yeSBtZXRob2QuIiwgbmFtZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHByb3ZpZGVyQ2FjaGVbbmFtZSArIHByb3ZpZGVyU3VmZml4XSA9IHByb3ZpZGVyXzsKICAgIH0KCiAgICBmdW5jdGlvbiBmYWN0b3J5KG5hbWUsIGZhY3RvcnlGbikgeyByZXR1cm4gcHJvdmlkZXIobmFtZSwgeyAkZ2V0OiBmYWN0b3J5Rm4gfSk7IH0KCiAgICBmdW5jdGlvbiBzZXJ2aWNlKG5hbWUsIGNvbnN0cnVjdG9yKSB7CiAgICAgIHJldHVybiBmYWN0b3J5KG5hbWUsIFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CiAgICAgICAgcmV0dXJuICRpbmplY3Rvci5pbnN0YW50aWF0ZShjb25zdHJ1Y3Rvcik7CiAgICAgIH1dKTsKICAgIH0KCiAgICBmdW5jdGlvbiB2YWx1ZShuYW1lLCB2YWwpIHsgcmV0dXJuIGZhY3RvcnkobmFtZSwgdmFsdWVGbih2YWwpKTsgfQoKICAgIGZ1bmN0aW9uIGNvbnN0YW50KG5hbWUsIHZhbHVlKSB7CiAgICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KG5hbWUsICdjb25zdGFudCcpOwogICAgICBwcm92aWRlckNhY2hlW25hbWVdID0gdmFsdWU7CiAgICAgIGluc3RhbmNlQ2FjaGVbbmFtZV0gPSB2YWx1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBkZWNvcmF0b3Ioc2VydmljZU5hbWUsIGRlY29yRm4pIHsKICAgICAgdmFyIG9yaWdQcm92aWRlciA9IHByb3ZpZGVySW5qZWN0b3IuZ2V0KHNlcnZpY2VOYW1lICsgcHJvdmlkZXJTdWZmaXgpLAogICAgICAgIG9yaWckZ2V0ID0gb3JpZ1Byb3ZpZGVyLiRnZXQ7CgogICAgICBvcmlnUHJvdmlkZXIuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBvcmlnSW5zdGFuY2UgPSBpbnN0YW5jZUluamVjdG9yLmludm9rZShvcmlnJGdldCwgb3JpZ1Byb3ZpZGVyKTsKICAgICAgICByZXR1cm4gaW5zdGFuY2VJbmplY3Rvci5pbnZva2UoZGVjb3JGbiwgbnVsbCwgeyRkZWxlZ2F0ZTogb3JpZ0luc3RhbmNlfSk7CiAgICAgIH07CiAgICB9CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBNb2R1bGUgTG9hZGluZwogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICBmdW5jdGlvbiBsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKXsKICAgICAgdmFyIHJ1bkJsb2NrcyA9IFtdLCBtb2R1bGVGbiwgaW52b2tlUXVldWUsIGksIGlpOwogICAgICBmb3JFYWNoKG1vZHVsZXNUb0xvYWQsIGZ1bmN0aW9uKG1vZHVsZSkgewogICAgICAgIGlmIChsb2FkZWRNb2R1bGVzLmdldChtb2R1bGUpKSByZXR1cm47CiAgICAgICAgbG9hZGVkTW9kdWxlcy5wdXQobW9kdWxlLCB0cnVlKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmIChpc1N0cmluZyhtb2R1bGUpKSB7CiAgICAgICAgICAgIG1vZHVsZUZuID0gYW5ndWxhck1vZHVsZShtb2R1bGUpOwogICAgICAgICAgICBydW5CbG9ja3MgPSBydW5CbG9ja3MuY29uY2F0KGxvYWRNb2R1bGVzKG1vZHVsZUZuLnJlcXVpcmVzKSkuY29uY2F0KG1vZHVsZUZuLl9ydW5CbG9ja3MpOwoKICAgICAgICAgICAgZm9yKGludm9rZVF1ZXVlID0gbW9kdWxlRm4uX2ludm9rZVF1ZXVlLCBpID0gMCwgaWkgPSBpbnZva2VRdWV1ZS5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGludm9rZUFyZ3MgPSBpbnZva2VRdWV1ZVtpXSwKICAgICAgICAgICAgICAgIHByb3ZpZGVyID0gcHJvdmlkZXJJbmplY3Rvci5nZXQoaW52b2tlQXJnc1swXSk7CgogICAgICAgICAgICAgIHByb3ZpZGVyW2ludm9rZUFyZ3NbMV1dLmFwcGx5KHByb3ZpZGVyLCBpbnZva2VBcmdzWzJdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKG1vZHVsZSkpIHsKICAgICAgICAgICAgcnVuQmxvY2tzLnB1c2gocHJvdmlkZXJJbmplY3Rvci5pbnZva2UobW9kdWxlKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkobW9kdWxlKSkgewogICAgICAgICAgICBydW5CbG9ja3MucHVzaChwcm92aWRlckluamVjdG9yLmludm9rZShtb2R1bGUpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGFzc2VydEFyZ0ZuKG1vZHVsZSwgJ21vZHVsZScpOwogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGlmIChpc0FycmF5KG1vZHVsZSkpIHsKICAgICAgICAgICAgbW9kdWxlID0gbW9kdWxlW21vZHVsZS5sZW5ndGggLSAxXTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChlLm1lc3NhZ2UgJiYgZS5zdGFjayAmJiBlLnN0YWNrLmluZGV4T2YoZS5tZXNzYWdlKSA9PSAtMSkgewogICAgICAgICAgICAvLyBTYWZhcmkgJiBGRidzIHN0YWNrIHRyYWNlcyBkb24ndCBjb250YWluIGVycm9yLm1lc3NhZ2UgY29udGVudAogICAgICAgICAgICAvLyB1bmxpa2UgdGhvc2Ugb2YgQ2hyb21lIGFuZCBJRQogICAgICAgICAgICAvLyBTbyBpZiBzdGFjayBkb2Vzbid0IGNvbnRhaW4gbWVzc2FnZSwgd2UgY3JlYXRlIGEgbmV3IHN0cmluZyB0aGF0IGNvbnRhaW5zIGJvdGguCiAgICAgICAgICAgIC8vIFNpbmNlIGVycm9yLnN0YWNrIGlzIHJlYWQtb25seSBpbiBTYWZhcmksIEknbSBvdmVycmlkaW5nIGUgYW5kIG5vdCBlLnN0YWNrIGhlcmUuCiAgICAgICAgICAgIC8qIGpzaGludCAtVzAyMiAqLwogICAgICAgICAgICBlID0gZS5tZXNzYWdlICsgJ1xuJyArIGUuc3RhY2s7CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ21vZHVsZXJyJywgIkZhaWxlZCB0byBpbnN0YW50aWF0ZSBtb2R1bGUgezB9IGR1ZSB0bzpcbnsxfSIsCiAgICAgICAgICAgIG1vZHVsZSwgZS5zdGFjayB8fCBlLm1lc3NhZ2UgfHwgZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHJ1bkJsb2NrczsKICAgIH0KCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vIGludGVybmFsIEluamVjdG9yCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICBmdW5jdGlvbiBjcmVhdGVJbnRlcm5hbEluamVjdG9yKGNhY2hlLCBmYWN0b3J5KSB7CgogICAgICBmdW5jdGlvbiBnZXRTZXJ2aWNlKHNlcnZpY2VOYW1lKSB7CiAgICAgICAgaWYgKGNhY2hlLmhhc093blByb3BlcnR5KHNlcnZpY2VOYW1lKSkgewogICAgICAgICAgaWYgKGNhY2hlW3NlcnZpY2VOYW1lXSA9PT0gSU5TVEFOVElBVElORykgewogICAgICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ2NkZXAnLCAnQ2lyY3VsYXIgZGVwZW5kZW5jeSBmb3VuZDogezB9JywgcGF0aC5qb2luKCcgPC0gJykpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNhY2hlW3NlcnZpY2VOYW1lXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcGF0aC51bnNoaWZ0KHNlcnZpY2VOYW1lKTsKICAgICAgICAgICAgY2FjaGVbc2VydmljZU5hbWVdID0gSU5TVEFOVElBVElORzsKICAgICAgICAgICAgcmV0dXJuIGNhY2hlW3NlcnZpY2VOYW1lXSA9IGZhY3Rvcnkoc2VydmljZU5hbWUpOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIGlmIChjYWNoZVtzZXJ2aWNlTmFtZV0gPT09IElOU1RBTlRJQVRJTkcpIHsKICAgICAgICAgICAgICBkZWxldGUgY2FjaGVbc2VydmljZU5hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHBhdGguc2hpZnQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGludm9rZShmbiwgc2VsZiwgbG9jYWxzKXsKICAgICAgICB2YXIgYXJncyA9IFtdLAogICAgICAgICAgJGluamVjdCA9IGFubm90YXRlKGZuKSwKICAgICAgICAgIGxlbmd0aCwgaSwKICAgICAgICAgIGtleTsKCiAgICAgICAgZm9yKGkgPSAwLCBsZW5ndGggPSAkaW5qZWN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBrZXkgPSAkaW5qZWN0W2ldOwogICAgICAgICAgaWYgKHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignaXRrbicsCiAgICAgICAgICAgICAgJ0luY29ycmVjdCBpbmplY3Rpb24gdG9rZW4hIEV4cGVjdGVkIHNlcnZpY2UgbmFtZSBhcyBzdHJpbmcsIGdvdCB7MH0nLCBrZXkpOwogICAgICAgICAgfQogICAgICAgICAgYXJncy5wdXNoKAogICAgICAgICAgICAgIGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5KQogICAgICAgICAgICAgID8gbG9jYWxzW2tleV0KICAgICAgICAgICAgICA6IGdldFNlcnZpY2Uoa2V5KQogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFmbi4kaW5qZWN0KSB7CiAgICAgICAgICAvLyB0aGlzIG1lYW5zIHRoYXQgd2UgbXVzdCBiZSBhbiBhcnJheS4KICAgICAgICAgIGZuID0gZm5bbGVuZ3RoXTsKICAgICAgICB9CgogICAgICAgIC8vIGh0dHA6Ly9qc3BlcmYuY29tL2FuZ3VsYXJqcy1pbnZva2UtYXBwbHktdnMtc3dpdGNoCiAgICAgICAgLy8gIzUzODgKICAgICAgICByZXR1cm4gZm4uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGluc3RhbnRpYXRlKFR5cGUsIGxvY2FscykgewogICAgICAgIHZhciBDb25zdHJ1Y3RvciA9IGZ1bmN0aW9uKCkge30sCiAgICAgICAgICBpbnN0YW5jZSwgcmV0dXJuZWRWYWx1ZTsKCiAgICAgICAgLy8gQ2hlY2sgaWYgVHlwZSBpcyBhbm5vdGF0ZWQgYW5kIHVzZSBqdXN0IHRoZSBnaXZlbiBmdW5jdGlvbiBhdCBuLTEgYXMgcGFyYW1ldGVyCiAgICAgICAgLy8gZS5nLiBzb21lTW9kdWxlLmZhY3RvcnkoJ2dyZWV0ZXInLCBbJyR3aW5kb3cnLCBmdW5jdGlvbihyZW5hbWVkJHdpbmRvdykge31dKTsKICAgICAgICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAoaXNBcnJheShUeXBlKSA/IFR5cGVbVHlwZS5sZW5ndGggLSAxXSA6IFR5cGUpLnByb3RvdHlwZTsKICAgICAgICBpbnN0YW5jZSA9IG5ldyBDb25zdHJ1Y3RvcigpOwogICAgICAgIHJldHVybmVkVmFsdWUgPSBpbnZva2UoVHlwZSwgaW5zdGFuY2UsIGxvY2Fscyk7CgogICAgICAgIHJldHVybiBpc09iamVjdChyZXR1cm5lZFZhbHVlKSB8fCBpc0Z1bmN0aW9uKHJldHVybmVkVmFsdWUpID8gcmV0dXJuZWRWYWx1ZSA6IGluc3RhbmNlOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIGludm9rZTogaW52b2tlLAogICAgICAgIGluc3RhbnRpYXRlOiBpbnN0YW50aWF0ZSwKICAgICAgICBnZXQ6IGdldFNlcnZpY2UsCiAgICAgICAgYW5ub3RhdGU6IGFubm90YXRlLAogICAgICAgIGhhczogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcmV0dXJuIHByb3ZpZGVyQ2FjaGUuaGFzT3duUHJvcGVydHkobmFtZSArIHByb3ZpZGVyU3VmZml4KSB8fCBjYWNoZS5oYXNPd25Qcm9wZXJ0eShuYW1lKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfQoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRhbmNob3JTY3JvbGwKICAgKiBAa2luZCBmdW5jdGlvbgogICAqIEByZXF1aXJlcyAkd2luZG93CiAgICogQHJlcXVpcmVzICRsb2NhdGlvbgogICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBXaGVuIGNhbGxlZCwgaXQgY2hlY2tzIGN1cnJlbnQgdmFsdWUgb2YgYCRsb2NhdGlvbi5oYXNoKClgIGFuZCBzY3JvbGxzIHRvIHRoZSByZWxhdGVkIGVsZW1lbnQsCiAgICogYWNjb3JkaW5nIHRvIHJ1bGVzIHNwZWNpZmllZCBpbgogICAqIFtIdG1sNSBzcGVjXShodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjdGhlLWluZGljYXRlZC1wYXJ0LW9mLXRoZS1kb2N1bWVudCkuCiAgICoKICAgKiBJdCBhbHNvIHdhdGNoZXMgdGhlIGAkbG9jYXRpb24uaGFzaCgpYCBhbmQgc2Nyb2xscyB3aGVuZXZlciBpdCBjaGFuZ2VzIHRvIG1hdGNoIGFueSBhbmNob3IuCiAgICogVGhpcyBjYW4gYmUgZGlzYWJsZWQgYnkgY2FsbGluZyBgJGFuY2hvclNjcm9sbFByb3ZpZGVyLmRpc2FibGVBdXRvU2Nyb2xsaW5nKClgLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8ZGl2IGlkPSJzY3JvbGxBcmVhIiBuZy1jb250cm9sbGVyPSJTY3JvbGxDdHJsIj4KICAgPGEgbmctY2xpY2s9ImdvdG9Cb3R0b20oKSI+R28gdG8gYm90dG9tPC9hPgogICA8YSBpZD0iYm90dG9tIj48L2E+IFlvdSdyZSBhdCB0aGUgYm90dG9tIQogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICBmdW5jdGlvbiBTY3JvbGxDdHJsKCRzY29wZSwgJGxvY2F0aW9uLCAkYW5jaG9yU2Nyb2xsKSB7CiAgICAgICAgICRzY29wZS5nb3RvQm90dG9tID0gZnVuY3Rpb24gKCl7CiAgICAgICAgICAgLy8gc2V0IHRoZSBsb2NhdGlvbi5oYXNoIHRvIHRoZSBpZCBvZgogICAgICAgICAgIC8vIHRoZSBlbGVtZW50IHlvdSB3aXNoIHRvIHNjcm9sbCB0by4KICAgICAgICAgICAkbG9jYXRpb24uaGFzaCgnYm90dG9tJyk7CgogICAgICAgICAgIC8vIGNhbGwgJGFuY2hvclNjcm9sbCgpCiAgICAgICAgICAgJGFuY2hvclNjcm9sbCgpOwogICAgICAgICB9OwogICAgICAgfQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgICNzY3JvbGxBcmVhIHsKICAgICAgICAgaGVpZ2h0OiAzNTBweDsKICAgICAgICAgb3ZlcmZsb3c6IGF1dG87CiAgICAgICB9CgogICAjYm90dG9tIHsKICAgICAgICAgZGlzcGxheTogYmxvY2s7CiAgICAgICAgIG1hcmdpbi10b3A6IDIwMDBweDsKICAgICAgIH0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgZnVuY3Rpb24gJEFuY2hvclNjcm9sbFByb3ZpZGVyKCkgewoKICAgIHZhciBhdXRvU2Nyb2xsaW5nRW5hYmxlZCA9IHRydWU7CgogICAgdGhpcy5kaXNhYmxlQXV0b1Njcm9sbGluZyA9IGZ1bmN0aW9uKCkgewogICAgICBhdXRvU2Nyb2xsaW5nRW5hYmxlZCA9IGZhbHNlOwogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGxvY2F0aW9uJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbigkd2luZG93LCAkbG9jYXRpb24sICRyb290U2NvcGUpIHsKICAgICAgdmFyIGRvY3VtZW50ID0gJHdpbmRvdy5kb2N1bWVudDsKCiAgICAgIC8vIGhlbHBlciBmdW5jdGlvbiB0byBnZXQgZmlyc3QgYW5jaG9yIGZyb20gYSBOb2RlTGlzdAogICAgICAvLyBjYW4ndCB1c2UgZmlsdGVyLmZpbHRlciwgYXMgaXQgYWNjZXB0cyBvbmx5IGluc3RhbmNlcyBvZiBBcnJheQogICAgICAvLyBhbmQgSUUgY2FuJ3QgY29udmVydCBOb2RlTGlzdCB0byBhbiBhcnJheSB1c2luZyBbXS5zbGljZQogICAgICAvLyBUT0RPKHZvanRhKTogdXNlIGZpbHRlciBpZiB3ZSBjaGFuZ2UgaXQgdG8gYWNjZXB0IGxpc3RzIGFzIHdlbGwKICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RBbmNob3IobGlzdCkgewogICAgICAgIHZhciByZXN1bHQgPSBudWxsOwogICAgICAgIGZvckVhY2gobGlzdCwgZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgaWYgKCFyZXN1bHQgJiYgbG93ZXJjYXNlKGVsZW1lbnQubm9kZU5hbWUpID09PSAnYScpIHJlc3VsdCA9IGVsZW1lbnQ7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gc2Nyb2xsKCkgewogICAgICAgIHZhciBoYXNoID0gJGxvY2F0aW9uLmhhc2goKSwgZWxtOwoKICAgICAgICAvLyBlbXB0eSBoYXNoLCBzY3JvbGwgdG8gdGhlIHRvcCBvZiB0aGUgcGFnZQogICAgICAgIGlmICghaGFzaCkgJHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKCiAgICAgICAgLy8gZWxlbWVudCB3aXRoIGdpdmVuIGlkCiAgICAgICAgZWxzZSBpZiAoKGVsbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGhhc2gpKSkgZWxtLnNjcm9sbEludG9WaWV3KCk7CgogICAgICAgIC8vIGZpcnN0IGFuY2hvciB3aXRoIGdpdmVuIG5hbWUgOi1ECiAgICAgICAgZWxzZSBpZiAoKGVsbSA9IGdldEZpcnN0QW5jaG9yKGRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lKGhhc2gpKSkpIGVsbS5zY3JvbGxJbnRvVmlldygpOwoKICAgICAgICAvLyBubyBlbGVtZW50IGFuZCBoYXNoID09ICd0b3AnLCBzY3JvbGwgdG8gdGhlIHRvcCBvZiB0aGUgcGFnZQogICAgICAgIGVsc2UgaWYgKGhhc2ggPT09ICd0b3AnKSAkd2luZG93LnNjcm9sbFRvKDAsIDApOwogICAgICB9CgogICAgICAvLyBkb2VzIG5vdCBzY3JvbGwgd2hlbiB1c2VyIGNsaWNrcyBvbiBhbmNob3IgbGluayB0aGF0IGlzIGN1cnJlbnRseSBvbgogICAgICAvLyAobm8gdXJsIGNoYW5nZSwgbm8gJGxvY2F0aW9uLmhhc2goKSBjaGFuZ2UpLCBicm93c2VyIG5hdGl2ZSBkb2VzIHNjcm9sbAogICAgICBpZiAoYXV0b1Njcm9sbGluZ0VuYWJsZWQpIHsKICAgICAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiBhdXRvU2Nyb2xsV2F0Y2goKSB7cmV0dXJuICRsb2NhdGlvbi5oYXNoKCk7fSwKICAgICAgICAgIGZ1bmN0aW9uIGF1dG9TY3JvbGxXYXRjaEFjdGlvbigpIHsKICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKHNjcm9sbCk7CiAgICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcmV0dXJuIHNjcm9sbDsKICAgIH1dOwogIH0KCiAgdmFyICRhbmltYXRlTWluRXJyID0gbWluRXJyKCckYW5pbWF0ZScpOwoKICAvKioKICAgKiBAbmdkb2MgcHJvdmlkZXIKICAgKiBAbmFtZSAkYW5pbWF0ZVByb3ZpZGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mICRhbmltYXRlIHRoYXQgZG9lc24ndCBwZXJmb3JtIGFueSBhbmltYXRpb25zLCBpbnN0ZWFkIGp1c3QKICAgKiBzeW5jaHJvbm91c2x5IHBlcmZvcm1zIERPTQogICAqIHVwZGF0ZXMgYW5kIGNhbGxzIGRvbmUoKSBjYWxsYmFja3MuCiAgICoKICAgKiBJbiBvcmRlciB0byBlbmFibGUgYW5pbWF0aW9ucyB0aGUgbmdBbmltYXRlIG1vZHVsZSBoYXMgdG8gYmUgbG9hZGVkLgogICAqCiAgICogVG8gc2VlIHRoZSBmdW5jdGlvbmFsIGltcGxlbWVudGF0aW9uIGNoZWNrIG91dCBzcmMvbmdBbmltYXRlL2FuaW1hdGUuanMKICAgKi8KICB2YXIgJEFuaW1hdGVQcm92aWRlciA9IFsnJHByb3ZpZGUnLCBmdW5jdGlvbigkcHJvdmlkZSkgewoKCiAgICB0aGlzLiQkc2VsZWN0b3JzID0ge307CgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGFuaW1hdGVQcm92aWRlciNyZWdpc3RlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXJzIGEgbmV3IGluamVjdGFibGUgYW5pbWF0aW9uIGZhY3RvcnkgZnVuY3Rpb24uIFRoZSBmYWN0b3J5IGZ1bmN0aW9uIHByb2R1Y2VzIHRoZQogICAgICogYW5pbWF0aW9uIG9iamVjdCB3aGljaCBjb250YWlucyBjYWxsYmFjayBmdW5jdGlvbnMgZm9yIGVhY2ggZXZlbnQgdGhhdCBpcyBleHBlY3RlZCB0byBiZQogICAgICogYW5pbWF0ZWQuCiAgICAgKgogICAgICogICAqIGBldmVudEZuYDogYGZ1bmN0aW9uKEVsZW1lbnQsIGRvbmVGdW5jdGlvbilgIFRoZSBlbGVtZW50IHRvIGFuaW1hdGUsIHRoZSBgZG9uZUZ1bmN0aW9uYAogICAgICogICBtdXN0IGJlIGNhbGxlZCBvbmNlIHRoZSBlbGVtZW50IGFuaW1hdGlvbiBpcyBjb21wbGV0ZS4gSWYgYSBmdW5jdGlvbiBpcyByZXR1cm5lZCB0aGVuIHRoZQogICAgICogICBhbmltYXRpb24gc2VydmljZSB3aWxsIHVzZSB0aGlzIGZ1bmN0aW9uIHRvIGNhbmNlbCB0aGUgYW5pbWF0aW9uIHdoZW5ldmVyIGEgY2FuY2VsIGV2ZW50IGlzCiAgICAgKiAgIHRyaWdnZXJlZC4KICAgICAqCiAgICAgKgogICAgICogYGBganMKICAgICAqICAgcmV0dXJuIHsKICAgICAqICAgICBldmVudEZuIDogZnVuY3Rpb24oZWxlbWVudCwgZG9uZSkgewogICAgICogICAgICAgLy9jb2RlIHRvIHJ1biB0aGUgYW5pbWF0aW9uCiAgICAgKiAgICAgICAvL29uY2UgY29tcGxldGUsIHRoZW4gcnVuIGRvbmUoKQogICAgICogICAgICAgcmV0dXJuIGZ1bmN0aW9uIGNhbmNlbGxhdGlvbkZ1bmN0aW9uKCkgewogICAgICogICAgICAgICAvL2NvZGUgdG8gY2FuY2VsIHRoZSBhbmltYXRpb24KICAgICAqICAgICAgIH0KICAgICAqICAgICB9CiAgICAgKiAgIH0KICAgICAqIGBgYAogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBhbmltYXRpb24uCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmYWN0b3J5IFRoZSBmYWN0b3J5IGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCB0byByZXR1cm4gdGhlIGFuaW1hdGlvbgogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QuCiAgICAgKi8KICAgIHRoaXMucmVnaXN0ZXIgPSBmdW5jdGlvbihuYW1lLCBmYWN0b3J5KSB7CiAgICAgIHZhciBrZXkgPSBuYW1lICsgJy1hbmltYXRpb24nOwogICAgICBpZiAobmFtZSAmJiBuYW1lLmNoYXJBdCgwKSAhPSAnLicpIHRocm93ICRhbmltYXRlTWluRXJyKCdub3Rjc2VsJywKICAgICAgICAiRXhwZWN0aW5nIGNsYXNzIHNlbGVjdG9yIHN0YXJ0aW5nIHdpdGggJy4nIGdvdCAnezB9Jy4iLCBuYW1lKTsKICAgICAgdGhpcy4kJHNlbGVjdG9yc1tuYW1lLnN1YnN0cigxKV0gPSBrZXk7CiAgICAgICRwcm92aWRlLmZhY3Rvcnkoa2V5LCBmYWN0b3J5KTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkYW5pbWF0ZVByb3ZpZGVyI2NsYXNzTmFtZUZpbHRlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2V0cyBhbmQvb3IgcmV0dXJucyB0aGUgQ1NTIGNsYXNzIHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIGNoZWNrZWQgd2hlbiBwZXJmb3JtaW5nCiAgICAgKiBhbiBhbmltYXRpb24uIFVwb24gYm9vdHN0cmFwIHRoZSBjbGFzc05hbWVGaWx0ZXIgdmFsdWUgaXMgbm90IHNldCBhdCBhbGwgYW5kIHdpbGwKICAgICAqIHRoZXJlZm9yZSBlbmFibGUgJGFuaW1hdGUgdG8gYXR0ZW1wdCB0byBwZXJmb3JtIGFuIGFuaW1hdGlvbiBvbiBhbnkgZWxlbWVudC4KICAgICAqIFdoZW4gc2V0dGluZyB0aGUgY2xhc3NOYW1lRmlsdGVyIHZhbHVlLCBhbmltYXRpb25zIHdpbGwgb25seSBiZSBwZXJmb3JtZWQgb24gZWxlbWVudHMKICAgICAqIHRoYXQgc3VjY2Vzc2Z1bGx5IG1hdGNoIHRoZSBmaWx0ZXIgZXhwcmVzc2lvbi4gVGhpcyBpbiB0dXJuIGNhbiBib29zdCBwZXJmb3JtYW5jZQogICAgICogZm9yIGxvdy1wb3dlcmVkIGRldmljZXMgYXMgd2VsbCBhcyBhcHBsaWNhdGlvbnMgY29udGFpbmluZyBhIGxvdCBvZiBzdHJ1Y3R1cmFsIG9wZXJhdGlvbnMuCiAgICAgKiBAcGFyYW0ge1JlZ0V4cD19IGV4cHJlc3Npb24gVGhlIGNsYXNzTmFtZSBleHByZXNzaW9uIHdoaWNoIHdpbGwgYmUgY2hlY2tlZCBhZ2FpbnN0IGFsbCBhbmltYXRpb25zCiAgICAgKiBAcmV0dXJuIHtSZWdFeHB9IFRoZSBjdXJyZW50IENTUyBjbGFzc05hbWUgZXhwcmVzc2lvbiB2YWx1ZS4gSWYgbnVsbCB0aGVuIHRoZXJlIGlzIG5vIGV4cHJlc3Npb24gdmFsdWUKICAgICAqLwogICAgdGhpcy5jbGFzc05hbWVGaWx0ZXIgPSBmdW5jdGlvbihleHByZXNzaW9uKSB7CiAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLiQkY2xhc3NOYW1lRmlsdGVyID0gKGV4cHJlc3Npb24gaW5zdGFuY2VvZiBSZWdFeHApID8gZXhwcmVzc2lvbiA6IG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuJCRjbGFzc05hbWVGaWx0ZXI7CiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsnJHRpbWVvdXQnLCAnJCRhc3luY0NhbGxiYWNrJywgZnVuY3Rpb24oJHRpbWVvdXQsICQkYXN5bmNDYWxsYmFjaykgewoKICAgICAgZnVuY3Rpb24gYXN5bmMoZm4pIHsKICAgICAgICBmbiAmJiAkJGFzeW5jQ2FsbGJhY2soZm4pOwogICAgICB9CgogICAgICAvKioKICAgICAgICoKICAgICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAgICogQG5hbWUgJGFuaW1hdGUKICAgICAgICogQGRlc2NyaXB0aW9uIFRoZSAkYW5pbWF0ZSBzZXJ2aWNlIHByb3ZpZGVzIHJ1ZGltZW50YXJ5IERPTSBtYW5pcHVsYXRpb24gZnVuY3Rpb25zIHRvCiAgICAgICAqIGluc2VydCwgcmVtb3ZlIGFuZCBtb3ZlIGVsZW1lbnRzIHdpdGhpbiB0aGUgRE9NLCBhcyB3ZWxsIGFzIGFkZGluZyBhbmQgcmVtb3ZpbmcgY2xhc3Nlcy4KICAgICAgICogVGhpcyBzZXJ2aWNlIGlzIHRoZSBjb3JlIHNlcnZpY2UgdXNlZCBieSB0aGUgbmdBbmltYXRlICRhbmltYXRvciBzZXJ2aWNlIHdoaWNoIHByb3ZpZGVzCiAgICAgICAqIGhpZ2gtbGV2ZWwgYW5pbWF0aW9uIGhvb2tzIGZvciBDU1MgYW5kIEphdmFTY3JpcHQuCiAgICAgICAqCiAgICAgICAqICRhbmltYXRlIGlzIGF2YWlsYWJsZSBpbiB0aGUgQW5ndWxhckpTIGNvcmUsIGhvd2V2ZXIsIHRoZSBuZ0FuaW1hdGUgbW9kdWxlIG11c3QgYmUgaW5jbHVkZWQKICAgICAgICogdG8gZW5hYmxlIGZ1bGwgb3V0IGFuaW1hdGlvbiBzdXBwb3J0LiBPdGhlcndpc2UsICRhbmltYXRlIHdpbGwgb25seSBwZXJmb3JtIHNpbXBsZSBET00KICAgICAgICogbWFuaXB1bGF0aW9uIG9wZXJhdGlvbnMuCiAgICAgICAqCiAgICAgICAqIFRvIGxlYXJuIG1vcmUgYWJvdXQgZW5hYmxpbmcgYW5pbWF0aW9uIHN1cHBvcnQsIGNsaWNrIGhlcmUgdG8gdmlzaXQgdGhlIHtAbGluayBuZ0FuaW1hdGUKICAgICAqIG5nQW5pbWF0ZSBtb2R1bGUgcGFnZX0gYXMgd2VsbCBhcyB0aGUge0BsaW5rIG5nQW5pbWF0ZS4kYW5pbWF0ZSBuZ0FuaW1hdGUgJGFuaW1hdGUgc2VydmljZQogICAgICogcGFnZX0uCiAgICAgICAqLwogICAgICByZXR1cm4gewoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNlbnRlcgogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICogQGRlc2NyaXB0aW9uIEluc2VydHMgdGhlIGVsZW1lbnQgaW50byB0aGUgRE9NIGVpdGhlciBhZnRlciB0aGUgYGFmdGVyYCBlbGVtZW50IG9yIHdpdGhpbgogICAgICAgICAqICAgdGhlIGBwYXJlbnRgIGVsZW1lbnQuIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGJlIGluc2VydGVkIGludG8gdGhlIERPTQogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gcGFyZW50IHRoZSBwYXJlbnQgZWxlbWVudCB3aGljaCB3aWxsIGFwcGVuZCB0aGUgZWxlbWVudCBhcwogICAgICAgICAqICAgYSBjaGlsZCAoaWYgdGhlIGFmdGVyIGVsZW1lbnQgaXMgbm90IHByZXNlbnQpCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBhZnRlciB0aGUgc2libGluZyBlbGVtZW50IHdoaWNoIHdpbGwgYXBwZW5kIHRoZSBlbGVtZW50CiAgICAgICAgICogICBhZnRlciBpdHNlbGYKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZG9uZSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIGFmdGVyIHRoZSBlbGVtZW50IGhhcyBiZWVuCiAgICAgICAgICogICBpbnNlcnRlZCBpbnRvIHRoZSBET00KICAgICAgICAgKi8KICAgICAgICBlbnRlciA6IGZ1bmN0aW9uKGVsZW1lbnQsIHBhcmVudCwgYWZ0ZXIsIGRvbmUpIHsKICAgICAgICAgIGlmIChhZnRlcikgewogICAgICAgICAgICBhZnRlci5hZnRlcihlbGVtZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICghcGFyZW50IHx8ICFwYXJlbnRbMF0pIHsKICAgICAgICAgICAgICBwYXJlbnQgPSBhZnRlci5wYXJlbnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJlbnQuYXBwZW5kKGVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgYXN5bmMoZG9uZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICoKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjbGVhdmUKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqIEBkZXNjcmlwdGlvbiBSZW1vdmVzIHRoZSBlbGVtZW50IGZyb20gdGhlIERPTS4gT25jZSBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlCiAgICAgICAgICogICBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgRE9NCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbj19IGRvbmUgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCBhZnRlciB0aGUgZWxlbWVudCBoYXMgYmVlbgogICAgICAgICAqICAgcmVtb3ZlZCBmcm9tIHRoZSBET00KICAgICAgICAgKi8KICAgICAgICBsZWF2ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsKICAgICAgICAgIGVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICBhc3luYyhkb25lKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNtb3ZlCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKiBAZGVzY3JpcHRpb24gTW92ZXMgdGhlIHBvc2l0aW9uIG9mIHRoZSBwcm92aWRlZCBlbGVtZW50IHdpdGhpbiB0aGUgRE9NIHRvIGJlIHBsYWNlZAogICAgICAgICAqIGVpdGhlciBhZnRlciB0aGUgYGFmdGVyYCBlbGVtZW50IG9yIGluc2lkZSBvZiB0aGUgYHBhcmVudGAgZWxlbWVudC4gT25jZSBjb21wbGV0ZSwgdGhlCiAgICAgICAgICogZG9uZSgpIGNhbGxiYWNrIHdpbGwgYmUgZmlyZWQgKGlmIHByb3ZpZGVkKS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGJlIG1vdmVkIGFyb3VuZCB3aXRoaW4gdGhlCiAgICAgICAgICogICBET00KICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IHBhcmVudCB0aGUgcGFyZW50IGVsZW1lbnQgd2hlcmUgdGhlIGVsZW1lbnQgd2lsbCBiZQogICAgICAgICAqICAgaW5zZXJ0ZWQgaW50byAoaWYgdGhlIGFmdGVyIGVsZW1lbnQgaXMgbm90IHByZXNlbnQpCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBhZnRlciB0aGUgc2libGluZyBlbGVtZW50IHdoZXJlIHRoZSBlbGVtZW50IHdpbGwgYmUKICAgICAgICAgKiAgIHBvc2l0aW9uZWQgbmV4dCB0bwogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb249fSBkb25lIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAoaWYgcHJvdmlkZWQpIHRoYXQgd2lsbCBiZSBmaXJlZCBhZnRlciB0aGUKICAgICAgICAgKiAgIGVsZW1lbnQgaGFzIGJlZW4gbW92ZWQgdG8gaXRzIG5ldyBwb3NpdGlvbgogICAgICAgICAqLwogICAgICAgIG1vdmUgOiBmdW5jdGlvbihlbGVtZW50LCBwYXJlbnQsIGFmdGVyLCBkb25lKSB7CiAgICAgICAgICAvLyBEbyBub3QgcmVtb3ZlIGVsZW1lbnQgYmVmb3JlIGluc2VydC4gUmVtb3Zpbmcgd2lsbCBjYXVzZSBkYXRhIGFzc29jaWF0ZWQgd2l0aCB0aGUKICAgICAgICAgIC8vIGVsZW1lbnQgdG8gYmUgZHJvcHBlZC4gSW5zZXJ0IHdpbGwgaW1wbGljaXRseSBkbyB0aGUgcmVtb3ZlLgogICAgICAgICAgdGhpcy5lbnRlcihlbGVtZW50LCBwYXJlbnQsIGFmdGVyLCBkb25lKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNhZGRDbGFzcwogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICogQGRlc2NyaXB0aW9uIEFkZHMgdGhlIHByb3ZpZGVkIGNsYXNzTmFtZSBDU1MgY2xhc3MgdmFsdWUgdG8gdGhlIHByb3ZpZGVkIGVsZW1lbnQuIE9uY2UKICAgICAgICAgKiBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgaGF2ZSB0aGUgY2xhc3NOYW1lIHZhbHVlCiAgICAgICAgICogICBhZGRlZCB0byBpdAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc05hbWUgdGhlIENTUyBjbGFzcyB3aGljaCB3aWxsIGJlIGFkZGVkIHRvIHRoZSBlbGVtZW50CiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbj19IGRvbmUgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBwcm92aWRlZCkgdGhhdCB3aWxsIGJlIGZpcmVkIGFmdGVyIHRoZQogICAgICAgICAqICAgY2xhc3NOYW1lIHZhbHVlIGhhcyBiZWVuIGFkZGVkIHRvIHRoZSBlbGVtZW50CiAgICAgICAgICovCiAgICAgICAgYWRkQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGRvbmUpIHsKICAgICAgICAgIGNsYXNzTmFtZSA9IGlzU3RyaW5nKGNsYXNzTmFtZSkgPwogICAgICAgICAgICBjbGFzc05hbWUgOgogICAgICAgICAgICBpc0FycmF5KGNsYXNzTmFtZSkgPyBjbGFzc05hbWUuam9pbignICcpIDogJyc7CiAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIGpxTGl0ZUFkZENsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGFzeW5jKGRvbmUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI3JlbW92ZUNsYXNzCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKiBAZGVzY3JpcHRpb24gUmVtb3ZlcyB0aGUgcHJvdmlkZWQgY2xhc3NOYW1lIENTUyBjbGFzcyB2YWx1ZSBmcm9tIHRoZSBwcm92aWRlZCBlbGVtZW50LgogICAgICAgICAqIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGhhdmUgdGhlIGNsYXNzTmFtZSB2YWx1ZQogICAgICAgICAqICAgcmVtb3ZlZCBmcm9tIGl0CiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzTmFtZSB0aGUgQ1NTIGNsYXNzIHdoaWNoIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50CiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbj19IGRvbmUgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBwcm92aWRlZCkgdGhhdCB3aWxsIGJlIGZpcmVkIGFmdGVyIHRoZQogICAgICAgICAqICAgY2xhc3NOYW1lIHZhbHVlIGhhcyBiZWVuIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgICAqLwogICAgICAgIHJlbW92ZUNsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7CiAgICAgICAgICBjbGFzc05hbWUgPSBpc1N0cmluZyhjbGFzc05hbWUpID8KICAgICAgICAgICAgY2xhc3NOYW1lIDoKICAgICAgICAgICAgaXNBcnJheShjbGFzc05hbWUpID8gY2xhc3NOYW1lLmpvaW4oJyAnKSA6ICcnOwogICAgICAgICAgZm9yRWFjaChlbGVtZW50LCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICBqcUxpdGVSZW1vdmVDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgfSk7CiAgICAgICAgICBhc3luYyhkb25lKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNzZXRDbGFzcwogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICogQGRlc2NyaXB0aW9uIEFkZHMgYW5kL29yIHJlbW92ZXMgdGhlIGdpdmVuIENTUyBjbGFzc2VzIHRvIGFuZCBmcm9tIHRoZSBlbGVtZW50LgogICAgICAgICAqIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB3aGljaCB3aWxsIGhhdmUgaXRzIENTUyBjbGFzc2VzIGNoYW5nZWQKICAgICAgICAgKiAgIHJlbW92ZWQgZnJvbSBpdAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBhZGQgdGhlIENTUyBjbGFzc2VzIHdoaWNoIHdpbGwgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVtb3ZlIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZG9uZSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gKGlmIHByb3ZpZGVkKSB0aGF0IHdpbGwgYmUgZmlyZWQgYWZ0ZXIgdGhlCiAgICAgICAgICogICBDU1MgY2xhc3NlcyBoYXZlIGJlZW4gc2V0IG9uIHRoZSBlbGVtZW50CiAgICAgICAgICovCiAgICAgICAgc2V0Q2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBhZGQsIHJlbW92ZSwgZG9uZSkgewogICAgICAgICAgZm9yRWFjaChlbGVtZW50LCBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgICAgICBqcUxpdGVBZGRDbGFzcyhlbGVtZW50LCBhZGQpOwogICAgICAgICAgICBqcUxpdGVSZW1vdmVDbGFzcyhlbGVtZW50LCByZW1vdmUpOwogICAgICAgICAgfSk7CiAgICAgICAgICBhc3luYyhkb25lKTsKICAgICAgICB9LAoKICAgICAgICBlbmFibGVkIDogbm9vcAogICAgICB9OwogICAgfV07CiAgfV07CgogIGZ1bmN0aW9uICQkQXN5bmNDYWxsYmFja1Byb3ZpZGVyKCl7CiAgICB0aGlzLiRnZXQgPSBbJyQkckFGJywgJyR0aW1lb3V0JywgZnVuY3Rpb24oJCRyQUYsICR0aW1lb3V0KSB7CiAgICAgIHJldHVybiAkJHJBRi5zdXBwb3J0ZWQKICAgICAgICA/IGZ1bmN0aW9uKGZuKSB7IHJldHVybiAkJHJBRihmbik7IH0KICAgICAgICA6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgcmV0dXJuICR0aW1lb3V0KGZuLCAwLCBmYWxzZSk7CiAgICAgIH07CiAgICB9XTsKICB9CgogIC8qKgogICAqICEgVGhpcyBpcyBhIHByaXZhdGUgdW5kb2N1bWVudGVkIHNlcnZpY2UgIQogICAqCiAgICogQG5hbWUgJGJyb3dzZXIKICAgKiBAcmVxdWlyZXMgJGxvZwogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgb2JqZWN0IGhhcyB0d28gZ29hbHM6CiAgICoKICAgKiAtIGhpZGUgYWxsIHRoZSBnbG9iYWwgc3RhdGUgaW4gdGhlIGJyb3dzZXIgY2F1c2VkIGJ5IHRoZSB3aW5kb3cgb2JqZWN0CiAgICogLSBhYnN0cmFjdCBhd2F5IGFsbCB0aGUgYnJvd3NlciBzcGVjaWZpYyBmZWF0dXJlcyBhbmQgaW5jb25zaXN0ZW5jaWVzCiAgICoKICAgKiBGb3IgdGVzdHMgd2UgcHJvdmlkZSB7QGxpbmsgbmdNb2NrLiRicm93c2VyIG1vY2sgaW1wbGVtZW50YXRpb259IG9mIHRoZSBgJGJyb3dzZXJgCiAgICogc2VydmljZSwgd2hpY2ggY2FuIGJlIHVzZWQgZm9yIGNvbnZlbmllbnQgdGVzdGluZyBvZiB0aGUgYXBwbGljYXRpb24gd2l0aG91dCB0aGUgaW50ZXJhY3Rpb24gd2l0aAogICAqIHRoZSByZWFsIGJyb3dzZXIgYXBpcy4KICAgKi8KICAvKioKICAgKiBAcGFyYW0ge29iamVjdH0gd2luZG93IFRoZSBnbG9iYWwgd2luZG93IG9iamVjdC4KICAgKiBAcGFyYW0ge29iamVjdH0gZG9jdW1lbnQgalF1ZXJ5IHdyYXBwZWQgZG9jdW1lbnQuCiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBYSFIgWE1MSHR0cFJlcXVlc3QgY29uc3RydWN0b3IuCiAgICogQHBhcmFtIHtvYmplY3R9ICRsb2cgY29uc29sZS5sb2cgb3IgYW4gb2JqZWN0IHdpdGggdGhlIHNhbWUgaW50ZXJmYWNlLgogICAqIEBwYXJhbSB7b2JqZWN0fSAkc25pZmZlciAkc25pZmZlciBzZXJ2aWNlCiAgICovCiAgZnVuY3Rpb24gQnJvd3Nlcih3aW5kb3csIGRvY3VtZW50LCAkbG9nLCAkc25pZmZlcikgewogICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICByYXdEb2N1bWVudCA9IGRvY3VtZW50WzBdLAogICAgICBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbiwKICAgICAgaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5LAogICAgICBzZXRUaW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQsCiAgICAgIGNsZWFyVGltZW91dCA9IHdpbmRvdy5jbGVhclRpbWVvdXQsCiAgICAgIHBlbmRpbmdEZWZlcklkcyA9IHt9OwoKICAgIHNlbGYuaXNNb2NrID0gZmFsc2U7CgogICAgdmFyIG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID0gMDsKICAgIHZhciBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MgPSBbXTsKCiAgICAvLyBUT0RPKHZvanRhKTogcmVtb3ZlIHRoaXMgdGVtcG9yYXJ5IGFwaQogICAgc2VsZi4kJGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0ID0gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Q7CiAgICBzZWxmLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPSBmdW5jdGlvbigpIHsgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQrKzsgfTsKCiAgICAvKioKICAgICAqIEV4ZWN1dGVzIHRoZSBgZm5gIGZ1bmN0aW9uKHN1cHBvcnRzIGN1cnJ5aW5nKSBhbmQgZGVjcmVtZW50cyB0aGUgYG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrc2AKICAgICAqIGNvdW50ZXIuIElmIHRoZSBjb3VudGVyIHJlYWNoZXMgMCwgYWxsIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYCBhcmUgZXhlY3V0ZWQuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKSB7CiAgICAgIHRyeSB7CiAgICAgICAgZm4uYXBwbHkobnVsbCwgc2xpY2VBcmdzKGFyZ3VtZW50cywgMSkpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50LS07CiAgICAgICAgaWYgKG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID09PSAwKSB7CiAgICAgICAgICB3aGlsZShvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzLnBvcCgpKCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAkbG9nLmVycm9yKGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAcHJpdmF0ZQogICAgICogTm90ZTogdGhpcyBtZXRob2QgaXMgdXNlZCBvbmx5IGJ5IHNjZW5hcmlvIHJ1bm5lcgogICAgICogVE9ETyh2b2p0YSk6IHByZWZpeCB0aGlzIG1ldGhvZCB3aXRoICQkID8KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gY2FsbGJhY2sgRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuIG5vIG91dHN0YW5kaW5nIHJlcXVlc3QKICAgICAqLwogICAgc2VsZi5ub3RpZnlXaGVuTm9PdXRzdGFuZGluZ1JlcXVlc3RzID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgLy8gZm9yY2UgYnJvd3NlciB0byBleGVjdXRlIGFsbCBwb2xsRm5zIC0gdGhpcyBpcyBuZWVkZWQgc28gdGhhdCBjb29raWVzIGFuZCBvdGhlciBwb2xsZXJzIGZpcmUKICAgICAgLy8gYXQgc29tZSBkZXRlcm1pbmlzdGljIHRpbWUgaW4gcmVzcGVjdCB0byB0aGUgdGVzdCBydW5uZXIncyBhY3Rpb25zLiBMZWF2aW5nIHRoaW5ncyB1cCB0byB0aGUKICAgICAgLy8gcmVndWxhciBwb2xsZXIgd291bGQgcmVzdWx0IGluIGZsYWt5IHRlc3RzLgogICAgICBmb3JFYWNoKHBvbGxGbnMsIGZ1bmN0aW9uKHBvbGxGbil7IHBvbGxGbigpOyB9KTsKCiAgICAgIGlmIChvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9PT0gMCkgewogICAgICAgIGNhbGxiYWNrKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwogICAgICB9CiAgICB9OwoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBQb2xsIFdhdGNoZXIgQVBJCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgdmFyIHBvbGxGbnMgPSBbXSwKICAgICAgcG9sbFRpbWVvdXQ7CgogICAgLyoqCiAgICAgKiBAbmFtZSAkYnJvd3NlciNhZGRQb2xsRm4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIFBvbGwgZnVuY3Rpb24gdG8gYWRkCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBBZGRzIGEgZnVuY3Rpb24gdG8gdGhlIGxpc3Qgb2YgZnVuY3Rpb25zIHRoYXQgcG9sbGVyIHBlcmlvZGljYWxseSBleGVjdXRlcywKICAgICAqIGFuZCBzdGFydHMgcG9sbGluZyBpZiBub3Qgc3RhcnRlZCB5ZXQuCiAgICAgKgogICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IHRoZSBhZGRlZCBmdW5jdGlvbgogICAgICovCiAgICBzZWxmLmFkZFBvbGxGbiA9IGZ1bmN0aW9uKGZuKSB7CiAgICAgIGlmIChpc1VuZGVmaW5lZChwb2xsVGltZW91dCkpIHN0YXJ0UG9sbGVyKDEwMCwgc2V0VGltZW91dCk7CiAgICAgIHBvbGxGbnMucHVzaChmbik7CiAgICAgIHJldHVybiBmbjsKICAgIH07CgogICAgLyoqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaW50ZXJ2YWwgSG93IG9mdGVuIHNob3VsZCBicm93c2VyIGNhbGwgcG9sbCBmdW5jdGlvbnMgKG1zKQogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBzZXRUaW1lb3V0IFJlZmVyZW5jZSB0byBhIHJlYWwgb3IgZmFrZSBgc2V0VGltZW91dGAgZnVuY3Rpb24uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb25maWd1cmVzIHRoZSBwb2xsZXIgdG8gcnVuIGluIHRoZSBzcGVjaWZpZWQgaW50ZXJ2YWxzLCB1c2luZyB0aGUgc3BlY2lmaWVkCiAgICAgKiBzZXRUaW1lb3V0IGZuIGFuZCBraWNrcyBpdCBvZmYuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHN0YXJ0UG9sbGVyKGludGVydmFsLCBzZXRUaW1lb3V0KSB7CiAgICAgIChmdW5jdGlvbiBjaGVjaygpIHsKICAgICAgICBmb3JFYWNoKHBvbGxGbnMsIGZ1bmN0aW9uKHBvbGxGbil7IHBvbGxGbigpOyB9KTsKICAgICAgICBwb2xsVGltZW91dCA9IHNldFRpbWVvdXQoY2hlY2ssIGludGVydmFsKTsKICAgICAgfSkoKTsKICAgIH0KCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8gVVJMIEFQSQogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICB2YXIgbGFzdEJyb3dzZXJVcmwgPSBsb2NhdGlvbi5ocmVmLAogICAgICBiYXNlRWxlbWVudCA9IGRvY3VtZW50LmZpbmQoJ2Jhc2UnKSwKICAgICAgbmV3TG9jYXRpb24gPSBudWxsOwoKICAgIC8qKgogICAgICogQG5hbWUgJGJyb3dzZXIjdXJsCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBHRVRURVI6CiAgICAgKiBXaXRob3V0IGFueSBhcmd1bWVudCwgdGhpcyBtZXRob2QganVzdCByZXR1cm5zIGN1cnJlbnQgdmFsdWUgb2YgbG9jYXRpb24uaHJlZi4KICAgICAqCiAgICAgKiBTRVRURVI6CiAgICAgKiBXaXRoIGF0IGxlYXN0IG9uZSBhcmd1bWVudCwgdGhpcyBtZXRob2Qgc2V0cyB1cmwgdG8gbmV3IHZhbHVlLgogICAgICogSWYgaHRtbDUgaGlzdG9yeSBhcGkgc3VwcG9ydGVkLCBwdXNoU3RhdGUvcmVwbGFjZVN0YXRlIGlzIHVzZWQsIG90aGVyd2lzZQogICAgICogbG9jYXRpb24uaHJlZi9sb2NhdGlvbi5yZXBsYWNlIGlzIHVzZWQuCiAgICAgKiBSZXR1cm5zIGl0cyBvd24gaW5zdGFuY2UgdG8gYWxsb3cgY2hhaW5pbmcKICAgICAqCiAgICAgKiBOT1RFOiB0aGlzIGFwaSBpcyBpbnRlbmRlZCBmb3IgdXNlIG9ubHkgYnkgdGhlICRsb2NhdGlvbiBzZXJ2aWNlLiBQbGVhc2UgdXNlIHRoZQogICAgICoge0BsaW5rIG5nLiRsb2NhdGlvbiAkbG9jYXRpb24gc2VydmljZX0gdG8gY2hhbmdlIHVybC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIE5ldyB1cmwgKHdoZW4gdXNlZCBhcyBzZXR0ZXIpCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSByZXBsYWNlIFNob3VsZCBuZXcgdXJsIHJlcGxhY2UgY3VycmVudCBoaXN0b3J5IHJlY29yZCA/CiAgICAgKi8KICAgIHNlbGYudXJsID0gZnVuY3Rpb24odXJsLCByZXBsYWNlKSB7CiAgICAgIC8vIEFuZHJvaWQgQnJvd3NlciBCRkNhY2hlIGNhdXNlcyBsb2NhdGlvbiwgaGlzdG9yeSByZWZlcmVuY2UgdG8gYmVjb21lIHN0YWxlLgogICAgICBpZiAobG9jYXRpb24gIT09IHdpbmRvdy5sb2NhdGlvbikgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIGlmIChoaXN0b3J5ICE9PSB3aW5kb3cuaGlzdG9yeSkgaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwoKICAgICAgLy8gc2V0dGVyCiAgICAgIGlmICh1cmwpIHsKICAgICAgICBpZiAobGFzdEJyb3dzZXJVcmwgPT0gdXJsKSByZXR1cm47CiAgICAgICAgbGFzdEJyb3dzZXJVcmwgPSB1cmw7CiAgICAgICAgaWYgKCRzbmlmZmVyLmhpc3RvcnkpIHsKICAgICAgICAgIGlmIChyZXBsYWNlKSBoaXN0b3J5LnJlcGxhY2VTdGF0ZShudWxsLCAnJywgdXJsKTsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZShudWxsLCAnJywgdXJsKTsKICAgICAgICAgICAgLy8gQ3JhenkgT3BlcmEgQnVnOiBodHRwOi8vbXkub3BlcmEuY29tL2NvbW11bml0eS9mb3J1bXMvdG9waWMuZG1sP2lkPTExODU0NjIKICAgICAgICAgICAgYmFzZUVsZW1lbnQuYXR0cignaHJlZicsIGJhc2VFbGVtZW50LmF0dHIoJ2hyZWYnKSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5ld0xvY2F0aW9uID0gdXJsOwogICAgICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICAgICAgbG9jYXRpb24ucmVwbGFjZSh1cmwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbG9jYXRpb24uaHJlZiA9IHVybDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgLy8gZ2V0dGVyCiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gLSBuZXdMb2NhdGlvbiBpcyBhIHdvcmthcm91bmQgZm9yIGFuIElFNy05IGlzc3VlIHdpdGggbG9jYXRpb24ucmVwbGFjZSBhbmQgbG9jYXRpb24uaHJlZgogICAgICAgIC8vICAgbWV0aG9kcyBub3QgdXBkYXRpbmcgbG9jYXRpb24uaHJlZiBzeW5jaHJvbm91c2x5LgogICAgICAgIC8vIC0gdGhlIHJlcGxhY2VtZW50IGlzIGEgd29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NDA3MTcyCiAgICAgICAgcmV0dXJuIG5ld0xvY2F0aW9uIHx8IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvJTI3L2csIiciKTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgdXJsQ2hhbmdlTGlzdGVuZXJzID0gW10sCiAgICAgIHVybENoYW5nZUluaXQgPSBmYWxzZTsKCiAgICBmdW5jdGlvbiBmaXJlVXJsQ2hhbmdlKCkgewogICAgICBuZXdMb2NhdGlvbiA9IG51bGw7CiAgICAgIGlmIChsYXN0QnJvd3NlclVybCA9PSBzZWxmLnVybCgpKSByZXR1cm47CgogICAgICBsYXN0QnJvd3NlclVybCA9IHNlbGYudXJsKCk7CiAgICAgIGZvckVhY2godXJsQ2hhbmdlTGlzdGVuZXJzLCBmdW5jdGlvbihsaXN0ZW5lcikgewogICAgICAgIGxpc3RlbmVyKHNlbGYudXJsKCkpOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuYW1lICRicm93c2VyI29uVXJsQ2hhbmdlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZWdpc3RlciBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkLCB3aGVuIHVybCBjaGFuZ2VzLgogICAgICoKICAgICAqIEl0J3Mgb25seSBjYWxsZWQgd2hlbiB0aGUgdXJsIGlzIGNoYW5nZWQgZnJvbSBvdXRzaWRlIG9mIGFuZ3VsYXI6CiAgICAgKiAtIHVzZXIgdHlwZXMgZGlmZmVyZW50IHVybCBpbnRvIGFkZHJlc3MgYmFyCiAgICAgKiAtIHVzZXIgY2xpY2tzIG9uIGhpc3RvcnkgKGZvcndhcmQvYmFjaykgYnV0dG9uCiAgICAgKiAtIHVzZXIgY2xpY2tzIG9uIGEgbGluawogICAgICoKICAgICAqIEl0J3Mgbm90IGNhbGxlZCB3aGVuIHVybCBpcyBjaGFuZ2VkIGJ5ICRicm93c2VyLnVybCgpIG1ldGhvZAogICAgICoKICAgICAqIFRoZSBsaXN0ZW5lciBnZXRzIGNhbGxlZCB3aXRoIG5ldyB1cmwgYXMgcGFyYW1ldGVyLgogICAgICoKICAgICAqIE5PVEU6IHRoaXMgYXBpIGlzIGludGVuZGVkIGZvciB1c2Ugb25seSBieSB0aGUgJGxvY2F0aW9uIHNlcnZpY2UuIFBsZWFzZSB1c2UgdGhlCiAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBtb25pdG9yIHVybCBjaGFuZ2VzIGluIGFuZ3VsYXIgYXBwcy4KICAgICAqCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZyl9IGxpc3RlbmVyIExpc3RlbmVyIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCB3aGVuIHVybCBjaGFuZ2VzLgogICAgICogQHJldHVybiB7ZnVuY3Rpb24oc3RyaW5nKX0gUmV0dXJucyB0aGUgcmVnaXN0ZXJlZCBsaXN0ZW5lciBmbiAtIGhhbmR5IGlmIHRoZSBmbiBpcyBhbm9ueW1vdXMuCiAgICAgKi8KICAgIHNlbGYub25VcmxDaGFuZ2UgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAvLyBUT0RPKHZvanRhKTogcmVmYWN0b3IgdG8gdXNlIG5vZGUncyBzeW50YXggZm9yIGV2ZW50cwogICAgICBpZiAoIXVybENoYW5nZUluaXQpIHsKICAgICAgICAvLyBXZSBsaXN0ZW4gb24gYm90aCAoaGFzaGNoYW5nZS9wb3BzdGF0ZSkgd2hlbiBhdmFpbGFibGUsIGFzIHNvbWUgYnJvd3NlcnMgKGUuZy4gT3BlcmEpCiAgICAgICAgLy8gZG9uJ3QgZmlyZSBwb3BzdGF0ZSB3aGVuIHVzZXIgY2hhbmdlIHRoZSBhZGRyZXNzIGJhciBhbmQgZG9uJ3QgZmlyZSBoYXNoY2hhbmdlIHdoZW4gdXJsCiAgICAgICAgLy8gY2hhbmdlZCBieSBwdXNoL3JlcGxhY2VTdGF0ZQoKICAgICAgICAvLyBodG1sNSBoaXN0b3J5IGFwaSAtIHBvcHN0YXRlIGV2ZW50CiAgICAgICAgaWYgKCRzbmlmZmVyLmhpc3RvcnkpIGpxTGl0ZSh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIGZpcmVVcmxDaGFuZ2UpOwogICAgICAgIC8vIGhhc2hjaGFuZ2UgZXZlbnQKICAgICAgICBpZiAoJHNuaWZmZXIuaGFzaGNoYW5nZSkganFMaXRlKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCBmaXJlVXJsQ2hhbmdlKTsKICAgICAgICAvLyBwb2xsaW5nCiAgICAgICAgZWxzZSBzZWxmLmFkZFBvbGxGbihmaXJlVXJsQ2hhbmdlKTsKCiAgICAgICAgdXJsQ2hhbmdlSW5pdCA9IHRydWU7CiAgICAgIH0KCiAgICAgIHVybENoYW5nZUxpc3RlbmVycy5wdXNoKGNhbGxiYWNrKTsKICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgfTsKCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8gTWlzYyBBUEkKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyoqCiAgICAgKiBAbmFtZSAkYnJvd3NlciNiYXNlSHJlZgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0dXJucyBjdXJyZW50IDxiYXNlIGhyZWY+CiAgICAgKiAoYWx3YXlzIHJlbGF0aXZlIC0gd2l0aG91dCBkb21haW4pCiAgICAgKgogICAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGN1cnJlbnQgYmFzZSBocmVmCiAgICAgKi8KICAgIHNlbGYuYmFzZUhyZWYgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGhyZWYgPSBiYXNlRWxlbWVudC5hdHRyKCdocmVmJyk7CiAgICAgIHJldHVybiBocmVmID8gaHJlZi5yZXBsYWNlKC9eKGh0dHBzP1w6KT9cL1wvW15cL10qLywgJycpIDogJyc7CiAgICB9OwoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBDb29raWVzIEFQSQogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIHZhciBsYXN0Q29va2llcyA9IHt9OwogICAgdmFyIGxhc3RDb29raWVTdHJpbmcgPSAnJzsKICAgIHZhciBjb29raWVQYXRoID0gc2VsZi5iYXNlSHJlZigpOwoKICAgIC8qKgogICAgICogQG5hbWUgJGJyb3dzZXIjY29va2llcwogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBDb29raWUgbmFtZQogICAgICogQHBhcmFtIHtzdHJpbmc9fSB2YWx1ZSBDb29raWUgdmFsdWUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBjb29raWVzIG1ldGhvZCBwcm92aWRlcyBhICdwcml2YXRlJyBsb3cgbGV2ZWwgYWNjZXNzIHRvIGJyb3dzZXIgY29va2llcy4KICAgICAqIEl0IGlzIG5vdCBtZWFudCB0byBiZSB1c2VkIGRpcmVjdGx5LCB1c2UgdGhlICRjb29raWUgc2VydmljZSBpbnN0ZWFkLgogICAgICoKICAgICAqIFRoZSByZXR1cm4gdmFsdWVzIHZhcnkgZGVwZW5kaW5nIG9uIHRoZSBhcmd1bWVudHMgdGhhdCB0aGUgbWV0aG9kIHdhcyBjYWxsZWQgd2l0aCBhcyBmb2xsb3dzOgogICAgICoKICAgICAqIC0gY29va2llcygpIC0+IGhhc2ggb2YgYWxsIGNvb2tpZXMsIHRoaXMgaXMgTk9UIGEgY29weSBvZiB0aGUgaW50ZXJuYWwgc3RhdGUsIHNvIGRvIG5vdCBtb2RpZnkKICAgICAqICAgaXQKICAgICAqIC0gY29va2llcyhuYW1lLCB2YWx1ZSkgLT4gc2V0IG5hbWUgdG8gdmFsdWUsIGlmIHZhbHVlIGlzIHVuZGVmaW5lZCBkZWxldGUgdGhlIGNvb2tpZQogICAgICogLSBjb29raWVzKG5hbWUpIC0+IHRoZSBzYW1lIGFzIChuYW1lLCB1bmRlZmluZWQpID09IERFTEVURVMgKG5vIG9uZSBjYWxscyBpdCByaWdodCBub3cgdGhhdAogICAgICogICB3YXkpCiAgICAgKgogICAgICogQHJldHVybnMge09iamVjdH0gSGFzaCBvZiBhbGwgY29va2llcyAoaWYgY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlcikKICAgICAqLwogICAgc2VsZi5jb29raWVzID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgLyogZ2xvYmFsIGVzY2FwZTogZmFsc2UsIHVuZXNjYXBlOiBmYWxzZSAqLwogICAgICB2YXIgY29va2llTGVuZ3RoLCBjb29raWVBcnJheSwgY29va2llLCBpLCBpbmRleDsKCiAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHJhd0RvY3VtZW50LmNvb2tpZSA9IGVzY2FwZShuYW1lKSArICI9O3BhdGg9IiArIGNvb2tpZVBhdGggKwogICAgICAgICAgICAiO2V4cGlyZXM9VGh1LCAwMSBKYW4gMTk3MCAwMDowMDowMCBHTVQiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICAgIGNvb2tpZUxlbmd0aCA9IChyYXdEb2N1bWVudC5jb29raWUgPSBlc2NhcGUobmFtZSkgKyAnPScgKyBlc2NhcGUodmFsdWUpICsKICAgICAgICAgICAgICAnO3BhdGg9JyArIGNvb2tpZVBhdGgpLmxlbmd0aCArIDE7CgogICAgICAgICAgICAvLyBwZXIgaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMjEwOS50eHQgYnJvd3NlciBtdXN0IGFsbG93IGF0IG1pbmltdW06CiAgICAgICAgICAgIC8vIC0gMzAwIGNvb2tpZXMKICAgICAgICAgICAgLy8gLSAyMCBjb29raWVzIHBlciB1bmlxdWUgZG9tYWluCiAgICAgICAgICAgIC8vIC0gNDA5NiBieXRlcyBwZXIgY29va2llCiAgICAgICAgICAgIGlmIChjb29raWVMZW5ndGggPiA0MDk2KSB7CiAgICAgICAgICAgICAgJGxvZy53YXJuKCJDb29raWUgJyIrIG5hbWUgKwogICAgICAgICAgICAgICAgIicgcG9zc2libHkgbm90IHNldCBvciBvdmVyZmxvd2VkIGJlY2F1c2UgaXQgd2FzIHRvbyBsYXJnZSAoIisKICAgICAgICAgICAgICAgIGNvb2tpZUxlbmd0aCArICIgPiA0MDk2IGJ5dGVzKSEiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAocmF3RG9jdW1lbnQuY29va2llICE9PSBsYXN0Q29va2llU3RyaW5nKSB7CiAgICAgICAgICBsYXN0Q29va2llU3RyaW5nID0gcmF3RG9jdW1lbnQuY29va2llOwogICAgICAgICAgY29va2llQXJyYXkgPSBsYXN0Q29va2llU3RyaW5nLnNwbGl0KCI7ICIpOwogICAgICAgICAgbGFzdENvb2tpZXMgPSB7fTsKCiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29va2llQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29va2llID0gY29va2llQXJyYXlbaV07CiAgICAgICAgICAgIGluZGV4ID0gY29va2llLmluZGV4T2YoJz0nKTsKICAgICAgICAgICAgaWYgKGluZGV4ID4gMCkgeyAvL2lnbm9yZSBuYW1lbGVzcyBjb29raWVzCiAgICAgICAgICAgICAgbmFtZSA9IHVuZXNjYXBlKGNvb2tpZS5zdWJzdHJpbmcoMCwgaW5kZXgpKTsKICAgICAgICAgICAgICAvLyB0aGUgZmlyc3QgdmFsdWUgdGhhdCBpcyBzZWVuIGZvciBhIGNvb2tpZSBpcyB0aGUgbW9zdAogICAgICAgICAgICAgIC8vIHNwZWNpZmljIG9uZS4gIHZhbHVlcyBmb3IgdGhlIHNhbWUgY29va2llIG5hbWUgdGhhdAogICAgICAgICAgICAgIC8vIGZvbGxvdyBhcmUgZm9yIGxlc3Mgc3BlY2lmaWMgcGF0aHMuCiAgICAgICAgICAgICAgaWYgKGxhc3RDb29raWVzW25hbWVdID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGxhc3RDb29raWVzW25hbWVdID0gdW5lc2NhcGUoY29va2llLnN1YnN0cmluZyhpbmRleCArIDEpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGxhc3RDb29raWVzOwogICAgICB9CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuYW1lICRicm93c2VyI2RlZmVyCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24sIHdobydzIGV4ZWN1dGlvbiBzaG91bGQgYmUgZGVmZXJyZWQuCiAgICAgKiBAcGFyYW0ge251bWJlcj19IFtkZWxheT0wXSBvZiBtaWxsaXNlY29uZHMgdG8gZGVmZXIgdGhlIGZ1bmN0aW9uIGV4ZWN1dGlvbi4KICAgICAqIEByZXR1cm5zIHsqfSBEZWZlcklkIHRoYXQgY2FuIGJlIHVzZWQgdG8gY2FuY2VsIHRoZSB0YXNrIHZpYSBgJGJyb3dzZXIuZGVmZXIuY2FuY2VsKClgLgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRXhlY3V0ZXMgYSBmbiBhc3luY2hyb25vdXNseSB2aWEgYHNldFRpbWVvdXQoZm4sIGRlbGF5KWAuCiAgICAgKgogICAgICogVW5saWtlIHdoZW4gY2FsbGluZyBgc2V0VGltZW91dGAgZGlyZWN0bHksIGluIHRlc3QgdGhpcyBmdW5jdGlvbiBpcyBtb2NrZWQgYW5kIGluc3RlYWQgb2YgdXNpbmcKICAgICAqIGBzZXRUaW1lb3V0YCBpbiB0ZXN0cywgdGhlIGZucyBhcmUgcXVldWVkIGluIGFuIGFycmF5LCB3aGljaCBjYW4gYmUgcHJvZ3JhbW1hdGljYWxseSBmbHVzaGVkCiAgICAgKiB2aWEgYCRicm93c2VyLmRlZmVyLmZsdXNoKClgLgogICAgICoKICAgICAqLwogICAgc2VsZi5kZWZlciA9IGZ1bmN0aW9uKGZuLCBkZWxheSkgewogICAgICB2YXIgdGltZW91dElkOwogICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOwogICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXTsKICAgICAgICBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChmbik7CiAgICAgIH0sIGRlbGF5IHx8IDApOwogICAgICBwZW5kaW5nRGVmZXJJZHNbdGltZW91dElkXSA9IHRydWU7CiAgICAgIHJldHVybiB0aW1lb3V0SWQ7CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuYW1lICRicm93c2VyI2RlZmVyLmNhbmNlbAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ2FuY2VscyBhIGRlZmVycmVkIHRhc2sgaWRlbnRpZmllZCB3aXRoIGBkZWZlcklkYC4KICAgICAqCiAgICAgKiBAcGFyYW0geyp9IGRlZmVySWQgVG9rZW4gcmV0dXJuZWQgYnkgdGhlIGAkYnJvd3Nlci5kZWZlcmAgZnVuY3Rpb24uCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHRhc2sgaGFzbid0IGV4ZWN1dGVkIHlldCBhbmQgd2FzIHN1Y2Nlc3NmdWxseQogICAgICogICAgICAgICAgICAgICAgICAgIGNhbmNlbGVkLgogICAgICovCiAgICBzZWxmLmRlZmVyLmNhbmNlbCA9IGZ1bmN0aW9uKGRlZmVySWQpIHsKICAgICAgaWYgKHBlbmRpbmdEZWZlcklkc1tkZWZlcklkXSkgewogICAgICAgIGRlbGV0ZSBwZW5kaW5nRGVmZXJJZHNbZGVmZXJJZF07CiAgICAgICAgY2xlYXJUaW1lb3V0KGRlZmVySWQpOwogICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KG5vb3ApOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogIH0KCiAgZnVuY3Rpb24gJEJyb3dzZXJQcm92aWRlcigpewogICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgJyRsb2cnLCAnJHNuaWZmZXInLCAnJGRvY3VtZW50JywKICAgICAgZnVuY3Rpb24oICR3aW5kb3csICAgJGxvZywgICAkc25pZmZlciwgICAkZG9jdW1lbnQpewogICAgICAgIHJldHVybiBuZXcgQnJvd3Nlcigkd2luZG93LCAkZG9jdW1lbnQsICRsb2csICRzbmlmZmVyKTsKICAgICAgfV07CiAgfQoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRjYWNoZUZhY3RvcnkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEZhY3RvcnkgdGhhdCBjb25zdHJ1Y3RzIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfSBvYmplY3RzIGFuZCBnaXZlcyBhY2Nlc3MgdG8KICAgKiB0aGVtLgogICAqCiAgICogYGBganMKICAgKgogICAqICB2YXIgY2FjaGUgPSAkY2FjaGVGYWN0b3J5KCdjYWNoZUlkJyk7CiAgICogIGV4cGVjdCgkY2FjaGVGYWN0b3J5LmdldCgnY2FjaGVJZCcpKS50b0JlKGNhY2hlKTsKICAgKiAgZXhwZWN0KCRjYWNoZUZhY3RvcnkuZ2V0KCdub1N1Y2hDYWNoZUlkJykpLm5vdC50b0JlRGVmaW5lZCgpOwogICAqCiAgICogIGNhY2hlLnB1dCgia2V5IiwgInZhbHVlIik7CiAgICogIGNhY2hlLnB1dCgiYW5vdGhlciBrZXkiLCAiYW5vdGhlciB2YWx1ZSIpOwogICAqCiAgICogIC8vIFdlJ3ZlIHNwZWNpZmllZCBubyBvcHRpb25zIG9uIGNyZWF0aW9uCiAgICogIGV4cGVjdChjYWNoZS5pbmZvKCkpLnRvRXF1YWwoe2lkOiAnY2FjaGVJZCcsIHNpemU6IDJ9KTsKICAgKgogICAqIGBgYAogICAqCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gY2FjaGVJZCBOYW1lIG9yIGlkIG9mIHRoZSBuZXdseSBjcmVhdGVkIGNhY2hlLgogICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBPcHRpb25zIG9iamVjdCB0aGF0IHNwZWNpZmllcyB0aGUgY2FjaGUgYmVoYXZpb3IuIFByb3BlcnRpZXM6CiAgICoKICAgKiAgIC0gYHtudW1iZXI9fWAgYGNhcGFjaXR5YCDigJQgdHVybnMgdGhlIGNhY2hlIGludG8gTFJVIGNhY2hlLgogICAqCiAgICogQHJldHVybnMge29iamVjdH0gTmV3bHkgY3JlYXRlZCBjYWNoZSBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHNldCBvZiBtZXRob2RzOgogICAqCiAgICogLSBge29iamVjdH1gIGBpbmZvKClgIOKAlCBSZXR1cm5zIGlkLCBzaXplLCBhbmQgb3B0aW9ucyBvZiBjYWNoZS4KICAgKiAtIGB7eyp9fWAgYHB1dCh7c3RyaW5nfSBrZXksIHsqfSB2YWx1ZSlgIOKAlCBQdXRzIGEgbmV3IGtleS12YWx1ZSBwYWlyIGludG8gdGhlIGNhY2hlIGFuZCByZXR1cm5zCiAgICogICBpdC4KICAgKiAtIGB7eyp9fWAgYGdldCh7c3RyaW5nfSBrZXkpYCDigJQgUmV0dXJucyBjYWNoZWQgdmFsdWUgZm9yIGBrZXlgIG9yIHVuZGVmaW5lZCBmb3IgY2FjaGUgbWlzcy4KICAgKiAtIGB7dm9pZH1gIGByZW1vdmUoe3N0cmluZ30ga2V5KWAg4oCUIFJlbW92ZXMgYSBrZXktdmFsdWUgcGFpciBmcm9tIHRoZSBjYWNoZS4KICAgKiAtIGB7dm9pZH1gIGByZW1vdmVBbGwoKWAg4oCUIFJlbW92ZXMgYWxsIGNhY2hlZCB2YWx1ZXMuCiAgICogLSBge3ZvaWR9YCBgZGVzdHJveSgpYCDigJQgUmVtb3ZlcyByZWZlcmVuY2VzIHRvIHRoaXMgY2FjaGUgZnJvbSAkY2FjaGVGYWN0b3J5LgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJjYWNoZUV4YW1wbGVBcHAiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDYWNoZUNvbnRyb2xsZXIiPgogICA8aW5wdXQgbmctbW9kZWw9Im5ld0NhY2hlS2V5IiBwbGFjZWhvbGRlcj0iS2V5Ij4KICAgPGlucHV0IG5nLW1vZGVsPSJuZXdDYWNoZVZhbHVlIiBwbGFjZWhvbGRlcj0iVmFsdWUiPgogICA8YnV0dG9uIG5nLWNsaWNrPSJwdXQobmV3Q2FjaGVLZXksIG5ld0NhY2hlVmFsdWUpIj5DYWNoZTwvYnV0dG9uPgoKICAgPHAgbmctaWY9ImtleXMubGVuZ3RoIj5DYWNoZWQgVmFsdWVzPC9wPgogICA8ZGl2IG5nLXJlcGVhdD0ia2V5IGluIGtleXMiPgogICA8c3BhbiBuZy1iaW5kPSJrZXkiPjwvc3Bhbj4KICAgPHNwYW4+OiA8L3NwYW4+CiAgIDxiIG5nLWJpbmQ9ImNhY2hlLmdldChrZXkpIj48L2I+CiAgIDwvZGl2PgoKICAgPHA+Q2FjaGUgSW5mbzwvcD4KICAgPGRpdiBuZy1yZXBlYXQ9IihrZXksIHZhbHVlKSBpbiBjYWNoZS5pbmZvKCkiPgogICA8c3BhbiBuZy1iaW5kPSJrZXkiPjwvc3Bhbj4KICAgPHNwYW4+OiA8L3NwYW4+CiAgIDxiIG5nLWJpbmQ9InZhbHVlIj48L2I+CiAgIDwvZGl2PgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICBhbmd1bGFyLm1vZHVsZSgnY2FjaGVFeGFtcGxlQXBwJywgW10pLgogICBjb250cm9sbGVyKCdDYWNoZUNvbnRyb2xsZXInLCBbJyRzY29wZScsICckY2FjaGVGYWN0b3J5JywgZnVuY3Rpb24oJHNjb3BlLCAkY2FjaGVGYWN0b3J5KSB7CiAgICAgICAgICAgJHNjb3BlLmtleXMgPSBbXTsKICAgICAgICAgICAkc2NvcGUuY2FjaGUgPSAkY2FjaGVGYWN0b3J5KCdjYWNoZUlkJyk7CiAgICAgICAgICAgJHNjb3BlLnB1dCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICRzY29wZS5jYWNoZS5wdXQoa2V5LCB2YWx1ZSk7CiAgICAgICAgICAgICAkc2NvcGUua2V5cy5wdXNoKGtleSk7CiAgICAgICAgICAgfTsKICAgICAgICAgfV0pOwogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgIHAgewogICAgICAgICBtYXJnaW46IDEwcHggMCAzcHg7CiAgICAgICB9CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIGZ1bmN0aW9uICRDYWNoZUZhY3RvcnlQcm92aWRlcigpIHsKCiAgICB0aGlzLiRnZXQgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNhY2hlcyA9IHt9OwoKICAgICAgZnVuY3Rpb24gY2FjaGVGYWN0b3J5KGNhY2hlSWQsIG9wdGlvbnMpIHsKICAgICAgICBpZiAoY2FjaGVJZCBpbiBjYWNoZXMpIHsKICAgICAgICAgIHRocm93IG1pbkVycignJGNhY2hlRmFjdG9yeScpKCdpaWQnLCAiQ2FjaGVJZCAnezB9JyBpcyBhbHJlYWR5IHRha2VuISIsIGNhY2hlSWQpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNpemUgPSAwLAogICAgICAgICAgc3RhdHMgPSBleHRlbmQoe30sIG9wdGlvbnMsIHtpZDogY2FjaGVJZH0pLAogICAgICAgICAgZGF0YSA9IHt9LAogICAgICAgICAgY2FwYWNpdHkgPSAob3B0aW9ucyAmJiBvcHRpb25zLmNhcGFjaXR5KSB8fCBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgICAgbHJ1SGFzaCA9IHt9LAogICAgICAgICAgZnJlc2hFbmQgPSBudWxsLAogICAgICAgICAgc3RhbGVFbmQgPSBudWxsOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgdHlwZQogICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEEgY2FjaGUgb2JqZWN0IHVzZWQgdG8gc3RvcmUgYW5kIHJldHJpZXZlIGRhdGEsIHByaW1hcmlseSB1c2VkIGJ5CiAgICAgICAgICoge0BsaW5rICRodHRwICRodHRwfSBhbmQgdGhlIHtAbGluayBuZy5kaXJlY3RpdmU6c2NyaXB0IHNjcmlwdH0gZGlyZWN0aXZlIHRvIGNhY2hlCiAgICAgICAgICogdGVtcGxhdGVzIGFuZCBvdGhlciBkYXRhLgogICAgICAgICAqCiAgICAgICAgICogYGBganMKICAgICAgICAgKiAgYW5ndWxhci5tb2R1bGUoJ3N1cGVyQ2FjaGUnKQogICAgICAgICAqICAgIC5mYWN0b3J5KCdzdXBlckNhY2hlJywgWyckY2FjaGVGYWN0b3J5JywgZnVuY3Rpb24oJGNhY2hlRmFjdG9yeSkgewogICAgICAgKiAgICAgIHJldHVybiAkY2FjaGVGYWN0b3J5KCdzdXBlci1jYWNoZScpOwogICAgICAgKiAgICB9XSk7CiAgICAgICAgICogYGBgCiAgICAgICAgICoKICAgICAgICAgKiBFeGFtcGxlIHRlc3Q6CiAgICAgICAgICoKICAgICAgICAgKiBgYGBqcwogICAgICAgICAqICBpdCgnc2hvdWxkIGJlaGF2ZSBsaWtlIGEgY2FjaGUnLCBpbmplY3QoZnVuY3Rpb24oc3VwZXJDYWNoZSkgewogICAgICAgKiAgICBzdXBlckNhY2hlLnB1dCgna2V5JywgJ3ZhbHVlJyk7CiAgICAgICAqICAgIHN1cGVyQ2FjaGUucHV0KCdhbm90aGVyIGtleScsICdhbm90aGVyIHZhbHVlJyk7CiAgICAgICAqCiAgICAgICAqICAgIGV4cGVjdChzdXBlckNhY2hlLmluZm8oKSkudG9FcXVhbCh7CiAgICAgICAqICAgICAgaWQ6ICdzdXBlci1jYWNoZScsCiAgICAgICAqICAgICAgc2l6ZTogMgogICAgICAgKiAgICB9KTsKICAgICAgICoKICAgICAgICogICAgc3VwZXJDYWNoZS5yZW1vdmUoJ2Fub3RoZXIga2V5Jyk7CiAgICAgICAqICAgIGV4cGVjdChzdXBlckNhY2hlLmdldCgnYW5vdGhlciBrZXknKSkudG9CZVVuZGVmaW5lZCgpOwogICAgICAgKgogICAgICAgKiAgICBzdXBlckNhY2hlLnJlbW92ZUFsbCgpOwogICAgICAgKiAgICBleHBlY3Qoc3VwZXJDYWNoZS5pbmZvKCkpLnRvRXF1YWwoewogICAgICAgKiAgICAgIGlkOiAnc3VwZXItY2FjaGUnLAogICAgICAgKiAgICAgIHNpemU6IDAKICAgICAgICogICAgfSk7CiAgICAgICAqICB9KSk7CiAgICAgICAgICogYGBgCiAgICAgICAgICovCiAgICAgICAgcmV0dXJuIGNhY2hlc1tjYWNoZUlkXSA9IHsKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUjcHV0CiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogSW5zZXJ0cyBhIG5hbWVkIGVudHJ5IGludG8gdGhlIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfSBvYmplY3QgdG8gYmUKICAgICAgICAgICAqIHJldHJpZXZlZCBsYXRlciwgYW5kIGluY3JlbWVudGluZyB0aGUgc2l6ZSBvZiB0aGUgY2FjaGUgaWYgdGhlIGtleSB3YXMgbm90IGFscmVhZHkKICAgICAgICAgICAqIHByZXNlbnQgaW4gdGhlIGNhY2hlLiBJZiBiZWhhdmluZyBsaWtlIGFuIExSVSBjYWNoZSwgaXQgd2lsbCBhbHNvIHJlbW92ZSBzdGFsZQogICAgICAgICAgICogZW50cmllcyBmcm9tIHRoZSBzZXQuCiAgICAgICAgICAgKgogICAgICAgICAgICogSXQgd2lsbCBub3QgaW5zZXJ0IHVuZGVmaW5lZCB2YWx1ZXMgaW50byB0aGUgY2FjaGUuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSB0aGUga2V5IHVuZGVyIHdoaWNoIHRoZSBjYWNoZWQgZGF0YSBpcyBzdG9yZWQuCiAgICAgICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIHRoZSB2YWx1ZSB0byBzdG9yZSBhbG9uZ3NpZGUgdGhlIGtleS4gSWYgaXQgaXMgdW5kZWZpbmVkLCB0aGUga2V5CiAgICAgICAgICAgKiAgICB3aWxsIG5vdCBiZSBzdG9yZWQuCiAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gdGhlIHZhbHVlIHN0b3JlZC4KICAgICAgICAgICAqLwogICAgICAgICAgcHV0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChjYXBhY2l0eSA8IE51bWJlci5NQVhfVkFMVUUpIHsKICAgICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV0gfHwgKGxydUhhc2hba2V5XSA9IHtrZXk6IGtleX0pOwoKICAgICAgICAgICAgICByZWZyZXNoKGxydUVudHJ5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgICBpZiAoIShrZXkgaW4gZGF0YSkpIHNpemUrKzsKICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7CgogICAgICAgICAgICBpZiAoc2l6ZSA+IGNhcGFjaXR5KSB7CiAgICAgICAgICAgICAgdGhpcy5yZW1vdmUoc3RhbGVFbmQua2V5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUjZ2V0CiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogUmV0cmlldmVzIG5hbWVkIGRhdGEgc3RvcmVkIGluIHRoZSB7QGxpbmsgJGNhY2hlRmFjdG9yeS5DYWNoZSBDYWNoZX0gb2JqZWN0LgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgdGhlIGtleSBvZiB0aGUgZGF0YSB0byBiZSByZXRyaWV2ZWQKICAgICAgICAgICAqIEByZXR1cm5zIHsqfSB0aGUgdmFsdWUgc3RvcmVkLgogICAgICAgICAgICovCiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICBpZiAoY2FwYWNpdHkgPCBOdW1iZXIuTUFYX1ZBTFVFKSB7CiAgICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldOwoKICAgICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZGF0YVtrZXldOwogICAgICAgICAgfSwKCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5LkNhY2hlI3JlbW92ZQogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFJlbW92ZXMgYW4gZW50cnkgZnJvbSB0aGUge0BsaW5rICRjYWNoZUZhY3RvcnkuQ2FjaGUgQ2FjaGV9IG9iamVjdC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IHRoZSBrZXkgb2YgdGhlIGVudHJ5IHRvIGJlIHJlbW92ZWQKICAgICAgICAgICAqLwogICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgaWYgKGNhcGFjaXR5IDwgTnVtYmVyLk1BWF9WQUxVRSkgewogICAgICAgICAgICAgIHZhciBscnVFbnRyeSA9IGxydUhhc2hba2V5XTsKCiAgICAgICAgICAgICAgaWYgKCFscnVFbnRyeSkgcmV0dXJuOwoKICAgICAgICAgICAgICBpZiAobHJ1RW50cnkgPT0gZnJlc2hFbmQpIGZyZXNoRW5kID0gbHJ1RW50cnkucDsKICAgICAgICAgICAgICBpZiAobHJ1RW50cnkgPT0gc3RhbGVFbmQpIHN0YWxlRW5kID0gbHJ1RW50cnkubjsKICAgICAgICAgICAgICBsaW5rKGxydUVudHJ5Lm4sbHJ1RW50cnkucCk7CgogICAgICAgICAgICAgIGRlbGV0ZSBscnVIYXNoW2tleV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRlbGV0ZSBkYXRhW2tleV07CiAgICAgICAgICAgIHNpemUtLTsKICAgICAgICAgIH0sCgoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNyZW1vdmVBbGwKICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBDbGVhcnMgdGhlIGNhY2hlIG9iamVjdCBvZiBhbnkgZW50cmllcy4KICAgICAgICAgICAqLwogICAgICAgICAgcmVtb3ZlQWxsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZGF0YSA9IHt9OwogICAgICAgICAgICBzaXplID0gMDsKICAgICAgICAgICAgbHJ1SGFzaCA9IHt9OwogICAgICAgICAgICBmcmVzaEVuZCA9IHN0YWxlRW5kID0gbnVsbDsKICAgICAgICAgIH0sCgoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNkZXN0cm95CiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogRGVzdHJveXMgdGhlIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfSBvYmplY3QgZW50aXJlbHksCiAgICAgICAgICAgKiByZW1vdmluZyBpdCBmcm9tIHRoZSB7QGxpbmsgJGNhY2hlRmFjdG9yeSAkY2FjaGVGYWN0b3J5fSBzZXQuCiAgICAgICAgICAgKi8KICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkYXRhID0gbnVsbDsKICAgICAgICAgICAgc3RhdHMgPSBudWxsOwogICAgICAgICAgICBscnVIYXNoID0gbnVsbDsKICAgICAgICAgICAgZGVsZXRlIGNhY2hlc1tjYWNoZUlkXTsKICAgICAgICAgIH0sCgoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNpbmZvCiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogUmV0cmlldmUgaW5mb3JtYXRpb24gcmVnYXJkaW5nIGEgcGFydGljdWxhciB7QGxpbmsgJGNhY2hlRmFjdG9yeS5DYWNoZSBDYWNoZX0uCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybnMge29iamVjdH0gYW4gb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICAgICAgICogICA8dWw+CiAgICAgICAgICAgKiAgICAgPGxpPioqaWQqKjogdGhlIGlkIG9mIHRoZSBjYWNoZSBpbnN0YW5jZTwvbGk+CiAgICAgICAgICAgKiAgICAgPGxpPioqc2l6ZSoqOiB0aGUgbnVtYmVyIG9mIGVudHJpZXMga2VwdCBpbiB0aGUgY2FjaGUgaW5zdGFuY2U8L2xpPgogICAgICAgICAgICogICAgIDxsaT4qKi4uLioqOiBhbnkgYWRkaXRpb25hbCBwcm9wZXJ0aWVzIGZyb20gdGhlIG9wdGlvbnMgb2JqZWN0IHdoZW4gY3JlYXRpbmcgdGhlCiAgICAgICAgICAgKiAgICAgICBjYWNoZS48L2xpPgogICAgICAgICAgICogICA8L3VsPgogICAgICAgICAgICovCiAgICAgICAgICBpbmZvOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGV4dGVuZCh7fSwgc3RhdHMsIHtzaXplOiBzaXplfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCgogICAgICAgIC8qKgogICAgICAgICAqIG1ha2VzIHRoZSBgZW50cnlgIHRoZSBmcmVzaEVuZCBvZiB0aGUgTFJVIGxpbmtlZCBsaXN0CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcmVmcmVzaChlbnRyeSkgewogICAgICAgICAgaWYgKGVudHJ5ICE9IGZyZXNoRW5kKSB7CiAgICAgICAgICAgIGlmICghc3RhbGVFbmQpIHsKICAgICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5OwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YWxlRW5kID09IGVudHJ5KSB7CiAgICAgICAgICAgICAgc3RhbGVFbmQgPSBlbnRyeS5uOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsaW5rKGVudHJ5Lm4sIGVudHJ5LnApOwogICAgICAgICAgICBsaW5rKGVudHJ5LCBmcmVzaEVuZCk7CiAgICAgICAgICAgIGZyZXNoRW5kID0gZW50cnk7CiAgICAgICAgICAgIGZyZXNoRW5kLm4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIC8qKgogICAgICAgICAqIGJpZGlyZWN0aW9uYWxseSBsaW5rcyB0d28gZW50cmllcyBvZiB0aGUgTFJVIGxpbmtlZCBsaXN0CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gbGluayhuZXh0RW50cnksIHByZXZFbnRyeSkgewogICAgICAgICAgaWYgKG5leHRFbnRyeSAhPSBwcmV2RW50cnkpIHsKICAgICAgICAgICAgaWYgKG5leHRFbnRyeSkgbmV4dEVudHJ5LnAgPSBwcmV2RW50cnk7IC8vcCBzdGFuZHMgZm9yIHByZXZpb3VzLCAncHJldicgZGlkbid0IG1pbmlmeQogICAgICAgICAgICBpZiAocHJldkVudHJ5KSBwcmV2RW50cnkubiA9IG5leHRFbnRyeTsgLy9uIHN0YW5kcyBmb3IgbmV4dCwgJ25leHQnIGRpZG4ndCBtaW5pZnkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5I2luZm8KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEdldCBpbmZvcm1hdGlvbiBhYm91dCBhbGwgdGhlIGNhY2hlcyB0aGF0IGhhdmUgYmVlbiBjcmVhdGVkCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IC0ga2V5LXZhbHVlIG1hcCBvZiBgY2FjaGVJZGAgdG8gdGhlIHJlc3VsdCBvZiBjYWxsaW5nIGBjYWNoZSNpbmZvYAogICAgICAgKi8KICAgICAgY2FjaGVGYWN0b3J5LmluZm8gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgaW5mbyA9IHt9OwogICAgICAgIGZvckVhY2goY2FjaGVzLCBmdW5jdGlvbihjYWNoZSwgY2FjaGVJZCkgewogICAgICAgICAgaW5mb1tjYWNoZUlkXSA9IGNhY2hlLmluZm8oKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgfTsKCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5I2dldAogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogR2V0IGFjY2VzcyB0byBhIGNhY2hlIG9iamVjdCBieSB0aGUgYGNhY2hlSWRgIHVzZWQgd2hlbiBpdCB3YXMgY3JlYXRlZC4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlSWQgTmFtZSBvciBpZCBvZiBhIGNhY2hlIHRvIGFjY2Vzcy4KICAgICAgICogQHJldHVybnMge29iamVjdH0gQ2FjaGUgb2JqZWN0IGlkZW50aWZpZWQgYnkgdGhlIGNhY2hlSWQgb3IgdW5kZWZpbmVkIGlmIG5vIHN1Y2ggY2FjaGUuCiAgICAgICAqLwogICAgICBjYWNoZUZhY3RvcnkuZ2V0ID0gZnVuY3Rpb24oY2FjaGVJZCkgewogICAgICAgIHJldHVybiBjYWNoZXNbY2FjaGVJZF07CiAgICAgIH07CgoKICAgICAgcmV0dXJuIGNhY2hlRmFjdG9yeTsKICAgIH07CiAgfQoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICR0ZW1wbGF0ZUNhY2hlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgZmlyc3QgdGltZSBhIHRlbXBsYXRlIGlzIHVzZWQsIGl0IGlzIGxvYWRlZCBpbiB0aGUgdGVtcGxhdGUgY2FjaGUgZm9yIHF1aWNrIHJldHJpZXZhbC4gWW91CiAgICogY2FuIGxvYWQgdGVtcGxhdGVzIGRpcmVjdGx5IGludG8gdGhlIGNhY2hlIGluIGEgYHNjcmlwdGAgdGFnLCBvciBieSBjb25zdW1pbmcgdGhlCiAgICogYCR0ZW1wbGF0ZUNhY2hlYCBzZXJ2aWNlIGRpcmVjdGx5LgogICAqCiAgICogQWRkaW5nIHZpYSB0aGUgYHNjcmlwdGAgdGFnOgogICAqCiAgICogYGBgaHRtbAogICAqICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIiBpZD0idGVtcGxhdGVJZC5odG1sIj4KICAgKiAgICAgPHA+VGhpcyBpcyB0aGUgY29udGVudCBvZiB0aGUgdGVtcGxhdGU8L3A+CiAgICogICA8L3NjcmlwdD4KICAgKiBgYGAKICAgKgogICAqICoqTm90ZToqKiB0aGUgYHNjcmlwdGAgdGFnIGNvbnRhaW5pbmcgdGhlIHRlbXBsYXRlIGRvZXMgbm90IG5lZWQgdG8gYmUgaW5jbHVkZWQgaW4gdGhlIGBoZWFkYCBvZgogICAqIHRoZSBkb2N1bWVudCwgYnV0IGl0IG11c3QgYmUgYmVsb3cgdGhlIGBuZy1hcHBgIGRlZmluaXRpb24uCiAgICoKICAgKiBBZGRpbmcgdmlhIHRoZSAkdGVtcGxhdGVDYWNoZSBzZXJ2aWNlOgogICAqCiAgICogYGBganMKICAgKiB2YXIgbXlBcHAgPSBhbmd1bGFyLm1vZHVsZSgnbXlBcHAnLCBbXSk7CiAgICogbXlBcHAucnVuKGZ1bmN0aW9uKCR0ZW1wbGF0ZUNhY2hlKSB7CiAqICAgJHRlbXBsYXRlQ2FjaGUucHV0KCd0ZW1wbGF0ZUlkLmh0bWwnLCAnVGhpcyBpcyB0aGUgY29udGVudCBvZiB0aGUgdGVtcGxhdGUnKTsKICogfSk7CiAgICogYGBgCiAgICoKICAgKiBUbyByZXRyaWV2ZSB0aGUgdGVtcGxhdGUgbGF0ZXIsIHNpbXBseSB1c2UgaXQgaW4geW91ciBIVE1MOgogICAqIGBgYGh0bWwKICAgKiA8ZGl2IG5nLWluY2x1ZGU9IiAndGVtcGxhdGVJZC5odG1sJyAiPjwvZGl2PgogICAqIGBgYAogICAqCiAgICogb3IgZ2V0IGl0IHZpYSBKYXZhc2NyaXB0OgogICAqIGBgYGpzCiAgICogJHRlbXBsYXRlQ2FjaGUuZ2V0KCd0ZW1wbGF0ZUlkLmh0bWwnKQogICAqIGBgYAogICAqCiAgICogU2VlIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9LgogICAqCiAgICovCiAgZnVuY3Rpb24gJFRlbXBsYXRlQ2FjaGVQcm92aWRlcigpIHsKICAgIHRoaXMuJGdldCA9IFsnJGNhY2hlRmFjdG9yeScsIGZ1bmN0aW9uKCRjYWNoZUZhY3RvcnkpIHsKICAgICAgcmV0dXJuICRjYWNoZUZhY3RvcnkoJ3RlbXBsYXRlcycpOwogICAgfV07CiAgfQoKICAvKiAhIFZBUklBQkxFL0ZVTkNUSU9OIE5BTUlORyBDT05WRU5USU9OUyBUSEFUIEFQUExZIFRPIFRISVMgRklMRSEKICAgKgogICAqIERPTS1yZWxhdGVkIHZhcmlhYmxlczoKICAgKgogICAqIC0gIm5vZGUiIC0gRE9NIE5vZGUKICAgKiAtICJlbGVtZW50IiAtIERPTSBFbGVtZW50IG9yIE5vZGUKICAgKiAtICIkbm9kZSIgb3IgIiRlbGVtZW50IiAtIGpxTGl0ZS13cmFwcGVkIG5vZGUgb3IgZWxlbWVudAogICAqCiAgICoKICAgKiBDb21waWxlciByZWxhdGVkIHN0dWZmOgogICAqCiAgICogLSAibGlua0ZuIiAtIGxpbmtpbmcgZm4gb2YgYSBzaW5nbGUgZGlyZWN0aXZlCiAgICogLSAibm9kZUxpbmtGbiIgLSBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBhIHBhcnRpY3VsYXIgbm9kZQogICAqIC0gImNoaWxkTGlua0ZuIiAtICBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBjaGlsZCBub2RlcyBvZiBhIHBhcnRpY3VsYXIgbm9kZQogICAqIC0gImNvbXBvc2l0ZUxpbmtGbiIgLSBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYWxsIGxpbmtpbmcgZm5zIGZvciBhIGNvbXBpbGF0aW9uIHJvb3QgKG5vZGVMaXN0KQogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkY29tcGlsZQogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDb21waWxlcyBhbiBIVE1MIHN0cmluZyBvciBET00gaW50byBhIHRlbXBsYXRlIGFuZCBwcm9kdWNlcyBhIHRlbXBsYXRlIGZ1bmN0aW9uLCB3aGljaAogICAqIGNhbiB0aGVuIGJlIHVzZWQgdG8gbGluayB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBgc2NvcGVgfSBhbmQgdGhlIHRlbXBsYXRlIHRvZ2V0aGVyLgogICAqCiAgICogVGhlIGNvbXBpbGF0aW9uIGlzIGEgcHJvY2VzcyBvZiB3YWxraW5nIHRoZSBET00gdHJlZSBhbmQgbWF0Y2hpbmcgRE9NIGVsZW1lbnRzIHRvCiAgICoge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlIGRpcmVjdGl2ZXN9LgogICAqCiAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAgICogKipOb3RlOioqIFRoaXMgZG9jdW1lbnQgaXMgYW4gaW4tZGVwdGggcmVmZXJlbmNlIG9mIGFsbCBkaXJlY3RpdmUgb3B0aW9ucy4KICAgKiBGb3IgYSBnZW50bGUgaW50cm9kdWN0aW9uIHRvIGRpcmVjdGl2ZXMgd2l0aCBleGFtcGxlcyBvZiBjb21tb24gdXNlIGNhc2VzLAogICAqIHNlZSB0aGUge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSBkaXJlY3RpdmUgZ3VpZGV9LgogICAqIDwvZGl2PgogICAqCiAgICogIyMgQ29tcHJlaGVuc2l2ZSBEaXJlY3RpdmUgQVBJCiAgICoKICAgKiBUaGVyZSBhcmUgbWFueSBkaWZmZXJlbnQgb3B0aW9ucyBmb3IgYSBkaXJlY3RpdmUuCiAgICoKICAgKiBUaGUgZGlmZmVyZW5jZSByZXNpZGVzIGluIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZhY3RvcnkgZnVuY3Rpb24uCiAgICogWW91IGNhbiBlaXRoZXIgcmV0dXJuIGEgIkRpcmVjdGl2ZSBEZWZpbml0aW9uIE9iamVjdCIgKHNlZSBiZWxvdykgdGhhdCBkZWZpbmVzIHRoZSBkaXJlY3RpdmUgcHJvcGVydGllcywKICAgKiBvciBqdXN0IHRoZSBgcG9zdExpbmtgIGZ1bmN0aW9uIChhbGwgb3RoZXIgcHJvcGVydGllcyB3aWxsIGhhdmUgdGhlIGRlZmF1bHQgdmFsdWVzKS4KICAgKgogICAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXN1Y2Nlc3MiPgogICAqICoqQmVzdCBQcmFjdGljZToqKiBJdCdzIHJlY29tbWVuZGVkIHRvIHVzZSB0aGUgImRpcmVjdGl2ZSBkZWZpbml0aW9uIG9iamVjdCIgZm9ybS4KICAgKiA8L2Rpdj4KICAgKgogICAqIEhlcmUncyBhbiBleGFtcGxlIGRpcmVjdGl2ZSBkZWNsYXJlZCB3aXRoIGEgRGlyZWN0aXZlIERlZmluaXRpb24gT2JqZWN0OgogICAqCiAgICogYGBganMKICAgKiAgIHZhciBteU1vZHVsZSA9IGFuZ3VsYXIubW9kdWxlKC4uLik7CiAgICoKICAgKiAgIG15TW9kdWxlLmRpcmVjdGl2ZSgnZGlyZWN0aXZlTmFtZScsIGZ1bmN0aW9uIGZhY3RvcnkoaW5qZWN0YWJsZXMpIHsKICogICAgIHZhciBkaXJlY3RpdmVEZWZpbml0aW9uT2JqZWN0ID0gewogKiAgICAgICBwcmlvcml0eTogMCwKICogICAgICAgdGVtcGxhdGU6ICc8ZGl2PjwvZGl2PicsIC8vIG9yIC8vIGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsgLi4uIH0sCiAqICAgICAgIC8vIG9yCiAqICAgICAgIC8vIHRlbXBsYXRlVXJsOiAnZGlyZWN0aXZlLmh0bWwnLCAvLyBvciAvLyBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7IC4uLiB9LAogKiAgICAgICB0cmFuc2NsdWRlOiBmYWxzZSwKICogICAgICAgcmVzdHJpY3Q6ICdBJywKICogICAgICAgc2NvcGU6IGZhbHNlLAogKiAgICAgICBjb250cm9sbGVyOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsICR0cmFuc2NsdWRlLCBvdGhlckluamVjdGFibGVzKSB7IC4uLiB9LAogKiAgICAgICBjb250cm9sbGVyQXM6ICdzdHJpbmdBbGlhcycsCiAqICAgICAgIHJlcXVpcmU6ICdzaWJsaW5nRGlyZWN0aXZlTmFtZScsIC8vIG9yIC8vIFsnXnBhcmVudERpcmVjdGl2ZU5hbWUnLCAnP29wdGlvbmFsRGlyZWN0aXZlTmFtZScsICc/Xm9wdGlvbmFsUGFyZW50J10sCiAqICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIGNvbXBpbGUodEVsZW1lbnQsIHRBdHRycywgdHJhbnNjbHVkZSkgewogKiAgICAgICAgIHJldHVybiB7CiAqICAgICAgICAgICBwcmU6IGZ1bmN0aW9uIHByZUxpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMsIGNvbnRyb2xsZXIpIHsgLi4uIH0sCiAqICAgICAgICAgICBwb3N0OiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycywgY29udHJvbGxlcikgeyAuLi4gfQogKiAgICAgICAgIH0KICogICAgICAgICAvLyBvcgogKiAgICAgICAgIC8vIHJldHVybiBmdW5jdGlvbiBwb3N0TGluayggLi4uICkgeyAuLi4gfQogKiAgICAgICB9LAogKiAgICAgICAvLyBvcgogKiAgICAgICAvLyBsaW5rOiB7CiAqICAgICAgIC8vICBwcmU6IGZ1bmN0aW9uIHByZUxpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMsIGNvbnRyb2xsZXIpIHsgLi4uIH0sCiAqICAgICAgIC8vICBwb3N0OiBmdW5jdGlvbiBwb3N0TGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycywgY29udHJvbGxlcikgeyAuLi4gfQogKiAgICAgICAvLyB9CiAqICAgICAgIC8vIG9yCiAqICAgICAgIC8vIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKCAuLi4gKSB7IC4uLiB9CiAqICAgICB9OwogKiAgICAgcmV0dXJuIGRpcmVjdGl2ZURlZmluaXRpb25PYmplY3Q7CiAqICAgfSk7CiAgICogYGBgCiAgICoKICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICAgKiAqKk5vdGU6KiogQW55IHVuc3BlY2lmaWVkIG9wdGlvbnMgd2lsbCB1c2UgdGhlIGRlZmF1bHQgdmFsdWUuIFlvdSBjYW4gc2VlIHRoZSBkZWZhdWx0IHZhbHVlcyBiZWxvdy4KICAgKiA8L2Rpdj4KICAgKgogICAqIFRoZXJlZm9yZSB0aGUgYWJvdmUgY2FuIGJlIHNpbXBsaWZpZWQgYXM6CiAgICoKICAgKiBgYGBqcwogICAqICAgdmFyIG15TW9kdWxlID0gYW5ndWxhci5tb2R1bGUoLi4uKTsKICAgKgogICAqICAgbXlNb2R1bGUuZGlyZWN0aXZlKCdkaXJlY3RpdmVOYW1lJywgZnVuY3Rpb24gZmFjdG9yeShpbmplY3RhYmxlcykgewogKiAgICAgdmFyIGRpcmVjdGl2ZURlZmluaXRpb25PYmplY3QgPSB7CiAqICAgICAgIGxpbms6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzKSB7IC4uLiB9CiAqICAgICB9OwogKiAgICAgcmV0dXJuIGRpcmVjdGl2ZURlZmluaXRpb25PYmplY3Q7CiAqICAgICAvLyBvcgogKiAgICAgLy8gcmV0dXJuIGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzKSB7IC4uLiB9CiAqICAgfSk7CiAgICogYGBgCiAgICoKICAgKgogICAqCiAgICogIyMjIERpcmVjdGl2ZSBEZWZpbml0aW9uIE9iamVjdAogICAqCiAgICogVGhlIGRpcmVjdGl2ZSBkZWZpbml0aW9uIG9iamVjdCBwcm92aWRlcyBpbnN0cnVjdGlvbnMgdG8gdGhlIHtAbGluayBuZy4kY29tcGlsZQogKiBjb21waWxlcn0uIFRoZSBhdHRyaWJ1dGVzIGFyZToKICAgKgogICAqICMjIyMgYHByaW9yaXR5YAogICAqIFdoZW4gdGhlcmUgYXJlIG11bHRpcGxlIGRpcmVjdGl2ZXMgZGVmaW5lZCBvbiBhIHNpbmdsZSBET00gZWxlbWVudCwgc29tZXRpbWVzIGl0CiAgICogaXMgbmVjZXNzYXJ5IHRvIHNwZWNpZnkgdGhlIG9yZGVyIGluIHdoaWNoIHRoZSBkaXJlY3RpdmVzIGFyZSBhcHBsaWVkLiBUaGUgYHByaW9yaXR5YCBpcyB1c2VkCiAgICogdG8gc29ydCB0aGUgZGlyZWN0aXZlcyBiZWZvcmUgdGhlaXIgYGNvbXBpbGVgIGZ1bmN0aW9ucyBnZXQgY2FsbGVkLiBQcmlvcml0eSBpcyBkZWZpbmVkIGFzIGEKICAgKiBudW1iZXIuIERpcmVjdGl2ZXMgd2l0aCBncmVhdGVyIG51bWVyaWNhbCBgcHJpb3JpdHlgIGFyZSBjb21waWxlZCBmaXJzdC4gUHJlLWxpbmsgZnVuY3Rpb25zCiAgICogYXJlIGFsc28gcnVuIGluIHByaW9yaXR5IG9yZGVyLCBidXQgcG9zdC1saW5rIGZ1bmN0aW9ucyBhcmUgcnVuIGluIHJldmVyc2Ugb3JkZXIuIFRoZSBvcmRlcgogICAqIG9mIGRpcmVjdGl2ZXMgd2l0aCB0aGUgc2FtZSBwcmlvcml0eSBpcyB1bmRlZmluZWQuIFRoZSBkZWZhdWx0IHByaW9yaXR5IGlzIGAwYC4KICAgKgogICAqICMjIyMgYHRlcm1pbmFsYAogICAqIElmIHNldCB0byB0cnVlIHRoZW4gdGhlIGN1cnJlbnQgYHByaW9yaXR5YCB3aWxsIGJlIHRoZSBsYXN0IHNldCBvZiBkaXJlY3RpdmVzCiAgICogd2hpY2ggd2lsbCBleGVjdXRlIChhbnkgZGlyZWN0aXZlcyBhdCB0aGUgY3VycmVudCBwcmlvcml0eSB3aWxsIHN0aWxsIGV4ZWN1dGUKICAgKiBhcyB0aGUgb3JkZXIgb2YgZXhlY3V0aW9uIG9uIHNhbWUgYHByaW9yaXR5YCBpcyB1bmRlZmluZWQpLgogICAqCiAgICogIyMjIyBgc2NvcGVgCiAgICogKipJZiBzZXQgdG8gYHRydWVgLCoqIHRoZW4gYSBuZXcgc2NvcGUgd2lsbCBiZSBjcmVhdGVkIGZvciB0aGlzIGRpcmVjdGl2ZS4gSWYgbXVsdGlwbGUgZGlyZWN0aXZlcyBvbiB0aGUKICAgKiBzYW1lIGVsZW1lbnQgcmVxdWVzdCBhIG5ldyBzY29wZSwgb25seSBvbmUgbmV3IHNjb3BlIGlzIGNyZWF0ZWQuIFRoZSBuZXcgc2NvcGUgcnVsZSBkb2VzIG5vdAogICAqIGFwcGx5IGZvciB0aGUgcm9vdCBvZiB0aGUgdGVtcGxhdGUgc2luY2UgdGhlIHJvb3Qgb2YgdGhlIHRlbXBsYXRlIGFsd2F5cyBnZXRzIGEgbmV3IHNjb3BlLgogICAqCiAgICogKipJZiBzZXQgdG8gYHt9YCAob2JqZWN0IGhhc2gpLCoqIHRoZW4gYSBuZXcgImlzb2xhdGUiIHNjb3BlIGlzIGNyZWF0ZWQuIFRoZSAnaXNvbGF0ZScgc2NvcGUgZGlmZmVycyBmcm9tCiAgICogbm9ybWFsIHNjb3BlIGluIHRoYXQgaXQgZG9lcyBub3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdCBmcm9tIHRoZSBwYXJlbnQgc2NvcGUuIFRoaXMgaXMgdXNlZnVsCiAgICogd2hlbiBjcmVhdGluZyByZXVzYWJsZSBjb21wb25lbnRzLCB3aGljaCBzaG91bGQgbm90IGFjY2lkZW50YWxseSByZWFkIG9yIG1vZGlmeSBkYXRhIGluIHRoZQogICAqIHBhcmVudCBzY29wZS4KICAgKgogICAqIFRoZSAnaXNvbGF0ZScgc2NvcGUgdGFrZXMgYW4gb2JqZWN0IGhhc2ggd2hpY2ggZGVmaW5lcyBhIHNldCBvZiBsb2NhbCBzY29wZSBwcm9wZXJ0aWVzCiAgICogZGVyaXZlZCBmcm9tIHRoZSBwYXJlbnQgc2NvcGUuIFRoZXNlIGxvY2FsIHByb3BlcnRpZXMgYXJlIHVzZWZ1bCBmb3IgYWxpYXNpbmcgdmFsdWVzIGZvcgogICAqIHRlbXBsYXRlcy4gTG9jYWxzIGRlZmluaXRpb24gaXMgYSBoYXNoIG9mIGxvY2FsIHNjb3BlIHByb3BlcnR5IHRvIGl0cyBzb3VyY2U6CiAgICoKICAgKiAqIGBAYCBvciBgQGF0dHJgIC0gYmluZCBhIGxvY2FsIHNjb3BlIHByb3BlcnR5IHRvIHRoZSB2YWx1ZSBvZiBET00gYXR0cmlidXRlLiBUaGUgcmVzdWx0IGlzCiAgICogICBhbHdheXMgYSBzdHJpbmcgc2luY2UgRE9NIGF0dHJpYnV0ZXMgYXJlIHN0cmluZ3MuIElmIG5vIGBhdHRyYCBuYW1lIGlzIHNwZWNpZmllZCAgdGhlbiB0aGUKICAgKiAgIGF0dHJpYnV0ZSBuYW1lIGlzIGFzc3VtZWQgdG8gYmUgdGhlIHNhbWUgYXMgdGhlIGxvY2FsIG5hbWUuCiAgICogICBHaXZlbiBgPHdpZGdldCBteS1hdHRyPSJoZWxsbyB7e25hbWV9fSI+YCBhbmQgd2lkZ2V0IGRlZmluaXRpb24KICAgKiAgIG9mIGBzY29wZTogeyBsb2NhbE5hbWU6J0BteUF0dHInIH1gLCB0aGVuIHdpZGdldCBzY29wZSBwcm9wZXJ0eSBgbG9jYWxOYW1lYCB3aWxsIHJlZmxlY3QKICAgKiAgIHRoZSBpbnRlcnBvbGF0ZWQgdmFsdWUgb2YgYGhlbGxvIHt7bmFtZX19YC4gQXMgdGhlIGBuYW1lYCBhdHRyaWJ1dGUgY2hhbmdlcyBzbyB3aWxsIHRoZQogICAqICAgYGxvY2FsTmFtZWAgcHJvcGVydHkgb24gdGhlIHdpZGdldCBzY29wZS4gVGhlIGBuYW1lYCBpcyByZWFkIGZyb20gdGhlIHBhcmVudCBzY29wZSAobm90CiAgICogICBjb21wb25lbnQgc2NvcGUpLgogICAqCiAgICogKiBgPWAgb3IgYD1hdHRyYCAtIHNldCB1cCBiaS1kaXJlY3Rpb25hbCBiaW5kaW5nIGJldHdlZW4gYSBsb2NhbCBzY29wZSBwcm9wZXJ0eSBhbmQgdGhlCiAgICogICBwYXJlbnQgc2NvcGUgcHJvcGVydHkgb2YgbmFtZSBkZWZpbmVkIHZpYSB0aGUgdmFsdWUgb2YgdGhlIGBhdHRyYCBhdHRyaWJ1dGUuIElmIG5vIGBhdHRyYAogICAqICAgbmFtZSBpcyBzcGVjaWZpZWQgdGhlbiB0aGUgYXR0cmlidXRlIG5hbWUgaXMgYXNzdW1lZCB0byBiZSB0aGUgc2FtZSBhcyB0aGUgbG9jYWwgbmFtZS4KICAgKiAgIEdpdmVuIGA8d2lkZ2V0IG15LWF0dHI9InBhcmVudE1vZGVsIj5gIGFuZCB3aWRnZXQgZGVmaW5pdGlvbiBvZgogICAqICAgYHNjb3BlOiB7IGxvY2FsTW9kZWw6Jz1teUF0dHInIH1gLCB0aGVuIHdpZGdldCBzY29wZSBwcm9wZXJ0eSBgbG9jYWxNb2RlbGAgd2lsbCByZWZsZWN0IHRoZQogICAqICAgdmFsdWUgb2YgYHBhcmVudE1vZGVsYCBvbiB0aGUgcGFyZW50IHNjb3BlLiBBbnkgY2hhbmdlcyB0byBgcGFyZW50TW9kZWxgIHdpbGwgYmUgcmVmbGVjdGVkCiAgICogICBpbiBgbG9jYWxNb2RlbGAgYW5kIGFueSBjaGFuZ2VzIGluIGBsb2NhbE1vZGVsYCB3aWxsIHJlZmxlY3QgaW4gYHBhcmVudE1vZGVsYC4gSWYgdGhlIHBhcmVudAogICAqICAgc2NvcGUgcHJvcGVydHkgZG9lc24ndCBleGlzdCwgaXQgd2lsbCB0aHJvdyBhIE5PTl9BU1NJR05BQkxFX01PREVMX0VYUFJFU1NJT04gZXhjZXB0aW9uLiBZb3UKICAgKiAgIGNhbiBhdm9pZCB0aGlzIGJlaGF2aW9yIHVzaW5nIGA9P2Agb3IgYD0/YXR0cmAgaW4gb3JkZXIgdG8gZmxhZyB0aGUgcHJvcGVydHkgYXMgb3B0aW9uYWwuCiAgICoKICAgKiAqIGAmYCBvciBgJmF0dHJgIC0gcHJvdmlkZXMgYSB3YXkgdG8gZXhlY3V0ZSBhbiBleHByZXNzaW9uIGluIHRoZSBjb250ZXh0IG9mIHRoZSBwYXJlbnQgc2NvcGUuCiAgICogICBJZiBubyBgYXR0cmAgbmFtZSBpcyBzcGVjaWZpZWQgdGhlbiB0aGUgYXR0cmlidXRlIG5hbWUgaXMgYXNzdW1lZCB0byBiZSB0aGUgc2FtZSBhcyB0aGUKICAgKiAgIGxvY2FsIG5hbWUuIEdpdmVuIGA8d2lkZ2V0IG15LWF0dHI9ImNvdW50ID0gY291bnQgKyB2YWx1ZSI+YCBhbmQgd2lkZ2V0IGRlZmluaXRpb24gb2YKICAgKiAgIGBzY29wZTogeyBsb2NhbEZuOicmbXlBdHRyJyB9YCwgdGhlbiBpc29sYXRlIHNjb3BlIHByb3BlcnR5IGBsb2NhbEZuYCB3aWxsIHBvaW50IHRvCiAgICogICBhIGZ1bmN0aW9uIHdyYXBwZXIgZm9yIHRoZSBgY291bnQgPSBjb3VudCArIHZhbHVlYCBleHByZXNzaW9uLiBPZnRlbiBpdCdzIGRlc2lyYWJsZSB0bwogICAqICAgcGFzcyBkYXRhIGZyb20gdGhlIGlzb2xhdGVkIHNjb3BlIHZpYSBhbiBleHByZXNzaW9uIGFuZCB0byB0aGUgcGFyZW50IHNjb3BlLCB0aGlzIGNhbiBiZQogICAqICAgZG9uZSBieSBwYXNzaW5nIGEgbWFwIG9mIGxvY2FsIHZhcmlhYmxlIG5hbWVzIGFuZCB2YWx1ZXMgaW50byB0aGUgZXhwcmVzc2lvbiB3cmFwcGVyIGZuLgogICAqICAgRm9yIGV4YW1wbGUsIGlmIHRoZSBleHByZXNzaW9uIGlzIGBpbmNyZW1lbnQoYW1vdW50KWAgdGhlbiB3ZSBjYW4gc3BlY2lmeSB0aGUgYW1vdW50IHZhbHVlCiAgICogICBieSBjYWxsaW5nIHRoZSBgbG9jYWxGbmAgYXMgYGxvY2FsRm4oe2Ftb3VudDogMjJ9KWAuCiAgICoKICAgKgogICAqCiAgICogIyMjIyBgY29udHJvbGxlcmAKICAgKiBDb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBUaGUgY29udHJvbGxlciBpcyBpbnN0YW50aWF0ZWQgYmVmb3JlIHRoZQogICAqIHByZS1saW5raW5nIHBoYXNlIGFuZCBpdCBpcyBzaGFyZWQgd2l0aCBvdGhlciBkaXJlY3RpdmVzIChzZWUKICAgKiBgcmVxdWlyZWAgYXR0cmlidXRlKS4gVGhpcyBhbGxvd3MgdGhlIGRpcmVjdGl2ZXMgdG8gY29tbXVuaWNhdGUgd2l0aCBlYWNoIG90aGVyIGFuZCBhdWdtZW50CiAgICogZWFjaCBvdGhlcidzIGJlaGF2aW9yLiBUaGUgY29udHJvbGxlciBpcyBpbmplY3RhYmxlIChhbmQgc3VwcG9ydHMgYnJhY2tldCBub3RhdGlvbikgd2l0aCB0aGUgZm9sbG93aW5nIGxvY2FsczoKICAgKgogICAqICogYCRzY29wZWAgLSBDdXJyZW50IHNjb3BlIGFzc29jaWF0ZWQgd2l0aCB0aGUgZWxlbWVudAogICAqICogYCRlbGVtZW50YCAtIEN1cnJlbnQgZWxlbWVudAogICAqICogYCRhdHRyc2AgLSBDdXJyZW50IGF0dHJpYnV0ZXMgb2JqZWN0IGZvciB0aGUgZWxlbWVudAogICAqICogYCR0cmFuc2NsdWRlYCAtIEEgdHJhbnNjbHVkZSBsaW5raW5nIGZ1bmN0aW9uIHByZS1ib3VuZCB0byB0aGUgY29ycmVjdCB0cmFuc2NsdXNpb24gc2NvcGUuCiAgICogICAgVGhlIHNjb3BlIGNhbiBiZSBvdmVycmlkZGVuIGJ5IGFuIG9wdGlvbmFsIGZpcnN0IGFyZ3VtZW50LgogICAqICAgYGZ1bmN0aW9uKFtzY29wZV0sIGNsb25lTGlua2luZ0ZuKWAuCiAgICoKICAgKgogICAqICMjIyMgYHJlcXVpcmVgCiAgICogUmVxdWlyZSBhbm90aGVyIGRpcmVjdGl2ZSBhbmQgaW5qZWN0IGl0cyBjb250cm9sbGVyIGFzIHRoZSBmb3VydGggYXJndW1lbnQgdG8gdGhlIGxpbmtpbmcgZnVuY3Rpb24uIFRoZQogICAqIGByZXF1aXJlYCB0YWtlcyBhIHN0cmluZyBuYW1lIChvciBhcnJheSBvZiBzdHJpbmdzKSBvZiB0aGUgZGlyZWN0aXZlKHMpIHRvIHBhc3MgaW4uIElmIGFuIGFycmF5IGlzIHVzZWQsIHRoZQogICAqIGluamVjdGVkIGFyZ3VtZW50IHdpbGwgYmUgYW4gYXJyYXkgaW4gY29ycmVzcG9uZGluZyBvcmRlci4gSWYgbm8gc3VjaCBkaXJlY3RpdmUgY2FuIGJlCiAgICogZm91bmQsIG9yIGlmIHRoZSBkaXJlY3RpdmUgZG9lcyBub3QgaGF2ZSBhIGNvbnRyb2xsZXIsIHRoZW4gYW4gZXJyb3IgaXMgcmFpc2VkLiBUaGUgbmFtZSBjYW4gYmUgcHJlZml4ZWQgd2l0aDoKICAgKgogICAqICogKG5vIHByZWZpeCkgLSBMb2NhdGUgdGhlIHJlcXVpcmVkIGNvbnRyb2xsZXIgb24gdGhlIGN1cnJlbnQgZWxlbWVudC4gVGhyb3cgYW4gZXJyb3IgaWYgbm90IGZvdW5kLgogICAqICogYD9gIC0gQXR0ZW1wdCB0byBsb2NhdGUgdGhlIHJlcXVpcmVkIGNvbnRyb2xsZXIgb3IgcGFzcyBgbnVsbGAgdG8gdGhlIGBsaW5rYCBmbiBpZiBub3QgZm91bmQuCiAgICogKiBgXmAgLSBMb2NhdGUgdGhlIHJlcXVpcmVkIGNvbnRyb2xsZXIgYnkgc2VhcmNoaW5nIHRoZSBlbGVtZW50J3MgcGFyZW50cy4gVGhyb3cgYW4gZXJyb3IgaWYgbm90IGZvdW5kLgogICAqICogYD9eYCAtIEF0dGVtcHQgdG8gbG9jYXRlIHRoZSByZXF1aXJlZCBjb250cm9sbGVyIGJ5IHNlYXJjaGluZyB0aGUgZWxlbWVudCdzIHBhcmVudHMgb3IgcGFzcyBgbnVsbGAgdG8gdGhlCiAgICogICBgbGlua2AgZm4gaWYgbm90IGZvdW5kLgogICAqCiAgICoKICAgKiAjIyMjIGBjb250cm9sbGVyQXNgCiAgICogQ29udHJvbGxlciBhbGlhcyBhdCB0aGUgZGlyZWN0aXZlIHNjb3BlLiBBbiBhbGlhcyBmb3IgdGhlIGNvbnRyb2xsZXIgc28gaXQKICAgKiBjYW4gYmUgcmVmZXJlbmNlZCBhdCB0aGUgZGlyZWN0aXZlIHRlbXBsYXRlLiBUaGUgZGlyZWN0aXZlIG5lZWRzIHRvIGRlZmluZSBhIHNjb3BlIGZvciB0aGlzCiAgICogY29uZmlndXJhdGlvbiB0byBiZSB1c2VkLiBVc2VmdWwgaW4gdGhlIGNhc2Ugd2hlbiBkaXJlY3RpdmUgaXMgdXNlZCBhcyBjb21wb25lbnQuCiAgICoKICAgKgogICAqICMjIyMgYHJlc3RyaWN0YAogICAqIFN0cmluZyBvZiBzdWJzZXQgb2YgYEVBQ01gIHdoaWNoIHJlc3RyaWN0cyB0aGUgZGlyZWN0aXZlIHRvIGEgc3BlY2lmaWMgZGlyZWN0aXZlCiAgICogZGVjbGFyYXRpb24gc3R5bGUuIElmIG9taXR0ZWQsIHRoZSBkZWZhdWx0IChhdHRyaWJ1dGVzIG9ubHkpIGlzIHVzZWQuCiAgICoKICAgKiAqIGBFYCAtIEVsZW1lbnQgbmFtZTogYDxteS1kaXJlY3RpdmU+PC9teS1kaXJlY3RpdmU+YAogICAqICogYEFgIC0gQXR0cmlidXRlIChkZWZhdWx0KTogYDxkaXYgbXktZGlyZWN0aXZlPSJleHAiPjwvZGl2PmAKICAgKiAqIGBDYCAtIENsYXNzOiBgPGRpdiBjbGFzcz0ibXktZGlyZWN0aXZlOiBleHA7Ij48L2Rpdj5gCiAgICogKiBgTWAgLSBDb21tZW50OiBgPCEtLSBkaXJlY3RpdmU6IG15LWRpcmVjdGl2ZSBleHAgLS0+YAogICAqCiAgICoKICAgKiAjIyMjIGB0ZW1wbGF0ZWAKICAgKiByZXBsYWNlIHRoZSBjdXJyZW50IGVsZW1lbnQgd2l0aCB0aGUgY29udGVudHMgb2YgdGhlIEhUTUwuIFRoZSByZXBsYWNlbWVudCBwcm9jZXNzCiAgICogbWlncmF0ZXMgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIC8gY2xhc3NlcyBmcm9tIHRoZSBvbGQgZWxlbWVudCB0byB0aGUgbmV3IG9uZS4gU2VlIHRoZQogICAqIHtAbGluayBndWlkZS9kaXJlY3RpdmUjY3JlYXRpbmctY3VzdG9tLWRpcmVjdGl2ZXNfY3JlYXRpbmctZGlyZWN0aXZlc190ZW1wbGF0ZS1leHBhbmRpbmctZGlyZWN0aXZlCiAqIERpcmVjdGl2ZXMgR3VpZGV9IGZvciBhbiBleGFtcGxlLgogICAqCiAgICogWW91IGNhbiBzcGVjaWZ5IGB0ZW1wbGF0ZWAgYXMgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSB0ZW1wbGF0ZSBvciBhcyBhIGZ1bmN0aW9uIHdoaWNoIHRha2VzCiAgICogdHdvIGFyZ3VtZW50cyBgdEVsZW1lbnRgIGFuZCBgdEF0dHJzYCAoZGVzY3JpYmVkIGluIHRoZSBgY29tcGlsZWAgZnVuY3Rpb24gYXBpIGJlbG93KSBhbmQKICAgKiByZXR1cm5zIGEgc3RyaW5nIHZhbHVlIHJlcHJlc2VudGluZyB0aGUgdGVtcGxhdGUuCiAgICoKICAgKgogICAqICMjIyMgYHRlbXBsYXRlVXJsYAogICAqIFNhbWUgYXMgYHRlbXBsYXRlYCBidXQgdGhlIHRlbXBsYXRlIGlzIGxvYWRlZCBmcm9tIHRoZSBzcGVjaWZpZWQgVVJMLiBCZWNhdXNlCiAgICogdGhlIHRlbXBsYXRlIGxvYWRpbmcgaXMgYXN5bmNocm9ub3VzIHRoZSBjb21waWxhdGlvbi9saW5raW5nIGlzIHN1c3BlbmRlZCB1bnRpbCB0aGUgdGVtcGxhdGUKICAgKiBpcyBsb2FkZWQuCiAgICoKICAgKiBZb3UgY2FuIHNwZWNpZnkgYHRlbXBsYXRlVXJsYCBhcyBhIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIFVSTCBvciBhcyBhIGZ1bmN0aW9uIHdoaWNoIHRha2VzIHR3bwogICAqIGFyZ3VtZW50cyBgdEVsZW1lbnRgIGFuZCBgdEF0dHJzYCAoZGVzY3JpYmVkIGluIHRoZSBgY29tcGlsZWAgZnVuY3Rpb24gYXBpIGJlbG93KSBhbmQgcmV0dXJucwogICAqIGEgc3RyaW5nIHZhbHVlIHJlcHJlc2VudGluZyB0aGUgdXJsLiAgSW4gZWl0aGVyIGNhc2UsIHRoZSB0ZW1wbGF0ZSBVUkwgaXMgcGFzc2VkIHRocm91Z2gge0BsaW5rCiAgICAqIGFwaS9uZy4kc2NlI2dldFRydXN0ZWRSZXNvdXJjZVVybCAkc2NlLmdldFRydXN0ZWRSZXNvdXJjZVVybH0uCiAgICoKICAgKgogICAqICMjIyMgYHJlcGxhY2VgIChbKkRFUFJFQ0FURUQqIV0sIHdpbGwgYmUgcmVtb3ZlZCBpbiBuZXh0IG1ham9yIHJlbGVhc2UpCiAgICogc3BlY2lmeSB3aGVyZSB0aGUgdGVtcGxhdGUgc2hvdWxkIGJlIGluc2VydGVkLiBEZWZhdWx0cyB0byBgZmFsc2VgLgogICAqCiAgICogKiBgdHJ1ZWAgLSB0aGUgdGVtcGxhdGUgd2lsbCByZXBsYWNlIHRoZSBjdXJyZW50IGVsZW1lbnQuCiAgICogKiBgZmFsc2VgIC0gdGhlIHRlbXBsYXRlIHdpbGwgcmVwbGFjZSB0aGUgY29udGVudHMgb2YgdGhlIGN1cnJlbnQgZWxlbWVudC4KICAgKgogICAqCiAgICogIyMjIyBgdHJhbnNjbHVkZWAKICAgKiBjb21waWxlIHRoZSBjb250ZW50IG9mIHRoZSBlbGVtZW50IGFuZCBtYWtlIGl0IGF2YWlsYWJsZSB0byB0aGUgZGlyZWN0aXZlLgogICAqIFR5cGljYWxseSB1c2VkIHdpdGgge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1RyYW5zY2x1ZGUKICogbmdUcmFuc2NsdWRlfS4gVGhlIGFkdmFudGFnZSBvZiB0cmFuc2NsdXNpb24gaXMgdGhhdCB0aGUgbGlua2luZyBmdW5jdGlvbiByZWNlaXZlcyBhCiAgICogdHJhbnNjbHVzaW9uIGZ1bmN0aW9uIHdoaWNoIGlzIHByZS1ib3VuZCB0byB0aGUgY29ycmVjdCBzY29wZS4gSW4gYSB0eXBpY2FsIHNldHVwIHRoZSB3aWRnZXQKICAgKiBjcmVhdGVzIGFuIGBpc29sYXRlYCBzY29wZSwgYnV0IHRoZSB0cmFuc2NsdXNpb24gaXMgbm90IGEgY2hpbGQsIGJ1dCBhIHNpYmxpbmcgb2YgdGhlIGBpc29sYXRlYAogICAqIHNjb3BlLiBUaGlzIG1ha2VzIGl0IHBvc3NpYmxlIGZvciB0aGUgd2lkZ2V0IHRvIGhhdmUgcHJpdmF0ZSBzdGF0ZSwgYW5kIHRoZSB0cmFuc2NsdXNpb24gdG8KICAgKiBiZSBib3VuZCB0byB0aGUgcGFyZW50IChwcmUtYGlzb2xhdGVgKSBzY29wZS4KICAgKgogICAqICogYHRydWVgIC0gdHJhbnNjbHVkZSB0aGUgY29udGVudCBvZiB0aGUgZGlyZWN0aXZlLgogICAqICogYCdlbGVtZW50J2AgLSB0cmFuc2NsdWRlIHRoZSB3aG9sZSBlbGVtZW50IGluY2x1ZGluZyBhbnkgZGlyZWN0aXZlcyBkZWZpbmVkIGF0IGxvd2VyIHByaW9yaXR5LgogICAqCiAgICoKICAgKiAjIyMjIGBjb21waWxlYAogICAqCiAgICogYGBganMKICAgKiAgIGZ1bmN0aW9uIGNvbXBpbGUodEVsZW1lbnQsIHRBdHRycywgdHJhbnNjbHVkZSkgeyAuLi4gfQogICAqIGBgYAogICAqCiAgICogVGhlIGNvbXBpbGUgZnVuY3Rpb24gZGVhbHMgd2l0aCB0cmFuc2Zvcm1pbmcgdGhlIHRlbXBsYXRlIERPTS4gU2luY2UgbW9zdCBkaXJlY3RpdmVzIGRvIG5vdCBkbwogICAqIHRlbXBsYXRlIHRyYW5zZm9ybWF0aW9uLCBpdCBpcyBub3QgdXNlZCBvZnRlbi4gVGhlIGNvbXBpbGUgZnVuY3Rpb24gdGFrZXMgdGhlIGZvbGxvd2luZyBhcmd1bWVudHM6CiAgICoKICAgKiAgICogYHRFbGVtZW50YCAtIHRlbXBsYXRlIGVsZW1lbnQgLSBUaGUgZWxlbWVudCB3aGVyZSB0aGUgZGlyZWN0aXZlIGhhcyBiZWVuIGRlY2xhcmVkLiBJdCBpcwogICAqICAgICBzYWZlIHRvIGRvIHRlbXBsYXRlIHRyYW5zZm9ybWF0aW9uIG9uIHRoZSBlbGVtZW50IGFuZCBjaGlsZCBlbGVtZW50cyBvbmx5LgogICAqCiAgICogICAqIGB0QXR0cnNgIC0gdGVtcGxhdGUgYXR0cmlidXRlcyAtIE5vcm1hbGl6ZWQgbGlzdCBvZiBhdHRyaWJ1dGVzIGRlY2xhcmVkIG9uIHRoaXMgZWxlbWVudCBzaGFyZWQKICAgKiAgICAgYmV0d2VlbiBhbGwgZGlyZWN0aXZlIGNvbXBpbGUgZnVuY3Rpb25zLgogICAqCiAgICogICAqIGB0cmFuc2NsdWRlYCAtICBbKkRFUFJFQ0FURUQqIV0gQSB0cmFuc2NsdWRlIGxpbmtpbmcgZnVuY3Rpb246IGBmdW5jdGlvbihzY29wZSwgY2xvbmVMaW5raW5nRm4pYAogICAqCiAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAgICogKipOb3RlOioqIFRoZSB0ZW1wbGF0ZSBpbnN0YW5jZSBhbmQgdGhlIGxpbmsgaW5zdGFuY2UgbWF5IGJlIGRpZmZlcmVudCBvYmplY3RzIGlmIHRoZSB0ZW1wbGF0ZSBoYXMKICAgKiBiZWVuIGNsb25lZC4gRm9yIHRoaXMgcmVhc29uIGl0IGlzICoqbm90Kiogc2FmZSB0byBkbyBhbnl0aGluZyBvdGhlciB0aGFuIERPTSB0cmFuc2Zvcm1hdGlvbnMgdGhhdAogICAqIGFwcGx5IHRvIGFsbCBjbG9uZWQgRE9NIG5vZGVzIHdpdGhpbiB0aGUgY29tcGlsZSBmdW5jdGlvbi4gU3BlY2lmaWNhbGx5LCBET00gbGlzdGVuZXIgcmVnaXN0cmF0aW9uCiAgICogc2hvdWxkIGJlIGRvbmUgaW4gYSBsaW5raW5nIGZ1bmN0aW9uIHJhdGhlciB0aGFuIGluIGEgY29tcGlsZSBmdW5jdGlvbi4KICAgKiA8L2Rpdj4KCiAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAgICogKipOb3RlOioqIFRoZSBjb21waWxlIGZ1bmN0aW9uIGNhbm5vdCBoYW5kbGUgZGlyZWN0aXZlcyB0aGF0IHJlY3Vyc2l2ZWx5IHVzZSB0aGVtc2VsdmVzIGluIHRoZWlyCiAgICogb3duIHRlbXBsYXRlcyBvciBjb21waWxlIGZ1bmN0aW9ucy4gQ29tcGlsaW5nIHRoZXNlIGRpcmVjdGl2ZXMgcmVzdWx0cyBpbiBhbiBpbmZpbml0ZSBsb29wIGFuZCBhCiAgICogc3RhY2sgb3ZlcmZsb3cgZXJyb3JzLgogICAqCiAgICogVGhpcyBjYW4gYmUgYXZvaWRlZCBieSBtYW51YWxseSB1c2luZyAkY29tcGlsZSBpbiB0aGUgcG9zdExpbmsgZnVuY3Rpb24gdG8gaW1wZXJhdGl2ZWx5IGNvbXBpbGUKICAgKiBhIGRpcmVjdGl2ZSdzIHRlbXBsYXRlIGluc3RlYWQgb2YgcmVseWluZyBvbiBhdXRvbWF0aWMgdGVtcGxhdGUgY29tcGlsYXRpb24gdmlhIGB0ZW1wbGF0ZWAgb3IKICAgKiBgdGVtcGxhdGVVcmxgIGRlY2xhcmF0aW9uIG9yIG1hbnVhbCBjb21waWxhdGlvbiBpbnNpZGUgdGhlIGNvbXBpbGUgZnVuY3Rpb24uCiAgICogPC9kaXY+CiAgICoKICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1lcnJvciI+CiAgICogKipOb3RlOioqIFRoZSBgdHJhbnNjbHVkZWAgZnVuY3Rpb24gdGhhdCBpcyBwYXNzZWQgdG8gdGhlIGNvbXBpbGUgZnVuY3Rpb24gaXMgZGVwcmVjYXRlZCwgYXMgaXQKICAgKiAgIGUuZy4gZG9lcyBub3Qga25vdyBhYm91dCB0aGUgcmlnaHQgb3V0ZXIgc2NvcGUuIFBsZWFzZSB1c2UgdGhlIHRyYW5zY2x1ZGUgZnVuY3Rpb24gdGhhdCBpcyBwYXNzZWQKICAgKiAgIHRvIHRoZSBsaW5rIGZ1bmN0aW9uIGluc3RlYWQuCiAgICogPC9kaXY+CgogICAqIEEgY29tcGlsZSBmdW5jdGlvbiBjYW4gaGF2ZSBhIHJldHVybiB2YWx1ZSB3aGljaCBjYW4gYmUgZWl0aGVyIGEgZnVuY3Rpb24gb3IgYW4gb2JqZWN0LgogICAqCiAgICogKiByZXR1cm5pbmcgYSAocG9zdC1saW5rKSBmdW5jdGlvbiAtIGlzIGVxdWl2YWxlbnQgdG8gcmVnaXN0ZXJpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gdmlhIHRoZQogICAqICAgYGxpbmtgIHByb3BlcnR5IG9mIHRoZSBjb25maWcgb2JqZWN0IHdoZW4gdGhlIGNvbXBpbGUgZnVuY3Rpb24gaXMgZW1wdHkuCiAgICoKICAgKiAqIHJldHVybmluZyBhbiBvYmplY3Qgd2l0aCBmdW5jdGlvbihzKSByZWdpc3RlcmVkIHZpYSBgcHJlYCBhbmQgYHBvc3RgIHByb3BlcnRpZXMgLSBhbGxvd3MgeW91IHRvCiAgICogICBjb250cm9sIHdoZW4gYSBsaW5raW5nIGZ1bmN0aW9uIHNob3VsZCBiZSBjYWxsZWQgZHVyaW5nIHRoZSBsaW5raW5nIHBoYXNlLiBTZWUgaW5mbyBhYm91dAogICAqICAgcHJlLWxpbmtpbmcgYW5kIHBvc3QtbGlua2luZyBmdW5jdGlvbnMgYmVsb3cuCiAgICoKICAgKgogICAqICMjIyMgYGxpbmtgCiAgICogVGhpcyBwcm9wZXJ0eSBpcyB1c2VkIG9ubHkgaWYgdGhlIGBjb21waWxlYCBwcm9wZXJ0eSBpcyBub3QgZGVmaW5lZC4KICAgKgogICAqIGBgYGpzCiAgICogICBmdW5jdGlvbiBsaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzLCBjb250cm9sbGVyLCB0cmFuc2NsdWRlRm4pIHsgLi4uIH0KICAgKiBgYGAKICAgKgogICAqIFRoZSBsaW5rIGZ1bmN0aW9uIGlzIHJlc3BvbnNpYmxlIGZvciByZWdpc3RlcmluZyBET00gbGlzdGVuZXJzIGFzIHdlbGwgYXMgdXBkYXRpbmcgdGhlIERPTS4gSXQgaXMKICAgKiBleGVjdXRlZCBhZnRlciB0aGUgdGVtcGxhdGUgaGFzIGJlZW4gY2xvbmVkLiBUaGlzIGlzIHdoZXJlIG1vc3Qgb2YgdGhlIGRpcmVjdGl2ZSBsb2dpYyB3aWxsIGJlCiAgICogcHV0LgogICAqCiAgICogICAqIGBzY29wZWAgLSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBTY29wZX0gLSBUaGUgc2NvcGUgdG8gYmUgdXNlZCBieSB0aGUKICAgKiAgICAgZGlyZWN0aXZlIGZvciByZWdpc3RlcmluZyB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlc30uCiAgICoKICAgKiAgICogYGlFbGVtZW50YCAtIGluc3RhbmNlIGVsZW1lbnQgLSBUaGUgZWxlbWVudCB3aGVyZSB0aGUgZGlyZWN0aXZlIGlzIHRvIGJlIHVzZWQuIEl0IGlzIHNhZmUgdG8KICAgKiAgICAgbWFuaXB1bGF0ZSB0aGUgY2hpbGRyZW4gb2YgdGhlIGVsZW1lbnQgb25seSBpbiBgcG9zdExpbmtgIGZ1bmN0aW9uIHNpbmNlIHRoZSBjaGlsZHJlbiBoYXZlCiAgICogICAgIGFscmVhZHkgYmVlbiBsaW5rZWQuCiAgICoKICAgKiAgICogYGlBdHRyc2AgLSBpbnN0YW5jZSBhdHRyaWJ1dGVzIC0gTm9ybWFsaXplZCBsaXN0IG9mIGF0dHJpYnV0ZXMgZGVjbGFyZWQgb24gdGhpcyBlbGVtZW50IHNoYXJlZAogICAqICAgICBiZXR3ZWVuIGFsbCBkaXJlY3RpdmUgbGlua2luZyBmdW5jdGlvbnMuCiAgICoKICAgKiAgICogYGNvbnRyb2xsZXJgIC0gYSBjb250cm9sbGVyIGluc3RhbmNlIC0gQSBjb250cm9sbGVyIGluc3RhbmNlIGlmIGF0IGxlYXN0IG9uZSBkaXJlY3RpdmUgb24gdGhlCiAgICogICAgIGVsZW1lbnQgZGVmaW5lcyBhIGNvbnRyb2xsZXIuIFRoZSBjb250cm9sbGVyIGlzIHNoYXJlZCBhbW9uZyBhbGwgdGhlIGRpcmVjdGl2ZXMsIHdoaWNoIGFsbG93cwogICAqICAgICB0aGUgZGlyZWN0aXZlcyB0byB1c2UgdGhlIGNvbnRyb2xsZXJzIGFzIGEgY29tbXVuaWNhdGlvbiBjaGFubmVsLgogICAqCiAgICogICAqIGB0cmFuc2NsdWRlRm5gIC0gQSB0cmFuc2NsdWRlIGxpbmtpbmcgZnVuY3Rpb24gcHJlLWJvdW5kIHRvIHRoZSBjb3JyZWN0IHRyYW5zY2x1c2lvbiBzY29wZS4KICAgKiAgICAgVGhlIHNjb3BlIGNhbiBiZSBvdmVycmlkZGVuIGJ5IGFuIG9wdGlvbmFsIGZpcnN0IGFyZ3VtZW50LiBUaGlzIGlzIHRoZSBzYW1lIGFzIHRoZSBgJHRyYW5zY2x1ZGVgCiAgICogICAgIHBhcmFtZXRlciBvZiBkaXJlY3RpdmUgY29udHJvbGxlcnMuCiAgICogICAgIGBmdW5jdGlvbihbc2NvcGVdLCBjbG9uZUxpbmtpbmdGbilgLgogICAqCiAgICoKICAgKiAjIyMjIFByZS1saW5raW5nIGZ1bmN0aW9uCiAgICoKICAgKiBFeGVjdXRlZCBiZWZvcmUgdGhlIGNoaWxkIGVsZW1lbnRzIGFyZSBsaW5rZWQuIE5vdCBzYWZlIHRvIGRvIERPTSB0cmFuc2Zvcm1hdGlvbiBzaW5jZSB0aGUKICAgKiBjb21waWxlciBsaW5raW5nIGZ1bmN0aW9uIHdpbGwgZmFpbCB0byBsb2NhdGUgdGhlIGNvcnJlY3QgZWxlbWVudHMgZm9yIGxpbmtpbmcuCiAgICoKICAgKiAjIyMjIFBvc3QtbGlua2luZyBmdW5jdGlvbgogICAqCiAgICogRXhlY3V0ZWQgYWZ0ZXIgdGhlIGNoaWxkIGVsZW1lbnRzIGFyZSBsaW5rZWQuIEl0IGlzIHNhZmUgdG8gZG8gRE9NIHRyYW5zZm9ybWF0aW9uIGluIHRoZSBwb3N0LWxpbmtpbmcgZnVuY3Rpb24uCiAgICoKICAgKiA8YSBuYW1lPSJBdHRyaWJ1dGVzIj48L2E+CiAgICogIyMjIEF0dHJpYnV0ZXMKICAgKgogICAqIFRoZSB7QGxpbmsgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMgQXR0cmlidXRlc30gb2JqZWN0IC0gcGFzc2VkIGFzIGEgcGFyYW1ldGVyIGluIHRoZQogICAqIGBsaW5rKClgIG9yIGBjb21waWxlKClgIGZ1bmN0aW9ucy4gSXQgaGFzIGEgdmFyaWV0eSBvZiB1c2VzLgogICAqCiAgICogYWNjZXNzaW5nICpOb3JtYWxpemVkIGF0dHJpYnV0ZSBuYW1lczoqCiAgICogRGlyZWN0aXZlcyBsaWtlICduZ0JpbmQnIGNhbiBiZSBleHByZXNzZWQgaW4gbWFueSB3YXlzOiAnbmc6YmluZCcsIGBkYXRhLW5nLWJpbmRgLCBvciAneC1uZy1iaW5kJy4KICAgKiB0aGUgYXR0cmlidXRlcyBvYmplY3QgYWxsb3dzIGZvciBub3JtYWxpemVkIGFjY2VzcyB0bwogICAqICAgdGhlIGF0dHJpYnV0ZXMuCiAgICoKICAgKiAqICpEaXJlY3RpdmUgaW50ZXItY29tbXVuaWNhdGlvbjoqIEFsbCBkaXJlY3RpdmVzIHNoYXJlIHRoZSBzYW1lIGluc3RhbmNlIG9mIHRoZSBhdHRyaWJ1dGVzCiAgICogICBvYmplY3Qgd2hpY2ggYWxsb3dzIHRoZSBkaXJlY3RpdmVzIHRvIHVzZSB0aGUgYXR0cmlidXRlcyBvYmplY3QgYXMgaW50ZXIgZGlyZWN0aXZlCiAgICogICBjb21tdW5pY2F0aW9uLgogICAqCiAgICogKiAqU3VwcG9ydHMgaW50ZXJwb2xhdGlvbjoqIEludGVycG9sYXRpb24gYXR0cmlidXRlcyBhcmUgYXNzaWduZWQgdG8gdGhlIGF0dHJpYnV0ZSBvYmplY3QKICAgKiAgIGFsbG93aW5nIG90aGVyIGRpcmVjdGl2ZXMgdG8gcmVhZCB0aGUgaW50ZXJwb2xhdGVkIHZhbHVlLgogICAqCiAgICogKiAqT2JzZXJ2aW5nIGludGVycG9sYXRlZCBhdHRyaWJ1dGVzOiogVXNlIGAkb2JzZXJ2ZWAgdG8gb2JzZXJ2ZSB0aGUgdmFsdWUgY2hhbmdlcyBvZiBhdHRyaWJ1dGVzCiAgICogICB0aGF0IGNvbnRhaW4gaW50ZXJwb2xhdGlvbiAoZS5nLiBgc3JjPSJ7e2Jhcn19ImApLiBOb3Qgb25seSBpcyB0aGlzIHZlcnkgZWZmaWNpZW50IGJ1dCBpdCdzIGFsc28KICAgKiAgIHRoZSBvbmx5IHdheSB0byBlYXNpbHkgZ2V0IHRoZSBhY3R1YWwgdmFsdWUgYmVjYXVzZSBkdXJpbmcgdGhlIGxpbmtpbmcgcGhhc2UgdGhlIGludGVycG9sYXRpb24KICAgKiAgIGhhc24ndCBiZWVuIGV2YWx1YXRlZCB5ZXQgYW5kIHNvIHRoZSB2YWx1ZSBpcyBhdCB0aGlzIHRpbWUgc2V0IHRvIGB1bmRlZmluZWRgLgogICAqCiAgICogYGBganMKICAgKiBmdW5jdGlvbiBsaW5raW5nRm4oc2NvcGUsIGVsbSwgYXR0cnMsIGN0cmwpIHsKICogICAvLyBnZXQgdGhlIGF0dHJpYnV0ZSB2YWx1ZQogKiAgIGNvbnNvbGUubG9nKGF0dHJzLm5nTW9kZWwpOwogKgogKiAgIC8vIGNoYW5nZSB0aGUgYXR0cmlidXRlCiAqICAgYXR0cnMuJHNldCgnbmdNb2RlbCcsICduZXcgdmFsdWUnKTsKICoKICogICAvLyBvYnNlcnZlIGNoYW5nZXMgdG8gaW50ZXJwb2xhdGVkIGF0dHJpYnV0ZQogKiAgIGF0dHJzLiRvYnNlcnZlKCduZ01vZGVsJywgZnVuY3Rpb24odmFsdWUpIHsKICogICAgIGNvbnNvbGUubG9nKCduZ01vZGVsIGhhcyBjaGFuZ2VkIHZhbHVlIHRvICcgKyB2YWx1ZSk7CiAqICAgfSk7CiAqIH0KICAgKiBgYGAKICAgKgogICAqIEJlbG93IGlzIGFuIGV4YW1wbGUgdXNpbmcgYCRjb21waWxlUHJvdmlkZXJgLgogICAqCiAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAgICogKipOb3RlKio6IFR5cGljYWxseSBkaXJlY3RpdmVzIGFyZSByZWdpc3RlcmVkIHdpdGggYG1vZHVsZS5kaXJlY3RpdmVgLiBUaGUgZXhhbXBsZSBiZWxvdyBpcwogICAqIHRvIGlsbHVzdHJhdGUgaG93IGAkY29tcGlsZWAgd29ya3MuCiAgICogPC9kaXY+CiAgICoKICAgPGV4YW1wbGUgbW9kdWxlPSJjb21waWxlIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGFuZ3VsYXIubW9kdWxlKCdjb21waWxlJywgW10sIGZ1bmN0aW9uKCRjb21waWxlUHJvdmlkZXIpIHsKICAgICAgICAvLyBjb25maWd1cmUgbmV3ICdjb21waWxlJyBkaXJlY3RpdmUgYnkgcGFzc2luZyBhIGRpcmVjdGl2ZQogICAgICAgIC8vIGZhY3RvcnkgZnVuY3Rpb24uIFRoZSBmYWN0b3J5IGZ1bmN0aW9uIGluamVjdHMgdGhlICckY29tcGlsZScKICAgICAgICAkY29tcGlsZVByb3ZpZGVyLmRpcmVjdGl2ZSgnY29tcGlsZScsIGZ1bmN0aW9uKCRjb21waWxlKSB7CiAgICAgICAgICAvLyBkaXJlY3RpdmUgZmFjdG9yeSBjcmVhdGVzIGEgbGluayBmdW5jdGlvbgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goCiAgICAgICAgICAgICAgZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgICAgICAgICAvLyB3YXRjaCB0aGUgJ2NvbXBpbGUnIGV4cHJlc3Npb24gZm9yIGNoYW5nZXMKICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS4kZXZhbChhdHRycy5jb21waWxlKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAvLyB3aGVuIHRoZSAnY29tcGlsZScgZXhwcmVzc2lvbiBjaGFuZ2VzCiAgICAgICAgICAgICAgICAvLyBhc3NpZ24gaXQgaW50byB0aGUgY3VycmVudCBET00KICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCh2YWx1ZSk7CgogICAgICAgICAgICAgICAgLy8gY29tcGlsZSB0aGUgbmV3IERPTSBhbmQgbGluayBpdCB0byB0aGUgY3VycmVudAogICAgICAgICAgICAgICAgLy8gc2NvcGUuCiAgICAgICAgICAgICAgICAvLyBOT1RFOiB3ZSBvbmx5IGNvbXBpbGUgLmNoaWxkTm9kZXMgc28gdGhhdAogICAgICAgICAgICAgICAgLy8gd2UgZG9uJ3QgZ2V0IGludG8gaW5maW5pdGUgbG9vcCBjb21waWxpbmcgb3Vyc2VsdmVzCiAgICAgICAgICAgICAgICAkY29tcGlsZShlbGVtZW50LmNvbnRlbnRzKCkpKHNjb3BlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICk7CiAgICAgICAgICB9OwogICAgICAgIH0pCiAgICAgIH0pOwoKICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAkc2NvcGUubmFtZSA9ICdBbmd1bGFyJzsKICAgICAgICAkc2NvcGUuaHRtbCA9ICdIZWxsbyB7e25hbWV9fSc7CiAgICAgIH0KICAgPC9zY3JpcHQ+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIDxpbnB1dCBuZy1tb2RlbD0ibmFtZSI+IDxicj4KICAgPHRleHRhcmVhIG5nLW1vZGVsPSJodG1sIj48L3RleHRhcmVhPiA8YnI+CiAgIDxkaXYgY29tcGlsZT0iaHRtbCI+PC9kaXY+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGF1dG8gY29tcGlsZScsIGZ1bmN0aW9uKCkgewogICAgICAgdmFyIHRleHRhcmVhID0gJCgndGV4dGFyZWEnKTsKICAgICAgIHZhciBvdXRwdXQgPSAkKCdkaXZbY29tcGlsZV0nKTsKICAgICAgIC8vIFRoZSBpbml0aWFsIHN0YXRlIHJlYWRzICdIZWxsbyBBbmd1bGFyJy4KICAgICAgIGV4cGVjdChvdXRwdXQuZ2V0VGV4dCgpKS50b0JlKCdIZWxsbyBBbmd1bGFyJyk7CiAgICAgICB0ZXh0YXJlYS5jbGVhcigpOwogICAgICAgdGV4dGFyZWEuc2VuZEtleXMoJ3t7bmFtZX19IScpOwogICAgICAgZXhwZWN0KG91dHB1dC5nZXRUZXh0KCkpLnRvQmUoJ0FuZ3VsYXIhJyk7CiAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgoKICAgKgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8RE9NRWxlbWVudH0gZWxlbWVudCBFbGVtZW50IG9yIEhUTUwgc3RyaW5nIHRvIGNvbXBpbGUgaW50byBhIHRlbXBsYXRlIGZ1bmN0aW9uLgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZSwgY2xvbmVBdHRhY2hGbj0pfSB0cmFuc2NsdWRlIGZ1bmN0aW9uIGF2YWlsYWJsZSB0byBkaXJlY3RpdmVzLgogICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhQcmlvcml0eSBvbmx5IGFwcGx5IGRpcmVjdGl2ZXMgbG93ZXIgdGhhbiBnaXZlbiBwcmlvcml0eSAoT25seSBlZmZlY3RzIHRoZQogICAqICAgICAgICAgICAgICAgICByb290IGVsZW1lbnQocyksIG5vdCB0aGVpciBjaGlsZHJlbikKICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oc2NvcGUsIGNsb25lQXR0YWNoRm49KX0gYSBsaW5rIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gYmluZCB0ZW1wbGF0ZQogICAqIChhIERPTSBlbGVtZW50L3RyZWUpIHRvIGEgc2NvcGUuIFdoZXJlOgogICAqCiAgICogICogYHNjb3BlYCAtIEEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgU2NvcGV9IHRvIGJpbmQgdG8uCiAgICogICogYGNsb25lQXR0YWNoRm5gIC0gSWYgYGNsb25lQXR0YWNoRm5gIGlzIHByb3ZpZGVkLCB0aGVuIHRoZSBsaW5rIGZ1bmN0aW9uIHdpbGwgY2xvbmUgdGhlCiAgICogIGB0ZW1wbGF0ZWAgYW5kIGNhbGwgdGhlIGBjbG9uZUF0dGFjaEZuYCBmdW5jdGlvbiBhbGxvd2luZyB0aGUgY2FsbGVyIHRvIGF0dGFjaCB0aGUKICAgKiAgY2xvbmVkIGVsZW1lbnRzIHRvIHRoZSBET00gZG9jdW1lbnQgYXQgdGhlIGFwcHJvcHJpYXRlIHBsYWNlLiBUaGUgYGNsb25lQXR0YWNoRm5gIGlzCiAgICogIGNhbGxlZCBhczogPGJyPiBgY2xvbmVBdHRhY2hGbihjbG9uZWRFbGVtZW50LCBzY29wZSlgIHdoZXJlOgogICAqCiAgICogICAgICAqIGBjbG9uZWRFbGVtZW50YCAtIGlzIGEgY2xvbmUgb2YgdGhlIG9yaWdpbmFsIGBlbGVtZW50YCBwYXNzZWQgaW50byB0aGUgY29tcGlsZXIuCiAgICogICAgICAqIGBzY29wZWAgLSBpcyB0aGUgY3VycmVudCBzY29wZSB3aXRoIHdoaWNoIHRoZSBsaW5raW5nIGZ1bmN0aW9uIGlzIHdvcmtpbmcgd2l0aC4KICAgKgogICAqIENhbGxpbmcgdGhlIGxpbmtpbmcgZnVuY3Rpb24gcmV0dXJucyB0aGUgZWxlbWVudCBvZiB0aGUgdGVtcGxhdGUuIEl0IGlzIGVpdGhlciB0aGUgb3JpZ2luYWwKICAgKiBlbGVtZW50IHBhc3NlZCBpbiwgb3IgdGhlIGNsb25lIG9mIHRoZSBlbGVtZW50IGlmIHRoZSBgY2xvbmVBdHRhY2hGbmAgaXMgcHJvdmlkZWQuCiAgICoKICAgKiBBZnRlciBsaW5raW5nIHRoZSB2aWV3IGlzIG5vdCB1cGRhdGVkIHVudGlsIGFmdGVyIGEgY2FsbCB0byAkZGlnZXN0IHdoaWNoIHR5cGljYWxseSBpcyBkb25lIGJ5CiAgICogQW5ndWxhciBhdXRvbWF0aWNhbGx5LgogICAqCiAgICogSWYgeW91IG5lZWQgYWNjZXNzIHRvIHRoZSBib3VuZCB2aWV3LCB0aGVyZSBhcmUgdHdvIHdheXMgdG8gZG8gaXQ6CiAgICoKICAgKiAtIElmIHlvdSBhcmUgbm90IGFza2luZyB0aGUgbGlua2luZyBmdW5jdGlvbiB0byBjbG9uZSB0aGUgdGVtcGxhdGUsIGNyZWF0ZSB0aGUgRE9NIGVsZW1lbnQocykKICAgKiAgIGJlZm9yZSB5b3Ugc2VuZCB0aGVtIHRvIHRoZSBjb21waWxlciBhbmQga2VlcCB0aGlzIHJlZmVyZW5jZSBhcm91bmQuCiAgICogICBgYGBqcwogICAqICAgICB2YXIgZWxlbWVudCA9ICRjb21waWxlKCc8cD57e3RvdGFsfX08L3A+Jykoc2NvcGUpOwogICAqICAgYGBgCiAgICoKICAgKiAtIGlmIG9uIHRoZSBvdGhlciBoYW5kLCB5b3UgbmVlZCB0aGUgZWxlbWVudCB0byBiZSBjbG9uZWQsIHRoZSB2aWV3IHJlZmVyZW5jZSBmcm9tIHRoZSBvcmlnaW5hbAogICAqICAgZXhhbXBsZSB3b3VsZCBub3QgcG9pbnQgdG8gdGhlIGNsb25lLCBidXQgcmF0aGVyIHRvIHRoZSBvcmlnaW5hbCB0ZW1wbGF0ZSB0aGF0IHdhcyBjbG9uZWQuIEluCiAgICogICB0aGlzIGNhc2UsIHlvdSBjYW4gYWNjZXNzIHRoZSBjbG9uZSB2aWEgdGhlIGNsb25lQXR0YWNoRm46CiAgICogICBgYGBqcwogICAqICAgICB2YXIgdGVtcGxhdGVFbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KCc8cD57e3RvdGFsfX08L3A+JyksCiAgICogICAgICAgICBzY29wZSA9IC4uLi47CiAgICoKICAgKiAgICAgdmFyIGNsb25lZEVsZW1lbnQgPSAkY29tcGlsZSh0ZW1wbGF0ZUVsZW1lbnQpKHNjb3BlLCBmdW5jdGlvbihjbG9uZWRFbGVtZW50LCBzY29wZSkgewogKiAgICAgICAvL2F0dGFjaCB0aGUgY2xvbmUgdG8gRE9NIGRvY3VtZW50IGF0IHRoZSByaWdodCBwbGFjZQogKiAgICAgfSk7CiAgICoKICAgKiAgICAgLy9ub3cgd2UgaGF2ZSByZWZlcmVuY2UgdG8gdGhlIGNsb25lZCBET00gdmlhIGBjbG9uZWRFbGVtZW50YAogICAqICAgYGBgCiAgICoKICAgKgogICAqIEZvciBpbmZvcm1hdGlvbiBvbiBob3cgdGhlIGNvbXBpbGVyIHdvcmtzLCBzZWUgdGhlCiAgICoge0BsaW5rIGd1aWRlL2NvbXBpbGVyIEFuZ3VsYXIgSFRNTCBDb21waWxlcn0gc2VjdGlvbiBvZiB0aGUgRGV2ZWxvcGVyIEd1aWRlLgogICAqLwoKICB2YXIgJGNvbXBpbGVNaW5FcnIgPSBtaW5FcnIoJyRjb21waWxlJyk7CgogIC8qKgogICAqIEBuZ2RvYyBwcm92aWRlcgogICAqIEBuYW1lICRjb21waWxlUHJvdmlkZXIKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICovCiAgJENvbXBpbGVQcm92aWRlci4kaW5qZWN0ID0gWyckcHJvdmlkZScsICckJHNhbml0aXplVXJpUHJvdmlkZXInXTsKICBmdW5jdGlvbiAkQ29tcGlsZVByb3ZpZGVyKCRwcm92aWRlLCAkJHNhbml0aXplVXJpUHJvdmlkZXIpIHsKICAgIHZhciBoYXNEaXJlY3RpdmVzID0ge30sCiAgICAgIFN1ZmZpeCA9ICdEaXJlY3RpdmUnLAogICAgICBDT01NRU5UX0RJUkVDVElWRV9SRUdFWFAgPSAvXlxzKmRpcmVjdGl2ZVw6XHMqKFtcZFx3X1wtXSspXHMrKC4qKSQvLAogICAgICBDTEFTU19ESVJFQ1RJVkVfUkVHRVhQID0gLygoW1xkXHdfXC1dKykoPzpcOihbXjtdKykpPzs/KS87CgogICAgLy8gUmVmOiBodHRwOi8vZGV2ZWxvcGVycy53aGF0d2cub3JnL3dlYmFwcGFwaXMuaHRtbCNldmVudC1oYW5kbGVyLWlkbC1hdHRyaWJ1dGVzCiAgICAvLyBUaGUgYXNzdW1wdGlvbiBpcyB0aGF0IGZ1dHVyZSBET00gZXZlbnQgYXR0cmlidXRlIG5hbWVzIHdpbGwgYmVnaW4gd2l0aAogICAgLy8gJ29uJyBhbmQgYmUgY29tcG9zZWQgb2Ygb25seSBFbmdsaXNoIGxldHRlcnMuCiAgICB2YXIgRVZFTlRfSEFORExFUl9BVFRSX1JFR0VYUCA9IC9eKG9uW2Etel0rfGZvcm1hY3Rpb24pJC87CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZQogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJlZ2lzdGVyIGEgbmV3IGRpcmVjdGl2ZSB3aXRoIHRoZSBjb21waWxlci4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R9IG5hbWUgTmFtZSBvZiB0aGUgZGlyZWN0aXZlIGluIGNhbWVsLWNhc2UgKGkuZS4gPGNvZGU+bmdCaW5kPC9jb2RlPiB3aGljaAogICAgICogICAgd2lsbCBtYXRjaCBhcyA8Y29kZT5uZy1iaW5kPC9jb2RlPiksIG9yIGFuIG9iamVjdCBtYXAgb2YgZGlyZWN0aXZlcyB3aGVyZSB0aGUga2V5cyBhcmUgdGhlCiAgICAgKiAgICBuYW1lcyBhbmQgdGhlIHZhbHVlcyBhcmUgdGhlIGZhY3Rvcmllcy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXl9IGRpcmVjdGl2ZUZhY3RvcnkgQW4gaW5qZWN0YWJsZSBkaXJlY3RpdmUgZmFjdG9yeSBmdW5jdGlvbi4gU2VlCiAgICAgKiAgICB7QGxpbmsgZ3VpZGUvZGlyZWN0aXZlfSBmb3IgbW9yZSBpbmZvLgogICAgICogQHJldHVybnMge25nLiRjb21waWxlUHJvdmlkZXJ9IFNlbGYgZm9yIGNoYWluaW5nLgogICAgICovCiAgICB0aGlzLmRpcmVjdGl2ZSA9IGZ1bmN0aW9uIHJlZ2lzdGVyRGlyZWN0aXZlKG5hbWUsIGRpcmVjdGl2ZUZhY3RvcnkpIHsKICAgICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkobmFtZSwgJ2RpcmVjdGl2ZScpOwogICAgICBpZiAoaXNTdHJpbmcobmFtZSkpIHsKICAgICAgICBhc3NlcnRBcmcoZGlyZWN0aXZlRmFjdG9yeSwgJ2RpcmVjdGl2ZUZhY3RvcnknKTsKICAgICAgICBpZiAoIWhhc0RpcmVjdGl2ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgIGhhc0RpcmVjdGl2ZXNbbmFtZV0gPSBbXTsKICAgICAgICAgICRwcm92aWRlLmZhY3RvcnkobmFtZSArIFN1ZmZpeCwgWyckaW5qZWN0b3InLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICAgICAgICBmdW5jdGlvbigkaW5qZWN0b3IsICRleGNlcHRpb25IYW5kbGVyKSB7CiAgICAgICAgICAgICAgdmFyIGRpcmVjdGl2ZXMgPSBbXTsKICAgICAgICAgICAgICBmb3JFYWNoKGhhc0RpcmVjdGl2ZXNbbmFtZV0sIGZ1bmN0aW9uKGRpcmVjdGl2ZUZhY3RvcnksIGluZGV4KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YXIgZGlyZWN0aXZlID0gJGluamVjdG9yLmludm9rZShkaXJlY3RpdmVGYWN0b3J5KTsKICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oZGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IHsgY29tcGlsZTogdmFsdWVGbihkaXJlY3RpdmUpIH07CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWRpcmVjdGl2ZS5jb21waWxlICYmIGRpcmVjdGl2ZS5saW5rKSB7CiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLmNvbXBpbGUgPSB2YWx1ZUZuKGRpcmVjdGl2ZS5saW5rKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucHJpb3JpdHkgPSBkaXJlY3RpdmUucHJpb3JpdHkgfHwgMDsKICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5uYW1lID0gZGlyZWN0aXZlLm5hbWUgfHwgbmFtZTsKICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZSB8fCAoZGlyZWN0aXZlLmNvbnRyb2xsZXIgJiYgZGlyZWN0aXZlLm5hbWUpOwogICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVzdHJpY3QgPSBkaXJlY3RpdmUucmVzdHJpY3QgfHwgJ0EnOwogICAgICAgICAgICAgICAgICBkaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmV0dXJuIGRpcmVjdGl2ZXM7CiAgICAgICAgICAgIH1dKTsKICAgICAgICB9CiAgICAgICAgaGFzRGlyZWN0aXZlc1tuYW1lXS5wdXNoKGRpcmVjdGl2ZUZhY3RvcnkpOwogICAgICB9IGVsc2UgewogICAgICAgIGZvckVhY2gobmFtZSwgcmV2ZXJzZVBhcmFtcyhyZWdpc3RlckRpcmVjdGl2ZSkpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkY29tcGlsZVByb3ZpZGVyI2FIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0CiAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0cmlldmVzIG9yIG92ZXJyaWRlcyB0aGUgZGVmYXVsdCByZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBpcyB1c2VkIGZvciB3aGl0ZWxpc3Rpbmcgb2Ygc2FmZQogICAgICogdXJscyBkdXJpbmcgYVtocmVmXSBzYW5pdGl6YXRpb24uCiAgICAgKgogICAgICogVGhlIHNhbml0aXphdGlvbiBpcyBhIHNlY3VyaXR5IG1lYXN1cmUgYWltZWQgYXQgcHJldmVudCBYU1MgYXR0YWNrcyB2aWEgaHRtbCBsaW5rcy4KICAgICAqCiAgICAgKiBBbnkgdXJsIGFib3V0IHRvIGJlIGFzc2lnbmVkIHRvIGFbaHJlZl0gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50bwogICAgICogYW4gYWJzb2x1dGUgdXJsLiBBZnRlcndhcmRzLCB0aGUgdXJsIGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgYGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0YAogICAgICogcmVndWxhciBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kLCB0aGUgb3JpZ2luYWwgdXJsIGlzIHdyaXR0ZW4gaW50byB0aGUgZG9tLiBPdGhlcndpc2UsCiAgICAgKiB0aGUgYWJzb2x1dGUgdXJsIGlzIHByZWZpeGVkIHdpdGggYCd1bnNhZmU6J2Agc3RyaW5nIGFuZCBvbmx5IHRoZW4gaXMgaXQgd3JpdHRlbiBpbnRvIHRoZSBET00uCiAgICAgKgogICAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAgICogQHJldHVybnMge1JlZ0V4cHxuZy4kY29tcGlsZVByb3ZpZGVyfSBDdXJyZW50IFJlZ0V4cCBpZiBjYWxsZWQgd2l0aG91dCB2YWx1ZSBvciBzZWxmIGZvcgogICAgICogICAgY2hhaW5pbmcgb3RoZXJ3aXNlLgogICAgICovCiAgICB0aGlzLmFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gZnVuY3Rpb24ocmVnZXhwKSB7CiAgICAgIGlmIChpc0RlZmluZWQocmVnZXhwKSkgewogICAgICAgICQkc2FuaXRpemVVcmlQcm92aWRlci5hSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdChyZWdleHApOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAkJHNhbml0aXplVXJpUHJvdmlkZXIuYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QoKTsKICAgICAgfQogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkY29tcGlsZVByb3ZpZGVyI2ltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdAogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgICAqIHVybHMgZHVyaW5nIGltZ1tzcmNdIHNhbml0aXphdGlvbi4KICAgICAqCiAgICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAgICoKICAgICAqIEFueSB1cmwgYWJvdXQgdG8gYmUgYXNzaWduZWQgdG8gaW1nW3NyY10gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50bwogICAgICogYW4gYWJzb2x1dGUgdXJsLiBBZnRlcndhcmRzLCB0aGUgdXJsIGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgYGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdGAKICAgICAqIHJlZ3VsYXIgZXhwcmVzc2lvbi4gSWYgYSBtYXRjaCBpcyBmb3VuZCwgdGhlIG9yaWdpbmFsIHVybCBpcyB3cml0dGVuIGludG8gdGhlIGRvbS4gT3RoZXJ3aXNlLAogICAgICogdGhlIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGlzIGl0IHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAgICoKICAgICAqIEBwYXJhbSB7UmVnRXhwPX0gcmVnZXhwIE5ldyByZWdleHAgdG8gd2hpdGVsaXN0IHVybHMgd2l0aC4KICAgICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgICAqICAgIGNoYWluaW5nIG90aGVyd2lzZS4KICAgICAqLwogICAgdGhpcy5pbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbihyZWdleHApIHsKICAgICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgICAgJCRzYW5pdGl6ZVVyaVByb3ZpZGVyLmltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdChyZWdleHApOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAkJHNhbml0aXplVXJpUHJvdmlkZXIuaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0KCk7CiAgICAgIH0KICAgIH07CgogICAgdGhpcy4kZ2V0ID0gWwogICAgICAnJGluamVjdG9yJywgJyRpbnRlcnBvbGF0ZScsICckZXhjZXB0aW9uSGFuZGxlcicsICckaHR0cCcsICckdGVtcGxhdGVDYWNoZScsICckcGFyc2UnLAogICAgICAnJGNvbnRyb2xsZXInLCAnJHJvb3RTY29wZScsICckZG9jdW1lbnQnLCAnJHNjZScsICckYW5pbWF0ZScsICckJHNhbml0aXplVXJpJywKICAgICAgZnVuY3Rpb24oJGluamVjdG9yLCAgICRpbnRlcnBvbGF0ZSwgICAkZXhjZXB0aW9uSGFuZGxlciwgICAkaHR0cCwgICAkdGVtcGxhdGVDYWNoZSwgICAkcGFyc2UsCiAgICAgICAgICAgICAgICRjb250cm9sbGVyLCAgICRyb290U2NvcGUsICAgJGRvY3VtZW50LCAgICRzY2UsICAgJGFuaW1hdGUsICAgJCRzYW5pdGl6ZVVyaSkgewoKICAgICAgICB2YXIgQXR0cmlidXRlcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIHRoaXMuJCRlbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgIHRoaXMuJGF0dHIgPSBhdHRyIHx8IHt9OwogICAgICAgIH07CgogICAgICAgIEF0dHJpYnV0ZXMucHJvdG90eXBlID0gewogICAgICAgICAgJG5vcm1hbGl6ZTogZGlyZWN0aXZlTm9ybWFsaXplLAoKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRhZGRDbGFzcwogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIEFkZHMgdGhlIENTUyBjbGFzcyB2YWx1ZSBzcGVjaWZpZWQgYnkgdGhlIGNsYXNzVmFsIHBhcmFtZXRlciB0byB0aGUgZWxlbWVudC4gSWYgYW5pbWF0aW9ucwogICAgICAgICAgICogYXJlIGVuYWJsZWQgdGhlbiBhbiBhbmltYXRpb24gd2lsbCBiZSB0cmlnZ2VyZWQgZm9yIHRoZSBjbGFzcyBhZGRpdGlvbi4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NWYWwgVGhlIGNsYXNzTmFtZSB2YWx1ZSB0aGF0IHdpbGwgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICAgICAqLwogICAgICAgICAgJGFkZENsYXNzIDogZnVuY3Rpb24oY2xhc3NWYWwpIHsKICAgICAgICAgICAgaWYoY2xhc3NWYWwgJiYgY2xhc3NWYWwubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICRhbmltYXRlLmFkZENsYXNzKHRoaXMuJCRlbGVtZW50LCBjbGFzc1ZhbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkcmVtb3ZlQ2xhc3MKICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBSZW1vdmVzIHRoZSBDU1MgY2xhc3MgdmFsdWUgc3BlY2lmaWVkIGJ5IHRoZSBjbGFzc1ZhbCBwYXJhbWV0ZXIgZnJvbSB0aGUgZWxlbWVudC4gSWYKICAgICAgICAgICAqIGFuaW1hdGlvbnMgYXJlIGVuYWJsZWQgdGhlbiBhbiBhbmltYXRpb24gd2lsbCBiZSB0cmlnZ2VyZWQgZm9yIHRoZSBjbGFzcyByZW1vdmFsLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc1ZhbCBUaGUgY2xhc3NOYW1lIHZhbHVlIHRoYXQgd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICAgICAqLwogICAgICAgICAgJHJlbW92ZUNsYXNzIDogZnVuY3Rpb24oY2xhc3NWYWwpIHsKICAgICAgICAgICAgaWYoY2xhc3NWYWwgJiYgY2xhc3NWYWwubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKHRoaXMuJCRlbGVtZW50LCBjbGFzc1ZhbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkdXBkYXRlQ2xhc3MKICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBBZGRzIGFuZCByZW1vdmVzIHRoZSBhcHByb3ByaWF0ZSBDU1MgY2xhc3MgdmFsdWVzIHRvIHRoZSBlbGVtZW50IGJhc2VkIG9uIHRoZSBkaWZmZXJlbmNlCiAgICAgICAgICAgKiBiZXR3ZWVuIHRoZSBuZXcgYW5kIG9sZCBDU1MgY2xhc3MgdmFsdWVzIChzcGVjaWZpZWQgYXMgbmV3Q2xhc3NlcyBhbmQgb2xkQ2xhc3NlcykuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld0NsYXNzZXMgVGhlIGN1cnJlbnQgQ1NTIGNsYXNzTmFtZSB2YWx1ZQogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG9sZENsYXNzZXMgVGhlIGZvcm1lciBDU1MgY2xhc3NOYW1lIHZhbHVlCiAgICAgICAgICAgKi8KICAgICAgICAgICR1cGRhdGVDbGFzcyA6IGZ1bmN0aW9uKG5ld0NsYXNzZXMsIG9sZENsYXNzZXMpIHsKICAgICAgICAgICAgdmFyIHRvQWRkID0gdG9rZW5EaWZmZXJlbmNlKG5ld0NsYXNzZXMsIG9sZENsYXNzZXMpOwogICAgICAgICAgICB2YXIgdG9SZW1vdmUgPSB0b2tlbkRpZmZlcmVuY2Uob2xkQ2xhc3NlcywgbmV3Q2xhc3Nlcyk7CgogICAgICAgICAgICBpZih0b0FkZC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcyh0aGlzLiQkZWxlbWVudCwgdG9SZW1vdmUpOwogICAgICAgICAgICB9IGVsc2UgaWYodG9SZW1vdmUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3ModGhpcy4kJGVsZW1lbnQsIHRvQWRkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAkYW5pbWF0ZS5zZXRDbGFzcyh0aGlzLiQkZWxlbWVudCwgdG9BZGQsIHRvUmVtb3ZlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIFNldCBhIG5vcm1hbGl6ZWQgYXR0cmlidXRlIG9uIHRoZSBlbGVtZW50IGluIGEgd2F5IHN1Y2ggdGhhdCBhbGwgZGlyZWN0aXZlcwogICAgICAgICAgICogY2FuIHNoYXJlIHRoZSBhdHRyaWJ1dGUuIFRoaXMgZnVuY3Rpb24gcHJvcGVybHkgaGFuZGxlcyBib29sZWFuIGF0dHJpYnV0ZXMuCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IE5vcm1hbGl6ZWQga2V5LiAoaWUgbmdBdHRyaWJ1dGUpCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ3xib29sZWFufSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2V0LiBJZiBgbnVsbGAgYXR0cmlidXRlIHdpbGwgYmUgZGVsZXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHdyaXRlQXR0ciBJZiBmYWxzZSwgZG9lcyBub3Qgd3JpdGUgdGhlIHZhbHVlIHRvIERPTSBlbGVtZW50IGF0dHJpYnV0ZS4KICAgICAgICAgICAqICAgICBEZWZhdWx0cyB0byB0cnVlLgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBhdHRyTmFtZSBPcHRpb25hbCBub25lIG5vcm1hbGl6ZWQgbmFtZS4gRGVmYXVsdHMgdG8ga2V5LgogICAgICAgICAgICovCiAgICAgICAgICAkc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlLCB3cml0ZUF0dHIsIGF0dHJOYW1lKSB7CiAgICAgICAgICAgIC8vIFRPRE86IGRlY2lkZSB3aGV0aGVyIG9yIG5vdCB0byB0aHJvdyBhbiBlcnJvciBpZiAiY2xhc3MiCiAgICAgICAgICAgIC8vaXMgc2V0IHRocm91Z2ggdGhpcyBmdW5jdGlvbiBzaW5jZSBpdCBtYXkgY2F1c2UgJHVwZGF0ZUNsYXNzIHRvCiAgICAgICAgICAgIC8vYmVjb21lIHVuc3RhYmxlLgoKICAgICAgICAgICAgdmFyIGJvb2xlYW5LZXkgPSBnZXRCb29sZWFuQXR0ck5hbWUodGhpcy4kJGVsZW1lbnRbMF0sIGtleSksCiAgICAgICAgICAgICAgbm9ybWFsaXplZFZhbCwKICAgICAgICAgICAgICBub2RlTmFtZTsKCiAgICAgICAgICAgIGlmIChib29sZWFuS2V5KSB7CiAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQucHJvcChrZXksIHZhbHVlKTsKICAgICAgICAgICAgICBhdHRyTmFtZSA9IGJvb2xlYW5LZXk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwoKICAgICAgICAgICAgLy8gdHJhbnNsYXRlIG5vcm1hbGl6ZWQga2V5IHRvIGFjdHVhbCBrZXkKICAgICAgICAgICAgaWYgKGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgdGhpcy4kYXR0cltrZXldID0gYXR0ck5hbWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXR0ck5hbWUgPSB0aGlzLiRhdHRyW2tleV07CiAgICAgICAgICAgICAgaWYgKCFhdHRyTmFtZSkgewogICAgICAgICAgICAgICAgdGhpcy4kYXR0cltrZXldID0gYXR0ck5hbWUgPSBzbmFrZV9jYXNlKGtleSwgJy0nKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5vZGVOYW1lID0gbm9kZU5hbWVfKHRoaXMuJCRlbGVtZW50KTsKCiAgICAgICAgICAgIC8vIHNhbml0aXplIGFbaHJlZl0gYW5kIGltZ1tzcmNdIHZhbHVlcwogICAgICAgICAgICBpZiAoKG5vZGVOYW1lID09PSAnQScgJiYga2V5ID09PSAnaHJlZicpIHx8CiAgICAgICAgICAgICAgKG5vZGVOYW1lID09PSAnSU1HJyAmJiBrZXkgPT09ICdzcmMnKSkgewogICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlID0gJCRzYW5pdGl6ZVVyaSh2YWx1ZSwga2V5ID09PSAnc3JjJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh3cml0ZUF0dHIgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LnJlbW92ZUF0dHIoYXR0ck5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5hdHRyKGF0dHJOYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBmaXJlIG9ic2VydmVycwogICAgICAgICAgICB2YXIgJCRvYnNlcnZlcnMgPSB0aGlzLiQkb2JzZXJ2ZXJzOwogICAgICAgICAgICAkJG9ic2VydmVycyAmJiBmb3JFYWNoKCQkb2JzZXJ2ZXJzW2tleV0sIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZuKHZhbHVlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkb2JzZXJ2ZQogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIE9ic2VydmVzIGFuIGludGVycG9sYXRlZCBhdHRyaWJ1dGUuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhlIG9ic2VydmVyIGZ1bmN0aW9uIHdpbGwgYmUgaW52b2tlZCBvbmNlIGR1cmluZyB0aGUgbmV4dCBgJGRpZ2VzdGAgZm9sbG93aW5nCiAgICAgICAgICAgKiBjb21waWxhdGlvbi4gVGhlIG9ic2VydmVyIGlzIHRoZW4gaW52b2tlZCB3aGVuZXZlciB0aGUgaW50ZXJwb2xhdGVkIHZhbHVlCiAgICAgICAgICAgKiBjaGFuZ2VzLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgTm9ybWFsaXplZCBrZXkuIChpZSBuZ0F0dHJpYnV0ZSkgLgogICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihpbnRlcnBvbGF0ZWRWYWx1ZSl9IGZuIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2hlbmV2ZXIKICAgICAgICAgICB0aGUgaW50ZXJwb2xhdGVkIHZhbHVlIG9mIHRoZSBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgICAgICAqICAgICAgICBTZWUgdGhlIHtAbGluayBndWlkZS9kaXJlY3RpdmUjQXR0cmlidXRlcyBEaXJlY3RpdmVzfSBndWlkZSBmb3IgbW9yZSBpbmZvLgogICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IHRoZSBgZm5gIHBhcmFtZXRlci4KICAgICAgICAgICAqLwogICAgICAgICAgJG9ic2VydmU6IGZ1bmN0aW9uKGtleSwgZm4pIHsKICAgICAgICAgICAgdmFyIGF0dHJzID0gdGhpcywKICAgICAgICAgICAgICAkJG9ic2VydmVycyA9IChhdHRycy4kJG9ic2VydmVycyB8fCAoYXR0cnMuJCRvYnNlcnZlcnMgPSB7fSkpLAogICAgICAgICAgICAgIGxpc3RlbmVycyA9ICgkJG9ic2VydmVyc1trZXldIHx8ICgkJG9ic2VydmVyc1trZXldID0gW10pKTsKCiAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGZuKTsKICAgICAgICAgICAgJHJvb3RTY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmICghbGlzdGVuZXJzLiQkaW50ZXIpIHsKICAgICAgICAgICAgICAgIC8vIG5vIG9uZSByZWdpc3RlcmVkIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLCBzbyBsZXRzIGNhbGwgaXQgbWFudWFsbHkKICAgICAgICAgICAgICAgIGZuKGF0dHJzW2tleV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgc3RhcnRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2woKSwKICAgICAgICAgIGVuZFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2woKSwKICAgICAgICAgIGRlbm9ybWFsaXplVGVtcGxhdGUgPSAoc3RhcnRTeW1ib2wgPT0gJ3t7JyB8fCBlbmRTeW1ib2wgID09ICd9fScpCiAgICAgICAgICAgID8gaWRlbnRpdHkKICAgICAgICAgICAgOiBmdW5jdGlvbiBkZW5vcm1hbGl6ZVRlbXBsYXRlKHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZS5yZXBsYWNlKC9ce1x7L2csIHN0YXJ0U3ltYm9sKS5yZXBsYWNlKC99fS9nLCBlbmRTeW1ib2wpOwogICAgICAgICAgfSwKICAgICAgICAgIE5HX0FUVFJfQklORElORyA9IC9ebmdBdHRyW0EtWl0vOwoKCiAgICAgICAgcmV0dXJuIGNvbXBpbGU7CgogICAgICAgIC8vPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiAgICAgICAgZnVuY3Rpb24gY29tcGlsZSgkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0NvbXBpbGVDb250ZXh0KSB7CiAgICAgICAgICBpZiAoISgkY29tcGlsZU5vZGVzIGluc3RhbmNlb2YganFMaXRlKSkgewogICAgICAgICAgICAvLyBqcXVlcnkgYWx3YXlzIHJld3JhcHMsIHdoZXJlYXMgd2UgbmVlZCB0byBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgc2VsZWN0b3Igc28gdGhhdCB3ZSBjYW4KICAgICAgICAgICAgLy8gbW9kaWZ5IGl0LgogICAgICAgICAgICAkY29tcGlsZU5vZGVzID0ganFMaXRlKCRjb21waWxlTm9kZXMpOwogICAgICAgICAgfQogICAgICAgICAgLy8gV2UgY2FuIG5vdCBjb21waWxlIHRvcCBsZXZlbCB0ZXh0IGVsZW1lbnRzIHNpbmNlIHRleHQgbm9kZXMgY2FuIGJlIG1lcmdlZCBhbmQgd2Ugd2lsbAogICAgICAgICAgLy8gbm90IGJlIGFibGUgdG8gYXR0YWNoIHNjb3BlIGRhdGEgdG8gdGhlbSwgc28gd2Ugd2lsbCB3cmFwIHRoZW0gaW4gPHNwYW4+CiAgICAgICAgICBmb3JFYWNoKCRjb21waWxlTm9kZXMsIGZ1bmN0aW9uKG5vZGUsIGluZGV4KXsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMyAvKiB0ZXh0IG5vZGUgKi8gJiYgbm9kZS5ub2RlVmFsdWUubWF0Y2goL1xTKy8pIC8qIG5vbi1lbXB0eSAqLyApIHsKICAgICAgICAgICAgICAkY29tcGlsZU5vZGVzW2luZGV4XSA9IG5vZGUgPSBqcUxpdGUobm9kZSkud3JhcCgnPHNwYW4+PC9zcGFuPicpLnBhcmVudCgpWzBdOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBjb21wb3NpdGVMaW5rRm4gPQogICAgICAgICAgICBjb21waWxlTm9kZXMoJGNvbXBpbGVOb2RlcywgdHJhbnNjbHVkZUZuLCAkY29tcGlsZU5vZGVzLAogICAgICAgICAgICAgIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpOwogICAgICAgICAgc2FmZUFkZENsYXNzKCRjb21waWxlTm9kZXMsICduZy1zY29wZScpOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHB1YmxpY0xpbmtGbihzY29wZSwgY2xvbmVDb25uZWN0Rm4sIHRyYW5zY2x1ZGVDb250cm9sbGVycyl7CiAgICAgICAgICAgIGFzc2VydEFyZyhzY29wZSwgJ3Njb3BlJyk7CiAgICAgICAgICAgIC8vIGltcG9ydGFudCEhOiB3ZSBtdXN0IGNhbGwgb3VyIGpxTGl0ZS5jbG9uZSgpIHNpbmNlIHRoZSBqUXVlcnkgb25lIGlzIHRyeWluZyB0byBiZSBzbWFydAogICAgICAgICAgICAvLyBhbmQgc29tZXRpbWVzIGNoYW5nZXMgdGhlIHN0cnVjdHVyZSBvZiB0aGUgRE9NLgogICAgICAgICAgICB2YXIgJGxpbmtOb2RlID0gY2xvbmVDb25uZWN0Rm4KICAgICAgICAgICAgICA/IEpRTGl0ZVByb3RvdHlwZS5jbG9uZS5jYWxsKCRjb21waWxlTm9kZXMpIC8vIElNUE9SVEFOVCEhIQogICAgICAgICAgICAgIDogJGNvbXBpbGVOb2RlczsKCiAgICAgICAgICAgIGZvckVhY2godHJhbnNjbHVkZUNvbnRyb2xsZXJzLCBmdW5jdGlvbihpbnN0YW5jZSwgbmFtZSkgewogICAgICAgICAgICAgICRsaW5rTm9kZS5kYXRhKCckJyArIG5hbWUgKyAnQ29udHJvbGxlcicsIGluc3RhbmNlKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBBdHRhY2ggc2NvcGUgb25seSB0byBub24tdGV4dCBub2Rlcy4KICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaWkgPSAkbGlua05vZGUubGVuZ3RoOyBpPGlpOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgbm9kZSA9ICRsaW5rTm9kZVtpXSwKICAgICAgICAgICAgICAgIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZTsKICAgICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IDEgLyogZWxlbWVudCAqLyB8fCBub2RlVHlwZSA9PT0gOSAvKiBkb2N1bWVudCAqLykgewogICAgICAgICAgICAgICAgJGxpbmtOb2RlLmVxKGkpLmRhdGEoJyRzY29wZScsIHNjb3BlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjbG9uZUNvbm5lY3RGbikgY2xvbmVDb25uZWN0Rm4oJGxpbmtOb2RlLCBzY29wZSk7CiAgICAgICAgICAgIGlmIChjb21wb3NpdGVMaW5rRm4pIGNvbXBvc2l0ZUxpbmtGbihzY29wZSwgJGxpbmtOb2RlLCAkbGlua05vZGUpOwogICAgICAgICAgICByZXR1cm4gJGxpbmtOb2RlOwogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNhZmVBZGRDbGFzcygkZWxlbWVudCwgY2xhc3NOYW1lKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSwgc2luY2UgaXQgbWVhbnMgdGhhdCB3ZSBhcmUgdHJ5aW5nIHRvIHNldCBjbGFzcyBvbgogICAgICAgICAgICAvLyBTVkcgZWxlbWVudCwgd2hlcmUgY2xhc3MgbmFtZSBpcyByZWFkLW9ubHkuCiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBDb21waWxlIGZ1bmN0aW9uIG1hdGNoZXMgZWFjaCBub2RlIGluIG5vZGVMaXN0IGFnYWluc3QgdGhlIGRpcmVjdGl2ZXMuIE9uY2UgYWxsIGRpcmVjdGl2ZXMKICAgICAgICAgKiBmb3IgYSBwYXJ0aWN1bGFyIG5vZGUgYXJlIGNvbGxlY3RlZCB0aGVpciBjb21waWxlIGZ1bmN0aW9ucyBhcmUgZXhlY3V0ZWQuIFRoZSBjb21waWxlCiAgICAgICAgICogZnVuY3Rpb25zIHJldHVybiB2YWx1ZXMgLSB0aGUgbGlua2luZyBmdW5jdGlvbnMgLSBhcmUgY29tYmluZWQgaW50byBhIGNvbXBvc2l0ZSBsaW5raW5nCiAgICAgICAgICogZnVuY3Rpb24sIHdoaWNoIGlzIHRoZSBhIGxpbmtpbmcgZnVuY3Rpb24gZm9yIHRoZSBub2RlLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtOb2RlTGlzdH0gbm9kZUxpc3QgYW4gYXJyYXkgb2Ygbm9kZXMgb3IgTm9kZUxpc3QgdG8gY29tcGlsZQogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZSwgY2xvbmVBdHRhY2hGbj0pfSB0cmFuc2NsdWRlRm4gQSBsaW5raW5nIGZ1bmN0aW9uLCB3aGVyZSB0aGUKICAgICAgICAgKiAgICAgICAgc2NvcGUgYXJndW1lbnQgaXMgYXV0by1nZW5lcmF0ZWQgdG8gdGhlIG5ldyBjaGlsZCBvZiB0aGUgdHJhbnNjbHVkZWQgcGFyZW50IHNjb3BlLgogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudD19ICRyb290RWxlbWVudCBJZiB0aGUgbm9kZUxpc3QgaXMgdGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGF0aW9uIHRyZWUgdGhlbgogICAgICAgICAqICAgICAgICB0aGUgcm9vdEVsZW1lbnQgbXVzdCBiZSBzZXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIG9mIHRoZSBjb21waWxlIHJvb3QuIFRoaXMgaXMKICAgICAgICAgKiAgICAgICAgbmVlZGVkIHNvIHRoYXQgdGhlIGpxTGl0ZSBjb2xsZWN0aW9uIGl0ZW1zIGNhbiBiZSByZXBsYWNlZCB3aXRoIHdpZGdldHMuCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBtYXhQcmlvcml0eSBNYXggZGlyZWN0aXZlIHByaW9yaXR5LgogICAgICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gQSBjb21wb3NpdGUgbGlua2luZyBmdW5jdGlvbiBvZiBhbGwgb2YgdGhlIG1hdGNoZWQgZGlyZWN0aXZlcyBvciBudWxsLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVOb2Rlcyhub2RlTGlzdCwgdHJhbnNjbHVkZUZuLCAkcm9vdEVsZW1lbnQsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpIHsKICAgICAgICAgIHZhciBsaW5rRm5zID0gW10sCiAgICAgICAgICAgIGF0dHJzLCBkaXJlY3RpdmVzLCBub2RlTGlua0ZuLCBjaGlsZE5vZGVzLCBjaGlsZExpbmtGbiwgbGlua0ZuRm91bmQ7CgogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2RlTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhdHRycyA9IG5ldyBBdHRyaWJ1dGVzKCk7CgogICAgICAgICAgICAvLyB3ZSBtdXN0IGFsd2F5cyByZWZlciB0byBub2RlTGlzdFtpXSBzaW5jZSB0aGUgbm9kZXMgY2FuIGJlIHJlcGxhY2VkIHVuZGVybmVhdGggdXMuCiAgICAgICAgICAgIGRpcmVjdGl2ZXMgPSBjb2xsZWN0RGlyZWN0aXZlcyhub2RlTGlzdFtpXSwgW10sIGF0dHJzLCBpID09PSAwID8gbWF4UHJpb3JpdHkgOiB1bmRlZmluZWQsCiAgICAgICAgICAgICAgaWdub3JlRGlyZWN0aXZlKTsKCiAgICAgICAgICAgIG5vZGVMaW5rRm4gPSAoZGlyZWN0aXZlcy5sZW5ndGgpCiAgICAgICAgICAgICAgPyBhcHBseURpcmVjdGl2ZXNUb05vZGUoZGlyZWN0aXZlcywgbm9kZUxpc3RbaV0sIGF0dHJzLCB0cmFuc2NsdWRlRm4sICRyb290RWxlbWVudCwKICAgICAgICAgICAgICBudWxsLCBbXSwgW10sIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpCiAgICAgICAgICAgICAgOiBudWxsOwoKICAgICAgICAgICAgaWYgKG5vZGVMaW5rRm4gJiYgbm9kZUxpbmtGbi5zY29wZSkgewogICAgICAgICAgICAgIHNhZmVBZGRDbGFzcyhqcUxpdGUobm9kZUxpc3RbaV0pLCAnbmctc2NvcGUnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2hpbGRMaW5rRm4gPSAobm9kZUxpbmtGbiAmJiBub2RlTGlua0ZuLnRlcm1pbmFsIHx8CiAgICAgICAgICAgICAgIShjaGlsZE5vZGVzID0gbm9kZUxpc3RbaV0uY2hpbGROb2RlcykgfHwKICAgICAgICAgICAgICAhY2hpbGROb2Rlcy5sZW5ndGgpCiAgICAgICAgICAgICAgPyBudWxsCiAgICAgICAgICAgICAgOiBjb21waWxlTm9kZXMoY2hpbGROb2RlcywKICAgICAgICAgICAgICBub2RlTGlua0ZuID8gbm9kZUxpbmtGbi50cmFuc2NsdWRlIDogdHJhbnNjbHVkZUZuKTsKCiAgICAgICAgICAgIGxpbmtGbnMucHVzaChub2RlTGlua0ZuLCBjaGlsZExpbmtGbik7CiAgICAgICAgICAgIGxpbmtGbkZvdW5kID0gbGlua0ZuRm91bmQgfHwgbm9kZUxpbmtGbiB8fCBjaGlsZExpbmtGbjsKICAgICAgICAgICAgLy91c2UgdGhlIHByZXZpb3VzIGNvbnRleHQgb25seSBmb3IgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlIHZpcnR1YWwgZ3JvdXAKICAgICAgICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gcmV0dXJuIGEgbGlua2luZyBmdW5jdGlvbiBpZiB3ZSBoYXZlIGZvdW5kIGFueXRoaW5nLCBudWxsIG90aGVyd2lzZQogICAgICAgICAgcmV0dXJuIGxpbmtGbkZvdW5kID8gY29tcG9zaXRlTGlua0ZuIDogbnVsbDsKCiAgICAgICAgICBmdW5jdGlvbiBjb21wb3NpdGVMaW5rRm4oc2NvcGUsIG5vZGVMaXN0LCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgIHZhciBub2RlTGlua0ZuLCBjaGlsZExpbmtGbiwgbm9kZSwgJG5vZGUsIGNoaWxkU2NvcGUsIGNoaWxkVHJhbnNjbHVkZUZuLCBpLCBpaSwgbjsKCiAgICAgICAgICAgIC8vIGNvcHkgbm9kZUxpc3Qgc28gdGhhdCBsaW5raW5nIGRvZXNuJ3QgYnJlYWsgZHVlIHRvIGxpdmUgbGlzdCB1cGRhdGVzLgogICAgICAgICAgICB2YXIgbm9kZUxpc3RMZW5ndGggPSBub2RlTGlzdC5sZW5ndGgsCiAgICAgICAgICAgICAgc3RhYmxlTm9kZUxpc3QgPSBuZXcgQXJyYXkobm9kZUxpc3RMZW5ndGgpOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbm9kZUxpc3RMZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHN0YWJsZU5vZGVMaXN0W2ldID0gbm9kZUxpc3RbaV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvcihpID0gMCwgbiA9IDAsIGlpID0gbGlua0Zucy5sZW5ndGg7IGkgPCBpaTsgbisrKSB7CiAgICAgICAgICAgICAgbm9kZSA9IHN0YWJsZU5vZGVMaXN0W25dOwogICAgICAgICAgICAgIG5vZGVMaW5rRm4gPSBsaW5rRm5zW2krK107CiAgICAgICAgICAgICAgY2hpbGRMaW5rRm4gPSBsaW5rRm5zW2krK107CiAgICAgICAgICAgICAgJG5vZGUgPSBqcUxpdGUobm9kZSk7CgogICAgICAgICAgICAgIGlmIChub2RlTGlua0ZuKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZUxpbmtGbi5zY29wZSkgewogICAgICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICAkbm9kZS5kYXRhKCckc2NvcGUnLCBjaGlsZFNjb3BlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBzY29wZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gbm9kZUxpbmtGbi50cmFuc2NsdWRlOwogICAgICAgICAgICAgICAgaWYgKGNoaWxkVHJhbnNjbHVkZUZuIHx8ICghYm91bmRUcmFuc2NsdWRlRm4gJiYgdHJhbnNjbHVkZUZuKSkgewogICAgICAgICAgICAgICAgICBub2RlTGlua0ZuKGNoaWxkTGlua0ZuLCBjaGlsZFNjb3BlLCBub2RlLCAkcm9vdEVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgY3JlYXRlQm91bmRUcmFuc2NsdWRlRm4oc2NvcGUsIGNoaWxkVHJhbnNjbHVkZUZuIHx8IHRyYW5zY2x1ZGVGbikKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIGNoaWxkU2NvcGUsIG5vZGUsICRyb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGRMaW5rRm4pIHsKICAgICAgICAgICAgICAgIGNoaWxkTGlua0ZuKHNjb3BlLCBub2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQm91bmRUcmFuc2NsdWRlRm4oc2NvcGUsIHRyYW5zY2x1ZGVGbikgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGJvdW5kVHJhbnNjbHVkZUZuKHRyYW5zY2x1ZGVkU2NvcGUsIGNsb25lRm4sIGNvbnRyb2xsZXJzKSB7CiAgICAgICAgICAgIHZhciBzY29wZUNyZWF0ZWQgPSBmYWxzZTsKCiAgICAgICAgICAgIGlmICghdHJhbnNjbHVkZWRTY29wZSkgewogICAgICAgICAgICAgIHRyYW5zY2x1ZGVkU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgdHJhbnNjbHVkZWRTY29wZS4kJHRyYW5zY2x1ZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICBzY29wZUNyZWF0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY2xvbmUgPSB0cmFuc2NsdWRlRm4odHJhbnNjbHVkZWRTY29wZSwgY2xvbmVGbiwgY29udHJvbGxlcnMpOwogICAgICAgICAgICBpZiAoc2NvcGVDcmVhdGVkKSB7CiAgICAgICAgICAgICAgY2xvbmUub24oJyRkZXN0cm95JywgYmluZCh0cmFuc2NsdWRlZFNjb3BlLCB0cmFuc2NsdWRlZFNjb3BlLiRkZXN0cm95KSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNsb25lOwogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIExvb2tzIGZvciBkaXJlY3RpdmVzIG9uIHRoZSBnaXZlbiBub2RlIGFuZCBhZGRzIHRoZW0gdG8gdGhlIGRpcmVjdGl2ZSBjb2xsZWN0aW9uIHdoaWNoIGlzCiAgICAgICAgICogc29ydGVkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIG5vZGUgTm9kZSB0byBzZWFyY2guCiAgICAgICAgICogQHBhcmFtIGRpcmVjdGl2ZXMgQW4gYXJyYXkgdG8gd2hpY2ggdGhlIGRpcmVjdGl2ZXMgYXJlIGFkZGVkIHRvLiBUaGlzIGFycmF5IGlzIHNvcnRlZCBiZWZvcmUKICAgICAgICAgKiAgICAgICAgdGhlIGZ1bmN0aW9uIHJldHVybnMuCiAgICAgICAgICogQHBhcmFtIGF0dHJzIFRoZSBzaGFyZWQgYXR0cnMgb2JqZWN0IHdoaWNoIGlzIHVzZWQgdG8gcG9wdWxhdGUgdGhlIG5vcm1hbGl6ZWQgYXR0cmlidXRlcy4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG1heFByaW9yaXR5IE1heCBkaXJlY3RpdmUgcHJpb3JpdHkuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY29sbGVjdERpcmVjdGl2ZXMobm9kZSwgZGlyZWN0aXZlcywgYXR0cnMsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpIHsKICAgICAgICAgIHZhciBub2RlVHlwZSA9IG5vZGUubm9kZVR5cGUsCiAgICAgICAgICAgIGF0dHJzTWFwID0gYXR0cnMuJGF0dHIsCiAgICAgICAgICAgIG1hdGNoLAogICAgICAgICAgICBjbGFzc05hbWU7CgogICAgICAgICAgc3dpdGNoKG5vZGVUeXBlKSB7CiAgICAgICAgICAgIGNhc2UgMTogLyogRWxlbWVudCAqLwogICAgICAgICAgICAgIC8vIHVzZSB0aGUgbm9kZSBuYW1lOiA8ZGlyZWN0aXZlPgogICAgICAgICAgICAgIGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLAogICAgICAgICAgICAgICAgZGlyZWN0aXZlTm9ybWFsaXplKG5vZGVOYW1lXyhub2RlKS50b0xvd2VyQ2FzZSgpKSwgJ0UnLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKTsKCiAgICAgICAgICAgICAgLy8gaXRlcmF0ZSBvdmVyIHRoZSBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgZm9yICh2YXIgYXR0ciwgbmFtZSwgbk5hbWUsIG5nQXR0ck5hbWUsIHZhbHVlLCBuQXR0cnMgPSBub2RlLmF0dHJpYnV0ZXMsCiAgICAgICAgICAgICAgICAgICAgIGogPSAwLCBqaiA9IG5BdHRycyAmJiBuQXR0cnMubGVuZ3RoOyBqIDwgamo7IGorKykgewogICAgICAgICAgICAgICAgdmFyIGF0dHJTdGFydE5hbWUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHZhciBhdHRyRW5kTmFtZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGF0dHIgPSBuQXR0cnNbal07CiAgICAgICAgICAgICAgICBpZiAoIW1zaWUgfHwgbXNpZSA+PSA4IHx8IGF0dHIuc3BlY2lmaWVkKSB7CiAgICAgICAgICAgICAgICAgIG5hbWUgPSBhdHRyLm5hbWU7CiAgICAgICAgICAgICAgICAgIC8vIHN1cHBvcnQgbmdBdHRyIGF0dHJpYnV0ZSBiaW5kaW5nCiAgICAgICAgICAgICAgICAgIG5nQXR0ck5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobmFtZSk7CiAgICAgICAgICAgICAgICAgIGlmIChOR19BVFRSX0JJTkRJTkcudGVzdChuZ0F0dHJOYW1lKSkgewogICAgICAgICAgICAgICAgICAgIG5hbWUgPSBzbmFrZV9jYXNlKG5nQXR0ck5hbWUuc3Vic3RyKDYpLCAnLScpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICB2YXIgZGlyZWN0aXZlTk5hbWUgPSBuZ0F0dHJOYW1lLnJlcGxhY2UoLyhTdGFydHxFbmQpJC8sICcnKTsKICAgICAgICAgICAgICAgICAgaWYgKG5nQXR0ck5hbWUgPT09IGRpcmVjdGl2ZU5OYW1lICsgJ1N0YXJ0JykgewogICAgICAgICAgICAgICAgICAgIGF0dHJTdGFydE5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgICAgIGF0dHJFbmROYW1lID0gbmFtZS5zdWJzdHIoMCwgbmFtZS5sZW5ndGggLSA1KSArICdlbmQnOwogICAgICAgICAgICAgICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cigwLCBuYW1lLmxlbmd0aCAtIDYpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBuTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICBhdHRyc01hcFtuTmFtZV0gPSBuYW1lOwogICAgICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB2YWx1ZSA9IHRyaW0oYXR0ci52YWx1ZSk7CiAgICAgICAgICAgICAgICAgIGlmIChnZXRCb29sZWFuQXR0ck5hbWUobm9kZSwgbk5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJ1ZTsgLy8gcHJlc2VuY2UgbWVhbnMgdHJ1ZQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGFkZEF0dHJJbnRlcnBvbGF0ZURpcmVjdGl2ZShub2RlLCBkaXJlY3RpdmVzLCB2YWx1ZSwgbk5hbWUpOwogICAgICAgICAgICAgICAgICBhZGREaXJlY3RpdmUoZGlyZWN0aXZlcywgbk5hbWUsICdBJywgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSwgYXR0clN0YXJ0TmFtZSwKICAgICAgICAgICAgICAgICAgICBhdHRyRW5kTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyB1c2UgY2xhc3MgYXMgZGlyZWN0aXZlCiAgICAgICAgICAgICAgY2xhc3NOYW1lID0gbm9kZS5jbGFzc05hbWU7CiAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKGNsYXNzTmFtZSkgJiYgY2xhc3NOYW1lICE9PSAnJykgewogICAgICAgICAgICAgICAgd2hpbGUgKG1hdGNoID0gQ0xBU1NfRElSRUNUSVZFX1JFR0VYUC5leGVjKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgbk5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUobWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgICBpZiAoYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5OYW1lLCAnQycsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0cnNbbk5hbWVdID0gdHJpbShtYXRjaFszXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lLnN1YnN0cihtYXRjaC5pbmRleCArIG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDM6IC8qIFRleHQgTm9kZSAqLwogICAgICAgICAgICAgIGFkZFRleHRJbnRlcnBvbGF0ZURpcmVjdGl2ZShkaXJlY3RpdmVzLCBub2RlLm5vZGVWYWx1ZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgODogLyogQ29tbWVudCAqLwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBtYXRjaCA9IENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUC5leGVjKG5vZGUubm9kZVZhbHVlKTsKICAgICAgICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICAgICAgICBuTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZShtYXRjaFsxXSk7CiAgICAgICAgICAgICAgICAgIGlmIChhZGREaXJlY3RpdmUoZGlyZWN0aXZlcywgbk5hbWUsICdNJywgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB0cmltKG1hdGNoWzJdKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIC8vIHR1cm5zIG91dCB0aGF0IHVuZGVyIHNvbWUgY2lyY3Vtc3RhbmNlcyBJRTkgdGhyb3dzIGVycm9ycyB3aGVuIG9uZSBhdHRlbXB0cyB0byByZWFkCiAgICAgICAgICAgICAgICAvLyBjb21tZW50J3Mgbm9kZSB2YWx1ZS4KICAgICAgICAgICAgICAgIC8vIEp1c3QgaWdub3JlIGl0IGFuZCBjb250aW51ZS4gKENhbid0IHNlZW0gdG8gcmVwcm9kdWNlIGluIHRlc3QgY2FzZS4pCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICAgIGRpcmVjdGl2ZXMuc29ydChieVByaW9yaXR5KTsKICAgICAgICAgIHJldHVybiBkaXJlY3RpdmVzOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogR2l2ZW4gYSBub2RlIHdpdGggYW4gZGlyZWN0aXZlLXN0YXJ0IGl0IGNvbGxlY3RzIGFsbCBvZiB0aGUgc2libGluZ3MgdW50aWwgaXQgZmluZHMKICAgICAgICAgKiBkaXJlY3RpdmUtZW5kLgogICAgICAgICAqIEBwYXJhbSBub2RlCiAgICAgICAgICogQHBhcmFtIGF0dHJTdGFydAogICAgICAgICAqIEBwYXJhbSBhdHRyRW5kCiAgICAgICAgICogQHJldHVybnMgeyp9CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZ3JvdXBTY2FuKG5vZGUsIGF0dHJTdGFydCwgYXR0ckVuZCkgewogICAgICAgICAgdmFyIG5vZGVzID0gW107CiAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgaWYgKGF0dHJTdGFydCAmJiBub2RlLmhhc0F0dHJpYnV0ZSAmJiBub2RlLmhhc0F0dHJpYnV0ZShhdHRyU3RhcnQpKSB7CiAgICAgICAgICAgIHZhciBzdGFydE5vZGUgPSBub2RlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKCFub2RlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndXRlcmRpcicsCiAgICAgICAgICAgICAgICAgICJVbnRlcm1pbmF0ZWQgYXR0cmlidXRlLCBmb3VuZCAnezB9JyBidXQgbm8gbWF0Y2hpbmcgJ3sxfScgZm91bmQuIiwKICAgICAgICAgICAgICAgICAgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSAvKiogRWxlbWVudCAqKi8pIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmhhc0F0dHJpYnV0ZShhdHRyU3RhcnQpKSBkZXB0aCsrOwogICAgICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJFbmQpKSBkZXB0aC0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICB9IHdoaWxlIChkZXB0aCA+IDApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbm9kZXMucHVzaChub2RlKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4ganFMaXRlKG5vZGVzKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIFdyYXBwZXIgZm9yIGxpbmtpbmcgZnVuY3Rpb24gd2hpY2ggY29udmVydHMgbm9ybWFsIGxpbmtpbmcgZnVuY3Rpb24gaW50byBhIGdyb3VwZWQKICAgICAgICAgKiBsaW5raW5nIGZ1bmN0aW9uLgogICAgICAgICAqIEBwYXJhbSBsaW5rRm4KICAgICAgICAgKiBAcGFyYW0gYXR0clN0YXJ0CiAgICAgICAgICogQHBhcmFtIGF0dHJFbmQKICAgICAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZ3JvdXBFbGVtZW50c0xpbmtGbldyYXBwZXIobGlua0ZuLCBhdHRyU3RhcnQsIGF0dHJFbmQpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIGNvbnRyb2xsZXJzLCB0cmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgZWxlbWVudCA9IGdyb3VwU2NhbihlbGVtZW50WzBdLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgICByZXR1cm4gbGlua0ZuKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcnMsIHRyYW5zY2x1ZGVGbik7CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogT25jZSB0aGUgZGlyZWN0aXZlcyBoYXZlIGJlZW4gY29sbGVjdGVkLCB0aGVpciBjb21waWxlIGZ1bmN0aW9ucyBhcmUgZXhlY3V0ZWQuIFRoaXMgbWV0aG9kCiAgICAgICAgICogaXMgcmVzcG9uc2libGUgZm9yIGlubGluaW5nIGRpcmVjdGl2ZSB0ZW1wbGF0ZXMgYXMgd2VsbCBhcyB0ZXJtaW5hdGluZyB0aGUgYXBwbGljYXRpb24KICAgICAgICAgKiBvZiB0aGUgZGlyZWN0aXZlcyBpZiB0aGUgdGVybWluYWwgZGlyZWN0aXZlIGhhcyBiZWVuIHJlYWNoZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSBkaXJlY3RpdmVzIEFycmF5IG9mIGNvbGxlY3RlZCBkaXJlY3RpdmVzIHRvIGV4ZWN1dGUgdGhlaXIgY29tcGlsZSBmdW5jdGlvbi4KICAgICAgICAgKiAgICAgICAgdGhpcyBuZWVkcyB0byBiZSBwcmUtc29ydGVkIGJ5IHByaW9yaXR5IG9yZGVyLgogICAgICAgICAqIEBwYXJhbSB7Tm9kZX0gY29tcGlsZU5vZGUgVGhlIHJhdyBET00gbm9kZSB0byBhcHBseSB0aGUgY29tcGlsZSBmdW5jdGlvbnMgdG8KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdGVtcGxhdGVBdHRycyBUaGUgc2hhcmVkIGF0dHJpYnV0ZSBmdW5jdGlvbgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oYW5ndWxhci5TY29wZSwgY2xvbmVBdHRhY2hGbj0pfSB0cmFuc2NsdWRlRm4gQSBsaW5raW5nIGZ1bmN0aW9uLCB3aGVyZSB0aGUKICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUgYXJndW1lbnQgaXMgYXV0by1nZW5lcmF0ZWQgdG8gdGhlIG5ldwogICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGlsZCBvZiB0aGUgdHJhbnNjbHVkZWQgcGFyZW50IHNjb3BlLgogICAgICAgICAqIEBwYXJhbSB7SlFMaXRlfSBqcUNvbGxlY3Rpb24gSWYgd2UgYXJlIHdvcmtpbmcgb24gdGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGUgdHJlZSB0aGVuIHRoaXMKICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50IGhhcyB0aGUgcm9vdCBqcUxpdGUgYXJyYXkgc28gdGhhdCB3ZSBjYW4gcmVwbGFjZSBub2RlcwogICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb24gaXQuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBvcmlnaW5hbFJlcGxhY2VEaXJlY3RpdmUgQW4gb3B0aW9uYWwgZGlyZWN0aXZlIHRoYXQgd2lsbCBiZSBpZ25vcmVkIHdoZW4KICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxpbmcgdGhlIHRyYW5zY2x1c2lvbi4KICAgICAgICAgKiBAcGFyYW0ge0FycmF5LjxGdW5jdGlvbj59IHByZUxpbmtGbnMKICAgICAgICAgKiBAcGFyYW0ge0FycmF5LjxGdW5jdGlvbj59IHBvc3RMaW5rRm5zCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQgQ29udGV4dCB1c2VkIGZvciBwcmV2aW91cyBjb21waWxhdGlvbiBvZiB0aGUgY3VycmVudAogICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUKICAgICAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IGxpbmtGbgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGFwcGx5RGlyZWN0aXZlc1RvTm9kZShkaXJlY3RpdmVzLCBjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycywgdHJhbnNjbHVkZUZuLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqcUNvbGxlY3Rpb24sIG9yaWdpbmFsUmVwbGFjZURpcmVjdGl2ZSwgcHJlTGlua0ZucywgcG9zdExpbmtGbnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpIHsKICAgICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQgPSBwcmV2aW91c0NvbXBpbGVDb250ZXh0IHx8IHt9OwoKICAgICAgICAgIHZhciB0ZXJtaW5hbFByaW9yaXR5ID0gLU51bWJlci5NQVhfVkFMVUUsCiAgICAgICAgICAgIG5ld1Njb3BlRGlyZWN0aXZlLAogICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcyA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQuY29udHJvbGxlckRpcmVjdGl2ZXMsCiAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQubmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLAogICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQudGVtcGxhdGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUgPSBwcmV2aW91c0NvbXBpbGVDb250ZXh0Lm5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgIGhhc1RyYW5zY2x1ZGVEaXJlY3RpdmUgPSBmYWxzZSwKICAgICAgICAgICAgaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUgPSBwcmV2aW91c0NvbXBpbGVDb250ZXh0Lmhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlLAogICAgICAgICAgICAkY29tcGlsZU5vZGUgPSB0ZW1wbGF0ZUF0dHJzLiQkZWxlbWVudCA9IGpxTGl0ZShjb21waWxlTm9kZSksCiAgICAgICAgICAgIGRpcmVjdGl2ZSwKICAgICAgICAgICAgZGlyZWN0aXZlTmFtZSwKICAgICAgICAgICAgJHRlbXBsYXRlLAogICAgICAgICAgICByZXBsYWNlRGlyZWN0aXZlID0gb3JpZ2luYWxSZXBsYWNlRGlyZWN0aXZlLAogICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IHRyYW5zY2x1ZGVGbiwKICAgICAgICAgICAgbGlua0ZuLAogICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZTsKCiAgICAgICAgICAvLyBleGVjdXRlcyBhbGwgZGlyZWN0aXZlcyBvbiB0aGUgY3VycmVudCBlbGVtZW50CiAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICBkaXJlY3RpdmUgPSBkaXJlY3RpdmVzW2ldOwogICAgICAgICAgICB2YXIgYXR0clN0YXJ0ID0gZGlyZWN0aXZlLiQkc3RhcnQ7CiAgICAgICAgICAgIHZhciBhdHRyRW5kID0gZGlyZWN0aXZlLiQkZW5kOwoKICAgICAgICAgICAgLy8gY29sbGVjdCBtdWx0aWJsb2NrIHNlY3Rpb25zCiAgICAgICAgICAgIGlmIChhdHRyU3RhcnQpIHsKICAgICAgICAgICAgICAkY29tcGlsZU5vZGUgPSBncm91cFNjYW4oY29tcGlsZU5vZGUsIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJHRlbXBsYXRlID0gdW5kZWZpbmVkOwoKICAgICAgICAgICAgaWYgKHRlcm1pbmFsUHJpb3JpdHkgPiBkaXJlY3RpdmUucHJpb3JpdHkpIHsKICAgICAgICAgICAgICBicmVhazsgLy8gcHJldmVudCBmdXJ0aGVyIHByb2Nlc3Npbmcgb2YgZGlyZWN0aXZlcwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUuc2NvcGUpIHsKICAgICAgICAgICAgICBuZXdTY29wZURpcmVjdGl2ZSA9IG5ld1Njb3BlRGlyZWN0aXZlIHx8IGRpcmVjdGl2ZTsKCiAgICAgICAgICAgICAgLy8gc2tpcCB0aGUgY2hlY2sgZm9yIGRpcmVjdGl2ZXMgd2l0aCBhc3luYyB0ZW1wbGF0ZXMsIHdlJ2xsIGNoZWNrIHRoZSBkZXJpdmVkIHN5bmMKICAgICAgICAgICAgICAvLyBkaXJlY3RpdmUgd2hlbiB0aGUgdGVtcGxhdGUgYXJyaXZlcwogICAgICAgICAgICAgIGlmICghZGlyZWN0aXZlLnRlbXBsYXRlVXJsKSB7CiAgICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgnbmV3L2lzb2xhdGVkIHNjb3BlJywgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLCBkaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3QoZGlyZWN0aXZlVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmUubmFtZTsKCiAgICAgICAgICAgIGlmICghZGlyZWN0aXZlLnRlbXBsYXRlVXJsICYmIGRpcmVjdGl2ZS5jb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgZGlyZWN0aXZlVmFsdWUgPSBkaXJlY3RpdmUuY29udHJvbGxlcjsKICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlcyA9IGNvbnRyb2xsZXJEaXJlY3RpdmVzIHx8IHt9OwogICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCInIiArIGRpcmVjdGl2ZU5hbWUgKyAiJyBjb250cm9sbGVyIiwKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzW2RpcmVjdGl2ZU5hbWVdLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgY29udHJvbGxlckRpcmVjdGl2ZXNbZGlyZWN0aXZlTmFtZV0gPSBkaXJlY3RpdmU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS50cmFuc2NsdWRlKSB7CiAgICAgICAgICAgICAgaGFzVHJhbnNjbHVkZURpcmVjdGl2ZSA9IHRydWU7CgogICAgICAgICAgICAgIC8vIFNwZWNpYWwgY2FzZSBuZ0lmIGFuZCBuZ1JlcGVhdCBzbyB0aGF0IHdlIGRvbid0IGNvbXBsYWluIGFib3V0IGR1cGxpY2F0ZSB0cmFuc2NsdXNpb24uCiAgICAgICAgICAgICAgLy8gVGhpcyBvcHRpb24gc2hvdWxkIG9ubHkgYmUgdXNlZCBieSBkaXJlY3RpdmVzIHRoYXQga25vdyBob3cgdG8gc2FmZWx5IGhhbmRsZSBlbGVtZW50IHRyYW5zY2x1c2lvbiwKICAgICAgICAgICAgICAvLyB3aGVyZSB0aGUgdHJhbnNjbHVkZWQgbm9kZXMgYXJlIGFkZGVkIG9yIHJlcGxhY2VkIGFmdGVyIGxpbmtpbmcuCiAgICAgICAgICAgICAgaWYgKCFkaXJlY3RpdmUuJCR0bGIpIHsKICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0cmFuc2NsdXNpb24nLCBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID09ICdlbGVtZW50JykgewogICAgICAgICAgICAgICAgaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGVybWluYWxQcmlvcml0eSA9IGRpcmVjdGl2ZS5wcmlvcml0eTsKICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGdyb3VwU2Nhbihjb21waWxlTm9kZSwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgICRjb21waWxlTm9kZSA9IHRlbXBsYXRlQXR0cnMuJCRlbGVtZW50ID0KICAgICAgICAgICAgICAgICAganFMaXRlKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyAnICsgZGlyZWN0aXZlTmFtZSArICc6ICcgKwogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlQXR0cnNbZGlyZWN0aXZlTmFtZV0gKyAnICcpKTsKICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJGNvbXBpbGVOb2RlWzBdOwogICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgoanFDb2xsZWN0aW9uLCBqcUxpdGUoc2xpY2VBcmdzKCR0ZW1wbGF0ZSkpLCBjb21waWxlTm9kZSk7CgogICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBjb21waWxlKCR0ZW1wbGF0ZSwgdHJhbnNjbHVkZUZuLCB0ZXJtaW5hbFByaW9yaXR5LAogICAgICAgICAgICAgICAgICAgIHJlcGxhY2VEaXJlY3RpdmUgJiYgcmVwbGFjZURpcmVjdGl2ZS5uYW1lLCB7CiAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgcGFzcyBpbjoKICAgICAgICAgICAgICAgICAgICAvLyAtIGNvbnRyb2xsZXJEaXJlY3RpdmVzIC0gb3RoZXJ3aXNlIHdlJ2xsIGNyZWF0ZSBkdXBsaWNhdGVzIGNvbnRyb2xsZXJzCiAgICAgICAgICAgICAgICAgICAgLy8gLSBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgb3IgdGVtcGxhdGVEaXJlY3RpdmUgLSBjb21iaW5pbmcgdGVtcGxhdGVzIHdpdGgKICAgICAgICAgICAgICAgICAgICAvLyAgIGVsZW1lbnQgdHJhbnNjbHVzaW9uIGRvZXNuJ3QgbWFrZSBzZW5zZS4KICAgICAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgICAgIC8vIFdlIG5lZWQgb25seSBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlIHNvIHRoYXQgd2UgcHJldmVudCBwdXR0aW5nIHRyYW5zY2x1c2lvbgogICAgICAgICAgICAgICAgICAgIC8vIG9uIHRoZSBzYW1lIGVsZW1lbnQgbW9yZSB0aGFuIG9uY2UuCiAgICAgICAgICAgICAgICAgICAgbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZTogbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKGpxTGl0ZUNsb25lKGNvbXBpbGVOb2RlKSkuY29udGVudHMoKTsKICAgICAgICAgICAgICAgICRjb21waWxlTm9kZS5lbXB0eSgpOyAvLyBjbGVhciBjb250ZW50cwogICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBjb21waWxlKCR0ZW1wbGF0ZSwgdHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVtcGxhdGUpIHsKICAgICAgICAgICAgICBhc3NlcnROb0R1cGxpY2F0ZSgndGVtcGxhdGUnLCB0ZW1wbGF0ZURpcmVjdGl2ZSwgZGlyZWN0aXZlLCAkY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwoKICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZSA9IChpc0Z1bmN0aW9uKGRpcmVjdGl2ZS50ZW1wbGF0ZSkpCiAgICAgICAgICAgICAgICA/IGRpcmVjdGl2ZS50ZW1wbGF0ZSgkY29tcGlsZU5vZGUsIHRlbXBsYXRlQXR0cnMpCiAgICAgICAgICAgICAgICA6IGRpcmVjdGl2ZS50ZW1wbGF0ZTsKCiAgICAgICAgICAgICAgZGlyZWN0aXZlVmFsdWUgPSBkZW5vcm1hbGl6ZVRlbXBsYXRlKGRpcmVjdGl2ZVZhbHVlKTsKCiAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZS5yZXBsYWNlKSB7CiAgICAgICAgICAgICAgICByZXBsYWNlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgaWYgKGpxTGl0ZUlzVGV4dE5vZGUoZGlyZWN0aXZlVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IFtdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKHRyaW0oZGlyZWN0aXZlVmFsdWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJHRlbXBsYXRlWzBdOwoKICAgICAgICAgICAgICAgIGlmICgkdGVtcGxhdGUubGVuZ3RoICE9IDEgfHwgY29tcGlsZU5vZGUubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ3RwbHJ0JywKICAgICAgICAgICAgICAgICAgICAiVGVtcGxhdGUgZm9yIGRpcmVjdGl2ZSAnezB9JyBtdXN0IGhhdmUgZXhhY3RseSBvbmUgcm9vdCBlbGVtZW50LiB7MX0iLAogICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZU5hbWUsICcnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXBsYWNlV2l0aChqcUNvbGxlY3Rpb24sICRjb21waWxlTm9kZSwgY29tcGlsZU5vZGUpOwoKICAgICAgICAgICAgICAgIHZhciBuZXdUZW1wbGF0ZUF0dHJzID0geyRhdHRyOiB7fX07CgogICAgICAgICAgICAgICAgLy8gY29tYmluZSBkaXJlY3RpdmVzIGZyb20gdGhlIG9yaWdpbmFsIG5vZGUgYW5kIGZyb20gdGhlIHRlbXBsYXRlOgogICAgICAgICAgICAgICAgLy8gLSB0YWtlIHRoZSBhcnJheSBvZiBkaXJlY3RpdmVzIGZvciB0aGlzIGVsZW1lbnQKICAgICAgICAgICAgICAgIC8vIC0gc3BsaXQgaXQgaW50byB0d28gcGFydHMsIHRob3NlIHRoYXQgYWxyZWFkeSBhcHBsaWVkIChwcm9jZXNzZWQpIGFuZCB0aG9zZSB0aGF0IHdlcmVuJ3QgKHVucHJvY2Vzc2VkKQogICAgICAgICAgICAgICAgLy8gLSBjb2xsZWN0IGRpcmVjdGl2ZXMgZnJvbSB0aGUgdGVtcGxhdGUgYW5kIHNvcnQgdGhlbSBieSBwcmlvcml0eQogICAgICAgICAgICAgICAgLy8gLSBjb21iaW5lIGRpcmVjdGl2ZXMgYXM6IHByb2Nlc3NlZCArIHRlbXBsYXRlICsgdW5wcm9jZXNzZWQKICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURpcmVjdGl2ZXMgPSBjb2xsZWN0RGlyZWN0aXZlcyhjb21waWxlTm9kZSwgW10sIG5ld1RlbXBsYXRlQXR0cnMpOwogICAgICAgICAgICAgICAgdmFyIHVucHJvY2Vzc2VkRGlyZWN0aXZlcyA9IGRpcmVjdGl2ZXMuc3BsaWNlKGkgKyAxLCBkaXJlY3RpdmVzLmxlbmd0aCAtIChpICsgMSkpOwoKICAgICAgICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgbWFya0RpcmVjdGl2ZXNBc0lzb2xhdGUodGVtcGxhdGVEaXJlY3RpdmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMgPSBkaXJlY3RpdmVzLmNvbmNhdCh0ZW1wbGF0ZURpcmVjdGl2ZXMpLmNvbmNhdCh1bnByb2Nlc3NlZERpcmVjdGl2ZXMpOwogICAgICAgICAgICAgICAgbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXModGVtcGxhdGVBdHRycywgbmV3VGVtcGxhdGVBdHRycyk7CgogICAgICAgICAgICAgICAgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoZGlyZWN0aXZlVmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZS50ZW1wbGF0ZVVybCkgewogICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0ZW1wbGF0ZScsIHRlbXBsYXRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CgogICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUucmVwbGFjZSkgewogICAgICAgICAgICAgICAgcmVwbGFjZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIG5vZGVMaW5rRm4gPSBjb21waWxlVGVtcGxhdGVVcmwoZGlyZWN0aXZlcy5zcGxpY2UoaSwgZGlyZWN0aXZlcy5sZW5ndGggLSBpKSwgJGNvbXBpbGVOb2RlLAogICAgICAgICAgICAgICAgdGVtcGxhdGVBdHRycywganFDb2xsZWN0aW9uLCBjaGlsZFRyYW5zY2x1ZGVGbiwgcHJlTGlua0ZucywgcG9zdExpbmtGbnMsIHsKICAgICAgICAgICAgICAgICAgY29udHJvbGxlckRpcmVjdGl2ZXM6IGNvbnRyb2xsZXJEaXJlY3RpdmVzLAogICAgICAgICAgICAgICAgICBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmU6IG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmU6IHRlbXBsYXRlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlOiBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRpcmVjdGl2ZS5jb21waWxlKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGxpbmtGbiA9IGRpcmVjdGl2ZS5jb21waWxlKCRjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycywgY2hpbGRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24obGlua0ZuKSkgewogICAgICAgICAgICAgICAgICBhZGRMaW5rRm5zKG51bGwsIGxpbmtGbiwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobGlua0ZuKSB7CiAgICAgICAgICAgICAgICAgIGFkZExpbmtGbnMobGlua0ZuLnByZSwgbGlua0ZuLnBvc3QsIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGNvbXBpbGVOb2RlKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlyZWN0aXZlLnRlcm1pbmFsKSB7CiAgICAgICAgICAgICAgbm9kZUxpbmtGbi50ZXJtaW5hbCA9IHRydWU7CiAgICAgICAgICAgICAgdGVybWluYWxQcmlvcml0eSA9IE1hdGgubWF4KHRlcm1pbmFsUHJpb3JpdHksIGRpcmVjdGl2ZS5wcmlvcml0eSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9CgogICAgICAgICAgbm9kZUxpbmtGbi5zY29wZSA9IG5ld1Njb3BlRGlyZWN0aXZlICYmIG5ld1Njb3BlRGlyZWN0aXZlLnNjb3BlID09PSB0cnVlOwogICAgICAgICAgbm9kZUxpbmtGbi50cmFuc2NsdWRlID0gaGFzVHJhbnNjbHVkZURpcmVjdGl2ZSAmJiBjaGlsZFRyYW5zY2x1ZGVGbjsKICAgICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQuaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUgPSBoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZTsKCiAgICAgICAgICAvLyBtaWdodCBiZSBub3JtYWwgb3IgZGVsYXllZCBub2RlTGlua0ZuIGRlcGVuZGluZyBvbiBpZiB0ZW1wbGF0ZVVybCBpcyBwcmVzZW50CiAgICAgICAgICByZXR1cm4gbm9kZUxpbmtGbjsKCiAgICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgICAgICAgIGZ1bmN0aW9uIGFkZExpbmtGbnMocHJlLCBwb3N0LCBhdHRyU3RhcnQsIGF0dHJFbmQpIHsKICAgICAgICAgICAgaWYgKHByZSkgewogICAgICAgICAgICAgIGlmIChhdHRyU3RhcnQpIHByZSA9IGdyb3VwRWxlbWVudHNMaW5rRm5XcmFwcGVyKHByZSwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICBwcmUucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlOwogICAgICAgICAgICAgIHByZS5kaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlTmFtZTsKICAgICAgICAgICAgICBpZiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlID09PSBkaXJlY3RpdmUgfHwgZGlyZWN0aXZlLiQkaXNvbGF0ZVNjb3BlKSB7CiAgICAgICAgICAgICAgICBwcmUgPSBjbG9uZUFuZEFubm90YXRlRm4ocHJlLCB7aXNvbGF0ZVNjb3BlOiB0cnVlfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZUxpbmtGbnMucHVzaChwcmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwb3N0KSB7CiAgICAgICAgICAgICAgaWYgKGF0dHJTdGFydCkgcG9zdCA9IGdyb3VwRWxlbWVudHNMaW5rRm5XcmFwcGVyKHBvc3QsIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgICAgICAgcG9zdC5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmU7CiAgICAgICAgICAgICAgcG9zdC5kaXJlY3RpdmVOYW1lID0gZGlyZWN0aXZlTmFtZTsKICAgICAgICAgICAgICBpZiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlID09PSBkaXJlY3RpdmUgfHwgZGlyZWN0aXZlLiQkaXNvbGF0ZVNjb3BlKSB7CiAgICAgICAgICAgICAgICBwb3N0ID0gY2xvbmVBbmRBbm5vdGF0ZUZuKHBvc3QsIHtpc29sYXRlU2NvcGU6IHRydWV9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcG9zdExpbmtGbnMucHVzaChwb3N0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKCiAgICAgICAgICBmdW5jdGlvbiBnZXRDb250cm9sbGVycyhkaXJlY3RpdmVOYW1lLCByZXF1aXJlLCAkZWxlbWVudCwgZWxlbWVudENvbnRyb2xsZXJzKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSwgcmV0cmlldmFsTWV0aG9kID0gJ2RhdGEnLCBvcHRpb25hbCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoaXNTdHJpbmcocmVxdWlyZSkpIHsKICAgICAgICAgICAgICB3aGlsZSgodmFsdWUgPSByZXF1aXJlLmNoYXJBdCgwKSkgPT0gJ14nIHx8IHZhbHVlID09ICc/JykgewogICAgICAgICAgICAgICAgcmVxdWlyZSA9IHJlcXVpcmUuc3Vic3RyKDEpOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09ICdeJykgewogICAgICAgICAgICAgICAgICByZXRyaWV2YWxNZXRob2QgPSAnaW5oZXJpdGVkRGF0YSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvcHRpb25hbCA9IG9wdGlvbmFsIHx8IHZhbHVlID09ICc/JzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFsdWUgPSBudWxsOwoKICAgICAgICAgICAgICBpZiAoZWxlbWVudENvbnRyb2xsZXJzICYmIHJldHJpZXZhbE1ldGhvZCA9PT0gJ2RhdGEnKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IGVsZW1lbnRDb250cm9sbGVyc1tyZXF1aXJlXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCAkZWxlbWVudFtyZXRyaWV2YWxNZXRob2RdKCckJyArIHJlcXVpcmUgKyAnQ29udHJvbGxlcicpOwoKICAgICAgICAgICAgICBpZiAoIXZhbHVlICYmICFvcHRpb25hbCkgewogICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ2N0cmVxJywKICAgICAgICAgICAgICAgICAgIkNvbnRyb2xsZXIgJ3swfScsIHJlcXVpcmVkIGJ5IGRpcmVjdGl2ZSAnezF9JywgY2FuJ3QgYmUgZm91bmQhIiwKICAgICAgICAgICAgICAgICAgcmVxdWlyZSwgZGlyZWN0aXZlTmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5KHJlcXVpcmUpKSB7CiAgICAgICAgICAgICAgdmFsdWUgPSBbXTsKICAgICAgICAgICAgICBmb3JFYWNoKHJlcXVpcmUsIGZ1bmN0aW9uKHJlcXVpcmUpIHsKICAgICAgICAgICAgICAgIHZhbHVlLnB1c2goZ2V0Q29udHJvbGxlcnMoZGlyZWN0aXZlTmFtZSwgcmVxdWlyZSwgJGVsZW1lbnQsIGVsZW1lbnRDb250cm9sbGVycykpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KCgogICAgICAgICAgZnVuY3Rpb24gbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICAgIHZhciBhdHRycywgJGVsZW1lbnQsIGksIGlpLCBsaW5rRm4sIGNvbnRyb2xsZXIsIGlzb2xhdGVTY29wZSwgZWxlbWVudENvbnRyb2xsZXJzID0ge30sIHRyYW5zY2x1ZGVGbjsKCiAgICAgICAgICAgIGlmIChjb21waWxlTm9kZSA9PT0gbGlua05vZGUpIHsKICAgICAgICAgICAgICBhdHRycyA9IHRlbXBsYXRlQXR0cnM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXR0cnMgPSBzaGFsbG93Q29weSh0ZW1wbGF0ZUF0dHJzLCBuZXcgQXR0cmlidXRlcyhqcUxpdGUobGlua05vZGUpLCB0ZW1wbGF0ZUF0dHJzLiRhdHRyKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJGVsZW1lbnQgPSBhdHRycy4kJGVsZW1lbnQ7CgogICAgICAgICAgICBpZiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlKSB7CiAgICAgICAgICAgICAgdmFyIExPQ0FMX1JFR0VYUCA9IC9eXHMqKFtAPSZdKShcPz8pXHMqKFx3KilccyokLzsKICAgICAgICAgICAgICB2YXIgJGxpbmtOb2RlID0ganFMaXRlKGxpbmtOb2RlKTsKCiAgICAgICAgICAgICAgaXNvbGF0ZVNjb3BlID0gc2NvcGUuJG5ldyh0cnVlKTsKCiAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlRGlyZWN0aXZlICYmICh0ZW1wbGF0ZURpcmVjdGl2ZSA9PT0gbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlIHx8CiAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9PT0gbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLiQkb3JpZ2luYWxEaXJlY3RpdmUpKSB7CiAgICAgICAgICAgICAgICAkbGlua05vZGUuZGF0YSgnJGlzb2xhdGVTY29wZScsIGlzb2xhdGVTY29wZSkgOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkbGlua05vZGUuZGF0YSgnJGlzb2xhdGVTY29wZU5vVGVtcGxhdGUnLCBpc29sYXRlU2NvcGUpOwogICAgICAgICAgICAgIH0KCgoKICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGxpbmtOb2RlLCAnbmctaXNvbGF0ZS1zY29wZScpOwoKICAgICAgICAgICAgICBmb3JFYWNoKG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS5zY29wZSwgZnVuY3Rpb24oZGVmaW5pdGlvbiwgc2NvcGVOYW1lKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBkZWZpbml0aW9uLm1hdGNoKExPQ0FMX1JFR0VYUCkgfHwgW10sCiAgICAgICAgICAgICAgICAgIGF0dHJOYW1lID0gbWF0Y2hbM10gfHwgc2NvcGVOYW1lLAogICAgICAgICAgICAgICAgICBvcHRpb25hbCA9IChtYXRjaFsyXSA9PSAnPycpLAogICAgICAgICAgICAgICAgICBtb2RlID0gbWF0Y2hbMV0sIC8vIEAsID0sIG9yICYKICAgICAgICAgICAgICAgICAgbGFzdFZhbHVlLAogICAgICAgICAgICAgICAgICBwYXJlbnRHZXQsIHBhcmVudFNldCwgY29tcGFyZTsKCiAgICAgICAgICAgICAgICBpc29sYXRlU2NvcGUuJCRpc29sYXRlQmluZGluZ3Nbc2NvcGVOYW1lXSA9IG1vZGUgKyBhdHRyTmFtZTsKCiAgICAgICAgICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKCiAgICAgICAgICAgICAgICAgIGNhc2UgJ0AnOgogICAgICAgICAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKGF0dHJOYW1lLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgaXNvbGF0ZVNjb3BlW3Njb3BlTmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBhdHRycy4kJG9ic2VydmVyc1thdHRyTmFtZV0uJCRzY29wZSA9IHNjb3BlOwogICAgICAgICAgICAgICAgICAgIGlmKCBhdHRyc1thdHRyTmFtZV0gKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgYXR0cmlidXRlIGhhcyBiZWVuIHByb3ZpZGVkIHRoZW4gd2UgdHJpZ2dlciBhbiBpbnRlcnBvbGF0aW9uIHRvIGVuc3VyZQogICAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHZhbHVlIGlzIHRoZXJlIGZvciB1c2UgaW4gdGhlIGxpbmsgZm4KICAgICAgICAgICAgICAgICAgICAgIGlzb2xhdGVTY29wZVtzY29wZU5hbWVdID0gJGludGVycG9sYXRlKGF0dHJzW2F0dHJOYW1lXSkoc2NvcGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgIGNhc2UgJz0nOgogICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25hbCAmJiAhYXR0cnNbYXR0ck5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRHZXQubGl0ZXJhbCkgewogICAgICAgICAgICAgICAgICAgICAgY29tcGFyZSA9IGVxdWFsczsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgY29tcGFyZSA9IGZ1bmN0aW9uKGEsYikgeyByZXR1cm4gYSA9PT0gYjsgfTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFyZW50U2V0ID0gcGFyZW50R2V0LmFzc2lnbiB8fCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIHJlc2V0IHRoZSBjaGFuZ2UsIG9yIHdlIHdpbGwgdGhyb3cgdGhpcyBleGNlcHRpb24gb24gZXZlcnkgJGRpZ2VzdAogICAgICAgICAgICAgICAgICAgICAgbGFzdFZhbHVlID0gaXNvbGF0ZVNjb3BlW3Njb3BlTmFtZV0gPSBwYXJlbnRHZXQoc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ25vbmFzc2lnbicsCiAgICAgICAgICAgICAgICAgICAgICAgICJFeHByZXNzaW9uICd7MH0nIHVzZWQgd2l0aCBkaXJlY3RpdmUgJ3sxfScgaXMgbm9uLWFzc2lnbmFibGUhIiwKICAgICAgICAgICAgICAgICAgICAgICAgYXR0cnNbYXR0ck5hbWVdLCBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBpc29sYXRlU2NvcGVbc2NvcGVOYW1lXSA9IHBhcmVudEdldChzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgaXNvbGF0ZVNjb3BlLiR3YXRjaChmdW5jdGlvbiBwYXJlbnRWYWx1ZVdhdGNoKCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFZhbHVlID0gcGFyZW50R2V0KHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICAgIGlmICghY29tcGFyZShwYXJlbnRWYWx1ZSwgaXNvbGF0ZVNjb3BlW3Njb3BlTmFtZV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSBvdXQgb2Ygc3luYyBhbmQgbmVlZCB0byBjb3B5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY29tcGFyZShwYXJlbnRWYWx1ZSwgbGFzdFZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBhcmVudCBjaGFuZ2VkIGFuZCBpdCBoYXMgcHJlY2VkZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgIGlzb2xhdGVTY29wZVtzY29wZU5hbWVdID0gcGFyZW50VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHBhcmVudCBjYW4gYmUgYXNzaWduZWQgdGhlbiBkbyBzbwogICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFNldChzY29wZSwgcGFyZW50VmFsdWUgPSBpc29sYXRlU2NvcGVbc2NvcGVOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsYXN0VmFsdWUgPSBwYXJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICB9LCBudWxsLCBwYXJlbnRHZXQubGl0ZXJhbCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICBjYXNlICcmJzoKICAgICAgICAgICAgICAgICAgICBwYXJlbnRHZXQgPSAkcGFyc2UoYXR0cnNbYXR0ck5hbWVdKTsKICAgICAgICAgICAgICAgICAgICBpc29sYXRlU2NvcGVbc2NvcGVOYW1lXSA9IGZ1bmN0aW9uKGxvY2FscykgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudEdldChzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignaXNjcCcsCiAgICAgICAgICAgICAgICAgICAgICAgICJJbnZhbGlkIGlzb2xhdGUgc2NvcGUgZGVmaW5pdGlvbiBmb3IgZGlyZWN0aXZlICd7MH0nLiIgKwogICAgICAgICAgICAgICAgICAgICAgICAiIERlZmluaXRpb246IHsuLi4gezF9OiAnezJ9JyAuLi59IiwKICAgICAgICAgICAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS5uYW1lLCBzY29wZU5hbWUsIGRlZmluaXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyYW5zY2x1ZGVGbiA9IGJvdW5kVHJhbnNjbHVkZUZuICYmIGNvbnRyb2xsZXJzQm91bmRUcmFuc2NsdWRlOwogICAgICAgICAgICBpZiAoY29udHJvbGxlckRpcmVjdGl2ZXMpIHsKICAgICAgICAgICAgICBmb3JFYWNoKGNvbnRyb2xsZXJEaXJlY3RpdmVzLCBmdW5jdGlvbihkaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7CiAgICAgICAgICAgICAgICAgICRzY29wZTogZGlyZWN0aXZlID09PSBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgfHwgZGlyZWN0aXZlLiQkaXNvbGF0ZVNjb3BlID8gaXNvbGF0ZVNjb3BlIDogc2NvcGUsCiAgICAgICAgICAgICAgICAgICRlbGVtZW50OiAkZWxlbWVudCwKICAgICAgICAgICAgICAgICAgJGF0dHJzOiBhdHRycywKICAgICAgICAgICAgICAgICAgJHRyYW5zY2x1ZGU6IHRyYW5zY2x1ZGVGbgogICAgICAgICAgICAgICAgfSwgY29udHJvbGxlckluc3RhbmNlOwoKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBkaXJlY3RpdmUuY29udHJvbGxlcjsKICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVyID09ICdAJykgewogICAgICAgICAgICAgICAgICBjb250cm9sbGVyID0gYXR0cnNbZGlyZWN0aXZlLm5hbWVdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNvbnRyb2xsZXJJbnN0YW5jZSA9ICRjb250cm9sbGVyKGNvbnRyb2xsZXIsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAvLyBGb3IgZGlyZWN0aXZlcyB3aXRoIGVsZW1lbnQgdHJhbnNjbHVzaW9uIHRoZSBlbGVtZW50IGlzIGEgY29tbWVudCwKICAgICAgICAgICAgICAgIC8vIGJ1dCBqUXVlcnkgLmRhdGEgZG9lc24ndCBzdXBwb3J0IGF0dGFjaGluZyBkYXRhIHRvIGNvbW1lbnQgbm9kZXMgYXMgaXQncyBoYXJkIHRvCiAgICAgICAgICAgICAgICAvLyBjbGVhbiB1cCAoaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvODMzNSkuCiAgICAgICAgICAgICAgICAvLyBJbnN0ZWFkLCB3ZSBzYXZlIHRoZSBjb250cm9sbGVycyBmb3IgdGhlIGVsZW1lbnQgaW4gYSBsb2NhbCBoYXNoIGFuZCBhdHRhY2ggdG8gLmRhdGEKICAgICAgICAgICAgICAgIC8vIGxhdGVyLCBvbmNlIHdlIGhhdmUgdGhlIGFjdHVhbCBlbGVtZW50LgogICAgICAgICAgICAgICAgZWxlbWVudENvbnRyb2xsZXJzW2RpcmVjdGl2ZS5uYW1lXSA9IGNvbnRyb2xsZXJJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGlmICghaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuZGF0YSgnJCcgKyBkaXJlY3RpdmUubmFtZSArICdDb250cm9sbGVyJywgY29udHJvbGxlckluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlLmNvbnRyb2xsZXJBcykgewogICAgICAgICAgICAgICAgICBsb2NhbHMuJHNjb3BlW2RpcmVjdGl2ZS5jb250cm9sbGVyQXNdID0gY29udHJvbGxlckluc3RhbmNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQUkVMSU5LSU5HCiAgICAgICAgICAgIGZvcihpID0gMCwgaWkgPSBwcmVMaW5rRm5zLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgbGlua0ZuID0gcHJlTGlua0Zuc1tpXTsKICAgICAgICAgICAgICAgIGxpbmtGbihsaW5rRm4uaXNvbGF0ZVNjb3BlID8gaXNvbGF0ZVNjb3BlIDogc2NvcGUsICRlbGVtZW50LCBhdHRycywKICAgICAgICAgICAgICAgICAgICBsaW5rRm4ucmVxdWlyZSAmJiBnZXRDb250cm9sbGVycyhsaW5rRm4uZGlyZWN0aXZlTmFtZSwgbGlua0ZuLnJlcXVpcmUsICRlbGVtZW50LCBlbGVtZW50Q29udHJvbGxlcnMpLCB0cmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUsIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBSRUNVUlNJT04KICAgICAgICAgICAgLy8gV2Ugb25seSBwYXNzIHRoZSBpc29sYXRlIHNjb3BlLCBpZiB0aGUgaXNvbGF0ZSBkaXJlY3RpdmUgaGFzIGEgdGVtcGxhdGUsCiAgICAgICAgICAgIC8vIG90aGVyd2lzZSB0aGUgY2hpbGQgZWxlbWVudHMgZG8gbm90IGJlbG9uZyB0byB0aGUgaXNvbGF0ZSBkaXJlY3RpdmUuCiAgICAgICAgICAgIHZhciBzY29wZVRvQ2hpbGQgPSBzY29wZTsKICAgICAgICAgICAgaWYgKG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSAmJiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLnRlbXBsYXRlIHx8IG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS50ZW1wbGF0ZVVybCA9PT0gbnVsbCkpIHsKICAgICAgICAgICAgICBzY29wZVRvQ2hpbGQgPSBpc29sYXRlU2NvcGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGRMaW5rRm4gJiYgY2hpbGRMaW5rRm4oc2NvcGVUb0NoaWxkLCBsaW5rTm9kZS5jaGlsZE5vZGVzLCB1bmRlZmluZWQsIGJvdW5kVHJhbnNjbHVkZUZuKTsKCiAgICAgICAgICAgIC8vIFBPU1RMSU5LSU5HCiAgICAgICAgICAgIGZvcihpID0gcG9zdExpbmtGbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgbGlua0ZuID0gcG9zdExpbmtGbnNbaV07CiAgICAgICAgICAgICAgICBsaW5rRm4obGlua0ZuLmlzb2xhdGVTY29wZSA/IGlzb2xhdGVTY29wZSA6IHNjb3BlLCAkZWxlbWVudCwgYXR0cnMsCiAgICAgICAgICAgICAgICAgICAgbGlua0ZuLnJlcXVpcmUgJiYgZ2V0Q29udHJvbGxlcnMobGlua0ZuLmRpcmVjdGl2ZU5hbWUsIGxpbmtGbi5yZXF1aXJlLCAkZWxlbWVudCwgZWxlbWVudENvbnRyb2xsZXJzKSwgdHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVGhpcyBpcyB0aGUgZnVuY3Rpb24gdGhhdCBpcyBpbmplY3RlZCBhcyBgJHRyYW5zY2x1ZGVgLgogICAgICAgICAgICBmdW5jdGlvbiBjb250cm9sbGVyc0JvdW5kVHJhbnNjbHVkZShzY29wZSwgY2xvbmVBdHRhY2hGbikgewogICAgICAgICAgICAgIHZhciB0cmFuc2NsdWRlQ29udHJvbGxlcnM7CgogICAgICAgICAgICAgIC8vIG5vIHNjb3BlIHBhc3NlZAogICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMikgewogICAgICAgICAgICAgICAgY2xvbmVBdHRhY2hGbiA9IHNjb3BlOwogICAgICAgICAgICAgICAgc2NvcGUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICAgIHRyYW5zY2x1ZGVDb250cm9sbGVycyA9IGVsZW1lbnRDb250cm9sbGVyczsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBib3VuZFRyYW5zY2x1ZGVGbihzY29wZSwgY2xvbmVBdHRhY2hGbiwgdHJhbnNjbHVkZUNvbnRyb2xsZXJzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbWFya0RpcmVjdGl2ZXNBc0lzb2xhdGUoZGlyZWN0aXZlcykgewogICAgICAgICAgLy8gbWFyayBhbGwgZGlyZWN0aXZlcyBhcyBuZWVkaW5nIGlzb2xhdGUgc2NvcGUuCiAgICAgICAgICBmb3IgKHZhciBqID0gMCwgamogPSBkaXJlY3RpdmVzLmxlbmd0aDsgaiA8IGpqOyBqKyspIHsKICAgICAgICAgICAgZGlyZWN0aXZlc1tqXSA9IGluaGVyaXQoZGlyZWN0aXZlc1tqXSwgeyQkaXNvbGF0ZVNjb3BlOiB0cnVlfSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBsb29rcyB1cCB0aGUgZGlyZWN0aXZlIGFuZCBkZWNvcmF0ZXMgaXQgd2l0aCBleGNlcHRpb24gaGFuZGxpbmcgYW5kIHByb3BlciBwYXJhbWV0ZXJzLiBXZQogICAgICAgICAqIGNhbGwgdGhpcyB0aGUgYm91bmREaXJlY3RpdmUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBuYW1lIG9mIHRoZSBkaXJlY3RpdmUgdG8gbG9vayB1cC4KICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbG9jYXRpb24gVGhlIGRpcmVjdGl2ZSBtdXN0IGJlIGZvdW5kIGluIHNwZWNpZmljIGZvcm1hdC4KICAgICAgICAgKiAgIFN0cmluZyBjb250YWluaW5nIGFueSBvZiB0aGVzZXMgY2hhcmFjdGVyczoKICAgICAgICAgKgogICAgICAgICAqICAgKiBgRWA6IGVsZW1lbnQgbmFtZQogICAgICAgICAqICAgKiBgQSc6IGF0dHJpYnV0ZQogICAgICAgICAqICAgKiBgQ2A6IGNsYXNzCiAgICAgICAgICogICAqIGBNYDogY29tbWVudAogICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSB0cnVlIGlmIGRpcmVjdGl2ZSB3YXMgYWRkZWQuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gYWRkRGlyZWN0aXZlKHREaXJlY3RpdmVzLCBuYW1lLCBsb2NhdGlvbiwgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSwgc3RhcnRBdHRyTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kQXR0ck5hbWUpIHsKICAgICAgICAgIGlmIChuYW1lID09PSBpZ25vcmVEaXJlY3RpdmUpIHJldHVybiBudWxsOwogICAgICAgICAgdmFyIG1hdGNoID0gbnVsbDsKICAgICAgICAgIGlmIChoYXNEaXJlY3RpdmVzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgIGZvcih2YXIgZGlyZWN0aXZlLCBkaXJlY3RpdmVzID0gJGluamVjdG9yLmdldChuYW1lICsgU3VmZml4KSwKICAgICAgICAgICAgICAgICAgaSA9IDAsIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7IGk8aWk7IGkrKykgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBkaXJlY3RpdmUgPSBkaXJlY3RpdmVzW2ldOwogICAgICAgICAgICAgICAgaWYgKCAobWF4UHJpb3JpdHkgPT09IHVuZGVmaW5lZCB8fCBtYXhQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgJiYKICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLnJlc3RyaWN0LmluZGV4T2YobG9jYXRpb24pICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzdGFydEF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlID0gaW5oZXJpdChkaXJlY3RpdmUsIHskJHN0YXJ0OiBzdGFydEF0dHJOYW1lLCAkJGVuZDogZW5kQXR0ck5hbWV9KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB0RGlyZWN0aXZlcy5wdXNoKGRpcmVjdGl2ZSk7CiAgICAgICAgICAgICAgICAgIG1hdGNoID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2goZSkgeyAkZXhjZXB0aW9uSGFuZGxlcihlKTsgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgfQoKCiAgICAgICAgLyoqCiAgICAgICAgICogV2hlbiB0aGUgZWxlbWVudCBpcyByZXBsYWNlZCB3aXRoIEhUTUwgdGVtcGxhdGUgdGhlbiB0aGUgbmV3IGF0dHJpYnV0ZXMKICAgICAgICAgKiBvbiB0aGUgdGVtcGxhdGUgbmVlZCB0byBiZSBtZXJnZWQgd2l0aCB0aGUgZXhpc3RpbmcgYXR0cmlidXRlcyBpbiB0aGUgRE9NLgogICAgICAgICAqIFRoZSBkZXNpcmVkIGVmZmVjdCBpcyB0byBoYXZlIGJvdGggb2YgdGhlIGF0dHJpYnV0ZXMgcHJlc2VudC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBkc3QgZGVzdGluYXRpb24gYXR0cmlidXRlcyAob3JpZ2luYWwgRE9NKQogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzcmMgc291cmNlIGF0dHJpYnV0ZXMgKGZyb20gdGhlIGRpcmVjdGl2ZSB0ZW1wbGF0ZSkKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBtZXJnZVRlbXBsYXRlQXR0cmlidXRlcyhkc3QsIHNyYykgewogICAgICAgICAgdmFyIHNyY0F0dHIgPSBzcmMuJGF0dHIsCiAgICAgICAgICAgIGRzdEF0dHIgPSBkc3QuJGF0dHIsCiAgICAgICAgICAgICRlbGVtZW50ID0gZHN0LiQkZWxlbWVudDsKCiAgICAgICAgICAvLyByZWFwcGx5IHRoZSBvbGQgYXR0cmlidXRlcyB0byB0aGUgbmV3IGVsZW1lbnQKICAgICAgICAgIGZvckVhY2goZHN0LCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIGlmIChrZXkuY2hhckF0KDApICE9ICckJykgewogICAgICAgICAgICAgIGlmIChzcmNba2V5XSAmJiBzcmNba2V5XSAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhbHVlICs9IChrZXkgPT09ICdzdHlsZScgPyAnOycgOiAnICcpICsgc3JjW2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRzdC4kc2V0KGtleSwgdmFsdWUsIHRydWUsIHNyY0F0dHJba2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIGNvcHkgdGhlIG5ldyBhdHRyaWJ1dGVzIG9uIHRoZSBvbGQgYXR0cnMgb2JqZWN0CiAgICAgICAgICBmb3JFYWNoKHNyYywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgICBpZiAoa2V5ID09ICdjbGFzcycpIHsKICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGVsZW1lbnQsIHZhbHVlKTsKICAgICAgICAgICAgICBkc3RbJ2NsYXNzJ10gPSAoZHN0WydjbGFzcyddID8gZHN0WydjbGFzcyddICsgJyAnIDogJycpICsgdmFsdWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09ICdzdHlsZScpIHsKICAgICAgICAgICAgICAkZWxlbWVudC5hdHRyKCdzdHlsZScsICRlbGVtZW50LmF0dHIoJ3N0eWxlJykgKyAnOycgKyB2YWx1ZSk7CiAgICAgICAgICAgICAgZHN0WydzdHlsZSddID0gKGRzdFsnc3R5bGUnXSA/IGRzdFsnc3R5bGUnXSArICc7JyA6ICcnKSArIHZhbHVlOwogICAgICAgICAgICAgIC8vIGBkc3RgIHdpbGwgbmV2ZXIgY29udGFpbiBoYXNPd25Qcm9wZXJ0eSBhcyBET00gcGFyc2VyIHdvbid0IGxldCBpdC4KICAgICAgICAgICAgICAvLyBZb3Ugd2lsbCBnZXQgYW4gIkludmFsaWRDaGFyYWN0ZXJFcnJvcjogRE9NIEV4Y2VwdGlvbiA1IiBlcnJvciBpZiB5b3UKICAgICAgICAgICAgICAvLyBoYXZlIGFuIGF0dHJpYnV0ZSBsaWtlICJoYXMtb3duLXByb3BlcnR5IiBvciAiZGF0YS1oYXMtb3duLXByb3BlcnR5IiwgZXRjLgogICAgICAgICAgICB9IGVsc2UgaWYgKGtleS5jaGFyQXQoMCkgIT0gJyQnICYmICFkc3QuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgIGRzdFtrZXldID0gdmFsdWU7CiAgICAgICAgICAgICAgZHN0QXR0cltrZXldID0gc3JjQXR0cltrZXldOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CgoKICAgICAgICBmdW5jdGlvbiBjb21waWxlVGVtcGxhdGVVcmwoZGlyZWN0aXZlcywgJGNvbXBpbGVOb2RlLCB0QXR0cnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyb290RWxlbWVudCwgY2hpbGRUcmFuc2NsdWRlRm4sIHByZUxpbmtGbnMsIHBvc3RMaW5rRm5zLCBwcmV2aW91c0NvbXBpbGVDb250ZXh0KSB7CiAgICAgICAgICB2YXIgbGlua1F1ZXVlID0gW10sCiAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuLAogICAgICAgICAgICBhZnRlclRlbXBsYXRlQ2hpbGRMaW5rRm4sCiAgICAgICAgICAgIGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGUgPSAkY29tcGlsZU5vZGVbMF0sCiAgICAgICAgICAgIG9yaWdBc3luY0RpcmVjdGl2ZSA9IGRpcmVjdGl2ZXMuc2hpZnQoKSwKICAgICAgICAgIC8vIFRoZSBmYWN0IHRoYXQgd2UgaGF2ZSB0byBjb3B5IGFuZCBwYXRjaCB0aGUgZGlyZWN0aXZlIHNlZW1zIHdyb25nIQogICAgICAgICAgICBkZXJpdmVkU3luY0RpcmVjdGl2ZSA9IGV4dGVuZCh7fSwgb3JpZ0FzeW5jRGlyZWN0aXZlLCB7CiAgICAgICAgICAgICAgdGVtcGxhdGVVcmw6IG51bGwsIHRyYW5zY2x1ZGU6IG51bGwsIHJlcGxhY2U6IG51bGwsICQkb3JpZ2luYWxEaXJlY3RpdmU6IG9yaWdBc3luY0RpcmVjdGl2ZQogICAgICAgICAgICB9KSwKICAgICAgICAgICAgdGVtcGxhdGVVcmwgPSAoaXNGdW5jdGlvbihvcmlnQXN5bmNEaXJlY3RpdmUudGVtcGxhdGVVcmwpKQogICAgICAgICAgICAgID8gb3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlVXJsKCRjb21waWxlTm9kZSwgdEF0dHJzKQogICAgICAgICAgICAgIDogb3JpZ0FzeW5jRGlyZWN0aXZlLnRlbXBsYXRlVXJsOwoKICAgICAgICAgICRjb21waWxlTm9kZS5lbXB0eSgpOwoKICAgICAgICAgICRodHRwLmdldCgkc2NlLmdldFRydXN0ZWRSZXNvdXJjZVVybCh0ZW1wbGF0ZVVybCksIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS4KICAgICAgICAgICAgc3VjY2VzcyhmdW5jdGlvbihjb250ZW50KSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBpbGVOb2RlLCB0ZW1wVGVtcGxhdGVBdHRycywgJHRlbXBsYXRlLCBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuOwoKICAgICAgICAgICAgICBjb250ZW50ID0gZGVub3JtYWxpemVUZW1wbGF0ZShjb250ZW50KTsKCiAgICAgICAgICAgICAgaWYgKG9yaWdBc3luY0RpcmVjdGl2ZS5yZXBsYWNlKSB7CiAgICAgICAgICAgICAgICBpZiAoanFMaXRlSXNUZXh0Tm9kZShjb250ZW50KSkgewogICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBbXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IGpxTGl0ZSh0cmltKGNvbnRlbnQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gJHRlbXBsYXRlWzBdOwoKICAgICAgICAgICAgICAgIGlmICgkdGVtcGxhdGUubGVuZ3RoICE9IDEgfHwgY29tcGlsZU5vZGUubm9kZVR5cGUgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ3RwbHJ0JywKICAgICAgICAgICAgICAgICAgICAiVGVtcGxhdGUgZm9yIGRpcmVjdGl2ZSAnezB9JyBtdXN0IGhhdmUgZXhhY3RseSBvbmUgcm9vdCBlbGVtZW50LiB7MX0iLAogICAgICAgICAgICAgICAgICAgIG9yaWdBc3luY0RpcmVjdGl2ZS5uYW1lLCB0ZW1wbGF0ZVVybCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGVtcFRlbXBsYXRlQXR0cnMgPSB7JGF0dHI6IHt9fTsKICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKCRyb290RWxlbWVudCwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVEaXJlY3RpdmVzID0gY29sbGVjdERpcmVjdGl2ZXMoY29tcGlsZU5vZGUsIFtdLCB0ZW1wVGVtcGxhdGVBdHRycyk7CgogICAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KG9yaWdBc3luY0RpcmVjdGl2ZS5zY29wZSkpIHsKICAgICAgICAgICAgICAgICAgbWFya0RpcmVjdGl2ZXNBc0lzb2xhdGUodGVtcGxhdGVEaXJlY3RpdmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMgPSB0ZW1wbGF0ZURpcmVjdGl2ZXMuY29uY2F0KGRpcmVjdGl2ZXMpOwogICAgICAgICAgICAgICAgbWVyZ2VUZW1wbGF0ZUF0dHJpYnV0ZXModEF0dHJzLCB0ZW1wVGVtcGxhdGVBdHRycyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbXBpbGVOb2RlID0gYmVmb3JlVGVtcGxhdGVDb21waWxlTm9kZTsKICAgICAgICAgICAgICAgICRjb21waWxlTm9kZS5odG1sKGNvbnRlbnQpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZGlyZWN0aXZlcy51bnNoaWZ0KGRlcml2ZWRTeW5jRGlyZWN0aXZlKTsKCiAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4gPSBhcHBseURpcmVjdGl2ZXNUb05vZGUoZGlyZWN0aXZlcywgY29tcGlsZU5vZGUsIHRBdHRycywKICAgICAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuLCAkY29tcGlsZU5vZGUsIG9yaWdBc3luY0RpcmVjdGl2ZSwgcHJlTGlua0ZucywgcG9zdExpbmtGbnMsCiAgICAgICAgICAgICAgICBwcmV2aW91c0NvbXBpbGVDb250ZXh0KTsKICAgICAgICAgICAgICBmb3JFYWNoKCRyb290RWxlbWVudCwgZnVuY3Rpb24obm9kZSwgaSkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUgPT0gY29tcGlsZU5vZGUpIHsKICAgICAgICAgICAgICAgICAgJHJvb3RFbGVtZW50W2ldID0gJGNvbXBpbGVOb2RlWzBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiA9IGNvbXBpbGVOb2RlcygkY29tcGlsZU5vZGVbMF0uY2hpbGROb2RlcywgY2hpbGRUcmFuc2NsdWRlRm4pOwoKCiAgICAgICAgICAgICAgd2hpbGUobGlua1F1ZXVlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgdmFyIHNjb3BlID0gbGlua1F1ZXVlLnNoaWZ0KCksCiAgICAgICAgICAgICAgICAgIGJlZm9yZVRlbXBsYXRlTGlua05vZGUgPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgICAgbGlua1Jvb3RFbGVtZW50ID0gbGlua1F1ZXVlLnNoaWZ0KCksCiAgICAgICAgICAgICAgICAgIGJvdW5kVHJhbnNjbHVkZUZuID0gbGlua1F1ZXVlLnNoaWZ0KCksCiAgICAgICAgICAgICAgICAgIGxpbmtOb2RlID0gJGNvbXBpbGVOb2RlWzBdOwoKICAgICAgICAgICAgICAgIGlmIChiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlICE9PSBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBvbGRDbGFzc2VzID0gYmVmb3JlVGVtcGxhdGVMaW5rTm9kZS5jbGFzc05hbWU7CgogICAgICAgICAgICAgICAgICBpZiAoIShwcmV2aW91c0NvbXBpbGVDb250ZXh0Lmhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlICYmCiAgICAgICAgICAgICAgICAgICAgb3JpZ0FzeW5jRGlyZWN0aXZlLnJlcGxhY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gaXQgd2FzIGNsb25lZCB0aGVyZWZvcmUgd2UgaGF2ZSB0byBjbG9uZSBhcyB3ZWxsLgogICAgICAgICAgICAgICAgICAgIGxpbmtOb2RlID0ganFMaXRlQ2xvbmUoY29tcGlsZU5vZGUpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICByZXBsYWNlV2l0aChsaW5rUm9vdEVsZW1lbnQsIGpxTGl0ZShiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlKSwgbGlua05vZGUpOwoKICAgICAgICAgICAgICAgICAgLy8gQ29weSBpbiBDU1MgY2xhc3NlcyBmcm9tIG9yaWdpbmFsIG5vZGUKICAgICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKGpxTGl0ZShsaW5rTm9kZSksIG9sZENsYXNzZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuLnRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgICAgICAgY2hpbGRCb3VuZFRyYW5zY2x1ZGVGbiA9IGNyZWF0ZUJvdW5kVHJhbnNjbHVkZUZuKHNjb3BlLCBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbi50cmFuc2NsdWRlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4gPSBib3VuZFRyYW5zY2x1ZGVGbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwgc2NvcGUsIGxpbmtOb2RlLCAkcm9vdEVsZW1lbnQsCiAgICAgICAgICAgICAgICAgIGNoaWxkQm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsaW5rUXVldWUgPSBudWxsOwogICAgICAgICAgICB9KS4KICAgICAgICAgICAgZXJyb3IoZnVuY3Rpb24ocmVzcG9uc2UsIGNvZGUsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCd0cGxvYWQnLCAnRmFpbGVkIHRvIGxvYWQgdGVtcGxhdGU6IHswfScsIGNvbmZpZy51cmwpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gZGVsYXllZE5vZGVMaW5rRm4oaWdub3JlQ2hpbGRMaW5rRm4sIHNjb3BlLCBub2RlLCByb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgaWYgKGxpbmtRdWV1ZSkgewogICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKHNjb3BlKTsKICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChub2RlKTsKICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChyb290RWxlbWVudCk7CiAgICAgICAgICAgICAgbGlua1F1ZXVlLnB1c2goYm91bmRUcmFuc2NsdWRlRm4pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuKGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQoKCiAgICAgICAgLyoqCiAgICAgICAgICogU29ydGluZyBmdW5jdGlvbiBmb3IgYm91bmQgZGlyZWN0aXZlcy4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBieVByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgIHZhciBkaWZmID0gYi5wcmlvcml0eSAtIGEucHJpb3JpdHk7CiAgICAgICAgICBpZiAoZGlmZiAhPT0gMCkgcmV0dXJuIGRpZmY7CiAgICAgICAgICBpZiAoYS5uYW1lICE9PSBiLm5hbWUpIHJldHVybiAoYS5uYW1lIDwgYi5uYW1lKSA/IC0xIDogMTsKICAgICAgICAgIHJldHVybiBhLmluZGV4IC0gYi5pbmRleDsKICAgICAgICB9CgoKICAgICAgICBmdW5jdGlvbiBhc3NlcnROb0R1cGxpY2F0ZSh3aGF0LCBwcmV2aW91c0RpcmVjdGl2ZSwgZGlyZWN0aXZlLCBlbGVtZW50KSB7CiAgICAgICAgICBpZiAocHJldmlvdXNEaXJlY3RpdmUpIHsKICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ211bHRpZGlyJywgJ011bHRpcGxlIGRpcmVjdGl2ZXMgW3swfSwgezF9XSBhc2tpbmcgZm9yIHsyfSBvbjogezN9JywKICAgICAgICAgICAgICBwcmV2aW91c0RpcmVjdGl2ZS5uYW1lLCBkaXJlY3RpdmUubmFtZSwgd2hhdCwgc3RhcnRpbmdUYWcoZWxlbWVudCkpOwogICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIGFkZFRleHRJbnRlcnBvbGF0ZURpcmVjdGl2ZShkaXJlY3RpdmVzLCB0ZXh0KSB7CiAgICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZSh0ZXh0LCB0cnVlKTsKICAgICAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgIGRpcmVjdGl2ZXMucHVzaCh7CiAgICAgICAgICAgICAgcHJpb3JpdHk6IDAsCiAgICAgICAgICAgICAgY29tcGlsZTogdmFsdWVGbihmdW5jdGlvbiB0ZXh0SW50ZXJwb2xhdGVMaW5rRm4oc2NvcGUsIG5vZGUpIHsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBub2RlLnBhcmVudCgpLAogICAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IHBhcmVudC5kYXRhKCckYmluZGluZycpIHx8IFtdOwogICAgICAgICAgICAgICAgYmluZGluZ3MucHVzaChpbnRlcnBvbGF0ZUZuKTsKICAgICAgICAgICAgICAgIHNhZmVBZGRDbGFzcyhwYXJlbnQuZGF0YSgnJGJpbmRpbmcnLCBiaW5kaW5ncyksICduZy1iaW5kaW5nJyk7CiAgICAgICAgICAgICAgICBzY29wZS4kd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVGbldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGVbMF0ubm9kZVZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CgoKICAgICAgICBmdW5jdGlvbiBnZXRUcnVzdGVkQ29udGV4dChub2RlLCBhdHRyTm9ybWFsaXplZE5hbWUpIHsKICAgICAgICAgIGlmIChhdHRyTm9ybWFsaXplZE5hbWUgPT0gInNyY2RvYyIpIHsKICAgICAgICAgICAgcmV0dXJuICRzY2UuSFRNTDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0YWcgPSBub2RlTmFtZV8obm9kZSk7CiAgICAgICAgICAvLyBtYWN0aW9uW3hsaW5rOmhyZWZdIGNhbiBzb3VyY2UgU1ZHLiAgSXQncyBub3QgbGltaXRlZCB0byA8bWFjdGlvbj4uCiAgICAgICAgICBpZiAoYXR0ck5vcm1hbGl6ZWROYW1lID09ICJ4bGlua0hyZWYiIHx8CiAgICAgICAgICAgICh0YWcgPT0gIkZPUk0iICYmIGF0dHJOb3JtYWxpemVkTmFtZSA9PSAiYWN0aW9uIikgfHwKICAgICAgICAgICAgKHRhZyAhPSAiSU1HIiAmJiAoYXR0ck5vcm1hbGl6ZWROYW1lID09ICJzcmMiIHx8CiAgICAgICAgICAgICAgYXR0ck5vcm1hbGl6ZWROYW1lID09ICJuZ1NyYyIpKSkgewogICAgICAgICAgICByZXR1cm4gJHNjZS5SRVNPVVJDRV9VUkw7CiAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgZnVuY3Rpb24gYWRkQXR0ckludGVycG9sYXRlRGlyZWN0aXZlKG5vZGUsIGRpcmVjdGl2ZXMsIHZhbHVlLCBuYW1lKSB7CiAgICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZSh2YWx1ZSwgdHJ1ZSk7CgogICAgICAgICAgLy8gbm8gaW50ZXJwb2xhdGlvbiBmb3VuZCAtPiBpZ25vcmUKICAgICAgICAgIGlmICghaW50ZXJwb2xhdGVGbikgcmV0dXJuOwoKCiAgICAgICAgICBpZiAobmFtZSA9PT0gIm11bHRpcGxlIiAmJiBub2RlTmFtZV8obm9kZSkgPT09ICJTRUxFQ1QiKSB7CiAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCJzZWxtdWx0aSIsCiAgICAgICAgICAgICAgIkJpbmRpbmcgdG8gdGhlICdtdWx0aXBsZScgYXR0cmlidXRlIGlzIG5vdCBzdXBwb3J0ZWQuIEVsZW1lbnQ6IHswfSIsCiAgICAgICAgICAgICAgc3RhcnRpbmdUYWcobm9kZSkpOwogICAgICAgICAgfQoKICAgICAgICAgIGRpcmVjdGl2ZXMucHVzaCh7CiAgICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBwcmU6IGZ1bmN0aW9uIGF0dHJJbnRlcnBvbGF0ZVByZUxpbmtGbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgICAgICB2YXIgJCRvYnNlcnZlcnMgPSAoYXR0ci4kJG9ic2VydmVycyB8fCAoYXR0ci4kJG9ic2VydmVycyA9IHt9KSk7CgogICAgICAgICAgICAgICAgICBpZiAoRVZFTlRfSEFORExFUl9BVFRSX1JFR0VYUC50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ25vZG9tZXZlbnRzJywKICAgICAgICAgICAgICAgICAgICAgICAgIkludGVycG9sYXRpb25zIGZvciBIVE1MIERPTSBldmVudCBhdHRyaWJ1dGVzIGFyZSBkaXNhbGxvd2VkLiAgUGxlYXNlIHVzZSB0aGUgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICJuZy0gdmVyc2lvbnMgKHN1Y2ggYXMgbmctY2xpY2sgaW5zdGVhZCBvZiBvbmNsaWNrKSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGludGVycG9sYXRlIGFnYWluLCBpbiBjYXNlIHRoZSBhdHRyaWJ1dGUgdmFsdWUgaGFzIGJlZW4gdXBkYXRlZAogICAgICAgICAgICAgICAgICAvLyAoZS5nLiBieSBhbm90aGVyIGRpcmVjdGl2ZSdzIGNvbXBpbGUgZnVuY3Rpb24pCiAgICAgICAgICAgICAgICAgIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUoYXR0cltuYW1lXSwgdHJ1ZSwgZ2V0VHJ1c3RlZENvbnRleHQobm9kZSwgbmFtZSkpOwoKICAgICAgICAgICAgICAgICAgLy8gaWYgYXR0cmlidXRlIHdhcyB1cGRhdGVkIHNvIHRoYXQgdGhlcmUgaXMgbm8gaW50ZXJwb2xhdGlvbiBnb2luZyBvbiB3ZSBkb24ndCB3YW50IHRvCiAgICAgICAgICAgICAgICAgIC8vIHJlZ2lzdGVyIGFueSBvYnNlcnZlcnMKICAgICAgICAgICAgICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAvLyBUT0RPKGkpOiB0aGlzIHNob3VsZCBsaWtlbHkgYmUgYXR0ci4kc2V0KG5hbWUsIGl0ZXJwb2xhdGVGbihzY29wZSkgc28gdGhhdCB3ZSByZXNldCB0aGUKICAgICAgICAgICAgICAgICAgLy8gYWN0dWFsIGF0dHIgdmFsdWUKICAgICAgICAgICAgICAgICAgYXR0cltuYW1lXSA9IGludGVycG9sYXRlRm4oc2NvcGUpOwogICAgICAgICAgICAgICAgICAoJCRvYnNlcnZlcnNbbmFtZV0gfHwgKCQkb2JzZXJ2ZXJzW25hbWVdID0gW10pKS4kJGludGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgKGF0dHIuJCRvYnNlcnZlcnMgJiYgYXR0ci4kJG9ic2VydmVyc1tuYW1lXS4kJHNjb3BlIHx8IHNjb3BlKS4KICAgICAgICAgICAgICAgICAgICAkd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVGbldhdGNoQWN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgLy9zcGVjaWFsIGNhc2UgZm9yIGNsYXNzIGF0dHJpYnV0ZSBhZGRpdGlvbiArIHJlbW92YWwKICAgICAgICAgICAgICAgICAgICAgIC8vc28gdGhhdCBjbGFzcyBjaGFuZ2VzIGNhbiB0YXAgaW50byB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAvL2hvb2tzIHByb3ZpZGVkIGJ5IHRoZSAkYW5pbWF0ZSBzZXJ2aWNlLiBCZSBzdXJlIHRvCiAgICAgICAgICAgICAgICAgICAgICAvL3NraXAgYW5pbWF0aW9ucyB3aGVuIHRoZSBmaXJzdCBkaWdlc3Qgb2NjdXJzICh3aGVuCiAgICAgICAgICAgICAgICAgICAgICAvL2JvdGggdGhlIG5ldyBhbmQgdGhlIG9sZCB2YWx1ZXMgYXJlIHRoZSBzYW1lKSBzaW5jZQogICAgICAgICAgICAgICAgICAgICAgLy90aGUgQ1NTIGNsYXNzZXMgYXJlIHRoZSBub24taW50ZXJwb2xhdGVkIHZhbHVlcwogICAgICAgICAgICAgICAgICAgICAgaWYobmFtZSA9PT0gJ2NsYXNzJyAmJiBuZXdWYWx1ZSAhPSBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiR1cGRhdGVDbGFzcyhuZXdWYWx1ZSwgb2xkVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXR0ci4kc2V0KG5hbWUsIG5ld1ZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CgoKICAgICAgICAvKioKICAgICAgICAgKiBUaGlzIGlzIGEgc3BlY2lhbCBqcUxpdGUucmVwbGFjZVdpdGgsIHdoaWNoIGNhbiByZXBsYWNlIGl0ZW1zIHdoaWNoCiAgICAgICAgICogaGF2ZSBubyBwYXJlbnRzLCBwcm92aWRlZCB0aGF0IHRoZSBjb250YWluaW5nIGpxTGl0ZSBjb2xsZWN0aW9uIGlzIHByb3ZpZGVkLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtKcUxpdGU9fSAkcm9vdEVsZW1lbnQgVGhlIHJvb3Qgb2YgdGhlIGNvbXBpbGUgdHJlZS4gVXNlZCBzbyB0aGF0IHdlIGNhbiByZXBsYWNlIG5vZGVzCiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW4gdGhlIHJvb3Qgb2YgdGhlIHRyZWUuCiAgICAgICAgICogQHBhcmFtIHtKcUxpdGV9IGVsZW1lbnRzVG9SZW1vdmUgVGhlIGpxTGl0ZSBlbGVtZW50IHdoaWNoIHdlIGFyZSBnb2luZyB0byByZXBsYWNlLiBXZSBrZWVwCiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIHNoZWxsLCBidXQgcmVwbGFjZSBpdHMgRE9NIG5vZGUgcmVmZXJlbmNlLgogICAgICAgICAqIEBwYXJhbSB7Tm9kZX0gbmV3Tm9kZSBUaGUgbmV3IERPTSBub2RlLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHJlcGxhY2VXaXRoKCRyb290RWxlbWVudCwgZWxlbWVudHNUb1JlbW92ZSwgbmV3Tm9kZSkgewogICAgICAgICAgdmFyIGZpcnN0RWxlbWVudFRvUmVtb3ZlID0gZWxlbWVudHNUb1JlbW92ZVswXSwKICAgICAgICAgICAgcmVtb3ZlQ291bnQgPSBlbGVtZW50c1RvUmVtb3ZlLmxlbmd0aCwKICAgICAgICAgICAgcGFyZW50ID0gZmlyc3RFbGVtZW50VG9SZW1vdmUucGFyZW50Tm9kZSwKICAgICAgICAgICAgaSwgaWk7CgogICAgICAgICAgaWYgKCRyb290RWxlbWVudCkgewogICAgICAgICAgICBmb3IoaSA9IDAsIGlpID0gJHJvb3RFbGVtZW50Lmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICBpZiAoJHJvb3RFbGVtZW50W2ldID09IGZpcnN0RWxlbWVudFRvUmVtb3ZlKSB7CiAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbaSsrXSA9IG5ld05vZGU7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gaSwgajIgPSBqICsgcmVtb3ZlQ291bnQgLSAxLAogICAgICAgICAgICAgICAgICAgICAgIGpqID0gJHJvb3RFbGVtZW50Lmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgaiA8IGpqOyBqKyssIGoyKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKGoyIDwgamopIHsKICAgICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbal0gPSAkcm9vdEVsZW1lbnRbajJdOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSAkcm9vdEVsZW1lbnRbal07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRyb290RWxlbWVudC5sZW5ndGggLT0gcmVtb3ZlQ291bnQgLSAxOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHBhcmVudCkgewogICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKG5ld05vZGUsIGZpcnN0RWxlbWVudFRvUmVtb3ZlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgIGZyYWdtZW50LmFwcGVuZENoaWxkKGZpcnN0RWxlbWVudFRvUmVtb3ZlKTsKICAgICAgICAgIG5ld05vZGVbanFMaXRlLmV4cGFuZG9dID0gZmlyc3RFbGVtZW50VG9SZW1vdmVbanFMaXRlLmV4cGFuZG9dOwogICAgICAgICAgZm9yICh2YXIgayA9IDEsIGtrID0gZWxlbWVudHNUb1JlbW92ZS5sZW5ndGg7IGsgPCBrazsgaysrKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gZWxlbWVudHNUb1JlbW92ZVtrXTsKICAgICAgICAgICAganFMaXRlKGVsZW1lbnQpLnJlbW92ZSgpOyAvLyBtdXN0IGRvIHRoaXMgd2F5IHRvIGNsZWFuIHVwIGV4cGFuZG8KICAgICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgICAgIGRlbGV0ZSBlbGVtZW50c1RvUmVtb3ZlW2tdOwogICAgICAgICAgfQoKICAgICAgICAgIGVsZW1lbnRzVG9SZW1vdmVbMF0gPSBuZXdOb2RlOwogICAgICAgICAgZWxlbWVudHNUb1JlbW92ZS5sZW5ndGggPSAxOwogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIGNsb25lQW5kQW5ub3RhdGVGbihmbiwgYW5ub3RhdGlvbikgewogICAgICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbigpIHsgcmV0dXJuIGZuLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7IH0sIGZuLCBhbm5vdGF0aW9uKTsKICAgICAgICB9CiAgICAgIH1dOwogIH0KCiAgdmFyIFBSRUZJWF9SRUdFWFAgPSAvXih4W1w6XC1fXXxkYXRhW1w6XC1fXSkvaTsKICAvKioKICAgKiBDb252ZXJ0cyBhbGwgYWNjZXB0ZWQgZGlyZWN0aXZlcyBmb3JtYXQgaW50byBwcm9wZXIgZGlyZWN0aXZlIG5hbWUuCiAgICogQWxsIG9mIHRoZXNlIHdpbGwgYmVjb21lICdteURpcmVjdGl2ZSc6CiAgICogICBteTpEaXJlY3RpdmUKICAgKiAgIG15LWRpcmVjdGl2ZQogICAqICAgeC1teS1kaXJlY3RpdmUKICAgKiAgIGRhdGEtbXk6ZGlyZWN0aXZlCiAgICoKICAgKiBBbHNvIHRoZXJlIGlzIHNwZWNpYWwgY2FzZSBmb3IgTW96IHByZWZpeCBzdGFydGluZyB3aXRoIHVwcGVyIGNhc2UgbGV0dGVyLgogICAqIEBwYXJhbSBuYW1lIE5hbWUgdG8gbm9ybWFsaXplCiAgICovCiAgZnVuY3Rpb24gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUpIHsKICAgIHJldHVybiBjYW1lbENhc2UobmFtZS5yZXBsYWNlKFBSRUZJWF9SRUdFWFAsICcnKSk7CiAgfQoKICAvKioKICAgKiBAbmdkb2MgdHlwZQogICAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBIHNoYXJlZCBvYmplY3QgYmV0d2VlbiBkaXJlY3RpdmUgY29tcGlsZSAvIGxpbmtpbmcgZnVuY3Rpb25zIHdoaWNoIGNvbnRhaW5zIG5vcm1hbGl6ZWQgRE9NCiAgICogZWxlbWVudCBhdHRyaWJ1dGVzLiBUaGUgdmFsdWVzIHJlZmxlY3QgY3VycmVudCBiaW5kaW5nIHN0YXRlIGB7eyB9fWAuIFRoZSBub3JtYWxpemF0aW9uIGlzCiAgICogbmVlZGVkIHNpbmNlIGFsbCBvZiB0aGVzZSBhcmUgdHJlYXRlZCBhcyBlcXVpdmFsZW50IGluIEFuZ3VsYXI6CiAgICoKICAgKiBgYGAKICAgKiAgICA8c3BhbiBuZzpiaW5kPSJhIiBuZy1iaW5kPSJhIiBkYXRhLW5nLWJpbmQ9ImEiIHgtbmctYmluZD0iYSI+CiAgICogYGBgCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRhdHRyCiAgICogQHJldHVybnMge29iamVjdH0gQSBtYXAgb2YgRE9NIGVsZW1lbnQgYXR0cmlidXRlIG5hbWVzIHRvIHRoZSBub3JtYWxpemVkIG5hbWUuIFRoaXMgaXMKICAgKiAgICAgICAgICAgICAgICAgICBuZWVkZWQgdG8gZG8gcmV2ZXJzZSBsb29rdXAgZnJvbSBub3JtYWxpemVkIG5hbWUgYmFjayB0byBhY3R1YWwgbmFtZS4KICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyMkc2V0CiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldCBET00gZWxlbWVudCBhdHRyaWJ1dGUgdmFsdWUuCiAgICoKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIE5vcm1hbGl6ZWQgZWxlbWVudCBhdHRyaWJ1dGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gbW9kaWZ5LiBUaGUgbmFtZSBpcwogICAqICAgICAgICAgIHJldmVyc2UtdHJhbnNsYXRlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRhdHRyICRhdHRyfQogICAqICAgICAgICAgIHByb3BlcnR5IHRvIHRoZSBvcmlnaW5hbCBuYW1lLgogICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSB0byBzZXQgdGhlIGF0dHJpYnV0ZSB0by4gVGhlIHZhbHVlIGNhbiBiZSBhbiBpbnRlcnBvbGF0ZWQgc3RyaW5nLgogICAqLwoKCgogIC8qKgogICAqIENsb3N1cmUgY29tcGlsZXIgdHlwZSBpbmZvcm1hdGlvbgogICAqLwoKICBmdW5jdGlvbiBub2Rlc2V0TGlua2luZ0ZuKAogICAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAgIC8qIE5vZGVMaXN0ICovIG5vZGVMaXN0LAogICAgLyogRWxlbWVudCAqLyByb290RWxlbWVudCwKICAgIC8qIGZ1bmN0aW9uKEZ1bmN0aW9uKSAqLyBib3VuZFRyYW5zY2x1ZGVGbgogICAgKXt9CgogIGZ1bmN0aW9uIGRpcmVjdGl2ZUxpbmtpbmdGbigKICAgIC8qIG5vZGVzZXRMaW5raW5nRm4gKi8gbm9kZXNldExpbmtpbmdGbiwKICAgIC8qIGFuZ3VsYXIuU2NvcGUgKi8gc2NvcGUsCiAgICAvKiBOb2RlICovIG5vZGUsCiAgICAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LAogICAgLyogZnVuY3Rpb24oRnVuY3Rpb24pICovIGJvdW5kVHJhbnNjbHVkZUZuCiAgICApe30KCiAgZnVuY3Rpb24gdG9rZW5EaWZmZXJlbmNlKHN0cjEsIHN0cjIpIHsKICAgIHZhciB2YWx1ZXMgPSAnJywKICAgICAgdG9rZW5zMSA9IHN0cjEuc3BsaXQoL1xzKy8pLAogICAgICB0b2tlbnMyID0gc3RyMi5zcGxpdCgvXHMrLyk7CgogICAgb3V0ZXI6CiAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCB0b2tlbnMxLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHRva2VuID0gdG9rZW5zMVtpXTsKICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgdG9rZW5zMi5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYodG9rZW4gPT0gdG9rZW5zMltqXSkgY29udGludWUgb3V0ZXI7CiAgICAgICAgfQogICAgICAgIHZhbHVlcyArPSAodmFsdWVzLmxlbmd0aCA+IDAgPyAnICcgOiAnJykgKyB0b2tlbjsKICAgICAgfQogICAgcmV0dXJuIHZhbHVlczsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBwcm92aWRlcgogICAqIEBuYW1lICRjb250cm9sbGVyUHJvdmlkZXIKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUge0BsaW5rIG5nLiRjb250cm9sbGVyICRjb250cm9sbGVyIHNlcnZpY2V9IGlzIHVzZWQgYnkgQW5ndWxhciB0byBjcmVhdGUgbmV3CiAgICogY29udHJvbGxlcnMuCiAgICoKICAgKiBUaGlzIHByb3ZpZGVyIGFsbG93cyBjb250cm9sbGVyIHJlZ2lzdHJhdGlvbiB2aWEgdGhlCiAgICoge0BsaW5rIG5nLiRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIgcmVnaXN0ZXJ9IG1ldGhvZC4KICAgKi8KICBmdW5jdGlvbiAkQ29udHJvbGxlclByb3ZpZGVyKCkgewogICAgdmFyIGNvbnRyb2xsZXJzID0ge30sCiAgICAgIENOVFJMX1JFRyA9IC9eKFxTKykoXHMrYXNccysoXHcrKSk/JC87CgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGNvbnRyb2xsZXJQcm92aWRlciNyZWdpc3RlcgogICAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBuYW1lIENvbnRyb2xsZXIgbmFtZSwgb3IgYW4gb2JqZWN0IG1hcCBvZiBjb250cm9sbGVycyB3aGVyZSB0aGUga2V5cyBhcmUKICAgICAqICAgIHRoZSBuYW1lcyBhbmQgdGhlIHZhbHVlcyBhcmUgdGhlIGNvbnN0cnVjdG9ycy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258QXJyYXl9IGNvbnN0cnVjdG9yIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZm4gKG9wdGlvbmFsbHkgZGVjb3JhdGVkIHdpdGggREkKICAgICAqICAgIGFubm90YXRpb25zIGluIHRoZSBhcnJheSBub3RhdGlvbikuCiAgICAgKi8KICAgIHRoaXMucmVnaXN0ZXIgPSBmdW5jdGlvbihuYW1lLCBjb25zdHJ1Y3RvcikgewogICAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCAnY29udHJvbGxlcicpOwogICAgICBpZiAoaXNPYmplY3QobmFtZSkpIHsKICAgICAgICBleHRlbmQoY29udHJvbGxlcnMsIG5hbWUpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnRyb2xsZXJzW25hbWVdID0gY29uc3RydWN0b3I7CiAgICAgIH0KICAgIH07CgoKICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgJyR3aW5kb3cnLCBmdW5jdGlvbigkaW5qZWN0b3IsICR3aW5kb3cpIHsKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICAgKiBAbmFtZSAkY29udHJvbGxlcgogICAgICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb258c3RyaW5nfSBjb25zdHJ1Y3RvciBJZiBjYWxsZWQgd2l0aCBhIGZ1bmN0aW9uIHRoZW4gaXQncyBjb25zaWRlcmVkIHRvIGJlIHRoZQogICAgICAgKiAgICBjb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBPdGhlcndpc2UgaXQncyBjb25zaWRlcmVkIHRvIGJlIGEgc3RyaW5nIHdoaWNoIGlzIHVzZWQKICAgICAgICogICAgdG8gcmV0cmlldmUgdGhlIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgdXNpbmcgdGhlIGZvbGxvd2luZyBzdGVwczoKICAgICAgICoKICAgICAgICogICAgKiBjaGVjayBpZiBhIGNvbnRyb2xsZXIgd2l0aCBnaXZlbiBuYW1lIGlzIHJlZ2lzdGVyZWQgdmlhIGAkY29udHJvbGxlclByb3ZpZGVyYAogICAgICAgKiAgICAqIGNoZWNrIGlmIGV2YWx1YXRpbmcgdGhlIHN0cmluZyBvbiB0aGUgY3VycmVudCBzY29wZSByZXR1cm5zIGEgY29uc3RydWN0b3IKICAgICAgICogICAgKiBjaGVjayBgd2luZG93W2NvbnN0cnVjdG9yXWAgb24gdGhlIGdsb2JhbCBgd2luZG93YCBvYmplY3QKICAgICAgICoKICAgICAgICogQHBhcmFtIHtPYmplY3R9IGxvY2FscyBJbmplY3Rpb24gbG9jYWxzIGZvciBDb250cm9sbGVyLgogICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEluc3RhbmNlIG9mIGdpdmVuIGNvbnRyb2xsZXIuCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBgJGNvbnRyb2xsZXJgIHNlcnZpY2UgaXMgcmVzcG9uc2libGUgZm9yIGluc3RhbnRpYXRpbmcgY29udHJvbGxlcnMuCiAgICAgICAqCiAgICAgICAqIEl0J3MganVzdCBhIHNpbXBsZSBjYWxsIHRvIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LCBidXQgZXh0cmFjdGVkIGludG8KICAgICAgICogYSBzZXJ2aWNlLCBzbyB0aGF0IG9uZSBjYW4gb3ZlcnJpZGUgdGhpcyBzZXJ2aWNlIHdpdGggW0JDIHZlcnNpb25dKGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzE2NDk3ODgpLgogICAgICAgKi8KICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGxvY2FscykgewogICAgICAgIHZhciBpbnN0YW5jZSwgbWF0Y2gsIGNvbnN0cnVjdG9yLCBpZGVudGlmaWVyOwoKICAgICAgICBpZihpc1N0cmluZyhleHByZXNzaW9uKSkgewogICAgICAgICAgbWF0Y2ggPSBleHByZXNzaW9uLm1hdGNoKENOVFJMX1JFRyksCiAgICAgICAgICAgIGNvbnN0cnVjdG9yID0gbWF0Y2hbMV0sCiAgICAgICAgICAgIGlkZW50aWZpZXIgPSBtYXRjaFszXTsKICAgICAgICAgIGV4cHJlc3Npb24gPSBjb250cm9sbGVycy5oYXNPd25Qcm9wZXJ0eShjb25zdHJ1Y3RvcikKICAgICAgICAgICAgPyBjb250cm9sbGVyc1tjb25zdHJ1Y3Rvcl0KICAgICAgICAgICAgOiBnZXR0ZXIobG9jYWxzLiRzY29wZSwgY29uc3RydWN0b3IsIHRydWUpIHx8IGdldHRlcigkd2luZG93LCBjb25zdHJ1Y3RvciwgdHJ1ZSk7CgogICAgICAgICAgYXNzZXJ0QXJnRm4oZXhwcmVzc2lvbiwgY29uc3RydWN0b3IsIHRydWUpOwogICAgICAgIH0KCiAgICAgICAgaW5zdGFuY2UgPSAkaW5qZWN0b3IuaW5zdGFudGlhdGUoZXhwcmVzc2lvbiwgbG9jYWxzKTsKCiAgICAgICAgaWYgKGlkZW50aWZpZXIpIHsKICAgICAgICAgIGlmICghKGxvY2FscyAmJiB0eXBlb2YgbG9jYWxzLiRzY29wZSA9PSAnb2JqZWN0JykpIHsKICAgICAgICAgICAgdGhyb3cgbWluRXJyKCckY29udHJvbGxlcicpKCdub3NjcCcsCiAgICAgICAgICAgICAgIkNhbm5vdCBleHBvcnQgY29udHJvbGxlciAnezB9JyBhcyAnezF9JyEgTm8gJHNjb3BlIG9iamVjdCBwcm92aWRlZCB2aWEgYGxvY2Fsc2AuIiwKICAgICAgICAgICAgICAgIGNvbnN0cnVjdG9yIHx8IGV4cHJlc3Npb24ubmFtZSwgaWRlbnRpZmllcik7CiAgICAgICAgICB9CgogICAgICAgICAgbG9jYWxzLiRzY29wZVtpZGVudGlmaWVyXSA9IGluc3RhbmNlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICB9OwogICAgfV07CiAgfQoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRkb2N1bWVudAogICAqIEByZXF1aXJlcyAkd2luZG93CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBIHtAbGluayBhbmd1bGFyLmVsZW1lbnQgalF1ZXJ5IG9yIGpxTGl0ZX0gd3JhcHBlciBmb3IgdGhlIGJyb3dzZXIncyBgd2luZG93LmRvY3VtZW50YCBvYmplY3QuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iTWFpbkN0cmwiPgogICA8cD4kZG9jdW1lbnQgdGl0bGU6IDxiIG5nLWJpbmQ9InRpdGxlIj48L2I+PC9wPgogICA8cD53aW5kb3cuZG9jdW1lbnQgdGl0bGU6IDxiIG5nLWJpbmQ9IndpbmRvd1RpdGxlIj48L2I+PC9wPgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICBmdW5jdGlvbiBNYWluQ3RybCgkc2NvcGUsICRkb2N1bWVudCkgewogICAgICAgICAkc2NvcGUudGl0bGUgPSAkZG9jdW1lbnRbMF0udGl0bGU7CiAgICAgICAgICRzY29wZS53aW5kb3dUaXRsZSA9IGFuZ3VsYXIuZWxlbWVudCh3aW5kb3cuZG9jdW1lbnQpWzBdLnRpdGxlOwogICAgICAgfQogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICBmdW5jdGlvbiAkRG9jdW1lbnRQcm92aWRlcigpewogICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgZnVuY3Rpb24od2luZG93KXsKICAgICAgcmV0dXJuIGpxTGl0ZSh3aW5kb3cuZG9jdW1lbnQpOwogICAgfV07CiAgfQoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRleGNlcHRpb25IYW5kbGVyCiAgICogQHJlcXVpcmVzIG5nLiRsb2cKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEFueSB1bmNhdWdodCBleGNlcHRpb24gaW4gYW5ndWxhciBleHByZXNzaW9ucyBpcyBkZWxlZ2F0ZWQgdG8gdGhpcyBzZXJ2aWNlLgogICAqIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIHNpbXBseSBkZWxlZ2F0ZXMgdG8gYCRsb2cuZXJyb3JgIHdoaWNoIGxvZ3MgaXQgaW50bwogICAqIHRoZSBicm93c2VyIGNvbnNvbGUuCiAgICoKICAgKiBJbiB1bml0IHRlc3RzLCBpZiBgYW5ndWxhci1tb2Nrcy5qc2AgaXMgbG9hZGVkLCB0aGlzIHNlcnZpY2UgaXMgb3ZlcnJpZGRlbiBieQogICAqIHtAbGluayBuZ01vY2suJGV4Y2VwdGlvbkhhbmRsZXIgbW9jayAkZXhjZXB0aW9uSGFuZGxlcn0gd2hpY2ggYWlkcyBpbiB0ZXN0aW5nLgogICAqCiAgICogIyMgRXhhbXBsZToKICAgKgogICAqIGBgYGpzCiAgICogICBhbmd1bGFyLm1vZHVsZSgnZXhjZXB0aW9uT3ZlcnJpZGUnLCBbXSkuZmFjdG9yeSgnJGV4Y2VwdGlvbkhhbmRsZXInLCBmdW5jdGlvbiAoKSB7CiAqICAgICByZXR1cm4gZnVuY3Rpb24gKGV4Y2VwdGlvbiwgY2F1c2UpIHsKICogICAgICAgZXhjZXB0aW9uLm1lc3NhZ2UgKz0gJyAoY2F1c2VkIGJ5ICInICsgY2F1c2UgKyAnIiknOwogKiAgICAgICB0aHJvdyBleGNlcHRpb247CiAqICAgICB9OwogKiAgIH0pOwogICAqIGBgYAogICAqCiAgICogVGhpcyBleGFtcGxlIHdpbGwgb3ZlcnJpZGUgdGhlIG5vcm1hbCBhY3Rpb24gb2YgYCRleGNlcHRpb25IYW5kbGVyYCwgdG8gbWFrZSBhbmd1bGFyCiAgICogZXhjZXB0aW9ucyBmYWlsIGhhcmQgd2hlbiB0aGV5IGhhcHBlbiwgaW5zdGVhZCBvZiBqdXN0IGxvZ2dpbmcgdG8gdGhlIGNvbnNvbGUuCiAgICoKICAgKiBAcGFyYW0ge0Vycm9yfSBleGNlcHRpb24gRXhjZXB0aW9uIGFzc29jaWF0ZWQgd2l0aCB0aGUgZXJyb3IuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBjYXVzZSBvcHRpb25hbCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY29udGV4dCBpbiB3aGljaAogICAqICAgICAgIHRoZSBlcnJvciB3YXMgdGhyb3duLgogICAqCiAgICovCiAgZnVuY3Rpb24gJEV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlcigpIHsKICAgIHRoaXMuJGdldCA9IFsnJGxvZycsIGZ1bmN0aW9uKCRsb2cpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV4Y2VwdGlvbiwgY2F1c2UpIHsKICAgICAgICAkbG9nLmVycm9yLmFwcGx5KCRsb2csIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9XTsKICB9CgogIC8qKgogICAqIFBhcnNlIGhlYWRlcnMgaW50byBrZXkgdmFsdWUgb2JqZWN0CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaGVhZGVycyBSYXcgaGVhZGVycyBhcyBhIHN0cmluZwogICAqIEByZXR1cm5zIHtPYmplY3R9IFBhcnNlZCBoZWFkZXJzIGFzIGtleSB2YWx1ZSBvYmplY3QKICAgKi8KICBmdW5jdGlvbiBwYXJzZUhlYWRlcnMoaGVhZGVycykgewogICAgdmFyIHBhcnNlZCA9IHt9LCBrZXksIHZhbCwgaTsKCiAgICBpZiAoIWhlYWRlcnMpIHJldHVybiBwYXJzZWQ7CgogICAgZm9yRWFjaChoZWFkZXJzLnNwbGl0KCdcbicpLCBmdW5jdGlvbihsaW5lKSB7CiAgICAgIGkgPSBsaW5lLmluZGV4T2YoJzonKTsKICAgICAga2V5ID0gbG93ZXJjYXNlKHRyaW0obGluZS5zdWJzdHIoMCwgaSkpKTsKICAgICAgdmFsID0gdHJpbShsaW5lLnN1YnN0cihpICsgMSkpOwoKICAgICAgaWYgKGtleSkgewogICAgICAgIGlmIChwYXJzZWRba2V5XSkgewogICAgICAgICAgcGFyc2VkW2tleV0gKz0gJywgJyArIHZhbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGFyc2VkW2tleV0gPSB2YWw7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICByZXR1cm4gcGFyc2VkOwogIH0KCgogIC8qKgogICAqIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHByb3ZpZGVzIGFjY2VzcyB0byBwYXJzZWQgaGVhZGVycy4KICAgKgogICAqIEhlYWRlcnMgYXJlIGxhenkgcGFyc2VkIHdoZW4gZmlyc3QgcmVxdWVzdGVkLgogICAqIEBzZWUgcGFyc2VIZWFkZXJzCiAgICoKICAgKiBAcGFyYW0geyhzdHJpbmd8T2JqZWN0KX0gaGVhZGVycyBIZWFkZXJzIHRvIHByb3ZpZGUgYWNjZXNzIHRvLgogICAqIEByZXR1cm5zIHtmdW5jdGlvbihzdHJpbmc9KX0gUmV0dXJucyBhIGdldHRlciBmdW5jdGlvbiB3aGljaCBpZiBjYWxsZWQgd2l0aDoKICAgKgogICAqICAgLSBpZiBjYWxsZWQgd2l0aCBzaW5nbGUgYW4gYXJndW1lbnQgcmV0dXJucyBhIHNpbmdsZSBoZWFkZXIgdmFsdWUgb3IgbnVsbAogICAqICAgLSBpZiBjYWxsZWQgd2l0aCBubyBhcmd1bWVudHMgcmV0dXJucyBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgaGVhZGVycy4KICAgKi8KICBmdW5jdGlvbiBoZWFkZXJzR2V0dGVyKGhlYWRlcnMpIHsKICAgIHZhciBoZWFkZXJzT2JqID0gaXNPYmplY3QoaGVhZGVycykgPyBoZWFkZXJzIDogdW5kZWZpbmVkOwoKICAgIHJldHVybiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghaGVhZGVyc09iaikgaGVhZGVyc09iaiA9ICBwYXJzZUhlYWRlcnMoaGVhZGVycyk7CgogICAgICBpZiAobmFtZSkgewogICAgICAgIHJldHVybiBoZWFkZXJzT2JqW2xvd2VyY2FzZShuYW1lKV0gfHwgbnVsbDsKICAgICAgfQoKICAgICAgcmV0dXJuIGhlYWRlcnNPYmo7CiAgICB9OwogIH0KCgogIC8qKgogICAqIENoYWluIGFsbCBnaXZlbiBmdW5jdGlvbnMKICAgKgogICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgYm90aCByZXF1ZXN0IGFuZCByZXNwb25zZSB0cmFuc2Zvcm1pbmcKICAgKgogICAqIEBwYXJhbSB7Kn0gZGF0YSBEYXRhIHRvIHRyYW5zZm9ybS4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHN0cmluZz0pfSBoZWFkZXJzIEh0dHAgaGVhZGVycyBnZXR0ZXIgZm4uCiAgICogQHBhcmFtIHsoRnVuY3Rpb258QXJyYXkuPEZ1bmN0aW9uPil9IGZucyBGdW5jdGlvbiBvciBhbiBhcnJheSBvZiBmdW5jdGlvbnMuCiAgICogQHJldHVybnMgeyp9IFRyYW5zZm9ybWVkIGRhdGEuCiAgICovCiAgZnVuY3Rpb24gdHJhbnNmb3JtRGF0YShkYXRhLCBoZWFkZXJzLCBmbnMpIHsKICAgIGlmIChpc0Z1bmN0aW9uKGZucykpCiAgICAgIHJldHVybiBmbnMoZGF0YSwgaGVhZGVycyk7CgogICAgZm9yRWFjaChmbnMsIGZ1bmN0aW9uKGZuKSB7CiAgICAgIGRhdGEgPSBmbihkYXRhLCBoZWFkZXJzKTsKICAgIH0pOwoKICAgIHJldHVybiBkYXRhOwogIH0KCgogIGZ1bmN0aW9uIGlzU3VjY2VzcyhzdGF0dXMpIHsKICAgIHJldHVybiAyMDAgPD0gc3RhdHVzICYmIHN0YXR1cyA8IDMwMDsKICB9CgoKICBmdW5jdGlvbiAkSHR0cFByb3ZpZGVyKCkgewogICAgdmFyIEpTT05fU1RBUlQgPSAvXlxzKihcW3xce1teXHtdKS8sCiAgICAgIEpTT05fRU5EID0gL1tcfVxdXVxzKiQvLAogICAgICBQUk9URUNUSU9OX1BSRUZJWCA9IC9eXClcXVx9Jyw/XG4vLAogICAgICBDT05URU5UX1RZUEVfQVBQTElDQVRJT05fSlNPTiA9IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOCd9OwoKICAgIHZhciBkZWZhdWx0cyA9IHRoaXMuZGVmYXVsdHMgPSB7CiAgICAgIC8vIHRyYW5zZm9ybSBpbmNvbWluZyByZXNwb25zZSBkYXRhCiAgICAgIHRyYW5zZm9ybVJlc3BvbnNlOiBbZnVuY3Rpb24oZGF0YSkgewogICAgICAgIGlmIChpc1N0cmluZyhkYXRhKSkgewogICAgICAgICAgLy8gc3RyaXAganNvbiB2dWxuZXJhYmlsaXR5IHByb3RlY3Rpb24gcHJlZml4CiAgICAgICAgICBkYXRhID0gZGF0YS5yZXBsYWNlKFBST1RFQ1RJT05fUFJFRklYLCAnJyk7CiAgICAgICAgICBpZiAoSlNPTl9TVEFSVC50ZXN0KGRhdGEpICYmIEpTT05fRU5ELnRlc3QoZGF0YSkpCiAgICAgICAgICAgIGRhdGEgPSBmcm9tSnNvbihkYXRhKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgIH1dLAoKICAgICAgLy8gdHJhbnNmb3JtIG91dGdvaW5nIHJlcXVlc3QgZGF0YQogICAgICB0cmFuc2Zvcm1SZXF1ZXN0OiBbZnVuY3Rpb24oZCkgewogICAgICAgIHJldHVybiBpc09iamVjdChkKSAmJiAhaXNGaWxlKGQpICYmICFpc0Jsb2IoZCkgPyB0b0pzb24oZCkgOiBkOwogICAgICB9XSwKCiAgICAgIC8vIGRlZmF1bHQgaGVhZGVycwogICAgICBoZWFkZXJzOiB7CiAgICAgICAgY29tbW9uOiB7CiAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24sIHRleHQvcGxhaW4sICovKicKICAgICAgICB9LAogICAgICAgIHBvc3Q6ICAgc2hhbGxvd0NvcHkoQ09OVEVOVF9UWVBFX0FQUExJQ0FUSU9OX0pTT04pLAogICAgICAgIHB1dDogICAgc2hhbGxvd0NvcHkoQ09OVEVOVF9UWVBFX0FQUExJQ0FUSU9OX0pTT04pLAogICAgICAgIHBhdGNoOiAgc2hhbGxvd0NvcHkoQ09OVEVOVF9UWVBFX0FQUExJQ0FUSU9OX0pTT04pCiAgICAgIH0sCgogICAgICB4c3JmQ29va2llTmFtZTogJ1hTUkYtVE9LRU4nLAogICAgICB4c3JmSGVhZGVyTmFtZTogJ1gtWFNSRi1UT0tFTicKICAgIH07CgogICAgLyoqCiAgICAgKiBBcmUgb3JkZXJlZCBieSByZXF1ZXN0LCBpLmUuIHRoZXkgYXJlIGFwcGxpZWQgaW4gdGhlIHNhbWUgb3JkZXIgYXMgdGhlCiAgICAgKiBhcnJheSwgb24gcmVxdWVzdCwgYnV0IHJldmVyc2Ugb3JkZXIsIG9uIHJlc3BvbnNlLgogICAgICovCiAgICB2YXIgaW50ZXJjZXB0b3JGYWN0b3JpZXMgPSB0aGlzLmludGVyY2VwdG9ycyA9IFtdOwoKICAgIC8qKgogICAgICogRm9yIGhpc3RvcmljYWwgcmVhc29ucywgcmVzcG9uc2UgaW50ZXJjZXB0b3JzIGFyZSBvcmRlcmVkIGJ5IHRoZSBvcmRlciBpbiB3aGljaAogICAgICogdGhleSBhcmUgYXBwbGllZCB0byB0aGUgcmVzcG9uc2UuIChUaGlzIGlzIHRoZSBvcHBvc2l0ZSBvZiBpbnRlcmNlcHRvckZhY3RvcmllcykKICAgICAqLwogICAgdmFyIHJlc3BvbnNlSW50ZXJjZXB0b3JGYWN0b3JpZXMgPSB0aGlzLnJlc3BvbnNlSW50ZXJjZXB0b3JzID0gW107CgogICAgdGhpcy4kZ2V0ID0gWyckaHR0cEJhY2tlbmQnLCAnJGJyb3dzZXInLCAnJGNhY2hlRmFjdG9yeScsICckcm9vdFNjb3BlJywgJyRxJywgJyRpbmplY3RvcicsCiAgICAgIGZ1bmN0aW9uKCRodHRwQmFja2VuZCwgJGJyb3dzZXIsICRjYWNoZUZhY3RvcnksICRyb290U2NvcGUsICRxLCAkaW5qZWN0b3IpIHsKCiAgICAgICAgdmFyIGRlZmF1bHRDYWNoZSA9ICRjYWNoZUZhY3RvcnkoJyRodHRwJyk7CgogICAgICAgIC8qKgogICAgICAgICAqIEludGVyY2VwdG9ycyBzdG9yZWQgaW4gcmV2ZXJzZSBvcmRlci4gSW5uZXIgaW50ZXJjZXB0b3JzIGJlZm9yZSBvdXRlciBpbnRlcmNlcHRvcnMuCiAgICAgICAgICogVGhlIHJldmVyc2FsIGlzIG5lZWRlZCBzbyB0aGF0IHdlIGNhbiBidWlsZCB1cCB0aGUgaW50ZXJjZXB0aW9uIGNoYWluIGFyb3VuZCB0aGUKICAgICAgICAgKiBzZXJ2ZXIgcmVxdWVzdC4KICAgICAgICAgKi8KICAgICAgICB2YXIgcmV2ZXJzZWRJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICAgICAgZm9yRWFjaChpbnRlcmNlcHRvckZhY3RvcmllcywgZnVuY3Rpb24oaW50ZXJjZXB0b3JGYWN0b3J5KSB7CiAgICAgICAgICByZXZlcnNlZEludGVyY2VwdG9ycy51bnNoaWZ0KGlzU3RyaW5nKGludGVyY2VwdG9yRmFjdG9yeSkKICAgICAgICAgICAgPyAkaW5qZWN0b3IuZ2V0KGludGVyY2VwdG9yRmFjdG9yeSkgOiAkaW5qZWN0b3IuaW52b2tlKGludGVyY2VwdG9yRmFjdG9yeSkpOwogICAgICAgIH0pOwoKICAgICAgICBmb3JFYWNoKHJlc3BvbnNlSW50ZXJjZXB0b3JGYWN0b3JpZXMsIGZ1bmN0aW9uKGludGVyY2VwdG9yRmFjdG9yeSwgaW5kZXgpIHsKICAgICAgICAgIHZhciByZXNwb25zZUZuID0gaXNTdHJpbmcoaW50ZXJjZXB0b3JGYWN0b3J5KQogICAgICAgICAgICA/ICRpbmplY3Rvci5nZXQoaW50ZXJjZXB0b3JGYWN0b3J5KQogICAgICAgICAgICA6ICRpbmplY3Rvci5pbnZva2UoaW50ZXJjZXB0b3JGYWN0b3J5KTsKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIFJlc3BvbnNlIGludGVyY2VwdG9ycyBnbyBiZWZvcmUgImFyb3VuZCIgaW50ZXJjZXB0b3JzIChubyByZWFsIHJlYXNvbiwganVzdAogICAgICAgICAgICogaGFkIHRvIHBpY2sgb25lLikgQnV0IHRoZXkgYXJlIGFscmVhZHkgcmV2ZXJzZWQsIHNvIHdlIGNhbid0IHVzZSB1bnNoaWZ0LCBoZW5jZQogICAgICAgICAgICogdGhlIHNwbGljZS4KICAgICAgICAgICAqLwogICAgICAgICAgcmV2ZXJzZWRJbnRlcmNlcHRvcnMuc3BsaWNlKGluZGV4LCAwLCB7CiAgICAgICAgICAgIHJlc3BvbnNlOiBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgIHJldHVybiByZXNwb25zZUZuKCRxLndoZW4ocmVzcG9uc2UpKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcmVzcG9uc2VFcnJvcjogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VGbigkcS5yZWplY3QocmVzcG9uc2UpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgJGh0dHAKICAgICAgICAgKiBAcmVxdWlyZXMgbmcuJGh0dHBCYWNrZW5kCiAgICAgICAgICogQHJlcXVpcmVzICRjYWNoZUZhY3RvcnkKICAgICAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICAgICAqIEByZXF1aXJlcyAkcQogICAgICAgICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoZSBgJGh0dHBgIHNlcnZpY2UgaXMgYSBjb3JlIEFuZ3VsYXIgc2VydmljZSB0aGF0IGZhY2lsaXRhdGVzIGNvbW11bmljYXRpb24gd2l0aCB0aGUgcmVtb3RlCiAgICAgICAgICogSFRUUCBzZXJ2ZXJzIHZpYSB0aGUgYnJvd3NlcidzIFtYTUxIdHRwUmVxdWVzdF0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4veG1saHR0cHJlcXVlc3QpCiAgICAgICAgICogb2JqZWN0IG9yIHZpYSBbSlNPTlBdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvSlNPTlApLgogICAgICAgICAqCiAgICAgICAgICogRm9yIHVuaXQgdGVzdGluZyBhcHBsaWNhdGlvbnMgdGhhdCB1c2UgYCRodHRwYCBzZXJ2aWNlLCBzZWUKICAgICAgICAgKiB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCAkaHR0cEJhY2tlbmQgbW9ja30uCiAgICAgICAgICoKICAgICAgICAgKiBGb3IgYSBoaWdoZXIgbGV2ZWwgb2YgYWJzdHJhY3Rpb24sIHBsZWFzZSBjaGVjayBvdXQgdGhlIHtAbGluayBuZ1Jlc291cmNlLiRyZXNvdXJjZQogICAgICogJHJlc291cmNlfSBzZXJ2aWNlLgogICAgICAgICAqCiAgICAgICAgICogVGhlICRodHRwIEFQSSBpcyBiYXNlZCBvbiB0aGUge0BsaW5rIG5nLiRxIGRlZmVycmVkL3Byb21pc2UgQVBJc30gZXhwb3NlZCBieQogICAgICAgICAqIHRoZSAkcSBzZXJ2aWNlLiBXaGlsZSBmb3Igc2ltcGxlIHVzYWdlIHBhdHRlcm5zIHRoaXMgZG9lc24ndCBtYXR0ZXIgbXVjaCwgZm9yIGFkdmFuY2VkIHVzYWdlCiAgICAgICAgICogaXQgaXMgaW1wb3J0YW50IHRvIGZhbWlsaWFyaXplIHlvdXJzZWxmIHdpdGggdGhlc2UgQVBJcyBhbmQgdGhlIGd1YXJhbnRlZXMgdGhleSBwcm92aWRlLgogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiAjIEdlbmVyYWwgdXNhZ2UKICAgICAgICAgKiBUaGUgYCRodHRwYCBzZXJ2aWNlIGlzIGEgZnVuY3Rpb24gd2hpY2ggdGFrZXMgYSBzaW5nbGUgYXJndW1lbnQg4oCUIGEgY29uZmlndXJhdGlvbiBvYmplY3Qg4oCUCiAgICAgICAgICogdGhhdCBpcyB1c2VkIHRvIGdlbmVyYXRlIGFuIEhUVFAgcmVxdWVzdCBhbmQgcmV0dXJucyAgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0KICAgICAgICAgKiB3aXRoIHR3byAkaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuCiAgICAgICAgICoKICAgICAgICAgKiBgYGBqcwogICAgICAgICAqICAgJGh0dHAoe21ldGhvZDogJ0dFVCcsIHVybDogJy9zb21lVXJsJ30pLgogICAgICAgICAqICAgICBzdWNjZXNzKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cywgaGVhZGVycywgY29uZmlnKSB7CiAgICAgKiAgICAgICAvLyB0aGlzIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGFzeW5jaHJvbm91c2x5CiAgICAgKiAgICAgICAvLyB3aGVuIHRoZSByZXNwb25zZSBpcyBhdmFpbGFibGUKICAgICAqICAgICB9KS4KICAgICAgICAgKiAgICAgZXJyb3IoZnVuY3Rpb24oZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAqICAgICAgIC8vIGNhbGxlZCBhc3luY2hyb25vdXNseSBpZiBhbiBlcnJvciBvY2N1cnMKICAgICAqICAgICAgIC8vIG9yIHNlcnZlciByZXR1cm5zIHJlc3BvbnNlIHdpdGggYW4gZXJyb3Igc3RhdHVzLgogICAgICogICAgIH0pOwogICAgICAgICAqIGBgYAogICAgICAgICAqCiAgICAgICAgICogU2luY2UgdGhlIHJldHVybmVkIHZhbHVlIG9mIGNhbGxpbmcgdGhlICRodHRwIGZ1bmN0aW9uIGlzIGEgYHByb21pc2VgLCB5b3UgY2FuIGFsc28gdXNlCiAgICAgICAgICogdGhlIGB0aGVuYCBtZXRob2QgdG8gcmVnaXN0ZXIgY2FsbGJhY2tzLCBhbmQgdGhlc2UgY2FsbGJhY2tzIHdpbGwgcmVjZWl2ZSBhIHNpbmdsZSBhcmd1bWVudCDigJMKICAgICAgICAgKiBhbiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZXNwb25zZS4gU2VlIHRoZSBBUEkgc2lnbmF0dXJlIGFuZCB0eXBlIGluZm8gYmVsb3cgZm9yIG1vcmUKICAgICAgICAgKiBkZXRhaWxzLgogICAgICAgICAqCiAgICAgICAgICogQSByZXNwb25zZSBzdGF0dXMgY29kZSBiZXR3ZWVuIDIwMCBhbmQgMjk5IGlzIGNvbnNpZGVyZWQgYSBzdWNjZXNzIHN0YXR1cyBhbmQKICAgICAgICAgKiB3aWxsIHJlc3VsdCBpbiB0aGUgc3VjY2VzcyBjYWxsYmFjayBiZWluZyBjYWxsZWQuIE5vdGUgdGhhdCBpZiB0aGUgcmVzcG9uc2UgaXMgYSByZWRpcmVjdCwKICAgICAgICAgKiBYTUxIdHRwUmVxdWVzdCB3aWxsIHRyYW5zcGFyZW50bHkgZm9sbG93IGl0LCBtZWFuaW5nIHRoYXQgdGhlIGVycm9yIGNhbGxiYWNrIHdpbGwgbm90IGJlCiAgICAgICAgICogY2FsbGVkIGZvciBzdWNoIHJlc3BvbnNlcy4KICAgICAgICAgKgogICAgICAgICAqICMgV3JpdGluZyBVbml0IFRlc3RzIHRoYXQgdXNlICRodHRwCiAgICAgICAgICogV2hlbiB1bml0IHRlc3RpbmcgKHVzaW5nIHtAbGluayBuZ01vY2sgbmdNb2NrfSksIGl0IGlzIG5lY2Vzc2FyeSB0byBjYWxsCiAgICAgICAgICoge0BsaW5rIG5nTW9jay4kaHR0cEJhY2tlbmQjZmx1c2ggJGh0dHBCYWNrZW5kLmZsdXNoKCl9IHRvIGZsdXNoIGVhY2ggcGVuZGluZwogICAgICAgICAqIHJlcXVlc3QgdXNpbmcgdHJhaW5lZCByZXNwb25zZXMuCiAgICAgICAgICoKICAgICAgICAgKiBgYGAKICAgICAgICAgKiAkaHR0cEJhY2tlbmQuZXhwZWN0R0VUKC4uLik7CiAgICAgICAgICogJGh0dHAuZ2V0KC4uLik7CiAgICAgICAgICogJGh0dHBCYWNrZW5kLmZsdXNoKCk7CiAgICAgICAgICogYGBgCiAgICAgICAgICoKICAgICAgICAgKiAjIFNob3J0Y3V0IG1ldGhvZHMKICAgICAgICAgKgogICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZHMgYXJlIGFsc28gYXZhaWxhYmxlLiBBbGwgc2hvcnRjdXQgbWV0aG9kcyByZXF1aXJlIHBhc3NpbmcgaW4gdGhlIFVSTCwgYW5kCiAgICAgICAgICogcmVxdWVzdCBkYXRhIG11c3QgYmUgcGFzc2VkIGluIGZvciBQT1NUL1BVVCByZXF1ZXN0cy4KICAgICAgICAgKgogICAgICAgICAqIGBgYGpzCiAgICAgICAgICogICAkaHR0cC5nZXQoJy9zb21lVXJsJykuc3VjY2VzcyhzdWNjZXNzQ2FsbGJhY2spOwogICAgICAgICAqICAgJGh0dHAucG9zdCgnL3NvbWVVcmwnLCBkYXRhKS5zdWNjZXNzKHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgICAgICogYGBgCiAgICAgICAgICoKICAgICAgICAgKiBDb21wbGV0ZSBsaXN0IG9mIHNob3J0Y3V0IG1ldGhvZHM6CiAgICAgICAgICoKICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNnZXQgJGh0dHAuZ2V0fQogICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2hlYWQgJGh0dHAuaGVhZH0KICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwb3N0ICRodHRwLnBvc3R9CiAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjcHV0ICRodHRwLnB1dH0KICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNkZWxldGUgJGh0dHAuZGVsZXRlfQogICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2pzb25wICRodHRwLmpzb25wfQogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiAjIFNldHRpbmcgSFRUUCBIZWFkZXJzCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgJGh0dHAgc2VydmljZSB3aWxsIGF1dG9tYXRpY2FsbHkgYWRkIGNlcnRhaW4gSFRUUCBoZWFkZXJzIHRvIGFsbCByZXF1ZXN0cy4gVGhlc2UgZGVmYXVsdHMKICAgICAgICAgKiBjYW4gYmUgZnVsbHkgY29uZmlndXJlZCBieSBhY2Nlc3NpbmcgdGhlIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnNgIGNvbmZpZ3VyYXRpb24KICAgICAgICAgKiBvYmplY3QsIHdoaWNoIGN1cnJlbnRseSBjb250YWlucyB0aGlzIGRlZmF1bHQgY29uZmlndXJhdGlvbjoKICAgICAgICAgKgogICAgICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5jb21tb25gIChoZWFkZXJzIHRoYXQgYXJlIGNvbW1vbiBmb3IgYWxsIHJlcXVlc3RzKToKICAgICAgICAgKiAgIC0gYEFjY2VwdDogYXBwbGljYXRpb24vanNvbiwgdGV4dC9wbGFpbiwgKiAvICpgCiAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnBvc3RgOiAoaGVhZGVyIGRlZmF1bHRzIGZvciBQT1NUIHJlcXVlc3RzKQogICAgICAgICAqICAgLSBgQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uYAogICAgICAgICAqIC0gYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVycy5wdXRgIChoZWFkZXIgZGVmYXVsdHMgZm9yIFBVVCByZXF1ZXN0cykKICAgICAgICAgKiAgIC0gYENvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbmAKICAgICAgICAgKgogICAgICAgICAqIFRvIGFkZCBvciBvdmVyd3JpdGUgdGhlc2UgZGVmYXVsdHMsIHNpbXBseSBhZGQgb3IgcmVtb3ZlIGEgcHJvcGVydHkgZnJvbSB0aGVzZSBjb25maWd1cmF0aW9uCiAgICAgICAgICogb2JqZWN0cy4gVG8gYWRkIGhlYWRlcnMgZm9yIGFuIEhUVFAgbWV0aG9kIG90aGVyIHRoYW4gUE9TVCBvciBQVVQsIHNpbXBseSBhZGQgYSBuZXcgb2JqZWN0CiAgICAgICAgICogd2l0aCB0aGUgbG93ZXJjYXNlZCBIVFRQIG1ldGhvZCBuYW1lIGFzIHRoZSBrZXksIGUuZy4KICAgICAgICAgKiBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLmdldCA9IHsgJ015LUhlYWRlcicgOiAndmFsdWUnIH0uCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgZGVmYXVsdHMgY2FuIGFsc28gYmUgc2V0IGF0IHJ1bnRpbWUgdmlhIHRoZSBgJGh0dHAuZGVmYXVsdHNgIG9iamVjdCBpbiB0aGUgc2FtZQogICAgICAgICAqIGZhc2hpb24uIEZvciBleGFtcGxlOgogICAgICAgICAqCiAgICAgICAgICogYGBgCiAgICAgICAgICogbW9kdWxlLnJ1bihmdW5jdGlvbigkaHR0cCkgewogICAgICogICAkaHR0cC5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vbi5BdXRob3JpemF0aW9uID0gJ0Jhc2ljIFltVmxjRHBpYjI5dycKICAgICAqIH0pOwogICAgICAgICAqIGBgYAogICAgICAgICAqCiAgICAgICAgICogSW4gYWRkaXRpb24sIHlvdSBjYW4gc3VwcGx5IGEgYGhlYWRlcnNgIHByb3BlcnR5IGluIHRoZSBjb25maWcgb2JqZWN0IHBhc3NlZCB3aGVuCiAgICAgICAgICogY2FsbGluZyBgJGh0dHAoY29uZmlnKWAsIHdoaWNoIG92ZXJyaWRlcyB0aGUgZGVmYXVsdHMgd2l0aG91dCBjaGFuZ2luZyB0aGVtIGdsb2JhbGx5LgogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiAjIFRyYW5zZm9ybWluZyBSZXF1ZXN0cyBhbmQgUmVzcG9uc2VzCiAgICAgICAgICoKICAgICAgICAgKiBCb3RoIHJlcXVlc3RzIGFuZCByZXNwb25zZXMgY2FuIGJlIHRyYW5zZm9ybWVkIHVzaW5nIHRyYW5zZm9ybSBmdW5jdGlvbnMuIEJ5IGRlZmF1bHQsIEFuZ3VsYXIKICAgICAgICAgKiBhcHBsaWVzIHRoZXNlIHRyYW5zZm9ybWF0aW9uczoKICAgICAgICAgKgogICAgICAgICAqIFJlcXVlc3QgdHJhbnNmb3JtYXRpb25zOgogICAgICAgICAqCiAgICAgICAgICogLSBJZiB0aGUgYGRhdGFgIHByb3BlcnR5IG9mIHRoZSByZXF1ZXN0IGNvbmZpZ3VyYXRpb24gb2JqZWN0IGNvbnRhaW5zIGFuIG9iamVjdCwgc2VyaWFsaXplIGl0CiAgICAgICAgICogICBpbnRvIEpTT04gZm9ybWF0LgogICAgICAgICAqCiAgICAgICAgICogUmVzcG9uc2UgdHJhbnNmb3JtYXRpb25zOgogICAgICAgICAqCiAgICAgICAgICogIC0gSWYgWFNSRiBwcmVmaXggaXMgZGV0ZWN0ZWQsIHN0cmlwIGl0IChzZWUgU2VjdXJpdHkgQ29uc2lkZXJhdGlvbnMgc2VjdGlvbiBiZWxvdykuCiAgICAgICAgICogIC0gSWYgSlNPTiByZXNwb25zZSBpcyBkZXRlY3RlZCwgZGVzZXJpYWxpemUgaXQgdXNpbmcgYSBKU09OIHBhcnNlci4KICAgICAgICAgKgogICAgICAgICAqIFRvIGdsb2JhbGx5IGF1Z21lbnQgb3Igb3ZlcnJpZGUgdGhlIGRlZmF1bHQgdHJhbnNmb3JtcywgbW9kaWZ5IHRoZQogICAgICAgICAqIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLnRyYW5zZm9ybVJlcXVlc3RgIGFuZCBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy50cmFuc2Zvcm1SZXNwb25zZWAKICAgICAgICAgKiBwcm9wZXJ0aWVzLiBUaGVzZSBwcm9wZXJ0aWVzIGFyZSBieSBkZWZhdWx0IGFuIGFycmF5IG9mIHRyYW5zZm9ybSBmdW5jdGlvbnMsIHdoaWNoIGFsbG93cyB5b3UKICAgICAgICAgKiB0byBgcHVzaGAgb3IgYHVuc2hpZnRgIGEgbmV3IHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9uIGludG8gdGhlIHRyYW5zZm9ybWF0aW9uIGNoYWluLiBZb3UgY2FuCiAgICAgICAgICogYWxzbyBkZWNpZGUgdG8gY29tcGxldGVseSBvdmVycmlkZSBhbnkgZGVmYXVsdCB0cmFuc2Zvcm1hdGlvbnMgYnkgYXNzaWduaW5nIHlvdXIKICAgICAgICAgKiB0cmFuc2Zvcm1hdGlvbiBmdW5jdGlvbnMgdG8gdGhlc2UgcHJvcGVydGllcyBkaXJlY3RseSB3aXRob3V0IHRoZSBhcnJheSB3cmFwcGVyLiAgVGhlc2UgZGVmYXVsdHMKICAgICAgICAgKiBhcmUgYWdhaW4gYXZhaWxhYmxlIG9uIHRoZSAkaHR0cCBmYWN0b3J5IGF0IHJ1bi10aW1lLCB3aGljaCBtYXkgYmUgdXNlZnVsIGlmIHlvdSBoYXZlIHJ1bi10aW1lCiAgICAgICAgICogc2VydmljZXMgeW91IHdpc2ggdG8gYmUgaW52b2x2ZWQgaW4geW91ciB0cmFuc2Zvcm1hdGlvbnMuCiAgICAgICAgICoKICAgICAgICAgKiBTaW1pbGFybHksIHRvIGxvY2FsbHkgb3ZlcnJpZGUgdGhlIHJlcXVlc3QvcmVzcG9uc2UgdHJhbnNmb3JtcywgYXVnbWVudCB0aGUKICAgICAgICAgKiBgdHJhbnNmb3JtUmVxdWVzdGAgYW5kL29yIGB0cmFuc2Zvcm1SZXNwb25zZWAgcHJvcGVydGllcyBvZiB0aGUgY29uZmlndXJhdGlvbiBvYmplY3QgcGFzc2VkCiAgICAgICAgICogaW50byBgJGh0dHBgLgogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiAjIENhY2hpbmcKICAgICAgICAgKgogICAgICAgICAqIFRvIGVuYWJsZSBjYWNoaW5nLCBzZXQgdGhlIHJlcXVlc3QgY29uZmlndXJhdGlvbiBgY2FjaGVgIHByb3BlcnR5IHRvIGB0cnVlYCAodG8gdXNlIGRlZmF1bHQKICAgICAgICAgKiBjYWNoZSkgb3IgdG8gYSBjdXN0b20gY2FjaGUgb2JqZWN0IChidWlsdCB3aXRoIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5IGAkY2FjaGVGYWN0b3J5YH0pLgogICAgICAgICAqIFdoZW4gdGhlIGNhY2hlIGlzIGVuYWJsZWQsIGAkaHR0cGAgc3RvcmVzIHRoZSByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIgaW4gdGhlIHNwZWNpZmllZAogICAgICAgICAqIGNhY2hlLiBUaGUgbmV4dCB0aW1lIHRoZSBzYW1lIHJlcXVlc3QgaXMgbWFkZSwgdGhlIHJlc3BvbnNlIGlzIHNlcnZlZCBmcm9tIHRoZSBjYWNoZSB3aXRob3V0CiAgICAgICAgICogc2VuZGluZyBhIHJlcXVlc3QgdG8gdGhlIHNlcnZlci4KICAgICAgICAgKgogICAgICAgICAqIE5vdGUgdGhhdCBldmVuIGlmIHRoZSByZXNwb25zZSBpcyBzZXJ2ZWQgZnJvbSBjYWNoZSwgZGVsaXZlcnkgb2YgdGhlIGRhdGEgaXMgYXN5bmNocm9ub3VzIGluCiAgICAgICAgICogdGhlIHNhbWUgd2F5IHRoYXQgcmVhbCByZXF1ZXN0cyBhcmUuCiAgICAgICAgICoKICAgICAgICAgKiBJZiB0aGVyZSBhcmUgbXVsdGlwbGUgR0VUIHJlcXVlc3RzIGZvciB0aGUgc2FtZSBVUkwgdGhhdCBzaG91bGQgYmUgY2FjaGVkIHVzaW5nIHRoZSBzYW1lCiAgICAgICAgICogY2FjaGUsIGJ1dCB0aGUgY2FjaGUgaXMgbm90IHBvcHVsYXRlZCB5ZXQsIG9ubHkgb25lIHJlcXVlc3QgdG8gdGhlIHNlcnZlciB3aWxsIGJlIG1hZGUgYW5kCiAgICAgICAgICogdGhlIHJlbWFpbmluZyByZXF1ZXN0cyB3aWxsIGJlIGZ1bGZpbGxlZCB1c2luZyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgZmlyc3QgcmVxdWVzdC4KICAgICAgICAgKgogICAgICAgICAqIFlvdSBjYW4gY2hhbmdlIHRoZSBkZWZhdWx0IGNhY2hlIHRvIGEgbmV3IG9iamVjdCAoYnVpbHQgd2l0aAogICAgICAgICAqIHtAbGluayBuZy4kY2FjaGVGYWN0b3J5IGAkY2FjaGVGYWN0b3J5YH0pIGJ5IHVwZGF0aW5nIHRoZQogICAgICAgICAqIHtAbGluayBuZy4kaHR0cCNwcm9wZXJ0aWVzX2RlZmF1bHRzIGAkaHR0cC5kZWZhdWx0cy5jYWNoZWB9IHByb3BlcnR5LiBBbGwgcmVxdWVzdHMgd2hvIHNldAogICAgICAgICAqIHRoZWlyIGBjYWNoZWAgcHJvcGVydHkgdG8gYHRydWVgIHdpbGwgbm93IHVzZSB0aGlzIGNhY2hlIG9iamVjdC4KICAgICAgICAgKgogICAgICAgICAqIElmIHlvdSBzZXQgdGhlIGRlZmF1bHQgY2FjaGUgdG8gYGZhbHNlYCB0aGVuIG9ubHkgcmVxdWVzdHMgdGhhdCBzcGVjaWZ5IHRoZWlyIG93biBjdXN0b20KICAgICAgICAgKiBjYWNoZSBvYmplY3Qgd2lsbCBiZSBjYWNoZWQuCiAgICAgICAgICoKICAgICAgICAgKiAjIEludGVyY2VwdG9ycwogICAgICAgICAqCiAgICAgICAgICogQmVmb3JlIHlvdSBzdGFydCBjcmVhdGluZyBpbnRlcmNlcHRvcnMsIGJlIHN1cmUgdG8gdW5kZXJzdGFuZCB0aGUKICAgICAgICAgKiB7QGxpbmsgbmcuJHEgJHEgYW5kIGRlZmVycmVkL3Byb21pc2UgQVBJc30uCiAgICAgICAgICoKICAgICAgICAgKiBGb3IgcHVycG9zZXMgb2YgZ2xvYmFsIGVycm9yIGhhbmRsaW5nLCBhdXRoZW50aWNhdGlvbiwgb3IgYW55IGtpbmQgb2Ygc3luY2hyb25vdXMgb3IKICAgICAgICAgKiBhc3luY2hyb25vdXMgcHJlLXByb2Nlc3Npbmcgb2YgcmVxdWVzdCBvciBwb3N0cHJvY2Vzc2luZyBvZiByZXNwb25zZXMsIGl0IGlzIGRlc2lyYWJsZSB0byBiZQogICAgICAgICAqIGFibGUgdG8gaW50ZXJjZXB0IHJlcXVlc3RzIGJlZm9yZSB0aGV5IGFyZSBoYW5kZWQgdG8gdGhlIHNlcnZlciBhbmQKICAgICAgICAgKiByZXNwb25zZXMgYmVmb3JlIHRoZXkgYXJlIGhhbmRlZCBvdmVyIHRvIHRoZSBhcHBsaWNhdGlvbiBjb2RlIHRoYXQKICAgICAgICAgKiBpbml0aWF0ZWQgdGhlc2UgcmVxdWVzdHMuIFRoZSBpbnRlcmNlcHRvcnMgbGV2ZXJhZ2UgdGhlIHtAbGluayBuZy4kcQogICAgICogcHJvbWlzZSBBUElzfSB0byBmdWxmaWxsIHRoaXMgbmVlZCBmb3IgYm90aCBzeW5jaHJvbm91cyBhbmQgYXN5bmNocm9ub3VzIHByZS1wcm9jZXNzaW5nLgogICAgICAgICAqCiAgICAgICAgICogVGhlIGludGVyY2VwdG9ycyBhcmUgc2VydmljZSBmYWN0b3JpZXMgdGhhdCBhcmUgcmVnaXN0ZXJlZCB3aXRoIHRoZSBgJGh0dHBQcm92aWRlcmAgYnkKICAgICAgICAgKiBhZGRpbmcgdGhlbSB0byB0aGUgYCRodHRwUHJvdmlkZXIuaW50ZXJjZXB0b3JzYCBhcnJheS4gVGhlIGZhY3RvcnkgaXMgY2FsbGVkIGFuZAogICAgICAgICAqIGluamVjdGVkIHdpdGggZGVwZW5kZW5jaWVzIChpZiBzcGVjaWZpZWQpIGFuZCByZXR1cm5zIHRoZSBpbnRlcmNlcHRvci4KICAgICAgICAgKgogICAgICAgICAqIFRoZXJlIGFyZSB0d28ga2luZHMgb2YgaW50ZXJjZXB0b3JzIChhbmQgdHdvIGtpbmRzIG9mIHJlamVjdGlvbiBpbnRlcmNlcHRvcnMpOgogICAgICAgICAqCiAgICAgICAgICogICAqIGByZXF1ZXN0YDogaW50ZXJjZXB0b3JzIGdldCBjYWxsZWQgd2l0aCBhIGh0dHAgYGNvbmZpZ2Agb2JqZWN0LiBUaGUgZnVuY3Rpb24gaXMgZnJlZSB0bwogICAgICAgICAqICAgICBtb2RpZnkgdGhlIGBjb25maWdgIG9iamVjdCBvciBjcmVhdGUgYSBuZXcgb25lLiBUaGUgZnVuY3Rpb24gbmVlZHMgdG8gcmV0dXJuIHRoZSBgY29uZmlnYAogICAgICAgICAqICAgICBvYmplY3QgZGlyZWN0bHksIG9yIGEgcHJvbWlzZSBjb250YWluaW5nIHRoZSBgY29uZmlnYCBvciBhIG5ldyBgY29uZmlnYCBvYmplY3QuCiAgICAgICAgICogICAqIGByZXF1ZXN0RXJyb3JgOiBpbnRlcmNlcHRvciBnZXRzIGNhbGxlZCB3aGVuIGEgcHJldmlvdXMgaW50ZXJjZXB0b3IgdGhyZXcgYW4gZXJyb3Igb3IKICAgICAgICAgKiAgICAgcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbi4KICAgICAgICAgKiAgICogYHJlc3BvbnNlYDogaW50ZXJjZXB0b3JzIGdldCBjYWxsZWQgd2l0aCBodHRwIGByZXNwb25zZWAgb2JqZWN0LiBUaGUgZnVuY3Rpb24gaXMgZnJlZSB0bwogICAgICAgICAqICAgICBtb2RpZnkgdGhlIGByZXNwb25zZWAgb2JqZWN0IG9yIGNyZWF0ZSBhIG5ldyBvbmUuIFRoZSBmdW5jdGlvbiBuZWVkcyB0byByZXR1cm4gdGhlIGByZXNwb25zZWAKICAgICAgICAgKiAgICAgb2JqZWN0IGRpcmVjdGx5LCBvciBhcyBhIHByb21pc2UgY29udGFpbmluZyB0aGUgYHJlc3BvbnNlYCBvciBhIG5ldyBgcmVzcG9uc2VgIG9iamVjdC4KICAgICAgICAgKiAgICogYHJlc3BvbnNlRXJyb3JgOiBpbnRlcmNlcHRvciBnZXRzIGNhbGxlZCB3aGVuIGEgcHJldmlvdXMgaW50ZXJjZXB0b3IgdGhyZXcgYW4gZXJyb3Igb3IKICAgICAgICAgKiAgICAgcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbi4KICAgICAgICAgKgogICAgICAgICAqCiAgICAgICAgICogYGBganMKICAgICAgICAgKiAgIC8vIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciBhcyBhIHNlcnZpY2UKICAgICAgICAgKiAgICRwcm92aWRlLmZhY3RvcnkoJ215SHR0cEludGVyY2VwdG9yJywgZnVuY3Rpb24oJHEsIGRlcGVuZGVuY3kxLCBkZXBlbmRlbmN5MikgewogICAgICogICAgIHJldHVybiB7CiAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAqICAgICAgICdyZXF1ZXN0JzogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBzdWNjZXNzCiAgICAgKiAgICAgICAgIHJldHVybiBjb25maWc7CiAgICAgKiAgICAgICB9LAogICAgICoKICAgICAqICAgICAgIC8vIG9wdGlvbmFsIG1ldGhvZAogICAgICogICAgICAncmVxdWVzdEVycm9yJzogZnVuY3Rpb24ocmVqZWN0aW9uKSB7CiAgICAgKiAgICAgICAgIC8vIGRvIHNvbWV0aGluZyBvbiBlcnJvcgogICAgICogICAgICAgICBpZiAoY2FuUmVjb3ZlcihyZWplY3Rpb24pKSB7CiAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgKiAgICAgICAgIH0KICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZWplY3Rpb24pOwogICAgICogICAgICAgfSwKICAgICAqCiAgICAgKgogICAgICoKICAgICAqICAgICAgIC8vIG9wdGlvbmFsIG1ldGhvZAogICAgICogICAgICAgJ3Jlc3BvbnNlJzogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIHN1Y2Nlc3MKICAgICAqICAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICogICAgICAgfSwKICAgICAqCiAgICAgKiAgICAgICAvLyBvcHRpb25hbCBtZXRob2QKICAgICAqICAgICAgJ3Jlc3BvbnNlRXJyb3InOiBmdW5jdGlvbihyZWplY3Rpb24pIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIGVycm9yCiAgICAgKiAgICAgICAgIGlmIChjYW5SZWNvdmVyKHJlamVjdGlvbikpIHsKICAgICAqICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VPck5ld1Byb21pc2UKICAgICAqICAgICAgICAgfQogICAgICogICAgICAgICByZXR1cm4gJHEucmVqZWN0KHJlamVjdGlvbik7CiAgICAgKiAgICAgICB9CiAgICAgKiAgICAgfTsKICAgICAqICAgfSk7CiAgICAgICAgICoKICAgICAgICAgKiAgICRodHRwUHJvdmlkZXIuaW50ZXJjZXB0b3JzLnB1c2goJ215SHR0cEludGVyY2VwdG9yJyk7CiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqICAgLy8gYWx0ZXJuYXRpdmVseSwgcmVnaXN0ZXIgdGhlIGludGVyY2VwdG9yIHZpYSBhbiBhbm9ueW1vdXMgZmFjdG9yeQogICAgICAgICAqICAgJGh0dHBQcm92aWRlci5pbnRlcmNlcHRvcnMucHVzaChmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIHsKICAgICAqICAgICAgJ3JlcXVlc3QnOiBmdW5jdGlvbihjb25maWcpIHsKICAgICAqICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUKICAgICAqICAgICAgIH0sCiAgICAgKgogICAgICogICAgICAgJ3Jlc3BvbnNlJzogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgIC8vIHNhbWUgYXMgYWJvdmUKICAgICAqICAgICAgIH0KICAgICAqICAgICB9OwogICAgICogICB9KTsKICAgICAgICAgKiBgYGAKICAgICAgICAgKgogICAgICAgICAqICMgUmVzcG9uc2UgaW50ZXJjZXB0b3JzIChERVBSRUNBVEVEKQogICAgICAgICAqCiAgICAgICAgICogQmVmb3JlIHlvdSBzdGFydCBjcmVhdGluZyBpbnRlcmNlcHRvcnMsIGJlIHN1cmUgdG8gdW5kZXJzdGFuZCB0aGUKICAgICAgICAgKiB7QGxpbmsgbmcuJHEgJHEgYW5kIGRlZmVycmVkL3Byb21pc2UgQVBJc30uCiAgICAgICAgICoKICAgICAgICAgKiBGb3IgcHVycG9zZXMgb2YgZ2xvYmFsIGVycm9yIGhhbmRsaW5nLCBhdXRoZW50aWNhdGlvbiBvciBhbnkga2luZCBvZiBzeW5jaHJvbm91cyBvcgogICAgICAgICAqIGFzeW5jaHJvbm91cyBwcmVwcm9jZXNzaW5nIG9mIHJlY2VpdmVkIHJlc3BvbnNlcywgaXQgaXMgZGVzaXJhYmxlIHRvIGJlIGFibGUgdG8gaW50ZXJjZXB0CiAgICAgICAgICogcmVzcG9uc2VzIGZvciBodHRwIHJlcXVlc3RzIGJlZm9yZSB0aGV5IGFyZSBoYW5kZWQgb3ZlciB0byB0aGUgYXBwbGljYXRpb24gY29kZSB0aGF0CiAgICAgICAgICogaW5pdGlhdGVkIHRoZXNlIHJlcXVlc3RzLiBUaGUgcmVzcG9uc2UgaW50ZXJjZXB0b3JzIGxldmVyYWdlIHRoZSB7QGxpbmsgbmcuJHEKICAgICAqIHByb21pc2UgYXBpc30gdG8gZnVsZmlsIHRoaXMgbmVlZCBmb3IgYm90aCBzeW5jaHJvbm91cyBhbmQgYXN5bmNocm9ub3VzIHByZXByb2Nlc3NpbmcuCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgaW50ZXJjZXB0b3JzIGFyZSBzZXJ2aWNlIGZhY3RvcmllcyB0aGF0IGFyZSByZWdpc3RlcmVkIHdpdGggdGhlICRodHRwUHJvdmlkZXIgYnkKICAgICAgICAgKiBhZGRpbmcgdGhlbSB0byB0aGUgYCRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnNgIGFycmF5LiBUaGUgZmFjdG9yeSBpcyBjYWxsZWQgYW5kCiAgICAgICAgICogaW5qZWN0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgKGlmIHNwZWNpZmllZCkgYW5kIHJldHVybnMgdGhlIGludGVyY2VwdG9yICDigJQgYSBmdW5jdGlvbiB0aGF0CiAgICAgICAgICogdGFrZXMgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0gYW5kIHJldHVybnMgdGhlIG9yaWdpbmFsIG9yIGEgbmV3IHByb21pc2UuCiAgICAgICAgICoKICAgICAgICAgKiBgYGBqcwogICAgICAgICAqICAgLy8gcmVnaXN0ZXIgdGhlIGludGVyY2VwdG9yIGFzIGEgc2VydmljZQogICAgICAgICAqICAgJHByb3ZpZGUuZmFjdG9yeSgnbXlIdHRwSW50ZXJjZXB0b3InLCBmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAqICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIHN1Y2Nlc3MKICAgICAqICAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICogICAgICAgfSwgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIGVycm9yCiAgICAgKiAgICAgICAgIGlmIChjYW5SZWNvdmVyKHJlc3BvbnNlKSkgewogICAgICogICAgICAgICAgIHJldHVybiByZXNwb25zZU9yTmV3UHJvbWlzZQogICAgICogICAgICAgICB9CiAgICAgKiAgICAgICAgIHJldHVybiAkcS5yZWplY3QocmVzcG9uc2UpOwogICAgICogICAgICAgfSk7CiAgICAgKiAgICAgfQogICAgICogICB9KTsKICAgICAgICAgKgogICAgICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKCdteUh0dHBJbnRlcmNlcHRvcicpOwogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiAgIC8vIHJlZ2lzdGVyIHRoZSBpbnRlcmNlcHRvciB2aWEgYW4gYW5vbnltb3VzIGZhY3RvcnkKICAgICAgICAgKiAgICRodHRwUHJvdmlkZXIucmVzcG9uc2VJbnRlcmNlcHRvcnMucHVzaChmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAqICAgICAgIC8vIHNhbWUgYXMgYWJvdmUKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICAgICAqIGBgYAogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiAjIFNlY3VyaXR5IENvbnNpZGVyYXRpb25zCiAgICAgICAgICoKICAgICAgICAgKiBXaGVuIGRlc2lnbmluZyB3ZWIgYXBwbGljYXRpb25zLCBjb25zaWRlciBzZWN1cml0eSB0aHJlYXRzIGZyb206CiAgICAgICAgICoKICAgICAgICAgKiAtIFtKU09OIHZ1bG5lcmFiaWxpdHldKGh0dHA6Ly9oYWFja2VkLmNvbS9hcmNoaXZlLzIwMDgvMTEvMjAvYW5hdG9teS1vZi1hLXN1YnRsZS1qc29uLXZ1bG5lcmFiaWxpdHkuYXNweCkKICAgICAgICAgKiAtIFtYU1JGXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Nyb3NzLXNpdGVfcmVxdWVzdF9mb3JnZXJ5KQogICAgICAgICAqCiAgICAgICAgICogQm90aCBzZXJ2ZXIgYW5kIHRoZSBjbGllbnQgbXVzdCBjb29wZXJhdGUgaW4gb3JkZXIgdG8gZWxpbWluYXRlIHRoZXNlIHRocmVhdHMuIEFuZ3VsYXIgY29tZXMKICAgICAgICAgKiBwcmUtY29uZmlndXJlZCB3aXRoIHN0cmF0ZWdpZXMgdGhhdCBhZGRyZXNzIHRoZXNlIGlzc3VlcywgYnV0IGZvciB0aGlzIHRvIHdvcmsgYmFja2VuZCBzZXJ2ZXIKICAgICAgICAgKiBjb29wZXJhdGlvbiBpcyByZXF1aXJlZC4KICAgICAgICAgKgogICAgICAgICAqICMjIEpTT04gVnVsbmVyYWJpbGl0eSBQcm90ZWN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBBIFtKU09OIHZ1bG5lcmFiaWxpdHldKGh0dHA6Ly9oYWFja2VkLmNvbS9hcmNoaXZlLzIwMDgvMTEvMjAvYW5hdG9teS1vZi1hLXN1YnRsZS1qc29uLXZ1bG5lcmFiaWxpdHkuYXNweCkKICAgICAgICAgKiBhbGxvd3MgdGhpcmQgcGFydHkgd2Vic2l0ZSB0byB0dXJuIHlvdXIgSlNPTiByZXNvdXJjZSBVUkwgaW50bwogICAgICAgICAqIFtKU09OUF0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9KU09OUCkgcmVxdWVzdCB1bmRlciBzb21lIGNvbmRpdGlvbnMuIFRvCiAgICAgICAgICogY291bnRlciB0aGlzIHlvdXIgc2VydmVyIGNhbiBwcmVmaXggYWxsIEpTT04gcmVxdWVzdHMgd2l0aCBmb2xsb3dpbmcgc3RyaW5nIGAiKV19JyxcbiJgLgogICAgICAgICAqIEFuZ3VsYXIgd2lsbCBhdXRvbWF0aWNhbGx5IHN0cmlwIHRoZSBwcmVmaXggYmVmb3JlIHByb2Nlc3NpbmcgaXQgYXMgSlNPTi4KICAgICAgICAgKgogICAgICAgICAqIEZvciBleGFtcGxlIGlmIHlvdXIgc2VydmVyIG5lZWRzIHRvIHJldHVybjoKICAgICAgICAgKiBgYGBqcwogICAgICAgICAqIFsnb25lJywndHdvJ10KICAgICAgICAgKiBgYGAKICAgICAgICAgKgogICAgICAgICAqIHdoaWNoIGlzIHZ1bG5lcmFibGUgdG8gYXR0YWNrLCB5b3VyIHNlcnZlciBjYW4gcmV0dXJuOgogICAgICAgICAqIGBgYGpzCiAgICAgICAgICogKV19JywKICAgICAgICAgKiBbJ29uZScsJ3R3byddCiAgICAgICAgICogYGBgCiAgICAgICAgICoKICAgICAgICAgKiBBbmd1bGFyIHdpbGwgc3RyaXAgdGhlIHByZWZpeCwgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIEpTT04uCiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqICMjIENyb3NzIFNpdGUgUmVxdWVzdCBGb3JnZXJ5IChYU1JGKSBQcm90ZWN0aW9uCiAgICAgICAgICoKICAgICAgICAgKiBbWFNSRl0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1zaXRlX3JlcXVlc3RfZm9yZ2VyeSkgaXMgYSB0ZWNobmlxdWUgYnkgd2hpY2gKICAgICAgICAgKiBhbiB1bmF1dGhvcml6ZWQgc2l0ZSBjYW4gZ2FpbiB5b3VyIHVzZXIncyBwcml2YXRlIGRhdGEuIEFuZ3VsYXIgcHJvdmlkZXMgYSBtZWNoYW5pc20KICAgICAgICAgKiB0byBjb3VudGVyIFhTUkYuIFdoZW4gcGVyZm9ybWluZyBYSFIgcmVxdWVzdHMsIHRoZSAkaHR0cCBzZXJ2aWNlIHJlYWRzIGEgdG9rZW4gZnJvbSBhIGNvb2tpZQogICAgICAgICAqIChieSBkZWZhdWx0LCBgWFNSRi1UT0tFTmApIGFuZCBzZXRzIGl0IGFzIGFuIEhUVFAgaGVhZGVyIChgWC1YU1JGLVRPS0VOYCkuIFNpbmNlIG9ubHkKICAgICAgICAgKiBKYXZhU2NyaXB0IHRoYXQgcnVucyBvbiB5b3VyIGRvbWFpbiBjb3VsZCByZWFkIHRoZSBjb29raWUsIHlvdXIgc2VydmVyIGNhbiBiZSBhc3N1cmVkIHRoYXQKICAgICAgICAgKiB0aGUgWEhSIGNhbWUgZnJvbSBKYXZhU2NyaXB0IHJ1bm5pbmcgb24geW91ciBkb21haW4uIFRoZSBoZWFkZXIgd2lsbCBub3QgYmUgc2V0IGZvcgogICAgICAgICAqIGNyb3NzLWRvbWFpbiByZXF1ZXN0cy4KICAgICAgICAgKgogICAgICAgICAqIFRvIHRha2UgYWR2YW50YWdlIG9mIHRoaXMsIHlvdXIgc2VydmVyIG5lZWRzIHRvIHNldCBhIHRva2VuIGluIGEgSmF2YVNjcmlwdCByZWFkYWJsZSBzZXNzaW9uCiAgICAgICAgICogY29va2llIGNhbGxlZCBgWFNSRi1UT0tFTmAgb24gdGhlIGZpcnN0IEhUVFAgR0VUIHJlcXVlc3QuIE9uIHN1YnNlcXVlbnQgWEhSIHJlcXVlc3RzIHRoZQogICAgICAgICAqIHNlcnZlciBjYW4gdmVyaWZ5IHRoYXQgdGhlIGNvb2tpZSBtYXRjaGVzIGBYLVhTUkYtVE9LRU5gIEhUVFAgaGVhZGVyLCBhbmQgdGhlcmVmb3JlIGJlIHN1cmUKICAgICAgICAgKiB0aGF0IG9ubHkgSmF2YVNjcmlwdCBydW5uaW5nIG9uIHlvdXIgZG9tYWluIGNvdWxkIGhhdmUgc2VudCB0aGUgcmVxdWVzdC4gVGhlIHRva2VuIG11c3QgYmUKICAgICAgICAgKiB1bmlxdWUgZm9yIGVhY2ggdXNlciBhbmQgbXVzdCBiZSB2ZXJpZmlhYmxlIGJ5IHRoZSBzZXJ2ZXIgKHRvIHByZXZlbnQgdGhlIEphdmFTY3JpcHQgZnJvbQogICAgICAgICAqIG1ha2luZyB1cCBpdHMgb3duIHRva2VucykuIFdlIHJlY29tbWVuZCB0aGF0IHRoZSB0b2tlbiBpcyBhIGRpZ2VzdCBvZiB5b3VyIHNpdGUncwogICAgICAgICAqIGF1dGhlbnRpY2F0aW9uIGNvb2tpZSB3aXRoIGEgW3NhbHRdKGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1NhbHRfKGNyeXB0b2dyYXBoeSkpCiAgICAgICAgICogZm9yIGFkZGVkIHNlY3VyaXR5LgogICAgICAgICAqCiAgICAgICAgICogVGhlIG5hbWUgb2YgdGhlIGhlYWRlcnMgY2FuIGJlIHNwZWNpZmllZCB1c2luZyB0aGUgeHNyZkhlYWRlck5hbWUgYW5kIHhzcmZDb29raWVOYW1lCiAgICAgICAgICogcHJvcGVydGllcyBvZiBlaXRoZXIgJGh0dHBQcm92aWRlci5kZWZhdWx0cyBhdCBjb25maWctdGltZSwgJGh0dHAuZGVmYXVsdHMgYXQgcnVuLXRpbWUsCiAgICAgICAgICogb3IgdGhlIHBlci1yZXF1ZXN0IGNvbmZpZyBvYmplY3QuCiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWcgT2JqZWN0IGRlc2NyaWJpbmcgdGhlIHJlcXVlc3QgdG8gYmUgbWFkZSBhbmQgaG93IGl0IHNob3VsZCBiZQogICAgICAgICAqICAgIHByb2Nlc3NlZC4gVGhlIG9iamVjdCBoYXMgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgICAgICoKICAgICAgICAgKiAgICAtICoqbWV0aG9kKiog4oCTIGB7c3RyaW5nfWAg4oCTIEhUVFAgbWV0aG9kIChlLmcuICdHRVQnLCAnUE9TVCcsIGV0YykKICAgICAgICAgKiAgICAtICoqdXJsKiog4oCTIGB7c3RyaW5nfWAg4oCTIEFic29sdXRlIG9yIHJlbGF0aXZlIFVSTCBvZiB0aGUgcmVzb3VyY2UgdGhhdCBpcyBiZWluZyByZXF1ZXN0ZWQuCiAgICAgICAgICogICAgLSAqKnBhcmFtcyoqIOKAkyBge09iamVjdC48c3RyaW5nfE9iamVjdD59YCDigJMgTWFwIG9mIHN0cmluZ3Mgb3Igb2JqZWN0cyB3aGljaCB3aWxsIGJlIHR1cm5lZAogICAgICAgICAqICAgICAgdG8gYD9rZXkxPXZhbHVlMSZrZXkyPXZhbHVlMmAgYWZ0ZXIgdGhlIHVybC4gSWYgdGhlIHZhbHVlIGlzIG5vdCBhIHN0cmluZywgaXQgd2lsbCBiZQogICAgICAgICAqICAgICAgSlNPTmlmaWVkLgogICAgICAgICAqICAgIC0gKipkYXRhKiog4oCTIGB7c3RyaW5nfE9iamVjdH1gIOKAkyBEYXRhIHRvIGJlIHNlbnQgYXMgdGhlIHJlcXVlc3QgbWVzc2FnZSBkYXRhLgogICAgICAgICAqICAgIC0gKipoZWFkZXJzKiog4oCTIGB7T2JqZWN0fWAg4oCTIE1hcCBvZiBzdHJpbmdzIG9yIGZ1bmN0aW9ucyB3aGljaCByZXR1cm4gc3RyaW5ncyByZXByZXNlbnRpbmcKICAgICAgICAgKiAgICAgIEhUVFAgaGVhZGVycyB0byBzZW5kIHRvIHRoZSBzZXJ2ZXIuIElmIHRoZSByZXR1cm4gdmFsdWUgb2YgYSBmdW5jdGlvbiBpcyBudWxsLCB0aGUKICAgICAgICAgKiAgICAgIGhlYWRlciB3aWxsIG5vdCBiZSBzZW50LgogICAgICAgICAqICAgIC0gKip4c3JmSGVhZGVyTmFtZSoqIOKAkyBge3N0cmluZ31gIOKAkyBOYW1lIG9mIEhUVFAgaGVhZGVyIHRvIHBvcHVsYXRlIHdpdGggdGhlIFhTUkYgdG9rZW4uCiAgICAgICAgICogICAgLSAqKnhzcmZDb29raWVOYW1lKiog4oCTIGB7c3RyaW5nfWAg4oCTIE5hbWUgb2YgY29va2llIGNvbnRhaW5pbmcgdGhlIFhTUkYgdG9rZW4uCiAgICAgICAgICogICAgLSAqKnRyYW5zZm9ybVJlcXVlc3QqKiDigJMKICAgICAgICAgKiAgICAgIGB7ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcil8QXJyYXkuPGZ1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpPn1gIOKAkwogICAgICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgICAgICogICAgICByZXF1ZXN0IGJvZHkgYW5kIGhlYWRlcnMgYW5kIHJldHVybnMgaXRzIHRyYW5zZm9ybWVkICh0eXBpY2FsbHkgc2VyaWFsaXplZCkgdmVyc2lvbi4KICAgICAgICAgKiAgICAtICoqdHJhbnNmb3JtUmVzcG9uc2UqKiDigJMKICAgICAgICAgKiAgICAgIGB7ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcil8QXJyYXkuPGZ1bmN0aW9uKGRhdGEsIGhlYWRlcnNHZXR0ZXIpPn1gIOKAkwogICAgICAgICAqICAgICAgdHJhbnNmb3JtIGZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIHN1Y2ggZnVuY3Rpb25zLiBUaGUgdHJhbnNmb3JtIGZ1bmN0aW9uIHRha2VzIHRoZSBodHRwCiAgICAgICAgICogICAgICByZXNwb25zZSBib2R5IGFuZCBoZWFkZXJzIGFuZCByZXR1cm5zIGl0cyB0cmFuc2Zvcm1lZCAodHlwaWNhbGx5IGRlc2VyaWFsaXplZCkgdmVyc2lvbi4KICAgICAgICAgKiAgICAtICoqY2FjaGUqKiDigJMgYHtib29sZWFufENhY2hlfWAg4oCTIElmIHRydWUsIGEgZGVmYXVsdCAkaHR0cCBjYWNoZSB3aWxsIGJlIHVzZWQgdG8gY2FjaGUgdGhlCiAgICAgICAgICogICAgICBHRVQgcmVxdWVzdCwgb3RoZXJ3aXNlIGlmIGEgY2FjaGUgaW5zdGFuY2UgYnVpbHQgd2l0aAogICAgICAgICAqICAgICAge0BsaW5rIG5nLiRjYWNoZUZhY3RvcnkgJGNhY2hlRmFjdG9yeX0sIHRoaXMgY2FjaGUgd2lsbCBiZSB1c2VkIGZvcgogICAgICAgICAqICAgICAgY2FjaGluZy4KICAgICAgICAgKiAgICAtICoqdGltZW91dCoqIOKAkyBge251bWJlcnxQcm9taXNlfWAg4oCTIHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzLCBvciB7QGxpbmsgbmcuJHEgcHJvbWlzZX0KICAgICAgICAgKiAgICAgIHRoYXQgc2hvdWxkIGFib3J0IHRoZSByZXF1ZXN0IHdoZW4gcmVzb2x2ZWQuCiAgICAgICAgICogICAgLSAqKndpdGhDcmVkZW50aWFscyoqIC0gYHtib29sZWFufWAgLSB3aGV0aGVyIHRvIHNldCB0aGUgYHdpdGhDcmVkZW50aWFsc2AgZmxhZyBvbiB0aGUKICAgICAgICAgKiAgICAgIFhIUiBvYmplY3QuIFNlZSBbcmVxdWVzdHMgd2l0aCBjcmVkZW50aWFsc11odHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9odHRwX2FjY2Vzc19jb250cm9sI3NlY3Rpb25fNQogICAgICAgICAqICAgICAgZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgICAgICogICAgLSAqKnJlc3BvbnNlVHlwZSoqIC0gYHtzdHJpbmd9YCAtIHNlZQogICAgICAgICAqICAgICAgW3JlcXVlc3RUeXBlXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS9YTUxIdHRwUmVxdWVzdCNyZXNwb25zZVR5cGUpLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBSZXR1cm5zIGEge0BsaW5rIG5nLiRxIHByb21pc2V9IG9iamVjdCB3aXRoIHRoZQogICAgICAgICAqICAgc3RhbmRhcmQgYHRoZW5gIG1ldGhvZCBhbmQgdHdvIGh0dHAgc3BlY2lmaWMgbWV0aG9kczogYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgLiBUaGUgYHRoZW5gCiAgICAgICAgICogICBtZXRob2QgdGFrZXMgdHdvIGFyZ3VtZW50cyBhIHN1Y2Nlc3MgYW5kIGFuIGVycm9yIGNhbGxiYWNrIHdoaWNoIHdpbGwgYmUgY2FsbGVkIHdpdGggYQogICAgICAgICAqICAgcmVzcG9uc2Ugb2JqZWN0LiBUaGUgYHN1Y2Nlc3NgIGFuZCBgZXJyb3JgIG1ldGhvZHMgdGFrZSBhIHNpbmdsZSBhcmd1bWVudCAtIGEgZnVuY3Rpb24gdGhhdAogICAgICAgICAqICAgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgcmVxdWVzdCBzdWNjZWVkcyBvciBmYWlscyByZXNwZWN0aXZlbHkuIFRoZSBhcmd1bWVudHMgcGFzc2VkIGludG8KICAgICAgICAgKiAgIHRoZXNlIGZ1bmN0aW9ucyBhcmUgZGVzdHJ1Y3R1cmVkIHJlcHJlc2VudGF0aW9uIG9mIHRoZSByZXNwb25zZSBvYmplY3QgcGFzc2VkIGludG8gdGhlCiAgICAgICAgICogICBgdGhlbmAgbWV0aG9kLiBUaGUgcmVzcG9uc2Ugb2JqZWN0IGhhcyB0aGVzZSBwcm9wZXJ0aWVzOgogICAgICAgICAqCiAgICAgICAgICogICAtICoqZGF0YSoqIOKAkyBge3N0cmluZ3xPYmplY3R9YCDigJMgVGhlIHJlc3BvbnNlIGJvZHkgdHJhbnNmb3JtZWQgd2l0aCB0aGUgdHJhbnNmb3JtCiAgICAgICAgICogICAgIGZ1bmN0aW9ucy4KICAgICAgICAgKiAgIC0gKipzdGF0dXMqKiDigJMgYHtudW1iZXJ9YCDigJMgSFRUUCBzdGF0dXMgY29kZSBvZiB0aGUgcmVzcG9uc2UuCiAgICAgICAgICogICAtICoqaGVhZGVycyoqIOKAkyBge2Z1bmN0aW9uKFtoZWFkZXJOYW1lXSl9YCDigJMgSGVhZGVyIGdldHRlciBmdW5jdGlvbi4KICAgICAgICAgKiAgIC0gKipjb25maWcqKiDigJMgYHtPYmplY3R9YCDigJMgVGhlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IHRoYXQgd2FzIHVzZWQgdG8gZ2VuZXJhdGUgdGhlIHJlcXVlc3QuCiAgICAgICAgICogICAtICoqc3RhdHVzVGV4dCoqIOKAkyBge3N0cmluZ31gIOKAkyBIVFRQIHN0YXR1cyB0ZXh0IG9mIHRoZSByZXNwb25zZS4KICAgICAgICAgKgogICAgICAgICAqIEBwcm9wZXJ0eSB7QXJyYXkuPE9iamVjdD59IHBlbmRpbmdSZXF1ZXN0cyBBcnJheSBvZiBjb25maWcgb2JqZWN0cyBmb3IgY3VycmVudGx5IHBlbmRpbmcKICAgICAgICAgKiAgIHJlcXVlc3RzLiBUaGlzIGlzIHByaW1hcmlseSBtZWFudCB0byBiZSB1c2VkIGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMuCiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgIDxleGFtcGxlPgogICAgICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJGZXRjaEN0cmwiPgogICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJtZXRob2QiPgogICAgICAgICA8b3B0aW9uPkdFVDwvb3B0aW9uPgogICAgICAgICA8b3B0aW9uPkpTT05QPC9vcHRpb24+CiAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InVybCIgc2l6ZT0iODAiLz4KICAgICAgICAgPGJ1dHRvbiBpZD0iZmV0Y2hidG4iIG5nLWNsaWNrPSJmZXRjaCgpIj5mZXRjaDwvYnV0dG9uPjxicj4KICAgICAgICAgPGJ1dHRvbiBpZD0ic2FtcGxlZ2V0YnRuIiBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0dFVCcsICdodHRwLWhlbGxvLmh0bWwnKSI+U2FtcGxlIEdFVDwvYnV0dG9uPgogICAgICAgICA8YnV0dG9uIGlkPSJzYW1wbGVqc29ucGJ0biIKICAgICAgICAgbmctY2xpY2s9InVwZGF0ZU1vZGVsKCdKU09OUCcsCiAgICAgICAgICdodHRwczovL2FuZ3VsYXJqcy5vcmcvZ3JlZXQucGhwP2NhbGxiYWNrPUpTT05fQ0FMTEJBQ0smbmFtZT1TdXBlciUyMEhlcm8nKSI+CiAgICAgICAgIFNhbXBsZSBKU09OUAogICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgPGJ1dHRvbiBpZD0iaW52YWxpZGpzb25wYnRuIgogICAgICAgICBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywgJ2h0dHBzOi8vYW5ndWxhcmpzLm9yZy9kb2VzbnRleGlzdCZjYWxsYmFjaz1KU09OX0NBTExCQUNLJykiPgogICAgICAgICBJbnZhbGlkIEpTT05QCiAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICA8cHJlPmh0dHAgc3RhdHVzIGNvZGU6IHt7c3RhdHVzfX08L3ByZT4KICAgICAgICAgPHByZT5odHRwIHJlc3BvbnNlIGRhdGE6IHt7ZGF0YX19PC9wcmU+CiAgICAgICAgIDwvZGl2PgogICAgICAgICA8L2ZpbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgICAgICAgIGZ1bmN0aW9uIEZldGNoQ3RybCgkc2NvcGUsICRodHRwLCAkdGVtcGxhdGVDYWNoZSkgewogICAgJHNjb3BlLm1ldGhvZCA9ICdHRVQnOwogICAgJHNjb3BlLnVybCA9ICdodHRwLWhlbGxvLmh0bWwnOwoKICAgICRzY29wZS5mZXRjaCA9IGZ1bmN0aW9uKCkgewogICAgICAkc2NvcGUuY29kZSA9IG51bGw7CiAgICAgICRzY29wZS5yZXNwb25zZSA9IG51bGw7CgogICAgICAkaHR0cCh7bWV0aG9kOiAkc2NvcGUubWV0aG9kLCB1cmw6ICRzY29wZS51cmwsIGNhY2hlOiAkdGVtcGxhdGVDYWNoZX0pLgogICAgICAgIHN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSwgc3RhdHVzKSB7CiAgICAgICAgICAkc2NvcGUuc3RhdHVzID0gc3RhdHVzOwogICAgICAgICAgJHNjb3BlLmRhdGEgPSBkYXRhOwogICAgICAgIH0pLgogICAgICAgIGVycm9yKGZ1bmN0aW9uKGRhdGEsIHN0YXR1cykgewogICAgICAgICAgJHNjb3BlLmRhdGEgPSBkYXRhIHx8ICJSZXF1ZXN0IGZhaWxlZCI7CiAgICAgICAgICAkc2NvcGUuc3RhdHVzID0gc3RhdHVzOwogICAgICB9KTsKICAgIH07CgogICAgJHNjb3BlLnVwZGF0ZU1vZGVsID0gZnVuY3Rpb24obWV0aG9kLCB1cmwpIHsKICAgICAgJHNjb3BlLm1ldGhvZCA9IG1ldGhvZDsKICAgICAgJHNjb3BlLnVybCA9IHVybDsKICAgIH07CiAgfQogICAgICAgICA8L2ZpbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9Imh0dHAtaGVsbG8uaHRtbCI+CiAgICAgICAgIEhlbGxvLCAkaHR0cCEKICAgICAgICAgPC9maWxlPgogICAgICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICAgICAgdmFyIHN0YXR1cyA9IGVsZW1lbnQoYnkuYmluZGluZygnc3RhdHVzJykpOwogICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQoYnkuYmluZGluZygnZGF0YScpKTsKICAgICAgICAgdmFyIGZldGNoQnRuID0gZWxlbWVudChieS5pZCgnZmV0Y2hidG4nKSk7CiAgICAgICAgIHZhciBzYW1wbGVHZXRCdG4gPSBlbGVtZW50KGJ5LmlkKCdzYW1wbGVnZXRidG4nKSk7CiAgICAgICAgIHZhciBzYW1wbGVKc29ucEJ0biA9IGVsZW1lbnQoYnkuaWQoJ3NhbXBsZWpzb25wYnRuJykpOwogICAgICAgICB2YXIgaW52YWxpZEpzb25wQnRuID0gZWxlbWVudChieS5pZCgnaW52YWxpZGpzb25wYnRuJykpOwoKICAgICAgICAgaXQoJ3Nob3VsZCBtYWtlIGFuIHhociBHRVQgcmVxdWVzdCcsIGZ1bmN0aW9uKCkgewogICAgc2FtcGxlR2V0QnRuLmNsaWNrKCk7CiAgICBmZXRjaEJ0bi5jbGljaygpOwogICAgZXhwZWN0KHN0YXR1cy5nZXRUZXh0KCkpLnRvTWF0Y2goJzIwMCcpOwogICAgZXhwZWN0KGRhdGEuZ2V0VGV4dCgpKS50b01hdGNoKC9IZWxsbywgXCRodHRwIS8pOwogIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBtYWtlIGEgSlNPTlAgcmVxdWVzdCB0byBhbmd1bGFyanMub3JnJywgZnVuY3Rpb24oKSB7CiAgICBzYW1wbGVKc29ucEJ0bi5jbGljaygpOwogICAgZmV0Y2hCdG4uY2xpY2soKTsKICAgIGV4cGVjdChzdGF0dXMuZ2V0VGV4dCgpKS50b01hdGNoKCcyMDAnKTsKICAgIGV4cGVjdChkYXRhLmdldFRleHQoKSkudG9NYXRjaCgvU3VwZXIgSGVybyEvKTsKICB9KTsKCiAgICAgICAgIGl0KCdzaG91bGQgbWFrZSBKU09OUCByZXF1ZXN0IHRvIGludmFsaWQgVVJMIGFuZCBpbnZva2UgdGhlIGVycm9yIGhhbmRsZXInLAogICAgICAgICBmdW5jdGlvbigpIHsKICAgIGludmFsaWRKc29ucEJ0bi5jbGljaygpOwogICAgZmV0Y2hCdG4uY2xpY2soKTsKICAgIGV4cGVjdChzdGF0dXMuZ2V0VGV4dCgpKS50b01hdGNoKCcwJyk7CiAgICBleHBlY3QoZGF0YS5nZXRUZXh0KCkpLnRvTWF0Y2goJ1JlcXVlc3QgZmFpbGVkJyk7CiAgfSk7CiAgICAgICAgIDwvZmlsZT4KICAgICAgICAgPC9leGFtcGxlPgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uICRodHRwKHJlcXVlc3RDb25maWcpIHsKICAgICAgICAgIHZhciBjb25maWcgPSB7CiAgICAgICAgICAgIG1ldGhvZDogJ2dldCcsCiAgICAgICAgICAgIHRyYW5zZm9ybVJlcXVlc3Q6IGRlZmF1bHRzLnRyYW5zZm9ybVJlcXVlc3QsCiAgICAgICAgICAgIHRyYW5zZm9ybVJlc3BvbnNlOiBkZWZhdWx0cy50cmFuc2Zvcm1SZXNwb25zZQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBoZWFkZXJzID0gbWVyZ2VIZWFkZXJzKHJlcXVlc3RDb25maWcpOwoKICAgICAgICAgIGV4dGVuZChjb25maWcsIHJlcXVlc3RDb25maWcpOwogICAgICAgICAgY29uZmlnLmhlYWRlcnMgPSBoZWFkZXJzOwogICAgICAgICAgY29uZmlnLm1ldGhvZCA9IHVwcGVyY2FzZShjb25maWcubWV0aG9kKTsKCiAgICAgICAgICB2YXIgeHNyZlZhbHVlID0gdXJsSXNTYW1lT3JpZ2luKGNvbmZpZy51cmwpCiAgICAgICAgICAgID8gJGJyb3dzZXIuY29va2llcygpW2NvbmZpZy54c3JmQ29va2llTmFtZSB8fCBkZWZhdWx0cy54c3JmQ29va2llTmFtZV0KICAgICAgICAgICAgOiB1bmRlZmluZWQ7CiAgICAgICAgICBpZiAoeHNyZlZhbHVlKSB7CiAgICAgICAgICAgIGhlYWRlcnNbKGNvbmZpZy54c3JmSGVhZGVyTmFtZSB8fCBkZWZhdWx0cy54c3JmSGVhZGVyTmFtZSldID0geHNyZlZhbHVlOwogICAgICAgICAgfQoKCiAgICAgICAgICB2YXIgc2VydmVyUmVxdWVzdCA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgICAgICBoZWFkZXJzID0gY29uZmlnLmhlYWRlcnM7CiAgICAgICAgICAgIHZhciByZXFEYXRhID0gdHJhbnNmb3JtRGF0YShjb25maWcuZGF0YSwgaGVhZGVyc0dldHRlcihoZWFkZXJzKSwgY29uZmlnLnRyYW5zZm9ybVJlcXVlc3QpOwoKICAgICAgICAgICAgLy8gc3RyaXAgY29udGVudC10eXBlIGlmIGRhdGEgaXMgdW5kZWZpbmVkCiAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChjb25maWcuZGF0YSkpIHsKICAgICAgICAgICAgICBmb3JFYWNoKGhlYWRlcnMsIGZ1bmN0aW9uKHZhbHVlLCBoZWFkZXIpIHsKICAgICAgICAgICAgICAgIGlmIChsb3dlcmNhc2UoaGVhZGVyKSA9PT0gJ2NvbnRlbnQtdHlwZScpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlIGhlYWRlcnNbaGVhZGVyXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGNvbmZpZy53aXRoQ3JlZGVudGlhbHMpICYmICFpc1VuZGVmaW5lZChkZWZhdWx0cy53aXRoQ3JlZGVudGlhbHMpKSB7CiAgICAgICAgICAgICAgY29uZmlnLndpdGhDcmVkZW50aWFscyA9IGRlZmF1bHRzLndpdGhDcmVkZW50aWFsczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gc2VuZCByZXF1ZXN0CiAgICAgICAgICAgIHJldHVybiBzZW5kUmVxKGNvbmZpZywgcmVxRGF0YSwgaGVhZGVycykudGhlbih0cmFuc2Zvcm1SZXNwb25zZSwgdHJhbnNmb3JtUmVzcG9uc2UpOwogICAgICAgICAgfTsKCiAgICAgICAgICB2YXIgY2hhaW4gPSBbc2VydmVyUmVxdWVzdCwgdW5kZWZpbmVkXTsKICAgICAgICAgIHZhciBwcm9taXNlID0gJHEud2hlbihjb25maWcpOwoKICAgICAgICAgIC8vIGFwcGx5IGludGVyY2VwdG9ycwogICAgICAgICAgZm9yRWFjaChyZXZlcnNlZEludGVyY2VwdG9ycywgZnVuY3Rpb24oaW50ZXJjZXB0b3IpIHsKICAgICAgICAgICAgaWYgKGludGVyY2VwdG9yLnJlcXVlc3QgfHwgaW50ZXJjZXB0b3IucmVxdWVzdEVycm9yKSB7CiAgICAgICAgICAgICAgY2hhaW4udW5zaGlmdChpbnRlcmNlcHRvci5yZXF1ZXN0LCBpbnRlcmNlcHRvci5yZXF1ZXN0RXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnRlcmNlcHRvci5yZXNwb25zZSB8fCBpbnRlcmNlcHRvci5yZXNwb25zZUVycm9yKSB7CiAgICAgICAgICAgICAgY2hhaW4ucHVzaChpbnRlcmNlcHRvci5yZXNwb25zZSwgaW50ZXJjZXB0b3IucmVzcG9uc2VFcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHdoaWxlKGNoYWluLmxlbmd0aCkgewogICAgICAgICAgICB2YXIgdGhlbkZuID0gY2hhaW4uc2hpZnQoKTsKICAgICAgICAgICAgdmFyIHJlamVjdEZuID0gY2hhaW4uc2hpZnQoKTsKCiAgICAgICAgICAgIHByb21pc2UgPSBwcm9taXNlLnRoZW4odGhlbkZuLCByZWplY3RGbik7CiAgICAgICAgICB9CgogICAgICAgICAgcHJvbWlzZS5zdWNjZXNzID0gZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgZm4ocmVzcG9uc2UuZGF0YSwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZS5oZWFkZXJzLCBjb25maWcpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgICB9OwoKICAgICAgICAgIHByb21pc2UuZXJyb3IgPSBmdW5jdGlvbihmbikgewogICAgICAgICAgICBwcm9taXNlLnRoZW4obnVsbCwgZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICBmbihyZXNwb25zZS5kYXRhLCByZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmhlYWRlcnMsIGNvbmZpZyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICAgIH07CgogICAgICAgICAgcmV0dXJuIHByb21pc2U7CgogICAgICAgICAgZnVuY3Rpb24gdHJhbnNmb3JtUmVzcG9uc2UocmVzcG9uc2UpIHsKICAgICAgICAgICAgLy8gbWFrZSBhIGNvcHkgc2luY2UgdGhlIHJlc3BvbnNlIG11c3QgYmUgY2FjaGVhYmxlCiAgICAgICAgICAgIHZhciByZXNwID0gZXh0ZW5kKHt9LCByZXNwb25zZSwgewogICAgICAgICAgICAgIGRhdGE6IHRyYW5zZm9ybURhdGEocmVzcG9uc2UuZGF0YSwgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnLnRyYW5zZm9ybVJlc3BvbnNlKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIChpc1N1Y2Nlc3MocmVzcG9uc2Uuc3RhdHVzKSkKICAgICAgICAgICAgICA/IHJlc3AKICAgICAgICAgICAgICA6ICRxLnJlamVjdChyZXNwKTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBtZXJnZUhlYWRlcnMoY29uZmlnKSB7CiAgICAgICAgICAgIHZhciBkZWZIZWFkZXJzID0gZGVmYXVsdHMuaGVhZGVycywKICAgICAgICAgICAgICByZXFIZWFkZXJzID0gZXh0ZW5kKHt9LCBjb25maWcuaGVhZGVycyksCiAgICAgICAgICAgICAgZGVmSGVhZGVyTmFtZSwgbG93ZXJjYXNlRGVmSGVhZGVyTmFtZSwgcmVxSGVhZGVyTmFtZTsKCiAgICAgICAgICAgIGRlZkhlYWRlcnMgPSBleHRlbmQoe30sIGRlZkhlYWRlcnMuY29tbW9uLCBkZWZIZWFkZXJzW2xvd2VyY2FzZShjb25maWcubWV0aG9kKV0pOwoKICAgICAgICAgICAgLy8gZXhlY3V0ZSBpZiBoZWFkZXIgdmFsdWUgaXMgZnVuY3Rpb24KICAgICAgICAgICAgZXhlY0hlYWRlcnMoZGVmSGVhZGVycyk7CiAgICAgICAgICAgIGV4ZWNIZWFkZXJzKHJlcUhlYWRlcnMpOwoKICAgICAgICAgICAgLy8gdXNpbmcgZm9yLWluIGluc3RlYWQgb2YgZm9yRWFjaCB0byBhdm9pZCB1bmVjZXNzYXJ5IGl0ZXJhdGlvbiBhZnRlciBoZWFkZXIgaGFzIGJlZW4gZm91bmQKICAgICAgICAgICAgZGVmYXVsdEhlYWRlcnNJdGVyYXRpb246CiAgICAgICAgICAgICAgZm9yIChkZWZIZWFkZXJOYW1lIGluIGRlZkhlYWRlcnMpIHsKICAgICAgICAgICAgICAgIGxvd2VyY2FzZURlZkhlYWRlck5hbWUgPSBsb3dlcmNhc2UoZGVmSGVhZGVyTmFtZSk7CgogICAgICAgICAgICAgICAgZm9yIChyZXFIZWFkZXJOYW1lIGluIHJlcUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShyZXFIZWFkZXJOYW1lKSA9PT0gbG93ZXJjYXNlRGVmSGVhZGVyTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIGRlZmF1bHRIZWFkZXJzSXRlcmF0aW9uOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmVxSGVhZGVyc1tkZWZIZWFkZXJOYW1lXSA9IGRlZkhlYWRlcnNbZGVmSGVhZGVyTmFtZV07CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlcUhlYWRlcnM7CgogICAgICAgICAgICBmdW5jdGlvbiBleGVjSGVhZGVycyhoZWFkZXJzKSB7CiAgICAgICAgICAgICAgdmFyIGhlYWRlckNvbnRlbnQ7CgogICAgICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24oaGVhZGVyRm4sIGhlYWRlcikgewogICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oaGVhZGVyRm4pKSB7CiAgICAgICAgICAgICAgICAgIGhlYWRlckNvbnRlbnQgPSBoZWFkZXJGbigpOwogICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyQ29udGVudCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaGVhZGVyc1toZWFkZXJdID0gaGVhZGVyQ29udGVudDsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgICRodHRwLnBlbmRpbmdSZXF1ZXN0cyA9IFtdOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGh0dHAjZ2V0CiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgR0VUYCByZXF1ZXN0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAqLwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGh0dHAjZGVsZXRlCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgREVMRVRFYCByZXF1ZXN0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAqLwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGh0dHAjaGVhZAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEhFQURgIHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICovCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkaHR0cCNqc29ucAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYEpTT05QYCByZXF1ZXN0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QuCiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICBTaG91bGQgY29udGFpbiBgSlNPTl9DQUxMQkFDS2Agc3RyaW5nLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICovCiAgICAgICAgY3JlYXRlU2hvcnRNZXRob2RzKCdnZXQnLCAnZGVsZXRlJywgJ2hlYWQnLCAnanNvbnAnKTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRodHRwI3Bvc3QKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBQT1NUYCByZXF1ZXN0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgKiBAcGFyYW0geyp9IGRhdGEgUmVxdWVzdCBjb250ZW50CiAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgKi8KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRodHRwI3B1dAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYFBVVGAgcmVxdWVzdC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICogQHBhcmFtIHsqfSBkYXRhIFJlcXVlc3QgY29udGVudAogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICovCiAgICAgICAgY3JlYXRlU2hvcnRNZXRob2RzV2l0aERhdGEoJ3Bvc3QnLCAncHV0Jyk7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAqIEBuYW1lICRodHRwI2RlZmF1bHRzCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBSdW50aW1lIGVxdWl2YWxlbnQgb2YgdGhlIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzYCBwcm9wZXJ0eS4gQWxsb3dzIGNvbmZpZ3VyYXRpb24gb2YKICAgICAgICAgKiBkZWZhdWx0IGhlYWRlcnMsIHdpdGhDcmVkZW50aWFscyBhcyB3ZWxsIGFzIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWF0aW9ucy4KICAgICAgICAgKgogICAgICAgICAqIFNlZSAiU2V0dGluZyBIVFRQIEhlYWRlcnMiIGFuZCAiVHJhbnNmb3JtaW5nIFJlcXVlc3RzIGFuZCBSZXNwb25zZXMiIHNlY3Rpb25zIGFib3ZlLgogICAgICAgICAqLwogICAgICAgICRodHRwLmRlZmF1bHRzID0gZGVmYXVsdHM7CgoKICAgICAgICByZXR1cm4gJGh0dHA7CgoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVTaG9ydE1ldGhvZHMobmFtZXMpIHsKICAgICAgICAgIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICRodHRwW25hbWVdID0gZnVuY3Rpb24odXJsLCBjb25maWcpIHsKICAgICAgICAgICAgICByZXR1cm4gJGh0dHAoZXh0ZW5kKGNvbmZpZyB8fCB7fSwgewogICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgdXJsOiB1cmwKICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9KTsKICAgICAgICB9CgoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVTaG9ydE1ldGhvZHNXaXRoRGF0YShuYW1lKSB7CiAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAkaHR0cFtuYW1lXSA9IGZ1bmN0aW9uKHVybCwgZGF0YSwgY29uZmlnKSB7CiAgICAgICAgICAgICAgcmV0dXJuICRodHRwKGV4dGVuZChjb25maWcgfHwge30sIHsKICAgICAgICAgICAgICAgIG1ldGhvZDogbmFtZSwKICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCgogICAgICAgIC8qKgogICAgICAgICAqIE1ha2VzIHRoZSByZXF1ZXN0LgogICAgICAgICAqCiAgICAgICAgICogISEhIEFDQ0VTU0VTIENMT1NVUkUgVkFSUzoKICAgICAgICAgKiAkaHR0cEJhY2tlbmQsIGRlZmF1bHRzLCAkbG9nLCAkcm9vdFNjb3BlLCBkZWZhdWx0Q2FjaGUsICRodHRwLnBlbmRpbmdSZXF1ZXN0cwogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHNlbmRSZXEoY29uZmlnLCByZXFEYXRhLCByZXFIZWFkZXJzKSB7CiAgICAgICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpLAogICAgICAgICAgICBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZSwKICAgICAgICAgICAgY2FjaGUsCiAgICAgICAgICAgIGNhY2hlZFJlc3AsCiAgICAgICAgICAgIHVybCA9IGJ1aWxkVXJsKGNvbmZpZy51cmwsIGNvbmZpZy5wYXJhbXMpOwoKICAgICAgICAgICRodHRwLnBlbmRpbmdSZXF1ZXN0cy5wdXNoKGNvbmZpZyk7CiAgICAgICAgICBwcm9taXNlLnRoZW4ocmVtb3ZlUGVuZGluZ1JlcSwgcmVtb3ZlUGVuZGluZ1JlcSk7CgoKICAgICAgICAgIGlmICgoY29uZmlnLmNhY2hlIHx8IGRlZmF1bHRzLmNhY2hlKSAmJiBjb25maWcuY2FjaGUgIT09IGZhbHNlICYmIGNvbmZpZy5tZXRob2QgPT0gJ0dFVCcpIHsKICAgICAgICAgICAgY2FjaGUgPSBpc09iamVjdChjb25maWcuY2FjaGUpID8gY29uZmlnLmNhY2hlCiAgICAgICAgICAgICAgOiBpc09iamVjdChkZWZhdWx0cy5jYWNoZSkgPyBkZWZhdWx0cy5jYWNoZQogICAgICAgICAgICAgIDogZGVmYXVsdENhY2hlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgICBjYWNoZWRSZXNwID0gY2FjaGUuZ2V0KHVybCk7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgICAgICBpZiAoY2FjaGVkUmVzcC50aGVuKSB7CiAgICAgICAgICAgICAgICAvLyBjYWNoZWQgcmVxdWVzdCBoYXMgYWxyZWFkeSBiZWVuIHNlbnQsIGJ1dCB0aGVyZSBpcyBubyByZXNwb25zZSB5ZXQKICAgICAgICAgICAgICAgIGNhY2hlZFJlc3AudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKICAgICAgICAgICAgICAgIHJldHVybiBjYWNoZWRSZXNwOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBzZXJ2aW5nIGZyb20gY2FjaGUKICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KGNhY2hlZFJlc3ApKSB7CiAgICAgICAgICAgICAgICAgIHJlc29sdmVQcm9taXNlKGNhY2hlZFJlc3BbMV0sIGNhY2hlZFJlc3BbMF0sIHNoYWxsb3dDb3B5KGNhY2hlZFJlc3BbMl0pLCBjYWNoZWRSZXNwWzNdKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlc29sdmVQcm9taXNlKGNhY2hlZFJlc3AsIDIwMCwge30sICdPSycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBwdXQgdGhlIHByb21pc2UgZm9yIHRoZSBub24tdHJhbnNmb3JtZWQgcmVzcG9uc2UgaW50byBjYWNoZSBhcyBhIHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgY2FjaGUucHV0KHVybCwgcHJvbWlzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBpZiB3ZSB3b24ndCBoYXZlIHRoZSByZXNwb25zZSBpbiBjYWNoZSwgc2VuZCB0aGUgcmVxdWVzdCB0byB0aGUgYmFja2VuZAogICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGNhY2hlZFJlc3ApKSB7CiAgICAgICAgICAgICRodHRwQmFja2VuZChjb25maWcubWV0aG9kLCB1cmwsIHJlcURhdGEsIGRvbmUsIHJlcUhlYWRlcnMsIGNvbmZpZy50aW1lb3V0LAogICAgICAgICAgICAgIGNvbmZpZy53aXRoQ3JlZGVudGlhbHMsIGNvbmZpZy5yZXNwb25zZVR5cGUpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBwcm9taXNlOwoKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIENhbGxiYWNrIHJlZ2lzdGVyZWQgdG8gJGh0dHBCYWNrZW5kKCk6CiAgICAgICAgICAgKiAgLSBjYWNoZXMgdGhlIHJlc3BvbnNlIGlmIGRlc2lyZWQKICAgICAgICAgICAqICAtIHJlc29sdmVzIHRoZSByYXcgJGh0dHAgcHJvbWlzZQogICAgICAgICAgICogIC0gY2FsbHMgJGFwcGx5CiAgICAgICAgICAgKi8KICAgICAgICAgIGZ1bmN0aW9uIGRvbmUoc3RhdHVzLCByZXNwb25zZSwgaGVhZGVyc1N0cmluZywgc3RhdHVzVGV4dCkgewogICAgICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgICAgICBpZiAoaXNTdWNjZXNzKHN0YXR1cykpIHsKICAgICAgICAgICAgICAgIGNhY2hlLnB1dCh1cmwsIFtzdGF0dXMsIHJlc3BvbnNlLCBwYXJzZUhlYWRlcnMoaGVhZGVyc1N0cmluZyksIHN0YXR1c1RleHRdKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHByb21pc2UgZnJvbSB0aGUgY2FjaGUKICAgICAgICAgICAgICAgIGNhY2hlLnJlbW92ZSh1cmwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UocmVzcG9uc2UsIHN0YXR1cywgaGVhZGVyc1N0cmluZywgc3RhdHVzVGV4dCk7CiAgICAgICAgICAgIGlmICghJHJvb3RTY29wZS4kJHBoYXNlKSAkcm9vdFNjb3BlLiRhcHBseSgpOwogICAgICAgICAgfQoKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIFJlc29sdmVzIHRoZSByYXcgJGh0dHAgcHJvbWlzZS4KICAgICAgICAgICAqLwogICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZVByb21pc2UocmVzcG9uc2UsIHN0YXR1cywgaGVhZGVycywgc3RhdHVzVGV4dCkgewogICAgICAgICAgICAvLyBub3JtYWxpemUgaW50ZXJuYWwgc3RhdHVzZXMgdG8gMAogICAgICAgICAgICBzdGF0dXMgPSBNYXRoLm1heChzdGF0dXMsIDApOwoKICAgICAgICAgICAgKGlzU3VjY2VzcyhzdGF0dXMpID8gZGVmZXJyZWQucmVzb2x2ZSA6IGRlZmVycmVkLnJlamVjdCkoewogICAgICAgICAgICAgIGRhdGE6IHJlc3BvbnNlLAogICAgICAgICAgICAgIHN0YXR1czogc3RhdHVzLAogICAgICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnNHZXR0ZXIoaGVhZGVycyksCiAgICAgICAgICAgICAgY29uZmlnOiBjb25maWcsCiAgICAgICAgICAgICAgc3RhdHVzVGV4dCA6IHN0YXR1c1RleHQKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgoKICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZVBlbmRpbmdSZXEoKSB7CiAgICAgICAgICAgIHZhciBpZHggPSBpbmRleE9mKCRodHRwLnBlbmRpbmdSZXF1ZXN0cywgY29uZmlnKTsKICAgICAgICAgICAgaWYgKGlkeCAhPT0gLTEpICRodHRwLnBlbmRpbmdSZXF1ZXN0cy5zcGxpY2UoaWR4LCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CgoKICAgICAgICBmdW5jdGlvbiBidWlsZFVybCh1cmwsIHBhcmFtcykgewogICAgICAgICAgaWYgKCFwYXJhbXMpIHJldHVybiB1cmw7CiAgICAgICAgICB2YXIgcGFydHMgPSBbXTsKICAgICAgICAgIGZvckVhY2hTb3J0ZWQocGFyYW1zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCBpc1VuZGVmaW5lZCh2YWx1ZSkpIHJldHVybjsKICAgICAgICAgICAgaWYgKCFpc0FycmF5KHZhbHVlKSkgdmFsdWUgPSBbdmFsdWVdOwoKICAgICAgICAgICAgZm9yRWFjaCh2YWx1ZSwgZnVuY3Rpb24odikgewogICAgICAgICAgICAgIGlmIChpc09iamVjdCh2KSkgewogICAgICAgICAgICAgICAgdiA9IHRvSnNvbih2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFydHMucHVzaChlbmNvZGVVcmlRdWVyeShrZXkpICsgJz0nICsKICAgICAgICAgICAgICAgIGVuY29kZVVyaVF1ZXJ5KHYpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmKHBhcnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdXJsICs9ICgodXJsLmluZGV4T2YoJz8nKSA9PSAtMSkgPyAnPycgOiAnJicpICsgcGFydHMuam9pbignJicpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVybDsKICAgICAgICB9CgoKICAgICAgfV07CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVYaHIobWV0aG9kKSB7CiAgICAvL2lmIElFIGFuZCB0aGUgbWV0aG9kIGlzIG5vdCBSRkMyNjE2IGNvbXBsaWFudCwgb3IgaWYgWE1MSHR0cFJlcXVlc3QKICAgIC8vaXMgbm90IGF2YWlsYWJsZSwgdHJ5IGdldHRpbmcgYW4gQWN0aXZlWE9iamVjdC4gT3RoZXJ3aXNlLCB1c2UgWE1MSHR0cFJlcXVlc3QKICAgIC8vaWYgaXQgaXMgYXZhaWxhYmxlCiAgICBpZiAobXNpZSA8PSA4ICYmICghbWV0aG9kLm1hdGNoKC9eKGdldHxwb3N0fGhlYWR8cHV0fGRlbGV0ZXxvcHRpb25zKSQvaSkgfHwKICAgICAgIXdpbmRvdy5YTUxIdHRwUmVxdWVzdCkpIHsKICAgICAgcmV0dXJuIG5ldyB3aW5kb3cuQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKICAgIH0gZWxzZSBpZiAod2luZG93LlhNTEh0dHBSZXF1ZXN0KSB7CiAgICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCk7CiAgICB9CgogICAgdGhyb3cgbWluRXJyKCckaHR0cEJhY2tlbmQnKSgnbm94aHInLCAiVGhpcyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgWE1MSHR0cFJlcXVlc3QuIik7CiAgfQoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRodHRwQmFja2VuZAogICAqIEByZXF1aXJlcyAkd2luZG93CiAgICogQHJlcXVpcmVzICRkb2N1bWVudAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogSFRUUCBiYWNrZW5kIHVzZWQgYnkgdGhlIHtAbGluayBuZy4kaHR0cCBzZXJ2aWNlfSB0aGF0IGRlbGVnYXRlcyB0bwogICAqIFhNTEh0dHBSZXF1ZXN0IG9iamVjdCBvciBKU09OUCBhbmQgZGVhbHMgd2l0aCBicm93c2VyIGluY29tcGF0aWJpbGl0aWVzLgogICAqCiAgICogWW91IHNob3VsZCBuZXZlciBuZWVkIHRvIHVzZSB0aGlzIHNlcnZpY2UgZGlyZWN0bHksIGluc3RlYWQgdXNlIHRoZSBoaWdoZXItbGV2ZWwgYWJzdHJhY3Rpb25zOgogICAqIHtAbGluayBuZy4kaHR0cCAkaHR0cH0gb3Ige0BsaW5rIG5nUmVzb3VyY2UuJHJlc291cmNlICRyZXNvdXJjZX0uCiAgICoKICAgKiBEdXJpbmcgdGVzdGluZyB0aGlzIGltcGxlbWVudGF0aW9uIGlzIHN3YXBwZWQgd2l0aCB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCBtb2NrCiAqICRodHRwQmFja2VuZH0gd2hpY2ggY2FuIGJlIHRyYWluZWQgd2l0aCByZXNwb25zZXMuCiAgICovCiAgZnVuY3Rpb24gJEh0dHBCYWNrZW5kUHJvdmlkZXIoKSB7CiAgICB0aGlzLiRnZXQgPSBbJyRicm93c2VyJywgJyR3aW5kb3cnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24oJGJyb3dzZXIsICR3aW5kb3csICRkb2N1bWVudCkgewogICAgICByZXR1cm4gY3JlYXRlSHR0cEJhY2tlbmQoJGJyb3dzZXIsIGNyZWF0ZVhociwgJGJyb3dzZXIuZGVmZXIsICR3aW5kb3cuYW5ndWxhci5jYWxsYmFja3MsICRkb2N1bWVudFswXSk7CiAgICB9XTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUh0dHBCYWNrZW5kKCRicm93c2VyLCBjcmVhdGVYaHIsICRicm93c2VyRGVmZXIsIGNhbGxiYWNrcywgcmF3RG9jdW1lbnQpIHsKICAgIHZhciBBQk9SVEVEID0gLTE7CgogICAgLy8gVE9ETyh2b2p0YSk6IGZpeCB0aGUgc2lnbmF0dXJlCiAgICByZXR1cm4gZnVuY3Rpb24obWV0aG9kLCB1cmwsIHBvc3QsIGNhbGxiYWNrLCBoZWFkZXJzLCB0aW1lb3V0LCB3aXRoQ3JlZGVudGlhbHMsIHJlc3BvbnNlVHlwZSkgewogICAgICB2YXIgc3RhdHVzOwogICAgICAkYnJvd3Nlci4kJGluY091dHN0YW5kaW5nUmVxdWVzdENvdW50KCk7CiAgICAgIHVybCA9IHVybCB8fCAkYnJvd3Nlci51cmwoKTsKCiAgICAgIGlmIChsb3dlcmNhc2UobWV0aG9kKSA9PSAnanNvbnAnKSB7CiAgICAgICAgdmFyIGNhbGxiYWNrSWQgPSAnXycgKyAoY2FsbGJhY2tzLmNvdW50ZXIrKykudG9TdHJpbmcoMzYpOwogICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXS5kYXRhID0gZGF0YTsKICAgICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXS5jYWxsZWQgPSB0cnVlOwogICAgICAgIH07CgogICAgICAgIHZhciBqc29ucERvbmUgPSBqc29ucFJlcSh1cmwucmVwbGFjZSgnSlNPTl9DQUxMQkFDSycsICdhbmd1bGFyLmNhbGxiYWNrcy4nICsgY2FsbGJhY2tJZCksCiAgICAgICAgICBjYWxsYmFja0lkLCBmdW5jdGlvbihzdGF0dXMsIHRleHQpIHsKICAgICAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLCBzdGF0dXMsIGNhbGxiYWNrc1tjYWxsYmFja0lkXS5kYXRhLCAiIiwgdGV4dCk7CiAgICAgICAgICAgIGNhbGxiYWNrc1tjYWxsYmFja0lkXSA9IG5vb3A7CiAgICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKCiAgICAgICAgdmFyIHhociA9IGNyZWF0ZVhocihtZXRob2QpOwoKICAgICAgICB4aHIub3BlbihtZXRob2QsIHVybCwgdHJ1ZSk7CiAgICAgICAgZm9yRWFjaChoZWFkZXJzLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgLy8gSW4gSUU2IGFuZCA3LCB0aGlzIG1pZ2h0IGJlIGNhbGxlZCBzeW5jaHJvbm91c2x5IHdoZW4geGhyLnNlbmQgYmVsb3cgaXMgY2FsbGVkIGFuZCB0aGUKICAgICAgICAvLyByZXNwb25zZSBpcyBpbiB0aGUgY2FjaGUuIHRoZSBwcm9taXNlIGFwaSB3aWxsIGVuc3VyZSB0aGF0IHRvIHRoZSBhcHAgY29kZSB0aGUgYXBpIGlzCiAgICAgICAgLy8gYWx3YXlzIGFzeW5jCiAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gb25yZWFkeXN0YXRlY2hhbmdlIG1pZ2h0IGdldCBjYWxsZWQgbXVsdGlwbGUgdGltZXMgd2l0aCByZWFkeVN0YXRlID09PSA0IG9uIG1vYmlsZSB3ZWJraXQgY2F1c2VkIGJ5CiAgICAgICAgICAvLyB4aHJzIHRoYXQgYXJlIHJlc29sdmVkIHdoaWxlIHRoZSBhcHAgaXMgaW4gdGhlIGJhY2tncm91bmQgKHNlZSAjNTQyNikuCiAgICAgICAgICAvLyBzaW5jZSBjYWxsaW5nIGNvbXBsZXRlUmVxdWVzdCBzZXRzIHRoZSBgeGhyYCB2YXJpYWJsZSB0byBudWxsLCB3ZSBqdXN0IGNoZWNrIGlmIGl0J3Mgbm90IG51bGwgYmVmb3JlCiAgICAgICAgICAvLyBjb250aW51aW5nCiAgICAgICAgICAvLwogICAgICAgICAgLy8gd2UgY2FuJ3Qgc2V0IHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgdG8gdW5kZWZpbmVkIG9yIGRlbGV0ZSBpdCBiZWNhdXNlIHRoYXQgYnJlYWtzIElFOCAobWV0aG9kPVBBVENIKSBhbmQKICAgICAgICAgIC8vIFNhZmFyaSByZXNwZWN0aXZlbHkuCiAgICAgICAgICBpZiAoeGhyICYmIHhoci5yZWFkeVN0YXRlID09IDQpIHsKICAgICAgICAgICAgdmFyIHJlc3BvbnNlSGVhZGVycyA9IG51bGwsCiAgICAgICAgICAgICAgcmVzcG9uc2UgPSBudWxsOwoKICAgICAgICAgICAgaWYoc3RhdHVzICE9PSBBQk9SVEVEKSB7CiAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzID0geGhyLmdldEFsbFJlc3BvbnNlSGVhZGVycygpOwoKICAgICAgICAgICAgICAvLyByZXNwb25zZVRleHQgaXMgdGhlIG9sZC1zY2hvb2wgd2F5IG9mIHJldHJpZXZpbmcgcmVzcG9uc2UgKHN1cHBvcnRlZCBieSBJRTggJiA5KQogICAgICAgICAgICAgIC8vIHJlc3BvbnNlL3Jlc3BvbnNlVHlwZSBwcm9wZXJ0aWVzIHdlcmUgaW50cm9kdWNlZCBpbiBYSFIgTGV2ZWwyIHNwZWMgKHN1cHBvcnRlZCBieSBJRTEwKQogICAgICAgICAgICAgIHJlc3BvbnNlID0gKCdyZXNwb25zZScgaW4geGhyKSA/IHhoci5yZXNwb25zZSA6IHhoci5yZXNwb25zZVRleHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbXBsZXRlUmVxdWVzdChjYWxsYmFjaywKICAgICAgICAgICAgICAgIHN0YXR1cyB8fCB4aHIuc3RhdHVzLAogICAgICAgICAgICAgIHJlc3BvbnNlLAogICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycywKICAgICAgICAgICAgICAgIHhoci5zdGF0dXNUZXh0IHx8ICcnKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBpZiAod2l0aENyZWRlbnRpYWxzKSB7CiAgICAgICAgICB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmIChyZXNwb25zZVR5cGUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHhoci5yZXNwb25zZVR5cGUgPSByZXNwb25zZVR5cGU7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIC8vIFdlYktpdCBhZGRlZCBzdXBwb3J0IGZvciB0aGUganNvbiByZXNwb25zZVR5cGUgdmFsdWUgb24gMDkvMDMvMjAxMwogICAgICAgICAgICAvLyBodHRwczovL2J1Z3Mud2Via2l0Lm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NzM2NDguIFZlcnNpb25zIG9mIFNhZmFyaSBwcmlvciB0byA3IGFyZQogICAgICAgICAgICAvLyBrbm93biB0byB0aHJvdyB3aGVuIHNldHRpbmcgdGhlIHZhbHVlICJqc29uIiBhcyB0aGUgcmVzcG9uc2UgdHlwZS4gT3RoZXIgb2xkZXIKICAgICAgICAgICAgLy8gYnJvd3NlcnMgaW1wbGVtZW50aW5nIHRoZSByZXNwb25zZVR5cGUKICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gVGhlIGpzb24gcmVzcG9uc2UgdHlwZSBjYW4gYmUgaWdub3JlZCBpZiBub3Qgc3VwcG9ydGVkLCBiZWNhdXNlIEpTT04gcGF5bG9hZHMgYXJlCiAgICAgICAgICAgIC8vIHBhcnNlZCBvbiB0aGUgY2xpZW50LXNpZGUgcmVnYXJkbGVzcy4KICAgICAgICAgICAgaWYgKHJlc3BvbnNlVHlwZSAhPT0gJ2pzb24nKSB7CiAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgeGhyLnNlbmQocG9zdCB8fCBudWxsKTsKICAgICAgfQoKICAgICAgaWYgKHRpbWVvdXQgPiAwKSB7CiAgICAgICAgdmFyIHRpbWVvdXRJZCA9ICRicm93c2VyRGVmZXIodGltZW91dFJlcXVlc3QsIHRpbWVvdXQpOwogICAgICB9IGVsc2UgaWYgKHRpbWVvdXQgJiYgdGltZW91dC50aGVuKSB7CiAgICAgICAgdGltZW91dC50aGVuKHRpbWVvdXRSZXF1ZXN0KTsKICAgICAgfQoKCiAgICAgIGZ1bmN0aW9uIHRpbWVvdXRSZXF1ZXN0KCkgewogICAgICAgIHN0YXR1cyA9IEFCT1JURUQ7CiAgICAgICAganNvbnBEb25lICYmIGpzb25wRG9uZSgpOwogICAgICAgIHhociAmJiB4aHIuYWJvcnQoKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLCBzdGF0dXMsIHJlc3BvbnNlLCBoZWFkZXJzU3RyaW5nLCBzdGF0dXNUZXh0KSB7CiAgICAgICAgLy8gY2FuY2VsIHRpbWVvdXQgYW5kIHN1YnNlcXVlbnQgdGltZW91dCBwcm9taXNlIHJlc29sdXRpb24KICAgICAgICB0aW1lb3V0SWQgJiYgJGJyb3dzZXJEZWZlci5jYW5jZWwodGltZW91dElkKTsKICAgICAgICBqc29ucERvbmUgPSB4aHIgPSBudWxsOwoKICAgICAgICAvLyBmaXggc3RhdHVzIGNvZGUgd2hlbiBpdCBpcyAwICgwIHN0YXR1cyBpcyB1bmRvY3VtZW50ZWQpLgogICAgICAgIC8vIE9jY3VycyB3aGVuIGFjY2Vzc2luZyBmaWxlIHJlc291cmNlcyBvciBvbiBBbmRyb2lkIDQuMSBzdG9jayBicm93c2VyCiAgICAgICAgLy8gd2hpbGUgcmV0cmlldmluZyBmaWxlcyBmcm9tIGFwcGxpY2F0aW9uIGNhY2hlLgogICAgICAgIGlmIChzdGF0dXMgPT09IDApIHsKICAgICAgICAgIHN0YXR1cyA9IHJlc3BvbnNlID8gMjAwIDogdXJsUmVzb2x2ZSh1cmwpLnByb3RvY29sID09ICdmaWxlJyA/IDQwNCA6IDA7CiAgICAgICAgfQoKICAgICAgICAvLyBub3JtYWxpemUgSUUgYnVnIChodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xNDUwKQogICAgICAgIHN0YXR1cyA9IHN0YXR1cyA9PT0gMTIyMyA/IDIwNCA6IHN0YXR1czsKICAgICAgICBzdGF0dXNUZXh0ID0gc3RhdHVzVGV4dCB8fCAnJzsKCiAgICAgICAgY2FsbGJhY2soc3RhdHVzLCByZXNwb25zZSwgaGVhZGVyc1N0cmluZywgc3RhdHVzVGV4dCk7CiAgICAgICAgJGJyb3dzZXIuJCRjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdChub29wKTsKICAgICAgfQogICAgfTsKCiAgICBmdW5jdGlvbiBqc29ucFJlcSh1cmwsIGNhbGxiYWNrSWQsIGRvbmUpIHsKICAgICAgLy8gd2UgY2FuJ3QgdXNlIGpRdWVyeS9qcUxpdGUgaGVyZSBiZWNhdXNlIGpRdWVyeSBkb2VzIGNyYXp5IHNoaXQgd2l0aCBzY3JpcHQgZWxlbWVudHMsIGUuZy46CiAgICAgIC8vIC0gZmV0Y2hlcyBsb2NhbCBzY3JpcHRzIHZpYSBYSFIgYW5kIGV2YWxzIHRoZW0KICAgICAgLy8gLSBhZGRzIGFuZCBpbW1lZGlhdGVseSByZW1vdmVzIHNjcmlwdCBlbGVtZW50cyBmcm9tIHRoZSBkb2N1bWVudAogICAgICB2YXIgc2NyaXB0ID0gcmF3RG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0JyksIGNhbGxiYWNrID0gbnVsbDsKICAgICAgc2NyaXB0LnR5cGUgPSAidGV4dC9qYXZhc2NyaXB0IjsKICAgICAgc2NyaXB0LnNyYyA9IHVybDsKICAgICAgc2NyaXB0LmFzeW5jID0gdHJ1ZTsKCiAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oc2NyaXB0LCAibG9hZCIsIGNhbGxiYWNrKTsKICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oc2NyaXB0LCAiZXJyb3IiLCBjYWxsYmFjayk7CiAgICAgICAgcmF3RG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICAgIHNjcmlwdCA9IG51bGw7CiAgICAgICAgdmFyIHN0YXR1cyA9IC0xOwogICAgICAgIHZhciB0ZXh0ID0gInVua25vd24iOwoKICAgICAgICBpZiAoZXZlbnQpIHsKICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAibG9hZCIgJiYgIWNhbGxiYWNrc1tjYWxsYmFja0lkXS5jYWxsZWQpIHsKICAgICAgICAgICAgZXZlbnQgPSB7IHR5cGU6ICJlcnJvciIgfTsKICAgICAgICAgIH0KICAgICAgICAgIHRleHQgPSBldmVudC50eXBlOwogICAgICAgICAgc3RhdHVzID0gZXZlbnQudHlwZSA9PT0gImVycm9yIiA/IDQwNCA6IDIwMDsKICAgICAgICB9CgogICAgICAgIGlmIChkb25lKSB7CiAgICAgICAgICBkb25lKHN0YXR1cywgdGV4dCk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKHNjcmlwdCwgImxvYWQiLCBjYWxsYmFjayk7CiAgICAgIGFkZEV2ZW50TGlzdGVuZXJGbihzY3JpcHQsICJlcnJvciIsIGNhbGxiYWNrKTsKCiAgICAgIGlmIChtc2llIDw9IDgpIHsKICAgICAgICBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoaXNTdHJpbmcoc2NyaXB0LnJlYWR5U3RhdGUpICYmIC9sb2FkZWR8Y29tcGxldGUvLnRlc3Qoc2NyaXB0LnJlYWR5U3RhdGUpKSB7CiAgICAgICAgICAgIHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwogICAgICAgICAgICBjYWxsYmFjayh7CiAgICAgICAgICAgICAgdHlwZTogJ2xvYWQnCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJhd0RvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgfQogIH0KCiAgdmFyICRpbnRlcnBvbGF0ZU1pbkVyciA9IG1pbkVycignJGludGVycG9sYXRlJyk7CgogIC8qKgogICAqIEBuZ2RvYyBwcm92aWRlcgogICAqIEBuYW1lICRpbnRlcnBvbGF0ZVByb3ZpZGVyCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogVXNlZCBmb3IgY29uZmlndXJpbmcgdGhlIGludGVycG9sYXRpb24gbWFya3VwLiBEZWZhdWx0cyB0byBge3tgIGFuZCBgfX1gLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJjdXN0b21JbnRlcnBvbGF0aW9uQXBwIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIHZhciBjdXN0b21JbnRlcnBvbGF0aW9uQXBwID0gYW5ndWxhci5tb2R1bGUoJ2N1c3RvbUludGVycG9sYXRpb25BcHAnLCBbXSk7CgogICBjdXN0b21JbnRlcnBvbGF0aW9uQXBwLmNvbmZpZyhmdW5jdGlvbigkaW50ZXJwb2xhdGVQcm92aWRlcikgewogICAgJGludGVycG9sYXRlUHJvdmlkZXIuc3RhcnRTeW1ib2woJy8vJyk7CiAgICAkaW50ZXJwb2xhdGVQcm92aWRlci5lbmRTeW1ib2woJy8vJyk7CiAgfSk7CgoKICAgY3VzdG9tSW50ZXJwb2xhdGlvbkFwcC5jb250cm9sbGVyKCdEZW1vQ29udHJvbGxlcicsIGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmxhYmVsID0gIlRoaXMgYmluZGluZyBpcyBicm91Z2h0IHlvdSBieSAvLyBpbnRlcnBvbGF0aW9uIHN5bWJvbHMuIjsKICB9KTsKICAgPC9zY3JpcHQ+CiAgIDxkaXYgbmctYXBwPSJBcHAiIG5nLWNvbnRyb2xsZXI9IkRlbW9Db250cm9sbGVyIGFzIGRlbW8iPgogICAvL2RlbW8ubGFiZWwvLwogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBpbnRlcnBvbGF0ZSBiaW5kaW5nIHdpdGggY3VzdG9tIHN5bWJvbHMnLCBmdW5jdGlvbigpIHsKICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2RlbW8ubGFiZWwnKSkuZ2V0VGV4dCgpKS50b0JlKCdUaGlzIGJpbmRpbmcgaXMgYnJvdWdodCB5b3UgYnkgLy8gaW50ZXJwb2xhdGlvbiBzeW1ib2xzLicpOwogIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICBmdW5jdGlvbiAkSW50ZXJwb2xhdGVQcm92aWRlcigpIHsKICAgIHZhciBzdGFydFN5bWJvbCA9ICd7eyc7CiAgICB2YXIgZW5kU3ltYm9sID0gJ319JzsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFN5bWJvbCB0byBkZW5vdGUgc3RhcnQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYHt7YC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gdmFsdWUgbmV3IHZhbHVlIHRvIHNldCB0aGUgc3RhcnRpbmcgc3ltYm9sIHRvLgogICAgICogQHJldHVybnMge3N0cmluZ3xzZWxmfSBSZXR1cm5zIHRoZSBzeW1ib2wgd2hlbiB1c2VkIGFzIGdldHRlciBhbmQgc2VsZiBpZiB1c2VkIGFzIHNldHRlci4KICAgICAqLwogICAgdGhpcy5zdGFydFN5bWJvbCA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgc3RhcnRTeW1ib2wgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gc3RhcnRTeW1ib2w7CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2wKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgZW5kIG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB9fWAuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSB2YWx1ZSBuZXcgdmFsdWUgdG8gc2V0IHRoZSBlbmRpbmcgc3ltYm9sIHRvLgogICAgICogQHJldHVybnMge3N0cmluZ3xzZWxmfSBSZXR1cm5zIHRoZSBzeW1ib2wgd2hlbiB1c2VkIGFzIGdldHRlciBhbmQgc2VsZiBpZiB1c2VkIGFzIHNldHRlci4KICAgICAqLwogICAgdGhpcy5lbmRTeW1ib2wgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIGVuZFN5bWJvbCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICAgIH0KICAgIH07CgoKICAgIHRoaXMuJGdldCA9IFsnJHBhcnNlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRzY2UnLCBmdW5jdGlvbigkcGFyc2UsICRleGNlcHRpb25IYW5kbGVyLCAkc2NlKSB7CiAgICAgIHZhciBzdGFydFN5bWJvbExlbmd0aCA9IHN0YXJ0U3ltYm9sLmxlbmd0aCwKICAgICAgICBlbmRTeW1ib2xMZW5ndGggPSBlbmRTeW1ib2wubGVuZ3RoOwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgICAqIEBuYW1lICRpbnRlcnBvbGF0ZQogICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgKgogICAgICAgKiBAcmVxdWlyZXMgJHBhcnNlCiAgICAgICAqIEByZXF1aXJlcyAkc2NlCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKgogICAgICAgKiBDb21waWxlcyBhIHN0cmluZyB3aXRoIG1hcmt1cCBpbnRvIGFuIGludGVycG9sYXRpb24gZnVuY3Rpb24uIFRoaXMgc2VydmljZSBpcyB1c2VkIGJ5IHRoZQogICAgICAgKiBIVE1MIHtAbGluayBuZy4kY29tcGlsZSAkY29tcGlsZX0gc2VydmljZSBmb3IgZGF0YSBiaW5kaW5nLiBTZWUKICAgICAgICoge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyICRpbnRlcnBvbGF0ZVByb3ZpZGVyfSBmb3IgY29uZmlndXJpbmcgdGhlCiAgICAgICAqIGludGVycG9sYXRpb24gbWFya3VwLgogICAgICAgKgogICAgICAgKgogICAgICAgKiBgYGBqcwogICAgICAgKiAgIHZhciAkaW50ZXJwb2xhdGUgPSAuLi47IC8vIGluamVjdGVkCiAgICAgICAqICAgdmFyIGV4cCA9ICRpbnRlcnBvbGF0ZSgnSGVsbG8ge3tuYW1lIHwgdXBwZXJjYXNlfX0hJyk7CiAgICAgICAqICAgZXhwZWN0KGV4cCh7bmFtZTonQW5ndWxhcid9KS50b0VxdWFsKCdIZWxsbyBBTkdVTEFSIScpOwogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgVGhlIHRleHQgd2l0aCBtYXJrdXAgdG8gaW50ZXJwb2xhdGUuCiAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG11c3RIYXZlRXhwcmVzc2lvbiBpZiBzZXQgdG8gdHJ1ZSB0aGVuIHRoZSBpbnRlcnBvbGF0aW9uIHN0cmluZyBtdXN0IGhhdmUKICAgICAgICogICAgZW1iZWRkZWQgZXhwcmVzc2lvbiBpbiBvcmRlciB0byByZXR1cm4gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4gU3RyaW5ncyB3aXRoIG5vCiAgICAgICAqICAgIGVtYmVkZGVkIGV4cHJlc3Npb24gd2lsbCByZXR1cm4gbnVsbCBmb3IgdGhlIGludGVycG9sYXRpb24gZnVuY3Rpb24uCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdHJ1c3RlZENvbnRleHQgd2hlbiBwcm92aWRlZCwgdGhlIHJldHVybmVkIGZ1bmN0aW9uIHBhc3NlcyB0aGUgaW50ZXJwb2xhdGVkCiAgICAgICAqICAgIHJlc3VsdCB0aHJvdWdoIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWQgJHNjZS5nZXRUcnVzdGVkKGludGVycG9sYXRlZFJlc3VsdCwKICAgICAqICAgIHRydXN0ZWRDb250ZXh0KX0gYmVmb3JlIHJldHVybmluZyBpdC4gIFJlZmVyIHRvIHRoZSB7QGxpbmsgbmcuJHNjZSAkc2NlfSBzZXJ2aWNlIHRoYXQKICAgICAgICogICAgcHJvdmlkZXMgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgZm9yIGRldGFpbHMuCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0KX0gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbiB3aGljaCBpcyB1c2VkIHRvIGNvbXB1dGUgdGhlCiAgICAgICAqICAgIGludGVycG9sYXRlZCBzdHJpbmcuIFRoZSBmdW5jdGlvbiBoYXMgdGhlc2UgcGFyYW1ldGVyczoKICAgICAgICoKICAgICAgICogICAgKiBgY29udGV4dGA6IGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncyBhcmUgZXZhbHVhdGVkCiAgICAgICAqICAgICAgYWdhaW5zdC4KICAgICAgICoKICAgICAgICovCiAgICAgIGZ1bmN0aW9uICRpbnRlcnBvbGF0ZSh0ZXh0LCBtdXN0SGF2ZUV4cHJlc3Npb24sIHRydXN0ZWRDb250ZXh0KSB7CiAgICAgICAgdmFyIHN0YXJ0SW5kZXgsCiAgICAgICAgICBlbmRJbmRleCwKICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgIHBhcnRzID0gW10sCiAgICAgICAgICBsZW5ndGggPSB0ZXh0Lmxlbmd0aCwKICAgICAgICAgIGhhc0ludGVycG9sYXRpb24gPSBmYWxzZSwKICAgICAgICAgIGZuLAogICAgICAgICAgZXhwLAogICAgICAgICAgY29uY2F0ID0gW107CgogICAgICAgIHdoaWxlKGluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpZiAoICgoc3RhcnRJbmRleCA9IHRleHQuaW5kZXhPZihzdGFydFN5bWJvbCwgaW5kZXgpKSAhPSAtMSkgJiYKICAgICAgICAgICAgKChlbmRJbmRleCA9IHRleHQuaW5kZXhPZihlbmRTeW1ib2wsIHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCkpICE9IC0xKSApIHsKICAgICAgICAgICAgKGluZGV4ICE9IHN0YXJ0SW5kZXgpICYmIHBhcnRzLnB1c2godGV4dC5zdWJzdHJpbmcoaW5kZXgsIHN0YXJ0SW5kZXgpKTsKICAgICAgICAgICAgcGFydHMucHVzaChmbiA9ICRwYXJzZShleHAgPSB0ZXh0LnN1YnN0cmluZyhzdGFydEluZGV4ICsgc3RhcnRTeW1ib2xMZW5ndGgsIGVuZEluZGV4KSkpOwogICAgICAgICAgICBmbi5leHAgPSBleHA7CiAgICAgICAgICAgIGluZGV4ID0gZW5kSW5kZXggKyBlbmRTeW1ib2xMZW5ndGg7CiAgICAgICAgICAgIGhhc0ludGVycG9sYXRpb24gPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gd2UgZGlkIG5vdCBmaW5kIGFueXRoaW5nLCBzbyB3ZSBoYXZlIHRvIGFkZCB0aGUgcmVtYWluZGVyIHRvIHRoZSBwYXJ0cyBhcnJheQogICAgICAgICAgICAoaW5kZXggIT0gbGVuZ3RoKSAmJiBwYXJ0cy5wdXNoKHRleHQuc3Vic3RyaW5nKGluZGV4KSk7CiAgICAgICAgICAgIGluZGV4ID0gbGVuZ3RoOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCEobGVuZ3RoID0gcGFydHMubGVuZ3RoKSkgewogICAgICAgICAgLy8gd2UgYWRkZWQsIG5vdGhpbmcsIG11c3QgaGF2ZSBiZWVuIGFuIGVtcHR5IHN0cmluZy4KICAgICAgICAgIHBhcnRzLnB1c2goJycpOwogICAgICAgICAgbGVuZ3RoID0gMTsKICAgICAgICB9CgogICAgICAgIC8vIENvbmNhdGVuYXRpbmcgZXhwcmVzc2lvbnMgbWFrZXMgaXQgaGFyZCB0byByZWFzb24gYWJvdXQgd2hldGhlciBzb21lIGNvbWJpbmF0aW9uIG9mCiAgICAgICAgLy8gY29uY2F0ZW5hdGVkIHZhbHVlcyBhcmUgdW5zYWZlIHRvIHVzZSBhbmQgY291bGQgZWFzaWx5IGxlYWQgdG8gWFNTLiAgQnkgcmVxdWlyaW5nIHRoYXQgYQogICAgICAgIC8vIHNpbmdsZSBleHByZXNzaW9uIGJlIHVzZWQgZm9yIGlmcmFtZVtzcmNdLCBvYmplY3Rbc3JjXSwgZXRjLiwgd2UgZW5zdXJlIHRoYXQgdGhlIHZhbHVlCiAgICAgICAgLy8gdGhhdCdzIHVzZWQgaXMgYXNzaWduZWQgb3IgY29uc3RydWN0ZWQgYnkgc29tZSBKUyBjb2RlIHNvbWV3aGVyZSB0aGF0IGlzIG1vcmUgdGVzdGFibGUgb3IKICAgICAgICAvLyBtYWtlIGl0IG9idmlvdXMgdGhhdCB5b3UgYm91bmQgdGhlIHZhbHVlIHRvIHNvbWUgdXNlciBjb250cm9sbGVkIHZhbHVlLiAgVGhpcyBoZWxwcyByZWR1Y2UKICAgICAgICAvLyB0aGUgbG9hZCB3aGVuIGF1ZGl0aW5nIGZvciBYU1MgaXNzdWVzLgogICAgICAgIGlmICh0cnVzdGVkQ29udGV4dCAmJiBwYXJ0cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICB0aHJvdyAkaW50ZXJwb2xhdGVNaW5FcnIoJ25vY29uY2F0JywKICAgICAgICAgICAgICAiRXJyb3Igd2hpbGUgaW50ZXJwb2xhdGluZzogezB9XG5TdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyBkaXNhbGxvd3MgIiArCiAgICAgICAgICAgICAgImludGVycG9sYXRpb25zIHRoYXQgY29uY2F0ZW5hdGUgbXVsdGlwbGUgZXhwcmVzc2lvbnMgd2hlbiBhIHRydXN0ZWQgdmFsdWUgaXMgIiArCiAgICAgICAgICAgICAgInJlcXVpcmVkLiAgU2VlIGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nLiRzY2UiLCB0ZXh0KTsKICAgICAgICB9CgogICAgICAgIGlmICghbXVzdEhhdmVFeHByZXNzaW9uICB8fCBoYXNJbnRlcnBvbGF0aW9uKSB7CiAgICAgICAgICBjb25jYXQubGVuZ3RoID0gbGVuZ3RoOwogICAgICAgICAgZm4gPSBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgaWkgPSBsZW5ndGgsIHBhcnQ7IGk8aWk7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiAocGFydCA9IHBhcnRzW2ldKSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgIHBhcnQgPSBwYXJ0KGNvbnRleHQpOwogICAgICAgICAgICAgICAgICBpZiAodHJ1c3RlZENvbnRleHQpIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gJHNjZS5nZXRUcnVzdGVkKHRydXN0ZWRDb250ZXh0LCBwYXJ0KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gJHNjZS52YWx1ZU9mKHBhcnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChwYXJ0ID09IG51bGwpIHsgLy8gbnVsbCB8fCB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gJyc7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgcGFydCkgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBjYXNlICdudW1iZXInOgogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ID0gJycgKyBwYXJ0OwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSB0b0pzb24ocGFydCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25jYXRbaV0gPSBwYXJ0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY29uY2F0LmpvaW4oJycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoKGVycikgewogICAgICAgICAgICAgIHZhciBuZXdFcnIgPSAkaW50ZXJwb2xhdGVNaW5FcnIoJ2ludGVycicsICJDYW4ndCBpbnRlcnBvbGF0ZTogezB9XG57MX0iLCB0ZXh0LAogICAgICAgICAgICAgICAgZXJyLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKG5ld0Vycik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBmbi5leHAgPSB0ZXh0OwogICAgICAgICAgZm4ucGFydHMgPSBwYXJ0czsKICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICB9CiAgICAgIH0KCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkaW50ZXJwb2xhdGUjc3RhcnRTeW1ib2wKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIHN0YXJ0IG9mIGV4cHJlc3Npb24gaW4gdGhlIGludGVycG9sYXRlZCBzdHJpbmcuIERlZmF1bHRzIHRvIGB7e2AuCiAgICAgKgogICAgICogVXNlIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNzdGFydFN5bWJvbCAkaW50ZXJwb2xhdGVQcm92aWRlciNzdGFydFN5bWJvbH0gdG8gY2hhbmdlCiAgICAgICAqIHRoZSBzeW1ib2wuCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IHN0YXJ0IHN5bWJvbC4KICAgICAgICovCiAgICAgICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzdGFydFN5bWJvbDsKICAgICAgfTsKCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkaW50ZXJwb2xhdGUjZW5kU3ltYm9sCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHRoZSBlbmQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYH19YC4KICAgICAgICoKICAgICAgICogVXNlIHtAbGluayBuZy4kaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2wgJGludGVycG9sYXRlUHJvdmlkZXIjZW5kU3ltYm9sfSB0byBjaGFuZ2UKICAgICAgICogdGhlIHN5bWJvbC4KICAgICAgICoKICAgICAgICogQHJldHVybnMge3N0cmluZ30gZW5kIHN5bWJvbC4KICAgICAgICovCiAgICAgICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2wgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZW5kU3ltYm9sOwogICAgICB9OwoKICAgICAgcmV0dXJuICRpbnRlcnBvbGF0ZTsKICAgIH1dOwogIH0KCiAgZnVuY3Rpb24gJEludGVydmFsUHJvdmlkZXIoKSB7CiAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJHdpbmRvdycsICckcScsCiAgICAgIGZ1bmN0aW9uKCRyb290U2NvcGUsICAgJHdpbmRvdywgICAkcSkgewogICAgICAgIHZhciBpbnRlcnZhbHMgPSB7fTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgICAgICogQG5hbWUgJGludGVydmFsCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBBbmd1bGFyJ3Mgd3JhcHBlciBmb3IgYHdpbmRvdy5zZXRJbnRlcnZhbGAuIFRoZSBgZm5gIGZ1bmN0aW9uIGlzIGV4ZWN1dGVkIGV2ZXJ5IGBkZWxheWAKICAgICAgICAgKiBtaWxsaXNlY29uZHMuCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIG9mIHJlZ2lzdGVyaW5nIGFuIGludGVydmFsIGZ1bmN0aW9uIGlzIGEgcHJvbWlzZS4gVGhpcyBwcm9taXNlIHdpbGwgYmUKICAgICAgICAgKiBub3RpZmllZCB1cG9uIGVhY2ggdGljayBvZiB0aGUgaW50ZXJ2YWwsIGFuZCB3aWxsIGJlIHJlc29sdmVkIGFmdGVyIGBjb3VudGAgaXRlcmF0aW9ucywgb3IKICAgICAgICAgKiBydW4gaW5kZWZpbml0ZWx5IGlmIGBjb3VudGAgaXMgbm90IGRlZmluZWQuIFRoZSB2YWx1ZSBvZiB0aGUgbm90aWZpY2F0aW9uIHdpbGwgYmUgdGhlCiAgICAgICAgICogbnVtYmVyIG9mIGl0ZXJhdGlvbnMgdGhhdCBoYXZlIHJ1bi4KICAgICAgICAgKiBUbyBjYW5jZWwgYW4gaW50ZXJ2YWwsIGNhbGwgYCRpbnRlcnZhbC5jYW5jZWwocHJvbWlzZSlgLgogICAgICAgICAqCiAgICAgICAgICogSW4gdGVzdHMgeW91IGNhbiB1c2Uge0BsaW5rIG5nTW9jay4kaW50ZXJ2YWwjZmx1c2ggYCRpbnRlcnZhbC5mbHVzaChtaWxsaXMpYH0gdG8KICAgICAgICAgKiBtb3ZlIGZvcndhcmQgYnkgYG1pbGxpc2AgbWlsbGlzZWNvbmRzIGFuZCB0cmlnZ2VyIGFueSBmdW5jdGlvbnMgc2NoZWR1bGVkIHRvIHJ1biBpbiB0aGF0CiAgICAgICAgICogdGltZS4KICAgICAgICAgKgogICAgICAgICAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogICAgICAgICAqICoqTm90ZSoqOiBJbnRlcnZhbHMgY3JlYXRlZCBieSB0aGlzIHNlcnZpY2UgbXVzdCBiZSBleHBsaWNpdGx5IGRlc3Ryb3llZCB3aGVuIHlvdSBhcmUgZmluaXNoZWQKICAgICAgICAgKiB3aXRoIHRoZW0uICBJbiBwYXJ0aWN1bGFyIHRoZXkgYXJlIG5vdCBhdXRvbWF0aWNhbGx5IGRlc3Ryb3llZCB3aGVuIGEgY29udHJvbGxlcidzIHNjb3BlIG9yIGEKICAgICAgICAgKiBkaXJlY3RpdmUncyBlbGVtZW50IGFyZSBkZXN0cm95ZWQuCiAgICAgICAgICogWW91IHNob3VsZCB0YWtlIHRoaXMgaW50byBjb25zaWRlcmF0aW9uIGFuZCBtYWtlIHN1cmUgdG8gYWx3YXlzIGNhbmNlbCB0aGUgaW50ZXJ2YWwgYXQgdGhlCiAgICAgICAgICogYXBwcm9wcmlhdGUgbW9tZW50LiAgU2VlIHRoZSBleGFtcGxlIGJlbG93IGZvciBtb3JlIGRldGFpbHMgb24gaG93IGFuZCB3aGVuIHRvIGRvIHRoaXMuCiAgICAgICAgICogPC9kaXY+CiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24gdGhhdCBzaG91bGQgYmUgY2FsbGVkIHJlcGVhdGVkbHkuCiAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IE51bWJlciBvZiBtaWxsaXNlY29uZHMgYmV0d2VlbiBlYWNoIGZ1bmN0aW9uIGNhbGwuCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBbY291bnQ9MF0gTnVtYmVyIG9mIHRpbWVzIHRvIHJlcGVhdC4gSWYgbm90IHNldCwgb3IgMCwgd2lsbCByZXBlYXQKICAgICAgICAgKiAgIGluZGVmaW5pdGVseS4KICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBbaW52b2tlQXBwbHk9dHJ1ZV0gSWYgc2V0IHRvIGBmYWxzZWAgc2tpcHMgbW9kZWwgZGlydHkgY2hlY2tpbmcsIG90aGVyd2lzZQogICAgICAgICAqICAgd2lsbCBpbnZva2UgYGZuYCB3aXRoaW4gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRhcHBseSAkYXBwbHl9IGJsb2NrLgogICAgICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggd2lsbCBiZSBub3RpZmllZCBvbiBlYWNoIGl0ZXJhdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgICogPGV4YW1wbGUgbW9kdWxlPSJ0aW1lIj4KICAgICAgICAgKiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICAqICAgICA8c2NyaXB0PgogICAgICAgICAqICAgICAgIGZ1bmN0aW9uIEN0cmwyKCRzY29wZSwkaW50ZXJ2YWwpIHsKICAgICAgKiAgICAgICAgICRzY29wZS5mb3JtYXQgPSAnTS9kL3l5IGg6bW06c3MgYSc7CiAgICAgICogICAgICAgICAkc2NvcGUuYmxvb2RfMSA9IDEwMDsKICAgICAgKiAgICAgICAgICRzY29wZS5ibG9vZF8yID0gMTIwOwogICAgICAqCiAgICAgICogICAgICAgICB2YXIgc3RvcDsKICAgICAgKiAgICAgICAgICRzY29wZS5maWdodCA9IGZ1bmN0aW9uKCkgewogICAgICAqICAgICAgICAgICAvLyBEb24ndCBzdGFydCBhIG5ldyBmaWdodCBpZiB3ZSBhcmUgYWxyZWFkeSBmaWdodGluZwogICAgICAqICAgICAgICAgICBpZiAoIGFuZ3VsYXIuaXNEZWZpbmVkKHN0b3ApICkgcmV0dXJuOwogICAgICAqCiAgICAgICogICAgICAgICAgIHN0b3AgPSAkaW50ZXJ2YWwoZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgICAgaWYgKCRzY29wZS5ibG9vZF8xID4gMCAmJiAkc2NvcGUuYmxvb2RfMiA+IDApIHsKICAgICAgKiAgICAgICAgICAgICAgICAgJHNjb3BlLmJsb29kXzEgPSAkc2NvcGUuYmxvb2RfMSAtIDM7CiAgICAgICogICAgICAgICAgICAgICAgICRzY29wZS5ibG9vZF8yID0gJHNjb3BlLmJsb29kXzIgLSA0OwogICAgICAqICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICogICAgICAgICAgICAgICAgICRzY29wZS5zdG9wRmlnaHQoKTsKICAgICAgKiAgICAgICAgICAgICB9CiAgICAgICogICAgICAgICAgIH0sIDEwMCk7CiAgICAgICogICAgICAgICB9OwogICAgICAqCiAgICAgICogICAgICAgICAkc2NvcGUuc3RvcEZpZ2h0ID0gZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgIGlmIChhbmd1bGFyLmlzRGVmaW5lZChzdG9wKSkgewogICAgICAqICAgICAgICAgICAgICRpbnRlcnZhbC5jYW5jZWwoc3RvcCk7CiAgICAgICogICAgICAgICAgICAgc3RvcCA9IHVuZGVmaW5lZDsKICAgICAgKiAgICAgICAgICAgfQogICAgICAqICAgICAgICAgfTsKICAgICAgKgogICAgICAqICAgICAgICAgJHNjb3BlLnJlc2V0RmlnaHQgPSBmdW5jdGlvbigpIHsKICAgICAgKiAgICAgICAgICAgJHNjb3BlLmJsb29kXzEgPSAxMDA7CiAgICAgICogICAgICAgICAgICRzY29wZS5ibG9vZF8yID0gMTIwOwogICAgICAqICAgICAgICAgfQogICAgICAqCiAgICAgICogICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAqICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgaW50ZXJ2YWwgaXMgZGVzdHJveWVkIHRvbwogICAgICAqICAgICAgICAgICAkc2NvcGUuc3RvcEZpZ2h0KCk7CiAgICAgICogICAgICAgICB9KTsKICAgICAgKiAgICAgICB9CiAgICAgICAgICoKICAgICAgICAgKiAgICAgICBhbmd1bGFyLm1vZHVsZSgndGltZScsIFtdKQogICAgICAgICAqICAgICAgICAgLy8gUmVnaXN0ZXIgdGhlICdteUN1cnJlbnRUaW1lJyBkaXJlY3RpdmUgZmFjdG9yeSBtZXRob2QuCiAgICAgICAgICogICAgICAgICAvLyBXZSBpbmplY3QgJGludGVydmFsIGFuZCBkYXRlRmlsdGVyIHNlcnZpY2Ugc2luY2UgdGhlIGZhY3RvcnkgbWV0aG9kIGlzIERJLgogICAgICAgICAqICAgICAgICAgLmRpcmVjdGl2ZSgnbXlDdXJyZW50VGltZScsIGZ1bmN0aW9uKCRpbnRlcnZhbCwgZGF0ZUZpbHRlcikgewogICAgICAqICAgICAgICAgICAvLyByZXR1cm4gdGhlIGRpcmVjdGl2ZSBsaW5rIGZ1bmN0aW9uLiAoY29tcGlsZSBmdW5jdGlvbiBub3QgbmVlZGVkKQogICAgICAqICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICogICAgICAgICAgICAgdmFyIGZvcm1hdCwgIC8vIGRhdGUgZm9ybWF0CiAgICAgICogICAgICAgICAgICAgc3RvcFRpbWU7IC8vIHNvIHRoYXQgd2UgY2FuIGNhbmNlbCB0aGUgdGltZSB1cGRhdGVzCiAgICAgICoKICAgICAgKiAgICAgICAgICAgICAvLyB1c2VkIHRvIHVwZGF0ZSB0aGUgVUkKICAgICAgKiAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVUaW1lKCkgewogICAgICAqICAgICAgICAgICAgICAgZWxlbWVudC50ZXh0KGRhdGVGaWx0ZXIobmV3IERhdGUoKSwgZm9ybWF0KSk7CiAgICAgICogICAgICAgICAgICAgfQogICAgICAqCiAgICAgICogICAgICAgICAgICAgLy8gd2F0Y2ggdGhlIGV4cHJlc3Npb24sIGFuZCB1cGRhdGUgdGhlIFVJIG9uIGNoYW5nZS4KICAgICAgKiAgICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0cnMubXlDdXJyZW50VGltZSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgKiAgICAgICAgICAgICAgIGZvcm1hdCA9IHZhbHVlOwogICAgICAqICAgICAgICAgICAgICAgdXBkYXRlVGltZSgpOwogICAgICAqICAgICAgICAgICAgIH0pOwogICAgICAqCiAgICAgICogICAgICAgICAgICAgc3RvcFRpbWUgPSAkaW50ZXJ2YWwodXBkYXRlVGltZSwgMTAwMCk7CiAgICAgICoKICAgICAgKiAgICAgICAgICAgICAvLyBsaXN0ZW4gb24gRE9NIGRlc3Ryb3kgKHJlbW92YWwpIGV2ZW50LCBhbmQgY2FuY2VsIHRoZSBuZXh0IFVJIHVwZGF0ZQogICAgICAqICAgICAgICAgICAgIC8vIHRvIHByZXZlbnQgdXBkYXRpbmcgdGltZSBvZnRlciB0aGUgRE9NIGVsZW1lbnQgd2FzIHJlbW92ZWQuCiAgICAgICogICAgICAgICAgICAgZWxlbWVudC5iaW5kKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAqICAgICAgICAgICAgICAgJGludGVydmFsLmNhbmNlbChzdG9wVGltZSk7CiAgICAgICogICAgICAgICAgICAgfSk7CiAgICAgICogICAgICAgICAgIH0KICAgICAgKiAgICAgICAgIH0pOwogICAgICAgICAqICAgICA8L3NjcmlwdD4KICAgICAgICAgKgogICAgICAgICAqICAgICA8ZGl2PgogICAgICAgICAqICAgICAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybDIiPgogICAgICAgICAqICAgICAgICAgRGF0ZSBmb3JtYXQ6IDxpbnB1dCBuZy1tb2RlbD0iZm9ybWF0Ij4gPGhyLz4KICAgICAgICAgKiAgICAgICAgIEN1cnJlbnQgdGltZSBpczogPHNwYW4gbXktY3VycmVudC10aW1lPSJmb3JtYXQiPjwvc3Bhbj4KICAgICAgICAgKiAgICAgICAgIDxoci8+CiAgICAgICAgICogICAgICAgICBCbG9vZCAxIDogPGZvbnQgY29sb3I9J3JlZCc+e3tibG9vZF8xfX08L2ZvbnQ+CiAgICAgICAgICogICAgICAgICBCbG9vZCAyIDogPGZvbnQgY29sb3I9J3JlZCc+e3tibG9vZF8yfX08L2ZvbnQ+CiAgICAgICAgICogICAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgZGF0YS1uZy1jbGljaz0iZmlnaHQoKSI+RmlnaHQ8L2J1dHRvbj4KICAgICAgICAgKiAgICAgICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBkYXRhLW5nLWNsaWNrPSJzdG9wRmlnaHQoKSI+U3RvcEZpZ2h0PC9idXR0b24+CiAgICAgICAgICogICAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgZGF0YS1uZy1jbGljaz0icmVzZXRGaWdodCgpIj5yZXNldEZpZ2h0PC9idXR0b24+CiAgICAgICAgICogICAgICAgPC9kaXY+CiAgICAgICAgICogICAgIDwvZGl2PgogICAgICAgICAqCiAgICAgICAgICogICA8L2ZpbGU+CiAgICAgICAgICogPC9leGFtcGxlPgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGludGVydmFsKGZuLCBkZWxheSwgY291bnQsIGludm9rZUFwcGx5KSB7CiAgICAgICAgICB2YXIgc2V0SW50ZXJ2YWwgPSAkd2luZG93LnNldEludGVydmFsLAogICAgICAgICAgICBjbGVhckludGVydmFsID0gJHdpbmRvdy5jbGVhckludGVydmFsLAogICAgICAgICAgICBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgICBpdGVyYXRpb24gPSAwLAogICAgICAgICAgICBza2lwQXBwbHkgPSAoaXNEZWZpbmVkKGludm9rZUFwcGx5KSAmJiAhaW52b2tlQXBwbHkpOwoKICAgICAgICAgIGNvdW50ID0gaXNEZWZpbmVkKGNvdW50KSA/IGNvdW50IDogMDsKCiAgICAgICAgICBwcm9taXNlLnRoZW4obnVsbCwgbnVsbCwgZm4pOwoKICAgICAgICAgIHByb21pc2UuJCRpbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gdGljaygpIHsKICAgICAgICAgICAgZGVmZXJyZWQubm90aWZ5KGl0ZXJhdGlvbisrKTsKCiAgICAgICAgICAgIGlmIChjb3VudCA+IDAgJiYgaXRlcmF0aW9uID49IGNvdW50KSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShpdGVyYXRpb24pOwogICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwocHJvbWlzZS4kJGludGVydmFsSWQpOwogICAgICAgICAgICAgIGRlbGV0ZSBpbnRlcnZhbHNbcHJvbWlzZS4kJGludGVydmFsSWRdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXNraXBBcHBseSkgJHJvb3RTY29wZS4kYXBwbHkoKTsKCiAgICAgICAgICB9LCBkZWxheSk7CgogICAgICAgICAgaW50ZXJ2YWxzW3Byb21pc2UuJCRpbnRlcnZhbElkXSA9IGRlZmVycmVkOwoKICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH0KCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkaW50ZXJ2YWwjY2FuY2VsCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBDYW5jZWxzIGEgdGFzayBhc3NvY2lhdGVkIHdpdGggdGhlIGBwcm9taXNlYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7cHJvbWlzZX0gcHJvbWlzZSByZXR1cm5lZCBieSB0aGUgYCRpbnRlcnZhbGAgZnVuY3Rpb24uCiAgICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB0YXNrIHdhcyBzdWNjZXNzZnVsbHkgY2FuY2VsZWQuCiAgICAgICAgICovCiAgICAgICAgaW50ZXJ2YWwuY2FuY2VsID0gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICAgICAgaWYgKHByb21pc2UgJiYgcHJvbWlzZS4kJGludGVydmFsSWQgaW4gaW50ZXJ2YWxzKSB7CiAgICAgICAgICAgIGludGVydmFsc1twcm9taXNlLiQkaW50ZXJ2YWxJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgICAgICBjbGVhckludGVydmFsKHByb21pc2UuJCRpbnRlcnZhbElkKTsKICAgICAgICAgICAgZGVsZXRlIGludGVydmFsc1twcm9taXNlLiQkaW50ZXJ2YWxJZF07CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBpbnRlcnZhbDsKICAgICAgfV07CiAgfQoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRsb2NhbGUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqICRsb2NhbGUgc2VydmljZSBwcm92aWRlcyBsb2NhbGl6YXRpb24gcnVsZXMgZm9yIHZhcmlvdXMgQW5ndWxhciBjb21wb25lbnRzLiBBcyBvZiByaWdodCBub3cgdGhlCiAgICogb25seSBwdWJsaWMgYXBpIGlzOgogICAqCiAgICogKiBgaWRgIOKAkyBge3N0cmluZ31gIOKAkyBsb2NhbGUgaWQgZm9ybWF0dGVkIGFzIGBsYW5ndWFnZUlkLWNvdW50cnlJZGAgKGUuZy4gYGVuLXVzYCkKICAgKi8KICBmdW5jdGlvbiAkTG9jYWxlUHJvdmlkZXIoKXsKICAgIHRoaXMuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIGlkOiAnZW4tdXMnLAoKICAgICAgICBOVU1CRVJfRk9STUFUUzogewogICAgICAgICAgREVDSU1BTF9TRVA6ICcuJywKICAgICAgICAgIEdST1VQX1NFUDogJywnLAogICAgICAgICAgUEFUVEVSTlM6IFsKICAgICAgICAgICAgeyAvLyBEZWNpbWFsIFBhdHRlcm4KICAgICAgICAgICAgICBtaW5JbnQ6IDEsCiAgICAgICAgICAgICAgbWluRnJhYzogMCwKICAgICAgICAgICAgICBtYXhGcmFjOiAzLAogICAgICAgICAgICAgIHBvc1ByZTogJycsCiAgICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgICBuZWdQcmU6ICctJywKICAgICAgICAgICAgICBuZWdTdWY6ICcnLAogICAgICAgICAgICAgIGdTaXplOiAzLAogICAgICAgICAgICAgIGxnU2l6ZTogMwogICAgICAgICAgICB9LHsgLy9DdXJyZW5jeSBQYXR0ZXJuCiAgICAgICAgICAgICAgbWluSW50OiAxLAogICAgICAgICAgICAgIG1pbkZyYWM6IDIsCiAgICAgICAgICAgICAgbWF4RnJhYzogMiwKICAgICAgICAgICAgICBwb3NQcmU6ICdcdTAwQTQnLAogICAgICAgICAgICAgIHBvc1N1ZjogJycsCiAgICAgICAgICAgICAgbmVnUHJlOiAnKFx1MDBBNCcsCiAgICAgICAgICAgICAgbmVnU3VmOiAnKScsCiAgICAgICAgICAgICAgZ1NpemU6IDMsCiAgICAgICAgICAgICAgbGdTaXplOiAzCiAgICAgICAgICAgIH0KICAgICAgICAgIF0sCiAgICAgICAgICBDVVJSRU5DWV9TWU06ICckJwogICAgICAgIH0sCgogICAgICAgIERBVEVUSU1FX0ZPUk1BVFM6IHsKICAgICAgICAgIE1PTlRIOgogICAgICAgICAgICAnSmFudWFyeSxGZWJydWFyeSxNYXJjaCxBcHJpbCxNYXksSnVuZSxKdWx5LEF1Z3VzdCxTZXB0ZW1iZXIsT2N0b2JlcixOb3ZlbWJlcixEZWNlbWJlcicKICAgICAgICAgICAgICAuc3BsaXQoJywnKSwKICAgICAgICAgIFNIT1JUTU9OVEg6ICAnSmFuLEZlYixNYXIsQXByLE1heSxKdW4sSnVsLEF1ZyxTZXAsT2N0LE5vdixEZWMnLnNwbGl0KCcsJyksCiAgICAgICAgICBEQVk6ICdTdW5kYXksTW9uZGF5LFR1ZXNkYXksV2VkbmVzZGF5LFRodXJzZGF5LEZyaWRheSxTYXR1cmRheScuc3BsaXQoJywnKSwKICAgICAgICAgIFNIT1JUREFZOiAnU3VuLE1vbixUdWUsV2VkLFRodSxGcmksU2F0Jy5zcGxpdCgnLCcpLAogICAgICAgICAgQU1QTVM6IFsnQU0nLCdQTSddLAogICAgICAgICAgbWVkaXVtOiAnTU1NIGQsIHkgaDptbTpzcyBhJywKICAgICAgICAgIHNob3J0OiAnTS9kL3l5IGg6bW0gYScsCiAgICAgICAgICBmdWxsRGF0ZTogJ0VFRUUsIE1NTU0gZCwgeScsCiAgICAgICAgICBsb25nRGF0ZTogJ01NTU0gZCwgeScsCiAgICAgICAgICBtZWRpdW1EYXRlOiAnTU1NIGQsIHknLAogICAgICAgICAgc2hvcnREYXRlOiAnTS9kL3l5JywKICAgICAgICAgIG1lZGl1bVRpbWU6ICdoOm1tOnNzIGEnLAogICAgICAgICAgc2hvcnRUaW1lOiAnaDptbSBhJwogICAgICAgIH0sCgogICAgICAgIHBsdXJhbENhdDogZnVuY3Rpb24obnVtKSB7CiAgICAgICAgICBpZiAobnVtID09PSAxKSB7CiAgICAgICAgICAgIHJldHVybiAnb25lJzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAnb3RoZXInOwogICAgICAgIH0KICAgICAgfTsKICAgIH07CiAgfQoKICB2YXIgUEFUSF9NQVRDSCA9IC9eKFteXD8jXSopKFw/KFteI10qKSk/KCMoLiopKT8kLywKICAgIERFRkFVTFRfUE9SVFMgPSB7J2h0dHAnOiA4MCwgJ2h0dHBzJzogNDQzLCAnZnRwJzogMjF9OwogIHZhciAkbG9jYXRpb25NaW5FcnIgPSBtaW5FcnIoJyRsb2NhdGlvbicpOwoKCiAgLyoqCiAgICogRW5jb2RlIHBhdGggdXNpbmcgZW5jb2RlVXJpU2VnbWVudCwgaWdub3JpbmcgZm9yd2FyZCBzbGFzaGVzCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCBQYXRoIHRvIGVuY29kZQogICAqIEByZXR1cm5zIHtzdHJpbmd9CiAgICovCiAgZnVuY3Rpb24gZW5jb2RlUGF0aChwYXRoKSB7CiAgICB2YXIgc2VnbWVudHMgPSBwYXRoLnNwbGl0KCcvJyksCiAgICAgIGkgPSBzZWdtZW50cy5sZW5ndGg7CgogICAgd2hpbGUgKGktLSkgewogICAgICBzZWdtZW50c1tpXSA9IGVuY29kZVVyaVNlZ21lbnQoc2VnbWVudHNbaV0pOwogICAgfQoKICAgIHJldHVybiBzZWdtZW50cy5qb2luKCcvJyk7CiAgfQoKICBmdW5jdGlvbiBwYXJzZUFic29sdXRlVXJsKGFic29sdXRlVXJsLCBsb2NhdGlvbk9iaiwgYXBwQmFzZSkgewogICAgdmFyIHBhcnNlZFVybCA9IHVybFJlc29sdmUoYWJzb2x1dGVVcmwsIGFwcEJhc2UpOwoKICAgIGxvY2F0aW9uT2JqLiQkcHJvdG9jb2wgPSBwYXJzZWRVcmwucHJvdG9jb2w7CiAgICBsb2NhdGlvbk9iai4kJGhvc3QgPSBwYXJzZWRVcmwuaG9zdG5hbWU7CiAgICBsb2NhdGlvbk9iai4kJHBvcnQgPSBpbnQocGFyc2VkVXJsLnBvcnQpIHx8IERFRkFVTFRfUE9SVFNbcGFyc2VkVXJsLnByb3RvY29sXSB8fCBudWxsOwogIH0KCgogIGZ1bmN0aW9uIHBhcnNlQXBwVXJsKHJlbGF0aXZlVXJsLCBsb2NhdGlvbk9iaiwgYXBwQmFzZSkgewogICAgdmFyIHByZWZpeGVkID0gKHJlbGF0aXZlVXJsLmNoYXJBdCgwKSAhPT0gJy8nKTsKICAgIGlmIChwcmVmaXhlZCkgewogICAgICByZWxhdGl2ZVVybCA9ICcvJyArIHJlbGF0aXZlVXJsOwogICAgfQogICAgdmFyIG1hdGNoID0gdXJsUmVzb2x2ZShyZWxhdGl2ZVVybCwgYXBwQmFzZSk7CiAgICBsb2NhdGlvbk9iai4kJHBhdGggPSBkZWNvZGVVUklDb21wb25lbnQocHJlZml4ZWQgJiYgbWF0Y2gucGF0aG5hbWUuY2hhckF0KDApID09PSAnLycgPwogICAgICBtYXRjaC5wYXRobmFtZS5zdWJzdHJpbmcoMSkgOiBtYXRjaC5wYXRobmFtZSk7CiAgICBsb2NhdGlvbk9iai4kJHNlYXJjaCA9IHBhcnNlS2V5VmFsdWUobWF0Y2guc2VhcmNoKTsKICAgIGxvY2F0aW9uT2JqLiQkaGFzaCA9IGRlY29kZVVSSUNvbXBvbmVudChtYXRjaC5oYXNoKTsKCiAgICAvLyBtYWtlIHN1cmUgcGF0aCBzdGFydHMgd2l0aCAnLyc7CiAgICBpZiAobG9jYXRpb25PYmouJCRwYXRoICYmIGxvY2F0aW9uT2JqLiQkcGF0aC5jaGFyQXQoMCkgIT0gJy8nKSB7CiAgICAgIGxvY2F0aW9uT2JqLiQkcGF0aCA9ICcvJyArIGxvY2F0aW9uT2JqLiQkcGF0aDsKICAgIH0KICB9CgoKICAvKioKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBiZWdpbgogICAqIEBwYXJhbSB7c3RyaW5nfSB3aG9sZQogICAqIEByZXR1cm5zIHtzdHJpbmd9IHJldHVybnMgdGV4dCBmcm9tIHdob2xlIGFmdGVyIGJlZ2luIG9yIHVuZGVmaW5lZCBpZiBpdCBkb2VzIG5vdCBiZWdpbiB3aXRoCiAgICogICAgICAgICAgICAgICAgICAgZXhwZWN0ZWQgc3RyaW5nLgogICAqLwogIGZ1bmN0aW9uIGJlZ2luc1dpdGgoYmVnaW4sIHdob2xlKSB7CiAgICBpZiAod2hvbGUuaW5kZXhPZihiZWdpbikgPT09IDApIHsKICAgICAgcmV0dXJuIHdob2xlLnN1YnN0cihiZWdpbi5sZW5ndGgpOwogICAgfQogIH0KCgogIGZ1bmN0aW9uIHN0cmlwSGFzaCh1cmwpIHsKICAgIHZhciBpbmRleCA9IHVybC5pbmRleE9mKCcjJyk7CiAgICByZXR1cm4gaW5kZXggPT0gLTEgPyB1cmwgOiB1cmwuc3Vic3RyKDAsIGluZGV4KTsKICB9CgoKICBmdW5jdGlvbiBzdHJpcEZpbGUodXJsKSB7CiAgICByZXR1cm4gdXJsLnN1YnN0cigwLCBzdHJpcEhhc2godXJsKS5sYXN0SW5kZXhPZignLycpICsgMSk7CiAgfQoKICAvKiByZXR1cm4gdGhlIHNlcnZlciBvbmx5IChzY2hlbWU6Ly9ob3N0OnBvcnQpICovCiAgZnVuY3Rpb24gc2VydmVyQmFzZSh1cmwpIHsKICAgIHJldHVybiB1cmwuc3Vic3RyaW5nKDAsIHVybC5pbmRleE9mKCcvJywgdXJsLmluZGV4T2YoJy8vJykgKyAyKSk7CiAgfQoKCiAgLyoqCiAgICogTG9jYXRpb25IdG1sNVVybCByZXByZXNlbnRzIGFuIHVybAogICAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBIVE1MNSBtb2RlIGlzIGVuYWJsZWQgYW5kIHN1cHBvcnRlZAogICAqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEJhc2UgYXBwbGljYXRpb24gYmFzZSBVUkwKICAgKiBAcGFyYW0ge3N0cmluZ30gYmFzZVByZWZpeCB1cmwgcGF0aCBwcmVmaXgKICAgKi8KICBmdW5jdGlvbiBMb2NhdGlvbkh0bWw1VXJsKGFwcEJhc2UsIGJhc2VQcmVmaXgpIHsKICAgIHRoaXMuJCRodG1sNSA9IHRydWU7CiAgICBiYXNlUHJlZml4ID0gYmFzZVByZWZpeCB8fCAnJzsKICAgIHZhciBhcHBCYXNlTm9GaWxlID0gc3RyaXBGaWxlKGFwcEJhc2UpOwogICAgcGFyc2VBYnNvbHV0ZVVybChhcHBCYXNlLCB0aGlzLCBhcHBCYXNlKTsKCgogICAgLyoqCiAgICAgKiBQYXJzZSBnaXZlbiBodG1sNSAocmVndWxhcikgdXJsIHN0cmluZyBpbnRvIHByb3BlcnRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZXdBYnNvbHV0ZVVybCBIVE1MNSB1cmwKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHRoaXMuJCRwYXJzZSA9IGZ1bmN0aW9uKHVybCkgewogICAgICB2YXIgcGF0aFVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKTsKICAgICAgaWYgKCFpc1N0cmluZyhwYXRoVXJsKSkgewogICAgICAgIHRocm93ICRsb2NhdGlvbk1pbkVycignaXB0aHByZngnLCAnSW52YWxpZCB1cmwgInswfSIsIG1pc3NpbmcgcGF0aCBwcmVmaXggInsxfSIuJywgdXJsLAogICAgICAgICAgYXBwQmFzZU5vRmlsZSk7CiAgICAgIH0KCiAgICAgIHBhcnNlQXBwVXJsKHBhdGhVcmwsIHRoaXMsIGFwcEJhc2UpOwoKICAgICAgaWYgKCF0aGlzLiQkcGF0aCkgewogICAgICAgIHRoaXMuJCRwYXRoID0gJy8nOwogICAgICB9CgogICAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgfTsKCiAgICAvKioKICAgICAqIENvbXBvc2UgdXJsIGFuZCB1cGRhdGUgYGFic1VybGAgcHJvcGVydHkKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgIGhhc2ggPSB0aGlzLiQkaGFzaCA/ICcjJyArIGVuY29kZVVyaVNlZ21lbnQodGhpcy4kJGhhc2gpIDogJyc7CgogICAgICB0aGlzLiQkdXJsID0gZW5jb2RlUGF0aCh0aGlzLiQkcGF0aCkgKyAoc2VhcmNoID8gJz8nICsgc2VhcmNoIDogJycpICsgaGFzaDsKICAgICAgdGhpcy4kJGFic1VybCA9IGFwcEJhc2VOb0ZpbGUgKyB0aGlzLiQkdXJsLnN1YnN0cigxKTsgLy8gZmlyc3QgY2hhciBpcyBhbHdheXMgJy8nCiAgICB9OwoKICAgIHRoaXMuJCRyZXdyaXRlID0gZnVuY3Rpb24odXJsKSB7CiAgICAgIHZhciBhcHBVcmwsIHByZXZBcHBVcmw7CgogICAgICBpZiAoIChhcHBVcmwgPSBiZWdpbnNXaXRoKGFwcEJhc2UsIHVybCkpICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgcHJldkFwcFVybCA9IGFwcFVybDsKICAgICAgICBpZiAoIChhcHBVcmwgPSBiZWdpbnNXaXRoKGJhc2VQcmVmaXgsIGFwcFVybCkpICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICByZXR1cm4gYXBwQmFzZU5vRmlsZSArIChiZWdpbnNXaXRoKCcvJywgYXBwVXJsKSB8fCBhcHBVcmwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gYXBwQmFzZSArIHByZXZBcHBVcmw7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKCAoYXBwVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlTm9GaWxlLCB1cmwpKSAhPT0gdW5kZWZpbmVkICkgewogICAgICAgIHJldHVybiBhcHBCYXNlTm9GaWxlICsgYXBwVXJsOwogICAgICB9IGVsc2UgaWYgKGFwcEJhc2VOb0ZpbGUgPT0gdXJsICsgJy8nKSB7CiAgICAgICAgcmV0dXJuIGFwcEJhc2VOb0ZpbGU7CiAgICAgIH0KICAgIH07CiAgfQoKCiAgLyoqCiAgICogTG9jYXRpb25IYXNoYmFuZ1VybCByZXByZXNlbnRzIHVybAogICAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBkZXZlbG9wZXIgZG9lc24ndCBvcHQgaW50byBodG1sNSBtb2RlLgogICAqIEl0IGFsc28gc2VydmVzIGFzIHRoZSBiYXNlIGNsYXNzIGZvciBodG1sNSBtb2RlIGZhbGxiYWNrIG9uIGxlZ2FjeSBicm93c2Vycy4KICAgKgogICAqIEBjb25zdHJ1Y3RvcgogICAqIEBwYXJhbSB7c3RyaW5nfSBhcHBCYXNlIGFwcGxpY2F0aW9uIGJhc2UgVVJMCiAgICogQHBhcmFtIHtzdHJpbmd9IGhhc2hQcmVmaXggaGFzaGJhbmcgcHJlZml4CiAgICovCiAgZnVuY3Rpb24gTG9jYXRpb25IYXNoYmFuZ1VybChhcHBCYXNlLCBoYXNoUHJlZml4KSB7CiAgICB2YXIgYXBwQmFzZU5vRmlsZSA9IHN0cmlwRmlsZShhcHBCYXNlKTsKCiAgICBwYXJzZUFic29sdXRlVXJsKGFwcEJhc2UsIHRoaXMsIGFwcEJhc2UpOwoKCiAgICAvKioKICAgICAqIFBhcnNlIGdpdmVuIGhhc2hiYW5nIHVybCBpbnRvIHByb3BlcnRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgSGFzaGJhbmcgdXJsCiAgICAgKiBAcHJpdmF0ZQogICAgICovCiAgICB0aGlzLiQkcGFyc2UgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgdmFyIHdpdGhvdXRCYXNlVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlLCB1cmwpIHx8IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKTsKICAgICAgdmFyIHdpdGhvdXRIYXNoVXJsID0gd2l0aG91dEJhc2VVcmwuY2hhckF0KDApID09ICcjJwogICAgICAgID8gYmVnaW5zV2l0aChoYXNoUHJlZml4LCB3aXRob3V0QmFzZVVybCkKICAgICAgICA6ICh0aGlzLiQkaHRtbDUpCiAgICAgICAgPyB3aXRob3V0QmFzZVVybAogICAgICAgIDogJyc7CgogICAgICBpZiAoIWlzU3RyaW5nKHdpdGhvdXRIYXNoVXJsKSkgewogICAgICAgIHRocm93ICRsb2NhdGlvbk1pbkVycignaWhzaHByZngnLCAnSW52YWxpZCB1cmwgInswfSIsIG1pc3NpbmcgaGFzaCBwcmVmaXggInsxfSIuJywgdXJsLAogICAgICAgICAgaGFzaFByZWZpeCk7CiAgICAgIH0KICAgICAgcGFyc2VBcHBVcmwod2l0aG91dEhhc2hVcmwsIHRoaXMsIGFwcEJhc2UpOwoKICAgICAgdGhpcy4kJHBhdGggPSByZW1vdmVXaW5kb3dzRHJpdmVOYW1lKHRoaXMuJCRwYXRoLCB3aXRob3V0SGFzaFVybCwgYXBwQmFzZSk7CgogICAgICB0aGlzLiQkY29tcG9zZSgpOwoKICAgICAgLyoKICAgICAgICogSW4gV2luZG93cywgb24gYW4gYW5jaG9yIG5vZGUgb24gZG9jdW1lbnRzIGxvYWRlZCBmcm9tCiAgICAgICAqIHRoZSBmaWxlc3lzdGVtLCB0aGUgYnJvd3NlciB3aWxsIHJldHVybiBhIHBhdGhuYW1lCiAgICAgICAqIHByZWZpeGVkIHdpdGggdGhlIGRyaXZlIG5hbWUgKCcvQzovcGF0aCcpIHdoZW4gYQogICAgICAgKiBwYXRobmFtZSB3aXRob3V0IGEgZHJpdmUgaXMgc2V0OgogICAgICAgKiAgKiBhLnNldEF0dHJpYnV0ZSgnaHJlZicsICcvZm9vJykKICAgICAgICogICAqIGEucGF0aG5hbWUgPT09ICcvQzovZm9vJyAvL3RydWUKICAgICAgICoKICAgICAgICogSW5zaWRlIG9mIEFuZ3VsYXIsIHdlJ3JlIGFsd2F5cyB1c2luZyBwYXRobmFtZXMgdGhhdAogICAgICAgKiBkbyBub3QgaW5jbHVkZSBkcml2ZSBuYW1lcyBmb3Igcm91dGluZy4KICAgICAgICovCiAgICAgIGZ1bmN0aW9uIHJlbW92ZVdpbmRvd3NEcml2ZU5hbWUgKHBhdGgsIHVybCwgYmFzZSkgewogICAgICAgIC8qCiAgICAgICAgIE1hdGNoZXMgcGF0aHMgZm9yIGZpbGUgcHJvdG9jb2wgb24gd2luZG93cywKICAgICAgICAgc3VjaCBhcyAvQzovZm9vL2JhciwgYW5kIGNhcHR1cmVzIG9ubHkgL2Zvby9iYXIuCiAgICAgICAgICovCiAgICAgICAgdmFyIHdpbmRvd3NGaWxlUGF0aEV4cCA9IC9eXC9bQS1aXTooXC8uKikvOwoKICAgICAgICB2YXIgZmlyc3RQYXRoU2VnbWVudE1hdGNoOwoKICAgICAgICAvL0dldCB0aGUgcmVsYXRpdmUgcGF0aCBmcm9tIHRoZSBpbnB1dCBVUkwuCiAgICAgICAgaWYgKHVybC5pbmRleE9mKGJhc2UpID09PSAwKSB7CiAgICAgICAgICB1cmwgPSB1cmwucmVwbGFjZShiYXNlLCAnJyk7CiAgICAgICAgfQoKICAgICAgICAvLyBUaGUgaW5wdXQgVVJMIGludGVudGlvbmFsbHkgY29udGFpbnMgYSBmaXJzdCBwYXRoIHNlZ21lbnQgdGhhdCBlbmRzIHdpdGggYSBjb2xvbi4KICAgICAgICBpZiAod2luZG93c0ZpbGVQYXRoRXhwLmV4ZWModXJsKSkgewogICAgICAgICAgcmV0dXJuIHBhdGg7CiAgICAgICAgfQoKICAgICAgICBmaXJzdFBhdGhTZWdtZW50TWF0Y2ggPSB3aW5kb3dzRmlsZVBhdGhFeHAuZXhlYyhwYXRoKTsKICAgICAgICByZXR1cm4gZmlyc3RQYXRoU2VnbWVudE1hdGNoID8gZmlyc3RQYXRoU2VnbWVudE1hdGNoWzFdIDogcGF0aDsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIENvbXBvc2UgaGFzaGJhbmcgdXJsIGFuZCB1cGRhdGUgYGFic1VybGAgcHJvcGVydHkKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgIGhhc2ggPSB0aGlzLiQkaGFzaCA/ICcjJyArIGVuY29kZVVyaVNlZ21lbnQodGhpcy4kJGhhc2gpIDogJyc7CgogICAgICB0aGlzLiQkdXJsID0gZW5jb2RlUGF0aCh0aGlzLiQkcGF0aCkgKyAoc2VhcmNoID8gJz8nICsgc2VhcmNoIDogJycpICsgaGFzaDsKICAgICAgdGhpcy4kJGFic1VybCA9IGFwcEJhc2UgKyAodGhpcy4kJHVybCA/IGhhc2hQcmVmaXggKyB0aGlzLiQkdXJsIDogJycpOwogICAgfTsKCiAgICB0aGlzLiQkcmV3cml0ZSA9IGZ1bmN0aW9uKHVybCkgewogICAgICBpZihzdHJpcEhhc2goYXBwQmFzZSkgPT0gc3RyaXBIYXNoKHVybCkpIHsKICAgICAgICByZXR1cm4gdXJsOwogICAgICB9CiAgICB9OwogIH0KCgogIC8qKgogICAqIExvY2F0aW9uSGFzaGJhbmdVcmwgcmVwcmVzZW50cyB1cmwKICAgKiBUaGlzIG9iamVjdCBpcyBleHBvc2VkIGFzICRsb2NhdGlvbiBzZXJ2aWNlIHdoZW4gaHRtbDUgaGlzdG9yeSBhcGkgaXMgZW5hYmxlZCBidXQgdGhlIGJyb3dzZXIKICAgKiBkb2VzIG5vdCBzdXBwb3J0IGl0LgogICAqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEJhc2UgYXBwbGljYXRpb24gYmFzZSBVUkwKICAgKiBAcGFyYW0ge3N0cmluZ30gaGFzaFByZWZpeCBoYXNoYmFuZyBwcmVmaXgKICAgKi8KICBmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybChhcHBCYXNlLCBoYXNoUHJlZml4KSB7CiAgICB0aGlzLiQkaHRtbDUgPSB0cnVlOwogICAgTG9jYXRpb25IYXNoYmFuZ1VybC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgIHZhciBhcHBCYXNlTm9GaWxlID0gc3RyaXBGaWxlKGFwcEJhc2UpOwoKICAgIHRoaXMuJCRyZXdyaXRlID0gZnVuY3Rpb24odXJsKSB7CiAgICAgIHZhciBhcHBVcmw7CgogICAgICBpZiAoIGFwcEJhc2UgPT0gc3RyaXBIYXNoKHVybCkgKSB7CiAgICAgICAgcmV0dXJuIHVybDsKICAgICAgfSBlbHNlIGlmICggKGFwcFVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZU5vRmlsZSwgdXJsKSkgKSB7CiAgICAgICAgcmV0dXJuIGFwcEJhc2UgKyBoYXNoUHJlZml4ICsgYXBwVXJsOwogICAgICB9IGVsc2UgaWYgKCBhcHBCYXNlTm9GaWxlID09PSB1cmwgKyAnLycpIHsKICAgICAgICByZXR1cm4gYXBwQmFzZU5vRmlsZTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLiQkY29tcG9zZSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VhcmNoID0gdG9LZXlWYWx1ZSh0aGlzLiQkc2VhcmNoKSwKICAgICAgICBoYXNoID0gdGhpcy4kJGhhc2ggPyAnIycgKyBlbmNvZGVVcmlTZWdtZW50KHRoaXMuJCRoYXNoKSA6ICcnOwoKICAgICAgdGhpcy4kJHVybCA9IGVuY29kZVBhdGgodGhpcy4kJHBhdGgpICsgKHNlYXJjaCA/ICc/JyArIHNlYXJjaCA6ICcnKSArIGhhc2g7CiAgICAgIC8vIGluY2x1ZGUgaGFzaFByZWZpeCBpbiAkJGFic1VybCB3aGVuICQkdXJsIGlzIGVtcHR5IHNvIElFOCAmIDkgZG8gbm90IHJlbG9hZCBwYWdlIGJlY2F1c2Ugb2YgcmVtb3ZhbCBvZiAnIycKICAgICAgdGhpcy4kJGFic1VybCA9IGFwcEJhc2UgKyBoYXNoUHJlZml4ICsgdGhpcy4kJHVybDsKICAgIH07CgogIH0KCgogIExvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsLnByb3RvdHlwZSA9CiAgICBMb2NhdGlvbkhhc2hiYW5nVXJsLnByb3RvdHlwZSA9CiAgICAgIExvY2F0aW9uSHRtbDVVcmwucHJvdG90eXBlID0gewoKICAgICAgICAvKioKICAgICAgICAgKiBBcmUgd2UgaW4gaHRtbDUgbW9kZT8KICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgICQkaHRtbDU6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBIYXMgYW55IGNoYW5nZSBiZWVuIHJlcGxhY2luZyA/CiAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgKi8KICAgICAgICAkJHJlcGxhY2U6IGZhbHNlLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGxvY2F0aW9uI2Fic1VybAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gZnVsbCB1cmwgcmVwcmVzZW50YXRpb24gd2l0aCBhbGwgc2VnbWVudHMgZW5jb2RlZCBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAgICAgICAgICogW1JGQyAzOTg2XShodHRwOi8vd3d3LmlldGYub3JnL3JmYy9yZmMzOTg2LnR4dCkuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IGZ1bGwgdXJsCiAgICAgICAgICovCiAgICAgICAgYWJzVXJsOiBsb2NhdGlvbkdldHRlcignJCRhYnNVcmwnKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRsb2NhdGlvbiN1cmwKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciAvIHNldHRlci4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiB1cmwgKGUuZy4gYC9wYXRoP2E9YiNoYXNoYCkgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIHBhdGgsIHNlYXJjaCBhbmQgaGFzaCwgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdXJsIE5ldyB1cmwgd2l0aG91dCBiYXNlIHByZWZpeCAoZS5nLiBgL3BhdGg/YT1iI2hhc2hgKQogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVwbGFjZSBUaGUgcGF0aCB0aGF0IHdpbGwgYmUgY2hhbmdlZAogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gdXJsCiAgICAgICAgICovCiAgICAgICAgdXJsOiBmdW5jdGlvbih1cmwsIHJlcGxhY2UpIHsKICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh1cmwpKQogICAgICAgICAgICByZXR1cm4gdGhpcy4kJHVybDsKCiAgICAgICAgICB2YXIgbWF0Y2ggPSBQQVRIX01BVENILmV4ZWModXJsKTsKICAgICAgICAgIGlmIChtYXRjaFsxXSkgdGhpcy5wYXRoKGRlY29kZVVSSUNvbXBvbmVudChtYXRjaFsxXSkpOwogICAgICAgICAgaWYgKG1hdGNoWzJdIHx8IG1hdGNoWzFdKSB0aGlzLnNlYXJjaChtYXRjaFszXSB8fCAnJyk7CiAgICAgICAgICB0aGlzLmhhc2gobWF0Y2hbNV0gfHwgJycsIHJlcGxhY2UpOwoKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkbG9jYXRpb24jcHJvdG9jb2wKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHByb3RvY29sIG9mIGN1cnJlbnQgdXJsLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBwcm90b2NvbCBvZiBjdXJyZW50IHVybAogICAgICAgICAqLwogICAgICAgIHByb3RvY29sOiBsb2NhdGlvbkdldHRlcignJCRwcm90b2NvbCcpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGxvY2F0aW9uI2hvc3QKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIGhvc3Qgb2YgY3VycmVudCB1cmwuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IGhvc3Qgb2YgY3VycmVudCB1cmwuCiAgICAgICAgICovCiAgICAgICAgaG9zdDogbG9jYXRpb25HZXR0ZXIoJyQkaG9zdCcpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGxvY2F0aW9uI3BvcnQKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIGdldHRlciBvbmx5LgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHBvcnQgb2YgY3VycmVudCB1cmwuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9IHBvcnQKICAgICAgICAgKi8KICAgICAgICBwb3J0OiBsb2NhdGlvbkdldHRlcignJCRwb3J0JyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkbG9jYXRpb24jcGF0aAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHBhdGggb2YgY3VycmVudCB1cmwgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIHBhdGggd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIE5vdGU6IFBhdGggc2hvdWxkIGFsd2F5cyBiZWdpbiB3aXRoIGZvcndhcmQgc2xhc2ggKC8pLCB0aGlzIG1ldGhvZCB3aWxsIGFkZCB0aGUgZm9yd2FyZCBzbGFzaAogICAgICAgICAqIGlmIGl0IGlzIG1pc3NpbmcuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IHBhdGggTmV3IHBhdGgKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHBhdGgKICAgICAgICAgKi8KICAgICAgICBwYXRoOiBsb2NhdGlvbkdldHRlclNldHRlcignJCRwYXRoJywgZnVuY3Rpb24ocGF0aCkgewogICAgICAgICAgcmV0dXJuIHBhdGguY2hhckF0KDApID09ICcvJyA/IHBhdGggOiAnLycgKyBwYXRoOwogICAgICAgIH0pLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGxvY2F0aW9uI3NlYXJjaAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHNlYXJjaCBwYXJ0IChhcyBvYmplY3QpIG9mIGN1cnJlbnQgdXJsIHdoZW4gY2FsbGVkIHdpdGhvdXQgYW55IHBhcmFtZXRlci4KICAgICAgICAgKgogICAgICAgICAqIENoYW5nZSBzZWFyY2ggcGFydCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiBgYGBqcwogICAgICAgICAqIC8vIGdpdmVuIHVybCBodHRwOi8vZXhhbXBsZS5jb20vIy9zb21lL3BhdGg/Zm9vPWJhciZiYXo9eG94bwogICAgICAgICAqIHZhciBzZWFyY2hPYmplY3QgPSAkbG9jYXRpb24uc2VhcmNoKCk7CiAgICAgICAgICogLy8gPT4ge2ZvbzogJ2JhcicsIGJhejogJ3hveG8nfQogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiAvLyBzZXQgZm9vIHRvICd5aXBlZScKICAgICAgICAgKiAkbG9jYXRpb24uc2VhcmNoKCdmb28nLCAneWlwZWUnKTsKICAgICAgICAgKiAvLyA9PiAkbG9jYXRpb24KICAgICAgICAgKiBgYGAKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdC48c3RyaW5nPnxPYmplY3QuPEFycmF5LjxzdHJpbmc+Pn0gc2VhcmNoIE5ldyBzZWFyY2ggcGFyYW1zIC0gc3RyaW5nIG9yCiAgICAgICAgICogaGFzaCBvYmplY3QuCiAgICAgICAgICoKICAgICAgICAgKiBXaGVuIGNhbGxlZCB3aXRoIGEgc2luZ2xlIGFyZ3VtZW50IHRoZSBtZXRob2QgYWN0cyBhcyBhIHNldHRlciwgc2V0dGluZyB0aGUgYHNlYXJjaGAgY29tcG9uZW50CiAgICAgICAgICogb2YgYCRsb2NhdGlvbmAgdG8gdGhlIHNwZWNpZmllZCB2YWx1ZS4KICAgICAgICAgKgogICAgICAgICAqIElmIHRoZSBhcmd1bWVudCBpcyBhIGhhc2ggb2JqZWN0IGNvbnRhaW5pbmcgYW4gYXJyYXkgb2YgdmFsdWVzLCB0aGVzZSB2YWx1ZXMgd2lsbCBiZSBlbmNvZGVkCiAgICAgICAgICogYXMgZHVwbGljYXRlIHNlYXJjaCBwYXJhbWV0ZXJzIGluIHRoZSB1cmwuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8QXJyYXk8c3RyaW5nPik9fSBwYXJhbVZhbHVlIElmIGBzZWFyY2hgIGlzIGEgc3RyaW5nLCB0aGVuIGBwYXJhbVZhbHVlYCB3aWxsCiAgICAgICAgICogb3ZlcnJpZGUgb25seSBhIHNpbmdsZSBzZWFyY2ggcHJvcGVydHkuCiAgICAgICAgICoKICAgICAgICAgKiBJZiBgcGFyYW1WYWx1ZWAgaXMgYW4gYXJyYXksIGl0IHdpbGwgb3ZlcnJpZGUgdGhlIHByb3BlcnR5IG9mIHRoZSBgc2VhcmNoYCBjb21wb25lbnQgb2YKICAgICAgICAgKiBgJGxvY2F0aW9uYCBzcGVjaWZpZWQgdmlhIHRoZSBmaXJzdCBhcmd1bWVudC4KICAgICAgICAgKgogICAgICAgICAqIElmIGBwYXJhbVZhbHVlYCBpcyBgbnVsbGAsIHRoZSBwcm9wZXJ0eSBzcGVjaWZpZWQgdmlhIHRoZSBmaXJzdCBhcmd1bWVudCB3aWxsIGJlIGRlbGV0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IElmIGNhbGxlZCB3aXRoIG5vIGFyZ3VtZW50cyByZXR1cm5zIHRoZSBwYXJzZWQgYHNlYXJjaGAgb2JqZWN0LiBJZiBjYWxsZWQgd2l0aAogICAgICAgICAqIG9uZSBvciBtb3JlIGFyZ3VtZW50cyByZXR1cm5zIGAkbG9jYXRpb25gIG9iamVjdCBpdHNlbGYuCiAgICAgICAgICovCiAgICAgICAgc2VhcmNoOiBmdW5jdGlvbihzZWFyY2gsIHBhcmFtVmFsdWUpIHsKICAgICAgICAgIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJCRzZWFyY2g7CiAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoc2VhcmNoKSkgewogICAgICAgICAgICAgICAgdGhpcy4kJHNlYXJjaCA9IHBhcnNlS2V5VmFsdWUoc2VhcmNoKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHNlYXJjaCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuJCRzZWFyY2ggPSBzZWFyY2g7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93ICRsb2NhdGlvbk1pbkVycignaXNyY2hhcmcnLAogICAgICAgICAgICAgICAgICAnVGhlIGZpcnN0IGFyZ3VtZW50IG9mIHRoZSBgJGxvY2F0aW9uI3NlYXJjaCgpYCBjYWxsIG11c3QgYmUgYSBzdHJpbmcgb3IgYW4gb2JqZWN0LicpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQocGFyYW1WYWx1ZSkgfHwgcGFyYW1WYWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuJCRzZWFyY2hbc2VhcmNoXTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy4kJHNlYXJjaFtzZWFyY2hdID0gcGFyYW1WYWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy4kJGNvbXBvc2UoKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkbG9jYXRpb24jaGFzaAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIGhhc2ggZnJhZ21lbnQgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIGhhc2ggZnJhZ21lbnQgd2hlbiBjYWxsZWQgd2l0aCBwYXJhbWV0ZXIgYW5kIHJldHVybiBgJGxvY2F0aW9uYC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gaGFzaCBOZXcgaGFzaCBmcmFnbWVudAogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gaGFzaAogICAgICAgICAqLwogICAgICAgIGhhc2g6IGxvY2F0aW9uR2V0dGVyU2V0dGVyKCckJGhhc2gnLCBpZGVudGl0eSksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkbG9jYXRpb24jcmVwbGFjZQogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogSWYgY2FsbGVkLCBhbGwgY2hhbmdlcyB0byAkbG9jYXRpb24gZHVyaW5nIGN1cnJlbnQgYCRkaWdlc3RgIHdpbGwgYmUgcmVwbGFjaW5nIGN1cnJlbnQgaGlzdG9yeQogICAgICAgICAqIHJlY29yZCwgaW5zdGVhZCBvZiBhZGRpbmcgbmV3IG9uZS4KICAgICAgICAgKi8KICAgICAgICByZXBsYWNlOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMuJCRyZXBsYWNlID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KICAgICAgfTsKCiAgZnVuY3Rpb24gbG9jYXRpb25HZXR0ZXIocHJvcGVydHkpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXNbcHJvcGVydHldOwogICAgfTsKICB9CgoKICBmdW5jdGlvbiBsb2NhdGlvbkdldHRlclNldHRlcihwcm9wZXJ0eSwgcHJlcHJvY2VzcykgewogICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChpc1VuZGVmaW5lZCh2YWx1ZSkpCiAgICAgICAgcmV0dXJuIHRoaXNbcHJvcGVydHldOwoKICAgICAgdGhpc1twcm9wZXJ0eV0gPSBwcmVwcm9jZXNzKHZhbHVlKTsKICAgICAgdGhpcy4kJGNvbXBvc2UoKTsKCiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9CgoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRsb2NhdGlvbgogICAqCiAgICogQHJlcXVpcmVzICRyb290RWxlbWVudAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlICRsb2NhdGlvbiBzZXJ2aWNlIHBhcnNlcyB0aGUgVVJMIGluIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyIChiYXNlZCBvbiB0aGUKICAgKiBbd2luZG93LmxvY2F0aW9uXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi93aW5kb3cubG9jYXRpb24pKSBhbmQgbWFrZXMgdGhlIFVSTAogICAqIGF2YWlsYWJsZSB0byB5b3VyIGFwcGxpY2F0aW9uLiBDaGFuZ2VzIHRvIHRoZSBVUkwgaW4gdGhlIGFkZHJlc3MgYmFyIGFyZSByZWZsZWN0ZWQgaW50bwogICAqICRsb2NhdGlvbiBzZXJ2aWNlIGFuZCBjaGFuZ2VzIHRvICRsb2NhdGlvbiBhcmUgcmVmbGVjdGVkIGludG8gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIuCiAgICoKICAgKiAqKlRoZSAkbG9jYXRpb24gc2VydmljZToqKgogICAqCiAgICogLSBFeHBvc2VzIHRoZSBjdXJyZW50IFVSTCBpbiB0aGUgYnJvd3NlciBhZGRyZXNzIGJhciwgc28geW91IGNhbgogICAqICAgLSBXYXRjaCBhbmQgb2JzZXJ2ZSB0aGUgVVJMLgogICAqICAgLSBDaGFuZ2UgdGhlIFVSTC4KICAgKiAtIFN5bmNocm9uaXplcyB0aGUgVVJMIHdpdGggdGhlIGJyb3dzZXIgd2hlbiB0aGUgdXNlcgogICAqICAgLSBDaGFuZ2VzIHRoZSBhZGRyZXNzIGJhci4KICAgKiAgIC0gQ2xpY2tzIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIChvciBjbGlja3MgYSBIaXN0b3J5IGxpbmspLgogICAqICAgLSBDbGlja3Mgb24gYSBsaW5rLgogICAqIC0gUmVwcmVzZW50cyB0aGUgVVJMIG9iamVjdCBhcyBhIHNldCBvZiBtZXRob2RzIChwcm90b2NvbCwgaG9zdCwgcG9ydCwgcGF0aCwgc2VhcmNoLCBoYXNoKS4KICAgKgogICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIHNlZSB7QGxpbmsgZ3VpZGUvJGxvY2F0aW9uIERldmVsb3BlciBHdWlkZTogVXNpbmcgJGxvY2F0aW9ufQogICAqLwoKICAvKioKICAgKiBAbmdkb2MgcHJvdmlkZXIKICAgKiBAbmFtZSAkbG9jYXRpb25Qcm92aWRlcgogICAqIEBkZXNjcmlwdGlvbgogICAqIFVzZSB0aGUgYCRsb2NhdGlvblByb3ZpZGVyYCB0byBjb25maWd1cmUgaG93IHRoZSBhcHBsaWNhdGlvbiBkZWVwIGxpbmtpbmcgcGF0aHMgYXJlIHN0b3JlZC4KICAgKi8KICBmdW5jdGlvbiAkTG9jYXRpb25Qcm92aWRlcigpewogICAgdmFyIGhhc2hQcmVmaXggPSAnJywKICAgICAgaHRtbDVNb2RlID0gZmFsc2U7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lICRsb2NhdGlvblByb3ZpZGVyI2hhc2hQcmVmaXgKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBwcmVmaXggUHJlZml4IGZvciBoYXNoIHBhcnQgKGNvbnRhaW5pbmcgcGF0aCBhbmQgc2VhcmNoKQogICAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgICAqLwogICAgdGhpcy5oYXNoUHJlZml4ID0gZnVuY3Rpb24ocHJlZml4KSB7CiAgICAgIGlmIChpc0RlZmluZWQocHJlZml4KSkgewogICAgICAgIGhhc2hQcmVmaXggPSBwcmVmaXg7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGhhc2hQcmVmaXg7CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lICRsb2NhdGlvblByb3ZpZGVyI2h0bWw1TW9kZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBtb2RlIFVzZSBIVE1MNSBzdHJhdGVneSBpZiBhdmFpbGFibGUuCiAgICAgKiBAcmV0dXJucyB7Kn0gY3VycmVudCB2YWx1ZSBpZiB1c2VkIGFzIGdldHRlciBvciBpdHNlbGYgKGNoYWluaW5nKSBpZiB1c2VkIGFzIHNldHRlcgogICAgICovCiAgICB0aGlzLmh0bWw1TW9kZSA9IGZ1bmN0aW9uKG1vZGUpIHsKICAgICAgaWYgKGlzRGVmaW5lZChtb2RlKSkgewogICAgICAgIGh0bWw1TW9kZSA9IG1vZGU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGh0bWw1TW9kZTsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBldmVudAogICAgICogQG5hbWUgJGxvY2F0aW9uIyRsb2NhdGlvbkNoYW5nZVN0YXJ0CiAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEJyb2FkY2FzdGVkIGJlZm9yZSBhIFVSTCB3aWxsIGNoYW5nZS4gVGhpcyBjaGFuZ2UgY2FuIGJlIHByZXZlbnRlZCBieSBjYWxsaW5nCiAgICAgKiBgcHJldmVudERlZmF1bHRgIG1ldGhvZCBvZiB0aGUgZXZlbnQuIFNlZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGZvciBtb3JlCiAgICAgKiBkZXRhaWxzIGFib3V0IGV2ZW50IG9iamVjdC4gVXBvbiBzdWNjZXNzZnVsIGNoYW5nZQogICAgICoge0BsaW5rIG5nLiRsb2NhdGlvbiNldmVudHNfJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcyAkbG9jYXRpb25DaGFuZ2VTdWNjZXNzfSBpcyBmaXJlZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdH0gYW5ndWxhckV2ZW50IFN5bnRoZXRpYyBldmVudCBvYmplY3QuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3VXJsIE5ldyBVUkwKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gb2xkVXJsIFVSTCB0aGF0IHdhcyBiZWZvcmUgaXQgd2FzIGNoYW5nZWQuCiAgICAgKi8KCiAgICAvKioKICAgICAqIEBuZ2RvYyBldmVudAogICAgICogQG5hbWUgJGxvY2F0aW9uIyRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3MKICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQnJvYWRjYXN0ZWQgYWZ0ZXIgYSBVUkwgd2FzIGNoYW5nZWQuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IGFuZ3VsYXJFdmVudCBTeW50aGV0aWMgZXZlbnQgb2JqZWN0LgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld1VybCBOZXcgVVJMCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG9sZFVybCBVUkwgdGhhdCB3YXMgYmVmb3JlIGl0IHdhcyBjaGFuZ2VkLgogICAgICovCgogICAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRicm93c2VyJywgJyRzbmlmZmVyJywgJyRyb290RWxlbWVudCcsCiAgICAgIGZ1bmN0aW9uKCAkcm9vdFNjb3BlLCAgICRicm93c2VyLCAgICRzbmlmZmVyLCAgICRyb290RWxlbWVudCkgewogICAgICAgIHZhciAkbG9jYXRpb24sCiAgICAgICAgICBMb2NhdGlvbk1vZGUsCiAgICAgICAgICBiYXNlSHJlZiA9ICRicm93c2VyLmJhc2VIcmVmKCksIC8vIGlmIGJhc2VbaHJlZl0gaXMgdW5kZWZpbmVkLCBpdCBkZWZhdWx0cyB0byAnJwogICAgICAgICAgaW5pdGlhbFVybCA9ICRicm93c2VyLnVybCgpLAogICAgICAgICAgYXBwQmFzZTsKCiAgICAgICAgaWYgKGh0bWw1TW9kZSkgewogICAgICAgICAgYXBwQmFzZSA9IHNlcnZlckJhc2UoaW5pdGlhbFVybCkgKyAoYmFzZUhyZWYgfHwgJy8nKTsKICAgICAgICAgIExvY2F0aW9uTW9kZSA9ICRzbmlmZmVyLmhpc3RvcnkgPyBMb2NhdGlvbkh0bWw1VXJsIDogTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFwcEJhc2UgPSBzdHJpcEhhc2goaW5pdGlhbFVybCk7CiAgICAgICAgICBMb2NhdGlvbk1vZGUgPSBMb2NhdGlvbkhhc2hiYW5nVXJsOwogICAgICAgIH0KICAgICAgICAkbG9jYXRpb24gPSBuZXcgTG9jYXRpb25Nb2RlKGFwcEJhc2UsICcjJyArIGhhc2hQcmVmaXgpOwogICAgICAgICRsb2NhdGlvbi4kJHBhcnNlKCRsb2NhdGlvbi4kJHJld3JpdGUoaW5pdGlhbFVybCkpOwoKICAgICAgICAkcm9vdEVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIC8vIFRPRE8odm9qdGEpOiByZXdyaXRlIGxpbmsgd2hlbiBvcGVuaW5nIGluIG5ldyB0YWIvd2luZG93IChpbiBsZWdhY3kgYnJvd3NlcikKICAgICAgICAgIC8vIGN1cnJlbnRseSB3ZSBvcGVuIG5pY2UgdXJsIGxpbmsgYW5kIHJlZGlyZWN0IHRoZW4KCiAgICAgICAgICBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5IHx8IGV2ZW50LndoaWNoID09IDIpIHJldHVybjsKCiAgICAgICAgICB2YXIgZWxtID0ganFMaXRlKGV2ZW50LnRhcmdldCk7CgogICAgICAgICAgLy8gdHJhdmVyc2UgdGhlIERPTSB1cCB0byBmaW5kIGZpcnN0IEEgdGFnCiAgICAgICAgICB3aGlsZSAobG93ZXJjYXNlKGVsbVswXS5ub2RlTmFtZSkgIT09ICdhJykgewogICAgICAgICAgICAvLyBpZ25vcmUgcmV3cml0aW5nIGlmIG5vIEEgdGFnIChyZWFjaGVkIHJvb3QgZWxlbWVudCwgb3Igbm8gcGFyZW50IC0gcmVtb3ZlZCBmcm9tIGRvY3VtZW50KQogICAgICAgICAgICBpZiAoZWxtWzBdID09PSAkcm9vdEVsZW1lbnRbMF0gfHwgIShlbG0gPSBlbG0ucGFyZW50KCkpWzBdKSByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGFic0hyZWYgPSBlbG0ucHJvcCgnaHJlZicpOwoKICAgICAgICAgIGlmIChpc09iamVjdChhYnNIcmVmKSAmJiBhYnNIcmVmLnRvU3RyaW5nKCkgPT09ICdbb2JqZWN0IFNWR0FuaW1hdGVkU3RyaW5nXScpIHsKICAgICAgICAgICAgLy8gU1ZHQW5pbWF0ZWRTdHJpbmcuYW5pbVZhbCBzaG91bGQgYmUgaWRlbnRpY2FsIHRvIFNWR0FuaW1hdGVkU3RyaW5nLmJhc2VWYWwsIHVubGVzcyBkdXJpbmcKICAgICAgICAgICAgLy8gYW4gYW5pbWF0aW9uLgogICAgICAgICAgICBhYnNIcmVmID0gdXJsUmVzb2x2ZShhYnNIcmVmLmFuaW1WYWwpLmhyZWY7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTWFrZSByZWxhdGl2ZSBsaW5rcyB3b3JrIGluIEhUTUw1IG1vZGUgZm9yIGxlZ2FjeSBicm93c2VycyAob3IgYXQgbGVhc3QgSUU4ICYgOSkKICAgICAgICAgIC8vIFRoZSBocmVmIHNob3VsZCBiZSBhIHJlZ3VsYXIgdXJsIGUuZy4gL2xpbmsvc29tZXdoZXJlIG9yIGxpbmsvc29tZXdoZXJlIG9yIC4uL3NvbWV3aGVyZSBvcgogICAgICAgICAgLy8gc29tZXdoZXJlI2FuY2hvciBvciBodHRwOi8vZXhhbXBsZS5jb20vc29tZXdoZXJlCiAgICAgICAgICBpZiAoTG9jYXRpb25Nb2RlID09PSBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybCkgewogICAgICAgICAgICAvLyBnZXQgdGhlIGFjdHVhbCBocmVmIGF0dHJpYnV0ZSAtIHNlZQogICAgICAgICAgICAvLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvaWUvZGQzNDcxNDgodj12cy44NSkuYXNweAogICAgICAgICAgICB2YXIgaHJlZiA9IGVsbS5hdHRyKCdocmVmJykgfHwgZWxtLmF0dHIoJ3hsaW5rOmhyZWYnKTsKCiAgICAgICAgICAgIGlmIChocmVmLmluZGV4T2YoJzovLycpIDwgMCkgeyAgICAgICAgIC8vIElnbm9yZSBhYnNvbHV0ZSBVUkxzCiAgICAgICAgICAgICAgdmFyIHByZWZpeCA9ICcjJyArIGhhc2hQcmVmaXg7CiAgICAgICAgICAgICAgaWYgKGhyZWZbMF0gPT0gJy8nKSB7CiAgICAgICAgICAgICAgICAvLyBhYnNvbHV0ZSBwYXRoIC0gcmVwbGFjZSBvbGQgcGF0aAogICAgICAgICAgICAgICAgYWJzSHJlZiA9IGFwcEJhc2UgKyBwcmVmaXggKyBocmVmOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaHJlZlswXSA9PSAnIycpIHsKICAgICAgICAgICAgICAgIC8vIGxvY2FsIGFuY2hvcgogICAgICAgICAgICAgICAgYWJzSHJlZiA9IGFwcEJhc2UgKyBwcmVmaXggKyAoJGxvY2F0aW9uLnBhdGgoKSB8fCAnLycpICsgaHJlZjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gcmVsYXRpdmUgcGF0aCAtIGpvaW4gd2l0aCBjdXJyZW50IHBhdGgKICAgICAgICAgICAgICAgIHZhciBzdGFjayA9ICRsb2NhdGlvbi5wYXRoKCkuc3BsaXQoIi8iKSwKICAgICAgICAgICAgICAgICAgcGFydHMgPSBocmVmLnNwbGl0KCIvIik7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpPTA7IGk8cGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKHBhcnRzW2ldID09ICIuIikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocGFydHNbaV0gPT0gIi4uIikKICAgICAgICAgICAgICAgICAgICBzdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocGFydHNbaV0ubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gocGFydHNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYWJzSHJlZiA9IGFwcEJhc2UgKyBwcmVmaXggKyBzdGFjay5qb2luKCcvJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHJld3JpdHRlblVybCA9ICRsb2NhdGlvbi4kJHJld3JpdGUoYWJzSHJlZik7CgogICAgICAgICAgaWYgKGFic0hyZWYgJiYgIWVsbS5hdHRyKCd0YXJnZXQnKSAmJiByZXdyaXR0ZW5VcmwgJiYgIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpKSB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGlmIChyZXdyaXR0ZW5VcmwgIT0gJGJyb3dzZXIudXJsKCkpIHsKICAgICAgICAgICAgICAvLyB1cGRhdGUgbG9jYXRpb24gbWFudWFsbHkKICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShyZXdyaXR0ZW5VcmwpOwogICAgICAgICAgICAgICRyb290U2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICAgICAgLy8gaGFjayB0byB3b3JrIGFyb3VuZCBGRjYgYnVnIDY4NDIwOCB3aGVuIHNjZW5hcmlvIHJ1bm5lciBjbGlja3Mgb24gbGlua3MKICAgICAgICAgICAgICB3aW5kb3cuYW5ndWxhclsnZmYtNjg0MjA4LXByZXZlbnREZWZhdWx0J10gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CgoKICAgICAgICAvLyByZXdyaXRlIGhhc2hiYW5nIHVybCA8PiBodG1sNSB1cmwKICAgICAgICBpZiAoJGxvY2F0aW9uLmFic1VybCgpICE9IGluaXRpYWxVcmwpIHsKICAgICAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCksIHRydWUpOwogICAgICAgIH0KCiAgICAgICAgLy8gdXBkYXRlICRsb2NhdGlvbiB3aGVuICRicm93c2VyIHVybCBjaGFuZ2VzCiAgICAgICAgJGJyb3dzZXIub25VcmxDaGFuZ2UoZnVuY3Rpb24obmV3VXJsKSB7CiAgICAgICAgICBpZiAoJGxvY2F0aW9uLmFic1VybCgpICE9IG5ld1VybCkgewogICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIG9sZFVybCA9ICRsb2NhdGlvbi5hYnNVcmwoKTsKCiAgICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2UobmV3VXJsKTsKICAgICAgICAgICAgICBpZiAoJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdGFydCcsIG5ld1VybCwKICAgICAgICAgICAgICAgIG9sZFVybCkuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2Uob2xkVXJsKTsKICAgICAgICAgICAgICAgICRicm93c2VyLnVybChvbGRVcmwpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UpICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyB1cGRhdGUgYnJvd3NlcgogICAgICAgIHZhciBjaGFuZ2VDb3VudGVyID0gMDsKICAgICAgICAkcm9vdFNjb3BlLiR3YXRjaChmdW5jdGlvbiAkbG9jYXRpb25XYXRjaCgpIHsKICAgICAgICAgIHZhciBvbGRVcmwgPSAkYnJvd3Nlci51cmwoKTsKICAgICAgICAgIHZhciBjdXJyZW50UmVwbGFjZSA9ICRsb2NhdGlvbi4kJHJlcGxhY2U7CgogICAgICAgICAgaWYgKCFjaGFuZ2VDb3VudGVyIHx8IG9sZFVybCAhPSAkbG9jYXRpb24uYWJzVXJsKCkpIHsKICAgICAgICAgICAgY2hhbmdlQ291bnRlcisrOwogICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3RhcnQnLCAkbG9jYXRpb24uYWJzVXJsKCksIG9sZFVybCkuCiAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShvbGRVcmwpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkYnJvd3Nlci51cmwoJGxvY2F0aW9uLmFic1VybCgpLCBjdXJyZW50UmVwbGFjZSk7CiAgICAgICAgICAgICAgICBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgICRsb2NhdGlvbi4kJHJlcGxhY2UgPSBmYWxzZTsKCiAgICAgICAgICByZXR1cm4gY2hhbmdlQ291bnRlcjsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuICRsb2NhdGlvbjsKCiAgICAgICAgZnVuY3Rpb24gYWZ0ZXJMb2NhdGlvbkNoYW5nZShvbGRVcmwpIHsKICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcycsICRsb2NhdGlvbi5hYnNVcmwoKSwgb2xkVXJsKTsKICAgICAgICB9CiAgICAgIH1dOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkbG9nCiAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNpbXBsZSBzZXJ2aWNlIGZvciBsb2dnaW5nLiBEZWZhdWx0IGltcGxlbWVudGF0aW9uIHNhZmVseSB3cml0ZXMgdGhlIG1lc3NhZ2UKICAgKiBpbnRvIHRoZSBicm93c2VyJ3MgY29uc29sZSAoaWYgcHJlc2VudCkuCiAgICoKICAgKiBUaGUgbWFpbiBwdXJwb3NlIG9mIHRoaXMgc2VydmljZSBpcyB0byBzaW1wbGlmeSBkZWJ1Z2dpbmcgYW5kIHRyb3VibGVzaG9vdGluZy4KICAgKgogICAqIFRoZSBkZWZhdWx0IGlzIHRvIGxvZyBgZGVidWdgIG1lc3NhZ2VzLiBZb3UgY2FuIHVzZQogICAqIHtAbGluayBuZy4kbG9nUHJvdmlkZXIgbmcuJGxvZ1Byb3ZpZGVyI2RlYnVnRW5hYmxlZH0gdG8gY2hhbmdlIHRoaXMuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgZnVuY3Rpb24gTG9nQ3RybCgkc2NvcGUsICRsb2cpIHsKICAgICAgICAgJHNjb3BlLiRsb2cgPSAkbG9nOwogICAgICAgICAkc2NvcGUubWVzc2FnZSA9ICdIZWxsbyBXb3JsZCEnOwogICAgICAgfQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkxvZ0N0cmwiPgogICA8cD5SZWxvYWQgdGhpcyBwYWdlIHdpdGggb3BlbiBjb25zb2xlLCBlbnRlciB0ZXh0IGFuZCBoaXQgdGhlIGxvZyBidXR0b24uLi48L3A+CiAgIE1lc3NhZ2U6CiAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibWVzc2FnZSIvPgogICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmxvZyhtZXNzYWdlKSI+bG9nPC9idXR0b24+CiAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cud2FybihtZXNzYWdlKSI+d2FybjwvYnV0dG9uPgogICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmluZm8obWVzc2FnZSkiPmluZm88L2J1dHRvbj4KICAgPGJ1dHRvbiBuZy1jbGljaz0iJGxvZy5lcnJvcihtZXNzYWdlKSI+ZXJyb3I8L2J1dHRvbj4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgcHJvdmlkZXIKICAgKiBAbmFtZSAkbG9nUHJvdmlkZXIKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2UgdGhlIGAkbG9nUHJvdmlkZXJgIHRvIGNvbmZpZ3VyZSBob3cgdGhlIGFwcGxpY2F0aW9uIGxvZ3MgbWVzc2FnZXMKICAgKi8KICBmdW5jdGlvbiAkTG9nUHJvdmlkZXIoKXsKICAgIHZhciBkZWJ1ZyA9IHRydWUsCiAgICAgIHNlbGYgPSB0aGlzOwoKICAgIC8qKgogICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgKiBAbmFtZSAkbG9nUHJvdmlkZXIjZGVidWdFbmFibGVkCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IGZsYWcgZW5hYmxlIG9yIGRpc2FibGUgZGVidWcgbGV2ZWwgbWVzc2FnZXMKICAgICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICAgKi8KICAgIHRoaXMuZGVidWdFbmFibGVkID0gZnVuY3Rpb24oZmxhZykgewogICAgICBpZiAoaXNEZWZpbmVkKGZsYWcpKSB7CiAgICAgICAgZGVidWcgPSBmbGFnOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkZWJ1ZzsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCBmdW5jdGlvbigkd2luZG93KXsKICAgICAgcmV0dXJuIHsKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGxvZyNsb2cKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFdyaXRlIGEgbG9nIG1lc3NhZ2UKICAgICAgICAgKi8KICAgICAgICBsb2c6IGNvbnNvbGVMb2coJ2xvZycpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGxvZyNpbmZvCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBXcml0ZSBhbiBpbmZvcm1hdGlvbiBtZXNzYWdlCiAgICAgICAgICovCiAgICAgICAgaW5mbzogY29uc29sZUxvZygnaW5mbycpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGxvZyN3YXJuCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBXcml0ZSBhIHdhcm5pbmcgbWVzc2FnZQogICAgICAgICAqLwogICAgICAgIHdhcm46IGNvbnNvbGVMb2coJ3dhcm4nKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRsb2cjZXJyb3IKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFdyaXRlIGFuIGVycm9yIG1lc3NhZ2UKICAgICAgICAgKi8KICAgICAgICBlcnJvcjogY29uc29sZUxvZygnZXJyb3InKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRsb2cjZGVidWcKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFdyaXRlIGEgZGVidWcgbWVzc2FnZQogICAgICAgICAqLwogICAgICAgIGRlYnVnOiAoZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGZuID0gY29uc29sZUxvZygnZGVidWcnKTsKCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChkZWJ1ZykgewogICAgICAgICAgICAgIGZuLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfSgpKQogICAgICB9OwoKICAgICAgZnVuY3Rpb24gZm9ybWF0RXJyb3IoYXJnKSB7CiAgICAgICAgaWYgKGFyZyBpbnN0YW5jZW9mIEVycm9yKSB7CiAgICAgICAgICBpZiAoYXJnLnN0YWNrKSB7CiAgICAgICAgICAgIGFyZyA9IChhcmcubWVzc2FnZSAmJiBhcmcuc3RhY2suaW5kZXhPZihhcmcubWVzc2FnZSkgPT09IC0xKQogICAgICAgICAgICAgID8gJ0Vycm9yOiAnICsgYXJnLm1lc3NhZ2UgKyAnXG4nICsgYXJnLnN0YWNrCiAgICAgICAgICAgICAgOiBhcmcuc3RhY2s7CiAgICAgICAgICB9IGVsc2UgaWYgKGFyZy5zb3VyY2VVUkwpIHsKICAgICAgICAgICAgYXJnID0gYXJnLm1lc3NhZ2UgKyAnXG4nICsgYXJnLnNvdXJjZVVSTCArICc6JyArIGFyZy5saW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjb25zb2xlTG9nKHR5cGUpIHsKICAgICAgICB2YXIgY29uc29sZSA9ICR3aW5kb3cuY29uc29sZSB8fCB7fSwKICAgICAgICAgIGxvZ0ZuID0gY29uc29sZVt0eXBlXSB8fCBjb25zb2xlLmxvZyB8fCBub29wLAogICAgICAgICAgaGFzQXBwbHkgPSBmYWxzZTsKCiAgICAgICAgLy8gTm90ZTogcmVhZGluZyBsb2dGbi5hcHBseSB0aHJvd3MgYW4gZXJyb3IgaW4gSUUxMSBpbiBJRTggZG9jdW1lbnQgbW9kZS4KICAgICAgICAvLyBUaGUgcmVhc29uIGJlaGluZCB0aGlzIGlzIHRoYXQgY29uc29sZS5sb2cgaGFzIHR5cGUgIm9iamVjdCIgaW4gSUU4Li4uCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGhhc0FwcGx5ID0gISFsb2dGbi5hcHBseTsKICAgICAgICB9IGNhdGNoIChlKSB7fQoKICAgICAgICBpZiAoaGFzQXBwbHkpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uKGFyZykgewogICAgICAgICAgICAgIGFyZ3MucHVzaChmb3JtYXRFcnJvcihhcmcpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBsb2dGbi5hcHBseShjb25zb2xlLCBhcmdzKTsKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICAvLyB3ZSBhcmUgSUUgd2hpY2ggZWl0aGVyIGRvZXNuJ3QgaGF2ZSB3aW5kb3cuY29uc29sZSA9PiB0aGlzIGlzIG5vb3AgYW5kIHdlIGRvIG5vdGhpbmcsCiAgICAgICAgLy8gb3Igd2UgYXJlIElFIHdoZXJlIGNvbnNvbGUubG9nIGRvZXNuJ3QgaGF2ZSBhcHBseSBzbyB3ZSBsb2cgYXQgbGVhc3QgZmlyc3QgMiBhcmdzCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFyZzEsIGFyZzIpIHsKICAgICAgICAgIGxvZ0ZuKGFyZzEsIGFyZzIgPT0gbnVsbCA/ICcnIDogYXJnMik7CiAgICAgICAgfTsKICAgICAgfQogICAgfV07CiAgfQoKICB2YXIgJHBhcnNlTWluRXJyID0gbWluRXJyKCckcGFyc2UnKTsKICB2YXIgcHJvbWlzZVdhcm5pbmdDYWNoZSA9IHt9OwogIHZhciBwcm9taXNlV2FybmluZzsKCi8vIFNhbmRib3hpbmcgQW5ndWxhciBFeHByZXNzaW9ucwovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gQW5ndWxhciBleHByZXNzaW9ucyBhcmUgZ2VuZXJhbGx5IGNvbnNpZGVyZWQgc2FmZSBiZWNhdXNlIHRoZXNlIGV4cHJlc3Npb25zIG9ubHkgaGF2ZSBkaXJlY3QKLy8gYWNjZXNzIHRvICRzY29wZSBhbmQgbG9jYWxzLiBIb3dldmVyLCBvbmUgY2FuIG9idGFpbiB0aGUgYWJpbGl0eSB0byBleGVjdXRlIGFyYml0cmFyeSBKUyBjb2RlIGJ5Ci8vIG9idGFpbmluZyBhIHJlZmVyZW5jZSB0byBuYXRpdmUgSlMgZnVuY3Rpb25zIHN1Y2ggYXMgdGhlIEZ1bmN0aW9uIGNvbnN0cnVjdG9yLgovLwovLyBBcyBhbiBleGFtcGxlLCBjb25zaWRlciB0aGUgZm9sbG93aW5nIEFuZ3VsYXIgZXhwcmVzc2lvbjoKLy8KLy8gICB7fS50b1N0cmluZy5jb25zdHJ1Y3RvcihhbGVydCgiZXZpbCBKUyBjb2RlIikpCi8vCi8vIFdlIHdhbnQgdG8gcHJldmVudCB0aGlzIHR5cGUgb2YgYWNjZXNzLiBGb3IgdGhlIHNha2Ugb2YgcGVyZm9ybWFuY2UsIGR1cmluZyB0aGUgbGV4aW5nIHBoYXNlIHdlCi8vIGRpc2FsbG93IGFueSAiZG90dGVkIiBhY2Nlc3MgdG8gYW55IG1lbWJlciBuYW1lZCAiY29uc3RydWN0b3IiLgovLwovLyBGb3IgcmVmbGVjdGl2ZSBjYWxscyAoYVtiXSkgd2UgY2hlY2sgdGhhdCB0aGUgdmFsdWUgb2YgdGhlIGxvb2t1cCBpcyBub3QgdGhlIEZ1bmN0aW9uIGNvbnN0cnVjdG9yCi8vIHdoaWxlIGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24sIHdoaWNoIGlzIGEgc3Ryb25nZXIgYnV0IG1vcmUgZXhwZW5zaXZlIHRlc3QuIFNpbmNlIHJlZmxlY3RpdmUKLy8gY2FsbHMgYXJlIGV4cGVuc2l2ZSBhbnl3YXksIHRoaXMgaXMgbm90IHN1Y2ggYSBiaWcgZGVhbCBjb21wYXJlZCB0byBzdGF0aWMgZGVyZWZlcmVuY2luZy4KLy8KLy8gVGhpcyBzYW5kYm94aW5nIHRlY2huaXF1ZSBpcyBub3QgcGVyZmVjdCBhbmQgZG9lc24ndCBhaW0gdG8gYmUuIFRoZSBnb2FsIGlzIHRvIHByZXZlbnQgZXhwbG9pdHMKLy8gYWdhaW5zdCB0aGUgZXhwcmVzc2lvbiBsYW5ndWFnZSwgYnV0IG5vdCB0byBwcmV2ZW50IGV4cGxvaXRzIHRoYXQgd2VyZSBlbmFibGVkIGJ5IGV4cG9zaW5nCi8vIHNlbnNpdGl2ZSBKYXZhU2NyaXB0IG9yIGJyb3dzZXIgYXBpcyBvbiBTY29wZS4gRXhwb3Npbmcgc3VjaCBvYmplY3RzIG9uIGEgU2NvcGUgaXMgbmV2ZXIgYSBnb29kCi8vIHByYWN0aWNlIGFuZCB0aGVyZWZvcmUgd2UgYXJlIG5vdCBldmVuIHRyeWluZyB0byBwcm90ZWN0IGFnYWluc3QgaW50ZXJhY3Rpb24gd2l0aCBhbiBvYmplY3QKLy8gZXhwbGljaXRseSBleHBvc2VkIGluIHRoaXMgd2F5LgovLwovLyBBIGRldmVsb3BlciBjb3VsZCBmb2lsIHRoZSBuYW1lIGNoZWNrIGJ5IGFsaWFzaW5nIHRoZSBGdW5jdGlvbiBjb25zdHJ1Y3RvciB1bmRlciBhIGRpZmZlcmVudAovLyBuYW1lIG9uIHRoZSBzY29wZS4KLy8KLy8gSW4gZ2VuZXJhbCwgaXQgaXMgbm90IHBvc3NpYmxlIHRvIGFjY2VzcyBhIFdpbmRvdyBvYmplY3QgZnJvbSBhbiBhbmd1bGFyIGV4cHJlc3Npb24gdW5sZXNzIGEKLy8gd2luZG93IG9yIHNvbWUgRE9NIG9iamVjdCB0aGF0IGhhcyBhIHJlZmVyZW5jZSB0byB3aW5kb3cgaXMgcHVibGlzaGVkIG9udG8gYSBTY29wZS4KCiAgZnVuY3Rpb24gZW5zdXJlU2FmZU1lbWJlck5hbWUobmFtZSwgZnVsbEV4cHJlc3Npb24pIHsKICAgIGlmIChuYW1lID09PSAiY29uc3RydWN0b3IiKSB7CiAgICAgIHRocm93ICRwYXJzZU1pbkVycignaXNlY2ZsZCcsCiAgICAgICAgJ1JlZmVyZW5jaW5nICJjb25zdHJ1Y3RvciIgZmllbGQgaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLAogICAgICAgIGZ1bGxFeHByZXNzaW9uKTsKICAgIH0KICAgIHJldHVybiBuYW1lOwogIH0KCiAgZnVuY3Rpb24gZW5zdXJlU2FmZU9iamVjdChvYmosIGZ1bGxFeHByZXNzaW9uKSB7CiAgICAvLyBuaWZ0eSBjaGVjayBpZiBvYmogaXMgRnVuY3Rpb24gdGhhdCBpcyBmYXN0IGFuZCB3b3JrcyBhY3Jvc3MgaWZyYW1lcyBhbmQgb3RoZXIgY29udGV4dHMKICAgIGlmIChvYmopIHsKICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gb2JqKSB7CiAgICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2VjZm4nLAogICAgICAgICAgJ1JlZmVyZW5jaW5nIEZ1bmN0aW9uIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGlzYWxsb3dlZCEgRXhwcmVzc2lvbjogezB9JywKICAgICAgICAgIGZ1bGxFeHByZXNzaW9uKTsKICAgICAgfSBlbHNlIGlmICgvLyBpc1dpbmRvdyhvYmopCiAgICAgICAgb2JqLmRvY3VtZW50ICYmIG9iai5sb2NhdGlvbiAmJiBvYmouYWxlcnQgJiYgb2JqLnNldEludGVydmFsKSB7CiAgICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2Vjd2luZG93JywKICAgICAgICAgICdSZWZlcmVuY2luZyB0aGUgV2luZG93IGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGlzYWxsb3dlZCEgRXhwcmVzc2lvbjogezB9JywKICAgICAgICAgIGZ1bGxFeHByZXNzaW9uKTsKICAgICAgfSBlbHNlIGlmICgvLyBpc0VsZW1lbnQob2JqKQogICAgICAgIG9iai5jaGlsZHJlbiAmJiAob2JqLm5vZGVOYW1lIHx8IChvYmoucHJvcCAmJiBvYmouYXR0ciAmJiBvYmouZmluZCkpKSB7CiAgICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2VjZG9tJywKICAgICAgICAgICdSZWZlcmVuY2luZyBET00gbm9kZXMgaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLAogICAgICAgICAgZnVsbEV4cHJlc3Npb24pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gb2JqOwogIH0KCiAgdmFyIE9QRVJBVE9SUyA9IHsKICAgIC8qIGpzaGludCBiaXR3aXNlIDogZmFsc2UgKi8KICAgICdudWxsJzpmdW5jdGlvbigpe3JldHVybiBudWxsO30sCiAgICAndHJ1ZSc6ZnVuY3Rpb24oKXtyZXR1cm4gdHJ1ZTt9LAogICAgJ2ZhbHNlJzpmdW5jdGlvbigpe3JldHVybiBmYWxzZTt9LAogICAgdW5kZWZpbmVkOm5vb3AsCiAgICAnKyc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpewogICAgICBhPWEoc2VsZiwgbG9jYWxzKTsgYj1iKHNlbGYsIGxvY2Fscyk7CiAgICAgIGlmIChpc0RlZmluZWQoYSkpIHsKICAgICAgICBpZiAoaXNEZWZpbmVkKGIpKSB7CiAgICAgICAgICByZXR1cm4gYSArIGI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhOwogICAgICB9CiAgICAgIHJldHVybiBpc0RlZmluZWQoYik/Yjp1bmRlZmluZWQ7fSwKICAgICctJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7CiAgICAgIGE9YShzZWxmLCBsb2NhbHMpOyBiPWIoc2VsZiwgbG9jYWxzKTsKICAgICAgcmV0dXJuIChpc0RlZmluZWQoYSk/YTowKS0oaXNEZWZpbmVkKGIpP2I6MCk7CiAgICB9LAogICAgJyonOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpKmIoc2VsZiwgbG9jYWxzKTt9LAogICAgJy8nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpL2Ioc2VsZiwgbG9jYWxzKTt9LAogICAgJyUnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpJWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJ14nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpXmIoc2VsZiwgbG9jYWxzKTt9LAogICAgJz0nOm5vb3AsCiAgICAnPT09JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsIGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyk9PT1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICchPT0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSwgYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKSE9PWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJz09JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT09YihzZWxmLCBsb2NhbHMpO30sCiAgICAnIT0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpIT1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICc8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKTxiKHNlbGYsIGxvY2Fscyk7fSwKICAgICc+JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT5iKHNlbGYsIGxvY2Fscyk7fSwKICAgICc8PSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyk8PWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJz49JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT49YihzZWxmLCBsb2NhbHMpO30sCiAgICAnJiYnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpJiZiKHNlbGYsIGxvY2Fscyk7fSwKICAgICd8fCc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2Fscyl8fGIoc2VsZiwgbG9jYWxzKTt9LAogICAgJyYnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpJmIoc2VsZiwgbG9jYWxzKTt9LAovLyAgICAnfCc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhfGI7fSwKICAgICd8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGIoc2VsZiwgbG9jYWxzKShzZWxmLCBsb2NhbHMsIGEoc2VsZiwgbG9jYWxzKSk7fSwKICAgICchJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEpe3JldHVybiAhYShzZWxmLCBsb2NhbHMpO30KICB9OwogIC8qIGpzaGludCBiaXR3aXNlOiB0cnVlICovCiAgdmFyIEVTQ0FQRSA9IHsibiI6IlxuIiwgImYiOiJcZiIsICJyIjoiXHIiLCAidCI6Ilx0IiwgInYiOiJcdiIsICInIjoiJyIsICciJzonIid9OwoKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICB2YXIgTGV4ZXIgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICB9OwoKICBMZXhlci5wcm90b3R5cGUgPSB7CiAgICBjb25zdHJ1Y3RvcjogTGV4ZXIsCgogICAgbGV4OiBmdW5jdGlvbiAodGV4dCkgewogICAgICB0aGlzLnRleHQgPSB0ZXh0OwoKICAgICAgdGhpcy5pbmRleCA9IDA7CiAgICAgIHRoaXMuY2ggPSB1bmRlZmluZWQ7CiAgICAgIHRoaXMubGFzdENoID0gJzonOyAvLyBjYW4gc3RhcnQgcmVnZXhwCgogICAgICB0aGlzLnRva2VucyA9IFtdOwoKICAgICAgd2hpbGUgKHRoaXMuaW5kZXggPCB0aGlzLnRleHQubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5jaCA9IHRoaXMudGV4dC5jaGFyQXQodGhpcy5pbmRleCk7CiAgICAgICAgaWYgKHRoaXMuaXMoJyJcJycpKSB7CiAgICAgICAgICB0aGlzLnJlYWRTdHJpbmcodGhpcy5jaCk7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzTnVtYmVyKHRoaXMuY2gpIHx8IHRoaXMuaXMoJy4nKSAmJiB0aGlzLmlzTnVtYmVyKHRoaXMucGVlaygpKSkgewogICAgICAgICAgdGhpcy5yZWFkTnVtYmVyKCk7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzSWRlbnQodGhpcy5jaCkpIHsKICAgICAgICAgIHRoaXMucmVhZElkZW50KCk7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzKCcoKXt9W10uLDs6PycpKSB7CiAgICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgICAgICAgaW5kZXg6IHRoaXMuaW5kZXgsCiAgICAgICAgICAgIHRleHQ6IHRoaXMuY2gKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc1doaXRlc3BhY2UodGhpcy5jaCkpIHsKICAgICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgY2gyID0gdGhpcy5jaCArIHRoaXMucGVlaygpOwogICAgICAgICAgdmFyIGNoMyA9IGNoMiArIHRoaXMucGVlaygyKTsKICAgICAgICAgIHZhciBmbiA9IE9QRVJBVE9SU1t0aGlzLmNoXTsKICAgICAgICAgIHZhciBmbjIgPSBPUEVSQVRPUlNbY2gyXTsKICAgICAgICAgIHZhciBmbjMgPSBPUEVSQVRPUlNbY2gzXTsKICAgICAgICAgIGlmIChmbjMpIHsKICAgICAgICAgICAgdGhpcy50b2tlbnMucHVzaCh7aW5kZXg6IHRoaXMuaW5kZXgsIHRleHQ6IGNoMywgZm46IGZuM30pOwogICAgICAgICAgICB0aGlzLmluZGV4ICs9IDM7CiAgICAgICAgICB9IGVsc2UgaWYgKGZuMikgewogICAgICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHtpbmRleDogdGhpcy5pbmRleCwgdGV4dDogY2gyLCBmbjogZm4yfSk7CiAgICAgICAgICAgIHRoaXMuaW5kZXggKz0gMjsKICAgICAgICAgIH0gZWxzZSBpZiAoZm4pIHsKICAgICAgICAgICAgdGhpcy50b2tlbnMucHVzaCh7CiAgICAgICAgICAgICAgaW5kZXg6IHRoaXMuaW5kZXgsCiAgICAgICAgICAgICAgdGV4dDogdGhpcy5jaCwKICAgICAgICAgICAgICBmbjogZm4KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuaW5kZXggKz0gMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudGhyb3dFcnJvcignVW5leHBlY3RlZCBuZXh0IGNoYXJhY3RlciAnLCB0aGlzLmluZGV4LCB0aGlzLmluZGV4ICsgMSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMubGFzdENoID0gdGhpcy5jaDsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy50b2tlbnM7CiAgICB9LAoKICAgIGlzOiBmdW5jdGlvbihjaGFycykgewogICAgICByZXR1cm4gY2hhcnMuaW5kZXhPZih0aGlzLmNoKSAhPT0gLTE7CiAgICB9LAoKICAgIHdhczogZnVuY3Rpb24oY2hhcnMpIHsKICAgICAgcmV0dXJuIGNoYXJzLmluZGV4T2YodGhpcy5sYXN0Q2gpICE9PSAtMTsKICAgIH0sCgogICAgcGVlazogZnVuY3Rpb24oaSkgewogICAgICB2YXIgbnVtID0gaSB8fCAxOwogICAgICByZXR1cm4gKHRoaXMuaW5kZXggKyBudW0gPCB0aGlzLnRleHQubGVuZ3RoKSA/IHRoaXMudGV4dC5jaGFyQXQodGhpcy5pbmRleCArIG51bSkgOiBmYWxzZTsKICAgIH0sCgogICAgaXNOdW1iZXI6IGZ1bmN0aW9uKGNoKSB7CiAgICAgIHJldHVybiAoJzAnIDw9IGNoICYmIGNoIDw9ICc5Jyk7CiAgICB9LAoKICAgIGlzV2hpdGVzcGFjZTogZnVuY3Rpb24oY2gpIHsKICAgICAgLy8gSUUgdHJlYXRzIG5vbi1icmVha2luZyBzcGFjZSBhcyBcdTAwQTAKICAgICAgcmV0dXJuIChjaCA9PT0gJyAnIHx8IGNoID09PSAnXHInIHx8IGNoID09PSAnXHQnIHx8CiAgICAgICAgY2ggPT09ICdcbicgfHwgY2ggPT09ICdcdicgfHwgY2ggPT09ICdcdTAwQTAnKTsKICAgIH0sCgogICAgaXNJZGVudDogZnVuY3Rpb24oY2gpIHsKICAgICAgcmV0dXJuICgnYScgPD0gY2ggJiYgY2ggPD0gJ3onIHx8CiAgICAgICAgJ0EnIDw9IGNoICYmIGNoIDw9ICdaJyB8fAogICAgICAgICdfJyA9PT0gY2ggfHwgY2ggPT09ICckJyk7CiAgICB9LAoKICAgIGlzRXhwT3BlcmF0b3I6IGZ1bmN0aW9uKGNoKSB7CiAgICAgIHJldHVybiAoY2ggPT09ICctJyB8fCBjaCA9PT0gJysnIHx8IHRoaXMuaXNOdW1iZXIoY2gpKTsKICAgIH0sCgogICAgdGhyb3dFcnJvcjogZnVuY3Rpb24oZXJyb3IsIHN0YXJ0LCBlbmQpIHsKICAgICAgZW5kID0gZW5kIHx8IHRoaXMuaW5kZXg7CiAgICAgIHZhciBjb2xTdHIgPSAoaXNEZWZpbmVkKHN0YXJ0KQogICAgICAgID8gJ3MgJyArIHN0YXJ0ICsgICctJyArIHRoaXMuaW5kZXggKyAnIFsnICsgdGhpcy50ZXh0LnN1YnN0cmluZyhzdGFydCwgZW5kKSArICddJwogICAgICAgIDogJyAnICsgZW5kKTsKICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdsZXhlcnInLCAnTGV4ZXIgRXJyb3I6IHswfSBhdCBjb2x1bW57MX0gaW4gZXhwcmVzc2lvbiBbezJ9XS4nLAogICAgICAgIGVycm9yLCBjb2xTdHIsIHRoaXMudGV4dCk7CiAgICB9LAoKICAgIHJlYWROdW1iZXI6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgbnVtYmVyID0gJyc7CiAgICAgIHZhciBzdGFydCA9IHRoaXMuaW5kZXg7CiAgICAgIHdoaWxlICh0aGlzLmluZGV4IDwgdGhpcy50ZXh0Lmxlbmd0aCkgewogICAgICAgIHZhciBjaCA9IGxvd2VyY2FzZSh0aGlzLnRleHQuY2hhckF0KHRoaXMuaW5kZXgpKTsKICAgICAgICBpZiAoY2ggPT0gJy4nIHx8IHRoaXMuaXNOdW1iZXIoY2gpKSB7CiAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBwZWVrQ2ggPSB0aGlzLnBlZWsoKTsKICAgICAgICAgIGlmIChjaCA9PSAnZScgJiYgdGhpcy5pc0V4cE9wZXJhdG9yKHBlZWtDaCkpIHsKICAgICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRXhwT3BlcmF0b3IoY2gpICYmCiAgICAgICAgICAgIHBlZWtDaCAmJiB0aGlzLmlzTnVtYmVyKHBlZWtDaCkgJiYKICAgICAgICAgICAgbnVtYmVyLmNoYXJBdChudW1iZXIubGVuZ3RoIC0gMSkgPT0gJ2UnKSB7CiAgICAgICAgICAgIG51bWJlciArPSBjaDsKICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0V4cE9wZXJhdG9yKGNoKSAmJgogICAgICAgICAgICAoIXBlZWtDaCB8fCAhdGhpcy5pc051bWJlcihwZWVrQ2gpKSAmJgogICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdJbnZhbGlkIGV4cG9uZW50Jyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICB9CiAgICAgIG51bWJlciA9IDEgKiBudW1iZXI7CiAgICAgIHRoaXMudG9rZW5zLnB1c2goewogICAgICAgIGluZGV4OiBzdGFydCwKICAgICAgICB0ZXh0OiBudW1iZXIsCiAgICAgICAgbGl0ZXJhbDogdHJ1ZSwKICAgICAgICBjb25zdGFudDogdHJ1ZSwKICAgICAgICBmbjogZnVuY3Rpb24oKSB7IHJldHVybiBudW1iZXI7IH0KICAgICAgfSk7CiAgICB9LAoKICAgIHJlYWRJZGVudDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBwYXJzZXIgPSB0aGlzOwoKICAgICAgdmFyIGlkZW50ID0gJyc7CiAgICAgIHZhciBzdGFydCA9IHRoaXMuaW5kZXg7CgogICAgICB2YXIgbGFzdERvdCwgcGVla0luZGV4LCBtZXRob2ROYW1lLCBjaDsKCiAgICAgIHdoaWxlICh0aGlzLmluZGV4IDwgdGhpcy50ZXh0Lmxlbmd0aCkgewogICAgICAgIGNoID0gdGhpcy50ZXh0LmNoYXJBdCh0aGlzLmluZGV4KTsKICAgICAgICBpZiAoY2ggPT09ICcuJyB8fCB0aGlzLmlzSWRlbnQoY2gpIHx8IHRoaXMuaXNOdW1iZXIoY2gpKSB7CiAgICAgICAgICBpZiAoY2ggPT09ICcuJykgbGFzdERvdCA9IHRoaXMuaW5kZXg7CiAgICAgICAgICBpZGVudCArPSBjaDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgfQoKICAgICAgLy9jaGVjayBpZiB0aGlzIGlzIG5vdCBhIG1ldGhvZCBpbnZvY2F0aW9uIGFuZCBpZiBpdCBpcyBiYWNrIG91dCB0byBsYXN0IGRvdAogICAgICBpZiAobGFzdERvdCkgewogICAgICAgIHBlZWtJbmRleCA9IHRoaXMuaW5kZXg7CiAgICAgICAgd2hpbGUgKHBlZWtJbmRleCA8IHRoaXMudGV4dC5sZW5ndGgpIHsKICAgICAgICAgIGNoID0gdGhpcy50ZXh0LmNoYXJBdChwZWVrSW5kZXgpOwogICAgICAgICAgaWYgKGNoID09PSAnKCcpIHsKICAgICAgICAgICAgbWV0aG9kTmFtZSA9IGlkZW50LnN1YnN0cihsYXN0RG90IC0gc3RhcnQgKyAxKTsKICAgICAgICAgICAgaWRlbnQgPSBpZGVudC5zdWJzdHIoMCwgbGFzdERvdCAtIHN0YXJ0KTsKICAgICAgICAgICAgdGhpcy5pbmRleCA9IHBlZWtJbmRleDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5pc1doaXRlc3BhY2UoY2gpKSB7CiAgICAgICAgICAgIHBlZWtJbmRleCsrOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgoKICAgICAgdmFyIHRva2VuID0gewogICAgICAgIGluZGV4OiBzdGFydCwKICAgICAgICB0ZXh0OiBpZGVudAogICAgICB9OwoKICAgICAgLy8gT1BFUkFUT1JTIGlzIG91ciBvd24gb2JqZWN0IHNvIHdlIGRvbid0IG5lZWQgdG8gdXNlIHNwZWNpYWwgaGFzT3duUHJvcGVydHlGbgogICAgICBpZiAoT1BFUkFUT1JTLmhhc093blByb3BlcnR5KGlkZW50KSkgewogICAgICAgIHRva2VuLmZuID0gT1BFUkFUT1JTW2lkZW50XTsKICAgICAgICB0b2tlbi5saXRlcmFsID0gdHJ1ZTsKICAgICAgICB0b2tlbi5jb25zdGFudCA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGdldHRlciA9IGdldHRlckZuKGlkZW50LCB0aGlzLm9wdGlvbnMsIHRoaXMudGV4dCk7CiAgICAgICAgdG9rZW4uZm4gPSBleHRlbmQoZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICByZXR1cm4gKGdldHRlcihzZWxmLCBsb2NhbHMpKTsKICAgICAgICB9LCB7CiAgICAgICAgICBhc3NpZ246IGZ1bmN0aW9uKHNlbGYsIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBzZXR0ZXIoc2VsZiwgaWRlbnQsIHZhbHVlLCBwYXJzZXIudGV4dCwgcGFyc2VyLm9wdGlvbnMpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICB0aGlzLnRva2Vucy5wdXNoKHRva2VuKTsKCiAgICAgIGlmIChtZXRob2ROYW1lKSB7CiAgICAgICAgdGhpcy50b2tlbnMucHVzaCh7CiAgICAgICAgICBpbmRleDpsYXN0RG90LAogICAgICAgICAgdGV4dDogJy4nCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy50b2tlbnMucHVzaCh7CiAgICAgICAgICBpbmRleDogbGFzdERvdCArIDEsCiAgICAgICAgICB0ZXh0OiBtZXRob2ROYW1lCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgcmVhZFN0cmluZzogZnVuY3Rpb24ocXVvdGUpIHsKICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5pbmRleDsKICAgICAgdGhpcy5pbmRleCsrOwogICAgICB2YXIgc3RyaW5nID0gJyc7CiAgICAgIHZhciByYXdTdHJpbmcgPSBxdW90ZTsKICAgICAgdmFyIGVzY2FwZSA9IGZhbHNlOwogICAgICB3aGlsZSAodGhpcy5pbmRleCA8IHRoaXMudGV4dC5sZW5ndGgpIHsKICAgICAgICB2YXIgY2ggPSB0aGlzLnRleHQuY2hhckF0KHRoaXMuaW5kZXgpOwogICAgICAgIHJhd1N0cmluZyArPSBjaDsKICAgICAgICBpZiAoZXNjYXBlKSB7CiAgICAgICAgICBpZiAoY2ggPT09ICd1JykgewogICAgICAgICAgICB2YXIgaGV4ID0gdGhpcy50ZXh0LnN1YnN0cmluZyh0aGlzLmluZGV4ICsgMSwgdGhpcy5pbmRleCArIDUpOwogICAgICAgICAgICBpZiAoIWhleC5tYXRjaCgvW1xkYS1mXXs0fS9pKSkKICAgICAgICAgICAgICB0aGlzLnRocm93RXJyb3IoJ0ludmFsaWQgdW5pY29kZSBlc2NhcGUgW1xcdScgKyBoZXggKyAnXScpOwogICAgICAgICAgICB0aGlzLmluZGV4ICs9IDQ7CiAgICAgICAgICAgIHN0cmluZyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KGhleCwgMTYpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciByZXAgPSBFU0NBUEVbY2hdOwogICAgICAgICAgICBpZiAocmVwKSB7CiAgICAgICAgICAgICAgc3RyaW5nICs9IHJlcDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHJpbmcgKz0gY2g7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVzY2FwZSA9IGZhbHNlOwogICAgICAgIH0gZWxzZSBpZiAoY2ggPT09ICdcXCcpIHsKICAgICAgICAgIGVzY2FwZSA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gcXVvdGUpIHsKICAgICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgICAgIHRoaXMudG9rZW5zLnB1c2goewogICAgICAgICAgICBpbmRleDogc3RhcnQsCiAgICAgICAgICAgIHRleHQ6IHJhd1N0cmluZywKICAgICAgICAgICAgc3RyaW5nOiBzdHJpbmcsCiAgICAgICAgICAgIGxpdGVyYWw6IHRydWUsCiAgICAgICAgICAgIGNvbnN0YW50OiB0cnVlLAogICAgICAgICAgICBmbjogZnVuY3Rpb24oKSB7IHJldHVybiBzdHJpbmc7IH0KICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdHJpbmcgKz0gY2g7CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5kZXgrKzsKICAgICAgfQogICAgICB0aGlzLnRocm93RXJyb3IoJ1VudGVybWluYXRlZCBxdW90ZScsIHN0YXJ0KTsKICAgIH0KICB9OwoKCiAgLyoqCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgdmFyIFBhcnNlciA9IGZ1bmN0aW9uIChsZXhlciwgJGZpbHRlciwgb3B0aW9ucykgewogICAgdGhpcy5sZXhlciA9IGxleGVyOwogICAgdGhpcy4kZmlsdGVyID0gJGZpbHRlcjsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgfTsKCiAgUGFyc2VyLlpFUk8gPSBleHRlbmQoZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIDA7CiAgfSwgewogICAgY29uc3RhbnQ6IHRydWUKICB9KTsKCiAgUGFyc2VyLnByb3RvdHlwZSA9IHsKICAgIGNvbnN0cnVjdG9yOiBQYXJzZXIsCgogICAgcGFyc2U6IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgIHRoaXMudGV4dCA9IHRleHQ7CgogICAgICB0aGlzLnRva2VucyA9IHRoaXMubGV4ZXIubGV4KHRleHQpOwoKICAgICAgdmFyIHZhbHVlID0gdGhpcy5zdGF0ZW1lbnRzKCk7CgogICAgICBpZiAodGhpcy50b2tlbnMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdpcyBhbiB1bmV4cGVjdGVkIHRva2VuJywgdGhpcy50b2tlbnNbMF0pOwogICAgICB9CgogICAgICB2YWx1ZS5saXRlcmFsID0gISF2YWx1ZS5saXRlcmFsOwogICAgICB2YWx1ZS5jb25zdGFudCA9ICEhdmFsdWUuY29uc3RhbnQ7CgogICAgICByZXR1cm4gdmFsdWU7CiAgICB9LAoKICAgIHByaW1hcnk6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHByaW1hcnk7CiAgICAgIGlmICh0aGlzLmV4cGVjdCgnKCcpKSB7CiAgICAgICAgcHJpbWFyeSA9IHRoaXMuZmlsdGVyQ2hhaW4oKTsKICAgICAgICB0aGlzLmNvbnN1bWUoJyknKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLmV4cGVjdCgnWycpKSB7CiAgICAgICAgcHJpbWFyeSA9IHRoaXMuYXJyYXlEZWNsYXJhdGlvbigpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuZXhwZWN0KCd7JykpIHsKICAgICAgICBwcmltYXJ5ID0gdGhpcy5vYmplY3QoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgdG9rZW4gPSB0aGlzLmV4cGVjdCgpOwogICAgICAgIHByaW1hcnkgPSB0b2tlbi5mbjsKICAgICAgICBpZiAoIXByaW1hcnkpIHsKICAgICAgICAgIHRoaXMudGhyb3dFcnJvcignbm90IGEgcHJpbWFyeSBleHByZXNzaW9uJywgdG9rZW4pOwogICAgICAgIH0KICAgICAgICBwcmltYXJ5LmxpdGVyYWwgPSAhIXRva2VuLmxpdGVyYWw7CiAgICAgICAgcHJpbWFyeS5jb25zdGFudCA9ICEhdG9rZW4uY29uc3RhbnQ7CiAgICAgIH0KCiAgICAgIHZhciBuZXh0LCBjb250ZXh0OwogICAgICB3aGlsZSAoKG5leHQgPSB0aGlzLmV4cGVjdCgnKCcsICdbJywgJy4nKSkpIHsKICAgICAgICBpZiAobmV4dC50ZXh0ID09PSAnKCcpIHsKICAgICAgICAgIHByaW1hcnkgPSB0aGlzLmZ1bmN0aW9uQ2FsbChwcmltYXJ5LCBjb250ZXh0KTsKICAgICAgICAgIGNvbnRleHQgPSBudWxsOwogICAgICAgIH0gZWxzZSBpZiAobmV4dC50ZXh0ID09PSAnWycpIHsKICAgICAgICAgIGNvbnRleHQgPSBwcmltYXJ5OwogICAgICAgICAgcHJpbWFyeSA9IHRoaXMub2JqZWN0SW5kZXgocHJpbWFyeSk7CiAgICAgICAgfSBlbHNlIGlmIChuZXh0LnRleHQgPT09ICcuJykgewogICAgICAgICAgY29udGV4dCA9IHByaW1hcnk7CiAgICAgICAgICBwcmltYXJ5ID0gdGhpcy5maWVsZEFjY2VzcyhwcmltYXJ5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdJTVBPU1NJQkxFJyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBwcmltYXJ5OwogICAgfSwKCiAgICB0aHJvd0Vycm9yOiBmdW5jdGlvbihtc2csIHRva2VuKSB7CiAgICAgIHRocm93ICRwYXJzZU1pbkVycignc3ludGF4JywKICAgICAgICAnU3ludGF4IEVycm9yOiBUb2tlbiBcJ3swfVwnIHsxfSBhdCBjb2x1bW4gezJ9IG9mIHRoZSBleHByZXNzaW9uIFt7M31dIHN0YXJ0aW5nIGF0IFt7NH1dLicsCiAgICAgICAgdG9rZW4udGV4dCwgbXNnLCAodG9rZW4uaW5kZXggKyAxKSwgdGhpcy50ZXh0LCB0aGlzLnRleHQuc3Vic3RyaW5nKHRva2VuLmluZGV4KSk7CiAgICB9LAoKICAgIHBlZWtUb2tlbjogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLnRva2Vucy5sZW5ndGggPT09IDApCiAgICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCd1ZW9lJywgJ1VuZXhwZWN0ZWQgZW5kIG9mIGV4cHJlc3Npb246IHswfScsIHRoaXMudGV4dCk7CiAgICAgIHJldHVybiB0aGlzLnRva2Vuc1swXTsKICAgIH0sCgogICAgcGVlazogZnVuY3Rpb24oZTEsIGUyLCBlMywgZTQpIHsKICAgICAgaWYgKHRoaXMudG9rZW5zLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgdG9rZW4gPSB0aGlzLnRva2Vuc1swXTsKICAgICAgICB2YXIgdCA9IHRva2VuLnRleHQ7CiAgICAgICAgaWYgKHQgPT09IGUxIHx8IHQgPT09IGUyIHx8IHQgPT09IGUzIHx8IHQgPT09IGU0IHx8CiAgICAgICAgICAoIWUxICYmICFlMiAmJiAhZTMgJiYgIWU0KSkgewogICAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIGV4cGVjdDogZnVuY3Rpb24oZTEsIGUyLCBlMywgZTQpewogICAgICB2YXIgdG9rZW4gPSB0aGlzLnBlZWsoZTEsIGUyLCBlMywgZTQpOwogICAgICBpZiAodG9rZW4pIHsKICAgICAgICB0aGlzLnRva2Vucy5zaGlmdCgpOwogICAgICAgIHJldHVybiB0b2tlbjsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIGNvbnN1bWU6IGZ1bmN0aW9uKGUxKXsKICAgICAgaWYgKCF0aGlzLmV4cGVjdChlMSkpIHsKICAgICAgICB0aGlzLnRocm93RXJyb3IoJ2lzIHVuZXhwZWN0ZWQsIGV4cGVjdGluZyBbJyArIGUxICsgJ10nLCB0aGlzLnBlZWsoKSk7CiAgICAgIH0KICAgIH0sCgogICAgdW5hcnlGbjogZnVuY3Rpb24oZm4sIHJpZ2h0KSB7CiAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgcmV0dXJuIGZuKHNlbGYsIGxvY2FscywgcmlnaHQpOwogICAgICB9LCB7CiAgICAgICAgY29uc3RhbnQ6cmlnaHQuY29uc3RhbnQKICAgICAgfSk7CiAgICB9LAoKICAgIHRlcm5hcnlGbjogZnVuY3Rpb24obGVmdCwgbWlkZGxlLCByaWdodCl7CiAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oc2VsZiwgbG9jYWxzKXsKICAgICAgICByZXR1cm4gbGVmdChzZWxmLCBsb2NhbHMpID8gbWlkZGxlKHNlbGYsIGxvY2FscykgOiByaWdodChzZWxmLCBsb2NhbHMpOwogICAgICB9LCB7CiAgICAgICAgY29uc3RhbnQ6IGxlZnQuY29uc3RhbnQgJiYgbWlkZGxlLmNvbnN0YW50ICYmIHJpZ2h0LmNvbnN0YW50CiAgICAgIH0pOwogICAgfSwKCiAgICBiaW5hcnlGbjogZnVuY3Rpb24obGVmdCwgZm4sIHJpZ2h0KSB7CiAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgcmV0dXJuIGZuKHNlbGYsIGxvY2FscywgbGVmdCwgcmlnaHQpOwogICAgICB9LCB7CiAgICAgICAgY29uc3RhbnQ6bGVmdC5jb25zdGFudCAmJiByaWdodC5jb25zdGFudAogICAgICB9KTsKICAgIH0sCgogICAgc3RhdGVtZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzdGF0ZW1lbnRzID0gW107CiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgaWYgKHRoaXMudG9rZW5zLmxlbmd0aCA+IDAgJiYgIXRoaXMucGVlaygnfScsICcpJywgJzsnLCAnXScpKQogICAgICAgICAgc3RhdGVtZW50cy5wdXNoKHRoaXMuZmlsdGVyQ2hhaW4oKSk7CiAgICAgICAgaWYgKCF0aGlzLmV4cGVjdCgnOycpKSB7CiAgICAgICAgICAvLyBvcHRpbWl6ZSBmb3IgdGhlIGNvbW1vbiBjYXNlIHdoZXJlIHRoZXJlIGlzIG9ubHkgb25lIHN0YXRlbWVudC4KICAgICAgICAgIC8vIFRPRE8oc2l6ZSk6IG1heWJlIHdlIHNob3VsZCBub3Qgc3VwcG9ydCBtdWx0aXBsZSBzdGF0ZW1lbnRzPwogICAgICAgICAgcmV0dXJuIChzdGF0ZW1lbnRzLmxlbmd0aCA9PT0gMSkKICAgICAgICAgICAgPyBzdGF0ZW1lbnRzWzBdCiAgICAgICAgICAgIDogZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGF0ZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07CiAgICAgICAgICAgICAgaWYgKHN0YXRlbWVudCkgewogICAgICAgICAgICAgICAgdmFsdWUgPSBzdGF0ZW1lbnQoc2VsZiwgbG9jYWxzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgZmlsdGVyQ2hhaW46IGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGVmdCA9IHRoaXMuZXhwcmVzc2lvbigpOwogICAgICB2YXIgdG9rZW47CiAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCd8JykpKSB7CiAgICAgICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy5maWx0ZXIoKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBmaWx0ZXI6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdG9rZW4gPSB0aGlzLmV4cGVjdCgpOwogICAgICB2YXIgZm4gPSB0aGlzLiRmaWx0ZXIodG9rZW4udGV4dCk7CiAgICAgIHZhciBhcmdzRm4gPSBbXTsKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJzonKSkpIHsKICAgICAgICAgIGFyZ3NGbi5wdXNoKHRoaXMuZXhwcmVzc2lvbigpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGZuSW52b2tlID0gZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBpbnB1dCkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtpbnB1dF07CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnc0ZuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgYXJncy5wdXNoKGFyZ3NGbltpXShzZWxmLCBsb2NhbHMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkoc2VsZiwgYXJncyk7CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZm5JbnZva2U7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBleHByZXNzaW9uOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuYXNzaWdubWVudCgpOwogICAgfSwKCiAgICBhc3NpZ25tZW50OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGxlZnQgPSB0aGlzLnRlcm5hcnkoKTsKICAgICAgdmFyIHJpZ2h0OwogICAgICB2YXIgdG9rZW47CiAgICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnPScpKSkgewogICAgICAgIGlmICghbGVmdC5hc3NpZ24pIHsKICAgICAgICAgIHRoaXMudGhyb3dFcnJvcignaW1wbGllcyBhc3NpZ25tZW50IGJ1dCBbJyArCiAgICAgICAgICAgIHRoaXMudGV4dC5zdWJzdHJpbmcoMCwgdG9rZW4uaW5kZXgpICsgJ10gY2FuIG5vdCBiZSBhc3NpZ25lZCB0bycsIHRva2VuKTsKICAgICAgICB9CiAgICAgICAgcmlnaHQgPSB0aGlzLnRlcm5hcnkoKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGxvY2FscykgewogICAgICAgICAgcmV0dXJuIGxlZnQuYXNzaWduKHNjb3BlLCByaWdodChzY29wZSwgbG9jYWxzKSwgbG9jYWxzKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiBsZWZ0OwogICAgfSwKCiAgICB0ZXJuYXJ5OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGxlZnQgPSB0aGlzLmxvZ2ljYWxPUigpOwogICAgICB2YXIgbWlkZGxlOwogICAgICB2YXIgdG9rZW47CiAgICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnPycpKSkgewogICAgICAgIG1pZGRsZSA9IHRoaXMudGVybmFyeSgpOwogICAgICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnOicpKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMudGVybmFyeUZuKGxlZnQsIG1pZGRsZSwgdGhpcy50ZXJuYXJ5KCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnRocm93RXJyb3IoJ2V4cGVjdGVkIDonLCB0b2tlbik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBsZWZ0OwogICAgICB9CiAgICB9LAoKICAgIGxvZ2ljYWxPUjogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsZWZ0ID0gdGhpcy5sb2dpY2FsQU5EKCk7CiAgICAgIHZhciB0b2tlbjsKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJ3x8JykpKSB7CiAgICAgICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy5sb2dpY2FsQU5EKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbGVmdDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgbG9naWNhbEFORDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsZWZ0ID0gdGhpcy5lcXVhbGl0eSgpOwogICAgICB2YXIgdG9rZW47CiAgICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnJiYnKSkpIHsKICAgICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy5sb2dpY2FsQU5EKCkpOwogICAgICB9CiAgICAgIHJldHVybiBsZWZ0OwogICAgfSwKCiAgICBlcXVhbGl0eTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsZWZ0ID0gdGhpcy5yZWxhdGlvbmFsKCk7CiAgICAgIHZhciB0b2tlbjsKICAgICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCc9PScsJyE9JywnPT09JywnIT09JykpKSB7CiAgICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMuZXF1YWxpdHkoKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQ7CiAgICB9LAoKICAgIHJlbGF0aW9uYWw6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGVmdCA9IHRoaXMuYWRkaXRpdmUoKTsKICAgICAgdmFyIHRva2VuOwogICAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJzwnLCAnPicsICc8PScsICc+PScpKSkgewogICAgICAgIGxlZnQgPSB0aGlzLmJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCB0aGlzLnJlbGF0aW9uYWwoKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQ7CiAgICB9LAoKICAgIGFkZGl0aXZlOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGxlZnQgPSB0aGlzLm11bHRpcGxpY2F0aXZlKCk7CiAgICAgIHZhciB0b2tlbjsKICAgICAgd2hpbGUgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCcrJywnLScpKSkgewogICAgICAgIGxlZnQgPSB0aGlzLmJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCB0aGlzLm11bHRpcGxpY2F0aXZlKCkpOwogICAgICB9CiAgICAgIHJldHVybiBsZWZ0OwogICAgfSwKCiAgICBtdWx0aXBsaWNhdGl2ZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsZWZ0ID0gdGhpcy51bmFyeSgpOwogICAgICB2YXIgdG9rZW47CiAgICAgIHdoaWxlICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnKicsJy8nLCclJykpKSB7CiAgICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMudW5hcnkoKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQ7CiAgICB9LAoKICAgIHVuYXJ5OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRva2VuOwogICAgICBpZiAodGhpcy5leHBlY3QoJysnKSkgewogICAgICAgIHJldHVybiB0aGlzLnByaW1hcnkoKTsKICAgICAgfSBlbHNlIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnLScpKSkgewogICAgICAgIHJldHVybiB0aGlzLmJpbmFyeUZuKFBhcnNlci5aRVJPLCB0b2tlbi5mbiwgdGhpcy51bmFyeSgpKTsKICAgICAgfSBlbHNlIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnIScpKSkgewogICAgICAgIHJldHVybiB0aGlzLnVuYXJ5Rm4odG9rZW4uZm4sIHRoaXMudW5hcnkoKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMucHJpbWFyeSgpOwogICAgICB9CiAgICB9LAoKICAgIGZpZWxkQWNjZXNzOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgdmFyIHBhcnNlciA9IHRoaXM7CiAgICAgIHZhciBmaWVsZCA9IHRoaXMuZXhwZWN0KCkudGV4dDsKICAgICAgdmFyIGdldHRlciA9IGdldHRlckZuKGZpZWxkLCB0aGlzLm9wdGlvbnMsIHRoaXMudGV4dCk7CgogICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uKHNjb3BlLCBsb2NhbHMsIHNlbGYpIHsKICAgICAgICByZXR1cm4gZ2V0dGVyKHNlbGYgfHwgb2JqZWN0KHNjb3BlLCBsb2NhbHMpKTsKICAgICAgfSwgewogICAgICAgIGFzc2lnbjogZnVuY3Rpb24oc2NvcGUsIHZhbHVlLCBsb2NhbHMpIHsKICAgICAgICAgIHJldHVybiBzZXR0ZXIob2JqZWN0KHNjb3BlLCBsb2NhbHMpLCBmaWVsZCwgdmFsdWUsIHBhcnNlci50ZXh0LCBwYXJzZXIub3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgb2JqZWN0SW5kZXg6IGZ1bmN0aW9uKG9iaikgewogICAgICB2YXIgcGFyc2VyID0gdGhpczsKCiAgICAgIHZhciBpbmRleEZuID0gdGhpcy5leHByZXNzaW9uKCk7CiAgICAgIHRoaXMuY29uc3VtZSgnXScpOwoKICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbihzZWxmLCBsb2NhbHMpIHsKICAgICAgICB2YXIgbyA9IG9iaihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgaSA9IGluZGV4Rm4oc2VsZiwgbG9jYWxzKSwKICAgICAgICAgIHYsIHA7CgogICAgICAgIGlmICghbykgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB2ID0gZW5zdXJlU2FmZU9iamVjdChvW2ldLCBwYXJzZXIudGV4dCk7CiAgICAgICAgaWYgKHYgJiYgdi50aGVuICYmIHBhcnNlci5vcHRpb25zLnVud3JhcFByb21pc2VzKSB7CiAgICAgICAgICBwID0gdjsKICAgICAgICAgIGlmICghKCckJHYnIGluIHYpKSB7CiAgICAgICAgICAgIHAuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgICBwLnRoZW4oZnVuY3Rpb24odmFsKSB7IHAuJCR2ID0gdmFsOyB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHYgPSB2LiQkdjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHY7CiAgICAgIH0sIHsKICAgICAgICBhc3NpZ246IGZ1bmN0aW9uKHNlbGYsIHZhbHVlLCBsb2NhbHMpIHsKICAgICAgICAgIHZhciBrZXkgPSBpbmRleEZuKHNlbGYsIGxvY2Fscyk7CiAgICAgICAgICAvLyBwcmV2ZW50IG92ZXJ3cml0aW5nIG9mIEZ1bmN0aW9uLmNvbnN0cnVjdG9yIHdoaWNoIHdvdWxkIGJyZWFrIGVuc3VyZVNhZmVPYmplY3QgY2hlY2sKICAgICAgICAgIHZhciBzYWZlID0gZW5zdXJlU2FmZU9iamVjdChvYmooc2VsZiwgbG9jYWxzKSwgcGFyc2VyLnRleHQpOwogICAgICAgICAgcmV0dXJuIHNhZmVba2V5XSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIGZ1bmN0aW9uQ2FsbDogZnVuY3Rpb24oZm4sIGNvbnRleHRHZXR0ZXIpIHsKICAgICAgdmFyIGFyZ3NGbiA9IFtdOwogICAgICBpZiAodGhpcy5wZWVrVG9rZW4oKS50ZXh0ICE9PSAnKScpIHsKICAgICAgICBkbyB7CiAgICAgICAgICBhcmdzRm4ucHVzaCh0aGlzLmV4cHJlc3Npb24oKSk7CiAgICAgICAgfSB3aGlsZSAodGhpcy5leHBlY3QoJywnKSk7CiAgICAgIH0KICAgICAgdGhpcy5jb25zdW1lKCcpJyk7CgogICAgICB2YXIgcGFyc2VyID0gdGhpczsKCiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICB2YXIgY29udGV4dCA9IGNvbnRleHRHZXR0ZXIgPyBjb250ZXh0R2V0dGVyKHNjb3BlLCBsb2NhbHMpIDogc2NvcGU7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJnc0ZuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBhcmdzLnB1c2goYXJnc0ZuW2ldKHNjb3BlLCBsb2NhbHMpKTsKICAgICAgICB9CiAgICAgICAgdmFyIGZuUHRyID0gZm4oc2NvcGUsIGxvY2FscywgY29udGV4dCkgfHwgbm9vcDsKCiAgICAgICAgZW5zdXJlU2FmZU9iamVjdChjb250ZXh0LCBwYXJzZXIudGV4dCk7CiAgICAgICAgZW5zdXJlU2FmZU9iamVjdChmblB0ciwgcGFyc2VyLnRleHQpOwoKICAgICAgICAvLyBJRSBzdHVwaWRpdHkhIChJRSBkb2Vzbid0IGhhdmUgYXBwbHkgZm9yIHNvbWUgbmF0aXZlIGZ1bmN0aW9ucykKICAgICAgICB2YXIgdiA9IGZuUHRyLmFwcGx5CiAgICAgICAgICA/IGZuUHRyLmFwcGx5KGNvbnRleHQsIGFyZ3MpCiAgICAgICAgICA6IGZuUHRyKGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0sIGFyZ3NbM10sIGFyZ3NbNF0pOwoKICAgICAgICByZXR1cm4gZW5zdXJlU2FmZU9iamVjdCh2LCBwYXJzZXIudGV4dCk7CiAgICAgIH07CiAgICB9LAoKICAgIC8vIFRoaXMgaXMgdXNlZCB3aXRoIGpzb24gYXJyYXkgZGVjbGFyYXRpb24KICAgIGFycmF5RGVjbGFyYXRpb246IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGVsZW1lbnRGbnMgPSBbXTsKICAgICAgdmFyIGFsbENvbnN0YW50ID0gdHJ1ZTsKICAgICAgaWYgKHRoaXMucGVla1Rva2VuKCkudGV4dCAhPT0gJ10nKSB7CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKHRoaXMucGVlaygnXScpKSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQgdHJhaWxpbmcgY29tbWFzIHBlciBFUzUuMS4KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudEZuID0gdGhpcy5leHByZXNzaW9uKCk7CiAgICAgICAgICBlbGVtZW50Rm5zLnB1c2goZWxlbWVudEZuKTsKICAgICAgICAgIGlmICghZWxlbWVudEZuLmNvbnN0YW50KSB7CiAgICAgICAgICAgIGFsbENvbnN0YW50ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSB3aGlsZSAodGhpcy5leHBlY3QoJywnKSk7CiAgICAgIH0KICAgICAgdGhpcy5jb25zdW1lKCddJyk7CgogICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudEZucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgYXJyYXkucHVzaChlbGVtZW50Rm5zW2ldKHNlbGYsIGxvY2FscykpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH0sIHsKICAgICAgICBsaXRlcmFsOiB0cnVlLAogICAgICAgIGNvbnN0YW50OiBhbGxDb25zdGFudAogICAgICB9KTsKICAgIH0sCgogICAgb2JqZWN0OiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBrZXlWYWx1ZXMgPSBbXTsKICAgICAgdmFyIGFsbENvbnN0YW50ID0gdHJ1ZTsKICAgICAgaWYgKHRoaXMucGVla1Rva2VuKCkudGV4dCAhPT0gJ30nKSB7CiAgICAgICAgZG8gewogICAgICAgICAgaWYgKHRoaXMucGVlaygnfScpKSB7CiAgICAgICAgICAgIC8vIFN1cHBvcnQgdHJhaWxpbmcgY29tbWFzIHBlciBFUzUuMS4KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdG9rZW4gPSB0aGlzLmV4cGVjdCgpLAogICAgICAgICAgICBrZXkgPSB0b2tlbi5zdHJpbmcgfHwgdG9rZW4udGV4dDsKICAgICAgICAgIHRoaXMuY29uc3VtZSgnOicpOwogICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5leHByZXNzaW9uKCk7CiAgICAgICAgICBrZXlWYWx1ZXMucHVzaCh7a2V5OiBrZXksIHZhbHVlOiB2YWx1ZX0pOwogICAgICAgICAgaWYgKCF2YWx1ZS5jb25zdGFudCkgewogICAgICAgICAgICBhbGxDb25zdGFudCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0gd2hpbGUgKHRoaXMuZXhwZWN0KCcsJykpOwogICAgICB9CiAgICAgIHRoaXMuY29uc3VtZSgnfScpOwoKICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbihzZWxmLCBsb2NhbHMpIHsKICAgICAgICB2YXIgb2JqZWN0ID0ge307CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBrZXlWYWx1ZSA9IGtleVZhbHVlc1tpXTsKICAgICAgICAgIG9iamVjdFtrZXlWYWx1ZS5rZXldID0ga2V5VmFsdWUudmFsdWUoc2VsZiwgbG9jYWxzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgfSwgewogICAgICAgIGxpdGVyYWw6IHRydWUsCiAgICAgICAgY29uc3RhbnQ6IGFsbENvbnN0YW50CiAgICAgIH0pOwogICAgfQogIH07CgoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gUGFyc2VyIGhlbHBlciBmdW5jdGlvbnMKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgZnVuY3Rpb24gc2V0dGVyKG9iaiwgcGF0aCwgc2V0VmFsdWUsIGZ1bGxFeHAsIG9wdGlvbnMpIHsKICAgIC8vbmVlZGVkPwogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgdmFyIGVsZW1lbnQgPSBwYXRoLnNwbGl0KCcuJyksIGtleTsKICAgIGZvciAodmFyIGkgPSAwOyBlbGVtZW50Lmxlbmd0aCA+IDE7IGkrKykgewogICAgICBrZXkgPSBlbnN1cmVTYWZlTWVtYmVyTmFtZShlbGVtZW50LnNoaWZ0KCksIGZ1bGxFeHApOwogICAgICB2YXIgcHJvcGVydHlPYmogPSBvYmpba2V5XTsKICAgICAgaWYgKCFwcm9wZXJ0eU9iaikgewogICAgICAgIHByb3BlcnR5T2JqID0ge307CiAgICAgICAgb2JqW2tleV0gPSBwcm9wZXJ0eU9iajsKICAgICAgfQogICAgICBvYmogPSBwcm9wZXJ0eU9iajsKICAgICAgaWYgKG9iai50aGVuICYmIG9wdGlvbnMudW53cmFwUHJvbWlzZXMpIHsKICAgICAgICBwcm9taXNlV2FybmluZyhmdWxsRXhwKTsKICAgICAgICBpZiAoISgiJCR2IiBpbiBvYmopKSB7CiAgICAgICAgICAoZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsKSB7IHByb21pc2UuJCR2ID0gdmFsOyB9KTsgfQogICAgICAgICAgICApKG9iaik7CiAgICAgICAgfQogICAgICAgIGlmIChvYmouJCR2ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIG9iai4kJHYgPSB7fTsKICAgICAgICB9CiAgICAgICAgb2JqID0gb2JqLiQkdjsKICAgICAgfQogICAgfQogICAga2V5ID0gZW5zdXJlU2FmZU1lbWJlck5hbWUoZWxlbWVudC5zaGlmdCgpLCBmdWxsRXhwKTsKICAgIG9ialtrZXldID0gc2V0VmFsdWU7CiAgICByZXR1cm4gc2V0VmFsdWU7CiAgfQoKICB2YXIgZ2V0dGVyRm5DYWNoZSA9IHt9OwoKICAvKioKICAgKiBJbXBsZW1lbnRhdGlvbiBvZiB0aGUgIkJsYWNrIEhvbGUiIHZhcmlhbnQgZnJvbToKICAgKiAtIGh0dHA6Ly9qc3BlcmYuY29tL2FuZ3VsYXJqcy1wYXJzZS1nZXR0ZXIvNAogICAqIC0gaHR0cDovL2pzcGVyZi5jb20vcGF0aC1ldmFsdWF0aW9uLXNpbXBsaWZpZWQvNwogICAqLwogIGZ1bmN0aW9uIGNzcFNhZmVHZXR0ZXJGbihrZXkwLCBrZXkxLCBrZXkyLCBrZXkzLCBrZXk0LCBmdWxsRXhwLCBvcHRpb25zKSB7CiAgICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXkwLCBmdWxsRXhwKTsKICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTEsIGZ1bGxFeHApOwogICAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MiwgZnVsbEV4cCk7CiAgICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXkzLCBmdWxsRXhwKTsKICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTQsIGZ1bGxFeHApOwoKICAgIHJldHVybiAhb3B0aW9ucy51bndyYXBQcm9taXNlcwogICAgICA/IGZ1bmN0aW9uIGNzcFNhZmVHZXR0ZXIoc2NvcGUsIGxvY2FscykgewogICAgICB2YXIgcGF0aFZhbCA9IChsb2NhbHMgJiYgbG9jYWxzLmhhc093blByb3BlcnR5KGtleTApKSA/IGxvY2FscyA6IHNjb3BlOwoKICAgICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHBhdGhWYWw7CiAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTBdOwoKICAgICAgaWYgKCFrZXkxKSByZXR1cm4gcGF0aFZhbDsKICAgICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5MV07CgogICAgICBpZiAoIWtleTIpIHJldHVybiBwYXRoVmFsOwogICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkyXTsKCiAgICAgIGlmICgha2V5MykgcmV0dXJuIHBhdGhWYWw7CiAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTNdOwoKICAgICAgaWYgKCFrZXk0KSByZXR1cm4gcGF0aFZhbDsKICAgICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5NF07CgogICAgICByZXR1cm4gcGF0aFZhbDsKICAgIH0KICAgICAgOiBmdW5jdGlvbiBjc3BTYWZlUHJvbWlzZUVuYWJsZWRHZXR0ZXIoc2NvcGUsIGxvY2FscykgewogICAgICB2YXIgcGF0aFZhbCA9IChsb2NhbHMgJiYgbG9jYWxzLmhhc093blByb3BlcnR5KGtleTApKSA/IGxvY2FscyA6IHNjb3BlLAogICAgICAgIHByb21pc2U7CgogICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gcGF0aFZhbDsKCiAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTBdOwogICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICBwcm9taXNlV2FybmluZyhmdWxsRXhwKTsKICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWwpIHsgcHJvbWlzZS4kJHYgPSB2YWw7IH0pOwogICAgICAgIH0KICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgIH0KCiAgICAgIGlmICgha2V5MSkgcmV0dXJuIHBhdGhWYWw7CiAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTFdOwogICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICBwcm9taXNlV2FybmluZyhmdWxsRXhwKTsKICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWwpIHsgcHJvbWlzZS4kJHYgPSB2YWw7IH0pOwogICAgICAgIH0KICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgIH0KCiAgICAgIGlmICgha2V5MikgcmV0dXJuIHBhdGhWYWw7CiAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTJdOwogICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICBwcm9taXNlV2FybmluZyhmdWxsRXhwKTsKICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWwpIHsgcHJvbWlzZS4kJHYgPSB2YWw7IH0pOwogICAgICAgIH0KICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgIH0KCiAgICAgIGlmICgha2V5MykgcmV0dXJuIHBhdGhWYWw7CiAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTNdOwogICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICBwcm9taXNlV2FybmluZyhmdWxsRXhwKTsKICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWwpIHsgcHJvbWlzZS4kJHYgPSB2YWw7IH0pOwogICAgICAgIH0KICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgIH0KCiAgICAgIGlmICgha2V5NCkgcmV0dXJuIHBhdGhWYWw7CiAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTRdOwogICAgICBpZiAocGF0aFZhbCAmJiBwYXRoVmFsLnRoZW4pIHsKICAgICAgICBwcm9taXNlV2FybmluZyhmdWxsRXhwKTsKICAgICAgICBpZiAoISgiJCR2IiBpbiBwYXRoVmFsKSkgewogICAgICAgICAgcHJvbWlzZSA9IHBhdGhWYWw7CiAgICAgICAgICBwcm9taXNlLiQkdiA9IHVuZGVmaW5lZDsKICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWwpIHsgcHJvbWlzZS4kJHYgPSB2YWw7IH0pOwogICAgICAgIH0KICAgICAgICBwYXRoVmFsID0gcGF0aFZhbC4kJHY7CiAgICAgIH0KICAgICAgcmV0dXJuIHBhdGhWYWw7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gc2ltcGxlR2V0dGVyRm4xKGtleTAsIGZ1bGxFeHApIHsKICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTAsIGZ1bGxFeHApOwoKICAgIHJldHVybiBmdW5jdGlvbiBzaW1wbGVHZXR0ZXJGbjEoc2NvcGUsIGxvY2FscykgewogICAgICBpZiAoc2NvcGUgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgcmV0dXJuICgobG9jYWxzICYmIGxvY2Fscy5oYXNPd25Qcm9wZXJ0eShrZXkwKSkgPyBsb2NhbHMgOiBzY29wZSlba2V5MF07CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gc2ltcGxlR2V0dGVyRm4yKGtleTAsIGtleTEsIGZ1bGxFeHApIHsKICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTAsIGZ1bGxFeHApOwogICAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MSwgZnVsbEV4cCk7CgogICAgcmV0dXJuIGZ1bmN0aW9uIHNpbXBsZUdldHRlckZuMihzY29wZSwgbG9jYWxzKSB7CiAgICAgIGlmIChzY29wZSA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICBzY29wZSA9ICgobG9jYWxzICYmIGxvY2Fscy5oYXNPd25Qcm9wZXJ0eShrZXkwKSkgPyBsb2NhbHMgOiBzY29wZSlba2V5MF07CiAgICAgIHJldHVybiBzY29wZSA9PSBudWxsID8gdW5kZWZpbmVkIDogc2NvcGVba2V5MV07CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZ2V0dGVyRm4ocGF0aCwgb3B0aW9ucywgZnVsbEV4cCkgewogICAgLy8gQ2hlY2sgd2hldGhlciB0aGUgY2FjaGUgaGFzIHRoaXMgZ2V0dGVyIGFscmVhZHkuCiAgICAvLyBXZSBjYW4gdXNlIGhhc093blByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBjYWNoZSBiZWNhdXNlIHdlIGVuc3VyZSwKICAgIC8vIHNlZSBiZWxvdywgdGhhdCB0aGUgY2FjaGUgbmV2ZXIgc3RvcmVzIGEgcGF0aCBjYWxsZWQgJ2hhc093blByb3BlcnR5JwogICAgaWYgKGdldHRlckZuQ2FjaGUuaGFzT3duUHJvcGVydHkocGF0aCkpIHsKICAgICAgcmV0dXJuIGdldHRlckZuQ2FjaGVbcGF0aF07CiAgICB9CgogICAgdmFyIHBhdGhLZXlzID0gcGF0aC5zcGxpdCgnLicpLAogICAgICBwYXRoS2V5c0xlbmd0aCA9IHBhdGhLZXlzLmxlbmd0aCwKICAgICAgZm47CgogICAgLy8gV2hlbiB3ZSBoYXZlIG9ubHkgMSBvciAyIHRva2VucywgdXNlIG9wdGltaXplZCBzcGVjaWFsIGNhc2UgY2xvc3VyZXMuCiAgICAvLyBodHRwOi8vanNwZXJmLmNvbS9hbmd1bGFyanMtcGFyc2UtZ2V0dGVyLzYKICAgIGlmICghb3B0aW9ucy51bndyYXBQcm9taXNlcyAmJiBwYXRoS2V5c0xlbmd0aCA9PT0gMSkgewogICAgICBmbiA9IHNpbXBsZUdldHRlckZuMShwYXRoS2V5c1swXSwgZnVsbEV4cCk7CiAgICB9IGVsc2UgaWYgKCFvcHRpb25zLnVud3JhcFByb21pc2VzICYmIHBhdGhLZXlzTGVuZ3RoID09PSAyKSB7CiAgICAgIGZuID0gc2ltcGxlR2V0dGVyRm4yKHBhdGhLZXlzWzBdLCBwYXRoS2V5c1sxXSwgZnVsbEV4cCk7CiAgICB9IGVsc2UgaWYgKG9wdGlvbnMuY3NwKSB7CiAgICAgIGlmIChwYXRoS2V5c0xlbmd0aCA8IDYpIHsKICAgICAgICBmbiA9IGNzcFNhZmVHZXR0ZXJGbihwYXRoS2V5c1swXSwgcGF0aEtleXNbMV0sIHBhdGhLZXlzWzJdLCBwYXRoS2V5c1szXSwgcGF0aEtleXNbNF0sIGZ1bGxFeHAsCiAgICAgICAgICBvcHRpb25zKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmbiA9IGZ1bmN0aW9uKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICAgIHZhciBpID0gMCwgdmFsOwogICAgICAgICAgZG8gewogICAgICAgICAgICB2YWwgPSBjc3BTYWZlR2V0dGVyRm4ocGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwgcGF0aEtleXNbaSsrXSwKICAgICAgICAgICAgICBwYXRoS2V5c1tpKytdLCBmdWxsRXhwLCBvcHRpb25zKShzY29wZSwgbG9jYWxzKTsKCiAgICAgICAgICAgIGxvY2FscyA9IHVuZGVmaW5lZDsgLy8gY2xlYXIgYWZ0ZXIgZmlyc3QgaXRlcmF0aW9uCiAgICAgICAgICAgIHNjb3BlID0gdmFsOwogICAgICAgICAgfSB3aGlsZSAoaSA8IHBhdGhLZXlzTGVuZ3RoKTsKICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGNvZGUgPSAndmFyIHA7XG4nOwogICAgICBmb3JFYWNoKHBhdGhLZXlzLCBmdW5jdGlvbihrZXksIGluZGV4KSB7CiAgICAgICAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5LCBmdWxsRXhwKTsKICAgICAgICBjb2RlICs9ICdpZihzID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7XG4nICsKICAgICAgICAgICdzPScrIChpbmRleAogICAgICAgICAgLy8gd2Ugc2ltcGx5IGRlcmVmZXJlbmNlICdzJyBvbiBhbnkgLmRvdCBub3RhdGlvbgogICAgICAgICAgPyAncycKICAgICAgICAgIC8vIGJ1dCBpZiB3ZSBhcmUgZmlyc3QgdGhlbiB3ZSBjaGVjayBsb2NhbHMgZmlyc3QsIGFuZCBpZiBzbyByZWFkIGl0IGZpcnN0CiAgICAgICAgICA6ICcoKGsmJmsuaGFzT3duUHJvcGVydHkoIicgKyBrZXkgKyAnIikpP2s6cyknKSArICdbIicgKyBrZXkgKyAnIl0nICsgJztcbicgKwogICAgICAgICAgKG9wdGlvbnMudW53cmFwUHJvbWlzZXMKICAgICAgICAgICAgPyAnaWYgKHMgJiYgcy50aGVuKSB7XG4nICsKICAgICAgICAgICAgJyBwdygiJyArIGZ1bGxFeHAucmVwbGFjZSgvKFsiXHJcbl0pL2csICdcXCQxJykgKyAnIik7XG4nICsKICAgICAgICAgICAgJyBpZiAoISgiJCR2IiBpbiBzKSkge1xuJyArCiAgICAgICAgICAgICcgcD1zO1xuJyArCiAgICAgICAgICAgICcgcC4kJHYgPSB1bmRlZmluZWQ7XG4nICsKICAgICAgICAgICAgJyBwLnRoZW4oZnVuY3Rpb24odikge3AuJCR2PXY7fSk7XG4nICsKICAgICAgICAgICAgJ31cbicgKwogICAgICAgICAgICAnIHM9cy4kJHZcbicgKwogICAgICAgICAgICAnfVxuJwogICAgICAgICAgICA6ICcnKTsKICAgICAgfSk7CiAgICAgIGNvZGUgKz0gJ3JldHVybiBzOyc7CgogICAgICAvKiBqc2hpbnQgLVcwNTQgKi8KICAgICAgdmFyIGV2YWxlZEZuR2V0dGVyID0gbmV3IEZ1bmN0aW9uKCdzJywgJ2snLCAncHcnLCBjb2RlKTsgLy8gcz1zY29wZSwgaz1sb2NhbHMsIHB3PXByb21pc2VXYXJuaW5nCiAgICAgIC8qIGpzaGludCArVzA1NCAqLwogICAgICBldmFsZWRGbkdldHRlci50b1N0cmluZyA9IHZhbHVlRm4oY29kZSk7CiAgICAgIGZuID0gb3B0aW9ucy51bndyYXBQcm9taXNlcyA/IGZ1bmN0aW9uKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICByZXR1cm4gZXZhbGVkRm5HZXR0ZXIoc2NvcGUsIGxvY2FscywgcHJvbWlzZVdhcm5pbmcpOwogICAgICB9IDogZXZhbGVkRm5HZXR0ZXI7CiAgICB9CgogICAgLy8gT25seSBjYWNoZSB0aGUgdmFsdWUgaWYgaXQncyBub3QgZ29pbmcgdG8gbWVzcyB1cCB0aGUgY2FjaGUgb2JqZWN0CiAgICAvLyBUaGlzIGlzIG1vcmUgcGVyZm9ybWFudCB0aGF0IHVzaW5nIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbAogICAgaWYgKHBhdGggIT09ICdoYXNPd25Qcm9wZXJ0eScpIHsKICAgICAgZ2V0dGVyRm5DYWNoZVtwYXRoXSA9IGZuOwogICAgfQogICAgcmV0dXJuIGZuOwogIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJHBhcnNlCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogQ29udmVydHMgQW5ndWxhciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpbnRvIGEgZnVuY3Rpb24uCiAgICoKICAgKiBgYGBqcwogICAqICAgdmFyIGdldHRlciA9ICRwYXJzZSgndXNlci5uYW1lJyk7CiAgICogICB2YXIgc2V0dGVyID0gZ2V0dGVyLmFzc2lnbjsKICAgKiAgIHZhciBjb250ZXh0ID0ge3VzZXI6e25hbWU6J2FuZ3VsYXInfX07CiAgICogICB2YXIgbG9jYWxzID0ge3VzZXI6e25hbWU6J2xvY2FsJ319OwogICAqCiAgICogICBleHBlY3QoZ2V0dGVyKGNvbnRleHQpKS50b0VxdWFsKCdhbmd1bGFyJyk7CiAgICogICBzZXR0ZXIoY29udGV4dCwgJ25ld1ZhbHVlJyk7CiAgICogICBleHBlY3QoY29udGV4dC51c2VyLm5hbWUpLnRvRXF1YWwoJ25ld1ZhbHVlJyk7CiAgICogICBleHBlY3QoZ2V0dGVyKGNvbnRleHQsIGxvY2FscykpLnRvRXF1YWwoJ2xvY2FsJyk7CiAgICogYGBgCiAgICoKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgKgogICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICogICAgICBgY29udGV4dGAuCiAgICoKICAgKiAgICBUaGUgcmV0dXJuZWQgZnVuY3Rpb24gYWxzbyBoYXMgdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAqICAgICAgKiBgbGl0ZXJhbGAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB3aGV0aGVyIHRoZSBleHByZXNzaW9uJ3MgdG9wLWxldmVsIG5vZGUgaXMgYSBKYXZhU2NyaXB0CiAgICogICAgICAgIGxpdGVyYWwuCiAgICogICAgICAqIGBjb25zdGFudGAg4oCTIGB7Ym9vbGVhbn1gIOKAkyB3aGV0aGVyIHRoZSBleHByZXNzaW9uIGlzIG1hZGUgZW50aXJlbHkgb2YgSmF2YVNjcmlwdAogICAqICAgICAgICBjb25zdGFudCBsaXRlcmFscy4KICAgKiAgICAgICogYGFzc2lnbmAg4oCTIGB7P2Z1bmN0aW9uKGNvbnRleHQsIHZhbHVlKX1gIOKAkyBpZiB0aGUgZXhwcmVzc2lvbiBpcyBhc3NpZ25hYmxlLCB0aGlzIHdpbGwgYmUKICAgKiAgICAgICAgc2V0IHRvIGEgZnVuY3Rpb24gdG8gY2hhbmdlIGl0cyB2YWx1ZSBvbiB0aGUgZ2l2ZW4gY29udGV4dC4KICAgKgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIHByb3ZpZGVyCiAgICogQG5hbWUgJHBhcnNlUHJvdmlkZXIKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogYCRwYXJzZVByb3ZpZGVyYCBjYW4gYmUgdXNlZCBmb3IgY29uZmlndXJpbmcgdGhlIGRlZmF1bHQgYmVoYXZpb3Igb2YgdGhlIHtAbGluayBuZy4kcGFyc2UgJHBhcnNlfQogICAqICBzZXJ2aWNlLgogICAqLwogIGZ1bmN0aW9uICRQYXJzZVByb3ZpZGVyKCkgewogICAgdmFyIGNhY2hlID0ge307CgogICAgdmFyICRwYXJzZU9wdGlvbnMgPSB7CiAgICAgIGNzcDogZmFsc2UsCiAgICAgIHVud3JhcFByb21pc2VzOiBmYWxzZSwKICAgICAgbG9nUHJvbWlzZVdhcm5pbmdzOiB0cnVlCiAgICB9OwoKCiAgICAvKioKICAgICAqIEBkZXByZWNhdGVkIFByb21pc2UgdW53cmFwcGluZyB2aWEgJHBhcnNlIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgZnV0dXJlLgogICAgICoKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRwYXJzZVByb3ZpZGVyI3Vud3JhcFByb21pc2VzCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiAqKlRoaXMgZmVhdHVyZSBpcyBkZXByZWNhdGVkLCBzZWUgZGVwcmVjYXRpb24gbm90ZXMgYmVsb3cgZm9yIG1vcmUgaW5mbyoqCiAgICAgKgogICAgICogSWYgc2V0IHRvIHRydWUgKGRlZmF1bHQgaXMgZmFsc2UpLCAkcGFyc2Ugd2lsbCB1bndyYXAgcHJvbWlzZXMgYXV0b21hdGljYWxseSB3aGVuIGEgcHJvbWlzZSBpcwogICAgICogZm91bmQgYXQgYW55IHBhcnQgb2YgdGhlIGV4cHJlc3Npb24uIEluIG90aGVyIHdvcmRzLCBpZiBzZXQgdG8gdHJ1ZSwgdGhlIGV4cHJlc3Npb24gd2lsbCBhbHdheXMKICAgICAqIHJlc3VsdCBpbiBhIG5vbi1wcm9taXNlIHZhbHVlLgogICAgICoKICAgICAqIFdoaWxlIHRoZSBwcm9taXNlIGlzIHVucmVzb2x2ZWQsIGl0J3MgdHJlYXRlZCBhcyB1bmRlZmluZWQsIGJ1dCBvbmNlIHJlc29sdmVkIGFuZCBmdWxmaWxsZWQsCiAgICAgKiB0aGUgZnVsZmlsbG1lbnQgdmFsdWUgaXMgdXNlZCBpbiBwbGFjZSBvZiB0aGUgcHJvbWlzZSB3aGlsZSBldmFsdWF0aW5nIHRoZSBleHByZXNzaW9uLgogICAgICoKICAgICAqICoqRGVwcmVjYXRpb24gbm90aWNlKioKICAgICAqCiAgICAgKiBUaGlzIGlzIGEgZmVhdHVyZSB0aGF0IGRpZG4ndCBwcm92ZSB0byBiZSB3aWxkbHkgdXNlZnVsIG9yIHBvcHVsYXIsIHByaW1hcmlseSBiZWNhdXNlIG9mIHRoZQogICAgICogZGljaG90b215IGJldHdlZW4gZGF0YSBhY2Nlc3MgaW4gdGVtcGxhdGVzIChhY2Nlc3NlZCBhcyByYXcgdmFsdWVzKSBhbmQgY29udHJvbGxlciBjb2RlCiAgICAgKiAoYWNjZXNzZWQgYXMgcHJvbWlzZXMpLgogICAgICoKICAgICAqIEluIG1vc3QgY29kZSB3ZSBlbmRlZCB1cCByZXNvbHZpbmcgcHJvbWlzZXMgbWFudWFsbHkgaW4gY29udHJvbGxlcnMgYW55d2F5IGFuZCB0aHVzIHVuaWZ5aW5nCiAgICAgKiB0aGUgbW9kZWwgYWNjZXNzIHRoZXJlLgogICAgICoKICAgICAqIE90aGVyIGRvd25zaWRlcyBvZiBhdXRvbWF0aWMgcHJvbWlzZSB1bndyYXBwaW5nOgogICAgICoKICAgICAqIC0gd2hlbiBidWlsZGluZyBjb21wb25lbnRzIGl0J3Mgb2Z0ZW4gZGVzaXJhYmxlIHRvIHJlY2VpdmUgdGhlIHJhdyBwcm9taXNlcwogICAgICogLSBhZGRzIGNvbXBsZXhpdHkgYW5kIHNsb3dzIGRvd24gZXhwcmVzc2lvbiBldmFsdWF0aW9uCiAgICAgKiAtIG1ha2VzIGV4cHJlc3Npb24gY29kZSBwcmUtZ2VuZXJhdGlvbiB1bmF0dHJhY3RpdmUgZHVlIHRvIHRoZSBhbW91bnQgb2YgY29kZSB0aGF0IG5lZWRzIHRvIGJlCiAgICAgKiAgIGdlbmVyYXRlZAogICAgICogLSBtYWtlcyBJREUgYXV0by1jb21wbGV0aW9uIGFuZCB0b29sIHN1cHBvcnQgaGFyZAogICAgICoKICAgICAqICoqV2FybmluZyBMb2dzKioKICAgICAqCiAgICAgKiBJZiB0aGUgdW53cmFwcGluZyBpcyBlbmFibGVkLCBBbmd1bGFyIHdpbGwgbG9nIGEgd2FybmluZyBhYm91dCBlYWNoIGV4cHJlc3Npb24gdGhhdCB1bndyYXBzIGEKICAgICAqIHByb21pc2UgKHRvIHJlZHVjZSB0aGUgbm9pc2UsIGVhY2ggZXhwcmVzc2lvbiBpcyBsb2dnZWQgb25seSBvbmNlKS4gVG8gZGlzYWJsZSB0aGlzIGxvZ2dpbmcgdXNlCiAgICAgKiBgJHBhcnNlUHJvdmlkZXIubG9nUHJvbWlzZVdhcm5pbmdzKGZhbHNlKWAgYXBpLgogICAgICoKICAgICAqCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSB2YWx1ZSBOZXcgdmFsdWUuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbnxzZWxmfSBSZXR1cm5zIHRoZSBjdXJyZW50IHNldHRpbmcgd2hlbiB1c2VkIGFzIGdldHRlciBhbmQgc2VsZiBpZiB1c2VkIGFzCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICBzZXR0ZXIuCiAgICAgKi8KICAgIHRoaXMudW53cmFwUHJvbWlzZXMgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICRwYXJzZU9wdGlvbnMudW53cmFwUHJvbWlzZXMgPSAhIXZhbHVlOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAkcGFyc2VPcHRpb25zLnVud3JhcFByb21pc2VzOwogICAgICB9CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBkZXByZWNhdGVkIFByb21pc2UgdW53cmFwcGluZyB2aWEgJHBhcnNlIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgZnV0dXJlLgogICAgICoKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRwYXJzZVByb3ZpZGVyI2xvZ1Byb21pc2VXYXJuaW5ncwogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKgogICAgICogQ29udHJvbHMgd2hldGhlciBBbmd1bGFyIHNob3VsZCBsb2cgYSB3YXJuaW5nIG9uIGFueSBlbmNvdW50ZXIgb2YgYSBwcm9taXNlIGluIGFuIGV4cHJlc3Npb24uCiAgICAgKgogICAgICogVGhlIGRlZmF1bHQgaXMgc2V0IHRvIGB0cnVlYC4KICAgICAqCiAgICAgKiBUaGlzIHNldHRpbmcgYXBwbGllcyBvbmx5IGlmIGAkcGFyc2VQcm92aWRlci51bndyYXBQcm9taXNlc2Agc2V0dGluZyBpcyBzZXQgdG8gdHJ1ZSBhcyB3ZWxsLgogICAgICoKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHZhbHVlIE5ldyB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufHNlbGZ9IFJldHVybnMgdGhlIGN1cnJlbnQgc2V0dGluZyB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgIHNldHRlci4KICAgICAqLwogICAgdGhpcy5sb2dQcm9taXNlV2FybmluZ3MgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICRwYXJzZU9wdGlvbnMubG9nUHJvbWlzZVdhcm5pbmdzID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICRwYXJzZU9wdGlvbnMubG9nUHJvbWlzZVdhcm5pbmdzOwogICAgICB9CiAgICB9OwoKCiAgICB0aGlzLiRnZXQgPSBbJyRmaWx0ZXInLCAnJHNuaWZmZXInLCAnJGxvZycsIGZ1bmN0aW9uKCRmaWx0ZXIsICRzbmlmZmVyLCAkbG9nKSB7CiAgICAgICRwYXJzZU9wdGlvbnMuY3NwID0gJHNuaWZmZXIuY3NwOwoKICAgICAgcHJvbWlzZVdhcm5pbmcgPSBmdW5jdGlvbiBwcm9taXNlV2FybmluZ0ZuKGZ1bGxFeHApIHsKICAgICAgICBpZiAoISRwYXJzZU9wdGlvbnMubG9nUHJvbWlzZVdhcm5pbmdzIHx8IHByb21pc2VXYXJuaW5nQ2FjaGUuaGFzT3duUHJvcGVydHkoZnVsbEV4cCkpIHJldHVybjsKICAgICAgICBwcm9taXNlV2FybmluZ0NhY2hlW2Z1bGxFeHBdID0gdHJ1ZTsKICAgICAgICAkbG9nLndhcm4oJ1skcGFyc2VdIFByb21pc2UgZm91bmQgaW4gdGhlIGV4cHJlc3Npb24gYCcgKyBmdWxsRXhwICsgJ2AuICcgKwogICAgICAgICAgJ0F1dG9tYXRpYyB1bndyYXBwaW5nIG9mIHByb21pc2VzIGluIEFuZ3VsYXIgZXhwcmVzc2lvbnMgaXMgZGVwcmVjYXRlZC4nKTsKICAgICAgfTsKCiAgICAgIHJldHVybiBmdW5jdGlvbihleHApIHsKICAgICAgICB2YXIgcGFyc2VkRXhwcmVzc2lvbjsKCiAgICAgICAgc3dpdGNoICh0eXBlb2YgZXhwKSB7CiAgICAgICAgICBjYXNlICdzdHJpbmcnOgoKICAgICAgICAgICAgaWYgKGNhY2hlLmhhc093blByb3BlcnR5KGV4cCkpIHsKICAgICAgICAgICAgICByZXR1cm4gY2FjaGVbZXhwXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGxleGVyID0gbmV3IExleGVyKCRwYXJzZU9wdGlvbnMpOwogICAgICAgICAgICB2YXIgcGFyc2VyID0gbmV3IFBhcnNlcihsZXhlciwgJGZpbHRlciwgJHBhcnNlT3B0aW9ucyk7CiAgICAgICAgICAgIHBhcnNlZEV4cHJlc3Npb24gPSBwYXJzZXIucGFyc2UoZXhwKTsKCiAgICAgICAgICAgIGlmIChleHAgIT09ICdoYXNPd25Qcm9wZXJ0eScpIHsKICAgICAgICAgICAgICAvLyBPbmx5IGNhY2hlIHRoZSB2YWx1ZSBpZiBpdCdzIG5vdCBnb2luZyB0byBtZXNzIHVwIHRoZSBjYWNoZSBvYmplY3QKICAgICAgICAgICAgICAvLyBUaGlzIGlzIG1vcmUgcGVyZm9ybWFudCB0aGF0IHVzaW5nIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbAogICAgICAgICAgICAgIGNhY2hlW2V4cF0gPSBwYXJzZWRFeHByZXNzaW9uOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcGFyc2VkRXhwcmVzc2lvbjsKCiAgICAgICAgICBjYXNlICdmdW5jdGlvbic6CiAgICAgICAgICAgIHJldHVybiBleHA7CgogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgcmV0dXJuIG5vb3A7CiAgICAgICAgfQogICAgICB9OwogICAgfV07CiAgfQoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRxCiAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEEgcHJvbWlzZS9kZWZlcnJlZCBpbXBsZW1lbnRhdGlvbiBpbnNwaXJlZCBieSBbS3JpcyBLb3dhbCdzIFFdKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcSkuCiAgICoKICAgKiBbVGhlIENvbW1vbkpTIFByb21pc2UgcHJvcG9zYWxdKGh0dHA6Ly93aWtpLmNvbW1vbmpzLm9yZy93aWtpL1Byb21pc2VzKSBkZXNjcmliZXMgYSBwcm9taXNlIGFzIGFuCiAgICogaW50ZXJmYWNlIGZvciBpbnRlcmFjdGluZyB3aXRoIGFuIG9iamVjdCB0aGF0IHJlcHJlc2VudHMgdGhlIHJlc3VsdCBvZiBhbiBhY3Rpb24gdGhhdCBpcwogICAqIHBlcmZvcm1lZCBhc3luY2hyb25vdXNseSwgYW5kIG1heSBvciBtYXkgbm90IGJlIGZpbmlzaGVkIGF0IGFueSBnaXZlbiBwb2ludCBpbiB0aW1lLgogICAqCiAgICogRnJvbSB0aGUgcGVyc3BlY3RpdmUgb2YgZGVhbGluZyB3aXRoIGVycm9yIGhhbmRsaW5nLCBkZWZlcnJlZCBhbmQgcHJvbWlzZSBBUElzIGFyZSB0bwogICAqIGFzeW5jaHJvbm91cyBwcm9ncmFtbWluZyB3aGF0IGB0cnlgLCBgY2F0Y2hgIGFuZCBgdGhyb3dgIGtleXdvcmRzIGFyZSB0byBzeW5jaHJvbm91cyBwcm9ncmFtbWluZy4KICAgKgogICAqIGBgYGpzCiAgICogICAvLyBmb3IgdGhlIHB1cnBvc2Ugb2YgdGhpcyBleGFtcGxlIGxldCdzIGFzc3VtZSB0aGF0IHZhcmlhYmxlcyBgJHFgLCBgc2NvcGVgIGFuZCBgb2tUb0dyZWV0YAogICAqICAgLy8gYXJlIGF2YWlsYWJsZSBpbiB0aGUgY3VycmVudCBsZXhpY2FsIHNjb3BlICh0aGV5IGNvdWxkIGhhdmUgYmVlbiBpbmplY3RlZCBvciBwYXNzZWQgaW4pLgogICAqCiAgICogICBmdW5jdGlvbiBhc3luY0dyZWV0KG5hbWUpIHsKICogICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7CiAqCiAqICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogKiAgICAgICAvLyBzaW5jZSB0aGlzIGZuIGV4ZWN1dGVzIGFzeW5jIGluIGEgZnV0dXJlIHR1cm4gb2YgdGhlIGV2ZW50IGxvb3AsIHdlIG5lZWQgdG8gd3JhcAogKiAgICAgICAvLyBvdXIgY29kZSBpbnRvIGFuICRhcHBseSBjYWxsIHNvIHRoYXQgdGhlIG1vZGVsIGNoYW5nZXMgYXJlIHByb3Blcmx5IG9ic2VydmVkLgogKiAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAqICAgICAgICAgZGVmZXJyZWQubm90aWZ5KCdBYm91dCB0byBncmVldCAnICsgbmFtZSArICcuJyk7CiAqCiAqICAgICAgICAgaWYgKG9rVG9HcmVldChuYW1lKSkgewogKiAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZSgnSGVsbG8sICcgKyBuYW1lICsgJyEnKTsKICogICAgICAgICB9IGVsc2UgewogKiAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KCdHcmVldGluZyAnICsgbmFtZSArICcgaXMgbm90IGFsbG93ZWQuJyk7CiAqICAgICAgICAgfQogKiAgICAgICB9KTsKICogICAgIH0sIDEwMDApOwogKgogKiAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2U7CiAqICAgfQogICAqCiAgICogICB2YXIgcHJvbWlzZSA9IGFzeW5jR3JlZXQoJ1JvYmluIEhvb2QnKTsKICAgKiAgIHByb21pc2UudGhlbihmdW5jdGlvbihncmVldGluZykgewogKiAgICAgYWxlcnQoJ1N1Y2Nlc3M6ICcgKyBncmVldGluZyk7CiAqICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAqICAgICBhbGVydCgnRmFpbGVkOiAnICsgcmVhc29uKTsKICogICB9LCBmdW5jdGlvbih1cGRhdGUpIHsKICogICAgIGFsZXJ0KCdHb3Qgbm90aWZpY2F0aW9uOiAnICsgdXBkYXRlKTsKICogICB9KTsKICAgKiBgYGAKICAgKgogICAqIEF0IGZpcnN0IGl0IG1pZ2h0IG5vdCBiZSBvYnZpb3VzIHdoeSB0aGlzIGV4dHJhIGNvbXBsZXhpdHkgaXMgd29ydGggdGhlIHRyb3VibGUuIFRoZSBwYXlvZmYKICAgKiBjb21lcyBpbiB0aGUgd2F5IG9mIGd1YXJhbnRlZXMgdGhhdCBwcm9taXNlIGFuZCBkZWZlcnJlZCBBUElzIG1ha2UsIHNlZQogICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvdW5jb21tb25qcy9ibG9iL21hc3Rlci9wcm9taXNlcy9zcGVjaWZpY2F0aW9uLm1kLgogICAqCiAgICogQWRkaXRpb25hbGx5IHRoZSBwcm9taXNlIGFwaSBhbGxvd3MgZm9yIGNvbXBvc2l0aW9uIHRoYXQgaXMgdmVyeSBoYXJkIHRvIGRvIHdpdGggdGhlCiAgICogdHJhZGl0aW9uYWwgY2FsbGJhY2sgKFtDUFNdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29udGludWF0aW9uLXBhc3Npbmdfc3R5bGUpKSBhcHByb2FjaC4KICAgKiBGb3IgbW9yZSBvbiB0aGlzIHBsZWFzZSBzZWUgdGhlIFtRIGRvY3VtZW50YXRpb25dKGh0dHBzOi8vZ2l0aHViLmNvbS9rcmlza293YWwvcSkgZXNwZWNpYWxseSB0aGUKICAgKiBzZWN0aW9uIG9uIHNlcmlhbCBvciBwYXJhbGxlbCBqb2luaW5nIG9mIHByb21pc2VzLgogICAqCiAgICoKICAgKiAjIFRoZSBEZWZlcnJlZCBBUEkKICAgKgogICAqIEEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkIGlzIGNvbnN0cnVjdGVkIGJ5IGNhbGxpbmcgYCRxLmRlZmVyKClgLgogICAqCiAgICogVGhlIHB1cnBvc2Ugb2YgdGhlIGRlZmVycmVkIG9iamVjdCBpcyB0byBleHBvc2UgdGhlIGFzc29jaWF0ZWQgUHJvbWlzZSBpbnN0YW5jZSBhcyB3ZWxsIGFzIEFQSXMKICAgKiB0aGF0IGNhbiBiZSB1c2VkIGZvciBzaWduYWxpbmcgdGhlIHN1Y2Nlc3NmdWwgb3IgdW5zdWNjZXNzZnVsIGNvbXBsZXRpb24sIGFzIHdlbGwgYXMgdGhlIHN0YXR1cwogICAqIG9mIHRoZSB0YXNrLgogICAqCiAgICogKipNZXRob2RzKioKICAgKgogICAqIC0gYHJlc29sdmUodmFsdWUpYCDigJMgcmVzb2x2ZXMgdGhlIGRlcml2ZWQgcHJvbWlzZSB3aXRoIHRoZSBgdmFsdWVgLiBJZiB0aGUgdmFsdWUgaXMgYSByZWplY3Rpb24KICAgKiAgIGNvbnN0cnVjdGVkIHZpYSBgJHEucmVqZWN0YCwgdGhlIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZCBpbnN0ZWFkLgogICAqIC0gYHJlamVjdChyZWFzb24pYCDigJMgcmVqZWN0cyB0aGUgZGVyaXZlZCBwcm9taXNlIHdpdGggdGhlIGByZWFzb25gLiBUaGlzIGlzIGVxdWl2YWxlbnQgdG8KICAgKiAgIHJlc29sdmluZyBpdCB3aXRoIGEgcmVqZWN0aW9uIGNvbnN0cnVjdGVkIHZpYSBgJHEucmVqZWN0YC4KICAgKiAtIGBub3RpZnkodmFsdWUpYCAtIHByb3ZpZGVzIHVwZGF0ZXMgb24gdGhlIHN0YXR1cyBvZiB0aGUgcHJvbWlzZSdzIGV4ZWN1dGlvbi4gVGhpcyBtYXkgYmUgY2FsbGVkCiAgICogICBtdWx0aXBsZSB0aW1lcyBiZWZvcmUgdGhlIHByb21pc2UgaXMgZWl0aGVyIHJlc29sdmVkIG9yIHJlamVjdGVkLgogICAqCiAgICogKipQcm9wZXJ0aWVzKioKICAgKgogICAqIC0gcHJvbWlzZSDigJMgYHtQcm9taXNlfWAg4oCTIHByb21pc2Ugb2JqZWN0IGFzc29jaWF0ZWQgd2l0aCB0aGlzIGRlZmVycmVkLgogICAqCiAgICoKICAgKiAjIFRoZSBQcm9taXNlIEFQSQogICAqCiAgICogQSBuZXcgcHJvbWlzZSBpbnN0YW5jZSBpcyBjcmVhdGVkIHdoZW4gYSBkZWZlcnJlZCBpbnN0YW5jZSBpcyBjcmVhdGVkIGFuZCBjYW4gYmUgcmV0cmlldmVkIGJ5CiAgICogY2FsbGluZyBgZGVmZXJyZWQucHJvbWlzZWAuCiAgICoKICAgKiBUaGUgcHVycG9zZSBvZiB0aGUgcHJvbWlzZSBvYmplY3QgaXMgdG8gYWxsb3cgZm9yIGludGVyZXN0ZWQgcGFydGllcyB0byBnZXQgYWNjZXNzIHRvIHRoZSByZXN1bHQKICAgKiBvZiB0aGUgZGVmZXJyZWQgdGFzayB3aGVuIGl0IGNvbXBsZXRlcy4KICAgKgogICAqICoqTWV0aG9kcyoqCiAgICoKICAgKiAtIGB0aGVuKHN1Y2Nlc3NDYWxsYmFjaywgZXJyb3JDYWxsYmFjaywgbm90aWZ5Q2FsbGJhY2spYCDigJMgcmVnYXJkbGVzcyBvZiB3aGVuIHRoZSBwcm9taXNlIHdhcyBvcgogICAqICAgd2lsbCBiZSByZXNvbHZlZCBvciByZWplY3RlZCwgYHRoZW5gIGNhbGxzIG9uZSBvZiB0aGUgc3VjY2VzcyBvciBlcnJvciBjYWxsYmFja3MgYXN5bmNocm9ub3VzbHkKICAgKiAgIGFzIHNvb24gYXMgdGhlIHJlc3VsdCBpcyBhdmFpbGFibGUuIFRoZSBjYWxsYmFja3MgYXJlIGNhbGxlZCB3aXRoIGEgc2luZ2xlIGFyZ3VtZW50OiB0aGUgcmVzdWx0CiAgICogICBvciByZWplY3Rpb24gcmVhc29uLiBBZGRpdGlvbmFsbHksIHRoZSBub3RpZnkgY2FsbGJhY2sgbWF5IGJlIGNhbGxlZCB6ZXJvIG9yIG1vcmUgdGltZXMgdG8KICAgKiAgIHByb3ZpZGUgYSBwcm9ncmVzcyBpbmRpY2F0aW9uLCBiZWZvcmUgdGhlIHByb21pc2UgaXMgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQuCiAgICoKICAgKiAgIFRoaXMgbWV0aG9kICpyZXR1cm5zIGEgbmV3IHByb21pc2UqIHdoaWNoIGlzIHJlc29sdmVkIG9yIHJlamVjdGVkIHZpYSB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZQogICAqICAgYHN1Y2Nlc3NDYWxsYmFja2AsIGBlcnJvckNhbGxiYWNrYC4gSXQgYWxzbyBub3RpZmllcyB2aWEgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUKICAgKiAgIGBub3RpZnlDYWxsYmFja2AgbWV0aG9kLiBUaGUgcHJvbWlzZSBjYW4gbm90IGJlIHJlc29sdmVkIG9yIHJlamVjdGVkIGZyb20gdGhlIG5vdGlmeUNhbGxiYWNrCiAgICogICBtZXRob2QuCiAgICoKICAgKiAtIGBjYXRjaChlcnJvckNhbGxiYWNrKWAg4oCTIHNob3J0aGFuZCBmb3IgYHByb21pc2UudGhlbihudWxsLCBlcnJvckNhbGxiYWNrKWAKICAgKgogICAqIC0gYGZpbmFsbHkoY2FsbGJhY2spYCDigJMgYWxsb3dzIHlvdSB0byBvYnNlcnZlIGVpdGhlciB0aGUgZnVsZmlsbG1lbnQgb3IgcmVqZWN0aW9uIG9mIGEgcHJvbWlzZSwKICAgKiAgIGJ1dCB0byBkbyBzbyB3aXRob3V0IG1vZGlmeWluZyB0aGUgZmluYWwgdmFsdWUuIFRoaXMgaXMgdXNlZnVsIHRvIHJlbGVhc2UgcmVzb3VyY2VzIG9yIGRvIHNvbWUKICAgKiAgIGNsZWFuLXVwIHRoYXQgbmVlZHMgdG8gYmUgZG9uZSB3aGV0aGVyIHRoZSBwcm9taXNlIHdhcyByZWplY3RlZCBvciByZXNvbHZlZC4gU2VlIHRoZSBbZnVsbAogICAqICAgc3BlY2lmaWNhdGlvbl0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xL3dpa2kvQVBJLVJlZmVyZW5jZSNwcm9taXNlZmluYWxseWNhbGxiYWNrKSBmb3IKICAgKiAgIG1vcmUgaW5mb3JtYXRpb24uCiAgICoKICAgKiAgIEJlY2F1c2UgYGZpbmFsbHlgIGlzIGEgcmVzZXJ2ZWQgd29yZCBpbiBKYXZhU2NyaXB0IGFuZCByZXNlcnZlZCBrZXl3b3JkcyBhcmUgbm90IHN1cHBvcnRlZCBhcwogICAqICAgcHJvcGVydHkgbmFtZXMgYnkgRVMzLCB5b3UnbGwgbmVlZCB0byBpbnZva2UgdGhlIG1ldGhvZCBsaWtlIGBwcm9taXNlWydmaW5hbGx5J10oY2FsbGJhY2spYCB0bwogICAqICAgbWFrZSB5b3VyIGNvZGUgSUU4IGFuZCBBbmRyb2lkIDIueCBjb21wYXRpYmxlLgogICAqCiAgICogIyBDaGFpbmluZyBwcm9taXNlcwogICAqCiAgICogQmVjYXVzZSBjYWxsaW5nIHRoZSBgdGhlbmAgbWV0aG9kIG9mIGEgcHJvbWlzZSByZXR1cm5zIGEgbmV3IGRlcml2ZWQgcHJvbWlzZSwgaXQgaXMgZWFzaWx5CiAgICogcG9zc2libGUgdG8gY3JlYXRlIGEgY2hhaW4gb2YgcHJvbWlzZXM6CiAgICoKICAgKiBgYGBqcwogICAqICAgcHJvbWlzZUIgPSBwcm9taXNlQS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogKiAgICAgcmV0dXJuIHJlc3VsdCArIDE7CiAqICAgfSk7CiAgICoKICAgKiAgIC8vIHByb21pc2VCIHdpbGwgYmUgcmVzb2x2ZWQgaW1tZWRpYXRlbHkgYWZ0ZXIgcHJvbWlzZUEgaXMgcmVzb2x2ZWQgYW5kIGl0cyB2YWx1ZQogICAqICAgLy8gd2lsbCBiZSB0aGUgcmVzdWx0IG9mIHByb21pc2VBIGluY3JlbWVudGVkIGJ5IDEKICAgKiBgYGAKICAgKgogICAqIEl0IGlzIHBvc3NpYmxlIHRvIGNyZWF0ZSBjaGFpbnMgb2YgYW55IGxlbmd0aCBhbmQgc2luY2UgYSBwcm9taXNlIGNhbiBiZSByZXNvbHZlZCB3aXRoIGFub3RoZXIKICAgKiBwcm9taXNlICh3aGljaCB3aWxsIGRlZmVyIGl0cyByZXNvbHV0aW9uIGZ1cnRoZXIpLCBpdCBpcyBwb3NzaWJsZSB0byBwYXVzZS9kZWZlciByZXNvbHV0aW9uIG9mCiAgICogdGhlIHByb21pc2VzIGF0IGFueSBwb2ludCBpbiB0aGUgY2hhaW4uIFRoaXMgbWFrZXMgaXQgcG9zc2libGUgdG8gaW1wbGVtZW50IHBvd2VyZnVsIEFQSXMgbGlrZQogICAqICRodHRwJ3MgcmVzcG9uc2UgaW50ZXJjZXB0b3JzLgogICAqCiAgICoKICAgKiAjIERpZmZlcmVuY2VzIGJldHdlZW4gS3JpcyBLb3dhbCdzIFEgYW5kICRxCiAgICoKICAgKiAgVGhlcmUgYXJlIHR3byBtYWluIGRpZmZlcmVuY2VzOgogICAqCiAgICogLSAkcSBpcyBpbnRlZ3JhdGVkIHdpdGggdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlfSBTY29wZSBtb2RlbCBvYnNlcnZhdGlvbgogICAqICAgbWVjaGFuaXNtIGluIGFuZ3VsYXIsIHdoaWNoIG1lYW5zIGZhc3RlciBwcm9wYWdhdGlvbiBvZiByZXNvbHV0aW9uIG9yIHJlamVjdGlvbiBpbnRvIHlvdXIKICAgKiAgIG1vZGVscyBhbmQgYXZvaWRpbmcgdW5uZWNlc3NhcnkgYnJvd3NlciByZXBhaW50cywgd2hpY2ggd291bGQgcmVzdWx0IGluIGZsaWNrZXJpbmcgVUkuCiAgICogLSBRIGhhcyBtYW55IG1vcmUgZmVhdHVyZXMgdGhhbiAkcSwgYnV0IHRoYXQgY29tZXMgYXQgYSBjb3N0IG9mIGJ5dGVzLiAkcSBpcyB0aW55LCBidXQgY29udGFpbnMKICAgKiAgIGFsbCB0aGUgaW1wb3J0YW50IGZ1bmN0aW9uYWxpdHkgbmVlZGVkIGZvciBjb21tb24gYXN5bmMgdGFza3MuCiAgICoKICAgKiAgIyBUZXN0aW5nCiAgICoKICAgKiAgYGBganMKICAgKiAgICBpdCgnc2hvdWxkIHNpbXVsYXRlIHByb21pc2UnLCBpbmplY3QoZnVuY3Rpb24oJHEsICRyb290U2NvcGUpIHsKICogICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpOwogKiAgICAgIHZhciBwcm9taXNlID0gZGVmZXJyZWQucHJvbWlzZTsKICogICAgICB2YXIgcmVzb2x2ZWRWYWx1ZTsKICoKICogICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24odmFsdWUpIHsgcmVzb2x2ZWRWYWx1ZSA9IHZhbHVlOyB9KTsKICogICAgICBleHBlY3QocmVzb2x2ZWRWYWx1ZSkudG9CZVVuZGVmaW5lZCgpOwogKgogKiAgICAgIC8vIFNpbXVsYXRlIHJlc29sdmluZyBvZiBwcm9taXNlCiAqICAgICAgZGVmZXJyZWQucmVzb2x2ZSgxMjMpOwogKiAgICAgIC8vIE5vdGUgdGhhdCB0aGUgJ3RoZW4nIGZ1bmN0aW9uIGRvZXMgbm90IGdldCBjYWxsZWQgc3luY2hyb25vdXNseS4KICogICAgICAvLyBUaGlzIGlzIGJlY2F1c2Ugd2Ugd2FudCB0aGUgcHJvbWlzZSBBUEkgdG8gYWx3YXlzIGJlIGFzeW5jLCB3aGV0aGVyIG9yIG5vdAogKiAgICAgIC8vIGl0IGdvdCBjYWxsZWQgc3luY2hyb25vdXNseSBvciBhc3luY2hyb25vdXNseS4KICogICAgICBleHBlY3QocmVzb2x2ZWRWYWx1ZSkudG9CZVVuZGVmaW5lZCgpOwogKgogKiAgICAgIC8vIFByb3BhZ2F0ZSBwcm9taXNlIHJlc29sdXRpb24gdG8gJ3RoZW4nIGZ1bmN0aW9ucyB1c2luZyAkYXBwbHkoKS4KICogICAgICAkcm9vdFNjb3BlLiRhcHBseSgpOwogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0VxdWFsKDEyMyk7CiAqICAgIH0pKTsKICAgKiAgYGBgCiAgICovCiAgZnVuY3Rpb24gJFFQcm92aWRlcigpIHsKCiAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCBmdW5jdGlvbigkcm9vdFNjb3BlLCAkZXhjZXB0aW9uSGFuZGxlcikgewogICAgICByZXR1cm4gcUZhY3RvcnkoZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoY2FsbGJhY2spOwogICAgICB9LCAkZXhjZXB0aW9uSGFuZGxlcik7CiAgICB9XTsKICB9CgoKICAvKioKICAgKiBDb25zdHJ1Y3RzIGEgcHJvbWlzZSBtYW5hZ2VyLgogICAqCiAgICogQHBhcmFtIHtmdW5jdGlvbihGdW5jdGlvbil9IG5leHRUaWNrIEZ1bmN0aW9uIGZvciBleGVjdXRpbmcgZnVuY3Rpb25zIGluIHRoZSBuZXh0IHR1cm4uCiAgICogQHBhcmFtIHtmdW5jdGlvbiguLi4qKX0gZXhjZXB0aW9uSGFuZGxlciBGdW5jdGlvbiBpbnRvIHdoaWNoIHVuZXhwZWN0ZWQgZXhjZXB0aW9ucyBhcmUgcGFzc2VkIGZvcgogICAqICAgICBkZWJ1Z2dpbmcgcHVycG9zZXMuCiAgICogQHJldHVybnMge29iamVjdH0gUHJvbWlzZSBtYW5hZ2VyLgogICAqLwogIGZ1bmN0aW9uIHFGYWN0b3J5KG5leHRUaWNrLCBleGNlcHRpb25IYW5kbGVyKSB7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkcSNkZWZlcgogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBgRGVmZXJyZWRgIG9iamVjdCB3aGljaCByZXByZXNlbnRzIGEgdGFzayB3aGljaCB3aWxsIGZpbmlzaCBpbiB0aGUgZnV0dXJlLgogICAgICoKICAgICAqIEByZXR1cm5zIHtEZWZlcnJlZH0gUmV0dXJucyBhIG5ldyBpbnN0YW5jZSBvZiBkZWZlcnJlZC4KICAgICAqLwogICAgdmFyIGRlZmVyID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBwZW5kaW5nID0gW10sCiAgICAgICAgdmFsdWUsIGRlZmVycmVkOwoKICAgICAgZGVmZXJyZWQgPSB7CgogICAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgaWYgKHBlbmRpbmcpIHsKICAgICAgICAgICAgdmFyIGNhbGxiYWNrcyA9IHBlbmRpbmc7CiAgICAgICAgICAgIHBlbmRpbmcgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHZhbHVlID0gcmVmKHZhbCk7CgogICAgICAgICAgICBpZiAoY2FsbGJhY2tzLmxlbmd0aCkgewogICAgICAgICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gY2FsbGJhY2tzLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBjYWxsYmFja3NbaV07CiAgICAgICAgICAgICAgICAgIHZhbHVlLnRoZW4oY2FsbGJhY2tbMF0sIGNhbGxiYWNrWzFdLCBjYWxsYmFja1syXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAoKCiAgICAgICAgcmVqZWN0OiBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgIGRlZmVycmVkLnJlc29sdmUoY3JlYXRlSW50ZXJuYWxSZWplY3RlZFByb21pc2UocmVhc29uKSk7CiAgICAgICAgfSwKCgogICAgICAgIG5vdGlmeTogZnVuY3Rpb24ocHJvZ3Jlc3MpIHsKICAgICAgICAgIGlmIChwZW5kaW5nKSB7CiAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBwZW5kaW5nOwoKICAgICAgICAgICAgaWYgKHBlbmRpbmcubGVuZ3RoKSB7CiAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBjYWxsYmFja3MubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXTsKICAgICAgICAgICAgICAgICAgY2FsbGJhY2tbMl0ocHJvZ3Jlc3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKCgogICAgICAgIHByb21pc2U6IHsKICAgICAgICAgIHRoZW46IGZ1bmN0aW9uKGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9ncmVzc2JhY2spIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CgogICAgICAgICAgICB2YXIgd3JhcHBlZENhbGxiYWNrID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGlzRnVuY3Rpb24oY2FsbGJhY2spID8gY2FsbGJhY2sgOiBkZWZhdWx0Q2FsbGJhY2spKHZhbHVlKSk7CiAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgd3JhcHBlZEVycmJhY2sgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGlzRnVuY3Rpb24oZXJyYmFjaykgPyBlcnJiYWNrIDogZGVmYXVsdEVycmJhY2spKHJlYXNvbikpOwogICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgcmVzdWx0LnJlamVjdChlKTsKICAgICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIHdyYXBwZWRQcm9ncmVzc2JhY2sgPSBmdW5jdGlvbihwcm9ncmVzcykgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXN1bHQubm90aWZ5KChpc0Z1bmN0aW9uKHByb2dyZXNzYmFjaykgPyBwcm9ncmVzc2JhY2sgOiBkZWZhdWx0Q2FsbGJhY2spKHByb2dyZXNzKSk7CiAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmIChwZW5kaW5nKSB7CiAgICAgICAgICAgICAgcGVuZGluZy5wdXNoKFt3cmFwcGVkQ2FsbGJhY2ssIHdyYXBwZWRFcnJiYWNrLCB3cmFwcGVkUHJvZ3Jlc3NiYWNrXSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFsdWUudGhlbih3cmFwcGVkQ2FsbGJhY2ssIHdyYXBwZWRFcnJiYWNrLCB3cmFwcGVkUHJvZ3Jlc3NiYWNrKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgICAgfSwKCiAgICAgICAgICAiY2F0Y2giOiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgICByZXR1cm4gdGhpcy50aGVuKG51bGwsIGNhbGxiYWNrKTsKICAgICAgICAgIH0sCgogICAgICAgICAgImZpbmFsbHkiOiBmdW5jdGlvbihjYWxsYmFjaykgewoKICAgICAgICAgICAgZnVuY3Rpb24gbWFrZVByb21pc2UodmFsdWUsIHJlc29sdmVkKSB7CiAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICAgICAgaWYgKHJlc29sdmVkKSB7CiAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5yZWplY3QodmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNhbGxiYWNrKHZhbHVlLCBpc1Jlc29sdmVkKSB7CiAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrT3V0cHV0ID0gbnVsbDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY2FsbGJhY2tPdXRwdXQgPSAoY2FsbGJhY2sgfHxkZWZhdWx0Q2FsbGJhY2spKCk7CiAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWFrZVByb21pc2UoZSwgZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tPdXRwdXQgJiYgaXNGdW5jdGlvbihjYWxsYmFja091dHB1dC50aGVuKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrT3V0cHV0LnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBtYWtlUHJvbWlzZSh2YWx1ZSwgaXNSZXNvbHZlZCk7CiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbihlcnJvcikgewogICAgICAgICAgICAgICAgICByZXR1cm4gbWFrZVByb21pc2UoZXJyb3IsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWFrZVByb21pc2UodmFsdWUsIGlzUmVzb2x2ZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHJldHVybiBoYW5kbGVDYWxsYmFjayh2YWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUNhbGxiYWNrKGVycm9yLCBmYWxzZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHJldHVybiBkZWZlcnJlZDsKICAgIH07CgoKICAgIHZhciByZWYgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAodmFsdWUgJiYgaXNGdW5jdGlvbih2YWx1ZS50aGVuKSkgcmV0dXJuIHZhbHVlOwogICAgICByZXR1cm4gewogICAgICAgIHRoZW46IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKICAgICAgICAgIG5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXN1bHQucmVzb2x2ZShjYWxsYmFjayh2YWx1ZSkpOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgfQogICAgICB9OwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkcSNyZWplY3QKICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgcHJvbWlzZSB0aGF0IGlzIHJlc29sdmVkIGFzIHJlamVjdGVkIHdpdGggdGhlIHNwZWNpZmllZCBgcmVhc29uYC4gVGhpcyBhcGkgc2hvdWxkIGJlCiAgICAgKiB1c2VkIHRvIGZvcndhcmQgcmVqZWN0aW9uIGluIGEgY2hhaW4gb2YgcHJvbWlzZXMuIElmIHlvdSBhcmUgZGVhbGluZyB3aXRoIHRoZSBsYXN0IHByb21pc2UgaW4KICAgICAqIGEgcHJvbWlzZSBjaGFpbiwgeW91IGRvbid0IG5lZWQgdG8gd29ycnkgYWJvdXQgaXQuCiAgICAgKgogICAgICogV2hlbiBjb21wYXJpbmcgZGVmZXJyZWRzL3Byb21pc2VzIHRvIHRoZSBmYW1pbGlhciBiZWhhdmlvciBvZiB0cnkvY2F0Y2gvdGhyb3csIHRoaW5rIG9mCiAgICAgKiBgcmVqZWN0YCBhcyB0aGUgYHRocm93YCBrZXl3b3JkIGluIEphdmFTY3JpcHQuIFRoaXMgYWxzbyBtZWFucyB0aGF0IGlmIHlvdSAiY2F0Y2giIGFuIGVycm9yIHZpYQogICAgICogYSBwcm9taXNlIGVycm9yIGNhbGxiYWNrIGFuZCB5b3Ugd2FudCB0byBmb3J3YXJkIHRoZSBlcnJvciB0byB0aGUgcHJvbWlzZSBkZXJpdmVkIGZyb20gdGhlCiAgICAgKiBjdXJyZW50IHByb21pc2UsIHlvdSBoYXZlIHRvICJyZXRocm93IiB0aGUgZXJyb3IgYnkgcmV0dXJuaW5nIGEgcmVqZWN0aW9uIGNvbnN0cnVjdGVkIHZpYQogICAgICogYHJlamVjdGAuCiAgICAgKgogICAgICogYGBganMKICAgICAqICAgcHJvbWlzZUIgPSBwcm9taXNlQS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAqICAgICAvLyBzdWNjZXNzOiBkbyBzb21ldGhpbmcgYW5kIHJlc29sdmUgcHJvbWlzZUIKICAgKiAgICAgLy8gICAgICAgICAgd2l0aCB0aGUgb2xkIG9yIGEgbmV3IHJlc3VsdAogICAqICAgICByZXR1cm4gcmVzdWx0OwogICAqICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICogICAgIC8vIGVycm9yOiBoYW5kbGUgdGhlIGVycm9yIGlmIHBvc3NpYmxlIGFuZAogICAqICAgICAvLyAgICAgICAgcmVzb2x2ZSBwcm9taXNlQiB3aXRoIG5ld1Byb21pc2VPclZhbHVlLAogICAqICAgICAvLyAgICAgICAgb3RoZXJ3aXNlIGZvcndhcmQgdGhlIHJlamVjdGlvbiB0byBwcm9taXNlQgogICAqICAgICBpZiAoY2FuSGFuZGxlKHJlYXNvbikpIHsKICAgKiAgICAgIC8vIGhhbmRsZSB0aGUgZXJyb3IgYW5kIHJlY292ZXIKICAgKiAgICAgIHJldHVybiBuZXdQcm9taXNlT3JWYWx1ZTsKICAgKiAgICAgfQogICAqICAgICByZXR1cm4gJHEucmVqZWN0KHJlYXNvbik7CiAgICogICB9KTsKICAgICAqIGBgYAogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gcmVhc29uIENvbnN0YW50LCBtZXNzYWdlLCBleGNlcHRpb24gb3IgYW4gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcmVqZWN0aW9uIHJlYXNvbi4KICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgcHJvbWlzZSB0aGF0IHdhcyBhbHJlYWR5IHJlc29sdmVkIGFzIHJlamVjdGVkIHdpdGggdGhlIGByZWFzb25gLgogICAgICovCiAgICB2YXIgcmVqZWN0ID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgIHZhciByZXN1bHQgPSBkZWZlcigpOwogICAgICByZXN1bHQucmVqZWN0KHJlYXNvbik7CiAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgIH07CgogICAgdmFyIGNyZWF0ZUludGVybmFsUmVqZWN0ZWRQcm9taXNlID0gZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdGhlbjogZnVuY3Rpb24oY2FsbGJhY2ssIGVycmJhY2spIHsKICAgICAgICAgIHZhciByZXN1bHQgPSBkZWZlcigpOwogICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVzdWx0LnJlc29sdmUoKGlzRnVuY3Rpb24oZXJyYmFjaykgPyBlcnJiYWNrIDogZGVmYXVsdEVycmJhY2spKHJlYXNvbikpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgICAgIH0KICAgICAgfTsKICAgIH07CgoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHEjd2hlbgogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFdyYXBzIGFuIG9iamVjdCB0aGF0IG1pZ2h0IGJlIGEgdmFsdWUgb3IgYSAoM3JkIHBhcnR5KSB0aGVuLWFibGUgcHJvbWlzZSBpbnRvIGEgJHEgcHJvbWlzZS4KICAgICAqIFRoaXMgaXMgdXNlZnVsIHdoZW4geW91IGFyZSBkZWFsaW5nIHdpdGggYW4gb2JqZWN0IHRoYXQgbWlnaHQgb3IgbWlnaHQgbm90IGJlIGEgcHJvbWlzZSwgb3IgaWYKICAgICAqIHRoZSBwcm9taXNlIGNvbWVzIGZyb20gYSBzb3VyY2UgdGhhdCBjYW4ndCBiZSB0cnVzdGVkLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVmFsdWUgb3IgYSBwcm9taXNlCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHByb21pc2Ugb2YgdGhlIHBhc3NlZCB2YWx1ZSBvciBwcm9taXNlCiAgICAgKi8KICAgIHZhciB3aGVuID0gZnVuY3Rpb24odmFsdWUsIGNhbGxiYWNrLCBlcnJiYWNrLCBwcm9ncmVzc2JhY2spIHsKICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCksCiAgICAgICAgZG9uZTsKCiAgICAgIHZhciB3cmFwcGVkQ2FsbGJhY2sgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gKGlzRnVuY3Rpb24oY2FsbGJhY2spID8gY2FsbGJhY2sgOiBkZWZhdWx0Q2FsbGJhY2spKHZhbHVlKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgcmV0dXJuIHJlamVjdChlKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgd3JhcHBlZEVycmJhY2sgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIChpc0Z1bmN0aW9uKGVycmJhY2spID8gZXJyYmFjayA6IGRlZmF1bHRFcnJiYWNrKShyZWFzb24pOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICByZXR1cm4gcmVqZWN0KGUpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciB3cmFwcGVkUHJvZ3Jlc3NiYWNrID0gZnVuY3Rpb24ocHJvZ3Jlc3MpIHsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIChpc0Z1bmN0aW9uKHByb2dyZXNzYmFjaykgPyBwcm9ncmVzc2JhY2sgOiBkZWZhdWx0Q2FsbGJhY2spKHByb2dyZXNzKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIG5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgIHJlZih2YWx1ZSkudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgaWYgKGRvbmUpIHJldHVybjsKICAgICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgICAgcmVzdWx0LnJlc29sdmUocmVmKHZhbHVlKS50aGVuKHdyYXBwZWRDYWxsYmFjaywgd3JhcHBlZEVycmJhY2ssIHdyYXBwZWRQcm9ncmVzc2JhY2spKTsKICAgICAgICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgICAgIGlmIChkb25lKSByZXR1cm47CiAgICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKHdyYXBwZWRFcnJiYWNrKHJlYXNvbikpOwogICAgICAgIH0sIGZ1bmN0aW9uKHByb2dyZXNzKSB7CiAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwogICAgICAgICAgcmVzdWx0Lm5vdGlmeSh3cmFwcGVkUHJvZ3Jlc3NiYWNrKHByb2dyZXNzKSk7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgfTsKCgogICAgZnVuY3Rpb24gZGVmYXVsdENhbGxiYWNrKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCgogICAgZnVuY3Rpb24gZGVmYXVsdEVycmJhY2socmVhc29uKSB7CiAgICAgIHJldHVybiByZWplY3QocmVhc29uKTsKICAgIH0KCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkcSNhbGwKICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDb21iaW5lcyBtdWx0aXBsZSBwcm9taXNlcyBpbnRvIGEgc2luZ2xlIHByb21pc2UgdGhhdCBpcyByZXNvbHZlZCB3aGVuIGFsbCBvZiB0aGUgaW5wdXQKICAgICAqIHByb21pc2VzIGFyZSByZXNvbHZlZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5LjxQcm9taXNlPnxPYmplY3QuPFByb21pc2U+fSBwcm9taXNlcyBBbiBhcnJheSBvciBoYXNoIG9mIHByb21pc2VzLgogICAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBzaW5nbGUgcHJvbWlzZSB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCBhbiBhcnJheS9oYXNoIG9mIHZhbHVlcywKICAgICAqICAgZWFjaCB2YWx1ZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBwcm9taXNlIGF0IHRoZSBzYW1lIGluZGV4L2tleSBpbiB0aGUgYHByb21pc2VzYCBhcnJheS9oYXNoLgogICAgICogICBJZiBhbnkgb2YgdGhlIHByb21pc2VzIGlzIHJlc29sdmVkIHdpdGggYSByZWplY3Rpb24sIHRoaXMgcmVzdWx0aW5nIHByb21pc2Ugd2lsbCBiZSByZWplY3RlZAogICAgICogICB3aXRoIHRoZSBzYW1lIHJlamVjdGlvbiB2YWx1ZS4KICAgICAqLwogICAgZnVuY3Rpb24gYWxsKHByb21pc2VzKSB7CiAgICAgIHZhciBkZWZlcnJlZCA9IGRlZmVyKCksCiAgICAgICAgY291bnRlciA9IDAsCiAgICAgICAgcmVzdWx0cyA9IGlzQXJyYXkocHJvbWlzZXMpID8gW10gOiB7fTsKCiAgICAgIGZvckVhY2gocHJvbWlzZXMsIGZ1bmN0aW9uKHByb21pc2UsIGtleSkgewogICAgICAgIGNvdW50ZXIrKzsKICAgICAgICByZWYocHJvbWlzZSkudGhlbihmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgaWYgKHJlc3VsdHMuaGFzT3duUHJvcGVydHkoa2V5KSkgcmV0dXJuOwogICAgICAgICAgcmVzdWx0c1trZXldID0gdmFsdWU7CiAgICAgICAgICBpZiAoISgtLWNvdW50ZXIpKSBkZWZlcnJlZC5yZXNvbHZlKHJlc3VsdHMpOwogICAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgaWYgKHJlc3VsdHMuaGFzT3duUHJvcGVydHkoa2V5KSkgcmV0dXJuOwogICAgICAgICAgZGVmZXJyZWQucmVqZWN0KHJlYXNvbik7CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgaWYgKGNvdW50ZXIgPT09IDApIHsKICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHJlc3VsdHMpOwogICAgICB9CgogICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICBkZWZlcjogZGVmZXIsCiAgICAgIHJlamVjdDogcmVqZWN0LAogICAgICB3aGVuOiB3aGVuLAogICAgICBhbGw6IGFsbAogICAgfTsKICB9CgogIGZ1bmN0aW9uICQkUkFGUHJvdmlkZXIoKXsgLy9yQUYKICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckdGltZW91dCcsIGZ1bmN0aW9uKCR3aW5kb3csICR0aW1lb3V0KSB7CiAgICAgIHZhciByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSAkd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICR3aW5kb3cud2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgJHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CgogICAgICB2YXIgY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSAkd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgJHdpbmRvdy53ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICAgICR3aW5kb3cubW96Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAkd2luZG93LndlYmtpdENhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZTsKCiAgICAgIHZhciByYWZTdXBwb3J0ZWQgPSAhIXJlcXVlc3RBbmltYXRpb25GcmFtZTsKICAgICAgdmFyIHJhZiA9IHJhZlN1cHBvcnRlZAogICAgICAgID8gZnVuY3Rpb24oZm4pIHsKICAgICAgICB2YXIgaWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZm4pOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKGlkKTsKICAgICAgICB9OwogICAgICB9CiAgICAgICAgOiBmdW5jdGlvbihmbikgewogICAgICAgIHZhciB0aW1lciA9ICR0aW1lb3V0KGZuLCAxNi42NiwgZmFsc2UpOyAvLyAxMDAwIC8gNjAgPSAxNi42NjYKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAkdGltZW91dC5jYW5jZWwodGltZXIpOwogICAgICAgIH07CiAgICAgIH07CgogICAgICByYWYuc3VwcG9ydGVkID0gcmFmU3VwcG9ydGVkOwoKICAgICAgcmV0dXJuIHJhZjsKICAgIH1dOwogIH0KCiAgLyoqCiAgICogREVTSUdOIE5PVEVTCiAgICoKICAgKiBUaGUgZGVzaWduIGRlY2lzaW9ucyBiZWhpbmQgdGhlIHNjb3BlIGFyZSBoZWF2aWx5IGZhdm9yZWQgZm9yIHNwZWVkIGFuZCBtZW1vcnkgY29uc3VtcHRpb24uCiAgICoKICAgKiBUaGUgdHlwaWNhbCB1c2Ugb2Ygc2NvcGUgaXMgdG8gd2F0Y2ggdGhlIGV4cHJlc3Npb25zLCB3aGljaCBtb3N0IG9mIHRoZSB0aW1lIHJldHVybiB0aGUgc2FtZQogICAqIHZhbHVlIGFzIGxhc3QgdGltZSBzbyB3ZSBvcHRpbWl6ZSB0aGUgb3BlcmF0aW9uLgogICAqCiAgICogQ2xvc3VyZXMgY29uc3RydWN0aW9uIGlzIGV4cGVuc2l2ZSBpbiB0ZXJtcyBvZiBzcGVlZCBhcyB3ZWxsIGFzIG1lbW9yeToKICAgKiAgIC0gTm8gY2xvc3VyZXMsIGluc3RlYWQgdXNlIHByb3RvdHlwaWNhbCBpbmhlcml0YW5jZSBmb3IgQVBJCiAgICogICAtIEludGVybmFsIHN0YXRlIG5lZWRzIHRvIGJlIHN0b3JlZCBvbiBzY29wZSBkaXJlY3RseSwgd2hpY2ggbWVhbnMgdGhhdCBwcml2YXRlIHN0YXRlIGlzCiAgICogICAgIGV4cG9zZWQgYXMgJCRfX19fIHByb3BlcnRpZXMKICAgKgogICAqIExvb3Agb3BlcmF0aW9ucyBhcmUgb3B0aW1pemVkIGJ5IHVzaW5nIHdoaWxlKGNvdW50LS0pIHsgLi4uIH0KICAgKiAgIC0gdGhpcyBtZWFucyB0aGF0IGluIG9yZGVyIHRvIGtlZXAgdGhlIHNhbWUgb3JkZXIgb2YgZXhlY3V0aW9uIGFzIGFkZGl0aW9uIHdlIGhhdmUgdG8gYWRkCiAgICogICAgIGl0ZW1zIHRvIHRoZSBhcnJheSBhdCB0aGUgYmVnaW5uaW5nICh1bnNoaWZ0KSBpbnN0ZWFkIG9mIGF0IHRoZSBlbmQgKHB1c2gpCiAgICoKICAgKiBDaGlsZCBzY29wZXMgYXJlIGNyZWF0ZWQgYW5kIHJlbW92ZWQgb2Z0ZW4KICAgKiAgIC0gVXNpbmcgYW4gYXJyYXkgd291bGQgYmUgc2xvdyBzaW5jZSBpbnNlcnRzIGluIG1pZGRsZSBhcmUgZXhwZW5zaXZlIHNvIHdlIHVzZSBsaW5rZWQgbGlzdAogICAqCiAgICogVGhlcmUgYXJlIGZldyB3YXRjaGVzIHRoZW4gYSBsb3Qgb2Ygb2JzZXJ2ZXJzLiBUaGlzIGlzIHdoeSB5b3UgZG9uJ3Qgd2FudCB0aGUgb2JzZXJ2ZXIgdG8gYmUKICAgKiBpbXBsZW1lbnRlZCBpbiB0aGUgc2FtZSB3YXkgYXMgd2F0Y2guIFdhdGNoIHJlcXVpcmVzIHJldHVybiBvZiBpbml0aWFsaXphdGlvbiBmdW5jdGlvbiB3aGljaAogICAqIGFyZSBleHBlbnNpdmUgdG8gY29uc3RydWN0LgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIHByb3ZpZGVyCiAgICogQG5hbWUgJHJvb3RTY29wZVByb3ZpZGVyCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBQcm92aWRlciBmb3IgdGhlICRyb290U2NvcGUgc2VydmljZS4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRyb290U2NvcGVQcm92aWRlciNkaWdlc3RUdGwKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIFNldHMgdGhlIG51bWJlciBvZiBgJGRpZ2VzdGAgaXRlcmF0aW9ucyB0aGUgc2NvcGUgc2hvdWxkIGF0dGVtcHQgdG8gZXhlY3V0ZSBiZWZvcmUgZ2l2aW5nIHVwIGFuZAogICAqIGFzc3VtaW5nIHRoYXQgdGhlIG1vZGVsIGlzIHVuc3RhYmxlLgogICAqCiAgICogVGhlIGN1cnJlbnQgZGVmYXVsdCBpcyAxMCBpdGVyYXRpb25zLgogICAqCiAgICogSW4gY29tcGxleCBhcHBsaWNhdGlvbnMgaXQncyBwb3NzaWJsZSB0aGF0IHRoZSBkZXBlbmRlbmNpZXMgYmV0d2VlbiBgJHdhdGNoYHMgd2lsbCByZXN1bHQgaW4KICAgKiBzZXZlcmFsIGRpZ2VzdCBpdGVyYXRpb25zLiBIb3dldmVyIGlmIGFuIGFwcGxpY2F0aW9uIG5lZWRzIG1vcmUgdGhhbiB0aGUgZGVmYXVsdCAxMCBkaWdlc3QKICAgKiBpdGVyYXRpb25zIGZvciBpdHMgbW9kZWwgdG8gc3RhYmlsaXplIHRoZW4geW91IHNob3VsZCBpbnZlc3RpZ2F0ZSB3aGF0IGlzIGNhdXNpbmcgdGhlIG1vZGVsIHRvCiAgICogY29udGludW91c2x5IGNoYW5nZSBkdXJpbmcgdGhlIGRpZ2VzdC4KICAgKgogICAqIEluY3JlYXNpbmcgdGhlIFRUTCBjb3VsZCBoYXZlIHBlcmZvcm1hbmNlIGltcGxpY2F0aW9ucywgc28geW91IHNob3VsZCBub3QgY2hhbmdlIGl0IHdpdGhvdXQKICAgKiBwcm9wZXIganVzdGlmaWNhdGlvbi4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfSBsaW1pdCBUaGUgbnVtYmVyIG9mIGRpZ2VzdCBpdGVyYXRpb25zLgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkcm9vdFNjb3BlCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBFdmVyeSBhcHBsaWNhdGlvbiBoYXMgYSBzaW5nbGUgcm9vdCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0uCiAgICogQWxsIG90aGVyIHNjb3BlcyBhcmUgZGVzY2VuZGFudCBzY29wZXMgb2YgdGhlIHJvb3Qgc2NvcGUuIFNjb3BlcyBwcm92aWRlIHNlcGFyYXRpb24KICAgKiBiZXR3ZWVuIHRoZSBtb2RlbCBhbmQgdGhlIHZpZXcsIHZpYSBhIG1lY2hhbmlzbSBmb3Igd2F0Y2hpbmcgdGhlIG1vZGVsIGZvciBjaGFuZ2VzLgogICAqIFRoZXkgYWxzbyBwcm92aWRlIGFuIGV2ZW50IGVtaXNzaW9uL2Jyb2FkY2FzdCBhbmQgc3Vic2NyaXB0aW9uIGZhY2lsaXR5LiBTZWUgdGhlCiAgICoge0BsaW5rIGd1aWRlL3Njb3BlIGRldmVsb3BlciBndWlkZSBvbiBzY29wZXN9LgogICAqLwogIGZ1bmN0aW9uICRSb290U2NvcGVQcm92aWRlcigpewogICAgdmFyIFRUTCA9IDEwOwogICAgdmFyICRyb290U2NvcGVNaW5FcnIgPSBtaW5FcnIoJyRyb290U2NvcGUnKTsKICAgIHZhciBsYXN0RGlydHlXYXRjaCA9IG51bGw7CgogICAgdGhpcy5kaWdlc3RUdGwgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIFRUTCA9IHZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBUVEw7CiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRwYXJzZScsICckYnJvd3NlcicsCiAgICAgIGZ1bmN0aW9uKCAkaW5qZWN0b3IsICAgJGV4Y2VwdGlvbkhhbmRsZXIsICAgJHBhcnNlLCAgICRicm93c2VyKSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyB0eXBlCiAgICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZQogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQSByb290IHNjb3BlIGNhbiBiZSByZXRyaWV2ZWQgdXNpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlICRyb290U2NvcGV9IGtleSBmcm9tIHRoZQogICAgICAgICAqIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LiBDaGlsZCBzY29wZXMgYXJlIGNyZWF0ZWQgdXNpbmcgdGhlCiAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG5ldyAkbmV3KCl9IG1ldGhvZC4gKE1vc3Qgc2NvcGVzIGFyZSBjcmVhdGVkIGF1dG9tYXRpY2FsbHkgd2hlbgogICAgICAgICAqIGNvbXBpbGVkIEhUTUwgdGVtcGxhdGUgaXMgZXhlY3V0ZWQuKQogICAgICAgICAqCiAgICAgICAgICogSGVyZSBpcyBhIHNpbXBsZSBzY29wZSBzbmlwcGV0IHRvIHNob3cgaG93IHlvdSBjYW4gaW50ZXJhY3Qgd2l0aCB0aGUgc2NvcGUuCiAgICAgICAgICogYGBgaHRtbAogICAgICAgICAqIDxmaWxlIHNyYz0iLi90ZXN0L25nL3Jvb3RTY29wZVNwZWMuanMiIHRhZz0iZG9jczEiIC8+CiAgICAgICAgICogYGBgCiAgICAgICAgICoKICAgICAgICAgKiAjIEluaGVyaXRhbmNlCiAgICAgICAgICogQSBzY29wZSBjYW4gaW5oZXJpdCBmcm9tIGEgcGFyZW50IHNjb3BlLCBhcyBpbiB0aGlzIGV4YW1wbGU6CiAgICAgICAgICogYGBganMKICAgICAgICAgdmFyIHBhcmVudCA9ICRyb290U2NvcGU7CiAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudC4kbmV3KCk7CgogICAgICAgICBwYXJlbnQuc2FsdXRhdGlvbiA9ICJIZWxsbyI7CiAgICAgICAgIGNoaWxkLm5hbWUgPSAiV29ybGQiOwogICAgICAgICBleHBlY3QoY2hpbGQuc2FsdXRhdGlvbikudG9FcXVhbCgnSGVsbG8nKTsKCiAgICAgICAgIGNoaWxkLnNhbHV0YXRpb24gPSAiV2VsY29tZSI7CiAgICAgICAgIGV4cGVjdChjaGlsZC5zYWx1dGF0aW9uKS50b0VxdWFsKCdXZWxjb21lJyk7CiAgICAgICAgIGV4cGVjdChwYXJlbnQuc2FsdXRhdGlvbikudG9FcXVhbCgnSGVsbG8nKTsKICAgICAgICAgKiBgYGAKICAgICAgICAgKgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgZnVuY3Rpb24oKT49fSBwcm92aWRlcnMgTWFwIG9mIHNlcnZpY2UgZmFjdG9yeSB3aGljaCBuZWVkIHRvIGJlCiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm92aWRlZCBmb3IgdGhlIGN1cnJlbnQgc2NvcGUuIERlZmF1bHRzIHRvIHtAbGluayBuZ30uCiAgICAgICAgICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgKj49fSBpbnN0YW5jZUNhY2hlIFByb3ZpZGVzIHByZS1pbnN0YW50aWF0ZWQgc2VydmljZXMgd2hpY2ggc2hvdWxkCiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBlbmQvb3ZlcnJpZGUgc2VydmljZXMgcHJvdmlkZWQgYnkgYHByb3ZpZGVyc2AuIFRoaXMgaXMgaGFuZHkKICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoZW4gdW5pdC10ZXN0aW5nIGFuZCBoYXZpbmcgdGhlIG5lZWQgdG8gb3ZlcnJpZGUgYSBkZWZhdWx0CiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlLgogICAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9IE5ld2x5IGNyZWF0ZWQgc2NvcGUuCiAgICAgICAgICoKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBTY29wZSgpIHsKICAgICAgICAgIHRoaXMuJGlkID0gbmV4dFVpZCgpOwogICAgICAgICAgdGhpcy4kJHBoYXNlID0gdGhpcy4kcGFyZW50ID0gdGhpcy4kJHdhdGNoZXJzID0KICAgICAgICAgICAgdGhpcy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nID0KICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRIZWFkID0gdGhpcy4kJGNoaWxkVGFpbCA9IG51bGw7CiAgICAgICAgICB0aGlzWyd0aGlzJ10gPSB0aGlzLiRyb290ID0gIHRoaXM7CiAgICAgICAgICB0aGlzLiQkZGVzdHJveWVkID0gZmFsc2U7CiAgICAgICAgICB0aGlzLiQkYXN5bmNRdWV1ZSA9IFtdOwogICAgICAgICAgdGhpcy4kJHBvc3REaWdlc3RRdWV1ZSA9IFtdOwogICAgICAgICAgdGhpcy4kJGxpc3RlbmVycyA9IHt9OwogICAgICAgICAgdGhpcy4kJGxpc3RlbmVyQ291bnQgPSB7fTsKICAgICAgICAgIHRoaXMuJCRpc29sYXRlQmluZGluZ3MgPSB7fTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGlkCiAgICAgICAgICogQHJldHVybnMge251bWJlcn0gVW5pcXVlIHNjb3BlIElEIChtb25vdG9uaWNhbGx5IGluY3JlYXNpbmcgYWxwaGFudW1lcmljIHNlcXVlbmNlKSB1c2VmdWwgZm9yCiAgICAgICAgICogICBkZWJ1Z2dpbmcuCiAgICAgICAgICovCgoKICAgICAgICBTY29wZS5wcm90b3R5cGUgPSB7CiAgICAgICAgICBjb25zdHJ1Y3RvcjogU2NvcGUsCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJG5ldwogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIENyZWF0ZXMgYSBuZXcgY2hpbGQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUgc2NvcGV9LgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoZSBwYXJlbnQgc2NvcGUgd2lsbCBwcm9wYWdhdGUgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBhbmQKICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBldmVudHMuIFRoZSBzY29wZSBjYW4gYmUgcmVtb3ZlZCBmcm9tIHRoZQogICAgICAgICAgICogc2NvcGUgaGllcmFyY2h5IHVzaW5nIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9LgogICAgICAgICAgICoKICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95ICRkZXN0cm95KCl9IG11c3QgYmUgY2FsbGVkIG9uIGEgc2NvcGUgd2hlbiBpdCBpcwogICAgICAgICAgICogZGVzaXJlZCBmb3IgdGhlIHNjb3BlIGFuZCBpdHMgY2hpbGQgc2NvcGVzIHRvIGJlIHBlcm1hbmVudGx5IGRldGFjaGVkIGZyb20gdGhlIHBhcmVudCBhbmQKICAgICAgICAgICAqIHRodXMgc3RvcCBwYXJ0aWNpcGF0aW5nIGluIG1vZGVsIGNoYW5nZSBkZXRlY3Rpb24gYW5kIGxpc3RlbmVyIG5vdGlmaWNhdGlvbiBieSBpbnZva2luZy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzb2xhdGUgSWYgdHJ1ZSwgdGhlbiB0aGUgc2NvcGUgZG9lcyBub3QgcHJvdG90eXBpY2FsbHkgaW5oZXJpdCBmcm9tIHRoZQogICAgICAgICAgICogICAgICAgICBwYXJlbnQgc2NvcGUuIFRoZSBzY29wZSBpcyBpc29sYXRlZCwgYXMgaXQgY2FuIG5vdCBzZWUgcGFyZW50IHNjb3BlIHByb3BlcnRpZXMuCiAgICAgICAgICAgKiAgICAgICAgIFdoZW4gY3JlYXRpbmcgd2lkZ2V0cywgaXQgaXMgdXNlZnVsIGZvciB0aGUgd2lkZ2V0IHRvIG5vdCBhY2NpZGVudGFsbHkgcmVhZCBwYXJlbnQKICAgICAgICAgICAqICAgICAgICAgc3RhdGUuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybnMge09iamVjdH0gVGhlIG5ld2x5IGNyZWF0ZWQgY2hpbGQgc2NvcGUuCiAgICAgICAgICAgKgogICAgICAgICAgICovCiAgICAgICAgICAkbmV3OiBmdW5jdGlvbihpc29sYXRlKSB7CiAgICAgICAgICAgIHZhciBDaGlsZFNjb3BlLAogICAgICAgICAgICAgIGNoaWxkOwoKICAgICAgICAgICAgaWYgKGlzb2xhdGUpIHsKICAgICAgICAgICAgICBjaGlsZCA9IG5ldyBTY29wZSgpOwogICAgICAgICAgICAgIGNoaWxkLiRyb290ID0gdGhpcy4kcm9vdDsKICAgICAgICAgICAgICAvLyBlbnN1cmUgdGhhdCB0aGVyZSBpcyBqdXN0IG9uZSBhc3luYyBxdWV1ZSBwZXIgJHJvb3RTY29wZSBhbmQgaXRzIGNoaWxkcmVuCiAgICAgICAgICAgICAgY2hpbGQuJCRhc3luY1F1ZXVlID0gdGhpcy4kJGFzeW5jUXVldWU7CiAgICAgICAgICAgICAgY2hpbGQuJCRwb3N0RGlnZXN0UXVldWUgPSB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIE9ubHkgY3JlYXRlIGEgY2hpbGQgc2NvcGUgY2xhc3MgaWYgc29tZWJvZHkgYXNrcyBmb3Igb25lLAogICAgICAgICAgICAgIC8vIGJ1dCBjYWNoZSBpdCB0byBhbGxvdyB0aGUgVk0gdG8gb3B0aW1pemUgbG9va3Vwcy4KICAgICAgICAgICAgICBpZiAoIXRoaXMuJCRjaGlsZFNjb3BlQ2xhc3MpIHsKICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFNjb3BlQ2xhc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhpcy4kJHdhdGNoZXJzID0gdGhpcy4kJG5leHRTaWJsaW5nID0KICAgICAgICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRIZWFkID0gdGhpcy4kJGNoaWxkVGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgICAgIHRoaXMuJCRsaXN0ZW5lcnMgPSB7fTsKICAgICAgICAgICAgICAgICAgdGhpcy4kJGxpc3RlbmVyQ291bnQgPSB7fTsKICAgICAgICAgICAgICAgICAgdGhpcy4kaWQgPSBuZXh0VWlkKCk7CiAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFNjb3BlQ2xhc3MgPSBudWxsOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFNjb3BlQ2xhc3MucHJvdG90eXBlID0gdGhpczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSBuZXcgdGhpcy4kJGNoaWxkU2NvcGVDbGFzcygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoaWxkWyd0aGlzJ10gPSBjaGlsZDsKICAgICAgICAgICAgY2hpbGQuJHBhcmVudCA9IHRoaXM7CiAgICAgICAgICAgIGNoaWxkLiQkcHJldlNpYmxpbmcgPSB0aGlzLiQkY2hpbGRUYWlsOwogICAgICAgICAgICBpZiAodGhpcy4kJGNoaWxkSGVhZCkgewogICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwuJCRuZXh0U2libGluZyA9IGNoaWxkOwogICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLiQkY2hpbGRIZWFkID0gdGhpcy4kJGNoaWxkVGFpbCA9IGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyR3YXRjaAogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFJlZ2lzdGVycyBhIGBsaXN0ZW5lcmAgY2FsbGJhY2sgdG8gYmUgZXhlY3V0ZWQgd2hlbmV2ZXIgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGNoYW5nZXMuCiAgICAgICAgICAgKgogICAgICAgICAgICogLSBUaGUgYHdhdGNoRXhwcmVzc2lvbmAgaXMgY2FsbGVkIG9uIGV2ZXJ5IGNhbGwgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdAogICAgICAgKiAgICRkaWdlc3QoKX0gYW5kIHNob3VsZCByZXR1cm4gdGhlIHZhbHVlIHRoYXQgd2lsbCBiZSB3YXRjaGVkLiAoU2luY2UKICAgICAgICAgICAqICAge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IHJlcnVucyB3aGVuIGl0IGRldGVjdHMgY2hhbmdlcyB0aGUKICAgICAgICAgICAqICAgYHdhdGNoRXhwcmVzc2lvbmAgY2FuIGV4ZWN1dGUgbXVsdGlwbGUgdGltZXMgcGVyCiAgICAgICAgICAgKiAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBhbmQgc2hvdWxkIGJlIGlkZW1wb3RlbnQuKQogICAgICAgICAgICogLSBUaGUgYGxpc3RlbmVyYCBpcyBjYWxsZWQgb25seSB3aGVuIHRoZSB2YWx1ZSBmcm9tIHRoZSBjdXJyZW50IGB3YXRjaEV4cHJlc3Npb25gIGFuZCB0aGUKICAgICAgICAgICAqICAgcHJldmlvdXMgY2FsbCB0byBgd2F0Y2hFeHByZXNzaW9uYCBhcmUgbm90IGVxdWFsICh3aXRoIHRoZSBleGNlcHRpb24gb2YgdGhlIGluaXRpYWwgcnVuLAogICAgICAgICAgICogICBzZWUgYmVsb3cpLiBJbmVxdWFsaXR5IGlzIGRldGVybWluZWQgYWNjb3JkaW5nIHRvIHJlZmVyZW5jZSBpbmVxdWFsaXR5LAogICAgICAgICAgICogICBbc3RyaWN0IGNvbXBhcmlzb25dKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL09wZXJhdG9ycy9Db21wYXJpc29uX09wZXJhdG9ycykKICAgICAgICAgICAqICAgIHZpYSB0aGUgYCE9PWAgSmF2YXNjcmlwdCBvcGVyYXRvciwgdW5sZXNzIGBvYmplY3RFcXVhbGl0eSA9PSB0cnVlYAogICAgICAgICAgICogICAoc2VlIG5leHQgcG9pbnQpCiAgICAgICAgICAgKiAtIFdoZW4gYG9iamVjdEVxdWFsaXR5ID09IHRydWVgLCBpbmVxdWFsaXR5IG9mIHRoZSBgd2F0Y2hFeHByZXNzaW9uYCBpcyBkZXRlcm1pbmVkCiAgICAgICAgICAgKiAgIGFjY29yZGluZyB0byB0aGUge0BsaW5rIGFuZ3VsYXIuZXF1YWxzfSBmdW5jdGlvbi4gVG8gc2F2ZSB0aGUgdmFsdWUgb2YgdGhlIG9iamVjdCBmb3IKICAgICAgICAgICAqICAgbGF0ZXIgY29tcGFyaXNvbiwgdGhlIHtAbGluayBhbmd1bGFyLmNvcHl9IGZ1bmN0aW9uIGlzIHVzZWQuIFRoaXMgdGhlcmVmb3JlIG1lYW5zIHRoYXQKICAgICAgICAgICAqICAgd2F0Y2hpbmcgY29tcGxleCBvYmplY3RzIHdpbGwgaGF2ZSBhZHZlcnNlIG1lbW9yeSBhbmQgcGVyZm9ybWFuY2UgaW1wbGljYXRpb25zLgogICAgICAgICAgICogLSBUaGUgd2F0Y2ggYGxpc3RlbmVyYCBtYXkgY2hhbmdlIHRoZSBtb2RlbCwgd2hpY2ggbWF5IHRyaWdnZXIgb3RoZXIgYGxpc3RlbmVyYHMgdG8gZmlyZS4KICAgICAgICAgICAqICAgVGhpcyBpcyBhY2hpZXZlZCBieSByZXJ1bm5pbmcgdGhlIHdhdGNoZXJzIHVudGlsIG5vIGNoYW5nZXMgYXJlIGRldGVjdGVkLiBUaGUgcmVydW4KICAgICAgICAgICAqICAgaXRlcmF0aW9uIGxpbWl0IGlzIDEwIHRvIHByZXZlbnQgYW4gaW5maW5pdGUgbG9vcCBkZWFkbG9jay4KICAgICAgICAgICAqCiAgICAgICAgICAgKgogICAgICAgICAgICogSWYgeW91IHdhbnQgdG8gYmUgbm90aWZpZWQgd2hlbmV2ZXIge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0fSBpcyBjYWxsZWQsCiAgICAgICAgICAgKiB5b3UgY2FuIHJlZ2lzdGVyIGEgYHdhdGNoRXhwcmVzc2lvbmAgZnVuY3Rpb24gd2l0aCBubyBgbGlzdGVuZXJgLiAoU2luY2UgYHdhdGNoRXhwcmVzc2lvbmAKICAgICAgICAgICAqIGNhbiBleGVjdXRlIG11bHRpcGxlIHRpbWVzIHBlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlIHdoZW4gYQogICAgICAgICAgICogY2hhbmdlIGlzIGRldGVjdGVkLCBiZSBwcmVwYXJlZCBmb3IgbXVsdGlwbGUgY2FsbHMgdG8geW91ciBsaXN0ZW5lci4pCiAgICAgICAgICAgKgogICAgICAgICAgICogQWZ0ZXIgYSB3YXRjaGVyIGlzIHJlZ2lzdGVyZWQgd2l0aCB0aGUgc2NvcGUsIHRoZSBgbGlzdGVuZXJgIGZuIGlzIGNhbGxlZCBhc3luY2hyb25vdXNseQogICAgICAgICAgICogKHZpYSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZXZhbEFzeW5jICRldmFsQXN5bmN9KSB0byBpbml0aWFsaXplIHRoZQogICAgICAgICAgICogd2F0Y2hlci4gSW4gcmFyZSBjYXNlcywgdGhpcyBpcyB1bmRlc2lyYWJsZSBiZWNhdXNlIHRoZSBsaXN0ZW5lciBpcyBjYWxsZWQgd2hlbiB0aGUgcmVzdWx0CiAgICAgICAgICAgKiBvZiBgd2F0Y2hFeHByZXNzaW9uYCBkaWRuJ3QgY2hhbmdlLiBUbyBkZXRlY3QgdGhpcyBzY2VuYXJpbyB3aXRoaW4gdGhlIGBsaXN0ZW5lcmAgZm4sIHlvdQogICAgICAgICAgICogY2FuIGNvbXBhcmUgdGhlIGBuZXdWYWxgIGFuZCBgb2xkVmFsYC4gSWYgdGhlc2UgdHdvIHZhbHVlcyBhcmUgaWRlbnRpY2FsIChgPT09YCkgdGhlbiB0aGUKICAgICAgICAgICAqIGxpc3RlbmVyIHdhcyBjYWxsZWQgZHVlIHRvIGluaXRpYWxpemF0aW9uLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoZSBleGFtcGxlIGJlbG93IGNvbnRhaW5zIGFuIGlsbHVzdHJhdGlvbiBvZiB1c2luZyBhIGZ1bmN0aW9uIGFzIHlvdXIgJHdhdGNoIGxpc3RlbmVyCiAgICAgICAgICAgKgogICAgICAgICAgICoKICAgICAgICAgICAqICMgRXhhbXBsZQogICAgICAgICAgICogYGBganMKICAgICAgICAgICAvLyBsZXQncyBhc3N1bWUgdGhhdCBzY29wZSB3YXMgZGVwZW5kZW5jeSBpbmplY3RlZCBhcyB0aGUgJHJvb3RTY29wZQogICAgICAgICAgIHZhciBzY29wZSA9ICRyb290U2NvcGU7CiAgICAgICAgICAgc2NvcGUubmFtZSA9ICdtaXNrbyc7CiAgICAgICAgICAgc2NvcGUuY291bnRlciA9IDA7CgogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgIHNjb3BlLiR3YXRjaCgnbmFtZScsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IHNjb3BlLmNvdW50ZXIgKyAxOwogICAgICAgICAgIH0pOwogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgLy8gdGhlIGxpc3RlbmVyIGlzIGFsd2F5cyBjYWxsZWQgZHVyaW5nIHRoZSBmaXJzdCAkZGlnZXN0IGxvb3AgYWZ0ZXIgaXQgd2FzIHJlZ2lzdGVyZWQKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKCiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIC8vIGJ1dCBub3cgaXQgd2lsbCBub3QgYmUgY2FsbGVkIHVubGVzcyB0aGUgdmFsdWUgY2hhbmdlcwogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwoKICAgICAgICAgICBzY29wZS5uYW1lID0gJ2FkYW0nOwogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgyKTsKCgoKICAgICAgICAgICAvLyBVc2luZyBhIGxpc3RlbmVyIGZ1bmN0aW9uCiAgICAgICAgICAgdmFyIGZvb2Q7CiAgICAgICAgICAgc2NvcGUuZm9vZENvdW50ZXIgPSAwOwogICAgICAgICAgIGV4cGVjdChzY29wZS5mb29kQ291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICBzY29wZS4kd2F0Y2goCiAgICAgICAgICAgLy8gVGhpcyBpcyB0aGUgbGlzdGVuZXIgZnVuY3Rpb24KICAgICAgICAgICBmdW5jdGlvbigpIHsgcmV0dXJuIGZvb2Q7IH0sCiAgICAgICAgICAgLy8gVGhpcyBpcyB0aGUgY2hhbmdlIGhhbmRsZXIKICAgICAgICAgICBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgaWYgKCBuZXdWYWx1ZSAhPT0gb2xkVmFsdWUgKSB7CiAgICAgICAgICAgICAgICAgLy8gT25seSBpbmNyZW1lbnQgdGhlIGNvdW50ZXIgaWYgdGhlIHZhbHVlIGNoYW5nZWQKICAgICAgICAgICAgICAgICBzY29wZS5mb29kQ291bnRlciA9IHNjb3BlLmZvb2RDb3VudGVyICsgMTsKICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgfQogICAgICAgICAgICk7CiAgICAgICAgICAgLy8gTm8gZGlnZXN0IGhhcyBiZWVuIHJ1biBzbyB0aGUgY291bnRlciB3aWxsIGJlIHplcm8KICAgICAgICAgICBleHBlY3Qoc2NvcGUuZm9vZENvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgIC8vIFJ1biB0aGUgZGlnZXN0IGJ1dCBzaW5jZSBmb29kIGhhcyBub3QgY2hhbmdlZCBjb3VudCB3aWxsIHN0aWxsIGJlIHplcm8KICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmZvb2RDb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICAvLyBVcGRhdGUgZm9vZCBhbmQgcnVuIGRpZ2VzdC4gIE5vdyB0aGUgY291bnRlciB3aWxsIGluY3JlbWVudAogICAgICAgICAgIGZvb2QgPSAnY2hlZXNlYnVyZ2VyJzsKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmZvb2RDb3VudGVyKS50b0VxdWFsKDEpOwoKICAgICAgICAgICAqIGBgYAogICAgICAgICAgICoKICAgICAgICAgICAqCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHsoZnVuY3Rpb24oKXxzdHJpbmcpfSB3YXRjaEV4cHJlc3Npb24gRXhwcmVzc2lvbiB0aGF0IGlzIGV2YWx1YXRlZCBvbiBlYWNoCiAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlLiBBIGNoYW5nZSBpbiB0aGUgcmV0dXJuIHZhbHVlIHRyaWdnZXJzCiAgICAgICAgICAgKiAgICBhIGNhbGwgdG8gdGhlIGBsaXN0ZW5lcmAuCiAgICAgICAgICAgKgogICAgICAgICAgICogICAgLSBgc3RyaW5nYDogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259CiAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBjYWxsZWQgd2l0aCBjdXJyZW50IGBzY29wZWAgYXMgYSBwYXJhbWV0ZXIuCiAgICAgICAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfHN0cmluZyk9fSBsaXN0ZW5lciBDYWxsYmFjayBjYWxsZWQgd2hlbmV2ZXIgdGhlIHJldHVybiB2YWx1ZSBvZgogICAgICAgICAgICogICB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2hhbmdlcy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBFdmFsdWF0ZWQgYXMge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0KICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSwgc2NvcGUpYDogY2FsbGVkIHdpdGggY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWVzIGFzCiAgICAgICAgICAgKiAgICAgIHBhcmFtZXRlcnMuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gb2JqZWN0RXF1YWxpdHkgQ29tcGFyZSBmb3Igb2JqZWN0IGVxdWFsaXR5IHVzaW5nIHtAbGluayBhbmd1bGFyLmVxdWFsc30gaW5zdGVhZCBvZgogICAgICAgICAgICogICAgIGNvbXBhcmluZyBmb3IgcmVmZXJlbmNlIGVxdWFsaXR5LgogICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4KICAgICAgICAgICAqLwogICAgICAgICAgJHdhdGNoOiBmdW5jdGlvbih3YXRjaEV4cCwgbGlzdGVuZXIsIG9iamVjdEVxdWFsaXR5KSB7CiAgICAgICAgICAgIHZhciBzY29wZSA9IHRoaXMsCiAgICAgICAgICAgICAgZ2V0ID0gY29tcGlsZVRvRm4od2F0Y2hFeHAsICd3YXRjaCcpLAogICAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycywKICAgICAgICAgICAgICB3YXRjaGVyID0gewogICAgICAgICAgICAgICAgZm46IGxpc3RlbmVyLAogICAgICAgICAgICAgICAgbGFzdDogaW5pdFdhdGNoVmFsLAogICAgICAgICAgICAgICAgZ2V0OiBnZXQsCiAgICAgICAgICAgICAgICBleHA6IHdhdGNoRXhwLAogICAgICAgICAgICAgICAgZXE6ICEhb2JqZWN0RXF1YWxpdHkKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgbGFzdERpcnR5V2F0Y2ggPSBudWxsOwoKICAgICAgICAgICAgLy8gaW4gdGhlIGNhc2UgdXNlciBwYXNzIHN0cmluZywgd2UgbmVlZCB0byBjb21waWxlIGl0LCBkbyB3ZSByZWFsbHkgbmVlZCB0aGlzID8KICAgICAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkgewogICAgICAgICAgICAgIHZhciBsaXN0ZW5GbiA9IGNvbXBpbGVUb0ZuKGxpc3RlbmVyIHx8IG5vb3AsICdsaXN0ZW5lcicpOwogICAgICAgICAgICAgIHdhdGNoZXIuZm4gPSBmdW5jdGlvbihuZXdWYWwsIG9sZFZhbCwgc2NvcGUpIHtsaXN0ZW5GbihzY29wZSk7fTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiB3YXRjaEV4cCA9PSAnc3RyaW5nJyAmJiBnZXQuY29uc3RhbnQpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxGbiA9IHdhdGNoZXIuZm47CiAgICAgICAgICAgICAgd2F0Y2hlci5mbiA9IGZ1bmN0aW9uKG5ld1ZhbCwgb2xkVmFsLCBzY29wZSkgewogICAgICAgICAgICAgICAgb3JpZ2luYWxGbi5jYWxsKHRoaXMsIG5ld1ZhbCwgb2xkVmFsLCBzY29wZSk7CiAgICAgICAgICAgICAgICBhcnJheVJlbW92ZShhcnJheSwgd2F0Y2hlcik7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFhcnJheSkgewogICAgICAgICAgICAgIGFycmF5ID0gc2NvcGUuJCR3YXRjaGVycyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHdlIHVzZSB1bnNoaWZ0IHNpbmNlIHdlIHVzZSBhIHdoaWxlIGxvb3AgaW4gJGRpZ2VzdCBmb3Igc3BlZWQuCiAgICAgICAgICAgIC8vIHRoZSB3aGlsZSBsb29wIHJlYWRzIGluIHJldmVyc2Ugb3JkZXIuCiAgICAgICAgICAgIGFycmF5LnVuc2hpZnQod2F0Y2hlcik7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gZGVyZWdpc3RlcldhdGNoKCkgewogICAgICAgICAgICAgIGFycmF5UmVtb3ZlKGFycmF5LCB3YXRjaGVyKTsKICAgICAgICAgICAgICBsYXN0RGlydHlXYXRjaCA9IG51bGw7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9LAoKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJHdhdGNoQ29sbGVjdGlvbgogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFNoYWxsb3cgd2F0Y2hlcyB0aGUgcHJvcGVydGllcyBvZiBhbiBvYmplY3QgYW5kIGZpcmVzIHdoZW5ldmVyIGFueSBvZiB0aGUgcHJvcGVydGllcyBjaGFuZ2UKICAgICAgICAgICAqIChmb3IgYXJyYXlzLCB0aGlzIGltcGxpZXMgd2F0Y2hpbmcgdGhlIGFycmF5IGl0ZW1zOyBmb3Igb2JqZWN0IG1hcHMsIHRoaXMgaW1wbGllcyB3YXRjaGluZwogICAgICAgICAgICogdGhlIHByb3BlcnRpZXMpLiBJZiBhIGNoYW5nZSBpcyBkZXRlY3RlZCwgdGhlIGBsaXN0ZW5lcmAgY2FsbGJhY2sgaXMgZmlyZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogLSBUaGUgYG9iamAgY29sbGVjdGlvbiBpcyBvYnNlcnZlZCB2aWEgc3RhbmRhcmQgJHdhdGNoIG9wZXJhdGlvbiBhbmQgaXMgZXhhbWluZWQgb24gZXZlcnkKICAgICAgICAgICAqICAgY2FsbCB0byAkZGlnZXN0KCkgdG8gc2VlIGlmIGFueSBpdGVtcyBoYXZlIGJlZW4gYWRkZWQsIHJlbW92ZWQsIG9yIG1vdmVkLgogICAgICAgICAgICogLSBUaGUgYGxpc3RlbmVyYCBpcyBjYWxsZWQgd2hlbmV2ZXIgYW55dGhpbmcgd2l0aGluIHRoZSBgb2JqYCBoYXMgY2hhbmdlZC4gRXhhbXBsZXMgaW5jbHVkZQogICAgICAgICAgICogICBhZGRpbmcsIHJlbW92aW5nLCBhbmQgbW92aW5nIGl0ZW1zIGJlbG9uZ2luZyB0byBhbiBvYmplY3Qgb3IgYXJyYXkuCiAgICAgICAgICAgKgogICAgICAgICAgICoKICAgICAgICAgICAqICMgRXhhbXBsZQogICAgICAgICAgICogYGBganMKICAgICAgICAgICAkc2NvcGUubmFtZXMgPSBbJ2lnb3InLCAnbWF0aWFzJywgJ21pc2tvJywgJ2phbWVzJ107CiAgICAgICAgICAgJHNjb3BlLmRhdGFDb3VudCA9IDQ7CgogICAgICAgICAgICRzY29wZS4kd2F0Y2hDb2xsZWN0aW9uKCduYW1lcycsIGZ1bmN0aW9uKG5ld05hbWVzLCBvbGROYW1lcykgewogICAgICAgICAgICAkc2NvcGUuZGF0YUNvdW50ID0gbmV3TmFtZXMubGVuZ3RoOwogICAgICAgICAgfSk7CgogICAgICAgICAgIGV4cGVjdCgkc2NvcGUuZGF0YUNvdW50KS50b0VxdWFsKDQpOwogICAgICAgICAgICRzY29wZS4kZGlnZXN0KCk7CgogICAgICAgICAgIC8vc3RpbGwgYXQgNCAuLi4gbm8gY2hhbmdlcwogICAgICAgICAgIGV4cGVjdCgkc2NvcGUuZGF0YUNvdW50KS50b0VxdWFsKDQpOwoKICAgICAgICAgICAkc2NvcGUubmFtZXMucG9wKCk7CiAgICAgICAgICAgJHNjb3BlLiRkaWdlc3QoKTsKCiAgICAgICAgICAgLy9ub3cgdGhlcmUncyBiZWVuIGEgY2hhbmdlCiAgICAgICAgICAgZXhwZWN0KCRzY29wZS5kYXRhQ291bnQpLnRvRXF1YWwoMyk7CiAgICAgICAgICAgKiBgYGAKICAgICAgICAgICAqCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8ZnVuY3Rpb24oc2NvcGUpfSBvYmogRXZhbHVhdGVkIGFzIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LiBUaGUKICAgICAgICAgICAqICAgIGV4cHJlc3Npb24gdmFsdWUgc2hvdWxkIGV2YWx1YXRlIHRvIGFuIG9iamVjdCBvciBhbiBhcnJheSB3aGljaCBpcyBvYnNlcnZlZCBvbiBlYWNoCiAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGN5Y2xlLiBBbnkgc2hhbGxvdyBjaGFuZ2Ugd2l0aGluIHRoZQogICAgICAgICAgICogICAgY29sbGVjdGlvbiB3aWxsIHRyaWdnZXIgYSBjYWxsIHRvIHRoZSBgbGlzdGVuZXJgLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24obmV3Q29sbGVjdGlvbiwgb2xkQ29sbGVjdGlvbiwgc2NvcGUpfSBsaXN0ZW5lciBhIGNhbGxiYWNrIGZ1bmN0aW9uIGNhbGxlZAogICAgICAgICAgICogICAgd2hlbiBhIGNoYW5nZSBpcyBkZXRlY3RlZC4KICAgICAgICAgICAqICAgIC0gVGhlIGBuZXdDb2xsZWN0aW9uYCBvYmplY3QgaXMgdGhlIG5ld2x5IG1vZGlmaWVkIGRhdGEgb2J0YWluZWQgZnJvbSB0aGUgYG9iamAgZXhwcmVzc2lvbgogICAgICAgICAgICogICAgLSBUaGUgYG9sZENvbGxlY3Rpb25gIG9iamVjdCBpcyBhIGNvcHkgb2YgdGhlIGZvcm1lciBjb2xsZWN0aW9uIGRhdGEuCiAgICAgICAgICAgKiAgICAgIER1ZSB0byBwZXJmb3JtYW5jZSBjb25zaWRlcmF0aW9ucywgdGhlYG9sZENvbGxlY3Rpb25gIHZhbHVlIGlzIGNvbXB1dGVkIG9ubHkgaWYgdGhlCiAgICAgICAgICAgKiAgICAgIGBsaXN0ZW5lcmAgZnVuY3Rpb24gZGVjbGFyZXMgdHdvIG9yIG1vcmUgYXJndW1lbnRzLgogICAgICAgICAgICogICAgLSBUaGUgYHNjb3BlYCBhcmd1bWVudCByZWZlcnMgdG8gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZS1yZWdpc3RyYXRpb24gZnVuY3Rpb24gZm9yIHRoaXMgbGlzdGVuZXIuIFdoZW4gdGhlCiAgICAgICAgICAgKiAgICBkZS1yZWdpc3RyYXRpb24gZnVuY3Rpb24gaXMgZXhlY3V0ZWQsIHRoZSBpbnRlcm5hbCB3YXRjaCBvcGVyYXRpb24gaXMgdGVybWluYXRlZC4KICAgICAgICAgICAqLwogICAgICAgICAgJHdhdGNoQ29sbGVjdGlvbjogZnVuY3Rpb24ob2JqLCBsaXN0ZW5lcikgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgIC8vIHRoZSBjdXJyZW50IHZhbHVlLCB1cGRhdGVkIG9uIGVhY2ggZGlydHktY2hlY2sgcnVuCiAgICAgICAgICAgIHZhciBuZXdWYWx1ZTsKICAgICAgICAgICAgLy8gYSBzaGFsbG93IGNvcHkgb2YgdGhlIG5ld1ZhbHVlIGZyb20gdGhlIGxhc3QgZGlydHktY2hlY2sgcnVuLAogICAgICAgICAgICAvLyB1cGRhdGVkIHRvIG1hdGNoIG5ld1ZhbHVlIGR1cmluZyBkaXJ0eS1jaGVjayBydW4KICAgICAgICAgICAgdmFyIG9sZFZhbHVlOwogICAgICAgICAgICAvLyBhIHNoYWxsb3cgY29weSBvZiB0aGUgbmV3VmFsdWUgZnJvbSB3aGVuIHRoZSBsYXN0IGNoYW5nZSBoYXBwZW5lZAogICAgICAgICAgICB2YXIgdmVyeU9sZFZhbHVlOwogICAgICAgICAgICAvLyBvbmx5IHRyYWNrIHZlcnlPbGRWYWx1ZSBpZiB0aGUgbGlzdGVuZXIgaXMgYXNraW5nIGZvciBpdAogICAgICAgICAgICB2YXIgdHJhY2tWZXJ5T2xkVmFsdWUgPSAobGlzdGVuZXIubGVuZ3RoID4gMSk7CiAgICAgICAgICAgIHZhciBjaGFuZ2VEZXRlY3RlZCA9IDA7CiAgICAgICAgICAgIHZhciBvYmpHZXR0ZXIgPSAkcGFyc2Uob2JqKTsKICAgICAgICAgICAgdmFyIGludGVybmFsQXJyYXkgPSBbXTsKICAgICAgICAgICAgdmFyIGludGVybmFsT2JqZWN0ID0ge307CiAgICAgICAgICAgIHZhciBpbml0UnVuID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIG9sZExlbmd0aCA9IDA7CgogICAgICAgICAgICBmdW5jdGlvbiAkd2F0Y2hDb2xsZWN0aW9uV2F0Y2goKSB7CiAgICAgICAgICAgICAgbmV3VmFsdWUgPSBvYmpHZXR0ZXIoc2VsZik7CiAgICAgICAgICAgICAgdmFyIG5ld0xlbmd0aCwga2V5OwoKICAgICAgICAgICAgICBpZiAoIWlzT2JqZWN0KG5ld1ZhbHVlKSkgeyAvLyBpZiBwcmltaXRpdmUKICAgICAgICAgICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgb2xkVmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXlMaWtlKG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBpbnRlcm5hbEFycmF5KSB7CiAgICAgICAgICAgICAgICAgIC8vIHdlIGFyZSB0cmFuc2l0aW9uaW5nIGZyb20gc29tZXRoaW5nIHdoaWNoIHdhcyBub3QgYW4gYXJyYXkgaW50byBhcnJheS4KICAgICAgICAgICAgICAgICAgb2xkVmFsdWUgPSBpbnRlcm5hbEFycmF5OwogICAgICAgICAgICAgICAgICBvbGRMZW5ndGggPSBvbGRWYWx1ZS5sZW5ndGggPSAwOwogICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG5ld0xlbmd0aCA9IG5ld1ZhbHVlLmxlbmd0aDsKCiAgICAgICAgICAgICAgICBpZiAob2xkTGVuZ3RoICE9PSBuZXdMZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgLy8gaWYgbGVuZ3RocyBkbyBub3QgbWF0Y2ggd2UgbmVlZCB0byB0cmlnZ2VyIGNoYW5nZSBub3RpZmljYXRpb24KICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgb2xkVmFsdWUubGVuZ3RoID0gb2xkTGVuZ3RoID0gbmV3TGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gY29weSB0aGUgaXRlbXMgdG8gb2xkVmFsdWUgYW5kIGxvb2sgZm9yIGNoYW5nZXMuCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0xlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBib3RoTmFOID0gKG9sZFZhbHVlW2ldICE9PSBvbGRWYWx1ZVtpXSkgJiYKICAgICAgICAgICAgICAgICAgICAobmV3VmFsdWVbaV0gIT09IG5ld1ZhbHVlW2ldKTsKICAgICAgICAgICAgICAgICAgaWYgKCFib3RoTmFOICYmIChvbGRWYWx1ZVtpXSAhPT0gbmV3VmFsdWVbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgICBvbGRWYWx1ZVtpXSA9IG5ld1ZhbHVlW2ldOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gaW50ZXJuYWxPYmplY3QpIHsKICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIHRyYW5zaXRpb25pbmcgZnJvbSBzb21ldGhpbmcgd2hpY2ggd2FzIG5vdCBhbiBvYmplY3QgaW50byBvYmplY3QuCiAgICAgICAgICAgICAgICAgIG9sZFZhbHVlID0gaW50ZXJuYWxPYmplY3QgPSB7fTsKICAgICAgICAgICAgICAgICAgb2xkTGVuZ3RoID0gMDsKICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGNvcHkgdGhlIGl0ZW1zIHRvIG9sZFZhbHVlIGFuZCBsb29rIGZvciBjaGFuZ2VzLgogICAgICAgICAgICAgICAgbmV3TGVuZ3RoID0gMDsKICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXdWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3TGVuZ3RoKys7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWx1ZVtrZXldICE9PSBuZXdWYWx1ZVtrZXldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgICAgICAgICAgICAgIG9sZFZhbHVlW2tleV0gPSBuZXdWYWx1ZVtrZXldOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBvbGRMZW5ndGgrKzsKICAgICAgICAgICAgICAgICAgICAgIG9sZFZhbHVlW2tleV0gPSBuZXdWYWx1ZVtrZXldOwogICAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvbGRMZW5ndGggPiBuZXdMZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgLy8gd2UgdXNlZCB0byBoYXZlIG1vcmUga2V5cywgbmVlZCB0byBmaW5kIHRoZW0gYW5kIGRlc3Ryb3kgdGhlbS4KICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgZm9yKGtleSBpbiBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChvbGRWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpICYmICFuZXdWYWx1ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICBvbGRMZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBvbGRWYWx1ZVtrZXldOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gY2hhbmdlRGV0ZWN0ZWQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uICR3YXRjaENvbGxlY3Rpb25BY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKGluaXRSdW4pIHsKICAgICAgICAgICAgICAgIGluaXRSdW4gPSBmYWxzZTsKICAgICAgICAgICAgICAgIGxpc3RlbmVyKG5ld1ZhbHVlLCBuZXdWYWx1ZSwgc2VsZik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVyKG5ld1ZhbHVlLCB2ZXJ5T2xkVmFsdWUsIHNlbGYpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gbWFrZSBhIGNvcHkgZm9yIHRoZSBuZXh0IHRpbWUgYSBjb2xsZWN0aW9uIGlzIGNoYW5nZWQKICAgICAgICAgICAgICBpZiAodHJhY2tWZXJ5T2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICghaXNPYmplY3QobmV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgIC8vcHJpbWl0aXZlCiAgICAgICAgICAgICAgICAgIHZlcnlPbGRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5TGlrZShuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgdmVyeU9sZFZhbHVlID0gbmV3IEFycmF5KG5ld1ZhbHVlLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3VmFsdWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB2ZXJ5T2xkVmFsdWVbaV0gPSBuZXdWYWx1ZVtpXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gaWYgb2JqZWN0CiAgICAgICAgICAgICAgICAgIHZlcnlPbGRWYWx1ZSA9IHt9OwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChuZXdWYWx1ZSwga2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgdmVyeU9sZFZhbHVlW2tleV0gPSBuZXdWYWx1ZVtrZXldOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuJHdhdGNoKCR3YXRjaENvbGxlY3Rpb25XYXRjaCwgJHdhdGNoQ29sbGVjdGlvbkFjdGlvbik7CiAgICAgICAgICB9LAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0CiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogUHJvY2Vzc2VzIGFsbCBvZiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJzfSBvZiB0aGUgY3VycmVudCBzY29wZSBhbmQKICAgICAgICAgICAqIGl0cyBjaGlsZHJlbi4gQmVjYXVzZSBhIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyfSdzIGxpc3RlbmVyIGNhbiBjaGFuZ2UKICAgICAgICAgICAqIHRoZSBtb2RlbCwgdGhlIGAkZGlnZXN0KClgIGtlZXBzIGNhbGxpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVyc30KICAgICAgICAgICAqIHVudGlsIG5vIG1vcmUgbGlzdGVuZXJzIGFyZSBmaXJpbmcuIFRoaXMgbWVhbnMgdGhhdCBpdCBpcyBwb3NzaWJsZSB0byBnZXQgaW50byBhbiBpbmZpbml0ZQogICAgICAgICAgICogbG9vcC4gVGhpcyBmdW5jdGlvbiB3aWxsIHRocm93IGAnTWF4aW11bSBpdGVyYXRpb24gbGltaXQgZXhjZWVkZWQuJ2AgaWYgdGhlIG51bWJlciBvZgogICAgICAgICAgICogaXRlcmF0aW9ucyBleGNlZWRzIDEwLgogICAgICAgICAgICoKICAgICAgICAgICAqIFVzdWFsbHksIHlvdSBkb24ndCBjYWxsIGAkZGlnZXN0KClgIGRpcmVjdGx5IGluCiAgICAgICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ29udHJvbGxlciBjb250cm9sbGVyc30gb3IgaW4KICAgICAgICAgICAqIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyI2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4KICAgICAgICAgICAqIEluc3RlYWQsIHlvdSBzaG91bGQgY2FsbCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkYXBwbHkgJGFwcGx5KCl9ICh0eXBpY2FsbHkgZnJvbSB3aXRoaW4KICAgICAgICAgICAqIGEge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlIGRpcmVjdGl2ZXN9KSwgd2hpY2ggd2lsbCBmb3JjZSBhIGAkZGlnZXN0KClgLgogICAgICAgICAgICoKICAgICAgICAgICAqIElmIHlvdSB3YW50IHRvIGJlIG5vdGlmaWVkIHdoZW5ldmVyIGAkZGlnZXN0KClgIGlzIGNhbGxlZCwKICAgICAgICAgICAqIHlvdSBjYW4gcmVnaXN0ZXIgYSBgd2F0Y2hFeHByZXNzaW9uYCBmdW5jdGlvbiB3aXRoCiAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggJHdhdGNoKCl9IHdpdGggbm8gYGxpc3RlbmVyYC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBJbiB1bml0IHRlc3RzLCB5b3UgbWF5IG5lZWQgdG8gY2FsbCBgJGRpZ2VzdCgpYCB0byBzaW11bGF0ZSB0aGUgc2NvcGUgbGlmZSBjeWNsZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiAjIEV4YW1wbGUKICAgICAgICAgICAqIGBgYGpzCiAgICAgICAgICAgdmFyIHNjb3BlID0gLi4uOwogICAgICAgICAgIHNjb3BlLm5hbWUgPSAnbWlza28nOwogICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSAwOwoKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKICAgICAgICAgICBzY29wZS4kd2F0Y2goJ25hbWUnLCBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgIHNjb3BlLmNvdW50ZXIgPSBzY29wZS5jb3VudGVyICsgMTsKICAgICAgICAgICB9KTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgwKTsKCiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIC8vIHRoZSBsaXN0ZW5lciBpcyBhbHdheXMgY2FsbGVkIGR1cmluZyB0aGUgZmlyc3QgJGRpZ2VzdCBsb29wIGFmdGVyIGl0IHdhcyByZWdpc3RlcmVkCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMSk7CgogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAvLyBidXQgbm93IGl0IHdpbGwgbm90IGJlIGNhbGxlZCB1bmxlc3MgdGhlIHZhbHVlIGNoYW5nZXMKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKCiAgICAgICAgICAgc2NvcGUubmFtZSA9ICdhZGFtJzsKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMik7CiAgICAgICAgICAgKiBgYGAKICAgICAgICAgICAqCiAgICAgICAgICAgKi8KICAgICAgICAgICRkaWdlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgd2F0Y2gsIHZhbHVlLCBsYXN0LAogICAgICAgICAgICAgIHdhdGNoZXJzLAogICAgICAgICAgICAgIGFzeW5jUXVldWUgPSB0aGlzLiQkYXN5bmNRdWV1ZSwKICAgICAgICAgICAgICBwb3N0RGlnZXN0UXVldWUgPSB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlLAogICAgICAgICAgICAgIGxlbmd0aCwKICAgICAgICAgICAgICBkaXJ0eSwgdHRsID0gVFRMLAogICAgICAgICAgICAgIG5leHQsIGN1cnJlbnQsIHRhcmdldCA9IHRoaXMsCiAgICAgICAgICAgICAgd2F0Y2hMb2cgPSBbXSwKICAgICAgICAgICAgICBsb2dJZHgsIGxvZ01zZywgYXN5bmNUYXNrOwoKICAgICAgICAgICAgYmVnaW5QaGFzZSgnJGRpZ2VzdCcpOwoKICAgICAgICAgICAgbGFzdERpcnR5V2F0Y2ggPSBudWxsOwoKICAgICAgICAgICAgZG8geyAvLyAid2hpbGUgZGlydHkiIGxvb3AKICAgICAgICAgICAgICBkaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICAgIGN1cnJlbnQgPSB0YXJnZXQ7CgogICAgICAgICAgICAgIHdoaWxlKGFzeW5jUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBhc3luY1Rhc2sgPSBhc3luY1F1ZXVlLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICAgIGFzeW5jVGFzay5zY29wZS4kZXZhbChhc3luY1Rhc2suZXhwcmVzc2lvbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0RGlydHlXYXRjaCA9IG51bGw7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB0cmF2ZXJzZVNjb3Blc0xvb3A6CiAgICAgICAgICAgICAgICBkbyB7IC8vICJ0cmF2ZXJzZSB0aGUgc2NvcGVzIiBsb29wCiAgICAgICAgICAgICAgICAgIGlmICgod2F0Y2hlcnMgPSBjdXJyZW50LiQkd2F0Y2hlcnMpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gcHJvY2VzcyBvdXIgd2F0Y2hlcwogICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHdhdGNoZXJzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoID0gd2F0Y2hlcnNbbGVuZ3RoXTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTW9zdCBjb21tb24gd2F0Y2hlcyBhcmUgb24gcHJpbWl0aXZlcywgaW4gd2hpY2ggY2FzZSB3ZSBjYW4gc2hvcnQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2lyY3VpdCBpdCB3aXRoID09PSBvcGVyYXRvciwgb25seSB3aGVuID09PSBmYWlscyBkbyB3ZSB1c2UgLmVxdWFscwogICAgICAgICAgICAgICAgICAgICAgICBpZiAod2F0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHZhbHVlID0gd2F0Y2guZ2V0KGN1cnJlbnQpKSAhPT0gKGxhc3QgPSB3YXRjaC5sYXN0KSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgISh3YXRjaC5lcQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGVxdWFscyh2YWx1ZSwgbGFzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAodHlwZW9mIHZhbHVlID09ICdudW1iZXInICYmIHR5cGVvZiBsYXN0ID09ICdudW1iZXInCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICYmIGlzTmFOKHZhbHVlKSAmJiBpc05hTihsYXN0KSkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0RGlydHlXYXRjaCA9IHdhdGNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2gubGFzdCA9IHdhdGNoLmVxID8gY29weSh2YWx1ZSwgbnVsbCkgOiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdGNoLmZuKHZhbHVlLCAoKGxhc3QgPT09IGluaXRXYXRjaFZhbCkgPyB2YWx1ZSA6IGxhc3QpLCBjdXJyZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0dGwgPCA1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0lkeCA9IDQgLSB0dGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghd2F0Y2hMb2dbbG9nSWR4XSkgd2F0Y2hMb2dbbG9nSWR4XSA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgPSAoaXNGdW5jdGlvbih3YXRjaC5leHApKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ2ZuOiAnICsgKHdhdGNoLmV4cC5uYW1lIHx8IHdhdGNoLmV4cC50b1N0cmluZygpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogd2F0Y2guZXhwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dNc2cgKz0gJzsgbmV3VmFsOiAnICsgdG9Kc29uKHZhbHVlKSArICc7IG9sZFZhbDogJyArIHRvSnNvbihsYXN0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2hMb2dbbG9nSWR4XS5wdXNoKGxvZ01zZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh3YXRjaCA9PT0gbGFzdERpcnR5V2F0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBtb3N0IHJlY2VudGx5IGRpcnR5IHdhdGNoZXIgaXMgbm93IGNsZWFuLCBzaG9ydCBjaXJjdWl0IHNpbmNlIHRoZSByZW1haW5pbmcgd2F0Y2hlcnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhhdmUgYWxyZWFkeSBiZWVuIHRlc3RlZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayB0cmF2ZXJzZVNjb3Blc0xvb3A7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyBJbnNhbml0eSBXYXJuaW5nOiBzY29wZSBkZXB0aC1maXJzdCB0cmF2ZXJzYWwKICAgICAgICAgICAgICAgICAgLy8geWVzLCB0aGlzIGNvZGUgaXMgYSBiaXQgY3JhenksIGJ1dCBpdCB3b3JrcyBhbmQgd2UgaGF2ZSB0ZXN0cyB0byBwcm92ZSBpdCEKICAgICAgICAgICAgICAgICAgLy8gdGhpcyBwaWVjZSBzaG91bGQgYmUga2VwdCBpbiBzeW5jIHdpdGggdGhlIHRyYXZlcnNhbCBpbiAkYnJvYWRjYXN0CiAgICAgICAgICAgICAgICAgIGlmICghKG5leHQgPSAoY3VycmVudC4kJGNoaWxkSGVhZCB8fAogICAgICAgICAgICAgICAgICAgIChjdXJyZW50ICE9PSB0YXJnZXQgJiYgY3VycmVudC4kJG5leHRTaWJsaW5nKSkpKSB7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IHdoaWxlICgoY3VycmVudCA9IG5leHQpKTsKCiAgICAgICAgICAgICAgLy8gYGJyZWFrIHRyYXZlcnNlU2NvcGVzTG9vcDtgIHRha2VzIHVzIHRvIGhlcmUKCiAgICAgICAgICAgICAgaWYoKGRpcnR5IHx8IGFzeW5jUXVldWUubGVuZ3RoKSAmJiAhKHR0bC0tKSkgewogICAgICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICAgICAgdGhyb3cgJHJvb3RTY29wZU1pbkVycignaW5mZGlnJywKICAgICAgICAgICAgICAgICAgICAnezB9ICRkaWdlc3QoKSBpdGVyYXRpb25zIHJlYWNoZWQuIEFib3J0aW5nIVxuJyArCiAgICAgICAgICAgICAgICAgICAgJ1dhdGNoZXJzIGZpcmVkIGluIHRoZSBsYXN0IDUgaXRlcmF0aW9uczogezF9JywKICAgICAgICAgICAgICAgICAgVFRMLCB0b0pzb24od2F0Y2hMb2cpKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IHdoaWxlIChkaXJ0eSB8fCBhc3luY1F1ZXVlLmxlbmd0aCk7CgogICAgICAgICAgICBjbGVhclBoYXNlKCk7CgogICAgICAgICAgICB3aGlsZShwb3N0RGlnZXN0UXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHBvc3REaWdlc3RRdWV1ZS5zaGlmdCgpKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAoKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveQogICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gc2NvcGUgYmVpbmcgZGVzdHJveWVkCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBCcm9hZGNhc3RlZCB3aGVuIGEgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbiBhcmUgYmVpbmcgZGVzdHJveWVkLgogICAgICAgICAgICoKICAgICAgICAgICAqIE5vdGUgdGhhdCwgaW4gQW5ndWxhckpTLCB0aGVyZSBpcyBhbHNvIGEgYCRkZXN0cm95YCBqUXVlcnkgZXZlbnQsIHdoaWNoIGNhbiBiZSB1c2VkIHRvCiAgICAgICAgICAgKiBjbGVhbiB1cCBET00gYmluZGluZ3MgYmVmb3JlIGFuIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00uCiAgICAgICAgICAgKi8KCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGRlc3Ryb3kKICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBSZW1vdmVzIHRoZSBjdXJyZW50IHNjb3BlIChhbmQgYWxsIG9mIGl0cyBjaGlsZHJlbikgZnJvbSB0aGUgcGFyZW50IHNjb3BlLiBSZW1vdmFsIGltcGxpZXMKICAgICAgICAgICAqIHRoYXQgY2FsbHMgdG8ge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IHdpbGwgbm8gbG9uZ2VyCiAgICAgICAgICAgKiBwcm9wYWdhdGUgdG8gdGhlIGN1cnJlbnQgc2NvcGUgYW5kIGl0cyBjaGlsZHJlbi4gUmVtb3ZhbCBhbHNvIGltcGxpZXMgdGhhdCB0aGUgY3VycmVudAogICAgICAgICAgICogc2NvcGUgaXMgZWxpZ2libGUgZm9yIGdhcmJhZ2UgY29sbGVjdGlvbi4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBUaGUgYCRkZXN0cm95KClgIGlzIHVzdWFsbHkgdXNlZCBieSBkaXJlY3RpdmVzIHN1Y2ggYXMKICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9IGZvciBtYW5hZ2luZyB0aGUKICAgICAgICAgICAqIHVucm9sbGluZyBvZiB0aGUgbG9vcC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBKdXN0IGJlZm9yZSBhIHNjb3BlIGlzIGRlc3Ryb3llZCwgYSBgJGRlc3Ryb3lgIGV2ZW50IGlzIGJyb2FkY2FzdGVkIG9uIHRoaXMgc2NvcGUuCiAgICAgICAgICAgKiBBcHBsaWNhdGlvbiBjb2RlIGNhbiByZWdpc3RlciBhIGAkZGVzdHJveWAgZXZlbnQgaGFuZGxlciB0aGF0IHdpbGwgZ2l2ZSBpdCBhIGNoYW5jZSB0bwogICAgICAgICAgICogcGVyZm9ybSBhbnkgbmVjZXNzYXJ5IGNsZWFudXAuCiAgICAgICAgICAgKgogICAgICAgICAgICogTm90ZSB0aGF0LCBpbiBBbmd1bGFySlMsIHRoZXJlIGlzIGFsc28gYSBgJGRlc3Ryb3lgIGpRdWVyeSBldmVudCwgd2hpY2ggY2FuIGJlIHVzZWQgdG8KICAgICAgICAgICAqIGNsZWFuIHVwIERPTSBiaW5kaW5ncyBiZWZvcmUgYW4gZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTS4KICAgICAgICAgICAqLwogICAgICAgICAgJGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyB3ZSBjYW4ndCBkZXN0cm95IHRoZSByb290IHNjb3BlIG9yIGEgc2NvcGUgdGhhdCBoYXMgYmVlbiBhbHJlYWR5IGRlc3Ryb3llZAogICAgICAgICAgICBpZiAodGhpcy4kJGRlc3Ryb3llZCkgcmV0dXJuOwogICAgICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy4kcGFyZW50OwoKICAgICAgICAgICAgdGhpcy4kYnJvYWRjYXN0KCckZGVzdHJveScpOwogICAgICAgICAgICB0aGlzLiQkZGVzdHJveWVkID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKHRoaXMgPT09ICRyb290U2NvcGUpIHJldHVybjsKCiAgICAgICAgICAgIGZvckVhY2godGhpcy4kJGxpc3RlbmVyQ291bnQsIGJpbmQobnVsbCwgZGVjcmVtZW50TGlzdGVuZXJDb3VudCwgdGhpcykpOwoKICAgICAgICAgICAgLy8gc2V2ZXIgYWxsIHRoZSByZWZlcmVuY2VzIHRvIHBhcmVudCBzY29wZXMgKGFmdGVyIHRoaXMgY2xlYW51cCwgdGhlIGN1cnJlbnQgc2NvcGUgc2hvdWxkCiAgICAgICAgICAgIC8vIG5vdCBiZSByZXRhaW5lZCBieSBhbnkgb2Ygb3VyIHJlZmVyZW5jZXMgYW5kIHNob3VsZCBiZSBlbGlnaWJsZSBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uKQogICAgICAgICAgICBpZiAocGFyZW50LiQkY2hpbGRIZWFkID09IHRoaXMpIHBhcmVudC4kJGNoaWxkSGVhZCA9IHRoaXMuJCRuZXh0U2libGluZzsKICAgICAgICAgICAgaWYgKHBhcmVudC4kJGNoaWxkVGFpbCA9PSB0aGlzKSBwYXJlbnQuJCRjaGlsZFRhaWwgPSB0aGlzLiQkcHJldlNpYmxpbmc7CiAgICAgICAgICAgIGlmICh0aGlzLiQkcHJldlNpYmxpbmcpIHRoaXMuJCRwcmV2U2libGluZy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJG5leHRTaWJsaW5nOwogICAgICAgICAgICBpZiAodGhpcy4kJG5leHRTaWJsaW5nKSB0aGlzLiQkbmV4dFNpYmxpbmcuJCRwcmV2U2libGluZyA9IHRoaXMuJCRwcmV2U2libGluZzsKCgogICAgICAgICAgICAvLyBBbGwgb2YgdGhlIGNvZGUgYmVsb3cgaXMgYm9ndXMgY29kZSB0aGF0IHdvcmtzIGFyb3VuZCBWOCdzIG1lbW9yeSBsZWFrIHZpYSBvcHRpbWl6ZWQgY29kZQogICAgICAgICAgICAvLyBhbmQgaW5saW5lIGNhY2hlcy4KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gc2VlOgogICAgICAgICAgICAvLyAtIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvdjgvaXNzdWVzL2RldGFpbD9pZD0yMDczI2MyNgogICAgICAgICAgICAvLyAtIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvaXNzdWVzLzY3OTQjaXNzdWVjb21tZW50LTM4NjQ4OTA5CiAgICAgICAgICAgIC8vIC0gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvMTMxMyNpc3N1ZWNvbW1lbnQtMTAzNzg0NTEKCiAgICAgICAgICAgIHRoaXMuJHBhcmVudCA9IHRoaXMuJCRuZXh0U2libGluZyA9IHRoaXMuJCRwcmV2U2libGluZyA9IHRoaXMuJCRjaGlsZEhlYWQgPQogICAgICAgICAgICAgIHRoaXMuJCRjaGlsZFRhaWwgPSB0aGlzLiRyb290ID0gbnVsbDsKCiAgICAgICAgICAgIC8vIGRvbid0IHJlc2V0IHRoZXNlIHRvIG51bGwgaW4gY2FzZSBzb21lIGFzeW5jIHRhc2sgdHJpZXMgdG8gcmVnaXN0ZXIgYSBsaXN0ZW5lci93YXRjaC90YXNrCiAgICAgICAgICAgIHRoaXMuJCRsaXN0ZW5lcnMgPSB7fTsKICAgICAgICAgICAgdGhpcy4kJHdhdGNoZXJzID0gdGhpcy4kJGFzeW5jUXVldWUgPSB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlID0gW107CgogICAgICAgICAgICAvLyBwcmV2ZW50IE5QRXMgc2luY2UgdGhlc2UgbWV0aG9kcyBoYXZlIHJlZmVyZW5jZXMgdG8gcHJvcGVydGllcyB3ZSBudWxsZWQgb3V0CiAgICAgICAgICAgIHRoaXMuJGRlc3Ryb3kgPSB0aGlzLiRkaWdlc3QgPSB0aGlzLiRhcHBseSA9IG5vb3A7CiAgICAgICAgICAgIHRoaXMuJG9uID0gdGhpcy4kd2F0Y2ggPSBmdW5jdGlvbigpIHsgcmV0dXJuIG5vb3A7IH07CiAgICAgICAgICB9LAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZXZhbAogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIEV4ZWN1dGVzIHRoZSBgZXhwcmVzc2lvbmAgb24gdGhlIGN1cnJlbnQgc2NvcGUgYW5kIHJldHVybnMgdGhlIHJlc3VsdC4gQW55IGV4Y2VwdGlvbnMgaW4KICAgICAgICAgICAqIHRoZSBleHByZXNzaW9uIGFyZSBwcm9wYWdhdGVkICh1bmNhdWdodCkuIFRoaXMgaXMgdXNlZnVsIHdoZW4gZXZhbHVhdGluZyBBbmd1bGFyCiAgICAgICAgICAgKiBleHByZXNzaW9ucy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiAjIEV4YW1wbGUKICAgICAgICAgICAqIGBgYGpzCiAgICAgICAgICAgdmFyIHNjb3BlID0gbmcuJHJvb3RTY29wZS5TY29wZSgpOwogICAgICAgICAgIHNjb3BlLmEgPSAxOwogICAgICAgICAgIHNjb3BlLmIgPSAyOwoKICAgICAgICAgICBleHBlY3Qoc2NvcGUuJGV2YWwoJ2ErYicpKS50b0VxdWFsKDMpOwogICAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbChmdW5jdGlvbihzY29wZSl7IHJldHVybiBzY29wZS5hICsgc2NvcGUuYjsgfSkpLnRvRXF1YWwoMyk7CiAgICAgICAgICAgKiBgYGAKICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4KICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHsob2JqZWN0KT19IGxvY2FscyBMb2NhbCB2YXJpYWJsZXMgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluIHNjb3BlLgogICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICAgICAqLwogICAgICAgICAgJGV2YWw6IGZ1bmN0aW9uKGV4cHIsIGxvY2FscykgewogICAgICAgICAgICByZXR1cm4gJHBhcnNlKGV4cHIpKHRoaXMsIGxvY2Fscyk7CiAgICAgICAgICB9LAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZXZhbEFzeW5jCiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogRXhlY3V0ZXMgdGhlIGV4cHJlc3Npb24gb24gdGhlIGN1cnJlbnQgc2NvcGUgYXQgYSBsYXRlciBwb2ludCBpbiB0aW1lLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoZSBgJGV2YWxBc3luY2AgbWFrZXMgbm8gZ3VhcmFudGVlcyBhcyB0byB3aGVuIHRoZSBgZXhwcmVzc2lvbmAgd2lsbCBiZSBleGVjdXRlZCwgb25seQogICAgICAgICAgICogdGhhdDoKICAgICAgICAgICAqCiAgICAgICAgICAgKiAgIC0gaXQgd2lsbCBleGVjdXRlIGFmdGVyIHRoZSBmdW5jdGlvbiB0aGF0IHNjaGVkdWxlZCB0aGUgZXZhbHVhdGlvbiAocHJlZmVyYWJseSBiZWZvcmUgRE9NCiAgICAgICAgICAgKiAgICAgcmVuZGVyaW5nKS4KICAgICAgICAgICAqICAgLSBhdCBsZWFzdCBvbmUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0IGN5Y2xlfSB3aWxsIGJlIHBlcmZvcm1lZCBhZnRlcgogICAgICAgICAgICogICAgIGBleHByZXNzaW9uYCBleGVjdXRpb24uCiAgICAgICAgICAgKgogICAgICAgICAgICogQW55IGV4Y2VwdGlvbnMgZnJvbSB0aGUgZXhlY3V0aW9uIG9mIHRoZSBleHByZXNzaW9uIGFyZSBmb3J3YXJkZWQgdG8gdGhlCiAgICAgICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgKgogICAgICAgICAgICogX19Ob3RlOl9fIGlmIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIG91dHNpZGUgb2YgYSBgJGRpZ2VzdGAgY3ljbGUsIGEgbmV3IGAkZGlnZXN0YCBjeWNsZQogICAgICAgICAgICogd2lsbCBiZSBzY2hlZHVsZWQuIEhvd2V2ZXIsIGl0IGlzIGVuY291cmFnZWQgdG8gYWx3YXlzIGNhbGwgY29kZSB0aGF0IGNoYW5nZXMgdGhlIG1vZGVsCiAgICAgICAgICAgKiBmcm9tIHdpdGhpbiBhbiBgJGFwcGx5YCBjYWxsLiBUaGF0IGluY2x1ZGVzIGNvZGUgZXZhbHVhdGVkIHZpYSBgJGV2YWxBc3luY2AuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHsoc3RyaW5nfGZ1bmN0aW9uKCkpPX0gZXhwcmVzc2lvbiBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogICAgLSBgc3RyaW5nYDogZXhlY3V0ZSB1c2luZyB0aGUgcnVsZXMgYXMgZGVmaW5lZCBpbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4KICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggdGhlIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAgICAgKgogICAgICAgICAgICovCiAgICAgICAgICAkZXZhbEFzeW5jOiBmdW5jdGlvbihleHByKSB7CiAgICAgICAgICAgIC8vIGlmIHdlIGFyZSBvdXRzaWRlIG9mIGFuICRkaWdlc3QgbG9vcCBhbmQgdGhpcyBpcyB0aGUgZmlyc3QgdGltZSB3ZSBhcmUgc2NoZWR1bGluZyBhc3luYwogICAgICAgICAgICAvLyB0YXNrIGFsc28gc2NoZWR1bGUgYXN5bmMgYXV0by1mbHVzaAogICAgICAgICAgICBpZiAoISRyb290U2NvcGUuJCRwaGFzZSAmJiAhJHJvb3RTY29wZS4kJGFzeW5jUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoJHJvb3RTY29wZS4kJGFzeW5jUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLiQkYXN5bmNRdWV1ZS5wdXNoKHtzY29wZTogdGhpcywgZXhwcmVzc2lvbjogZXhwcn0pOwogICAgICAgICAgfSwKCiAgICAgICAgICAkJHBvc3REaWdlc3QgOiBmdW5jdGlvbihmbikgewogICAgICAgICAgICB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlLnB1c2goZm4pOwogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGFwcGx5CiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogYCRhcHBseSgpYCBpcyB1c2VkIHRvIGV4ZWN1dGUgYW4gZXhwcmVzc2lvbiBpbiBhbmd1bGFyIGZyb20gb3V0c2lkZSBvZiB0aGUgYW5ndWxhcgogICAgICAgICAgICogZnJhbWV3b3JrLiAoRm9yIGV4YW1wbGUgZnJvbSBicm93c2VyIERPTSBldmVudHMsIHNldFRpbWVvdXQsIFhIUiBvciB0aGlyZCBwYXJ0eSBsaWJyYXJpZXMpLgogICAgICAgICAgICogQmVjYXVzZSB3ZSBhcmUgY2FsbGluZyBpbnRvIHRoZSBhbmd1bGFyIGZyYW1ld29yayB3ZSBuZWVkIHRvIHBlcmZvcm0gcHJvcGVyIHNjb3BlIGxpZmUKICAgICAgICAgICAqIGN5Y2xlIG9mIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciBleGNlcHRpb24gaGFuZGxpbmd9LAogICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCBleGVjdXRpbmcgd2F0Y2hlc30uCiAgICAgICAgICAgKgogICAgICAgICAgICogIyMgTGlmZSBjeWNsZQogICAgICAgICAgICoKICAgICAgICAgICAqICMgUHNldWRvLUNvZGUgb2YgYCRhcHBseSgpYAogICAgICAgICAgICogYGBganMKICAgICAgICAgICBmdW5jdGlvbiAkYXBwbHkoZXhwcikgewogICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgcmV0dXJuICRldmFsKGV4cHIpOwogICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICRyb290LiRkaWdlc3QoKTsKICAgICAgICAgICAgIH0KICAgICAgICAgICB9CiAgICAgICAgICAgKiBgYGAKICAgICAgICAgICAqCiAgICAgICAgICAgKgogICAgICAgICAgICogU2NvcGUncyBgJGFwcGx5KClgIG1ldGhvZCB0cmFuc2l0aW9ucyB0aHJvdWdoIHRoZSBmb2xsb3dpbmcgc3RhZ2VzOgogICAgICAgICAgICoKICAgICAgICAgICAqIDEuIFRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyBleGVjdXRlZCB1c2luZyB0aGUKICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsICRldmFsKCl9IG1ldGhvZC4KICAgICAgICAgICAqIDIuIEFueSBleGNlcHRpb25zIGZyb20gdGhlIGV4ZWN1dGlvbiBvZiB0aGUgZXhwcmVzc2lvbiBhcmUgZm9yd2FyZGVkIHRvIHRoZQogICAgICAgICAgICogICAge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICogMy4gVGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaH0gbGlzdGVuZXJzIGFyZSBmaXJlZCBpbW1lZGlhdGVseSBhZnRlciB0aGUKICAgICAgICAgICAqICAgIGV4cHJlc3Npb24gd2FzIGV4ZWN1dGVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gbWV0aG9kLgogICAgICAgICAgICoKICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHAgQW4gYW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkLgogICAgICAgICAgICoKICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uCiAgICAgICAgICAgKiAgICAtIGBmdW5jdGlvbihzY29wZSlgOiBleGVjdXRlIHRoZSBmdW5jdGlvbiB3aXRoIGN1cnJlbnQgYHNjb3BlYCBwYXJhbWV0ZXIuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXN1bHQgb2YgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbi4KICAgICAgICAgICAqLwogICAgICAgICAgJGFwcGx5OiBmdW5jdGlvbihleHByKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgYmVnaW5QaGFzZSgnJGFwcGx5Jyk7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuJGV2YWwoZXhwcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRvbgogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIExpc3RlbnMgb24gZXZlbnRzIG9mIGEgZ2l2ZW4gdHlwZS4gU2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRlbWl0ICRlbWl0fSBmb3IKICAgICAgICAgICAqIGRpc2N1c3Npb24gb2YgZXZlbnQgbGlmZSBjeWNsZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBUaGUgZXZlbnQgbGlzdGVuZXIgZnVuY3Rpb24gZm9ybWF0IGlzOiBgZnVuY3Rpb24oZXZlbnQsIGFyZ3MuLi4pYC4gVGhlIGBldmVudGAgb2JqZWN0CiAgICAgICAgICAgKiBwYXNzZWQgaW50byB0aGUgbGlzdGVuZXIgaGFzIHRoZSBmb2xsb3dpbmcgYXR0cmlidXRlczoKICAgICAgICAgICAqCiAgICAgICAgICAgKiAgIC0gYHRhcmdldFNjb3BlYCAtIGB7U2NvcGV9YDogdGhlIHNjb3BlIG9uIHdoaWNoIHRoZSBldmVudCB3YXMgYCRlbWl0YC1lZCBvcgogICAgICAgICAgICogICAgIGAkYnJvYWRjYXN0YC1lZC4KICAgICAgICAgICAqICAgLSBgY3VycmVudFNjb3BlYCAtIGB7U2NvcGV9YDogdGhlIGN1cnJlbnQgc2NvcGUgd2hpY2ggaXMgaGFuZGxpbmcgdGhlIGV2ZW50LgogICAgICAgICAgICogICAtIGBuYW1lYCAtIGB7c3RyaW5nfWA6IG5hbWUgb2YgdGhlIGV2ZW50LgogICAgICAgICAgICogICAtIGBzdG9wUHJvcGFnYXRpb25gIC0gYHtmdW5jdGlvbj19YDogY2FsbGluZyBgc3RvcFByb3BhZ2F0aW9uYCBmdW5jdGlvbiB3aWxsIGNhbmNlbAogICAgICAgICAgICogICAgIGZ1cnRoZXIgZXZlbnQgcHJvcGFnYXRpb24gKGF2YWlsYWJsZSBvbmx5IGZvciBldmVudHMgdGhhdCB3ZXJlIGAkZW1pdGAtZWQpLgogICAgICAgICAgICogICAtIGBwcmV2ZW50RGVmYXVsdGAgLSBge2Z1bmN0aW9ufWA6IGNhbGxpbmcgYHByZXZlbnREZWZhdWx0YCBzZXRzIGBkZWZhdWx0UHJldmVudGVkYCBmbGFnCiAgICAgICAgICAgKiAgICAgdG8gdHJ1ZS4KICAgICAgICAgICAqICAgLSBgZGVmYXVsdFByZXZlbnRlZGAgLSBge2Jvb2xlYW59YDogdHJ1ZSBpZiBgcHJldmVudERlZmF1bHRgIHdhcyBjYWxsZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBsaXN0ZW4gb24uCiAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGV2ZW50LCAuLi5hcmdzKX0gbGlzdGVuZXIgRnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBldmVudCBpcyBlbWl0dGVkLgogICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IFJldHVybnMgYSBkZXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4KICAgICAgICAgICAqLwogICAgICAgICAgJG9uOiBmdW5jdGlvbihuYW1lLCBsaXN0ZW5lcikgewogICAgICAgICAgICB2YXIgbmFtZWRMaXN0ZW5lcnMgPSB0aGlzLiQkbGlzdGVuZXJzW25hbWVdOwogICAgICAgICAgICBpZiAoIW5hbWVkTGlzdGVuZXJzKSB7CiAgICAgICAgICAgICAgdGhpcy4kJGxpc3RlbmVyc1tuYW1lXSA9IG5hbWVkTGlzdGVuZXJzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CgogICAgICAgICAgICB2YXIgY3VycmVudCA9IHRoaXM7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpZiAoIWN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50LiQkbGlzdGVuZXJDb3VudFtuYW1lXSA9IDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdKys7CiAgICAgICAgICAgIH0gd2hpbGUgKChjdXJyZW50ID0gY3VycmVudC4kcGFyZW50KSk7CgogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBuYW1lZExpc3RlbmVyc1tpbmRleE9mKG5hbWVkTGlzdGVuZXJzLCBsaXN0ZW5lcildID0gbnVsbDsKICAgICAgICAgICAgICBkZWNyZW1lbnRMaXN0ZW5lckNvdW50KHNlbGYsIDEsIG5hbWUpOwogICAgICAgICAgICB9OwogICAgICAgICAgfSwKCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRlbWl0CiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogRGlzcGF0Y2hlcyBhbiBldmVudCBgbmFtZWAgdXB3YXJkcyB0aHJvdWdoIHRoZSBzY29wZSBoaWVyYXJjaHkgbm90aWZ5aW5nIHRoZQogICAgICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBUaGUgZXZlbnQgbGlmZSBjeWNsZSBzdGFydHMgYXQgdGhlIHNjb3BlIG9uIHdoaWNoIGAkZW1pdGAgd2FzIGNhbGxlZC4gQWxsCiAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSBsaXN0ZW5pbmcgZm9yIGBuYW1lYCBldmVudCBvbiB0aGlzIHNjb3BlIGdldAogICAgICAgICAgICogbm90aWZpZWQuIEFmdGVyd2FyZHMsIHRoZSBldmVudCB0cmF2ZXJzZXMgdXB3YXJkcyB0b3dhcmQgdGhlIHJvb3Qgc2NvcGUgYW5kIGNhbGxzIGFsbAogICAgICAgICAgICogcmVnaXN0ZXJlZCBsaXN0ZW5lcnMgYWxvbmcgdGhlIHdheS4gVGhlIGV2ZW50IHdpbGwgc3RvcCBwcm9wYWdhdGluZyBpZiBvbmUgb2YgdGhlIGxpc3RlbmVycwogICAgICAgICAgICogY2FuY2VscyBpdC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9uIGVtaXR0ZWQgZnJvbSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9uIGxpc3RlbmVyc30gd2lsbCBiZSBwYXNzZWQKICAgICAgICAgICAqIG9udG8gdGhlIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGVtaXQuCiAgICAgICAgICAgKiBAcGFyYW0gey4uLip9IGFyZ3MgT3B0aW9uYWwgb25lIG9yIG1vcmUgYXJndW1lbnRzIHdoaWNoIHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gRXZlbnQgb2JqZWN0IChzZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufSkuCiAgICAgICAgICAgKi8KICAgICAgICAgICRlbWl0OiBmdW5jdGlvbihuYW1lLCBhcmdzKSB7CiAgICAgICAgICAgIHZhciBlbXB0eSA9IFtdLAogICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzLAogICAgICAgICAgICAgIHNjb3BlID0gdGhpcywKICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb24gPSBmYWxzZSwKICAgICAgICAgICAgICBldmVudCA9IHsKICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICB0YXJnZXRTY29wZTogc2NvcGUsCiAgICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkge3N0b3BQcm9wYWdhdGlvbiA9IHRydWU7fSwKICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGxpc3RlbmVyQXJncyA9IGNvbmNhdChbZXZlbnRdLCBhcmd1bWVudHMsIDEpLAogICAgICAgICAgICAgIGksIGxlbmd0aDsKCiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBuYW1lZExpc3RlbmVycyA9IHNjb3BlLiQkbGlzdGVuZXJzW25hbWVdIHx8IGVtcHR5OwogICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IHNjb3BlOwogICAgICAgICAgICAgIGZvciAoaT0wLCBsZW5ndGg9bmFtZWRMaXN0ZW5lcnMubGVuZ3RoOyBpPGxlbmd0aDsgaSsrKSB7CgogICAgICAgICAgICAgICAgLy8gaWYgbGlzdGVuZXJzIHdlcmUgZGVyZWdpc3RlcmVkLCBkZWZyYWdtZW50IHRoZSBhcnJheQogICAgICAgICAgICAgICAgaWYgKCFuYW1lZExpc3RlbmVyc1tpXSkgewogICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgICAgbGVuZ3RoLS07CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgLy9hbGxvdyBhbGwgbGlzdGVuZXJzIGF0dGFjaGVkIHRvIHRoZSBjdXJyZW50IHNjb3BlIHRvIHJ1bgogICAgICAgICAgICAgICAgICBuYW1lZExpc3RlbmVyc1tpXS5hcHBseShudWxsLCBsaXN0ZW5lckFyZ3MpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy9pZiBhbnkgbGlzdGVuZXIgb24gdGhlIGN1cnJlbnQgc2NvcGUgc3RvcHMgcHJvcGFnYXRpb24sIHByZXZlbnQgYnViYmxpbmcKICAgICAgICAgICAgICBpZiAoc3RvcFByb3BhZ2F0aW9uKSByZXR1cm4gZXZlbnQ7CiAgICAgICAgICAgICAgLy90cmF2ZXJzZSB1cHdhcmRzCiAgICAgICAgICAgICAgc2NvcGUgPSBzY29wZS4kcGFyZW50OwogICAgICAgICAgICB9IHdoaWxlIChzY29wZSk7CgogICAgICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgICAgICB9LAoKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGJyb2FkY2FzdAogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIERpc3BhdGNoZXMgYW4gZXZlbnQgYG5hbWVgIGRvd253YXJkcyB0byBhbGwgY2hpbGQgc2NvcGVzIChhbmQgdGhlaXIgY2hpbGRyZW4pIG5vdGlmeWluZyB0aGUKICAgICAgICAgICAqIHJlZ2lzdGVyZWQge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufSBsaXN0ZW5lcnMuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhlIGV2ZW50IGxpZmUgY3ljbGUgc3RhcnRzIGF0IHRoZSBzY29wZSBvbiB3aGljaCBgJGJyb2FkY2FzdGAgd2FzIGNhbGxlZC4gQWxsCiAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSBsaXN0ZW5pbmcgZm9yIGBuYW1lYCBldmVudCBvbiB0aGlzIHNjb3BlIGdldAogICAgICAgICAgICogbm90aWZpZWQuIEFmdGVyd2FyZHMsIHRoZSBldmVudCBwcm9wYWdhdGVzIHRvIGFsbCBkaXJlY3QgYW5kIGluZGlyZWN0IHNjb3BlcyBvZiB0aGUgY3VycmVudAogICAgICAgICAgICogc2NvcGUgYW5kIGNhbGxzIGFsbCByZWdpc3RlcmVkIGxpc3RlbmVycyBhbG9uZyB0aGUgd2F5LiBUaGUgZXZlbnQgY2Fubm90IGJlIGNhbmNlbGVkLgogICAgICAgICAgICoKICAgICAgICAgICAqIEFueSBleGNlcHRpb24gZW1pdHRlZCBmcm9tIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSB3aWxsIGJlIHBhc3NlZAogICAgICAgICAgICogb250byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEV2ZW50IG5hbWUgdG8gYnJvYWRjYXN0LgogICAgICAgICAgICogQHBhcmFtIHsuLi4qfSBhcmdzIE9wdGlvbmFsIG9uZSBvciBtb3JlIGFyZ3VtZW50cyB3aGljaCB3aWxsIGJlIHBhc3NlZCBvbnRvIHRoZSBldmVudCBsaXN0ZW5lcnMuCiAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9IEV2ZW50IG9iamVjdCwgc2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0KICAgICAgICAgICAqLwogICAgICAgICAgJGJyb2FkY2FzdDogZnVuY3Rpb24obmFtZSwgYXJncykgewogICAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcywKICAgICAgICAgICAgICBjdXJyZW50ID0gdGFyZ2V0LAogICAgICAgICAgICAgIG5leHQgPSB0YXJnZXQsCiAgICAgICAgICAgICAgZXZlbnQgPSB7CiAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgdGFyZ2V0U2NvcGU6IHRhcmdldCwKICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgZXZlbnQuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZGVmYXVsdFByZXZlbnRlZDogZmFsc2UKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGxpc3RlbmVyQXJncyA9IGNvbmNhdChbZXZlbnRdLCBhcmd1bWVudHMsIDEpLAogICAgICAgICAgICAgIGxpc3RlbmVycywgaSwgbGVuZ3RoOwoKICAgICAgICAgICAgLy9kb3duIHdoaWxlIHlvdSBjYW4sIHRoZW4gdXAgYW5kIG5leHQgc2libGluZyBvciB1cCBhbmQgbmV4dCBzaWJsaW5nIHVudGlsIGJhY2sgYXQgcm9vdAogICAgICAgICAgICB3aGlsZSAoKGN1cnJlbnQgPSBuZXh0KSkgewogICAgICAgICAgICAgIGV2ZW50LmN1cnJlbnRTY29wZSA9IGN1cnJlbnQ7CiAgICAgICAgICAgICAgbGlzdGVuZXJzID0gY3VycmVudC4kJGxpc3RlbmVyc1tuYW1lXSB8fCBbXTsKICAgICAgICAgICAgICBmb3IgKGk9MCwgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsgaTxsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgLy8gaWYgbGlzdGVuZXJzIHdlcmUgZGVyZWdpc3RlcmVkLCBkZWZyYWdtZW50IHRoZSBhcnJheQogICAgICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnNbaV0pIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmFwcGx5KG51bGwsIGxpc3RlbmVyQXJncyk7CiAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBJbnNhbml0eSBXYXJuaW5nOiBzY29wZSBkZXB0aC1maXJzdCB0cmF2ZXJzYWwKICAgICAgICAgICAgICAvLyB5ZXMsIHRoaXMgY29kZSBpcyBhIGJpdCBjcmF6eSwgYnV0IGl0IHdvcmtzIGFuZCB3ZSBoYXZlIHRlc3RzIHRvIHByb3ZlIGl0IQogICAgICAgICAgICAgIC8vIHRoaXMgcGllY2Ugc2hvdWxkIGJlIGtlcHQgaW4gc3luYyB3aXRoIHRoZSB0cmF2ZXJzYWwgaW4gJGRpZ2VzdAogICAgICAgICAgICAgIC8vICh0aG91Z2ggaXQgZGlmZmVycyBkdWUgdG8gaGF2aW5nIHRoZSBleHRyYSBjaGVjayBmb3IgJCRsaXN0ZW5lckNvdW50KQogICAgICAgICAgICAgIGlmICghKG5leHQgPSAoKGN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdICYmIGN1cnJlbnQuJCRjaGlsZEhlYWQpIHx8CiAgICAgICAgICAgICAgICAoY3VycmVudCAhPT0gdGFyZ2V0ICYmIGN1cnJlbnQuJCRuZXh0U2libGluZykpKSkgewogICAgICAgICAgICAgICAgd2hpbGUoY3VycmVudCAhPT0gdGFyZ2V0ICYmICEobmV4dCA9IGN1cnJlbnQuJCRuZXh0U2libGluZykpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuJHBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBldmVudDsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgJHJvb3RTY29wZSA9IG5ldyBTY29wZSgpOwoKICAgICAgICByZXR1cm4gJHJvb3RTY29wZTsKCgogICAgICAgIGZ1bmN0aW9uIGJlZ2luUGhhc2UocGhhc2UpIHsKICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiQkcGhhc2UpIHsKICAgICAgICAgICAgdGhyb3cgJHJvb3RTY29wZU1pbkVycignaW5wcm9nJywgJ3swfSBhbHJlYWR5IGluIHByb2dyZXNzJywgJHJvb3RTY29wZS4kJHBoYXNlKTsKICAgICAgICAgIH0KCiAgICAgICAgICAkcm9vdFNjb3BlLiQkcGhhc2UgPSBwaGFzZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGNsZWFyUGhhc2UoKSB7CiAgICAgICAgICAkcm9vdFNjb3BlLiQkcGhhc2UgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY29tcGlsZVRvRm4oZXhwLCBuYW1lKSB7CiAgICAgICAgICB2YXIgZm4gPSAkcGFyc2UoZXhwKTsKICAgICAgICAgIGFzc2VydEFyZ0ZuKGZuLCBuYW1lKTsKICAgICAgICAgIHJldHVybiBmbjsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRlY3JlbWVudExpc3RlbmVyQ291bnQoY3VycmVudCwgY291bnQsIG5hbWUpIHsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0gLT0gY291bnQ7CgogICAgICAgICAgICBpZiAoY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0gPT09IDApIHsKICAgICAgICAgICAgICBkZWxldGUgY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gd2hpbGUgKChjdXJyZW50ID0gY3VycmVudC4kcGFyZW50KSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBmdW5jdGlvbiB1c2VkIGFzIGFuIGluaXRpYWwgdmFsdWUgZm9yIHdhdGNoZXJzLgogICAgICAgICAqIGJlY2F1c2UgaXQncyB1bmlxdWUgd2UgY2FuIGVhc2lseSB0ZWxsIGl0IGFwYXJ0IGZyb20gb3RoZXIgdmFsdWVzCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gaW5pdFdhdGNoVmFsKCkge30KICAgICAgfV07CiAgfQoKICAvKioKICAgKiBAZGVzY3JpcHRpb24KICAgKiBQcml2YXRlIHNlcnZpY2UgdG8gc2FuaXRpemUgdXJpcyBmb3IgbGlua3MgYW5kIGltYWdlcy4gVXNlZCBieSAkY29tcGlsZSBhbmQgJHNhbml0aXplLgogICAqLwogIGZ1bmN0aW9uICQkU2FuaXRpemVVcmlQcm92aWRlcigpIHsKICAgIHZhciBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCA9IC9eXHMqKGh0dHBzP3xmdHB8bWFpbHRvfHRlbHxmaWxlKTovLAogICAgICBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSAvXlxzKihodHRwcz98ZnRwfGZpbGUpOnxkYXRhOmltYWdlXC8vOwoKICAgIC8qKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICAgKiB1cmxzIGR1cmluZyBhW2hyZWZdIHNhbml0aXphdGlvbi4KICAgICAqCiAgICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAgICoKICAgICAqIEFueSB1cmwgYWJvdXQgdG8gYmUgYXNzaWduZWQgdG8gYVtocmVmXSB2aWEgZGF0YS1iaW5kaW5nIGlzIGZpcnN0IG5vcm1hbGl6ZWQgYW5kIHR1cm5lZCBpbnRvCiAgICAgKiBhbiBhYnNvbHV0ZSB1cmwuIEFmdGVyd2FyZHMsIHRoZSB1cmwgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBgYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3RgCiAgICAgKiByZWd1bGFyIGV4cHJlc3Npb24uIElmIGEgbWF0Y2ggaXMgZm91bmQsIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSwKICAgICAqIHRoZSBhYnNvbHV0ZSB1cmwgaXMgcHJlZml4ZWQgd2l0aCBgJ3Vuc2FmZTonYCBzdHJpbmcgYW5kIG9ubHkgdGhlbiBpcyBpdCB3cml0dGVuIGludG8gdGhlIERPTS4KICAgICAqCiAgICAgKiBAcGFyYW0ge1JlZ0V4cD19IHJlZ2V4cCBOZXcgcmVnZXhwIHRvIHdoaXRlbGlzdCB1cmxzIHdpdGguCiAgICAgKiBAcmV0dXJucyB7UmVnRXhwfG5nLiRjb21waWxlUHJvdmlkZXJ9IEN1cnJlbnQgUmVnRXhwIGlmIGNhbGxlZCB3aXRob3V0IHZhbHVlIG9yIHNlbGYgZm9yCiAgICAgKiAgICBjaGFpbmluZyBvdGhlcndpc2UuCiAgICAgKi8KICAgIHRoaXMuYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbihyZWdleHApIHsKICAgICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgICAgYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSByZWdleHA7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgcmV0dXJuIGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0OwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgICAqIHVybHMgZHVyaW5nIGltZ1tzcmNdIHNhbml0aXphdGlvbi4KICAgICAqCiAgICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAgICoKICAgICAqIEFueSB1cmwgYWJvdXQgdG8gYmUgYXNzaWduZWQgdG8gaW1nW3NyY10gdmlhIGRhdGEtYmluZGluZyBpcyBmaXJzdCBub3JtYWxpemVkIGFuZCB0dXJuZWQgaW50bwogICAgICogYW4gYWJzb2x1dGUgdXJsLiBBZnRlcndhcmRzLCB0aGUgdXJsIGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgYGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdGAKICAgICAqIHJlZ3VsYXIgZXhwcmVzc2lvbi4gSWYgYSBtYXRjaCBpcyBmb3VuZCwgdGhlIG9yaWdpbmFsIHVybCBpcyB3cml0dGVuIGludG8gdGhlIGRvbS4gT3RoZXJ3aXNlLAogICAgICogdGhlIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGlzIGl0IHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAgICoKICAgICAqIEBwYXJhbSB7UmVnRXhwPX0gcmVnZXhwIE5ldyByZWdleHAgdG8gd2hpdGVsaXN0IHVybHMgd2l0aC4KICAgICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgICAqICAgIGNoYWluaW5nIG90aGVyd2lzZS4KICAgICAqLwogICAgdGhpcy5pbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbihyZWdleHApIHsKICAgICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgICAgaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gcmVnZXhwOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIHJldHVybiBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3Q7CiAgICB9OwoKICAgIHRoaXMuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gc2FuaXRpemVVcmkodXJpLCBpc0ltYWdlKSB7CiAgICAgICAgdmFyIHJlZ2V4ID0gaXNJbWFnZSA/IGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA6IGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0OwogICAgICAgIHZhciBub3JtYWxpemVkVmFsOwogICAgICAgIC8vIE5PVEU6IHVybFJlc29sdmUoKSBkb2Vzbid0IHN1cHBvcnQgSUUgPCA4IHNvIHdlIGRvbid0IHNhbml0aXplIGZvciB0aGF0IGNhc2UuCiAgICAgICAgaWYgKCFtc2llIHx8IG1zaWUgPj0gOCApIHsKICAgICAgICAgIG5vcm1hbGl6ZWRWYWwgPSB1cmxSZXNvbHZlKHVyaSkuaHJlZjsKICAgICAgICAgIGlmIChub3JtYWxpemVkVmFsICE9PSAnJyAmJiAhbm9ybWFsaXplZFZhbC5tYXRjaChyZWdleCkpIHsKICAgICAgICAgICAgcmV0dXJuICd1bnNhZmU6Jytub3JtYWxpemVkVmFsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdXJpOwogICAgICB9OwogICAgfTsKICB9CgogIHZhciAkc2NlTWluRXJyID0gbWluRXJyKCckc2NlJyk7CgogIHZhciBTQ0VfQ09OVEVYVFMgPSB7CiAgICBIVE1MOiAnaHRtbCcsCiAgICBDU1M6ICdjc3MnLAogICAgVVJMOiAndXJsJywKICAgIC8vIFJFU09VUkNFX1VSTCBpcyBhIHN1YnR5cGUgb2YgVVJMIHVzZWQgaW4gY29udGV4dHMgd2hlcmUgYSBwcml2aWxlZ2VkIHJlc291cmNlIGlzIHNvdXJjZWQgZnJvbSBhCiAgICAvLyB1cmwuICAoZS5nLiBuZy1pbmNsdWRlLCBzY3JpcHQgc3JjLCB0ZW1wbGF0ZVVybCkKICAgIFJFU09VUkNFX1VSTDogJ3Jlc291cmNlVXJsJywKICAgIEpTOiAnanMnCiAgfTsKCi8vIEhlbHBlciBmdW5jdGlvbnMgZm9sbG93LgoKLy8gQ29waWVkIGZyb206Ci8vIGh0dHA6Ly9kb2NzLmNsb3N1cmUtbGlicmFyeS5nb29nbGVjb2RlLmNvbS9naXQvY2xvc3VyZV9nb29nX3N0cmluZ19zdHJpbmcuanMuc291cmNlLmh0bWwjbGluZTk2MgovLyBQcmVyZXE6IHMgaXMgYSBzdHJpbmcuCiAgZnVuY3Rpb24gZXNjYXBlRm9yUmVnZXhwKHMpIHsKICAgIHJldHVybiBzLnJlcGxhY2UoLyhbLSgpXFtcXXt9Kz8qLiRcXnwsOiM8IVxcXSkvZywgJ1xcJDEnKS4KICAgICAgcmVwbGFjZSgvXHgwOC9nLCAnXFx4MDgnKTsKICB9CgoKICBmdW5jdGlvbiBhZGp1c3RNYXRjaGVyKG1hdGNoZXIpIHsKICAgIGlmIChtYXRjaGVyID09PSAnc2VsZicpIHsKICAgICAgcmV0dXJuIG1hdGNoZXI7CiAgICB9IGVsc2UgaWYgKGlzU3RyaW5nKG1hdGNoZXIpKSB7CiAgICAgIC8vIFN0cmluZ3MgbWF0Y2ggZXhhY3RseSBleGNlcHQgZm9yIDIgd2lsZGNhcmRzIC0gJyonIGFuZCAnKionLgogICAgICAvLyAnKicgbWF0Y2hlcyBhbnkgY2hhcmFjdGVyIGV4Y2VwdCB0aG9zZSBmcm9tIHRoZSBzZXQgJzovLj8mJy4KICAgICAgLy8gJyoqJyBtYXRjaGVzIGFueSBjaGFyYWN0ZXIgKGxpa2UgLiogaW4gYSBSZWdFeHApLgogICAgICAvLyBNb3JlIHRoYW4gMiAqJ3MgcmFpc2VzIGFuIGVycm9yIGFzIGl0J3MgaWxsIGRlZmluZWQuCiAgICAgIGlmIChtYXRjaGVyLmluZGV4T2YoJyoqKicpID4gLTEpIHsKICAgICAgICB0aHJvdyAkc2NlTWluRXJyKCdpd2NhcmQnLAogICAgICAgICAgJ0lsbGVnYWwgc2VxdWVuY2UgKioqIGluIHN0cmluZyBtYXRjaGVyLiAgU3RyaW5nOiB7MH0nLCBtYXRjaGVyKTsKICAgICAgfQogICAgICBtYXRjaGVyID0gZXNjYXBlRm9yUmVnZXhwKG1hdGNoZXIpLgogICAgICAgIHJlcGxhY2UoJ1xcKlxcKicsICcuKicpLgogICAgICAgIHJlcGxhY2UoJ1xcKicsICdbXjovLj8mO10qJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIG1hdGNoZXIgKyAnJCcpOwogICAgfSBlbHNlIGlmIChpc1JlZ0V4cChtYXRjaGVyKSkgewogICAgICAvLyBUaGUgb25seSBvdGhlciB0eXBlIG9mIG1hdGNoZXIgYWxsb3dlZCBpcyBhIFJlZ2V4cC4KICAgICAgLy8gTWF0Y2ggZW50aXJlIFVSTCAvIGRpc2FsbG93IHBhcnRpYWwgbWF0Y2hlcy4KICAgICAgLy8gRmxhZ3MgYXJlIHJlc2V0IChpLmUuIG5vIGdsb2JhbCwgaWdub3JlQ2FzZSBvciBtdWx0aWxpbmUpCiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIG1hdGNoZXIuc291cmNlICsgJyQnKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2ltYXRjaGVyJywKICAgICAgICAnTWF0Y2hlcnMgbWF5IG9ubHkgYmUgInNlbGYiLCBzdHJpbmcgcGF0dGVybnMgb3IgUmVnRXhwIG9iamVjdHMnKTsKICAgIH0KICB9CgoKICBmdW5jdGlvbiBhZGp1c3RNYXRjaGVycyhtYXRjaGVycykgewogICAgdmFyIGFkanVzdGVkTWF0Y2hlcnMgPSBbXTsKICAgIGlmIChpc0RlZmluZWQobWF0Y2hlcnMpKSB7CiAgICAgIGZvckVhY2gobWF0Y2hlcnMsIGZ1bmN0aW9uKG1hdGNoZXIpIHsKICAgICAgICBhZGp1c3RlZE1hdGNoZXJzLnB1c2goYWRqdXN0TWF0Y2hlcihtYXRjaGVyKSk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIGFkanVzdGVkTWF0Y2hlcnM7CiAgfQoKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkc2NlRGVsZWdhdGUKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBgJHNjZURlbGVnYXRlYCBpcyBhIHNlcnZpY2UgdGhhdCBpcyB1c2VkIGJ5IHRoZSBgJHNjZWAgc2VydmljZSB0byBwcm92aWRlIHtAbGluayBuZy4kc2NlIFN0cmljdAogKiBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpfSBzZXJ2aWNlcyB0byBBbmd1bGFySlMuCiAgICoKICAgKiBUeXBpY2FsbHksIHlvdSB3b3VsZCBjb25maWd1cmUgb3Igb3ZlcnJpZGUgdGhlIHtAbGluayBuZy4kc2NlRGVsZWdhdGUgJHNjZURlbGVnYXRlfSBpbnN0ZWFkIG9mCiAgICogdGhlIGAkc2NlYCBzZXJ2aWNlIHRvIGN1c3RvbWl6ZSB0aGUgd2F5IFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIHdvcmtzIGluIEFuZ3VsYXJKUy4gIFRoaXMgaXMKICAgKiBiZWNhdXNlLCB3aGlsZSB0aGUgYCRzY2VgIHByb3ZpZGVzIG51bWVyb3VzIHNob3J0aGFuZCBtZXRob2RzLCBldGMuLCB5b3UgcmVhbGx5IG9ubHkgbmVlZCB0bwogICAqIG92ZXJyaWRlIDMgY29yZSBmdW5jdGlvbnMgKGB0cnVzdEFzYCwgYGdldFRydXN0ZWRgIGFuZCBgdmFsdWVPZmApIHRvIHJlcGxhY2UgdGhlIHdheSB0aGluZ3MKICAgKiB3b3JrIGJlY2F1c2UgYCRzY2VgIGRlbGVnYXRlcyB0byBgJHNjZURlbGVnYXRlYCBmb3IgdGhlc2Ugb3BlcmF0aW9ucy4KICAgKgogICAqIFJlZmVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciAkc2NlRGVsZWdhdGVQcm92aWRlcn0gdG8gY29uZmlndXJlIHRoaXMgc2VydmljZS4KICAgKgogICAqIFRoZSBkZWZhdWx0IGluc3RhbmNlIG9mIGAkc2NlRGVsZWdhdGVgIHNob3VsZCB3b3JrIG91dCBvZiB0aGUgYm94IHdpdGggbGl0dGxlIHBhaW4uICBXaGlsZSB5b3UKICAgKiBjYW4gb3ZlcnJpZGUgaXQgY29tcGxldGVseSB0byBjaGFuZ2UgdGhlIGJlaGF2aW9yIG9mIGAkc2NlYCwgdGhlIGNvbW1vbiBjYXNlIHdvdWxkCiAgICogaW52b2x2ZSBjb25maWd1cmluZyB0aGUge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyICRzY2VEZWxlZ2F0ZVByb3ZpZGVyfSBpbnN0ZWFkIGJ5IHNldHRpbmcKICAgKiB5b3VyIG93biB3aGl0ZWxpc3RzIGFuZCBibGFja2xpc3RzIGZvciB0cnVzdGluZyBVUkxzIHVzZWQgZm9yIGxvYWRpbmcgQW5ndWxhckpTIHJlc291cmNlcyBzdWNoIGFzCiAgICogdGVtcGxhdGVzLiAgUmVmZXIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0CiAqICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsV2hpdGVsaXN0fSBhbmQge0BsaW5rCiAgICAqIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0ICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsQmxhY2tsaXN0fQogICAqLwoKICAvKioKICAgKiBAbmdkb2MgcHJvdmlkZXIKICAgKiBAbmFtZSAkc2NlRGVsZWdhdGVQcm92aWRlcgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogVGhlIGAkc2NlRGVsZWdhdGVQcm92aWRlcmAgcHJvdmlkZXIgYWxsb3dzIGRldmVsb3BlcnMgdG8gY29uZmlndXJlIHRoZSB7QGxpbmsgbmcuJHNjZURlbGVnYXRlCiAqICRzY2VEZWxlZ2F0ZX0gc2VydmljZS4gIFRoaXMgYWxsb3dzIG9uZSB0byBnZXQvc2V0IHRoZSB3aGl0ZWxpc3RzIGFuZCBibGFja2xpc3RzIHVzZWQgdG8gZW5zdXJlCiAgICogdGhhdCB0aGUgVVJMcyB1c2VkIGZvciBzb3VyY2luZyBBbmd1bGFyIHRlbXBsYXRlcyBhcmUgc2FmZS4gIFJlZmVyIHtAbGluawogICAgKiBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCAkc2NlRGVsZWdhdGVQcm92aWRlci5yZXNvdXJjZVVybFdoaXRlbGlzdH0gYW5kCiAgICoge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0ICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsQmxhY2tsaXN0fQogICAqCiAgICogRm9yIHRoZSBnZW5lcmFsIGRldGFpbHMgYWJvdXQgdGhpcyBzZXJ2aWNlIGluIEFuZ3VsYXIsIHJlYWQgdGhlIG1haW4gcGFnZSBmb3Ige0BsaW5rIG5nLiRzY2UKICogU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSl9LgogICAqCiAgICogKipFeGFtcGxlKio6ICBDb25zaWRlciB0aGUgZm9sbG93aW5nIGNhc2UuIDxhIG5hbWU9ImV4YW1wbGUiPjwvYT4KICAgKgogICAqIC0geW91ciBhcHAgaXMgaG9zdGVkIGF0IHVybCBgaHR0cDovL215YXBwLmV4YW1wbGUuY29tL2AKICAgKiAtIGJ1dCBzb21lIG9mIHlvdXIgdGVtcGxhdGVzIGFyZSBob3N0ZWQgb24gb3RoZXIgZG9tYWlucyB5b3UgY29udHJvbCBzdWNoIGFzCiAgICogICBgaHR0cDovL3NydjAxLmFzc2V0cy5leGFtcGxlLmNvbS9gLCAgYGh0dHA6Ly9zcnYwMi5hc3NldHMuZXhhbXBsZS5jb20vYCwgZXRjLgogICAqIC0gYW5kIHlvdSBoYXZlIGFuIG9wZW4gcmVkaXJlY3QgYXQgYGh0dHA6Ly9teWFwcC5leGFtcGxlLmNvbS9jbGlja1RocnU/Li4uYC4KICAgKgogICAqIEhlcmUgaXMgd2hhdCBhIHNlY3VyZSBjb25maWd1cmF0aW9uIGZvciB0aGlzIHNjZW5hcmlvIG1pZ2h0IGxvb2sgbGlrZToKICAgKgogICAqIDxwcmUgY2xhc3M9InByZXR0eXByaW50Ij4KICAgKiAgICBhbmd1bGFyLm1vZHVsZSgnbXlBcHAnLCBbXSkuY29uZmlnKGZ1bmN0aW9uKCRzY2VEZWxlZ2F0ZVByb3ZpZGVyKSB7CiAqICAgICAgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxXaGl0ZWxpc3QoWwogKiAgICAgICAgLy8gQWxsb3cgc2FtZSBvcmlnaW4gcmVzb3VyY2UgbG9hZHMuCiAqICAgICAgICAnc2VsZicsCiAqICAgICAgICAvLyBBbGxvdyBsb2FkaW5nIGZyb20gb3VyIGFzc2V0cyBkb21haW4uICBOb3RpY2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiAqIGFuZCAqKi4KICogICAgICAgICdodHRwOi8vc3J2Ki5hc3NldHMuZXhhbXBsZS5jb20vKionXSk7CiAqCiAqICAgICAgLy8gVGhlIGJsYWNrbGlzdCBvdmVycmlkZXMgdGhlIHdoaXRlbGlzdCBzbyB0aGUgb3BlbiByZWRpcmVjdCBoZXJlIGlzIGJsb2NrZWQuCiAqICAgICAgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxCbGFja2xpc3QoWwogKiAgICAgICAgJ2h0dHA6Ly9teWFwcC5leGFtcGxlLmNvbS9jbGlja1RocnUqKiddKTsKICogICAgICB9KTsKICAgKiA8L3ByZT4KICAgKi8KCiAgZnVuY3Rpb24gJFNjZURlbGVnYXRlUHJvdmlkZXIoKSB7CiAgICB0aGlzLlNDRV9DT05URVhUUyA9IFNDRV9DT05URVhUUzsKCiAgICAvLyBSZXNvdXJjZSBVUkxzIGNhbiBhbHNvIGJlIHRydXN0ZWQgYnkgcG9saWN5LgogICAgdmFyIHJlc291cmNlVXJsV2hpdGVsaXN0ID0gWydzZWxmJ10sCiAgICAgIHJlc291cmNlVXJsQmxhY2tsaXN0ID0gW107CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdAogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5PX0gd2hpdGVsaXN0IFdoZW4gcHJvdmlkZWQsIHJlcGxhY2VzIHRoZSByZXNvdXJjZVVybFdoaXRlbGlzdCB3aXRoIHRoZSB2YWx1ZQogICAgICogICAgIHByb3ZpZGVkLiAgVGhpcyBtdXN0IGJlIGFuIGFycmF5IG9yIG51bGwuICBBIHNuYXBzaG90IG9mIHRoaXMgYXJyYXkgaXMgdXNlZCBzbyBmdXJ0aGVyCiAgICAgKiAgICAgY2hhbmdlcyB0byB0aGUgYXJyYXkgYXJlIGlnbm9yZWQuCiAgICAgKgogICAgICogICAgIEZvbGxvdyB7QGxpbmsgbmcuJHNjZSNyZXNvdXJjZVVybFBhdHRlcm5JdGVtIHRoaXMgbGlua30gZm9yIGEgZGVzY3JpcHRpb24gb2YgdGhlIGl0ZW1zCiAgICAgKiAgICAgYWxsb3dlZCBpbiB0aGlzIGFycmF5LgogICAgICoKICAgICAqICAgICBOb3RlOiAqKmFuIGVtcHR5IHdoaXRlbGlzdCBhcnJheSB3aWxsIGJsb2NrIGFsbCBVUkxzKiohCiAgICAgKgogICAgICogQHJldHVybiB7QXJyYXl9IHRoZSBjdXJyZW50bHkgc2V0IHdoaXRlbGlzdCBhcnJheS4KICAgICAqCiAgICAgKiBUaGUgKipkZWZhdWx0IHZhbHVlKiogd2hlbiBubyB3aGl0ZWxpc3QgaGFzIGJlZW4gZXhwbGljaXRseSBzZXQgaXMgYFsnc2VsZiddYCBhbGxvd2luZyBvbmx5CiAgICAgKiBzYW1lIG9yaWdpbiByZXNvdXJjZSByZXF1ZXN0cy4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNldHMvR2V0cyB0aGUgd2hpdGVsaXN0IG9mIHRydXN0ZWQgcmVzb3VyY2UgVVJMcy4KICAgICAqLwogICAgdGhpcy5yZXNvdXJjZVVybFdoaXRlbGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHJlc291cmNlVXJsV2hpdGVsaXN0ID0gYWRqdXN0TWF0Y2hlcnModmFsdWUpOwogICAgICB9CiAgICAgIHJldHVybiByZXNvdXJjZVVybFdoaXRlbGlzdDsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybEJsYWNrbGlzdAogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAcGFyYW0ge0FycmF5PX0gYmxhY2tsaXN0IFdoZW4gcHJvdmlkZWQsIHJlcGxhY2VzIHRoZSByZXNvdXJjZVVybEJsYWNrbGlzdCB3aXRoIHRoZSB2YWx1ZQogICAgICogICAgIHByb3ZpZGVkLiAgVGhpcyBtdXN0IGJlIGFuIGFycmF5IG9yIG51bGwuICBBIHNuYXBzaG90IG9mIHRoaXMgYXJyYXkgaXMgdXNlZCBzbyBmdXJ0aGVyCiAgICAgKiAgICAgY2hhbmdlcyB0byB0aGUgYXJyYXkgYXJlIGlnbm9yZWQuCiAgICAgKgogICAgICogICAgIEZvbGxvdyB7QGxpbmsgbmcuJHNjZSNyZXNvdXJjZVVybFBhdHRlcm5JdGVtIHRoaXMgbGlua30gZm9yIGEgZGVzY3JpcHRpb24gb2YgdGhlIGl0ZW1zCiAgICAgKiAgICAgYWxsb3dlZCBpbiB0aGlzIGFycmF5LgogICAgICoKICAgICAqICAgICBUaGUgdHlwaWNhbCB1c2FnZSBmb3IgdGhlIGJsYWNrbGlzdCBpcyB0byAqKmJsb2NrCiAgICAgKiAgICAgW29wZW4gcmVkaXJlY3RzXShodHRwOi8vY3dlLm1pdHJlLm9yZy9kYXRhL2RlZmluaXRpb25zLzYwMS5odG1sKSoqIHNlcnZlZCBieSB5b3VyIGRvbWFpbiBhcwogICAgICogICAgIHRoZXNlIHdvdWxkIG90aGVyd2lzZSBiZSB0cnVzdGVkIGJ1dCBhY3R1YWxseSByZXR1cm4gY29udGVudCBmcm9tIHRoZSByZWRpcmVjdGVkIGRvbWFpbi4KICAgICAqCiAgICAgKiAgICAgRmluYWxseSwgKip0aGUgYmxhY2tsaXN0IG92ZXJyaWRlcyB0aGUgd2hpdGVsaXN0KiogYW5kIGhhcyB0aGUgZmluYWwgc2F5LgogICAgICoKICAgICAqIEByZXR1cm4ge0FycmF5fSB0aGUgY3VycmVudGx5IHNldCBibGFja2xpc3QgYXJyYXkuCiAgICAgKgogICAgICogVGhlICoqZGVmYXVsdCB2YWx1ZSoqIHdoZW4gbm8gd2hpdGVsaXN0IGhhcyBiZWVuIGV4cGxpY2l0bHkgc2V0IGlzIHRoZSBlbXB0eSBhcnJheSAoaS5lLiB0aGVyZQogICAgICogaXMgbm8gYmxhY2tsaXN0LikKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNldHMvR2V0cyB0aGUgYmxhY2tsaXN0IG9mIHRydXN0ZWQgcmVzb3VyY2UgVVJMcy4KICAgICAqLwoKICAgIHRoaXMucmVzb3VyY2VVcmxCbGFja2xpc3QgPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICByZXNvdXJjZVVybEJsYWNrbGlzdCA9IGFkanVzdE1hdGNoZXJzKHZhbHVlKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzb3VyY2VVcmxCbGFja2xpc3Q7CiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CgogICAgICB2YXIgaHRtbFNhbml0aXplciA9IGZ1bmN0aW9uIGh0bWxTYW5pdGl6ZXIoaHRtbCkgewogICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ3Vuc2FmZScsICdBdHRlbXB0aW5nIHRvIHVzZSBhbiB1bnNhZmUgdmFsdWUgaW4gYSBzYWZlIGNvbnRleHQuJyk7CiAgICAgIH07CgogICAgICBpZiAoJGluamVjdG9yLmhhcygnJHNhbml0aXplJykpIHsKICAgICAgICBodG1sU2FuaXRpemVyID0gJGluamVjdG9yLmdldCgnJHNhbml0aXplJyk7CiAgICAgIH0KCgogICAgICBmdW5jdGlvbiBtYXRjaFVybChtYXRjaGVyLCBwYXJzZWRVcmwpIHsKICAgICAgICBpZiAobWF0Y2hlciA9PT0gJ3NlbGYnKSB7CiAgICAgICAgICByZXR1cm4gdXJsSXNTYW1lT3JpZ2luKHBhcnNlZFVybCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIGRlZmluaXRlbHkgYSByZWdleC4gIFNlZSBhZGp1c3RNYXRjaGVycygpCiAgICAgICAgICByZXR1cm4gISFtYXRjaGVyLmV4ZWMocGFyc2VkVXJsLmhyZWYpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gaXNSZXNvdXJjZVVybEFsbG93ZWRCeVBvbGljeSh1cmwpIHsKICAgICAgICB2YXIgcGFyc2VkVXJsID0gdXJsUmVzb2x2ZSh1cmwudG9TdHJpbmcoKSk7CiAgICAgICAgdmFyIGksIG4sIGFsbG93ZWQgPSBmYWxzZTsKICAgICAgICAvLyBFbnN1cmUgdGhhdCBhdCBsZWFzdCBvbmUgaXRlbSBmcm9tIHRoZSB3aGl0ZWxpc3QgYWxsb3dzIHRoaXMgdXJsLgogICAgICAgIGZvciAoaSA9IDAsIG4gPSByZXNvdXJjZVVybFdoaXRlbGlzdC5sZW5ndGg7IGkgPCBuOyBpKyspIHsKICAgICAgICAgIGlmIChtYXRjaFVybChyZXNvdXJjZVVybFdoaXRlbGlzdFtpXSwgcGFyc2VkVXJsKSkgewogICAgICAgICAgICBhbGxvd2VkID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChhbGxvd2VkKSB7CiAgICAgICAgICAvLyBFbnN1cmUgdGhhdCBubyBpdGVtIGZyb20gdGhlIGJsYWNrbGlzdCBibG9ja2VkIHRoaXMgdXJsLgogICAgICAgICAgZm9yIChpID0gMCwgbiA9IHJlc291cmNlVXJsQmxhY2tsaXN0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICAgICAgICBpZiAobWF0Y2hVcmwocmVzb3VyY2VVcmxCbGFja2xpc3RbaV0sIHBhcnNlZFVybCkpIHsKICAgICAgICAgICAgICBhbGxvd2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFsbG93ZWQ7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGdlbmVyYXRlSG9sZGVyVHlwZShCYXNlKSB7CiAgICAgICAgdmFyIGhvbGRlclR5cGUgPSBmdW5jdGlvbiBUcnVzdGVkVmFsdWVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZSkgewogICAgICAgICAgdGhpcy4kJHVud3JhcFRydXN0ZWRWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdHJ1c3RlZFZhbHVlOwogICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIGlmIChCYXNlKSB7CiAgICAgICAgICBob2xkZXJUeXBlLnByb3RvdHlwZSA9IG5ldyBCYXNlKCk7CiAgICAgICAgfQogICAgICAgIGhvbGRlclR5cGUucHJvdG90eXBlLnZhbHVlT2YgPSBmdW5jdGlvbiBzY2VWYWx1ZU9mKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuJCR1bndyYXBUcnVzdGVkVmFsdWUoKTsKICAgICAgICB9OwogICAgICAgIGhvbGRlclR5cGUucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gc2NlVG9TdHJpbmcoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy4kJHVud3JhcFRydXN0ZWRWYWx1ZSgpLnRvU3RyaW5nKCk7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gaG9sZGVyVHlwZTsKICAgICAgfQoKICAgICAgdmFyIHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UgPSBnZW5lcmF0ZUhvbGRlclR5cGUoKSwKICAgICAgICBieVR5cGUgPSB7fTsKCiAgICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuSFRNTF0gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuQ1NTXSA9IGdlbmVyYXRlSG9sZGVyVHlwZSh0cnVzdGVkVmFsdWVIb2xkZXJCYXNlKTsKICAgICAgYnlUeXBlW1NDRV9DT05URVhUUy5VUkxdID0gZ2VuZXJhdGVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpOwogICAgICBieVR5cGVbU0NFX0NPTlRFWFRTLkpTXSA9IGdlbmVyYXRlSG9sZGVyVHlwZSh0cnVzdGVkVmFsdWVIb2xkZXJCYXNlKTsKICAgICAgYnlUeXBlW1NDRV9DT05URVhUUy5SRVNPVVJDRV9VUkxdID0gZ2VuZXJhdGVIb2xkZXJUeXBlKGJ5VHlwZVtTQ0VfQ09OVEVYVFMuVVJMXSk7CgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlRGVsZWdhdGUjdHJ1c3RBcwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogUmV0dXJucyBhbiBvYmplY3QgdGhhdCBpcyB0cnVzdGVkIGJ5IGFuZ3VsYXIgZm9yIHVzZSBpbiBzcGVjaWZpZWQgc3RyaWN0CiAgICAgICAqIGNvbnRleHR1YWwgZXNjYXBpbmcgY29udGV4dHMgKHN1Y2ggYXMgbmctYmluZC1odG1sLCBuZy1pbmNsdWRlLCBhbnkgc3JjCiAgICAgICAqIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uLCBhbnkgZG9tIGV2ZW50IGJpbmRpbmcgYXR0cmlidXRlIGludGVycG9sYXRpb24KICAgICAgICogc3VjaCBhcyBmb3Igb25jbGljaywgIGV0Yy4pIHRoYXQgdXNlcyB0aGUgcHJvdmlkZWQgdmFsdWUuCiAgICAgICAqIFNlZSB7QGxpbmsgbmcuJHNjZSAkc2NlfSBmb3IgZW5hYmxpbmcgc3RyaWN0IGNvbnRleHR1YWwgZXNjYXBpbmcuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSBraW5kIG9mIGNvbnRleHQgaW4gd2hpY2ggdGhpcyB2YWx1ZSBpcyBzYWZlIGZvciB1c2UuICBlLmcuIHVybCwKICAgICAgICogICByZXNvdXJjZVVybCwgaHRtbCwganMgYW5kIGNzcy4KICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdGhhdCB0aGF0IHNob3VsZCBiZSBjb25zaWRlcmVkIHRydXN0ZWQvc2FmZS4KICAgICAgICogQHJldHVybnMgeyp9IEEgdmFsdWUgdGhhdCBjYW4gYmUgdXNlZCB0byBzdGFuZCBpbiBmb3IgdGhlIHByb3ZpZGVkIGB2YWx1ZWAgaW4gcGxhY2VzCiAgICAgICAqIHdoZXJlIEFuZ3VsYXIgZXhwZWN0cyBhICRzY2UudHJ1c3RBcygpIHJldHVybiB2YWx1ZS4KICAgICAgICovCiAgICAgIGZ1bmN0aW9uIHRydXN0QXModHlwZSwgdHJ1c3RlZFZhbHVlKSB7CiAgICAgICAgdmFyIENvbnN0cnVjdG9yID0gKGJ5VHlwZS5oYXNPd25Qcm9wZXJ0eSh0eXBlKSA/IGJ5VHlwZVt0eXBlXSA6IG51bGwpOwogICAgICAgIGlmICghQ29uc3RydWN0b3IpIHsKICAgICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2ljb250ZXh0JywKICAgICAgICAgICAgJ0F0dGVtcHRlZCB0byB0cnVzdCBhIHZhbHVlIGluIGludmFsaWQgY29udGV4dC4gQ29udGV4dDogezB9OyBWYWx1ZTogezF9JywKICAgICAgICAgICAgdHlwZSwgdHJ1c3RlZFZhbHVlKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRydXN0ZWRWYWx1ZSA9PT0gbnVsbCB8fCB0cnVzdGVkVmFsdWUgPT09IHVuZGVmaW5lZCB8fCB0cnVzdGVkVmFsdWUgPT09ICcnKSB7CiAgICAgICAgICByZXR1cm4gdHJ1c3RlZFZhbHVlOwogICAgICAgIH0KICAgICAgICAvLyBBbGwgdGhlIGN1cnJlbnQgY29udGV4dHMgaW4gU0NFX0NPTlRFWFRTIGhhcHBlbiB0byBiZSBzdHJpbmdzLiAgSW4gb3JkZXIgdG8gYXZvaWQgdHJ1c3RpbmcKICAgICAgICAvLyBtdXRhYmxlIG9iamVjdHMsIHdlIGVuc3VyZSBoZXJlIHRoYXQgdGhlIHZhbHVlIHBhc3NlZCBpbiBpcyBhY3R1YWxseSBhIHN0cmluZy4KICAgICAgICBpZiAodHlwZW9mIHRydXN0ZWRWYWx1ZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2l0eXBlJywKICAgICAgICAgICAgJ0F0dGVtcHRlZCB0byB0cnVzdCBhIG5vbi1zdHJpbmcgdmFsdWUgaW4gYSBjb250ZW50IHJlcXVpcmluZyBhIHN0cmluZzogQ29udGV4dDogezB9JywKICAgICAgICAgICAgdHlwZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgQ29uc3RydWN0b3IodHJ1c3RlZFZhbHVlKTsKICAgICAgfQoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZURlbGVnYXRlI3ZhbHVlT2YKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIElmIHRoZSBwYXNzZWQgcGFyYW1ldGVyIGhhZCBiZWVuIHJldHVybmVkIGJ5IGEgcHJpb3IgY2FsbCB0byB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAqIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9LCByZXR1cm5zIHRoZSB2YWx1ZSB0aGF0IGhhZCBiZWVuIHBhc3NlZCB0byB7QGxpbmsKICAgICAgICAqIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9LgogICAgICAgKgogICAgICAgKiBJZiB0aGUgcGFzc2VkIHBhcmFtZXRlciBpcyBub3QgYSB2YWx1ZSB0aGF0IGhhZCBiZWVuIHJldHVybmVkIGJ5IHtAbGluawogICAgICAgICogbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0sIHJldHVybnMgaXQgYXMtaXMuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHJlc3VsdCBvZiBhIHByaW9yIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfQogICAgICAgKiAgICAgIGNhbGwgb3IgYW55dGhpbmcgZWxzZS4KICAgICAgICogQHJldHVybnMgeyp9IFRoZSBgdmFsdWVgIHRoYXQgd2FzIG9yaWdpbmFsbHkgcHJvdmlkZWQgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgKiAgICAgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gaWYgYHZhbHVlYCBpcyB0aGUgcmVzdWx0IG9mIHN1Y2ggYSBjYWxsLiAgT3RoZXJ3aXNlLCByZXR1cm5zCiAgICAgICAqICAgICBgdmFsdWVgIHVuY2hhbmdlZC4KICAgICAgICovCiAgICAgIGZ1bmN0aW9uIHZhbHVlT2YobWF5YmVUcnVzdGVkKSB7CiAgICAgICAgaWYgKG1heWJlVHJ1c3RlZCBpbnN0YW5jZW9mIHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpIHsKICAgICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQuJCR1bndyYXBUcnVzdGVkVmFsdWUoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBUYWtlcyB0aGUgcmVzdWx0IG9mIGEge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9IGNhbGwgYW5kCiAgICAgICAqIHJldHVybnMgdGhlIG9yaWdpbmFsbHkgc3VwcGxpZWQgdmFsdWUgaWYgdGhlIHF1ZXJpZWQgY29udGV4dCB0eXBlIGlzIGEgc3VwZXJ0eXBlIG9mIHRoZQogICAgICAgKiBjcmVhdGVkIHR5cGUuICBJZiB0aGlzIGNvbmRpdGlvbiBpc24ndCBzYXRpc2ZpZWQsIHRocm93cyBhbiBleGNlcHRpb24uCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSBraW5kIG9mIGNvbnRleHQgaW4gd2hpY2ggdGhpcyB2YWx1ZSBpcyB0byBiZSB1c2VkLgogICAgICAgKiBAcGFyYW0geyp9IG1heWJlVHJ1c3RlZCBUaGUgcmVzdWx0IG9mIGEgcHJpb3Ige0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgKiAgICAgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gY2FsbC4KICAgICAgICogQHJldHVybnMgeyp9IFRoZSB2YWx1ZSB0aGUgd2FzIG9yaWdpbmFsbHkgcHJvdmlkZWQgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgKiAgICAgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gaWYgdmFsaWQgaW4gdGhpcyBjb250ZXh0LiAgT3RoZXJ3aXNlLCB0aHJvd3MgYW4gZXhjZXB0aW9uLgogICAgICAgKi8KICAgICAgZnVuY3Rpb24gZ2V0VHJ1c3RlZCh0eXBlLCBtYXliZVRydXN0ZWQpIHsKICAgICAgICBpZiAobWF5YmVUcnVzdGVkID09PSBudWxsIHx8IG1heWJlVHJ1c3RlZCA9PT0gdW5kZWZpbmVkIHx8IG1heWJlVHJ1c3RlZCA9PT0gJycpIHsKICAgICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQ7CiAgICAgICAgfQogICAgICAgIHZhciBjb25zdHJ1Y3RvciA9IChieVR5cGUuaGFzT3duUHJvcGVydHkodHlwZSkgPyBieVR5cGVbdHlwZV0gOiBudWxsKTsKICAgICAgICBpZiAoY29uc3RydWN0b3IgJiYgbWF5YmVUcnVzdGVkIGluc3RhbmNlb2YgY29uc3RydWN0b3IpIHsKICAgICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQuJCR1bndyYXBUcnVzdGVkVmFsdWUoKTsKICAgICAgICB9CiAgICAgICAgLy8gSWYgd2UgZ2V0IGhlcmUsIHRoZW4gd2UgbWF5IG9ubHkgdGFrZSBvbmUgb2YgdHdvIGFjdGlvbnMuCiAgICAgICAgLy8gMS4gc2FuaXRpemUgdGhlIHZhbHVlIGZvciB0aGUgcmVxdWVzdGVkIHR5cGUsIG9yCiAgICAgICAgLy8gMi4gdGhyb3cgYW4gZXhjZXB0aW9uLgogICAgICAgIGlmICh0eXBlID09PSBTQ0VfQ09OVEVYVFMuUkVTT1VSQ0VfVVJMKSB7CiAgICAgICAgICBpZiAoaXNSZXNvdXJjZVVybEFsbG93ZWRCeVBvbGljeShtYXliZVRydXN0ZWQpKSB7CiAgICAgICAgICAgIHJldHVybiBtYXliZVRydXN0ZWQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyAkc2NlTWluRXJyKCdpbnNlY3VybCcsCiAgICAgICAgICAgICAgJ0Jsb2NrZWQgbG9hZGluZyByZXNvdXJjZSBmcm9tIHVybCBub3QgYWxsb3dlZCBieSAkc2NlRGVsZWdhdGUgcG9saWN5LiAgVVJMOiB7MH0nLAogICAgICAgICAgICAgIG1heWJlVHJ1c3RlZC50b1N0cmluZygpKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09IFNDRV9DT05URVhUUy5IVE1MKSB7CiAgICAgICAgICByZXR1cm4gaHRtbFNhbml0aXplcihtYXliZVRydXN0ZWQpOwogICAgICAgIH0KICAgICAgICB0aHJvdyAkc2NlTWluRXJyKCd1bnNhZmUnLCAnQXR0ZW1wdGluZyB0byB1c2UgYW4gdW5zYWZlIHZhbHVlIGluIGEgc2FmZSBjb250ZXh0LicpOwogICAgICB9CgogICAgICByZXR1cm4geyB0cnVzdEFzOiB0cnVzdEFzLAogICAgICAgIGdldFRydXN0ZWQ6IGdldFRydXN0ZWQsCiAgICAgICAgdmFsdWVPZjogdmFsdWVPZiB9OwogICAgfV07CiAgfQoKCiAgLyoqCiAgICogQG5nZG9jIHByb3ZpZGVyCiAgICogQG5hbWUgJHNjZVByb3ZpZGVyCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBUaGUgJHNjZVByb3ZpZGVyIHByb3ZpZGVyIGFsbG93cyBkZXZlbG9wZXJzIHRvIGNvbmZpZ3VyZSB0aGUge0BsaW5rIG5nLiRzY2UgJHNjZX0gc2VydmljZS4KICAgKiAtICAgZW5hYmxlL2Rpc2FibGUgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSkgaW4gYSBtb2R1bGUKICAgKiAtICAgb3ZlcnJpZGUgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gd2l0aCBhIGN1c3RvbSBkZWxlZ2F0ZQogICAqCiAgICogUmVhZCBtb3JlIGFib3V0IHtAbGluayBuZy4kc2NlIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIChTQ0UpfS4KICAgKi8KCiAgLyoganNoaW50IG1heGxlbjogZmFsc2UqLwoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRzY2UKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBgJHNjZWAgaXMgYSBzZXJ2aWNlIHRoYXQgcHJvdmlkZXMgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgc2VydmljZXMgdG8gQW5ndWxhckpTLgogICAqCiAgICogIyBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZwogICAqCiAgICogU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSkgaXMgYSBtb2RlIGluIHdoaWNoIEFuZ3VsYXJKUyByZXF1aXJlcyBiaW5kaW5ncyBpbiBjZXJ0YWluCiAgICogY29udGV4dHMgdG8gcmVzdWx0IGluIGEgdmFsdWUgdGhhdCBpcyBtYXJrZWQgYXMgc2FmZSB0byB1c2UgZm9yIHRoYXQgY29udGV4dC4gIE9uZSBleGFtcGxlIG9mCiAgICogc3VjaCBhIGNvbnRleHQgaXMgYmluZGluZyBhcmJpdHJhcnkgaHRtbCBjb250cm9sbGVkIGJ5IHRoZSB1c2VyIHZpYSBgbmctYmluZC1odG1sYC4gIFdlIHJlZmVyCiAgICogdG8gdGhlc2UgY29udGV4dHMgYXMgcHJpdmlsZWdlZCBvciBTQ0UgY29udGV4dHMuCiAgICoKICAgKiBBcyBvZiB2ZXJzaW9uIDEuMiwgQW5ndWxhciBzaGlwcyB3aXRoIFNDRSBlbmFibGVkIGJ5IGRlZmF1bHQuCiAgICoKICAgKiBOb3RlOiAgV2hlbiBlbmFibGVkICh0aGUgZGVmYXVsdCksIElFOCBpbiBxdWlya3MgbW9kZSBpcyBub3Qgc3VwcG9ydGVkLiAgSW4gdGhpcyBtb2RlLCBJRTggYWxsb3dzCiAgICogb25lIHRvIGV4ZWN1dGUgYXJiaXRyYXJ5IGphdmFzY3JpcHQgYnkgdGhlIHVzZSBvZiB0aGUgZXhwcmVzc2lvbigpIHN5bnRheC4gIFJlZmVyCiAgICogPGh0dHA6Ly9ibG9ncy5tc2RuLmNvbS9iL2llL2FyY2hpdmUvMjAwOC8xMC8xNi9lbmRpbmctZXhwcmVzc2lvbnMuYXNweD4gdG8gbGVhcm4gbW9yZSBhYm91dCB0aGVtLgogICAqIFlvdSBjYW4gZW5zdXJlIHlvdXIgZG9jdW1lbnQgaXMgaW4gc3RhbmRhcmRzIG1vZGUgYW5kIG5vdCBxdWlya3MgbW9kZSBieSBhZGRpbmcgYDwhZG9jdHlwZSBodG1sPmAKICAgKiB0byB0aGUgdG9wIG9mIHlvdXIgSFRNTCBkb2N1bWVudC4KICAgKgogICAqIFNDRSBhc3Npc3RzIGluIHdyaXRpbmcgY29kZSBpbiB3YXkgdGhhdCAoYSkgaXMgc2VjdXJlIGJ5IGRlZmF1bHQgYW5kIChiKSBtYWtlcyBhdWRpdGluZyBmb3IKICAgKiBzZWN1cml0eSB2dWxuZXJhYmlsaXRpZXMgc3VjaCBhcyBYU1MsIGNsaWNramFja2luZywgZXRjLiBhIGxvdCBlYXNpZXIuCiAgICoKICAgKiBIZXJlJ3MgYW4gZXhhbXBsZSBvZiBhIGJpbmRpbmcgaW4gYSBwcml2aWxlZ2VkIGNvbnRleHQ6CiAgICoKICAgKiA8cHJlIGNsYXNzPSJwcmV0dHlwcmludCI+CiAgICogICAgIDxpbnB1dCBuZy1tb2RlbD0idXNlckh0bWwiPgogICAqICAgICA8ZGl2IG5nLWJpbmQtaHRtbD0idXNlckh0bWwiPgogICAqIDwvcHJlPgogICAqCiAgICogTm90aWNlIHRoYXQgYG5nLWJpbmQtaHRtbGAgaXMgYm91bmQgdG8gYHVzZXJIdG1sYCBjb250cm9sbGVkIGJ5IHRoZSB1c2VyLiAgV2l0aCBTQ0UKICAgKiBkaXNhYmxlZCwgdGhpcyBhcHBsaWNhdGlvbiBhbGxvd3MgdGhlIHVzZXIgdG8gcmVuZGVyIGFyYml0cmFyeSBIVE1MIGludG8gdGhlIERJVi4KICAgKiBJbiBhIG1vcmUgcmVhbGlzdGljIGV4YW1wbGUsIG9uZSBtYXkgYmUgcmVuZGVyaW5nIHVzZXIgY29tbWVudHMsIGJsb2cgYXJ0aWNsZXMsIGV0Yy4gdmlhCiAgICogYmluZGluZ3MuICAoSFRNTCBpcyBqdXN0IG9uZSBleGFtcGxlIG9mIGEgY29udGV4dCB3aGVyZSByZW5kZXJpbmcgdXNlciBjb250cm9sbGVkIGlucHV0IGNyZWF0ZXMKICAgKiBzZWN1cml0eSB2dWxuZXJhYmlsaXRpZXMuKQogICAqCiAgICogRm9yIHRoZSBjYXNlIG9mIEhUTUwsIHlvdSBtaWdodCB1c2UgYSBsaWJyYXJ5LCBlaXRoZXIgb24gdGhlIGNsaWVudCBzaWRlLCBvciBvbiB0aGUgc2VydmVyIHNpZGUsCiAgICogdG8gc2FuaXRpemUgdW5zYWZlIEhUTUwgYmVmb3JlIGJpbmRpbmcgdG8gdGhlIHZhbHVlIGFuZCByZW5kZXJpbmcgaXQgaW4gdGhlIGRvY3VtZW50LgogICAqCiAgICogSG93IHdvdWxkIHlvdSBlbnN1cmUgdGhhdCBldmVyeSBwbGFjZSB0aGF0IHVzZWQgdGhlc2UgdHlwZXMgb2YgYmluZGluZ3Mgd2FzIGJvdW5kIHRvIGEgdmFsdWUgdGhhdAogICAqIHdhcyBzYW5pdGl6ZWQgYnkgeW91ciBsaWJyYXJ5IChvciByZXR1cm5lZCBhcyBzYWZlIGZvciByZW5kZXJpbmcgYnkgeW91ciBzZXJ2ZXI/KSAgSG93IGNhbiB5b3UKICAgKiBlbnN1cmUgdGhhdCB5b3UgZGlkbid0IGFjY2lkZW50YWxseSBkZWxldGUgdGhlIGxpbmUgdGhhdCBzYW5pdGl6ZWQgdGhlIHZhbHVlLCBvciByZW5hbWVkIHNvbWUKICAgKiBwcm9wZXJ0aWVzL2ZpZWxkcyBhbmQgZm9yZ290IHRvIHVwZGF0ZSB0aGUgYmluZGluZyB0byB0aGUgc2FuaXRpemVkIHZhbHVlPwogICAqCiAgICogVG8gYmUgc2VjdXJlIGJ5IGRlZmF1bHQsIHlvdSB3YW50IHRvIGVuc3VyZSB0aGF0IGFueSBzdWNoIGJpbmRpbmdzIGFyZSBkaXNhbGxvd2VkIHVubGVzcyB5b3UgY2FuCiAgICogZGV0ZXJtaW5lIHRoYXQgc29tZXRoaW5nIGV4cGxpY2l0bHkgc2F5cyBpdCdzIHNhZmUgdG8gdXNlIGEgdmFsdWUgZm9yIGJpbmRpbmcgaW4gdGhhdAogICAqIGNvbnRleHQuICBZb3UgY2FuIHRoZW4gYXVkaXQgeW91ciBjb2RlIChhIHNpbXBsZSBncmVwIHdvdWxkIGRvKSB0byBlbnN1cmUgdGhhdCB0aGlzIGlzIG9ubHkgZG9uZQogICAqIGZvciB0aG9zZSB2YWx1ZXMgdGhhdCB5b3UgY2FuIGVhc2lseSB0ZWxsIGFyZSBzYWZlIC0gYmVjYXVzZSB0aGV5IHdlcmUgcmVjZWl2ZWQgZnJvbSB5b3VyIHNlcnZlciwKICAgKiBzYW5pdGl6ZWQgYnkgeW91ciBsaWJyYXJ5LCBldGMuICBZb3UgY2FuIG9yZ2FuaXplIHlvdXIgY29kZWJhc2UgdG8gaGVscCB3aXRoIHRoaXMgLSBwZXJoYXBzCiAgICogYWxsb3dpbmcgb25seSB0aGUgZmlsZXMgaW4gYSBzcGVjaWZpYyBkaXJlY3RvcnkgdG8gZG8gdGhpcy4gIEVuc3VyaW5nIHRoYXQgdGhlIGludGVybmFsIEFQSQogICAqIGV4cG9zZWQgYnkgdGhhdCBjb2RlIGRvZXNuJ3QgbWFya3VwIGFyYml0cmFyeSB2YWx1ZXMgYXMgc2FmZSB0aGVuIGJlY29tZXMgYSBtb3JlIG1hbmFnZWFibGUgdGFzay4KICAgKgogICAqIEluIHRoZSBjYXNlIG9mIEFuZ3VsYXJKUycgU0NFIHNlcnZpY2UsIG9uZSB1c2VzIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfQogICAqIChhbmQgc2hvcnRoYW5kIG1ldGhvZHMgc3VjaCBhcyB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzSHRtbCAkc2NlLnRydXN0QXNIdG1sfSwgZXRjLikgdG8KICAgKiBvYnRhaW4gdmFsdWVzIHRoYXQgd2lsbCBiZSBhY2NlcHRlZCBieSBTQ0UgLyBwcml2aWxlZ2VkIGNvbnRleHRzLgogICAqCiAgICoKICAgKiAjIyBIb3cgZG9lcyBpdCB3b3JrPwogICAqCiAgICogSW4gcHJpdmlsZWdlZCBjb250ZXh0cywgZGlyZWN0aXZlcyBhbmQgY29kZSB3aWxsIGJpbmQgdG8gdGhlIHJlc3VsdCBvZiB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkCiAqICRzY2UuZ2V0VHJ1c3RlZChjb250ZXh0LCB2YWx1ZSl9IHJhdGhlciB0aGFuIHRvIHRoZSB2YWx1ZSBkaXJlY3RseS4gIERpcmVjdGl2ZXMgdXNlIHtAbGluawogICAgKiBuZy4kc2NlI3BhcnNlICRzY2UucGFyc2VBc30gcmF0aGVyIHRoYW4gYCRwYXJzZWAgdG8gd2F0Y2ggYXR0cmlidXRlIGJpbmRpbmdzLCB3aGljaCBwZXJmb3JtcyB0aGUKICAgKiB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkICRzY2UuZ2V0VHJ1c3RlZH0gYmVoaW5kIHRoZSBzY2VuZXMgb24gbm9uLWNvbnN0YW50IGxpdGVyYWxzLgogICAqCiAgICogQXMgYW4gZXhhbXBsZSwge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0JpbmRIdG1sIG5nQmluZEh0bWx9IHVzZXMge0BsaW5rCiAgICAqIG5nLiRzY2UjcGFyc2VBc0h0bWwgJHNjZS5wYXJzZUFzSHRtbChiaW5kaW5nIGV4cHJlc3Npb24pfS4gIEhlcmUncyB0aGUgYWN0dWFsIGNvZGUgKHNsaWdodGx5CiAgICogc2ltcGxpZmllZCk6CiAgICoKICAgKiA8cHJlIGNsYXNzPSJwcmV0dHlwcmludCI+CiAgICogICB2YXIgbmdCaW5kSHRtbERpcmVjdGl2ZSA9IFsnJHNjZScsIGZ1bmN0aW9uKCRzY2UpIHsKICogICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogKiAgICAgICBzY29wZS4kd2F0Y2goJHNjZS5wYXJzZUFzSHRtbChhdHRyLm5nQmluZEh0bWwpLCBmdW5jdGlvbih2YWx1ZSkgewogKiAgICAgICAgIGVsZW1lbnQuaHRtbCh2YWx1ZSB8fCAnJyk7CiAqICAgICAgIH0pOwogKiAgICAgfTsKICogICB9XTsKICAgKiA8L3ByZT4KICAgKgogICAqICMjIEltcGFjdCBvbiBsb2FkaW5nIHRlbXBsYXRlcwogICAqCiAgICogVGhpcyBhcHBsaWVzIGJvdGggdG8gdGhlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlIGBuZy1pbmNsdWRlYH0gZGlyZWN0aXZlIGFzIHdlbGwgYXMKICAgKiBgdGVtcGxhdGVVcmxgJ3Mgc3BlY2lmaWVkIGJ5IHtAbGluayBndWlkZS9kaXJlY3RpdmUgZGlyZWN0aXZlc30uCiAgICoKICAgKiBCeSBkZWZhdWx0LCBBbmd1bGFyIG9ubHkgbG9hZHMgdGVtcGxhdGVzIGZyb20gdGhlIHNhbWUgZG9tYWluIGFuZCBwcm90b2NvbCBhcyB0aGUgYXBwbGljYXRpb24KICAgKiBkb2N1bWVudC4gIFRoaXMgaXMgZG9uZSBieSBjYWxsaW5nIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRSZXNvdXJjZVVybAogKiAkc2NlLmdldFRydXN0ZWRSZXNvdXJjZVVybH0gb24gdGhlIHRlbXBsYXRlIFVSTC4gIFRvIGxvYWQgdGVtcGxhdGVzIGZyb20gb3RoZXIgZG9tYWlucyBhbmQvb3IKICAgKiBwcm90b2NvbHMsIHlvdSBtYXkgZWl0aGVyIGVpdGhlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3Qgd2hpdGVsaXN0CiAqIHRoZW19IG9yIHtAbGluayBuZy4kc2NlI3RydXN0QXNSZXNvdXJjZVVybCB3cmFwIGl0fSBpbnRvIGEgdHJ1c3RlZCB2YWx1ZS4KICAgKgogICAqICpQbGVhc2Ugbm90ZSo6CiAgICogVGhlIGJyb3dzZXIncwogICAqIFtTYW1lIE9yaWdpbiBQb2xpY3ldKGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvYnJvd3NlcnNlYy93aWtpL1BhcnQyI1NhbWUtb3JpZ2luX3BvbGljeV9mb3JfWE1MSHR0cFJlcXVlc3QpCiAgICogYW5kIFtDcm9zcy1PcmlnaW4gUmVzb3VyY2UgU2hhcmluZyAoQ09SUyldKGh0dHA6Ly93d3cudzMub3JnL1RSL2NvcnMvKQogICAqIHBvbGljeSBhcHBseSBpbiBhZGRpdGlvbiB0byB0aGlzIGFuZCBtYXkgZnVydGhlciByZXN0cmljdCB3aGV0aGVyIHRoZSB0ZW1wbGF0ZSBpcyBzdWNjZXNzZnVsbHkKICAgKiBsb2FkZWQuICBUaGlzIG1lYW5zIHRoYXQgd2l0aG91dCB0aGUgcmlnaHQgQ09SUyBwb2xpY3ksIGxvYWRpbmcgdGVtcGxhdGVzIGZyb20gYSBkaWZmZXJlbnQgZG9tYWluCiAgICogd29uJ3Qgd29yayBvbiBhbGwgYnJvd3NlcnMuICBBbHNvLCBsb2FkaW5nIHRlbXBsYXRlcyBmcm9tIGBmaWxlOi8vYCBVUkwgZG9lcyBub3Qgd29yayBvbiBzb21lCiAgICogYnJvd3NlcnMuCiAgICoKICAgKiAjIyBUaGlzIGZlZWxzIGxpa2UgdG9vIG11Y2ggb3ZlcmhlYWQgZm9yIHRoZSBkZXZlbG9wZXI/CiAgICoKICAgKiBJdCdzIGltcG9ydGFudCB0byByZW1lbWJlciB0aGF0IFNDRSBvbmx5IGFwcGxpZXMgdG8gaW50ZXJwb2xhdGlvbiBleHByZXNzaW9ucy4KICAgKgogICAqIElmIHlvdXIgZXhwcmVzc2lvbnMgYXJlIGNvbnN0YW50IGxpdGVyYWxzLCB0aGV5J3JlIGF1dG9tYXRpY2FsbHkgdHJ1c3RlZCBhbmQgeW91IGRvbid0IG5lZWQgdG8KICAgKiBjYWxsIGAkc2NlLnRydXN0QXNgIG9uIHRoZW0gKHJlbWVtYmVyIHRvIGluY2x1ZGUgdGhlIGBuZ1Nhbml0aXplYCBtb2R1bGUpIChlLmcuCiAgICogYDxkaXYgbmctYmluZC1odG1sPSInPGI+aW1wbGljaXRseSB0cnVzdGVkPC9iPiciPjwvZGl2PmApIGp1c3Qgd29ya3MuCiAgICoKICAgKiBBZGRpdGlvbmFsbHksIGBhW2hyZWZdYCBhbmQgYGltZ1tzcmNdYCBhdXRvbWF0aWNhbGx5IHNhbml0aXplIHRoZWlyIFVSTHMgYW5kIGRvIG5vdCBwYXNzIHRoZW0KICAgKiB0aHJvdWdoIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWQgJHNjZS5nZXRUcnVzdGVkfS4gIFNDRSBkb2Vzbid0IHBsYXkgYSByb2xlIGhlcmUuCiAgICoKICAgKiBUaGUgaW5jbHVkZWQge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSAkc2NlRGVsZWdhdGV9IGNvbWVzIHdpdGggc2FuZSBkZWZhdWx0cyB0byBhbGxvdyB5b3UgdG8gbG9hZAogICAqIHRlbXBsYXRlcyBpbiBgbmctaW5jbHVkZWAgZnJvbSB5b3VyIGFwcGxpY2F0aW9uJ3MgZG9tYWluIHdpdGhvdXQgaGF2aW5nIHRvIGV2ZW4ga25vdyBhYm91dCBTQ0UuCiAgICogSXQgYmxvY2tzIGxvYWRpbmcgdGVtcGxhdGVzIGZyb20gb3RoZXIgZG9tYWlucyBvciBsb2FkaW5nIHRlbXBsYXRlcyBvdmVyIGh0dHAgZnJvbSBhbiBodHRwcwogICAqIHNlcnZlZCBkb2N1bWVudC4gIFlvdSBjYW4gY2hhbmdlIHRoZXNlIGJ5IHNldHRpbmcgeW91ciBvd24gY3VzdG9tIHtAbGluawogICAgKiBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCB3aGl0ZWxpc3RzfSBhbmQge0BsaW5rCiAgICAqIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0IGJsYWNrbGlzdHN9IGZvciBtYXRjaGluZyBzdWNoIFVSTHMuCiAgICoKICAgKiBUaGlzIHNpZ25pZmljYW50bHkgcmVkdWNlcyB0aGUgb3ZlcmhlYWQuICBJdCBpcyBmYXIgZWFzaWVyIHRvIHBheSB0aGUgc21hbGwgb3ZlcmhlYWQgYW5kIGhhdmUgYW4KICAgKiBhcHBsaWNhdGlvbiB0aGF0J3Mgc2VjdXJlIGFuZCBjYW4gYmUgYXVkaXRlZCB0byB2ZXJpZnkgdGhhdCB3aXRoIG11Y2ggbW9yZSBlYXNlIHRoYW4gYm9sdGluZwogICAqIHNlY3VyaXR5IG9udG8gYW4gYXBwbGljYXRpb24gbGF0ZXIuCiAgICoKICAgKiA8YSBuYW1lPSJjb250ZXh0cyI+PC9hPgogICAqICMjIFdoYXQgdHJ1c3RlZCBjb250ZXh0IHR5cGVzIGFyZSBzdXBwb3J0ZWQ/CiAgICoKICAgKiB8IENvbnRleHQgICAgICAgICAgICAgfCBOb3RlcyAgICAgICAgICB8CiAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tfAogICAqIHwgYCRzY2UuSFRNTGAgICAgICAgICB8IEZvciBIVE1MIHRoYXQncyBzYWZlIHRvIHNvdXJjZSBpbnRvIHRoZSBhcHBsaWNhdGlvbi4gIFRoZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQmluZEh0bWwgbmdCaW5kSHRtbH0gZGlyZWN0aXZlIHVzZXMgdGhpcyBjb250ZXh0IGZvciBiaW5kaW5ncy4gSWYgYW4gdW5zYWZlIHZhbHVlIGlzIGVuY291bnRlcmVkIGFuZCB0aGUge0BsaW5rIG5nU2FuaXRpemUgJHNhbml0aXplfSBtb2R1bGUgaXMgcHJlc2VudCB0aGlzIHdpbGwgc2FuaXRpemUgdGhlIHZhbHVlIGluc3RlYWQgb2YgdGhyb3dpbmcgYW4gZXJyb3IuIHwKICAgKiB8IGAkc2NlLkNTU2AgICAgICAgICAgfCBGb3IgQ1NTIHRoYXQncyBzYWZlIHRvIHNvdXJjZSBpbnRvIHRoZSBhcHBsaWNhdGlvbi4gIEN1cnJlbnRseSB1bnVzZWQuICBGZWVsIGZyZWUgdG8gdXNlIGl0IGluIHlvdXIgb3duIGRpcmVjdGl2ZXMuIHwKICAgKiB8IGAkc2NlLlVSTGAgICAgICAgICAgfCBGb3IgVVJMcyB0aGF0IGFyZSBzYWZlIHRvIGZvbGxvdyBhcyBsaW5rcy4gIEN1cnJlbnRseSB1bnVzZWQgKGA8YSBocmVmPWAgYW5kIGA8aW1nIHNyYz1gIHNhbml0aXplIHRoZWlyIHVybHMgYW5kIGRvbid0IGNvbnN0aXR1dGUgYW4gU0NFIGNvbnRleHQuIHwKICAgKiB8IGAkc2NlLlJFU09VUkNFX1VSTGAgfCBGb3IgVVJMcyB0aGF0IGFyZSBub3Qgb25seSBzYWZlIHRvIGZvbGxvdyBhcyBsaW5rcywgYnV0IHdob3NlIGNvbnRlbnRzIGFyZSBhbHNvIHNhZmUgdG8gaW5jbHVkZSBpbiB5b3VyIGFwcGxpY2F0aW9uLiAgRXhhbXBsZXMgaW5jbHVkZSBgbmctaW5jbHVkZWAsIGBzcmNgIC8gYG5nU3JjYCBiaW5kaW5ncyBmb3IgdGFncyBvdGhlciB0aGFuIGBJTUdgIChlLmcuIGBJRlJBTUVgLCBgT0JKRUNUYCwgZXRjLikgIDxicj48YnI+Tm90ZSB0aGF0IGAkc2NlLlJFU09VUkNFX1VSTGAgbWFrZXMgYSBzdHJvbmdlciBzdGF0ZW1lbnQgYWJvdXQgdGhlIFVSTCB0aGFuIGAkc2NlLlVSTGAgZG9lcyBhbmQgdGhlcmVmb3JlIGNvbnRleHRzIHJlcXVpcmluZyB2YWx1ZXMgdHJ1c3RlZCBmb3IgYCRzY2UuUkVTT1VSQ0VfVVJMYCBjYW4gYmUgdXNlZCBhbnl3aGVyZSB0aGF0IHZhbHVlcyB0cnVzdGVkIGZvciBgJHNjZS5VUkxgIGFyZSByZXF1aXJlZC4gfAogICAqIHwgYCRzY2UuSlNgICAgICAgICAgICB8IEZvciBKYXZhU2NyaXB0IHRoYXQgaXMgc2FmZSB0byBleGVjdXRlIGluIHlvdXIgYXBwbGljYXRpb24ncyBjb250ZXh0LiAgQ3VycmVudGx5IHVudXNlZC4gIEZlZWwgZnJlZSB0byB1c2UgaXQgaW4geW91ciBvd24gZGlyZWN0aXZlcy4gfAogICAqCiAgICogIyMgRm9ybWF0IG9mIGl0ZW1zIGluIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCByZXNvdXJjZVVybFdoaXRlbGlzdH0ve0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0IEJsYWNrbGlzdH0gPGEgbmFtZT0icmVzb3VyY2VVcmxQYXR0ZXJuSXRlbSI+PC9hPgogICAqCiAgICogIEVhY2ggZWxlbWVudCBpbiB0aGVzZSBhcnJheXMgbXVzdCBiZSBvbmUgb2YgdGhlIGZvbGxvd2luZzoKICAgKgogICAqICAtICoqJ3NlbGYnKioKICAgKiAgICAtIFRoZSBzcGVjaWFsICoqc3RyaW5nKiosIGAnc2VsZidgLCBjYW4gYmUgdXNlZCB0byBtYXRjaCBhZ2FpbnN0IGFsbCBVUkxzIG9mIHRoZSAqKnNhbWUKICAgKiAgICAgIGRvbWFpbioqIGFzIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB1c2luZyB0aGUgKipzYW1lIHByb3RvY29sKiouCiAgICogIC0gKipTdHJpbmcqKiAoZXhjZXB0IHRoZSBzcGVjaWFsIHZhbHVlIGAnc2VsZidgKQogICAqICAgIC0gVGhlIHN0cmluZyBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGZ1bGwgKm5vcm1hbGl6ZWQgLyBhYnNvbHV0ZSBVUkwqIG9mIHRoZSByZXNvdXJjZQogICAqICAgICAgYmVpbmcgdGVzdGVkIChzdWJzdHJpbmcgbWF0Y2hlcyBhcmUgbm90IGdvb2QgZW5vdWdoLikKICAgKiAgICAtIFRoZXJlIGFyZSBleGFjdGx5ICoqdHdvIHdpbGRjYXJkIHNlcXVlbmNlcyoqIC0gYCpgIGFuZCBgKipgLiAgQWxsIG90aGVyIGNoYXJhY3RlcnMKICAgKiAgICAgIG1hdGNoIHRoZW1zZWx2ZXMuCiAgICogICAgLSBgKmA6IG1hdGNoZXMgemVybyBvciBtb3JlIG9jY3VycmVuY2VzIG9mIGFueSBjaGFyYWN0ZXIgb3RoZXIgdGhhbiBvbmUgb2YgdGhlIGZvbGxvd2luZyA2CiAgICogICAgICBjaGFyYWN0ZXJzOiAnYDpgJywgJ2AvYCcsICdgLmAnLCAnYD9gJywgJ2AmYCcgYW5kICc7Jy4gIEl0J3MgYSB1c2VmdWwgd2lsZGNhcmQgZm9yIHVzZQogICAqICAgICAgaW4gYSB3aGl0ZWxpc3QuCiAgICogICAgLSBgKipgOiBtYXRjaGVzIHplcm8gb3IgbW9yZSBvY2N1cnJlbmNlcyBvZiAqYW55KiBjaGFyYWN0ZXIuICBBcyBzdWNoLCBpdCdzIG5vdAogICAqICAgICAgbm90IGFwcHJvcHJpYXRlIHRvIHVzZSBpbiBmb3IgYSBzY2hlbWUsIGRvbWFpbiwgZXRjLiBhcyBpdCB3b3VsZCBtYXRjaCB0b28gbXVjaC4gIChlLmcuCiAgICogICAgICBodHRwOi8vKiouZXhhbXBsZS5jb20vIHdvdWxkIG1hdGNoIGh0dHA6Ly9ldmlsLmNvbS8/aWdub3JlPS5leGFtcGxlLmNvbS8gYW5kIHRoYXQgbWlnaHQKICAgKiAgICAgIG5vdCBoYXZlIGJlZW4gdGhlIGludGVudGlvbi4pICBJdHMgdXNhZ2UgYXQgdGhlIHZlcnkgZW5kIG9mIHRoZSBwYXRoIGlzIG9rLiAgKGUuZy4KICAgKiAgICAgIGh0dHA6Ly9mb28uZXhhbXBsZS5jb20vdGVtcGxhdGVzLyoqKS4KICAgKiAgLSAqKlJlZ0V4cCoqICgqc2VlIGNhdmVhdCBiZWxvdyopCiAgICogICAgLSAqQ2F2ZWF0KjogIFdoaWxlIHJlZ3VsYXIgZXhwcmVzc2lvbnMgYXJlIHBvd2VyZnVsIGFuZCBvZmZlciBncmVhdCBmbGV4aWJpbGl0eSwgIHRoZWlyIHN5bnRheAogICAqICAgICAgKGFuZCBhbGwgdGhlIGluZXZpdGFibGUgZXNjYXBpbmcpIG1ha2VzIHRoZW0gKmhhcmRlciB0byBtYWludGFpbiouICBJdCdzIGVhc3kgdG8KICAgKiAgICAgIGFjY2lkZW50YWxseSBpbnRyb2R1Y2UgYSBidWcgd2hlbiBvbmUgdXBkYXRlcyBhIGNvbXBsZXggZXhwcmVzc2lvbiAoaW1obywgYWxsIHJlZ2V4ZXMgc2hvdWxkCiAgICogICAgICBoYXZlIGdvb2QgdGVzdCBjb3ZlcmFnZS4pLiAgRm9yIGluc3RhbmNlLCB0aGUgdXNlIG9mIGAuYCBpbiB0aGUgcmVnZXggaXMgY29ycmVjdCBvbmx5IGluIGEKICAgKiAgICAgIHNtYWxsIG51bWJlciBvZiBjYXNlcy4gIEEgYC5gIGNoYXJhY3RlciBpbiB0aGUgcmVnZXggdXNlZCB3aGVuIG1hdGNoaW5nIHRoZSBzY2hlbWUgb3IgYQogICAqICAgICAgc3ViZG9tYWluIGNvdWxkIGJlIG1hdGNoZWQgYWdhaW5zdCBhIGA6YCBvciBsaXRlcmFsIGAuYCB0aGF0IHdhcyBsaWtlbHkgbm90IGludGVuZGVkLiAgIEl0CiAgICogICAgICBpcyBoaWdobHkgcmVjb21tZW5kZWQgdG8gdXNlIHRoZSBzdHJpbmcgcGF0dGVybnMgYW5kIG9ubHkgZmFsbCBiYWNrIHRvIHJlZ3VsYXIgZXhwcmVzc2lvbnMKICAgKiAgICAgIGlmIHRoZXkgYXMgYSBsYXN0IHJlc29ydC4KICAgKiAgICAtIFRoZSByZWd1bGFyIGV4cHJlc3Npb24gbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBSZWdFeHAgKGkuZS4gbm90IGEgc3RyaW5nLikgIEl0IGlzCiAgICogICAgICBtYXRjaGVkIGFnYWluc3QgdGhlICoqZW50aXJlKiogKm5vcm1hbGl6ZWQgLyBhYnNvbHV0ZSBVUkwqIG9mIHRoZSByZXNvdXJjZSBiZWluZyB0ZXN0ZWQKICAgKiAgICAgIChldmVuIHdoZW4gdGhlIFJlZ0V4cCBkaWQgbm90IGhhdmUgdGhlIGBeYCBhbmQgYCRgIGNvZGVzLikgIEluIGFkZGl0aW9uLCBhbnkgZmxhZ3MKICAgKiAgICAgIHByZXNlbnQgb24gdGhlIFJlZ0V4cCAoc3VjaCBhcyBtdWx0aWxpbmUsIGdsb2JhbCwgaWdub3JlQ2FzZSkgYXJlIGlnbm9yZWQuCiAgICogICAgLSBJZiB5b3UgYXJlIGdlbmVyYXRpbmcgeW91ciBKYXZhU2NyaXB0IGZyb20gc29tZSBvdGhlciB0ZW1wbGF0aW5nIGVuZ2luZSAobm90CiAgICogICAgICByZWNvbW1lbmRlZCwgZS5nLiBpbiBpc3N1ZSBbIzQwMDZdKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIuanMvaXNzdWVzLzQwMDYpKSwKICAgKiAgICAgIHJlbWVtYmVyIHRvIGVzY2FwZSB5b3VyIHJlZ3VsYXIgZXhwcmVzc2lvbiAoYW5kIGJlIGF3YXJlIHRoYXQgeW91IG1pZ2h0IG5lZWQgbW9yZSB0aGFuCiAgICogICAgICBvbmUgbGV2ZWwgb2YgZXNjYXBpbmcgZGVwZW5kaW5nIG9uIHlvdXIgdGVtcGxhdGluZyBlbmdpbmUgYW5kIHRoZSB3YXkgeW91IGludGVycG9sYXRlZAogICAqICAgICAgdGhlIHZhbHVlLikgIERvIG1ha2UgdXNlIG9mIHlvdXIgcGxhdGZvcm0ncyBlc2NhcGluZyBtZWNoYW5pc20gYXMgaXQgbWlnaHQgYmUgZ29vZAogICAqICAgICAgZW5vdWdoIGJlZm9yZSBjb2RpbmcgeW91ciBvd24uICBlLmcuIFJ1YnkgaGFzCiAgICogICAgICBbUmVnZXhwLmVzY2FwZShzdHIpXShodHRwOi8vd3d3LnJ1YnktZG9jLm9yZy9jb3JlLTIuMC4wL1JlZ2V4cC5odG1sI21ldGhvZC1jLWVzY2FwZSkKICAgKiAgICAgIGFuZCBQeXRob24gaGFzIFtyZS5lc2NhcGVdKGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvbGlicmFyeS9yZS5odG1sI3JlLmVzY2FwZSkuCiAgICogICAgICBKYXZhc2NyaXB0IGxhY2tzIGEgc2ltaWxhciBidWlsdCBpbiBmdW5jdGlvbiBmb3IgZXNjYXBpbmcuICBUYWtlIGEgbG9vayBhdCBHb29nbGUKICAgKiAgICAgIENsb3N1cmUgbGlicmFyeSdzIFtnb29nLnN0cmluZy5yZWdFeHBFc2NhcGUocyldKAogICAqICAgICAgaHR0cDovL2RvY3MuY2xvc3VyZS1saWJyYXJ5Lmdvb2dsZWNvZGUuY29tL2dpdC9jbG9zdXJlX2dvb2dfc3RyaW5nX3N0cmluZy5qcy5zb3VyY2UuaHRtbCNsaW5lOTYyKS4KICAgKgogICAqIFJlZmVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciAkc2NlRGVsZWdhdGVQcm92aWRlcn0gZm9yIGFuIGV4YW1wbGUuCiAgICoKICAgKiAjIyBTaG93IG1lIGFuIGV4YW1wbGUgdXNpbmcgU0NFLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJteVNjZUFwcCIgZGVwcz0iYW5ndWxhci1zYW5pdGl6ZS5qcyI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9Im15QXBwQ29udHJvbGxlciBhcyBteUN0cmwiPgogICA8aSBuZy1iaW5kLWh0bWw9Im15Q3RybC5leHBsaWNpdGx5VHJ1c3RlZEh0bWwiIGlkPSJleHBsaWNpdGx5VHJ1c3RlZEh0bWwiPjwvaT48YnI+PGJyPgogICA8Yj5Vc2VyIGNvbW1lbnRzPC9iPjxicj4KICAgQnkgZGVmYXVsdCwgSFRNTCB0aGF0IGlzbid0IGV4cGxpY2l0bHkgdHJ1c3RlZCAoZS5nLiBBbGljZSdzIGNvbW1lbnQpIGlzIHNhbml0aXplZCB3aGVuCiAgICRzYW5pdGl6ZSBpcyBhdmFpbGFibGUuICBJZiAkc2FuaXRpemUgaXNuJ3QgYXZhaWxhYmxlLCB0aGlzIHJlc3VsdHMgaW4gYW4gZXJyb3IgaW5zdGVhZCBvZiBhbgogICBleHBsb2l0LgogICA8ZGl2IGNsYXNzPSJ3ZWxsIj4KICAgPGRpdiBuZy1yZXBlYXQ9InVzZXJDb21tZW50IGluIG15Q3RybC51c2VyQ29tbWVudHMiPgogICA8Yj57e3VzZXJDb21tZW50Lm5hbWV9fTwvYj46CiAgIDxzcGFuIG5nLWJpbmQtaHRtbD0idXNlckNvbW1lbnQuaHRtbENvbW1lbnQiIGNsYXNzPSJodG1sQ29tbWVudCI+PC9zcGFuPgogICA8YnI+CiAgIDwvZGl2PgogICA8L2Rpdj4KICAgPC9kaXY+CiAgIDwvZmlsZT4KCiAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgIHZhciBteVNjZUFwcCA9IGFuZ3VsYXIubW9kdWxlKCdteVNjZUFwcCcsIFsnbmdTYW5pdGl6ZSddKTsKCiAgIG15U2NlQXBwLmNvbnRyb2xsZXIoIm15QXBwQ29udHJvbGxlciIsIGZ1bmN0aW9uIG15QXBwQ29udHJvbGxlcigkaHR0cCwgJHRlbXBsYXRlQ2FjaGUsICRzY2UpIHsKICAgIHZhciBzZWxmID0gdGhpczsKICAgICRodHRwLmdldCgidGVzdF9kYXRhLmpzb24iLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuc3VjY2VzcyhmdW5jdGlvbih1c2VyQ29tbWVudHMpIHsKICAgICAgc2VsZi51c2VyQ29tbWVudHMgPSB1c2VyQ29tbWVudHM7CiAgICB9KTsKICAgIHNlbGYuZXhwbGljaXRseVRydXN0ZWRIdG1sID0gJHNjZS50cnVzdEFzSHRtbCgKICAgICAgICAnPHNwYW4gb25tb3VzZW92ZXI9InRoaXMudGV4dENvbnRlbnQ9JnF1b3Q7RXhwbGljaXRseSB0cnVzdGVkIEhUTUwgYnlwYXNzZXMgJyArCiAgICAgICAgJ3Nhbml0aXphdGlvbi4mcXVvdDsiPkhvdmVyIG92ZXIgdGhpcyB0ZXh0Ljwvc3Bhbj4nKTsKICB9KTsKICAgPC9maWxlPgoKICAgPGZpbGUgbmFtZT0idGVzdF9kYXRhLmpzb24iPgogICBbCiAgIHsgIm5hbWUiOiAiQWxpY2UiLAogICAgImh0bWxDb21tZW50IjoKICAgICAgICAiPHNwYW4gb25tb3VzZW92ZXI9J3RoaXMudGV4dENvbnRlbnQ9XCJQV04zRCFcIic+SXMgPGk+YW55b25lPC9pPiByZWFkaW5nIHRoaXM/PC9zcGFuPiIKICB9LAogICB7ICJuYW1lIjogIkJvYiIsCiAgICAiaHRtbENvbW1lbnQiOiAiPGk+WWVzITwvaT4gIEFtIEkgdGhlIG9ubHkgb3RoZXIgb25lPyIKICB9CiAgIF0KICAgPC9maWxlPgoKICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGRlc2NyaWJlKCdTQ0UgZG9jIGRlbW8nLCBmdW5jdGlvbigpIHsKICAgIGl0KCdzaG91bGQgc2FuaXRpemUgdW50cnVzdGVkIHZhbHVlcycsIGZ1bmN0aW9uKCkgewogICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJy5odG1sQ29tbWVudCcpKS5nZXRJbm5lckh0bWwoKSkKICAgICAgICAgIC50b0JlKCc8c3Bhbj5JcyA8aT5hbnlvbmU8L2k+IHJlYWRpbmcgdGhpcz88L3NwYW4+Jyk7CiAgICB9KTsKCiAgICBpdCgnc2hvdWxkIE5PVCBzYW5pdGl6ZSBleHBsaWNpdGx5IHRydXN0ZWQgdmFsdWVzJywgZnVuY3Rpb24oKSB7CiAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdleHBsaWNpdGx5VHJ1c3RlZEh0bWwnKSkuZ2V0SW5uZXJIdG1sKCkpLnRvQmUoCiAgICAgICAgICAnPHNwYW4gb25tb3VzZW92ZXI9InRoaXMudGV4dENvbnRlbnQ9JnF1b3Q7RXhwbGljaXRseSB0cnVzdGVkIEhUTUwgYnlwYXNzZXMgJyArCiAgICAgICAgICAnc2FuaXRpemF0aW9uLiZxdW90OyI+SG92ZXIgb3ZlciB0aGlzIHRleHQuPC9zcGFuPicpOwogICAgfSk7CiAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqCiAgICoKICAgKgogICAqICMjIENhbiBJIGRpc2FibGUgU0NFIGNvbXBsZXRlbHk/CiAgICoKICAgKiBZZXMsIHlvdSBjYW4uICBIb3dldmVyLCB0aGlzIGlzIHN0cm9uZ2x5IGRpc2NvdXJhZ2VkLiAgU0NFIGdpdmVzIHlvdSBhIGxvdCBvZiBzZWN1cml0eSBiZW5lZml0cwogICAqIGZvciBsaXR0bGUgY29kaW5nIG92ZXJoZWFkLiAgSXQgd2lsbCBiZSBtdWNoIGhhcmRlciB0byB0YWtlIGFuIFNDRSBkaXNhYmxlZCBhcHBsaWNhdGlvbiBhbmQKICAgKiBlaXRoZXIgc2VjdXJlIGl0IG9uIHlvdXIgb3duIG9yIGVuYWJsZSBTQ0UgYXQgYSBsYXRlciBzdGFnZS4gIEl0IG1pZ2h0IG1ha2Ugc2Vuc2UgdG8gZGlzYWJsZSBTQ0UKICAgKiBmb3IgY2FzZXMgd2hlcmUgeW91IGhhdmUgYSBsb3Qgb2YgZXhpc3RpbmcgY29kZSB0aGF0IHdhcyB3cml0dGVuIGJlZm9yZSBTQ0Ugd2FzIGludHJvZHVjZWQgYW5kCiAgICogeW91J3JlIG1pZ3JhdGluZyB0aGVtIGEgbW9kdWxlIGF0IGEgdGltZS4KICAgKgogICAqIFRoYXQgc2FpZCwgaGVyZSdzIGhvdyB5b3UgY2FuIGNvbXBsZXRlbHkgZGlzYWJsZSBTQ0U6CiAgICoKICAgKiA8cHJlIGNsYXNzPSJwcmV0dHlwcmludCI+CiAgICogICBhbmd1bGFyLm1vZHVsZSgnbXlBcHBXaXRoU2NlRGlzYWJsZWRteUFwcCcsIFtdKS5jb25maWcoZnVuY3Rpb24oJHNjZVByb3ZpZGVyKSB7CiAqICAgICAvLyBDb21wbGV0ZWx5IGRpc2FibGUgU0NFLiAgRm9yIGRlbW9uc3RyYXRpb24gcHVycG9zZXMgb25seSEKICogICAgIC8vIERvIG5vdCB1c2UgaW4gbmV3IHByb2plY3RzLgogKiAgICAgJHNjZVByb3ZpZGVyLmVuYWJsZWQoZmFsc2UpOwogKiAgIH0pOwogICAqIDwvcHJlPgogICAqCiAgICovCiAgLyoganNoaW50IG1heGxlbjogMTAwICovCgogIGZ1bmN0aW9uICRTY2VQcm92aWRlcigpIHsKICAgIHZhciBlbmFibGVkID0gdHJ1ZTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2VQcm92aWRlciNlbmFibGVkCiAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICoKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHZhbHVlIElmIHByb3ZpZGVkLCB0aGVuIGVuYWJsZXMvZGlzYWJsZXMgU0NFLgogICAgICogQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiBTQ0UgaXMgZW5hYmxlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRW5hYmxlcy9kaXNhYmxlcyBTQ0UgYW5kIHJldHVybnMgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgKi8KICAgIHRoaXMuZW5hYmxlZCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIGVuYWJsZWQgPSAhIXZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBlbmFibGVkOwogICAgfTsKCgogICAgLyogRGVzaWduIG5vdGVzIG9uIHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGZvciBTQ0UuCiAgICAgKgogICAgICogVGhlIEFQSSBjb250cmFjdCBmb3IgdGhlIFNDRSBkZWxlZ2F0ZQogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICogVGhlIFNDRSBkZWxlZ2F0ZSBvYmplY3QgbXVzdCBwcm92aWRlIHRoZSBmb2xsb3dpbmcgMyBtZXRob2RzOgogICAgICoKICAgICAqIC0gdHJ1c3RBcyhjb250ZXh0RW51bSwgdmFsdWUpCiAgICAgKiAgICAgVGhpcyBtZXRob2QgaXMgdXNlZCB0byB0ZWxsIHRoZSBTQ0Ugc2VydmljZSB0aGF0IHRoZSBwcm92aWRlZCB2YWx1ZSBpcyBPSyB0byB1c2UgaW4gdGhlCiAgICAgKiAgICAgY29udGV4dHMgc3BlY2lmaWVkIGJ5IGNvbnRleHRFbnVtLiAgSXQgbXVzdCByZXR1cm4gYW4gb2JqZWN0IHRoYXQgd2lsbCBiZSBhY2NlcHRlZCBieQogICAgICogICAgIGdldFRydXN0ZWQoKSBmb3IgYSBjb21wYXRpYmxlIGNvbnRleHRFbnVtIGFuZCByZXR1cm4gdGhpcyB2YWx1ZS4KICAgICAqCiAgICAgKiAtIHZhbHVlT2YodmFsdWUpCiAgICAgKiAgICAgRm9yIHZhbHVlcyB0aGF0IHdlcmUgbm90IHByb2R1Y2VkIGJ5IHRydXN0QXMoKSwgcmV0dXJuIHRoZW0gYXMgaXMuICBGb3IgdmFsdWVzIHRoYXQgd2VyZQogICAgICogICAgIHByb2R1Y2VkIGJ5IHRydXN0QXMoKSwgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIGlucHV0IHZhbHVlIHRvIHRydXN0QXMuICBCYXNpY2FsbHksIGlmCiAgICAgKiAgICAgdHJ1c3RBcyBpcyB3cmFwcGluZyB0aGUgZ2l2ZW4gdmFsdWVzIGludG8gc29tZSB0eXBlLCB0aGlzIG9wZXJhdGlvbiB1bndyYXBzIGl0IHdoZW4gZ2l2ZW4KICAgICAqICAgICBzdWNoIGEgdmFsdWUuCiAgICAgKgogICAgICogLSBnZXRUcnVzdGVkKGNvbnRleHRFbnVtLCB2YWx1ZSkKICAgICAqICAgICBUaGlzIGZ1bmN0aW9uIHNob3VsZCByZXR1cm4gdGhlIGEgdmFsdWUgdGhhdCBpcyBzYWZlIHRvIHVzZSBpbiB0aGUgY29udGV4dCBzcGVjaWZpZWQgYnkKICAgICAqICAgICBjb250ZXh0RW51bSBvciB0aHJvdyBhbmQgZXhjZXB0aW9uIG90aGVyd2lzZS4KICAgICAqCiAgICAgKiBOT1RFOiBUaGlzIGNvbnRyYWN0IGRlbGliZXJhdGVseSBkb2VzIE5PVCBzdGF0ZSB0aGF0IHZhbHVlcyByZXR1cm5lZCBieSB0cnVzdEFzKCkgbXVzdCBiZQogICAgICogb3BhcXVlIG9yIHdyYXBwZWQgaW4gc29tZSBob2xkZXIgb2JqZWN0LiAgVGhhdCBoYXBwZW5zIHRvIGJlIGFuIGltcGxlbWVudGF0aW9uIGRldGFpbC4gIEZvcgogICAgICogaW5zdGFuY2UsIGFuIGltcGxlbWVudGF0aW9uIGNvdWxkIG1haW50YWluIGEgcmVnaXN0cnkgb2YgYWxsIHRydXN0ZWQgb2JqZWN0cyBieSBjb250ZXh0LiAgSW4KICAgICAqIHN1Y2ggYSBjYXNlLCB0cnVzdEFzKCkgd291bGQgcmV0dXJuIHRoZSBzYW1lIG9iamVjdCB0aGF0IHdhcyBwYXNzZWQgaW4uICBnZXRUcnVzdGVkKCkgd291bGQKICAgICAqIHJldHVybiB0aGUgc2FtZSBvYmplY3QgcGFzc2VkIGluIGlmIGl0IHdhcyBmb3VuZCBpbiB0aGUgcmVnaXN0cnkgdW5kZXIgYSBjb21wYXRpYmxlIGNvbnRleHQgb3IKICAgICAqIHRocm93IGFuIGV4Y2VwdGlvbiBvdGhlcndpc2UuICBBbiBpbXBsZW1lbnRhdGlvbiBtaWdodCBvbmx5IHdyYXAgdmFsdWVzIHNvbWUgb2YgdGhlIHRpbWUgYmFzZWQKICAgICAqIG9uIHNvbWUgY3JpdGVyaWEuICBnZXRUcnVzdGVkKCkgbWlnaHQgcmV0dXJuIGEgdmFsdWUgYW5kIG5vdCB0aHJvdyBhbiBleGNlcHRpb24gZm9yIHNwZWNpYWwKICAgICAqIGNvbnN0YW50cyBvciBvYmplY3RzIGV2ZW4gaWYgbm90IHdyYXBwZWQuICBBbGwgc3VjaCBpbXBsZW1lbnRhdGlvbnMgZnVsZmlsbCB0aGlzIGNvbnRyYWN0LgogICAgICoKICAgICAqCiAgICAgKiBBIG5vdGUgb24gdGhlIGluaGVyaXRhbmNlIG1vZGVsIGZvciBTQ0UgY29udGV4dHMKICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICogSSd2ZSB1c2VkIGluaGVyaXRhbmNlIGFuZCBtYWRlIFJFU09VUkNFX1VSTCB3cmFwcGVkIHR5cGVzIGEgc3VidHlwZSBvZiBVUkwgd3JhcHBlZCB0eXBlcy4gIFRoaXMKICAgICAqIGlzIHB1cmVseSBhbiBpbXBsZW1lbnRhdGlvbiBkZXRhaWxzLgogICAgICoKICAgICAqIFRoZSBjb250cmFjdCBpcyBzaW1wbHkgdGhpczoKICAgICAqCiAgICAgKiAgICAgZ2V0VHJ1c3RlZCgkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpIHN1Y2NlZWRpbmcgaW1wbGllcyB0aGF0IGdldFRydXN0ZWQoJHNjZS5VUkwsIHZhbHVlKQogICAgICogICAgIHdpbGwgYWxzbyBzdWNjZWVkLgogICAgICoKICAgICAqIEluaGVyaXRhbmNlIGhhcHBlbnMgdG8gY2FwdHVyZSB0aGlzIGluIGEgbmF0dXJhbCB3YXkuICBJbiBzb21lIGZ1dHVyZSwgd2UKICAgICAqIG1heSBub3QgdXNlIGluaGVyaXRhbmNlIGFueW1vcmUuICBUaGF0IGlzIE9LIGJlY2F1c2Ugbm8gY29kZSBvdXRzaWRlIG9mCiAgICAgKiBzY2UuanMgYW5kIHNjZVNwZWNzLmpzIHdvdWxkIG5lZWQgdG8gYmUgYXdhcmUgb2YgdGhpcyBkZXRhaWwuCiAgICAgKi8KCiAgICB0aGlzLiRnZXQgPSBbJyRwYXJzZScsICckc25pZmZlcicsICckc2NlRGVsZWdhdGUnLCBmdW5jdGlvbigKICAgICAgJHBhcnNlLCAgICRzbmlmZmVyLCAgICRzY2VEZWxlZ2F0ZSkgewogICAgICAvLyBQcmVyZXE6IEVuc3VyZSB0aGF0IHdlJ3JlIG5vdCBydW5uaW5nIGluIElFOCBxdWlya3MgbW9kZS4gIEluIHRoYXQgbW9kZSwgSUUgYWxsb3dzCiAgICAgIC8vIHRoZSAiZXhwcmVzc2lvbihqYXZhc2NyaXB0IGV4cHJlc3Npb24pIiBzeW50YXggd2hpY2ggaXMgaW5zZWN1cmUuCiAgICAgIGlmIChlbmFibGVkICYmICRzbmlmZmVyLm1zaWUgJiYgJHNuaWZmZXIubXNpZURvY3VtZW50TW9kZSA8IDgpIHsKICAgICAgICB0aHJvdyAkc2NlTWluRXJyKCdpZXF1aXJrcycsCiAgICAgICAgICAgICdTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyBkb2VzIG5vdCBzdXBwb3J0IEludGVybmV0IEV4cGxvcmVyIHZlcnNpb24gPCA5IGluIHF1aXJrcyAnICsKICAgICAgICAgICAgJ21vZGUuICBZb3UgY2FuIGZpeCB0aGlzIGJ5IGFkZGluZyB0aGUgdGV4dCA8IWRvY3R5cGUgaHRtbD4gdG8gdGhlIHRvcCBvZiB5b3VyIEhUTUwgJyArCiAgICAgICAgICAgICdkb2N1bWVudC4gIFNlZSBodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy4kc2NlIGZvciBtb3JlIGluZm9ybWF0aW9uLicpOwogICAgICB9CgogICAgICB2YXIgc2NlID0gc2hhbGxvd0NvcHkoU0NFX0NPTlRFWFRTKTsKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2UjaXNFbmFibGVkCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IHRydWUgaWYgU0NFIGlzIGVuYWJsZWQsIGZhbHNlIG90aGVyd2lzZS4gIElmIHlvdSB3YW50IHRvIHNldCB0aGUgdmFsdWUsIHlvdQogICAgICAgKiBoYXZlIHRvIGRvIGl0IGF0IG1vZHVsZSBjb25maWcgdGltZSBvbiB7QGxpbmsgbmcuJHNjZVByb3ZpZGVyICRzY2VQcm92aWRlcn0uCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBSZXR1cm5zIGEgYm9vbGVhbiBpbmRpY2F0aW5nIGlmIFNDRSBpcyBlbmFibGVkLgogICAgICAgKi8KICAgICAgc2NlLmlzRW5hYmxlZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gZW5hYmxlZDsKICAgICAgfTsKICAgICAgc2NlLnRydXN0QXMgPSAkc2NlRGVsZWdhdGUudHJ1c3RBczsKICAgICAgc2NlLmdldFRydXN0ZWQgPSAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZDsKICAgICAgc2NlLnZhbHVlT2YgPSAkc2NlRGVsZWdhdGUudmFsdWVPZjsKCiAgICAgIGlmICghZW5hYmxlZCkgewogICAgICAgIHNjZS50cnVzdEFzID0gc2NlLmdldFRydXN0ZWQgPSBmdW5jdGlvbih0eXBlLCB2YWx1ZSkgeyByZXR1cm4gdmFsdWU7IH07CiAgICAgICAgc2NlLnZhbHVlT2YgPSBpZGVudGl0eTsKICAgICAgfQoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSNwYXJzZQogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogQ29udmVydHMgQW5ndWxhciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpbnRvIGEgZnVuY3Rpb24uICBUaGlzIGlzIGxpa2Uge0BsaW5rCiAgICAgICAgKiBuZy4kcGFyc2UgJHBhcnNlfSBhbmQgaXMgaWRlbnRpY2FsIHdoZW4gdGhlIGV4cHJlc3Npb24gaXMgYSBsaXRlcmFsIGNvbnN0YW50LiAgT3RoZXJ3aXNlLCBpdAogICAgICAgKiB3cmFwcyB0aGUgZXhwcmVzc2lvbiBpbiBhIGNhbGwgdG8ge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWQoKnR5cGUqLAogICAgICogKnJlc3VsdCopfQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBTQ0UgY29udGV4dCBpbiB3aGljaCB0aGlzIHJlc3VsdCB3aWxsIGJlIHVzZWQuCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgICAqCiAgICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAgICogICAgICBgY29udGV4dGAuCiAgICAgICAqLwogICAgICBzY2UucGFyc2VBcyA9IGZ1bmN0aW9uIHNjZVBhcnNlQXModHlwZSwgZXhwcikgewogICAgICAgIHZhciBwYXJzZWQgPSAkcGFyc2UoZXhwcik7CiAgICAgICAgaWYgKHBhcnNlZC5saXRlcmFsICYmIHBhcnNlZC5jb25zdGFudCkgewogICAgICAgICAgcmV0dXJuIHBhcnNlZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIHNjZVBhcnNlQXNUcnVzdGVkKHNlbGYsIGxvY2FscykgewogICAgICAgICAgICByZXR1cm4gc2NlLmdldFRydXN0ZWQodHlwZSwgcGFyc2VkKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH07CgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlI3RydXN0QXMKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIERlbGVnYXRlcyB0byB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0uICBBcyBzdWNoLAogICAgICAgKiByZXR1cm5zIGFuIG9iamVjdCB0aGF0IGlzIHRydXN0ZWQgYnkgYW5ndWxhciBmb3IgdXNlIGluIHNwZWNpZmllZCBzdHJpY3QgY29udGV4dHVhbAogICAgICAgKiBlc2NhcGluZyBjb250ZXh0cyAoc3VjaCBhcyBuZy1iaW5kLWh0bWwsIG5nLWluY2x1ZGUsIGFueSBzcmMgYXR0cmlidXRlCiAgICAgICAqIGludGVycG9sYXRpb24sIGFueSBkb20gZXZlbnQgYmluZGluZyBhdHRyaWJ1dGUgaW50ZXJwb2xhdGlvbiBzdWNoIGFzIGZvciBvbmNsaWNrLCAgZXRjLikKICAgICAgICogdGhhdCB1c2VzIHRoZSBwcm92aWRlZCB2YWx1ZS4gIFNlZSAqIHtAbGluayBuZy4kc2NlICRzY2V9IGZvciBlbmFibGluZyBzdHJpY3QgY29udGV4dHVhbAogICAgICAgKiBlc2NhcGluZy4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgY29udGV4dCBpbiB3aGljaCB0aGlzIHZhbHVlIGlzIHNhZmUgZm9yIHVzZS4gIGUuZy4gdXJsLAogICAgICAgKiAgIHJlc291cmNlX3VybCwgaHRtbCwganMgYW5kIGNzcy4KICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdGhhdCB0aGF0IHNob3VsZCBiZSBjb25zaWRlcmVkIHRydXN0ZWQvc2FmZS4KICAgICAgICogQHJldHVybnMgeyp9IEEgdmFsdWUgdGhhdCBjYW4gYmUgdXNlZCB0byBzdGFuZCBpbiBmb3IgdGhlIHByb3ZpZGVkIGB2YWx1ZWAgaW4gcGxhY2VzCiAgICAgICAqIHdoZXJlIEFuZ3VsYXIgZXhwZWN0cyBhICRzY2UudHJ1c3RBcygpIHJldHVybiB2YWx1ZS4KICAgICAgICovCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlI3RydXN0QXNIdG1sCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UudHJ1c3RBc0h0bWwodmFsdWUpYCDihpIKICAgICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5IVE1MLCB2YWx1ZSlgfQogICAgICAgKgogICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB0cnVzdEFzLgogICAgICAgKiBAcmV0dXJucyB7Kn0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHBhc3NlZCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkSHRtbAogICAgICogICAgICRzY2UuZ2V0VHJ1c3RlZEh0bWwodmFsdWUpfSB0byBvYnRhaW4gdGhlIG9yaWdpbmFsIHZhbHVlLiAgKHByaXZpbGVnZWQgZGlyZWN0aXZlcwogICAgICAgKiAgICAgb25seSBhY2NlcHQgZXhwcmVzc2lvbnMgdGhhdCBhcmUgZWl0aGVyIGxpdGVyYWwgY29uc3RhbnRzIG9yIGFyZSB0aGUKICAgICAgICogICAgIHJldHVybiB2YWx1ZSBvZiB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzICRzY2UudHJ1c3RBc30uKQogICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBc1VybAogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnRydXN0QXNVcmwodmFsdWUpYCDihpIKICAgICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRVcmwKICAgICAqICAgICAkc2NlLmdldFRydXN0ZWRVcmwodmFsdWUpfSB0byBvYnRhaW4gdGhlIG9yaWdpbmFsIHZhbHVlLiAgKHByaXZpbGVnZWQgZGlyZWN0aXZlcwogICAgICAgKiAgICAgb25seSBhY2NlcHQgZXhwcmVzc2lvbnMgdGhhdCBhcmUgZWl0aGVyIGxpdGVyYWwgY29uc3RhbnRzIG9yIGFyZSB0aGUKICAgICAgICogICAgIHJldHVybiB2YWx1ZSBvZiB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzICRzY2UudHJ1c3RBc30uKQogICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBc1Jlc291cmNlVXJsCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UudHJ1c3RBc1Jlc291cmNlVXJsKHZhbHVlKWAg4oaSCiAgICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzKCRzY2UuUkVTT1VSQ0VfVVJMLCB2YWx1ZSlgfQogICAgICAgKgogICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB0cnVzdEFzLgogICAgICAgKiBAcmV0dXJucyB7Kn0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHBhc3NlZCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkUmVzb3VyY2VVcmwKICAgICAqICAgICAkc2NlLmdldFRydXN0ZWRSZXNvdXJjZVVybCh2YWx1ZSl9IHRvIG9idGFpbiB0aGUgb3JpZ2luYWwgdmFsdWUuICAocHJpdmlsZWdlZCBkaXJlY3RpdmVzCiAgICAgICAqICAgICBvbmx5IGFjY2VwdCBleHByZXNzaW9ucyB0aGF0IGFyZSBlaXRoZXIgbGl0ZXJhbCBjb25zdGFudHMgb3IgYXJlIHRoZSByZXR1cm4KICAgICAgICogICAgIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSN0cnVzdEFzSnMKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS50cnVzdEFzSnModmFsdWUpYCDihpIKICAgICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5KUywgdmFsdWUpYH0KICAgICAgICoKICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdHJ1c3RBcy4KICAgICAgICogQHJldHVybnMgeyp9IEFuIG9iamVjdCB0aGF0IGNhbiBiZSBwYXNzZWQgdG8ge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZEpzCiAgICAgKiAgICAgJHNjZS5nZXRUcnVzdGVkSnModmFsdWUpfSB0byBvYnRhaW4gdGhlIG9yaWdpbmFsIHZhbHVlLiAgKHByaXZpbGVnZWQgZGlyZWN0aXZlcwogICAgICAgKiAgICAgb25seSBhY2NlcHQgZXhwcmVzc2lvbnMgdGhhdCBhcmUgZWl0aGVyIGxpdGVyYWwgY29uc3RhbnRzIG9yIGFyZSB0aGUKICAgICAgICogICAgIHJldHVybiB2YWx1ZSBvZiB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzICRzY2UudHJ1c3RBc30uKQogICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZAogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogRGVsZWdhdGVzIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWRgfS4gIEFzIHN1Y2gsCiAgICAgICAqIHRha2VzIHRoZSByZXN1bHQgb2YgYSB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzIGAkc2NlLnRydXN0QXNgfSgpIGNhbGwgYW5kIHJldHVybnMgdGhlCiAgICAgICAqIG9yaWdpbmFsbHkgc3VwcGxpZWQgdmFsdWUgaWYgdGhlIHF1ZXJpZWQgY29udGV4dCB0eXBlIGlzIGEgc3VwZXJ0eXBlIG9mIHRoZSBjcmVhdGVkIHR5cGUuCiAgICAgICAqIElmIHRoaXMgY29uZGl0aW9uIGlzbid0IHNhdGlzZmllZCwgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgY29udGV4dCBpbiB3aGljaCB0aGlzIHZhbHVlIGlzIHRvIGJlIHVzZWQuCiAgICAgICAqIEBwYXJhbSB7Kn0gbWF5YmVUcnVzdGVkIFRoZSByZXN1bHQgb2YgYSBwcmlvciB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzIGAkc2NlLnRydXN0QXNgfQogICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsLgogICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHZhbHVlIHRoZSB3YXMgb3JpZ2luYWxseSBwcm92aWRlZCB0bwogICAgICAgKiAgICAgICAgICAgICAge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyBgJHNjZS50cnVzdEFzYH0gaWYgdmFsaWQgaW4gdGhpcyBjb250ZXh0LgogICAgICAgKiAgICAgICAgICAgICAgT3RoZXJ3aXNlLCB0aHJvd3MgYW4gZXhjZXB0aW9uLgogICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZEh0bWwKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5nZXRUcnVzdGVkSHRtbCh2YWx1ZSlgIOKGkgogICAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLkhUTUwsIHZhbHVlKWB9CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYCRzY2UuZ2V0VHJ1c3RlZGAuCiAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5IVE1MLCB2YWx1ZSlgCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkQ3NzCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZENzcyh2YWx1ZSlgIOKGkgogICAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLkNTUywgdmFsdWUpYH0KICAgICAgICoKICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLkNTUywgdmFsdWUpYAogICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZFVybAogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRVcmwodmFsdWUpYCDihpIKICAgICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWQoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHBhc3MgdG8gYCRzY2UuZ2V0VHJ1c3RlZGAuCiAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5VUkwsIHZhbHVlKWAKICAgICAgICovCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlI2dldFRydXN0ZWRSZXNvdXJjZVVybAogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRSZXNvdXJjZVVybCh2YWx1ZSlgIOKGkgogICAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYH0KICAgICAgICoKICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWRgLgogICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuUkVTT1VSQ0VfVVJMLCB2YWx1ZSlgCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkSnMKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5nZXRUcnVzdGVkSnModmFsdWUpYCDihpIKICAgICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjZ2V0VHJ1c3RlZCBgJHNjZURlbGVnYXRlLmdldFRydXN0ZWQoJHNjZS5KUywgdmFsdWUpYH0KICAgICAgICoKICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLkpTLCB2YWx1ZSlgCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSNwYXJzZUFzSHRtbAogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNIdG1sKGV4cHJlc3Npb24gc3RyaW5nKWAg4oaSCiAgICAgICAqICAgICB7QGxpbmsgbmcuJHNjZSNwYXJzZSBgJHNjZS5wYXJzZUFzKCRzY2UuSFRNTCwgdmFsdWUpYH0KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAgICoKICAgICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAgICovCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlI3BhcnNlQXNDc3MKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzQ3NzKHZhbHVlKWAg4oaSCiAgICAgICAqICAgICB7QGxpbmsgbmcuJHNjZSNwYXJzZSBgJHNjZS5wYXJzZUFzKCRzY2UuQ1NTLCB2YWx1ZSlgfQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICAgKgogICAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2UjcGFyc2VBc1VybAogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNVcmwodmFsdWUpYCDihpIKICAgICAgICogICAgIHtAbGluayBuZy4kc2NlI3BhcnNlIGAkc2NlLnBhcnNlQXMoJHNjZS5VUkwsIHZhbHVlKWB9CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgICAqCiAgICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAgICogICAgICBgY29udGV4dGAuCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSNwYXJzZUFzUmVzb3VyY2VVcmwKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzUmVzb3VyY2VVcmwodmFsdWUpYCDihpIKICAgICAgICogICAgIHtAbGluayBuZy4kc2NlI3BhcnNlIGAkc2NlLnBhcnNlQXMoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKWB9CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgICAqCiAgICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAgICogICAgICBgY29udGV4dGAuCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSNwYXJzZUFzSnMKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5wYXJzZUFzSnModmFsdWUpYCDihpIKICAgICAgICogICAgIHtAbGluayBuZy4kc2NlI3BhcnNlIGAkc2NlLnBhcnNlQXMoJHNjZS5KUywgdmFsdWUpYH0KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAgICoKICAgICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAgICovCgogICAgICAvLyBTaG9ydGhhbmQgZGVsZWdhdGlvbnMuCiAgICAgIHZhciBwYXJzZSA9IHNjZS5wYXJzZUFzLAogICAgICAgIGdldFRydXN0ZWQgPSBzY2UuZ2V0VHJ1c3RlZCwKICAgICAgICB0cnVzdEFzID0gc2NlLnRydXN0QXM7CgogICAgICBmb3JFYWNoKFNDRV9DT05URVhUUywgZnVuY3Rpb24gKGVudW1WYWx1ZSwgbmFtZSkgewogICAgICAgIHZhciBsTmFtZSA9IGxvd2VyY2FzZShuYW1lKTsKICAgICAgICBzY2VbY2FtZWxDYXNlKCJwYXJzZV9hc18iICsgbE5hbWUpXSA9IGZ1bmN0aW9uIChleHByKSB7CiAgICAgICAgICByZXR1cm4gcGFyc2UoZW51bVZhbHVlLCBleHByKTsKICAgICAgICB9OwogICAgICAgIHNjZVtjYW1lbENhc2UoImdldF90cnVzdGVkXyIgKyBsTmFtZSldID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0VHJ1c3RlZChlbnVtVmFsdWUsIHZhbHVlKTsKICAgICAgICB9OwogICAgICAgIHNjZVtjYW1lbENhc2UoInRydXN0X2FzXyIgKyBsTmFtZSldID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdHJ1c3RBcyhlbnVtVmFsdWUsIHZhbHVlKTsKICAgICAgICB9OwogICAgICB9KTsKCiAgICAgIHJldHVybiBzY2U7CiAgICB9XTsKICB9CgogIC8qKgogICAqICEhISBUaGlzIGlzIGFuIHVuZG9jdW1lbnRlZCAicHJpdmF0ZSIgc2VydmljZSAhISEKICAgKgogICAqIEBuYW1lICRzbmlmZmVyCiAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgKiBAcmVxdWlyZXMgJGRvY3VtZW50CiAgICoKICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhpc3RvcnkgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IGh0bWw1IGhpc3RvcnkgYXBpID8KICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc2hjaGFuZ2UgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IGhhc2hjaGFuZ2UgZXZlbnQgPwogICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdHJhbnNpdGlvbnMgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IENTUyB0cmFuc2l0aW9uIGV2ZW50cyA/CiAgICogQHByb3BlcnR5IHtib29sZWFufSBhbmltYXRpb25zIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCBDU1MgYW5pbWF0aW9uIGV2ZW50cyA/CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIGlzIHZlcnkgc2ltcGxlIGltcGxlbWVudGF0aW9uIG9mIHRlc3RpbmcgYnJvd3NlcidzIGZlYXR1cmVzLgogICAqLwogIGZ1bmN0aW9uICRTbmlmZmVyUHJvdmlkZXIoKSB7CiAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24oJHdpbmRvdywgJGRvY3VtZW50KSB7CiAgICAgIHZhciBldmVudFN1cHBvcnQgPSB7fSwKICAgICAgICBhbmRyb2lkID0KICAgICAgICAgIGludCgoL2FuZHJvaWQgKFxkKykvLmV4ZWMobG93ZXJjYXNlKCgkd2luZG93Lm5hdmlnYXRvciB8fCB7fSkudXNlckFnZW50KSkgfHwgW10pWzFdKSwKICAgICAgICBib3hlZSA9IC9Cb3hlZS9pLnRlc3QoKCR3aW5kb3cubmF2aWdhdG9yIHx8IHt9KS51c2VyQWdlbnQpLAogICAgICAgIGRvY3VtZW50ID0gJGRvY3VtZW50WzBdIHx8IHt9LAogICAgICAgIGRvY3VtZW50TW9kZSA9IGRvY3VtZW50LmRvY3VtZW50TW9kZSwKICAgICAgICB2ZW5kb3JQcmVmaXgsCiAgICAgICAgdmVuZG9yUmVnZXggPSAvXihNb3p8d2Via2l0fE98bXMpKD89W0EtWl0pLywKICAgICAgICBib2R5U3R5bGUgPSBkb2N1bWVudC5ib2R5ICYmIGRvY3VtZW50LmJvZHkuc3R5bGUsCiAgICAgICAgdHJhbnNpdGlvbnMgPSBmYWxzZSwKICAgICAgICBhbmltYXRpb25zID0gZmFsc2UsCiAgICAgICAgbWF0Y2g7CgogICAgICBpZiAoYm9keVN0eWxlKSB7CiAgICAgICAgZm9yKHZhciBwcm9wIGluIGJvZHlTdHlsZSkgewogICAgICAgICAgaWYobWF0Y2ggPSB2ZW5kb3JSZWdleC5leGVjKHByb3ApKSB7CiAgICAgICAgICAgIHZlbmRvclByZWZpeCA9IG1hdGNoWzBdOwogICAgICAgICAgICB2ZW5kb3JQcmVmaXggPSB2ZW5kb3JQcmVmaXguc3Vic3RyKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyB2ZW5kb3JQcmVmaXguc3Vic3RyKDEpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmKCF2ZW5kb3JQcmVmaXgpIHsKICAgICAgICAgIHZlbmRvclByZWZpeCA9ICgnV2Via2l0T3BhY2l0eScgaW4gYm9keVN0eWxlKSAmJiAnd2Via2l0JzsKICAgICAgICB9CgogICAgICAgIHRyYW5zaXRpb25zID0gISEoKCd0cmFuc2l0aW9uJyBpbiBib2R5U3R5bGUpIHx8ICh2ZW5kb3JQcmVmaXggKyAnVHJhbnNpdGlvbicgaW4gYm9keVN0eWxlKSk7CiAgICAgICAgYW5pbWF0aW9ucyAgPSAhISgoJ2FuaW1hdGlvbicgaW4gYm9keVN0eWxlKSB8fCAodmVuZG9yUHJlZml4ICsgJ0FuaW1hdGlvbicgaW4gYm9keVN0eWxlKSk7CgogICAgICAgIGlmIChhbmRyb2lkICYmICghdHJhbnNpdGlvbnN8fCFhbmltYXRpb25zKSkgewogICAgICAgICAgdHJhbnNpdGlvbnMgPSBpc1N0cmluZyhkb2N1bWVudC5ib2R5LnN0eWxlLndlYmtpdFRyYW5zaXRpb24pOwogICAgICAgICAgYW5pbWF0aW9ucyA9IGlzU3RyaW5nKGRvY3VtZW50LmJvZHkuc3R5bGUud2Via2l0QW5pbWF0aW9uKTsKICAgICAgICB9CiAgICAgIH0KCgogICAgICByZXR1cm4gewogICAgICAgIC8vIEFuZHJvaWQgaGFzIGhpc3RvcnkucHVzaFN0YXRlLCBidXQgaXQgZG9lcyBub3QgdXBkYXRlIGxvY2F0aW9uIGNvcnJlY3RseQogICAgICAgIC8vIHNvIGxldCdzIG5vdCB1c2UgdGhlIGhpc3RvcnkgQVBJIGF0IGFsbC4KICAgICAgICAvLyBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvYW5kcm9pZC9pc3N1ZXMvZGV0YWlsP2lkPTE3NDcxCiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvOTA0CgogICAgICAgIC8vIG9sZGVyIHdlYmtpdCBicm93c2VyICg1MzMuOSkgb24gQm94ZWUgYm94IGhhcyBleGFjdGx5IHRoZSBzYW1lIHByb2JsZW0gYXMgQW5kcm9pZCBoYXMKICAgICAgICAvLyBzbyBsZXQncyBub3QgdXNlIHRoZSBoaXN0b3J5IEFQSSBhbHNvCiAgICAgICAgLy8gV2UgYXJlIHB1cnBvc2VmdWxseSB1c2luZyBgIShhbmRyb2lkIDwgNClgIHRvIGNvdmVyIHRoZSBjYXNlIHdoZW4gYGFuZHJvaWRgIGlzIHVuZGVmaW5lZAogICAgICAgIC8vIGpzaGludCAtVzAxOAogICAgICAgIGhpc3Rvcnk6ICEhKCR3aW5kb3cuaGlzdG9yeSAmJiAkd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlICYmICEoYW5kcm9pZCA8IDQpICYmICFib3hlZSksCiAgICAgICAgLy8ganNoaW50ICtXMDE4CiAgICAgICAgaGFzaGNoYW5nZTogJ29uaGFzaGNoYW5nZScgaW4gJHdpbmRvdyAmJgogICAgICAgICAgLy8gSUU4IGNvbXBhdGlibGUgbW9kZSBsaWVzCiAgICAgICAgICAoIWRvY3VtZW50TW9kZSB8fCBkb2N1bWVudE1vZGUgPiA3KSwKICAgICAgICBoYXNFdmVudDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIC8vIElFOSBpbXBsZW1lbnRzICdpbnB1dCcgZXZlbnQgaXQncyBzbyBmdWJhcmVkIHRoYXQgd2UgcmF0aGVyIHByZXRlbmQgdGhhdCBpdCBkb2Vzbid0IGhhdmUKICAgICAgICAgIC8vIGl0LiBJbiBwYXJ0aWN1bGFyIHRoZSBldmVudCBpcyBub3QgZmlyZWQgd2hlbiBiYWNrc3BhY2Ugb3IgZGVsZXRlIGtleSBhcmUgcHJlc3NlZCBvcgogICAgICAgICAgLy8gd2hlbiBjdXQgb3BlcmF0aW9uIGlzIHBlcmZvcm1lZC4KICAgICAgICAgIGlmIChldmVudCA9PSAnaW5wdXQnICYmIG1zaWUgPT0gOSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChldmVudFN1cHBvcnRbZXZlbnRdKSkgewogICAgICAgICAgICB2YXIgZGl2RWxtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIGV2ZW50U3VwcG9ydFtldmVudF0gPSAnb24nICsgZXZlbnQgaW4gZGl2RWxtOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBldmVudFN1cHBvcnRbZXZlbnRdOwogICAgICAgIH0sCiAgICAgICAgY3NwOiBjc3AoKSwKICAgICAgICB2ZW5kb3JQcmVmaXg6IHZlbmRvclByZWZpeCwKICAgICAgICB0cmFuc2l0aW9ucyA6IHRyYW5zaXRpb25zLAogICAgICAgIGFuaW1hdGlvbnMgOiBhbmltYXRpb25zLAogICAgICAgIGFuZHJvaWQ6IGFuZHJvaWQsCiAgICAgICAgbXNpZSA6IG1zaWUsCiAgICAgICAgbXNpZURvY3VtZW50TW9kZTogZG9jdW1lbnRNb2RlCiAgICAgIH07CiAgICB9XTsKICB9CgogIGZ1bmN0aW9uICRUaW1lb3V0UHJvdmlkZXIoKSB7CiAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHEnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLAogICAgICBmdW5jdGlvbigkcm9vdFNjb3BlLCAgICRicm93c2VyLCAgICRxLCAgICRleGNlcHRpb25IYW5kbGVyKSB7CiAgICAgICAgdmFyIGRlZmVycmVkcyA9IHt9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAgICAgKiBAbmFtZSAkdGltZW91dAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQW5ndWxhcidzIHdyYXBwZXIgZm9yIGB3aW5kb3cuc2V0VGltZW91dGAuIFRoZSBgZm5gIGZ1bmN0aW9uIGlzIHdyYXBwZWQgaW50byBhIHRyeS9jYXRjaAogICAgICAgICAqIGJsb2NrIGFuZCBkZWxlZ2F0ZXMgYW55IGV4Y2VwdGlvbnMgdG8KICAgICAgICAgKiB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIG9mIHJlZ2lzdGVyaW5nIGEgdGltZW91dCBmdW5jdGlvbiBpcyBhIHByb21pc2UsIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgd2hlbgogICAgICAgICAqIHRoZSB0aW1lb3V0IGlzIHJlYWNoZWQgYW5kIHRoZSB0aW1lb3V0IGZ1bmN0aW9uIGlzIGV4ZWN1dGVkLgogICAgICAgICAqCiAgICAgICAgICogVG8gY2FuY2VsIGEgdGltZW91dCByZXF1ZXN0LCBjYWxsIGAkdGltZW91dC5jYW5jZWwocHJvbWlzZSlgLgogICAgICAgICAqCiAgICAgICAgICogSW4gdGVzdHMgeW91IGNhbiB1c2Uge0BsaW5rIG5nTW9jay4kdGltZW91dCBgJHRpbWVvdXQuZmx1c2goKWB9IHRvCiAgICAgICAgICogc3luY2hyb25vdXNseSBmbHVzaCB0aGUgcXVldWUgb2YgZGVmZXJyZWQgZnVuY3Rpb25zLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBBIGZ1bmN0aW9uLCB3aG9zZSBleGVjdXRpb24gc2hvdWxkIGJlIGRlbGF5ZWQuCiAgICAgICAgICogQHBhcmFtIHtudW1iZXI9fSBbZGVsYXk9MF0gRGVsYXkgaW4gbWlsbGlzZWNvbmRzLgogICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbnZva2VBcHBseT10cnVlXSBJZiBzZXQgdG8gYGZhbHNlYCBza2lwcyBtb2RlbCBkaXJ0eSBjaGVja2luZywgb3RoZXJ3aXNlCiAgICAgICAgICogICB3aWxsIGludm9rZSBgZm5gIHdpdGhpbiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseX0gYmxvY2suCiAgICAgICAgICogQHJldHVybnMge1Byb21pc2V9IFByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdoZW4gdGhlIHRpbWVvdXQgaXMgcmVhY2hlZC4gVGhlIHZhbHVlIHRoaXMKICAgICAgICAgKiAgIHByb21pc2Ugd2lsbCBiZSByZXNvbHZlZCB3aXRoIGlzIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGBmbmAgZnVuY3Rpb24uCiAgICAgICAgICoKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiB0aW1lb3V0KGZuLCBkZWxheSwgaW52b2tlQXBwbHkpIHsKICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgICBza2lwQXBwbHkgPSAoaXNEZWZpbmVkKGludm9rZUFwcGx5KSAmJiAhaW52b2tlQXBwbHkpLAogICAgICAgICAgICB0aW1lb3V0SWQ7CgogICAgICAgICAgdGltZW91dElkID0gJGJyb3dzZXIuZGVmZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShmbigpKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0KGUpOwogICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmFsbHkgewogICAgICAgICAgICAgIGRlbGV0ZSBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghc2tpcEFwcGx5KSAkcm9vdFNjb3BlLiRhcHBseSgpOwogICAgICAgICAgfSwgZGVsYXkpOwoKICAgICAgICAgIHByb21pc2UuJCR0aW1lb3V0SWQgPSB0aW1lb3V0SWQ7CiAgICAgICAgICBkZWZlcnJlZHNbdGltZW91dElkXSA9IGRlZmVycmVkOwoKICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgIH0KCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkdGltZW91dCNjYW5jZWwKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENhbmNlbHMgYSB0YXNrIGFzc29jaWF0ZWQgd2l0aCB0aGUgYHByb21pc2VgLiBBcyBhIHJlc3VsdCBvZiB0aGlzLCB0aGUgcHJvbWlzZSB3aWxsIGJlCiAgICAgICAgICogcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbi4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7UHJvbWlzZT19IHByb21pc2UgUHJvbWlzZSByZXR1cm5lZCBieSB0aGUgYCR0aW1lb3V0YCBmdW5jdGlvbi4KICAgICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHRhc2sgaGFzbid0IGV4ZWN1dGVkIHlldCBhbmQgd2FzIHN1Y2Nlc3NmdWxseQogICAgICAgICAqICAgY2FuY2VsZWQuCiAgICAgICAgICovCiAgICAgICAgdGltZW91dC5jYW5jZWwgPSBmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgICAgICBpZiAocHJvbWlzZSAmJiBwcm9taXNlLiQkdGltZW91dElkIGluIGRlZmVycmVkcykgewogICAgICAgICAgICBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF0ucmVqZWN0KCdjYW5jZWxlZCcpOwogICAgICAgICAgICBkZWxldGUgZGVmZXJyZWRzW3Byb21pc2UuJCR0aW1lb3V0SWRdOwogICAgICAgICAgICByZXR1cm4gJGJyb3dzZXIuZGVmZXIuY2FuY2VsKHByb21pc2UuJCR0aW1lb3V0SWQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CgogICAgICAgIHJldHVybiB0aW1lb3V0OwogICAgICB9XTsKICB9CgovLyBOT1RFOiAgVGhlIHVzYWdlIG9mIHdpbmRvdyBhbmQgZG9jdW1lbnQgaW5zdGVhZCBvZiAkd2luZG93IGFuZCAkZG9jdW1lbnQgaGVyZSBpcwovLyBkZWxpYmVyYXRlLiAgVGhpcyBzZXJ2aWNlIGRlcGVuZHMgb24gdGhlIHNwZWNpZmljIGJlaGF2aW9yIG9mIGFuY2hvciBub2RlcyBjcmVhdGVkIGJ5IHRoZQovLyBicm93c2VyIChyZXNvbHZpbmcgYW5kIHBhcnNpbmcgVVJMcykgdGhhdCBpcyB1bmxpa2VseSB0byBiZSBwcm92aWRlZCBieSBtb2NrIG9iamVjdHMgYW5kCi8vIGNhdXNlIHVzIHRvIGJyZWFrIHRlc3RzLiAgSW4gYWRkaXRpb24sIHdoZW4gdGhlIGJyb3dzZXIgcmVzb2x2ZXMgYSBVUkwgZm9yIFhIUiwgaXQKLy8gZG9lc24ndCBrbm93IGFib3V0IG1vY2tlZCBsb2NhdGlvbnMgYW5kIHJlc29sdmVzIFVSTHMgdG8gdGhlIHJlYWwgZG9jdW1lbnQgLSB3aGljaCBpcwovLyBleGFjdGx5IHRoZSBiZWhhdmlvciBuZWVkZWQgaGVyZS4gIFRoZXJlIGlzIGxpdHRsZSB2YWx1ZSBpcyBtb2NraW5nIHRoZXNlIG91dCBmb3IgdGhpcwovLyBzZXJ2aWNlLgogIHZhciB1cmxQYXJzaW5nTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICB2YXIgb3JpZ2luVXJsID0gdXJsUmVzb2x2ZSh3aW5kb3cubG9jYXRpb24uaHJlZiwgdHJ1ZSk7CgoKICAvKioKICAgKgogICAqIEltcGxlbWVudGF0aW9uIE5vdGVzIGZvciBub24tSUUgYnJvd3NlcnMKICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICogQXNzaWduaW5nIGEgVVJMIHRvIHRoZSBocmVmIHByb3BlcnR5IG9mIGFuIGFuY2hvciBET00gbm9kZSwgZXZlbiBvbmUgYXR0YWNoZWQgdG8gdGhlIERPTSwKICAgKiByZXN1bHRzIGJvdGggaW4gdGhlIG5vcm1hbGl6aW5nIGFuZCBwYXJzaW5nIG9mIHRoZSBVUkwuICBOb3JtYWxpemluZyBtZWFucyB0aGF0IGEgcmVsYXRpdmUKICAgKiBVUkwgd2lsbCBiZSByZXNvbHZlZCBpbnRvIGFuIGFic29sdXRlIFVSTCBpbiB0aGUgY29udGV4dCBvZiB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQuCiAgICogUGFyc2luZyBtZWFucyB0aGF0IHRoZSBhbmNob3Igbm9kZSdzIGhvc3QsIGhvc3RuYW1lLCBwcm90b2NvbCwgcG9ydCwgcGF0aG5hbWUgYW5kIHJlbGF0ZWQKICAgKiBwcm9wZXJ0aWVzIGFyZSBhbGwgcG9wdWxhdGVkIHRvIHJlZmxlY3QgdGhlIG5vcm1hbGl6ZWQgVVJMLiAgVGhpcyBhcHByb2FjaCBoYXMgd2lkZQogICAqIGNvbXBhdGliaWxpdHkgLSBTYWZhcmkgMSssIE1vemlsbGEgMSssIE9wZXJhIDcrLGUgZXRjLiAgU2VlCiAgICogaHR0cDovL3d3dy5hcHRhbmEuY29tL3JlZmVyZW5jZS9odG1sL2FwaS9IVE1MQW5jaG9yRWxlbWVudC5odG1sCiAgICoKICAgKiBJbXBsZW1lbnRhdGlvbiBOb3RlcyBmb3IgSUUKICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBJRSA+PSA4IGFuZCA8PSAxMCBub3JtYWxpemVzIHRoZSBVUkwgd2hlbiBhc3NpZ25lZCB0byB0aGUgYW5jaG9yIG5vZGUgc2ltaWxhciB0byB0aGUgb3RoZXIKICAgKiBicm93c2Vycy4gIEhvd2V2ZXIsIHRoZSBwYXJzZWQgY29tcG9uZW50cyB3aWxsIG5vdCBiZSBzZXQgaWYgdGhlIFVSTCBhc3NpZ25lZCBkaWQgbm90IHNwZWNpZnkKICAgKiB0aGVtLiAgKGUuZy4gaWYgeW91IGFzc2lnbiBhLmhyZWYgPSAiZm9vIiwgdGhlbiBhLnByb3RvY29sLCBhLmhvc3QsIGV0Yy4gd2lsbCBiZSBlbXB0eS4pICBXZQogICAqIHdvcmsgYXJvdW5kIHRoYXQgYnkgcGVyZm9ybWluZyB0aGUgcGFyc2luZyBpbiBhIDJuZCBzdGVwIGJ5IHRha2luZyBhIHByZXZpb3VzbHkgbm9ybWFsaXplZAogICAqIFVSTCAoZS5nLiBieSBhc3NpZ25pbmcgdG8gYS5ocmVmKSBhbmQgYXNzaWduaW5nIGl0IGEuaHJlZiBhZ2Fpbi4gIFRoaXMgY29ycmVjdGx5IHBvcHVsYXRlcyB0aGUKICAgKiBwcm9wZXJ0aWVzIHN1Y2ggYXMgcHJvdG9jb2wsIGhvc3RuYW1lLCBwb3J0LCBldGMuCiAgICoKICAgKiBJRTcgZG9lcyBub3Qgbm9ybWFsaXplIHRoZSBVUkwgd2hlbiBhc3NpZ25lZCB0byBhbiBhbmNob3Igbm9kZS4gIChBcHBhcmVudGx5LCBpdCBkb2VzLCBpZiBvbmUKICAgKiB1c2VzIHRoZSBpbm5lciBIVE1MIGFwcHJvYWNoIHRvIGFzc2lnbiB0aGUgVVJMIGFzIHBhcnQgb2YgYW4gSFRNTCBzbmlwcGV0IC0KICAgKiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS80NzI3MjkpICBIb3dldmVyLCBzZXR0aW5nIGltZ1tzcmNdIGRvZXMgbm9ybWFsaXplIHRoZSBVUkwuCiAgICogVW5mb3J0dW5hdGVseSwgc2V0dGluZyBpbWdbc3JjXSB0byBzb21ldGhpbmcgbGlrZSAiamF2YXNjcmlwdDpmb28iIG9uIElFIHRocm93cyBhbiBleGNlcHRpb24uCiAgICogU2luY2UgdGhlIHByaW1hcnkgdXNhZ2UgZm9yIG5vcm1hbGl6aW5nIFVSTHMgaXMgdG8gc2FuaXRpemUgc3VjaCBVUkxzLCB3ZSBjYW4ndCB1c2UgdGhhdAogICAqIG1ldGhvZCBhbmQgSUUgPCA4IGlzIHVuc3VwcG9ydGVkLgogICAqCiAgICogUmVmZXJlbmNlczoKICAgKiAgIGh0dHA6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0hUTUxBbmNob3JFbGVtZW50CiAgICogICBodHRwOi8vd3d3LmFwdGFuYS5jb20vcmVmZXJlbmNlL2h0bWwvYXBpL0hUTUxBbmNob3JFbGVtZW50Lmh0bWwKICAgKiAgIGh0dHA6Ly91cmwuc3BlYy53aGF0d2cub3JnLyN1cmx1dGlscwogICAqICAgaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9wdWxsLzI5MDIKICAgKiAgIGh0dHA6Ly9qYW1lcy5wYWRvbHNleS5jb20vamF2YXNjcmlwdC9wYXJzaW5nLXVybHMtd2l0aC10aGUtZG9tLwogICAqCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSBVUkwgdG8gYmUgcGFyc2VkLgogICAqIEBkZXNjcmlwdGlvbiBOb3JtYWxpemVzIGFuZCBwYXJzZXMgYSBVUkwuCiAgICogQHJldHVybnMge29iamVjdH0gUmV0dXJucyB0aGUgbm9ybWFsaXplZCBVUkwgYXMgYSBkaWN0aW9uYXJ5LgogICAqCiAgICogICB8IG1lbWJlciBuYW1lICAgfCBEZXNjcmlwdGlvbiAgICB8CiAgICogICB8LS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS18CiAgICogICB8IGhyZWYgICAgICAgICAgfCBBIG5vcm1hbGl6ZWQgdmVyc2lvbiBvZiB0aGUgcHJvdmlkZWQgVVJMIGlmIGl0IHdhcyBub3QgYW4gYWJzb2x1dGUgVVJMIHwKICAgKiAgIHwgcHJvdG9jb2wgICAgICB8IFRoZSBwcm90b2NvbCBpbmNsdWRpbmcgdGhlIHRyYWlsaW5nIGNvbG9uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAqICAgfCBob3N0ICAgICAgICAgIHwgVGhlIGhvc3QgYW5kIHBvcnQgKGlmIHRoZSBwb3J0IGlzIG5vbi1kZWZhdWx0KSBvZiB0aGUgbm9ybWFsaXplZFVybCAgICB8CiAgICogICB8IHNlYXJjaCAgICAgICAgfCBUaGUgc2VhcmNoIHBhcmFtcywgbWludXMgdGhlIHF1ZXN0aW9uIG1hcmsgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgKiAgIHwgaGFzaCAgICAgICAgICB8IFRoZSBoYXNoIHN0cmluZywgbWludXMgdGhlIGhhc2ggc3ltYm9sCiAgICogICB8IGhvc3RuYW1lICAgICAgfCBUaGUgaG9zdG5hbWUKICAgKiAgIHwgcG9ydCAgICAgICAgICB8IFRoZSBwb3J0LCB3aXRob3V0ICI6IgogICAqICAgfCBwYXRobmFtZSAgICAgIHwgVGhlIHBhdGhuYW1lLCBiZWdpbm5pbmcgd2l0aCAiLyIKICAgKgogICAqLwogIGZ1bmN0aW9uIHVybFJlc29sdmUodXJsLCBiYXNlKSB7CiAgICB2YXIgaHJlZiA9IHVybDsKCiAgICBpZiAobXNpZSkgewogICAgICAvLyBOb3JtYWxpemUgYmVmb3JlIHBhcnNlLiAgUmVmZXIgSW1wbGVtZW50YXRpb24gTm90ZXMgb24gd2h5IHRoaXMgaXMKICAgICAgLy8gZG9uZSBpbiB0d28gc3RlcHMgb24gSUUuCiAgICAgIHVybFBhcnNpbmdOb2RlLnNldEF0dHJpYnV0ZSgiaHJlZiIsIGhyZWYpOwogICAgICBocmVmID0gdXJsUGFyc2luZ05vZGUuaHJlZjsKICAgIH0KCiAgICB1cmxQYXJzaW5nTm9kZS5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBocmVmKTsKCiAgICAvLyB1cmxQYXJzaW5nTm9kZSBwcm92aWRlcyB0aGUgVXJsVXRpbHMgaW50ZXJmYWNlIC0gaHR0cDovL3VybC5zcGVjLndoYXR3Zy5vcmcvI3VybHV0aWxzCiAgICByZXR1cm4gewogICAgICBocmVmOiB1cmxQYXJzaW5nTm9kZS5ocmVmLAogICAgICBwcm90b2NvbDogdXJsUGFyc2luZ05vZGUucHJvdG9jb2wgPyB1cmxQYXJzaW5nTm9kZS5wcm90b2NvbC5yZXBsYWNlKC86JC8sICcnKSA6ICcnLAogICAgICBob3N0OiB1cmxQYXJzaW5nTm9kZS5ob3N0LAogICAgICBzZWFyY2g6IHVybFBhcnNpbmdOb2RlLnNlYXJjaCA/IHVybFBhcnNpbmdOb2RlLnNlYXJjaC5yZXBsYWNlKC9eXD8vLCAnJykgOiAnJywKICAgICAgaGFzaDogdXJsUGFyc2luZ05vZGUuaGFzaCA/IHVybFBhcnNpbmdOb2RlLmhhc2gucmVwbGFjZSgvXiMvLCAnJykgOiAnJywKICAgICAgaG9zdG5hbWU6IHVybFBhcnNpbmdOb2RlLmhvc3RuYW1lLAogICAgICBwb3J0OiB1cmxQYXJzaW5nTm9kZS5wb3J0LAogICAgICBwYXRobmFtZTogKHVybFBhcnNpbmdOb2RlLnBhdGhuYW1lLmNoYXJBdCgwKSA9PT0gJy8nKQogICAgICAgID8gdXJsUGFyc2luZ05vZGUucGF0aG5hbWUKICAgICAgICA6ICcvJyArIHVybFBhcnNpbmdOb2RlLnBhdGhuYW1lCiAgICB9OwogIH0KCiAgLyoqCiAgICogUGFyc2UgYSByZXF1ZXN0IFVSTCBhbmQgZGV0ZXJtaW5lIHdoZXRoZXIgdGhpcyBpcyBhIHNhbWUtb3JpZ2luIHJlcXVlc3QgYXMgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50LgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSByZXF1ZXN0VXJsIFRoZSB1cmwgb2YgdGhlIHJlcXVlc3QgYXMgYSBzdHJpbmcgdGhhdCB3aWxsIGJlIHJlc29sdmVkCiAgICogb3IgYSBwYXJzZWQgVVJMIG9iamVjdC4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgcmVxdWVzdCBpcyBmb3IgdGhlIHNhbWUgb3JpZ2luIGFzIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudC4KICAgKi8KICBmdW5jdGlvbiB1cmxJc1NhbWVPcmlnaW4ocmVxdWVzdFVybCkgewogICAgdmFyIHBhcnNlZCA9IChpc1N0cmluZyhyZXF1ZXN0VXJsKSkgPyB1cmxSZXNvbHZlKHJlcXVlc3RVcmwpIDogcmVxdWVzdFVybDsKICAgIHJldHVybiAocGFyc2VkLnByb3RvY29sID09PSBvcmlnaW5VcmwucHJvdG9jb2wgJiYKICAgICAgcGFyc2VkLmhvc3QgPT09IG9yaWdpblVybC5ob3N0KTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJHdpbmRvdwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQSByZWZlcmVuY2UgdG8gdGhlIGJyb3dzZXIncyBgd2luZG93YCBvYmplY3QuIFdoaWxlIGB3aW5kb3dgCiAgICogaXMgZ2xvYmFsbHkgYXZhaWxhYmxlIGluIEphdmFTY3JpcHQsIGl0IGNhdXNlcyB0ZXN0YWJpbGl0eSBwcm9ibGVtcywgYmVjYXVzZQogICAqIGl0IGlzIGEgZ2xvYmFsIHZhcmlhYmxlLiBJbiBhbmd1bGFyIHdlIGFsd2F5cyByZWZlciB0byBpdCB0aHJvdWdoIHRoZQogICAqIGAkd2luZG93YCBzZXJ2aWNlLCBzbyBpdCBtYXkgYmUgb3ZlcnJpZGRlbiwgcmVtb3ZlZCBvciBtb2NrZWQgZm9yIHRlc3RpbmcuCiAgICoKICAgKiBFeHByZXNzaW9ucywgbGlrZSB0aGUgb25lIGRlZmluZWQgZm9yIHRoZSBgbmdDbGlja2AgZGlyZWN0aXZlIGluIHRoZSBleGFtcGxlCiAgICogYmVsb3csIGFyZSBldmFsdWF0ZWQgd2l0aCByZXNwZWN0IHRvIHRoZSBjdXJyZW50IHNjb3BlLiAgVGhlcmVmb3JlLCB0aGVyZSBpcwogICAqIG5vIHJpc2sgb2YgaW5hZHZlcnRlbnRseSBjb2RpbmcgaW4gYSBkZXBlbmRlbmN5IG9uIGEgZ2xvYmFsIHZhbHVlIGluIHN1Y2ggYW4KICAgKiBleHByZXNzaW9uLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSwgJHdpbmRvdykgewogICAgICAgICAgICRzY29wZS5ncmVldGluZyA9ICdIZWxsbywgV29ybGQhJzsKICAgICAgICAgICAkc2NvcGUuZG9HcmVldGluZyA9IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICAgICAgICAgICAgICR3aW5kb3cuYWxlcnQoZ3JlZXRpbmcpOwogICAgICAgICAgIH07CiAgICAgICAgIH0KICAgPC9zY3JpcHQ+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iZ3JlZXRpbmciIC8+CiAgIDxidXR0b24gbmctY2xpY2s9ImRvR3JlZXRpbmcoZ3JlZXRpbmcpIj5BTEVSVDwvYnV0dG9uPgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBkaXNwbGF5IHRoZSBncmVldGluZyBpbiB0aGUgaW5wdXQgYm94JywgZnVuY3Rpb24oKSB7CiAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdncmVldGluZycpKS5zZW5kS2V5cygnSGVsbG8sIEUyRSBUZXN0cycpOwogICAgICAgLy8gSWYgd2UgY2xpY2sgdGhlIGJ1dHRvbiBpdCB3aWxsIGJsb2NrIHRoZSB0ZXN0IHJ1bm5lcgogICAgICAgLy8gZWxlbWVudCgnOmJ1dHRvbicpLmNsaWNrKCk7CiAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICBmdW5jdGlvbiAkV2luZG93UHJvdmlkZXIoKXsKICAgIHRoaXMuJGdldCA9IHZhbHVlRm4od2luZG93KTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBwcm92aWRlcgogICAqIEBuYW1lICRmaWx0ZXJQcm92aWRlcgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogRmlsdGVycyBhcmUganVzdCBmdW5jdGlvbnMgd2hpY2ggdHJhbnNmb3JtIGlucHV0IHRvIGFuIG91dHB1dC4gSG93ZXZlciBmaWx0ZXJzIG5lZWQgdG8gYmUKICAgKiBEZXBlbmRlbmN5IEluamVjdGVkLiBUbyBhY2hpZXZlIHRoaXMgYSBmaWx0ZXIgZGVmaW5pdGlvbiBjb25zaXN0cyBvZiBhIGZhY3RvcnkgZnVuY3Rpb24gd2hpY2ggaXMKICAgKiBhbm5vdGF0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgYW5kIGlzIHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyBhIGZpbHRlciBmdW5jdGlvbi4KICAgKgogICAqIGBgYGpzCiAgICogICAvLyBGaWx0ZXIgcmVnaXN0cmF0aW9uCiAgICogICBmdW5jdGlvbiBNeU1vZHVsZSgkcHJvdmlkZSwgJGZpbHRlclByb3ZpZGVyKSB7CiAqICAgICAvLyBjcmVhdGUgYSBzZXJ2aWNlIHRvIGRlbW9uc3RyYXRlIGluamVjdGlvbiAobm90IGFsd2F5cyBuZWVkZWQpCiAqICAgICAkcHJvdmlkZS52YWx1ZSgnZ3JlZXQnLCBmdW5jdGlvbihuYW1lKXsKICogICAgICAgcmV0dXJuICdIZWxsbyAnICsgbmFtZSArICchJzsKICogICAgIH0pOwogKgogKiAgICAgLy8gcmVnaXN0ZXIgYSBmaWx0ZXIgZmFjdG9yeSB3aGljaCB1c2VzIHRoZQogKiAgICAgLy8gZ3JlZXQgc2VydmljZSB0byBkZW1vbnN0cmF0ZSBESS4KICogICAgICRmaWx0ZXJQcm92aWRlci5yZWdpc3RlcignZ3JlZXQnLCBmdW5jdGlvbihncmVldCl7CiAqICAgICAgIC8vIHJldHVybiB0aGUgZmlsdGVyIGZ1bmN0aW9uIHdoaWNoIHVzZXMgdGhlIGdyZWV0IHNlcnZpY2UKICogICAgICAgLy8gdG8gZ2VuZXJhdGUgc2FsdXRhdGlvbgogKiAgICAgICByZXR1cm4gZnVuY3Rpb24odGV4dCkgewogKiAgICAgICAgIC8vIGZpbHRlcnMgbmVlZCB0byBiZSBmb3JnaXZpbmcgc28gY2hlY2sgaW5wdXQgdmFsaWRpdHkKICogICAgICAgICByZXR1cm4gdGV4dCAmJiBncmVldCh0ZXh0KSB8fCB0ZXh0OwogKiAgICAgICB9OwogKiAgICAgfSk7CiAqICAgfQogICAqIGBgYAogICAqCiAgICogVGhlIGZpbHRlciBmdW5jdGlvbiBpcyByZWdpc3RlcmVkIHdpdGggdGhlIGAkaW5qZWN0b3JgIHVuZGVyIHRoZSBmaWx0ZXIgbmFtZSBzdWZmaXggd2l0aAogICAqIGBGaWx0ZXJgLgogICAqCiAgICogYGBganMKICAgKiAgIGl0KCdzaG91bGQgYmUgdGhlIHNhbWUgaW5zdGFuY2UnLCBpbmplY3QoCiAgICogICAgIGZ1bmN0aW9uKCRmaWx0ZXJQcm92aWRlcikgewogKiAgICAgICAkZmlsdGVyUHJvdmlkZXIucmVnaXN0ZXIoJ3JldmVyc2UnLCBmdW5jdGlvbigpewogKiAgICAgICAgIHJldHVybiAuLi47CiAqICAgICAgIH0pOwogKiAgICAgfSwKICAgKiAgICAgZnVuY3Rpb24oJGZpbHRlciwgcmV2ZXJzZUZpbHRlcikgewogKiAgICAgICBleHBlY3QoJGZpbHRlcigncmV2ZXJzZScpKS50b0JlKHJldmVyc2VGaWx0ZXIpOwogKiAgICAgfSk7CiAgICogYGBgCiAgICoKICAgKgogICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IGhvdyBhbmd1bGFyIGZpbHRlcnMgd29yaywgYW5kIGhvdyB0byBjcmVhdGUgeW91ciBvd24gZmlsdGVycywgc2VlCiAgICoge0BsaW5rIGd1aWRlL2ZpbHRlciBGaWx0ZXJzfSBpbiB0aGUgQW5ndWxhciBEZXZlbG9wZXIgR3VpZGUuCiAgICovCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRmaWx0ZXJQcm92aWRlciNyZWdpc3RlcgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJlZ2lzdGVyIGZpbHRlciBmYWN0b3J5IGZ1bmN0aW9uLgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFRoZSBmaWx0ZXIgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcyBpbmplY3RhYmxlLgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkZmlsdGVyCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKiBAZGVzY3JpcHRpb24KICAgKiBGaWx0ZXJzIGFyZSB1c2VkIGZvciBmb3JtYXR0aW5nIGRhdGEgZGlzcGxheWVkIHRvIHRoZSB1c2VyLgogICAqCiAgICogVGhlIGdlbmVyYWwgc3ludGF4IGluIHRlbXBsYXRlcyBpcyBhcyBmb2xsb3dzOgogICAqCiAgICogICAgICAgICB7eyBleHByZXNzaW9uIFt8IGZpbHRlcl9uYW1lWzpwYXJhbWV0ZXJfdmFsdWVdIC4uLiBdIH19CiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIgZnVuY3Rpb24gdG8gcmV0cmlldmUKICAgKiBAcmV0dXJuIHtGdW5jdGlvbn0gdGhlIGZpbHRlciBmdW5jdGlvbgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG5hbWU9IiRmaWx0ZXIiIG1vZHVsZT0iZmlsdGVyRXhhbXBsZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9Ik1haW5DdHJsIj4KICAgPGgzPnt7IG9yaWdpbmFsVGV4dCB9fTwvaDM+CiAgIDxoMz57eyBmaWx0ZXJlZFRleHQgfX08L2gzPgogICA8L2Rpdj4KICAgPC9maWxlPgoKICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgYW5ndWxhci5tb2R1bGUoJ2ZpbHRlckV4YW1wbGUnLCBbXSkKICAgLmNvbnRyb2xsZXIoJ01haW5DdHJsJywgZnVuY3Rpb24oJHNjb3BlLCAkZmlsdGVyKSB7CiAgICAgICAgJHNjb3BlLm9yaWdpbmFsVGV4dCA9ICdoZWxsbyc7CiAgICAgICAgJHNjb3BlLmZpbHRlcmVkVGV4dCA9ICRmaWx0ZXIoJ3VwcGVyY2FzZScpKCRzY29wZS5vcmlnaW5hbFRleHQpOwogICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgJEZpbHRlclByb3ZpZGVyLiRpbmplY3QgPSBbJyRwcm92aWRlJ107CiAgZnVuY3Rpb24gJEZpbHRlclByb3ZpZGVyKCRwcm92aWRlKSB7CiAgICB2YXIgc3VmZml4ID0gJ0ZpbHRlcic7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R9IG5hbWUgTmFtZSBvZiB0aGUgZmlsdGVyIGZ1bmN0aW9uLCBvciBhbiBvYmplY3QgbWFwIG9mIGZpbHRlcnMgd2hlcmUKICAgICAqICAgIHRoZSBrZXlzIGFyZSB0aGUgZmlsdGVyIG5hbWVzIGFuZCB0aGUgdmFsdWVzIGFyZSB0aGUgZmlsdGVyIGZhY3Rvcmllcy4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJlZ2lzdGVyZWQgZmlsdGVyIGluc3RhbmNlLCBvciBpZiBhIG1hcCBvZiBmaWx0ZXJzIHdhcyBwcm92aWRlZCB0aGVuIGEgbWFwCiAgICAgKiAgICBvZiB0aGUgcmVnaXN0ZXJlZCBmaWx0ZXIgaW5zdGFuY2VzLgogICAgICovCiAgICBmdW5jdGlvbiByZWdpc3RlcihuYW1lLCBmYWN0b3J5KSB7CiAgICAgIGlmKGlzT2JqZWN0KG5hbWUpKSB7CiAgICAgICAgdmFyIGZpbHRlcnMgPSB7fTsKICAgICAgICBmb3JFYWNoKG5hbWUsIGZ1bmN0aW9uKGZpbHRlciwga2V5KSB7CiAgICAgICAgICBmaWx0ZXJzW2tleV0gPSByZWdpc3RlcihrZXksIGZpbHRlcik7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGZpbHRlcnM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICRwcm92aWRlLmZhY3RvcnkobmFtZSArIHN1ZmZpeCwgZmFjdG9yeSk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMucmVnaXN0ZXIgPSByZWdpc3RlcjsKCiAgICB0aGlzLiRnZXQgPSBbJyRpbmplY3RvcicsIGZ1bmN0aW9uKCRpbmplY3RvcikgewogICAgICByZXR1cm4gZnVuY3Rpb24obmFtZSkgewogICAgICAgIHJldHVybiAkaW5qZWN0b3IuZ2V0KG5hbWUgKyBzdWZmaXgpOwogICAgICB9OwogICAgfV07CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIC8qIGdsb2JhbAogICAgIGN1cnJlbmN5RmlsdGVyOiBmYWxzZSwKICAgICBkYXRlRmlsdGVyOiBmYWxzZSwKICAgICBmaWx0ZXJGaWx0ZXI6IGZhbHNlLAogICAgIGpzb25GaWx0ZXI6IGZhbHNlLAogICAgIGxpbWl0VG9GaWx0ZXI6IGZhbHNlLAogICAgIGxvd2VyY2FzZUZpbHRlcjogZmFsc2UsCiAgICAgbnVtYmVyRmlsdGVyOiBmYWxzZSwKICAgICBvcmRlckJ5RmlsdGVyOiBmYWxzZSwKICAgICB1cHBlcmNhc2VGaWx0ZXI6IGZhbHNlLAogICAgICovCgogICAgcmVnaXN0ZXIoJ2N1cnJlbmN5JywgY3VycmVuY3lGaWx0ZXIpOwogICAgcmVnaXN0ZXIoJ2RhdGUnLCBkYXRlRmlsdGVyKTsKICAgIHJlZ2lzdGVyKCdmaWx0ZXInLCBmaWx0ZXJGaWx0ZXIpOwogICAgcmVnaXN0ZXIoJ2pzb24nLCBqc29uRmlsdGVyKTsKICAgIHJlZ2lzdGVyKCdsaW1pdFRvJywgbGltaXRUb0ZpbHRlcik7CiAgICByZWdpc3RlcignbG93ZXJjYXNlJywgbG93ZXJjYXNlRmlsdGVyKTsKICAgIHJlZ2lzdGVyKCdudW1iZXInLCBudW1iZXJGaWx0ZXIpOwogICAgcmVnaXN0ZXIoJ29yZGVyQnknLCBvcmRlckJ5RmlsdGVyKTsKICAgIHJlZ2lzdGVyKCd1cHBlcmNhc2UnLCB1cHBlcmNhc2VGaWx0ZXIpOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGZpbHRlcgogICAqIEBuYW1lIGZpbHRlcgogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZWxlY3RzIGEgc3Vic2V0IG9mIGl0ZW1zIGZyb20gYGFycmF5YCBhbmQgcmV0dXJucyBpdCBhcyBhIG5ldyBhcnJheS4KICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBzb3VyY2UgYXJyYXkuCiAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fGZ1bmN0aW9uKCl9IGV4cHJlc3Npb24gVGhlIHByZWRpY2F0ZSB0byBiZSB1c2VkIGZvciBzZWxlY3RpbmcgaXRlbXMgZnJvbQogICAqICAgYGFycmF5YC4KICAgKgogICAqICAgQ2FuIGJlIG9uZSBvZjoKICAgKgogICAqICAgLSBgc3RyaW5nYDogVGhlIHN0cmluZyBpcyBldmFsdWF0ZWQgYXMgYW4gZXhwcmVzc2lvbiBhbmQgdGhlIHJlc3VsdGluZyB2YWx1ZSBpcyB1c2VkIGZvciBzdWJzdHJpbmcgbWF0Y2ggYWdhaW5zdAogICAqICAgICB0aGUgY29udGVudHMgb2YgdGhlIGBhcnJheWAuIEFsbCBzdHJpbmdzIG9yIG9iamVjdHMgd2l0aCBzdHJpbmcgcHJvcGVydGllcyBpbiBgYXJyYXlgIHRoYXQgY29udGFpbiB0aGlzIHN0cmluZwogICAqICAgICB3aWxsIGJlIHJldHVybmVkLiBUaGUgcHJlZGljYXRlIGNhbiBiZSBuZWdhdGVkIGJ5IHByZWZpeGluZyB0aGUgc3RyaW5nIHdpdGggYCFgLgogICAqCiAgICogICAtIGBPYmplY3RgOiBBIHBhdHRlcm4gb2JqZWN0IGNhbiBiZSB1c2VkIHRvIGZpbHRlciBzcGVjaWZpYyBwcm9wZXJ0aWVzIG9uIG9iamVjdHMgY29udGFpbmVkCiAgICogICAgIGJ5IGBhcnJheWAuIEZvciBleGFtcGxlIGB7bmFtZToiTSIsIHBob25lOiIxIn1gIHByZWRpY2F0ZSB3aWxsIHJldHVybiBhbiBhcnJheSBvZiBpdGVtcwogICAqICAgICB3aGljaCBoYXZlIHByb3BlcnR5IGBuYW1lYCBjb250YWluaW5nICJNIiBhbmQgcHJvcGVydHkgYHBob25lYCBjb250YWluaW5nICIxIi4gQSBzcGVjaWFsCiAgICogICAgIHByb3BlcnR5IG5hbWUgYCRgIGNhbiBiZSB1c2VkIChhcyBpbiBgeyQ6InRleHQifWApIHRvIGFjY2VwdCBhIG1hdGNoIGFnYWluc3QgYW55CiAgICogICAgIHByb3BlcnR5IG9mIHRoZSBvYmplY3QuIFRoYXQncyBlcXVpdmFsZW50IHRvIHRoZSBzaW1wbGUgc3Vic3RyaW5nIG1hdGNoIHdpdGggYSBgc3RyaW5nYAogICAqICAgICBhcyBkZXNjcmliZWQgYWJvdmUuCiAgICoKICAgKiAgIC0gYGZ1bmN0aW9uKHZhbHVlKWA6IEEgcHJlZGljYXRlIGZ1bmN0aW9uIGNhbiBiZSB1c2VkIHRvIHdyaXRlIGFyYml0cmFyeSBmaWx0ZXJzLiBUaGUgZnVuY3Rpb24gaXMKICAgKiAgICAgY2FsbGVkIGZvciBlYWNoIGVsZW1lbnQgb2YgYGFycmF5YC4gVGhlIGZpbmFsIHJlc3VsdCBpcyBhbiBhcnJheSBvZiB0aG9zZSBlbGVtZW50cyB0aGF0CiAgICogICAgIHRoZSBwcmVkaWNhdGUgcmV0dXJuZWQgdHJ1ZSBmb3IuCiAgICoKICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQpfHRydWV8dW5kZWZpbmVkfSBjb21wYXJhdG9yIENvbXBhcmF0b3Igd2hpY2ggaXMgdXNlZCBpbgogICAqICAgICBkZXRlcm1pbmluZyBpZiB0aGUgZXhwZWN0ZWQgdmFsdWUgKGZyb20gdGhlIGZpbHRlciBleHByZXNzaW9uKSBhbmQgYWN0dWFsIHZhbHVlIChmcm9tCiAgICogICAgIHRoZSBvYmplY3QgaW4gdGhlIGFycmF5KSBzaG91bGQgYmUgY29uc2lkZXJlZCBhIG1hdGNoLgogICAqCiAgICogICBDYW4gYmUgb25lIG9mOgogICAqCiAgICogICAtIGBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkKWA6CiAgICogICAgIFRoZSBmdW5jdGlvbiB3aWxsIGJlIGdpdmVuIHRoZSBvYmplY3QgdmFsdWUgYW5kIHRoZSBwcmVkaWNhdGUgdmFsdWUgdG8gY29tcGFyZSBhbmQKICAgKiAgICAgc2hvdWxkIHJldHVybiB0cnVlIGlmIHRoZSBpdGVtIHNob3VsZCBiZSBpbmNsdWRlZCBpbiBmaWx0ZXJlZCByZXN1bHQuCiAgICoKICAgKiAgIC0gYHRydWVgOiBBIHNob3J0aGFuZCBmb3IgYGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQpIHsgcmV0dXJuIGFuZ3VsYXIuZXF1YWxzKGV4cGVjdGVkLCBhY3R1YWwpfWAuCiAgICogICAgIHRoaXMgaXMgZXNzZW50aWFsbHkgc3RyaWN0IGNvbXBhcmlzb24gb2YgZXhwZWN0ZWQgYW5kIGFjdHVhbC4KICAgKgogICAqICAgLSBgZmFsc2V8dW5kZWZpbmVkYDogQSBzaG9ydCBoYW5kIGZvciBhIGZ1bmN0aW9uIHdoaWNoIHdpbGwgbG9vayBmb3IgYSBzdWJzdHJpbmcgbWF0Y2ggaW4gY2FzZQogICAqICAgICBpbnNlbnNpdGl2ZSB3YXkuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctaW5pdD0iZnJpZW5kcyA9IFt7bmFtZTonSm9obicsIHBob25lOic1NTUtMTI3Nid9LAogICB7bmFtZTonTWFyeScsIHBob25lOic4MDAtQklHLU1BUlknfSwKICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnfSwKICAge25hbWU6J0FkYW0nLCBwaG9uZTonNTU1LTU2NzgnfSwKICAge25hbWU6J0p1bGllJywgcGhvbmU6JzU1NS04NzY1J30sCiAgIHtuYW1lOidKdWxpZXR0ZScsIHBob25lOic1NTUtNTY3OCd9XSI+PC9kaXY+CgogICBTZWFyY2g6IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoVGV4dCI+CiAgIDx0YWJsZSBpZD0ic2VhcmNoVGV4dFJlc3VsdHMiPgogICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBmaWx0ZXI6c2VhcmNoVGV4dCI+CiAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgIDwvdHI+CiAgIDwvdGFibGU+CiAgIDxocj4KICAgQW55OiA8aW5wdXQgbmctbW9kZWw9InNlYXJjaC4kIj4gPGJyPgogICBOYW1lIG9ubHkgPGlucHV0IG5nLW1vZGVsPSJzZWFyY2gubmFtZSI+PGJyPgogICBQaG9uZSBvbmx5IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLnBob25lIj48YnI+CiAgIEVxdWFsaXR5IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InN0cmljdCI+PGJyPgogICA8dGFibGUgaWQ9InNlYXJjaE9ialJlc3VsdHMiPgogICA8dHI+PHRoPk5hbWU8L3RoPjx0aD5QaG9uZTwvdGg+PC90cj4KICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kT2JqIGluIGZyaWVuZHMgfCBmaWx0ZXI6c2VhcmNoOnN0cmljdCI+CiAgIDx0ZD57e2ZyaWVuZE9iai5uYW1lfX08L3RkPgogICA8dGQ+e3tmcmllbmRPYmoucGhvbmV9fTwvdGQ+CiAgIDwvdHI+CiAgIDwvdGFibGU+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIHZhciBleHBlY3RGcmllbmROYW1lcyA9IGZ1bmN0aW9uKGV4cGVjdGVkTmFtZXMsIGtleSkgewogICAgICAgICBlbGVtZW50LmFsbChieS5yZXBlYXRlcihrZXkgKyAnIGluIGZyaWVuZHMnKS5jb2x1bW4oa2V5ICsgJy5uYW1lJykpLnRoZW4oZnVuY3Rpb24oYXJyKSB7CiAgICAgICAgICAgYXJyLmZvckVhY2goZnVuY3Rpb24od2QsIGkpIHsKICAgICAgICAgICAgIGV4cGVjdCh3ZC5nZXRUZXh0KCkpLnRvTWF0Y2goZXhwZWN0ZWROYW1lc1tpXSk7CiAgICAgICAgICAgfSk7CiAgICAgICAgIH0pOwogICAgICAgfTsKCiAgIGl0KCdzaG91bGQgc2VhcmNoIGFjcm9zcyBhbGwgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdmFyIHNlYXJjaFRleHQgPSBlbGVtZW50KGJ5Lm1vZGVsKCdzZWFyY2hUZXh0JykpOwogICAgICAgICBzZWFyY2hUZXh0LmNsZWFyKCk7CiAgICAgICAgIHNlYXJjaFRleHQuc2VuZEtleXMoJ20nKTsKICAgICAgICAgZXhwZWN0RnJpZW5kTmFtZXMoWydNYXJ5JywgJ01pa2UnLCAnQWRhbSddLCAnZnJpZW5kJyk7CgogICAgICAgICBzZWFyY2hUZXh0LmNsZWFyKCk7CiAgICAgICAgIHNlYXJjaFRleHQuc2VuZEtleXMoJzc2Jyk7CiAgICAgICAgIGV4cGVjdEZyaWVuZE5hbWVzKFsnSm9obicsICdKdWxpZSddLCAnZnJpZW5kJyk7CiAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgc2VhcmNoIGluIHNwZWNpZmljIGZpZWxkcyB3aGVuIGZpbHRlcmluZyB3aXRoIGEgcHJlZGljYXRlIG9iamVjdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICB2YXIgc2VhcmNoQW55ID0gZWxlbWVudChieS5tb2RlbCgnc2VhcmNoLiQnKSk7CiAgICAgICAgIHNlYXJjaEFueS5jbGVhcigpOwogICAgICAgICBzZWFyY2hBbnkuc2VuZEtleXMoJ2knKTsKICAgICAgICAgZXhwZWN0RnJpZW5kTmFtZXMoWydNYXJ5JywgJ01pa2UnLCAnSnVsaWUnLCAnSnVsaWV0dGUnXSwgJ2ZyaWVuZE9iaicpOwogICAgICAgfSk7CiAgIGl0KCdzaG91bGQgdXNlIGEgZXF1YWwgY29tcGFyaXNvbiB3aGVuIGNvbXBhcmF0b3IgaXMgdHJ1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICB2YXIgc2VhcmNoTmFtZSA9IGVsZW1lbnQoYnkubW9kZWwoJ3NlYXJjaC5uYW1lJykpOwogICAgICAgICB2YXIgc3RyaWN0ID0gZWxlbWVudChieS5tb2RlbCgnc3RyaWN0JykpOwogICAgICAgICBzZWFyY2hOYW1lLmNsZWFyKCk7CiAgICAgICAgIHNlYXJjaE5hbWUuc2VuZEtleXMoJ0p1bGllJyk7CiAgICAgICAgIHN0cmljdC5jbGljaygpOwogICAgICAgICBleHBlY3RGcmllbmROYW1lcyhbJ0p1bGllJ10sICdmcmllbmRPYmonKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICBmdW5jdGlvbiBmaWx0ZXJGaWx0ZXIoKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oYXJyYXksIGV4cHJlc3Npb24sIGNvbXBhcmF0b3IpIHsKICAgICAgaWYgKCFpc0FycmF5KGFycmF5KSkgcmV0dXJuIGFycmF5OwoKICAgICAgdmFyIGNvbXBhcmF0b3JUeXBlID0gdHlwZW9mKGNvbXBhcmF0b3IpLAogICAgICAgIHByZWRpY2F0ZXMgPSBbXTsKCiAgICAgIHByZWRpY2F0ZXMuY2hlY2sgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcHJlZGljYXRlcy5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYoIXByZWRpY2F0ZXNbal0odmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH07CgogICAgICBpZiAoY29tcGFyYXRvclR5cGUgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICBpZiAoY29tcGFyYXRvclR5cGUgPT09ICdib29sZWFuJyAmJiBjb21wYXJhdG9yKSB7CiAgICAgICAgICBjb21wYXJhdG9yID0gZnVuY3Rpb24ob2JqLCB0ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBhbmd1bGFyLmVxdWFscyhvYmosIHRleHQpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29tcGFyYXRvciA9IGZ1bmN0aW9uKG9iaiwgdGV4dCkgewogICAgICAgICAgICBpZiAob2JqICYmIHRleHQgJiYgdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIHRleHQgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgb2JqS2V5IGluIG9iaikgewogICAgICAgICAgICAgICAgaWYgKG9iaktleS5jaGFyQXQoMCkgIT09ICckJyAmJiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgb2JqS2V5KSAmJgogICAgICAgICAgICAgICAgICBjb21wYXJhdG9yKG9ialtvYmpLZXldLCB0ZXh0W29iaktleV0pKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGV4dCA9ICgnJyt0ZXh0KS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICByZXR1cm4gKCcnK29iaikudG9Mb3dlckNhc2UoKS5pbmRleE9mKHRleHQpID4gLTE7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHNlYXJjaCA9IGZ1bmN0aW9uKG9iaiwgdGV4dCl7CiAgICAgICAgaWYgKHR5cGVvZiB0ZXh0ID09ICdzdHJpbmcnICYmIHRleHQuY2hhckF0KDApID09PSAnIScpIHsKICAgICAgICAgIHJldHVybiAhc2VhcmNoKG9iaiwgdGV4dC5zdWJzdHIoMSkpOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKHR5cGVvZiBvYmopIHsKICAgICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgIHJldHVybiBjb21wYXJhdG9yKG9iaiwgdGV4dCk7CiAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiB0ZXh0KSB7CiAgICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgIHJldHVybiBjb21wYXJhdG9yKG9iaiwgdGV4dCk7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIGZvciAoIHZhciBvYmpLZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICAgIGlmIChvYmpLZXkuY2hhckF0KDApICE9PSAnJCcgJiYgc2VhcmNoKG9ialtvYmpLZXldLCB0ZXh0KSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICBjYXNlICJhcnJheSI6CiAgICAgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IG9iai5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGlmIChzZWFyY2gob2JqW2ldLCB0ZXh0KSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHN3aXRjaCAodHlwZW9mIGV4cHJlc3Npb24pIHsKICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAvLyBTZXQgdXAgZXhwcmVzc2lvbiBvYmplY3QgYW5kIGZhbGwgdGhyb3VnaAogICAgICAgICAgZXhwcmVzc2lvbiA9IHskOmV4cHJlc3Npb259OwogICAgICAgIC8vIGpzaGludCAtVzA4NgogICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAvLyBqc2hpbnQgK1cwODYKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBleHByZXNzaW9uKSB7CiAgICAgICAgICAgIChmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBleHByZXNzaW9uW3BhdGhdID09ICd1bmRlZmluZWQnKSByZXR1cm47CiAgICAgICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2VhcmNoKHBhdGggPT0gJyQnID8gdmFsdWUgOiAodmFsdWUgJiYgdmFsdWVbcGF0aF0pLCBleHByZXNzaW9uW3BhdGhdKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkoa2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2Z1bmN0aW9uJzoKICAgICAgICAgIHByZWRpY2F0ZXMucHVzaChleHByZXNzaW9uKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXR1cm4gYXJyYXk7CiAgICAgIH0KICAgICAgdmFyIGZpbHRlcmVkID0gW107CiAgICAgIGZvciAoIHZhciBqID0gMDsgaiA8IGFycmF5Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJyYXlbal07CiAgICAgICAgaWYgKHByZWRpY2F0ZXMuY2hlY2sodmFsdWUpKSB7CiAgICAgICAgICBmaWx0ZXJlZC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZpbHRlcmVkOwogICAgfTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBmaWx0ZXIKICAgKiBAbmFtZSBjdXJyZW5jeQogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBGb3JtYXRzIGEgbnVtYmVyIGFzIGEgY3VycmVuY3kgKGllICQxLDIzNC41NikuIFdoZW4gbm8gY3VycmVuY3kgc3ltYm9sIGlzIHByb3ZpZGVkLCBkZWZhdWx0CiAgICogc3ltYm9sIGZvciBjdXJyZW50IGxvY2FsZSBpcyB1c2VkLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCBJbnB1dCB0byBmaWx0ZXIuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBzeW1ib2wgQ3VycmVuY3kgc3ltYm9sIG9yIGlkZW50aWZpZXIgdG8gYmUgZGlzcGxheWVkLgogICAqIEByZXR1cm5zIHtzdHJpbmd9IEZvcm1hdHRlZCBudW1iZXIuCiAgICoKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUuYW1vdW50ID0gMTIzNC41NjsKICAgICAgICAgfQogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgPGlucHV0IHR5cGU9Im51bWJlciIgbmctbW9kZWw9ImFtb3VudCI+IDxicj4KICAgZGVmYXVsdCBjdXJyZW5jeSBzeW1ib2wgKCQpOiA8c3BhbiBpZD0iY3VycmVuY3ktZGVmYXVsdCI+e3thbW91bnQgfCBjdXJyZW5jeX19PC9zcGFuPjxicj4KICAgY3VzdG9tIGN1cnJlbmN5IGlkZW50aWZpZXIgKFVTRCQpOiA8c3Bhbj57e2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIn19PC9zcGFuPgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBpbml0IHdpdGggMTIzNC41NicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnY3VycmVuY3ktZGVmYXVsdCcpKS5nZXRUZXh0KCkpLnRvQmUoJyQxLDIzNC41NicpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdhbW91bnQgfCBjdXJyZW5jeToiVVNEJCInKSkuZ2V0VGV4dCgpKS50b0JlKCdVU0QkMSwyMzQuNTYnKTsKICAgICAgIH0pOwogICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBpZiAoYnJvd3Nlci5wYXJhbXMuYnJvd3NlciA9PSAnc2FmYXJpJykgewogICAgICAgICAgIC8vIFNhZmFyaSBkb2VzIG5vdCB1bmRlcnN0YW5kIHRoZSBtaW51cyBrZXkuIFNlZQogICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL3Byb3RyYWN0b3IvaXNzdWVzLzQ4MQogICAgICAgICAgIHJldHVybjsKICAgICAgICAgfQogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdhbW91bnQnKSkuY2xlYXIoKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnYW1vdW50JykpLnNlbmRLZXlzKCctMTIzNCcpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnY3VycmVuY3ktZGVmYXVsdCcpKS5nZXRUZXh0KCkpLnRvQmUoJygkMSwyMzQuMDApJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIicpKS5nZXRUZXh0KCkpLnRvQmUoJyhVU0QkMSwyMzQuMDApJyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgY3VycmVuY3lGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogIGZ1bmN0aW9uIGN1cnJlbmN5RmlsdGVyKCRsb2NhbGUpIHsKICAgIHZhciBmb3JtYXRzID0gJGxvY2FsZS5OVU1CRVJfRk9STUFUUzsKICAgIHJldHVybiBmdW5jdGlvbihhbW91bnQsIGN1cnJlbmN5U3ltYm9sKXsKICAgICAgaWYgKGlzVW5kZWZpbmVkKGN1cnJlbmN5U3ltYm9sKSkgY3VycmVuY3lTeW1ib2wgPSBmb3JtYXRzLkNVUlJFTkNZX1NZTTsKICAgICAgcmV0dXJuIGZvcm1hdE51bWJlcihhbW91bnQsIGZvcm1hdHMuUEFUVEVSTlNbMV0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLCAyKS4KICAgICAgICByZXBsYWNlKC9cdTAwQTQvZywgY3VycmVuY3lTeW1ib2wpOwogICAgfTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBmaWx0ZXIKICAgKiBAbmFtZSBudW1iZXIKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRm9ybWF0cyBhIG51bWJlciBhcyB0ZXh0LgogICAqCiAgICogSWYgdGhlIGlucHV0IGlzIG5vdCBhIG51bWJlciBhbiBlbXB0eSBzdHJpbmcgaXMgcmV0dXJuZWQuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcnxzdHJpbmd9IG51bWJlciBOdW1iZXIgdG8gZm9ybWF0LgogICAqIEBwYXJhbSB7KG51bWJlcnxzdHJpbmcpPX0gZnJhY3Rpb25TaXplIE51bWJlciBvZiBkZWNpbWFsIHBsYWNlcyB0byByb3VuZCB0aGUgbnVtYmVyIHRvLgogICAqIElmIHRoaXMgaXMgbm90IHByb3ZpZGVkIHRoZW4gdGhlIGZyYWN0aW9uIHNpemUgaXMgY29tcHV0ZWQgZnJvbSB0aGUgY3VycmVudCBsb2NhbGUncyBudW1iZXIKICAgKiBmb3JtYXR0aW5nIHBhdHRlcm4uIEluIHRoZSBjYXNlIG9mIHRoZSBkZWZhdWx0IGxvY2FsZSwgaXQgd2lsbCBiZSAzLgogICAqIEByZXR1cm5zIHtzdHJpbmd9IE51bWJlciByb3VuZGVkIHRvIGRlY2ltYWxQbGFjZXMgYW5kIHBsYWNlcyBhIOKAnCzigJ0gYWZ0ZXIgZWFjaCB0aGlyZCBkaWdpdC4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudmFsID0gMTIzNC41Njc4OTsKICAgICAgICAgfQogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgRW50ZXIgbnVtYmVyOiA8aW5wdXQgbmctbW9kZWw9J3ZhbCc+PGJyPgogICBEZWZhdWx0IGZvcm1hdHRpbmc6IDxzcGFuIGlkPSdudW1iZXItZGVmYXVsdCc+e3t2YWwgfCBudW1iZXJ9fTwvc3Bhbj48YnI+CiAgIE5vIGZyYWN0aW9uczogPHNwYW4+e3t2YWwgfCBudW1iZXI6MH19PC9zcGFuPjxicj4KICAgTmVnYXRpdmUgbnVtYmVyOiA8c3Bhbj57ey12YWwgfCBudW1iZXI6NH19PC9zcGFuPgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBmb3JtYXQgbnVtYmVycycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbnVtYmVyLWRlZmF1bHQnKSkuZ2V0VGV4dCgpKS50b0JlKCcxLDIzNC41NjgnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygndmFsIHwgbnVtYmVyOjAnKSkuZ2V0VGV4dCgpKS50b0JlKCcxLDIzNScpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCctdmFsIHwgbnVtYmVyOjQnKSkuZ2V0VGV4dCgpKS50b0JlKCctMSwyMzQuNTY3OScpOwogICAgICAgfSk7CgogICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCd2YWwnKSkuY2xlYXIoKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsJykpLnNlbmRLZXlzKCczMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbnVtYmVyLWRlZmF1bHQnKSkuZ2V0VGV4dCgpKS50b0JlKCczLDM3NC4zMzMnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygndmFsIHwgbnVtYmVyOjAnKSkuZ2V0VGV4dCgpKS50b0JlKCczLDM3NCcpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCctdmFsIHwgbnVtYmVyOjQnKSkuZ2V0VGV4dCgpKS50b0JlKCctMywzNzQuMzMzMCcpOwogICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgoKICBudW1iZXJGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogIGZ1bmN0aW9uIG51bWJlckZpbHRlcigkbG9jYWxlKSB7CiAgICB2YXIgZm9ybWF0cyA9ICRsb2NhbGUuTlVNQkVSX0ZPUk1BVFM7CiAgICByZXR1cm4gZnVuY3Rpb24obnVtYmVyLCBmcmFjdGlvblNpemUpIHsKICAgICAgcmV0dXJuIGZvcm1hdE51bWJlcihudW1iZXIsIGZvcm1hdHMuUEFUVEVSTlNbMF0sIGZvcm1hdHMuR1JPVVBfU0VQLCBmb3JtYXRzLkRFQ0lNQUxfU0VQLAogICAgICAgIGZyYWN0aW9uU2l6ZSk7CiAgICB9OwogIH0KCiAgdmFyIERFQ0lNQUxfU0VQID0gJy4nOwogIGZ1bmN0aW9uIGZvcm1hdE51bWJlcihudW1iZXIsIHBhdHRlcm4sIGdyb3VwU2VwLCBkZWNpbWFsU2VwLCBmcmFjdGlvblNpemUpIHsKICAgIGlmIChudW1iZXIgPT0gbnVsbCB8fCAhaXNGaW5pdGUobnVtYmVyKSB8fCBpc09iamVjdChudW1iZXIpKSByZXR1cm4gJyc7CgogICAgdmFyIGlzTmVnYXRpdmUgPSBudW1iZXIgPCAwOwogICAgbnVtYmVyID0gTWF0aC5hYnMobnVtYmVyKTsKICAgIHZhciBudW1TdHIgPSBudW1iZXIgKyAnJywKICAgICAgZm9ybWF0ZWRUZXh0ID0gJycsCiAgICAgIHBhcnRzID0gW107CgogICAgdmFyIGhhc0V4cG9uZW50ID0gZmFsc2U7CiAgICBpZiAobnVtU3RyLmluZGV4T2YoJ2UnKSAhPT0gLTEpIHsKICAgICAgdmFyIG1hdGNoID0gbnVtU3RyLm1hdGNoKC8oW1xkXC5dKyllKC0/KShcZCspLyk7CiAgICAgIGlmIChtYXRjaCAmJiBtYXRjaFsyXSA9PSAnLScgJiYgbWF0Y2hbM10gPiBmcmFjdGlvblNpemUgKyAxKSB7CiAgICAgICAgbnVtU3RyID0gJzAnOwogICAgICB9IGVsc2UgewogICAgICAgIGZvcm1hdGVkVGV4dCA9IG51bVN0cjsKICAgICAgICBoYXNFeHBvbmVudCA9IHRydWU7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoIWhhc0V4cG9uZW50KSB7CiAgICAgIHZhciBmcmFjdGlvbkxlbiA9IChudW1TdHIuc3BsaXQoREVDSU1BTF9TRVApWzFdIHx8ICcnKS5sZW5ndGg7CgogICAgICAvLyBkZXRlcm1pbmUgZnJhY3Rpb25TaXplIGlmIGl0IGlzIG5vdCBzcGVjaWZpZWQKICAgICAgaWYgKGlzVW5kZWZpbmVkKGZyYWN0aW9uU2l6ZSkpIHsKICAgICAgICBmcmFjdGlvblNpemUgPSBNYXRoLm1pbihNYXRoLm1heChwYXR0ZXJuLm1pbkZyYWMsIGZyYWN0aW9uTGVuKSwgcGF0dGVybi5tYXhGcmFjKTsKICAgICAgfQoKICAgICAgdmFyIHBvdyA9IE1hdGgucG93KDEwLCBmcmFjdGlvblNpemUgKyAxKTsKICAgICAgbnVtYmVyID0gTWF0aC5mbG9vcihudW1iZXIgKiBwb3cgKyA1KSAvIHBvdzsKICAgICAgdmFyIGZyYWN0aW9uID0gKCcnICsgbnVtYmVyKS5zcGxpdChERUNJTUFMX1NFUCk7CiAgICAgIHZhciB3aG9sZSA9IGZyYWN0aW9uWzBdOwogICAgICBmcmFjdGlvbiA9IGZyYWN0aW9uWzFdIHx8ICcnOwoKICAgICAgdmFyIGksIHBvcyA9IDAsCiAgICAgICAgbGdyb3VwID0gcGF0dGVybi5sZ1NpemUsCiAgICAgICAgZ3JvdXAgPSBwYXR0ZXJuLmdTaXplOwoKICAgICAgaWYgKHdob2xlLmxlbmd0aCA+PSAobGdyb3VwICsgZ3JvdXApKSB7CiAgICAgICAgcG9zID0gd2hvbGUubGVuZ3RoIC0gbGdyb3VwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBwb3M7IGkrKykgewogICAgICAgICAgaWYgKChwb3MgLSBpKSVncm91cCA9PT0gMCAmJiBpICE9PSAwKSB7CiAgICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgICAgIH0KICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSB3aG9sZS5jaGFyQXQoaSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3IgKGkgPSBwb3M7IGkgPCB3aG9sZS5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICgod2hvbGUubGVuZ3RoIC0gaSklbGdyb3VwID09PSAwICYmIGkgIT09IDApIHsKICAgICAgICAgIGZvcm1hdGVkVGV4dCArPSBncm91cFNlcDsKICAgICAgICB9CiAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IHdob2xlLmNoYXJBdChpKTsKICAgICAgfQoKICAgICAgLy8gZm9ybWF0IGZyYWN0aW9uIHBhcnQuCiAgICAgIHdoaWxlKGZyYWN0aW9uLmxlbmd0aCA8IGZyYWN0aW9uU2l6ZSkgewogICAgICAgIGZyYWN0aW9uICs9ICcwJzsKICAgICAgfQoKICAgICAgaWYgKGZyYWN0aW9uU2l6ZSAmJiBmcmFjdGlvblNpemUgIT09ICIwIikgZm9ybWF0ZWRUZXh0ICs9IGRlY2ltYWxTZXAgKyBmcmFjdGlvbi5zdWJzdHIoMCwgZnJhY3Rpb25TaXplKTsKICAgIH0gZWxzZSB7CgogICAgICBpZiAoZnJhY3Rpb25TaXplID4gMCAmJiBudW1iZXIgPiAtMSAmJiBudW1iZXIgPCAxKSB7CiAgICAgICAgZm9ybWF0ZWRUZXh0ID0gbnVtYmVyLnRvRml4ZWQoZnJhY3Rpb25TaXplKTsKICAgICAgfQogICAgfQoKICAgIHBhcnRzLnB1c2goaXNOZWdhdGl2ZSA/IHBhdHRlcm4ubmVnUHJlIDogcGF0dGVybi5wb3NQcmUpOwogICAgcGFydHMucHVzaChmb3JtYXRlZFRleHQpOwogICAgcGFydHMucHVzaChpc05lZ2F0aXZlID8gcGF0dGVybi5uZWdTdWYgOiBwYXR0ZXJuLnBvc1N1Zik7CiAgICByZXR1cm4gcGFydHMuam9pbignJyk7CiAgfQoKICBmdW5jdGlvbiBwYWROdW1iZXIobnVtLCBkaWdpdHMsIHRyaW0pIHsKICAgIHZhciBuZWcgPSAnJzsKICAgIGlmIChudW0gPCAwKSB7CiAgICAgIG5lZyA9ICAnLSc7CiAgICAgIG51bSA9IC1udW07CiAgICB9CiAgICBudW0gPSAnJyArIG51bTsKICAgIHdoaWxlKG51bS5sZW5ndGggPCBkaWdpdHMpIG51bSA9ICcwJyArIG51bTsKICAgIGlmICh0cmltKQogICAgICBudW0gPSBudW0uc3Vic3RyKG51bS5sZW5ndGggLSBkaWdpdHMpOwogICAgcmV0dXJuIG5lZyArIG51bTsKICB9CgoKICBmdW5jdGlvbiBkYXRlR2V0dGVyKG5hbWUsIHNpemUsIG9mZnNldCwgdHJpbSkgewogICAgb2Zmc2V0ID0gb2Zmc2V0IHx8IDA7CiAgICByZXR1cm4gZnVuY3Rpb24oZGF0ZSkgewogICAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKICAgICAgaWYgKG9mZnNldCA+IDAgfHwgdmFsdWUgPiAtb2Zmc2V0KQogICAgICAgIHZhbHVlICs9IG9mZnNldDsKICAgICAgaWYgKHZhbHVlID09PSAwICYmIG9mZnNldCA9PSAtMTIgKSB2YWx1ZSA9IDEyOwogICAgICByZXR1cm4gcGFkTnVtYmVyKHZhbHVlLCBzaXplLCB0cmltKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBkYXRlU3RyR2V0dGVyKG5hbWUsIHNob3J0Rm9ybSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGUsIGZvcm1hdHMpIHsKICAgICAgdmFyIHZhbHVlID0gZGF0ZVsnZ2V0JyArIG5hbWVdKCk7CiAgICAgIHZhciBnZXQgPSB1cHBlcmNhc2Uoc2hvcnRGb3JtID8gKCdTSE9SVCcgKyBuYW1lKSA6IG5hbWUpOwoKICAgICAgcmV0dXJuIGZvcm1hdHNbZ2V0XVt2YWx1ZV07CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gdGltZVpvbmVHZXR0ZXIoZGF0ZSkgewogICAgdmFyIHpvbmUgPSAtMSAqIGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICAgIHZhciBwYWRkZWRab25lID0gKHpvbmUgPj0gMCkgPyAiKyIgOiAiIjsKCiAgICBwYWRkZWRab25lICs9IHBhZE51bWJlcihNYXRoW3pvbmUgPiAwID8gJ2Zsb29yJyA6ICdjZWlsJ10oem9uZSAvIDYwKSwgMikgKwogICAgICBwYWROdW1iZXIoTWF0aC5hYnMoem9uZSAlIDYwKSwgMik7CgogICAgcmV0dXJuIHBhZGRlZFpvbmU7CiAgfQoKICBmdW5jdGlvbiBhbXBtR2V0dGVyKGRhdGUsIGZvcm1hdHMpIHsKICAgIHJldHVybiBkYXRlLmdldEhvdXJzKCkgPCAxMiA/IGZvcm1hdHMuQU1QTVNbMF0gOiBmb3JtYXRzLkFNUE1TWzFdOwogIH0KCiAgdmFyIERBVEVfRk9STUFUUyA9IHsKICAgIHl5eXk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgNCksCiAgICB5eTogZGF0ZUdldHRlcignRnVsbFllYXInLCAyLCAwLCB0cnVlKSwKICAgIHk6IGRhdGVHZXR0ZXIoJ0Z1bGxZZWFyJywgMSksCiAgICBNTU1NOiBkYXRlU3RyR2V0dGVyKCdNb250aCcpLAogICAgTU1NOiBkYXRlU3RyR2V0dGVyKCdNb250aCcsIHRydWUpLAogICAgTU06IGRhdGVHZXR0ZXIoJ01vbnRoJywgMiwgMSksCiAgICBNOiBkYXRlR2V0dGVyKCdNb250aCcsIDEsIDEpLAogICAgZGQ6IGRhdGVHZXR0ZXIoJ0RhdGUnLCAyKSwKICAgIGQ6IGRhdGVHZXR0ZXIoJ0RhdGUnLCAxKSwKICAgIEhIOiBkYXRlR2V0dGVyKCdIb3VycycsIDIpLAogICAgSDogZGF0ZUdldHRlcignSG91cnMnLCAxKSwKICAgIGhoOiBkYXRlR2V0dGVyKCdIb3VycycsIDIsIC0xMiksCiAgICBoOiBkYXRlR2V0dGVyKCdIb3VycycsIDEsIC0xMiksCiAgICBtbTogZGF0ZUdldHRlcignTWludXRlcycsIDIpLAogICAgbTogZGF0ZUdldHRlcignTWludXRlcycsIDEpLAogICAgc3M6IGRhdGVHZXR0ZXIoJ1NlY29uZHMnLCAyKSwKICAgIHM6IGRhdGVHZXR0ZXIoJ1NlY29uZHMnLCAxKSwKICAgIC8vIHdoaWxlIElTTyA4NjAxIHJlcXVpcmVzIGZyYWN0aW9ucyB0byBiZSBwcmVmaXhlZCB3aXRoIGAuYCBvciBgLGAKICAgIC8vIHdlIGNhbiBiZSBqdXN0IHNhZmVseSByZWx5IG9uIHVzaW5nIGBzc3NgIHNpbmNlIHdlIGN1cnJlbnRseSBkb24ndCBzdXBwb3J0IHNpbmdsZSBvciB0d28gZGlnaXQgZnJhY3Rpb25zCiAgICBzc3M6IGRhdGVHZXR0ZXIoJ01pbGxpc2Vjb25kcycsIDMpLAogICAgRUVFRTogZGF0ZVN0ckdldHRlcignRGF5JyksCiAgICBFRUU6IGRhdGVTdHJHZXR0ZXIoJ0RheScsIHRydWUpLAogICAgYTogYW1wbUdldHRlciwKICAgIFo6IHRpbWVab25lR2V0dGVyCiAgfTsKCiAgdmFyIERBVEVfRk9STUFUU19TUExJVCA9IC8oKD86W155TWRIaG1zYVpFJ10rKXwoPzonKD86W14nXXwnJykqJyl8KD86RSt8eSt8TSt8ZCt8SCt8aCt8bSt8cyt8YXxaKSkoLiopLywKICAgIE5VTUJFUl9TVFJJTkcgPSAvXlwtP1xkKyQvOwoKICAvKioKICAgKiBAbmdkb2MgZmlsdGVyCiAgICogQG5hbWUgZGF0ZQogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiAgIEZvcm1hdHMgYGRhdGVgIHRvIGEgc3RyaW5nIGJhc2VkIG9uIHRoZSByZXF1ZXN0ZWQgYGZvcm1hdGAuCiAgICoKICAgKiAgIGBmb3JtYXRgIHN0cmluZyBjYW4gYmUgY29tcG9zZWQgb2YgdGhlIGZvbGxvd2luZyBlbGVtZW50czoKICAgKgogICAqICAgKiBgJ3l5eXknYDogNCBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyIChlLmcuIEFEIDEgPT4gMDAwMSwgQUQgMjAxMCA9PiAyMDEwKQogICAqICAgKiBgJ3l5J2A6IDIgZGlnaXQgcmVwcmVzZW50YXRpb24gb2YgeWVhciwgcGFkZGVkICgwMC05OSkuIChlLmcuIEFEIDIwMDEgPT4gMDEsIEFEIDIwMTAgPT4gMTApCiAgICogICAqIGAneSdgOiAxIGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIsIGUuZy4gKEFEIDEgPT4gMSwgQUQgMTk5ID0+IDE5OSkKICAgKiAgICogYCdNTU1NJ2A6IE1vbnRoIGluIHllYXIgKEphbnVhcnktRGVjZW1iZXIpCiAgICogICAqIGAnTU1NJ2A6IE1vbnRoIGluIHllYXIgKEphbi1EZWMpCiAgICogICAqIGAnTU0nYDogTW9udGggaW4geWVhciwgcGFkZGVkICgwMS0xMikKICAgKiAgICogYCdNJ2A6IE1vbnRoIGluIHllYXIgKDEtMTIpCiAgICogICAqIGAnZGQnYDogRGF5IGluIG1vbnRoLCBwYWRkZWQgKDAxLTMxKQogICAqICAgKiBgJ2QnYDogRGF5IGluIG1vbnRoICgxLTMxKQogICAqICAgKiBgJ0VFRUUnYDogRGF5IGluIFdlZWssKFN1bmRheS1TYXR1cmRheSkKICAgKiAgICogYCdFRUUnYDogRGF5IGluIFdlZWssIChTdW4tU2F0KQogICAqICAgKiBgJ0hIJ2A6IEhvdXIgaW4gZGF5LCBwYWRkZWQgKDAwLTIzKQogICAqICAgKiBgJ0gnYDogSG91ciBpbiBkYXkgKDAtMjMpCiAgICogICAqIGAnaGgnYDogSG91ciBpbiBhbS9wbSwgcGFkZGVkICgwMS0xMikKICAgKiAgICogYCdoJ2A6IEhvdXIgaW4gYW0vcG0sICgxLTEyKQogICAqICAgKiBgJ21tJ2A6IE1pbnV0ZSBpbiBob3VyLCBwYWRkZWQgKDAwLTU5KQogICAqICAgKiBgJ20nYDogTWludXRlIGluIGhvdXIgKDAtNTkpCiAgICogICAqIGAnc3MnYDogU2Vjb25kIGluIG1pbnV0ZSwgcGFkZGVkICgwMC01OSkKICAgKiAgICogYCdzJ2A6IFNlY29uZCBpbiBtaW51dGUgKDAtNTkpCiAgICogICAqIGAnLnNzcycgb3IgJyxzc3MnYDogTWlsbGlzZWNvbmQgaW4gc2Vjb25kLCBwYWRkZWQgKDAwMC05OTkpCiAgICogICAqIGAnYSdgOiBhbS9wbSBtYXJrZXIKICAgKiAgICogYCdaJ2A6IDQgZGlnaXQgKCtzaWduKSByZXByZXNlbnRhdGlvbiBvZiB0aGUgdGltZXpvbmUgb2Zmc2V0ICgtMTIwMC0rMTIwMCkKICAgKgogICAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBhbHNvIGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nIHByZWRlZmluZWQKICAgKiAgIHtAbGluayBndWlkZS9pMThuIGxvY2FsaXphYmxlIGZvcm1hdHN9OgogICAqCiAgICogICAqIGAnbWVkaXVtJ2A6IGVxdWl2YWxlbnQgdG8gYCdNTU0gZCwgeSBoOm1tOnNzIGEnYCBmb3IgZW5fVVMgbG9jYWxlCiAgICogICAgIChlLmcuIFNlcCAzLCAyMDEwIDEyOjA1OjA4IHBtKQogICAqICAgKiBgJ3Nob3J0J2A6IGVxdWl2YWxlbnQgdG8gYCdNL2QveXkgaDptbSBhJ2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gOS8zLzEwIDEyOjA1IHBtKQogICAqICAgKiBgJ2Z1bGxEYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdFRUVFLCBNTU1NIGQseSdgIGZvciBlbl9VUyAgbG9jYWxlCiAgICogICAgIChlLmcuIEZyaWRheSwgU2VwdGVtYmVyIDMsIDIwMTApCiAgICogICAqIGAnbG9uZ0RhdGUnYDogZXF1aXZhbGVudCB0byBgJ01NTU0gZCwgeSdgIGZvciBlbl9VUyAgbG9jYWxlIChlLmcuIFNlcHRlbWJlciAzLCAyMDEwKQogICAqICAgKiBgJ21lZGl1bURhdGUnYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5J2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gU2VwIDMsIDIwMTApCiAgICogICAqIGAnc2hvcnREYXRlJ2A6IGVxdWl2YWxlbnQgdG8gYCdNL2QveXknYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDkvMy8xMCkKICAgKiAgICogYCdtZWRpdW1UaW1lJ2A6IGVxdWl2YWxlbnQgdG8gYCdoOm1tOnNzIGEnYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDEyOjA1OjA4IHBtKQogICAqICAgKiBgJ3Nob3J0VGltZSdgOiBlcXVpdmFsZW50IHRvIGAnaDptbSBhJ2AgZm9yIGVuX1VTIGxvY2FsZSAoZS5nLiAxMjowNSBwbSkKICAgKgogICAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBjb250YWluIGxpdGVyYWwgdmFsdWVzLiBUaGVzZSBuZWVkIHRvIGJlIHF1b3RlZCB3aXRoIHNpbmdsZSBxdW90ZXMgKGUuZy4KICAgKiAgIGAiaCAnaW4gdGhlIG1vcm5pbmcnImApLiBJbiBvcmRlciB0byBvdXRwdXQgc2luZ2xlIHF1b3RlLCB1c2UgdHdvIHNpbmdsZSBxdW90ZXMgaW4gYSBzZXF1ZW5jZQogICAqICAgKGUuZy4gYCJoICdvJydjbG9jayciYCkuCiAgICoKICAgKiBAcGFyYW0geyhEYXRlfG51bWJlcnxzdHJpbmcpfSBkYXRlIERhdGUgdG8gZm9ybWF0IGVpdGhlciBhcyBEYXRlIG9iamVjdCwgbWlsbGlzZWNvbmRzIChzdHJpbmcgb3IKICAgKiAgICBudW1iZXIpIG9yIHZhcmlvdXMgSVNPIDg2MDEgZGF0ZXRpbWUgc3RyaW5nIGZvcm1hdHMgKGUuZy4geXl5eS1NTS1kZFRISDptbTpzcy5TU1NaIGFuZCBpdHMKICAgKiAgICBzaG9ydGVyIHZlcnNpb25zIGxpa2UgeXl5eS1NTS1kZFRISDptbVosIHl5eXktTU0tZGQgb3IgeXl5eU1NZGRUSEhtbXNzWikuIElmIG5vIHRpbWV6b25lIGlzCiAgICogICAgc3BlY2lmaWVkIGluIHRoZSBzdHJpbmcgaW5wdXQsIHRoZSB0aW1lIGlzIGNvbnNpZGVyZWQgdG8gYmUgaW4gdGhlIGxvY2FsIHRpbWV6b25lLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gZm9ybWF0IEZvcm1hdHRpbmcgcnVsZXMgKHNlZSBEZXNjcmlwdGlvbikuIElmIG5vdCBzcGVjaWZpZWQsCiAgICogICAgYG1lZGl1bURhdGVgIGlzIHVzZWQuCiAgICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIHN0cmluZyBvciB0aGUgaW5wdXQgaWYgaW5wdXQgaXMgbm90IHJlY29nbml6ZWQgYXMgZGF0ZS9taWxsaXMuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nfX08L3NwYW4+OgogICA8c3Bhbj57ezEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nfX08L3NwYW4+PGJyPgogICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJ319PC9zcGFuPjoKICAgPHNwYW4+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJ319PC9zcGFuPjxicj4KICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J01NL2RkL3l5eXkgQCBoOm1tYSd9fTwvc3Bhbj46CiAgIDxzcGFuPnt7JzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJ319PC9zcGFuPjxicj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBmb3JtYXQgZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCIxMjg4MzIzNjIzMDA2IHwgZGF0ZTonbWVkaXVtJyIpKS5nZXRUZXh0KCkpLgogICAgICAgICAgICB0b01hdGNoKC9PY3QgMlxkLCAyMDEwIFxkezEsMn06XGR7Mn06XGR7Mn0gKEFNfFBNKS8pOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCIxMjg4MzIzNjIzMDA2IHwgZGF0ZToneXl5eS1NTS1kZCBISDptbTpzcyBaJyIpKS5nZXRUZXh0KCkpLgogICAgICAgICAgICB0b01hdGNoKC8yMDEwXC0xMFwtMlxkIFxkezJ9OlxkezJ9OlxkezJ9IChcLXxcKyk/XGR7NH0vKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygiJzEyODgzMjM2MjMwMDYnIHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJyIpKS5nZXRUZXh0KCkpLgogICB0b01hdGNoKC8xMFwvMlxkXC8yMDEwIEAgXGR7MSwyfTpcZHsyfShBTXxQTSkvKTsKICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIGRhdGVGaWx0ZXIuJGluamVjdCA9IFsnJGxvY2FsZSddOwogIGZ1bmN0aW9uIGRhdGVGaWx0ZXIoJGxvY2FsZSkgewoKCiAgICB2YXIgUl9JU084NjAxX1NUUiA9IC9eKFxkezR9KS0/KFxkXGQpLT8oXGRcZCkoPzpUKFxkXGQpKD86Oj8oXGRcZCkoPzo6PyhcZFxkKSg/OlwuKFxkKykpPyk/KT8oWnwoWystXSkoXGRcZCk6PyhcZFxkKSk/KT8kLzsKICAgIC8vIDEgICAgICAgIDIgICAgICAgMyAgICAgICAgIDQgICAgICAgICAgNSAgICAgICAgICA2ICAgICAgICAgIDcgICAgICAgICAgOCAgOSAgICAgMTAgICAgICAxMQogICAgZnVuY3Rpb24ganNvblN0cmluZ1RvRGF0ZShzdHJpbmcpIHsKICAgICAgdmFyIG1hdGNoOwogICAgICBpZiAobWF0Y2ggPSBzdHJpbmcubWF0Y2goUl9JU084NjAxX1NUUikpIHsKICAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKDApLAogICAgICAgICAgdHpIb3VyID0gMCwKICAgICAgICAgIHR6TWluICA9IDAsCiAgICAgICAgICBkYXRlU2V0dGVyID0gbWF0Y2hbOF0gPyBkYXRlLnNldFVUQ0Z1bGxZZWFyIDogZGF0ZS5zZXRGdWxsWWVhciwKICAgICAgICAgIHRpbWVTZXR0ZXIgPSBtYXRjaFs4XSA/IGRhdGUuc2V0VVRDSG91cnMgOiBkYXRlLnNldEhvdXJzOwoKICAgICAgICBpZiAobWF0Y2hbOV0pIHsKICAgICAgICAgIHR6SG91ciA9IGludChtYXRjaFs5XSArIG1hdGNoWzEwXSk7CiAgICAgICAgICB0ek1pbiA9IGludChtYXRjaFs5XSArIG1hdGNoWzExXSk7CiAgICAgICAgfQogICAgICAgIGRhdGVTZXR0ZXIuY2FsbChkYXRlLCBpbnQobWF0Y2hbMV0pLCBpbnQobWF0Y2hbMl0pIC0gMSwgaW50KG1hdGNoWzNdKSk7CiAgICAgICAgdmFyIGggPSBpbnQobWF0Y2hbNF18fDApIC0gdHpIb3VyOwogICAgICAgIHZhciBtID0gaW50KG1hdGNoWzVdfHwwKSAtIHR6TWluOwogICAgICAgIHZhciBzID0gaW50KG1hdGNoWzZdfHwwKTsKICAgICAgICB2YXIgbXMgPSBNYXRoLnJvdW5kKHBhcnNlRmxvYXQoJzAuJyArIChtYXRjaFs3XXx8MCkpICogMTAwMCk7CiAgICAgICAgdGltZVNldHRlci5jYWxsKGRhdGUsIGgsIG0sIHMsIG1zKTsKICAgICAgICByZXR1cm4gZGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gc3RyaW5nOwogICAgfQoKCiAgICByZXR1cm4gZnVuY3Rpb24oZGF0ZSwgZm9ybWF0KSB7CiAgICAgIHZhciB0ZXh0ID0gJycsCiAgICAgICAgcGFydHMgPSBbXSwKICAgICAgICBmbiwgbWF0Y2g7CgogICAgICBmb3JtYXQgPSBmb3JtYXQgfHwgJ21lZGl1bURhdGUnOwogICAgICBmb3JtYXQgPSAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFNbZm9ybWF0XSB8fCBmb3JtYXQ7CiAgICAgIGlmIChpc1N0cmluZyhkYXRlKSkgewogICAgICAgIGlmIChOVU1CRVJfU1RSSU5HLnRlc3QoZGF0ZSkpIHsKICAgICAgICAgIGRhdGUgPSBpbnQoZGF0ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRhdGUgPSBqc29uU3RyaW5nVG9EYXRlKGRhdGUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGlzTnVtYmVyKGRhdGUpKSB7CiAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKGRhdGUpOwogICAgICB9CgogICAgICBpZiAoIWlzRGF0ZShkYXRlKSkgewogICAgICAgIHJldHVybiBkYXRlOwogICAgICB9CgogICAgICB3aGlsZShmb3JtYXQpIHsKICAgICAgICBtYXRjaCA9IERBVEVfRk9STUFUU19TUExJVC5leGVjKGZvcm1hdCk7CiAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICBwYXJ0cyA9IGNvbmNhdChwYXJ0cywgbWF0Y2gsIDEpOwogICAgICAgICAgZm9ybWF0ID0gcGFydHMucG9wKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBhcnRzLnB1c2goZm9ybWF0KTsKICAgICAgICAgIGZvcm1hdCA9IG51bGw7CiAgICAgICAgfQogICAgICB9CgogICAgICBmb3JFYWNoKHBhcnRzLCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgZm4gPSBEQVRFX0ZPUk1BVFNbdmFsdWVdOwogICAgICAgIHRleHQgKz0gZm4gPyBmbihkYXRlLCAkbG9jYWxlLkRBVEVUSU1FX0ZPUk1BVFMpCiAgICAgICAgICA6IHZhbHVlLnJlcGxhY2UoLyheJ3wnJCkvZywgJycpLnJlcGxhY2UoLycnL2csICInIik7CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHRleHQ7CiAgICB9OwogIH0KCgogIC8qKgogICAqIEBuZ2RvYyBmaWx0ZXIKICAgKiBAbmFtZSBqc29uCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqICAgQWxsb3dzIHlvdSB0byBjb252ZXJ0IGEgSmF2YVNjcmlwdCBvYmplY3QgaW50byBKU09OIHN0cmluZy4KICAgKgogICAqICAgVGhpcyBmaWx0ZXIgaXMgbW9zdGx5IHVzZWZ1bCBmb3IgZGVidWdnaW5nLiBXaGVuIHVzaW5nIHRoZSBkb3VibGUgY3VybHkge3t2YWx1ZX19IG5vdGF0aW9uCiAgICogICB0aGUgYmluZGluZyBpcyBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBKU09OLgogICAqCiAgICogQHBhcmFtIHsqfSBvYmplY3QgQW55IEphdmFTY3JpcHQgb2JqZWN0IChpbmNsdWRpbmcgYXJyYXlzIGFuZCBwcmltaXRpdmUgdHlwZXMpIHRvIGZpbHRlci4KICAgKiBAcmV0dXJucyB7c3RyaW5nfSBKU09OIHN0cmluZy4KICAgKgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8cHJlPnt7IHsnbmFtZSc6J3ZhbHVlJ30gfCBqc29uIH19PC9wcmU+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQganNvbmlmeSBmaWx0ZXJlZCBvYmplY3RzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoInsnbmFtZSc6J3ZhbHVlJ30iKSkuZ2V0VGV4dCgpKS50b01hdGNoKC9ce1xuICAibmFtZSI6ID8idmFsdWUiXG59Lyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICoKICAgKi8KICBmdW5jdGlvbiBqc29uRmlsdGVyKCkgewogICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICByZXR1cm4gdG9Kc29uKG9iamVjdCwgdHJ1ZSk7CiAgICB9OwogIH0KCgogIC8qKgogICAqIEBuZ2RvYyBmaWx0ZXIKICAgKiBAbmFtZSBsb3dlcmNhc2UKICAgKiBAa2luZCBmdW5jdGlvbgogICAqIEBkZXNjcmlwdGlvbgogICAqIENvbnZlcnRzIHN0cmluZyB0byBsb3dlcmNhc2UuCiAgICogQHNlZSBhbmd1bGFyLmxvd2VyY2FzZQogICAqLwogIHZhciBsb3dlcmNhc2VGaWx0ZXIgPSB2YWx1ZUZuKGxvd2VyY2FzZSk7CgoKICAvKioKICAgKiBAbmdkb2MgZmlsdGVyCiAgICogQG5hbWUgdXBwZXJjYXNlCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKiBAZGVzY3JpcHRpb24KICAgKiBDb252ZXJ0cyBzdHJpbmcgdG8gdXBwZXJjYXNlLgogICAqIEBzZWUgYW5ndWxhci51cHBlcmNhc2UKICAgKi8KICB2YXIgdXBwZXJjYXNlRmlsdGVyID0gdmFsdWVGbih1cHBlcmNhc2UpOwoKICAvKioKICAgKiBAbmdkb2MgZmlsdGVyCiAgICogQG5hbWUgbGltaXRUbwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDcmVhdGVzIGEgbmV3IGFycmF5IG9yIHN0cmluZyBjb250YWluaW5nIG9ubHkgYSBzcGVjaWZpZWQgbnVtYmVyIG9mIGVsZW1lbnRzLiBUaGUgZWxlbWVudHMKICAgKiBhcmUgdGFrZW4gZnJvbSBlaXRoZXIgdGhlIGJlZ2lubmluZyBvciB0aGUgZW5kIG9mIHRoZSBzb3VyY2UgYXJyYXkgb3Igc3RyaW5nLCBhcyBzcGVjaWZpZWQgYnkKICAgKiB0aGUgdmFsdWUgYW5kIHNpZ24gKHBvc2l0aXZlIG9yIG5lZ2F0aXZlKSBvZiBgbGltaXRgLgogICAqCiAgICogQHBhcmFtIHtBcnJheXxzdHJpbmd9IGlucHV0IFNvdXJjZSBhcnJheSBvciBzdHJpbmcgdG8gYmUgbGltaXRlZC4KICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGxpbWl0IFRoZSBsZW5ndGggb2YgdGhlIHJldHVybmVkIGFycmF5IG9yIHN0cmluZy4gSWYgdGhlIGBsaW1pdGAgbnVtYmVyCiAgICogICAgIGlzIHBvc2l0aXZlLCBgbGltaXRgIG51bWJlciBvZiBpdGVtcyBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHNvdXJjZSBhcnJheS9zdHJpbmcgYXJlIGNvcGllZC4KICAgKiAgICAgSWYgdGhlIG51bWJlciBpcyBuZWdhdGl2ZSwgYGxpbWl0YCBudW1iZXIgIG9mIGl0ZW1zIGZyb20gdGhlIGVuZCBvZiB0aGUgc291cmNlIGFycmF5L3N0cmluZwogICAqICAgICBhcmUgY29waWVkLiBUaGUgYGxpbWl0YCB3aWxsIGJlIHRyaW1tZWQgaWYgaXQgZXhjZWVkcyBgYXJyYXkubGVuZ3RoYAogICAqIEByZXR1cm5zIHtBcnJheXxzdHJpbmd9IEEgbmV3IHN1Yi1hcnJheSBvciBzdWJzdHJpbmcgb2YgbGVuZ3RoIGBsaW1pdGAgb3IgbGVzcyBpZiBpbnB1dCBhcnJheQogICAqICAgICBoYWQgbGVzcyB0aGFuIGBsaW1pdGAgZWxlbWVudHMuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLm51bWJlcnMgPSBbMSwyLDMsNCw1LDYsNyw4LDldOwogICAgICAgICAgICRzY29wZS5sZXR0ZXJzID0gImFiY2RlZmdoaSI7CiAgICAgICAgICAgJHNjb3BlLm51bUxpbWl0ID0gMzsKICAgICAgICAgICAkc2NvcGUubGV0dGVyTGltaXQgPSAzOwogICAgICAgICB9CiAgIDwvc2NyaXB0PgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICBMaW1pdCB7e251bWJlcnN9fSB0bzogPGlucHV0IHR5cGU9ImludGVnZXIiIG5nLW1vZGVsPSJudW1MaW1pdCI+CiAgIDxwPk91dHB1dCBudW1iZXJzOiB7eyBudW1iZXJzIHwgbGltaXRUbzpudW1MaW1pdCB9fTwvcD4KICAgTGltaXQge3tsZXR0ZXJzfX0gdG86IDxpbnB1dCB0eXBlPSJpbnRlZ2VyIiBuZy1tb2RlbD0ibGV0dGVyTGltaXQiPgogICA8cD5PdXRwdXQgbGV0dGVyczoge3sgbGV0dGVycyB8IGxpbWl0VG86bGV0dGVyTGltaXQgfX08L3A+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICB2YXIgbnVtTGltaXRJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ251bUxpbWl0JykpOwogICB2YXIgbGV0dGVyTGltaXRJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ2xldHRlckxpbWl0JykpOwogICB2YXIgbGltaXRlZE51bWJlcnMgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ251bWJlcnMgfCBsaW1pdFRvOm51bUxpbWl0JykpOwogICB2YXIgbGltaXRlZExldHRlcnMgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ2xldHRlcnMgfCBsaW1pdFRvOmxldHRlckxpbWl0JykpOwoKICAgaXQoJ3Nob3VsZCBsaW1pdCB0aGUgbnVtYmVyIGFycmF5IHRvIGZpcnN0IHRocmVlIGl0ZW1zJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChudW1MaW1pdElucHV0LmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9CZSgnMycpOwogICAgICAgICBleHBlY3QobGV0dGVyTGltaXRJbnB1dC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvQmUoJzMnKTsKICAgICAgICAgZXhwZWN0KGxpbWl0ZWROdW1iZXJzLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IG51bWJlcnM6IFsxLDIsM10nKTsKICAgICAgICAgZXhwZWN0KGxpbWl0ZWRMZXR0ZXJzLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IGxldHRlcnM6IGFiYycpOwogICAgICAgfSk7CgogICBpdCgnc2hvdWxkIHVwZGF0ZSB0aGUgb3V0cHV0IHdoZW4gLTMgaXMgZW50ZXJlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBudW1MaW1pdElucHV0LmNsZWFyKCk7CiAgICAgICAgIG51bUxpbWl0SW5wdXQuc2VuZEtleXMoJy0zJyk7CiAgICAgICAgIGxldHRlckxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgbGV0dGVyTGltaXRJbnB1dC5zZW5kS2V5cygnLTMnKTsKICAgICAgICAgZXhwZWN0KGxpbWl0ZWROdW1iZXJzLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IG51bWJlcnM6IFs3LDgsOV0nKTsKICAgICAgICAgZXhwZWN0KGxpbWl0ZWRMZXR0ZXJzLmdldFRleHQoKSkudG9FcXVhbCgnT3V0cHV0IGxldHRlcnM6IGdoaScpOwogICAgICAgfSk7CgogICBpdCgnc2hvdWxkIG5vdCBleGNlZWQgdGhlIG1heGltdW0gc2l6ZSBvZiBpbnB1dCBhcnJheScsIGZ1bmN0aW9uKCkgewogICAgICAgICBudW1MaW1pdElucHV0LmNsZWFyKCk7CiAgICAgICAgIG51bUxpbWl0SW5wdXQuc2VuZEtleXMoJzEwMCcpOwogICAgICAgICBsZXR0ZXJMaW1pdElucHV0LmNsZWFyKCk7CiAgICAgICAgIGxldHRlckxpbWl0SW5wdXQuc2VuZEtleXMoJzEwMCcpOwogICAgICAgICBleHBlY3QobGltaXRlZE51bWJlcnMuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbnVtYmVyczogWzEsMiwzLDQsNSw2LDcsOCw5XScpOwogICAgICAgICBleHBlY3QobGltaXRlZExldHRlcnMuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbGV0dGVyczogYWJjZGVmZ2hpJyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgZnVuY3Rpb24gbGltaXRUb0ZpbHRlcigpewogICAgcmV0dXJuIGZ1bmN0aW9uKGlucHV0LCBsaW1pdCkgewogICAgICBpZiAoIWlzQXJyYXkoaW5wdXQpICYmICFpc1N0cmluZyhpbnB1dCkpIHJldHVybiBpbnB1dDsKCiAgICAgIGlmIChNYXRoLmFicyhOdW1iZXIobGltaXQpKSA9PT0gSW5maW5pdHkpIHsKICAgICAgICBsaW1pdCA9IE51bWJlcihsaW1pdCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGltaXQgPSBpbnQobGltaXQpOwogICAgICB9CgogICAgICBpZiAoaXNTdHJpbmcoaW5wdXQpKSB7CiAgICAgICAgLy9OYU4gY2hlY2sgb24gbGltaXQKICAgICAgICBpZiAobGltaXQpIHsKICAgICAgICAgIHJldHVybiBsaW1pdCA+PSAwID8gaW5wdXQuc2xpY2UoMCwgbGltaXQpIDogaW5wdXQuc2xpY2UobGltaXQsIGlucHV0Lmxlbmd0aCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZhciBvdXQgPSBbXSwKICAgICAgICBpLCBuOwoKICAgICAgLy8gaWYgYWJzKGxpbWl0KSBleGNlZWRzIG1heGltdW0gbGVuZ3RoLCB0cmltIGl0CiAgICAgIGlmIChsaW1pdCA+IGlucHV0Lmxlbmd0aCkKICAgICAgICBsaW1pdCA9IGlucHV0Lmxlbmd0aDsKICAgICAgZWxzZSBpZiAobGltaXQgPCAtaW5wdXQubGVuZ3RoKQogICAgICAgIGxpbWl0ID0gLWlucHV0Lmxlbmd0aDsKCiAgICAgIGlmIChsaW1pdCA+IDApIHsKICAgICAgICBpID0gMDsKICAgICAgICBuID0gbGltaXQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IGlucHV0Lmxlbmd0aCArIGxpbWl0OwogICAgICAgIG4gPSBpbnB1dC5sZW5ndGg7CiAgICAgIH0KCiAgICAgIGZvciAoOyBpPG47IGkrKykgewogICAgICAgIG91dC5wdXNoKGlucHV0W2ldKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG91dDsKICAgIH07CiAgfQoKICAvKioKICAgKiBAbmdkb2MgZmlsdGVyCiAgICogQG5hbWUgb3JkZXJCeQogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBPcmRlcnMgYSBzcGVjaWZpZWQgYGFycmF5YCBieSB0aGUgYGV4cHJlc3Npb25gIHByZWRpY2F0ZS4gSXQgaXMgb3JkZXJlZCBhbHBoYWJldGljYWxseQogICAqIGZvciBzdHJpbmdzIGFuZCBudW1lcmljYWxseSBmb3IgbnVtYmVycy4gTm90ZTogaWYgeW91IG5vdGljZSBudW1iZXJzIGFyZSBub3QgYmVpbmcgc29ydGVkCiAgICogY29ycmVjdGx5LCBtYWtlIHN1cmUgdGhleSBhcmUgYWN0dWFsbHkgYmVpbmcgc2F2ZWQgYXMgbnVtYmVycyBhbmQgbm90IHN0cmluZ3MuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc29ydC4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCopfHN0cmluZ3xBcnJheS48KGZ1bmN0aW9uKCopfHN0cmluZyk+fSBleHByZXNzaW9uIEEgcHJlZGljYXRlIHRvIGJlCiAgICogICAgdXNlZCBieSB0aGUgY29tcGFyYXRvciB0byBkZXRlcm1pbmUgdGhlIG9yZGVyIG9mIGVsZW1lbnRzLgogICAqCiAgICogICAgQ2FuIGJlIG9uZSBvZjoKICAgKgogICAqICAgIC0gYGZ1bmN0aW9uYDogR2V0dGVyIGZ1bmN0aW9uLiBUaGUgcmVzdWx0IG9mIHRoaXMgZnVuY3Rpb24gd2lsbCBiZSBzb3J0ZWQgdXNpbmcgdGhlCiAgICogICAgICBgPGAsIGA9YCwgYD5gIG9wZXJhdG9yLgogICAqICAgIC0gYHN0cmluZ2A6IEFuIEFuZ3VsYXIgZXhwcmVzc2lvbiB3aGljaCBldmFsdWF0ZXMgdG8gYW4gb2JqZWN0IHRvIG9yZGVyIGJ5LCBzdWNoIGFzICduYW1lJwogICAqICAgICAgdG8gc29ydCBieSBhIHByb3BlcnR5IGNhbGxlZCAnbmFtZScuIE9wdGlvbmFsbHkgcHJlZml4ZWQgd2l0aCBgK2Agb3IgYC1gIHRvIGNvbnRyb2wKICAgKiAgICAgIGFzY2VuZGluZyBvciBkZXNjZW5kaW5nIHNvcnQgb3JkZXIgKGZvciBleGFtcGxlLCArbmFtZSBvciAtbmFtZSkuCiAgICogICAgLSBgQXJyYXlgOiBBbiBhcnJheSBvZiBmdW5jdGlvbiBvciBzdHJpbmcgcHJlZGljYXRlcy4gVGhlIGZpcnN0IHByZWRpY2F0ZSBpbiB0aGUgYXJyYXkKICAgKiAgICAgIGlzIHVzZWQgZm9yIHNvcnRpbmcsIGJ1dCB3aGVuIHR3byBpdGVtcyBhcmUgZXF1aXZhbGVudCwgdGhlIG5leHQgcHJlZGljYXRlIGlzIHVzZWQuCiAgICoKICAgKiBAcGFyYW0ge2Jvb2xlYW49fSByZXZlcnNlIFJldmVyc2UgdGhlIG9yZGVyIG9mIHRoZSBhcnJheS4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFNvcnRlZCBjb3B5IG9mIHRoZSBzb3VyY2UgYXJyYXkuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLmZyaWVuZHMgPQogICAgICAgICAgICAgICBbe25hbWU6J0pvaG4nLCBwaG9uZTonNTU1LTEyMTInLCBhZ2U6MTB9LAogICAgICAgICAgICAgICAge25hbWU6J01hcnknLCBwaG9uZTonNTU1LTk4NzYnLCBhZ2U6MTl9LAogICAgICAgICAgICAgICAge25hbWU6J01pa2UnLCBwaG9uZTonNTU1LTQzMjEnLCBhZ2U6MjF9LAogICAgICAgICAgICAgICAge25hbWU6J0FkYW0nLCBwaG9uZTonNTU1LTU2NzgnLCBhZ2U6MzV9LAogICAgICAgICAgICAgICAge25hbWU6J0p1bGllJywgcGhvbmU6JzU1NS04NzY1JywgYWdlOjI5fV0KICAgICAgICAgICAkc2NvcGUucHJlZGljYXRlID0gJy1hZ2UnOwogICAgICAgICB9CiAgIDwvc2NyaXB0PgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICA8cHJlPlNvcnRpbmcgcHJlZGljYXRlID0ge3twcmVkaWNhdGV9fTsgcmV2ZXJzZSA9IHt7cmV2ZXJzZX19PC9wcmU+CiAgIDxoci8+CiAgIFsgPGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlPScnIj51bnNvcnRlZDwvYT4gXQogICA8dGFibGUgY2xhc3M9ImZyaWVuZCI+CiAgIDx0cj4KICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICduYW1lJzsgcmV2ZXJzZT1mYWxzZSI+TmFtZTwvYT4KICAgKDxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICctbmFtZSc7IHJldmVyc2U9ZmFsc2UiPl48L2E+KTwvdGg+CiAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGUgPSAncGhvbmUnOyByZXZlcnNlPSFyZXZlcnNlIj5QaG9uZSBOdW1iZXI8L2E+PC90aD4KICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICdhZ2UnOyByZXZlcnNlPSFyZXZlcnNlIj5BZ2U8L2E+PC90aD4KICAgPC90cj4KICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMgfCBvcmRlckJ5OnByZWRpY2F0ZTpyZXZlcnNlIj4KICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgPHRkPnt7ZnJpZW5kLmFnZX19PC90ZD4KICAgPC90cj4KICAgPC90YWJsZT4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqCiAgICogSXQncyBhbHNvIHBvc3NpYmxlIHRvIGNhbGwgdGhlIG9yZGVyQnkgZmlsdGVyIG1hbnVhbGx5LCBieSBpbmplY3RpbmcgYCRmaWx0ZXJgLCByZXRyaWV2aW5nIHRoZQogICAqIGZpbHRlciByb3V0aW5lIHdpdGggYCRmaWx0ZXIoJ29yZGVyQnknKWAsIGFuZCBjYWxsaW5nIHRoZSByZXR1cm5lZCBmaWx0ZXIgcm91dGluZSB3aXRoIHRoZQogICAqIGRlc2lyZWQgcGFyYW1ldGVycy4KICAgKgogICAqIEV4YW1wbGU6CiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIDx0YWJsZSBjbGFzcz0iZnJpZW5kIj4KICAgPHRyPgogICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icmV2ZXJzZT1mYWxzZTtvcmRlcignbmFtZScsIGZhbHNlKSI+TmFtZTwvYT4KICAgKDxhIGhyZWY9IiIgbmctY2xpY2s9Im9yZGVyKCctbmFtZScsZmFsc2UpIj5ePC9hPik8L3RoPgogICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icmV2ZXJzZT0hcmV2ZXJzZTtvcmRlcigncGhvbmUnLCByZXZlcnNlKSI+UGhvbmUgTnVtYmVyPC9hPjwvdGg+CiAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJyZXZlcnNlPSFyZXZlcnNlO29yZGVyKCdhZ2UnLHJldmVyc2UpIj5BZ2U8L2E+PC90aD4KICAgPC90cj4KICAgPHRyIG5nLXJlcGVhdD0iZnJpZW5kIGluIGZyaWVuZHMiPgogICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgPHRkPnt7ZnJpZW5kLnBob25lfX08L3RkPgogICA8dGQ+e3tmcmllbmQuYWdlfX08L3RkPgogICA8L3RyPgogICA8L3RhYmxlPgogICA8L2Rpdj4KICAgPC9maWxlPgoKICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUsICRmaWx0ZXIpIHsKICAgICAgICB2YXIgb3JkZXJCeSA9ICRmaWx0ZXIoJ29yZGVyQnknKTsKICAgICAgICAkc2NvcGUuZnJpZW5kcyA9IFsKICAgICAgICAgIHsgbmFtZTogJ0pvaG4nLCAgICBwaG9uZTogJzU1NS0xMjEyJywgICAgYWdlOiAxMCB9LAogICAgICAgICAgeyBuYW1lOiAnTWFyeScsICAgIHBob25lOiAnNTU1LTk4NzYnLCAgICBhZ2U6IDE5IH0sCiAgICAgICAgICB7IG5hbWU6ICdNaWtlJywgICAgcGhvbmU6ICc1NTUtNDMyMScsICAgIGFnZTogMjEgfSwKICAgICAgICAgIHsgbmFtZTogJ0FkYW0nLCAgICBwaG9uZTogJzU1NS01Njc4JywgICAgYWdlOiAzNSB9LAogICAgICAgICAgeyBuYW1lOiAnSnVsaWUnLCAgIHBob25lOiAnNTU1LTg3NjUnLCAgICBhZ2U6IDI5IH0KICAgICAgICBdOwoKICAgICAgICAkc2NvcGUub3JkZXIgPSBmdW5jdGlvbihwcmVkaWNhdGUsIHJldmVyc2UpIHsKICAgICAgICAgICRzY29wZS5mcmllbmRzID0gb3JkZXJCeSgkc2NvcGUuZnJpZW5kcywgcHJlZGljYXRlLCByZXZlcnNlKTsKICAgICAgICB9OwogICAgICAgICRzY29wZS5vcmRlcignLWFnZScsZmFsc2UpOwogICAgICB9CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIG9yZGVyQnlGaWx0ZXIuJGluamVjdCA9IFsnJHBhcnNlJ107CiAgZnVuY3Rpb24gb3JkZXJCeUZpbHRlcigkcGFyc2UpewogICAgcmV0dXJuIGZ1bmN0aW9uKGFycmF5LCBzb3J0UHJlZGljYXRlLCByZXZlcnNlT3JkZXIpIHsKICAgICAgaWYgKCFpc0FycmF5KGFycmF5KSkgcmV0dXJuIGFycmF5OwogICAgICBpZiAoIXNvcnRQcmVkaWNhdGUpIHJldHVybiBhcnJheTsKICAgICAgc29ydFByZWRpY2F0ZSA9IGlzQXJyYXkoc29ydFByZWRpY2F0ZSkgPyBzb3J0UHJlZGljYXRlOiBbc29ydFByZWRpY2F0ZV07CiAgICAgIHNvcnRQcmVkaWNhdGUgPSBtYXAoc29ydFByZWRpY2F0ZSwgZnVuY3Rpb24ocHJlZGljYXRlKXsKICAgICAgICB2YXIgZGVzY2VuZGluZyA9IGZhbHNlLCBnZXQgPSBwcmVkaWNhdGUgfHwgaWRlbnRpdHk7CiAgICAgICAgaWYgKGlzU3RyaW5nKHByZWRpY2F0ZSkpIHsKICAgICAgICAgIGlmICgocHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnKycgfHwgcHJlZGljYXRlLmNoYXJBdCgwKSA9PSAnLScpKSB7CiAgICAgICAgICAgIGRlc2NlbmRpbmcgPSBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJzsKICAgICAgICAgICAgcHJlZGljYXRlID0gcHJlZGljYXRlLnN1YnN0cmluZygxKTsKICAgICAgICAgIH0KICAgICAgICAgIGdldCA9ICRwYXJzZShwcmVkaWNhdGUpOwogICAgICAgICAgaWYgKGdldC5jb25zdGFudCkgewogICAgICAgICAgICB2YXIga2V5ID0gZ2V0KCk7CiAgICAgICAgICAgIHJldHVybiByZXZlcnNlQ29tcGFyYXRvcihmdW5jdGlvbihhLGIpIHsKICAgICAgICAgICAgICByZXR1cm4gY29tcGFyZShhW2tleV0sIGJba2V5XSk7CiAgICAgICAgICAgIH0sIGRlc2NlbmRpbmcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV2ZXJzZUNvbXBhcmF0b3IoZnVuY3Rpb24oYSxiKXsKICAgICAgICAgIHJldHVybiBjb21wYXJlKGdldChhKSxnZXQoYikpOwogICAgICAgIH0sIGRlc2NlbmRpbmcpOwogICAgICB9KTsKICAgICAgdmFyIGFycmF5Q29weSA9IFtdOwogICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgeyBhcnJheUNvcHkucHVzaChhcnJheVtpXSk7IH0KICAgICAgcmV0dXJuIGFycmF5Q29weS5zb3J0KHJldmVyc2VDb21wYXJhdG9yKGNvbXBhcmF0b3IsIHJldmVyc2VPcmRlcikpOwoKICAgICAgZnVuY3Rpb24gY29tcGFyYXRvcihvMSwgbzIpewogICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNvcnRQcmVkaWNhdGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBjb21wID0gc29ydFByZWRpY2F0ZVtpXShvMSwgbzIpOwogICAgICAgICAgaWYgKGNvbXAgIT09IDApIHJldHVybiBjb21wOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBmdW5jdGlvbiByZXZlcnNlQ29tcGFyYXRvcihjb21wLCBkZXNjZW5kaW5nKSB7CiAgICAgICAgcmV0dXJuIHRvQm9vbGVhbihkZXNjZW5kaW5nKQogICAgICAgICAgPyBmdW5jdGlvbihhLGIpe3JldHVybiBjb21wKGIsYSk7fQogICAgICAgICAgOiBjb21wOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNvbXBhcmUodjEsIHYyKXsKICAgICAgICB2YXIgdDEgPSB0eXBlb2YgdjE7CiAgICAgICAgdmFyIHQyID0gdHlwZW9mIHYyOwogICAgICAgIGlmICh0MSA9PSB0MikgewogICAgICAgICAgaWYgKHQxID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHYxID0gdjEudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgdjIgPSB2Mi50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHYxID09PSB2MikgcmV0dXJuIDA7CiAgICAgICAgICByZXR1cm4gdjEgPCB2MiA/IC0xIDogMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHQxIDwgdDIgPyAtMSA6IDE7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gbmdEaXJlY3RpdmUoZGlyZWN0aXZlKSB7CiAgICBpZiAoaXNGdW5jdGlvbihkaXJlY3RpdmUpKSB7CiAgICAgIGRpcmVjdGl2ZSA9IHsKICAgICAgICBsaW5rOiBkaXJlY3RpdmUKICAgICAgfTsKICAgIH0KICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQUMnOwogICAgcmV0dXJuIHZhbHVlRm4oZGlyZWN0aXZlKTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBhCiAgICogQHJlc3RyaWN0IEUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIE1vZGlmaWVzIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHRoZSBodG1sIEEgdGFnIHNvIHRoYXQgdGhlIGRlZmF1bHQgYWN0aW9uIGlzIHByZXZlbnRlZCB3aGVuCiAgICogdGhlIGhyZWYgYXR0cmlidXRlIGlzIGVtcHR5LgogICAqCiAgICogVGhpcyBjaGFuZ2UgcGVybWl0cyB0aGUgZWFzeSBjcmVhdGlvbiBvZiBhY3Rpb24gbGlua3Mgd2l0aCB0aGUgYG5nQ2xpY2tgIGRpcmVjdGl2ZQogICAqIHdpdGhvdXQgY2hhbmdpbmcgdGhlIGxvY2F0aW9uIG9yIGNhdXNpbmcgcGFnZSByZWxvYWRzLCBlLmcuOgogICAqIGA8YSBocmVmPSIiIG5nLWNsaWNrPSJsaXN0LmFkZEl0ZW0oKSI+QWRkIEl0ZW08L2E+YAogICAqLwogIHZhciBodG1sQW5jaG9yRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICByZXN0cmljdDogJ0UnLAogICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewoKICAgICAgaWYgKG1zaWUgPD0gOCkgewoKICAgICAgICAvLyB0dXJuIDxhIGhyZWYgbmctY2xpY2s9Ii4uIj5saW5rPC9hPiBpbnRvIGEgc3R5bGFibGUgbGluayBpbiBJRQogICAgICAgIC8vIGJ1dCBvbmx5IGlmIGl0IGRvZXNuJ3QgaGF2ZSBuYW1lIGF0dHJpYnV0ZSwgaW4gd2hpY2ggY2FzZSBpdCdzIGFuIGFuY2hvcgogICAgICAgIGlmICghYXR0ci5ocmVmICYmICFhdHRyLm5hbWUpIHsKICAgICAgICAgIGF0dHIuJHNldCgnaHJlZicsICcnKTsKICAgICAgICB9CgogICAgICAgIC8vIGFkZCBhIGNvbW1lbnQgbm9kZSB0byBhbmNob3JzIHRvIHdvcmthcm91bmQgSUUgYnVnIHRoYXQgY2F1c2VzIGVsZW1lbnQgY29udGVudCB0byBiZSByZXNldAogICAgICAgIC8vIHRvIG5ldyBhdHRyaWJ1dGUgY29udGVudCBpZiBhdHRyaWJ1dGUgaXMgdXBkYXRlZCB3aXRoIHZhbHVlIGNvbnRhaW5pbmcgQCBhbmQgZWxlbWVudCBhbHNvCiAgICAgICAgLy8gY29udGFpbnMgdmFsdWUgd2l0aCBACiAgICAgICAgLy8gc2VlIGlzc3VlICMxOTQ5CiAgICAgICAgZWxlbWVudC5hcHBlbmQoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnSUUgZml4JykpOwogICAgICB9CgogICAgICBpZiAoIWF0dHIuaHJlZiAmJiAhYXR0ci54bGlua0hyZWYgJiYgIWF0dHIubmFtZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCkgewogICAgICAgICAgLy8gU1ZHQUVsZW1lbnQgZG9lcyBub3QgdXNlIHRoZSBocmVmIGF0dHJpYnV0ZSwgYnV0IHJhdGhlciB0aGUgJ3hsaW5rSHJlZicgYXR0cmlidXRlLgogICAgICAgICAgdmFyIGhyZWYgPSB0b1N0cmluZy5jYWxsKGVsZW1lbnQucHJvcCgnaHJlZicpKSA9PT0gJ1tvYmplY3QgU1ZHQW5pbWF0ZWRTdHJpbmddJyA/CiAgICAgICAgICAgICd4bGluazpocmVmJyA6ICdocmVmJzsKICAgICAgICAgIGVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgICAvLyBpZiB3ZSBoYXZlIG5vIGhyZWYgdXJsLCB0aGVuIGRvbid0IG5hdmlnYXRlIGFueXdoZXJlLgogICAgICAgICAgICBpZiAoIWVsZW1lbnQuYXR0cihocmVmKSkgewogICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgIH0KICAgIH0KICB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nSHJlZgogICAqIEByZXN0cmljdCBBCiAgICogQHByaW9yaXR5IDk5CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2luZyBBbmd1bGFyIG1hcmt1cCBsaWtlIGB7e2hhc2h9fWAgaW4gYW4gaHJlZiBhdHRyaWJ1dGUgd2lsbAogICAqIG1ha2UgdGhlIGxpbmsgZ28gdG8gdGhlIHdyb25nIFVSTCBpZiB0aGUgdXNlciBjbGlja3MgaXQgYmVmb3JlCiAgICogQW5ndWxhciBoYXMgYSBjaGFuY2UgdG8gcmVwbGFjZSB0aGUgYHt7aGFzaH19YCBtYXJrdXAgd2l0aCBpdHMKICAgKiB2YWx1ZS4gVW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgbWFya3VwIHRoZSBsaW5rIHdpbGwgYmUgYnJva2VuCiAgICogYW5kIHdpbGwgbW9zdCBsaWtlbHkgcmV0dXJuIGEgNDA0IGVycm9yLgogICAqCiAgICogVGhlIGBuZ0hyZWZgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogICAqCiAgICogVGhlIHdyb25nIHdheSB0byB3cml0ZSBpdDoKICAgKiBgYGBodG1sCiAgICogPGEgaHJlZj0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAgICogYGBgCiAgICoKICAgKiBUaGUgY29ycmVjdCB3YXkgdG8gd3JpdGUgaXQ6CiAgICogYGBgaHRtbAogICAqIDxhIG5nLWhyZWY9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAqIGBgYAogICAqCiAgICogQGVsZW1lbnQgQQogICAqIEBwYXJhbSB7dGVtcGxhdGV9IG5nSHJlZiBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluIGB7e319YCBtYXJrdXAuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIFRoaXMgZXhhbXBsZSBzaG93cyB2YXJpb3VzIGNvbWJpbmF0aW9ucyBvZiBgaHJlZmAsIGBuZy1ocmVmYCBhbmQgYG5nLWNsaWNrYCBhdHRyaWJ1dGVzCiAgICogaW4gbGlua3MgYW5kIHRoZWlyIGRpZmZlcmVudCBiZWhhdmlvcnM6CiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGlucHV0IG5nLW1vZGVsPSJ2YWx1ZSIgLz48YnIgLz4KICAgPGEgaWQ9ImxpbmstMSIgaHJlZiBuZy1jbGljaz0idmFsdWUgPSAxIj5saW5rIDE8L2E+IChsaW5rLCBkb24ndCByZWxvYWQpPGJyIC8+CiAgIDxhIGlkPSJsaW5rLTIiIGhyZWY9IiIgbmctY2xpY2s9InZhbHVlID0gMiI+bGluayAyPC9hPiAobGluaywgZG9uJ3QgcmVsb2FkKTxiciAvPgogICA8YSBpZD0ibGluay0zIiBuZy1ocmVmPSIve3snMTIzJ319Ij5saW5rIDM8L2E+IChsaW5rLCByZWxvYWQhKTxiciAvPgogICA8YSBpZD0ibGluay00IiBocmVmPSIiIG5hbWU9Inh4IiBuZy1jbGljaz0idmFsdWUgPSA0Ij5hbmNob3I8L2E+IChsaW5rLCBkb24ndCByZWxvYWQpPGJyIC8+CiAgIDxhIGlkPSJsaW5rLTUiIG5hbWU9Inh4eCIgbmctY2xpY2s9InZhbHVlID0gNSI+YW5jaG9yPC9hPiAobm8gbGluayk8YnIgLz4KICAgPGEgaWQ9ImxpbmstNiIgbmctaHJlZj0ie3t2YWx1ZX19Ij5saW5rPC9hPiAobGluaywgY2hhbmdlIGxvY2F0aW9uKQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIHdpdGhvdXQgdmFsdWUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ2xpbmstMScpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9FcXVhbCgnMScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2xpbmstMScpKS5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSkudG9CZSgnJyk7CiAgICAgICAgfSk7CgogICBpdCgnc2hvdWxkIGV4ZWN1dGUgbmctY2xpY2sgYnV0IG5vdCByZWxvYWQgd2hlbiBocmVmIGVtcHR5IHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudChieS5pZCgnbGluay0yJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0VxdWFsKCcyJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay0yJykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b0JlKCcnKTsKICAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBhbmQgY2hhbmdlIHVybCB3aGVuIG5nLWhyZWYgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay0zJykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b01hdGNoKC9cLzEyMyQvKTsKCiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTMnKSkuY2xpY2soKTsKCiAgICAgICAgICAvLyBBdCB0aGlzIHBvaW50LCB3ZSBuYXZpZ2F0ZSBhd2F5IGZyb20gYW4gQW5ndWxhciBwYWdlLCBzbyB3ZSBuZWVkCiAgICAgICAgICAvLyB0byB1c2UgYnJvd3Nlci5kcml2ZXIgdG8gZ2V0IHRoZSBiYXNlIHdlYmRyaXZlci4KCiAgICAgICAgICBicm93c2VyLndhaXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBicm93c2VyLmRyaXZlci5nZXRDdXJyZW50VXJsKCkudGhlbihmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgICByZXR1cm4gdXJsLm1hdGNoKC9cLzEyMyQvKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LCAxMDAwLCAncGFnZSBzaG91bGQgbmF2aWdhdGUgdG8gLzEyMycpOwogICAgICAgIH0pOwoKICAgeGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIGhyZWYgZW1wdHkgc3RyaW5nIGFuZCBuYW1lIHNwZWNpZmllZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudChieS5pZCgnbGluay00JykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0VxdWFsKCc0Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay00JykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b0JlKCcnKTsKICAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIG5vIGhyZWYgYnV0IG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTUnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvRXF1YWwoJzUnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTUnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvQmUobnVsbCk7CiAgICAgICAgfSk7CgogICBpdCgnc2hvdWxkIG9ubHkgY2hhbmdlIHVybCB3aGVuIG9ubHkgbmctaHJlZicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuY2xlYXIoKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpLnNlbmRLZXlzKCc2Jyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay02JykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b01hdGNoKC9cLzYkLyk7CgogICAgICAgICAgZWxlbWVudChieS5pZCgnbGluay02JykpLmNsaWNrKCk7CgogICAgICAgICAgLy8gQXQgdGhpcyBwb2ludCwgd2UgbmF2aWdhdGUgYXdheSBmcm9tIGFuIEFuZ3VsYXIgcGFnZSwgc28gd2UgbmVlZAogICAgICAgICAgLy8gdG8gdXNlIGJyb3dzZXIuZHJpdmVyIHRvIGdldCB0aGUgYmFzZSB3ZWJkcml2ZXIuCiAgICAgICAgICBicm93c2VyLndhaXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBicm93c2VyLmRyaXZlci5nZXRDdXJyZW50VXJsKCkudGhlbihmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgICByZXR1cm4gdXJsLm1hdGNoKC9cLzYkLyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgMTAwMCwgJ3BhZ2Ugc2hvdWxkIG5hdmlnYXRlIHRvIC82Jyk7CiAgICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdTcmMKICAgKiBAcmVzdHJpY3QgQQogICAqIEBwcmlvcml0eSA5OQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSBge3toYXNofX1gIGluIGEgYHNyY2AgYXR0cmlidXRlIGRvZXNuJ3QKICAgKiB3b3JrIHJpZ2h0OiBUaGUgYnJvd3NlciB3aWxsIGZldGNoIGZyb20gdGhlIFVSTCB3aXRoIHRoZSBsaXRlcmFsCiAgICogdGV4dCBge3toYXNofX1gIHVudGlsIEFuZ3VsYXIgcmVwbGFjZXMgdGhlIGV4cHJlc3Npb24gaW5zaWRlCiAgICogYHt7aGFzaH19YC4gVGhlIGBuZ1NyY2AgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0uCiAgICoKICAgKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogICAqIGBgYGh0bWwKICAgKiA8aW1nIHNyYz0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAgICogYGBgCiAgICoKICAgKiBUaGUgY29ycmVjdCB3YXkgdG8gd3JpdGUgaXQ6CiAgICogYGBgaHRtbAogICAqIDxpbWcgbmctc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgKiBgYGAKICAgKgogICAqIEBlbGVtZW50IElNRwogICAqIEBwYXJhbSB7dGVtcGxhdGV9IG5nU3JjIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nU3Jjc2V0CiAgICogQHJlc3RyaWN0IEEKICAgKiBAcHJpb3JpdHkgOTkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFVzaW5nIEFuZ3VsYXIgbWFya3VwIGxpa2UgYHt7aGFzaH19YCBpbiBhIGBzcmNzZXRgIGF0dHJpYnV0ZSBkb2Vzbid0CiAgICogd29yayByaWdodDogVGhlIGJyb3dzZXIgd2lsbCBmZXRjaCBmcm9tIHRoZSBVUkwgd2l0aCB0aGUgbGl0ZXJhbAogICAqIHRleHQgYHt7aGFzaH19YCB1bnRpbCBBbmd1bGFyIHJlcGxhY2VzIHRoZSBleHByZXNzaW9uIGluc2lkZQogICAqIGB7e2hhc2h9fWAuIFRoZSBgbmdTcmNzZXRgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtLgogICAqCiAgICogVGhlIGJ1Z2d5IHdheSB0byB3cml0ZSBpdDoKICAgKiBgYGBodG1sCiAgICogPGltZyBzcmNzZXQ9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSAyeCIvPgogICAqIGBgYAogICAqCiAgICogVGhlIGNvcnJlY3Qgd2F5IHRvIHdyaXRlIGl0OgogICAqIGBgYGh0bWwKICAgKiA8aW1nIG5nLXNyY3NldD0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19IDJ4Ii8+CiAgICogYGBgCiAgICoKICAgKiBAZWxlbWVudCBJTUcKICAgKiBAcGFyYW0ge3RlbXBsYXRlfSBuZ1NyY3NldCBhbnkgc3RyaW5nIHdoaWNoIGNhbiBjb250YWluIGB7e319YCBtYXJrdXAuCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0Rpc2FibGVkCiAgICogQHJlc3RyaWN0IEEKICAgKiBAcHJpb3JpdHkgMTAwCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIFRoZSBmb2xsb3dpbmcgbWFya3VwIHdpbGwgbWFrZSB0aGUgYnV0dG9uIGVuYWJsZWQgb24gQ2hyb21lL0ZpcmVmb3ggYnV0IG5vdCBvbiBJRTggYW5kIG9sZGVyIElFczoKICAgKiBgYGBodG1sCiAgICogPGRpdiBuZy1pbml0PSJzY29wZSA9IHsgaXNEaXNhYmxlZDogZmFsc2UgfSI+CiAgICogIDxidXR0b24gZGlzYWJsZWQ9Int7c2NvcGUuaXNEaXNhYmxlZH19Ij5EaXNhYmxlZDwvYnV0dG9uPgogICAqIDwvZGl2PgogICAqIGBgYAogICAqCiAgICogVGhlIEhUTUwgc3BlY2lmaWNhdGlvbiBkb2VzIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSB2YWx1ZXMgb2YgYm9vbGVhbiBhdHRyaWJ1dGVzCiAgICogc3VjaCBhcyBkaXNhYmxlZC4gKFRoZWlyIHByZXNlbmNlIG1lYW5zIHRydWUgYW5kIHRoZWlyIGFic2VuY2UgbWVhbnMgZmFsc2UuKQogICAqIElmIHdlIHB1dCBhbiBBbmd1bGFyIGludGVycG9sYXRpb24gZXhwcmVzc2lvbiBpbnRvIHN1Y2ggYW4gYXR0cmlidXRlIHRoZW4gdGhlCiAgICogYmluZGluZyBpbmZvcm1hdGlvbiB3b3VsZCBiZSBsb3N0IHdoZW4gdGhlIGJyb3dzZXIgcmVtb3ZlcyB0aGUgYXR0cmlidXRlLgogICAqIFRoZSBgbmdEaXNhYmxlZGAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0gZm9yIHRoZSBgZGlzYWJsZWRgIGF0dHJpYnV0ZS4KICAgKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogICAqIGEgcGVybWFuZW50IHJlbGlhYmxlIHBsYWNlIHRvIHN0b3JlIHRoZSBiaW5kaW5nIGluZm9ybWF0aW9uLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICBDbGljayBtZSB0byB0b2dnbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgIDxidXR0b24gbmctbW9kZWw9ImJ1dHRvbiIgbmctZGlzYWJsZWQ9ImNoZWNrZWQiPkJ1dHRvbjwvYnV0dG9uPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIHRvZ2dsZSBidXR0b24nLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnYnV0dG9uJykpLmdldEF0dHJpYnV0ZSgnZGlzYWJsZWQnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdjaGVja2VkJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJ2J1dHRvbicpKS5nZXRBdHRyaWJ1dGUoJ2Rpc2FibGVkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICoKICAgKiBAZWxlbWVudCBJTlBVVAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdEaXNhYmxlZCBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5LAogICAqICAgICB0aGVuIHNwZWNpYWwgYXR0cmlidXRlICJkaXNhYmxlZCIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0NoZWNrZWQKICAgKiBAcmVzdHJpY3QgQQogICAqIEBwcmlvcml0eSAxMDAKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogICAqIHN1Y2ggYXMgY2hlY2tlZC4gKFRoZWlyIHByZXNlbmNlIG1lYW5zIHRydWUgYW5kIHRoZWlyIGFic2VuY2UgbWVhbnMgZmFsc2UuKQogICAqIElmIHdlIHB1dCBhbiBBbmd1bGFyIGludGVycG9sYXRpb24gZXhwcmVzc2lvbiBpbnRvIHN1Y2ggYW4gYXR0cmlidXRlIHRoZW4gdGhlCiAgICogYmluZGluZyBpbmZvcm1hdGlvbiB3b3VsZCBiZSBsb3N0IHdoZW4gdGhlIGJyb3dzZXIgcmVtb3ZlcyB0aGUgYXR0cmlidXRlLgogICAqIFRoZSBgbmdDaGVja2VkYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGBjaGVja2VkYCBhdHRyaWJ1dGUuCiAgICogVGhpcyBjb21wbGVtZW50YXJ5IGRpcmVjdGl2ZSBpcyBub3QgcmVtb3ZlZCBieSB0aGUgYnJvd3NlciBhbmQgc28gcHJvdmlkZXMKICAgKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIENoZWNrIG1lIHRvIGNoZWNrIGJvdGg6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9Im1hc3RlciI+PGJyLz4KICAgPGlucHV0IGlkPSJjaGVja1NsYXZlIiB0eXBlPSJjaGVja2JveCIgbmctY2hlY2tlZD0ibWFzdGVyIj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBjaGVjayBib3RoIGNoZWNrQm94ZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdjaGVja1NsYXZlJykpLmdldEF0dHJpYnV0ZSgnY2hlY2tlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ21hc3RlcicpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2NoZWNrU2xhdmUnKSkuZ2V0QXR0cmlidXRlKCdjaGVja2VkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICoKICAgKiBAZWxlbWVudCBJTlBVVAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDaGVja2VkIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHksCiAgICogICAgIHRoZW4gc3BlY2lhbCBhdHRyaWJ1dGUgImNoZWNrZWQiIHdpbGwgYmUgc2V0IG9uIHRoZSBlbGVtZW50CiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdSZWFkb25seQogICAqIEByZXN0cmljdCBBCiAgICogQHByaW9yaXR5IDEwMAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIEhUTUwgc3BlY2lmaWNhdGlvbiBkb2VzIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSB2YWx1ZXMgb2YgYm9vbGVhbiBhdHRyaWJ1dGVzCiAgICogc3VjaCBhcyByZWFkb25seS4gKFRoZWlyIHByZXNlbmNlIG1lYW5zIHRydWUgYW5kIHRoZWlyIGFic2VuY2UgbWVhbnMgZmFsc2UuKQogICAqIElmIHdlIHB1dCBhbiBBbmd1bGFyIGludGVycG9sYXRpb24gZXhwcmVzc2lvbiBpbnRvIHN1Y2ggYW4gYXR0cmlidXRlIHRoZW4gdGhlCiAgICogYmluZGluZyBpbmZvcm1hdGlvbiB3b3VsZCBiZSBsb3N0IHdoZW4gdGhlIGJyb3dzZXIgcmVtb3ZlcyB0aGUgYXR0cmlidXRlLgogICAqIFRoZSBgbmdSZWFkb25seWAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0gZm9yIHRoZSBgcmVhZG9ubHlgIGF0dHJpYnV0ZS4KICAgKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogICAqIGEgcGVybWFuZW50IHJlbGlhYmxlIHBsYWNlIHRvIHN0b3JlIHRoZSBiaW5kaW5nIGluZm9ybWF0aW9uLgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgQ2hlY2sgbWUgdG8gbWFrZSB0ZXh0IHJlYWRvbmx5OiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICA8aW5wdXQgdHlwZT0idGV4dCIgbmctcmVhZG9ubHk9ImNoZWNrZWQiIHZhbHVlPSJJJ20gQW5ndWxhciIvPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIHRvZ2dsZSByZWFkb25seSBhdHRyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJ1t0eXBlPSJ0ZXh0Il0nKSkuZ2V0QXR0cmlidXRlKCdyZWFkb25seScpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2NoZWNrZWQnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnW3R5cGU9InRleHQiXScpKS5nZXRBdHRyaWJ1dGUoJ3JlYWRvbmx5JykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICoKICAgKiBAZWxlbWVudCBJTlBVVAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdSZWFkb25seSBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5LAogICAqICAgICB0aGVuIHNwZWNpYWwgYXR0cmlidXRlICJyZWFkb25seSIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ1NlbGVjdGVkCiAgICogQHJlc3RyaWN0IEEKICAgKiBAcHJpb3JpdHkgMTAwCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgSFRNTCBzcGVjaWZpY2F0aW9uIGRvZXMgbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHZhbHVlcyBvZiBib29sZWFuIGF0dHJpYnV0ZXMKICAgKiBzdWNoIGFzIHNlbGVjdGVkLiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAgICogSWYgd2UgcHV0IGFuIEFuZ3VsYXIgaW50ZXJwb2xhdGlvbiBleHByZXNzaW9uIGludG8gc3VjaCBhbiBhdHRyaWJ1dGUgdGhlbiB0aGUKICAgKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAgICogVGhlIGBuZ1NlbGVjdGVkYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGBzZWxlY3RlZGAgYXR0cmlidXRlLgogICAqIFRoaXMgY29tcGxlbWVudGFyeSBkaXJlY3RpdmUgaXMgbm90IHJlbW92ZWQgYnkgdGhlIGJyb3dzZXIgYW5kIHNvIHByb3ZpZGVzCiAgICogYSBwZXJtYW5lbnQgcmVsaWFibGUgcGxhY2UgdG8gc3RvcmUgdGhlIGJpbmRpbmcgaW5mb3JtYXRpb24uCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIENoZWNrIG1lIHRvIHNlbGVjdDogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ic2VsZWN0ZWQiPjxici8+CiAgIDxzZWxlY3Q+CiAgIDxvcHRpb24+SGVsbG8hPC9vcHRpb24+CiAgIDxvcHRpb24gaWQ9ImdyZWV0IiBuZy1zZWxlY3RlZD0ic2VsZWN0ZWQiPkdyZWV0aW5ncyE8L29wdGlvbj4KICAgPC9zZWxlY3Q+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgc2VsZWN0IEdyZWV0aW5ncyEnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdncmVldCcpKS5nZXRBdHRyaWJ1dGUoJ3NlbGVjdGVkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc2VsZWN0ZWQnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdncmVldCcpKS5nZXRBdHRyaWJ1dGUoJ3NlbGVjdGVkJykpLnRvQmVUcnV0aHkoKTsKICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICoKICAgKiBAZWxlbWVudCBPUFRJT04KICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU2VsZWN0ZWQgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSwKICAgKiAgICAgdGhlbiBzcGVjaWFsIGF0dHJpYnV0ZSAic2VsZWN0ZWQiIHdpbGwgYmUgc2V0IG9uIHRoZSBlbGVtZW50CiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ09wZW4KICAgKiBAcmVzdHJpY3QgQQogICAqIEBwcmlvcml0eSAxMDAKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogICAqIHN1Y2ggYXMgb3Blbi4gKFRoZWlyIHByZXNlbmNlIG1lYW5zIHRydWUgYW5kIHRoZWlyIGFic2VuY2UgbWVhbnMgZmFsc2UuKQogICAqIElmIHdlIHB1dCBhbiBBbmd1bGFyIGludGVycG9sYXRpb24gZXhwcmVzc2lvbiBpbnRvIHN1Y2ggYW4gYXR0cmlidXRlIHRoZW4gdGhlCiAgICogYmluZGluZyBpbmZvcm1hdGlvbiB3b3VsZCBiZSBsb3N0IHdoZW4gdGhlIGJyb3dzZXIgcmVtb3ZlcyB0aGUgYXR0cmlidXRlLgogICAqIFRoZSBgbmdPcGVuYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGBvcGVuYCBhdHRyaWJ1dGUuCiAgICogVGhpcyBjb21wbGVtZW50YXJ5IGRpcmVjdGl2ZSBpcyBub3QgcmVtb3ZlZCBieSB0aGUgYnJvd3NlciBhbmQgc28gcHJvdmlkZXMKICAgKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIENoZWNrIG1lIGNoZWNrIG11bHRpcGxlOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJvcGVuIj48YnIvPgogICA8ZGV0YWlscyBpZD0iZGV0YWlscyIgbmctb3Blbj0ib3BlbiI+CiAgIDxzdW1tYXJ5PlNob3cvSGlkZSBtZTwvc3VtbWFyeT4KICAgPC9kZXRhaWxzPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIHRvZ2dsZSBvcGVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2RldGFpbHMnKSkuZ2V0QXR0cmlidXRlKCdvcGVuJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ29wZW4nKSkuY2xpY2soKTsKICAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZGV0YWlscycpKS5nZXRBdHRyaWJ1dGUoJ29wZW4nKSkudG9CZVRydXRoeSgpOwogICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICoKICAgKiBAZWxlbWVudCBERVRBSUxTCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ09wZW4gSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSwKICAgKiAgICAgdGhlbiBzcGVjaWFsIGF0dHJpYnV0ZSAib3BlbiIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICAgKi8KCiAgdmFyIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzID0ge307CgoKLy8gYm9vbGVhbiBhdHRycyBhcmUgZXZhbHVhdGVkCiAgZm9yRWFjaChCT09MRUFOX0FUVFIsIGZ1bmN0aW9uKHByb3BOYW1lLCBhdHRyTmFtZSkgewogICAgLy8gYmluZGluZyB0byBtdWx0aXBsZSBpcyBub3Qgc3VwcG9ydGVkCiAgICBpZiAocHJvcE5hbWUgPT0gIm11bHRpcGxlIikgcmV0dXJuOwoKICAgIHZhciBub3JtYWxpemVkID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgYXR0ck5hbWUpOwogICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0cltub3JtYWxpemVkXSwgZnVuY3Rpb24gbmdCb29sZWFuQXR0cldhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGF0dHIuJHNldChhdHRyTmFtZSwgISF2YWx1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CiAgICB9OwogIH0pOwoKCi8vIG5nLXNyYywgbmctc3Jjc2V0LCBuZy1ocmVmIGFyZSBpbnRlcnBvbGF0ZWQKICBmb3JFYWNoKFsnc3JjJywgJ3NyY3NldCcsICdocmVmJ10sIGZ1bmN0aW9uKGF0dHJOYW1lKSB7CiAgICB2YXIgbm9ybWFsaXplZCA9IGRpcmVjdGl2ZU5vcm1hbGl6ZSgnbmctJyArIGF0dHJOYW1lKTsKICAgIG5nQXR0cmlidXRlQWxpYXNEaXJlY3RpdmVzW25vcm1hbGl6ZWRdID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcHJpb3JpdHk6IDk5LCAvLyBpdCBuZWVkcyB0byBydW4gYWZ0ZXIgdGhlIGF0dHJpYnV0ZXMgYXJlIGludGVycG9sYXRlZAogICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICB2YXIgcHJvcE5hbWUgPSBhdHRyTmFtZSwKICAgICAgICAgICAgbmFtZSA9IGF0dHJOYW1lOwoKICAgICAgICAgIGlmIChhdHRyTmFtZSA9PT0gJ2hyZWYnICYmCiAgICAgICAgICAgIHRvU3RyaW5nLmNhbGwoZWxlbWVudC5wcm9wKCdocmVmJykpID09PSAnW29iamVjdCBTVkdBbmltYXRlZFN0cmluZ10nKSB7CiAgICAgICAgICAgIG5hbWUgPSAneGxpbmtIcmVmJzsKICAgICAgICAgICAgYXR0ci4kYXR0cltuYW1lXSA9ICd4bGluazpocmVmJzsKICAgICAgICAgICAgcHJvcE5hbWUgPSBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIGF0dHIuJG9ic2VydmUobm9ybWFsaXplZCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKCF2YWx1ZSkKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICBhdHRyLiRzZXQobmFtZSwgdmFsdWUpOwoKICAgICAgICAgICAgLy8gb24gSUUsIGlmICJuZzpzcmMiIGRpcmVjdGl2ZSBkZWNsYXJhdGlvbiBpcyB1c2VkIGFuZCAic3JjIiBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdAogICAgICAgICAgICAvLyB0aGVuIGNhbGxpbmcgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3NyYycsICdmb28nKSBkb2Vzbid0IGRvIGFueXRoaW5nLCBzbyB3ZSBuZWVkCiAgICAgICAgICAgIC8vIHRvIHNldCB0aGUgcHJvcGVydHkgYXMgd2VsbCB0byBhY2hpZXZlIHRoZSBkZXNpcmVkIGVmZmVjdC4KICAgICAgICAgICAgLy8gd2UgdXNlIGF0dHJbYXR0ck5hbWVdIHZhbHVlIHNpbmNlICRzZXQgY2FuIHNhbml0aXplIHRoZSB1cmwuCiAgICAgICAgICAgIGlmIChtc2llICYmIHByb3BOYW1lKSBlbGVtZW50LnByb3AocHJvcE5hbWUsIGF0dHJbbmFtZV0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwogICAgfTsKICB9KTsKCiAgLyogZ2xvYmFsIC1udWxsRm9ybUN0cmwgKi8KICB2YXIgbnVsbEZvcm1DdHJsID0gewogICAgJGFkZENvbnRyb2w6IG5vb3AsCiAgICAkcmVtb3ZlQ29udHJvbDogbm9vcCwKICAgICRzZXRWYWxpZGl0eTogbm9vcCwKICAgICRzZXREaXJ0eTogbm9vcCwKICAgICRzZXRQcmlzdGluZTogbm9vcAogIH07CgogIC8qKgogICAqIEBuZ2RvYyB0eXBlCiAgICogQG5hbWUgZm9ybS5Gb3JtQ29udHJvbGxlcgogICAqCiAgICogQHByb3BlcnR5IHtib29sZWFufSAkcHJpc3RpbmUgVHJ1ZSBpZiB1c2VyIGhhcyBub3QgaW50ZXJhY3RlZCB3aXRoIHRoZSBmb3JtIHlldC4KICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRkaXJ0eSBUcnVlIGlmIHVzZXIgaGFzIGFscmVhZHkgaW50ZXJhY3RlZCB3aXRoIHRoZSBmb3JtLgogICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHZhbGlkIFRydWUgaWYgYWxsIG9mIHRoZSBjb250YWluaW5nIGZvcm1zIGFuZCBjb250cm9scyBhcmUgdmFsaWQuCiAgICogQHByb3BlcnR5IHtib29sZWFufSAkaW52YWxpZCBUcnVlIGlmIGF0IGxlYXN0IG9uZSBjb250YWluaW5nIGNvbnRyb2wgb3IgZm9ybSBpcyBpbnZhbGlkLgogICAqCiAgICogQHByb3BlcnR5IHtPYmplY3R9ICRlcnJvciBJcyBhbiBvYmplY3QgaGFzaCwgY29udGFpbmluZyByZWZlcmVuY2VzIHRvIGFsbCBpbnZhbGlkIGNvbnRyb2xzIG9yCiAgICogIGZvcm1zLCB3aGVyZToKICAgKgogICAqICAtIGtleXMgYXJlIHZhbGlkYXRpb24gdG9rZW5zIChlcnJvciBuYW1lcyksCiAgICogIC0gdmFsdWVzIGFyZSBhcnJheXMgb2YgY29udHJvbHMgb3IgZm9ybXMgdGhhdCBhcmUgaW52YWxpZCBmb3IgZ2l2ZW4gZXJyb3IgbmFtZS4KICAgKgogICAqCiAgICogIEJ1aWx0LWluIHZhbGlkYXRpb24gdG9rZW5zOgogICAqCiAgICogIC0gYGVtYWlsYAogICAqICAtIGBtYXhgCiAgICogIC0gYG1heGxlbmd0aGAKICAgKiAgLSBgbWluYAogICAqICAtIGBtaW5sZW5ndGhgCiAgICogIC0gYG51bWJlcmAKICAgKiAgLSBgcGF0dGVybmAKICAgKiAgLSBgcmVxdWlyZWRgCiAgICogIC0gYHVybGAKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIGBGb3JtQ29udHJvbGxlcmAga2VlcHMgdHJhY2sgb2YgYWxsIGl0cyBjb250cm9scyBhbmQgbmVzdGVkIGZvcm1zIGFzIHdlbGwgYXMgdGhlIHN0YXRlIG9mIHRoZW0sCiAgICogc3VjaCBhcyBiZWluZyB2YWxpZC9pbnZhbGlkIG9yIGRpcnR5L3ByaXN0aW5lLgogICAqCiAgICogRWFjaCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0gZGlyZWN0aXZlIGNyZWF0ZXMgYW4gaW5zdGFuY2UKICAgKiBvZiBgRm9ybUNvbnRyb2xsZXJgLgogICAqCiAgICovCi8vYXNrcyBmb3IgJHNjb3BlIHRvIGZvb2wgdGhlIEJDIGNvbnRyb2xsZXIgbW9kdWxlCiAgRm9ybUNvbnRyb2xsZXIuJGluamVjdCA9IFsnJGVsZW1lbnQnLCAnJGF0dHJzJywgJyRzY29wZScsICckYW5pbWF0ZSddOwogIGZ1bmN0aW9uIEZvcm1Db250cm9sbGVyKGVsZW1lbnQsIGF0dHJzLCAkc2NvcGUsICRhbmltYXRlKSB7CiAgICB2YXIgZm9ybSA9IHRoaXMsCiAgICAgIHBhcmVudEZvcm0gPSBlbGVtZW50LnBhcmVudCgpLmNvbnRyb2xsZXIoJ2Zvcm0nKSB8fCBudWxsRm9ybUN0cmwsCiAgICAgIGludmFsaWRDb3VudCA9IDAsIC8vIHVzZWQgdG8gZWFzaWx5IGRldGVybWluZSBpZiB3ZSBhcmUgdmFsaWQKICAgICAgZXJyb3JzID0gZm9ybS4kZXJyb3IgPSB7fSwKICAgICAgY29udHJvbHMgPSBbXTsKCiAgICAvLyBpbml0IHN0YXRlCiAgICBmb3JtLiRuYW1lID0gYXR0cnMubmFtZSB8fCBhdHRycy5uZ0Zvcm07CiAgICBmb3JtLiRkaXJ0eSA9IGZhbHNlOwogICAgZm9ybS4kcHJpc3RpbmUgPSB0cnVlOwogICAgZm9ybS4kdmFsaWQgPSB0cnVlOwogICAgZm9ybS4kaW52YWxpZCA9IGZhbHNlOwoKICAgIHBhcmVudEZvcm0uJGFkZENvbnRyb2woZm9ybSk7CgogICAgLy8gU2V0dXAgaW5pdGlhbCBzdGF0ZSBvZiB0aGUgY29udHJvbAogICAgZWxlbWVudC5hZGRDbGFzcyhQUklTVElORV9DTEFTUyk7CiAgICB0b2dnbGVWYWxpZENzcyh0cnVlKTsKCiAgICAvLyBjb252ZW5pZW5jZSBtZXRob2QgZm9yIGVhc3kgdG9nZ2xpbmcgb2YgY2xhc3NlcwogICAgZnVuY3Rpb24gdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KSB7CiAgICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsIChpc1ZhbGlkID8gSU5WQUxJRF9DTEFTUyA6IFZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAgICRhbmltYXRlLmFkZENsYXNzKGVsZW1lbnQsIChpc1ZhbGlkID8gVkFMSURfQ0xBU1MgOiBJTlZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRhZGRDb250cm9sCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZWdpc3RlciBhIGNvbnRyb2wgd2l0aCB0aGUgZm9ybS4KICAgICAqCiAgICAgKiBJbnB1dCBlbGVtZW50cyB1c2luZyBuZ01vZGVsQ29udHJvbGxlciBkbyB0aGlzIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGV5IGFyZSBsaW5rZWQuCiAgICAgKi8KICAgIGZvcm0uJGFkZENvbnRyb2wgPSBmdW5jdGlvbihjb250cm9sKSB7CiAgICAgIC8vIEJyZWFraW5nIGNoYW5nZSAtIGJlZm9yZSwgaW5wdXRzIHdob3NlIG5hbWUgd2FzICJoYXNPd25Qcm9wZXJ0eSIgd2VyZSBxdWlldGx5IGlnbm9yZWQKICAgICAgLy8gYW5kIG5vdCBhZGRlZCB0byB0aGUgc2NvcGUuICBOb3cgd2UgdGhyb3cgYW4gZXJyb3IuCiAgICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KGNvbnRyb2wuJG5hbWUsICdpbnB1dCcpOwogICAgICBjb250cm9scy5wdXNoKGNvbnRyb2wpOwoKICAgICAgaWYgKGNvbnRyb2wuJG5hbWUpIHsKICAgICAgICBmb3JtW2NvbnRyb2wuJG5hbWVdID0gY29udHJvbDsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJHJlbW92ZUNvbnRyb2wKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERlcmVnaXN0ZXIgYSBjb250cm9sIGZyb20gdGhlIGZvcm0uCiAgICAgKgogICAgICogSW5wdXQgZWxlbWVudHMgdXNpbmcgbmdNb2RlbENvbnRyb2xsZXIgZG8gdGhpcyBhdXRvbWF0aWNhbGx5IHdoZW4gdGhleSBhcmUgZGVzdHJveWVkLgogICAgICovCiAgICBmb3JtLiRyZW1vdmVDb250cm9sID0gZnVuY3Rpb24oY29udHJvbCkgewogICAgICBpZiAoY29udHJvbC4kbmFtZSAmJiBmb3JtW2NvbnRyb2wuJG5hbWVdID09PSBjb250cm9sKSB7CiAgICAgICAgZGVsZXRlIGZvcm1bY29udHJvbC4kbmFtZV07CiAgICAgIH0KICAgICAgZm9yRWFjaChlcnJvcnMsIGZ1bmN0aW9uKHF1ZXVlLCB2YWxpZGF0aW9uVG9rZW4pIHsKICAgICAgICBmb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIHRydWUsIGNvbnRyb2wpOwogICAgICB9KTsKCiAgICAgIGFycmF5UmVtb3ZlKGNvbnRyb2xzLCBjb250cm9sKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRzZXRWYWxpZGl0eQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2V0cyB0aGUgdmFsaWRpdHkgb2YgYSBmb3JtIGNvbnRyb2wuCiAgICAgKgogICAgICogVGhpcyBtZXRob2Qgd2lsbCBhbHNvIHByb3BhZ2F0ZSB0byBwYXJlbnQgZm9ybXMuCiAgICAgKi8KICAgIGZvcm0uJHNldFZhbGlkaXR5ID0gZnVuY3Rpb24odmFsaWRhdGlvblRva2VuLCBpc1ZhbGlkLCBjb250cm9sKSB7CiAgICAgIHZhciBxdWV1ZSA9IGVycm9yc1t2YWxpZGF0aW9uVG9rZW5dOwoKICAgICAgaWYgKGlzVmFsaWQpIHsKICAgICAgICBpZiAocXVldWUpIHsKICAgICAgICAgIGFycmF5UmVtb3ZlKHF1ZXVlLCBjb250cm9sKTsKICAgICAgICAgIGlmICghcXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgIGludmFsaWRDb3VudC0tOwogICAgICAgICAgICBpZiAoIWludmFsaWRDb3VudCkgewogICAgICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQpOwogICAgICAgICAgICAgIGZvcm0uJHZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgICBmb3JtLiRpbnZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBmYWxzZTsKICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSwgdmFsaWRhdGlvblRva2VuKTsKICAgICAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvblRva2VuLCB0cnVlLCBmb3JtKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICB9IGVsc2UgewogICAgICAgIGlmICghaW52YWxpZENvdW50KSB7CiAgICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkKTsKICAgICAgICB9CiAgICAgICAgaWYgKHF1ZXVlKSB7CiAgICAgICAgICBpZiAoaW5jbHVkZXMocXVldWUsIGNvbnRyb2wpKSByZXR1cm47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVycm9yc1t2YWxpZGF0aW9uVG9rZW5dID0gcXVldWUgPSBbXTsKICAgICAgICAgIGludmFsaWRDb3VudCsrOwogICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoZmFsc2UsIHZhbGlkYXRpb25Ub2tlbik7CiAgICAgICAgICBwYXJlbnRGb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIGZhbHNlLCBmb3JtKTsKICAgICAgICB9CiAgICAgICAgcXVldWUucHVzaChjb250cm9sKTsKCiAgICAgICAgZm9ybS4kdmFsaWQgPSBmYWxzZTsKICAgICAgICBmb3JtLiRpbnZhbGlkID0gdHJ1ZTsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJHNldERpcnR5CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXRzIHRoZSBmb3JtIHRvIGEgZGlydHkgc3RhdGUuCiAgICAgKgogICAgICogVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB0byBhZGQgdGhlICduZy1kaXJ0eScgY2xhc3MgYW5kIHNldCB0aGUgZm9ybSB0byBhIGRpcnR5CiAgICAgKiBzdGF0ZSAobmctZGlydHkgY2xhc3MpLiBUaGlzIG1ldGhvZCB3aWxsIGFsc28gcHJvcGFnYXRlIHRvIHBhcmVudCBmb3Jtcy4KICAgICAqLwogICAgZm9ybS4kc2V0RGlydHkgPSBmdW5jdGlvbigpIHsKICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoZWxlbWVudCwgUFJJU1RJTkVfQ0xBU1MpOwogICAgICAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCBESVJUWV9DTEFTUyk7CiAgICAgIGZvcm0uJGRpcnR5ID0gdHJ1ZTsKICAgICAgZm9ybS4kcHJpc3RpbmUgPSBmYWxzZTsKICAgICAgcGFyZW50Rm9ybS4kc2V0RGlydHkoKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyIyRzZXRQcmlzdGluZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2V0cyB0aGUgZm9ybSB0byBpdHMgcHJpc3RpbmUgc3RhdGUuCiAgICAgKgogICAgICogVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB0byByZW1vdmUgdGhlICduZy1kaXJ0eScgY2xhc3MgYW5kIHNldCB0aGUgZm9ybSB0byBpdHMgcHJpc3RpbmUKICAgICAqIHN0YXRlIChuZy1wcmlzdGluZSBjbGFzcykuIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gYWxsIHRoZSBjb250cm9scyBjb250YWluZWQKICAgICAqIGluIHRoaXMgZm9ybS4KICAgICAqCiAgICAgKiBTZXR0aW5nIGEgZm9ybSBiYWNrIHRvIGEgcHJpc3RpbmUgc3RhdGUgaXMgb2Z0ZW4gdXNlZnVsIHdoZW4gd2Ugd2FudCB0byAncmV1c2UnIGEgZm9ybSBhZnRlcgogICAgICogc2F2aW5nIG9yIHJlc2V0dGluZyBpdC4KICAgICAqLwogICAgZm9ybS4kc2V0UHJpc3RpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsIERJUlRZX0NMQVNTKTsKICAgICAgJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgUFJJU1RJTkVfQ0xBU1MpOwogICAgICBmb3JtLiRkaXJ0eSA9IGZhbHNlOwogICAgICBmb3JtLiRwcmlzdGluZSA9IHRydWU7CiAgICAgIGZvckVhY2goY29udHJvbHMsIGZ1bmN0aW9uKGNvbnRyb2wpIHsKICAgICAgICBjb250cm9sLiRzZXRQcmlzdGluZSgpOwogICAgICB9KTsKICAgIH07CiAgfQoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nRm9ybQogICAqIEByZXN0cmljdCBFQUMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIE5lc3RhYmxlIGFsaWFzIG9mIHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBgZm9ybWB9IGRpcmVjdGl2ZS4gSFRNTAogICAqIGRvZXMgbm90IGFsbG93IG5lc3Rpbmcgb2YgZm9ybSBlbGVtZW50cy4gSXQgaXMgdXNlZnVsIHRvIG5lc3QgZm9ybXMsIGZvciBleGFtcGxlIGlmIHRoZSB2YWxpZGl0eSBvZiBhCiAgICogc3ViLWdyb3VwIG9mIGNvbnRyb2xzIG5lZWRzIHRvIGJlIGRldGVybWluZWQuCiAgICoKICAgKiBOb3RlOiB0aGUgcHVycG9zZSBvZiBgbmdGb3JtYCBpcyB0byBncm91cCBjb250cm9scywKICAgKiBidXQgbm90IHRvIGJlIGEgcmVwbGFjZW1lbnQgZm9yIHRoZSBgPGZvcm0+YCB0YWcgd2l0aCBhbGwgb2YgaXRzIGNhcGFiaWxpdGllcwogICAqIChlLmcuIHBvc3RpbmcgdG8gdGhlIHNlcnZlciwgLi4uKS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdGb3JtfG5hbWUgTmFtZSBvZiB0aGUgZm9ybS4gSWYgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIHdpbGwgYmUgcHVibGlzaGVkIGludG8KICAgKiAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRlZCBzY29wZSwgdW5kZXIgdGhpcyBuYW1lLgogICAqCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBmb3JtCiAgICogQHJlc3RyaWN0IEUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERpcmVjdGl2ZSB0aGF0IGluc3RhbnRpYXRlcwogICAqIHtAbGluayBmb3JtLkZvcm1Db250cm9sbGVyIEZvcm1Db250cm9sbGVyfS4KICAgKgogICAqIElmIHRoZSBgbmFtZWAgYXR0cmlidXRlIGlzIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciBpcyBwdWJsaXNoZWQgb250byB0aGUgY3VycmVudCBzY29wZSB1bmRlcgogICAqIHRoaXMgbmFtZS4KICAgKgogICAqICMgQWxpYXM6IHtAbGluayBuZy5kaXJlY3RpdmU6bmdGb3JtIGBuZ0Zvcm1gfQogICAqCiAgICogSW4gQW5ndWxhciBmb3JtcyBjYW4gYmUgbmVzdGVkLiBUaGlzIG1lYW5zIHRoYXQgdGhlIG91dGVyIGZvcm0gaXMgdmFsaWQgd2hlbiBhbGwgb2YgdGhlIGNoaWxkCiAgICogZm9ybXMgYXJlIHZhbGlkIGFzIHdlbGwuIEhvd2V2ZXIsIGJyb3dzZXJzIGRvIG5vdCBhbGxvdyBuZXN0aW5nIG9mIGA8Zm9ybT5gIGVsZW1lbnRzLCBzbwogICAqIEFuZ3VsYXIgcHJvdmlkZXMgdGhlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdGb3JtIGBuZ0Zvcm1gfSBkaXJlY3RpdmUgd2hpY2ggYmVoYXZlcyBpZGVudGljYWxseSB0bwogICAqIGA8Zm9ybT5gIGJ1dCBjYW4gYmUgbmVzdGVkLiAgVGhpcyBhbGxvd3MgeW91IHRvIGhhdmUgbmVzdGVkIGZvcm1zLCB3aGljaCBpcyB2ZXJ5IHVzZWZ1bCB3aGVuCiAgICogdXNpbmcgQW5ndWxhciB2YWxpZGF0aW9uIGRpcmVjdGl2ZXMgaW4gZm9ybXMgdGhhdCBhcmUgZHluYW1pY2FsbHkgZ2VuZXJhdGVkIHVzaW5nIHRoZQogICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgYG5nUmVwZWF0YH0gZGlyZWN0aXZlLiBTaW5jZSB5b3UgY2Fubm90IGR5bmFtaWNhbGx5IGdlbmVyYXRlIHRoZSBgbmFtZWAKICAgKiBhdHRyaWJ1dGUgb2YgaW5wdXQgZWxlbWVudHMgdXNpbmcgaW50ZXJwb2xhdGlvbiwgeW91IGhhdmUgdG8gd3JhcCBlYWNoIHNldCBvZiByZXBlYXRlZCBpbnB1dHMgaW4gYW4KICAgKiBgbmdGb3JtYCBkaXJlY3RpdmUgYW5kIG5lc3QgdGhlc2UgaW4gYW4gb3V0ZXIgYGZvcm1gIGVsZW1lbnQuCiAgICoKICAgKgogICAqICMgQ1NTIGNsYXNzZXMKICAgKiAgLSBgbmctdmFsaWRgIGlzIHNldCBpZiB0aGUgZm9ybSBpcyB2YWxpZC4KICAgKiAgLSBgbmctaW52YWxpZGAgaXMgc2V0IGlmIHRoZSBmb3JtIGlzIGludmFsaWQuCiAgICogIC0gYG5nLXByaXN0aW5lYCBpcyBzZXQgaWYgdGhlIGZvcm0gaXMgcHJpc3RpbmUuCiAgICogIC0gYG5nLWRpcnR5YCBpcyBzZXQgaWYgdGhlIGZvcm0gaXMgZGlydHkuCiAgICoKICAgKiBLZWVwIGluIG1pbmQgdGhhdCBuZ0FuaW1hdGUgY2FuIGRldGVjdCBlYWNoIG9mIHRoZXNlIGNsYXNzZXMgd2hlbiBhZGRlZCBhbmQgcmVtb3ZlZC4KICAgKgogICAqCiAgICogIyBTdWJtaXR0aW5nIGEgZm9ybSBhbmQgcHJldmVudGluZyB0aGUgZGVmYXVsdCBhY3Rpb24KICAgKgogICAqIFNpbmNlIHRoZSByb2xlIG9mIGZvcm1zIGluIGNsaWVudC1zaWRlIEFuZ3VsYXIgYXBwbGljYXRpb25zIGlzIGRpZmZlcmVudCB0aGFuIGluIGNsYXNzaWNhbAogICAqIHJvdW5kdHJpcCBhcHBzLCBpdCBpcyBkZXNpcmFibGUgZm9yIHRoZSBicm93c2VyIG5vdCB0byB0cmFuc2xhdGUgdGhlIGZvcm0gc3VibWlzc2lvbiBpbnRvIGEgZnVsbAogICAqIHBhZ2UgcmVsb2FkIHRoYXQgc2VuZHMgdGhlIGRhdGEgdG8gdGhlIHNlcnZlci4gSW5zdGVhZCBzb21lIGphdmFzY3JpcHQgbG9naWMgc2hvdWxkIGJlIHRyaWdnZXJlZAogICAqIHRvIGhhbmRsZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGluIGFuIGFwcGxpY2F0aW9uLXNwZWNpZmljIHdheS4KICAgKgogICAqIEZvciB0aGlzIHJlYXNvbiwgQW5ndWxhciBwcmV2ZW50cyB0aGUgZGVmYXVsdCBhY3Rpb24gKGZvcm0gc3VibWlzc2lvbiB0byB0aGUgc2VydmVyKSB1bmxlc3MgdGhlCiAgICogYDxmb3JtPmAgZWxlbWVudCBoYXMgYW4gYGFjdGlvbmAgYXR0cmlidXRlIHNwZWNpZmllZC4KICAgKgogICAqIFlvdSBjYW4gdXNlIG9uZSBvZiB0aGUgZm9sbG93aW5nIHR3byB3YXlzIHRvIHNwZWNpZnkgd2hhdCBqYXZhc2NyaXB0IG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIHdoZW4KICAgKiBhIGZvcm0gaXMgc3VibWl0dGVkOgogICAqCiAgICogLSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nU3VibWl0IG5nU3VibWl0fSBkaXJlY3RpdmUgb24gdGhlIGZvcm0gZWxlbWVudAogICAqIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9IGRpcmVjdGl2ZSBvbiB0aGUgZmlyc3QKICAgKiAgYnV0dG9uIG9yIGlucHV0IGZpZWxkIG9mIHR5cGUgc3VibWl0IChpbnB1dFt0eXBlPXN1Ym1pdF0pCiAgICoKICAgKiBUbyBwcmV2ZW50IGRvdWJsZSBleGVjdXRpb24gb2YgdGhlIGhhbmRsZXIsIHVzZSBvbmx5IG9uZSBvZiB0aGUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1N1Ym1pdCBuZ1N1Ym1pdH0KICAgKiBvciB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30gZGlyZWN0aXZlcy4KICAgKiBUaGlzIGlzIGJlY2F1c2Ugb2YgdGhlIGZvbGxvd2luZyBmb3JtIHN1Ym1pc3Npb24gcnVsZXMgaW4gdGhlIEhUTUwgc3BlY2lmaWNhdGlvbjoKICAgKgogICAqIC0gSWYgYSBmb3JtIGhhcyBvbmx5IG9uZSBpbnB1dCBmaWVsZCB0aGVuIGhpdHRpbmcgZW50ZXIgaW4gdGhpcyBmaWVsZCB0cmlnZ2VycyBmb3JtIHN1Ym1pdAogICAqIChgbmdTdWJtaXRgKQogICAqIC0gaWYgYSBmb3JtIGhhcyAyKyBpbnB1dCBmaWVsZHMgYW5kIG5vIGJ1dHRvbnMgb3IgaW5wdXRbdHlwZT1zdWJtaXRdIHRoZW4gaGl0dGluZyBlbnRlcgogICAqIGRvZXNuJ3QgdHJpZ2dlciBzdWJtaXQKICAgKiAtIGlmIGEgZm9ybSBoYXMgb25lIG9yIG1vcmUgaW5wdXQgZmllbGRzIGFuZCBvbmUgb3IgbW9yZSBidXR0b25zIG9yIGlucHV0W3R5cGU9c3VibWl0XSB0aGVuCiAgICogaGl0dGluZyBlbnRlciBpbiBhbnkgb2YgdGhlIGlucHV0IGZpZWxkcyB3aWxsIHRyaWdnZXIgdGhlIGNsaWNrIGhhbmRsZXIgb24gdGhlICpmaXJzdCogYnV0dG9uIG9yCiAgICogaW5wdXRbdHlwZT1zdWJtaXRdIChgbmdDbGlja2ApICphbmQqIGEgc3VibWl0IGhhbmRsZXIgb24gdGhlIGVuY2xvc2luZyBmb3JtIChgbmdTdWJtaXRgKQogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIE5hbWUgb2YgdGhlIGZvcm0uIElmIHNwZWNpZmllZCwgdGhlIGZvcm0gY29udHJvbGxlciB3aWxsIGJlIHB1Ymxpc2hlZCBpbnRvCiAgICogICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQgc2NvcGUsIHVuZGVyIHRoaXMgbmFtZS4KICAgKgogICAqICMjIEFuaW1hdGlvbiBIb29rcwogICAqCiAgICogQW5pbWF0aW9ucyBpbiBuZ0Zvcm0gYXJlIHRyaWdnZXJlZCB3aGVuIGFueSBvZiB0aGUgYXNzb2NpYXRlZCBDU1MgY2xhc3NlcyBhcmUgYWRkZWQgYW5kIHJlbW92ZWQuCiAgICogVGhlc2UgY2xhc3NlcyBhcmU6IGAubmctcHJpc3RpbmVgLCBgLm5nLWRpcnR5YCwgYC5uZy1pbnZhbGlkYCBhbmQgYC5uZy12YWxpZGAgYXMgd2VsbCBhcyBhbnkKICAgKiBvdGhlciB2YWxpZGF0aW9ucyB0aGF0IGFyZSBwZXJmb3JtZWQgd2l0aGluIHRoZSBmb3JtLiBBbmltYXRpb25zIGluIG5nRm9ybSBhcmUgc2ltaWxhciB0byBob3cKICAgKiB0aGV5IHdvcmsgaW4gbmdDbGFzcyBhbmQgYW5pbWF0aW9ucyBjYW4gYmUgaG9va2VkIGludG8gdXNpbmcgQ1NTIHRyYW5zaXRpb25zLCBrZXlmcmFtZXMgYXMgd2VsbAogICAqIGFzIEpTIGFuaW1hdGlvbnMuCiAgICoKICAgKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgYSBzaW1wbGUgd2F5IHRvIHV0aWxpemUgQ1NTIHRyYW5zaXRpb25zIHRvIHN0eWxlIGEgZm9ybSBlbGVtZW50CiAgICogdGhhdCBoYXMgYmVlbiByZW5kZXJlZCBhcyBpbnZhbGlkIGFmdGVyIGl0IGhhcyBiZWVuIHZhbGlkYXRlZDoKICAgKgogICAqIDxwcmU+CiAgICogLy9iZSBzdXJlIHRvIGluY2x1ZGUgbmdBbmltYXRlIGFzIGEgbW9kdWxlIHRvIGhvb2sgaW50byBtb3JlCiAgICogLy9hZHZhbmNlZCBhbmltYXRpb25zCiAgICogLm15LWZvcm0gewogKiAgIHRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogKiAgIGJhY2tncm91bmQ6IHdoaXRlOwogKiB9CiAgICogLm15LWZvcm0ubmctaW52YWxpZCB7CiAqICAgYmFja2dyb3VuZDogcmVkOwogKiAgIGNvbG9yOndoaXRlOwogKiB9CiAgICogPC9wcmU+CiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiIGZpeEJhc2U9InRydWUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudXNlclR5cGUgPSAnZ3Vlc3QnOwogICAgICAgICB9CiAgIDwvc2NyaXB0PgogICA8c3R5bGU+CiAgIC5teS1mb3JtIHsKICAgICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgICB0cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OwogICAgICAgIH0KICAgLm15LWZvcm0ubmctaW52YWxpZCB7CiAgICAgICAgICBiYWNrZ3JvdW5kOiByZWQ7CiAgICAgICAgfQogICA8L3N0eWxlPgogICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiIGNsYXNzPSJteS1mb3JtIj4KICAgdXNlclR5cGU6IDxpbnB1dCBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InVzZXJUeXBlIiByZXF1aXJlZD4KICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj5SZXF1aXJlZCE8L3NwYW4+PGJyPgogICA8dHQ+dXNlclR5cGUgPSB7e3VzZXJUeXBlfX08L3R0Pjxicj4KICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyPgogICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnI+CiAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgIDwvZm9ybT4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdXNlclR5cGUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3VzZXJUeXBlJykpOwogICAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyVHlwZS5nZXRUZXh0KCkpLnRvQ29udGFpbignZ3Vlc3QnKTsKICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgIH0pOwoKICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdXNlclR5cGUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3VzZXJUeXBlJykpOwogICAgICAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgICAgICAgdmFyIHVzZXJJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3VzZXJUeXBlJykpOwoKICAgICAgICAgIHVzZXJJbnB1dC5jbGVhcigpOwogICAgICAgICAgdXNlcklucHV0LnNlbmRLZXlzKCcnKTsKCiAgICAgICAgICBleHBlY3QodXNlclR5cGUuZ2V0VGV4dCgpKS50b0VxdWFsKCd1c2VyVHlwZSA9Jyk7CiAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqCiAgICovCiAgdmFyIGZvcm1EaXJlY3RpdmVGYWN0b3J5ID0gZnVuY3Rpb24oaXNOZ0Zvcm0pIHsKICAgIHJldHVybiBbJyR0aW1lb3V0JywgZnVuY3Rpb24oJHRpbWVvdXQpIHsKICAgICAgdmFyIGZvcm1EaXJlY3RpdmUgPSB7CiAgICAgICAgbmFtZTogJ2Zvcm0nLAogICAgICAgIHJlc3RyaWN0OiBpc05nRm9ybSA/ICdFQUMnIDogJ0UnLAogICAgICAgIGNvbnRyb2xsZXI6IEZvcm1Db250cm9sbGVyLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcHJlOiBmdW5jdGlvbihzY29wZSwgZm9ybUVsZW1lbnQsIGF0dHIsIGNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICBpZiAoIWF0dHIuYWN0aW9uKSB7CiAgICAgICAgICAgICAgICAvLyB3ZSBjYW4ndCB1c2UganEgZXZlbnRzIGJlY2F1c2UgaWYgYSBmb3JtIGlzIGRlc3Ryb3llZCBkdXJpbmcgc3VibWlzc2lvbiB0aGUgZGVmYXVsdAogICAgICAgICAgICAgICAgLy8gYWN0aW9uIGlzIG5vdCBwcmV2ZW50ZWQuIHNlZSAjMTIzOAogICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgIC8vIElFIDkgaXMgbm90IGFmZmVjdGVkIGJlY2F1c2UgaXQgZG9lc24ndCBmaXJlIGEgc3VibWl0IGV2ZW50IGFuZCB0cnkgdG8gZG8gYSBmdWxsCiAgICAgICAgICAgICAgICAvLyBwYWdlIHJlbG9hZCBpZiB0aGUgZm9ybSB3YXMgZGVzdHJveWVkIGJ5IHN1Ym1pc3Npb24gb2YgdGhlIGZvcm0gdmlhIGEgY2xpY2sgaGFuZGxlcgogICAgICAgICAgICAgICAgLy8gb24gYSBidXR0b24gaW4gdGhlIGZvcm0uIExvb2tzIGxpa2UgYW4gSUU5IHNwZWNpZmljIGJ1Zy4KICAgICAgICAgICAgICAgIHZhciBwcmV2ZW50RGVmYXVsdExpc3RlbmVyID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQKICAgICAgICAgICAgICAgICAgICA/IGV2ZW50LnByZXZlbnREZWZhdWx0KCkKICAgICAgICAgICAgICAgICAgICA6IGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7IC8vIElFCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGFkZEV2ZW50TGlzdGVuZXJGbihmb3JtRWxlbWVudFswXSwgJ3N1Ym1pdCcsIHByZXZlbnREZWZhdWx0TGlzdGVuZXIpOwoKICAgICAgICAgICAgICAgIC8vIHVucmVnaXN0ZXIgdGhlIHByZXZlbnREZWZhdWx0IGxpc3RlbmVyIHNvIHRoYXQgd2UgZG9uJ3Qgbm90IGxlYWsgbWVtb3J5IGJ1dCBpbiBhCiAgICAgICAgICAgICAgICAvLyB3YXkgdGhhdCB3aWxsIGFjaGlldmUgdGhlIHByZXZlbnRpb24gb2YgdGhlIGRlZmF1bHQgYWN0aW9uLgogICAgICAgICAgICAgICAgZm9ybUVsZW1lbnQub24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihmb3JtRWxlbWVudFswXSwgJ3N1Ym1pdCcsIHByZXZlbnREZWZhdWx0TGlzdGVuZXIpOwogICAgICAgICAgICAgICAgICB9LCAwLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHZhciBwYXJlbnRGb3JtQ3RybCA9IGZvcm1FbGVtZW50LnBhcmVudCgpLmNvbnRyb2xsZXIoJ2Zvcm0nKSwKICAgICAgICAgICAgICAgIGFsaWFzID0gYXR0ci5uYW1lIHx8IGF0dHIubmdGb3JtOwoKICAgICAgICAgICAgICBpZiAoYWxpYXMpIHsKICAgICAgICAgICAgICAgIHNldHRlcihzY29wZSwgYWxpYXMsIGNvbnRyb2xsZXIsIGFsaWFzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcmVudEZvcm1DdHJsKSB7CiAgICAgICAgICAgICAgICBmb3JtRWxlbWVudC5vbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcGFyZW50Rm9ybUN0cmwuJHJlbW92ZUNvbnRyb2woY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICAgIGlmIChhbGlhcykgewogICAgICAgICAgICAgICAgICAgIHNldHRlcihzY29wZSwgYWxpYXMsIHVuZGVmaW5lZCwgYWxpYXMpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGV4dGVuZChjb250cm9sbGVyLCBudWxsRm9ybUN0cmwpOyAvL3N0b3AgcHJvcGFnYXRpbmcgY2hpbGQgZGVzdHJ1Y3Rpb24gaGFuZGxlcnMgdXB3YXJkcwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHJldHVybiBmb3JtRGlyZWN0aXZlOwogICAgfV07CiAgfTsKCiAgdmFyIGZvcm1EaXJlY3RpdmUgPSBmb3JtRGlyZWN0aXZlRmFjdG9yeSgpOwogIHZhciBuZ0Zvcm1EaXJlY3RpdmUgPSBmb3JtRGlyZWN0aXZlRmFjdG9yeSh0cnVlKTsKCiAgLyogZ2xvYmFsCgogICAtVkFMSURfQ0xBU1MsCiAgIC1JTlZBTElEX0NMQVNTLAogICAtUFJJU1RJTkVfQ0xBU1MsCiAgIC1ESVJUWV9DTEFTUwogICAqLwoKICB2YXIgVVJMX1JFR0VYUCA9IC9eKGZ0cHxodHRwfGh0dHBzKTpcL1wvKFx3Kzp7MCwxfVx3KkApPyhcUyspKDpbMC05XSspPyhcL3xcLyhbXHcjITouPys9JiVAIVwtXC9dKSk/JC87CiAgdmFyIEVNQUlMX1JFR0VYUCA9IC9eW2EtejAtOSEjJCUmJyorLz0/Xl9ge3x9fi4tXStAW2EtejAtOS1dKyhcLlthLXowLTktXSspKiQvaTsKICB2YXIgTlVNQkVSX1JFR0VYUCA9IC9eXHMqKFwtfFwrKT8oXGQrfChcZCooXC5cZCopKSlccyokLzsKCiAgdmFyIGlucHV0VHlwZSA9IHsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBpbnB1dAogICAgICogQG5hbWUgaW5wdXRbdGV4dF0KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFN0YW5kYXJkIEhUTUwgdGV4dCBpbnB1dCB3aXRoIGFuZ3VsYXIgZGF0YSBiaW5kaW5nLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAqICAgIG1heGxlbmd0aC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBbbmdUcmltPXRydWVdIElmIHNldCB0byBmYWxzZSBBbmd1bGFyIHdpbGwgbm90IGF1dG9tYXRpY2FsbHkgdHJpbSB0aGUgaW5wdXQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZSBuYW1lPSJ0ZXh0LWlucHV0LWRpcmVjdGl2ZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnZ3Vlc3QnOwogICAgICAgICAgICAgJHNjb3BlLndvcmQgPSAvXlxzKlx3KlxzKiQvOwogICAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIFNpbmdsZSB3b3JkOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IgogICAgIG5nLXBhdHRlcm49IndvcmQiIHJlcXVpcmVkIG5nLXRyaW09ImZhbHNlIj4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucGF0dGVybiI+CiAgICAgU2luZ2xlIHdvcmQgb25seSE8L3NwYW4+CgogICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgIDwvZm9ybT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgdmFyIHRleHQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3RleHQnKSk7CiAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgIHZhciBpbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3RleHQnKSk7CgogICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QodGV4dC5nZXRUZXh0KCkpLnRvQ29udGFpbignZ3Vlc3QnKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCcnKTsKCiAgICAgICAgICAgIGV4cGVjdCh0ZXh0LmdldFRleHQoKSkudG9FcXVhbCgndGV4dCA9Jyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbXVsdGkgd29yZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnaGVsbG8gd29ybGQnKTsKCiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgICd0ZXh0JzogdGV4dElucHV0VHlwZSwKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgaW5wdXQKICAgICAqIEBuYW1lIGlucHV0W251bWJlcl0KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRleHQgaW5wdXQgd2l0aCBudW1iZXIgdmFsaWRhdGlvbiBhbmQgdHJhbnNmb3JtYXRpb24uIFNldHMgdGhlIGBudW1iZXJgIHZhbGlkYXRpb24KICAgICAqIGVycm9yIGlmIG5vdCBhIHZhbGlkIG51bWJlci4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG1pbiBTZXRzIHRoZSBgbWluYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBsZXNzIHRoYW4gYG1pbmAuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG1heCBTZXRzIHRoZSBgbWF4YCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZW50ZXJlZCBpcyBncmVhdGVyIHRoYW4gYG1heGAuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGUgbmFtZT0ibnVtYmVyLWlucHV0LWRpcmVjdGl2ZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnZhbHVlID0gMTI7CiAgICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgTnVtYmVyOiA8aW5wdXQgdHlwZT0ibnVtYmVyIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InZhbHVlIgogICAgIG1pbj0iMCIgbWF4PSI5OSIgcmVxdWlyZWQ+CiAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLm51bWJlciI+CiAgICAgTm90IHZhbGlkIG51bWJlciE8L3NwYW4+CiAgICAgPHR0PnZhbHVlID0ge3t2YWx1ZX19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICA8L2Zvcm0+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgIHZhciB2YWx1ZSA9IGVsZW1lbnQoYnkuYmluZGluZygndmFsdWUnKSk7CiAgICAgdmFyIHZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0uaW5wdXQuJHZhbGlkJykpOwogICAgIHZhciBpbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpOwoKICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KHZhbHVlLmdldFRleHQoKSkudG9Db250YWluKCcxMicpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJycpOwogICAgICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0VxdWFsKCd2YWx1ZSA9Jyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgb3ZlciBtYXgnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJzEyMycpOwogICAgICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0VxdWFsKCd2YWx1ZSA9Jyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgICdudW1iZXInOiBudW1iZXJJbnB1dFR5cGUsCgoKICAgIC8qKgogICAgICogQG5nZG9jIGlucHV0CiAgICAgKiBAbmFtZSBpbnB1dFt1cmxdCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBUZXh0IGlucHV0IHdpdGggVVJMIHZhbGlkYXRpb24uIFNldHMgdGhlIGB1cmxgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSBjb250ZW50IGlzIG5vdCBhCiAgICAgKiB2YWxpZCBVUkwuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICogICAgbWlubGVuZ3RoLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAgICogICAgbWF4bGVuZ3RoLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlIG5hbWU9InVybC1pbnB1dC1kaXJlY3RpdmUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2h0dHA6Ly9nb29nbGUuY29tJzsKICAgICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBVUkw6IDxpbnB1dCB0eXBlPSJ1cmwiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idGV4dCIgcmVxdWlyZWQ+CiAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnVybCI+CiAgICAgTm90IHZhbGlkIHVybCE8L3NwYW4+CiAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IudXJsID0ge3shIW15Rm9ybS4kZXJyb3IudXJsfX08L3R0Pjxici8+CiAgICAgPC9mb3JtPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICB2YXIgdGV4dCA9IGVsZW1lbnQoYnkuYmluZGluZygndGV4dCcpKTsKICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndGV4dCcpKTsKCiAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdCh0ZXh0LmdldFRleHQoKSkudG9Db250YWluKCdodHRwOi8vZ29vZ2xlLmNvbScpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0VxdWFsKCd0ZXh0ID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBub3QgdXJsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCdib3gnKTsKCiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgICd1cmwnOiB1cmxJbnB1dFR5cGUsCgoKICAgIC8qKgogICAgICogQG5nZG9jIGlucHV0CiAgICAgKiBAbmFtZSBpbnB1dFtlbWFpbF0KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRleHQgaW5wdXQgd2l0aCBlbWFpbCB2YWxpZGF0aW9uLiBTZXRzIHRoZSBgZW1haWxgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIG5vdCBhIHZhbGlkIGVtYWlsCiAgICAgKiBhZGRyZXNzLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAqICAgIG1heGxlbmd0aC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZSBuYW1lPSJlbWFpbC1pbnB1dC1kaXJlY3RpdmUiPgogICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgIDxzY3JpcHQ+CiAgICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJ21lQGV4YW1wbGUuY29tJzsKICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBFbWFpbDogPGlucHV0IHR5cGU9ImVtYWlsIiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiIHJlcXVpcmVkPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5lbWFpbCI+CiAgICAgTm90IHZhbGlkIGVtYWlsITwvc3Bhbj4KICAgICA8dHQ+dGV4dCA9IHt7dGV4dH19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5lbWFpbCA9IHt7ISFteUZvcm0uJGVycm9yLmVtYWlsfX08L3R0Pjxici8+CiAgICAgPC9mb3JtPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICB2YXIgdGV4dCA9IGVsZW1lbnQoYnkuYmluZGluZygndGV4dCcpKTsKICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndGV4dCcpKTsKCiAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdCh0ZXh0LmdldFRleHQoKSkudG9Db250YWluKCdtZUBleGFtcGxlLmNvbScpOwogICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJycpOwogICAgICAgICAgICBleHBlY3QodGV4dC5nZXRUZXh0KCkpLnRvRXF1YWwoJ3RleHQgPScpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG5vdCBlbWFpbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygneHh4Jyk7CgogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCiAgICAnZW1haWwnOiBlbWFpbElucHV0VHlwZSwKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgaW5wdXQKICAgICAqIEBuYW1lIGlucHV0W3JhZGlvXQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCByYWRpbyBidXR0b24uCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIFRoZSB2YWx1ZSB0byB3aGljaCB0aGUgZXhwcmVzc2lvbiBzaG91bGQgYmUgc2V0IHdoZW4gc2VsZWN0ZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdWYWx1ZSBBbmd1bGFyIGV4cHJlc3Npb24gd2hpY2ggc2V0cyB0aGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkCiAgICAgKiAgICBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlIG5hbWU9InJhZGlvLWlucHV0LWRpcmVjdGl2ZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLmNvbG9yID0gJ2JsdWUnOwogICAgICAgICAgICAgJHNjb3BlLnNwZWNpYWxWYWx1ZSA9IHsKICAgICAgICAgICAgICAgImlkIjogIjEyMzQ1IiwKICAgICAgICAgICAgICAgInZhbHVlIjogImdyZWVuIgogICAgICAgICAgICAgfTsKICAgICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJjb2xvciIgdmFsdWU9InJlZCI+ICBSZWQgPGJyLz4KICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJjb2xvciIgbmctdmFsdWU9InNwZWNpYWxWYWx1ZSI+IEdyZWVuIDxici8+CiAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuZy1tb2RlbD0iY29sb3IiIHZhbHVlPSJibHVlIj4gQmx1ZSA8YnIvPgogICAgIDx0dD5jb2xvciA9IHt7Y29sb3IgfCBqc29ufX08L3R0Pjxici8+CiAgICAgPC9mb3JtPgogICAgIE5vdGUgdGhhdCBgbmctdmFsdWU9InNwZWNpYWxWYWx1ZSJgIHNldHMgcmFkaW8gaXRlbSdzIHZhbHVlIHRvIGJlIHRoZSB2YWx1ZSBvZiBgJHNjb3BlLnNwZWNpYWxWYWx1ZWAuCiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgIGl0KCdzaG91bGQgY2hhbmdlIHN0YXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjb2xvciA9IGVsZW1lbnQoYnkuYmluZGluZygnY29sb3InKSk7CgogICAgICAgICAgICBleHBlY3QoY29sb3IuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2JsdWUnKTsKCiAgICAgICAgICAgIGVsZW1lbnQuYWxsKGJ5Lm1vZGVsKCdjb2xvcicpKS5nZXQoMCkuY2xpY2soKTsKCiAgICAgICAgICAgIGV4cGVjdChjb2xvci5nZXRUZXh0KCkpLnRvQ29udGFpbigncmVkJyk7CiAgICAgICAgICB9KTsKICAgICA8L2ZpbGU+CiAgICAgPC9leGFtcGxlPgogICAgICovCiAgICAncmFkaW8nOiByYWRpb0lucHV0VHlwZSwKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgaW5wdXQKICAgICAqIEBuYW1lIGlucHV0W2NoZWNrYm94XQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSFRNTCBjaGVja2JveC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nVHJ1ZVZhbHVlIFRoZSB2YWx1ZSB0byB3aGljaCB0aGUgZXhwcmVzc2lvbiBzaG91bGQgYmUgc2V0IHdoZW4gc2VsZWN0ZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nRmFsc2VWYWx1ZSBUaGUgdmFsdWUgdG8gd2hpY2ggdGhlIGV4cHJlc3Npb24gc2hvdWxkIGJlIHNldCB3aGVuIG5vdCBzZWxlY3RlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlIG5hbWU9ImNoZWNrYm94LWlucHV0LWRpcmVjdGl2ZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnZhbHVlMSA9IHRydWU7CiAgICAgICAgICAgICAkc2NvcGUudmFsdWUyID0gJ1lFUycKICAgICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBWYWx1ZTE6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InZhbHVlMSI+IDxici8+CiAgICAgVmFsdWUyOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJ2YWx1ZTIiCiAgICAgbmctdHJ1ZS12YWx1ZT0iWUVTIiBuZy1mYWxzZS12YWx1ZT0iTk8iPiA8YnIvPgogICAgIDx0dD52YWx1ZTEgPSB7e3ZhbHVlMX19PC90dD48YnIvPgogICAgIDx0dD52YWx1ZTIgPSB7e3ZhbHVlMn19PC90dD48YnIvPgogICAgIDwvZm9ybT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgaXQoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlMSA9IGVsZW1lbnQoYnkuYmluZGluZygndmFsdWUxJykpOwogICAgICAgICAgICB2YXIgdmFsdWUyID0gZWxlbWVudChieS5iaW5kaW5nKCd2YWx1ZTInKSk7CgogICAgICAgICAgICBleHBlY3QodmFsdWUxLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZTIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ1lFUycpOwoKICAgICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsdWUxJykpLmNsaWNrKCk7CiAgICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlMicpKS5jbGljaygpOwoKICAgICAgICAgICAgZXhwZWN0KHZhbHVlMS5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgICAgZXhwZWN0KHZhbHVlMi5nZXRUZXh0KCkpLnRvQ29udGFpbignTk8nKTsKICAgICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgICdjaGVja2JveCc6IGNoZWNrYm94SW5wdXRUeXBlLAoKICAgICdoaWRkZW4nOiBub29wLAogICAgJ2J1dHRvbic6IG5vb3AsCiAgICAnc3VibWl0Jzogbm9vcCwKICAgICdyZXNldCc6IG5vb3AsCiAgICAnZmlsZSc6IG5vb3AKICB9OwoKLy8gQSBoZWxwZXIgZnVuY3Rpb24gdG8gY2FsbCAkc2V0VmFsaWRpdHkgYW5kIHJldHVybiB0aGUgdmFsdWUgLyB1bmRlZmluZWQsCi8vIGEgcGF0dGVybiB0aGF0IGlzIHJlcGVhdGVkIGEgbG90IGluIHRoZSBpbnB1dCB2YWxpZGF0aW9uIGxvZ2ljLgogIGZ1bmN0aW9uIHZhbGlkYXRlKGN0cmwsIHZhbGlkYXRvck5hbWUsIHZhbGlkaXR5LCB2YWx1ZSl7CiAgICBjdHJsLiRzZXRWYWxpZGl0eSh2YWxpZGF0b3JOYW1lLCB2YWxpZGl0eSk7CiAgICByZXR1cm4gdmFsaWRpdHkgPyB2YWx1ZSA6IHVuZGVmaW5lZDsKICB9CgoKICBmdW5jdGlvbiBhZGROYXRpdmVIdG1sNVZhbGlkYXRvcnMoY3RybCwgdmFsaWRhdG9yTmFtZSwgZWxlbWVudCkgewogICAgdmFyIHZhbGlkaXR5ID0gZWxlbWVudC5wcm9wKCd2YWxpZGl0eScpOwogICAgaWYgKGlzT2JqZWN0KHZhbGlkaXR5KSkgewogICAgICB2YXIgdmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAvLyBEb24ndCBvdmVyd3JpdGUgcHJldmlvdXMgdmFsaWRhdGlvbiwgZG9uJ3QgY29uc2lkZXIgdmFsdWVNaXNzaW5nIHRvIGFwcGx5IChuZy1yZXF1aXJlZCBjYW4KICAgICAgICAvLyBwZXJmb3JtIHRoZSByZXF1aXJlZCB2YWxpZGF0aW9uKQogICAgICAgIGlmICghY3RybC4kZXJyb3JbdmFsaWRhdG9yTmFtZV0gJiYgKHZhbGlkaXR5LmJhZElucHV0IHx8IHZhbGlkaXR5LmN1c3RvbUVycm9yIHx8CiAgICAgICAgICB2YWxpZGl0eS50eXBlTWlzbWF0Y2gpICYmICF2YWxpZGl0eS52YWx1ZU1pc3NpbmcpIHsKICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KHZhbGlkYXRvck5hbWUsIGZhbHNlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9OwogICAgICBjdHJsLiRwYXJzZXJzLnB1c2godmFsaWRhdG9yKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogICAgdmFyIHZhbGlkaXR5ID0gZWxlbWVudC5wcm9wKCd2YWxpZGl0eScpOwogICAgdmFyIHBsYWNlaG9sZGVyID0gZWxlbWVudFswXS5wbGFjZWhvbGRlciwgbm9ldmVudCA9IHt9OwoKICAgIC8vIEluIGNvbXBvc2l0aW9uIG1vZGUsIHVzZXJzIGFyZSBzdGlsbCBpbnB1dGluZyBpbnRlcm1lZGlhdGUgdGV4dCBidWZmZXIsCiAgICAvLyBob2xkIHRoZSBsaXN0ZW5lciB1bnRpbCBjb21wb3NpdGlvbiBpcyBkb25lLgogICAgLy8gTW9yZSBhYm91dCBjb21wb3NpdGlvbiBldmVudHM6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9Db21wb3NpdGlvbkV2ZW50CiAgICBpZiAoISRzbmlmZmVyLmFuZHJvaWQpIHsKICAgICAgdmFyIGNvbXBvc2luZyA9IGZhbHNlOwoKICAgICAgZWxlbWVudC5vbignY29tcG9zaXRpb25zdGFydCcsIGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICBjb21wb3NpbmcgPSB0cnVlOwogICAgICB9KTsKCiAgICAgIGVsZW1lbnQub24oJ2NvbXBvc2l0aW9uZW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgY29tcG9zaW5nID0gZmFsc2U7CiAgICAgICAgbGlzdGVuZXIoKTsKICAgICAgfSk7CiAgICB9CgogICAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24oZXYpIHsKICAgICAgaWYgKGNvbXBvc2luZykgcmV0dXJuOwogICAgICB2YXIgdmFsdWUgPSBlbGVtZW50LnZhbCgpOwoKICAgICAgLy8gSUUgKDExIGFuZCB1bmRlcikgc2VlbSB0byBlbWl0IGFuICdpbnB1dCcgZXZlbnQgaWYgdGhlIHBsYWNlaG9sZGVyIHZhbHVlIGNoYW5nZXMuCiAgICAgIC8vIFdlIGRvbid0IHdhbnQgdG8gZGlydHkgdGhlIHZhbHVlIHdoZW4gdGhpcyBoYXBwZW5zLCBzbyB3ZSBhYm9ydCBoZXJlLiBVbmZvcnR1bmF0ZWx5LAogICAgICAvLyBJRSBhbHNvIHNlbmRzIGlucHV0IGV2ZW50cyBmb3Igb3RoZXIgbm9uLWlucHV0LXJlbGF0ZWQgdGhpbmdzLCAoc3VjaCBhcyBmb2N1c2luZyBvbiBhCiAgICAgIC8vIGZvcm0gY29udHJvbCksIHNvIHRoaXMgY2hhbmdlIGlzIG5vdCBlbnRpcmVseSBlbm91Z2ggdG8gc29sdmUgdGhpcy4KICAgICAgaWYgKG1zaWUgJiYgKGV2IHx8IG5vZXZlbnQpLnR5cGUgPT09ICdpbnB1dCcgJiYgZWxlbWVudFswXS5wbGFjZWhvbGRlciAhPT0gcGxhY2Vob2xkZXIpIHsKICAgICAgICBwbGFjZWhvbGRlciA9IGVsZW1lbnRbMF0ucGxhY2Vob2xkZXI7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBCeSBkZWZhdWx0IHdlIHdpbGwgdHJpbSB0aGUgdmFsdWUKICAgICAgLy8gSWYgdGhlIGF0dHJpYnV0ZSBuZy10cmltIGV4aXN0cyB3ZSB3aWxsIGF2b2lkIHRyaW1taW5nCiAgICAgIC8vIGUuZy4gPGlucHV0IG5nLW1vZGVsPSJmb28iIG5nLXRyaW09ImZhbHNlIj4KICAgICAgaWYgKHRvQm9vbGVhbihhdHRyLm5nVHJpbSB8fCAnVCcpKSB7CiAgICAgICAgdmFsdWUgPSB0cmltKHZhbHVlKTsKICAgICAgfQoKICAgICAgaWYgKGN0cmwuJHZpZXdWYWx1ZSAhPT0gdmFsdWUgfHwKICAgICAgICAvLyBJZiB0aGUgdmFsdWUgaXMgc3RpbGwgZW1wdHkvZmFsc3ksIGFuZCB0aGVyZSBpcyBubyBgcmVxdWlyZWRgIGVycm9yLCBydW4gdmFsaWRhdG9ycwogICAgICAgIC8vIGFnYWluLiBUaGlzIGVuYWJsZXMgSFRNTDUgY29uc3RyYWludCB2YWxpZGF0aW9uIGVycm9ycyB0byBhZmZlY3QgQW5ndWxhciB2YWxpZGF0aW9uCiAgICAgICAgLy8gZXZlbiB3aGVuIHRoZSBmaXJzdCBjaGFyYWN0ZXIgZW50ZXJlZCBjYXVzZXMgYW4gZXJyb3IuCiAgICAgICAgKHZhbGlkaXR5ICYmIHZhbHVlID09PSAnJyAmJiAhdmFsaWRpdHkudmFsdWVNaXNzaW5nKSkgewogICAgICAgIGlmIChzY29wZS4kJHBoYXNlKSB7CiAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUodmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgLy8gaWYgdGhlIGJyb3dzZXIgZG9lcyBzdXBwb3J0ICJpbnB1dCIgZXZlbnQsIHdlIGFyZSBmaW5lIC0gZXhjZXB0IG9uIElFOSB3aGljaCBkb2Vzbid0IGZpcmUgdGhlCiAgICAvLyBpbnB1dCBldmVudCBvbiBiYWNrc3BhY2UsIGRlbGV0ZSBvciBjdXQKICAgIGlmICgkc25pZmZlci5oYXNFdmVudCgnaW5wdXQnKSkgewogICAgICBlbGVtZW50Lm9uKCdpbnB1dCcsIGxpc3RlbmVyKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciB0aW1lb3V0OwoKICAgICAgdmFyIGRlZmVyTGlzdGVuZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRpbWVvdXQpIHsKICAgICAgICAgIHRpbWVvdXQgPSAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbigpIHsKICAgICAgICAgICAgbGlzdGVuZXIoKTsKICAgICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBlbGVtZW50Lm9uKCdrZXlkb3duJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICB2YXIga2V5ID0gZXZlbnQua2V5Q29kZTsKCiAgICAgICAgLy8gaWdub3JlCiAgICAgICAgLy8gICAgY29tbWFuZCAgICAgICAgICAgIG1vZGlmaWVycyAgICAgICAgICAgICAgICAgICBhcnJvd3MKICAgICAgICBpZiAoa2V5ID09PSA5MSB8fCAoMTUgPCBrZXkgJiYga2V5IDwgMTkpIHx8ICgzNyA8PSBrZXkgJiYga2V5IDw9IDQwKSkgcmV0dXJuOwoKICAgICAgICBkZWZlckxpc3RlbmVyKCk7CiAgICAgIH0pOwoKICAgICAgLy8gaWYgdXNlciBtb2RpZmllcyBpbnB1dCB2YWx1ZSB1c2luZyBjb250ZXh0IG1lbnUgaW4gSUUsIHdlIG5lZWQgInBhc3RlIiBhbmQgImN1dCIgZXZlbnRzIHRvIGNhdGNoIGl0CiAgICAgIGlmICgkc25pZmZlci5oYXNFdmVudCgncGFzdGUnKSkgewogICAgICAgIGVsZW1lbnQub24oJ3Bhc3RlIGN1dCcsIGRlZmVyTGlzdGVuZXIpOwogICAgICB9CiAgICB9CgogICAgLy8gaWYgdXNlciBwYXN0ZSBpbnRvIGlucHV0IHVzaW5nIG1vdXNlIG9uIG9sZGVyIGJyb3dzZXIKICAgIC8vIG9yIGZvcm0gYXV0b2NvbXBsZXRlIG9uIG5ld2VyIGJyb3dzZXIsIHdlIG5lZWQgImNoYW5nZSIgZXZlbnQgdG8gY2F0Y2ggaXQKICAgIGVsZW1lbnQub24oJ2NoYW5nZScsIGxpc3RlbmVyKTsKCiAgICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgICAgZWxlbWVudC52YWwoY3RybC4kaXNFbXB0eShjdHJsLiR2aWV3VmFsdWUpID8gJycgOiBjdHJsLiR2aWV3VmFsdWUpOwogICAgfTsKCiAgICAvLyBwYXR0ZXJuIHZhbGlkYXRvcgogICAgdmFyIHBhdHRlcm4gPSBhdHRyLm5nUGF0dGVybiwKICAgICAgcGF0dGVyblZhbGlkYXRvciwKICAgICAgbWF0Y2g7CgogICAgaWYgKHBhdHRlcm4pIHsKICAgICAgdmFyIHZhbGlkYXRlUmVnZXggPSBmdW5jdGlvbihyZWdleHAsIHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbGlkYXRlKGN0cmwsICdwYXR0ZXJuJywgY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgcmVnZXhwLnRlc3QodmFsdWUpLCB2YWx1ZSk7CiAgICAgIH07CiAgICAgIG1hdGNoID0gcGF0dGVybi5tYXRjaCgvXlwvKC4qKVwvKFtnaW1dKikkLyk7CiAgICAgIGlmIChtYXRjaCkgewogICAgICAgIHBhdHRlcm4gPSBuZXcgUmVnRXhwKG1hdGNoWzFdLCBtYXRjaFsyXSk7CiAgICAgICAgcGF0dGVyblZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdmFsaWRhdGVSZWdleChwYXR0ZXJuLCB2YWx1ZSk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBwYXR0ZXJuVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHZhciBwYXR0ZXJuT2JqID0gc2NvcGUuJGV2YWwocGF0dGVybik7CgogICAgICAgICAgaWYgKCFwYXR0ZXJuT2JqIHx8ICFwYXR0ZXJuT2JqLnRlc3QpIHsKICAgICAgICAgICAgdGhyb3cgbWluRXJyKCduZ1BhdHRlcm4nKSgnbm9yZWdleHAnLAogICAgICAgICAgICAgICdFeHBlY3RlZCB7MH0gdG8gYmUgYSBSZWdFeHAgYnV0IHdhcyB7MX0uIEVsZW1lbnQ6IHsyfScsIHBhdHRlcm4sCiAgICAgICAgICAgICAgcGF0dGVybk9iaiwgc3RhcnRpbmdUYWcoZWxlbWVudCkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbGlkYXRlUmVnZXgocGF0dGVybk9iaiwgdmFsdWUpOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChwYXR0ZXJuVmFsaWRhdG9yKTsKICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKHBhdHRlcm5WYWxpZGF0b3IpOwogICAgfQoKICAgIC8vIG1pbiBsZW5ndGggdmFsaWRhdG9yCiAgICBpZiAoYXR0ci5uZ01pbmxlbmd0aCkgewogICAgICB2YXIgbWlubGVuZ3RoID0gaW50KGF0dHIubmdNaW5sZW5ndGgpOwogICAgICB2YXIgbWluTGVuZ3RoVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ21pbmxlbmd0aCcsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IHZhbHVlLmxlbmd0aCA+PSBtaW5sZW5ndGgsIHZhbHVlKTsKICAgICAgfTsKCiAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtaW5MZW5ndGhWYWxpZGF0b3IpOwogICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWluTGVuZ3RoVmFsaWRhdG9yKTsKICAgIH0KCiAgICAvLyBtYXggbGVuZ3RoIHZhbGlkYXRvcgogICAgaWYgKGF0dHIubmdNYXhsZW5ndGgpIHsKICAgICAgdmFyIG1heGxlbmd0aCA9IGludChhdHRyLm5nTWF4bGVuZ3RoKTsKICAgICAgdmFyIG1heExlbmd0aFZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbGlkYXRlKGN0cmwsICdtYXhsZW5ndGgnLCBjdHJsLiRpc0VtcHR5KHZhbHVlKSB8fCB2YWx1ZS5sZW5ndGggPD0gbWF4bGVuZ3RoLCB2YWx1ZSk7CiAgICAgIH07CgogICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWF4TGVuZ3RoVmFsaWRhdG9yKTsKICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1heExlbmd0aFZhbGlkYXRvcik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBudW1iZXJJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogICAgdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKCiAgICBjdHJsLiRwYXJzZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFyIGVtcHR5ID0gY3RybC4kaXNFbXB0eSh2YWx1ZSk7CiAgICAgIGlmIChlbXB0eSB8fCBOVU1CRVJfUkVHRVhQLnRlc3QodmFsdWUpKSB7CiAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIHRydWUpOwogICAgICAgIHJldHVybiB2YWx1ZSA9PT0gJycgPyBudWxsIDogKGVtcHR5ID8gdmFsdWUgOiBwYXJzZUZsb2F0KHZhbHVlKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ251bWJlcicsIGZhbHNlKTsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICB9CiAgICB9KTsKCiAgICBhZGROYXRpdmVIdG1sNVZhbGlkYXRvcnMoY3RybCwgJ251bWJlcicsIGVsZW1lbnQpOwoKICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gY3RybC4kaXNFbXB0eSh2YWx1ZSkgPyAnJyA6ICcnICsgdmFsdWU7CiAgICB9KTsKCiAgICBpZiAoYXR0ci5taW4pIHsKICAgICAgdmFyIG1pblZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG1pbiA9IHBhcnNlRmxvYXQoYXR0ci5taW4pOwogICAgICAgIHJldHVybiB2YWxpZGF0ZShjdHJsLCAnbWluJywgY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgdmFsdWUgPj0gbWluLCB2YWx1ZSk7CiAgICAgIH07CgogICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWluVmFsaWRhdG9yKTsKICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1pblZhbGlkYXRvcik7CiAgICB9CgogICAgaWYgKGF0dHIubWF4KSB7CiAgICAgIHZhciBtYXhWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHZhciBtYXggPSBwYXJzZUZsb2F0KGF0dHIubWF4KTsKICAgICAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ21heCcsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IHZhbHVlIDw9IG1heCwgdmFsdWUpOwogICAgICB9OwoKICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKG1heFZhbGlkYXRvcik7CiAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtYXhWYWxpZGF0b3IpOwogICAgfQoKICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ251bWJlcicsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IGlzTnVtYmVyKHZhbHVlKSwgdmFsdWUpOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiB1cmxJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3NlcikgewogICAgdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKTsKCiAgICB2YXIgdXJsVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbGlkYXRlKGN0cmwsICd1cmwnLCBjdHJsLiRpc0VtcHR5KHZhbHVlKSB8fCBVUkxfUkVHRVhQLnRlc3QodmFsdWUpLCB2YWx1ZSk7CiAgICB9OwoKICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaCh1cmxWYWxpZGF0b3IpOwogICAgY3RybC4kcGFyc2Vycy5wdXNoKHVybFZhbGlkYXRvcik7CiAgfQoKICBmdW5jdGlvbiBlbWFpbElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICAgIHZhciBlbWFpbFZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWxpZGF0ZShjdHJsLCAnZW1haWwnLCBjdHJsLiRpc0VtcHR5KHZhbHVlKSB8fCBFTUFJTF9SRUdFWFAudGVzdCh2YWx1ZSksIHZhbHVlKTsKICAgIH07CgogICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGVtYWlsVmFsaWRhdG9yKTsKICAgIGN0cmwuJHBhcnNlcnMucHVzaChlbWFpbFZhbGlkYXRvcik7CiAgfQoKICBmdW5jdGlvbiByYWRpb0lucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgLy8gbWFrZSB0aGUgbmFtZSB1bmlxdWUsIGlmIG5vdCBkZWZpbmVkCiAgICBpZiAoaXNVbmRlZmluZWQoYXR0ci5uYW1lKSkgewogICAgICBlbGVtZW50LmF0dHIoJ25hbWUnLCBuZXh0VWlkKCkpOwogICAgfQoKICAgIGVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChlbGVtZW50WzBdLmNoZWNrZWQpIHsKICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUoYXR0ci52YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmFsdWUgPSBhdHRyLnZhbHVlOwogICAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSAodmFsdWUgPT0gY3RybC4kdmlld1ZhbHVlKTsKICAgIH07CgogICAgYXR0ci4kb2JzZXJ2ZSgndmFsdWUnLCBjdHJsLiRyZW5kZXIpOwogIH0KCiAgZnVuY3Rpb24gY2hlY2tib3hJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgIHZhciB0cnVlVmFsdWUgPSBhdHRyLm5nVHJ1ZVZhbHVlLAogICAgICBmYWxzZVZhbHVlID0gYXR0ci5uZ0ZhbHNlVmFsdWU7CgogICAgaWYgKCFpc1N0cmluZyh0cnVlVmFsdWUpKSB0cnVlVmFsdWUgPSB0cnVlOwogICAgaWYgKCFpc1N0cmluZyhmYWxzZVZhbHVlKSkgZmFsc2VWYWx1ZSA9IGZhbHNlOwoKICAgIGVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7CiAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICBjdHJsLiRzZXRWaWV3VmFsdWUoZWxlbWVudFswXS5jaGVja2VkKTsKICAgICAgfSk7CiAgICB9KTsKCiAgICBjdHJsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgICAgZWxlbWVudFswXS5jaGVja2VkID0gY3RybC4kdmlld1ZhbHVlOwogICAgfTsKCiAgICAvLyBPdmVycmlkZSB0aGUgc3RhbmRhcmQgYCRpc0VtcHR5YCBiZWNhdXNlIGEgdmFsdWUgb2YgYGZhbHNlYCBtZWFucyBlbXB0eSBpbiBhIGNoZWNrYm94LgogICAgY3RybC4kaXNFbXB0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAhPT0gdHJ1ZVZhbHVlOwogICAgfTsKCiAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB0cnVlVmFsdWU7CiAgICB9KTsKCiAgICBjdHJsLiRwYXJzZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID8gdHJ1ZVZhbHVlIDogZmFsc2VWYWx1ZTsKICAgIH0pOwogIH0KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSB0ZXh0YXJlYQogICAqIEByZXN0cmljdCBFCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBIVE1MIHRleHRhcmVhIGVsZW1lbnQgY29udHJvbCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLiBUaGUgZGF0YS1iaW5kaW5nIGFuZCB2YWxpZGF0aW9uCiAgICogcHJvcGVydGllcyBvZiB0aGlzIGVsZW1lbnQgYXJlIGV4YWN0bHkgdGhlIHNhbWUgYXMgdGhvc2Ugb2YgdGhlCiAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dCBlbGVtZW50fS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgKiAgICBtaW5sZW5ndGguCiAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAqICAgIG1heGxlbmd0aC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpbnB1dAogICAqIEByZXN0cmljdCBFCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBIVE1MIGlucHV0IGVsZW1lbnQgY29udHJvbCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLiBJbnB1dCBjb250cm9sIGZvbGxvd3MgSFRNTDUgaW5wdXQgdHlwZXMKICAgKiBhbmQgcG9seWZpbGxzIHRoZSBIVE1MNSB2YWxpZGF0aW9uIGJlaGF2aW9yIGZvciBvbGRlciBicm93c2Vycy4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG5nUmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBpZiBzZXQgdG8gdHJ1ZQogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICogICAgbWlubGVuZ3RoLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgKiAgICBtYXhsZW5ndGguCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBuYW1lPSJpbnB1dC1kaXJlY3RpdmUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudXNlciA9IHtuYW1lOiAnZ3Vlc3QnLCBsYXN0OiAndmlzaXRvcid9OwogICAgICAgICB9CiAgIDwvc2NyaXB0PgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICA8Zm9ybSBuYW1lPSJteUZvcm0iPgogICBVc2VyIG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJ1c2VyTmFtZSIgbmctbW9kZWw9InVzZXIubmFtZSIgcmVxdWlyZWQ+CiAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLnVzZXJOYW1lLiRlcnJvci5yZXF1aXJlZCI+CiAgIFJlcXVpcmVkITwvc3Bhbj48YnI+CiAgIExhc3QgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9Imxhc3ROYW1lIiBuZy1tb2RlbD0idXNlci5sYXN0IgogICBuZy1taW5sZW5ndGg9IjMiIG5nLW1heGxlbmd0aD0iMTAiPgogICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5sYXN0TmFtZS4kZXJyb3IubWlubGVuZ3RoIj4KICAgVG9vIHNob3J0ITwvc3Bhbj4KICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0ubGFzdE5hbWUuJGVycm9yLm1heGxlbmd0aCI+CiAgIFRvbyBsb25nITwvc3Bhbj48YnI+CiAgIDwvZm9ybT4KICAgPGhyPgogICA8dHQ+dXNlciA9IHt7dXNlcn19PC90dD48YnIvPgogICA8dHQ+bXlGb3JtLnVzZXJOYW1lLiR2YWxpZCA9IHt7bXlGb3JtLnVzZXJOYW1lLiR2YWxpZH19PC90dD48YnI+CiAgIDx0dD5teUZvcm0udXNlck5hbWUuJGVycm9yID0ge3tteUZvcm0udXNlck5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgPHR0Pm15Rm9ybS5sYXN0TmFtZS4kdmFsaWQgPSB7e215Rm9ybS5sYXN0TmFtZS4kdmFsaWR9fTwvdHQ+PGJyPgogICA8dHQ+bXlGb3JtLmxhc3ROYW1lLiRlcnJvciA9IHt7bXlGb3JtLmxhc3ROYW1lLiRlcnJvcn19PC90dD48YnI+CiAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxicj4KICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnI+CiAgIDx0dD5teUZvcm0uJGVycm9yLm1pbmxlbmd0aCA9IHt7ISFteUZvcm0uJGVycm9yLm1pbmxlbmd0aH19PC90dD48YnI+CiAgIDx0dD5teUZvcm0uJGVycm9yLm1heGxlbmd0aCA9IHt7ISFteUZvcm0uJGVycm9yLm1heGxlbmd0aH19PC90dD48YnI+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICB2YXIgdXNlciA9IGVsZW1lbnQoYnkuYmluZGluZygne3t1c2VyfX0nKSk7CiAgIHZhciB1c2VyTmFtZVZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0udXNlck5hbWUuJHZhbGlkJykpOwogICB2YXIgbGFzdE5hbWVWYWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiR2YWxpZCcpKTsKICAgdmFyIGxhc3ROYW1lRXJyb3IgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5sYXN0TmFtZS4kZXJyb3InKSk7CiAgIHZhciBmb3JtVmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS4kdmFsaWQnKSk7CiAgIHZhciB1c2VyTmFtZUlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndXNlci5uYW1lJykpOwogICB2YXIgdXNlckxhc3RJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3VzZXIubGFzdCcpKTsKCiAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KHVzZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3sibmFtZSI6Imd1ZXN0IiwibGFzdCI6InZpc2l0b3IifScpOwogICAgICAgICAgZXhwZWN0KHVzZXJOYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChmb3JtVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eSB3aGVuIHJlcXVpcmVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1c2VyTmFtZUlucHV0LmNsZWFyKCk7CiAgICAgICAgICB1c2VyTmFtZUlucHV0LnNlbmRLZXlzKCcnKTsKCiAgICAgICAgICBleHBlY3QodXNlci5nZXRUZXh0KCkpLnRvQ29udGFpbigneyJsYXN0IjoidmlzaXRvciJ9Jyk7CiAgICAgICAgICBleHBlY3QodXNlck5hbWVWYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIGV4cGVjdChmb3JtVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgfSk7CgogICBpdCgnc2hvdWxkIGJlIHZhbGlkIGlmIGVtcHR5IHdoZW4gbWluIGxlbmd0aCBpcyBzZXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHVzZXJMYXN0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIHVzZXJMYXN0SW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyLmdldFRleHQoKSkudG9Db250YWluKCd7Im5hbWUiOiJndWVzdCIsImxhc3QiOiIifScpOwogICAgICAgICAgZXhwZWN0KGxhc3ROYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChmb3JtVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBsZXNzIHRoYW4gcmVxdWlyZWQgbWluIGxlbmd0aCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdXNlckxhc3RJbnB1dC5jbGVhcigpOwogICAgICAgICAgdXNlckxhc3RJbnB1dC5zZW5kS2V5cygneHgnKTsKCiAgICAgICAgICBleHBlY3QodXNlci5nZXRUZXh0KCkpLnRvQ29udGFpbigneyJuYW1lIjoiZ3Vlc3QifScpOwogICAgICAgICAgZXhwZWN0KGxhc3ROYW1lVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QobGFzdE5hbWVFcnJvci5nZXRUZXh0KCkpLnRvQ29udGFpbignbWlubGVuZ3RoJyk7CiAgICAgICAgICBleHBlY3QoZm9ybVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgIH0pOwoKICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGxvbmdlciB0aGFuIG1heCBsZW5ndGgnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHVzZXJMYXN0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIHVzZXJMYXN0SW5wdXQuc2VuZEtleXMoJ3NvbWUgcmlkaWN1bG91c2x5IGxvbmcgbmFtZScpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyLmdldFRleHQoKSkudG9Db250YWluKCd7Im5hbWUiOiJndWVzdCJ9Jyk7CiAgICAgICAgICBleHBlY3QobGFzdE5hbWVWYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIGV4cGVjdChsYXN0TmFtZUVycm9yLmdldFRleHQoKSkudG9Db250YWluKCdtYXhsZW5ndGgnKTsKICAgICAgICAgIGV4cGVjdChmb3JtVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIHZhciBpbnB1dERpcmVjdGl2ZSA9IFsnJGJyb3dzZXInLCAnJHNuaWZmZXInLCBmdW5jdGlvbigkYnJvd3NlciwgJHNuaWZmZXIpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsCiAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgaWYgKGN0cmwpIHsKICAgICAgICAgIChpbnB1dFR5cGVbbG93ZXJjYXNlKGF0dHIudHlwZSldIHx8IGlucHV0VHlwZS50ZXh0KShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsCiAgICAgICAgICAgICRicm93c2VyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfV07CgogIHZhciBWQUxJRF9DTEFTUyA9ICduZy12YWxpZCcsCiAgICBJTlZBTElEX0NMQVNTID0gJ25nLWludmFsaWQnLAogICAgUFJJU1RJTkVfQ0xBU1MgPSAnbmctcHJpc3RpbmUnLAogICAgRElSVFlfQ0xBU1MgPSAnbmctZGlydHknOwoKICAvKioKICAgKiBAbmdkb2MgdHlwZQogICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIKICAgKgogICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSAkdmlld1ZhbHVlIEFjdHVhbCBzdHJpbmcgdmFsdWUgaW4gdGhlIHZpZXcuCiAgICogQHByb3BlcnR5IHsqfSAkbW9kZWxWYWx1ZSBUaGUgdmFsdWUgaW4gdGhlIG1vZGVsLCB0aGF0IHRoZSBjb250cm9sIGlzIGJvdW5kIHRvLgogICAqIEBwcm9wZXJ0eSB7QXJyYXkuPEZ1bmN0aW9uPn0gJHBhcnNlcnMgQXJyYXkgb2YgZnVuY3Rpb25zIHRvIGV4ZWN1dGUsIGFzIGEgcGlwZWxpbmUsIHdoZW5ldmVyCiAgIHRoZSBjb250cm9sIHJlYWRzIHZhbHVlIGZyb20gdGhlIERPTS4gIEVhY2ggZnVuY3Rpb24gaXMgY2FsbGVkLCBpbiB0dXJuLCBwYXNzaW5nIHRoZSB2YWx1ZQogICB0aHJvdWdoIHRvIHRoZSBuZXh0LiBUaGUgbGFzdCByZXR1cm4gdmFsdWUgaXMgdXNlZCB0byBwb3B1bGF0ZSB0aGUgbW9kZWwuCiAgIFVzZWQgdG8gc2FuaXRpemUgLyBjb252ZXJ0IHRoZSB2YWx1ZSBhcyB3ZWxsIGFzIHZhbGlkYXRpb24uIEZvciB2YWxpZGF0aW9uLAogICB0aGUgcGFyc2VycyBzaG91bGQgdXBkYXRlIHRoZSB2YWxpZGl0eSBzdGF0ZSB1c2luZwogICB7QGxpbmsgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0VmFsaWRpdHkgJHNldFZhbGlkaXR5KCl9LAogICBhbmQgcmV0dXJuIGB1bmRlZmluZWRgIGZvciBpbnZhbGlkIHZhbHVlcy4KCiAgICoKICAgKiBAcHJvcGVydHkge0FycmF5LjxGdW5jdGlvbj59ICRmb3JtYXR0ZXJzIEFycmF5IG9mIGZ1bmN0aW9ucyB0byBleGVjdXRlLCBhcyBhIHBpcGVsaW5lLCB3aGVuZXZlcgogICB0aGUgbW9kZWwgdmFsdWUgY2hhbmdlcy4gRWFjaCBmdW5jdGlvbiBpcyBjYWxsZWQsIGluIHR1cm4sIHBhc3NpbmcgdGhlIHZhbHVlIHRocm91Z2ggdG8gdGhlCiAgIG5leHQuIFVzZWQgdG8gZm9ybWF0IC8gY29udmVydCB2YWx1ZXMgZm9yIGRpc3BsYXkgaW4gdGhlIGNvbnRyb2wgYW5kIHZhbGlkYXRpb24uCiAgICogYGBganMKICAgKiBmdW5jdGlvbiBmb3JtYXR0ZXIodmFsdWUpIHsKICogICBpZiAodmFsdWUpIHsKICogICAgIHJldHVybiB2YWx1ZS50b1VwcGVyQ2FzZSgpOwogKiAgIH0KICogfQogICAqIG5nTW9kZWwuJGZvcm1hdHRlcnMucHVzaChmb3JtYXR0ZXIpOwogICAqIGBgYAogICAqCiAgICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkdmlld0NoYW5nZUxpc3RlbmVycyBBcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZSB3aGVuZXZlciB0aGUKICAgKiAgICAgdmlldyB2YWx1ZSBoYXMgY2hhbmdlZC4gSXQgaXMgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzLCBhbmQgaXRzIHJldHVybiB2YWx1ZSBpcyBpZ25vcmVkLgogICAqICAgICBUaGlzIGNhbiBiZSB1c2VkIGluIHBsYWNlIG9mIGFkZGl0aW9uYWwgJHdhdGNoZXMgYWdhaW5zdCB0aGUgbW9kZWwgdmFsdWUuCiAgICoKICAgKiBAcHJvcGVydHkge09iamVjdH0gJGVycm9yIEFuIG9iamVjdCBoYXNoIHdpdGggYWxsIGVycm9ycyBhcyBrZXlzLgogICAqCiAgICogQHByb3BlcnR5IHtib29sZWFufSAkcHJpc3RpbmUgVHJ1ZSBpZiB1c2VyIGhhcyBub3QgaW50ZXJhY3RlZCB3aXRoIHRoZSBjb250cm9sIHlldC4KICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRkaXJ0eSBUcnVlIGlmIHVzZXIgaGFzIGFscmVhZHkgaW50ZXJhY3RlZCB3aXRoIHRoZSBjb250cm9sLgogICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJHZhbGlkIFRydWUgaWYgdGhlcmUgaXMgbm8gZXJyb3IuCiAgICogQHByb3BlcnR5IHtib29sZWFufSAkaW52YWxpZCBUcnVlIGlmIGF0IGxlYXN0IG9uZSBlcnJvciBvbiB0aGUgY29udHJvbC4KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogYE5nTW9kZWxDb250cm9sbGVyYCBwcm92aWRlcyBBUEkgZm9yIHRoZSBgbmctbW9kZWxgIGRpcmVjdGl2ZS4gVGhlIGNvbnRyb2xsZXIgY29udGFpbnMKICAgKiBzZXJ2aWNlcyBmb3IgZGF0YS1iaW5kaW5nLCB2YWxpZGF0aW9uLCBDU1MgdXBkYXRlcywgYW5kIHZhbHVlIGZvcm1hdHRpbmcgYW5kIHBhcnNpbmcuIEl0CiAgICogcHVycG9zZWZ1bGx5IGRvZXMgbm90IGNvbnRhaW4gYW55IGxvZ2ljIHdoaWNoIGRlYWxzIHdpdGggRE9NIHJlbmRlcmluZyBvciBsaXN0ZW5pbmcgdG8KICAgKiBET00gZXZlbnRzLiBTdWNoIERPTSByZWxhdGVkIGxvZ2ljIHNob3VsZCBiZSBwcm92aWRlZCBieSBvdGhlciBkaXJlY3RpdmVzIHdoaWNoIG1ha2UgdXNlIG9mCiAgICogYE5nTW9kZWxDb250cm9sbGVyYCBmb3IgZGF0YS1iaW5kaW5nLgogICAqCiAgICogIyMgQ3VzdG9tIENvbnRyb2wgRXhhbXBsZQogICAqIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgdG8gdXNlIGBOZ01vZGVsQ29udHJvbGxlcmAgd2l0aCBhIGN1c3RvbSBjb250cm9sIHRvIGFjaGlldmUKICAgKiBkYXRhLWJpbmRpbmcuIE5vdGljZSBob3cgZGlmZmVyZW50IGRpcmVjdGl2ZXMgKGBjb250ZW50ZWRpdGFibGVgLCBgbmctbW9kZWxgLCBhbmQgYHJlcXVpcmVkYCkKICAgKiBjb2xsYWJvcmF0ZSB0b2dldGhlciB0byBhY2hpZXZlIHRoZSBkZXNpcmVkIHJlc3VsdC4KICAgKgogICAqIE5vdGUgdGhhdCBgY29udGVudGVkaXRhYmxlYCBpcyBhbiBIVE1MNSBhdHRyaWJ1dGUsIHdoaWNoIHRlbGxzIHRoZSBicm93c2VyIHRvIGxldCB0aGUgZWxlbWVudAogICAqIGNvbnRlbnRzIGJlIGVkaXRlZCBpbiBwbGFjZSBieSB0aGUgdXNlci4gIFRoaXMgd2lsbCBub3Qgd29yayBvbiBvbGRlciBicm93c2Vycy4KICAgKgogICAqIFdlIGFyZSB1c2luZyB0aGUge0BsaW5rIG5nLnNlcnZpY2U6JHNjZSAkc2NlfSBzZXJ2aWNlIGhlcmUgYW5kIGluY2x1ZGUgdGhlIHtAbGluayBuZ1Nhbml0aXplICRzYW5pdGl6ZX0KICAgKiBtb2R1bGUgdG8gYXV0b21hdGljYWxseSByZW1vdmUgImJhZCIgY29udGVudCBsaWtlIGlubGluZSBldmVudCBsaXN0ZW5lciAoZS5nLiBgPHNwYW4gb25jbGljaz0iLi4uIj5gKS4KICAgKiBIb3dldmVyLCBhcyB3ZSBhcmUgdXNpbmcgYCRzY2VgIHRoZSBtb2RlbCBjYW4gc3RpbGwgZGVjaWRlIHRvIHRvIHByb3ZpZGUgdW5zYWZlIGNvbnRlbnQgaWYgaXQgbWFya3MKICAgKiB0aGF0IGNvbnRlbnQgdXNpbmcgdGhlIGAkc2NlYCBzZXJ2aWNlLgogICAqCiAgICogPGV4YW1wbGUgbmFtZT0iTmdNb2RlbENvbnRyb2xsZXIiIG1vZHVsZT0iY3VzdG9tQ29udHJvbCIgZGVwcz0iYW5ndWxhci1zYW5pdGl6ZS5qcyI+CiAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgIFtjb250ZW50ZWRpdGFibGVdIHsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCBibGFjazsKICAgICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB3aGl0ZTsKICAgICAgICBtaW4taGVpZ2h0OiAyMHB4OwogICAgICB9CgogICAubmctaW52YWxpZCB7CiAgICAgICAgYm9yZGVyOiAxcHggc29saWQgcmVkOwogICAgICB9CgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgIGFuZ3VsYXIubW9kdWxlKCdjdXN0b21Db250cm9sJywgWyduZ1Nhbml0aXplJ10pLgogICBkaXJlY3RpdmUoJ2NvbnRlbnRlZGl0YWJsZScsIFsnJHNjZScsIGZ1bmN0aW9uKCRzY2UpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHJlc3RyaWN0OiAnQScsIC8vIG9ubHkgYWN0aXZhdGUgb24gZWxlbWVudCBhdHRyaWJ1dGUKICAgICAgICAgICAgcmVxdWlyZTogJz9uZ01vZGVsJywgLy8gZ2V0IGEgaG9sZCBvZiBOZ01vZGVsQ29udHJvbGxlcgogICAgICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIG5nTW9kZWwpIHsKICAgICAgICAgICAgICBpZighbmdNb2RlbCkgcmV0dXJuOyAvLyBkbyBub3RoaW5nIGlmIG5vIG5nLW1vZGVsCgogICAgICAgICAgICAgIC8vIFNwZWNpZnkgaG93IFVJIHNob3VsZCBiZSB1cGRhdGVkCiAgICAgICAgICAgICAgbmdNb2RlbC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50Lmh0bWwoJHNjZS5nZXRUcnVzdGVkSHRtbChuZ01vZGVsLiR2aWV3VmFsdWUgfHwgJycpKTsKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAvLyBMaXN0ZW4gZm9yIGNoYW5nZSBldmVudHMgdG8gZW5hYmxlIGJpbmRpbmcKICAgICAgICAgICAgICBlbGVtZW50Lm9uKCdibHVyIGtleXVwIGNoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KHJlYWQpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHJlYWQoKTsgLy8gaW5pdGlhbGl6ZQoKICAgICAgICAgICAgICAvLyBXcml0ZSBkYXRhIHRvIHRoZSBtb2RlbAogICAgICAgICAgICAgIGZ1bmN0aW9uIHJlYWQoKSB7CiAgICAgICAgICAgICAgICB2YXIgaHRtbCA9IGVsZW1lbnQuaHRtbCgpOwogICAgICAgICAgICAgICAgLy8gV2hlbiB3ZSBjbGVhciB0aGUgY29udGVudCBlZGl0YWJsZSB0aGUgYnJvd3NlciBsZWF2ZXMgYSA8YnI+IGJlaGluZAogICAgICAgICAgICAgICAgLy8gSWYgc3RyaXAtYnIgYXR0cmlidXRlIGlzIHByb3ZpZGVkIHRoZW4gd2Ugc3RyaXAgdGhpcyBvdXQKICAgICAgICAgICAgICAgIGlmKCBhdHRycy5zdHJpcEJyICYmIGh0bWwgPT0gJzxicj4nICkgewogICAgICAgICAgICAgICAgICBodG1sID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZ01vZGVsLiRzZXRWaWV3VmFsdWUoaHRtbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH1dKTsKICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGZvcm0gbmFtZT0ibXlGb3JtIj4KICAgPGRpdiBjb250ZW50ZWRpdGFibGUKICAgbmFtZT0ibXlXaWRnZXQiIG5nLW1vZGVsPSJ1c2VyQ29udGVudCIKICAgc3RyaXAtYnI9InRydWUiCiAgIHJlcXVpcmVkPkNoYW5nZSBtZSE8L2Rpdj4KICAgPHNwYW4gbmctc2hvdz0ibXlGb3JtLm15V2lkZ2V0LiRlcnJvci5yZXF1aXJlZCI+UmVxdWlyZWQhPC9zcGFuPgogICA8aHI+CiAgIDx0ZXh0YXJlYSBuZy1tb2RlbD0idXNlckNvbnRlbnQiPjwvdGV4dGFyZWE+CiAgIDwvZm9ybT4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBkYXRhLWJpbmQgYW5kIGJlY29tZSBpbnZhbGlkJywgZnVuY3Rpb24oKSB7CiAgICAgIGlmIChicm93c2VyLnBhcmFtcy5icm93c2VyID09ICdzYWZhcmknIHx8IGJyb3dzZXIucGFyYW1zLmJyb3dzZXIgPT0gJ2ZpcmVmb3gnKSB7CiAgICAgICAgLy8gU2FmYXJpRHJpdmVyIGNhbid0IGhhbmRsZSBjb250ZW50ZWRpdGFibGUKICAgICAgICAvLyBhbmQgRmlyZWZveCBkcml2ZXIgY2FuJ3QgY2xlYXIgY29udGVudGVkaXRhYmxlcyB2ZXJ5IHdlbGwKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGNvbnRlbnRFZGl0YWJsZSA9IGVsZW1lbnQoYnkuY3NzKCdbY29udGVudGVkaXRhYmxlXScpKTsKICAgICAgdmFyIGNvbnRlbnQgPSAnQ2hhbmdlIG1lISc7CgogICAgICBleHBlY3QoY29udGVudEVkaXRhYmxlLmdldFRleHQoKSkudG9FcXVhbChjb250ZW50KTsKCiAgICAgIGNvbnRlbnRFZGl0YWJsZS5jbGVhcigpOwogICAgICBjb250ZW50RWRpdGFibGUuc2VuZEtleXMocHJvdHJhY3Rvci5LZXkuQkFDS19TUEFDRSk7CiAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUuZ2V0VGV4dCgpKS50b0VxdWFsKCcnKTsKICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvTWF0Y2goL25nLWludmFsaWQtcmVxdWlyZWQvKTsKICAgIH0pOwogICA8L2ZpbGU+CiAgICogPC9leGFtcGxlPgogICAqCiAgICoKICAgKi8KICB2YXIgTmdNb2RlbENvbnRyb2xsZXIgPSBbJyRzY29wZScsICckZXhjZXB0aW9uSGFuZGxlcicsICckYXR0cnMnLCAnJGVsZW1lbnQnLCAnJHBhcnNlJywgJyRhbmltYXRlJywKICAgIGZ1bmN0aW9uKCRzY29wZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRhdHRyLCAkZWxlbWVudCwgJHBhcnNlLCAkYW5pbWF0ZSkgewogICAgICB0aGlzLiR2aWV3VmFsdWUgPSBOdW1iZXIuTmFOOwogICAgICB0aGlzLiRtb2RlbFZhbHVlID0gTnVtYmVyLk5hTjsKICAgICAgdGhpcy4kcGFyc2VycyA9IFtdOwogICAgICB0aGlzLiRmb3JtYXR0ZXJzID0gW107CiAgICAgIHRoaXMuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMgPSBbXTsKICAgICAgdGhpcy4kcHJpc3RpbmUgPSB0cnVlOwogICAgICB0aGlzLiRkaXJ0eSA9IGZhbHNlOwogICAgICB0aGlzLiR2YWxpZCA9IHRydWU7CiAgICAgIHRoaXMuJGludmFsaWQgPSBmYWxzZTsKICAgICAgdGhpcy4kbmFtZSA9ICRhdHRyLm5hbWU7CgogICAgICB2YXIgbmdNb2RlbEdldCA9ICRwYXJzZSgkYXR0ci5uZ01vZGVsKSwKICAgICAgICBuZ01vZGVsU2V0ID0gbmdNb2RlbEdldC5hc3NpZ247CgogICAgICBpZiAoIW5nTW9kZWxTZXQpIHsKICAgICAgICB0aHJvdyBtaW5FcnIoJ25nTW9kZWwnKSgnbm9uYXNzaWduJywgIkV4cHJlc3Npb24gJ3swfScgaXMgbm9uLWFzc2lnbmFibGUuIEVsZW1lbnQ6IHsxfSIsCiAgICAgICAgICAkYXR0ci5uZ01vZGVsLCBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICB9CgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRyZW5kZXIKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIENhbGxlZCB3aGVuIHRoZSB2aWV3IG5lZWRzIHRvIGJlIHVwZGF0ZWQuIEl0IGlzIGV4cGVjdGVkIHRoYXQgdGhlIHVzZXIgb2YgdGhlIG5nLW1vZGVsCiAgICAgICAqIGRpcmVjdGl2ZSB3aWxsIGltcGxlbWVudCB0aGlzIG1ldGhvZC4KICAgICAgICovCiAgICAgIHRoaXMuJHJlbmRlciA9IG5vb3A7CgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRpc0VtcHR5CiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBUaGlzIGlzIGNhbGxlZCB3aGVuIHdlIG5lZWQgdG8gZGV0ZXJtaW5lIGlmIHRoZSB2YWx1ZSBvZiB0aGUgaW5wdXQgaXMgZW1wdHkuCiAgICAgICAqCiAgICAgICAqIEZvciBpbnN0YW5jZSwgdGhlIHJlcXVpcmVkIGRpcmVjdGl2ZSBkb2VzIHRoaXMgdG8gd29yayBvdXQgaWYgdGhlIGlucHV0IGhhcyBkYXRhIG9yIG5vdC4KICAgICAgICogVGhlIGRlZmF1bHQgYCRpc0VtcHR5YCBmdW5jdGlvbiBjaGVja3Mgd2hldGhlciB0aGUgdmFsdWUgaXMgYHVuZGVmaW5lZGAsIGAnJ2AsIGBudWxsYCBvciBgTmFOYC4KICAgICAgICoKICAgICAgICogWW91IGNhbiBvdmVycmlkZSB0aGlzIGZvciBpbnB1dCBkaXJlY3RpdmVzIHdob3NlIGNvbmNlcHQgb2YgYmVpbmcgZW1wdHkgaXMgZGlmZmVyZW50IHRvIHRoZQogICAgICAgKiBkZWZhdWx0LiBUaGUgYGNoZWNrYm94SW5wdXRUeXBlYCBkaXJlY3RpdmUgZG9lcyB0aGlzIGJlY2F1c2UgaW4gaXRzIGNhc2UgYSB2YWx1ZSBvZiBgZmFsc2VgCiAgICAgICAqIGltcGxpZXMgZW1wdHkuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGVtcHR5LgogICAgICAgKi8KICAgICAgdGhpcy4kaXNFbXB0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGlzVW5kZWZpbmVkKHZhbHVlKSB8fCB2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgIT09IHZhbHVlOwogICAgICB9OwoKICAgICAgdmFyIHBhcmVudEZvcm0gPSAkZWxlbWVudC5pbmhlcml0ZWREYXRhKCckZm9ybUNvbnRyb2xsZXInKSB8fCBudWxsRm9ybUN0cmwsCiAgICAgICAgaW52YWxpZENvdW50ID0gMCwgLy8gdXNlZCB0byBlYXNpbHkgZGV0ZXJtaW5lIGlmIHdlIGFyZSB2YWxpZAogICAgICAgICRlcnJvciA9IHRoaXMuJGVycm9yID0ge307IC8vIGtlZXAgaW52YWxpZCBrZXlzIGhlcmUKCgogICAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICAgICRlbGVtZW50LmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CgogICAgICAvLyBjb252ZW5pZW5jZSBtZXRob2QgZm9yIGVhc3kgdG9nZ2xpbmcgb2YgY2xhc3NlcwogICAgICBmdW5jdGlvbiB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpIHsKICAgICAgICB2YWxpZGF0aW9uRXJyb3JLZXkgPSB2YWxpZGF0aW9uRXJyb3JLZXkgPyAnLScgKyBzbmFrZV9jYXNlKHZhbGlkYXRpb25FcnJvcktleSwgJy0nKSA6ICcnOwogICAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKCRlbGVtZW50LCAoaXNWYWxpZCA/IElOVkFMSURfQ0xBU1MgOiBWQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpOwogICAgICAgICRhbmltYXRlLmFkZENsYXNzKCRlbGVtZW50LCAoaXNWYWxpZCA/IFZBTElEX0NMQVNTIDogSU5WQUxJRF9DTEFTUykgKyB2YWxpZGF0aW9uRXJyb3JLZXkpOwogICAgICB9CgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRWYWxpZGl0eQogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogQ2hhbmdlIHRoZSB2YWxpZGl0eSBzdGF0ZSwgYW5kIG5vdGlmaWVzIHRoZSBmb3JtIHdoZW4gdGhlIGNvbnRyb2wgY2hhbmdlcyB2YWxpZGl0eS4gKGkuZS4gaXQKICAgICAgICogZG9lcyBub3Qgbm90aWZ5IGZvcm0gaWYgZ2l2ZW4gdmFsaWRhdG9yIGlzIGFscmVhZHkgbWFya2VkIGFzIGludmFsaWQpLgogICAgICAgKgogICAgICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIGJ5IHZhbGlkYXRvcnMgLSBpLmUuIHRoZSBwYXJzZXIgb3IgZm9ybWF0dGVyIGZ1bmN0aW9ucy4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbGlkYXRpb25FcnJvcktleSBOYW1lIG9mIHRoZSB2YWxpZGF0b3IuIHRoZSBgdmFsaWRhdGlvbkVycm9yS2V5YCB3aWxsIGFzc2lnbgogICAgICAgKiAgICAgICAgdG8gYCRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldPWlzVmFsaWRgIHNvIHRoYXQgaXQgaXMgYXZhaWxhYmxlIGZvciBkYXRhLWJpbmRpbmcuCiAgICAgICAqICAgICAgICBUaGUgYHZhbGlkYXRpb25FcnJvcktleWAgc2hvdWxkIGJlIGluIGNhbWVsQ2FzZSBhbmQgd2lsbCBnZXQgY29udmVydGVkIGludG8gZGFzaC1jYXNlCiAgICAgICAqICAgICAgICBmb3IgY2xhc3MgbmFtZS4gRXhhbXBsZTogYG15RXJyb3JgIHdpbGwgcmVzdWx0IGluIGBuZy12YWxpZC1teS1lcnJvcmAgYW5kIGBuZy1pbnZhbGlkLW15LWVycm9yYAogICAgICAgKiAgICAgICAgY2xhc3MgYW5kIGNhbiBiZSBib3VuZCB0byBhcyAgYHt7c29tZUZvcm0uc29tZUNvbnRyb2wuJGVycm9yLm15RXJyb3J9fWAgLgogICAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzVmFsaWQgV2hldGhlciB0aGUgY3VycmVudCBzdGF0ZSBpcyB2YWxpZCAodHJ1ZSkgb3IgaW52YWxpZCAoZmFsc2UpLgogICAgICAgKi8KICAgICAgdGhpcy4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbih2YWxpZGF0aW9uRXJyb3JLZXksIGlzVmFsaWQpIHsKICAgICAgICAvLyBQdXJwb3NlZnVsIHVzZSBvZiAhIGhlcmUgdG8gY2FzdCBpc1ZhbGlkIHRvIGJvb2xlYW4gaW4gY2FzZSBpdCBpcyB1bmRlZmluZWQKICAgICAgICAvLyBqc2hpbnQgLVcwMTgKICAgICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0gPT09ICFpc1ZhbGlkKSByZXR1cm47CiAgICAgICAgLy8ganNoaW50ICtXMDE4CgogICAgICAgIGlmIChpc1ZhbGlkKSB7CiAgICAgICAgICBpZiAoJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0pIGludmFsaWRDb3VudC0tOwogICAgICAgICAgaWYgKCFpbnZhbGlkQ291bnQpIHsKICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3ModHJ1ZSk7CiAgICAgICAgICAgIHRoaXMuJHZhbGlkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy4kaW52YWxpZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0b2dnbGVWYWxpZENzcyhmYWxzZSk7CiAgICAgICAgICB0aGlzLiRpbnZhbGlkID0gdHJ1ZTsKICAgICAgICAgIHRoaXMuJHZhbGlkID0gZmFsc2U7CiAgICAgICAgICBpbnZhbGlkQ291bnQrKzsKICAgICAgICB9CgogICAgICAgICRlcnJvclt2YWxpZGF0aW9uRXJyb3JLZXldID0gIWlzVmFsaWQ7CiAgICAgICAgdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCwgdmFsaWRhdGlvbkVycm9yS2V5KTsKCiAgICAgICAgcGFyZW50Rm9ybS4kc2V0VmFsaWRpdHkodmFsaWRhdGlvbkVycm9yS2V5LCBpc1ZhbGlkLCB0aGlzKTsKICAgICAgfTsKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFByaXN0aW5lCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBTZXRzIHRoZSBjb250cm9sIHRvIGl0cyBwcmlzdGluZSBzdGF0ZS4KICAgICAgICoKICAgICAgICogVGhpcyBtZXRob2QgY2FuIGJlIGNhbGxlZCB0byByZW1vdmUgdGhlICduZy1kaXJ0eScgY2xhc3MgYW5kIHNldCB0aGUgY29udHJvbCB0byBpdHMgcHJpc3RpbmUKICAgICAgICogc3RhdGUgKG5nLXByaXN0aW5lIGNsYXNzKS4KICAgICAgICovCiAgICAgIHRoaXMuJHNldFByaXN0aW5lID0gZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuJGRpcnR5ID0gZmFsc2U7CiAgICAgICAgdGhpcy4kcHJpc3RpbmUgPSB0cnVlOwogICAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKCRlbGVtZW50LCBESVJUWV9DTEFTUyk7CiAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3MoJGVsZW1lbnQsIFBSSVNUSU5FX0NMQVNTKTsKICAgICAgfTsKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZpZXdWYWx1ZQogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogVXBkYXRlIHRoZSB2aWV3IHZhbHVlLgogICAgICAgKgogICAgICAgKiBUaGlzIG1ldGhvZCBzaG91bGQgYmUgY2FsbGVkIHdoZW4gdGhlIHZpZXcgdmFsdWUgY2hhbmdlcywgdHlwaWNhbGx5IGZyb20gd2l0aGluIGEgRE9NIGV2ZW50IGhhbmRsZXIuCiAgICAgICAqIEZvciBleGFtcGxlIHtAbGluayBuZy5kaXJlY3RpdmU6aW5wdXQgaW5wdXR9IGFuZAogICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOnNlbGVjdCBzZWxlY3R9IGRpcmVjdGl2ZXMgY2FsbCBpdC4KICAgICAgICoKICAgICAgICogSXQgd2lsbCB1cGRhdGUgdGhlICR2aWV3VmFsdWUsIHRoZW4gcGFzcyB0aGlzIHZhbHVlIHRocm91Z2ggZWFjaCBvZiB0aGUgZnVuY3Rpb25zIGluIGAkcGFyc2Vyc2AsCiAgICAgICAqIHdoaWNoIGluY2x1ZGVzIGFueSB2YWxpZGF0b3JzLiBUaGUgdmFsdWUgdGhhdCBjb21lcyBvdXQgb2YgdGhpcyBgJHBhcnNlcnNgIHBpcGVsaW5lLCBiZSBhcHBsaWVkIHRvCiAgICAgICAqIGAkbW9kZWxWYWx1ZWAgYW5kIHRoZSAqKmV4cHJlc3Npb24qKiBzcGVjaWZpZWQgaW4gdGhlIGBuZy1tb2RlbGAgYXR0cmlidXRlLgogICAgICAgKgogICAgICAgKiBMYXN0bHksIGFsbCB0aGUgcmVnaXN0ZXJlZCBjaGFuZ2UgbGlzdGVuZXJzLCBpbiB0aGUgYCR2aWV3Q2hhbmdlTGlzdGVuZXJzYCBsaXN0LCBhcmUgY2FsbGVkLgogICAgICAgKgogICAgICAgKiBOb3RlIHRoYXQgY2FsbGluZyB0aGlzIGZ1bmN0aW9uIGRvZXMgbm90IHRyaWdnZXIgYSBgJGRpZ2VzdGAuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBWYWx1ZSBmcm9tIHRoZSB2aWV3LgogICAgICAgKi8KICAgICAgdGhpcy4kc2V0Vmlld1ZhbHVlID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLiR2aWV3VmFsdWUgPSB2YWx1ZTsKCiAgICAgICAgLy8gY2hhbmdlIHRvIGRpcnR5CiAgICAgICAgaWYgKHRoaXMuJHByaXN0aW5lKSB7CiAgICAgICAgICB0aGlzLiRkaXJ0eSA9IHRydWU7CiAgICAgICAgICB0aGlzLiRwcmlzdGluZSA9IGZhbHNlOwogICAgICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoJGVsZW1lbnQsIFBSSVNUSU5FX0NMQVNTKTsKICAgICAgICAgICRhbmltYXRlLmFkZENsYXNzKCRlbGVtZW50LCBESVJUWV9DTEFTUyk7CiAgICAgICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgICAgIH0KCiAgICAgICAgZm9yRWFjaCh0aGlzLiRwYXJzZXJzLCBmdW5jdGlvbihmbikgewogICAgICAgICAgdmFsdWUgPSBmbih2YWx1ZSk7CiAgICAgICAgfSk7CgogICAgICAgIGlmICh0aGlzLiRtb2RlbFZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgdGhpcy4kbW9kZWxWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgbmdNb2RlbFNldCgkc2NvcGUsIHZhbHVlKTsKICAgICAgICAgIGZvckVhY2godGhpcy4kdmlld0NoYW5nZUxpc3RlbmVycywgZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBsaXN0ZW5lcigpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgLy8gbW9kZWwgLT4gdmFsdWUKICAgICAgdmFyIGN0cmwgPSB0aGlzOwoKICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbiBuZ01vZGVsV2F0Y2goKSB7CiAgICAgICAgdmFyIHZhbHVlID0gbmdNb2RlbEdldCgkc2NvcGUpOwoKICAgICAgICAvLyBpZiBzY29wZSBtb2RlbCB2YWx1ZSBhbmQgbmdNb2RlbCB2YWx1ZSBhcmUgb3V0IG9mIHN5bmMKICAgICAgICBpZiAoY3RybC4kbW9kZWxWYWx1ZSAhPT0gdmFsdWUpIHsKCiAgICAgICAgICB2YXIgZm9ybWF0dGVycyA9IGN0cmwuJGZvcm1hdHRlcnMsCiAgICAgICAgICAgIGlkeCA9IGZvcm1hdHRlcnMubGVuZ3RoOwoKICAgICAgICAgIGN0cmwuJG1vZGVsVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIHdoaWxlKGlkeC0tKSB7CiAgICAgICAgICAgIHZhbHVlID0gZm9ybWF0dGVyc1tpZHhdKHZhbHVlKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoY3RybC4kdmlld1ZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICBjdHJsLiR2aWV3VmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgY3RybC4kcmVuZGVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0pOwogICAgfV07CgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdNb2RlbAogICAqCiAgICogQGVsZW1lbnQgaW5wdXQKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdNb2RlbGAgZGlyZWN0aXZlIGJpbmRzIGFuIGBpbnB1dGAsYHNlbGVjdGAsIGB0ZXh0YXJlYWAgKG9yIGN1c3RvbSBmb3JtIGNvbnRyb2wpIHRvIGEKICAgKiBwcm9wZXJ0eSBvbiB0aGUgc2NvcGUgdXNpbmcge0BsaW5rIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIgTmdNb2RlbENvbnRyb2xsZXJ9LAogICAqIHdoaWNoIGlzIGNyZWF0ZWQgYW5kIGV4cG9zZWQgYnkgdGhpcyBkaXJlY3RpdmUuCiAgICoKICAgKiBgbmdNb2RlbGAgaXMgcmVzcG9uc2libGUgZm9yOgogICAqCiAgICogLSBCaW5kaW5nIHRoZSB2aWV3IGludG8gdGhlIG1vZGVsLCB3aGljaCBvdGhlciBkaXJlY3RpdmVzIHN1Y2ggYXMgYGlucHV0YCwgYHRleHRhcmVhYCBvciBgc2VsZWN0YAogICAqICAgcmVxdWlyZS4KICAgKiAtIFByb3ZpZGluZyB2YWxpZGF0aW9uIGJlaGF2aW9yIChpLmUuIHJlcXVpcmVkLCBudW1iZXIsIGVtYWlsLCB1cmwpLgogICAqIC0gS2VlcGluZyB0aGUgc3RhdGUgb2YgdGhlIGNvbnRyb2wgKHZhbGlkL2ludmFsaWQsIGRpcnR5L3ByaXN0aW5lLCB2YWxpZGF0aW9uIGVycm9ycykuCiAgICogLSBTZXR0aW5nIHJlbGF0ZWQgY3NzIGNsYXNzZXMgb24gdGhlIGVsZW1lbnQgKGBuZy12YWxpZGAsIGBuZy1pbnZhbGlkYCwgYG5nLWRpcnR5YCwgYG5nLXByaXN0aW5lYCkgaW5jbHVkaW5nIGFuaW1hdGlvbnMuCiAgICogLSBSZWdpc3RlcmluZyB0aGUgY29udHJvbCB3aXRoIGl0cyBwYXJlbnQge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtIGZvcm19LgogICAqCiAgICogTm90ZTogYG5nTW9kZWxgIHdpbGwgdHJ5IHRvIGJpbmQgdG8gdGhlIHByb3BlcnR5IGdpdmVuIGJ5IGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24gb24gdGhlCiAgICogY3VycmVudCBzY29wZS4gSWYgdGhlIHByb3BlcnR5IGRvZXNuJ3QgYWxyZWFkeSBleGlzdCBvbiB0aGlzIHNjb3BlLCBpdCB3aWxsIGJlIGNyZWF0ZWQKICAgKiBpbXBsaWNpdGx5IGFuZCBhZGRlZCB0byB0aGUgc2NvcGUuCiAgICoKICAgKiBGb3IgYmVzdCBwcmFjdGljZXMgb24gdXNpbmcgYG5nTW9kZWxgLCBzZWU6CiAgICoKICAgKiAgLSBbaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy93aWtpL1VuZGVyc3RhbmRpbmctU2NvcGVzXQogICAqCiAgICogRm9yIGJhc2ljIGV4YW1wbGVzLCBob3cgdG8gdXNlIGBuZ01vZGVsYCwgc2VlOgogICAqCiAgICogIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dH0KICAgKiAgICAtIHtAbGluayBpbnB1dFt0ZXh0XSB0ZXh0fQogICAqICAgIC0ge0BsaW5rIGlucHV0W2NoZWNrYm94XSBjaGVja2JveH0KICAgKiAgICAtIHtAbGluayBpbnB1dFtyYWRpb10gcmFkaW99CiAgICogICAgLSB7QGxpbmsgaW5wdXRbbnVtYmVyXSBudW1iZXJ9CiAgICogICAgLSB7QGxpbmsgaW5wdXRbZW1haWxdIGVtYWlsfQogICAqICAgIC0ge0BsaW5rIGlucHV0W3VybF0gdXJsfQogICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0KICAgKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOnRleHRhcmVhIHRleHRhcmVhfQogICAqCiAgICogIyBDU1MgY2xhc3NlcwogICAqIFRoZSBmb2xsb3dpbmcgQ1NTIGNsYXNzZXMgYXJlIGFkZGVkIGFuZCByZW1vdmVkIG9uIHRoZSBhc3NvY2lhdGVkIGlucHV0L3NlbGVjdC90ZXh0YXJlYSBlbGVtZW50CiAgICogZGVwZW5kaW5nIG9uIHRoZSB2YWxpZGl0eSBvZiB0aGUgbW9kZWwuCiAgICoKICAgKiAgLSBgbmctdmFsaWRgIGlzIHNldCBpZiB0aGUgbW9kZWwgaXMgdmFsaWQuCiAgICogIC0gYG5nLWludmFsaWRgIGlzIHNldCBpZiB0aGUgbW9kZWwgaXMgaW52YWxpZC4KICAgKiAgLSBgbmctcHJpc3RpbmVgIGlzIHNldCBpZiB0aGUgbW9kZWwgaXMgcHJpc3RpbmUuCiAgICogIC0gYG5nLWRpcnR5YCBpcyBzZXQgaWYgdGhlIG1vZGVsIGlzIGRpcnR5LgogICAqCiAgICogS2VlcCBpbiBtaW5kIHRoYXQgbmdBbmltYXRlIGNhbiBkZXRlY3QgZWFjaCBvZiB0aGVzZSBjbGFzc2VzIHdoZW4gYWRkZWQgYW5kIHJlbW92ZWQuCiAgICoKICAgKiAjIyBBbmltYXRpb24gSG9va3MKICAgKgogICAqIEFuaW1hdGlvbnMgd2l0aGluIG1vZGVscyBhcmUgdHJpZ2dlcmVkIHdoZW4gYW55IG9mIHRoZSBhc3NvY2lhdGVkIENTUyBjbGFzc2VzIGFyZSBhZGRlZCBhbmQgcmVtb3ZlZAogICAqIG9uIHRoZSBpbnB1dCBlbGVtZW50IHdoaWNoIGlzIGF0dGFjaGVkIHRvIHRoZSBtb2RlbC4gVGhlc2UgY2xhc3NlcyBhcmU6IGAubmctcHJpc3RpbmVgLCBgLm5nLWRpcnR5YCwKICAgKiBgLm5nLWludmFsaWRgIGFuZCBgLm5nLXZhbGlkYCBhcyB3ZWxsIGFzIGFueSBvdGhlciB2YWxpZGF0aW9ucyB0aGF0IGFyZSBwZXJmb3JtZWQgb24gdGhlIG1vZGVsIGl0c2VsZi4KICAgKiBUaGUgYW5pbWF0aW9ucyB0aGF0IGFyZSB0cmlnZ2VyZWQgd2l0aGluIG5nTW9kZWwgYXJlIHNpbWlsYXIgdG8gaG93IHRoZXkgd29yayBpbiBuZ0NsYXNzIGFuZAogICAqIGFuaW1hdGlvbnMgY2FuIGJlIGhvb2tlZCBpbnRvIHVzaW5nIENTUyB0cmFuc2l0aW9ucywga2V5ZnJhbWVzIGFzIHdlbGwgYXMgSlMgYW5pbWF0aW9ucy4KICAgKgogICAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzaG93cyBhIHNpbXBsZSB3YXkgdG8gdXRpbGl6ZSBDU1MgdHJhbnNpdGlvbnMgdG8gc3R5bGUgYW4gaW5wdXQgZWxlbWVudAogICAqIHRoYXQgaGFzIGJlZW4gcmVuZGVyZWQgYXMgaW52YWxpZCBhZnRlciBpdCBoYXMgYmVlbiB2YWxpZGF0ZWQ6CiAgICoKICAgKiA8cHJlPgogICAqIC8vYmUgc3VyZSB0byBpbmNsdWRlIG5nQW5pbWF0ZSBhcyBhIG1vZHVsZSB0byBob29rIGludG8gbW9yZQogICAqIC8vYWR2YW5jZWQgYW5pbWF0aW9ucwogICAqIC5teS1pbnB1dCB7CiAqICAgdHJhbnNpdGlvbjowLjVzIGxpbmVhciBhbGw7CiAqICAgYmFja2dyb3VuZDogd2hpdGU7CiAqIH0KICAgKiAubXktaW5wdXQubmctaW52YWxpZCB7CiAqICAgYmFja2dyb3VuZDogcmVkOwogKiAgIGNvbG9yOndoaXRlOwogKiB9CiAgICogPC9wcmU+CiAgICoKICAgKiBAZXhhbXBsZQogICAqIDxleGFtcGxlIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSIgZml4QmFzZT0idHJ1ZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLnZhbCA9ICcxJzsKICAgICAgICB9CiAgIDwvc2NyaXB0PgogICA8c3R5bGU+CiAgIC5teS1pbnB1dCB7CiAgICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgICB0cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgICBiYWNrZ3JvdW5kOiB0cmFuc3BhcmVudDsKICAgICAgICAgfQogICAubXktaW5wdXQubmctaW52YWxpZCB7CiAgICAgICAgICAgY29sb3I6d2hpdGU7CiAgICAgICAgICAgYmFja2dyb3VuZDogcmVkOwogICAgICAgICB9CiAgIDwvc3R5bGU+CiAgIFVwZGF0ZSBpbnB1dCB0byBzZWUgdHJhbnNpdGlvbnMgd2hlbiB2YWxpZC9pbnZhbGlkLgogICBJbnRlZ2VyIGlzIGEgdmFsaWQgdmFsdWUuCiAgIDxmb3JtIG5hbWU9InRlc3RGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgPGlucHV0IG5nLW1vZGVsPSJ2YWwiIG5nLXBhdHRlcm49Ii9eXGQrJC8iIG5hbWU9ImFuaW0iIGNsYXNzPSJteS1pbnB1dCIgLz4KICAgPC9mb3JtPgogICA8L2ZpbGU+CiAgICogPC9leGFtcGxlPgogICAqLwogIHZhciBuZ01vZGVsRGlyZWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICByZXF1aXJlOiBbJ25nTW9kZWwnLCAnXj9mb3JtJ10sCiAgICAgIGNvbnRyb2xsZXI6IE5nTW9kZWxDb250cm9sbGVyLAogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybHMpIHsKICAgICAgICAvLyBub3RpZnkgb3RoZXJzLCBlc3BlY2lhbGx5IHBhcmVudCBmb3JtcwoKICAgICAgICB2YXIgbW9kZWxDdHJsID0gY3RybHNbMF0sCiAgICAgICAgICBmb3JtQ3RybCA9IGN0cmxzWzFdIHx8IG51bGxGb3JtQ3RybDsKCiAgICAgICAgZm9ybUN0cmwuJGFkZENvbnRyb2wobW9kZWxDdHJsKTsKCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZm9ybUN0cmwuJHJlbW92ZUNvbnRyb2wobW9kZWxDdHJsKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICB9OwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nQ2hhbmdlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBFdmFsdWF0ZSB0aGUgZ2l2ZW4gZXhwcmVzc2lvbiB3aGVuIHRoZSB1c2VyIGNoYW5nZXMgdGhlIGlucHV0LgogICAqIFRoZSBleHByZXNzaW9uIGlzIGV2YWx1YXRlZCBpbW1lZGlhdGVseSwgdW5saWtlIHRoZSBKYXZhU2NyaXB0IG9uY2hhbmdlIGV2ZW50CiAgICogd2hpY2ggb25seSB0cmlnZ2VycyBhdCB0aGUgZW5kIG9mIGEgY2hhbmdlICh1c3VhbGx5LCB3aGVuIHRoZSB1c2VyIGxlYXZlcyB0aGUKICAgKiBmb3JtIGVsZW1lbnQgb3IgcHJlc3NlcyB0aGUgcmV0dXJuIGtleSkuCiAgICogVGhlIGV4cHJlc3Npb24gaXMgbm90IGV2YWx1YXRlZCB3aGVuIHRoZSB2YWx1ZSBjaGFuZ2UgaXMgY29taW5nIGZyb20gdGhlIG1vZGVsLgogICAqCiAgICogTm90ZSwgdGhpcyBkaXJlY3RpdmUgcmVxdWlyZXMgYG5nTW9kZWxgIHRvIGJlIHByZXNlbnQuCiAgICoKICAgKiBAZWxlbWVudCBpbnB1dAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDaGFuZ2Uge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbiBjaGFuZ2UKICAgKiBpbiBpbnB1dCB2YWx1ZS4KICAgKgogICAqIEBleGFtcGxlCiAgICogPGV4YW1wbGUgbmFtZT0ibmdDaGFuZ2UtZGlyZWN0aXZlIj4KICAgKiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAqICAgICA8c2NyaXB0PgogICAqICAgICAgIGZ1bmN0aW9uIENvbnRyb2xsZXIoJHNjb3BlKSB7CiAqICAgICAgICAgJHNjb3BlLmNvdW50ZXIgPSAwOwogKiAgICAgICAgICRzY29wZS5jaGFuZ2UgPSBmdW5jdGlvbigpIHsKICogICAgICAgICAgICRzY29wZS5jb3VudGVyKys7CiAqICAgICAgICAgfTsKICogICAgICAgfQogICAqICAgICA8L3NjcmlwdD4KICAgKiAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDb250cm9sbGVyIj4KICAgKiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjb25maXJtZWQiIG5nLWNoYW5nZT0iY2hhbmdlKCkiIGlkPSJuZy1jaGFuZ2UtZXhhbXBsZTEiIC8+CiAgICogICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY29uZmlybWVkIiBpZD0ibmctY2hhbmdlLWV4YW1wbGUyIiAvPgogICAqICAgICAgIDxsYWJlbCBmb3I9Im5nLWNoYW5nZS1leGFtcGxlMiI+Q29uZmlybWVkPC9sYWJlbD48YnIgLz4KICAgKiAgICAgICA8dHQ+ZGVidWcgPSB7e2NvbmZpcm1lZH19PC90dD48YnIvPgogICAqICAgICAgIDx0dD5jb3VudGVyID0ge3tjb3VudGVyfX08L3R0Pjxici8+CiAgICogICAgIDwvZGl2PgogICAqICAgPC9maWxlPgogICAqICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICogICAgIHZhciBjb3VudGVyID0gZWxlbWVudChieS5iaW5kaW5nKCdjb3VudGVyJykpOwogICAqICAgICB2YXIgZGVidWcgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ2NvbmZpcm1lZCcpKTsKICAgKgogICAqICAgICBpdCgnc2hvdWxkIGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gdmlldycsIGZ1bmN0aW9uKCkgewogKiAgICAgICBleHBlY3QoY291bnRlci5nZXRUZXh0KCkpLnRvQ29udGFpbignMCcpOwogKgogKiAgICAgICBlbGVtZW50KGJ5LmlkKCduZy1jaGFuZ2UtZXhhbXBsZTEnKSkuY2xpY2soKTsKICoKICogICAgICAgZXhwZWN0KGNvdW50ZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzEnKTsKICogICAgICAgZXhwZWN0KGRlYnVnLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAqICAgICB9KTsKICAgKgogICAqICAgICBpdCgnc2hvdWxkIG5vdCBldmFsdWF0ZSB0aGUgZXhwcmVzc2lvbiBpZiBjaGFuZ2luZyBmcm9tIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAqICAgICAgIGVsZW1lbnQoYnkuaWQoJ25nLWNoYW5nZS1leGFtcGxlMicpKS5jbGljaygpOwoKICogICAgICAgZXhwZWN0KGNvdW50ZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzAnKTsKICogICAgICAgZXhwZWN0KGRlYnVnLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAqICAgICB9KTsKICAgKiAgIDwvZmlsZT4KICAgKiA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nQ2hhbmdlRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICBjdHJsLiR2aWV3Q2hhbmdlTGlzdGVuZXJzLnB1c2goZnVuY3Rpb24oKSB7CiAgICAgICAgc2NvcGUuJGV2YWwoYXR0ci5uZ0NoYW5nZSk7CiAgICAgIH0pOwogICAgfQogIH0pOwoKCiAgdmFyIHJlcXVpcmVkRGlyZWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxtLCBhdHRyLCBjdHJsKSB7CiAgICAgICAgaWYgKCFjdHJsKSByZXR1cm47CiAgICAgICAgYXR0ci5yZXF1aXJlZCA9IHRydWU7IC8vIGZvcmNlIHRydXRoeSBpbiBjYXNlIHdlIGFyZSBvbiBub24gaW5wdXQgZWxlbWVudAoKICAgICAgICB2YXIgdmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmIChhdHRyLnJlcXVpcmVkICYmIGN0cmwuJGlzRW1wdHkodmFsdWUpKSB7CiAgICAgICAgICAgIGN0cmwuJHNldFZhbGlkaXR5KCdyZXF1aXJlZCcsIGZhbHNlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3JlcXVpcmVkJywgdHJ1ZSk7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2godmFsaWRhdG9yKTsKICAgICAgICBjdHJsLiRwYXJzZXJzLnVuc2hpZnQodmFsaWRhdG9yKTsKCiAgICAgICAgYXR0ci4kb2JzZXJ2ZSgncmVxdWlyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhbGlkYXRvcihjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogIH07CgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdMaXN0CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUZXh0IGlucHV0IHRoYXQgY29udmVydHMgYmV0d2VlbiBhIGRlbGltaXRlZCBzdHJpbmcgYW5kIGFuIGFycmF5IG9mIHN0cmluZ3MuIFRoZSBkZWxpbWl0ZXIKICAgKiBjYW4gYmUgYSBmaXhlZCBzdHJpbmcgKGJ5IGRlZmF1bHQgYSBjb21tYSkgb3IgYSByZWd1bGFyIGV4cHJlc3Npb24uCiAgICoKICAgKiBAZWxlbWVudCBpbnB1dAogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdMaXN0IG9wdGlvbmFsIGRlbGltaXRlciB0aGF0IHNob3VsZCBiZSB1c2VkIHRvIHNwbGl0IHRoZSB2YWx1ZS4gSWYKICAgKiAgIHNwZWNpZmllZCBpbiBmb3JtIGAvc29tZXRoaW5nL2AgdGhlbiB0aGUgdmFsdWUgd2lsbCBiZSBjb252ZXJ0ZWQgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG5hbWU9Im5nTGlzdC1kaXJlY3RpdmUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubmFtZXMgPSBbJ2lnb3InLCAnbWlza28nLCAndm9qdGEnXTsKICAgICAgICAgfQogICA8L3NjcmlwdD4KICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgTGlzdDogPGlucHV0IG5hbWU9Im5hbWVzSW5wdXQiIG5nLW1vZGVsPSJuYW1lcyIgbmctbGlzdCByZXF1aXJlZD4KICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0ubmFtZXNJbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICBSZXF1aXJlZCE8L3NwYW4+CiAgIDxicj4KICAgPHR0Pm5hbWVzID0ge3tuYW1lc319PC90dD48YnIvPgogICA8dHQ+bXlGb3JtLm5hbWVzSW5wdXQuJHZhbGlkID0ge3tteUZvcm0ubmFtZXNJbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgPHR0Pm15Rm9ybS5uYW1lc0lucHV0LiRlcnJvciA9IHt7bXlGb3JtLm5hbWVzSW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgPC9mb3JtPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICB2YXIgbGlzdElucHV0ID0gZWxlbWVudChieS5tb2RlbCgnbmFtZXMnKSk7CiAgIHZhciBuYW1lcyA9IGVsZW1lbnQoYnkuYmluZGluZygne3tuYW1lc319JykpOwogICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZCcpKTsKICAgdmFyIGVycm9yID0gZWxlbWVudChieS5jc3MoJ3NwYW4uZXJyb3InKSk7CgogICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChuYW1lcy5nZXRUZXh0KCkpLnRvQ29udGFpbignWyJpZ29yIiwibWlza28iLCJ2b2p0YSJdJyk7CiAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIGV4cGVjdChlcnJvci5nZXRDc3NWYWx1ZSgnZGlzcGxheScpKS50b0JlKCdub25lJyk7CiAgICAgICAgfSk7CgogICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGxpc3RJbnB1dC5jbGVhcigpOwogICAgICAgICAgbGlzdElucHV0LnNlbmRLZXlzKCcnKTsKCiAgICAgICAgICBleHBlY3QobmFtZXMuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJycpOwogICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGVycm9yLmdldENzc1ZhbHVlKCdkaXNwbGF5JykpLm5vdC50b0JlKCdub25lJyk7ICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nTGlzdERpcmVjdGl2ZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLAogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgICAgIHZhciBtYXRjaCA9IC9cLyguKilcLy8uZXhlYyhhdHRyLm5nTGlzdCksCiAgICAgICAgICBzZXBhcmF0b3IgPSBtYXRjaCAmJiBuZXcgUmVnRXhwKG1hdGNoWzFdKSB8fCBhdHRyLm5nTGlzdCB8fCAnLCc7CgogICAgICAgIHZhciBwYXJzZSA9IGZ1bmN0aW9uKHZpZXdWYWx1ZSkgewogICAgICAgICAgLy8gSWYgdGhlIHZpZXdWYWx1ZSBpcyBpbnZhbGlkIChzYXkgcmVxdWlyZWQgYnV0IGVtcHR5KSBpdCB3aWxsIGJlIGB1bmRlZmluZWRgCiAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmlld1ZhbHVlKSkgcmV0dXJuOwoKICAgICAgICAgIHZhciBsaXN0ID0gW107CgogICAgICAgICAgaWYgKHZpZXdWYWx1ZSkgewogICAgICAgICAgICBmb3JFYWNoKHZpZXdWYWx1ZS5zcGxpdChzZXBhcmF0b3IpLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGlmICh2YWx1ZSkgbGlzdC5wdXNoKHRyaW0odmFsdWUpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGxpc3Q7CiAgICAgICAgfTsKCiAgICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKHBhcnNlKTsKICAgICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWUuam9pbignLCAnKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0pOwoKICAgICAgICAvLyBPdmVycmlkZSB0aGUgc3RhbmRhcmQgJGlzRW1wdHkgYmVjYXVzZSBhbiBlbXB0eSBhcnJheSBtZWFucyB0aGUgaW5wdXQgaXMgZW1wdHkuCiAgICAgICAgY3RybC4kaXNFbXB0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIXZhbHVlIHx8ICF2YWx1ZS5sZW5ndGg7CiAgICAgICAgfTsKICAgICAgfQogICAgfTsKICB9OwoKCiAgdmFyIENPTlNUQU5UX1ZBTFVFX1JFR0VYUCA9IC9eKHRydWV8ZmFsc2V8XGQrKSQvOwogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ1ZhbHVlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBCaW5kcyB0aGUgZ2l2ZW4gZXhwcmVzc2lvbiB0byB0aGUgdmFsdWUgb2YgYGlucHV0W3NlbGVjdF1gIG9yIGBpbnB1dFtyYWRpb11gLCBzbwogICAqIHRoYXQgd2hlbiB0aGUgZWxlbWVudCBpcyBzZWxlY3RlZCwgdGhlIGBuZ01vZGVsYCBvZiB0aGF0IGVsZW1lbnQgaXMgc2V0IHRvIHRoZQogICAqIGJvdW5kIHZhbHVlLgogICAqCiAgICogYG5nVmFsdWVgIGlzIHVzZWZ1bCB3aGVuIGR5bmFtaWNhbGx5IGdlbmVyYXRpbmcgbGlzdHMgb2YgcmFkaW8gYnV0dG9ucyB1c2luZyBgbmctcmVwZWF0YCwgYXMKICAgKiBzaG93biBiZWxvdy4KICAgKgogICAqIEBlbGVtZW50IGlucHV0CiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1ZhbHVlIGFuZ3VsYXIgZXhwcmVzc2lvbiwgd2hvc2UgdmFsdWUgd2lsbCBiZSBib3VuZCB0byB0aGUgYHZhbHVlYCBhdHRyaWJ1dGUKICAgKiAgIG9mIHRoZSBgaW5wdXRgIGVsZW1lbnQKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG5hbWU9Im5nVmFsdWUtZGlyZWN0aXZlIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS5uYW1lcyA9IFsncGl6emEnLCAndW5pY29ybnMnLCAncm9ib3RzJ107CiAgICAgICAgICAgICRzY29wZS5teSA9IHsgZmF2b3JpdGU6ICd1bmljb3JucycgfTsKICAgICAgICAgIH0KICAgPC9zY3JpcHQ+CiAgIDxmb3JtIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICA8aDI+V2hpY2ggaXMgeW91ciBmYXZvcml0ZT88L2gyPgogICA8bGFiZWwgbmctcmVwZWF0PSJuYW1lIGluIG5hbWVzIiBmb3I9Int7bmFtZX19Ij4KICAge3tuYW1lfX0KICAgPGlucHV0IHR5cGU9InJhZGlvIgogICBuZy1tb2RlbD0ibXkuZmF2b3JpdGUiCiAgIG5nLXZhbHVlPSJuYW1lIgogICBpZD0ie3tuYW1lfX0iCiAgIG5hbWU9ImZhdm9yaXRlIj4KICAgPC9sYWJlbD4KICAgPGRpdj5Zb3UgY2hvc2Uge3tteS5mYXZvcml0ZX19PC9kaXY+CiAgIDwvZm9ybT4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgdmFyIGZhdm9yaXRlID0gZWxlbWVudChieS5iaW5kaW5nKCdteS5mYXZvcml0ZScpKTsKCiAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGZhdm9yaXRlLmdldFRleHQoKSkudG9Db250YWluKCd1bmljb3JucycpOwogICAgICAgIH0pOwogICBpdCgnc2hvdWxkIGJpbmQgdGhlIHZhbHVlcyB0byB0aGUgaW5wdXRzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50LmFsbChieS5tb2RlbCgnbXkuZmF2b3JpdGUnKSkuZ2V0KDApLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZmF2b3JpdGUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3BpenphJyk7CiAgICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIHZhciBuZ1ZhbHVlRGlyZWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICBwcmlvcml0eTogMTAwLAogICAgICBjb21waWxlOiBmdW5jdGlvbih0cGwsIHRwbEF0dHIpIHsKICAgICAgICBpZiAoQ09OU1RBTlRfVkFMVUVfUkVHRVhQLnRlc3QodHBsQXR0ci5uZ1ZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIG5nVmFsdWVDb25zdGFudExpbmsoc2NvcGUsIGVsbSwgYXR0cikgewogICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgc2NvcGUuJGV2YWwoYXR0ci5uZ1ZhbHVlKSk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gbmdWYWx1ZUxpbmsoc2NvcGUsIGVsbSwgYXR0cikgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1ZhbHVlLCBmdW5jdGlvbiB2YWx1ZVdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdCaW5kCiAgICogQHJlc3RyaWN0IEFDCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgYG5nQmluZGAgYXR0cmlidXRlIHRlbGxzIEFuZ3VsYXIgdG8gcmVwbGFjZSB0aGUgdGV4dCBjb250ZW50IG9mIHRoZSBzcGVjaWZpZWQgSFRNTCBlbGVtZW50CiAgICogd2l0aCB0aGUgdmFsdWUgb2YgYSBnaXZlbiBleHByZXNzaW9uLCBhbmQgdG8gdXBkYXRlIHRoZSB0ZXh0IGNvbnRlbnQgd2hlbiB0aGUgdmFsdWUgb2YgdGhhdAogICAqIGV4cHJlc3Npb24gY2hhbmdlcy4KICAgKgogICAqIFR5cGljYWxseSwgeW91IGRvbid0IHVzZSBgbmdCaW5kYCBkaXJlY3RseSwgYnV0IGluc3RlYWQgeW91IHVzZSB0aGUgZG91YmxlIGN1cmx5IG1hcmt1cCBsaWtlCiAgICogYHt7IGV4cHJlc3Npb24gfX1gIHdoaWNoIGlzIHNpbWlsYXIgYnV0IGxlc3MgdmVyYm9zZS4KICAgKgogICAqIEl0IGlzIHByZWZlcmFibGUgdG8gdXNlIGBuZ0JpbmRgIGluc3RlYWQgb2YgYHt7IGV4cHJlc3Npb24gfX1gIHdoZW4gYSB0ZW1wbGF0ZSBpcyBtb21lbnRhcmlseQogICAqIGRpc3BsYXllZCBieSB0aGUgYnJvd3NlciBpbiBpdHMgcmF3IHN0YXRlIGJlZm9yZSBBbmd1bGFyIGNvbXBpbGVzIGl0LiBTaW5jZSBgbmdCaW5kYCBpcyBhbgogICAqIGVsZW1lbnQgYXR0cmlidXRlLCBpdCBtYWtlcyB0aGUgYmluZGluZ3MgaW52aXNpYmxlIHRvIHRoZSB1c2VyIHdoaWxlIHRoZSBwYWdlIGlzIGxvYWRpbmcuCiAgICoKICAgKiBBbiBhbHRlcm5hdGl2ZSBzb2x1dGlvbiB0byB0aGlzIHByb2JsZW0gd291bGQgYmUgdXNpbmcgdGhlCiAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Nsb2FrIG5nQ2xvYWt9IGRpcmVjdGl2ZS4KICAgKgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0JpbmQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIEVudGVyIGEgbmFtZSBpbiB0aGUgTGl2ZSBQcmV2aWV3IHRleHQgYm94OyB0aGUgZ3JlZXRpbmcgYmVsb3cgdGhlIHRleHQgYm94IGNoYW5nZXMgaW5zdGFudGx5LgogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLm5hbWUgPSAnV2hpcmxlZCc7CiAgICAgICAgIH0KICAgPC9zY3JpcHQ+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIEVudGVyIG5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSI+PGJyPgogICBIZWxsbyA8c3BhbiBuZy1iaW5kPSJuYW1lIj48L3NwYW4+IQogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1iaW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBuYW1lSW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCduYW1lJykpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnbmFtZScpKS5nZXRUZXh0KCkpLnRvQmUoJ1doaXJsZWQnKTsKICAgICAgICAgbmFtZUlucHV0LmNsZWFyKCk7CiAgICAgICAgIG5hbWVJbnB1dC5zZW5kS2V5cygnd29ybGQnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnbmFtZScpKS5nZXRUZXh0KCkpLnRvQmUoJ3dvcmxkJyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nQmluZERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICBlbGVtZW50LmFkZENsYXNzKCduZy1iaW5kaW5nJykuZGF0YSgnJGJpbmRpbmcnLCBhdHRyLm5nQmluZCk7CiAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ0JpbmQsIGZ1bmN0aW9uIG5nQmluZFdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgIC8vIFdlIGFyZSBwdXJwb3NlZnVsbHkgdXNpbmcgPT0gaGVyZSByYXRoZXIgdGhhbiA9PT0gYmVjYXVzZSB3ZSB3YW50IHRvCiAgICAgIC8vIGNhdGNoIHdoZW4gdmFsdWUgaXMgIm51bGwgb3IgdW5kZWZpbmVkIgogICAgICAvLyBqc2hpbnQgLVcwNDEKICAgICAgZWxlbWVudC50ZXh0KHZhbHVlID09IHVuZGVmaW5lZCA/ICcnIDogdmFsdWUpOwogICAgfSk7CiAgfSk7CgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdCaW5kVGVtcGxhdGUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdCaW5kVGVtcGxhdGVgIGRpcmVjdGl2ZSBzcGVjaWZpZXMgdGhhdCB0aGUgZWxlbWVudAogICAqIHRleHQgY29udGVudCBzaG91bGQgYmUgcmVwbGFjZWQgd2l0aCB0aGUgaW50ZXJwb2xhdGlvbiBvZiB0aGUgdGVtcGxhdGUKICAgKiBpbiB0aGUgYG5nQmluZFRlbXBsYXRlYCBhdHRyaWJ1dGUuCiAgICogVW5saWtlIGBuZ0JpbmRgLCB0aGUgYG5nQmluZFRlbXBsYXRlYCBjYW4gY29udGFpbiBtdWx0aXBsZSBge3tgIGB9fWAKICAgKiBleHByZXNzaW9ucy4gVGhpcyBkaXJlY3RpdmUgaXMgbmVlZGVkIHNpbmNlIHNvbWUgSFRNTCBlbGVtZW50cwogICAqIChzdWNoIGFzIFRJVExFIGFuZCBPUFRJT04pIGNhbm5vdCBjb250YWluIFNQQU4gZWxlbWVudHMuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcGFyYW0ge3N0cmluZ30gbmdCaW5kVGVtcGxhdGUgdGVtcGxhdGUgb2YgZm9ybQogICAqICAgPHR0Pnt7PC90dD4gPHR0PmV4cHJlc3Npb248L3R0PiA8dHQ+fX08L3R0PiB0byBldmFsLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBUcnkgaXQgaGVyZTogZW50ZXIgdGV4dCBpbiB0ZXh0IGJveCBhbmQgd2F0Y2ggdGhlIGdyZWV0aW5nIGNoYW5nZS4KICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5zYWx1dGF0aW9uID0gJ0hlbGxvJzsKICAgICAgICAgICAkc2NvcGUubmFtZSA9ICdXb3JsZCc7CiAgICAgICAgIH0KICAgPC9zY3JpcHQ+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIFNhbHV0YXRpb246IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ic2FsdXRhdGlvbiI+PGJyPgogICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiPjxicj4KICAgPHByZSBuZy1iaW5kLXRlbXBsYXRlPSJ7e3NhbHV0YXRpb259fSB7e25hbWV9fSEiPjwvcHJlPgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1iaW5kJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBzYWx1dGF0aW9uRWxlbSA9IGVsZW1lbnQoYnkuYmluZGluZygnc2FsdXRhdGlvbicpKTsKICAgICAgICAgdmFyIHNhbHV0YXRpb25JbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3NhbHV0YXRpb24nKSk7CiAgICAgICAgIHZhciBuYW1lSW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCduYW1lJykpOwoKICAgICAgICAgZXhwZWN0KHNhbHV0YXRpb25FbGVtLmdldFRleHQoKSkudG9CZSgnSGVsbG8gV29ybGQhJyk7CgogICAgICAgICBzYWx1dGF0aW9uSW5wdXQuY2xlYXIoKTsKICAgICAgICAgc2FsdXRhdGlvbklucHV0LnNlbmRLZXlzKCdHcmVldGluZ3MnKTsKICAgICAgICAgbmFtZUlucHV0LmNsZWFyKCk7CiAgICAgICAgIG5hbWVJbnB1dC5zZW5kS2V5cygndXNlcicpOwoKICAgICAgICAgZXhwZWN0KHNhbHV0YXRpb25FbGVtLmdldFRleHQoKSkudG9CZSgnR3JlZXRpbmdzIHVzZXIhJyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nQmluZFRlbXBsYXRlRGlyZWN0aXZlID0gWyckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbigkaW50ZXJwb2xhdGUpIHsKICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAvLyBUT0RPOiBtb3ZlIHRoaXMgdG8gc2NlbmFyaW8gcnVubmVyCiAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyLm5nQmluZFRlbXBsYXRlKSk7CiAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGludGVycG9sYXRlRm4pOwogICAgICBhdHRyLiRvYnNlcnZlKCduZ0JpbmRUZW1wbGF0ZScsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgZWxlbWVudC50ZXh0KHZhbHVlKTsKICAgICAgfSk7CiAgICB9OwogIH1dOwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nQmluZEh0bWwKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSBiaW5kaW5nIHRoYXQgd2lsbCBpbm5lckhUTUwgdGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBgZXhwcmVzc2lvbmAgaW50byB0aGUgY3VycmVudAogICAqIGVsZW1lbnQgaW4gYSBzZWN1cmUgd2F5LiAgQnkgZGVmYXVsdCwgdGhlIGlubmVySFRNTC1lZCBjb250ZW50IHdpbGwgYmUgc2FuaXRpemVkIHVzaW5nIHRoZSB7QGxpbmsKICAgICogbmdTYW5pdGl6ZS4kc2FuaXRpemUgJHNhbml0aXplfSBzZXJ2aWNlLiAgVG8gdXRpbGl6ZSB0aGlzIGZ1bmN0aW9uYWxpdHksIGVuc3VyZSB0aGF0IGAkc2FuaXRpemVgCiAgICogaXMgYXZhaWxhYmxlLCBmb3IgZXhhbXBsZSwgYnkgaW5jbHVkaW5nIHtAbGluayBuZ1Nhbml0aXplfSBpbiB5b3VyIG1vZHVsZSdzIGRlcGVuZGVuY2llcyAobm90IGluCiAgICogY29yZSBBbmd1bGFyLikgIFlvdSBtYXkgYWxzbyBieXBhc3Mgc2FuaXRpemF0aW9uIGZvciB2YWx1ZXMgeW91IGtub3cgYXJlIHNhZmUuIFRvIGRvIHNvLCBiaW5kIHRvCiAgICogYW4gZXhwbGljaXRseSB0cnVzdGVkIHZhbHVlIHZpYSB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzSHRtbCAkc2NlLnRydXN0QXNIdG1sfS4gIFNlZSB0aGUgZXhhbXBsZQogICAqIHVuZGVyIHtAbGluayBuZy4kc2NlI0V4YW1wbGUgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSl9LgogICAqCiAgICogTm90ZTogSWYgYSBgJHNhbml0aXplYCBzZXJ2aWNlIGlzIHVuYXZhaWxhYmxlIGFuZCB0aGUgYm91bmQgdmFsdWUgaXNuJ3QgZXhwbGljaXRseSB0cnVzdGVkLCB5b3UKICAgKiB3aWxsIGhhdmUgYW4gZXhjZXB0aW9uIChpbnN0ZWFkIG9mIGFuIGV4cGxvaXQuKQogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0JpbmRIdG1sIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlLgogICAqCiAgICogQGV4YW1wbGUKICAgVHJ5IGl0IGhlcmU6IGVudGVyIHRleHQgaW4gdGV4dCBib3ggYW5kIHdhdGNoIHRoZSBncmVldGluZyBjaGFuZ2UuCgogICA8ZXhhbXBsZSBtb2R1bGU9Im5nQmluZEh0bWxFeGFtcGxlIiBkZXBzPSJhbmd1bGFyLXNhbml0aXplLmpzIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctY29udHJvbGxlcj0ibmdCaW5kSHRtbEN0cmwiPgogICA8cCBuZy1iaW5kLWh0bWw9Im15SFRNTCI+PC9wPgogICA8L2Rpdj4KICAgPC9maWxlPgoKICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgYW5ndWxhci5tb2R1bGUoJ25nQmluZEh0bWxFeGFtcGxlJywgWyduZ1Nhbml0aXplJ10pCgogICAuY29udHJvbGxlcignbmdCaW5kSHRtbEN0cmwnLCBbJyRzY29wZScsIGZ1bmN0aW9uIG5nQmluZEh0bWxDdHJsKCRzY29wZSkgewogICAgICAgICAkc2NvcGUubXlIVE1MID0KICAgICAgICAgICAgJ0kgYW0gYW4gPGNvZGU+SFRNTDwvY29kZT5zdHJpbmcgd2l0aCA8YSBocmVmPSIjIj5saW5rcyE8L2E+IGFuZCBvdGhlciA8ZW0+c3R1ZmY8L2VtPic7CiAgICAgICB9XSk7CiAgIDwvZmlsZT4KCiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQtaHRtbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdteUhUTUwnKSkuZ2V0VGV4dCgpKS50b0JlKAogICAgICAgICAgICAgJ0kgYW0gYW4gSFRNTHN0cmluZyB3aXRoIGxpbmtzISBhbmQgb3RoZXIgc3R1ZmYnKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICB2YXIgbmdCaW5kSHRtbERpcmVjdGl2ZSA9IFsnJHNjZScsICckcGFyc2UnLCBmdW5jdGlvbigkc2NlLCAkcGFyc2UpIHsKICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICBlbGVtZW50LmFkZENsYXNzKCduZy1iaW5kaW5nJykuZGF0YSgnJGJpbmRpbmcnLCBhdHRyLm5nQmluZEh0bWwpOwoKICAgICAgdmFyIHBhcnNlZCA9ICRwYXJzZShhdHRyLm5nQmluZEh0bWwpOwogICAgICBmdW5jdGlvbiBnZXRTdHJpbmdWYWx1ZSgpIHsgcmV0dXJuIChwYXJzZWQoc2NvcGUpIHx8ICcnKS50b1N0cmluZygpOyB9CgogICAgICBzY29wZS4kd2F0Y2goZ2V0U3RyaW5nVmFsdWUsIGZ1bmN0aW9uIG5nQmluZEh0bWxXYXRjaEFjdGlvbih2YWx1ZSkgewogICAgICAgIGVsZW1lbnQuaHRtbCgkc2NlLmdldFRydXN0ZWRIdG1sKHBhcnNlZChzY29wZSkpIHx8ICcnKTsKICAgICAgfSk7CiAgICB9OwogIH1dOwoKICBmdW5jdGlvbiBjbGFzc0RpcmVjdGl2ZShuYW1lLCBzZWxlY3RvcikgewogICAgbmFtZSA9ICduZ0NsYXNzJyArIG5hbWU7CiAgICByZXR1cm4gWyckYW5pbWF0ZScsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdBQycsCiAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIHZhciBvbGRWYWw7CgogICAgICAgICAgc2NvcGUuJHdhdGNoKGF0dHJbbmFtZV0sIG5nQ2xhc3NXYXRjaEFjdGlvbiwgdHJ1ZSk7CgogICAgICAgICAgYXR0ci4kb2JzZXJ2ZSgnY2xhc3MnLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBuZ0NsYXNzV2F0Y2hBY3Rpb24oc2NvcGUuJGV2YWwoYXR0cltuYW1lXSkpOwogICAgICAgICAgfSk7CgoKICAgICAgICAgIGlmIChuYW1lICE9PSAnbmdDbGFzcycpIHsKICAgICAgICAgICAgc2NvcGUuJHdhdGNoKCckaW5kZXgnLCBmdW5jdGlvbigkaW5kZXgsIG9sZCRpbmRleCkgewogICAgICAgICAgICAgIC8vIGpzaGludCBiaXR3aXNlOiBmYWxzZQogICAgICAgICAgICAgIHZhciBtb2QgPSAkaW5kZXggJiAxOwogICAgICAgICAgICAgIGlmIChtb2QgIT09IChvbGQkaW5kZXggJiAxKSkgewogICAgICAgICAgICAgICAgdmFyIGNsYXNzZXMgPSBhcnJheUNsYXNzZXMoc2NvcGUuJGV2YWwoYXR0cltuYW1lXSkpOwogICAgICAgICAgICAgICAgbW9kID09PSBzZWxlY3RvciA/CiAgICAgICAgICAgICAgICAgIGFkZENsYXNzZXMoY2xhc3NlcykgOgogICAgICAgICAgICAgICAgICByZW1vdmVDbGFzc2VzKGNsYXNzZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gYWRkQ2xhc3NlcyhjbGFzc2VzKSB7CiAgICAgICAgICAgIHZhciBuZXdDbGFzc2VzID0gZGlnZXN0Q2xhc3NDb3VudHMoY2xhc3NlcywgMSk7CiAgICAgICAgICAgIGF0dHIuJGFkZENsYXNzKG5ld0NsYXNzZXMpOwogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNsYXNzZXMoY2xhc3NlcykgewogICAgICAgICAgICB2YXIgbmV3Q2xhc3NlcyA9IGRpZ2VzdENsYXNzQ291bnRzKGNsYXNzZXMsIC0xKTsKICAgICAgICAgICAgYXR0ci4kcmVtb3ZlQ2xhc3MobmV3Q2xhc3Nlcyk7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gZGlnZXN0Q2xhc3NDb3VudHMgKGNsYXNzZXMsIGNvdW50KSB7CiAgICAgICAgICAgIHZhciBjbGFzc0NvdW50cyA9IGVsZW1lbnQuZGF0YSgnJGNsYXNzQ291bnRzJykgfHwge307CiAgICAgICAgICAgIHZhciBjbGFzc2VzVG9VcGRhdGUgPSBbXTsKICAgICAgICAgICAgZm9yRWFjaChjbGFzc2VzLCBmdW5jdGlvbiAoY2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgaWYgKGNvdW50ID4gMCB8fCBjbGFzc0NvdW50c1tjbGFzc05hbWVdKSB7CiAgICAgICAgICAgICAgICBjbGFzc0NvdW50c1tjbGFzc05hbWVdID0gKGNsYXNzQ291bnRzW2NsYXNzTmFtZV0gfHwgMCkgKyBjb3VudDsKICAgICAgICAgICAgICAgIGlmIChjbGFzc0NvdW50c1tjbGFzc05hbWVdID09PSArKGNvdW50ID4gMCkpIHsKICAgICAgICAgICAgICAgICAgY2xhc3Nlc1RvVXBkYXRlLnB1c2goY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBlbGVtZW50LmRhdGEoJyRjbGFzc0NvdW50cycsIGNsYXNzQ291bnRzKTsKICAgICAgICAgICAgcmV0dXJuIGNsYXNzZXNUb1VwZGF0ZS5qb2luKCcgJyk7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2xhc3NlcyAob2xkQ2xhc3NlcywgbmV3Q2xhc3NlcykgewogICAgICAgICAgICB2YXIgdG9BZGQgPSBhcnJheURpZmZlcmVuY2UobmV3Q2xhc3Nlcywgb2xkQ2xhc3Nlcyk7CiAgICAgICAgICAgIHZhciB0b1JlbW92ZSA9IGFycmF5RGlmZmVyZW5jZShvbGRDbGFzc2VzLCBuZXdDbGFzc2VzKTsKICAgICAgICAgICAgdG9SZW1vdmUgPSBkaWdlc3RDbGFzc0NvdW50cyh0b1JlbW92ZSwgLTEpOwogICAgICAgICAgICB0b0FkZCA9IGRpZ2VzdENsYXNzQ291bnRzKHRvQWRkLCAxKTsKCiAgICAgICAgICAgIGlmICh0b0FkZC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCB0b1JlbW92ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodG9SZW1vdmUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgdG9BZGQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICRhbmltYXRlLnNldENsYXNzKGVsZW1lbnQsIHRvQWRkLCB0b1JlbW92ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBuZ0NsYXNzV2F0Y2hBY3Rpb24obmV3VmFsKSB7CiAgICAgICAgICAgIGlmIChzZWxlY3RvciA9PT0gdHJ1ZSB8fCBzY29wZS4kaW5kZXggJSAyID09PSBzZWxlY3RvcikgewogICAgICAgICAgICAgIHZhciBuZXdDbGFzc2VzID0gYXJyYXlDbGFzc2VzKG5ld1ZhbCB8fCBbXSk7CiAgICAgICAgICAgICAgaWYgKCFvbGRWYWwpIHsKICAgICAgICAgICAgICAgIGFkZENsYXNzZXMobmV3Q2xhc3Nlcyk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghZXF1YWxzKG5ld1ZhbCxvbGRWYWwpKSB7CiAgICAgICAgICAgICAgICB2YXIgb2xkQ2xhc3NlcyA9IGFycmF5Q2xhc3NlcyhvbGRWYWwpOwogICAgICAgICAgICAgICAgdXBkYXRlQ2xhc3NlcyhvbGRDbGFzc2VzLCBuZXdDbGFzc2VzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb2xkVmFsID0gc2hhbGxvd0NvcHkobmV3VmFsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CgogICAgICBmdW5jdGlvbiBhcnJheURpZmZlcmVuY2UodG9rZW5zMSwgdG9rZW5zMikgewogICAgICAgIHZhciB2YWx1ZXMgPSBbXTsKCiAgICAgICAgb3V0ZXI6CiAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgdG9rZW5zMS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlbnMxW2ldOwogICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgdG9rZW5zMi5sZW5ndGg7IGorKykgewogICAgICAgICAgICAgIGlmKHRva2VuID09IHRva2VuczJbal0pIGNvbnRpbnVlIG91dGVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhbHVlcy5wdXNoKHRva2VuKTsKICAgICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgICB9CgogICAgICBmdW5jdGlvbiBhcnJheUNsYXNzZXMgKGNsYXNzVmFsKSB7CiAgICAgICAgaWYgKGlzQXJyYXkoY2xhc3NWYWwpKSB7CiAgICAgICAgICByZXR1cm4gY2xhc3NWYWw7CiAgICAgICAgfSBlbHNlIGlmIChpc1N0cmluZyhjbGFzc1ZhbCkpIHsKICAgICAgICAgIHJldHVybiBjbGFzc1ZhbC5zcGxpdCgnICcpOwogICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3QoY2xhc3NWYWwpKSB7CiAgICAgICAgICB2YXIgY2xhc3NlcyA9IFtdLCBpID0gMDsKICAgICAgICAgIGZvckVhY2goY2xhc3NWYWwsIGZ1bmN0aW9uKHYsIGspIHsKICAgICAgICAgICAgaWYgKHYpIHsKICAgICAgICAgICAgICBjbGFzc2VzID0gY2xhc3Nlcy5jb25jYXQoay5zcGxpdCgnICcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gY2xhc3NlczsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNsYXNzVmFsOwogICAgICB9CiAgICB9XTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0NsYXNzCiAgICogQHJlc3RyaWN0IEFDCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgYG5nQ2xhc3NgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIGR5bmFtaWNhbGx5IHNldCBDU1MgY2xhc3NlcyBvbiBhbiBIVE1MIGVsZW1lbnQgYnkgZGF0YWJpbmRpbmcKICAgKiBhbiBleHByZXNzaW9uIHRoYXQgcmVwcmVzZW50cyBhbGwgY2xhc3NlcyB0byBiZSBhZGRlZC4KICAgKgogICAqIFRoZSBkaXJlY3RpdmUgb3BlcmF0ZXMgaW4gdGhyZWUgZGlmZmVyZW50IHdheXMsIGRlcGVuZGluZyBvbiB3aGljaCBvZiB0aHJlZSB0eXBlcyB0aGUgZXhwcmVzc2lvbgogICAqIGV2YWx1YXRlcyB0bzoKICAgKgogICAqIDEuIElmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhIHN0cmluZywgdGhlIHN0cmluZyBzaG91bGQgYmUgb25lIG9yIG1vcmUgc3BhY2UtZGVsaW1pdGVkIGNsYXNzCiAgICogbmFtZXMuCiAgICoKICAgKiAyLiBJZiB0aGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYW4gYXJyYXksIGVhY2ggZWxlbWVudCBvZiB0aGUgYXJyYXkgc2hvdWxkIGJlIGEgc3RyaW5nIHRoYXQgaXMKICAgKiBvbmUgb3IgbW9yZSBzcGFjZS1kZWxpbWl0ZWQgY2xhc3MgbmFtZXMuCiAgICoKICAgKiAzLiBJZiB0aGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYW4gb2JqZWN0LCB0aGVuIGZvciBlYWNoIGtleS12YWx1ZSBwYWlyIG9mIHRoZQogICAqIG9iamVjdCB3aXRoIGEgdHJ1dGh5IHZhbHVlIHRoZSBjb3JyZXNwb25kaW5nIGtleSBpcyB1c2VkIGFzIGEgY2xhc3MgbmFtZS4KICAgKgogICAqIFRoZSBkaXJlY3RpdmUgd29uJ3QgYWRkIGR1cGxpY2F0ZSBjbGFzc2VzIGlmIGEgcGFydGljdWxhciBjbGFzcyB3YXMgYWxyZWFkeSBzZXQuCiAgICoKICAgKiBXaGVuIHRoZSBleHByZXNzaW9uIGNoYW5nZXMsIHRoZSBwcmV2aW91c2x5IGFkZGVkIGNsYXNzZXMgYXJlIHJlbW92ZWQgYW5kIG9ubHkgdGhlbiB0aGUKICAgKiBuZXcgY2xhc3NlcyBhcmUgYWRkZWQuCiAgICoKICAgKiBAYW5pbWF0aW9ucwogICAqIGFkZCAtIGhhcHBlbnMganVzdCBiZWZvcmUgdGhlIGNsYXNzIGlzIGFwcGxpZWQgdG8gdGhlIGVsZW1lbnQKICAgKiByZW1vdmUgLSBoYXBwZW5zIGp1c3QgYmVmb3JlIHRoZSBjbGFzcyBpcyByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUgcmVzdWx0CiAgICogICBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcwogICAqICAgbmFtZXMsIGFuIGFycmF5LCBvciBhIG1hcCBvZiBjbGFzcyBuYW1lcyB0byBib29sZWFuIHZhbHVlcy4gSW4gdGhlIGNhc2Ugb2YgYSBtYXAsIHRoZQogICAqICAgbmFtZXMgb2YgdGhlIHByb3BlcnRpZXMgd2hvc2UgdmFsdWVzIGFyZSB0cnV0aHkgd2lsbCBiZSBhZGRlZCBhcyBjc3MgY2xhc3NlcyB0byB0aGUKICAgKiAgIGVsZW1lbnQuCiAgICoKICAgKiBAZXhhbXBsZSBFeGFtcGxlIHRoYXQgZGVtb25zdHJhdGVzIGJhc2ljIGJpbmRpbmdzIHZpYSBuZ0NsYXNzIGRpcmVjdGl2ZS4KICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8cCBuZy1jbGFzcz0ie3N0cmlrZTogZGVsZXRlZCwgYm9sZDogaW1wb3J0YW50LCByZWQ6IGVycm9yfSI+TWFwIFN5bnRheCBFeGFtcGxlPC9wPgogICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJkZWxldGVkIj4gZGVsZXRlZCAoYXBwbHkgInN0cmlrZSIgY2xhc3MpPGJyPgogICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJpbXBvcnRhbnQiPiBpbXBvcnRhbnQgKGFwcGx5ICJib2xkIiBjbGFzcyk8YnI+CiAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImVycm9yIj4gZXJyb3IgKGFwcGx5ICJyZWQiIGNsYXNzKQogICA8aHI+CiAgIDxwIG5nLWNsYXNzPSJzdHlsZSI+VXNpbmcgU3RyaW5nIFN5bnRheDwvcD4KICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzdHlsZSIgcGxhY2Vob2xkZXI9IlR5cGU6IGJvbGQgc3RyaWtlIHJlZCI+CiAgIDxocj4KICAgPHAgbmctY2xhc3M9IltzdHlsZTEsIHN0eWxlMiwgc3R5bGUzXSI+VXNpbmcgQXJyYXkgU3ludGF4PC9wPgogICA8aW5wdXQgbmctbW9kZWw9InN0eWxlMSIgcGxhY2Vob2xkZXI9IlR5cGU6IGJvbGQsIHN0cmlrZSBvciByZWQiPjxicj4KICAgPGlucHV0IG5nLW1vZGVsPSJzdHlsZTIiIHBsYWNlaG9sZGVyPSJUeXBlOiBib2xkLCBzdHJpa2Ugb3IgcmVkIj48YnI+CiAgIDxpbnB1dCBuZy1tb2RlbD0ic3R5bGUzIiBwbGFjZWhvbGRlcj0iVHlwZTogYm9sZCwgc3RyaWtlIG9yIHJlZCI+PGJyPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgIC5zdHJpa2UgewogICAgICAgICB0ZXh0LWRlY29yYXRpb246IGxpbmUtdGhyb3VnaDsKICAgICAgIH0KICAgLmJvbGQgewogICAgICAgICAgIGZvbnQtd2VpZ2h0OiBib2xkOwogICAgICAgfQogICAucmVkIHsKICAgICAgICAgICBjb2xvcjogcmVkOwogICAgICAgfQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICB2YXIgcHMgPSBlbGVtZW50LmFsbChieS5jc3MoJ3AnKSk7CgogICBpdCgnc2hvdWxkIGxldCB5b3UgdG9nZ2xlIHRoZSBjbGFzcycsIGZ1bmN0aW9uKCkgewoKICAgICAgICAgZXhwZWN0KHBzLmZpcnN0KCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS5ub3QudG9NYXRjaCgvYm9sZC8pOwogICAgICAgICBleHBlY3QocHMuZmlyc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLm5vdC50b01hdGNoKC9yZWQvKTsKCiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2ltcG9ydGFudCcpKS5jbGljaygpOwogICAgICAgICBleHBlY3QocHMuZmlyc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvTWF0Y2goL2JvbGQvKTsKCiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2Vycm9yJykpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChwcy5maXJzdCgpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9NYXRjaCgvcmVkLyk7CiAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgbGV0IHlvdSB0b2dnbGUgc3RyaW5nIGV4YW1wbGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KHBzLmdldCgxKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvQmUoJycpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzdHlsZScpKS5jbGVhcigpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzdHlsZScpKS5zZW5kS2V5cygncmVkJyk7CiAgICAgICAgIGV4cGVjdChwcy5nZXQoMSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b0JlKCdyZWQnKTsKICAgICAgIH0pOwoKICAgaXQoJ2FycmF5IGV4YW1wbGUgc2hvdWxkIGhhdmUgMyBjbGFzc2VzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChwcy5sYXN0KCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b0JlKCcnKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc3R5bGUxJykpLnNlbmRLZXlzKCdib2xkJyk7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3N0eWxlMicpKS5zZW5kS2V5cygnc3RyaWtlJyk7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3N0eWxlMycpKS5zZW5kS2V5cygncmVkJyk7CiAgICAgICAgIGV4cGVjdChwcy5sYXN0KCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b0JlKCdib2xkIHN0cmlrZSByZWQnKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KCiAgICMjIEFuaW1hdGlvbnMKCiAgIFRoZSBleGFtcGxlIGJlbG93IGRlbW9uc3RyYXRlcyBob3cgdG8gcGVyZm9ybSBhbmltYXRpb25zIHVzaW5nIG5nQ2xhc3MuCgogICA8ZXhhbXBsZSBtb2R1bGU9Im5nQW5pbWF0ZSIgZGVwcz0iYW5ndWxhci1hbmltYXRlLmpzIiBhbmltYXRpb25zPSJ0cnVlIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxpbnB1dCBpZD0ic2V0YnRuIiB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQiIG5nLWNsaWNrPSJteVZhcj0nbXktY2xhc3MnIj4KICAgPGlucHV0IGlkPSJjbGVhcmJ0biIgdHlwZT0iYnV0dG9uIiB2YWx1ZT0iY2xlYXIiIG5nLWNsaWNrPSJteVZhcj0nJyI+CiAgIDxicj4KICAgPHNwYW4gY2xhc3M9ImJhc2UtY2xhc3MiIG5nLWNsYXNzPSJteVZhciI+U2FtcGxlIFRleHQ8L3NwYW4+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgLmJhc2UtY2xhc3MgewogICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgICAgdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgfQoKICAgLmJhc2UtY2xhc3MubXktY2xhc3MgewogICAgICAgICBjb2xvcjogcmVkOwogICAgICAgICBmb250LXNpemU6M2VtOwogICAgICAgfQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsYXNzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnLmJhc2UtY2xhc3MnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS5ub3QuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKCiAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ3NldGJ0bicpKS5jbGljaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcuYmFzZS1jbGFzcycpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLgogICAgICAgICAgIHRvTWF0Y2goL215LWNsYXNzLyk7CgogICAgICAgICBlbGVtZW50KGJ5LmlkKCdjbGVhcmJ0bicpKS5jbGljaygpOwoKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcuYmFzZS1jbGFzcycpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLm5vdC4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwogICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgoKCiAgICMjIG5nQ2xhc3MgYW5kIHByZS1leGlzdGluZyBDU1MzIFRyYW5zaXRpb25zL0FuaW1hdGlvbnMKICAgVGhlIG5nQ2xhc3MgZGlyZWN0aXZlIHN0aWxsIHN1cHBvcnRzIENTUzMgVHJhbnNpdGlvbnMvQW5pbWF0aW9ucyBldmVuIGlmIHRoZXkgZG8gbm90IGZvbGxvdyB0aGUgbmdBbmltYXRlIENTUyBuYW1pbmcgc3RydWN0dXJlLgogICBVcG9uIGFuaW1hdGlvbiBuZ0FuaW1hdGUgd2lsbCBhcHBseSBzdXBwbGVtZW50YXJ5IENTUyBjbGFzc2VzIHRvIHRyYWNrIHRoZSBzdGFydCBhbmQgZW5kIG9mIGFuIGFuaW1hdGlvbiwgYnV0IHRoaXMgd2lsbCBub3QgaGluZGVyCiAgIGFueSBwcmUtZXhpc3RpbmcgQ1NTIHRyYW5zaXRpb25zIGFscmVhZHkgb24gdGhlIGVsZW1lbnQuIFRvIGdldCBhbiBpZGVhIG9mIHdoYXQgaGFwcGVucyBkdXJpbmcgYSBjbGFzcy1iYXNlZCBhbmltYXRpb24sIGJlIHN1cmUKICAgdG8gdmlldyB0aGUgc3RlcCBieSBzdGVwIGRldGFpbHMgb2Yge0BsaW5rIG5nQW5pbWF0ZS4kYW5pbWF0ZSNhZGRjbGFzcyAkYW5pbWF0ZS5hZGRDbGFzc30gYW5kCiAgIHtAbGluayBuZ0FuaW1hdGUuJGFuaW1hdGUjcmVtb3ZlY2xhc3MgJGFuaW1hdGUucmVtb3ZlQ2xhc3N9LgogICAqLwogIHZhciBuZ0NsYXNzRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJycsIHRydWUpOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdDbGFzc09kZAogICAqIEByZXN0cmljdCBBQwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGBuZ0NsYXNzT2RkYCBhbmQgYG5nQ2xhc3NFdmVuYCBkaXJlY3RpdmVzIHdvcmsgZXhhY3RseSBhcwogICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGFzcyBuZ0NsYXNzfSwgZXhjZXB0IHRoZXkgd29yayBpbgogICAqIGNvbmp1bmN0aW9uIHdpdGggYG5nUmVwZWF0YCBhbmQgdGFrZSBlZmZlY3Qgb25seSBvbiBvZGQgKGV2ZW4pIHJvd3MuCiAgICoKICAgKiBUaGlzIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCBvbmx5IHdpdGhpbiB0aGUgc2NvcGUgb2YgYW4KICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fS4KICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzc09kZCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLiBUaGUgcmVzdWx0CiAgICogICBvZiB0aGUgZXZhbHVhdGlvbiBjYW4gYmUgYSBzdHJpbmcgcmVwcmVzZW50aW5nIHNwYWNlIGRlbGltaXRlZCBjbGFzcyBuYW1lcyBvciBhbiBhcnJheS4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPG9sIG5nLWluaXQ9Im5hbWVzPVsnSm9obicsICdNYXJ5JywgJ0NhdGUnLCAnU3V6J10iPgogICA8bGkgbmctcmVwZWF0PSJuYW1lIGluIG5hbWVzIj4KICAgPHNwYW4gbmctY2xhc3Mtb2RkPSInb2RkJyIgbmctY2xhc3MtZXZlbj0iJ2V2ZW4nIj4KICAge3tuYW1lfX0KICAgPC9zcGFuPgogICA8L2xpPgogICA8L29sPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InN0eWxlLmNzcyI+CiAgIC5vZGQgewogICAgICAgICBjb2xvcjogcmVkOwogICAgICAgfQogICAuZXZlbiB7CiAgICAgICAgIGNvbG9yOiBibHVlOwogICAgICAgfQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGNoZWNrIG5nLWNsYXNzLW9kZCBhbmQgbmctY2xhc3MtZXZlbicsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5yZXBlYXRlcignbmFtZSBpbiBuYW1lcycpLnJvdygwKS5jb2x1bW4oJ25hbWUnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS4KICAgICAgICAgICB0b01hdGNoKC9vZGQvKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkucmVwZWF0ZXIoJ25hbWUgaW4gbmFtZXMnKS5yb3coMSkuY29sdW1uKCduYW1lJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvZXZlbi8pOwogICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIHZhciBuZ0NsYXNzT2RkRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJ09kZCcsIDApOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdDbGFzc0V2ZW4KICAgKiBAcmVzdHJpY3QgQUMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdDbGFzc09kZGAgYW5kIGBuZ0NsYXNzRXZlbmAgZGlyZWN0aXZlcyB3b3JrIGV4YWN0bHkgYXMKICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xhc3MgbmdDbGFzc30sIGV4Y2VwdCB0aGV5IHdvcmsgaW4KICAgKiBjb25qdW5jdGlvbiB3aXRoIGBuZ1JlcGVhdGAgYW5kIHRha2UgZWZmZWN0IG9ubHkgb24gb2RkIChldmVuKSByb3dzLgogICAqCiAgICogVGhpcyBkaXJlY3RpdmUgY2FuIGJlIGFwcGxpZWQgb25seSB3aXRoaW4gdGhlIHNjb3BlIG9mIGFuCiAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0uCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xhc3NFdmVuIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZQogICAqICAgcmVzdWx0IG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzIG5hbWVzIG9yIGFuIGFycmF5LgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8b2wgbmctaW5pdD0ibmFtZXM9WydKb2huJywgJ01hcnknLCAnQ2F0ZScsICdTdXonXSI+CiAgIDxsaSBuZy1yZXBlYXQ9Im5hbWUgaW4gbmFtZXMiPgogICA8c3BhbiBuZy1jbGFzcy1vZGQ9IidvZGQnIiBuZy1jbGFzcy1ldmVuPSInZXZlbiciPgogICB7e25hbWV9fSAmbmJzcDsgJm5ic3A7ICZuYnNwOwogICA8L3NwYW4+CiAgIDwvbGk+CiAgIDwvb2w+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgLm9kZCB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgIC5ldmVuIHsKICAgICAgICAgY29sb3I6IGJsdWU7CiAgICAgICB9CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3Mtb2RkIGFuZCBuZy1jbGFzcy1ldmVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LnJlcGVhdGVyKCduYW1lIGluIG5hbWVzJykucm93KDApLmNvbHVtbignbmFtZScpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLgogICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5yZXBlYXRlcignbmFtZSBpbiBuYW1lcycpLnJvdygxKS5jb2x1bW4oJ25hbWUnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS4KICAgICAgICAgICB0b01hdGNoKC9ldmVuLyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nQ2xhc3NFdmVuRGlyZWN0aXZlID0gY2xhc3NEaXJlY3RpdmUoJ0V2ZW4nLCAxKTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nQ2xvYWsKICAgKiBAcmVzdHJpY3QgQUMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdDbG9ha2AgZGlyZWN0aXZlIGlzIHVzZWQgdG8gcHJldmVudCB0aGUgQW5ndWxhciBodG1sIHRlbXBsYXRlIGZyb20gYmVpbmcgYnJpZWZseQogICAqIGRpc3BsYXllZCBieSB0aGUgYnJvd3NlciBpbiBpdHMgcmF3ICh1bmNvbXBpbGVkKSBmb3JtIHdoaWxlIHlvdXIgYXBwbGljYXRpb24gaXMgbG9hZGluZy4gVXNlIHRoaXMKICAgKiBkaXJlY3RpdmUgdG8gYXZvaWQgdGhlIHVuZGVzaXJhYmxlIGZsaWNrZXIgZWZmZWN0IGNhdXNlZCBieSB0aGUgaHRtbCB0ZW1wbGF0ZSBkaXNwbGF5LgogICAqCiAgICogVGhlIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCB0byB0aGUgYDxib2R5PmAgZWxlbWVudCwgYnV0IHRoZSBwcmVmZXJyZWQgdXNhZ2UgaXMgdG8gYXBwbHkKICAgKiBtdWx0aXBsZSBgbmdDbG9ha2AgZGlyZWN0aXZlcyB0byBzbWFsbCBwb3J0aW9ucyBvZiB0aGUgcGFnZSB0byBwZXJtaXQgcHJvZ3Jlc3NpdmUgcmVuZGVyaW5nCiAgICogb2YgdGhlIGJyb3dzZXIgdmlldy4KICAgKgogICAqIGBuZ0Nsb2FrYCB3b3JrcyBpbiBjb29wZXJhdGlvbiB3aXRoIHRoZSBmb2xsb3dpbmcgY3NzIHJ1bGUgZW1iZWRkZWQgd2l0aGluIGBhbmd1bGFyLmpzYCBhbmQKICAgKiBgYW5ndWxhci5taW4uanNgLgogICAqIEZvciBDU1AgbW9kZSBwbGVhc2UgYWRkIGBhbmd1bGFyLWNzcC5jc3NgIHRvIHlvdXIgaHRtbCBmaWxlIChzZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NzcCBuZ0NzcH0pLgogICAqCiAgICogYGBgY3NzCiAgICogW25nXDpjbG9ha10sIFtuZy1jbG9ha10sIFtkYXRhLW5nLWNsb2FrXSwgW3gtbmctY2xvYWtdLCAubmctY2xvYWssIC54LW5nLWNsb2FrIHsKICogICBkaXNwbGF5OiBub25lICFpbXBvcnRhbnQ7CiAqIH0KICAgKiBgYGAKICAgKgogICAqIFdoZW4gdGhpcyBjc3MgcnVsZSBpcyBsb2FkZWQgYnkgdGhlIGJyb3dzZXIsIGFsbCBodG1sIGVsZW1lbnRzIChpbmNsdWRpbmcgdGhlaXIgY2hpbGRyZW4pIHRoYXQKICAgKiBhcmUgdGFnZ2VkIHdpdGggdGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgYXJlIGhpZGRlbi4gV2hlbiBBbmd1bGFyIGVuY291bnRlcnMgdGhpcyBkaXJlY3RpdmUKICAgKiBkdXJpbmcgdGhlIGNvbXBpbGF0aW9uIG9mIHRoZSB0ZW1wbGF0ZSBpdCBkZWxldGVzIHRoZSBgbmdDbG9ha2AgZWxlbWVudCBhdHRyaWJ1dGUsIG1ha2luZwogICAqIHRoZSBjb21waWxlZCBlbGVtZW50IHZpc2libGUuCiAgICoKICAgKiBGb3IgdGhlIGJlc3QgcmVzdWx0LCB0aGUgYGFuZ3VsYXIuanNgIHNjcmlwdCBtdXN0IGJlIGxvYWRlZCBpbiB0aGUgaGVhZCBzZWN0aW9uIG9mIHRoZSBodG1sCiAgICogZG9jdW1lbnQ7IGFsdGVybmF0aXZlbHksIHRoZSBjc3MgcnVsZSBhYm92ZSBtdXN0IGJlIGluY2x1ZGVkIGluIHRoZSBleHRlcm5hbCBzdHlsZXNoZWV0IG9mIHRoZQogICAqIGFwcGxpY2F0aW9uLgogICAqCiAgICogTGVnYWN5IGJyb3dzZXJzLCBsaWtlIElFNywgZG8gbm90IHByb3ZpZGUgYXR0cmlidXRlIHNlbGVjdG9yIHN1cHBvcnQgKGFkZGVkIGluIENTUyAyLjEpIHNvIHRoZXkKICAgKiBjYW5ub3QgbWF0Y2ggdGhlIGBbbmdcOmNsb2FrXWAgc2VsZWN0b3IuIFRvIHdvcmsgYXJvdW5kIHRoaXMgbGltaXRhdGlvbiwgeW91IG11c3QgYWRkIHRoZSBjc3MKICAgKiBjbGFzcyBgbmctY2xvYWtgIGluIGFkZGl0aW9uIHRvIHRoZSBgbmdDbG9ha2AgZGlyZWN0aXZlIGFzIHNob3duIGluIHRoZSBleGFtcGxlIGJlbG93LgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgaWQ9InRlbXBsYXRlMSIgbmctY2xvYWs+e3sgJ2hlbGxvJyB9fTwvZGl2PgogICA8ZGl2IGlkPSJ0ZW1wbGF0ZTIiIG5nLWNsb2FrIGNsYXNzPSJuZy1jbG9hayI+e3sgJ2hlbGxvIElFNycgfX08L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCByZW1vdmUgdGhlIHRlbXBsYXRlIGRpcmVjdGl2ZSBhbmQgY3NzIGNsYXNzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdCgkKCcjdGVtcGxhdGUxJykuZ2V0QXR0cmlidXRlKCduZy1jbG9haycpKS4KICAgICAgICAgICB0b0JlTnVsbCgpOwogICAgICAgICBleHBlY3QoJCgnI3RlbXBsYXRlMicpLmdldEF0dHJpYnV0ZSgnbmctY2xvYWsnKSkuCiAgICAgICAgICAgdG9CZU51bGwoKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKgogICAqLwogIHZhciBuZ0Nsb2FrRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICBhdHRyLiRzZXQoJ25nQ2xvYWsnLCB1bmRlZmluZWQpOwogICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKCduZy1jbG9haycpOwogICAgfQogIH0pOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdDb250cm9sbGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgYG5nQ29udHJvbGxlcmAgZGlyZWN0aXZlIGF0dGFjaGVzIGEgY29udHJvbGxlciBjbGFzcyB0byB0aGUgdmlldy4gVGhpcyBpcyBhIGtleSBhc3BlY3Qgb2YgaG93IGFuZ3VsYXIKICAgKiBzdXBwb3J0cyB0aGUgcHJpbmNpcGxlcyBiZWhpbmQgdGhlIE1vZGVsLVZpZXctQ29udHJvbGxlciBkZXNpZ24gcGF0dGVybi4KICAgKgogICAqIE1WQyBjb21wb25lbnRzIGluIGFuZ3VsYXI6CiAgICoKICAgKiAqIE1vZGVsIOKAlCBUaGUgTW9kZWwgaXMgc2NvcGUgcHJvcGVydGllczsgc2NvcGVzIGFyZSBhdHRhY2hlZCB0byB0aGUgRE9NIHdoZXJlIHNjb3BlIHByb3BlcnRpZXMKICAgKiAgIGFyZSBhY2Nlc3NlZCB0aHJvdWdoIGJpbmRpbmdzLgogICAqICogVmlldyDigJQgVGhlIHRlbXBsYXRlIChIVE1MIHdpdGggZGF0YSBiaW5kaW5ncykgdGhhdCBpcyByZW5kZXJlZCBpbnRvIHRoZSBWaWV3LgogICAqICogQ29udHJvbGxlciDigJQgVGhlIGBuZ0NvbnRyb2xsZXJgIGRpcmVjdGl2ZSBzcGVjaWZpZXMgYSBDb250cm9sbGVyIGNsYXNzOyB0aGUgY2xhc3MgY29udGFpbnMgYnVzaW5lc3MKICAgKiAgIGxvZ2ljIGJlaGluZCB0aGUgYXBwbGljYXRpb24gdG8gZGVjb3JhdGUgdGhlIHNjb3BlIHdpdGggZnVuY3Rpb25zIGFuZCB2YWx1ZXMKICAgKgogICAqIE5vdGUgdGhhdCB5b3UgY2FuIGFsc28gYXR0YWNoIGNvbnRyb2xsZXJzIHRvIHRoZSBET00gYnkgZGVjbGFyaW5nIGl0IGluIGEgcm91dGUgZGVmaW5pdGlvbgogICAqIHZpYSB0aGUge0BsaW5rIG5nUm91dGUuJHJvdXRlICRyb3V0ZX0gc2VydmljZS4gQSBjb21tb24gbWlzdGFrZSBpcyB0byBkZWNsYXJlIHRoZSBjb250cm9sbGVyCiAgICogYWdhaW4gdXNpbmcgYG5nLWNvbnRyb2xsZXJgIGluIHRoZSB0ZW1wbGF0ZSBpdHNlbGYuICBUaGlzIHdpbGwgY2F1c2UgdGhlIGNvbnRyb2xsZXIgdG8gYmUgYXR0YWNoZWQKICAgKiBhbmQgZXhlY3V0ZWQgdHdpY2UuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAc2NvcGUKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ29udHJvbGxlciBOYW1lIG9mIGEgZ2xvYmFsbHkgYWNjZXNzaWJsZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBvciBhbgogICAqICAgICB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSB0aGF0IG9uIHRoZSBjdXJyZW50IHNjb3BlIGV2YWx1YXRlcyB0byBhCiAgICogICAgIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLiBUaGUgY29udHJvbGxlciBpbnN0YW5jZSBjYW4gYmUgcHVibGlzaGVkIGludG8gYSBzY29wZSBwcm9wZXJ0eQogICAqICAgICBieSBzcGVjaWZ5aW5nIGBhcyBwcm9wZXJ0eU5hbWVgLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBIZXJlIGlzIGEgc2ltcGxlIGZvcm0gZm9yIGVkaXRpbmcgdXNlciBjb250YWN0IGluZm9ybWF0aW9uLiBBZGRpbmcsIHJlbW92aW5nLCBjbGVhcmluZywgYW5kCiAgICogZ3JlZXRpbmcgYXJlIG1ldGhvZHMgZGVjbGFyZWQgb24gdGhlIGNvbnRyb2xsZXIgKHNlZSBzb3VyY2UgdGFiKS4gVGhlc2UgbWV0aG9kcyBjYW4KICAgKiBlYXNpbHkgYmUgY2FsbGVkIGZyb20gdGhlIGFuZ3VsYXIgbWFya3VwLiBBbnkgY2hhbmdlcyB0byB0aGUgZGF0YSBhcmUgYXV0b21hdGljYWxseSByZWZsZWN0ZWQKICAgKiBpbiB0aGUgVmlldyB3aXRob3V0IHRoZSBuZWVkIGZvciBhIG1hbnVhbCB1cGRhdGUuCiAgICoKICAgKiBUd28gZGlmZmVyZW50IGRlY2xhcmF0aW9uIHN0eWxlcyBhcmUgaW5jbHVkZWQgYmVsb3c6CiAgICoKICAgKiAqIG9uZSBiaW5kcyBtZXRob2RzIGFuZCBwcm9wZXJ0aWVzIGRpcmVjdGx5IG9udG8gdGhlIGNvbnRyb2xsZXIgdXNpbmcgYHRoaXNgOgogICAqIGBuZy1jb250cm9sbGVyPSJTZXR0aW5nc0NvbnRyb2xsZXIxIGFzIHNldHRpbmdzImAKICAgKiAqIG9uZSBpbmplY3RzIGAkc2NvcGVgIGludG8gdGhlIGNvbnRyb2xsZXI6CiAgICogYG5nLWNvbnRyb2xsZXI9IlNldHRpbmdzQ29udHJvbGxlcjIiYAogICAqCiAgICogVGhlIHNlY29uZCBvcHRpb24gaXMgbW9yZSBjb21tb24gaW4gdGhlIEFuZ3VsYXIgY29tbXVuaXR5LCBhbmQgaXMgZ2VuZXJhbGx5IHVzZWQgaW4gYm9pbGVycGxhdGVzCiAgICogYW5kIGluIHRoaXMgZ3VpZGUuIEhvd2V2ZXIsIHRoZXJlIGFyZSBhZHZhbnRhZ2VzIHRvIGJpbmRpbmcgcHJvcGVydGllcyBkaXJlY3RseSB0byB0aGUgY29udHJvbGxlcgogICAqIGFuZCBhdm9pZGluZyBzY29wZS4KICAgKgogICAqICogVXNpbmcgYGNvbnRyb2xsZXIgYXNgIG1ha2VzIGl0IG9idmlvdXMgd2hpY2ggY29udHJvbGxlciB5b3UgYXJlIGFjY2Vzc2luZyBpbiB0aGUgdGVtcGxhdGUgd2hlbgogICAqIG11bHRpcGxlIGNvbnRyb2xsZXJzIGFwcGx5IHRvIGFuIGVsZW1lbnQuCiAgICogKiBJZiB5b3UgYXJlIHdyaXRpbmcgeW91ciBjb250cm9sbGVycyBhcyBjbGFzc2VzIHlvdSBoYXZlIGVhc2llciBhY2Nlc3MgdG8gdGhlIHByb3BlcnRpZXMgYW5kCiAgICogbWV0aG9kcywgd2hpY2ggd2lsbCBhcHBlYXIgb24gdGhlIHNjb3BlLCBmcm9tIGluc2lkZSB0aGUgY29udHJvbGxlciBjb2RlLgogICAqICogU2luY2UgdGhlcmUgaXMgYWx3YXlzIGEgYC5gIGluIHRoZSBiaW5kaW5ncywgeW91IGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgcHJvdG90eXBhbAogICAqIGluaGVyaXRhbmNlIG1hc2tpbmcgcHJpbWl0aXZlcy4KICAgKgogICAqIFRoaXMgZXhhbXBsZSBkZW1vbnN0cmF0ZXMgdGhlIGBjb250cm9sbGVyIGFzYCBzeW50YXguCiAgICoKICAgKiA8ZXhhbXBsZSBuYW1lPSJuZ0NvbnRyb2xsZXJBcyI+CiAgICogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgKiAgICA8ZGl2IGlkPSJjdHJsLWFzLWV4bXBsIiBuZy1jb250cm9sbGVyPSJTZXR0aW5nc0NvbnRyb2xsZXIxIGFzIHNldHRpbmdzIj4KICAgKiAgICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ic2V0dGluZ3MubmFtZSIvPgogICAqICAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJzZXR0aW5ncy5ncmVldCgpIj5ncmVldDwvYT4gXTxici8+CiAgICogICAgICBDb250YWN0OgogICAqICAgICAgPHVsPgogICAqICAgICAgICA8bGkgbmctcmVwZWF0PSJjb250YWN0IGluIHNldHRpbmdzLmNvbnRhY3RzIj4KICAgKiAgICAgICAgICA8c2VsZWN0IG5nLW1vZGVsPSJjb250YWN0LnR5cGUiPgogICAqICAgICAgICAgICAgIDxvcHRpb24+cGhvbmU8L29wdGlvbj4KICAgKiAgICAgICAgICAgICA8b3B0aW9uPmVtYWlsPC9vcHRpb24+CiAgICogICAgICAgICAgPC9zZWxlY3Q+CiAgICogICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJjb250YWN0LnZhbHVlIi8+CiAgICogICAgICAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJzZXR0aW5ncy5jbGVhckNvbnRhY3QoY29udGFjdCkiPmNsZWFyPC9hPgogICAqICAgICAgICAgIHwgPGEgaHJlZj0iIiBuZy1jbGljaz0ic2V0dGluZ3MucmVtb3ZlQ29udGFjdChjb250YWN0KSI+WDwvYT4gXQogICAqICAgICAgICA8L2xpPgogICAqICAgICAgICA8bGk+WyA8YSBocmVmPSIiIG5nLWNsaWNrPSJzZXR0aW5ncy5hZGRDb250YWN0KCkiPmFkZDwvYT4gXTwvbGk+CiAgICogICAgIDwvdWw+CiAgICogICAgPC9kaXY+CiAgICogICA8L2ZpbGU+CiAgICogICA8ZmlsZSBuYW1lPSJhcHAuanMiPgogICAqICAgIGZ1bmN0aW9uIFNldHRpbmdzQ29udHJvbGxlcjEoKSB7CiAqICAgICAgdGhpcy5uYW1lID0gIkpvaG4gU21pdGgiOwogKiAgICAgIHRoaXMuY29udGFjdHMgPSBbCiAqICAgICAgICB7dHlwZTogJ3Bob25lJywgdmFsdWU6ICc0MDggNTU1IDEyMTInfSwKICogICAgICAgIHt0eXBlOiAnZW1haWwnLCB2YWx1ZTogJ2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnfSBdOwogICAqICAgIH0KICAgKgogICAqICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLmdyZWV0ID0gZnVuY3Rpb24oKSB7CiAqICAgICAgYWxlcnQodGhpcy5uYW1lKTsKICogICAgfTsKICAgKgogICAqICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICogICAgICB0aGlzLmNvbnRhY3RzLnB1c2goe3R5cGU6ICdlbWFpbCcsIHZhbHVlOiAneW91cm5hbWVAZXhhbXBsZS5vcmcnfSk7CiAgICogICAgfTsKICAgKgogICAqICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLnJlbW92ZUNvbnRhY3QgPSBmdW5jdGlvbihjb250YWN0VG9SZW1vdmUpIHsKICogICAgIHZhciBpbmRleCA9IHRoaXMuY29udGFjdHMuaW5kZXhPZihjb250YWN0VG9SZW1vdmUpOwogKiAgICAgIHRoaXMuY29udGFjdHMuc3BsaWNlKGluZGV4LCAxKTsKICogICAgfTsKICAgKgogICAqICAgIFNldHRpbmdzQ29udHJvbGxlcjEucHJvdG90eXBlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICogICAgICBjb250YWN0LnR5cGUgPSAncGhvbmUnOwogKiAgICAgIGNvbnRhY3QudmFsdWUgPSAnJzsKICogICAgfTsKICAgKiAgIDwvZmlsZT4KICAgKiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAqICAgICBpdCgnc2hvdWxkIGNoZWNrIGNvbnRyb2xsZXIgYXMnLCBmdW5jdGlvbigpIHsKICogICAgICAgdmFyIGNvbnRhaW5lciA9IGVsZW1lbnQoYnkuaWQoJ2N0cmwtYXMtZXhtcGwnKSk7CiAqICAgICAgICAgZXhwZWN0KGNvbnRhaW5lci5maW5kRWxlbWVudChieS5tb2RlbCgnc2V0dGluZ3MubmFtZScpKQogKiAgICAgICAgICAgLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9CZSgnSm9obiBTbWl0aCcpOwogKgogKiAgICAgICB2YXIgZmlyc3RSZXBlYXQgPQogKiAgICAgICAgICAgY29udGFpbmVyLmZpbmRFbGVtZW50KGJ5LnJlcGVhdGVyKCdjb250YWN0IGluIHNldHRpbmdzLmNvbnRhY3RzJykucm93KDApKTsKICogICAgICAgdmFyIHNlY29uZFJlcGVhdCA9CiAqICAgICAgICAgICBjb250YWluZXIuZmluZEVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gc2V0dGluZ3MuY29udGFjdHMnKS5yb3coMSkpOwogKgogKiAgICAgICBleHBlY3QoZmlyc3RSZXBlYXQuZmluZEVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAgLnRvQmUoJzQwOCA1NTUgMTIxMicpOwogKgogKiAgICAgICBleHBlY3Qoc2Vjb25kUmVwZWF0LmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgIC50b0JlKCdqb2huLnNtaXRoQGV4YW1wbGUub3JnJyk7CiAgICoKICAgKiAgICAgICBmaXJzdFJlcGVhdC5maW5kRWxlbWVudChieS5saW5rVGV4dCgnY2xlYXInKSkuY2xpY2soKTsKICAgKgogICAqICAgICAgIGV4cGVjdChmaXJzdFJlcGVhdC5maW5kRWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAgICogICAgICAgICAgIC50b0JlKCcnKTsKICAgKgogICAqICAgICAgIGNvbnRhaW5lci5maW5kRWxlbWVudChieS5saW5rVGV4dCgnYWRkJykpLmNsaWNrKCk7CiAgICoKICAgKiAgICAgICBleHBlY3QoY29udGFpbmVyLmZpbmRFbGVtZW50KGJ5LnJlcGVhdGVyKCdjb250YWN0IGluIHNldHRpbmdzLmNvbnRhY3RzJykucm93KDIpKQogICAqICAgICAgICAgICAuZmluZEVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkKICAgKiAgICAgICAgICAgLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICAgKiAgICAgICAgICAgLnRvQmUoJ3lvdXJuYW1lQGV4YW1wbGUub3JnJyk7CiAgICogICAgIH0pOwogICAqICAgPC9maWxlPgogICAqIDwvZXhhbXBsZT4KICAgKgogICAqIFRoaXMgZXhhbXBsZSBkZW1vbnN0cmF0ZXMgdGhlICJhdHRhY2ggdG8gYCRzY29wZWAiIHN0eWxlIG9mIGNvbnRyb2xsZXIuCiAgICoKICAgKiA8ZXhhbXBsZSBuYW1lPSJuZ0NvbnRyb2xsZXIiPgogICAqICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgKiAgIDxkaXYgaWQ9ImN0cmwtZXhtcGwiIG5nLWNvbnRyb2xsZXI9IlNldHRpbmdzQ29udHJvbGxlcjIiPgogICAqICAgICBOYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9Im5hbWUiLz4KICAgKiAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJncmVldCgpIj5ncmVldDwvYT4gXTxici8+CiAgICogICAgIENvbnRhY3Q6CiAgICogICAgIDx1bD4KICAgKiAgICAgICA8bGkgbmctcmVwZWF0PSJjb250YWN0IGluIGNvbnRhY3RzIj4KICAgKiAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbnRhY3QudHlwZSI+CiAgICogICAgICAgICAgICA8b3B0aW9uPnBob25lPC9vcHRpb24+CiAgICogICAgICAgICAgICA8b3B0aW9uPmVtYWlsPC9vcHRpb24+CiAgICogICAgICAgICA8L3NlbGVjdD4KICAgKiAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0iY29udGFjdC52YWx1ZSIvPgogICAqICAgICAgICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJjbGVhckNvbnRhY3QoY29udGFjdCkiPmNsZWFyPC9hPgogICAqICAgICAgICAgfCA8YSBocmVmPSIiIG5nLWNsaWNrPSJyZW1vdmVDb250YWN0KGNvbnRhY3QpIj5YPC9hPiBdCiAgICogICAgICAgPC9saT4KICAgKiAgICAgICA8bGk+WyA8YSBocmVmPSIiIG5nLWNsaWNrPSJhZGRDb250YWN0KCkiPmFkZDwvYT4gXTwvbGk+CiAgICogICAgPC91bD4KICAgKiAgIDwvZGl2PgogICAqICA8L2ZpbGU+CiAgICogIDxmaWxlIG5hbWU9ImFwcC5qcyI+CiAgICogICBmdW5jdGlvbiBTZXR0aW5nc0NvbnRyb2xsZXIyKCRzY29wZSkgewogKiAgICAgJHNjb3BlLm5hbWUgPSAiSm9obiBTbWl0aCI7CiAqICAgICAkc2NvcGUuY29udGFjdHMgPSBbCiAqICAgICAgIHt0eXBlOidwaG9uZScsIHZhbHVlOic0MDggNTU1IDEyMTInfSwKICogICAgICAge3R5cGU6J2VtYWlsJywgdmFsdWU6J2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnfSBdOwogICAqCiAgICogICAgICRzY29wZS5ncmVldCA9IGZ1bmN0aW9uKCkgewogKiAgICAgICBhbGVydCgkc2NvcGUubmFtZSk7CiAqICAgICB9OwogICAqCiAgICogICAgICRzY29wZS5hZGRDb250YWN0ID0gZnVuY3Rpb24oKSB7CiAqICAgICAgICRzY29wZS5jb250YWN0cy5wdXNoKHt0eXBlOidlbWFpbCcsIHZhbHVlOid5b3VybmFtZUBleGFtcGxlLm9yZyd9KTsKICAgKiAgICAgfTsKICAgKgogICAqICAgICAkc2NvcGUucmVtb3ZlQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3RUb1JlbW92ZSkgewogKiAgICAgICB2YXIgaW5kZXggPSAkc2NvcGUuY29udGFjdHMuaW5kZXhPZihjb250YWN0VG9SZW1vdmUpOwogKiAgICAgICAkc2NvcGUuY29udGFjdHMuc3BsaWNlKGluZGV4LCAxKTsKICogICAgIH07CiAgICoKICAgKiAgICAgJHNjb3BlLmNsZWFyQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3QpIHsKICogICAgICAgY29udGFjdC50eXBlID0gJ3Bob25lJzsKICogICAgICAgY29udGFjdC52YWx1ZSA9ICcnOwogKiAgICAgfTsKICAgKiAgIH0KICAgKiAgPC9maWxlPgogICAqICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgKiAgICBpdCgnc2hvdWxkIGNoZWNrIGNvbnRyb2xsZXInLCBmdW5jdGlvbigpIHsKICogICAgICB2YXIgY29udGFpbmVyID0gZWxlbWVudChieS5pZCgnY3RybC1leG1wbCcpKTsKICoKICogICAgICBleHBlY3QoY29udGFpbmVyLmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCduYW1lJykpCiAqICAgICAgICAgIC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvQmUoJ0pvaG4gU21pdGgnKTsKICoKICogICAgICB2YXIgZmlyc3RSZXBlYXQgPQogKiAgICAgICAgICBjb250YWluZXIuZmluZEVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gY29udGFjdHMnKS5yb3coMCkpOwogKiAgICAgIHZhciBzZWNvbmRSZXBlYXQgPQogKiAgICAgICAgICBjb250YWluZXIuZmluZEVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gY29udGFjdHMnKS5yb3coMSkpOwogKgogKiAgICAgIGV4cGVjdChmaXJzdFJlcGVhdC5maW5kRWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgIC50b0JlKCc0MDggNTU1IDEyMTInKTsKICogICAgICBleHBlY3Qoc2Vjb25kUmVwZWF0LmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgLnRvQmUoJ2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnKTsKICAgKgogICAqICAgICAgZmlyc3RSZXBlYXQuZmluZEVsZW1lbnQoYnkubGlua1RleHQoJ2NsZWFyJykpLmNsaWNrKCk7CiAgICoKICAgKiAgICAgIGV4cGVjdChmaXJzdFJlcGVhdC5maW5kRWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAgICogICAgICAgICAgLnRvQmUoJycpOwogICAqCiAgICogICAgICBjb250YWluZXIuZmluZEVsZW1lbnQoYnkubGlua1RleHQoJ2FkZCcpKS5jbGljaygpOwogICAqCiAgICogICAgICBleHBlY3QoY29udGFpbmVyLmZpbmRFbGVtZW50KGJ5LnJlcGVhdGVyKCdjb250YWN0IGluIGNvbnRhY3RzJykucm93KDIpKQogICAqICAgICAgICAgIC5maW5kRWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKQogICAqICAgICAgICAgIC5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAgICogICAgICAgICAgLnRvQmUoJ3lvdXJuYW1lQGV4YW1wbGUub3JnJyk7CiAgICogICAgfSk7CiAgICogIDwvZmlsZT4KICAgKjwvZXhhbXBsZT4KCiAgICovCiAgdmFyIG5nQ29udHJvbGxlckRpcmVjdGl2ZSA9IFtmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHNjb3BlOiB0cnVlLAogICAgICBjb250cm9sbGVyOiAnQCcsCiAgICAgIHByaW9yaXR5OiA1MDAKICAgIH07CiAgfV07CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0NzcAogICAqCiAgICogQGVsZW1lbnQgaHRtbAogICAqIEBkZXNjcmlwdGlvbgogICAqIEVuYWJsZXMgW0NTUCAoQ29udGVudCBTZWN1cml0eSBQb2xpY3kpXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9TZWN1cml0eS9DU1ApIHN1cHBvcnQuCiAgICoKICAgKiBUaGlzIGlzIG5lY2Vzc2FyeSB3aGVuIGRldmVsb3BpbmcgdGhpbmdzIGxpa2UgR29vZ2xlIENocm9tZSBFeHRlbnNpb25zLgogICAqCiAgICogQ1NQIGZvcmJpZHMgYXBwcyB0byB1c2UgYGV2YWxgIG9yIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIChhbW9uZyBvdGhlciB0aGluZ3MpLgogICAqIEZvciB1cyB0byBiZSBjb21wYXRpYmxlLCB3ZSBqdXN0IG5lZWQgdG8gaW1wbGVtZW50IHRoZSAiZ2V0dGVyRm4iIGluICRwYXJzZSB3aXRob3V0IHZpb2xhdGluZwogICAqIGFueSBvZiB0aGVzZSByZXN0cmljdGlvbnMuCiAgICoKICAgKiBBbmd1bGFySlMgdXNlcyBgRnVuY3Rpb24oc3RyaW5nKWAgZ2VuZXJhdGVkIGZ1bmN0aW9ucyBhcyBhIHNwZWVkIG9wdGltaXphdGlvbi4gQXBwbHlpbmcgdGhlIGBuZ0NzcGAKICAgKiBkaXJlY3RpdmUgd2lsbCBjYXVzZSBBbmd1bGFyIHRvIHVzZSBDU1AgY29tcGF0aWJpbGl0eSBtb2RlLiBXaGVuIHRoaXMgbW9kZSBpcyBvbiBBbmd1bGFySlMgd2lsbAogICAqIGV2YWx1YXRlIGFsbCBleHByZXNzaW9ucyB1cCB0byAzMCUgc2xvd2VyIHRoYW4gaW4gbm9uLUNTUCBtb2RlLCBidXQgbm8gc2VjdXJpdHkgdmlvbGF0aW9ucyB3aWxsCiAgICogYmUgcmFpc2VkLgogICAqCiAgICogQ1NQIGZvcmJpZHMgSmF2YVNjcmlwdCB0byBpbmxpbmUgc3R5bGVzaGVldCBydWxlcy4gSW4gbm9uIENTUCBtb2RlIEFuZ3VsYXIgYXV0b21hdGljYWxseQogICAqIGluY2x1ZGVzIHNvbWUgQ1NTIHJ1bGVzIChlLmcuIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbG9hayBuZ0Nsb2FrfSkuCiAgICogVG8gbWFrZSB0aG9zZSBkaXJlY3RpdmVzIHdvcmsgaW4gQ1NQIG1vZGUsIGluY2x1ZGUgdGhlIGBhbmd1bGFyLWNzcC5jc3NgIG1hbnVhbGx5LgogICAqCiAgICogSW4gb3JkZXIgdG8gdXNlIHRoaXMgZmVhdHVyZSBwdXQgdGhlIGBuZ0NzcGAgZGlyZWN0aXZlIG9uIHRoZSByb290IGVsZW1lbnQgb2YgdGhlIGFwcGxpY2F0aW9uLgogICAqCiAgICogKk5vdGU6IFRoaXMgZGlyZWN0aXZlIGlzIG9ubHkgYXZhaWxhYmxlIGluIHRoZSBgbmctY3NwYCBhbmQgYGRhdGEtbmctY3NwYCBhdHRyaWJ1dGUgZm9ybS4qCiAgICoKICAgKiBAZXhhbXBsZQogICAqIFRoaXMgZXhhbXBsZSBzaG93cyBob3cgdG8gYXBwbHkgdGhlIGBuZ0NzcGAgZGlyZWN0aXZlIHRvIHRoZSBgaHRtbGAgdGFnLgogICBgYGBodG1sCiAgIDwhZG9jdHlwZSBodG1sPgogICA8aHRtbCBuZy1hcHAgbmctY3NwPgogICAuLi4KICAgLi4uCiAgIDwvaHRtbD4KICAgYGBgCiAgICovCgovLyBuZ0NzcCBpcyBub3QgaW1wbGVtZW50ZWQgYXMgYSBwcm9wZXIgZGlyZWN0aXZlIGFueSBtb3JlLCBiZWNhdXNlIHdlIG5lZWQgaXQgYmUgcHJvY2Vzc2VkIHdoaWxlIHdlIGJvb3RzdHJhcAovLyB0aGUgc3lzdGVtIChiZWZvcmUgJHBhcnNlIGlzIGluc3RhbnRpYXRlZCksIGZvciB0aGlzIHJlYXNvbiB3ZSBqdXN0IGhhdmUgYSBjc3AoKSBmbiB0aGF0IGxvb2tzIGZvciBuZy1jc3AgYXR0cmlidXRlCi8vIGFueXdoZXJlIGluIHRoZSBjdXJyZW50IGRvYwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdDbGljawogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIG5nQ2xpY2sgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igd2hlbgogICAqIGFuIGVsZW1lbnQgaXMgY2xpY2tlZC4KICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwcmlvcml0eSAwCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsaWNrIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBjbGljay4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxidXR0b24gbmctY2xpY2s9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgSW5jcmVtZW50CiAgIDwvYnV0dG9uPgogICBjb3VudDoge3tjb3VudH19CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnY291bnQnKSkuZ2V0VGV4dCgpKS50b01hdGNoKCcwJyk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCdidXR0b24nKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnY291bnQnKSkuZ2V0VGV4dCgpKS50b01hdGNoKCcxJyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgLyoKICAgKiBBIGRpcmVjdGl2ZSB0aGF0IGFsbG93cyBjcmVhdGlvbiBvZiBjdXN0b20gb25jbGljayBoYW5kbGVycyB0aGF0IGFyZSBkZWZpbmVkIGFzIGFuZ3VsYXIKICAgKiBleHByZXNzaW9ucyBhbmQgYXJlIGNvbXBpbGVkIGFuZCBleGVjdXRlZCB3aXRoaW4gdGhlIGN1cnJlbnQgc2NvcGUuCiAgICoKICAgKiBFdmVudHMgdGhhdCBhcmUgaGFuZGxlZCB2aWEgdGhlc2UgaGFuZGxlciBhcmUgYWx3YXlzIGNvbmZpZ3VyZWQgbm90IHRvIHByb3BhZ2F0ZSBmdXJ0aGVyLgogICAqLwogIHZhciBuZ0V2ZW50RGlyZWN0aXZlcyA9IHt9OwogIGZvckVhY2goCiAgICAnY2xpY2sgZGJsY2xpY2sgbW91c2Vkb3duIG1vdXNldXAgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlbW92ZSBtb3VzZWVudGVyIG1vdXNlbGVhdmUga2V5ZG93biBrZXl1cCBrZXlwcmVzcyBzdWJtaXQgZm9jdXMgYmx1ciBjb3B5IGN1dCBwYXN0ZScuc3BsaXQoJyAnKSwKICAgIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdmFyIGRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBuYW1lKTsKICAgICAgbmdFdmVudERpcmVjdGl2ZXNbZGlyZWN0aXZlTmFtZV0gPSBbJyRwYXJzZScsIGZ1bmN0aW9uKCRwYXJzZSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICB2YXIgZm4gPSAkcGFyc2UoYXR0cltkaXJlY3RpdmVOYW1lXSk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICAgIGVsZW1lbnQub24obG93ZXJjYXNlKG5hbWUpLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBmbihzY29wZSwgeyRldmVudDpldmVudH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfV07CiAgICB9CiAgKTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nRGJsY2xpY2sKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdEYmxjbGlja2AgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gYSBkYmxjbGljayBldmVudC4KICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwcmlvcml0eSAwCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0RibGNsaWNrIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBhIGRibGNsaWNrLiAoVGhlIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxidXR0b24gbmctZGJsY2xpY2s9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgSW5jcmVtZW50IChvbiBkb3VibGUgY2xpY2spCiAgIDwvYnV0dG9uPgogICBjb3VudDoge3tjb3VudH19CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nTW91c2Vkb3duCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgbmdNb3VzZWRvd24gZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2Vkb3duIGV2ZW50LgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHByaW9yaXR5IDAKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2Vkb3duIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBtb3VzZWRvd24uICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8YnV0dG9uIG5nLW1vdXNlZG93bj0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICBJbmNyZW1lbnQgKG9uIG1vdXNlIGRvd24pCiAgIDwvYnV0dG9uPgogICBjb3VudDoge3tjb3VudH19CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nTW91c2V1cAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2V1cCBldmVudC4KICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwcmlvcml0eSAwCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNldXAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAqIG1vdXNldXAuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8YnV0dG9uIG5nLW1vdXNldXA9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgSW5jcmVtZW50IChvbiBtb3VzZSB1cCkKICAgPC9idXR0b24+CiAgIGNvdW50OiB7e2NvdW50fX0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ01vdXNlb3ZlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VvdmVyIGV2ZW50LgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHByaW9yaXR5IDAKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2VvdmVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBtb3VzZW92ZXIuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8YnV0dG9uIG5nLW1vdXNlb3Zlcj0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICBJbmNyZW1lbnQgKHdoZW4gbW91c2UgaXMgb3ZlcikKICAgPC9idXR0b24+CiAgIGNvdW50OiB7e2NvdW50fX0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdNb3VzZWVudGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWVudGVyIGV2ZW50LgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHByaW9yaXR5IDAKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2VlbnRlciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICogbW91c2VlbnRlci4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxidXR0b24gbmctbW91c2VlbnRlcj0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICBJbmNyZW1lbnQgKHdoZW4gbW91c2UgZW50ZXJzKQogICA8L2J1dHRvbj4KICAgY291bnQ6IHt7Y291bnR9fQogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ01vdXNlbGVhdmUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlbGVhdmUgZXZlbnQuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcHJpb3JpdHkgMAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWxlYXZlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBtb3VzZWxlYXZlLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGJ1dHRvbiBuZy1tb3VzZWxlYXZlPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgIEluY3JlbWVudCAod2hlbiBtb3VzZSBsZWF2ZXMpCiAgIDwvYnV0dG9uPgogICBjb3VudDoge3tjb3VudH19CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nTW91c2Vtb3ZlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZW1vdmUgZXZlbnQuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcHJpb3JpdHkgMAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZW1vdmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAqIG1vdXNlbW92ZS4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxidXR0b24gbmctbW91c2Vtb3ZlPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgIEluY3JlbWVudCAod2hlbiBtb3VzZSBtb3ZlcykKICAgPC9idXR0b24+CiAgIGNvdW50OiB7e2NvdW50fX0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdLZXlkb3duCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBrZXlkb3duIGV2ZW50LgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHByaW9yaXR5IDAKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nS2V5ZG93biB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICoga2V5ZG93bi4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGAgYW5kIGNhbiBiZSBpbnRlcnJvZ2F0ZWQgZm9yIGtleUNvZGUsIGFsdEtleSwgZXRjLikKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGlucHV0IG5nLWtleWRvd249ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAga2V5IGRvd24gY291bnQ6IHt7Y291bnR9fQogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0tleXVwCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBrZXl1cCBldmVudC4KICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwcmlvcml0eSAwCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleXVwIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBrZXl1cC4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGAgYW5kIGNhbiBiZSBpbnRlcnJvZ2F0ZWQgZm9yIGtleUNvZGUsIGFsdEtleSwgZXRjLikKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHA+VHlwaW5nIGluIHRoZSBpbnB1dCBib3ggYmVsb3cgdXBkYXRlcyB0aGUga2V5IGNvdW50PC9wPgogICA8aW5wdXQgbmcta2V5dXA9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4ga2V5IHVwIGNvdW50OiB7e2NvdW50fX0KCiAgIDxwPlR5cGluZyBpbiB0aGUgaW5wdXQgYm94IGJlbG93IHVwZGF0ZXMgdGhlIGtleWNvZGU8L3A+CiAgIDxpbnB1dCBuZy1rZXl1cD0iZXZlbnQ9JGV2ZW50Ij4KICAgPHA+ZXZlbnQga2V5Q29kZToge3sgZXZlbnQua2V5Q29kZSB9fTwvcD4KICAgPHA+ZXZlbnQgYWx0S2V5OiB7eyBldmVudC5hbHRLZXkgfX08L3A+CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nS2V5cHJlc3MKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGtleXByZXNzIGV2ZW50LgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0tleXByZXNzIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBrZXlwcmVzcy4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0KICAgKiBhbmQgY2FuIGJlIGludGVycm9nYXRlZCBmb3Iga2V5Q29kZSwgYWx0S2V5LCBldGMuKQogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8aW5wdXQgbmcta2V5cHJlc3M9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAga2V5IHByZXNzIGNvdW50OiB7e2NvdW50fX0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdTdWJtaXQKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEVuYWJsZXMgYmluZGluZyBhbmd1bGFyIGV4cHJlc3Npb25zIHRvIG9uc3VibWl0IGV2ZW50cy4KICAgKgogICAqIEFkZGl0aW9uYWxseSBpdCBwcmV2ZW50cyB0aGUgZGVmYXVsdCBhY3Rpb24gKHdoaWNoIGZvciBmb3JtIG1lYW5zIHNlbmRpbmcgdGhlIHJlcXVlc3QgdG8gdGhlCiAgICogc2VydmVyIGFuZCByZWxvYWRpbmcgdGhlIGN1cnJlbnQgcGFnZSksIGJ1dCBvbmx5IGlmIHRoZSBmb3JtIGRvZXMgbm90IGNvbnRhaW4gYGFjdGlvbmAsCiAgICogYGRhdGEtYWN0aW9uYCwgb3IgYHgtYWN0aW9uYCBhdHRyaWJ1dGVzLgogICAqCiAgICogQGVsZW1lbnQgZm9ybQogICAqIEBwcmlvcml0eSAwCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1N1Ym1pdCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsLgogICAqICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLmxpc3QgPSBbXTsKICAgICAgICAgICRzY29wZS50ZXh0ID0gJ2hlbGxvJzsKICAgICAgICAgICRzY29wZS5zdWJtaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCRzY29wZS50ZXh0KSB7CiAgICAgICAgICAgICAgJHNjb3BlLmxpc3QucHVzaCh0aGlzLnRleHQpOwogICAgICAgICAgICAgICRzY29wZS50ZXh0ID0gJyc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICA8L3NjcmlwdD4KICAgPGZvcm0gbmctc3VibWl0PSJzdWJtaXQoKSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIEVudGVyIHRleHQgYW5kIGhpdCBlbnRlcjoKICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJ0ZXh0IiBuYW1lPSJ0ZXh0IiAvPgogICA8aW5wdXQgdHlwZT0ic3VibWl0IiBpZD0ic3VibWl0IiB2YWx1ZT0iU3VibWl0IiAvPgogICA8cHJlPmxpc3Q9e3tsaXN0fX08L3ByZT4KICAgPC9mb3JtPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGNoZWNrIG5nLXN1Ym1pdCcsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdsaXN0JykpLmdldFRleHQoKSkudG9CZSgnbGlzdD1bXScpOwogICAgICAgICBlbGVtZW50KGJ5LmNzcygnI3N1Ym1pdCcpKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdsaXN0JykpLmdldFRleHQoKSkudG9Db250YWluKCdoZWxsbycpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pbnB1dCgndGV4dCcpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvQmUoJycpOwogICAgICAgfSk7CiAgIGl0KCdzaG91bGQgaWdub3JlIGVtcHR5IHN0cmluZ3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnbGlzdCcpKS5nZXRUZXh0KCkpLnRvQmUoJ2xpc3Q9W10nKTsKICAgICAgICAgZWxlbWVudChieS5jc3MoJyNzdWJtaXQnKSkuY2xpY2soKTsKICAgICAgICAgZWxlbWVudChieS5jc3MoJyNzdWJtaXQnKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnbGlzdCcpKS5nZXRUZXh0KCkpLnRvQ29udGFpbignaGVsbG8nKTsKICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0ZvY3VzCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBmb2N1cyBldmVudC4KICAgKgogICAqIEBlbGVtZW50IHdpbmRvdywgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIGEKICAgKiBAcHJpb3JpdHkgMAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdGb2N1cyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICogZm9jdXMuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogICAqCiAgICogQGV4YW1wbGUKICAgKiBTZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsaWNrIG5nQ2xpY2t9CiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0JsdXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGJsdXIgZXZlbnQuCiAgICoKICAgKiBAZWxlbWVudCB3aW5kb3csIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBhCiAgICogQHByaW9yaXR5IDAKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmx1ciB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICogYmx1ci4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAgICoKICAgKiBAZXhhbXBsZQogICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nQ29weQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gY29weSBldmVudC4KICAgKgogICAqIEBlbGVtZW50IHdpbmRvdywgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIGEKICAgKiBAcHJpb3JpdHkgMAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDb3B5IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBjb3B5LiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGlucHV0IG5nLWNvcHk9ImNvcGllZD10cnVlIiBuZy1pbml0PSJjb3BpZWQ9ZmFsc2U7IHZhbHVlPSdjb3B5IG1lJyIgbmctbW9kZWw9InZhbHVlIj4KICAgY29waWVkOiB7e2NvcGllZH19CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdDdXQKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGN1dCBldmVudC4KICAgKgogICAqIEBlbGVtZW50IHdpbmRvdywgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIGEKICAgKiBAcHJpb3JpdHkgMAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDdXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAqIGN1dC4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxpbnB1dCBuZy1jdXQ9ImN1dD10cnVlIiBuZy1pbml0PSJjdXQ9ZmFsc2U7IHZhbHVlPSdjdXQgbWUnIiBuZy1tb2RlbD0idmFsdWUiPgogICBjdXQ6IHt7Y3V0fX0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ1Bhc3RlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBwYXN0ZSBldmVudC4KICAgKgogICAqIEBlbGVtZW50IHdpbmRvdywgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIGEKICAgKiBAcHJpb3JpdHkgMAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdQYXN0ZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICogcGFzdGUuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8aW5wdXQgbmctcGFzdGU9InBhc3RlPXRydWUiIG5nLWluaXQ9InBhc3RlPWZhbHNlIiBwbGFjZWhvbGRlcj0ncGFzdGUgaGVyZSc+CiAgIHBhc3RlZDoge3twYXN0ZX19CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdJZgogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgYG5nSWZgIGRpcmVjdGl2ZSByZW1vdmVzIG9yIHJlY3JlYXRlcyBhIHBvcnRpb24gb2YgdGhlIERPTSB0cmVlIGJhc2VkIG9uIGFuCiAgICoge2V4cHJlc3Npb259LiBJZiB0aGUgZXhwcmVzc2lvbiBhc3NpZ25lZCB0byBgbmdJZmAgZXZhbHVhdGVzIHRvIGEgZmFsc2UKICAgKiB2YWx1ZSB0aGVuIHRoZSBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NLCBvdGhlcndpc2UgYSBjbG9uZSBvZiB0aGUKICAgKiBlbGVtZW50IGlzIHJlaW5zZXJ0ZWQgaW50byB0aGUgRE9NLgogICAqCiAgICogYG5nSWZgIGRpZmZlcnMgZnJvbSBgbmdTaG93YCBhbmQgYG5nSGlkZWAgaW4gdGhhdCBgbmdJZmAgY29tcGxldGVseSByZW1vdmVzIGFuZCByZWNyZWF0ZXMgdGhlCiAgICogZWxlbWVudCBpbiB0aGUgRE9NIHJhdGhlciB0aGFuIGNoYW5naW5nIGl0cyB2aXNpYmlsaXR5IHZpYSB0aGUgYGRpc3BsYXlgIGNzcyBwcm9wZXJ0eS4gIEEgY29tbW9uCiAgICogY2FzZSB3aGVuIHRoaXMgZGlmZmVyZW5jZSBpcyBzaWduaWZpY2FudCBpcyB3aGVuIHVzaW5nIGNzcyBzZWxlY3RvcnMgdGhhdCByZWx5IG9uIGFuIGVsZW1lbnQncwogICAqIHBvc2l0aW9uIHdpdGhpbiB0aGUgRE9NLCBzdWNoIGFzIHRoZSBgOmZpcnN0LWNoaWxkYCBvciBgOmxhc3QtY2hpbGRgIHBzZXVkby1jbGFzc2VzLgogICAqCiAgICogTm90ZSB0aGF0IHdoZW4gYW4gZWxlbWVudCBpcyByZW1vdmVkIHVzaW5nIGBuZ0lmYCBpdHMgc2NvcGUgaXMgZGVzdHJveWVkIGFuZCBhIG5ldyBzY29wZQogICAqIGlzIGNyZWF0ZWQgd2hlbiB0aGUgZWxlbWVudCBpcyByZXN0b3JlZC4gIFRoZSBzY29wZSBjcmVhdGVkIHdpdGhpbiBgbmdJZmAgaW5oZXJpdHMgZnJvbQogICAqIGl0cyBwYXJlbnQgc2NvcGUgdXNpbmcKICAgKiBbcHJvdG90eXBhbCBpbmhlcml0YW5jZV0oaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy93aWtpL1RoZS1OdWFuY2VzLW9mLVNjb3BlLVByb3RvdHlwYWwtSW5oZXJpdGFuY2UpLgogICAqIEFuIGltcG9ydGFudCBpbXBsaWNhdGlvbiBvZiB0aGlzIGlzIGlmIGBuZ01vZGVsYCBpcyB1c2VkIHdpdGhpbiBgbmdJZmAgdG8gYmluZCB0bwogICAqIGEgamF2YXNjcmlwdCBwcmltaXRpdmUgZGVmaW5lZCBpbiB0aGUgcGFyZW50IHNjb3BlLiBJbiB0aGlzIGNhc2UgYW55IG1vZGlmaWNhdGlvbnMgbWFkZSB0byB0aGUKICAgKiB2YXJpYWJsZSB3aXRoaW4gdGhlIGNoaWxkIHNjb3BlIHdpbGwgb3ZlcnJpZGUgKGhpZGUpIHRoZSB2YWx1ZSBpbiB0aGUgcGFyZW50IHNjb3BlLgogICAqCiAgICogQWxzbywgYG5nSWZgIHJlY3JlYXRlcyBlbGVtZW50cyB1c2luZyB0aGVpciBjb21waWxlZCBzdGF0ZS4gQW4gZXhhbXBsZSBvZiB0aGlzIGJlaGF2aW9yCiAgICogaXMgaWYgYW4gZWxlbWVudCdzIGNsYXNzIGF0dHJpYnV0ZSBpcyBkaXJlY3RseSBtb2RpZmllZCBhZnRlciBpdCdzIGNvbXBpbGVkLCB1c2luZyBzb21ldGhpbmcgbGlrZQogICAqIGpRdWVyeSdzIGAuYWRkQ2xhc3MoKWAgbWV0aG9kLCBhbmQgdGhlIGVsZW1lbnQgaXMgbGF0ZXIgcmVtb3ZlZC4gV2hlbiBgbmdJZmAgcmVjcmVhdGVzIHRoZSBlbGVtZW50CiAgICogdGhlIGFkZGVkIGNsYXNzIHdpbGwgYmUgbG9zdCBiZWNhdXNlIHRoZSBvcmlnaW5hbCBjb21waWxlZCBzdGF0ZSBpcyB1c2VkIHRvIHJlZ2VuZXJhdGUgdGhlIGVsZW1lbnQuCiAgICoKICAgKiBBZGRpdGlvbmFsbHksIHlvdSBjYW4gcHJvdmlkZSBhbmltYXRpb25zIHZpYSB0aGUgYG5nQW5pbWF0ZWAgbW9kdWxlIHRvIGFuaW1hdGUgdGhlIGBlbnRlcmAKICAgKiBhbmQgYGxlYXZlYCBlZmZlY3RzLgogICAqCiAgICogQGFuaW1hdGlvbnMKICAgKiBlbnRlciAtIGhhcHBlbnMganVzdCBhZnRlciB0aGUgbmdJZiBjb250ZW50cyBjaGFuZ2UgYW5kIGEgbmV3IERPTSBlbGVtZW50IGlzIGNyZWF0ZWQgYW5kIGluamVjdGVkIGludG8gdGhlIG5nSWYgY29udGFpbmVyCiAgICogbGVhdmUgLSBoYXBwZW5zIGp1c3QgYmVmb3JlIHRoZSBuZ0lmIGNvbnRlbnRzIGFyZSByZW1vdmVkIGZyb20gdGhlIERPTQogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHNjb3BlCiAgICogQHByaW9yaXR5IDYwMAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdJZiBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgZmFsc3kgdGhlbgogICAqICAgICB0aGUgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTSB0cmVlLiBJZiBpdCBpcyB0cnV0aHkgYSBjb3B5IG9mIHRoZSBjb21waWxlZAogICAqICAgICBlbGVtZW50IGlzIGFkZGVkIHRvIHRoZSBET00gdHJlZS4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgQ2xpY2sgbWU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiIG5nLWluaXQ9ImNoZWNrZWQ9dHJ1ZSIgLz48YnIvPgogICBTaG93IHdoZW4gY2hlY2tlZDoKICAgPHNwYW4gbmctaWY9ImNoZWNrZWQiIGNsYXNzPSJhbmltYXRlLWlmIj4KICAgSSdtIHJlbW92ZWQgd2hlbiB0aGUgY2hlY2tib3ggaXMgdW5jaGVja2VkLgogICA8L3NwYW4+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAuYW5pbWF0ZS1pZiB7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgfQoKICAgLmFuaW1hdGUtaWYubmctZW50ZXIsIC5hbmltYXRlLWlmLm5nLWxlYXZlIHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgICB0cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgIH0KCiAgIC5hbmltYXRlLWlmLm5nLWVudGVyLAogICAuYW5pbWF0ZS1pZi5uZy1sZWF2ZS5uZy1sZWF2ZS1hY3RpdmUgewogICAgICAgIG9wYWNpdHk6MDsKICAgICAgfQoKICAgLmFuaW1hdGUtaWYubmctbGVhdmUsCiAgIC5hbmltYXRlLWlmLm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAgICAgICAgb3BhY2l0eToxOwogICAgICB9CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIHZhciBuZ0lmRGlyZWN0aXZlID0gWyckYW5pbWF0ZScsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CiAgICByZXR1cm4gewogICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgIHByaW9yaXR5OiA2MDAsCiAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICByZXN0cmljdDogJ0EnLAogICAgICAkJHRsYjogdHJ1ZSwKICAgICAgbGluazogZnVuY3Rpb24gKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJsLCAkdHJhbnNjbHVkZSkgewogICAgICAgIHZhciBibG9jaywgY2hpbGRTY29wZSwgcHJldmlvdXNFbGVtZW50czsKICAgICAgICAkc2NvcGUuJHdhdGNoKCRhdHRyLm5nSWYsIGZ1bmN0aW9uIG5nSWZXYXRjaEFjdGlvbih2YWx1ZSkgewoKICAgICAgICAgIGlmICh0b0Jvb2xlYW4odmFsdWUpKSB7CiAgICAgICAgICAgIGlmICghY2hpbGRTY29wZSkgewogICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSAkc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICR0cmFuc2NsdWRlKGNoaWxkU2NvcGUsIGZ1bmN0aW9uIChjbG9uZSkgewogICAgICAgICAgICAgICAgY2xvbmVbY2xvbmUubGVuZ3RoKytdID0gZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnIGVuZCBuZ0lmOiAnICsgJGF0dHIubmdJZiArICcgJyk7CiAgICAgICAgICAgICAgICAvLyBOb3RlOiBXZSBvbmx5IG5lZWQgdGhlIGZpcnN0L2xhc3Qgbm9kZSBvZiB0aGUgY2xvbmVkIG5vZGVzLgogICAgICAgICAgICAgICAgLy8gSG93ZXZlciwgd2UgbmVlZCB0byBrZWVwIHRoZSByZWZlcmVuY2UgdG8gdGhlIGpxbGl0ZSB3cmFwcGVyIGFzIGl0IG1pZ2h0IGJlIGNoYW5nZWQgbGF0ZXIKICAgICAgICAgICAgICAgIC8vIGJ5IGEgZGlyZWN0aXZlIHdpdGggdGVtcGxhdGVVcmwgd2hlbiBpdHMgdGVtcGxhdGUgYXJyaXZlcy4KICAgICAgICAgICAgICAgIGJsb2NrID0gewogICAgICAgICAgICAgICAgICBjbG9uZTogY2xvbmUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjbG9uZSwgJGVsZW1lbnQucGFyZW50KCksICRlbGVtZW50KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYocHJldmlvdXNFbGVtZW50cykgewogICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudHMucmVtb3ZlKCk7CiAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50cyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoY2hpbGRTY29wZSkgewogICAgICAgICAgICAgIGNoaWxkU2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihibG9jaykgewogICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudHMgPSBnZXRCbG9ja0VsZW1lbnRzKGJsb2NrLmNsb25lKTsKICAgICAgICAgICAgICAkYW5pbWF0ZS5sZWF2ZShwcmV2aW91c0VsZW1lbnRzLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudHMgPSBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGJsb2NrID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogIH1dOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdJbmNsdWRlCiAgICogQHJlc3RyaWN0IEVDQQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRmV0Y2hlcywgY29tcGlsZXMgYW5kIGluY2x1ZGVzIGFuIGV4dGVybmFsIEhUTUwgZnJhZ21lbnQuCiAgICoKICAgKiBCeSBkZWZhdWx0LCB0aGUgdGVtcGxhdGUgVVJMIGlzIHJlc3RyaWN0ZWQgdG8gdGhlIHNhbWUgZG9tYWluIGFuZCBwcm90b2NvbCBhcyB0aGUKICAgKiBhcHBsaWNhdGlvbiBkb2N1bWVudC4gVGhpcyBpcyBkb25lIGJ5IGNhbGxpbmcge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAqICRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsfSBvbiBpdC4gVG8gbG9hZCB0ZW1wbGF0ZXMgZnJvbSBvdGhlciBkb21haW5zIG9yIHByb3RvY29scwogICAqIHlvdSBtYXkgZWl0aGVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCB3aGl0ZWxpc3QgdGhlbX0gb3IKICAgKiBbd3JhcCB0aGVtXShuZy4kc2NlI3RydXN0QXNSZXNvdXJjZVVybCkgYXMgdHJ1c3RlZCB2YWx1ZXMuIFJlZmVyIHRvIEFuZ3VsYXIncyB7QGxpbmsKICAgICogbmcuJHNjZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZ30uCiAgICoKICAgKiBJbiBhZGRpdGlvbiwgdGhlIGJyb3dzZXIncwogICAqIFtTYW1lIE9yaWdpbiBQb2xpY3ldKGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvYnJvd3NlcnNlYy93aWtpL1BhcnQyI1NhbWUtb3JpZ2luX3BvbGljeV9mb3JfWE1MSHR0cFJlcXVlc3QpCiAgICogYW5kIFtDcm9zcy1PcmlnaW4gUmVzb3VyY2UgU2hhcmluZyAoQ09SUyldKGh0dHA6Ly93d3cudzMub3JnL1RSL2NvcnMvKQogICAqIHBvbGljeSBtYXkgZnVydGhlciByZXN0cmljdCB3aGV0aGVyIHRoZSB0ZW1wbGF0ZSBpcyBzdWNjZXNzZnVsbHkgbG9hZGVkLgogICAqIEZvciBleGFtcGxlLCBgbmdJbmNsdWRlYCB3b24ndCB3b3JrIGZvciBjcm9zcy1kb21haW4gcmVxdWVzdHMgb24gYWxsIGJyb3dzZXJzIGFuZCBmb3IgYGZpbGU6Ly9gCiAgICogYWNjZXNzIG9uIHNvbWUgYnJvd3NlcnMuCiAgICoKICAgKiBAYW5pbWF0aW9ucwogICAqIGVudGVyIC0gYW5pbWF0aW9uIGlzIHVzZWQgdG8gYnJpbmcgbmV3IGNvbnRlbnQgaW50byB0aGUgYnJvd3Nlci4KICAgKiBsZWF2ZSAtIGFuaW1hdGlvbiBpcyB1c2VkIHRvIGFuaW1hdGUgZXhpc3RpbmcgY29udGVudCBhd2F5LgogICAqCiAgICogVGhlIGVudGVyIGFuZCBsZWF2ZSBhbmltYXRpb24gb2NjdXIgY29uY3VycmVudGx5LgogICAqCiAgICogQHNjb3BlCiAgICogQHByaW9yaXR5IDQwMAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nSW5jbHVkZXxzcmMgYW5ndWxhciBleHByZXNzaW9uIGV2YWx1YXRpbmcgdG8gVVJMLiBJZiB0aGUgc291cmNlIGlzIGEgc3RyaW5nIGNvbnN0YW50LAogICAqICAgICAgICAgICAgICAgICBtYWtlIHN1cmUgeW91IHdyYXAgaXQgaW4gKipzaW5nbGUqKiBxdW90ZXMsIGUuZy4gYHNyYz0iJ215UGFydGlhbFRlbXBsYXRlLmh0bWwnImAuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBvbmxvYWQgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB3aGVuIGEgbmV3IHBhcnRpYWwgaXMgbG9hZGVkLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBhdXRvc2Nyb2xsIFdoZXRoZXIgYG5nSW5jbHVkZWAgc2hvdWxkIGNhbGwge0BsaW5rIG5nLiRhbmNob3JTY3JvbGwKICogICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsfSB0byBzY3JvbGwgdGhlIHZpZXdwb3J0IGFmdGVyIHRoZSBjb250ZW50IGlzIGxvYWRlZC4KICAgKgogICAqICAgICAgICAgICAgICAgICAgLSBJZiB0aGUgYXR0cmlidXRlIGlzIG5vdCBzZXQsIGRpc2FibGUgc2Nyb2xsaW5nLgogICAqICAgICAgICAgICAgICAgICAgLSBJZiB0aGUgYXR0cmlidXRlIGlzIHNldCB3aXRob3V0IHZhbHVlLCBlbmFibGUgc2Nyb2xsaW5nLgogICAqICAgICAgICAgICAgICAgICAgLSBPdGhlcndpc2UgZW5hYmxlIHNjcm9sbGluZyBvbmx5IGlmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnV0aHkgdmFsdWUuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9Im5nQW5pbWF0ZSIgZGVwcz0iYW5ndWxhci1hbmltYXRlLmpzIiBhbmltYXRpb25zPSJ0cnVlIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIDxzZWxlY3QgbmctbW9kZWw9InRlbXBsYXRlIiBuZy1vcHRpb25zPSJ0Lm5hbWUgZm9yIHQgaW4gdGVtcGxhdGVzIj4KICAgPG9wdGlvbiB2YWx1ZT0iIj4oYmxhbmspPC9vcHRpb24+CiAgIDwvc2VsZWN0PgogICB1cmwgb2YgdGhlIHRlbXBsYXRlOiA8dHQ+e3t0ZW1wbGF0ZS51cmx9fTwvdHQ+CiAgIDxoci8+CiAgIDxkaXYgY2xhc3M9InNsaWRlLWFuaW1hdGUtY29udGFpbmVyIj4KICAgPGRpdiBjbGFzcz0ic2xpZGUtYW5pbWF0ZSIgbmctaW5jbHVkZT0idGVtcGxhdGUudXJsIj48L2Rpdj4KICAgPC9kaXY+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgJHNjb3BlLnRlbXBsYXRlcyA9CiAgICAgICAgICBbIHsgbmFtZTogJ3RlbXBsYXRlMS5odG1sJywgdXJsOiAndGVtcGxhdGUxLmh0bWwnfSwKICAgICAgICAgICAgeyBuYW1lOiAndGVtcGxhdGUyLmh0bWwnLCB1cmw6ICd0ZW1wbGF0ZTIuaHRtbCd9IF07CiAgICAgICAgJHNjb3BlLnRlbXBsYXRlID0gJHNjb3BlLnRlbXBsYXRlc1swXTsKICAgICAgfQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InRlbXBsYXRlMS5odG1sIj4KICAgQ29udGVudCBvZiB0ZW1wbGF0ZTEuaHRtbAogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InRlbXBsYXRlMi5odG1sIj4KICAgQ29udGVudCBvZiB0ZW1wbGF0ZTIuaHRtbAogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9ImFuaW1hdGlvbnMuY3NzIj4KICAgLnNsaWRlLWFuaW1hdGUtY29udGFpbmVyIHsKICAgICAgICBwb3NpdGlvbjpyZWxhdGl2ZTsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgaGVpZ2h0OjQwcHg7CiAgICAgICAgb3ZlcmZsb3c6aGlkZGVuOwogICAgICB9CgogICAuc2xpZGUtYW5pbWF0ZSB7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICB9CgogICAuc2xpZGUtYW5pbWF0ZS5uZy1lbnRlciwgLnNsaWRlLWFuaW1hdGUubmctbGVhdmUgewogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKCiAgICAgICAgcG9zaXRpb246YWJzb2x1dGU7CiAgICAgICAgdG9wOjA7CiAgICAgICAgbGVmdDowOwogICAgICAgIHJpZ2h0OjA7CiAgICAgICAgYm90dG9tOjA7CiAgICAgICAgZGlzcGxheTpibG9jazsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgIH0KCiAgIC5zbGlkZS1hbmltYXRlLm5nLWVudGVyIHsKICAgICAgICB0b3A6LTUwcHg7CiAgICAgIH0KICAgLnNsaWRlLWFuaW1hdGUubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICAgICAgICB0b3A6MDsKICAgICAgfQoKICAgLnNsaWRlLWFuaW1hdGUubmctbGVhdmUgewogICAgICAgIHRvcDowOwogICAgICB9CiAgIC5zbGlkZS1hbmltYXRlLm5nLWxlYXZlLm5nLWxlYXZlLWFjdGl2ZSB7CiAgICAgICAgdG9wOjUwcHg7CiAgICAgIH0KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgdmFyIHRlbXBsYXRlU2VsZWN0ID0gZWxlbWVudChieS5tb2RlbCgndGVtcGxhdGUnKSk7CiAgIHZhciBpbmNsdWRlRWxlbSA9IGVsZW1lbnQoYnkuY3NzKCdbbmctaW5jbHVkZV0nKSk7CgogICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUxLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3QoaW5jbHVkZUVsZW0uZ2V0VGV4dCgpKS50b01hdGNoKC9Db250ZW50IG9mIHRlbXBsYXRlMS5odG1sLyk7CiAgICAgIH0pOwoKICAgaXQoJ3Nob3VsZCBsb2FkIHRlbXBsYXRlMi5odG1sJywgZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGJyb3dzZXIucGFyYW1zLmJyb3dzZXIgPT0gJ2ZpcmVmb3gnKSB7CiAgICAgICAgICAvLyBGaXJlZm94IGNhbid0IGhhbmRsZSB1c2luZyBzZWxlY3RzCiAgICAgICAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvcHJvdHJhY3Rvci9pc3N1ZXMvNDgwCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlU2VsZWN0LmNsaWNrKCk7CiAgICAgICAgdGVtcGxhdGVTZWxlY3QuZWxlbWVudC5hbGwoYnkuY3NzKCdvcHRpb24nKSkuZ2V0KDIpLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KGluY2x1ZGVFbGVtLmdldFRleHQoKSkudG9NYXRjaCgvQ29udGVudCBvZiB0ZW1wbGF0ZTIuaHRtbC8pOwogICAgICB9KTsKCiAgIGl0KCdzaG91bGQgY2hhbmdlIHRvIGJsYW5rJywgZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKGJyb3dzZXIucGFyYW1zLmJyb3dzZXIgPT0gJ2ZpcmVmb3gnKSB7CiAgICAgICAgICAvLyBGaXJlZm94IGNhbid0IGhhbmRsZSB1c2luZyBzZWxlY3RzCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlU2VsZWN0LmNsaWNrKCk7CiAgICAgICAgdGVtcGxhdGVTZWxlY3QuZWxlbWVudC5hbGwoYnkuY3NzKCdvcHRpb24nKSkuZ2V0KDApLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KGluY2x1ZGVFbGVtLmlzUHJlc2VudCgpKS50b0JlKGZhbHNlKTsKICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGV2ZW50CiAgICogQG5hbWUgbmdJbmNsdWRlIyRpbmNsdWRlQ29udGVudFJlcXVlc3RlZAogICAqIEBldmVudFR5cGUgZW1pdCBvbiB0aGUgc2NvcGUgbmdJbmNsdWRlIHdhcyBkZWNsYXJlZCBpbgogICAqIEBkZXNjcmlwdGlvbgogICAqIEVtaXR0ZWQgZXZlcnkgdGltZSB0aGUgbmdJbmNsdWRlIGNvbnRlbnQgaXMgcmVxdWVzdGVkLgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGV2ZW50CiAgICogQG5hbWUgbmdJbmNsdWRlIyRpbmNsdWRlQ29udGVudExvYWRlZAogICAqIEBldmVudFR5cGUgZW1pdCBvbiB0aGUgY3VycmVudCBuZ0luY2x1ZGUgc2NvcGUKICAgKiBAZGVzY3JpcHRpb24KICAgKiBFbWl0dGVkIGV2ZXJ5IHRpbWUgdGhlIG5nSW5jbHVkZSBjb250ZW50IGlzIHJlbG9hZGVkLgogICAqLwogIHZhciBuZ0luY2x1ZGVEaXJlY3RpdmUgPSBbJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywgJyRhbmNob3JTY3JvbGwnLCAnJGFuaW1hdGUnLCAnJHNjZScsCiAgICBmdW5jdGlvbigkaHR0cCwgICAkdGVtcGxhdGVDYWNoZSwgICAkYW5jaG9yU2Nyb2xsLCAgICRhbmltYXRlLCAgICRzY2UpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0VDQScsCiAgICAgICAgcHJpb3JpdHk6IDQwMCwKICAgICAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgY29udHJvbGxlcjogYW5ndWxhci5ub29wLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIHZhciBzcmNFeHAgPSBhdHRyLm5nSW5jbHVkZSB8fCBhdHRyLnNyYywKICAgICAgICAgICAgb25sb2FkRXhwID0gYXR0ci5vbmxvYWQgfHwgJycsCiAgICAgICAgICAgIGF1dG9TY3JvbGxFeHAgPSBhdHRyLmF1dG9zY3JvbGw7CgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmwsICR0cmFuc2NsdWRlKSB7CiAgICAgICAgICAgIHZhciBjaGFuZ2VDb3VudGVyID0gMCwKICAgICAgICAgICAgICBjdXJyZW50U2NvcGUsCiAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50LAogICAgICAgICAgICAgIGN1cnJlbnRFbGVtZW50OwoKICAgICAgICAgICAgdmFyIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZihwcmV2aW91c0VsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmKGN1cnJlbnRTY29wZSkgewogICAgICAgICAgICAgICAgY3VycmVudFNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICBjdXJyZW50U2NvcGUgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZihjdXJyZW50RWxlbWVudCkgewogICAgICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoY3VycmVudEVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnQgPSBudWxsOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnQgPSBjdXJyZW50RWxlbWVudDsKICAgICAgICAgICAgICAgIGN1cnJlbnRFbGVtZW50ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBzY29wZS4kd2F0Y2goJHNjZS5wYXJzZUFzUmVzb3VyY2VVcmwoc3JjRXhwKSwgZnVuY3Rpb24gbmdJbmNsdWRlV2F0Y2hBY3Rpb24oc3JjKSB7CiAgICAgICAgICAgICAgdmFyIGFmdGVyQW5pbWF0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGF1dG9TY3JvbGxFeHApICYmICghYXV0b1Njcm9sbEV4cCB8fCBzY29wZS4kZXZhbChhdXRvU2Nyb2xsRXhwKSkpIHsKICAgICAgICAgICAgICAgICAgJGFuY2hvclNjcm9sbCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdmFyIHRoaXNDaGFuZ2VJZCA9ICsrY2hhbmdlQ291bnRlcjsKCiAgICAgICAgICAgICAgaWYgKHNyYykgewogICAgICAgICAgICAgICAgJGh0dHAuZ2V0KHNyYywge2NhY2hlOiAkdGVtcGxhdGVDYWNoZX0pLnN1Y2Nlc3MoZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgaWYgKHRoaXNDaGFuZ2VJZCAhPT0gY2hhbmdlQ291bnRlcikgcmV0dXJuOwogICAgICAgICAgICAgICAgICB2YXIgbmV3U2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgIGN0cmwudGVtcGxhdGUgPSByZXNwb25zZTsKCiAgICAgICAgICAgICAgICAgIC8vIE5vdGU6IFRoaXMgd2lsbCBhbHNvIGxpbmsgYWxsIGNoaWxkcmVuIG9mIG5nLWluY2x1ZGUgdGhhdCB3ZXJlIGNvbnRhaW5lZCBpbiB0aGUgb3JpZ2luYWwKICAgICAgICAgICAgICAgICAgLy8gaHRtbC4gSWYgdGhhdCBjb250ZW50IGNvbnRhaW5zIGNvbnRyb2xsZXJzLCAuLi4gdGhleSBjb3VsZCBwb2xsdXRlL2NoYW5nZSB0aGUgc2NvcGUuCiAgICAgICAgICAgICAgICAgIC8vIEhvd2V2ZXIsIHVzaW5nIG5nLWluY2x1ZGUgb24gYW4gZWxlbWVudCB3aXRoIGFkZGl0aW9uYWwgY29udGVudCBkb2VzIG5vdCBtYWtlIHNlbnNlLi4uCiAgICAgICAgICAgICAgICAgIC8vIE5vdGU6IFdlIGNhbid0IHJlbW92ZSB0aGVtIGluIHRoZSBjbG9uZUF0dGNoRm4gb2YgJHRyYW5zY2x1ZGUgYXMgdGhhdAogICAgICAgICAgICAgICAgICAvLyBmdW5jdGlvbiBpcyBjYWxsZWQgYmVmb3JlIGxpbmtpbmcgdGhlIGNvbnRlbnQsIHdoaWNoIHdvdWxkIGFwcGx5IGNoaWxkCiAgICAgICAgICAgICAgICAgIC8vIGRpcmVjdGl2ZXMgdG8gbm9uIGV4aXN0aW5nIGVsZW1lbnRzLgogICAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSAkdHJhbnNjbHVkZShuZXdTY29wZSwgZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhbnVwTGFzdEluY2x1ZGVDb250ZW50KCk7CiAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUuZW50ZXIoY2xvbmUsIG51bGwsICRlbGVtZW50LCBhZnRlckFuaW1hdGlvbik7CiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgY3VycmVudFNjb3BlID0gbmV3U2NvcGU7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRFbGVtZW50ID0gY2xvbmU7CgogICAgICAgICAgICAgICAgICBjdXJyZW50U2NvcGUuJGVtaXQoJyRpbmNsdWRlQ29udGVudExvYWRlZCcpOwogICAgICAgICAgICAgICAgICBzY29wZS4kZXZhbChvbmxvYWRFeHApOwogICAgICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0aGlzQ2hhbmdlSWQgPT09IGNoYW5nZUNvdW50ZXIpIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgc2NvcGUuJGVtaXQoJyRpbmNsdWRlQ29udGVudFJlcXVlc3RlZCcpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjbGVhbnVwTGFzdEluY2x1ZGVDb250ZW50KCk7CiAgICAgICAgICAgICAgICBjdHJsLnRlbXBsYXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH07CiAgICB9XTsKCi8vIFRoaXMgZGlyZWN0aXZlIGlzIGNhbGxlZCBkdXJpbmcgdGhlICR0cmFuc2NsdWRlIGNhbGwgb2YgdGhlIGZpcnN0IGBuZ0luY2x1ZGVgIGRpcmVjdGl2ZS4KLy8gSXQgd2lsbCByZXBsYWNlIGFuZCBjb21waWxlIHRoZSBjb250ZW50IG9mIHRoZSBlbGVtZW50IHdpdGggdGhlIGxvYWRlZCB0ZW1wbGF0ZS4KLy8gV2UgbmVlZCB0aGlzIGRpcmVjdGl2ZSBzbyB0aGF0IHRoZSBlbGVtZW50IGNvbnRlbnQgaXMgYWxyZWFkeSBmaWxsZWQgd2hlbgovLyB0aGUgbGluayBmdW5jdGlvbiBvZiBhbm90aGVyIGRpcmVjdGl2ZSBvbiB0aGUgc2FtZSBlbGVtZW50IGFzIG5nSW5jbHVkZQovLyBpcyBjYWxsZWQuCiAgdmFyIG5nSW5jbHVkZUZpbGxDb250ZW50RGlyZWN0aXZlID0gWyckY29tcGlsZScsCiAgICBmdW5jdGlvbigkY29tcGlsZSkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRUNBJywKICAgICAgICBwcmlvcml0eTogLTQwMCwKICAgICAgICByZXF1aXJlOiAnbmdJbmNsdWRlJywKICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJsKSB7CiAgICAgICAgICAkZWxlbWVudC5odG1sKGN0cmwudGVtcGxhdGUpOwogICAgICAgICAgJGNvbXBpbGUoJGVsZW1lbnQuY29udGVudHMoKSkoc2NvcGUpOwogICAgICAgIH0KICAgICAgfTsKICAgIH1dOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdJbml0CiAgICogQHJlc3RyaWN0IEFDCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgYG5nSW5pdGAgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gZXZhbHVhdGUgYW4gZXhwcmVzc2lvbiBpbiB0aGUKICAgKiBjdXJyZW50IHNjb3BlLgogICAqCiAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtZXJyb3IiPgogICAqIFRoZSBvbmx5IGFwcHJvcHJpYXRlIHVzZSBvZiBgbmdJbml0YCBpcyBmb3IgYWxpYXNpbmcgc3BlY2lhbCBwcm9wZXJ0aWVzIG9mCiAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBgbmdSZXBlYXRgfSwgYXMgc2VlbiBpbiB0aGUgZGVtbyBiZWxvdy4gQmVzaWRlcyB0aGlzIGNhc2UsIHlvdQogICAqIHNob3VsZCB1c2Uge0BsaW5rIGd1aWRlL2NvbnRyb2xsZXIgY29udHJvbGxlcnN9IHJhdGhlciB0aGFuIGBuZ0luaXRgCiAgICogdG8gaW5pdGlhbGl6ZSB2YWx1ZXMgb24gYSBzY29wZS4KICAgKiA8L2Rpdj4KICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICAgKiAqKk5vdGUqKjogSWYgeW91IGhhdmUgYXNzaWdubWVudCBpbiBgbmdJbml0YCBhbG9uZyB3aXRoIHtAbGluayBuZy4kZmlsdGVyIGAkZmlsdGVyYH0sIG1ha2UKICAgKiBzdXJlIHlvdSBoYXZlIHBhcmVudGhlc2lzIGZvciBjb3JyZWN0IHByZWNlZGVuY2U6CiAgICogPHByZSBjbGFzcz0icHJldHR5cHJpbnQiPgogICAqICAgPGRpdiBuZy1pbml0PSJ0ZXN0MSA9IChkYXRhIHwgb3JkZXJCeTonbmFtZScpIj48L2Rpdj4KICAgKiA8L3ByZT4KICAgKiA8L2Rpdj4KICAgKgogICAqIEBwcmlvcml0eSA0NTAKICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdJbml0IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAkc2NvcGUubGlzdCA9IFtbJ2EnLCAnYiddLCBbJ2MnLCAnZCddXTsKICAgICB9CiAgIDwvc2NyaXB0PgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICA8ZGl2IG5nLXJlcGVhdD0iaW5uZXJMaXN0IGluIGxpc3QiIG5nLWluaXQ9Im91dGVySW5kZXggPSAkaW5kZXgiPgogICA8ZGl2IG5nLXJlcGVhdD0idmFsdWUgaW4gaW5uZXJMaXN0IiBuZy1pbml0PSJpbm5lckluZGV4ID0gJGluZGV4Ij4KICAgPHNwYW4gY2xhc3M9ImV4YW1wbGUtaW5pdCI+bGlzdFsge3tvdXRlckluZGV4fX0gXVsge3tpbm5lckluZGV4fX0gXSA9IHt7dmFsdWV9fTs8L3NwYW4+CiAgIDwvZGl2PgogICA8L2Rpdj4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgYWxpYXMgaW5kZXggcG9zaXRpb25zJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBlbGVtZW50cyA9IGVsZW1lbnQuYWxsKGJ5LmNzcygnLmV4YW1wbGUtaW5pdCcpKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnRzLmdldCgwKS5nZXRUZXh0KCkpLnRvQmUoJ2xpc3RbIDAgXVsgMCBdID0gYTsnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnRzLmdldCgxKS5nZXRUZXh0KCkpLnRvQmUoJ2xpc3RbIDAgXVsgMSBdID0gYjsnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnRzLmdldCgyKS5nZXRUZXh0KCkpLnRvQmUoJ2xpc3RbIDEgXVsgMCBdID0gYzsnKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnRzLmdldCgzKS5nZXRUZXh0KCkpLnRvQmUoJ2xpc3RbIDEgXVsgMSBdID0gZDsnKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICB2YXIgbmdJbml0RGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgcHJpb3JpdHk6IDQ1MCwKICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIHByZTogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICBzY29wZS4kZXZhbChhdHRycy5uZ0luaXQpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nTm9uQmluZGFibGUKICAgKiBAcmVzdHJpY3QgQUMKICAgKiBAcHJpb3JpdHkgMTAwMAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGBuZ05vbkJpbmRhYmxlYCBkaXJlY3RpdmUgdGVsbHMgQW5ndWxhciBub3QgdG8gY29tcGlsZSBvciBiaW5kIHRoZSBjb250ZW50cyBvZiB0aGUgY3VycmVudAogICAqIERPTSBlbGVtZW50LiBUaGlzIGlzIHVzZWZ1bCBpZiB0aGUgZWxlbWVudCBjb250YWlucyB3aGF0IGFwcGVhcnMgdG8gYmUgQW5ndWxhciBkaXJlY3RpdmVzIGFuZAogICAqIGJpbmRpbmdzIGJ1dCB3aGljaCBzaG91bGQgYmUgaWdub3JlZCBieSBBbmd1bGFyLiBUaGlzIGNvdWxkIGJlIHRoZSBjYXNlIGlmIHlvdSBoYXZlIGEgc2l0ZSB0aGF0CiAgICogZGlzcGxheXMgc25pcHBldHMgb2YgY29kZSwgZm9yIGluc3RhbmNlLgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICoKICAgKiBAZXhhbXBsZQogICAqIEluIHRoaXMgZXhhbXBsZSB0aGVyZSBhcmUgdHdvIGxvY2F0aW9ucyB3aGVyZSBhIHNpbXBsZSBpbnRlcnBvbGF0aW9uIGJpbmRpbmcgKGB7e319YCkgaXMgcHJlc2VudCwKICAgKiBidXQgdGhlIG9uZSB3cmFwcGVkIGluIGBuZ05vbkJpbmRhYmxlYCBpcyBsZWZ0IGFsb25lLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8ZGl2Pk5vcm1hbDoge3sxICsgMn19PC9kaXY+CiAgIDxkaXYgbmctbm9uLWJpbmRhYmxlPklnbm9yZWQ6IHt7MSArIDJ9fTwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGNoZWNrIG5nLW5vbi1iaW5kYWJsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCcxICsgMicpKS5nZXRUZXh0KCkpLnRvQ29udGFpbignMycpOwogICAgICAgICBleHBlY3QoZWxlbWVudC5hbGwoYnkuY3NzKCdkaXYnKSkubGFzdCgpLmdldFRleHQoKSkudG9NYXRjaCgvMSBcKyAyLyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nTm9uQmluZGFibGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7IHRlcm1pbmFsOiB0cnVlLCBwcmlvcml0eTogMTAwMCB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nUGx1cmFsaXplCiAgICogQHJlc3RyaWN0IEVBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBgbmdQbHVyYWxpemVgIGlzIGEgZGlyZWN0aXZlIHRoYXQgZGlzcGxheXMgbWVzc2FnZXMgYWNjb3JkaW5nIHRvIGVuLVVTIGxvY2FsaXphdGlvbiBydWxlcy4KICAgKiBUaGVzZSBydWxlcyBhcmUgYnVuZGxlZCB3aXRoIGFuZ3VsYXIuanMsIGJ1dCBjYW4gYmUgb3ZlcnJpZGRlbgogICAqIChzZWUge0BsaW5rIGd1aWRlL2kxOG4gQW5ndWxhciBpMThufSBkZXYgZ3VpZGUpLiBZb3UgY29uZmlndXJlIG5nUGx1cmFsaXplIGRpcmVjdGl2ZQogICAqIGJ5IHNwZWNpZnlpbmcgdGhlIG1hcHBpbmdzIGJldHdlZW4KICAgKiBbcGx1cmFsIGNhdGVnb3JpZXNdKGh0dHA6Ly91bmljb2RlLm9yZy9yZXBvcy9jbGRyLXRtcC90cnVuay9kaWZmL3N1cHBsZW1lbnRhbC9sYW5ndWFnZV9wbHVyYWxfcnVsZXMuaHRtbCkKICAgKiBhbmQgdGhlIHN0cmluZ3MgdG8gYmUgZGlzcGxheWVkLgogICAqCiAgICogIyBQbHVyYWwgY2F0ZWdvcmllcyBhbmQgZXhwbGljaXQgbnVtYmVyIHJ1bGVzCiAgICogVGhlcmUgYXJlIHR3bwogICAqIFtwbHVyYWwgY2F0ZWdvcmllc10oaHR0cDovL3VuaWNvZGUub3JnL3JlcG9zL2NsZHItdG1wL3RydW5rL2RpZmYvc3VwcGxlbWVudGFsL2xhbmd1YWdlX3BsdXJhbF9ydWxlcy5odG1sKQogICAqIGluIEFuZ3VsYXIncyBkZWZhdWx0IGVuLVVTIGxvY2FsZTogIm9uZSIgYW5kICJvdGhlciIuCiAgICoKICAgKiBXaGlsZSBhIHBsdXJhbCBjYXRlZ29yeSBtYXkgbWF0Y2ggbWFueSBudW1iZXJzIChmb3IgZXhhbXBsZSwgaW4gZW4tVVMgbG9jYWxlLCAib3RoZXIiIGNhbiBtYXRjaAogICAqIGFueSBudW1iZXIgdGhhdCBpcyBub3QgMSksIGFuIGV4cGxpY2l0IG51bWJlciBydWxlIGNhbiBvbmx5IG1hdGNoIG9uZSBudW1iZXIuIEZvciBleGFtcGxlLCB0aGUKICAgKiBleHBsaWNpdCBudW1iZXIgcnVsZSBmb3IgIjMiIG1hdGNoZXMgdGhlIG51bWJlciAzLiBUaGVyZSBhcmUgZXhhbXBsZXMgb2YgcGx1cmFsIGNhdGVnb3JpZXMKICAgKiBhbmQgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIHRocm91Z2hvdXQgdGhlIHJlc3Qgb2YgdGhpcyBkb2N1bWVudGF0aW9uLgogICAqCiAgICogIyBDb25maWd1cmluZyBuZ1BsdXJhbGl6ZQogICAqIFlvdSBjb25maWd1cmUgbmdQbHVyYWxpemUgYnkgcHJvdmlkaW5nIDIgYXR0cmlidXRlczogYGNvdW50YCBhbmQgYHdoZW5gLgogICAqIFlvdSBjYW4gYWxzbyBwcm92aWRlIGFuIG9wdGlvbmFsIGF0dHJpYnV0ZSwgYG9mZnNldGAuCiAgICoKICAgKiBUaGUgdmFsdWUgb2YgdGhlIGBjb3VudGAgYXR0cmlidXRlIGNhbiBiZSBlaXRoZXIgYSBzdHJpbmcgb3IgYW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24KICogQW5ndWxhciBleHByZXNzaW9ufTsgdGhlc2UgYXJlIGV2YWx1YXRlZCBvbiB0aGUgY3VycmVudCBzY29wZSBmb3IgaXRzIGJvdW5kIHZhbHVlLgogICAqCiAgICogVGhlIGB3aGVuYCBhdHRyaWJ1dGUgc3BlY2lmaWVzIHRoZSBtYXBwaW5ncyBiZXR3ZWVuIHBsdXJhbCBjYXRlZ29yaWVzIGFuZCB0aGUgYWN0dWFsCiAgICogc3RyaW5nIHRvIGJlIGRpc3BsYXllZC4gVGhlIHZhbHVlIG9mIHRoZSBhdHRyaWJ1dGUgc2hvdWxkIGJlIGEgSlNPTiBvYmplY3QuCiAgICoKICAgKiBUaGUgZm9sbG93aW5nIGV4YW1wbGUgc2hvd3MgaG93IHRvIGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZToKICAgKgogICAqIGBgYGh0bWwKICAgKiA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIKICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAnMSBwZXJzb24gaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnb3RoZXInOiAne30gcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgKiA8L25nLXBsdXJhbGl6ZT4KICAgKmBgYAogICAqCiAgICogSW4gdGhlIGV4YW1wbGUsIGAiMDogTm9ib2R5IGlzIHZpZXdpbmcuImAgaXMgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUuIElmIHlvdSBkaWQgbm90CiAgICogc3BlY2lmeSB0aGlzIHJ1bGUsIDAgd291bGQgYmUgbWF0Y2hlZCB0byB0aGUgIm90aGVyIiBjYXRlZ29yeSBhbmQgIjAgcGVvcGxlIGFyZSB2aWV3aW5nIgogICAqIHdvdWxkIGJlIHNob3duIGluc3RlYWQgb2YgIk5vYm9keSBpcyB2aWV3aW5nIi4gWW91IGNhbiBzcGVjaWZ5IGFuIGV4cGxpY2l0IG51bWJlciBydWxlIGZvcgogICAqIG90aGVyIG51bWJlcnMsIGZvciBleGFtcGxlIDEyLCBzbyB0aGF0IGluc3RlYWQgb2Ygc2hvd2luZyAiMTIgcGVvcGxlIGFyZSB2aWV3aW5nIiwgeW91IGNhbgogICAqIHNob3cgImEgZG96ZW4gcGVvcGxlIGFyZSB2aWV3aW5nIi4KICAgKgogICAqIFlvdSBjYW4gdXNlIGEgc2V0IG9mIGNsb3NlZCBicmFjZXMgKGB7fWApIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSBudW1iZXIgdGhhdCB5b3Ugd2FudCBzdWJzdGl0dXRlZAogICAqIGludG8gcGx1cmFsaXplZCBzdHJpbmdzLiBJbiB0aGUgcHJldmlvdXMgZXhhbXBsZSwgQW5ndWxhciB3aWxsIHJlcGxhY2UgYHt9YCB3aXRoCiAgICogPHNwYW4gbmctbm9uLWJpbmRhYmxlPmB7e3BlcnNvbkNvdW50fX1gPC9zcGFuPi4gVGhlIGNsb3NlZCBicmFjZXMgYHt9YCBpcyBhIHBsYWNlaG9sZGVyCiAgICogZm9yIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57e251bWJlckV4cHJlc3Npb259fTwvc3Bhbj4uCiAgICoKICAgKiAjIENvbmZpZ3VyaW5nIG5nUGx1cmFsaXplIHdpdGggb2Zmc2V0CiAgICogVGhlIGBvZmZzZXRgIGF0dHJpYnV0ZSBhbGxvd3MgZnVydGhlciBjdXN0b21pemF0aW9uIG9mIHBsdXJhbGl6ZWQgdGV4dCwgd2hpY2ggY2FuIHJlc3VsdCBpbgogICAqIGEgYmV0dGVyIHVzZXIgZXhwZXJpZW5jZS4gRm9yIGV4YW1wbGUsIGluc3RlYWQgb2YgdGhlIG1lc3NhZ2UgIjQgcGVvcGxlIGFyZSB2aWV3aW5nIHRoaXMgZG9jdW1lbnQiLAogICAqIHlvdSBtaWdodCBkaXNwbGF5ICJKb2huLCBLYXRlIGFuZCAyIG90aGVycyBhcmUgdmlld2luZyB0aGlzIGRvY3VtZW50Ii4KICAgKiBUaGUgb2Zmc2V0IGF0dHJpYnV0ZSBhbGxvd3MgeW91IHRvIG9mZnNldCBhIG51bWJlciBieSBhbnkgZGVzaXJlZCB2YWx1ZS4KICAgKiBMZXQncyB0YWtlIGEgbG9vayBhdCBhbiBleGFtcGxlOgogICAqCiAgICogYGBgaHRtbAogICAqIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IiBvZmZzZXQ9MgogICAqICAgICAgICAgICAgICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICcxJzogJ3t7cGVyc29uMX19IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJzInOiAne3twZXJzb24xfX0gYW5kIHt7cGVyc29uMn19IGFyZSB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAne3twZXJzb24xfX0sIHt7cGVyc29uMn19IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIHt9IG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nfSI+CiAgICogPC9uZy1wbHVyYWxpemU+CiAgICogYGBgCiAgICoKICAgKiBOb3RpY2UgdGhhdCB3ZSBhcmUgc3RpbGwgdXNpbmcgdHdvIHBsdXJhbCBjYXRlZ29yaWVzKG9uZSwgb3RoZXIpLCBidXQgd2UgYWRkZWQKICAgKiB0aHJlZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgMCwgMSBhbmQgMi4KICAgKiBXaGVuIG9uZSBwZXJzb24sIHBlcmhhcHMgSm9obiwgdmlld3MgdGhlIGRvY3VtZW50LCAiSm9obiBpcyB2aWV3aW5nIiB3aWxsIGJlIHNob3duLgogICAqIFdoZW4gdGhyZWUgcGVvcGxlIHZpZXcgdGhlIGRvY3VtZW50LCBubyBleHBsaWNpdCBudW1iZXIgcnVsZSBpcyBmb3VuZCwgc28KICAgKiBhbiBvZmZzZXQgb2YgMiBpcyB0YWtlbiBvZmYgMywgYW5kIEFuZ3VsYXIgdXNlcyAxIHRvIGRlY2lkZSB0aGUgcGx1cmFsIGNhdGVnb3J5LgogICAqIEluIHRoaXMgY2FzZSwgcGx1cmFsIGNhdGVnb3J5ICdvbmUnIGlzIG1hdGNoZWQgYW5kICJKb2huLCBNYXJyeSBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZyIKICAgKiBpcyBzaG93bi4KICAgKgogICAqIE5vdGUgdGhhdCB3aGVuIHlvdSBzcGVjaWZ5IG9mZnNldHMsIHlvdSBtdXN0IHByb3ZpZGUgZXhwbGljaXQgbnVtYmVyIHJ1bGVzIGZvcgogICAqIG51bWJlcnMgZnJvbSAwIHVwIHRvIGFuZCBpbmNsdWRpbmcgdGhlIG9mZnNldC4gSWYgeW91IHVzZSBhbiBvZmZzZXQgb2YgMywgZm9yIGV4YW1wbGUsCiAgICogeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yIDAsIDEsIDIgYW5kIDMuIFlvdSBtdXN0IGFsc28gcHJvdmlkZSBwbHVyYWwgc3RyaW5ncyBmb3IKICAgKiBwbHVyYWwgY2F0ZWdvcmllcyAib25lIiBhbmQgIm90aGVyIi4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfGV4cHJlc3Npb259IGNvdW50IFRoZSB2YXJpYWJsZSB0byBiZSBib3VuZCB0by4KICAgKiBAcGFyYW0ge3N0cmluZ30gd2hlbiBUaGUgbWFwcGluZyBiZXR3ZWVuIHBsdXJhbCBjYXRlZ29yeSB0byBpdHMgY29ycmVzcG9uZGluZyBzdHJpbmdzLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gb2Zmc2V0IE9mZnNldCB0byBkZWR1Y3QgZnJvbSB0aGUgdG90YWwgbnVtYmVyLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAkc2NvcGUucGVyc29uMSA9ICdJZ29yJzsKICAgICAgICAgICAgJHNjb3BlLnBlcnNvbjIgPSAnTWlza28nOwogICAgICAgICAgICAkc2NvcGUucGVyc29uQ291bnQgPSAxOwogICAgICAgICAgfQogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgUGVyc29uIDE6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb24xIiB2YWx1ZT0iSWdvciIgLz48YnIvPgogICBQZXJzb24gMjo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbjIiIHZhbHVlPSJNaXNrbyIgLz48YnIvPgogICBOdW1iZXIgb2YgUGVvcGxlOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uQ291bnQiIHZhbHVlPSIxIiAvPjxici8+CgogICA8IS0tLSBFeGFtcGxlIHdpdGggc2ltcGxlIHBsdXJhbGl6YXRpb24gcnVsZXMgZm9yIGVuIGxvY2FsZSAtLS0+CiAgIFdpdGhvdXQgT2Zmc2V0OgogICA8bmctcGx1cmFsaXplIGNvdW50PSJwZXJzb25Db3VudCIKICAgd2hlbj0ieycwJzogJ05vYm9keSBpcyB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJzEgcGVyc29uIGlzIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICA8L25nLXBsdXJhbGl6ZT48YnI+CgogICA8IS0tLSBFeGFtcGxlIHdpdGggb2Zmc2V0IC0tLT4KICAgV2l0aCBPZmZzZXQoMik6CiAgIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IiBvZmZzZXQ9MgogICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcxJzogJ3t7cGVyc29uMX19IGlzIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcyJzogJ3t7cGVyc29uMX19IGFuZCB7e3BlcnNvbjJ9fSBhcmUgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIHt9IG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nfSI+CiAgIDwvbmctcGx1cmFsaXplPgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBzaG93IGNvcnJlY3QgcGx1cmFsaXplZCBzdHJpbmcnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB3aXRob3V0T2Zmc2V0ID0gZWxlbWVudC5hbGwoYnkuY3NzKCduZy1wbHVyYWxpemUnKSkuZ2V0KDApOwogICAgICAgICAgdmFyIHdpdGhPZmZzZXQgPSBlbGVtZW50LmFsbChieS5jc3MoJ25nLXBsdXJhbGl6ZScpKS5nZXQoMSk7CiAgICAgICAgICB2YXIgY291bnRJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3BlcnNvbkNvdW50JykpOwoKICAgICAgICAgIGV4cGVjdCh3aXRob3V0T2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnMSBwZXJzb24gaXMgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdCh3aXRoT2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnSWdvciBpcyB2aWV3aW5nLicpOwoKICAgICAgICAgIGNvdW50SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIGNvdW50SW5wdXQuc2VuZEtleXMoJzAnKTsKCiAgICAgICAgICBleHBlY3Qod2l0aG91dE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ05vYm9keSBpcyB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdOb2JvZHkgaXMgdmlld2luZy4nKTsKCiAgICAgICAgICBjb3VudElucHV0LmNsZWFyKCk7CiAgICAgICAgICBjb3VudElucHV0LnNlbmRLZXlzKCcyJyk7CgogICAgICAgICAgZXhwZWN0KHdpdGhvdXRPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCcyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdCh3aXRoT2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnSWdvciBhbmQgTWlza28gYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgY291bnRJbnB1dC5jbGVhcigpOwogICAgICAgICAgY291bnRJbnB1dC5zZW5kS2V5cygnMycpOwoKICAgICAgICAgIGV4cGVjdCh3aXRob3V0T2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnMyBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3Qod2l0aE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ0lnb3IsIE1pc2tvIGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nLicpOwoKICAgICAgICAgIGNvdW50SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIGNvdW50SW5wdXQuc2VuZEtleXMoJzQnKTsKCiAgICAgICAgICBleHBlY3Qod2l0aG91dE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJzQgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdJZ29yLCBNaXNrbyBhbmQgMiBvdGhlciBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgfSk7CiAgIGl0KCdzaG91bGQgc2hvdyBkYXRhLWJvdW5kIG5hbWVzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgd2l0aE9mZnNldCA9IGVsZW1lbnQuYWxsKGJ5LmNzcygnbmctcGx1cmFsaXplJykpLmdldCgxKTsKICAgICAgICAgIHZhciBwZXJzb25Db3VudCA9IGVsZW1lbnQoYnkubW9kZWwoJ3BlcnNvbkNvdW50JykpOwogICAgICAgICAgdmFyIHBlcnNvbjEgPSBlbGVtZW50KGJ5Lm1vZGVsKCdwZXJzb24xJykpOwogICAgICAgICAgdmFyIHBlcnNvbjIgPSBlbGVtZW50KGJ5Lm1vZGVsKCdwZXJzb24yJykpOwogICAgICAgICAgcGVyc29uQ291bnQuY2xlYXIoKTsKICAgICAgICAgIHBlcnNvbkNvdW50LnNlbmRLZXlzKCc0Jyk7CiAgICAgICAgICBwZXJzb24xLmNsZWFyKCk7CiAgICAgICAgICBwZXJzb24xLnNlbmRLZXlzKCdEaScpOwogICAgICAgICAgcGVyc29uMi5jbGVhcigpOwogICAgICAgICAgcGVyc29uMi5zZW5kS2V5cygnVm9qdGEnKTsKICAgICAgICAgIGV4cGVjdCh3aXRoT2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnRGksIFZvanRhIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nUGx1cmFsaXplRGlyZWN0aXZlID0gWyckbG9jYWxlJywgJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRsb2NhbGUsICRpbnRlcnBvbGF0ZSkgewogICAgdmFyIEJSQUNFID0gL3t9L2c7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VBJywKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICB2YXIgbnVtYmVyRXhwID0gYXR0ci5jb3VudCwKICAgICAgICAgIHdoZW5FeHAgPSBhdHRyLiRhdHRyLndoZW4gJiYgZWxlbWVudC5hdHRyKGF0dHIuJGF0dHIud2hlbiksIC8vIHdlIGhhdmUge3t9fSBpbiBhdHRycwogICAgICAgICAgb2Zmc2V0ID0gYXR0ci5vZmZzZXQgfHwgMCwKICAgICAgICAgIHdoZW5zID0gc2NvcGUuJGV2YWwod2hlbkV4cCkgfHwge30sCiAgICAgICAgICB3aGVuc0V4cEZucyA9IHt9LAogICAgICAgICAgc3RhcnRTeW1ib2wgPSAkaW50ZXJwb2xhdGUuc3RhcnRTeW1ib2woKSwKICAgICAgICAgIGVuZFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5lbmRTeW1ib2woKSwKICAgICAgICAgIGlzV2hlbiA9IC9ed2hlbihNaW51cyk/KC4rKSQvOwoKICAgICAgICBmb3JFYWNoKGF0dHIsIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIGlmIChpc1doZW4udGVzdChhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICB3aGVuc1tsb3dlcmNhc2UoYXR0cmlidXRlTmFtZS5yZXBsYWNlKCd3aGVuJywgJycpLnJlcGxhY2UoJ01pbnVzJywgJy0nKSldID0KICAgICAgICAgICAgICBlbGVtZW50LmF0dHIoYXR0ci4kYXR0clthdHRyaWJ1dGVOYW1lXSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgZm9yRWFjaCh3aGVucywgZnVuY3Rpb24oZXhwcmVzc2lvbiwga2V5KSB7CiAgICAgICAgICB3aGVuc0V4cEZuc1trZXldID0KICAgICAgICAgICAgJGludGVycG9sYXRlKGV4cHJlc3Npb24ucmVwbGFjZShCUkFDRSwgc3RhcnRTeW1ib2wgKyBudW1iZXJFeHAgKyAnLScgKwogICAgICAgICAgICAgIG9mZnNldCArIGVuZFN5bWJvbCkpOwogICAgICAgIH0pOwoKICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gbmdQbHVyYWxpemVXYXRjaCgpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHBhcnNlRmxvYXQoc2NvcGUuJGV2YWwobnVtYmVyRXhwKSk7CgogICAgICAgICAgaWYgKCFpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgLy9pZiBleHBsaWNpdCBudW1iZXIgcnVsZSBzdWNoIGFzIDEsIDIsIDMuLi4gaXMgZGVmaW5lZCwganVzdCB1c2UgaXQuIE90aGVyd2lzZSwKICAgICAgICAgICAgLy9jaGVjayBpdCBhZ2FpbnN0IHBsdXJhbGl6YXRpb24gcnVsZXMgaW4gJGxvY2FsZSBzZXJ2aWNlCiAgICAgICAgICAgIGlmICghKHZhbHVlIGluIHdoZW5zKSkgdmFsdWUgPSAkbG9jYWxlLnBsdXJhbENhdCh2YWx1ZSAtIG9mZnNldCk7CiAgICAgICAgICAgIHJldHVybiB3aGVuc0V4cEZuc1t2YWx1ZV0oc2NvcGUsIGVsZW1lbnQsIHRydWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgfQogICAgICAgIH0sIGZ1bmN0aW9uIG5nUGx1cmFsaXplV2F0Y2hBY3Rpb24obmV3VmFsKSB7CiAgICAgICAgICBlbGVtZW50LnRleHQobmV3VmFsKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICB9XTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nUmVwZWF0CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgYG5nUmVwZWF0YCBkaXJlY3RpdmUgaW5zdGFudGlhdGVzIGEgdGVtcGxhdGUgb25jZSBwZXIgaXRlbSBmcm9tIGEgY29sbGVjdGlvbi4gRWFjaCB0ZW1wbGF0ZQogICAqIGluc3RhbmNlIGdldHMgaXRzIG93biBzY29wZSwgd2hlcmUgdGhlIGdpdmVuIGxvb3AgdmFyaWFibGUgaXMgc2V0IHRvIHRoZSBjdXJyZW50IGNvbGxlY3Rpb24gaXRlbSwKICAgKiBhbmQgYCRpbmRleGAgaXMgc2V0IHRvIHRoZSBpdGVtIGluZGV4IG9yIGtleS4KICAgKgogICAqIFNwZWNpYWwgcHJvcGVydGllcyBhcmUgZXhwb3NlZCBvbiB0aGUgbG9jYWwgc2NvcGUgb2YgZWFjaCB0ZW1wbGF0ZSBpbnN0YW5jZSwgaW5jbHVkaW5nOgogICAqCiAgICogfCBWYXJpYWJsZSAgfCBUeXBlICAgICAgICAgICAgfCBEZXRhaWxzICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAqIHwtLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgKiB8IGAkaW5kZXhgICB8IHtAdHlwZSBudW1iZXJ9ICB8IGl0ZXJhdG9yIG9mZnNldCBvZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCAoMC4ubGVuZ3RoLTEpICAgICAgICAgICAgICAgICAgICAgICB8CiAgICogfCBgJGZpcnN0YCAgfCB7QHR5cGUgYm9vbGVhbn0gfCB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGZpcnN0IGluIHRoZSBpdGVyYXRvci4gICAgICAgICAgICAgICAgICAgICAgfAogICAqIHwgYCRtaWRkbGVgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBiZXR3ZWVuIHRoZSBmaXJzdCBhbmQgbGFzdCBpbiB0aGUgaXRlcmF0b3IuIHwKICAgKiB8IGAkbGFzdGAgICB8IHtAdHlwZSBib29sZWFufSB8IHRydWUgaWYgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaXMgbGFzdCBpbiB0aGUgaXRlcmF0b3IuICAgICAgICAgICAgICAgICAgICAgICB8CiAgICogfCBgJGV2ZW5gICAgfCB7QHR5cGUgYm9vbGVhbn0gfCB0cnVlIGlmIHRoZSBpdGVyYXRvciBwb3NpdGlvbiBgJGluZGV4YCBpcyBldmVuIChvdGhlcndpc2UgZmFsc2UpLiAgICAgICAgICAgfAogICAqIHwgYCRvZGRgICAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgaXRlcmF0b3IgcG9zaXRpb24gYCRpbmRleGAgaXMgb2RkIChvdGhlcndpc2UgZmFsc2UpLiAgICAgICAgICAgIHwKICAgKgogICAqIENyZWF0aW5nIGFsaWFzZXMgZm9yIHRoZXNlIHByb3BlcnRpZXMgaXMgcG9zc2libGUgd2l0aCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSW5pdCBgbmdJbml0YH0uCiAgICogVGhpcyBtYXkgYmUgdXNlZnVsIHdoZW4sIGZvciBpbnN0YW5jZSwgbmVzdGluZyBuZ1JlcGVhdHMuCiAgICoKICAgKiAjIFNwZWNpYWwgcmVwZWF0IHN0YXJ0IGFuZCBlbmQgcG9pbnRzCiAgICogVG8gcmVwZWF0IGEgc2VyaWVzIG9mIGVsZW1lbnRzIGluc3RlYWQgb2YganVzdCBvbmUgcGFyZW50IGVsZW1lbnQsIG5nUmVwZWF0IChhcyB3ZWxsIGFzIG90aGVyIG5nIGRpcmVjdGl2ZXMpIHN1cHBvcnRzIGV4dGVuZGluZwogICAqIHRoZSByYW5nZSBvZiB0aGUgcmVwZWF0ZXIgYnkgZGVmaW5pbmcgZXhwbGljaXQgc3RhcnQgYW5kIGVuZCBwb2ludHMgYnkgdXNpbmcgKipuZy1yZXBlYXQtc3RhcnQqKiBhbmQgKipuZy1yZXBlYXQtZW5kKiogcmVzcGVjdGl2ZWx5LgogICAqIFRoZSAqKm5nLXJlcGVhdC1zdGFydCoqIGRpcmVjdGl2ZSB3b3JrcyB0aGUgc2FtZSBhcyAqKm5nLXJlcGVhdCoqLCBidXQgd2lsbCByZXBlYXQgYWxsIHRoZSBIVE1MIGNvZGUgKGluY2x1ZGluZyB0aGUgdGFnIGl0J3MgZGVmaW5lZCBvbikKICAgKiB1cCB0byBhbmQgaW5jbHVkaW5nIHRoZSBlbmRpbmcgSFRNTCB0YWcgd2hlcmUgKipuZy1yZXBlYXQtZW5kKiogaXMgcGxhY2VkLgogICAqCiAgICogVGhlIGV4YW1wbGUgYmVsb3cgbWFrZXMgdXNlIG9mIHRoaXMgZmVhdHVyZToKICAgKiBgYGBodG1sCiAgICogICA8aGVhZGVyIG5nLXJlcGVhdC1zdGFydD0iaXRlbSBpbiBpdGVtcyI+CiAgICogICAgIEhlYWRlciB7eyBpdGVtIH19CiAgICogICA8L2hlYWRlcj4KICAgKiAgIDxkaXYgY2xhc3M9ImJvZHkiPgogICAqICAgICBCb2R5IHt7IGl0ZW0gfX0KICAgKiAgIDwvZGl2PgogICAqICAgPGZvb3RlciBuZy1yZXBlYXQtZW5kPgogICAqICAgICBGb290ZXIge3sgaXRlbSB9fQogICAqICAgPC9mb290ZXI+CiAgICogYGBgCiAgICoKICAgKiBBbmQgd2l0aCBhbiBpbnB1dCBvZiB7QHR5cGUgWydBJywnQiddfSBmb3IgdGhlIGl0ZW1zIHZhcmlhYmxlIGluIHRoZSBleGFtcGxlIGFib3ZlLCB0aGUgb3V0cHV0IHdpbGwgZXZhbHVhdGUgdG86CiAgICogYGBgaHRtbAogICAqICAgPGhlYWRlcj4KICAgKiAgICAgSGVhZGVyIEEKICAgKiAgIDwvaGVhZGVyPgogICAqICAgPGRpdiBjbGFzcz0iYm9keSI+CiAgICogICAgIEJvZHkgQQogICAqICAgPC9kaXY+CiAgICogICA8Zm9vdGVyPgogICAqICAgICBGb290ZXIgQQogICAqICAgPC9mb290ZXI+CiAgICogICA8aGVhZGVyPgogICAqICAgICBIZWFkZXIgQgogICAqICAgPC9oZWFkZXI+CiAgICogICA8ZGl2IGNsYXNzPSJib2R5Ij4KICAgKiAgICAgQm9keSBCCiAgICogICA8L2Rpdj4KICAgKiAgIDxmb290ZXI+CiAgICogICAgIEZvb3RlciBCCiAgICogICA8L2Zvb3Rlcj4KICAgKiBgYGAKICAgKgogICAqIFRoZSBjdXN0b20gc3RhcnQgYW5kIGVuZCBwb2ludHMgZm9yIG5nUmVwZWF0IGFsc28gc3VwcG9ydCBhbGwgb3RoZXIgSFRNTCBkaXJlY3RpdmUgc3ludGF4IGZsYXZvcnMgcHJvdmlkZWQgaW4gQW5ndWxhckpTIChzdWNoCiAgICogYXMgKipkYXRhLW5nLXJlcGVhdC1zdGFydCoqLCAqKngtbmctcmVwZWF0LXN0YXJ0KiogYW5kICoqbmc6cmVwZWF0LXN0YXJ0KiopLgogICAqCiAgICogQGFuaW1hdGlvbnMKICAgKiAqKi5lbnRlcioqIC0gd2hlbiBhIG5ldyBpdGVtIGlzIGFkZGVkIHRvIHRoZSBsaXN0IG9yIHdoZW4gYW4gaXRlbSBpcyByZXZlYWxlZCBhZnRlciBhIGZpbHRlcgogICAqCiAgICogKioubGVhdmUqKiAtIHdoZW4gYW4gaXRlbSBpcyByZW1vdmVkIGZyb20gdGhlIGxpc3Qgb3Igd2hlbiBhbiBpdGVtIGlzIGZpbHRlcmVkIG91dAogICAqCiAgICogKioubW92ZSoqIC0gd2hlbiBhbiBhZGphY2VudCBpdGVtIGlzIGZpbHRlcmVkIG91dCBjYXVzaW5nIGEgcmVvcmRlciBvciB3aGVuIHRoZSBpdGVtIGNvbnRlbnRzIGFyZSByZW9yZGVyZWQKICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBzY29wZQogICAqIEBwcmlvcml0eSAxMDAwCiAgICogQHBhcmFtIHtyZXBlYXRfZXhwcmVzc2lvbn0gbmdSZXBlYXQgVGhlIGV4cHJlc3Npb24gaW5kaWNhdGluZyBob3cgdG8gZW51bWVyYXRlIGEgY29sbGVjdGlvbi4gVGhlc2UKICAgKiAgIGZvcm1hdHMgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQ6CiAgICoKICAgKiAgICogYHZhcmlhYmxlIGluIGV4cHJlc3Npb25gIOKAkyB3aGVyZSB2YXJpYWJsZSBpcyB0aGUgdXNlciBkZWZpbmVkIGxvb3AgdmFyaWFibGUgYW5kIGBleHByZXNzaW9uYAogICAqICAgICBpcyBhIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICAgKgogICAqICAgICBGb3IgZXhhbXBsZTogYGFsYnVtIGluIGFydGlzdC5hbGJ1bXNgLgogICAqCiAgICogICAqIGAoa2V5LCB2YWx1ZSkgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIGBrZXlgIGFuZCBgdmFsdWVgIGNhbiBiZSBhbnkgdXNlciBkZWZpbmVkIGlkZW50aWZpZXJzLAogICAqICAgICBhbmQgYGV4cHJlc3Npb25gIGlzIHRoZSBzY29wZSBleHByZXNzaW9uIGdpdmluZyB0aGUgY29sbGVjdGlvbiB0byBlbnVtZXJhdGUuCiAgICoKICAgKiAgICAgRm9yIGV4YW1wbGU6IGAobmFtZSwgYWdlKSBpbiB7J2FkYW0nOjEwLCAnYW1hbGllJzoxMn1gLgogICAqCiAgICogICAqIGB2YXJpYWJsZSBpbiBleHByZXNzaW9uIHRyYWNrIGJ5IHRyYWNraW5nX2V4cHJlc3Npb25gIOKAkyBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCB0cmFja2luZyBmdW5jdGlvbgogICAqICAgICB3aGljaCBjYW4gYmUgdXNlZCB0byBhc3NvY2lhdGUgdGhlIG9iamVjdHMgaW4gdGhlIGNvbGxlY3Rpb24gd2l0aCB0aGUgRE9NIGVsZW1lbnRzLiBJZiBubyB0cmFja2luZyBmdW5jdGlvbgogICAqICAgICBpcyBzcGVjaWZpZWQgdGhlIG5nLXJlcGVhdCBhc3NvY2lhdGVzIGVsZW1lbnRzIGJ5IGlkZW50aXR5IGluIHRoZSBjb2xsZWN0aW9uLiBJdCBpcyBhbiBlcnJvciB0byBoYXZlCiAgICogICAgIG1vcmUgdGhhbiBvbmUgdHJhY2tpbmcgZnVuY3Rpb24gdG8gcmVzb2x2ZSB0byB0aGUgc2FtZSBrZXkuIChUaGlzIHdvdWxkIG1lYW4gdGhhdCB0d28gZGlzdGluY3Qgb2JqZWN0cyBhcmUKICAgKiAgICAgbWFwcGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LCB3aGljaCBpcyBub3QgcG9zc2libGUuKSAgRmlsdGVycyBzaG91bGQgYmUgYXBwbGllZCB0byB0aGUgZXhwcmVzc2lvbiwKICAgKiAgICAgYmVmb3JlIHNwZWNpZnlpbmcgYSB0cmFja2luZyBleHByZXNzaW9uLgogICAqCiAgICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtc2AgaXMgZXF1aXZhbGVudCB0byBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSAkaWQoaXRlbSlgLiBUaGlzIGltcGxpZXMgdGhhdCB0aGUgRE9NIGVsZW1lbnRzCiAgICogICAgIHdpbGwgYmUgYXNzb2NpYXRlZCBieSBpdGVtIGlkZW50aXR5IGluIHRoZSBhcnJheS4KICAgKgogICAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXMgdHJhY2sgYnkgJGlkKGl0ZW0pYC4gQSBidWlsdCBpbiBgJGlkKClgIGZ1bmN0aW9uIGNhbiBiZSB1c2VkIHRvIGFzc2lnbiBhIHVuaXF1ZQogICAqICAgICBgJCRoYXNoS2V5YCBwcm9wZXJ0eSB0byBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5LiBUaGlzIHByb3BlcnR5IGlzIHRoZW4gdXNlZCBhcyBhIGtleSB0byBhc3NvY2lhdGVkIERPTSBlbGVtZW50cwogICAqICAgICB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIGl0ZW0gaW4gdGhlIGFycmF5IGJ5IGlkZW50aXR5LiBNb3ZpbmcgdGhlIHNhbWUgb2JqZWN0IGluIGFycmF5IHdvdWxkIG1vdmUgdGhlIERPTQogICAqICAgICBlbGVtZW50IGluIHRoZSBzYW1lIHdheSBpbiB0aGUgRE9NLgogICAqCiAgICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSBpdGVtLmlkYCBpcyBhIHR5cGljYWwgcGF0dGVybiB3aGVuIHRoZSBpdGVtcyBjb21lIGZyb20gdGhlIGRhdGFiYXNlLiBJbiB0aGlzCiAgICogICAgIGNhc2UgdGhlIG9iamVjdCBpZGVudGl0eSBkb2VzIG5vdCBtYXR0ZXIuIFR3byBvYmplY3RzIGFyZSBjb25zaWRlcmVkIGVxdWl2YWxlbnQgYXMgbG9uZyBhcyB0aGVpciBgaWRgCiAgICogICAgIHByb3BlcnR5IGlzIHNhbWUuCiAgICoKICAgKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHwgZmlsdGVyOnNlYXJjaFRleHQgdHJhY2sgYnkgaXRlbS5pZGAgaXMgYSBwYXR0ZXJuIHRoYXQgbWlnaHQgYmUgdXNlZCB0byBhcHBseSBhIGZpbHRlcgogICAqICAgICB0byBpdGVtcyBpbiBjb25qdW5jdGlvbiB3aXRoIGEgdHJhY2tpbmcgZXhwcmVzc2lvbi4KICAgKgogICAqIEBleGFtcGxlCiAgICogVGhpcyBleGFtcGxlIGluaXRpYWxpemVzIHRoZSBzY29wZSB0byBhIGxpc3Qgb2YgbmFtZXMgYW5kCiAgICogdGhlbiB1c2VzIGBuZ1JlcGVhdGAgdG8gZGlzcGxheSBldmVyeSBwZXJzb246CiAgIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGRpdiBuZy1pbml0PSJmcmllbmRzID0gWwogICB7bmFtZTonSm9obicsIGFnZToyNSwgZ2VuZGVyOidib3knfSwKICAge25hbWU6J0plc3NpZScsIGFnZTozMCwgZ2VuZGVyOidnaXJsJ30sCiAgIHtuYW1lOidKb2hhbm5hJywgYWdlOjI4LCBnZW5kZXI6J2dpcmwnfSwKICAge25hbWU6J0pveScsIGFnZToxNSwgZ2VuZGVyOidnaXJsJ30sCiAgIHtuYW1lOidNYXJ5JywgYWdlOjI4LCBnZW5kZXI6J2dpcmwnfSwKICAge25hbWU6J1BldGVyJywgYWdlOjk1LCBnZW5kZXI6J2JveSd9LAogICB7bmFtZTonU2ViYXN0aWFuJywgYWdlOjUwLCBnZW5kZXI6J2JveSd9LAogICB7bmFtZTonRXJpa2EnLCBhZ2U6MjcsIGdlbmRlcjonZ2lybCd9LAogICB7bmFtZTonUGF0cmljaycsIGFnZTo0MCwgZ2VuZGVyOidib3knfSwKICAge25hbWU6J1NhbWFudGhhJywgYWdlOjYwLCBnZW5kZXI6J2dpcmwnfQogICBdIj4KICAgSSBoYXZlIHt7ZnJpZW5kcy5sZW5ndGh9fSBmcmllbmRzLiBUaGV5IGFyZToKICAgPGlucHV0IHR5cGU9InNlYXJjaCIgbmctbW9kZWw9InEiIHBsYWNlaG9sZGVyPSJmaWx0ZXIgZnJpZW5kcy4uLiIgLz4KICAgPHVsIGNsYXNzPSJleGFtcGxlLWFuaW1hdGUtY29udGFpbmVyIj4KICAgPGxpIGNsYXNzPSJhbmltYXRlLXJlcGVhdCIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpxIj4KICAgW3t7JGluZGV4ICsgMX19XSB7e2ZyaWVuZC5uYW1lfX0gd2hvIGlzIHt7ZnJpZW5kLmFnZX19IHllYXJzIG9sZC4KICAgPC9saT4KICAgPC91bD4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAuZXhhbXBsZS1hbmltYXRlLWNvbnRhaW5lciB7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGxpc3Qtc3R5bGU6bm9uZTsKICAgICAgICBtYXJnaW46MDsKICAgICAgICBwYWRkaW5nOjAgMTBweDsKICAgICAgfQoKICAgLmFuaW1hdGUtcmVwZWF0IHsKICAgICAgICBsaW5lLWhlaWdodDo0MHB4OwogICAgICAgIGxpc3Qtc3R5bGU6bm9uZTsKICAgICAgICBib3gtc2l6aW5nOmJvcmRlci1ib3g7CiAgICAgIH0KCiAgIC5hbmltYXRlLXJlcGVhdC5uZy1tb3ZlLAogICAuYW5pbWF0ZS1yZXBlYXQubmctZW50ZXIsCiAgIC5hbmltYXRlLXJlcGVhdC5uZy1sZWF2ZSB7CiAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICB0cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgfQoKICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlLm5nLWxlYXZlLWFjdGl2ZSwKICAgLmFuaW1hdGUtcmVwZWF0Lm5nLW1vdmUsCiAgIC5hbmltYXRlLXJlcGVhdC5uZy1lbnRlciB7CiAgICAgICAgb3BhY2l0eTowOwogICAgICAgIG1heC1oZWlnaHQ6MDsKICAgICAgfQoKICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlLAogICAuYW5pbWF0ZS1yZXBlYXQubmctbW92ZS5uZy1tb3ZlLWFjdGl2ZSwKICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWVudGVyLm5nLWVudGVyLWFjdGl2ZSB7CiAgICAgICAgb3BhY2l0eToxOwogICAgICAgIG1heC1oZWlnaHQ6NDBweDsKICAgICAgfQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICB2YXIgZnJpZW5kcyA9IGVsZW1lbnQuYWxsKGJ5LnJlcGVhdGVyKCdmcmllbmQgaW4gZnJpZW5kcycpKTsKCiAgIGl0KCdzaG91bGQgcmVuZGVyIGluaXRpYWwgZGF0YSBzZXQnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3QoZnJpZW5kcy5jb3VudCgpKS50b0JlKDEwKTsKICAgICAgICBleHBlY3QoZnJpZW5kcy5nZXQoMCkuZ2V0VGV4dCgpKS50b0VxdWFsKCdbMV0gSm9obiB3aG8gaXMgMjUgeWVhcnMgb2xkLicpOwogICAgICAgIGV4cGVjdChmcmllbmRzLmdldCgxKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1syXSBKZXNzaWUgd2hvIGlzIDMwIHllYXJzIG9sZC4nKTsKICAgICAgICBleHBlY3QoZnJpZW5kcy5sYXN0KCkuZ2V0VGV4dCgpKS50b0VxdWFsKCdbMTBdIFNhbWFudGhhIHdobyBpcyA2MCB5ZWFycyBvbGQuJyk7CiAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnZnJpZW5kcy5sZW5ndGgnKSkuZ2V0VGV4dCgpKQogICAgICAgICAgICAudG9NYXRjaCgiSSBoYXZlIDEwIGZyaWVuZHMuIFRoZXkgYXJlOiIpOwogICAgICB9KTsKCiAgIGl0KCdzaG91bGQgdXBkYXRlIHJlcGVhdGVyIHdoZW4gZmlsdGVyIHByZWRpY2F0ZSBjaGFuZ2VzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChmcmllbmRzLmNvdW50KCkpLnRvQmUoMTApOwoKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgncScpKS5zZW5kS2V5cygnbWEnKTsKCiAgICAgICAgIGV4cGVjdChmcmllbmRzLmNvdW50KCkpLnRvQmUoMik7CiAgICAgICAgIGV4cGVjdChmcmllbmRzLmdldCgwKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1sxXSBNYXJ5IHdobyBpcyAyOCB5ZWFycyBvbGQuJyk7CiAgICAgICAgIGV4cGVjdChmcmllbmRzLmxhc3QoKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1syXSBTYW1hbnRoYSB3aG8gaXMgNjAgeWVhcnMgb2xkLicpOwogICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIHZhciBuZ1JlcGVhdERpcmVjdGl2ZSA9IFsnJHBhcnNlJywgJyRhbmltYXRlJywgZnVuY3Rpb24oJHBhcnNlLCAkYW5pbWF0ZSkgewogICAgdmFyIE5HX1JFTU9WRUQgPSAnJCROR19SRU1PVkVEJzsKICAgIHZhciBuZ1JlcGVhdE1pbkVyciA9IG1pbkVycignbmdSZXBlYXQnKTsKICAgIHJldHVybiB7CiAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgcHJpb3JpdHk6IDEwMDAsCiAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICAkJHRsYjogdHJ1ZSwKICAgICAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmwsICR0cmFuc2NsdWRlKXsKICAgICAgICB2YXIgZXhwcmVzc2lvbiA9ICRhdHRyLm5nUmVwZWF0OwogICAgICAgIHZhciBtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goL15ccyooW1xzXFNdKz8pXHMraW5ccysoW1xzXFNdKz8pKD86XHMrdHJhY2tccytieVxzKyhbXHNcU10rPykpP1xzKiQvKSwKICAgICAgICAgIHRyYWNrQnlFeHAsIHRyYWNrQnlFeHBHZXR0ZXIsIHRyYWNrQnlJZEV4cEZuLCB0cmFja0J5SWRBcnJheUZuLCB0cmFja0J5SWRPYmpGbiwKICAgICAgICAgIGxocywgcmhzLCB2YWx1ZUlkZW50aWZpZXIsIGtleUlkZW50aWZpZXIsCiAgICAgICAgICBoYXNoRm5Mb2NhbHMgPSB7JGlkOiBoYXNoS2V5fTsKCiAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgdGhyb3cgbmdSZXBlYXRNaW5FcnIoJ2lleHAnLCAiRXhwZWN0ZWQgZXhwcmVzc2lvbiBpbiBmb3JtIG9mICdfaXRlbV8gaW4gX2NvbGxlY3Rpb25fWyB0cmFjayBieSBfaWRfXScgYnV0IGdvdCAnezB9Jy4iLAogICAgICAgICAgICBleHByZXNzaW9uKTsKICAgICAgICB9CgogICAgICAgIGxocyA9IG1hdGNoWzFdOwogICAgICAgIHJocyA9IG1hdGNoWzJdOwogICAgICAgIHRyYWNrQnlFeHAgPSBtYXRjaFszXTsKCiAgICAgICAgaWYgKHRyYWNrQnlFeHApIHsKICAgICAgICAgIHRyYWNrQnlFeHBHZXR0ZXIgPSAkcGFyc2UodHJhY2tCeUV4cCk7CiAgICAgICAgICB0cmFja0J5SWRFeHBGbiA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIGluZGV4KSB7CiAgICAgICAgICAgIC8vIGFzc2lnbiBrZXksIHZhbHVlLCBhbmQgJGluZGV4IHRvIHRoZSBsb2NhbHMgc28gdGhhdCB0aGV5IGNhbiBiZSB1c2VkIGluIGhhc2ggZnVuY3Rpb25zCiAgICAgICAgICAgIGlmIChrZXlJZGVudGlmaWVyKSBoYXNoRm5Mb2NhbHNba2V5SWRlbnRpZmllcl0gPSBrZXk7CiAgICAgICAgICAgIGhhc2hGbkxvY2Fsc1t2YWx1ZUlkZW50aWZpZXJdID0gdmFsdWU7CiAgICAgICAgICAgIGhhc2hGbkxvY2Fscy4kaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgcmV0dXJuIHRyYWNrQnlFeHBHZXR0ZXIoJHNjb3BlLCBoYXNoRm5Mb2NhbHMpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdHJhY2tCeUlkQXJyYXlGbiA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGhhc2hLZXkodmFsdWUpOwogICAgICAgICAgfTsKICAgICAgICAgIHRyYWNrQnlJZE9iakZuID0gZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBrZXk7CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgbWF0Y2ggPSBsaHMubWF0Y2goL14oPzooW1wkXHddKyl8XCgoW1wkXHddKylccyosXHMqKFtcJFx3XSspXCkpJC8pOwogICAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgIHRocm93IG5nUmVwZWF0TWluRXJyKCdpaWRleHAnLCAiJ19pdGVtXycgaW4gJ19pdGVtXyBpbiBfY29sbGVjdGlvbl8nIHNob3VsZCBiZSBhbiBpZGVudGlmaWVyIG9yICcoX2tleV8sIF92YWx1ZV8pJyBleHByZXNzaW9uLCBidXQgZ290ICd7MH0nLiIsCiAgICAgICAgICAgIGxocyk7CiAgICAgICAgfQogICAgICAgIHZhbHVlSWRlbnRpZmllciA9IG1hdGNoWzNdIHx8IG1hdGNoWzFdOwogICAgICAgIGtleUlkZW50aWZpZXIgPSBtYXRjaFsyXTsKCiAgICAgICAgLy8gU3RvcmUgYSBsaXN0IG9mIGVsZW1lbnRzIGZyb20gcHJldmlvdXMgcnVuLiBUaGlzIGlzIGEgaGFzaCB3aGVyZSBrZXkgaXMgdGhlIGl0ZW0gZnJvbSB0aGUKICAgICAgICAvLyBpdGVyYXRvciwgYW5kIHRoZSB2YWx1ZSBpcyBvYmplY3RzIHdpdGggZm9sbG93aW5nIHByb3BlcnRpZXMuCiAgICAgICAgLy8gICAtIHNjb3BlOiBib3VuZCBzY29wZQogICAgICAgIC8vICAgLSBlbGVtZW50OiBwcmV2aW91cyBlbGVtZW50LgogICAgICAgIC8vICAgLSBpbmRleDogcG9zaXRpb24KICAgICAgICB2YXIgbGFzdEJsb2NrTWFwID0ge307CgogICAgICAgIC8vd2F0Y2ggcHJvcHMKICAgICAgICAkc2NvcGUuJHdhdGNoQ29sbGVjdGlvbihyaHMsIGZ1bmN0aW9uIG5nUmVwZWF0QWN0aW9uKGNvbGxlY3Rpb24pewogICAgICAgICAgdmFyIGluZGV4LCBsZW5ndGgsCiAgICAgICAgICAgIHByZXZpb3VzTm9kZSA9ICRlbGVtZW50WzBdLCAgICAgLy8gY3VycmVudCBwb3NpdGlvbiBvZiB0aGUgbm9kZQogICAgICAgICAgICBuZXh0Tm9kZSwKICAgICAgICAgIC8vIFNhbWUgYXMgbGFzdEJsb2NrTWFwIGJ1dCBpdCBoYXMgdGhlIGN1cnJlbnQgc3RhdGUuIEl0IHdpbGwgYmVjb21lIHRoZQogICAgICAgICAgLy8gbGFzdEJsb2NrTWFwIG9uIHRoZSBuZXh0IGl0ZXJhdGlvbi4KICAgICAgICAgICAgbmV4dEJsb2NrTWFwID0ge30sCiAgICAgICAgICAgIGFycmF5TGVuZ3RoLAogICAgICAgICAgICBjaGlsZFNjb3BlLAogICAgICAgICAgICBrZXksIHZhbHVlLCAvLyBrZXkvdmFsdWUgb2YgaXRlcmF0aW9uCiAgICAgICAgICAgIHRyYWNrQnlJZCwKICAgICAgICAgICAgdHJhY2tCeUlkRm4sCiAgICAgICAgICAgIGNvbGxlY3Rpb25LZXlzLAogICAgICAgICAgICBibG9jaywgICAgICAgLy8gbGFzdCBvYmplY3QgaW5mb3JtYXRpb24ge3Njb3BlLCBlbGVtZW50LCBpZH0KICAgICAgICAgICAgbmV4dEJsb2NrT3JkZXIgPSBbXSwKICAgICAgICAgICAgZWxlbWVudHNUb1JlbW92ZTsKCgogICAgICAgICAgaWYgKGlzQXJyYXlMaWtlKGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgIGNvbGxlY3Rpb25LZXlzID0gY29sbGVjdGlvbjsKICAgICAgICAgICAgdHJhY2tCeUlkRm4gPSB0cmFja0J5SWRFeHBGbiB8fCB0cmFja0J5SWRBcnJheUZuOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdHJhY2tCeUlkRm4gPSB0cmFja0J5SWRFeHBGbiB8fCB0cmFja0J5SWRPYmpGbjsKICAgICAgICAgICAgLy8gaWYgb2JqZWN0LCBleHRyYWN0IGtleXMsIHNvcnQgdGhlbSBhbmQgdXNlIHRvIGRldGVybWluZSBvcmRlciBvZiBpdGVyYXRpb24gb3ZlciBvYmogcHJvcHMKICAgICAgICAgICAgY29sbGVjdGlvbktleXMgPSBbXTsKICAgICAgICAgICAgZm9yIChrZXkgaW4gY29sbGVjdGlvbikgewogICAgICAgICAgICAgIGlmIChjb2xsZWN0aW9uLmhhc093blByb3BlcnR5KGtleSkgJiYga2V5LmNoYXJBdCgwKSAhPSAnJCcpIHsKICAgICAgICAgICAgICAgIGNvbGxlY3Rpb25LZXlzLnB1c2goa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29sbGVjdGlvbktleXMuc29ydCgpOwogICAgICAgICAgfQoKICAgICAgICAgIGFycmF5TGVuZ3RoID0gY29sbGVjdGlvbktleXMubGVuZ3RoOwoKICAgICAgICAgIC8vIGxvY2F0ZSBleGlzdGluZyBpdGVtcwogICAgICAgICAgbGVuZ3RoID0gbmV4dEJsb2NrT3JkZXIubGVuZ3RoID0gY29sbGVjdGlvbktleXMubGVuZ3RoOwogICAgICAgICAgZm9yKGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAga2V5ID0gKGNvbGxlY3Rpb24gPT09IGNvbGxlY3Rpb25LZXlzKSA/IGluZGV4IDogY29sbGVjdGlvbktleXNbaW5kZXhdOwogICAgICAgICAgICB2YWx1ZSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICAgdHJhY2tCeUlkID0gdHJhY2tCeUlkRm4oa2V5LCB2YWx1ZSwgaW5kZXgpOwogICAgICAgICAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eSh0cmFja0J5SWQsICdgdHJhY2sgYnlgIGlkJyk7CiAgICAgICAgICAgIGlmKGxhc3RCbG9ja01hcC5oYXNPd25Qcm9wZXJ0eSh0cmFja0J5SWQpKSB7CiAgICAgICAgICAgICAgYmxvY2sgPSBsYXN0QmxvY2tNYXBbdHJhY2tCeUlkXTsKICAgICAgICAgICAgICBkZWxldGUgbGFzdEJsb2NrTWFwW3RyYWNrQnlJZF07CiAgICAgICAgICAgICAgbmV4dEJsb2NrTWFwW3RyYWNrQnlJZF0gPSBibG9jazsKICAgICAgICAgICAgICBuZXh0QmxvY2tPcmRlcltpbmRleF0gPSBibG9jazsKICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0QmxvY2tNYXAuaGFzT3duUHJvcGVydHkodHJhY2tCeUlkKSkgewogICAgICAgICAgICAgIC8vIHJlc3RvcmUgbGFzdEJsb2NrTWFwCiAgICAgICAgICAgICAgZm9yRWFjaChuZXh0QmxvY2tPcmRlciwgZnVuY3Rpb24oYmxvY2spIHsKICAgICAgICAgICAgICAgIGlmIChibG9jayAmJiBibG9jay5zY29wZSkgbGFzdEJsb2NrTWFwW2Jsb2NrLmlkXSA9IGJsb2NrOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBkdXBsaWNhdGUgYW5kIHdlIG5lZWQgdG8gdGhyb3cgYW4gZXJyb3IKICAgICAgICAgICAgICB0aHJvdyBuZ1JlcGVhdE1pbkVycignZHVwZXMnLCAiRHVwbGljYXRlcyBpbiBhIHJlcGVhdGVyIGFyZSBub3QgYWxsb3dlZC4gVXNlICd0cmFjayBieScgZXhwcmVzc2lvbiB0byBzcGVjaWZ5IHVuaXF1ZSBrZXlzLiBSZXBlYXRlcjogezB9LCBEdXBsaWNhdGUga2V5OiB7MX0iLAogICAgICAgICAgICAgICAgZXhwcmVzc2lvbiwgICAgICAgdHJhY2tCeUlkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBuZXcgbmV2ZXIgYmVmb3JlIHNlZW4gYmxvY2sKICAgICAgICAgICAgICBuZXh0QmxvY2tPcmRlcltpbmRleF0gPSB7IGlkOiB0cmFja0J5SWQgfTsKICAgICAgICAgICAgICBuZXh0QmxvY2tNYXBbdHJhY2tCeUlkXSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gcmVtb3ZlIGV4aXN0aW5nIGl0ZW1zCiAgICAgICAgICBmb3IgKGtleSBpbiBsYXN0QmxvY2tNYXApIHsKICAgICAgICAgICAgLy8gbGFzdEJsb2NrTWFwIGlzIG91ciBvd24gb2JqZWN0IHNvIHdlIGRvbid0IG5lZWQgdG8gdXNlIHNwZWNpYWwgaGFzT3duUHJvcGVydHlGbgogICAgICAgICAgICBpZiAobGFzdEJsb2NrTWFwLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICBibG9jayA9IGxhc3RCbG9ja01hcFtrZXldOwogICAgICAgICAgICAgIGVsZW1lbnRzVG9SZW1vdmUgPSBnZXRCbG9ja0VsZW1lbnRzKGJsb2NrLmNsb25lKTsKICAgICAgICAgICAgICAkYW5pbWF0ZS5sZWF2ZShlbGVtZW50c1RvUmVtb3ZlKTsKICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnRzVG9SZW1vdmUsIGZ1bmN0aW9uKGVsZW1lbnQpIHsgZWxlbWVudFtOR19SRU1PVkVEXSA9IHRydWU7IH0pOwogICAgICAgICAgICAgIGJsb2NrLnNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyB3ZSBhcmUgbm90IHVzaW5nIGZvckVhY2ggZm9yIHBlcmYgcmVhc29ucyAodHJ5aW5nIHRvIGF2b2lkICNjYWxsKQogICAgICAgICAgZm9yIChpbmRleCA9IDAsIGxlbmd0aCA9IGNvbGxlY3Rpb25LZXlzLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAga2V5ID0gKGNvbGxlY3Rpb24gPT09IGNvbGxlY3Rpb25LZXlzKSA/IGluZGV4IDogY29sbGVjdGlvbktleXNbaW5kZXhdOwogICAgICAgICAgICB2YWx1ZSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICAgYmxvY2sgPSBuZXh0QmxvY2tPcmRlcltpbmRleF07CiAgICAgICAgICAgIGlmIChuZXh0QmxvY2tPcmRlcltpbmRleCAtIDFdKSBwcmV2aW91c05vZGUgPSBnZXRCbG9ja0VuZChuZXh0QmxvY2tPcmRlcltpbmRleCAtIDFdKTsKCiAgICAgICAgICAgIGlmIChibG9jay5zY29wZSkgewogICAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgYWxyZWFkeSBzZWVuIHRoaXMgb2JqZWN0LCB0aGVuIHdlIG5lZWQgdG8gcmV1c2UgdGhlCiAgICAgICAgICAgICAgLy8gYXNzb2NpYXRlZCBzY29wZS9lbGVtZW50CiAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IGJsb2NrLnNjb3BlOwoKICAgICAgICAgICAgICBuZXh0Tm9kZSA9IHByZXZpb3VzTm9kZTsKICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICBuZXh0Tm9kZSA9IG5leHROb2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgIH0gd2hpbGUobmV4dE5vZGUgJiYgbmV4dE5vZGVbTkdfUkVNT1ZFRF0pOwoKICAgICAgICAgICAgICBpZiAoZ2V0QmxvY2tTdGFydChibG9jaykgIT0gbmV4dE5vZGUpIHsKICAgICAgICAgICAgICAgIC8vIGV4aXN0aW5nIGl0ZW0gd2hpY2ggZ290IG1vdmVkCiAgICAgICAgICAgICAgICAkYW5pbWF0ZS5tb3ZlKGdldEJsb2NrRWxlbWVudHMoYmxvY2suY2xvbmUpLCBudWxsLCBqcUxpdGUocHJldmlvdXNOb2RlKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzTm9kZSA9IGdldEJsb2NrRW5kKGJsb2NrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBuZXcgaXRlbSB3aGljaCB3ZSBkb24ndCBrbm93IGFib3V0CiAgICAgICAgICAgICAgY2hpbGRTY29wZSA9ICRzY29wZS4kbmV3KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNoaWxkU2NvcGVbdmFsdWVJZGVudGlmaWVyXSA9IHZhbHVlOwogICAgICAgICAgICBpZiAoa2V5SWRlbnRpZmllcikgY2hpbGRTY29wZVtrZXlJZGVudGlmaWVyXSA9IGtleTsKICAgICAgICAgICAgY2hpbGRTY29wZS4kaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgY2hpbGRTY29wZS4kZmlyc3QgPSAoaW5kZXggPT09IDApOwogICAgICAgICAgICBjaGlsZFNjb3BlLiRsYXN0ID0gKGluZGV4ID09PSAoYXJyYXlMZW5ndGggLSAxKSk7CiAgICAgICAgICAgIGNoaWxkU2NvcGUuJG1pZGRsZSA9ICEoY2hpbGRTY29wZS4kZmlyc3QgfHwgY2hpbGRTY29wZS4kbGFzdCk7CiAgICAgICAgICAgIC8vIGpzaGludCBiaXR3aXNlOiBmYWxzZQogICAgICAgICAgICBjaGlsZFNjb3BlLiRvZGQgPSAhKGNoaWxkU2NvcGUuJGV2ZW4gPSAoaW5kZXgmMSkgPT09IDApOwogICAgICAgICAgICAvLyBqc2hpbnQgYml0d2lzZTogdHJ1ZQoKICAgICAgICAgICAgaWYgKCFibG9jay5zY29wZSkgewogICAgICAgICAgICAgICR0cmFuc2NsdWRlKGNoaWxkU2NvcGUsIGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgICAgICAgICBjbG9uZVtjbG9uZS5sZW5ndGgrK10gPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCcgZW5kIG5nUmVwZWF0OiAnICsgZXhwcmVzc2lvbiArICcgJyk7CiAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjbG9uZSwgbnVsbCwganFMaXRlKHByZXZpb3VzTm9kZSkpOwogICAgICAgICAgICAgICAgcHJldmlvdXNOb2RlID0gY2xvbmU7CiAgICAgICAgICAgICAgICBibG9jay5zY29wZSA9IGNoaWxkU2NvcGU7CiAgICAgICAgICAgICAgICAvLyBOb3RlOiBXZSBvbmx5IG5lZWQgdGhlIGZpcnN0L2xhc3Qgbm9kZSBvZiB0aGUgY2xvbmVkIG5vZGVzLgogICAgICAgICAgICAgICAgLy8gSG93ZXZlciwgd2UgbmVlZCB0byBrZWVwIHRoZSByZWZlcmVuY2UgdG8gdGhlIGpxbGl0ZSB3cmFwcGVyIGFzIGl0IG1pZ2h0IGJlIGNoYW5nZWQgbGF0ZXIKICAgICAgICAgICAgICAgIC8vIGJ5IGEgZGlyZWN0aXZlIHdpdGggdGVtcGxhdGVVcmwgd2hlbiBpdHMgdGVtcGxhdGUgYXJyaXZlcy4KICAgICAgICAgICAgICAgIGJsb2NrLmNsb25lID0gY2xvbmU7CiAgICAgICAgICAgICAgICBuZXh0QmxvY2tNYXBbYmxvY2suaWRdID0gYmxvY2s7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGxhc3RCbG9ja01hcCA9IG5leHRCbG9ja01hcDsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKCiAgICBmdW5jdGlvbiBnZXRCbG9ja1N0YXJ0KGJsb2NrKSB7CiAgICAgIHJldHVybiBibG9jay5jbG9uZVswXTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRCbG9ja0VuZChibG9jaykgewogICAgICByZXR1cm4gYmxvY2suY2xvbmVbYmxvY2suY2xvbmUubGVuZ3RoIC0gMV07CiAgICB9CiAgfV07CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ1Nob3cKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdTaG93YCBkaXJlY3RpdmUgc2hvd3Mgb3IgaGlkZXMgdGhlIGdpdmVuIEhUTUwgZWxlbWVudCBiYXNlZCBvbiB0aGUgZXhwcmVzc2lvbgogICAqIHByb3ZpZGVkIHRvIHRoZSBuZ1Nob3cgYXR0cmlidXRlLiBUaGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gYnkgcmVtb3Zpbmcgb3IgYWRkaW5nCiAgICogdGhlIGBuZy1oaWRlYCBDU1MgY2xhc3Mgb250byB0aGUgZWxlbWVudC4gVGhlIGAubmctaGlkZWAgQ1NTIGNsYXNzIGlzIHByZWRlZmluZWQKICAgKiBpbiBBbmd1bGFySlMgYW5kIHNldHMgdGhlIGRpc3BsYXkgc3R5bGUgdG8gbm9uZSAodXNpbmcgYW4gIWltcG9ydGFudCBmbGFnKS4KICAgKiBGb3IgQ1NQIG1vZGUgcGxlYXNlIGFkZCBgYW5ndWxhci1jc3AuY3NzYCB0byB5b3VyIGh0bWwgZmlsZSAoc2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDc3AgbmdDc3B9KS4KICAgKgogICAqIGBgYGh0bWwKICAgKiA8IS0tIHdoZW4gJHNjb3BlLm15VmFsdWUgaXMgdHJ1dGh5IChlbGVtZW50IGlzIHZpc2libGUpIC0tPgogICAqIDxkaXYgbmctc2hvdz0ibXlWYWx1ZSI+PC9kaXY+CiAgICoKICAgKiA8IS0tIHdoZW4gJHNjb3BlLm15VmFsdWUgaXMgZmFsc3kgKGVsZW1lbnQgaXMgaGlkZGVuKSAtLT4KICAgKiA8ZGl2IG5nLXNob3c9Im15VmFsdWUiIGNsYXNzPSJuZy1oaWRlIj48L2Rpdj4KICAgKiBgYGAKICAgKgogICAqIFdoZW4gdGhlIG5nU2hvdyBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBmYWxzZSB0aGVuIHRoZSBuZy1oaWRlIENTUyBjbGFzcyBpcyBhZGRlZCB0byB0aGUgY2xhc3MgYXR0cmlidXRlCiAgICogb24gdGhlIGVsZW1lbnQgY2F1c2luZyBpdCB0byBiZWNvbWUgaGlkZGVuLiBXaGVuIHRydWUsIHRoZSBuZy1oaWRlIENTUyBjbGFzcyBpcyByZW1vdmVkCiAgICogZnJvbSB0aGUgZWxlbWVudCBjYXVzaW5nIHRoZSBlbGVtZW50IG5vdCB0byBhcHBlYXIgaGlkZGVuLgogICAqCiAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAgICogKipOb3RlOioqIEhlcmUgaXMgYSBsaXN0IG9mIHZhbHVlcyB0aGF0IG5nU2hvdyB3aWxsIGNvbnNpZGVyIGFzIGEgZmFsc3kgdmFsdWUgKGNhc2UgaW5zZW5zaXRpdmUpOjxiciAvPgogICAqICJmIiAvICIwIiAvICJmYWxzZSIgLyAibm8iIC8gIm4iIC8gIltdIgogICAqIDwvZGl2PgogICAqCiAgICogIyMgV2h5IGlzICFpbXBvcnRhbnQgdXNlZD8KICAgKgogICAqIFlvdSBtYXkgYmUgd29uZGVyaW5nIHdoeSAhaW1wb3J0YW50IGlzIHVzZWQgZm9yIHRoZSAubmctaGlkZSBDU1MgY2xhc3MuIFRoaXMgaXMgYmVjYXVzZSB0aGUgYC5uZy1oaWRlYCBzZWxlY3RvcgogICAqIGNhbiBiZSBlYXNpbHkgb3ZlcnJpZGRlbiBieSBoZWF2aWVyIHNlbGVjdG9ycy4gRm9yIGV4YW1wbGUsIHNvbWV0aGluZyBhcyBzaW1wbGUKICAgKiBhcyBjaGFuZ2luZyB0aGUgZGlzcGxheSBzdHlsZSBvbiBhIEhUTUwgbGlzdCBpdGVtIHdvdWxkIG1ha2UgaGlkZGVuIGVsZW1lbnRzIGFwcGVhciB2aXNpYmxlLgogICAqIFRoaXMgYWxzbyBiZWNvbWVzIGEgYmlnZ2VyIGlzc3VlIHdoZW4gZGVhbGluZyB3aXRoIENTUyBmcmFtZXdvcmtzLgogICAqCiAgICogQnkgdXNpbmcgIWltcG9ydGFudCwgdGhlIHNob3cgYW5kIGhpZGUgYmVoYXZpb3Igd2lsbCB3b3JrIGFzIGV4cGVjdGVkIGRlc3BpdGUgYW55IGNsYXNoIGJldHdlZW4gQ1NTIHNlbGVjdG9yCiAgICogc3BlY2lmaWNpdHkgKHdoZW4gIWltcG9ydGFudCBpc24ndCB1c2VkIHdpdGggYW55IGNvbmZsaWN0aW5nIHN0eWxlcykuIElmIGEgZGV2ZWxvcGVyIGNob29zZXMgdG8gb3ZlcnJpZGUgdGhlCiAgICogc3R5bGluZyB0byBjaGFuZ2UgaG93IHRvIGhpZGUgYW4gZWxlbWVudCB0aGVuIGl0IGlzIGp1c3QgYSBtYXR0ZXIgb2YgdXNpbmcgIWltcG9ydGFudCBpbiB0aGVpciBvd24gQ1NTIGNvZGUuCiAgICoKICAgKiAjIyMgT3ZlcnJpZGluZyAubmctaGlkZQogICAqCiAgICogQnkgZGVmYXVsdCwgdGhlIGAubmctaGlkZWAgY2xhc3Mgd2lsbCBzdHlsZSB0aGUgZWxlbWVudCB3aXRoIGBkaXNwbGF5Om5vbmUhaW1wb3J0YW50YC4gSWYgeW91IHdpc2ggdG8gY2hhbmdlCiAgICogdGhlIGhpZGUgYmVoYXZpb3Igd2l0aCBuZ1Nob3cvbmdIaWRlIHRoZW4gdGhpcyBjYW4gYmUgYWNoaWV2ZWQgYnkgcmVzdGF0aW5nIHRoZSBzdHlsZXMgZm9yIHRoZSBgLm5nLWhpZGVgCiAgICogY2xhc3MgaW4gQ1NTOgogICAqCiAgICogYGBgY3NzCiAgICogLm5nLWhpZGUgewogKiAgIC8vdGhpcyBpcyBqdXN0IGFub3RoZXIgZm9ybSBvZiBoaWRpbmcgYW4gZWxlbWVudAogKiAgIGRpc3BsYXk6YmxvY2shaW1wb3J0YW50OwogKiAgIHBvc2l0aW9uOmFic29sdXRlOwogKiAgIHRvcDotOTk5OXB4OwogKiAgIGxlZnQ6LTk5OTlweDsKICogfQogICAqIGBgYAogICAqCiAgICogQnkgZGVmYXVsdCB5b3UgZG9uJ3QgbmVlZCB0byBvdmVycmlkZSBpbiBDU1MgYW55dGhpbmcgYW5kIHRoZSBhbmltYXRpb25zIHdpbGwgd29yayBhcm91bmQgdGhlIGRpc3BsYXkgc3R5bGUuCiAgICoKICAgKiAjIyBBIG5vdGUgYWJvdXQgYW5pbWF0aW9ucyB3aXRoIG5nU2hvdwogICAqCiAgICogQW5pbWF0aW9ucyBpbiBuZ1Nob3cvbmdIaWRlIHdvcmsgd2l0aCB0aGUgc2hvdyBhbmQgaGlkZSBldmVudHMgdGhhdCBhcmUgdHJpZ2dlcmVkIHdoZW4gdGhlIGRpcmVjdGl2ZSBleHByZXNzaW9uCiAgICogaXMgdHJ1ZSBhbmQgZmFsc2UuIFRoaXMgc3lzdGVtIHdvcmtzIGxpa2UgdGhlIGFuaW1hdGlvbiBzeXN0ZW0gcHJlc2VudCB3aXRoIG5nQ2xhc3MgZXhjZXB0IHRoYXQKICAgKiB5b3UgbXVzdCBhbHNvIGluY2x1ZGUgdGhlICFpbXBvcnRhbnQgZmxhZyB0byBvdmVycmlkZSB0aGUgZGlzcGxheSBwcm9wZXJ0eQogICAqIHNvIHRoYXQgeW91IGNhbiBwZXJmb3JtIGFuIGFuaW1hdGlvbiB3aGVuIHRoZSBlbGVtZW50IGlzIGhpZGRlbiBkdXJpbmcgdGhlIHRpbWUgb2YgdGhlIGFuaW1hdGlvbi4KICAgKgogICAqIGBgYGNzcwogICAqIC8vCiAgICogLy9hIHdvcmtpbmcgZXhhbXBsZSBjYW4gYmUgZm91bmQgYXQgdGhlIGJvdHRvbSBvZiB0aGlzIHBhZ2UKICAgKiAvLwogICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkLCAubXktZWxlbWVudC5uZy1oaWRlLXJlbW92ZSB7CiAqICAgdHJhbnNpdGlvbjowLjVzIGxpbmVhciBhbGw7CiAqIH0KICAgKgogICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkIHsgLi4uIH0KICAgKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZC5uZy1oaWRlLWFkZC1hY3RpdmUgeyAuLi4gfQogICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsgLi4uIH0KICAgKiAubXktZWxlbWVudC5uZy1oaWRlLXJlbW92ZS5uZy1oaWRlLXJlbW92ZS1hY3RpdmUgeyAuLi4gfQogICAqIGBgYAogICAqCiAgICogS2VlcCBpbiBtaW5kIHRoYXQsIGFzIG9mIEFuZ3VsYXJKUyB2ZXJzaW9uIDEuMi4xNyAoYW5kIDEuMy4wLWJldGEuMTEpLCB0aGVyZSBpcyBubyBuZWVkIHRvIGNoYW5nZSB0aGUgZGlzcGxheQogICAqIHByb3BlcnR5IHRvIGJsb2NrIGR1cmluZyBhbmltYXRpb24gc3RhdGVzLS1uZ0FuaW1hdGUgd2lsbCBoYW5kbGUgdGhlIHN0eWxlIHRvZ2dsaW5nIGF1dG9tYXRpY2FsbHkgZm9yIHlvdS4KICAgKgogICAqIEBhbmltYXRpb25zCiAgICogYWRkQ2xhc3M6IC5uZy1oaWRlIC0gaGFwcGVucyBhZnRlciB0aGUgbmdTaG93IGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgdHJ1dGh5IHZhbHVlIGFuZCB0aGUganVzdCBiZWZvcmUgY29udGVudHMgYXJlIHNldCB0byB2aXNpYmxlCiAgICogcmVtb3ZlQ2xhc3M6IC5uZy1oaWRlIC0gaGFwcGVucyBhZnRlciB0aGUgbmdTaG93IGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgbm9uIHRydXRoeSB2YWx1ZSBhbmQganVzdCBiZWZvcmUgdGhlIGNvbnRlbnRzIGFyZSBzZXQgdG8gaGlkZGVuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU2hvdyBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5CiAgICogICAgIHRoZW4gdGhlIGVsZW1lbnQgaXMgc2hvd24gb3IgaGlkZGVuIHJlc3BlY3RpdmVseS4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgQ2xpY2sgbWU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgIDxkaXY+CiAgIFNob3c6CiAgIDxkaXYgY2xhc3M9ImNoZWNrLWVsZW1lbnQgYW5pbWF0ZS1zaG93IiBuZy1zaG93PSJjaGVja2VkIj4KICAgPHNwYW4gY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24tdGh1bWJzLXVwIj48L3NwYW4+IEkgc2hvdyB1cCB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC4KICAgPC9kaXY+CiAgIDwvZGl2PgogICA8ZGl2PgogICBIaWRlOgogICA8ZGl2IGNsYXNzPSJjaGVjay1lbGVtZW50IGFuaW1hdGUtc2hvdyIgbmctaGlkZT0iY2hlY2tlZCI+CiAgIDxzcGFuIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLXRodW1icy1kb3duIj48L3NwYW4+IEkgaGlkZSB3aGVuIHlvdXIgY2hlY2tib3ggaXMgY2hlY2tlZC4KICAgPC9kaXY+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9ImdseXBoaWNvbnMuY3NzIj4KICAgQGltcG9ydCB1cmwoLy9uZXRkbmEuYm9vdHN0cmFwY2RuLmNvbS9ib290c3RyYXAvMy4wLjAvY3NzL2Jvb3RzdHJhcC1nbHlwaGljb25zLmNzcyk7CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAuYW5pbWF0ZS1zaG93IHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgIGxpbmUtaGVpZ2h0OjIwcHg7CiAgICAgICAgb3BhY2l0eToxOwogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgIH0KCiAgIC5hbmltYXRlLXNob3cubmctaGlkZSB7CiAgICAgICAgbGluZS1oZWlnaHQ6MDsKICAgICAgICBvcGFjaXR5OjA7CiAgICAgICAgcGFkZGluZzowIDEwcHg7CiAgICAgIH0KCiAgIC5jaGVjay1lbGVtZW50IHsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgYm9yZGVyOjFweCBzb2xpZCBibGFjazsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICB9CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIHZhciB0aHVtYnNVcCA9IGVsZW1lbnQoYnkuY3NzKCdzcGFuLmdseXBoaWNvbi10aHVtYnMtdXAnKSk7CiAgIHZhciB0aHVtYnNEb3duID0gZWxlbWVudChieS5jc3MoJ3NwYW4uZ2x5cGhpY29uLXRodW1icy1kb3duJykpOwoKICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1zaG93IC8gbmctaGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgIGV4cGVjdCh0aHVtYnNVcC5pc0Rpc3BsYXllZCgpKS50b0JlRmFsc3koKTsKICAgICAgICBleHBlY3QodGh1bWJzRG93bi5pc0Rpc3BsYXllZCgpKS50b0JlVHJ1dGh5KCk7CgogICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2NoZWNrZWQnKSkuY2xpY2soKTsKCiAgICAgICAgZXhwZWN0KHRodW1ic1VwLmlzRGlzcGxheWVkKCkpLnRvQmVUcnV0aHkoKTsKICAgICAgICBleHBlY3QodGh1bWJzRG93bi5pc0Rpc3BsYXllZCgpKS50b0JlRmFsc3koKTsKICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIHZhciBuZ1Nob3dEaXJlY3RpdmUgPSBbJyRhbmltYXRlJywgZnVuY3Rpb24oJGFuaW1hdGUpIHsKICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICBzY29wZS4kd2F0Y2goYXR0ci5uZ1Nob3csIGZ1bmN0aW9uIG5nU2hvd1dhdGNoQWN0aW9uKHZhbHVlKXsKICAgICAgICAkYW5pbWF0ZVt0b0Jvb2xlYW4odmFsdWUpID8gJ3JlbW92ZUNsYXNzJyA6ICdhZGRDbGFzcyddKGVsZW1lbnQsICduZy1oaWRlJyk7CiAgICAgIH0pOwogICAgfTsKICB9XTsKCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0hpZGUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdIaWRlYCBkaXJlY3RpdmUgc2hvd3Mgb3IgaGlkZXMgdGhlIGdpdmVuIEhUTUwgZWxlbWVudCBiYXNlZCBvbiB0aGUgZXhwcmVzc2lvbgogICAqIHByb3ZpZGVkIHRvIHRoZSBuZ0hpZGUgYXR0cmlidXRlLiBUaGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gYnkgcmVtb3Zpbmcgb3IgYWRkaW5nCiAgICogdGhlIGBuZy1oaWRlYCBDU1MgY2xhc3Mgb250byB0aGUgZWxlbWVudC4gVGhlIGAubmctaGlkZWAgQ1NTIGNsYXNzIGlzIHByZWRlZmluZWQKICAgKiBpbiBBbmd1bGFySlMgYW5kIHNldHMgdGhlIGRpc3BsYXkgc3R5bGUgdG8gbm9uZSAodXNpbmcgYW4gIWltcG9ydGFudCBmbGFnKS4KICAgKiBGb3IgQ1NQIG1vZGUgcGxlYXNlIGFkZCBgYW5ndWxhci1jc3AuY3NzYCB0byB5b3VyIGh0bWwgZmlsZSAoc2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDc3AgbmdDc3B9KS4KICAgKgogICAqIGBgYGh0bWwKICAgKiA8IS0tIHdoZW4gJHNjb3BlLm15VmFsdWUgaXMgdHJ1dGh5IChlbGVtZW50IGlzIGhpZGRlbikgLS0+CiAgICogPGRpdiBuZy1oaWRlPSJteVZhbHVlIiBjbGFzcz0ibmctaGlkZSI+PC9kaXY+CiAgICoKICAgKiA8IS0tIHdoZW4gJHNjb3BlLm15VmFsdWUgaXMgZmFsc3kgKGVsZW1lbnQgaXMgdmlzaWJsZSkgLS0+CiAgICogPGRpdiBuZy1oaWRlPSJteVZhbHVlIj48L2Rpdj4KICAgKiBgYGAKICAgKgogICAqIFdoZW4gdGhlIG5nSGlkZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlIHRoZW4gdGhlIC5uZy1oaWRlIENTUyBjbGFzcyBpcyBhZGRlZCB0byB0aGUgY2xhc3MgYXR0cmlidXRlCiAgICogb24gdGhlIGVsZW1lbnQgY2F1c2luZyBpdCB0byBiZWNvbWUgaGlkZGVuLiBXaGVuIGZhbHNlLCB0aGUgbmctaGlkZSBDU1MgY2xhc3MgaXMgcmVtb3ZlZAogICAqIGZyb20gdGhlIGVsZW1lbnQgY2F1c2luZyB0aGUgZWxlbWVudCBub3QgdG8gYXBwZWFyIGhpZGRlbi4KICAgKgogICAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogICAqICoqTm90ZToqKiBIZXJlIGlzIGEgbGlzdCBvZiB2YWx1ZXMgdGhhdCBuZ0hpZGUgd2lsbCBjb25zaWRlciBhcyBhIGZhbHN5IHZhbHVlIChjYXNlIGluc2Vuc2l0aXZlKTo8YnIgLz4KICAgKiAiZiIgLyAiMCIgLyAiZmFsc2UiIC8gIm5vIiAvICJuIiAvICJbXSIKICAgKiA8L2Rpdj4KICAgKgogICAqICMjIFdoeSBpcyAhaW1wb3J0YW50IHVzZWQ/CiAgICoKICAgKiBZb3UgbWF5IGJlIHdvbmRlcmluZyB3aHkgIWltcG9ydGFudCBpcyB1c2VkIGZvciB0aGUgLm5nLWhpZGUgQ1NTIGNsYXNzLiBUaGlzIGlzIGJlY2F1c2UgdGhlIGAubmctaGlkZWAgc2VsZWN0b3IKICAgKiBjYW4gYmUgZWFzaWx5IG92ZXJyaWRkZW4gYnkgaGVhdmllciBzZWxlY3RvcnMuIEZvciBleGFtcGxlLCBzb21ldGhpbmcgYXMgc2ltcGxlCiAgICogYXMgY2hhbmdpbmcgdGhlIGRpc3BsYXkgc3R5bGUgb24gYSBIVE1MIGxpc3QgaXRlbSB3b3VsZCBtYWtlIGhpZGRlbiBlbGVtZW50cyBhcHBlYXIgdmlzaWJsZS4KICAgKiBUaGlzIGFsc28gYmVjb21lcyBhIGJpZ2dlciBpc3N1ZSB3aGVuIGRlYWxpbmcgd2l0aCBDU1MgZnJhbWV3b3Jrcy4KICAgKgogICAqIEJ5IHVzaW5nICFpbXBvcnRhbnQsIHRoZSBzaG93IGFuZCBoaWRlIGJlaGF2aW9yIHdpbGwgd29yayBhcyBleHBlY3RlZCBkZXNwaXRlIGFueSBjbGFzaCBiZXR3ZWVuIENTUyBzZWxlY3RvcgogICAqIHNwZWNpZmljaXR5ICh3aGVuICFpbXBvcnRhbnQgaXNuJ3QgdXNlZCB3aXRoIGFueSBjb25mbGljdGluZyBzdHlsZXMpLiBJZiBhIGRldmVsb3BlciBjaG9vc2VzIHRvIG92ZXJyaWRlIHRoZQogICAqIHN0eWxpbmcgdG8gY2hhbmdlIGhvdyB0byBoaWRlIGFuIGVsZW1lbnQgdGhlbiBpdCBpcyBqdXN0IGEgbWF0dGVyIG9mIHVzaW5nICFpbXBvcnRhbnQgaW4gdGhlaXIgb3duIENTUyBjb2RlLgogICAqCiAgICogIyMjIE92ZXJyaWRpbmcgLm5nLWhpZGUKICAgKgogICAqIEJ5IGRlZmF1bHQsIHRoZSBgLm5nLWhpZGVgIGNsYXNzIHdpbGwgc3R5bGUgdGhlIGVsZW1lbnQgd2l0aCBgZGlzcGxheTpub25lIWltcG9ydGFudGAuIElmIHlvdSB3aXNoIHRvIGNoYW5nZQogICAqIHRoZSBoaWRlIGJlaGF2aW9yIHdpdGggbmdTaG93L25nSGlkZSB0aGVuIHRoaXMgY2FuIGJlIGFjaGlldmVkIGJ5IHJlc3RhdGluZyB0aGUgc3R5bGVzIGZvciB0aGUgYC5uZy1oaWRlYAogICAqIGNsYXNzIGluIENTUzoKICAgKgogICAqIGBgYGNzcwogICAqIC5uZy1oaWRlIHsKICogICAvL3RoaXMgaXMganVzdCBhbm90aGVyIGZvcm0gb2YgaGlkaW5nIGFuIGVsZW1lbnQKICogICBkaXNwbGF5OmJsb2NrIWltcG9ydGFudDsKICogICBwb3NpdGlvbjphYnNvbHV0ZTsKICogICB0b3A6LTk5OTlweDsKICogICBsZWZ0Oi05OTk5cHg7CiAqIH0KICAgKiBgYGAKICAgKgogICAqIEJ5IGRlZmF1bHQgeW91IGRvbid0IG5lZWQgdG8gb3ZlcnJpZGUgaW4gQ1NTIGFueXRoaW5nIGFuZCB0aGUgYW5pbWF0aW9ucyB3aWxsIHdvcmsgYXJvdW5kIHRoZSBkaXNwbGF5IHN0eWxlLgogICAqCiAgICogIyMgQSBub3RlIGFib3V0IGFuaW1hdGlvbnMgd2l0aCBuZ0hpZGUKICAgKgogICAqIEFuaW1hdGlvbnMgaW4gbmdTaG93L25nSGlkZSB3b3JrIHdpdGggdGhlIHNob3cgYW5kIGhpZGUgZXZlbnRzIHRoYXQgYXJlIHRyaWdnZXJlZCB3aGVuIHRoZSBkaXJlY3RpdmUgZXhwcmVzc2lvbgogICAqIGlzIHRydWUgYW5kIGZhbHNlLiBUaGlzIHN5c3RlbSB3b3JrcyBsaWtlIHRoZSBhbmltYXRpb24gc3lzdGVtIHByZXNlbnQgd2l0aCBuZ0NsYXNzLCBleGNlcHQgdGhhdCB0aGUgYC5uZy1oaWRlYAogICAqIENTUyBjbGFzcyBpcyBhZGRlZCBhbmQgcmVtb3ZlZCBmb3IgeW91IGluc3RlYWQgb2YgeW91ciBvd24gQ1NTIGNsYXNzLgogICAqCiAgICogYGBgY3NzCiAgICogLy8KICAgKiAvL2Egd29ya2luZyBleGFtcGxlIGNhbiBiZSBmb3VuZCBhdCB0aGUgYm90dG9tIG9mIHRoaXMgcGFnZQogICAqIC8vCiAgICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQsIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogfQogICAqCiAgICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQgeyAuLi4gfQogICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkLm5nLWhpZGUtYWRkLWFjdGl2ZSB7IC4uLiB9CiAgICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgeyAuLi4gfQogICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlLm5nLWhpZGUtcmVtb3ZlLWFjdGl2ZSB7IC4uLiB9CiAgICogYGBgCiAgICoKICAgKiBLZWVwIGluIG1pbmQgdGhhdCwgYXMgb2YgQW5ndWxhckpTIHZlcnNpb24gMS4yLjE3IChhbmQgMS4zLjAtYmV0YS4xMSksIHRoZXJlIGlzIG5vIG5lZWQgdG8gY2hhbmdlIHRoZSBkaXNwbGF5CiAgICogcHJvcGVydHkgdG8gYmxvY2sgZHVyaW5nIGFuaW1hdGlvbiBzdGF0ZXMtLW5nQW5pbWF0ZSB3aWxsIGhhbmRsZSB0aGUgc3R5bGUgdG9nZ2xpbmcgYXV0b21hdGljYWxseSBmb3IgeW91LgogICAqCiAgICogQGFuaW1hdGlvbnMKICAgKiByZW1vdmVDbGFzczogLm5nLWhpZGUgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ0hpZGUgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSB0cnV0aHkgdmFsdWUgYW5kIGp1c3QgYmVmb3JlIHRoZSBjb250ZW50cyBhcmUgc2V0IHRvIGhpZGRlbgogICAqIGFkZENsYXNzOiAubmctaGlkZSAtIGhhcHBlbnMgYWZ0ZXIgdGhlIG5nSGlkZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhIG5vbiB0cnV0aHkgdmFsdWUgYW5kIGp1c3QgYmVmb3JlIHRoZSBjb250ZW50cyBhcmUgc2V0IHRvIHZpc2libGUKICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdIaWRlIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHkgdGhlbgogICAqICAgICB0aGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gcmVzcGVjdGl2ZWx5LgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgPGRpdj4KICAgU2hvdzoKICAgPGRpdiBjbGFzcz0iY2hlY2stZWxlbWVudCBhbmltYXRlLWhpZGUiIG5nLXNob3c9ImNoZWNrZWQiPgogICA8c3BhbiBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi10aHVtYnMtdXAiPjwvc3Bhbj4gSSBzaG93IHVwIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICA8L2Rpdj4KICAgPC9kaXY+CiAgIDxkaXY+CiAgIEhpZGU6CiAgIDxkaXYgY2xhc3M9ImNoZWNrLWVsZW1lbnQgYW5pbWF0ZS1oaWRlIiBuZy1oaWRlPSJjaGVja2VkIj4KICAgPHNwYW4gY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24tdGh1bWJzLWRvd24iPjwvc3Bhbj4gSSBoaWRlIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICA8L2Rpdj4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0iZ2x5cGhpY29ucy5jc3MiPgogICBAaW1wb3J0IHVybCgvL25ldGRuYS5ib290c3RyYXBjZG4uY29tL2Jvb3RzdHJhcC8zLjAuMC9jc3MvYm9vdHN0cmFwLWdseXBoaWNvbnMuY3NzKTsKICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgIC5hbmltYXRlLWhpZGUgewogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgbGluZS1oZWlnaHQ6MjBweDsKICAgICAgICBvcGFjaXR5OjE7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgfQoKICAgLmFuaW1hdGUtaGlkZS5uZy1oaWRlIHsKICAgICAgICBsaW5lLWhlaWdodDowOwogICAgICAgIG9wYWNpdHk6MDsKICAgICAgICBwYWRkaW5nOjAgMTBweDsKICAgICAgfQoKICAgLmNoZWNrLWVsZW1lbnQgewogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgIH0KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgdmFyIHRodW1ic1VwID0gZWxlbWVudChieS5jc3MoJ3NwYW4uZ2x5cGhpY29uLXRodW1icy11cCcpKTsKICAgdmFyIHRodW1ic0Rvd24gPSBlbGVtZW50KGJ5LmNzcygnc3Bhbi5nbHlwaGljb24tdGh1bWJzLWRvd24nKSk7CgogICBpdCgnc2hvdWxkIGNoZWNrIG5nLXNob3cgLyBuZy1oaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KHRodW1ic1VwLmlzRGlzcGxheWVkKCkpLnRvQmVGYWxzeSgpOwogICAgICAgIGV4cGVjdCh0aHVtYnNEb3duLmlzRGlzcGxheWVkKCkpLnRvQmVUcnV0aHkoKTsKCiAgICAgICAgZWxlbWVudChieS5tb2RlbCgnY2hlY2tlZCcpKS5jbGljaygpOwoKICAgICAgICBleHBlY3QodGh1bWJzVXAuaXNEaXNwbGF5ZWQoKSkudG9CZVRydXRoeSgpOwogICAgICAgIGV4cGVjdCh0aHVtYnNEb3duLmlzRGlzcGxheWVkKCkpLnRvQmVGYWxzeSgpOwogICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nSGlkZURpcmVjdGl2ZSA9IFsnJGFuaW1hdGUnLCBmdW5jdGlvbigkYW5pbWF0ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nSGlkZSwgZnVuY3Rpb24gbmdIaWRlV2F0Y2hBY3Rpb24odmFsdWUpewogICAgICAgICRhbmltYXRlW3RvQm9vbGVhbih2YWx1ZSkgPyAnYWRkQ2xhc3MnIDogJ3JlbW92ZUNsYXNzJ10oZWxlbWVudCwgJ25nLWhpZGUnKTsKICAgICAgfSk7CiAgICB9OwogIH1dOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdTdHlsZQogICAqIEByZXN0cmljdCBBQwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGBuZ1N0eWxlYCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzZXQgQ1NTIHN0eWxlIG9uIGFuIEhUTUwgZWxlbWVudCBjb25kaXRpb25hbGx5LgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1N0eWxlCiAgICoKICAgKiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB3aGljaCBldmFscyB0byBhbgogICAqIG9iamVjdCB3aG9zZSBrZXlzIGFyZSBDU1Mgc3R5bGUgbmFtZXMgYW5kIHZhbHVlcyBhcmUgY29ycmVzcG9uZGluZyB2YWx1ZXMgZm9yIHRob3NlIENTUwogICAqIGtleXMuCiAgICoKICAgKiBTaW5jZSBzb21lIENTUyBzdHlsZSBuYW1lcyBhcmUgbm90IHZhbGlkIGtleXMgZm9yIGFuIG9iamVjdCwgdGhleSBtdXN0IGJlIHF1b3RlZC4KICAgKiBTZWUgdGhlICdiYWNrZ3JvdW5kLWNvbG9yJyBzdHlsZSBpbiB0aGUgZXhhbXBsZSBiZWxvdy4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCBjb2xvciIgbmctY2xpY2s9Im15U3R5bGU9e2NvbG9yOidyZWQnfSI+CiAgIDxpbnB1dCB0eXBlPSJidXR0b24iIHZhbHVlPSJzZXQgYmFja2dyb3VuZCIgbmctY2xpY2s9Im15U3R5bGU9eydiYWNrZ3JvdW5kLWNvbG9yJzonYmx1ZSd9Ij4KICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9ImNsZWFyIiBuZy1jbGljaz0ibXlTdHlsZT17fSI+CiAgIDxici8+CiAgIDxzcGFuIG5nLXN0eWxlPSJteVN0eWxlIj5TYW1wbGUgVGV4dDwvc3Bhbj4KICAgPHByZT5teVN0eWxlPXt7bXlTdHlsZX19PC9wcmU+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgc3BhbiB7CiAgICAgICAgIGNvbG9yOiBibGFjazsKICAgICAgIH0KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgdmFyIGNvbG9yU3BhbiA9IGVsZW1lbnQoYnkuY3NzKCdzcGFuJykpOwoKICAgaWl0KCdzaG91bGQgY2hlY2sgbmctc3R5bGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGNvbG9yU3Bhbi5nZXRDc3NWYWx1ZSgnY29sb3InKSkudG9CZSgncmdiYSgwLCAwLCAwLCAxKScpOwogICAgICAgICBlbGVtZW50KGJ5LmNzcygnaW5wdXRbdmFsdWU9XCdzZXQgY29sb3JcJ10nKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGNvbG9yU3Bhbi5nZXRDc3NWYWx1ZSgnY29sb3InKSkudG9CZSgncmdiYSgyNTUsIDAsIDAsIDEpJyk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCdpbnB1dFt2YWx1ZT1jbGVhcl0nKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KGNvbG9yU3Bhbi5nZXRDc3NWYWx1ZSgnY29sb3InKSkudG9CZSgncmdiYSgwLCAwLCAwLCAxKScpOwogICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIHZhciBuZ1N0eWxlRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nU3R5bGUsIGZ1bmN0aW9uIG5nU3R5bGVXYXRjaEFjdGlvbihuZXdTdHlsZXMsIG9sZFN0eWxlcykgewogICAgICBpZiAob2xkU3R5bGVzICYmIChuZXdTdHlsZXMgIT09IG9sZFN0eWxlcykpIHsKICAgICAgICBmb3JFYWNoKG9sZFN0eWxlcywgZnVuY3Rpb24odmFsLCBzdHlsZSkgeyBlbGVtZW50LmNzcyhzdHlsZSwgJycpO30pOwogICAgICB9CiAgICAgIGlmIChuZXdTdHlsZXMpIGVsZW1lbnQuY3NzKG5ld1N0eWxlcyk7CiAgICB9LCB0cnVlKTsKICB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nU3dpdGNoCiAgICogQHJlc3RyaWN0IEVBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgYG5nU3dpdGNoYCBkaXJlY3RpdmUgaXMgdXNlZCB0byBjb25kaXRpb25hbGx5IHN3YXAgRE9NIHN0cnVjdHVyZSBvbiB5b3VyIHRlbXBsYXRlIGJhc2VkIG9uIGEgc2NvcGUgZXhwcmVzc2lvbi4KICAgKiBFbGVtZW50cyB3aXRoaW4gYG5nU3dpdGNoYCBidXQgd2l0aG91dCBgbmdTd2l0Y2hXaGVuYCBvciBgbmdTd2l0Y2hEZWZhdWx0YCBkaXJlY3RpdmVzIHdpbGwgYmUgcHJlc2VydmVkIGF0IHRoZSBsb2NhdGlvbgogICAqIGFzIHNwZWNpZmllZCBpbiB0aGUgdGVtcGxhdGUuCiAgICoKICAgKiBUaGUgZGlyZWN0aXZlIGl0c2VsZiB3b3JrcyBzaW1pbGFyIHRvIG5nSW5jbHVkZSwgaG93ZXZlciwgaW5zdGVhZCBvZiBkb3dubG9hZGluZyB0ZW1wbGF0ZSBjb2RlIChvciBsb2FkaW5nIGl0CiAgICogZnJvbSB0aGUgdGVtcGxhdGUgY2FjaGUpLCBgbmdTd2l0Y2hgIHNpbXBseSBjaG9vc2VzIG9uZSBvZiB0aGUgbmVzdGVkIGVsZW1lbnRzIGFuZCBtYWtlcyBpdCB2aXNpYmxlIGJhc2VkIG9uIHdoaWNoIGVsZW1lbnQKICAgKiBtYXRjaGVzIHRoZSB2YWx1ZSBvYnRhaW5lZCBmcm9tIHRoZSBldmFsdWF0ZWQgZXhwcmVzc2lvbi4gSW4gb3RoZXIgd29yZHMsIHlvdSBkZWZpbmUgYSBjb250YWluZXIgZWxlbWVudAogICAqICh3aGVyZSB5b3UgcGxhY2UgdGhlIGRpcmVjdGl2ZSksIHBsYWNlIGFuIGV4cHJlc3Npb24gb24gdGhlICoqYG9uPSIuLi4iYCBhdHRyaWJ1dGUqKgogICAqIChvciB0aGUgKipgbmctc3dpdGNoPSIuLi4iYCBhdHRyaWJ1dGUqKiksIGRlZmluZSBhbnkgaW5uZXIgZWxlbWVudHMgaW5zaWRlIG9mIHRoZSBkaXJlY3RpdmUgYW5kIHBsYWNlCiAgICogYSB3aGVuIGF0dHJpYnV0ZSBwZXIgZWxlbWVudC4gVGhlIHdoZW4gYXR0cmlidXRlIGlzIHVzZWQgdG8gaW5mb3JtIG5nU3dpdGNoIHdoaWNoIGVsZW1lbnQgdG8gZGlzcGxheSB3aGVuIHRoZSBvbgogICAqIGV4cHJlc3Npb24gaXMgZXZhbHVhdGVkLiBJZiBhIG1hdGNoaW5nIGV4cHJlc3Npb24gaXMgbm90IGZvdW5kIHZpYSBhIHdoZW4gYXR0cmlidXRlIHRoZW4gYW4gZWxlbWVudCB3aXRoIHRoZSBkZWZhdWx0CiAgICogYXR0cmlidXRlIGlzIGRpc3BsYXllZC4KICAgKgogICAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LWluZm8iPgogICAqIEJlIGF3YXJlIHRoYXQgdGhlIGF0dHJpYnV0ZSB2YWx1ZXMgdG8gbWF0Y2ggYWdhaW5zdCBjYW5ub3QgYmUgZXhwcmVzc2lvbnMuIFRoZXkgYXJlIGludGVycHJldGVkCiAgICogYXMgbGl0ZXJhbCBzdHJpbmcgdmFsdWVzIHRvIG1hdGNoIGFnYWluc3QuCiAgICogRm9yIGV4YW1wbGUsICoqYG5nLXN3aXRjaC13aGVuPSJzb21lVmFsImAqKiB3aWxsIG1hdGNoIGFnYWluc3QgdGhlIHN0cmluZyBgInNvbWVWYWwiYCBub3QgYWdhaW5zdCB0aGUKICAgKiB2YWx1ZSBvZiB0aGUgZXhwcmVzc2lvbiBgJHNjb3BlLnNvbWVWYWxgLgogICAqIDwvZGl2PgoKICAgKiBAYW5pbWF0aW9ucwogICAqIGVudGVyIC0gaGFwcGVucyBhZnRlciB0aGUgbmdTd2l0Y2ggY29udGVudHMgY2hhbmdlIGFuZCB0aGUgbWF0Y2hlZCBjaGlsZCBlbGVtZW50IGlzIHBsYWNlZCBpbnNpZGUgdGhlIGNvbnRhaW5lcgogICAqIGxlYXZlIC0gaGFwcGVucyBqdXN0IGFmdGVyIHRoZSBuZ1N3aXRjaCBjb250ZW50cyBjaGFuZ2UgYW5kIGp1c3QgYmVmb3JlIHRoZSBmb3JtZXIgY29udGVudHMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgRE9NCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIGBgYAogICAqIDxBTlkgbmctc3dpdGNoPSJleHByZXNzaW9uIj4KICAgKiAgIDxBTlkgbmctc3dpdGNoLXdoZW49Im1hdGNoVmFsdWUxIj4uLi48L0FOWT4KICAgKiAgIDxBTlkgbmctc3dpdGNoLXdoZW49Im1hdGNoVmFsdWUyIj4uLi48L0FOWT4KICAgKiAgIDxBTlkgbmctc3dpdGNoLWRlZmF1bHQ+Li4uPC9BTlk+CiAgICogPC9BTlk+CiAgICogYGBgCiAgICoKICAgKgogICAqIEBzY29wZQogICAqIEBwcmlvcml0eSA4MDAKICAgKiBAcGFyYW0geyp9IG5nU3dpdGNofG9uIGV4cHJlc3Npb24gdG8gbWF0Y2ggYWdhaW5zdCA8dHQ+bmctc3dpdGNoLXdoZW48L3R0Pi4KICAgKiBPbiBjaGlsZCBlbGVtZW50cyBhZGQ6CiAgICoKICAgKiAqIGBuZ1N3aXRjaFdoZW5gOiB0aGUgY2FzZSBzdGF0ZW1lbnQgdG8gbWF0Y2ggYWdhaW5zdC4gSWYgbWF0Y2ggdGhlbiB0aGlzCiAgICogICBjYXNlIHdpbGwgYmUgZGlzcGxheWVkLiBJZiB0aGUgc2FtZSBtYXRjaCBhcHBlYXJzIG11bHRpcGxlIHRpbWVzLCBhbGwgdGhlCiAgICogICBlbGVtZW50cyB3aWxsIGJlIGRpc3BsYXllZC4KICAgKiAqIGBuZ1N3aXRjaERlZmF1bHRgOiB0aGUgZGVmYXVsdCBjYXNlIHdoZW4gbm8gb3RoZXIgY2FzZSBtYXRjaC4gSWYgdGhlcmUKICAgKiAgIGFyZSBtdWx0aXBsZSBkZWZhdWx0IGNhc2VzLCBhbGwgb2YgdGhlbSB3aWxsIGJlIGRpc3BsYXllZCB3aGVuIG5vIG90aGVyCiAgICogICBjYXNlIG1hdGNoLgogICAqCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9Im5nQW5pbWF0ZSIgZGVwcz0iYW5ndWxhci1hbmltYXRlLmpzIiBhbmltYXRpb25zPSJ0cnVlIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIDxzZWxlY3QgbmctbW9kZWw9InNlbGVjdGlvbiIgbmctb3B0aW9ucz0iaXRlbSBmb3IgaXRlbSBpbiBpdGVtcyI+CiAgIDwvc2VsZWN0PgogICA8dHQ+c2VsZWN0aW9uPXt7c2VsZWN0aW9ufX08L3R0PgogICA8aHIvPgogICA8ZGl2IGNsYXNzPSJhbmltYXRlLXN3aXRjaC1jb250YWluZXIiCiAgIG5nLXN3aXRjaCBvbj0ic2VsZWN0aW9uIj4KICAgPGRpdiBjbGFzcz0iYW5pbWF0ZS1zd2l0Y2giIG5nLXN3aXRjaC13aGVuPSJzZXR0aW5ncyI+U2V0dGluZ3MgRGl2PC9kaXY+CiAgIDxkaXYgY2xhc3M9ImFuaW1hdGUtc3dpdGNoIiBuZy1zd2l0Y2gtd2hlbj0iaG9tZSI+SG9tZSBTcGFuPC9kaXY+CiAgIDxkaXYgY2xhc3M9ImFuaW1hdGUtc3dpdGNoIiBuZy1zd2l0Y2gtZGVmYXVsdD5kZWZhdWx0PC9kaXY+CiAgIDwvZGl2PgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICRzY29wZS5pdGVtcyA9IFsnc2V0dGluZ3MnLCAnaG9tZScsICdvdGhlciddOwogICAgICAgICRzY29wZS5zZWxlY3Rpb24gPSAkc2NvcGUuaXRlbXNbMF07CiAgICAgIH0KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgIC5hbmltYXRlLXN3aXRjaC1jb250YWluZXIgewogICAgICAgIHBvc2l0aW9uOnJlbGF0aXZlOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgYm9yZGVyOjFweCBzb2xpZCBibGFjazsKICAgICAgICBoZWlnaHQ6NDBweDsKICAgICAgICBvdmVyZmxvdzpoaWRkZW47CiAgICAgIH0KCiAgIC5hbmltYXRlLXN3aXRjaCB7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICB9CgogICAuYW5pbWF0ZS1zd2l0Y2gubmctYW5pbWF0ZSB7CiAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwoKICAgICAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgICAgICB0b3A6MDsKICAgICAgICBsZWZ0OjA7CiAgICAgICAgcmlnaHQ6MDsKICAgICAgICBib3R0b206MDsKICAgICAgfQoKICAgLmFuaW1hdGUtc3dpdGNoLm5nLWxlYXZlLm5nLWxlYXZlLWFjdGl2ZSwKICAgLmFuaW1hdGUtc3dpdGNoLm5nLWVudGVyIHsKICAgICAgICB0b3A6LTUwcHg7CiAgICAgIH0KICAgLmFuaW1hdGUtc3dpdGNoLm5nLWxlYXZlLAogICAuYW5pbWF0ZS1zd2l0Y2gubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICAgICAgICB0b3A6MDsKICAgICAgfQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICB2YXIgc3dpdGNoRWxlbSA9IGVsZW1lbnQoYnkuY3NzKCdbbmctc3dpdGNoXScpKTsKICAgdmFyIHNlbGVjdCA9IGVsZW1lbnQoYnkubW9kZWwoJ3NlbGVjdGlvbicpKTsKCiAgIGl0KCdzaG91bGQgc3RhcnQgaW4gc2V0dGluZ3MnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3Qoc3dpdGNoRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL1NldHRpbmdzIERpdi8pOwogICAgICB9KTsKICAgaXQoJ3Nob3VsZCBjaGFuZ2UgdG8gaG9tZScsIGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGVjdC5lbGVtZW50LmFsbChieS5jc3MoJ29wdGlvbicpKS5nZXQoMSkuY2xpY2soKTsKICAgICAgICBleHBlY3Qoc3dpdGNoRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL0hvbWUgU3Bhbi8pOwogICAgICB9KTsKICAgaXQoJ3Nob3VsZCBzZWxlY3QgZGVmYXVsdCcsIGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGVjdC5lbGVtZW50LmFsbChieS5jc3MoJ29wdGlvbicpKS5nZXQoMikuY2xpY2soKTsKICAgICAgICBleHBlY3Qoc3dpdGNoRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL2RlZmF1bHQvKTsKICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIHZhciBuZ1N3aXRjaERpcmVjdGl2ZSA9IFsnJGFuaW1hdGUnLCBmdW5jdGlvbigkYW5pbWF0ZSkgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFQScsCiAgICAgIHJlcXVpcmU6ICduZ1N3aXRjaCcsCgogICAgICAvLyBhc2tzIGZvciAkc2NvcGUgdG8gZm9vbCB0aGUgQkMgY29udHJvbGxlciBtb2R1bGUKICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCBmdW5jdGlvbiBuZ1N3aXRjaENvbnRyb2xsZXIoKSB7CiAgICAgICAgdGhpcy5jYXNlcyA9IHt9OwogICAgICB9XSwKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIG5nU3dpdGNoQ29udHJvbGxlcikgewogICAgICAgIHZhciB3YXRjaEV4cHIgPSBhdHRyLm5nU3dpdGNoIHx8IGF0dHIub24sCiAgICAgICAgICBzZWxlY3RlZFRyYW5zY2x1ZGVzID0gW10sCiAgICAgICAgICBzZWxlY3RlZEVsZW1lbnRzID0gW10sCiAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzID0gW10sCiAgICAgICAgICBzZWxlY3RlZFNjb3BlcyA9IFtdOwoKICAgICAgICBzY29wZS4kd2F0Y2god2F0Y2hFeHByLCBmdW5jdGlvbiBuZ1N3aXRjaFdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgICB2YXIgaSwgaWk7CiAgICAgICAgICBmb3IgKGkgPSAwLCBpaSA9IHByZXZpb3VzRWxlbWVudHMubGVuZ3RoOyBpIDwgaWk7ICsraSkgewogICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzW2ldLnJlbW92ZSgpOwogICAgICAgICAgfQogICAgICAgICAgcHJldmlvdXNFbGVtZW50cy5sZW5ndGggPSAwOwoKICAgICAgICAgIGZvciAoaSA9IDAsIGlpID0gc2VsZWN0ZWRTY29wZXMubGVuZ3RoOyBpIDwgaWk7ICsraSkgewogICAgICAgICAgICB2YXIgc2VsZWN0ZWQgPSBzZWxlY3RlZEVsZW1lbnRzW2ldOwogICAgICAgICAgICBzZWxlY3RlZFNjb3Blc1tpXS4kZGVzdHJveSgpOwogICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzW2ldID0gc2VsZWN0ZWQ7CiAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKHNlbGVjdGVkLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgc2VsZWN0ZWRFbGVtZW50cy5sZW5ndGggPSAwOwogICAgICAgICAgc2VsZWN0ZWRTY29wZXMubGVuZ3RoID0gMDsKCiAgICAgICAgICBpZiAoKHNlbGVjdGVkVHJhbnNjbHVkZXMgPSBuZ1N3aXRjaENvbnRyb2xsZXIuY2FzZXNbJyEnICsgdmFsdWVdIHx8IG5nU3dpdGNoQ29udHJvbGxlci5jYXNlc1snPyddKSkgewogICAgICAgICAgICBzY29wZS4kZXZhbChhdHRyLmNoYW5nZSk7CiAgICAgICAgICAgIGZvckVhY2goc2VsZWN0ZWRUcmFuc2NsdWRlcywgZnVuY3Rpb24oc2VsZWN0ZWRUcmFuc2NsdWRlKSB7CiAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgc2VsZWN0ZWRTY29wZXMucHVzaChzZWxlY3RlZFNjb3BlKTsKICAgICAgICAgICAgICBzZWxlY3RlZFRyYW5zY2x1ZGUudHJhbnNjbHVkZShzZWxlY3RlZFNjb3BlLCBmdW5jdGlvbihjYXNlRWxlbWVudCkgewogICAgICAgICAgICAgICAgdmFyIGFuY2hvciA9IHNlbGVjdGVkVHJhbnNjbHVkZS5lbGVtZW50OwoKICAgICAgICAgICAgICAgIHNlbGVjdGVkRWxlbWVudHMucHVzaChjYXNlRWxlbWVudCk7CiAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjYXNlRWxlbWVudCwgYW5jaG9yLnBhcmVudCgpLCBhbmNob3IpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICB9XTsKCiAgdmFyIG5nU3dpdGNoV2hlbkRpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgIHByaW9yaXR5OiA4MDAsCiAgICByZXF1aXJlOiAnXm5nU3dpdGNoJywKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY3RybCwgJHRyYW5zY2x1ZGUpIHsKICAgICAgY3RybC5jYXNlc1snIScgKyBhdHRycy5uZ1N3aXRjaFdoZW5dID0gKGN0cmwuY2FzZXNbJyEnICsgYXR0cnMubmdTd2l0Y2hXaGVuXSB8fCBbXSk7CiAgICAgIGN0cmwuY2FzZXNbJyEnICsgYXR0cnMubmdTd2l0Y2hXaGVuXS5wdXNoKHsgdHJhbnNjbHVkZTogJHRyYW5zY2x1ZGUsIGVsZW1lbnQ6IGVsZW1lbnQgfSk7CiAgICB9CiAgfSk7CgogIHZhciBuZ1N3aXRjaERlZmF1bHREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICBwcmlvcml0eTogODAwLAogICAgcmVxdWlyZTogJ15uZ1N3aXRjaCcsCiAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHRyYW5zY2x1ZGUpIHsKICAgICAgY3RybC5jYXNlc1snPyddID0gKGN0cmwuY2FzZXNbJz8nXSB8fCBbXSk7CiAgICAgIGN0cmwuY2FzZXNbJz8nXS5wdXNoKHsgdHJhbnNjbHVkZTogJHRyYW5zY2x1ZGUsIGVsZW1lbnQ6IGVsZW1lbnQgfSk7CiAgICB9CiAgfSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ1RyYW5zY2x1ZGUKICAgKiBAcmVzdHJpY3QgQUMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERpcmVjdGl2ZSB0aGF0IG1hcmtzIHRoZSBpbnNlcnRpb24gcG9pbnQgZm9yIHRoZSB0cmFuc2NsdWRlZCBET00gb2YgdGhlIG5lYXJlc3QgcGFyZW50IGRpcmVjdGl2ZSB0aGF0IHVzZXMgdHJhbnNjbHVzaW9uLgogICAqCiAgICogQW55IGV4aXN0aW5nIGNvbnRlbnQgb2YgdGhlIGVsZW1lbnQgdGhhdCB0aGlzIGRpcmVjdGl2ZSBpcyBwbGFjZWQgb24gd2lsbCBiZSByZW1vdmVkIGJlZm9yZSB0aGUgdHJhbnNjbHVkZWQgY29udGVudCBpcyBpbnNlcnRlZC4KICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJ0cmFuc2NsdWRlIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnRpdGxlID0gJ0xvcmVtIElwc3VtJzsKICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdOZXF1ZSBwb3JybyBxdWlzcXVhbSBlc3QgcXVpIGRvbG9yZW0gaXBzdW0gcXVpYSBkb2xvci4uLic7CiAgICAgICAgIH0KCiAgIGFuZ3VsYXIubW9kdWxlKCd0cmFuc2NsdWRlJywgW10pCiAgIC5kaXJlY3RpdmUoJ3BhbmUnLCBmdW5jdGlvbigpewogICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICAgICAgICAgc2NvcGU6IHsgdGl0bGU6J0AnIH0sCiAgIHRlbXBsYXRlOiAnPGRpdiBzdHlsZT0iYm9yZGVyOiAxcHggc29saWQgYmxhY2s7Ij4nICsKICAgJzxkaXYgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6IGdyYXkiPnt7dGl0bGV9fTwvZGl2PicgKwogICAnPGRpdiBuZy10cmFuc2NsdWRlPjwvZGl2PicgKwogICAnPC9kaXY+JwogICB9OwogICB9KTsKICAgPC9zY3JpcHQ+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIDxpbnB1dCBuZy1tb2RlbD0idGl0bGUiPjxicj4KICAgPHRleHRhcmVhIG5nLW1vZGVsPSJ0ZXh0Ij48L3RleHRhcmVhPiA8YnIvPgogICA8cGFuZSB0aXRsZT0ie3t0aXRsZX19Ij57e3RleHR9fTwvcGFuZT4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgaGF2ZSB0cmFuc2NsdWRlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHRpdGxlRWxlbWVudCA9IGVsZW1lbnQoYnkubW9kZWwoJ3RpdGxlJykpOwogICAgICAgICAgdGl0bGVFbGVtZW50LmNsZWFyKCk7CiAgICAgICAgICB0aXRsZUVsZW1lbnQuc2VuZEtleXMoJ1RJVExFJyk7CiAgICAgICAgICB2YXIgdGV4dEVsZW1lbnQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZXh0JykpOwogICAgICAgICAgdGV4dEVsZW1lbnQuY2xlYXIoKTsKICAgICAgICAgIHRleHRFbGVtZW50LnNlbmRLZXlzKCdURVhUJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd0aXRsZScpKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1RJVExFJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd0ZXh0JykpLmdldFRleHQoKSkudG9FcXVhbCgnVEVYVCcpOwogICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKgogICAqLwogIHZhciBuZ1RyYW5zY2x1ZGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsIGNvbnRyb2xsZXIsICR0cmFuc2NsdWRlKSB7CiAgICAgIGlmICghJHRyYW5zY2x1ZGUpIHsKICAgICAgICB0aHJvdyBtaW5FcnIoJ25nVHJhbnNjbHVkZScpKCdvcnBoYW4nLAogICAgICAgICAgICAnSWxsZWdhbCB1c2Ugb2YgbmdUcmFuc2NsdWRlIGRpcmVjdGl2ZSBpbiB0aGUgdGVtcGxhdGUhICcgKwogICAgICAgICAgICAnTm8gcGFyZW50IGRpcmVjdGl2ZSB0aGF0IHJlcXVpcmVzIGEgdHJhbnNjbHVzaW9uIGZvdW5kLiAnICsKICAgICAgICAgICAgJ0VsZW1lbnQ6IHswfScsCiAgICAgICAgICBzdGFydGluZ1RhZygkZWxlbWVudCkpOwogICAgICB9CgogICAgICAkdHJhbnNjbHVkZShmdW5jdGlvbihjbG9uZSkgewogICAgICAgICRlbGVtZW50LmVtcHR5KCk7CiAgICAgICAgJGVsZW1lbnQuYXBwZW5kKGNsb25lKTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBzY3JpcHQKICAgKiBAcmVzdHJpY3QgRQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogTG9hZCB0aGUgY29udGVudCBvZiBhIGA8c2NyaXB0PmAgZWxlbWVudCBpbnRvIHtAbGluayBuZy4kdGVtcGxhdGVDYWNoZSBgJHRlbXBsYXRlQ2FjaGVgfSwgc28gdGhhdCB0aGUKICAgKiB0ZW1wbGF0ZSBjYW4gYmUgdXNlZCBieSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSBgbmdJbmNsdWRlYH0sCiAgICoge0BsaW5rIG5nUm91dGUuZGlyZWN0aXZlOm5nVmlldyBgbmdWaWV3YH0sIG9yIHtAbGluayBndWlkZS9kaXJlY3RpdmUgZGlyZWN0aXZlc30uIFRoZSB0eXBlIG9mIHRoZQogICAqIGA8c2NyaXB0PmAgZWxlbWVudCBtdXN0IGJlIHNwZWNpZmllZCBhcyBgdGV4dC9uZy10ZW1wbGF0ZWAsIGFuZCBhIGNhY2hlIG5hbWUgZm9yIHRoZSB0ZW1wbGF0ZSBtdXN0IGJlCiAgICogYXNzaWduZWQgdGhyb3VnaCB0aGUgZWxlbWVudCdzIGBpZGAsIHdoaWNoIGNhbiB0aGVuIGJlIHVzZWQgYXMgYSBkaXJlY3RpdmUncyBgdGVtcGxhdGVVcmxgLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgTXVzdCBiZSBzZXQgdG8gYCd0ZXh0L25nLXRlbXBsYXRlJ2AuCiAgICogQHBhcmFtIHtzdHJpbmd9IGlkIENhY2hlIG5hbWUgb2YgdGhlIHRlbXBsYXRlLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSIvdHBsLmh0bWwiPgogICBDb250ZW50IG9mIHRoZSB0ZW1wbGF0ZS4KICAgPC9zY3JpcHQ+CgogICA8YSBuZy1jbGljaz0iY3VycmVudFRwbD0nL3RwbC5odG1sJyIgaWQ9InRwbC1saW5rIj5Mb2FkIGlubGluZWQgdGVtcGxhdGU8L2E+CiAgIDxkaXYgaWQ9InRwbC1jb250ZW50IiBuZy1pbmNsdWRlIHNyYz0iY3VycmVudFRwbCI+PC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZSBkZWZpbmVkIGluc2lkZSBzY3JpcHQgdGFnJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZWxlbWVudChieS5jc3MoJyN0cGwtbGluaycpKS5jbGljaygpOwogICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnI3RwbC1jb250ZW50JykpLmdldFRleHQoKSkudG9NYXRjaCgvQ29udGVudCBvZiB0aGUgdGVtcGxhdGUvKTsKICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIHZhciBzY3JpcHREaXJlY3RpdmUgPSBbJyR0ZW1wbGF0ZUNhY2hlJywgZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgaWYgKGF0dHIudHlwZSA9PSAndGV4dC9uZy10ZW1wbGF0ZScpIHsKICAgICAgICAgIHZhciB0ZW1wbGF0ZVVybCA9IGF0dHIuaWQsCiAgICAgICAgICAvLyBJRSBpcyBub3QgY29uc2lzdGVudCwgaW4gc2NyaXB0cyB3ZSBoYXZlIHRvIHJlYWQgLnRleHQgYnV0IGluIG90aGVyIG5vZGVzIHdlIGhhdmUgdG8gcmVhZCAudGV4dENvbnRlbnQKICAgICAgICAgICAgdGV4dCA9IGVsZW1lbnRbMF0udGV4dDsKCiAgICAgICAgICAkdGVtcGxhdGVDYWNoZS5wdXQodGVtcGxhdGVVcmwsIHRleHQpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XTsKCiAgdmFyIG5nT3B0aW9uc01pbkVyciA9IG1pbkVycignbmdPcHRpb25zJyk7CiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIHNlbGVjdAogICAqIEByZXN0cmljdCBFCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBIVE1MIGBTRUxFQ1RgIGVsZW1lbnQgd2l0aCBhbmd1bGFyIGRhdGEtYmluZGluZy4KICAgKgogICAqICMgYG5nT3B0aW9uc2AKICAgKgogICAqIFRoZSBgbmdPcHRpb25zYCBhdHRyaWJ1dGUgY2FuIGJlIHVzZWQgdG8gZHluYW1pY2FsbHkgZ2VuZXJhdGUgYSBsaXN0IG9mIGA8b3B0aW9uPmAKICAgKiBlbGVtZW50cyBmb3IgdGhlIGA8c2VsZWN0PmAgZWxlbWVudCB1c2luZyB0aGUgYXJyYXkgb3Igb2JqZWN0IG9idGFpbmVkIGJ5IGV2YWx1YXRpbmcgdGhlCiAgICogYG5nT3B0aW9uc2AgY29tcHJlaGVuc2lvbl9leHByZXNzaW9uLgogICAqCiAgICogV2hlbiBhbiBpdGVtIGluIHRoZSBgPHNlbGVjdD5gIG1lbnUgaXMgc2VsZWN0ZWQsIHRoZSBhcnJheSBlbGVtZW50IG9yIG9iamVjdCBwcm9wZXJ0eQogICAqIHJlcHJlc2VudGVkIGJ5IHRoZSBzZWxlY3RlZCBvcHRpb24gd2lsbCBiZSBib3VuZCB0byB0aGUgbW9kZWwgaWRlbnRpZmllZCBieSB0aGUgYG5nTW9kZWxgCiAgICogZGlyZWN0aXZlLgogICAqCiAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAgICogKipOb3RlOioqIGBuZ01vZGVsYCBjb21wYXJlcyBieSByZWZlcmVuY2UsIG5vdCB2YWx1ZS4gVGhpcyBpcyBpbXBvcnRhbnQgd2hlbiBiaW5kaW5nIHRvIGFuCiAgICogYXJyYXkgb2Ygb2JqZWN0cy4gU2VlIGFuIGV4YW1wbGUgW2luIHRoaXMganNmaWRkbGVdKGh0dHA6Ly9qc2ZpZGRsZS5uZXQvcVd6VGIvKS4KICAgKiA8L2Rpdj4KICAgKgogICAqIE9wdGlvbmFsbHksIGEgc2luZ2xlIGhhcmQtY29kZWQgYDxvcHRpb24+YCBlbGVtZW50LCB3aXRoIHRoZSB2YWx1ZSBzZXQgdG8gYW4gZW1wdHkgc3RyaW5nLCBjYW4KICAgKiBiZSBuZXN0ZWQgaW50byB0aGUgYDxzZWxlY3Q+YCBlbGVtZW50LiBUaGlzIGVsZW1lbnQgd2lsbCB0aGVuIHJlcHJlc2VudCB0aGUgYG51bGxgIG9yICJub3Qgc2VsZWN0ZWQiCiAgICogb3B0aW9uLiBTZWUgZXhhbXBsZSBiZWxvdyBmb3IgZGVtb25zdHJhdGlvbi4KICAgKgogICAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogICAqICoqTm90ZToqKiBgbmdPcHRpb25zYCBwcm92aWRlcyBhbiBpdGVyYXRvciBmYWNpbGl0eSBmb3IgdGhlIGA8b3B0aW9uPmAgZWxlbWVudCB3aGljaCBzaG91bGQgYmUgdXNlZCBpbnN0ZWFkCiAgICogb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gd2hlbiB5b3Ugd2FudCB0aGUKICAgKiBgc2VsZWN0YCBtb2RlbCB0byBiZSBib3VuZCB0byBhIG5vbi1zdHJpbmcgdmFsdWUuIFRoaXMgaXMgYmVjYXVzZSBhbiBvcHRpb24gZWxlbWVudCBjYW4gb25seQogICAqIGJlIGJvdW5kIHRvIHN0cmluZyB2YWx1ZXMgYXQgcHJlc2VudC4KICAgKiA8L2Rpdj4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBUaGUgY29udHJvbCBpcyBjb25zaWRlcmVkIHZhbGlkIG9ubHkgaWYgdmFsdWUgaXMgZW50ZXJlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAqIEBwYXJhbSB7Y29tcHJlaGVuc2lvbl9leHByZXNzaW9uPX0gbmdPcHRpb25zIGluIG9uZSBvZiB0aGUgZm9sbG93aW5nIGZvcm1zOgogICAqCiAgICogICAqIGZvciBhcnJheSBkYXRhIHNvdXJjZXM6CiAgICogICAgICogYGxhYmVsYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICogICAgICogYGxhYmVsYCAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3JgKiogYHZhbHVlYCAqKmBpbmAqKiBgYXJyYXlgCiAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAgKipgdHJhY2sgYnlgKiogYHRyYWNrZXhwcmAKICAgKiAgICogZm9yIG9iamVjdCBkYXRhIHNvdXJjZXM6CiAgICogICAgICogYGxhYmVsYCAqKmBmb3IgKGAqKmBrZXlgICoqYCxgKiogYHZhbHVlYCoqYCkgaW5gKiogYG9iamVjdGAKICAgKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGZvciAoYCoqYGtleWAgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAqICAgICAqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYCAqKmBmb3IgKGAqKmBrZXlgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZ3JvdXAgYnlgKiogYGdyb3VwYAogICAqICAgICAgICAgKipgZm9yYCBgKGAqKmBrZXlgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAqCiAgICogV2hlcmU6CiAgICoKICAgKiAgICogYGFycmF5YCAvIGBvYmplY3RgOiBhbiBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbiBhcnJheSAvIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICogICAqIGB2YWx1ZWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gZWFjaCBpdGVtIGluIHRoZSBgYXJyYXlgIG9yIGVhY2ggcHJvcGVydHkgdmFsdWUKICAgKiAgICAgIG9mIGBvYmplY3RgIGR1cmluZyBpdGVyYXRpb24uCiAgICogICAqIGBrZXlgOiBsb2NhbCB2YXJpYWJsZSB3aGljaCB3aWxsIHJlZmVyIHRvIGEgcHJvcGVydHkgbmFtZSBpbiBgb2JqZWN0YCBkdXJpbmcgaXRlcmF0aW9uLgogICAqICAgKiBgbGFiZWxgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIHRoZSBsYWJlbCBmb3IgYDxvcHRpb24+YCBlbGVtZW50LiBUaGUKICAgKiAgICAgYGV4cHJlc3Npb25gIHdpbGwgbW9zdCBsaWtlbHkgcmVmZXIgdG8gdGhlIGB2YWx1ZWAgdmFyaWFibGUgKGUuZy4gYHZhbHVlLnByb3BlcnR5TmFtZWApLgogICAqICAgKiBgc2VsZWN0YDogVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZSBib3VuZCB0byB0aGUgbW9kZWwgb2YgdGhlIHBhcmVudCBgPHNlbGVjdD5gCiAgICogICAgICBlbGVtZW50LiBJZiBub3Qgc3BlY2lmaWVkLCBgc2VsZWN0YCBleHByZXNzaW9uIHdpbGwgZGVmYXVsdCB0byBgdmFsdWVgLgogICAqICAgKiBgZ3JvdXBgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIHVzZWQgdG8gZ3JvdXAgb3B0aW9ucyB1c2luZyB0aGUgYDxvcHRncm91cD5gCiAgICogICAgICBET00gZWxlbWVudC4KICAgKiAgICogYHRyYWNrZXhwcmA6IFVzZWQgd2hlbiB3b3JraW5nIHdpdGggYW4gYXJyYXkgb2Ygb2JqZWN0cy4gVGhlIHJlc3VsdCBvZiB0aGlzIGV4cHJlc3Npb24gd2lsbCBiZQogICAqICAgICAgdXNlZCB0byBpZGVudGlmeSB0aGUgb2JqZWN0cyBpbiB0aGUgYXJyYXkuIFRoZSBgdHJhY2tleHByYCB3aWxsIG1vc3QgbGlrZWx5IHJlZmVyIHRvIHRoZQogICAqICAgICBgdmFsdWVgIHZhcmlhYmxlIChlLmcuIGB2YWx1ZS5wcm9wZXJ0eU5hbWVgKS4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gTXlDbnRybCgkc2NvcGUpIHsKICAgICAgICAgICRzY29wZS5jb2xvcnMgPSBbCiAgICAgICAgICAgIHtuYW1lOidibGFjaycsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgIHtuYW1lOid3aGl0ZScsIHNoYWRlOidsaWdodCd9LAogICAgICAgICAgICB7bmFtZToncmVkJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAge25hbWU6J2JsdWUnLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICB7bmFtZToneWVsbG93Jywgc2hhZGU6J2xpZ2h0J30KICAgICAgICAgIF07CiAgICAgICAgICAkc2NvcGUubXlDb2xvciA9ICRzY29wZS5jb2xvcnNbMl07IC8vIHJlZAogICAgICAgIH0KICAgPC9zY3JpcHQ+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iTXlDbnRybCI+CiAgIDx1bD4KICAgPGxpIG5nLXJlcGVhdD0iY29sb3IgaW4gY29sb3JzIj4KICAgTmFtZTogPGlucHV0IG5nLW1vZGVsPSJjb2xvci5uYW1lIj4KICAgWzxhIGhyZWYgbmctY2xpY2s9ImNvbG9ycy5zcGxpY2UoJGluZGV4LCAxKSI+WDwvYT5dCiAgIDwvbGk+CiAgIDxsaT4KICAgWzxhIGhyZWYgbmctY2xpY2s9ImNvbG9ycy5wdXNoKHt9KSI+YWRkPC9hPl0KICAgPC9saT4KICAgPC91bD4KICAgPGhyLz4KICAgQ29sb3IgKG51bGwgbm90IGFsbG93ZWQpOgogICA8c2VsZWN0IG5nLW1vZGVsPSJteUNvbG9yIiBuZy1vcHRpb25zPSJjb2xvci5uYW1lIGZvciBjb2xvciBpbiBjb2xvcnMiPjwvc2VsZWN0Pjxicj4KCiAgIENvbG9yIChudWxsIGFsbG93ZWQpOgogICA8c3BhbiAgY2xhc3M9Im51bGxhYmxlIj4KICAgPHNlbGVjdCBuZy1tb2RlbD0ibXlDb2xvciIgbmctb3B0aW9ucz0iY29sb3IubmFtZSBmb3IgY29sb3IgaW4gY29sb3JzIj4KICAgPG9wdGlvbiB2YWx1ZT0iIj4tLSBjaG9vc2UgY29sb3IgLS08L29wdGlvbj4KICAgPC9zZWxlY3Q+CiAgIDwvc3Bhbj48YnIvPgoKICAgQ29sb3IgZ3JvdXBlZCBieSBzaGFkZToKICAgPHNlbGVjdCBuZy1tb2RlbD0ibXlDb2xvciIgbmctb3B0aW9ucz0iY29sb3IubmFtZSBncm91cCBieSBjb2xvci5zaGFkZSBmb3IgY29sb3IgaW4gY29sb3JzIj4KICAgPC9zZWxlY3Q+PGJyLz4KCgogICBTZWxlY3QgPGEgaHJlZiBuZy1jbGljaz0ibXlDb2xvciA9IHsgbmFtZTonbm90IGluIGxpc3QnLCBzaGFkZTogJ290aGVyJyB9Ij5ib2d1czwvYT4uPGJyPgogICA8aHIvPgogICBDdXJyZW50bHkgc2VsZWN0ZWQ6IHt7IHtzZWxlY3RlZF9jb2xvcjpteUNvbG9yfSAgfX0KICAgPGRpdiBzdHlsZT0iYm9yZGVyOnNvbGlkIDFweCBibGFjazsgaGVpZ2h0OjIwcHgiCiAgIG5nLXN0eWxlPSJ7J2JhY2tncm91bmQtY29sb3InOm15Q29sb3IubmFtZX0iPgogICA8L2Rpdj4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgY2hlY2sgbmctb3B0aW9ucycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpteUNvbG9yfScpKS5nZXRUZXh0KCkpLnRvTWF0Y2goJ3JlZCcpOwogICAgICAgICAgIGVsZW1lbnQuYWxsKGJ5LnNlbGVjdCgnbXlDb2xvcicpKS5maXJzdCgpLmNsaWNrKCk7CiAgICAgICAgICAgZWxlbWVudC5hbGwoYnkuY3NzKCdzZWxlY3RbbmctbW9kZWw9Im15Q29sb3IiXSBvcHRpb24nKSkuZmlyc3QoKS5jbGljaygpOwogICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3tzZWxlY3RlZF9jb2xvcjpteUNvbG9yfScpKS5nZXRUZXh0KCkpLnRvTWF0Y2goJ2JsYWNrJyk7CiAgICAgICAgICAgZWxlbWVudChieS5jc3MoJy5udWxsYWJsZSBzZWxlY3RbbmctbW9kZWw9Im15Q29sb3IiXScpKS5jbGljaygpOwogICAgICAgICAgIGVsZW1lbnQuYWxsKGJ5LmNzcygnLm51bGxhYmxlIHNlbGVjdFtuZy1tb2RlbD0ibXlDb2xvciJdIG9wdGlvbicpKS5maXJzdCgpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygne3NlbGVjdGVkX2NvbG9yOm15Q29sb3J9JykpLmdldFRleHQoKSkudG9NYXRjaCgnbnVsbCcpOwogICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgogIHZhciBuZ09wdGlvbnNEaXJlY3RpdmUgPSB2YWx1ZUZuKHsgdGVybWluYWw6IHRydWUgfSk7Ci8vIGpzaGludCBtYXhsZW46IGZhbHNlCiAgdmFyIHNlbGVjdERpcmVjdGl2ZSA9IFsnJGNvbXBpbGUnLCAnJHBhcnNlJywgZnVuY3Rpb24oJGNvbXBpbGUsICAgJHBhcnNlKSB7CiAgICAvLzAwMDAxMTExMTExMTExMDAwMDAwMDAwMDAyMjIyMjIyMjIyMDAwMDAwMDAwMDAwMDAwMDAwMDAwMzMzMzMzMzMzMzAwMDAwMDAwMDAwMDAwNDQ0NDQ0NDQ0NDQ0NDQ0MDAwMDAwMDAwNTU1NTU1NTU1NTU1NTU1MDAwMDAwMDY2NjY2NjY2NjY2NjY2NjAwMDAwMDAwMDAwMDAwMDc3Nzc3Nzc3NzcwMDAwMDAwMDAwMDAwMDAwMDAwODg4ODg4ODg4OAogICAgdmFyIE5HX09QVElPTlNfUkVHRVhQID0gL15ccyooW1xzXFNdKz8pKD86XHMrYXNccysoW1xzXFNdKz8pKT8oPzpccytncm91cFxzK2J5XHMrKFtcc1xTXSs/KSk/XHMrZm9yXHMrKD86KFtcJFx3XVtcJFx3XSopfCg/OlwoXHMqKFtcJFx3XVtcJFx3XSopXHMqLFxzKihbXCRcd11bXCRcd10qKVxzKlwpKSlccytpblxzKyhbXHNcU10rPykoPzpccyt0cmFja1xzK2J5XHMrKFtcc1xTXSs/KSk/JC8sCiAgICAgIG51bGxNb2RlbEN0cmwgPSB7JHNldFZpZXdWYWx1ZTogbm9vcH07Ci8vIGpzaGludCBtYXhsZW46IDEwMAoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgIHJlcXVpcmU6IFsnc2VsZWN0JywgJz9uZ01vZGVsJ10sCiAgICAgIGNvbnRyb2xsZXI6IFsnJGVsZW1lbnQnLCAnJHNjb3BlJywgJyRhdHRycycsIGZ1bmN0aW9uKCRlbGVtZW50LCAkc2NvcGUsICRhdHRycykgewogICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgIG9wdGlvbnNNYXAgPSB7fSwKICAgICAgICAgIG5nTW9kZWxDdHJsID0gbnVsbE1vZGVsQ3RybCwKICAgICAgICAgIG51bGxPcHRpb24sCiAgICAgICAgICB1bmtub3duT3B0aW9uOwoKCiAgICAgICAgc2VsZi5kYXRhYm91bmQgPSAkYXR0cnMubmdNb2RlbDsKCgogICAgICAgIHNlbGYuaW5pdCA9IGZ1bmN0aW9uKG5nTW9kZWxDdHJsXywgbnVsbE9wdGlvbl8sIHVua25vd25PcHRpb25fKSB7CiAgICAgICAgICBuZ01vZGVsQ3RybCA9IG5nTW9kZWxDdHJsXzsKICAgICAgICAgIG51bGxPcHRpb24gPSBudWxsT3B0aW9uXzsKICAgICAgICAgIHVua25vd25PcHRpb24gPSB1bmtub3duT3B0aW9uXzsKICAgICAgICB9OwoKCiAgICAgICAgc2VsZi5hZGRPcHRpb24gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkodmFsdWUsICcib3B0aW9uIHZhbHVlIicpOwogICAgICAgICAgb3B0aW9uc01hcFt2YWx1ZV0gPSB0cnVlOwoKICAgICAgICAgIGlmIChuZ01vZGVsQ3RybC4kdmlld1ZhbHVlID09IHZhbHVlKSB7CiAgICAgICAgICAgICRlbGVtZW50LnZhbCh2YWx1ZSk7CiAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgfQogICAgICAgIH07CgoKICAgICAgICBzZWxmLnJlbW92ZU9wdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAodGhpcy5oYXNPcHRpb24odmFsdWUpKSB7CiAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zTWFwW3ZhbHVlXTsKICAgICAgICAgICAgaWYgKG5nTW9kZWxDdHJsLiR2aWV3VmFsdWUgPT0gdmFsdWUpIHsKICAgICAgICAgICAgICB0aGlzLnJlbmRlclVua25vd25PcHRpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKCgogICAgICAgIHNlbGYucmVuZGVyVW5rbm93bk9wdGlvbiA9IGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgdmFyIHVua25vd25WYWwgPSAnPyAnICsgaGFzaEtleSh2YWwpICsgJyA/JzsKICAgICAgICAgIHVua25vd25PcHRpb24udmFsKHVua25vd25WYWwpOwogICAgICAgICAgJGVsZW1lbnQucHJlcGVuZCh1bmtub3duT3B0aW9uKTsKICAgICAgICAgICRlbGVtZW50LnZhbCh1bmtub3duVmFsKTsKICAgICAgICAgIHVua25vd25PcHRpb24ucHJvcCgnc2VsZWN0ZWQnLCB0cnVlKTsgLy8gbmVlZGVkIGZvciBJRQogICAgICAgIH07CgoKICAgICAgICBzZWxmLmhhc09wdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gb3B0aW9uc01hcC5oYXNPd25Qcm9wZXJ0eSh2YWx1ZSk7CiAgICAgICAgfTsKCiAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIGRpc2FibGUgdW5rbm93biBvcHRpb24gc28gdGhhdCB3ZSBkb24ndCBkbyB3b3JrIHdoZW4gdGhlIHdob2xlIHNlbGVjdCBpcyBiZWluZyBkZXN0cm95ZWQKICAgICAgICAgIHNlbGYucmVuZGVyVW5rbm93bk9wdGlvbiA9IG5vb3A7CiAgICAgICAgfSk7CiAgICAgIH1dLAoKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmxzKSB7CiAgICAgICAgLy8gaWYgbmdNb2RlbCBpcyBub3QgZGVmaW5lZCwgd2UgZG9uJ3QgbmVlZCB0byBkbyBhbnl0aGluZwogICAgICAgIGlmICghY3RybHNbMV0pIHJldHVybjsKCiAgICAgICAgdmFyIHNlbGVjdEN0cmwgPSBjdHJsc1swXSwKICAgICAgICAgIG5nTW9kZWxDdHJsID0gY3RybHNbMV0sCiAgICAgICAgICBtdWx0aXBsZSA9IGF0dHIubXVsdGlwbGUsCiAgICAgICAgICBvcHRpb25zRXhwID0gYXR0ci5uZ09wdGlvbnMsCiAgICAgICAgICBudWxsT3B0aW9uID0gZmFsc2UsIC8vIGlmIGZhbHNlLCB1c2VyIHdpbGwgbm90IGJlIGFibGUgdG8gc2VsZWN0IGl0ICh1c2VkIGJ5IG5nT3B0aW9ucykKICAgICAgICAgIGVtcHR5T3B0aW9uLAogICAgICAgIC8vIHdlIGNhbid0IGp1c3QganFMaXRlKCc8b3B0aW9uPicpIHNpbmNlIGpxTGl0ZSBpcyBub3Qgc21hcnQgZW5vdWdoCiAgICAgICAgLy8gdG8gY3JlYXRlIGl0IGluIDxzZWxlY3Q+IGFuZCBJRSBiYXJmcyBvdGhlcndpc2UuCiAgICAgICAgICBvcHRpb25UZW1wbGF0ZSA9IGpxTGl0ZShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKSksCiAgICAgICAgICBvcHRHcm91cFRlbXBsYXRlID1qcUxpdGUoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0Z3JvdXAnKSksCiAgICAgICAgICB1bmtub3duT3B0aW9uID0gb3B0aW9uVGVtcGxhdGUuY2xvbmUoKTsKCiAgICAgICAgLy8gZmluZCAibnVsbCIgb3B0aW9uCiAgICAgICAgZm9yKHZhciBpID0gMCwgY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkcmVuKCksIGlpID0gY2hpbGRyZW4ubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgaWYgKGNoaWxkcmVuW2ldLnZhbHVlID09PSAnJykgewogICAgICAgICAgICBlbXB0eU9wdGlvbiA9IG51bGxPcHRpb24gPSBjaGlsZHJlbi5lcShpKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZWxlY3RDdHJsLmluaXQobmdNb2RlbEN0cmwsIG51bGxPcHRpb24sIHVua25vd25PcHRpb24pOwoKICAgICAgICAvLyByZXF1aXJlZCB2YWxpZGF0b3IKICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgIG5nTW9kZWxDdHJsLiRpc0VtcHR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuICF2YWx1ZSB8fCB2YWx1ZS5sZW5ndGggPT09IDA7CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKG9wdGlvbnNFeHApIHNldHVwQXNPcHRpb25zKHNjb3BlLCBlbGVtZW50LCBuZ01vZGVsQ3RybCk7CiAgICAgICAgZWxzZSBpZiAobXVsdGlwbGUpIHNldHVwQXNNdWx0aXBsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwpOwogICAgICAgIGVsc2Ugc2V0dXBBc1NpbmdsZShzY29wZSwgZWxlbWVudCwgbmdNb2RlbEN0cmwsIHNlbGVjdEN0cmwpOwoKCiAgICAgICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKCgogICAgICAgIGZ1bmN0aW9uIHNldHVwQXNTaW5nbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIG5nTW9kZWxDdHJsLCBzZWxlY3RDdHJsKSB7CiAgICAgICAgICBuZ01vZGVsQ3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB2aWV3VmFsdWUgPSBuZ01vZGVsQ3RybC4kdmlld1ZhbHVlOwoKICAgICAgICAgICAgaWYgKHNlbGVjdEN0cmwuaGFzT3B0aW9uKHZpZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICBpZiAodW5rbm93bk9wdGlvbi5wYXJlbnQoKSkgdW5rbm93bk9wdGlvbi5yZW1vdmUoKTsKICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnZhbCh2aWV3VmFsdWUpOwogICAgICAgICAgICAgIGlmICh2aWV3VmFsdWUgPT09ICcnKSBlbXB0eU9wdGlvbi5wcm9wKCdzZWxlY3RlZCcsIHRydWUpOyAvLyB0byBtYWtlIElFOSBoYXBweQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2aWV3VmFsdWUpICYmIGVtcHR5T3B0aW9uKSB7CiAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LnZhbCgnJyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNlbGVjdEN0cmwucmVuZGVyVW5rbm93bk9wdGlvbih2aWV3VmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICBzZWxlY3RFbGVtZW50Lm9uKCdjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRzZXRWaWV3VmFsdWUoc2VsZWN0RWxlbWVudC52YWwoKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzZXR1cEFzTXVsdGlwbGUoc2NvcGUsIHNlbGVjdEVsZW1lbnQsIGN0cmwpIHsKICAgICAgICAgIHZhciBsYXN0VmlldzsKICAgICAgICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgaXRlbXMgPSBuZXcgSGFzaE1hcChjdHJsLiR2aWV3VmFsdWUpOwogICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IGlzRGVmaW5lZChpdGVtcy5nZXQob3B0aW9uLnZhbHVlKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKCiAgICAgICAgICAvLyB3ZSBoYXZlIHRvIGRvIGl0IG9uIGVhY2ggd2F0Y2ggc2luY2UgbmdNb2RlbCB3YXRjaGVzIHJlZmVyZW5jZSwgYnV0CiAgICAgICAgICAvLyB3ZSBuZWVkIHRvIHdvcmsgb2YgYW4gYXJyYXksIHNvIHdlIG5lZWQgdG8gc2VlIGlmIGFueXRoaW5nIHdhcyBpbnNlcnRlZC9yZW1vdmVkCiAgICAgICAgICBzY29wZS4kd2F0Y2goZnVuY3Rpb24gc2VsZWN0TXVsdGlwbGVXYXRjaCgpIHsKICAgICAgICAgICAgaWYgKCFlcXVhbHMobGFzdFZpZXcsIGN0cmwuJHZpZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICBsYXN0VmlldyA9IHNoYWxsb3dDb3B5KGN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgY3RybC4kcmVuZGVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHNlbGVjdEVsZW1lbnQub24oJ2NoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgICAgICAgICAgZm9yRWFjaChzZWxlY3RFbGVtZW50LmZpbmQoJ29wdGlvbicpLCBmdW5jdGlvbihvcHRpb24pIHsKICAgICAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgYXJyYXkucHVzaChvcHRpb24udmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShhcnJheSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzZXR1cEFzT3B0aW9ucyhzY29wZSwgc2VsZWN0RWxlbWVudCwgY3RybCkgewogICAgICAgICAgdmFyIG1hdGNoOwoKICAgICAgICAgIGlmICghKG1hdGNoID0gb3B0aW9uc0V4cC5tYXRjaChOR19PUFRJT05TX1JFR0VYUCkpKSB7CiAgICAgICAgICAgIHRocm93IG5nT3B0aW9uc01pbkVycignaWV4cCcsCiAgICAgICAgICAgICAgICAiRXhwZWN0ZWQgZXhwcmVzc2lvbiBpbiBmb3JtIG9mICIgKwogICAgICAgICAgICAgICAgIidfc2VsZWN0XyAoYXMgX2xhYmVsXyk/IGZvciAoX2tleV8sKT9fdmFsdWVfIGluIF9jb2xsZWN0aW9uXyciICsKICAgICAgICAgICAgICAgICIgYnV0IGdvdCAnezB9Jy4gRWxlbWVudDogezF9IiwKICAgICAgICAgICAgICBvcHRpb25zRXhwLCBzdGFydGluZ1RhZyhzZWxlY3RFbGVtZW50KSk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGRpc3BsYXlGbiA9ICRwYXJzZShtYXRjaFsyXSB8fCBtYXRjaFsxXSksCiAgICAgICAgICAgIHZhbHVlTmFtZSA9IG1hdGNoWzRdIHx8IG1hdGNoWzZdLAogICAgICAgICAgICBrZXlOYW1lID0gbWF0Y2hbNV0sCiAgICAgICAgICAgIGdyb3VwQnlGbiA9ICRwYXJzZShtYXRjaFszXSB8fCAnJyksCiAgICAgICAgICAgIHZhbHVlRm4gPSAkcGFyc2UobWF0Y2hbMl0gPyBtYXRjaFsxXSA6IHZhbHVlTmFtZSksCiAgICAgICAgICAgIHZhbHVlc0ZuID0gJHBhcnNlKG1hdGNoWzddKSwKICAgICAgICAgICAgdHJhY2sgPSBtYXRjaFs4XSwKICAgICAgICAgICAgdHJhY2tGbiA9IHRyYWNrID8gJHBhcnNlKG1hdGNoWzhdKSA6IG51bGwsCiAgICAgICAgICAvLyBUaGlzIGlzIGFuIGFycmF5IG9mIGFycmF5IG9mIGV4aXN0aW5nIG9wdGlvbiBncm91cHMgaW4gRE9NLgogICAgICAgICAgLy8gV2UgdHJ5IHRvIHJldXNlIHRoZXNlIGlmIHBvc3NpYmxlCiAgICAgICAgICAvLyAtIG9wdGlvbkdyb3Vwc0NhY2hlWzBdIGlzIHRoZSBvcHRpb25zIHdpdGggbm8gb3B0aW9uIGdyb3VwCiAgICAgICAgICAvLyAtIG9wdGlvbkdyb3Vwc0NhY2hlWz9dWzBdIGlzIHRoZSBwYXJlbnQ6IGVpdGhlciB0aGUgU0VMRUNUIG9yIE9QVEdST1VQIGVsZW1lbnQKICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUgPSBbW3tlbGVtZW50OiBzZWxlY3RFbGVtZW50LCBsYWJlbDonJ31dXTsKCiAgICAgICAgICBpZiAobnVsbE9wdGlvbikgewogICAgICAgICAgICAvLyBjb21waWxlIHRoZSBlbGVtZW50IHNpbmNlIHRoZXJlIG1pZ2h0IGJlIGJpbmRpbmdzIGluIGl0CiAgICAgICAgICAgICRjb21waWxlKG51bGxPcHRpb24pKHNjb3BlKTsKCiAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgY2xhc3MsIHdoaWNoIGlzIGFkZGVkIGF1dG9tYXRpY2FsbHkgYmVjYXVzZSB3ZSByZWNvbXBpbGUgdGhlIGVsZW1lbnQgYW5kIGl0CiAgICAgICAgICAgIC8vIGJlY29tZXMgdGhlIGNvbXBpbGF0aW9uIHJvb3QKICAgICAgICAgICAgbnVsbE9wdGlvbi5yZW1vdmVDbGFzcygnbmctc2NvcGUnKTsKCiAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gcmVtb3ZlIGl0IGJlZm9yZSBjYWxsaW5nIHNlbGVjdEVsZW1lbnQuZW1wdHkoKSBiZWNhdXNlIG90aGVyd2lzZSBJRSB3aWxsCiAgICAgICAgICAgIC8vIHJlbW92ZSB0aGUgbGFiZWwgZnJvbSB0aGUgZWxlbWVudC4gd3RmPwogICAgICAgICAgICBudWxsT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGNsZWFyIGNvbnRlbnRzLCB3ZSdsbCBhZGQgd2hhdCdzIG5lZWRlZCBiYXNlZCBvbiB0aGUgbW9kZWwKICAgICAgICAgIHNlbGVjdEVsZW1lbnQuZW1wdHkoKTsKCiAgICAgICAgICBzZWxlY3RFbGVtZW50Lm9uKCdjaGFuZ2UnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBvcHRpb25Hcm91cCwKICAgICAgICAgICAgICAgIGNvbGxlY3Rpb24gPSB2YWx1ZXNGbihzY29wZSkgfHwgW10sCiAgICAgICAgICAgICAgICBsb2NhbHMgPSB7fSwKICAgICAgICAgICAgICAgIGtleSwgdmFsdWUsIG9wdGlvbkVsZW1lbnQsIGluZGV4LCBncm91cEluZGV4LCBsZW5ndGgsIGdyb3VwTGVuZ3RoLCB0cmFja0luZGV4OwoKICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGdyb3VwSW5kZXggPSAwLCBncm91cExlbmd0aCA9IG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCA8IGdyb3VwTGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgLy8gbGlzdCBvZiBvcHRpb25zIGZvciB0aGF0IGdyb3VwLiAoZmlyc3QgaXRlbSBoYXMgdGhlIHBhcmVudCkKICAgICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNDYWNoZVtncm91cEluZGV4XTsKCiAgICAgICAgICAgICAgICAgIGZvcihpbmRleCA9IDEsIGxlbmd0aCA9IG9wdGlvbkdyb3VwLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKG9wdGlvbkVsZW1lbnQgPSBvcHRpb25Hcm91cFtpbmRleF0uZWxlbWVudClbMF0uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIGtleSA9IG9wdGlvbkVsZW1lbnQudmFsKCk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoa2V5TmFtZSkgbG9jYWxzW2tleU5hbWVdID0ga2V5OwogICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh0cmFja0luZGV4ID0gMDsgdHJhY2tJbmRleCA8IGNvbGxlY3Rpb24ubGVuZ3RoOyB0cmFja0luZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25bdHJhY2tJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4oc2NvcGUsIGxvY2FscykgPT0ga2V5KSBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKHZhbHVlRm4oc2NvcGUsIGxvY2FscykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBrZXkgPSBzZWxlY3RFbGVtZW50LnZhbCgpOwogICAgICAgICAgICAgICAgaWYgKGtleSA9PSAnPycpIHsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gJycpewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAodHJhY2tGbikgewogICAgICAgICAgICAgICAgICAgIGZvciAodHJhY2tJbmRleCA9IDA7IHRyYWNrSW5kZXggPCBjb2xsZWN0aW9uLmxlbmd0aDsgdHJhY2tJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25bdHJhY2tJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICBpZiAodHJhY2tGbihzY29wZSwgbG9jYWxzKSA9PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBjb2xsZWN0aW9uW2tleV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGtleU5hbWUpIGxvY2Fsc1trZXlOYW1lXSA9IGtleTsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlRm4oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgbnVsbCBvcHRpb24ncyBzZWxlY3RlZCBwcm9wZXJ0eSBoZXJlIHNvICRyZW5kZXIgY2xlYW5zIGl0IHVwIGNvcnJlY3RseQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlWzBdLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlWzBdWzFdLmlkICE9PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZVswXVsxXS5zZWxlY3RlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CgogICAgICAgICAgY3RybC4kcmVuZGVyID0gcmVuZGVyOwoKICAgICAgICAgIC8vIFRPRE8odm9qdGEpOiBjYW4ndCB3ZSBvcHRpbWl6ZSB0aGlzID8KICAgICAgICAgIHNjb3BlLiR3YXRjaChyZW5kZXIpOwoKICAgICAgICAgIGZ1bmN0aW9uIHJlbmRlcigpIHsKICAgICAgICAgICAgLy8gVGVtcG9yYXJ5IGxvY2F0aW9uIGZvciB0aGUgb3B0aW9uIGdyb3VwcyBiZWZvcmUgd2UgcmVuZGVyIHRoZW0KICAgICAgICAgICAgdmFyIG9wdGlvbkdyb3VwcyA9IHsnJzpbXX0sCiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lcyA9IFsnJ10sCiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lLAogICAgICAgICAgICAgIG9wdGlvbkdyb3VwLAogICAgICAgICAgICAgIG9wdGlvbiwKICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCwgZXhpc3RpbmdPcHRpb25zLCBleGlzdGluZ09wdGlvbiwKICAgICAgICAgICAgICBtb2RlbFZhbHVlID0gY3RybC4kbW9kZWxWYWx1ZSwKICAgICAgICAgICAgICB2YWx1ZXMgPSB2YWx1ZXNGbihzY29wZSkgfHwgW10sCiAgICAgICAgICAgICAga2V5cyA9IGtleU5hbWUgPyBzb3J0ZWRLZXlzKHZhbHVlcykgOiB2YWx1ZXMsCiAgICAgICAgICAgICAga2V5LAogICAgICAgICAgICAgIGdyb3VwTGVuZ3RoLCBsZW5ndGgsCiAgICAgICAgICAgICAgZ3JvdXBJbmRleCwgaW5kZXgsCiAgICAgICAgICAgICAgbG9jYWxzID0ge30sCiAgICAgICAgICAgICAgc2VsZWN0ZWQsCiAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQgPSBmYWxzZSwgLy8gbm90aGluZyBpcyBzZWxlY3RlZCB5ZXQKICAgICAgICAgICAgICBsYXN0RWxlbWVudCwKICAgICAgICAgICAgICBlbGVtZW50LAogICAgICAgICAgICAgIGxhYmVsOwoKICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgICAgaWYgKHRyYWNrRm4gJiYgaXNBcnJheShtb2RlbFZhbHVlKSkgewogICAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQgPSBuZXcgSGFzaE1hcChbXSk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciB0cmFja0luZGV4ID0gMDsgdHJhY2tJbmRleCA8IG1vZGVsVmFsdWUubGVuZ3RoOyB0cmFja0luZGV4KyspIHsKICAgICAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSBtb2RlbFZhbHVlW3RyYWNrSW5kZXhdOwogICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldC5wdXQodHJhY2tGbihzY29wZSwgbG9jYWxzKSwgbW9kZWxWYWx1ZVt0cmFja0luZGV4XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gbmV3IEhhc2hNYXAobW9kZWxWYWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBXZSBub3cgYnVpbGQgdXAgdGhlIGxpc3Qgb2Ygb3B0aW9ucyB3ZSBuZWVkICh3ZSBtZXJnZSBsYXRlcikKICAgICAgICAgICAgZm9yIChpbmRleCA9IDA7IGxlbmd0aCA9IGtleXMubGVuZ3RoLCBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewoKICAgICAgICAgICAgICBrZXkgPSBpbmRleDsKICAgICAgICAgICAgICBpZiAoa2V5TmFtZSkgewogICAgICAgICAgICAgICAga2V5ID0ga2V5c1tpbmRleF07CiAgICAgICAgICAgICAgICBpZiAoIGtleS5jaGFyQXQoMCkgPT09ICckJyApIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgbG9jYWxzW2tleU5hbWVdID0ga2V5OwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgbG9jYWxzW3ZhbHVlTmFtZV0gPSB2YWx1ZXNba2V5XTsKCiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBOYW1lID0gZ3JvdXBCeUZuKHNjb3BlLCBsb2NhbHMpIHx8ICcnOwogICAgICAgICAgICAgIGlmICghKG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV0pKSB7CiAgICAgICAgICAgICAgICBvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc1tvcHRpb25Hcm91cE5hbWVdID0gW107CiAgICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWVzLnB1c2gob3B0aW9uR3JvdXBOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICBzZWxlY3RlZCA9IGlzRGVmaW5lZCgKICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQucmVtb3ZlKHRyYWNrRm4gPyB0cmFja0ZuKHNjb3BlLCBsb2NhbHMpIDogdmFsdWVGbihzY29wZSwgbG9jYWxzKSkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0cmFja0ZuKSB7CiAgICAgICAgICAgICAgICAgIHZhciBtb2RlbENhc3QgPSB7fTsKICAgICAgICAgICAgICAgICAgbW9kZWxDYXN0W3ZhbHVlTmFtZV0gPSBtb2RlbFZhbHVlOwogICAgICAgICAgICAgICAgICBzZWxlY3RlZCA9IHRyYWNrRm4oc2NvcGUsIG1vZGVsQ2FzdCkgPT09IHRyYWNrRm4oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzZWxlY3RlZCA9IG1vZGVsVmFsdWUgPT09IHZhbHVlRm4oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IHNlbGVjdGVkU2V0IHx8IHNlbGVjdGVkOyAvLyBzZWUgaWYgYXQgbGVhc3Qgb25lIGl0ZW0gaXMgc2VsZWN0ZWQKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFiZWwgPSBkaXNwbGF5Rm4oc2NvcGUsIGxvY2Fscyk7IC8vIHdoYXQgd2lsbCBiZSBzZWVuIGJ5IHRoZSB1c2VyCgogICAgICAgICAgICAgIC8vIGRvaW5nIGRpc3BsYXlGbihzY29wZSwgbG9jYWxzKSB8fCAnJyBvdmVyd3JpdGVzIHplcm8gdmFsdWVzCiAgICAgICAgICAgICAgbGFiZWwgPSBpc0RlZmluZWQobGFiZWwpID8gbGFiZWwgOiAnJzsKICAgICAgICAgICAgICBvcHRpb25Hcm91cC5wdXNoKHsKICAgICAgICAgICAgICAgIC8vIGVpdGhlciB0aGUgaW5kZXggaW50byBhcnJheSBvciBrZXkgZnJvbSBvYmplY3QKICAgICAgICAgICAgICAgIGlkOiB0cmFja0ZuID8gdHJhY2tGbihzY29wZSwgbG9jYWxzKSA6IChrZXlOYW1lID8ga2V5c1tpbmRleF0gOiBpbmRleCksCiAgICAgICAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICAgICAgICBzZWxlY3RlZDogc2VsZWN0ZWQgICAgICAgICAgICAgICAgICAgLy8gZGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBiZSBzZWxlY3RlZAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghbXVsdGlwbGUpIHsKICAgICAgICAgICAgICBpZiAobnVsbE9wdGlvbiB8fCBtb2RlbFZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAvLyBpbnNlcnQgbnVsbCBvcHRpb24gaWYgd2UgaGF2ZSBhIHBsYWNlaG9sZGVyLCBvciB0aGUgbW9kZWwgaXMgbnVsbAogICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzWycnXS51bnNoaWZ0KHtpZDonJywgbGFiZWw6JycsIHNlbGVjdGVkOiFzZWxlY3RlZFNldH0pOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNlbGVjdGVkU2V0KSB7CiAgICAgICAgICAgICAgICAvLyBvcHRpb24gY291bGQgbm90IGJlIGZvdW5kLCB3ZSBoYXZlIHRvIGluc2VydCB0aGUgdW5kZWZpbmVkIGl0ZW0KICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc1snJ10udW5zaGlmdCh7aWQ6Jz8nLCBsYWJlbDonJywgc2VsZWN0ZWQ6dHJ1ZX0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTm93IHdlIG5lZWQgdG8gdXBkYXRlIHRoZSBsaXN0IG9mIERPTSBub2RlcyB0byBtYXRjaCB0aGUgb3B0aW9uR3JvdXBzIHdlIGNvbXB1dGVkIGFib3ZlCiAgICAgICAgICAgIGZvciAoZ3JvdXBJbmRleCA9IDAsIGdyb3VwTGVuZ3RoID0gb3B0aW9uR3JvdXBOYW1lcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCA8IGdyb3VwTGVuZ3RoOwogICAgICAgICAgICAgICAgIGdyb3VwSW5kZXgrKykgewogICAgICAgICAgICAgIC8vIGN1cnJlbnQgb3B0aW9uIGdyb3VwIG5hbWUgb3IgJycgaWYgbm8gZ3JvdXAKICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBvcHRpb25Hcm91cE5hbWVzW2dyb3VwSW5kZXhdOwoKICAgICAgICAgICAgICAvLyBsaXN0IG9mIG9wdGlvbnMgZm9yIHRoYXQgZ3JvdXAuIChmaXJzdCBpdGVtIGhhcyB0aGUgcGFyZW50KQogICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV07CgogICAgICAgICAgICAgIGlmIChvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGggPD0gZ3JvdXBJbmRleCkgewogICAgICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBncm93IHRoZSBvcHRpb25Hcm91cHMKICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50ID0gewogICAgICAgICAgICAgICAgICBlbGVtZW50OiBvcHRHcm91cFRlbXBsYXRlLmNsb25lKCkuYXR0cignbGFiZWwnLCBvcHRpb25Hcm91cE5hbWUpLAogICAgICAgICAgICAgICAgICBsYWJlbDogb3B0aW9uR3JvdXAubGFiZWwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMgPSBbZXhpc3RpbmdQYXJlbnRdOwogICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUucHVzaChleGlzdGluZ09wdGlvbnMpOwogICAgICAgICAgICAgICAgc2VsZWN0RWxlbWVudC5hcHBlbmQoZXhpc3RpbmdQYXJlbnQuZWxlbWVudCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucyA9IG9wdGlvbkdyb3Vwc0NhY2hlW2dyb3VwSW5kZXhdOwogICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQgPSBleGlzdGluZ09wdGlvbnNbMF07ICAvLyBlaXRoZXIgU0VMRUNUIChubyBncm91cCkgb3IgT1BUR1JPVVAgZWxlbWVudAoKICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSB0aGUgT1BUR1JPVVAgbGFiZWwgaWYgbm90IHRoZSBzYW1lLgogICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nUGFyZW50LmxhYmVsICE9IG9wdGlvbkdyb3VwTmFtZSkgewogICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudC5lbGVtZW50LmF0dHIoJ2xhYmVsJywgZXhpc3RpbmdQYXJlbnQubGFiZWwgPSBvcHRpb25Hcm91cE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBudWxsOyAgLy8gc3RhcnQgYXQgdGhlIGJlZ2lubmluZwogICAgICAgICAgICAgIGZvcihpbmRleCA9IDAsIGxlbmd0aCA9IG9wdGlvbkdyb3VwLmxlbmd0aDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbkdyb3VwW2luZGV4XTsKICAgICAgICAgICAgICAgIGlmICgoZXhpc3RpbmdPcHRpb24gPSBleGlzdGluZ09wdGlvbnNbaW5kZXgrMV0pKSB7CiAgICAgICAgICAgICAgICAgIC8vIHJldXNlIGVsZW1lbnRzCiAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gZXhpc3RpbmdPcHRpb24uZWxlbWVudDsKICAgICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nT3B0aW9uLmxhYmVsICE9PSBvcHRpb24ubGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC50ZXh0KGV4aXN0aW5nT3B0aW9uLmxhYmVsID0gb3B0aW9uLmxhYmVsKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24uaWQgIT09IG9wdGlvbi5pZCkgewogICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnZhbChleGlzdGluZ09wdGlvbi5pZCA9IG9wdGlvbi5pZCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgLy8gbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnKSBwcm92aWRlZCBieSBqUXVlcnkgaGFzIHNpZGUtZWZmZWN0cwogICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24uc2VsZWN0ZWQgIT09IG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnByb3AoJ3NlbGVjdGVkJywgKGV4aXN0aW5nT3B0aW9uLnNlbGVjdGVkID0gb3B0aW9uLnNlbGVjdGVkKSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vIGdyb3cgZWxlbWVudHMKCiAgICAgICAgICAgICAgICAgIC8vIGlmIGl0J3MgYSBudWxsIG9wdGlvbgogICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLmlkID09PSAnJyAmJiBudWxsT3B0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gcHV0IGJhY2sgdGhlIHByZS1jb21waWxlZCBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudCA9IG51bGxPcHRpb247CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8galF1ZXJ5KHYxLjQuMikgQnVnOiBXZSBzaG91bGQgYmUgYWJsZSB0byBjaGFpbiB0aGUgbWV0aG9kIGNhbGxzLCBidXQKICAgICAgICAgICAgICAgICAgICAvLyBpbiB0aGlzIHZlcnNpb24gb2YgalF1ZXJ5IG9uIHNvbWUgYnJvd3NlciB0aGUgLnRleHQoKSByZXR1cm5zIGEgc3RyaW5nCiAgICAgICAgICAgICAgICAgICAgLy8gcmF0aGVyIHRoZW4gdGhlIGVsZW1lbnQuCiAgICAgICAgICAgICAgICAgICAgKGVsZW1lbnQgPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgLnZhbChvcHRpb24uaWQpCiAgICAgICAgICAgICAgICAgICAgICAuYXR0cignc2VsZWN0ZWQnLCBvcHRpb24uc2VsZWN0ZWQpCiAgICAgICAgICAgICAgICAgICAgICAudGV4dChvcHRpb24ubGFiZWwpOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBleGlzdGluZ09wdGlvbnMucHVzaChleGlzdGluZ09wdGlvbiA9IHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50OiBlbGVtZW50LAogICAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb24ubGFiZWwsCiAgICAgICAgICAgICAgICAgICAgaWQ6IG9wdGlvbi5pZCwKICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogb3B0aW9uLnNlbGVjdGVkCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICBpZiAobGFzdEVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudC5hZnRlcihlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudC5lbGVtZW50LmFwcGVuZChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIHJlbW92ZSBhbnkgZXhjZXNzaXZlIE9QVElPTnMgaW4gYSBncm91cAogICAgICAgICAgICAgIGluZGV4Kys7IC8vIGluY3JlbWVudCBzaW5jZSB0aGUgZXhpc3RpbmdPcHRpb25zWzBdIGlzIHBhcmVudCBlbGVtZW50IG5vdCBPUFRJT04KICAgICAgICAgICAgICB3aGlsZShleGlzdGluZ09wdGlvbnMubGVuZ3RoID4gaW5kZXgpIHsKICAgICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucy5wb3AoKS5lbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyByZW1vdmUgYW55IGV4Y2Vzc2l2ZSBPUFRHUk9VUHMgZnJvbSBzZWxlY3QKICAgICAgICAgICAgd2hpbGUob3B0aW9uR3JvdXBzQ2FjaGUubGVuZ3RoID4gZ3JvdXBJbmRleCkgewogICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlLnBvcCgpWzBdLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfV07CgogIHZhciBvcHRpb25EaXJlY3RpdmUgPSBbJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRpbnRlcnBvbGF0ZSkgewogICAgdmFyIG51bGxTZWxlY3RDdHJsID0gewogICAgICBhZGRPcHRpb246IG5vb3AsCiAgICAgIHJlbW92ZU9wdGlvbjogbm9vcAogICAgfTsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0UnLAogICAgICBwcmlvcml0eTogMTAwLAogICAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGF0dHIudmFsdWUpKSB7CiAgICAgICAgICB2YXIgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShlbGVtZW50LnRleHQoKSwgdHJ1ZSk7CiAgICAgICAgICBpZiAoIWludGVycG9sYXRlRm4pIHsKICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIGVsZW1lbnQudGV4dCgpKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIHZhciBzZWxlY3RDdHJsTmFtZSA9ICckc2VsZWN0Q29udHJvbGxlcicsCiAgICAgICAgICAgIHBhcmVudCA9IGVsZW1lbnQucGFyZW50KCksCiAgICAgICAgICAgIHNlbGVjdEN0cmwgPSBwYXJlbnQuZGF0YShzZWxlY3RDdHJsTmFtZSkgfHwKICAgICAgICAgICAgICBwYXJlbnQucGFyZW50KCkuZGF0YShzZWxlY3RDdHJsTmFtZSk7IC8vIGluIGNhc2Ugd2UgYXJlIGluIG9wdGdyb3VwCgogICAgICAgICAgaWYgKHNlbGVjdEN0cmwgJiYgc2VsZWN0Q3RybC5kYXRhYm91bmQpIHsKICAgICAgICAgICAgLy8gRm9yIHNvbWUgcmVhc29uIE9wZXJhIGRlZmF1bHRzIHRvIHRydWUgYW5kIGlmIG5vdCBvdmVycmlkZGVuIHRoaXMgbWVzc2VzIHVwIHRoZSByZXBlYXRlci4KICAgICAgICAgICAgLy8gV2UgZG9uJ3Qgd2FudCB0aGUgdmlldyB0byBkcml2ZSB0aGUgaW5pdGlhbGl6YXRpb24gb2YgdGhlIG1vZGVsIGFueXdheS4KICAgICAgICAgICAgZWxlbWVudC5wcm9wKCdzZWxlY3RlZCcsIGZhbHNlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGVjdEN0cmwgPSBudWxsU2VsZWN0Q3RybDsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goaW50ZXJwb2xhdGVGbiwgZnVuY3Rpb24gaW50ZXJwb2xhdGVXYXRjaEFjdGlvbihuZXdWYWwsIG9sZFZhbCkgewogICAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBuZXdWYWwpOwogICAgICAgICAgICAgIGlmIChuZXdWYWwgIT09IG9sZFZhbCkgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24ob2xkVmFsKTsKICAgICAgICAgICAgICBzZWxlY3RDdHJsLmFkZE9wdGlvbihuZXdWYWwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKGF0dHIudmFsdWUpOwogICAgICAgICAgfQoKICAgICAgICAgIGVsZW1lbnQub24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNlbGVjdEN0cmwucmVtb3ZlT3B0aW9uKGF0dHIudmFsdWUpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgfQogICAgfTsKICB9XTsKCiAgdmFyIHN0eWxlRGlyZWN0aXZlID0gdmFsdWVGbih7CiAgICByZXN0cmljdDogJ0UnLAogICAgdGVybWluYWw6IHRydWUKICB9KTsKCiAgaWYgKHdpbmRvdy5hbmd1bGFyLmJvb3RzdHJhcCkgewogICAgLy9Bbmd1bGFySlMgaXMgYWxyZWFkeSBsb2FkZWQsIHNvIHdlIGNhbiByZXR1cm4gaGVyZS4uLgogICAgY29uc29sZS5sb2coJ1dBUk5JTkc6IFRyaWVkIHRvIGxvYWQgYW5ndWxhciBtb3JlIHRoYW4gb25jZS4nKTsKICAgIHJldHVybjsKICB9CgogIC8vdHJ5IHRvIGJpbmQgdG8ganF1ZXJ5IG5vdyBzbyB0aGF0IG9uZSBjYW4gd3JpdGUgYW5ndWxhci5lbGVtZW50KCkucmVhZCgpCiAgLy9idXQgd2Ugd2lsbCByZWJpbmQgb24gYm9vdHN0cmFwIGFnYWluLgogIGJpbmRKUXVlcnkoKTsKCiAgcHVibGlzaEV4dGVybmFsQVBJKGFuZ3VsYXIpOwoKICBqcUxpdGUoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCkgewogICAgYW5ndWxhckluaXQoZG9jdW1lbnQsIGJvb3RzdHJhcCk7CiAgfSk7Cgp9KSh3aW5kb3csIGRvY3VtZW50KTsKCiF3aW5kb3cuYW5ndWxhci4kJGNzcCgpICYmIHdpbmRvdy5hbmd1bGFyLmVsZW1lbnQoZG9jdW1lbnQpLmZpbmQoJ2hlYWQnKS5wcmVwZW5kKCc8c3R5bGUgdHlwZT0idGV4dC9jc3MiPkBjaGFyc2V0ICJVVEYtOCI7W25nXFw6Y2xvYWtdLFtuZy1jbG9ha10sW2RhdGEtbmctY2xvYWtdLFt4LW5nLWNsb2FrXSwubmctY2xvYWssLngtbmctY2xvYWssLm5nLWhpZGV7ZGlzcGxheTpub25lICFpbXBvcnRhbnQ7fW5nXFw6Zm9ybXtkaXNwbGF5OmJsb2NrO30ubmctYW5pbWF0ZS1ibG9jay10cmFuc2l0aW9uc3t0cmFuc2l0aW9uOjBzIGFsbCFpbXBvcnRhbnQ7LXdlYmtpdC10cmFuc2l0aW9uOjBzIGFsbCFpbXBvcnRhbnQ7fS5uZy1oaWRlLWFkZC1hY3RpdmUsLm5nLWhpZGUtcmVtb3Zle2Rpc3BsYXk6YmxvY2shaW1wb3J0YW50O308L3N0eWxlPicpOwovKiEKICogaW9uaWMuYnVuZGxlLmpzIGlzIGEgY29uY2F0ZW5hdGlvbiBvZjoKICogaW9uaWMuanMsIGFuZ3VsYXIuanMsIGFuZ3VsYXItYW5pbWF0ZS5qcywKICogYW5ndWxhci1zYW5pdGl6ZS5qcywgYW5ndWxhci11aS1yb3V0ZXIuanMsCiAqIGFuZCBpb25pYy1hbmd1bGFyLmpzCiAqLwoKLyoqCiAqIEBsaWNlbnNlIEFuZ3VsYXJKUyB2MS4yLjE3CiAqIChjKSAyMDEwLTIwMTQgR29vZ2xlLCBJbmMuIGh0dHA6Ly9hbmd1bGFyanMub3JnCiAqIExpY2Vuc2U6IE1JVAogKi8KKGZ1bmN0aW9uKHdpbmRvdywgYW5ndWxhciwgdW5kZWZpbmVkKSB7J3VzZSBzdHJpY3QnOwoKICAvKiBqc2hpbnQgbWF4bGVuOiBmYWxzZSAqLwoKICAvKioKICAgKiBAbmdkb2MgbW9kdWxlCiAgICogQG5hbWUgbmdBbmltYXRlCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiAjIG5nQW5pbWF0ZQogICAqCiAgICogVGhlIGBuZ0FuaW1hdGVgIG1vZHVsZSBwcm92aWRlcyBzdXBwb3J0IGZvciBKYXZhU2NyaXB0LCBDU1MzIHRyYW5zaXRpb24gYW5kIENTUzMga2V5ZnJhbWUgYW5pbWF0aW9uIGhvb2tzIHdpdGhpbiBleGlzdGluZyBjb3JlIGFuZCBjdXN0b20gZGlyZWN0aXZlcy4KICAgKgogICAqCiAgICogPGRpdiBkb2MtbW9kdWxlLWNvbXBvbmVudHM9Im5nQW5pbWF0ZSI+PC9kaXY+CiAgICoKICAgKiAjIFVzYWdlCiAgICoKICAgKiBUbyBzZWUgYW5pbWF0aW9ucyBpbiBhY3Rpb24sIGFsbCB0aGF0IGlzIHJlcXVpcmVkIGlzIHRvIGRlZmluZSB0aGUgYXBwcm9wcmlhdGUgQ1NTIGNsYXNzZXMKICAgKiBvciB0byByZWdpc3RlciBhIEphdmFTY3JpcHQgYW5pbWF0aW9uIHZpYSB0aGUgbXlNb2R1bGUuYW5pbWF0aW9uKCkgZnVuY3Rpb24uIFRoZSBkaXJlY3RpdmVzIHRoYXQgc3VwcG9ydCBhbmltYXRpb24gYXV0b21hdGljYWxseSBhcmU6CiAgICogYG5nUmVwZWF0YCwgYG5nSW5jbHVkZWAsIGBuZ0lmYCwgYG5nU3dpdGNoYCwgYG5nU2hvd2AsIGBuZ0hpZGVgLCBgbmdWaWV3YCBhbmQgYG5nQ2xhc3NgLiBDdXN0b20gZGlyZWN0aXZlcyBjYW4gdGFrZSBhZHZhbnRhZ2Ugb2YgYW5pbWF0aW9uCiAgICogYnkgdXNpbmcgdGhlIGAkYW5pbWF0ZWAgc2VydmljZS4KICAgKgogICAqIEJlbG93IGlzIGEgbW9yZSBkZXRhaWxlZCBicmVha2Rvd24gb2YgdGhlIHN1cHBvcnRlZCBhbmltYXRpb24gZXZlbnRzIHByb3ZpZGVkIGJ5IHByZS1leGlzdGluZyBuZyBkaXJlY3RpdmVzOgogICAqCiAgICogfCBEaXJlY3RpdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBTdXBwb3J0ZWQgQW5pbWF0aW9ucyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0I3VzYWdlX2FuaW1hdGlvbnMgbmdSZXBlYXR9ICAgICAgICAgfCBlbnRlciwgbGVhdmUgYW5kIG1vdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICogfCB7QGxpbmsgbmdSb3V0ZS5kaXJlY3RpdmU6bmdWaWV3I3VzYWdlX2FuaW1hdGlvbnMgbmdWaWV3fSAgICAgICAgfCBlbnRlciBhbmQgbGVhdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSW5jbHVkZSN1c2FnZV9hbmltYXRpb25zIG5nSW5jbHVkZX0gICAgICAgfCBlbnRlciBhbmQgbGVhdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nU3dpdGNoI3VzYWdlX2FuaW1hdGlvbnMgbmdTd2l0Y2h9ICAgICAgICAgfCBlbnRlciBhbmQgbGVhdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nSWYjdXNhZ2VfYW5pbWF0aW9ucyBuZ0lmfSAgICAgICAgICAgICAgICAgfCBlbnRlciBhbmQgbGVhdmUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xhc3MjdXNhZ2VfYW5pbWF0aW9ucyBuZ0NsYXNzfSAgICAgICAgICAgfCBhZGQgYW5kIHJlbW92ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nU2hvdyN1c2FnZV9hbmltYXRpb25zIG5nU2hvdyAmIG5nSGlkZX0gICAgfCBhZGQgYW5kIHJlbW92ZSAodGhlIG5nLWhpZGUgY2xhc3MgdmFsdWUpICAgICAgICAgICB8CiAgICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0jdXNhZ2VfYW5pbWF0aW9ucyBmb3JtfSAgICAgICAgICAgICAgICAgfCBhZGQgYW5kIHJlbW92ZSAoZGlydHksIHByaXN0aW5lLCB2YWxpZCwgaW52YWxpZCAmIGFsbCBvdGhlciB2YWxpZGF0aW9ucykgICAgICAgICAgICAgICAgfAogICAqIHwge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ01vZGVsI3VzYWdlX2FuaW1hdGlvbnMgbmdNb2RlbH0gICAgICAgICAgIHwgYWRkIGFuZCByZW1vdmUgKGRpcnR5LCBwcmlzdGluZSwgdmFsaWQsIGludmFsaWQgJiBhbGwgb3RoZXIgdmFsaWRhdGlvbnMpICAgICAgICAgICAgICAgIHwKICAgKgogICAqIFlvdSBjYW4gZmluZCBvdXQgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCBhbmltYXRpb25zIHVwb24gdmlzaXRpbmcgZWFjaCBkaXJlY3RpdmUgcGFnZS4KICAgKgogICAqIEJlbG93IGlzIGFuIGV4YW1wbGUgb2YgaG93IHRvIGFwcGx5IGFuaW1hdGlvbnMgdG8gYSBkaXJlY3RpdmUgdGhhdCBzdXBwb3J0cyBhbmltYXRpb24gaG9va3M6CiAgICoKICAgKiBgYGBodG1sCiAgICogPHN0eWxlIHR5cGU9InRleHQvY3NzIj4KICAgKiAuc2xpZGUubmctZW50ZXIsIC5zbGlkZS5uZy1sZWF2ZSB7CiAqICAgLXdlYmtpdC10cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogfQogICAqCiAgICogLnNsaWRlLm5nLWVudGVyIHsgfSAgICAgICAgLyYjNDI7IHN0YXJ0aW5nIGFuaW1hdGlvbnMgZm9yIGVudGVyICYjNDI7LwogICAqIC5zbGlkZS5uZy1lbnRlci1hY3RpdmUgeyB9IC8mIzQyOyB0ZXJtaW5hbCBhbmltYXRpb25zIGZvciBlbnRlciAmIzQyOy8KICAgKiAuc2xpZGUubmctbGVhdmUgeyB9ICAgICAgICAvJiM0Mjsgc3RhcnRpbmcgYW5pbWF0aW9ucyBmb3IgbGVhdmUgJiM0MjsvCiAgICogLnNsaWRlLm5nLWxlYXZlLWFjdGl2ZSB7IH0gLyYjNDI7IHRlcm1pbmFsIGFuaW1hdGlvbnMgZm9yIGxlYXZlICYjNDI7LwogICAqIDwvc3R5bGU+CiAgICoKICAgKiA8IS0tCiAgICogdGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIGF1dG9tYXRpY2FsbHkgYWRkIC5uZy1lbnRlciBhbmQgLm5nLWxlYXZlIHRvIHRoZSBlbGVtZW50CiAgICogdG8gdHJpZ2dlciB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9ucwogICAqIC0tPgogICAqIDxBTlkgY2xhc3M9InNsaWRlIiBuZy1pbmNsdWRlPSIuLi4iPjwvQU5ZPgogICAqIGBgYAogICAqCiAgICogS2VlcCBpbiBtaW5kIHRoYXQgaWYgYW4gYW5pbWF0aW9uIGlzIHJ1bm5pbmcsIGFueSBjaGlsZCBlbGVtZW50cyBjYW5ub3QgYmUgYW5pbWF0ZWQgdW50aWwgdGhlIHBhcmVudCBlbGVtZW50J3MKICAgKiBhbmltYXRpb24gaGFzIGNvbXBsZXRlZC4KICAgKgogICAqIDxoMj5DU1MtZGVmaW5lZCBBbmltYXRpb25zPC9oMj4KICAgKiBUaGUgYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgYXV0b21hdGljYWxseSBhcHBseSB0d28gQ1NTIGNsYXNzZXMgdG8gdGhlIGFuaW1hdGVkIGVsZW1lbnQgYW5kIHRoZXNlIHR3byBDU1MgY2xhc3NlcwogICAqIGFyZSBkZXNpZ25lZCB0byBjb250YWluIHRoZSBzdGFydCBhbmQgZW5kIENTUyBzdHlsaW5nLiBCb3RoIENTUyB0cmFuc2l0aW9ucyBhbmQga2V5ZnJhbWUgYW5pbWF0aW9ucyBhcmUgc3VwcG9ydGVkCiAgICogYW5kIGNhbiBiZSB1c2VkIHRvIHBsYXkgYWxvbmcgd2l0aCB0aGlzIG5hbWluZyBzdHJ1Y3R1cmUuCiAgICoKICAgKiBUaGUgZm9sbG93aW5nIGNvZGUgYmVsb3cgZGVtb25zdHJhdGVzIGhvdyB0byBwZXJmb3JtIGFuaW1hdGlvbnMgdXNpbmcgKipDU1MgdHJhbnNpdGlvbnMqKiB3aXRoIEFuZ3VsYXI6CiAgICoKICAgKiBgYGBodG1sCiAgICogPHN0eWxlIHR5cGU9InRleHQvY3NzIj4KICAgKiAvJiM0MjsKICAgKiAgVGhlIGFuaW1hdGUgY2xhc3MgaXMgYXBhcnQgb2YgdGhlIGVsZW1lbnQgYW5kIHRoZSBuZy1lbnRlciBjbGFzcwogICAqICBpcyBhdHRhY2hlZCB0byB0aGUgZWxlbWVudCBvbmNlIHRoZSBlbnRlciBhbmltYXRpb24gZXZlbnQgaXMgdHJpZ2dlcmVkCiAgICogJiM0MjsvCiAgICogLnJldmVhbC1hbmltYXRpb24ubmctZW50ZXIgewogKiAgLXdlYmtpdC10cmFuc2l0aW9uOiAxcyBsaW5lYXIgYWxsOyAvJiM0MjsgU2FmYXJpL0Nocm9tZSAmIzQyOy8KICogIHRyYW5zaXRpb246IDFzIGxpbmVhciBhbGw7IC8mIzQyOyBBbGwgb3RoZXIgbW9kZXJuIGJyb3dzZXJzIGFuZCBJRTEwKyAmIzQyOy8KICoKICogIC8mIzQyOyBUaGUgYW5pbWF0aW9uIHByZXBhcmF0aW9uIGNvZGUgJiM0MjsvCiAqICBvcGFjaXR5OiAwOwogKiB9CiAgICoKICAgKiAvJiM0MjsKICAgKiAgS2VlcCBpbiBtaW5kIHRoYXQgeW91IHdhbnQgdG8gY29tYmluZSBib3RoIENTUwogICAqICBjbGFzc2VzIHRvZ2V0aGVyIHRvIGF2b2lkIGFueSBDU1Mtc3BlY2lmaWNpdHkKICAgKiAgY29uZmxpY3RzCiAgICogJiM0MjsvCiAgICogLnJldmVhbC1hbmltYXRpb24ubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICogIC8mIzQyOyBUaGUgYW5pbWF0aW9uIGNvZGUgaXRzZWxmICYjNDI7LwogKiAgb3BhY2l0eTogMTsKICogfQogICAqIDwvc3R5bGU+CiAgICoKICAgKiA8ZGl2IGNsYXNzPSJ2aWV3LWNvbnRhaW5lciI+CiAgICogICA8ZGl2IG5nLXZpZXcgY2xhc3M9InJldmVhbC1hbmltYXRpb24iPjwvZGl2PgogICAqIDwvZGl2PgogICAqIGBgYAogICAqCiAgICogVGhlIGZvbGxvd2luZyBjb2RlIGJlbG93IGRlbW9uc3RyYXRlcyBob3cgdG8gcGVyZm9ybSBhbmltYXRpb25zIHVzaW5nICoqQ1NTIGFuaW1hdGlvbnMqKiB3aXRoIEFuZ3VsYXI6CiAgICoKICAgKiBgYGBodG1sCiAgICogPHN0eWxlIHR5cGU9InRleHQvY3NzIj4KICAgKiAucmV2ZWFsLWFuaW1hdGlvbi5uZy1lbnRlciB7CiAqICAgLXdlYmtpdC1hbmltYXRpb246IGVudGVyX3NlcXVlbmNlIDFzIGxpbmVhcjsgLyYjNDI7IFNhZmFyaS9DaHJvbWUgJiM0MjsvCiAqICAgYW5pbWF0aW9uOiBlbnRlcl9zZXF1ZW5jZSAxcyBsaW5lYXI7IC8mIzQyOyBJRTEwKyBhbmQgRnV0dXJlIEJyb3dzZXJzICYjNDI7LwogKiB9CiAgICogQC13ZWJraXQta2V5ZnJhbWVzIGVudGVyX3NlcXVlbmNlIHsKICogICBmcm9tIHsgb3BhY2l0eTowOyB9CiAqICAgdG8geyBvcGFjaXR5OjE7IH0KICogfQogICAqIEBrZXlmcmFtZXMgZW50ZXJfc2VxdWVuY2UgewogKiAgIGZyb20geyBvcGFjaXR5OjA7IH0KICogICB0byB7IG9wYWNpdHk6MTsgfQogKiB9CiAgICogPC9zdHlsZT4KICAgKgogICAqIDxkaXYgY2xhc3M9InZpZXctY29udGFpbmVyIj4KICAgKiAgIDxkaXYgbmctdmlldyBjbGFzcz0icmV2ZWFsLWFuaW1hdGlvbiI+PC9kaXY+CiAgICogPC9kaXY+CiAgICogYGBgCiAgICoKICAgKiBCb3RoIENTUzMgYW5pbWF0aW9ucyBhbmQgdHJhbnNpdGlvbnMgY2FuIGJlIHVzZWQgdG9nZXRoZXIgYW5kIHRoZSBhbmltYXRlIHNlcnZpY2Ugd2lsbCBmaWd1cmUgb3V0IHRoZSBjb3JyZWN0IGR1cmF0aW9uIGFuZCBkZWxheSB0aW1pbmcuCiAgICoKICAgKiBVcG9uIERPTSBtdXRhdGlvbiwgdGhlIGV2ZW50IGNsYXNzIGlzIGFkZGVkIGZpcnN0IChzb21ldGhpbmcgbGlrZSBgbmctZW50ZXJgKSwgdGhlbiB0aGUgYnJvd3NlciBwcmVwYXJlcyBpdHNlbGYgdG8gYWRkCiAgICogdGhlIGFjdGl2ZSBjbGFzcyAoaW4gdGhpcyBjYXNlIGBuZy1lbnRlci1hY3RpdmVgKSB3aGljaCB0aGVuIHRyaWdnZXJzIHRoZSBhbmltYXRpb24uIFRoZSBhbmltYXRpb24gbW9kdWxlIHdpbGwgYXV0b21hdGljYWxseQogICAqIGRldGVjdCB0aGUgQ1NTIGNvZGUgdG8gZGV0ZXJtaW5lIHdoZW4gdGhlIGFuaW1hdGlvbiBlbmRzLiBPbmNlIHRoZSBhbmltYXRpb24gaXMgb3ZlciB0aGVuIGJvdGggQ1NTIGNsYXNzZXMgd2lsbCBiZQogICAqIHJlbW92ZWQgZnJvbSB0aGUgRE9NLiBJZiBhIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBDU1MgdHJhbnNpdGlvbnMgb3IgQ1NTIGFuaW1hdGlvbnMgdGhlbiB0aGUgYW5pbWF0aW9uIHdpbGwgc3RhcnQgYW5kIGVuZAogICAqIGltbWVkaWF0ZWx5IHJlc3VsdGluZyBpbiBhIERPTSBlbGVtZW50IHRoYXQgaXMgYXQgaXRzIGZpbmFsIHN0YXRlLiBUaGlzIGZpbmFsIHN0YXRlIGlzIHdoZW4gdGhlIERPTSBlbGVtZW50CiAgICogaGFzIG5vIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBjbGFzc2VzIGFwcGxpZWQgdG8gaXQuCiAgICoKICAgKiA8aDM+Q1NTIFN0YWdnZXJpbmcgQW5pbWF0aW9uczwvaDM+CiAgICogQSBTdGFnZ2VyaW5nIGFuaW1hdGlvbiBpcyBhIGNvbGxlY3Rpb24gb2YgYW5pbWF0aW9ucyB0aGF0IGFyZSBpc3N1ZWQgd2l0aCBhIHNsaWdodCBkZWxheSBpbiBiZXR3ZWVuIGVhY2ggc3VjY2Vzc2l2ZSBvcGVyYXRpb24gcmVzdWx0aW5nIGluIGEKICAgKiBjdXJ0YWluLWxpa2UgZWZmZWN0LiBUaGUgbmdBbmltYXRlIG1vZHVsZSwgYXMgb2YgMS4yLjAsIHN1cHBvcnRzIHN0YWdnZXJpbmcgYW5pbWF0aW9ucyBhbmQgdGhlIHN0YWdnZXIgZWZmZWN0IGNhbiBiZQogICAqIHBlcmZvcm1lZCBieSBjcmVhdGluZyBhICoqbmctRVZFTlQtc3RhZ2dlcioqIENTUyBjbGFzcyBhbmQgYXR0YWNoaW5nIHRoYXQgY2xhc3MgdG8gdGhlIGJhc2UgQ1NTIGNsYXNzIHVzZWQgZm9yCiAgICogdGhlIGFuaW1hdGlvbi4gVGhlIHN0eWxlIHByb3BlcnR5IGV4cGVjdGVkIHdpdGhpbiB0aGUgc3RhZ2dlciBjbGFzcyBjYW4gZWl0aGVyIGJlIGEgKip0cmFuc2l0aW9uLWRlbGF5Kiogb3IgYW4KICAgKiAqKmFuaW1hdGlvbi1kZWxheSoqIHByb3BlcnR5IChvciBib3RoIGlmIHlvdXIgYW5pbWF0aW9uIGNvbnRhaW5zIGJvdGggdHJhbnNpdGlvbnMgYW5kIGtleWZyYW1lIGFuaW1hdGlvbnMpLgogICAqCiAgICogYGBgY3NzCiAgICogLm15LWFuaW1hdGlvbi5uZy1lbnRlciB7CiAqICAgLyYjNDI7IHN0YW5kYXJkIHRyYW5zaXRpb24gY29kZSAmIzQyOy8KICogICAtd2Via2l0LXRyYW5zaXRpb246IDFzIGxpbmVhciBhbGw7CiAqICAgdHJhbnNpdGlvbjogMXMgbGluZWFyIGFsbDsKICogICBvcGFjaXR5OjA7CiAqIH0KICAgKiAubXktYW5pbWF0aW9uLm5nLWVudGVyLXN0YWdnZXIgewogKiAgIC8mIzQyOyB0aGlzIHdpbGwgaGF2ZSBhIDEwMG1zIGRlbGF5IGJldHdlZW4gZWFjaCBzdWNjZXNzaXZlIGxlYXZlIGFuaW1hdGlvbiAmIzQyOy8KICogICAtd2Via2l0LXRyYW5zaXRpb24tZGVsYXk6IDAuMXM7CiAqICAgdHJhbnNpdGlvbi1kZWxheTogMC4xczsKICoKICogICAvJiM0MjsgaW4gY2FzZSB0aGUgc3RhZ2dlciBkb2Vzbid0IHdvcmsgdGhlbiB0aGVzZSB0d28gdmFsdWVzCiAqICAgIG11c3QgYmUgc2V0IHRvIDAgdG8gYXZvaWQgYW4gYWNjaWRlbnRhbCBDU1MgaW5oZXJpdGFuY2UgJiM0MjsvCiAqICAgLXdlYmtpdC10cmFuc2l0aW9uLWR1cmF0aW9uOiAwczsKICogICB0cmFuc2l0aW9uLWR1cmF0aW9uOiAwczsKICogfQogICAqIC5teS1hbmltYXRpb24ubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICogICAvJiM0Mjsgc3RhbmRhcmQgdHJhbnNpdGlvbiBzdHlsZXMgJiM0MjsvCiAqICAgb3BhY2l0eToxOwogKiB9CiAgICogYGBgCiAgICoKICAgKiBTdGFnZ2VyaW5nIGFuaW1hdGlvbnMgd29yayBieSBkZWZhdWx0IGluIG5nUmVwZWF0IChzbyBsb25nIGFzIHRoZSBDU1MgY2xhc3MgaXMgZGVmaW5lZCkuIE91dHNpZGUgb2YgbmdSZXBlYXQsIHRvIHVzZSBzdGFnZ2VyaW5nIGFuaW1hdGlvbnMKICAgKiBvbiB5b3VyIG93biwgdGhleSBjYW4gYmUgdHJpZ2dlcmVkIGJ5IGZpcmluZyBtdWx0aXBsZSBjYWxscyB0byB0aGUgc2FtZSBldmVudCBvbiAkYW5pbWF0ZS4gSG93ZXZlciwgdGhlIHJlc3RyaWN0aW9ucyBzdXJyb3VuZGluZyB0aGlzCiAgICogYXJlIHRoYXQgZWFjaCBvZiB0aGUgZWxlbWVudHMgbXVzdCBoYXZlIHRoZSBzYW1lIENTUyBjbGFzc05hbWUgdmFsdWUgYXMgd2VsbCBhcyB0aGUgc2FtZSBwYXJlbnQgZWxlbWVudC4gQSBzdGFnZ2VyIG9wZXJhdGlvbgogICAqIHdpbGwgYWxzbyBiZSByZXNldCBpZiBtb3JlIHRoYW4gMTBtcyBoYXMgcGFzc2VkIGFmdGVyIHRoZSBsYXN0IGFuaW1hdGlvbiBoYXMgYmVlbiBmaXJlZC4KICAgKgogICAqIFRoZSBmb2xsb3dpbmcgY29kZSB3aWxsIGlzc3VlIHRoZSAqKm5nLWxlYXZlLXN0YWdnZXIqKiBldmVudCBvbiB0aGUgZWxlbWVudCBwcm92aWRlZDoKICAgKgogICAqIGBgYGpzCiAgICogdmFyIGtpZHMgPSBwYXJlbnQuY2hpbGRyZW4oKTsKICAgKgogICAqICRhbmltYXRlLmxlYXZlKGtpZHNbMF0pOyAvL3N0YWdnZXIgaW5kZXg9MAogICAqICRhbmltYXRlLmxlYXZlKGtpZHNbMV0pOyAvL3N0YWdnZXIgaW5kZXg9MQogICAqICRhbmltYXRlLmxlYXZlKGtpZHNbMl0pOyAvL3N0YWdnZXIgaW5kZXg9MgogICAqICRhbmltYXRlLmxlYXZlKGtpZHNbM10pOyAvL3N0YWdnZXIgaW5kZXg9MwogICAqICRhbmltYXRlLmxlYXZlKGtpZHNbNF0pOyAvL3N0YWdnZXIgaW5kZXg9NAogICAqCiAgICogJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAqICAgLy9zdGFnZ2VyIGhhcyByZXNldCBpdHNlbGYKICogICAkYW5pbWF0ZS5sZWF2ZShraWRzWzVdKTsgLy9zdGFnZ2VyIGluZGV4PTAKICogICAkYW5pbWF0ZS5sZWF2ZShraWRzWzZdKTsgLy9zdGFnZ2VyIGluZGV4PTEKICogfSwgMTAwLCBmYWxzZSk7CiAgICogYGBgCiAgICoKICAgKiBTdGFnZ2VyIGFuaW1hdGlvbnMgYXJlIGN1cnJlbnRseSBvbmx5IHN1cHBvcnRlZCB3aXRoaW4gQ1NTLWRlZmluZWQgYW5pbWF0aW9ucy4KICAgKgogICAqIDxoMj5KYXZhU2NyaXB0LWRlZmluZWQgQW5pbWF0aW9uczwvaDI+CiAgICogSW4gdGhlIGV2ZW50IHRoYXQgeW91IGRvIG5vdCB3YW50IHRvIHVzZSBDU1MzIHRyYW5zaXRpb25zIG9yIENTUzMgYW5pbWF0aW9ucyBvciBpZiB5b3Ugd2lzaCB0byBvZmZlciBhbmltYXRpb25zIG9uIGJyb3dzZXJzIHRoYXQgZG8gbm90CiAgICogeWV0IHN1cHBvcnQgQ1NTIHRyYW5zaXRpb25zL2FuaW1hdGlvbnMsIHRoZW4geW91IGNhbiBtYWtlIHVzZSBvZiBKYXZhU2NyaXB0IGFuaW1hdGlvbnMgZGVmaW5lZCBpbnNpZGUgb2YgeW91ciBBbmd1bGFySlMgbW9kdWxlLgogICAqCiAgICogYGBganMKICAgKiAvLyFhbm5vdGF0ZT0iWW91ckFwcCIgWW91ciBBbmd1bGFySlMgTW9kdWxlfFJlcGxhY2UgdGhpcyBvciBuZ01vZHVsZSB3aXRoIHRoZSBtb2R1bGUgdGhhdCB5b3UgdXNlZCB0byBkZWZpbmUgeW91ciBhcHBsaWNhdGlvbi4KICAgKiB2YXIgbmdNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnWW91ckFwcCcsIFsnbmdBbmltYXRlJ10pOwogICAqIG5nTW9kdWxlLmFuaW1hdGlvbignLm15LWNyYXp5LWFuaW1hdGlvbicsIGZ1bmN0aW9uKCkgewogKiAgIHJldHVybiB7CiAqICAgICBlbnRlcjogZnVuY3Rpb24oZWxlbWVudCwgZG9uZSkgewogKiAgICAgICAvL3J1biB0aGUgYW5pbWF0aW9uIGhlcmUgYW5kIGNhbGwgZG9uZSB3aGVuIHRoZSBhbmltYXRpb24gaXMgY29tcGxldGUKICogICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbmNlbGxlZCkgewogKiAgICAgICAgIC8vdGhpcyAob3B0aW9uYWwpIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIGFuaW1hdGlvbgogKiAgICAgICAgIC8vY29tcGxldGVzIG9yIHdoZW4gdGhlIGFuaW1hdGlvbiBpcyBjYW5jZWxsZWQgKHRoZSBjYW5jZWxsZWQKICogICAgICAgICAvL2ZsYWcgd2lsbCBiZSBzZXQgdG8gdHJ1ZSBpZiBjYW5jZWxsZWQpLgogKiAgICAgICB9OwogKiAgICAgfSwKICogICAgIGxlYXZlOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7IH0sCiAqICAgICBtb3ZlOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7IH0sCiAqCiAqICAgICAvL2FuaW1hdGlvbiB0aGF0IGNhbiBiZSB0cmlnZ2VyZWQgYmVmb3JlIHRoZSBjbGFzcyBpcyBhZGRlZAogKiAgICAgYmVmb3JlQWRkQ2xhc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgeyB9LAogKgogKiAgICAgLy9hbmltYXRpb24gdGhhdCBjYW4gYmUgdHJpZ2dlcmVkIGFmdGVyIHRoZSBjbGFzcyBpcyBhZGRlZAogKiAgICAgYWRkQ2xhc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgeyB9LAogKgogKiAgICAgLy9hbmltYXRpb24gdGhhdCBjYW4gYmUgdHJpZ2dlcmVkIGJlZm9yZSB0aGUgY2xhc3MgaXMgcmVtb3ZlZAogKiAgICAgYmVmb3JlUmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgeyB9LAogKgogKiAgICAgLy9hbmltYXRpb24gdGhhdCBjYW4gYmUgdHJpZ2dlcmVkIGFmdGVyIHRoZSBjbGFzcyBpcyByZW1vdmVkCiAqICAgICByZW1vdmVDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7IH0KICogICB9OwogKiB9KTsKICAgKiBgYGAKICAgKgogICAqIEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIGFyZSBjcmVhdGVkIHdpdGggYSBDU1MtbGlrZSBjbGFzcyBzZWxlY3RvciBhbmQgYSBjb2xsZWN0aW9uIG9mIGV2ZW50cyB3aGljaCBhcmUgc2V0IHRvIHJ1bgogICAqIGEgamF2YXNjcmlwdCBjYWxsYmFjayBmdW5jdGlvbi4gV2hlbiBhbiBhbmltYXRpb24gaXMgdHJpZ2dlcmVkLCAkYW5pbWF0ZSB3aWxsIGxvb2sgZm9yIGEgbWF0Y2hpbmcgYW5pbWF0aW9uIHdoaWNoIGZpdHMKICAgKiB0aGUgZWxlbWVudCdzIENTUyBjbGFzcyBhdHRyaWJ1dGUgdmFsdWUgYW5kIHRoZW4gcnVuIHRoZSBtYXRjaGluZyBhbmltYXRpb24gZXZlbnQgZnVuY3Rpb24gKGlmIGZvdW5kKS4KICAgKiBJbiBvdGhlciB3b3JkcywgaWYgdGhlIENTUyBjbGFzc2VzIHByZXNlbnQgb24gdGhlIGFuaW1hdGVkIGVsZW1lbnQgbWF0Y2ggYW55IG9mIHRoZSBKYXZhU2NyaXB0IGFuaW1hdGlvbnMgdGhlbiB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gd2lsbAogICAqIGJlIGV4ZWN1dGVkLiBJdCBzaG91bGQgYmUgYWxzbyBub3RlZCB0aGF0IG9ubHkgc2ltcGxlLCBzaW5nbGUgY2xhc3Mgc2VsZWN0b3JzIGFyZSBhbGxvd2VkIChjb21wb3VuZCBjbGFzcyBzZWxlY3RvcnMgYXJlIG5vdCBzdXBwb3J0ZWQpLgogICAqCiAgICogV2l0aGluIGEgSmF2YVNjcmlwdCBhbmltYXRpb24sIGFuIG9iamVjdCBjb250YWluaW5nIHZhcmlvdXMgZXZlbnQgY2FsbGJhY2sgYW5pbWF0aW9uIGZ1bmN0aW9ucyBpcyBleHBlY3RlZCB0byBiZSByZXR1cm5lZC4KICAgKiBBcyBleHBsYWluZWQgYWJvdmUsIHRoZXNlIGNhbGxiYWNrcyBhcmUgdHJpZ2dlcmVkIGJhc2VkIG9uIHRoZSBhbmltYXRpb24gZXZlbnQuIFRoZXJlZm9yZSBpZiBhbiBlbnRlciBhbmltYXRpb24gaXMgcnVuLAogICAqIGFuZCB0aGUgSmF2YVNjcmlwdCBhbmltYXRpb24gaXMgZm91bmQsIHRoZW4gdGhlIGVudGVyIGNhbGxiYWNrIHdpbGwgaGFuZGxlIHRoYXQgYW5pbWF0aW9uIChpbiBhZGRpdGlvbiB0byB0aGUgQ1NTIGtleWZyYW1lIGFuaW1hdGlvbgogICAqIG9yIHRyYW5zaXRpb24gY29kZSB0aGF0IGlzIGRlZmluZWQgdmlhIGEgc3R5bGVzaGVldCkuCiAgICoKICAgKi8KCiAgYW5ndWxhci5tb2R1bGUoJ25nQW5pbWF0ZScsIFsnbmcnXSkKCiAgLyoqCiAgICogQG5nZG9jIHByb3ZpZGVyCiAgICogQG5hbWUgJGFuaW1hdGVQcm92aWRlcgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogVGhlIGAkYW5pbWF0ZVByb3ZpZGVyYCBhbGxvd3MgZGV2ZWxvcGVycyB0byByZWdpc3RlciBKYXZhU2NyaXB0IGFuaW1hdGlvbiBldmVudCBoYW5kbGVycyBkaXJlY3RseSBpbnNpZGUgb2YgYSBtb2R1bGUuCiAgICogV2hlbiBhbiBhbmltYXRpb24gaXMgdHJpZ2dlcmVkLCB0aGUgJGFuaW1hdGUgc2VydmljZSB3aWxsIHF1ZXJ5IHRoZSAkYW5pbWF0ZSBzZXJ2aWNlIHRvIGZpbmQgYW55IGFuaW1hdGlvbnMgdGhhdCBtYXRjaAogICAqIHRoZSBwcm92aWRlZCBuYW1lIHZhbHVlLgogICAqCiAgICogUmVxdWlyZXMgdGhlIHtAbGluayBuZ0FuaW1hdGUgYG5nQW5pbWF0ZWB9IG1vZHVsZSB0byBiZSBpbnN0YWxsZWQuCiAgICoKICAgKiBQbGVhc2UgdmlzaXQgdGhlIHtAbGluayBuZ0FuaW1hdGUgYG5nQW5pbWF0ZWB9IG1vZHVsZSBvdmVydmlldyBwYWdlIGxlYXJuIG1vcmUgYWJvdXQgaG93IHRvIHVzZSBhbmltYXRpb25zIGluIHlvdXIgYXBwbGljYXRpb24uCiAgICoKICAgKi8KCiAgICAvL3RoaXMgcHJpdmF0ZSBzZXJ2aWNlIGlzIG9ubHkgdXNlZCB3aXRoaW4gQ1NTLWVuYWJsZWQgYW5pbWF0aW9ucwogICAgLy9JRTggKyBJRTkgZG8gbm90IHN1cHBvcnQgckFGIG5hdGl2ZWx5LCBidXQgdGhhdCBpcyBmaW5lIHNpbmNlIHRoZXkKICAgIC8vYWxzbyBkb24ndCBzdXBwb3J0IHRyYW5zaXRpb25zIGFuZCBrZXlmcmFtZXMgd2hpY2ggbWVhbnMgdGhhdCB0aGUgY29kZQogICAgLy9iZWxvdyB3aWxsIG5ldmVyIGJlIHVzZWQgYnkgdGhlIHR3byBicm93c2Vycy4KICAgIC5mYWN0b3J5KCckJGFuaW1hdGVSZWZsb3cnLCBbJyQkckFGJywgJyRkb2N1bWVudCcsIGZ1bmN0aW9uKCQkckFGLCAkZG9jdW1lbnQpIHsKICAgICAgdmFyIGJvZCA9ICRkb2N1bWVudFswXS5ib2R5OwogICAgICByZXR1cm4gZnVuY3Rpb24oZm4pIHsKICAgICAgICAvL3RoZSByZXR1cm5lZCBmdW5jdGlvbiBhY3RzIGFzIHRoZSBjYW5jZWxsYXRpb24gZnVuY3Rpb24KICAgICAgICByZXR1cm4gJCRyQUYoZnVuY3Rpb24oKSB7CiAgICAgICAgICAvL3RoZSBsaW5lIGJlbG93IHdpbGwgZm9yY2UgdGhlIGJyb3dzZXIgdG8gcGVyZm9ybSBhIHJlcGFpbnQKICAgICAgICAgIC8vc28gdGhhdCBhbGwgdGhlIGFuaW1hdGVkIGVsZW1lbnRzIHdpdGhpbiB0aGUgYW5pbWF0aW9uIGZyYW1lCiAgICAgICAgICAvL3dpbGwgYmUgcHJvcGVybHkgdXBkYXRlZCBhbmQgZHJhd24gb24gc2NyZWVuLiBUaGlzIGlzCiAgICAgICAgICAvL3JlcXVpcmVkIHRvIHBlcmZvcm0gbXVsdGktY2xhc3MgQ1NTIGJhc2VkIGFuaW1hdGlvbnMgd2l0aAogICAgICAgICAgLy9GaXJlZm94LiBETyBOT1QgUkVNT1ZFIFRISVMgTElORS4KICAgICAgICAgIHZhciBhID0gYm9kLm9mZnNldFdpZHRoICsgMTsKICAgICAgICAgIGZuKCk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9XSkKCiAgICAuY29uZmlnKFsnJHByb3ZpZGUnLCAnJGFuaW1hdGVQcm92aWRlcicsIGZ1bmN0aW9uKCRwcm92aWRlLCAkYW5pbWF0ZVByb3ZpZGVyKSB7CiAgICAgIHZhciBub29wID0gYW5ndWxhci5ub29wOwogICAgICB2YXIgZm9yRWFjaCA9IGFuZ3VsYXIuZm9yRWFjaDsKICAgICAgdmFyIHNlbGVjdG9ycyA9ICRhbmltYXRlUHJvdmlkZXIuJCRzZWxlY3RvcnM7CgogICAgICB2YXIgRUxFTUVOVF9OT0RFID0gMTsKICAgICAgdmFyIE5HX0FOSU1BVEVfU1RBVEUgPSAnJCRuZ0FuaW1hdGVTdGF0ZSc7CiAgICAgIHZhciBOR19BTklNQVRFX0NMQVNTX05BTUUgPSAnbmctYW5pbWF0ZSc7CiAgICAgIHZhciByb290QW5pbWF0ZVN0YXRlID0ge3J1bm5pbmc6IHRydWV9OwoKICAgICAgZnVuY3Rpb24gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpIHsKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgZWxlbWVudC5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGVsbSA9IGVsZW1lbnRbaV07CiAgICAgICAgICBpZihlbG0ubm9kZVR5cGUgPT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIHJldHVybiBlbG07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBwcmVwYXJlRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnQgJiYgYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCkgewogICAgICAgIHJldHVybiBhbmd1bGFyLmVsZW1lbnQoZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gaXNNYXRjaGluZ0VsZW1lbnQoZWxtMSwgZWxtMikgewogICAgICAgIHJldHVybiBleHRyYWN0RWxlbWVudE5vZGUoZWxtMSkgPT0gZXh0cmFjdEVsZW1lbnROb2RlKGVsbTIpOwogICAgICB9CgogICAgICAkcHJvdmlkZS5kZWNvcmF0b3IoJyRhbmltYXRlJywgWyckZGVsZWdhdGUnLCAnJGluamVjdG9yJywgJyRzbmlmZmVyJywgJyRyb290RWxlbWVudCcsICckJGFzeW5jQ2FsbGJhY2snLCAnJHJvb3RTY29wZScsICckZG9jdW1lbnQnLAogICAgICAgIGZ1bmN0aW9uKCRkZWxlZ2F0ZSwgICAkaW5qZWN0b3IsICAgJHNuaWZmZXIsICAgJHJvb3RFbGVtZW50LCAgICQkYXN5bmNDYWxsYmFjaywgICAgJHJvb3RTY29wZSwgICAkZG9jdW1lbnQpIHsKCiAgICAgICAgICB2YXIgZ2xvYmFsQW5pbWF0aW9uQ291bnRlciA9IDA7CiAgICAgICAgICAkcm9vdEVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFLCByb290QW5pbWF0ZVN0YXRlKTsKCiAgICAgICAgICAvLyBkaXNhYmxlIGFuaW1hdGlvbnMgZHVyaW5nIGJvb3RzdHJhcCwgYnV0IG9uY2Ugd2UgYm9vdHN0cmFwcGVkLCB3YWl0IGFnYWluCiAgICAgICAgICAvLyBmb3IgYW5vdGhlciBkaWdlc3QgdW50aWwgZW5hYmxpbmcgYW5pbWF0aW9ucy4gVGhlIHJlYXNvbiB3aHkgd2UgZGlnZXN0IHR3aWNlCiAgICAgICAgICAvLyBpcyBiZWNhdXNlIGFsbCBzdHJ1Y3R1cmFsIGFuaW1hdGlvbnMgKGVudGVyLCBsZWF2ZSBhbmQgbW92ZSkgYWxsIHBlcmZvcm0gYQogICAgICAgICAgLy8gcG9zdCBkaWdlc3Qgb3BlcmF0aW9uIGJlZm9yZSBhbmltYXRpbmcuIElmIHdlIG9ubHkgd2FpdCBmb3IgYSBzaW5nbGUgZGlnZXN0CiAgICAgICAgICAvLyB0byBwYXNzIHRoZW4gdGhlIHN0cnVjdHVyYWwgYW5pbWF0aW9uIHdvdWxkIHJlbmRlciBpdHMgYW5pbWF0aW9uIG9uIHBhZ2UgbG9hZC4KICAgICAgICAgIC8vICh3aGljaCBpcyB3aGF0IHdlJ3JlIHRyeWluZyB0byBhdm9pZCB3aGVuIHRoZSBhcHBsaWNhdGlvbiBmaXJzdCBib290cyB1cC4pCiAgICAgICAgICAkcm9vdFNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgJHJvb3RTY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcm9vdEFuaW1hdGVTdGF0ZS5ydW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CgogICAgICAgICAgdmFyIGNsYXNzTmFtZUZpbHRlciA9ICRhbmltYXRlUHJvdmlkZXIuY2xhc3NOYW1lRmlsdGVyKCk7CiAgICAgICAgICB2YXIgaXNBbmltYXRhYmxlQ2xhc3NOYW1lID0gIWNsYXNzTmFtZUZpbHRlcgogICAgICAgICAgICA/IGZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfQogICAgICAgICAgICA6IGZ1bmN0aW9uKGNsYXNzTmFtZSkgewogICAgICAgICAgICByZXR1cm4gY2xhc3NOYW1lRmlsdGVyLnRlc3QoY2xhc3NOYW1lKTsKICAgICAgICAgIH07CgogICAgICAgICAgZnVuY3Rpb24gbG9va3VwKG5hbWUpIHsKICAgICAgICAgICAgaWYgKG5hbWUpIHsKICAgICAgICAgICAgICB2YXIgbWF0Y2hlcyA9IFtdLAogICAgICAgICAgICAgICAgZmxhZ01hcCA9IHt9LAogICAgICAgICAgICAgICAgY2xhc3NlcyA9IG5hbWUuc3Vic3RyKDEpLnNwbGl0KCcuJyk7CgogICAgICAgICAgICAgIC8vdGhlIGVtcHR5IHN0cmluZyB2YWx1ZSBpcyB0aGUgZGVmYXVsdCBhbmltYXRpb24KICAgICAgICAgICAgICAvL29wZXJhdGlvbiB3aGljaCBwZXJmb3JtcyBDU1MgdHJhbnNpdGlvbiBhbmQga2V5ZnJhbWUKICAgICAgICAgICAgICAvL2FuaW1hdGlvbnMgc25pZmZpbmcuIFRoaXMgaXMgYWx3YXlzIGluY2x1ZGVkIGZvciBlYWNoCiAgICAgICAgICAgICAgLy9lbGVtZW50IGFuaW1hdGlvbiBwcm9jZWR1cmUgaWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMKICAgICAgICAgICAgICAvL3RyYW5zaXRpb25zIGFuZC9vciBrZXlmcmFtZSBhbmltYXRpb25zLiBUaGUgZGVmYXVsdAogICAgICAgICAgICAgIC8vYW5pbWF0aW9uIGlzIGFkZGVkIHRvIHRoZSB0b3Agb2YgdGhlIGxpc3QgdG8gcHJldmVudAogICAgICAgICAgICAgIC8vYW55IHByZXZpb3VzIGFuaW1hdGlvbnMgZnJvbSBhZmZlY3RpbmcgdGhlIGVsZW1lbnQgc3R5bGluZwogICAgICAgICAgICAgIC8vcHJpb3IgdG8gdGhlIGVsZW1lbnQgYmVpbmcgYW5pbWF0ZWQuCiAgICAgICAgICAgICAgaWYgKCRzbmlmZmVyLnRyYW5zaXRpb25zIHx8ICRzbmlmZmVyLmFuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgIG1hdGNoZXMucHVzaCgkaW5qZWN0b3IuZ2V0KHNlbGVjdG9yc1snJ10pKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGtsYXNzID0gY2xhc3Nlc1tpXSwKICAgICAgICAgICAgICAgICAgc2VsZWN0b3JGYWN0b3J5TmFtZSA9IHNlbGVjdG9yc1trbGFzc107CiAgICAgICAgICAgICAgICBpZihzZWxlY3RvckZhY3RvcnlOYW1lICYmICFmbGFnTWFwW2tsYXNzXSkgewogICAgICAgICAgICAgICAgICBtYXRjaGVzLnB1c2goJGluamVjdG9yLmdldChzZWxlY3RvckZhY3RvcnlOYW1lKSk7CiAgICAgICAgICAgICAgICAgIGZsYWdNYXBba2xhc3NdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBhbmltYXRpb25SdW5uZXIoZWxlbWVudCwgYW5pbWF0aW9uRXZlbnQsIGNsYXNzTmFtZSkgewogICAgICAgICAgICAvL3RyYW5zY2x1ZGVkIGRpcmVjdGl2ZXMgbWF5IHNvbWV0aW1lcyBmaXJlIGFuIGFuaW1hdGlvbiB1c2luZyBvbmx5IGNvbW1lbnQgbm9kZXMKICAgICAgICAgICAgLy9iZXN0IHRvIGNhdGNoIHRoaXMgZWFybHkgb24gdG8gcHJldmVudCBhbnkgYW5pbWF0aW9uIG9wZXJhdGlvbnMgZnJvbSBvY2N1cnJpbmcKICAgICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50WzBdOwogICAgICAgICAgICBpZighbm9kZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGlzU2V0Q2xhc3NPcGVyYXRpb24gPSBhbmltYXRpb25FdmVudCA9PSAnc2V0Q2xhc3MnOwogICAgICAgICAgICB2YXIgaXNDbGFzc0Jhc2VkID0gaXNTZXRDbGFzc09wZXJhdGlvbiB8fAogICAgICAgICAgICAgIGFuaW1hdGlvbkV2ZW50ID09ICdhZGRDbGFzcycgfHwKICAgICAgICAgICAgICBhbmltYXRpb25FdmVudCA9PSAncmVtb3ZlQ2xhc3MnOwoKICAgICAgICAgICAgdmFyIGNsYXNzTmFtZUFkZCwgY2xhc3NOYW1lUmVtb3ZlOwogICAgICAgICAgICBpZihhbmd1bGFyLmlzQXJyYXkoY2xhc3NOYW1lKSkgewogICAgICAgICAgICAgIGNsYXNzTmFtZUFkZCA9IGNsYXNzTmFtZVswXTsKICAgICAgICAgICAgICBjbGFzc05hbWVSZW1vdmUgPSBjbGFzc05hbWVbMV07CiAgICAgICAgICAgICAgY2xhc3NOYW1lID0gY2xhc3NOYW1lQWRkICsgJyAnICsgY2xhc3NOYW1lUmVtb3ZlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY3VycmVudENsYXNzTmFtZSA9IGVsZW1lbnQuYXR0cignY2xhc3MnKTsKICAgICAgICAgICAgdmFyIGNsYXNzZXMgPSBjdXJyZW50Q2xhc3NOYW1lICsgJyAnICsgY2xhc3NOYW1lOwogICAgICAgICAgICBpZighaXNBbmltYXRhYmxlQ2xhc3NOYW1lKGNsYXNzZXMpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgYmVmb3JlQ29tcGxldGUgPSBub29wLAogICAgICAgICAgICAgIGJlZm9yZUNhbmNlbCA9IFtdLAogICAgICAgICAgICAgIGJlZm9yZSA9IFtdLAogICAgICAgICAgICAgIGFmdGVyQ29tcGxldGUgPSBub29wLAogICAgICAgICAgICAgIGFmdGVyQ2FuY2VsID0gW10sCiAgICAgICAgICAgICAgYWZ0ZXIgPSBbXTsKCiAgICAgICAgICAgIHZhciBhbmltYXRpb25Mb29rdXAgPSAoJyAnICsgY2xhc3NlcykucmVwbGFjZSgvXHMrL2csJy4nKTsKICAgICAgICAgICAgZm9yRWFjaChsb29rdXAoYW5pbWF0aW9uTG9va3VwKSwgZnVuY3Rpb24oYW5pbWF0aW9uRmFjdG9yeSkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gcmVnaXN0ZXJBbmltYXRpb24oYW5pbWF0aW9uRmFjdG9yeSwgYW5pbWF0aW9uRXZlbnQpOwogICAgICAgICAgICAgIGlmKCFjcmVhdGVkICYmIGlzU2V0Q2xhc3NPcGVyYXRpb24pIHsKICAgICAgICAgICAgICAgIHJlZ2lzdGVyQW5pbWF0aW9uKGFuaW1hdGlvbkZhY3RvcnksICdhZGRDbGFzcycpOwogICAgICAgICAgICAgICAgcmVnaXN0ZXJBbmltYXRpb24oYW5pbWF0aW9uRmFjdG9yeSwgJ3JlbW92ZUNsYXNzJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyQW5pbWF0aW9uKGFuaW1hdGlvbkZhY3RvcnksIGV2ZW50KSB7CiAgICAgICAgICAgICAgdmFyIGFmdGVyRm4gPSBhbmltYXRpb25GYWN0b3J5W2V2ZW50XTsKICAgICAgICAgICAgICB2YXIgYmVmb3JlRm4gPSBhbmltYXRpb25GYWN0b3J5WydiZWZvcmUnICsgZXZlbnQuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBldmVudC5zdWJzdHIoMSldOwogICAgICAgICAgICAgIGlmKGFmdGVyRm4gfHwgYmVmb3JlRm4pIHsKICAgICAgICAgICAgICAgIGlmKGV2ZW50ID09ICdsZWF2ZScpIHsKICAgICAgICAgICAgICAgICAgYmVmb3JlRm4gPSBhZnRlckZuOwogICAgICAgICAgICAgICAgICAvL3doZW4gc2V0IGFzIG51bGwgdGhlbiBhbmltYXRpb24ga25vd3MgdG8gc2tpcCB0aGlzIHBoYXNlCiAgICAgICAgICAgICAgICAgIGFmdGVyRm4gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYWZ0ZXIucHVzaCh7CiAgICAgICAgICAgICAgICAgIGV2ZW50IDogZXZlbnQsIGZuIDogYWZ0ZXJGbgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBiZWZvcmUucHVzaCh7CiAgICAgICAgICAgICAgICAgIGV2ZW50IDogZXZlbnQsIGZuIDogYmVmb3JlRm4KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBydW4oZm5zLCBjYW5jZWxsYXRpb25zLCBhbGxDb21wbGV0ZUZuKSB7CiAgICAgICAgICAgICAgdmFyIGFuaW1hdGlvbnMgPSBbXTsKICAgICAgICAgICAgICBmb3JFYWNoKGZucywgZnVuY3Rpb24oYW5pbWF0aW9uKSB7CiAgICAgICAgICAgICAgICBhbmltYXRpb24uZm4gJiYgYW5pbWF0aW9ucy5wdXNoKGFuaW1hdGlvbik7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIHZhciBjb3VudCA9IDA7CiAgICAgICAgICAgICAgZnVuY3Rpb24gYWZ0ZXJBbmltYXRpb25Db21wbGV0ZShpbmRleCkgewogICAgICAgICAgICAgICAgaWYoY2FuY2VsbGF0aW9ucykgewogICAgICAgICAgICAgICAgICAoY2FuY2VsbGF0aW9uc1tpbmRleF0gfHwgbm9vcCkoKTsKICAgICAgICAgICAgICAgICAgaWYoKytjb3VudCA8IGFuaW1hdGlvbnMubGVuZ3RoKSByZXR1cm47CiAgICAgICAgICAgICAgICAgIGNhbmNlbGxhdGlvbnMgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYWxsQ29tcGxldGVGbigpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy9UaGUgY29kZSBiZWxvdyBhZGRzIGRpcmVjdGx5IHRvIHRoZSBhcnJheSBpbiBvcmRlciB0byB3b3JrIHdpdGgKICAgICAgICAgICAgICAvL2JvdGggc3luYyBhbmQgYXN5bmMgYW5pbWF0aW9ucy4gU3luYyBhbmltYXRpb25zIGFyZSB3aGVuIHRoZSBkb25lKCkKICAgICAgICAgICAgICAvL29wZXJhdGlvbiBpcyBjYWxsZWQgcmlnaHQgYXdheS4gRE8gTk9UIFJFRkFDVE9SIQogICAgICAgICAgICAgIGZvckVhY2goYW5pbWF0aW9ucywgZnVuY3Rpb24oYW5pbWF0aW9uLCBpbmRleCkgewogICAgICAgICAgICAgICAgdmFyIHByb2dyZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGFmdGVyQW5pbWF0aW9uQ29tcGxldGUoaW5kZXgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHN3aXRjaChhbmltYXRpb24uZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgY2FzZSAnc2V0Q2xhc3MnOgogICAgICAgICAgICAgICAgICAgIGNhbmNlbGxhdGlvbnMucHVzaChhbmltYXRpb24uZm4oZWxlbWVudCwgY2xhc3NOYW1lQWRkLCBjbGFzc05hbWVSZW1vdmUsIHByb2dyZXNzKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgJ2FkZENsYXNzJzoKICAgICAgICAgICAgICAgICAgICBjYW5jZWxsYXRpb25zLnB1c2goYW5pbWF0aW9uLmZuKGVsZW1lbnQsIGNsYXNzTmFtZUFkZCB8fCBjbGFzc05hbWUsICAgICBwcm9ncmVzcykpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlICdyZW1vdmVDbGFzcyc6CiAgICAgICAgICAgICAgICAgICAgY2FuY2VsbGF0aW9ucy5wdXNoKGFuaW1hdGlvbi5mbihlbGVtZW50LCBjbGFzc05hbWVSZW1vdmUgfHwgY2xhc3NOYW1lLCAgcHJvZ3Jlc3MpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICBjYW5jZWxsYXRpb25zLnB1c2goYW5pbWF0aW9uLmZuKGVsZW1lbnQsIHByb2dyZXNzKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGlmKGNhbmNlbGxhdGlvbnMgJiYgY2FuY2VsbGF0aW9ucy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIGFsbENvbXBsZXRlRm4oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbm9kZSA6IG5vZGUsCiAgICAgICAgICAgICAgZXZlbnQgOiBhbmltYXRpb25FdmVudCwKICAgICAgICAgICAgICBjbGFzc05hbWUgOiBjbGFzc05hbWUsCiAgICAgICAgICAgICAgaXNDbGFzc0Jhc2VkIDogaXNDbGFzc0Jhc2VkLAogICAgICAgICAgICAgIGlzU2V0Q2xhc3NPcGVyYXRpb24gOiBpc1NldENsYXNzT3BlcmF0aW9uLAogICAgICAgICAgICAgIGJlZm9yZSA6IGZ1bmN0aW9uKGFsbENvbXBsZXRlRm4pIHsKICAgICAgICAgICAgICAgIGJlZm9yZUNvbXBsZXRlID0gYWxsQ29tcGxldGVGbjsKICAgICAgICAgICAgICAgIHJ1bihiZWZvcmUsIGJlZm9yZUNhbmNlbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGJlZm9yZUNvbXBsZXRlID0gbm9vcDsKICAgICAgICAgICAgICAgICAgYWxsQ29tcGxldGVGbigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBhZnRlciA6IGZ1bmN0aW9uKGFsbENvbXBsZXRlRm4pIHsKICAgICAgICAgICAgICAgIGFmdGVyQ29tcGxldGUgPSBhbGxDb21wbGV0ZUZuOwogICAgICAgICAgICAgICAgcnVuKGFmdGVyLCBhZnRlckNhbmNlbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGFmdGVyQ29tcGxldGUgPSBub29wOwogICAgICAgICAgICAgICAgICBhbGxDb21wbGV0ZUZuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNhbmNlbCA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYoYmVmb3JlQ2FuY2VsKSB7CiAgICAgICAgICAgICAgICAgIGZvckVhY2goYmVmb3JlQ2FuY2VsLCBmdW5jdGlvbihjYW5jZWxGbikgewogICAgICAgICAgICAgICAgICAgIChjYW5jZWxGbiB8fCBub29wKSh0cnVlKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIGJlZm9yZUNvbXBsZXRlKHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoYWZ0ZXJDYW5jZWwpIHsKICAgICAgICAgICAgICAgICAgZm9yRWFjaChhZnRlckNhbmNlbCwgZnVuY3Rpb24oY2FuY2VsRm4pIHsKICAgICAgICAgICAgICAgICAgICAoY2FuY2VsRm4gfHwgbm9vcCkodHJ1ZSk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICBhZnRlckNvbXBsZXRlKHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZQogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFRoZSBgJGFuaW1hdGVgIHNlcnZpY2UgcHJvdmlkZXMgYW5pbWF0aW9uIGRldGVjdGlvbiBzdXBwb3J0IHdoaWxlIHBlcmZvcm1pbmcgRE9NIG9wZXJhdGlvbnMgKGVudGVyLCBsZWF2ZSBhbmQgbW92ZSkgYXMgd2VsbCBhcyBkdXJpbmcgYWRkQ2xhc3MgYW5kIHJlbW92ZUNsYXNzIG9wZXJhdGlvbnMuCiAgICAgICAgICAgKiBXaGVuIGFueSBvZiB0aGVzZSBvcGVyYXRpb25zIGFyZSBydW4sIHRoZSAkYW5pbWF0ZSBzZXJ2aWNlCiAgICAgICAgICAgKiB3aWxsIGV4YW1pbmUgYW55IEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zICh3aGljaCBhcmUgZGVmaW5lZCBieSB1c2luZyB0aGUgJGFuaW1hdGVQcm92aWRlciBwcm92aWRlciBvYmplY3QpCiAgICAgICAgICAgKiBhcyB3ZWxsIGFzIGFueSBDU1MtZGVmaW5lZCBhbmltYXRpb25zIGFnYWluc3QgdGhlIENTUyBjbGFzc2VzIHByZXNlbnQgb24gdGhlIGVsZW1lbnQgb25jZSB0aGUgRE9NIG9wZXJhdGlvbiBpcyBydW4uCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhlIGAkYW5pbWF0ZWAgc2VydmljZSBpcyB1c2VkIGJlaGluZCB0aGUgc2NlbmVzIHdpdGggcHJlLWV4aXN0aW5nIGRpcmVjdGl2ZXMgYW5kIGFuaW1hdGlvbiB3aXRoIHRoZXNlIGRpcmVjdGl2ZXMKICAgICAgICAgICAqIHdpbGwgd29yayBvdXQgb2YgdGhlIGJveCB3aXRob3V0IGFueSBleHRyYSBjb25maWd1cmF0aW9uLgogICAgICAgICAgICoKICAgICAgICAgICAqIFJlcXVpcmVzIHRoZSB7QGxpbmsgbmdBbmltYXRlIGBuZ0FuaW1hdGVgfSBtb2R1bGUgdG8gYmUgaW5zdGFsbGVkLgogICAgICAgICAgICoKICAgICAgICAgICAqIFBsZWFzZSB2aXNpdCB0aGUge0BsaW5rIG5nQW5pbWF0ZSBgbmdBbmltYXRlYH0gbW9kdWxlIG92ZXJ2aWV3IHBhZ2UgbGVhcm4gbW9yZSBhYm91dCBob3cgdG8gdXNlIGFuaW1hdGlvbnMgaW4geW91ciBhcHBsaWNhdGlvbi4KICAgICAgICAgICAqCiAgICAgICAgICAgKi8KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lICRhbmltYXRlI2VudGVyCiAgICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBBcHBlbmRzIHRoZSBlbGVtZW50IHRvIHRoZSBwYXJlbnRFbGVtZW50IGVsZW1lbnQgdGhhdCByZXNpZGVzIGluIHRoZSBkb2N1bWVudCBhbmQgdGhlbiBydW5zIHRoZSBlbnRlciBhbmltYXRpb24uIE9uY2UKICAgICAgICAgICAgICogdGhlIGFuaW1hdGlvbiBpcyBzdGFydGVkLCB0aGUgZm9sbG93aW5nIENTUyBjbGFzc2VzIHdpbGwgYmUgcHJlc2VudCBvbiB0aGUgZWxlbWVudCBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSBhbmltYXRpb246CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEJlbG93IGlzIGEgYnJlYWtkb3duIG9mIGVhY2ggc3RlcCB0aGF0IG9jY3VycyBkdXJpbmcgZW50ZXIgYW5pbWF0aW9uOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiB8IEFuaW1hdGlvbiBTdGVwICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSB8CiAgICAgICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICAgICAgICogfCAxLiAkYW5pbWF0ZS5lbnRlciguLi4pIGlzIGNhbGxlZCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiB8IDIuIGVsZW1lbnQgaXMgaW5zZXJ0ZWQgaW50byB0aGUgcGFyZW50RWxlbWVudCBlbGVtZW50IG9yIGJlc2lkZSB0aGUgYWZ0ZXJFbGVtZW50IGVsZW1lbnQgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgMy4gJGFuaW1hdGUgcnVucyBhbnkgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUiICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCA0LiB0aGUgLm5nLWVudGVyIGNsYXNzIGlzIGFkZGVkIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1lbnRlciIgICAgfAogICAgICAgICAgICAgKiB8IDUuICRhbmltYXRlIHNjYW5zIHRoZSBlbGVtZW50IHN0eWxlcyB0byBnZXQgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBkdXJhdGlvbiBhbmQgZGVsYXkgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWVudGVyIiAgICB8CiAgICAgICAgICAgICAqIHwgNi4gJGFuaW1hdGUgd2FpdHMgZm9yIDEwbXMgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctZW50ZXIiICAgIHwKICAgICAgICAgICAgICogfCA3LiB0aGUgLm5nLWVudGVyLWFjdGl2ZSBhbmQgLm5nLWFuaW1hdGUtYWN0aXZlIGNsYXNzZXMgYXJlIGFkZGVkICh0aGlzIHRyaWdnZXJzIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24pIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWFuaW1hdGUtYWN0aXZlIG5nLWVudGVyIG5nLWVudGVyLWFjdGl2ZSIgfAogICAgICAgICAgICAgKiB8IDguICRhbmltYXRlIHdhaXRzIGZvciBYIG1pbGxpc2Vjb25kcyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWFuaW1hdGUtYWN0aXZlIG5nLWVudGVyIG5nLWVudGVyLWFjdGl2ZSIgfAogICAgICAgICAgICAgKiB8IDkuIFRoZSBhbmltYXRpb24gZW5kcyBhbmQgYWxsIGdlbmVyYXRlZCBDU1MgY2xhc3NlcyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50ICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgMTAuIFRoZSBkb25lQ2FsbGJhY2soKSBjYWxsYmFjayBpcyBmaXJlZCAoaWYgcHJvdmlkZWQpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIGVudGVyIGFuaW1hdGlvbgogICAgICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IHBhcmVudEVsZW1lbnQgdGhlIHBhcmVudCBlbGVtZW50IG9mIHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIGVudGVyIGFuaW1hdGlvbgogICAgICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGFmdGVyRWxlbWVudCB0aGUgc2libGluZyBlbGVtZW50ICh3aGljaCBpcyB0aGUgcHJldmlvdXMgZWxlbWVudCkgb2YgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgZW50ZXIgYW5pbWF0aW9uCiAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKT19IGRvbmVDYWxsYmFjayB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCBvbmNlIHRoZSBhbmltYXRpb24gaXMgY29tcGxldGUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGVudGVyIDogZnVuY3Rpb24oZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50LCBkb25lQ2FsbGJhY2spIHsKICAgICAgICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgIHBhcmVudEVsZW1lbnQgPSBwcmVwYXJlRWxlbWVudChwYXJlbnRFbGVtZW50KTsKICAgICAgICAgICAgICBhZnRlckVsZW1lbnQgPSBwcmVwYXJlRWxlbWVudChhZnRlckVsZW1lbnQpOwoKICAgICAgICAgICAgICB0aGlzLmVuYWJsZWQoZmFsc2UsIGVsZW1lbnQpOwogICAgICAgICAgICAgICRkZWxlZ2F0ZS5lbnRlcihlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQpOwogICAgICAgICAgICAgICRyb290U2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZWxlbWVudCA9IHN0cmlwQ29tbWVudHNGcm9tRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgIHBlcmZvcm1BbmltYXRpb24oJ2VudGVyJywgJ25nLWVudGVyJywgZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50LCBub29wLCBkb25lQ2FsbGJhY2spOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjbGVhdmUKICAgICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFJ1bnMgdGhlIGxlYXZlIGFuaW1hdGlvbiBvcGVyYXRpb24gYW5kLCB1cG9uIGNvbXBsZXRpb24sIHJlbW92ZXMgdGhlIGVsZW1lbnQgZnJvbSB0aGUgRE9NLiBPbmNlCiAgICAgICAgICAgICAqIHRoZSBhbmltYXRpb24gaXMgc3RhcnRlZCwgdGhlIGZvbGxvd2luZyBDU1MgY2xhc3NlcyB3aWxsIGJlIGFkZGVkIGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIGFuaW1hdGlvbjoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQmVsb3cgaXMgYSBicmVha2Rvd24gb2YgZWFjaCBzdGVwIHRoYXQgb2NjdXJzIGR1cmluZyBsZWF2ZSBhbmltYXRpb246CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBXaGF0IHRoZSBlbGVtZW50IGNsYXNzIGF0dHJpYnV0ZSBsb29rcyBsaWtlIHwKICAgICAgICAgICAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAgICAgKiB8IDEuICRhbmltYXRlLmxlYXZlKC4uLikgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgMi4gJGFuaW1hdGUgcnVucyBhbnkgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUiICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCAzLiB0aGUgLm5nLWxlYXZlIGNsYXNzIGlzIGFkZGVkIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1sZWF2ZSIgICAgfAogICAgICAgICAgICAgKiB8IDQuICRhbmltYXRlIHNjYW5zIHRoZSBlbGVtZW50IHN0eWxlcyB0byBnZXQgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBkdXJhdGlvbiBhbmQgZGVsYXkgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWxlYXZlIiAgICB8CiAgICAgICAgICAgICAqIHwgNS4gJGFuaW1hdGUgd2FpdHMgZm9yIDEwbXMgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbGVhdmUiICAgIHwKICAgICAgICAgICAgICogfCA2LiB0aGUgLm5nLWxlYXZlLWFjdGl2ZSBhbmQgLm5nLWFuaW1hdGUtYWN0aXZlIGNsYXNzZXMgaXMgYWRkZWQgKHRoaXMgdHJpZ2dlcnMgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbikgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctYW5pbWF0ZS1hY3RpdmUgbmctbGVhdmUgbmctbGVhdmUtYWN0aXZlIiB8CiAgICAgICAgICAgICAqIHwgNy4gJGFuaW1hdGUgd2FpdHMgZm9yIFggbWlsbGlzZWNvbmRzIGZvciB0aGUgYW5pbWF0aW9uIHRvIGNvbXBsZXRlICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctYW5pbWF0ZS1hY3RpdmUgbmctbGVhdmUgbmctbGVhdmUtYWN0aXZlIiB8CiAgICAgICAgICAgICAqIHwgOC4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCA5LiBUaGUgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IC4uLiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiB8IDEwLiBUaGUgZG9uZUNhbGxiYWNrKCkgY2FsbGJhY2sgaXMgZmlyZWQgKGlmIHByb3ZpZGVkKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgLi4uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlIGZvY3VzIG9mIHRoZSBsZWF2ZSBhbmltYXRpb24KICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpPX0gZG9uZUNhbGxiYWNrIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgbGVhdmUgOiBmdW5jdGlvbihlbGVtZW50LCBkb25lQ2FsbGJhY2spIHsKICAgICAgICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgIGNhbmNlbENoaWxkQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgICAgICB0aGlzLmVuYWJsZWQoZmFsc2UsIGVsZW1lbnQpOwogICAgICAgICAgICAgICRyb290U2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcGVyZm9ybUFuaW1hdGlvbignbGVhdmUnLCAnbmctbGVhdmUnLCBzdHJpcENvbW1lbnRzRnJvbUVsZW1lbnQoZWxlbWVudCksIG51bGwsIG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAkZGVsZWdhdGUubGVhdmUoZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9LCBkb25lQ2FsbGJhY2spOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjbW92ZQogICAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogRmlyZXMgdGhlIG1vdmUgRE9NIG9wZXJhdGlvbi4gSnVzdCBiZWZvcmUgdGhlIGFuaW1hdGlvbiBzdGFydHMsIHRoZSBhbmltYXRlIHNlcnZpY2Ugd2lsbCBlaXRoZXIgYXBwZW5kIGl0IGludG8gdGhlIHBhcmVudEVsZW1lbnQgY29udGFpbmVyIG9yCiAgICAgICAgICAgICAqIGFkZCB0aGUgZWxlbWVudCBkaXJlY3RseSBhZnRlciB0aGUgYWZ0ZXJFbGVtZW50IGVsZW1lbnQgaWYgcHJlc2VudC4gVGhlbiB0aGUgbW92ZSBhbmltYXRpb24gd2lsbCBiZSBydW4uIE9uY2UKICAgICAgICAgICAgICogdGhlIGFuaW1hdGlvbiBpcyBzdGFydGVkLCB0aGUgZm9sbG93aW5nIENTUyBjbGFzc2VzIHdpbGwgYmUgYWRkZWQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBCZWxvdyBpcyBhIGJyZWFrZG93biBvZiBlYWNoIHN0ZXAgdGhhdCBvY2N1cnMgZHVyaW5nIG1vdmUgYW5pbWF0aW9uOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiB8IEFuaW1hdGlvbiBTdGVwICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSB8CiAgICAgICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgICAgICAgICogfCAxLiAkYW5pbWF0ZS5tb3ZlKC4uLikgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiB8IDIuIGVsZW1lbnQgaXMgbW92ZWQgaW50byB0aGUgcGFyZW50RWxlbWVudCBlbGVtZW50IG9yIGJlc2lkZSB0aGUgYWZ0ZXJFbGVtZW50IGVsZW1lbnQgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgMy4gJGFuaW1hdGUgcnVucyBhbnkgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUiICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCA0LiB0aGUgLm5nLW1vdmUgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1tb3ZlIiAgICAgfAogICAgICAgICAgICAgKiB8IDUuICRhbmltYXRlIHNjYW5zIHRoZSBlbGVtZW50IHN0eWxlcyB0byBnZXQgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBkdXJhdGlvbiBhbmQgZGVsYXkgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLW1vdmUiICAgICB8CiAgICAgICAgICAgICAqIHwgNi4gJGFuaW1hdGUgd2FpdHMgZm9yIDEwbXMgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbW92ZSIgICAgIHwKICAgICAgICAgICAgICogfCA3LiB0aGUgLm5nLW1vdmUtYWN0aXZlIGFuZCAubmctYW5pbWF0ZS1hY3RpdmUgY2xhc3NlcyBpcyBhZGRlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBuZy1tb3ZlIG5nLW1vdmUtYWN0aXZlIiB8CiAgICAgICAgICAgICAqIHwgOC4gJGFuaW1hdGUgd2FpdHMgZm9yIFggbWlsbGlzZWNvbmRzIGZvciB0aGUgYW5pbWF0aW9uIHRvIGNvbXBsZXRlICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctYW5pbWF0ZS1hY3RpdmUgbmctbW92ZSBuZy1tb3ZlLWFjdGl2ZSIgfAogICAgICAgICAgICAgKiB8IDkuIFRoZSBhbmltYXRpb24gZW5kcyBhbmQgYWxsIGdlbmVyYXRlZCBDU1MgY2xhc3NlcyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50ICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgMTAuIFRoZSBkb25lQ2FsbGJhY2soKSBjYWxsYmFjayBpcyBmaXJlZCAoaWYgcHJvdmlkZWQpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIG1vdmUgYW5pbWF0aW9uCiAgICAgICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gcGFyZW50RWxlbWVudCB0aGUgcGFyZW50RWxlbWVudCBlbGVtZW50IG9mIHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIG1vdmUgYW5pbWF0aW9uCiAgICAgICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gYWZ0ZXJFbGVtZW50IHRoZSBzaWJsaW5nIGVsZW1lbnQgKHdoaWNoIGlzIHRoZSBwcmV2aW91cyBlbGVtZW50KSBvZiB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlIGZvY3VzIG9mIHRoZSBtb3ZlIGFuaW1hdGlvbgogICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCk9fSBkb25lQ2FsbGJhY2sgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgb25jZSB0aGUgYW5pbWF0aW9uIGlzIGNvbXBsZXRlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBtb3ZlIDogZnVuY3Rpb24oZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50LCBkb25lQ2FsbGJhY2spIHsKICAgICAgICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgIHBhcmVudEVsZW1lbnQgPSBwcmVwYXJlRWxlbWVudChwYXJlbnRFbGVtZW50KTsKICAgICAgICAgICAgICBhZnRlckVsZW1lbnQgPSBwcmVwYXJlRWxlbWVudChhZnRlckVsZW1lbnQpOwoKICAgICAgICAgICAgICBjYW5jZWxDaGlsZEFuaW1hdGlvbnMoZWxlbWVudCk7CiAgICAgICAgICAgICAgdGhpcy5lbmFibGVkKGZhbHNlLCBlbGVtZW50KTsKICAgICAgICAgICAgICAkZGVsZWdhdGUubW92ZShlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQpOwogICAgICAgICAgICAgICRyb290U2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZWxlbWVudCA9IHN0cmlwQ29tbWVudHNGcm9tRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgIHBlcmZvcm1BbmltYXRpb24oJ21vdmUnLCAnbmctbW92ZScsIGVsZW1lbnQsIHBhcmVudEVsZW1lbnQsIGFmdGVyRWxlbWVudCwgbm9vcCwgZG9uZUNhbGxiYWNrKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lICRhbmltYXRlI2FkZENsYXNzCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBUcmlnZ2VycyBhIGN1c3RvbSBhbmltYXRpb24gZXZlbnQgYmFzZWQgb2ZmIHRoZSBjbGFzc05hbWUgdmFyaWFibGUgYW5kIHRoZW4gYXR0YWNoZXMgdGhlIGNsYXNzTmFtZSB2YWx1ZSB0byB0aGUgZWxlbWVudCBhcyBhIENTUyBjbGFzcy4KICAgICAgICAgICAgICogVW5saWtlIHRoZSBvdGhlciBhbmltYXRpb24gbWV0aG9kcywgdGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIHN1ZmZpeCB0aGUgY2xhc3NOYW1lIHZhbHVlIHdpdGgge0B0eXBlIC1hZGR9IGluIG9yZGVyIHRvIHByb3ZpZGUKICAgICAgICAgICAgICogdGhlIGFuaW1hdGUgc2VydmljZSB0aGUgc2V0dXAgYW5kIGFjdGl2ZSBDU1MgY2xhc3NlcyBpbiBvcmRlciB0byB0cmlnZ2VyIHRoZSBhbmltYXRpb24gKHRoaXMgd2lsbCBiZSBza2lwcGVkIGlmIG5vIENTUyB0cmFuc2l0aW9ucwogICAgICAgICAgICAgKiBvciBrZXlmcmFtZXMgYXJlIGRlZmluZWQgb24gdGhlIC1hZGQgb3IgYmFzZSBDU1MgY2xhc3MpLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBCZWxvdyBpcyBhIGJyZWFrZG93biBvZiBlYWNoIHN0ZXAgdGhhdCBvY2N1cnMgZHVyaW5nIGFkZENsYXNzIGFuaW1hdGlvbjoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogfCBBbmltYXRpb24gU3RlcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSB8CiAgICAgICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAgICAgKiB8IDEuICRhbmltYXRlLmFkZENsYXNzKGVsZW1lbnQsICdzdXBlcicpIGlzIGNhbGxlZCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCAyLiAkYW5pbWF0ZSBydW5zIGFueSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIiAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgMy4gdGhlIC5zdXBlci1hZGQgY2xhc3MgYXJlIGFkZGVkIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBzdXBlci1hZGQiICAgfAogICAgICAgICAgICAgKiB8IDQuICRhbmltYXRlIHNjYW5zIHRoZSBlbGVtZW50IHN0eWxlcyB0byBnZXQgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBkdXJhdGlvbiBhbmQgZGVsYXkgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgc3VwZXItYWRkIiAgIHwKICAgICAgICAgICAgICogfCA1LiAkYW5pbWF0ZSB3YWl0cyBmb3IgMTBtcyAodGhpcyBwZXJmb3JtcyBhIHJlZmxvdykgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIHN1cGVyLWFkZCIgICB8CiAgICAgICAgICAgICAqIHwgNi4gdGhlIC5zdXBlciwgLnN1cGVyLWFkZC1hY3RpdmUgYW5kIC5uZy1hbmltYXRlLWFjdGl2ZSBjbGFzc2VzIGFyZSBhZGRlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBzdXBlciBzdXBlci1hZGQgc3VwZXItYWRkLWFjdGl2ZSIgICAgICAgICAgfAogICAgICAgICAgICAgKiB8IDcuICRhbmltYXRlIHdhaXRzIGZvciBYIG1pbGxpc2Vjb25kcyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIHN1cGVyIHN1cGVyLWFkZCBzdXBlci1hZGQtYWN0aXZlIiAgfAogICAgICAgICAgICAgKiB8IDguIFRoZSBhbmltYXRpb24gZW5kcyBhbmQgYWxsIGdlbmVyYXRlZCBDU1MgY2xhc3NlcyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIHN1cGVyIiAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCA5LiBUaGUgc3VwZXIgY2xhc3MgaXMga2VwdCBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciIgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgMTAuIFRoZSBkb25lQ2FsbGJhY2soKSBjYWxsYmFjayBpcyBmaXJlZCAoaWYgcHJvdmlkZWQpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIiICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIGFuaW1hdGVkCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc05hbWUgdGhlIENTUyBjbGFzcyB0aGF0IHdpbGwgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQgYW5kIHRoZW4gYW5pbWF0ZWQKICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpPX0gZG9uZUNhbGxiYWNrIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgYWRkQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGRvbmVDYWxsYmFjaykgewogICAgICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgZWxlbWVudCA9IHN0cmlwQ29tbWVudHNGcm9tRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICBwZXJmb3JtQW5pbWF0aW9uKCdhZGRDbGFzcycsIGNsYXNzTmFtZSwgZWxlbWVudCwgbnVsbCwgbnVsbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkZGVsZWdhdGUuYWRkQ2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9LCBkb25lQ2FsbGJhY2spOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjcmVtb3ZlQ2xhc3MKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFRyaWdnZXJzIGEgY3VzdG9tIGFuaW1hdGlvbiBldmVudCBiYXNlZCBvZmYgdGhlIGNsYXNzTmFtZSB2YXJpYWJsZSBhbmQgdGhlbiByZW1vdmVzIHRoZSBDU1MgY2xhc3MgcHJvdmlkZWQgYnkgdGhlIGNsYXNzTmFtZSB2YWx1ZQogICAgICAgICAgICAgKiBmcm9tIHRoZSBlbGVtZW50LiBVbmxpa2UgdGhlIG90aGVyIGFuaW1hdGlvbiBtZXRob2RzLCB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgc3VmZml4IHRoZSBjbGFzc05hbWUgdmFsdWUgd2l0aCB7QHR5cGUgLXJlbW92ZX0gaW4KICAgICAgICAgICAgICogb3JkZXIgdG8gcHJvdmlkZSB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHRoZSBzZXR1cCBhbmQgYWN0aXZlIENTUyBjbGFzc2VzIGluIG9yZGVyIHRvIHRyaWdnZXIgdGhlIGFuaW1hdGlvbiAodGhpcyB3aWxsIGJlIHNraXBwZWQgaWYKICAgICAgICAgICAgICogbm8gQ1NTIHRyYW5zaXRpb25zIG9yIGtleWZyYW1lcyBhcmUgZGVmaW5lZCBvbiB0aGUgLXJlbW92ZSBvciBiYXNlIENTUyBjbGFzc2VzKS4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQmVsb3cgaXMgYSBicmVha2Rvd24gb2YgZWFjaCBzdGVwIHRoYXQgb2NjdXJzIGR1cmluZyByZW1vdmVDbGFzcyBhbmltYXRpb246CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgV2hhdCB0aGUgZWxlbWVudCBjbGFzcyBhdHRyaWJ1dGUgbG9va3MgbGlrZSAgICAgfAogICAgICAgICAgICAgKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAgICAgKiB8IDEuICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsICdzdXBlcicpIGlzIGNhbGxlZCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIiICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiB8IDIuICRhbmltYXRlIHJ1bnMgYW55IEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgbmctYW5pbWF0ZSIgICAgICAgfAogICAgICAgICAgICAgKiB8IDMuIHRoZSAuc3VwZXItcmVtb3ZlIGNsYXNzIGFyZSBhZGRlZCB0byB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgbmctYW5pbWF0ZSBzdXBlci1yZW1vdmUifAogICAgICAgICAgICAgKiB8IDQuICRhbmltYXRlIHNjYW5zIHRoZSBlbGVtZW50IHN0eWxlcyB0byBnZXQgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbiBkdXJhdGlvbiBhbmQgZGVsYXkgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgbmctYW5pbWF0ZSBzdXBlci1yZW1vdmUiICAgfAogICAgICAgICAgICAgKiB8IDUuICRhbmltYXRlIHdhaXRzIGZvciAxMG1zICh0aGlzIHBlcmZvcm1zIGEgcmVmbG93KSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgbmctYW5pbWF0ZSBzdXBlci1yZW1vdmUiICAgfAogICAgICAgICAgICAgKiB8IDYuIHRoZSAuc3VwZXItcmVtb3ZlLWFjdGl2ZSBhbmQgLm5nLWFuaW1hdGUtYWN0aXZlIGNsYXNzZXMgYXJlIGFkZGVkIGFuZCAuc3VwZXIgaXMgcmVtb3ZlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBzdXBlci1yZW1vdmUgc3VwZXItcmVtb3ZlLWFjdGl2ZSIgICAgICAgICAgfAogICAgICAgICAgICAgKiB8IDcuICRhbmltYXRlIHdhaXRzIGZvciBYIG1pbGxpc2Vjb25kcyBmb3IgdGhlIGFuaW1hdGlvbiB0byBjb21wbGV0ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBzdXBlci1yZW1vdmUgc3VwZXItcmVtb3ZlLWFjdGl2ZSIgICB8CiAgICAgICAgICAgICAqIHwgOC4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgOS4gVGhlIGRvbmVDYWxsYmFjaygpIGNhbGxiYWNrIGlzIGZpcmVkIChpZiBwcm92aWRlZCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgYW5pbWF0ZWQKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzTmFtZSB0aGUgQ1NTIGNsYXNzIHRoYXQgd2lsbCBiZSBhbmltYXRlZCBhbmQgdGhlbiByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpPX0gZG9uZUNhbGxiYWNrIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGRvbmVDYWxsYmFjaykgewogICAgICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgZWxlbWVudCA9IHN0cmlwQ29tbWVudHNGcm9tRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICBwZXJmb3JtQW5pbWF0aW9uKCdyZW1vdmVDbGFzcycsIGNsYXNzTmFtZSwgZWxlbWVudCwgbnVsbCwgbnVsbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkZGVsZWdhdGUucmVtb3ZlQ2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9LCBkb25lQ2FsbGJhY2spOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNzZXRDbGFzcwogICAgICAgICAgICAgKiBAZnVuY3Rpb24KICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uIEFkZHMgYW5kL29yIHJlbW92ZXMgdGhlIGdpdmVuIENTUyBjbGFzc2VzIHRvIGFuZCBmcm9tIHRoZSBlbGVtZW50LgogICAgICAgICAgICAgKiBPbmNlIGNvbXBsZXRlLCB0aGUgZG9uZSgpIGNhbGxiYWNrIHdpbGwgYmUgZmlyZWQgKGlmIHByb3ZpZGVkKS4KICAgICAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgaXRzIENTUyBjbGFzc2VzIGNoYW5nZWQKICAgICAgICAgICAgICogICByZW1vdmVkIGZyb20gaXQKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGFkZCB0aGUgQ1NTIGNsYXNzZXMgd2hpY2ggd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVtb3ZlIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbj19IGRvbmUgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBwcm92aWRlZCkgdGhhdCB3aWxsIGJlIGZpcmVkIGFmdGVyIHRoZQogICAgICAgICAgICAgKiAgIENTUyBjbGFzc2VzIGhhdmUgYmVlbiBzZXQgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHNldENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgYWRkLCByZW1vdmUsIGRvbmVDYWxsYmFjaykgewogICAgICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgZWxlbWVudCA9IHN0cmlwQ29tbWVudHNGcm9tRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICBwZXJmb3JtQW5pbWF0aW9uKCdzZXRDbGFzcycsIFthZGQsIHJlbW92ZV0sIGVsZW1lbnQsIG51bGwsIG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJGRlbGVnYXRlLnNldENsYXNzKGVsZW1lbnQsIGFkZCwgcmVtb3ZlKTsKICAgICAgICAgICAgICB9LCBkb25lQ2FsbGJhY2spOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjZW5hYmxlZAogICAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSB2YWx1ZSBJZiBwcm92aWRlZCB0aGVuIHNldCB0aGUgYW5pbWF0aW9uIG9uIG9yIG9mZi4KICAgICAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IElmIHByb3ZpZGVkIHRoZW4gdGhlIGVsZW1lbnQgd2lsbCBiZSB1c2VkIHRvIHJlcHJlc2VudCB0aGUgZW5hYmxlL2Rpc2FibGUgb3BlcmF0aW9uCiAgICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEN1cnJlbnQgYW5pbWF0aW9uIHN0YXRlLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogR2xvYmFsbHkgZW5hYmxlcy9kaXNhYmxlcyBhbmltYXRpb25zLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZW5hYmxlZCA6IGZ1bmN0aW9uKHZhbHVlLCBlbGVtZW50KSB7CiAgICAgICAgICAgICAgc3dpdGNoKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgaWYodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpIHx8IHt9OwogICAgICAgICAgICAgICAgICAgIGRhdGEuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgIHJvb3RBbmltYXRlU3RhdGUuZGlzYWJsZWQgPSAhdmFsdWU7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIHZhbHVlID0gIXJvb3RBbmltYXRlU3RhdGUuZGlzYWJsZWQ7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gISF2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICAvKgogICAgICAgICAgIGFsbCBhbmltYXRpb25zIGNhbGwgdGhpcyBzaGFyZWQgYW5pbWF0aW9uIHRyaWdnZXJpbmcgZnVuY3Rpb24gaW50ZXJuYWxseS4KICAgICAgICAgICBUaGUgYW5pbWF0aW9uRXZlbnQgdmFyaWFibGUgcmVmZXJzIHRvIHRoZSBKYXZhU2NyaXB0IGFuaW1hdGlvbiBldmVudCB0aGF0IHdpbGwgYmUgdHJpZ2dlcmVkCiAgICAgICAgICAgYW5kIHRoZSBjbGFzc05hbWUgdmFsdWUgaXMgdGhlIG5hbWUgb2YgdGhlIGFuaW1hdGlvbiB0aGF0IHdpbGwgYmUgYXBwbGllZCB3aXRoaW4gdGhlCiAgICAgICAgICAgQ1NTIGNvZGUuIEVsZW1lbnQsIHBhcmVudEVsZW1lbnQgYW5kIGFmdGVyRWxlbWVudCBhcmUgcHJvdmlkZWQgRE9NIGVsZW1lbnRzIGZvciB0aGUgYW5pbWF0aW9uCiAgICAgICAgICAgYW5kIHRoZSBvbkNvbXBsZXRlIGNhbGxiYWNrIHdpbGwgYmUgZmlyZWQgb25jZSB0aGUgYW5pbWF0aW9uIGlzIGZ1bGx5IGNvbXBsZXRlLgogICAgICAgICAgICovCiAgICAgICAgICBmdW5jdGlvbiBwZXJmb3JtQW5pbWF0aW9uKGFuaW1hdGlvbkV2ZW50LCBjbGFzc05hbWUsIGVsZW1lbnQsIHBhcmVudEVsZW1lbnQsIGFmdGVyRWxlbWVudCwgZG9tT3BlcmF0aW9uLCBkb25lQ2FsbGJhY2spIHsKCiAgICAgICAgICAgIHZhciBydW5uZXIgPSBhbmltYXRpb25SdW5uZXIoZWxlbWVudCwgYW5pbWF0aW9uRXZlbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgIGlmKCFydW5uZXIpIHsKICAgICAgICAgICAgICBmaXJlRE9NT3BlcmF0aW9uKCk7CiAgICAgICAgICAgICAgZmlyZUJlZm9yZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgICAgICBmaXJlQWZ0ZXJDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICAgICAgY2xvc2VBbmltYXRpb24oKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNsYXNzTmFtZSA9IHJ1bm5lci5jbGFzc05hbWU7CiAgICAgICAgICAgIHZhciBlbGVtZW50RXZlbnRzID0gYW5ndWxhci5lbGVtZW50Ll9kYXRhKHJ1bm5lci5ub2RlKTsKICAgICAgICAgICAgZWxlbWVudEV2ZW50cyA9IGVsZW1lbnRFdmVudHMgJiYgZWxlbWVudEV2ZW50cy5ldmVudHM7CgogICAgICAgICAgICBpZiAoIXBhcmVudEVsZW1lbnQpIHsKICAgICAgICAgICAgICBwYXJlbnRFbGVtZW50ID0gYWZ0ZXJFbGVtZW50ID8gYWZ0ZXJFbGVtZW50LnBhcmVudCgpIDogZWxlbWVudC5wYXJlbnQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG5nQW5pbWF0ZVN0YXRlICA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKSB8fCB7fTsKICAgICAgICAgICAgdmFyIHJ1bm5pbmdBbmltYXRpb25zICAgICA9IG5nQW5pbWF0ZVN0YXRlLmFjdGl2ZSB8fCB7fTsKICAgICAgICAgICAgdmFyIHRvdGFsQWN0aXZlQW5pbWF0aW9ucyA9IG5nQW5pbWF0ZVN0YXRlLnRvdGFsQWN0aXZlIHx8IDA7CiAgICAgICAgICAgIHZhciBsYXN0QW5pbWF0aW9uICAgICAgICAgPSBuZ0FuaW1hdGVTdGF0ZS5sYXN0OwoKICAgICAgICAgICAgLy9vbmx5IGFsbG93IGFuaW1hdGlvbnMgaWYgdGhlIGN1cnJlbnRseSBydW5uaW5nIGFuaW1hdGlvbiBpcyBub3Qgc3RydWN0dXJhbAogICAgICAgICAgICAvL29yIGlmIHRoZXJlIGlzIG5vIGFuaW1hdGlvbiBydW5uaW5nIGF0IGFsbAogICAgICAgICAgICB2YXIgc2tpcEFuaW1hdGlvbnMgPSBydW5uZXIuaXNDbGFzc0Jhc2VkID8KICAgICAgICAgICAgICBuZ0FuaW1hdGVTdGF0ZS5kaXNhYmxlZCB8fCAobGFzdEFuaW1hdGlvbiAmJiAhbGFzdEFuaW1hdGlvbi5pc0NsYXNzQmFzZWQpIDoKICAgICAgICAgICAgICBmYWxzZTsKCiAgICAgICAgICAgIC8vc2tpcCB0aGUgYW5pbWF0aW9uIGlmIGFuaW1hdGlvbnMgYXJlIGRpc2FibGVkLCBhIHBhcmVudCBpcyBhbHJlYWR5IGJlaW5nIGFuaW1hdGVkLAogICAgICAgICAgICAvL3RoZSBlbGVtZW50IGlzIG5vdCBjdXJyZW50bHkgYXR0YWNoZWQgdG8gdGhlIGRvY3VtZW50IGJvZHkgb3IgdGhlbiBjb21wbGV0ZWx5IGNsb3NlCiAgICAgICAgICAgIC8vdGhlIGFuaW1hdGlvbiBpZiBhbnkgbWF0Y2hpbmcgYW5pbWF0aW9ucyBhcmUgbm90IGZvdW5kIGF0IGFsbC4KICAgICAgICAgICAgLy9OT1RFOiBJRTggKyBJRTkgc2hvdWxkIGNsb3NlIHByb3Blcmx5IChydW4gY2xvc2VBbmltYXRpb24oKSkgaW4gY2FzZSBhbiBhbmltYXRpb24gd2FzIGZvdW5kLgogICAgICAgICAgICBpZiAoc2tpcEFuaW1hdGlvbnMgfHwgYW5pbWF0aW9uc0Rpc2FibGVkKGVsZW1lbnQsIHBhcmVudEVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgZmlyZURPTU9wZXJhdGlvbigpOwogICAgICAgICAgICAgIGZpcmVCZWZvcmVDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICAgICAgZmlyZUFmdGVyQ2FsbGJhY2tBc3luYygpOwogICAgICAgICAgICAgIGNsb3NlQW5pbWF0aW9uKCk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgc2tpcEFuaW1hdGlvbiA9IGZhbHNlOwogICAgICAgICAgICBpZih0b3RhbEFjdGl2ZUFuaW1hdGlvbnMgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGFuaW1hdGlvbnNUb0NhbmNlbCA9IFtdOwogICAgICAgICAgICAgIGlmKCFydW5uZXIuaXNDbGFzc0Jhc2VkKSB7CiAgICAgICAgICAgICAgICBpZihhbmltYXRpb25FdmVudCA9PSAnbGVhdmUnICYmIHJ1bm5pbmdBbmltYXRpb25zWyduZy1sZWF2ZSddKSB7CiAgICAgICAgICAgICAgICAgIHNraXBBbmltYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy9jYW5jZWwgYWxsIGFuaW1hdGlvbnMgd2hlbiBhIHN0cnVjdHVyYWwgYW5pbWF0aW9uIHRha2VzIHBsYWNlCiAgICAgICAgICAgICAgICAgIGZvcih2YXIga2xhc3MgaW4gcnVubmluZ0FuaW1hdGlvbnMpIHsKICAgICAgICAgICAgICAgICAgICBhbmltYXRpb25zVG9DYW5jZWwucHVzaChydW5uaW5nQW5pbWF0aW9uc1trbGFzc10pOwogICAgICAgICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCwga2xhc3MpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJ1bm5pbmdBbmltYXRpb25zID0ge307CiAgICAgICAgICAgICAgICAgIHRvdGFsQWN0aXZlQW5pbWF0aW9ucyA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmKGxhc3RBbmltYXRpb24uZXZlbnQgPT0gJ3NldENsYXNzJykgewogICAgICAgICAgICAgICAgYW5pbWF0aW9uc1RvQ2FuY2VsLnB1c2gobGFzdEFuaW1hdGlvbik7CiAgICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYocnVubmluZ0FuaW1hdGlvbnNbY2xhc3NOYW1lXSkgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBydW5uaW5nQW5pbWF0aW9uc1tjbGFzc05hbWVdOwogICAgICAgICAgICAgICAgaWYoY3VycmVudC5ldmVudCA9PSBhbmltYXRpb25FdmVudCkgewogICAgICAgICAgICAgICAgICBza2lwQW5pbWF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbnNUb0NhbmNlbC5wdXNoKGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZihhbmltYXRpb25zVG9DYW5jZWwubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgZm9yRWFjaChhbmltYXRpb25zVG9DYW5jZWwsIGZ1bmN0aW9uKG9wZXJhdGlvbikgewogICAgICAgICAgICAgICAgICBvcGVyYXRpb24uY2FuY2VsKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKHJ1bm5lci5pc0NsYXNzQmFzZWQgJiYgIXJ1bm5lci5pc1NldENsYXNzT3BlcmF0aW9uICYmICFza2lwQW5pbWF0aW9uKSB7CiAgICAgICAgICAgICAgc2tpcEFuaW1hdGlvbiA9IChhbmltYXRpb25FdmVudCA9PSAnYWRkQ2xhc3MnKSA9PSBlbGVtZW50Lmhhc0NsYXNzKGNsYXNzTmFtZSk7IC8vb3Bwb3NpdGUgb2YgWE9SCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKHNraXBBbmltYXRpb24pIHsKICAgICAgICAgICAgICBmaXJlRE9NT3BlcmF0aW9uKCk7CiAgICAgICAgICAgICAgZmlyZUJlZm9yZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgICAgICBmaXJlQWZ0ZXJDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICAgICAgZmlyZURvbmVDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihhbmltYXRpb25FdmVudCA9PSAnbGVhdmUnKSB7CiAgICAgICAgICAgICAgLy90aGVyZSdzIG5vIG5lZWQgdG8gZXZlciByZW1vdmUgdGhlIGxpc3RlbmVyIHNpbmNlIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgLy93aWxsIGJlIHJlbW92ZWQgKGRlc3Ryb3llZCkgYWZ0ZXIgdGhlIGxlYXZlIGFuaW1hdGlvbiBlbmRzIG9yCiAgICAgICAgICAgICAgLy9pcyBjYW5jZWxsZWQgbWlkd2F5CiAgICAgICAgICAgICAgZWxlbWVudC5vbmUoJyRkZXN0cm95JywgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQodGhpcyk7CiAgICAgICAgICAgICAgICB2YXIgc3RhdGUgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICAgICAgICBpZihzdGF0ZSkgewogICAgICAgICAgICAgICAgICB2YXIgYWN0aXZlTGVhdmVBbmltYXRpb24gPSBzdGF0ZS5hY3RpdmVbJ25nLWxlYXZlJ107CiAgICAgICAgICAgICAgICAgIGlmKGFjdGl2ZUxlYXZlQW5pbWF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aXZlTGVhdmVBbmltYXRpb24uY2FuY2VsKCk7CiAgICAgICAgICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCAnbmctbGVhdmUnKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL3RoZSBuZy1hbmltYXRlIGNsYXNzIGRvZXMgbm90aGluZywgYnV0IGl0J3MgaGVyZSB0byBhbGxvdyBmb3IKICAgICAgICAgICAgLy9wYXJlbnQgYW5pbWF0aW9ucyB0byBmaW5kIGFuZCBjYW5jZWwgY2hpbGQgYW5pbWF0aW9ucyB3aGVuIG5lZWRlZAogICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKE5HX0FOSU1BVEVfQ0xBU1NfTkFNRSk7CgogICAgICAgICAgICB2YXIgbG9jYWxBbmltYXRpb25Db3VudCA9IGdsb2JhbEFuaW1hdGlvbkNvdW50ZXIrKzsKICAgICAgICAgICAgdG90YWxBY3RpdmVBbmltYXRpb25zKys7CiAgICAgICAgICAgIHJ1bm5pbmdBbmltYXRpb25zW2NsYXNzTmFtZV0gPSBydW5uZXI7CgogICAgICAgICAgICBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSwgewogICAgICAgICAgICAgIGxhc3QgOiBydW5uZXIsCiAgICAgICAgICAgICAgYWN0aXZlIDogcnVubmluZ0FuaW1hdGlvbnMsCiAgICAgICAgICAgICAgaW5kZXggOiBsb2NhbEFuaW1hdGlvbkNvdW50LAogICAgICAgICAgICAgIHRvdGFsQWN0aXZlIDogdG90YWxBY3RpdmVBbmltYXRpb25zCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy9maXJzdCB3ZSBydW4gdGhlIGJlZm9yZSBhbmltYXRpb25zIGFuZCB3aGVuIGFsbCBvZiB0aG9zZSBhcmUgY29tcGxldGUKICAgICAgICAgICAgLy90aGVuIHdlIHBlcmZvcm0gdGhlIERPTSBvcGVyYXRpb24gYW5kIHJ1biB0aGUgbmV4dCBzZXQgb2YgYW5pbWF0aW9ucwogICAgICAgICAgICBmaXJlQmVmb3JlQ2FsbGJhY2tBc3luYygpOwogICAgICAgICAgICBydW5uZXIuYmVmb3JlKGZ1bmN0aW9uKGNhbmNlbGxlZCkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpOwogICAgICAgICAgICAgIGNhbmNlbGxlZCA9IGNhbmNlbGxlZCB8fAogICAgICAgICAgICAgICAgIWRhdGEgfHwgIWRhdGEuYWN0aXZlW2NsYXNzTmFtZV0gfHwKICAgICAgICAgICAgICAgIChydW5uZXIuaXNDbGFzc0Jhc2VkICYmIGRhdGEuYWN0aXZlW2NsYXNzTmFtZV0uZXZlbnQgIT0gYW5pbWF0aW9uRXZlbnQpOwoKICAgICAgICAgICAgICBmaXJlRE9NT3BlcmF0aW9uKCk7CiAgICAgICAgICAgICAgaWYoY2FuY2VsbGVkID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBjbG9zZUFuaW1hdGlvbigpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmaXJlQWZ0ZXJDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICAgICAgICBydW5uZXIuYWZ0ZXIoY2xvc2VBbmltYXRpb24pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBmdW5jdGlvbiBmaXJlRE9NQ2FsbGJhY2soYW5pbWF0aW9uUGhhc2UpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnROYW1lID0gJyRhbmltYXRlOicgKyBhbmltYXRpb25QaGFzZTsKICAgICAgICAgICAgICBpZihlbGVtZW50RXZlbnRzICYmIGVsZW1lbnRFdmVudHNbZXZlbnROYW1lXSAmJiBlbGVtZW50RXZlbnRzW2V2ZW50TmFtZV0ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgJCRhc3luY0NhbGxiYWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBlbGVtZW50LnRyaWdnZXJIYW5kbGVyKGV2ZW50TmFtZSwgewogICAgICAgICAgICAgICAgICAgIGV2ZW50IDogYW5pbWF0aW9uRXZlbnQsCiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lIDogY2xhc3NOYW1lCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBmaXJlQmVmb3JlQ2FsbGJhY2tBc3luYygpIHsKICAgICAgICAgICAgICBmaXJlRE9NQ2FsbGJhY2soJ2JlZm9yZScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBmaXJlQWZ0ZXJDYWxsYmFja0FzeW5jKCkgewogICAgICAgICAgICAgIGZpcmVET01DYWxsYmFjaygnYWZ0ZXInKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gZmlyZURvbmVDYWxsYmFja0FzeW5jKCkgewogICAgICAgICAgICAgIGZpcmVET01DYWxsYmFjaygnY2xvc2UnKTsKICAgICAgICAgICAgICBpZihkb25lQ2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICQkYXN5bmNDYWxsYmFjayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgZG9uZUNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vaXQgaXMgbGVzcyBjb21wbGljYXRlZCB0byB1c2UgYSBmbGFnIHRoYW4gbWFuYWdpbmcgYW5kIGNhbmNlbGluZwogICAgICAgICAgICAvL3RpbWVvdXRzIGNvbnRhaW5pbmcgbXVsdGlwbGUgY2FsbGJhY2tzLgogICAgICAgICAgICBmdW5jdGlvbiBmaXJlRE9NT3BlcmF0aW9uKCkgewogICAgICAgICAgICAgIGlmKCFmaXJlRE9NT3BlcmF0aW9uLmhhc0JlZW5SdW4pIHsKICAgICAgICAgICAgICAgIGZpcmVET01PcGVyYXRpb24uaGFzQmVlblJ1biA9IHRydWU7CiAgICAgICAgICAgICAgICBkb21PcGVyYXRpb24oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGNsb3NlQW5pbWF0aW9uKCkgewogICAgICAgICAgICAgIGlmKCFjbG9zZUFuaW1hdGlvbi5oYXNCZWVuUnVuKSB7CiAgICAgICAgICAgICAgICBjbG9zZUFuaW1hdGlvbi5oYXNCZWVuUnVuID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpOwogICAgICAgICAgICAgICAgaWYoZGF0YSkgewogICAgICAgICAgICAgICAgICAvKiBvbmx5IHN0cnVjdHVyYWwgYW5pbWF0aW9ucyB3YWl0IGZvciByZWZsb3cgYmVmb3JlIHJlbW92aW5nIGFuCiAgICAgICAgICAgICAgICAgICBhbmltYXRpb24sIGJ1dCBjbGFzcy1iYXNlZCBhbmltYXRpb25zIGRvbid0LiBBbiBleGFtcGxlIG9mIHRoaXMKICAgICAgICAgICAgICAgICAgIGZhaWxpbmcgd291bGQgYmUgd2hlbiBhIHBhcmVudCBIVE1MIHRhZyBoYXMgYSBuZy1jbGFzcyBhdHRyaWJ1dGUKICAgICAgICAgICAgICAgICAgIGNhdXNpbmcgQUxMIGRpcmVjdGl2ZXMgYmVsb3cgdG8gc2tpcCBhbmltYXRpb25zIGR1cmluZyB0aGUgZGlnZXN0ICovCiAgICAgICAgICAgICAgICAgIGlmKHJ1bm5lciAmJiBydW5uZXIuaXNDbGFzc0Jhc2VkKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICQkYXN5bmNDYWxsYmFjayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgaWYobG9jYWxBbmltYXRpb25Db3VudCA9PSBkYXRhLmluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25FdmVudCk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUsIGRhdGEpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmaXJlRG9uZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBjYW5jZWxDaGlsZEFuaW1hdGlvbnMoZWxlbWVudCkgewogICAgICAgICAgICB2YXIgbm9kZSA9IGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KTsKICAgICAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgICB2YXIgbm9kZXMgPSBhbmd1bGFyLmlzRnVuY3Rpb24obm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKSA/CiAgICAgICAgICAgICAgICBub2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoTkdfQU5JTUFURV9DTEFTU19OQU1FKSA6CiAgICAgICAgICAgICAgICBub2RlLnF1ZXJ5U2VsZWN0b3JBbGwoJy4nICsgTkdfQU5JTUFURV9DTEFTU19OQU1FKTsKICAgICAgICAgICAgICBmb3JFYWNoKG5vZGVzLCBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICAgICAgICBpZihkYXRhICYmIGRhdGEuYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgIGZvckVhY2goZGF0YS5hY3RpdmUsIGZ1bmN0aW9uKHJ1bm5lcikgewogICAgICAgICAgICAgICAgICAgIHJ1bm5lci5jYW5jZWwoKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBjbGVhbnVwKGVsZW1lbnQsIGNsYXNzTmFtZSkgewogICAgICAgICAgICBpZihpc01hdGNoaW5nRWxlbWVudChlbGVtZW50LCAkcm9vdEVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgaWYoIXJvb3RBbmltYXRlU3RhdGUuZGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgIHJvb3RBbmltYXRlU3RhdGUucnVubmluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcm9vdEFuaW1hdGVTdGF0ZS5zdHJ1Y3R1cmFsID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYoY2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSkgfHwge307CgogICAgICAgICAgICAgIHZhciByZW1vdmVBbmltYXRpb25zID0gY2xhc3NOYW1lID09PSB0cnVlOwogICAgICAgICAgICAgIGlmKCFyZW1vdmVBbmltYXRpb25zICYmIGRhdGEuYWN0aXZlICYmIGRhdGEuYWN0aXZlW2NsYXNzTmFtZV0pIHsKICAgICAgICAgICAgICAgIGRhdGEudG90YWxBY3RpdmUtLTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLmFjdGl2ZVtjbGFzc05hbWVdOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYocmVtb3ZlQW5pbWF0aW9ucyB8fCAhZGF0YS50b3RhbEFjdGl2ZSkgewogICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhOR19BTklNQVRFX0NMQVNTX05BTUUpOwogICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVEYXRhKE5HX0FOSU1BVEVfU1RBVEUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGFuaW1hdGlvbnNEaXNhYmxlZChlbGVtZW50LCBwYXJlbnRFbGVtZW50KSB7CiAgICAgICAgICAgIGlmIChyb290QW5pbWF0ZVN0YXRlLmRpc2FibGVkKSByZXR1cm4gdHJ1ZTsKCiAgICAgICAgICAgIGlmKGlzTWF0Y2hpbmdFbGVtZW50KGVsZW1lbnQsICRyb290RWxlbWVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcm9vdEFuaW1hdGVTdGF0ZS5kaXNhYmxlZCB8fCByb290QW5pbWF0ZVN0YXRlLnJ1bm5pbmc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAvL3RoZSBlbGVtZW50IGRpZCBub3QgcmVhY2ggdGhlIHJvb3QgZWxlbWVudCB3aGljaCBtZWFucyB0aGF0IGl0CiAgICAgICAgICAgICAgLy9pcyBub3QgYXBhcnQgb2YgdGhlIERPTS4gVGhlcmVmb3JlIHRoZXJlIGlzIG5vIHJlYXNvbiB0byBkbwogICAgICAgICAgICAgIC8vYW55IGFuaW1hdGlvbnMgb24gaXQKICAgICAgICAgICAgICBpZihwYXJlbnRFbGVtZW50Lmxlbmd0aCA9PT0gMCkgYnJlYWs7CgogICAgICAgICAgICAgIHZhciBpc1Jvb3QgPSBpc01hdGNoaW5nRWxlbWVudChwYXJlbnRFbGVtZW50LCAkcm9vdEVsZW1lbnQpOwogICAgICAgICAgICAgIHZhciBzdGF0ZSA9IGlzUm9vdCA/IHJvb3RBbmltYXRlU3RhdGUgOiBwYXJlbnRFbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHN0YXRlICYmICghIXN0YXRlLmRpc2FibGVkIHx8IHN0YXRlLnJ1bm5pbmcgfHwgc3RhdGUudG90YWxBY3RpdmUgPiAwKTsKICAgICAgICAgICAgICBpZihpc1Jvb3QgfHwgcmVzdWx0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYoaXNSb290KSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZShwYXJlbnRFbGVtZW50ID0gcGFyZW50RWxlbWVudC5wYXJlbnQoKSk7CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9XSk7CgogICAgICAkYW5pbWF0ZVByb3ZpZGVyLnJlZ2lzdGVyKCcnLCBbJyR3aW5kb3cnLCAnJHNuaWZmZXInLCAnJHRpbWVvdXQnLCAnJCRhbmltYXRlUmVmbG93JywKICAgICAgICBmdW5jdGlvbigkd2luZG93LCAgICRzbmlmZmVyLCAgICR0aW1lb3V0LCAgICQkYW5pbWF0ZVJlZmxvdykgewogICAgICAgICAgLy8gRGV0ZWN0IHByb3BlciB0cmFuc2l0aW9uZW5kL2FuaW1hdGlvbmVuZCBldmVudCBuYW1lcy4KICAgICAgICAgIHZhciBDU1NfUFJFRklYID0gJycsIFRSQU5TSVRJT05fUFJPUCwgVFJBTlNJVElPTkVORF9FVkVOVCwgQU5JTUFUSU9OX1BST1AsIEFOSU1BVElPTkVORF9FVkVOVDsKCiAgICAgICAgICAvLyBJZiB1bnByZWZpeGVkIGV2ZW50cyBhcmUgbm90IHN1cHBvcnRlZCBidXQgd2Via2l0LXByZWZpeGVkIGFyZSwgdXNlIHRoZSBsYXR0ZXIuCiAgICAgICAgICAvLyBPdGhlcndpc2UsIGp1c3QgdXNlIFczQyBuYW1lcywgYnJvd3NlcnMgbm90IHN1cHBvcnRpbmcgdGhlbSBhdCBhbGwgd2lsbCBqdXN0IGlnbm9yZSB0aGVtLgogICAgICAgICAgLy8gTm90ZTogQ2hyb21lIGltcGxlbWVudHMgYHdpbmRvdy5vbndlYmtpdGFuaW1hdGlvbmVuZGAgYW5kIGRvZXNuJ3QgaW1wbGVtZW50IGB3aW5kb3cub25hbmltYXRpb25lbmRgCiAgICAgICAgICAvLyBidXQgYXQgdGhlIHNhbWUgdGltZSBkaXNwYXRjaGVzIHRoZSBgYW5pbWF0aW9uZW5kYCBldmVudCBhbmQgbm90IGB3ZWJraXRBbmltYXRpb25FbmRgLgogICAgICAgICAgLy8gUmVnaXN0ZXIgYm90aCBldmVudHMgaW4gY2FzZSBgd2luZG93Lm9uYW5pbWF0aW9uZW5kYCBpcyBub3Qgc3VwcG9ydGVkIGJlY2F1c2Ugb2YgdGhhdCwKICAgICAgICAgIC8vIGRvIHRoZSBzYW1lIGZvciBgdHJhbnNpdGlvbmVuZGAgYXMgU2FmYXJpIGlzIGxpa2VseSB0byBleGhpYml0IHNpbWlsYXIgYmVoYXZpb3IuCiAgICAgICAgICAvLyBBbHNvLCB0aGUgb25seSBtb2Rlcm4gYnJvd3NlciB0aGF0IHVzZXMgdmVuZG9yIHByZWZpeGVzIGZvciB0cmFuc2l0aW9ucy9rZXlmcmFtZXMgaXMgd2Via2l0CiAgICAgICAgICAvLyB0aGVyZWZvcmUgdGhlcmUgaXMgbm8gcmVhc29uIHRvIHRlc3QgYW55bW9yZSBmb3Igb3RoZXIgdmVuZG9yIHByZWZpeGVzOiBodHRwOi8vY2FuaXVzZS5jb20vI3NlYXJjaD10cmFuc2l0aW9uCiAgICAgICAgICBpZiAod2luZG93Lm9udHJhbnNpdGlvbmVuZCA9PT0gdW5kZWZpbmVkICYmIHdpbmRvdy5vbndlYmtpdHRyYW5zaXRpb25lbmQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBDU1NfUFJFRklYID0gJy13ZWJraXQtJzsKICAgICAgICAgICAgVFJBTlNJVElPTl9QUk9QID0gJ1dlYmtpdFRyYW5zaXRpb24nOwogICAgICAgICAgICBUUkFOU0lUSU9ORU5EX0VWRU5UID0gJ3dlYmtpdFRyYW5zaXRpb25FbmQgdHJhbnNpdGlvbmVuZCc7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBUUkFOU0lUSU9OX1BST1AgPSAndHJhbnNpdGlvbic7CiAgICAgICAgICAgIFRSQU5TSVRJT05FTkRfRVZFTlQgPSAndHJhbnNpdGlvbmVuZCc7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHdpbmRvdy5vbmFuaW1hdGlvbmVuZCA9PT0gdW5kZWZpbmVkICYmIHdpbmRvdy5vbndlYmtpdGFuaW1hdGlvbmVuZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIENTU19QUkVGSVggPSAnLXdlYmtpdC0nOwogICAgICAgICAgICBBTklNQVRJT05fUFJPUCA9ICdXZWJraXRBbmltYXRpb24nOwogICAgICAgICAgICBBTklNQVRJT05FTkRfRVZFTlQgPSAnd2Via2l0QW5pbWF0aW9uRW5kIGFuaW1hdGlvbmVuZCc7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBBTklNQVRJT05fUFJPUCA9ICdhbmltYXRpb24nOwogICAgICAgICAgICBBTklNQVRJT05FTkRfRVZFTlQgPSAnYW5pbWF0aW9uZW5kJzsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgRFVSQVRJT05fS0VZID0gJ0R1cmF0aW9uJzsKICAgICAgICAgIHZhciBQUk9QRVJUWV9LRVkgPSAnUHJvcGVydHknOwogICAgICAgICAgdmFyIERFTEFZX0tFWSA9ICdEZWxheSc7CiAgICAgICAgICB2YXIgQU5JTUFUSU9OX0lURVJBVElPTl9DT1VOVF9LRVkgPSAnSXRlcmF0aW9uQ291bnQnOwogICAgICAgICAgdmFyIE5HX0FOSU1BVEVfUEFSRU5UX0tFWSA9ICckJG5nQW5pbWF0ZUtleSc7CiAgICAgICAgICB2YXIgTkdfQU5JTUFURV9DU1NfREFUQV9LRVkgPSAnJCRuZ0FuaW1hdGVDU1MzRGF0YSc7CiAgICAgICAgICB2YXIgTkdfQU5JTUFURV9CTE9DS19DTEFTU19OQU1FID0gJ25nLWFuaW1hdGUtYmxvY2stdHJhbnNpdGlvbnMnOwogICAgICAgICAgdmFyIEVMQVBTRURfVElNRV9NQVhfREVDSU1BTF9QTEFDRVMgPSAzOwogICAgICAgICAgdmFyIENMT1NJTkdfVElNRV9CVUZGRVIgPSAxLjU7CiAgICAgICAgICB2YXIgT05FX1NFQ09ORCA9IDEwMDA7CgogICAgICAgICAgdmFyIGxvb2t1cENhY2hlID0ge307CiAgICAgICAgICB2YXIgcGFyZW50Q291bnRlciA9IDA7CiAgICAgICAgICB2YXIgYW5pbWF0aW9uUmVmbG93UXVldWUgPSBbXTsKICAgICAgICAgIHZhciBjYW5jZWxBbmltYXRpb25SZWZsb3c7CiAgICAgICAgICBmdW5jdGlvbiBhZnRlclJlZmxvdyhlbGVtZW50LCBjYWxsYmFjaykgewogICAgICAgICAgICBpZihjYW5jZWxBbmltYXRpb25SZWZsb3cpIHsKICAgICAgICAgICAgICBjYW5jZWxBbmltYXRpb25SZWZsb3coKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhbmltYXRpb25SZWZsb3dRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uUmVmbG93ID0gJCRhbmltYXRlUmVmbG93KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGZvckVhY2goYW5pbWF0aW9uUmVmbG93UXVldWUsIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBhbmltYXRpb25SZWZsb3dRdWV1ZSA9IFtdOwogICAgICAgICAgICAgIGNhbmNlbEFuaW1hdGlvblJlZmxvdyA9IG51bGw7CiAgICAgICAgICAgICAgbG9va3VwQ2FjaGUgPSB7fTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGNsb3NpbmdUaW1lciA9IG51bGw7CiAgICAgICAgICB2YXIgY2xvc2luZ1RpbWVzdGFtcCA9IDA7CiAgICAgICAgICB2YXIgYW5pbWF0aW9uRWxlbWVudFF1ZXVlID0gW107CiAgICAgICAgICBmdW5jdGlvbiBhbmltYXRpb25DbG9zZUhhbmRsZXIoZWxlbWVudCwgdG90YWxUaW1lKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwogICAgICAgICAgICBlbGVtZW50ID0gYW5ndWxhci5lbGVtZW50KG5vZGUpOwoKICAgICAgICAgICAgLy90aGlzIGl0ZW0gd2lsbCBiZSBnYXJiYWdlIGNvbGxlY3RlZCBieSB0aGUgY2xvc2luZwogICAgICAgICAgICAvL2FuaW1hdGlvbiB0aW1lb3V0CiAgICAgICAgICAgIGFuaW1hdGlvbkVsZW1lbnRRdWV1ZS5wdXNoKGVsZW1lbnQpOwoKICAgICAgICAgICAgLy9idXQgaXQgbWF5IG5vdCBuZWVkIHRvIGNhbmNlbCBvdXQgdGhlIGV4aXN0aW5nIHRpbWVvdXQKICAgICAgICAgICAgLy9pZiB0aGUgdGltZXN0YW1wIGlzIGxlc3MgdGhhbiB0aGUgcHJldmlvdXMgb25lCiAgICAgICAgICAgIHZhciBmdXR1cmVUaW1lc3RhbXAgPSBEYXRlLm5vdygpICsgdG90YWxUaW1lOwogICAgICAgICAgICBpZihmdXR1cmVUaW1lc3RhbXAgPD0gY2xvc2luZ1RpbWVzdGFtcCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHRpbWVvdXQuY2FuY2VsKGNsb3NpbmdUaW1lcik7CgogICAgICAgICAgICBjbG9zaW5nVGltZXN0YW1wID0gZnV0dXJlVGltZXN0YW1wOwogICAgICAgICAgICBjbG9zaW5nVGltZXIgPSAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjbG9zZUFsbEFuaW1hdGlvbnMoYW5pbWF0aW9uRWxlbWVudFF1ZXVlKTsKICAgICAgICAgICAgICBhbmltYXRpb25FbGVtZW50UXVldWUgPSBbXTsKICAgICAgICAgICAgfSwgdG90YWxUaW1lLCBmYWxzZSk7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gY2xvc2VBbGxBbmltYXRpb25zKGVsZW1lbnRzKSB7CiAgICAgICAgICAgIGZvckVhY2goZWxlbWVudHMsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudERhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9DU1NfREFUQV9LRVkpOwogICAgICAgICAgICAgIGlmKGVsZW1lbnREYXRhKSB7CiAgICAgICAgICAgICAgICAoZWxlbWVudERhdGEuY2xvc2VBbmltYXRpb25GbiB8fCBub29wKSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gZ2V0RWxlbWVudEFuaW1hdGlvbkRldGFpbHMoZWxlbWVudCwgY2FjaGVLZXkpIHsKICAgICAgICAgICAgdmFyIGRhdGEgPSBjYWNoZUtleSA/IGxvb2t1cENhY2hlW2NhY2hlS2V5XSA6IG51bGw7CiAgICAgICAgICAgIGlmKCFkYXRhKSB7CiAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb25EdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb25EZWxheSA9IDA7CiAgICAgICAgICAgICAgdmFyIGFuaW1hdGlvbkR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB2YXIgYW5pbWF0aW9uRGVsYXkgPSAwOwogICAgICAgICAgICAgIHZhciB0cmFuc2l0aW9uRGVsYXlTdHlsZTsKICAgICAgICAgICAgICB2YXIgYW5pbWF0aW9uRGVsYXlTdHlsZTsKICAgICAgICAgICAgICB2YXIgdHJhbnNpdGlvbkR1cmF0aW9uU3R5bGU7CiAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb25Qcm9wZXJ0eVN0eWxlOwoKICAgICAgICAgICAgICAvL3dlIHdhbnQgYWxsIHRoZSBzdHlsZXMgZGVmaW5lZCBiZWZvcmUgYW5kIGFmdGVyCiAgICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50LCBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGVsZW1lbnRTdHlsZXMgPSAkd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWxlbWVudCkgfHwge307CgogICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uRHVyYXRpb25TdHlsZSA9IGVsZW1lbnRTdHlsZXNbVFJBTlNJVElPTl9QUk9QICsgRFVSQVRJT05fS0VZXTsKCiAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvbiA9IE1hdGgubWF4KHBhcnNlTWF4VGltZSh0cmFuc2l0aW9uRHVyYXRpb25TdHlsZSksIHRyYW5zaXRpb25EdXJhdGlvbik7CgogICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uUHJvcGVydHlTdHlsZSA9IGVsZW1lbnRTdHlsZXNbVFJBTlNJVElPTl9QUk9QICsgUFJPUEVSVFlfS0VZXTsKCiAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb25EZWxheVN0eWxlID0gZWxlbWVudFN0eWxlc1tUUkFOU0lUSU9OX1BST1AgKyBERUxBWV9LRVldOwoKICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbkRlbGF5ICA9IE1hdGgubWF4KHBhcnNlTWF4VGltZSh0cmFuc2l0aW9uRGVsYXlTdHlsZSksIHRyYW5zaXRpb25EZWxheSk7CgogICAgICAgICAgICAgICAgICBhbmltYXRpb25EZWxheVN0eWxlID0gZWxlbWVudFN0eWxlc1tBTklNQVRJT05fUFJPUCArIERFTEFZX0tFWV07CgogICAgICAgICAgICAgICAgICBhbmltYXRpb25EZWxheSAgID0gTWF0aC5tYXgocGFyc2VNYXhUaW1lKGFuaW1hdGlvbkRlbGF5U3R5bGUpLCBhbmltYXRpb25EZWxheSk7CgogICAgICAgICAgICAgICAgICB2YXIgYUR1cmF0aW9uICA9IHBhcnNlTWF4VGltZShlbGVtZW50U3R5bGVzW0FOSU1BVElPTl9QUk9QICsgRFVSQVRJT05fS0VZXSk7CgogICAgICAgICAgICAgICAgICBpZihhRHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgYUR1cmF0aW9uICo9IHBhcnNlSW50KGVsZW1lbnRTdHlsZXNbQU5JTUFUSU9OX1BST1AgKyBBTklNQVRJT05fSVRFUkFUSU9OX0NPVU5UX0tFWV0sIDEwKSB8fCAxOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBhbmltYXRpb25EdXJhdGlvbiA9IE1hdGgubWF4KGFEdXJhdGlvbiwgYW5pbWF0aW9uRHVyYXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGRhdGEgPSB7CiAgICAgICAgICAgICAgICB0b3RhbCA6IDAsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uUHJvcGVydHlTdHlsZTogdHJhbnNpdGlvblByb3BlcnR5U3R5bGUsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uRHVyYXRpb25TdHlsZTogdHJhbnNpdGlvbkR1cmF0aW9uU3R5bGUsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uRGVsYXlTdHlsZTogdHJhbnNpdGlvbkRlbGF5U3R5bGUsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uRGVsYXk6IHRyYW5zaXRpb25EZWxheSwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvbjogdHJhbnNpdGlvbkR1cmF0aW9uLAogICAgICAgICAgICAgICAgYW5pbWF0aW9uRGVsYXlTdHlsZTogYW5pbWF0aW9uRGVsYXlTdHlsZSwKICAgICAgICAgICAgICAgIGFuaW1hdGlvbkRlbGF5OiBhbmltYXRpb25EZWxheSwKICAgICAgICAgICAgICAgIGFuaW1hdGlvbkR1cmF0aW9uOiBhbmltYXRpb25EdXJhdGlvbgogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYoY2FjaGVLZXkpIHsKICAgICAgICAgICAgICAgIGxvb2t1cENhY2hlW2NhY2hlS2V5XSA9IGRhdGE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBkYXRhOwogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIHBhcnNlTWF4VGltZShzdHIpIHsKICAgICAgICAgICAgdmFyIG1heFZhbHVlID0gMDsKICAgICAgICAgICAgdmFyIHZhbHVlcyA9IGFuZ3VsYXIuaXNTdHJpbmcoc3RyKSA/CiAgICAgICAgICAgICAgc3RyLnNwbGl0KC9ccyosXHMqLykgOgogICAgICAgICAgICAgIFtdOwogICAgICAgICAgICBmb3JFYWNoKHZhbHVlcywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBtYXhWYWx1ZSA9IE1hdGgubWF4KHBhcnNlRmxvYXQodmFsdWUpIHx8IDAsIG1heFZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBtYXhWYWx1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBnZXRDYWNoZUtleShlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRFbGVtZW50ID0gZWxlbWVudC5wYXJlbnQoKTsKICAgICAgICAgICAgdmFyIHBhcmVudElEID0gcGFyZW50RWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfUEFSRU5UX0tFWSk7CiAgICAgICAgICAgIGlmKCFwYXJlbnRJRCkgewogICAgICAgICAgICAgIHBhcmVudEVsZW1lbnQuZGF0YShOR19BTklNQVRFX1BBUkVOVF9LRVksICsrcGFyZW50Q291bnRlcik7CiAgICAgICAgICAgICAgcGFyZW50SUQgPSBwYXJlbnRDb3VudGVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwYXJlbnRJRCArICctJyArIGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJyk7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gYW5pbWF0ZVNldHVwKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGNhbGN1bGF0aW9uRGVjb3JhdG9yKSB7CiAgICAgICAgICAgIHZhciBjYWNoZUtleSA9IGdldENhY2hlS2V5KGVsZW1lbnQpOwogICAgICAgICAgICB2YXIgZXZlbnRDYWNoZUtleSA9IGNhY2hlS2V5ICsgJyAnICsgY2xhc3NOYW1lOwogICAgICAgICAgICB2YXIgaXRlbUluZGV4ID0gbG9va3VwQ2FjaGVbZXZlbnRDYWNoZUtleV0gPyArK2xvb2t1cENhY2hlW2V2ZW50Q2FjaGVLZXldLnRvdGFsIDogMDsKCiAgICAgICAgICAgIHZhciBzdGFnZ2VyID0ge307CiAgICAgICAgICAgIGlmKGl0ZW1JbmRleCA+IDApIHsKICAgICAgICAgICAgICB2YXIgc3RhZ2dlckNsYXNzTmFtZSA9IGNsYXNzTmFtZSArICctc3RhZ2dlcic7CiAgICAgICAgICAgICAgdmFyIHN0YWdnZXJDYWNoZUtleSA9IGNhY2hlS2V5ICsgJyAnICsgc3RhZ2dlckNsYXNzTmFtZTsKICAgICAgICAgICAgICB2YXIgYXBwbHlDbGFzc2VzID0gIWxvb2t1cENhY2hlW3N0YWdnZXJDYWNoZUtleV07CgogICAgICAgICAgICAgIGFwcGx5Q2xhc3NlcyAmJiBlbGVtZW50LmFkZENsYXNzKHN0YWdnZXJDbGFzc05hbWUpOwoKICAgICAgICAgICAgICBzdGFnZ2VyID0gZ2V0RWxlbWVudEFuaW1hdGlvbkRldGFpbHMoZWxlbWVudCwgc3RhZ2dlckNhY2hlS2V5KTsKCiAgICAgICAgICAgICAgYXBwbHlDbGFzc2VzICYmIGVsZW1lbnQucmVtb3ZlQ2xhc3Moc3RhZ2dlckNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qIHRoZSBhbmltYXRpb24gaXRzZWxmIG1heSBuZWVkIHRvIGFkZC9yZW1vdmUgc3BlY2lhbCBDU1MgY2xhc3NlcwogICAgICAgICAgICAgKiBiZWZvcmUgY2FsY3VsYXRpbmcgdGhlIGFubWF0aW9uIHN0eWxlcyAqLwogICAgICAgICAgICBjYWxjdWxhdGlvbkRlY29yYXRvciA9IGNhbGN1bGF0aW9uRGVjb3JhdG9yIHx8CiAgICAgICAgICAgICAgZnVuY3Rpb24oZm4pIHsgcmV0dXJuIGZuKCk7IH07CgogICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CgogICAgICAgICAgICB2YXIgZm9ybWVyRGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSkgfHwge307CgogICAgICAgICAgICB2YXIgdGltaW5ncyA9IGNhbGN1bGF0aW9uRGVjb3JhdG9yKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBnZXRFbGVtZW50QW5pbWF0aW9uRGV0YWlscyhlbGVtZW50LCBldmVudENhY2hlS2V5KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB2YXIgdHJhbnNpdGlvbkR1cmF0aW9uID0gdGltaW5ncy50cmFuc2l0aW9uRHVyYXRpb247CiAgICAgICAgICAgIHZhciBhbmltYXRpb25EdXJhdGlvbiA9IHRpbWluZ3MuYW5pbWF0aW9uRHVyYXRpb247CiAgICAgICAgICAgIGlmKHRyYW5zaXRpb25EdXJhdGlvbiA9PT0gMCAmJiBhbmltYXRpb25EdXJhdGlvbiA9PT0gMCkgewogICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSwgewogICAgICAgICAgICAgIHJ1bm5pbmcgOiBmb3JtZXJEYXRhLnJ1bm5pbmcgfHwgMCwKICAgICAgICAgICAgICBpdGVtSW5kZXggOiBpdGVtSW5kZXgsCiAgICAgICAgICAgICAgc3RhZ2dlciA6IHN0YWdnZXIsCiAgICAgICAgICAgICAgdGltaW5ncyA6IHRpbWluZ3MsCiAgICAgICAgICAgICAgY2xvc2VBbmltYXRpb25GbiA6IG5vb3AKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvL3RlbXBvcmFyaWx5IGRpc2FibGUgdGhlIHRyYW5zaXRpb24gc28gdGhhdCB0aGUgZW50ZXIgc3R5bGVzCiAgICAgICAgICAgIC8vZG9uJ3QgYW5pbWF0ZSB0d2ljZSAodGhpcyBpcyBoZXJlIHRvIGF2b2lkIGEgYnVnIGluIENocm9tZS9GRikuCiAgICAgICAgICAgIHZhciBpc0N1cnJlbnRseUFuaW1hdGluZyA9IGZvcm1lckRhdGEucnVubmluZyA+IDAgfHwgYW5pbWF0aW9uRXZlbnQgPT0gJ3NldENsYXNzJzsKICAgICAgICAgICAgaWYodHJhbnNpdGlvbkR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgIGJsb2NrVHJhbnNpdGlvbnMoZWxlbWVudCwgY2xhc3NOYW1lLCBpc0N1cnJlbnRseUFuaW1hdGluZyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vc3RhZ2dlcmluZyBrZXlmcmFtZSBhbmltYXRpb25zIHdvcmsgYnkgYWRqdXN0aW5nIHRoZSBgYW5pbWF0aW9uLWRlbGF5YCBDU1MgcHJvcGVydHkKICAgICAgICAgICAgLy9vbiB0aGUgZ2l2ZW4gZWxlbWVudCwgaG93ZXZlciwgdGhlIGRlbGF5IHZhbHVlIGNhbiBvbmx5IGNhbGN1bGF0ZWQgYWZ0ZXIgdGhlIHJlZmxvdwogICAgICAgICAgICAvL3NpbmNlIGJ5IHRoYXQgdGltZSAkYW5pbWF0ZSBrbm93cyBob3cgbWFueSBlbGVtZW50cyBhcmUgYmVpbmcgYW5pbWF0ZWQuIFRoZXJlZm9yZSwKICAgICAgICAgICAgLy91bnRpbCB0aGUgcmVmbG93IG9jY3VycyB0aGUgZWxlbWVudCBuZWVkcyB0byBiZSBibG9ja2VkICh3aGVyZSB0aGUga2V5ZnJhbWUgYW5pbWF0aW9uCiAgICAgICAgICAgIC8vaXMgc2V0IHRvIGBub25lIDBzYCkuIFRoaXMgYmxvY2tpbmcgbWVjaGFuaXNtIHNob3VsZCBvbmx5IGJlIHNldCBmb3Igd2hlbiBhIHN0YWdnZXIKICAgICAgICAgICAgLy9hbmltYXRpb24gaXMgZGV0ZWN0ZWQgYW5kIHdoZW4gdGhlIGVsZW1lbnQgaXRlbSBpbmRleCBpcyBncmVhdGVyIHRoYW4gMC4KICAgICAgICAgICAgaWYoYW5pbWF0aW9uRHVyYXRpb24gPiAwICYmIHN0YWdnZXIuYW5pbWF0aW9uRGVsYXkgPiAwICYmIHN0YWdnZXIuYW5pbWF0aW9uRHVyYXRpb24gPT09IDApIHsKICAgICAgICAgICAgICBibG9ja0tleWZyYW1lQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gaXNTdHJ1Y3R1cmFsQW5pbWF0aW9uKGNsYXNzTmFtZSkgewogICAgICAgICAgICByZXR1cm4gY2xhc3NOYW1lID09ICduZy1lbnRlcicgfHwgY2xhc3NOYW1lID09ICduZy1tb3ZlJyB8fCBjbGFzc05hbWUgPT0gJ25nLWxlYXZlJzsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBibG9ja1RyYW5zaXRpb25zKGVsZW1lbnQsIGNsYXNzTmFtZSwgaXNBbmltYXRpbmcpIHsKICAgICAgICAgICAgaWYoaXNTdHJ1Y3R1cmFsQW5pbWF0aW9uKGNsYXNzTmFtZSkgfHwgIWlzQW5pbWF0aW5nKSB7CiAgICAgICAgICAgICAgZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpLnN0eWxlW1RSQU5TSVRJT05fUFJPUCArIFBST1BFUlRZX0tFWV0gPSAnbm9uZSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhOR19BTklNQVRFX0JMT0NLX0NMQVNTX05BTUUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gYmxvY2tLZXlmcmFtZUFuaW1hdGlvbnMoZWxlbWVudCkgewogICAgICAgICAgICBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCkuc3R5bGVbQU5JTUFUSU9OX1BST1BdID0gJ25vbmUgMHMnOwogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIHVuYmxvY2tUcmFuc2l0aW9ucyhlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICAgICAgdmFyIHByb3AgPSBUUkFOU0lUSU9OX1BST1AgKyBQUk9QRVJUWV9LRVk7CiAgICAgICAgICAgIHZhciBub2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwogICAgICAgICAgICBpZihub2RlLnN0eWxlW3Byb3BdICYmIG5vZGUuc3R5bGVbcHJvcF0ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIG5vZGUuc3R5bGVbcHJvcF0gPSAnJzsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKE5HX0FOSU1BVEVfQkxPQ0tfQ0xBU1NfTkFNRSk7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gdW5ibG9ja0tleWZyYW1lQW5pbWF0aW9ucyhlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBwcm9wID0gQU5JTUFUSU9OX1BST1A7CiAgICAgICAgICAgIHZhciBub2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwogICAgICAgICAgICBpZihub2RlLnN0eWxlW3Byb3BdICYmIG5vZGUuc3R5bGVbcHJvcF0ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIG5vZGUuc3R5bGVbcHJvcF0gPSAnJzsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGFuaW1hdGVSdW4oYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYWN0aXZlQW5pbWF0aW9uQ29tcGxldGUpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgICAgIHZhciBlbGVtZW50RGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSk7CiAgICAgICAgICAgIGlmKG5vZGUuZ2V0QXR0cmlidXRlKCdjbGFzcycpLmluZGV4T2YoY2xhc3NOYW1lKSA9PSAtMSB8fCAhZWxlbWVudERhdGEpIHsKICAgICAgICAgICAgICBhY3RpdmVBbmltYXRpb25Db21wbGV0ZSgpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGFjdGl2ZUNsYXNzTmFtZSA9ICcnOwogICAgICAgICAgICBmb3JFYWNoKGNsYXNzTmFtZS5zcGxpdCgnICcpLCBmdW5jdGlvbihrbGFzcywgaSkgewogICAgICAgICAgICAgIGFjdGl2ZUNsYXNzTmFtZSArPSAoaSA+IDAgPyAnICcgOiAnJykgKyBrbGFzcyArICctYWN0aXZlJzsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB2YXIgc3RhZ2dlciA9IGVsZW1lbnREYXRhLnN0YWdnZXI7CiAgICAgICAgICAgIHZhciB0aW1pbmdzID0gZWxlbWVudERhdGEudGltaW5nczsKICAgICAgICAgICAgdmFyIGl0ZW1JbmRleCA9IGVsZW1lbnREYXRhLml0ZW1JbmRleDsKICAgICAgICAgICAgdmFyIG1heER1cmF0aW9uID0gTWF0aC5tYXgodGltaW5ncy50cmFuc2l0aW9uRHVyYXRpb24sIHRpbWluZ3MuYW5pbWF0aW9uRHVyYXRpb24pOwogICAgICAgICAgICB2YXIgbWF4RGVsYXkgPSBNYXRoLm1heCh0aW1pbmdzLnRyYW5zaXRpb25EZWxheSwgdGltaW5ncy5hbmltYXRpb25EZWxheSk7CiAgICAgICAgICAgIHZhciBtYXhEZWxheVRpbWUgPSBtYXhEZWxheSAqIE9ORV9TRUNPTkQ7CgogICAgICAgICAgICB2YXIgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgdmFyIGNzczNBbmltYXRpb25FdmVudHMgPSBBTklNQVRJT05FTkRfRVZFTlQgKyAnICcgKyBUUkFOU0lUSU9ORU5EX0VWRU5UOwoKICAgICAgICAgICAgdmFyIHN0eWxlID0gJycsIGFwcGxpZWRTdHlsZXMgPSBbXTsKICAgICAgICAgICAgaWYodGltaW5ncy50cmFuc2l0aW9uRHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgdmFyIHByb3BlcnR5U3R5bGUgPSB0aW1pbmdzLnRyYW5zaXRpb25Qcm9wZXJ0eVN0eWxlOwogICAgICAgICAgICAgIGlmKHByb3BlcnR5U3R5bGUuaW5kZXhPZignYWxsJykgPT0gLTEpIHsKICAgICAgICAgICAgICAgIHN0eWxlICs9IENTU19QUkVGSVggKyAndHJhbnNpdGlvbi1wcm9wZXJ0eTogJyArIHByb3BlcnR5U3R5bGUgKyAnOyc7CiAgICAgICAgICAgICAgICBzdHlsZSArPSBDU1NfUFJFRklYICsgJ3RyYW5zaXRpb24tZHVyYXRpb246ICcgKyB0aW1pbmdzLnRyYW5zaXRpb25EdXJhdGlvblN0eWxlICsgJzsnOwogICAgICAgICAgICAgICAgYXBwbGllZFN0eWxlcy5wdXNoKENTU19QUkVGSVggKyAndHJhbnNpdGlvbi1wcm9wZXJ0eScpOwogICAgICAgICAgICAgICAgYXBwbGllZFN0eWxlcy5wdXNoKENTU19QUkVGSVggKyAndHJhbnNpdGlvbi1kdXJhdGlvbicpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoaXRlbUluZGV4ID4gMCkgewogICAgICAgICAgICAgIGlmKHN0YWdnZXIudHJhbnNpdGlvbkRlbGF5ID4gMCAmJiBzdGFnZ2VyLnRyYW5zaXRpb25EdXJhdGlvbiA9PT0gMCkgewogICAgICAgICAgICAgICAgdmFyIGRlbGF5U3R5bGUgPSB0aW1pbmdzLnRyYW5zaXRpb25EZWxheVN0eWxlOwogICAgICAgICAgICAgICAgc3R5bGUgKz0gQ1NTX1BSRUZJWCArICd0cmFuc2l0aW9uLWRlbGF5OiAnICsKICAgICAgICAgICAgICAgICAgcHJlcGFyZVN0YWdnZXJEZWxheShkZWxheVN0eWxlLCBzdGFnZ2VyLnRyYW5zaXRpb25EZWxheSwgaXRlbUluZGV4KSArICc7ICc7CiAgICAgICAgICAgICAgICBhcHBsaWVkU3R5bGVzLnB1c2goQ1NTX1BSRUZJWCArICd0cmFuc2l0aW9uLWRlbGF5Jyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZihzdGFnZ2VyLmFuaW1hdGlvbkRlbGF5ID4gMCAmJiBzdGFnZ2VyLmFuaW1hdGlvbkR1cmF0aW9uID09PSAwKSB7CiAgICAgICAgICAgICAgICBzdHlsZSArPSBDU1NfUFJFRklYICsgJ2FuaW1hdGlvbi1kZWxheTogJyArCiAgICAgICAgICAgICAgICAgIHByZXBhcmVTdGFnZ2VyRGVsYXkodGltaW5ncy5hbmltYXRpb25EZWxheVN0eWxlLCBzdGFnZ2VyLmFuaW1hdGlvbkRlbGF5LCBpdGVtSW5kZXgpICsgJzsgJzsKICAgICAgICAgICAgICAgIGFwcGxpZWRTdHlsZXMucHVzaChDU1NfUFJFRklYICsgJ2FuaW1hdGlvbi1kZWxheScpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoYXBwbGllZFN0eWxlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgLy90aGUgZWxlbWVudCBiZWluZyBhbmltYXRlZCBtYXkgc29tZXRpbWVzIGNvbnRhaW4gY29tbWVudCBub2RlcyBpbgogICAgICAgICAgICAgIC8vdGhlIGpxTGl0ZSBvYmplY3QsIHNvIHdlJ3JlIHNhZmUgdG8gdXNlIGEgc2luZ2xlIHZhcmlhYmxlIHRvIGhvdXNlCiAgICAgICAgICAgICAgLy90aGUgc3R5bGVzIHNpbmNlIHRoZXJlIGlzIGFsd2F5cyBvbmx5IG9uZSBlbGVtZW50IGJlaW5nIGFuaW1hdGVkCiAgICAgICAgICAgICAgdmFyIG9sZFN0eWxlID0gbm9kZS5nZXRBdHRyaWJ1dGUoJ3N0eWxlJykgfHwgJyc7CiAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgb2xkU3R5bGUgKyAnOyAnICsgc3R5bGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBlbGVtZW50Lm9uKGNzczNBbmltYXRpb25FdmVudHMsIG9uQW5pbWF0aW9uUHJvZ3Jlc3MpOwogICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGFjdGl2ZUNsYXNzTmFtZSk7CiAgICAgICAgICAgIGVsZW1lbnREYXRhLmNsb3NlQW5pbWF0aW9uRm4gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBvbkVuZCgpOwogICAgICAgICAgICAgIGFjdGl2ZUFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgc3RhZ2dlclRpbWUgICAgICAgPSBpdGVtSW5kZXggKiAoTWF0aC5tYXgoc3RhZ2dlci5hbmltYXRpb25EZWxheSwgc3RhZ2dlci50cmFuc2l0aW9uRGVsYXkpIHx8IDApOwogICAgICAgICAgICB2YXIgYW5pbWF0aW9uVGltZSAgICAgPSAobWF4RGVsYXkgKyBtYXhEdXJhdGlvbikgKiBDTE9TSU5HX1RJTUVfQlVGRkVSOwogICAgICAgICAgICB2YXIgdG90YWxUaW1lICAgICAgICAgPSAoc3RhZ2dlclRpbWUgKyBhbmltYXRpb25UaW1lKSAqIE9ORV9TRUNPTkQ7CgogICAgICAgICAgICBlbGVtZW50RGF0YS5ydW5uaW5nKys7CiAgICAgICAgICAgIGFuaW1hdGlvbkNsb3NlSGFuZGxlcihlbGVtZW50LCB0b3RhbFRpbWUpOwogICAgICAgICAgICByZXR1cm4gb25FbmQ7CgogICAgICAgICAgICAvLyBUaGlzIHdpbGwgYXV0b21hdGljYWxseSBiZSBjYWxsZWQgYnkgJGFuaW1hdGUgc28KICAgICAgICAgICAgLy8gdGhlcmUgaXMgbm8gbmVlZCB0byBhdHRhY2ggdGhpcyBpbnRlcm5hbGx5IHRvIHRoZQogICAgICAgICAgICAvLyB0aW1lb3V0IGRvbmUgbWV0aG9kLgogICAgICAgICAgICBmdW5jdGlvbiBvbkVuZChjYW5jZWxsZWQpIHsKICAgICAgICAgICAgICBlbGVtZW50Lm9mZihjc3MzQW5pbWF0aW9uRXZlbnRzLCBvbkFuaW1hdGlvblByb2dyZXNzKTsKICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGFjdGl2ZUNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgYW5pbWF0ZUNsb3NlKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBhcHBsaWVkU3R5bGVzKSB7CiAgICAgICAgICAgICAgICBub2RlLnN0eWxlLnJlbW92ZVByb3BlcnR5KGFwcGxpZWRTdHlsZXNbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gb25BbmltYXRpb25Qcm9ncmVzcyhldmVudCkgewogICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIHZhciBldiA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgfHwgZXZlbnQ7CiAgICAgICAgICAgICAgdmFyIHRpbWVTdGFtcCA9IGV2LiRtYW51YWxUaW1lU3RhbXAgfHwgZXYudGltZVN0YW1wIHx8IERhdGUubm93KCk7CgogICAgICAgICAgICAgIC8qIEZpcmVmb3ggKG9yIHBvc3NpYmx5IGp1c3QgR2Vja28pIGxpa2VzIHRvIG5vdCByb3VuZCB2YWx1ZXMgdXAKICAgICAgICAgICAgICAgKiB3aGVuIGEgbXMgbWVhc3VyZW1lbnQgaXMgdXNlZCBmb3IgdGhlIGFuaW1hdGlvbiAqLwogICAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IHBhcnNlRmxvYXQoZXYuZWxhcHNlZFRpbWUudG9GaXhlZChFTEFQU0VEX1RJTUVfTUFYX0RFQ0lNQUxfUExBQ0VTKSk7CgogICAgICAgICAgICAgIC8qICRtYW51YWxUaW1lU3RhbXAgaXMgYSBtb2NrZWQgdGltZVN0YW1wIHZhbHVlIHdoaWNoIGlzIHNldAogICAgICAgICAgICAgICAqIHdpdGhpbiBicm93c2VyVHJpZ2dlcigpLiBUaGlzIGlzIG9ubHkgaGVyZSBzbyB0aGF0IHRlc3RzIGNhbgogICAgICAgICAgICAgICAqIG1vY2sgYW5pbWF0aW9ucyBwcm9wZXJseS4gUmVhbCBldmVudHMgZmFsbGJhY2sgdG8gZXZlbnQudGltZVN0YW1wLAogICAgICAgICAgICAgICAqIG9yLCBpZiB0aGV5IGRvbid0LCB0aGVuIGEgdGltZVN0YW1wIGlzIGF1dG9tYXRpY2FsbHkgY3JlYXRlZCBmb3IgdGhlbS4KICAgICAgICAgICAgICAgKiBXZSdyZSBjaGVja2luZyB0byBzZWUgaWYgdGhlIHRpbWVTdGFtcCBzdXJwYXNzZXMgdGhlIGV4cGVjdGVkIGRlbGF5LAogICAgICAgICAgICAgICAqIGJ1dCB3ZSdyZSB1c2luZyBlbGFwc2VkVGltZSBpbnN0ZWFkIG9mIHRoZSB0aW1lU3RhbXAgb24gdGhlIDJuZAogICAgICAgICAgICAgICAqIHByZS1jb25kaXRpb24gc2luY2UgYW5pbWF0aW9ucyBzb21ldGltZXMgY2xvc2Ugb2ZmIGVhcmx5ICovCiAgICAgICAgICAgICAgaWYoTWF0aC5tYXgodGltZVN0YW1wIC0gc3RhcnRUaW1lLCAwKSA+PSBtYXhEZWxheVRpbWUgJiYgZWxhcHNlZFRpbWUgPj0gbWF4RHVyYXRpb24pIHsKICAgICAgICAgICAgICAgIGFjdGl2ZUFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVN0YWdnZXJEZWxheShkZWxheVN0eWxlLCBzdGFnZ2VyRGVsYXksIGluZGV4KSB7CiAgICAgICAgICAgIHZhciBzdHlsZSA9ICcnOwogICAgICAgICAgICBmb3JFYWNoKGRlbGF5U3R5bGUuc3BsaXQoJywnKSwgZnVuY3Rpb24odmFsLCBpKSB7CiAgICAgICAgICAgICAgc3R5bGUgKz0gKGkgPiAwID8gJywnIDogJycpICsKICAgICAgICAgICAgICAgIChpbmRleCAqIHN0YWdnZXJEZWxheSArIHBhcnNlSW50KHZhbCwgMTApKSArICdzJzsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBzdHlsZTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBhbmltYXRlQmVmb3JlKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGNhbGN1bGF0aW9uRGVjb3JhdG9yKSB7CiAgICAgICAgICAgIGlmKGFuaW1hdGVTZXR1cChhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lLCBjYWxjdWxhdGlvbkRlY29yYXRvcikpIHsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FuY2VsbGVkKSB7CiAgICAgICAgICAgICAgICBjYW5jZWxsZWQgJiYgYW5pbWF0ZUNsb3NlKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGFuaW1hdGVBZnRlcihhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lLCBhZnRlckFuaW1hdGlvbkNvbXBsZXRlKSB7CiAgICAgICAgICAgIGlmKGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSkpIHsKICAgICAgICAgICAgICByZXR1cm4gYW5pbWF0ZVJ1bihhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lLCBhZnRlckFuaW1hdGlvbkNvbXBsZXRlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhbmltYXRlQ2xvc2UoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICBhZnRlckFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBhbmltYXRlKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlKSB7CiAgICAgICAgICAgIC8vSWYgdGhlIGFuaW1hdGVTZXR1cCBmdW5jdGlvbiBkb2Vzbid0IGJvdGhlciByZXR1cm5pbmcgYQogICAgICAgICAgICAvL2NhbmNlbGxhdGlvbiBmdW5jdGlvbiB0aGVuIGl0IG1lYW5zIHRoYXQgdGhlcmUgaXMgbm8gYW5pbWF0aW9uCiAgICAgICAgICAgIC8vdG8gcGVyZm9ybSBhdCBhbGwKICAgICAgICAgICAgdmFyIHByZVJlZmxvd0NhbmNlbGxhdGlvbiA9IGFuaW1hdGVCZWZvcmUoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgIGlmKCFwcmVSZWZsb3dDYW5jZWxsYXRpb24pIHsKICAgICAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZSgpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9UaGVyZSBhcmUgdHdvIGNhbmNlbGxhdGlvbiBmdW5jdGlvbnM6IG9uZSBpcyBiZWZvcmUgdGhlIGZpcnN0CiAgICAgICAgICAgIC8vcmVmbG93IGFuaW1hdGlvbiBhbmQgdGhlIHNlY29uZCBpcyBkdXJpbmcgdGhlIGFjdGl2ZSBzdGF0ZQogICAgICAgICAgICAvL2FuaW1hdGlvbi4gVGhlIGZpcnN0IGZ1bmN0aW9uIHdpbGwgdGFrZSBjYXJlIG9mIHJlbW92aW5nIHRoZQogICAgICAgICAgICAvL2RhdGEgZnJvbSB0aGUgZWxlbWVudCB3aGljaCB3aWxsIG5vdCBtYWtlIHRoZSAybmQgYW5pbWF0aW9uCiAgICAgICAgICAgIC8vaGFwcGVuIGluIHRoZSBmaXJzdCBwbGFjZQogICAgICAgICAgICB2YXIgY2FuY2VsID0gcHJlUmVmbG93Q2FuY2VsbGF0aW9uOwogICAgICAgICAgICBhZnRlclJlZmxvdyhlbGVtZW50LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB1bmJsb2NrVHJhbnNpdGlvbnMoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB1bmJsb2NrS2V5ZnJhbWVBbmltYXRpb25zKGVsZW1lbnQpOwogICAgICAgICAgICAgIC8vb25jZSB0aGUgcmVmbG93IGlzIGNvbXBsZXRlIHRoZW4gd2UgcG9pbnQgY2FuY2VsIHRvCiAgICAgICAgICAgICAgLy90aGUgbmV3IGNhbmNlbGxhdGlvbiBmdW5jdGlvbiB3aGljaCB3aWxsIHJlbW92ZSBhbGwgb2YgdGhlCiAgICAgICAgICAgICAgLy9hbmltYXRpb24gcHJvcGVydGllcyBmcm9tIHRoZSBhY3RpdmUgYW5pbWF0aW9uCiAgICAgICAgICAgICAgY2FuY2VsID0gYW5pbWF0ZUFmdGVyKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FuY2VsbGVkKSB7CiAgICAgICAgICAgICAgKGNhbmNlbCB8fCBub29wKShjYW5jZWxsZWQpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGFuaW1hdGVDbG9zZShlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSk7CiAgICAgICAgICAgIGlmKGRhdGEpIHsKICAgICAgICAgICAgICBpZihkYXRhLnJ1bm5pbmcpIHsKICAgICAgICAgICAgICAgIGRhdGEucnVubmluZy0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZighZGF0YS5ydW5uaW5nIHx8IGRhdGEucnVubmluZyA9PT0gMCkgewogICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVEYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBlbnRlciA6IGZ1bmN0aW9uKGVsZW1lbnQsIGFuaW1hdGlvbkNvbXBsZXRlZCkgewogICAgICAgICAgICAgIHJldHVybiBhbmltYXRlKCdlbnRlcicsIGVsZW1lbnQsICduZy1lbnRlcicsIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBsZWF2ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGFuaW1hdGlvbkNvbXBsZXRlZCkgewogICAgICAgICAgICAgIHJldHVybiBhbmltYXRlKCdsZWF2ZScsIGVsZW1lbnQsICduZy1sZWF2ZScsIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBtb3ZlIDogZnVuY3Rpb24oZWxlbWVudCwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGFuaW1hdGUoJ21vdmUnLCBlbGVtZW50LCAnbmctbW92ZScsIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBiZWZvcmVTZXRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGFkZCwgcmVtb3ZlLCBhbmltYXRpb25Db21wbGV0ZWQpIHsKICAgICAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gc3VmZml4Q2xhc3NlcyhyZW1vdmUsICctcmVtb3ZlJykgKyAnICcgKwogICAgICAgICAgICAgICAgc3VmZml4Q2xhc3NlcyhhZGQsICctYWRkJyk7CiAgICAgICAgICAgICAgdmFyIGNhbmNlbGxhdGlvbk1ldGhvZCA9IGFuaW1hdGVCZWZvcmUoJ3NldENsYXNzJywgZWxlbWVudCwgY2xhc3NOYW1lLCBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgICAgLyogd2hlbiBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gYW4gZWxlbWVudCB0aGVuIHRoZSB0cmFuc2l0aW9uIHN0eWxlCiAgICAgICAgICAgICAgICAgKiB0aGF0IGlzIGFwcGxpZWQgaXMgdGhlIHRyYW5zaXRpb24gZGVmaW5lZCBvbiB0aGUgZWxlbWVudCB3aXRob3V0IHRoZQogICAgICAgICAgICAgICAgICogQ1NTIGNsYXNzIGJlaW5nIHRoZXJlLiBUaGlzIGlzIGhvdyBDU1MzIGZ1bmN0aW9ucyBvdXRzaWRlIG9mIG5nQW5pbWF0ZS4KICAgICAgICAgICAgICAgICAqIGh0dHA6Ly9wbG5rci5jby9lZGl0L2o4T3pnVE54SFRiNG4zekx5akdXP3A9cHJldmlldyAqLwogICAgICAgICAgICAgICAgdmFyIGtsYXNzID0gZWxlbWVudC5hdHRyKCdjbGFzcycpOwogICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhyZW1vdmUpOwogICAgICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhhZGQpOwogICAgICAgICAgICAgICAgdmFyIHRpbWluZ3MgPSBmbigpOwogICAgICAgICAgICAgICAgZWxlbWVudC5hdHRyKCdjbGFzcycsIGtsYXNzKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aW1pbmdzOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBpZihjYW5jZWxsYXRpb25NZXRob2QpIHsKICAgICAgICAgICAgICAgIGFmdGVyUmVmbG93KGVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB1bmJsb2NrVHJhbnNpdGlvbnMoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgdW5ibG9ja0tleWZyYW1lQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uQ29tcGxldGVkKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiBjYW5jZWxsYXRpb25NZXRob2Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFuaW1hdGlvbkNvbXBsZXRlZCgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYmVmb3JlQWRkQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlZCkgewogICAgICAgICAgICAgIHZhciBjYW5jZWxsYXRpb25NZXRob2QgPSBhbmltYXRlQmVmb3JlKCdhZGRDbGFzcycsIGVsZW1lbnQsIHN1ZmZpeENsYXNzZXMoY2xhc3NOYW1lLCAnLWFkZCcpLCBmdW5jdGlvbihmbikgewoKICAgICAgICAgICAgICAgIC8qIHdoZW4gYSBDU1MgY2xhc3MgaXMgYWRkZWQgdG8gYW4gZWxlbWVudCB0aGVuIHRoZSB0cmFuc2l0aW9uIHN0eWxlIHRoYXQKICAgICAgICAgICAgICAgICAqIGlzIGFwcGxpZWQgaXMgdGhlIHRyYW5zaXRpb24gZGVmaW5lZCBvbiB0aGUgZWxlbWVudCB3aGVuIHRoZSBDU1MgY2xhc3MKICAgICAgICAgICAgICAgICAqIGlzIGFkZGVkIGF0IHRoZSB0aW1lIG9mIHRoZSBhbmltYXRpb24uIFRoaXMgaXMgaG93IENTUzMgZnVuY3Rpb25zCiAgICAgICAgICAgICAgICAgKiBvdXRzaWRlIG9mIG5nQW5pbWF0ZS4gKi8KICAgICAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgIHZhciB0aW1pbmdzID0gZm4oKTsKICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aW1pbmdzOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBpZihjYW5jZWxsYXRpb25NZXRob2QpIHsKICAgICAgICAgICAgICAgIGFmdGVyUmVmbG93KGVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB1bmJsb2NrVHJhbnNpdGlvbnMoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgdW5ibG9ja0tleWZyYW1lQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uQ29tcGxldGVkKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiBjYW5jZWxsYXRpb25NZXRob2Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFuaW1hdGlvbkNvbXBsZXRlZCgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgc2V0Q2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBhZGQsIHJlbW92ZSwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICAgICAgcmVtb3ZlID0gc3VmZml4Q2xhc3NlcyhyZW1vdmUsICctcmVtb3ZlJyk7CiAgICAgICAgICAgICAgYWRkID0gc3VmZml4Q2xhc3NlcyhhZGQsICctYWRkJyk7CiAgICAgICAgICAgICAgdmFyIGNsYXNzTmFtZSA9IHJlbW92ZSArICcgJyArIGFkZDsKICAgICAgICAgICAgICByZXR1cm4gYW5pbWF0ZUFmdGVyKCdzZXRDbGFzcycsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGVkKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGFkZENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25Db21wbGV0ZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gYW5pbWF0ZUFmdGVyKCdhZGRDbGFzcycsIGVsZW1lbnQsIHN1ZmZpeENsYXNzZXMoY2xhc3NOYW1lLCAnLWFkZCcpLCBhbmltYXRpb25Db21wbGV0ZWQpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYmVmb3JlUmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlZCkgewogICAgICAgICAgICAgIHZhciBjYW5jZWxsYXRpb25NZXRob2QgPSBhbmltYXRlQmVmb3JlKCdyZW1vdmVDbGFzcycsIGVsZW1lbnQsIHN1ZmZpeENsYXNzZXMoY2xhc3NOYW1lLCAnLXJlbW92ZScpLCBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgICAgLyogd2hlbiBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gYW4gZWxlbWVudCB0aGVuIHRoZSB0cmFuc2l0aW9uIHN0eWxlCiAgICAgICAgICAgICAgICAgKiB0aGF0IGlzIGFwcGxpZWQgaXMgdGhlIHRyYW5zaXRpb24gZGVmaW5lZCBvbiB0aGUgZWxlbWVudCB3aXRob3V0IHRoZQogICAgICAgICAgICAgICAgICogQ1NTIGNsYXNzIGJlaW5nIHRoZXJlLiBUaGlzIGlzIGhvdyBDU1MzIGZ1bmN0aW9ucyBvdXRzaWRlIG9mIG5nQW5pbWF0ZS4KICAgICAgICAgICAgICAgICAqIGh0dHA6Ly9wbG5rci5jby9lZGl0L2o4T3pnVE54SFRiNG4zekx5akdXP3A9cHJldmlldyAqLwogICAgICAgICAgICAgICAgdmFyIGtsYXNzID0gZWxlbWVudC5hdHRyKCdjbGFzcycpOwogICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgdmFyIHRpbWluZ3MgPSBmbigpOwogICAgICAgICAgICAgICAgZWxlbWVudC5hdHRyKCdjbGFzcycsIGtsYXNzKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aW1pbmdzOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBpZihjYW5jZWxsYXRpb25NZXRob2QpIHsKICAgICAgICAgICAgICAgIGFmdGVyUmVmbG93KGVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB1bmJsb2NrVHJhbnNpdGlvbnMoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgICAgdW5ibG9ja0tleWZyYW1lQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uQ29tcGxldGVkKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiBjYW5jZWxsYXRpb25NZXRob2Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGFuaW1hdGlvbkNvbXBsZXRlZCgpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlZCkgewogICAgICAgICAgICAgIHJldHVybiBhbmltYXRlQWZ0ZXIoJ3JlbW92ZUNsYXNzJywgZWxlbWVudCwgc3VmZml4Q2xhc3NlcyhjbGFzc05hbWUsICctcmVtb3ZlJyksIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgZnVuY3Rpb24gc3VmZml4Q2xhc3NlcyhjbGFzc2VzLCBzdWZmaXgpIHsKICAgICAgICAgICAgdmFyIGNsYXNzTmFtZSA9ICcnOwogICAgICAgICAgICBjbGFzc2VzID0gYW5ndWxhci5pc0FycmF5KGNsYXNzZXMpID8gY2xhc3NlcyA6IGNsYXNzZXMuc3BsaXQoL1xzKy8pOwogICAgICAgICAgICBmb3JFYWNoKGNsYXNzZXMsIGZ1bmN0aW9uKGtsYXNzLCBpKSB7CiAgICAgICAgICAgICAgaWYoa2xhc3MgJiYga2xhc3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY2xhc3NOYW1lICs9IChpID4gMCA/ICcgJyA6ICcnKSArIGtsYXNzICsgc3VmZml4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBjbGFzc05hbWU7CiAgICAgICAgICB9CiAgICAgICAgfV0pOwogICAgfV0pOwoKCn0pKHdpbmRvdywgd2luZG93LmFuZ3VsYXIpOwoKLyohCiAqIGlvbmljLmJ1bmRsZS5qcyBpcyBhIGNvbmNhdGVuYXRpb24gb2Y6CiAqIGlvbmljLmpzLCBhbmd1bGFyLmpzLCBhbmd1bGFyLWFuaW1hdGUuanMsCiAqIGFuZ3VsYXItc2FuaXRpemUuanMsIGFuZ3VsYXItdWktcm91dGVyLmpzLAogKiBhbmQgaW9uaWMtYW5ndWxhci5qcwogKi8KCi8qKgogKiBAbGljZW5zZSBBbmd1bGFySlMgdjEuMi4xNwogKiAoYykgMjAxMC0yMDE0IEdvb2dsZSwgSW5jLiBodHRwOi8vYW5ndWxhcmpzLm9yZwogKiBMaWNlbnNlOiBNSVQKICovCihmdW5jdGlvbih3aW5kb3csIGFuZ3VsYXIsIHVuZGVmaW5lZCkgeyd1c2Ugc3RyaWN0JzsKCiAgdmFyICRzYW5pdGl6ZU1pbkVyciA9IGFuZ3VsYXIuJCRtaW5FcnIoJyRzYW5pdGl6ZScpOwoKICAvKioKICAgKiBAbmdkb2MgbW9kdWxlCiAgICogQG5hbWUgbmdTYW5pdGl6ZQogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogIyBuZ1Nhbml0aXplCiAgICoKICAgKiBUaGUgYG5nU2FuaXRpemVgIG1vZHVsZSBwcm92aWRlcyBmdW5jdGlvbmFsaXR5IHRvIHNhbml0aXplIEhUTUwuCiAgICoKICAgKgogICAqIDxkaXYgZG9jLW1vZHVsZS1jb21wb25lbnRzPSJuZ1Nhbml0aXplIj48L2Rpdj4KICAgKgogICAqIFNlZSB7QGxpbmsgbmdTYW5pdGl6ZS4kc2FuaXRpemUgYCRzYW5pdGl6ZWB9IGZvciB1c2FnZS4KICAgKi8KCiAgLyoKICAgKiBIVE1MIFBhcnNlciBCeSBNaXNrbyBIZXZlcnkgKG1pc2tvQGhldmVyeS5jb20pCiAgICogYmFzZWQgb246ICBIVE1MIFBhcnNlciBCeSBKb2huIFJlc2lnIChlam9obi5vcmcpCiAgICogT3JpZ2luYWwgY29kZSBieSBFcmlrIEFydmlkc3NvbiwgTW96aWxsYSBQdWJsaWMgTGljZW5zZQogICAqIGh0dHA6Ly9lcmlrLmVhZS5uZXQvc2ltcGxlaHRtbHBhcnNlci9zaW1wbGVodG1scGFyc2VyLmpzCiAgICoKICAgKiAvLyBVc2UgbGlrZSBzbzoKICAgKiBodG1sUGFyc2VyKGh0bWxTdHJpbmcsIHsKICAgKiAgICAgc3RhcnQ6IGZ1bmN0aW9uKHRhZywgYXR0cnMsIHVuYXJ5KSB7fSwKICAgKiAgICAgZW5kOiBmdW5jdGlvbih0YWcpIHt9LAogICAqICAgICBjaGFyczogZnVuY3Rpb24odGV4dCkge30sCiAgICogICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKHRleHQpIHt9CiAgICogfSk7CiAgICoKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJHNhbml0aXplCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqICAgVGhlIGlucHV0IGlzIHNhbml0aXplZCBieSBwYXJzaW5nIHRoZSBodG1sIGludG8gdG9rZW5zLiBBbGwgc2FmZSB0b2tlbnMgKGZyb20gYSB3aGl0ZWxpc3QpIGFyZQogICAqICAgdGhlbiBzZXJpYWxpemVkIGJhY2sgdG8gcHJvcGVybHkgZXNjYXBlZCBodG1sIHN0cmluZy4gVGhpcyBtZWFucyB0aGF0IG5vIHVuc2FmZSBpbnB1dCBjYW4gbWFrZQogICAqICAgaXQgaW50byB0aGUgcmV0dXJuZWQgc3RyaW5nLCBob3dldmVyLCBzaW5jZSBvdXIgcGFyc2VyIGlzIG1vcmUgc3RyaWN0IHRoYW4gYSB0eXBpY2FsIGJyb3dzZXIKICAgKiAgIHBhcnNlciwgaXQncyBwb3NzaWJsZSB0aGF0IHNvbWUgb2JzY3VyZSBpbnB1dCwgd2hpY2ggd291bGQgYmUgcmVjb2duaXplZCBhcyB2YWxpZCBIVE1MIGJ5IGEKICAgKiAgIGJyb3dzZXIsIHdvbid0IG1ha2UgaXQgdGhyb3VnaCB0aGUgc2FuaXRpemVyLgogICAqICAgVGhlIHdoaXRlbGlzdCBpcyBjb25maWd1cmVkIHVzaW5nIHRoZSBmdW5jdGlvbnMgYGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0YCBhbmQKICAgKiAgIGBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3RgIG9mIHtAbGluayBuZy4kY29tcGlsZVByb3ZpZGVyIGAkY29tcGlsZVByb3ZpZGVyYH0uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gaHRtbCBIdG1sIGlucHV0LgogICAqIEByZXR1cm5zIHtzdHJpbmd9IFNhbml0aXplZCBodG1sLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJuZ1Nhbml0aXplIiBkZXBzPSJhbmd1bGFyLXNhbml0aXplLmpzIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlLCAkc2NlKSB7CiAgICAgICAgICRzY29wZS5zbmlwcGV0ID0KICAgICAgICAgICAnPHAgc3R5bGU9ImNvbG9yOmJsdWUiPmFuIGh0bWxcbicgKwogICAgICAgICAgICc8ZW0gb25tb3VzZW92ZXI9InRoaXMudGV4dENvbnRlbnQ9XCdQV04zRCFcJyI+Y2xpY2sgaGVyZTwvZW0+XG4nICsKICAgICAgICAgICAnc25pcHBldDwvcD4nOwogICAgICAgICAkc2NvcGUuZGVsaWJlcmF0ZWx5VHJ1c3REYW5nZXJvdXNTbmlwcGV0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgcmV0dXJuICRzY2UudHJ1c3RBc0h0bWwoJHNjb3BlLnNuaXBwZXQpOwogICAgICAgICB9OwogICAgICAgfQogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgU25pcHBldDogPHRleHRhcmVhIG5nLW1vZGVsPSJzbmlwcGV0IiBjb2xzPSI2MCIgcm93cz0iMyI+PC90ZXh0YXJlYT4KICAgPHRhYmxlPgogICA8dHI+CiAgIDx0ZD5EaXJlY3RpdmU8L3RkPgogICA8dGQ+SG93PC90ZD4KICAgPHRkPlNvdXJjZTwvdGQ+CiAgIDx0ZD5SZW5kZXJlZDwvdGQ+CiAgIDwvdHI+CiAgIDx0ciBpZD0iYmluZC1odG1sLXdpdGgtc2FuaXRpemUiPgogICA8dGQ+bmctYmluZC1odG1sPC90ZD4KICAgPHRkPkF1dG9tYXRpY2FsbHkgdXNlcyAkc2FuaXRpemU8L3RkPgogICA8dGQ+PHByZT4mbHQ7ZGl2IG5nLWJpbmQtaHRtbD0ic25pcHBldCImZ3Q7PGJyLz4mbHQ7L2RpdiZndDs8L3ByZT48L3RkPgogICA8dGQ+PGRpdiBuZy1iaW5kLWh0bWw9InNuaXBwZXQiPjwvZGl2PjwvdGQ+CiAgIDwvdHI+CiAgIDx0ciBpZD0iYmluZC1odG1sLXdpdGgtdHJ1c3QiPgogICA8dGQ+bmctYmluZC1odG1sPC90ZD4KICAgPHRkPkJ5cGFzcyAkc2FuaXRpemUgYnkgZXhwbGljaXRseSB0cnVzdGluZyB0aGUgZGFuZ2Vyb3VzIHZhbHVlPC90ZD4KICAgPHRkPgogICA8cHJlPiZsdDtkaXYgbmctYmluZC1odG1sPSJkZWxpYmVyYXRlbHlUcnVzdERhbmdlcm91c1NuaXBwZXQoKSImZ3Q7CiAgICZsdDsvZGl2Jmd0OzwvcHJlPgogICA8L3RkPgogICA8dGQ+PGRpdiBuZy1iaW5kLWh0bWw9ImRlbGliZXJhdGVseVRydXN0RGFuZ2Vyb3VzU25pcHBldCgpIj48L2Rpdj48L3RkPgogICA8L3RyPgogICA8dHIgaWQ9ImJpbmQtZGVmYXVsdCI+CiAgIDx0ZD5uZy1iaW5kPC90ZD4KICAgPHRkPkF1dG9tYXRpY2FsbHkgZXNjYXBlczwvdGQ+CiAgIDx0ZD48cHJlPiZsdDtkaXYgbmctYmluZD0ic25pcHBldCImZ3Q7PGJyLz4mbHQ7L2RpdiZndDs8L3ByZT48L3RkPgogICA8dGQ+PGRpdiBuZy1iaW5kPSJzbmlwcGV0Ij48L2Rpdj48L3RkPgogICA8L3RyPgogICA8L3RhYmxlPgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBzYW5pdGl6ZSB0aGUgaHRtbCBzbmlwcGV0IGJ5IGRlZmF1bHQnLCBmdW5jdGlvbigpIHsKICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnI2JpbmQtaHRtbC13aXRoLXNhbml0aXplIGRpdicpKS5nZXRJbm5lckh0bWwoKSkuCiAgICAgICAgIHRvQmUoJzxwPmFuIGh0bWxcbjxlbT5jbGljayBoZXJlPC9lbT5cbnNuaXBwZXQ8L3A+Jyk7CiAgICAgfSk7CgogICBpdCgnc2hvdWxkIGlubGluZSByYXcgc25pcHBldCBpZiBib3VuZCB0byBhIHRydXN0ZWQgdmFsdWUnLCBmdW5jdGlvbigpIHsKICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnI2JpbmQtaHRtbC13aXRoLXRydXN0IGRpdicpKS5nZXRJbm5lckh0bWwoKSkuCiAgICAgICAgIHRvQmUoIjxwIHN0eWxlPVwiY29sb3I6Ymx1ZVwiPmFuIGh0bWxcbiIgKwogICAgICAgICAgICAgICI8ZW0gb25tb3VzZW92ZXI9XCJ0aGlzLnRleHRDb250ZW50PSdQV04zRCEnXCI+Y2xpY2sgaGVyZTwvZW0+XG4iICsKICAgICAgICAgICAgICAic25pcHBldDwvcD4iKTsKICAgICB9KTsKCiAgIGl0KCdzaG91bGQgZXNjYXBlIHNuaXBwZXQgd2l0aG91dCBhbnkgZmlsdGVyJywgZnVuY3Rpb24oKSB7CiAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJyNiaW5kLWRlZmF1bHQgZGl2JykpLmdldElubmVySHRtbCgpKS4KICAgICAgICAgdG9CZSgiJmx0O3Agc3R5bGU9XCJjb2xvcjpibHVlXCImZ3Q7YW4gaHRtbFxuIiArCiAgICAgICAgICAgICAgIiZsdDtlbSBvbm1vdXNlb3Zlcj1cInRoaXMudGV4dENvbnRlbnQ9J1BXTjNEISdcIiZndDtjbGljayBoZXJlJmx0Oy9lbSZndDtcbiIgKwogICAgICAgICAgICAgICJzbmlwcGV0Jmx0Oy9wJmd0OyIpOwogICAgIH0pOwoKICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3NuaXBwZXQnKSkuY2xlYXIoKTsKICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3NuaXBwZXQnKSkuc2VuZEtleXMoJ25ldyA8YiBvbmNsaWNrPSJhbGVydCgxKSI+dGV4dDwvYj4nKTsKICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnI2JpbmQtaHRtbC13aXRoLXNhbml0aXplIGRpdicpKS5nZXRJbm5lckh0bWwoKSkuCiAgICAgICAgIHRvQmUoJ25ldyA8Yj50ZXh0PC9iPicpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjYmluZC1odG1sLXdpdGgtdHJ1c3QgZGl2JykpLmdldElubmVySHRtbCgpKS50b0JlKAogICAgICAgICAnbmV3IDxiIG9uY2xpY2s9ImFsZXJ0KDEpIj50ZXh0PC9iPicpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjYmluZC1kZWZhdWx0IGRpdicpKS5nZXRJbm5lckh0bWwoKSkudG9CZSgKICAgICAgICAgIm5ldyAmbHQ7YiBvbmNsaWNrPVwiYWxlcnQoMSlcIiZndDt0ZXh0Jmx0Oy9iJmd0OyIpOwogICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICBmdW5jdGlvbiAkU2FuaXRpemVQcm92aWRlcigpIHsKICAgIHRoaXMuJGdldCA9IFsnJCRzYW5pdGl6ZVVyaScsIGZ1bmN0aW9uKCQkc2FuaXRpemVVcmkpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgICB2YXIgYnVmID0gW107CiAgICAgICAgaHRtbFBhcnNlcihodG1sLCBodG1sU2FuaXRpemVXcml0ZXIoYnVmLCBmdW5jdGlvbih1cmksIGlzSW1hZ2UpIHsKICAgICAgICAgIHJldHVybiAhL151bnNhZmUvLnRlc3QoJCRzYW5pdGl6ZVVyaSh1cmksIGlzSW1hZ2UpKTsKICAgICAgICB9KSk7CiAgICAgICAgcmV0dXJuIGJ1Zi5qb2luKCcnKTsKICAgICAgfTsKICAgIH1dOwogIH0KCiAgZnVuY3Rpb24gc2FuaXRpemVUZXh0KGNoYXJzKSB7CiAgICB2YXIgYnVmID0gW107CiAgICB2YXIgd3JpdGVyID0gaHRtbFNhbml0aXplV3JpdGVyKGJ1ZiwgYW5ndWxhci5ub29wKTsKICAgIHdyaXRlci5jaGFycyhjaGFycyk7CiAgICByZXR1cm4gYnVmLmpvaW4oJycpOwogIH0KCgovLyBSZWd1bGFyIEV4cHJlc3Npb25zIGZvciBwYXJzaW5nIHRhZ3MgYW5kIGF0dHJpYnV0ZXMKICB2YXIgU1RBUlRfVEFHX1JFR0VYUCA9CiAgICAgIC9ePFxzKihbXHc6LV0rKSgoPzpccytbXHc6LV0rKD86XHMqPVxzKig/Oig/OiJbXiJdKiIpfCg/OidbXiddKicpfFtePlxzXSspKT8pKilccyooXC8/KVxzKj4vLAogICAgRU5EX1RBR19SRUdFWFAgPSAvXjxccypcL1xzKihbXHc6LV0rKVtePl0qPi8sCiAgICBBVFRSX1JFR0VYUCA9IC8oW1x3Oi1dKykoPzpccyo9XHMqKD86KD86IigoPzpbXiJdKSopIil8KD86JygoPzpbXiddKSopJyl8KFtePlxzXSspKSk/L2csCiAgICBCRUdJTl9UQUdfUkVHRVhQID0gL148LywKICAgIEJFR0lOR19FTkRfVEFHRV9SRUdFWFAgPSAvXjxccypcLy8sCiAgICBDT01NRU5UX1JFR0VYUCA9IC88IS0tKC4qPyktLT4vZywKICAgIERPQ1RZUEVfUkVHRVhQID0gLzwhRE9DVFlQRShbXj5dKj8pPi9pLAogICAgQ0RBVEFfUkVHRVhQID0gLzwhXFtDREFUQVxbKC4qPyldXT4vZywKICAgIFNVUlJPR0FURV9QQUlSX1JFR0VYUCA9IC9bXHVEODAwLVx1REJGRl1bXHVEQzAwLVx1REZGRl0vZywKICAvLyBNYXRjaCBldmVyeXRoaW5nIG91dHNpZGUgb2Ygbm9ybWFsIGNoYXJzIGFuZCAiIChxdW90ZSBjaGFyYWN0ZXIpCiAgICBOT05fQUxQSEFOVU1FUklDX1JFR0VYUCA9IC8oW15cIy1+fCB8IV0pL2c7CgoKLy8gR29vZCBzb3VyY2Ugb2YgaW5mbyBhYm91dCBlbGVtZW50cyBhbmQgYXR0cmlidXRlcwovLyBodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjc2VtYW50aWNzCi8vIGh0dHA6Ly9zaW1vbi5odG1sNS5vcmcvaHRtbC1lbGVtZW50cwoKLy8gU2FmZSBWb2lkIEVsZW1lbnRzIC0gSFRNTDUKLy8gaHR0cDovL2Rldi53My5vcmcvaHRtbDUvc3BlYy9PdmVydmlldy5odG1sI3ZvaWQtZWxlbWVudHMKICB2YXIgdm9pZEVsZW1lbnRzID0gbWFrZU1hcCgiYXJlYSxicixjb2wsaHIsaW1nLHdiciIpOwoKLy8gRWxlbWVudHMgdGhhdCB5b3UgY2FuLCBpbnRlbnRpb25hbGx5LCBsZWF2ZSBvcGVuIChhbmQgd2hpY2ggY2xvc2UgdGhlbXNlbHZlcykKLy8gaHR0cDovL2Rldi53My5vcmcvaHRtbDUvc3BlYy9PdmVydmlldy5odG1sI29wdGlvbmFsLXRhZ3MKICB2YXIgb3B0aW9uYWxFbmRUYWdCbG9ja0VsZW1lbnRzID0gbWFrZU1hcCgiY29sZ3JvdXAsZGQsZHQsbGkscCx0Ym9keSx0ZCx0Zm9vdCx0aCx0aGVhZCx0ciIpLAogICAgb3B0aW9uYWxFbmRUYWdJbmxpbmVFbGVtZW50cyA9IG1ha2VNYXAoInJwLHJ0IiksCiAgICBvcHRpb25hbEVuZFRhZ0VsZW1lbnRzID0gYW5ndWxhci5leHRlbmQoe30sCiAgICAgIG9wdGlvbmFsRW5kVGFnSW5saW5lRWxlbWVudHMsCiAgICAgIG9wdGlvbmFsRW5kVGFnQmxvY2tFbGVtZW50cyk7CgovLyBTYWZlIEJsb2NrIEVsZW1lbnRzIC0gSFRNTDUKICB2YXIgYmxvY2tFbGVtZW50cyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBvcHRpb25hbEVuZFRhZ0Jsb2NrRWxlbWVudHMsIG1ha2VNYXAoImFkZHJlc3MsYXJ0aWNsZSwiICsKICAgICJhc2lkZSxibG9ja3F1b3RlLGNhcHRpb24sY2VudGVyLGRlbCxkaXIsZGl2LGRsLGZpZ3VyZSxmaWdjYXB0aW9uLGZvb3RlcixoMSxoMixoMyxoNCxoNSwiICsKICAgICJoNixoZWFkZXIsaGdyb3VwLGhyLGlucyxtYXAsbWVudSxuYXYsb2wscHJlLHNjcmlwdCxzZWN0aW9uLHRhYmxlLHVsIikpOwoKLy8gSW5saW5lIEVsZW1lbnRzIC0gSFRNTDUKICB2YXIgaW5saW5lRWxlbWVudHMgPSBhbmd1bGFyLmV4dGVuZCh7fSwgb3B0aW9uYWxFbmRUYWdJbmxpbmVFbGVtZW50cywgbWFrZU1hcCgiYSxhYmJyLGFjcm9ueW0sYiwiICsKICAgICJiZGksYmRvLGJpZyxicixjaXRlLGNvZGUsZGVsLGRmbixlbSxmb250LGksaW1nLGlucyxrYmQsbGFiZWwsbWFwLG1hcmsscSxydWJ5LHJwLHJ0LHMsIiArCiAgICAic2FtcCxzbWFsbCxzcGFuLHN0cmlrZSxzdHJvbmcsc3ViLHN1cCx0aW1lLHR0LHUsdmFyIikpOwoKCi8vIFNwZWNpYWwgRWxlbWVudHMgKGNhbiBjb250YWluIGFueXRoaW5nKQogIHZhciBzcGVjaWFsRWxlbWVudHMgPSBtYWtlTWFwKCJzY3JpcHQsc3R5bGUiKTsKCiAgdmFyIHZhbGlkRWxlbWVudHMgPSBhbmd1bGFyLmV4dGVuZCh7fSwKICAgIHZvaWRFbGVtZW50cywKICAgIGJsb2NrRWxlbWVudHMsCiAgICBpbmxpbmVFbGVtZW50cywKICAgIG9wdGlvbmFsRW5kVGFnRWxlbWVudHMpOwoKLy9BdHRyaWJ1dGVzIHRoYXQgaGF2ZSBocmVmIGFuZCBoZW5jZSBuZWVkIHRvIGJlIHNhbml0aXplZAogIHZhciB1cmlBdHRycyA9IG1ha2VNYXAoImJhY2tncm91bmQsY2l0ZSxocmVmLGxvbmdkZXNjLHNyYyx1c2VtYXAiKTsKICB2YXIgdmFsaWRBdHRycyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCB1cmlBdHRycywgbWFrZU1hcCgKICAgICAgJ2FiYnIsYWxpZ24sYWx0LGF4aXMsYmdjb2xvcixib3JkZXIsY2VsbHBhZGRpbmcsY2VsbHNwYWNpbmcsY2xhc3MsY2xlYXIsJysKICAgICAgJ2NvbG9yLGNvbHMsY29sc3Bhbixjb21wYWN0LGNvb3JkcyxkaXIsZmFjZSxoZWFkZXJzLGhlaWdodCxocmVmbGFuZyxoc3BhY2UsJysKICAgICAgJ2lzbWFwLGxhbmcsbGFuZ3VhZ2Usbm9ocmVmLG5vd3JhcCxyZWwscmV2LHJvd3Mscm93c3BhbixydWxlcywnKwogICAgICAnc2NvcGUsc2Nyb2xsaW5nLHNoYXBlLHNpemUsc3BhbixzdGFydCxzdW1tYXJ5LHRhcmdldCx0aXRsZSx0eXBlLCcrCiAgICAgICd2YWxpZ24sdmFsdWUsdnNwYWNlLHdpZHRoJykpOwoKICBmdW5jdGlvbiBtYWtlTWFwKHN0cikgewogICAgdmFyIG9iaiA9IHt9LCBpdGVtcyA9IHN0ci5zcGxpdCgnLCcpLCBpOwogICAgZm9yIChpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrKSBvYmpbaXRlbXNbaV1dID0gdHJ1ZTsKICAgIHJldHVybiBvYmo7CiAgfQoKCiAgLyoqCiAgICogQGV4YW1wbGUKICAgKiBodG1sUGFyc2VyKGh0bWxTdHJpbmcsIHsKICogICAgIHN0YXJ0OiBmdW5jdGlvbih0YWcsIGF0dHJzLCB1bmFyeSkge30sCiAqICAgICBlbmQ6IGZ1bmN0aW9uKHRhZykge30sCiAqICAgICBjaGFyczogZnVuY3Rpb24odGV4dCkge30sCiAqICAgICBjb21tZW50OiBmdW5jdGlvbih0ZXh0KSB7fQogKiB9KTsKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBodG1sIHN0cmluZwogICAqIEBwYXJhbSB7b2JqZWN0fSBoYW5kbGVyCiAgICovCiAgZnVuY3Rpb24gaHRtbFBhcnNlciggaHRtbCwgaGFuZGxlciApIHsKICAgIHZhciBpbmRleCwgY2hhcnMsIG1hdGNoLCBzdGFjayA9IFtdLCBsYXN0ID0gaHRtbDsKICAgIHN0YWNrLmxhc3QgPSBmdW5jdGlvbigpIHsgcmV0dXJuIHN0YWNrWyBzdGFjay5sZW5ndGggLSAxIF07IH07CgogICAgd2hpbGUgKCBodG1sICkgewogICAgICBjaGFycyA9IHRydWU7CgogICAgICAvLyBNYWtlIHN1cmUgd2UncmUgbm90IGluIGEgc2NyaXB0IG9yIHN0eWxlIGVsZW1lbnQKICAgICAgaWYgKCAhc3RhY2subGFzdCgpIHx8ICFzcGVjaWFsRWxlbWVudHNbIHN0YWNrLmxhc3QoKSBdICkgewoKICAgICAgICAvLyBDb21tZW50CiAgICAgICAgaWYgKCBodG1sLmluZGV4T2YoIjwhLS0iKSA9PT0gMCApIHsKICAgICAgICAgIC8vIGNvbW1lbnRzIGNvbnRhaW5pbmcgLS0gYXJlIG5vdCBhbGxvd2VkIHVubGVzcyB0aGV5IHRlcm1pbmF0ZSB0aGUgY29tbWVudAogICAgICAgICAgaW5kZXggPSBodG1sLmluZGV4T2YoIi0tIiwgNCk7CgogICAgICAgICAgaWYgKCBpbmRleCA+PSAwICYmIGh0bWwubGFzdEluZGV4T2YoIi0tPiIsIGluZGV4KSA9PT0gaW5kZXgpIHsKICAgICAgICAgICAgaWYgKGhhbmRsZXIuY29tbWVudCkgaGFuZGxlci5jb21tZW50KCBodG1sLnN1YnN0cmluZyggNCwgaW5kZXggKSApOwogICAgICAgICAgICBodG1sID0gaHRtbC5zdWJzdHJpbmcoIGluZGV4ICsgMyApOwogICAgICAgICAgICBjaGFycyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgLy8gRE9DVFlQRQogICAgICAgIH0gZWxzZSBpZiAoIERPQ1RZUEVfUkVHRVhQLnRlc3QoaHRtbCkgKSB7CiAgICAgICAgICBtYXRjaCA9IGh0bWwubWF0Y2goIERPQ1RZUEVfUkVHRVhQICk7CgogICAgICAgICAgaWYgKCBtYXRjaCApIHsKICAgICAgICAgICAgaHRtbCA9IGh0bWwucmVwbGFjZSggbWF0Y2hbMF0sICcnKTsKICAgICAgICAgICAgY2hhcnMgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGVuZCB0YWcKICAgICAgICB9IGVsc2UgaWYgKCBCRUdJTkdfRU5EX1RBR0VfUkVHRVhQLnRlc3QoaHRtbCkgKSB7CiAgICAgICAgICBtYXRjaCA9IGh0bWwubWF0Y2goIEVORF9UQUdfUkVHRVhQICk7CgogICAgICAgICAgaWYgKCBtYXRjaCApIHsKICAgICAgICAgICAgaHRtbCA9IGh0bWwuc3Vic3RyaW5nKCBtYXRjaFswXS5sZW5ndGggKTsKICAgICAgICAgICAgbWF0Y2hbMF0ucmVwbGFjZSggRU5EX1RBR19SRUdFWFAsIHBhcnNlRW5kVGFnICk7CiAgICAgICAgICAgIGNoYXJzID0gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gc3RhcnQgdGFnCiAgICAgICAgfSBlbHNlIGlmICggQkVHSU5fVEFHX1JFR0VYUC50ZXN0KGh0bWwpICkgewogICAgICAgICAgbWF0Y2ggPSBodG1sLm1hdGNoKCBTVEFSVF9UQUdfUkVHRVhQICk7CgogICAgICAgICAgaWYgKCBtYXRjaCApIHsKICAgICAgICAgICAgaHRtbCA9IGh0bWwuc3Vic3RyaW5nKCBtYXRjaFswXS5sZW5ndGggKTsKICAgICAgICAgICAgbWF0Y2hbMF0ucmVwbGFjZSggU1RBUlRfVEFHX1JFR0VYUCwgcGFyc2VTdGFydFRhZyApOwogICAgICAgICAgICBjaGFycyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCBjaGFycyApIHsKICAgICAgICAgIGluZGV4ID0gaHRtbC5pbmRleE9mKCI8Iik7CgogICAgICAgICAgdmFyIHRleHQgPSBpbmRleCA8IDAgPyBodG1sIDogaHRtbC5zdWJzdHJpbmcoIDAsIGluZGV4ICk7CiAgICAgICAgICBodG1sID0gaW5kZXggPCAwID8gIiIgOiBodG1sLnN1YnN0cmluZyggaW5kZXggKTsKCiAgICAgICAgICBpZiAoaGFuZGxlci5jaGFycykgaGFuZGxlci5jaGFycyggZGVjb2RlRW50aXRpZXModGV4dCkgKTsKICAgICAgICB9CgogICAgICB9IGVsc2UgewogICAgICAgIGh0bWwgPSBodG1sLnJlcGxhY2UobmV3IFJlZ0V4cCgiKC4qKTxcXHMqXFwvXFxzKiIgKyBzdGFjay5sYXN0KCkgKyAiW14+XSo+IiwgJ2knKSwKICAgICAgICAgIGZ1bmN0aW9uKGFsbCwgdGV4dCl7CiAgICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UoQ09NTUVOVF9SRUdFWFAsICIkMSIpLnJlcGxhY2UoQ0RBVEFfUkVHRVhQLCAiJDEiKTsKCiAgICAgICAgICAgIGlmIChoYW5kbGVyLmNoYXJzKSBoYW5kbGVyLmNoYXJzKCBkZWNvZGVFbnRpdGllcyh0ZXh0KSApOwoKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfSk7CgogICAgICAgIHBhcnNlRW5kVGFnKCAiIiwgc3RhY2subGFzdCgpICk7CiAgICAgIH0KCiAgICAgIGlmICggaHRtbCA9PSBsYXN0ICkgewogICAgICAgIHRocm93ICRzYW5pdGl6ZU1pbkVycignYmFkcGFyc2UnLCAiVGhlIHNhbml0aXplciB3YXMgdW5hYmxlIHRvIHBhcnNlIHRoZSBmb2xsb3dpbmcgYmxvY2sgIiArCiAgICAgICAgICAib2YgaHRtbDogezB9IiwgaHRtbCk7CiAgICAgIH0KICAgICAgbGFzdCA9IGh0bWw7CiAgICB9CgogICAgLy8gQ2xlYW4gdXAgYW55IHJlbWFpbmluZyB0YWdzCiAgICBwYXJzZUVuZFRhZygpOwoKICAgIGZ1bmN0aW9uIHBhcnNlU3RhcnRUYWcoIHRhZywgdGFnTmFtZSwgcmVzdCwgdW5hcnkgKSB7CiAgICAgIHRhZ05hbWUgPSBhbmd1bGFyLmxvd2VyY2FzZSh0YWdOYW1lKTsKICAgICAgaWYgKCBibG9ja0VsZW1lbnRzWyB0YWdOYW1lIF0gKSB7CiAgICAgICAgd2hpbGUgKCBzdGFjay5sYXN0KCkgJiYgaW5saW5lRWxlbWVudHNbIHN0YWNrLmxhc3QoKSBdICkgewogICAgICAgICAgcGFyc2VFbmRUYWcoICIiLCBzdGFjay5sYXN0KCkgKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICggb3B0aW9uYWxFbmRUYWdFbGVtZW50c1sgdGFnTmFtZSBdICYmIHN0YWNrLmxhc3QoKSA9PSB0YWdOYW1lICkgewogICAgICAgIHBhcnNlRW5kVGFnKCAiIiwgdGFnTmFtZSApOwogICAgICB9CgogICAgICB1bmFyeSA9IHZvaWRFbGVtZW50c1sgdGFnTmFtZSBdIHx8ICEhdW5hcnk7CgogICAgICBpZiAoICF1bmFyeSApCiAgICAgICAgc3RhY2sucHVzaCggdGFnTmFtZSApOwoKICAgICAgdmFyIGF0dHJzID0ge307CgogICAgICByZXN0LnJlcGxhY2UoQVRUUl9SRUdFWFAsCiAgICAgICAgZnVuY3Rpb24obWF0Y2gsIG5hbWUsIGRvdWJsZVF1b3RlZFZhbHVlLCBzaW5nbGVRdW90ZWRWYWx1ZSwgdW5xdW90ZWRWYWx1ZSkgewogICAgICAgICAgdmFyIHZhbHVlID0gZG91YmxlUXVvdGVkVmFsdWUKICAgICAgICAgICAgfHwgc2luZ2xlUXVvdGVkVmFsdWUKICAgICAgICAgICAgfHwgdW5xdW90ZWRWYWx1ZQogICAgICAgICAgICB8fCAnJzsKCiAgICAgICAgICBhdHRyc1tuYW1lXSA9IGRlY29kZUVudGl0aWVzKHZhbHVlKTsKICAgICAgICB9KTsKICAgICAgaWYgKGhhbmRsZXIuc3RhcnQpIGhhbmRsZXIuc3RhcnQoIHRhZ05hbWUsIGF0dHJzLCB1bmFyeSApOwogICAgfQoKICAgIGZ1bmN0aW9uIHBhcnNlRW5kVGFnKCB0YWcsIHRhZ05hbWUgKSB7CiAgICAgIHZhciBwb3MgPSAwLCBpOwogICAgICB0YWdOYW1lID0gYW5ndWxhci5sb3dlcmNhc2UodGFnTmFtZSk7CiAgICAgIGlmICggdGFnTmFtZSApCiAgICAgIC8vIEZpbmQgdGhlIGNsb3Nlc3Qgb3BlbmVkIHRhZyBvZiB0aGUgc2FtZSB0eXBlCiAgICAgICAgZm9yICggcG9zID0gc3RhY2subGVuZ3RoIC0gMTsgcG9zID49IDA7IHBvcy0tICkKICAgICAgICAgIGlmICggc3RhY2tbIHBvcyBdID09IHRhZ05hbWUgKQogICAgICAgICAgICBicmVhazsKCiAgICAgIGlmICggcG9zID49IDAgKSB7CiAgICAgICAgLy8gQ2xvc2UgYWxsIHRoZSBvcGVuIGVsZW1lbnRzLCB1cCB0aGUgc3RhY2sKICAgICAgICBmb3IgKCBpID0gc3RhY2subGVuZ3RoIC0gMTsgaSA+PSBwb3M7IGktLSApCiAgICAgICAgICBpZiAoaGFuZGxlci5lbmQpIGhhbmRsZXIuZW5kKCBzdGFja1sgaSBdICk7CgogICAgICAgIC8vIFJlbW92ZSB0aGUgb3BlbiBlbGVtZW50cyBmcm9tIHRoZSBzdGFjawogICAgICAgIHN0YWNrLmxlbmd0aCA9IHBvczsKICAgICAgfQogICAgfQogIH0KCiAgdmFyIGhpZGRlblByZT1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJwcmUiKTsKICB2YXIgc3BhY2VSZSA9IC9eKFxzKikoW1xzXFNdKj8pKFxzKikkLzsKICAvKioKICAgKiBkZWNvZGVzIGFsbCBlbnRpdGllcyBpbnRvIHJlZ3VsYXIgc3RyaW5nCiAgICogQHBhcmFtIHZhbHVlCiAgICogQHJldHVybnMge3N0cmluZ30gQSBzdHJpbmcgd2l0aCBkZWNvZGVkIGVudGl0aWVzLgogICAqLwogIGZ1bmN0aW9uIGRlY29kZUVudGl0aWVzKHZhbHVlKSB7CiAgICBpZiAoIXZhbHVlKSB7IHJldHVybiAnJzsgfQoKICAgIC8vIE5vdGU6IElFOCBkb2VzIG5vdCBwcmVzZXJ2ZSBzcGFjZXMgYXQgdGhlIHN0YXJ0L2VuZCBvZiBpbm5lckhUTUwKICAgIC8vIHNvIHdlIG11c3QgY2FwdHVyZSB0aGVtIGFuZCByZWF0dGFjaCB0aGVtIGFmdGVyd2FyZAogICAgdmFyIHBhcnRzID0gc3BhY2VSZS5leGVjKHZhbHVlKTsKICAgIHZhciBzcGFjZUJlZm9yZSA9IHBhcnRzWzFdOwogICAgdmFyIHNwYWNlQWZ0ZXIgPSBwYXJ0c1szXTsKICAgIHZhciBjb250ZW50ID0gcGFydHNbMl07CiAgICBpZiAoY29udGVudCkgewogICAgICBoaWRkZW5QcmUuaW5uZXJIVE1MPWNvbnRlbnQucmVwbGFjZSgvPC9nLCImbHQ7Iik7CiAgICAgIC8vIGlubmVyVGV4dCBkZXBlbmRzIG9uIHN0eWxpbmcgYXMgaXQgZG9lc24ndCBkaXNwbGF5IGhpZGRlbiBlbGVtZW50cy4KICAgICAgLy8gVGhlcmVmb3JlLCBpdCdzIGJldHRlciB0byB1c2UgdGV4dENvbnRlbnQgbm90IHRvIGNhdXNlIHVubmVjZXNzYXJ5CiAgICAgIC8vIHJlZmxvd3MuIEhvd2V2ZXIsIElFPDkgZG9uJ3Qgc3VwcG9ydCB0ZXh0Q29udGVudCBzbyB0aGUgaW5uZXJUZXh0CiAgICAgIC8vIGZhbGxiYWNrIGlzIG5lY2Vzc2FyeS4KICAgICAgY29udGVudCA9ICd0ZXh0Q29udGVudCcgaW4gaGlkZGVuUHJlID8KICAgICAgICBoaWRkZW5QcmUudGV4dENvbnRlbnQgOiBoaWRkZW5QcmUuaW5uZXJUZXh0OwogICAgfQogICAgcmV0dXJuIHNwYWNlQmVmb3JlICsgY29udGVudCArIHNwYWNlQWZ0ZXI7CiAgfQoKICAvKioKICAgKiBFc2NhcGVzIGFsbCBwb3RlbnRpYWxseSBkYW5nZXJvdXMgY2hhcmFjdGVycywgc28gdGhhdCB0aGUKICAgKiByZXN1bHRpbmcgc3RyaW5nIGNhbiBiZSBzYWZlbHkgaW5zZXJ0ZWQgaW50byBhdHRyaWJ1dGUgb3IKICAgKiBlbGVtZW50IHRleHQuCiAgICogQHBhcmFtIHZhbHVlCiAgICogQHJldHVybnMge3N0cmluZ30gZXNjYXBlZCB0ZXh0CiAgICovCiAgZnVuY3Rpb24gZW5jb2RlRW50aXRpZXModmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZS4KICAgICAgcmVwbGFjZSgvJi9nLCAnJmFtcDsnKS4KICAgICAgcmVwbGFjZShTVVJST0dBVEVfUEFJUl9SRUdFWFAsIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHZhciBoaSA9IHZhbHVlLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgdmFyIGxvdyA9IHZhbHVlLmNoYXJDb2RlQXQoMSk7CiAgICAgICAgcmV0dXJuICcmIycgKyAoKChoaSAtIDB4RDgwMCkgKiAweDQwMCkgKyAobG93IC0gMHhEQzAwKSArIDB4MTAwMDApICsgJzsnOwogICAgICB9KS4KICAgICAgcmVwbGFjZShOT05fQUxQSEFOVU1FUklDX1JFR0VYUCwgZnVuY3Rpb24odmFsdWUpewogICAgICAgIHJldHVybiAnJiMnICsgdmFsdWUuY2hhckNvZGVBdCgwKSArICc7JzsKICAgICAgfSkuCiAgICAgIHJlcGxhY2UoLzwvZywgJyZsdDsnKS4KICAgICAgcmVwbGFjZSgvPi9nLCAnJmd0OycpOwogIH0KCiAgLyoqCiAgICogY3JlYXRlIGFuIEhUTUwvWE1MIHdyaXRlciB3aGljaCB3cml0ZXMgdG8gYnVmZmVyCiAgICogQHBhcmFtIHtBcnJheX0gYnVmIHVzZSBidWYuamFpbignJykgdG8gZ2V0IG91dCBzYW5pdGl6ZWQgaHRtbCBzdHJpbmcKICAgKiBAcmV0dXJucyB7b2JqZWN0fSBpbiB0aGUgZm9ybSBvZiB7CiAqICAgICBzdGFydDogZnVuY3Rpb24odGFnLCBhdHRycywgdW5hcnkpIHt9LAogKiAgICAgZW5kOiBmdW5jdGlvbih0YWcpIHt9LAogKiAgICAgY2hhcnM6IGZ1bmN0aW9uKHRleHQpIHt9LAogKiAgICAgY29tbWVudDogZnVuY3Rpb24odGV4dCkge30KICogfQogICAqLwogIGZ1bmN0aW9uIGh0bWxTYW5pdGl6ZVdyaXRlcihidWYsIHVyaVZhbGlkYXRvcil7CiAgICB2YXIgaWdub3JlID0gZmFsc2U7CiAgICB2YXIgb3V0ID0gYW5ndWxhci5iaW5kKGJ1ZiwgYnVmLnB1c2gpOwogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IGZ1bmN0aW9uKHRhZywgYXR0cnMsIHVuYXJ5KXsKICAgICAgICB0YWcgPSBhbmd1bGFyLmxvd2VyY2FzZSh0YWcpOwogICAgICAgIGlmICghaWdub3JlICYmIHNwZWNpYWxFbGVtZW50c1t0YWddKSB7CiAgICAgICAgICBpZ25vcmUgPSB0YWc7CiAgICAgICAgfQogICAgICAgIGlmICghaWdub3JlICYmIHZhbGlkRWxlbWVudHNbdGFnXSA9PT0gdHJ1ZSkgewogICAgICAgICAgb3V0KCc8Jyk7CiAgICAgICAgICBvdXQodGFnKTsKICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChhdHRycywgZnVuY3Rpb24odmFsdWUsIGtleSl7CiAgICAgICAgICAgIHZhciBsa2V5PWFuZ3VsYXIubG93ZXJjYXNlKGtleSk7CiAgICAgICAgICAgIHZhciBpc0ltYWdlID0gKHRhZyA9PT0gJ2ltZycgJiYgbGtleSA9PT0gJ3NyYycpIHx8IChsa2V5ID09PSAnYmFja2dyb3VuZCcpOwogICAgICAgICAgICBpZiAodmFsaWRBdHRyc1tsa2V5XSA9PT0gdHJ1ZSAmJgogICAgICAgICAgICAgICh1cmlBdHRyc1tsa2V5XSAhPT0gdHJ1ZSB8fCB1cmlWYWxpZGF0b3IodmFsdWUsIGlzSW1hZ2UpKSkgewogICAgICAgICAgICAgIG91dCgnICcpOwogICAgICAgICAgICAgIG91dChrZXkpOwogICAgICAgICAgICAgIG91dCgnPSInKTsKICAgICAgICAgICAgICBvdXQoZW5jb2RlRW50aXRpZXModmFsdWUpKTsKICAgICAgICAgICAgICBvdXQoJyInKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBvdXQodW5hcnkgPyAnLz4nIDogJz4nKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGVuZDogZnVuY3Rpb24odGFnKXsKICAgICAgICB0YWcgPSBhbmd1bGFyLmxvd2VyY2FzZSh0YWcpOwogICAgICAgIGlmICghaWdub3JlICYmIHZhbGlkRWxlbWVudHNbdGFnXSA9PT0gdHJ1ZSkgewogICAgICAgICAgb3V0KCc8LycpOwogICAgICAgICAgb3V0KHRhZyk7CiAgICAgICAgICBvdXQoJz4nKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRhZyA9PSBpZ25vcmUpIHsKICAgICAgICAgIGlnbm9yZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hhcnM6IGZ1bmN0aW9uKGNoYXJzKXsKICAgICAgICBpZiAoIWlnbm9yZSkgewogICAgICAgICAgb3V0KGVuY29kZUVudGl0aWVzKGNoYXJzKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH0KCgovLyBkZWZpbmUgbmdTYW5pdGl6ZSBtb2R1bGUgYW5kIHJlZ2lzdGVyICRzYW5pdGl6ZSBzZXJ2aWNlCiAgYW5ndWxhci5tb2R1bGUoJ25nU2FuaXRpemUnLCBbXSkucHJvdmlkZXIoJyRzYW5pdGl6ZScsICRTYW5pdGl6ZVByb3ZpZGVyKTsKCiAgLyogZ2xvYmFsIHNhbml0aXplVGV4dDogZmFsc2UgKi8KCiAgLyoqCiAgICogQG5nZG9jIGZpbHRlcgogICAqIEBuYW1lIGxpbmt5CiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEZpbmRzIGxpbmtzIGluIHRleHQgaW5wdXQgYW5kIHR1cm5zIHRoZW0gaW50byBodG1sIGxpbmtzLiBTdXBwb3J0cyBodHRwL2h0dHBzL2Z0cC9tYWlsdG8gYW5kCiAgICogcGxhaW4gZW1haWwgYWRkcmVzcyBsaW5rcy4KICAgKgogICAqIFJlcXVpcmVzIHRoZSB7QGxpbmsgbmdTYW5pdGl6ZSBgbmdTYW5pdGl6ZWB9IG1vZHVsZSB0byBiZSBpbnN0YWxsZWQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBJbnB1dCB0ZXh0LgogICAqIEBwYXJhbSB7c3RyaW5nfSB0YXJnZXQgV2luZG93IChfYmxhbmt8X3NlbGZ8X3BhcmVudHxfdG9wKSBvciBuYW1lZCBmcmFtZSB0byBvcGVuIGxpbmtzIGluLgogICAqIEByZXR1cm5zIHtzdHJpbmd9IEh0bWwtbGlua2lmaWVkIHRleHQuCiAgICoKICAgKiBAdXNhZ2UKICAgPHNwYW4gbmctYmluZC1odG1sPSJsaW5reV9leHByZXNzaW9uIHwgbGlua3kiPjwvc3Bhbj4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0ibmdTYW5pdGl6ZSIgZGVwcz0iYW5ndWxhci1zYW5pdGl6ZS5qcyI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5zbmlwcGV0ID0KICAgICAgICAgICAgICdQcmV0dHkgdGV4dCB3aXRoIHNvbWUgbGlua3M6XG4nKwogICAgICAgICAgICAgJ2h0dHA6Ly9hbmd1bGFyanMub3JnLyxcbicrCiAgICAgICAgICAgICAnbWFpbHRvOnVzQHNvbWV3aGVyZS5vcmcsXG4nKwogICAnYW5vdGhlckBzb21ld2hlcmUub3JnLFxuJysKICAgJ2FuZCBvbmUgbW9yZTogZnRwOi8vMTI3LjAuMC4xLy4nOwogICAkc2NvcGUuc25pcHBldFdpdGhUYXJnZXQgPSAnaHR0cDovL2FuZ3VsYXJqcy5vcmcvJzsKICAgfQogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgU25pcHBldDogPHRleHRhcmVhIG5nLW1vZGVsPSJzbmlwcGV0IiBjb2xzPSI2MCIgcm93cz0iMyI+PC90ZXh0YXJlYT4KICAgPHRhYmxlPgogICA8dHI+CiAgIDx0ZD5GaWx0ZXI8L3RkPgogICA8dGQ+U291cmNlPC90ZD4KICAgPHRkPlJlbmRlcmVkPC90ZD4KICAgPC90cj4KICAgPHRyIGlkPSJsaW5reS1maWx0ZXIiPgogICA8dGQ+bGlua3kgZmlsdGVyPC90ZD4KICAgPHRkPgogICA8cHJlPiZsdDtkaXYgbmctYmluZC1odG1sPSJzbmlwcGV0IHwgbGlua3kiJmd0Ozxicj4mbHQ7L2RpdiZndDs8L3ByZT4KICAgPC90ZD4KICAgPHRkPgogICA8ZGl2IG5nLWJpbmQtaHRtbD0ic25pcHBldCB8IGxpbmt5Ij48L2Rpdj4KICAgPC90ZD4KICAgPC90cj4KICAgPHRyIGlkPSJsaW5reS10YXJnZXQiPgogICA8dGQ+bGlua3kgdGFyZ2V0PC90ZD4KICAgPHRkPgogICA8cHJlPiZsdDtkaXYgbmctYmluZC1odG1sPSJzbmlwcGV0V2l0aFRhcmdldCB8IGxpbmt5OidfYmxhbmsnIiZndDs8YnI+Jmx0Oy9kaXYmZ3Q7PC9wcmU+CiAgIDwvdGQ+CiAgIDx0ZD4KICAgPGRpdiBuZy1iaW5kLWh0bWw9InNuaXBwZXRXaXRoVGFyZ2V0IHwgbGlua3k6J19ibGFuayciPjwvZGl2PgogICA8L3RkPgogICA8L3RyPgogICA8dHIgaWQ9ImVzY2FwZWQtaHRtbCI+CiAgIDx0ZD5ubyBmaWx0ZXI8L3RkPgogICA8dGQ+PHByZT4mbHQ7ZGl2IG5nLWJpbmQ9InNuaXBwZXQiJmd0Ozxicj4mbHQ7L2RpdiZndDs8L3ByZT48L3RkPgogICA8dGQ+PGRpdiBuZy1iaW5kPSJzbmlwcGV0Ij48L2Rpdj48L3RkPgogICA8L3RyPgogICA8L3RhYmxlPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGxpbmtpZnkgdGhlIHNuaXBwZXQgd2l0aCB1cmxzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5reS1maWx0ZXInKSkuZWxlbWVudChieS5iaW5kaW5nKCdzbmlwcGV0IHwgbGlua3knKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgIHRvQmUoJ1ByZXR0eSB0ZXh0IHdpdGggc29tZSBsaW5rczogaHR0cDovL2FuZ3VsYXJqcy5vcmcvLCB1c0Bzb21ld2hlcmUub3JnLCAnICsKICAgJ2Fub3RoZXJAc29tZXdoZXJlLm9yZywgYW5kIG9uZSBtb3JlOiBmdHA6Ly8xMjcuMC4wLjEvLicpOwogICBleHBlY3QoZWxlbWVudC5hbGwoYnkuY3NzKCcjbGlua3ktZmlsdGVyIGEnKSkuY291bnQoKSkudG9FcXVhbCg0KTsKICAgfSk7CgogICBpdCgnc2hvdWxkIG5vdCBsaW5raWZ5IHNuaXBwZXQgd2l0aG91dCB0aGUgbGlua3kgZmlsdGVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdlc2NhcGVkLWh0bWwnKSkuZWxlbWVudChieS5iaW5kaW5nKCdzbmlwcGV0JykpLmdldFRleHQoKSkuCiAgICAgICAgICAgICB0b0JlKCdQcmV0dHkgdGV4dCB3aXRoIHNvbWUgbGlua3M6IGh0dHA6Ly9hbmd1bGFyanMub3JnLywgbWFpbHRvOnVzQHNvbWV3aGVyZS5vcmcsICcgKwogICAnYW5vdGhlckBzb21ld2hlcmUub3JnLCBhbmQgb25lIG1vcmU6IGZ0cDovLzEyNy4wLjAuMS8uJyk7CiAgIGV4cGVjdChlbGVtZW50LmFsbChieS5jc3MoJyNlc2NhcGVkLWh0bWwgYScpKS5jb3VudCgpKS50b0VxdWFsKDApOwogICB9KTsKCiAgIGl0KCdzaG91bGQgdXBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3NuaXBwZXQnKSkuY2xlYXIoKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc25pcHBldCcpKS5zZW5kS2V5cygnbmV3IGh0dHA6Ly9saW5rLicpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGlua3ktZmlsdGVyJykpLmVsZW1lbnQoYnkuYmluZGluZygnc25pcHBldCB8IGxpbmt5JykpLmdldFRleHQoKSkuCiAgICAgICAgICAgICB0b0JlKCduZXcgaHR0cDovL2xpbmsuJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50LmFsbChieS5jc3MoJyNsaW5reS1maWx0ZXIgYScpKS5jb3VudCgpKS50b0VxdWFsKDEpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZXNjYXBlZC1odG1sJykpLmVsZW1lbnQoYnkuYmluZGluZygnc25pcHBldCcpKS5nZXRUZXh0KCkpCiAgICAgICAgICAgICAudG9CZSgnbmV3IGh0dHA6Ly9saW5rLicpOwogICAgICAgfSk7CgogICBpdCgnc2hvdWxkIHdvcmsgd2l0aCB0aGUgdGFyZ2V0IHByb3BlcnR5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2xpbmt5LXRhcmdldCcpKS4KICAgICAgICAgICAgZWxlbWVudChieS5iaW5kaW5nKCJzbmlwcGV0V2l0aFRhcmdldCB8IGxpbmt5OidfYmxhbmsnIikpLmdldFRleHQoKSkuCiAgICAgICAgICAgIHRvQmUoJ2h0dHA6Ly9hbmd1bGFyanMub3JnLycpOwogICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnI2xpbmt5LXRhcmdldCBhJykpLmdldEF0dHJpYnV0ZSgndGFyZ2V0JykpLnRvRXF1YWwoJ19ibGFuaycpOwogICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIGFuZ3VsYXIubW9kdWxlKCduZ1Nhbml0aXplJykuZmlsdGVyKCdsaW5reScsIFsnJHNhbml0aXplJywgZnVuY3Rpb24oJHNhbml0aXplKSB7CiAgICB2YXIgTElOS1lfVVJMX1JFR0VYUCA9CiAgICAgICAgLygoZnRwfGh0dHBzPyk6XC9cL3wobWFpbHRvOik/W0EtWmEtejAtOS5fJSstXStAKVxTKlteXHMuOywoKXt9PD5dLywKICAgICAgTUFJTFRPX1JFR0VYUCA9IC9ebWFpbHRvOi87CgogICAgcmV0dXJuIGZ1bmN0aW9uKHRleHQsIHRhcmdldCkgewogICAgICBpZiAoIXRleHQpIHJldHVybiB0ZXh0OwogICAgICB2YXIgbWF0Y2g7CiAgICAgIHZhciByYXcgPSB0ZXh0OwogICAgICB2YXIgaHRtbCA9IFtdOwogICAgICB2YXIgdXJsOwogICAgICB2YXIgaTsKICAgICAgd2hpbGUgKChtYXRjaCA9IHJhdy5tYXRjaChMSU5LWV9VUkxfUkVHRVhQKSkpIHsKICAgICAgICAvLyBXZSBjYW4gbm90IGVuZCBpbiB0aGVzZSBhcyB0aGV5IGFyZSBzb21ldGltZXMgZm91bmQgYXQgdGhlIGVuZCBvZiB0aGUgc2VudGVuY2UKICAgICAgICB1cmwgPSBtYXRjaFswXTsKICAgICAgICAvLyBpZiB3ZSBkaWQgbm90IG1hdGNoIGZ0cC9odHRwL21haWx0byB0aGVuIGFzc3VtZSBtYWlsdG8KICAgICAgICBpZiAobWF0Y2hbMl0gPT0gbWF0Y2hbM10pIHVybCA9ICdtYWlsdG86JyArIHVybDsKICAgICAgICBpID0gbWF0Y2guaW5kZXg7CiAgICAgICAgYWRkVGV4dChyYXcuc3Vic3RyKDAsIGkpKTsKICAgICAgICBhZGRMaW5rKHVybCwgbWF0Y2hbMF0ucmVwbGFjZShNQUlMVE9fUkVHRVhQLCAnJykpOwogICAgICAgIHJhdyA9IHJhdy5zdWJzdHJpbmcoaSArIG1hdGNoWzBdLmxlbmd0aCk7CiAgICAgIH0KICAgICAgYWRkVGV4dChyYXcpOwogICAgICByZXR1cm4gJHNhbml0aXplKGh0bWwuam9pbignJykpOwoKICAgICAgZnVuY3Rpb24gYWRkVGV4dCh0ZXh0KSB7CiAgICAgICAgaWYgKCF0ZXh0KSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGh0bWwucHVzaChzYW5pdGl6ZVRleHQodGV4dCkpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBhZGRMaW5rKHVybCwgdGV4dCkgewogICAgICAgIGh0bWwucHVzaCgnPGEgJyk7CiAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKHRhcmdldCkpIHsKICAgICAgICAgIGh0bWwucHVzaCgndGFyZ2V0PSInKTsKICAgICAgICAgIGh0bWwucHVzaCh0YXJnZXQpOwogICAgICAgICAgaHRtbC5wdXNoKCciICcpOwogICAgICAgIH0KICAgICAgICBodG1sLnB1c2goJ2hyZWY9IicpOwogICAgICAgIGh0bWwucHVzaCh1cmwpOwogICAgICAgIGh0bWwucHVzaCgnIj4nKTsKICAgICAgICBhZGRUZXh0KHRleHQpOwogICAgICAgIGh0bWwucHVzaCgnPC9hPicpOwogICAgICB9CiAgICB9OwogIH1dKTsKCgp9KSh3aW5kb3csIHdpbmRvdy5hbmd1bGFyKTsKCi8qIQogKiBpb25pYy5idW5kbGUuanMgaXMgYSBjb25jYXRlbmF0aW9uIG9mOgogKiBpb25pYy5qcywgYW5ndWxhci5qcywgYW5ndWxhci1hbmltYXRlLmpzLAogKiBhbmd1bGFyLXNhbml0aXplLmpzLCBhbmd1bGFyLXVpLXJvdXRlci5qcywKICogYW5kIGlvbmljLWFuZ3VsYXIuanMKICovCgovKioKICogU3RhdGUtYmFzZWQgcm91dGluZyBmb3IgQW5ndWxhckpTCiAqIEB2ZXJzaW9uIHYwLjIuMTAKICogQGxpbmsgaHR0cDovL2FuZ3VsYXItdWkuZ2l0aHViLmNvbS8KICogQGxpY2Vuc2UgTUlUIExpY2Vuc2UsIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvTUlUCiAqLwoKLyogY29tbW9uanMgcGFja2FnZSBtYW5hZ2VyIHN1cHBvcnQgKGVnIGNvbXBvbmVudGpzKSAqLwppZiAodHlwZW9mIG1vZHVsZSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGV4cG9ydHMgIT09ICJ1bmRlZmluZWQiICYmIG1vZHVsZS5leHBvcnRzID09PSBleHBvcnRzKXsKICBtb2R1bGUuZXhwb3J0cyA9ICd1aS5yb3V0ZXInOwp9CgooZnVuY3Rpb24gKHdpbmRvdywgYW5ndWxhciwgdW5kZWZpbmVkKSB7CiAgLypqc2hpbnQgZ2xvYmFsc3RyaWN0OnRydWUqLwogIC8qZ2xvYmFsIGFuZ3VsYXI6ZmFsc2UqLwogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIGlzRGVmaW5lZCA9IGFuZ3VsYXIuaXNEZWZpbmVkLAogICAgaXNGdW5jdGlvbiA9IGFuZ3VsYXIuaXNGdW5jdGlvbiwKICAgIGlzU3RyaW5nID0gYW5ndWxhci5pc1N0cmluZywKICAgIGlzT2JqZWN0ID0gYW5ndWxhci5pc09iamVjdCwKICAgIGlzQXJyYXkgPSBhbmd1bGFyLmlzQXJyYXksCiAgICBmb3JFYWNoID0gYW5ndWxhci5mb3JFYWNoLAogICAgZXh0ZW5kID0gYW5ndWxhci5leHRlbmQsCiAgICBjb3B5ID0gYW5ndWxhci5jb3B5OwoKICBmdW5jdGlvbiBpbmhlcml0KHBhcmVudCwgZXh0cmEpIHsKICAgIHJldHVybiBleHRlbmQobmV3IChleHRlbmQoZnVuY3Rpb24oKSB7fSwgeyBwcm90b3R5cGU6IHBhcmVudCB9KSkoKSwgZXh0cmEpOwogIH0KCiAgZnVuY3Rpb24gbWVyZ2UoZHN0KSB7CiAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogIT09IGRzdCkgewogICAgICAgIGZvckVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBpZiAoIWRzdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSBkc3Rba2V5XSA9IHZhbHVlOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBkc3Q7CiAgfQoKICAvKioKICAgKiBGaW5kcyB0aGUgY29tbW9uIGFuY2VzdG9yIHBhdGggYmV0d2VlbiB0d28gc3RhdGVzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGZpcnN0IFRoZSBmaXJzdCBzdGF0ZS4KICAgKiBAcGFyYW0ge09iamVjdH0gc2Vjb25kIFRoZSBzZWNvbmQgc3RhdGUuCiAgICogQHJldHVybiB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2Ygc3RhdGUgbmFtZXMgaW4gZGVzY2VuZGluZyBvcmRlciwgbm90IGluY2x1ZGluZyB0aGUgcm9vdC4KICAgKi8KICBmdW5jdGlvbiBhbmNlc3RvcnMoZmlyc3QsIHNlY29uZCkgewogICAgdmFyIHBhdGggPSBbXTsKCiAgICBmb3IgKHZhciBuIGluIGZpcnN0LnBhdGgpIHsKICAgICAgaWYgKGZpcnN0LnBhdGhbbl0gIT09IHNlY29uZC5wYXRoW25dKSBicmVhazsKICAgICAgcGF0aC5wdXNoKGZpcnN0LnBhdGhbbl0pOwogICAgfQogICAgcmV0dXJuIHBhdGg7CiAgfQoKICAvKioKICAgKiBJRTgtc2FmZSB3cmFwcGVyIGZvciBgT2JqZWN0LmtleXMoKWAuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IEEgSmF2YVNjcmlwdCBvYmplY3QuCiAgICogQHJldHVybiB7QXJyYXl9IFJldHVybnMgdGhlIGtleXMgb2YgdGhlIG9iamVjdCBhcyBhbiBhcnJheS4KICAgKi8KICBmdW5jdGlvbiBrZXlzKG9iamVjdCkgewogICAgaWYgKE9iamVjdC5rZXlzKSB7CiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmplY3QpOwogICAgfQogICAgdmFyIHJlc3VsdCA9IFtdOwoKICAgIGFuZ3VsYXIuZm9yRWFjaChvYmplY3QsIGZ1bmN0aW9uKHZhbCwga2V5KSB7CiAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBJRTgtc2FmZSB3cmFwcGVyIGZvciBgQXJyYXkucHJvdG90eXBlLmluZGV4T2YoKWAuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBBIEphdmFTY3JpcHQgYXJyYXkuCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBBIHZhbHVlIHRvIHNlYXJjaCB0aGUgYXJyYXkgZm9yLgogICAqIEByZXR1cm4ge051bWJlcn0gUmV0dXJucyB0aGUgYXJyYXkgaW5kZXggdmFsdWUgb2YgYHZhbHVlYCwgb3IgYC0xYCBpZiBub3QgcHJlc2VudC4KICAgKi8KICBmdW5jdGlvbiBhcnJheVNlYXJjaChhcnJheSwgdmFsdWUpIHsKICAgIGlmIChBcnJheS5wcm90b3R5cGUuaW5kZXhPZikgewogICAgICByZXR1cm4gYXJyYXkuaW5kZXhPZih2YWx1ZSwgTnVtYmVyKGFyZ3VtZW50c1syXSkgfHwgMCk7CiAgICB9CiAgICB2YXIgbGVuID0gYXJyYXkubGVuZ3RoID4+PiAwLCBmcm9tID0gTnVtYmVyKGFyZ3VtZW50c1syXSkgfHwgMDsKICAgIGZyb20gPSAoZnJvbSA8IDApID8gTWF0aC5jZWlsKGZyb20pIDogTWF0aC5mbG9vcihmcm9tKTsKCiAgICBpZiAoZnJvbSA8IDApIGZyb20gKz0gbGVuOwoKICAgIGZvciAoOyBmcm9tIDwgbGVuOyBmcm9tKyspIHsKICAgICAgaWYgKGZyb20gaW4gYXJyYXkgJiYgYXJyYXlbZnJvbV0gPT09IHZhbHVlKSByZXR1cm4gZnJvbTsKICAgIH0KICAgIHJldHVybiAtMTsKICB9CgogIC8qKgogICAqIE1lcmdlcyBhIHNldCBvZiBwYXJhbWV0ZXJzIHdpdGggYWxsIHBhcmFtZXRlcnMgaW5oZXJpdGVkIGJldHdlZW4gdGhlIGNvbW1vbiBwYXJlbnRzIG9mIHRoZQogICAqIGN1cnJlbnQgc3RhdGUgYW5kIGEgZ2l2ZW4gZGVzdGluYXRpb24gc3RhdGUuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gY3VycmVudFBhcmFtcyBUaGUgdmFsdWUgb2YgdGhlIGN1cnJlbnQgc3RhdGUgcGFyYW1ldGVycyAoJHN0YXRlUGFyYW1zKS4KICAgKiBAcGFyYW0ge09iamVjdH0gbmV3UGFyYW1zIFRoZSBzZXQgb2YgcGFyYW1ldGVycyB3aGljaCB3aWxsIGJlIGNvbXBvc2l0ZWQgd2l0aCBpbmhlcml0ZWQgcGFyYW1zLgogICAqIEBwYXJhbSB7T2JqZWN0fSAkY3VycmVudCBJbnRlcm5hbCBkZWZpbml0aW9uIG9mIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIGN1cnJlbnQgc3RhdGUuCiAgICogQHBhcmFtIHtPYmplY3R9ICR0byBJbnRlcm5hbCBkZWZpbml0aW9uIG9mIG9iamVjdCByZXByZXNlbnRpbmcgc3RhdGUgdG8gdHJhbnNpdGlvbiB0by4KICAgKi8KICBmdW5jdGlvbiBpbmhlcml0UGFyYW1zKGN1cnJlbnRQYXJhbXMsIG5ld1BhcmFtcywgJGN1cnJlbnQsICR0bykgewogICAgdmFyIHBhcmVudHMgPSBhbmNlc3RvcnMoJGN1cnJlbnQsICR0byksIHBhcmVudFBhcmFtcywgaW5oZXJpdGVkID0ge30sIGluaGVyaXRMaXN0ID0gW107CgogICAgZm9yICh2YXIgaSBpbiBwYXJlbnRzKSB7CiAgICAgIGlmICghcGFyZW50c1tpXS5wYXJhbXMgfHwgIXBhcmVudHNbaV0ucGFyYW1zLmxlbmd0aCkgY29udGludWU7CiAgICAgIHBhcmVudFBhcmFtcyA9IHBhcmVudHNbaV0ucGFyYW1zOwoKICAgICAgZm9yICh2YXIgaiBpbiBwYXJlbnRQYXJhbXMpIHsKICAgICAgICBpZiAoYXJyYXlTZWFyY2goaW5oZXJpdExpc3QsIHBhcmVudFBhcmFtc1tqXSkgPj0gMCkgY29udGludWU7CiAgICAgICAgaW5oZXJpdExpc3QucHVzaChwYXJlbnRQYXJhbXNbal0pOwogICAgICAgIGluaGVyaXRlZFtwYXJlbnRQYXJhbXNbal1dID0gY3VycmVudFBhcmFtc1twYXJlbnRQYXJhbXNbal1dOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZXh0ZW5kKHt9LCBpbmhlcml0ZWQsIG5ld1BhcmFtcyk7CiAgfQoKICAvKioKICAgKiBOb3JtYWxpemVzIGEgc2V0IG9mIHZhbHVlcyB0byBzdHJpbmcgb3IgYG51bGxgLCBmaWx0ZXJpbmcgdGhlbSBieSBhIGxpc3Qgb2Yga2V5cy4KICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IGtleXMgVGhlIGxpc3Qgb2Yga2V5cyB0byBub3JtYWxpemUvcmV0dXJuLgogICAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZXMgQW4gb2JqZWN0IGhhc2ggb2YgdmFsdWVzIHRvIG5vcm1hbGl6ZS4KICAgKiBAcmV0dXJuIHtPYmplY3R9IFJldHVybnMgYW4gb2JqZWN0IGhhc2ggb2Ygbm9ybWFsaXplZCBzdHJpbmcgdmFsdWVzLgogICAqLwogIGZ1bmN0aW9uIG5vcm1hbGl6ZShrZXlzLCB2YWx1ZXMpIHsKICAgIHZhciBub3JtYWxpemVkID0ge307CgogICAgZm9yRWFjaChrZXlzLCBmdW5jdGlvbiAobmFtZSkgewogICAgICB2YXIgdmFsdWUgPSB2YWx1ZXNbbmFtZV07CiAgICAgIG5vcm1hbGl6ZWRbbmFtZV0gPSAodmFsdWUgIT0gbnVsbCkgPyBTdHJpbmcodmFsdWUpIDogbnVsbDsKICAgIH0pOwogICAgcmV0dXJuIG5vcm1hbGl6ZWQ7CiAgfQoKICAvKioKICAgKiBQZXJmb3JtcyBhIG5vbi1zdHJpY3QgY29tcGFyaXNvbiBvZiB0aGUgc3Vic2V0IG9mIHR3byBvYmplY3RzLCBkZWZpbmVkIGJ5IGEgbGlzdCBvZiBrZXlzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGEgVGhlIGZpcnN0IG9iamVjdC4KICAgKiBAcGFyYW0ge09iamVjdH0gYiBUaGUgc2Vjb25kIG9iamVjdC4KICAgKiBAcGFyYW0ge0FycmF5fSBrZXlzIFRoZSBsaXN0IG9mIGtleXMgd2l0aGluIGVhY2ggb2JqZWN0IHRvIGNvbXBhcmUuIElmIHRoZSBsaXN0IGlzIGVtcHR5IG9yIG5vdCBzcGVjaWZpZWQsCiAgICogICAgICAgICAgICAgICAgICAgICBpdCBkZWZhdWx0cyB0byB0aGUgbGlzdCBvZiBrZXlzIGluIGBhYC4KICAgKiBAcmV0dXJuIHtCb29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUga2V5cyBtYXRjaCwgb3RoZXJ3aXNlIGBmYWxzZWAuCiAgICovCiAgZnVuY3Rpb24gZXF1YWxGb3JLZXlzKGEsIGIsIGtleXMpIHsKICAgIGlmICgha2V5cykgewogICAgICBrZXlzID0gW107CiAgICAgIGZvciAodmFyIG4gaW4gYSkga2V5cy5wdXNoKG4pOyAvLyBVc2VkIGluc3RlYWQgb2YgT2JqZWN0LmtleXMoKSBmb3IgSUU4IGNvbXBhdGliaWxpdHkKICAgIH0KCiAgICBmb3IgKHZhciBpPTA7IGk8a2V5cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgayA9IGtleXNbaV07CiAgICAgIGlmIChhW2tdICE9IGJba10pIHJldHVybiBmYWxzZTsgLy8gTm90ICc9PT0nLCB2YWx1ZXMgYXJlbid0IG5lY2Vzc2FyaWx5IG5vcm1hbGl6ZWQKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KCiAgLyoqCiAgICogUmV0dXJucyB0aGUgc3Vic2V0IG9mIGFuIG9iamVjdCwgYmFzZWQgb24gYSBsaXN0IG9mIGtleXMuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fSBrZXlzCiAgICogQHBhcmFtIHtPYmplY3R9IHZhbHVlcwogICAqIEByZXR1cm4ge0Jvb2xlYW59IFJldHVybnMgYSBzdWJzZXQgb2YgYHZhbHVlc2AuCiAgICovCiAgZnVuY3Rpb24gZmlsdGVyQnlLZXlzKGtleXMsIHZhbHVlcykgewogICAgdmFyIGZpbHRlcmVkID0ge307CgogICAgZm9yRWFjaChrZXlzLCBmdW5jdGlvbiAobmFtZSkgewogICAgICBmaWx0ZXJlZFtuYW1lXSA9IHZhbHVlc1tuYW1lXTsKICAgIH0pOwogICAgcmV0dXJuIGZpbHRlcmVkOwogIH0KICAvKioKICAgKiBAbmdkb2Mgb3ZlcnZpZXcKICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogIyB1aS5yb3V0ZXIudXRpbCBzdWItbW9kdWxlCiAgICoKICAgKiBUaGlzIG1vZHVsZSBpcyBhIGRlcGVuZGVuY3kgb2Ygb3RoZXIgc3ViLW1vZHVsZXMuIERvIG5vdCBpbmNsdWRlIHRoaXMgbW9kdWxlIGFzIGEgZGVwZW5kZW5jeQogICAqIGluIHlvdXIgYW5ndWxhciBhcHAgKHVzZSB7QGxpbmsgdWkucm91dGVyfSBtb2R1bGUgaW5zdGVhZCkuCiAgICoKICAgKi8KICBhbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnV0aWwnLCBbJ25nJ10pOwoKICAvKioKICAgKiBAbmdkb2Mgb3ZlcnZpZXcKICAgKiBAbmFtZSB1aS5yb3V0ZXIucm91dGVyCiAgICoKICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnV0aWwKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqICMgdWkucm91dGVyLnJvdXRlciBzdWItbW9kdWxlCiAgICoKICAgKiBUaGlzIG1vZHVsZSBpcyBhIGRlcGVuZGVuY3kgb2Ygb3RoZXIgc3ViLW1vZHVsZXMuIERvIG5vdCBpbmNsdWRlIHRoaXMgbW9kdWxlIGFzIGEgZGVwZW5kZW5jeQogICAqIGluIHlvdXIgYW5ndWxhciBhcHAgKHVzZSB7QGxpbmsgdWkucm91dGVyfSBtb2R1bGUgaW5zdGVhZCkuCiAgICovCiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5yb3V0ZXInLCBbJ3VpLnJvdXRlci51dGlsJ10pOwoKICAvKioKICAgKiBAbmdkb2Mgb3ZlcnZpZXcKICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUKICAgKgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIucm91dGVyCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci51dGlsCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiAjIHVpLnJvdXRlci5zdGF0ZSBzdWItbW9kdWxlCiAgICoKICAgKiBUaGlzIG1vZHVsZSBpcyBhIGRlcGVuZGVuY3kgb2YgdGhlIG1haW4gdWkucm91dGVyIG1vZHVsZS4gRG8gbm90IGluY2x1ZGUgdGhpcyBtb2R1bGUgYXMgYSBkZXBlbmRlbmN5CiAgICogaW4geW91ciBhbmd1bGFyIGFwcCAodXNlIHtAbGluayB1aS5yb3V0ZXJ9IG1vZHVsZSBpbnN0ZWFkKS4KICAgKgogICAqLwogIGFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIuc3RhdGUnLCBbJ3VpLnJvdXRlci5yb3V0ZXInLCAndWkucm91dGVyLnV0aWwnXSk7CgogIC8qKgogICAqIEBuZ2RvYyBvdmVydmlldwogICAqIEBuYW1lIHVpLnJvdXRlcgogICAqCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogIyB1aS5yb3V0ZXIKICAgKgogICAqICMjIFRoZSBtYWluIG1vZHVsZSBmb3IgdWkucm91dGVyCiAgICogVGhlcmUgYXJlIHNldmVyYWwgc3ViLW1vZHVsZXMgaW5jbHVkZWQgd2l0aCB0aGUgdWkucm91dGVyIG1vZHVsZSwgaG93ZXZlciBvbmx5IHRoaXMgbW9kdWxlIGlzIG5lZWRlZAogICAqIGFzIGEgZGVwZW5kZW5jeSB3aXRoaW4geW91ciBhbmd1bGFyIGFwcC4gVGhlIG90aGVyIG1vZHVsZXMgYXJlIGZvciBvcmdhbml6YXRpb24gcHVycG9zZXMuCiAgICoKICAgKiBUaGUgbW9kdWxlcyBhcmU6CiAgICogKiB1aS5yb3V0ZXIgLSB0aGUgbWFpbiAidW1icmVsbGEiIG1vZHVsZQogICAqICogdWkucm91dGVyLnJvdXRlciAtCiAgICoKICAgKiAqWW91J2xsIG5lZWQgdG8gaW5jbHVkZSAqKm9ubHkqKiB0aGlzIG1vZHVsZSBhcyB0aGUgZGVwZW5kZW5jeSB3aXRoaW4geW91ciBhbmd1bGFyIGFwcC4qCiAgICoKICAgKiA8cHJlPgogICAqIDwhZG9jdHlwZSBodG1sPgogICAqIDxodG1sIG5nLWFwcD0ibXlBcHAiPgogICAqIDxoZWFkPgogICAqICAgPHNjcmlwdCBzcmM9ImpzL2FuZ3VsYXIuanMiPjwvc2NyaXB0PgogICAqICAgPCEtLSBJbmNsdWRlIHRoZSB1aS1yb3V0ZXIgc2NyaXB0IC0tPgogICAqICAgPHNjcmlwdCBzcmM9ImpzL2FuZ3VsYXItdWktcm91dGVyLm1pbi5qcyI+PC9zY3JpcHQ+CiAgICogICA8c2NyaXB0PgogICAqICAgICAvLyAuLi5hbmQgYWRkICd1aS5yb3V0ZXInIGFzIGEgZGVwZW5kZW5jeQogICAqICAgICB2YXIgbXlBcHAgPSBhbmd1bGFyLm1vZHVsZSgnbXlBcHAnLCBbJ3VpLnJvdXRlciddKTsKICAgKiAgIDwvc2NyaXB0PgogICAqIDwvaGVhZD4KICAgKiA8Ym9keT4KICAgKiA8L2JvZHk+CiAgICogPC9odG1sPgogICAqIDwvcHJlPgogICAqLwogIGFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXInLCBbJ3VpLnJvdXRlci5zdGF0ZSddKTsKCiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5jb21wYXQnLCBbJ3VpLnJvdXRlciddKTsKCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLiRyZXNvbHZlCiAgICoKICAgKiBAcmVxdWlyZXMgJHEKICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBNYW5hZ2VzIHJlc29sdXRpb24gb2YgKGFjeWNsaWMpIGdyYXBocyBvZiBwcm9taXNlcy4KICAgKi8KICAkUmVzb2x2ZS4kaW5qZWN0ID0gWyckcScsICckaW5qZWN0b3InXTsKICBmdW5jdGlvbiAkUmVzb2x2ZSggICRxLCAgICAkaW5qZWN0b3IpIHsKCiAgICB2YXIgVklTSVRfSU5fUFJPR1JFU1MgPSAxLAogICAgICBWSVNJVF9ET05FID0gMiwKICAgICAgTk9USElORyA9IHt9LAogICAgICBOT19ERVBFTkRFTkNJRVMgPSBbXSwKICAgICAgTk9fTE9DQUxTID0gTk9USElORywKICAgICAgTk9fUEFSRU5UID0gZXh0ZW5kKCRxLndoZW4oTk9USElORyksIHsgJCRwcm9taXNlczogTk9USElORywgJCR2YWx1ZXM6IE5PVEhJTkcgfSk7CgoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kcmVzb2x2ZSNzdHVkeQogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci51dGlsLiRyZXNvbHZlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTdHVkaWVzIGEgc2V0IG9mIGludm9jYWJsZXMgdGhhdCBhcmUgbGlrZWx5IHRvIGJlIHVzZWQgbXVsdGlwbGUgdGltZXMuCiAgICAgKiA8cHJlPgogICAgICogJHJlc29sdmUuc3R1ZHkoaW52b2NhYmxlcykobG9jYWxzLCBwYXJlbnQsIHNlbGYpCiAgICAgKiA8L3ByZT4KICAgICAqIGlzIGVxdWl2YWxlbnQgdG8KICAgICAqIDxwcmU+CiAgICAgKiAkcmVzb2x2ZS5yZXNvbHZlKGludm9jYWJsZXMsIGxvY2FscywgcGFyZW50LCBzZWxmKQogICAgICogPC9wcmU+CiAgICAgKiBidXQgdGhlIGZvcm1lciBpcyBtb3JlIGVmZmljaWVudCAoaW4gZmFjdCBgcmVzb2x2ZWAganVzdCBjYWxscyBgc3R1ZHlgCiAgICAgKiBpbnRlcm5hbGx5KS4KICAgICAqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW52b2NhYmxlcyBJbnZvY2FibGUgb2JqZWN0cwogICAgICogQHJldHVybiB7ZnVuY3Rpb259IGEgZnVuY3Rpb24gdG8gcGFzcyBpbiBsb2NhbHMsIHBhcmVudCBhbmQgc2VsZgogICAgICovCiAgICB0aGlzLnN0dWR5ID0gZnVuY3Rpb24gKGludm9jYWJsZXMpIHsKICAgICAgaWYgKCFpc09iamVjdChpbnZvY2FibGVzKSkgdGhyb3cgbmV3IEVycm9yKCInaW52b2NhYmxlcycgbXVzdCBiZSBhbiBvYmplY3QiKTsKCiAgICAgIC8vIFBlcmZvcm0gYSB0b3BvbG9naWNhbCBzb3J0IG9mIGludm9jYWJsZXMgdG8gYnVpbGQgYW4gb3JkZXJlZCBwbGFuCiAgICAgIHZhciBwbGFuID0gW10sIGN5Y2xlID0gW10sIHZpc2l0ZWQgPSB7fTsKICAgICAgZnVuY3Rpb24gdmlzaXQodmFsdWUsIGtleSkgewogICAgICAgIGlmICh2aXNpdGVkW2tleV0gPT09IFZJU0lUX0RPTkUpIHJldHVybjsKCiAgICAgICAgY3ljbGUucHVzaChrZXkpOwogICAgICAgIGlmICh2aXNpdGVkW2tleV0gPT09IFZJU0lUX0lOX1BST0dSRVNTKSB7CiAgICAgICAgICBjeWNsZS5zcGxpY2UoMCwgY3ljbGUuaW5kZXhPZihrZXkpKTsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ3ljbGljIGRlcGVuZGVuY3k6ICIgKyBjeWNsZS5qb2luKCIgLT4gIikpOwogICAgICAgIH0KICAgICAgICB2aXNpdGVkW2tleV0gPSBWSVNJVF9JTl9QUk9HUkVTUzsKCiAgICAgICAgaWYgKGlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgICAgcGxhbi5wdXNoKGtleSwgWyBmdW5jdGlvbigpIHsgcmV0dXJuICRpbmplY3Rvci5nZXQodmFsdWUpOyB9XSwgTk9fREVQRU5ERU5DSUVTKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHBhcmFtcyA9ICRpbmplY3Rvci5hbm5vdGF0ZSh2YWx1ZSk7CiAgICAgICAgICBmb3JFYWNoKHBhcmFtcywgZnVuY3Rpb24gKHBhcmFtKSB7CiAgICAgICAgICAgIGlmIChwYXJhbSAhPT0ga2V5ICYmIGludm9jYWJsZXMuaGFzT3duUHJvcGVydHkocGFyYW0pKSB2aXNpdChpbnZvY2FibGVzW3BhcmFtXSwgcGFyYW0pOwogICAgICAgICAgfSk7CiAgICAgICAgICBwbGFuLnB1c2goa2V5LCB2YWx1ZSwgcGFyYW1zKTsKICAgICAgICB9CgogICAgICAgIGN5Y2xlLnBvcCgpOwogICAgICAgIHZpc2l0ZWRba2V5XSA9IFZJU0lUX0RPTkU7CiAgICAgIH0KICAgICAgZm9yRWFjaChpbnZvY2FibGVzLCB2aXNpdCk7CiAgICAgIGludm9jYWJsZXMgPSBjeWNsZSA9IHZpc2l0ZWQgPSBudWxsOyAvLyBwbGFuIGlzIGFsbCB0aGF0J3MgcmVxdWlyZWQKCiAgICAgIGZ1bmN0aW9uIGlzUmVzb2x2ZSh2YWx1ZSkgewogICAgICAgIHJldHVybiBpc09iamVjdCh2YWx1ZSkgJiYgdmFsdWUudGhlbiAmJiB2YWx1ZS4kJHByb21pc2VzOwogICAgICB9CgogICAgICByZXR1cm4gZnVuY3Rpb24gKGxvY2FscywgcGFyZW50LCBzZWxmKSB7CiAgICAgICAgaWYgKGlzUmVzb2x2ZShsb2NhbHMpICYmIHNlbGYgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgc2VsZiA9IHBhcmVudDsgcGFyZW50ID0gbG9jYWxzOyBsb2NhbHMgPSBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAoIWxvY2FscykgbG9jYWxzID0gTk9fTE9DQUxTOwogICAgICAgIGVsc2UgaWYgKCFpc09iamVjdChsb2NhbHMpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIidsb2NhbHMnIG11c3QgYmUgYW4gb2JqZWN0Iik7CiAgICAgICAgfQogICAgICAgIGlmICghcGFyZW50KSBwYXJlbnQgPSBOT19QQVJFTlQ7CiAgICAgICAgZWxzZSBpZiAoIWlzUmVzb2x2ZShwYXJlbnQpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIidwYXJlbnQnIG11c3QgYmUgYSBwcm9taXNlIHJldHVybmVkIGJ5ICRyZXNvbHZlLnJlc29sdmUoKSIpOwogICAgICAgIH0KCiAgICAgICAgLy8gVG8gY29tcGxldGUgdGhlIG92ZXJhbGwgcmVzb2x1dGlvbiwgd2UgaGF2ZSB0byB3YWl0IGZvciB0aGUgcGFyZW50CiAgICAgICAgLy8gcHJvbWlzZSBhbmQgZm9yIHRoZSBwcm9taXNlIGZvciBlYWNoIGludm9rYWJsZSBpbiBvdXIgcGxhbi4KICAgICAgICB2YXIgcmVzb2x1dGlvbiA9ICRxLmRlZmVyKCksCiAgICAgICAgICByZXN1bHQgPSByZXNvbHV0aW9uLnByb21pc2UsCiAgICAgICAgICBwcm9taXNlcyA9IHJlc3VsdC4kJHByb21pc2VzID0ge30sCiAgICAgICAgICB2YWx1ZXMgPSBleHRlbmQoe30sIGxvY2FscyksCiAgICAgICAgICB3YWl0ID0gMSArIHBsYW4ubGVuZ3RoLzMsCiAgICAgICAgICBtZXJnZWQgPSBmYWxzZTsKCiAgICAgICAgZnVuY3Rpb24gZG9uZSgpIHsKICAgICAgICAgIC8vIE1lcmdlIHBhcmVudCB2YWx1ZXMgd2UgaGF2ZW4ndCBnb3QgeWV0IGFuZCBwdWJsaXNoIG91ciBvd24gJCR2YWx1ZXMKICAgICAgICAgIGlmICghLS13YWl0KSB7CiAgICAgICAgICAgIGlmICghbWVyZ2VkKSBtZXJnZSh2YWx1ZXMsIHBhcmVudC4kJHZhbHVlcyk7CiAgICAgICAgICAgIHJlc3VsdC4kJHZhbHVlcyA9IHZhbHVlczsKICAgICAgICAgICAgcmVzdWx0LiQkcHJvbWlzZXMgPSB0cnVlOyAvLyBrZWVwIGZvciBpc1Jlc29sdmUoKQogICAgICAgICAgICByZXNvbHV0aW9uLnJlc29sdmUodmFsdWVzKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGZhaWwocmVhc29uKSB7CiAgICAgICAgICByZXN1bHQuJCRmYWlsdXJlID0gcmVhc29uOwogICAgICAgICAgcmVzb2x1dGlvbi5yZWplY3QocmVhc29uKTsKICAgICAgICB9CgogICAgICAgIC8vIFNob3J0LWNpcmN1aXQgaWYgcGFyZW50IGhhcyBhbHJlYWR5IGZhaWxlZAogICAgICAgIGlmIChpc0RlZmluZWQocGFyZW50LiQkZmFpbHVyZSkpIHsKICAgICAgICAgIGZhaWwocGFyZW50LiQkZmFpbHVyZSk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KCiAgICAgICAgLy8gTWVyZ2UgcGFyZW50IHZhbHVlcyBpZiB0aGUgcGFyZW50IGhhcyBhbHJlYWR5IHJlc29sdmVkLCBvciBtZXJnZQogICAgICAgIC8vIHBhcmVudCBwcm9taXNlcyBhbmQgd2FpdCBpZiB0aGUgcGFyZW50IHJlc29sdmUgaXMgc3RpbGwgaW4gcHJvZ3Jlc3MuCiAgICAgICAgaWYgKHBhcmVudC4kJHZhbHVlcykgewogICAgICAgICAgbWVyZ2VkID0gbWVyZ2UodmFsdWVzLCBwYXJlbnQuJCR2YWx1ZXMpOwogICAgICAgICAgZG9uZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBleHRlbmQocHJvbWlzZXMsIHBhcmVudC4kJHByb21pc2VzKTsKICAgICAgICAgIHBhcmVudC50aGVuKGRvbmUsIGZhaWwpOwogICAgICAgIH0KCiAgICAgICAgLy8gUHJvY2VzcyBlYWNoIGludm9jYWJsZSBpbiB0aGUgcGxhbiwgYnV0IGlnbm9yZSBhbnkgd2hlcmUgYSBsb2NhbCBvZiB0aGUgc2FtZSBuYW1lIGV4aXN0cy4KICAgICAgICBmb3IgKHZhciBpPTAsIGlpPXBsYW4ubGVuZ3RoOyBpPGlpOyBpKz0zKSB7CiAgICAgICAgICBpZiAobG9jYWxzLmhhc093blByb3BlcnR5KHBsYW5baV0pKSBkb25lKCk7CiAgICAgICAgICBlbHNlIGludm9rZShwbGFuW2ldLCBwbGFuW2krMV0sIHBsYW5baSsyXSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBpbnZva2Uoa2V5LCBpbnZvY2FibGUsIHBhcmFtcykgewogICAgICAgICAgLy8gQ3JlYXRlIGEgZGVmZXJyZWQgZm9yIHRoaXMgaW52b2NhdGlvbi4gRmFpbHVyZXMgd2lsbCBwcm9wYWdhdGUgdG8gdGhlIHJlc29sdXRpb24gYXMgd2VsbC4KICAgICAgICAgIHZhciBpbnZvY2F0aW9uID0gJHEuZGVmZXIoKSwgd2FpdFBhcmFtcyA9IDA7CiAgICAgICAgICBmdW5jdGlvbiBvbmZhaWx1cmUocmVhc29uKSB7CiAgICAgICAgICAgIGludm9jYXRpb24ucmVqZWN0KHJlYXNvbik7CiAgICAgICAgICAgIGZhaWwocmVhc29uKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIFdhaXQgZm9yIGFueSBwYXJhbWV0ZXIgdGhhdCB3ZSBoYXZlIGEgcHJvbWlzZSBmb3IgKGVpdGhlciBmcm9tIHBhcmVudCBvciBmcm9tIHRoaXMKICAgICAgICAgIC8vIHJlc29sdmU7IGluIHRoYXQgY2FzZSBzdHVkeSgpIHdpbGwgaGF2ZSBtYWRlIHN1cmUgaXQncyBvcmRlcmVkIGJlZm9yZSB1cyBpbiB0aGUgcGxhbikuCiAgICAgICAgICBmb3JFYWNoKHBhcmFtcywgZnVuY3Rpb24gKGRlcCkgewogICAgICAgICAgICBpZiAocHJvbWlzZXMuaGFzT3duUHJvcGVydHkoZGVwKSAmJiAhbG9jYWxzLmhhc093blByb3BlcnR5KGRlcCkpIHsKICAgICAgICAgICAgICB3YWl0UGFyYW1zKys7CiAgICAgICAgICAgICAgcHJvbWlzZXNbZGVwXS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgICAgICAgIHZhbHVlc1tkZXBdID0gcmVzdWx0OwogICAgICAgICAgICAgICAgaWYgKCEoLS13YWl0UGFyYW1zKSkgcHJvY2VlZCgpOwogICAgICAgICAgICAgIH0sIG9uZmFpbHVyZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKCF3YWl0UGFyYW1zKSBwcm9jZWVkKCk7CiAgICAgICAgICBmdW5jdGlvbiBwcm9jZWVkKCkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHJlc3VsdC4kJGZhaWx1cmUpKSByZXR1cm47CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaW52b2NhdGlvbi5yZXNvbHZlKCRpbmplY3Rvci5pbnZva2UoaW52b2NhYmxlLCBzZWxmLCB2YWx1ZXMpKTsKICAgICAgICAgICAgICBpbnZvY2F0aW9uLnByb21pc2UudGhlbihmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICAgICAgICB2YWx1ZXNba2V5XSA9IHJlc3VsdDsKICAgICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgICB9LCBvbmZhaWx1cmUpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgb25mYWlsdXJlKGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAvLyBQdWJsaXNoIHByb21pc2Ugc3luY2hyb25vdXNseTsgaW52b2NhdGlvbnMgZnVydGhlciBkb3duIGluIHRoZSBwbGFuIG1heSBkZXBlbmQgb24gaXQuCiAgICAgICAgICBwcm9taXNlc1trZXldID0gaW52b2NhdGlvbi5wcm9taXNlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLiRyZXNvbHZlI3Jlc29sdmUKICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC4kcmVzb2x2ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVzb2x2ZXMgYSBzZXQgb2YgaW52b2NhYmxlcy4gQW4gaW52b2NhYmxlIGlzIGEgZnVuY3Rpb24gdG8gYmUgaW52b2tlZCB2aWEKICAgICAqIGAkaW5qZWN0b3IuaW52b2tlKClgLCBhbmQgY2FuIGhhdmUgYW4gYXJiaXRyYXJ5IG51bWJlciBvZiBkZXBlbmRlbmNpZXMuCiAgICAgKiBBbiBpbnZvY2FibGUgY2FuIGVpdGhlciByZXR1cm4gYSB2YWx1ZSBkaXJlY3RseSwKICAgICAqIG9yIGEgYCRxYCBwcm9taXNlLiBJZiBhIHByb21pc2UgaXMgcmV0dXJuZWQgaXQgd2lsbCBiZSByZXNvbHZlZCBhbmQgdGhlCiAgICAgKiByZXN1bHRpbmcgdmFsdWUgd2lsbCBiZSB1c2VkIGluc3RlYWQuIERlcGVuZGVuY2llcyBvZiBpbnZvY2FibGVzIGFyZSByZXNvbHZlZAogICAgICogKGluIHRoaXMgb3JkZXIgb2YgcHJlY2VkZW5jZSkKICAgICAqCiAgICAgKiAtIGZyb20gdGhlIHNwZWNpZmllZCBgbG9jYWxzYAogICAgICogLSBmcm9tIGFub3RoZXIgaW52b2NhYmxlIHRoYXQgaXMgcGFydCBvZiB0aGlzIGAkcmVzb2x2ZWAgY2FsbAogICAgICogLSBmcm9tIGFuIGludm9jYWJsZSB0aGF0IGlzIGluaGVyaXRlZCBmcm9tIGEgYHBhcmVudGAgY2FsbCB0byBgJHJlc29sdmVgCiAgICAgKiAgIChvciByZWN1cnNpdmVseQogICAgICogLSBmcm9tIGFueSBhbmNlc3RvciBgJHJlc29sdmVgIG9mIHRoYXQgcGFyZW50KS4KICAgICAqCiAgICAgKiBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkcmVzb2x2ZWAgaXMgYSBwcm9taXNlIGZvciBhbiBvYmplY3QgdGhhdCBjb250YWlucwogICAgICogKGluIHRoaXMgb3JkZXIgb2YgcHJlY2VkZW5jZSkKICAgICAqCiAgICAgKiAtIGFueSBgbG9jYWxzYCAoaWYgc3BlY2lmaWVkKQogICAgICogLSB0aGUgcmVzb2x2ZWQgcmV0dXJuIHZhbHVlcyBvZiBhbGwgaW5qZWN0YWJsZXMKICAgICAqIC0gYW55IHZhbHVlcyBpbmhlcml0ZWQgZnJvbSBhIGBwYXJlbnRgIGNhbGwgdG8gYCRyZXNvbHZlYCAoaWYgc3BlY2lmaWVkKQogICAgICoKICAgICAqIFRoZSBwcm9taXNlIHdpbGwgcmVzb2x2ZSBhZnRlciB0aGUgYHBhcmVudGAgcHJvbWlzZSAoaWYgYW55KSBhbmQgYWxsIHByb21pc2VzCiAgICAgKiByZXR1cm5lZCBieSBpbmplY3RhYmxlcyBoYXZlIGJlZW4gcmVzb2x2ZWQuIElmIGFueSBpbnZvY2FibGUKICAgICAqIChvciBgJGluamVjdG9yLmludm9rZWApIHRocm93cyBhbiBleGNlcHRpb24sIG9yIGlmIGEgcHJvbWlzZSByZXR1cm5lZCBieSBhbgogICAgICogaW52b2NhYmxlIGlzIHJlamVjdGVkLCB0aGUgYCRyZXNvbHZlYCBwcm9taXNlIGlzIGltbWVkaWF0ZWx5IHJlamVjdGVkIHdpdGggdGhlCiAgICAgKiBzYW1lIGVycm9yLiBBIHJlamVjdGlvbiBvZiBhIGBwYXJlbnRgIHByb21pc2UgKGlmIHNwZWNpZmllZCkgd2lsbCBsaWtld2lzZSBiZQogICAgICogcHJvcGFnYXRlZCBpbW1lZGlhdGVseS4gT25jZSB0aGUgYCRyZXNvbHZlYCBwcm9taXNlIGhhcyBiZWVuIHJlamVjdGVkLCBubwogICAgICogZnVydGhlciBpbnZvY2FibGVzIHdpbGwgYmUgY2FsbGVkLgogICAgICoKICAgICAqIEN5Y2xpYyBkZXBlbmRlbmNpZXMgYmV0d2VlbiBpbnZvY2FibGVzIGFyZSBub3QgcGVybWl0dGVkIGFuZCB3aWxsIGNhdWVzIGAkcmVzb2x2ZWAKICAgICAqIHRvIHRocm93IGFuIGVycm9yLiBBcyBhIHNwZWNpYWwgY2FzZSwgYW4gaW5qZWN0YWJsZSBjYW4gZGVwZW5kIG9uIGEgcGFyYW1ldGVyCiAgICAgKiB3aXRoIHRoZSBzYW1lIG5hbWUgYXMgdGhlIGluamVjdGFibGUsIHdoaWNoIHdpbGwgYmUgZnVsZmlsbGVkIGZyb20gdGhlIGBwYXJlbnRgCiAgICAgKiBpbmplY3RhYmxlIG9mIHRoZSBzYW1lIG5hbWUuIFRoaXMgYWxsb3dzIGluaGVyaXRlZCB2YWx1ZXMgdG8gYmUgZGVjb3JhdGVkLgogICAgICogTm90ZSB0aGF0IGluIHRoaXMgY2FzZSBhbnkgb3RoZXIgaW5qZWN0YWJsZSBpbiB0aGUgc2FtZSBgJHJlc29sdmVgIHdpdGggdGhlIHNhbWUKICAgICAqIGRlcGVuZGVuY3kgd291bGQgc2VlIHRoZSBkZWNvcmF0ZWQgdmFsdWUsIG5vdCB0aGUgaW5oZXJpdGVkIHZhbHVlLgogICAgICoKICAgICAqIE5vdGUgdGhhdCBtaXNzaW5nIGRlcGVuZGVuY2llcyAtLSB1bmxpa2UgY3ljbGljIGRlcGVuZGVuY2llcyAtLSB3aWxsIGNhdXNlIGFuCiAgICAgKiAoYXN5bmNocm9ub3VzKSByZWplY3Rpb24gb2YgdGhlIGAkcmVzb2x2ZWAgcHJvbWlzZSByYXRoZXIgdGhhbiBhIChzeW5jaHJvbm91cykKICAgICAqIGV4Y2VwdGlvbi4KICAgICAqCiAgICAgKiBJbnZvY2FibGVzIGFyZSBpbnZva2VkIGVhZ2VybHkgYXMgc29vbiBhcyBhbGwgZGVwZW5kZW5jaWVzIGFyZSBhdmFpbGFibGUuCiAgICAgKiBUaGlzIGlzIHRydWUgZXZlbiBmb3IgZGVwZW5kZW5jaWVzIGluaGVyaXRlZCBmcm9tIGEgYHBhcmVudGAgY2FsbCB0byBgJHJlc29sdmVgLgogICAgICoKICAgICAqIEFzIGEgc3BlY2lhbCBjYXNlLCBhbiBpbnZvY2FibGUgY2FuIGJlIGEgc3RyaW5nLCBpbiB3aGljaCBjYXNlIGl0IGlzIHRha2VuIHRvCiAgICAgKiBiZSBhIHNlcnZpY2UgbmFtZSB0byBiZSBwYXNzZWQgdG8gYCRpbmplY3Rvci5nZXQoKWAuIFRoaXMgaXMgc3VwcG9ydGVkIHByaW1hcmlseQogICAgICogZm9yIGJhY2t3YXJkcy1jb21wYXRpYmlsaXR5IHdpdGggdGhlIGByZXNvbHZlYCBwcm9wZXJ0eSBvZiBgJHJvdXRlUHJvdmlkZXJgCiAgICAgKiByb3V0ZXMuCiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IGludm9jYWJsZXMgZnVuY3Rpb25zIHRvIGludm9rZSBvcgogICAgICogYCRpbmplY3RvcmAgc2VydmljZXMgdG8gZmV0Y2guCiAgICAgKiBAcGFyYW0ge29iamVjdH0gbG9jYWxzICB2YWx1ZXMgdG8gbWFrZSBhdmFpbGFibGUgdG8gdGhlIGluamVjdGFibGVzCiAgICAgKiBAcGFyYW0ge29iamVjdH0gcGFyZW50ICBhIHByb21pc2UgcmV0dXJuZWQgYnkgYW5vdGhlciBjYWxsIHRvIGAkcmVzb2x2ZWAuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gc2VsZiAgdGhlIGB0aGlzYCBmb3IgdGhlIGludm9rZWQgbWV0aG9kcwogICAgICogQHJldHVybiB7b2JqZWN0fSBQcm9taXNlIGZvciBhbiBvYmplY3QgdGhhdCBjb250YWlucyB0aGUgcmVzb2x2ZWQgcmV0dXJuIHZhbHVlCiAgICAgKiBvZiBhbGwgaW52b2NhYmxlcywgYXMgd2VsbCBhcyBhbnkgaW5oZXJpdGVkIGFuZCBsb2NhbCB2YWx1ZXMuCiAgICAgKi8KICAgIHRoaXMucmVzb2x2ZSA9IGZ1bmN0aW9uIChpbnZvY2FibGVzLCBsb2NhbHMsIHBhcmVudCwgc2VsZikgewogICAgICByZXR1cm4gdGhpcy5zdHVkeShpbnZvY2FibGVzKShsb2NhbHMsIHBhcmVudCwgc2VsZik7CiAgICB9OwogIH0KCiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci51dGlsJykuc2VydmljZSgnJHJlc29sdmUnLCAkUmVzb2x2ZSk7CgoKICAvKioKICAgKiBAbmdkb2Mgb2JqZWN0CiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeQogICAqCiAgICogQHJlcXVpcmVzICRodHRwCiAgICogQHJlcXVpcmVzICR0ZW1wbGF0ZUNhY2hlCiAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2VydmljZS4gTWFuYWdlcyBsb2FkaW5nIG9mIHRlbXBsYXRlcy4KICAgKi8KICAkVGVtcGxhdGVGYWN0b3J5LiRpbmplY3QgPSBbJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywgJyRpbmplY3RvciddOwogIGZ1bmN0aW9uICRUZW1wbGF0ZUZhY3RvcnkoICAkaHR0cCwgICAkdGVtcGxhdGVDYWNoZSwgICAkaW5qZWN0b3IpIHsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeSNmcm9tQ29uZmlnCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlcyBhIHRlbXBsYXRlIGZyb20gYSBjb25maWd1cmF0aW9uIG9iamVjdC4KICAgICAqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gY29uZmlnIENvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciB3aGljaCB0byBsb2FkIGEgdGVtcGxhdGUuCiAgICAgKiBUaGUgZm9sbG93aW5nIHByb3BlcnRpZXMgYXJlIHNlYXJjaCBpbiB0aGUgc3BlY2lmaWVkIG9yZGVyLCBhbmQgdGhlIGZpcnN0IG9uZQogICAgICogdGhhdCBpcyBkZWZpbmVkIGlzIHVzZWQgdG8gY3JlYXRlIHRoZSB0ZW1wbGF0ZToKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3R9IGNvbmZpZy50ZW1wbGF0ZSBodG1sIHN0cmluZyB0ZW1wbGF0ZSBvciBmdW5jdGlvbiB0bwogICAgICogbG9hZCB2aWEge0BsaW5rIHVpLnJvdXRlci51dGlsLiR0ZW1wbGF0ZUZhY3RvcnkjZnJvbVN0cmluZyBmcm9tU3RyaW5nfS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gY29uZmlnLnRlbXBsYXRlVXJsIHVybCB0byBsb2FkIG9yIGEgZnVuY3Rpb24gcmV0dXJuaW5nCiAgICAgKiB0aGUgdXJsIHRvIGxvYWQgdmlhIHtAbGluayB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5I2Zyb21VcmwgZnJvbVVybH0uCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25maWcudGVtcGxhdGVQcm92aWRlciBmdW5jdGlvbiB0byBpbnZva2UgdmlhCiAgICAgKiB7QGxpbmsgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeSNmcm9tUHJvdmlkZXIgZnJvbVByb3ZpZGVyfS4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJhbXMgIFBhcmFtZXRlcnMgdG8gcGFzcyB0byB0aGUgdGVtcGxhdGUgZnVuY3Rpb24uCiAgICAgKiBAcGFyYW0ge29iamVjdH0gbG9jYWxzIExvY2FscyB0byBwYXNzIHRvIGBpbnZva2VgIGlmIHRoZSB0ZW1wbGF0ZSBpcyBsb2FkZWQKICAgICAqIHZpYSBhIGB0ZW1wbGF0ZVByb3ZpZGVyYC4gRGVmYXVsdHMgdG8gYHsgcGFyYW1zOiBwYXJhbXMgfWAuCiAgICAgKgogICAgICogQHJldHVybiB7c3RyaW5nfG9iamVjdH0gIFRoZSB0ZW1wbGF0ZSBodG1sIGFzIGEgc3RyaW5nLCBvciBhIHByb21pc2UgZm9yCiAgICAgKiB0aGF0IHN0cmluZyxvciBgbnVsbGAgaWYgbm8gdGVtcGxhdGUgaXMgY29uZmlndXJlZC4KICAgICAqLwogICAgdGhpcy5mcm9tQ29uZmlnID0gZnVuY3Rpb24gKGNvbmZpZywgcGFyYW1zLCBsb2NhbHMpIHsKICAgICAgcmV0dXJuICgKICAgICAgICBpc0RlZmluZWQoY29uZmlnLnRlbXBsYXRlKSA/IHRoaXMuZnJvbVN0cmluZyhjb25maWcudGVtcGxhdGUsIHBhcmFtcykgOgogICAgICAgICAgaXNEZWZpbmVkKGNvbmZpZy50ZW1wbGF0ZVVybCkgPyB0aGlzLmZyb21VcmwoY29uZmlnLnRlbXBsYXRlVXJsLCBwYXJhbXMpIDoKICAgICAgICAgICAgaXNEZWZpbmVkKGNvbmZpZy50ZW1wbGF0ZVByb3ZpZGVyKSA/IHRoaXMuZnJvbVByb3ZpZGVyKGNvbmZpZy50ZW1wbGF0ZVByb3ZpZGVyLCBwYXJhbXMsIGxvY2FscykgOgogICAgICAgICAgICAgIG51bGwKICAgICAgICApOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeSNmcm9tU3RyaW5nCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlcyBhIHRlbXBsYXRlIGZyb20gYSBzdHJpbmcgb3IgYSBmdW5jdGlvbiByZXR1cm5pbmcgYSBzdHJpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSB0ZW1wbGF0ZSBodG1sIHRlbXBsYXRlIGFzIGEgc3RyaW5nIG9yIGZ1bmN0aW9uIHRoYXQKICAgICAqIHJldHVybnMgYW4gaHRtbCB0ZW1wbGF0ZSBhcyBhIHN0cmluZy4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJhbXMgUGFyYW1ldGVycyB0byBwYXNzIHRvIHRoZSB0ZW1wbGF0ZSBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtzdHJpbmd8b2JqZWN0fSBUaGUgdGVtcGxhdGUgaHRtbCBhcyBhIHN0cmluZywgb3IgYSBwcm9taXNlIGZvciB0aGF0CiAgICAgKiBzdHJpbmcuCiAgICAgKi8KICAgIHRoaXMuZnJvbVN0cmluZyA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgcGFyYW1zKSB7CiAgICAgIHJldHVybiBpc0Z1bmN0aW9uKHRlbXBsYXRlKSA/IHRlbXBsYXRlKHBhcmFtcykgOiB0ZW1wbGF0ZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLiR0ZW1wbGF0ZUZhY3RvcnkjZnJvbVVybAogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci51dGlsLiR0ZW1wbGF0ZUZhY3RvcnkKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIExvYWRzIGEgdGVtcGxhdGUgZnJvbSB0aGUgYSBVUkwgdmlhIGAkaHR0cGAgYW5kIGAkdGVtcGxhdGVDYWNoZWAuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8RnVuY3Rpb259IHVybCB1cmwgb2YgdGhlIHRlbXBsYXRlIHRvIGxvYWQsIG9yIGEgZnVuY3Rpb24KICAgICAqIHRoYXQgcmV0dXJucyBhIHVybC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgUGFyYW1ldGVycyB0byBwYXNzIHRvIHRoZSB1cmwgZnVuY3Rpb24uCiAgICAgKiBAcmV0dXJuIHtzdHJpbmd8UHJvbWlzZS48c3RyaW5nPn0gVGhlIHRlbXBsYXRlIGh0bWwgYXMgYSBzdHJpbmcsIG9yIGEgcHJvbWlzZQogICAgICogZm9yIHRoYXQgc3RyaW5nLgogICAgICovCiAgICB0aGlzLmZyb21VcmwgPSBmdW5jdGlvbiAodXJsLCBwYXJhbXMpIHsKICAgICAgaWYgKGlzRnVuY3Rpb24odXJsKSkgdXJsID0gdXJsKHBhcmFtcyk7CiAgICAgIGlmICh1cmwgPT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICAgIGVsc2UgcmV0dXJuICRodHRwCiAgICAgICAgLmdldCh1cmwsIHsgY2FjaGU6ICR0ZW1wbGF0ZUNhY2hlIH0pCiAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsgcmV0dXJuIHJlc3BvbnNlLmRhdGE7IH0pOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeSNmcm9tVXJsCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlcyBhIHRlbXBsYXRlIGJ5IGludm9raW5nIGFuIGluamVjdGFibGUgcHJvdmlkZXIgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gcHJvdmlkZXIgRnVuY3Rpb24gdG8gaW52b2tlIHZpYSBgJGluamVjdG9yLmludm9rZWAKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgUGFyYW1ldGVycyBmb3IgdGhlIHRlbXBsYXRlLgogICAgICogQHBhcmFtIHtPYmplY3R9IGxvY2FscyBMb2NhbHMgdG8gcGFzcyB0byBgaW52b2tlYC4gRGVmYXVsdHMgdG8KICAgICAqIGB7IHBhcmFtczogcGFyYW1zIH1gLgogICAgICogQHJldHVybiB7c3RyaW5nfFByb21pc2UuPHN0cmluZz59IFRoZSB0ZW1wbGF0ZSBodG1sIGFzIGEgc3RyaW5nLCBvciBhIHByb21pc2UKICAgICAqIGZvciB0aGF0IHN0cmluZy4KICAgICAqLwogICAgdGhpcy5mcm9tUHJvdmlkZXIgPSBmdW5jdGlvbiAocHJvdmlkZXIsIHBhcmFtcywgbG9jYWxzKSB7CiAgICAgIHJldHVybiAkaW5qZWN0b3IuaW52b2tlKHByb3ZpZGVyLCBudWxsLCBsb2NhbHMgfHwgeyBwYXJhbXM6IHBhcmFtcyB9KTsKICAgIH07CiAgfQoKICBhbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnV0aWwnKS5zZXJ2aWNlKCckdGVtcGxhdGVGYWN0b3J5JywgJFRlbXBsYXRlRmFjdG9yeSk7CgogIC8qKgogICAqIEBuZ2RvYyBvYmplY3QKICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIE1hdGNoZXMgVVJMcyBhZ2FpbnN0IHBhdHRlcm5zIGFuZCBleHRyYWN0cyBuYW1lZCBwYXJhbWV0ZXJzIGZyb20gdGhlIHBhdGggb3IgdGhlIHNlYXJjaAogICAqIHBhcnQgb2YgdGhlIFVSTC4gQSBVUkwgcGF0dGVybiBjb25zaXN0cyBvZiBhIHBhdGggcGF0dGVybiwgb3B0aW9uYWxseSBmb2xsb3dlZCBieSAnPycgYW5kIGEgbGlzdAogICAqIG9mIHNlYXJjaCBwYXJhbWV0ZXJzLiBNdWx0aXBsZSBzZWFyY2ggcGFyYW1ldGVyIG5hbWVzIGFyZSBzZXBhcmF0ZWQgYnkgJyYnLiBTZWFyY2ggcGFyYW1ldGVycwogICAqIGRvIG5vdCBpbmZsdWVuY2Ugd2hldGhlciBvciBub3QgYSBVUkwgaXMgbWF0Y2hlZCwgYnV0IHRoZWlyIHZhbHVlcyBhcmUgcGFzc2VkIHRocm91Z2ggaW50bwogICAqIHRoZSBtYXRjaGVkIHBhcmFtZXRlcnMgcmV0dXJuZWQgYnkge0BsaW5rIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlciNtZXRob2RzX2V4ZWMgZXhlY30uCiAgICoKICAgKiBQYXRoIHBhcmFtZXRlciBwbGFjZWhvbGRlcnMgY2FuIGJlIHNwZWNpZmllZCB1c2luZyBzaW1wbGUgY29sb24vY2F0Y2gtYWxsIHN5bnRheCBvciBjdXJseSBicmFjZQogICAqIHN5bnRheCwgd2hpY2ggb3B0aW9uYWxseSBhbGxvd3MgYSByZWd1bGFyIGV4cHJlc3Npb24gZm9yIHRoZSBwYXJhbWV0ZXIgdG8gYmUgc3BlY2lmaWVkOgogICAqCiAgICogKiBgJzonYCBuYW1lIC0gY29sb24gcGxhY2Vob2xkZXIKICAgKiAqIGAnKidgIG5hbWUgLSBjYXRjaC1hbGwgcGxhY2Vob2xkZXIKICAgKiAqIGAneycgbmFtZSAnfSdgIC0gY3VybHkgcGxhY2Vob2xkZXIKICAgKiAqIGAneycgbmFtZSAnOicgcmVnZXhwICd9J2AgLSBjdXJseSBwbGFjZWhvbGRlciB3aXRoIHJlZ2V4cC4gU2hvdWxkIHRoZSByZWdleHAgaXRzZWxmIGNvbnRhaW4KICAgKiAgIGN1cmx5IGJyYWNlcywgdGhleSBtdXN0IGJlIGluIG1hdGNoZWQgcGFpcnMgb3IgZXNjYXBlZCB3aXRoIGEgYmFja3NsYXNoLgogICAqCiAgICogUGFyYW1ldGVyIG5hbWVzIG1heSBjb250YWluIG9ubHkgd29yZCBjaGFyYWN0ZXJzIChsYXRpbiBsZXR0ZXJzLCBkaWdpdHMsIGFuZCB1bmRlcnNjb3JlKSBhbmQKICAgKiBtdXN0IGJlIHVuaXF1ZSB3aXRoaW4gdGhlIHBhdHRlcm4gKGFjcm9zcyBib3RoIHBhdGggYW5kIHNlYXJjaCBwYXJhbWV0ZXJzKS4gRm9yIGNvbG9uCiAgICogcGxhY2Vob2xkZXJzIG9yIGN1cmx5IHBsYWNlaG9sZGVycyB3aXRob3V0IGFuIGV4cGxpY2l0IHJlZ2V4cCwgYSBwYXRoIHBhcmFtZXRlciBtYXRjaGVzIGFueQogICAqIG51bWJlciBvZiBjaGFyYWN0ZXJzIG90aGVyIHRoYW4gJy8nLiBGb3IgY2F0Y2gtYWxsIHBsYWNlaG9sZGVycyB0aGUgcGF0aCBwYXJhbWV0ZXIgbWF0Y2hlcwogICAqIGFueSBudW1iZXIgb2YgY2hhcmFjdGVycy4KICAgKgogICAqIEV4YW1wbGVzOgogICAqCiAgICogKiBgJy9oZWxsby8nYCAtIE1hdGNoZXMgb25seSBpZiB0aGUgcGF0aCBpcyBleGFjdGx5ICcvaGVsbG8vJy4gVGhlcmUgaXMgbm8gc3BlY2lhbCB0cmVhdG1lbnQgZm9yCiAgICogICB0cmFpbGluZyBzbGFzaGVzLCBhbmQgcGF0dGVybnMgaGF2ZSB0byBtYXRjaCB0aGUgZW50aXJlIHBhdGgsIG5vdCBqdXN0IGEgcHJlZml4LgogICAqICogYCcvdXNlci86aWQnYCAtIE1hdGNoZXMgJy91c2VyL2JvYicgb3IgJy91c2VyLzEyMzQhISEnIG9yIGV2ZW4gJy91c2VyLycgYnV0IG5vdCAnL3VzZXInIG9yCiAgICogICAnL3VzZXIvYm9iL2RldGFpbHMnLiBUaGUgc2Vjb25kIHBhdGggc2VnbWVudCB3aWxsIGJlIGNhcHR1cmVkIGFzIHRoZSBwYXJhbWV0ZXIgJ2lkJy4KICAgKiAqIGAnL3VzZXIve2lkfSdgIC0gU2FtZSBhcyB0aGUgcHJldmlvdXMgZXhhbXBsZSwgYnV0IHVzaW5nIGN1cmx5IGJyYWNlIHN5bnRheC4KICAgKiAqIGAnL3VzZXIve2lkOlteL10qfSdgIC0gU2FtZSBhcyB0aGUgcHJldmlvdXMgZXhhbXBsZS4KICAgKiAqIGAnL3VzZXIve2lkOlswLTlhLWZBLUZdezEsOH19J2AgLSBTaW1pbGFyIHRvIHRoZSBwcmV2aW91cyBleGFtcGxlLCBidXQgb25seSBtYXRjaGVzIGlmIHRoZSBpZAogICAqICAgcGFyYW1ldGVyIGNvbnNpc3RzIG9mIDEgdG8gOCBoZXggZGlnaXRzLgogICAqICogYCcvZmlsZXMve3BhdGg6Lip9J2AgLSBNYXRjaGVzIGFueSBVUkwgc3RhcnRpbmcgd2l0aCAnL2ZpbGVzLycgYW5kIGNhcHR1cmVzIHRoZSByZXN0IG9mIHRoZQogICAqICAgcGF0aCBpbnRvIHRoZSBwYXJhbWV0ZXIgJ3BhdGgnLgogICAqICogYCcvZmlsZXMvKnBhdGgnYCAtIGRpdHRvLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdHRlcm4gIHRoZSBwYXR0ZXJuIHRvIGNvbXBpbGUgaW50byBhIG1hdGNoZXIuCiAgICoKICAgKiBAcHJvcGVydHkge3N0cmluZ30gcHJlZml4ICBBIHN0YXRpYyBwcmVmaXggb2YgdGhpcyBwYXR0ZXJuLiBUaGUgbWF0Y2hlciBndWFyYW50ZWVzIHRoYXQgYW55CiAgICogICBVUkwgbWF0Y2hpbmcgdGhpcyBtYXRjaGVyIChpLmUuIGFueSBzdHJpbmcgZm9yIHdoaWNoIHtAbGluayB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIjbWV0aG9kc19leGVjIGV4ZWMoKX0gcmV0dXJucwogICAqICAgbm9uLW51bGwpIHdpbGwgc3RhcnQgd2l0aCB0aGlzIHByZWZpeC4KICAgKgogICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBzb3VyY2UgIFRoZSBwYXR0ZXJuIHRoYXQgd2FzIHBhc3NlZCBpbnRvIHRoZSBjb250cnVjdG9yCiAgICoKICAgKiBAcHJvcGVydHkge3N0cmluZ30gc291cmNlUGF0aCAgVGhlIHBhdGggcG9ydGlvbiBvZiB0aGUgc291cmNlIHByb3BlcnR5CiAgICoKICAgKiBAcHJvcGVydHkge3N0cmluZ30gc291cmNlU2VhcmNoICBUaGUgc2VhcmNoIHBvcnRpb24gb2YgdGhlIHNvdXJjZSBwcm9wZXJ0eQogICAqCiAgICogQHByb3BlcnR5IHtzdHJpbmd9IHJlZ2V4ICBUaGUgY29uc3RydWN0ZWQgcmVnZXggdGhhdCB3aWxsIGJlIHVzZWQgdG8gbWF0Y2ggYWdhaW5zdCB0aGUgdXJsIHdoZW4KICAgKiAgIGl0IGlzIHRpbWUgdG8gZGV0ZXJtaW5lIHdoaWNoIHVybCB3aWxsIG1hdGNoLgogICAqCiAgICogQHJldHVybnMge09iamVjdH0gIE5ldyBVcmxNYXRjaGVyIG9iamVjdAogICAqLwogIGZ1bmN0aW9uIFVybE1hdGNoZXIocGF0dGVybikgewoKICAgIC8vIEZpbmQgYWxsIHBsYWNlaG9sZGVycyBhbmQgY3JlYXRlIGEgY29tcGlsZWQgcGF0dGVybiwgdXNpbmcgZWl0aGVyIGNsYXNzaWMgb3IgY3VybHkgc3ludGF4OgogICAgLy8gICAnKicgbmFtZQogICAgLy8gICAnOicgbmFtZQogICAgLy8gICAneycgbmFtZSAnfScKICAgIC8vICAgJ3snIG5hbWUgJzonIHJlZ2V4cCAnfScKICAgIC8vIFRoZSByZWd1bGFyIGV4cHJlc3Npb24gaXMgc29tZXdoYXQgY29tcGxpY2F0ZWQgZHVlIHRvIHRoZSBuZWVkIHRvIGFsbG93IGN1cmx5IGJyYWNlcwogICAgLy8gaW5zaWRlIHRoZSByZWd1bGFyIGV4cHJlc3Npb24uIFRoZSBwbGFjZWhvbGRlciByZWdleHAgYnJlYWtzIGRvd24gYXMgZm9sbG93czoKICAgIC8vICAgIChbOipdKShcdyspICAgICAgICAgICAgICAgY2xhc3NpYyBwbGFjZWhvbGRlciAoJDEgLyAkMikKICAgIC8vICAgIFx7KFx3KykoPzpcOiggLi4uICkpP1x9ICAgY3VybHkgYnJhY2UgcGxhY2Vob2xkZXIgKCQzKSB3aXRoIG9wdGlvbmFsIHJlZ2V4cCAuLi4gKCQ0KQogICAgLy8gICAgKD86IC4uLiB8IC4uLiB8IC4uLiApKyAgICB0aGUgcmVnZXhwIGNvbnNpc3RzIG9mIGFueSBudW1iZXIgb2YgYXRvbXMsIGFuIGF0b20gYmVpbmcgZWl0aGVyCiAgICAvLyAgICBbXnt9XFxdKyAgICAgICAgICAgICAgICAgIC0gYW55dGhpbmcgb3RoZXIgdGhhbiBjdXJseSBicmFjZXMgb3IgYmFja3NsYXNoCiAgICAvLyAgICBcXC4gICAgICAgICAgICAgICAgICAgICAgIC0gYSBiYWNrc2xhc2ggZXNjYXBlCiAgICAvLyAgICBceyg/Oltee31cXF0rfFxcLikqXH0gICAgIC0gYSBtYXRjaGVkIHNldCBvZiBjdXJseSBicmFjZXMgY29udGFpbmluZyBvdGhlciBhdG9tcwogICAgdmFyIHBsYWNlaG9sZGVyID0gLyhbOipdKShcdyspfFx7KFx3KykoPzpcOigoPzpbXnt9XFxdK3xcXC58XHsoPzpbXnt9XFxdK3xcXC4pKlx9KSspKT9cfS9nLAogICAgICBuYW1lcyA9IHt9LCBjb21waWxlZCA9ICdeJywgbGFzdCA9IDAsIG0sCiAgICAgIHNlZ21lbnRzID0gdGhpcy5zZWdtZW50cyA9IFtdLAogICAgICBwYXJhbXMgPSB0aGlzLnBhcmFtcyA9IFtdOwoKICAgIGZ1bmN0aW9uIGFkZFBhcmFtZXRlcihpZCkgewogICAgICBpZiAoIS9eXHcrKC0rXHcrKSokLy50ZXN0KGlkKSkgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHBhcmFtZXRlciBuYW1lICciICsgaWQgKyAiJyBpbiBwYXR0ZXJuICciICsgcGF0dGVybiArICInIik7CiAgICAgIGlmIChuYW1lc1tpZF0pIHRocm93IG5ldyBFcnJvcigiRHVwbGljYXRlIHBhcmFtZXRlciBuYW1lICciICsgaWQgKyAiJyBpbiBwYXR0ZXJuICciICsgcGF0dGVybiArICInIik7CiAgICAgIG5hbWVzW2lkXSA9IHRydWU7CiAgICAgIHBhcmFtcy5wdXNoKGlkKTsKICAgIH0KCiAgICBmdW5jdGlvbiBxdW90ZVJlZ0V4cChzdHJpbmcpIHsKICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bXFxcW1xdXF4kKis/LigpfHt9XS9nLCAiXFwkJiIpOwogICAgfQoKICAgIHRoaXMuc291cmNlID0gcGF0dGVybjsKCiAgICAvLyBTcGxpdCBpbnRvIHN0YXRpYyBzZWdtZW50cyBzZXBhcmF0ZWQgYnkgcGF0aCBwYXJhbWV0ZXIgcGxhY2Vob2xkZXJzLgogICAgLy8gVGhlIG51bWJlciBvZiBzZWdtZW50cyBpcyBhbHdheXMgMSBtb3JlIHRoYW4gdGhlIG51bWJlciBvZiBwYXJhbWV0ZXJzLgogICAgdmFyIGlkLCByZWdleHAsIHNlZ21lbnQ7CiAgICB3aGlsZSAoKG0gPSBwbGFjZWhvbGRlci5leGVjKHBhdHRlcm4pKSkgewogICAgICBpZCA9IG1bMl0gfHwgbVszXTsgLy8gSUVbNzhdIHJldHVybnMgJycgZm9yIHVubWF0Y2hlZCBncm91cHMgaW5zdGVhZCBvZiBudWxsCiAgICAgIHJlZ2V4cCA9IG1bNF0gfHwgKG1bMV0gPT0gJyonID8gJy4qJyA6ICdbXi9dKicpOwogICAgICBzZWdtZW50ID0gcGF0dGVybi5zdWJzdHJpbmcobGFzdCwgbS5pbmRleCk7CiAgICAgIGlmIChzZWdtZW50LmluZGV4T2YoJz8nKSA+PSAwKSBicmVhazsgLy8gd2UncmUgaW50byB0aGUgc2VhcmNoIHBhcnQKICAgICAgY29tcGlsZWQgKz0gcXVvdGVSZWdFeHAoc2VnbWVudCkgKyAnKCcgKyByZWdleHAgKyAnKSc7CiAgICAgIGFkZFBhcmFtZXRlcihpZCk7CiAgICAgIHNlZ21lbnRzLnB1c2goc2VnbWVudCk7CiAgICAgIGxhc3QgPSBwbGFjZWhvbGRlci5sYXN0SW5kZXg7CiAgICB9CiAgICBzZWdtZW50ID0gcGF0dGVybi5zdWJzdHJpbmcobGFzdCk7CgogICAgLy8gRmluZCBhbnkgc2VhcmNoIHBhcmFtZXRlciBuYW1lcyBhbmQgcmVtb3ZlIHRoZW0gZnJvbSB0aGUgbGFzdCBzZWdtZW50CiAgICB2YXIgaSA9IHNlZ21lbnQuaW5kZXhPZignPycpOwogICAgaWYgKGkgPj0gMCkgewogICAgICB2YXIgc2VhcmNoID0gdGhpcy5zb3VyY2VTZWFyY2ggPSBzZWdtZW50LnN1YnN0cmluZyhpKTsKICAgICAgc2VnbWVudCA9IHNlZ21lbnQuc3Vic3RyaW5nKDAsIGkpOwogICAgICB0aGlzLnNvdXJjZVBhdGggPSBwYXR0ZXJuLnN1YnN0cmluZygwLCBsYXN0K2kpOwoKICAgICAgLy8gQWxsb3cgcGFyYW1ldGVycyB0byBiZSBzZXBhcmF0ZWQgYnkgJz8nIGFzIHdlbGwgYXMgJyYnIHRvIG1ha2UgY29uY2F0KCkgZWFzaWVyCiAgICAgIGZvckVhY2goc2VhcmNoLnN1YnN0cmluZygxKS5zcGxpdCgvWyY/XS8pLCBhZGRQYXJhbWV0ZXIpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5zb3VyY2VQYXRoID0gcGF0dGVybjsKICAgICAgdGhpcy5zb3VyY2VTZWFyY2ggPSAnJzsKICAgIH0KCiAgICBjb21waWxlZCArPSBxdW90ZVJlZ0V4cChzZWdtZW50KSArICckJzsKICAgIHNlZ21lbnRzLnB1c2goc2VnbWVudCk7CiAgICB0aGlzLnJlZ2V4cCA9IG5ldyBSZWdFeHAoY29tcGlsZWQpOwogICAgdGhpcy5wcmVmaXggPSBzZWdtZW50c1swXTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlciNjb25jYXQKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXR1cm5zIGEgbmV3IG1hdGNoZXIgZm9yIGEgcGF0dGVybiBjb25zdHJ1Y3RlZCBieSBhcHBlbmRpbmcgdGhlIHBhdGggcGFydCBhbmQgYWRkaW5nIHRoZQogICAqIHNlYXJjaCBwYXJhbWV0ZXJzIG9mIHRoZSBzcGVjaWZpZWQgcGF0dGVybiB0byB0aGlzIHBhdHRlcm4uIFRoZSBjdXJyZW50IHBhdHRlcm4gaXMgbm90CiAgICogbW9kaWZpZWQuIFRoaXMgY2FuIGJlIHVuZGVyc3Rvb2QgYXMgY3JlYXRpbmcgYSBwYXR0ZXJuIGZvciBVUkxzIHRoYXQgYXJlIHJlbGF0aXZlIHRvIChvcgogICAqIHN1ZmZpeGVzIG9mKSB0aGUgY3VycmVudCBwYXR0ZXJuLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBUaGUgZm9sbG93aW5nIHR3byBtYXRjaGVycyBhcmUgZXF1aXZhbGVudDoKICAgKiBgYGAKICAgKiBuZXcgVXJsTWF0Y2hlcignL3VzZXIve2lkfT9xJykuY29uY2F0KCcvZGV0YWlscz9kYXRlJyk7CiAgICogbmV3IFVybE1hdGNoZXIoJy91c2VyL3tpZH0vZGV0YWlscz9xJmRhdGUnKTsKICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBwYXR0ZXJuICBUaGUgcGF0dGVybiB0byBhcHBlbmQuCiAgICogQHJldHVybnMge3VpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcn0gIEEgbWF0Y2hlciBmb3IgdGhlIGNvbmNhdGVuYXRlZCBwYXR0ZXJuLgogICAqLwogIFVybE1hdGNoZXIucHJvdG90eXBlLmNvbmNhdCA9IGZ1bmN0aW9uIChwYXR0ZXJuKSB7CiAgICAvLyBCZWNhdXNlIG9yZGVyIG9mIHNlYXJjaCBwYXJhbWV0ZXJzIGlzIGlycmVsZXZhbnQsIHdlIGNhbiBhZGQgb3VyIG93biBzZWFyY2gKICAgIC8vIHBhcmFtZXRlcnMgdG8gdGhlIGVuZCBvZiB0aGUgbmV3IHBhdHRlcm4uIFBhcnNlIHRoZSBuZXcgcGF0dGVybiBieSBpdHNlbGYKICAgIC8vIGFuZCB0aGVuIGpvaW4gdGhlIGJpdHMgdG9nZXRoZXIsIGJ1dCBpdCdzIG11Y2ggZWFzaWVyIHRvIGRvIHRoaXMgb24gYSBzdHJpbmcgbGV2ZWwuCiAgICByZXR1cm4gbmV3IFVybE1hdGNoZXIodGhpcy5zb3VyY2VQYXRoICsgcGF0dGVybiArIHRoaXMuc291cmNlU2VhcmNoKTsKICB9OwoKICBVcmxNYXRjaGVyLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLnNvdXJjZTsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIjZXhlYwogICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRlc3RzIHRoZSBzcGVjaWZpZWQgcGF0aCBhZ2FpbnN0IHRoaXMgbWF0Y2hlciwgYW5kIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGNhcHR1cmVkCiAgICogcGFyYW1ldGVyIHZhbHVlcywgb3IgbnVsbCBpZiB0aGUgcGF0aCBkb2VzIG5vdCBtYXRjaC4gVGhlIHJldHVybmVkIG9iamVjdCBjb250YWlucyB0aGUgdmFsdWVzCiAgICogb2YgYW55IHNlYXJjaCBwYXJhbWV0ZXJzIHRoYXQgYXJlIG1lbnRpb25lZCBpbiB0aGUgcGF0dGVybiwgYnV0IHRoZWlyIHZhbHVlIG1heSBiZSBudWxsIGlmCiAgICogdGhleSBhcmUgbm90IHByZXNlbnQgaW4gYHNlYXJjaFBhcmFtc2AuIFRoaXMgbWVhbnMgdGhhdCBzZWFyY2ggcGFyYW1ldGVycyBhcmUgYWx3YXlzIHRyZWF0ZWQKICAgKiBhcyBvcHRpb25hbC4KICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgCiAgICogbmV3IFVybE1hdGNoZXIoJy91c2VyL3tpZH0/cSZyJykuZXhlYygnL3VzZXIvYm9iJywgeyB4OicxJywgcTonaGVsbG8nIH0pOwogICAqIC8vIHJldHVybnMgeyBpZDonYm9iJywgcTonaGVsbG8nLCByOm51bGwgfQogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggIFRoZSBVUkwgcGF0aCB0byBtYXRjaCwgZS5nLiBgJGxvY2F0aW9uLnBhdGgoKWAuCiAgICogQHBhcmFtIHtPYmplY3R9IHNlYXJjaFBhcmFtcyAgVVJMIHNlYXJjaCBwYXJhbWV0ZXJzLCBlLmcuIGAkbG9jYXRpb24uc2VhcmNoKClgLgogICAqIEByZXR1cm5zIHtPYmplY3R9ICBUaGUgY2FwdHVyZWQgcGFyYW1ldGVyIHZhbHVlcy4KICAgKi8KICBVcmxNYXRjaGVyLnByb3RvdHlwZS5leGVjID0gZnVuY3Rpb24gKHBhdGgsIHNlYXJjaFBhcmFtcykgewogICAgdmFyIG0gPSB0aGlzLnJlZ2V4cC5leGVjKHBhdGgpOwogICAgaWYgKCFtKSByZXR1cm4gbnVsbDsKCiAgICB2YXIgcGFyYW1zID0gdGhpcy5wYXJhbXMsIG5Ub3RhbCA9IHBhcmFtcy5sZW5ndGgsCiAgICAgIG5QYXRoID0gdGhpcy5zZWdtZW50cy5sZW5ndGgtMSwKICAgICAgdmFsdWVzID0ge30sIGk7CgogICAgaWYgKG5QYXRoICE9PSBtLmxlbmd0aCAtIDEpIHRocm93IG5ldyBFcnJvcigiVW5iYWxhbmNlZCBjYXB0dXJlIGdyb3VwIGluIHJvdXRlICciICsgdGhpcy5zb3VyY2UgKyAiJyIpOwoKICAgIGZvciAoaT0wOyBpPG5QYXRoOyBpKyspIHZhbHVlc1twYXJhbXNbaV1dID0gbVtpKzFdOwogICAgZm9yICgvKiovOyBpPG5Ub3RhbDsgaSsrKSB2YWx1ZXNbcGFyYW1zW2ldXSA9IHNlYXJjaFBhcmFtc1twYXJhbXNbaV1dOwoKICAgIHJldHVybiB2YWx1ZXM7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyI3BhcmFtZXRlcnMKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXR1cm5zIHRoZSBuYW1lcyBvZiBhbGwgcGF0aCBhbmQgc2VhcmNoIHBhcmFtZXRlcnMgb2YgdGhpcyBwYXR0ZXJuIGluIGFuIHVuc3BlY2lmaWVkIG9yZGVyLgogICAqCiAgICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fSAgQW4gYXJyYXkgb2YgcGFyYW1ldGVyIG5hbWVzLiBNdXN0IGJlIHRyZWF0ZWQgYXMgcmVhZC1vbmx5LiBJZiB0aGUKICAgKiAgICBwYXR0ZXJuIGhhcyBubyBwYXJhbWV0ZXJzLCBhbiBlbXB0eSBhcnJheSBpcyByZXR1cm5lZC4KICAgKi8KICBVcmxNYXRjaGVyLnByb3RvdHlwZS5wYXJhbWV0ZXJzID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMucGFyYW1zOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlciNmb3JtYXQKICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDcmVhdGVzIGEgVVJMIHRoYXQgbWF0Y2hlcyB0aGlzIHBhdHRlcm4gYnkgc3Vic3RpdHV0aW5nIHRoZSBzcGVjaWZpZWQgdmFsdWVzCiAgICogZm9yIHRoZSBwYXRoIGFuZCBzZWFyY2ggcGFyYW1ldGVycy4gTnVsbCB2YWx1ZXMgZm9yIHBhdGggcGFyYW1ldGVycyBhcmUKICAgKiB0cmVhdGVkIGFzIGVtcHR5IHN0cmluZ3MuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYAogICAqIG5ldyBVcmxNYXRjaGVyKCcvdXNlci97aWR9P3EnKS5mb3JtYXQoeyBpZDonYm9iJywgcToneWVzJyB9KTsKICAgKiAvLyByZXR1cm5zICcvdXNlci9ib2I/cT15ZXMnCiAgICogYGBgCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gdmFsdWVzICB0aGUgdmFsdWVzIHRvIHN1YnN0aXR1dGUgZm9yIHRoZSBwYXJhbWV0ZXJzIGluIHRoaXMgcGF0dGVybi4KICAgKiBAcmV0dXJucyB7c3RyaW5nfSAgdGhlIGZvcm1hdHRlZCBVUkwgKHBhdGggYW5kIG9wdGlvbmFsbHkgc2VhcmNoIHBhcnQpLgogICAqLwogIFVybE1hdGNoZXIucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uICh2YWx1ZXMpIHsKICAgIHZhciBzZWdtZW50cyA9IHRoaXMuc2VnbWVudHMsIHBhcmFtcyA9IHRoaXMucGFyYW1zOwogICAgaWYgKCF2YWx1ZXMpIHJldHVybiBzZWdtZW50cy5qb2luKCcnKTsKCiAgICB2YXIgblBhdGggPSBzZWdtZW50cy5sZW5ndGgtMSwgblRvdGFsID0gcGFyYW1zLmxlbmd0aCwKICAgICAgcmVzdWx0ID0gc2VnbWVudHNbMF0sIGksIHNlYXJjaCwgdmFsdWU7CgogICAgZm9yIChpPTA7IGk8blBhdGg7IGkrKykgewogICAgICB2YWx1ZSA9IHZhbHVlc1twYXJhbXNbaV1dOwogICAgICAvLyBUT0RPOiBNYXliZSB3ZSBzaG91bGQgdGhyb3cgb24gbnVsbCBoZXJlPyBJdCdzIG5vdCByZWFsbHkgZ29vZCBzdHlsZSB0byB1c2UgJycgYW5kIG51bGwgaW50ZXJjaGFuZ2VhYmxleQogICAgICBpZiAodmFsdWUgIT0gbnVsbCkgcmVzdWx0ICs9IGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CiAgICAgIHJlc3VsdCArPSBzZWdtZW50c1tpKzFdOwogICAgfQogICAgZm9yICgvKiovOyBpPG5Ub3RhbDsgaSsrKSB7CiAgICAgIHZhbHVlID0gdmFsdWVzW3BhcmFtc1tpXV07CiAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgcmVzdWx0ICs9IChzZWFyY2ggPyAnJicgOiAnPycpICsgcGFyYW1zW2ldICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgICBzZWFyY2ggPSB0cnVlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKCgogIC8qKgogICAqIEBuZ2RvYyBvYmplY3QKICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdXJsTWF0Y2hlckZhY3RvcnkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEZhY3RvcnkgZm9yIHtAbGluayB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXJ9IGluc3RhbmNlcy4gVGhlIGZhY3RvcnkgaXMgYWxzbyBhdmFpbGFibGUgdG8gcHJvdmlkZXJzCiAgICogdW5kZXIgdGhlIG5hbWUgYCR1cmxNYXRjaGVyRmFjdG9yeVByb3ZpZGVyYC4KICAgKi8KICBmdW5jdGlvbiAkVXJsTWF0Y2hlckZhY3RvcnkoKSB7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLiR1cmxNYXRjaGVyRmFjdG9yeSNjb21waWxlCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHVybE1hdGNoZXJGYWN0b3J5CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEge0BsaW5rIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcn0gZm9yIHRoZSBzcGVjaWZpZWQgcGF0dGVybi4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0dGVybiAgVGhlIFVSTCBwYXR0ZXJuLgogICAgICogQHJldHVybnMge3VpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcn0gIFRoZSBVcmxNYXRjaGVyLgogICAgICovCiAgICB0aGlzLmNvbXBpbGUgPSBmdW5jdGlvbiAocGF0dGVybikgewogICAgICByZXR1cm4gbmV3IFVybE1hdGNoZXIocGF0dGVybik7CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdXJsTWF0Y2hlckZhY3RvcnkjaXNNYXRjaGVyCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHVybE1hdGNoZXJGYWN0b3J5CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIHNwZWNpZmllZCBvYmplY3QgaXMgYSBVcmxNYXRjaGVyLCBvciBmYWxzZSBvdGhlcndpc2UuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCAgVGhlIG9iamVjdCB0byBwZXJmb3JtIHRoZSB0eXBlIGNoZWNrIGFnYWluc3QuCiAgICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gIFJldHVybnMgYHRydWVgIGlmIHRoZSBvYmplY3QgaGFzIHRoZSBmb2xsb3dpbmcgZnVuY3Rpb25zOiBgZXhlY2AsIGBmb3JtYXRgLCBhbmQgYGNvbmNhdGAuCiAgICAgKi8KICAgIHRoaXMuaXNNYXRjaGVyID0gZnVuY3Rpb24gKG8pIHsKICAgICAgcmV0dXJuIGlzT2JqZWN0KG8pICYmIGlzRnVuY3Rpb24oby5leGVjKSAmJiBpc0Z1bmN0aW9uKG8uZm9ybWF0KSAmJiBpc0Z1bmN0aW9uKG8uY29uY2F0KTsKICAgIH07CgogICAgLyogTm8gbmVlZCB0byBkb2N1bWVudCAkZ2V0LCBzaW5jZSBpdCByZXR1cm5zIHRoaXMgKi8KICAgIHRoaXMuJGdldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogIH0KCi8vIFJlZ2lzdGVyIGFzIGEgcHJvdmlkZXIgc28gaXQncyBhdmFpbGFibGUgdG8gb3RoZXIgcHJvdmlkZXJzCiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci51dGlsJykucHJvdmlkZXIoJyR1cmxNYXRjaGVyRmFjdG9yeScsICRVcmxNYXRjaGVyRmFjdG9yeSk7CgogIC8qKgogICAqIEBuZ2RvYyBvYmplY3QKICAgKiBAbmFtZSB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlcgogICAqCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci51dGlsLiR1cmxNYXRjaGVyRmFjdG9yeVByb3ZpZGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBgJHVybFJvdXRlclByb3ZpZGVyYCBoYXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHdhdGNoaW5nIGAkbG9jYXRpb25gLgogICAqIFdoZW4gYCRsb2NhdGlvbmAgY2hhbmdlcyBpdCBydW5zIHRocm91Z2ggYSBsaXN0IG9mIHJ1bGVzIG9uZSBieSBvbmUgdW50aWwgYQogICAqIG1hdGNoIGlzIGZvdW5kLiBgJHVybFJvdXRlclByb3ZpZGVyYCBpcyB1c2VkIGJlaGluZCB0aGUgc2NlbmVzIGFueXRpbWUgeW91IHNwZWNpZnkKICAgKiBhIHVybCBpbiBhIHN0YXRlIGNvbmZpZ3VyYXRpb24uIEFsbCB1cmxzIGFyZSBjb21waWxlZCBpbnRvIGEgVXJsTWF0Y2hlciBvYmplY3QuCiAgICoKICAgKiBUaGVyZSBhcmUgc2V2ZXJhbCBtZXRob2RzIG9uIGAkdXJsUm91dGVyUHJvdmlkZXJgIHRoYXQgbWFrZSBpdCB1c2VmdWwgdG8gdXNlIGRpcmVjdGx5CiAgICogaW4geW91ciBtb2R1bGUgY29uZmlnLgogICAqLwogICRVcmxSb3V0ZXJQcm92aWRlci4kaW5qZWN0ID0gWyckdXJsTWF0Y2hlckZhY3RvcnlQcm92aWRlciddOwogIGZ1bmN0aW9uICRVcmxSb3V0ZXJQcm92aWRlciggICR1cmxNYXRjaGVyRmFjdG9yeSkgewogICAgdmFyIHJ1bGVzID0gW10sCiAgICAgIG90aGVyd2lzZSA9IG51bGw7CgogICAgLy8gUmV0dXJucyBhIHN0cmluZyB0aGF0IGlzIGEgcHJlZml4IG9mIGFsbCBzdHJpbmdzIG1hdGNoaW5nIHRoZSBSZWdFeHAKICAgIGZ1bmN0aW9uIHJlZ0V4cFByZWZpeChyZSkgewogICAgICB2YXIgcHJlZml4ID0gL15cXigoPzpcXFteYS16QS1aMC05XXxbXlxcXFtcXVxeJCorPy4oKXx7fV0rKSopLy5leGVjKHJlLnNvdXJjZSk7CiAgICAgIHJldHVybiAocHJlZml4ICE9IG51bGwpID8gcHJlZml4WzFdLnJlcGxhY2UoL1xcKC4pL2csICIkMSIpIDogJyc7CiAgICB9CgogICAgLy8gSW50ZXJwb2xhdGVzIG1hdGNoZWQgdmFsdWVzIGludG8gYSBTdHJpbmcucmVwbGFjZSgpLXN0eWxlIHBhdHRlcm4KICAgIGZ1bmN0aW9uIGludGVycG9sYXRlKHBhdHRlcm4sIG1hdGNoKSB7CiAgICAgIHJldHVybiBwYXR0ZXJuLnJlcGxhY2UoL1wkKFwkfFxkezEsMn0pLywgZnVuY3Rpb24gKG0sIHdoYXQpIHsKICAgICAgICByZXR1cm4gbWF0Y2hbd2hhdCA9PT0gJyQnID8gMCA6IE51bWJlcih3aGF0KV07CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlciNydWxlCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyUHJvdmlkZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERlZmluZXMgcnVsZXMgdGhhdCBhcmUgdXNlZCBieSBgJHVybFJvdXRlclByb3ZpZGVyIHRvIGZpbmQgbWF0Y2hlcyBmb3IKICAgICAqIHNwZWNpZmljIFVSTHMuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsndWkucm91dGVyLnJvdXRlciddKTsKICAgICAqCiAgICAgKiBhcHAuY29uZmlnKGZ1bmN0aW9uICgkdXJsUm91dGVyUHJvdmlkZXIpIHsKICAgKiAgIC8vIEhlcmUncyBhbiBleGFtcGxlIG9mIGhvdyB5b3UgbWlnaHQgYWxsb3cgY2FzZSBpbnNlbnNpdGl2ZSB1cmxzCiAgICogICAkdXJsUm91dGVyUHJvdmlkZXIucnVsZShmdW5jdGlvbiAoJGluamVjdG9yLCAkbG9jYXRpb24pIHsKICAgKiAgICAgdmFyIHBhdGggPSAkbG9jYXRpb24ucGF0aCgpLAogICAqICAgICAgICAgbm9ybWFsaXplZCA9IHBhdGgudG9Mb3dlckNhc2UoKTsKICAgKgogICAqICAgICBpZiAocGF0aCAhPT0gbm9ybWFsaXplZCkgewogICAqICAgICAgIHJldHVybiBub3JtYWxpemVkOwogICAqICAgICB9CiAgICogICB9KTsKICAgKiB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7b2JqZWN0fSBydWxlIEhhbmRsZXIgZnVuY3Rpb24gdGhhdCB0YWtlcyBgJGluamVjdG9yYCBhbmQgYCRsb2NhdGlvbmAKICAgICAqIHNlcnZpY2VzIGFzIGFyZ3VtZW50cy4gWW91IGNhbiB1c2UgdGhlbSB0byByZXR1cm4gYSB2YWxpZCBwYXRoIGFzIGEgc3RyaW5nLgogICAgICoKICAgICAqIEByZXR1cm4ge29iamVjdH0gJHVybFJvdXRlclByb3ZpZGVyIC0gJHVybFJvdXRlclByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KICAgIHRoaXMucnVsZSA9CiAgICAgIGZ1bmN0aW9uIChydWxlKSB7CiAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKHJ1bGUpKSB0aHJvdyBuZXcgRXJyb3IoIidydWxlJyBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICBydWxlcy5wdXNoKHJ1bGUpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyUHJvdmlkZXIjb3RoZXJ3aXNlCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyUHJvdmlkZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIERlZmluZXMgYSBwYXRoIHRoYXQgaXMgdXNlZCB3aGVuIGFuIGludmFsaWVkIHJvdXRlIGlzIHJlcXVlc3RlZC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogPHByZT4KICAgICAqIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnYXBwJywgWyd1aS5yb3V0ZXIucm91dGVyJ10pOwogICAgICoKICAgICAqIGFwcC5jb25maWcoZnVuY3Rpb24gKCR1cmxSb3V0ZXJQcm92aWRlcikgewogICAqICAgLy8gaWYgdGhlIHBhdGggZG9lc24ndCBtYXRjaCBhbnkgb2YgdGhlIHVybHMgeW91IGNvbmZpZ3VyZWQKICAgKiAgIC8vIG90aGVyd2lzZSB3aWxsIHRha2UgY2FyZSBvZiByb3V0aW5nIHRoZSB1c2VyIHRvIHRoZQogICAqICAgLy8gc3BlY2lmaWVkIHVybAogICAqICAgJHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZSgnL2luZGV4Jyk7CiAgICoKICAgKiAgIC8vIEV4YW1wbGUgb2YgdXNpbmcgZnVuY3Rpb24gcnVsZSBhcyBwYXJhbQogICAqICAgJHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZShmdW5jdGlvbiAoJGluamVjdG9yLCAkbG9jYXRpb24pIHsKICAgKiAgICAgLi4uCiAgICogICB9KTsKICAgKiB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gcnVsZSBUaGUgdXJsIHBhdGggeW91IHdhbnQgdG8gcmVkaXJlY3QgdG8gb3IgYSBmdW5jdGlvbgogICAgICogcnVsZSB0aGF0IHJldHVybnMgdGhlIHVybCBwYXRoLiBUaGUgZnVuY3Rpb24gdmVyc2lvbiBpcyBwYXNzZWQgdHdvIHBhcmFtczoKICAgICAqIGAkaW5qZWN0b3JgIGFuZCBgJGxvY2F0aW9uYCBzZXJ2aWNlcy4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtvYmplY3R9ICR1cmxSb3V0ZXJQcm92aWRlciAtICR1cmxSb3V0ZXJQcm92aWRlciBpbnN0YW5jZQogICAgICovCiAgICB0aGlzLm90aGVyd2lzZSA9CiAgICAgIGZ1bmN0aW9uIChydWxlKSB7CiAgICAgICAgaWYgKGlzU3RyaW5nKHJ1bGUpKSB7CiAgICAgICAgICB2YXIgcmVkaXJlY3QgPSBydWxlOwogICAgICAgICAgcnVsZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHJlZGlyZWN0OyB9OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICghaXNGdW5jdGlvbihydWxlKSkgdGhyb3cgbmV3IEVycm9yKCIncnVsZScgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgICAgb3RoZXJ3aXNlID0gcnVsZTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfTsKCgogICAgZnVuY3Rpb24gaGFuZGxlSWZNYXRjaCgkaW5qZWN0b3IsIGhhbmRsZXIsIG1hdGNoKSB7CiAgICAgIGlmICghbWF0Y2gpIHJldHVybiBmYWxzZTsKICAgICAgdmFyIHJlc3VsdCA9ICRpbmplY3Rvci5pbnZva2UoaGFuZGxlciwgaGFuZGxlciwgeyAkbWF0Y2g6IG1hdGNoIH0pOwogICAgICByZXR1cm4gaXNEZWZpbmVkKHJlc3VsdCkgPyByZXN1bHQgOiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlciN3aGVuCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyUHJvdmlkZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJlZ2lzdGVycyBhIGhhbmRsZXIgZm9yIGEgZ2l2ZW4gdXJsIG1hdGNoaW5nLiBpZiBoYW5kbGUgaXMgYSBzdHJpbmcsIGl0IGlzCiAgICAgKiB0cmVhdGVkIGFzIGEgcmVkaXJlY3QsIGFuZCBpcyBpbnRlcnBvbGF0ZWQgYWNjb3JkaW5nIHRvIHRoZSBzeXludGF4IG9mIG1hdGNoCiAgICAgKiAoaS5lLiBsaWtlIFN0cmluZy5yZXBsYWNlKCkgZm9yIFJlZ0V4cCwgb3IgbGlrZSBhIFVybE1hdGNoZXIgcGF0dGVybiBvdGhlcndpc2UpLgogICAgICoKICAgICAqIElmIHRoZSBoYW5kbGVyIGlzIGEgZnVuY3Rpb24sIGl0IGlzIGluamVjdGFibGUuIEl0IGdldHMgaW52b2tlZCBpZiBgJGxvY2F0aW9uYAogICAgICogbWF0Y2hlcy4gWW91IGhhdmUgdGhlIG9wdGlvbiBvZiBpbmplY3QgdGhlIG1hdGNoIG9iamVjdCBhcyBgJG1hdGNoYC4KICAgICAqCiAgICAgKiBUaGUgaGFuZGxlciBjYW4gcmV0dXJuCiAgICAgKgogICAgICogLSAqKmZhbHN5KiogdG8gaW5kaWNhdGUgdGhhdCB0aGUgcnVsZSBkaWRuJ3QgbWF0Y2ggYWZ0ZXIgYWxsLCB0aGVuIGAkdXJsUm91dGVyYAogICAgICogICB3aWxsIGNvbnRpbnVlIHRyeWluZyB0byBmaW5kIGFub3RoZXIgb25lIHRoYXQgbWF0Y2hlcy4KICAgICAqIC0gKipzdHJpbmcqKiB3aGljaCBpcyB0cmVhdGVkIGFzIGEgcmVkaXJlY3QgYW5kIHBhc3NlZCB0byBgJGxvY2F0aW9uLnVybCgpYAogICAgICogLSAqKnZvaWQqKiBvciBhbnkgKip0cnV0aHkqKiB2YWx1ZSB0ZWxscyBgJHVybFJvdXRlcmAgdGhhdCB0aGUgdXJsIHdhcyBoYW5kbGVkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiA8cHJlPgogICAgICogdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdhcHAnLCBbJ3VpLnJvdXRlci5yb3V0ZXInXSk7CiAgICAgKgogICAgICogYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHVybFJvdXRlclByb3ZpZGVyKSB7CiAgICogICAkdXJsUm91dGVyUHJvdmlkZXIud2hlbigkc3RhdGUudXJsLCBmdW5jdGlvbiAoJG1hdGNoLCAkc3RhdGVQYXJhbXMpIHsKICAgKiAgICAgaWYgKCRzdGF0ZS4kY3VycmVudC5uYXZpZ2FibGUgIT09IHN0YXRlIHx8CiAgICogICAgICAgICAhZXF1YWxGb3JLZXlzKCRtYXRjaCwgJHN0YXRlUGFyYW1zKSB7CiAgICogICAgICAkc3RhdGUudHJhbnNpdGlvblRvKHN0YXRlLCAkbWF0Y2gsIGZhbHNlKTsKICAgKiAgICAgfQogICAqICAgfSk7CiAgICogfSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3R9IHdoYXQgVGhlIGluY29taW5nIHBhdGggdGhhdCB5b3Ugd2FudCB0byByZWRpcmVjdC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gaGFuZGxlciBUaGUgcGF0aCB5b3Ugd2FudCB0byByZWRpcmVjdCB5b3VyIHVzZXIgdG8uCiAgICAgKi8KICAgIHRoaXMud2hlbiA9CiAgICAgIGZ1bmN0aW9uICh3aGF0LCBoYW5kbGVyKSB7CiAgICAgICAgdmFyIHJlZGlyZWN0LCBoYW5kbGVySXNTdHJpbmcgPSBpc1N0cmluZyhoYW5kbGVyKTsKICAgICAgICBpZiAoaXNTdHJpbmcod2hhdCkpIHdoYXQgPSAkdXJsTWF0Y2hlckZhY3RvcnkuY29tcGlsZSh3aGF0KTsKCiAgICAgICAgaWYgKCFoYW5kbGVySXNTdHJpbmcgJiYgIWlzRnVuY3Rpb24oaGFuZGxlcikgJiYgIWlzQXJyYXkoaGFuZGxlcikpCiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgJ2hhbmRsZXInIGluIHdoZW4oKSIpOwoKICAgICAgICB2YXIgc3RyYXRlZ2llcyA9IHsKICAgICAgICAgIG1hdGNoZXI6IGZ1bmN0aW9uICh3aGF0LCBoYW5kbGVyKSB7CiAgICAgICAgICAgIGlmIChoYW5kbGVySXNTdHJpbmcpIHsKICAgICAgICAgICAgICByZWRpcmVjdCA9ICR1cmxNYXRjaGVyRmFjdG9yeS5jb21waWxlKGhhbmRsZXIpOwogICAgICAgICAgICAgIGhhbmRsZXIgPSBbJyRtYXRjaCcsIGZ1bmN0aW9uICgkbWF0Y2gpIHsgcmV0dXJuIHJlZGlyZWN0LmZvcm1hdCgkbWF0Y2gpOyB9XTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uICgkaW5qZWN0b3IsICRsb2NhdGlvbikgewogICAgICAgICAgICAgIHJldHVybiBoYW5kbGVJZk1hdGNoKCRpbmplY3RvciwgaGFuZGxlciwgd2hhdC5leGVjKCRsb2NhdGlvbi5wYXRoKCksICRsb2NhdGlvbi5zZWFyY2goKSkpOwogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgcHJlZml4OiBpc1N0cmluZyh3aGF0LnByZWZpeCkgPyB3aGF0LnByZWZpeCA6ICcnCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIHJlZ2V4OiBmdW5jdGlvbiAod2hhdCwgaGFuZGxlcikgewogICAgICAgICAgICBpZiAod2hhdC5nbG9iYWwgfHwgd2hhdC5zdGlja3kpIHRocm93IG5ldyBFcnJvcigid2hlbigpIFJlZ0V4cCBtdXN0IG5vdCBiZSBnbG9iYWwgb3Igc3RpY2t5Iik7CgogICAgICAgICAgICBpZiAoaGFuZGxlcklzU3RyaW5nKSB7CiAgICAgICAgICAgICAgcmVkaXJlY3QgPSBoYW5kbGVyOwogICAgICAgICAgICAgIGhhbmRsZXIgPSBbJyRtYXRjaCcsIGZ1bmN0aW9uICgkbWF0Y2gpIHsgcmV0dXJuIGludGVycG9sYXRlKHJlZGlyZWN0LCAkbWF0Y2gpOyB9XTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uICgkaW5qZWN0b3IsICRsb2NhdGlvbikgewogICAgICAgICAgICAgIHJldHVybiBoYW5kbGVJZk1hdGNoKCRpbmplY3RvciwgaGFuZGxlciwgd2hhdC5leGVjKCRsb2NhdGlvbi5wYXRoKCkpKTsKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIHByZWZpeDogcmVnRXhwUHJlZml4KHdoYXQpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBjaGVjayA9IHsgbWF0Y2hlcjogJHVybE1hdGNoZXJGYWN0b3J5LmlzTWF0Y2hlcih3aGF0KSwgcmVnZXg6IHdoYXQgaW5zdGFuY2VvZiBSZWdFeHAgfTsKCiAgICAgICAgZm9yICh2YXIgbiBpbiBjaGVjaykgewogICAgICAgICAgaWYgKGNoZWNrW25dKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnJ1bGUoc3RyYXRlZ2llc1tuXSh3aGF0LCBoYW5kbGVyKSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgJ3doYXQnIGluIHdoZW4oKSIpOwogICAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyCiAgICAgKgogICAgICogQHJlcXVpcmVzICRsb2NhdGlvbgogICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKi8KICAgIHRoaXMuJGdldCA9CiAgICAgIFsgICAgICAgICckbG9jYXRpb24nLCAnJHJvb3RTY29wZScsICckaW5qZWN0b3InLAogICAgICAgIGZ1bmN0aW9uICgkbG9jYXRpb24sICAgJHJvb3RTY29wZSwgICAkaW5qZWN0b3IpIHsKICAgICAgICAgIC8vIFRPRE86IE9wdGltaXplIGdyb3VwcyBvZiBydWxlcyB3aXRoIG5vbi1lbXB0eSBwcmVmaXggaW50byBzb21lIHNvcnQgb2YgZGVjaXNpb24gdHJlZQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlKGV2dCkgewogICAgICAgICAgICBpZiAoZXZ0ICYmIGV2dC5kZWZhdWx0UHJldmVudGVkKSByZXR1cm47CiAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrKHJ1bGUpIHsKICAgICAgICAgICAgICB2YXIgaGFuZGxlZCA9IHJ1bGUoJGluamVjdG9yLCAkbG9jYXRpb24pOwogICAgICAgICAgICAgIGlmIChoYW5kbGVkKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoaGFuZGxlZCkpICRsb2NhdGlvbi5yZXBsYWNlKCkudXJsKGhhbmRsZWQpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbj1ydWxlcy5sZW5ndGgsIGk7CiAgICAgICAgICAgIGZvciAoaT0wOyBpPG47IGkrKykgewogICAgICAgICAgICAgIGlmIChjaGVjayhydWxlc1tpXSkpIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBhbHdheXMgY2hlY2sgb3RoZXJ3aXNlIGxhc3QgdG8gYWxsb3cgZHluYW1pYyB1cGRhdGVzIHRvIHRoZSBzZXQgb2YgcnVsZXMKICAgICAgICAgICAgaWYgKG90aGVyd2lzZSkgY2hlY2sob3RoZXJ3aXNlKTsKICAgICAgICAgIH0KCiAgICAgICAgICAkcm9vdFNjb3BlLiRvbignJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcycsIHVwZGF0ZSk7CgogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXIjc3luYwogICAgICAgICAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBUcmlnZ2VycyBhbiB1cGRhdGU7IHRoZSBzYW1lIHVwZGF0ZSB0aGF0IGhhcHBlbnMgd2hlbiB0aGUgYWRkcmVzcyBiYXIgdXJsIGNoYW5nZXMsIGFrYSBgJGxvY2F0aW9uQ2hhbmdlU3VjY2Vzc2AuCiAgICAgICAgICAgICAqIFRoaXMgbWV0aG9kIGlzIHVzZWZ1bCB3aGVuIHlvdSBuZWVkIHRvIHVzZSBgcHJldmVudERlZmF1bHQoKWAgb24gdGhlIGAkbG9jYXRpb25DaGFuZ2VTdWNjZXNzYCBldmVudCwKICAgICAgICAgICAgICogcGVyZm9ybSBzb21lIGN1c3RvbSBsb2dpYyAocm91dGUgcHJvdGVjdGlvbiwgYXV0aCwgY29uZmlnLCByZWRpcmVjdGlvbiwgZXRjKSBhbmQgdGhlbiBmaW5hbGx5IHByb2NlZWQKICAgICAgICAgICAgICogd2l0aCB0aGUgdHJhbnNpdGlvbiBieSBjYWxsaW5nIGAkdXJsUm91dGVyLnN5bmMoKWAuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAqIGFuZ3VsYXIubW9kdWxlKCdhcHAnLCBbJ3VpLnJvdXRlciddKTsKICAgICAgICAgICAgICogICAucnVuKGZ1bmN0aW9uKCRyb290U2NvcGUsICR1cmxSb3V0ZXIpIHsKICAgICAgICAgKiAgICAgJHJvb3RTY29wZS4kb24oJyRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3MnLCBmdW5jdGlvbihldnQpIHsKICAgICAgICAgKiAgICAgICAvLyBIYWx0IHN0YXRlIGNoYW5nZSBmcm9tIGV2ZW4gc3RhcnRpbmcKICAgICAgICAgKiAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgKiAgICAgICAvLyBQZXJmb3JtIGN1c3RvbSBsb2dpYwogICAgICAgICAqICAgICAgIHZhciBtZWV0c1JlcXVpcmVtZW50ID0gLi4uCiAgICAgICAgICogICAgICAgLy8gQ29udGludWUgd2l0aCB0aGUgdXBkYXRlIGFuZCBzdGF0ZSB0cmFuc2l0aW9uIGlmIGxvZ2ljIGFsbG93cwogICAgICAgICAqICAgICAgIGlmIChtZWV0c1JlcXVpcmVtZW50KSAkdXJsUm91dGVyLnN5bmMoKTsKICAgICAgICAgKiAgICAgfSk7CiAgICAgICAgICogfSk7CiAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc3luYzogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIHVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH1dOwogIH0KCiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5yb3V0ZXInKS5wcm92aWRlcignJHVybFJvdXRlcicsICRVcmxSb3V0ZXJQcm92aWRlcik7CgogIC8qKgogICAqIEBuZ2RvYyBvYmplY3QKICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlUHJvdmlkZXIKICAgKgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlcgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIudXRpbC4kdXJsTWF0Y2hlckZhY3RvcnlQcm92aWRlcgogICAqIEByZXF1aXJlcyAkbG9jYXRpb25Qcm92aWRlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIG5ldyBgJHN0YXRlUHJvdmlkZXJgIHdvcmtzIHNpbWlsYXIgdG8gQW5ndWxhcidzIHYxIHJvdXRlciwgYnV0IGl0IGZvY3VzZXMgcHVyZWx5CiAgICogb24gc3RhdGUuCiAgICoKICAgKiBBIHN0YXRlIGNvcnJlc3BvbmRzIHRvIGEgInBsYWNlIiBpbiB0aGUgYXBwbGljYXRpb24gaW4gdGVybXMgb2YgdGhlIG92ZXJhbGwgVUkgYW5kCiAgICogbmF2aWdhdGlvbi4gQSBzdGF0ZSBkZXNjcmliZXMgKHZpYSB0aGUgY29udHJvbGxlciAvIHRlbXBsYXRlIC8gdmlldyBwcm9wZXJ0aWVzKSB3aGF0CiAgICogdGhlIFVJIGxvb2tzIGxpa2UgYW5kIGRvZXMgYXQgdGhhdCBwbGFjZS4KICAgKgogICAqIFN0YXRlcyBvZnRlbiBoYXZlIHRoaW5ncyBpbiBjb21tb24sIGFuZCB0aGUgcHJpbWFyeSB3YXkgb2YgZmFjdG9yaW5nIG91dCB0aGVzZQogICAqIGNvbW1vbmFsaXRpZXMgaW4gdGhpcyBtb2RlbCBpcyB2aWEgdGhlIHN0YXRlIGhpZXJhcmNoeSwgaS5lLiBwYXJlbnQvY2hpbGQgc3RhdGVzIGFrYQogICAqIG5lc3RlZCBzdGF0ZXMuCiAgICoKICAgKiBUaGUgYCRzdGF0ZVByb3ZpZGVyYCBwcm92aWRlcyBpbnRlcmZhY2VzIHRvIGRlY2xhcmUgdGhlc2Ugc3RhdGVzIGZvciB5b3VyIGFwcC4KICAgKi8KICAkU3RhdGVQcm92aWRlci4kaW5qZWN0ID0gWyckdXJsUm91dGVyUHJvdmlkZXInLCAnJHVybE1hdGNoZXJGYWN0b3J5UHJvdmlkZXInLCAnJGxvY2F0aW9uUHJvdmlkZXInXTsKICBmdW5jdGlvbiAkU3RhdGVQcm92aWRlciggICAkdXJsUm91dGVyUHJvdmlkZXIsICAgJHVybE1hdGNoZXJGYWN0b3J5LCAgICAgICAgICAgJGxvY2F0aW9uUHJvdmlkZXIpIHsKCiAgICB2YXIgcm9vdCwgc3RhdGVzID0ge30sICRzdGF0ZSwgcXVldWUgPSB7fSwgYWJzdHJhY3RLZXkgPSAnYWJzdHJhY3QnOwoKICAgIC8vIEJ1aWxkcyBzdGF0ZSBwcm9wZXJ0aWVzIGZyb20gZGVmaW5pdGlvbiBwYXNzZWQgdG8gcmVnaXN0ZXJTdGF0ZSgpCiAgICB2YXIgc3RhdGVCdWlsZGVyID0gewoKICAgICAgLy8gRGVyaXZlIHBhcmVudCBzdGF0ZSBmcm9tIGEgaGllcmFyY2hpY2FsIG5hbWUgb25seSBpZiAncGFyZW50JyBpcyBub3QgZXhwbGljaXRseSBkZWZpbmVkLgogICAgICAvLyBzdGF0ZS5jaGlsZHJlbiA9IFtdOwogICAgICAvLyBpZiAocGFyZW50KSBwYXJlbnQuY2hpbGRyZW4ucHVzaChzdGF0ZSk7CiAgICAgIHBhcmVudDogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgICBpZiAoaXNEZWZpbmVkKHN0YXRlLnBhcmVudCkgJiYgc3RhdGUucGFyZW50KSByZXR1cm4gZmluZFN0YXRlKHN0YXRlLnBhcmVudCk7CiAgICAgICAgLy8gcmVnZXggbWF0Y2hlcyBhbnkgdmFsaWQgY29tcG9zaXRlIHN0YXRlIG5hbWUKICAgICAgICAvLyB3b3VsZCBtYXRjaCAiY29udGFjdC5saXN0IiBidXQgbm90ICJjb250YWN0cyIKICAgICAgICB2YXIgY29tcG9zaXRlTmFtZSA9IC9eKC4rKVwuW14uXSskLy5leGVjKHN0YXRlLm5hbWUpOwogICAgICAgIHJldHVybiBjb21wb3NpdGVOYW1lID8gZmluZFN0YXRlKGNvbXBvc2l0ZU5hbWVbMV0pIDogcm9vdDsKICAgICAgfSwKCiAgICAgIC8vIGluaGVyaXQgJ2RhdGEnIGZyb20gcGFyZW50IGFuZCBvdmVycmlkZSBieSBvd24gdmFsdWVzIChpZiBhbnkpCiAgICAgIGRhdGE6IGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgICAgaWYgKHN0YXRlLnBhcmVudCAmJiBzdGF0ZS5wYXJlbnQuZGF0YSkgewogICAgICAgICAgc3RhdGUuZGF0YSA9IHN0YXRlLnNlbGYuZGF0YSA9IGV4dGVuZCh7fSwgc3RhdGUucGFyZW50LmRhdGEsIHN0YXRlLmRhdGEpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RhdGUuZGF0YTsKICAgICAgfSwKCiAgICAgIC8vIEJ1aWxkIGEgVVJMTWF0Y2hlciBpZiBuZWNlc3NhcnksIGVpdGhlciB2aWEgYSByZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwKICAgICAgdXJsOiBmdW5jdGlvbihzdGF0ZSkgewogICAgICAgIHZhciB1cmwgPSBzdGF0ZS51cmw7CgogICAgICAgIGlmIChpc1N0cmluZyh1cmwpKSB7CiAgICAgICAgICBpZiAodXJsLmNoYXJBdCgwKSA9PSAnXicpIHsKICAgICAgICAgICAgcmV0dXJuICR1cmxNYXRjaGVyRmFjdG9yeS5jb21waWxlKHVybC5zdWJzdHJpbmcoMSkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIChzdGF0ZS5wYXJlbnQubmF2aWdhYmxlIHx8IHJvb3QpLnVybC5jb25jYXQodXJsKTsKICAgICAgICB9CgogICAgICAgIGlmICgkdXJsTWF0Y2hlckZhY3RvcnkuaXNNYXRjaGVyKHVybCkgfHwgdXJsID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCB1cmwgJyIgKyB1cmwgKyAiJyBpbiBzdGF0ZSAnIiArIHN0YXRlICsgIiciKTsKICAgICAgfSwKCiAgICAgIC8vIEtlZXAgdHJhY2sgb2YgdGhlIGNsb3Nlc3QgYW5jZXN0b3Igc3RhdGUgdGhhdCBoYXMgYSBVUkwgKGkuZS4gaXMgbmF2aWdhYmxlKQogICAgICBuYXZpZ2FibGU6IGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgICAgcmV0dXJuIHN0YXRlLnVybCA/IHN0YXRlIDogKHN0YXRlLnBhcmVudCA/IHN0YXRlLnBhcmVudC5uYXZpZ2FibGUgOiBudWxsKTsKICAgICAgfSwKCiAgICAgIC8vIERlcml2ZSBwYXJhbWV0ZXJzIGZvciB0aGlzIHN0YXRlIGFuZCBlbnN1cmUgdGhleSdyZSBhIHN1cGVyLXNldCBvZiBwYXJlbnQncyBwYXJhbWV0ZXJzCiAgICAgIHBhcmFtczogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgICBpZiAoIXN0YXRlLnBhcmFtcykgewogICAgICAgICAgcmV0dXJuIHN0YXRlLnVybCA/IHN0YXRlLnVybC5wYXJhbWV0ZXJzKCkgOiBzdGF0ZS5wYXJlbnQucGFyYW1zOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzQXJyYXkoc3RhdGUucGFyYW1zKSkgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHBhcmFtcyBpbiBzdGF0ZSAnIiArIHN0YXRlICsgIiciKTsKICAgICAgICBpZiAoc3RhdGUudXJsKSB0aHJvdyBuZXcgRXJyb3IoIkJvdGggcGFyYW1zIGFuZCB1cmwgc3BlY2ljaWZpZWQgaW4gc3RhdGUgJyIgKyBzdGF0ZSArICInIik7CiAgICAgICAgcmV0dXJuIHN0YXRlLnBhcmFtczsKICAgICAgfSwKCiAgICAgIC8vIElmIHRoZXJlIGlzIG5vIGV4cGxpY2l0IG11bHRpLXZpZXcgY29uZmlndXJhdGlvbiwgbWFrZSBvbmUgdXAgc28gd2UgZG9uJ3QgaGF2ZQogICAgICAvLyB0byBoYW5kbGUgYm90aCBjYXNlcyBpbiB0aGUgdmlldyBkaXJlY3RpdmUgbGF0ZXIuIE5vdGUgdGhhdCBoYXZpbmcgYW4gZXhwbGljaXQKICAgICAgLy8gJ3ZpZXdzJyBwcm9wZXJ0eSB3aWxsIG1lYW4gdGhlIGRlZmF1bHQgdW5uYW1lZCB2aWV3IHByb3BlcnRpZXMgYXJlIGlnbm9yZWQuIFRoaXMKICAgICAgLy8gaXMgYWxzbyBhIGdvb2QgdGltZSB0byByZXNvbHZlIHZpZXcgbmFtZXMgdG8gYWJzb2x1dGUgbmFtZXMsIHNvIGV2ZXJ5dGhpbmcgaXMgYQogICAgICAvLyBzdHJhaWdodCBsb29rdXAgYXQgbGluayB0aW1lLgogICAgICB2aWV3czogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgICB2YXIgdmlld3MgPSB7fTsKCiAgICAgICAgZm9yRWFjaChpc0RlZmluZWQoc3RhdGUudmlld3MpID8gc3RhdGUudmlld3MgOiB7ICcnOiBzdGF0ZSB9LCBmdW5jdGlvbiAodmlldywgbmFtZSkgewogICAgICAgICAgaWYgKG5hbWUuaW5kZXhPZignQCcpIDwgMCkgbmFtZSArPSAnQCcgKyBzdGF0ZS5wYXJlbnQubmFtZTsKICAgICAgICAgIHZpZXdzW25hbWVdID0gdmlldzsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdmlld3M7CiAgICAgIH0sCgogICAgICBvd25QYXJhbXM6IGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgICAgaWYgKCFzdGF0ZS5wYXJlbnQpIHsKICAgICAgICAgIHJldHVybiBzdGF0ZS5wYXJhbXM7CiAgICAgICAgfQogICAgICAgIHZhciBwYXJhbU5hbWVzID0ge307IGZvckVhY2goc3RhdGUucGFyYW1zLCBmdW5jdGlvbiAocCkgeyBwYXJhbU5hbWVzW3BdID0gdHJ1ZTsgfSk7CgogICAgICAgIGZvckVhY2goc3RhdGUucGFyZW50LnBhcmFtcywgZnVuY3Rpb24gKHApIHsKICAgICAgICAgIGlmICghcGFyYW1OYW1lc1twXSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3NpbmcgcmVxdWlyZWQgcGFyYW1ldGVyICciICsgcCArICInIGluIHN0YXRlICciICsgc3RhdGUubmFtZSArICInIik7CiAgICAgICAgICB9CiAgICAgICAgICBwYXJhbU5hbWVzW3BdID0gZmFsc2U7CiAgICAgICAgfSk7CiAgICAgICAgdmFyIG93blBhcmFtcyA9IFtdOwoKICAgICAgICBmb3JFYWNoKHBhcmFtTmFtZXMsIGZ1bmN0aW9uIChvd24sIHApIHsKICAgICAgICAgIGlmIChvd24pIG93blBhcmFtcy5wdXNoKHApOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBvd25QYXJhbXM7CiAgICAgIH0sCgogICAgICAvLyBLZWVwIGEgZnVsbCBwYXRoIGZyb20gdGhlIHJvb3QgZG93biB0byB0aGlzIHN0YXRlIGFzIHRoaXMgaXMgbmVlZGVkIGZvciBzdGF0ZSBhY3RpdmF0aW9uLgogICAgICBwYXRoOiBmdW5jdGlvbihzdGF0ZSkgewogICAgICAgIHJldHVybiBzdGF0ZS5wYXJlbnQgPyBzdGF0ZS5wYXJlbnQucGF0aC5jb25jYXQoc3RhdGUpIDogW107IC8vIGV4Y2x1ZGUgcm9vdCBmcm9tIHBhdGgKICAgICAgfSwKCiAgICAgIC8vIFNwZWVkIHVwICRzdGF0ZS5jb250YWlucygpIGFzIGl0J3MgdXNlZCBhIGxvdAogICAgICBpbmNsdWRlczogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgICB2YXIgaW5jbHVkZXMgPSBzdGF0ZS5wYXJlbnQgPyBleHRlbmQoe30sIHN0YXRlLnBhcmVudC5pbmNsdWRlcykgOiB7fTsKICAgICAgICBpbmNsdWRlc1tzdGF0ZS5uYW1lXSA9IHRydWU7CiAgICAgICAgcmV0dXJuIGluY2x1ZGVzOwogICAgICB9LAoKICAgICAgJGRlbGVnYXRlczoge30KICAgIH07CgogICAgZnVuY3Rpb24gaXNSZWxhdGl2ZShzdGF0ZU5hbWUpIHsKICAgICAgcmV0dXJuIHN0YXRlTmFtZS5pbmRleE9mKCIuIikgPT09IDAgfHwgc3RhdGVOYW1lLmluZGV4T2YoIl4iKSA9PT0gMDsKICAgIH0KCiAgICBmdW5jdGlvbiBmaW5kU3RhdGUoc3RhdGVPck5hbWUsIGJhc2UpIHsKICAgICAgdmFyIGlzU3RyID0gaXNTdHJpbmcoc3RhdGVPck5hbWUpLAogICAgICAgIG5hbWUgID0gaXNTdHIgPyBzdGF0ZU9yTmFtZSA6IHN0YXRlT3JOYW1lLm5hbWUsCiAgICAgICAgcGF0aCAgPSBpc1JlbGF0aXZlKG5hbWUpOwoKICAgICAgaWYgKHBhdGgpIHsKICAgICAgICBpZiAoIWJhc2UpIHRocm93IG5ldyBFcnJvcigiTm8gcmVmZXJlbmNlIHBvaW50IGdpdmVuIGZvciBwYXRoICciICArIG5hbWUgKyAiJyIpOwogICAgICAgIHZhciByZWwgPSBuYW1lLnNwbGl0KCIuIiksIGkgPSAwLCBwYXRoTGVuZ3RoID0gcmVsLmxlbmd0aCwgY3VycmVudCA9IGJhc2U7CgogICAgICAgIGZvciAoOyBpIDwgcGF0aExlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAocmVsW2ldID09PSAiIiAmJiBpID09PSAwKSB7CiAgICAgICAgICAgIGN1cnJlbnQgPSBiYXNlOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZWxbaV0gPT09ICJeIikgewogICAgICAgICAgICBpZiAoIWN1cnJlbnQucGFyZW50KSB0aHJvdyBuZXcgRXJyb3IoIlBhdGggJyIgKyBuYW1lICsgIicgbm90IHZhbGlkIGZvciBzdGF0ZSAnIiArIGJhc2UubmFtZSArICInIik7CiAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LnBhcmVudDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgcmVsID0gcmVsLnNsaWNlKGkpLmpvaW4oIi4iKTsKICAgICAgICBuYW1lID0gY3VycmVudC5uYW1lICsgKGN1cnJlbnQubmFtZSAmJiByZWwgPyAiLiIgOiAiIikgKyByZWw7CiAgICAgIH0KICAgICAgdmFyIHN0YXRlID0gc3RhdGVzW25hbWVdOwoKICAgICAgaWYgKHN0YXRlICYmIChpc1N0ciB8fCAoIWlzU3RyICYmIChzdGF0ZSA9PT0gc3RhdGVPck5hbWUgfHwgc3RhdGUuc2VsZiA9PT0gc3RhdGVPck5hbWUpKSkpIHsKICAgICAgICByZXR1cm4gc3RhdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KCiAgICBmdW5jdGlvbiBxdWV1ZVN0YXRlKHBhcmVudE5hbWUsIHN0YXRlKSB7CiAgICAgIGlmICghcXVldWVbcGFyZW50TmFtZV0pIHsKICAgICAgICBxdWV1ZVtwYXJlbnROYW1lXSA9IFtdOwogICAgICB9CiAgICAgIHF1ZXVlW3BhcmVudE5hbWVdLnB1c2goc3RhdGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlZ2lzdGVyU3RhdGUoc3RhdGUpIHsKICAgICAgLy8gV3JhcCBhIG5ldyBvYmplY3QgYXJvdW5kIHRoZSBzdGF0ZSBzbyB3ZSBjYW4gc3RvcmUgb3VyIHByaXZhdGUgZGV0YWlscyBlYXNpbHkuCiAgICAgIHN0YXRlID0gaW5oZXJpdChzdGF0ZSwgewogICAgICAgIHNlbGY6IHN0YXRlLAogICAgICAgIHJlc29sdmU6IHN0YXRlLnJlc29sdmUgfHwge30sCiAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgeyByZXR1cm4gdGhpcy5uYW1lOyB9CiAgICAgIH0pOwoKICAgICAgdmFyIG5hbWUgPSBzdGF0ZS5uYW1lOwogICAgICBpZiAoIWlzU3RyaW5nKG5hbWUpIHx8IG5hbWUuaW5kZXhPZignQCcpID49IDApIHRocm93IG5ldyBFcnJvcigiU3RhdGUgbXVzdCBoYXZlIGEgdmFsaWQgbmFtZSIpOwogICAgICBpZiAoc3RhdGVzLmhhc093blByb3BlcnR5KG5hbWUpKSB0aHJvdyBuZXcgRXJyb3IoIlN0YXRlICciICsgbmFtZSArICInJyBpcyBhbHJlYWR5IGRlZmluZWQiKTsKCiAgICAgIC8vIEdldCBwYXJlbnQgbmFtZQogICAgICB2YXIgcGFyZW50TmFtZSA9IChuYW1lLmluZGV4T2YoJy4nKSAhPT0gLTEpID8gbmFtZS5zdWJzdHJpbmcoMCwgbmFtZS5sYXN0SW5kZXhPZignLicpKQogICAgICAgIDogKGlzU3RyaW5nKHN0YXRlLnBhcmVudCkpID8gc3RhdGUucGFyZW50CiAgICAgICAgOiAnJzsKCiAgICAgIC8vIElmIHBhcmVudCBpcyBub3QgcmVnaXN0ZXJlZCB5ZXQsIGFkZCBzdGF0ZSB0byBxdWV1ZSBhbmQgcmVnaXN0ZXIgbGF0ZXIKICAgICAgaWYgKHBhcmVudE5hbWUgJiYgIXN0YXRlc1twYXJlbnROYW1lXSkgewogICAgICAgIHJldHVybiBxdWV1ZVN0YXRlKHBhcmVudE5hbWUsIHN0YXRlLnNlbGYpOwogICAgICB9CgogICAgICBmb3IgKHZhciBrZXkgaW4gc3RhdGVCdWlsZGVyKSB7CiAgICAgICAgaWYgKGlzRnVuY3Rpb24oc3RhdGVCdWlsZGVyW2tleV0pKSBzdGF0ZVtrZXldID0gc3RhdGVCdWlsZGVyW2tleV0oc3RhdGUsIHN0YXRlQnVpbGRlci4kZGVsZWdhdGVzW2tleV0pOwogICAgICB9CiAgICAgIHN0YXRlc1tuYW1lXSA9IHN0YXRlOwoKICAgICAgLy8gUmVnaXN0ZXIgdGhlIHN0YXRlIGluIHRoZSBnbG9iYWwgc3RhdGUgbGlzdCBhbmQgd2l0aCAkdXJsUm91dGVyIGlmIG5lY2Vzc2FyeS4KICAgICAgaWYgKCFzdGF0ZVthYnN0cmFjdEtleV0gJiYgc3RhdGUudXJsKSB7CiAgICAgICAgJHVybFJvdXRlclByb3ZpZGVyLndoZW4oc3RhdGUudXJsLCBbJyRtYXRjaCcsICckc3RhdGVQYXJhbXMnLCBmdW5jdGlvbiAoJG1hdGNoLCAkc3RhdGVQYXJhbXMpIHsKICAgICAgICAgIGlmICgkc3RhdGUuJGN1cnJlbnQubmF2aWdhYmxlICE9IHN0YXRlIHx8ICFlcXVhbEZvcktleXMoJG1hdGNoLCAkc3RhdGVQYXJhbXMpKSB7CiAgICAgICAgICAgICRzdGF0ZS50cmFuc2l0aW9uVG8oc3RhdGUsICRtYXRjaCwgeyBsb2NhdGlvbjogZmFsc2UgfSk7CiAgICAgICAgICB9CiAgICAgICAgfV0pOwogICAgICB9CgogICAgICAvLyBSZWdpc3RlciBhbnkgcXVldWVkIGNoaWxkcmVuCiAgICAgIGlmIChxdWV1ZVtuYW1lXSkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWVbbmFtZV0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHJlZ2lzdGVyU3RhdGUocXVldWVbbmFtZV1baV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHN0YXRlOwogICAgfQoKICAgIC8vIENoZWNrcyB0ZXh0IHRvIHNlZSBpZiBpdCBsb29rcyBsaWtlIGEgZ2xvYi4KICAgIGZ1bmN0aW9uIGlzR2xvYiAodGV4dCkgewogICAgICByZXR1cm4gdGV4dC5pbmRleE9mKCcqJykgPiAtMTsKICAgIH0KCiAgICAvLyBSZXR1cm5zIHRydWUgaWYgZ2xvYiBtYXRjaGVzIGN1cnJlbnQgJHN0YXRlIG5hbWUuCiAgICBmdW5jdGlvbiBkb2VzU3RhdGVNYXRjaEdsb2IgKGdsb2IpIHsKICAgICAgdmFyIGdsb2JTZWdtZW50cyA9IGdsb2Iuc3BsaXQoJy4nKSwKICAgICAgICBzZWdtZW50cyA9ICRzdGF0ZS4kY3VycmVudC5uYW1lLnNwbGl0KCcuJyk7CgogICAgICAvL21hdGNoIGdyZWVkeSBzdGFydHMKICAgICAgaWYgKGdsb2JTZWdtZW50c1swXSA9PT0gJyoqJykgewogICAgICAgIHNlZ21lbnRzID0gc2VnbWVudHMuc2xpY2Uoc2VnbWVudHMuaW5kZXhPZihnbG9iU2VnbWVudHNbMV0pKTsKICAgICAgICBzZWdtZW50cy51bnNoaWZ0KCcqKicpOwogICAgICB9CiAgICAgIC8vbWF0Y2ggZ3JlZWR5IGVuZHMKICAgICAgaWYgKGdsb2JTZWdtZW50c1tnbG9iU2VnbWVudHMubGVuZ3RoIC0gMV0gPT09ICcqKicpIHsKICAgICAgICBzZWdtZW50cy5zcGxpY2Uoc2VnbWVudHMuaW5kZXhPZihnbG9iU2VnbWVudHNbZ2xvYlNlZ21lbnRzLmxlbmd0aCAtIDJdKSArIDEsIE51bWJlci5NQVhfVkFMVUUpOwogICAgICAgIHNlZ21lbnRzLnB1c2goJyoqJyk7CiAgICAgIH0KCiAgICAgIGlmIChnbG9iU2VnbWVudHMubGVuZ3RoICE9IHNlZ21lbnRzLmxlbmd0aCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgLy9tYXRjaCBzaW5nbGUgc3RhcnMKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBnbG9iU2VnbWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaWYgKGdsb2JTZWdtZW50c1tpXSA9PT0gJyonKSB7CiAgICAgICAgICBzZWdtZW50c1tpXSA9ICcqJzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBzZWdtZW50cy5qb2luKCcnKSA9PT0gZ2xvYlNlZ21lbnRzLmpvaW4oJycpOwogICAgfQoKCiAgICAvLyBJbXBsaWNpdCByb290IHN0YXRlIHRoYXQgaXMgYWx3YXlzIGFjdGl2ZQogICAgcm9vdCA9IHJlZ2lzdGVyU3RhdGUoewogICAgICBuYW1lOiAnJywKICAgICAgdXJsOiAnXicsCiAgICAgIHZpZXdzOiBudWxsLAogICAgICAnYWJzdHJhY3QnOiB0cnVlCiAgICB9KTsKICAgIHJvb3QubmF2aWdhYmxlID0gbnVsbDsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlciNkZWNvcmF0b3IKICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlUHJvdmlkZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEFsbG93cyB5b3UgdG8gZXh0ZW5kIChjYXJlZnVsbHkpIG9yIG92ZXJyaWRlIChhdCB5b3VyIG93biBwZXJpbCkgdGhlCiAgICAgKiBgc3RhdGVCdWlsZGVyYCBvYmplY3QgdXNlZCBpbnRlcm5hbGx5IGJ5IGAkc3RhdGVQcm92aWRlcmAuIFRoaXMgY2FuIGJlIHVzZWQKICAgICAqIHRvIGFkZCBjdXN0b20gZnVuY3Rpb25hbGl0eSB0byB1aS1yb3V0ZXIsIGZvciBleGFtcGxlIGluZmVycmluZyB0ZW1wbGF0ZVVybAogICAgICogYmFzZWQgb24gdGhlIHN0YXRlIG5hbWUuCiAgICAgKgogICAgICogV2hlbiBwYXNzaW5nIG9ubHkgYSBuYW1lLCBpdCByZXR1cm5zIHRoZSBjdXJyZW50IChvcmlnaW5hbCBvciBkZWNvcmF0ZWQpIGJ1aWxkZXIKICAgICAqIGZ1bmN0aW9uIHRoYXQgbWF0Y2hlcyBgbmFtZWAuCiAgICAgKgogICAgICogVGhlIGJ1aWxkZXIgZnVuY3Rpb25zIHRoYXQgY2FuIGJlIGRlY29yYXRlZCBhcmUgbGlzdGVkIGJlbG93LiBUaG91Z2ggbm90IGFsbAogICAgICogbmVjZXNzYXJpbHkgaGF2ZSBhIGdvb2QgdXNlIGNhc2UgZm9yIGRlY29yYXRpb24sIHRoYXQgaXMgdXAgdG8geW91IHRvIGRlY2lkZS4KICAgICAqCiAgICAgKiBJbiBhZGRpdGlvbiwgdXNlcnMgY2FuIGF0dGFjaCBjdXN0b20gZGVjb3JhdG9ycywgd2hpY2ggd2lsbCBnZW5lcmF0ZSBuZXcKICAgICAqIHByb3BlcnRpZXMgd2l0aGluIHRoZSBzdGF0ZSdzIGludGVybmFsIGRlZmluaXRpb24uIFRoZXJlIGlzIGN1cnJlbnRseSBubyBjbGVhcgogICAgICogdXNlLWNhc2UgZm9yIHRoaXMgYmV5b25kIGFjY2Vzc2luZyBpbnRlcm5hbCBzdGF0ZXMgKGkuZS4gJHN0YXRlLiRjdXJyZW50KSwKICAgICAqIGhvd2V2ZXIsIGV4cGVjdCB0aGlzIHRvIGJlY29tZSBpbmNyZWFzaW5nbHkgcmVsZXZhbnQgYXMgd2UgaW50cm9kdWNlIGFkZGl0aW9uYWwKICAgICAqIG1ldGEtcHJvZ3JhbW1pbmcgZmVhdHVyZXMuCiAgICAgKgogICAgICogKipXYXJuaW5nKio6IERlY29yYXRvcnMgc2hvdWxkIG5vdCBiZSBpbnRlcmRlcGVuZGVudCBiZWNhdXNlIHRoZSBvcmRlciBvZgogICAgICogZXhlY3V0aW9uIG9mIHRoZSBidWlsZGVyIGZ1bmN0aW9ucyBpbiBub24tZGV0ZXJtaW5pc3RpYy4gQnVpbGRlciBmdW5jdGlvbnMKICAgICAqIHNob3VsZCBvbmx5IGJlIGRlcGVuZGVudCBvbiB0aGUgc3RhdGUgZGVmaW5pdGlvbiBvYmplY3QgYW5kIHN1cGVyIGZ1bmN0aW9uLgogICAgICoKICAgICAqCiAgICAgKiBFeGlzdGluZyBidWlsZGVyIGZ1bmN0aW9ucyBhbmQgY3VycmVudCByZXR1cm4gdmFsdWVzOgogICAgICoKICAgICAqIC0gKipwYXJlbnQqKiBge29iamVjdH1gIC0gcmV0dXJucyB0aGUgcGFyZW50IHN0YXRlIG9iamVjdC4KICAgICAqIC0gKipkYXRhKiogYHtvYmplY3R9YCAtIHJldHVybnMgc3RhdGUgZGF0YSwgaW5jbHVkaW5nIGFueSBpbmhlcml0ZWQgZGF0YSB0aGF0IGlzIG5vdAogICAgICogICBvdmVycmlkZGVuIGJ5IG93biB2YWx1ZXMgKGlmIGFueSkuCiAgICAgKiAtICoqdXJsKiogYHtvYmplY3R9YCAtIHJldHVybnMgYSB7bGluayB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXJ9IG9yIG51bGwuCiAgICAgKiAtICoqbmF2aWdhYmxlKiogYHtvYmplY3R9YCAtIHJldHVybnMgY2xvc2VzdCBhbmNlc3RvciBzdGF0ZSB0aGF0IGhhcyBhIFVSTCAoYWthIGlzCiAgICAgKiAgIG5hdmlnYWJsZSkuCiAgICAgKiAtICoqcGFyYW1zKiogYHtvYmplY3R9YCAtIHJldHVybnMgYW4gYXJyYXkgb2Ygc3RhdGUgcGFyYW1zIHRoYXQgYXJlIGVuc3VyZWQgdG8KICAgICAqICAgYmUgYSBzdXBlci1zZXQgb2YgcGFyZW50J3MgcGFyYW1zLgogICAgICogLSAqKnZpZXdzKiogYHtvYmplY3R9YCAtIHJldHVybnMgYSB2aWV3cyBvYmplY3Qgd2hlcmUgZWFjaCBrZXkgaXMgYW4gYWJzb2x1dGUgdmlldwogICAgICogICBuYW1lIChpLmUuICJ2aWV3TmFtZUBzdGF0ZU5hbWUiKSBhbmQgZWFjaCB2YWx1ZSBpcyB0aGUgY29uZmlnIG9iamVjdAogICAgICogICAodGVtcGxhdGUsIGNvbnRyb2xsZXIpIGZvciB0aGUgdmlldy4gRXZlbiB3aGVuIHlvdSBkb24ndCB1c2UgdGhlIHZpZXdzIG9iamVjdAogICAgICogICBleHBsaWNpdGx5IG9uIGEgc3RhdGUgY29uZmlnLCBvbmUgaXMgc3RpbGwgY3JlYXRlZCBmb3IgeW91IGludGVybmFsbHkuCiAgICAgKiAgIFNvIGJ5IGRlY29yYXRpbmcgdGhpcyBidWlsZGVyIGZ1bmN0aW9uIHlvdSBoYXZlIGFjY2VzcyB0byBkZWNvcmF0aW5nIHRlbXBsYXRlCiAgICAgKiAgIGFuZCBjb250cm9sbGVyIHByb3BlcnRpZXMuCiAgICAgKiAtICoqb3duUGFyYW1zKiogYHtvYmplY3R9YCAtIHJldHVybnMgYW4gYXJyYXkgb2YgcGFyYW1zIHRoYXQgYmVsb25nIHRvIHRoZSBzdGF0ZSwKICAgICAqICAgbm90IGluY2x1ZGluZyBhbnkgcGFyYW1zIGRlZmluZWQgYnkgYW5jZXN0b3Igc3RhdGVzLgogICAgICogLSAqKnBhdGgqKiBge3N0cmluZ31gIC0gcmV0dXJucyB0aGUgZnVsbCBwYXRoIGZyb20gdGhlIHJvb3QgZG93biB0byB0aGlzIHN0YXRlLgogICAgICogICBOZWVkZWQgZm9yIHN0YXRlIGFjdGl2YXRpb24uCiAgICAgKiAtICoqaW5jbHVkZXMqKiBge29iamVjdH1gIC0gcmV0dXJucyBhbiBvYmplY3QgdGhhdCBpbmNsdWRlcyBldmVyeSBzdGF0ZSB0aGF0CiAgICAgKiAgIHdvdWxkIHBhc3MgYSAnJHN0YXRlLmluY2x1ZGVzKCknIHRlc3QuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiAvLyBPdmVycmlkZSB0aGUgaW50ZXJuYWwgJ3ZpZXdzJyBidWlsZGVyIHdpdGggYSBmdW5jdGlvbiB0aGF0IHRha2VzIHRoZSBzdGF0ZQogICAgICogLy8gZGVmaW5pdGlvbiwgYW5kIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBmdW5jdGlvbiBiZWluZyBvdmVycmlkZGVuOgogICAgICogJHN0YXRlUHJvdmlkZXIuZGVjb3JhdG9yKCd2aWV3cycsIGZ1bmN0aW9uICgkc3RhdGUsIHBhcmVudCkgewogICAqICAgdmFyIHJlc3VsdCA9IHt9LAogICAqICAgICAgIHZpZXdzID0gcGFyZW50KHN0YXRlKTsKICAgKgogICAqICAgYW5ndWxhci5mb3JFYWNoKHZpZXcsIGZ1bmN0aW9uIChjb25maWcsIG5hbWUpIHsKICAgKiAgICAgdmFyIGF1dG9OYW1lID0gKHN0YXRlLm5hbWUgKyAnLicgKyBuYW1lKS5yZXBsYWNlKCcuJywgJy8nKTsKICAgKiAgICAgY29uZmlnLnRlbXBsYXRlVXJsID0gY29uZmlnLnRlbXBsYXRlVXJsIHx8ICcvcGFydGlhbHMvJyArIGF1dG9OYW1lICsgJy5odG1sJzsKICAgKiAgICAgcmVzdWx0W25hbWVdID0gY29uZmlnOwogICAqICAgfSk7CiAgICogICByZXR1cm4gcmVzdWx0OwogICAqIH0pOwogICAgICoKICAgICAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCdob21lJywgewogICAqICAgdmlld3M6IHsKICAgKiAgICAgJ2NvbnRhY3QubGlzdCc6IHsgY29udHJvbGxlcjogJ0xpc3RDb250cm9sbGVyJyB9LAogICAqICAgICAnY29udGFjdC5pdGVtJzogeyBjb250cm9sbGVyOiAnSXRlbUNvbnRyb2xsZXInIH0KICAgKiAgIH0KICAgKiB9KTsKICAgICAqCiAgICAgKiAvLyAuLi4KICAgICAqCiAgICAgKiAkc3RhdGUuZ28oJ2hvbWUnKTsKICAgICAqIC8vIEF1dG8tcG9wdWxhdGVzIGxpc3QgYW5kIGl0ZW0gdmlld3Mgd2l0aCAvcGFydGlhbHMvaG9tZS9jb250YWN0L2xpc3QuaHRtbCwKICAgICAqIC8vIGFuZCAvcGFydGlhbHMvaG9tZS9jb250YWN0L2l0ZW0uaHRtbCwgcmVzcGVjdGl2ZWx5LgogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGJ1aWxkZXIgZnVuY3Rpb24gdG8gZGVjb3JhdGUuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZnVuYyBBIGZ1bmN0aW9uIHRoYXQgaXMgcmVzcG9uc2libGUgZm9yIGRlY29yYXRpbmcgdGhlIG9yaWdpbmFsCiAgICAgKiBidWlsZGVyIGZ1bmN0aW9uLiBUaGUgZnVuY3Rpb24gcmVjZWl2ZXMgdHdvIHBhcmFtZXRlcnM6CiAgICAgKgogICAgICogICAtIGB7b2JqZWN0fWAgLSBzdGF0ZSAtIFRoZSBzdGF0ZSBjb25maWcgb2JqZWN0LgogICAgICogICAtIGB7b2JqZWN0fWAgLSBzdXBlciAtIFRoZSBvcmlnaW5hbCBidWlsZGVyIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEByZXR1cm4ge29iamVjdH0gJHN0YXRlUHJvdmlkZXIgLSAkc3RhdGVQcm92aWRlciBpbnN0YW5jZQogICAgICovCiAgICB0aGlzLmRlY29yYXRvciA9IGRlY29yYXRvcjsKICAgIGZ1bmN0aW9uIGRlY29yYXRvcihuYW1lLCBmdW5jKSB7CiAgICAgIC8qanNoaW50IHZhbGlkdGhpczogdHJ1ZSAqLwogICAgICBpZiAoaXNTdHJpbmcobmFtZSkgJiYgIWlzRGVmaW5lZChmdW5jKSkgewogICAgICAgIHJldHVybiBzdGF0ZUJ1aWxkZXJbbmFtZV07CiAgICAgIH0KICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpIHx8ICFpc1N0cmluZyhuYW1lKSkgewogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIGlmIChzdGF0ZUJ1aWxkZXJbbmFtZV0gJiYgIXN0YXRlQnVpbGRlci4kZGVsZWdhdGVzW25hbWVdKSB7CiAgICAgICAgc3RhdGVCdWlsZGVyLiRkZWxlZ2F0ZXNbbmFtZV0gPSBzdGF0ZUJ1aWxkZXJbbmFtZV07CiAgICAgIH0KICAgICAgc3RhdGVCdWlsZGVyW25hbWVdID0gZnVuYzsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlciNzdGF0ZQogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXJzIGEgc3RhdGUgY29uZmlndXJhdGlvbiB1bmRlciBhIGdpdmVuIHN0YXRlIG5hbWUuIFRoZSBzdGF0ZUNvbmZpZyBvYmplY3QKICAgICAqIGhhcyB0aGUgZm9sbG93aW5nIGFjY2VwdGFibGUgcHJvcGVydGllcy4KICAgICAqCiAgICAgKiA8YSBpZD0ndGVtcGxhdGUnPjwvYT4KICAgICAqCiAgICAgKiAtICoqYHRlbXBsYXRlYCoqIC0ge3N0cmluZ3xmdW5jdGlvbj19IC0gaHRtbCB0ZW1wbGF0ZSBhcyBhIHN0cmluZyBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucwogICAgICogICBhbiBodG1sIHRlbXBsYXRlIGFzIGEgc3RyaW5nIHdoaWNoIHNob3VsZCBiZSB1c2VkIGJ5IHRoZSB1aVZpZXcgZGlyZWN0aXZlcy4gVGhpcyBwcm9wZXJ0eQogICAgICogICB0YWtlcyBwcmVjZWRlbmNlIG92ZXIgdGVtcGxhdGVVcmwuCiAgICAgKgogICAgICogICBJZiBgdGVtcGxhdGVgIGlzIGEgZnVuY3Rpb24sIGl0IHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogICAgICoKICAgICAqICAgLSB7YXJyYXkuJmx0O29iamVjdCZndDt9IC0gc3RhdGUgcGFyYW1ldGVycyBleHRyYWN0ZWQgZnJvbSB0aGUgY3VycmVudCAkbG9jYXRpb24ucGF0aCgpIGJ5CiAgICAgKiAgICAgYXBwbHlpbmcgdGhlIGN1cnJlbnQgc3RhdGUKICAgICAqCiAgICAgKiA8YSBpZD0ndGVtcGxhdGVVcmwnPjwvYT4KICAgICAqCiAgICAgKiAtICoqYHRlbXBsYXRlVXJsYCoqIC0ge3N0cmluZ3xmdW5jdGlvbj19IC0gcGF0aCBvciBmdW5jdGlvbiB0aGF0IHJldHVybnMgYSBwYXRoIHRvIGFuIGh0bWwKICAgICAqICAgdGVtcGxhdGUgdGhhdCBzaG91bGQgYmUgdXNlZCBieSB1aVZpZXcuCiAgICAgKgogICAgICogICBJZiBgdGVtcGxhdGVVcmxgIGlzIGEgZnVuY3Rpb24sIGl0IHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogICAgICoKICAgICAqICAgLSB7YXJyYXkuJmx0O29iamVjdCZndDt9IC0gc3RhdGUgcGFyYW1ldGVycyBleHRyYWN0ZWQgZnJvbSB0aGUgY3VycmVudCAkbG9jYXRpb24ucGF0aCgpIGJ5CiAgICAgKiAgICAgYXBwbHlpbmcgdGhlIGN1cnJlbnQgc3RhdGUKICAgICAqCiAgICAgKiA8YSBpZD0ndGVtcGxhdGVQcm92aWRlcic+PC9hPgogICAgICoKICAgICAqIC0gKipgdGVtcGxhdGVQcm92aWRlcmAqKiAtIHtmdW5jdGlvbj19IC0gUHJvdmlkZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zIEhUTUwgY29udGVudAogICAgICogICBzdHJpbmcuCiAgICAgKgogICAgICogPGEgaWQ9J2NvbnRyb2xsZXInPjwvYT4KICAgICAqCiAgICAgKiAtICoqYGNvbnRyb2xsZXJgKiogLSB7c3RyaW5nfGZ1bmN0aW9uPX0gLSAgQ29udHJvbGxlciBmbiB0aGF0IHNob3VsZCBiZSBhc3NvY2lhdGVkIHdpdGggbmV3bHkKICAgICAqICAgcmVsYXRlZCBzY29wZSBvciB0aGUgbmFtZSBvZiBhIHJlZ2lzdGVyZWQgY29udHJvbGxlciBpZiBwYXNzZWQgYXMgYSBzdHJpbmcuCiAgICAgKgogICAgICogPGEgaWQ9J2NvbnRyb2xsZXJQcm92aWRlcic+PC9hPgogICAgICoKICAgICAqIC0gKipgY29udHJvbGxlclByb3ZpZGVyYCoqIC0ge2Z1bmN0aW9uPX0gLSBJbmplY3RhYmxlIHByb3ZpZGVyIGZ1bmN0aW9uIHRoYXQgcmV0dXJucwogICAgICogICB0aGUgYWN0dWFsIGNvbnRyb2xsZXIgb3Igc3RyaW5nLgogICAgICoKICAgICAqIDxhIGlkPSdjb250cm9sbGVyQXMnPjwvYT4KICAgICAqCiAgICAgKiAtICoqYGNvbnRyb2xsZXJBc2AqKiDigJMge3N0cmluZz19IOKAkyBBIGNvbnRyb2xsZXIgYWxpYXMgbmFtZS4gSWYgcHJlc2VudCB0aGUgY29udHJvbGxlciB3aWxsIGJlCiAgICAgKiAgIHB1Ymxpc2hlZCB0byBzY29wZSB1bmRlciB0aGUgY29udHJvbGxlckFzIG5hbWUuCiAgICAgKgogICAgICogPGEgaWQ9J3Jlc29sdmUnPjwvYT4KICAgICAqCiAgICAgKiAtICoqYHJlc29sdmVgKiogLSB7b2JqZWN0LiZsdDtzdHJpbmcsIGZ1bmN0aW9uJmd0Oz19IC0gQW4gb3B0aW9uYWwgbWFwIG9mIGRlcGVuZGVuY2llcyB3aGljaAogICAgICogICBzaG91bGQgYmUgaW5qZWN0ZWQgaW50byB0aGUgY29udHJvbGxlci4gSWYgYW55IG9mIHRoZXNlIGRlcGVuZGVuY2llcyBhcmUgcHJvbWlzZXMsCiAgICAgKiAgIHRoZSByb3V0ZXIgd2lsbCB3YWl0IGZvciB0aGVtIGFsbCB0byBiZSByZXNvbHZlZCBvciBvbmUgdG8gYmUgcmVqZWN0ZWQgYmVmb3JlIHRoZQogICAgICogICBjb250cm9sbGVyIGlzIGluc3RhbnRpYXRlZC4gSWYgYWxsIHRoZSBwcm9taXNlcyBhcmUgcmVzb2x2ZWQgc3VjY2Vzc2Z1bGx5LCB0aGUgdmFsdWVzCiAgICAgKiAgIG9mIHRoZSByZXNvbHZlZCBwcm9taXNlcyBhcmUgaW5qZWN0ZWQgYW5kICRzdGF0ZUNoYW5nZVN1Y2Nlc3MgZXZlbnQgaXMgZmlyZWQuIElmIGFueQogICAgICogICBvZiB0aGUgcHJvbWlzZXMgYXJlIHJlamVjdGVkIHRoZSAkc3RhdGVDaGFuZ2VFcnJvciBldmVudCBpcyBmaXJlZC4gVGhlIG1hcCBvYmplY3QgaXM6CiAgICAgKgogICAgICogICAtIGtleSAtIHtzdHJpbmd9OiBuYW1lIG9mIGRlcGVuZGVuY3kgdG8gYmUgaW5qZWN0ZWQgaW50byBjb250cm9sbGVyCiAgICAgKiAgIC0gZmFjdG9yeSAtIHtzdHJpbmd8ZnVuY3Rpb259OiBJZiBzdHJpbmcgdGhlbiBpdCBpcyBhbGlhcyBmb3Igc2VydmljZS4gT3RoZXJ3aXNlIGlmIGZ1bmN0aW9uLAogICAgICogICAgIGl0IGlzIGluamVjdGVkIGFuZCByZXR1cm4gdmFsdWUgaXQgdHJlYXRlZCBhcyBkZXBlbmRlbmN5LiBJZiByZXN1bHQgaXMgYSBwcm9taXNlLCBpdCBpcwogICAgICogICAgIHJlc29sdmVkIGJlZm9yZSBpdHMgdmFsdWUgaXMgaW5qZWN0ZWQgaW50byBjb250cm9sbGVyLgogICAgICoKICAgICAqIDxhIGlkPSd1cmwnPjwvYT4KICAgICAqCiAgICAgKiAtICoqYHVybGAqKiAtIHtzdHJpbmc9fSAtIEEgdXJsIHdpdGggb3B0aW9uYWwgcGFyYW1ldGVycy4gV2hlbiBhIHN0YXRlIGlzIG5hdmlnYXRlZCBvcgogICAgICogICB0cmFuc2l0aW9uZWQgdG8sIHRoZSBgJHN0YXRlUGFyYW1zYCBzZXJ2aWNlIHdpbGwgYmUgcG9wdWxhdGVkIHdpdGggYW55CiAgICAgKiAgIHBhcmFtZXRlcnMgdGhhdCB3ZXJlIHBhc3NlZC4KICAgICAqCiAgICAgKiA8YSBpZD0ncGFyYW1zJz48L2E+CiAgICAgKgogICAgICogLSAqKmBwYXJhbXNgKiogLSB7b2JqZWN0PX0gLSBBbiBhcnJheSBvZiBwYXJhbWV0ZXIgbmFtZXMgb3IgcmVndWxhciBleHByZXNzaW9ucy4gT25seQogICAgICogICB1c2UgdGhpcyB3aXRoaW4gYSBzdGF0ZSBpZiB5b3UgYXJlIG5vdCB1c2luZyB1cmwuIE90aGVyd2lzZSB5b3UgY2FuIHNwZWNpZnkgeW91cgogICAgICogICBwYXJhbWV0ZXJzIHdpdGhpbiB0aGUgdXJsLiBXaGVuIGEgc3RhdGUgaXMgbmF2aWdhdGVkIG9yIHRyYW5zaXRpb25lZCB0bywgdGhlCiAgICAgKiAgICRzdGF0ZVBhcmFtcyBzZXJ2aWNlIHdpbGwgYmUgcG9wdWxhdGVkIHdpdGggYW55IHBhcmFtZXRlcnMgdGhhdCB3ZXJlIHBhc3NlZC4KICAgICAqCiAgICAgKiA8YSBpZD0ndmlld3MnPjwvYT4KICAgICAqCiAgICAgKiAtICoqYHZpZXdzYCoqIC0ge29iamVjdD19IC0gVXNlIHRoZSB2aWV3cyBwcm9wZXJ0eSB0byBzZXQgdXAgbXVsdGlwbGUgdmlld3Mgb3IgdG8gdGFyZ2V0IHZpZXdzCiAgICAgKiAgIG1hbnVhbGx5L2V4cGxpY2l0bHkuCiAgICAgKgogICAgICogPGEgaWQ9J2Fic3RyYWN0Jz48L2E+CiAgICAgKgogICAgICogLSAqKmBhYnN0cmFjdGAqKiAtIHtib29sZWFuPX0gLSBBbiBhYnN0cmFjdCBzdGF0ZSB3aWxsIG5ldmVyIGJlIGRpcmVjdGx5IGFjdGl2YXRlZCwKICAgICAqICAgYnV0IGNhbiBwcm92aWRlIGluaGVyaXRlZCBwcm9wZXJ0aWVzIHRvIGl0cyBjb21tb24gY2hpbGRyZW4gc3RhdGVzLgogICAgICoKICAgICAqIDxhIGlkPSdvbkVudGVyJz48L2E+CiAgICAgKgogICAgICogLSAqKmBvbkVudGVyYCoqIC0ge29iamVjdD19IC0gQ2FsbGJhY2sgZnVuY3Rpb24gZm9yIHdoZW4gYSBzdGF0ZSBpcyBlbnRlcmVkLiBHb29kIHdheQogICAgICogICB0byB0cmlnZ2VyIGFuIGFjdGlvbiBvciBkaXNwYXRjaCBhbiBldmVudCwgc3VjaCBhcyBvcGVuaW5nIGEgZGlhbG9nLgogICAgICoKICAgICAqIDxhIGlkPSdvbkV4aXQnPjwvYT4KICAgICAqCiAgICAgKiAtICoqYG9uRXhpdGAqKiAtIHtvYmplY3Q9fSAtIENhbGxiYWNrIGZ1bmN0aW9uIGZvciB3aGVuIGEgc3RhdGUgaXMgZXhpdGVkLiBHb29kIHdheSB0bwogICAgICogICB0cmlnZ2VyIGFuIGFjdGlvbiBvciBkaXNwYXRjaCBhbiBldmVudCwgc3VjaCBhcyBvcGVuaW5nIGEgZGlhbG9nLgogICAgICoKICAgICAqIDxhIGlkPSdyZWxvYWRPblNlYXJjaCc+PC9hPgogICAgICoKICAgICAqIC0gKipgcmVsb2FkT25TZWFyY2ggPSB0cnVlYCoqIC0ge2Jvb2xlYW49fSAtIElmIGBmYWxzZWAsIHdpbGwgbm90IHJldHJpZ2dlciB0aGUgc2FtZSBzdGF0ZQogICAgICogICBqdXN0IGJlY2F1c2UgYSBzZWFyY2gvcXVlcnkgcGFyYW1ldGVyIGhhcyBjaGFuZ2VkICh2aWEgJGxvY2F0aW9uLnNlYXJjaCgpIG9yICRsb2NhdGlvbi5oYXNoKCkpLgogICAgICogICBVc2VmdWwgZm9yIHdoZW4geW91J2QgbGlrZSB0byBtb2RpZnkgJGxvY2F0aW9uLnNlYXJjaCgpIHdpdGhvdXQgdHJpZ2dlcmluZyBhIHJlbG9hZC4KICAgICAqCiAgICAgKiA8YSBpZD0nZGF0YSc+PC9hPgogICAgICoKICAgICAqIC0gKipgZGF0YWAqKiAtIHtvYmplY3Q9fSAtIEFyYml0cmFyeSBkYXRhIG9iamVjdCwgdXNlZnVsIGZvciBjdXN0b20gY29uZmlndXJhdGlvbi4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogPHByZT4KICAgICAqIC8vIFNvbWUgc3RhdGUgbmFtZSBleGFtcGxlcwogICAgICoKICAgICAqIC8vIHN0YXRlTmFtZSBjYW4gYmUgYSBzaW5nbGUgdG9wLWxldmVsIG5hbWUgKG11c3QgYmUgdW5pcXVlKS4KICAgICAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCJob21lIiwge30pOwogICAgICoKICAgICAqIC8vIE9yIGl0IGNhbiBiZSBhIG5lc3RlZCBzdGF0ZSBuYW1lLiBUaGlzIHN0YXRlIGlzIGEgY2hpbGQgb2YgdGhlCiAgICAgKiAvLyBhYm92ZSAiaG9tZSIgc3RhdGUuCiAgICAgKiAkc3RhdGVQcm92aWRlci5zdGF0ZSgiaG9tZS5uZXdlc3QiLCB7fSk7CiAgICAgKgogICAgICogLy8gTmVzdCBzdGF0ZXMgYXMgZGVlcGx5IGFzIG5lZWRlZC4KICAgICAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCJob21lLm5ld2VzdC5hYmMueHl6LmluY2VwdGlvbiIsIHt9KTsKICAgICAqCiAgICAgKiAvLyBzdGF0ZSgpIHJldHVybnMgJHN0YXRlUHJvdmlkZXIsIHNvIHlvdSBjYW4gY2hhaW4gc3RhdGUgZGVjbGFyYXRpb25zLgogICAgICogJHN0YXRlUHJvdmlkZXIKICAgICAqICAgLnN0YXRlKCJob21lIiwge30pCiAgICAgKiAgIC5zdGF0ZSgiYWJvdXQiLCB7fSkKICAgICAqICAgLnN0YXRlKCJjb250YWN0cyIsIHt9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEEgdW5pcXVlIHN0YXRlIG5hbWUsIGUuZy4gImhvbWUiLCAiYWJvdXQiLCAiY29udGFjdHMiLgogICAgICogVG8gY3JlYXRlIGEgcGFyZW50L2NoaWxkIHN0YXRlIHVzZSBhIGRvdCwgZS5nLiAiYWJvdXQuc2FsZXMiLCAiaG9tZS5uZXdlc3QiLgogICAgICogQHBhcmFtIHtvYmplY3R9IGRlZmluaXRpb24gU3RhdGUgY29uZmlndXJhdGlvbiBvYmplY3QuCiAgICAgKi8KICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTsKICAgIGZ1bmN0aW9uIHN0YXRlKG5hbWUsIGRlZmluaXRpb24pIHsKICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovCiAgICAgIGlmIChpc09iamVjdChuYW1lKSkgZGVmaW5pdGlvbiA9IG5hbWU7CiAgICAgIGVsc2UgZGVmaW5pdGlvbi5uYW1lID0gbmFtZTsKICAgICAgcmVnaXN0ZXJTdGF0ZShkZWZpbml0aW9uKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgKgogICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAqIEByZXF1aXJlcyAkcQogICAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kdmlldwogICAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAgICogQHJlcXVpcmVzIHVpLnJvdXRlci51dGlsLiRyZXNvbHZlCiAgICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVBhcmFtcwogICAgICoKICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBwYXJhbXMgQSBwYXJhbSBvYmplY3QsIGUuZy4ge3NlY3Rpb25JZDogc2VjdGlvbi5pZCl9LCB0aGF0CiAgICAgKiB5b3UnZCBsaWtlIHRvIHRlc3QgYWdhaW5zdCB0aGUgY3VycmVudCBhY3RpdmUgc3RhdGUuCiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gY3VycmVudCBBIHJlZmVyZW5jZSB0byB0aGUgc3RhdGUncyBjb25maWcgb2JqZWN0LiBIb3dldmVyCiAgICAgKiB5b3UgcGFzc2VkIGl0IGluLiBVc2VmdWwgZm9yIGFjY2Vzc2luZyBjdXN0b20gZGF0YS4KICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSB0cmFuc2l0aW9uIEN1cnJlbnRseSBwZW5kaW5nIHRyYW5zaXRpb24uIEEgcHJvbWlzZSB0aGF0J2xsCiAgICAgKiByZXNvbHZlIG9yIHJlamVjdC4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIGAkc3RhdGVgIHNlcnZpY2UgaXMgcmVzcG9uc2libGUgZm9yIHJlcHJlc2VudGluZyBzdGF0ZXMgYXMgd2VsbCBhcyB0cmFuc2l0aW9uaW5nCiAgICAgKiBiZXR3ZWVuIHRoZW0uIEl0IGFsc28gcHJvdmlkZXMgaW50ZXJmYWNlcyB0byBhc2sgZm9yIGN1cnJlbnQgc3RhdGUgb3IgZXZlbiBzdGF0ZXMKICAgICAqIHlvdSdyZSBjb21pbmcgZnJvbS4KICAgICAqLwogICAgICAvLyAkdXJsUm91dGVyIGlzIGluamVjdGVkIGp1c3QgdG8gZW5zdXJlIGl0IGdldHMgaW5zdGFudGlhdGVkCiAgICB0aGlzLiRnZXQgPSAkZ2V0OwogICAgJGdldC4kaW5qZWN0ID0gWyckcm9vdFNjb3BlJywgJyRxJywgJyR2aWV3JywgJyRpbmplY3RvcicsICckcmVzb2x2ZScsICckc3RhdGVQYXJhbXMnLCAnJGxvY2F0aW9uJywgJyR1cmxSb3V0ZXInLCAnJGJyb3dzZXInXTsKICAgIGZ1bmN0aW9uICRnZXQoICAgJHJvb3RTY29wZSwgICAkcSwgICAkdmlldywgICAkaW5qZWN0b3IsICAgJHJlc29sdmUsICAgJHN0YXRlUGFyYW1zLCAgICRsb2NhdGlvbiwgICAkdXJsUm91dGVyLCAgICRicm93c2VyKSB7CgogICAgICB2YXIgVHJhbnNpdGlvblN1cGVyc2VkZWQgPSAkcS5yZWplY3QobmV3IEVycm9yKCd0cmFuc2l0aW9uIHN1cGVyc2VkZWQnKSk7CiAgICAgIHZhciBUcmFuc2l0aW9uUHJldmVudGVkID0gJHEucmVqZWN0KG5ldyBFcnJvcigndHJhbnNpdGlvbiBwcmV2ZW50ZWQnKSk7CiAgICAgIHZhciBUcmFuc2l0aW9uQWJvcnRlZCA9ICRxLnJlamVjdChuZXcgRXJyb3IoJ3RyYW5zaXRpb24gYWJvcnRlZCcpKTsKICAgICAgdmFyIFRyYW5zaXRpb25GYWlsZWQgPSAkcS5yZWplY3QobmV3IEVycm9yKCd0cmFuc2l0aW9uIGZhaWxlZCcpKTsKICAgICAgdmFyIGN1cnJlbnRMb2NhdGlvbiA9ICRsb2NhdGlvbi51cmwoKTsKICAgICAgdmFyIGJhc2VIcmVmID0gJGJyb3dzZXIuYmFzZUhyZWYoKTsKCiAgICAgIGZ1bmN0aW9uIHN5bmNVcmwoKSB7CiAgICAgICAgaWYgKCRsb2NhdGlvbi51cmwoKSAhPT0gY3VycmVudExvY2F0aW9uKSB7CiAgICAgICAgICAkbG9jYXRpb24udXJsKGN1cnJlbnRMb2NhdGlvbik7CiAgICAgICAgICAkbG9jYXRpb24ucmVwbGFjZSgpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcm9vdC5sb2NhbHMgPSB7IHJlc29sdmU6IG51bGwsIGdsb2JhbHM6IHsgJHN0YXRlUGFyYW1zOiB7fSB9IH07CiAgICAgICRzdGF0ZSA9IHsKICAgICAgICBwYXJhbXM6IHt9LAogICAgICAgIGN1cnJlbnQ6IHJvb3Quc2VsZiwKICAgICAgICAkY3VycmVudDogcm9vdCwKICAgICAgICB0cmFuc2l0aW9uOiBudWxsCiAgICAgIH07CgogICAgICAvKioKICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjcmVsb2FkCiAgICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBBIG1ldGhvZCB0aGF0IGZvcmNlIHJlbG9hZHMgdGhlIGN1cnJlbnQgc3RhdGUuIEFsbCByZXNvbHZlcyBhcmUgcmUtcmVzb2x2ZWQsIGV2ZW50cyBhcmUgbm90IHJlLWZpcmVkLAogICAgICAgKiBhbmQgY29udHJvbGxlcnMgcmVpbnN0YW50aWF0ZWQgKGJ1ZyB3aXRoIGNvbnRyb2xsZXJzIHJlaW5zdGFudGlhdGluZyByaWdodCBub3csIGZpeGluZyBzb29uKS4KICAgICAgICoKICAgICAgICogQGV4YW1wbGUKICAgICAgICogPHByZT4KICAgICAgICogdmFyIGFwcCBhbmd1bGFyLm1vZHVsZSgnYXBwJywgWyd1aS5yb3V0ZXInXSk7CiAgICAgICAqCiAgICAgICAqIGFwcC5jb250cm9sbGVyKCdjdHJsJywgZnVuY3Rpb24gKCRzY29wZSwgJHN0YXRlKSB7CiAgICAgKiAgICRzY29wZS5yZWxvYWQgPSBmdW5jdGlvbigpewogICAgICogICAgICRzdGF0ZS5yZWxvYWQoKTsKICAgICAqICAgfQogICAgICogfSk7CiAgICAgICAqIDwvcHJlPgogICAgICAgKgogICAgICAgKiBgcmVsb2FkKClgIGlzIGp1c3QgYW4gYWxpYXMgZm9yOgogICAgICAgKiA8cHJlPgogICAgICAgKiAkc3RhdGUudHJhbnNpdGlvblRvKCRzdGF0ZS5jdXJyZW50LCAkc3RhdGVQYXJhbXMsIHsgCiAgICAgKiAgIHJlbG9hZDogdHJ1ZSwgaW5oZXJpdDogZmFsc2UsIG5vdGlmeTogZmFsc2UgCiAgICAgKiB9KTsKICAgICAgICogPC9wcmU+CiAgICAgICAqLwogICAgICAkc3RhdGUucmVsb2FkID0gZnVuY3Rpb24gcmVsb2FkKCkgewogICAgICAgICRzdGF0ZS50cmFuc2l0aW9uVG8oJHN0YXRlLmN1cnJlbnQsICRzdGF0ZVBhcmFtcywgeyByZWxvYWQ6IHRydWUsIGluaGVyaXQ6IGZhbHNlLCBub3RpZnk6IGZhbHNlIH0pOwogICAgICB9OwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI2dvCiAgICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBDb252ZW5pZW5jZSBtZXRob2QgZm9yIHRyYW5zaXRpb25pbmcgdG8gYSBuZXcgc3RhdGUuIGAkc3RhdGUuZ29gIGNhbGxzCiAgICAgICAqIGAkc3RhdGUudHJhbnNpdGlvblRvYCBpbnRlcm5hbGx5IGJ1dCBhdXRvbWF0aWNhbGx5IHNldHMgb3B0aW9ucyB0bwogICAgICAgKiBgeyBsb2NhdGlvbjogdHJ1ZSwgaW5oZXJpdDogdHJ1ZSwgcmVsYXRpdmU6ICRzdGF0ZS4kY3VycmVudCwgbm90aWZ5OiB0cnVlIH1gLgogICAgICAgKiBUaGlzIGFsbG93cyB5b3UgdG8gZWFzaWx5IHVzZSBhbiBhYnNvbHV0ZSBvciByZWxhdGl2ZSB0byBwYXRoIGFuZCBzcGVjaWZ5CiAgICAgICAqIG9ubHkgdGhlIHBhcmFtZXRlcnMgeW91J2QgbGlrZSB0byB1cGRhdGUgKHdoaWxlIGxldHRpbmcgdW5zcGVjaWZpZWQgcGFyYW1ldGVycwogICAgICAgKiBpbmhlcml0IGZyb20gdGhlIGN1cnJlbnRseSBhY3RpdmUgYW5jZXN0b3Igc3RhdGVzKS4KICAgICAgICoKICAgICAgICogQGV4YW1wbGUKICAgICAgICogPHByZT4KICAgICAgICogdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdhcHAnLCBbJ3VpLnJvdXRlciddKTsKICAgICAgICoKICAgICAgICogYXBwLmNvbnRyb2xsZXIoJ2N0cmwnLCBmdW5jdGlvbiAoJHNjb3BlLCAkc3RhdGUpIHsKICAgICAqICAgJHNjb3BlLmNoYW5nZVN0YXRlID0gZnVuY3Rpb24gKCkgewogICAgICogICAgICRzdGF0ZS5nbygnY29udGFjdC5kZXRhaWwnKTsKICAgICAqICAgfTsKICAgICAqIH0pOwogICAgICAgKiA8L3ByZT4KICAgICAgICogPGltZyBzcmM9Jy4uL25nZG9jX2Fzc2V0cy9TdGF0ZUdvRXhhbXBsZXMucG5nJy8+CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0byBBYnNvbHV0ZSBzdGF0ZSBuYW1lIG9yIHJlbGF0aXZlIHN0YXRlIHBhdGguIFNvbWUgZXhhbXBsZXM6CiAgICAgICAqCiAgICAgICAqIC0gYCRzdGF0ZS5nbygnY29udGFjdC5kZXRhaWwnKWAgLSB3aWxsIGdvIHRvIHRoZSBgY29udGFjdC5kZXRhaWxgIHN0YXRlCiAgICAgICAqIC0gYCRzdGF0ZS5nbygnXicpYCAtIHdpbGwgZ28gdG8gYSBwYXJlbnQgc3RhdGUKICAgICAgICogLSBgJHN0YXRlLmdvKCdeLnNpYmxpbmcnKWAgLSB3aWxsIGdvIHRvIGEgc2libGluZyBzdGF0ZQogICAgICAgKiAtIGAkc3RhdGUuZ28oJy5jaGlsZC5ncmFuZGNoaWxkJylgIC0gd2lsbCBnbyB0byBncmFuZGNoaWxkIHN0YXRlCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gcGFyYW1zIEEgbWFwIG9mIHRoZSBwYXJhbWV0ZXJzIHRoYXQgd2lsbCBiZSBzZW50IHRvIHRoZSBzdGF0ZSwKICAgICAgICogd2lsbCBwb3B1bGF0ZSAkc3RhdGVQYXJhbXMuIEFueSBwYXJhbWV0ZXJzIHRoYXQgYXJlIG5vdCBzcGVjaWZpZWQgd2lsbCBiZSBpbmhlcml0ZWQgZnJvbSBjdXJyZW50bHkKICAgICAgICogZGVmaW5lZCBwYXJhbWV0ZXJzLiBUaGlzIGFsbG93cywgZm9yIGV4YW1wbGUsIGdvaW5nIHRvIGEgc2libGluZyBzdGF0ZSB0aGF0IHNoYXJlcyBwYXJhbWV0ZXJzCiAgICAgICAqIHNwZWNpZmllZCBpbiBhIHBhcmVudCBzdGF0ZS4gUGFyYW1ldGVyIGluaGVyaXRhbmNlIG9ubHkgd29ya3MgYmV0d2VlbiBjb21tb24gYW5jZXN0b3Igc3RhdGVzLCBJLmUuCiAgICAgICAqIHRyYW5zaXRpb25pbmcgdG8gYSBzaWJsaW5nIHdpbGwgZ2V0IHlvdSB0aGUgcGFyYW1ldGVycyBmb3IgYWxsIHBhcmVudHMsIHRyYW5zaXRpb25pbmcgdG8gYSBjaGlsZAogICAgICAgKiB3aWxsIGdldCB5b3UgYWxsIGN1cnJlbnQgcGFyYW1ldGVycywgZXRjLgogICAgICAgKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgT3B0aW9ucyBvYmplY3QuIFRoZSBvcHRpb25zIGFyZToKICAgICAgICoKICAgICAgICogLSAqKmBsb2NhdGlvbmAqKiAtIHtib29sZWFuPXRydWV8c3RyaW5nPX0gLSBJZiBgdHJ1ZWAgd2lsbCB1cGRhdGUgdGhlIHVybCBpbiB0aGUgbG9jYXRpb24gYmFyLCBpZiBgZmFsc2VgCiAgICAgICAqICAgIHdpbGwgbm90LiBJZiBzdHJpbmcsIG11c3QgYmUgYCJyZXBsYWNlImAsIHdoaWNoIHdpbGwgdXBkYXRlIHVybCBhbmQgYWxzbyByZXBsYWNlIGxhc3QgaGlzdG9yeSByZWNvcmQuCiAgICAgICAqIC0gKipgaW5oZXJpdGAqKiAtIHtib29sZWFuPXRydWV9LCBJZiBgdHJ1ZWAgd2lsbCBpbmhlcml0IHVybCBwYXJhbWV0ZXJzIGZyb20gY3VycmVudCB1cmwuCiAgICAgICAqIC0gKipgcmVsYXRpdmVgKiogLSB7b2JqZWN0PSRzdGF0ZS4kY3VycmVudH0sIFdoZW4gdHJhbnNpdGlvbmluZyB3aXRoIHJlbGF0aXZlIHBhdGggKGUuZyAnXicpLAogICAgICAgKiAgICBkZWZpbmVzIHdoaWNoIHN0YXRlIHRvIGJlIHJlbGF0aXZlIGZyb20uCiAgICAgICAqIC0gKipgbm90aWZ5YCoqIC0ge2Jvb2xlYW49dHJ1ZX0sIElmIGB0cnVlYCB3aWxsIGJyb2FkY2FzdCAkc3RhdGVDaGFuZ2VTdGFydCBhbmQgJHN0YXRlQ2hhbmdlU3VjY2VzcyBldmVudHMuCiAgICAgICAqIC0gKipgcmVsb2FkYCoqICh2MC4yLjUpIC0ge2Jvb2xlYW49ZmFsc2V9LCBJZiBgdHJ1ZWAgd2lsbCBmb3JjZSB0cmFuc2l0aW9uIGV2ZW4gaWYgdGhlIHN0YXRlIG9yIHBhcmFtcwogICAgICAgKiAgICBoYXZlIG5vdCBjaGFuZ2VkLCBha2EgYSByZWxvYWQgb2YgdGhlIHNhbWUgc3RhdGUuIEl0IGRpZmZlcnMgZnJvbSByZWxvYWRPblNlYXJjaCBiZWNhdXNlIHlvdSdkCiAgICAgICAqICAgIHVzZSB0aGlzIHdoZW4geW91IHdhbnQgdG8gZm9yY2UgYSByZWxvYWQgd2hlbiAqZXZlcnl0aGluZyogaXMgdGhlIHNhbWUsIGluY2x1ZGluZyBzZWFyY2ggcGFyYW1zLgogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHJlcHJlc2VudGluZyB0aGUgc3RhdGUgb2YgdGhlIG5ldyB0cmFuc2l0aW9uLgogICAgICAgKgogICAgICAgKiBQb3NzaWJsZSBzdWNjZXNzIHZhbHVlczoKICAgICAgICoKICAgICAgICogLSAkc3RhdGUuY3VycmVudAogICAgICAgKgogICAgICAgKiA8YnIvPlBvc3NpYmxlIHJlamVjdGlvbiB2YWx1ZXM6CiAgICAgICAqCiAgICAgICAqIC0gJ3RyYW5zaXRpb24gc3VwZXJzZWRlZCcgLSB3aGVuIGEgbmV3ZXIgdHJhbnNpdGlvbiBoYXMgYmVlbiBzdGFydGVkIGFmdGVyIHRoaXMgb25lCiAgICAgICAqIC0gJ3RyYW5zaXRpb24gcHJldmVudGVkJyAtIHdoZW4gYGV2ZW50LnByZXZlbnREZWZhdWx0KClgIGhhcyBiZWVuIGNhbGxlZCBpbiBhIGAkc3RhdGVDaGFuZ2VTdGFydGAgbGlzdGVuZXIKICAgICAgICogLSAndHJhbnNpdGlvbiBhYm9ydGVkJyAtIHdoZW4gYGV2ZW50LnByZXZlbnREZWZhdWx0KClgIGhhcyBiZWVuIGNhbGxlZCBpbiBhIGAkc3RhdGVOb3RGb3VuZGAgbGlzdGVuZXIgb3IKICAgICAgICogICB3aGVuIGEgYCRzdGF0ZU5vdEZvdW5kYCBgZXZlbnQucmV0cnlgIHByb21pc2UgZXJyb3JzLgogICAgICAgKiAtICd0cmFuc2l0aW9uIGZhaWxlZCcgLSB3aGVuIGEgc3RhdGUgaGFzIGJlZW4gdW5zdWNjZXNzZnVsbHkgZm91bmQgYWZ0ZXIgMiB0cmllcy4KICAgICAgICogLSAqcmVzb2x2ZSBlcnJvciogLSB3aGVuIGFuIGVycm9yIGhhcyBvY2N1cnJlZCB3aXRoIGEgYHJlc29sdmVgCiAgICAgICAqCiAgICAgICAqLwogICAgICAkc3RhdGUuZ28gPSBmdW5jdGlvbiBnbyh0bywgcGFyYW1zLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNpdGlvblRvKHRvLCBwYXJhbXMsIGV4dGVuZCh7IGluaGVyaXQ6IHRydWUsIHJlbGF0aXZlOiAkc3RhdGUuJGN1cnJlbnQgfSwgb3B0aW9ucykpOwogICAgICB9OwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI3RyYW5zaXRpb25UbwogICAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogTG93LWxldmVsIG1ldGhvZCBmb3IgdHJhbnNpdGlvbmluZyB0byBhIG5ldyBzdGF0ZS4ge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjbWV0aG9kc19nbyAkc3RhdGUuZ299CiAgICAgICAqIHVzZXMgYHRyYW5zaXRpb25Ub2AgaW50ZXJuYWxseS4gYCRzdGF0ZS5nb2AgaXMgcmVjb21tZW5kZWQgaW4gbW9zdCBzaXR1YXRpb25zLgogICAgICAgKgogICAgICAgKiBAZXhhbXBsZQogICAgICAgKiA8cHJlPgogICAgICAgKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsndWkucm91dGVyJ10pOwogICAgICAgKgogICAgICAgKiBhcHAuY29udHJvbGxlcignY3RybCcsIGZ1bmN0aW9uICgkc2NvcGUsICRzdGF0ZSkgewogICAgICogICAkc2NvcGUuY2hhbmdlU3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgKiAgICAgJHN0YXRlLnRyYW5zaXRpb25UbygnY29udGFjdC5kZXRhaWwnKTsKICAgICAqICAgfTsKICAgICAqIH0pOwogICAgICAgKiA8L3ByZT4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRvIFN0YXRlIG5hbWUuCiAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gdG9QYXJhbXMgQSBtYXAgb2YgdGhlIHBhcmFtZXRlcnMgdGhhdCB3aWxsIGJlIHNlbnQgdG8gdGhlIHN0YXRlLAogICAgICAgKiB3aWxsIHBvcHVsYXRlICRzdGF0ZVBhcmFtcy4KICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIE9wdGlvbnMgb2JqZWN0LiBUaGUgb3B0aW9ucyBhcmU6CiAgICAgICAqCiAgICAgICAqIC0gKipgbG9jYXRpb25gKiogLSB7Ym9vbGVhbj10cnVlfHN0cmluZz19IC0gSWYgYHRydWVgIHdpbGwgdXBkYXRlIHRoZSB1cmwgaW4gdGhlIGxvY2F0aW9uIGJhciwgaWYgYGZhbHNlYAogICAgICAgKiAgICB3aWxsIG5vdC4gSWYgc3RyaW5nLCBtdXN0IGJlIGAicmVwbGFjZSJgLCB3aGljaCB3aWxsIHVwZGF0ZSB1cmwgYW5kIGFsc28gcmVwbGFjZSBsYXN0IGhpc3RvcnkgcmVjb3JkLgogICAgICAgKiAtICoqYGluaGVyaXRgKiogLSB7Ym9vbGVhbj1mYWxzZX0sIElmIGB0cnVlYCB3aWxsIGluaGVyaXQgdXJsIHBhcmFtZXRlcnMgZnJvbSBjdXJyZW50IHVybC4KICAgICAgICogLSAqKmByZWxhdGl2ZWAqKiAtIHtvYmplY3Q9fSwgV2hlbiB0cmFuc2l0aW9uaW5nIHdpdGggcmVsYXRpdmUgcGF0aCAoZS5nICdeJyksCiAgICAgICAqICAgIGRlZmluZXMgd2hpY2ggc3RhdGUgdG8gYmUgcmVsYXRpdmUgZnJvbS4KICAgICAgICogLSAqKmBub3RpZnlgKiogLSB7Ym9vbGVhbj10cnVlfSwgSWYgYHRydWVgIHdpbGwgYnJvYWRjYXN0ICRzdGF0ZUNoYW5nZVN0YXJ0IGFuZCAkc3RhdGVDaGFuZ2VTdWNjZXNzIGV2ZW50cy4KICAgICAgICogLSAqKmByZWxvYWRgKiogKHYwLjIuNSkgLSB7Ym9vbGVhbj1mYWxzZX0sIElmIGB0cnVlYCB3aWxsIGZvcmNlIHRyYW5zaXRpb24gZXZlbiBpZiB0aGUgc3RhdGUgb3IgcGFyYW1zCiAgICAgICAqICAgIGhhdmUgbm90IGNoYW5nZWQsIGFrYSBhIHJlbG9hZCBvZiB0aGUgc2FtZSBzdGF0ZS4gSXQgZGlmZmVycyBmcm9tIHJlbG9hZE9uU2VhcmNoIGJlY2F1c2UgeW91J2QKICAgICAgICogICAgdXNlIHRoaXMgd2hlbiB5b3Ugd2FudCB0byBmb3JjZSBhIHJlbG9hZCB3aGVuICpldmVyeXRoaW5nKiBpcyB0aGUgc2FtZSwgaW5jbHVkaW5nIHNlYXJjaCBwYXJhbXMuCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2UgcmVwcmVzZW50aW5nIHRoZSBzdGF0ZSBvZiB0aGUgbmV3IHRyYW5zaXRpb24uIFNlZQogICAgICAgKiB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNtZXRob2RzX2dvICRzdGF0ZS5nb30uCiAgICAgICAqLwogICAgICAkc3RhdGUudHJhbnNpdGlvblRvID0gZnVuY3Rpb24gdHJhbnNpdGlvblRvKHRvLCB0b1BhcmFtcywgb3B0aW9ucykgewogICAgICAgIHRvUGFyYW1zID0gdG9QYXJhbXMgfHwge307CiAgICAgICAgb3B0aW9ucyA9IGV4dGVuZCh7CiAgICAgICAgICBsb2NhdGlvbjogdHJ1ZSwgaW5oZXJpdDogZmFsc2UsIHJlbGF0aXZlOiBudWxsLCBub3RpZnk6IHRydWUsIHJlbG9hZDogZmFsc2UsICRyZXRyeTogZmFsc2UKICAgICAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICAgICAgdmFyIGZyb20gPSAkc3RhdGUuJGN1cnJlbnQsIGZyb21QYXJhbXMgPSAkc3RhdGUucGFyYW1zLCBmcm9tUGF0aCA9IGZyb20ucGF0aDsKICAgICAgICB2YXIgZXZ0LCB0b1N0YXRlID0gZmluZFN0YXRlKHRvLCBvcHRpb25zLnJlbGF0aXZlKTsKCiAgICAgICAgaWYgKCFpc0RlZmluZWQodG9TdGF0ZSkpIHsKICAgICAgICAgIC8vIEJyb2FkY2FzdCBub3QgZm91bmQgZXZlbnQgYW5kIGFib3J0IHRoZSB0cmFuc2l0aW9uIGlmIHByZXZlbnRlZAogICAgICAgICAgdmFyIHJlZGlyZWN0ID0geyB0bzogdG8sIHRvUGFyYW1zOiB0b1BhcmFtcywgb3B0aW9uczogb3B0aW9ucyB9OwoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlIyRzdGF0ZU5vdEZvdW5kCiAgICAgICAgICAgKiBAZXZlbnRPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIEZpcmVkIHdoZW4gYSByZXF1ZXN0ZWQgc3RhdGUgKipjYW5ub3QgYmUgZm91bmQqKiB1c2luZyB0aGUgcHJvdmlkZWQgc3RhdGUgbmFtZSBkdXJpbmcgdHJhbnNpdGlvbi4KICAgICAgICAgICAqIFRoZSBldmVudCBpcyBicm9hZGNhc3QgYWxsb3dpbmcgYW55IGhhbmRsZXJzIGEgc2luZ2xlIGNoYW5jZSB0byBkZWFsIHdpdGggdGhlIGVycm9yICh1c3VhbGx5IGJ5CiAgICAgICAgICAgKiBsYXp5LWxvYWRpbmcgdGhlIHVuZm91bmQgc3RhdGUpLiBBIHNwZWNpYWwgYHVuZm91bmRTdGF0ZWAgb2JqZWN0IGlzIHBhc3NlZCB0byB0aGUgbGlzdGVuZXIgaGFuZGxlciwKICAgICAgICAgICAqIHlvdSBjYW4gc2VlIGl0cyB0aHJlZSBwcm9wZXJ0aWVzIGluIHRoZSBleGFtcGxlLiBZb3UgY2FuIHVzZSBgZXZlbnQucHJldmVudERlZmF1bHQoKWAgdG8gYWJvcnQgdGhlCiAgICAgICAgICAgKiB0cmFuc2l0aW9uIGFuZCB0aGUgcHJvbWlzZSByZXR1cm5lZCBmcm9tIGBnb2Agd2lsbCBiZSByZWplY3RlZCB3aXRoIGEgYCd0cmFuc2l0aW9uIGFib3J0ZWQnYCB2YWx1ZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgRXZlbnQgb2JqZWN0LgogICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHVuZm91bmRTdGF0ZSBVbmZvdW5kIFN0YXRlIGluZm9ybWF0aW9uLiBDb250YWluczogYHRvLCB0b1BhcmFtcywgb3B0aW9uc2AgcHJvcGVydGllcy4KICAgICAgICAgICAqIEBwYXJhbSB7U3RhdGV9IGZyb21TdGF0ZSBDdXJyZW50IHN0YXRlIG9iamVjdC4KICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBmcm9tUGFyYW1zIEN1cnJlbnQgc3RhdGUgcGFyYW1zLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgICAgKgogICAgICAgICAgICogPHByZT4KICAgICAgICAgICAqIC8vIHNvbWV3aGVyZSwgYXNzdW1lIGxhenkuc3RhdGUgaGFzIG5vdCBiZWVuIGRlZmluZWQKICAgICAgICAgICAqICRzdGF0ZS5nbygibGF6eS5zdGF0ZSIsIHthOjEsIGI6Mn0sIHtpbmhlcml0OmZhbHNlfSk7CiAgICAgICAgICAgKgogICAgICAgICAgICogLy8gc29tZXdoZXJlIGVsc2UKICAgICAgICAgICAqICRzY29wZS4kb24oJyRzdGF0ZU5vdEZvdW5kJywKICAgICAgICAgICAqIGZ1bmN0aW9uKGV2ZW50LCB1bmZvdW5kU3RhdGUsIGZyb21TdGF0ZSwgZnJvbVBhcmFtcyl7CiAgICAgICAgICogICAgIGNvbnNvbGUubG9nKHVuZm91bmRTdGF0ZS50byk7IC8vICJsYXp5LnN0YXRlIgogICAgICAgICAqICAgICBjb25zb2xlLmxvZyh1bmZvdW5kU3RhdGUudG9QYXJhbXMpOyAvLyB7YToxLCBiOjJ9CiAgICAgICAgICogICAgIGNvbnNvbGUubG9nKHVuZm91bmRTdGF0ZS5vcHRpb25zKTsgLy8ge2luaGVyaXQ6ZmFsc2V9ICsgZGVmYXVsdCBvcHRpb25zCiAgICAgICAgICogfSkKICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICovCiAgICAgICAgICBldnQgPSAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRzdGF0ZU5vdEZvdW5kJywgcmVkaXJlY3QsIGZyb20uc2VsZiwgZnJvbVBhcmFtcyk7CiAgICAgICAgICBpZiAoZXZ0LmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgc3luY1VybCgpOwogICAgICAgICAgICByZXR1cm4gVHJhbnNpdGlvbkFib3J0ZWQ7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQWxsb3cgdGhlIGhhbmRsZXIgdG8gcmV0dXJuIGEgcHJvbWlzZSB0byBkZWZlciBzdGF0ZSBsb29rdXAgcmV0cnkKICAgICAgICAgIGlmIChldnQucmV0cnkpIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMuJHJldHJ5KSB7CiAgICAgICAgICAgICAgc3luY1VybCgpOwogICAgICAgICAgICAgIHJldHVybiBUcmFuc2l0aW9uRmFpbGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXRyeVRyYW5zaXRpb24gPSAkc3RhdGUudHJhbnNpdGlvbiA9ICRxLndoZW4oZXZ0LnJldHJ5KTsKICAgICAgICAgICAgcmV0cnlUcmFuc2l0aW9uLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHJldHJ5VHJhbnNpdGlvbiAhPT0gJHN0YXRlLnRyYW5zaXRpb24pIHJldHVybiBUcmFuc2l0aW9uU3VwZXJzZWRlZDsKICAgICAgICAgICAgICByZWRpcmVjdC5vcHRpb25zLiRyZXRyeSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuICRzdGF0ZS50cmFuc2l0aW9uVG8ocmVkaXJlY3QudG8sIHJlZGlyZWN0LnRvUGFyYW1zLCByZWRpcmVjdC5vcHRpb25zKTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFRyYW5zaXRpb25BYm9ydGVkOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc3luY1VybCgpOwogICAgICAgICAgICByZXR1cm4gcmV0cnlUcmFuc2l0aW9uOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEFsd2F5cyByZXRyeSBvbmNlIGlmIHRoZSAkc3RhdGVOb3RGb3VuZCB3YXMgbm90IHByZXZlbnRlZAogICAgICAgICAgLy8gKGhhbmRsZXMgZWl0aGVyIHJlZGlyZWN0IGNoYW5nZWQgb3Igc3RhdGUgbGF6eS1kZWZpbml0aW9uKQogICAgICAgICAgdG8gPSByZWRpcmVjdC50bzsKICAgICAgICAgIHRvUGFyYW1zID0gcmVkaXJlY3QudG9QYXJhbXM7CiAgICAgICAgICBvcHRpb25zID0gcmVkaXJlY3Qub3B0aW9uczsKICAgICAgICAgIHRvU3RhdGUgPSBmaW5kU3RhdGUodG8sIG9wdGlvbnMucmVsYXRpdmUpOwogICAgICAgICAgaWYgKCFpc0RlZmluZWQodG9TdGF0ZSkpIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucmVsYXRpdmUpIHRocm93IG5ldyBFcnJvcigiQ291bGQgbm90IHJlc29sdmUgJyIgKyB0byArICInIGZyb20gc3RhdGUgJyIgKyBvcHRpb25zLnJlbGF0aXZlICsgIiciKTsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyBzdWNoIHN0YXRlICciICsgdG8gKyAiJyIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodG9TdGF0ZVthYnN0cmFjdEtleV0pIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHRyYW5zaXRpb24gdG8gYWJzdHJhY3Qgc3RhdGUgJyIgKyB0byArICInIik7CiAgICAgICAgaWYgKG9wdGlvbnMuaW5oZXJpdCkgdG9QYXJhbXMgPSBpbmhlcml0UGFyYW1zKCRzdGF0ZVBhcmFtcywgdG9QYXJhbXMgfHwge30sICRzdGF0ZS4kY3VycmVudCwgdG9TdGF0ZSk7CiAgICAgICAgdG8gPSB0b1N0YXRlOwoKICAgICAgICB2YXIgdG9QYXRoID0gdG8ucGF0aDsKCiAgICAgICAgLy8gU3RhcnRpbmcgZnJvbSB0aGUgcm9vdCBvZiB0aGUgcGF0aCwga2VlcCBhbGwgbGV2ZWxzIHRoYXQgaGF2ZW4ndCBjaGFuZ2VkCiAgICAgICAgdmFyIGtlZXAsIHN0YXRlLCBsb2NhbHMgPSByb290LmxvY2FscywgdG9Mb2NhbHMgPSBbXTsKICAgICAgICBmb3IgKGtlZXAgPSAwLCBzdGF0ZSA9IHRvUGF0aFtrZWVwXTsKICAgICAgICAgICAgIHN0YXRlICYmIHN0YXRlID09PSBmcm9tUGF0aFtrZWVwXSAmJiBlcXVhbEZvcktleXModG9QYXJhbXMsIGZyb21QYXJhbXMsIHN0YXRlLm93blBhcmFtcykgJiYgIW9wdGlvbnMucmVsb2FkOwogICAgICAgICAgICAga2VlcCsrLCBzdGF0ZSA9IHRvUGF0aFtrZWVwXSkgewogICAgICAgICAgbG9jYWxzID0gdG9Mb2NhbHNba2VlcF0gPSBzdGF0ZS5sb2NhbHM7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB3ZSdyZSBnb2luZyB0byB0aGUgc2FtZSBzdGF0ZSBhbmQgYWxsIGxvY2FscyBhcmUga2VwdCwgd2UndmUgZ290IG5vdGhpbmcgdG8gZG8uCiAgICAgICAgLy8gQnV0IGNsZWFyICd0cmFuc2l0aW9uJywgYXMgd2Ugc3RpbGwgd2FudCB0byBjYW5jZWwgYW55IG90aGVyIHBlbmRpbmcgdHJhbnNpdGlvbnMuCiAgICAgICAgLy8gVE9ETzogV2UgbWF5IG5vdCB3YW50IHRvIGJ1bXAgJ3RyYW5zaXRpb24nIGlmIHdlJ3JlIGNhbGxlZCBmcm9tIGEgbG9jYXRpb24gY2hhbmdlIHRoYXQgd2UndmUgaW5pdGlhdGVkIG91cnNlbHZlcywKICAgICAgICAvLyBiZWNhdXNlIHdlIG1pZ2h0IGFjY2lkZW50YWxseSBhYm9ydCBhIGxlZ2l0aW1hdGUgdHJhbnNpdGlvbiBpbml0aWF0ZWQgZnJvbSBjb2RlPwogICAgICAgIGlmIChzaG91bGRUcmlnZ2VyUmVsb2FkKHRvLCBmcm9tLCBsb2NhbHMsIG9wdGlvbnMpICkgewogICAgICAgICAgaWYgKCB0by5zZWxmLnJlbG9hZE9uU2VhcmNoICE9PSBmYWxzZSApCiAgICAgICAgICAgIHN5bmNVcmwoKTsKICAgICAgICAgICRzdGF0ZS50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgIHJldHVybiAkcS53aGVuKCRzdGF0ZS5jdXJyZW50KTsKICAgICAgICB9CgogICAgICAgIC8vIE5vcm1hbGl6ZS9maWx0ZXIgcGFyYW1ldGVycyBiZWZvcmUgd2UgcGFzcyB0aGVtIHRvIGV2ZW50IGhhbmRsZXJzIGV0Yy4KICAgICAgICB0b1BhcmFtcyA9IG5vcm1hbGl6ZSh0by5wYXJhbXMsIHRvUGFyYW1zIHx8IHt9KTsKCiAgICAgICAgLy8gQnJvYWRjYXN0IHN0YXJ0IGV2ZW50IGFuZCBjYW5jZWwgdGhlIHRyYW5zaXRpb24gaWYgcmVxdWVzdGVkCiAgICAgICAgaWYgKG9wdGlvbnMubm90aWZ5KSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSMkc3RhdGVDaGFuZ2VTdGFydAogICAgICAgICAgICogQGV2ZW50T2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICAgICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBGaXJlZCB3aGVuIHRoZSBzdGF0ZSB0cmFuc2l0aW9uICoqYmVnaW5zKiouIFlvdSBjYW4gdXNlIGBldmVudC5wcmV2ZW50RGVmYXVsdCgpYAogICAgICAgICAgICogdG8gcHJldmVudCB0aGUgdHJhbnNpdGlvbiBmcm9tIGhhcHBlbmluZyBhbmQgdGhlbiB0aGUgdHJhbnNpdGlvbiBwcm9taXNlIHdpbGwgYmUKICAgICAgICAgICAqIHJlamVjdGVkIHdpdGggYSBgJ3RyYW5zaXRpb24gcHJldmVudGVkJ2AgdmFsdWUuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IEV2ZW50IG9iamVjdC4KICAgICAgICAgICAqIEBwYXJhbSB7U3RhdGV9IHRvU3RhdGUgVGhlIHN0YXRlIGJlaW5nIHRyYW5zaXRpb25lZCB0by4KICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0b1BhcmFtcyBUaGUgcGFyYW1zIHN1cHBsaWVkIHRvIHRoZSBgdG9TdGF0ZWAuCiAgICAgICAgICAgKiBAcGFyYW0ge1N0YXRlfSBmcm9tU3RhdGUgVGhlIGN1cnJlbnQgc3RhdGUsIHByZS10cmFuc2l0aW9uLgogICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGZyb21QYXJhbXMgVGhlIHBhcmFtcyBzdXBwbGllZCB0byB0aGUgYGZyb21TdGF0ZWAuCiAgICAgICAgICAgKgogICAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAqCiAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICogJHJvb3RTY29wZS4kb24oJyRzdGF0ZUNoYW5nZVN0YXJ0JywKICAgICAgICAgICAqIGZ1bmN0aW9uKGV2ZW50LCB0b1N0YXRlLCB0b1BhcmFtcywgZnJvbVN0YXRlLCBmcm9tUGFyYW1zKXsKICAgICAgICAgKiAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgKiAgICAgLy8gdHJhbnNpdGlvblRvKCkgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIHdpdGgKICAgICAgICAgKiAgICAgLy8gYSAndHJhbnNpdGlvbiBwcmV2ZW50ZWQnIGVycm9yCiAgICAgICAgICogfSkKICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICovCiAgICAgICAgICBldnQgPSAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRzdGF0ZUNoYW5nZVN0YXJ0JywgdG8uc2VsZiwgdG9QYXJhbXMsIGZyb20uc2VsZiwgZnJvbVBhcmFtcyk7CiAgICAgICAgICBpZiAoZXZ0LmRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgc3luY1VybCgpOwogICAgICAgICAgICByZXR1cm4gVHJhbnNpdGlvblByZXZlbnRlZDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFJlc29sdmUgbG9jYWxzIGZvciB0aGUgcmVtYWluaW5nIHN0YXRlcywgYnV0IGRvbid0IHVwZGF0ZSBhbnkgZ2xvYmFsIHN0YXRlIGp1c3QKICAgICAgICAvLyB5ZXQgLS0gaWYgYW55dGhpbmcgZmFpbHMgdG8gcmVzb2x2ZSB0aGUgY3VycmVudCBzdGF0ZSBuZWVkcyB0byByZW1haW4gdW50b3VjaGVkLgogICAgICAgIC8vIFdlIGFsc28gc2V0IHVwIGFuIGluaGVyaXRhbmNlIGNoYWluIGZvciB0aGUgbG9jYWxzIGhlcmUuIFRoaXMgYWxsb3dzIHRoZSB2aWV3IGRpcmVjdGl2ZQogICAgICAgIC8vIHRvIHF1aWNrbHkgbG9vayB1cCB0aGUgY29ycmVjdCBkZWZpbml0aW9uIGZvciBlYWNoIHZpZXcgaW4gdGhlIGN1cnJlbnQgc3RhdGUuIEV2ZW4KICAgICAgICAvLyB0aG91Z2ggd2UgY3JlYXRlIHRoZSBsb2NhbHMgb2JqZWN0IGl0c2VsZiBvdXRzaWRlIHJlc29sdmVTdGF0ZSgpLCBpdCBpcyBpbml0aWFsbHkKICAgICAgICAvLyBlbXB0eSBhbmQgZ2V0cyBmaWxsZWQgYXN5bmNocm9ub3VzbHkuIFdlIG5lZWQgdG8ga2VlcCB0cmFjayBvZiB0aGUgcHJvbWlzZSBmb3IgdGhlCiAgICAgICAgLy8gKGZ1bGx5IHJlc29sdmVkKSBjdXJyZW50IGxvY2FscywgYW5kIHBhc3MgdGhpcyBkb3duIHRoZSBjaGFpbi4KICAgICAgICB2YXIgcmVzb2x2ZWQgPSAkcS53aGVuKGxvY2Fscyk7CiAgICAgICAgZm9yICh2YXIgbD1rZWVwOyBsPHRvUGF0aC5sZW5ndGg7IGwrKywgc3RhdGU9dG9QYXRoW2xdKSB7CiAgICAgICAgICBsb2NhbHMgPSB0b0xvY2Fsc1tsXSA9IGluaGVyaXQobG9jYWxzKTsKICAgICAgICAgIHJlc29sdmVkID0gcmVzb2x2ZVN0YXRlKHN0YXRlLCB0b1BhcmFtcywgc3RhdGU9PT10bywgcmVzb2x2ZWQsIGxvY2Fscyk7CiAgICAgICAgfQoKICAgICAgICAvLyBPbmNlIGV2ZXJ5dGhpbmcgaXMgcmVzb2x2ZWQsIHdlIGFyZSByZWFkeSB0byBwZXJmb3JtIHRoZSBhY3R1YWwgdHJhbnNpdGlvbgogICAgICAgIC8vIGFuZCByZXR1cm4gYSBwcm9taXNlIGZvciB0aGUgbmV3IHN0YXRlLiBXZSBhbHNvIGtlZXAgdHJhY2sgb2Ygd2hhdCB0aGUKICAgICAgICAvLyBjdXJyZW50IHByb21pc2UgaXMsIHNvIHRoYXQgd2UgY2FuIGRldGVjdCBvdmVybGFwcGluZyB0cmFuc2l0aW9ucyBhbmQKICAgICAgICAvLyBrZWVwIG9ubHkgdGhlIG91dGNvbWUgb2YgdGhlIGxhc3QgdHJhbnNpdGlvbi4KICAgICAgICB2YXIgdHJhbnNpdGlvbiA9ICRzdGF0ZS50cmFuc2l0aW9uID0gcmVzb2x2ZWQudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgbCwgZW50ZXJpbmcsIGV4aXRpbmc7CgogICAgICAgICAgaWYgKCRzdGF0ZS50cmFuc2l0aW9uICE9PSB0cmFuc2l0aW9uKSByZXR1cm4gVHJhbnNpdGlvblN1cGVyc2VkZWQ7CgogICAgICAgICAgLy8gRXhpdCAnZnJvbScgc3RhdGVzIG5vdCBrZXB0CiAgICAgICAgICBmb3IgKGw9ZnJvbVBhdGgubGVuZ3RoLTE7IGw+PWtlZXA7IGwtLSkgewogICAgICAgICAgICBleGl0aW5nID0gZnJvbVBhdGhbbF07CiAgICAgICAgICAgIGlmIChleGl0aW5nLnNlbGYub25FeGl0KSB7CiAgICAgICAgICAgICAgJGluamVjdG9yLmludm9rZShleGl0aW5nLnNlbGYub25FeGl0LCBleGl0aW5nLnNlbGYsIGV4aXRpbmcubG9jYWxzLmdsb2JhbHMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV4aXRpbmcubG9jYWxzID0gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBFbnRlciAndG8nIHN0YXRlcyBub3Qga2VwdAogICAgICAgICAgZm9yIChsPWtlZXA7IGw8dG9QYXRoLmxlbmd0aDsgbCsrKSB7CiAgICAgICAgICAgIGVudGVyaW5nID0gdG9QYXRoW2xdOwogICAgICAgICAgICBlbnRlcmluZy5sb2NhbHMgPSB0b0xvY2Fsc1tsXTsKICAgICAgICAgICAgaWYgKGVudGVyaW5nLnNlbGYub25FbnRlcikgewogICAgICAgICAgICAgICRpbmplY3Rvci5pbnZva2UoZW50ZXJpbmcuc2VsZi5vbkVudGVyLCBlbnRlcmluZy5zZWxmLCBlbnRlcmluZy5sb2NhbHMuZ2xvYmFscyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBSdW4gaXQgYWdhaW4sIHRvIGNhdGNoIGFueSB0cmFuc2l0aW9ucyBpbiBjYWxsYmFja3MKICAgICAgICAgIGlmICgkc3RhdGUudHJhbnNpdGlvbiAhPT0gdHJhbnNpdGlvbikgcmV0dXJuIFRyYW5zaXRpb25TdXBlcnNlZGVkOwoKICAgICAgICAgIC8vIFVwZGF0ZSBnbG9iYWxzIGluICRzdGF0ZQogICAgICAgICAgJHN0YXRlLiRjdXJyZW50ID0gdG87CiAgICAgICAgICAkc3RhdGUuY3VycmVudCA9IHRvLnNlbGY7CiAgICAgICAgICAkc3RhdGUucGFyYW1zID0gdG9QYXJhbXM7CiAgICAgICAgICBjb3B5KCRzdGF0ZS5wYXJhbXMsICRzdGF0ZVBhcmFtcyk7CiAgICAgICAgICAkc3RhdGUudHJhbnNpdGlvbiA9IG51bGw7CgogICAgICAgICAgLy8gVXBkYXRlICRsb2NhdGlvbgogICAgICAgICAgdmFyIHRvTmF2ID0gdG8ubmF2aWdhYmxlOwogICAgICAgICAgaWYgKG9wdGlvbnMubG9jYXRpb24gJiYgdG9OYXYpIHsKICAgICAgICAgICAgJGxvY2F0aW9uLnVybCh0b05hdi51cmwuZm9ybWF0KHRvTmF2LmxvY2Fscy5nbG9iYWxzLiRzdGF0ZVBhcmFtcykpOwoKICAgICAgICAgICAgaWYgKG9wdGlvbnMubG9jYXRpb24gPT09ICdyZXBsYWNlJykgewogICAgICAgICAgICAgICRsb2NhdGlvbi5yZXBsYWNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAob3B0aW9ucy5ub3RpZnkpIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlIyRzdGF0ZUNoYW5nZVN1Y2Nlc3MKICAgICAgICAgICAgICogQGV2ZW50T2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBGaXJlZCBvbmNlIHRoZSBzdGF0ZSB0cmFuc2l0aW9uIGlzICoqY29tcGxldGUqKi4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IEV2ZW50IG9iamVjdC4KICAgICAgICAgICAgICogQHBhcmFtIHtTdGF0ZX0gdG9TdGF0ZSBUaGUgc3RhdGUgYmVpbmcgdHJhbnNpdGlvbmVkIHRvLgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdG9QYXJhbXMgVGhlIHBhcmFtcyBzdXBwbGllZCB0byB0aGUgYHRvU3RhdGVgLgogICAgICAgICAgICAgKiBAcGFyYW0ge1N0YXRlfSBmcm9tU3RhdGUgVGhlIGN1cnJlbnQgc3RhdGUsIHByZS10cmFuc2l0aW9uLgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZnJvbVBhcmFtcyBUaGUgcGFyYW1zIHN1cHBsaWVkIHRvIHRoZSBgZnJvbVN0YXRlYC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHN0YXRlQ2hhbmdlU3VjY2VzcycsIHRvLnNlbGYsIHRvUGFyYW1zLCBmcm9tLnNlbGYsIGZyb21QYXJhbXMpOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudExvY2F0aW9uID0gJGxvY2F0aW9uLnVybCgpOwoKICAgICAgICAgIHJldHVybiAkc3RhdGUuY3VycmVudDsKICAgICAgICB9LCBmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgIGlmICgkc3RhdGUudHJhbnNpdGlvbiAhPT0gdHJhbnNpdGlvbikgcmV0dXJuIFRyYW5zaXRpb25TdXBlcnNlZGVkOwoKICAgICAgICAgICRzdGF0ZS50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlIyRzdGF0ZUNoYW5nZUVycm9yCiAgICAgICAgICAgKiBAZXZlbnRPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIEZpcmVkIHdoZW4gYW4gKiplcnJvciBvY2N1cnMqKiBkdXJpbmcgdHJhbnNpdGlvbi4gSXQncyBpbXBvcnRhbnQgdG8gbm90ZSB0aGF0IGlmIHlvdQogICAgICAgICAgICogaGF2ZSBhbnkgZXJyb3JzIGluIHlvdXIgcmVzb2x2ZSBmdW5jdGlvbnMgKGphdmFzY3JpcHQgZXJyb3JzLCBub24tZXhpc3RlbnQgc2VydmljZXMsIGV0YykKICAgICAgICAgICAqIHRoZXkgd2lsbCBub3QgdGhyb3cgdHJhZGl0aW9uYWxseS4gWW91IG11c3QgbGlzdGVuIGZvciB0aGlzICRzdGF0ZUNoYW5nZUVycm9yIGV2ZW50IHRvCiAgICAgICAgICAgKiBjYXRjaCAqKkFMTCoqIGVycm9ycy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgRXZlbnQgb2JqZWN0LgogICAgICAgICAgICogQHBhcmFtIHtTdGF0ZX0gdG9TdGF0ZSBUaGUgc3RhdGUgYmVpbmcgdHJhbnNpdGlvbmVkIHRvLgogICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRvUGFyYW1zIFRoZSBwYXJhbXMgc3VwcGxpZWQgdG8gdGhlIGB0b1N0YXRlYC4KICAgICAgICAgICAqIEBwYXJhbSB7U3RhdGV9IGZyb21TdGF0ZSBUaGUgY3VycmVudCBzdGF0ZSwgcHJlLXRyYW5zaXRpb24uCiAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZnJvbVBhcmFtcyBUaGUgcGFyYW1zIHN1cHBsaWVkIHRvIHRoZSBgZnJvbVN0YXRlYC4KICAgICAgICAgICAqIEBwYXJhbSB7RXJyb3J9IGVycm9yIFRoZSByZXNvbHZlIGVycm9yIG9iamVjdC4KICAgICAgICAgICAqLwogICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckc3RhdGVDaGFuZ2VFcnJvcicsIHRvLnNlbGYsIHRvUGFyYW1zLCBmcm9tLnNlbGYsIGZyb21QYXJhbXMsIGVycm9yKTsKICAgICAgICAgIHN5bmNVcmwoKTsKCiAgICAgICAgICByZXR1cm4gJHEucmVqZWN0KGVycm9yKTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHRyYW5zaXRpb247CiAgICAgIH07CgogICAgICAvKioKICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjaXMKICAgICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNpbWlsYXIgdG8ge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjbWV0aG9kc19pbmNsdWRlcyAkc3RhdGUuaW5jbHVkZXN9LAogICAgICAgKiBidXQgb25seSBjaGVja3MgZm9yIHRoZSBmdWxsIHN0YXRlIG5hbWUuIElmIHBhcmFtcyBpcyBzdXBwbGllZCB0aGVuIGl0IHdpbGwgYmUKICAgICAgICogdGVzdGVkIGZvciBzdHJpY3QgZXF1YWxpdHkgYWdhaW5zdCB0aGUgY3VycmVudCBhY3RpdmUgcGFyYW1zIG9iamVjdCwgc28gYWxsIHBhcmFtcwogICAgICAgKiBtdXN0IG1hdGNoIHdpdGggbm9uZSBtaXNzaW5nIGFuZCBubyBleHRyYXMuCiAgICAgICAqCiAgICAgICAqIEBleGFtcGxlCiAgICAgICAqIDxwcmU+CiAgICAgICAqICRzdGF0ZS5pcygnY29udGFjdC5kZXRhaWxzLml0ZW0nKTsgLy8gcmV0dXJucyB0cnVlCiAgICAgICAqICRzdGF0ZS5pcyhjb250YWN0RGV0YWlsSXRlbVN0YXRlT2JqZWN0KTsgLy8gcmV0dXJucyB0cnVlCiAgICAgICAqCiAgICAgICAqIC8vIGV2ZXJ5dGhpbmcgZWxzZSB3b3VsZCByZXR1cm4gZmFsc2UKICAgICAgICogPC9wcmU+CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gc3RhdGVOYW1lIFRoZSBzdGF0ZSBuYW1lIG9yIHN0YXRlIG9iamVjdCB5b3UnZCBsaWtlIHRvIGNoZWNrLgogICAgICAgKiBAcGFyYW0ge29iamVjdD19IHBhcmFtcyBBIHBhcmFtIG9iamVjdCwgZS5nLiBge3NlY3Rpb25JZDogc2VjdGlvbi5pZH1gLCB0aGF0IHlvdSdkIGxpa2UKICAgICAgICogdG8gdGVzdCBhZ2FpbnN0IHRoZSBjdXJyZW50IGFjdGl2ZSBzdGF0ZS4KICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBpdCBpcyB0aGUgc3RhdGUuCiAgICAgICAqLwogICAgICAkc3RhdGUuaXMgPSBmdW5jdGlvbiBpcyhzdGF0ZU9yTmFtZSwgcGFyYW1zKSB7CiAgICAgICAgdmFyIHN0YXRlID0gZmluZFN0YXRlKHN0YXRlT3JOYW1lKTsKCiAgICAgICAgaWYgKCFpc0RlZmluZWQoc3RhdGUpKSB7CiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0KCiAgICAgICAgaWYgKCRzdGF0ZS4kY3VycmVudCAhPT0gc3RhdGUpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBpc0RlZmluZWQocGFyYW1zKSAmJiBwYXJhbXMgIT09IG51bGwgPyBhbmd1bGFyLmVxdWFscygkc3RhdGVQYXJhbXMsIHBhcmFtcykgOiB0cnVlOwogICAgICB9OwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI2luY2x1ZGVzCiAgICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBBIG1ldGhvZCB0byBkZXRlcm1pbmUgaWYgdGhlIGN1cnJlbnQgYWN0aXZlIHN0YXRlIGlzIGVxdWFsIHRvIG9yIGlzIHRoZSBjaGlsZCBvZiB0aGUKICAgICAgICogc3RhdGUgc3RhdGVOYW1lLiBJZiBhbnkgcGFyYW1zIGFyZSBwYXNzZWQgdGhlbiB0aGV5IHdpbGwgYmUgdGVzdGVkIGZvciBhIG1hdGNoIGFzIHdlbGwuCiAgICAgICAqIE5vdCBhbGwgdGhlIHBhcmFtZXRlcnMgbmVlZCB0byBiZSBwYXNzZWQsIGp1c3QgdGhlIG9uZXMgeW91J2QgbGlrZSB0byB0ZXN0IGZvciBlcXVhbGl0eS4KICAgICAgICoKICAgICAgICogQGV4YW1wbGUKICAgICAgICogPHByZT4KICAgICAgICogJHN0YXRlLiRjdXJyZW50Lm5hbWUgPSAnY29udGFjdHMuZGV0YWlscy5pdGVtJzsKICAgICAgICoKICAgICAgICogJHN0YXRlLmluY2x1ZGVzKCJjb250YWN0cyIpOyAvLyByZXR1cm5zIHRydWUKICAgICAgICogJHN0YXRlLmluY2x1ZGVzKCJjb250YWN0cy5kZXRhaWxzIik7IC8vIHJldHVybnMgdHJ1ZQogICAgICAgKiAkc3RhdGUuaW5jbHVkZXMoImNvbnRhY3RzLmRldGFpbHMuaXRlbSIpOyAvLyByZXR1cm5zIHRydWUKICAgICAgICogJHN0YXRlLmluY2x1ZGVzKCJjb250YWN0cy5saXN0Iik7IC8vIHJldHVybnMgZmFsc2UKICAgICAgICogJHN0YXRlLmluY2x1ZGVzKCJhYm91dCIpOyAvLyByZXR1cm5zIGZhbHNlCiAgICAgICAqIDwvcHJlPgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogQmFzaWMgZ2xvYmluZyBwYXR0ZXJucyB3aWxsIGFsc28gd29yay4KICAgICAgICoKICAgICAgICogQGV4YW1wbGUKICAgICAgICogPHByZT4KICAgICAgICogJHN0YXRlLiRjdXJyZW50Lm5hbWUgPSAnY29udGFjdHMuZGV0YWlscy5pdGVtLnVybCc7CiAgICAgICAqCiAgICAgICAqICRzdGF0ZS5pbmNsdWRlcygiKi5kZXRhaWxzLiouKiIpOyAvLyByZXR1cm5zIHRydWUKICAgICAgICogJHN0YXRlLmluY2x1ZGVzKCIqLmRldGFpbHMuKioiKTsgLy8gcmV0dXJucyB0cnVlCiAgICAgICAqICRzdGF0ZS5pbmNsdWRlcygiKiouaXRlbS4qKiIpOyAvLyByZXR1cm5zIHRydWUKICAgICAgICogJHN0YXRlLmluY2x1ZGVzKCIqLmRldGFpbHMuaXRlbS51cmwiKTsgLy8gcmV0dXJucyB0cnVlCiAgICAgICAqICRzdGF0ZS5pbmNsdWRlcygiKi5kZXRhaWxzLioudXJsIik7IC8vIHJldHVybnMgdHJ1ZQogICAgICAgKiAkc3RhdGUuaW5jbHVkZXMoIiouZGV0YWlscy4qIik7IC8vIHJldHVybnMgZmFsc2UKICAgICAgICogJHN0YXRlLmluY2x1ZGVzKCJpdGVtLioqIik7IC8vIHJldHVybnMgZmFsc2UKICAgICAgICogPC9wcmU+CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdGF0ZU9yTmFtZSBBIHBhcnRpYWwgbmFtZSB0byBiZSBzZWFyY2hlZCBmb3Igd2l0aGluIHRoZSBjdXJyZW50IHN0YXRlIG5hbWUuCiAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJhbXMgQSBwYXJhbSBvYmplY3QsIGUuZy4gYHtzZWN0aW9uSWQ6IHNlY3Rpb24uaWR9YCwKICAgICAgICogdGhhdCB5b3UnZCBsaWtlIHRvIHRlc3QgYWdhaW5zdCB0aGUgY3VycmVudCBhY3RpdmUgc3RhdGUuCiAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgaXQgZG9lcyBpbmNsdWRlIHRoZSBzdGF0ZQogICAgICAgKi8KCiAgICAgICRzdGF0ZS5pbmNsdWRlcyA9IGZ1bmN0aW9uIGluY2x1ZGVzKHN0YXRlT3JOYW1lLCBwYXJhbXMpIHsKICAgICAgICBpZiAoaXNTdHJpbmcoc3RhdGVPck5hbWUpICYmIGlzR2xvYihzdGF0ZU9yTmFtZSkpIHsKICAgICAgICAgIGlmIChkb2VzU3RhdGVNYXRjaEdsb2Ioc3RhdGVPck5hbWUpKSB7CiAgICAgICAgICAgIHN0YXRlT3JOYW1lID0gJHN0YXRlLiRjdXJyZW50Lm5hbWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgc3RhdGUgPSBmaW5kU3RhdGUoc3RhdGVPck5hbWUpOwogICAgICAgIGlmICghaXNEZWZpbmVkKHN0YXRlKSkgewogICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB9CgogICAgICAgIGlmICghaXNEZWZpbmVkKCRzdGF0ZS4kY3VycmVudC5pbmNsdWRlc1tzdGF0ZS5uYW1lXSkpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHZhciB2YWxpZFBhcmFtcyA9IHRydWU7CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHBhcmFtcywgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgaWYgKCFpc0RlZmluZWQoJHN0YXRlUGFyYW1zW2tleV0pIHx8ICRzdGF0ZVBhcmFtc1trZXldICE9PSB2YWx1ZSkgewogICAgICAgICAgICB2YWxpZFBhcmFtcyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiB2YWxpZFBhcmFtczsKICAgICAgfTsKCgogICAgICAvKioKICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjaHJlZgogICAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogQSB1cmwgZ2VuZXJhdGlvbiBtZXRob2QgdGhhdCByZXR1cm5zIHRoZSBjb21waWxlZCB1cmwgZm9yIHRoZSBnaXZlbiBzdGF0ZSBwb3B1bGF0ZWQgd2l0aCB0aGUgZ2l2ZW4gcGFyYW1zLgogICAgICAgKgogICAgICAgKiBAZXhhbXBsZQogICAgICAgKiA8cHJlPgogICAgICAgKiBleHBlY3QoJHN0YXRlLmhyZWYoImFib3V0LnBlcnNvbiIsIHsgcGVyc29uOiAiYm9iIiB9KSkudG9FcXVhbCgiL2Fib3V0L2JvYiIpOwogICAgICAgKiA8L3ByZT4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSBzdGF0ZU9yTmFtZSBUaGUgc3RhdGUgbmFtZSBvciBzdGF0ZSBvYmplY3QgeW91J2QgbGlrZSB0byBnZW5lcmF0ZSBhIHVybCBmcm9tLgogICAgICAgKiBAcGFyYW0ge29iamVjdD19IHBhcmFtcyBBbiBvYmplY3Qgb2YgcGFyYW1ldGVyIHZhbHVlcyB0byBmaWxsIHRoZSBzdGF0ZSdzIHJlcXVpcmVkIHBhcmFtZXRlcnMuCiAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBPcHRpb25zIG9iamVjdC4gVGhlIG9wdGlvbnMgYXJlOgogICAgICAgKgogICAgICAgKiAtICoqYGxvc3N5YCoqIC0ge2Jvb2xlYW49dHJ1ZX0gLSAgSWYgdHJ1ZSwgYW5kIGlmIHRoZXJlIGlzIG5vIHVybCBhc3NvY2lhdGVkIHdpdGggdGhlIHN0YXRlIHByb3ZpZGVkIGluIHRoZQogICAgICAgKiAgICBmaXJzdCBwYXJhbWV0ZXIsIHRoZW4gdGhlIGNvbnN0cnVjdGVkIGhyZWYgdXJsIHdpbGwgYmUgYnVpbHQgZnJvbSB0aGUgZmlyc3QgbmF2aWdhYmxlIGFuY2VzdG9yIChha2EKICAgICAgICogICAgYW5jZXN0b3Igd2l0aCBhIHZhbGlkIHVybCkuCiAgICAgICAqIC0gKipgaW5oZXJpdGAqKiAtIHtib29sZWFuPWZhbHNlfSwgSWYgYHRydWVgIHdpbGwgaW5oZXJpdCB1cmwgcGFyYW1ldGVycyBmcm9tIGN1cnJlbnQgdXJsLgogICAgICAgKiAtICoqYHJlbGF0aXZlYCoqIC0ge29iamVjdD0kc3RhdGUuJGN1cnJlbnR9LCBXaGVuIHRyYW5zaXRpb25pbmcgd2l0aCByZWxhdGl2ZSBwYXRoIChlLmcgJ14nKSwKICAgICAgICogICAgZGVmaW5lcyB3aGljaCBzdGF0ZSB0byBiZSByZWxhdGl2ZSBmcm9tLgogICAgICAgKiAtICoqYGFic29sdXRlYCoqIC0ge2Jvb2xlYW49ZmFsc2V9LCAgSWYgdHJ1ZSB3aWxsIGdlbmVyYXRlIGFuIGFic29sdXRlIHVybCwgZS5nLiAiaHR0cDovL3d3dy5leGFtcGxlLmNvbS9mdWxsdXJsIi4KICAgICAgICoKICAgICAgICogQHJldHVybnMge3N0cmluZ30gY29tcGlsZWQgc3RhdGUgdXJsCiAgICAgICAqLwogICAgICAkc3RhdGUuaHJlZiA9IGZ1bmN0aW9uIGhyZWYoc3RhdGVPck5hbWUsIHBhcmFtcywgb3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSBleHRlbmQoeyBsb3NzeTogdHJ1ZSwgaW5oZXJpdDogZmFsc2UsIGFic29sdXRlOiBmYWxzZSwgcmVsYXRpdmU6ICRzdGF0ZS4kY3VycmVudCB9LCBvcHRpb25zIHx8IHt9KTsKICAgICAgICB2YXIgc3RhdGUgPSBmaW5kU3RhdGUoc3RhdGVPck5hbWUsIG9wdGlvbnMucmVsYXRpdmUpOwogICAgICAgIGlmICghaXNEZWZpbmVkKHN0YXRlKSkgcmV0dXJuIG51bGw7CgogICAgICAgIHBhcmFtcyA9IGluaGVyaXRQYXJhbXMoJHN0YXRlUGFyYW1zLCBwYXJhbXMgfHwge30sICRzdGF0ZS4kY3VycmVudCwgc3RhdGUpOwogICAgICAgIHZhciBuYXYgPSAoc3RhdGUgJiYgb3B0aW9ucy5sb3NzeSkgPyBzdGF0ZS5uYXZpZ2FibGUgOiBzdGF0ZTsKICAgICAgICB2YXIgdXJsID0gKG5hdiAmJiBuYXYudXJsKSA/IG5hdi51cmwuZm9ybWF0KG5vcm1hbGl6ZShzdGF0ZS5wYXJhbXMsIHBhcmFtcyB8fCB7fSkpIDogbnVsbDsKICAgICAgICBpZiAoISRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSgpICYmIHVybCkgewogICAgICAgICAgdXJsID0gIiMiICsgJGxvY2F0aW9uUHJvdmlkZXIuaGFzaFByZWZpeCgpICsgdXJsOwogICAgICAgIH0KCiAgICAgICAgaWYgKGJhc2VIcmVmICE9PSAnLycpIHsKICAgICAgICAgIGlmICgkbG9jYXRpb25Qcm92aWRlci5odG1sNU1vZGUoKSkgewogICAgICAgICAgICB1cmwgPSBiYXNlSHJlZi5zbGljZSgwLCAtMSkgKyB1cmw7CiAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuYWJzb2x1dGUpewogICAgICAgICAgICB1cmwgPSBiYXNlSHJlZi5zbGljZSgxKSArIHVybDsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChvcHRpb25zLmFic29sdXRlICYmIHVybCkgewogICAgICAgICAgdXJsID0gJGxvY2F0aW9uLnByb3RvY29sKCkgKyAnOi8vJyArCiAgICAgICAgICAgICRsb2NhdGlvbi5ob3N0KCkgKwogICAgICAgICAgICAoJGxvY2F0aW9uLnBvcnQoKSA9PSA4MCB8fCAkbG9jYXRpb24ucG9ydCgpID09IDQ0MyA/ICcnIDogJzonICsgJGxvY2F0aW9uLnBvcnQoKSkgKwogICAgICAgICAgICAoISRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSgpICYmIHVybCA/ICcvJyA6ICcnKSArCiAgICAgICAgICAgIHVybDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVybDsKICAgICAgfTsKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNnZXQKICAgICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFJldHVybnMgdGhlIHN0YXRlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IGZvciBhbnkgc3BlY2lmaWMgc3RhdGUgb3IgYWxsIHN0YXRlcy4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0PX0gc3RhdGVPck5hbWUgSWYgcHJvdmlkZWQsIHdpbGwgb25seSBnZXQgdGhlIGNvbmZpZyBmb3IKICAgICAgICogdGhlIHJlcXVlc3RlZCBzdGF0ZS4gSWYgbm90IHByb3ZpZGVkLCByZXR1cm5zIGFuIGFycmF5IG9mIEFMTCBzdGF0ZSBjb25maWdzLgogICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fGFycmF5fSBTdGF0ZSBjb25maWd1cmF0aW9uIG9iamVjdCBvciBhcnJheSBvZiBhbGwgb2JqZWN0cy4KICAgICAgICovCiAgICAgICRzdGF0ZS5nZXQgPSBmdW5jdGlvbiAoc3RhdGVPck5hbWUsIGNvbnRleHQpIHsKICAgICAgICBpZiAoIWlzRGVmaW5lZChzdGF0ZU9yTmFtZSkpIHsKICAgICAgICAgIHZhciBsaXN0ID0gW107CiAgICAgICAgICBmb3JFYWNoKHN0YXRlcywgZnVuY3Rpb24oc3RhdGUpIHsgbGlzdC5wdXNoKHN0YXRlLnNlbGYpOyB9KTsKICAgICAgICAgIHJldHVybiBsaXN0OwogICAgICAgIH0KICAgICAgICB2YXIgc3RhdGUgPSBmaW5kU3RhdGUoc3RhdGVPck5hbWUsIGNvbnRleHQpOwogICAgICAgIHJldHVybiAoc3RhdGUgJiYgc3RhdGUuc2VsZikgPyBzdGF0ZS5zZWxmIDogbnVsbDsKICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIHJlc29sdmVTdGF0ZShzdGF0ZSwgcGFyYW1zLCBwYXJhbXNBcmVGaWx0ZXJlZCwgaW5oZXJpdGVkLCBkc3QpIHsKICAgICAgICAvLyBNYWtlIGEgcmVzdHJpY3RlZCAkc3RhdGVQYXJhbXMgd2l0aCBvbmx5IHRoZSBwYXJhbWV0ZXJzIHRoYXQgYXBwbHkgdG8gdGhpcyBzdGF0ZSBpZgogICAgICAgIC8vIG5lY2Vzc2FyeS4gSW4gYWRkaXRpb24gdG8gYmVpbmcgYXZhaWxhYmxlIHRvIHRoZSBjb250cm9sbGVyIGFuZCBvbkVudGVyL29uRXhpdCBjYWxsYmFja3MsCiAgICAgICAgLy8gd2UgYWxzbyBuZWVkICRzdGF0ZVBhcmFtcyB0byBiZSBhdmFpbGFibGUgZm9yIGFueSAkaW5qZWN0b3IgY2FsbHMgd2UgbWFrZSBkdXJpbmcgdGhlCiAgICAgICAgLy8gZGVwZW5kZW5jeSByZXNvbHV0aW9uIHByb2Nlc3MuCiAgICAgICAgdmFyICRzdGF0ZVBhcmFtcyA9IChwYXJhbXNBcmVGaWx0ZXJlZCkgPyBwYXJhbXMgOiBmaWx0ZXJCeUtleXMoc3RhdGUucGFyYW1zLCBwYXJhbXMpOwogICAgICAgIHZhciBsb2NhbHMgPSB7ICRzdGF0ZVBhcmFtczogJHN0YXRlUGFyYW1zIH07CgogICAgICAgIC8vIFJlc29sdmUgJ2dsb2JhbCcgZGVwZW5kZW5jaWVzIGZvciB0aGUgc3RhdGUsIGkuZS4gdGhvc2Ugbm90IHNwZWNpZmljIHRvIGEgdmlldy4KICAgICAgICAvLyBXZSdyZSBhbHNvIGluY2x1ZGluZyAkc3RhdGVQYXJhbXMgaW4gdGhpczsgdGhhdCB3YXkgdGhlIHBhcmFtZXRlcnMgYXJlIHJlc3RyaWN0ZWQKICAgICAgICAvLyB0byB0aGUgc2V0IHRoYXQgc2hvdWxkIGJlIHZpc2libGUgdG8gdGhlIHN0YXRlLCBhbmQgYXJlIGluZGVwZW5kZW50IG9mIHdoZW4gd2UgdXBkYXRlCiAgICAgICAgLy8gdGhlIGdsb2JhbCAkc3RhdGUgYW5kICRzdGF0ZVBhcmFtcyB2YWx1ZXMuCiAgICAgICAgZHN0LnJlc29sdmUgPSAkcmVzb2x2ZS5yZXNvbHZlKHN0YXRlLnJlc29sdmUsIGxvY2FscywgZHN0LnJlc29sdmUsIHN0YXRlKTsKICAgICAgICB2YXIgcHJvbWlzZXMgPSBbIGRzdC5yZXNvbHZlLnRoZW4oZnVuY3Rpb24gKGdsb2JhbHMpIHsKICAgICAgICAgIGRzdC5nbG9iYWxzID0gZ2xvYmFsczsKICAgICAgICB9KSBdOwogICAgICAgIGlmIChpbmhlcml0ZWQpIHByb21pc2VzLnB1c2goaW5oZXJpdGVkKTsKCiAgICAgICAgLy8gUmVzb2x2ZSB0ZW1wbGF0ZSBhbmQgZGVwZW5kZW5jaWVzIGZvciBhbGwgdmlld3MuCiAgICAgICAgZm9yRWFjaChzdGF0ZS52aWV3cywgZnVuY3Rpb24gKHZpZXcsIG5hbWUpIHsKICAgICAgICAgIHZhciBpbmplY3RhYmxlcyA9ICh2aWV3LnJlc29sdmUgJiYgdmlldy5yZXNvbHZlICE9PSBzdGF0ZS5yZXNvbHZlID8gdmlldy5yZXNvbHZlIDoge30pOwogICAgICAgICAgaW5qZWN0YWJsZXMuJHRlbXBsYXRlID0gWyBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiAkdmlldy5sb2FkKG5hbWUsIHsgdmlldzogdmlldywgbG9jYWxzOiBsb2NhbHMsIHBhcmFtczogJHN0YXRlUGFyYW1zLCBub3RpZnk6IGZhbHNlIH0pIHx8ICcnOwogICAgICAgICAgfV07CgogICAgICAgICAgcHJvbWlzZXMucHVzaCgkcmVzb2x2ZS5yZXNvbHZlKGluamVjdGFibGVzLCBsb2NhbHMsIGRzdC5yZXNvbHZlLCBzdGF0ZSkudGhlbihmdW5jdGlvbiAocmVzdWx0KSB7CiAgICAgICAgICAgIC8vIFJlZmVyZW5jZXMgdG8gdGhlIGNvbnRyb2xsZXIgKG9ubHkgaW5zdGFudGlhdGVkIGF0IGxpbmsgdGltZSkKICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24odmlldy5jb250cm9sbGVyUHJvdmlkZXIpIHx8IGlzQXJyYXkodmlldy5jb250cm9sbGVyUHJvdmlkZXIpKSB7CiAgICAgICAgICAgICAgdmFyIGluamVjdExvY2FscyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBpbmplY3RhYmxlcywgbG9jYWxzKTsKICAgICAgICAgICAgICByZXN1bHQuJCRjb250cm9sbGVyID0gJGluamVjdG9yLmludm9rZSh2aWV3LmNvbnRyb2xsZXJQcm92aWRlciwgbnVsbCwgaW5qZWN0TG9jYWxzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXN1bHQuJCRjb250cm9sbGVyID0gdmlldy5jb250cm9sbGVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIFByb3ZpZGUgYWNjZXNzIHRvIHRoZSBzdGF0ZSBpdHNlbGYgZm9yIGludGVybmFsIHVzZQogICAgICAgICAgICByZXN1bHQuJCRzdGF0ZSA9IHN0YXRlOwogICAgICAgICAgICByZXN1bHQuJCRjb250cm9sbGVyQXMgPSB2aWV3LmNvbnRyb2xsZXJBczsKICAgICAgICAgICAgZHN0W25hbWVdID0gcmVzdWx0OwogICAgICAgICAgfSkpOwogICAgICAgIH0pOwoKICAgICAgICAvLyBXYWl0IGZvciBhbGwgdGhlIHByb21pc2VzIGFuZCB0aGVuIHJldHVybiB0aGUgYWN0aXZhdGlvbiBvYmplY3QKICAgICAgICByZXR1cm4gJHEuYWxsKHByb21pc2VzKS50aGVuKGZ1bmN0aW9uICh2YWx1ZXMpIHsKICAgICAgICAgIHJldHVybiBkc3Q7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiAkc3RhdGU7CiAgICB9CgogICAgZnVuY3Rpb24gc2hvdWxkVHJpZ2dlclJlbG9hZCh0bywgZnJvbSwgbG9jYWxzLCBvcHRpb25zKSB7CiAgICAgIGlmICggdG8gPT09IGZyb20gJiYgKChsb2NhbHMgPT09IGZyb20ubG9jYWxzICYmICFvcHRpb25zLnJlbG9hZCkgfHwgKHRvLnNlbGYucmVsb2FkT25TZWFyY2ggPT09IGZhbHNlKSkgKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICB9CgogIGFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIuc3RhdGUnKQogICAgLnZhbHVlKCckc3RhdGVQYXJhbXMnLCB7fSkKICAgIC5wcm92aWRlcignJHN0YXRlJywgJFN0YXRlUHJvdmlkZXIpOwoKCiAgJFZpZXdQcm92aWRlci4kaW5qZWN0ID0gW107CiAgZnVuY3Rpb24gJFZpZXdQcm92aWRlcigpIHsKCiAgICB0aGlzLiRnZXQgPSAkZ2V0OwogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHZpZXcKICAgICAqCiAgICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeQogICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKi8KICAgICRnZXQuJGluamVjdCA9IFsnJHJvb3RTY29wZScsICckdGVtcGxhdGVGYWN0b3J5J107CiAgICBmdW5jdGlvbiAkZ2V0KCAgICRyb290U2NvcGUsICAgJHRlbXBsYXRlRmFjdG9yeSkgewogICAgICByZXR1cm4gewogICAgICAgIC8vICR2aWV3LmxvYWQoJ2Z1bGwudmlld05hbWUnLCB7IHRlbXBsYXRlOiAuLi4sIGNvbnRyb2xsZXI6IC4uLiwgcmVzb2x2ZTogLi4uLCBhc3luYzogZmFsc2UsIHBhcmFtczogLi4uIH0pCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiR2aWV3I2xvYWQKICAgICAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiR2aWV3CiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIG5hbWUKICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBvcHRpb24gb2JqZWN0LgogICAgICAgICAqLwogICAgICAgIGxvYWQ6IGZ1bmN0aW9uIGxvYWQobmFtZSwgb3B0aW9ucykgewogICAgICAgICAgdmFyIHJlc3VsdCwgZGVmYXVsdHMgPSB7CiAgICAgICAgICAgIHRlbXBsYXRlOiBudWxsLCBjb250cm9sbGVyOiBudWxsLCB2aWV3OiBudWxsLCBsb2NhbHM6IG51bGwsIG5vdGlmeTogdHJ1ZSwgYXN5bmM6IHRydWUsIHBhcmFtczoge30KICAgICAgICAgIH07CiAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKGRlZmF1bHRzLCBvcHRpb25zKTsKCiAgICAgICAgICBpZiAob3B0aW9ucy52aWV3KSB7CiAgICAgICAgICAgIHJlc3VsdCA9ICR0ZW1wbGF0ZUZhY3RvcnkuZnJvbUNvbmZpZyhvcHRpb25zLnZpZXcsIG9wdGlvbnMucGFyYW1zLCBvcHRpb25zLmxvY2Fscyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmVzdWx0ICYmIG9wdGlvbnMubm90aWZ5KSB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSMkdmlld0NvbnRlbnRMb2FkaW5nCiAgICAgICAgICAgICAqIEBldmVudE9mIHVpLnJvdXRlci5zdGF0ZS4kdmlldwogICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBGaXJlZCBvbmNlIHRoZSB2aWV3ICoqYmVnaW5zIGxvYWRpbmcqKiwgKmJlZm9yZSogdGhlIERPTSBpcyByZW5kZXJlZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IEV2ZW50IG9iamVjdC4KICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHZpZXdDb25maWcgVGhlIHZpZXcgY29uZmlnIHByb3BlcnRpZXMgKHRlbXBsYXRlLCBjb250cm9sbGVyLCBldGMpLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICAgKiAkc2NvcGUuJG9uKCckdmlld0NvbnRlbnRMb2FkaW5nJywKICAgICAgICAgICAgICogZnVuY3Rpb24oZXZlbnQsIHZpZXdDb25maWcpewogICAgICAgICAqICAgICAvLyBBY2Nlc3MgdG8gYWxsIHRoZSB2aWV3IGNvbmZpZyBwcm9wZXJ0aWVzLgogICAgICAgICAqICAgICAvLyBhbmQgb25lIHNwZWNpYWwgcHJvcGVydHkgJ3RhcmdldFZpZXcnCiAgICAgICAgICogICAgIC8vIHZpZXdDb25maWcudGFyZ2V0VmlldwogICAgICAgICAqIH0pOwogICAgICAgICAgICAgKiA8L3ByZT4KICAgICAgICAgICAgICovCiAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHZpZXdDb250ZW50TG9hZGluZycsIG9wdGlvbnMpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfQoKICBhbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnN0YXRlJykucHJvdmlkZXIoJyR2aWV3JywgJFZpZXdQcm92aWRlcik7CgogIC8qKgogICAqIEBuZ2RvYyBvYmplY3QKICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHVpVmlld1Njcm9sbFByb3ZpZGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBQcm92aWRlciB0aGF0IHJldHVybnMgdGhlIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHVpVmlld1Njcm9sbH0gc2VydmljZSBmdW5jdGlvbi4KICAgKi8KICBmdW5jdGlvbiAkVmlld1Njcm9sbFByb3ZpZGVyKCkgewoKICAgIHZhciB1c2VBbmNob3JTY3JvbGwgPSBmYWxzZTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiR1aVZpZXdTY3JvbGxQcm92aWRlciN1c2VBbmNob3JTY3JvbGwKICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHVpVmlld1Njcm9sbFByb3ZpZGVyCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXZlcnRzIGJhY2sgdG8gdXNpbmcgdGhlIGNvcmUgW2AkYW5jaG9yU2Nyb2xsYF0oaHR0cDovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvbmcuJGFuY2hvclNjcm9sbCkgc2VydmljZSBmb3IKICAgICAqIHNjcm9sbGluZyBiYXNlZCBvbiB0aGUgdXJsIGFuY2hvci4KICAgICAqLwogICAgdGhpcy51c2VBbmNob3JTY3JvbGwgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHVzZUFuY2hvclNjcm9sbCA9IHRydWU7CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiR1aVZpZXdTY3JvbGwKICAgICAqCiAgICAgKiBAcmVxdWlyZXMgJGFuY2hvclNjcm9sbAogICAgICogQHJlcXVpcmVzICR0aW1lb3V0CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBXaGVuIGNhbGxlZCB3aXRoIGEganFMaXRlIGVsZW1lbnQsIGl0IHNjcm9sbHMgdGhlIGVsZW1lbnQgaW50byB2aWV3IChhZnRlciBhCiAgICAgKiBgJHRpbWVvdXRgIHNvIHRoZSBET00gaGFzIHRpbWUgdG8gcmVmcmVzaCkuCiAgICAgKgogICAgICogSWYgeW91IHByZWZlciB0byByZWx5IG9uIGAkYW5jaG9yU2Nyb2xsYCB0byBzY3JvbGwgdGhlIHZpZXcgdG8gdGhlIGFuY2hvciwKICAgICAqIHRoaXMgY2FuIGJlIGVuYWJsZWQgYnkgY2FsbGluZyB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiR1aVZpZXdTY3JvbGxQcm92aWRlciNtZXRob2RzX3VzZUFuY2hvclNjcm9sbCBgJHVpVmlld1Njcm9sbFByb3ZpZGVyLnVzZUFuY2hvclNjcm9sbCgpYH0uCiAgICAgKi8KICAgIHRoaXMuJGdldCA9IFsnJGFuY2hvclNjcm9sbCcsICckdGltZW91dCcsIGZ1bmN0aW9uICgkYW5jaG9yU2Nyb2xsLCAkdGltZW91dCkgewogICAgICBpZiAodXNlQW5jaG9yU2Nyb2xsKSB7CiAgICAgICAgcmV0dXJuICRhbmNob3JTY3JvbGw7CiAgICAgIH0KCiAgICAgIHJldHVybiBmdW5jdGlvbiAoJGVsZW1lbnQpIHsKICAgICAgICAkdGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAkZWxlbWVudFswXS5zY3JvbGxJbnRvVmlldygpOwogICAgICAgIH0sIDAsIGZhbHNlKTsKICAgICAgfTsKICAgIH1dOwogIH0KCiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5zdGF0ZScpLnByb3ZpZGVyKCckdWlWaWV3U2Nyb2xsJywgJFZpZXdTY3JvbGxQcm92aWRlcik7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuZGlyZWN0aXZlOnVpLXZpZXcKICAgKgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICogQHJlcXVpcmVzICRjb21waWxlCiAgICogQHJlcXVpcmVzICRjb250cm9sbGVyCiAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHVpVmlld1Njcm9sbAogICAqIEByZXF1aXJlcyAkZG9jdW1lbnQKICAgKgogICAqIEByZXN0cmljdCBFQ0EKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSB1aS12aWV3IGRpcmVjdGl2ZSB0ZWxscyAkc3RhdGUgd2hlcmUgdG8gcGxhY2UgeW91ciB0ZW1wbGF0ZXMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IHVpLXZpZXcgQSB2aWV3IG5hbWUuIFRoZSBuYW1lIHNob3VsZCBiZSB1bmlxdWUgYW1vbmdzdCB0aGUgb3RoZXIgdmlld3MgaW4gdGhlCiAgICogc2FtZSBzdGF0ZS4gWW91IGNhbiBoYXZlIHZpZXdzIG9mIHRoZSBzYW1lIG5hbWUgdGhhdCBsaXZlIGluIGRpZmZlcmVudCBzdGF0ZXMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IGF1dG9zY3JvbGwgSXQgYWxsb3dzIHlvdSB0byBzZXQgdGhlIHNjcm9sbCBiZWhhdmlvciBvZiB0aGUgYnJvd3NlciB3aW5kb3cKICAgKiB3aGVuIGEgdmlldyBpcyBwb3B1bGF0ZWQuIEJ5IGRlZmF1bHQsICRhbmNob3JTY3JvbGwgaXMgb3ZlcnJpZGRlbiBieSB1aS1yb3V0ZXIncyBjdXN0b20gc2Nyb2xsCiAgICogc2VydmljZSwge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kdWlWaWV3U2Nyb2xsfS4gVGhpcyBjdXN0b20gc2VydmljZSBsZXQncyB5b3UKICAgKiBzY3JvbGwgdWktdmlldyBlbGVtZW50cyBpbnRvIHZpZXcgd2hlbiB0aGV5IGFyZSBwb3B1bGF0ZWQgZHVyaW5nIGEgc3RhdGUgYWN0aXZhdGlvbi4KICAgKgogICAqICpOb3RlOiBUbyByZXZlcnQgYmFjayB0byBvbGQgW2AkYW5jaG9yU2Nyb2xsYF0oaHR0cDovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvbmcuJGFuY2hvclNjcm9sbCkKICAgKiBmdW5jdGlvbmFsaXR5LCBjYWxsIGAkdWlWaWV3U2Nyb2xsUHJvdmlkZXIudXNlQW5jaG9yU2Nyb2xsKClgLioKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gb25sb2FkIEV4cHJlc3Npb24gdG8gZXZhbHVhdGUgd2hlbmV2ZXIgdGhlIHZpZXcgdXBkYXRlcy4KICAgKgogICAqIEBleGFtcGxlCiAgICogQSB2aWV3IGNhbiBiZSB1bm5hbWVkIG9yIG5hbWVkLgogICAqIDxwcmU+CiAgICogPCEtLSBVbm5hbWVkIC0tPgogICAqIDxkaXYgdWktdmlldz48L2Rpdj4KICAgKgogICAqIDwhLS0gTmFtZWQgLS0+CiAgICogPGRpdiB1aS12aWV3PSJ2aWV3TmFtZSI+PC9kaXY+CiAgICogPC9wcmU+CiAgICoKICAgKiBZb3UgY2FuIG9ubHkgaGF2ZSBvbmUgdW5uYW1lZCB2aWV3IHdpdGhpbiBhbnkgdGVtcGxhdGUgKG9yIHJvb3QgaHRtbCkuIElmIHlvdSBhcmUgb25seSB1c2luZyBhCiAgICogc2luZ2xlIHZpZXcgYW5kIGl0IGlzIHVubmFtZWQgdGhlbiB5b3UgY2FuIHBvcHVsYXRlIGl0IGxpa2Ugc286CiAgICogPHByZT4KICAgKiA8ZGl2IHVpLXZpZXc+PC9kaXY+CiAgICogJHN0YXRlUHJvdmlkZXIuc3RhdGUoImhvbWUiLCB7CiAqICAgdGVtcGxhdGU6ICI8aDE+SEVMTE8hPC9oMT4iCiAqIH0pCiAgICogPC9wcmU+CiAgICoKICAgKiBUaGUgYWJvdmUgaXMgYSBjb252ZW5pZW50IHNob3J0Y3V0IGVxdWl2YWxlbnQgdG8gc3BlY2lmeWluZyB5b3VyIHZpZXcgZXhwbGljaXRseSB3aXRoIHRoZSB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVByb3ZpZGVyI3ZpZXdzIGB2aWV3c2B9CiAgICogY29uZmlnIHByb3BlcnR5LCBieSBuYW1lLCBpbiB0aGlzIGNhc2UgYW4gZW1wdHkgbmFtZToKICAgKiA8cHJlPgogICAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCJob21lIiwgewogKiAgIHZpZXdzOiB7CiAqICAgICAiIjogewogKiAgICAgICB0ZW1wbGF0ZTogIjxoMT5IRUxMTyE8L2gxPiIKICogICAgIH0KICogICB9ICAgIAogKiB9KQogICAqIDwvcHJlPgogICAqCiAgICogQnV0IHR5cGljYWxseSB5b3UnbGwgb25seSB1c2UgdGhlIHZpZXdzIHByb3BlcnR5IGlmIHlvdSBuYW1lIHlvdXIgdmlldyBvciBoYXZlIG1vcmUgdGhhbiBvbmUgdmlldwogICAqIGluIHRoZSBzYW1lIHRlbXBsYXRlLiBUaGVyZSdzIG5vdCByZWFsbHkgYSBjb21wZWxsaW5nIHJlYXNvbiB0byBuYW1lIGEgdmlldyBpZiBpdHMgdGhlIG9ubHkgb25lLAogICAqIGJ1dCB5b3UgY291bGQgaWYgeW91IHdhbnRlZCwgbGlrZSBzbzoKICAgKiA8cHJlPgogICAqIDxkaXYgdWktdmlldz0ibWFpbiI+PC9kaXY+CiAgICogPC9wcmU+CiAgICogPHByZT4KICAgKiAkc3RhdGVQcm92aWRlci5zdGF0ZSgiaG9tZSIsIHsKICogICB2aWV3czogewogKiAgICAgIm1haW4iOiB7CiAqICAgICAgIHRlbXBsYXRlOiAiPGgxPkhFTExPITwvaDE+IgogKiAgICAgfQogKiAgIH0gICAgCiAqIH0pCiAgICogPC9wcmU+CiAgICoKICAgKiBSZWFsbHkgdGhvdWdoLCB5b3UnbGwgdXNlIHZpZXdzIHRvIHNldCB1cCBtdWx0aXBsZSB2aWV3czoKICAgKiA8cHJlPgogICAqIDxkaXYgdWktdmlldz48L2Rpdj4KICAgKiA8ZGl2IHVpLXZpZXc9ImNoYXJ0Ij48L2Rpdj4KICAgKiA8ZGl2IHVpLXZpZXc9ImRhdGEiPjwvZGl2PgogICAqIDwvcHJlPgogICAqCiAgICogPHByZT4KICAgKiAkc3RhdGVQcm92aWRlci5zdGF0ZSgiaG9tZSIsIHsKICogICB2aWV3czogewogKiAgICAgIiI6IHsKICogICAgICAgdGVtcGxhdGU6ICI8aDE+SEVMTE8hPC9oMT4iCiAqICAgICB9LAogKiAgICAgImNoYXJ0IjogewogKiAgICAgICB0ZW1wbGF0ZTogIjxjaGFydF90aGluZy8+IgogKiAgICAgfSwKICogICAgICJkYXRhIjogewogKiAgICAgICB0ZW1wbGF0ZTogIjxkYXRhX3RoaW5nLz4iCiAqICAgICB9CiAqICAgfSAgICAKICogfSkKICAgKiA8L3ByZT4KICAgKgogICAqIEV4YW1wbGVzIGZvciBgYXV0b3Njcm9sbGA6CiAgICoKICAgKiA8cHJlPgogICAqIDwhLS0gSWYgYXV0b3Njcm9sbCBwcmVzZW50IHdpdGggbm8gZXhwcmVzc2lvbiwKICAgKiAgICAgIHRoZW4gc2Nyb2xsIHVpLXZpZXcgaW50byB2aWV3IC0tPgogICAqIDx1aS12aWV3IGF1dG9zY3JvbGwvPgogICAqCiAgICogPCEtLSBJZiBhdXRvc2Nyb2xsIHByZXNlbnQgd2l0aCB2YWxpZCBleHByZXNzaW9uLAogICAqICAgICAgdGhlbiBzY3JvbGwgdWktdmlldyBpbnRvIHZpZXcgaWYgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZSAtLT4KICAgKiA8dWktdmlldyBhdXRvc2Nyb2xsPSd0cnVlJy8+CiAgICogPHVpLXZpZXcgYXV0b3Njcm9sbD0nZmFsc2UnLz4KICAgKiA8dWktdmlldyBhdXRvc2Nyb2xsPSdzY29wZVZhcmlhYmxlJy8+CiAgICogPC9wcmU+CiAgICovCiAgJFZpZXdEaXJlY3RpdmUuJGluamVjdCA9IFsnJHN0YXRlJywgJyRpbmplY3RvcicsICckdWlWaWV3U2Nyb2xsJ107CiAgZnVuY3Rpb24gJFZpZXdEaXJlY3RpdmUoICAgJHN0YXRlLCAgICRpbmplY3RvciwgICAkdWlWaWV3U2Nyb2xsKSB7CgogICAgZnVuY3Rpb24gZ2V0U2VydmljZSgpIHsKICAgICAgcmV0dXJuICgkaW5qZWN0b3IuaGFzKSA/IGZ1bmN0aW9uKHNlcnZpY2UpIHsKICAgICAgICByZXR1cm4gJGluamVjdG9yLmhhcyhzZXJ2aWNlKSA/ICRpbmplY3Rvci5nZXQoc2VydmljZSkgOiBudWxsOwogICAgICB9IDogZnVuY3Rpb24oc2VydmljZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gJGluamVjdG9yLmdldChzZXJ2aWNlKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICB9CgogICAgdmFyIHNlcnZpY2UgPSBnZXRTZXJ2aWNlKCksCiAgICAgICRhbmltYXRvciA9IHNlcnZpY2UoJyRhbmltYXRvcicpLAogICAgICAkYW5pbWF0ZSA9IHNlcnZpY2UoJyRhbmltYXRlJyk7CgogICAgLy8gUmV0dXJucyBhIHNldCBvZiBET00gbWFuaXB1bGF0aW9uIGZ1bmN0aW9ucyBiYXNlZCBvbiB3aGljaCBBbmd1bGFyIHZlcnNpb24KICAgIC8vIGl0IHNob3VsZCB1c2UKICAgIGZ1bmN0aW9uIGdldFJlbmRlcmVyKGF0dHJzLCBzY29wZSkgewogICAgICB2YXIgc3RhdGljcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBlbnRlcjogZnVuY3Rpb24gKGVsZW1lbnQsIHRhcmdldCwgY2IpIHsgdGFyZ2V0LmFmdGVyKGVsZW1lbnQpOyBjYigpOyB9LAogICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uIChlbGVtZW50LCBjYikgeyBlbGVtZW50LnJlbW92ZSgpOyBjYigpOyB9CiAgICAgICAgfTsKICAgICAgfTsKCiAgICAgIGlmICgkYW5pbWF0ZSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBlbnRlcjogZnVuY3Rpb24oZWxlbWVudCwgdGFyZ2V0LCBjYikgeyAkYW5pbWF0ZS5lbnRlcihlbGVtZW50LCBudWxsLCB0YXJnZXQsIGNiKTsgfSwKICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbihlbGVtZW50LCBjYikgeyAkYW5pbWF0ZS5sZWF2ZShlbGVtZW50LCBjYik7IH0KICAgICAgICB9OwogICAgICB9CgogICAgICBpZiAoJGFuaW1hdG9yKSB7CiAgICAgICAgdmFyIGFuaW1hdGUgPSAkYW5pbWF0b3IgJiYgJGFuaW1hdG9yKHNjb3BlLCBhdHRycyk7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBlbnRlcjogZnVuY3Rpb24oZWxlbWVudCwgdGFyZ2V0LCBjYikge2FuaW1hdGUuZW50ZXIoZWxlbWVudCwgbnVsbCwgdGFyZ2V0KTsgY2IoKTsgfSwKICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbihlbGVtZW50LCBjYikgeyBhbmltYXRlLmxlYXZlKGVsZW1lbnQpOyBjYigpOyB9CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIHN0YXRpY3MoKTsKICAgIH0KCiAgICB2YXIgZGlyZWN0aXZlID0gewogICAgICByZXN0cmljdDogJ0VDQScsCiAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICBwcmlvcml0eTogNDAwLAogICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICh0RWxlbWVudCwgdEF0dHJzLCAkdHJhbnNjbHVkZSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsICRlbGVtZW50LCBhdHRycykgewogICAgICAgICAgdmFyIHByZXZpb3VzRWwsIGN1cnJlbnRFbCwgY3VycmVudFNjb3BlLCBsYXRlc3RMb2NhbHMsCiAgICAgICAgICAgIG9ubG9hZEV4cCAgICAgPSBhdHRycy5vbmxvYWQgfHwgJycsCiAgICAgICAgICAgIGF1dG9TY3JvbGxFeHAgPSBhdHRycy5hdXRvc2Nyb2xsLAogICAgICAgICAgICByZW5kZXJlciAgICAgID0gZ2V0UmVuZGVyZXIoYXR0cnMsIHNjb3BlKTsKCiAgICAgICAgICBzY29wZS4kb24oJyRzdGF0ZUNoYW5nZVN1Y2Nlc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlVmlldyhmYWxzZSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHNjb3BlLiRvbignJHZpZXdDb250ZW50TG9hZGluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGVWaWV3KGZhbHNlKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHVwZGF0ZVZpZXcodHJ1ZSk7CgogICAgICAgICAgZnVuY3Rpb24gY2xlYW51cExhc3RWaWV3KCkgewogICAgICAgICAgICBpZiAocHJldmlvdXNFbCkgewogICAgICAgICAgICAgIHByZXZpb3VzRWwucmVtb3ZlKCk7CiAgICAgICAgICAgICAgcHJldmlvdXNFbCA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjdXJyZW50U2NvcGUpIHsKICAgICAgICAgICAgICBjdXJyZW50U2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICBjdXJyZW50U2NvcGUgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY3VycmVudEVsKSB7CiAgICAgICAgICAgICAgcmVuZGVyZXIubGVhdmUoY3VycmVudEVsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzRWwgPSBudWxsOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBwcmV2aW91c0VsID0gY3VycmVudEVsOwogICAgICAgICAgICAgIGN1cnJlbnRFbCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVWaWV3KGZpcnN0VGltZSkgewogICAgICAgICAgICB2YXIgbmV3U2NvcGUgICAgICAgID0gc2NvcGUuJG5ldygpLAogICAgICAgICAgICAgIG5hbWUgICAgICAgICAgICA9IGN1cnJlbnRFbCAmJiBjdXJyZW50RWwuZGF0YSgnJHVpVmlld05hbWUnKSwKICAgICAgICAgICAgICBwcmV2aW91c0xvY2FscyAgPSBuYW1lICYmICRzdGF0ZS4kY3VycmVudCAmJiAkc3RhdGUuJGN1cnJlbnQubG9jYWxzW25hbWVdOwoKICAgICAgICAgICAgaWYgKCFmaXJzdFRpbWUgJiYgcHJldmlvdXNMb2NhbHMgPT09IGxhdGVzdExvY2FscykgcmV0dXJuOyAvLyBub3RoaW5nIHRvIGRvCgogICAgICAgICAgICB2YXIgY2xvbmUgPSAkdHJhbnNjbHVkZShuZXdTY29wZSwgZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgICAgICAgICByZW5kZXJlci5lbnRlcihjbG9uZSwgJGVsZW1lbnQsIGZ1bmN0aW9uIG9uVWlWaWV3RW50ZXIoKSB7CiAgICAgICAgICAgICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQoYXV0b1Njcm9sbEV4cCkgJiYgIWF1dG9TY3JvbGxFeHAgfHwgc2NvcGUuJGV2YWwoYXV0b1Njcm9sbEV4cCkpIHsKICAgICAgICAgICAgICAgICAgJHVpVmlld1Njcm9sbChjbG9uZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgY2xlYW51cExhc3RWaWV3KCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgbGF0ZXN0TG9jYWxzID0gJHN0YXRlLiRjdXJyZW50LmxvY2Fsc1tjbG9uZS5kYXRhKCckdWlWaWV3TmFtZScpXTsKCiAgICAgICAgICAgIGN1cnJlbnRFbCA9IGNsb25lOwogICAgICAgICAgICBjdXJyZW50U2NvcGUgPSBuZXdTY29wZTsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuZGlyZWN0aXZlOnVpLXZpZXcjJHZpZXdDb250ZW50TG9hZGVkCiAgICAgICAgICAgICAqIEBldmVudE9mIHVpLnJvdXRlci5zdGF0ZS5kaXJlY3RpdmU6dWktdmlldwogICAgICAgICAgICAgKiBAZXZlbnRUeXBlIGVtaXRzIG9uIHVpLXZpZXcgZGlyZWN0aXZlIHNjb3BlCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbiAgICAgICAgICAgKgogICAgICAgICAgICAgKiBGaXJlZCBvbmNlIHRoZSB2aWV3IGlzICoqbG9hZGVkKiosICphZnRlciogdGhlIERPTSBpcyByZW5kZXJlZC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50IEV2ZW50IG9iamVjdC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGN1cnJlbnRTY29wZS4kZW1pdCgnJHZpZXdDb250ZW50TG9hZGVkJyk7CiAgICAgICAgICAgIGN1cnJlbnRTY29wZS4kZXZhbChvbmxvYWRFeHApOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIGRpcmVjdGl2ZTsKICB9CgogICRWaWV3RGlyZWN0aXZlRmlsbC4kaW5qZWN0ID0gWyckY29tcGlsZScsICckY29udHJvbGxlcicsICckc3RhdGUnXTsKICBmdW5jdGlvbiAkVmlld0RpcmVjdGl2ZUZpbGwgKCRjb21waWxlLCAkY29udHJvbGxlciwgJHN0YXRlKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VDQScsCiAgICAgIHByaW9yaXR5OiAtNDAwLAogICAgICBjb21waWxlOiBmdW5jdGlvbiAodEVsZW1lbnQpIHsKICAgICAgICB2YXIgaW5pdGlhbCA9IHRFbGVtZW50Lmh0bWwoKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCAkZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICAgIHZhciBuYW1lICAgICAgPSBhdHRycy51aVZpZXcgfHwgYXR0cnMubmFtZSB8fCAnJywKICAgICAgICAgICAgaW5oZXJpdGVkID0gJGVsZW1lbnQuaW5oZXJpdGVkRGF0YSgnJHVpVmlldycpOwoKICAgICAgICAgIGlmIChuYW1lLmluZGV4T2YoJ0AnKSA8IDApIHsKICAgICAgICAgICAgbmFtZSA9IG5hbWUgKyAnQCcgKyAoaW5oZXJpdGVkID8gaW5oZXJpdGVkLnN0YXRlLm5hbWUgOiAnJyk7CiAgICAgICAgICB9CgogICAgICAgICAgJGVsZW1lbnQuZGF0YSgnJHVpVmlld05hbWUnLCBuYW1lKTsKCiAgICAgICAgICB2YXIgY3VycmVudCA9ICRzdGF0ZS4kY3VycmVudCwKICAgICAgICAgICAgbG9jYWxzICA9IGN1cnJlbnQgJiYgY3VycmVudC5sb2NhbHNbbmFtZV07CgogICAgICAgICAgaWYgKCEgbG9jYWxzKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICAkZWxlbWVudC5kYXRhKCckdWlWaWV3JywgeyBuYW1lOiBuYW1lLCBzdGF0ZTogbG9jYWxzLiQkc3RhdGUgfSk7CiAgICAgICAgICAkZWxlbWVudC5odG1sKGxvY2Fscy4kdGVtcGxhdGUgPyBsb2NhbHMuJHRlbXBsYXRlIDogaW5pdGlhbCk7CgogICAgICAgICAgdmFyIGxpbmsgPSAkY29tcGlsZSgkZWxlbWVudC5jb250ZW50cygpKTsKCiAgICAgICAgICBpZiAobG9jYWxzLiQkY29udHJvbGxlcikgewogICAgICAgICAgICBsb2NhbHMuJHNjb3BlID0gc2NvcGU7CiAgICAgICAgICAgIHZhciBjb250cm9sbGVyID0gJGNvbnRyb2xsZXIobG9jYWxzLiQkY29udHJvbGxlciwgbG9jYWxzKTsKICAgICAgICAgICAgaWYgKGxvY2Fscy4kJGNvbnRyb2xsZXJBcykgewogICAgICAgICAgICAgIHNjb3BlW2xvY2Fscy4kJGNvbnRyb2xsZXJBc10gPSBjb250cm9sbGVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgICRlbGVtZW50LmRhdGEoJyRuZ0NvbnRyb2xsZXJDb250cm9sbGVyJywgY29udHJvbGxlcik7CiAgICAgICAgICAgICRlbGVtZW50LmNoaWxkcmVuKCkuZGF0YSgnJG5nQ29udHJvbGxlckNvbnRyb2xsZXInLCBjb250cm9sbGVyKTsKICAgICAgICAgIH0KCiAgICAgICAgICBsaW5rKHNjb3BlKTsKICAgICAgICB9OwogICAgICB9CiAgICB9OwogIH0KCiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5zdGF0ZScpLmRpcmVjdGl2ZSgndWlWaWV3JywgJFZpZXdEaXJlY3RpdmUpOwogIGFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIuc3RhdGUnKS5kaXJlY3RpdmUoJ3VpVmlldycsICRWaWV3RGlyZWN0aXZlRmlsbCk7CgogIGZ1bmN0aW9uIHBhcnNlU3RhdGVSZWYocmVmKSB7CiAgICB2YXIgcGFyc2VkID0gcmVmLnJlcGxhY2UoL1xuL2csICIgIikubWF0Y2goL14oW14oXSs/KVxzKihcKCguKilcKSk/JC8pOwogICAgaWYgKCFwYXJzZWQgfHwgcGFyc2VkLmxlbmd0aCAhPT0gNCkgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHN0YXRlIHJlZiAnIiArIHJlZiArICInIik7CiAgICByZXR1cm4geyBzdGF0ZTogcGFyc2VkWzFdLCBwYXJhbUV4cHI6IHBhcnNlZFszXSB8fCBudWxsIH07CiAgfQoKICBmdW5jdGlvbiBzdGF0ZUNvbnRleHQoZWwpIHsKICAgIHZhciBzdGF0ZURhdGEgPSBlbC5wYXJlbnQoKS5pbmhlcml0ZWREYXRhKCckdWlWaWV3Jyk7CgogICAgaWYgKHN0YXRlRGF0YSAmJiBzdGF0ZURhdGEuc3RhdGUgJiYgc3RhdGVEYXRhLnN0YXRlLm5hbWUpIHsKICAgICAgcmV0dXJuIHN0YXRlRGF0YS5zdGF0ZTsKICAgIH0KICB9CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuZGlyZWN0aXZlOnVpLXNyZWYKICAgKgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICogQHJlcXVpcmVzICR0aW1lb3V0CiAgICoKICAgKiBAcmVzdHJpY3QgQQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQSBkaXJlY3RpdmUgdGhhdCBiaW5kcyBhIGxpbmsgKGA8YT5gIHRhZykgdG8gYSBzdGF0ZS4gSWYgdGhlIHN0YXRlIGhhcyBhbiBhc3NvY2lhdGVkCiAgICogVVJMLCB0aGUgZGlyZWN0aXZlIHdpbGwgYXV0b21hdGljYWxseSBnZW5lcmF0ZSAmIHVwZGF0ZSB0aGUgYGhyZWZgIGF0dHJpYnV0ZSB2aWEKICAgKiB0aGUge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjbWV0aG9kc19ocmVmICRzdGF0ZS5ocmVmKCl9IG1ldGhvZC4gQ2xpY2tpbmcKICAgKiB0aGUgbGluayB3aWxsIHRyaWdnZXIgYSBzdGF0ZSB0cmFuc2l0aW9uIHdpdGggb3B0aW9uYWwgcGFyYW1ldGVycy4KICAgKgogICAqIEFsc28gbWlkZGxlLWNsaWNraW5nLCByaWdodC1jbGlja2luZywgYW5kIGN0cmwtY2xpY2tpbmcgb24gdGhlIGxpbmsgd2lsbCBiZQogICAqIGhhbmRsZWQgbmF0aXZlbHkgYnkgdGhlIGJyb3dzZXIuCiAgICoKICAgKiBZb3UgY2FuIGFsc28gdXNlIHJlbGF0aXZlIHN0YXRlIHBhdGhzIHdpdGhpbiB1aS1zcmVmLCBqdXN0IGxpa2UgdGhlIHJlbGF0aXZlCiAgICogcGF0aHMgcGFzc2VkIHRvIGAkc3RhdGUuZ28oKWAuIFlvdSBqdXN0IG5lZWQgdG8gYmUgYXdhcmUgdGhhdCB0aGUgcGF0aCBpcyByZWxhdGl2ZQogICAqIHRvIHRoZSBzdGF0ZSB0aGF0IHRoZSBsaW5rIGxpdmVzIGluLCBpbiBvdGhlciB3b3JkcyB0aGUgc3RhdGUgdGhhdCBsb2FkZWQgdGhlCiAgICogdGVtcGxhdGUgY29udGFpbmluZyB0aGUgbGluay4KICAgKgogICAqIFlvdSBjYW4gc3BlY2lmeSBvcHRpb25zIHRvIHBhc3MgdG8ge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjZ28gJHN0YXRlLmdvKCl9CiAgICogdXNpbmcgdGhlIGB1aS1zcmVmLW9wdHNgIGF0dHJpYnV0ZS4gT3B0aW9ucyBhcmUgcmVzdHJpY3RlZCB0byBgbG9jYXRpb25gLCBgaW5oZXJpdGAsCiAgICogYW5kIGByZWxvYWRgLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBIZXJlJ3MgYW4gZXhhbXBsZSBvZiBob3cgeW91J2QgdXNlIHVpLXNyZWYgYW5kIGhvdyBpdCB3b3VsZCBjb21waWxlLiBJZiB5b3UgaGF2ZSB0aGUKICAgKiBmb2xsb3dpbmcgdGVtcGxhdGU6CiAgICogPHByZT4KICAgKiA8YSB1aS1zcmVmPSJob21lIj5Ib21lPC9hPiB8IDxhIHVpLXNyZWY9ImFib3V0Ij5BYm91dDwvYT4KICAgKgogICAqIDx1bD4KICAgKiAgICAgPGxpIG5nLXJlcGVhdD0iY29udGFjdCBpbiBjb250YWN0cyI+CiAgICogICAgICAgICA8YSB1aS1zcmVmPSJjb250YWN0cy5kZXRhaWwoeyBpZDogY29udGFjdC5pZCB9KSI+e3sgY29udGFjdC5uYW1lIH19PC9hPgogICAqICAgICA8L2xpPgogICAqIDwvdWw+CiAgICogPC9wcmU+CiAgICoKICAgKiBUaGVuIHRoZSBjb21waWxlZCBodG1sIHdvdWxkIGJlIChhc3N1bWluZyBIdG1sNU1vZGUgaXMgb2ZmKToKICAgKiA8cHJlPgogICAqIDxhIGhyZWY9IiMvaG9tZSIgdWktc3JlZj0iaG9tZSI+SG9tZTwvYT4gfCA8YSBocmVmPSIjL2Fib3V0IiB1aS1zcmVmPSJhYm91dCI+QWJvdXQ8L2E+CiAgICoKICAgKiA8dWw+CiAgICogICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gY29udGFjdHMiPgogICAqICAgICAgICAgPGEgaHJlZj0iIy9jb250YWN0cy8xIiB1aS1zcmVmPSJjb250YWN0cy5kZXRhaWwoeyBpZDogY29udGFjdC5pZCB9KSI+Sm9lPC9hPgogICAqICAgICA8L2xpPgogICAqICAgICA8bGkgbmctcmVwZWF0PSJjb250YWN0IGluIGNvbnRhY3RzIj4KICAgKiAgICAgICAgIDxhIGhyZWY9IiMvY29udGFjdHMvMiIgdWktc3JlZj0iY29udGFjdHMuZGV0YWlsKHsgaWQ6IGNvbnRhY3QuaWQgfSkiPkFsaWNlPC9hPgogICAqICAgICA8L2xpPgogICAqICAgICA8bGkgbmctcmVwZWF0PSJjb250YWN0IGluIGNvbnRhY3RzIj4KICAgKiAgICAgICAgIDxhIGhyZWY9IiMvY29udGFjdHMvMyIgdWktc3JlZj0iY29udGFjdHMuZGV0YWlsKHsgaWQ6IGNvbnRhY3QuaWQgfSkiPkJvYjwvYT4KICAgKiAgICAgPC9saT4KICAgKiA8L3VsPgogICAqCiAgICogPGEgdWktc3JlZj0iaG9tZSIgdWktc3JlZi1vcHRzPSJ7cmVsb2FkOiB0cnVlfSI+SG9tZTwvYT4KICAgKiA8L3ByZT4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB1aS1zcmVmICdzdGF0ZU5hbWUnIGNhbiBiZSBhbnkgdmFsaWQgYWJzb2x1dGUgb3IgcmVsYXRpdmUgc3RhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gdWktc3JlZi1vcHRzIG9wdGlvbnMgdG8gcGFzcyB0byB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNnbyAkc3RhdGUuZ28oKX0KICAgKi8KICAkU3RhdGVSZWZEaXJlY3RpdmUuJGluamVjdCA9IFsnJHN0YXRlJywgJyR0aW1lb3V0J107CiAgZnVuY3Rpb24gJFN0YXRlUmVmRGlyZWN0aXZlKCRzdGF0ZSwgJHRpbWVvdXQpIHsKICAgIHZhciBhbGxvd2VkT3B0aW9ucyA9IFsnbG9jYXRpb24nLCAnaW5oZXJpdCcsICdyZWxvYWQnXTsKCiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0EnLAogICAgICByZXF1aXJlOiAnP151aVNyZWZBY3RpdmUnLAogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMsIHVpU3JlZkFjdGl2ZSkgewogICAgICAgIHZhciByZWYgPSBwYXJzZVN0YXRlUmVmKGF0dHJzLnVpU3JlZik7CiAgICAgICAgdmFyIHBhcmFtcyA9IG51bGwsIHVybCA9IG51bGwsIGJhc2UgPSBzdGF0ZUNvbnRleHQoZWxlbWVudCkgfHwgJHN0YXRlLiRjdXJyZW50OwogICAgICAgIHZhciBpc0Zvcm0gPSBlbGVtZW50WzBdLm5vZGVOYW1lID09PSAiRk9STSI7CiAgICAgICAgdmFyIGF0dHIgPSBpc0Zvcm0gPyAiYWN0aW9uIiA6ICJocmVmIiwgbmF2ID0gdHJ1ZTsKCiAgICAgICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgICByZWxhdGl2ZTogYmFzZQogICAgICAgIH07CiAgICAgICAgdmFyIG9wdGlvbnNPdmVycmlkZSA9IHNjb3BlLiRldmFsKGF0dHJzLnVpU3JlZk9wdHMpIHx8IHt9OwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChhbGxvd2VkT3B0aW9ucywgZnVuY3Rpb24ob3B0aW9uKSB7CiAgICAgICAgICBpZiAob3B0aW9uIGluIG9wdGlvbnNPdmVycmlkZSkgewogICAgICAgICAgICBvcHRpb25zW29wdGlvbl0gPSBvcHRpb25zT3ZlcnJpZGVbb3B0aW9uXTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdmFyIHVwZGF0ZSA9IGZ1bmN0aW9uKG5ld1ZhbCkgewogICAgICAgICAgaWYgKG5ld1ZhbCkgcGFyYW1zID0gbmV3VmFsOwogICAgICAgICAgaWYgKCFuYXYpIHJldHVybjsKCiAgICAgICAgICB2YXIgbmV3SHJlZiA9ICRzdGF0ZS5ocmVmKHJlZi5zdGF0ZSwgcGFyYW1zLCBvcHRpb25zKTsKCiAgICAgICAgICBpZiAodWlTcmVmQWN0aXZlKSB7CiAgICAgICAgICAgIHVpU3JlZkFjdGl2ZS4kJHNldFN0YXRlSW5mbyhyZWYuc3RhdGUsIHBhcmFtcyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIW5ld0hyZWYpIHsKICAgICAgICAgICAgbmF2ID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW1lbnRbMF1bYXR0cl0gPSBuZXdIcmVmOwogICAgICAgIH07CgogICAgICAgIGlmIChyZWYucGFyYW1FeHByKSB7CiAgICAgICAgICBzY29wZS4kd2F0Y2gocmVmLnBhcmFtRXhwciwgZnVuY3Rpb24obmV3VmFsLCBvbGRWYWwpIHsKICAgICAgICAgICAgaWYgKG5ld1ZhbCAhPT0gcGFyYW1zKSB1cGRhdGUobmV3VmFsKTsKICAgICAgICAgIH0sIHRydWUpOwogICAgICAgICAgcGFyYW1zID0gc2NvcGUuJGV2YWwocmVmLnBhcmFtRXhwcik7CiAgICAgICAgfQogICAgICAgIHVwZGF0ZSgpOwoKICAgICAgICBpZiAoaXNGb3JtKSByZXR1cm47CgogICAgICAgIGVsZW1lbnQuYmluZCgiY2xpY2siLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICB2YXIgYnV0dG9uID0gZS53aGljaCB8fCBlLmJ1dHRvbjsKICAgICAgICAgIGlmICggIShidXR0b24gPiAxIHx8IGUuY3RybEtleSB8fCBlLm1ldGFLZXkgfHwgZS5zaGlmdEtleSB8fCBlbGVtZW50LmF0dHIoJ3RhcmdldCcpKSApIHsKICAgICAgICAgICAgLy8gSEFDSzogVGhpcyBpcyB0byBhbGxvdyBuZy1jbGlja3MgdG8gYmUgcHJvY2Vzc2VkIGJlZm9yZSB0aGUgdHJhbnNpdGlvbiBpcyBpbml0aWF0ZWQ6CiAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICRzdGF0ZS5nbyhyZWYuc3RhdGUsIHBhcmFtcywgb3B0aW9ucyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgfQoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLmRpcmVjdGl2ZTp1aS1zcmVmLWFjdGl2ZQogICAqCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVBhcmFtcwogICAqIEByZXF1aXJlcyAkaW50ZXJwb2xhdGUKICAgKgogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBIGRpcmVjdGl2ZSB3b3JraW5nIGFsb25nc2lkZSB1aS1zcmVmIHRvIGFkZCBjbGFzc2VzIHRvIGFuIGVsZW1lbnQgd2hlbiB0aGUKICAgKiByZWxhdGVkIHVpLXNyZWYgZGlyZWN0aXZlJ3Mgc3RhdGUgaXMgYWN0aXZlLCBhbmQgcmVtb3ZpbmcgdGhlbSB3aGVuIGl0IGlzIGluYWN0aXZlLgogICAqIFRoZSBwcmltYXJ5IHVzZS1jYXNlIGlzIHRvIHNpbXBsaWZ5IHRoZSBzcGVjaWFsIGFwcGVhcmFuY2Ugb2YgbmF2aWdhdGlvbiBtZW51cwogICAqIHJlbHlpbmcgb24gYHVpLXNyZWZgLCBieSBoYXZpbmcgdGhlICJhY3RpdmUiIHN0YXRlJ3MgbWVudSBidXR0b24gYXBwZWFyIGRpZmZlcmVudCwKICAgKiBkaXN0aW5ndWlzaGluZyBpdCBmcm9tIHRoZSBpbmFjdGl2ZSBtZW51IGl0ZW1zLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBHaXZlbiB0aGUgZm9sbG93aW5nIHRlbXBsYXRlOgogICAqIDxwcmU+CiAgICogPHVsPgogICAqICAgPGxpIHVpLXNyZWYtYWN0aXZlPSJhY3RpdmUiIGNsYXNzPSJpdGVtIj4KICAgKiAgICAgPGEgaHJlZiB1aS1zcmVmPSJhcHAudXNlcih7dXNlcjogJ2JpbGJvYmFnZ2lucyd9KSI+QGJpbGJvYmFnZ2luczwvYT4KICAgKiAgIDwvbGk+CiAgICogPC91bD4KICAgKiA8L3ByZT4KICAgKgogICAqIFdoZW4gdGhlIGFwcCBzdGF0ZSBpcyAiYXBwLnVzZXIiLCBhbmQgY29udGFpbnMgdGhlIHN0YXRlIHBhcmFtZXRlciAidXNlciIgd2l0aCB2YWx1ZSAiYmlsYm9iYWdnaW5zIiwKICAgKiB0aGUgcmVzdWx0aW5nIEhUTUwgd2lsbCBhcHBlYXIgYXMgKG5vdGUgdGhlICdhY3RpdmUnIGNsYXNzKToKICAgKiA8cHJlPgogICAqIDx1bD4KICAgKiAgIDxsaSB1aS1zcmVmLWFjdGl2ZT0iYWN0aXZlIiBjbGFzcz0iaXRlbSBhY3RpdmUiPgogICAqICAgICA8YSB1aS1zcmVmPSJhcHAudXNlcih7dXNlcjogJ2JpbGJvYmFnZ2lucyd9KSIgaHJlZj0iL3VzZXJzL2JpbGJvYmFnZ2lucyI+QGJpbGJvYmFnZ2luczwvYT4KICAgKiAgIDwvbGk+CiAgICogPC91bD4KICAgKiA8L3ByZT4KICAgKgogICAqIFRoZSBjbGFzcyBuYW1lIGlzIGludGVycG9sYXRlZCAqKm9uY2UqKiBkdXJpbmcgdGhlIGRpcmVjdGl2ZXMgbGluayB0aW1lIChhbnkgZnVydGhlciBjaGFuZ2VzIHRvIHRoZQogICAqIGludGVycG9sYXRlZCB2YWx1ZSBhcmUgaWdub3JlZCkuCiAgICoKICAgKiBNdWx0aXBsZSBjbGFzc2VzIG1heSBiZSBzcGVjaWZpZWQgaW4gYSBzcGFjZS1zZXBhcmF0ZWQgZm9ybWF0OgogICAqIDxwcmU+CiAgICogPHVsPgogICAqICAgPGxpIHVpLXNyZWYtYWN0aXZlPSdjbGFzczEgY2xhc3MyIGNsYXNzMyc+CiAgICogICAgIDxhIHVpLXNyZWY9ImFwcC51c2VyIj5saW5rPC9hPgogICAqICAgPC9saT4KICAgKiA8L3VsPgogICAqIDwvcHJlPgogICAqLwogICRTdGF0ZUFjdGl2ZURpcmVjdGl2ZS4kaW5qZWN0ID0gWyckc3RhdGUnLCAnJHN0YXRlUGFyYW1zJywgJyRpbnRlcnBvbGF0ZSddOwogIGZ1bmN0aW9uICRTdGF0ZUFjdGl2ZURpcmVjdGl2ZSgkc3RhdGUsICRzdGF0ZVBhcmFtcywgJGludGVycG9sYXRlKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogIkEiLAogICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckZWxlbWVudCcsICckYXR0cnMnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgICB2YXIgc3RhdGUsIHBhcmFtcywgYWN0aXZlQ2xhc3M7CgogICAgICAgIC8vIFRoZXJlIHByb2JhYmx5IGlzbid0IG11Y2ggcG9pbnQgaW4gJG9ic2VydmluZyB0aGlzCiAgICAgICAgYWN0aXZlQ2xhc3MgPSAkaW50ZXJwb2xhdGUoJGF0dHJzLnVpU3JlZkFjdGl2ZSB8fCAnJywgZmFsc2UpKCRzY29wZSk7CgogICAgICAgIC8vIEFsbG93IHVpU3JlZiB0byBjb21tdW5pY2F0ZSB3aXRoIHVpU3JlZkFjdGl2ZQogICAgICAgIHRoaXMuJCRzZXRTdGF0ZUluZm8gPSBmdW5jdGlvbihuZXdTdGF0ZSwgbmV3UGFyYW1zKSB7CiAgICAgICAgICBzdGF0ZSA9ICRzdGF0ZS5nZXQobmV3U3RhdGUsIHN0YXRlQ29udGV4dCgkZWxlbWVudCkpOwogICAgICAgICAgcGFyYW1zID0gbmV3UGFyYW1zOwogICAgICAgICAgdXBkYXRlKCk7CiAgICAgICAgfTsKCiAgICAgICAgJHNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3VjY2VzcycsIHVwZGF0ZSk7CgogICAgICAgIC8vIFVwZGF0ZSByb3V0ZSBzdGF0ZQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZSgpIHsKICAgICAgICAgIGlmICgkc3RhdGUuJGN1cnJlbnQuc2VsZiA9PT0gc3RhdGUgJiYgbWF0Y2hlc1BhcmFtcygpKSB7CiAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKGFjdGl2ZUNsYXNzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICRlbGVtZW50LnJlbW92ZUNsYXNzKGFjdGl2ZUNsYXNzKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG1hdGNoZXNQYXJhbXMoKSB7CiAgICAgICAgICByZXR1cm4gIXBhcmFtcyB8fCBlcXVhbEZvcktleXMocGFyYW1zLCAkc3RhdGVQYXJhbXMpOwogICAgICAgIH0KICAgICAgfV0KICAgIH07CiAgfQoKICBhbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnN0YXRlJykKICAgIC5kaXJlY3RpdmUoJ3VpU3JlZicsICRTdGF0ZVJlZkRpcmVjdGl2ZSkKICAgIC5kaXJlY3RpdmUoJ3VpU3JlZkFjdGl2ZScsICRTdGF0ZUFjdGl2ZURpcmVjdGl2ZSk7CgogIC8qKgogICAqIEBuZ2RvYyBmaWx0ZXIKICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuZmlsdGVyOmlzU3RhdGUKICAgKgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUcmFuc2xhdGVzIHRvIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI21ldGhvZHNfaXMgJHN0YXRlLmlzKCJzdGF0ZU5hbWUiKX0uCiAgICovCiAgJElzU3RhdGVGaWx0ZXIuJGluamVjdCA9IFsnJHN0YXRlJ107CiAgZnVuY3Rpb24gJElzU3RhdGVGaWx0ZXIoJHN0YXRlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgcmV0dXJuICRzdGF0ZS5pcyhzdGF0ZSk7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGZpbHRlcgogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS5maWx0ZXI6aW5jbHVkZWRCeVN0YXRlCiAgICoKICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVHJhbnNsYXRlcyB0byB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNtZXRob2RzX2luY2x1ZGVzICRzdGF0ZS5pbmNsdWRlcygnZnVsbE9yUGFydGlhbFN0YXRlTmFtZScpfS4KICAgKi8KICAkSW5jbHVkZWRCeVN0YXRlRmlsdGVyLiRpbmplY3QgPSBbJyRzdGF0ZSddOwogIGZ1bmN0aW9uICRJbmNsdWRlZEJ5U3RhdGVGaWx0ZXIoJHN0YXRlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgcmV0dXJuICRzdGF0ZS5pbmNsdWRlcyhzdGF0ZSk7CiAgICB9OwogIH0KCiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5zdGF0ZScpCiAgICAuZmlsdGVyKCdpc1N0YXRlJywgJElzU3RhdGVGaWx0ZXIpCiAgICAuZmlsdGVyKCdpbmNsdWRlZEJ5U3RhdGUnLCAkSW5jbHVkZWRCeVN0YXRlRmlsdGVyKTsKCiAgLyoKICAgKiBAbmdkb2Mgb2JqZWN0CiAgICogQG5hbWUgdWkucm91dGVyLmNvbXBhdC4kcm91dGVQcm92aWRlcgogICAqCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlcgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogYCRyb3V0ZVByb3ZpZGVyYCBvZiB0aGUgYHVpLnJvdXRlci5jb21wYXRgIG1vZHVsZSBvdmVyd3JpdGVzIHRoZSBleGlzdGluZwogICAqIGByb3V0ZVByb3ZpZGVyYCBmcm9tIHRoZSBjb3JlLiBUaGlzIGlzIGRvbmUgdG8gcHJvdmlkZSBjb21wYXRpYmlsaXR5IGJldHdlZW4KICAgKiB0aGUgVUkgUm91dGVyIGFuZCB0aGUgY29yZSByb3V0ZXIuCiAgICoKICAgKiBJdCBhbHNvIHByb3ZpZGVzIGEgYHdoZW4oKWAgbWV0aG9kIHRvIHJlZ2lzdGVyIHJvdXRlcyB0aGF0IG1hcCB0byBjZXJ0YWluIHVybHMuCiAgICogQmVoaW5kIHRoZSBzY2VuZXMgaXQgYWN0dWFsbHkgZGVsZWdhdGVzIGVpdGhlciB0byAKICAgKiB7QGxpbmsgdWkucm91dGVyLnJvdXRlci4kdXJsUm91dGVyUHJvdmlkZXIgJHVybFJvdXRlclByb3ZpZGVyfSBvciB0byB0aGUgCiAgICoge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlciAkc3RhdGVQcm92aWRlcn0gdG8gcG9zdHByb2Nlc3MgdGhlIGdpdmVuIAogICAqIHJvdXRlciBkZWZpbml0aW9uIG9iamVjdC4KICAgKi8KICAkUm91dGVQcm92aWRlci4kaW5qZWN0ID0gWyckc3RhdGVQcm92aWRlcicsICckdXJsUm91dGVyUHJvdmlkZXInXTsKICBmdW5jdGlvbiAkUm91dGVQcm92aWRlciggICRzdGF0ZVByb3ZpZGVyLCAgICAkdXJsUm91dGVyUHJvdmlkZXIpIHsKCiAgICB2YXIgcm91dGVzID0gW107CgogICAgb25FbnRlclJvdXRlLiRpbmplY3QgPSBbJyQkc3RhdGUnXTsKICAgIGZ1bmN0aW9uIG9uRW50ZXJSb3V0ZSggICAkJHN0YXRlKSB7CiAgICAgIC8qanNoaW50IHZhbGlkdGhpczogdHJ1ZSAqLwogICAgICB0aGlzLmxvY2FscyA9ICQkc3RhdGUubG9jYWxzLmdsb2JhbHM7CiAgICAgIHRoaXMucGFyYW1zID0gdGhpcy5sb2NhbHMuJHN0YXRlUGFyYW1zOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uRXhpdFJvdXRlKCkgewogICAgICAvKmpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KICAgICAgdGhpcy5sb2NhbHMgPSBudWxsOwogICAgICB0aGlzLnBhcmFtcyA9IG51bGw7CiAgICB9CgogICAgdGhpcy53aGVuID0gd2hlbjsKICAgIC8qCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci5jb21wYXQuJHJvdXRlUHJvdmlkZXIjd2hlbgogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5jb21wYXQuJHJvdXRlUHJvdmlkZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJlZ2lzdGVycyBhIHJvdXRlIHdpdGggYSBnaXZlbiByb3V0ZSBkZWZpbml0aW9uIG9iamVjdC4gVGhlIHJvdXRlIGRlZmluaXRpb24KICAgICAqIG9iamVjdCBoYXMgdGhlIHNhbWUgaW50ZXJmYWNlIHRoZSBhbmd1bGFyIGNvcmUgcm91dGUgZGVmaW5pdGlvbiBvYmplY3QgaGFzLgogICAgICogCiAgICAgKiBAZXhhbXBsZQogICAgICogPHByZT4KICAgICAqIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnYXBwJywgWyd1aS5yb3V0ZXIuY29tcGF0J10pOwogICAgICoKICAgICAqIGFwcC5jb25maWcoZnVuY3Rpb24gKCRyb3V0ZVByb3ZpZGVyKSB7CiAgICAgKiAgICRyb3V0ZVByb3ZpZGVyLndoZW4oJ2hvbWUnLCB7CiAgICAgKiAgICAgY29udHJvbGxlcjogZnVuY3Rpb24gKCkgeyAuLi4gfSwKICAgICAqICAgICB0ZW1wbGF0ZVVybDogJ3BhdGgvdG8vdGVtcGxhdGUnCiAgICAgKiAgIH0pOwogICAgICogfSk7CiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFVSTCBhcyBzdHJpbmcKICAgICAqIEBwYXJhbSB7b2JqZWN0fSByb3V0ZSBSb3V0ZSBkZWZpbml0aW9uIG9iamVjdAogICAgICoKICAgICAqIEByZXR1cm4ge29iamVjdH0gJHJvdXRlUHJvdmlkZXIgLSAkcm91dGVQcm92aWRlciBpbnN0YW5jZQogICAgICovCiAgICBmdW5jdGlvbiB3aGVuKHVybCwgcm91dGUpIHsKICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovCiAgICAgIGlmIChyb3V0ZS5yZWRpcmVjdFRvICE9IG51bGwpIHsKICAgICAgICAvLyBSZWRpcmVjdCwgY29uZmlndXJlIGRpcmVjdGx5IG9uICR1cmxSb3V0ZXJQcm92aWRlcgogICAgICAgIHZhciByZWRpcmVjdCA9IHJvdXRlLnJlZGlyZWN0VG8sIGhhbmRsZXI7CiAgICAgICAgaWYgKGlzU3RyaW5nKHJlZGlyZWN0KSkgewogICAgICAgICAgaGFuZGxlciA9IHJlZGlyZWN0OyAvLyBsZWF2ZSAkdXJsUm91dGVyUHJvdmlkZXIgdG8gaGFuZGxlCiAgICAgICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKHJlZGlyZWN0KSkgewogICAgICAgICAgLy8gQWRhcHQgdG8gJHVybFJvdXRlclByb3ZpZGVyIEFQSQogICAgICAgICAgaGFuZGxlciA9IGZ1bmN0aW9uIChwYXJhbXMsICRsb2NhdGlvbikgewogICAgICAgICAgICByZXR1cm4gcmVkaXJlY3QocGFyYW1zLCAkbG9jYXRpb24ucGF0aCgpLCAkbG9jYXRpb24uc2VhcmNoKCkpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkICdyZWRpcmVjdFRvJyBpbiB3aGVuKCkiKTsKICAgICAgICB9CiAgICAgICAgJHVybFJvdXRlclByb3ZpZGVyLndoZW4odXJsLCBoYW5kbGVyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBSZWd1bGFyIHJvdXRlLCBjb25maWd1cmUgYXMgc3RhdGUKICAgICAgICAkc3RhdGVQcm92aWRlci5zdGF0ZShpbmhlcml0KHJvdXRlLCB7CiAgICAgICAgICBwYXJlbnQ6IG51bGwsCiAgICAgICAgICBuYW1lOiAncm91dGU6JyArIGVuY29kZVVSSUNvbXBvbmVudCh1cmwpLAogICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICBvbkVudGVyOiBvbkVudGVyUm91dGUsCiAgICAgICAgICBvbkV4aXQ6IG9uRXhpdFJvdXRlCiAgICAgICAgfSkpOwogICAgICB9CiAgICAgIHJvdXRlcy5wdXNoKHJvdXRlKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLyoKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIHVpLnJvdXRlci5jb21wYXQuJHJvdXRlCiAgICAgKgogICAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICAgKiBAcmVxdWlyZXMgJHJvdXRlUGFyYW1zCiAgICAgKgogICAgICogQHByb3BlcnR5IHtvYmplY3R9IHJvdXRlcyAtIEFycmF5IG9mIHJlZ2lzdGVyZWQgcm91dGVzLgogICAgICogQHByb3BlcnR5IHtvYmplY3R9IHBhcmFtcyAtIEN1cnJlbnQgcm91dGUgcGFyYW1zIGFzIG9iamVjdC4KICAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjdXJyZW50IC0gTmFtZSBvZiB0aGUgY3VycmVudCByb3V0ZS4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRoZSBgJHJvdXRlYCBzZXJ2aWNlIHByb3ZpZGVzIGludGVyZmFjZXMgdG8gYWNjZXNzIGRlZmluZWQgcm91dGVzLiBJdCBhbHNvIGxldCdzCiAgICAgKiB5b3UgYWNjZXNzIHJvdXRlIHBhcmFtcyB0aHJvdWdoIGAkcm91dGVQYXJhbXNgIHNlcnZpY2UsIHNvIHlvdSBoYXZlIGZ1bGx5CiAgICAgKiBjb250cm9sIG92ZXIgYWxsIHRoZSBzdHVmZiB5b3Ugd291bGQgYWN0dWFsbHkgZ2V0IGZyb20gYW5ndWxhcidzIGNvcmUgYCRyb3V0ZWAKICAgICAqIHNlcnZpY2UuCiAgICAgKi8KICAgIHRoaXMuJGdldCA9ICRnZXQ7CiAgICAkZ2V0LiRpbmplY3QgPSBbJyRzdGF0ZScsICckcm9vdFNjb3BlJywgJyRyb3V0ZVBhcmFtcyddOwogICAgZnVuY3Rpb24gJGdldCggICAkc3RhdGUsICAgJHJvb3RTY29wZSwgICAkcm91dGVQYXJhbXMpIHsKCiAgICAgIHZhciAkcm91dGUgPSB7CiAgICAgICAgcm91dGVzOiByb3V0ZXMsCiAgICAgICAgcGFyYW1zOiAkcm91dGVQYXJhbXMsCiAgICAgICAgY3VycmVudDogdW5kZWZpbmVkCiAgICAgIH07CgogICAgICBmdW5jdGlvbiBzdGF0ZUFzUm91dGUoc3RhdGUpIHsKICAgICAgICByZXR1cm4gKHN0YXRlLm5hbWUgIT09ICcnKSA/IHN0YXRlIDogdW5kZWZpbmVkOwogICAgICB9CgogICAgICAkcm9vdFNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3RhcnQnLCBmdW5jdGlvbiAoZXYsIHRvLCB0b1BhcmFtcywgZnJvbSwgZnJvbVBhcmFtcykgewogICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlQ2hhbmdlU3RhcnQnLCBzdGF0ZUFzUm91dGUodG8pLCBzdGF0ZUFzUm91dGUoZnJvbSkpOwogICAgICB9KTsKCiAgICAgICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdWNjZXNzJywgZnVuY3Rpb24gKGV2LCB0bywgdG9QYXJhbXMsIGZyb20sIGZyb21QYXJhbXMpIHsKICAgICAgICAkcm91dGUuY3VycmVudCA9IHN0YXRlQXNSb3V0ZSh0byk7CiAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckcm91dGVDaGFuZ2VTdWNjZXNzJywgc3RhdGVBc1JvdXRlKHRvKSwgc3RhdGVBc1JvdXRlKGZyb20pKTsKICAgICAgICBjb3B5KHRvUGFyYW1zLCAkcm91dGUucGFyYW1zKTsKICAgICAgfSk7CgogICAgICAkcm9vdFNjb3BlLiRvbignJHN0YXRlQ2hhbmdlRXJyb3InLCBmdW5jdGlvbiAoZXYsIHRvLCB0b1BhcmFtcywgZnJvbSwgZnJvbVBhcmFtcywgZXJyb3IpIHsKICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRyb3V0ZUNoYW5nZUVycm9yJywgc3RhdGVBc1JvdXRlKHRvKSwgc3RhdGVBc1JvdXRlKGZyb20pLCBlcnJvcik7CiAgICAgIH0pOwoKICAgICAgcmV0dXJuICRyb3V0ZTsKICAgIH0KICB9CgogIGFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIuY29tcGF0JykKICAgIC5wcm92aWRlcignJHJvdXRlJywgJFJvdXRlUHJvdmlkZXIpCiAgICAuZGlyZWN0aXZlKCduZ1ZpZXcnLCAkVmlld0RpcmVjdGl2ZSk7Cn0pKHdpbmRvdywgd2luZG93LmFuZ3VsYXIpOwovKiEKICogaW9uaWMuYnVuZGxlLmpzIGlzIGEgY29uY2F0ZW5hdGlvbiBvZjoKICogaW9uaWMuanMsIGFuZ3VsYXIuanMsIGFuZ3VsYXItYW5pbWF0ZS5qcywKICogYW5ndWxhci1zYW5pdGl6ZS5qcywgYW5ndWxhci11aS1yb3V0ZXIuanMsCiAqIGFuZCBpb25pYy1hbmd1bGFyLmpzCiAqLwoKLyohCiAqIENvcHlyaWdodCAyMDE0IERyaWZ0eSBDby4KICogaHR0cDovL2RyaWZ0eS5jb20vCiAqCiAqIElvbmljLCB2MS4wLjAtYmV0YS4xMQogKiBBIHBvd2VyZnVsIEhUTUw1IG1vYmlsZSBhcHAgZnJhbWV3b3JrLgogKiBodHRwOi8vaW9uaWNmcmFtZXdvcmsuY29tLwogKgogKiBCeSBAbWF4bHluY2gsIEBiZW5qc3BlcnJ5LCBAYWRhbWRicmFkbGV5IDwzCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4gUGxlYXNlIHNlZSBMSUNFTlNFIGZvciBtb3JlIGluZm9ybWF0aW9uLgogKgogKi8KCihmdW5jdGlvbigpIHsKICAvKgogICAqIGRlcHJlY2F0ZWQuanMKICAgKiBodHRwczovL2dpdGh1Yi5jb20vd2VhcmVmcmFjdGFsL2RlcHJlY2F0ZWQvCiAgICogQ29weXJpZ2h0IChjKSAyMDE0IEZyYWN0YWwgPGNvbnRhY3RAd2VhcmVmcmFjdGFsLmNvbT4KICAgKiBMaWNlbnNlIE1JVAogICAqLwovL0ludGVydmFsIG9iamVjdAogIHZhciBkZXByZWNhdGVkID0gewogICAgbWV0aG9kOiBmdW5jdGlvbihtc2csIGxvZywgZm4pIHsKICAgICAgdmFyIGNhbGxlZCA9IGZhbHNlOwogICAgICByZXR1cm4gZnVuY3Rpb24gZGVwcmVjYXRlZE1ldGhvZCgpewogICAgICAgIGlmICghY2FsbGVkKSB7CiAgICAgICAgICBjYWxsZWQgPSB0cnVlOwogICAgICAgICAgbG9nKG1zZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfSwKCiAgICBmaWVsZDogZnVuY3Rpb24obXNnLCBsb2csIHBhcmVudCwgZmllbGQsIHZhbCkgewogICAgICB2YXIgY2FsbGVkID0gZmFsc2U7CiAgICAgIHZhciBnZXR0ZXIgPSBmdW5jdGlvbigpewogICAgICAgIGlmICghY2FsbGVkKSB7CiAgICAgICAgICBjYWxsZWQgPSB0cnVlOwogICAgICAgICAgbG9nKG1zZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWw7CiAgICAgIH07CiAgICAgIHZhciBzZXR0ZXIgPSBmdW5jdGlvbih2KSB7CiAgICAgICAgaWYgKCFjYWxsZWQpIHsKICAgICAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgICAgICBsb2cobXNnKTsKICAgICAgICB9CiAgICAgICAgdmFsID0gdjsKICAgICAgICByZXR1cm4gdjsKICAgICAgfTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHBhcmVudCwgZmllbGQsIHsKICAgICAgICBnZXQ6IGdldHRlciwKICAgICAgICBzZXQ6IHNldHRlciwKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgIH0pOwogICAgICByZXR1cm47CiAgICB9CiAgfTsKCgogIHZhciBJb25pY01vZHVsZSA9IGFuZ3VsYXIubW9kdWxlKCdpb25pYycsIFsnbmdBbmltYXRlJywgJ25nU2FuaXRpemUnLCAndWkucm91dGVyJ10pLAogICAgZXh0ZW5kID0gYW5ndWxhci5leHRlbmQsCiAgICBmb3JFYWNoID0gYW5ndWxhci5mb3JFYWNoLAogICAgaXNEZWZpbmVkID0gYW5ndWxhci5pc0RlZmluZWQsCiAgICBpc1N0cmluZyA9IGFuZ3VsYXIuaXNTdHJpbmcsCiAgICBqcUxpdGUgPSBhbmd1bGFyLmVsZW1lbnQ7CgoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRpb25pY0FjdGlvblNoZWV0CiAgICogQG1vZHVsZSBpb25pYwogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBBY3Rpb24gU2hlZXQgaXMgYSBzbGlkZS11cCBwYW5lIHRoYXQgbGV0cyB0aGUgdXNlciBjaG9vc2UgZnJvbSBhIHNldCBvZiBvcHRpb25zLgogICAqIERhbmdlcm91cyBvcHRpb25zIGFyZSBoaWdobGlnaHRlZCBpbiByZWQgYW5kIG1hZGUgb2J2aW91cy4KICAgKgogICAqIFRoZXJlIGFyZSBlYXN5IHdheXMgdG8gY2FuY2VsIG91dCBvZiB0aGUgYWN0aW9uIHNoZWV0LCBzdWNoIGFzIHRhcHBpbmcgdGhlIGJhY2tkcm9wIG9yIGV2ZW4KICAgKiBoaXR0aW5nIGVzY2FwZSBvbiB0aGUga2V5Ym9hcmQgZm9yIGRlc2t0b3AgdGVzdGluZy4KICAgKgogICAqICFbQWN0aW9uIFNoZWV0XShodHRwOi8vaW9uaWNmcmFtZXdvcmsuY29tLnMzLmFtYXpvbmF3cy5jb20vZG9jcy9jb250cm9sbGVycy9hY3Rpb25TaGVldC5naWYpCiAgICoKICAgKiBAdXNhZ2UKICAgKiBUbyB0cmlnZ2VyIGFuIEFjdGlvbiBTaGVldCBpbiB5b3VyIGNvZGUsIHVzZSB0aGUgJGlvbmljQWN0aW9uU2hlZXQgc2VydmljZSBpbiB5b3VyIGFuZ3VsYXIgY29udHJvbGxlcnM6CiAgICoKICAgKiBgYGBqcwogICAqIGFuZ3VsYXIubW9kdWxlKCdteVN1cGVyQXBwJywgWydpb25pYyddKQogICAqIC5jb250cm9sbGVyKGZ1bmN0aW9uKCRzY29wZSwgJGlvbmljQWN0aW9uU2hlZXQsICR0aW1lb3V0KSB7CiAqCiAqICAvLyBUcmlnZ2VyZWQgb24gYSBidXR0b24gY2xpY2ssIG9yIHNvbWUgb3RoZXIgdGFyZ2V0CiAqICAkc2NvcGUuc2hvdyA9IGZ1bmN0aW9uKCkgewogKgogKiAgICAvLyBTaG93IHRoZSBhY3Rpb24gc2hlZXQKICogICAgdmFyIGhpZGVTaGVldCA9ICRpb25pY0FjdGlvblNoZWV0LnNob3coewogKiAgICAgIGJ1dHRvbnM6IFsKICogICAgICAgIHsgdGV4dDogJzxiPlNoYXJlPC9iPiBUaGlzJyB9LAogKiAgICAgICAgeyB0ZXh0OiAnTW92ZScgfQogKiAgICAgIF0sCiAqICAgICAgZGVzdHJ1Y3RpdmVUZXh0OiAnRGVsZXRlJywKICogICAgICB0aXRsZVRleHQ6ICdNb2RpZnkgeW91ciBhbGJ1bScsCiAqICAgICAgY2FuY2VsVGV4dDogJ0NhbmNlbCcsCiAqICAgICAgY2FuY2VsOiBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIGFkZCBjYW5jZWwgY29kZS4uCiAgICAgICAgfSwKICogICAgICBidXR0b25DbGlja2VkOiBmdW5jdGlvbihpbmRleCkgewogKiAgICAgICAgcmV0dXJuIHRydWU7CiAqICAgICAgfQogKiAgICB9KTsKICoKICogICAgLy8gRm9yIGV4YW1wbGUncyBzYWtlLCBoaWRlIHRoZSBzaGVldCBhZnRlciB0d28gc2Vjb25kcwogKiAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICogICAgICBoaWRlU2hlZXQoKTsKICogICAgfSwgMjAwMCk7CiAqCiAqICB9OwogKiB9KTsKICAgKiBgYGAKICAgKgogICAqLwogIElvbmljTW9kdWxlCiAgICAuZmFjdG9yeSgnJGlvbmljQWN0aW9uU2hlZXQnLCBbCiAgICAgICckcm9vdFNjb3BlJywKICAgICAgJyRkb2N1bWVudCcsCiAgICAgICckY29tcGlsZScsCiAgICAgICckYW5pbWF0ZScsCiAgICAgICckdGltZW91dCcsCiAgICAgICckaW9uaWNUZW1wbGF0ZUxvYWRlcicsCiAgICAgICckaW9uaWNQbGF0Zm9ybScsCiAgICAgIGZ1bmN0aW9uKCRyb290U2NvcGUsICRkb2N1bWVudCwgJGNvbXBpbGUsICRhbmltYXRlLCAkdGltZW91dCwgJGlvbmljVGVtcGxhdGVMb2FkZXIsICRpb25pY1BsYXRmb3JtKSB7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBzaG93OiBhY3Rpb25TaGVldAogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkaW9uaWNBY3Rpb25TaGVldCNzaG93CiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogTG9hZCBhbmQgcmV0dXJuIGEgbmV3IGFjdGlvbiBzaGVldC4KICAgICAgICAgKgogICAgICAgICAqIEEgbmV3IGlzb2xhdGVkIHNjb3BlIHdpbGwgYmUgY3JlYXRlZCBmb3IgdGhlCiAgICAgICAgICogYWN0aW9uIHNoZWV0IGFuZCB0aGUgbmV3IGVsZW1lbnQgd2lsbCBiZSBhcHBlbmRlZCBpbnRvIHRoZSBib2R5LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgZm9yIHRoaXMgQWN0aW9uU2hlZXQuIFByb3BlcnRpZXM6CiAgICAgICAgICoKICAgICAgICAgKiAgLSBgW09iamVjdF1gIGBidXR0b25zYCBXaGljaCBidXR0b25zIHRvIHNob3cuICBFYWNoIGJ1dHRvbiBpcyBhbiBvYmplY3Qgd2l0aCBhIGB0ZXh0YCBmaWVsZC4KICAgICAgICAgKiAgLSBge3N0cmluZ31gIGB0aXRsZVRleHRgIFRoZSB0aXRsZSB0byBzaG93IG9uIHRoZSBhY3Rpb24gc2hlZXQuCiAgICAgICAgICogIC0gYHtzdHJpbmc9fWAgYGNhbmNlbFRleHRgIHRoZSB0ZXh0IGZvciBhICdjYW5jZWwnIGJ1dHRvbiBvbiB0aGUgYWN0aW9uIHNoZWV0LgogICAgICAgICAqICAtIGB7c3RyaW5nPX1gIGBkZXN0cnVjdGl2ZVRleHRgIFRoZSB0ZXh0IGZvciBhICdkYW5nZXInIG9uIHRoZSBhY3Rpb24gc2hlZXQuCiAgICAgICAgICogIC0gYHtmdW5jdGlvbj19YCBgY2FuY2VsYCBDYWxsZWQgaWYgdGhlIGNhbmNlbCBidXR0b24gaXMgcHJlc3NlZCwgdGhlIGJhY2tkcm9wIGlzIHRhcHBlZCBvcgogICAgICAgICAqICAgICB0aGUgaGFyZHdhcmUgYmFjayBidXR0b24gaXMgcHJlc3NlZC4KICAgICAgICAgKiAgLSBge2Z1bmN0aW9uPX1gIGBidXR0b25DbGlja2VkYCBDYWxsZWQgd2hlbiBvbmUgb2YgdGhlIG5vbi1kZXN0cnVjdGl2ZSBidXR0b25zIGlzIGNsaWNrZWQsCiAgICAgICAgICogICAgIHdpdGggdGhlIGluZGV4IG9mIHRoZSBidXR0b24gdGhhdCB3YXMgY2xpY2tlZCBhbmQgdGhlIGJ1dHRvbiBvYmplY3QuIFJldHVybiB0cnVlIHRvIGNsb3NlCiAgICAgICAgICogICAgIHRoZSBhY3Rpb24gc2hlZXQsIG9yIGZhbHNlIHRvIGtlZXAgaXQgb3BlbmVkLgogICAgICAgICAqICAtIGB7ZnVuY3Rpb249fWAgYGRlc3RydWN0aXZlQnV0dG9uQ2xpY2tlZGAgQ2FsbGVkIHdoZW4gdGhlIGRlc3RydWN0aXZlIGJ1dHRvbiBpcyBjbGlja2VkLgogICAgICAgICAqICAgICBSZXR1cm4gdHJ1ZSB0byBjbG9zZSB0aGUgYWN0aW9uIHNoZWV0LCBvciBmYWxzZSB0byBrZWVwIGl0IG9wZW5lZC4KICAgICAgICAgKiAgLSAgYHtib29sZWFuPX1gIGBjYW5jZWxPblN0YXRlQ2hhbmdlYCBXaGV0aGVyIHRvIGNhbmNlbCB0aGUgYWN0aW9uU2hlZXQgd2hlbiBuYXZpZ2F0aW5nCiAgICAgICAgICogICAgIHRvIGEgbmV3IHN0YXRlLiAgRGVmYXVsdCB0cnVlLgogICAgICAgICAqCiAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9ufSBgaGlkZVNoZWV0YCBBIGZ1bmN0aW9uIHdoaWNoLCB3aGVuIGNhbGxlZCwgaGlkZXMgJiBjYW5jZWxzIHRoZSBhY3Rpb24gc2hlZXQuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gYWN0aW9uU2hlZXQob3B0cykgewogICAgICAgICAgdmFyIHNjb3BlID0gJHJvb3RTY29wZS4kbmV3KHRydWUpOwoKICAgICAgICAgIGFuZ3VsYXIuZXh0ZW5kKHNjb3BlLCB7CiAgICAgICAgICAgIGNhbmNlbDogYW5ndWxhci5ub29wLAogICAgICAgICAgICBkZXN0cnVjdGl2ZUJ1dHRvbkNsaWNrZWQ6IGFuZ3VsYXIubm9vcCwKICAgICAgICAgICAgYnV0dG9uQ2xpY2tlZDogYW5ndWxhci5ub29wLAogICAgICAgICAgICAkZGVyZWdpc3RlckJhY2tCdXR0b246IGFuZ3VsYXIubm9vcCwKICAgICAgICAgICAgYnV0dG9uczogW10sCiAgICAgICAgICAgIGNhbmNlbE9uU3RhdGVDaGFuZ2U6IHRydWUKICAgICAgICAgIH0sIG9wdHMgfHwge30pOwoKCiAgICAgICAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZQogICAgICAgICAgdmFyIGVsZW1lbnQgPSBzY29wZS5lbGVtZW50ID0gJGNvbXBpbGUoJzxpb24tYWN0aW9uLXNoZWV0IGJ1dHRvbnM9ImJ1dHRvbnMiPjwvaW9uLWFjdGlvbi1zaGVldD4nKShzY29wZSk7CgogICAgICAgICAgLy8gR3JhYiB0aGUgc2hlZXQgZWxlbWVudCBmb3IgYW5pbWF0aW9uCiAgICAgICAgICB2YXIgc2hlZXRFbCA9IGpxTGl0ZShlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3IoJy5hY3Rpb24tc2hlZXQtd3JhcHBlcicpKTsKCiAgICAgICAgICB2YXIgc3RhdGVDaGFuZ2VMaXN0ZW5Eb25lID0gc2NvcGUuY2FuY2VsT25TdGF0ZUNoYW5nZSA/CiAgICAgICAgICAgICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdWNjZXNzJywgZnVuY3Rpb24oKSB7IHNjb3BlLmNhbmNlbCgpOyB9KSA6CiAgICAgICAgICAgIGFuZ3VsYXIubm9vcDsKCiAgICAgICAgICAvLyByZW1vdmVzIHRoZSBhY3Rpb25TaGVldCBmcm9tIHRoZSBzY3JlZW4KICAgICAgICAgIHNjb3BlLnJlbW92ZVNoZWV0ID0gZnVuY3Rpb24oZG9uZSkgewogICAgICAgICAgICBpZiAoc2NvcGUucmVtb3ZlZCkgcmV0dXJuOwoKICAgICAgICAgICAgc2NvcGUucmVtb3ZlZCA9IHRydWU7CiAgICAgICAgICAgIHNoZWV0RWwucmVtb3ZlQ2xhc3MoJ2FjdGlvbi1zaGVldC11cCcpOwogICAgICAgICAgICAkZG9jdW1lbnRbMF0uYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdhY3Rpb24tc2hlZXQtb3BlbicpOwogICAgICAgICAgICBzY29wZS4kZGVyZWdpc3RlckJhY2tCdXR0b24oKTsKICAgICAgICAgICAgc3RhdGVDaGFuZ2VMaXN0ZW5Eb25lKCk7CgogICAgICAgICAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCAnYWN0aXZlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgIC8vIHNjb3BlLmNhbmNlbC4kc2NvcGUgaXMgZGVmaW5lZCBuZWFyIHRoZSBib3R0b20KICAgICAgICAgICAgICBzY29wZS5jYW5jZWwuJHNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICAoZG9uZSB8fCBhbmd1bGFyLm5vb3ApKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKCiAgICAgICAgICBzY29wZS5zaG93U2hlZXQgPSBmdW5jdGlvbihkb25lKSB7CiAgICAgICAgICAgIGlmIChzY29wZS5yZW1vdmVkKSByZXR1cm47CgogICAgICAgICAgICAkZG9jdW1lbnRbMF0uYm9keS5hcHBlbmRDaGlsZChlbGVtZW50WzBdKTsKICAgICAgICAgICAgJGRvY3VtZW50WzBdLmJvZHkuY2xhc3NMaXN0LmFkZCgnYWN0aW9uLXNoZWV0LW9wZW4nKTsKCiAgICAgICAgICAgICRhbmltYXRlLmFkZENsYXNzKGVsZW1lbnQsICdhY3RpdmUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoc2NvcGUucmVtb3ZlZCkgcmV0dXJuOwogICAgICAgICAgICAgIChkb25lIHx8IGFuZ3VsYXIubm9vcCkoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgaWYgKHNjb3BlLnJlbW92ZWQpIHJldHVybjsKICAgICAgICAgICAgICBzaGVldEVsLmFkZENsYXNzKCdhY3Rpb24tc2hlZXQtdXAnKTsKICAgICAgICAgICAgfSwgMjAsIGZhbHNlKTsKICAgICAgICAgIH07CgogICAgICAgICAgLy8gcmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uIHJldHVybnMgYSBjYWxsYmFjayB0byBkZXJlZ2lzdGVyIHRoZSBhY3Rpb24KICAgICAgICAgIHNjb3BlLiRkZXJlZ2lzdGVyQmFja0J1dHRvbiA9ICRpb25pY1BsYXRmb3JtLnJlZ2lzdGVyQmFja0J1dHRvbkFjdGlvbigKICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgJHRpbWVvdXQoc2NvcGUuY2FuY2VsKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfQUNUSU9OX1NIRUVUCiAgICAgICAgICApOwoKICAgICAgICAgIC8vIGNhbGxlZCB3aGVuIHRoZSB1c2VyIHByZXNzZXMgdGhlIGNhbmNlbCBidXR0b24KICAgICAgICAgIHNjb3BlLmNhbmNlbCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBhZnRlciB0aGUgYW5pbWF0aW9uIGlzIG91dCwgY2FsbCB0aGUgY2FuY2VsIGNhbGxiYWNrCiAgICAgICAgICAgIHNjb3BlLnJlbW92ZVNoZWV0KG9wdHMuY2FuY2VsKTsKICAgICAgICAgIH07CgogICAgICAgICAgc2NvcGUuYnV0dG9uQ2xpY2tlZCA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBidXR0b24gY2xpY2sgZXZlbnQgcmV0dXJuZWQgdHJ1ZSwgd2hpY2ggbWVhbnMKICAgICAgICAgICAgLy8gd2UgY2FuIGNsb3NlIHRoZSBhY3Rpb24gc2hlZXQKICAgICAgICAgICAgaWYgKG9wdHMuYnV0dG9uQ2xpY2tlZChpbmRleCwgb3B0cy5idXR0b25zW2luZGV4XSkgPT09IHRydWUpIHsKICAgICAgICAgICAgICBzY29wZS5yZW1vdmVTaGVldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIHNjb3BlLmRlc3RydWN0aXZlQnV0dG9uQ2xpY2tlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgZGVzdHJ1Y3RpdmUgYnV0dG9uIGNsaWNrIGV2ZW50IHJldHVybmVkIHRydWUsIHdoaWNoIG1lYW5zCiAgICAgICAgICAgIC8vIHdlIGNhbiBjbG9zZSB0aGUgYWN0aW9uIHNoZWV0CiAgICAgICAgICAgIGlmIChvcHRzLmRlc3RydWN0aXZlQnV0dG9uQ2xpY2tlZCgpID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgc2NvcGUucmVtb3ZlU2hlZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICBzY29wZS5zaG93U2hlZXQoKTsKCiAgICAgICAgICAvLyBFeHBvc2UgdGhlIHNjb3BlIG9uICRpb25pY0FjdGlvblNoZWV0J3MgcmV0dXJuIHZhbHVlIGZvciB0aGUgc2FrZQogICAgICAgICAgLy8gb2YgdGVzdGluZyBpdC4KICAgICAgICAgIHNjb3BlLmNhbmNlbC4kc2NvcGUgPSBzY29wZTsKCiAgICAgICAgICByZXR1cm4gc2NvcGUuY2FuY2VsOwogICAgICAgIH0KICAgICAgfV0pOwoKCiAganFMaXRlLnByb3RvdHlwZS5hZGRDbGFzcyA9IGZ1bmN0aW9uKGNzc0NsYXNzZXMpIHsKICAgIHZhciB4LCB5LCBjc3NDbGFzcywgZWwsIHNwbGl0Q2xhc3NlcywgZXhpc3RpbmdDbGFzc2VzOwogICAgaWYgKGNzc0NsYXNzZXMgJiYgY3NzQ2xhc3NlcyAhPSAnbmctc2NvcGUnICYmIGNzc0NsYXNzZXMgIT0gJ25nLWlzb2xhdGUtc2NvcGUnKSB7CiAgICAgIGZvcih4PTA7IHg8dGhpcy5sZW5ndGg7IHgrKykgewogICAgICAgIGVsID0gdGhpc1t4XTsKICAgICAgICBpZihlbC5zZXRBdHRyaWJ1dGUpIHsKCiAgICAgICAgICBpZihjc3NDbGFzc2VzLmluZGV4T2YoJyAnKSA8IDApIHsKICAgICAgICAgICAgZWwuY2xhc3NMaXN0LmFkZChjc3NDbGFzc2VzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGV4aXN0aW5nQ2xhc3NlcyA9ICgnICcgKyAoZWwuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKSArICcgJykKICAgICAgICAgICAgICAucmVwbGFjZSgvW1xuXHRdL2csICIgIik7CiAgICAgICAgICAgIHNwbGl0Q2xhc3NlcyA9IGNzc0NsYXNzZXMuc3BsaXQoJyAnKTsKCiAgICAgICAgICAgIGZvciAoeT0wOyB5PHNwbGl0Q2xhc3Nlcy5sZW5ndGg7IHkrKykgewogICAgICAgICAgICAgIGNzc0NsYXNzID0gc3BsaXRDbGFzc2VzW3ldLnRyaW0oKTsKICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdDbGFzc2VzLmluZGV4T2YoJyAnICsgY3NzQ2xhc3MgKyAnICcpID09PSAtMSkgewogICAgICAgICAgICAgICAgZXhpc3RpbmdDbGFzc2VzICs9IGNzc0NsYXNzICsgJyAnOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgZXhpc3RpbmdDbGFzc2VzLnRyaW0oKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwoKICBqcUxpdGUucHJvdG90eXBlLnJlbW92ZUNsYXNzID0gZnVuY3Rpb24oY3NzQ2xhc3NlcykgewogICAgdmFyIHgsIHksIHNwbGl0Q2xhc3NlcywgY3NzQ2xhc3MsIGVsOwogICAgaWYgKGNzc0NsYXNzZXMpIHsKICAgICAgZm9yKHg9MDsgeDx0aGlzLmxlbmd0aDsgeCsrKSB7CiAgICAgICAgZWwgPSB0aGlzW3hdOwogICAgICAgIGlmKGVsLmdldEF0dHJpYnV0ZSkgewogICAgICAgICAgaWYoY3NzQ2xhc3Nlcy5pbmRleE9mKCcgJykgPCAwKSB7CiAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoY3NzQ2xhc3Nlcyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzcGxpdENsYXNzZXMgPSBjc3NDbGFzc2VzLnNwbGl0KCcgJyk7CgogICAgICAgICAgICBmb3IgKHk9MDsgeTxzcGxpdENsYXNzZXMubGVuZ3RoOyB5KyspIHsKICAgICAgICAgICAgICBjc3NDbGFzcyA9IHNwbGl0Q2xhc3Nlc1t5XTsKICAgICAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgKAogICAgICAgICAgICAgICAgICAoIiAiICsgKGVsLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICIpCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcblx0XS9nLCAiICIpCiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoIiAiICsgY3NzQ2xhc3MudHJpbSgpICsgIiAiLCAiICIpKS50cmltKCkKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRpb25pY0JhY2tkcm9wCiAgICogQG1vZHVsZSBpb25pYwogICAqIEBkZXNjcmlwdGlvbgogICAqIFNob3dzIGFuZCBoaWRlcyBhIGJhY2tkcm9wIG92ZXIgdGhlIFVJLiAgQXBwZWFycyBiZWhpbmQgcG9wdXBzLCBsb2FkaW5nLAogICAqIGFuZCBvdGhlciBvdmVybGF5cy4KICAgKgogICAqIE9mdGVuLCBtdWx0aXBsZSBVSSBjb21wb25lbnRzIHJlcXVpcmUgYSBiYWNrZHJvcCwgYnV0IG9ubHkgb25lIGJhY2tkcm9wIGlzCiAgICogZXZlciBuZWVkZWQgaW4gdGhlIERPTSBhdCBhIHRpbWUuCiAgICoKICAgKiBUaGVyZWZvcmUsIGVhY2ggY29tcG9uZW50IHRoYXQgcmVxdWlyZXMgdGhlIGJhY2tkcm9wIHRvIGJlIHNob3duIGNhbGxzCiAgICogYCRpb25pY0JhY2tkcm9wLnJldGFpbigpYCB3aGVuIGl0IHdhbnRzIHRoZSBiYWNrZHJvcCwgdGhlbiBgJGlvbmljQmFja2Ryb3AucmVsZWFzZSgpYAogICAqIHdoZW4gaXQgaXMgZG9uZSB3aXRoIHRoZSBiYWNrZHJvcC4KICAgKgogICAqIEZvciBlYWNoIHRpbWUgYHJldGFpbmAgaXMgY2FsbGVkLCB0aGUgYmFja2Ryb3Agd2lsbCBiZSBzaG93biB1bnRpbCBgcmVsZWFzZWAgaXMgY2FsbGVkLgogICAqCiAgICogRm9yIGV4YW1wbGUsIGlmIGByZXRhaW5gIGlzIGNhbGxlZCB0aHJlZSB0aW1lcywgdGhlIGJhY2tkcm9wIHdpbGwgYmUgc2hvd24gdW50aWwgYHJlbGVhc2VgCiAgICogaXMgY2FsbGVkIHRocmVlIHRpbWVzLgogICAqCiAgICogQHVzYWdlCiAgICoKICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIE15Q29udHJvbGxlcigkc2NvcGUsICRpb25pY0JhY2tkcm9wLCAkdGltZW91dCkgewogKiAgIC8vU2hvdyBhIGJhY2tkcm9wIGZvciBvbmUgc2Vjb25kCiAqICAgJHNjb3BlLmFjdGlvbiA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljQmFja2Ryb3AucmV0YWluKCk7CiAqICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICogICAgICAgJGlvbmljQmFja2Ryb3AucmVsZWFzZSgpOwogKiAgICAgfSwgMTAwMCk7CiAqICAgfTsKICogfQogICAqIGBgYAogICAqLwogIElvbmljTW9kdWxlCiAgICAuZmFjdG9yeSgnJGlvbmljQmFja2Ryb3AnLCBbCiAgICAgICckZG9jdW1lbnQnLCAnJHRpbWVvdXQnLAogICAgICBmdW5jdGlvbigkZG9jdW1lbnQsICR0aW1lb3V0KSB7CgogICAgICAgIHZhciBlbCA9IGpxTGl0ZSgnPGRpdiBjbGFzcz0iYmFja2Ryb3AiPicpOwogICAgICAgIHZhciBiYWNrZHJvcEhvbGRzID0gMDsKCiAgICAgICAgJGRvY3VtZW50WzBdLmJvZHkuYXBwZW5kQ2hpbGQoZWxbMF0pOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNCYWNrZHJvcCNyZXRhaW4KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbiBSZXRhaW5zIHRoZSBiYWNrZHJvcC4KICAgICAgICAgICAqLwogICAgICAgICAgcmV0YWluOiByZXRhaW4sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRpb25pY0JhY2tkcm9wI3JlbGVhc2UKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogUmVsZWFzZXMgdGhlIGJhY2tkcm9wLgogICAgICAgICAgICovCiAgICAgICAgICByZWxlYXNlOiByZWxlYXNlLAoKICAgICAgICAgIGdldEVsZW1lbnQ6IGdldEVsZW1lbnQsCgogICAgICAgICAgLy8gZXhwb3NlZCBmb3IgdGVzdGluZwogICAgICAgICAgX2VsZW1lbnQ6IGVsCiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gcmV0YWluKCkgewogICAgICAgICAgaWYgKCAoKytiYWNrZHJvcEhvbGRzKSA9PT0gMSApIHsKICAgICAgICAgICAgZWwuYWRkQ2xhc3MoJ3Zpc2libGUnKTsKICAgICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGJhY2tkcm9wSG9sZHMgJiYgZWwuYWRkQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVsZWFzZSgpIHsKICAgICAgICAgIGlmICggKC0tYmFja2Ryb3BIb2xkcykgPT09IDAgKSB7CiAgICAgICAgICAgIGVsLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsKICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgIWJhY2tkcm9wSG9sZHMgJiYgZWwucmVtb3ZlQ2xhc3MoJ3Zpc2libGUnKTsKICAgICAgICAgICAgfSwgNDAwLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBnZXRFbGVtZW50KCkgewogICAgICAgICAgcmV0dXJuIGVsOwogICAgICAgIH0KCiAgICAgIH1dKTsKCiAgLyoqCiAgICogQHByaXZhdGUKICAgKi8KICBJb25pY01vZHVsZQogICAgLmZhY3RvcnkoJyRpb25pY0JpbmQnLCBbJyRwYXJzZScsICckaW50ZXJwb2xhdGUnLCBmdW5jdGlvbigkcGFyc2UsICRpbnRlcnBvbGF0ZSkgewogICAgICB2YXIgTE9DQUxfUkVHRVhQID0gL15ccyooW0A9Jl0pKFw/PylccyooXHcqKVxzKiQvOwogICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGF0dHJzLCBiaW5kRGVmaW5pdGlvbikgewogICAgICAgIGZvckVhY2goYmluZERlZmluaXRpb24gfHwge30sIGZ1bmN0aW9uIChkZWZpbml0aW9uLCBzY29wZU5hbWUpIHsKICAgICAgICAgIC8vQWRhcHRlZCBmcm9tIGFuZ3VsYXIuanMgJGNvbXBpbGUKICAgICAgICAgIHZhciBtYXRjaCA9IGRlZmluaXRpb24ubWF0Y2goTE9DQUxfUkVHRVhQKSB8fCBbXSwKICAgICAgICAgICAgYXR0ck5hbWUgPSBtYXRjaFszXSB8fCBzY29wZU5hbWUsCiAgICAgICAgICAgIG1vZGUgPSBtYXRjaFsxXSwgLy8gQCwgPSwgb3IgJgogICAgICAgICAgICBwYXJlbnRHZXQsCiAgICAgICAgICAgIHVud2F0Y2g7CgogICAgICAgICAgc3dpdGNoKG1vZGUpIHsKICAgICAgICAgICAgY2FzZSAnQCc6CiAgICAgICAgICAgICAgaWYgKCFhdHRyc1thdHRyTmFtZV0pIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXR0cnMuJG9ic2VydmUoYXR0ck5hbWUsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgLy8gd2UgdHJpZ2dlciBhbiBpbnRlcnBvbGF0aW9uIHRvIGVuc3VyZQogICAgICAgICAgICAgIC8vIHRoZSB2YWx1ZSBpcyB0aGVyZSBmb3IgdXNlIGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgaWYgKGF0dHJzW2F0dHJOYW1lXSkgewogICAgICAgICAgICAgICAgc2NvcGVbc2NvcGVOYW1lXSA9ICRpbnRlcnBvbGF0ZShhdHRyc1thdHRyTmFtZV0pKHNjb3BlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlICc9JzoKICAgICAgICAgICAgICBpZiAoIWF0dHJzW2F0dHJOYW1lXSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1bndhdGNoID0gc2NvcGUuJHdhdGNoKGF0dHJzW2F0dHJOYW1lXSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHNjb3BlW3Njb3BlTmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAvL0Rlc3Ryb3kgcGFyZW50IHNjb3BlIHdhdGNoZXIgd2hlbiB0aGlzIHNjb3BlIGlzIGRlc3Ryb3llZAogICAgICAgICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCB1bndhdGNoKTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJyYnOgogICAgICAgICAgICAgIC8qIGpzaGludCAtVzA0NCAqLwogICAgICAgICAgICAgIGlmIChhdHRyc1thdHRyTmFtZV0gJiYgYXR0cnNbYXR0ck5hbWVdLm1hdGNoKFJlZ0V4cChzY29wZU5hbWUgKyAnXCguKj9cKScpKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCcmIGV4cHJlc3Npb24gYmluZGluZyAiJyArIHNjb3BlTmFtZSArICciIGxvb2tzIGxpa2UgaXQgd2lsbCByZWN1cnNpdmVseSBjYWxsICInICsKICAgICAgICAgICAgICAgICAgYXR0cnNbYXR0ck5hbWVdICsgJyIgYW5kIGNhdXNlIGEgc3RhY2sgb3ZlcmZsb3chIFBsZWFzZSBjaG9vc2UgYSBkaWZmZXJlbnQgc2NvcGVOYW1lLicpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRHZXQgPSAkcGFyc2UoYXR0cnNbYXR0ck5hbWVdKTsKICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gZnVuY3Rpb24obG9jYWxzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50R2V0KHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9XSk7CgogIElvbmljTW9kdWxlCiAgICAuZmFjdG9yeSgnJGNvbGxlY3Rpb25EYXRhU291cmNlJywgWwogICAgICAnJGNhY2hlRmFjdG9yeScsCiAgICAgICckcGFyc2UnLAogICAgICAnJHJvb3RTY29wZScsCiAgICAgIGZ1bmN0aW9uKCRjYWNoZUZhY3RvcnksICRwYXJzZSwgJHJvb3RTY29wZSkgewogICAgICAgIGZ1bmN0aW9uIGhpZGVXaXRoVHJhbnNmb3JtKGVsZW1lbnQpIHsKICAgICAgICAgIGVsZW1lbnQuY3NzKGlvbmljLkNTUy5UUkFOU0ZPUk0sICd0cmFuc2xhdGUzZCgtMjAwMHB4LC0yMDAwcHgsMCknKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIENvbGxlY3Rpb25SZXBlYXREYXRhU291cmNlKG9wdGlvbnMpIHsKICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgIHRoaXMuc2NvcGUgPSBvcHRpb25zLnNjb3BlOwogICAgICAgICAgdGhpcy50cmFuc2NsdWRlRm4gPSBvcHRpb25zLnRyYW5zY2x1ZGVGbjsKICAgICAgICAgIHRoaXMudHJhbnNjbHVkZVBhcmVudCA9IG9wdGlvbnMudHJhbnNjbHVkZVBhcmVudDsKICAgICAgICAgIHRoaXMuZWxlbWVudCA9IG9wdGlvbnMuZWxlbWVudDsKCiAgICAgICAgICB0aGlzLmtleUV4cHIgPSBvcHRpb25zLmtleUV4cHI7CiAgICAgICAgICB0aGlzLmxpc3RFeHByID0gb3B0aW9ucy5saXN0RXhwcjsKICAgICAgICAgIHRoaXMudHJhY2tCeUV4cHIgPSBvcHRpb25zLnRyYWNrQnlFeHByOwoKICAgICAgICAgIHRoaXMuaGVpZ2h0R2V0dGVyID0gb3B0aW9ucy5oZWlnaHRHZXR0ZXI7CiAgICAgICAgICB0aGlzLndpZHRoR2V0dGVyID0gb3B0aW9ucy53aWR0aEdldHRlcjsKCiAgICAgICAgICB0aGlzLmRpbWVuc2lvbnMgPSBbXTsKICAgICAgICAgIHRoaXMuZGF0YSA9IFtdOwoKICAgICAgICAgIGlmICh0aGlzLnRyYWNrQnlFeHByKSB7CiAgICAgICAgICAgIHZhciB0cmFja0J5R2V0dGVyID0gJHBhcnNlKHRoaXMudHJhY2tCeUV4cHIpOwogICAgICAgICAgICB2YXIgaGFzaEZuTG9jYWxzID0geyRpZDogaGFzaEtleX07CiAgICAgICAgICAgIHRoaXMuaXRlbUhhc2hHZXR0ZXIgPSBmdW5jdGlvbihpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgICBoYXNoRm5Mb2NhbHNbc2VsZi5rZXlFeHByXSA9IHZhbHVlOwogICAgICAgICAgICAgIGhhc2hGbkxvY2Fscy4kaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICByZXR1cm4gdHJhY2tCeUdldHRlcihzZWxmLnNjb3BlLCBoYXNoRm5Mb2NhbHMpOwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5pdGVtSGFzaEdldHRlciA9IGZ1bmN0aW9uKGluZGV4LCB2YWx1ZSkgewogICAgICAgICAgICAgIHJldHVybiBoYXNoS2V5KHZhbHVlKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLmF0dGFjaGVkSXRlbXMgPSB7fTsKICAgICAgICAgIHRoaXMuQkFDS1VQX0lURU1TX0xFTkdUSCA9IDEwOwogICAgICAgICAgdGhpcy5iYWNrdXBJdGVtc0FycmF5ID0gW107CiAgICAgICAgfQogICAgICAgIENvbGxlY3Rpb25SZXBlYXREYXRhU291cmNlLnByb3RvdHlwZSA9IHsKICAgICAgICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLkJBQ0tVUF9JVEVNU19MRU5HVEg7IGkrKykgewogICAgICAgICAgICAgIHRoaXMuZGV0YWNoSXRlbSh0aGlzLmNyZWF0ZUl0ZW0oKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5kaW1lbnNpb25zLmxlbmd0aCA9IDA7CiAgICAgICAgICAgIHRoaXMuZGF0YSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYmFja3VwSXRlbXNBcnJheS5sZW5ndGggPSAwOwogICAgICAgICAgICB0aGlzLmF0dGFjaGVkSXRlbXMgPSB7fTsKICAgICAgICAgIH0sCiAgICAgICAgICBjYWxjdWxhdGVEYXRhRGltZW5zaW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBsb2NhbHMgPSB7fTsKICAgICAgICAgICAgdGhpcy5kaW1lbnNpb25zID0gdGhpcy5kYXRhLm1hcChmdW5jdGlvbih2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgICBsb2NhbHNbdGhpcy5rZXlFeHByXSA9IHZhbHVlOwogICAgICAgICAgICAgIGxvY2Fscy4kaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgd2lkdGg6IHRoaXMud2lkdGhHZXR0ZXIodGhpcy5zY29wZSwgbG9jYWxzKSwKICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5oZWlnaHRHZXR0ZXIodGhpcy5zY29wZSwgbG9jYWxzKQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgICB0aGlzLmRpbWVuc2lvbnMgPSB0aGlzLmJlZm9yZVNpYmxpbmdzLmNvbmNhdCh0aGlzLmRpbWVuc2lvbnMpLmNvbmNhdCh0aGlzLmFmdGVyU2libGluZ3MpOwogICAgICAgICAgICB0aGlzLmRhdGFTdGFydEluZGV4ID0gdGhpcy5iZWZvcmVTaWJsaW5ncy5sZW5ndGg7CiAgICAgICAgICB9LAogICAgICAgICAgY3JlYXRlSXRlbTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBpdGVtID0ge307CiAgICAgICAgICAgIGl0ZW0uc2NvcGUgPSB0aGlzLnNjb3BlLiRuZXcoKTsKCiAgICAgICAgICAgIHRoaXMudHJhbnNjbHVkZUZuKGl0ZW0uc2NvcGUsIGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgICAgICAgY2xvbmUuY3NzKCdwb3NpdGlvbicsICdhYnNvbHV0ZScpOwogICAgICAgICAgICAgIGl0ZW0uZWxlbWVudCA9IGNsb25lOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMudHJhbnNjbHVkZVBhcmVudC5hcHBlbmQoaXRlbS5lbGVtZW50KTsKCiAgICAgICAgICAgIHJldHVybiBpdGVtOwogICAgICAgICAgfSwKICAgICAgICAgIGdldEl0ZW06IGZ1bmN0aW9uKGhhc2gpIHsKICAgICAgICAgICAgaWYgKCAoaXRlbSA9IHRoaXMuYXR0YWNoZWRJdGVtc1toYXNoXSkgKSB7CiAgICAgICAgICAgICAgLy9kbyBub3RoaW5nLCB0aGUgaXRlbSBpcyBnb29kCiAgICAgICAgICAgIH0gZWxzZSBpZiAoIChpdGVtID0gdGhpcy5iYWNrdXBJdGVtc0FycmF5LnBvcCgpKSApIHsKICAgICAgICAgICAgICByZWNvbm5lY3RTY29wZShpdGVtLnNjb3BlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpdGVtID0gdGhpcy5jcmVhdGVJdGVtKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGl0ZW07CiAgICAgICAgICB9LAogICAgICAgICAgYXR0YWNoSXRlbUF0SW5kZXg6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHRoaXMuZGF0YVtpbmRleF07CgogICAgICAgICAgICBpZiAoaW5kZXggPCB0aGlzLmRhdGFTdGFydEluZGV4KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmVmb3JlU2libGluZ3NbaW5kZXhdOwogICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID4gdGhpcy5kYXRhLmxlbmd0aCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLmFmdGVyU2libGluZ3NbaW5kZXggLSB0aGlzLmRhdGEubGVuZ3RoIC0gdGhpcy5kYXRhU3RhcnRJbmRleF07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBoYXNoID0gdGhpcy5pdGVtSGFzaEdldHRlcihpbmRleCwgdmFsdWUpOwogICAgICAgICAgICB2YXIgaXRlbSA9IHRoaXMuZ2V0SXRlbShoYXNoKTsKCiAgICAgICAgICAgIGlmIChpdGVtLnNjb3BlLiRpbmRleCAhPT0gaW5kZXggfHwgaXRlbS5zY29wZVt0aGlzLmtleUV4cHJdICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgIGl0ZW0uc2NvcGVbdGhpcy5rZXlFeHByXSA9IHZhbHVlOwogICAgICAgICAgICAgIGl0ZW0uc2NvcGUuJGluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgICAgaXRlbS5zY29wZS4kZmlyc3QgPSAoaW5kZXggPT09IDApOwogICAgICAgICAgICAgIGl0ZW0uc2NvcGUuJGxhc3QgPSAoaW5kZXggPT09ICh0aGlzLmdldExlbmd0aCgpIC0gMSkpOwogICAgICAgICAgICAgIGl0ZW0uc2NvcGUuJG1pZGRsZSA9ICEoaXRlbS5zY29wZS4kZmlyc3QgfHwgaXRlbS5zY29wZS4kbGFzdCk7CiAgICAgICAgICAgICAgaXRlbS5zY29wZS4kb2RkID0gIShpdGVtLnNjb3BlLiRldmVuID0gKGluZGV4JjEpID09PSAwKTsKCiAgICAgICAgICAgICAgLy9XZSBjaGFuZ2VkIHRoZSBzY29wZSwgc28gZGlnZXN0IGlmIG5lZWRlZAogICAgICAgICAgICAgIGlmICghJHJvb3RTY29wZS4kJHBoYXNlKSB7CiAgICAgICAgICAgICAgICBpdGVtLnNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGl0ZW0uaGFzaCA9IGhhc2g7CiAgICAgICAgICAgIHRoaXMuYXR0YWNoZWRJdGVtc1toYXNoXSA9IGl0ZW07CgogICAgICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZXN0cm95SXRlbTogZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICBpdGVtLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgIGl0ZW0uc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgaXRlbS5zY29wZSA9IG51bGw7CiAgICAgICAgICAgIGl0ZW0uZWxlbWVudCA9IG51bGw7CiAgICAgICAgICB9LAogICAgICAgICAgZGV0YWNoSXRlbTogZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICBkZWxldGUgdGhpcy5hdHRhY2hlZEl0ZW1zW2l0ZW0uaGFzaF07CgogICAgICAgICAgICAvL0lmIGl0J3MgYW4gb3V0c2lkZSBpdGVtLCBvbmx5IGhpZGUgaXQuIFRoZXNlIGl0ZW1zIGFyZW4ndCBwYXJ0IG9mIGNvbGxlY3Rpb24KICAgICAgICAgICAgLy9yZXBlYXQncyBsaXN0LCBvbmx5IHNpdCBvdXRzaWRlCiAgICAgICAgICAgIGlmIChpdGVtLmlzT3V0c2lkZSkgewogICAgICAgICAgICAgIGhpZGVXaXRoVHJhbnNmb3JtKGl0ZW0uZWxlbWVudCk7CgogICAgICAgICAgICAgIC8vIElmIHdlIGFyZSBhdCB0aGUgbGltaXQgb2YgYmFja3VwIGl0ZW1zLCBqdXN0IGdldCByaWQgb2YgdGhlIHRoaXMgZWxlbWVudAogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYmFja3VwSXRlbXNBcnJheS5sZW5ndGggPj0gdGhpcy5CQUNLVVBfSVRFTVNfTEVOR1RIKSB7CiAgICAgICAgICAgICAgdGhpcy5kZXN0cm95SXRlbShpdGVtKTsKICAgICAgICAgICAgICAvLyBPdGhlcndpc2UsIGFkZCBpdCB0byBvdXIgYmFja3VwIGl0ZW1zCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5iYWNrdXBJdGVtc0FycmF5LnB1c2goaXRlbSk7CiAgICAgICAgICAgICAgaGlkZVdpdGhUcmFuc2Zvcm0oaXRlbS5lbGVtZW50KTsKICAgICAgICAgICAgICAvL0Rvbid0IC4kZGVzdHJveSgpLCBqdXN0IHN0b3Agd2F0Y2hlcnMgYW5kIGV2ZW50cyBmaXJpbmcKICAgICAgICAgICAgICBkaXNjb25uZWN0U2NvcGUoaXRlbS5zY29wZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9LAogICAgICAgICAgZ2V0TGVuZ3RoOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGltZW5zaW9ucyAmJiB0aGlzLmRpbWVuc2lvbnMubGVuZ3RoIHx8IDA7CiAgICAgICAgICB9LAogICAgICAgICAgc2V0RGF0YTogZnVuY3Rpb24odmFsdWUsIGJlZm9yZVNpYmxpbmdzLCBhZnRlclNpYmxpbmdzKSB7CiAgICAgICAgICAgIHRoaXMuZGF0YSA9IHZhbHVlIHx8IFtdOwogICAgICAgICAgICB0aGlzLmJlZm9yZVNpYmxpbmdzID0gYmVmb3JlU2libGluZ3MgfHwgW107CiAgICAgICAgICAgIHRoaXMuYWZ0ZXJTaWJsaW5ncyA9IGFmdGVyU2libGluZ3MgfHwgW107CiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlRGF0YURpbWVuc2lvbnMoKTsKCiAgICAgICAgICAgIHRoaXMuYWZ0ZXJTaWJsaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICBpdGVtLmVsZW1lbnQuY3NzKHtwb3NpdGlvbjogJ2Fic29sdXRlJywgdG9wOiAnMCcsIGxlZnQ6ICcwJyB9KTsKICAgICAgICAgICAgICBoaWRlV2l0aFRyYW5zZm9ybShpdGVtLmVsZW1lbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIENvbGxlY3Rpb25SZXBlYXREYXRhU291cmNlOwogICAgICB9XSk7CgogIC8qKgogICAqIENvbXB1dGVzIGEgaGFzaCBvZiBhbiAnb2JqJy4KICAgKiBIYXNoIG9mIGE6CiAgICogIHN0cmluZyBpcyBzdHJpbmcKICAgKiAgbnVtYmVyIGlzIG51bWJlciBhcyBzdHJpbmcKICAgKiAgb2JqZWN0IGlzIGVpdGhlciByZXN1bHQgb2YgY2FsbGluZyAkJGhhc2hLZXkgZnVuY3Rpb24gb24gdGhlIG9iamVjdCBvciB1bmlxdWVseSBnZW5lcmF0ZWQgaWQsCiAgICogICAgICAgICB0aGF0IGlzIGFsc28gYXNzaWduZWQgdG8gdGhlICQkaGFzaEtleSBwcm9wZXJ0eSBvZiB0aGUgb2JqZWN0LgogICAqCiAgICogQHBhcmFtIG9iagogICAqIEByZXR1cm5zIHtzdHJpbmd9IGhhc2ggc3RyaW5nIHN1Y2ggdGhhdCB0aGUgc2FtZSBpbnB1dCB3aWxsIGhhdmUgdGhlIHNhbWUgaGFzaCBzdHJpbmcuCiAgICogICAgICAgICBUaGUgcmVzdWx0aW5nIHN0cmluZyBrZXkgaXMgaW4gJ3R5cGU6aGFzaEtleScgZm9ybWF0LgogICAqLwogIGZ1bmN0aW9uIGhhc2hLZXkob2JqKSB7CiAgICB2YXIgb2JqVHlwZSA9IHR5cGVvZiBvYmosCiAgICAgIGtleTsKCiAgICBpZiAob2JqVHlwZSA9PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwpIHsKICAgICAgaWYgKHR5cGVvZiAoa2V5ID0gb2JqLiQkaGFzaEtleSkgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIC8vIG11c3QgaW52b2tlIG9uIG9iamVjdCB0byBrZWVwIHRoZSByaWdodCB0aGlzCiAgICAgICAga2V5ID0gb2JqLiQkaGFzaEtleSgpOwogICAgICB9IGVsc2UgaWYgKGtleSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAga2V5ID0gb2JqLiQkaGFzaEtleSA9IGlvbmljLlV0aWxzLm5leHRVaWQoKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAga2V5ID0gb2JqOwogICAgfQoKICAgIHJldHVybiBvYmpUeXBlICsgJzonICsga2V5OwogIH0KCiAgZnVuY3Rpb24gZGlzY29ubmVjdFNjb3BlKHNjb3BlKSB7CiAgICBpZiAoc2NvcGUuJHJvb3QgPT09IHNjb3BlKSB7CiAgICAgIHJldHVybjsgLy8gd2UgY2FuJ3QgZGlzY29ubmVjdCB0aGUgcm9vdCBub2RlOwogICAgfQogICAgdmFyIHBhcmVudCA9IHNjb3BlLiRwYXJlbnQ7CiAgICBzY29wZS4kJGRpc2Nvbm5lY3RlZCA9IHRydWU7CiAgICAvLyBTZWUgU2NvcGUuJGRlc3Ryb3kKICAgIGlmIChwYXJlbnQuJCRjaGlsZEhlYWQgPT09IHNjb3BlKSB7CiAgICAgIHBhcmVudC4kJGNoaWxkSGVhZCA9IHNjb3BlLiQkbmV4dFNpYmxpbmc7CiAgICB9CiAgICBpZiAocGFyZW50LiQkY2hpbGRUYWlsID09PSBzY29wZSkgewogICAgICBwYXJlbnQuJCRjaGlsZFRhaWwgPSBzY29wZS4kJHByZXZTaWJsaW5nOwogICAgfQogICAgaWYgKHNjb3BlLiQkcHJldlNpYmxpbmcpIHsKICAgICAgc2NvcGUuJCRwcmV2U2libGluZy4kJG5leHRTaWJsaW5nID0gc2NvcGUuJCRuZXh0U2libGluZzsKICAgIH0KICAgIGlmIChzY29wZS4kJG5leHRTaWJsaW5nKSB7CiAgICAgIHNjb3BlLiQkbmV4dFNpYmxpbmcuJCRwcmV2U2libGluZyA9IHNjb3BlLiQkcHJldlNpYmxpbmc7CiAgICB9CiAgICBzY29wZS4kJG5leHRTaWJsaW5nID0gc2NvcGUuJCRwcmV2U2libGluZyA9IG51bGw7CiAgfQoKICBmdW5jdGlvbiByZWNvbm5lY3RTY29wZShzY29wZSkgewogICAgaWYgKHNjb3BlLiRyb290ID09PSBzY29wZSkgewogICAgICByZXR1cm47IC8vIHdlIGNhbid0IGRpc2Nvbm5lY3QgdGhlIHJvb3Qgbm9kZTsKICAgIH0KICAgIGlmICghc2NvcGUuJCRkaXNjb25uZWN0ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHBhcmVudCA9IHNjb3BlLiRwYXJlbnQ7CiAgICBzY29wZS4kJGRpc2Nvbm5lY3RlZCA9IGZhbHNlOwogICAgLy8gU2VlIFNjb3BlLiRuZXcgZm9yIHRoaXMgbG9naWMuLi4KICAgIHNjb3BlLiQkcHJldlNpYmxpbmcgPSBwYXJlbnQuJCRjaGlsZFRhaWw7CiAgICBpZiAocGFyZW50LiQkY2hpbGRIZWFkKSB7CiAgICAgIHBhcmVudC4kJGNoaWxkVGFpbC4kJG5leHRTaWJsaW5nID0gc2NvcGU7CiAgICAgIHBhcmVudC4kJGNoaWxkVGFpbCA9IHNjb3BlOwogICAgfSBlbHNlIHsKICAgICAgcGFyZW50LiQkY2hpbGRIZWFkID0gcGFyZW50LiQkY2hpbGRUYWlsID0gc2NvcGU7CiAgICB9CiAgfQoKCiAgSW9uaWNNb2R1bGUKICAgIC5mYWN0b3J5KCckY29sbGVjdGlvblJlcGVhdE1hbmFnZXInLCBbCiAgICAgICckcm9vdFNjb3BlJywKICAgICAgJyR0aW1lb3V0JywKICAgICAgZnVuY3Rpb24oJHJvb3RTY29wZSwgJHRpbWVvdXQpIHsKICAgICAgICAvKioKICAgICAgICAgKiBWb2NhYnVsYXJ5OiAicHJpbWFyeSIgYW5kICJzZWNvbmRhcnkiIHNpemUvZGlyZWN0aW9uL3Bvc2l0aW9uIG1lYW4KICAgICAgICAgKiAieSIgYW5kICJ4IiBmb3IgdmVydGljYWwgc2Nyb2xsaW5nLCBvciAieCIgYW5kICJ5IiBmb3IgaG9yaXpvbnRhbCBzY3JvbGxpbmcuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gQ29sbGVjdGlvblJlcGVhdE1hbmFnZXIob3B0aW9ucykgewogICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgdGhpcy5kYXRhU291cmNlID0gb3B0aW9ucy5kYXRhU291cmNlOwogICAgICAgICAgdGhpcy5lbGVtZW50ID0gb3B0aW9ucy5lbGVtZW50OwogICAgICAgICAgdGhpcy5zY3JvbGxWaWV3ID0gb3B0aW9ucy5zY3JvbGxWaWV3OwoKICAgICAgICAgIHRoaXMuaXNWZXJ0aWNhbCA9ICEhdGhpcy5zY3JvbGxWaWV3Lm9wdGlvbnMuc2Nyb2xsaW5nWTsKICAgICAgICAgIHRoaXMucmVuZGVyZWRJdGVtcyA9IHt9OwogICAgICAgICAgdGhpcy5kaW1lbnNpb25zID0gW107CiAgICAgICAgICB0aGlzLnNldEN1cnJlbnRJbmRleCgwKTsKCiAgICAgICAgICAvL092ZXJyaWRlIHNjcm9sbHZpZXcncyByZW5kZXIgY2FsbGJhY2sKICAgICAgICAgIHRoaXMuc2Nyb2xsVmlldy5fXyRjYWxsYmFjayA9IHRoaXMuc2Nyb2xsVmlldy5fX2NhbGxiYWNrOwogICAgICAgICAgdGhpcy5zY3JvbGxWaWV3Ll9fY2FsbGJhY2sgPSBhbmd1bGFyLmJpbmQodGhpcywgdGhpcy5yZW5kZXJTY3JvbGwpOwoKICAgICAgICAgIGZ1bmN0aW9uIGdldFZpZXdwb3J0U2l6ZSgpIHsgcmV0dXJuIHNlbGYudmlld3BvcnRTaXplOyB9CiAgICAgICAgICAvL1NldCBnZXR0ZXJzIGFuZCBzZXR0ZXJzIHRvIG1hdGNoIHdoZXRoZXIgdGhpcyBzY3JvbGx2aWV3IGlzIHZlcnRpY2FsIG9yIG5vdAogICAgICAgICAgaWYgKHRoaXMuaXNWZXJ0aWNhbCkgewogICAgICAgICAgICB0aGlzLnNjcm9sbFZpZXcub3B0aW9ucy5nZXRDb250ZW50SGVpZ2h0ID0gZ2V0Vmlld3BvcnRTaXplOwoKICAgICAgICAgICAgdGhpcy5zY3JvbGxWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX19zY3JvbGxUb3A7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2Nyb2xsTWF4VmFsdWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fbWF4U2Nyb2xsVG9wOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnNjcm9sbFNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fY2xpZW50SGVpZ2h0OwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnNlY29uZGFyeVNjcm9sbFNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fY2xpZW50V2lkdGg7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMudHJhbnNmb3JtU3RyaW5nID0gZnVuY3Rpb24oeSwgeCkgewogICAgICAgICAgICAgIHJldHVybiAndHJhbnNsYXRlM2QoJyt4KydweCwnK3krJ3B4LDApJzsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5wcmltYXJ5RGltZW5zaW9uID0gZnVuY3Rpb24oZGltKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGRpbS5oZWlnaHQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2Vjb25kYXJ5RGltZW5zaW9uID0gZnVuY3Rpb24oZGltKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGRpbS53aWR0aDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVmlldy5vcHRpb25zLmdldENvbnRlbnRXaWR0aCA9IGdldFZpZXdwb3J0U2l6ZTsKCiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVmFsdWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fc2Nyb2xsTGVmdDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5zY3JvbGxNYXhWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX19tYXhTY3JvbGxMZWZ0OwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnNjcm9sbFNpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fY2xpZW50V2lkdGg7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2Vjb25kYXJ5U2Nyb2xsU2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX19jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMudHJhbnNmb3JtU3RyaW5nID0gZnVuY3Rpb24oeCwgeSkgewogICAgICAgICAgICAgIHJldHVybiAndHJhbnNsYXRlM2QoJyt4KydweCwnK3krJ3B4LDApJzsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5wcmltYXJ5RGltZW5zaW9uID0gZnVuY3Rpb24oZGltKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGRpbS53aWR0aDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5zZWNvbmRhcnlEaW1lbnNpb24gPSBmdW5jdGlvbihkaW0pIHsKICAgICAgICAgICAgICByZXR1cm4gZGltLmhlaWdodDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIENvbGxlY3Rpb25SZXBlYXRNYW5hZ2VyLnByb3RvdHlwZSA9IHsKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnJlbmRlcmVkSXRlbXMgPSB7fTsKICAgICAgICAgICAgdGhpcy5yZW5kZXIgPSBhbmd1bGFyLm5vb3A7CiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlRGltZW5zaW9ucyA9IGFuZ3VsYXIubm9vcDsKICAgICAgICAgICAgdGhpcy5kaW1lbnNpb25zID0gW107CiAgICAgICAgICB9LAoKICAgICAgICAgIC8qCiAgICAgICAgICAgKiBQcmUtY2FsY3VsYXRlIHRoZSBwb3NpdGlvbiBvZiBhbGwgaXRlbXMgaW4gdGhlIGRhdGEgbGlzdC4KICAgICAgICAgICAqIERvIHRoaXMgdXNpbmcgdGhlIHByb3ZpZGVkIHdpZHRoIGFuZCBoZWlnaHQgKHByaW1hcnlTaXplIGFuZCBzZWNvbmRhcnlTaXplKQogICAgICAgICAgICogcHJvdmlkZWQgYnkgdGhlIGRhdGFTb3VyY2UuCiAgICAgICAgICAgKi8KICAgICAgICAgIGNhbGN1bGF0ZURpbWVuc2lvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvKgogICAgICAgICAgICAgKiBGb3IgdGhlIHNha2Ugb2YgZXhwbGFuYXRpb25zIGJlbG93LCB3ZSdyZSBnb2luZyB0byBwcmV0ZW5kIHdlIGFyZSBzY3JvbGxpbmcKICAgICAgICAgICAgICogdmVydGljYWxseTogSXRlbXMgYXJlIGxhaWQgb3V0IHdpdGggcHJpbWFyeVNpemUgYmVpbmcgaGVpZ2h0LAogICAgICAgICAgICAgKiBzZWNvbmRhcnlTaXplIGJlaW5nIHdpZHRoLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdmFyIHByaW1hcnlQb3MgPSAwOwogICAgICAgICAgICB2YXIgc2Vjb25kYXJ5UG9zID0gMDsKICAgICAgICAgICAgdmFyIHNlY29uZGFyeVNjcm9sbFNpemUgPSB0aGlzLnNlY29uZGFyeVNjcm9sbFNpemUoKTsKICAgICAgICAgICAgdmFyIHByZXZpb3VzSXRlbTsKCiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZS5iZWZvcmVTaWJsaW5ncyAmJiB0aGlzLmRhdGFTb3VyY2UuYmVmb3JlU2libGluZ3MuZm9yRWFjaChjYWxjdWxhdGVTaXplLCB0aGlzKTsKICAgICAgICAgICAgdmFyIGJlZm9yZVNpemUgPSBwcmltYXJ5UG9zICsgKHByZXZpb3VzSXRlbSA/IHByZXZpb3VzSXRlbS5wcmltYXJ5U2l6ZSA6IDApOwoKICAgICAgICAgICAgcHJpbWFyeVBvcyA9IHNlY29uZGFyeVBvcyA9IDA7CiAgICAgICAgICAgIHByZXZpb3VzSXRlbSA9IG51bGw7CgoKICAgICAgICAgICAgdmFyIGRpbWVuc2lvbnMgPSB0aGlzLmRhdGFTb3VyY2UuZGltZW5zaW9ucy5tYXAoY2FsY3VsYXRlU2l6ZSwgdGhpcyk7CiAgICAgICAgICAgIHZhciB0b3RhbFNpemUgPSBwcmltYXJ5UG9zICsgKHByZXZpb3VzSXRlbSA/IHByZXZpb3VzSXRlbS5wcmltYXJ5U2l6ZSA6IDApOwoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBiZWZvcmVTaXplOiBiZWZvcmVTaXplLAogICAgICAgICAgICAgIHRvdGFsU2l6ZTogdG90YWxTaXplLAogICAgICAgICAgICAgIGRpbWVuc2lvbnM6IGRpbWVuc2lvbnMKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZVNpemUoZGltKSB7CgogICAgICAgICAgICAgIC8vRWFjaCBkaW1lbnNpb24gaXMgYW4gb2JqZWN0IHt3aWR0aDogTnVtYmVyLCBoZWlnaHQ6IE51bWJlcn0gcHJvdmlkZWQgYnkKICAgICAgICAgICAgICAvL3RoZSBkYXRhU291cmNlCiAgICAgICAgICAgICAgdmFyIHJlY3QgPSB7CiAgICAgICAgICAgICAgICAvL0dldCB0aGUgaGVpZ2h0IG91dCBvZiB0aGUgZGltZW5zaW9uIG9iamVjdAogICAgICAgICAgICAgICAgcHJpbWFyeVNpemU6IHRoaXMucHJpbWFyeURpbWVuc2lvbihkaW0pLAogICAgICAgICAgICAgICAgLy9NYXggb3V0IHRoZSBpdGVtJ3Mgd2lkdGggdG8gdGhlIHdpZHRoIG9mIHRoZSBzY3JvbGx2aWV3CiAgICAgICAgICAgICAgICBzZWNvbmRhcnlTaXplOiBNYXRoLm1pbih0aGlzLnNlY29uZGFyeURpbWVuc2lvbihkaW0pLCBzZWNvbmRhcnlTY3JvbGxTaXplKQogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIC8vSWYgdGhpcyBpc24ndCB0aGUgZmlyc3QgaXRlbQogICAgICAgICAgICAgIGlmIChwcmV2aW91c0l0ZW0pIHsKICAgICAgICAgICAgICAgIC8vTW92ZSB0aGUgaXRlbSdzIHggcG9zaXRpb24gb3ZlciBieSB0aGUgd2lkdGggb2YgdGhlIHByZXZpb3VzIGl0ZW0KICAgICAgICAgICAgICAgIHNlY29uZGFyeVBvcyArPSBwcmV2aW91c0l0ZW0uc2Vjb25kYXJ5U2l6ZTsKICAgICAgICAgICAgICAgIC8vSWYgdGhlIHkgcG9zaXRpb24gaXMgdGhlIHNhbWUgYXMgdGhlIHByZXZpb3VzIGl0ZW0gYW5kCiAgICAgICAgICAgICAgICAvL3RoZSB4IHBvc2l0aW9uIGlzIGJpZ2dlciB0aGFuIHRoZSBzY3JvbGxlcidzIHdpZHRoCiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNJdGVtLnByaW1hcnlQb3MgPT09IHByaW1hcnlQb3MgJiYKICAgICAgICAgICAgICAgICAgc2Vjb25kYXJ5UG9zICsgcmVjdC5zZWNvbmRhcnlTaXplID4gc2Vjb25kYXJ5U2Nyb2xsU2l6ZSkgewogICAgICAgICAgICAgICAgICAvL1RoZW4gZ28gdG8gdGhlIG5leHQgcm93LCB3aXRoIHggcG9zaXRpb24gMAogICAgICAgICAgICAgICAgICBzZWNvbmRhcnlQb3MgPSAwOwogICAgICAgICAgICAgICAgICBwcmltYXJ5UG9zICs9IHByZXZpb3VzSXRlbS5wcmltYXJ5U2l6ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJlY3QucHJpbWFyeVBvcyA9IHByaW1hcnlQb3M7CiAgICAgICAgICAgICAgcmVjdC5zZWNvbmRhcnlQb3MgPSBzZWNvbmRhcnlQb3M7CgogICAgICAgICAgICAgIHByZXZpb3VzSXRlbSA9IHJlY3Q7CiAgICAgICAgICAgICAgcmV0dXJuIHJlY3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICByZXNpemU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gdGhpcy5jYWxjdWxhdGVEaW1lbnNpb25zKCk7CiAgICAgICAgICAgIHRoaXMuZGltZW5zaW9ucyA9IHJlc3VsdC5kaW1lbnNpb25zOwogICAgICAgICAgICB0aGlzLnZpZXdwb3J0U2l6ZSA9IHJlc3VsdC50b3RhbFNpemU7CiAgICAgICAgICAgIHRoaXMuYmVmb3JlU2l6ZSA9IHJlc3VsdC5iZWZvcmVTaXplOwogICAgICAgICAgICB0aGlzLnNldEN1cnJlbnRJbmRleCgwKTsKICAgICAgICAgICAgdGhpcy5yZW5kZXIodHJ1ZSk7CiAgICAgICAgICAgIGlmICghdGhpcy5kYXRhU291cmNlLmJhY2t1cEl0ZW1zQXJyYXkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdGhpcy5kYXRhU291cmNlLnNldHVwKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAvKgogICAgICAgICAgICogc2V0Q3VycmVudEluZGV4IHNldHMgdGhlIGluZGV4IGluIHRoZSBsaXN0IHRoYXQgbWF0Y2hlcyB0aGUgc2Nyb2xsZXIncyBwb3NpdGlvbi4KICAgICAgICAgICAqIEFsc28gc2F2ZSB0aGUgcG9zaXRpb24gaW4gdGhlIHNjcm9sbGVyIGZvciBuZXh0IGFuZCBwcmV2aW91cyBpdGVtcyAoaWYgdGhleSBleGlzdCkKICAgICAgICAgICAqLwogICAgICAgICAgc2V0Q3VycmVudEluZGV4OiBmdW5jdGlvbihpbmRleCwgaGVpZ2h0KSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50UG9zID0gKHRoaXMuZGltZW5zaW9uc1tpbmRleF0gfHwge30pLnByaW1hcnlQb3MgfHwgMDsKICAgICAgICAgICAgdGhpcy5jdXJyZW50SW5kZXggPSBpbmRleDsKCiAgICAgICAgICAgIHRoaXMuaGFzUHJldkluZGV4ID0gaW5kZXggPiAwOwogICAgICAgICAgICBpZiAodGhpcy5oYXNQcmV2SW5kZXgpIHsKICAgICAgICAgICAgICB0aGlzLnByZXZpb3VzUG9zID0gTWF0aC5tYXgoCiAgICAgICAgICAgICAgICAgIGN1cnJlbnRQb3MgLSB0aGlzLmRpbWVuc2lvbnNbaW5kZXggLSAxXS5wcmltYXJ5U2l6ZSwKICAgICAgICAgICAgICAgIHRoaXMuZGltZW5zaW9uc1tpbmRleCAtIDFdLnByaW1hcnlQb3MKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuaGFzTmV4dEluZGV4ID0gaW5kZXggKyAxIDwgdGhpcy5kYXRhU291cmNlLmdldExlbmd0aCgpOwogICAgICAgICAgICBpZiAodGhpcy5oYXNOZXh0SW5kZXgpIHsKICAgICAgICAgICAgICB0aGlzLm5leHRQb3MgPSBNYXRoLm1pbigKICAgICAgICAgICAgICAgICAgY3VycmVudFBvcyArIHRoaXMuZGltZW5zaW9uc1tpbmRleCArIDFdLnByaW1hcnlTaXplLAogICAgICAgICAgICAgICAgdGhpcy5kaW1lbnNpb25zW2luZGV4ICsgMV0ucHJpbWFyeVBvcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIG92ZXJyaWRlIHRoZSBzY3JvbGxlcidzIHJlbmRlciBjYWxsYmFjayB0byBjaGVjayBpZiB3ZSBuZWVkIHRvCiAgICAgICAgICAgKiByZS1yZW5kZXIgb3VyIGNvbGxlY3Rpb24KICAgICAgICAgICAqLwogICAgICAgICAgcmVuZGVyU2Nyb2xsOiBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlKGZ1bmN0aW9uKHRyYW5zZm9ybUxlZnQsIHRyYW5zZm9ybVRvcCwgem9vbSwgd2FzUmVzaXplKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzVmVydGljYWwpIHsKICAgICAgICAgICAgICB0aGlzLnJlbmRlcklmTmVlZGVkKHRyYW5zZm9ybVRvcCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5yZW5kZXJJZk5lZWRlZCh0cmFuc2Zvcm1MZWZ0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3Ll9fJGNhbGxiYWNrKHRyYW5zZm9ybUxlZnQsIHRyYW5zZm9ybVRvcCwgem9vbSwgd2FzUmVzaXplKTsKICAgICAgICAgIH0pLAogICAgICAgICAgcmVuZGVySWZOZWVkZWQ6IGZ1bmN0aW9uKHNjcm9sbFBvcykgewogICAgICAgICAgICBpZiAoKHRoaXMuaGFzTmV4dEluZGV4ICYmIHNjcm9sbFBvcyA+PSB0aGlzLm5leHRQb3MpIHx8CiAgICAgICAgICAgICAgKHRoaXMuaGFzUHJldkluZGV4ICYmIHNjcm9sbFBvcyA8IHRoaXMucHJldmlvdXNQb3MpKSB7CiAgICAgICAgICAgICAgLy8gTWF0aC5hYnModHJhbnNmb3JtUG9zIC0gdGhpcy5sYXN0UmVuZGVyU2Nyb2xsVmFsdWUpID4gMTAwKSB7CiAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIC8qCiAgICAgICAgICAgKiBnZXRJbmRleEZvclNjcm9sbFZhbHVlOiBHaXZlbiB0aGUgbW9zdCByZWNlbnQgZGF0YSBpbmRleCBhbmQgYSBuZXcgc2Nyb2xsVmFsdWUsCiAgICAgICAgICAgKiBmaW5kIHRoZSBkYXRhIGluZGV4IHRoYXQgbWF0Y2hlcyB0aGF0IHNjcm9sbFZhbHVlLgogICAgICAgICAgICoKICAgICAgICAgICAqIFN0cmF0ZWd5IChpZiB3ZSBhcmUgc2Nyb2xsaW5nIGRvd24pOiBrZWVwIGdvaW5nIGZvcndhcmQgaW4gdGhlIGRpbWVuc2lvbnMgbGlzdCwKICAgICAgICAgICAqIHN0YXJ0aW5nIGF0IHRoZSBnaXZlbiBpbmRleCwgdW50aWwgYW4gaXRlbSB3aXRoIGhlaWdodCBtYXRjaGluZyB0aGUgbmV3IHNjcm9sbFZhbHVlCiAgICAgICAgICAgKiBpcyBmb3VuZC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBUaGlzIGlzIGEgd2hpbGUgbG9vcC4gSW4gdGhlIHdvcnN0IGNhc2UgaXQgd2lsbCBoYXZlIHRvIGdvIHRocm91Z2ggdGhlIHdob2xlIGxpc3QKICAgICAgICAgICAqIChlZyB0byBzY3JvbGwgZnJvbSB0b3AgdG8gYm90dG9tKS4gIFRoZSBtb3N0IGNvbW1vbiBjYXNlIGlzIHRvIHNjcm9sbAogICAgICAgICAgICogZG93biAxLTMgaXRlbXMgYXQgYSB0aW1lLgogICAgICAgICAgICoKICAgICAgICAgICAqIFdoaWxlIHRoaXMgaXMgbm90IGFzIGVmZmljaWVudCBhcyBpdCBjb3VsZCBiZSwgb3B0aW1pemluZyBpdCBnaXZlcyBubyBub3RpY2VhYmxlCiAgICAgICAgICAgKiBiZW5lZml0LiAgV2Ugd291bGQgaGF2ZSB0byB1c2UgYSBuZXcgbWVtb3J5LWludGVuc2l2ZSBkYXRhIHN0cnVjdHVyZSBmb3IgZGltZW5zaW9ucwogICAgICAgICAgICogdG8gZnVsbHkgb3B0aW1pemUgaXQuCiAgICAgICAgICAgKi8KICAgICAgICAgIGdldEluZGV4Rm9yU2Nyb2xsVmFsdWU6IGZ1bmN0aW9uKGksIHNjcm9sbFZhbHVlKSB7CiAgICAgICAgICAgIHZhciByZWN0OwogICAgICAgICAgICAvL1Njcm9sbGluZyB1cAogICAgICAgICAgICBpZiAoc2Nyb2xsVmFsdWUgPD0gdGhpcy5kaW1lbnNpb25zW2ldLnByaW1hcnlQb3MpIHsKICAgICAgICAgICAgICB3aGlsZSAoIChyZWN0ID0gdGhpcy5kaW1lbnNpb25zW2kgLSAxXSkgJiYgcmVjdC5wcmltYXJ5UG9zID4gc2Nyb2xsVmFsdWUpIHsKICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy9TY3JvbGxpbmcgZG93bgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdoaWxlICggKHJlY3QgPSB0aGlzLmRpbWVuc2lvbnNbaSArIDFdKSAmJiByZWN0LnByaW1hcnlQb3MgPCBzY3JvbGxWYWx1ZSkgewogICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgIH0sCiAgICAgICAgICAvKgogICAgICAgICAgICogcmVuZGVyOiBGaWd1cmUgb3V0IHRoZSBzY3JvbGwgcG9zaXRpb24sIHRoZSBpbmRleCBtYXRjaGluZyBpdCwgYW5kIHRoZW4gdGVsbAogICAgICAgICAgICogdGhlIGRhdGEgc291cmNlIHRvIHJlbmRlciB0aGUgY29ycmVjdCBpdGVtcyBpbnRvIHRoZSBET00uCiAgICAgICAgICAgKi8KICAgICAgICAgIHJlbmRlcjogZnVuY3Rpb24oc2hvdWxkUmVkcmF3QWxsKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgIHZhciBpc091dE9mQm91bmRzID0gKCB0aGlzLmN1cnJlbnRJbmRleCA+PSB0aGlzLmRhdGFTb3VyY2UuZ2V0TGVuZ3RoKCkgKTsKICAgICAgICAgICAgLy8gV2Ugd2FudCB0byByZW1vdmUgYWxsIHRoZSBpdGVtcyBhbmQgcmVkcmF3IGV2ZXJ5dGhpbmcgaWYgd2UncmUgb3V0IG9mIGJvdW5kcwogICAgICAgICAgICAvLyBvciBhIGZsYWcgaXMgcGFzc2VkIGluLgogICAgICAgICAgICBpZiAoaXNPdXRPZkJvdW5kcyB8fCBzaG91bGRSZWRyYXdBbGwpIHsKICAgICAgICAgICAgICBmb3IgKGkgaW4gdGhpcy5yZW5kZXJlZEl0ZW1zKSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUl0ZW0oaSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIEp1c3QgZG9uJ3QgcmVuZGVyIGFueXRoaW5nIGlmIHdlJ3JlIG91dCBvZiBib3VuZHMKICAgICAgICAgICAgICBpZiAoaXNPdXRPZkJvdW5kcykgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcmVjdDsKICAgICAgICAgICAgdmFyIHNjcm9sbFZhbHVlID0gdGhpcy5zY3JvbGxWYWx1ZSgpOwogICAgICAgICAgICAvLyBTY3JvbGwgc2l6ZSA9IGhvdyBtYW55IHBpeGVscyBhcmUgdmlzaWJsZSBpbiB0aGUgc2Nyb2xsZXIgYXQgb25lIHRpbWUKICAgICAgICAgICAgdmFyIHNjcm9sbFNpemUgPSB0aGlzLnNjcm9sbFNpemUoKTsKICAgICAgICAgICAgLy8gV2UgdGFrZSB0aGUgY3VycmVudCBzY3JvbGwgdmFsdWUgYW5kIGFkZCBpdCB0byB0aGUgc2Nyb2xsU2l6ZSB0byBnZXQKICAgICAgICAgICAgLy8gd2hhdCBzY3JvbGxWYWx1ZSB0aGUgY3VycmVudCB2aXNpYmxlIHNjcm9sbCBhcmVhIGVuZHMgYXQuCiAgICAgICAgICAgIHZhciBzY3JvbGxTaXplRW5kID0gc2Nyb2xsU2l6ZSArIHNjcm9sbFZhbHVlOwogICAgICAgICAgICAvLyBHZXQgdGhlIG5ldyBzdGFydCBpbmRleCBmb3Igc2Nyb2xsaW5nLCBiYXNlZCBvbiB0aGUgY3VycmVudCBzY3JvbGxWYWx1ZSBhbmQKICAgICAgICAgICAgLy8gdGhlIG1vc3QgcmVjZW50IGtub3duIGluZGV4CiAgICAgICAgICAgIHZhciBzdGFydEluZGV4ID0gdGhpcy5nZXRJbmRleEZvclNjcm9sbFZhbHVlKHRoaXMuY3VycmVudEluZGV4LCBzY3JvbGxWYWx1ZSk7CgogICAgICAgICAgICAvLyBJZiB3ZSBhcmVuJ3Qgb24gdGhlIGZpcnN0IGl0ZW0sIGFkZCBvbmUgcm93IG9mIGl0ZW1zIGJlZm9yZSBzbyB0aGF0IHdoZW4gdGhlIHVzZXIgaXMKICAgICAgICAgICAgLy8gc2Nyb2xsaW5nIHVwIGhlIHNlZXMgdGhlIHByZXZpb3VzIGl0ZW0KICAgICAgICAgICAgdmFyIHJlbmRlclN0YXJ0SW5kZXggPSBNYXRoLm1heChzdGFydEluZGV4IC0gMSwgMCk7CiAgICAgICAgICAgIC8vIEtlZXAgYWRkaW5nIGl0ZW1zIHRvIHRoZSAnZXh0cmEgcm93IGFib3ZlJyB1bnRpbCB3ZSBnZXQgdG8gYSBuZXcgcm93LgogICAgICAgICAgICAvLyBUaGlzIGlzIGZvciB0aGUgY2FzZSB3aGVyZSB0aGVyZSBhcmUgbXVsdGlwbGUgaXRlbXMgb24gb25lIHJvdyBhYm92ZQogICAgICAgICAgICAvLyB0aGUgY3VycmVudCBpdGVtOyB3ZSB3YW50IHRvIGtlZXAgYWRkaW5nIGl0ZW1zIGFib3ZlIHVudGlsCiAgICAgICAgICAgIC8vIGEgbmV3IHJvdyBpcyByZWFjaGVkLgogICAgICAgICAgICB3aGlsZSAocmVuZGVyU3RhcnRJbmRleCA+IDAgJiYKICAgICAgICAgICAgICAocmVjdCA9IHRoaXMuZGltZW5zaW9uc1tyZW5kZXJTdGFydEluZGV4XSkgJiYKICAgICAgICAgICAgICByZWN0LnByaW1hcnlQb3MgPT09IHRoaXMuZGltZW5zaW9uc1tzdGFydEluZGV4IC0gMV0ucHJpbWFyeVBvcykgewogICAgICAgICAgICAgIHJlbmRlclN0YXJ0SW5kZXgtLTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gS2VlcCByZW5kZXJpbmcgaXRlbXMsIGFkZGluZyB0aGVtIHVudGlsIHdlIGFyZSBwYXN0IHRoZSBlbmQgb2YgdGhlIHZpc2libGUgc2Nyb2xsIGFyZWEKICAgICAgICAgICAgaSA9IHJlbmRlclN0YXJ0SW5kZXg7CiAgICAgICAgICAgIHdoaWxlICgocmVjdCA9IHRoaXMuZGltZW5zaW9uc1tpXSkgJiYgKHJlY3QucHJpbWFyeVBvcyAtIHJlY3QucHJpbWFyeVNpemUgPCBzY3JvbGxTaXplRW5kKSkgewogICAgICAgICAgICAgIGRvUmVuZGVyKGkrKyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy9BZGQgdHdvIG1vcmUgaXRlbXMgYXQgdGhlIGVuZAogICAgICAgICAgICBkb1JlbmRlcihpKyspOwogICAgICAgICAgICBkb1JlbmRlcihpKTsKICAgICAgICAgICAgdmFyIHJlbmRlckVuZEluZGV4ID0gaTsKCiAgICAgICAgICAgIC8vIFJlbW92ZSBhbnkgaXRlbXMgdGhhdCB3ZXJlIHJlbmRlcmVkIGFuZCBhcmVuJ3QgdmlzaWJsZSBhbnltb3JlCiAgICAgICAgICAgIGZvciAoaSBpbiB0aGlzLnJlbmRlcmVkSXRlbXMpIHsKICAgICAgICAgICAgICBpZiAoaSA8IHJlbmRlclN0YXJ0SW5kZXggfHwgaSA+IHJlbmRlckVuZEluZGV4KSB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUl0ZW0oaSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnNldEN1cnJlbnRJbmRleChzdGFydEluZGV4KTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGRvUmVuZGVyKGRhdGFJbmRleCkgewogICAgICAgICAgICAgIHZhciByZWN0ID0gc2VsZi5kaW1lbnNpb25zW2RhdGFJbmRleF07CiAgICAgICAgICAgICAgaWYgKCFyZWN0KSB7CgogICAgICAgICAgICAgIH1lbHNlIGlmIChkYXRhSW5kZXggPCBzZWxmLmRhdGFTb3VyY2UuZGF0YVN0YXJ0SW5kZXgpIHsKICAgICAgICAgICAgICAgIC8vIGRvIG5vdGhpbmcKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2VsZi5yZW5kZXJJdGVtKGRhdGFJbmRleCwgcmVjdC5wcmltYXJ5UG9zIC0gc2VsZi5iZWZvcmVTaXplLCByZWN0LnNlY29uZGFyeVBvcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgcmVuZGVySXRlbTogZnVuY3Rpb24oZGF0YUluZGV4LCBwcmltYXJ5UG9zLCBzZWNvbmRhcnlQb3MpIHsKICAgICAgICAgICAgLy8gQXR0YWNoIGFuIGl0ZW0sIGFuZCBzZXQgaXRzIHRyYW5zZm9ybSBwb3NpdGlvbiB0byB0aGUgcmVxdWlyZWQgdmFsdWUKICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLmRhdGFTb3VyY2UuYXR0YWNoSXRlbUF0SW5kZXgoZGF0YUluZGV4KTsKICAgICAgICAgICAgaWYgKGl0ZW0gJiYgaXRlbS5lbGVtZW50KSB7CiAgICAgICAgICAgICAgaWYgKGl0ZW0ucHJpbWFyeVBvcyAhPT0gcHJpbWFyeVBvcyB8fCBpdGVtLnNlY29uZGFyeVBvcyAhPT0gc2Vjb25kYXJ5UG9zKSB7CiAgICAgICAgICAgICAgICBpdGVtLmVsZW1lbnQuY3NzKGlvbmljLkNTUy5UUkFOU0ZPUk0sIHRoaXMudHJhbnNmb3JtU3RyaW5nKAogICAgICAgICAgICAgICAgICBwcmltYXJ5UG9zLCBzZWNvbmRhcnlQb3MKICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgICAgICAgaXRlbS5wcmltYXJ5UG9zID0gcHJpbWFyeVBvczsKICAgICAgICAgICAgICAgIGl0ZW0uc2Vjb25kYXJ5UG9zID0gc2Vjb25kYXJ5UG9zOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBTYXZlIHRoZSBpdGVtIGluIHJlbmRlcmVkIGl0ZW1zCiAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlZEl0ZW1zW2RhdGFJbmRleF0gPSBpdGVtOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIElmIGFuIGl0ZW0gYXQgdGhpcyBpbmRleCBkb2Vzbid0IGV4aXN0IGFueW1vcmUsIGJlIHN1cmUgdG8gZGVsZXRlCiAgICAgICAgICAgICAgLy8gaXQgZnJvbSByZW5kZXJlZCBpdGVtcwogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnJlbmRlcmVkSXRlbXNbZGF0YUluZGV4XTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHJlbW92ZUl0ZW06IGZ1bmN0aW9uKGRhdGFJbmRleCkgewogICAgICAgICAgICAvLyBEZXRhY2ggYSBnaXZlbiBpdGVtCiAgICAgICAgICAgIHZhciBpdGVtID0gdGhpcy5yZW5kZXJlZEl0ZW1zW2RhdGFJbmRleF07CiAgICAgICAgICAgIGlmIChpdGVtKSB7CiAgICAgICAgICAgICAgaXRlbS5wcmltYXJ5UG9zID0gaXRlbS5zZWNvbmRhcnlQb3MgPSBudWxsOwogICAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZS5kZXRhY2hJdGVtKGl0ZW0pOwogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnJlbmRlcmVkSXRlbXNbZGF0YUluZGV4XTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBleGNlcHRpb25zID0geydyZW5kZXJTY3JvbGwnOjEsICdyZW5kZXJJZk5lZWRlZCc6MX07CiAgICAgICAgZm9yRWFjaChDb2xsZWN0aW9uUmVwZWF0TWFuYWdlci5wcm90b3R5cGUsIGZ1bmN0aW9uKG1ldGhvZCwga2V5KSB7CiAgICAgICAgICBpZiAoZXhjZXB0aW9uc1trZXldKSByZXR1cm47CiAgICAgICAgICBDb2xsZWN0aW9uUmVwZWF0TWFuYWdlci5wcm90b3R5cGVba2V5XSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2b2lkIDA7CiAgICAgICAgICAgIHJldHVybiBtZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBDb2xsZWN0aW9uUmVwZWF0TWFuYWdlcjsKICAgICAgfV0pOwoKCiAgZnVuY3Rpb24gZGVsZWdhdGVTZXJ2aWNlKG1ldGhvZE5hbWVzKSB7CiAgICByZXR1cm4gWyckbG9nJywgZnVuY3Rpb24oJGxvZykgewogICAgICB2YXIgZGVsZWdhdGUgPSB0aGlzOwoKICAgICAgdmFyIGluc3RhbmNlcyA9IHRoaXMuX2luc3RhbmNlcyA9IFtdOwogICAgICB0aGlzLl9yZWdpc3Rlckluc3RhbmNlID0gZnVuY3Rpb24oaW5zdGFuY2UsIGhhbmRsZSkgewogICAgICAgIGluc3RhbmNlLiQkZGVsZWdhdGVIYW5kbGUgPSBoYW5kbGU7CiAgICAgICAgaW5zdGFuY2VzLnB1c2goaW5zdGFuY2UpOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gZGVyZWdpc3RlcigpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGluc3RhbmNlcy5pbmRleE9mKGluc3RhbmNlKTsKICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgaW5zdGFuY2VzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfTsKCiAgICAgIHRoaXMuJGdldEJ5SGFuZGxlID0gZnVuY3Rpb24oaGFuZGxlKSB7CiAgICAgICAgaWYgKCFoYW5kbGUpIHsKICAgICAgICAgIHJldHVybiBkZWxlZ2F0ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBJbnN0YW5jZUZvckhhbmRsZShoYW5kbGUpOwogICAgICB9OwoKICAgICAgLyoKICAgICAgICogQ3JlYXRlcyBhIG5ldyBvYmplY3QgdGhhdCB3aWxsIGhhdmUgYWxsIHRoZSBtZXRob2ROYW1lcyBnaXZlbiwKICAgICAgICogYW5kIGNhbGwgdGhlbSBvbiB0aGUgZ2l2ZW4gdGhlIGNvbnRyb2xsZXIgaW5zdGFuY2UgbWF0Y2hpbmcgZ2l2ZW4KICAgICAgICogaGFuZGxlLgogICAgICAgKiBUaGUgcmVhc29uIHdlIGRvbid0IGp1c3QgbGV0ICRnZXRCeUhhbmRsZSByZXR1cm4gdGhlIGNvbnRyb2xsZXIgaW5zdGFuY2UKICAgICAgICogaXRzZWxmIGlzIHRoYXQgdGhlIGNvbnRyb2xsZXIgaW5zdGFuY2UgbWlnaHQgbm90IGV4aXN0IHlldC4KICAgICAgICoKICAgICAgICogV2Ugd2FudCBwZW9wbGUgdG8gYmUgYWJsZSB0byBkbwogICAgICAgKiBgdmFyIGluc3RhbmNlID0gJGlvbmljU2Nyb2xsRGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdmb28nKWAgb24gY29udHJvbGxlcgogICAgICAgKiBpbnN0YW50aWF0aW9uLCBidXQgb24gY29udHJvbGxlciBpbnN0YW50aWF0aW9uIGEgY2hpbGQgZGlyZWN0aXZlCiAgICAgICAqIG1heSBub3QgaGF2ZSBiZWVuIGNvbXBpbGVkIHlldCEKICAgICAgICoKICAgICAgICogU28gdGhpcyBpcyBvdXIgd2F5IG9mIHNvbHZpbmcgdGhpcyBwcm9ibGVtOiB3ZSBjcmVhdGUgYW4gb2JqZWN0CiAgICAgICAqIHRoYXQgd2lsbCBvbmx5IHRyeSB0byBmZXRjaCB0aGUgY29udHJvbGxlciB3aXRoIGdpdmVuIGhhbmRsZQogICAgICAgKiBvbmNlIHRoZSBtZXRob2RzIGFyZSBhY3R1YWxseSBjYWxsZWQuCiAgICAgICAqLwogICAgICBmdW5jdGlvbiBJbnN0YW5jZUZvckhhbmRsZShoYW5kbGUpIHsKICAgICAgICB0aGlzLmhhbmRsZSA9IGhhbmRsZTsKICAgICAgfQogICAgICBtZXRob2ROYW1lcy5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgICBJbnN0YW5jZUZvckhhbmRsZS5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBoYW5kbGUgPSB0aGlzLmhhbmRsZTsKICAgICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICAgICAgdmFyIG1hdGNoaW5nSW5zdGFuY2VzRm91bmQgPSAwOwogICAgICAgICAgdmFyIGZpbmFsUmVzdWx0OwogICAgICAgICAgdmFyIHJlc3VsdDsKCiAgICAgICAgICAvL1RoaXMgbG9naWMgaXMgcmVwZWF0ZWQgYmVsb3c7IHdlIGNvdWxkIGZhY3RvciBzb21lIG9mIGl0IG91dCB0byBhIGZ1bmN0aW9uCiAgICAgICAgICAvL2J1dCBkb24ndCBiZWNhdXNlIGl0IGxldHMgdGhpcyBtZXRob2QgYmUgbW9yZSBwZXJmb3JtYW50IChvbmUgbG9vcCB2ZXJzdXMgMikKICAgICAgICAgIGluc3RhbmNlcy5mb3JFYWNoKGZ1bmN0aW9uKGluc3RhbmNlKSB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS4kJGRlbGVnYXRlSGFuZGxlID09PSBoYW5kbGUpIHsKICAgICAgICAgICAgICBtYXRjaGluZ0luc3RhbmNlc0ZvdW5kKys7CiAgICAgICAgICAgICAgcmVzdWx0ID0gaW5zdGFuY2VbbWV0aG9kTmFtZV0uYXBwbHkoaW5zdGFuY2UsIGFyZ3MpOwogICAgICAgICAgICAgIC8vT25seSByZXR1cm4gdGhlIHZhbHVlIGZyb20gdGhlIGZpcnN0IGNhbGwKICAgICAgICAgICAgICBpZiAobWF0Y2hpbmdJbnN0YW5jZXNGb3VuZCA9PT0gMSkgewogICAgICAgICAgICAgICAgZmluYWxSZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICBpZiAoIW1hdGNoaW5nSW5zdGFuY2VzRm91bmQpIHsKICAgICAgICAgICAgcmV0dXJuICRsb2cud2FybigKICAgICAgICAgICAgICAgICdEZWxlZ2F0ZSBmb3IgaGFuZGxlICInK3RoaXMuaGFuZGxlKyciIGNvdWxkIG5vdCBmaW5kIGEgJyArCiAgICAgICAgICAgICAgICAnY29ycmVzcG9uZGluZyBlbGVtZW50IHdpdGggZGVsZWdhdGUtaGFuZGxlPSInK3RoaXMuaGFuZGxlKyciISAnICsKICAgICAgICAgICAgICAgIG1ldGhvZE5hbWUgKyAnKCkgd2FzIG5vdCBjYWxsZWQhXG4nICsKICAgICAgICAgICAgICAgICdQb3NzaWJsZSBjYXVzZTogSWYgeW91IGFyZSBjYWxsaW5nICcgKyBtZXRob2ROYW1lICsgJygpIGltbWVkaWF0ZWx5LCBhbmQgJyArCiAgICAgICAgICAgICAgICAneW91ciBlbGVtZW50IHdpdGggZGVsZWdhdGUtaGFuZGxlPSInICsgdGhpcy5oYW5kbGUgKyAnIiBpcyBhIGNoaWxkIG9mIHlvdXIgJyArCiAgICAgICAgICAgICAgICAnY29udHJvbGxlciwgdGhlbiB5b3VyIGVsZW1lbnQgbWF5IG5vdCBiZSBjb21waWxlZCB5ZXQuIFB1dCBhICR0aW1lb3V0ICcgKwogICAgICAgICAgICAgICAgJ2Fyb3VuZCB5b3VyIGNhbGwgdG8gJyArIG1ldGhvZE5hbWUgKyAnKCkgYW5kIHRyeSBhZ2Fpbi4nCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGZpbmFsUmVzdWx0OwogICAgICAgIH07CiAgICAgICAgZGVsZWdhdGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICAgICAgdmFyIGZpbmFsUmVzdWx0OwogICAgICAgICAgdmFyIHJlc3VsdDsKCiAgICAgICAgICAvL1RoaXMgbG9naWMgaXMgcmVwZWF0ZWQgYWJvdmUKICAgICAgICAgIGluc3RhbmNlcy5mb3JFYWNoKGZ1bmN0aW9uKGluc3RhbmNlLCBpbmRleCkgewogICAgICAgICAgICByZXN1bHQgPSBpbnN0YW5jZVttZXRob2ROYW1lXS5hcHBseShpbnN0YW5jZSwgYXJncyk7CiAgICAgICAgICAgIC8vT25seSByZXR1cm4gdGhlIHZhbHVlIGZyb20gdGhlIGZpcnN0IGNhbGwKICAgICAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgICAgICAgICAgZmluYWxSZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHJldHVybiBmaW5hbFJlc3VsdDsKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBjYWxsTWV0aG9kKGluc3RhbmNlc1RvVXNlLCBtZXRob2ROYW1lLCBhcmdzKSB7CiAgICAgICAgICB2YXIgZmluYWxSZXN1bHQ7CiAgICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgICAgaW5zdGFuY2VzVG9Vc2UuZm9yRWFjaChmdW5jdGlvbihpbnN0YW5jZSwgaW5kZXgpIHsKICAgICAgICAgICAgcmVzdWx0ID0gaW5zdGFuY2VbbWV0aG9kTmFtZV0uYXBwbHkoaW5zdGFuY2UsIGFyZ3MpOwogICAgICAgICAgICAvL01ha2UgaXQgc28gdGhlIGZpcnN0IHJlc3VsdCBpcyB0aGUgb25lIHJldHVybmVkCiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkgewogICAgICAgICAgICAgIGZpbmFsUmVzdWx0ID0gcmVzdWx0OwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBmaW5hbFJlc3VsdDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfV07CiAgfQoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRpb25pY0dlc3R1cmUKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uIEFuIGFuZ3VsYXIgc2VydmljZSBleHBvc2luZyBpb25pYwogICAqIHtAbGluayBpb25pYy51dGlsaXR5OmlvbmljLkV2ZW50Q29udHJvbGxlcn0ncyBnZXN0dXJlcy4KICAgKi8KICBJb25pY01vZHVsZQogICAgLmZhY3RvcnkoJyRpb25pY0dlc3R1cmUnLCBbZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRpb25pY0dlc3R1cmUjb24KICAgICAgICAgKiBAZGVzY3JpcHRpb24gQWRkIGFuIGV2ZW50IGxpc3RlbmVyIGZvciBhIGdlc3R1cmUgb24gYW4gZWxlbWVudC4gU2VlIHtAbGluayBpb25pYy51dGlsaXR5OmlvbmljLkV2ZW50Q29udHJvbGxlciNvbkdlc3R1cmV9LgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudFR5cGUgVGhlIGdlc3R1cmUgZXZlbnQgdG8gbGlzdGVuIGZvci4KICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGUpfSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBnZXN0dXJlCiAgICAgICAgICogaGFwcGVucy4KICAgICAgICAgKiBAcGFyYW0ge2VsZW1lbnR9ICRlbGVtZW50IFRoZSBhbmd1bGFyIGVsZW1lbnQgdG8gbGlzdGVuIGZvciB0aGUgZXZlbnQgb24uCiAgICAgICAgICogQHJldHVybnMge2lvbmljLkdlc3R1cmV9IFRoZSBnZXN0dXJlIG9iamVjdCAodXNlIHRoaXMgdG8gcmVtb3ZlIHRoZSBnZXN0dXJlIGxhdGVyIG9uKS4KICAgICAgICAgKi8KICAgICAgICBvbjogZnVuY3Rpb24oZXZlbnRUeXBlLCBjYiwgJGVsZW1lbnQpIHsKICAgICAgICAgIHJldHVybiB3aW5kb3cuaW9uaWMub25HZXN0dXJlKGV2ZW50VHlwZSwgY2IsICRlbGVtZW50WzBdKTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkaW9uaWNHZXN0dXJlI29mZgogICAgICAgICAqIEBkZXNjcmlwdGlvbiBSZW1vdmUgYW4gZXZlbnQgbGlzdGVuZXIgZm9yIGEgZ2VzdHVyZSBvbiBhbiBlbGVtZW50LiBTZWUge0BsaW5rIGlvbmljLnV0aWxpdHk6aW9uaWMuRXZlbnRDb250cm9sbGVyI29mZkdlc3R1cmV9LgogICAgICAgICAqIEBwYXJhbSB7aW9uaWMuR2VzdHVyZX0gZ2VzdHVyZSBUaGUgZ2VzdHVyZSB0aGF0IHNob3VsZCBiZSByZW1vdmVkLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudFR5cGUgVGhlIGdlc3R1cmUgZXZlbnQgdG8gcmVtb3ZlIHRoZSBsaXN0ZW5lciBmb3IuCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihlKX0gY2FsbGJhY2sgVGhlIGxpc3RlbmVyIHRvIHJlbW92ZS4KICAgICAgICAgKi8KICAgICAgICBvZmY6IGZ1bmN0aW9uKGdlc3R1cmUsIGV2ZW50VHlwZSwgY2IpIHsKICAgICAgICAgIHJldHVybiB3aW5kb3cuaW9uaWMub2ZmR2VzdHVyZShnZXN0dXJlLCBldmVudFR5cGUsIGNiKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9XSk7CgoKICB2YXIgTE9BRElOR19UUEwgPQogICAgJzxkaXYgY2xhc3M9ImxvYWRpbmctY29udGFpbmVyIj4nICsKICAgICc8ZGl2IGNsYXNzPSJsb2FkaW5nIj4nICsKICAgICc8L2Rpdj4nICsKICAgICc8L2Rpdj4nOwoKICB2YXIgTE9BRElOR19ISURFX0RFUFJFQ0FURUQgPSAnJGlvbmljTG9hZGluZyBpbnN0YW5jZS5oaWRlKCkgaGFzIGJlZW4gZGVwcmVjYXRlZC4gVXNlICRpb25pY0xvYWRpbmcuaGlkZSgpLic7CiAgdmFyIExPQURJTkdfU0hPV19ERVBSRUNBVEVEID0gJyRpb25pY0xvYWRpbmcgaW5zdGFuY2Uuc2hvdygpIGhhcyBiZWVuIGRlcHJlY2F0ZWQuIFVzZSAkaW9uaWNMb2FkaW5nLnNob3coKS4nOwogIHZhciBMT0FESU5HX1NFVF9ERVBSRUNBVEVEID0gJyRpb25pY0xvYWRpbmcgaW5zdGFuY2Uuc2V0Q29udGVudCgpIGhhcyBiZWVuIGRlcHJlY2F0ZWQuIFVzZSAkaW9uaWNMb2FkaW5nLnNob3coeyB0ZW1wbGF0ZTogXCdteSBjb250ZW50XCcgfSkuJzsKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkaW9uaWNMb2FkaW5nCiAgICogQG1vZHVsZSBpb25pYwogICAqIEBkZXNjcmlwdGlvbgogICAqIEFuIG92ZXJsYXkgdGhhdCBjYW4gYmUgdXNlZCB0byBpbmRpY2F0ZSBhY3Rpdml0eSB3aGlsZSBibG9ja2luZyB1c2VyCiAgICogaW50ZXJhY3Rpb24uCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBqcwogICAqIGFuZ3VsYXIubW9kdWxlKCdMb2FkaW5nQXBwJywgWydpb25pYyddKQogICAqIC5jb250cm9sbGVyKCdMb2FkaW5nQ3RybCcsIGZ1bmN0aW9uKCRzY29wZSwgJGlvbmljTG9hZGluZykgewogKiAgICRzY29wZS5zaG93ID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNMb2FkaW5nLnNob3coewogKiAgICAgICB0ZW1wbGF0ZTogJ0xvYWRpbmcuLi4nCiAqICAgICB9KTsKICogICB9OwogKiAgICRzY29wZS5oaWRlID0gZnVuY3Rpb24oKXsKICogICAgICRpb25pY0xvYWRpbmcuaGlkZSgpOwogKiAgIH07CiAqIH0pOwogICAqIGBgYAogICAqLwogIC8qKgogICAqIEBuZ2RvYyBvYmplY3QKICAgKiBAbmFtZSAkaW9uaWNMb2FkaW5nQ29uZmlnCiAgICogQG1vZHVsZSBpb25pYwogICAqIEBkZXNjcmlwdGlvbgogICAqIFNldCB0aGUgZGVmYXVsdCBvcHRpb25zIHRvIGJlIHBhc3NlZCB0byB0aGUge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljTG9hZGluZ30gc2VydmljZS4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGpzCiAgICogdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdteUFwcCcsIFsnaW9uaWMnXSkKICAgKiBhcHAuY29uc3RhbnQoJyRpb25pY0xvYWRpbmdDb25maWcnLCB7CiAqICAgdGVtcGxhdGU6ICdEZWZhdWx0IExvYWRpbmcgVGVtcGxhdGUuLi4nCiAqIH0pOwogICAqIGFwcC5jb250cm9sbGVyKCdBcHBDdHJsJywgZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNMb2FkaW5nKSB7CiAqICAgJHNjb3BlLnNob3dMb2FkaW5nID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNMb2FkaW5nLnNob3coKTsgLy9vcHRpb25zIGRlZmF1bHQgdG8gdmFsdWVzIGluICRpb25pY0xvYWRpbmdDb25maWcKICogICB9OwogKiB9KTsKICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLmNvbnN0YW50KCckaW9uaWNMb2FkaW5nQ29uZmlnJywgewogICAgICB0ZW1wbGF0ZTogJzxpIGNsYXNzPSJpb24tbG9hZGluZy1kIj48L2k+JwogICAgfSkKICAgIC5mYWN0b3J5KCckaW9uaWNMb2FkaW5nJywgWwogICAgICAnJGlvbmljTG9hZGluZ0NvbmZpZycsCiAgICAgICckZG9jdW1lbnQnLAogICAgICAnJGlvbmljVGVtcGxhdGVMb2FkZXInLAogICAgICAnJGlvbmljQmFja2Ryb3AnLAogICAgICAnJHRpbWVvdXQnLAogICAgICAnJHEnLAogICAgICAnJGxvZycsCiAgICAgICckY29tcGlsZScsCiAgICAgICckaW9uaWNQbGF0Zm9ybScsCiAgICAgIGZ1bmN0aW9uKCRpb25pY0xvYWRpbmdDb25maWcsICRkb2N1bWVudCwgJGlvbmljVGVtcGxhdGVMb2FkZXIsICRpb25pY0JhY2tkcm9wLCAkdGltZW91dCwgJHEsICRsb2csICRjb21waWxlLCAkaW9uaWNQbGF0Zm9ybSkgewoKICAgICAgICB2YXIgbG9hZGVySW5zdGFuY2U7CiAgICAgICAgLy9kZWZhdWx0IHZhbHVlcwogICAgICAgIHZhciBkZXJlZ2lzdGVyQmFja0FjdGlvbiA9IGFuZ3VsYXIubm9vcDsKICAgICAgICB2YXIgbG9hZGluZ1Nob3dEZWxheSA9ICRxLndoZW4oKTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGlvbmljTG9hZGluZyNzaG93CiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24gU2hvd3MgYSBsb2FkaW5nIGluZGljYXRvci4gSWYgdGhlIGluZGljYXRvciBpcyBhbHJlYWR5IHNob3duLAogICAgICAgICAgICogaXQgd2lsbCBzZXQgdGhlIG9wdGlvbnMgZ2l2ZW4gYW5kIGtlZXAgdGhlIGluZGljYXRvciBzaG93bi4KICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRzIFRoZSBvcHRpb25zIGZvciB0aGUgbG9hZGluZyBpbmRpY2F0b3IuIEF2YWlsYWJsZSBwcm9wZXJ0aWVzOgogICAgICAgICAgICogIC0gYHtzdHJpbmc9fWAgYHRlbXBsYXRlYCBUaGUgaHRtbCBjb250ZW50IG9mIHRoZSBpbmRpY2F0b3IuCiAgICAgICAgICAgKiAgLSBge3N0cmluZz19YCBgdGVtcGxhdGVVcmxgIFRoZSB1cmwgb2YgYW4gaHRtbCB0ZW1wbGF0ZSB0byBsb2FkIGFzIHRoZSBjb250ZW50IG9mIHRoZSBpbmRpY2F0b3IuCiAgICAgICAgICAgKiAgLSBge2Jvb2xlYW49fWAgYG5vQmFja2Ryb3BgIFdoZXRoZXIgdG8gaGlkZSB0aGUgYmFja2Ryb3AuIEJ5IGRlZmF1bHQgaXQgd2lsbCBiZSBzaG93bi4KICAgICAgICAgICAqICAtIGB7bnVtYmVyPX1gIGBkZWxheWAgSG93IG1hbnkgbWlsbGlzZWNvbmRzIHRvIGRlbGF5IHNob3dpbmcgdGhlIGluZGljYXRvci4gQnkgZGVmYXVsdCB0aGVyZSBpcyBubyBkZWxheS4KICAgICAgICAgICAqICAtIGB7bnVtYmVyPX1gIGBkdXJhdGlvbmAgSG93IG1hbnkgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgYXV0b21hdGljYWxseQogICAgICAgICAgICogIGhpZGluZyB0aGUgaW5kaWNhdG9yLiBCeSBkZWZhdWx0LCB0aGUgaW5kaWNhdG9yIHdpbGwgYmUgc2hvd24gdW50aWwgYC5oaWRlKClgIGlzIGNhbGxlZC4KICAgICAgICAgICAqLwogICAgICAgICAgc2hvdzogc2hvd0xvYWRlciwKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGlvbmljTG9hZGluZyNoaWRlCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24gSGlkZXMgdGhlIGxvYWRpbmcgaW5kaWNhdG9yLCBpZiBzaG93bi4KICAgICAgICAgICAqLwogICAgICAgICAgaGlkZTogaGlkZUxvYWRlciwKICAgICAgICAgIC8qKgogICAgICAgICAgICogQHByaXZhdGUgZm9yIHRlc3RpbmcKICAgICAgICAgICAqLwogICAgICAgICAgX2dldExvYWRlcjogZ2V0TG9hZGVyCiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gZ2V0TG9hZGVyKCkgewogICAgICAgICAgaWYgKCFsb2FkZXJJbnN0YW5jZSkgewogICAgICAgICAgICBsb2FkZXJJbnN0YW5jZSA9ICRpb25pY1RlbXBsYXRlTG9hZGVyLmNvbXBpbGUoewogICAgICAgICAgICAgIHRlbXBsYXRlOiBMT0FESU5HX1RQTCwKICAgICAgICAgICAgICBhcHBlbmRUbzogJGRvY3VtZW50WzBdLmJvZHkKICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihsb2FkZXIpIHsKICAgICAgICAgICAgICAgIHZhciBzZWxmID0gbG9hZGVyOwoKICAgICAgICAgICAgICAgIGxvYWRlci5zaG93ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVQcm9taXNlID0gb3B0aW9ucy50ZW1wbGF0ZVVybCA/CiAgICAgICAgICAgICAgICAgICAgJGlvbmljVGVtcGxhdGVMb2FkZXIubG9hZChvcHRpb25zLnRlbXBsYXRlVXJsKSA6CiAgICAgICAgICAgICAgICAgICAgLy9vcHRpb25zLmNvbnRlbnQ6IGRlcHJlY2F0ZWQKICAgICAgICAgICAgICAgICAgICAkcS53aGVuKG9wdGlvbnMudGVtcGxhdGUgfHwgb3B0aW9ucy5jb250ZW50IHx8ICcnKTsKCgogICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNTaG93bikgewogICAgICAgICAgICAgICAgICAgIC8vb3B0aW9ucy5zaG93QmFja2Ryb3A6IGRlcHJlY2F0ZWQKICAgICAgICAgICAgICAgICAgICB0aGlzLmhhc0JhY2tkcm9wID0gIW9wdGlvbnMubm9CYWNrZHJvcCAmJiBvcHRpb25zLnNob3dCYWNrZHJvcCAhPT0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFja2Ryb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICRpb25pY0JhY2tkcm9wLnJldGFpbigpOwogICAgICAgICAgICAgICAgICAgICAgJGlvbmljQmFja2Ryb3AuZ2V0RWxlbWVudCgpLmFkZENsYXNzKCdiYWNrZHJvcC1sb2FkaW5nJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgICR0aW1lb3V0LmNhbmNlbCh0aGlzLmR1cmF0aW9uVGltZW91dCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kdXJhdGlvblRpbWVvdXQgPSAkdGltZW91dCgKICAgICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuYmluZCh0aGlzLCB0aGlzLmhpZGUpLAogICAgICAgICAgICAgICAgICAgICAgK29wdGlvbnMuZHVyYXRpb24KICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICB0ZW1wbGF0ZVByb21pc2UudGhlbihmdW5jdGlvbihodG1sKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGh0bWwpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBsb2FkaW5nID0gc2VsZi5lbGVtZW50LmNoaWxkcmVuKCk7CiAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nLmh0bWwoaHRtbCk7CiAgICAgICAgICAgICAgICAgICAgICAkY29tcGlsZShsb2FkaW5nLmNvbnRlbnRzKCkpKHNlbGYuc2NvcGUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy9Eb24ndCBzaG93IHVudGlsIHRlbXBsYXRlIGNoYW5nZXMKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5pc1Nob3duKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoJ3Zpc2libGUnKTsKICAgICAgICAgICAgICAgICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pc1Nob3duICYmIHNlbGYuZWxlbWVudC5hZGRDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICRkb2N1bWVudFswXS5ib2R5LmNsYXNzTGlzdC5hZGQoJ2xvYWRpbmctYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgdGhpcy5pc1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBsb2FkZXIuaGlkZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1Nob3duKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzQmFja2Ryb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICRpb25pY0JhY2tkcm9wLnJlbGVhc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICRpb25pY0JhY2tkcm9wLmdldEVsZW1lbnQoKS5yZW1vdmVDbGFzcygnYmFja2Ryb3AtbG9hZGluZycpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICRkb2N1bWVudFswXS5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ2xvYWRpbmctYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICFzZWxmLmlzU2hvd24gJiYgc2VsZi5lbGVtZW50LnJlbW92ZUNsYXNzKCd2aXNpYmxlJyk7CiAgICAgICAgICAgICAgICAgICAgfSwgMjAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAkdGltZW91dC5jYW5jZWwodGhpcy5kdXJhdGlvblRpbWVvdXQpOwogICAgICAgICAgICAgICAgICB0aGlzLmlzU2hvd24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgcmV0dXJuIGxvYWRlcjsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsb2FkZXJJbnN0YW5jZTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNob3dMb2FkZXIob3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IGV4dGVuZCgkaW9uaWNMb2FkaW5nQ29uZmlnIHx8IHt9LCBvcHRpb25zIHx8IHt9KTsKICAgICAgICAgIHZhciBkZWxheSA9IG9wdGlvbnMuZGVsYXkgfHwgb3B0aW9ucy5zaG93RGVsYXkgfHwgMDsKCiAgICAgICAgICAvL0lmIGxvYWRpbmcuc2hvdygpIHdhcyBjYWxsZWQgcHJldmlvdXNseSwgY2FuY2VsIGl0IGFuZCBzaG93IHdpdGggb3VyIG5ldyBvcHRpb25zCiAgICAgICAgICBsb2FkaW5nU2hvd0RlbGF5ICYmICR0aW1lb3V0LmNhbmNlbChsb2FkaW5nU2hvd0RlbGF5KTsKICAgICAgICAgIGxvYWRpbmdTaG93RGVsYXkgPSAkdGltZW91dChhbmd1bGFyLm5vb3AsIGRlbGF5KTsKCiAgICAgICAgICBsb2FkaW5nU2hvd0RlbGF5LnRoZW4oZ2V0TG9hZGVyKS50aGVuKGZ1bmN0aW9uKGxvYWRlcikgewogICAgICAgICAgICBkZXJlZ2lzdGVyQmFja0FjdGlvbigpOwogICAgICAgICAgICAvL0Rpc2FibGUgaGFyZHdhcmUgYmFjayBidXR0b24gd2hpbGUgbG9hZGluZwogICAgICAgICAgICBkZXJlZ2lzdGVyQmFja0FjdGlvbiA9ICRpb25pY1BsYXRmb3JtLnJlZ2lzdGVyQmFja0J1dHRvbkFjdGlvbigKICAgICAgICAgICAgICBhbmd1bGFyLm5vb3AsCiAgICAgICAgICAgICAgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfTE9BRElORwogICAgICAgICAgICApOwogICAgICAgICAgICByZXR1cm4gbG9hZGVyLnNob3cob3B0aW9ucyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBoaWRlOiBkZXByZWNhdGVkLm1ldGhvZChMT0FESU5HX0hJREVfREVQUkVDQVRFRCwgJGxvZy5lcnJvciwgaGlkZUxvYWRlciksCiAgICAgICAgICAgIHNob3c6IGRlcHJlY2F0ZWQubWV0aG9kKExPQURJTkdfU0hPV19ERVBSRUNBVEVELCAkbG9nLmVycm9yLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzaG93TG9hZGVyKG9wdGlvbnMpOwogICAgICAgICAgICB9KSwKICAgICAgICAgICAgc2V0Q29udGVudDogZGVwcmVjYXRlZC5tZXRob2QoTE9BRElOR19TRVRfREVQUkVDQVRFRCwgJGxvZy5lcnJvciwgZnVuY3Rpb24oY29udGVudCkgewogICAgICAgICAgICAgIGdldExvYWRlcigpLnRoZW4oZnVuY3Rpb24obG9hZGVyKSB7CiAgICAgICAgICAgICAgICBsb2FkZXIuc2hvdyh7IHRlbXBsYXRlOiBjb250ZW50IH0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGhpZGVMb2FkZXIoKSB7CiAgICAgICAgICBkZXJlZ2lzdGVyQmFja0FjdGlvbigpOwogICAgICAgICAgJHRpbWVvdXQuY2FuY2VsKGxvYWRpbmdTaG93RGVsYXkpOwogICAgICAgICAgZ2V0TG9hZGVyKCkudGhlbihmdW5jdGlvbihsb2FkZXIpIHsKICAgICAgICAgICAgbG9hZGVyLmhpZGUoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfV0pOwoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRpb25pY01vZGFsCiAgICogQG1vZHVsZSBpb25pYwogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogUmVsYXRlZDoge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNNb2RhbCBpb25pY01vZGFsIGNvbnRyb2xsZXJ9LgogICAqCiAgICogVGhlIE1vZGFsIGlzIGEgY29udGVudCBwYW5lIHRoYXQgY2FuIGdvIG92ZXIgdGhlIHVzZXIncyBtYWluIHZpZXcKICAgKiB0ZW1wb3JhcmlseS4gIFVzdWFsbHkgdXNlZCBmb3IgbWFraW5nIGEgY2hvaWNlIG9yIGVkaXRpbmcgYW4gaXRlbS4KICAgKgogICAqIFB1dCB0aGUgY29udGVudCBvZiB0aGUgbW9kYWwgaW5zaWRlIG9mIGFuIGA8aW9uLW1vZGFsLXZpZXc+YCBlbGVtZW50LgogICAqCiAgICogTm90ZTogYSBtb2RhbCB3aWxsIGJyb2FkY2FzdCAnbW9kYWwuc2hvd24nLCAnbW9kYWwuaGlkZGVuJywgYW5kICdtb2RhbC5yZW1vdmVkJyBldmVudHMgZnJvbSBpdHMgb3JpZ2luYXRpbmcKICAgKiBzY29wZSwgcGFzc2luZyBpbiBpdHNlbGYgYXMgYW4gZXZlbnQgYXJndW1lbnQuIEJvdGggdGhlIG1vZGFsLnJlbW92ZWQgYW5kIG1vZGFsLmhpZGRlbiBldmVudHMgYXJlCiAgICogY2FsbGVkIHdoZW4gdGhlIG1vZGFsIGlzIHJlbW92ZWQuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPHNjcmlwdCBpZD0ibXktbW9kYWwuaHRtbCIgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSI+CiAgICogICA8aW9uLW1vZGFsLXZpZXc+CiAgICogICAgIDxpb24taGVhZGVyLWJhcj4KICAgKiAgICAgICA8aDEgY2xhc3M9InRpdGxlIj5NeSBNb2RhbCB0aXRsZTwvaDE+CiAgICogICAgIDwvaW9uLWhlYWRlci1iYXI+CiAgICogICAgIDxpb24tY29udGVudD4KICAgKiAgICAgICBIZWxsbyEKICAgKiAgICAgPC9pb24tY29udGVudD4KICAgKiAgIDwvaW9uLW1vZGFsLXZpZXc+CiAgICogPC9zY3JpcHQ+CiAgICogYGBgCiAgICogYGBganMKICAgKiBhbmd1bGFyLm1vZHVsZSgndGVzdEFwcCcsIFsnaW9uaWMnXSkKICAgKiAuY29udHJvbGxlcignTXlDb250cm9sbGVyJywgZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNNb2RhbCkgewogKiAgICRpb25pY01vZGFsLmZyb21UZW1wbGF0ZVVybCgnbXktbW9kYWwuaHRtbCcsIHsKICogICAgIHNjb3BlOiAkc2NvcGUsCiAqICAgICBhbmltYXRpb246ICdzbGlkZS1pbi11cCcKICogICB9KS50aGVuKGZ1bmN0aW9uKG1vZGFsKSB7CiAqICAgICAkc2NvcGUubW9kYWwgPSBtb2RhbDsKICogICB9KTsKICogICAkc2NvcGUub3Blbk1vZGFsID0gZnVuY3Rpb24oKSB7CiAqICAgICAkc2NvcGUubW9kYWwuc2hvdygpOwogKiAgIH07CiAqICAgJHNjb3BlLmNsb3NlTW9kYWwgPSBmdW5jdGlvbigpIHsKICogICAgICRzY29wZS5tb2RhbC5oaWRlKCk7CiAqICAgfTsKICogICAvL0NsZWFudXAgdGhlIG1vZGFsIHdoZW4gd2UncmUgZG9uZSB3aXRoIGl0IQogKiAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAqICAgICAkc2NvcGUubW9kYWwucmVtb3ZlKCk7CiAqICAgfSk7CiAqICAgLy8gRXhlY3V0ZSBhY3Rpb24gb24gaGlkZSBtb2RhbAogKiAgICRzY29wZS4kb24oJ21vZGFsLmhpZGRlbicsIGZ1bmN0aW9uKCkgewogKiAgICAgLy8gRXhlY3V0ZSBhY3Rpb24KICogICB9KTsKICogICAvLyBFeGVjdXRlIGFjdGlvbiBvbiByZW1vdmUgbW9kYWwKICogICAkc2NvcGUuJG9uKCdtb2RhbC5yZW1vdmVkJywgZnVuY3Rpb24oKSB7CiAqICAgICAvLyBFeGVjdXRlIGFjdGlvbgogKiAgIH0pOwogKiB9KTsKICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLmZhY3RvcnkoJyRpb25pY01vZGFsJywgWwogICAgICAnJHJvb3RTY29wZScsCiAgICAgICckZG9jdW1lbnQnLAogICAgICAnJGNvbXBpbGUnLAogICAgICAnJHRpbWVvdXQnLAogICAgICAnJGlvbmljUGxhdGZvcm0nLAogICAgICAnJGlvbmljVGVtcGxhdGVMb2FkZXInLAogICAgICAnJHEnLAogICAgICAnJGxvZycsCiAgICAgIGZ1bmN0aW9uKCRyb290U2NvcGUsICRkb2N1bWVudCwgJGNvbXBpbGUsICR0aW1lb3V0LCAkaW9uaWNQbGF0Zm9ybSwgJGlvbmljVGVtcGxhdGVMb2FkZXIsICRxLCAkbG9nKSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBjb250cm9sbGVyCiAgICAgICAgICogQG5hbWUgaW9uaWNNb2RhbAogICAgICAgICAqIEBtb2R1bGUgaW9uaWMKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBJbnN0YW50aWF0ZWQgYnkgdGhlIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY01vZGFsfSBzZXJ2aWNlLgogICAgICAgICAqCiAgICAgICAgICogQmUgc3VyZSB0byBjYWxsIFtyZW1vdmUoKV0oI3JlbW92ZSkgd2hlbiB5b3UgYXJlIGRvbmUgd2l0aCBlYWNoIG1vZGFsCiAgICAgICAgICogdG8gY2xlYW4gaXQgdXAgYW5kIGF2b2lkIG1lbW9yeSBsZWFrcy4KICAgICAgICAgKgogICAgICAgICAqIE5vdGU6IGEgbW9kYWwgd2lsbCBicm9hZGNhc3QgJ21vZGFsLnNob3duJywgJ21vZGFsLmhpZGRlbicsIGFuZCAnbW9kYWwucmVtb3ZlZCcgZXZlbnRzIGZyb20gaXRzIG9yaWdpbmF0aW5nCiAgICAgICAgICogc2NvcGUsIHBhc3NpbmcgaW4gaXRzZWxmIGFzIGFuIGV2ZW50IGFyZ3VtZW50LiBOb3RlOiBib3RoIG1vZGFsLnJlbW92ZWQgYW5kIG1vZGFsLmhpZGRlbiBhcmUKICAgICAgICAgKiBjYWxsZWQgd2hlbiB0aGUgbW9kYWwgaXMgcmVtb3ZlZC4KICAgICAgICAgKi8KICAgICAgICB2YXIgTW9kYWxWaWV3ID0gaW9uaWMudmlld3MuTW9kYWwuaW5oZXJpdCh7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGlvbmljTW9kYWwjaW5pdGlhbGl6ZQogICAgICAgICAgICogQGRlc2NyaXB0aW9uIENyZWF0ZXMgYSBuZXcgbW9kYWwgY29udHJvbGxlciBpbnN0YW5jZS4KICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIEFuIG9wdGlvbnMgb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICAgICAgICogIC0gYHtvYmplY3Q9fWAgYHNjb3BlYCBUaGUgc2NvcGUgdG8gYmUgYSBjaGlsZCBvZi4KICAgICAgICAgICAqICAgIERlZmF1bHQ6IGNyZWF0ZXMgYSBjaGlsZCBvZiAkcm9vdFNjb3BlLgogICAgICAgICAgICogIC0gYHtzdHJpbmc9fWAgYGFuaW1hdGlvbmAgVGhlIGFuaW1hdGlvbiB0byBzaG93ICYgaGlkZSB3aXRoLgogICAgICAgICAgICogICAgRGVmYXVsdDogJ3NsaWRlLWluLXVwJwogICAgICAgICAgICogIC0gYHtib29sZWFuPX1gIGBmb2N1c0ZpcnN0SW5wdXRgIFdoZXRoZXIgdG8gYXV0b2ZvY3VzIHRoZSBmaXJzdCBpbnB1dCBvZgogICAgICAgICAgICogICAgdGhlIG1vZGFsIHdoZW4gc2hvd24uICBEZWZhdWx0OiBmYWxzZS4KICAgICAgICAgICAqICAtIGB7Ym9vbGVhbj19YCBgYmFja2Ryb3BDbGlja1RvQ2xvc2VgIFdoZXRoZXIgdG8gY2xvc2UgdGhlIG1vZGFsIG9uIGNsaWNraW5nIHRoZSBiYWNrZHJvcC4KICAgICAgICAgICAqICAgIERlZmF1bHQ6IHRydWUuCiAgICAgICAgICAgKiAgLSBge2Jvb2xlYW49fWAgYGhhcmR3YXJlQmFja0J1dHRvbkNsb3NlYCBXaGV0aGVyIHRoZSBtb2RhbCBjYW4gYmUgY2xvc2VkIHVzaW5nIHRoZSBoYXJkd2FyZQogICAgICAgICAgICogICAgYmFjayBidXR0b24gb24gQW5kcm9pZCBhbmQgc2ltaWxhciBkZXZpY2VzLiAgRGVmYXVsdDogdHJ1ZS4KICAgICAgICAgICAqLwogICAgICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0cykgewogICAgICAgICAgICBpb25pYy52aWV3cy5Nb2RhbC5wcm90b3R5cGUuaW5pdGlhbGl6ZS5jYWxsKHRoaXMsIG9wdHMpOwogICAgICAgICAgICB0aGlzLmFuaW1hdGlvbiA9IG9wdHMuYW5pbWF0aW9uIHx8ICdzbGlkZS1pbi11cCc7CiAgICAgICAgICB9LAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgaW9uaWNNb2RhbCNzaG93CiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24gU2hvdyB0aGlzIG1vZGFsIGluc3RhbmNlLgogICAgICAgICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBtb2RhbCBpcyBmaW5pc2hlZCBhbmltYXRpbmcgaW4uCiAgICAgICAgICAgKi8KICAgICAgICAgIHNob3c6IGZ1bmN0aW9uKHRhcmdldCkgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgICAgICBpZihzZWxmLnNjb3BlLiQkZGVzdHJveWVkKSB7CiAgICAgICAgICAgICAgJGxvZy5lcnJvcignQ2Fubm90IGNhbGwgJyArICBzZWxmLnZpZXdUeXBlICsgJy5zaG93KCkgYWZ0ZXIgcmVtb3ZlKCkuIFBsZWFzZSBjcmVhdGUgYSBuZXcgJyArICBzZWxmLnZpZXdUeXBlICsgJyBpbnN0YW5jZS4nKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBtb2RhbEVsID0ganFMaXRlKHNlbGYubW9kYWxFbCk7CgogICAgICAgICAgICBzZWxmLmVsLmNsYXNzTGlzdC5yZW1vdmUoJ2hpZGUnKTsKICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAkZG9jdW1lbnRbMF0uYm9keS5jbGFzc0xpc3QuYWRkKHNlbGYudmlld1R5cGUgKyAnLW9wZW4nKTsKICAgICAgICAgICAgfSwgNDAwKTsKCiAgICAgICAgICAgIGlmKCFzZWxmLmVsLnBhcmVudEVsZW1lbnQpIHsKICAgICAgICAgICAgICBtb2RhbEVsLmFkZENsYXNzKHNlbGYuYW5pbWF0aW9uKTsKICAgICAgICAgICAgICAkZG9jdW1lbnRbMF0uYm9keS5hcHBlbmRDaGlsZChzZWxmLmVsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYodGFyZ2V0ICYmIHNlbGYucG9zaXRpb25WaWV3KSB7CiAgICAgICAgICAgICAgc2VsZi5wb3NpdGlvblZpZXcodGFyZ2V0LCBtb2RhbEVsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbW9kYWxFbC5hZGRDbGFzcygnbmctZW50ZXIgYWN0aXZlJykKICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ25nLWxlYXZlIG5nLWxlYXZlLWFjdGl2ZScpOwoKICAgICAgICAgICAgc2VsZi5faXNTaG93biA9IHRydWU7CiAgICAgICAgICAgIHNlbGYuX2RlcmVnaXN0ZXJCYWNrQnV0dG9uID0gJGlvbmljUGxhdGZvcm0ucmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uKAogICAgICAgICAgICAgIHNlbGYuaGFyZHdhcmVCYWNrQnV0dG9uQ2xvc2UgPyBhbmd1bGFyLmJpbmQoc2VsZiwgc2VsZi5oaWRlKSA6IGFuZ3VsYXIubm9vcCwKICAgICAgICAgICAgICBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9NT0RBTAogICAgICAgICAgICApOwoKICAgICAgICAgICAgc2VsZi5faXNPcGVuUHJvbWlzZSA9ICRxLmRlZmVyKCk7CgogICAgICAgICAgICBpb25pYy52aWV3cy5Nb2RhbC5wcm90b3R5cGUuc2hvdy5jYWxsKHNlbGYpOwoKICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBtb2RhbEVsLmFkZENsYXNzKCduZy1lbnRlci1hY3RpdmUnKTsKICAgICAgICAgICAgICBpb25pYy50cmlnZ2VyKCdyZXNpemUnKTsKICAgICAgICAgICAgICBzZWxmLnNjb3BlLiRwYXJlbnQgJiYgc2VsZi5zY29wZS4kcGFyZW50LiRicm9hZGNhc3Qoc2VsZi52aWV3VHlwZSArICcuc2hvd24nLCBzZWxmKTsKICAgICAgICAgICAgICBzZWxmLmVsLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICB9LCAyMCk7CgogICAgICAgICAgICByZXR1cm4gJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgLy9BZnRlciBhbmltYXRpbmcgaW4sIGFsbG93IGhpZGUgb24gYmFja2Ryb3AgY2xpY2sKICAgICAgICAgICAgICBzZWxmLiRlbC5vbignY2xpY2snLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBpZiAoc2VsZi5iYWNrZHJvcENsaWNrVG9DbG9zZSAmJiBlLnRhcmdldCA9PT0gc2VsZi5lbCkgewogICAgICAgICAgICAgICAgICBzZWxmLmhpZGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgNDAwKTsKICAgICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBpb25pY01vZGFsI2hpZGUKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbiBIaWRlIHRoaXMgbW9kYWwgaW5zdGFuY2UuCiAgICAgICAgICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIG1vZGFsIGlzIGZpbmlzaGVkIGFuaW1hdGluZyBvdXQuCiAgICAgICAgICAgKi8KICAgICAgICAgIGhpZGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgIHZhciBtb2RhbEVsID0ganFMaXRlKHNlbGYubW9kYWxFbCk7CgogICAgICAgICAgICBzZWxmLmVsLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICBtb2RhbEVsLmFkZENsYXNzKCduZy1sZWF2ZScpOwoKICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBtb2RhbEVsLmFkZENsYXNzKCduZy1sZWF2ZS1hY3RpdmUnKQogICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKCduZy1lbnRlciBuZy1lbnRlci1hY3RpdmUgYWN0aXZlJyk7CiAgICAgICAgICAgIH0sIDIwKTsKCiAgICAgICAgICAgIHNlbGYuJGVsLm9mZignY2xpY2snKTsKICAgICAgICAgICAgc2VsZi5faXNTaG93biA9IGZhbHNlOwogICAgICAgICAgICBzZWxmLnNjb3BlLiRwYXJlbnQgJiYgc2VsZi5zY29wZS4kcGFyZW50LiRicm9hZGNhc3Qoc2VsZi52aWV3VHlwZSArICcuaGlkZGVuJywgc2VsZik7CiAgICAgICAgICAgIHNlbGYuX2RlcmVnaXN0ZXJCYWNrQnV0dG9uICYmIHNlbGYuX2RlcmVnaXN0ZXJCYWNrQnV0dG9uKCk7CgogICAgICAgICAgICBpb25pYy52aWV3cy5Nb2RhbC5wcm90b3R5cGUuaGlkZS5jYWxsKHNlbGYpOwoKICAgICAgICAgICAgcmV0dXJuICR0aW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgJGRvY3VtZW50WzBdLmJvZHkuY2xhc3NMaXN0LnJlbW92ZShzZWxmLnZpZXdUeXBlICsgJy1vcGVuJyk7CiAgICAgICAgICAgICAgc2VsZi5lbC5jbGFzc0xpc3QuYWRkKCdoaWRlJyk7CiAgICAgICAgICAgIH0sIHNlbGYuaGlkZURlbGF5IHx8IDUwMCk7CiAgICAgICAgICB9LAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgaW9uaWNNb2RhbCNyZW1vdmUKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbiBSZW1vdmUgdGhpcyBtb2RhbCBpbnN0YW5jZSBmcm9tIHRoZSBET00gYW5kIGNsZWFuIHVwLgogICAgICAgICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBtb2RhbCBpcyBmaW5pc2hlZCBhbmltYXRpbmcgb3V0LgogICAgICAgICAgICovCiAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICAgIHNlbGYuc2NvcGUuJHBhcmVudCAmJiBzZWxmLnNjb3BlLiRwYXJlbnQuJGJyb2FkY2FzdChzZWxmLnZpZXdUeXBlICsgJy5yZW1vdmVkJywgc2VsZik7CgogICAgICAgICAgICByZXR1cm4gc2VsZi5oaWRlKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzZWxmLnNjb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgc2VsZi4kZWwucmVtb3ZlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGlvbmljTW9kYWwjaXNTaG93bgogICAgICAgICAgICogQHJldHVybnMgYm9vbGVhbiBXaGV0aGVyIHRoaXMgbW9kYWwgaXMgY3VycmVudGx5IHNob3duLgogICAgICAgICAgICovCiAgICAgICAgICBpc1Nob3duOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICEhdGhpcy5faXNTaG93bjsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdmFyIGNyZWF0ZU1vZGFsID0gZnVuY3Rpb24odGVtcGxhdGVTdHJpbmcsIG9wdGlvbnMpIHsKICAgICAgICAgIC8vIENyZWF0ZSBhIG5ldyBzY29wZSBmb3IgdGhlIG1vZGFsCiAgICAgICAgICB2YXIgc2NvcGUgPSBvcHRpb25zLnNjb3BlICYmIG9wdGlvbnMuc2NvcGUuJG5ldygpIHx8ICRyb290U2NvcGUuJG5ldyh0cnVlKTsKCiAgICAgICAgICBvcHRpb25zLnZpZXdUeXBlID0gb3B0aW9ucy52aWV3VHlwZSB8fCAnbW9kYWwnOwoKICAgICAgICAgIGV4dGVuZChzY29wZSwgewogICAgICAgICAgICAkaGFzSGVhZGVyOiBmYWxzZSwKICAgICAgICAgICAgJGhhc1N1YmhlYWRlcjogZmFsc2UsCiAgICAgICAgICAgICRoYXNGb290ZXI6IGZhbHNlLAogICAgICAgICAgICAkaGFzU3ViZm9vdGVyOiBmYWxzZSwKICAgICAgICAgICAgJGhhc1RhYnM6IGZhbHNlLAogICAgICAgICAgICAkaGFzVGFic1RvcDogZmFsc2UKICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlCiAgICAgICAgICB2YXIgZWxlbWVudCA9ICRjb21waWxlKCc8aW9uLScgKyBvcHRpb25zLnZpZXdUeXBlICsgJz4nICsgdGVtcGxhdGVTdHJpbmcgKyAnPC9pb24tJyArIG9wdGlvbnMudmlld1R5cGUgKyAnPicpKHNjb3BlKTsKCiAgICAgICAgICBvcHRpb25zLiRlbCA9IGVsZW1lbnQ7CiAgICAgICAgICBvcHRpb25zLmVsID0gZWxlbWVudFswXTsKICAgICAgICAgIG9wdGlvbnMubW9kYWxFbCA9IG9wdGlvbnMuZWwucXVlcnlTZWxlY3RvcignLicgKyBvcHRpb25zLnZpZXdUeXBlKTsKICAgICAgICAgIHZhciBtb2RhbCA9IG5ldyBNb2RhbFZpZXcob3B0aW9ucyk7CgogICAgICAgICAgbW9kYWwuc2NvcGUgPSBzY29wZTsKCiAgICAgICAgICAvLyBJZiB0aGlzIHdhc24ndCBhIGRlZmluZWQgc2NvcGUsIHdlIGNhbiBhc3NpZ24gdGhlIHZpZXdUeXBlIHRvIHRoZSBpc29sYXRlZCBzY29wZQogICAgICAgICAgLy8gd2UgY3JlYXRlZAogICAgICAgICAgaWYoIW9wdGlvbnMuc2NvcGUpIHsKICAgICAgICAgICAgc2NvcGVbIG9wdGlvbnMudmlld1R5cGUgXSA9IG1vZGFsOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBtb2RhbDsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNNb2RhbCNmcm9tVGVtcGxhdGUKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZW1wbGF0ZVN0cmluZyBUaGUgdGVtcGxhdGUgc3RyaW5nIHRvIHVzZSBhcyB0aGUgbW9kYWwncwogICAgICAgICAgICogY29udGVudC4KICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIE9wdGlvbnMgdG8gYmUgcGFzc2VkIHtAbGluayBpb25pYy5jb250cm9sbGVyOmlvbmljTW9kYWwjaW5pdGlhbGl6ZSBpb25pY01vZGFsI2luaXRpYWxpemV9IG1ldGhvZC4KICAgICAgICAgICAqIEByZXR1cm5zIHtvYmplY3R9IEFuIGluc3RhbmNlIG9mIGFuIHtAbGluayBpb25pYy5jb250cm9sbGVyOmlvbmljTW9kYWx9CiAgICAgICAgICAgKiBjb250cm9sbGVyLgogICAgICAgICAgICovCiAgICAgICAgICBmcm9tVGVtcGxhdGU6IGZ1bmN0aW9uKHRlbXBsYXRlU3RyaW5nLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBtb2RhbCA9IGNyZWF0ZU1vZGFsKHRlbXBsYXRlU3RyaW5nLCBvcHRpb25zIHx8IHt9KTsKICAgICAgICAgICAgcmV0dXJuIG1vZGFsOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGlvbmljTW9kYWwjZnJvbVRlbXBsYXRlVXJsCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGVtcGxhdGVVcmwgVGhlIHVybCB0byBsb2FkIHRoZSB0ZW1wbGF0ZSBmcm9tLgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgT3B0aW9ucyB0byBiZSBwYXNzZWQge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNNb2RhbCNpbml0aWFsaXplIGlvbmljTW9kYWwjaW5pdGlhbGl6ZX0gbWV0aG9kLgogICAgICAgICAgICogb3B0aW9ucyBvYmplY3QuCiAgICAgICAgICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aXRoIGFuIGluc3RhbmNlIG9mCiAgICAgICAgICAgKiBhbiB7QGxpbmsgaW9uaWMuY29udHJvbGxlcjppb25pY01vZGFsfSBjb250cm9sbGVyLgogICAgICAgICAgICovCiAgICAgICAgICBmcm9tVGVtcGxhdGVVcmw6IGZ1bmN0aW9uKHVybCwgb3B0aW9ucywgXykgewogICAgICAgICAgICB2YXIgY2I7CiAgICAgICAgICAgIC8vRGVwcmVjYXRlZDogYWxsb3cgYSBjYWxsYmFjayBhcyBzZWNvbmQgcGFyYW1ldGVyLiBOb3cgd2UgcmV0dXJuIGEgcHJvbWlzZS4KICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNGdW5jdGlvbihvcHRpb25zKSkgewogICAgICAgICAgICAgIGNiID0gb3B0aW9uczsKICAgICAgICAgICAgICBvcHRpb25zID0gXzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gJGlvbmljVGVtcGxhdGVMb2FkZXIubG9hZCh1cmwpLnRoZW4oZnVuY3Rpb24odGVtcGxhdGVTdHJpbmcpIHsKICAgICAgICAgICAgICB2YXIgbW9kYWwgPSBjcmVhdGVNb2RhbCh0ZW1wbGF0ZVN0cmluZywgb3B0aW9ucyB8fCB7fSk7CiAgICAgICAgICAgICAgY2IgJiYgY2IobW9kYWwpOwogICAgICAgICAgICAgIHJldHVybiBtb2RhbDsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfV0pOwoKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZQogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZWxlZ2F0ZSBmb3IgY29udHJvbGxpbmcgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfSBkaXJlY3RpdmUuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIGBgYGh0bWwKICAgKiA8Ym9keSBuZy1jb250cm9sbGVyPSJNeUN0cmwiPgogICAqICAgPGlvbi1uYXYtYmFyPgogICAqICAgICA8YnV0dG9uIG5nLWNsaWNrPSJzZXROYXZUaXRsZSgnYmFuYW5hJykiPgogICAqICAgICAgIFNldCB0aXRsZSB0byBiYW5hbmEhCiAgICogICAgIDwvYnV0dG9uPgogICAqICAgPC9pb24tbmF2LWJhcj4KICAgKiA8L2JvZHk+CiAgICogYGBgCiAgICogYGBganMKICAgKiBmdW5jdGlvbiBNeUN0cmwoJHNjb3BlLCAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSkgewogKiAgICRzY29wZS5zZXROYXZUaXRsZSA9IGZ1bmN0aW9uKHRpdGxlKSB7CiAqICAgICAkaW9uaWNOYXZCYXJEZWxlZ2F0ZS5zZXRUaXRsZSh0aXRsZSk7CiAqICAgfQogKiB9CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5zZXJ2aWNlKCckaW9uaWNOYXZCYXJEZWxlZ2F0ZScsIGRlbGVnYXRlU2VydmljZShbCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlI2JhY2sKICAgICAqIEBkZXNjcmlwdGlvbiBHb2VzIGJhY2sgaW4gdGhlIHZpZXcgaGlzdG9yeS4KICAgICAqIEBwYXJhbSB7RE9NRXZlbnQ9fSBldmVudCBUaGUgZXZlbnQgb2JqZWN0IChlZyBmcm9tIGEgdGFwIGV2ZW50KQogICAgICovCiAgICAgICdiYWNrJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUjYWxpZ24KICAgICAqIEBkZXNjcmlwdGlvbiBBbGlnbnMgdGhlIHRpdGxlIHdpdGggdGhlIGJ1dHRvbnMgaW4gYSBnaXZlbiBkaXJlY3Rpb24uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IGRpcmVjdGlvbiBUaGUgZGlyZWN0aW9uIHRvIHRoZSBhbGlnbiB0aGUgdGl0bGUgdGV4dCB0b3dhcmRzLgogICAgICogQXZhaWxhYmxlOiAnbGVmdCcsICdyaWdodCcsICdjZW50ZXInLiBEZWZhdWx0OiAnY2VudGVyJy4KICAgICAqLwogICAgICAnYWxpZ24nLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSNzaG93QmFja0J1dHRvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXQvZ2V0IHdoZXRoZXIgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFja0J1dHRvbn0gaXMgc2hvd24KICAgICAqIChpZiBpdCBleGlzdHMpLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdyBXaGV0aGVyIHRvIHNob3cgdGhlIGJhY2sgYnV0dG9uLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGJhY2sgYnV0dG9uIGlzIHNob3duLgogICAgICovCiAgICAgICdzaG93QmFja0J1dHRvbicsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlI3Nob3dCYXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2V0L2dldCB3aGV0aGVyIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0gaXMgc2hvd24uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IHNob3cgV2hldGhlciB0byBzaG93IHRoZSBiYXIuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgYmFyIGlzIHNob3duLgogICAgICovCiAgICAgICdzaG93QmFyJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUjc2V0VGl0bGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2V0IHRoZSB0aXRsZSBmb3IgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0aXRsZSBUaGUgbmV3IHRpdGxlIHRvIHNob3cuCiAgICAgKi8KICAgICAgJ3NldFRpdGxlJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUjY2hhbmdlVGl0bGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ2hhbmdlIHRoZSB0aXRsZSwgdHJhbnNpdGlvbmluZyB0aGUgbmV3IHRpdGxlIGluIGFuZCB0aGUgb2xkIG9uZSBvdXQgaW4gYSBnaXZlbiBkaXJlY3Rpb24uCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGl0bGUgVGhlIG5ldyB0aXRsZSB0byBzaG93LgogICAgICogQHBhcmFtIHtzdHJpbmd9IGRpcmVjdGlvbiBUaGUgZGlyZWN0aW9uIHRvIHRyYW5zaXRpb24gdGhlIG5ldyB0aXRsZSBpbi4KICAgICAqIEF2YWlsYWJsZTogJ2ZvcndhcmQnLCAnYmFjaycuCiAgICAgKi8KICAgICAgJ2NoYW5nZVRpdGxlJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUjZ2V0VGl0bGUKICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBjdXJyZW50IHRpdGxlIG9mIHRoZSBuYXZiYXIuCiAgICAgKi8KICAgICAgJ2dldFRpdGxlJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUjZ2V0UHJldmlvdXNUaXRsZQogICAgICogQHJldHVybnMge3N0cmluZ30gVGhlIHByZXZpb3VzIHRpdGxlIG9mIHRoZSBuYXZiYXIuCiAgICAgKi8KICAgICAgJ2dldFByZXZpb3VzVGl0bGUnCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlIyRnZXRCeUhhbmRsZQogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhbmRsZQogICAgICogQHJldHVybnMgYGRlbGVnYXRlSW5zdGFuY2VgIEEgZGVsZWdhdGUgaW5zdGFuY2UgdGhhdCBjb250cm9scyBvbmx5IHRoZQogICAgICogbmF2QmFycyB3aXRoIGRlbGVnYXRlLWhhbmRsZSBtYXRjaGluZyB0aGUgZ2l2ZW4gaGFuZGxlLgogICAgICoKICAgICAqIEV4YW1wbGU6IGAkaW9uaWNOYXZCYXJEZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ215SGFuZGxlJykuc2V0VGl0bGUoJ25ld1RpdGxlJylgCiAgICAgKi8KICAgIF0pKTsKCiAgdmFyIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX1ZJRVcgPSAxMDA7CiAgdmFyIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX1NJREVfTUVOVSA9IDE1MDsKICB2YXIgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfTU9EQUwgPSAyMDA7CiAgdmFyIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX0FDVElPTl9TSEVFVCA9IDMwMDsKICB2YXIgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfUE9QVVAgPSA0MDA7CiAgdmFyIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX0xPQURJTkcgPSA1MDA7CgogIGZ1bmN0aW9uIGNvbXBvbmVudENvbmZpZyhkZWZhdWx0cykgewogICAgZGVmYXVsdHMuJGdldCA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gZGVmYXVsdHM7IH07CiAgICByZXR1cm4gZGVmYXVsdHM7CiAgfQoKICBJb25pY01vZHVsZQogICAgLmNvbnN0YW50KCckaW9uaWNQbGF0Zm9ybURlZmF1bHRzJywgewogICAgICAnaW9zJzogewogICAgICAgICckaW9uaWNOYXZCYXJDb25maWcnOiB7CiAgICAgICAgICB0cmFuc2l0aW9uOiAnbmF2LXRpdGxlLXNsaWRlLWlvczcnLAogICAgICAgICAgYWxpZ25UaXRsZTogJ2NlbnRlcicsCiAgICAgICAgICBiYWNrQnV0dG9uSWNvbjogJ2lvbi1pb3M3LWFycm93LWJhY2snCiAgICAgICAgfSwKICAgICAgICAnJGlvbmljTmF2Vmlld0NvbmZpZyc6IHsKICAgICAgICAgIHRyYW5zaXRpb246ICdzbGlkZS1sZWZ0LXJpZ2h0LWlvczcnCiAgICAgICAgfSwKICAgICAgICAnJGlvbmljVGFic0NvbmZpZyc6IHsKICAgICAgICAgIHR5cGU6ICcnLAogICAgICAgICAgcG9zaXRpb246ICcnCiAgICAgICAgfQogICAgICB9LAogICAgICAnYW5kcm9pZCc6IHsKICAgICAgICAnJGlvbmljTmF2QmFyQ29uZmlnJzogewogICAgICAgICAgdHJhbnNpdGlvbjogJ25hdi10aXRsZS1zbGlkZS1pb3M3JywKICAgICAgICAgIGFsaWduVGl0bGU6ICdjZW50ZXInLAogICAgICAgICAgYmFja0J1dHRvbkljb246ICdpb24taW9zNy1hcnJvdy1iYWNrJwogICAgICAgIH0sCiAgICAgICAgJyRpb25pY05hdlZpZXdDb25maWcnOiB7CiAgICAgICAgICB0cmFuc2l0aW9uOiAnc2xpZGUtbGVmdC1yaWdodC1pb3M3JwogICAgICAgIH0sCiAgICAgICAgJyRpb25pY1RhYnNDb25maWcnOiB7CiAgICAgICAgICB0eXBlOiAndGFicy1zdHJpcGVkJywKICAgICAgICAgIHBvc2l0aW9uOiAnJwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgoKICBJb25pY01vZHVsZS5jb25maWcoWwogICAgJyRpb25pY1BsYXRmb3JtRGVmYXVsdHMnLAoKICAgICckaW5qZWN0b3InLAoKICAgIGZ1bmN0aW9uKCRpb25pY1BsYXRmb3JtRGVmYXVsdHMsICRpbmplY3RvcikgewogICAgICB2YXIgcGxhdGZvcm0gPSBpb25pYy5QbGF0Zm9ybS5wbGF0Zm9ybSgpOwoKICAgICAgdmFyIGFwcGx5Q29uZmlnID0gZnVuY3Rpb24ocGxhdGZvcm1EZWZhdWx0cykgewogICAgICAgIGZvckVhY2gocGxhdGZvcm1EZWZhdWx0cywgZnVuY3Rpb24oZGVmYXVsdHMsIGNvbnN0YW50TmFtZSkgewogICAgICAgICAgZXh0ZW5kKCRpbmplY3Rvci5nZXQoY29uc3RhbnROYW1lKSwgZGVmYXVsdHMpOwogICAgICAgIH0pOwogICAgICB9OwoKICAgICAgc3dpdGNoKHBsYXRmb3JtKSB7CiAgICAgICAgY2FzZSAnaW9zJzoKICAgICAgICAgIGFwcGx5Q29uZmlnKCRpb25pY1BsYXRmb3JtRGVmYXVsdHMuaW9zKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2FuZHJvaWQnOgogICAgICAgICAgYXBwbHlDb25maWcoJGlvbmljUGxhdGZvcm1EZWZhdWx0cy5hbmRyb2lkKTsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9XSk7CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljUGxhdGZvcm0KICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICogQW4gYW5ndWxhciBhYnN0cmFjdGlvbiBvZiB7QGxpbmsgaW9uaWMudXRpbGl0eTppb25pYy5QbGF0Zm9ybX0uCiAgICoKICAgKiBVc2VkIHRvIGRldGVjdCB0aGUgY3VycmVudCBwbGF0Zm9ybSwgYXMgd2VsbCBhcyBkbyB0aGluZ3MgbGlrZSBvdmVycmlkZSB0aGUKICAgKiBBbmRyb2lkIGJhY2sgYnV0dG9uIGluIFBob25lR2FwL0NvcmRvdmEuCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5wcm92aWRlcignJGlvbmljUGxhdGZvcm0nLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAkZ2V0OiBbJyRxJywgJyRyb290U2NvcGUnLCBmdW5jdGlvbigkcSwgJHJvb3RTY29wZSkgewogICAgICAgICAgdmFyIHNlbGYgPSB7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNQbGF0Zm9ybSNvbkhhcmR3YXJlQmFja0J1dHRvbgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU29tZSBwbGF0Zm9ybXMgaGF2ZSBhIGhhcmR3YXJlIGJhY2sgYnV0dG9uLCBzbyB0aGlzIGlzIG9uZSB3YXkgdG8KICAgICAgICAgICAgICogYmluZCB0byBpdC4KICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgdGhlIGNhbGxiYWNrIHRvIHRyaWdnZXIgd2hlbiB0aGlzIGV2ZW50IG9jY3VycwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgb25IYXJkd2FyZUJhY2tCdXR0b246IGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgICAgICAgaW9uaWMuUGxhdGZvcm0ucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdiYWNrYnV0dG9uJywgY2IsIGZhbHNlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lICRpb25pY1BsYXRmb3JtI29mZkhhcmR3YXJlQmFja0J1dHRvbgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogUmVtb3ZlIGFuIGV2ZW50IGxpc3RlbmVyIGZvciB0aGUgYmFja2J1dHRvbi4KICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGxpc3RlbmVyIGZ1bmN0aW9uIHRoYXQgd2FzCiAgICAgICAgICAgICAqIG9yaWdpbmFsbHkgYm91bmQuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBvZmZIYXJkd2FyZUJhY2tCdXR0b246IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgICAgaW9uaWMuUGxhdGZvcm0ucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdiYWNrYnV0dG9uJywgZm4pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgJGlvbmljUGxhdGZvcm0jcmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBSZWdpc3RlciBhIGhhcmR3YXJlIGJhY2sgYnV0dG9uIGFjdGlvbi4gT25seSBvbmUgYWN0aW9uIHdpbGwgZXhlY3V0ZQogICAgICAgICAgICAgKiB3aGVuIHRoZSBiYWNrIGJ1dHRvbiBpcyBjbGlja2VkLCBzbyB0aGlzIG1ldGhvZCBkZWNpZGVzIHdoaWNoIG9mCiAgICAgICAgICAgICAqIHRoZSByZWdpc3RlcmVkIGJhY2sgYnV0dG9uIGFjdGlvbnMgaGFzIHRoZSBoaWdoZXN0IHByaW9yaXR5LgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBGb3IgZXhhbXBsZSwgaWYgYW4gYWN0aW9uc2hlZXQgaXMgc2hvd2luZywgdGhlIGJhY2sgYnV0dG9uIHNob3VsZAogICAgICAgICAgICAgKiBjbG9zZSB0aGUgYWN0aW9uc2hlZXQsIGJ1dCBpdCBzaG91bGQgbm90IGFsc28gZ28gYmFjayBhIHBhZ2UgdmlldwogICAgICAgICAgICAgKiBvciBjbG9zZSBhIG1vZGFsIHdoaWNoIG1heSBiZSBvcGVuLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgd2hlbiB0aGUgYmFjayBidXR0b24gaXMgcHJlc3NlZCwKICAgICAgICAgICAgICogaWYgdGhpcyBsaXN0ZW5lciBpcyB0aGUgaGlnaGVzdCBwcmlvcml0eS4KICAgICAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IHByaW9yaXR5IE9ubHkgdGhlIGhpZ2hlc3QgcHJpb3JpdHkgd2lsbCBleGVjdXRlLgogICAgICAgICAgICAgKiBAcGFyYW0geyo9fSBhY3Rpb25JZCBUaGUgaWQgdG8gYXNzaWduIHRoaXMgYWN0aW9uLiBEZWZhdWx0OiBhCiAgICAgICAgICAgICAqIHJhbmRvbSB1bmlxdWUgaWQuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbn0gQSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgd2lsbCBkZXJlZ2lzdGVyCiAgICAgICAgICAgICAqIHRoaXMgYmFja0J1dHRvbkFjdGlvbi4KICAgICAgICAgICAgICovCiAgICAgICAgICAgICRiYWNrQnV0dG9uQWN0aW9uczoge30sCiAgICAgICAgICAgIHJlZ2lzdGVyQmFja0J1dHRvbkFjdGlvbjogZnVuY3Rpb24oZm4sIHByaW9yaXR5LCBhY3Rpb25JZCkgewoKICAgICAgICAgICAgICBpZighc2VsZi5faGFzQmFja0J1dHRvbkhhbmRsZXIpIHsKICAgICAgICAgICAgICAgIC8vIGFkZCBhIGJhY2sgYnV0dG9uIGxpc3RlbmVyIGlmIG9uZSBoYXNuJ3QgYmVlbiBzZXR1cCB5ZXQKICAgICAgICAgICAgICAgIHNlbGYuJGJhY2tCdXR0b25BY3Rpb25zID0ge307CiAgICAgICAgICAgICAgICBzZWxmLm9uSGFyZHdhcmVCYWNrQnV0dG9uKHNlbGYuaGFyZHdhcmVCYWNrQnV0dG9uQ2xpY2spOwogICAgICAgICAgICAgICAgc2VsZi5faGFzQmFja0J1dHRvbkhhbmRsZXIgPSB0cnVlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IHsKICAgICAgICAgICAgICAgIGlkOiAoYWN0aW9uSWQgPyBhY3Rpb25JZCA6IGlvbmljLlV0aWxzLm5leHRVaWQoKSksCiAgICAgICAgICAgICAgICBwcmlvcml0eTogKHByaW9yaXR5ID8gcHJpb3JpdHkgOiAwKSwKICAgICAgICAgICAgICAgIGZuOiBmbgogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgc2VsZi4kYmFja0J1dHRvbkFjdGlvbnNbYWN0aW9uLmlkXSA9IGFjdGlvbjsKCiAgICAgICAgICAgICAgLy8gcmV0dXJuIGEgZnVuY3Rpb24gdG8gZGUtcmVnaXN0ZXIgdGhpcyBiYWNrIGJ1dHRvbiBhY3Rpb24KICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgc2VsZi4kYmFja0J1dHRvbkFjdGlvbnNbYWN0aW9uLmlkXTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBoYXJkd2FyZUJhY2tCdXR0b25DbGljazogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgLy8gbG9vcCB0aHJvdWdoIGFsbCB0aGUgcmVnaXN0ZXJlZCBiYWNrIGJ1dHRvbiBhY3Rpb25zCiAgICAgICAgICAgICAgLy8gYW5kIG9ubHkgcnVuIHRoZSBsYXN0IG9uZSBvZiB0aGUgaGlnaGVzdCBwcmlvcml0eQogICAgICAgICAgICAgIHZhciBwcmlvcml0eUFjdGlvbiwgYWN0aW9uSWQ7CiAgICAgICAgICAgICAgZm9yKGFjdGlvbklkIGluIHNlbGYuJGJhY2tCdXR0b25BY3Rpb25zKSB7CiAgICAgICAgICAgICAgICBpZighcHJpb3JpdHlBY3Rpb24gfHwgc2VsZi4kYmFja0J1dHRvbkFjdGlvbnNbYWN0aW9uSWRdLnByaW9yaXR5ID49IHByaW9yaXR5QWN0aW9uLnByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgIHByaW9yaXR5QWN0aW9uID0gc2VsZi4kYmFja0J1dHRvbkFjdGlvbnNbYWN0aW9uSWRdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZihwcmlvcml0eUFjdGlvbikgewogICAgICAgICAgICAgICAgcHJpb3JpdHlBY3Rpb24uZm4oZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJpb3JpdHlBY3Rpb247CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaXM6IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICAgICAgICByZXR1cm4gaW9uaWMuUGxhdGZvcm0uaXModHlwZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNQbGF0Zm9ybSNyZWFkeQogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogVHJpZ2dlciBhIGNhbGxiYWNrIG9uY2UgdGhlIGRldmljZSBpcyByZWFkeSwKICAgICAgICAgICAgICogb3IgaW1tZWRpYXRlbHkgaWYgdGhlIGRldmljZSBpcyBhbHJlYWR5IHJlYWR5LgogICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uPX0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRvIGNhbGwuCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgZGV2aWNlIGlzIHJlYWR5LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgICAgICAgdmFyIHEgPSAkcS5kZWZlcigpOwoKICAgICAgICAgICAgICBpb25pYy5QbGF0Zm9ybS5yZWFkeShmdW5jdGlvbigpewogICAgICAgICAgICAgICAgcS5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICBjYiAmJiBjYigpOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICByZXR1cm4gcS5wcm9taXNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgfV0KICAgICAgfTsKCiAgICB9KTsKCgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljUG9wb3ZlcgogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIFJlbGF0ZWQ6IHtAbGluayBpb25pYy5jb250cm9sbGVyOmlvbmljUG9wb3ZlciBpb25pY1BvcG92ZXIgY29udHJvbGxlcn0uCiAgICoKICAgKiBUaGUgUG9wb3ZlciBpcyBhIHZpZXcgdGhhdCBmbG9hdHMgYWJvdmUgYW4gYXBw4oCZcyBjb250ZW50LiBQb3BvdmVycyBwcm92aWRlIGFuCiAgICogZWFzeSB3YXkgdG8gcHJlc2VudCBvciBnYXRoZXIgaW5mb3JtYXRpb24gZnJvbSB0aGUgdXNlciBhbmQgYXJlCiAgICogY29tbW9ubHkgdXNlZCBpbiB0aGUgZm9sbG93aW5nIHNpdHVhdGlvbnM6CiAgICoKICAgKiAtIFNob3cgbW9yZSBpbmZvIGFib3V0IHRoZSBjdXJyZW50IHZpZXcKICAgKiAtIFNlbGVjdCBhIGNvbW1vbmx5IHVzZWQgdG9vbCBvciBjb25maWd1cmF0aW9uCiAgICogLSBQcmVzZW50IGEgbGlzdCBvZiBhY3Rpb25zIHRvIHBlcmZvcm0gaW5zaWRlIG9uZSBvZiB5b3VyIHZpZXdzCiAgICoKICAgKiBQdXQgdGhlIGNvbnRlbnQgb2YgdGhlIHBvcG92ZXIgaW5zaWRlIG9mIGFuIGA8aW9uLXBvcG92ZXItdmlldz5gIGVsZW1lbnQuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPHA+CiAgICogICA8YnV0dG9uIG5nLWNsaWNrPSJvcGVuUG9wb3ZlcigkZXZlbnQpIj5PcGVuIFBvcG92ZXI8L2J1dHRvbj4KICAgKiA8L3A+CiAgICoKICAgKiA8c2NyaXB0IGlkPSJteS1wb3BvdmVyLmh0bWwiIHR5cGU9InRleHQvbmctdGVtcGxhdGUiPgogICAqICAgPGlvbi1wb3BvdmVyLXZpZXc+CiAgICogICAgIDxpb24taGVhZGVyLWJhcj4KICAgKiAgICAgICA8aDEgY2xhc3M9InRpdGxlIj5NeSBQb3BvdmVyIFRpdGxlPC9oMT4KICAgKiAgICAgPC9pb24taGVhZGVyLWJhcj4KICAgKiAgICAgPGlvbi1jb250ZW50PgogICAqICAgICAgIEhlbGxvIQogICAqICAgICA8L2lvbi1jb250ZW50PgogICAqICAgPC9pb24tcG9wb3Zlci12aWV3PgogICAqIDwvc2NyaXB0PgogICAqIGBgYAogICAqIGBgYGpzCiAgICogYW5ndWxhci5tb2R1bGUoJ3Rlc3RBcHAnLCBbJ2lvbmljJ10pCiAgICogLmNvbnRyb2xsZXIoJ015Q29udHJvbGxlcicsIGZ1bmN0aW9uKCRzY29wZSwgJGlvbmljUG9wb3ZlcikgewogKiAgICRpb25pY1BvcG92ZXIuZnJvbVRlbXBsYXRlVXJsKCdteS1wb3BvdmVyLmh0bWwnLCB7CiAqICAgICBzY29wZTogJHNjb3BlLAogKiAgIH0pLnRoZW4oZnVuY3Rpb24ocG9wb3ZlcikgewogKiAgICAgJHNjb3BlLnBvcG92ZXIgPSBwb3BvdmVyOwogKiAgIH0pOwogKiAgICRzY29wZS5vcGVuUG9wb3ZlciA9IGZ1bmN0aW9uKCRldmVudCkgewogKiAgICAgJHNjb3BlLnBvcG92ZXIuc2hvdygkZXZlbnQpOwogKiAgIH07CiAqICAgJHNjb3BlLmNsb3NlUG9wb3ZlciA9IGZ1bmN0aW9uKCkgewogKiAgICAgJHNjb3BlLnBvcG92ZXIuaGlkZSgpOwogKiAgIH07CiAqICAgLy9DbGVhbnVwIHRoZSBwb3BvdmVyIHdoZW4gd2UncmUgZG9uZSB3aXRoIGl0IQogKiAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAqICAgICAkc2NvcGUucG9wb3Zlci5yZW1vdmUoKTsKICogICB9KTsKICogICAvLyBFeGVjdXRlIGFjdGlvbiBvbiBoaWRlIHBvcG92ZXIKICogICAkc2NvcGUuJG9uKCdwb3BvdmVyLmhpZGRlbicsIGZ1bmN0aW9uKCkgewogKiAgICAgLy8gRXhlY3V0ZSBhY3Rpb24KICogICB9KTsKICogICAvLyBFeGVjdXRlIGFjdGlvbiBvbiByZW1vdmUgcG9wb3ZlcgogKiAgICRzY29wZS4kb24oJ3BvcG92ZXIucmVtb3ZlZCcsIGZ1bmN0aW9uKCkgewogKiAgICAgLy8gRXhlY3V0ZSBhY3Rpb24KICogICB9KTsKICogfSk7CiAgICogYGBgCiAgICovCgoKICBJb25pY01vZHVsZQogICAgLmZhY3RvcnkoJyRpb25pY1BvcG92ZXInLCBbJyRpb25pY01vZGFsJywgJyRpb25pY1Bvc2l0aW9uJywgJyRkb2N1bWVudCcsCiAgICAgIGZ1bmN0aW9uKCRpb25pY01vZGFsLCAkaW9uaWNQb3NpdGlvbiwgJGRvY3VtZW50KSB7CgogICAgICAgIHZhciBQT1BPVkVSX0JPRFlfUEFERElORyA9IDY7CgogICAgICAgIHZhciBQT1BPVkVSX09QVElPTlMgPSB7CiAgICAgICAgICB2aWV3VHlwZTogJ3BvcG92ZXInLAogICAgICAgICAgaGlkZURlbGF5OiAxLAogICAgICAgICAgYW5pbWF0aW9uOiAnbm9uZScsCiAgICAgICAgICBwb3NpdGlvblZpZXc6IHBvc2l0aW9uVmlldwogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIHBvc2l0aW9uVmlldyh0YXJnZXQsIHBvcG92ZXJFbGUpIHsKICAgICAgICAgIHZhciB0YXJnZXRFbGUgPSBhbmd1bGFyLmVsZW1lbnQodGFyZ2V0LnRhcmdldCB8fCB0YXJnZXQpOwogICAgICAgICAgdmFyIGJ1dHRvbk9mZnNldCA9ICRpb25pY1Bvc2l0aW9uLm9mZnNldCggdGFyZ2V0RWxlICk7CiAgICAgICAgICB2YXIgcG9wb3ZlcldpZHRoID0gcG9wb3ZlckVsZS5wcm9wKCdvZmZzZXRXaWR0aCcpOwogICAgICAgICAgdmFyIGJvZHlXaWR0aCA9ICRkb2N1bWVudFswXS5ib2R5LmNsaWVudFdpZHRoOwogICAgICAgICAgdmFyIGJvZHlIZWlnaHQgPSAkZG9jdW1lbnRbMF0uYm9keS5jbGllbnRIZWlnaHQ7CgogICAgICAgICAgdmFyIHBvcG92ZXJDU1MgPSB7CiAgICAgICAgICAgIHRvcDogYnV0dG9uT2Zmc2V0LnRvcCArIGJ1dHRvbk9mZnNldC5oZWlnaHQsCiAgICAgICAgICAgIGxlZnQ6IGJ1dHRvbk9mZnNldC5sZWZ0ICsgYnV0dG9uT2Zmc2V0LndpZHRoIC8gMiAtIHBvcG92ZXJXaWR0aCAvIDIKICAgICAgICAgIH07CgogICAgICAgICAgaWYocG9wb3ZlckNTUy5sZWZ0IDwgUE9QT1ZFUl9CT0RZX1BBRERJTkcpIHsKICAgICAgICAgICAgcG9wb3ZlckNTUy5sZWZ0ID0gUE9QT1ZFUl9CT0RZX1BBRERJTkc7CiAgICAgICAgICB9IGVsc2UgaWYocG9wb3ZlckNTUy5sZWZ0ICsgcG9wb3ZlcldpZHRoICsgUE9QT1ZFUl9CT0RZX1BBRERJTkcgPiBib2R5V2lkdGgpIHsKICAgICAgICAgICAgcG9wb3ZlckNTUy5sZWZ0ID0gYm9keVdpZHRoIC0gcG9wb3ZlcldpZHRoIC0gUE9QT1ZFUl9CT0RZX1BBRERJTkc7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGFycm93RWxlID0gcG9wb3ZlckVsZVswXS5xdWVyeVNlbGVjdG9yKCcucG9wb3Zlci1hcnJvdycpOwogICAgICAgICAgYW5ndWxhci5lbGVtZW50KGFycm93RWxlKS5jc3MoewogICAgICAgICAgICBsZWZ0OiAoYnV0dG9uT2Zmc2V0LmxlZnQgLSBwb3BvdmVyQ1NTLmxlZnQpICsgKGJ1dHRvbk9mZnNldC53aWR0aCAvIDIpIC0gKGFycm93RWxlLm9mZnNldFdpZHRoIC8gMikgKyAncHgnCiAgICAgICAgICB9KTsKCiAgICAgICAgICBwb3BvdmVyRWxlLmNzcyh7CiAgICAgICAgICAgIHRvcDogcG9wb3ZlckNTUy50b3AgKyAncHgnLAogICAgICAgICAgICBsZWZ0OiBwb3BvdmVyQ1NTLmxlZnQgKyAncHgnLAogICAgICAgICAgICBtYXJnaW5MZWZ0OiAnMCcsCiAgICAgICAgICAgIG9wYWNpdHk6ICcxJwogICAgICAgICAgfSk7CgogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGNvbnRyb2xsZXIKICAgICAgICAgKiBAbmFtZSBpb25pY1BvcG92ZXIKICAgICAgICAgKiBAbW9kdWxlIGlvbmljCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogSW5zdGFudGlhdGVkIGJ5IHRoZSB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNQb3BvdmVyfSBzZXJ2aWNlLgogICAgICAgICAqCiAgICAgICAgICogQmUgc3VyZSB0byBjYWxsIFtyZW1vdmUoKV0oI3JlbW92ZSkgd2hlbiB5b3UgYXJlIGRvbmUgd2l0aCBlYWNoIHBvcG92ZXIKICAgICAgICAgKiB0byBjbGVhbiBpdCB1cCBhbmQgYXZvaWQgbWVtb3J5IGxlYWtzLgogICAgICAgICAqCiAgICAgICAgICogTm90ZTogYSBwb3BvdmVyIHdpbGwgYnJvYWRjYXN0ICdwb3BvdmVyLnNob3duJywgJ3BvcG92ZXIuaGlkZGVuJywgYW5kICdwb3BvdmVyLnJlbW92ZWQnIGV2ZW50cyBmcm9tIGl0cyBvcmlnaW5hdGluZwogICAgICAgICAqIHNjb3BlLCBwYXNzaW5nIGluIGl0c2VsZiBhcyBhbiBldmVudCBhcmd1bWVudC4gQm90aCB0aGUgcG9wb3Zlci5yZW1vdmVkIGFuZCBwb3BvdmVyLmhpZGRlbiBldmVudHMgYXJlCiAgICAgICAgICogY2FsbGVkIHdoZW4gdGhlIHBvcG92ZXIgaXMgcmVtb3ZlZC4KICAgICAgICAgKi8KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIGlvbmljUG9wb3ZlciNpbml0aWFsaXplCiAgICAgICAgICogQGRlc2NyaXB0aW9uIENyZWF0ZXMgYSBuZXcgcG9wb3ZlciBjb250cm9sbGVyIGluc3RhbmNlLgogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIEFuIG9wdGlvbnMgb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICAgICAqICAtIGB7b2JqZWN0PX1gIGBzY29wZWAgVGhlIHNjb3BlIHRvIGJlIGEgY2hpbGQgb2YuCiAgICAgICAgICogICAgRGVmYXVsdDogY3JlYXRlcyBhIGNoaWxkIG9mICRyb290U2NvcGUuCiAgICAgICAgICogIC0gYHtib29sZWFuPX1gIGBmb2N1c0ZpcnN0SW5wdXRgIFdoZXRoZXIgdG8gYXV0b2ZvY3VzIHRoZSBmaXJzdCBpbnB1dCBvZgogICAgICAgICAqICAgIHRoZSBwb3BvdmVyIHdoZW4gc2hvd24uICBEZWZhdWx0OiBmYWxzZS4KICAgICAgICAgKiAgLSBge2Jvb2xlYW49fWAgYGJhY2tkcm9wQ2xpY2tUb0Nsb3NlYCBXaGV0aGVyIHRvIGNsb3NlIHRoZSBwb3BvdmVyIG9uIGNsaWNraW5nIHRoZSBiYWNrZHJvcC4KICAgICAgICAgKiAgICBEZWZhdWx0OiB0cnVlLgogICAgICAgICAqICAtIGB7Ym9vbGVhbj19YCBgaGFyZHdhcmVCYWNrQnV0dG9uQ2xvc2VgIFdoZXRoZXIgdGhlIHBvcG92ZXIgY2FuIGJlIGNsb3NlZCB1c2luZyB0aGUgaGFyZHdhcmUKICAgICAgICAgKiAgICBiYWNrIGJ1dHRvbiBvbiBBbmRyb2lkIGFuZCBzaW1pbGFyIGRldmljZXMuICBEZWZhdWx0OiB0cnVlLgogICAgICAgICAqLwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgaW9uaWNQb3BvdmVyI3Nob3cKICAgICAgICAgKiBAZGVzY3JpcHRpb24gU2hvdyB0aGlzIHBvcG92ZXIgaW5zdGFuY2UuCiAgICAgICAgICogQHBhcmFtIHskZXZlbnR9ICRldmVudCBUaGUgJGV2ZW50IG9yIHRhcmdldCBlbGVtZW50IHdoaWNoIHRoZSBwb3BvdmVyIHNob3VsZCBhbGlnbgogICAgICAgICAqIGl0c2VsZiBuZXh0IHRvLgogICAgICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgcG9wb3ZlciBpcyBmaW5pc2hlZCBhbmltYXRpbmcgaW4uCiAgICAgICAgICovCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBpb25pY1BvcG92ZXIjaGlkZQogICAgICAgICAqIEBkZXNjcmlwdGlvbiBIaWRlIHRoaXMgcG9wb3ZlciBpbnN0YW5jZS4KICAgICAgICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIHBvcG92ZXIgaXMgZmluaXNoZWQgYW5pbWF0aW5nIG91dC4KICAgICAgICAgKi8KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIGlvbmljUG9wb3ZlciNyZW1vdmUKICAgICAgICAgKiBAZGVzY3JpcHRpb24gUmVtb3ZlIHRoaXMgcG9wb3ZlciBpbnN0YW5jZSBmcm9tIHRoZSBET00gYW5kIGNsZWFuIHVwLgogICAgICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgcG9wb3ZlciBpcyBmaW5pc2hlZCBhbmltYXRpbmcgb3V0LgogICAgICAgICAqLwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgaW9uaWNQb3BvdmVyI2lzU2hvd24KICAgICAgICAgKiBAcmV0dXJucyBib29sZWFuIFdoZXRoZXIgdGhpcyBwb3BvdmVyIGlzIGN1cnJlbnRseSBzaG93bi4KICAgICAgICAgKi8KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGlvbmljUG9wb3ZlciNmcm9tVGVtcGxhdGUKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZW1wbGF0ZVN0cmluZyBUaGUgdGVtcGxhdGUgc3RyaW5nIHRvIHVzZSBhcyB0aGUgcG9wb3ZlcnMncwogICAgICAgICAgICogY29udGVudC4KICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIE9wdGlvbnMgdG8gYmUgcGFzc2VkIHRvIHRoZSBpbml0aWFsaXplIG1ldGhvZC4KICAgICAgICAgICAqIEByZXR1cm5zIHtvYmplY3R9IEFuIGluc3RhbmNlIG9mIGFuIHtAbGluayBpb25pYy5jb250cm9sbGVyOmlvbmljUG9wb3Zlcn0KICAgICAgICAgICAqIGNvbnRyb2xsZXIgKCRpb25pY1BvcG92ZXIgaXMgYnVpbHQgb24gdG9wIG9mICRpb25pY1BvcG92ZXIpLgogICAgICAgICAgICovCiAgICAgICAgICBmcm9tVGVtcGxhdGU6IGZ1bmN0aW9uKHRlbXBsYXRlU3RyaW5nLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiAkaW9uaWNNb2RhbC5mcm9tVGVtcGxhdGUodGVtcGxhdGVTdHJpbmcsIGlvbmljLlV0aWxzLmV4dGVuZChvcHRpb25zIHx8IHt9LCBQT1BPVkVSX09QVElPTlMpICk7CiAgICAgICAgICB9LAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNQb3BvdmVyI2Zyb21UZW1wbGF0ZVVybAogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRlbXBsYXRlVXJsIFRoZSB1cmwgdG8gbG9hZCB0aGUgdGVtcGxhdGUgZnJvbS4KICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIE9wdGlvbnMgdG8gYmUgcGFzc2VkIHRvIHRoZSBpbml0aWFsaXplIG1ldGhvZC4KICAgICAgICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdpdGggYW4gaW5zdGFuY2Ugb2YKICAgICAgICAgICAqIGFuIHtAbGluayBpb25pYy5jb250cm9sbGVyOmlvbmljUG9wb3Zlcn0gY29udHJvbGxlciAoJGlvbmljUG9wb3ZlciBpcyBidWlsdCBvbiB0b3Agb2YgJGlvbmljUG9wb3ZlcikuCiAgICAgICAgICAgKi8KICAgICAgICAgIGZyb21UZW1wbGF0ZVVybDogZnVuY3Rpb24odXJsLCBvcHRpb25zLCBfKSB7CiAgICAgICAgICAgIHJldHVybiAkaW9uaWNNb2RhbC5mcm9tVGVtcGxhdGVVcmwodXJsLCBvcHRpb25zLCBpb25pYy5VdGlscy5leHRlbmQob3B0aW9ucyB8fCB7fSwgUE9QT1ZFUl9PUFRJT05TKSApOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICB9XSk7CgoKICB2YXIgUE9QVVBfVFBMID0KICAgICc8ZGl2IGNsYXNzPSJwb3B1cCI+JyArCiAgICAnPGRpdiBjbGFzcz0icG9wdXAtaGVhZCI+JyArCiAgICAnPGgzIGNsYXNzPSJwb3B1cC10aXRsZSIgbmctYmluZC1odG1sPSJ0aXRsZSI+PC9oMz4nICsKICAgICc8aDUgY2xhc3M9InBvcHVwLXN1Yi10aXRsZSIgbmctYmluZC1odG1sPSJzdWJUaXRsZSIgbmctaWY9InN1YlRpdGxlIj48L2g1PicgKwogICAgJzwvZGl2PicgKwogICAgJzxkaXYgY2xhc3M9InBvcHVwLWJvZHkiPicgKwogICAgJzwvZGl2PicgKwogICAgJzxkaXYgY2xhc3M9InBvcHVwLWJ1dHRvbnMgcm93Ij4nICsKICAgICc8YnV0dG9uIG5nLXJlcGVhdD0iYnV0dG9uIGluIGJ1dHRvbnMiIG5nLWNsaWNrPSIkYnV0dG9uVGFwcGVkKGJ1dHRvbiwgJGV2ZW50KSIgY2xhc3M9ImJ1dHRvbiBjb2wiIG5nLWNsYXNzPSJidXR0b24udHlwZSB8fCBcJ2J1dHRvbi1kZWZhdWx0XCciIG5nLWJpbmQtaHRtbD0iYnV0dG9uLnRleHQiPjwvYnV0dG9uPicgKwogICAgJzwvZGl2PicgKwogICAgJzwvZGl2Pic7CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljUG9wdXAKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKiBAY29kZXBlbiB6a21oSgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogVGhlIElvbmljIFBvcHVwIHNlcnZpY2UgYWxsb3dzIHByb2dyYW1tYXRpY2FsbHkgY3JlYXRpbmcgYW5kIHNob3dpbmcgcG9wdXAKICAgKiB3aW5kb3dzIHRoYXQgcmVxdWlyZSB0aGUgdXNlciB0byByZXNwb25kIGluIG9yZGVyIHRvIGNvbnRpbnVlLgogICAqCiAgICogVGhlIHBvcHVwIHN5c3RlbSBoYXMgc3VwcG9ydCBmb3IgbW9yZSBmbGV4aWJsZSB2ZXJzaW9ucyBvZiB0aGUgYnVpbHQgaW4gYGFsZXJ0KClgLCBgcHJvbXB0KClgLAogICAqIGFuZCBgY29uZmlybSgpYCBmdW5jdGlvbnMgdGhhdCB1c2VycyBhcmUgdXNlZCB0bywgaW4gYWRkaXRpb24gdG8gYWxsb3dpbmcgcG9wdXBzIHdpdGggY29tcGxldGVseQogICAqIGN1c3RvbSBjb250ZW50IGFuZCBsb29rLgogICAqCiAgICogQW4gaW5wdXQgY2FuIGJlIGdpdmVuIGFuIGBhdXRvZm9jdXNgIGF0dHJpYnV0ZSBzbyBpdCBhdXRvbWF0aWNhbGx5IHJlY2VpdmVzIGZvY3VzIHdoZW4KICAgKiB0aGUgcG9wdXAgZmlyc3Qgc2hvd3MuIEhvd2V2ZXIsIGRlcGVuZGluZyBvbiBjZXJ0YWluIHVzZS1jYXNlcyB0aGlzIGNhbiBjYXVzZSBpc3N1ZXMgd2l0aAogICAqIHRoZSB0YXAvY2xpY2sgc3lzdGVtLCB3aGljaCBpcyB3aHkgSW9uaWMgcHJlZmVycyB1c2luZyB0aGUgYGF1dG9mb2N1c2AgYXR0cmlidXRlIGFzCiAgICogYW4gb3B0LWluIGZlYXR1cmUgYW5kIG5vdCB0aGUgZGVmYXVsdC4KICAgKgogICAqIEB1c2FnZQogICAqIEEgZmV3IGJhc2ljIGV4YW1wbGVzLCBzZWUgYmVsb3cgZm9yIGRldGFpbHMgYWJvdXQgYWxsIG9mIHRoZSBvcHRpb25zIGF2YWlsYWJsZS4KICAgKgogICAqIGBgYGpzCiAgICphbmd1bGFyLm1vZHVsZSgnbXlTdXBlckFwcCcsIFsnaW9uaWMnXSkKICAgKi5jb250cm9sbGVyKCdQb3B1cEN0cmwnLGZ1bmN0aW9uKCRzY29wZSwgJGlvbmljUG9wdXAsICR0aW1lb3V0KSB7CiAqCiAqIC8vIFRyaWdnZXJlZCBvbiBhIGJ1dHRvbiBjbGljaywgb3Igc29tZSBvdGhlciB0YXJnZXQKICogJHNjb3BlLnNob3dQb3B1cCA9IGZ1bmN0aW9uKCkgewogKiAgICRzY29wZS5kYXRhID0ge30KICoKICogICAvLyBBbiBlbGFib3JhdGUsIGN1c3RvbSBwb3B1cAogKiAgIHZhciBteVBvcHVwID0gJGlvbmljUG9wdXAuc2hvdyh7CiAqICAgICB0ZW1wbGF0ZTogJzxpbnB1dCB0eXBlPSJwYXNzd29yZCIgbmctbW9kZWw9ImRhdGEud2lmaSI+JywKICogICAgIHRpdGxlOiAnRW50ZXIgV2ktRmkgUGFzc3dvcmQnLAogKiAgICAgc3ViVGl0bGU6ICdQbGVhc2UgdXNlIG5vcm1hbCB0aGluZ3MnLAogKiAgICAgc2NvcGU6ICRzY29wZSwKICogICAgIGJ1dHRvbnM6IFsKICogICAgICAgeyB0ZXh0OiAnQ2FuY2VsJyB9LAogKiAgICAgICB7CiAqICAgICAgICAgdGV4dDogJzxiPlNhdmU8L2I+JywKICogICAgICAgICB0eXBlOiAnYnV0dG9uLXBvc2l0aXZlJywKICogICAgICAgICBvblRhcDogZnVuY3Rpb24oZSkgewogKiAgICAgICAgICAgaWYgKCEkc2NvcGUuZGF0YS53aWZpKSB7CiAqICAgICAgICAgICAgIC8vZG9uJ3QgYWxsb3cgdGhlIHVzZXIgdG8gY2xvc2UgdW5sZXNzIGhlIGVudGVycyB3aWZpIHBhc3N3b3JkCiAqICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICogICAgICAgICAgIH0gZWxzZSB7CiAqICAgICAgICAgICAgIHJldHVybiAkc2NvcGUuZGF0YS53aWZpOwogKiAgICAgICAgICAgfQogKiAgICAgICAgIH0KICogICAgICAgfSwKICogICAgIF0KICogICB9KTsKICogICBteVBvcHVwLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAqICAgICBjb25zb2xlLmxvZygnVGFwcGVkIScsIHJlcyk7CiAqICAgfSk7CiAqICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAqICAgICAgbXlQb3B1cC5jbG9zZSgpOyAvL2Nsb3NlIHRoZSBwb3B1cCBhZnRlciAzIHNlY29uZHMgZm9yIHNvbWUgcmVhc29uCiAqICAgfSwgMzAwMCk7CiAqICB9OwogKiAgLy8gQSBjb25maXJtIGRpYWxvZwogKiAgJHNjb3BlLnNob3dDb25maXJtID0gZnVuY3Rpb24oKSB7CiAqICAgIHZhciBjb25maXJtUG9wdXAgPSAkaW9uaWNQb3B1cC5jb25maXJtKHsKICogICAgICB0aXRsZTogJ0NvbnN1bWUgSWNlIENyZWFtJywKICogICAgICB0ZW1wbGF0ZTogJ0FyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBlYXQgdGhpcyBpY2UgY3JlYW0/JwogKiAgICB9KTsKICogICAgY29uZmlybVBvcHVwLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAqICAgICAgaWYocmVzKSB7CiAqICAgICAgICBjb25zb2xlLmxvZygnWW91IGFyZSBzdXJlJyk7CiAqICAgICAgfSBlbHNlIHsKICogICAgICAgIGNvbnNvbGUubG9nKCdZb3UgYXJlIG5vdCBzdXJlJyk7CiAqICAgICAgfQogKiAgICB9KTsKICogIH07CiAqCiAqICAvLyBBbiBhbGVydCBkaWFsb2cKICogICRzY29wZS5zaG93QWxlcnQgPSBmdW5jdGlvbigpIHsKICogICAgdmFyIGFsZXJ0UG9wdXAgPSAkaW9uaWNQb3B1cC5hbGVydCh7CiAqICAgICAgdGl0bGU6ICdEb25cJ3QgZWF0IHRoYXQhJywKICogICAgICB0ZW1wbGF0ZTogJ0l0IG1pZ2h0IHRhc3RlIGdvb2QnCiAqICAgIH0pOwogKiAgICBhbGVydFBvcHVwLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAqICAgICAgY29uc29sZS5sb2coJ1RoYW5rIHlvdSBmb3Igbm90IGVhdGluZyBteSBkZWxpY2lvdXMgaWNlIGNyZWFtIGNvbmUnKTsKICogICAgfSk7CiAqICB9OwogKn0pOwogICAqYGBgCiAgICovCgogIElvbmljTW9kdWxlCiAgICAuZmFjdG9yeSgnJGlvbmljUG9wdXAnLCBbCiAgICAgICckaW9uaWNUZW1wbGF0ZUxvYWRlcicsCiAgICAgICckaW9uaWNCYWNrZHJvcCcsCiAgICAgICckcScsCiAgICAgICckdGltZW91dCcsCiAgICAgICckcm9vdFNjb3BlJywKICAgICAgJyRkb2N1bWVudCcsCiAgICAgICckY29tcGlsZScsCiAgICAgICckaW9uaWNQbGF0Zm9ybScsCiAgICAgIGZ1bmN0aW9uKCRpb25pY1RlbXBsYXRlTG9hZGVyLCAkaW9uaWNCYWNrZHJvcCwgJHEsICR0aW1lb3V0LCAkcm9vdFNjb3BlLCAkZG9jdW1lbnQsICRjb21waWxlLCAkaW9uaWNQbGF0Zm9ybSkgewogICAgICAgIC8vVE9ETyBhbGxvdyB0aGlzIHRvIGJlIGNvbmZpZ3VyZWQKICAgICAgICB2YXIgY29uZmlnID0gewogICAgICAgICAgc3RhY2tQdXNoRGVsYXk6IDUwCiAgICAgICAgfTsKICAgICAgICB2YXIgcG9wdXBTdGFjayA9IFtdOwogICAgICAgIHZhciAkaW9uaWNQb3B1cCA9IHsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBTaG93IGEgY29tcGxleCBwb3B1cC4gVGhpcyBpcyB0aGUgbWFzdGVyIHNob3cgZnVuY3Rpb24gZm9yIGFsbCBwb3B1cHMuCiAgICAgICAgICAgKgogICAgICAgICAgICogQSBjb21wbGV4IHBvcHVwIGhhcyBhIGBidXR0b25zYCBhcnJheSwgd2l0aCBlYWNoIGJ1dHRvbiBoYXZpbmcgYSBgdGV4dGAgYW5kIGB0eXBlYAogICAgICAgICAgICogZmllbGQsIGluIGFkZGl0aW9uIHRvIGFuIGBvblRhcGAgZnVuY3Rpb24uICBUaGUgYG9uVGFwYCBmdW5jdGlvbiwgY2FsbGVkIHdoZW4KICAgICAgICAgICAqIHRoZSBjb3JyZXNwb25kaW5nYnV0dG9uIG9uIHRoZSBwb3B1cCBpcyB0YXBwZWQsIHdpbGwgYnkgZGVmYXVsdCBjbG9zZSB0aGUgcG9wdXAKICAgICAgICAgICAqIGFuZCByZXNvbHZlIHRoZSBwb3B1cCBwcm9taXNlIHdpdGggaXRzIHJldHVybiB2YWx1ZS4gIElmIHlvdSB3aXNoIHRvIHByZXZlbnQgdGhlCiAgICAgICAgICAgKiBkZWZhdWx0IGFuZCBrZWVwIHRoZSBwb3B1cCBvcGVuIG9uIGJ1dHRvbiB0YXAsIGNhbGwgYGV2ZW50LnByZXZlbnREZWZhdWx0KClgIG9uIHRoZQogICAgICAgICAgICogcGFzc2VkIGluIHRhcCBldmVudC4gIERldGFpbHMgYmVsb3cuCiAgICAgICAgICAgKgogICAgICAgICAgICogQG5hbWUgJGlvbmljUG9wdXAjc2hvdwogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgZm9yIHRoZSBuZXcgcG9wdXAsIG9mIHRoZSBmb3JtOgogICAgICAgICAgICoKICAgICAgICAgICAqIGBgYAogICAgICAgICAgICogewogICAgICogICB0aXRsZTogJycsIC8vIFN0cmluZy4gVGhlIHRpdGxlIG9mIHRoZSBwb3B1cC4KICAgICAqICAgc3ViVGl0bGU6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIHN1Yi10aXRsZSBvZiB0aGUgcG9wdXAuCiAgICAgKiAgIHRlbXBsYXRlOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBodG1sIHRlbXBsYXRlIHRvIHBsYWNlIGluIHRoZSBwb3B1cCBib2R5LgogICAgICogICB0ZW1wbGF0ZVVybDogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgVVJMIG9mIGFuIGh0bWwgdGVtcGxhdGUgdG8gcGxhY2UgaW4gdGhlIHBvcHVwICAgYm9keS4KICAgICAqICAgc2NvcGU6IG51bGwsIC8vIFNjb3BlIChvcHRpb25hbCkuIEEgc2NvcGUgdG8gbGluayB0byB0aGUgcG9wdXAgY29udGVudC4KICAgICAqICAgYnV0dG9uczogW3sgLy9BcnJheVtPYmplY3RdIChvcHRpb25hbCkuIEJ1dHRvbnMgdG8gcGxhY2UgaW4gdGhlIHBvcHVwIGZvb3Rlci4KICAgICAqICAgICB0ZXh0OiAnQ2FuY2VsJywKICAgICAqICAgICB0eXBlOiAnYnV0dG9uLWRlZmF1bHQnLAogICAgICogICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7CiAgICAgKiAgICAgICAvLyBlLnByZXZlbnREZWZhdWx0KCkgd2lsbCBzdG9wIHRoZSBwb3B1cCBmcm9tIGNsb3Npbmcgd2hlbiB0YXBwZWQuCiAgICAgKiAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgKiAgICAgfQogICAgICogICB9LCB7CiAgICAgKiAgICAgdGV4dDogJ09LJywKICAgICAqICAgICB0eXBlOiAnYnV0dG9uLXBvc2l0aXZlJywKICAgICAqICAgICBvblRhcDogZnVuY3Rpb24oZSkgewogICAgICogICAgICAgLy8gUmV0dXJuaW5nIGEgdmFsdWUgd2lsbCBjYXVzZSB0aGUgcHJvbWlzZSB0byByZXNvbHZlIHdpdGggdGhlIGdpdmVuIHZhbHVlLgogICAgICogICAgICAgcmV0dXJuIHNjb3BlLmRhdGEucmVzcG9uc2U7CiAgICAgKiAgICAgfQogICAgICogICB9XQogICAgICogfQogICAgICAgICAgICogYGBgCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybnMge29iamVjdH0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIHBvcHVwIGlzIGNsb3NlZC4gSGFzIGFuIGFkZGl0aW9uYWwKICAgICAgICAgICAqIGBjbG9zZWAgZnVuY3Rpb24sIHdoaWNoIGNhbiBiZSB1c2VkIHRvIHByb2dyYW1tYXRpY2FsbHkgY2xvc2UgdGhlIHBvcHVwLgogICAgICAgICAgICovCiAgICAgICAgICBzaG93OiBzaG93UG9wdXAsCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNQb3B1cCNhbGVydAogICAgICAgICAgICogQGRlc2NyaXB0aW9uIFNob3cgYSBzaW1wbGUgYWxlcnQgcG9wdXAgd2l0aCBhIG1lc3NhZ2UgYW5kIG9uZSBidXR0b24gdGhhdCB0aGUgdXNlciBjYW4KICAgICAgICAgICAqIHRhcCB0byBjbG9zZSB0aGUgcG9wdXAuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgZm9yIHNob3dpbmcgdGhlIGFsZXJ0LCBvZiB0aGUgZm9ybToKICAgICAgICAgICAqCiAgICAgICAgICAgKiBgYGAKICAgICAgICAgICAqIHsKICAgICAqICAgdGl0bGU6ICcnLCAvLyBTdHJpbmcuIFRoZSB0aXRsZSBvZiB0aGUgcG9wdXAuCiAgICAgKiAgIHN1YlRpdGxlOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBzdWItdGl0bGUgb2YgdGhlIHBvcHVwLgogICAgICogICB0ZW1wbGF0ZTogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgaHRtbCB0ZW1wbGF0ZSB0byBwbGFjZSBpbiB0aGUgcG9wdXAgYm9keS4KICAgICAqICAgdGVtcGxhdGVVcmw6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIFVSTCBvZiBhbiBodG1sIHRlbXBsYXRlIHRvIHBsYWNlIGluIHRoZSBwb3B1cCAgIGJvZHkuCiAgICAgKiAgIG9rVGV4dDogJycsIC8vIFN0cmluZyAoZGVmYXVsdDogJ09LJykuIFRoZSB0ZXh0IG9mIHRoZSBPSyBidXR0b24uCiAgICAgKiAgIG9rVHlwZTogJycsIC8vIFN0cmluZyAoZGVmYXVsdDogJ2J1dHRvbi1wb3NpdGl2ZScpLiBUaGUgdHlwZSBvZiB0aGUgT0sgYnV0dG9uLgogICAgICogfQogICAgICAgICAgICogYGBgCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybnMge29iamVjdH0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIHBvcHVwIGlzIGNsb3NlZC4gSGFzIG9uZSBhZGRpdGlvbmFsCiAgICAgICAgICAgKiBmdW5jdGlvbiBgY2xvc2VgLCB3aGljaCBjYW4gYmUgY2FsbGVkIHdpdGggYW55IHZhbHVlIHRvIHByb2dyYW1tYXRpY2FsbHkgY2xvc2UgdGhlIHBvcHVwCiAgICAgICAgICAgKiB3aXRoIHRoZSBnaXZlbiB2YWx1ZS4KICAgICAgICAgICAqLwogICAgICAgICAgYWxlcnQ6IHNob3dBbGVydCwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRpb25pY1BvcHVwI2NvbmZpcm0KICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2hvdyBhIHNpbXBsZSBjb25maXJtIHBvcHVwIHdpdGggYSBDYW5jZWwgYW5kIE9LIGJ1dHRvbi4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBSZXNvbHZlcyB0aGUgcHJvbWlzZSB3aXRoIHRydWUgaWYgdGhlIHVzZXIgcHJlc3NlcyB0aGUgT0sgYnV0dG9uLCBhbmQgZmFsc2UgaWYgdGhlCiAgICAgICAgICAgKiB1c2VyIHByZXNzZXMgdGhlIENhbmNlbCBidXR0b24uCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgZm9yIHNob3dpbmcgdGhlIGNvbmZpcm0gcG9wdXAsIG9mIHRoZSBmb3JtOgogICAgICAgICAgICoKICAgICAgICAgICAqIGBgYAogICAgICAgICAgICogewogICAgICogICB0aXRsZTogJycsIC8vIFN0cmluZy4gVGhlIHRpdGxlIG9mIHRoZSBwb3B1cC4KICAgICAqICAgc3ViVGl0bGU6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIHN1Yi10aXRsZSBvZiB0aGUgcG9wdXAuCiAgICAgKiAgIHRlbXBsYXRlOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBodG1sIHRlbXBsYXRlIHRvIHBsYWNlIGluIHRoZSBwb3B1cCBib2R5LgogICAgICogICB0ZW1wbGF0ZVVybDogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgVVJMIG9mIGFuIGh0bWwgdGVtcGxhdGUgdG8gcGxhY2UgaW4gdGhlIHBvcHVwICAgYm9keS4KICAgICAqICAgY2FuY2VsVGV4dDogJycsIC8vIFN0cmluZyAoZGVmYXVsdDogJ0NhbmNlbCcpLiBUaGUgdGV4dCBvZiB0aGUgQ2FuY2VsIGJ1dHRvbi4KICAgICAqICAgY2FuY2VsVHlwZTogJycsIC8vIFN0cmluZyAoZGVmYXVsdDogJ2J1dHRvbi1kZWZhdWx0JykuIFRoZSB0eXBlIG9mIHRoZSBDYW5jZWwgYnV0dG9uLgogICAgICogICBva1RleHQ6ICcnLCAvLyBTdHJpbmcgKGRlZmF1bHQ6ICdPSycpLiBUaGUgdGV4dCBvZiB0aGUgT0sgYnV0dG9uLgogICAgICogICBva1R5cGU6ICcnLCAvLyBTdHJpbmcgKGRlZmF1bHQ6ICdidXR0b24tcG9zaXRpdmUnKS4gVGhlIHR5cGUgb2YgdGhlIE9LIGJ1dHRvbi4KICAgICAqIH0KICAgICAgICAgICAqIGBgYAogICAgICAgICAgICoKICAgICAgICAgICAqIEByZXR1cm5zIHtvYmplY3R9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBwb3B1cCBpcyBjbG9zZWQuIEhhcyBvbmUgYWRkaXRpb25hbAogICAgICAgICAgICogZnVuY3Rpb24gYGNsb3NlYCwgd2hpY2ggY2FuIGJlIGNhbGxlZCB3aXRoIGFueSB2YWx1ZSB0byBwcm9ncmFtbWF0aWNhbGx5IGNsb3NlIHRoZSBwb3B1cAogICAgICAgICAgICogd2l0aCB0aGUgZ2l2ZW4gdmFsdWUuCiAgICAgICAgICAgKi8KICAgICAgICAgIGNvbmZpcm06IHNob3dDb25maXJtLAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGlvbmljUG9wdXAjcHJvbXB0CiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24gU2hvdyBhIHNpbXBsZSBwcm9tcHQgcG9wdXAsIHdoaWNoIGhhcyBhbiBpbnB1dCwgT0sgYnV0dG9uLCBhbmQgQ2FuY2VsIGJ1dHRvbi4KICAgICAgICAgICAqIFJlc29sdmVzIHRoZSBwcm9taXNlIHdpdGggdGhlIHZhbHVlIG9mIHRoZSBpbnB1dCBpZiB0aGUgdXNlciBwcmVzc2VzIE9LLCBhbmQgd2l0aCB1bmRlZmluZWQKICAgICAgICAgICAqIGlmIHRoZSB1c2VyIHByZXNzZXMgQ2FuY2VsLgogICAgICAgICAgICoKICAgICAgICAgICAqIGBgYGphdmFzY3JpcHQKICAgICAgICAgICAqICAkaW9uaWNQb3B1cC5wcm9tcHQoewogICAgICogICAgdGl0bGU6ICdQYXNzd29yZCBDaGVjaycsCiAgICAgKiAgICB0ZW1wbGF0ZTogJ0VudGVyIHlvdXIgc2VjcmV0IHBhc3N3b3JkJywKICAgICAqICAgIGlucHV0VHlwZTogJ3Bhc3N3b3JkJywKICAgICAqICAgIGlucHV0UGxhY2Vob2xkZXI6ICdZb3VyIHBhc3N3b3JkJwogICAgICogIH0pLnRoZW4oZnVuY3Rpb24ocmVzKSB7CiAgICAgKiAgICBjb25zb2xlLmxvZygnWW91ciBwYXNzd29yZCBpcycsIHJlcyk7CiAgICAgKiAgfSk7CiAgICAgICAgICAgKiBgYGAKICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFRoZSBvcHRpb25zIGZvciBzaG93aW5nIHRoZSBwcm9tcHQgcG9wdXAsIG9mIHRoZSBmb3JtOgogICAgICAgICAgICoKICAgICAgICAgICAqIGBgYAogICAgICAgICAgICogewogICAgICogICB0aXRsZTogJycsIC8vIFN0cmluZy4gVGhlIHRpdGxlIG9mIHRoZSBwb3B1cC4KICAgICAqICAgc3ViVGl0bGU6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIHN1Yi10aXRsZSBvZiB0aGUgcG9wdXAuCiAgICAgKiAgIHRlbXBsYXRlOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBodG1sIHRlbXBsYXRlIHRvIHBsYWNlIGluIHRoZSBwb3B1cCBib2R5LgogICAgICogICB0ZW1wbGF0ZVVybDogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgVVJMIG9mIGFuIGh0bWwgdGVtcGxhdGUgdG8gcGxhY2UgaW4gdGhlIHBvcHVwICAgYm9keS4KICAgICAqICAgaW5wdXRUeXBlOiAvLyBTdHJpbmcgKGRlZmF1bHQ6ICd0ZXh0JykuIFRoZSB0eXBlIG9mIGlucHV0IHRvIHVzZQogICAgICogICBpbnB1dFBsYWNlaG9sZGVyOiAvLyBTdHJpbmcgKGRlZmF1bHQ6ICcnKS4gQSBwbGFjZWhvbGRlciB0byB1c2UgZm9yIHRoZSBpbnB1dC4KICAgICAqICAgY2FuY2VsVGV4dDogLy8gU3RyaW5nIChkZWZhdWx0OiAnQ2FuY2VsJy4gVGhlIHRleHQgb2YgdGhlIENhbmNlbCBidXR0b24uCiAgICAgKiAgIGNhbmNlbFR5cGU6IC8vIFN0cmluZyAoZGVmYXVsdDogJ2J1dHRvbi1kZWZhdWx0JykuIFRoZSB0eXBlIG9mIHRoZSBDYW5jZWwgYnV0dG9uLgogICAgICogICBva1RleHQ6IC8vIFN0cmluZyAoZGVmYXVsdDogJ09LJykuIFRoZSB0ZXh0IG9mIHRoZSBPSyBidXR0b24uCiAgICAgKiAgIG9rVHlwZTogLy8gU3RyaW5nIChkZWZhdWx0OiAnYnV0dG9uLXBvc2l0aXZlJykuIFRoZSB0eXBlIG9mIHRoZSBPSyBidXR0b24uCiAgICAgKiB9CiAgICAgICAgICAgKiBgYGAKICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgcG9wdXAgaXMgY2xvc2VkLiBIYXMgb25lIGFkZGl0aW9uYWwKICAgICAgICAgICAqIGZ1bmN0aW9uIGBjbG9zZWAsIHdoaWNoIGNhbiBiZSBjYWxsZWQgd2l0aCBhbnkgdmFsdWUgdG8gcHJvZ3JhbW1hdGljYWxseSBjbG9zZSB0aGUgcG9wdXAKICAgICAgICAgICAqIHdpdGggdGhlIGdpdmVuIHZhbHVlLgogICAgICAgICAgICovCiAgICAgICAgICBwcm9tcHQ6IHNob3dQcm9tcHQsCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBwcml2YXRlIGZvciB0ZXN0aW5nCiAgICAgICAgICAgKi8KICAgICAgICAgIF9jcmVhdGVQb3B1cDogY3JlYXRlUG9wdXAsCiAgICAgICAgICBfcG9wdXBTdGFjazogcG9wdXBTdGFjawogICAgICAgIH07CgogICAgICAgIHJldHVybiAkaW9uaWNQb3B1cDsKCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUG9wdXAob3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IGV4dGVuZCh7CiAgICAgICAgICAgIHNjb3BlOiBudWxsLAogICAgICAgICAgICB0aXRsZTogJycsCiAgICAgICAgICAgIGJ1dHRvbnM6IFtdLAogICAgICAgICAgfSwgb3B0aW9ucyB8fCB7fSk7CgogICAgICAgICAgdmFyIHBvcHVwUHJvbWlzZSA9ICRpb25pY1RlbXBsYXRlTG9hZGVyLmNvbXBpbGUoewogICAgICAgICAgICB0ZW1wbGF0ZTogUE9QVVBfVFBMLAogICAgICAgICAgICBzY29wZTogb3B0aW9ucy5zY29wZSAmJiBvcHRpb25zLnNjb3BlLiRuZXcoKSwKICAgICAgICAgICAgYXBwZW5kVG86ICRkb2N1bWVudFswXS5ib2R5CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBjb250ZW50UHJvbWlzZSA9IG9wdGlvbnMudGVtcGxhdGVVcmwgPwogICAgICAgICAgICAkaW9uaWNUZW1wbGF0ZUxvYWRlci5sb2FkKG9wdGlvbnMudGVtcGxhdGVVcmwpIDoKICAgICAgICAgICAgJHEud2hlbihvcHRpb25zLnRlbXBsYXRlIHx8IG9wdGlvbnMuY29udGVudCB8fCAnJyk7CgogICAgICAgICAgcmV0dXJuICRxLmFsbChbcG9wdXBQcm9taXNlLCBjb250ZW50UHJvbWlzZV0pCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdHMpIHsKICAgICAgICAgICAgICB2YXIgc2VsZiA9IHJlc3VsdHNbMF07CiAgICAgICAgICAgICAgdmFyIGNvbnRlbnQgPSByZXN1bHRzWzFdOwogICAgICAgICAgICAgIHZhciByZXNwb25zZURlZmVycmVkID0gJHEuZGVmZXIoKTsKCiAgICAgICAgICAgICAgc2VsZi5yZXNwb25zZURlZmVycmVkID0gcmVzcG9uc2VEZWZlcnJlZDsKCiAgICAgICAgICAgICAgLy9DYW4ndCBuZy1iaW5kLWh0bWwgZm9yIHBvcHVwLWJvZHkgYmVjYXVzZSBpdCBjYW4gYmUgaW5zZWN1cmUgaHRtbAogICAgICAgICAgICAgIC8vKGVnIGFuIGlucHV0IGluIGNhc2Ugb2YgcHJvbXB0KQogICAgICAgICAgICAgIHZhciBib2R5ID0ganFMaXRlKHNlbGYuZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yKCcucG9wdXAtYm9keScpKTsKICAgICAgICAgICAgICBpZiAoY29udGVudCkgewogICAgICAgICAgICAgICAgYm9keS5odG1sKGNvbnRlbnQpOwogICAgICAgICAgICAgICAgJGNvbXBpbGUoYm9keS5jb250ZW50cygpKShzZWxmLnNjb3BlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYm9keS5yZW1vdmUoKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGV4dGVuZChzZWxmLnNjb3BlLCB7CiAgICAgICAgICAgICAgICB0aXRsZTogb3B0aW9ucy50aXRsZSwKICAgICAgICAgICAgICAgIGJ1dHRvbnM6IG9wdGlvbnMuYnV0dG9ucywKICAgICAgICAgICAgICAgIHN1YlRpdGxlOiBvcHRpb25zLnN1YlRpdGxlLAogICAgICAgICAgICAgICAgJGJ1dHRvblRhcHBlZDogZnVuY3Rpb24oYnV0dG9uLCBldmVudCkgewogICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gKGJ1dHRvbi5vblRhcCB8fCBhbmd1bGFyLm5vb3ApKGV2ZW50KTsKICAgICAgICAgICAgICAgICAgZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50IHx8IGV2ZW50OyAvL2pxdWVyeSBldmVudHMKCiAgICAgICAgICAgICAgICAgIGlmICghZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlRGVmZXJyZWQucmVzb2x2ZShyZXN1bHQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIHNlbGYuc2hvdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKHNlbGYuaXNTaG93bikgcmV0dXJuOwoKICAgICAgICAgICAgICAgIHNlbGYuaXNTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIC8vaWYgaGlkZGVuIHdoaWxlIHdhaXRpbmcgZm9yIHJhZiwgZG9uJ3Qgc2hvdwogICAgICAgICAgICAgICAgICBpZiAoIXNlbGYuaXNTaG93bikgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgLy9pZiB0aGUgcG9wdXAgaXMgdGFsbGVyIHRoYW4gdGhlIHdpbmRvdywgbWFrZSB0aGUgcG9wdXAgYm9keSBzY3JvbGxhYmxlCiAgICAgICAgICAgICAgICAgIGlmKHNlbGYuZWxlbWVudFswXS5vZmZzZXRIZWlnaHQgPiB3aW5kb3cuaW5uZXJIZWlnaHQgLSAyMCl7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5lbGVtZW50WzBdLnN0eWxlLmhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCAtIDIwKydweCc7CiAgICAgICAgICAgICAgICAgICAgcG9wdXBCb2R5ID0gc2VsZi5lbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3JBbGwoJy5wb3B1cC1ib2R5Jyk7CiAgICAgICAgICAgICAgICAgICAgcG9wdXBIZWFkID0gc2VsZi5lbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3JBbGwoJy5wb3B1cC1oZWFkJyk7CiAgICAgICAgICAgICAgICAgICAgcG9wdXBCdXR0b25zID0gc2VsZi5lbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3JBbGwoJy5wb3B1cC1idXR0b25zJyk7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5lbGVtZW50LmFkZENsYXNzKCdwb3B1cC10YWxsJyk7CiAgICAgICAgICAgICAgICAgICAgbmV3SGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0IC0gcG9wdXBIZWFkWzBdLm9mZnNldEhlaWdodCAtIHBvcHVwQnV0dG9uc1swXS5vZmZzZXRIZWlnaHQgLTIwOwogICAgICAgICAgICAgICAgICAgIHBvcHVwQm9keVswXS5zdHlsZS5oZWlnaHQgPSAgbmV3SGVpZ2h0ICsgJ3B4JzsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgc2VsZi5lbGVtZW50LnJlbW92ZUNsYXNzKCdwb3B1cC1oaWRkZW4nKTsKICAgICAgICAgICAgICAgICAgc2VsZi5lbGVtZW50LmFkZENsYXNzKCdwb3B1cC1zaG93aW5nIGFjdGl2ZScpOwogICAgICAgICAgICAgICAgICBpb25pYy5Eb21VdGlsLmNlbnRlckVsZW1lbnRCeU1hcmdpblR3aWNlKHNlbGYuZWxlbWVudFswXSk7CiAgICAgICAgICAgICAgICAgIGZvY3VzSW5wdXQoc2VsZi5lbGVtZW50KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgc2VsZi5oaWRlID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgfHwgYW5ndWxhci5ub29wOwogICAgICAgICAgICAgICAgaWYgKCFzZWxmLmlzU2hvd24pIHJldHVybiBjYWxsYmFjaygpOwoKICAgICAgICAgICAgICAgIHNlbGYuaXNTaG93biA9IGZhbHNlOwogICAgICAgICAgICAgICAgc2VsZi5lbGVtZW50LnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHNlbGYuZWxlbWVudC5hZGRDbGFzcygncG9wdXAtaGlkZGVuJyk7CiAgICAgICAgICAgICAgICAkdGltZW91dChjYWxsYmFjaywgMjUwKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHNlbGYucmVtb3ZlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoc2VsZi5yZW1vdmVkKSByZXR1cm47CgogICAgICAgICAgICAgICAgc2VsZi5oaWRlKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBzZWxmLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgIHNlbGYuc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHNlbGYucmVtb3ZlZCA9IHRydWU7CiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb25IYXJkd2FyZUJhY2tCdXR0b24oZSkgewogICAgICAgICAgcG9wdXBTdGFja1swXSAmJiBwb3B1cFN0YWNrWzBdLnJlc3BvbnNlRGVmZXJyZWQucmVzb2x2ZSgpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2hvd1BvcHVwKG9wdGlvbnMpIHsKICAgICAgICAgIHZhciBwb3B1cFByb21pc2UgPSAkaW9uaWNQb3B1cC5fY3JlYXRlUG9wdXAob3B0aW9ucyk7CiAgICAgICAgICB2YXIgcHJldmlvdXNQb3B1cCA9IHBvcHVwU3RhY2tbMF07CgogICAgICAgICAgaWYgKHByZXZpb3VzUG9wdXApIHsKICAgICAgICAgICAgcHJldmlvdXNQb3B1cC5oaWRlKCk7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIHJlc3VsdFByb21pc2UgPSAkdGltZW91dChhbmd1bGFyLm5vb3AsIHByZXZpb3VzUG9wdXAgPyBjb25maWcuc3RhY2tQdXNoRGVsYXkgOiAwKQogICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHsgcmV0dXJuIHBvcHVwUHJvbWlzZTsgfSkKICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocG9wdXApIHsKICAgICAgICAgICAgICBpZiAoIXByZXZpb3VzUG9wdXApIHsKICAgICAgICAgICAgICAgIC8vQWRkIHBvcHVwLW9wZW4gJiBiYWNrZHJvcCBpZiB0aGlzIGlzIGZpcnN0IHBvcHVwCiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ3BvcHVwLW9wZW4nKTsKICAgICAgICAgICAgICAgICRpb25pY0JhY2tkcm9wLnJldGFpbigpOwogICAgICAgICAgICAgICAgJGlvbmljUG9wdXAuX2JhY2tCdXR0b25BY3Rpb25Eb25lID0gJGlvbmljUGxhdGZvcm0ucmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uKAogICAgICAgICAgICAgICAgICBvbkhhcmR3YXJlQmFja0J1dHRvbiwKICAgICAgICAgICAgICAgICAgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfUE9QVVAKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBvcHVwU3RhY2sudW5zaGlmdChwb3B1cCk7CiAgICAgICAgICAgICAgcG9wdXAuc2hvdygpOwoKICAgICAgICAgICAgICAvL0RFUFJFQ0FURUQ6IG5vdGlmeSB0aGUgcHJvbWlzZSB3aXRoIGFuIG9iamVjdCB3aXRoIGEgY2xvc2UgbWV0aG9kCiAgICAgICAgICAgICAgcG9wdXAucmVzcG9uc2VEZWZlcnJlZC5ub3RpZnkoewogICAgICAgICAgICAgICAgY2xvc2U6IHJlc3VsdFByb21pc2UuY2xvc2UKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgcmV0dXJuIHBvcHVwLnJlc3BvbnNlRGVmZXJyZWQucHJvbWlzZS50aGVuKGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gcG9wdXBTdGFjay5pbmRleE9mKHBvcHVwKTsKICAgICAgICAgICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgcG9wdXBTdGFjay5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcG9wdXAucmVtb3ZlKCk7CgogICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzUG9wdXAgPSBwb3B1cFN0YWNrWzBdOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzUG9wdXApIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNQb3B1cC5zaG93KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAvL1JlbW92ZSBwb3B1cC1vcGVuICYgYmFja2Ryb3AgaWYgdGhpcyBpcyBsYXN0IHBvcHVwCiAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgncG9wdXAtb3BlbicpOwogICAgICAgICAgICAgICAgICAoJGlvbmljUG9wdXAuX2JhY2tCdXR0b25BY3Rpb25Eb25lIHx8IGFuZ3VsYXIubm9vcCkoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGFsd2F5cyByZWxlYXNlIHRoZSBiYWNrZHJvcCBzaW5jZSBpdCBoYXMgYW4gaW50ZXJuYWwgYmFja2Ryb3AgY291bnRlcgogICAgICAgICAgICAgICAgJGlvbmljQmFja2Ryb3AucmVsZWFzZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgZnVuY3Rpb24gY2xvc2UocmVzdWx0KSB7CiAgICAgICAgICAgIHBvcHVwUHJvbWlzZS50aGVuKGZ1bmN0aW9uKHBvcHVwKSB7CiAgICAgICAgICAgICAgaWYgKCFwb3B1cC5yZW1vdmVkKSB7CiAgICAgICAgICAgICAgICBwb3B1cC5yZXNwb25zZURlZmVycmVkLnJlc29sdmUocmVzdWx0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0UHJvbWlzZS5jbG9zZSA9IGNsb3NlOwoKICAgICAgICAgIHJldHVybiByZXN1bHRQcm9taXNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZm9jdXNJbnB1dChlbGVtZW50KSB7CiAgICAgICAgICB2YXIgZm9jdXNPbiA9IGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignW2F1dG9mb2N1c10nKTsKICAgICAgICAgIGlmIChmb2N1c09uKSB7CiAgICAgICAgICAgIGZvY3VzT24uZm9jdXMoKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNob3dBbGVydChvcHRzKSB7CiAgICAgICAgICByZXR1cm4gc2hvd1BvcHVwKCBleHRlbmQoewogICAgICAgICAgICBidXR0b25zOiBbewogICAgICAgICAgICAgIHRleHQ6IG9wdHMub2tUZXh0IHx8ICdPSycsCiAgICAgICAgICAgICAgdHlwZTogb3B0cy5va1R5cGUgfHwgJ2J1dHRvbi1wb3NpdGl2ZScsCiAgICAgICAgICAgICAgb25UYXA6IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV0KICAgICAgICAgIH0sIG9wdHMgfHwge30pICk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzaG93Q29uZmlybShvcHRzKSB7CiAgICAgICAgICByZXR1cm4gc2hvd1BvcHVwKCBleHRlbmQoewogICAgICAgICAgICBidXR0b25zOiBbewogICAgICAgICAgICAgIHRleHQ6IG9wdHMuY2FuY2VsVGV4dCB8fCAnQ2FuY2VsJyAsCiAgICAgICAgICAgICAgdHlwZTogb3B0cy5jYW5jZWxUeXBlIHx8ICdidXR0b24tZGVmYXVsdCcsCiAgICAgICAgICAgICAgb25UYXA6IGZ1bmN0aW9uKGUpIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICB0ZXh0OiBvcHRzLm9rVGV4dCB8fCAnT0snLAogICAgICAgICAgICAgIHR5cGU6IG9wdHMub2tUeXBlIHx8ICdidXR0b24tcG9zaXRpdmUnLAogICAgICAgICAgICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7IHJldHVybiB0cnVlOyB9CiAgICAgICAgICAgIH1dCiAgICAgICAgICB9LCBvcHRzIHx8IHt9KSApOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2hvd1Byb21wdChvcHRzKSB7CiAgICAgICAgICB2YXIgc2NvcGUgPSAkcm9vdFNjb3BlLiRuZXcodHJ1ZSk7CiAgICAgICAgICBzY29wZS5kYXRhID0ge307CiAgICAgICAgICByZXR1cm4gc2hvd1BvcHVwKCBleHRlbmQoewogICAgICAgICAgICB0ZW1wbGF0ZTogJzxpbnB1dCBuZy1tb2RlbD0iZGF0YS5yZXNwb25zZSIgdHlwZT0iJyArIChvcHRzLmlucHV0VHlwZSB8fCAndGV4dCcpICsKICAgICAgICAgICAgICAnIiBwbGFjZWhvbGRlcj0iJyArIChvcHRzLmlucHV0UGxhY2Vob2xkZXIgfHwgJycpICsgJyI+JywKICAgICAgICAgICAgc2NvcGU6IHNjb3BlLAogICAgICAgICAgICBidXR0b25zOiBbewogICAgICAgICAgICAgIHRleHQ6IG9wdHMuY2FuY2VsVGV4dCB8fCAnQ2FuY2VsJywKICAgICAgICAgICAgICB0eXBlOiBvcHRzLmNhbmNlbFR5cGV8fCAnYnV0dG9uLWRlZmF1bHQnLAogICAgICAgICAgICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7fQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgdGV4dDogb3B0cy5va1RleHQgfHwgJ09LJywKICAgICAgICAgICAgICB0eXBlOiBvcHRzLm9rVHlwZSB8fCAnYnV0dG9uLXBvc2l0aXZlJywKICAgICAgICAgICAgICBvblRhcDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLmRhdGEucmVzcG9uc2UgfHwgJyc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9XQogICAgICAgICAgfSwgb3B0cyB8fCB7fSkgKTsKICAgICAgICB9CiAgICAgIH1dKTsKCgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljUG9zaXRpb24KICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICogQSBzZXQgb2YgdXRpbGl0eSBtZXRob2RzIHRoYXQgY2FuIGJlIHVzZSB0byByZXRyaWV2ZSBwb3NpdGlvbiBvZiBET00gZWxlbWVudHMuCiAgICogSXQgaXMgbWVhbnQgdG8gYmUgdXNlZCB3aGVyZSB3ZSBuZWVkIHRvIGFic29sdXRlLXBvc2l0aW9uIERPTSBlbGVtZW50cyBpbgogICAqIHJlbGF0aW9uIHRvIG90aGVyLCBleGlzdGluZyBlbGVtZW50cyAodGhpcyBpcyB0aGUgY2FzZSBmb3IgdG9vbHRpcHMsIHBvcG92ZXJzLCBldGMuKS4KICAgKgogICAqIEFkYXB0ZWQgZnJvbSBbQW5ndWxhclVJIEJvb3RzdHJhcF0oaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXItdWkvYm9vdHN0cmFwL2Jsb2IvbWFzdGVyL3NyYy9wb3NpdGlvbi9wb3NpdGlvbi5qcyksCiAgICogKFtsaWNlbnNlXShodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci11aS9ib290c3RyYXAvYmxvYi9tYXN0ZXIvTElDRU5TRSkpCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5mYWN0b3J5KCckaW9uaWNQb3NpdGlvbicsIFsnJGRvY3VtZW50JywgJyR3aW5kb3cnLCBmdW5jdGlvbiAoJGRvY3VtZW50LCAkd2luZG93KSB7CgogICAgICBmdW5jdGlvbiBnZXRTdHlsZShlbCwgY3NzcHJvcCkgewogICAgICAgIGlmIChlbC5jdXJyZW50U3R5bGUpIHsgLy9JRQogICAgICAgICAgcmV0dXJuIGVsLmN1cnJlbnRTdHlsZVtjc3Nwcm9wXTsKICAgICAgICB9IGVsc2UgaWYgKCR3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSkgewogICAgICAgICAgcmV0dXJuICR3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbClbY3NzcHJvcF07CiAgICAgICAgfQogICAgICAgIC8vIGZpbmFsbHkgdHJ5IGFuZCBnZXQgaW5saW5lIHN0eWxlCiAgICAgICAgcmV0dXJuIGVsLnN0eWxlW2Nzc3Byb3BdOwogICAgICB9CgogICAgICAvKioKICAgICAgICogQ2hlY2tzIGlmIGEgZ2l2ZW4gZWxlbWVudCBpcyBzdGF0aWNhbGx5IHBvc2l0aW9uZWQKICAgICAgICogQHBhcmFtIGVsZW1lbnQgLSByYXcgRE9NIGVsZW1lbnQKICAgICAgICovCiAgICAgIGZ1bmN0aW9uIGlzU3RhdGljUG9zaXRpb25lZChlbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIChnZXRTdHlsZShlbGVtZW50LCAncG9zaXRpb24nKSB8fCAnc3RhdGljJyApID09PSAnc3RhdGljJzsKICAgICAgfQoKICAgICAgLyoqCiAgICAgICAqIHJldHVybnMgdGhlIGNsb3Nlc3QsIG5vbi1zdGF0aWNhbGx5IHBvc2l0aW9uZWQgcGFyZW50T2Zmc2V0IG9mIGEgZ2l2ZW4gZWxlbWVudAogICAgICAgKiBAcGFyYW0gZWxlbWVudAogICAgICAgKi8KICAgICAgdmFyIHBhcmVudE9mZnNldEVsID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICB2YXIgZG9jRG9tRWwgPSAkZG9jdW1lbnRbMF07CiAgICAgICAgdmFyIG9mZnNldFBhcmVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50IHx8IGRvY0RvbUVsOwogICAgICAgIHdoaWxlIChvZmZzZXRQYXJlbnQgJiYgb2Zmc2V0UGFyZW50ICE9PSBkb2NEb21FbCAmJiBpc1N0YXRpY1Bvc2l0aW9uZWQob2Zmc2V0UGFyZW50KSApIHsKICAgICAgICAgIG9mZnNldFBhcmVudCA9IG9mZnNldFBhcmVudC5vZmZzZXRQYXJlbnQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiBvZmZzZXRQYXJlbnQgfHwgZG9jRG9tRWw7CiAgICAgIH07CgogICAgICByZXR1cm4gewogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkaW9uaWNQb3NpdGlvbiNwb3NpdGlvbgogICAgICAgICAqIEBkZXNjcmlwdGlvbiBHZXQgdGhlIGN1cnJlbnQgY29vcmRpbmF0ZXMgb2YgdGhlIGVsZW1lbnQsIHJlbGF0aXZlIHRvIHRoZSBvZmZzZXQgcGFyZW50LgogICAgICAgICAqIFJlYWQtb25seSBlcXVpdmFsZW50IG9mIFtqUXVlcnkncyBwb3NpdGlvbiBmdW5jdGlvbl0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3Bvc2l0aW9uLykuCiAgICAgICAgICogQHBhcmFtIHtlbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIGdldCB0aGUgcG9zaXRpb24gb2YuCiAgICAgICAgICogQHJldHVybnMge29iamVjdH0gUmV0dXJucyBhbiBvYmplY3QgY29udGFpbmluZyB0aGUgcHJvcGVydGllcyB0b3AsIGxlZnQsIHdpZHRoIGFuZCBoZWlnaHQuCiAgICAgICAgICovCiAgICAgICAgcG9zaXRpb246IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICB2YXIgZWxCQ1IgPSB0aGlzLm9mZnNldChlbGVtZW50KTsKICAgICAgICAgIHZhciBvZmZzZXRQYXJlbnRCQ1IgPSB7IHRvcDogMCwgbGVmdDogMCB9OwogICAgICAgICAgdmFyIG9mZnNldFBhcmVudEVsID0gcGFyZW50T2Zmc2V0RWwoZWxlbWVudFswXSk7CiAgICAgICAgICBpZiAob2Zmc2V0UGFyZW50RWwgIT0gJGRvY3VtZW50WzBdKSB7CiAgICAgICAgICAgIG9mZnNldFBhcmVudEJDUiA9IHRoaXMub2Zmc2V0KGFuZ3VsYXIuZWxlbWVudChvZmZzZXRQYXJlbnRFbCkpOwogICAgICAgICAgICBvZmZzZXRQYXJlbnRCQ1IudG9wICs9IG9mZnNldFBhcmVudEVsLmNsaWVudFRvcCAtIG9mZnNldFBhcmVudEVsLnNjcm9sbFRvcDsKICAgICAgICAgICAgb2Zmc2V0UGFyZW50QkNSLmxlZnQgKz0gb2Zmc2V0UGFyZW50RWwuY2xpZW50TGVmdCAtIG9mZnNldFBhcmVudEVsLnNjcm9sbExlZnQ7CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIGJvdW5kaW5nQ2xpZW50UmVjdCA9IGVsZW1lbnRbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB3aWR0aDogYm91bmRpbmdDbGllbnRSZWN0LndpZHRoIHx8IGVsZW1lbnQucHJvcCgnb2Zmc2V0V2lkdGgnKSwKICAgICAgICAgICAgaGVpZ2h0OiBib3VuZGluZ0NsaWVudFJlY3QuaGVpZ2h0IHx8IGVsZW1lbnQucHJvcCgnb2Zmc2V0SGVpZ2h0JyksCiAgICAgICAgICAgIHRvcDogZWxCQ1IudG9wIC0gb2Zmc2V0UGFyZW50QkNSLnRvcCwKICAgICAgICAgICAgbGVmdDogZWxCQ1IubGVmdCAtIG9mZnNldFBhcmVudEJDUi5sZWZ0CiAgICAgICAgICB9OwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkaW9uaWNQb3NpdGlvbiNvZmZzZXQKICAgICAgICAgKiBAZGVzY3JpcHRpb24gR2V0IHRoZSBjdXJyZW50IGNvb3JkaW5hdGVzIG9mIHRoZSBlbGVtZW50LCByZWxhdGl2ZSB0byB0aGUgZG9jdW1lbnQuCiAgICAgICAgICogUmVhZC1vbmx5IGVxdWl2YWxlbnQgb2YgW2pRdWVyeSdzIG9mZnNldCBmdW5jdGlvbl0oaHR0cDovL2FwaS5qcXVlcnkuY29tL29mZnNldC8pLgogICAgICAgICAqIEBwYXJhbSB7ZWxlbWVudH0gZWxlbWVudCBUaGUgZWxlbWVudCB0byBnZXQgdGhlIG9mZnNldCBvZi4KICAgICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBwcm9wZXJ0aWVzIHRvcCwgbGVmdCwgd2lkdGggYW5kIGhlaWdodC4KICAgICAgICAgKi8KICAgICAgICBvZmZzZXQ6IGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICB2YXIgYm91bmRpbmdDbGllbnRSZWN0ID0gZWxlbWVudFswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHdpZHRoOiBib3VuZGluZ0NsaWVudFJlY3Qud2lkdGggfHwgZWxlbWVudC5wcm9wKCdvZmZzZXRXaWR0aCcpLAogICAgICAgICAgICBoZWlnaHQ6IGJvdW5kaW5nQ2xpZW50UmVjdC5oZWlnaHQgfHwgZWxlbWVudC5wcm9wKCdvZmZzZXRIZWlnaHQnKSwKICAgICAgICAgICAgdG9wOiBib3VuZGluZ0NsaWVudFJlY3QudG9wICsgKCR3aW5kb3cucGFnZVlPZmZzZXQgfHwgJGRvY3VtZW50WzBdLmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3ApLAogICAgICAgICAgICBsZWZ0OiBib3VuZGluZ0NsaWVudFJlY3QubGVmdCArICgkd2luZG93LnBhZ2VYT2Zmc2V0IHx8ICRkb2N1bWVudFswXS5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCkKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgfTsKICAgIH1dKTsKCgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGVsZWdhdGUgZm9yIGNvbnRyb2xsaW5nIHNjcm9sbFZpZXdzIChjcmVhdGVkIGJ5CiAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25Db250ZW50fSBhbmQKICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNjcm9sbH0gZGlyZWN0aXZlcykuCiAgICoKICAgKiBNZXRob2RzIGNhbGxlZCBkaXJlY3RseSBvbiB0aGUgJGlvbmljU2Nyb2xsRGVsZWdhdGUgc2VydmljZSB3aWxsIGNvbnRyb2wgYWxsIHNjcm9sbAogICAqIHZpZXdzLiAgVXNlIHRoZSB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNTY3JvbGxEZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUgJGdldEJ5SGFuZGxlfQogICAqIG1ldGhvZCB0byBjb250cm9sIHNwZWNpZmljIHNjcm9sbFZpZXdzLgogICAqCiAgICogQHVzYWdlCiAgICoKICAgKiBgYGBodG1sCiAgICogPGJvZHkgbmctY29udHJvbGxlcj0iTWFpbkN0cmwiPgogICAqICAgPGlvbi1jb250ZW50PgogICAqICAgICA8YnV0dG9uIG5nLWNsaWNrPSJzY3JvbGxUb3AoKSI+U2Nyb2xsIHRvIFRvcCE8L2J1dHRvbj4KICAgKiAgIDwvaW9uLWNvbnRlbnQ+CiAgICogPC9ib2R5PgogICAqIGBgYAogICAqIGBgYGpzCiAgICogZnVuY3Rpb24gTWFpbkN0cmwoJHNjb3BlLCAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSkgewogKiAgICRzY29wZS5zY3JvbGxUb3AgPSBmdW5jdGlvbigpIHsKICogICAgICRpb25pY1Njcm9sbERlbGVnYXRlLnNjcm9sbFRvcCgpOwogKiAgIH07CiAqIH0KICAgKiBgYGAKICAgKgogICAqIEV4YW1wbGUgb2YgYWR2YW5jZWQgdXNhZ2UsIHdpdGggdHdvIHNjcm9sbCBhcmVhcyB1c2luZyBgZGVsZWdhdGUtaGFuZGxlYAogICAqIGZvciBmaW5lIGNvbnRyb2wuCiAgICoKICAgKiBgYGBodG1sCiAgICogPGJvZHkgbmctY29udHJvbGxlcj0iTWFpbkN0cmwiPgogICAqICAgPGlvbi1jb250ZW50IGRlbGVnYXRlLWhhbmRsZT0ibWFpblNjcm9sbCI+CiAgICogICAgIDxidXR0b24gbmctY2xpY2s9InNjcm9sbE1haW5Ub1RvcCgpIj4KICAgKiAgICAgICBTY3JvbGwgY29udGVudCB0byB0b3AhCiAgICogICAgIDwvYnV0dG9uPgogICAqICAgICA8aW9uLXNjcm9sbCBkZWxlZ2F0ZS1oYW5kbGU9InNtYWxsIiBzdHlsZT0iaGVpZ2h0OiAxMDBweDsiPgogICAqICAgICAgIDxidXR0b24gbmctY2xpY2s9InNjcm9sbFNtYWxsVG9Ub3AoKSI+CiAgICogICAgICAgICBTY3JvbGwgc21hbGwgYXJlYSB0byB0b3AhCiAgICogICAgICAgPC9idXR0b24+CiAgICogICAgIDwvaW9uLXNjcm9sbD4KICAgKiAgIDwvaW9uLWNvbnRlbnQ+CiAgICogPC9ib2R5PgogICAqIGBgYAogICAqIGBgYGpzCiAgICogZnVuY3Rpb24gTWFpbkN0cmwoJHNjb3BlLCAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSkgewogKiAgICRzY29wZS5zY3JvbGxNYWluVG9Ub3AgPSBmdW5jdGlvbigpIHsKICogICAgICRpb25pY1Njcm9sbERlbGVnYXRlLiRnZXRCeUhhbmRsZSgnbWFpblNjcm9sbCcpLnNjcm9sbFRvcCgpOwogKiAgIH07CiAqICAgJHNjb3BlLnNjcm9sbFNtYWxsVG9Ub3AgPSBmdW5jdGlvbigpIHsKICogICAgICRpb25pY1Njcm9sbERlbGVnYXRlLiRnZXRCeUhhbmRsZSgnc21hbGwnKS5zY3JvbGxUb3AoKTsKICogICB9OwogKiB9CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5zZXJ2aWNlKCckaW9uaWNTY3JvbGxEZWxlZ2F0ZScsIGRlbGVnYXRlU2VydmljZShbCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI3Jlc2l6ZQogICAgICogQGRlc2NyaXB0aW9uIFRlbGwgdGhlIHNjcm9sbFZpZXcgdG8gcmVjYWxjdWxhdGUgdGhlIHNpemUgb2YgaXRzIGNvbnRhaW5lci4KICAgICAqLwogICAgICAncmVzaXplJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjc2Nyb2xsVG9wCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG91bGRBbmltYXRlIFdoZXRoZXIgdGhlIHNjcm9sbCBzaG91bGQgYW5pbWF0ZS4KICAgICAqLwogICAgICAnc2Nyb2xsVG9wJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjc2Nyb2xsQm90dG9tCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG91bGRBbmltYXRlIFdoZXRoZXIgdGhlIHNjcm9sbCBzaG91bGQgYW5pbWF0ZS4KICAgICAqLwogICAgICAnc2Nyb2xsQm90dG9tJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjc2Nyb2xsVG8KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBsZWZ0IFRoZSB4LXZhbHVlIHRvIHNjcm9sbCB0by4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB0b3AgVGhlIHktdmFsdWUgdG8gc2Nyb2xsIHRvLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdWxkQW5pbWF0ZSBXaGV0aGVyIHRoZSBzY3JvbGwgc2hvdWxkIGFuaW1hdGUuCiAgICAgKi8KICAgICAgJ3Njcm9sbFRvJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjc2Nyb2xsQnkKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBsZWZ0IFRoZSB4LW9mZnNldCB0byBzY3JvbGwgYnkuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdG9wIFRoZSB5LW9mZnNldCB0byBzY3JvbGwgYnkuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG91bGRBbmltYXRlIFdoZXRoZXIgdGhlIHNjcm9sbCBzaG91bGQgYW5pbWF0ZS4KICAgICAqLwogICAgICAnc2Nyb2xsQnknLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNnZXRTY3JvbGxQb3NpdGlvbgogICAgICogQHJldHVybnMge29iamVjdH0gVGhlIHNjcm9sbCBwb3NpdGlvbiBvZiB0aGlzIHZpZXcsIHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOgogICAgICogIC0gYHtudW1iZXJ9YCBgbGVmdGAgVGhlIGRpc3RhbmNlIHRoZSB1c2VyIGhhcyBzY3JvbGxlZCBmcm9tIHRoZSBsZWZ0IChzdGFydHMgYXQgMCkuCiAgICAgKiAgLSBge251bWJlcn1gIGB0b3BgIFRoZSBkaXN0YW5jZSB0aGUgdXNlciBoYXMgc2Nyb2xsZWQgZnJvbSB0aGUgdG9wIChzdGFydHMgYXQgMCkuCiAgICAgKi8KICAgICAgJ2dldFNjcm9sbFBvc2l0aW9uJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjYW5jaG9yU2Nyb2xsCiAgICAgKiBAZGVzY3JpcHRpb24gVGVsbCB0aGUgc2Nyb2xsVmlldyB0byBzY3JvbGwgdG8gdGhlIGVsZW1lbnQgd2l0aCBhbiBpZAogICAgICogbWF0Y2hpbmcgd2luZG93LmxvY2F0aW9uLmhhc2guCiAgICAgKgogICAgICogSWYgbm8gbWF0Y2hpbmcgZWxlbWVudCBpcyBmb3VuZCwgaXQgd2lsbCBzY3JvbGwgdG8gdG9wLgogICAgICoKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3VsZEFuaW1hdGUgV2hldGhlciB0aGUgc2Nyb2xsIHNob3VsZCBhbmltYXRlLgogICAgICovCiAgICAgICdhbmNob3JTY3JvbGwnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNnZXRTY3JvbGxWaWV3CiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBUaGUgc2Nyb2xsVmlldyBhc3NvY2lhdGVkIHdpdGggdGhpcyBkZWxlZ2F0ZS4KICAgICAqLwogICAgICAnZ2V0U2Nyb2xsVmlldycsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI3JlbWVtYmVyU2Nyb2xsUG9zaXRpb24KICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV2lsbCBtYWtlIGl0IHNvLCB3aGVuIHRoaXMgc2Nyb2xsVmlldyBpcyBkZXN0cm95ZWQgKHVzZXIgbGVhdmVzIHRoZSBwYWdlKSwKICAgICAqIHRoZSBsYXN0IHNjcm9sbCBwb3NpdGlvbiB0aGUgcGFnZSB3YXMgb24gd2lsbCBiZSBzYXZlZCwgaW5kZXhlZCBieSB0aGUKICAgICAqIGdpdmVuIGlkLgogICAgICoKICAgICAqIE5vdGU6IGZvciBwYWdlcyBhc3NvY2lhdGVkIHdpdGggYSB2aWV3IHVuZGVyIGFuIGlvbi1uYXYtdmlldywKICAgICAqIHJlbWVtYmVyU2Nyb2xsUG9zaXRpb24gYXV0b21hdGljYWxseSBzYXZlcyB0aGVpciBzY3JvbGwuCiAgICAgKgogICAgICogUmVsYXRlZCBtZXRob2RzOiBzY3JvbGxUb1JlbWVtYmVyZWRQb3NpdGlvbiwgZm9yZ2V0U2Nyb2xsUG9zaXRpb24gKGJlbG93KS4KICAgICAqCiAgICAgKiBJbiB0aGUgZm9sbG93aW5nIGV4YW1wbGUsIHRoZSBzY3JvbGwgcG9zaXRpb24gb2YgdGhlIGlvbi1zY3JvbGwgZWxlbWVudAogICAgICogd2lsbCBwZXJzaXN0LCBldmVuIHdoZW4gdGhlIHVzZXIgY2hhbmdlcyB0aGUgdG9nZ2xlIHN3aXRjaC4KICAgICAqCiAgICAgKiBgYGBodG1sCiAgICAgKiA8aW9uLXRvZ2dsZSBuZy1tb2RlbD0ic2hvdWxkU2hvd1Njcm9sbFZpZXciPjwvaW9uLXRvZ2dsZT4KICAgICAqIDxpb24tc2Nyb2xsIGRlbGVnYXRlLWhhbmRsZT0ibXlTY3JvbGwiIG5nLWlmPSJzaG91bGRTaG93U2Nyb2xsVmlldyI+CiAgICAgKiAgIDxkaXYgbmctY29udHJvbGxlcj0iU2Nyb2xsQ3RybCI+CiAgICAgKiAgICAgPGlvbi1saXN0PgogICAgICogICAgICAgeyUgcmF3ICV9PGlvbi1pdGVtIG5nLXJlcGVhdD0iaSBpbiBpdGVtcyI+e3tpfX08L2lvbi1pdGVtPnslIGVuZHJhdyAlfQogICAgICogICAgIDwvaW9uLWxpc3Q+CiAgICAgKiAgIDwvZGl2PgogICAgICogPC9pb24tc2Nyb2xsPgogICAgICogYGBgCiAgICAgKiBgYGBqcwogICAgICogZnVuY3Rpb24gU2Nyb2xsQ3RybCgkc2NvcGUsICRpb25pY1Njcm9sbERlbGVnYXRlKSB7CiAgICogICB2YXIgZGVsZWdhdGUgPSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ215U2Nyb2xsJyk7CiAgICoKICAgKiAgIC8vIFB1dCBhbnkgdW5pcXVlIElEIGhlcmUuICBUaGUgcG9pbnQgb2YgdGhpcyBpczogZXZlcnkgdGltZSB0aGUgY29udHJvbGxlciBpcyByZWNyZWF0ZWQKICAgKiAgIC8vIHdlIHdhbnQgdG8gbG9hZCB0aGUgY29ycmVjdCByZW1lbWJlcmVkIHNjcm9sbCB2YWx1ZXMuCiAgICogICBkZWxlZ2F0ZS5yZW1lbWJlclNjcm9sbFBvc2l0aW9uKCdteS1zY3JvbGwtaWQnKTsKICAgKiAgIGRlbGVnYXRlLnNjcm9sbFRvUmVtZW1iZXJlZFBvc2l0aW9uKCk7CiAgICogICAkc2NvcGUuaXRlbXMgPSBbXTsKICAgKiAgIGZvciAodmFyIGk9MDsgaTwxMDA7IGkrKykgewogICAqICAgICAkc2NvcGUuaXRlbXMucHVzaChpKTsKICAgKiAgIH0KICAgKiB9CiAgICAgKiBgYGAKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaWQgVGhlIGlkIHRvIHJlbWVtYmVyIHRoZSBzY3JvbGwgcG9zaXRpb24gb2YgdGhpcwogICAgICogc2Nyb2xsVmlldyBieS4KICAgICAqLwogICAgICAncmVtZW1iZXJTY3JvbGxQb3NpdGlvbicsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI2ZvcmdldFNjcm9sbFBvc2l0aW9uCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFN0b3AgcmVtZW1iZXJpbmcgdGhlIHNjcm9sbCBwb3NpdGlvbiBmb3IgdGhpcyBzY3JvbGxWaWV3LgogICAgICovCiAgICAgICdmb3JnZXRTY3JvbGxQb3NpdGlvbicsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI3Njcm9sbFRvUmVtZW1iZXJlZFBvc2l0aW9uCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIElmIHRoaXMgc2Nyb2xsVmlldyBoYXMgYW4gaWQgYXNzb2NpYXRlZCB3aXRoIGl0cyBzY3JvbGwgcG9zaXRpb24sCiAgICAgKiAodGhyb3VnaCBjYWxsaW5nIHJlbWVtYmVyU2Nyb2xsUG9zaXRpb24pLCBhbmQgdGhhdCBwb3NpdGlvbiBpcyByZW1lbWJlcmVkLAogICAgICogbG9hZCB0aGUgcG9zaXRpb24gYW5kIHNjcm9sbCB0byBpdC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3VsZEFuaW1hdGUgV2hldGhlciB0byBhbmltYXRlIHRoZSBzY3JvbGwuCiAgICAgKi8KICAgICAgJ3Njcm9sbFRvUmVtZW1iZXJlZFBvc2l0aW9uJwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoYW5kbGUKICAgICAqIEByZXR1cm5zIGBkZWxlZ2F0ZUluc3RhbmNlYCBBIGRlbGVnYXRlIGluc3RhbmNlIHRoYXQgY29udHJvbHMgb25seSB0aGUKICAgICAqIHNjcm9sbFZpZXdzIHdpdGggYGRlbGVnYXRlLWhhbmRsZWAgbWF0Y2hpbmcgdGhlIGdpdmVuIGhhbmRsZS4KICAgICAqCiAgICAgKiBFeGFtcGxlOiBgJGlvbmljU2Nyb2xsRGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdteS1oYW5kbGUnKS5zY3JvbGxUb3AoKTtgCiAgICAgKi8KICAgIF0pKTsKCgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZQogICAqIEBtb2R1bGUgaW9uaWMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERlbGVnYXRlIGZvciBjb250cm9sbGluZyB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXN9IGRpcmVjdGl2ZS4KICAgKgogICAqIE1ldGhvZHMgY2FsbGVkIGRpcmVjdGx5IG9uIHRoZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlIHNlcnZpY2Ugd2lsbCBjb250cm9sIGFsbCBzaWRlCiAgICogbWVudXMuICBVc2UgdGhlIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1NpZGVNZW51RGVsZWdhdGUjJGdldEJ5SGFuZGxlICRnZXRCeUhhbmRsZX0KICAgKiBtZXRob2QgdG8gY29udHJvbCBzcGVjaWZpYyBpb25TaWRlTWVudXMgaW5zdGFuY2VzLgogICAqCiAgICogQHVzYWdlCiAgICoKICAgKiBgYGBodG1sCiAgICogPGJvZHkgbmctY29udHJvbGxlcj0iTWFpbkN0cmwiPgogICAqICAgPGlvbi1zaWRlLW1lbnVzPgogICAqICAgICA8aW9uLXNpZGUtbWVudS1jb250ZW50PgogICAqICAgICAgIENvbnRlbnQhCiAgICogICAgICAgPGJ1dHRvbiBuZy1jbGljaz0idG9nZ2xlTGVmdFNpZGVNZW51KCkiPgogICAqICAgICAgICAgVG9nZ2xlIExlZnQgU2lkZSBNZW51CiAgICogICAgICAgPC9idXR0b24+CiAgICogICAgIDwvaW9uLXNpZGUtbWVudS1jb250ZW50PgogICAqICAgICA8aW9uLXNpZGUtbWVudSBzaWRlPSJsZWZ0Ij4KICAgKiAgICAgICBMZWZ0IE1lbnUhCiAgICogICAgIDxpb24tc2lkZS1tZW51PgogICAqICAgPC9pb24tc2lkZS1tZW51cz4KICAgKiA8L2JvZHk+CiAgICogYGBgCiAgICogYGBganMKICAgKiBmdW5jdGlvbiBNYWluQ3RybCgkc2NvcGUsICRpb25pY1NpZGVNZW51RGVsZWdhdGUpIHsKICogICAkc2NvcGUudG9nZ2xlTGVmdFNpZGVNZW51ID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNTaWRlTWVudURlbGVnYXRlLnRvZ2dsZUxlZnQoKTsKICogICB9OwogKiB9CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5zZXJ2aWNlKCckaW9uaWNTaWRlTWVudURlbGVnYXRlJywgZGVsZWdhdGVTZXJ2aWNlKFsKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSN0b2dnbGVMZWZ0CiAgICAgKiBAZGVzY3JpcHRpb24gVG9nZ2xlIHRoZSBsZWZ0IHNpZGUgbWVudSAoaWYgaXQgZXhpc3RzKS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IGlzT3BlbiBXaGV0aGVyIHRvIG9wZW4gb3IgY2xvc2UgdGhlIG1lbnUuCiAgICAgKiBEZWZhdWx0OiBUb2dnbGVzIHRoZSBtZW51LgogICAgICovCiAgICAgICd0b2dnbGVMZWZ0JywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSN0b2dnbGVSaWdodAogICAgICogQGRlc2NyaXB0aW9uIFRvZ2dsZSB0aGUgcmlnaHQgc2lkZSBtZW51IChpZiBpdCBleGlzdHMpLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gaXNPcGVuIFdoZXRoZXIgdG8gb3BlbiBvciBjbG9zZSB0aGUgbWVudS4KICAgICAqIERlZmF1bHQ6IFRvZ2dsZXMgdGhlIG1lbnUuCiAgICAgKi8KICAgICAgJ3RvZ2dsZVJpZ2h0JywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSNnZXRPcGVuUmF0aW8KICAgICAqIEBkZXNjcmlwdGlvbiBHZXRzIHRoZSByYXRpbyBvZiBvcGVuIGFtb3VudCBvdmVyIG1lbnUgd2lkdGguIEZvciBleGFtcGxlLCBhCiAgICAgKiBtZW51IG9mIHdpZHRoIDEwMCB0aGF0IGlzIG9wZW5lZCBieSA1MCBwaXhlbHMgaXMgNTAlIG9wZW5lZCwgYW5kIHdvdWxkIHJldHVybgogICAgICogYSByYXRpbyBvZiAwLjUuCiAgICAgKgogICAgICogQHJldHVybnMge2Zsb2F0fSAwIGlmIG5vdGhpbmcgaXMgb3BlbiwgYmV0d2VlbiAwIGFuZCAxIGlmIGxlZnQgbWVudSBpcwogICAgICogb3BlbmVkL29wZW5pbmcsIGFuZCBiZXR3ZWVuIDAgYW5kIC0xIGlmIHJpZ2h0IG1lbnUgaXMgb3BlbmVkL29wZW5pbmcuCiAgICAgKi8KICAgICAgJ2dldE9wZW5SYXRpbycsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1NpZGVNZW51RGVsZWdhdGUjaXNPcGVuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciBlaXRoZXIgdGhlIGxlZnQgb3IgcmlnaHQgbWVudSBpcyBjdXJyZW50bHkgb3BlbmVkLgogICAgICovCiAgICAgICdpc09wZW4nLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI2lzT3BlbkxlZnQKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSBsZWZ0IG1lbnUgaXMgY3VycmVudGx5IG9wZW5lZC4KICAgICAqLwogICAgICAnaXNPcGVuTGVmdCcsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1NpZGVNZW51RGVsZWdhdGUjaXNPcGVuUmlnaHQKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSByaWdodCBtZW51IGlzIGN1cnJlbnRseSBvcGVuZWQuCiAgICAgKi8KICAgICAgJ2lzT3BlblJpZ2h0JywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSNjYW5EcmFnQ29udGVudAogICAgICogQHBhcmFtIHtib29sZWFuPX0gY2FuRHJhZyBTZXQgd2hldGhlciB0aGUgY29udGVudCBjYW4gb3IgY2Fubm90IGJlIGRyYWdnZWQgdG8gb3BlbgogICAgICogc2lkZSBtZW51cy4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSBjb250ZW50IGNhbiBiZSBkcmFnZ2VkIHRvIG9wZW4gc2lkZSBtZW51cy4KICAgICAqLwogICAgICAnY2FuRHJhZ0NvbnRlbnQnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI2VkZ2VEcmFnVGhyZXNob2xkCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW58bnVtYmVyPX0gdmFsdWUgU2V0IHdoZXRoZXIgdGhlIGNvbnRlbnQgZHJhZyBjYW4gb25seSBzdGFydCBpZiBpdCBpcyBiZWxvdyBhIGNlcnRhaW4gdGhyZXNob2xkIGRpc3RhbmNlIGZyb20gdGhlIGVkZ2Ugb2YgdGhlIHNjcmVlbi4gQWNjZXB0cyB0aHJlZSBkaWZmZXJlbnQgdmFsdWVzOgogICAgICogIC0gSWYgYSBub24temVybyBudW1iZXIgaXMgZ2l2ZW4sIHRoYXQgbWFueSBwaXhlbHMgaXMgdXNlZCBhcyB0aGUgbWF4aW11bSBhbGxvd2VkIGRpc3RhbmNlIGZyb20gdGhlIGVkZ2UgdGhhdCBzdGFydHMgZHJhZ2dpbmcgdGhlIHNpZGUgbWVudS4KICAgICAqICAtIElmIHRydWUgaXMgZ2l2ZW4sIHRoZSBkZWZhdWx0IG51bWJlciBvZiBwaXhlbHMgKDI1KSBpcyB1c2VkIGFzIHRoZSBtYXhpbXVtIGFsbG93ZWQgZGlzdGFuY2UuCiAgICAgKiAgLSBJZiBmYWxzZSBvciAwIGlzIGdpdmVuLCB0aGUgZWRnZSBkcmFnIHRocmVzaG9sZCBpcyBkaXNhYmxlZCwgYW5kIGRyYWdnaW5nIGZyb20gYW55d2hlcmUgb24gdGhlIGNvbnRlbnQgaXMgYWxsb3dlZC4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSBkcmFnIGNhbiBzdGFydCBvbmx5IGZyb20gd2l0aGluIHRoZSBlZGdlIG9mIHNjcmVlbiB0aHJlc2hvbGQuCiAgICAgKi8KICAgICAgJ2VkZ2VEcmFnVGhyZXNob2xkJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoYW5kbGUKICAgICAqIEByZXR1cm5zIGBkZWxlZ2F0ZUluc3RhbmNlYCBBIGRlbGVnYXRlIGluc3RhbmNlIHRoYXQgY29udHJvbHMgb25seSB0aGUKICAgICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnVzfSBkaXJlY3RpdmVzIHdpdGggYGRlbGVnYXRlLWhhbmRsZWAgbWF0Y2hpbmcKICAgICAqIHRoZSBnaXZlbiBoYW5kbGUuCiAgICAgKgogICAgICogRXhhbXBsZTogYCRpb25pY1NpZGVNZW51RGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdteS1oYW5kbGUnKS50b2dnbGVMZWZ0KCk7YAogICAgICovCiAgICBdKSk7CgoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGVsZWdhdGUgdGhhdCBjb250cm9scyB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TbGlkZUJveH0gZGlyZWN0aXZlLgogICAqCiAgICogTWV0aG9kcyBjYWxsZWQgZGlyZWN0bHkgb24gdGhlICRpb25pY1NsaWRlQm94RGVsZWdhdGUgc2VydmljZSB3aWxsIGNvbnRyb2wgYWxsIHNsaWRlIGJveGVzLiAgVXNlIHRoZSB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNTbGlkZUJveERlbGVnYXRlIyRnZXRCeUhhbmRsZSAkZ2V0QnlIYW5kbGV9CiAgICogbWV0aG9kIHRvIGNvbnRyb2wgc3BlY2lmaWMgc2xpZGUgYm94IGluc3RhbmNlcy4KICAgKgogICAqIEB1c2FnZQogICAqCiAgICogYGBgaHRtbAogICAqIDxib2R5IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+CiAgICogICA8aW9uLXNsaWRlLWJveD4KICAgKiAgICAgPGlvbi1zbGlkZT4KICAgKiAgICAgICA8ZGl2IGNsYXNzPSJib3ggYmx1ZSI+CiAgICogICAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJuZXh0U2xpZGUoKSI+TmV4dCBzbGlkZSE8L2J1dHRvbj4KICAgKiAgICAgICA8L2Rpdj4KICAgKiAgICAgPC9pb24tc2xpZGU+CiAgICogICAgIDxpb24tc2xpZGU+CiAgICogICAgICAgPGRpdiBjbGFzcz0iYm94IHJlZCI+CiAgICogICAgICAgICBTbGlkZSAyIQogICAqICAgICAgIDwvZGl2PgogICAqICAgICA8L2lvbi1zbGlkZT4KICAgKiAgIDwvaW9uLXNsaWRlLWJveD4KICAgKiA8L2JvZHk+CiAgICogYGBgCiAgICogYGBganMKICAgKiBmdW5jdGlvbiBNeUN0cmwoJHNjb3BlLCAkaW9uaWNTbGlkZUJveERlbGVnYXRlKSB7CiAqICAgJHNjb3BlLm5leHRTbGlkZSA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZS5uZXh0KCk7CiAqICAgfQogKiB9CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5zZXJ2aWNlKCckaW9uaWNTbGlkZUJveERlbGVnYXRlJywgZGVsZWdhdGVTZXJ2aWNlKFsKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSN1cGRhdGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVXBkYXRlIHRoZSBzbGlkZWJveCAoZm9yIGV4YW1wbGUgaWYgdXNpbmcgQW5ndWxhciB3aXRoIG5nLXJlcGVhdCwKICAgICAqIHJlc2l6ZSBpdCBmb3IgdGhlIGVsZW1lbnRzIGluc2lkZSkuCiAgICAgKi8KICAgICAgJ3VwZGF0ZScsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjc2xpZGUKICAgICAqIEBwYXJhbSB7bnVtYmVyfSB0byBUaGUgaW5kZXggdG8gc2xpZGUgdG8uCiAgICAgKiBAcGFyYW0ge251bWJlcj19IHNwZWVkIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIGZvciB0aGUgY2hhbmdlIHRvIHRha2UuCiAgICAgKi8KICAgICAgJ3NsaWRlJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNlbmFibGVTbGlkZQogICAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdWxkRW5hYmxlIFdoZXRoZXIgdG8gZW5hYmxlIHNsaWRpbmcgdGhlIHNsaWRlYm94LgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgc2xpZGluZyBpcyBlbmFibGVkLgogICAgICovCiAgICAgICdlbmFibGVTbGlkZScsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjcHJldmlvdXMKICAgICAqIEBkZXNjcmlwdGlvbiBHbyB0byB0aGUgcHJldmlvdXMgc2xpZGUuIFdyYXBzIGFyb3VuZCBpZiBhdCB0aGUgYmVnaW5uaW5nLgogICAgICovCiAgICAgICdwcmV2aW91cycsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjbmV4dAogICAgICogQGRlc2NyaXB0aW9uIEdvIHRvIHRoZSBuZXh0IHNsaWRlLiBXcmFwcyBhcm91bmQgaWYgYXQgdGhlIGVuZC4KICAgICAqLwogICAgICAnbmV4dCcsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjc3RvcAogICAgICogQGRlc2NyaXB0aW9uIFN0b3Agc2xpZGluZy4gVGhlIHNsaWRlQm94IHdpbGwgbm90IG1vdmUgYWdhaW4gdW50aWwKICAgICAqIGV4cGxpY2l0bHkgdG9sZCB0byBkbyBzby4KICAgICAqLwogICAgICAnc3RvcCcsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjc3RhcnQKICAgICAqIEBkZXNjcmlwdGlvbiBTdGFydCBzbGlkaW5nIGFnYWluIGlmIHRoZSBzbGlkZUJveCB3YXMgc3RvcHBlZC4KICAgICAqLwogICAgICAnc3RhcnQnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlI2N1cnJlbnRJbmRleAogICAgICogQHJldHVybnMgbnVtYmVyIFRoZSBpbmRleCBvZiB0aGUgY3VycmVudCBzbGlkZS4KICAgICAqLwogICAgICAnY3VycmVudEluZGV4JywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNzbGlkZXNDb3VudAogICAgICogQHJldHVybnMgbnVtYmVyIFRoZSBudW1iZXIgb2Ygc2xpZGVzIHRoZXJlIGFyZSBjdXJyZW50bHkuCiAgICAgKi8KICAgICAgJ3NsaWRlc0NvdW50JwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlIyRnZXRCeUhhbmRsZQogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhbmRsZQogICAgICogQHJldHVybnMgYGRlbGVnYXRlSW5zdGFuY2VgIEEgZGVsZWdhdGUgaW5zdGFuY2UgdGhhdCBjb250cm9scyBvbmx5IHRoZQogICAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TbGlkZUJveH0gZGlyZWN0aXZlcyB3aXRoIGBkZWxlZ2F0ZS1oYW5kbGVgIG1hdGNoaW5nCiAgICAgKiB0aGUgZ2l2ZW4gaGFuZGxlLgogICAgICoKICAgICAqIEV4YW1wbGU6IGAkaW9uaWNTbGlkZUJveERlbGVnYXRlLiRnZXRCeUhhbmRsZSgnbXktaGFuZGxlJykuc3RvcCgpO2AKICAgICAqLwogICAgXSkpOwoKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkaW9uaWNUYWJzRGVsZWdhdGUKICAgKiBAbW9kdWxlIGlvbmljCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZWxlZ2F0ZSBmb3IgY29udHJvbGxpbmcgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uVGFic30gZGlyZWN0aXZlLgogICAqCiAgICogTWV0aG9kcyBjYWxsZWQgZGlyZWN0bHkgb24gdGhlICRpb25pY1RhYnNEZWxlZ2F0ZSBzZXJ2aWNlIHdpbGwgY29udHJvbCBhbGwgaW9uVGFicwogICAqIGRpcmVjdGl2ZXMuIFVzZSB0aGUge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljVGFic0RlbGVnYXRlIyRnZXRCeUhhbmRsZSAkZ2V0QnlIYW5kbGV9CiAgICogbWV0aG9kIHRvIGNvbnRyb2wgc3BlY2lmaWMgaW9uVGFicyBpbnN0YW5jZXMuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIGBgYGh0bWwKICAgKiA8Ym9keSBuZy1jb250cm9sbGVyPSJNeUN0cmwiPgogICAqICAgPGlvbi10YWJzPgogICAqCiAgICogICAgIDxpb24tdGFiIHRpdGxlPSJUYWIgMSI+CiAgICogICAgICAgSGVsbG8gdGFiIDEhCiAgICogICAgICAgPGJ1dHRvbiBuZy1jbGljaz0ic2VsZWN0VGFiV2l0aEluZGV4KDEpIj5TZWxlY3QgdGFiIDIhPC9idXR0b24+CiAgICogICAgIDwvaW9uLXRhYj4KICAgKiAgICAgPGlvbi10YWIgdGl0bGU9IlRhYiAyIj5IZWxsbyB0YWIgMiE8L2lvbi10YWI+CiAgICoKICAgKiAgIDwvaW9uLXRhYnM+CiAgICogPC9ib2R5PgogICAqIGBgYAogICAqIGBgYGpzCiAgICogZnVuY3Rpb24gTXlDdHJsKCRzY29wZSwgJGlvbmljVGFic0RlbGVnYXRlKSB7CiAqICAgJHNjb3BlLnNlbGVjdFRhYldpdGhJbmRleCA9IGZ1bmN0aW9uKGluZGV4KSB7CiAqICAgICAkaW9uaWNUYWJzRGVsZWdhdGUuc2VsZWN0KGluZGV4KTsKICogICB9CiAqIH0KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLnNlcnZpY2UoJyRpb25pY1RhYnNEZWxlZ2F0ZScsIGRlbGVnYXRlU2VydmljZShbCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1RhYnNEZWxlZ2F0ZSNzZWxlY3QKICAgICAqIEBkZXNjcmlwdGlvbiBTZWxlY3QgdGhlIHRhYiBtYXRjaGluZyB0aGUgZ2l2ZW4gaW5kZXguCiAgICAgKgogICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IEluZGV4IG9mIHRoZSB0YWIgdG8gc2VsZWN0LgogICAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdWxkQ2hhbmdlSGlzdG9yeSBXaGV0aGVyIHRoaXMgc2VsZWN0aW9uIHNob3VsZCBsb2FkIHRoaXMgdGFiJ3MKICAgICAqIHZpZXcgaGlzdG9yeSAoaWYgaXQgZXhpc3RzKSBhbmQgdXNlIGl0LCBvciBqdXN0IGxvYWQgdGhlIGRlZmF1bHQgcGFnZS4KICAgICAqIERlZmF1bHQgZmFsc2UuCiAgICAgKiBIaW50OiB5b3UgcHJvYmFibHkgd2FudCB0aGlzIHRvIGJlIHRydWUgaWYgeW91IGhhdmUgYW4KICAgICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2Vmlld30gaW5zaWRlIHlvdXIgdGFiLgogICAgICovCiAgICAgICdzZWxlY3QnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNUYWJzRGVsZWdhdGUjc2VsZWN0ZWRJbmRleAogICAgICogQHJldHVybnMgYG51bWJlcmAgVGhlIGluZGV4IG9mIHRoZSBzZWxlY3RlZCB0YWIsIG9yIC0xLgogICAgICovCiAgICAgICdzZWxlY3RlZEluZGV4JwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNUYWJzRGVsZWdhdGUjJGdldEJ5SGFuZGxlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGFuZGxlCiAgICAgKiBAcmV0dXJucyBgZGVsZWdhdGVJbnN0YW5jZWAgQSBkZWxlZ2F0ZSBpbnN0YW5jZSB0aGF0IGNvbnRyb2xzIG9ubHkgdGhlCiAgICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblRhYnN9IGRpcmVjdGl2ZXMgd2l0aCBgZGVsZWdhdGUtaGFuZGxlYCBtYXRjaGluZwogICAgICogdGhlIGdpdmVuIGhhbmRsZS4KICAgICAqCiAgICAgKiBFeGFtcGxlOiBgJGlvbmljVGFic0RlbGVnYXRlLiRnZXRCeUhhbmRsZSgnbXktaGFuZGxlJykuc2VsZWN0KDApO2AKICAgICAqLwogICAgXSkpOwoKCiAgSW9uaWNNb2R1bGUKICAgIC5mYWN0b3J5KCckaW9uaWNUZW1wbGF0ZUxvYWRlcicsIFsKICAgICAgJyRjb21waWxlJywKICAgICAgJyRjb250cm9sbGVyJywKICAgICAgJyRodHRwJywKICAgICAgJyRxJywKICAgICAgJyRyb290U2NvcGUnLAogICAgICAnJHRlbXBsYXRlQ2FjaGUnLAogICAgICBmdW5jdGlvbigkY29tcGlsZSwgJGNvbnRyb2xsZXIsICRodHRwLCAkcSwgJHJvb3RTY29wZSwgJHRlbXBsYXRlQ2FjaGUpIHsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGxvYWQ6IGZldGNoVGVtcGxhdGUsCiAgICAgICAgICBjb21waWxlOiBsb2FkQW5kQ29tcGlsZQogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGZldGNoVGVtcGxhdGUodXJsKSB7CiAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KHVybCwge2NhY2hlOiAkdGVtcGxhdGVDYWNoZX0pCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEgJiYgcmVzcG9uc2UuZGF0YS50cmltKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbG9hZEFuZENvbXBpbGUob3B0aW9ucykgewogICAgICAgICAgb3B0aW9ucyA9IGV4dGVuZCh7CiAgICAgICAgICAgIHRlbXBsYXRlOiAnJywKICAgICAgICAgICAgdGVtcGxhdGVVcmw6ICcnLAogICAgICAgICAgICBzY29wZTogbnVsbCwKICAgICAgICAgICAgY29udHJvbGxlcjogbnVsbCwKICAgICAgICAgICAgbG9jYWxzOiB7fSwKICAgICAgICAgICAgYXBwZW5kVG86IG51bGwKICAgICAgICAgIH0sIG9wdGlvbnMgfHwge30pOwoKICAgICAgICAgIHZhciB0ZW1wbGF0ZVByb21pc2UgPSBvcHRpb25zLnRlbXBsYXRlVXJsID8KICAgICAgICAgICAgdGhpcy5sb2FkKG9wdGlvbnMudGVtcGxhdGVVcmwpIDoKICAgICAgICAgICAgJHEud2hlbihvcHRpb25zLnRlbXBsYXRlKTsKCiAgICAgICAgICByZXR1cm4gdGVtcGxhdGVQcm9taXNlLnRoZW4oZnVuY3Rpb24odGVtcGxhdGUpIHsKICAgICAgICAgICAgdmFyIGNvbnRyb2xsZXI7CiAgICAgICAgICAgIHZhciBzY29wZSA9IG9wdGlvbnMuc2NvcGUgfHwgJHJvb3RTY29wZS4kbmV3KCk7CgogICAgICAgICAgICAvL0luY2FzZSB0ZW1wbGF0ZSBkb2Vzbid0IGhhdmUganVzdCBvbmUgcm9vdCBlbGVtZW50LCBkbyB0aGlzCiAgICAgICAgICAgIHZhciBlbGVtZW50ID0ganFMaXRlKCc8ZGl2PicpLmh0bWwodGVtcGxhdGUpLmNvbnRlbnRzKCk7CgogICAgICAgICAgICBpZiAob3B0aW9ucy5jb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgY29udHJvbGxlciA9ICRjb250cm9sbGVyKAogICAgICAgICAgICAgICAgb3B0aW9ucy5jb250cm9sbGVyLAogICAgICAgICAgICAgICAgZXh0ZW5kKG9wdGlvbnMubG9jYWxzLCB7CiAgICAgICAgICAgICAgICAgICRzY29wZTogc2NvcGUKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBlbGVtZW50LmNoaWxkcmVuKCkuZGF0YSgnJG5nQ29udHJvbGxlckNvbnRyb2xsZXInLCBjb250cm9sbGVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9ucy5hcHBlbmRUbykgewogICAgICAgICAgICAgIGpxTGl0ZShvcHRpb25zLmFwcGVuZFRvKS5hcHBlbmQoZWxlbWVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRjb21waWxlKGVsZW1lbnQpKHNjb3BlKTsKCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgZWxlbWVudDogZWxlbWVudCwKICAgICAgICAgICAgICBzY29wZTogc2NvcGUKICAgICAgICAgICAgfTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgIH1dKTsKCiAgLyoqCiAgICogQHByaXZhdGUKICAgKiBUT0RPIGRvY3VtZW50CiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5ydW4oWwogICAgICAnJHJvb3RTY29wZScsCiAgICAgICckc3RhdGUnLAogICAgICAnJGxvY2F0aW9uJywKICAgICAgJyRkb2N1bWVudCcsCiAgICAgICckYW5pbWF0ZScsCiAgICAgICckaW9uaWNQbGF0Zm9ybScsCiAgICAgICckaW9uaWNWaWV3U2VydmljZScsCiAgICAgIGZ1bmN0aW9uKCRyb290U2NvcGUsICRzdGF0ZSwgJGxvY2F0aW9uLCAkZG9jdW1lbnQsICRhbmltYXRlLCAkaW9uaWNQbGF0Zm9ybSwgJGlvbmljVmlld1NlcnZpY2UpIHsKCiAgICAgICAgLy8gaW5pdCB0aGUgdmFyaWFibGVzIHRoYXQga2VlcCB0cmFjayBvZiB0aGUgdmlldyBoaXN0b3J5CiAgICAgICAgJHJvb3RTY29wZS4kdmlld0hpc3RvcnkgPSB7CiAgICAgICAgICBoaXN0b3JpZXM6IHsgcm9vdDogeyBoaXN0b3J5SWQ6ICdyb290JywgcGFyZW50SGlzdG9yeUlkOiBudWxsLCBzdGFjazogW10sIGN1cnNvcjogLTEgfSB9LAogICAgICAgICAgdmlld3M6IHt9LAogICAgICAgICAgYmFja1ZpZXc6IG51bGwsCiAgICAgICAgICBmb3J3YXJkVmlldzogbnVsbCwKICAgICAgICAgIGN1cnJlbnRWaWV3OiBudWxsLAogICAgICAgICAgZGlzYWJsZWRSZWdpc3RyYWJsZVRhZ05hbWVzOiBbXQogICAgICAgIH07CgogICAgICAgIC8vIHNldCB0aGF0IHRoZXNlIGRpcmVjdGl2ZXMgc2hvdWxkIG5vdCBhbmltYXRlIHdoZW4gdHJhbnNpdGlvbmluZwogICAgICAgIC8vIHRvIGl0LiBJbnN0ZWFkLCB0aGUgY2hpbGRyZW4gPHRhYj4gZGlyZWN0aXZlcyB3b3VsZCBhbmltYXRlCiAgICAgICAgaWYgKCRpb25pY1ZpZXdTZXJ2aWNlLmRpc2FibGVSZWdpc3RlckJ5VGFnTmFtZSkgewogICAgICAgICAgJGlvbmljVmlld1NlcnZpY2UuZGlzYWJsZVJlZ2lzdGVyQnlUYWdOYW1lKCdpb24tdGFicycpOwogICAgICAgICAgJGlvbmljVmlld1NlcnZpY2UuZGlzYWJsZVJlZ2lzdGVyQnlUYWdOYW1lKCdpb24tc2lkZS1tZW51cycpOwogICAgICAgIH0KCiAgICAgICAgJHJvb3RTY29wZS4kb24oJ3ZpZXdTdGF0ZS5jaGFuZ2VIaXN0b3J5JywgZnVuY3Rpb24oZSwgZGF0YSkgewogICAgICAgICAgaWYoIWRhdGEpIHJldHVybjsKCiAgICAgICAgICB2YXIgaGlzdCA9IChkYXRhLmhpc3RvcnlJZCA/ICRyb290U2NvcGUuJHZpZXdIaXN0b3J5Lmhpc3Rvcmllc1sgZGF0YS5oaXN0b3J5SWQgXSA6IG51bGwgKTsKICAgICAgICAgIGlmKGhpc3QgJiYgaGlzdC5jdXJzb3IgPiAtMSAmJiBoaXN0LmN1cnNvciA8IGhpc3Quc3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgIC8vIHRoZSBoaXN0b3J5IHRoZXkncmUgZ29pbmcgdG8gYWxyZWFkeSBleGlzdHMKICAgICAgICAgICAgLy8gZ28gdG8gaXQncyBsYXN0IHZpZXcgaW4gaXRzIHN0YWNrCiAgICAgICAgICAgIHZhciB2aWV3ID0gaGlzdC5zdGFja1sgaGlzdC5jdXJzb3IgXTsKICAgICAgICAgICAgcmV0dXJuIHZpZXcuZ28oZGF0YSk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gdGhpcyBoaXN0b3J5IGRvZXMgbm90IGhhdmUgYSBVUkwsIGJ1dCBpdCBkb2VzIGhhdmUgYSB1aVNyZWYKICAgICAgICAgIC8vIGZpZ3VyZSBvdXQgaXRzIFVSTCBmcm9tIHRoZSB1aVNyZWYKICAgICAgICAgIGlmKCFkYXRhLnVybCAmJiBkYXRhLnVpU3JlZikgewogICAgICAgICAgICBkYXRhLnVybCA9ICRzdGF0ZS5ocmVmKGRhdGEudWlTcmVmKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZihkYXRhLnVybCkgewogICAgICAgICAgICAvLyBkb24ndCBsZXQgaXQgc3RhcnQgd2l0aCBhICMsIG1lc3NlcyB3aXRoICRsb2NhdGlvbi51cmwoKQogICAgICAgICAgICBpZihkYXRhLnVybC5pbmRleE9mKCcjJykgPT09IDApIHsKICAgICAgICAgICAgICBkYXRhLnVybCA9IGRhdGEudXJsLnJlcGxhY2UoJyMnLCAnJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYoZGF0YS51cmwgIT09ICRsb2NhdGlvbi51cmwoKSkgewogICAgICAgICAgICAgIC8vIHdlJ3ZlIGdvdCBhIGdvb2QgVVJMLCByZWFkeSBHTyEKICAgICAgICAgICAgICAkbG9jYXRpb24udXJsKGRhdGEudXJsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBTZXQgdGhlIGRvY3VtZW50IHRpdGxlIHdoZW4gYSBuZXcgdmlldyBpcyBzaG93bgogICAgICAgICRyb290U2NvcGUuJG9uKCd2aWV3U3RhdGUudmlld0VudGVyJywgZnVuY3Rpb24oZSwgZGF0YSkgewogICAgICAgICAgaWYoZGF0YSAmJiBkYXRhLnRpdGxlKSB7CiAgICAgICAgICAgICRkb2N1bWVudFswXS50aXRsZSA9IGRhdGEudGl0bGU7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8vIFRyaWdnZXJlZCB3aGVuIGRldmljZXMgd2l0aCBhIGhhcmR3YXJlIGJhY2sgYnV0dG9uIChBbmRyb2lkKSBpcyBjbGlja2VkIGJ5IHRoZSB1c2VyCiAgICAgICAgLy8gVGhpcyBpcyBhIENvcmRvdmEvUGhvbmVnYXAgcGxhdGZvcm0gc3BlY2lmYyBtZXRob2QKICAgICAgICBmdW5jdGlvbiBvbkhhcmR3YXJlQmFja0J1dHRvbihlKSB7CiAgICAgICAgICBpZigkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5iYWNrVmlldykgewogICAgICAgICAgICAvLyB0aGVyZSBpcyBhIGJhY2sgdmlldywgZ28gdG8gaXQKICAgICAgICAgICAgJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuYmFja1ZpZXcuZ28oKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIHRoZXJlIGlzIG5vIGJhY2sgdmlldywgc28gY2xvc2UgdGhlIGFwcCBpbnN0ZWFkCiAgICAgICAgICAgIGlvbmljLlBsYXRmb3JtLmV4aXRBcHAoKTsKICAgICAgICAgIH0KICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgJGlvbmljUGxhdGZvcm0ucmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uKAogICAgICAgICAgb25IYXJkd2FyZUJhY2tCdXR0b24sCiAgICAgICAgICBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9WSUVXCiAgICAgICAgKTsKCiAgICAgIH1dKQoKICAgIC5mYWN0b3J5KCckaW9uaWNWaWV3U2VydmljZScsIFsKICAgICAgJyRyb290U2NvcGUnLAogICAgICAnJHN0YXRlJywKICAgICAgJyRsb2NhdGlvbicsCiAgICAgICckd2luZG93JywKICAgICAgJyRpbmplY3RvcicsCiAgICAgICckYW5pbWF0ZScsCiAgICAgICckaW9uaWNOYXZWaWV3Q29uZmlnJywKICAgICAgZnVuY3Rpb24oJHJvb3RTY29wZSwgJHN0YXRlLCAkbG9jYXRpb24sICR3aW5kb3csICRpbmplY3RvciwgJGFuaW1hdGUsICRpb25pY05hdlZpZXdDb25maWcpIHsKCiAgICAgICAgdmFyIFZpZXcgPSBmdW5jdGlvbigpe307CiAgICAgICAgVmlldy5wcm90b3R5cGUuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgIGlmKGRhdGEpIHsKICAgICAgICAgICAgZm9yKHZhciBuYW1lIGluIGRhdGEpIHRoaXNbbmFtZV0gPSBkYXRhW25hbWVdOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgVmlldy5wcm90b3R5cGUuZ28gPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICBpZih0aGlzLnN0YXRlTmFtZSkgewogICAgICAgICAgICByZXR1cm4gJHN0YXRlLmdvKHRoaXMuc3RhdGVOYW1lLCB0aGlzLnN0YXRlUGFyYW1zKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZih0aGlzLnVybCAmJiB0aGlzLnVybCAhPT0gJGxvY2F0aW9uLnVybCgpKSB7CgogICAgICAgICAgICBpZigkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5iYWNrVmlldyA9PT0gdGhpcykgewogICAgICAgICAgICAgIHJldHVybiAkd2luZG93Lmhpc3RvcnkuZ28oLTEpOwogICAgICAgICAgICB9IGVsc2UgaWYoJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuZm9yd2FyZFZpZXcgPT09IHRoaXMpIHsKICAgICAgICAgICAgICByZXR1cm4gJHdpbmRvdy5oaXN0b3J5LmdvKDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkbG9jYXRpb24udXJsKHRoaXMudXJsKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgVmlldy5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYodGhpcy5zY29wZSkgewogICAgICAgICAgICB0aGlzLnNjb3BlLiRkZXN0cm95ICYmIHRoaXMuc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgdGhpcy5zY29wZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gY3JlYXRlVmlld0lkKHN0YXRlSWQpIHsKICAgICAgICAgIHJldHVybiBpb25pYy5VdGlscy5uZXh0VWlkKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewoKICAgICAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihjb250YWluZXJTY29wZSwgZWxlbWVudCkgewoKICAgICAgICAgICAgdmFyIHZpZXdIaXN0b3J5ID0gJHJvb3RTY29wZS4kdmlld0hpc3RvcnksCiAgICAgICAgICAgICAgY3VycmVudFN0YXRlSWQgPSB0aGlzLmdldEN1cnJlbnRTdGF0ZUlkKCksCiAgICAgICAgICAgICAgaGlzdCA9IHRoaXMuX2dldEhpc3RvcnkoY29udGFpbmVyU2NvcGUpLAogICAgICAgICAgICAgIGN1cnJlbnRWaWV3ID0gdmlld0hpc3RvcnkuY3VycmVudFZpZXcsCiAgICAgICAgICAgICAgYmFja1ZpZXcgPSB2aWV3SGlzdG9yeS5iYWNrVmlldywKICAgICAgICAgICAgICBmb3J3YXJkVmlldyA9IHZpZXdIaXN0b3J5LmZvcndhcmRWaWV3LAogICAgICAgICAgICAgIG5leHRWaWV3T3B0aW9ucyA9IHRoaXMubmV4dFZpZXdPcHRpb25zKCksCiAgICAgICAgICAgICAgcnNwID0gewogICAgICAgICAgICAgICAgdmlld0lkOiBudWxsLAogICAgICAgICAgICAgICAgbmF2QWN0aW9uOiBudWxsLAogICAgICAgICAgICAgICAgbmF2RGlyZWN0aW9uOiBudWxsLAogICAgICAgICAgICAgICAgaGlzdG9yeUlkOiBoaXN0Lmhpc3RvcnlJZAogICAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZihlbGVtZW50ICYmICF0aGlzLmlzVGFnTmFtZVJlZ2lzdHJhYmxlKGVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgLy8gZmlyc3QgY2hlY2sgdG8gc2VlIGlmIHRoaXMgZWxlbWVudCBjYW4gZXZlbiBiZSByZWdpc3RlcmVkIGFzIGEgdmlldy4KICAgICAgICAgICAgICAvLyBDZXJ0YWluIHRhZ3MgYXJlIG9ubHkgY29udGFpbmVycyBmb3Igdmlld3MsIGJ1dCBhcmUgbm90IHZpZXdzIHRoZW1zZWx2ZXMuCiAgICAgICAgICAgICAgLy8gRm9yIGV4YW1wbGUsIHRoZSA8aW9uLXRhYnM+IGRpcmVjdGl2ZSBjb250YWlucyBhIDxpb24tdGFiPiBhbmQgdGhlIDxpb24tdGFiPiBpcyB0aGUKICAgICAgICAgICAgICAvLyB2aWV3LCBidXQgdGhlIDxpb24tdGFicz4gZGlyZWN0aXZlIGl0c2VsZiBzaG91bGQgbm90IGJlIHJlZ2lzdGVyZWQgYXMgYSB2aWV3LgogICAgICAgICAgICAgIHJzcC5uYXZBY3Rpb24gPSAnZGlzYWJsZWRCeVRhZ05hbWUnOwogICAgICAgICAgICAgIHJldHVybiByc3A7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKGN1cnJlbnRWaWV3ICYmCiAgICAgICAgICAgICAgY3VycmVudFZpZXcuc3RhdGVJZCA9PT0gY3VycmVudFN0YXRlSWQgJiYKICAgICAgICAgICAgICBjdXJyZW50Vmlldy5oaXN0b3J5SWQgPT09IGhpc3QuaGlzdG9yeUlkKSB7CiAgICAgICAgICAgICAgLy8gZG8gbm90aGluZyBpZiBpdHMgdGhlIHNhbWUgc3RhdGVJZCBpbiB0aGUgc2FtZSBoaXN0b3J5CiAgICAgICAgICAgICAgcnNwLm5hdkFjdGlvbiA9ICdub0NoYW5nZSc7CiAgICAgICAgICAgICAgcmV0dXJuIHJzcDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYodmlld0hpc3RvcnkuZm9yY2VkTmF2KSB7CiAgICAgICAgICAgICAgLy8gd2UndmUgcHJldmlvdXNseSBzZXQgZXhhY3RseSB3aGF0IHRvIGRvCiAgICAgICAgICAgICAgaW9uaWMuVXRpbHMuZXh0ZW5kKHJzcCwgdmlld0hpc3RvcnkuZm9yY2VkTmF2KTsKICAgICAgICAgICAgICAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5mb3JjZWROYXYgPSBudWxsOwoKICAgICAgICAgICAgfSBlbHNlIGlmKGJhY2tWaWV3ICYmIGJhY2tWaWV3LnN0YXRlSWQgPT09IGN1cnJlbnRTdGF0ZUlkKSB7CiAgICAgICAgICAgICAgLy8gdGhleSB3ZW50IGJhY2sgb25lLCBzZXQgdGhlIG9sZCBjdXJyZW50IHZpZXcgYXMgYSBmb3J3YXJkIHZpZXcKICAgICAgICAgICAgICByc3Audmlld0lkID0gYmFja1ZpZXcudmlld0lkOwogICAgICAgICAgICAgIHJzcC5uYXZBY3Rpb24gPSAnbW92ZUJhY2snOwogICAgICAgICAgICAgIHJzcC52aWV3SWQgPSBiYWNrVmlldy52aWV3SWQ7CiAgICAgICAgICAgICAgaWYoYmFja1ZpZXcuaGlzdG9yeUlkID09PSBjdXJyZW50Vmlldy5oaXN0b3J5SWQpIHsKICAgICAgICAgICAgICAgIC8vIHdlbnQgYmFjayBpbiB0aGUgc2FtZSBoaXN0b3J5CiAgICAgICAgICAgICAgICByc3AubmF2RGlyZWN0aW9uID0gJ2JhY2snOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSBpZihmb3J3YXJkVmlldyAmJiBmb3J3YXJkVmlldy5zdGF0ZUlkID09PSBjdXJyZW50U3RhdGVJZCkgewogICAgICAgICAgICAgIC8vIHRoZXkgd2VudCB0byB0aGUgZm9yd2FyZCBvbmUsIHNldCB0aGUgZm9yd2FyZCB2aWV3IHRvIG5vIGxvbmdlciBhIGZvcndhcmQgdmlldwogICAgICAgICAgICAgIHJzcC52aWV3SWQgPSBmb3J3YXJkVmlldy52aWV3SWQ7CiAgICAgICAgICAgICAgcnNwLm5hdkFjdGlvbiA9ICdtb3ZlRm9yd2FyZCc7CiAgICAgICAgICAgICAgaWYoZm9yd2FyZFZpZXcuaGlzdG9yeUlkID09PSBjdXJyZW50Vmlldy5oaXN0b3J5SWQpIHsKICAgICAgICAgICAgICAgIHJzcC5uYXZEaXJlY3Rpb24gPSAnZm9yd2FyZCc7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB2YXIgcGFyZW50SGlzdG9yeSA9IHRoaXMuX2dldFBhcmVudEhpc3RvcnlPYmooY29udGFpbmVyU2NvcGUpOwogICAgICAgICAgICAgIGlmKGZvcndhcmRWaWV3Lmhpc3RvcnlJZCAmJiBwYXJlbnRIaXN0b3J5LnNjb3BlKSB7CiAgICAgICAgICAgICAgICAvLyBpZiBhIGhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBjcmVhdGVkIGJ5IHRoZSBmb3J3YXJkIHZpZXcgdGhlbiBtYWtlIHN1cmUgaXQgc3RheXMgdGhlIHNhbWUKICAgICAgICAgICAgICAgIHBhcmVudEhpc3Rvcnkuc2NvcGUuJGhpc3RvcnlJZCA9IGZvcndhcmRWaWV3Lmhpc3RvcnlJZDsKICAgICAgICAgICAgICAgIHJzcC5oaXN0b3J5SWQgPSBmb3J3YXJkVmlldy5oaXN0b3J5SWQ7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIGlmKGN1cnJlbnRWaWV3ICYmIGN1cnJlbnRWaWV3Lmhpc3RvcnlJZCAhPT0gaGlzdC5oaXN0b3J5SWQgJiYKICAgICAgICAgICAgICBoaXN0LmN1cnNvciA+IC0xICYmIGhpc3Quc3RhY2subGVuZ3RoID4gMCAmJiBoaXN0LmN1cnNvciA8IGhpc3Quc3RhY2subGVuZ3RoICYmCiAgICAgICAgICAgICAgaGlzdC5zdGFja1toaXN0LmN1cnNvcl0uc3RhdGVJZCA9PT0gY3VycmVudFN0YXRlSWQpIHsKICAgICAgICAgICAgICAvLyB0aGV5IGp1c3QgY2hhbmdlZCB0byBhIGRpZmZlcmVudCBoaXN0b3J5IGFuZCB0aGUgaGlzdG9yeSBhbHJlYWR5IGhhcyB2aWV3cyBpbiBpdAogICAgICAgICAgICAgIHJzcC52aWV3SWQgPSBoaXN0LnN0YWNrW2hpc3QuY3Vyc29yXS52aWV3SWQ7CiAgICAgICAgICAgICAgcnNwLm5hdkFjdGlvbiA9ICdtb3ZlQmFjayc7CgogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAvLyBzZXQgYSBuZXcgdW5pcXVlIHZpZXdJZAogICAgICAgICAgICAgIHJzcC52aWV3SWQgPSBjcmVhdGVWaWV3SWQoY3VycmVudFN0YXRlSWQpOwoKICAgICAgICAgICAgICBpZihjdXJyZW50VmlldykgewogICAgICAgICAgICAgICAgLy8gc2V0IHRoZSBmb3J3YXJkIHZpZXcgaWYgdGhlcmUgaXMgYSBjdXJyZW50IHZpZXcgKGllOiBpZiBpdHMgbm90IHRoZSBmaXJzdCB2aWV3KQogICAgICAgICAgICAgICAgY3VycmVudFZpZXcuZm9yd2FyZFZpZXdJZCA9IHJzcC52aWV3SWQ7CgogICAgICAgICAgICAgICAgLy8gaXRzIG9ubHkgbW92aW5nIGZvcndhcmQgaWYgaXRzIGluIHRoZSBzYW1lIGhpc3RvcnkKICAgICAgICAgICAgICAgIGlmKGhpc3QuaGlzdG9yeUlkID09PSBjdXJyZW50Vmlldy5oaXN0b3J5SWQpIHsKICAgICAgICAgICAgICAgICAgcnNwLm5hdkRpcmVjdGlvbiA9ICdmb3J3YXJkJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJzcC5uYXZBY3Rpb24gPSAnbmV3Vmlldyc7CgogICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgYSBuZXcgZm9yd2FyZCB2aWV3CiAgICAgICAgICAgICAgICBpZihmb3J3YXJkVmlldyAmJiBjdXJyZW50Vmlldy5zdGF0ZUlkICE9PSBmb3J3YXJkVmlldy5zdGF0ZUlkKSB7CiAgICAgICAgICAgICAgICAgIC8vIHRoZXkgbmF2aWdhdGVkIHRvIGEgbmV3IHZpZXcgYnV0IHRoZSBzdGFjayBhbHJlYWR5IGhhcyBhIGZvcndhcmQgdmlldwogICAgICAgICAgICAgICAgICAvLyBzaW5jZSBpdHMgYSBuZXcgdmlldyByZW1vdmUgYW55IGZvcndhcmRzIHRoYXQgZXhpc3RlZAogICAgICAgICAgICAgICAgICB2YXIgZm9yd2FyZHNIaXN0b3J5ID0gdGhpcy5fZ2V0SGlzdG9yeUJ5SWQoZm9yd2FyZFZpZXcuaGlzdG9yeUlkKTsKICAgICAgICAgICAgICAgICAgaWYoZm9yd2FyZHNIaXN0b3J5KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhlIGZvcndhcmQgaGFzIGEgaGlzdG9yeQogICAgICAgICAgICAgICAgICAgIGZvcih2YXIgeD1mb3J3YXJkc0hpc3Rvcnkuc3RhY2subGVuZ3RoIC0gMTsgeCA+PSBmb3J3YXJkVmlldy5pbmRleDsgeC0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBzdGFydGluZyBmcm9tIHRoZSBlbmQgZGVzdHJveSBhbGwgZm9yd2FyZHMgaW4gdGhpcyBoaXN0b3J5IGZyb20gdGhpcyBwb2ludAogICAgICAgICAgICAgICAgICAgICAgZm9yd2FyZHNIaXN0b3J5LnN0YWNrW3hdLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgIGZvcndhcmRzSGlzdG9yeS5zdGFjay5zcGxpY2UoeCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyB0aGVyZSdzIG5vIGN1cnJlbnQgdmlldywgc28gdGhpcyBtdXN0IGJlIHRoZSBpbml0aWFsIHZpZXcKICAgICAgICAgICAgICAgIHJzcC5uYXZBY3Rpb24gPSAnaW5pdGlhbFZpZXcnOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gYWRkIHRoZSBuZXcgdmlldwogICAgICAgICAgICAgIHZpZXdIaXN0b3J5LnZpZXdzW3JzcC52aWV3SWRdID0gdGhpcy5jcmVhdGVWaWV3KHsKICAgICAgICAgICAgICAgIHZpZXdJZDogcnNwLnZpZXdJZCwKICAgICAgICAgICAgICAgIGluZGV4OiBoaXN0LnN0YWNrLmxlbmd0aCwKICAgICAgICAgICAgICAgIGhpc3RvcnlJZDogaGlzdC5oaXN0b3J5SWQsCiAgICAgICAgICAgICAgICBiYWNrVmlld0lkOiAoY3VycmVudFZpZXcgJiYgY3VycmVudFZpZXcudmlld0lkID8gY3VycmVudFZpZXcudmlld0lkIDogbnVsbCksCiAgICAgICAgICAgICAgICBmb3J3YXJkVmlld0lkOiBudWxsLAogICAgICAgICAgICAgICAgc3RhdGVJZDogY3VycmVudFN0YXRlSWQsCiAgICAgICAgICAgICAgICBzdGF0ZU5hbWU6IHRoaXMuZ2V0Q3VycmVudFN0YXRlTmFtZSgpLAogICAgICAgICAgICAgICAgc3RhdGVQYXJhbXM6IHRoaXMuZ2V0Q3VycmVudFN0YXRlUGFyYW1zKCksCiAgICAgICAgICAgICAgICB1cmw6ICRsb2NhdGlvbi51cmwoKSwKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgaWYgKHJzcC5uYXZBY3Rpb24gPT0gJ21vdmVCYWNrJykgewogICAgICAgICAgICAgICAgLy9tb3ZlQmFjayhmcm9tLCB0byk7CiAgICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRlbWl0KCckdmlld0hpc3Rvcnkudmlld0JhY2snLCBjdXJyZW50Vmlldy52aWV3SWQsIHJzcC52aWV3SWQpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gYWRkIHRoZSBuZXcgdmlldyB0byB0aGlzIGhpc3RvcnkncyBzdGFjawogICAgICAgICAgICAgIGhpc3Quc3RhY2sucHVzaCh2aWV3SGlzdG9yeS52aWV3c1tyc3Audmlld0lkXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKG5leHRWaWV3T3B0aW9ucykgewogICAgICAgICAgICAgIGlmKG5leHRWaWV3T3B0aW9ucy5kaXNhYmxlQW5pbWF0ZSkgcnNwLm5hdkRpcmVjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgaWYobmV4dFZpZXdPcHRpb25zLmRpc2FibGVCYWNrKSB2aWV3SGlzdG9yeS52aWV3c1tyc3Audmlld0lkXS5iYWNrVmlld0lkID0gbnVsbDsKICAgICAgICAgICAgICB0aGlzLm5leHRWaWV3T3B0aW9ucyhudWxsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zZXROYXZWaWV3cyhyc3Audmlld0lkKTsKCiAgICAgICAgICAgIGhpc3QuY3Vyc29yID0gdmlld0hpc3RvcnkuY3VycmVudFZpZXcuaW5kZXg7CgogICAgICAgICAgICByZXR1cm4gcnNwOwogICAgICAgICAgfSwKCiAgICAgICAgICBzZXROYXZWaWV3czogZnVuY3Rpb24odmlld0lkKSB7CiAgICAgICAgICAgIHZhciB2aWV3SGlzdG9yeSA9ICRyb290U2NvcGUuJHZpZXdIaXN0b3J5OwoKICAgICAgICAgICAgdmlld0hpc3RvcnkuY3VycmVudFZpZXcgPSB0aGlzLl9nZXRWaWV3QnlJZCh2aWV3SWQpOwogICAgICAgICAgICB2aWV3SGlzdG9yeS5iYWNrVmlldyA9IHRoaXMuX2dldEJhY2tWaWV3KHZpZXdIaXN0b3J5LmN1cnJlbnRWaWV3KTsKICAgICAgICAgICAgdmlld0hpc3RvcnkuZm9yd2FyZFZpZXcgPSB0aGlzLl9nZXRGb3J3YXJkVmlldyh2aWV3SGlzdG9yeS5jdXJyZW50Vmlldyk7CgogICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyR2aWV3SGlzdG9yeS5oaXN0b3J5Q2hhbmdlJywgewogICAgICAgICAgICAgIHNob3dCYWNrOiAodmlld0hpc3RvcnkuYmFja1ZpZXcgJiYgdmlld0hpc3RvcnkuYmFja1ZpZXcuaGlzdG9yeUlkID09PSB2aWV3SGlzdG9yeS5jdXJyZW50Vmlldy5oaXN0b3J5SWQpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKCiAgICAgICAgICByZWdpc3Rlckhpc3Rvcnk6IGZ1bmN0aW9uKHNjb3BlKSB7CiAgICAgICAgICAgIHNjb3BlLiRoaXN0b3J5SWQgPSBpb25pYy5VdGlscy5uZXh0VWlkKCk7CiAgICAgICAgICB9LAoKICAgICAgICAgIGNyZWF0ZVZpZXc6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgdmFyIG5ld1ZpZXcgPSBuZXcgVmlldygpOwogICAgICAgICAgICByZXR1cm4gbmV3Vmlldy5pbml0aWFsaXplKGRhdGEpOwogICAgICAgICAgfSwKCiAgICAgICAgICBnZXRDdXJyZW50VmlldzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5jdXJyZW50VmlldzsKICAgICAgICAgIH0sCgogICAgICAgICAgZ2V0QmFja1ZpZXc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuYmFja1ZpZXc7CiAgICAgICAgICB9LAoKICAgICAgICAgIGdldEZvcndhcmRWaWV3OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmZvcndhcmRWaWV3OwogICAgICAgICAgfSwKCiAgICAgICAgICBnZXROYXZEaXJlY3Rpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkubmF2RGlyZWN0aW9uOwogICAgICAgICAgfSwKCiAgICAgICAgICBnZXRDdXJyZW50U3RhdGVOYW1lOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICgkc3RhdGUgJiYgJHN0YXRlLmN1cnJlbnQgPyAkc3RhdGUuY3VycmVudC5uYW1lIDogbnVsbCk7CiAgICAgICAgICB9LAoKICAgICAgICAgIGlzQ3VycmVudFN0YXRlTmF2VmlldzogZnVuY3Rpb24obmF2VmlldykgewogICAgICAgICAgICByZXR1cm4gKCRzdGF0ZSAmJgogICAgICAgICAgICAgICRzdGF0ZS5jdXJyZW50ICYmCiAgICAgICAgICAgICAgJHN0YXRlLmN1cnJlbnQudmlld3MgJiYKICAgICAgICAgICAgICAkc3RhdGUuY3VycmVudC52aWV3c1tuYXZWaWV3XSA/IHRydWUgOiBmYWxzZSk7CiAgICAgICAgICB9LAoKICAgICAgICAgIGdldEN1cnJlbnRTdGF0ZVBhcmFtczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBydG47CiAgICAgICAgICAgIGlmICgkc3RhdGUgJiYgJHN0YXRlLnBhcmFtcykgewogICAgICAgICAgICAgIGZvcih2YXIga2V5IGluICRzdGF0ZS5wYXJhbXMpIHsKICAgICAgICAgICAgICAgIGlmKCRzdGF0ZS5wYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICBydG4gPSBydG4gfHwge307CiAgICAgICAgICAgICAgICAgIHJ0bltrZXldID0gJHN0YXRlLnBhcmFtc1trZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcnRuOwogICAgICAgICAgfSwKCiAgICAgICAgICBnZXRDdXJyZW50U3RhdGVJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBpZDsKICAgICAgICAgICAgaWYoJHN0YXRlICYmICRzdGF0ZS5jdXJyZW50ICYmICRzdGF0ZS5jdXJyZW50Lm5hbWUpIHsKICAgICAgICAgICAgICBpZCA9ICRzdGF0ZS5jdXJyZW50Lm5hbWU7CiAgICAgICAgICAgICAgaWYoJHN0YXRlLnBhcmFtcykgewogICAgICAgICAgICAgICAgZm9yKHZhciBrZXkgaW4gJHN0YXRlLnBhcmFtcykgewogICAgICAgICAgICAgICAgICBpZigkc3RhdGUucGFyYW1zLmhhc093blByb3BlcnR5KGtleSkgJiYgJHN0YXRlLnBhcmFtc1trZXldKSB7CiAgICAgICAgICAgICAgICAgICAgaWQgKz0gIl8iICsga2V5ICsgIj0iICsgJHN0YXRlLnBhcmFtc1trZXldOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBpZDsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBpZiBzb21ldGhpbmcgZ29lcyB3cm9uZyBtYWtlIHN1cmUgaXRzIGdvdCBhIHVuaXF1ZSBzdGF0ZUlkCiAgICAgICAgICAgIHJldHVybiBpb25pYy5VdGlscy5uZXh0VWlkKCk7CiAgICAgICAgICB9LAoKICAgICAgICAgIGdvVG9IaXN0b3J5Um9vdDogZnVuY3Rpb24oaGlzdG9yeUlkKSB7CiAgICAgICAgICAgIGlmKGhpc3RvcnlJZCkgewogICAgICAgICAgICAgIHZhciBoaXN0ID0gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuaGlzdG9yaWVzWyBoaXN0b3J5SWQgXTsKICAgICAgICAgICAgICBpZihoaXN0ICYmIGhpc3Quc3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZigkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5jdXJyZW50VmlldyAmJiAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5jdXJyZW50Vmlldy52aWV3SWQgPT09IGhpc3Quc3RhY2tbMF0udmlld0lkKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmZvcmNlZE5hdiA9IHsKICAgICAgICAgICAgICAgICAgdmlld0lkOiBoaXN0LnN0YWNrWzBdLnZpZXdJZCwKICAgICAgICAgICAgICAgICAgbmF2QWN0aW9uOiAnbW92ZUJhY2snLAogICAgICAgICAgICAgICAgICBuYXZEaXJlY3Rpb246ICdiYWNrJwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGhpc3Quc3RhY2tbMF0uZ28oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCgogICAgICAgICAgX2dldFZpZXdCeUlkOiBmdW5jdGlvbih2aWV3SWQpIHsKICAgICAgICAgICAgcmV0dXJuICh2aWV3SWQgPyAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS52aWV3c1sgdmlld0lkIF0gOiBudWxsICk7CiAgICAgICAgICB9LAoKICAgICAgICAgIF9nZXRCYWNrVmlldzogZnVuY3Rpb24odmlldykgewogICAgICAgICAgICByZXR1cm4gKHZpZXcgPyB0aGlzLl9nZXRWaWV3QnlJZCh2aWV3LmJhY2tWaWV3SWQpIDogbnVsbCApOwogICAgICAgICAgfSwKCiAgICAgICAgICBfZ2V0Rm9yd2FyZFZpZXc6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgcmV0dXJuICh2aWV3ID8gdGhpcy5fZ2V0Vmlld0J5SWQodmlldy5mb3J3YXJkVmlld0lkKSA6IG51bGwgKTsKICAgICAgICAgIH0sCgogICAgICAgICAgX2dldEhpc3RvcnlCeUlkOiBmdW5jdGlvbihoaXN0b3J5SWQpIHsKICAgICAgICAgICAgcmV0dXJuIChoaXN0b3J5SWQgPyAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5oaXN0b3JpZXNbIGhpc3RvcnlJZCBdIDogbnVsbCApOwogICAgICAgICAgfSwKCiAgICAgICAgICBfZ2V0SGlzdG9yeTogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgICAgdmFyIGhpc3RPYmogPSB0aGlzLl9nZXRQYXJlbnRIaXN0b3J5T2JqKHNjb3BlKTsKCiAgICAgICAgICAgIGlmKCAhJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuaGlzdG9yaWVzWyBoaXN0T2JqLmhpc3RvcnlJZCBdICkgewogICAgICAgICAgICAgIC8vIHRoaXMgaGlzdG9yeSBvYmplY3QgZXhpc3RzIGluIHBhcmVudCBzY29wZSwgYnV0IGRvZXNuJ3QKICAgICAgICAgICAgICAvLyBleGlzdCBpbiB0aGUgaGlzdG9yeSBkYXRhIHlldAogICAgICAgICAgICAgICRyb290U2NvcGUuJHZpZXdIaXN0b3J5Lmhpc3Rvcmllc1sgaGlzdE9iai5oaXN0b3J5SWQgXSA9IHsKICAgICAgICAgICAgICAgIGhpc3RvcnlJZDogaGlzdE9iai5oaXN0b3J5SWQsCiAgICAgICAgICAgICAgICBwYXJlbnRIaXN0b3J5SWQ6IHRoaXMuX2dldFBhcmVudEhpc3RvcnlPYmooaGlzdE9iai5zY29wZS4kcGFyZW50KS5oaXN0b3J5SWQsCiAgICAgICAgICAgICAgICBzdGFjazogW10sCiAgICAgICAgICAgICAgICBjdXJzb3I6IC0xCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuICRyb290U2NvcGUuJHZpZXdIaXN0b3J5Lmhpc3Rvcmllc1sgaGlzdE9iai5oaXN0b3J5SWQgXTsKICAgICAgICAgIH0sCgogICAgICAgICAgX2dldFBhcmVudEhpc3RvcnlPYmo6IGZ1bmN0aW9uKHNjb3BlKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRTY29wZSA9IHNjb3BlOwogICAgICAgICAgICB3aGlsZShwYXJlbnRTY29wZSkgewogICAgICAgICAgICAgIGlmKHBhcmVudFNjb3BlLmhhc093blByb3BlcnR5KCckaGlzdG9yeUlkJykpIHsKICAgICAgICAgICAgICAgIC8vIHRoaXMgcGFyZW50IHNjb3BlIGhhcyBhIGhpc3RvcnlJZAogICAgICAgICAgICAgICAgcmV0dXJuIHsgaGlzdG9yeUlkOiBwYXJlbnRTY29wZS4kaGlzdG9yeUlkLCBzY29wZTogcGFyZW50U2NvcGUgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gbm90aGluZyBmb3VuZCBrZWVwIGNsaW1iaW5nIHVwCiAgICAgICAgICAgICAgcGFyZW50U2NvcGUgPSBwYXJlbnRTY29wZS4kcGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIG5vIGhpc3RvcnkgZm9yIGZvciB0aGUgcGFyZW50LCB1c2UgdGhlIHJvb3QKICAgICAgICAgICAgcmV0dXJuIHsgaGlzdG9yeUlkOiAncm9vdCcsIHNjb3BlOiAkcm9vdFNjb3BlIH07CiAgICAgICAgICB9LAoKICAgICAgICAgIG5leHRWaWV3T3B0aW9uczogZnVuY3Rpb24ob3B0cykgewogICAgICAgICAgICBpZihhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdGhpcy5fbmV4dE9wdHMgPSBvcHRzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9uZXh0T3B0czsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKCiAgICAgICAgICBnZXRSZW5kZXJlcjogZnVuY3Rpb24obmF2Vmlld0VsZW1lbnQsIG5hdlZpZXdBdHRycywgbmF2Vmlld1Njb3BlKSB7CiAgICAgICAgICAgIHZhciBzZXJ2aWNlID0gdGhpczsKICAgICAgICAgICAgdmFyIHJlZ2lzdGVyRGF0YTsKICAgICAgICAgICAgdmFyIGRvQW5pbWF0aW9uOwoKICAgICAgICAgICAgLy8gY2xpbWIgdXAgdGhlIERPTSBhbmQgc2VlIHdoaWNoIGFuaW1hdGlvbiBjbGFzc25hbWUgdG8gdXNlLCBpZiBhbnkKICAgICAgICAgICAgdmFyIGFuaW1hdGlvbkNsYXNzID0gZ2V0UGFyZW50QW5pbWF0aW9uQ2xhc3MobmF2Vmlld0VsZW1lbnRbMF0pOwoKICAgICAgICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50QW5pbWF0aW9uQ2xhc3MoZWwpIHsKICAgICAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gJyc7CiAgICAgICAgICAgICAgd2hpbGUoIWNsYXNzTmFtZSAmJiBlbCkgewogICAgICAgICAgICAgICAgY2xhc3NOYW1lID0gZWwuZ2V0QXR0cmlidXRlKCdhbmltYXRpb24nKTsKICAgICAgICAgICAgICAgIGVsID0gZWwucGFyZW50RWxlbWVudDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIElmIHRoZXkgZG9uJ3QgaGF2ZSBhbiBhbmltYXRpb24gc2V0IGV4cGxpY2l0bHksIHVzZSB0aGUgdmFsdWUgaW4gdGhlIGNvbmZpZwogICAgICAgICAgICAgIGlmKCFjbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkaW9uaWNOYXZWaWV3Q29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gY2xhc3NOYW1lOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBzZXRBbmltYXRpb25DbGFzcygpIHsKICAgICAgICAgICAgICAvLyBhZGQgdGhlIGFuaW1hdGlvbiBDU1MgY2xhc3Mgd2UncmUgZ29ubmEgdXNlIHRvIHRyYW5zaXRpb24gYmV0d2VlbiB2aWV3cwogICAgICAgICAgICAgIGlmIChhbmltYXRpb25DbGFzcykgewogICAgICAgICAgICAgICAgbmF2Vmlld0VsZW1lbnRbMF0uY2xhc3NMaXN0LmFkZChhbmltYXRpb25DbGFzcyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZihyZWdpc3RlckRhdGEubmF2RGlyZWN0aW9uID09PSAnYmFjaycpIHsKICAgICAgICAgICAgICAgIC8vIGFuaW1hdGUgbGlrZSB3ZSdyZSBtb3ZpbmcgYmFja3dhcmQKICAgICAgICAgICAgICAgIG5hdlZpZXdFbGVtZW50WzBdLmNsYXNzTGlzdC5hZGQoJ3JldmVyc2UnKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gZGVmYXVsdHMgdG8gYW5pbWF0ZSBmb3J3YXJkCiAgICAgICAgICAgICAgICAvLyBtYWtlIHN1cmUgdGhlIHJldmVyc2UgY2xhc3MgaXNuJ3QgYWxyZWFkeSBhZGRlZAogICAgICAgICAgICAgICAgbmF2Vmlld0VsZW1lbnRbMF0uY2xhc3NMaXN0LnJlbW92ZSgncmV2ZXJzZScpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNob3VsZEFuaW1hdGUpIHsKCiAgICAgICAgICAgICAgcmV0dXJuIHsKCiAgICAgICAgICAgICAgICBlbnRlcjogZnVuY3Rpb24oZWxlbWVudCkgewoKICAgICAgICAgICAgICAgICAgaWYoZG9BbmltYXRpb24gJiYgc2hvdWxkQW5pbWF0ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIGVudGVyIHdpdGggYW4gYW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgc2V0QW5pbWF0aW9uQ2xhc3MoKTsKCiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbmctZW50ZXInKTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ2Rpc2FibGUtcG9pbnRlci1ldmVudHMnKTsKCiAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUuZW50ZXIoZWxlbWVudCwgbmF2Vmlld0VsZW1lbnQsIG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdkaXNhYmxlLXBvaW50ZXItZXZlbnRzJyk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYW5pbWF0aW9uQ2xhc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmF2Vmlld0VsZW1lbnRbMF0uY2xhc3NMaXN0LnJlbW92ZShhbmltYXRpb25DbGFzcyk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoIWRvQW5pbWF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdkaXNhYmxlLXBvaW50ZXItZXZlbnRzJyk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIC8vIG5vIGFuaW1hdGlvbgogICAgICAgICAgICAgICAgICBuYXZWaWV3RWxlbWVudC5hcHBlbmQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGxlYXZlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBuYXZWaWV3RWxlbWVudC5jb250ZW50cygpOwoKICAgICAgICAgICAgICAgICAgaWYoZG9BbmltYXRpb24gJiYgc2hvdWxkQW5pbWF0ZSkgewogICAgICAgICAgICAgICAgICAgIC8vIGxlYXZlIHdpdGggYW4gYW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgICAgc2V0QW5pbWF0aW9uQ2xhc3MoKTsKCiAgICAgICAgICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoZWxlbWVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgLy8gbm8gYW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgIC8vIHJlZ2lzdGVyIGEgbmV3IHZpZXcKICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJEYXRhID0gc2VydmljZS5yZWdpc3RlcihuYXZWaWV3U2NvcGUsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBkb0FuaW1hdGlvbiA9IChhbmltYXRpb25DbGFzcyAhPT0gbnVsbCAmJiByZWdpc3RlckRhdGEubmF2RGlyZWN0aW9uICE9PSBudWxsKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyRGF0YTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0sCgogICAgICAgICAgZGlzYWJsZVJlZ2lzdGVyQnlUYWdOYW1lOiBmdW5jdGlvbih0YWdOYW1lKSB7CiAgICAgICAgICAgIC8vIG5vdCBldmVyeSBlbGVtZW50IHNob3VsZCBhbmltYXRlIGJldHdlZSB0cmFuc2l0aW9ucwogICAgICAgICAgICAvLyBGb3IgZXhhbXBsZSwgdGhlIDxpb24tdGFicz4gZGlyZWN0aXZlIHNob3VsZCBub3QgYW5pbWF0ZSB3aGVuIGl0IGVudGVycywKICAgICAgICAgICAgLy8gYnV0IGluc3RlYWQgdGhlIDxpb24tdGFicz4gZGlyZWN0dmUgd291bGQganVzdCBzaG93LCBhbmQgaXRzIGNoaWxkcmVuCiAgICAgICAgICAgIC8vIDxpb24tdGFiPiBkaXJlY3RpdmVzIHdvdWxkIGRvIHRoZSBhbmltYXRpbmcsIGJ1dCA8aW9uLXRhYnM+IGl0c2VsZiBpcyBub3QgYSB2aWV3CiAgICAgICAgICAgICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmRpc2FibGVkUmVnaXN0cmFibGVUYWdOYW1lcy5wdXNoKHRhZ05hbWUudG9VcHBlckNhc2UoKSk7CiAgICAgICAgICB9LAoKICAgICAgICAgIGlzVGFnTmFtZVJlZ2lzdHJhYmxlOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHRoaXMgZWxlbWVudCBoYXMgYSB0YWdOYW1lIChhdCBpdHMgcm9vdCwgbm90IHJlY3Vyc2l2ZWx5KQogICAgICAgICAgICAvLyB0aGF0IHNob3VsZG4ndCBiZSBhbmltYXRlZCwgbGlrZSA8aW9uLXRhYnM+IG9yIDxpb24tc2lkZS1tZW51PgogICAgICAgICAgICB2YXIgeCwgeSwgZGlzYWJsZWRUYWdzID0gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuZGlzYWJsZWRSZWdpc3RyYWJsZVRhZ05hbWVzOwogICAgICAgICAgICBmb3IoeD0wOyB4PGVsZW1lbnQubGVuZ3RoOyB4KyspIHsKICAgICAgICAgICAgICBpZihlbGVtZW50W3hdLm5vZGVUeXBlICE9PSAxKSBjb250aW51ZTsKICAgICAgICAgICAgICBmb3IoeT0wOyB5PGRpc2FibGVkVGFncy5sZW5ndGg7IHkrKykgewogICAgICAgICAgICAgICAgaWYoZWxlbWVudFt4XS50YWdOYW1lID09PSBkaXNhYmxlZFRhZ3NbeV0pIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0sCgogICAgICAgICAgY2xlYXJIaXN0b3J5OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyCiAgICAgICAgICAgICAgaGlzdG9yaWVzID0gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuaGlzdG9yaWVzLAogICAgICAgICAgICAgIGN1cnJlbnRWaWV3ID0gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuY3VycmVudFZpZXc7CgogICAgICAgICAgICBpZihoaXN0b3JpZXMpIHsKICAgICAgICAgICAgICBmb3IodmFyIGhpc3RvcnlJZCBpbiBoaXN0b3JpZXMpIHsKCiAgICAgICAgICAgICAgICBpZihoaXN0b3JpZXNbaGlzdG9yeUlkXS5zdGFjaykgewogICAgICAgICAgICAgICAgICBoaXN0b3JpZXNbaGlzdG9yeUlkXS5zdGFjayA9IFtdOwogICAgICAgICAgICAgICAgICBoaXN0b3JpZXNbaGlzdG9yeUlkXS5jdXJzb3IgPSAtMTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZihjdXJyZW50VmlldyAmJiBjdXJyZW50Vmlldy5oaXN0b3J5SWQgPT09IGhpc3RvcnlJZCkgewogICAgICAgICAgICAgICAgICBjdXJyZW50Vmlldy5iYWNrVmlld0lkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgY3VycmVudFZpZXcuZm9yd2FyZFZpZXdJZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGhpc3Rvcmllc1toaXN0b3J5SWRdLnN0YWNrLnB1c2goY3VycmVudFZpZXcpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmKGhpc3Rvcmllc1toaXN0b3J5SWRdLmRlc3Ryb3kpIHsKICAgICAgICAgICAgICAgICAgaGlzdG9yaWVzW2hpc3RvcnlJZF0uZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvcih2YXIgdmlld0lkIGluICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LnZpZXdzKSB7CiAgICAgICAgICAgICAgaWYodmlld0lkICE9PSBjdXJyZW50Vmlldy52aWV3SWQpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS52aWV3c1t2aWV3SWRdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoY3VycmVudFZpZXcpIHsKICAgICAgICAgICAgICB0aGlzLnNldE5hdlZpZXdzKGN1cnJlbnRWaWV3LnZpZXdJZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgfTsKCiAgICAgIH1dKTsKCiAgLyoqCiAgICogQHByaXZhdGUKICAgKi8KICBJb25pY01vZHVsZS5jb25maWcoWwogICAgJyRwcm92aWRlJywKICAgIGZ1bmN0aW9uKCRwcm92aWRlKSB7CiAgICAgIGZ1bmN0aW9uICRMb2NhdGlvbkRlY29yYXRvcigkbG9jYXRpb24sICR0aW1lb3V0KSB7CgogICAgICAgICRsb2NhdGlvbi5fX2hhc2ggPSAkbG9jYXRpb24uaGFzaDsKICAgICAgICAvL0ZpeDogd2hlbiB3aW5kb3cubG9jYXRpb24uaGFzaCBpcyBzZXQsIHRoZSBzY3JvbGxhYmxlIGFyZWEKICAgICAgICAvL2ZvdW5kIG5lYXJlc3QgdG8gYm9keSdzIHNjcm9sbFRvcCBpcyBzZXQgdG8gc2Nyb2xsIHRvIGFuIGVsZW1lbnQKICAgICAgICAvL3dpdGggdGhhdCBJRC4KICAgICAgICAkbG9jYXRpb24uaGFzaCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBzY3JvbGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2Nyb2xsLWNvbnRlbnQnKTsKICAgICAgICAgICAgICBpZiAoc2Nyb2xsKQogICAgICAgICAgICAgICAgc2Nyb2xsLnNjcm9sbFRvcCA9IDA7CiAgICAgICAgICAgIH0sIDAsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAkbG9jYXRpb24uX19oYXNoKHZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gJGxvY2F0aW9uOwogICAgICB9CgogICAgICAkcHJvdmlkZS5kZWNvcmF0b3IoJyRsb2NhdGlvbicsIFsnJGRlbGVnYXRlJywgJyR0aW1lb3V0JywgJExvY2F0aW9uRGVjb3JhdG9yXSk7CiAgICB9XSk7CgoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRpb25pY0xpc3REZWxlZ2F0ZQogICAqIEBtb2R1bGUgaW9uaWMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERlbGVnYXRlIGZvciBjb250cm9sbGluZyB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25MaXN0fSBkaXJlY3RpdmUuCiAgICoKICAgKiBNZXRob2RzIGNhbGxlZCBkaXJlY3RseSBvbiB0aGUgJGlvbmljTGlzdERlbGVnYXRlIHNlcnZpY2Ugd2lsbCBjb250cm9sIGFsbCBsaXN0cy4KICAgKiBVc2UgdGhlIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY0xpc3REZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUgJGdldEJ5SGFuZGxlfQogICAqIG1ldGhvZCB0byBjb250cm9sIHNwZWNpZmljIGlvbkxpc3QgaW5zdGFuY2VzLgogICAqCiAgICogQHVzYWdlCiAgICoKICAgKiBgYGBgaHRtbAogICAqIDxpb24tY29udGVudCBuZy1jb250cm9sbGVyPSJNeUN0cmwiPgogICAqICAgPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIiBuZy1jbGljaz0ic2hvd0RlbGV0ZUJ1dHRvbnMoKSI+PC9idXR0b24+CiAgICogICA8aW9uLWxpc3Q+CiAgICogICAgIDxpb24taXRlbSBuZy1yZXBlYXQ9ImkgaW4gaXRlbXMiPj4KICAgKiAgICAgICB7JSByYXcgJX1IZWxsbywge3tpfX0heyUgZW5kcmF3ICV9CiAgICogICAgICAgPGlvbi1kZWxldGUtYnV0dG9uIGNsYXNzPSJpb24tbWludXMtY2lyY2xlZCI+PC9pb24tZGVsZXRlLWJ1dHRvbj4KICAgKiAgICAgPC9pb24taXRlbT4KICAgKiAgIDwvaW9uLWxpc3Q+CiAgICogPC9pb24tY29udGVudD4KICAgKiBgYGAKICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIE15Q3RybCgkc2NvcGUsICRpb25pY0xpc3REZWxlZ2F0ZSkgewogKiAgICRzY29wZS5zaG93RGVsZXRlQnV0dG9ucyA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljTGlzdERlbGVnYXRlLnNob3dEZWxldGUodHJ1ZSk7CiAqICAgfTsKICogfQogICAqIGBgYAogICAqLwogIElvbmljTW9kdWxlCiAgICAuc2VydmljZSgnJGlvbmljTGlzdERlbGVnYXRlJywgZGVsZWdhdGVTZXJ2aWNlKFsKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTGlzdERlbGVnYXRlI3Nob3dSZW9yZGVyCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93UmVvcmRlciBTZXQgd2hldGhlciBvciBub3QgdGhpcyBsaXN0IGlzIHNob3dpbmcgaXRzIHJlb3JkZXIgYnV0dG9ucy4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSByZW9yZGVyIGJ1dHRvbnMgYXJlIHNob3duLgogICAgICovCiAgICAgICdzaG93UmVvcmRlcicsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY0xpc3REZWxlZ2F0ZSNzaG93RGVsZXRlCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93UmVvcmRlciBTZXQgd2hldGhlciBvciBub3QgdGhpcyBsaXN0IGlzIHNob3dpbmcgaXRzIGRlbGV0ZSBidXR0b25zLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGRlbGV0ZSBidXR0b25zIGFyZSBzaG93bi4KICAgICAqLwogICAgICAnc2hvd0RlbGV0ZScsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY0xpc3REZWxlZ2F0ZSNjYW5Td2lwZUl0ZW1zCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93UmVvcmRlciBTZXQgd2hldGhlciBvciBub3QgdGhpcyBsaXN0IGlzIGFibGUgdG8gc3dpcGUgdG8gc2hvdwogICAgICogb3B0aW9uIGJ1dHRvbnMuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgbGlzdCBpcyBhYmxlIHRvIHN3aXBlIHRvIHNob3cgb3B0aW9uIGJ1dHRvbnMuCiAgICAgKi8KICAgICAgJ2NhblN3aXBlSXRlbXMnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNMaXN0RGVsZWdhdGUjY2xvc2VPcHRpb25CdXR0b25zCiAgICAgKiBAZGVzY3JpcHRpb24gQ2xvc2VzIGFueSBvcHRpb24gYnV0dG9ucyBvbiB0aGUgbGlzdCB0aGF0IGFyZSBzd2lwZWQgb3Blbi4KICAgICAqLwogICAgICAnY2xvc2VPcHRpb25CdXR0b25zJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTGlzdERlbGVnYXRlIyRnZXRCeUhhbmRsZQogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhbmRsZQogICAgICogQHJldHVybnMgYGRlbGVnYXRlSW5zdGFuY2VgIEEgZGVsZWdhdGUgaW5zdGFuY2UgdGhhdCBjb250cm9scyBvbmx5IHRoZQogICAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25MaXN0fSBkaXJlY3RpdmVzIHdpdGggYGRlbGVnYXRlLWhhbmRsZWAgbWF0Y2hpbmcKICAgICAqIHRoZSBnaXZlbiBoYW5kbGUuCiAgICAgKgogICAgICogRXhhbXBsZTogYCRpb25pY0xpc3REZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ215LWhhbmRsZScpLnNob3dSZW9yZGVyKHRydWUpO2AKICAgICAqLwogICAgXSkpCgogICAgLmNvbnRyb2xsZXIoJyRpb25pY0xpc3QnLCBbCiAgICAgICckc2NvcGUnLAogICAgICAnJGF0dHJzJywKICAgICAgJyRwYXJzZScsCiAgICAgICckaW9uaWNMaXN0RGVsZWdhdGUnLAogICAgICBmdW5jdGlvbigkc2NvcGUsICRhdHRycywgJHBhcnNlLCAkaW9uaWNMaXN0RGVsZWdhdGUpIHsKCiAgICAgICAgdmFyIGlzU3dpcGVhYmxlID0gdHJ1ZTsKICAgICAgICB2YXIgaXNSZW9yZGVyU2hvd24gPSBmYWxzZTsKICAgICAgICB2YXIgaXNEZWxldGVTaG93biA9IGZhbHNlOwoKICAgICAgICB2YXIgZGVyZWdpc3Rlckluc3RhbmNlID0gJGlvbmljTGlzdERlbGVnYXRlLl9yZWdpc3Rlckluc3RhbmNlKHRoaXMsICRhdHRycy5kZWxlZ2F0ZUhhbmRsZSk7CiAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBkZXJlZ2lzdGVySW5zdGFuY2UpOwoKICAgICAgICB0aGlzLnNob3dSZW9yZGVyID0gZnVuY3Rpb24oc2hvdykgewogICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXNSZW9yZGVyU2hvd24gPSAhIXNob3c7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaXNSZW9yZGVyU2hvd247CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5zaG93RGVsZXRlID0gZnVuY3Rpb24oc2hvdykgewogICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXNEZWxldGVTaG93biA9ICEhc2hvdzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpc0RlbGV0ZVNob3duOwogICAgICAgIH07CgogICAgICAgIHRoaXMuY2FuU3dpcGVJdGVtcyA9IGZ1bmN0aW9uKGNhbikgewogICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXNTd2lwZWFibGUgPSAhIWNhbjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpc1N3aXBlYWJsZTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmNsb3NlT3B0aW9uQnV0dG9ucyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5saXN0VmlldyAmJiB0aGlzLmxpc3RWaWV3LmNsZWFyRHJhZ0VmZmVjdHMoKTsKICAgICAgICB9OwogICAgICB9XSk7CgogIElvbmljTW9kdWxlCiAgICAuY29udHJvbGxlcignJGlvbmljTmF2QmFyJywgWwogICAgICAnJHNjb3BlJywKICAgICAgJyRlbGVtZW50JywKICAgICAgJyRhdHRycycsCiAgICAgICckaW9uaWNWaWV3U2VydmljZScsCiAgICAgICckYW5pbWF0ZScsCiAgICAgICckY29tcGlsZScsCiAgICAgICckaW9uaWNOYXZCYXJEZWxlZ2F0ZScsCiAgICAgIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgJGlvbmljVmlld1NlcnZpY2UsICRhbmltYXRlLCAkY29tcGlsZSwgJGlvbmljTmF2QmFyRGVsZWdhdGUpIHsKICAgICAgICAvL0xldCB0aGUgcGFyZW50IGtub3cgYWJvdXQgb3VyIGNvbnRyb2xsZXIgdG9vIHNvIHRoYXQgY2hpbGRyZW4gb2YKICAgICAgICAvL3NpYmxpbmcgY29udGVudCBlbGVtZW50cyBjYW4ga25vdyBhYm91dCB1cwogICAgICAgICRlbGVtZW50LnBhcmVudCgpLmRhdGEoJyRpb25OYXZCYXJDb250cm9sbGVyJywgdGhpcyk7CgogICAgICAgIHZhciBkZXJlZ2lzdGVySW5zdGFuY2UgPSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZS5fcmVnaXN0ZXJJbnN0YW5jZSh0aGlzLCAkYXR0cnMuZGVsZWdhdGVIYW5kbGUpOwoKICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGRlcmVnaXN0ZXJJbnN0YW5jZSk7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgdGhpcy5sZWZ0QnV0dG9uc0VsZW1lbnQgPSBqcUxpdGUoCiAgICAgICAgICAkZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yKCcuYnV0dG9ucy5sZWZ0LWJ1dHRvbnMnKQogICAgICAgICk7CiAgICAgICAgdGhpcy5yaWdodEJ1dHRvbnNFbGVtZW50ID0ganFMaXRlKAogICAgICAgICAgJGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignLmJ1dHRvbnMucmlnaHQtYnV0dG9ucycpCiAgICAgICAgKTsKCiAgICAgICAgdGhpcy5iYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgYmFja1ZpZXcgPSAkaW9uaWNWaWV3U2VydmljZS5nZXRCYWNrVmlldygpOwogICAgICAgICAgYmFja1ZpZXcgJiYgYmFja1ZpZXcuZ28oKTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmFsaWduID0gZnVuY3Rpb24oZGlyZWN0aW9uKSB7CiAgICAgICAgICB0aGlzLl9oZWFkZXJCYXJWaWV3LmFsaWduKGRpcmVjdGlvbik7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5zaG93QmFja0J1dHRvbiA9IGZ1bmN0aW9uKHNob3cpIHsKICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICRzY29wZS5iYWNrQnV0dG9uU2hvd24gPSAhIXNob3c7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gISEoJHNjb3BlLmhhc0JhY2tCdXR0b24gJiYgJHNjb3BlLmJhY2tCdXR0b25TaG93bik7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5zaG93QmFyID0gZnVuY3Rpb24oc2hvdykgewogICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgJHNjb3BlLmlzSW52aXNpYmxlID0gIXNob3c7CiAgICAgICAgICAgICRzY29wZS4kcGFyZW50LiRoYXNIZWFkZXIgPSAhIXNob3c7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gISRzY29wZS5pc0ludmlzaWJsZTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnNldFRpdGxlID0gZnVuY3Rpb24odGl0bGUpIHsKICAgICAgICAgIGlmICgkc2NvcGUudGl0bGUgPT09IHRpdGxlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgICRzY29wZS5vbGRUaXRsZSA9ICRzY29wZS50aXRsZTsKICAgICAgICAgICRzY29wZS50aXRsZSA9IHRpdGxlIHx8ICcnOwogICAgICAgIH07CgogICAgICAgIHRoaXMuY2hhbmdlVGl0bGUgPSBmdW5jdGlvbih0aXRsZSwgZGlyZWN0aW9uKSB7CiAgICAgICAgICBpZiAoJHNjb3BlLnRpdGxlID09PSB0aXRsZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnNldFRpdGxlKHRpdGxlKTsKICAgICAgICAgICRzY29wZS5pc1JldmVyc2UgPSBkaXJlY3Rpb24gPT0gJ2JhY2snOwogICAgICAgICAgJHNjb3BlLnNob3VsZEFuaW1hdGUgPSAhIWRpcmVjdGlvbjsKCiAgICAgICAgICBpZiAoISRzY29wZS5zaG91bGRBbmltYXRlKSB7CiAgICAgICAgICAgIC8vV2UncmUgZG9uZSEKICAgICAgICAgICAgdGhpcy5faGVhZGVyQmFyVmlldy5hbGlnbigpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fYW5pbWF0ZVRpdGxlcygpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5nZXRUaXRsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuICRzY29wZS50aXRsZSB8fCAnJzsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmdldFByZXZpb3VzVGl0bGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiAkc2NvcGUub2xkVGl0bGUgfHwgJyc7CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogRXhwb3NlZCBmb3IgdGVzdGluZwogICAgICAgICAqLwogICAgICAgIHRoaXMuX2FuaW1hdGVUaXRsZXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBvbGRUaXRsZUVsLCBuZXdUaXRsZUVsLCBjdXJyZW50VGl0bGVzOwoKICAgICAgICAgIC8vSWYgd2UgaGF2ZSBhbnkgdGl0bGUgcmlnaHQgbm93CiAgICAgICAgICAvLyhvciBtb3JlIHRoYW4gb25lLCB0aGV5IGNvdWxkIGJlIHRyYW5zaXRpb25pbmcgb24gc3dpdGNoKSwKICAgICAgICAgIC8vcmVwbGFjZSB0aGUgZmlyc3Qgb25lIHdpdGggYW4gb2xkVGl0bGUgZWxlbWVudAogICAgICAgICAgY3VycmVudFRpdGxlcyA9ICRlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3JBbGwoJy50aXRsZScpOwogICAgICAgICAgaWYgKGN1cnJlbnRUaXRsZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIG9sZFRpdGxlRWwgPSAkY29tcGlsZSgnPGgxIGNsYXNzPSJ0aXRsZSIgbmctYmluZC1odG1sPSJvbGRUaXRsZSI+PC9oMT4nKSgkc2NvcGUpOwogICAgICAgICAgICBqcUxpdGUoY3VycmVudFRpdGxlc1swXSkucmVwbGFjZVdpdGgob2xkVGl0bGVFbCk7CiAgICAgICAgICB9CiAgICAgICAgICAvL0NvbXBpbGUgbmV3IHRpdGxlCiAgICAgICAgICBuZXdUaXRsZUVsID0gJGNvbXBpbGUoJzxoMSBjbGFzcz0idGl0bGUgaW52aXNpYmxlIiBuZy1iaW5kLWh0bWw9InRpdGxlIj48L2gxPicpKCRzY29wZSk7CgogICAgICAgICAgLy9BbmltYXRlIGluIG9uIG5leHQgZnJhbWUKICAgICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIG9sZFRpdGxlRWwgJiYgJGFuaW1hdGUubGVhdmUoanFMaXRlKG9sZFRpdGxlRWwpKTsKCiAgICAgICAgICAgIHZhciBpbnNlcnQgPSBvbGRUaXRsZUVsICYmIGpxTGl0ZShvbGRUaXRsZUVsKSB8fCBudWxsOwogICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihuZXdUaXRsZUVsLCAkZWxlbWVudCwgaW5zZXJ0LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzZWxmLl9oZWFkZXJCYXJWaWV3LmFsaWduKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy9DbGVhbnVwIGFueSBvbGQgdGl0bGVzIGxlZnRvdmVyIChiZXNpZGVzIHRoZSBvbmUgd2UgYWxyZWFkeSBkaWQgcmVwbGFjZVdpdGggb24pCiAgICAgICAgICAgIGZvckVhY2goY3VycmVudFRpdGxlcywgZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgICBpZiAoZWwgJiYgZWwucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgLy9Vc2UgLnJlbW92ZSgpIHRvIGNsZWFudXAgdGhpbmdzIGxpa2UgLmRhdGEoKQogICAgICAgICAgICAgICAganFMaXRlKGVsKS5yZW1vdmUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8kYXBwbHkgc28gYmluZGluZ3MgZmlyZQogICAgICAgICAgICAkc2NvcGUuJGRpZ2VzdCgpOwoKICAgICAgICAgICAgLy9TdG9wIGZsaWNrZXIgb2YgbmV3IHRpdGxlIG9uIGlvczcKICAgICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIG5ld1RpdGxlRWxbMF0uY2xhc3NMaXN0LnJlbW92ZSgnaW52aXNpYmxlJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgfV0pOwoKCiAgLyoqCiAgICogQHByaXZhdGUKICAgKi8KICBJb25pY01vZHVsZQoKICAgIC5mYWN0b3J5KCckJHNjcm9sbFZhbHVlQ2FjaGUnLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHt9OwogICAgfSkKCiAgICAuY29udHJvbGxlcignJGlvbmljU2Nyb2xsJywgWwogICAgICAnJHNjb3BlJywKICAgICAgJ3Njcm9sbFZpZXdPcHRpb25zJywKICAgICAgJyR0aW1lb3V0JywKICAgICAgJyR3aW5kb3cnLAogICAgICAnJCRzY3JvbGxWYWx1ZUNhY2hlJywKICAgICAgJyRsb2NhdGlvbicsCiAgICAgICckcm9vdFNjb3BlJywKICAgICAgJyRkb2N1bWVudCcsCiAgICAgICckaW9uaWNTY3JvbGxEZWxlZ2F0ZScsCiAgICAgIGZ1bmN0aW9uKCRzY29wZSwgc2Nyb2xsVmlld09wdGlvbnMsICR0aW1lb3V0LCAkd2luZG93LCAkJHNjcm9sbFZhbHVlQ2FjaGUsICRsb2NhdGlvbiwgJHJvb3RTY29wZSwgJGRvY3VtZW50LCAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSkgewoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHRoaXMuX3Njcm9sbFZpZXdPcHRpb25zID0gc2Nyb2xsVmlld09wdGlvbnM7IC8vZm9yIHRlc3RpbmcKCiAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQgPSBzY3JvbGxWaWV3T3B0aW9ucy5lbDsKICAgICAgICB2YXIgJGVsZW1lbnQgPSB0aGlzLiRlbGVtZW50ID0ganFMaXRlKGVsZW1lbnQpOwogICAgICAgIHZhciBzY3JvbGxWaWV3ID0gdGhpcy5zY3JvbGxWaWV3ID0gbmV3IGlvbmljLnZpZXdzLlNjcm9sbChzY3JvbGxWaWV3T3B0aW9ucyk7CgogICAgICAgIC8vQXR0YWNoIHNlbGYgdG8gZWxlbWVudCBhcyBhIGNvbnRyb2xsZXIgc28gb3RoZXIgZGlyZWN0aXZlcyBjYW4gcmVxdWlyZSB0aGlzIGNvbnRyb2xsZXIKICAgICAgICAvL3Rocm91Z2ggYHJlcXVpcmU6ICckaW9uaWNTY3JvbGwnCiAgICAgICAgLy9BbHNvIGF0dGFjaCB0byBwYXJlbnQgc28gdGhhdCBzaWJsaW5nIGVsZW1lbnRzIGNhbiByZXF1aXJlIHRoaXMKICAgICAgICAoJGVsZW1lbnQucGFyZW50KCkubGVuZ3RoID8gJGVsZW1lbnQucGFyZW50KCkgOiAkZWxlbWVudCkKICAgICAgICAgIC5kYXRhKCckJGlvbmljU2Nyb2xsQ29udHJvbGxlcicsIHRoaXMpOwoKICAgICAgICB2YXIgZGVyZWdpc3Rlckluc3RhbmNlID0gJGlvbmljU2Nyb2xsRGVsZWdhdGUuX3JlZ2lzdGVySW5zdGFuY2UoCiAgICAgICAgICB0aGlzLCBzY3JvbGxWaWV3T3B0aW9ucy5kZWxlZ2F0ZUhhbmRsZQogICAgICAgICk7CgogICAgICAgIGlmICghYW5ndWxhci5pc0RlZmluZWQoc2Nyb2xsVmlld09wdGlvbnMuYm91bmNpbmcpKSB7CiAgICAgICAgICBpb25pYy5QbGF0Zm9ybS5yZWFkeShmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2Nyb2xsVmlldy5vcHRpb25zLmJvdW5jaW5nID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmKGlvbmljLlBsYXRmb3JtLmlzQW5kcm9pZCgpKSB7CiAgICAgICAgICAgICAgLy8gTm8gYm91bmNpbmcgYnkgZGVmYXVsdCBvbiBBbmRyb2lkCiAgICAgICAgICAgICAgc2Nyb2xsVmlldy5vcHRpb25zLmJvdW5jaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgLy8gRmFzdGVyIHNjcm9sbCBkZWNlbAogICAgICAgICAgICAgIHNjcm9sbFZpZXcub3B0aW9ucy5kZWNlbGVyYXRpb24gPSAwLjk1OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIHZhciByZXNpemUgPSBhbmd1bGFyLmJpbmQoc2Nyb2xsVmlldywgc2Nyb2xsVmlldy5yZXNpemUpOwogICAgICAgIGlvbmljLm9uKCdyZXNpemUnLCByZXNpemUsICR3aW5kb3cpOwoKICAgICAgICAvLyBzZXQgYnkgcm9vdFNjb3BlIGxpc3RlbmVyIGlmIG5lZWRlZAogICAgICAgIHZhciBiYWNrTGlzdGVuRG9uZSA9IGFuZ3VsYXIubm9vcDsKCiAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGRlcmVnaXN0ZXJJbnN0YW5jZSgpOwogICAgICAgICAgc2Nyb2xsVmlldy5fX3JlbW92ZUV2ZW50SGFuZGxlcnMoKTsKICAgICAgICAgIGlvbmljLm9mZigncmVzaXplJywgcmVzaXplLCAkd2luZG93KTsKICAgICAgICAgICR3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVzaXplJywgcmVzaXplKTsKICAgICAgICAgIGJhY2tMaXN0ZW5Eb25lKCk7CiAgICAgICAgICBpZiAoc2VsZi5fcmVtZW1iZXJTY3JvbGxJZCkgewogICAgICAgICAgICAkJHNjcm9sbFZhbHVlQ2FjaGVbc2VsZi5fcmVtZW1iZXJTY3JvbGxJZF0gPSBzY3JvbGxWaWV3LmdldFZhbHVlcygpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAkZWxlbWVudC5vbignc2Nyb2xsJywgZnVuY3Rpb24oZSkgewogICAgICAgICAgdmFyIGRldGFpbCA9IChlLm9yaWdpbmFsRXZlbnQgfHwgZSkuZGV0YWlsIHx8IHt9OwogICAgICAgICAgJHNjb3BlLiRvblNjcm9sbCAmJiAkc2NvcGUuJG9uU2Nyb2xsKHsKICAgICAgICAgICAgZXZlbnQ6IGUsCiAgICAgICAgICAgIHNjcm9sbFRvcDogZGV0YWlsLnNjcm9sbFRvcCB8fCAwLAogICAgICAgICAgICBzY3JvbGxMZWZ0OiBkZXRhaWwuc2Nyb2xsTGVmdCB8fCAwCiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgJHNjb3BlLiRvbignJHZpZXdDb250ZW50TG9hZGVkJywgZnVuY3Rpb24oZSwgaGlzdG9yeURhdGEpIHsKICAgICAgICAgIC8vb25seSB0aGUgdG9wLW1vc3Qgc2Nyb2xsIGFyZWEgdW5kZXIgYSB2aWV3IHNob3VsZCByZW1lbWJlciB0aGF0IHZpZXcncwogICAgICAgICAgLy9zY3JvbGwgcG9zaXRpb24KICAgICAgICAgIGlmIChlLmRlZmF1bHRQcmV2ZW50ZWQpIHsgcmV0dXJuOyB9CiAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgdmFyIHZpZXdJZCA9IGhpc3RvcnlEYXRhICYmIGhpc3RvcnlEYXRhLnZpZXdJZCB8fCAkc2NvcGUuJGhpc3RvcnlJZDsKICAgICAgICAgIGlmICh2aWV3SWQpIHsKICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgc2VsZi5yZW1lbWJlclNjcm9sbFBvc2l0aW9uKHZpZXdJZCk7CiAgICAgICAgICAgICAgc2VsZi5zY3JvbGxUb1JlbWVtYmVyZWRQb3NpdGlvbigpOwoKICAgICAgICAgICAgICBiYWNrTGlzdGVuRG9uZSA9ICRyb290U2NvcGUuJG9uKCckdmlld0hpc3Rvcnkudmlld0JhY2snLCBmdW5jdGlvbihlLCBmcm9tVmlld0lkLCB0b1ZpZXdJZCkgewogICAgICAgICAgICAgICAgLy9XaGVuIGdvaW5nIGJhY2sgZnJvbSB0aGlzIHZpZXcsIGZvcmdldCBpdHMgc2F2ZWQgc2Nyb2xsIHBvc2l0aW9uCiAgICAgICAgICAgICAgICBpZiAodmlld0lkID09PSBmcm9tVmlld0lkKSB7CiAgICAgICAgICAgICAgICAgIHNlbGYuZm9yZ2V0U2Nyb2xsUG9zaXRpb24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwgMCwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIHNjcm9sbFZpZXcucnVuKCk7CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuX3JlbWVtYmVyU2Nyb2xsSWQgPSBudWxsOwoKICAgICAgICB0aGlzLmdldFNjcm9sbFZpZXcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXc7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5nZXRTY3JvbGxQb3NpdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsVmlldy5nZXRWYWx1ZXMoKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnJlc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuICR0aW1lb3V0KHJlc2l6ZSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5zY3JvbGxUb3AgPSBmdW5jdGlvbihzaG91bGRBbmltYXRlKSB7CiAgICAgICAgICB0aGlzLnJlc2l6ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNjcm9sbFZpZXcuc2Nyb2xsVG8oMCwgMCwgISFzaG91bGRBbmltYXRlKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHRoaXMuc2Nyb2xsQm90dG9tID0gZnVuY3Rpb24oc2hvdWxkQW5pbWF0ZSkgewogICAgICAgICAgdGhpcy5yZXNpemUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbWF4ID0gc2Nyb2xsVmlldy5nZXRTY3JvbGxNYXgoKTsKICAgICAgICAgICAgc2Nyb2xsVmlldy5zY3JvbGxUbyhtYXgubGVmdCwgbWF4LnRvcCwgISFzaG91bGRBbmltYXRlKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHRoaXMuc2Nyb2xsVG8gPSBmdW5jdGlvbihsZWZ0LCB0b3AsIHNob3VsZEFuaW1hdGUpIHsKICAgICAgICAgIHRoaXMucmVzaXplKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2Nyb2xsVmlldy5zY3JvbGxUbyhsZWZ0LCB0b3AsICEhc2hvdWxkQW5pbWF0ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnNjcm9sbEJ5ID0gZnVuY3Rpb24obGVmdCwgdG9wLCBzaG91bGRBbmltYXRlKSB7CiAgICAgICAgICB0aGlzLnJlc2l6ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNjcm9sbFZpZXcuc2Nyb2xsQnkobGVmdCwgdG9wLCAhIXNob3VsZEFuaW1hdGUpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5hbmNob3JTY3JvbGwgPSBmdW5jdGlvbihzaG91bGRBbmltYXRlKSB7CiAgICAgICAgICB0aGlzLnJlc2l6ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBoYXNoID0gJGxvY2F0aW9uLmhhc2goKTsKICAgICAgICAgICAgdmFyIGVsbSA9IGhhc2ggJiYgJGRvY3VtZW50WzBdLmdldEVsZW1lbnRCeUlkKGhhc2gpOwogICAgICAgICAgICBpZiAoIShoYXNoICYmIGVsbSkpIHsKICAgICAgICAgICAgICBzY3JvbGxWaWV3LnNjcm9sbFRvKDAsMCwgISFzaG91bGRBbmltYXRlKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1ckVsbSA9IGVsbTsKICAgICAgICAgICAgdmFyIHNjcm9sbExlZnQgPSAwLCBzY3JvbGxUb3AgPSAwLCBsZXZlbHNDbGltYmVkID0gMDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGlmKGN1ckVsbSAhPT0gbnVsbClzY3JvbGxMZWZ0ICs9IGN1ckVsbS5vZmZzZXRMZWZ0OwogICAgICAgICAgICAgIGlmKGN1ckVsbSAhPT0gbnVsbClzY3JvbGxUb3AgKz0gY3VyRWxtLm9mZnNldFRvcDsKICAgICAgICAgICAgICBjdXJFbG0gPSBjdXJFbG0ub2Zmc2V0UGFyZW50OwogICAgICAgICAgICAgIGxldmVsc0NsaW1iZWQrKzsKICAgICAgICAgICAgfSB3aGlsZSAoY3VyRWxtLmF0dHJpYnV0ZXMgIT0gc2VsZi5lbGVtZW50LmF0dHJpYnV0ZXMgJiYgY3VyRWxtLm9mZnNldFBhcmVudCk7CiAgICAgICAgICAgIHNjcm9sbFZpZXcuc2Nyb2xsVG8oc2Nyb2xsTGVmdCwgc2Nyb2xsVG9wLCAhIXNob3VsZEFuaW1hdGUpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5yZW1lbWJlclNjcm9sbFBvc2l0aW9uID0gZnVuY3Rpb24oaWQpIHsKICAgICAgICAgIGlmICghaWQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNdXN0IHN1cHBseSBhbiBpZCB0byByZW1lbWJlciB0aGUgc2Nyb2xsIGJ5ISIpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5fcmVtZW1iZXJTY3JvbGxJZCA9IGlkOwogICAgICAgIH07CiAgICAgICAgdGhpcy5mb3JnZXRTY3JvbGxQb3NpdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgZGVsZXRlICQkc2Nyb2xsVmFsdWVDYWNoZVt0aGlzLl9yZW1lbWJlclNjcm9sbElkXTsKICAgICAgICAgIHRoaXMuX3JlbWVtYmVyU2Nyb2xsSWQgPSBudWxsOwogICAgICAgIH07CiAgICAgICAgdGhpcy5zY3JvbGxUb1JlbWVtYmVyZWRQb3NpdGlvbiA9IGZ1bmN0aW9uKHNob3VsZEFuaW1hdGUpIHsKICAgICAgICAgIHZhciB2YWx1ZXMgPSAkJHNjcm9sbFZhbHVlQ2FjaGVbdGhpcy5fcmVtZW1iZXJTY3JvbGxJZF07CiAgICAgICAgICBpZiAodmFsdWVzKSB7CiAgICAgICAgICAgIHRoaXMucmVzaXplKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzY3JvbGxWaWV3LnNjcm9sbFRvKCt2YWx1ZXMubGVmdCwgK3ZhbHVlcy50b3AsIHNob3VsZEFuaW1hdGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgIHRoaXMuX3NldFJlZnJlc2hlciA9IGZ1bmN0aW9uKHJlZnJlc2hlclNjb3BlLCByZWZyZXNoZXJFbGVtZW50KSB7CiAgICAgICAgICB2YXIgcmVmcmVzaGVyID0gdGhpcy5yZWZyZXNoZXIgPSByZWZyZXNoZXJFbGVtZW50OwogICAgICAgICAgdmFyIHJlZnJlc2hlckhlaWdodCA9IHNlbGYucmVmcmVzaGVyLmNsaWVudEhlaWdodCB8fCAwOwogICAgICAgICAgc2Nyb2xsVmlldy5hY3RpdmF0ZVB1bGxUb1JlZnJlc2gocmVmcmVzaGVySGVpZ2h0LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmVmcmVzaGVyLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICByZWZyZXNoZXJTY29wZS4kb25QdWxsaW5nKCk7CiAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmVmcmVzaGVyLmNsYXNzTGlzdC5yZW1vdmUoJ3JlZnJlc2hpbmcnKTsKICAgICAgICAgICAgcmVmcmVzaGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJlZnJlc2hlci5jbGFzc0xpc3QuYWRkKCdyZWZyZXNoaW5nJyk7CiAgICAgICAgICAgIHJlZnJlc2hlclNjb3BlLiRvblJlZnJlc2goKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgIH1dKTsKCgogIElvbmljTW9kdWxlCiAgICAuY29udHJvbGxlcignJGlvbmljU2lkZU1lbnVzJywgWwogICAgICAnJHNjb3BlJywKICAgICAgJyRhdHRycycsCiAgICAgICckaW9uaWNTaWRlTWVudURlbGVnYXRlJywKICAgICAgJyRpb25pY1BsYXRmb3JtJywKICAgICAgZnVuY3Rpb24oJHNjb3BlLCAkYXR0cnMsICRpb25pY1NpZGVNZW51RGVsZWdhdGUsICRpb25pY1BsYXRmb3JtKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIGV4dGVuZCh0aGlzLCBpb25pYy5jb250cm9sbGVycy5TaWRlTWVudUNvbnRyb2xsZXIucHJvdG90eXBlKTsKCiAgICAgICAgdGhpcy4kc2NvcGUgPSAkc2NvcGU7CgogICAgICAgIGlvbmljLmNvbnRyb2xsZXJzLlNpZGVNZW51Q29udHJvbGxlci5jYWxsKHRoaXMsIHsKICAgICAgICAgIGxlZnQ6IHsgd2lkdGg6IDI3NSB9LAogICAgICAgICAgcmlnaHQ6IHsgd2lkdGg6IDI3NSB9CiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuY2FuRHJhZ0NvbnRlbnQgPSBmdW5jdGlvbihjYW5EcmFnKSB7CiAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAkc2NvcGUuZHJhZ0NvbnRlbnQgPSAhIWNhbkRyYWc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gJHNjb3BlLmRyYWdDb250ZW50OwogICAgICAgIH07CgogICAgICAgIHRoaXMuZWRnZVRocmVzaG9sZCA9IDI1OwogICAgICAgIHRoaXMuZWRnZVRocmVzaG9sZEVuYWJsZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmVkZ2VEcmFnVGhyZXNob2xkID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgIGlmIChhbmd1bGFyLmlzTnVtYmVyKHZhbHVlKSAmJiB2YWx1ZSA+IDApIHsKICAgICAgICAgICAgICB0aGlzLmVkZ2VUaHJlc2hvbGQgPSB2YWx1ZTsKICAgICAgICAgICAgICB0aGlzLmVkZ2VUaHJlc2hvbGRFbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmVkZ2VUaHJlc2hvbGRFbmFibGVkID0gISF2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXMuZWRnZVRocmVzaG9sZEVuYWJsZWQ7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5pc0RyYWdnYWJsZVRhcmdldCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIC8vT25seSByZXN0cmljdCBlZGdlIHdoZW4gc2lkZW1lbnUgaXMgY2xvc2VkIGFuZCByZXN0cmljdGlvbiBpcyBlbmFibGVkCiAgICAgICAgICB2YXIgc2hvdWxkT25seUFsbG93RWRnZURyYWcgPSBzZWxmLmVkZ2VUaHJlc2hvbGRFbmFibGVkICYmICFzZWxmLmlzT3BlbigpOwogICAgICAgICAgdmFyIHN0YXJ0WCA9IGUuZ2VzdHVyZS5zdGFydEV2ZW50ICYmIGUuZ2VzdHVyZS5zdGFydEV2ZW50LmNlbnRlciAmJgogICAgICAgICAgICBlLmdlc3R1cmUuc3RhcnRFdmVudC5jZW50ZXIucGFnZVg7CgogICAgICAgICAgdmFyIGRyYWdJc1dpdGhpbkJvdW5kcyA9ICFzaG91bGRPbmx5QWxsb3dFZGdlRHJhZyB8fAogICAgICAgICAgICBzdGFydFggPD0gc2VsZi5lZGdlVGhyZXNob2xkIHx8CiAgICAgICAgICAgIHN0YXJ0WCA+PSBzZWxmLmNvbnRlbnQub2Zmc2V0V2lkdGggLSBzZWxmLmVkZ2VUaHJlc2hvbGQ7CgogICAgICAgICAgcmV0dXJuICgkc2NvcGUuZHJhZ0NvbnRlbnQgfHwgc2VsZi5pc09wZW4oKSkgJiYKICAgICAgICAgICAgZHJhZ0lzV2l0aGluQm91bmRzICYmCiAgICAgICAgICAgICFlLmdlc3R1cmUuc3JjRXZlbnQuZGVmYXVsdFByZXZlbnRlZCAmJgogICAgICAgICAgICAhZS50YXJnZXQudGFnTmFtZS5tYXRjaCgvaW5wdXR8dGV4dGFyZWF8c2VsZWN0fG9iamVjdHxlbWJlZC9pKSAmJgogICAgICAgICAgICAhZS50YXJnZXQuaXNDb250ZW50RWRpdGFibGUgJiYKICAgICAgICAgICAgIShlLnRhcmdldC5kYXRhc2V0ID8gZS50YXJnZXQuZGF0YXNldC5wcmV2ZW50U2Nyb2xsIDogZS50YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLXByZXZlbnQtZGVmYXVsdCcpID09ICd0cnVlJyk7CiAgICAgICAgfTsKCiAgICAgICAgJHNjb3BlLnNpZGVNZW51Q29udGVudFRyYW5zbGF0ZVggPSAwOwoKCiAgICAgICAgdmFyIGRlcmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uID0gYW5ndWxhci5ub29wOwogICAgICAgIHZhciBjbG9zZVNpZGVNZW51ID0gYW5ndWxhci5iaW5kKHRoaXMsIHRoaXMuY2xvc2UpOwogICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gc2VsZi5nZXRPcGVuQW1vdW50KCkgIT09IDA7CiAgICAgICAgfSwgZnVuY3Rpb24oaXNPcGVuKSB7CiAgICAgICAgICBkZXJlZ2lzdGVyQmFja0J1dHRvbkFjdGlvbigpOwogICAgICAgICAgaWYgKGlzT3BlbikgewogICAgICAgICAgICBkZXJlZ2lzdGVyQmFja0J1dHRvbkFjdGlvbiA9ICRpb25pY1BsYXRmb3JtLnJlZ2lzdGVyQmFja0J1dHRvbkFjdGlvbigKICAgICAgICAgICAgICBjbG9zZVNpZGVNZW51LAogICAgICAgICAgICAgIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX1NJREVfTUVOVQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB2YXIgZGVyZWdpc3Rlckluc3RhbmNlID0gJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZS5fcmVnaXN0ZXJJbnN0YW5jZSgKICAgICAgICAgIHRoaXMsICRhdHRycy5kZWxlZ2F0ZUhhbmRsZQogICAgICAgICk7CiAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGRlcmVnaXN0ZXJJbnN0YW5jZSgpOwogICAgICAgICAgZGVyZWdpc3RlckJhY2tCdXR0b25BY3Rpb24oKTsKICAgICAgICB9KTsKICAgICAgfV0pOwoKICBJb25pY01vZHVsZQogICAgLmNvbnRyb2xsZXIoJyRpb25pY1RhYicsIFsKICAgICAgJyRzY29wZScsCiAgICAgICckaW9uaWNWaWV3U2VydmljZScsCiAgICAgICckYXR0cnMnLAogICAgICAnJGxvY2F0aW9uJywKICAgICAgJyRzdGF0ZScsCiAgICAgIGZ1bmN0aW9uKCRzY29wZSwgJGlvbmljVmlld1NlcnZpY2UsICRhdHRycywgJGxvY2F0aW9uLCAkc3RhdGUpIHsKICAgICAgICB0aGlzLiRzY29wZSA9ICRzY29wZTsKCiAgICAgICAgLy9BbGwgb2YgdGhlc2UgZXhwb3NlZCBmb3IgdGVzdGluZwogICAgICAgIHRoaXMuaHJlZk1hdGNoZXNTdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuICRhdHRycy5ocmVmICYmICRsb2NhdGlvbi5wYXRoKCkuaW5kZXhPZigKICAgICAgICAgICAgJGF0dHJzLmhyZWYucmVwbGFjZSgvXiMvLCAnJykucmVwbGFjZSgvXC8kLywgJycpCiAgICAgICAgICApID09PSAwOwogICAgICAgIH07CiAgICAgICAgdGhpcy5zcmVmTWF0Y2hlc1N0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gJGF0dHJzLnVpU3JlZiAmJiAkc3RhdGUuaW5jbHVkZXMoICRhdHRycy51aVNyZWYuc3BsaXQoJygnKVswXSApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5uYXZOYW1lTWF0Y2hlc1N0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5uYXZWaWV3TmFtZSAmJiAkaW9uaWNWaWV3U2VydmljZS5pc0N1cnJlbnRTdGF0ZU5hdlZpZXcodGhpcy5uYXZWaWV3TmFtZSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy50YWJNYXRjaGVzU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmhyZWZNYXRjaGVzU3RhdGUoKSB8fCB0aGlzLnNyZWZNYXRjaGVzU3RhdGUoKSB8fCB0aGlzLm5hdk5hbWVNYXRjaGVzU3RhdGUoKTsKICAgICAgICB9OwogICAgICB9XSk7CgogIElvbmljTW9kdWxlCiAgICAuY29udHJvbGxlcignJGlvbmljVGFicycsIFsKICAgICAgJyRzY29wZScsCiAgICAgICckaW9uaWNWaWV3U2VydmljZScsCiAgICAgICckZWxlbWVudCcsCiAgICAgIGZ1bmN0aW9uKCRzY29wZSwgJGlvbmljVmlld1NlcnZpY2UsICRlbGVtZW50KSB7CiAgICAgICAgdmFyIF9zZWxlY3RlZFRhYiA9IG51bGw7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHNlbGYudGFicyA9IFtdOwoKICAgICAgICBzZWxmLnNlbGVjdGVkSW5kZXggPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBzZWxmLnRhYnMuaW5kZXhPZihfc2VsZWN0ZWRUYWIpOwogICAgICAgIH07CiAgICAgICAgc2VsZi5zZWxlY3RlZFRhYiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIF9zZWxlY3RlZFRhYjsKICAgICAgICB9OwoKICAgICAgICBzZWxmLmFkZCA9IGZ1bmN0aW9uKHRhYikgewogICAgICAgICAgJGlvbmljVmlld1NlcnZpY2UucmVnaXN0ZXJIaXN0b3J5KHRhYik7CiAgICAgICAgICBzZWxmLnRhYnMucHVzaCh0YWIpOwogICAgICAgICAgaWYoc2VsZi50YWJzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICBzZWxmLnNlbGVjdCh0YWIpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHNlbGYucmVtb3ZlID0gZnVuY3Rpb24odGFiKSB7CiAgICAgICAgICB2YXIgdGFiSW5kZXggPSBzZWxmLnRhYnMuaW5kZXhPZih0YWIpOwogICAgICAgICAgaWYgKHRhYkluZGV4ID09PSAtMSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICAvL1VzZSBhIGZpZWxkIGxpa2UgJyR0YWJTZWxlY3RlZCcgc28gZGV2ZWxvcGVycyB3b24ndCBhY2NpZGVudGFsbHkgc2V0IGl0IGluIGNvbnRyb2xsZXJzIGV0YwogICAgICAgICAgaWYgKHRhYi4kdGFiU2VsZWN0ZWQpIHsKICAgICAgICAgICAgc2VsZi5kZXNlbGVjdCh0YWIpOwogICAgICAgICAgICAvL1RyeSB0byBzZWxlY3QgYSBuZXcgdGFiIGlmIHdlJ3JlIHJlbW92aW5nIGEgdGFiCiAgICAgICAgICAgIGlmIChzZWxmLnRhYnMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgLy9kbyBub3RoaW5nIGlmIHRoZXJlIGFyZSBubyBvdGhlciB0YWJzIHRvIHNlbGVjdAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vU2VsZWN0IHByZXZpb3VzIHRhYiBpZiBpdCdzIHRoZSBsYXN0IHRhYiwgZWxzZSBzZWxlY3QgbmV4dCB0YWIKICAgICAgICAgICAgICB2YXIgbmV3VGFiSW5kZXggPSB0YWJJbmRleCA9PT0gc2VsZi50YWJzLmxlbmd0aCAtIDEgPyB0YWJJbmRleCAtIDEgOiB0YWJJbmRleCArIDE7CiAgICAgICAgICAgICAgc2VsZi5zZWxlY3Qoc2VsZi50YWJzW25ld1RhYkluZGV4XSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHNlbGYudGFicy5zcGxpY2UodGFiSW5kZXgsIDEpOwogICAgICAgIH07CgogICAgICAgIHNlbGYuZGVzZWxlY3QgPSBmdW5jdGlvbih0YWIpIHsKICAgICAgICAgIGlmICh0YWIuJHRhYlNlbGVjdGVkKSB7CiAgICAgICAgICAgIF9zZWxlY3RlZFRhYiA9IG51bGw7CiAgICAgICAgICAgIHRhYi4kdGFiU2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgKHRhYi5vbkRlc2VsZWN0IHx8IGFuZ3VsYXIubm9vcCkoKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBzZWxmLnNlbGVjdCA9IGZ1bmN0aW9uKHRhYiwgc2hvdWxkRW1pdEV2ZW50KSB7CiAgICAgICAgICB2YXIgdGFiSW5kZXg7CiAgICAgICAgICBpZiAoYW5ndWxhci5pc051bWJlcih0YWIpKSB7CiAgICAgICAgICAgIHRhYkluZGV4ID0gdGFiOwogICAgICAgICAgICB0YWIgPSBzZWxmLnRhYnNbdGFiSW5kZXhdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGFiSW5kZXggPSBzZWxmLnRhYnMuaW5kZXhPZih0YWIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCF0YWIgfHwgdGFiSW5kZXggPT0gLTEpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgc2VsZWN0IHRhYiAiJyArIHRhYkluZGV4ICsgJyIhJyk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKF9zZWxlY3RlZFRhYiAmJiBfc2VsZWN0ZWRUYWIuJGhpc3RvcnlJZCA9PSB0YWIuJGhpc3RvcnlJZCkgewogICAgICAgICAgICBpZiAoc2hvdWxkRW1pdEV2ZW50KSB7CiAgICAgICAgICAgICAgJGlvbmljVmlld1NlcnZpY2UuZ29Ub0hpc3RvcnlSb290KHRhYi4kaGlzdG9yeUlkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yRWFjaChzZWxmLnRhYnMsIGZ1bmN0aW9uKHRhYikgewogICAgICAgICAgICAgIHNlbGYuZGVzZWxlY3QodGFiKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBfc2VsZWN0ZWRUYWIgPSB0YWI7CiAgICAgICAgICAgIC8vVXNlIGEgZnVubnkgbmFtZSBsaWtlICR0YWJTZWxlY3RlZCBzbyB0aGUgZGV2ZWxvcGVyIGRvZXNuJ3Qgb3ZlcndyaXRlIHRoZSB2YXIgaW4gYSBjaGlsZCBzY29wZQogICAgICAgICAgICB0YWIuJHRhYlNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgKHRhYi5vblNlbGVjdCB8fCBhbmd1bGFyLm5vb3ApKCk7CgogICAgICAgICAgICBpZiAoc2hvdWxkRW1pdEV2ZW50KSB7CiAgICAgICAgICAgICAgdmFyIHZpZXdEYXRhID0gewogICAgICAgICAgICAgICAgdHlwZTogJ3RhYicsCiAgICAgICAgICAgICAgICB0YWJJbmRleDogdGFiSW5kZXgsCiAgICAgICAgICAgICAgICBoaXN0b3J5SWQ6IHRhYi4kaGlzdG9yeUlkLAogICAgICAgICAgICAgICAgbmF2Vmlld05hbWU6IHRhYi5uYXZWaWV3TmFtZSwKICAgICAgICAgICAgICAgIGhhc05hdlZpZXc6ICEhdGFiLm5hdlZpZXdOYW1lLAogICAgICAgICAgICAgICAgdGl0bGU6IHRhYi50aXRsZSwKICAgICAgICAgICAgICAgIC8vU2tpcCB0aGUgZmlyc3QgY2hhcmFjdGVyIG9mIGhyZWYgaWYgaXQncyAjCiAgICAgICAgICAgICAgICB1cmw6IHRhYi5ocmVmLAogICAgICAgICAgICAgICAgdWlTcmVmOiB0YWIudWlTcmVmCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAkc2NvcGUuJGVtaXQoJ3ZpZXdTdGF0ZS5jaGFuZ2VIaXN0b3J5Jywgdmlld0RhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfV0pOwoKCiAgLyoKICAgKiBXZSBkb24ndCBkb2N1bWVudCB0aGUgaW9uQWN0aW9uU2hlZXQgZGlyZWN0aXZlLCB3ZSBpbnN0ZWFkIGRvY3VtZW50CiAgICogdGhlICRpb25pY0FjdGlvblNoZWV0IHNlcnZpY2UKICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uQWN0aW9uU2hlZXQnLCBbJyRkb2N1bWVudCcsIGZ1bmN0aW9uKCRkb2N1bWVudCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgc2NvcGU6IHRydWUsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KXsKICAgICAgICAgIHZhciBrZXlVcCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgaWYoZS53aGljaCA9PSAyNykgewogICAgICAgICAgICAgICRzY29wZS5jYW5jZWwoKTsKICAgICAgICAgICAgICAkc2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgdmFyIGJhY2tkcm9wQ2xpY2sgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGlmKGUudGFyZ2V0ID09ICRlbGVtZW50WzBdKSB7CiAgICAgICAgICAgICAgJHNjb3BlLmNhbmNlbCgpOwogICAgICAgICAgICAgICRzY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICRlbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAkZG9jdW1lbnQudW5iaW5kKCdrZXl1cCcsIGtleVVwKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgICRkb2N1bWVudC5iaW5kKCdrZXl1cCcsIGtleVVwKTsKICAgICAgICAgICRlbGVtZW50LmJpbmQoJ2NsaWNrJywgYmFja2Ryb3BDbGljayk7CiAgICAgICAgfSwKICAgICAgICB0ZW1wbGF0ZTogJzxkaXYgY2xhc3M9ImFjdGlvbi1zaGVldC1iYWNrZHJvcCI+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0iYWN0aW9uLXNoZWV0LXdyYXBwZXIiPicgKwogICAgICAgICAgJzxkaXYgY2xhc3M9ImFjdGlvbi1zaGVldCI+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0iYWN0aW9uLXNoZWV0LWdyb3VwIj4nICsKICAgICAgICAgICc8ZGl2IGNsYXNzPSJhY3Rpb24tc2hlZXQtdGl0bGUiIG5nLWlmPSJ0aXRsZVRleHQiIG5nLWJpbmQtaHRtbD0idGl0bGVUZXh0Ij48L2Rpdj4nICsKICAgICAgICAgICc8YnV0dG9uIGNsYXNzPSJidXR0b24iIG5nLWNsaWNrPSJidXR0b25DbGlja2VkKCRpbmRleCkiIG5nLXJlcGVhdD0iYnV0dG9uIGluIGJ1dHRvbnMiIG5nLWJpbmQtaHRtbD0iYnV0dG9uLnRleHQiPjwvYnV0dG9uPicgKwogICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgJzxkaXYgY2xhc3M9ImFjdGlvbi1zaGVldC1ncm91cCIgbmctaWY9ImRlc3RydWN0aXZlVGV4dCI+JyArCiAgICAgICAgICAnPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIGRlc3RydWN0aXZlIiBuZy1jbGljaz0iZGVzdHJ1Y3RpdmVCdXR0b25DbGlja2VkKCkiIG5nLWJpbmQtaHRtbD0iZGVzdHJ1Y3RpdmVUZXh0Ij48L2J1dHRvbj4nICsKICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICc8ZGl2IGNsYXNzPSJhY3Rpb24tc2hlZXQtZ3JvdXAiIG5nLWlmPSJjYW5jZWxUZXh0Ij4nICsKICAgICAgICAgICc8YnV0dG9uIGNsYXNzPSJidXR0b24iIG5nLWNsaWNrPSJjYW5jZWwoKSIgbmctYmluZC1odG1sPSJjYW5jZWxUZXh0Ij48L2J1dHRvbj4nICsKICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICc8L2Rpdj4nCiAgICAgIH07CiAgICB9XSk7CgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgaW9uQ2hlY2tib3gKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKiBAY29kZXBlbiBocWNqdQogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBjaGVja2JveCBpcyBubyBkaWZmZXJlbnQgdGhhbiB0aGUgSFRNTCBjaGVja2JveCBpbnB1dCwgZXhjZXB0IGl0J3Mgc3R5bGVkIGRpZmZlcmVudGx5LgogICAqCiAgICogVGhlIGNoZWNrYm94IGJlaGF2ZXMgbGlrZSBhbnkgW0FuZ3VsYXJKUyBjaGVja2JveF0oaHR0cDovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvbmcvaW5wdXQvaW5wdXRbY2hlY2tib3hdKS4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8aW9uLWNoZWNrYm94IG5nLW1vZGVsPSJpc0NoZWNrZWQiPkNoZWNrYm94IExhYmVsPC9pb24tY2hlY2tib3g+CiAgICogYGBgCiAgICovCgogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25DaGVja2JveCcsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgdGVtcGxhdGU6CiAgICAgICAgICAnPGxhYmVsIGNsYXNzPSJpdGVtIGl0ZW0tY2hlY2tib3giPicgKwogICAgICAgICAgJzxkaXYgY2xhc3M9ImNoZWNrYm94IGNoZWNrYm94LWlucHV0LWhpZGRlbiBkaXNhYmxlLXBvaW50ZXItZXZlbnRzIj4nICsKICAgICAgICAgICc8aW5wdXQgdHlwZT0iY2hlY2tib3giPicgKwogICAgICAgICAgJzxpIGNsYXNzPSJjaGVja2JveC1pY29uIj48L2k+JyArCiAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0iaXRlbS1jb250ZW50IGRpc2FibGUtcG9pbnRlci1ldmVudHMiIG5nLXRyYW5zY2x1ZGU+PC9kaXY+JyArCiAgICAgICAgICAnPC9sYWJlbD4nLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQuZmluZCgnaW5wdXQnKTsKICAgICAgICAgIGZvckVhY2goewogICAgICAgICAgICAnbmFtZSc6IGF0dHIubmFtZSwKICAgICAgICAgICAgJ25nLXZhbHVlJzogYXR0ci5uZ1ZhbHVlLAogICAgICAgICAgICAnbmctbW9kZWwnOiBhdHRyLm5nTW9kZWwsCiAgICAgICAgICAgICduZy1jaGVja2VkJzogYXR0ci5uZ0NoZWNrZWQsCiAgICAgICAgICAgICduZy1kaXNhYmxlZCc6IGF0dHIubmdEaXNhYmxlZCwKICAgICAgICAgICAgJ25nLXRydWUtdmFsdWUnOiBhdHRyLm5nVHJ1ZVZhbHVlLAogICAgICAgICAgICAnbmctZmFsc2UtdmFsdWUnOiBhdHRyLm5nRmFsc2VWYWx1ZSwKICAgICAgICAgICAgJ25nLWNoYW5nZSc6IGF0dHIubmdDaGFuZ2UKICAgICAgICAgIH0sIGZ1bmN0aW9uKHZhbHVlLCBuYW1lKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgaW5wdXQuYXR0cihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgIH07CiAgICB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAbmFtZSBjb2xsZWN0aW9uUmVwZWF0CiAgICogQHJlc3RyaWN0IEEKICAgKiBAY29kZXBlbiBtRnlnaAogICAqIEBkZXNjcmlwdGlvbgogICAqIGBjb2xsZWN0aW9uLXJlcGVhdGAgaXMgYSBkaXJlY3RpdmUgdGhhdCBhbGxvd3MgeW91IHRvIHJlbmRlciBsaXN0cyB3aXRoCiAgICogdGhvdXNhbmRzIG9mIGl0ZW1zIGluIHRoZW0sIGFuZCBleHBlcmllbmNlIGxpdHRsZSB0byBubyBwZXJmb3JtYW5jZSBwZW5hbHR5LgogICAqCiAgICogRGVtbzoKICAgKgogICAqIFRoZSBkaXJlY3RpdmUgcmVuZGVycyBvbnRvIHRoZSBzY3JlZW4gb25seSB0aGUgaXRlbXMgdGhhdCBzaG91bGQgYmUgY3VycmVudGx5IHZpc2libGUuCiAgICogU28gaWYgeW91IGhhdmUgMSwwMDAgaXRlbXMgaW4geW91ciBsaXN0IGJ1dCBvbmx5IHRlbiBmaXQgb24geW91ciBzY3JlZW4sCiAgICogY29sbGVjdGlvbi1yZXBlYXQgd2lsbCBvbmx5IHJlbmRlciBpbnRvIHRoZSBET00gdGhlIHRlbiB0aGF0IGFyZSBpbiB0aGUgY3VycmVudAogICAqIHNjcm9sbCBwb3NpdGlvbi4KICAgKgogICAqIEhlcmUgYXJlIGEgZmV3IHRoaW5ncyB0byBrZWVwIGluIG1pbmQgd2hpbGUgdXNpbmcgY29sbGVjdGlvbi1yZXBlYXQ6CiAgICoKICAgKiAxLiBUaGUgZGF0YSBzdXBwbGllZCB0byBjb2xsZWN0aW9uLXJlcGVhdCBtdXN0IGJlIGFuIGFycmF5LgogICAqIDIuIFlvdSBtdXN0IGV4cGxpY2l0bHkgdGVsbCB0aGUgZGlyZWN0aXZlIHdoYXQgc2l6ZSB5b3VyIGl0ZW1zIHdpbGwgYmUgaW4gdGhlIERPTSwgdXNpbmcgZGlyZWN0aXZlIGF0dHJpYnV0ZXMuCiAgICogUGl4ZWwgYW1vdW50cyBvciBwZXJjZW50YWdlcyBhcmUgYWxsb3dlZCAoc2VlIGJlbG93KS4KICAgKiAzLiBUaGUgZWxlbWVudHMgcmVuZGVyZWQgd2lsbCBiZSBhYnNvbHV0ZWx5IHBvc2l0aW9uZWQ6IGJlIHN1cmUgdG8gbGV0IHlvdXIgQ1NTIHdvcmsgd2l0aAogICAqIHRoaXMgKHNlZSBiZWxvdykuCiAgICogNC4gRWFjaCBjb2xsZWN0aW9uLXJlcGVhdCBsaXN0IHdpbGwgdGFrZSB1cCBhbGwgb2YgaXRzIHBhcmVudCBzY3JvbGxWaWV3J3Mgc3BhY2UuCiAgICogSWYgeW91IHdpc2ggdG8gaGF2ZSBtdWx0aXBsZSBsaXN0cyBvbiBvbmUgcGFnZSwgcHV0IGVhY2ggbGlzdCB3aXRoaW4gaXRzIG93bgogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2Nyb2xsIGlvblNjcm9sbH0gY29udGFpbmVyLgogICAqIDUuIFlvdSBzaG91bGQgbm90IHVzZSB0aGUgbmctc2hvdyBhbmQgbmctaGlkZSBkaXJlY3RpdmVzIG9uIHlvdXIgaW9uLWNvbnRlbnQvaW9uLXNjcm9sbCBlbGVtZW50cyB0aGF0CiAgICogaGF2ZSBhIGNvbGxlY3Rpb24tcmVwZWF0IGluc2lkZS4gIG5nLXNob3cgYW5kIG5nLWhpZGUgYXBwbHkgdGhlIGBkaXNwbGF5OiBub25lYCBjc3MgcnVsZSB0byB0aGUgY29udGVudCdzCiAgICogc3R5bGUsIGNhdXNpbmcgdGhlIHNjcm9sbFZpZXcgdG8gcmVhZCB0aGUgd2lkdGggYW5kIGhlaWdodCBvZiB0aGUgY29udGVudCBhcyAwLiAgUmVzdWx0aW5nbHksCiAgICogY29sbGVjdGlvbi1yZXBlYXQgd2lsbCByZW5kZXIgZWxlbWVudHMgdGhhdCBoYXZlIGp1c3QgYmVlbiB1bi1oaWRkZW4gaW5jb3JyZWN0bHkuCiAgICoKICAgKgogICAqIEB1c2FnZQogICAqCiAgICogIyMjIyBCYXNpYyBVc2FnZSAoc2luZ2xlIHJvd3Mgb2YgaXRlbXMpCiAgICoKICAgKiBOb3RpY2UgdHdvIHRoaW5ncyBoZXJlOiB3ZSB1c2Ugbmctc3R5bGUgdG8gc2V0IHRoZSBoZWlnaHQgb2YgdGhlIGl0ZW0gdG8gbWF0Y2gKICAgKiB3aGF0IHRoZSByZXBlYXRlciB0aGlua3Mgb3VyIGl0ZW0gaGVpZ2h0IGlzLiAgQWRkaXRpb25hbGx5LCB3ZSBhZGQgYSBjc3MgcnVsZQogICAqIHRvIG1ha2Ugb3VyIGl0ZW0gc3RyZXRjaCB0byBmaXQgdGhlIGZ1bGwgc2NyZWVuIChzaW5jZSBpdCB3aWxsIGJlIGFic29sdXRlbHkKICAgKiBwb3NpdGlvbmVkKS4KICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLWNvbnRlbnQgbmctY29udHJvbGxlcj0iQ29udGVudEN0cmwiPgogICAqICAgPGRpdiBjbGFzcz0ibGlzdCI+CiAgICogICAgIDxkaXYgY2xhc3M9Iml0ZW0gbXktaXRlbSIKICAgKiAgICAgICBjb2xsZWN0aW9uLXJlcGVhdD0iaXRlbSBpbiBpdGVtcyIKICAgKiAgICAgICBjb2xsZWN0aW9uLWl0ZW0td2lkdGg9IicxMDAlJyIKICAgKiAgICAgICBjb2xsZWN0aW9uLWl0ZW0taGVpZ2h0PSJnZXRJdGVtSGVpZ2h0KGl0ZW0sICRpbmRleCkiCiAgICogICAgICAgbmctc3R5bGU9IntoZWlnaHQ6IGdldEl0ZW1IZWlnaHQoaXRlbSwgJGluZGV4KX0iPgogICAqICAgICAgIHslIHJhdyAlfXt7aXRlbX19eyUgZW5kcmF3ICV9CiAgICogICAgIDwvZGl2PgogICAqICAgPC9kaXY+CiAgICogPC9kaXY+CiAgICogYGBgCiAgICogYGBganMKICAgKiBmdW5jdGlvbiBDb250ZW50Q3RybCgkc2NvcGUpIHsKICogICAkc2NvcGUuaXRlbXMgPSBbXTsKICogICBmb3IgKHZhciBpID0gMDsgaSA8IDEwMDA7IGkrKykgewogKiAgICAgJHNjb3BlLml0ZW1zLnB1c2goJ0l0ZW0gJyArIGkpOwogKiAgIH0KICoKICogICAkc2NvcGUuZ2V0SXRlbUhlaWdodCA9IGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CiAqICAgICAvL01ha2UgZXZlbmx5IGluZGV4ZWQgaXRlbXMgYmUgMTBweCB0YWxsZXIsIGZvciB0aGUgc2FrZSBvZiBleGFtcGxlCiAqICAgICByZXR1cm4gKGluZGV4ICUgMikgPT09IDAgPyA1MCA6IDYwOwogKiAgIH07CiAqIH0KICAgKiBgYGAKICAgKiBgYGBjc3MKICAgKiAubXktaXRlbSB7CiAqICAgbGVmdDogMDsKICogICByaWdodDogMDsKICogfQogICAqIGBgYAogICAqCiAgICogIyMjIyBHcmlkIFVzYWdlICh0aHJlZSBpdGVtcyBwZXIgcm93KQogICAqCiAgICogYGBgaHRtbAogICAqIDxpb24tY29udGVudD4KICAgKiAgIDxkaXYgY2xhc3M9Iml0ZW0gaXRlbS1hdmF0YXIgbXktaW1hZ2UtaXRlbSIKICAgKiAgICAgY29sbGVjdGlvbi1yZXBlYXQ9ImltYWdlIGluIGltYWdlcyIKICAgKiAgICAgY29sbGVjdGlvbi1pdGVtLXdpZHRoPSInMzMlJyIKICAgKiAgICAgY29sbGVjdGlvbi1pdGVtLWhlaWdodD0iJzMzJSciPgogICAqICAgICA8aW1nIG5nLXNyYz0ie3tpbWFnZS5zcmN9fSI+CiAgICogICA8L2Rpdj4KICAgKiA8L2lvbi1jb250ZW50PgogICAqIGBgYAogICAqIFBlcmNlbnRhZ2Ugb2YgdG90YWwgdmlzaWJsZSBsaXN0IGRpbWVuc2lvbnMuIFRoaXMgZXhhbXBsZSBzaG93cyBhIDMgYnkgMyBtYXRyaXggdGhhdCBmaXRzIG9uIHRoZSBzY3JlZW4gKDMgcm93cyBhbmQgMyBjb2x1bXMpLiBOb3RlIHRoYXQgZGltZW5zaW9ucyBhcmUgdXNlZCBpbiB0aGUgY3JlYXRpb24gb2YgdGhlIGVsZW1lbnQgYW5kIHRoZXJlZm9yZSBhIG1lYXN1cmVtZW50IG9mIHRoZSBpdGVtIGNhbm5ub3QgYmUgdXNlZCBhcyBhbiBpbnB1dCBkaW1lbnNpb24uCiAgICogYGBgY3NzCiAgICogLm15LWltYWdlLWl0ZW0gaW1nIHsKICogICBoZWlnaHQ6IDMzJTsKICogICB3aWR0aDogMzMlOwogKiB9CiAgICogYGBgCiAgICoKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IGNvbGxlY3Rpb24tcmVwZWF0IFRoZSBleHByZXNzaW9uIGluZGljYXRpbmcgaG93IHRvIGVudW1lcmF0ZSBhIGNvbGxlY3Rpb24uIFRoZXNlCiAgICogICBmb3JtYXRzIGFyZSBjdXJyZW50bHkgc3VwcG9ydGVkOgogICAqCiAgICogICAqIGB2YXJpYWJsZSBpbiBleHByZXNzaW9uYCDigJMgd2hlcmUgdmFyaWFibGUgaXMgdGhlIHVzZXIgZGVmaW5lZCBsb29wIHZhcmlhYmxlIGFuZCBgZXhwcmVzc2lvbmAKICAgKiAgICAgaXMgYSBzY29wZSBleHByZXNzaW9uIGdpdmluZyB0aGUgY29sbGVjdGlvbiB0byBlbnVtZXJhdGUuCiAgICoKICAgKiAgICAgRm9yIGV4YW1wbGU6IGBhbGJ1bSBpbiBhcnRpc3QuYWxidW1zYC4KICAgKgogICAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbiB0cmFjayBieSB0cmFja2luZ19leHByZXNzaW9uYCDigJMgWW91IGNhbiBhbHNvIHByb3ZpZGUgYW4gb3B0aW9uYWwgdHJhY2tpbmcgZnVuY3Rpb24KICAgKiAgICAgd2hpY2ggY2FuIGJlIHVzZWQgdG8gYXNzb2NpYXRlIHRoZSBvYmplY3RzIGluIHRoZSBjb2xsZWN0aW9uIHdpdGggdGhlIERPTSBlbGVtZW50cy4gSWYgbm8gdHJhY2tpbmcgZnVuY3Rpb24KICAgKiAgICAgaXMgc3BlY2lmaWVkIHRoZSBjb2xsZWN0aW9uLXJlcGVhdCBhc3NvY2lhdGVzIGVsZW1lbnRzIGJ5IGlkZW50aXR5IGluIHRoZSBjb2xsZWN0aW9uLiBJdCBpcyBhbiBlcnJvciB0byBoYXZlCiAgICogICAgIG1vcmUgdGhhbiBvbmUgdHJhY2tpbmcgZnVuY3Rpb24gdG8gcmVzb2x2ZSB0byB0aGUgc2FtZSBrZXkuIChUaGlzIHdvdWxkIG1lYW4gdGhhdCB0d28gZGlzdGluY3Qgb2JqZWN0cyBhcmUKICAgKiAgICAgbWFwcGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LCB3aGljaCBpcyBub3QgcG9zc2libGUuKSAgRmlsdGVycyBzaG91bGQgYmUgYXBwbGllZCB0byB0aGUgZXhwcmVzc2lvbiwKICAgKiAgICAgYmVmb3JlIHNwZWNpZnlpbmcgYSB0cmFja2luZyBleHByZXNzaW9uLgogICAqCiAgICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtc2AgaXMgZXF1aXZhbGVudCB0byBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSAkaWQoaXRlbSknLiBUaGlzIGltcGxpZXMgdGhhdCB0aGUgRE9NIGVsZW1lbnRzCiAgICogICAgIHdpbGwgYmUgYXNzb2NpYXRlZCBieSBpdGVtIGlkZW50aXR5IGluIHRoZSBhcnJheS4KICAgKgogICAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXMgdHJhY2sgYnkgJGlkKGl0ZW0pYC4gQSBidWlsdCBpbiBgJGlkKClgIGZ1bmN0aW9uIGNhbiBiZSB1c2VkIHRvIGFzc2lnbiBhIHVuaXF1ZQogICAqICAgICBgJCRoYXNoS2V5YCBwcm9wZXJ0eSB0byBlYWNoIGl0ZW0gaW4gdGhlIGFycmF5LiBUaGlzIHByb3BlcnR5IGlzIHRoZW4gdXNlZCBhcyBhIGtleSB0byBhc3NvY2lhdGVkIERPTSBlbGVtZW50cwogICAqICAgICB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIGl0ZW0gaW4gdGhlIGFycmF5IGJ5IGlkZW50aXR5LiBNb3ZpbmcgdGhlIHNhbWUgb2JqZWN0IGluIGFycmF5IHdvdWxkIG1vdmUgdGhlIERPTQogICAqICAgICBlbGVtZW50IGluIHRoZSBzYW1lIHdheSBpbiB0aGUgRE9NLgogICAqCiAgICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSBpdGVtLmlkYCBpcyBhIHR5cGljYWwgcGF0dGVybiB3aGVuIHRoZSBpdGVtcyBjb21lIGZyb20gdGhlIGRhdGFiYXNlLiBJbiB0aGlzCiAgICogICAgIGNhc2UgdGhlIG9iamVjdCBpZGVudGl0eSBkb2VzIG5vdCBtYXR0ZXIuIFR3byBvYmplY3RzIGFyZSBjb25zaWRlcmVkIGVxdWl2YWxlbnQgYXMgbG9uZyBhcyB0aGVpciBgaWRgCiAgICogICAgIHByb3BlcnR5IGlzIHNhbWUuCiAgICoKICAgKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHwgZmlsdGVyOnNlYXJjaFRleHQgdHJhY2sgYnkgaXRlbS5pZGAgaXMgYSBwYXR0ZXJuIHRoYXQgbWlnaHQgYmUgdXNlZCB0byBhcHBseSBhIGZpbHRlcgogICAqICAgICB0byBpdGVtcyBpbiBjb25qdW5jdGlvbiB3aXRoIGEgdHJhY2tpbmcgZXhwcmVzc2lvbi4KICAgKgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gY29sbGVjdGlvbi1pdGVtLXdpZHRoIFRoZSB3aWR0aCBvZiB0aGUgcmVwZWF0ZWQgZWxlbWVudC4gIENhbiBiZSBhIG51bWJlciAoaW4gcGl4ZWxzKSBvciBhIHBlcmNlbnRhZ2UuCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBjb2xsZWN0aW9uLWl0ZW0taGVpZ2h0IFRoZSBoZWlnaHQgb2YgdGhlIHJlcGVhdGVkIGVsZW1lbnQuICBDYW4gYmUgYSBudW1iZXIgKGluIHBpeGVscyksIG9yIGEgcGVyY2VudGFnZS4KICAgKgogICAqLwogIHZhciBDT0xMRUNUSU9OX1JFUEVBVF9TQ1JPTExWSUVXX1hZX0VSUk9SID0gIkNhbm5vdCBjcmVhdGUgYSBjb2xsZWN0aW9uLXJlcGVhdCB3aXRoaW4gYSBzY3JvbGxWaWV3IHRoYXQgaXMgc2Nyb2xsYWJsZSBvbiBib3RoIHggYW5kIHkgYXhpcy4gIENob29zZSBlaXRoZXIgeCBkaXJlY3Rpb24gb3IgeSBkaXJlY3Rpb24uIjsKICB2YXIgQ09MTEVDVElPTl9SRVBFQVRfQVRUUl9IRUlHSFRfRVJST1IgPSAiY29sbGVjdGlvbi1yZXBlYXQgZXhwZWN0ZWQgYXR0cmlidXRlIGNvbGxlY3Rpb24taXRlbS1oZWlnaHQgdG8gYmUgYSBhbiBleHByZXNzaW9uIHRoYXQgcmV0dXJucyBhIG51bWJlciAoaW4gcGl4ZWxzKSBvciBwZXJjZW50YWdlLiI7CiAgdmFyIENPTExFQ1RJT05fUkVQRUFUX0FUVFJfV0lEVEhfRVJST1IgPSAiY29sbGVjdGlvbi1yZXBlYXQgZXhwZWN0ZWQgYXR0cmlidXRlIGNvbGxlY3Rpb24taXRlbS13aWR0aCB0byBiZSBhIGFuIGV4cHJlc3Npb24gdGhhdCByZXR1cm5zIGEgbnVtYmVyIChpbiBwaXhlbHMpIG9yIHBlcmNlbnRhZ2UuIjsKICB2YXIgQ09MTEVDVElPTl9SRVBFQVRfQVRUUl9SRVBFQVRfRVJST1IgPSAiY29sbGVjdGlvbi1yZXBlYXQgZXhwZWN0ZWQgZXhwcmVzc2lvbiBpbiBmb3JtIG9mICdfaXRlbV8gaW4gX2NvbGxlY3Rpb25fWyB0cmFjayBieSBfaWRfXScgYnV0IGdvdCAnJSciOwoKICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSh7CiAgICAgIG5nU3JjOiBjb2xsZWN0aW9uUmVwZWF0U3JjRGlyZWN0aXZlKCduZ1NyYycsICdzcmMnKSwKICAgICAgbmdTcmNzZXQ6IGNvbGxlY3Rpb25SZXBlYXRTcmNEaXJlY3RpdmUoJ25nU3Jjc2V0JywgJ3NyY3NldCcpLAogICAgICBuZ0hyZWY6IGNvbGxlY3Rpb25SZXBlYXRTcmNEaXJlY3RpdmUoJ25nSHJlZicsICdocmVmJykKICAgIH0pCiAgICAuZGlyZWN0aXZlKCdjb2xsZWN0aW9uUmVwZWF0JywgWwogICAgICAnJGNvbGxlY3Rpb25SZXBlYXRNYW5hZ2VyJywKICAgICAgJyRjb2xsZWN0aW9uRGF0YVNvdXJjZScsCiAgICAgICckcGFyc2UnLAogICAgICBmdW5jdGlvbigkY29sbGVjdGlvblJlcGVhdE1hbmFnZXIsICRjb2xsZWN0aW9uRGF0YVNvdXJjZSwgJHBhcnNlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHByaW9yaXR5OiAxMDAwLAogICAgICAgICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICAgICAkJHRsYjogdHJ1ZSwKICAgICAgICAgIHJlcXVpcmU6ICdeJGlvbmljU2Nyb2xsJywKICAgICAgICAgIGNvbnRyb2xsZXI6IFtmdW5jdGlvbigpe31dLAogICAgICAgICAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNjcm9sbEN0cmwsICR0cmFuc2NsdWRlKSB7CiAgICAgICAgICAgIHZhciB3cmFwID0ganFMaXRlKCc8ZGl2IHN0eWxlPSJwb3NpdGlvbjpyZWxhdGl2ZTsiPicpOwogICAgICAgICAgICAkZWxlbWVudC5wYXJlbnQoKVswXS5pbnNlcnRCZWZvcmUod3JhcFswXSwgJGVsZW1lbnRbMF0pOwogICAgICAgICAgICB3cmFwLmFwcGVuZCgkZWxlbWVudCk7CgogICAgICAgICAgICB2YXIgc2Nyb2xsVmlldyA9IHNjcm9sbEN0cmwuc2Nyb2xsVmlldzsKICAgICAgICAgICAgaWYgKHNjcm9sbFZpZXcub3B0aW9ucy5zY3JvbGxpbmdYICYmIHNjcm9sbFZpZXcub3B0aW9ucy5zY3JvbGxpbmdZKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKENPTExFQ1RJT05fUkVQRUFUX1NDUk9MTFZJRVdfWFlfRVJST1IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaXNWZXJ0aWNhbCA9ICEhc2Nyb2xsVmlldy5vcHRpb25zLnNjcm9sbGluZ1k7CiAgICAgICAgICAgIGlmIChpc1ZlcnRpY2FsICYmICEkYXR0ci5jb2xsZWN0aW9uSXRlbUhlaWdodCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihDT0xMRUNUSU9OX1JFUEVBVF9BVFRSX0hFSUdIVF9FUlJPUik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzVmVydGljYWwgJiYgISRhdHRyLmNvbGxlY3Rpb25JdGVtV2lkdGgpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoQ09MTEVDVElPTl9SRVBFQVRfQVRUUl9XSURUSF9FUlJPUik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBoZWlnaHRQYXJzZWQgPSAkcGFyc2UoJGF0dHIuY29sbGVjdGlvbkl0ZW1IZWlnaHQgfHwgJyIxMDAlIicpOwogICAgICAgICAgICB2YXIgd2lkdGhQYXJzZWQgPSAkcGFyc2UoJGF0dHIuY29sbGVjdGlvbkl0ZW1XaWR0aCB8fCAnIjEwMCUiJyk7CgogICAgICAgICAgICB2YXIgaGVpZ2h0R2V0dGVyID0gZnVuY3Rpb24oc2NvcGUsIGxvY2FscykgewogICAgICAgICAgICAgIHZhciByZXN1bHQgPSBoZWlnaHRQYXJzZWQoc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHJlc3VsdCkgJiYgcmVzdWx0LmluZGV4T2YoJyUnKSA+IC0xKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihwYXJzZUludChyZXN1bHQsIDEwKSAvIDEwMCAqIHNjcm9sbFZpZXcuX19jbGllbnRIZWlnaHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgd2lkdGhHZXR0ZXIgPSBmdW5jdGlvbihzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHdpZHRoUGFyc2VkKHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgIGlmIChpc1N0cmluZyhyZXN1bHQpICYmIHJlc3VsdC5pbmRleE9mKCclJykgPiAtMSkgewogICAgICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IocGFyc2VJbnQocmVzdWx0LCAxMCkgLyAxMDAgKiBzY3JvbGxWaWV3Ll9fY2xpZW50V2lkdGgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIG1hdGNoID0gJGF0dHIuY29sbGVjdGlvblJlcGVhdC5tYXRjaCgvXlxzKihbXHNcU10rPylccytpblxzKyhbXHNcU10rPykoPzpccyt0cmFja1xzK2J5XHMrKFtcc1xTXSs/KSk/XHMqJC8pOwogICAgICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKENPTExFQ1RJT05fUkVQRUFUX0FUVFJfUkVQRUFUX0VSUk9SCiAgICAgICAgICAgICAgICAucmVwbGFjZSgnJScsICRhdHRyLmNvbGxlY3Rpb25SZXBlYXQpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIga2V5RXhwciA9IG1hdGNoWzFdOwogICAgICAgICAgICB2YXIgbGlzdEV4cHIgPSBtYXRjaFsyXTsKICAgICAgICAgICAgdmFyIHRyYWNrQnlFeHByID0gbWF0Y2hbM107CgogICAgICAgICAgICB2YXIgZGF0YVNvdXJjZSA9IG5ldyAkY29sbGVjdGlvbkRhdGFTb3VyY2UoewogICAgICAgICAgICAgIHNjb3BlOiAkc2NvcGUsCiAgICAgICAgICAgICAgdHJhbnNjbHVkZUZuOiAkdHJhbnNjbHVkZSwKICAgICAgICAgICAgICB0cmFuc2NsdWRlUGFyZW50OiAkZWxlbWVudC5wYXJlbnQoKSwKICAgICAgICAgICAgICBrZXlFeHByOiBrZXlFeHByLAogICAgICAgICAgICAgIGxpc3RFeHByOiBsaXN0RXhwciwKICAgICAgICAgICAgICB0cmFja0J5RXhwcjogdHJhY2tCeUV4cHIsCiAgICAgICAgICAgICAgaGVpZ2h0R2V0dGVyOiBoZWlnaHRHZXR0ZXIsCiAgICAgICAgICAgICAgd2lkdGhHZXR0ZXI6IHdpZHRoR2V0dGVyCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB2YXIgY29sbGVjdGlvblJlcGVhdE1hbmFnZXIgPSBuZXcgJGNvbGxlY3Rpb25SZXBlYXRNYW5hZ2VyKHsKICAgICAgICAgICAgICBkYXRhU291cmNlOiBkYXRhU291cmNlLAogICAgICAgICAgICAgIGVsZW1lbnQ6IHNjcm9sbEN0cmwuJGVsZW1lbnQsCiAgICAgICAgICAgICAgc2Nyb2xsVmlldzogc2Nyb2xsQ3RybC5zY3JvbGxWaWV3LAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICRzY29wZS4kd2F0Y2hDb2xsZWN0aW9uKGxpc3RFeHByLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGlmICh2YWx1ZSAmJiAhYW5ndWxhci5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjb2xsZWN0aW9uLXJlcGVhdCBleHBlY3RzIGFuIGFycmF5IHRvIHJlcGVhdCBvdmVyLCBidXQgaW5zdGVhZCBnb3QgJyIgKyB0eXBlb2YgdmFsdWUgKyAiJy4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVyZW5kZXIodmFsdWUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHZhciBzY3JvbGxWaWV3Q29udGVudCA9IHNjcm9sbEN0cmwuc2Nyb2xsVmlldy5fX2NvbnRlbnQ7CiAgICAgICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyKHZhbHVlKSB7CiAgICAgICAgICAgICAgdmFyIGJlZm9yZVNpYmxpbmdzID0gW107CiAgICAgICAgICAgICAgdmFyIGFmdGVyU2libGluZ3MgPSBbXTsKICAgICAgICAgICAgICB2YXIgYmVmb3JlID0gdHJ1ZTsKICAgICAgICAgICAgICBmb3JFYWNoKHNjcm9sbFZpZXdDb250ZW50LmNoaWxkcmVuLCBmdW5jdGlvbihub2RlLCBpKSB7CiAgICAgICAgICAgICAgICBpZiAoIGlvbmljLkRvbVV0aWwuZWxlbWVudElzRGVzY2VuZGFudCgkZWxlbWVudFswXSwgbm9kZSwgc2Nyb2xsVmlld0NvbnRlbnQpICkgewogICAgICAgICAgICAgICAgICBiZWZvcmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciB3aWR0aCA9IG5vZGUub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgICAgICAgIHZhciBoZWlnaHQgPSBub2RlLm9mZnNldEhlaWdodDsKICAgICAgICAgICAgICAgICAgaWYgKHdpZHRoICYmIGhlaWdodCkgewogICAgICAgICAgICAgICAgICAgIHZhciBlbGVtZW50ID0ganFMaXRlKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIChiZWZvcmUgPyBiZWZvcmVTaWJsaW5ncyA6IGFmdGVyU2libGluZ3MpLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IG5vZGUub2Zmc2V0V2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IG5vZGUub2Zmc2V0SGVpZ2h0LAogICAgICAgICAgICAgICAgICAgICAgZWxlbWVudDogZWxlbWVudCwKICAgICAgICAgICAgICAgICAgICAgIHNjb3BlOiBlbGVtZW50Lmlzb2xhdGVTY29wZSgpIHx8IGVsZW1lbnQuc2NvcGUoKSwKICAgICAgICAgICAgICAgICAgICAgIGlzT3V0c2lkZTogdHJ1ZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIHNjcm9sbFZpZXcucmVzaXplKCk7CiAgICAgICAgICAgICAgZGF0YVNvdXJjZS5zZXREYXRhKHZhbHVlLCBiZWZvcmVTaWJsaW5ncywgYWZ0ZXJTaWJsaW5ncyk7CiAgICAgICAgICAgICAgY29sbGVjdGlvblJlcGVhdE1hbmFnZXIucmVzaXplKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnVuY3Rpb24gb25XaW5kb3dSZXNpemUoKSB7CiAgICAgICAgICAgICAgcmVyZW5kZXIoJHNjb3BlLiRldmFsKGxpc3RFeHByKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlvbmljLm9uKCdyZXNpemUnLCBvbldpbmRvd1Jlc2l6ZSwgd2luZG93KTsKCiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY29sbGVjdGlvblJlcGVhdE1hbmFnZXIuZGVzdHJveSgpOwogICAgICAgICAgICAgIGRhdGFTb3VyY2UuZGVzdHJveSgpOwogICAgICAgICAgICAgIGlvbmljLm9mZigncmVzaXplJywgb25XaW5kb3dSZXNpemUsIHdpbmRvdyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH1dKTsKCi8vIEZpeCBmb3IgIzE2NzQKLy8gUHJvYmxlbTogaWYgYW4gbmdTcmMgb3IgbmdIcmVmIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgZmFsc3kgdmFsdWUsIGl0IHdpbGwKLy8gbm90IGVyYXNlIHRoZSBwcmV2aW91cyB0cnV0aHkgdmFsdWUgb2YgdGhlIGhyZWYuCi8vIEluIGNvbGxlY3Rpb25SZXBlYXQsIHdlIHJlLXVzZSBlbGVtZW50cyBmcm9tIGJlZm9yZS4gU28gaWYgdGhlIG5nSHJlZiBleHByZXNzaW9uCi8vIGV2YWx1YXRlcyB0byB0cnV0aHkgZm9yIGl0ZW0gMSBhbmQgdGhlbiBmYWxzeSBmb3IgaXRlbSAyLCBpZiBhbiBlbGVtZW50IGNoYW5nZXMKLy8gZnJvbSByZXByZXNlbnRpbmcgaXRlbSAxIHRvIHJlcHJlc2VudGluZyBpdGVtIDIsIGl0ZW0gMiB3aWxsIHN0aWxsIGhhdmUKLy8gaXRlbSAxJ3MgaHJlZiB2YWx1ZS4KLy8gU29sdXRpb246ICBlcmFzZSB0aGUgaHJlZiBvciBzcmMgYXR0cmlidXRlIGlmIG5nSHJlZi9uZ1NyYyBhcmUgZmFsc3kuCiAgZnVuY3Rpb24gY29sbGVjdGlvblJlcGVhdFNyY0RpcmVjdGl2ZShuZ0F0dHJOYW1lLCBhdHRyTmFtZSkgewogICAgcmV0dXJuIFtmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBwcmlvcml0eTogJzk5JywgLy8gaXQgbmVlZHMgdG8gcnVuIGFmdGVyIHRoZSBhdHRyaWJ1dGVzIGFyZSBpbnRlcnBvbGF0ZWQKICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY29sbGVjdGlvblJlcGVhdEN0cmwpIHsKICAgICAgICAgIGlmICghY29sbGVjdGlvblJlcGVhdEN0cmwpIHJldHVybjsKICAgICAgICAgIGF0dHIuJG9ic2VydmUobmdBdHRyTmFtZSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgZWxlbWVudFswXVthdHRyXSA9ICcnOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGVsZW1lbnRbMF1bYXR0cl0gPSB2YWx1ZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CiAgICB9XTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25Db250ZW50CiAgICogQG1vZHVsZSBpb25pYwogICAqIEBkZWxlZ2F0ZSBpb25pYy5zZXJ2aWNlOiRpb25pY1Njcm9sbERlbGVnYXRlCiAgICogQHJlc3RyaWN0IEUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBpb25Db250ZW50IGRpcmVjdGl2ZSBwcm92aWRlcyBhbiBlYXN5IHRvIHVzZSBjb250ZW50IGFyZWEgdGhhdCBjYW4gYmUgY29uZmlndXJlZAogICAqIHRvIHVzZSBJb25pYydzIGN1c3RvbSBTY3JvbGwgVmlldywgb3IgdGhlIGJ1aWx0IGluIG92ZXJmbG93IHNjcm9sbGluZyBvZiB0aGUgYnJvd3Nlci4KICAgKgogICAqIFdoaWxlIHdlIHJlY29tbWVuZCB1c2luZyB0aGUgY3VzdG9tIFNjcm9sbCBmZWF0dXJlcyBpbiBJb25pYyBpbiBtb3N0IGNhc2VzLCBzb21ldGltZXMKICAgKiAoZm9yIHBlcmZvcm1hbmNlIHJlYXNvbnMpIG9ubHkgdGhlIGJyb3dzZXIncyBuYXRpdmUgb3ZlcmZsb3cgc2Nyb2xsaW5nIHdpbGwgc3VmZmljZSwKICAgKiBhbmQgc28gd2UndmUgbWFkZSBpdCBlYXN5IHRvIHRvZ2dsZSBiZXR3ZWVuIHRoZSBJb25pYyBzY3JvbGwgaW1wbGVtZW50YXRpb24gYW5kCiAgICogb3ZlcmZsb3cgc2Nyb2xsaW5nLgogICAqCiAgICogWW91IGNhbiBpbXBsZW1lbnQgcHVsbC10by1yZWZyZXNoIHdpdGggdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uUmVmcmVzaGVyfQogICAqIGRpcmVjdGl2ZSwgYW5kIGluZmluaXRlIHNjcm9sbGluZyB3aXRoIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkluZmluaXRlU2Nyb2xsfQogICAqIGRpcmVjdGl2ZS4KICAgKgogICAqIEJlIGF3YXJlIHRoYXQgdGhpcyBkaXJlY3RpdmUgZ2V0cyBpdHMgb3duIGNoaWxkIHNjb3BlLiBJZiB5b3UgZG8gbm90IHVuZGVyc3RhbmQgd2h5IHRoaXMKICAgKiBpcyBpbXBvcnRhbnQsIHlvdSBjYW4gcmVhZCBbaHR0cHM6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvZ3VpZGUvc2NvcGVdKGh0dHBzOi8vZG9jcy5hbmd1bGFyanMub3JnL2d1aWRlL3Njb3BlKS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gZGVsZWdhdGUtaGFuZGxlIFRoZSBoYW5kbGUgdXNlZCB0byBpZGVudGlmeSB0aGlzIHNjcm9sbFZpZXcKICAgKiB3aXRoIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1Njcm9sbERlbGVnYXRlfS4KICAgKiBAcGFyYW0ge3N0cmluZz19IGRpcmVjdGlvbiBXaGljaCB3YXkgdG8gc2Nyb2xsLiAneCcgb3IgJ3knIG9yICd4eScuIERlZmF1bHQgJ3knLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHBhZGRpbmcgV2hldGhlciB0byBhZGQgcGFkZGluZyB0byB0aGUgY29udGVudC4KICAgKiBvZiB0aGUgY29udGVudC4gIERlZmF1bHRzIHRvIHRydWUgb24gaU9TLCBmYWxzZSBvbiBBbmRyb2lkLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNjcm9sbCBXaGV0aGVyIHRvIGFsbG93IHNjcm9sbGluZyBvZiBjb250ZW50LiAgRGVmYXVsdHMgdG8gdHJ1ZS4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvdmVyZmxvdy1zY3JvbGwgV2hldGhlciB0byB1c2Ugb3ZlcmZsb3ctc2Nyb2xsaW5nIGluc3RlYWQgb2YKICAgKiBJb25pYyBzY3JvbGwuCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2Nyb2xsYmFyLXggV2hldGhlciB0byBzaG93IHRoZSBob3Jpem9udGFsIHNjcm9sbGJhci4gRGVmYXVsdCB0cnVlLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNjcm9sbGJhci15IFdoZXRoZXIgdG8gc2hvdyB0aGUgdmVydGljYWwgc2Nyb2xsYmFyLiBEZWZhdWx0IHRydWUuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBzdGFydC15IEluaXRpYWwgdmVydGljYWwgc2Nyb2xsIHBvc2l0aW9uLiBEZWZhdWx0IDAuCiAgICogb2YgdGhlIGNvbnRlbnQuICBEZWZhdWx0cyB0byB0cnVlIG9uIGlPUywgZmFsc2Ugb24gQW5kcm9pZC4KICAgKiBAcGFyYW0ge2V4cHJlc3Npb249fSBvbi1zY3JvbGwgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB3aGVuIHRoZSBjb250ZW50IGlzIHNjcm9sbGVkLgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXNjcm9sbC1jb21wbGV0ZSBFeHByZXNzaW9uIHRvIGV2YWx1YXRlIHdoZW4gYSBzY3JvbGwgYWN0aW9uIGNvbXBsZXRlcy4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBoYXMtYm91bmNpbmcgV2hldGhlciB0byBhbGxvdyBzY3JvbGxpbmcgdG8gYm91bmNlIHBhc3QgdGhlIGVkZ2VzCiAgICogb2YgdGhlIGNvbnRlbnQuICBEZWZhdWx0cyB0byB0cnVlIG9uIGlPUywgZmFsc2Ugb24gQW5kcm9pZC4KICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uQ29udGVudCcsIFsKICAgICAgJyR0aW1lb3V0JywKICAgICAgJyRjb250cm9sbGVyJywKICAgICAgJyRpb25pY0JpbmQnLAogICAgICBmdW5jdGlvbigkdGltZW91dCwgJGNvbnRyb2xsZXIsICRpb25pY0JpbmQpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgIHJlcXVpcmU6ICdeP2lvbk5hdlZpZXcnLAogICAgICAgICAgc2NvcGU6IHRydWUsCiAgICAgICAgICBwcmlvcml0eTogODAwLAogICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICB2YXIgaW5uZXJFbGVtZW50OwoKICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnc2Nyb2xsLWNvbnRlbnQgaW9uaWMtc2Nyb2xsJyk7CgogICAgICAgICAgICBpZiAoYXR0ci5zY3JvbGwgIT0gJ2ZhbHNlJykgewogICAgICAgICAgICAgIC8vV2UgY2Fubm90IHVzZSBub3JtYWwgdHJhbnNjbHVkZSBoZXJlIGJlY2F1c2UgaXQgYnJlYWtzIGVsZW1lbnQuZGF0YSgpCiAgICAgICAgICAgICAgLy9pbmhlcml0YW5jZSBvbiBjb21waWxlCiAgICAgICAgICAgICAgaW5uZXJFbGVtZW50ID0ganFMaXRlKCc8ZGl2IGNsYXNzPSJzY3JvbGwiPjwvZGl2PicpOwogICAgICAgICAgICAgIGlubmVyRWxlbWVudC5hcHBlbmQoZWxlbWVudC5jb250ZW50cygpKTsKICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZChpbm5lckVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3Njcm9sbC1jb250ZW50LWZhbHNlJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7IHByZTogcHJlbGluayB9OwogICAgICAgICAgICBmdW5jdGlvbiBwcmVsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBuYXZWaWV3Q3RybCkgewogICAgICAgICAgICAgIHZhciBwYXJlbnRTY29wZSA9ICRzY29wZS4kcGFyZW50OwogICAgICAgICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKHBhcmVudFNjb3BlLiRoYXNIZWFkZXIgPyAnIGhhcy1oZWFkZXInIDogJycpICArCiAgICAgICAgICAgICAgICAgIChwYXJlbnRTY29wZS4kaGFzU3ViaGVhZGVyID8gJyBoYXMtc3ViaGVhZGVyJyA6ICcnKSArCiAgICAgICAgICAgICAgICAgIChwYXJlbnRTY29wZS4kaGFzRm9vdGVyID8gJyBoYXMtZm9vdGVyJyA6ICcnKSArCiAgICAgICAgICAgICAgICAgIChwYXJlbnRTY29wZS4kaGFzU3ViZm9vdGVyID8gJyBoYXMtc3ViZm9vdGVyJyA6ICcnKSArCiAgICAgICAgICAgICAgICAgIChwYXJlbnRTY29wZS4kaGFzVGFicyA/ICcgaGFzLXRhYnMnIDogJycpICsKICAgICAgICAgICAgICAgICAgKHBhcmVudFNjb3BlLiRoYXNUYWJzVG9wID8gJyBoYXMtdGFicy10b3AnIDogJycpOwogICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGNsYXNzTmFtZSwgb2xkQ2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5yZW1vdmVDbGFzcyhvbGRDbGFzc05hbWUpOwogICAgICAgICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgLy9Pbmx5IHRoaXMgaW9uQ29udGVudCBzaG91bGQgdXNlIHRoZXNlIHZhcmlhYmxlcyBmcm9tIHBhcmVudCBzY29wZXMKICAgICAgICAgICAgICAkc2NvcGUuJGhhc0hlYWRlciA9ICRzY29wZS4kaGFzU3ViaGVhZGVyID0KICAgICAgICAgICAgICAgICRzY29wZS4kaGFzRm9vdGVyID0gJHNjb3BlLiRoYXNTdWJmb290ZXIgPQogICAgICAgICAgICAgICAgICAkc2NvcGUuJGhhc1RhYnMgPSAkc2NvcGUuJGhhc1RhYnNUb3AgPQogICAgICAgICAgICAgICAgICAgIGZhbHNlOwogICAgICAgICAgICAgICRpb25pY0JpbmQoJHNjb3BlLCAkYXR0ciwgewogICAgICAgICAgICAgICAgJG9uU2Nyb2xsOiAnJm9uU2Nyb2xsJywKICAgICAgICAgICAgICAgICRvblNjcm9sbENvbXBsZXRlOiAnJm9uU2Nyb2xsQ29tcGxldGUnLAogICAgICAgICAgICAgICAgaGFzQm91bmNpbmc6ICdAJywKICAgICAgICAgICAgICAgIHBhZGRpbmc6ICdAJywKICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogJ0AnLAogICAgICAgICAgICAgICAgc2Nyb2xsYmFyWDogJ0AnLAogICAgICAgICAgICAgICAgc2Nyb2xsYmFyWTogJ0AnLAogICAgICAgICAgICAgICAgc3RhcnRYOiAnQCcsCiAgICAgICAgICAgICAgICBzdGFydFk6ICdAJywKICAgICAgICAgICAgICAgIHNjcm9sbEV2ZW50SW50ZXJ2YWw6ICdAJwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICRzY29wZS5kaXJlY3Rpb24gPSAkc2NvcGUuZGlyZWN0aW9uIHx8ICd5JzsKCiAgICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRyLnBhZGRpbmcpKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuJHdhdGNoKCRhdHRyLnBhZGRpbmcsIGZ1bmN0aW9uKG5ld1ZhbCkgewogICAgICAgICAgICAgICAgICAoaW5uZXJFbGVtZW50IHx8ICRlbGVtZW50KS50b2dnbGVDbGFzcygncGFkZGluZycsICEhbmV3VmFsKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKCRhdHRyLnNjcm9sbCA9PT0gImZhbHNlIikgewogICAgICAgICAgICAgICAgLy9kbyBub3RoaW5nCiAgICAgICAgICAgICAgfSBlbHNlIGlmKGF0dHIub3ZlcmZsb3dTY3JvbGwgPT09ICJ0cnVlIikgewogICAgICAgICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoJ292ZXJmbG93LXNjcm9sbCcpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkY29udHJvbGxlcignJGlvbmljU2Nyb2xsJywgewogICAgICAgICAgICAgICAgICAkc2NvcGU6ICRzY29wZSwKICAgICAgICAgICAgICAgICAgc2Nyb2xsVmlld09wdGlvbnM6IHsKICAgICAgICAgICAgICAgICAgICBlbDogJGVsZW1lbnRbMF0sCiAgICAgICAgICAgICAgICAgICAgZGVsZWdhdGVIYW5kbGU6IGF0dHIuZGVsZWdhdGVIYW5kbGUsCiAgICAgICAgICAgICAgICAgICAgYm91bmNpbmc6ICRzY29wZS4kZXZhbCgkc2NvcGUuaGFzQm91bmNpbmcpLAogICAgICAgICAgICAgICAgICAgIHN0YXJ0WDogJHNjb3BlLiRldmFsKCRzY29wZS5zdGFydFgpIHx8IDAsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRZOiAkc2NvcGUuJGV2YWwoJHNjb3BlLnN0YXJ0WSkgfHwgMCwKICAgICAgICAgICAgICAgICAgICBzY3JvbGxiYXJYOiAkc2NvcGUuJGV2YWwoJHNjb3BlLnNjcm9sbGJhclgpICE9PSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBzY3JvbGxiYXJZOiAkc2NvcGUuJGV2YWwoJHNjb3BlLnNjcm9sbGJhclkpICE9PSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBzY3JvbGxpbmdYOiAkc2NvcGUuZGlyZWN0aW9uLmluZGV4T2YoJ3gnKSA+PSAwLAogICAgICAgICAgICAgICAgICAgIHNjcm9sbGluZ1k6ICRzY29wZS5kaXJlY3Rpb24uaW5kZXhPZigneScpID49IDAsCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsRXZlbnRJbnRlcnZhbDogcGFyc2VJbnQoJHNjb3BlLnNjcm9sbEV2ZW50SW50ZXJ2YWwsIDEwKSB8fCAxMCwKICAgICAgICAgICAgICAgICAgICBzY3JvbGxpbmdDb21wbGV0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAkc2NvcGUuJG9uU2Nyb2xsQ29tcGxldGUoewogICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxUb3A6IHRoaXMuX19zY3JvbGxUb3AsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbExlZnQ6IHRoaXMuX19zY3JvbGxMZWZ0CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XSk7CgogIHZhciBHRVNUVVJFX0RJUkVDVElWRVMgPSAnb25Ib2xkIG9uVGFwIG9uVG91Y2ggb25SZWxlYXNlIG9uRHJhZyBvbkRyYWdVcCBvbkRyYWdSaWdodCBvbkRyYWdEb3duIG9uRHJhZ0xlZnQgb25Td2lwZSBvblN3aXBlVXAgb25Td2lwZVJpZ2h0IG9uU3dpcGVEb3duIG9uU3dpcGVMZWZ0Jy5zcGxpdCgnICcpOwoKICBHRVNUVVJFX0RJUkVDVElWRVMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICBJb25pY01vZHVsZS5kaXJlY3RpdmUobmFtZSwgZ2VzdHVyZURpcmVjdGl2ZShuYW1lKSk7CiAgfSk7CgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgb25Ib2xkCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUb3VjaCBzdGF5cyBhdCB0aGUgc2FtZSBsb2NhdGlvbiBmb3IgNTAwbXMuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGJ1dHRvbiBvbi1ob2xkPSJvbkhvbGQoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogICAqIGBgYAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG9uVGFwCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBRdWljayB0b3VjaCBhdCBhIGxvY2F0aW9uLiBJZiB0aGUgZHVyYXRpb24gb2YgdGhlIHRvdWNoIGdvZXMKICAgKiBsb25nZXIgdGhhbiAyNTBtcyBpdCBpcyBubyBsb25nZXIgYSB0YXAgZ2VzdHVyZS4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8YnV0dG9uIG9uLXRhcD0ib25UYXAoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogICAqIGBgYAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG9uVG91Y2gKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENhbGxlZCBpbW1lZGlhdGVseSB3aGVuIHRoZSB1c2VyIGZpcnN0IGJlZ2lucyBhIHRvdWNoLiBUaGlzCiAgICogZ2VzdHVyZSBkb2VzIG5vdCB3YWl0IGZvciBhIHRvdWNoZW5kL21vdXNldXAuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGJ1dHRvbiBvbi10b3VjaD0ib25Ub3VjaCgpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgb25SZWxlYXNlCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYWxsZWQgd2hlbiB0aGUgdXNlciBlbmRzIGEgdG91Y2guCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGJ1dHRvbiBvbi1yZWxlYXNlPSJvblJlbGVhc2UoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogICAqIGBgYAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG9uRHJhZwogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgQQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogTW92ZSB3aXRoIG9uZSB0b3VjaCBhcm91bmQgb24gdGhlIHBhZ2UuIEJsb2NraW5nIHRoZSBzY3JvbGxpbmcgd2hlbgogICAqIG1vdmluZyBsZWZ0IGFuZCByaWdodCBpcyBhIGdvb2QgcHJhY3RpY2UuIFdoZW4gYWxsIHRoZSBkcmFnIGV2ZW50cyBhcmUKICAgKiBibG9ja2luZyB5b3UgZGlzYWJsZSBzY3JvbGxpbmcgb24gdGhhdCBhcmVhLgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxidXR0b24gb24tZHJhZz0ib25EcmFnKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICAgKiBgYGAKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBvbkRyYWdVcAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgQQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2FsbGVkIHdoZW4gdGhlIGVsZW1lbnQgaXMgZHJhZ2dlZCB1cC4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8YnV0dG9uIG9uLWRyYWctdXA9Im9uRHJhZ1VwKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICAgKiBgYGAKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBvbkRyYWdSaWdodAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgQQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2FsbGVkIHdoZW4gdGhlIGVsZW1lbnQgaXMgZHJhZ2dlZCB0byB0aGUgcmlnaHQuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGJ1dHRvbiBvbi1kcmFnLXJpZ2h0PSJvbkRyYWdSaWdodCgpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgb25EcmFnRG93bgogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgQQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2FsbGVkIHdoZW4gdGhlIGVsZW1lbnQgaXMgZHJhZ2dlZCBkb3duLgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxidXR0b24gb24tZHJhZy1kb3duPSJvbkRyYWdEb3duKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICAgKiBgYGAKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBvbkRyYWdMZWZ0CiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYWxsZWQgd2hlbiB0aGUgZWxlbWVudCBpcyBkcmFnZ2VkIHRvIHRoZSBsZWZ0LgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxidXR0b24gb24tZHJhZy1sZWZ0PSJvbkRyYWdMZWZ0KCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICAgKiBgYGAKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBvblN3aXBlCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYWxsZWQgd2hlbiBhIG1vdmluZyB0b3VjaCBoYXMgYSBoaWdoIHZlbG9jaXR5IGluIGFueSBkaXJlY3Rpb24uCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGJ1dHRvbiBvbi1zd2lwZT0ib25Td2lwZSgpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgb25Td2lwZVVwCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYWxsZWQgd2hlbiBhIG1vdmluZyB0b3VjaCBoYXMgYSBoaWdoIHZlbG9jaXR5IG1vdmluZyB1cC4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8YnV0dG9uIG9uLXN3aXBlLXVwPSJvblN3aXBlVXAoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogICAqIGBgYAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG9uU3dpcGVSaWdodAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgQQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2FsbGVkIHdoZW4gYSBtb3ZpbmcgdG91Y2ggaGFzIGEgaGlnaCB2ZWxvY2l0eSBtb3ZpbmcgdG8gdGhlIHJpZ2h0LgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxidXR0b24gb24tc3dpcGUtcmlnaHQ9Im9uU3dpcGVSaWdodCgpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgb25Td2lwZURvd24KICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENhbGxlZCB3aGVuIGEgbW92aW5nIHRvdWNoIGhhcyBhIGhpZ2ggdmVsb2NpdHkgbW92aW5nIGRvd24uCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGJ1dHRvbiBvbi1zd2lwZS1kb3duPSJvblN3aXBlRG93bigpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgb25Td2lwZUxlZnQKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENhbGxlZCB3aGVuIGEgbW92aW5nIHRvdWNoIGhhcyBhIGhpZ2ggdmVsb2NpdHkgbW92aW5nIHRvIHRoZSBsZWZ0LgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxidXR0b24gb24tc3dpcGUtbGVmdD0ib25Td2lwZUxlZnQoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogICAqIGBgYAogICAqLwoKCiAgZnVuY3Rpb24gZ2VzdHVyZURpcmVjdGl2ZShkaXJlY3RpdmVOYW1lKSB7CiAgICByZXR1cm4gWyckaW9uaWNHZXN0dXJlJywgJyRwYXJzZScsIGZ1bmN0aW9uKCRpb25pY0dlc3R1cmUsICRwYXJzZSkgewogICAgICB2YXIgZXZlbnRUeXBlID0gZGlyZWN0aXZlTmFtZS5zdWJzdHIoMikudG9Mb3dlckNhc2UoKTsKCiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHZhciBmbiA9ICRwYXJzZSggYXR0cltkaXJlY3RpdmVOYW1lXSApOwoKICAgICAgICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbihldikgewogICAgICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmbihzY29wZSwgewogICAgICAgICAgICAgICRldmVudDogZXYKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICB2YXIgZ2VzdHVyZSA9ICRpb25pY0dlc3R1cmUub24oZXZlbnRUeXBlLCBsaXN0ZW5lciwgZWxlbWVudCk7CgogICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICRpb25pY0dlc3R1cmUub2ZmKGdlc3R1cmUsIGV2ZW50VHlwZSwgbGlzdGVuZXIpOwogICAgICAgIH0pOwogICAgICB9OwogICAgfV07CiAgfQoKCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvbk5hdkJhcicsIHRhcFNjcm9sbFRvVG9wRGlyZWN0aXZlKCkpCiAgICAuZGlyZWN0aXZlKCdpb25IZWFkZXJCYXInLCB0YXBTY3JvbGxUb1RvcERpcmVjdGl2ZSgpKQoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgaW9uSGVhZGVyQmFyCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBFCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBZGRzIGEgZml4ZWQgaGVhZGVyIGJhciBhYm92ZSBzb21lIGNvbnRlbnQuCiAgICoKICAgKiBDYW4gYWxzbyBiZSBhIHN1YmhlYWRlciAobG93ZXIgZG93bikgaWYgdGhlICdiYXItc3ViaGVhZGVyJyBjbGFzcyBpcyBhcHBsaWVkLgogICAqIFNlZSBbdGhlIGhlYWRlciBDU1MgZG9jc10oL2RvY3MvY29tcG9uZW50cy8jc3ViaGVhZGVyKS4KICAgKgogICAqIE5vdGU6IElmIHlvdSB1c2UgaW9uSGVhZGVyQmFyIGluIGNvbWJpbmF0aW9uIHdpdGggbmctaWYsIHRoZSBzdXJyb3VuZGluZyBjb250ZW50CiAgICogd2lsbCBub3QgYWxpZ24gY29ycmVjdGx5LiAgVGhpcyB3aWxsIGJlIGZpeGVkIHNvb24uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IGFsaWduLXRpdGxlIFdoZXJlIHRvIGFsaWduIHRoZSB0aXRsZS4KICAgKiBBdmFpbGFibGU6ICdsZWZ0JywgJ3JpZ2h0Jywgb3IgJ2NlbnRlcicuICBEZWZhdWx0cyB0byAnY2VudGVyJy4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBuby10YXAtc2Nyb2xsIEJ5IGRlZmF1bHQsIHRoZSBoZWFkZXIgYmFyIHdpbGwgc2Nyb2xsIHRoZQogICAqIGNvbnRlbnQgdG8gdGhlIHRvcCB3aGVuIHRhcHBlZC4gIFNldCBuby10YXAtc2Nyb2xsIHRvIHRydWUgdG8gZGlzYWJsZSB0aGlzCiAgICogYmVoYXZpb3IuCiAgICogQXZhaWxhYmxlOiB0cnVlIG9yIGZhbHNlLiAgRGVmYXVsdHMgdG8gZmFsc2UuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGlvbi1oZWFkZXItYmFyIGFsaWduLXRpdGxlPSJsZWZ0IiBjbGFzcz0iYmFyLXBvc2l0aXZlIj4KICAgKiAgIDxkaXYgY2xhc3M9ImJ1dHRvbnMiPgogICAqICAgICA8YnV0dG9uIGNsYXNzPSJidXR0b24iIG5nLWNsaWNrPSJkb1NvbWV0aGluZygpIj5MZWZ0IEJ1dHRvbjwvYnV0dG9uPgogICAqICAgPC9kaXY+CiAgICogICA8aDEgY2xhc3M9InRpdGxlIj5UaXRsZSE8L2gxPgogICAqICAgPGRpdiBjbGFzcz0iYnV0dG9ucyI+CiAgICogICAgIDxidXR0b24gY2xhc3M9ImJ1dHRvbiI+UmlnaHQgQnV0dG9uPC9idXR0b24+CiAgICogICA8L2Rpdj4KICAgKiA8L2lvbi1oZWFkZXItYmFyPgogICAqIDxpb24tY29udGVudD4KICAgKiAgIFNvbWUgY29udGVudCEKICAgKiA8L2lvbi1jb250ZW50PgogICAqIGBgYAogICAqLwogICAgLmRpcmVjdGl2ZSgnaW9uSGVhZGVyQmFyJywgaGVhZGVyRm9vdGVyQmFyRGlyZWN0aXZlKHRydWUpKQoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgaW9uRm9vdGVyQmFyCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBFCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBZGRzIGEgZml4ZWQgZm9vdGVyIGJhciBiZWxvdyBzb21lIGNvbnRlbnQuCiAgICoKICAgKiBDYW4gYWxzbyBiZSBhIHN1YmZvb3RlciAoaGlnaGVyIHVwKSBpZiB0aGUgJ2Jhci1zdWJmb290ZXInIGNsYXNzIGlzIGFwcGxpZWQuCiAgICogU2VlIFt0aGUgZm9vdGVyIENTUyBkb2NzXSgvZG9jcy9jb21wb25lbnRzLyNmb290ZXIpLgogICAqCiAgICogTm90ZTogSWYgeW91IHVzZSBpb25Gb290ZXJCYXIgaW4gY29tYmluYXRpb24gd2l0aCBuZy1pZiwgdGhlIHN1cnJvdW5kaW5nIGNvbnRlbnQKICAgKiB3aWxsIG5vdCBhbGlnbiBjb3JyZWN0bHkuICBUaGlzIHdpbGwgYmUgZml4ZWQgc29vbi4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gYWxpZ24tdGl0bGUgV2hlcmUgdG8gYWxpZ24gdGhlIHRpdGxlLgogICAqIEF2YWlsYWJsZTogJ2xlZnQnLCAncmlnaHQnLCBvciAnY2VudGVyJy4gIERlZmF1bHRzIHRvICdjZW50ZXInLgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxpb24tY29udGVudD4KICAgKiAgIFNvbWUgY29udGVudCEKICAgKiA8L2lvbi1jb250ZW50PgogICAqIDxpb24tZm9vdGVyLWJhciBhbGlnbi10aXRsZT0ibGVmdCIgY2xhc3M9ImJhci1hc3NlcnRpdmUiPgogICAqICAgPGRpdiBjbGFzcz0iYnV0dG9ucyI+CiAgICogICAgIDxidXR0b24gY2xhc3M9ImJ1dHRvbiI+TGVmdCBCdXR0b248L2J1dHRvbj4KICAgKiAgIDwvZGl2PgogICAqICAgPGgxIGNsYXNzPSJ0aXRsZSI+VGl0bGUhPC9oMT4KICAgKiAgIDxkaXYgY2xhc3M9ImJ1dHRvbnMiIG5nLWNsaWNrPSJkb1NvbWV0aGluZygpIj4KICAgKiAgICAgPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIj5SaWdodCBCdXR0b248L2J1dHRvbj4KICAgKiAgIDwvZGl2PgogICAqIDwvaW9uLWZvb3Rlci1iYXI+CiAgICogYGBgCiAgICovCiAgICAuZGlyZWN0aXZlKCdpb25Gb290ZXJCYXInLCBoZWFkZXJGb290ZXJCYXJEaXJlY3RpdmUoZmFsc2UpKTsKCiAgZnVuY3Rpb24gdGFwU2Nyb2xsVG9Ub3BEaXJlY3RpdmUoKSB7CiAgICByZXR1cm4gWyckaW9uaWNTY3JvbGxEZWxlZ2F0ZScsIGZ1bmN0aW9uKCRpb25pY1Njcm9sbERlbGVnYXRlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cikgewogICAgICAgICAgaWYgKCRhdHRyLm5vVGFwU2Nyb2xsID09ICd0cnVlJykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpb25pYy5vbigndGFwJywgb25UYXAsICRlbGVtZW50WzBdKTsKICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlvbmljLm9mZigndGFwJywgb25UYXAsICRlbGVtZW50WzBdKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGZ1bmN0aW9uIG9uVGFwKGUpIHsKICAgICAgICAgICAgdmFyIGRlcHRoID0gMzsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBlLnRhcmdldDsKICAgICAgICAgICAgLy9Eb24ndCBzY3JvbGwgdG8gdG9wIGluIGNlcnRhaW4gY2FzZXMKICAgICAgICAgICAgd2hpbGUgKGRlcHRoLS0gJiYgY3VycmVudCkgewogICAgICAgICAgICAgIGlmIChjdXJyZW50LmNsYXNzTGlzdC5jb250YWlucygnYnV0dG9uJykgfHwKICAgICAgICAgICAgICAgIGN1cnJlbnQudGFnTmFtZS5tYXRjaCgvaW5wdXR8dGV4dGFyZWF8c2VsZWN0L2kpIHx8CiAgICAgICAgICAgICAgICBjdXJyZW50LmlzQ29udGVudEVkaXRhYmxlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50LnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRvdWNoID0gZS5nZXN0dXJlICYmIGUuZ2VzdHVyZS50b3VjaGVzWzBdIHx8IGUuZGV0YWlsLnRvdWNoZXNbMF07CiAgICAgICAgICAgIHZhciBib3VuZHMgPSAkZWxlbWVudFswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgICAgaWYgKGlvbmljLkRvbVV0aWwucmVjdENvbnRhaW5zKAogICAgICAgICAgICAgIHRvdWNoLnBhZ2VYLCB0b3VjaC5wYWdlWSwKICAgICAgICAgICAgICBib3VuZHMubGVmdCwgYm91bmRzLnRvcCAtIDIwLAogICAgICAgICAgICAgICAgYm91bmRzLmxlZnQgKyBib3VuZHMud2lkdGgsIGJvdW5kcy50b3AgKyBib3VuZHMuaGVpZ2h0CiAgICAgICAgICAgICkpIHsKICAgICAgICAgICAgICAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS5zY3JvbGxUb3AodHJ1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9XTsKICB9CgogIGZ1bmN0aW9uIGhlYWRlckZvb3RlckJhckRpcmVjdGl2ZShpc0hlYWRlcikgewogICAgcmV0dXJuIFtmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cikgewogICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoaXNIZWFkZXIgPyAnYmFyIGJhci1oZWFkZXInIDogJ2JhciBiYXItZm9vdGVyJyk7CiAgICAgICAgICB2YXIgcGFyZW50ID0gJGVsZW1lbnRbMF0ucGFyZW50Tm9kZTsKICAgICAgICAgIGlmKHBhcmVudC5xdWVyeVNlbGVjdG9yKCcudGFicy10b3AnKSkkZWxlbWVudC5hZGRDbGFzcygnaGFzLXRhYnMtdG9wJyk7CiAgICAgICAgICByZXR1cm4geyBwcmU6IHByZWxpbmsgfTsKICAgICAgICAgIGZ1bmN0aW9uIHByZWxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIpIHsKICAgICAgICAgICAgdmFyIGhiID0gbmV3IGlvbmljLnZpZXdzLkhlYWRlckJhcih7CiAgICAgICAgICAgICAgZWw6ICRlbGVtZW50WzBdLAogICAgICAgICAgICAgIGFsaWduVGl0bGU6ICRhdHRyLmFsaWduVGl0bGUgfHwgJ2NlbnRlcicKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB2YXIgZWwgPSAkZWxlbWVudFswXTsKCiAgICAgICAgICAgIGlmIChpc0hlYWRlcikgewogICAgICAgICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7IHJldHVybiBlbC5jbGFzc05hbWU7IH0sIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNTaG93biA9IHZhbHVlLmluZGV4T2YoJ25nLWhpZGUnKSA9PT0gLTE7CiAgICAgICAgICAgICAgICB2YXIgaXNTdWJoZWFkZXIgPSB2YWx1ZS5pbmRleE9mKCdiYXItc3ViaGVhZGVyJykgIT09IC0xOwogICAgICAgICAgICAgICAgJHNjb3BlLiRoYXNIZWFkZXIgPSBpc1Nob3duICYmICFpc1N1YmhlYWRlcjsKICAgICAgICAgICAgICAgICRzY29wZS4kaGFzU3ViaGVhZGVyID0gaXNTaG93biAmJiBpc1N1YmhlYWRlcjsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZGVsZXRlICRzY29wZS4kaGFzSGVhZGVyOwogICAgICAgICAgICAgICAgZGVsZXRlICRzY29wZS4kaGFzU3ViaGVhZGVyOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7IHJldHVybiBlbC5jbGFzc05hbWU7IH0sIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNTaG93biA9IHZhbHVlLmluZGV4T2YoJ25nLWhpZGUnKSA9PT0gLTE7CiAgICAgICAgICAgICAgICB2YXIgaXNTdWJmb290ZXIgPSB2YWx1ZS5pbmRleE9mKCdiYXItc3ViZm9vdGVyJykgIT09IC0xOwogICAgICAgICAgICAgICAgJHNjb3BlLiRoYXNGb290ZXIgPSBpc1Nob3duICYmICFpc1N1YmZvb3RlcjsKICAgICAgICAgICAgICAgICRzY29wZS4kaGFzU3ViZm9vdGVyID0gaXNTaG93biAmJiBpc1N1YmZvb3RlcjsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZGVsZXRlICRzY29wZS4kaGFzRm9vdGVyOwogICAgICAgICAgICAgICAgZGVsZXRlICRzY29wZS4kaGFzU3ViZm9vdGVyOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICRzY29wZS4kd2F0Y2goJyRoYXNUYWJzJywgZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC50b2dnbGVDbGFzcygnaGFzLXRhYnMnLCAhIXZhbCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9XTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25JbmZpbml0ZVNjcm9sbAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25Db250ZW50LCBpb25pYy5kaXJlY3RpdmU6aW9uU2Nyb2xsCiAgICogQHJlc3RyaWN0IEUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBpb25JbmZpbml0ZVNjcm9sbCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBjYWxsIGEgZnVuY3Rpb24gd2hlbmV2ZXIKICAgKiB0aGUgdXNlciBnZXRzIHRvIHRoZSBib3R0b20gb2YgdGhlIHBhZ2Ugb3IgbmVhciB0aGUgYm90dG9tIG9mIHRoZSBwYWdlLgogICAqCiAgICogVGhlIGV4cHJlc3Npb24geW91IHBhc3MgaW4gZm9yIGBvbi1pbmZpbml0ZWAgaXMgY2FsbGVkIHdoZW4gdGhlIHVzZXIgc2Nyb2xscwogICAqIGdyZWF0ZXIgdGhhbiBgZGlzdGFuY2VgIGF3YXkgZnJvbSB0aGUgYm90dG9tIG9mIHRoZSBjb250ZW50LiAgT25jZSBgb24taW5maW5pdGVgCiAgICogaXMgZG9uZSBsb2FkaW5nIG5ldyBkYXRhLCBpdCBzaG91bGQgYnJvYWRjYXN0IHRoZSBgc2Nyb2xsLmluZmluaXRlU2Nyb2xsQ29tcGxldGVgCiAgICogZXZlbnQgZnJvbSB5b3VyIGNvbnRyb2xsZXIgKHNlZSBiZWxvdyBleGFtcGxlKS4KICAgKgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gb24taW5maW5pdGUgV2hhdCB0byBjYWxsIHdoZW4gdGhlIHNjcm9sbGVyIHJlYWNoZXMgdGhlCiAgICogYm90dG9tLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gZGlzdGFuY2UgVGhlIGRpc3RhbmNlIGZyb20gdGhlIGJvdHRvbSB0aGF0IHRoZSBzY3JvbGwgbXVzdAogICAqIHJlYWNoIHRvIHRyaWdnZXIgdGhlIG9uLWluZmluaXRlIGV4cHJlc3Npb24uIERlZmF1bHQ6IDElLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gaWNvbiBUaGUgaWNvbiB0byBzaG93IHdoaWxlIGxvYWRpbmcuIERlZmF1bHQ6ICdpb24tbG9hZGluZy1kJy4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8aW9uLWNvbnRlbnQgbmctY29udHJvbGxlcj0iTXlDb250cm9sbGVyIj4KICAgKiAgIDxpb24taW5maW5pdGUtc2Nyb2xsCiAgICogICAgIG9uLWluZmluaXRlPSJsb2FkTW9yZSgpIgogICAqICAgICBkaXN0YW5jZT0iMSUiPgogICAqICAgPC9pb24taW5maW5pdGUtc2Nyb2xsPgogICAqIDwvaW9uLWNvbnRlbnQ+CiAgICogYGBgCiAgICogYGBganMKICAgKiBmdW5jdGlvbiBNeUNvbnRyb2xsZXIoJHNjb3BlLCAkaHR0cCkgewogKiAgICRzY29wZS5pdGVtcyA9IFtdOwogKiAgICRzY29wZS5sb2FkTW9yZSA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGh0dHAuZ2V0KCcvbW9yZS1pdGVtcycpLnN1Y2Nlc3MoZnVuY3Rpb24oaXRlbXMpIHsKICogICAgICAgdXNlSXRlbXMoaXRlbXMpOwogKiAgICAgICAkc2NvcGUuJGJyb2FkY2FzdCgnc2Nyb2xsLmluZmluaXRlU2Nyb2xsQ29tcGxldGUnKTsKICogICAgIH0pOwogKiAgIH07CiAqCiAqICAgJHNjb3BlLiRvbignc3RhdGVDaGFuZ2VTdWNjZXNzJywgZnVuY3Rpb24oKSB7CiAqICAgICAkc2NvcGUubG9hZE1vcmUoKTsKICogICB9KTsKICogfQogICAqIGBgYAogICAqCiAgICogQW4gZWFzeSB0byB3YXkgdG8gc3RvcCBpbmZpbml0ZSBzY3JvbGwgb25jZSB0aGVyZSBpcyBubyBtb3JlIGRhdGEgdG8gbG9hZAogICAqIGlzIHRvIHVzZSBhbmd1bGFyJ3MgYG5nLWlmYCBkaXJlY3RpdmU6CiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi1pbmZpbml0ZS1zY3JvbGwKICAgKiAgIG5nLWlmPSJtb3JlRGF0YUNhbkJlTG9hZGVkKCkiCiAgICogICBpY29uPSJpb24tbG9hZGluZy1jIgogICAqICAgb24taW5maW5pdGU9ImxvYWRNb3JlRGF0YSgpIj4KICAgKiA8L2lvbi1pbmZpbml0ZS1zY3JvbGw+CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvbkluZmluaXRlU2Nyb2xsJywgWyckdGltZW91dCcsIGZ1bmN0aW9uKCR0aW1lb3V0KSB7CiAgICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZU1heFZhbHVlKGRpc3RhbmNlLCBtYXhpbXVtLCBpc1BlcmNlbnQpIHsKICAgICAgICByZXR1cm4gaXNQZXJjZW50ID8KICAgICAgICAgIG1heGltdW0gKiAoMSAtIHBhcnNlRmxvYXQoZGlzdGFuY2UsMTApIC8gMTAwKSA6CiAgICAgICAgICBtYXhpbXVtIC0gcGFyc2VGbG9hdChkaXN0YW5jZSwgMTApOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXF1aXJlOiBbJ14kaW9uaWNTY3JvbGwnLCAnaW9uSW5maW5pdGVTY3JvbGwnXSwKICAgICAgICB0ZW1wbGF0ZTogJzxpIGNsYXNzPSJpY29uIHt7aWNvbigpfX0gaWNvbi1yZWZyZXNoaW5nIj48L2k+JywKICAgICAgICBzY29wZTogdHJ1ZSwKICAgICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsICckYXR0cnMnLCBmdW5jdGlvbigkc2NvcGUsICRhdHRycykgewogICAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuc2Nyb2xsVmlldyA9IG51bGw7IC8vZ2l2ZW4gYnkgbGluayBmdW5jdGlvbgogICAgICAgICAgdGhpcy5nZXRNYXhTY3JvbGwgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGRpc3RhbmNlID0gKCRhdHRycy5kaXN0YW5jZSB8fCAnMi41JScpLnRyaW0oKTsKICAgICAgICAgICAgdmFyIGlzUGVyY2VudCA9IGRpc3RhbmNlLmluZGV4T2YoJyUnKSAhPT0gLTE7CiAgICAgICAgICAgIHZhciBtYXhWYWx1ZXMgPSB0aGlzLnNjcm9sbFZpZXcuZ2V0U2Nyb2xsTWF4KCk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbGVmdDogdGhpcy5zY3JvbGxWaWV3Lm9wdGlvbnMuc2Nyb2xsaW5nWCA/CiAgICAgICAgICAgICAgICBjYWxjdWxhdGVNYXhWYWx1ZShkaXN0YW5jZSwgbWF4VmFsdWVzLmxlZnQsIGlzUGVyY2VudCkgOgogICAgICAgICAgICAgICAgLTEsCiAgICAgICAgICAgICAgdG9wOiB0aGlzLnNjcm9sbFZpZXcub3B0aW9ucy5zY3JvbGxpbmdZID8KICAgICAgICAgICAgICAgIGNhbGN1bGF0ZU1heFZhbHVlKGRpc3RhbmNlLCBtYXhWYWx1ZXMudG9wLCBpc1BlcmNlbnQpIDoKICAgICAgICAgICAgICAgIC0xCiAgICAgICAgICAgIH07CiAgICAgICAgICB9OwogICAgICAgIH1dLAogICAgICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgY3RybHMpIHsKICAgICAgICAgIHZhciBzY3JvbGxDdHJsID0gY3RybHNbMF07CiAgICAgICAgICB2YXIgaW5maW5pdGVTY3JvbGxDdHJsID0gY3RybHNbMV07CiAgICAgICAgICB2YXIgc2Nyb2xsVmlldyA9IGluZmluaXRlU2Nyb2xsQ3RybC5zY3JvbGxWaWV3ID0gc2Nyb2xsQ3RybC5zY3JvbGxWaWV3OwoKICAgICAgICAgICRzY29wZS5pY29uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBhbmd1bGFyLmlzRGVmaW5lZCgkYXR0cnMuaWNvbikgPyAkYXR0cnMuaWNvbiA6ICdpb24tbG9hZGluZy1kJzsKICAgICAgICAgIH07CgogICAgICAgICAgdmFyIG9uSW5maW5pdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgJGVsZW1lbnRbMF0uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgIGluZmluaXRlU2Nyb2xsQ3RybC5pc0xvYWRpbmcgPSB0cnVlOwogICAgICAgICAgICAkc2NvcGUuJHBhcmVudCAmJiAkc2NvcGUuJHBhcmVudC4kYXBwbHkoJGF0dHJzLm9uSW5maW5pdGUgfHwgJycpOwogICAgICAgICAgfTsKCiAgICAgICAgICB2YXIgZmluaXNoSW5maW5pdGVTY3JvbGwgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgJGVsZW1lbnRbMF0uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNjcm9sbFZpZXcucmVzaXplKCk7CiAgICAgICAgICAgICAgY2hlY2tCb3VuZHMoKTsKICAgICAgICAgICAgfSwgMCwgZmFsc2UpOwogICAgICAgICAgICBpbmZpbml0ZVNjcm9sbEN0cmwuaXNMb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICB9OwoKICAgICAgICAgICRzY29wZS4kb24oJ3Njcm9sbC5pbmZpbml0ZVNjcm9sbENvbXBsZXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZpbmlzaEluZmluaXRlU2Nyb2xsKCk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzY3JvbGxDdHJsLiRlbGVtZW50Lm9mZignc2Nyb2xsJywgY2hlY2tCb3VuZHMpOwogICAgICAgICAgfSk7CgogICAgICAgICAgdmFyIGNoZWNrQm91bmRzID0gaW9uaWMuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZShjaGVja0luZmluaXRlQm91bmRzKTsKCiAgICAgICAgICAvL0NoZWNrIGJvdW5kcyBvbiBzdGFydCwgYWZ0ZXIgc2Nyb2xsVmlldyBpcyBmdWxseSByZW5kZXJlZAogICAgICAgICAgc2V0VGltZW91dChjaGVja0JvdW5kcyk7CiAgICAgICAgICBzY3JvbGxDdHJsLiRlbGVtZW50Lm9uKCdzY3JvbGwnLCBjaGVja0JvdW5kcyk7CgogICAgICAgICAgZnVuY3Rpb24gY2hlY2tJbmZpbml0ZUJvdW5kcygpIHsKICAgICAgICAgICAgaWYgKGluZmluaXRlU2Nyb2xsQ3RybC5pc0xvYWRpbmcpIHJldHVybjsKCiAgICAgICAgICAgIHZhciBzY3JvbGxWYWx1ZXMgPSBzY3JvbGxWaWV3LmdldFZhbHVlcygpOwogICAgICAgICAgICB2YXIgbWF4U2Nyb2xsID0gaW5maW5pdGVTY3JvbGxDdHJsLmdldE1heFNjcm9sbCgpOwoKICAgICAgICAgICAgaWYgKChtYXhTY3JvbGwubGVmdCAhPT0gLTEgJiYgc2Nyb2xsVmFsdWVzLmxlZnQgPj0gbWF4U2Nyb2xsLmxlZnQpIHx8CiAgICAgICAgICAgICAgKG1heFNjcm9sbC50b3AgIT09IC0xICYmIHNjcm9sbFZhbHVlcy50b3AgPj0gbWF4U2Nyb2xsLnRvcCkpIHsKICAgICAgICAgICAgICBvbkluZmluaXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9XSk7CgogIHZhciBJVEVNX1RQTF9DT05URU5UX0FOQ0hPUiA9CiAgICAnPGEgY2xhc3M9Iml0ZW0tY29udGVudCIgbmctaHJlZj0ie3skaHJlZigpfX0iIHRhcmdldD0ie3skdGFyZ2V0KCl9fSI+PC9hPic7CiAgdmFyIElURU1fVFBMX0NPTlRFTlQgPQogICAgJzxkaXYgY2xhc3M9Iml0ZW0tY29udGVudCI+PC9kaXY+JzsKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgaW9uSXRlbQogICAqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3QKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKiBDcmVhdGVzIGEgbGlzdC1pdGVtIHRoYXQgY2FuIGVhc2lseSBiZSBzd2lwZWQsCiAgICogZGVsZXRlZCwgcmVvcmRlcmVkLCBlZGl0ZWQsIGFuZCBtb3JlLgogICAqCiAgICogU2VlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdH0gZm9yIGEgY29tcGxldGUgZXhhbXBsZSAmIGV4cGxhbmF0aW9uLgogICAqCiAgICogQ2FuIGJlIGFzc2lnbmVkIGFueSBpdGVtIGNsYXNzIG5hbWUuIFNlZSB0aGUKICAgKiBbbGlzdCBDU1MgZG9jdW1lbnRhdGlvbl0oL2RvY3MvY29tcG9uZW50cy8jbGlzdCkuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLWxpc3Q+CiAgICogICA8aW9uLWl0ZW0+SGVsbG8hPC9pb24taXRlbT4KICAgKiA8L2lvbi1saXN0PgogICAqIGBgYAogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25JdGVtJywgWwogICAgICAnJGFuaW1hdGUnLAogICAgICAnJGNvbXBpbGUnLAogICAgICBmdW5jdGlvbigkYW5pbWF0ZSwgJGNvbXBpbGUpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCkgewogICAgICAgICAgICB0aGlzLiRzY29wZSA9ICRzY29wZTsKICAgICAgICAgICAgdGhpcy4kZWxlbWVudCA9ICRlbGVtZW50OwogICAgICAgICAgfV0sCiAgICAgICAgICBzY29wZTogdHJ1ZSwKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgICAgICAgdmFyIGlzQW5jaG9yID0gYW5ndWxhci5pc0RlZmluZWQoJGF0dHJzLmhyZWYpIHx8CiAgICAgICAgICAgICAgYW5ndWxhci5pc0RlZmluZWQoJGF0dHJzLm5nSHJlZikgfHwKICAgICAgICAgICAgICBhbmd1bGFyLmlzRGVmaW5lZCgkYXR0cnMudWlTcmVmKTsKICAgICAgICAgICAgdmFyIGlzQ29tcGxleEl0ZW0gPSBpc0FuY2hvciB8fAogICAgICAgICAgICAgIC8vTGFtZSB3YXkgb2YgdGVzdGluZywgYnV0IHdlIGhhdmUgdG8ga25vdyBhdCBjb21waWxlIHdoYXQgdG8gZG8gd2l0aCB0aGUgZWxlbWVudAogICAgICAgICAgICAgIC9pb24tKGRlbGV0ZXxvcHRpb258cmVvcmRlciktYnV0dG9uL2kudGVzdCgkZWxlbWVudC5odG1sKCkpOwoKICAgICAgICAgICAgaWYgKGlzQ29tcGxleEl0ZW0pIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJFbGVtZW50ID0ganFMaXRlKGlzQW5jaG9yID8gSVRFTV9UUExfQ09OVEVOVF9BTkNIT1IgOiBJVEVNX1RQTF9DT05URU5UKTsKICAgICAgICAgICAgICBpbm5lckVsZW1lbnQuYXBwZW5kKCRlbGVtZW50LmNvbnRlbnRzKCkpOwoKICAgICAgICAgICAgICAkZWxlbWVudC5hcHBlbmQoaW5uZXJFbGVtZW50KTsKICAgICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcygnaXRlbSBpdGVtLWNvbXBsZXgnKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcygnaXRlbScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgICAgICAgICAkc2NvcGUuJGhyZWYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkYXR0cnMuaHJlZiB8fCAkYXR0cnMubmdIcmVmOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgJHNjb3BlLiR0YXJnZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkYXR0cnMudGFyZ2V0IHx8ICdfc2VsZic7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XSk7CgoKICB2YXIgSVRFTV9UUExfREVMRVRFX0JVVFRPTiA9CiAgICAnPGRpdiBjbGFzcz0iaXRlbS1sZWZ0LWVkaXQgaXRlbS1kZWxldGUgZW5hYmxlLXBvaW50ZXItZXZlbnRzIj4nICsKICAgICc8L2Rpdj4nOwogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25EZWxldGVCdXR0b24KICAgKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25JdGVtCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBFCiAgICogQ3JlYXRlcyBhIGRlbGV0ZSBidXR0b24gaW5zaWRlIGEgbGlzdCBpdGVtLCB0aGF0IGlzIHZpc2libGUgd2hlbiB0aGUKICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3QgaW9uTGlzdCBwYXJlbnQnc30gYHNob3ctZGVsZXRlYCBldmFsdWF0ZXMgdG8gdHJ1ZSBvcgogICAqIGAkaW9uaWNMaXN0RGVsZWdhdGUuc2hvd0RlbGV0ZSh0cnVlKWAgaXMgY2FsbGVkLgogICAqCiAgICogVGFrZXMgYW55IGlvbmljb24gYXMgYSBjbGFzcy4KICAgKgogICAqIFNlZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3R9IGZvciBhIGNvbXBsZXRlIGV4YW1wbGUgJiBleHBsYW5hdGlvbi4KICAgKgogICAqIEB1c2FnZQogICAqCiAgICogYGBgaHRtbAogICAqIDxpb24tbGlzdCBzaG93LWRlbGV0ZT0ic2hvdWxkU2hvd0RlbGV0ZSI+CiAgICogICA8aW9uLWl0ZW0+CiAgICogICAgIDxpb24tZGVsZXRlLWJ1dHRvbiBjbGFzcz0iaW9uLW1pbnVzLWNpcmNsZWQiPjwvaW9uLWRlbGV0ZS1idXR0b24+CiAgICogICAgIEhlbGxvLCBsaXN0IGl0ZW0hCiAgICogICA8L2lvbi1pdGVtPgogICAqIDwvaW9uLWxpc3Q+CiAgICogPGlvbi10b2dnbGUgbmctbW9kZWw9InNob3VsZFNob3dEZWxldGUiPgogICAqICAgU2hvdyBEZWxldGU/CiAgICogPC9pb24tdG9nZ2xlPgogICAqIGBgYAogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25EZWxldGVCdXR0b24nLCBbJyRhbmltYXRlJywgZnVuY3Rpb24oJGFuaW1hdGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcXVpcmU6IFsnXmlvbkl0ZW0nLCAnXj9pb25MaXN0J10sCiAgICAgICAgLy9SdW4gYmVmb3JlIGFueXRoaW5nIGVsc2UsIHNvIHdlIGNhbiBtb3ZlIGl0IGJlZm9yZSBvdGhlciBkaXJlY3RpdmVzIHByb2Nlc3MKICAgICAgICAvL2l0cyBsb2NhdGlvbiAoZWcgbmdJZiByZWxpZXMgb24gdGhlIGxvY2F0aW9uIG9mIHRoZSBkaXJlY3RpdmUgaW4gdGhlIGRvbSkKICAgICAgICBwcmlvcml0eTogTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgJGF0dHIpIHsKICAgICAgICAgIC8vQWRkIHRoZSBjbGFzc2VzIHdlIG5lZWQgZHVyaW5nIHRoZSBjb21waWxlIHBoYXNlLCBzbyB0aGF0IHRoZXkgc3RheQogICAgICAgICAgLy9ldmVuIGlmIHNvbWV0aGluZyBlbHNlIGxpa2UgbmdJZiByZW1vdmVzIHRoZSBlbGVtZW50IGFuZCByZS1hZGRzcyBpdAogICAgICAgICAgJGF0dHIuJHNldCgnY2xhc3MnLCAoJGF0dHJbJ2NsYXNzJ10gfHwgJycpICsgJyBidXR0b24gaWNvbiBidXR0b24taWNvbicsIHRydWUpOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJscykgewogICAgICAgICAgICB2YXIgaXRlbUN0cmwgPSBjdHJsc1swXTsKICAgICAgICAgICAgdmFyIGxpc3RDdHJsID0gY3RybHNbMV07CiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSBqcUxpdGUoSVRFTV9UUExfREVMRVRFX0JVVFRPTik7CiAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmQoJGVsZW1lbnQpOwogICAgICAgICAgICBpdGVtQ3RybC4kZWxlbWVudC5hcHBlbmQoY29udGFpbmVyKS5hZGRDbGFzcygnaXRlbS1sZWZ0LWVkaXRhYmxlJyk7CgogICAgICAgICAgICBpZiAobGlzdEN0cmwgJiYgbGlzdEN0cmwuc2hvd0RlbGV0ZSgpKSB7CiAgICAgICAgICAgICAgY29udGFpbmVyLmFkZENsYXNzKCd2aXNpYmxlIGFjdGl2ZScpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfTsKICAgIH1dKTsKCgogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpdGVtRmxvYXRpbmdMYWJlbCcsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnQycsCiAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQpIHsKICAgICAgICAgIHZhciBlbCA9IGVsZW1lbnRbMF07CiAgICAgICAgICB2YXIgaW5wdXQgPSBlbC5xdWVyeVNlbGVjdG9yKCdpbnB1dCwgdGV4dGFyZWEnKTsKICAgICAgICAgIHZhciBpbnB1dExhYmVsID0gZWwucXVlcnlTZWxlY3RvcignLmlucHV0LWxhYmVsJyk7CgogICAgICAgICAgaWYgKCAhaW5wdXQgfHwgIWlucHV0TGFiZWwgKSByZXR1cm47CgogICAgICAgICAgdmFyIG9uSW5wdXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCBpbnB1dC52YWx1ZSApIHsKICAgICAgICAgICAgICBpbnB1dExhYmVsLmNsYXNzTGlzdC5hZGQoJ2hhcy1pbnB1dCcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlucHV0TGFiZWwuY2xhc3NMaXN0LnJlbW92ZSgnaGFzLWlucHV0Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBvbklucHV0KTsKCiAgICAgICAgICB2YXIgbmdNb2RlbEN0cmwgPSBhbmd1bGFyLmVsZW1lbnQoaW5wdXQpLmNvbnRyb2xsZXIoJ25nTW9kZWwnKTsKICAgICAgICAgIGlmICggbmdNb2RlbEN0cmwgKSB7CiAgICAgICAgICAgIG5nTW9kZWxDdHJsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IG5nTW9kZWxDdHJsLiR2aWV3VmFsdWUgfHwgJyc7CiAgICAgICAgICAgICAgb25JbnB1dCgpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQoKICAgICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBvbklucHV0KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwoKICB2YXIgSVRFTV9UUExfT1BUSU9OX0JVVFRPTlMgPQogICAgJzxkaXYgY2xhc3M9Iml0ZW0tb3B0aW9ucyBpbnZpc2libGUiPicgKwogICAgJzwvZGl2Pic7CiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvbk9wdGlvbkJ1dHRvbgogICAqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvbkl0ZW0KICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKiBDcmVhdGVzIGFuIG9wdGlvbiBidXR0b24gaW5zaWRlIGEgbGlzdCBpdGVtLCB0aGF0IGlzIHZpc2libGUgd2hlbiB0aGUgaXRlbSBpcyBzd2lwZWQKICAgKiB0byB0aGUgbGVmdCBieSB0aGUgdXNlci4gIFN3aXBlZCBvcGVuIG9wdGlvbiBidXR0b25zIGNhbiBiZSBoaWRkZW4gd2l0aAogICAqIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY0xpc3REZWxlZ2F0ZSNjbG9zZU9wdGlvbkJ1dHRvbnMgJGlvbmljTGlzdERlbGVnYXRlI2Nsb3NlT3B0aW9uQnV0dG9uc30uCiAgICoKICAgKiBDYW4gYmUgYXNzaWduZWQgYW55IGJ1dHRvbiBjbGFzcy4KICAgKgogICAqIFNlZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3R9IGZvciBhIGNvbXBsZXRlIGV4YW1wbGUgJiBleHBsYW5hdGlvbi4KICAgKgogICAqIEB1c2FnZQogICAqCiAgICogYGBgaHRtbAogICAqIDxpb24tbGlzdD4KICAgKiAgIDxpb24taXRlbT4KICAgKiAgICAgSSBsb3ZlIGtpdHRlbnMhCiAgICogICAgIDxpb24tb3B0aW9uLWJ1dHRvbiBjbGFzcz0iYnV0dG9uLXBvc2l0aXZlIj5TaGFyZTwvaW9uLW9wdGlvbi1idXR0b24+CiAgICogICAgIDxpb24tb3B0aW9uLWJ1dHRvbiBjbGFzcz0iYnV0dG9uLWFzc2VydGl2ZSI+RWRpdDwvaW9uLW9wdGlvbi1idXR0b24+CiAgICogICA8L2lvbi1pdGVtPgogICAqIDwvaW9uLWxpc3Q+CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvbk9wdGlvbkJ1dHRvbicsIFsnJGNvbXBpbGUnLCBmdW5jdGlvbigkY29tcGlsZSkgewogICAgICBmdW5jdGlvbiBzdG9wUHJvcGFnYXRpb24oZSkgewogICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcXVpcmU6ICdeaW9uSXRlbScsCiAgICAgICAgcHJpb3JpdHk6IE51bWJlci5NQVhfVkFMVUUsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgICAgICAkYXR0ci4kc2V0KCdjbGFzcycsICgkYXR0clsnY2xhc3MnXSB8fCAnJykgKyAnIGJ1dHRvbicsIHRydWUpOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBpdGVtQ3RybCkgewogICAgICAgICAgICBpZiAoIWl0ZW1DdHJsLm9wdGlvbnNDb250YWluZXIpIHsKICAgICAgICAgICAgICBpdGVtQ3RybC5vcHRpb25zQ29udGFpbmVyID0ganFMaXRlKElURU1fVFBMX09QVElPTl9CVVRUT05TKTsKICAgICAgICAgICAgICBpdGVtQ3RybC4kZWxlbWVudC5hcHBlbmQoaXRlbUN0cmwub3B0aW9uc0NvbnRhaW5lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbUN0cmwub3B0aW9uc0NvbnRhaW5lci5hcHBlbmQoJGVsZW1lbnQpOwoKICAgICAgICAgICAgLy9Eb24ndCBidWJibGUgY2xpY2sgdXAgdG8gbWFpbiAuaXRlbQogICAgICAgICAgICAkZWxlbWVudC5vbignY2xpY2snLCBzdG9wUHJvcGFnYXRpb24pOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH07CiAgICB9XSk7CgogIHZhciBJVEVNX1RQTF9SRU9SREVSX0JVVFRPTiA9CiAgICAnPGRpdiBkYXRhLXByZXZlbnQtc2Nyb2xsPSJ0cnVlIiBjbGFzcz0iaXRlbS1yaWdodC1lZGl0IGl0ZW0tcmVvcmRlciBlbmFibGUtcG9pbnRlci1ldmVudHMiPicgKwogICAgJzwvZGl2Pic7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25SZW9yZGVyQnV0dG9uCiAgICogQHBhcmVudCBpb25pYy5kaXJlY3RpdmU6aW9uSXRlbQogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgRQogICAqIENyZWF0ZXMgYSByZW9yZGVyIGJ1dHRvbiBpbnNpZGUgYSBsaXN0IGl0ZW0sIHRoYXQgaXMgdmlzaWJsZSB3aGVuIHRoZQogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdCBpb25MaXN0IHBhcmVudCdzfSBgc2hvdy1yZW9yZGVyYCBldmFsdWF0ZXMgdG8gdHJ1ZSBvcgogICAqIGAkaW9uaWNMaXN0RGVsZWdhdGUuc2hvd1Jlb3JkZXIodHJ1ZSlgIGlzIGNhbGxlZC4KICAgKgogICAqIENhbiBiZSBkcmFnZ2VkIHRvIHJlb3JkZXIgaXRlbXMgaW4gdGhlIGxpc3QuIFRha2VzIGFueSBpb25pY29uIGNsYXNzLgogICAqCiAgICogTm90ZTogUmVvcmRlcmluZyB3b3JrcyBiZXN0IHdoZW4gdXNlZCB3aXRoIGBuZy1yZXBlYXRgLiAgQmUgc3VyZSB0aGF0IGFsbCBgaW9uLWl0ZW1gIGNoaWxkcmVuIG9mIGFuIGBpb24tbGlzdGAgYXJlIHBhcnQgb2YgdGhlIHNhbWUgYG5nLXJlcGVhdGAgZXhwcmVzc2lvbi4KICAgKgogICAqIFdoZW4gYW4gaXRlbSByZW9yZGVyIGlzIGNvbXBsZXRlLCB0aGUgZXhwcmVzc2lvbiBnaXZlbiBpbiB0aGUgYG9uLXJlb3JkZXJgIGF0dHJpYnV0ZSBpcyBjYWxsZWQuIFRoZSBgb24tcmVvcmRlcmAgZXhwcmVzc2lvbiBpcyBnaXZlbiB0d28gbG9jYWxzIHRoYXQgY2FuIGJlIHVzZWQ6IGAkZnJvbUluZGV4YCBhbmQgYCR0b0luZGV4YC4gIFNlZSBiZWxvdyBmb3IgYW4gZXhhbXBsZS4KICAgKgogICAqIExvb2sgYXQge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25MaXN0fSBmb3IgbW9yZSBleGFtcGxlcy4KICAgKgogICAqIEB1c2FnZQogICAqCiAgICogYGBgaHRtbAogICAqIDxpb24tbGlzdCBuZy1jb250cm9sbGVyPSJNeUN0cmwiPgogICAqICAgPGlvbi1pdGVtIG5nLXJlcGVhdD0iaXRlbSBpbiBpdGVtcyI+CiAgICogICAgIEl0ZW0ge3tpdGVtfX0KICAgKiAgICAgPGlvbi1yZW9yZGVyLWJ1dHRvbiBjbGFzcz0iaW9uLW5hdmljb24iCiAgICogICAgICAgICAgICAgICAgICAgICAgICAgb24tcmVvcmRlcj0ibW92ZUl0ZW0oaXRlbSwgJGZyb21JbmRleCwgJHRvSW5kZXgpIj4KICAgKiAgICAgPC9pb24tcmVvcmRlcj4KICAgKiAgIDwvaW9uLWl0ZW0+CiAgICogPC9pb24tbGlzdD4KICAgKiBgYGAKICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIE15Q3RybCgkc2NvcGUpIHsKKiAgICRzY29wZS5pdGVtcyA9IFsxLCAyLCAzLCA0XTsKKiAgICRzY29wZS5tb3ZlSXRlbSA9IGZ1bmN0aW9uKGl0ZW0sIGZyb21JbmRleCwgdG9JbmRleCkgewoqICAgICAvL01vdmUgdGhlIGl0ZW0gaW4gdGhlIGFycmF5CiogICAgICRzY29wZS5pdGVtcy5zcGxpY2UoZnJvbUluZGV4LCAxKTsKKiAgICAgJHNjb3BlLml0ZW1zLnNwbGljZSh0b0luZGV4LCAwLCBpdGVtKTsKKiAgIH07CiogfQogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtleHByZXNzaW9uPX0gb24tcmVvcmRlciBFeHByZXNzaW9uIHRvIGNhbGwgd2hlbiBhbiBpdGVtIGlzIHJlb3JkZXJlZC4KICAgKiBQYXJhbWV0ZXJzIGdpdmVuOiAkZnJvbUluZGV4LCAkdG9JbmRleC4KICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uUmVvcmRlckJ1dHRvbicsIFsnJGFuaW1hdGUnLCAnJHBhcnNlJywgZnVuY3Rpb24oJGFuaW1hdGUsICRwYXJzZSkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZTogWydeaW9uSXRlbScsICdeP2lvbkxpc3QnXSwKICAgICAgICBwcmlvcml0eTogTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgJGF0dHIpIHsKICAgICAgICAgICRhdHRyLiRzZXQoJ2NsYXNzJywgKCRhdHRyWydjbGFzcyddIHx8ICcnKSArICcgYnV0dG9uIGljb24gYnV0dG9uLWljb24nLCB0cnVlKTsKICAgICAgICAgICRlbGVtZW50WzBdLnNldEF0dHJpYnV0ZSgnZGF0YS1wcmV2ZW50LXNjcm9sbCcsIHRydWUpOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJscykgewogICAgICAgICAgICB2YXIgaXRlbUN0cmwgPSBjdHJsc1swXTsKICAgICAgICAgICAgdmFyIGxpc3RDdHJsID0gY3RybHNbMV07CiAgICAgICAgICAgIHZhciBvblJlb3JkZXJGbiA9ICRwYXJzZSgkYXR0ci5vblJlb3JkZXIpOwoKICAgICAgICAgICAgJHNjb3BlLiRvblJlb3JkZXIgPSBmdW5jdGlvbihvbGRJbmRleCwgbmV3SW5kZXgpIHsKICAgICAgICAgICAgICBvblJlb3JkZXJGbigkc2NvcGUsIHsKICAgICAgICAgICAgICAgICRmcm9tSW5kZXg6IG9sZEluZGV4LAogICAgICAgICAgICAgICAgJHRvSW5kZXg6IG5ld0luZGV4CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgY29udGFpbmVyID0ganFMaXRlKElURU1fVFBMX1JFT1JERVJfQlVUVE9OKTsKICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZCgkZWxlbWVudCk7CiAgICAgICAgICAgIGl0ZW1DdHJsLiRlbGVtZW50LmFwcGVuZChjb250YWluZXIpLmFkZENsYXNzKCdpdGVtLXJpZ2h0LWVkaXRhYmxlJyk7CgogICAgICAgICAgICBpZiAobGlzdEN0cmwgJiYgbGlzdEN0cmwuc2hvd1Jlb3JkZXIoKSkgewogICAgICAgICAgICAgIGNvbnRhaW5lci5hZGRDbGFzcygndmlzaWJsZSBhY3RpdmUnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH07CiAgICB9XSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBrZXlib2FyZEF0dGFjaAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgQQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICoga2V5Ym9hcmQtYXR0YWNoIGlzIGFuIGF0dHJpYnV0ZSBkaXJlY3RpdmUgd2hpY2ggd2lsbCBjYXVzZSBhbiBlbGVtZW50IHRvIGZsb2F0IGFib3ZlCiAgICogdGhlIGtleWJvYXJkIHdoZW4gdGhlIGtleWJvYXJkIHNob3dzLiBDdXJyZW50bHkgb25seSBzdXBwb3J0cyB0aGUKICAgKiBbaW9uLWZvb3Rlci1iYXJdKHt7IHBhZ2UudmVyc2lvbkhyZWYgfX0vYXBpL2RpcmVjdGl2ZS9pb25Gb290ZXJCYXIvKSBkaXJlY3RpdmUuCiAgICoKICAgKiAjIyMgTm90ZXMKICAgKiAtIFRoaXMgZGlyZWN0aXZlIHJlcXVpcmVzIHRoZQogICAqIFtJb25pYyBLZXlib2FyZCBQbHVnaW5dKGh0dHBzOi8vZ2l0aHViLmNvbS9kcmlmdHljby9pb25pYy1wbHVnaW5zLWtleWJvYXJkKS4KICAgKiAtIE9uIEFuZHJvaWQgbm90IGluIGZ1bGxzY3JlZW4gbW9kZSwgaS5lLiB5b3UgaGF2ZQogICAqICAgYDxwcmVmZXJlbmNlIG5hbWU9IkZ1bGxzY3JlZW4iIHZhbHVlPSJmYWxzZSIgLz5gIG9yIG5vIHByZWZlcmVuY2UgaW4geW91ciBgY29uZmlnLnhtbGAgZmlsZSwKICAgKiAgIHRoaXMgZGlyZWN0aXZlIGlzIHVubmVjZXNzYXJ5IHNpbmNlIGl0IGlzIHRoZSBkZWZhdWx0IGJlaGF2aW9yLgogICAqIC0gT24gaU9TLCBpZiB0aGVyZSBpcyBhbiBpbnB1dCBpbiB5b3VyIGZvb3RlciwgeW91IHdpbGwgbmVlZCB0byBzZXQKICAgKiAgIGBjb3Jkb3ZhLnBsdWdpbnMuS2V5Ym9hcmQuZGlzYWJsZVNjcm9sbCh0cnVlKWAuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIGBgYGh0bWwKICAgKiAgPGlvbi1mb290ZXItYmFyIGFsaWduLXRpdGxlPSJsZWZ0IiBrZXlib2FyZC1hdHRhY2ggY2xhc3M9ImJhci1hc3NlcnRpdmUiPgogICAqICAgIDxoMSBjbGFzcz0idGl0bGUiPlRpdGxlITwvaDE+CiAgICogIDwvaW9uLWZvb3Rlci1iYXI+CiAgICogYGBgCiAgICovCgogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdrZXlib2FyZEF0dGFjaCcsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgaW9uaWMub24oJ25hdGl2ZS5rZXlib2FyZHNob3cnLCBvblNob3csIHdpbmRvdyk7CiAgICAgICAgaW9uaWMub24oJ25hdGl2ZS5rZXlib2FyZGhpZGUnLCBvbkhpZGUsIHdpbmRvdyk7CgogICAgICAgIC8vZGVwcmVjYXRlZAogICAgICAgIGlvbmljLm9uKCduYXRpdmUuc2hvd2tleWJvYXJkJywgb25TaG93LCB3aW5kb3cpOwogICAgICAgIGlvbmljLm9uKCduYXRpdmUuaGlkZWtleWJvYXJkJywgb25IaWRlLCB3aW5kb3cpOwoKCiAgICAgICAgdmFyIHNjcm9sbEN0cmw7CgogICAgICAgIGZ1bmN0aW9uIG9uU2hvdyhlKSB7CiAgICAgICAgICBpZiAoaW9uaWMuUGxhdGZvcm0uaXNBbmRyb2lkKCkgJiYgIWlvbmljLlBsYXRmb3JtLmlzRnVsbFNjcmVlbikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgLy9mb3IgdGVzdGluZwogICAgICAgICAgdmFyIGtleWJvYXJkSGVpZ2h0ID0gZS5rZXlib2FyZEhlaWdodCB8fCBlLmRldGFpbC5rZXlib2FyZEhlaWdodDsKICAgICAgICAgIGVsZW1lbnQuY3NzKCdib3R0b20nLCBrZXlib2FyZEhlaWdodCArICJweCIpOwogICAgICAgICAgc2Nyb2xsQ3RybCA9IGVsZW1lbnQuY29udHJvbGxlcignJGlvbmljU2Nyb2xsJyk7CiAgICAgICAgICBpZiAoIHNjcm9sbEN0cmwgKSB7CiAgICAgICAgICAgIHNjcm9sbEN0cmwuc2Nyb2xsVmlldy5fX2NvbnRhaW5lci5zdHlsZS5ib3R0b20gPSBrZXlib2FyZEhlaWdodCArIGtleWJvYXJkQXR0YWNoR2V0Q2xpZW50SGVpZ2h0KGVsZW1lbnRbMF0pICsgInB4IjsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG9uSGlkZSgpIHsKICAgICAgICAgIGlmIChpb25pYy5QbGF0Zm9ybS5pc0FuZHJvaWQoKSAmJiAhaW9uaWMuUGxhdGZvcm0uaXNGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBlbGVtZW50LmNzcygnYm90dG9tJywgJycpOwogICAgICAgICAgaWYgKCBzY3JvbGxDdHJsICkgewogICAgICAgICAgICBzY3JvbGxDdHJsLnNjcm9sbFZpZXcuX19jb250YWluZXIuc3R5bGUuYm90dG9tID0gJyc7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpb25pYy5vZmYoJ25hdGl2ZS5rZXlib2FyZHNob3cnLCBvblNob3csIHdpbmRvdyk7CiAgICAgICAgICBpb25pYy5vZmYoJ25hdGl2ZS5rZXlib2FyZGhpZGUnLCBvbkhpZGUsIHdpbmRvdyk7CgogICAgICAgICAgLy9kZXByZWNhdGVkCiAgICAgICAgICBpb25pYy5vZmYoJ25hdGl2ZS5zaG93a2V5Ym9hcmQnLCBvblNob3csIHdpbmRvdyk7CiAgICAgICAgICBpb25pYy5vZmYoJ25hdGl2ZS5oaWRla2V5Ym9hcmQnLCBvbkhpZGUsIHdpbmRvdyk7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9KTsKCiAgZnVuY3Rpb24ga2V5Ym9hcmRBdHRhY2hHZXRDbGllbnRIZWlnaHQoZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQuY2xpZW50SGVpZ2h0OwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvbkxpc3QKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljTGlzdERlbGVnYXRlCiAgICogQGNvZGVwZW4gSnNIamYKICAgKiBAcmVzdHJpY3QgRQogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBMaXN0IGlzIGEgd2lkZWx5IHVzZWQgaW50ZXJmYWNlIGVsZW1lbnQgaW4gYWxtb3N0IGFueSBtb2JpbGUgYXBwLCBhbmQgY2FuIGluY2x1ZGUKICAgKiBjb250ZW50IHJhbmdpbmcgZnJvbSBiYXNpYyB0ZXh0IGFsbCB0aGUgd2F5IHRvIGJ1dHRvbnMsIHRvZ2dsZXMsIGljb25zLCBhbmQgdGh1bWJuYWlscy4KICAgKgogICAqIEJvdGggdGhlIGxpc3QsIHdoaWNoIGNvbnRhaW5zIGl0ZW1zLCBhbmQgdGhlIGxpc3QgaXRlbXMgdGhlbXNlbHZlcyBjYW4gYmUgYW55IEhUTUwKICAgKiBlbGVtZW50LiBUaGUgY29udGFpbmluZyBlbGVtZW50IHJlcXVpcmVzIHRoZSBgbGlzdGAgY2xhc3MgYW5kIGVhY2ggbGlzdCBpdGVtIHJlcXVpcmVzCiAgICogdGhlIGBpdGVtYCBjbGFzcy4KICAgKgogICAqIEhvd2V2ZXIsIHVzaW5nIHRoZSBpb25MaXN0IGFuZCBpb25JdGVtIGRpcmVjdGl2ZXMgbWFrZSBpdCBlYXN5IHRvIHN1cHBvcnQgdmFyaW91cwogICAqIGludGVyYWN0aW9uIG1vZGVzIHN1Y2ggYXMgc3dpcGUgdG8gZWRpdCwgZHJhZyB0byByZW9yZGVyLCBhbmQgcmVtb3ZpbmcgaXRlbXMuCiAgICoKICAgKiBSZWxhdGVkOiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkl0ZW19LCB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk9wdGlvbkJ1dHRvbn0KICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblJlb3JkZXJCdXR0b259LCB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkRlbGV0ZUJ1dHRvbn0sIFtgbGlzdCBDU1MgZG9jdW1lbnRhdGlvbmBdKC9kb2NzL2NvbXBvbmVudHMvI2xpc3QpLgogICAqCiAgICogQHVzYWdlCiAgICoKICAgKiBCYXNpYyBVc2FnZToKICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLWxpc3Q+CiAgICogICA8aW9uLWl0ZW0gbmctcmVwZWF0PSJpdGVtIGluIGl0ZW1zIj4KICAgKiAgICAgeyUgcmF3ICV9SGVsbG8sIHt7aXRlbX19IXslIGVuZHJhdyAlfQogICAqICAgPC9pb24taXRlbT4KICAgKiA8L2lvbi1saXN0PgogICAqIGBgYAogICAqCiAgICogQWR2YW5jZWQgVXNhZ2U6IFRodW1ibmFpbHMsIERlbGV0ZSBidXR0b25zLCBSZW9yZGVyaW5nLCBTd2lwaW5nCiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi1saXN0IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCIKICAgKiAgICAgICAgICAgc2hvdy1kZWxldGU9InNob3VsZFNob3dEZWxldGUiCiAgICogICAgICAgICAgIHNob3ctcmVvcmRlcj0ic2hvdWxkU2hvd1Jlb3JkZXIiCiAgICogICAgICAgICAgIGNhbi1zd2lwZT0ibGlzdENhblN3aXBlIj4KICAgKiAgIDxpb24taXRlbSBuZy1yZXBlYXQ9Iml0ZW0gaW4gaXRlbXMiCiAgICogICAgICAgICAgICAgY2xhc3M9Iml0ZW0tdGh1bWJuYWlsLWxlZnQiPgogICAqCiAgICogICAgIHslIHJhdyAlfTxpbWcgbmctc3JjPSJ7e2l0ZW0uaW1nfX0iPgogICAqICAgICA8aDI+e3tpdGVtLnRpdGxlfX08L2gyPgogICAqICAgICA8cD57e2l0ZW0uZGVzY3JpcHRpb259fTwvcD57JSBlbmRyYXcgJX0KICAgKiAgICAgPGlvbi1vcHRpb24tYnV0dG9uIGNsYXNzPSJidXR0b24tcG9zaXRpdmUiCiAgICogICAgICAgICAgICAgICAgICAgICAgICBuZy1jbGljaz0ic2hhcmUoaXRlbSkiPgogICAqICAgICAgIFNoYXJlCiAgICogICAgIDwvaW9uLW9wdGlvbi1idXR0b24+CiAgICogICAgIDxpb24tb3B0aW9uLWJ1dHRvbiBjbGFzcz0iYnV0dG9uLWluZm8iCiAgICogICAgICAgICAgICAgICAgICAgICAgICBuZy1jbGljaz0iZWRpdChpdGVtKSI+CiAgICogICAgICAgRWRpdAogICAqICAgICA8L2lvbi1vcHRpb24tYnV0dG9uPgogICAqICAgICA8aW9uLWRlbGV0ZS1idXR0b24gY2xhc3M9Imlvbi1taW51cy1jaXJjbGVkIgogICAqICAgICAgICAgICAgICAgICAgICAgICAgbmctY2xpY2s9Iml0ZW1zLnNwbGljZSgkaW5kZXgsIDEpIj4KICAgKiAgICAgPC9pb24tZGVsZXRlLWJ1dHRvbj4KICAgKiAgICAgPGlvbi1yZW9yZGVyLWJ1dHRvbiBjbGFzcz0iaW9uLW5hdmljb24iCiAgICogICAgICAgICAgICAgICAgICAgICAgICAgb24tcmVvcmRlcj0icmVvcmRlckl0ZW0oaXRlbSwgJGZyb21JbmRleCwgJHRvSW5kZXgpIj4KICAgKiAgICAgPC9pb24tcmVvcmRlci1idXR0b24+CiAgICoKICAgKiAgIDwvaW9uLWl0ZW0+CiAgICogPC9pb24tbGlzdD4KICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gZGVsZWdhdGUtaGFuZGxlIFRoZSBoYW5kbGUgdXNlZCB0byBpZGVudGlmeSB0aGlzIGxpc3Qgd2l0aAogICAqIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY0xpc3REZWxlZ2F0ZX0uCiAgICogQHBhcmFtIHR5cGUge3N0cmluZz19IFRoZSB0eXBlIG9mIGxpc3QgdG8gdXNlIChmb3IgZXhhbXBsZSwgbGlzdC1pbnNldCBmb3IgYW4gaW5zZXQgbGlzdCkKICAgKiBAcGFyYW0gc2hvdy1kZWxldGUge2Jvb2xlYW49fSBXaGV0aGVyIHRoZSBkZWxldGUgYnV0dG9ucyBmb3IgdGhlIGl0ZW1zIGluIHRoZSBsaXN0IGFyZQogICAqIGN1cnJlbnRseSBzaG93biBvciBoaWRkZW4uCiAgICogQHBhcmFtIHNob3ctcmVvcmRlciB7Ym9vbGVhbj19IFdoZXRoZXIgdGhlIHJlb3JkZXIgYnV0dG9ucyBmb3IgdGhlIGl0ZW1zIGluIHRoZSBsaXN0IGFyZQogICAqIGN1cnJlbnRseSBzaG93biBvciBoaWRkZW4uCiAgICogQHBhcmFtIGNhbi1zd2lwZSB7Ym9vbGVhbj19IFdoZXRoZXIgdGhlIGl0ZW1zIGluIHRoZSBsaXN0IGFyZSBhbGxvd2VkIHRvIGJlIHN3aXBlZCB0byByZXZlYWwKICAgKiBvcHRpb24gYnV0dG9ucy4gRGVmYXVsdDogdHJ1ZS4KICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uTGlzdCcsIFsKICAgICAgJyRhbmltYXRlJywKICAgICAgJyR0aW1lb3V0JywKICAgICAgZnVuY3Rpb24oJGFuaW1hdGUsICR0aW1lb3V0KSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICByZXF1aXJlOiBbJ2lvbkxpc3QnLCAnXj8kaW9uaWNTY3JvbGwnXSwKICAgICAgICAgIGNvbnRyb2xsZXI6ICckaW9uaWNMaXN0JywKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cikgewogICAgICAgICAgICB2YXIgbGlzdEVsID0ganFMaXRlKCc8ZGl2IGNsYXNzPSJsaXN0Ij4nKQogICAgICAgICAgICAgIC5hcHBlbmQoICRlbGVtZW50LmNvbnRlbnRzKCkgKQogICAgICAgICAgICAgIC5hZGRDbGFzcygkYXR0ci50eXBlKTsKICAgICAgICAgICAgJGVsZW1lbnQuYXBwZW5kKGxpc3RFbCk7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzLCBjdHJscykgewogICAgICAgICAgICAgIHZhciBsaXN0Q3RybCA9IGN0cmxzWzBdOwogICAgICAgICAgICAgIHZhciBzY3JvbGxDdHJsID0gY3RybHNbMV07CgogICAgICAgICAgICAgIC8vV2FpdCBmb3IgY2hpbGQgZWxlbWVudHMgdG8gcmVuZGVyLi4uCiAgICAgICAgICAgICAgJHRpbWVvdXQoaW5pdCk7CgogICAgICAgICAgICAgIGZ1bmN0aW9uIGluaXQoKSB7CiAgICAgICAgICAgICAgICB2YXIgbGlzdFZpZXcgPSBsaXN0Q3RybC5saXN0VmlldyA9IG5ldyBpb25pYy52aWV3cy5MaXN0Vmlldyh7CiAgICAgICAgICAgICAgICAgIGVsOiAkZWxlbWVudFswXSwKICAgICAgICAgICAgICAgICAgbGlzdEVsOiAkZWxlbWVudC5jaGlsZHJlbigpWzBdLAogICAgICAgICAgICAgICAgICBzY3JvbGxFbDogc2Nyb2xsQ3RybCAmJiBzY3JvbGxDdHJsLmVsZW1lbnQsCiAgICAgICAgICAgICAgICAgIHNjcm9sbFZpZXc6IHNjcm9sbEN0cmwgJiYgc2Nyb2xsQ3RybC5zY3JvbGxWaWV3LAogICAgICAgICAgICAgICAgICBvblJlb3JkZXI6IGZ1bmN0aW9uKGVsLCBvbGRJbmRleCwgbmV3SW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbVNjb3BlID0ganFMaXRlKGVsKS5zY29wZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChpdGVtU2NvcGUgJiYgaXRlbVNjb3BlLiRvblJlb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vTWFrZSBzdXJlIG9uUmVvcmRlciBpcyBjYWxsZWQgaW4gYXBwbHkgY3ljbGUsCiAgICAgICAgICAgICAgICAgICAgICAvL2J1dCBhbHNvIG1ha2Ugc3VyZSBpdCBoYXMgbm8gY29uZmxpY3RzIGJ5IGRvaW5nCiAgICAgICAgICAgICAgICAgICAgICAvLyRldmFsQXN5bmMKICAgICAgICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpdGVtU2NvcGUuJG9uUmVvcmRlcihvbGRJbmRleCwgbmV3SW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICBjYW5Td2lwZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxpc3RDdHJsLmNhblN3aXBlSXRlbXMoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCgkYXR0ci5jYW5Td2lwZSkpIHsKICAgICAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnISEoJyArICRhdHRyLmNhblN3aXBlICsgJyknLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGxpc3RDdHJsLmNhblN3aXBlSXRlbXModmFsdWUpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpc0RlZmluZWQoJGF0dHIuc2hvd0RlbGV0ZSkpIHsKICAgICAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnISEoJyArICRhdHRyLnNob3dEZWxldGUgKyAnKScsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdEN0cmwuc2hvd0RlbGV0ZSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCgkYXR0ci5zaG93UmVvcmRlcikpIHsKICAgICAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnISEoJyArICRhdHRyLnNob3dSZW9yZGVyICsgJyknLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGxpc3RDdHJsLnNob3dSZW9yZGVyKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGxpc3RDdHJsLnNob3dEZWxldGUoKTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGlzU2hvd24sIHdhc1Nob3duKSB7CiAgICAgICAgICAgICAgICAgIC8vT25seSB1c2UgaXNTaG93bj1mYWxzZSBpZiBpdCB3YXMgYWxyZWFkeSBzaG93bgogICAgICAgICAgICAgICAgICBpZiAoIWlzU2hvd24gJiYgIXdhc1Nob3duKSB7IHJldHVybjsgfQoKICAgICAgICAgICAgICAgICAgaWYgKGlzU2hvd24pIGxpc3RDdHJsLmNsb3NlT3B0aW9uQnV0dG9ucygpOwogICAgICAgICAgICAgICAgICBsaXN0Q3RybC5jYW5Td2lwZUl0ZW1zKCFpc1Nob3duKTsKCiAgICAgICAgICAgICAgICAgICRlbGVtZW50LmNoaWxkcmVuKCkudG9nZ2xlQ2xhc3MoJ2xpc3QtbGVmdC1lZGl0aW5nJywgaXNTaG93bik7CiAgICAgICAgICAgICAgICAgICRlbGVtZW50LnRvZ2dsZUNsYXNzKCdkaXNhYmxlLXBvaW50ZXItZXZlbnRzJywgaXNTaG93bik7CgogICAgICAgICAgICAgICAgICB2YXIgZGVsZXRlQnV0dG9uID0ganFMaXRlKCRlbGVtZW50WzBdLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2l0ZW0tZGVsZXRlJykpOwogICAgICAgICAgICAgICAgICBzZXRCdXR0b25TaG93bihkZWxldGVCdXR0b24sIGxpc3RDdHJsLnNob3dEZWxldGUpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGxpc3RDdHJsLnNob3dSZW9yZGVyKCk7CiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbihpc1Nob3duLCB3YXNTaG93bikgewogICAgICAgICAgICAgICAgICAvL09ubHkgdXNlIGlzU2hvd249ZmFsc2UgaWYgaXQgd2FzIGFscmVhZHkgc2hvd24KICAgICAgICAgICAgICAgICAgaWYgKCFpc1Nob3duICYmICF3YXNTaG93bikgeyByZXR1cm47IH0KCiAgICAgICAgICAgICAgICAgIGlmIChpc1Nob3duKSBsaXN0Q3RybC5jbG9zZU9wdGlvbkJ1dHRvbnMoKTsKICAgICAgICAgICAgICAgICAgbGlzdEN0cmwuY2FuU3dpcGVJdGVtcyghaXNTaG93bik7CgogICAgICAgICAgICAgICAgICAkZWxlbWVudC5jaGlsZHJlbigpLnRvZ2dsZUNsYXNzKCdsaXN0LXJpZ2h0LWVkaXRpbmcnLCBpc1Nob3duKTsKICAgICAgICAgICAgICAgICAgJGVsZW1lbnQudG9nZ2xlQ2xhc3MoJ2Rpc2FibGUtcG9pbnRlci1ldmVudHMnLCBpc1Nob3duKTsKCiAgICAgICAgICAgICAgICAgIHZhciByZW9yZGVyQnV0dG9uID0ganFMaXRlKCRlbGVtZW50WzBdLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2l0ZW0tcmVvcmRlcicpKTsKICAgICAgICAgICAgICAgICAgc2V0QnV0dG9uU2hvd24ocmVvcmRlckJ1dHRvbiwgbGlzdEN0cmwuc2hvd1Jlb3JkZXIpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gc2V0QnV0dG9uU2hvd24oZWwsIHNob3duKSB7CiAgICAgICAgICAgICAgICAgIHNob3duKCkgJiYgZWwuYWRkQ2xhc3MoJ3Zpc2libGUnKSB8fCBlbC5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBzaG93bigpICYmIGVsLmFkZENsYXNzKCdhY3RpdmUnKSB8fCBlbC5yZW1vdmVDbGFzcygnaW52aXNpYmxlJyk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfV0pOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbWVudUNsb3NlCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBQwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2xvc2VzIGEgc2lkZSBtZW51IHdoaWNoIGlzIGN1cnJlbnRseSBvcGVuZWQuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBCZWxvdyBpcyBhbiBleGFtcGxlIG9mIGEgbGluayB3aXRoaW4gYSBzaWRlIG1lbnUuIFRhcHBpbmcgdGhpcyBsaW5rIHdvdWxkCiAgICogYXV0b21hdGljYWxseSBjbG9zZSB0aGUgY3VycmVudGx5IG9wZW5lZCBtZW51LgogICAqCiAgICogYGBgaHRtbAogICAqIDxhIG1lbnUtY2xvc2UgaHJlZj0iIy9ob21lIiBjbGFzcz0iaXRlbSI+SG9tZTwvYT4KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnbWVudUNsb3NlJywgWyckaW9uaWNWaWV3U2VydmljZScsIGZ1bmN0aW9uKCRpb25pY1ZpZXdTZXJ2aWNlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdBQycsCiAgICAgICAgcmVxdWlyZTogJ15pb25TaWRlTWVudXMnLAogICAgICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBzaWRlTWVudUN0cmwpIHsKICAgICAgICAgICRlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgc2lkZU1lbnVDdHJsLmNsb3NlKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CiAgICB9XSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBtZW51VG9nZ2xlCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBQwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVG9nZ2xlIGEgc2lkZSBtZW51IG9uIHRoZSBnaXZlbiBzaWRlCiAgICoKICAgKiBAdXNhZ2UKICAgKiBCZWxvdyBpcyBhbiBleGFtcGxlIG9mIGEgbGluayB3aXRoaW4gYSBuYXYgYmFyLiBUYXBwaW5nIHRoaXMgbGluayB3b3VsZAogICAqIGF1dG9tYXRpY2FsbHkgb3BlbiB0aGUgZ2l2ZW4gc2lkZSBtZW51CiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi12aWV3PgogICAqICAgPGlvbi1uYXYtYnV0dG9ucyBzaWRlPSJsZWZ0Ij4KICAgKiAgICA8YnV0dG9uIG1lbnUtdG9nZ2xlPSJsZWZ0IiBjbGFzcz0iYnV0dG9uIGJ1dHRvbi1pY29uIGljb24gaW9uLW5hdmljb24iPjwvYnV0dG9uPgogICAqICAgPC9pb24tbmF2LWJ1dHRvbnM+CiAgICogIC4uLgogICAqIDwvaW9uLXZpZXc+CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ21lbnVUb2dnbGUnLCBbJyRpb25pY1ZpZXdTZXJ2aWNlJywgZnVuY3Rpb24oJGlvbmljVmlld1NlcnZpY2UpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0FDJywKICAgICAgICByZXF1aXJlOiAnXmlvblNpZGVNZW51cycsCiAgICAgICAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNpZGVNZW51Q3RybCkgewogICAgICAgICAgdmFyIHNpZGUgPSAkYXR0ci5tZW51VG9nZ2xlIHx8ICdsZWZ0JzsKICAgICAgICAgICRlbGVtZW50LmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgaWYoc2lkZSA9PT0gJ2xlZnQnKSB7CiAgICAgICAgICAgICAgc2lkZU1lbnVDdHJsLnRvZ2dsZUxlZnQoKTsKICAgICAgICAgICAgfSBlbHNlIGlmKHNpZGUgPT09ICdyaWdodCcpIHsKICAgICAgICAgICAgICBzaWRlTWVudUN0cmwudG9nZ2xlUmlnaHQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwogICAgfV0pOwoKCiAgLyoKICAgKiBXZSBkb24ndCBkb2N1bWVudCB0aGUgaW9uTW9kYWwgZGlyZWN0aXZlLCB3ZSBpbnN0ZWFkIGRvY3VtZW50CiAgICogdGhlICRpb25pY01vZGFsIHNlcnZpY2UKICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uTW9kYWwnLCBbZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgY29udHJvbGxlcjogW2Z1bmN0aW9uKCl7fV0sCiAgICAgICAgdGVtcGxhdGU6ICc8ZGl2IGNsYXNzPSJtb2RhbC1iYWNrZHJvcCI+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0ibW9kYWwtd3JhcHBlciIgbmctdHJhbnNjbHVkZT48L2Rpdj4nICsKICAgICAgICAgICc8L2Rpdj4nCiAgICAgIH07CiAgICB9XSk7CgogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25Nb2RhbFZpZXcnLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ21vZGFsJyk7CiAgICAgICAgfQogICAgICB9OwogICAgfSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25OYXZCYWNrQnV0dG9uCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBFCiAgICogQHBhcmVudCBpb25OYXZCYXIKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDcmVhdGVzIGEgYmFjayBidXR0b24gaW5zaWRlIGFuIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfS4KICAgKgogICAqIFdpbGwgc2hvdyB1cCB3aGVuIHRoZSB1c2VyIGlzIGFibGUgdG8gZ28gYmFjayBpbiB0aGUgY3VycmVudCBuYXZpZ2F0aW9uIHN0YWNrLgogICAqCiAgICogQnkgZGVmYXVsdCwgd2lsbCBnbyBiYWNrIHdoZW4gY2xpY2tlZC4gIElmIHlvdSB3aXNoIGZvciBtb3JlIGFkdmFuY2VkIGJlaGF2aW9yLCBzZWUgdGhlCiAgICogZXhhbXBsZXMgYmVsb3cuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIFdpdGggZGVmYXVsdCBjbGljayBhY3Rpb246CiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi1uYXYtYmFyPgogICAqICAgPGlvbi1uYXYtYmFjay1idXR0b24gY2xhc3M9ImJ1dHRvbi1jbGVhciI+CiAgICogICAgIDxpIGNsYXNzPSJpb24tYXJyb3ctbGVmdC1jIj48L2k+IEJhY2sKICAgKiAgIDwvaW9uLW5hdi1iYWNrLWJ1dHRvbj4KICAgKiA8L2lvbi1uYXYtYmFyPgogICAqIGBgYAogICAqCiAgICogV2l0aCBjdXN0b20gY2xpY2sgYWN0aW9uLCB1c2luZyB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNOYXZCYXJEZWxlZ2F0ZX06CiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi1uYXYtYmFyIG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+CiAgICogICA8aW9uLW5hdi1iYWNrLWJ1dHRvbiBjbGFzcz0iYnV0dG9uLWNsZWFyIgogICAqICAgICBuZy1jbGljaz0iZ29CYWNrKCkiPgogICAqICAgICA8aSBjbGFzcz0iaW9uLWFycm93LWxlZnQtYyI+PC9pPiBCYWNrCiAgICogICA8L2lvbi1uYXYtYmFjay1idXR0b24+CiAgICogPC9pb24tbmF2LWJhcj4KICAgKiBgYGAKICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIE15Q3RybCgkc2NvcGUsICRpb25pY05hdkJhckRlbGVnYXRlKSB7CiAqICAgJHNjb3BlLmdvQmFjayA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljTmF2QmFyRGVsZWdhdGUuYmFjaygpOwogKiAgIH07CiAqIH0KICAgKiBgYGAKICAgKgogICAqIERpc3BsYXlpbmcgdGhlIHByZXZpb3VzIHRpdGxlIG9uIHRoZSBiYWNrIGJ1dHRvbiwgYWdhaW4gdXNpbmcKICAgKiB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNOYXZCYXJEZWxlZ2F0ZX0uCiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi1uYXYtYmFyIG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+CiAgICogICA8aW9uLW5hdi1iYWNrLWJ1dHRvbiBjbGFzcz0iYnV0dG9uLWljb24iPgogICAqICAgICA8aSBjbGFzcz0iaWNvbiBpb24tYXJyb3ctbGVmdC1jIj48L2k+eyUgcmF3ICV9e3tnZXRQcmV2aW91c1RpdGxlKCkgfHwgJ0JhY2snfX17JSBlbmRyYXcgJX0KICAgKiAgIDwvaW9uLW5hdi1iYWNrLWJ1dHRvbj4KICAgKiA8L2lvbi1uYXYtYmFyPgogICAqIGBgYAogICAqIGBgYGpzCiAgICogZnVuY3Rpb24gTXlDdHJsKCRzY29wZSwgJGlvbmljTmF2QmFyRGVsZWdhdGUpIHsKICogICAkc2NvcGUuZ2V0UHJldmlvdXNUaXRsZSA9IGZ1bmN0aW9uKCkgewogKiAgICAgcmV0dXJuICRpb25pY05hdkJhckRlbGVnYXRlLmdldFByZXZpb3VzVGl0bGUoKTsKICogICB9OwogKiB9CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvbk5hdkJhY2tCdXR0b24nLCBbCiAgICAgICckYW5pbWF0ZScsCiAgICAgICckcm9vdFNjb3BlJywKICAgICAgJyRzYW5pdGl6ZScsCiAgICAgICckaW9uaWNOYXZCYXJDb25maWcnLAogICAgICAnJGlvbmljTmdDbGljaycsCiAgICAgIGZ1bmN0aW9uKCRhbmltYXRlLCAkcm9vdFNjb3BlLCAkc2FuaXRpemUsICRpb25pY05hdkJhckNvbmZpZywgJGlvbmljTmdDbGljaykgewogICAgICAgIHZhciBiYWNrSXNTaG93biA9IGZhbHNlOwogICAgICAgIC8vSWYgdGhlIGN1cnJlbnQgdmlld3N0YXRlIGRvZXMgbm90IGFsbG93IGEgYmFjayBidXR0b24sCiAgICAgICAgLy9hbHdheXMgaGlkZSBpdC4KICAgICAgICAkcm9vdFNjb3BlLiRvbignJHZpZXdIaXN0b3J5Lmhpc3RvcnlDaGFuZ2UnLCBmdW5jdGlvbihlLCBkYXRhKSB7CiAgICAgICAgICBiYWNrSXNTaG93biA9ICEhZGF0YS5zaG93QmFjazsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgIHJlcXVpcmU6ICdeaW9uTmF2QmFyJywKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsKICAgICAgICAgICAgdEVsZW1lbnQuYWRkQ2xhc3MoJ2J1dHRvbiBiYWNrLWJ1dHRvbiBuZy1oaWRlJyk7CgogICAgICAgICAgICB2YXIgaGFzSWNvbkNoaWxkID0gISEodEVsZW1lbnQuaHRtbCgpIHx8ICcnKS5tYXRjaCgvY2xhc3M9Lio/aW9uLS8pOwoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBuYXZCYXJDdHJsKSB7CgogICAgICAgICAgICAgIC8vIEFkZCBhIGRlZmF1bHQgYmFjayBidXR0b24gaWNvbiBiYXNlZCBvbiB0aGUgbmF2IGNvbmZpZywgdW5sZXNzIG9uZSBpcyBzZXQKICAgICAgICAgICAgICBpZiAoIWhhc0ljb25DaGlsZCAmJiAkZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZignaW9uLScpID09PSAtMSkgewogICAgICAgICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoJGlvbmljTmF2QmFyQ29uZmlnLmJhY2tCdXR0b25JY29uKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vRGVmYXVsdCB0byBuZ0NsaWNrIGdvaW5nIGJhY2ssIGJ1dCBkb24ndCBvdmVycmlkZSBhIGN1c3RvbSBvbmUKICAgICAgICAgICAgICBpZiAoIWlzRGVmaW5lZCgkYXR0ci5uZ0NsaWNrKSkgewogICAgICAgICAgICAgICAgJGlvbmljTmdDbGljaygkc2NvcGUsICRlbGVtZW50LCBuYXZCYXJDdHJsLmJhY2spOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy9NYWtlIHN1cmUgYm90aCB0aGF0IGEgYmFja0J1dHRvbiBpcyBhbGxvd2VkIGluIHRoZSBmaXJzdCBwbGFjZSwKICAgICAgICAgICAgICAvL2FuZCB0aGF0IGl0IGlzIHNob3duIGJ5IHRoZSBjdXJyZW50IHZpZXcuCiAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmKGlzRGVmaW5lZCgkYXR0ci5mcm9tVGl0bGUpKSB7CiAgICAgICAgICAgICAgICAgICRlbGVtZW50WzBdLmlubmVySFRNTCA9ICc8c3BhbiBjbGFzcz0iYmFjay1idXR0b24tdGl0bGUiPicgKyAkc2FuaXRpemUoJHNjb3BlLm9sZFRpdGxlKSArICc8L3NwYW4+JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiAhIShiYWNrSXNTaG93biAmJiAkc2NvcGUuYmFja0J1dHRvblNob3duKTsKICAgICAgICAgICAgICB9LCBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlKGZ1bmN0aW9uKHNob3cpIHsKICAgICAgICAgICAgICAgIGlmIChzaG93KSAkYW5pbWF0ZS5yZW1vdmVDbGFzcygkZWxlbWVudCwgJ25nLWhpZGUnKTsKICAgICAgICAgICAgICAgIGVsc2UgJGFuaW1hdGUuYWRkQ2xhc3MoJGVsZW1lbnQsICduZy1oaWRlJyk7CiAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH1dKTsKCgogIElvbmljTW9kdWxlLmNvbnN0YW50KCckaW9uaWNOYXZCYXJDb25maWcnLCB7CiAgICB0cmFuc2l0aW9uOiAnbmF2LXRpdGxlLXNsaWRlLWlvczcnLAogICAgYWxpZ25UaXRsZTogJ2NlbnRlcicsCiAgICBiYWNrQnV0dG9uSWNvbjogJ2lvbi1pb3M3LWFycm93LWJhY2snCiAgfSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25OYXZCYXIKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljTmF2QmFyRGVsZWdhdGUKICAgKiBAcmVzdHJpY3QgRQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogSWYgd2UgaGF2ZSBhbiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdlZpZXd9IGRpcmVjdGl2ZSwgd2UgY2FuIGFsc28gY3JlYXRlIGFuCiAgICogYDxpb24tbmF2LWJhcj5gLCB3aGljaCB3aWxsIGNyZWF0ZSBhIHRvcGJhciB0aGF0IHVwZGF0ZXMgYXMgdGhlIGFwcGxpY2F0aW9uIHN0YXRlIGNoYW5nZXMuCiAgICoKICAgKiBXZSBjYW4gYWRkIGEgYmFjayBidXR0b24gYnkgcHV0dGluZyBhbiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhY2tCdXR0b259IGluc2lkZS4KICAgKgogICAqIFdlIGNhbiBhZGQgYnV0dG9ucyBkZXBlbmRpbmcgb24gdGhlIGN1cnJlbnRseSB2aXNpYmxlIHZpZXcgdXNpbmcKICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJ1dHRvbnN9LgogICAqCiAgICogQWRkIGFuIFthbmltYXRpb24gY2xhc3NdKC9kb2NzL2NvbXBvbmVudHMjYW5pbWF0aW9ucykgdG8gdGhlIGVsZW1lbnQgdmlhIHRoZQogICAqIGBhbmltYXRpb25gIGF0dHJpYnV0ZSB0byBlbmFibGUgYW5pbWF0ZWQgY2hhbmdpbmcgb2YgdGl0bGVzCiAgICogKHJlY29tbWVuZGVkOiAnbmF2LXRpdGxlLXNsaWRlLWlvczcnKS4KICAgKgogICAqIE5vdGUgdGhhdCB0aGUgaW9uLW5hdi1iYXIgZWxlbWVudCB3aWxsIG9ubHkgd29yayBjb3JyZWN0bHkgaWYgeW91ciBjb250ZW50IGhhcyBhbgogICAqIGlvblZpZXcgYXJvdW5kIGl0LgogICAqCiAgICogQHVzYWdlCiAgICoKICAgKiBgYGBodG1sCiAgICogPGJvZHkgbmctYXBwPSJzdGFydGVyIj4KICAgKiAgIDwhLS0gVGhlIG5hdiBiYXIgdGhhdCB3aWxsIGJlIHVwZGF0ZWQgYXMgd2UgbmF2aWdhdGUgLS0+CiAgICogICA8aW9uLW5hdi1iYXIgY2xhc3M9ImJhci1wb3NpdGl2ZSIgYW5pbWF0aW9uPSJuYXYtdGl0bGUtc2xpZGUtaW9zNyI+CiAgICogICA8L2lvbi1uYXYtYmFyPgogICAqCiAgICogICA8IS0tIHdoZXJlIHRoZSBpbml0aWFsIHZpZXcgdGVtcGxhdGUgd2lsbCBiZSByZW5kZXJlZCAtLT4KICAgKiAgIDxpb24tbmF2LXZpZXc+CiAgICogICAgIDxpb24tdmlldz4KICAgKiAgICAgICA8aW9uLWNvbnRlbnQ+SGVsbG8hPC9pb24tY29udGVudD4KICAgKiAgICAgPC9pb24tdmlldz4KICAgKiAgIDwvaW9uLW5hdi12aWV3PgogICAqIDwvYm9keT4KICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gZGVsZWdhdGUtaGFuZGxlIFRoZSBoYW5kbGUgdXNlZCB0byBpZGVudGlmeSB0aGlzIG5hdkJhcgogICAqIHdpdGgge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljTmF2QmFyRGVsZWdhdGV9LgogICAqIEBwYXJhbSBhbGlnbi10aXRsZSB7c3RyaW5nPX0gV2hlcmUgdG8gYWxpZ24gdGhlIHRpdGxlIG9mIHRoZSBuYXZiYXIuCiAgICogQXZhaWxhYmxlOiAnbGVmdCcsICdyaWdodCcsICdjZW50ZXInLiBEZWZhdWx0cyB0byAnY2VudGVyJy4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBuby10YXAtc2Nyb2xsIEJ5IGRlZmF1bHQsIHRoZSBuYXZiYXIgd2lsbCBzY3JvbGwgdGhlIGNvbnRlbnQKICAgKiB0byB0aGUgdG9wIHdoZW4gdGFwcGVkLiAgU2V0IG5vLXRhcC1zY3JvbGwgdG8gdHJ1ZSB0byBkaXNhYmxlIHRoaXMgYmVoYXZpb3IuCiAgICoKICAgKiA8L3RhYmxlPjxici8+CiAgICoKICAgKiAjIyMgQWx0ZXJuYXRpdmUgVXNhZ2UKICAgKgogICAqIEFsdGVybmF0aXZlbHksIHlvdSBtYXkgcHV0IGlvbi1uYXYtYmFyIGluc2lkZSBvZiBlYWNoIGluZGl2aWR1YWwgdmlldydzIGlvbi12aWV3IGVsZW1lbnQuCiAgICogVGhpcyB3aWxsIGFsbG93IHlvdSB0byBoYXZlIHRoZSB3aG9sZSBuYXZiYXIsIG5vdCBqdXN0IGl0cyBjb250ZW50cywgdHJhbnNpdGlvbiBldmVyeSB2aWV3IGNoYW5nZS4KICAgKgogICAqIFRoaXMgaXMgc2ltaWxhciB0byB1c2luZyBhIGhlYWRlciBiYXIgaW5zaWRlIHlvdXIgaW9uLXZpZXcsIGV4Y2VwdCBpdCB3aWxsIGhhdmUgYWxsIHRoZSBwb3dlciBvZiBhIG5hdmJhci4KICAgKgogICAqIElmIHlvdSBkbyB0aGlzLCBzaW1wbHkgcHV0IG5hdiBidXR0b25zIGluc2lkZSB0aGUgbmF2YmFyIGl0c2VsZjsgZG8gbm90IHVzZSBgPGlvbi1uYXYtYnV0dG9ucz5gLgogICAqCiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi12aWV3IHRpdGxlPSJteVRpdGxlIj4KICAgKiAgIDxpb24tbmF2LWJhciBjbGFzcz0iYmFyLXBvc2l0aXZlIj4KICAgKiAgICAgPGlvbi1uYXYtYmFjay1idXR0b24+CiAgICogICAgICAgQmFjawogICAqICAgICA8L2lvbi1uYXYtYmFjay1idXR0b24+CiAgICogICAgIDxkaXYgY2xhc3M9ImJ1dHRvbnMgcmlnaHQtYnV0dG9ucyI+CiAgICogICAgICAgPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIj4KICAgKiAgICAgICAgIFJpZ2h0IEJ1dHRvbgogICAqICAgICAgIDwvYnV0dG9uPgogICAqICAgICA8L2Rpdj4KICAgKiAgIDwvaW9uLW5hdi1iYXI+CiAgICogPC9pb24tdmlldz4KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uTmF2QmFyJywgWwogICAgICAnJGlvbmljVmlld1NlcnZpY2UnLAogICAgICAnJHJvb3RTY29wZScsCiAgICAgICckYW5pbWF0ZScsCiAgICAgICckY29tcGlsZScsCiAgICAgICckaW9uaWNOYXZCYXJDb25maWcnLAogICAgICBmdW5jdGlvbigkaW9uaWNWaWV3U2VydmljZSwgJHJvb3RTY29wZSwgJGFuaW1hdGUsICRjb21waWxlLCAkaW9uaWNOYXZCYXJDb25maWcpIHsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICBjb250cm9sbGVyOiAnJGlvbmljTmF2QmFyJywKICAgICAgICAgIHNjb3BlOiB0cnVlLAogICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICAvL1dlIGNhbm5vdCB0cmFuc2NsdWRlIGhlcmUgYmVjYXVzZSBpdCBicmVha3MgZWxlbWVudC5kYXRhKCkgaW5oZXJpdGFuY2Ugb24gY29tcGlsZQogICAgICAgICAgICB0RWxlbWVudAogICAgICAgICAgICAgIC5hZGRDbGFzcygnYmFyIGJhci1oZWFkZXIgbmF2LWJhcicpCiAgICAgICAgICAgICAgLmFwcGVuZCgKICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJidXR0b25zIGxlZnQtYnV0dG9ucyI+ICcgKwogICAgICAgICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgICAgICAgJzxoMSBuZy1iaW5kLWh0bWw9InRpdGxlIiBjbGFzcz0idGl0bGUiPjwvaDE+JyArCiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iYnV0dG9ucyByaWdodC1idXR0b25zIj4gJyArCiAgICAgICAgICAgICAgICAnPC9kaXY+JwogICAgICAgICAgICApOwoKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh0QXR0cnMuYW5pbWF0aW9uKSkgewogICAgICAgICAgICAgIHRFbGVtZW50LmFkZENsYXNzKHRBdHRycy5hbmltYXRpb24pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRFbGVtZW50LmFkZENsYXNzKCRpb25pY05hdkJhckNvbmZpZy50cmFuc2l0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsgcHJlOiBwcmVsaW5rIH07CiAgICAgICAgICAgIGZ1bmN0aW9uIHByZWxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIG5hdkJhckN0cmwpIHsKICAgICAgICAgICAgICBuYXZCYXJDdHJsLl9oZWFkZXJCYXJWaWV3ID0gbmV3IGlvbmljLnZpZXdzLkhlYWRlckJhcih7CiAgICAgICAgICAgICAgICBlbDogJGVsZW1lbnRbMF0sCiAgICAgICAgICAgICAgICBhbGlnblRpdGxlOiAkYXR0ci5hbGlnblRpdGxlIHx8ICRpb25pY05hdkJhckNvbmZpZy5hbGlnblRpdGxlIHx8ICdjZW50ZXInCiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIC8vZGVmYXVsdHMKICAgICAgICAgICAgICAkc2NvcGUuYmFja0J1dHRvblNob3duID0gZmFsc2U7CiAgICAgICAgICAgICAgJHNjb3BlLnNob3VsZEFuaW1hdGUgPSB0cnVlOwogICAgICAgICAgICAgICRzY29wZS5pc1JldmVyc2UgPSBmYWxzZTsKICAgICAgICAgICAgICAkc2NvcGUuaXNJbnZpc2libGUgPSB0cnVlOwoKICAgICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLiRwYXJlbnQuJGhhc0hlYWRlciA9IGZhbHNlOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICgkc2NvcGUuaXNSZXZlcnNlID8gJyByZXZlcnNlJyA6ICcnKSArCiAgICAgICAgICAgICAgICAgICgkc2NvcGUuaXNJbnZpc2libGUgPyAnIGludmlzaWJsZScgOiAnJykgKwogICAgICAgICAgICAgICAgICAoISRzY29wZS5zaG91bGRBbmltYXRlID8gJyBuby1hbmltYXRpb24nIDogJycpOwogICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGNsYXNzTmFtZSwgb2xkQ2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5yZW1vdmVDbGFzcyhvbGRDbGFzc05hbWUpOwogICAgICAgICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XSk7CgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgaW9uTmF2QnV0dG9ucwogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgRQogICAqIEBwYXJlbnQgaW9uTmF2VmlldwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXNlIGlvbk5hdkJ1dHRvbnMgdG8gc2V0IHRoZSBidXR0b25zIG9uIHlvdXIge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9CiAgICogZnJvbSB3aXRoaW4gYW4ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25WaWV3fS4KICAgKgogICAqIEFueSBidXR0b25zIHlvdSBkZWNsYXJlIHdpbGwgYmUgcGxhY2VkIG9udG8gdGhlIG5hdmJhcidzIGNvcnJlc3BvbmRpbmcgc2lkZSwKICAgKiBhbmQgdGhlbiBkZXN0cm95ZWQgd2hlbiB0aGUgdXNlciBsZWF2ZXMgdGhlaXIgcGFyZW50IHZpZXcuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGlvbi1uYXYtYmFyPgogICAqIDwvaW9uLW5hdi1iYXI+CiAgICogPGlvbi1uYXYtdmlldz4KICAgKiAgIDxpb24tdmlldz4KICAgKiAgICAgPGlvbi1uYXYtYnV0dG9ucyBzaWRlPSJsZWZ0Ij4KICAgKiAgICAgICA8YnV0dG9uIGNsYXNzPSJidXR0b24iIG5nLWNsaWNrPSJkb1NvbWV0aGluZygpIj4KICAgKiAgICAgICAgIEknbSBhIGJ1dHRvbiBvbiB0aGUgbGVmdCBvZiB0aGUgbmF2YmFyIQogICAqICAgICAgIDwvYnV0dG9uPgogICAqICAgICA8L2lvbi1uYXYtYnV0dG9ucz4KICAgKiAgICAgPGlvbi1jb250ZW50PgogICAqICAgICAgIFNvbWUgc3VwZXIgY29udGVudCBoZXJlIQogICAqICAgICA8L2lvbi1jb250ZW50PgogICAqICAgPC9pb24tdmlldz4KICAgKiA8L2lvbi1uYXYtdmlldz4KICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBzaWRlIFRoZSBzaWRlIHRvIHBsYWNlIHRoZSBidXR0b25zIG9uIGluIHRoZSBwYXJlbnQKICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0uIEF2YWlsYWJsZTogJ2xlZnQnIG9yICdyaWdodCcuCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvbk5hdkJ1dHRvbnMnLCBbJyRjb21waWxlJywgJyRhbmltYXRlJywgZnVuY3Rpb24oJGNvbXBpbGUsICRhbmltYXRlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVxdWlyZTogJ15pb25OYXZCYXInLAogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oJGVsZW1lbnQsICRhdHRycykgewogICAgICAgICAgdmFyIGNvbnRlbnQgPSAkZWxlbWVudC5jb250ZW50cygpLnJlbW92ZSgpOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgbmF2QmFyQ3RybCkgewogICAgICAgICAgICB2YXIgbmF2RWxlbWVudCA9ICRhdHRycy5zaWRlID09PSAncmlnaHQnID8KICAgICAgICAgICAgICBuYXZCYXJDdHJsLnJpZ2h0QnV0dG9uc0VsZW1lbnQgOgogICAgICAgICAgICAgIG5hdkJhckN0cmwubGVmdEJ1dHRvbnNFbGVtZW50OwoKICAgICAgICAgICAgLy9QdXQgYWxsIG9mIG91ciBpbnNpZGUgYnV0dG9ucyBpbnRvIHRoZWlyIG93biBzcGFuLAogICAgICAgICAgICAvL3NvIHdlIGNhbiByZW1vdmUgdGhlbSBhbGwgd2hlbiB0aGlzIGVsZW1lbnQgZGllcyAtCiAgICAgICAgICAgIC8vZXZlbiBpZiB0aGUgYnV0dG9ucyBoYXZlIGNoYW5nZWQgdGhyb3VnaCBhbiBuZy1yZXBlYXQgb3IgdGhlIGxpa2UsCiAgICAgICAgICAgIC8vd2UganVzdCByZW1vdmUgdGhlaXIgZGl2IHBhcmVudCBhbmQgdGhleSBhcmUgZ29uZS4KICAgICAgICAgICAgdmFyIGJ1dHRvbnMgPSBqcUxpdGUoJzxzcGFuPicpLmFwcGVuZChjb250ZW50KTsKCiAgICAgICAgICAgIC8vQ29tcGlsZSBidXR0b25zIGluc2lkZSBjb250ZW50IHNvIHRoZXkgaGF2ZSBhY2Nlc3MgdG8gZXZlcnl0aGluZwogICAgICAgICAgICAvL3NvbWV0aGluZyBpbnNpZGUgY29udGVudCBkb2VzIChlZyBwYXJlbnQgaW9uaWNTY3JvbGwpCiAgICAgICAgICAgICRlbGVtZW50LmFwcGVuZChidXR0b25zKTsKICAgICAgICAgICAgJGNvbXBpbGUoYnV0dG9ucykoJHNjb3BlKTsKCiAgICAgICAgICAgIC8vQXBwZW5kIGJ1dHRvbnMgdG8gbmF2YmFyCiAgICAgICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAvL0lmIHRoZSBzY29wZSBpcyBkZXN0cm95ZWQgYmVmb3JlIHJhZiBydW5zLCBiZSBzdXJlIG5vdCB0byBlbnRlcgogICAgICAgICAgICAgIGlmICghJHNjb3BlLiQkZGVzdHJveWVkKSB7CiAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihidXR0b25zLCBuYXZFbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy9XaGVuIG91ciBpb24tbmF2LWJ1dHRvbnMgY29udGFpbmVyIGlzIGRlc3Ryb3llZCwKICAgICAgICAgICAgLy9kZXN0cm95IGV2ZXJ5dGhpbmcgaW4gdGhlIG5hdmJhcgogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKGJ1dHRvbnMpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFRoZSBvcmlnaW5hbCBlbGVtZW50IGlzIGp1c3QgYSBjb21wbGV0ZWx5IGVtcHR5IDxpb24tbmF2LWJ1dHRvbnM+IGVsZW1lbnQuCiAgICAgICAgICAgIC8vIG1ha2UgaXQgaW52aXNpYmxlIGp1c3QgdG8gYmUgc3VyZSBpdCBkb2Vzbid0IGNoYW5nZSBhbnkgbGF5b3V0CiAgICAgICAgICAgICRlbGVtZW50LmNzcygnZGlzcGxheScsICdub25lJyk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfTsKICAgIH1dKTsKCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuYXZDbGVhcgogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgQUMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIG5hdi1jbGVhciBpcyBhbiBhdHRyaWJ1dGUgZGlyZWN0aXZlIHdoaWNoIHNob3VsZCBiZSB1c2VkIHdpdGggYW4gZWxlbWVudCB0aGF0IGNoYW5nZXMKICAgKiB0aGUgdmlldyBvbiBjbGljaywgZm9yIGV4YW1wbGUgYW4gYDxhIGhyZWY+YCBvciBhIGA8YnV0dG9uIHVpLXNyZWY+YC4KICAgKgogICAqIG5hdi1jbGVhciB3aWxsIGNhdXNlIHRoZSBnaXZlbiBlbGVtZW50LCB3aGVuIGNsaWNrZWQsIHRvIGRpc2FibGUgdGhlIG5leHQgdmlldyB0cmFuc2l0aW9uLgogICAqIFRoaXMgZGlyZWN0aXZlIGlzIHVzZWZ1bCwgZm9yIGV4YW1wbGUsIGZvciBsaW5rcyB3aXRoaW4gYSBzaWRlTWVudS4KICAgKgogICAqIEB1c2FnZQogICAqIEJlbG93IGlzIGEgbGluayBpbiBhIHNpZGUgbWVudSwgd2l0aCB0aGUgbmF2LWNsZWFyIGRpcmVjdGl2ZSBhZGRlZCB0byBpdC4KICAgKiBUYXBwaW5nIHRoaXMgbGluayB3aWxsIGRpc2FibGUgYW55IGFuaW1hdGlvbnMgdGhhdCB3b3VsZCBub3JtYWxseSBvY2N1cgogICAqIGJldHdlZW4gdmlld3MuCiAgICoKICAgKiBgYGBodG1sCiAgICogPGEgbmF2LWNsZWFyIG1lbnUtY2xvc2UgaHJlZj0iIy9ob21lIiBjbGFzcz0iaXRlbSI+SG9tZTwvYT4KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnbmF2Q2xlYXInLCBbCiAgICAgICckaW9uaWNWaWV3U2VydmljZScsCiAgICAgICckc3RhdGUnLAogICAgICAnJGxvY2F0aW9uJywKICAgICAgJyR3aW5kb3cnLAogICAgICAnJHJvb3RTY29wZScsCiAgICAgIGZ1bmN0aW9uKCRpb25pY1ZpZXdTZXJ2aWNlLCAkbG9jYXRpb24sICRzdGF0ZSwgJHdpbmRvdywgJHJvb3RTY29wZSkgewogICAgICAgICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VFcnJvcicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgJGlvbmljVmlld1NlcnZpY2UubmV4dFZpZXdPcHRpb25zKG51bGwpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwcmlvcml0eTogMTAwLAogICAgICAgICAgcmVzdHJpY3Q6ICdBQycsCiAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCkgewogICAgICAgICAgICByZXR1cm4geyBwcmU6IHByZWxpbmsgfTsKICAgICAgICAgICAgZnVuY3Rpb24gcHJlbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgICAgICAgICB2YXIgdW5yZWdpc3Rlckxpc3RlbmVyOwogICAgICAgICAgICAgIGZ1bmN0aW9uIGxpc3RlbkZvclN0YXRlQ2hhbmdlKCkgewogICAgICAgICAgICAgICAgdW5yZWdpc3Rlckxpc3RlbmVyID0gJHNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3RhcnQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgJGlvbmljVmlld1NlcnZpY2UubmV4dFZpZXdPcHRpb25zKHsKICAgICAgICAgICAgICAgICAgICBkaXNhYmxlQW5pbWF0ZTogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBkaXNhYmxlQmFjazogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgdW5yZWdpc3Rlckxpc3RlbmVyKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICR3aW5kb3cuc2V0VGltZW91dCh1bnJlZ2lzdGVyTGlzdGVuZXIsIDMwMCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAkZWxlbWVudC5vbignY2xpY2snLCBsaXN0ZW5Gb3JTdGF0ZUNoYW5nZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XSk7CgogIElvbmljTW9kdWxlLmNvbnN0YW50KCckaW9uaWNOYXZWaWV3Q29uZmlnJywgewogICAgdHJhbnNpdGlvbjogJ3NsaWRlLWxlZnQtcmlnaHQtaW9zNycKICB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvbk5hdlZpZXcKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKiBAY29kZXBlbiBvZHFDegogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQXMgYSB1c2VyIG5hdmlnYXRlcyB0aHJvdWdob3V0IHlvdXIgYXBwLCBJb25pYyBpcyBhYmxlIHRvIGtlZXAgdHJhY2sgb2YgdGhlaXIKICAgKiBuYXZpZ2F0aW9uIGhpc3RvcnkuIEJ5IGtub3dpbmcgdGhlaXIgaGlzdG9yeSwgdHJhbnNpdGlvbnMgYmV0d2VlbiB2aWV3cwogICAqIGNvcnJlY3RseSBzbGlkZSBlaXRoZXIgbGVmdCBvciByaWdodCwgb3Igbm8gdHJhbnNpdGlvbiBhdCBhbGwuIEFuIGFkZGl0aW9uYWwKICAgKiBiZW5lZml0IHRvIElvbmljJ3MgbmF2aWdhdGlvbiBzeXN0ZW0gaXMgaXRzIGFiaWxpdHkgdG8gbWFuYWdlIG11bHRpcGxlCiAgICogaGlzdG9yaWVzLgogICAqCiAgICogSW9uaWMgdXNlcyB0aGUgQW5ndWxhclVJIFJvdXRlciBtb2R1bGUgc28gYXBwIGludGVyZmFjZXMgY2FuIGJlIG9yZ2FuaXplZAogICAqIGludG8gdmFyaW91cyAic3RhdGVzIi4gTGlrZSBBbmd1bGFyJ3MgY29yZSAkcm91dGUgc2VydmljZSwgVVJMcyBjYW4gYmUgdXNlZAogICAqIHRvIGNvbnRyb2wgdGhlIHZpZXdzLiBIb3dldmVyLCB0aGUgQW5ndWxhclVJIFJvdXRlciBwcm92aWRlcyBhIG1vcmUgcG93ZXJmdWwKICAgKiBzdGF0ZSBtYW5hZ2VyIGluIHRoYXQgc3RhdGVzIGFyZSBib3VuZCB0byBuYW1lZCwgbmVzdGVkLCBhbmQgcGFyYWxsZWwgdmlld3MsCiAgICogYWxsb3dpbmcgbW9yZSB0aGFuIG9uZSB0ZW1wbGF0ZSB0byBiZSByZW5kZXJlZCBvbiB0aGUgc2FtZSBwYWdlLgogICAqIEFkZGl0aW9uYWxseSwgZWFjaCBzdGF0ZSBpcyBub3QgcmVxdWlyZWQgdG8gYmUgYm91bmQgdG8gYSBVUkwsIGFuZCBkYXRhIGNhbgogICAqIGJlIHB1c2hlZCB0byBlYWNoIHN0YXRlIHdoaWNoIGFsbG93cyBtdWNoIGZsZXhpYmlsaXR5LgogICAqCiAgICogVGhlIGlvbk5hdlZpZXcgZGlyZWN0aXZlIGlzIHVzZWQgdG8gcmVuZGVyIHRlbXBsYXRlcyBpbiB5b3VyIGFwcGxpY2F0aW9uLiBFYWNoIHRlbXBsYXRlCiAgICogaXMgcGFydCBvZiBhIHN0YXRlLiBTdGF0ZXMgYXJlIHVzdWFsbHkgbWFwcGVkIHRvIGEgdXJsLCBhbmQgYXJlIGRlZmluZWQgcHJvZ3JhbWF0aWNhbGx5CiAgICogdXNpbmcgYW5ndWxhci11aS1yb3V0ZXIgKHNlZSBbdGhlaXIgZG9jc10oaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXItdWkvdWktcm91dGVyL3dpa2kpLAogICAqIGFuZCByZW1lbWJlciB0byByZXBsYWNlIHVpLXZpZXcgd2l0aCBpb24tbmF2LXZpZXcgaW4gZXhhbXBsZXMpLgogICAqCiAgICogQHVzYWdlCiAgICogSW4gdGhpcyBleGFtcGxlLCB3ZSB3aWxsIGNyZWF0ZSBhIG5hdmlnYXRpb24gdmlldyB0aGF0IGNvbnRhaW5zIG91ciBkaWZmZXJlbnQgc3RhdGVzIGZvciB0aGUgYXBwLgogICAqCiAgICogVG8gZG8gdGhpcywgaW4gb3VyIG1hcmt1cCB3ZSB1c2UgaW9uTmF2VmlldyB0b3AgbGV2ZWwgZGlyZWN0aXZlLiBUbyBkaXNwbGF5IGEgaGVhZGVyIGJhciB3ZSB1c2UKICAgKiB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9IGRpcmVjdGl2ZSB0aGF0IHVwZGF0ZXMgYXMgd2UgbmF2aWdhdGUgdGhyb3VnaCB0aGUKICAgKiBuYXZpZ2F0aW9uIHN0YWNrLgogICAqCiAgICogWW91IGNhbiB1c2UgYW55IFthbmltYXRpb24gY2xhc3NdKC9kb2NzL2NvbXBvbmVudHMjYW5pbWF0aW9uKSBvbiB0aGUgbmF2VmlldydzIGBhbmltYXRpb25gIGF0dHJpYnV0ZQogICAqIHRvIGhhdmUgaXRzIHBhZ2VzIGFuaW1hdGUuCiAgICoKICAgKiBSZWNvbW1lbmRlZCBmb3IgcGFnZSB0cmFuc2l0aW9uczogJ3NsaWRlLWxlZnQtcmlnaHQnLCAnc2xpZGUtbGVmdC1yaWdodC1pb3M3JywgJ3NsaWRlLWluLXVwJy4KICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLW5hdi1iYXI+PC9pb24tbmF2LWJhcj4KICAgKiA8aW9uLW5hdi12aWV3IGFuaW1hdGlvbj0ic2xpZGUtbGVmdC1yaWdodCI+CiAgICogICA8IS0tIENlbnRlciBjb250ZW50IC0tPgogICAqIDwvaW9uLW5hdi12aWV3PgogICAqIGBgYAogICAqCiAgICogTmV4dCwgd2UgbmVlZCB0byBzZXR1cCBvdXIgc3RhdGVzIHRoYXQgd2lsbCBiZSByZW5kZXJlZC4KICAgKgogICAqIGBgYGpzCiAgICogdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdteUFwcCcsIFsnaW9uaWMnXSk7CiAgICogYXBwLmNvbmZpZyhmdW5jdGlvbigkc3RhdGVQcm92aWRlcikgewogKiAgICRzdGF0ZVByb3ZpZGVyCiAqICAgLnN0YXRlKCdpbmRleCcsIHsKICogICAgIHVybDogJy8nLAogKiAgICAgdGVtcGxhdGVVcmw6ICdob21lLmh0bWwnCiAqICAgfSkKICogICAuc3RhdGUoJ211c2ljJywgewogKiAgICAgdXJsOiAnL211c2ljJywKICogICAgIHRlbXBsYXRlVXJsOiAnbXVzaWMuaHRtbCcKICogICB9KTsKICogfSk7CiAgICogYGBgCiAgICogVGhlbiBvbiBhcHAgc3RhcnQsICRzdGF0ZVByb3ZpZGVyIHdpbGwgbG9vayBhdCB0aGUgdXJsLCBzZWUgaXQgbWF0Y2hlcyB0aGUgaW5kZXggc3RhdGUsCiAgICogYW5kIHRoZW4gdHJ5IHRvIGxvYWQgaG9tZS5odG1sIGludG8gdGhlIGA8aW9uLW5hdi12aWV3PmAuCiAgICoKICAgKiBQYWdlcyBhcmUgbG9hZGVkIGJ5IHRoZSBVUkxzIGdpdmVuLiBPbmUgc2ltcGxlIHdheSB0byBjcmVhdGUgdGVtcGxhdGVzIGluIEFuZ3VsYXIgaXMgdG8gcHV0CiAgICogdGhlbSBkaXJlY3RseSBpbnRvIHlvdXIgSFRNTCBmaWxlIGFuZCB1c2UgdGhlIGA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiPmAgc3ludGF4LgogICAqIFNvIGhlcmUgaXMgb25lIHdheSB0byBwdXQgaG9tZS5odG1sIGludG8gb3VyIGFwcDoKICAgKgogICAqIGBgYGh0bWwKICAgKiA8c2NyaXB0IGlkPSJob21lIiB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIj4KICAgKiAgIDwhLS0gVGhlIHRpdGxlIG9mIHRoZSBpb24tdmlldyB3aWxsIGJlIHNob3duIG9uIHRoZSBuYXZiYXIgLS0+CiAgICogICA8aW9uLXZpZXcgdGl0bGU9IidIb21lJyI+CiAgICogICAgIDxpb24tY29udGVudCBuZy1jb250cm9sbGVyPSJIb21lQ3RybCI+CiAgICogICAgICAgPCEtLSBUaGUgY29udGVudCBvZiB0aGUgcGFnZSAtLT4KICAgKiAgICAgICA8YSBocmVmPSIjL211c2ljIj5HbyB0byBtdXNpYyBwYWdlITwvYT4KICAgKiAgICAgPC9pb24tY29udGVudD4KICAgKiAgIDwvaW9uLXZpZXc+CiAgICogPC9zY3JpcHQ+CiAgICogYGBgCiAgICoKICAgKiBUaGlzIGlzIGdvb2QgdG8gZG8gYmVjYXVzZSB0aGUgdGVtcGxhdGUgd2lsbCBiZSBjYWNoZWQgZm9yIHZlcnkgZmFzdCBsb2FkaW5nLCBpbnN0ZWFkIG9mCiAgICogaGF2aW5nIHRvIGZldGNoIHRoZW0gZnJvbSB0aGUgbmV0d29yay4KICAgKgogICAqIFBsZWFzZSB2aXNpdCBbQW5ndWxhclVJIFJvdXRlcidzIGRvY3NdKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyLXVpL3VpLXJvdXRlci93aWtpKSBmb3IKICAgKiBtb3JlIGluZm8uIEJlbG93IGlzIGEgZ3JlYXQgdmlkZW8gYnkgdGhlIEFuZ3VsYXJVSSBSb3V0ZXIgZ3V5cyB0aGF0IG1heSBoZWxwIHRvIGV4cGxhaW4KICAgKiBob3cgaXQgYWxsIHdvcmtzOgogICAqCiAgICogPGlmcmFtZSB3aWR0aD0iNTYwIiBoZWlnaHQ9IjMxNSIgc3JjPSIvL3d3dy55b3V0dWJlLmNvbS9lbWJlZC9kcUpSb2g4TW5CbyIKICAgKiBmcmFtZWJvcmRlcj0iMCIgYWxsb3dmdWxsc2NyZWVuPjwvaWZyYW1lPgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIEEgdmlldyBuYW1lLiBUaGUgbmFtZSBzaG91bGQgYmUgdW5pcXVlIGFtb25nc3QgdGhlIG90aGVyIHZpZXdzIGluIHRoZQogICAqIHNhbWUgc3RhdGUuIFlvdSBjYW4gaGF2ZSB2aWV3cyBvZiB0aGUgc2FtZSBuYW1lIHRoYXQgbGl2ZSBpbiBkaWZmZXJlbnQgc3RhdGVzLiBGb3IgbW9yZQogICAqIGluZm9ybWF0aW9uLCBzZWUgdWktcm91dGVyJ3MgW3VpLXZpZXcgZG9jdW1lbnRhdGlvbl0oaHR0cDovL2FuZ3VsYXItdWkuZ2l0aHViLmlvL3VpLXJvdXRlci9zaXRlLyMvYXBpL3VpLnJvdXRlci5zdGF0ZS5kaXJlY3RpdmU6dWktdmlldykuCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvbk5hdlZpZXcnLCBbCiAgICAgICckaW9uaWNWaWV3U2VydmljZScsCiAgICAgICckc3RhdGUnLAogICAgICAnJGNvbXBpbGUnLAogICAgICAnJGNvbnRyb2xsZXInLAogICAgICAnJGFuaW1hdGUnLAogICAgICBmdW5jdGlvbiggJGlvbmljVmlld1NlcnZpY2UsICAgJHN0YXRlLCAgICRjb21waWxlLCAgICRjb250cm9sbGVyLCAgICRhbmltYXRlKSB7CiAgICAgICAgLy8gSU9OSUMncyBmb3JrIG9mIEFuZ3VsYXIgVUkgUm91dGVyLCB2MC4yLjcKICAgICAgICAvLyB0aGUgbmF2VmlldyBoYW5kbGVzIHJlZ2lzdGVyaW5nIHZpZXdzIGluIHRoZSBoaXN0b3J5LCB3aGljaCBhbmltYXRpb24gdG8gdXNlLCBhbmQgd2hpY2gKICAgICAgICB2YXIgdmlld0lzVXBkYXRpbmcgPSBmYWxzZTsKCiAgICAgICAgdmFyIGRpcmVjdGl2ZSA9IHsKICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICAgICAgIHByaW9yaXR5OiAyMDAwLAogICAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICAgIGNvbnRyb2xsZXI6IGZ1bmN0aW9uKCl7fSwKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uIChlbGVtZW50LCBhdHRyLCB0cmFuc2NsdWRlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgbmF2Vmlld0N0cmwpIHsKICAgICAgICAgICAgICB2YXIgdmlld1Njb3BlLCB2aWV3TG9jYWxzLAogICAgICAgICAgICAgICAgbmFtZSA9IGF0dHJbZGlyZWN0aXZlLm5hbWVdIHx8IGF0dHIubmFtZSB8fCAnJywKICAgICAgICAgICAgICAgIG9ubG9hZEV4cCA9IGF0dHIub25sb2FkIHx8ICcnLAogICAgICAgICAgICAgICAgaW5pdGlhbFZpZXcgPSB0cmFuc2NsdWRlKHNjb3BlKTsKCiAgICAgICAgICAgICAgLy8gUHV0IGJhY2sgdGhlIGNvbXBpbGVkIGluaXRpYWwgdmlldwogICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKGluaXRpYWxWaWV3KTsKCiAgICAgICAgICAgICAgLy8gRmluZCB0aGUgZGV0YWlscyBvZiB0aGUgcGFyZW50IHZpZXcgZGlyZWN0aXZlIChpZiBhbnkpIGFuZCB1c2UgaXQKICAgICAgICAgICAgICAvLyB0byBkZXJpdmUgb3VyIG93biBxdWFsaWZpZWQgdmlldyBuYW1lLCB0aGVuIGhhbmcgb3VyIG93biBkZXRhaWxzCiAgICAgICAgICAgICAgLy8gb2ZmIHRoZSBET00gc28gY2hpbGQgZGlyZWN0aXZlcyBjYW4gZmluZCBpdC4KICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnQoKS5pbmhlcml0ZWREYXRhKCckdWlWaWV3Jyk7CiAgICAgICAgICAgICAgaWYgKG5hbWUuaW5kZXhPZignQCcpIDwgMCkgbmFtZSAgPSBuYW1lICsgJ0AnICsgKChwYXJlbnQgJiYgcGFyZW50LnN0YXRlKSA/IHBhcmVudC5zdGF0ZS5uYW1lIDogJycpOwogICAgICAgICAgICAgIHZhciB2aWV3ID0geyBuYW1lOiBuYW1lLCBzdGF0ZTogbnVsbCB9OwogICAgICAgICAgICAgIGVsZW1lbnQuZGF0YSgnJHVpVmlldycsIHZpZXcpOwoKICAgICAgICAgICAgICB2YXIgZXZlbnRIb29rID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAodmlld0lzVXBkYXRpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgIHZpZXdJc1VwZGF0aW5nID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICB0cnkgeyB1cGRhdGVWaWV3KHRydWUpOyB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgIHZpZXdJc1VwZGF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2aWV3SXNVcGRhdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIHNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3VjY2VzcycsIGV2ZW50SG9vayk7CiAgICAgICAgICAgICAgLy8gc2NvcGUuJG9uKCckdmlld0NvbnRlbnRMb2FkaW5nJywgZXZlbnRIb29rKTsKICAgICAgICAgICAgICB1cGRhdGVWaWV3KGZhbHNlKTsKCiAgICAgICAgICAgICAgZnVuY3Rpb24gdXBkYXRlVmlldyhkb0FuaW1hdGUpIHsKICAgICAgICAgICAgICAgIC8vPT09ZmFsc2UgYmVjYXVzZSAkYW5pbWF0ZS5lbmFibGVkKCkgaXMgYSBub29wIHdpdGhvdXQgYW5ndWxhci1hbmltYXRlIGluY2x1ZGVkCiAgICAgICAgICAgICAgICBpZiAoJGFuaW1hdGUuZW5hYmxlZCgpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICBkb0FuaW1hdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgbG9jYWxzID0gJHN0YXRlLiRjdXJyZW50ICYmICRzdGF0ZS4kY3VycmVudC5sb2NhbHNbbmFtZV07CiAgICAgICAgICAgICAgICBpZiAobG9jYWxzID09PSB2aWV3TG9jYWxzKSByZXR1cm47IC8vIG5vdGhpbmcgdG8gZG8KICAgICAgICAgICAgICAgIHZhciByZW5kZXJlciA9ICRpb25pY1ZpZXdTZXJ2aWNlLmdldFJlbmRlcmVyKGVsZW1lbnQsIGF0dHIsIHNjb3BlKTsKCiAgICAgICAgICAgICAgICAvLyBEZXN0cm95IHByZXZpb3VzIHZpZXcgc2NvcGUKICAgICAgICAgICAgICAgIGlmICh2aWV3U2NvcGUpIHsKICAgICAgICAgICAgICAgICAgdmlld1Njb3BlLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgIHZpZXdTY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFsb2NhbHMpIHsKICAgICAgICAgICAgICAgICAgdmlld0xvY2FscyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIHZpZXcuc3RhdGUgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgLy8gUmVzdG9yZSB0aGUgaW5pdGlhbCB2aWV3CiAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50LmFwcGVuZChpbml0aWFsVmlldyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSBqcUxpdGUoJzxkaXY+PC9kaXY+JykuaHRtbChsb2NhbHMuJHRlbXBsYXRlKS5jb250ZW50cygpOwogICAgICAgICAgICAgICAgdmFyIHZpZXdSZWdpc3RlckRhdGEgPSByZW5kZXJlcigpLnJlZ2lzdGVyKG5ld0VsZW1lbnQpOwoKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBleGlzdGluZyBjb250ZW50CiAgICAgICAgICAgICAgICByZW5kZXJlcihkb0FuaW1hdGUpLmxlYXZlKCk7CgogICAgICAgICAgICAgICAgdmlld0xvY2FscyA9IGxvY2FsczsKICAgICAgICAgICAgICAgIHZpZXcuc3RhdGUgPSBsb2NhbHMuJCRzdGF0ZTsKCiAgICAgICAgICAgICAgICByZW5kZXJlcihkb0FuaW1hdGUpLmVudGVyKG5ld0VsZW1lbnQpOwoKICAgICAgICAgICAgICAgIHZhciBsaW5rID0gJGNvbXBpbGUobmV3RWxlbWVudCk7CiAgICAgICAgICAgICAgICB2aWV3U2NvcGUgPSBzY29wZS4kbmV3KCk7CgogICAgICAgICAgICAgICAgdmlld1Njb3BlLiRuYXZEaXJlY3Rpb24gPSB2aWV3UmVnaXN0ZXJEYXRhLm5hdkRpcmVjdGlvbjsKCiAgICAgICAgICAgICAgICBpZiAobG9jYWxzLiQkY29udHJvbGxlcikgewogICAgICAgICAgICAgICAgICBsb2NhbHMuJHNjb3BlID0gdmlld1Njb3BlOwogICAgICAgICAgICAgICAgICB2YXIgY29udHJvbGxlciA9ICRjb250cm9sbGVyKGxvY2Fscy4kJGNvbnRyb2xsZXIsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgIGVsZW1lbnQuY2hpbGRyZW4oKS5kYXRhKCckbmdDb250cm9sbGVyQ29udHJvbGxlcicsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGluayh2aWV3U2NvcGUpOwoKICAgICAgICAgICAgICAgIHZhciB2aWV3SGlzdG9yeURhdGEgPSAkaW9uaWNWaWV3U2VydmljZS5fZ2V0Vmlld0J5SWQodmlld1JlZ2lzdGVyRGF0YS52aWV3SWQpIHx8IHt9OwogICAgICAgICAgICAgICAgdmlld1Njb3BlLiRicm9hZGNhc3QoJyR2aWV3Q29udGVudExvYWRlZCcsIHZpZXdIaXN0b3J5RGF0YSk7CgogICAgICAgICAgICAgICAgaWYgKG9ubG9hZEV4cCkgdmlld1Njb3BlLiRldmFsKG9ubG9hZEV4cCk7CgogICAgICAgICAgICAgICAgbmV3RWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGRpcmVjdGl2ZTsKICAgICAgfV0pOwoKCiAgSW9uaWNNb2R1bGUKCiAgICAuY29uZmlnKFsnJHByb3ZpZGUnLCBmdW5jdGlvbigkcHJvdmlkZSkgewogICAgICAkcHJvdmlkZS5kZWNvcmF0b3IoJ25nQ2xpY2tEaXJlY3RpdmUnLCBbJyRkZWxlZ2F0ZScsIGZ1bmN0aW9uKCRkZWxlZ2F0ZSkgewogICAgICAgIC8vIGRyb3AgdGhlIGRlZmF1bHQgbmdDbGljayBkaXJlY3RpdmUKICAgICAgICAkZGVsZWdhdGUuc2hpZnQoKTsKICAgICAgICByZXR1cm4gJGRlbGVnYXRlOwogICAgICB9XSk7CiAgICB9XSkKCiAgLyoqCiAgICogQHByaXZhdGUKICAgKi8KICAgIC5mYWN0b3J5KCckaW9uaWNOZ0NsaWNrJywgWyckcGFyc2UnLCBmdW5jdGlvbigkcGFyc2UpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBjbGlja0V4cHIpIHsKICAgICAgICB2YXIgY2xpY2tIYW5kbGVyID0gYW5ndWxhci5pc0Z1bmN0aW9uKGNsaWNrRXhwcikgPwogICAgICAgICAgY2xpY2tFeHByIDoKICAgICAgICAgICRwYXJzZShjbGlja0V4cHIpOwoKICAgICAgICBlbGVtZW50Lm9uKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNsaWNrSGFuZGxlcihzY29wZSwgeyRldmVudDogKGV2ZW50KX0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIEhhY2sgZm9yIGlPUyBTYWZhcmkncyBiZW5lZml0LiBJdCBnb2VzIHNlYXJjaGluZyBmb3Igb25jbGljayBoYW5kbGVycyBhbmQgaXMgbGlhYmxlIHRvIGNsaWNrCiAgICAgICAgLy8gc29tZXRoaW5nIGVsc2UgbmVhcmJ5LgogICAgICAgIGVsZW1lbnQub25jbGljayA9IGZ1bmN0aW9uKGV2ZW50KSB7IH07CiAgICAgIH07CiAgICB9XSkKCiAgICAuZGlyZWN0aXZlKCduZ0NsaWNrJywgWyckaW9uaWNOZ0NsaWNrJywgZnVuY3Rpb24oJGlvbmljTmdDbGljaykgewogICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAkaW9uaWNOZ0NsaWNrKHNjb3BlLCBlbGVtZW50LCBhdHRyLm5nQ2xpY2spOwogICAgICB9OwogICAgfV0pCgogICAgLmRpcmVjdGl2ZSgnaW9uU3RvcEV2ZW50JywgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgICAgbGluazogZnVuY3Rpb24gKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICBlbGVtZW50LmJpbmQoYXR0ci5pb25TdG9wRXZlbnQsIGV2ZW50U3RvcFByb3BhZ2F0aW9uKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKICBmdW5jdGlvbiBldmVudFN0b3BQcm9wYWdhdGlvbihlKSB7CiAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogIH0KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25QYW5lCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBFCiAgICoKICAgKiBAZGVzY3JpcHRpb24gQSBzaW1wbGUgY29udGFpbmVyIHRoYXQgZml0cyBjb250ZW50LCB3aXRoIG5vIHNpZGUgZWZmZWN0cy4gIEFkZHMgdGhlICdwYW5lJyBjbGFzcyB0byB0aGUgZWxlbWVudC4KICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uUGFuZScsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3BhbmUnKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKCiAgLyoKICAgKiBXZSBkb24ndCBkb2N1bWVudCB0aGUgaW9uUG9wb3ZlciBkaXJlY3RpdmUsIHdlIGluc3RlYWQgZG9jdW1lbnQKICAgKiB0aGUgJGlvbmljUG9wb3ZlciBzZXJ2aWNlCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvblBvcG92ZXInLCBbZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgY29udHJvbGxlcjogW2Z1bmN0aW9uKCl7fV0sCiAgICAgICAgdGVtcGxhdGU6ICc8ZGl2IGNsYXNzPSJwb3BvdmVyLWJhY2tkcm9wIj4nICsKICAgICAgICAgICc8ZGl2IGNsYXNzPSJwb3BvdmVyLXdyYXBwZXIiIG5nLXRyYW5zY2x1ZGU+PC9kaXY+JyArCiAgICAgICAgICAnPC9kaXY+JwogICAgICB9OwogICAgfV0pOwoKICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uUG9wb3ZlclZpZXcnLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKCBhbmd1bGFyLmVsZW1lbnQoJzxkaXYgY2xhc3M9InBvcG92ZXItYXJyb3ciPjwvZGl2PicpICk7CiAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKCdwb3BvdmVyJyk7CiAgICAgICAgfQogICAgICB9OwogICAgfSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25SYWRpbwogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgRQogICAqIEBjb2RlcGVuIHNhb0JHCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIHJhZGlvIGRpcmVjdGl2ZSBpcyBubyBkaWZmZXJlbnQgdGhhbiB0aGUgSFRNTCByYWRpbyBpbnB1dCwgZXhjZXB0IGl0J3Mgc3R5bGVkIGRpZmZlcmVudGx5LgogICAqCiAgICogUmFkaW8gYmVoYXZlcyBsaWtlIGFueSBbQW5ndWxhckpTIHJhZGlvXShodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy9pbnB1dC9pbnB1dFtyYWRpb10pLgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxpb24tcmFkaW8gbmctbW9kZWw9ImNob2ljZSIgbmctdmFsdWU9IidBJyI+Q2hvb3NlIEE8L2lvbi1yYWRpbz4KICAgKiA8aW9uLXJhZGlvIG5nLW1vZGVsPSJjaG9pY2UiIG5nLXZhbHVlPSInQiciPkNob29zZSBCPC9pb24tcmFkaW8+CiAgICogPGlvbi1yYWRpbyBuZy1tb2RlbD0iY2hvaWNlIiBuZy12YWx1ZT0iJ0MnIj5DaG9vc2UgQzwvaW9uLXJhZGlvPgogICAqIGBgYAogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25SYWRpbycsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLAogICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgdGVtcGxhdGU6CiAgICAgICAgICAnPGxhYmVsIGNsYXNzPSJpdGVtIGl0ZW0tcmFkaW8iPicgKwogICAgICAgICAgJzxpbnB1dCB0eXBlPSJyYWRpbyIgbmFtZT0icmFkaW8tZ3JvdXAiPicgKwogICAgICAgICAgJzxkaXYgY2xhc3M9Iml0ZW0tY29udGVudCBkaXNhYmxlLXBvaW50ZXItZXZlbnRzIiBuZy10cmFuc2NsdWRlPjwvZGl2PicgKwogICAgICAgICAgJzxpIGNsYXNzPSJyYWRpby1pY29uIGRpc2FibGUtcG9pbnRlci1ldmVudHMgaWNvbiBpb24tY2hlY2ttYXJrIj48L2k+JyArCiAgICAgICAgICAnPC9sYWJlbD4nLAoKICAgICAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICBpZihhdHRyLmljb24pIGVsZW1lbnQuY2hpbGRyZW4oKS5lcSgyKS5yZW1vdmVDbGFzcygnaW9uLWNoZWNrbWFyaycpLmFkZENsYXNzKGF0dHIuaWNvbik7CiAgICAgICAgICB2YXIgaW5wdXQgPSBlbGVtZW50LmZpbmQoJ2lucHV0Jyk7CiAgICAgICAgICBmb3JFYWNoKHsKICAgICAgICAgICAgJ25hbWUnOiBhdHRyLm5hbWUsCiAgICAgICAgICAgICd2YWx1ZSc6IGF0dHIudmFsdWUsCiAgICAgICAgICAgICdkaXNhYmxlZCc6IGF0dHIuZGlzYWJsZWQsCiAgICAgICAgICAgICduZy12YWx1ZSc6IGF0dHIubmdWYWx1ZSwKICAgICAgICAgICAgJ25nLW1vZGVsJzogYXR0ci5uZ01vZGVsLAogICAgICAgICAgICAnbmctZGlzYWJsZWQnOiBhdHRyLm5nRGlzYWJsZWQsCiAgICAgICAgICAgICduZy1jaGFuZ2UnOiBhdHRyLm5nQ2hhbmdlCiAgICAgICAgICB9LCBmdW5jdGlvbih2YWx1ZSwgbmFtZSkgewogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgIGlucHV0LmF0dHIobmFtZSwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgc2NvcGUuZ2V0VmFsdWUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gc2NvcGUubmdWYWx1ZSB8fCBhdHRyLnZhbHVlOwogICAgICAgICAgICB9OwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25SZWZyZXNoZXIKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25Db250ZW50LCBpb25pYy5kaXJlY3RpdmU6aW9uU2Nyb2xsCiAgICogQGRlc2NyaXB0aW9uCiAgICogQWxsb3dzIHlvdSB0byBhZGQgcHVsbC10by1yZWZyZXNoIHRvIGEgc2Nyb2xsVmlldy4KICAgKgogICAqIFBsYWNlIGl0IGFzIHRoZSBmaXJzdCBjaGlsZCBvZiB5b3VyIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uQ29udGVudH0gb3IKICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNjcm9sbH0gZWxlbWVudC4KICAgKgogICAqIFdoZW4gcmVmcmVzaGluZyBpcyBjb21wbGV0ZSwgJGJyb2FkY2FzdCB0aGUgJ3Njcm9sbC5yZWZyZXNoQ29tcGxldGUnIGV2ZW50CiAgICogZnJvbSB5b3VyIGNvbnRyb2xsZXIuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLWNvbnRlbnQgbmctY29udHJvbGxlcj0iTXlDb250cm9sbGVyIj4KICAgKiAgIDxpb24tcmVmcmVzaGVyCiAgICogICAgIHB1bGxpbmctdGV4dD0iUHVsbCB0byByZWZyZXNoLi4uIgogICAqICAgICBvbi1yZWZyZXNoPSJkb1JlZnJlc2goKSI+CiAgICogICA8L2lvbi1yZWZyZXNoZXI+CiAgICogICA8aW9uLWxpc3Q+CiAgICogICAgIDxpb24taXRlbSBuZy1yZXBlYXQ9Iml0ZW0gaW4gaXRlbXMiPjwvaW9uLWl0ZW0+CiAgICogICA8L2lvbi1saXN0PgogICAqIDwvaW9uLWNvbnRlbnQ+CiAgICogYGBgCiAgICogYGBganMKICAgKiBhbmd1bGFyLm1vZHVsZSgndGVzdEFwcCcsIFsnaW9uaWMnXSkKICAgKiAuY29udHJvbGxlcignTXlDb250cm9sbGVyJywgZnVuY3Rpb24oJHNjb3BlLCAkaHR0cCkgewogKiAgICRzY29wZS5pdGVtcyA9IFsxLDIsM107CiAqICAgJHNjb3BlLmRvUmVmcmVzaCA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGh0dHAuZ2V0KCcvbmV3LWl0ZW1zJykKICogICAgICAuc3VjY2VzcyhmdW5jdGlvbihuZXdJdGVtcykgewogKiAgICAgICAgJHNjb3BlLml0ZW1zID0gbmV3SXRlbXM7CiAqICAgICAgfSkKICogICAgICAuZmluYWxseShmdW5jdGlvbigpIHsKICogICAgICAgIC8vIFN0b3AgdGhlIGlvbi1yZWZyZXNoZXIgZnJvbSBzcGlubmluZwogKiAgICAgICAgJHNjb3BlLiRicm9hZGNhc3QoJ3Njcm9sbC5yZWZyZXNoQ29tcGxldGUnKTsKICogICAgICB9KTsKICogICB9OwogKiB9KTsKICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXJlZnJlc2ggQ2FsbGVkIHdoZW4gdGhlIHVzZXIgcHVsbHMgZG93biBlbm91Z2ggYW5kIGxldHMgZ28KICAgKiBvZiB0aGUgcmVmcmVzaGVyLgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXB1bGxpbmcgQ2FsbGVkIHdoZW4gdGhlIHVzZXIgc3RhcnRzIHRvIHB1bGwgZG93bgogICAqIG9uIHRoZSByZWZyZXNoZXIuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBwdWxsaW5nLWljb24gVGhlIGljb24gdG8gZGlzcGxheSB3aGlsZSB0aGUgdXNlciBpcyBwdWxsaW5nIGRvd24uCiAgICogRGVmYXVsdDogJ2lvbi1hcnJvdy1kb3duLWMnLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gcHVsbGluZy10ZXh0IFRoZSB0ZXh0IHRvIGRpc3BsYXkgd2hpbGUgdGhlIHVzZXIgaXMgcHVsbGluZyBkb3duLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVmcmVzaGluZy1pY29uIFRoZSBpY29uIHRvIGRpc3BsYXkgYWZ0ZXIgdXNlciBsZXRzIGdvIG9mIHRoZQogICAqIHJlZnJlc2hlci4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlZnJlc2hpbmctdGV4dCBUaGUgdGV4dCB0byBkaXNwbGF5IGFmdGVyIHRoZSB1c2VyIGxldHMgZ28gb2YKICAgKiB0aGUgcmVmcmVzaGVyLgogICAqCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvblJlZnJlc2hlcicsIFsnJGlvbmljQmluZCcsIGZ1bmN0aW9uKCRpb25pY0JpbmQpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgcmVxdWlyZTogJ14kaW9uaWNTY3JvbGwnLAogICAgICAgIHRlbXBsYXRlOgogICAgICAgICAgJzxkaXYgY2xhc3M9InNjcm9sbC1yZWZyZXNoZXIiPicgKwogICAgICAgICAgJzxkaXYgY2xhc3M9ImlvbmljLXJlZnJlc2hlci1jb250ZW50IiAnICsKICAgICAgICAgICduZy1jbGFzcz0ie1wnaW9uaWMtcmVmcmVzaGVyLXdpdGgtdGV4dFwnOiBwdWxsaW5nVGV4dCB8fCByZWZyZXNoaW5nVGV4dH0iPicgKwogICAgICAgICAgJzxkaXYgY2xhc3M9Imljb24tcHVsbGluZyI+JyArCiAgICAgICAgICAnPGkgY2xhc3M9Imljb24ge3twdWxsaW5nSWNvbn19Ij48L2k+JyArCiAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0idGV4dC1wdWxsaW5nIiBuZy1iaW5kLWh0bWw9InB1bGxpbmdUZXh0Ij48L2Rpdj4nICsKICAgICAgICAgICc8aSBjbGFzcz0iaWNvbiB7e3JlZnJlc2hpbmdJY29ufX0gaWNvbi1yZWZyZXNoaW5nIj48L2k+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0idGV4dC1yZWZyZXNoaW5nIiBuZy1iaW5kLWh0bWw9InJlZnJlc2hpbmdUZXh0Ij48L2Rpdj4nICsKICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICc8L2Rpdj4nLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cnMpIHsKICAgICAgICAgIGlmIChhbmd1bGFyLmlzVW5kZWZpbmVkKCRhdHRycy5wdWxsaW5nSWNvbikpIHsKICAgICAgICAgICAgJGF0dHJzLiRzZXQoJ3B1bGxpbmdJY29uJywgJ2lvbi1hcnJvdy1kb3duLWMnKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhbmd1bGFyLmlzVW5kZWZpbmVkKCRhdHRycy5yZWZyZXNoaW5nSWNvbikpIHsKICAgICAgICAgICAgJGF0dHJzLiRzZXQoJ3JlZnJlc2hpbmdJY29uJywgJ2lvbi1sb2FkaW5nLWQnKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsIHNjcm9sbEN0cmwpIHsKICAgICAgICAgICAgJGlvbmljQmluZCgkc2NvcGUsICRhdHRycywgewogICAgICAgICAgICAgIHB1bGxpbmdJY29uOiAnQCcsCiAgICAgICAgICAgICAgcHVsbGluZ1RleHQ6ICdAJywKICAgICAgICAgICAgICByZWZyZXNoaW5nSWNvbjogJ0AnLAogICAgICAgICAgICAgIHJlZnJlc2hpbmdUZXh0OiAnQCcsCiAgICAgICAgICAgICAgJG9uUmVmcmVzaDogJyZvblJlZnJlc2gnLAogICAgICAgICAgICAgICRvblB1bGxpbmc6ICcmb25QdWxsaW5nJwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHNjcm9sbEN0cmwuX3NldFJlZnJlc2hlcigkc2NvcGUsICRlbGVtZW50WzBdKTsKICAgICAgICAgICAgJHNjb3BlLiRvbignc2Nyb2xsLnJlZnJlc2hDb21wbGV0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICRzY29wZS4kZXZhbEFzeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJGVsZW1lbnRbMF0uY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICBzY3JvbGxDdHJsLnNjcm9sbFZpZXcuZmluaXNoUHVsbFRvUmVmcmVzaCgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9OwogICAgfV0pOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgaW9uU2Nyb2xsCiAgICogQG1vZHVsZSBpb25pYwogICAqIEBkZWxlZ2F0ZSBpb25pYy5zZXJ2aWNlOiRpb25pY1Njcm9sbERlbGVnYXRlCiAgICogQGNvZGVwZW4gbXdGdWgKICAgKiBAcmVzdHJpY3QgRQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ3JlYXRlcyBhIHNjcm9sbGFibGUgY29udGFpbmVyIGZvciBhbGwgY29udGVudCBpbnNpZGUuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIEJhc2ljIHVzYWdlOgogICAqCiAgICogYGBgaHRtbAogICAqIDxpb24tc2Nyb2xsIHpvb21pbmc9InRydWUiIGRpcmVjdGlvbj0ieHkiIHN0eWxlPSJ3aWR0aDogNTAwcHg7IGhlaWdodDogNTAwcHgiPgogICAqICAgPGRpdiBzdHlsZT0id2lkdGg6IDUwMDBweDsgaGVpZ2h0OiA1MDAwcHg7IGJhY2tncm91bmQ6IHVybCgnaHR0cHM6Ly91cGxvYWQud2lraW1lZGlhLm9yZy93aWtpcGVkaWEvY29tbW9ucy9hL2FkL0V1cm9wZV9nZW9sb2dpY2FsX21hcC1lbi5qcGcnKSByZXBlYXQiPjwvZGl2PgogICAqICA8L2lvbi1zY3JvbGw+CiAgICogYGBgCiAgICoKICAgKiBOb3RlIHRoYXQgaXQncyBpbXBvcnRhbnQgdG8gc2V0IHRoZSBoZWlnaHQgb2YgdGhlIHNjcm9sbCBib3ggYXMgd2VsbCBhcyB0aGUgaGVpZ2h0IG9mIHRoZSBpbm5lcgogICAqIGNvbnRlbnQgdG8gZW5hYmxlIHNjcm9sbGluZy4gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSB0byBoYXZlIGZ1bGwgY29udHJvbCBvdmVyIHNjcm9sbGFibGUgYXJlYXMuCiAgICoKICAgKiBJZiB5b3UnZCBqdXN0IGxpa2UgdG8gaGF2ZSBhIGNlbnRlciBjb250ZW50IHNjcm9sbGluZyBhcmVhLCB1c2Uge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25Db250ZW50fSBpbnN0ZWFkLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBkZWxlZ2F0ZS1oYW5kbGUgVGhlIGhhbmRsZSB1c2VkIHRvIGlkZW50aWZ5IHRoaXMgc2Nyb2xsVmlldwogICAqIHdpdGgge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljU2Nyb2xsRGVsZWdhdGV9LgogICAqIEBwYXJhbSB7c3RyaW5nPX0gZGlyZWN0aW9uIFdoaWNoIHdheSB0byBzY3JvbGwuICd4JyBvciAneScgb3IgJ3h5Jy4gRGVmYXVsdCAneScuCiAgICogQHBhcmFtIHtib29sZWFuPX0gcGFnaW5nIFdoZXRoZXIgdG8gc2Nyb2xsIHdpdGggcGFnaW5nLgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXJlZnJlc2ggQ2FsbGVkIG9uIHB1bGwtdG8tcmVmcmVzaCwgdHJpZ2dlcmVkIGJ5IGFuIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uUmVmcmVzaGVyfS4KICAgKiBAcGFyYW0ge2V4cHJlc3Npb249fSBvbi1zY3JvbGwgQ2FsbGVkIHdoZW5ldmVyIHRoZSB1c2VyIHNjcm9sbHMuCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2Nyb2xsYmFyLXggV2hldGhlciB0byBzaG93IHRoZSBob3Jpem9udGFsIHNjcm9sbGJhci4gRGVmYXVsdCB0cnVlLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNjcm9sbGJhci15IFdoZXRoZXIgdG8gc2hvdyB0aGUgdmVydGljYWwgc2Nyb2xsYmFyLiBEZWZhdWx0IHRydWUuCiAgICogQHBhcmFtIHtib29sZWFuPX0gem9vbWluZyBXaGV0aGVyIHRvIHN1cHBvcnQgcGluY2gtdG8tem9vbQogICAqIEBwYXJhbSB7aW50ZWdlcj19IG1pbi16b29tIFRoZSBzbWFsbGVzdCB6b29tIGFtb3VudCBhbGxvd2VkIChkZWZhdWx0IGlzIDAuNSkKICAgKiBAcGFyYW0ge2ludGVnZXI9fSBtYXgtem9vbSBUaGUgbGFyZ2VzdCB6b29tIGFtb3VudCBhbGxvd2VkIChkZWZhdWx0IGlzIDMpCiAgICogQHBhcmFtIHtib29sZWFuPX0gaGFzLWJvdW5jaW5nIFdoZXRoZXIgdG8gYWxsb3cgc2Nyb2xsaW5nIHRvIGJvdW5jZSBwYXN0IHRoZSBlZGdlcwogICAqIG9mIHRoZSBjb250ZW50LiAgRGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MsIGZhbHNlIG9uIEFuZHJvaWQuCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvblNjcm9sbCcsIFsKICAgICAgJyR0aW1lb3V0JywKICAgICAgJyRjb250cm9sbGVyJywKICAgICAgJyRpb25pY0JpbmQnLAogICAgICBmdW5jdGlvbigkdGltZW91dCwgJGNvbnRyb2xsZXIsICRpb25pY0JpbmQpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgIHNjb3BlOiB0cnVlLAogICAgICAgICAgY29udHJvbGxlcjogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnc2Nyb2xsLXZpZXcgaW9uaWMtc2Nyb2xsJyk7CgogICAgICAgICAgICAvL1dlIGNhbm5vdCB0cmFuc2NsdWRlIGhlcmUgYmVjYXVzZSBpdCBicmVha3MgZWxlbWVudC5kYXRhKCkgaW5oZXJpdGFuY2Ugb24gY29tcGlsZQogICAgICAgICAgICB2YXIgaW5uZXJFbGVtZW50ID0ganFMaXRlKCc8ZGl2IGNsYXNzPSJzY3JvbGwiPjwvZGl2PicpOwogICAgICAgICAgICBpbm5lckVsZW1lbnQuYXBwZW5kKGVsZW1lbnQuY29udGVudHMoKSk7CiAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKGlubmVyRWxlbWVudCk7CgogICAgICAgICAgICByZXR1cm4geyBwcmU6IHByZWxpbmsgfTsKICAgICAgICAgICAgZnVuY3Rpb24gcHJlbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0cikgewogICAgICAgICAgICAgIHZhciBzY3JvbGxWaWV3LCBzY3JvbGxDdHJsOwoKICAgICAgICAgICAgICAkaW9uaWNCaW5kKCRzY29wZSwgJGF0dHIsIHsKICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogJ0AnLAogICAgICAgICAgICAgICAgcGFnaW5nOiAnQCcsCiAgICAgICAgICAgICAgICAkb25TY3JvbGw6ICcmb25TY3JvbGwnLAogICAgICAgICAgICAgICAgc2Nyb2xsOiAnQCcsCiAgICAgICAgICAgICAgICBzY3JvbGxiYXJYOiAnQCcsCiAgICAgICAgICAgICAgICBzY3JvbGxiYXJZOiAnQCcsCiAgICAgICAgICAgICAgICB6b29taW5nOiAnQCcsCiAgICAgICAgICAgICAgICBtaW5ab29tOiAnQCcsCiAgICAgICAgICAgICAgICBtYXhab29tOiAnQCcKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAkc2NvcGUuZGlyZWN0aW9uID0gJHNjb3BlLmRpcmVjdGlvbiB8fCAneSc7CgogICAgICAgICAgICAgIGlmIChhbmd1bGFyLmlzRGVmaW5lZCgkYXR0ci5wYWRkaW5nKSkgewogICAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgkYXR0ci5wYWRkaW5nLCBmdW5jdGlvbihuZXdWYWwpIHsKICAgICAgICAgICAgICAgICAgaW5uZXJFbGVtZW50LnRvZ2dsZUNsYXNzKCdwYWRkaW5nJywgISFuZXdWYWwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmKCRzY29wZS4kZXZhbCgkc2NvcGUucGFnaW5nKSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgaW5uZXJFbGVtZW50LmFkZENsYXNzKCdzY3JvbGwtcGFnaW5nJyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZighJHNjb3BlLmRpcmVjdGlvbikgeyAkc2NvcGUuZGlyZWN0aW9uID0gJ3knOyB9CiAgICAgICAgICAgICAgdmFyIGlzUGFnaW5nID0gJHNjb3BlLiRldmFsKCRzY29wZS5wYWdpbmcpID09PSB0cnVlOwoKICAgICAgICAgICAgICB2YXIgc2Nyb2xsVmlld09wdGlvbnM9IHsKICAgICAgICAgICAgICAgIGVsOiAkZWxlbWVudFswXSwKICAgICAgICAgICAgICAgIGRlbGVnYXRlSGFuZGxlOiAkYXR0ci5kZWxlZ2F0ZUhhbmRsZSwKICAgICAgICAgICAgICAgIGJvdW5jaW5nOiAkc2NvcGUuJGV2YWwoJGF0dHIuaGFzQm91bmNpbmcpLAogICAgICAgICAgICAgICAgcGFnaW5nOiBpc1BhZ2luZywKICAgICAgICAgICAgICAgIHNjcm9sbGJhclg6ICRzY29wZS4kZXZhbCgkc2NvcGUuc2Nyb2xsYmFyWCkgIT09IGZhbHNlLAogICAgICAgICAgICAgICAgc2Nyb2xsYmFyWTogJHNjb3BlLiRldmFsKCRzY29wZS5zY3JvbGxiYXJZKSAhPT0gZmFsc2UsCiAgICAgICAgICAgICAgICBzY3JvbGxpbmdYOiAkc2NvcGUuZGlyZWN0aW9uLmluZGV4T2YoJ3gnKSA+PSAwLAogICAgICAgICAgICAgICAgc2Nyb2xsaW5nWTogJHNjb3BlLmRpcmVjdGlvbi5pbmRleE9mKCd5JykgPj0gMCwKICAgICAgICAgICAgICAgIHpvb21pbmc6ICRzY29wZS4kZXZhbCgkc2NvcGUuem9vbWluZykgPT09IHRydWUsCiAgICAgICAgICAgICAgICBtYXhab29tOiAkc2NvcGUuJGV2YWwoJHNjb3BlLm1heFpvb20pIHx8IDMsCiAgICAgICAgICAgICAgICBtaW5ab29tOiAkc2NvcGUuJGV2YWwoJHNjb3BlLm1pblpvb20pIHx8IDAuNQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKGlzUGFnaW5nKSB7CiAgICAgICAgICAgICAgICBzY3JvbGxWaWV3T3B0aW9ucy5zcGVlZE11bHRpcGxpZXIgPSAwLjg7CiAgICAgICAgICAgICAgICBzY3JvbGxWaWV3T3B0aW9ucy5ib3VuY2luZyA9IGZhbHNlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgc2Nyb2xsQ3RybCA9ICRjb250cm9sbGVyKCckaW9uaWNTY3JvbGwnLCB7CiAgICAgICAgICAgICAgICAkc2NvcGU6ICRzY29wZSwKICAgICAgICAgICAgICAgIHNjcm9sbFZpZXdPcHRpb25zOiBzY3JvbGxWaWV3T3B0aW9ucwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHNjcm9sbFZpZXcgPSAkc2NvcGUuJHBhcmVudC5zY3JvbGxWaWV3ID0gc2Nyb2xsQ3RybC5zY3JvbGxWaWV3OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfV0pOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgaW9uU2lkZU1lbnUKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEEgY29udGFpbmVyIGZvciBhIHNpZGUgbWVudSwgc2libGluZyB0byBhbiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51Q29udGVudH0gZGlyZWN0aXZlLgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxpb24tc2lkZS1tZW51CiAgICogICBzaWRlPSJsZWZ0IgogICAqICAgd2lkdGg9Im15V2lkdGhWYWx1ZSArIDIwIgogICAqICAgaXMtZW5hYmxlZD0ic2hvdWxkTGVmdFNpZGVNZW51QmVFbmFibGVkKCkiPgogICAqIDwvaW9uLXNpZGUtbWVudT4KICAgKiBgYGAKICAgKiBGb3IgYSBjb21wbGV0ZSBzaWRlIG1lbnUgZXhhbXBsZSwgc2VlIHRoZQogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnVzfSBkb2N1bWVudGF0aW9uLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHNpZGUgV2hpY2ggc2lkZSB0aGUgc2lkZSBtZW51IGlzIGN1cnJlbnRseSBvbi4gIEFsbG93ZWQgdmFsdWVzOiAnbGVmdCcgb3IgJ3JpZ2h0Jy4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBpcy1lbmFibGVkIFdoZXRoZXIgdGhpcyBzaWRlIG1lbnUgaXMgZW5hYmxlZC4KICAgKiBAcGFyYW0ge251bWJlcj19IHdpZHRoIEhvdyBtYW55IHBpeGVscyB3aWRlIHRoZSBzaWRlIG1lbnUgc2hvdWxkIGJlLiAgRGVmYXVsdHMgdG8gMjc1LgogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25TaWRlTWVudScsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZTogJ15pb25TaWRlTWVudXMnLAogICAgICAgIHNjb3BlOiB0cnVlLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIGFuZ3VsYXIuaXNVbmRlZmluZWQoYXR0ci5pc0VuYWJsZWQpICYmIGF0dHIuJHNldCgnaXNFbmFibGVkJywgJ3RydWUnKTsKICAgICAgICAgIGFuZ3VsYXIuaXNVbmRlZmluZWQoYXR0ci53aWR0aCkgJiYgYXR0ci4kc2V0KCd3aWR0aCcsICcyNzUnKTsKCiAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKCdtZW51IG1lbnUtJyArIGF0dHIuc2lkZSk7CgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBzaWRlTWVudUN0cmwpIHsKICAgICAgICAgICAgJHNjb3BlLnNpZGUgPSAkYXR0ci5zaWRlIHx8ICdsZWZ0JzsKCiAgICAgICAgICAgIHZhciBzaWRlTWVudSA9IHNpZGVNZW51Q3RybFskc2NvcGUuc2lkZV0gPSBuZXcgaW9uaWMudmlld3MuU2lkZU1lbnUoewogICAgICAgICAgICAgIHdpZHRoOiAyNzUsCiAgICAgICAgICAgICAgZWw6ICRlbGVtZW50WzBdLAogICAgICAgICAgICAgIGlzRW5hYmxlZDogdHJ1ZQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICRzY29wZS4kd2F0Y2goJGF0dHIud2lkdGgsIGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgIHZhciBudW1iZXJWYWwgPSArdmFsOwogICAgICAgICAgICAgIGlmIChudW1iZXJWYWwgJiYgbnVtYmVyVmFsID09IHZhbCkgewogICAgICAgICAgICAgICAgc2lkZU1lbnUuc2V0V2lkdGgoK3ZhbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgkYXR0ci5pc0VuYWJsZWQsIGZ1bmN0aW9uKHZhbCkgewogICAgICAgICAgICAgIHNpZGVNZW51LnNldElzRW5hYmxlZCghIXZhbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25TaWRlTWVudUNvbnRlbnQKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEEgY29udGFpbmVyIGZvciB0aGUgbWFpbiB2aXNpYmxlIGNvbnRlbnQsIHNpYmxpbmcgdG8gb25lIG9yIG1vcmUKICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51fSBkaXJlY3RpdmVzLgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxpb24tc2lkZS1tZW51LWNvbnRlbnQKICAgKiAgIGVkZ2UtZHJhZy10aHJlc2hvbGQ9InRydWUiCiAgICogICBkcmFnLWNvbnRlbnQ9InRydWUiPgogICAqIDwvaW9uLXNpZGUtbWVudS1jb250ZW50PgogICAqIGBgYAogICAqIEZvciBhIGNvbXBsZXRlIHNpZGUgbWVudSBleGFtcGxlLCBzZWUgdGhlCiAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXN9IGRvY3VtZW50YXRpb24uCiAgICoKICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBkcmFnLWNvbnRlbnQgV2hldGhlciB0aGUgY29udGVudCBjYW4gYmUgZHJhZ2dlZC4gRGVmYXVsdCB0cnVlLgogICAqIEBwYXJhbSB7Ym9vbGVhbnxudW1iZXI9fSBlZGdlLWRyYWctdGhyZXNob2xkIFdoZXRoZXIgdGhlIGNvbnRlbnQgZHJhZyBjYW4gb25seSBzdGFydCBpZiBpdCBpcyBiZWxvdyBhIGNlcnRhaW4gdGhyZXNob2xkIGRpc3RhbmNlIGZyb20gdGhlIGVkZ2Ugb2YgdGhlIHNjcmVlbi4gIERlZmF1bHQgZmFsc2UuIEFjY2VwdHMgdGhyZWUgdHlwZXMgb2YgdmFsdWVzOgogICAqICAtIElmIGEgbm9uLXplcm8gbnVtYmVyIGlzIGdpdmVuLCB0aGF0IG1hbnkgcGl4ZWxzIGlzIHVzZWQgYXMgdGhlIG1heGltdW0gYWxsb3dlZCBkaXN0YW5jZSBmcm9tIHRoZSBlZGdlIHRoYXQgc3RhcnRzIGRyYWdnaW5nIHRoZSBzaWRlIG1lbnUuCiAgICogIC0gSWYgdHJ1ZSBpcyBnaXZlbiwgdGhlIGRlZmF1bHQgbnVtYmVyIG9mIHBpeGVscyAoMjUpIGlzIHVzZWQgYXMgdGhlIG1heGltdW0gYWxsb3dlZCBkaXN0YW5jZS4KICAgKiAgLSBJZiBmYWxzZSBvciAwIGlzIGdpdmVuLCB0aGUgZWRnZSBkcmFnIHRocmVzaG9sZCBpcyBkaXNhYmxlZCwgYW5kIGRyYWdnaW5nIGZyb20gYW55d2hlcmUgb24gdGhlIGNvbnRlbnQgaXMgYWxsb3dlZC4KICAgKgogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25TaWRlTWVudUNvbnRlbnQnLCBbCiAgICAgICckdGltZW91dCcsCiAgICAgICckaW9uaWNHZXN0dXJlJywKICAgICAgZnVuY3Rpb24oJHRpbWVvdXQsICRpb25pY0dlc3R1cmUpIHsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHJlc3RyaWN0OiAnRUEnLCAvL0RFUFJFQ0FURUQgJ0EnCiAgICAgICAgICByZXF1aXJlOiAnXmlvblNpZGVNZW51cycsCiAgICAgICAgICBzY29wZTogdHJ1ZSwKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgcmV0dXJuIHsgcHJlOiBwcmVsaW5rIH07CiAgICAgICAgICAgIGZ1bmN0aW9uIHByZWxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNpZGVNZW51Q3RybCkgewoKICAgICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcygnbWVudS1jb250ZW50IHBhbmUnKTsKCiAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChhdHRyLmRyYWdDb250ZW50KSkgewogICAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChhdHRyLmRyYWdDb250ZW50LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICBzaWRlTWVudUN0cmwuY2FuRHJhZ0NvbnRlbnQodmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNpZGVNZW51Q3RybC5jYW5EcmFnQ29udGVudCh0cnVlKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChpc0RlZmluZWQoYXR0ci5lZGdlRHJhZ1RocmVzaG9sZCkpIHsKICAgICAgICAgICAgICAgICRzY29wZS4kd2F0Y2goYXR0ci5lZGdlRHJhZ1RocmVzaG9sZCwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgc2lkZU1lbnVDdHJsLmVkZ2VEcmFnVGhyZXNob2xkKHZhbHVlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgdmFyIGRlZmF1bHRQcmV2ZW50ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgaXNEcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgICAvLyBMaXN0ZW4gZm9yIHRhcHMgb24gdGhlIGNvbnRlbnQgdG8gY2xvc2UgdGhlIG1lbnUKICAgICAgICAgICAgICBmdW5jdGlvbiBjb250ZW50VGFwKGUpIHsKICAgICAgICAgICAgICAgIGlmKHNpZGVNZW51Q3RybC5nZXRPcGVuQW1vdW50KCkgIT09IDApIHsKICAgICAgICAgICAgICAgICAgc2lkZU1lbnVDdHJsLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgIGUuZ2VzdHVyZS5zcmNFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpb25pYy5vbigndGFwJywgY29udGVudFRhcCwgJGVsZW1lbnRbMF0pOwoKICAgICAgICAgICAgICB2YXIgZHJhZ0ZuID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgaWYoZGVmYXVsdFByZXZlbnRlZCB8fCAhc2lkZU1lbnVDdHJsLmlzRHJhZ2dhYmxlVGFyZ2V0KGUpKSByZXR1cm47CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHNpZGVNZW51Q3RybC5faGFuZGxlRHJhZyhlKTsKICAgICAgICAgICAgICAgIGUuZ2VzdHVyZS5zcmNFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIHZhciBkcmFnVmVydEZuID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgaWYoaXNEcmFnZ2luZykgewogICAgICAgICAgICAgICAgICBlLmdlc3R1cmUuc3JjRXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAvL3ZhciBkcmFnR2VzdHVyZSA9IEdlc3R1cmUub24oJ2RyYWcnLCBkcmFnRm4sICRlbGVtZW50KTsKICAgICAgICAgICAgICB2YXIgZHJhZ1JpZ2h0R2VzdHVyZSA9ICRpb25pY0dlc3R1cmUub24oJ2RyYWdyaWdodCcsIGRyYWdGbiwgJGVsZW1lbnQpOwogICAgICAgICAgICAgIHZhciBkcmFnTGVmdEdlc3R1cmUgPSAkaW9uaWNHZXN0dXJlLm9uKCdkcmFnbGVmdCcsIGRyYWdGbiwgJGVsZW1lbnQpOwogICAgICAgICAgICAgIHZhciBkcmFnVXBHZXN0dXJlID0gJGlvbmljR2VzdHVyZS5vbignZHJhZ3VwJywgZHJhZ1ZlcnRGbiwgJGVsZW1lbnQpOwogICAgICAgICAgICAgIHZhciBkcmFnRG93bkdlc3R1cmUgPSAkaW9uaWNHZXN0dXJlLm9uKCdkcmFnZG93bicsIGRyYWdWZXJ0Rm4sICRlbGVtZW50KTsKCiAgICAgICAgICAgICAgdmFyIGRyYWdSZWxlYXNlRm4gPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZighZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgICAgICBzaWRlTWVudUN0cmwuX2VuZERyYWcoZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgdmFyIHJlbGVhc2VHZXN0dXJlID0gJGlvbmljR2VzdHVyZS5vbigncmVsZWFzZScsIGRyYWdSZWxlYXNlRm4sICRlbGVtZW50KTsKCiAgICAgICAgICAgICAgc2lkZU1lbnVDdHJsLnNldENvbnRlbnQoewogICAgICAgICAgICAgICAgZWxlbWVudDogZWxlbWVudFswXSwKICAgICAgICAgICAgICAgIG9uRHJhZzogZnVuY3Rpb24oZSkge30sCiAgICAgICAgICAgICAgICBlbmREcmFnOiBmdW5jdGlvbihlKSB7fSwKICAgICAgICAgICAgICAgIGdldFRyYW5zbGF0ZVg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gJHNjb3BlLnNpZGVNZW51Q29udGVudFRyYW5zbGF0ZVggfHwgMDsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXRUcmFuc2xhdGVYOiBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlKGZ1bmN0aW9uKGFtb3VudCkgewogICAgICAgICAgICAgICAgICAkZWxlbWVudFswXS5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICd0cmFuc2xhdGUzZCgnICsgYW1vdW50ICsgJ3B4LCAwLCAwKSc7CiAgICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICRzY29wZS5zaWRlTWVudUNvbnRlbnRUcmFuc2xhdGVYID0gYW1vdW50OwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgZW5hYmxlQW5pbWF0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgLy90aGlzLmVsLmNsYXNzTGlzdC5hZGQodGhpcy5hbmltYXRlQ2xhc3MpOwogICAgICAgICAgICAgICAgICAkc2NvcGUuYW5pbWF0aW9uRW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICRlbGVtZW50WzBdLmNsYXNzTGlzdC5hZGQoJ21lbnUtYW5pbWF0ZWQnKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkaXNhYmxlQW5pbWF0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgLy90aGlzLmVsLmNsYXNzTGlzdC5yZW1vdmUodGhpcy5hbmltYXRlQ2xhc3MpOwogICAgICAgICAgICAgICAgICAkc2NvcGUuYW5pbWF0aW9uRW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAkZWxlbWVudFswXS5jbGFzc0xpc3QucmVtb3ZlKCdtZW51LWFuaW1hdGVkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIC8vIENsZWFudXAKICAgICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJGlvbmljR2VzdHVyZS5vZmYoZHJhZ0xlZnRHZXN0dXJlLCAnZHJhZ2xlZnQnLCBkcmFnRm4pOwogICAgICAgICAgICAgICAgJGlvbmljR2VzdHVyZS5vZmYoZHJhZ1JpZ2h0R2VzdHVyZSwgJ2RyYWdyaWdodCcsIGRyYWdGbik7CiAgICAgICAgICAgICAgICAkaW9uaWNHZXN0dXJlLm9mZihkcmFnVXBHZXN0dXJlLCAnZHJhZ3VwJywgZHJhZ0ZuKTsKICAgICAgICAgICAgICAgICRpb25pY0dlc3R1cmUub2ZmKGRyYWdEb3duR2VzdHVyZSwgJ2RyYWdkb3duJywgZHJhZ0ZuKTsKICAgICAgICAgICAgICAgICRpb25pY0dlc3R1cmUub2ZmKHJlbGVhc2VHZXN0dXJlLCAncmVsZWFzZScsIGRyYWdSZWxlYXNlRm4pOwogICAgICAgICAgICAgICAgaW9uaWMub2ZmKCd0YXAnLCBjb250ZW50VGFwLCAkZWxlbWVudFswXSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XSk7CgogIElvbmljTW9kdWxlCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25TaWRlTWVudXMKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljU2lkZU1lbnVEZWxlZ2F0ZQogICAqIEByZXN0cmljdCBFCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBIGNvbnRhaW5lciBlbGVtZW50IGZvciBzaWRlIG1lbnUocykgYW5kIHRoZSBtYWluIGNvbnRlbnQuIEFsbG93cyB0aGUgbGVmdAogICAqIGFuZC9vciByaWdodCBzaWRlIG1lbnUgdG8gYmUgdG9nZ2xlZCBieSBkcmFnZ2luZyB0aGUgbWFpbiBjb250ZW50IGFyZWEgc2lkZQogICAqIHRvIHNpZGUuCiAgICoKICAgKiBUbyBhdXRvbWF0aWNhbGx5IGNsb3NlIGFuIG9wZW5lZCBtZW51IHlvdSBjYW4gYWRkIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOm1lbnVDbG9zZX0KICAgKiBhdHRyaWJ1dGUgZGlyZWN0aXZlLiBJbmNsdWRpbmcgdGhlIGBtZW51LWNsb3NlYCBhdHRyaWJ1dGUgaXMgdXN1YWxseSBhZGRlZCB0bwogICAqIGxpbmtzIGFuZCBidXR0b25zIHdpdGhpbiBgaW9uLXNpZGUtbWVudWAgY29udGVudCwgc28gdGhhdCB3aGVuIHRoZSBlbGVtZW50IGlzCiAgICogY2xpY2tlZCB0aGVuIHRoZSBvcGVuZWQgc2lkZSBtZW51IHdpbGwgYXV0b21hdGljYWxseSBjbG9zZS4KICAgKgogICAqICFbU2lkZSBNZW51XShodHRwOi8vaW9uaWNmcmFtZXdvcmsuY29tLnMzLmFtYXpvbmF3cy5jb20vZG9jcy9jb250cm9sbGVycy9zaWRlbWVudS5naWYpCiAgICoKICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiBzaWRlIG1lbnVzLCBjaGVjayBvdXQ6CiAgICoKICAgKiAtIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnVDb250ZW50fQogICAqIC0ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudX0KICAgKiAtIHtAbGluayBpb25pYy5kaXJlY3RpdmU6bWVudUNsb3NlfQogICAqCiAgICogQHVzYWdlCiAgICogVG8gdXNlIHNpZGUgbWVudXMsIGFkZCBhbiBgPGlvbi1zaWRlLW1lbnVzPmAgcGFyZW50IGVsZW1lbnQsCiAgICogYW4gYDxpb24tc2lkZS1tZW51LWNvbnRlbnQ+YCBmb3IgdGhlIGNlbnRlciBjb250ZW50LAogICAqIGFuZCBvbmUgb3IgbW9yZSBgPGlvbi1zaWRlLW1lbnU+YCBkaXJlY3RpdmVzLgogICAqCiAgICogYGBgaHRtbAogICAqIDxpb24tc2lkZS1tZW51cz4KICAgKiAgIDwhLS0gQ2VudGVyIGNvbnRlbnQgLS0+CiAgICogICA8aW9uLXNpZGUtbWVudS1jb250ZW50IG5nLWNvbnRyb2xsZXI9IkNvbnRlbnRDb250cm9sbGVyIj4KICAgKiAgIDwvaW9uLXNpZGUtbWVudS1jb250ZW50PgogICAqCiAgICogICA8IS0tIExlZnQgbWVudSAtLT4KICAgKiAgIDxpb24tc2lkZS1tZW51IHNpZGU9ImxlZnQiPgogICAqICAgPC9pb24tc2lkZS1tZW51PgogICAqCiAgICogICA8IS0tIFJpZ2h0IG1lbnUgLS0+CiAgICogICA8aW9uLXNpZGUtbWVudSBzaWRlPSJyaWdodCI+CiAgICogICA8L2lvbi1zaWRlLW1lbnU+CiAgICogPC9pb24tc2lkZS1tZW51cz4KICAgKiBgYGAKICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIENvbnRlbnRDb250cm9sbGVyKCRzY29wZSwgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSkgewogKiAgICRzY29wZS50b2dnbGVMZWZ0ID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNTaWRlTWVudURlbGVnYXRlLnRvZ2dsZUxlZnQoKTsKICogICB9OwogKiB9CiAgICogYGBgCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IGRlbGVnYXRlLWhhbmRsZSBUaGUgaGFuZGxlIHVzZWQgdG8gaWRlbnRpZnkgdGhpcyBzaWRlIG1lbnUKICAgKiB3aXRoIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1NpZGVNZW51RGVsZWdhdGV9LgogICAqCiAgICovCiAgICAuZGlyZWN0aXZlKCdpb25TaWRlTWVudXMnLCBbJyRkb2N1bWVudCcsIGZ1bmN0aW9uKCRkb2N1bWVudCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRUNBJywKICAgICAgICBjb250cm9sbGVyOiAnJGlvbmljU2lkZU1lbnVzJywKICAgICAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICBhdHRyLiRzZXQoJ2NsYXNzJywgKGF0dHJbJ2NsYXNzJ10gfHwgJycpICsgJyB2aWV3Jyk7CgogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSkgewogICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgJGRvY3VtZW50WzBdLmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnbWVudS1vcGVuJyk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9OwogICAgfV0pOwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvblNsaWRlQm94CiAgICogQG1vZHVsZSBpb25pYwogICAqIEBkZWxlZ2F0ZSBpb25pYy5zZXJ2aWNlOiRpb25pY1NsaWRlQm94RGVsZWdhdGUKICAgKiBAcmVzdHJpY3QgRQogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBTbGlkZSBCb3ggaXMgYSBtdWx0aS1wYWdlIGNvbnRhaW5lciB3aGVyZSBlYWNoIHBhZ2UgY2FuIGJlIHN3aXBlZCBvciBkcmFnZ2VkIGJldHdlZW46CiAgICoKICAgKiAhW1NsaWRlQm94XShodHRwOi8vaW9uaWNmcmFtZXdvcmsuY29tLnMzLmFtYXpvbmF3cy5jb20vZG9jcy9jb250cm9sbGVycy9zbGlkZUJveC5naWYpCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGlvbi1zbGlkZS1ib3ggb24tc2xpZGUtY2hhbmdlZD0ic2xpZGVIYXNDaGFuZ2VkKCRpbmRleCkiPgogICAqICAgPGlvbi1zbGlkZT4KICAgKiAgICAgPGRpdiBjbGFzcz0iYm94IGJsdWUiPjxoMT5CTFVFPC9oMT48L2Rpdj4KICAgKiAgIDwvaW9uLXNsaWRlPgogICAqICAgPGlvbi1zbGlkZT4KICAgKiAgICAgPGRpdiBjbGFzcz0iYm94IHllbGxvdyI+PGgxPllFTExPVzwvaDE+PC9kaXY+CiAgICogICA8L2lvbi1zbGlkZT4KICAgKiAgIDxpb24tc2xpZGU+CiAgICogICAgIDxkaXYgY2xhc3M9ImJveCBwaW5rIj48aDE+UElOSzwvaDE+PC9kaXY+CiAgICogICA8L2lvbi1zbGlkZT4KICAgKiA8L2lvbi1zbGlkZS1ib3g+CiAgICogYGBgCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IGRlbGVnYXRlLWhhbmRsZSBUaGUgaGFuZGxlIHVzZWQgdG8gaWRlbnRpZnkgdGhpcyBzbGlkZUJveAogICAqIHdpdGgge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljU2xpZGVCb3hEZWxlZ2F0ZX0uCiAgICogQHBhcmFtIHtib29sZWFuPX0gZG9lcy1jb250aW51ZSBXaGV0aGVyIHRoZSBzbGlkZSBib3ggc2hvdWxkIGxvb3AuCiAgICogQHBhcmFtIHtib29sZWFuPX0gYXV0by1wbGF5IFdoZXRoZXIgdGhlIHNsaWRlIGJveCBzaG91bGQgYXV0b21hdGljYWxseSBzbGlkZS4gRGVmYXVsdCB0cnVlIGlmIGRvZXMtY29udGludWUgaXMgdHJ1ZS4KICAgKiBAcGFyYW0ge251bWJlcj19IHNsaWRlLWludGVydmFsIEhvdyBtYW55IG1pbGxpc2Vjb25kcyB0byB3YWl0IHRvIGNoYW5nZSBzbGlkZXMgKGlmIGRvZXMtY29udGludWUgaXMgdHJ1ZSkuIERlZmF1bHRzIHRvIDQwMDAuCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdy1wYWdlciBXaGV0aGVyIGEgcGFnZXIgc2hvdWxkIGJlIHNob3duIGZvciB0aGlzIHNsaWRlIGJveC4KICAgKiBAcGFyYW0ge2V4cHJlc3Npb249fSBwYWdlci1jbGljayBFeHByZXNzaW9uIHRvIGNhbGwgd2hlbiBhIHBhZ2VyIGlzIGNsaWNrZWQgKGlmIHNob3ctcGFnZXIgaXMgdHJ1ZSkuIElzIHBhc3NlZCB0aGUgJ2luZGV4JyB2YXJpYWJsZS4KICAgKiBAcGFyYW0ge2V4cHJlc3Npb249fSBvbi1zbGlkZS1jaGFuZ2VkIEV4cHJlc3Npb24gY2FsbGVkIHdoZW5ldmVyIHRoZSBzbGlkZSBpcyBjaGFuZ2VkLiAgSXMgcGFzc2VkIGFuICckaW5kZXgnIHZhcmlhYmxlLgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IGFjdGl2ZS1zbGlkZSBNb2RlbCB0byBiaW5kIHRoZSBjdXJyZW50IHNsaWRlIHRvLgogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25TbGlkZUJveCcsIFsKICAgICAgJyR0aW1lb3V0JywKICAgICAgJyRjb21waWxlJywKICAgICAgJyRpb25pY1NsaWRlQm94RGVsZWdhdGUnLAogICAgICBmdW5jdGlvbigkdGltZW91dCwgJGNvbXBpbGUsICRpb25pY1NsaWRlQm94RGVsZWdhdGUpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgICAgc2NvcGU6IHsKICAgICAgICAgICAgYXV0b1BsYXk6ICc9JywKICAgICAgICAgICAgZG9lc0NvbnRpbnVlOiAnQCcsCiAgICAgICAgICAgIHNsaWRlSW50ZXJ2YWw6ICdAJywKICAgICAgICAgICAgc2hvd1BhZ2VyOiAnQCcsCiAgICAgICAgICAgIHBhZ2VyQ2xpY2s6ICcmJywKICAgICAgICAgICAgZGlzYWJsZVNjcm9sbDogJ0AnLAogICAgICAgICAgICBvblNsaWRlQ2hhbmdlZDogJyYnLAogICAgICAgICAgICBhY3RpdmVTbGlkZTogJz0/JwogICAgICAgICAgfSwKICAgICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgJyRhdHRycycsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycykgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIGNvbnRpbnVvdXMgPSAkc2NvcGUuJGV2YWwoJHNjb3BlLmRvZXNDb250aW51ZSkgPT09IHRydWU7CiAgICAgICAgICAgIHZhciBzaG91bGRBdXRvUGxheSA9IGlzRGVmaW5lZCgkYXR0cnMuYXV0b1BsYXkpID8gISEkc2NvcGUuYXV0b1BsYXkgOiBmYWxzZTsKICAgICAgICAgICAgdmFyIHNsaWRlSW50ZXJ2YWwgPSBzaG91bGRBdXRvUGxheSA/ICRzY29wZS4kZXZhbCgkc2NvcGUuc2xpZGVJbnRlcnZhbCkgfHwgNDAwMCA6IDA7CgogICAgICAgICAgICB2YXIgc2xpZGVyID0gbmV3IGlvbmljLnZpZXdzLlNsaWRlcih7CiAgICAgICAgICAgICAgZWw6ICRlbGVtZW50WzBdLAogICAgICAgICAgICAgIGF1dG86IHNsaWRlSW50ZXJ2YWwsCiAgICAgICAgICAgICAgY29udGludW91czogY29udGludW91cywKICAgICAgICAgICAgICBzdGFydFNsaWRlOiAkc2NvcGUuYWN0aXZlU2xpZGUsCiAgICAgICAgICAgICAgc2xpZGVzQ2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuY3VycmVudFNsaWRlID0gc2xpZGVyLmN1cnJlbnRJbmRleCgpOwoKICAgICAgICAgICAgICAgIC8vIFRyeSB0byB0cmlnZ2VyIGEgZGlnZXN0CiAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHt9KTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihzbGlkZUluZGV4KSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuY3VycmVudFNsaWRlID0gc2xpZGVJbmRleDsKICAgICAgICAgICAgICAgICRzY29wZS5vblNsaWRlQ2hhbmdlZCh7IGluZGV4OiAkc2NvcGUuY3VycmVudFNsaWRlLCAkaW5kZXg6ICRzY29wZS5jdXJyZW50U2xpZGV9KTsKICAgICAgICAgICAgICAgICRzY29wZS4kcGFyZW50LiRicm9hZGNhc3QoJ3NsaWRlQm94LnNsaWRlQ2hhbmdlZCcsIHNsaWRlSW5kZXgpOwogICAgICAgICAgICAgICAgJHNjb3BlLmFjdGl2ZVNsaWRlID0gc2xpZGVJbmRleDsKICAgICAgICAgICAgICAgIC8vIFRyeSB0byB0cmlnZ2VyIGEgZGlnZXN0CiAgICAgICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHt9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc2xpZGVyLmVuYWJsZVNsaWRlKCRzY29wZS4kZXZhbCgkYXR0cnMuZGlzYWJsZVNjcm9sbCkgIT09IHRydWUpOwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnYWN0aXZlU2xpZGUnLCBmdW5jdGlvbihudikgewogICAgICAgICAgICAgIGlmKGFuZ3VsYXIuaXNEZWZpbmVkKG52KSl7CiAgICAgICAgICAgICAgICBzbGlkZXIuc2xpZGUobnYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkc2NvcGUuJG9uKCdzbGlkZUJveC5uZXh0U2xpZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzbGlkZXIubmV4dCgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICRzY29wZS4kb24oJ3NsaWRlQm94LnByZXZTbGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNsaWRlci5wcmV2KCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgJHNjb3BlLiRvbignc2xpZGVCb3guc2V0U2xpZGUnLCBmdW5jdGlvbihlLCBpbmRleCkgewogICAgICAgICAgICAgIHNsaWRlci5zbGlkZShpbmRleCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy9FeHBvc2VkIGZvciB0ZXN0aW5nCiAgICAgICAgICAgIHRoaXMuX19zbGlkZXIgPSBzbGlkZXI7CgogICAgICAgICAgICB2YXIgZGVyZWdpc3Rlckluc3RhbmNlID0gJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZS5fcmVnaXN0ZXJJbnN0YW5jZShzbGlkZXIsICRhdHRycy5kZWxlZ2F0ZUhhbmRsZSk7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZGVyZWdpc3Rlckluc3RhbmNlKTsKCiAgICAgICAgICAgIHRoaXMuc2xpZGVzQ291bnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gc2xpZGVyLnNsaWRlc0NvdW50KCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLm9uUGFnZXJDbGljayA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgICAgdm9pZCAwOwogICAgICAgICAgICAgICRzY29wZS5wYWdlckNsaWNrKHtpbmRleDogaW5kZXh9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNsaWRlci5sb2FkKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfV0sCiAgICAgICAgICB0ZW1wbGF0ZTogJzxkaXYgY2xhc3M9InNsaWRlciI+JyArCiAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJzbGlkZXItc2xpZGVzIiBuZy10cmFuc2NsdWRlPicgKwogICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICc8L2Rpdj4nLAoKICAgICAgICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBzbGlkZUJveEN0cmwpIHsKICAgICAgICAgICAgLy8gSWYgdGhlIHBhZ2VyIHNob3VsZCBzaG93LCBhcHBlbmQgaXQgdG8gdGhlIHNsaWRlIGJveAogICAgICAgICAgICBpZigkc2NvcGUuJGV2YWwoJHNjb3BlLnNob3dQYWdlcikgIT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkU2NvcGUgPSAkc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgIHZhciBwYWdlciA9IGpxTGl0ZSgnPGlvbi1wYWdlcj48L2lvbi1wYWdlcj4nKTsKICAgICAgICAgICAgICAkZWxlbWVudC5hcHBlbmQocGFnZXIpOwogICAgICAgICAgICAgICRjb21waWxlKHBhZ2VyKShjaGlsZFNjb3BlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH1dKQogICAgLmRpcmVjdGl2ZSgnaW9uU2xpZGUnLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcXVpcmU6ICdeaW9uU2xpZGVCb3gnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3NsaWRlci1zbGlkZScpOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgIH07CiAgICB9KQoKICAgIC5kaXJlY3RpdmUoJ2lvblBhZ2VyJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHJlcXVpcmU6ICdeaW9uU2xpZGVCb3gnLAogICAgICAgIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0ic2xpZGVyLXBhZ2VyIj48c3BhbiBjbGFzcz0ic2xpZGVyLXBhZ2VyLXBhZ2UiIG5nLXJlcGVhdD0ic2xpZGUgaW4gbnVtU2xpZGVzKCkgdHJhY2sgYnkgJGluZGV4IiBuZy1jbGFzcz0ie2FjdGl2ZTogJGluZGV4ID09IGN1cnJlbnRTbGlkZX0iIG5nLWNsaWNrPSJwYWdlckNsaWNrKCRpbmRleCkiPjxpIGNsYXNzPSJpY29uIGlvbi1yZWNvcmQiPjwvaT48L3NwYW4+PC9kaXY+JywKICAgICAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgc2xpZGVCb3gpIHsKICAgICAgICAgIHZhciBzZWxlY3RQYWdlID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gJGVsZW1lbnRbMF0uY2hpbGRyZW47CiAgICAgICAgICAgIHZhciBsZW5ndGggPSBjaGlsZHJlbi5sZW5ndGg7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGlmKGkgPT0gaW5kZXgpIHsKICAgICAgICAgICAgICAgIGNoaWxkcmVuW2ldLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjaGlsZHJlbltpXS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgJHNjb3BlLnBhZ2VyQ2xpY2sgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgICBzbGlkZUJveC5vblBhZ2VyQ2xpY2soaW5kZXgpOwogICAgICAgICAgfTsKCiAgICAgICAgICAkc2NvcGUubnVtU2xpZGVzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQXJyYXkoc2xpZGVCb3guc2xpZGVzQ291bnQoKSk7CiAgICAgICAgICB9OwoKICAgICAgICAgICRzY29wZS4kd2F0Y2goJ2N1cnJlbnRTbGlkZScsIGZ1bmN0aW9uKHYpIHsKICAgICAgICAgICAgc2VsZWN0UGFnZSh2KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICB9KTsKCiAgSW9uaWNNb2R1bGUuY29uc3RhbnQoJyRpb25pY1RhYkNvbmZpZycsIHsKICAgIHR5cGU6ICcnCiAgfSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25UYWIKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25UYWJzCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDb250YWlucyBhIHRhYidzIGNvbnRlbnQuICBUaGUgY29udGVudCBvbmx5IGV4aXN0cyB3aGlsZSB0aGUgZ2l2ZW4gdGFiIGlzIHNlbGVjdGVkLgogICAqCiAgICogRWFjaCBpb25UYWIgaGFzIGl0cyBvd24gdmlldyBoaXN0b3J5LgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxpb24tdGFiCiAgICogICB0aXRsZT0iVGFiISIKICAgKiAgIGljb249Im15LWljb24iCiAgICogICBocmVmPSIjL3RhYi90YWItbGluayIKICAgKiAgIG9uLXNlbGVjdD0ib25UYWJTZWxlY3RlZCgpIgogICAqICAgb24tZGVzZWxlY3Q9Im9uVGFiRGVzZWxlY3RlZCgpIj4KICAgKiA8L2lvbi10YWI+CiAgICogYGBgCiAgICogRm9yIGEgY29tcGxldGUsIHdvcmtpbmcgdGFiIGJhciBleGFtcGxlLCBzZWUgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uVGFic30gZG9jdW1lbnRhdGlvbi4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB0aXRsZSBUaGUgdGl0bGUgb2YgdGhlIHRhYi4KICAgKiBAcGFyYW0ge3N0cmluZz19IGhyZWYgVGhlIGxpbmsgdGhhdCB0aGlzIHRhYiB3aWxsIG5hdmlnYXRlIHRvIHdoZW4gdGFwcGVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gaWNvbiBUaGUgaWNvbiBvZiB0aGUgdGFiLiBJZiBnaXZlbiwgdGhpcyB3aWxsIGJlY29tZSB0aGUgZGVmYXVsdCBmb3IgaWNvbi1vbiBhbmQgaWNvbi1vZmYuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBpY29uLW9uIFRoZSBpY29uIG9mIHRoZSB0YWIgd2hpbGUgaXQgaXMgc2VsZWN0ZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBpY29uLW9mZiBUaGUgaWNvbiBvZiB0aGUgdGFiIHdoaWxlIGl0IGlzIG5vdCBzZWxlY3RlZC4KICAgKiBAcGFyYW0ge2V4cHJlc3Npb249fSBiYWRnZSBUaGUgYmFkZ2UgdG8gcHV0IG9uIHRoaXMgdGFiICh1c3VhbGx5IGEgbnVtYmVyKS4KICAgKiBAcGFyYW0ge2V4cHJlc3Npb249fSBiYWRnZS1zdHlsZSBUaGUgc3R5bGUgb2YgYmFkZ2UgdG8gcHV0IG9uIHRoaXMgdGFiIChlZyB0YWJzLXBvc2l0aXZlKS4KICAgKiBAcGFyYW0ge2V4cHJlc3Npb249fSBvbi1zZWxlY3QgQ2FsbGVkIHdoZW4gdGhpcyB0YWIgaXMgc2VsZWN0ZWQuCiAgICogQHBhcmFtIHtleHByZXNzaW9uPX0gb24tZGVzZWxlY3QgQ2FsbGVkIHdoZW4gdGhpcyB0YWIgaXMgZGVzZWxlY3RlZC4KICAgKiBAcGFyYW0ge2V4cHJlc3Npb249fSBuZy1jbGljayBCeSBkZWZhdWx0LCB0aGUgdGFiIHdpbGwgYmUgc2VsZWN0ZWQgb24gY2xpY2suIElmIG5nQ2xpY2sgaXMgc2V0LCBpdCB3aWxsIG5vdC4gIFlvdSBjYW4gZXhwbGljaXRseSBzd2l0Y2ggdGFicyB1c2luZyB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNUYWJzRGVsZWdhdGUjc2VsZWN0ICRpb25pY1RhYnNEZWxlZ2F0ZS5zZWxlY3QoKX0uCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvblRhYicsIFsKICAgICAgJyRyb290U2NvcGUnLAogICAgICAnJGFuaW1hdGUnLAogICAgICAnJGlvbmljQmluZCcsCiAgICAgICckY29tcGlsZScsCiAgICAgIGZ1bmN0aW9uKCRyb290U2NvcGUsICRhbmltYXRlLCAkaW9uaWNCaW5kLCAkY29tcGlsZSkgewoKICAgICAgICAvL1JldHVybnMgJyBrZXk9InZhbHVlIicgaWYgdmFsdWUgZXhpc3RzCiAgICAgICAgZnVuY3Rpb24gYXR0clN0cihrLHYpIHsKICAgICAgICAgIHJldHVybiBhbmd1bGFyLmlzRGVmaW5lZCh2KSA/ICcgJyArIGsgKyAnPSInICsgdiArICciJyA6ICcnOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgIHJlcXVpcmU6IFsnXmlvblRhYnMnLCAnaW9uVGFiJ10sCiAgICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgICAgY29udHJvbGxlcjogJyRpb25pY1RhYicsCiAgICAgICAgICBzY29wZTogdHJ1ZSwKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKCiAgICAgICAgICAgIC8vV2UgY3JlYXRlIHRoZSB0YWJOYXZUZW1wbGF0ZSBpbiB0aGUgY29tcGlsZSBwaGFzZSBzbyB0aGF0IHRoZQogICAgICAgICAgICAvL2F0dHJpYnV0ZXMgd2UgcGFzcyBkb3duIHdvbid0IGJlIGludGVycG9sYXRlZCB5ZXQgLSB3ZSB3YW50CiAgICAgICAgICAgIC8vdG8gcGFzcyBkb3duIHRoZSAncmF3JyB2ZXJzaW9ucyBvZiB0aGUgYXR0cmlidXRlcwogICAgICAgICAgICB2YXIgdGFiTmF2VGVtcGxhdGUgPSAnPGlvbi10YWItbmF2JyArCiAgICAgICAgICAgICAgYXR0clN0cignbmctY2xpY2snLCBhdHRyLm5nQ2xpY2spICsKICAgICAgICAgICAgICBhdHRyU3RyKCd0aXRsZScsIGF0dHIudGl0bGUpICsKICAgICAgICAgICAgICBhdHRyU3RyKCdpY29uJywgYXR0ci5pY29uKSArCiAgICAgICAgICAgICAgYXR0clN0cignaWNvbi1vbicsIGF0dHIuaWNvbk9uKSArCiAgICAgICAgICAgICAgYXR0clN0cignaWNvbi1vZmYnLCBhdHRyLmljb25PZmYpICsKICAgICAgICAgICAgICBhdHRyU3RyKCdiYWRnZScsIGF0dHIuYmFkZ2UpICsKICAgICAgICAgICAgICBhdHRyU3RyKCdiYWRnZS1zdHlsZScsIGF0dHIuYmFkZ2VTdHlsZSkgKwogICAgICAgICAgICAgIGF0dHJTdHIoJ2hpZGRlbicsIGF0dHIuaGlkZGVuKSArCiAgICAgICAgICAgICAgYXR0clN0cignY2xhc3MnLCBhdHRyWydjbGFzcyddKSArCiAgICAgICAgICAgICAgJz48L2lvbi10YWItbmF2Pic7CgogICAgICAgICAgICAvL1JlbW92ZSB0aGUgY29udGVudHMgb2YgdGhlIGVsZW1lbnQgc28gd2UgY2FuIGNvbXBpbGUgdGhlbSBsYXRlciwgaWYgdGFiIGlzIHNlbGVjdGVkCiAgICAgICAgICAgIC8vV2UgZG9uJ3QgdXNlIHJlZ3VsYXIgdHJhbnNjbHVzaW9uIGJlY2F1c2UgaXQgYnJlYWtzIGVsZW1lbnQgaW5oZXJpdGFuY2UKICAgICAgICAgICAgdmFyIHRhYkNvbnRlbnQgPSBqcUxpdGUoJzxkaXYgY2xhc3M9InBhbmUiPicpCiAgICAgICAgICAgICAgLmFwcGVuZCggZWxlbWVudC5jb250ZW50cygpLnJlbW92ZSgpICk7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgY3RybHMpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRTY29wZTsKICAgICAgICAgICAgICB2YXIgY2hpbGRFbGVtZW50OwogICAgICAgICAgICAgIHZhciB0YWJzQ3RybCA9IGN0cmxzWzBdOwogICAgICAgICAgICAgIHZhciB0YWJDdHJsID0gY3RybHNbMV07CgogICAgICAgICAgICAgIHZhciBuYXZWaWV3ID0gdGFiQ29udGVudFswXS5xdWVyeVNlbGVjdG9yKCdpb24tbmF2LXZpZXcnKSB8fAogICAgICAgICAgICAgICAgdGFiQ29udGVudFswXS5xdWVyeVNlbGVjdG9yKCdkYXRhLWlvbi1uYXYtdmlldycpOwogICAgICAgICAgICAgIHZhciBuYXZWaWV3TmFtZSA9IG5hdlZpZXcgJiYgbmF2Vmlldy5nZXRBdHRyaWJ1dGUoJ25hbWUnKTsKCiAgICAgICAgICAgICAgJGlvbmljQmluZCgkc2NvcGUsICRhdHRyLCB7CiAgICAgICAgICAgICAgICBhbmltYXRlOiAnPScsCiAgICAgICAgICAgICAgICBvblNlbGVjdDogJyYnLAogICAgICAgICAgICAgICAgb25EZXNlbGVjdDogJyYnLAogICAgICAgICAgICAgICAgdGl0bGU6ICdAJywKICAgICAgICAgICAgICAgIHVpU3JlZjogJ0AnLAogICAgICAgICAgICAgICAgaHJlZjogJ0AnLAogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICB0YWJzQ3RybC5hZGQoJHNjb3BlKTsKICAgICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGFic0N0cmwucmVtb3ZlKCRzY29wZSk7CiAgICAgICAgICAgICAgICB0YWJOYXZFbGVtZW50Lmlzb2xhdGVTY29wZSgpLiRkZXN0cm95KCk7CiAgICAgICAgICAgICAgICB0YWJOYXZFbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAvL1JlbW92ZSB0aXRsZSBhdHRyaWJ1dGUgc28gYnJvd3Nlci10b29sdGlwIGRvZXMgbm90IGFwZWFyCiAgICAgICAgICAgICAgJGVsZW1lbnRbMF0ucmVtb3ZlQXR0cmlidXRlKCd0aXRsZScpOwoKICAgICAgICAgICAgICBpZiAobmF2Vmlld05hbWUpIHsKICAgICAgICAgICAgICAgIHRhYkN0cmwubmF2Vmlld05hbWUgPSBuYXZWaWV3TmFtZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgJHNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3VjY2VzcycsIHNlbGVjdElmTWF0Y2hlc1N0YXRlKTsKICAgICAgICAgICAgICBzZWxlY3RJZk1hdGNoZXNTdGF0ZSgpOwogICAgICAgICAgICAgIGZ1bmN0aW9uIHNlbGVjdElmTWF0Y2hlc1N0YXRlKCkgewogICAgICAgICAgICAgICAgaWYgKHRhYkN0cmwudGFiTWF0Y2hlc1N0YXRlKCkpIHsKICAgICAgICAgICAgICAgICAgdGFic0N0cmwuc2VsZWN0KCRzY29wZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB2YXIgdGFiTmF2RWxlbWVudCA9IGpxTGl0ZSh0YWJOYXZUZW1wbGF0ZSk7CiAgICAgICAgICAgICAgdGFiTmF2RWxlbWVudC5kYXRhKCckaW9uVGFic0NvbnRyb2xsZXInLCB0YWJzQ3RybCk7CiAgICAgICAgICAgICAgdGFiTmF2RWxlbWVudC5kYXRhKCckaW9uVGFiQ29udHJvbGxlcicsIHRhYkN0cmwpOwogICAgICAgICAgICAgIHRhYnNDdHJsLiR0YWJzRWxlbWVudC5hcHBlbmQoJGNvbXBpbGUodGFiTmF2RWxlbWVudCkoJHNjb3BlKSk7CgogICAgICAgICAgICAgICRzY29wZS4kd2F0Y2goJyR0YWJTZWxlY3RlZCcsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjaGlsZFNjb3BlICYmIGNoaWxkU2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgICAgY2hpbGRFbGVtZW50ICYmICRhbmltYXRlLmxlYXZlKGNoaWxkRWxlbWVudCk7CiAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQgPSBudWxsOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSAkc2NvcGUuJG5ldygpOwogICAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQgPSB0YWJDb250ZW50LmNsb25lKCk7CiAgICAgICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGNoaWxkRWxlbWVudCwgdGFic0N0cmwuJGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICAkY29tcGlsZShjaGlsZEVsZW1lbnQpKGNoaWxkU2NvcGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XSk7CgogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25UYWJOYXYnLCBbZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHJlcXVpcmU6IFsnXmlvblRhYnMnLCAnXmlvblRhYiddLAogICAgICAgIHRlbXBsYXRlOgogICAgICAgICAgJzxhIG5nLWNsYXNzPSJ7XCd0YWItaXRlbS1hY3RpdmVcJzogaXNUYWJBY3RpdmUoKSwgXCdoYXMtYmFkZ2VcJzpiYWRnZSwgXCd0YWItaGlkZGVuXCc6aXNIaWRkZW4oKX0iICcgKwogICAgICAgICAgJyBjbGFzcz0idGFiLWl0ZW0iPicgKwogICAgICAgICAgJzxzcGFuIGNsYXNzPSJiYWRnZSB7e2JhZGdlU3R5bGV9fSIgbmctaWY9ImJhZGdlIj57e2JhZGdlfX08L3NwYW4+JyArCiAgICAgICAgICAnPGkgY2xhc3M9Imljb24ge3tnZXRJY29uT24oKX19IiBuZy1pZj0iZ2V0SWNvbk9uKCkgJiYgaXNUYWJBY3RpdmUoKSI+PC9pPicgKwogICAgICAgICAgJzxpIGNsYXNzPSJpY29uIHt7Z2V0SWNvbk9mZigpfX0iIG5nLWlmPSJnZXRJY29uT2ZmKCkgJiYgIWlzVGFiQWN0aXZlKCkiPjwvaT4nICsKICAgICAgICAgICc8c3BhbiBjbGFzcz0idGFiLXRpdGxlIiBuZy1iaW5kLWh0bWw9InRpdGxlIj48L3NwYW4+JyArCiAgICAgICAgICAnPC9hPicsCiAgICAgICAgc2NvcGU6IHsKICAgICAgICAgIHRpdGxlOiAnQCcsCiAgICAgICAgICBpY29uOiAnQCcsCiAgICAgICAgICBpY29uT246ICdAJywKICAgICAgICAgIGljb25PZmY6ICdAJywKICAgICAgICAgIGJhZGdlOiAnPScsCiAgICAgICAgICBoaWRkZW46ICdAJywKICAgICAgICAgIGJhZGdlU3R5bGU6ICdAJywKICAgICAgICAgICdjbGFzcyc6ICdAJwogICAgICAgIH0sCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0ciwgdHJhbnNjbHVkZSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzLCBjdHJscykgewogICAgICAgICAgICB2YXIgdGFic0N0cmwgPSBjdHJsc1swXSwKICAgICAgICAgICAgICB0YWJDdHJsID0gY3RybHNbMV07CgogICAgICAgICAgICAvL1JlbW92ZSB0aXRsZSBhdHRyaWJ1dGUgc28gYnJvd3Nlci10b29sdGlwIGRvZXMgbm90IGFwZWFyCiAgICAgICAgICAgICRlbGVtZW50WzBdLnJlbW92ZUF0dHJpYnV0ZSgndGl0bGUnKTsKCiAgICAgICAgICAgICRzY29wZS5zZWxlY3RUYWIgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgIHRhYnNDdHJsLnNlbGVjdCh0YWJDdHJsLiRzY29wZSwgdHJ1ZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICghJGF0dHJzLm5nQ2xpY2spIHsKICAgICAgICAgICAgICAkZWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgICAgJHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgJHNjb3BlLnNlbGVjdFRhYihldmVudCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHNjb3BlLmlzSGlkZGVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYoJGF0dHJzLmhpZGRlbiA9PT0gJ3RydWUnIHx8ICRhdHRycy5oaWRkZW4gPT09IHRydWUpcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJHNjb3BlLmdldEljb25PbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAkc2NvcGUuaWNvbk9uIHx8ICRzY29wZS5pY29uOwogICAgICAgICAgICB9OwogICAgICAgICAgICAkc2NvcGUuZ2V0SWNvbk9mZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiAkc2NvcGUuaWNvbk9mZiB8fCAkc2NvcGUuaWNvbjsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICRzY29wZS5pc1RhYkFjdGl2ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0YWJzQ3RybC5zZWxlY3RlZFRhYigpID09PSB0YWJDdHJsLiRzY29wZTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9OwogICAgfV0pOwoKICBJb25pY01vZHVsZS5jb25zdGFudCgnJGlvbmljVGFic0NvbmZpZycsIHsKICAgIHBvc2l0aW9uOiAnJywKICAgIHR5cGU6ICcnCiAgfSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25UYWJzCiAgICogQG1vZHVsZSBpb25pYwogICAqIEBkZWxlZ2F0ZSBpb25pYy5zZXJ2aWNlOiRpb25pY1RhYnNEZWxlZ2F0ZQogICAqIEByZXN0cmljdCBFCiAgICogQGNvZGVwZW4gS2JyekoKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFBvd2VycyBhIG11bHRpLXRhYmJlZCBpbnRlcmZhY2Ugd2l0aCBhIFRhYiBCYXIgYW5kIGEgc2V0IG9mICJwYWdlcyIgdGhhdCBjYW4gYmUgdGFiYmVkCiAgICogdGhyb3VnaC4KICAgKgogICAqIEFzc2lnbiBhbnkgW3RhYnMgY2xhc3NdKC9kb2NzL2NvbXBvbmVudHMjdGFicykgb3IKICAgKiBbYW5pbWF0aW9uIGNsYXNzXSgvZG9jcy9jb21wb25lbnRzI2FuaW1hdGlvbikgdG8gdGhlIGVsZW1lbnQgdG8gZGVmaW5lCiAgICogaXRzIGxvb2sgYW5kIGZlZWwuCiAgICoKICAgKiBTZWUgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uVGFifSBkaXJlY3RpdmUncyBkb2N1bWVudGF0aW9uIGZvciBtb3JlIGRldGFpbHMgb24KICAgKiBpbmRpdmlkdWFsIHRhYnMuCiAgICoKICAgKiBOb3RlOiBkbyBub3QgcGxhY2UgaW9uLXRhYnMgaW5zaWRlIG9mIGFuIGlvbi1jb250ZW50IGVsZW1lbnQ7IGl0IGhhcyBiZWVuIGtub3duIHRvIGNhdXNlIGEKICAgKiBjZXJ0YWluIENTUyBidWcuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGlvbi10YWJzIGNsYXNzPSJ0YWJzLXBvc2l0aXZlIHRhYnMtaWNvbi1vbmx5Ij4KICAgKgogICAqICAgPGlvbi10YWIgdGl0bGU9IkhvbWUiIGljb24tb249Imlvbi1pb3M3LWZpbGluZyIgaWNvbi1vZmY9Imlvbi1pb3M3LWZpbGluZy1vdXRsaW5lIj4KICAgKiAgICAgPCEtLSBUYWIgMSBjb250ZW50IC0tPgogICAqICAgPC9pb24tdGFiPgogICAqCiAgICogICA8aW9uLXRhYiB0aXRsZT0iQWJvdXQiIGljb24tb249Imlvbi1pb3M3LWNsb2NrIiBpY29uLW9mZj0iaW9uLWlvczctY2xvY2stb3V0bGluZSI+CiAgICogICAgIDwhLS0gVGFiIDIgY29udGVudCAtLT4KICAgKiAgIDwvaW9uLXRhYj4KICAgKgogICAqICAgPGlvbi10YWIgdGl0bGU9IlNldHRpbmdzIiBpY29uLW9uPSJpb24taW9zNy1nZWFyIiBpY29uLW9mZj0iaW9uLWlvczctZ2Vhci1vdXRsaW5lIj4KICAgKiAgICAgPCEtLSBUYWIgMyBjb250ZW50IC0tPgogICAqICAgPC9pb24tdGFiPgogICAqCiAgICogPC9pb24tdGFicz4KICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gZGVsZWdhdGUtaGFuZGxlIFRoZSBoYW5kbGUgdXNlZCB0byBpZGVudGlmeSB0aGVzZSB0YWJzCiAgICogd2l0aCB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNUYWJzRGVsZWdhdGV9LgogICAqLwoKICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uVGFicycsIFsKICAgICAgJyRpb25pY1ZpZXdTZXJ2aWNlJywKICAgICAgJyRpb25pY1RhYnNEZWxlZ2F0ZScsCiAgICAgICckaW9uaWNUYWJzQ29uZmlnJywKICAgICAgZnVuY3Rpb24oJGlvbmljVmlld1NlcnZpY2UsICRpb25pY1RhYnNEZWxlZ2F0ZSwgJGlvbmljVGFic0NvbmZpZykgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgc2NvcGU6IHRydWUsCiAgICAgICAgICBjb250cm9sbGVyOiAnJGlvbmljVGFicycsCiAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3ZpZXcnKTsKICAgICAgICAgICAgLy9XZSBjYW5ub3QgdXNlIHJlZ3VsYXIgdHJhbnNjbHVkZSBoZXJlIGJlY2F1c2UgaXQgYnJlYWtzIGVsZW1lbnQuZGF0YSgpCiAgICAgICAgICAgIC8vaW5oZXJpdGFuY2Ugb24gY29tcGlsZQogICAgICAgICAgICB2YXIgaW5uZXJFbGVtZW50ID0ganFMaXRlKCc8ZGl2IGNsYXNzPSJ0YWJzIj48L2Rpdj4nKTsKICAgICAgICAgICAgaW5uZXJFbGVtZW50LmFwcGVuZChlbGVtZW50LmNvbnRlbnRzKCkpOwogICAgICAgICAgICBlbGVtZW50LmFwcGVuZChpbm5lckVsZW1lbnQpOwogICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKCRpb25pY1RhYnNDb25maWcucG9zaXRpb24pOwogICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKCRpb25pY1RhYnNDb25maWcudHlwZSk7CgogICAgICAgICAgICByZXR1cm4geyBwcmU6IHByZWxpbmsgfTsKICAgICAgICAgICAgZnVuY3Rpb24gcHJlbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgdGFic0N0cmwpIHsKICAgICAgICAgICAgICB2YXIgZGVyZWdpc3Rlckluc3RhbmNlID0gJGlvbmljVGFic0RlbGVnYXRlLl9yZWdpc3Rlckluc3RhbmNlKAogICAgICAgICAgICAgICAgdGFic0N0cmwsICRhdHRyLmRlbGVnYXRlSGFuZGxlCiAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBkZXJlZ2lzdGVySW5zdGFuY2UpOwoKICAgICAgICAgICAgICB0YWJzQ3RybC4kc2NvcGUgPSAkc2NvcGU7CiAgICAgICAgICAgICAgdGFic0N0cmwuJGVsZW1lbnQgPSAkZWxlbWVudDsKICAgICAgICAgICAgICB0YWJzQ3RybC4kdGFic0VsZW1lbnQgPSBqcUxpdGUoJGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignLnRhYnMnKSk7CgogICAgICAgICAgICAgIHZhciBlbCA9ICRlbGVtZW50WzBdOwogICAgICAgICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7IHJldHVybiBlbC5jbGFzc05hbWU7IH0sIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNUYWJzVG9wID0gdmFsdWUuaW5kZXhPZigndGFicy10b3AnKSAhPT0gLTE7CiAgICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSB2YWx1ZS5pbmRleE9mKCd0YWJzLWl0ZW0taGlkZScpICE9PSAtMTsKICAgICAgICAgICAgICAgICRzY29wZS4kaGFzVGFicyA9ICFpc1RhYnNUb3AgJiYgIWlzSGlkZGVuOwogICAgICAgICAgICAgICAgJHNjb3BlLiRoYXNUYWJzVG9wID0gaXNUYWJzVG9wICYmICFpc0hpZGRlbjsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZGVsZXRlICRzY29wZS4kaGFzVGFiczsKICAgICAgICAgICAgICAgIGRlbGV0ZSAkc2NvcGUuJGhhc1RhYnNUb3A7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25Ub2dnbGUKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGNvZGVwZW4gdGZBemoKICAgKiBAcmVzdHJpY3QgRQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQSB0b2dnbGUgaXMgYW4gYW5pbWF0ZWQgc3dpdGNoIHdoaWNoIGJpbmRzIGEgZ2l2ZW4gbW9kZWwgdG8gYSBib29sZWFuLgogICAqCiAgICogQWxsb3dzIGRyYWdnaW5nIG9mIHRoZSBzd2l0Y2gncyBudWIuCiAgICoKICAgKiBUaGUgdG9nZ2xlIGJlaGF2ZXMgbGlrZSBhbnkgW0FuZ3VsYXJKUyBjaGVja2JveF0oaHR0cDovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvbmcvaW5wdXQvaW5wdXRbY2hlY2tib3hdKSBvdGhlcndpc2UuCiAgICoKICAgKiBAcGFyYW0gdG9nZ2xlLWNsYXNzIHtzdHJpbmc9fSBTZXRzIHRoZSBDU1MgY2xhc3Mgb24gdGhlIGlubmVyIGBsYWJlbC50b2dnbGVgIGVsZW1lbnQgY3JlYXRlZCBieSB0aGUgZGlyZWN0aXZlLgogICAqCiAgICogQHVzYWdlCiAgICogQmVsb3cgaXMgYW4gZXhhbXBsZSBvZiBhIHRvZ2dsZSBkaXJlY3RpdmUgd2hpY2ggaXMgd2lyZWQgdXAgdG8gdGhlIGBhaXJwbGFuZU1vZGVgIG1vZGVsCiAgICogYW5kIGhhcyB0aGUgYHRvZ2dsZS1jYWxtYCBDU1MgY2xhc3MgYXNzaWduZWQgdG8gdGhlIGlubmVyIGVsZW1lbnQuCiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi10b2dnbGUgbmctbW9kZWw9ImFpcnBsYW5lTW9kZSIgdG9nZ2xlLWNsYXNzPSJ0b2dnbGUtY2FsbSI+QWlycGxhbmUgTW9kZTwvaW9uLXRvZ2dsZT4KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uVG9nZ2xlJywgWwogICAgICAnJGlvbmljR2VzdHVyZScsCiAgICAgICckdGltZW91dCcsCiAgICAgIGZ1bmN0aW9uKCRpb25pY0dlc3R1cmUsICR0aW1lb3V0KSB7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsCiAgICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgICAgdGVtcGxhdGU6CiAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJpdGVtIGl0ZW0tdG9nZ2xlIj4nICsKICAgICAgICAgICAgJzxkaXYgbmctdHJhbnNjbHVkZT48L2Rpdj4nICsKICAgICAgICAgICAgJzxsYWJlbCBjbGFzcz0idG9nZ2xlIj4nICsKICAgICAgICAgICAgJzxpbnB1dCB0eXBlPSJjaGVja2JveCI+JyArCiAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJ0cmFjayI+JyArCiAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJoYW5kbGUiPjwvZGl2PicgKwogICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICc8L2xhYmVsPicgKwogICAgICAgICAgICAnPC9kaXY+JywKCiAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQuZmluZCgnaW5wdXQnKTsKICAgICAgICAgICAgZm9yRWFjaCh7CiAgICAgICAgICAgICAgJ25hbWUnOiBhdHRyLm5hbWUsCiAgICAgICAgICAgICAgJ25nLXZhbHVlJzogYXR0ci5uZ1ZhbHVlLAogICAgICAgICAgICAgICduZy1tb2RlbCc6IGF0dHIubmdNb2RlbCwKICAgICAgICAgICAgICAnbmctY2hlY2tlZCc6IGF0dHIubmdDaGVja2VkLAogICAgICAgICAgICAgICduZy1kaXNhYmxlZCc6IGF0dHIubmdEaXNhYmxlZCwKICAgICAgICAgICAgICAnbmctdHJ1ZS12YWx1ZSc6IGF0dHIubmdUcnVlVmFsdWUsCiAgICAgICAgICAgICAgJ25nLWZhbHNlLXZhbHVlJzogYXR0ci5uZ0ZhbHNlVmFsdWUsCiAgICAgICAgICAgICAgJ25nLWNoYW5nZSc6IGF0dHIubmdDaGFuZ2UKICAgICAgICAgICAgfSwgZnVuY3Rpb24odmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgICAgICAgaW5wdXQuYXR0cihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmKGF0dHIudG9nZ2xlQ2xhc3MpIHsKICAgICAgICAgICAgICBlbGVtZW50WzBdLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdsYWJlbCcpWzBdLmNsYXNzTGlzdC5hZGQoYXR0ci50b2dnbGVDbGFzcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cikgewogICAgICAgICAgICAgIHZhciBlbCwgY2hlY2tib3gsIHRyYWNrLCBoYW5kbGU7CgogICAgICAgICAgICAgIGVsID0gJGVsZW1lbnRbMF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2xhYmVsJylbMF07CiAgICAgICAgICAgICAgY2hlY2tib3ggPSBlbC5jaGlsZHJlblswXTsKICAgICAgICAgICAgICB0cmFjayA9IGVsLmNoaWxkcmVuWzFdOwogICAgICAgICAgICAgIGhhbmRsZSA9IHRyYWNrLmNoaWxkcmVuWzBdOwoKICAgICAgICAgICAgICB2YXIgbmdNb2RlbENvbnRyb2xsZXIgPSBqcUxpdGUoY2hlY2tib3gpLmNvbnRyb2xsZXIoJ25nTW9kZWwnKTsKCiAgICAgICAgICAgICAgJHNjb3BlLnRvZ2dsZSA9IG5ldyBpb25pYy52aWV3cy5Ub2dnbGUoewogICAgICAgICAgICAgICAgZWw6IGVsLAogICAgICAgICAgICAgICAgdHJhY2s6IHRyYWNrLAogICAgICAgICAgICAgICAgY2hlY2tib3g6IGNoZWNrYm94LAogICAgICAgICAgICAgICAgaGFuZGxlOiBoYW5kbGUsCiAgICAgICAgICAgICAgICBvbkNoYW5nZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlmKGNoZWNrYm94LmNoZWNrZWQpIHsKICAgICAgICAgICAgICAgICAgICBuZ01vZGVsQ29udHJvbGxlci4kc2V0Vmlld1ZhbHVlKHRydWUpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDb250cm9sbGVyLiRzZXRWaWV3VmFsdWUoZmFsc2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICRzY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS50b2dnbGUuZGVzdHJveSgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgICAgfQoKICAgICAgICB9OwogICAgICB9XSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25WaWV3CiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBFCiAgICogQHBhcmVudCBpb25OYXZWaWV3CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBIGNvbnRhaW5lciBmb3IgY29udGVudCwgdXNlZCB0byB0ZWxsIGEgcGFyZW50IHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfQogICAqIGFib3V0IHRoZSBjdXJyZW50IHZpZXcuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBCZWxvdyBpcyBhbiBleGFtcGxlIHdoZXJlIG91ciBwYWdlIHdpbGwgbG9hZCB3aXRoIGEgbmF2YmFyIGNvbnRhaW5pbmcgIk15IFBhZ2UiIGFzIHRoZSB0aXRsZS4KICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLW5hdi1iYXI+PC9pb24tbmF2LWJhcj4KICAgKiA8aW9uLW5hdi12aWV3IGNsYXNzPSJzbGlkZS1sZWZ0LXJpZ2h0Ij4KICAgKiAgIDxpb24tdmlldyB0aXRsZT0iTXkgUGFnZSI+CiAgICogICAgIDxpb24tY29udGVudD4KICAgKiAgICAgICBIZWxsbyEKICAgKiAgICAgPC9pb24tY29udGVudD4KICAgKiAgIDwvaW9uLXZpZXc+CiAgICogPC9pb24tbmF2LXZpZXc+CiAgICogYGBgCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IHRpdGxlIFRoZSB0aXRsZSB0byBkaXNwbGF5IG9uIHRoZSBwYXJlbnQge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9LgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IGhpZGUtYmFjay1idXR0b24gV2hldGhlciB0byBoaWRlIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgcGFyZW50CiAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9IGJ5IGRlZmF1bHQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gaGlkZS1uYXYtYmFyIFdoZXRoZXIgdG8gaGlkZSB0aGUgcGFyZW50CiAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9IGJ5IGRlZmF1bHQuCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvblZpZXcnLCBbJyRpb25pY1ZpZXdTZXJ2aWNlJywgJyRyb290U2NvcGUnLCAnJGFuaW1hdGUnLAogICAgICBmdW5jdGlvbiggJGlvbmljVmlld1NlcnZpY2UsICAgJHJvb3RTY29wZSwgICAkYW5pbWF0ZSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICByZXN0cmljdDogJ0VBJywKICAgICAgICAgIHByaW9yaXR5OiAxMDAwLAogICAgICAgICAgcmVxdWlyZTogWydeP2lvbk5hdkJhcicsICdeP2lvbk1vZGFsJ10sCiAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzLCB0cmFuc2NsdWRlKSB7CiAgICAgICAgICAgIHRFbGVtZW50LmFkZENsYXNzKCdwYW5lJyk7CiAgICAgICAgICAgIHRFbGVtZW50WzBdLnJlbW92ZUF0dHJpYnV0ZSgndGl0bGUnKTsKCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJscykgewogICAgICAgICAgICAgIHZhciBuYXZCYXJDdHJsID0gY3RybHNbMF07CiAgICAgICAgICAgICAgdmFyIG1vZGFsQ3RybCA9IGN0cmxzWzFdOwoKICAgICAgICAgICAgICAvL0Rvbid0IHVzZSB0aGUgaW9uVmlldyBpZiB3ZSdyZSBpbnNpZGUgYSBtb2RhbCBvciB0aGVyZSdzIG5vIG5hdmJhcgogICAgICAgICAgICAgIGlmICghbmF2QmFyQ3RybCB8fCBtb2RhbEN0cmwpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChhbmd1bGFyLmlzRGVmaW5lZCgkYXR0ci50aXRsZSkpIHsKCiAgICAgICAgICAgICAgICB2YXIgaW5pdGlhbFRpdGxlID0gJGF0dHIudGl0bGU7CiAgICAgICAgICAgICAgICBuYXZCYXJDdHJsLmNoYW5nZVRpdGxlKGluaXRpYWxUaXRsZSwgJHNjb3BlLiRuYXZEaXJlY3Rpb24pOwoKICAgICAgICAgICAgICAgIC8vIHdhdGNoIGZvciBjaGFuZ2VzIGluIHRoZSB0aXRsZSwgZG9uJ3Qgc2V0IGluaXRpYWwgdmFsdWUgYXMgY2hhbmdlVGl0bGUgZG9lcyB0aGF0CiAgICAgICAgICAgICAgICAkYXR0ci4kb2JzZXJ2ZSgndGl0bGUnLCBmdW5jdGlvbih2YWwsIG9sZFZhbCkgewogICAgICAgICAgICAgICAgICBuYXZCYXJDdHJsLnNldFRpdGxlKHZhbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHZhciBoaWRlQmFja0F0dHIgPSBhbmd1bGFyLmlzRGVmaW5lZCgkYXR0ci5oaWRlQmFja0J1dHRvbikgPwogICAgICAgICAgICAgICAgJGF0dHIuaGlkZUJhY2tCdXR0b24gOgogICAgICAgICAgICAgICAgJ2ZhbHNlJzsKICAgICAgICAgICAgICAkc2NvcGUuJHdhdGNoKGhpZGVCYWNrQXR0ciwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIC8vIFNob3VsZCB3ZSBoaWRlIGEgYmFjayBidXR0b24gd2hlbiB0aGlzIHRhYiBpcyBzaG93bgogICAgICAgICAgICAgICAgbmF2QmFyQ3RybC5zaG93QmFja0J1dHRvbighdmFsdWUpOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICB2YXIgaGlkZU5hdkF0dHIgPSBhbmd1bGFyLmlzRGVmaW5lZCgkYXR0ci5oaWRlTmF2QmFyKSA/CiAgICAgICAgICAgICAgICAkYXR0ci5oaWRlTmF2QmFyIDoKICAgICAgICAgICAgICAgICdmYWxzZSc7CiAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChoaWRlTmF2QXR0ciwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIC8vIFNob3VsZCB0aGUgbmF2IGJhciBiZSBoaWRkZW4gZm9yIHRoaXMgdmlldyBvciBub3Q/CiAgICAgICAgICAgICAgICBuYXZCYXJDdHJsLnNob3dCYXIoIXZhbHVlKTsKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfV0pOwoKfSkoKTs=",
                "body": "LyohCiAqIGlvbmljLmJ1bmRsZS5qcyBpcyBhIGNvbmNhdGVuYXRpb24gb2Y6CiAqIGlvbmljLmpzLCBhbmd1bGFyLmpzLCBhbmd1bGFyLWFuaW1hdGUuanMsCiAqIGFuZ3VsYXItc2FuaXRpemUuanMsIGFuZ3VsYXItdWktcm91dGVyLmpzLAogKiBhbmQgaW9uaWMtYW5ndWxhci5qcwogKi8KCi8qIQogKiBDb3B5cmlnaHQgMjAxNCBEcmlmdHkgQ28uCiAqIGh0dHA6Ly9kcmlmdHkuY29tLwogKgogKiBJb25pYywgdjEuMC4wLWJldGEuMTEKICogQSBwb3dlcmZ1bCBIVE1MNSBtb2JpbGUgYXBwIGZyYW1ld29yay4KICogaHR0cDovL2lvbmljZnJhbWV3b3JrLmNvbS8KICoKICogQnkgQG1heGx5bmNoLCBAYmVuanNwZXJyeSwgQGFkYW1kYnJhZGxleSA8MwogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuIFBsZWFzZSBzZWUgTElDRU5TRSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICoKICovCgooZnVuY3Rpb24oKSB7CgovLyBDcmVhdGUgbmFtZXNwYWNlcwovLwogIHdpbmRvdy5pb25pYyA9IHsKICAgIGNvbnRyb2xsZXJzOiB7fSwKICAgIHZpZXdzOiB7fSwKICAgIHZlcnNpb246ICcxLjAuMC1iZXRhLjExJwogIH07CgogIChmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCBpb25pYykgewoKICAgIHZhciByZWFkeUNhbGxiYWNrcyA9IFtdOwogICAgdmFyIGlzRG9tUmVhZHkgPSBmYWxzZTsKCiAgICBmdW5jdGlvbiBkb21SZWFkeSgpIHsKICAgICAgaXNEb21SZWFkeSA9IHRydWU7CiAgICAgIGZvcih2YXIgeD0wOyB4PHJlYWR5Q2FsbGJhY2tzLmxlbmd0aDsgeCsrKSB7CiAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHJlYWR5Q2FsbGJhY2tzW3hdKTsKICAgICAgfQogICAgICByZWFkeUNhbGxiYWNrcyA9IFtdOwogICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZG9tUmVhZHkpOwogICAgfQogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbVJlYWR5KTsKCiAgICAvLyBGcm9tIHRoZSBtYW4gaGltc2VsZiwgTXIuIFBhdWwgSXJpc2guCiAgICAvLyBUaGUgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIHBvbHlmaWxsCiAgICAvLyBQdXQgaXQgb24gd2luZG93IGp1c3QgdG8gcHJlc2VydmUgaXRzIGNvbnRleHQKICAgIC8vIHdpdGhvdXQgaGF2aW5nIHRvIHVzZSAuY2FsbAogICAgd2luZG93Ll9yQUYgPSAoZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lICAgICAgIHx8CiAgICAgICAgd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgICAgfHwKICAgICAgICBmdW5jdGlvbiggY2FsbGJhY2sgKXsKICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGNhbGxiYWNrLCAxNik7CiAgICAgICAgfTsKICAgIH0pKCk7CgogICAgdmFyIGNhbmNlbEFuaW1hdGlvbkZyYW1lID0gd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgIHdpbmRvdy53ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICB3aW5kb3cubW96Q2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgd2luZG93LndlYmtpdENhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyB1dGlsaXR5CiAgICAgKiBAbmFtZSBpb25pYy5Eb21VdGlsCiAgICAgKiBAbW9kdWxlIGlvbmljCiAgICAgKi8KICAgIGlvbmljLkRvbVV0aWwgPSB7CiAgICAgIC8vQ2FsbCB3aXRoIHByb3BlciBjb250ZXh0CiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjcmVxdWVzdEFuaW1hdGlvbkZyYW1lCiAgICAgICAqIEBhbGlhcyBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUKICAgICAgICogQGRlc2NyaXB0aW9uIENhbGxzIFtyZXF1ZXN0QW5pbWF0aW9uRnJhbWVdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS93aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSwgb3IgYSBwb2x5ZmlsbCBpZiBub3QgYXZhaWxhYmxlLgogICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBuZXh0IGZyYW1lCiAgICAgICAqIGhhcHBlbnMuCiAgICAgICAqLwogICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWU6IGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgcmV0dXJuIHdpbmRvdy5fckFGKGNiKTsKICAgICAgfSwKCiAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lOiBmdW5jdGlvbihyZXF1ZXN0SWQpIHsKICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShyZXF1ZXN0SWQpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuRG9tVXRpbCNhbmltYXRpb25GcmFtZVRocm90dGxlCiAgICAgICAqIEBhbGlhcyBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBXaGVuIGdpdmVuIGEgY2FsbGJhY2ssIGlmIHRoYXQgY2FsbGJhY2sgaXMgY2FsbGVkIDEwMCB0aW1lcyBiZXR3ZWVuCiAgICAgICAqIGFuaW1hdGlvbiBmcmFtZXMsIGFkZGluZyBUaHJvdHRsZSB3aWxsIG1ha2UgaXQgb25seSBydW4gdGhlIGxhc3Qgb2YKICAgICAgICogdGhlIDEwMCBjYWxscy4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgYSBmdW5jdGlvbiB3aGljaCB3aWxsIGJlIHRocm90dGxlZCB0bwogICAgICAgKiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUKICAgICAgICogQHJldHVybnMge2Z1bmN0aW9ufSBBIGZ1bmN0aW9uIHdoaWNoIHdpbGwgdGhlbiBjYWxsIHRoZSBwYXNzZWQgaW4gY2FsbGJhY2suCiAgICAgICAqIFRoZSBwYXNzZWQgaW4gY2FsbGJhY2sgd2lsbCByZWNlaXZlIHRoZSBjb250ZXh0IHRoZSByZXR1cm5lZCBmdW5jdGlvbiBpcwogICAgICAgKiBjYWxsZWQgd2l0aC4KICAgICAgICovCiAgICAgIGFuaW1hdGlvbkZyYW1lVGhyb3R0bGU6IGZ1bmN0aW9uKGNiKSB7CiAgICAgICAgdmFyIGFyZ3MsIGlzUXVldWVkLCBjb250ZXh0OwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgICAgIGlmICghaXNRdWV1ZWQpIHsKICAgICAgICAgICAgaXNRdWV1ZWQgPSB0cnVlOwogICAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY2IuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgICAgaXNRdWV1ZWQgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjZ2V0UG9zaXRpb25JblBhcmVudAogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogRmluZCBhbiBlbGVtZW50J3Mgc2Nyb2xsIG9mZnNldCB3aXRoaW4gaXRzIGNvbnRhaW5lci4KICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIGZpbmQgdGhlIG9mZnNldCBvZi4KICAgICAgICogQHJldHVybnMge29iamVjdH0gQSBwb3NpdGlvbiBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgICAqICAgLSBge251bWJlcn1gIGBsZWZ0YCBUaGUgbGVmdCBvZmZzZXQgb2YgdGhlIGVsZW1lbnQuCiAgICAgICAqICAgLSBge251bWJlcn1gIGB0b3BgIFRoZSB0b3Agb2Zmc2V0IG9mIHRoZSBlbGVtZW50LgogICAgICAgKi8KICAgICAgZ2V0UG9zaXRpb25JblBhcmVudDogZnVuY3Rpb24oZWwpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgbGVmdDogZWwub2Zmc2V0TGVmdCwKICAgICAgICAgIHRvcDogZWwub2Zmc2V0VG9wCiAgICAgICAgfTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjcmVhZHkKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIENhbGwgYSBmdW5jdGlvbiB3aGVuIHRoZSBET00gaXMgcmVhZHksIG9yIGlmIGl0IGlzIGFscmVhZHkgcmVhZHkKICAgICAgICogY2FsbCB0aGUgZnVuY3Rpb24gaW1tZWRpYXRlbHkuCiAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBiZSBjYWxsZWQuCiAgICAgICAqLwogICAgICByZWFkeTogZnVuY3Rpb24oY2IpIHsKICAgICAgICBpZihpc0RvbVJlYWR5IHx8IGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIpIHsKICAgICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShjYik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlYWR5Q2FsbGJhY2tzLnB1c2goY2IpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjZ2V0VGV4dEJvdW5kcwogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogR2V0IGEgcmVjdCByZXByZXNlbnRpbmcgdGhlIGJvdW5kcyBvZiB0aGUgZ2l2ZW4gdGV4dE5vZGUuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gdGV4dE5vZGUgVGhlIHRleHROb2RlIHRvIGZpbmQgdGhlIGJvdW5kcyBvZi4KICAgICAgICogQHJldHVybnMge29iamVjdH0gQW4gb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYm91bmRzIG9mIHRoZSBub2RlLiBQcm9wZXJ0aWVzOgogICAgICAgKiAgIC0gYHtudW1iZXJ9YCBgbGVmdGAgVGhlIGxlZnQgcG9zaXR0b24gb2YgdGhlIHRleHROb2RlLgogICAgICAgKiAgIC0gYHtudW1iZXJ9YCBgcmlnaHRgIFRoZSByaWdodCBwb3NpdHRvbiBvZiB0aGUgdGV4dE5vZGUuCiAgICAgICAqICAgLSBge251bWJlcn1gIGB0b3BgIFRoZSB0b3AgcG9zaXR0b24gb2YgdGhlIHRleHROb2RlLgogICAgICAgKiAgIC0gYHtudW1iZXJ9YCBgYm90dG9tYCBUaGUgYm90dG9tIHBvc2l0aW9uIG9mIHRoZSB0ZXh0Tm9kZS4KICAgICAgICogICAtIGB7bnVtYmVyfWAgYHdpZHRoYCBUaGUgd2lkdGggb2YgdGhlIHRleHROb2RlLgogICAgICAgKiAgIC0gYHtudW1iZXJ9YCBgaGVpZ2h0YCBUaGUgaGVpZ2h0IG9mIHRoZSB0ZXh0Tm9kZS4KICAgICAgICovCiAgICAgIGdldFRleHRCb3VuZHM6IGZ1bmN0aW9uKHRleHROb2RlKSB7CiAgICAgICAgaWYoZG9jdW1lbnQuY3JlYXRlUmFuZ2UpIHsKICAgICAgICAgIHZhciByYW5nZSA9IGRvY3VtZW50LmNyZWF0ZVJhbmdlKCk7CiAgICAgICAgICByYW5nZS5zZWxlY3ROb2RlQ29udGVudHModGV4dE5vZGUpOwogICAgICAgICAgaWYocmFuZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KSB7CiAgICAgICAgICAgIHZhciByZWN0ID0gcmFuZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgICAgIGlmKHJlY3QpIHsKICAgICAgICAgICAgICB2YXIgc3ggPSB3aW5kb3cuc2Nyb2xsWDsKICAgICAgICAgICAgICB2YXIgc3kgPSB3aW5kb3cuc2Nyb2xsWTsKCiAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHRvcDogcmVjdC50b3AgKyBzeSwKICAgICAgICAgICAgICAgIGxlZnQ6IHJlY3QubGVmdCArIHN4LAogICAgICAgICAgICAgICAgcmlnaHQ6IHJlY3QubGVmdCArIHN4ICsgcmVjdC53aWR0aCwKICAgICAgICAgICAgICAgIGJvdHRvbTogcmVjdC50b3AgKyBzeSArIHJlY3QuaGVpZ2h0LAogICAgICAgICAgICAgICAgd2lkdGg6IHJlY3Qud2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IHJlY3QuaGVpZ2h0CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjZ2V0Q2hpbGRJbmRleAogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogR2V0IHRoZSBmaXJzdCBpbmRleCBvZiBhIGNoaWxkIG5vZGUgd2l0aGluIHRoZSBnaXZlbiBlbGVtZW50IG9mIHRoZQogICAgICAgKiBzcGVjaWZpZWQgdHlwZS4KICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIGZpbmQgdGhlIGluZGV4IG9mLgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUgbm9kZU5hbWUgdG8gbWF0Y2ggY2hpbGRyZW4gb2YgZWxlbWVudCBhZ2FpbnN0LgogICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgaW5kZXgsIG9yIC0xLCBvZiBhIGNoaWxkIHdpdGggbm9kZU5hbWUgbWF0Y2hpbmcgdHlwZS4KICAgICAgICovCiAgICAgIGdldENoaWxkSW5kZXg6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUpIHsKICAgICAgICBpZih0eXBlKSB7CiAgICAgICAgICB2YXIgY2ggPSBlbGVtZW50LnBhcmVudE5vZGUuY2hpbGRyZW47CiAgICAgICAgICB2YXIgYzsKICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGsgPSAwLCBqID0gY2gubGVuZ3RoOyBpIDwgajsgaSsrKSB7CiAgICAgICAgICAgIGMgPSBjaFtpXTsKICAgICAgICAgICAgaWYoYy5ub2RlTmFtZSAmJiBjLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gdHlwZSkgewogICAgICAgICAgICAgIGlmKGMgPT0gZWxlbWVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGsrKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZWxlbWVudC5wYXJlbnROb2RlLmNoaWxkcmVuKS5pbmRleE9mKGVsZW1lbnQpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBwcml2YXRlCiAgICAgICAqLwogICAgICBzd2FwTm9kZXM6IGZ1bmN0aW9uKHNyYywgZGVzdCkgewogICAgICAgIGRlc3QucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoc3JjLCBkZXN0KTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAcHJpdmF0ZQogICAgICAgKi8KICAgICAgY2VudGVyRWxlbWVudEJ5TWFyZ2luOiBmdW5jdGlvbihlbCkgewogICAgICAgIGVsLnN0eWxlLm1hcmdpbkxlZnQgPSAoLWVsLm9mZnNldFdpZHRoKSAvIDIgKyAncHgnOwogICAgICAgIGVsLnN0eWxlLm1hcmdpblRvcCA9ICgtZWwub2Zmc2V0SGVpZ2h0KSAvIDIgKyAncHgnOwogICAgICB9LAogICAgICAvL0NlbnRlciB0d2ljZSwgYWZ0ZXIgcmFmLCB0byBmaXggYSBidWcgd2l0aCBpb3MgYW5kIHNob3dpbmcgZWxlbWVudHMKICAgICAgLy90aGF0IGhhdmUganVzdCBiZWVuIGF0dGFjaGVkIHRvIHRoZSBET00uCiAgICAgIGNlbnRlckVsZW1lbnRCeU1hcmdpblR3aWNlOiBmdW5jdGlvbihlbCkgewogICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgIGlvbmljLkRvbVV0aWwuY2VudGVyRWxlbWVudEJ5TWFyZ2luKGVsKTsKICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlvbmljLkRvbVV0aWwuY2VudGVyRWxlbWVudEJ5TWFyZ2luKGVsKTsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpb25pYy5Eb21VdGlsLmNlbnRlckVsZW1lbnRCeU1hcmdpbihlbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0sCgogICAgICBlbGVtZW50SXNEZXNjZW5kYW50OiBmdW5jdGlvbihlbCwgcGFyZW50LCBzdG9wQXQpIHsKICAgICAgICB2YXIgY3VycmVudCA9IGVsOwogICAgICAgIGRvIHsKICAgICAgICAgIGlmIChjdXJyZW50ID09PSBwYXJlbnQpIHJldHVybiB0cnVlOwogICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucGFyZW50Tm9kZTsKICAgICAgICB9IHdoaWxlIChjdXJyZW50ICYmIGN1cnJlbnQgIT09IHN0b3BBdCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuRG9tVXRpbCNnZXRQYXJlbnRXaXRoQ2xhc3MKICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50CiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc05hbWUKICAgICAgICogQHJldHVybnMge0RPTUVsZW1lbnR9IFRoZSBjbG9zZXN0IHBhcmVudCBvZiBlbGVtZW50IG1hdGNoaW5nIHRoZQogICAgICAgKiBjbGFzc05hbWUsIG9yIG51bGwuCiAgICAgICAqLwogICAgICBnZXRQYXJlbnRXaXRoQ2xhc3M6IGZ1bmN0aW9uKGUsIGNsYXNzTmFtZSwgZGVwdGgpIHsKICAgICAgICBkZXB0aCA9IGRlcHRoIHx8IDEwOwogICAgICAgIHdoaWxlKGUucGFyZW50Tm9kZSAmJiBkZXB0aC0tKSB7CiAgICAgICAgICBpZihlLnBhcmVudE5vZGUuY2xhc3NMaXN0ICYmIGUucGFyZW50Tm9kZS5jbGFzc0xpc3QuY29udGFpbnMoY2xhc3NOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gZS5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgICAgZSA9IGUucGFyZW50Tm9kZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjZ2V0UGFyZW50T3JTZWxmV2l0aENsYXNzCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudAogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lCiAgICAgICAqIEByZXR1cm5zIHtET01FbGVtZW50fSBUaGUgY2xvc2VzdCBwYXJlbnQgb3Igc2VsZiBtYXRjaGluZyB0aGUKICAgICAgICogY2xhc3NOYW1lLCBvciBudWxsLgogICAgICAgKi8KICAgICAgZ2V0UGFyZW50T3JTZWxmV2l0aENsYXNzOiBmdW5jdGlvbihlLCBjbGFzc05hbWUsIGRlcHRoKSB7CiAgICAgICAgZGVwdGggPSBkZXB0aCB8fCAxMDsKICAgICAgICB3aGlsZShlICYmIGRlcHRoLS0pIHsKICAgICAgICAgIGlmKGUuY2xhc3NMaXN0ICYmIGUuY2xhc3NMaXN0LmNvbnRhaW5zKGNsYXNzTmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGU7CiAgICAgICAgICB9CiAgICAgICAgICBlID0gZS5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLkRvbVV0aWwjcmVjdENvbnRhaW5zCiAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSB4CiAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSB5CiAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MQogICAgICAgKiBAcGFyYW0ge251bWJlcn0geTEKICAgICAgICogQHBhcmFtIHtudW1iZXJ9IHgyCiAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MgogICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB7eCx5fSBmaXRzIHdpdGhpbiB0aGUgcmVjdGFuZ2xlIGRlZmluZWQgYnkKICAgICAgICoge3gxLHkxLHgyLHkyfS4KICAgICAgICovCiAgICAgIHJlY3RDb250YWluczogZnVuY3Rpb24oeCwgeSwgeDEsIHkxLCB4MiwgeTIpIHsKICAgICAgICBpZih4IDwgeDEgfHwgeCA+IHgyKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYoeSA8IHkxIHx8IHkgPiB5MikgcmV0dXJuIGZhbHNlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9OwoKICAgIC8vU2hvcnRjdXRzCiAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSBpb25pYy5Eb21VdGlsLnJlcXVlc3RBbmltYXRpb25GcmFtZTsKICAgIGlvbmljLmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gaW9uaWMuRG9tVXRpbC5jYW5jZWxBbmltYXRpb25GcmFtZTsKICAgIGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUgPSBpb25pYy5Eb21VdGlsLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGU7CiAgfSkod2luZG93LCBkb2N1bWVudCwgaW9uaWMpOwoKICAvKioKICAgKiBpb24tZXZlbnRzLmpzCiAgICoKICAgKiBBdXRob3I6IE1heCBMeW5jaCA8bWF4QGRyaWZ0eS5jb20+CiAgICoKICAgKiBGcmFtZXdvcmsgZXZlbnRzIGhhbmRsZXMgdmFyaW91cyBtb2JpbGUgYnJvd3NlciBldmVudHMsIGFuZAogICAqIGRldGVjdHMgc3BlY2lhbCBldmVudHMgbGlrZSB0YXAvc3dpcGUvZXRjLiBhbmQgZW1pdHMgdGhlbQogICAqIGFzIGN1c3RvbSBldmVudHMgdGhhdCBjYW4gYmUgdXNlZCBpbiBhbiBhcHAuCiAgICoKICAgKiBQb3J0aW9ucyBsb3ZpbmdseSBhZGFwdGVkIGZyb20gZ2l0aHViLmNvbS9tYWtlci9yYXRjaGV0IGFuZCBnaXRodWIuY29tL2FsZXhnaWJzb24vdGFwLmpzIC0gdGhhbmtzIGd1eXMhCiAgICovCgogIChmdW5jdGlvbihpb25pYykgewoKICAgIC8vIEN1c3RvbSBldmVudCBwb2x5ZmlsbAogICAgaW9uaWMuQ3VzdG9tRXZlbnQgPSAoZnVuY3Rpb24oKSB7CiAgICAgIGlmKCB0eXBlb2Ygd2luZG93LkN1c3RvbUV2ZW50ID09PSAnZnVuY3Rpb24nICkgcmV0dXJuIEN1c3RvbUV2ZW50OwoKICAgICAgdmFyIGN1c3RvbUV2ZW50ID0gZnVuY3Rpb24oZXZlbnQsIHBhcmFtcykgewogICAgICAgIHZhciBldnQ7CiAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHsKICAgICAgICAgIGJ1YmJsZXM6IGZhbHNlLAogICAgICAgICAgY2FuY2VsYWJsZTogZmFsc2UsCiAgICAgICAgICBkZXRhaWw6IHVuZGVmaW5lZAogICAgICAgIH07CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGV2dCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJDdXN0b21FdmVudCIpOwogICAgICAgICAgZXZ0LmluaXRDdXN0b21FdmVudChldmVudCwgcGFyYW1zLmJ1YmJsZXMsIHBhcmFtcy5jYW5jZWxhYmxlLCBwYXJhbXMuZGV0YWlsKTsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgLy8gZmFsbGJhY2sgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3Qgc3VwcG9ydCBjcmVhdGVFdmVudCgnQ3VzdG9tRXZlbnQnKQogICAgICAgICAgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIkV2ZW50Iik7CiAgICAgICAgICBmb3IgKHZhciBwYXJhbSBpbiBwYXJhbXMpIHsKICAgICAgICAgICAgZXZ0W3BhcmFtXSA9IHBhcmFtc1twYXJhbV07CiAgICAgICAgICB9CiAgICAgICAgICBldnQuaW5pdEV2ZW50KGV2ZW50LCBwYXJhbXMuYnViYmxlcywgcGFyYW1zLmNhbmNlbGFibGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZXZ0OwogICAgICB9OwogICAgICBjdXN0b21FdmVudC5wcm90b3R5cGUgPSB3aW5kb3cuRXZlbnQucHJvdG90eXBlOwogICAgICByZXR1cm4gY3VzdG9tRXZlbnQ7CiAgICB9KSgpOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyB1dGlsaXR5CiAgICAgKiBAbmFtZSBpb25pYy5FdmVudENvbnRyb2xsZXIKICAgICAqIEBtb2R1bGUgaW9uaWMKICAgICAqLwogICAgaW9uaWMuRXZlbnRDb250cm9sbGVyID0gewogICAgICBWSVJUVUFMSVpFRF9FVkVOVFM6IFsndGFwJywgJ3N3aXBlJywgJ3N3aXBlcmlnaHQnLCAnc3dpcGVsZWZ0JywgJ2RyYWcnLCAnaG9sZCcsICdyZWxlYXNlJ10sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5FdmVudENvbnRyb2xsZXIjdHJpZ2dlcgogICAgICAgKiBAYWxpYXMgaW9uaWMudHJpZ2dlcgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnRUeXBlIFRoZSBldmVudCB0byB0cmlnZ2VyLgogICAgICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSBUaGUgZGF0YSBmb3IgdGhlIGV2ZW50LiBIaW50OiBwYXNzIGluCiAgICAgICAqIGB7dGFyZ2V0OiB0YXJnZXRFbGVtZW50fWAKICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gYnViYmxlcyBXaGV0aGVyIHRoZSBldmVudCBzaG91bGQgYnViYmxlIHVwIHRoZSBET00uCiAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IGNhbmNlbGFibGUgV2hldGhlciB0aGUgZXZlbnQgc2hvdWxkIGJlIGNhbmNlbGFibGUuCiAgICAgICAqLwogICAgICAvLyBUcmlnZ2VyIGEgbmV3IGV2ZW50CiAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uKGV2ZW50VHlwZSwgZGF0YSwgYnViYmxlcywgY2FuY2VsYWJsZSkgewogICAgICAgIHZhciBldmVudCA9IG5ldyBpb25pYy5DdXN0b21FdmVudChldmVudFR5cGUsIHsKICAgICAgICAgIGRldGFpbDogZGF0YSwKICAgICAgICAgIGJ1YmJsZXM6ICEhYnViYmxlcywKICAgICAgICAgIGNhbmNlbGFibGU6ICEhY2FuY2VsYWJsZQogICAgICAgIH0pOwoKICAgICAgICAvLyBNYWtlIHN1cmUgdG8gdHJpZ2dlciB0aGUgZXZlbnQgb24gdGhlIGdpdmVuIHRhcmdldCwgb3IgZGlzcGF0Y2ggaXQgZnJvbQogICAgICAgIC8vIHRoZSB3aW5kb3cgaWYgd2UgZG9uJ3QgaGF2ZSBhbiBldmVudCB0YXJnZXQKICAgICAgICBkYXRhICYmIGRhdGEudGFyZ2V0ICYmIGRhdGEudGFyZ2V0LmRpc3BhdGNoRXZlbnQgJiYgZGF0YS50YXJnZXQuZGlzcGF0Y2hFdmVudChldmVudCkgfHwgd2luZG93LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuRXZlbnRDb250cm9sbGVyI29uCiAgICAgICAqIEBhbGlhcyBpb25pYy5vbgogICAgICAgKiBAZGVzY3JpcHRpb24gTGlzdGVuIHRvIGFuIGV2ZW50IG9uIGFuIGVsZW1lbnQuCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSBldmVudCB0byBsaXN0ZW4gZm9yLgogICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgbGlzdGVuZXIgdG8gYmUgY2FsbGVkLgogICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgVGhlIGVsZW1lbnQgdG8gbGlzdGVuIGZvciB0aGUgZXZlbnQgb24uCiAgICAgICAqLwogICAgICBvbjogZnVuY3Rpb24odHlwZSwgY2FsbGJhY2ssIGVsZW1lbnQpIHsKICAgICAgICB2YXIgZSA9IGVsZW1lbnQgfHwgd2luZG93OwoKICAgICAgICAvLyBCaW5kIGEgZ2VzdHVyZSBpZiBpdCdzIGEgdmlydHVhbCBldmVudAogICAgICAgIGZvcih2YXIgaSA9IDAsIGogPSB0aGlzLlZJUlRVQUxJWkVEX0VWRU5UUy5sZW5ndGg7IGkgPCBqOyBpKyspIHsKICAgICAgICAgIGlmKHR5cGUgPT0gdGhpcy5WSVJUVUFMSVpFRF9FVkVOVFNbaV0pIHsKICAgICAgICAgICAgdmFyIGdlc3R1cmUgPSBuZXcgaW9uaWMuR2VzdHVyZShlbGVtZW50KTsKICAgICAgICAgICAgZ2VzdHVyZS5vbih0eXBlLCBjYWxsYmFjayk7CiAgICAgICAgICAgIHJldHVybiBnZXN0dXJlOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gT3RoZXJ3aXNlIGJpbmQgYSBub3JtYWwgZXZlbnQKICAgICAgICBlLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgY2FsbGJhY2spOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuRXZlbnRDb250cm9sbGVyI29mZgogICAgICAgKiBAYWxpYXMgaW9uaWMub2ZmCiAgICAgICAqIEBkZXNjcmlwdGlvbiBSZW1vdmUgYW4gZXZlbnQgbGlzdGVuZXIuCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlCiAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudAogICAgICAgKi8KICAgICAgb2ZmOiBmdW5jdGlvbih0eXBlLCBjYWxsYmFjaywgZWxlbWVudCkgewogICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBjYWxsYmFjayk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5FdmVudENvbnRyb2xsZXIjb25HZXN0dXJlCiAgICAgICAqIEBhbGlhcyBpb25pYy5vbkdlc3R1cmUKICAgICAgICogQGRlc2NyaXB0aW9uIEFkZCBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBnZXN0dXJlIG9uIGFuIGVsZW1lbnQuCiAgICAgICAqCiAgICAgICAqIEF2YWlsYWJsZSBldmVudFR5cGVzIChmcm9tIFtoYW1tZXIuanNdKGh0dHA6Ly9laWdodG1lZGlhLmdpdGh1Yi5pby9oYW1tZXIuanMvKSk6CiAgICAgICAqCiAgICAgICAqIGBob2xkYCwgYHRhcGAsIGBkb3VibGV0YXBgLCBgZHJhZ2AsIGBkcmFnc3RhcnRgLCBgZHJhZ2VuZGAsIGBkcmFndXBgLCBgZHJhZ2Rvd25gLCA8YnIvPgogICAgICAgKiBgZHJhZ2xlZnRgLCBgZHJhZ3JpZ2h0YCwgYHN3aXBlYCwgYHN3aXBldXBgLCBgc3dpcGVkb3duYCwgYHN3aXBlbGVmdGAsIGBzd2lwZXJpZ2h0YCwgPGJyLz4KICAgICAgICogYHRyYW5zZm9ybWAsIGB0cmFuc2Zvcm1zdGFydGAsIGB0cmFuc2Zvcm1lbmRgLCBgcm90YXRlYCwgYHBpbmNoYCwgYHBpbmNoaW5gLCBgcGluY2hvdXRgLCA8L2JyPgogICAgICAgKiBgdG91Y2hgLCBgcmVsZWFzZWAKICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50VHlwZSBUaGUgZ2VzdHVyZSBldmVudCB0byBsaXN0ZW4gZm9yLgogICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGUpfSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBnZXN0dXJlCiAgICAgICAqIGhhcHBlbnMuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCBUaGUgYW5ndWxhciBlbGVtZW50IHRvIGxpc3RlbiBmb3IgdGhlIGV2ZW50IG9uLgogICAgICAgKi8KICAgICAgb25HZXN0dXJlOiBmdW5jdGlvbih0eXBlLCBjYWxsYmFjaywgZWxlbWVudCkgewogICAgICAgIHZhciBnZXN0dXJlID0gbmV3IGlvbmljLkdlc3R1cmUoZWxlbWVudCk7CiAgICAgICAgZ2VzdHVyZS5vbih0eXBlLCBjYWxsYmFjayk7CiAgICAgICAgcmV0dXJuIGdlc3R1cmU7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5FdmVudENvbnRyb2xsZXIjb2ZmR2VzdHVyZQogICAgICAgKiBAYWxpYXMgaW9uaWMub2ZmR2VzdHVyZQogICAgICAgKiBAZGVzY3JpcHRpb24gUmVtb3ZlIGFuIGV2ZW50IGxpc3RlbmVyIGZvciBhIGdlc3R1cmUgb24gYW4gZWxlbWVudC4KICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50VHlwZSBUaGUgZ2VzdHVyZSBldmVudC4KICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihlKX0gY2FsbGJhY2sgVGhlIGxpc3RlbmVyIHRoYXQgd2FzIGFkZGVkIGVhcmxpZXIuCiAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCBUaGUgZWxlbWVudCB0aGUgbGlzdGVuZXIgd2FzIGFkZGVkIG9uLgogICAgICAgKi8KICAgICAgb2ZmR2VzdHVyZTogZnVuY3Rpb24oZ2VzdHVyZSwgdHlwZSwgY2FsbGJhY2spIHsKICAgICAgICBnZXN0dXJlLm9mZih0eXBlLCBjYWxsYmFjayk7CiAgICAgIH0sCgogICAgICBoYW5kbGVQb3BTdGF0ZTogZnVuY3Rpb24oZXZlbnQpIHt9CiAgICB9OwoKCiAgICAvLyBNYXAgc29tZSBjb252ZW5pZW50IHRvcC1sZXZlbCBmdW5jdGlvbnMgZm9yIGV2ZW50IGhhbmRsaW5nCiAgICBpb25pYy5vbiA9IGZ1bmN0aW9uKCkgeyBpb25pYy5FdmVudENvbnRyb2xsZXIub24uYXBwbHkoaW9uaWMuRXZlbnRDb250cm9sbGVyLCBhcmd1bWVudHMpOyB9OwogICAgaW9uaWMub2ZmID0gZnVuY3Rpb24oKSB7IGlvbmljLkV2ZW50Q29udHJvbGxlci5vZmYuYXBwbHkoaW9uaWMuRXZlbnRDb250cm9sbGVyLCBhcmd1bWVudHMpOyB9OwogICAgaW9uaWMudHJpZ2dlciA9IGlvbmljLkV2ZW50Q29udHJvbGxlci50cmlnZ2VyOy8vZnVuY3Rpb24oKSB7IGlvbmljLkV2ZW50Q29udHJvbGxlci50cmlnZ2VyLmFwcGx5KGlvbmljLkV2ZW50Q29udHJvbGxlci50cmlnZ2VyLCBhcmd1bWVudHMpOyB9OwogICAgaW9uaWMub25HZXN0dXJlID0gZnVuY3Rpb24oKSB7IHJldHVybiBpb25pYy5FdmVudENvbnRyb2xsZXIub25HZXN0dXJlLmFwcGx5KGlvbmljLkV2ZW50Q29udHJvbGxlci5vbkdlc3R1cmUsIGFyZ3VtZW50cyk7IH07CiAgICBpb25pYy5vZmZHZXN0dXJlID0gZnVuY3Rpb24oKSB7IHJldHVybiBpb25pYy5FdmVudENvbnRyb2xsZXIub2ZmR2VzdHVyZS5hcHBseShpb25pYy5FdmVudENvbnRyb2xsZXIub2ZmR2VzdHVyZSwgYXJndW1lbnRzKTsgfTsKCiAgfSkod2luZG93LmlvbmljKTsKCiAgLyoqCiAgICogU2ltcGxlIGdlc3R1cmUgY29udHJvbGxlcnMgd2l0aCBzb21lIGNvbW1vbiBnZXN0dXJlcyB0aGF0IGVtaXQKICAgKiBnZXN0dXJlIGV2ZW50cy4KICAgKgogICAqIFBvcnRlZCBmcm9tIGdpdGh1Yi5jb20vRWlnaHRNZWRpYS9oYW1tZXIuanMgR2VzdHVyZXMgLSB0aGFua3MhCiAgICovCiAgKGZ1bmN0aW9uKGlvbmljKSB7CgogICAgLyoqCiAgICAgKiBpb25pYy5HZXN0dXJlcwogICAgICogdXNlIHRoaXMgdG8gY3JlYXRlIGluc3RhbmNlcwogICAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgIGVsZW1lbnQKICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgICAgICBvcHRpb25zCiAgICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9CiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqLwogICAgaW9uaWMuR2VzdHVyZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIG5ldyBpb25pYy5HZXN0dXJlcy5JbnN0YW5jZShlbGVtZW50LCBvcHRpb25zIHx8IHt9KTsKICAgIH07CgogICAgaW9uaWMuR2VzdHVyZXMgPSB7fTsKCiAgICAvLyBkZWZhdWx0IHNldHRpbmdzCiAgICBpb25pYy5HZXN0dXJlcy5kZWZhdWx0cyA9IHsKICAgICAgLy8gYWRkIGNzcyB0byB0aGUgZWxlbWVudCB0byBwcmV2ZW50IHRoZSBicm93c2VyIGZyb20gZG9pbmcKICAgICAgLy8gaXRzIG5hdGl2ZSBiZWhhdmlvci4gdGhpcyBkb2VzbnQgcHJldmVudCB0aGUgc2Nyb2xsaW5nLAogICAgICAvLyBidXQgY2FuY2VscyB0aGUgY29udGV4dG1lbnUsIHRhcCBoaWdobGlnaHRpbmcgZXRjCiAgICAgIC8vIHNldCB0byBmYWxzZSB0byBkaXNhYmxlIHRoaXMKICAgICAgc3RvcF9icm93c2VyX2JlaGF2aW9yOiAnZGlzYWJsZS11c2VyLWJlaGF2aW9yJwogICAgfTsKCiAgICAvLyBkZXRlY3QgdG91Y2hldmVudHMKICAgIGlvbmljLkdlc3R1cmVzLkhBU19QT0lOVEVSRVZFTlRTID0gd2luZG93Lm5hdmlnYXRvci5wb2ludGVyRW5hYmxlZCB8fCB3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQ7CiAgICBpb25pYy5HZXN0dXJlcy5IQVNfVE9VQ0hFVkVOVFMgPSAoJ29udG91Y2hzdGFydCcgaW4gd2luZG93KTsKCiAgICAvLyBkb250IHVzZSBtb3VzZWV2ZW50cyBvbiBtb2JpbGUgZGV2aWNlcwogICAgaW9uaWMuR2VzdHVyZXMuTU9CSUxFX1JFR0VYID0gL21vYmlsZXx0YWJsZXR8aXAoYWR8aG9uZXxvZCl8YW5kcm9pZHxzaWxrL2k7CiAgICBpb25pYy5HZXN0dXJlcy5OT19NT1VTRUVWRU5UUyA9IGlvbmljLkdlc3R1cmVzLkhBU19UT1VDSEVWRU5UUyAmJiB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaChpb25pYy5HZXN0dXJlcy5NT0JJTEVfUkVHRVgpOwoKICAgIC8vIGV2ZW50dHlwZXMgcGVyIHRvdWNoZXZlbnQgKHN0YXJ0LCBtb3ZlLCBlbmQpCiAgICAvLyBhcmUgZmlsbGVkIGJ5IGlvbmljLkdlc3R1cmVzLmV2ZW50LmRldGVybWluZUV2ZW50VHlwZXMgb24gc2V0dXAKICAgIGlvbmljLkdlc3R1cmVzLkVWRU5UX1RZUEVTID0ge307CgogICAgLy8gZGlyZWN0aW9uIGRlZmluZXMKICAgIGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9ET1dOID0gJ2Rvd24nOwogICAgaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX0xFRlQgPSAnbGVmdCc7CiAgICBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fVVAgPSAndXAnOwogICAgaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1JJR0hUID0gJ3JpZ2h0JzsKCiAgICAvLyBwb2ludGVyIHR5cGUKICAgIGlvbmljLkdlc3R1cmVzLlBPSU5URVJfTU9VU0UgPSAnbW91c2UnOwogICAgaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9UT1VDSCA9ICd0b3VjaCc7CiAgICBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX1BFTiA9ICdwZW4nOwoKICAgIC8vIHRvdWNoIGV2ZW50IGRlZmluZXMKICAgIGlvbmljLkdlc3R1cmVzLkVWRU5UX1NUQVJUID0gJ3N0YXJ0JzsKICAgIGlvbmljLkdlc3R1cmVzLkVWRU5UX01PVkUgPSAnbW92ZSc7CiAgICBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQgPSAnZW5kJzsKCiAgICAvLyBoYW1tZXIgZG9jdW1lbnQgd2hlcmUgdGhlIGJhc2UgZXZlbnRzIGFyZSBhZGRlZCBhdAogICAgaW9uaWMuR2VzdHVyZXMuRE9DVU1FTlQgPSB3aW5kb3cuZG9jdW1lbnQ7CgogICAgLy8gcGx1Z2lucyBuYW1lc3BhY2UKICAgIGlvbmljLkdlc3R1cmVzLnBsdWdpbnMgPSB7fTsKCiAgICAvLyBpZiB0aGUgd2luZG93IGV2ZW50cyBhcmUgc2V0Li4uCiAgICBpb25pYy5HZXN0dXJlcy5SRUFEWSA9IGZhbHNlOwoKICAgIC8qKgogICAgICogc2V0dXAgZXZlbnRzIHRvIGRldGVjdCBnZXN0dXJlcyBvbiB0aGUgZG9jdW1lbnQKICAgICAqLwogICAgZnVuY3Rpb24gc2V0dXAoKSB7CiAgICAgIGlmKGlvbmljLkdlc3R1cmVzLlJFQURZKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBmaW5kIHdoYXQgZXZlbnR0eXBlcyB3ZSBhZGQgbGlzdGVuZXJzIHRvCiAgICAgIGlvbmljLkdlc3R1cmVzLmV2ZW50LmRldGVybWluZUV2ZW50VHlwZXMoKTsKCiAgICAgIC8vIFJlZ2lzdGVyIGFsbCBnZXN0dXJlcyBpbnNpZGUgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMKICAgICAgZm9yKHZhciBuYW1lIGluIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzKSB7CiAgICAgICAgaWYoaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5yZWdpc3Rlcihpb25pYy5HZXN0dXJlcy5nZXN0dXJlc1tuYW1lXSk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBBZGQgdG91Y2ggZXZlbnRzIG9uIHRoZSBkb2N1bWVudAogICAgICBpb25pYy5HZXN0dXJlcy5ldmVudC5vblRvdWNoKGlvbmljLkdlc3R1cmVzLkRPQ1VNRU5ULCBpb25pYy5HZXN0dXJlcy5FVkVOVF9NT1ZFLCBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uZGV0ZWN0KTsKICAgICAgaW9uaWMuR2VzdHVyZXMuZXZlbnQub25Ub3VjaChpb25pYy5HZXN0dXJlcy5ET0NVTUVOVCwgaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5ELCBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uZGV0ZWN0KTsKCiAgICAgIC8vIGlvbmljLkdlc3R1cmVzIGlzIHJlYWR5Li4uIQogICAgICBpb25pYy5HZXN0dXJlcy5SRUFEWSA9IHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBjcmVhdGUgbmV3IGhhbW1lciBpbnN0YW5jZQogICAgICogYWxsIG1ldGhvZHMgc2hvdWxkIHJldHVybiB0aGUgaW5zdGFuY2UgaXRzZWxmLCBzbyBpdCBpcyBjaGFpbmFibGUuCiAgICAgKiBAcGFyYW0gICB7SFRNTEVsZW1lbnR9ICAgICAgIGVsZW1lbnQKICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgICAgICAgICAgW29wdGlvbnM9e31dCiAgICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9CiAgICAgKiBAbmFtZSBHZXN0dXJlLkluc3RhbmNlCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqLwogICAgaW9uaWMuR2VzdHVyZXMuSW5zdGFuY2UgPSBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIC8vIEEgbnVsbCBlbGVtZW50IHdhcyBwYXNzZWQgaW50byB0aGUgaW5zdGFuY2UsIHdoaWNoIG1lYW5zCiAgICAgIC8vIHdoYXRldmVyIGxvb2t1cCB3YXMgZG9uZSB0byBmaW5kIHRoaXMgZWxlbWVudCBmYWlsZWQgdG8gZmluZCBpdAogICAgICAvLyBzbyB3ZSBjYW4ndCBsaXN0ZW4gZm9yIGV2ZW50cyBvbiBpdC4KICAgICAgaWYoZWxlbWVudCA9PT0gbnVsbCkgewogICAgICAgIHZvaWQgMDsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIHNldHVwIGlvbmljLkdlc3R1cmVzSlMgd2luZG93IGV2ZW50cyBhbmQgcmVnaXN0ZXIgYWxsIGdlc3R1cmVzCiAgICAgIC8vIHRoaXMgYWxzbyBzZXRzIHVwIHRoZSBkZWZhdWx0IG9wdGlvbnMKICAgICAgc2V0dXAoKTsKCiAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CgogICAgICAvLyBzdGFydC9zdG9wIGRldGVjdGlvbiBvcHRpb24KICAgICAgdGhpcy5lbmFibGVkID0gdHJ1ZTsKCiAgICAgIC8vIG1lcmdlIG9wdGlvbnMKICAgICAgdGhpcy5vcHRpb25zID0gaW9uaWMuR2VzdHVyZXMudXRpbHMuZXh0ZW5kKAogICAgICAgIGlvbmljLkdlc3R1cmVzLnV0aWxzLmV4dGVuZCh7fSwgaW9uaWMuR2VzdHVyZXMuZGVmYXVsdHMpLAogICAgICAgICAgb3B0aW9ucyB8fCB7fSk7CgogICAgICAvLyBhZGQgc29tZSBjc3MgdG8gdGhlIGVsZW1lbnQgdG8gcHJldmVudCB0aGUgYnJvd3NlciBmcm9tIGRvaW5nIGl0cyBuYXRpdmUgYmVoYXZvaXIKICAgICAgaWYodGhpcy5vcHRpb25zLnN0b3BfYnJvd3Nlcl9iZWhhdmlvcikgewogICAgICAgIGlvbmljLkdlc3R1cmVzLnV0aWxzLnN0b3BEZWZhdWx0QnJvd3NlckJlaGF2aW9yKHRoaXMuZWxlbWVudCwgdGhpcy5vcHRpb25zLnN0b3BfYnJvd3Nlcl9iZWhhdmlvcik7CiAgICAgIH0KCiAgICAgIC8vIHN0YXJ0IGRldGVjdGlvbiBvbiB0b3VjaHN0YXJ0CiAgICAgIGlvbmljLkdlc3R1cmVzLmV2ZW50Lm9uVG91Y2goZWxlbWVudCwgaW9uaWMuR2VzdHVyZXMuRVZFTlRfU1RBUlQsIGZ1bmN0aW9uKGV2KSB7CiAgICAgICAgaWYoc2VsZi5lbmFibGVkKSB7CiAgICAgICAgICBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uc3RhcnREZXRlY3Qoc2VsZiwgZXYpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICAvLyByZXR1cm4gaW5zdGFuY2UKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKCiAgICBpb25pYy5HZXN0dXJlcy5JbnN0YW5jZS5wcm90b3R5cGUgPSB7CiAgICAgIC8qKgogICAgICAgKiBiaW5kIGV2ZW50cyB0byB0aGUgaW5zdGFuY2UKICAgICAgICogQHBhcmFtICAge1N0cmluZ30gICAgICBnZXN0dXJlCiAgICAgICAqIEBwYXJhbSAgIHtGdW5jdGlvbn0gICAgaGFuZGxlcgogICAgICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9CiAgICAgICAqLwogICAgICBvbjogZnVuY3Rpb24gb25FdmVudChnZXN0dXJlLCBoYW5kbGVyKXsKICAgICAgICB2YXIgZ2VzdHVyZXMgPSBnZXN0dXJlLnNwbGl0KCcgJyk7CiAgICAgICAgZm9yKHZhciB0PTA7IHQ8Z2VzdHVyZXMubGVuZ3RoOyB0KyspIHsKICAgICAgICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGdlc3R1cmVzW3RdLCBoYW5kbGVyLCBmYWxzZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiB1bmJpbmQgZXZlbnRzIHRvIHRoZSBpbnN0YW5jZQogICAgICAgKiBAcGFyYW0gICB7U3RyaW5nfSAgICAgIGdlc3R1cmUKICAgICAgICogQHBhcmFtICAge0Z1bmN0aW9ufSAgICBoYW5kbGVyCiAgICAgICAqIEByZXR1cm5zIHtpb25pYy5HZXN0dXJlcy5JbnN0YW5jZX0KICAgICAgICovCiAgICAgIG9mZjogZnVuY3Rpb24gb2ZmRXZlbnQoZ2VzdHVyZSwgaGFuZGxlcil7CiAgICAgICAgdmFyIGdlc3R1cmVzID0gZ2VzdHVyZS5zcGxpdCgnICcpOwogICAgICAgIGZvcih2YXIgdD0wOyB0PGdlc3R1cmVzLmxlbmd0aDsgdCsrKSB7CiAgICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihnZXN0dXJlc1t0XSwgaGFuZGxlciwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogdHJpZ2dlciBnZXN0dXJlIGV2ZW50CiAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgZ2VzdHVyZQogICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgIGV2ZW50RGF0YQogICAgICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9CiAgICAgICAqLwogICAgICB0cmlnZ2VyOiBmdW5jdGlvbiB0cmlnZ2VyRXZlbnQoZ2VzdHVyZSwgZXZlbnREYXRhKXsKICAgICAgICAvLyBjcmVhdGUgRE9NIGV2ZW50CiAgICAgICAgdmFyIGV2ZW50ID0gaW9uaWMuR2VzdHVyZXMuRE9DVU1FTlQuY3JlYXRlRXZlbnQoJ0V2ZW50Jyk7CiAgICAgICAgZXZlbnQuaW5pdEV2ZW50KGdlc3R1cmUsIHRydWUsIHRydWUpOwogICAgICAgIGV2ZW50Lmdlc3R1cmUgPSBldmVudERhdGE7CgogICAgICAgIC8vIHRyaWdnZXIgb24gdGhlIHRhcmdldCBpZiBpdCBpcyBpbiB0aGUgaW5zdGFuY2UgZWxlbWVudCwKICAgICAgICAvLyB0aGlzIGlzIGZvciBldmVudCBkZWxlZ2F0aW9uIHRyaWNrcwogICAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50OwogICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLnV0aWxzLmhhc1BhcmVudChldmVudERhdGEudGFyZ2V0LCBlbGVtZW50KSkgewogICAgICAgICAgZWxlbWVudCA9IGV2ZW50RGF0YS50YXJnZXQ7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBlbmFibGUgb2YgZGlzYWJsZSBoYW1tZXIuanMgZGV0ZWN0aW9uCiAgICAgICAqIEBwYXJhbSAgIHtCb29sZWFufSAgIHN0YXRlCiAgICAgICAqIEByZXR1cm5zIHtpb25pYy5HZXN0dXJlcy5JbnN0YW5jZX0KICAgICAgICovCiAgICAgIGVuYWJsZTogZnVuY3Rpb24gZW5hYmxlKHN0YXRlKSB7CiAgICAgICAgdGhpcy5lbmFibGVkID0gc3RhdGU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiB0aGlzIGhvbGRzIHRoZSBsYXN0IG1vdmUgZXZlbnQsCiAgICAgKiB1c2VkIHRvIGZpeCBlbXB0eSB0b3VjaGVuZCBpc3N1ZQogICAgICogc2VlIHRoZSBvblRvdWNoIGV2ZW50IGZvciBhbiBleHBsYW5hdGlvbgogICAgICogdHlwZSB7T2JqZWN0fQogICAgICovCiAgICB2YXIgbGFzdF9tb3ZlX2V2ZW50ID0gbnVsbDsKCgogICAgLyoqCiAgICAgKiB3aGVuIHRoZSBtb3VzZSBpcyBob2xkIGRvd24sIHRoaXMgaXMgdHJ1ZQogICAgICogdHlwZSB7Qm9vbGVhbn0KICAgICAqLwogICAgdmFyIGVuYWJsZV9kZXRlY3QgPSBmYWxzZTsKCgogICAgLyoqCiAgICAgKiB3aGVuIHRvdWNoIGV2ZW50cyBoYXZlIGJlZW4gZmlyZWQsIHRoaXMgaXMgdHJ1ZQogICAgICogdHlwZSB7Qm9vbGVhbn0KICAgICAqLwogICAgdmFyIHRvdWNoX3RyaWdnZXJlZCA9IGZhbHNlOwoKCiAgICBpb25pYy5HZXN0dXJlcy5ldmVudCA9IHsKICAgICAgLyoqCiAgICAgICAqIHNpbXBsZSBhZGRFdmVudExpc3RlbmVyCiAgICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBlbGVtZW50CiAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgICB0eXBlCiAgICAgICAqIEBwYXJhbSAgIHtGdW5jdGlvbn0gICAgICBoYW5kbGVyCiAgICAgICAqLwogICAgICBiaW5kRG9tOiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBoYW5kbGVyKSB7CiAgICAgICAgdmFyIHR5cGVzID0gdHlwZS5zcGxpdCgnICcpOwogICAgICAgIGZvcih2YXIgdD0wOyB0PHR5cGVzLmxlbmd0aDsgdCsrKSB7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodHlwZXNbdF0sIGhhbmRsZXIsIGZhbHNlKTsKICAgICAgICB9CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIHRvdWNoIGV2ZW50cyB3aXRoIG1vdXNlIGZhbGxiYWNrCiAgICAgICAqIEBwYXJhbSAgIHtIVE1MRWxlbWVudH0gICBlbGVtZW50CiAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgICBldmVudFR5cGUgICAgICAgIGxpa2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRQogICAgICAgKiBAcGFyYW0gICB7RnVuY3Rpb259ICAgICAgaGFuZGxlcgogICAgICAgKi8KICAgICAgb25Ub3VjaDogZnVuY3Rpb24gb25Ub3VjaChlbGVtZW50LCBldmVudFR5cGUsIGhhbmRsZXIpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHRoaXMuYmluZERvbShlbGVtZW50LCBpb25pYy5HZXN0dXJlcy5FVkVOVF9UWVBFU1tldmVudFR5cGVdLCBmdW5jdGlvbiBiaW5kRG9tT25Ub3VjaChldikgewogICAgICAgICAgdmFyIHNvdXJjZUV2ZW50VHlwZSA9IGV2LnR5cGUudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAvLyBvbm1vdXNldXAsIGJ1dCB3aGVuIHRvdWNoZW5kIGhhcyBiZWVuIGZpcmVkIHdlIGRvIG5vdGhpbmcuCiAgICAgICAgICAvLyB0aGlzIGlzIGZvciB0b3VjaGRldmljZXMgd2hpY2ggYWxzbyBmaXJlIGEgbW91c2V1cCBvbiB0b3VjaGVuZAogICAgICAgICAgaWYoc291cmNlRXZlbnRUeXBlLm1hdGNoKC9tb3VzZS8pICYmIHRvdWNoX3RyaWdnZXJlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgLy8gbW91c2VidXR0b24gbXVzdCBiZSBkb3duIG9yIGEgdG91Y2ggZXZlbnQKICAgICAgICAgIGVsc2UgaWYoIHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdG91Y2gvKSB8fCAgIC8vIHRvdWNoIGV2ZW50cyBhcmUgYWx3YXlzIG9uIHNjcmVlbgogICAgICAgICAgICBzb3VyY2VFdmVudFR5cGUubWF0Y2goL3BvaW50ZXJkb3duLykgfHwgLy8gcG9pbnRlcmV2ZW50cyB0b3VjaAogICAgICAgICAgICAoc291cmNlRXZlbnRUeXBlLm1hdGNoKC9tb3VzZS8pICYmIGV2LndoaWNoID09PSAxKSAgIC8vIG1vdXNlIGlzIHByZXNzZWQKICAgICAgICAgICAgKXsKICAgICAgICAgICAgZW5hYmxlX2RldGVjdCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gbW91c2UgaXNuJ3QgcHJlc3NlZAogICAgICAgICAgZWxzZSBpZihzb3VyY2VFdmVudFR5cGUubWF0Y2goL21vdXNlLykgJiYgZXYud2hpY2ggIT09IDEpIHsKICAgICAgICAgICAgZW5hYmxlX2RldGVjdCA9IGZhbHNlOwogICAgICAgICAgfQoKCiAgICAgICAgICAvLyB3ZSBhcmUgaW4gYSB0b3VjaCBldmVudCwgc2V0IHRoZSB0b3VjaCB0cmlnZ2VyZWQgYm9vbCB0byB0cnVlLAogICAgICAgICAgLy8gdGhpcyBmb3IgdGhlIGNvbmZsaWN0cyB0aGF0IG1heSBvY2N1ciBvbiBpb3MgYW5kIGFuZHJvaWQKICAgICAgICAgIGlmKHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdG91Y2h8cG9pbnRlci8pKSB7CiAgICAgICAgICAgIHRvdWNoX3RyaWdnZXJlZCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gY291bnQgdGhlIHRvdGFsIHRvdWNoZXMgb24gdGhlIHNjcmVlbgogICAgICAgICAgdmFyIGNvdW50X3RvdWNoZXMgPSAwOwoKICAgICAgICAgIC8vIHdoZW4gdG91Y2ggaGFzIGJlZW4gdHJpZ2dlcmVkIGluIHRoaXMgZGV0ZWN0aW9uIHNlc3Npb24KICAgICAgICAgIC8vIGFuZCB3ZSBhcmUgbm93IGhhbmRsaW5nIGEgbW91c2UgZXZlbnQsIHdlIHN0b3AgdGhhdCB0byBwcmV2ZW50IGNvbmZsaWN0cwogICAgICAgICAgaWYoZW5hYmxlX2RldGVjdCkgewogICAgICAgICAgICAvLyB1cGRhdGUgcG9pbnRlcmV2ZW50CiAgICAgICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLkhBU19QT0lOVEVSRVZFTlRTICYmIGV2ZW50VHlwZSAhPSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQpIHsKICAgICAgICAgICAgICBjb3VudF90b3VjaGVzID0gaW9uaWMuR2VzdHVyZXMuUG9pbnRlckV2ZW50LnVwZGF0ZVBvaW50ZXIoZXZlbnRUeXBlLCBldik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gdG91Y2gKICAgICAgICAgICAgZWxzZSBpZihzb3VyY2VFdmVudFR5cGUubWF0Y2goL3RvdWNoLykpIHsKICAgICAgICAgICAgICBjb3VudF90b3VjaGVzID0gZXYudG91Y2hlcy5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gbW91c2UKICAgICAgICAgICAgZWxzZSBpZighdG91Y2hfdHJpZ2dlcmVkKSB7CiAgICAgICAgICAgICAgY291bnRfdG91Y2hlcyA9IHNvdXJjZUV2ZW50VHlwZS5tYXRjaCgvdXAvKSA/IDAgOiAxOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiB3ZSBhcmUgaW4gYSBlbmQgZXZlbnQsIGJ1dCB3aGVuIHdlIHJlbW92ZSBvbmUgdG91Y2ggYW5kCiAgICAgICAgICAgIC8vIHdlIHN0aWxsIGhhdmUgZW5vdWdoLCBzZXQgZXZlbnRUeXBlIHRvIG1vdmUKICAgICAgICAgICAgaWYoY291bnRfdG91Y2hlcyA+IDAgJiYgZXZlbnRUeXBlID09IGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORCkgewogICAgICAgICAgICAgIGV2ZW50VHlwZSA9IGlvbmljLkdlc3R1cmVzLkVWRU5UX01PVkU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gbm8gdG91Y2hlcywgZm9yY2UgdGhlIGVuZCBldmVudAogICAgICAgICAgICBlbHNlIGlmKCFjb3VudF90b3VjaGVzKSB7CiAgICAgICAgICAgICAgZXZlbnRUeXBlID0gaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBzdG9yZSB0aGUgbGFzdCBtb3ZlIGV2ZW50CiAgICAgICAgICAgIGlmKGNvdW50X3RvdWNoZXMgfHwgbGFzdF9tb3ZlX2V2ZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbGFzdF9tb3ZlX2V2ZW50ID0gZXY7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHRyaWdnZXIgdGhlIGhhbmRsZXIKICAgICAgICAgICAgaGFuZGxlci5jYWxsKGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbiwgc2VsZi5jb2xsZWN0RXZlbnREYXRhKGVsZW1lbnQsIGV2ZW50VHlwZSwgc2VsZi5nZXRUb3VjaExpc3QobGFzdF9tb3ZlX2V2ZW50LCBldmVudFR5cGUpLCBldikpOwoKICAgICAgICAgICAgLy8gcmVtb3ZlIHBvaW50ZXJldmVudCBmcm9tIGxpc3QKICAgICAgICAgICAgaWYoaW9uaWMuR2VzdHVyZXMuSEFTX1BPSU5URVJFVkVOVFMgJiYgZXZlbnRUeXBlID09IGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORCkgewogICAgICAgICAgICAgIGNvdW50X3RvdWNoZXMgPSBpb25pYy5HZXN0dXJlcy5Qb2ludGVyRXZlbnQudXBkYXRlUG9pbnRlcihldmVudFR5cGUsIGV2KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vZGVidWcoc291cmNlRXZlbnRUeXBlICsiICIrIGV2ZW50VHlwZSk7CgogICAgICAgICAgLy8gb24gdGhlIGVuZCB3ZSByZXNldCBldmVyeXRoaW5nCiAgICAgICAgICBpZighY291bnRfdG91Y2hlcykgewogICAgICAgICAgICBsYXN0X21vdmVfZXZlbnQgPSBudWxsOwogICAgICAgICAgICBlbmFibGVfZGV0ZWN0ID0gZmFsc2U7CiAgICAgICAgICAgIHRvdWNoX3RyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgICBpb25pYy5HZXN0dXJlcy5Qb2ludGVyRXZlbnQucmVzZXQoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogd2UgaGF2ZSBkaWZmZXJlbnQgZXZlbnRzIGZvciBlYWNoIGRldmljZS9icm93c2VyCiAgICAgICAqIGRldGVybWluZSB3aGF0IHdlIG5lZWQgYW5kIHNldCB0aGVtIGluIHRoZSBpb25pYy5HZXN0dXJlcy5FVkVOVF9UWVBFUyBjb25zdGFudAogICAgICAgKi8KICAgICAgZGV0ZXJtaW5lRXZlbnRUeXBlczogZnVuY3Rpb24gZGV0ZXJtaW5lRXZlbnRUeXBlcygpIHsKICAgICAgICAvLyBkZXRlcm1pbmUgdGhlIGV2ZW50dHlwZSB3ZSB3YW50IHRvIHNldAogICAgICAgIHZhciB0eXBlczsKCiAgICAgICAgLy8gcG9pbnRlckV2ZW50cyBtYWdpYwogICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLkhBU19QT0lOVEVSRVZFTlRTKSB7CiAgICAgICAgICB0eXBlcyA9IGlvbmljLkdlc3R1cmVzLlBvaW50ZXJFdmVudC5nZXRFdmVudHMoKTsKICAgICAgICB9CiAgICAgICAgLy8gb24gQW5kcm9pZCwgaU9TLCBibGFja2JlcnJ5LCB3aW5kb3dzIG1vYmlsZSB3ZSBkb250IHdhbnQgYW55IG1vdXNlZXZlbnRzCiAgICAgICAgZWxzZSBpZihpb25pYy5HZXN0dXJlcy5OT19NT1VTRUVWRU5UUykgewogICAgICAgICAgdHlwZXMgPSBbCiAgICAgICAgICAgICd0b3VjaHN0YXJ0JywKICAgICAgICAgICAgJ3RvdWNobW92ZScsCiAgICAgICAgICAgICd0b3VjaGVuZCB0b3VjaGNhbmNlbCddOwogICAgICAgIH0KICAgICAgICAvLyBmb3Igbm9uIHBvaW50ZXIgZXZlbnRzIGJyb3dzZXJzIGFuZCBtaXhlZCBicm93c2VycywKICAgICAgICAvLyBsaWtlIGNocm9tZSBvbiB3aW5kb3dzOCB0b3VjaCBsYXB0b3AKICAgICAgICBlbHNlIHsKICAgICAgICAgIHR5cGVzID0gWwogICAgICAgICAgICAndG91Y2hzdGFydCBtb3VzZWRvd24nLAogICAgICAgICAgICAndG91Y2htb3ZlIG1vdXNlbW92ZScsCiAgICAgICAgICAgICd0b3VjaGVuZCB0b3VjaGNhbmNlbCBtb3VzZXVwJ107CiAgICAgICAgfQoKICAgICAgICBpb25pYy5HZXN0dXJlcy5FVkVOVF9UWVBFU1tpb25pYy5HZXN0dXJlcy5FVkVOVF9TVEFSVF0gID0gdHlwZXNbMF07CiAgICAgICAgaW9uaWMuR2VzdHVyZXMuRVZFTlRfVFlQRVNbaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRV0gICA9IHR5cGVzWzFdOwogICAgICAgIGlvbmljLkdlc3R1cmVzLkVWRU5UX1RZUEVTW2lvbmljLkdlc3R1cmVzLkVWRU5UX0VORF0gICAgPSB0eXBlc1syXTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogY3JlYXRlIHRvdWNobGlzdCBkZXBlbmRpbmcgb24gdGhlIGV2ZW50CiAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgIGV2CiAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgIGV2ZW50VHlwZSAgIHVzZWQgYnkgdGhlIGZha2VtdWx0aXRvdWNoIHBsdWdpbgogICAgICAgKi8KICAgICAgZ2V0VG91Y2hMaXN0OiBmdW5jdGlvbiBnZXRUb3VjaExpc3QoZXYvKiwgZXZlbnRUeXBlKi8pIHsKICAgICAgICAvLyBnZXQgdGhlIGZha2UgcG9pbnRlckV2ZW50IHRvdWNobGlzdAogICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLkhBU19QT0lOVEVSRVZFTlRTKSB7CiAgICAgICAgICByZXR1cm4gaW9uaWMuR2VzdHVyZXMuUG9pbnRlckV2ZW50LmdldFRvdWNoTGlzdCgpOwogICAgICAgIH0KICAgICAgICAvLyBnZXQgdGhlIHRvdWNobGlzdAogICAgICAgIGVsc2UgaWYoZXYudG91Y2hlcykgewogICAgICAgICAgcmV0dXJuIGV2LnRvdWNoZXM7CiAgICAgICAgfQogICAgICAgIC8vIG1ha2UgZmFrZSB0b3VjaGxpc3QgZnJvbSBtb3VzZSBwb3NpdGlvbgogICAgICAgIGVsc2UgewogICAgICAgICAgZXYuaWRlbnRpZmllciA9IDE7CiAgICAgICAgICByZXR1cm4gW2V2XTsKICAgICAgICB9CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIGNvbGxlY3QgZXZlbnQgZGF0YSBmb3IgaW9uaWMuR2VzdHVyZXMganMKICAgICAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgIGVsZW1lbnQKICAgICAgICogQHBhcmFtICAge1N0cmluZ30gICAgICAgIGV2ZW50VHlwZSAgICAgICAgbGlrZSBpb25pYy5HZXN0dXJlcy5FVkVOVF9NT1ZFCiAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgICAgICBldmVudERhdGEKICAgICAgICovCiAgICAgIGNvbGxlY3RFdmVudERhdGE6IGZ1bmN0aW9uIGNvbGxlY3RFdmVudERhdGEoZWxlbWVudCwgZXZlbnRUeXBlLCB0b3VjaGVzLCBldikgewoKICAgICAgICAvLyBmaW5kIG91dCBwb2ludGVyVHlwZQogICAgICAgIHZhciBwb2ludGVyVHlwZSA9IGlvbmljLkdlc3R1cmVzLlBPSU5URVJfVE9VQ0g7CiAgICAgICAgaWYoZXYudHlwZS5tYXRjaCgvbW91c2UvKSB8fCBpb25pYy5HZXN0dXJlcy5Qb2ludGVyRXZlbnQubWF0Y2hUeXBlKGlvbmljLkdlc3R1cmVzLlBPSU5URVJfTU9VU0UsIGV2KSkgewogICAgICAgICAgcG9pbnRlclR5cGUgPSBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX01PVVNFOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNlbnRlciAgICAgIDogaW9uaWMuR2VzdHVyZXMudXRpbHMuZ2V0Q2VudGVyKHRvdWNoZXMpLAogICAgICAgICAgdGltZVN0YW1wICAgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKICAgICAgICAgIHRhcmdldCAgICAgIDogZXYudGFyZ2V0LAogICAgICAgICAgdG91Y2hlcyAgICAgOiB0b3VjaGVzLAogICAgICAgICAgZXZlbnRUeXBlICAgOiBldmVudFR5cGUsCiAgICAgICAgICBwb2ludGVyVHlwZSA6IHBvaW50ZXJUeXBlLAogICAgICAgICAgc3JjRXZlbnQgICAgOiBldiwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIHByZXZlbnQgdGhlIGJyb3dzZXIgZGVmYXVsdCBhY3Rpb25zCiAgICAgICAgICAgKiBtb3N0bHkgdXNlZCB0byBkaXNhYmxlIHNjcm9sbGluZyBvZiB0aGUgYnJvd3NlcgogICAgICAgICAgICovCiAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmKHRoaXMuc3JjRXZlbnQucHJldmVudE1hbmlwdWxhdGlvbikgewogICAgICAgICAgICAgIHRoaXMuc3JjRXZlbnQucHJldmVudE1hbmlwdWxhdGlvbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZih0aGlzLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgLy90aGlzLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBzdG9wIGJ1YmJsaW5nIHRoZSBldmVudCB1cCB0byBpdHMgcGFyZW50cwogICAgICAgICAgICovCiAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnNyY0V2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIGltbWVkaWF0ZWx5IHN0b3AgZ2VzdHVyZSBkZXRlY3Rpb24KICAgICAgICAgICAqIG1pZ2h0IGJlIHVzZWZ1bCBhZnRlciBhIHN3aXBlIHdhcyBkZXRlY3RlZAogICAgICAgICAgICogQHJldHVybiB7Kn0KICAgICAgICAgICAqLwogICAgICAgICAgc3RvcERldGVjdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uc3RvcERldGVjdCgpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgIH07CgogICAgaW9uaWMuR2VzdHVyZXMuUG9pbnRlckV2ZW50ID0gewogICAgICAvKioKICAgICAgICogaG9sZHMgYWxsIHBvaW50ZXJzCiAgICAgICAqIHR5cGUge09iamVjdH0KICAgICAgICovCiAgICAgIHBvaW50ZXJzOiB7fSwKCiAgICAgIC8qKgogICAgICAgKiBnZXQgYSBsaXN0IG9mIHBvaW50ZXJzCiAgICAgICAqIEByZXR1cm5zIHtBcnJheX0gICAgIHRvdWNobGlzdAogICAgICAgKi8KICAgICAgZ2V0VG91Y2hMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgdmFyIHRvdWNobGlzdCA9IFtdOwoKICAgICAgICAvLyB3ZSBjYW4gdXNlIGZvckVhY2ggc2luY2UgcG9pbnRlckV2ZW50cyBvbmx5IGlzIGluIElFMTAKICAgICAgICBPYmplY3Qua2V5cyhzZWxmLnBvaW50ZXJzKS5zb3J0KCkuZm9yRWFjaChmdW5jdGlvbihpZCkgewogICAgICAgICAgdG91Y2hsaXN0LnB1c2goc2VsZi5wb2ludGVyc1tpZF0pOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0b3VjaGxpc3Q7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogdXBkYXRlIHRoZSBwb3NpdGlvbiBvZiBhIHBvaW50ZXIKICAgICAgICogQHBhcmFtICAge1N0cmluZ30gICB0eXBlICAgICAgICAgICAgIGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORAogICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgIHBvaW50ZXJFdmVudAogICAgICAgKi8KICAgICAgdXBkYXRlUG9pbnRlcjogZnVuY3Rpb24odHlwZSwgcG9pbnRlckV2ZW50KSB7CiAgICAgICAgaWYodHlwZSA9PSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQpIHsKICAgICAgICAgIHRoaXMucG9pbnRlcnMgPSB7fTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICBwb2ludGVyRXZlbnQuaWRlbnRpZmllciA9IHBvaW50ZXJFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICB0aGlzLnBvaW50ZXJzW3BvaW50ZXJFdmVudC5wb2ludGVySWRdID0gcG9pbnRlckV2ZW50OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMucG9pbnRlcnMpLmxlbmd0aDsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBjaGVjayBpZiBldiBtYXRjaGVzIHBvaW50ZXJ0eXBlCiAgICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgICAgICBwb2ludGVyVHlwZSAgICAgaW9uaWMuR2VzdHVyZXMuUE9JTlRFUl9NT1VTRQogICAgICAgKiBAcGFyYW0gICB7UG9pbnRlckV2ZW50fSAgZXYKICAgICAgICovCiAgICAgIG1hdGNoVHlwZTogZnVuY3Rpb24ocG9pbnRlclR5cGUsIGV2KSB7CiAgICAgICAgaWYoIWV2LnBvaW50ZXJUeXBlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB2YXIgdHlwZXMgPSB7fTsKICAgICAgICB0eXBlc1tpb25pYy5HZXN0dXJlcy5QT0lOVEVSX01PVVNFXSA9IChldi5wb2ludGVyVHlwZSA9PSBldi5NU1BPSU5URVJfVFlQRV9NT1VTRSB8fCBldi5wb2ludGVyVHlwZSA9PSBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX01PVVNFKTsKICAgICAgICB0eXBlc1tpb25pYy5HZXN0dXJlcy5QT0lOVEVSX1RPVUNIXSA9IChldi5wb2ludGVyVHlwZSA9PSBldi5NU1BPSU5URVJfVFlQRV9UT1VDSCB8fCBldi5wb2ludGVyVHlwZSA9PSBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX1RPVUNIKTsKICAgICAgICB0eXBlc1tpb25pYy5HZXN0dXJlcy5QT0lOVEVSX1BFTl0gPSAoZXYucG9pbnRlclR5cGUgPT0gZXYuTVNQT0lOVEVSX1RZUEVfUEVOIHx8IGV2LnBvaW50ZXJUeXBlID09IGlvbmljLkdlc3R1cmVzLlBPSU5URVJfUEVOKTsKICAgICAgICByZXR1cm4gdHlwZXNbcG9pbnRlclR5cGVdOwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBnZXQgZXZlbnRzCiAgICAgICAqLwogICAgICBnZXRFdmVudHM6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBbCiAgICAgICAgICAncG9pbnRlcmRvd24gTVNQb2ludGVyRG93bicsCiAgICAgICAgICAncG9pbnRlcm1vdmUgTVNQb2ludGVyTW92ZScsCiAgICAgICAgICAncG9pbnRlcnVwIHBvaW50ZXJjYW5jZWwgTVNQb2ludGVyVXAgTVNQb2ludGVyQ2FuY2VsJwogICAgICAgIF07CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogcmVzZXQgdGhlIGxpc3QKICAgICAgICovCiAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnBvaW50ZXJzID0ge307CiAgICAgIH0KICAgIH07CgoKICAgIGlvbmljLkdlc3R1cmVzLnV0aWxzID0gewogICAgICAvKioKICAgICAgICogZXh0ZW5kIG1ldGhvZCwKICAgICAgICogYWxzbyB1c2VkIGZvciBjbG9uaW5nIHdoZW4gZGVzdCBpcyBhbiBlbXB0eSBvYmplY3QKICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgZGVzdAogICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICBzcmMKICAgICAgICogQHBhcmFtCXtCb29sZWFufQltZXJnZQkJZG8gYSBtZXJnZQogICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSAgICBkZXN0CiAgICAgICAqLwogICAgICBleHRlbmQ6IGZ1bmN0aW9uIGV4dGVuZChkZXN0LCBzcmMsIG1lcmdlKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHNyYykgewogICAgICAgICAgaWYoZGVzdFtrZXldICE9PSB1bmRlZmluZWQgJiYgbWVyZ2UpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBkZXN0W2tleV0gPSBzcmNba2V5XTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRlc3Q7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIGZpbmQgaWYgYSBub2RlIGlzIGluIHRoZSBnaXZlbiBwYXJlbnQKICAgICAgICogdXNlZCBmb3IgZXZlbnQgZGVsZWdhdGlvbiB0cmlja3MKICAgICAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgIG5vZGUKICAgICAgICogQHBhcmFtICAge0hUTUxFbGVtZW50fSAgIHBhcmVudAogICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gICAgICAgaGFzX3BhcmVudAogICAgICAgKi8KICAgICAgaGFzUGFyZW50OiBmdW5jdGlvbihub2RlLCBwYXJlbnQpIHsKICAgICAgICB3aGlsZShub2RlKXsKICAgICAgICAgIGlmKG5vZGUgPT0gcGFyZW50KSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBnZXQgdGhlIGNlbnRlciBvZiBhbGwgdGhlIHRvdWNoZXMKICAgICAgICogQHBhcmFtICAge0FycmF5fSAgICAgdG91Y2hlcwogICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSAgICBjZW50ZXIKICAgICAgICovCiAgICAgIGdldENlbnRlcjogZnVuY3Rpb24gZ2V0Q2VudGVyKHRvdWNoZXMpIHsKICAgICAgICB2YXIgdmFsdWVzWCA9IFtdLCB2YWx1ZXNZID0gW107CgogICAgICAgIGZvcih2YXIgdD0gMCxsZW49dG91Y2hlcy5sZW5ndGg7IHQ8bGVuOyB0KyspIHsKICAgICAgICAgIHZhbHVlc1gucHVzaCh0b3VjaGVzW3RdLnBhZ2VYKTsKICAgICAgICAgIHZhbHVlc1kucHVzaCh0b3VjaGVzW3RdLnBhZ2VZKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwYWdlWDogKChNYXRoLm1pbi5hcHBseShNYXRoLCB2YWx1ZXNYKSArIE1hdGgubWF4LmFwcGx5KE1hdGgsIHZhbHVlc1gpKSAvIDIpLAogICAgICAgICAgcGFnZVk6ICgoTWF0aC5taW4uYXBwbHkoTWF0aCwgdmFsdWVzWSkgKyBNYXRoLm1heC5hcHBseShNYXRoLCB2YWx1ZXNZKSkgLyAyKQogICAgICAgIH07CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIGNhbGN1bGF0ZSB0aGUgdmVsb2NpdHkgYmV0d2VlbiB0d28gcG9pbnRzCiAgICAgICAqIEBwYXJhbSAgIHtOdW1iZXJ9ICAgIGRlbHRhX3RpbWUKICAgICAgICogQHBhcmFtICAge051bWJlcn0gICAgZGVsdGFfeAogICAgICAgKiBAcGFyYW0gICB7TnVtYmVyfSAgICBkZWx0YV95CiAgICAgICAqIEByZXR1cm5zIHtPYmplY3R9ICAgIHZlbG9jaXR5CiAgICAgICAqLwogICAgICBnZXRWZWxvY2l0eTogZnVuY3Rpb24gZ2V0VmVsb2NpdHkoZGVsdGFfdGltZSwgZGVsdGFfeCwgZGVsdGFfeSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICB4OiBNYXRoLmFicyhkZWx0YV94IC8gZGVsdGFfdGltZSkgfHwgMCwKICAgICAgICAgIHk6IE1hdGguYWJzKGRlbHRhX3kgLyBkZWx0YV90aW1lKSB8fCAwCiAgICAgICAgfTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogY2FsY3VsYXRlIHRoZSBhbmdsZSBiZXR3ZWVuIHR3byBjb29yZGluYXRlcwogICAgICAgKiBAcGFyYW0gICB7VG91Y2h9ICAgICB0b3VjaDEKICAgICAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gyCiAgICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9ICAgIGFuZ2xlCiAgICAgICAqLwogICAgICBnZXRBbmdsZTogZnVuY3Rpb24gZ2V0QW5nbGUodG91Y2gxLCB0b3VjaDIpIHsKICAgICAgICB2YXIgeSA9IHRvdWNoMi5wYWdlWSAtIHRvdWNoMS5wYWdlWSwKICAgICAgICAgIHggPSB0b3VjaDIucGFnZVggLSB0b3VjaDEucGFnZVg7CiAgICAgICAgcmV0dXJuIE1hdGguYXRhbjIoeSwgeCkgKiAxODAgLyBNYXRoLlBJOwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBhbmdsZSB0byBkaXJlY3Rpb24gZGVmaW5lCiAgICAgICAqIEBwYXJhbSAgIHtUb3VjaH0gICAgIHRvdWNoMQogICAgICAgKiBAcGFyYW0gICB7VG91Y2h9ICAgICB0b3VjaDIKICAgICAgICogQHJldHVybnMge1N0cmluZ30gICAgZGlyZWN0aW9uIGNvbnN0YW50LCBsaWtlIGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9MRUZUCiAgICAgICAqLwogICAgICBnZXREaXJlY3Rpb246IGZ1bmN0aW9uIGdldERpcmVjdGlvbih0b3VjaDEsIHRvdWNoMikgewogICAgICAgIHZhciB4ID0gTWF0aC5hYnModG91Y2gxLnBhZ2VYIC0gdG91Y2gyLnBhZ2VYKSwKICAgICAgICAgIHkgPSBNYXRoLmFicyh0b3VjaDEucGFnZVkgLSB0b3VjaDIucGFnZVkpOwoKICAgICAgICBpZih4ID49IHkpIHsKICAgICAgICAgIHJldHVybiB0b3VjaDEucGFnZVggLSB0b3VjaDIucGFnZVggPiAwID8gaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX0xFRlQgOiBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fUklHSFQ7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgcmV0dXJuIHRvdWNoMS5wYWdlWSAtIHRvdWNoMi5wYWdlWSA+IDAgPyBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fVVAgOiBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fRE9XTjsKICAgICAgICB9CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIGNhbGN1bGF0ZSB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0d28gdG91Y2hlcwogICAgICAgKiBAcGFyYW0gICB7VG91Y2h9ICAgICB0b3VjaDEKICAgICAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gyCiAgICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9ICAgIGRpc3RhbmNlCiAgICAgICAqLwogICAgICBnZXREaXN0YW5jZTogZnVuY3Rpb24gZ2V0RGlzdGFuY2UodG91Y2gxLCB0b3VjaDIpIHsKICAgICAgICB2YXIgeCA9IHRvdWNoMi5wYWdlWCAtIHRvdWNoMS5wYWdlWCwKICAgICAgICAgIHkgPSB0b3VjaDIucGFnZVkgLSB0b3VjaDEucGFnZVk7CiAgICAgICAgcmV0dXJuIE1hdGguc3FydCgoeCp4KSArICh5KnkpKTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogY2FsY3VsYXRlIHRoZSBzY2FsZSBmYWN0b3IgYmV0d2VlbiB0d28gdG91Y2hMaXN0cyAoZmluZ2VycykKICAgICAgICogbm8gc2NhbGUgaXMgMSwgYW5kIGdvZXMgZG93biB0byAwIHdoZW4gcGluY2hlZCB0b2dldGhlciwgYW5kIGJpZ2dlciB3aGVuIHBpbmNoZWQgb3V0CiAgICAgICAqIEBwYXJhbSAgIHtBcnJheX0gICAgIHN0YXJ0CiAgICAgICAqIEBwYXJhbSAgIHtBcnJheX0gICAgIGVuZAogICAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSAgICBzY2FsZQogICAgICAgKi8KICAgICAgZ2V0U2NhbGU6IGZ1bmN0aW9uIGdldFNjYWxlKHN0YXJ0LCBlbmQpIHsKICAgICAgICAvLyBuZWVkIHR3byBmaW5nZXJzLi4uCiAgICAgICAgaWYoc3RhcnQubGVuZ3RoID49IDIgJiYgZW5kLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5nZXREaXN0YW5jZShlbmRbMF0sIGVuZFsxXSkgLwogICAgICAgICAgICB0aGlzLmdldERpc3RhbmNlKHN0YXJ0WzBdLCBzdGFydFsxXSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAxOwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBjYWxjdWxhdGUgdGhlIHJvdGF0aW9uIGRlZ3JlZXMgYmV0d2VlbiB0d28gdG91Y2hMaXN0cyAoZmluZ2VycykKICAgICAgICogQHBhcmFtICAge0FycmF5fSAgICAgc3RhcnQKICAgICAgICogQHBhcmFtICAge0FycmF5fSAgICAgZW5kCiAgICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9ICAgIHJvdGF0aW9uCiAgICAgICAqLwogICAgICBnZXRSb3RhdGlvbjogZnVuY3Rpb24gZ2V0Um90YXRpb24oc3RhcnQsIGVuZCkgewogICAgICAgIC8vIG5lZWQgdHdvIGZpbmdlcnMKICAgICAgICBpZihzdGFydC5sZW5ndGggPj0gMiAmJiBlbmQubGVuZ3RoID49IDIpIHsKICAgICAgICAgIHJldHVybiB0aGlzLmdldEFuZ2xlKGVuZFsxXSwgZW5kWzBdKSAtCiAgICAgICAgICAgIHRoaXMuZ2V0QW5nbGUoc3RhcnRbMV0sIHN0YXJ0WzBdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIGJvb2xlYW4gaWYgdGhlIGRpcmVjdGlvbiBpcyB2ZXJ0aWNhbAogICAgICAgKiBAcGFyYW0gICAge1N0cmluZ30gICAgZGlyZWN0aW9uCiAgICAgICAqIEByZXR1cm5zICB7Qm9vbGVhbn0gICBpc192ZXJ0aWNhbAogICAgICAgKi8KICAgICAgaXNWZXJ0aWNhbDogZnVuY3Rpb24gaXNWZXJ0aWNhbChkaXJlY3Rpb24pIHsKICAgICAgICByZXR1cm4gKGRpcmVjdGlvbiA9PSBpb25pYy5HZXN0dXJlcy5ESVJFQ1RJT05fVVAgfHwgZGlyZWN0aW9uID09IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9ET1dOKTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogc3RvcCBicm93c2VyIGRlZmF1bHQgYmVoYXZpb3Igd2l0aCBjc3MgY2xhc3MKICAgICAgICogQHBhcmFtICAge0h0bWxFbGVtZW50fSAgIGVsZW1lbnQKICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgICAgIGNzc19jbGFzcwogICAgICAgKi8KICAgICAgc3RvcERlZmF1bHRCcm93c2VyQmVoYXZpb3I6IGZ1bmN0aW9uIHN0b3BEZWZhdWx0QnJvd3NlckJlaGF2aW9yKGVsZW1lbnQsIGNzc19jbGFzcykgewogICAgICAgIC8vIGNoYW5nZWQgZnJvbSBtYWtpbmcgbWFueSBzdHlsZSBjaGFuZ2VzIHRvIGp1c3QgYWRkaW5nIGEgcHJlc2V0IGNsYXNzbmFtZQogICAgICAgIC8vIGxlc3MgRE9NIG1hbmlwdWxhdGlvbnMsIGxlc3MgY29kZSwgYW5kIGVhc2llciB0byBjb250cm9sIGluIHRoZSBDU1Mgc2lkZSBvZiB0aGluZ3MKICAgICAgICAvLyBoYW1tZXIuanMgZG9lc24ndCBjb21lIHdpdGggQ1NTLCBidXQgaW9uaWMgZG9lcywgd2hpY2ggaXMgd2h5IHdlIHByZWZlciB0aGlzIG1ldGhvZAogICAgICAgIGlmKGVsZW1lbnQgJiYgZWxlbWVudC5jbGFzc0xpc3QpIHsKICAgICAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZChjc3NfY2xhc3MpOwogICAgICAgICAgZWxlbWVudC5vbnNlbGVjdHN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKCiAgICBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24gPSB7CiAgICAgIC8vIGNvbnRhaW5zIGFsbCByZWdpc3RyZWQgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMgaW4gdGhlIGNvcnJlY3Qgb3JkZXIKICAgICAgZ2VzdHVyZXM6IFtdLAoKICAgICAgLy8gZGF0YSBvZiB0aGUgY3VycmVudCBpb25pYy5HZXN0dXJlcy5nZXN0dXJlIGRldGVjdGlvbiBzZXNzaW9uCiAgICAgIGN1cnJlbnQ6IG51bGwsCgogICAgICAvLyB0aGUgcHJldmlvdXMgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBzZXNzaW9uIGRhdGEKICAgICAgLy8gaXMgYSBmdWxsIGNsb25lIG9mIHRoZSBwcmV2aW91cyBnZXN0dXJlLmN1cnJlbnQgb2JqZWN0CiAgICAgIHByZXZpb3VzOiBudWxsLAoKICAgICAgLy8gd2hlbiB0aGlzIGJlY29tZXMgdHJ1ZSwgbm8gZ2VzdHVyZXMgYXJlIGZpcmVkCiAgICAgIHN0b3BwZWQ6IGZhbHNlLAoKCiAgICAgIC8qKgogICAgICAgKiBzdGFydCBpb25pYy5HZXN0dXJlcy5nZXN0dXJlIGRldGVjdGlvbgogICAgICAgKiBAcGFyYW0gICB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9ICAgaW5zdAogICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgICAgICAgIGV2ZW50RGF0YQogICAgICAgKi8KICAgICAgc3RhcnREZXRlY3Q6IGZ1bmN0aW9uIHN0YXJ0RGV0ZWN0KGluc3QsIGV2ZW50RGF0YSkgewogICAgICAgIC8vIGFscmVhZHkgYnVzeSB3aXRoIGEgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBkZXRlY3Rpb24gb24gYW4gZWxlbWVudAogICAgICAgIGlmKHRoaXMuY3VycmVudCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdG9wcGVkID0gZmFsc2U7CgogICAgICAgIHRoaXMuY3VycmVudCA9IHsKICAgICAgICAgIGluc3QgICAgICAgIDogaW5zdCwgLy8gcmVmZXJlbmNlIHRvIGlvbmljLkdlc3R1cmVzSW5zdGFuY2Ugd2UncmUgd29ya2luZyBmb3IKICAgICAgICAgIHN0YXJ0RXZlbnQgIDogaW9uaWMuR2VzdHVyZXMudXRpbHMuZXh0ZW5kKHt9LCBldmVudERhdGEpLCAvLyBzdGFydCBldmVudERhdGEgZm9yIGRpc3RhbmNlcywgdGltaW5nIGV0YwogICAgICAgICAgbGFzdEV2ZW50ICAgOiBmYWxzZSwgLy8gbGFzdCBldmVudERhdGEKICAgICAgICAgIG5hbWUgICAgICAgIDogJycgLy8gY3VycmVudCBnZXN0dXJlIHdlJ3JlIGluL2RldGVjdGVkLCBjYW4gYmUgJ3RhcCcsICdob2xkJyBldGMKICAgICAgICB9OwoKICAgICAgICB0aGlzLmRldGVjdChldmVudERhdGEpOwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBpb25pYy5HZXN0dXJlcy5nZXN0dXJlIGRldGVjdGlvbgogICAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICBldmVudERhdGEKICAgICAgICovCiAgICAgIGRldGVjdDogZnVuY3Rpb24gZGV0ZWN0KGV2ZW50RGF0YSkgewogICAgICAgIGlmKCF0aGlzLmN1cnJlbnQgfHwgdGhpcy5zdG9wcGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBleHRlbmQgZXZlbnQgZGF0YSB3aXRoIGNhbGN1bGF0aW9ucyBhYm91dCBzY2FsZSwgZGlzdGFuY2UgZXRjCiAgICAgICAgZXZlbnREYXRhID0gdGhpcy5leHRlbmRFdmVudERhdGEoZXZlbnREYXRhKTsKCiAgICAgICAgLy8gaW5zdGFuY2Ugb3B0aW9ucwogICAgICAgIHZhciBpbnN0X29wdGlvbnMgPSB0aGlzLmN1cnJlbnQuaW5zdC5vcHRpb25zOwoKICAgICAgICAvLyBjYWxsIGlvbmljLkdlc3R1cmVzLmdlc3R1cmUgaGFuZGxlcnMKICAgICAgICBmb3IodmFyIGc9MCxsZW49dGhpcy5nZXN0dXJlcy5sZW5ndGg7IGc8bGVuOyBnKyspIHsKICAgICAgICAgIHZhciBnZXN0dXJlID0gdGhpcy5nZXN0dXJlc1tnXTsKCiAgICAgICAgICAvLyBvbmx5IHdoZW4gdGhlIGluc3RhbmNlIG9wdGlvbnMgaGF2ZSBlbmFibGVkIHRoaXMgZ2VzdHVyZQogICAgICAgICAgaWYoIXRoaXMuc3RvcHBlZCAmJiBpbnN0X29wdGlvbnNbZ2VzdHVyZS5uYW1lXSAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgLy8gaWYgYSBoYW5kbGVyIHJldHVybnMgZmFsc2UsIHdlIHN0b3Agd2l0aCB0aGUgZGV0ZWN0aW9uCiAgICAgICAgICAgIGlmKGdlc3R1cmUuaGFuZGxlci5jYWxsKGdlc3R1cmUsIGV2ZW50RGF0YSwgdGhpcy5jdXJyZW50Lmluc3QpID09PSBmYWxzZSkgewogICAgICAgICAgICAgIHRoaXMuc3RvcERldGVjdCgpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBzdG9yZSBhcyBwcmV2aW91cyBldmVudCBldmVudAogICAgICAgIGlmKHRoaXMuY3VycmVudCkgewogICAgICAgICAgdGhpcy5jdXJyZW50Lmxhc3RFdmVudCA9IGV2ZW50RGF0YTsKICAgICAgICB9CgogICAgICAgIC8vIGVuZGV2ZW50LCBidXQgbm90IHRoZSBsYXN0IHRvdWNoLCBzbyBkb250IHN0b3AKICAgICAgICBpZihldmVudERhdGEuZXZlbnRUeXBlID09IGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORCAmJiAhZXZlbnREYXRhLnRvdWNoZXMubGVuZ3RoLTEpIHsKICAgICAgICAgIHRoaXMuc3RvcERldGVjdCgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGV2ZW50RGF0YTsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogY2xlYXIgdGhlIGlvbmljLkdlc3R1cmVzLmdlc3R1cmUgdmFycwogICAgICAgKiB0aGlzIGlzIGNhbGxlZCBvbiBlbmREZXRlY3QsIGJ1dCBjYW4gYWxzbyBiZSB1c2VkIHdoZW4gYSBmaW5hbCBpb25pYy5HZXN0dXJlcy5nZXN0dXJlIGhhcyBiZWVuIGRldGVjdGVkCiAgICAgICAqIHRvIHN0b3Agb3RoZXIgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMgZnJvbSBiZWluZyBmaXJlZAogICAgICAgKi8KICAgICAgc3RvcERldGVjdDogZnVuY3Rpb24gc3RvcERldGVjdCgpIHsKICAgICAgICAvLyBjbG9uZSBjdXJyZW50IGRhdGEgdG8gdGhlIHN0b3JlIGFzIHRoZSBwcmV2aW91cyBnZXN0dXJlCiAgICAgICAgLy8gdXNlZCBmb3IgdGhlIGRvdWJsZSB0YXAgZ2VzdHVyZSwgc2luY2UgdGhpcyBpcyBhbiBvdGhlciBnZXN0dXJlIGRldGVjdCBzZXNzaW9uCiAgICAgICAgdGhpcy5wcmV2aW91cyA9IGlvbmljLkdlc3R1cmVzLnV0aWxzLmV4dGVuZCh7fSwgdGhpcy5jdXJyZW50KTsKCiAgICAgICAgLy8gcmVzZXQgdGhlIGN1cnJlbnQKICAgICAgICB0aGlzLmN1cnJlbnQgPSBudWxsOwoKICAgICAgICAvLyBzdG9wcGVkIQogICAgICAgIHRoaXMuc3RvcHBlZCA9IHRydWU7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIGV4dGVuZCBldmVudERhdGEgZm9yIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzCiAgICAgICAqIEBwYXJhbSAgIHtPYmplY3R9ICAgZXYKICAgICAgICogQHJldHVybnMge09iamVjdH0gICBldgogICAgICAgKi8KICAgICAgZXh0ZW5kRXZlbnREYXRhOiBmdW5jdGlvbiBleHRlbmRFdmVudERhdGEoZXYpIHsKICAgICAgICB2YXIgc3RhcnRFdiA9IHRoaXMuY3VycmVudC5zdGFydEV2ZW50OwoKICAgICAgICAvLyBpZiB0aGUgdG91Y2hlcyBjaGFuZ2UsIHNldCB0aGUgbmV3IHRvdWNoZXMgb3ZlciB0aGUgc3RhcnRFdmVudCB0b3VjaGVzCiAgICAgICAgLy8gdGhpcyBiZWNhdXNlIHRvdWNoZXZlbnRzIGRvbid0IGhhdmUgYWxsIHRoZSB0b3VjaGVzIG9uIHRvdWNoc3RhcnQsIG9yIHRoZQogICAgICAgIC8vIHVzZXIgbXVzdCBwbGFjZSBoaXMgZmluZ2VycyBhdCB0aGUgRVhBQ1Qgc2FtZSB0aW1lIG9uIHRoZSBzY3JlZW4sIHdoaWNoIGlzIG5vdCByZWFsaXN0aWMKICAgICAgICAvLyBidXQsIHNvbWV0aW1lcyBpdCBoYXBwZW5zIHRoYXQgYm90aCBmaW5nZXJzIGFyZSB0b3VjaGluZyBhdCB0aGUgRVhBQ1Qgc2FtZSB0aW1lCiAgICAgICAgaWYoc3RhcnRFdiAmJiAoZXYudG91Y2hlcy5sZW5ndGggIT0gc3RhcnRFdi50b3VjaGVzLmxlbmd0aCB8fCBldi50b3VjaGVzID09PSBzdGFydEV2LnRvdWNoZXMpKSB7CiAgICAgICAgICAvLyBleHRlbmQgMSBsZXZlbCBkZWVwIHRvIGdldCB0aGUgdG91Y2hsaXN0IHdpdGggdGhlIHRvdWNoIG9iamVjdHMKICAgICAgICAgIHN0YXJ0RXYudG91Y2hlcyA9IFtdOwogICAgICAgICAgZm9yKHZhciBpPTAsbGVuPWV2LnRvdWNoZXMubGVuZ3RoOyBpPGxlbjsgaSsrKSB7CiAgICAgICAgICAgIHN0YXJ0RXYudG91Y2hlcy5wdXNoKGlvbmljLkdlc3R1cmVzLnV0aWxzLmV4dGVuZCh7fSwgZXYudG91Y2hlc1tpXSkpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGRlbHRhX3RpbWUgPSBldi50aW1lU3RhbXAgLSBzdGFydEV2LnRpbWVTdGFtcCwKICAgICAgICAgIGRlbHRhX3ggPSBldi5jZW50ZXIucGFnZVggLSBzdGFydEV2LmNlbnRlci5wYWdlWCwKICAgICAgICAgIGRlbHRhX3kgPSBldi5jZW50ZXIucGFnZVkgLSBzdGFydEV2LmNlbnRlci5wYWdlWSwKICAgICAgICAgIHZlbG9jaXR5ID0gaW9uaWMuR2VzdHVyZXMudXRpbHMuZ2V0VmVsb2NpdHkoZGVsdGFfdGltZSwgZGVsdGFfeCwgZGVsdGFfeSk7CgogICAgICAgIGlvbmljLkdlc3R1cmVzLnV0aWxzLmV4dGVuZChldiwgewogICAgICAgICAgZGVsdGFUaW1lICAgOiBkZWx0YV90aW1lLAoKICAgICAgICAgIGRlbHRhWCAgICAgIDogZGVsdGFfeCwKICAgICAgICAgIGRlbHRhWSAgICAgIDogZGVsdGFfeSwKCiAgICAgICAgICB2ZWxvY2l0eVggICA6IHZlbG9jaXR5LngsCiAgICAgICAgICB2ZWxvY2l0eVkgICA6IHZlbG9jaXR5LnksCgogICAgICAgICAgZGlzdGFuY2UgICAgOiBpb25pYy5HZXN0dXJlcy51dGlscy5nZXREaXN0YW5jZShzdGFydEV2LmNlbnRlciwgZXYuY2VudGVyKSwKICAgICAgICAgIGFuZ2xlICAgICAgIDogaW9uaWMuR2VzdHVyZXMudXRpbHMuZ2V0QW5nbGUoc3RhcnRFdi5jZW50ZXIsIGV2LmNlbnRlciksCiAgICAgICAgICBkaXJlY3Rpb24gICA6IGlvbmljLkdlc3R1cmVzLnV0aWxzLmdldERpcmVjdGlvbihzdGFydEV2LmNlbnRlciwgZXYuY2VudGVyKSwKCiAgICAgICAgICBzY2FsZSAgICAgICA6IGlvbmljLkdlc3R1cmVzLnV0aWxzLmdldFNjYWxlKHN0YXJ0RXYudG91Y2hlcywgZXYudG91Y2hlcyksCiAgICAgICAgICByb3RhdGlvbiAgICA6IGlvbmljLkdlc3R1cmVzLnV0aWxzLmdldFJvdGF0aW9uKHN0YXJ0RXYudG91Y2hlcywgZXYudG91Y2hlcyksCgogICAgICAgICAgc3RhcnRFdmVudCAgOiBzdGFydEV2CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBldjsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogcmVnaXN0ZXIgbmV3IGdlc3R1cmUKICAgICAgICogQHBhcmFtICAge09iamVjdH0gICAgZ2VzdHVyZSBvYmplY3QsIHNlZSBnZXN0dXJlcy5qcyBmb3IgZG9jdW1lbnRhdGlvbgogICAgICAgKiBAcmV0dXJucyB7QXJyYXl9ICAgICBnZXN0dXJlcwogICAgICAgKi8KICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uIHJlZ2lzdGVyKGdlc3R1cmUpIHsKICAgICAgICAvLyBhZGQgYW4gZW5hYmxlIGdlc3R1cmUgb3B0aW9ucyBpZiB0aGVyZSBpcyBubyBnaXZlbgogICAgICAgIHZhciBvcHRpb25zID0gZ2VzdHVyZS5kZWZhdWx0cyB8fCB7fTsKICAgICAgICBpZihvcHRpb25zW2dlc3R1cmUubmFtZV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgb3B0aW9uc1tnZXN0dXJlLm5hbWVdID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIC8vIGV4dGVuZCBpb25pYy5HZXN0dXJlcyBkZWZhdWx0IG9wdGlvbnMgd2l0aCB0aGUgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZSBvcHRpb25zCiAgICAgICAgaW9uaWMuR2VzdHVyZXMudXRpbHMuZXh0ZW5kKGlvbmljLkdlc3R1cmVzLmRlZmF1bHRzLCBvcHRpb25zLCB0cnVlKTsKCiAgICAgICAgLy8gc2V0IGl0cyBpbmRleAogICAgICAgIGdlc3R1cmUuaW5kZXggPSBnZXN0dXJlLmluZGV4IHx8IDEwMDA7CgogICAgICAgIC8vIGFkZCBpb25pYy5HZXN0dXJlcy5nZXN0dXJlIHRvIHRoZSBsaXN0CiAgICAgICAgdGhpcy5nZXN0dXJlcy5wdXNoKGdlc3R1cmUpOwoKICAgICAgICAvLyBzb3J0IHRoZSBsaXN0IGJ5IGluZGV4CiAgICAgICAgdGhpcy5nZXN0dXJlcy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgIGlmIChhLmluZGV4IDwgYi5pbmRleCkgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYS5pbmRleCA+IGIuaW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2VzdHVyZXM7CiAgICAgIH0KICAgIH07CgoKICAgIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzID0gaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMgfHwge307CgogICAgLyoqCiAgICAgKiBDdXN0b20gZ2VzdHVyZXMKICAgICAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICoKICAgICAqIEdlc3R1cmUgb2JqZWN0CiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICogVGhlIG9iamVjdCBzdHJ1Y3R1cmUgb2YgYSBnZXN0dXJlOgogICAgICoKICAgICAqIHsgbmFtZTogJ215Z2VzdHVyZScsCiAgICogICBpbmRleDogMTMzNywKICAgKiAgIGRlZmF1bHRzOiB7CiAgICogICAgIG15Z2VzdHVyZV9vcHRpb246IHRydWUKICAgKiAgIH0KICAgKiAgIGhhbmRsZXI6IGZ1bmN0aW9uKHR5cGUsIGV2LCBpbnN0KSB7CiAgICogICAgIC8vIHRyaWdnZXIgZ2VzdHVyZSBldmVudAogICAqICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lLCBldik7CiAgICogICB9CiAgICogfQoKICAgICAqIEBwYXJhbSAgIHtTdHJpbmd9ICAgIG5hbWUKICAgICAqIHRoaXMgc2hvdWxkIGJlIHRoZSBuYW1lIG9mIHRoZSBnZXN0dXJlLCBsb3dlcmNhc2UKICAgICAqIGl0IGlzIGFsc28gYmVpbmcgdXNlZCB0byBkaXNhYmxlL2VuYWJsZSB0aGUgZ2VzdHVyZSBwZXIgaW5zdGFuY2UgY29uZmlnLgogICAgICoKICAgICAqIEBwYXJhbSAgIHtOdW1iZXJ9ICAgIFtpbmRleD0xMDAwXQogICAgICogdGhlIGluZGV4IG9mIHRoZSBnZXN0dXJlLCB3aGVyZSBpdCBpcyBnb2luZyB0byBiZSBpbiB0aGUgc3RhY2sgb2YgZ2VzdHVyZXMgZGV0ZWN0aW9uCiAgICAgKiBsaWtlIHdoZW4geW91IGJ1aWxkIGFuIGdlc3R1cmUgdGhhdCBkZXBlbmRzIG9uIHRoZSBkcmFnIGdlc3R1cmUsIGl0IGlzIGEgZ29vZAogICAgICogaWRlYSB0byBwbGFjZSBpdCBhZnRlciB0aGUgaW5kZXggb2YgdGhlIGRyYWcgZ2VzdHVyZS4KICAgICAqCiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICBbZGVmYXVsdHM9e31dCiAgICAgKiB0aGUgZGVmYXVsdCBzZXR0aW5ncyBvZiB0aGUgZ2VzdHVyZS4gdGhlc2UgYXJlIGFkZGVkIHRvIHRoZSBpbnN0YW5jZSBzZXR0aW5ncywKICAgICAqIGFuZCBjYW4gYmUgb3ZlcnJ1bGVkIHBlciBpbnN0YW5jZS4geW91IGNhbiBhbHNvIGFkZCB0aGUgbmFtZSBvZiB0aGUgZ2VzdHVyZSwKICAgICAqIGJ1dCB0aGlzIGlzIGFsc28gYWRkZWQgYnkgZGVmYXVsdCAoYW5kIHNldCB0byB0cnVlKS4KICAgICAqCiAgICAgKiBAcGFyYW0gICB7RnVuY3Rpb259ICBoYW5kbGVyCiAgICAgKiB0aGlzIGhhbmRsZXMgdGhlIGdlc3R1cmUgZGV0ZWN0aW9uIG9mIHlvdXIgY3VzdG9tIGdlc3R1cmUgYW5kIHJlY2VpdmVzIHRoZQogICAgICogZm9sbG93aW5nIGFyZ3VtZW50czoKICAgICAqCiAgICAgKiAgICAgIEBwYXJhbSAge09iamVjdH0gICAgZXZlbnREYXRhCiAgICAgKiAgICAgIGV2ZW50IGRhdGEgY29udGFpbmluZyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgKiAgICAgICAgICB0aW1lU3RhbXAgICB7TnVtYmVyfSAgICAgICAgdGltZSB0aGUgZXZlbnQgb2NjdXJyZWQKICAgICAqICAgICAgICAgIHRhcmdldCAgICAgIHtIVE1MRWxlbWVudH0gICB0YXJnZXQgZWxlbWVudAogICAgICogICAgICAgICAgdG91Y2hlcyAgICAge0FycmF5fSAgICAgICAgIHRvdWNoZXMgKGZpbmdlcnMsIHBvaW50ZXJzLCBtb3VzZSkgb24gdGhlIHNjcmVlbgogICAgICogICAgICAgICAgcG9pbnRlclR5cGUge1N0cmluZ30gICAgICAgIGtpbmQgb2YgcG9pbnRlciB0aGF0IHdhcyB1c2VkLiBtYXRjaGVzIGlvbmljLkdlc3R1cmVzLlBPSU5URVJfTU9VU0V8VE9VQ0gKICAgICAqICAgICAgICAgIGNlbnRlciAgICAgIHtPYmplY3R9ICAgICAgICBjZW50ZXIgcG9zaXRpb24gb2YgdGhlIHRvdWNoZXMuIGNvbnRhaW5zIHBhZ2VYIGFuZCBwYWdlWQogICAgICogICAgICAgICAgZGVsdGFUaW1lICAge051bWJlcn0gICAgICAgIHRoZSB0b3RhbCB0aW1lIG9mIHRoZSB0b3VjaGVzIGluIHRoZSBzY3JlZW4KICAgICAqICAgICAgICAgIGRlbHRhWCAgICAgIHtOdW1iZXJ9ICAgICAgICB0aGUgZGVsdGEgb24geCBheGlzIHdlIGhhdmVkIG1vdmVkCiAgICAgKiAgICAgICAgICBkZWx0YVkgICAgICB7TnVtYmVyfSAgICAgICAgdGhlIGRlbHRhIG9uIHkgYXhpcyB3ZSBoYXZlZCBtb3ZlZAogICAgICogICAgICAgICAgdmVsb2NpdHlYICAge051bWJlcn0gICAgICAgIHRoZSB2ZWxvY2l0eSBvbiB0aGUgeAogICAgICogICAgICAgICAgdmVsb2NpdHlZICAge051bWJlcn0gICAgICAgIHRoZSB2ZWxvY2l0eSBvbiB5CiAgICAgKiAgICAgICAgICBhbmdsZSAgICAgICB7TnVtYmVyfSAgICAgICAgdGhlIGFuZ2xlIHdlIGFyZSBtb3ZpbmcKICAgICAqICAgICAgICAgIGRpcmVjdGlvbiAgIHtTdHJpbmd9ICAgICAgICB0aGUgZGlyZWN0aW9uIHdlIGFyZSBtb3ZpbmcuIG1hdGNoZXMgaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1VQfERPV058TEVGVHxSSUdIVAogICAgICogICAgICAgICAgZGlzdGFuY2UgICAge051bWJlcn0gICAgICAgIHRoZSBkaXN0YW5jZSB3ZSBoYXZlZCBtb3ZlZAogICAgICogICAgICAgICAgc2NhbGUgICAgICAge051bWJlcn0gICAgICAgIHNjYWxpbmcgb2YgdGhlIHRvdWNoZXMsIG5lZWRzIDIgdG91Y2hlcwogICAgICogICAgICAgICAgcm90YXRpb24gICAge051bWJlcn0gICAgICAgIHJvdGF0aW9uIG9mIHRoZSB0b3VjaGVzLCBuZWVkcyAyIHRvdWNoZXMgKgogICAgICogICAgICAgICAgZXZlbnRUeXBlICAge1N0cmluZ30gICAgICAgIG1hdGNoZXMgaW9uaWMuR2VzdHVyZXMuRVZFTlRfU1RBUlR8TU9WRXxFTkQKICAgICAqICAgICAgICAgIHNyY0V2ZW50ICAgIHtPYmplY3R9ICAgICAgICB0aGUgc291cmNlIGV2ZW50LCBsaWtlIFRvdWNoU3RhcnQgb3IgTW91c2VEb3duICoKICAgICAqICAgICAgICAgIHN0YXJ0RXZlbnQgIHtPYmplY3R9ICAgICAgICBjb250YWlucyB0aGUgc2FtZSBwcm9wZXJ0aWVzIGFzIGFib3ZlLAogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dCBmcm9tIHRoZSBmaXJzdCB0b3VjaC4gdGhpcyBpcyB1c2VkIHRvIGNhbGN1bGF0ZQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc3RhbmNlcywgZGVsdGFUaW1lLCBzY2FsaW5nIGV0YwogICAgICoKICAgICAqICAgICAgQHBhcmFtICB7aW9uaWMuR2VzdHVyZXMuSW5zdGFuY2V9ICAgIGluc3QKICAgICAqICAgICAgdGhlIGluc3RhbmNlIHdlIGFyZSBkb2luZyB0aGUgZGV0ZWN0aW9uIGZvci4geW91IGNhbiBnZXQgdGhlIG9wdGlvbnMgZnJvbQogICAgICogICAgICB0aGUgaW5zdC5vcHRpb25zIG9iamVjdCBhbmQgdHJpZ2dlciB0aGUgZ2VzdHVyZSBldmVudCBieSBjYWxsaW5nIGluc3QudHJpZ2dlcgogICAgICoKICAgICAqCiAgICAgKiBIYW5kbGUgZ2VzdHVyZXMKICAgICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiBpbnNpZGUgdGhlIGhhbmRsZXIgeW91IGNhbiBnZXQvc2V0IGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbmljLmN1cnJlbnQuIFRoaXMgaXMgdGhlIGN1cnJlbnQKICAgICAqIGRldGVjdGlvbiBzZXNzaW9uaWMuIEl0IGhhcyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXMKICAgICAqICAgICAgQHBhcmFtICB7U3RyaW5nfSAgICBuYW1lCiAgICAgKiAgICAgIGNvbnRhaW5zIHRoZSBuYW1lIG9mIHRoZSBnZXN0dXJlIHdlIGhhdmUgZGV0ZWN0ZWQuIGl0IGhhcyBub3QgYSByZWFsIGZ1bmN0aW9uLAogICAgICogICAgICBvbmx5IHRvIGNoZWNrIGluIG90aGVyIGdlc3R1cmVzIGlmIHNvbWV0aGluZyBpcyBkZXRlY3RlZC4KICAgICAqICAgICAgbGlrZSBpbiB0aGUgZHJhZyBnZXN0dXJlIHdlIHNldCBpdCB0byAnZHJhZycgYW5kIGluIHRoZSBzd2lwZSBnZXN0dXJlIHdlIGNhbgogICAgICogICAgICBjaGVjayBpZiB0aGUgY3VycmVudCBnZXN0dXJlIGlzICdkcmFnJyBieSBhY2Nlc3NpbmcgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uaWMuY3VycmVudC5uYW1lCiAgICAgKgogICAgICogICAgICByZWFkb25seQogICAgICogICAgICBAcGFyYW0gIHtpb25pYy5HZXN0dXJlcy5JbnN0YW5jZX0gICAgaW5zdAogICAgICogICAgICB0aGUgaW5zdGFuY2Ugd2UgZG8gdGhlIGRldGVjdGlvbiBmb3IKICAgICAqCiAgICAgKiAgICAgIHJlYWRvbmx5CiAgICAgKiAgICAgIEBwYXJhbSAge09iamVjdH0gICAgc3RhcnRFdmVudAogICAgICogICAgICBjb250YWlucyB0aGUgcHJvcGVydGllcyBvZiB0aGUgZmlyc3QgZ2VzdHVyZSBkZXRlY3Rpb24gaW4gdGhpcyBzZXNzaW9uaWMuCiAgICAgKiAgICAgIFVzZWQgZm9yIGNhbGN1bGF0aW9ucyBhYm91dCB0aW1pbmcsIGRpc3RhbmNlLCBldGMuCiAgICAgKgogICAgICogICAgICByZWFkb25seQogICAgICogICAgICBAcGFyYW0gIHtPYmplY3R9ICAgIGxhc3RFdmVudAogICAgICogICAgICBjb250YWlucyBhbGwgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGxhc3QgZ2VzdHVyZSBkZXRlY3QgaW4gdGhpcyBzZXNzaW9uaWMuCiAgICAgKgogICAgICogYWZ0ZXIgdGhlIGdlc3R1cmUgZGV0ZWN0aW9uIHNlc3Npb24gaGFzIGJlZW4gY29tcGxldGVkICh1c2VyIGhhcyByZWxlYXNlZCB0aGUgc2NyZWVuKQogICAgICogdGhlIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbmljLmN1cnJlbnQgb2JqZWN0IGlzIGNvcGllZCBpbnRvIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbmljLnByZXZpb3VzLAogICAgICogdGhpcyBpcyB1c2VmdWxsIGZvciBnZXN0dXJlcyBsaWtlIGRvdWJsZXRhcCwgd2hlcmUgeW91IG5lZWQgdG8ga25vdyBpZiB0aGUKICAgICAqIHByZXZpb3VzIGdlc3R1cmUgd2FzIGEgdGFwCiAgICAgKgogICAgICogb3B0aW9ucyB0aGF0IGhhdmUgYmVlbiBzZXQgYnkgdGhlIGluc3RhbmNlIGNhbiBiZSByZWNlaXZlZCBieSBjYWxsaW5nIGluc3Qub3B0aW9ucwogICAgICoKICAgICAqIFlvdSBjYW4gdHJpZ2dlciBhIGdlc3R1cmUgZXZlbnQgYnkgY2FsbGluZyBpbnN0LnRyaWdnZXIoIm15Z2VzdHVyZSIsIGV2ZW50KS4KICAgICAqIFRoZSBmaXJzdCBwYXJhbSBpcyB0aGUgbmFtZSBvZiB5b3VyIGdlc3R1cmUsIHRoZSBzZWNvbmQgdGhlIGV2ZW50IGFyZ3VtZW50CiAgICAgKgogICAgICoKICAgICAqIFJlZ2lzdGVyIGdlc3R1cmVzCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICogV2hlbiBhbiBnZXN0dXJlIGlzIGFkZGVkIHRvIHRoZSBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcyBvYmplY3QsIGl0IGlzIGF1dG8gcmVnaXN0ZXJlZAogICAgICogYXQgdGhlIHNldHVwIG9mIHRoZSBmaXJzdCBpb25pYy5HZXN0dXJlcyBpbnN0YW5jZS4gWW91IGNhbiBhbHNvIGNhbGwgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uaWMucmVnaXN0ZXIKICAgICAqIG1hbnVhbGx5IGFuZCBwYXNzIHlvdXIgZ2VzdHVyZSBvYmplY3QgYXMgYSBwYXJhbQogICAgICoKICAgICAqLwoKICAgIC8qKgogICAgICogSG9sZAogICAgICogVG91Y2ggc3RheXMgYXQgdGhlIHNhbWUgcGxhY2UgZm9yIHggdGltZQogICAgICogZXZlbnRzICBob2xkCiAgICAgKi8KICAgIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzLkhvbGQgPSB7CiAgICAgIG5hbWU6ICdob2xkJywKICAgICAgaW5kZXg6IDEwLAogICAgICBkZWZhdWx0czogewogICAgICAgIGhvbGRfdGltZW91dAk6IDUwMCwKICAgICAgICBob2xkX3RocmVzaG9sZAk6IDEKICAgICAgfSwKICAgICAgdGltZXI6IG51bGwsCiAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIGhvbGRHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgc3dpdGNoKGV2LmV2ZW50VHlwZSkgewogICAgICAgICAgY2FzZSBpb25pYy5HZXN0dXJlcy5FVkVOVF9TVEFSVDoKICAgICAgICAgICAgLy8gY2xlYXIgYW55IHJ1bm5pbmcgdGltZXJzCiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCiAgICAgICAgICAgIC8vIHNldCB0aGUgZ2VzdHVyZSBzbyB3ZSBjYW4gY2hlY2sgaW4gdGhlIHRpbWVvdXQgaWYgaXQgc3RpbGwgaXMKICAgICAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSA9IHRoaXMubmFtZTsKCiAgICAgICAgICAgIC8vIHNldCB0aW1lciBhbmQgaWYgYWZ0ZXIgdGhlIHRpbWVvdXQgaXQgc3RpbGwgaXMgaG9sZCwKICAgICAgICAgICAgLy8gd2UgdHJpZ2dlciB0aGUgaG9sZCBldmVudAogICAgICAgICAgICB0aGlzLnRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZihpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uY3VycmVudC5uYW1lID09ICdob2xkJykgewogICAgICAgICAgICAgICAgaW9uaWMudGFwLmNhbmNlbENsaWNrKCk7CiAgICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ2hvbGQnLCBldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBpbnN0Lm9wdGlvbnMuaG9sZF90aW1lb3V0KTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgLy8gd2hlbiB5b3UgbW92ZSBvciBlbmQgd2UgY2xlYXIgdGhlIHRpbWVyCiAgICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX01PVkU6CiAgICAgICAgICAgIGlmKGV2LmRpc3RhbmNlID4gaW5zdC5vcHRpb25zLmhvbGRfdGhyZXNob2xkKSB7CiAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfRU5EOgogICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lcik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCgogICAgLyoqCiAgICAgKiBUYXAvRG91YmxlVGFwCiAgICAgKiBRdWljayB0b3VjaCBhdCBhIHBsYWNlIG9yIGRvdWJsZSBhdCB0aGUgc2FtZSBwbGFjZQogICAgICogZXZlbnRzICB0YXAsIGRvdWJsZXRhcAogICAgICovCiAgICBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcy5UYXAgPSB7CiAgICAgIG5hbWU6ICd0YXAnLAogICAgICBpbmRleDogMTAwLAogICAgICBkZWZhdWx0czogewogICAgICAgIHRhcF9tYXhfdG91Y2h0aW1lCTogMjUwLAogICAgICAgIHRhcF9tYXhfZGlzdGFuY2UJOiAxMCwKICAgICAgICB0YXBfYWx3YXlzCQkJOiB0cnVlLAogICAgICAgIGRvdWJsZXRhcF9kaXN0YW5jZQk6IDIwLAogICAgICAgIGRvdWJsZXRhcF9pbnRlcnZhbAk6IDMwMAogICAgICB9LAogICAgICBoYW5kbGVyOiBmdW5jdGlvbiB0YXBHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgaWYoZXYuZXZlbnRUeXBlID09IGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORCAmJiBldi5zcmNFdmVudC50eXBlICE9ICd0b3VjaGNhbmNlbCcpIHsKICAgICAgICAgIC8vIHByZXZpb3VzIGdlc3R1cmUsIGZvciB0aGUgZG91YmxlIHRhcCBzaW5jZSB0aGVzZSBhcmUgdHdvIGRpZmZlcmVudCBnZXN0dXJlIGRldGVjdGlvbnMKICAgICAgICAgIHZhciBwcmV2ID0gaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLnByZXZpb3VzLAogICAgICAgICAgICBkaWRfZG91YmxldGFwID0gZmFsc2U7CgogICAgICAgICAgLy8gd2hlbiB0aGUgdG91Y2h0aW1lIGlzIGhpZ2hlciB0aGVuIHRoZSBtYXggdG91Y2ggdGltZQogICAgICAgICAgLy8gb3Igd2hlbiB0aGUgbW92aW5nIGRpc3RhbmNlIGlzIHRvbyBtdWNoCiAgICAgICAgICBpZihldi5kZWx0YVRpbWUgPiBpbnN0Lm9wdGlvbnMudGFwX21heF90b3VjaHRpbWUgfHwKICAgICAgICAgICAgZXYuZGlzdGFuY2UgPiBpbnN0Lm9wdGlvbnMudGFwX21heF9kaXN0YW5jZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgLy8gY2hlY2sgaWYgZG91YmxlIHRhcAogICAgICAgICAgaWYocHJldiAmJiBwcmV2Lm5hbWUgPT0gJ3RhcCcgJiYKICAgICAgICAgICAgKGV2LnRpbWVTdGFtcCAtIHByZXYubGFzdEV2ZW50LnRpbWVTdGFtcCkgPCBpbnN0Lm9wdGlvbnMuZG91YmxldGFwX2ludGVydmFsICYmCiAgICAgICAgICAgIGV2LmRpc3RhbmNlIDwgaW5zdC5vcHRpb25zLmRvdWJsZXRhcF9kaXN0YW5jZSkgewogICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ2RvdWJsZXRhcCcsIGV2KTsKICAgICAgICAgICAgZGlkX2RvdWJsZXRhcCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gZG8gYSBzaW5nbGUgdGFwCiAgICAgICAgICBpZighZGlkX2RvdWJsZXRhcCB8fCBpbnN0Lm9wdGlvbnMudGFwX2Fsd2F5cykgewogICAgICAgICAgICBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uY3VycmVudC5uYW1lID0gJ3RhcCc7CiAgICAgICAgICAgIGluc3QudHJpZ2dlcigndGFwJywgZXYpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKCgogICAgLyoqCiAgICAgKiBTd2lwZQogICAgICogdHJpZ2dlcnMgc3dpcGUgZXZlbnRzIHdoZW4gdGhlIGVuZCB2ZWxvY2l0eSBpcyBhYm92ZSB0aGUgdGhyZXNob2xkCiAgICAgKiBldmVudHMgIHN3aXBlLCBzd2lwZWxlZnQsIHN3aXBlcmlnaHQsIHN3aXBldXAsIHN3aXBlZG93bgogICAgICovCiAgICBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcy5Td2lwZSA9IHsKICAgICAgbmFtZTogJ3N3aXBlJywKICAgICAgaW5kZXg6IDQwLAogICAgICBkZWZhdWx0czogewogICAgICAgIC8vIHNldCAwIGZvciB1bmxpbWl0ZWQsIGJ1dCB0aGlzIGNhbiBjb25mbGljdCB3aXRoIHRyYW5zZm9ybQogICAgICAgIHN3aXBlX21heF90b3VjaGVzICA6IDEsCiAgICAgICAgc3dpcGVfdmVsb2NpdHkgICAgIDogMC43CiAgICAgIH0sCiAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIHN3aXBlR2VzdHVyZShldiwgaW5zdCkgewogICAgICAgIGlmKGV2LmV2ZW50VHlwZSA9PSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQpIHsKICAgICAgICAgIC8vIG1heCB0b3VjaGVzCiAgICAgICAgICBpZihpbnN0Lm9wdGlvbnMuc3dpcGVfbWF4X3RvdWNoZXMgPiAwICYmCiAgICAgICAgICAgIGV2LnRvdWNoZXMubGVuZ3RoID4gaW5zdC5vcHRpb25zLnN3aXBlX21heF90b3VjaGVzKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyB3aGVuIHRoZSBkaXN0YW5jZSB3ZSBtb3ZlZCBpcyB0b28gc21hbGwgd2Ugc2tpcCB0aGlzIGdlc3R1cmUKICAgICAgICAgIC8vIG9yIHdlIGNhbiBiZSBhbHJlYWR5IGluIGRyYWdnaW5nCiAgICAgICAgICBpZihldi52ZWxvY2l0eVggPiBpbnN0Lm9wdGlvbnMuc3dpcGVfdmVsb2NpdHkgfHwKICAgICAgICAgICAgZXYudmVsb2NpdHlZID4gaW5zdC5vcHRpb25zLnN3aXBlX3ZlbG9jaXR5KSB7CiAgICAgICAgICAgIC8vIHRyaWdnZXIgc3dpcGUgZXZlbnRzCiAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUsIGV2KTsKICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArIGV2LmRpcmVjdGlvbiwgZXYpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKCgogICAgLyoqCiAgICAgKiBEcmFnCiAgICAgKiBNb3ZlIHdpdGggeCBmaW5nZXJzIChkZWZhdWx0IDEpIGFyb3VuZCBvbiB0aGUgcGFnZS4gQmxvY2tpbmcgdGhlIHNjcm9sbGluZyB3aGVuCiAgICAgKiBtb3ZpbmcgbGVmdCBhbmQgcmlnaHQgaXMgYSBnb29kIHByYWN0aWNlLiBXaGVuIGFsbCB0aGUgZHJhZyBldmVudHMgYXJlIGJsb2NraW5nCiAgICAgKiB5b3UgZGlzYWJsZSBzY3JvbGxpbmcgb24gdGhhdCBhcmVhLgogICAgICogZXZlbnRzICBkcmFnLCBkcmFwbGVmdCwgZHJhZ3JpZ2h0LCBkcmFndXAsIGRyYWdkb3duCiAgICAgKi8KICAgIGlvbmljLkdlc3R1cmVzLmdlc3R1cmVzLkRyYWcgPSB7CiAgICAgIG5hbWU6ICdkcmFnJywKICAgICAgaW5kZXg6IDUwLAogICAgICBkZWZhdWx0czogewogICAgICAgIGRyYWdfbWluX2Rpc3RhbmNlIDogMTAsCiAgICAgICAgLy8gU2V0IGNvcnJlY3RfZm9yX2RyYWdfbWluX2Rpc3RhbmNlIHRvIHRydWUgdG8gbWFrZSB0aGUgc3RhcnRpbmcgcG9pbnQgb2YgdGhlIGRyYWcKICAgICAgICAvLyBiZSBjYWxjdWxhdGVkIGZyb20gd2hlcmUgdGhlIGRyYWcgd2FzIHRyaWdnZXJlZCwgbm90IGZyb20gd2hlcmUgdGhlIHRvdWNoIHN0YXJ0ZWQuCiAgICAgICAgLy8gVXNlZnVsIHRvIGF2b2lkIGEgamVyay1zdGFydGluZyBkcmFnLCB3aGljaCBjYW4gbWFrZSBmaW5lLWFkanVzdG1lbnRzCiAgICAgICAgLy8gdGhyb3VnaCBkcmFnZ2luZyBkaWZmaWN1bHQsIGFuZCBiZSB2aXN1YWxseSB1bmFwcGVhbGluZy4KICAgICAgICBjb3JyZWN0X2Zvcl9kcmFnX21pbl9kaXN0YW5jZSA6IHRydWUsCiAgICAgICAgLy8gc2V0IDAgZm9yIHVubGltaXRlZCwgYnV0IHRoaXMgY2FuIGNvbmZsaWN0IHdpdGggdHJhbnNmb3JtCiAgICAgICAgZHJhZ19tYXhfdG91Y2hlcyAgOiAxLAogICAgICAgIC8vIHByZXZlbnQgZGVmYXVsdCBicm93c2VyIGJlaGF2aW9yIHdoZW4gZHJhZ2dpbmcgb2NjdXJzCiAgICAgICAgLy8gYmUgY2FyZWZ1bCB3aXRoIGl0LCBpdCBtYWtlcyB0aGUgZWxlbWVudCBhIGJsb2NraW5nIGVsZW1lbnQKICAgICAgICAvLyB3aGVuIHlvdSBhcmUgdXNpbmcgdGhlIGRyYWcgZ2VzdHVyZSwgaXQgaXMgYSBnb29kIHByYWN0aWNlIHRvIHNldCB0aGlzIHRydWUKICAgICAgICBkcmFnX2Jsb2NrX2hvcml6b250YWwgICA6IHRydWUsCiAgICAgICAgZHJhZ19ibG9ja192ZXJ0aWNhbCAgICAgOiB0cnVlLAogICAgICAgIC8vIGRyYWdfbG9ja190b19heGlzIGtlZXBzIHRoZSBkcmFnIGdlc3R1cmUgb24gdGhlIGF4aXMgdGhhdCBpdCBzdGFydGVkIG9uLAogICAgICAgIC8vIEl0IGRpc2FsbG93cyB2ZXJ0aWNhbCBkaXJlY3Rpb25zIGlmIHRoZSBpbml0aWFsIGRpcmVjdGlvbiB3YXMgaG9yaXpvbnRhbCwgYW5kIHZpY2UgdmVyc2EuCiAgICAgICAgZHJhZ19sb2NrX3RvX2F4aXMgICAgICAgOiBmYWxzZSwKICAgICAgICAvLyBkcmFnIGxvY2sgb25seSBraWNrcyBpbiB3aGVuIGRpc3RhbmNlID4gZHJhZ19sb2NrX21pbl9kaXN0YW5jZQogICAgICAgIC8vIFRoaXMgd2F5LCBsb2NraW5nIG9jY3VycyBvbmx5IHdoZW4gdGhlIGRpc3RhbmNlIGhhcyBiZWNvbWUgbGFyZ2UgZW5vdWdoIHRvIHJlbGlhYmx5IGRldGVybWluZSB0aGUgZGlyZWN0aW9uCiAgICAgICAgZHJhZ19sb2NrX21pbl9kaXN0YW5jZSA6IDI1CiAgICAgIH0sCiAgICAgIHRyaWdnZXJlZDogZmFsc2UsCiAgICAgIGhhbmRsZXI6IGZ1bmN0aW9uIGRyYWdHZXN0dXJlKGV2LCBpbnN0KSB7CiAgICAgICAgLy8gY3VycmVudCBnZXN0dXJlIGlzbnQgZHJhZywgYnV0IGRyYWdnZWQgaXMgdHJ1ZQogICAgICAgIC8vIHRoaXMgbWVhbnMgYW4gb3RoZXIgZ2VzdHVyZSBpcyBidXN5LiBub3cgY2FsbCBkcmFnZW5kCiAgICAgICAgaWYoaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSAhPSB0aGlzLm5hbWUgJiYgdGhpcy50cmlnZ2VyZWQpIHsKICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKydlbmQnLCBldik7CiAgICAgICAgICB0aGlzLnRyaWdnZXJlZCA9IGZhbHNlOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gbWF4IHRvdWNoZXMKICAgICAgICBpZihpbnN0Lm9wdGlvbnMuZHJhZ19tYXhfdG91Y2hlcyA+IDAgJiYKICAgICAgICAgIGV2LnRvdWNoZXMubGVuZ3RoID4gaW5zdC5vcHRpb25zLmRyYWdfbWF4X3RvdWNoZXMpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHN3aXRjaChldi5ldmVudFR5cGUpIHsKICAgICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfU1RBUlQ6CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRToKICAgICAgICAgICAgLy8gd2hlbiB0aGUgZGlzdGFuY2Ugd2UgbW92ZWQgaXMgdG9vIHNtYWxsIHdlIHNraXAgdGhpcyBnZXN0dXJlCiAgICAgICAgICAgIC8vIG9yIHdlIGNhbiBiZSBhbHJlYWR5IGluIGRyYWdnaW5nCiAgICAgICAgICAgIGlmKGV2LmRpc3RhbmNlIDwgaW5zdC5vcHRpb25zLmRyYWdfbWluX2Rpc3RhbmNlICYmCiAgICAgICAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSAhPSB0aGlzLm5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHdlIGFyZSBkcmFnZ2luZyEKICAgICAgICAgICAgaWYoaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQubmFtZSAhPSB0aGlzLm5hbWUpIHsKICAgICAgICAgICAgICBpb25pYy5HZXN0dXJlcy5kZXRlY3Rpb24uY3VycmVudC5uYW1lID0gdGhpcy5uYW1lOwogICAgICAgICAgICAgIGlmIChpbnN0Lm9wdGlvbnMuY29ycmVjdF9mb3JfZHJhZ19taW5fZGlzdGFuY2UpIHsKICAgICAgICAgICAgICAgIC8vIFdoZW4gYSBkcmFnIGlzIHRyaWdnZXJlZCwgc2V0IHRoZSBldmVudCBjZW50ZXIgdG8gZHJhZ19taW5fZGlzdGFuY2UgcGl4ZWxzIGZyb20gdGhlIG9yaWdpbmFsIGV2ZW50IGNlbnRlci4KICAgICAgICAgICAgICAgIC8vIFdpdGhvdXQgdGhpcyBjb3JyZWN0aW9uLCB0aGUgZHJhZ2dlZCBkaXN0YW5jZSB3b3VsZCBqdW1wc3RhcnQgYXQgZHJhZ19taW5fZGlzdGFuY2UgcGl4ZWxzIGluc3RlYWQgb2YgYXQgMC4KICAgICAgICAgICAgICAgIC8vIEl0IG1pZ2h0IGJlIHVzZWZ1bCB0byBzYXZlIHRoZSBvcmlnaW5hbCBzdGFydCBwb2ludCBzb21ld2hlcmUKICAgICAgICAgICAgICAgIHZhciBmYWN0b3IgPSBNYXRoLmFicyhpbnN0Lm9wdGlvbnMuZHJhZ19taW5fZGlzdGFuY2UvZXYuZGlzdGFuY2UpOwogICAgICAgICAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQuc3RhcnRFdmVudC5jZW50ZXIucGFnZVggKz0gZXYuZGVsdGFYICogZmFjdG9yOwogICAgICAgICAgICAgICAgaW9uaWMuR2VzdHVyZXMuZGV0ZWN0aW9uLmN1cnJlbnQuc3RhcnRFdmVudC5jZW50ZXIucGFnZVkgKz0gZXYuZGVsdGFZICogZmFjdG9yOwoKICAgICAgICAgICAgICAgIC8vIHJlY2FsY3VsYXRlIGV2ZW50IGRhdGEgdXNpbmcgbmV3IHN0YXJ0IHBvaW50CiAgICAgICAgICAgICAgICBldiA9IGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5leHRlbmRFdmVudERhdGEoZXYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gbG9jayBkcmFnIHRvIGF4aXM/CiAgICAgICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lmxhc3RFdmVudC5kcmFnX2xvY2tlZF90b19heGlzIHx8IChpbnN0Lm9wdGlvbnMuZHJhZ19sb2NrX3RvX2F4aXMgJiYgaW5zdC5vcHRpb25zLmRyYWdfbG9ja19taW5fZGlzdGFuY2U8PWV2LmRpc3RhbmNlKSkgewogICAgICAgICAgICAgIGV2LmRyYWdfbG9ja2VkX3RvX2F4aXMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBsYXN0X2RpcmVjdGlvbiA9IGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lmxhc3RFdmVudC5kaXJlY3Rpb247CiAgICAgICAgICAgIGlmKGV2LmRyYWdfbG9ja2VkX3RvX2F4aXMgJiYgbGFzdF9kaXJlY3Rpb24gIT09IGV2LmRpcmVjdGlvbikgewogICAgICAgICAgICAgIC8vIGtlZXAgZGlyZWN0aW9uIG9uIHRoZSBheGlzIHRoYXQgdGhlIGRyYWcgZ2VzdHVyZSBzdGFydGVkIG9uCiAgICAgICAgICAgICAgaWYoaW9uaWMuR2VzdHVyZXMudXRpbHMuaXNWZXJ0aWNhbChsYXN0X2RpcmVjdGlvbikpIHsKICAgICAgICAgICAgICAgIGV2LmRpcmVjdGlvbiA9IChldi5kZWx0YVkgPCAwKSA/IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9VUCA6IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9ET1dOOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGV2LmRpcmVjdGlvbiA9IChldi5kZWx0YVggPCAwKSA/IGlvbmljLkdlc3R1cmVzLkRJUkVDVElPTl9MRUZUIDogaW9uaWMuR2VzdHVyZXMuRElSRUNUSU9OX1JJR0hUOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZmlyc3QgdGltZSwgdHJpZ2dlciBkcmFnc3RhcnQgZXZlbnQKICAgICAgICAgICAgaWYoIXRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArJ3N0YXJ0JywgZXYpOwogICAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gdHJpZ2dlciBub3JtYWwgZXZlbnQKICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOwoKICAgICAgICAgICAgLy8gZGlyZWN0aW9uIGV2ZW50LCBsaWtlIGRyYWdkb3duCiAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKyBldi5kaXJlY3Rpb24sIGV2KTsKCiAgICAgICAgICAgIC8vIGJsb2NrIHRoZSBicm93c2VyIGV2ZW50cwogICAgICAgICAgICBpZiggKGluc3Qub3B0aW9ucy5kcmFnX2Jsb2NrX3ZlcnRpY2FsICYmIGlvbmljLkdlc3R1cmVzLnV0aWxzLmlzVmVydGljYWwoZXYuZGlyZWN0aW9uKSkgfHwKICAgICAgICAgICAgICAoaW5zdC5vcHRpb25zLmRyYWdfYmxvY2tfaG9yaXpvbnRhbCAmJiAhaW9uaWMuR2VzdHVyZXMudXRpbHMuaXNWZXJ0aWNhbChldi5kaXJlY3Rpb24pKSkgewogICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSBpb25pYy5HZXN0dXJlcy5FVkVOVF9FTkQ6CiAgICAgICAgICAgIC8vIHRyaWdnZXIgZHJhZ2VuZAogICAgICAgICAgICBpZih0aGlzLnRyaWdnZXJlZCkgewogICAgICAgICAgICAgIGluc3QudHJpZ2dlcih0aGlzLm5hbWUgKydlbmQnLCBldik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCgogICAgLyoqCiAgICAgKiBUcmFuc2Zvcm0KICAgICAqIFVzZXIgd2FudCB0byBzY2FsZSBvciByb3RhdGUgd2l0aCAyIGZpbmdlcnMKICAgICAqIGV2ZW50cyAgdHJhbnNmb3JtLCBwaW5jaCwgcGluY2hpbiwgcGluY2hvdXQsIHJvdGF0ZQogICAgICovCiAgICBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcy5UcmFuc2Zvcm0gPSB7CiAgICAgIG5hbWU6ICd0cmFuc2Zvcm0nLAogICAgICBpbmRleDogNDUsCiAgICAgIGRlZmF1bHRzOiB7CiAgICAgICAgLy8gZmFjdG9yLCBubyBzY2FsZSBpcyAxLCB6b29taW4gaXMgdG8gMCBhbmQgem9vbW91dCB1bnRpbCBoaWdoZXIgdGhlbiAxCiAgICAgICAgdHJhbnNmb3JtX21pbl9zY2FsZSAgICAgOiAwLjAxLAogICAgICAgIC8vIHJvdGF0aW9uIGluIGRlZ3JlZXMKICAgICAgICB0cmFuc2Zvcm1fbWluX3JvdGF0aW9uICA6IDEsCiAgICAgICAgLy8gcHJldmVudCBkZWZhdWx0IGJyb3dzZXIgYmVoYXZpb3Igd2hlbiB0d28gdG91Y2hlcyBhcmUgb24gdGhlIHNjcmVlbgogICAgICAgIC8vIGJ1dCBpdCBtYWtlcyB0aGUgZWxlbWVudCBhIGJsb2NraW5nIGVsZW1lbnQKICAgICAgICAvLyB3aGVuIHlvdSBhcmUgdXNpbmcgdGhlIHRyYW5zZm9ybSBnZXN0dXJlLCBpdCBpcyBhIGdvb2QgcHJhY3RpY2UgdG8gc2V0IHRoaXMgdHJ1ZQogICAgICAgIHRyYW5zZm9ybV9hbHdheXNfYmxvY2sgIDogZmFsc2UKICAgICAgfSwKICAgICAgdHJpZ2dlcmVkOiBmYWxzZSwKICAgICAgaGFuZGxlcjogZnVuY3Rpb24gdHJhbnNmb3JtR2VzdHVyZShldiwgaW5zdCkgewogICAgICAgIC8vIGN1cnJlbnQgZ2VzdHVyZSBpc250IGRyYWcsIGJ1dCBkcmFnZ2VkIGlzIHRydWUKICAgICAgICAvLyB0aGlzIG1lYW5zIGFuIG90aGVyIGdlc3R1cmUgaXMgYnVzeS4gbm93IGNhbGwgZHJhZ2VuZAogICAgICAgIGlmKGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgIT0gdGhpcy5uYW1lICYmIHRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnZW5kJywgZXYpOwogICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIGF0bGVhc3QgbXVsdGl0b3VjaAogICAgICAgIGlmKGV2LnRvdWNoZXMubGVuZ3RoIDwgMikgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gcHJldmVudCBkZWZhdWx0IHdoZW4gdHdvIGZpbmdlcnMgYXJlIG9uIHRoZSBzY3JlZW4KICAgICAgICBpZihpbnN0Lm9wdGlvbnMudHJhbnNmb3JtX2Fsd2F5c19ibG9jaykgewogICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CgogICAgICAgIHN3aXRjaChldi5ldmVudFR5cGUpIHsKICAgICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfU1RBUlQ6CiAgICAgICAgICAgIHRoaXMudHJpZ2dlcmVkID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgaW9uaWMuR2VzdHVyZXMuRVZFTlRfTU9WRToKICAgICAgICAgICAgdmFyIHNjYWxlX3RocmVzaG9sZCA9IE1hdGguYWJzKDEtZXYuc2NhbGUpOwogICAgICAgICAgICB2YXIgcm90YXRpb25fdGhyZXNob2xkID0gTWF0aC5hYnMoZXYucm90YXRpb24pOwoKICAgICAgICAgICAgLy8gd2hlbiB0aGUgZGlzdGFuY2Ugd2UgbW92ZWQgaXMgdG9vIHNtYWxsIHdlIHNraXAgdGhpcyBnZXN0dXJlCiAgICAgICAgICAgIC8vIG9yIHdlIGNhbiBiZSBhbHJlYWR5IGluIGRyYWdnaW5nCiAgICAgICAgICAgIGlmKHNjYWxlX3RocmVzaG9sZCA8IGluc3Qub3B0aW9ucy50cmFuc2Zvcm1fbWluX3NjYWxlICYmCiAgICAgICAgICAgICAgcm90YXRpb25fdGhyZXNob2xkIDwgaW5zdC5vcHRpb25zLnRyYW5zZm9ybV9taW5fcm90YXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHdlIGFyZSB0cmFuc2Zvcm1pbmchCiAgICAgICAgICAgIGlvbmljLkdlc3R1cmVzLmRldGVjdGlvbi5jdXJyZW50Lm5hbWUgPSB0aGlzLm5hbWU7CgogICAgICAgICAgICAvLyBmaXJzdCB0aW1lLCB0cmlnZ2VyIGRyYWdzdGFydCBldmVudAogICAgICAgICAgICBpZighdGhpcy50cmlnZ2VyZWQpIHsKICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lICsnc3RhcnQnLCBldik7CiAgICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpbnN0LnRyaWdnZXIodGhpcy5uYW1lLCBldik7IC8vIGJhc2ljIHRyYW5zZm9ybSBldmVudAoKICAgICAgICAgICAgLy8gdHJpZ2dlciByb3RhdGUgZXZlbnQKICAgICAgICAgICAgaWYocm90YXRpb25fdGhyZXNob2xkID4gaW5zdC5vcHRpb25zLnRyYW5zZm9ybV9taW5fcm90YXRpb24pIHsKICAgICAgICAgICAgICBpbnN0LnRyaWdnZXIoJ3JvdGF0ZScsIGV2KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gdHJpZ2dlciBwaW5jaCBldmVudAogICAgICAgICAgICBpZihzY2FsZV90aHJlc2hvbGQgPiBpbnN0Lm9wdGlvbnMudHJhbnNmb3JtX21pbl9zY2FsZSkgewogICAgICAgICAgICAgIGluc3QudHJpZ2dlcigncGluY2gnLCBldik7CiAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKCdwaW5jaCcrICgoZXYuc2NhbGUgPCAxKSA/ICdpbicgOiAnb3V0JyksIGV2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORDoKICAgICAgICAgICAgLy8gdHJpZ2dlciBkcmFnZW5kCiAgICAgICAgICAgIGlmKHRoaXMudHJpZ2dlcmVkKSB7CiAgICAgICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSArJ2VuZCcsIGV2KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy50cmlnZ2VyZWQgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKCiAgICAvKioKICAgICAqIFRvdWNoCiAgICAgKiBDYWxsZWQgYXMgZmlyc3QsIHRlbGxzIHRoZSB1c2VyIGhhcyB0b3VjaGVkIHRoZSBzY3JlZW4KICAgICAqIGV2ZW50cyAgdG91Y2gKICAgICAqLwogICAgaW9uaWMuR2VzdHVyZXMuZ2VzdHVyZXMuVG91Y2ggPSB7CiAgICAgIG5hbWU6ICd0b3VjaCcsCiAgICAgIGluZGV4OiAtSW5maW5pdHksCiAgICAgIGRlZmF1bHRzOiB7CiAgICAgICAgLy8gY2FsbCBwcmV2ZW50RGVmYXVsdCBhdCB0b3VjaHN0YXJ0LCBhbmQgbWFrZXMgdGhlIGVsZW1lbnQgYmxvY2tpbmcgYnkKICAgICAgICAvLyBkaXNhYmxpbmcgdGhlIHNjcm9sbGluZyBvZiB0aGUgcGFnZSwgYnV0IGl0IGltcHJvdmVzIGdlc3R1cmVzIGxpa2UKICAgICAgICAvLyB0cmFuc2Zvcm1pbmcgYW5kIGRyYWdnaW5nLgogICAgICAgIC8vIGJlIGNhcmVmdWwgd2l0aCB1c2luZyB0aGlzLCBpdCBjYW4gYmUgdmVyeSBhbm5veWluZyBmb3IgdXNlcnMgdG8gYmUgc3R1Y2sKICAgICAgICAvLyBvbiB0aGUgcGFnZQogICAgICAgIHByZXZlbnRfZGVmYXVsdDogZmFsc2UsCgogICAgICAgIC8vIGRpc2FibGUgbW91c2UgZXZlbnRzLCBzbyBvbmx5IHRvdWNoIChvciBwZW4hKSBpbnB1dCB0cmlnZ2VycyBldmVudHMKICAgICAgICBwcmV2ZW50X21vdXNlZXZlbnRzOiBmYWxzZQogICAgICB9LAogICAgICBoYW5kbGVyOiBmdW5jdGlvbiB0b3VjaEdlc3R1cmUoZXYsIGluc3QpIHsKICAgICAgICBpZihpbnN0Lm9wdGlvbnMucHJldmVudF9tb3VzZWV2ZW50cyAmJiBldi5wb2ludGVyVHlwZSA9PSBpb25pYy5HZXN0dXJlcy5QT0lOVEVSX01PVVNFKSB7CiAgICAgICAgICBldi5zdG9wRGV0ZWN0KCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZihpbnN0Lm9wdGlvbnMucHJldmVudF9kZWZhdWx0KSB7CiAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgaWYoZXYuZXZlbnRUeXBlID09ICBpb25pYy5HZXN0dXJlcy5FVkVOVF9TVEFSVCkgewogICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCgogICAgLyoqCiAgICAgKiBSZWxlYXNlCiAgICAgKiBDYWxsZWQgYXMgbGFzdCwgdGVsbHMgdGhlIHVzZXIgaGFzIHJlbGVhc2VkIHRoZSBzY3JlZW4KICAgICAqIGV2ZW50cyAgcmVsZWFzZQogICAgICovCiAgICBpb25pYy5HZXN0dXJlcy5nZXN0dXJlcy5SZWxlYXNlID0gewogICAgICBuYW1lOiAncmVsZWFzZScsCiAgICAgIGluZGV4OiBJbmZpbml0eSwKICAgICAgaGFuZGxlcjogZnVuY3Rpb24gcmVsZWFzZUdlc3R1cmUoZXYsIGluc3QpIHsKICAgICAgICBpZihldi5ldmVudFR5cGUgPT0gIGlvbmljLkdlc3R1cmVzLkVWRU5UX0VORCkgewogICAgICAgICAgaW5zdC50cmlnZ2VyKHRoaXMubmFtZSwgZXYpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9KSh3aW5kb3cuaW9uaWMpOwoKICAoZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgaW9uaWMpIHsKCiAgICB2YXIgSU9TID0gJ2lvcyc7CiAgICB2YXIgQU5EUk9JRCA9ICdhbmRyb2lkJzsKICAgIHZhciBXSU5ET1dTX1BIT05FID0gJ3dpbmRvd3NwaG9uZSc7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgdXRpbGl0eQogICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0KICAgICAqIEBtb2R1bGUgaW9uaWMKICAgICAqLwogICAgaW9uaWMuUGxhdGZvcm0gPSB7CgogICAgICAvLyBQdXQgbmF2aWdhdG9yIG9uIHBsYXRmb3JtIHNvIGl0IGNhbiBiZSBtb2NrZWQgYW5kIHNldAogICAgICAvLyB0aGUgYnJvd3NlciBkb2VzIG5vdCBhbGxvdyB3aW5kb3cubmF2aWdhdG9yIHRvIGJlIHNldAogICAgICBuYXZpZ2F0b3I6IHdpbmRvdy5uYXZpZ2F0b3IsCgogICAgICAvKioKICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2lzUmVhZHkKICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGRldmljZSBpcyByZWFkeS4KICAgICAgICovCiAgICAgIGlzUmVhZHk6IGZhbHNlLAogICAgICAvKioKICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI2lzRnVsbFNjcmVlbgogICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgZGV2aWNlIGlzIGZ1bGxzY3JlZW4uCiAgICAgICAqLwogICAgICBpc0Z1bGxTY3JlZW46IGZhbHNlLAogICAgICAvKioKICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI3BsYXRmb3JtcwogICAgICAgKiBAcmV0dXJucyB7QXJyYXkoc3RyaW5nKX0gQW4gYXJyYXkgb2YgYWxsIHBsYXRmb3JtcyBmb3VuZC4KICAgICAgICovCiAgICAgIHBsYXRmb3JtczogbnVsbCwKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNncmFkZQogICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBXaGF0IGdyYWRlIHRoZSBjdXJyZW50IHBsYXRmb3JtIGlzLgogICAgICAgKi8KICAgICAgZ3JhZGU6IG51bGwsCiAgICAgIHVhOiBuYXZpZ2F0b3IudXNlckFnZW50LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jcmVhZHkKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFRyaWdnZXIgYSBjYWxsYmFjayBvbmNlIHRoZSBkZXZpY2UgaXMgcmVhZHksIG9yIGltbWVkaWF0ZWx5CiAgICAgICAqIGlmIHRoZSBkZXZpY2UgaXMgYWxyZWFkeSByZWFkeS4gVGhpcyBtZXRob2QgY2FuIGJlIHJ1biBmcm9tCiAgICAgICAqIGFueXdoZXJlIGFuZCBkb2VzIG5vdCBuZWVkIHRvIGJlIHdyYXBwZWQgYnkgYW55IGFkZGl0b25hbCBtZXRob2RzLgogICAgICAgKiBXaGVuIHRoZSBhcHAgaXMgd2l0aGluIGEgV2ViVmlldyAoQ29yZG92YSksIGl0J2xsIGZpcmUKICAgICAgICogdGhlIGNhbGxiYWNrIG9uY2UgdGhlIGRldmljZSBpcyByZWFkeS4gSWYgdGhlIGFwcCBpcyB3aXRoaW4KICAgICAgICogYSB3ZWIgYnJvd3NlciwgaXQnbGwgZmlyZSB0aGUgY2FsbGJhY2sgYWZ0ZXIgYHdpbmRvdy5sb2FkYC4KICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRvIGNhbGwuCiAgICAgICAqLwogICAgICByZWFkeTogZnVuY3Rpb24oY2IpIHsKICAgICAgICAvLyBydW4gdGhyb3VnaCB0YXNrcyB0byBjb21wbGV0ZSBub3cgdGhhdCB0aGUgZGV2aWNlIGlzIHJlYWR5CiAgICAgICAgaWYodGhpcy5pc1JlYWR5KSB7CiAgICAgICAgICBjYigpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyB0aGUgcGxhdGZvcm0gaXNuJ3QgcmVhZHkgeWV0LCBhZGQgaXQgdG8gdGhpcyBhcnJheQogICAgICAgICAgLy8gd2hpY2ggd2lsbCBiZSBjYWxsZWQgb25jZSB0aGUgcGxhdGZvcm0gaXMgcmVhZHkKICAgICAgICAgIHJlYWR5Q2FsbGJhY2tzLnB1c2goY2IpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAcHJpdmF0ZQogICAgICAgKi8KICAgICAgZGV0ZWN0OiBmdW5jdGlvbigpIHsKICAgICAgICBpb25pYy5QbGF0Zm9ybS5fY2hlY2tQbGF0Zm9ybXMoKTsKCiAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgICAvLyBvbmx5IGFkZCB0byB0aGUgYm9keSBjbGFzcyBpZiB3ZSBnb3QgcGxhdGZvcm0gaW5mbwogICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGlvbmljLlBsYXRmb3JtLnBsYXRmb3Jtcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ3BsYXRmb3JtLScgKyBpb25pYy5QbGF0Zm9ybS5wbGF0Zm9ybXNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jc2V0R3JhZGUKICAgICAgICogQGRlc2NyaXB0aW9uIFNldCB0aGUgZ3JhZGUgb2YgdGhlIGRldmljZTogJ2EnLCAnYicsIG9yICdjJy4gJ2EnIGlzIHRoZSBiZXN0CiAgICAgICAqIChtb3N0IGNzcyBmZWF0dXJlcyBlbmFibGVkKSwgJ2MnIGlzIHRoZSB3b3JzdC4gIEJ5IGRlZmF1bHQsIHNldHMgdGhlIGdyYWRlCiAgICAgICAqIGRlcGVuZGluZyBvbiB0aGUgY3VycmVudCBkZXZpY2UuCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBncmFkZSBUaGUgbmV3IGdyYWRlIHRvIHNldC4KICAgICAgICovCiAgICAgIHNldEdyYWRlOiBmdW5jdGlvbihncmFkZSkgewogICAgICAgIHZhciBvbGRHcmFkZSA9IHRoaXMuZ3JhZGU7CiAgICAgICAgdGhpcy5ncmFkZSA9IGdyYWRlOwogICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChvbGRHcmFkZSkgewogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ2dyYWRlLScgKyBvbGRHcmFkZSk7CiAgICAgICAgICB9CiAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ2dyYWRlLScgKyBncmFkZSk7CiAgICAgICAgfSk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNkZXZpY2UKICAgICAgICogQGRlc2NyaXB0aW9uIFJldHVybiB0aGUgY3VycmVudCBkZXZpY2UgKGdpdmVuIGJ5IGNvcmRvdmEpLgogICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBUaGUgZGV2aWNlIG9iamVjdC4KICAgICAgICovCiAgICAgIGRldmljZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYod2luZG93LmRldmljZSkgcmV0dXJuIHdpbmRvdy5kZXZpY2U7CiAgICAgICAgaWYodGhpcy5pc1dlYlZpZXcoKSkgdm9pZCAwOwogICAgICAgIHJldHVybiB7fTsKICAgICAgfSwKCiAgICAgIF9jaGVja1BsYXRmb3JtczogZnVuY3Rpb24ocGxhdGZvcm1zKSB7CiAgICAgICAgdGhpcy5wbGF0Zm9ybXMgPSBbXTsKICAgICAgICB2YXIgZ3JhZGUgPSAnYSc7CgogICAgICAgIGlmKHRoaXMuaXNXZWJWaWV3KCkpIHsKICAgICAgICAgIHRoaXMucGxhdGZvcm1zLnB1c2goJ3dlYnZpZXcnKTsKICAgICAgICAgIHRoaXMucGxhdGZvcm1zLnB1c2goJ2NvcmRvdmEnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5wbGF0Zm9ybXMucHVzaCgnYnJvd3NlcicpOwogICAgICAgIH0KICAgICAgICBpZih0aGlzLmlzSVBhZCgpKSB0aGlzLnBsYXRmb3Jtcy5wdXNoKCdpcGFkJyk7CgogICAgICAgIHZhciBwbGF0Zm9ybSA9IHRoaXMucGxhdGZvcm0oKTsKICAgICAgICBpZihwbGF0Zm9ybSkgewogICAgICAgICAgdGhpcy5wbGF0Zm9ybXMucHVzaChwbGF0Zm9ybSk7CgogICAgICAgICAgdmFyIHZlcnNpb24gPSB0aGlzLnZlcnNpb24oKTsKICAgICAgICAgIGlmKHZlcnNpb24pIHsKICAgICAgICAgICAgdmFyIHYgPSB2ZXJzaW9uLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIGlmKHYuaW5kZXhPZignLicpID4gMCkgewogICAgICAgICAgICAgIHYgPSB2LnJlcGxhY2UoJy4nLCAnXycpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHYgKz0gJ18wJzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnBsYXRmb3Jtcy5wdXNoKHBsYXRmb3JtICsgdi5zcGxpdCgnXycpWzBdKTsKICAgICAgICAgICAgdGhpcy5wbGF0Zm9ybXMucHVzaChwbGF0Zm9ybSArIHYpOwoKICAgICAgICAgICAgaWYodGhpcy5pc0FuZHJvaWQoKSAmJiB2ZXJzaW9uIDwgNC40KSB7CiAgICAgICAgICAgICAgZ3JhZGUgPSAodmVyc2lvbiA8IDQgPyAnYycgOiAnYicpOwogICAgICAgICAgICB9IGVsc2UgaWYodGhpcy5pc1dpbmRvd3NQaG9uZSgpKSB7CiAgICAgICAgICAgICAgZ3JhZGUgPSAnYic7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuc2V0R3JhZGUoZ3JhZGUpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jaXNXZWJWaWV3CiAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBDaGVjayBpZiB3ZSBhcmUgcnVubmluZyB3aXRoaW4gYSBXZWJWaWV3IChzdWNoIGFzIENvcmRvdmEpLgogICAgICAgKi8KICAgICAgaXNXZWJWaWV3OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gISghd2luZG93LmNvcmRvdmEgJiYgIXdpbmRvdy5QaG9uZUdhcCAmJiAhd2luZG93LnBob25lZ2FwKTsKICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jaXNJUGFkCiAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHdlIGFyZSBydW5uaW5nIG9uIGlQYWQuCiAgICAgICAqLwogICAgICBpc0lQYWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmKCAvaVBhZC9pLnRlc3QoaW9uaWMuUGxhdGZvcm0ubmF2aWdhdG9yLnBsYXRmb3JtKSApIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gL2lQYWQvaS50ZXN0KHRoaXMudWEpOwogICAgICB9LAogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNpc0lPUwogICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB3ZSBhcmUgcnVubmluZyBvbiBpT1MuCiAgICAgICAqLwogICAgICBpc0lPUzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaXMoSU9TKTsKICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jaXNBbmRyb2lkCiAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHdlIGFyZSBydW5uaW5nIG9uIEFuZHJvaWQuCiAgICAgICAqLwogICAgICBpc0FuZHJvaWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmlzKEFORFJPSUQpOwogICAgICB9LAogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNpc1dpbmRvd3NQaG9uZQogICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB3ZSBhcmUgcnVubmluZyBvbiBXaW5kb3dzIFBob25lLgogICAgICAgKi8KICAgICAgaXNXaW5kb3dzUGhvbmU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmlzKFdJTkRPV1NfUEhPTkUpOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgaW9uaWMuUGxhdGZvcm0jcGxhdGZvcm0KICAgICAgICogQHJldHVybnMge3N0cmluZ30gVGhlIG5hbWUgb2YgdGhlIGN1cnJlbnQgcGxhdGZvcm0uCiAgICAgICAqLwogICAgICBwbGF0Zm9ybTogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gc2luZ2xldG9uIHRvIGdldCB0aGUgcGxhdGZvcm0gbmFtZQogICAgICAgIGlmKHBsYXRmb3JtTmFtZSA9PT0gbnVsbCkgdGhpcy5zZXRQbGF0Zm9ybSh0aGlzLmRldmljZSgpLnBsYXRmb3JtKTsKICAgICAgICByZXR1cm4gcGxhdGZvcm1OYW1lOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBwcml2YXRlCiAgICAgICAqLwogICAgICBzZXRQbGF0Zm9ybTogZnVuY3Rpb24obikgewogICAgICAgIGlmKHR5cGVvZiBuICE9ICd1bmRlZmluZWQnICYmIG4gIT09IG51bGwgJiYgbi5sZW5ndGgpIHsKICAgICAgICAgIHBsYXRmb3JtTmFtZSA9IG4udG9Mb3dlckNhc2UoKTsKICAgICAgICB9IGVsc2UgaWYodGhpcy51YS5pbmRleE9mKCdBbmRyb2lkJykgPiAwKSB7CiAgICAgICAgICBwbGF0Zm9ybU5hbWUgPSBBTkRST0lEOwogICAgICAgIH0gZWxzZSBpZih0aGlzLnVhLmluZGV4T2YoJ2lQaG9uZScpID4gLTEgfHwgdGhpcy51YS5pbmRleE9mKCdpUGFkJykgPiAtMSB8fCB0aGlzLnVhLmluZGV4T2YoJ2lQb2QnKSA+IC0xKSB7CiAgICAgICAgICBwbGF0Zm9ybU5hbWUgPSBJT1M7CiAgICAgICAgfSBlbHNlIGlmKHRoaXMudWEuaW5kZXhPZignV2luZG93cyBQaG9uZScpID4gLTEpIHsKICAgICAgICAgIHBsYXRmb3JtTmFtZSA9IFdJTkRPV1NfUEhPTkU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHBsYXRmb3JtTmFtZSA9IGlvbmljLlBsYXRmb3JtLm5hdmlnYXRvci5wbGF0Zm9ybSAmJiBuYXZpZ2F0b3IucGxhdGZvcm0udG9Mb3dlckNhc2UoKS5zcGxpdCgnICcpWzBdIHx8ICcnOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI3ZlcnNpb24KICAgICAgICogQHJldHVybnMge3N0cmluZ30gVGhlIHZlcnNpb24gb2YgdGhlIGN1cnJlbnQgZGV2aWNlIHBsYXRmb3JtLgogICAgICAgKi8KICAgICAgdmVyc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gc2luZ2xldG9uIHRvIGdldCB0aGUgcGxhdGZvcm0gdmVyc2lvbgogICAgICAgIGlmKHBsYXRmb3JtVmVyc2lvbiA9PT0gbnVsbCkgdGhpcy5zZXRWZXJzaW9uKHRoaXMuZGV2aWNlKCkudmVyc2lvbik7CiAgICAgICAgcmV0dXJuIHBsYXRmb3JtVmVyc2lvbjsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAcHJpdmF0ZQogICAgICAgKi8KICAgICAgc2V0VmVyc2lvbjogZnVuY3Rpb24odikgewogICAgICAgIGlmKHR5cGVvZiB2ICE9ICd1bmRlZmluZWQnICYmIHYgIT09IG51bGwpIHsKICAgICAgICAgIHYgPSB2LnNwbGl0KCcuJyk7CiAgICAgICAgICB2ID0gcGFyc2VGbG9hdCh2WzBdICsgJy4nICsgKHYubGVuZ3RoID4gMSA/IHZbMV0gOiAwKSk7CiAgICAgICAgICBpZighaXNOYU4odikpIHsKICAgICAgICAgICAgcGxhdGZvcm1WZXJzaW9uID0gdjsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcGxhdGZvcm1WZXJzaW9uID0gMDsKCiAgICAgICAgLy8gZmFsbGJhY2sgdG8gdXNlci1hZ2VudCBjaGVja2luZwogICAgICAgIHZhciBwTmFtZSA9IHRoaXMucGxhdGZvcm0oKTsKICAgICAgICB2YXIgdmVyc2lvbk1hdGNoID0gewogICAgICAgICAgJ2FuZHJvaWQnOiAvQW5kcm9pZCAoXGQrKS4oXGQrKT8vLAogICAgICAgICAgJ2lvcyc6IC9PUyAoXGQrKV8oXGQrKT8vLAogICAgICAgICAgJ3dpbmRvd3NwaG9uZSc6IC9XaW5kb3dzIFBob25lIChcZCspLihcZCspPy8KICAgICAgICB9OwogICAgICAgIGlmKHZlcnNpb25NYXRjaFtwTmFtZV0pIHsKICAgICAgICAgIHYgPSB0aGlzLnVhLm1hdGNoKCB2ZXJzaW9uTWF0Y2hbcE5hbWVdICk7CiAgICAgICAgICBpZih2ICYmICB2Lmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgcGxhdGZvcm1WZXJzaW9uID0gcGFyc2VGbG9hdCggdlsxXSArICcuJyArIHZbMl0gKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCgogICAgICAvLyBDaGVjayBpZiB0aGUgcGxhdGZvcm0gaXMgdGhlIG9uZSBkZXRlY3RlZCBieSBjb3Jkb3ZhCiAgICAgIGlzOiBmdW5jdGlvbih0eXBlKSB7CiAgICAgICAgdHlwZSA9IHR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAvLyBjaGVjayBpZiBpdCBoYXMgYW4gYXJyYXkgb2YgcGxhdGZvcm1zCiAgICAgICAgaWYodGhpcy5wbGF0Zm9ybXMpIHsKICAgICAgICAgIGZvcih2YXIgeCA9IDA7IHggPCB0aGlzLnBsYXRmb3Jtcy5sZW5ndGg7IHgrKykgewogICAgICAgICAgICBpZih0aGlzLnBsYXRmb3Jtc1t4XSA9PT0gdHlwZSkgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIGV4YWN0IG1hdGNoCiAgICAgICAgdmFyIHBOYW1lID0gdGhpcy5wbGF0Zm9ybSgpOwogICAgICAgIGlmKHBOYW1lKSB7CiAgICAgICAgICByZXR1cm4gcE5hbWUgPT09IHR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICB9CgogICAgICAgIC8vIEEgcXVpY2sgaGFjayBmb3IgdG8gY2hlY2sgdXNlckFnZW50CiAgICAgICAgcmV0dXJuIHRoaXMudWEudG9Mb3dlckNhc2UoKS5pbmRleE9mKHR5cGUpID49IDA7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNleGl0QXBwCiAgICAgICAqIEBkZXNjcmlwdGlvbiBFeGl0IHRoZSBhcHAuCiAgICAgICAqLwogICAgICBleGl0QXBwOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJlYWR5KGZ1bmN0aW9uKCl7CiAgICAgICAgICBuYXZpZ2F0b3IuYXBwICYmIG5hdmlnYXRvci5hcHAuZXhpdEFwcCAmJiBuYXZpZ2F0b3IuYXBwLmV4aXRBcHAoKTsKICAgICAgICB9KTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIGlvbmljLlBsYXRmb3JtI3Nob3dTdGF0dXNCYXIKICAgICAgICogQGRlc2NyaXB0aW9uIFNob3dzIG9yIGhpZGVzIHRoZSBkZXZpY2Ugc3RhdHVzIGJhciAoaW4gQ29yZG92YSkuCiAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gc2hvdWxkU2hvdyBXaGV0aGVyIG9yIG5vdCB0byBzaG93IHRoZSBzdGF0dXMgYmFyLgogICAgICAgKi8KICAgICAgc2hvd1N0YXR1c0JhcjogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgLy8gT25seSB1c2VmdWwgd2hlbiBydW4gd2l0aGluIGNvcmRvdmEKICAgICAgICB0aGlzLl9zaG93U3RhdHVzQmFyID0gdmFsOwogICAgICAgIHRoaXMucmVhZHkoZnVuY3Rpb24oKXsKICAgICAgICAgIC8vIHJ1biB0aGlzIG9ubHkgd2hlbiBvciBpZiB0aGUgcGxhdGZvcm0gKGNvcmRvdmEpIGlzIHJlYWR5CiAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICAgICAgaWYoaW9uaWMuUGxhdGZvcm0uX3Nob3dTdGF0dXNCYXIpIHsKICAgICAgICAgICAgICAvLyB0aGV5IGRvIG5vdCB3YW50IGl0IHRvIGJlIGZ1bGwgc2NyZWVuCiAgICAgICAgICAgICAgd2luZG93LlN0YXR1c0JhciAmJiB3aW5kb3cuU3RhdHVzQmFyLnNob3coKTsKICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ3N0YXR1cy1iYXItaGlkZScpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIGl0IHNob3VsZCBiZSBmdWxsIHNjcmVlbgogICAgICAgICAgICAgIHdpbmRvdy5TdGF0dXNCYXIgJiYgd2luZG93LlN0YXR1c0Jhci5oaWRlKCk7CiAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdzdGF0dXMtYmFyLWhpZGUnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSBpb25pYy5QbGF0Zm9ybSNmdWxsU2NyZWVuCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBTZXRzIHdoZXRoZXIgdGhlIGFwcCBpcyBmdWxsc2NyZWVuIG9yIG5vdCAoaW4gQ29yZG92YSkuCiAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3dGdWxsU2NyZWVuIFdoZXRoZXIgb3Igbm90IHRvIHNldCB0aGUgYXBwIHRvIGZ1bGxzY3JlZW4uIERlZmF1bHRzIHRvIHRydWUuCiAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3dTdGF0dXNCYXIgV2hldGhlciBvciBub3QgdG8gc2hvdyB0aGUgZGV2aWNlJ3Mgc3RhdHVzIGJhci4gRGVmYXVsdHMgdG8gZmFsc2UuCiAgICAgICAqLwogICAgICBmdWxsU2NyZWVuOiBmdW5jdGlvbihzaG93RnVsbFNjcmVlbiwgc2hvd1N0YXR1c0JhcikgewogICAgICAgIC8vIHNob3dGdWxsU2NyZWVuOiBkZWZhdWx0IGlzIHRydWUgaWYgbm8gcGFyYW0gcHJvdmlkZWQKICAgICAgICB0aGlzLmlzRnVsbFNjcmVlbiA9IChzaG93RnVsbFNjcmVlbiAhPT0gZmFsc2UpOwoKICAgICAgICAvLyBhZGQvcmVtb3ZlIHRoZSBmdWxsc2NyZWVuIGNsYXNzbmFtZSB0byB0aGUgYm9keQogICAgICAgIGlvbmljLkRvbVV0aWwucmVhZHkoZnVuY3Rpb24oKXsKICAgICAgICAgIC8vIHJ1biB0aGlzIG9ubHkgd2hlbiBvciBpZiB0aGUgRE9NIGlzIHJlYWR5CiAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICAgICAgaWYoaW9uaWMuUGxhdGZvcm0uaXNGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdmdWxsc2NyZWVuJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdmdWxsc2NyZWVuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgLy8gc2hvd1N0YXR1c0JhcjogZGVmYXVsdCBpcyBmYWxzZSBpZiBubyBwYXJhbSBwcm92aWRlZAogICAgICAgICAgaW9uaWMuUGxhdGZvcm0uc2hvd1N0YXR1c0JhciggKHNob3dTdGF0dXNCYXIgPT09IHRydWUpICk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICB9OwoKICAgIHZhciBwbGF0Zm9ybU5hbWUgPSBudWxsLCAvLyBqdXN0IHRoZSBuYW1lLCBsaWtlIGlPUyBvciBBbmRyb2lkCiAgICAgIHBsYXRmb3JtVmVyc2lvbiA9IG51bGwsIC8vIGEgZmxvYXQgb2YgdGhlIG1ham9yIGFuZCBtaW5vciwgbGlrZSA3LjEKICAgICAgcmVhZHlDYWxsYmFja3MgPSBbXTsKCiAgICAvLyBzZXR1cCBsaXN0ZW5lcnMgdG8ga25vdyB3aGVuIHRoZSBkZXZpY2UgaXMgcmVhZHkgdG8gZ28KICAgIGZ1bmN0aW9uIG9uV2luZG93TG9hZCgpIHsKICAgICAgaWYoaW9uaWMuUGxhdGZvcm0uaXNXZWJWaWV3KCkpIHsKICAgICAgICAvLyB0aGUgd2luZG93IGFuZCBzY3JpcHRzIGFyZSBmdWxseSBsb2FkZWQsIGFuZCBhIGNvcmRvdmEvcGhvbmVnYXAKICAgICAgICAvLyBvYmplY3QgZXhpc3RzIHRoZW4gbGV0J3MgbGlzdGVuIGZvciB0aGUgZGV2aWNlcmVhZHkKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJkZXZpY2VyZWFkeSIsIG9uUGxhdGZvcm1SZWFkeSwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIHRoZSB3aW5kb3cgYW5kIHNjcmlwdHMgYXJlIGZ1bGx5IGxvYWRlZCwgYnV0IHRoZSB3aW5kb3cgb2JqZWN0IGRvZXNuJ3QgaGF2ZSB0aGUKICAgICAgICAvLyBjb3Jkb3ZhL3Bob25lZ2FwIG9iamVjdCwgc28gaXRzIGp1c3QgYSBicm93c2VyLCBub3QgYSB3ZWJ2aWV3IHdyYXBwZWQgdy8gY29yZG92YQogICAgICAgIG9uUGxhdGZvcm1SZWFkeSgpOwogICAgICB9CiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJsb2FkIiwgb25XaW5kb3dMb2FkLCBmYWxzZSk7CiAgICB9CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibG9hZCIsIG9uV2luZG93TG9hZCwgZmFsc2UpOwoKICAgIGZ1bmN0aW9uIG9uUGxhdGZvcm1SZWFkeSgpIHsKICAgICAgLy8gdGhlIGRldmljZSBpcyBhbGwgc2V0IHRvIGdvLCBpbml0IG91ciBvd24gc3R1ZmYgdGhlbiBmaXJlIG9mZiBvdXIgZXZlbnQKICAgICAgaW9uaWMuUGxhdGZvcm0uaXNSZWFkeSA9IHRydWU7CiAgICAgIGlvbmljLlBsYXRmb3JtLmRldGVjdCgpOwogICAgICBmb3IodmFyIHg9MDsgeDxyZWFkeUNhbGxiYWNrcy5sZW5ndGg7IHgrKykgewogICAgICAgIC8vIGZpcmUgb2ZmIGFsbCB0aGUgY2FsbGJhY2tzIHRoYXQgd2VyZSBhZGRlZCBiZWZvcmUgdGhlIHBsYXRmb3JtIHdhcyByZWFkeQogICAgICAgIHJlYWR5Q2FsbGJhY2tzW3hdKCk7CiAgICAgIH0KICAgICAgcmVhZHlDYWxsYmFja3MgPSBbXTsKICAgICAgaW9uaWMudHJpZ2dlcigncGxhdGZvcm1yZWFkeScsIHsgdGFyZ2V0OiBkb2N1bWVudCB9KTsKCiAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpewogICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgncGxhdGZvcm0tcmVhZHknKTsKICAgICAgfSk7CiAgICB9CgogIH0pKHRoaXMsIGRvY3VtZW50LCBpb25pYyk7CgogIChmdW5jdGlvbihkb2N1bWVudCwgaW9uaWMpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICAvLyBJb25pYyBDU1MgcG9seWZpbGxzCiAgICBpb25pYy5DU1MgPSB7fTsKCiAgICAoZnVuY3Rpb24oKSB7CgogICAgICAvLyB0cmFuc2Zvcm0KICAgICAgdmFyIGksIGtleXMgPSBbJ3dlYmtpdFRyYW5zZm9ybScsICd0cmFuc2Zvcm0nLCAnLXdlYmtpdC10cmFuc2Zvcm0nLCAnd2Via2l0LXRyYW5zZm9ybScsCiAgICAgICAgJy1tb3otdHJhbnNmb3JtJywgJ21vei10cmFuc2Zvcm0nLCAnTW96VHJhbnNmb3JtJywgJ21velRyYW5zZm9ybScsICdtc1RyYW5zZm9ybSddOwoKICAgICAgZm9yKGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZVtrZXlzW2ldXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBpb25pYy5DU1MuVFJBTlNGT1JNID0ga2V5c1tpXTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gdHJhbnNpdGlvbgogICAgICBrZXlzID0gWyd3ZWJraXRUcmFuc2l0aW9uJywgJ21velRyYW5zaXRpb24nLCAnbXNUcmFuc2l0aW9uJywgJ3RyYW5zaXRpb24nXTsKICAgICAgZm9yKGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZVtrZXlzW2ldXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBpb25pYy5DU1MuVFJBTlNJVElPTiA9IGtleXNbaV07CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICB9KSgpOwoKICAgIC8vIGNsYXNzTGlzdCBwb2x5ZmlsbCBmb3IgdGhlbSBvbGRlciBBbmRyb2lkcwogICAgLy8gaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vZGV2b25nb3ZldHQvMTM4MTgzOQogICAgaWYgKCEoImNsYXNzTGlzdCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSAmJiBPYmplY3QuZGVmaW5lUHJvcGVydHkgJiYgdHlwZW9mIEhUTUxFbGVtZW50ICE9PSAndW5kZWZpbmVkJykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoSFRNTEVsZW1lbnQucHJvdG90eXBlLCAnY2xhc3NMaXN0JywgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGUoZm4pIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciB4LCBjbGFzc2VzID0gc2VsZi5jbGFzc05hbWUuc3BsaXQoL1xzKy8pOwoKICAgICAgICAgICAgICBmb3IoeD0wOyB4PGFyZ3VtZW50cy5sZW5ndGg7IHgrKykgewogICAgICAgICAgICAgICAgZm4oY2xhc3NlcywgY2xhc3Nlcy5pbmRleE9mKGFyZ3VtZW50c1t4XSksIGFyZ3VtZW50c1t4XSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBzZWxmLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbigiICIpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGFkZDogdXBkYXRlKGZ1bmN0aW9uKGNsYXNzZXMsIGluZGV4LCB2YWx1ZSkgewogICAgICAgICAgICAgIH5pbmRleCB8fCBjbGFzc2VzLnB1c2godmFsdWUpOwogICAgICAgICAgICB9KSwKCiAgICAgICAgICAgIHJlbW92ZTogdXBkYXRlKGZ1bmN0aW9uKGNsYXNzZXMsIGluZGV4KSB7CiAgICAgICAgICAgICAgfmluZGV4ICYmIGNsYXNzZXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgICAgfSksCgogICAgICAgICAgICB0b2dnbGU6IHVwZGF0ZShmdW5jdGlvbihjbGFzc2VzLCBpbmRleCwgdmFsdWUpIHsKICAgICAgICAgICAgICB+aW5kZXggPyBjbGFzc2VzLnNwbGljZShpbmRleCwgMSkgOiBjbGFzc2VzLnB1c2godmFsdWUpOwogICAgICAgICAgICB9KSwKCiAgICAgICAgICAgIGNvbnRhaW5zOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHJldHVybiAhIX5zZWxmLmNsYXNzTmFtZS5zcGxpdCgvXHMrLykuaW5kZXhPZih2YWx1ZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpdGVtOiBmdW5jdGlvbihpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuY2xhc3NOYW1lLnNwbGl0KC9ccysvKVtpXSB8fCBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICB9KShkb2N1bWVudCwgaW9uaWMpOwoKCiAgLyoqCiAgICogQG5nZG9jIHBhZ2UKICAgKiBAbmFtZSB0YXAKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICogT24gdG91Y2ggZGV2aWNlcyBzdWNoIGFzIGEgcGhvbmUgb3IgdGFibGV0LCBzb21lIGJyb3dzZXJzIGltcGxlbWVudCBhIDMwMG1zIGRlbGF5IGJldHdlZW4KICAgKiB0aGUgdGltZSB0aGUgdXNlciBzdG9wcyB0b3VjaGluZyB0aGUgZGlzcGxheSBhbmQgdGhlIG1vbWVudCB0aGUgYnJvd3NlciBleGVjdXRlcyB0aGUKICAgKiBjbGljay4gVGhpcyBkZWxheSB3YXMgaW5pdGlhbGx5IGludHJvZHVjZWQgc28gdGhlIGJyb3dzZXIgY2FuIGtub3cgd2hldGhlciB0aGUgdXNlciB3YW50cyB0bwogICAqIGRvdWJsZS10YXAgdG8gem9vbSBpbiBvbiB0aGUgd2VicGFnZS4gIEJhc2ljYWxseSwgdGhlIGJyb3dzZXIgd2FpdHMgcm91Z2hseSAzMDBtcyB0byBzZWUgaWYKICAgKiB0aGUgdXNlciBpcyBkb3VibGUtdGFwcGluZywgb3IganVzdCB0YXBwaW5nIG9uIHRoZSBkaXNwbGF5IG9uY2UuCiAgICoKICAgKiBPdXQgb2YgdGhlIGJveCwgSW9uaWMgYXV0b21hdGljYWxseSByZW1vdmVzIHRoZSAzMDBtcyBkZWxheSBpbiBvcmRlciB0byBtYWtlIElvbmljIGFwcHMKICAgKiBmZWVsIG1vcmUgIm5hdGl2ZSIgbGlrZS4gUmVzdWx0aW5nbHksIG90aGVyIHNvbHV0aW9ucyBzdWNoIGFzCiAgICogW2Zhc3RjbGlja10oaHR0cHM6Ly9naXRodWIuY29tL2Z0bGFicy9mYXN0Y2xpY2spIGFuZCBBbmd1bGFyJ3MKICAgKiBbbmdUb3VjaF0oaHR0cHM6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nVG91Y2gpIHNob3VsZCBub3QgYmUgaW5jbHVkZWQsIHRvIGF2b2lkIGNvbmZsaWN0cy4KICAgKgogICAqIFNvbWUgYnJvd3NlcnMgYWxyZWFkeSByZW1vdmUgdGhlIGRlbGF5IHdpdGggY2VydGFpbiBzZXR0aW5ncywgc3VjaCBhcyB0aGUgQ1NTIHByb3BlcnR5CiAgICogYHRvdWNoLWV2ZW50czogbm9uZWAgb3Igd2l0aCBzcGVjaWZpYyBtZXRhIHRhZyB2aWV3cG9ydCB2YWx1ZXMuIEhvd2V2ZXIsIGVhY2ggb2YgdGhlc2UKICAgKiBicm93c2VycyBzdGlsbCBoYW5kbGUgY2xpY2tzIGRpZmZlcmVudGx5LCBzdWNoIGFzIHdoZW4gdG8gZmlyZSBvZmYgb3IgY2FuY2VsIHRoZSBldmVudAogICAqIChsaWtlIHNjcm9sbGluZyB3aGVuIHRoZSB0YXJnZXQgaXMgYSBidXR0b24sIG9yIGhvbGRpbmcgYSBidXR0b24gZG93bikuCiAgICogRm9yIGJyb3dzZXJzIHRoYXQgYWxyZWFkeSByZW1vdmUgdGhlIDMwMG1zIGRlbGF5LCBjb25zaWRlciBJb25pYydzIHRhcCBzeXN0ZW0gYXMgYSB3YXkgdG8KICAgKiBub3JtYWxpemUgaG93IGNsaWNrcyBhcmUgaGFuZGxlZCBhY3Jvc3MgdGhlIHZhcmlvdXMgZGV2aWNlcyBzbyB0aGVyZSdzIGFuIGV4cGVjdGVkIHJlc3BvbnNlCiAgICogbm8gbWF0dGVyIHdoYXQgdGhlIGRldmljZSwgcGxhdGZvcm0gb3IgdmVyc2lvbi4gQWRkaXRpb25hbGx5LCBJb25pYyB3aWxsIHByZXZlbnQKICAgKiBnaG9zdGNsaWNrcyB3aGljaCBldmVuIGJyb3dzZXJzIHRoYXQgcmVtb3ZlIHRoZSBkZWxheSBzdGlsbCBleHBlcmllbmNlLgogICAqCiAgICogSW4gc29tZSBjYXNlcywgdGhpcmQtcGFydHkgbGlicmFyaWVzIG1heSBhbHNvIGJlIHdvcmtpbmcgd2l0aCB0b3VjaCBldmVudHMgd2hpY2ggY2FuIGludGVyZmVyZQogICAqIHdpdGggdGhlIHRhcCBzeXN0ZW0uIEZvciBleGFtcGxlLCBtYXBwaW5nIGxpYnJhcmllcyBsaWtlIEdvb2dsZSBvciBMZWFmbGV0IE1hcHMgb2Z0ZW4gaW1wbGVtZW50CiAgICogYSB0b3VjaCBkZXRlY3Rpb24gc3lzdGVtIHdoaWNoIGNvbmZsaWN0cyB3aXRoIElvbmljJ3MgdGFwIHN5c3RlbS4KICAgKgogICAqICMjIyBEaXNhYmxpbmcgdGhlIHRhcCBzeXN0ZW0KICAgKgogICAqIFRvIGRpc2FibGUgdGhlIHRhcCBmb3IgYW4gZWxlbWVudCBhbmQgYWxsIG9mIGl0cyBjaGlsZHJlbiBlbGVtZW50cywKICAgKiBhZGQgdGhlIGF0dHJpYnV0ZSBgZGF0YS10YXAtZGlzYWJsZWQ9InRydWUiYC4KICAgKgogICAqIGBgYGh0bWwKICAgKiA8ZGl2IGRhdGEtdGFwLWRpc2FibGVkPSJ0cnVlIj4KICAgKiAgICAgPGRpdiBpZD0iZ29vZ2xlLW1hcCI+PC9kaXY+CiAgICogPC9kaXY+CiAgICogYGBgCiAgICoKICAgKiAjIyMgQWRkaXRpb25hbCBOb3RlczoKICAgKgogICAqIC0gSW9uaWMgdGFwICB3b3JrcyB3aXRoIElvbmljJ3MgSmF2YVNjcmlwdCBzY3JvbGxpbmcKICAgKiAtIEVsZW1lbnRzIGNhbiBjb21lIGFuZCBnbyBmcm9tIHRoZSBET00gYW5kIElvbmljIHRhcCBkb2Vzbid0IGtlZXAgYWRkaW5nIGFuZCByZW1vdmluZwogICAqICAgbGlzdGVuZXJzCiAgICogLSBObyAidGFwIGRlbGF5IiBhZnRlciB0aGUgZmlyc3QgInRhcCIgKHlvdSBjYW4gdGFwIGFzIGZhc3QgYXMgeW91IHdhbnQsIHRoZXkgYWxsIGNsaWNrKQogICAqIC0gTWluaW1hbCBldmVudHMgbGlzdGVuZXJzLCBvbmx5IGJlaW5nIGFkZGVkIHRvIGRvY3VtZW50CiAgICogLSBDb3JyZWN0IGZvY3VzIGluL291dCBvbiBlYWNoIGlucHV0IHR5cGUgKHNlbGVjdCwgdGV4dGVhcmVhLCByYW5nZSkgb24gZWFjaCBwbGF0Zm9ybS9kZXZpY2UKICAgKiAtIFNob3dzIGFuZCBoaWRlcyB2aXJ0dWFsIGtleWJvYXJkIGNvcnJlY3RseSBmb3IgZWFjaCBwbGF0Zm9ybS9kZXZpY2UKICAgKiAtIFdvcmtzIHdpdGggbGFiZWxzIHN1cnJvdW5kaW5nIGlucHV0cwogICAqIC0gRG9lcyBub3QgZmlyZSBvZmYgYSBjbGljayBpZiB0aGUgdXNlciBtb3ZlcyB0aGUgcG9pbnRlciB0b28gZmFyCiAgICogLSBBZGRzIGFuZCByZW1vdmVzIGFuICdhY3RpdmF0ZWQnIGNzcyBjbGFzcwogICAqIC0gTXVsdGlwbGUgW3VuaXQgdGVzdHNdKGh0dHBzOi8vZ2l0aHViLmNvbS9kcmlmdHljby9pb25pYy9ibG9iL21hc3Rlci90ZXN0L3VuaXQvdXRpbHMvdGFwLnVuaXQuanMpIGZvciBlYWNoIHNjZW5hcmlvCiAgICoKICAgKi8KICAvKgoKICAgSU9OSUMgVEFQCiAgIC0tLS0tLS0tLS0tLS0tLQogICAtIEJvdGggdG91Y2ggYW5kIG1vdXNlIGV2ZW50cyBhcmUgYWRkZWQgdG8gdGhlIGRvY3VtZW50LmJvZHkgb24gRE9NIHJlYWR5CiAgIC0gSWYgYSB0b3VjaCBldmVudCBoYXBwZW5zLCBpdCBkb2VzIG5vdCB1c2UgbW91c2UgZXZlbnQgbGlzdGVuZXJzCiAgIC0gT24gdG91Y2hlbmQsIGlmIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHN0YXJ0IGFuZCBlbmQgd2FzIHNtYWxsLCB0cmlnZ2VyIGEgY2xpY2sKICAgLSBJbiB0aGUgdHJpZ2dlcmVkIGNsaWNrIGV2ZW50LCBhZGQgYSAnaXNJb25pY1RhcCcgcHJvcGVydHkKICAgLSBUaGUgdHJpZ2dlcmVkIGNsaWNrIHJlY2VpdmVzIHRoZSBzYW1lIHgseSBjb29yZGluYXRlcyBhcyBhcyB0aGUgZW5kIGV2ZW50CiAgIC0gT24gZG9jdW1lbnQuYm9keSBjbGljayBsaXN0ZW5lciAod2l0aCB1c2VDYXB0dXJlPXRydWUpLCBvbmx5IGFsbG93IGNsaWNrcyB3aXRoICdpc0lvbmljVGFwJwogICAtIFRyaWdnZXJpbmcgY2xpY2tzIHdpdGggbW91c2UgZXZlbnRzIHdvcmsgdGhlIHNhbWUgYXMgdG91Y2gsIGV4Y2VwdCB3aXRoIG1vdXNlZG93bi9tb3VzZXVwCiAgIC0gVGFwcGluZyBpbnB1dHMgaXMgZGlzYWJsZWQgZHVyaW5nIHNjcm9sbGluZwogICAqLwoKICB2YXIgdGFwRG9jOyAvLyB0aGUgZWxlbWVudCB3aGljaCB0aGUgbGlzdGVuZXJzIGFyZSBvbiAoZG9jdW1lbnQuYm9keSkKICB2YXIgdGFwQWN0aXZlRWxlOyAvLyB0aGUgZWxlbWVudCB3aGljaCBpcyBhY3RpdmUgKHByb2JhYmx5IGhhcyBmb2N1cykKICB2YXIgdGFwRW5hYmxlZFRvdWNoRXZlbnRzOwogIHZhciB0YXBNb3VzZVJlc2V0VGltZXI7CiAgdmFyIHRhcFBvaW50ZXJNb3ZlZDsKICB2YXIgdGFwUG9pbnRlclN0YXJ0OwogIHZhciB0YXBUb3VjaEZvY3VzZWRJbnB1dDsKICB2YXIgdGFwTGFzdFRvdWNoVGFyZ2V0OwogIHZhciB0YXBUb3VjaE1vdmVMaXN0ZW5lciA9ICd0b3VjaG1vdmUnOwoKLy8gaG93IG11Y2ggdGhlIGNvb3JkaW5hdGVzIGNhbiBiZSBvZmYgYmV0d2VlbiBzdGFydC9lbmQsIGJ1dCBzdGlsbCBhIGNsaWNrCiAgdmFyIFRBUF9SRUxFQVNFX1RPTEVSQU5DRSA9IDY7IC8vIGRlZmF1bHQgdG9sZXJhbmNlCiAgdmFyIFRBUF9SRUxFQVNFX0JVVFRPTl9UT0xFUkFOQ0UgPSA1MDsgLy8gYnV0dG9uIGVsZW1lbnRzIHNob3VsZCBoYXZlIGEgbGFyZ2VyIHRvbGVyYW5jZQoKICB2YXIgdGFwRXZlbnRMaXN0ZW5lcnMgPSB7CiAgICAnY2xpY2snOiB0YXBDbGlja0dhdGVLZWVwZXIsCgogICAgJ21vdXNlZG93bic6IHRhcE1vdXNlRG93biwKICAgICdtb3VzZXVwJzogdGFwTW91c2VVcCwKICAgICdtb3VzZW1vdmUnOiB0YXBNb3VzZU1vdmUsCgogICAgJ3RvdWNoc3RhcnQnOiB0YXBUb3VjaFN0YXJ0LAogICAgJ3RvdWNoZW5kJzogdGFwVG91Y2hFbmQsCiAgICAndG91Y2hjYW5jZWwnOiB0YXBUb3VjaENhbmNlbCwKICAgICd0b3VjaG1vdmUnOiB0YXBUb3VjaE1vdmUsCgogICAgJ3BvaW50ZXJkb3duJzogdGFwVG91Y2hTdGFydCwKICAgICdwb2ludGVydXAnOiB0YXBUb3VjaEVuZCwKICAgICdwb2ludGVyY2FuY2VsJzogdGFwVG91Y2hDYW5jZWwsCiAgICAncG9pbnRlcm1vdmUnOiB0YXBUb3VjaE1vdmUsCgogICAgJ01TUG9pbnRlckRvd24nOiB0YXBUb3VjaFN0YXJ0LAogICAgJ01TUG9pbnRlclVwJzogdGFwVG91Y2hFbmQsCiAgICAnTVNQb2ludGVyQ2FuY2VsJzogdGFwVG91Y2hDYW5jZWwsCiAgICAnTVNQb2ludGVyTW92ZSc6IHRhcFRvdWNoTW92ZSwKCiAgICAnZm9jdXNpbic6IHRhcEZvY3VzSW4sCiAgICAnZm9jdXNvdXQnOiB0YXBGb2N1c091dAogIH07CgogIGlvbmljLnRhcCA9IHsKCiAgICByZWdpc3RlcjogZnVuY3Rpb24oZWxlKSB7CiAgICAgIHRhcERvYyA9IGVsZTsKCiAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdHJ1ZSwgdHJ1ZSk7CiAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnKTsKICAgICAgdGFwRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJyk7CgogICAgICBpZiggd2luZG93Lm5hdmlnYXRvci5wb2ludGVyRW5hYmxlZCApIHsKICAgICAgICB0YXBFdmVudExpc3RlbmVyKCdwb2ludGVyZG93bicpOwogICAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJ1cCcpOwogICAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ3BvaW50Y2FuY2VsJyk7CiAgICAgICAgdGFwVG91Y2hNb3ZlTGlzdGVuZXIgPSAncG9pbnRlcm1vdmUnOwoKICAgICAgfSBlbHNlIGlmICh3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQpIHsKICAgICAgICB0YXBFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJEb3duJyk7CiAgICAgICAgdGFwRXZlbnRMaXN0ZW5lcignTVNQb2ludGVyVXAnKTsKICAgICAgICB0YXBFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJDYW5jZWwnKTsKICAgICAgICB0YXBUb3VjaE1vdmVMaXN0ZW5lciA9ICdNU1BvaW50ZXJNb3ZlJzsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGFwRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcpOwogICAgICAgIHRhcEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJyk7CiAgICAgICAgdGFwRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnKTsKICAgICAgfQoKICAgICAgdGFwRXZlbnRMaXN0ZW5lcignZm9jdXNpbicpOwogICAgICB0YXBFdmVudExpc3RlbmVyKCdmb2N1c291dCcpOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIGZvcih2YXIgdHlwZSBpbiB0YXBFdmVudExpc3RlbmVycykgewogICAgICAgICAgdGFwRXZlbnRMaXN0ZW5lcih0eXBlLCBmYWxzZSk7CiAgICAgICAgfQogICAgICAgIHRhcERvYyA9IG51bGw7CiAgICAgICAgdGFwQWN0aXZlRWxlID0gbnVsbDsKICAgICAgICB0YXBFbmFibGVkVG91Y2hFdmVudHMgPSBmYWxzZTsKICAgICAgICB0YXBQb2ludGVyTW92ZWQgPSBmYWxzZTsKICAgICAgICB0YXBQb2ludGVyU3RhcnQgPSBudWxsOwogICAgICB9OwogICAgfSwKCiAgICBpZ25vcmVTY3JvbGxTdGFydDogZnVuY3Rpb24oZSkgewogICAgICByZXR1cm4gKGUuZGVmYXVsdFByZXZlbnRlZCkgfHwgIC8vIGRlZmF1bHRQcmV2ZW50ZWQgaGFzIGJlZW4gYXNzaWduZWQgYnkgYW5vdGhlciBjb21wb25lbnQgaGFuZGxpbmcgdGhlIGV2ZW50CiAgICAgICAgKGUudGFyZ2V0LmlzQ29udGVudEVkaXRhYmxlKSB8fAogICAgICAgICgvXihmaWxlfHJhbmdlKSQvaSkudGVzdChlLnRhcmdldC50eXBlKSB8fAogICAgICAgIChlLnRhcmdldC5kYXRhc2V0ID8gZS50YXJnZXQuZGF0YXNldC5wcmV2ZW50U2Nyb2xsIDogZS50YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLXByZXZlbnQtZGVmYXVsdCcpKSA9PSAndHJ1ZScgfHwgLy8gbWFudWFsbHkgc2V0IHdpdGhpbiBhbiBlbGVtZW50cyBhdHRyaWJ1dGVzCiAgICAgICAgKCEhKC9eKG9iamVjdHxlbWJlZCkkL2kpLnRlc3QoZS50YXJnZXQudGFnTmFtZSkpIHx8ICAvLyBmbGFzaC9tb3ZpZS9vYmplY3QgdG91Y2hlcyBzaG91bGQgbm90IHRyeSB0byBzY3JvbGwKICAgICAgICBpb25pYy50YXAuaXNFbGVtZW50VGFwRGlzYWJsZWQoZS50YXJnZXQpOyAvLyBjaGVjayBpZiB0aGlzIGVsZW1lbnQsIG9yIGFuIGFuY2VzdG9yLCBoYXMgYGRhdGEtdGFwLWRpc2FibGVkYCBhdHRyaWJ1dGUKICAgIH0sCgogICAgaXNUZXh0SW5wdXQ6IGZ1bmN0aW9uKGVsZSkgewogICAgICByZXR1cm4gISFlbGUgJiYKICAgICAgICAoZWxlLnRhZ05hbWUgPT0gJ1RFWFRBUkVBJyB8fAogICAgICAgICAgZWxlLmNvbnRlbnRFZGl0YWJsZSA9PT0gJ3RydWUnIHx8CiAgICAgICAgICAoZWxlLnRhZ05hbWUgPT0gJ0lOUFVUJyAmJiAhKC9eKHJhZGlvfGNoZWNrYm94fHJhbmdlfGZpbGV8c3VibWl0fHJlc2V0KSQvaSkudGVzdChlbGUudHlwZSkpICk7CiAgICB9LAoKICAgIGlzRGF0ZUlucHV0OiBmdW5jdGlvbihlbGUpIHsKICAgICAgcmV0dXJuICEhZWxlICYmCiAgICAgICAgKGVsZS50YWdOYW1lID09ICdJTlBVVCcgJiYgKC9eKGRhdGV8dGltZXxkYXRldGltZS1sb2NhbHxtb250aHx3ZWVrKSQvaSkudGVzdChlbGUudHlwZSkpOwogICAgfSwKCiAgICBpc0xhYmVsV2l0aFRleHRJbnB1dDogZnVuY3Rpb24oZWxlKSB7CiAgICAgIHZhciBjb250YWluZXIgPSB0YXBDb250YWluaW5nRWxlbWVudChlbGUsIGZhbHNlKTsKCiAgICAgIHJldHVybiAhIWNvbnRhaW5lciAmJgogICAgICAgIGlvbmljLnRhcC5pc1RleHRJbnB1dCggdGFwVGFyZ2V0RWxlbWVudCggY29udGFpbmVyICkgKTsKICAgIH0sCgogICAgY29udGFpbnNPcklzVGV4dElucHV0OiBmdW5jdGlvbihlbGUpIHsKICAgICAgcmV0dXJuIGlvbmljLnRhcC5pc1RleHRJbnB1dChlbGUpIHx8IGlvbmljLnRhcC5pc0xhYmVsV2l0aFRleHRJbnB1dChlbGUpOwogICAgfSwKCiAgICBjbG9uZUZvY3VzZWRJbnB1dDogZnVuY3Rpb24oY29udGFpbmVyLCBzY3JvbGxJbnRhbmNlKSB7CiAgICAgIGlmKGlvbmljLnRhcC5oYXNDaGVja2VkQ2xvbmUpIHJldHVybjsKICAgICAgaW9uaWMudGFwLmhhc0NoZWNrZWRDbG9uZSA9IHRydWU7CgogICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgZm9jdXNJbnB1dCA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKCc6Zm9jdXMnKTsKICAgICAgICBpZiggaW9uaWMudGFwLmlzVGV4dElucHV0KGZvY3VzSW5wdXQpICkgewogICAgICAgICAgdmFyIGNsb25lZElucHV0ID0gZm9jdXNJbnB1dC5wYXJlbnRFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5jbG9uZWQtdGV4dC1pbnB1dCcpOwogICAgICAgICAgaWYoIWNsb25lZElucHV0KSB7CiAgICAgICAgICAgIGNsb25lZElucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChmb2N1c0lucHV0LnRhZ05hbWUpOwogICAgICAgICAgICBjbG9uZWRJbnB1dC5wbGFjZWhvbGRlciA9IGZvY3VzSW5wdXQucGxhY2Vob2xkZXI7CiAgICAgICAgICAgIGNsb25lZElucHV0LnR5cGUgPSBmb2N1c0lucHV0LnR5cGU7CiAgICAgICAgICAgIGNsb25lZElucHV0LnZhbHVlID0gZm9jdXNJbnB1dC52YWx1ZTsKICAgICAgICAgICAgY2xvbmVkSW5wdXQuc3R5bGUgPSBmb2N1c0lucHV0LnN0eWxlOwogICAgICAgICAgICBjbG9uZWRJbnB1dC5jbGFzc05hbWUgPSBmb2N1c0lucHV0LmNsYXNzTmFtZTsKICAgICAgICAgICAgY2xvbmVkSW5wdXQuY2xhc3NMaXN0LmFkZCgnY2xvbmVkLXRleHQtaW5wdXQnKTsKICAgICAgICAgICAgY2xvbmVkSW5wdXQucmVhZE9ubHkgPSB0cnVlOwogICAgICAgICAgICBmb2N1c0lucHV0LnBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNsb25lZElucHV0LCBmb2N1c0lucHV0KTsKICAgICAgICAgICAgZm9jdXNJbnB1dC5zdHlsZS50b3AgPSBmb2N1c0lucHV0Lm9mZnNldFRvcDsKICAgICAgICAgICAgZm9jdXNJbnB1dC5jbGFzc0xpc3QuYWRkKCdwcmV2aW91cy1pbnB1dC1mb2N1cycpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIGhhc0NoZWNrZWRDbG9uZTogZmFsc2UsCgogICAgcmVtb3ZlQ2xvbmVkSW5wdXRzOiBmdW5jdGlvbihjb250YWluZXIsIHNjcm9sbEludGFuY2UpIHsKICAgICAgaW9uaWMudGFwLmhhc0NoZWNrZWRDbG9uZSA9IGZhbHNlOwoKICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGNsb25lZElucHV0cyA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yQWxsKCcuY2xvbmVkLXRleHQtaW5wdXQnKTsKICAgICAgICB2YXIgcHJldmlvdXNJbnB1dEZvY3VzID0gY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3JBbGwoJy5wcmV2aW91cy1pbnB1dC1mb2N1cycpOwogICAgICAgIHZhciB4OwoKICAgICAgICBmb3IoeD0wOyB4PGNsb25lZElucHV0cy5sZW5ndGg7IHgrKykgewogICAgICAgICAgY2xvbmVkSW5wdXRzW3hdLnBhcmVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoIGNsb25lZElucHV0c1t4XSApOwogICAgICAgIH0KCiAgICAgICAgZm9yKHg9MDsgeDxwcmV2aW91c0lucHV0Rm9jdXMubGVuZ3RoOyB4KyspIHsKICAgICAgICAgIHByZXZpb3VzSW5wdXRGb2N1c1t4XS5jbGFzc0xpc3QucmVtb3ZlKCdwcmV2aW91cy1pbnB1dC1mb2N1cycpOwogICAgICAgICAgcHJldmlvdXNJbnB1dEZvY3VzW3hdLnN0eWxlLnRvcCA9ICcnOwogICAgICAgICAgcHJldmlvdXNJbnB1dEZvY3VzW3hdLmZvY3VzKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgcmVxdWlyZXNOYXRpdmVDbGljazogZnVuY3Rpb24oZWxlKSB7CiAgICAgIGlmKCFlbGUgfHwgZWxlLmRpc2FibGVkIHx8ICgvXihmaWxlfHJhbmdlKSQvaSkudGVzdChlbGUudHlwZSkgfHwgKC9eKG9iamVjdHx2aWRlbykkL2kpLnRlc3QoZWxlLnRhZ05hbWUpIHx8IGlvbmljLnRhcC5pc0xhYmVsQ29udGFpbmluZ0ZpbGVJbnB1dChlbGUpICkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBpb25pYy50YXAuaXNFbGVtZW50VGFwRGlzYWJsZWQoZWxlKTsKICAgIH0sCgogICAgaXNMYWJlbENvbnRhaW5pbmdGaWxlSW5wdXQ6IGZ1bmN0aW9uKGVsZSkgewogICAgICB2YXIgbGJsID0gdGFwQ29udGFpbmluZ0VsZW1lbnQoZWxlKTsKICAgICAgaWYobGJsLnRhZ05hbWUgIT09ICdMQUJFTCcpIHJldHVybiBmYWxzZTsKICAgICAgdmFyIGZpbGVJbnB1dCA9IGxibC5xdWVyeVNlbGVjdG9yKCdpbnB1dFt0eXBlPWZpbGVdJyk7CiAgICAgIGlmKGZpbGVJbnB1dCAmJiBmaWxlSW5wdXQuZGlzYWJsZWQgPT09IGZhbHNlKSByZXR1cm4gdHJ1ZTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICBpc0VsZW1lbnRUYXBEaXNhYmxlZDogZnVuY3Rpb24oZWxlKSB7CiAgICAgIGlmKGVsZSAmJiBlbGUubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICB2YXIgZWxlbWVudCA9IGVsZTsKICAgICAgICB3aGlsZShlbGVtZW50KSB7CiAgICAgICAgICBpZiggKGVsZW1lbnQuZGF0YXNldCA/IGVsZW1lbnQuZGF0YXNldC50YXBEaXNhYmxlZCA6IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLXRhcC1kaXNhYmxlZCcpKSA9PSAndHJ1ZScgKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50RWxlbWVudDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICBzZXRUb2xlcmFuY2U6IGZ1bmN0aW9uKHJlbGVhc2VUb2xlcmFuY2UsIHJlbGVhc2VCdXR0b25Ub2xlcmFuY2UpIHsKICAgICAgVEFQX1JFTEVBU0VfVE9MRVJBTkNFID0gcmVsZWFzZVRvbGVyYW5jZTsKICAgICAgVEFQX1JFTEVBU0VfQlVUVE9OX1RPTEVSQU5DRSA9IHJlbGVhc2VCdXR0b25Ub2xlcmFuY2U7CiAgICB9LAoKICAgIGNhbmNlbENsaWNrOiBmdW5jdGlvbigpIHsKICAgICAgLy8gdXNlZCB0byBjYW5jZWwgYW55IHNpbXVsYXRlZCBjbGlja3Mgd2hpY2ggbWF5IGhhcHBlbiBvbiBhIHRvdWNoZW5kL21vdXNldXAKICAgICAgLy8gZ2VzdHVyZXMgdXNlcyB0aGlzIG1ldGhvZCB3aXRoaW4gaXRzIHRhcCBhbmQgaG9sZCBldmVudHMKICAgICAgdGFwUG9pbnRlck1vdmVkID0gdHJ1ZTsKICAgIH0KCiAgfTsKCiAgZnVuY3Rpb24gdGFwRXZlbnRMaXN0ZW5lcih0eXBlLCBlbmFibGUsIHVzZUNhcHR1cmUpIHsKICAgIGlmKGVuYWJsZSAhPT0gZmFsc2UpIHsKICAgICAgdGFwRG9jLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgdGFwRXZlbnRMaXN0ZW5lcnNbdHlwZV0sIHVzZUNhcHR1cmUpOwogICAgfSBlbHNlIHsKICAgICAgdGFwRG9jLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgdGFwRXZlbnRMaXN0ZW5lcnNbdHlwZV0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdGFwQ2xpY2soZSkgewogICAgLy8gc2ltdWxhdGUgYSBub3JtYWwgY2xpY2sgYnkgcnVubmluZyB0aGUgZWxlbWVudCdzIGNsaWNrIG1ldGhvZCB0aGVuIGZvY3VzIG9uIGl0CiAgICB2YXIgY29udGFpbmVyID0gdGFwQ29udGFpbmluZ0VsZW1lbnQoZS50YXJnZXQpOwogICAgdmFyIGVsZSA9IHRhcFRhcmdldEVsZW1lbnQoY29udGFpbmVyKTsKCiAgICBpZiggaW9uaWMudGFwLnJlcXVpcmVzTmF0aXZlQ2xpY2soZWxlKSB8fCB0YXBQb2ludGVyTW92ZWQgKSByZXR1cm4gZmFsc2U7CgogICAgdmFyIGMgPSBnZXRQb2ludGVyQ29vcmRpbmF0ZXMoZSk7CgogICAgdm9pZCAwOwogICAgdHJpZ2dlck1vdXNlRXZlbnQoJ2NsaWNrJywgZWxlLCBjLngsIGMueSk7CgogICAgLy8gaWYgaXQncyBhbiBpbnB1dCwgZm9jdXMgaW4gb24gdGhlIHRhcmdldCwgb3RoZXJ3aXNlIGJsdXIKICAgIHRhcEhhbmRsZUZvY3VzKGVsZSk7CiAgfQoKICBmdW5jdGlvbiB0cmlnZ2VyTW91c2VFdmVudCh0eXBlLCBlbGUsIHgsIHkpIHsKICAgIC8vIHVzaW5nIGluaXRNb3VzZUV2ZW50IGluc3RlYWQgb2YgTW91c2VFdmVudCBmb3Igb3VyIEFuZHJvaWQgZnJpZW5kcwogICAgdmFyIGNsaWNrRXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiTW91c2VFdmVudHMiKTsKICAgIGNsaWNrRXZlbnQuaW5pdE1vdXNlRXZlbnQodHlwZSwgdHJ1ZSwgdHJ1ZSwgd2luZG93LCAxLCAwLCAwLCB4LCB5LCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgbnVsbCk7CiAgICBjbGlja0V2ZW50LmlzSW9uaWNUYXAgPSB0cnVlOwogICAgZWxlLmRpc3BhdGNoRXZlbnQoY2xpY2tFdmVudCk7CiAgfQoKICBmdW5jdGlvbiB0YXBDbGlja0dhdGVLZWVwZXIoZSkgewogICAgaWYoZS50YXJnZXQudHlwZSA9PSAnc3VibWl0JyAmJiBlLmRldGFpbCA9PT0gMCkgewogICAgICAvLyBkbyBub3QgcHJldmVudCBjbGljayBpZiBpdCBjYW1lIGZyb20gYW4gIkVudGVyIiBvciAiR28iIGtleXByZXNzIHN1Ym1pdAogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gZG8gbm90IGFsbG93IHRocm91Z2ggYW55IGNsaWNrIGV2ZW50cyB0aGF0IHdlcmUgbm90IGNyZWF0ZWQgYnkgaW9uaWMudGFwCiAgICBpZiggKGlvbmljLnNjcm9sbC5pc1Njcm9sbGluZyAmJiBpb25pYy50YXAuY29udGFpbnNPcklzVGV4dElucHV0KGUudGFyZ2V0KSApIHx8CiAgICAgICghZS5pc0lvbmljVGFwICYmICFpb25pYy50YXAucmVxdWlyZXNOYXRpdmVDbGljayhlLnRhcmdldCkpICkgewogICAgICB2b2lkIDA7CiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CgogICAgICBpZiggIWlvbmljLnRhcC5pc0xhYmVsV2l0aFRleHRJbnB1dChlLnRhcmdldCkgKSB7CiAgICAgICAgLy8gbGFiZWxzIGNsaWNrcyBmcm9tIG5hdGl2ZSBzaG91bGQgbm90IHByZXZlbnREZWZhdWx0IG90aGVyc2l6ZSBrZXlib2FyZCB3aWxsIG5vdCBzaG93IG9uIGlucHV0IGZvY3VzCiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CgovLyBNT1VTRQogIGZ1bmN0aW9uIHRhcE1vdXNlRG93bihlKSB7CiAgICBpZihlLmlzSW9uaWNUYXAgfHwgdGFwSWdub3JlRXZlbnQoZSkpIHJldHVybjsKCiAgICBpZih0YXBFbmFibGVkVG91Y2hFdmVudHMpIHsKICAgICAgdm9pZCAwOwogICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwoKICAgICAgaWYoICghaW9uaWMudGFwLmlzVGV4dElucHV0KGUudGFyZ2V0KSB8fCB0YXBMYXN0VG91Y2hUYXJnZXQgIT09IGUudGFyZ2V0KSAmJiAhKC9eKHNlbGVjdHxvcHRpb24pJC9pKS50ZXN0KGUudGFyZ2V0LnRhZ05hbWUpICkgewogICAgICAgIC8vIElmIHlvdSBwcmV2ZW50RGVmYXVsdCBvbiBhIHRleHQgaW5wdXQgdGhlbiB5b3UgY2Fubm90IG1vdmUgaXRzIHRleHQgY2FyZXQvY3Vyc29yLgogICAgICAgIC8vIEFsbG93IHRocm91Z2ggb25seSB0aGUgdGV4dCBpbnB1dCBkZWZhdWx0LiBIb3dldmVyLCB3aXRob3V0IHByZXZlbnREZWZhdWx0IG9uIGFuCiAgICAgICAgLy8gaW5wdXQgdGhlIDMwMG1zIGRlbGF5IGNhbiBjaGFuZ2UgZm9jdXMgb24gaW5wdXRzIGFmdGVyIHRoZSBrZXlib2FyZCBzaG93cyB1cC4KICAgICAgICAvLyBUaGUgZm9jdXNpbiBldmVudCBoYW5kbGVzIHRoZSBjaGFuY2Ugb2YgZm9jdXMgY2hhbmdpbmcgYWZ0ZXIgdGhlIGtleWJvYXJkIHNob3dzLgogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHRhcFBvaW50ZXJNb3ZlZCA9IGZhbHNlOwogICAgdGFwUG9pbnRlclN0YXJ0ID0gZ2V0UG9pbnRlckNvb3JkaW5hdGVzKGUpOwoKICAgIHRhcEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScpOwogICAgaW9uaWMuYWN0aXZhdG9yLnN0YXJ0KGUpOwogIH0KCiAgZnVuY3Rpb24gdGFwTW91c2VVcChlKSB7CiAgICBpZih0YXBFbmFibGVkVG91Y2hFdmVudHMpIHsKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYoIHRhcElnbm9yZUV2ZW50KGUpIHx8ICgvXihzZWxlY3R8b3B0aW9uKSQvaSkudGVzdChlLnRhcmdldC50YWdOYW1lKSApIHJldHVybiBmYWxzZTsKCiAgICBpZiggIXRhcEhhc1BvaW50ZXJNb3ZlZChlKSApIHsKICAgICAgdGFwQ2xpY2soZSk7CiAgICB9CiAgICB0YXBFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBmYWxzZSk7CiAgICBpb25pYy5hY3RpdmF0b3IuZW5kKCk7CiAgICB0YXBQb2ludGVyTW92ZWQgPSBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIHRhcE1vdXNlTW92ZShlKSB7CiAgICBpZiggdGFwSGFzUG9pbnRlck1vdmVkKGUpICkgewogICAgICB0YXBFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBmYWxzZSk7CiAgICAgIGlvbmljLmFjdGl2YXRvci5lbmQoKTsKICAgICAgdGFwUG9pbnRlck1vdmVkID0gdHJ1ZTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCgovLyBUT1VDSAogIGZ1bmN0aW9uIHRhcFRvdWNoU3RhcnQoZSkgewogICAgaWYoIHRhcElnbm9yZUV2ZW50KGUpICkgcmV0dXJuOwoKICAgIHRhcFBvaW50ZXJNb3ZlZCA9IGZhbHNlOwoKICAgIHRhcEVuYWJsZVRvdWNoRXZlbnRzKCk7CiAgICB0YXBQb2ludGVyU3RhcnQgPSBnZXRQb2ludGVyQ29vcmRpbmF0ZXMoZSk7CgogICAgdGFwRXZlbnRMaXN0ZW5lcih0YXBUb3VjaE1vdmVMaXN0ZW5lcik7CiAgICBpb25pYy5hY3RpdmF0b3Iuc3RhcnQoZSk7CgogICAgaWYoIGlvbmljLlBsYXRmb3JtLmlzSU9TKCkgJiYgaW9uaWMudGFwLmlzTGFiZWxXaXRoVGV4dElucHV0KGUudGFyZ2V0KSApIHsKICAgICAgLy8gaWYgdGhlIHRhcHBlZCBlbGVtZW50IGlzIGEgbGFiZWwsIHdoaWNoIGhhcyBhIGNoaWxkIGlucHV0CiAgICAgIC8vIHRoZW4gcHJldmVudERlZmF1bHQgc28gaU9TIGRvZXNuJ3QgdWdseSBhdXRvIHNjcm9sbCB0byB0aGUgaW5wdXQKICAgICAgLy8gYnV0IGRvIG5vdCBwcmV2ZW50IGRlZmF1bHQgb24gQW5kcm9pZCBvciBlbHNlIHlvdSBjYW5ub3QgbW92ZSB0aGUgdGV4dCBjYXJldAogICAgICAvLyBhbmQgZG8gbm90IHByZXZlbnQgZGVmYXVsdCBvbiBBbmRyb2lkIG9yIGVsc2Ugbm8gdmlydHVhbCBrZXlib2FyZCBzaG93cyB1cAoKICAgICAgdmFyIHRleHRJbnB1dCA9IHRhcFRhcmdldEVsZW1lbnQoIHRhcENvbnRhaW5pbmdFbGVtZW50KGUudGFyZ2V0KSApOwogICAgICBpZiggdGV4dElucHV0ICE9PSB0YXBBY3RpdmVFbGUgKSB7CiAgICAgICAgLy8gZG9uJ3QgcHJldmVudERlZmF1bHQgb24gYW4gYWxyZWFkeSBmb2N1c2VkIGlucHV0IG9yIGVsc2UgaU9TJ3MgdGV4dCBjYXJldCBpc24ndCB1c2FibGUKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHRhcFRvdWNoRW5kKGUpIHsKICAgIGlmKCB0YXBJZ25vcmVFdmVudChlKSApIHJldHVybjsKCiAgICB0YXBFbmFibGVUb3VjaEV2ZW50cygpOwogICAgaWYoICF0YXBIYXNQb2ludGVyTW92ZWQoZSkgKSB7CiAgICAgIHRhcENsaWNrKGUpOwoKICAgICAgaWYoICgvXihzZWxlY3R8b3B0aW9uKSQvaSkudGVzdChlLnRhcmdldC50YWdOYW1lKSApIHsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KICAgIH0KCiAgICB0YXBMYXN0VG91Y2hUYXJnZXQgPSBlLnRhcmdldDsKICAgIHRhcFRvdWNoQ2FuY2VsKCk7CiAgfQoKICBmdW5jdGlvbiB0YXBUb3VjaE1vdmUoZSkgewogICAgaWYoIHRhcEhhc1BvaW50ZXJNb3ZlZChlKSApIHsKICAgICAgdGFwUG9pbnRlck1vdmVkID0gdHJ1ZTsKICAgICAgdGFwRXZlbnRMaXN0ZW5lcih0YXBUb3VjaE1vdmVMaXN0ZW5lciwgZmFsc2UpOwogICAgICBpb25pYy5hY3RpdmF0b3IuZW5kKCk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHRhcFRvdWNoQ2FuY2VsKGUpIHsKICAgIHRhcEV2ZW50TGlzdGVuZXIodGFwVG91Y2hNb3ZlTGlzdGVuZXIsIGZhbHNlKTsKICAgIGlvbmljLmFjdGl2YXRvci5lbmQoKTsKICAgIHRhcFBvaW50ZXJNb3ZlZCA9IGZhbHNlOwogIH0KCiAgZnVuY3Rpb24gdGFwRW5hYmxlVG91Y2hFdmVudHMoKSB7CiAgICB0YXBFbmFibGVkVG91Y2hFdmVudHMgPSB0cnVlOwogICAgY2xlYXJUaW1lb3V0KHRhcE1vdXNlUmVzZXRUaW1lcik7CiAgICB0YXBNb3VzZVJlc2V0VGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgIHRhcEVuYWJsZWRUb3VjaEV2ZW50cyA9IGZhbHNlOwogICAgfSwgMjAwMCk7CiAgfQoKICBmdW5jdGlvbiB0YXBJZ25vcmVFdmVudChlKSB7CiAgICBpZihlLmlzVGFwSGFuZGxlZCkgcmV0dXJuIHRydWU7CiAgICBlLmlzVGFwSGFuZGxlZCA9IHRydWU7CgogICAgaWYoIGlvbmljLnNjcm9sbC5pc1Njcm9sbGluZyAmJiBpb25pYy50YXAuY29udGFpbnNPcklzVGV4dElucHV0KGUudGFyZ2V0KSApIHsKICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHRhcEhhbmRsZUZvY3VzKGVsZSkgewogICAgdGFwVG91Y2hGb2N1c2VkSW5wdXQgPSBudWxsOwoKICAgIHZhciB0cmlnZ2VyRm9jdXNJbiA9IGZhbHNlOwoKICAgIGlmKGVsZS50YWdOYW1lID09ICdTRUxFQ1QnKSB7CiAgICAgIC8vIHRyaWNrIHRvIGZvcmNlIEFuZHJvaWQgb3B0aW9ucyB0byBzaG93IHVwCiAgICAgIHRyaWdnZXJNb3VzZUV2ZW50KCdtb3VzZWRvd24nLCBlbGUsIDAsIDApOwogICAgICBlbGUuZm9jdXMgJiYgZWxlLmZvY3VzKCk7CiAgICAgIHRyaWdnZXJGb2N1c0luID0gdHJ1ZTsKCiAgICB9IGVsc2UgaWYodGFwQWN0aXZlRWxlbWVudCgpID09PSBlbGUpIHsKICAgICAgLy8gYWxyZWFkeSBpcyB0aGUgYWN0aXZlIGVsZW1lbnQgYW5kIGhhcyBmb2N1cwogICAgICB0cmlnZ2VyRm9jdXNJbiA9IHRydWU7CgogICAgfSBlbHNlIGlmKCAoL14oaW5wdXR8dGV4dGFyZWEpJC9pKS50ZXN0KGVsZS50YWdOYW1lKSApIHsKICAgICAgdHJpZ2dlckZvY3VzSW4gPSB0cnVlOwogICAgICBlbGUuZm9jdXMgJiYgZWxlLmZvY3VzKCk7CiAgICAgIGVsZS52YWx1ZSA9IGVsZS52YWx1ZTsKICAgICAgaWYoIHRhcEVuYWJsZWRUb3VjaEV2ZW50cyApIHsKICAgICAgICB0YXBUb3VjaEZvY3VzZWRJbnB1dCA9IGVsZTsKICAgICAgfQoKICAgIH0gZWxzZSB7CiAgICAgIHRhcEZvY3VzT3V0QWN0aXZlKCk7CiAgICB9CgogICAgaWYodHJpZ2dlckZvY3VzSW4pIHsKICAgICAgdGFwQWN0aXZlRWxlbWVudChlbGUpOwogICAgICBpb25pYy50cmlnZ2VyKCdpb25pYy5mb2N1c2luJywgewogICAgICAgIHRhcmdldDogZWxlCiAgICAgIH0sIHRydWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdGFwRm9jdXNPdXRBY3RpdmUoKSB7CiAgICB2YXIgZWxlID0gdGFwQWN0aXZlRWxlbWVudCgpOwogICAgaWYoZWxlICYmICgvXihpbnB1dHx0ZXh0YXJlYXxzZWxlY3QpJC9pKS50ZXN0KGVsZS50YWdOYW1lKSApIHsKICAgICAgdm9pZCAwOwogICAgICBlbGUuYmx1cigpOwogICAgfQogICAgdGFwQWN0aXZlRWxlbWVudChudWxsKTsKICB9CgogIGZ1bmN0aW9uIHRhcEZvY3VzSW4oZSkgewogICAgLy8gQmVjYXVzZSBhIHRleHQgaW5wdXQgZG9lc24ndCBwcmV2ZW50RGVmYXVsdCAoc28gdGhlIGNhcmV0IHN0aWxsIHdvcmtzKSB0aGVyZSdzIGEgY2hhbmNlCiAgICAvLyB0aGF0IGl0J3MgbW91c2Vkb3duIGV2ZW50IDMwMG1zIGxhdGVyIHdpbGwgY2hhbmdlIHRoZSBmb2N1cyB0byBhbm90aGVyIGVsZW1lbnQgYWZ0ZXIKICAgIC8vIHRoZSBrZXlib2FyZCBzaG93cyB1cC4KCiAgICBpZiggdGFwRW5hYmxlZFRvdWNoRXZlbnRzICYmCiAgICAgIGlvbmljLnRhcC5pc1RleHRJbnB1dCggdGFwQWN0aXZlRWxlbWVudCgpICkgJiYKICAgICAgaW9uaWMudGFwLmlzVGV4dElucHV0KHRhcFRvdWNoRm9jdXNlZElucHV0KSAmJgogICAgICB0YXBUb3VjaEZvY3VzZWRJbnB1dCAhPT0gZS50YXJnZXQgKSB7CgogICAgICAvLyAxKSBUaGUgcG9pbnRlciBpcyBmcm9tIHRvdWNoIGV2ZW50cwogICAgICAvLyAyKSBUaGVyZSBpcyBhbiBhY3RpdmUgZWxlbWVudCB3aGljaCBpcyBhIHRleHQgaW5wdXQKICAgICAgLy8gMykgQSB0ZXh0IGlucHV0IHdhcyBqdXN0IHNldCB0byBiZSBmb2N1c2VkIG9uIGJ5IGEgdG91Y2ggZXZlbnQKICAgICAgLy8gNCkgQSBuZXcgZm9jdXMgaGFzIGJlZW4gc2V0LCBob3dldmVyIHRoZSB0YXJnZXQgaXNuJ3QgdGhlIG9uZSB0aGUgdG91Y2ggZXZlbnQgd2FudGVkCiAgICAgIHZvaWQgMDsKICAgICAgdGFwVG91Y2hGb2N1c2VkSW5wdXQuZm9jdXMoKTsKICAgICAgdGFwVG91Y2hGb2N1c2VkSW5wdXQgPSBudWxsOwogICAgfQogICAgaW9uaWMuc2Nyb2xsLmlzU2Nyb2xsaW5nID0gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiB0YXBGb2N1c091dCgpIHsKICAgIHRhcEFjdGl2ZUVsZW1lbnQobnVsbCk7CiAgfQoKICBmdW5jdGlvbiB0YXBBY3RpdmVFbGVtZW50KGVsZSkgewogICAgaWYoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICB0YXBBY3RpdmVFbGUgPSBlbGU7CiAgICB9CiAgICByZXR1cm4gdGFwQWN0aXZlRWxlIHx8IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7CiAgfQoKICBmdW5jdGlvbiB0YXBIYXNQb2ludGVyTW92ZWQoZW5kRXZlbnQpIHsKICAgIGlmKCFlbmRFdmVudCB8fCBlbmRFdmVudC50YXJnZXQubm9kZVR5cGUgIT09IDEgfHwgIXRhcFBvaW50ZXJTdGFydCB8fCAoIHRhcFBvaW50ZXJTdGFydC54ID09PSAwICYmIHRhcFBvaW50ZXJTdGFydC55ID09PSAwICkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdmFyIGVuZENvb3JkaW5hdGVzID0gZ2V0UG9pbnRlckNvb3JkaW5hdGVzKGVuZEV2ZW50KTsKCiAgICB2YXIgaGFzQ2xhc3NMaXN0ID0gISEoZW5kRXZlbnQudGFyZ2V0LmNsYXNzTGlzdCAmJiBlbmRFdmVudC50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKTsKICAgIHZhciByZWxlYXNlVG9sZXJhbmNlID0gaGFzQ2xhc3NMaXN0ICYgZW5kRXZlbnQudGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygnYnV0dG9uJykgPwogICAgICBUQVBfUkVMRUFTRV9CVVRUT05fVE9MRVJBTkNFIDoKICAgICAgVEFQX1JFTEVBU0VfVE9MRVJBTkNFOwoKICAgIHJldHVybiBNYXRoLmFicyh0YXBQb2ludGVyU3RhcnQueCAtIGVuZENvb3JkaW5hdGVzLngpID4gcmVsZWFzZVRvbGVyYW5jZSB8fAogICAgICBNYXRoLmFicyh0YXBQb2ludGVyU3RhcnQueSAtIGVuZENvb3JkaW5hdGVzLnkpID4gcmVsZWFzZVRvbGVyYW5jZTsKICB9CgogIGZ1bmN0aW9uIGdldFBvaW50ZXJDb29yZGluYXRlcyhldmVudCkgewogICAgLy8gVGhpcyBtZXRob2QgY2FuIGdldCBjb29yZGluYXRlcyBmb3IgYm90aCBhIG1vdXNlIGNsaWNrCiAgICAvLyBvciBhIHRvdWNoIGRlcGVuZGluZyBvbiB0aGUgZ2l2ZW4gZXZlbnQKICAgIHZhciBjID0geyB4OjAsIHk6MCB9OwogICAgaWYoZXZlbnQpIHsKICAgICAgdmFyIHRvdWNoZXMgPSBldmVudC50b3VjaGVzICYmIGV2ZW50LnRvdWNoZXMubGVuZ3RoID8gZXZlbnQudG91Y2hlcyA6IFtldmVudF07CiAgICAgIHZhciBlID0gKGV2ZW50LmNoYW5nZWRUb3VjaGVzICYmIGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdKSB8fCB0b3VjaGVzWzBdOwogICAgICBpZihlKSB7CiAgICAgICAgYy54ID0gZS5jbGllbnRYIHx8IGUucGFnZVggfHwgMDsKICAgICAgICBjLnkgPSBlLmNsaWVudFkgfHwgZS5wYWdlWSB8fCAwOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gYzsKICB9CgogIGZ1bmN0aW9uIHRhcENvbnRhaW5pbmdFbGVtZW50KGVsZSwgYWxsb3dTZWxmKSB7CiAgICB2YXIgY2xpbWJFbGUgPSBlbGU7CiAgICBmb3IodmFyIHg9MDsgeDw2OyB4KyspIHsKICAgICAgaWYoIWNsaW1iRWxlKSBicmVhazsKICAgICAgaWYoY2xpbWJFbGUudGFnTmFtZSA9PT0gJ0xBQkVMJykgcmV0dXJuIGNsaW1iRWxlOwogICAgICBjbGltYkVsZSA9IGNsaW1iRWxlLnBhcmVudEVsZW1lbnQ7CiAgICB9CiAgICBpZihhbGxvd1NlbGYgIT09IGZhbHNlKSByZXR1cm4gZWxlOwogIH0KCiAgZnVuY3Rpb24gdGFwVGFyZ2V0RWxlbWVudChlbGUpIHsKICAgIGlmKGVsZSAmJiBlbGUudGFnTmFtZSA9PT0gJ0xBQkVMJykgewogICAgICBpZihlbGUuY29udHJvbCkgcmV0dXJuIGVsZS5jb250cm9sOwoKICAgICAgLy8gb2xkZXIgZGV2aWNlcyBkbyBub3Qgc3VwcG9ydCB0aGUgImNvbnRyb2wiIHByb3BlcnR5CiAgICAgIGlmKGVsZS5xdWVyeVNlbGVjdG9yKSB7CiAgICAgICAgdmFyIGNvbnRyb2wgPSBlbGUucXVlcnlTZWxlY3RvcignaW5wdXQsdGV4dGFyZWEsc2VsZWN0Jyk7CiAgICAgICAgaWYoY29udHJvbCkgcmV0dXJuIGNvbnRyb2w7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBlbGU7CiAgfQoKICBpb25pYy5Eb21VdGlsLnJlYWR5KGZ1bmN0aW9uKCl7CiAgICB2YXIgbmcgPSB0eXBlb2YgYW5ndWxhciAhPT0gJ3VuZGVmaW5lZCcgPyBhbmd1bGFyIDogbnVsbDsKICAgIC8vZG8gbm90aGluZyBmb3IgZTJlIHRlc3RzCiAgICBpZiAoIW5nIHx8IChuZyAmJiAhbmcuc2NlbmFyaW8pKSB7CiAgICAgIGlvbmljLnRhcC5yZWdpc3Rlcihkb2N1bWVudCk7CiAgICB9CiAgfSk7CgogIChmdW5jdGlvbihkb2N1bWVudCwgaW9uaWMpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICB2YXIgcXVldWVFbGVtZW50cyA9IHt9OyAgIC8vIGVsZW1lbnRzIHRoYXQgc2hvdWxkIGdldCBhbiBhY3RpdmUgc3RhdGUgaW4gWFggbWlsbGlzZWNvbmRzCiAgICB2YXIgYWN0aXZlRWxlbWVudHMgPSB7fTsgIC8vIGVsZW1lbnRzIHRoYXQgYXJlIGN1cnJlbnRseSBhY3RpdmUKICAgIHZhciBrZXlJZCA9IDA7ICAgICAgICAgICAgLy8gYSBjb3VudGVyIGZvciB1bmlxdWUga2V5cyBmb3IgdGhlIGFib3ZlIG9qZWN0cwogICAgdmFyIEFDVElWQVRFRF9DTEFTUyA9ICdhY3RpdmF0ZWQnOwoKICAgIGlvbmljLmFjdGl2YXRvciA9IHsKCiAgICAgIHN0YXJ0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAvLyB3aGVuIGFuIGVsZW1lbnQgaXMgdG91Y2hlZC9jbGlja2VkLCBpdCBjbGltYnMgdXAgYSBmZXcKICAgICAgICAvLyBwYXJlbnRzIHRvIHNlZSBpZiBpdCBpcyBhbiAuaXRlbSBvciAuYnV0dG9uIGVsZW1lbnQKICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICAgIGlmICggaW9uaWMudGFwLnJlcXVpcmVzTmF0aXZlQ2xpY2soZS50YXJnZXQpICkgcmV0dXJuOwogICAgICAgICAgdmFyIGVsZSA9IGUudGFyZ2V0OwogICAgICAgICAgdmFyIGVsZVRvQWN0aXZhdGU7CgogICAgICAgICAgZm9yKHZhciB4PTA7IHg8NDsgeCsrKSB7CiAgICAgICAgICAgIGlmKCFlbGUgfHwgZWxlLm5vZGVUeXBlICE9PSAxKSBicmVhazsKICAgICAgICAgICAgaWYoZWxlVG9BY3RpdmF0ZSAmJiBlbGUuY2xhc3NMaXN0LmNvbnRhaW5zKCdpdGVtJykpIHsKICAgICAgICAgICAgICBlbGVUb0FjdGl2YXRlID0gZWxlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCBlbGUudGFnTmFtZSA9PSAnQScgfHwgZWxlLnRhZ05hbWUgPT0gJ0JVVFRPTicgfHwgZWxlLmhhc0F0dHJpYnV0ZSgnbmctY2xpY2snKSApIHsKICAgICAgICAgICAgICBlbGVUb0FjdGl2YXRlID0gZWxlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKCBlbGUuY2xhc3NMaXN0LmNvbnRhaW5zKCdidXR0b24nKSApIHsKICAgICAgICAgICAgICBlbGVUb0FjdGl2YXRlID0gZWxlOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZSA9IGVsZS5wYXJlbnRFbGVtZW50OwogICAgICAgICAgfQoKICAgICAgICAgIGlmKGVsZVRvQWN0aXZhdGUpIHsKICAgICAgICAgICAgLy8gcXVldWUgdGhhdCB0aGlzIGVsZW1lbnQgc2hvdWxkIGJlIHNldCB0byBhY3RpdmUKICAgICAgICAgICAgcXVldWVFbGVtZW50c1trZXlJZF0gPSBlbGVUb0FjdGl2YXRlOwoKICAgICAgICAgICAgLy8gaW4gWFggbWlsbGlzZWNvbmRzLCBzZXQgdGhlIHF1ZXVlZCBlbGVtZW50cyB0byBhY3RpdmUKICAgICAgICAgICAgaWYoZS50eXBlID09PSAndG91Y2hzdGFydCcpIHsKICAgICAgICAgICAgICBzZWxmLl9hY3RpdmF0ZVRpbWVvdXQgPSBzZXRUaW1lb3V0KGFjdGl2YXRlRWxlbWVudHMsIDgwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYWN0aXZhdGVFbGVtZW50cyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGtleUlkID0gKGtleUlkID4gMTkgPyAwIDoga2V5SWQgKyAxKTsKICAgICAgICAgIH0KCiAgICAgICAgfSk7CiAgICAgIH0sCgogICAgICBlbmQ6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIGNsZWFyIG91dCBhbnkgYWN0aXZlL3F1ZXVlZCBlbGVtZW50cyBhZnRlciBYWCBtaWxsaXNlY29uZHMKICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fYWN0aXZhdGVUaW1lb3V0KTsKICAgICAgICBzZXRUaW1lb3V0KGNsZWFyLCAyMDApOwogICAgICB9CgogICAgfTsKCiAgICBmdW5jdGlvbiBjbGVhcigpIHsKICAgICAgLy8gY2xlYXIgb3V0IGFueSBlbGVtZW50cyB0aGF0IGFyZSBxdWV1ZWQgdG8gYmUgc2V0IHRvIGFjdGl2ZQogICAgICBxdWV1ZUVsZW1lbnRzID0ge307CgogICAgICAvLyBpbiB0aGUgbmV4dCBmcmFtZSwgcmVtb3ZlIHRoZSBhY3RpdmUgY2xhc3MgZnJvbSBhbGwgYWN0aXZlIGVsZW1lbnRzCiAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShkZWFjdGl2YXRlRWxlbWVudHMpOwogICAgfQoKICAgIGZ1bmN0aW9uIGFjdGl2YXRlRWxlbWVudHMoKSB7CiAgICAgIC8vIGFjdGl2YXRlIGFsbCBlbGVtZW50cyBpbiB0aGUgcXVldWUKICAgICAgZm9yKHZhciBrZXkgaW4gcXVldWVFbGVtZW50cykgewogICAgICAgIGlmKHF1ZXVlRWxlbWVudHNba2V5XSkgewogICAgICAgICAgcXVldWVFbGVtZW50c1trZXldLmNsYXNzTGlzdC5hZGQoQUNUSVZBVEVEX0NMQVNTKTsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnRzW2tleV0gPSBxdWV1ZUVsZW1lbnRzW2tleV07CiAgICAgICAgfQogICAgICB9CiAgICAgIHF1ZXVlRWxlbWVudHMgPSB7fTsKICAgIH0KCiAgICBmdW5jdGlvbiBkZWFjdGl2YXRlRWxlbWVudHMoKSB7CiAgICAgIGZvcih2YXIga2V5IGluIGFjdGl2ZUVsZW1lbnRzKSB7CiAgICAgICAgaWYoYWN0aXZlRWxlbWVudHNba2V5XSkgewogICAgICAgICAgYWN0aXZlRWxlbWVudHNba2V5XS5jbGFzc0xpc3QucmVtb3ZlKEFDVElWQVRFRF9DTEFTUyk7CiAgICAgICAgICBkZWxldGUgYWN0aXZlRWxlbWVudHNba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgfSkoZG9jdW1lbnQsIGlvbmljKTsKCiAgKGZ1bmN0aW9uKGlvbmljKSB7CgogICAgLyogZm9yIG5leHRVaWQoKSBmdW5jdGlvbiBiZWxvdyAqLwogICAgdmFyIHVpZCA9IFsnMCcsJzAnLCcwJ107CgogICAgLyoqCiAgICAgKiBWYXJpb3VzIHV0aWxpdGllcyB1c2VkIHRocm91Z2hvdXQgSW9uaWMKICAgICAqCiAgICAgKiBTb21lIG9mIHRoZXNlIGFyZSBhZG9wdGVkIGZyb20gdW5kZXJzY29yZS5qcyBhbmQgYmFja2JvbmUuanMsIGJvdGggYWxzbyBNSVQgbGljZW5zZWQuCiAgICAgKi8KICAgIGlvbmljLlV0aWxzID0gewoKICAgICAgYXJyYXlNb3ZlOiBmdW5jdGlvbiAoYXJyLCBvbGRfaW5kZXgsIG5ld19pbmRleCkgewogICAgICAgIGlmIChuZXdfaW5kZXggPj0gYXJyLmxlbmd0aCkgewogICAgICAgICAgdmFyIGsgPSBuZXdfaW5kZXggLSBhcnIubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKChrLS0pICsgMSkgewogICAgICAgICAgICBhcnIucHVzaCh1bmRlZmluZWQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBhcnIuc3BsaWNlKG5ld19pbmRleCwgMCwgYXJyLnNwbGljZShvbGRfaW5kZXgsIDEpWzBdKTsKICAgICAgICByZXR1cm4gYXJyOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFJldHVybiBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgZ2l2ZW4gY29udGV4dAogICAgICAgKi8KICAgICAgcHJveHk6IGZ1bmN0aW9uKGZ1bmMsIGNvbnRleHQpIHsKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgIH07CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogT25seSBjYWxsIGEgZnVuY3Rpb24gb25jZSBpbiB0aGUgZ2l2ZW4gaW50ZXJ2YWwuCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSBmdW5jIHtGdW5jdGlvbn0gdGhlIGZ1bmN0aW9uIHRvIGNhbGwKICAgICAgICogQHBhcmFtIHdhaXQge2ludH0gaG93IGxvbmcgdG8gd2FpdCBiZWZvcmUvYWZ0ZXIgdG8gYWxsb3cgZnVuY3Rpb24gY2FsbHMKICAgICAgICogQHBhcmFtIGltbWVkaWF0ZSB7Ym9vbGVhbn0gd2hldGhlciB0byBjYWxsIGltbWVkaWF0ZWx5IG9yIGFmdGVyIHRoZSB3YWl0IGludGVydmFsCiAgICAgICAqLwogICAgICBkZWJvdW5jZTogZnVuY3Rpb24oZnVuYywgd2FpdCwgaW1tZWRpYXRlKSB7CiAgICAgICAgdmFyIHRpbWVvdXQsIGFyZ3MsIGNvbnRleHQsIHRpbWVzdGFtcCwgcmVzdWx0OwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIGNvbnRleHQgPSB0aGlzOwogICAgICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICAgIHRpbWVzdGFtcCA9IG5ldyBEYXRlKCk7CiAgICAgICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGxhc3QgPSAobmV3IERhdGUoKSkgLSB0aW1lc3RhbXA7CiAgICAgICAgICAgIGlmIChsYXN0IDwgd2FpdCkgewogICAgICAgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0IC0gbGFzdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKCFpbW1lZGlhdGUpIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY2FsbE5vdyA9IGltbWVkaWF0ZSAmJiAhdGltZW91dDsKICAgICAgICAgIGlmICghdGltZW91dCkgewogICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2FsbE5vdykgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBUaHJvdHRsZSB0aGUgZ2l2ZW4gZnVuLCBvbmx5IGFsbG93aW5nIGl0IHRvIGJlCiAgICAgICAqIGNhbGxlZCBhdCBtb3N0IGV2ZXJ5IGB3YWl0YCBtcy4KICAgICAgICovCiAgICAgIHRocm90dGxlOiBmdW5jdGlvbihmdW5jLCB3YWl0LCBvcHRpb25zKSB7CiAgICAgICAgdmFyIGNvbnRleHQsIGFyZ3MsIHJlc3VsdDsKICAgICAgICB2YXIgdGltZW91dCA9IG51bGw7CiAgICAgICAgdmFyIHByZXZpb3VzID0gMDsKICAgICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcHJldmlvdXMgPSBvcHRpb25zLmxlYWRpbmcgPT09IGZhbHNlID8gMCA6IERhdGUubm93KCk7CiAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICAgIGlmICghcHJldmlvdXMgJiYgb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSkgcHJldmlvdXMgPSBub3c7CiAgICAgICAgICB2YXIgcmVtYWluaW5nID0gd2FpdCAtIChub3cgLSBwcmV2aW91cyk7CiAgICAgICAgICBjb250ZXh0ID0gdGhpczsKICAgICAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICBpZiAocmVtYWluaW5nIDw9IDApIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgcHJldmlvdXMgPSBub3c7CiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICB9IGVsc2UgaWYgKCF0aW1lb3V0ICYmIG9wdGlvbnMudHJhaWxpbmcgIT09IGZhbHNlKSB7CiAgICAgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCByZW1haW5pbmcpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9OwogICAgICB9LAogICAgICAvLyBCb3Jyb3dlZCBmcm9tIEJhY2tib25lLmpzJ3MgZXh0ZW5kCiAgICAgIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgogICAgICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogICAgICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgogICAgICBpbmhlcml0OiBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgICAgIHZhciBjaGlsZDsKCiAgICAgICAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQogICAgICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKICAgICAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICAgICAgaWYgKHByb3RvUHJvcHMgJiYgcHJvdG9Qcm9wcy5oYXNPd25Qcm9wZXJ0eSgnY29uc3RydWN0b3InKSkgewogICAgICAgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjaGlsZCA9IGZ1bmN0aW9uKCl7IHJldHVybiBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKICAgICAgICB9CgogICAgICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgICAgIGlvbmljLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CgogICAgICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAgICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgICAgICB2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKXsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9OwogICAgICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGUoKTsKCiAgICAgICAgLy8gQWRkIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChpbnN0YW5jZSBwcm9wZXJ0aWVzKSB0byB0aGUgc3ViY2xhc3MsCiAgICAgICAgLy8gaWYgc3VwcGxpZWQuCiAgICAgICAgaWYgKHByb3RvUHJvcHMpIGlvbmljLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwoKICAgICAgICAvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCiAgICAgICAgLy8gbGF0ZXIuCiAgICAgICAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCiAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICB9LAoKICAgICAgLy8gRXh0ZW5kIGFkYXB0ZWQgZnJvbSBVbmRlcnNjb3JlLmpzCiAgICAgIGV4dGVuZDogZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgc291cmNlID0gYXJnc1tpXTsKICAgICAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICAgICAgICBvYmpbcHJvcF0gPSBzb3VyY2VbcHJvcF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iajsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBBIGNvbnNpc3RlbnQgd2F5IG9mIGNyZWF0aW5nIHVuaXF1ZSBJRHMgaW4gYW5ndWxhci4gVGhlIElEIGlzIGEgc2VxdWVuY2Ugb2YgYWxwaGEgbnVtZXJpYwogICAgICAgKiBjaGFyYWN0ZXJzIHN1Y2ggYXMgJzAxMkFCQycuIFRoZSByZWFzb24gd2h5IHdlIGFyZSBub3QgdXNpbmcgc2ltcGx5IGEgbnVtYmVyIGNvdW50ZXIgaXMgdGhhdAogICAgICAgKiB0aGUgbnVtYmVyIHN0cmluZyBnZXRzIGxvbmdlciBvdmVyIHRpbWUsIGFuZCBpdCBjYW4gYWxzbyBvdmVyZmxvdywgd2hlcmUgYXMgdGhlIG5leHRJZAogICAgICAgKiB3aWxsIGdyb3cgbXVjaCBzbG93ZXIsIGl0IGlzIGEgc3RyaW5nLCBhbmQgaXQgd2lsbCBuZXZlciBvdmVyZmxvdy4KICAgICAgICoKICAgICAgICogQHJldHVybnMgYW4gdW5pcXVlIGFscGhhLW51bWVyaWMgc3RyaW5nCiAgICAgICAqLwogICAgICBuZXh0VWlkOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgaW5kZXggPSB1aWQubGVuZ3RoOwogICAgICAgIHZhciBkaWdpdDsKCiAgICAgICAgd2hpbGUoaW5kZXgpIHsKICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICBkaWdpdCA9IHVpZFtpbmRleF0uY2hhckNvZGVBdCgwKTsKICAgICAgICAgIGlmIChkaWdpdCA9PSA1NyAvKic5JyovKSB7CiAgICAgICAgICAgIHVpZFtpbmRleF0gPSAnQSc7CiAgICAgICAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGlnaXQgPT0gOTAgIC8qJ1onKi8pIHsKICAgICAgICAgICAgdWlkW2luZGV4XSA9ICcwJzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVpZFtpbmRleF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGRpZ2l0ICsgMSk7CiAgICAgICAgICAgIHJldHVybiB1aWQuam9pbignJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHVpZC51bnNoaWZ0KCcwJyk7CiAgICAgICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICAgICAgfQogICAgfTsKCiAgICAvLyBCaW5kIGEgZmV3IG9mIHRoZSBtb3N0IHVzZWZ1bCBmdW5jdGlvbnMgdG8gdGhlIGlvbmljIHNjb3BlCiAgICBpb25pYy5pbmhlcml0ID0gaW9uaWMuVXRpbHMuaW5oZXJpdDsKICAgIGlvbmljLmV4dGVuZCA9IGlvbmljLlV0aWxzLmV4dGVuZDsKICAgIGlvbmljLnRocm90dGxlID0gaW9uaWMuVXRpbHMudGhyb3R0bGU7CiAgICBpb25pYy5wcm94eSA9IGlvbmljLlV0aWxzLnByb3h5OwogICAgaW9uaWMuZGVib3VuY2UgPSBpb25pYy5VdGlscy5kZWJvdW5jZTsKCiAgfSkod2luZG93LmlvbmljKTsKCiAgLyoqCiAgICogQG5nZG9jIHBhZ2UKICAgKiBAbmFtZSBrZXlib2FyZAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVzY3JpcHRpb24KICAgKiBPbiBib3RoIEFuZHJvaWQgYW5kIGlPUywgSW9uaWMgd2lsbCBhdHRlbXB0IHRvIHByZXZlbnQgdGhlIGtleWJvYXJkIGZyb20KICAgKiBvYnNjdXJpbmcgaW5wdXRzIGFuZCBmb2N1c2FibGUgZWxlbWVudHMgd2hlbiBpdCBhcHBlYXJzIGJ5IHNjcm9sbGluZyB0aGVtCiAgICogaW50byB2aWV3LiAgSW4gb3JkZXIgZm9yIHRoaXMgdG8gd29yaywgYW55IGZvY3VzYWJsZSBlbGVtZW50cyBtdXN0IGJlIHdpdGhpbgogICAqIGEgW1Njcm9sbCBWaWV3XShodHRwOi8vaW9uaWNmcmFtZXdvcmsuY29tL2RvY3MvYXBpL2RpcmVjdGl2ZS9pb25TY3JvbGwvKQogICAqIG9yIGEgZGlyZWN0aXZlIHN1Y2ggYXMgW0NvbnRlbnRdKGh0dHA6Ly9pb25pY2ZyYW1ld29yay5jb20vZG9jcy9hcGkvZGlyZWN0aXZlL2lvbkNvbnRlbnQvKQogICAqIHRoYXQgaGFzIGEgU2Nyb2xsIFZpZXcuCiAgICoKICAgKiBJdCB3aWxsIGFsc28gYXR0ZW1wdCB0byBwcmV2ZW50IHRoZSBuYXRpdmUgb3ZlcmZsb3cgc2Nyb2xsaW5nIG9uIGZvY3VzLAogICAqIHdoaWNoIGNhbiBjYXVzZSBsYXlvdXQgaXNzdWVzIHN1Y2ggYXMgcHVzaGluZyBoZWFkZXJzIHVwIGFuZCBvdXQgb2Ygdmlldy4KICAgKgogICAqIFRoZSBrZXlib2FyZCBmaXhlcyB3b3JrIGJlc3QgaW4gY29uanVuY3Rpb24gd2l0aCB0aGUKICAgKiBbSW9uaWMgS2V5Ym9hcmQgUGx1Z2luXShodHRwczovL2dpdGh1Yi5jb20vZHJpZnR5Y28vaW9uaWMtcGx1Z2lucy1rZXlib2FyZCksCiAgICogYWx0aG91Z2ggaXQgd2lsbCBwZXJmb3JtIHJlYXNvbmFibHkgd2VsbCB3aXRob3V0LiAgSG93ZXZlciwgaWYgeW91IGFyZSB1c2luZwogICAqIENvcmRvdmEgdGhlcmUgaXMgbm8gcmVhc29uIG5vdCB0byB1c2UgdGhlIHBsdWdpbi4KICAgKgogICAqICMjIyBIaWRlIHdoZW4ga2V5Ym9hcmQgc2hvd3MKICAgKgogICAqIFRvIGhpZGUgYW4gZWxlbWVudCB3aGVuIHRoZSBrZXlib2FyZCBpcyBvcGVuLCBhZGQgdGhlIGNsYXNzIGBoaWRlLW9uLWtleWJvYXJkLW9wZW5gLgogICAqCiAgICogYGBgaHRtbAogICAqIDxkaXYgY2xhc3M9ImhpZGUtb24ta2V5Ym9hcmQtb3BlbiI+CiAgICogICA8ZGl2IGlkPSJnb29nbGUtbWFwIj48L2Rpdj4KICAgKiA8L2Rpdj4KICAgKiBgYGAKICAgKiAtLS0tLS0tLS0tCiAgICoKICAgKiAjIyMgUGx1Z2luIFVzYWdlCiAgICogSW5mb3JtYXRpb24gb24gdXNpbmcgdGhlIHBsdWdpbiBjYW4gYmUgZm91bmQgYXQKICAgKiBbaHR0cHM6Ly9naXRodWIuY29tL2RyaWZ0eWNvL2lvbmljLXBsdWdpbnMta2V5Ym9hcmRdKGh0dHBzOi8vZ2l0aHViLmNvbS9kcmlmdHljby9pb25pYy1wbHVnaW5zLWtleWJvYXJkKS4KICAgKgogICAqIC0tLS0tLS0tLS0KICAgKgogICAqICMjIyBBbmRyb2lkIE5vdGVzCiAgICogLSBJZiB5b3VyIGFwcCBpcyBydW5uaW5nIGluIGZ1bGxzY3JlZW4sIGkuZS4geW91IGhhdmUKICAgKiAgIGA8cHJlZmVyZW5jZSBuYW1lPSJGdWxsc2NyZWVuIiB2YWx1ZT0idHJ1ZSIgLz5gIGluIHlvdXIgYGNvbmZpZy54bWxgIGZpbGUKICAgKiAgIHlvdSB3aWxsIG5lZWQgdG8gc2V0IGBpb25pYy5QbGF0Zm9ybS5pc0Z1bGxTY3JlZW4gPSB0cnVlYCBtYW51YWxseS4KICAgKgogICAqIC0gWW91IGNhbiBjb25maWd1cmUgdGhlIGJlaGF2aW9yIG9mIHRoZSB3ZWIgdmlldyB3aGVuIHRoZSBrZXlib2FyZCBzaG93cyBieSBzZXR0aW5nCiAgICogICBbYW5kcm9pZDp3aW5kb3dTb2Z0SW5wdXRNb2RlXShodHRwOi8vZGV2ZWxvcGVyLmFuZHJvaWQuY29tL3JlZmVyZW5jZS9hbmRyb2lkL1IuYXR0ci5odG1sI3dpbmRvd1NvZnRJbnB1dE1vZGUpCiAgICogICB0byBlaXRoZXIgYGFkanVzdFBhbmAsIGBhZGp1c3RSZXNpemVgIG9yIGBhZGp1c3ROb3RoaW5nYCBpbiB5b3VyIGFwcCdzCiAgICogICBhY3Rpdml0eSBpbiBgQW5kcm9pZE1hbmlmZXN0LnhtbGAuIGBhZGp1c3RSZXNpemVgIGlzIHRoZSByZWNvbW1lbmRlZCBzZXR0aW5nCiAgICogICBmb3IgSW9uaWMsIGJ1dCBpZiBmb3Igc29tZSByZWFzb24geW91IGRvIHVzZSBgYWRqdXN0UGFuYCB5b3Ugd2lsbCBuZWVkIHRvCiAgICogICBzZXQgYGlvbmljLlBsYXRmb3JtLmlzRnVsbFNjcmVlbiA9IHRydWVgLgogICAqCiAgICogICBgYGB4bWwKICAgKiAgIDxhY3Rpdml0eSBhbmRyb2lkOndpbmRvd1NvZnRJbnB1dE1vZGU9ImFkanVzdFJlc2l6ZSI+CiAgICoKICAgKiAgIGBgYAogICAqCiAgICogIyMjIGlPUyBOb3RlcwogICAqIC0gSWYgdGhlIGNvbnRlbnQgb2YgeW91ciBhcHAgKGluY2x1ZGluZyB0aGUgaGVhZGVyKSBpcyBiZWluZyBwdXNoZWQgdXAgYW5kCiAgICogICBvdXQgb2YgdmlldyBvbiBpbnB1dCBmb2N1cywgdHJ5IHNldHRpbmcgYGNvcmRvdmEucGx1Z2lucy5LZXlib2FyZC5kaXNhYmxlU2Nyb2xsKHRydWUpYC4KICAgKiAgIFRoaXMgZG9lcyAqKm5vdCoqIGRpc2FibGUgc2Nyb2xsaW5nIGluIHRoZSBJb25pYyBzY3JvbGwgdmlldywgcmF0aGVyIGl0CiAgICogICBkaXNhYmxlcyB0aGUgbmF0aXZlIG92ZXJmbG93IHNjcm9sbGluZyB0aGF0IGhhcHBlbnMgYXV0b21hdGljYWxseSBhcyBhCiAgICogICByZXN1bHQgb2YgZm9jdXNpbmcgb24gaW5wdXRzIGJlbG93IHRoZSBrZXlib2FyZC4KICAgKgogICAqLwoKICB2YXIga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDsKICB2YXIga2V5Ym9hcmRJc09wZW47CiAgdmFyIGtleWJvYXJkQWN0aXZlRWxlbWVudDsKICB2YXIga2V5Ym9hcmRGb2N1c091dFRpbWVyOwogIHZhciBrZXlib2FyZEZvY3VzSW5UaW1lcjsKICB2YXIga2V5Ym9hcmRMYXN0U2hvdyA9IDA7CgogIHZhciBLRVlCT0FSRF9PUEVOX0NTUyA9ICdrZXlib2FyZC1vcGVuJzsKICB2YXIgU0NST0xMX0NPTlRBSU5FUl9DU1MgPSAnc2Nyb2xsJzsKCiAgaW9uaWMua2V5Ym9hcmQgPSB7CiAgICBpc09wZW46IGZhbHNlLAogICAgaGVpZ2h0OiBudWxsLAogICAgbGFuZHNjYXBlOiBmYWxzZSwKICB9OwoKICBmdW5jdGlvbiBrZXlib2FyZEluaXQoKSB7CiAgICBpZigga2V5Ym9hcmRIYXNQbHVnaW4oKSApIHsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ25hdGl2ZS5rZXlib2FyZHNob3cnLCBrZXlib2FyZE5hdGl2ZVNob3cpOwogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbmF0aXZlLmtleWJvYXJkaGlkZScsIGtleWJvYXJkRm9jdXNPdXQpOwoKICAgICAgLy9kZXByZWNhdGVkCiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCduYXRpdmUuc2hvd2tleWJvYXJkJywga2V5Ym9hcmROYXRpdmVTaG93KTsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ25hdGl2ZS5oaWRla2V5Ym9hcmQnLCBrZXlib2FyZEZvY3VzT3V0KTsKICAgIH0KICAgIGVsc2UgewogICAgICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2ZvY3Vzb3V0Jywga2V5Ym9hcmRGb2N1c091dCk7CiAgICB9CgogICAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdpb25pYy5mb2N1c2luJywga2V5Ym9hcmRCcm93c2VyRm9jdXNJbik7CiAgICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2ZvY3VzaW4nLCBrZXlib2FyZEJyb3dzZXJGb2N1c0luKTsKCiAgICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ29yaWVudGF0aW9uY2hhbmdlJywga2V5Ym9hcmRPcmllbnRhdGlvbkNoYW5nZSk7CgogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGtleWJvYXJkSW5pdCk7CiAgfQoKICBmdW5jdGlvbiBrZXlib2FyZE5hdGl2ZVNob3coZSkgewogICAgY2xlYXJUaW1lb3V0KGtleWJvYXJkRm9jdXNPdXRUaW1lcik7CiAgICBpb25pYy5rZXlib2FyZC5oZWlnaHQgPSBlLmtleWJvYXJkSGVpZ2h0OwogIH0KCiAgZnVuY3Rpb24ga2V5Ym9hcmRCcm93c2VyRm9jdXNJbihlKSB7CiAgICBpZiggIWUudGFyZ2V0IHx8ICFpb25pYy50YXAuaXNUZXh0SW5wdXQoZS50YXJnZXQpIHx8IGlvbmljLnRhcC5pc0RhdGVJbnB1dChlLnRhcmdldCkgfHwgIWtleWJvYXJkSXNXaXRoaW5TY3JvbGwoZS50YXJnZXQpICkgcmV0dXJuOwoKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBrZXlib2FyZE9uS2V5RG93biwgZmFsc2UpOwoKICAgIGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wID0gMDsKICAgIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcignLnNjcm9sbC1jb250ZW50Jykuc2Nyb2xsVG9wID0gMDsKCiAgICBrZXlib2FyZEFjdGl2ZUVsZW1lbnQgPSBlLnRhcmdldDsKCiAgICBrZXlib2FyZFNldFNob3coZSk7CiAgfQoKICBmdW5jdGlvbiBrZXlib2FyZFNldFNob3coZSkgewogICAgY2xlYXJUaW1lb3V0KGtleWJvYXJkRm9jdXNJblRpbWVyKTsKICAgIGNsZWFyVGltZW91dChrZXlib2FyZEZvY3VzT3V0VGltZXIpOwoKICAgIGtleWJvYXJkRm9jdXNJblRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICBpZiAoIGtleWJvYXJkTGFzdFNob3cgKyAzNTAgPiBEYXRlLm5vdygpICkgcmV0dXJuOwogICAgICBrZXlib2FyZExhc3RTaG93ID0gRGF0ZS5ub3coKTsKICAgICAgdmFyIGtleWJvYXJkSGVpZ2h0OwogICAgICB2YXIgZWxlbWVudEJvdW5kcyA9IGtleWJvYXJkQWN0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgdmFyIGNvdW50ID0gMDsKCiAgICAgIHZhciBwb2xsS2V5Ym9hcmRIZWlnaHQgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpewoKICAgICAgICBrZXlib2FyZEhlaWdodCA9IGtleWJvYXJkR2V0SGVpZ2h0KCk7CiAgICAgICAgaWYgKGNvdW50ID4gMTApewogICAgICAgICAgY2xlYXJJbnRlcnZhbChwb2xsS2V5Ym9hcmRIZWlnaHQpOwogICAgICAgICAgLy93YWl0ZWQgbG9uZyBlbm91Z2gsIGp1c3QgZ3Vlc3MKICAgICAgICAgIGtleWJvYXJkSGVpZ2h0ID0gMjc1OwogICAgICAgIH0KICAgICAgICBpZiAoa2V5Ym9hcmRIZWlnaHQpewogICAgICAgICAga2V5Ym9hcmRTaG93KGUudGFyZ2V0LCBlbGVtZW50Qm91bmRzLnRvcCwgZWxlbWVudEJvdW5kcy5ib3R0b20sIGtleWJvYXJkVmlld3BvcnRIZWlnaHQsIGtleWJvYXJkSGVpZ2h0KTsKICAgICAgICAgIGNsZWFySW50ZXJ2YWwocG9sbEtleWJvYXJkSGVpZ2h0KTsKICAgICAgICB9CiAgICAgICAgY291bnQrKzsKCiAgICAgIH0sIDEwMCk7CiAgICB9LCAzMik7CiAgfQoKICBmdW5jdGlvbiBrZXlib2FyZFNob3coZWxlbWVudCwgZWxlbWVudFRvcCwgZWxlbWVudEJvdHRvbSwgdmlld3BvcnRIZWlnaHQsIGtleWJvYXJkSGVpZ2h0KSB7CiAgICB2YXIgZGV0YWlscyA9IHsKICAgICAgdGFyZ2V0OiBlbGVtZW50LAogICAgICBlbGVtZW50VG9wOiBNYXRoLnJvdW5kKGVsZW1lbnRUb3ApLAogICAgICBlbGVtZW50Qm90dG9tOiBNYXRoLnJvdW5kKGVsZW1lbnRCb3R0b20pLAogICAgICBrZXlib2FyZEhlaWdodDoga2V5Ym9hcmRIZWlnaHQsCiAgICAgIHZpZXdwb3J0SGVpZ2h0OiB2aWV3cG9ydEhlaWdodAogICAgfTsKCiAgICBkZXRhaWxzLmhhc1BsdWdpbiA9IGtleWJvYXJkSGFzUGx1Z2luKCk7CgogICAgZGV0YWlscy5jb250ZW50SGVpZ2h0ID0gdmlld3BvcnRIZWlnaHQgLSBrZXlib2FyZEhlaWdodDsKCiAgICB2b2lkIDA7CgogICAgLy8gZmlndXJlIG91dCBpZiB0aGUgZWxlbWVudCBpcyB1bmRlciB0aGUga2V5Ym9hcmQKICAgIGRldGFpbHMuaXNFbGVtZW50VW5kZXJLZXlib2FyZCA9IChkZXRhaWxzLmVsZW1lbnRCb3R0b20gPiBkZXRhaWxzLmNvbnRlbnRIZWlnaHQpOwoKICAgIGlvbmljLmtleWJvYXJkLmlzT3BlbiA9IHRydWU7CgogICAgLy8gc2VuZCBldmVudCBzbyB0aGUgc2Nyb2xsIHZpZXcgYWRqdXN0cwogICAga2V5Ym9hcmRBY3RpdmVFbGVtZW50ID0gZWxlbWVudDsKICAgIGlvbmljLnRyaWdnZXIoJ3Njcm9sbENoaWxkSW50b1ZpZXcnLCBkZXRhaWxzLCB0cnVlKTsKCiAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXsKICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKEtFWUJPQVJEX09QRU5fQ1NTKTsKICAgIH0pOwoKICAgIC8vIGFueSBzaG93aW5nIHBhcnQgb2YgdGhlIGRvY3VtZW50IHRoYXQgaXNuJ3Qgd2l0aGluIHRoZSBzY3JvbGwgdGhlIHVzZXIKICAgIC8vIGNvdWxkIHRvdWNobW92ZSBhbmQgY2F1c2Ugc29tZSB1Z2x5IGNoYW5nZXMgdG8gdGhlIGFwcCwgc28gZGlzYWJsZQogICAgLy8gYW55IHRvdWNobW92ZSBldmVudHMgd2hpbGUgdGhlIGtleWJvYXJkIGlzIG9wZW4gdXNpbmcgZS5wcmV2ZW50RGVmYXVsdCgpCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCBrZXlib2FyZFByZXZlbnREZWZhdWx0LCBmYWxzZSk7CgogICAgcmV0dXJuIGRldGFpbHM7CiAgfQoKICBmdW5jdGlvbiBrZXlib2FyZEZvY3VzT3V0KGUpIHsKICAgIGNsZWFyVGltZW91dChrZXlib2FyZEZvY3VzT3V0VGltZXIpOwoKICAgIGtleWJvYXJkRm9jdXNPdXRUaW1lciA9IHNldFRpbWVvdXQoa2V5Ym9hcmRIaWRlLCAzNTApOwogIH0KCiAgZnVuY3Rpb24ga2V5Ym9hcmRIaWRlKCkgewogICAgdm9pZCAwOwogICAgaW9uaWMua2V5Ym9hcmQuaXNPcGVuID0gZmFsc2U7CgogICAgaW9uaWMudHJpZ2dlcigncmVzZXRTY3JvbGxWaWV3JywgewogICAgICB0YXJnZXQ6IGtleWJvYXJkQWN0aXZlRWxlbWVudAogICAgfSwgdHJ1ZSk7CgogICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LnJlbW92ZShLRVlCT0FSRF9PUEVOX0NTUyk7CiAgICB9KTsKCiAgICAvLyB0aGUga2V5Ym9hcmQgaXMgZ29uZSBub3csIHJlbW92ZSB0aGUgdG91Y2htb3ZlIHRoYXQgZGlzYWJsZXMgbmF0aXZlIHNjcm9sbAogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywga2V5Ym9hcmRQcmV2ZW50RGVmYXVsdCk7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywga2V5Ym9hcmRPbktleURvd24pOwogIH0KCiAgZnVuY3Rpb24ga2V5Ym9hcmRVcGRhdGVWaWV3cG9ydEhlaWdodCgpIHsKICAgIGlmKCB3aW5kb3cuaW5uZXJIZWlnaHQgPiBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0ICkgewogICAgICBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwogICAgfQogIH0KCiAgZnVuY3Rpb24ga2V5Ym9hcmRPbktleURvd24oZSkgewogICAgaWYoIGlvbmljLnNjcm9sbC5pc1Njcm9sbGluZyApIHsKICAgICAga2V5Ym9hcmRQcmV2ZW50RGVmYXVsdChlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGtleWJvYXJkUHJldmVudERlZmF1bHQoZSkgewogICAgaWYoIGUudGFyZ2V0LnRhZ05hbWUgIT09ICdURVhUQVJFQScgKSB7CiAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGtleWJvYXJkT3JpZW50YXRpb25DaGFuZ2UoKSB7CiAgICB2YXIgdXBkYXRlZFZpZXdwb3J0SGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwoKICAgIC8vdG9vIHNsb3csIGhhdmUgdG8gd2FpdCBmb3IgdXBkYXRlZCBoZWlnaHQKICAgIGlmICh1cGRhdGVkVmlld3BvcnRIZWlnaHQgPT09IGtleWJvYXJkVmlld3BvcnRIZWlnaHQpewogICAgICB2YXIgY291bnQgPSAwOwogICAgICB2YXIgcG9sbFZpZXdwb3J0SGVpZ2h0ID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXsKICAgICAgICAvL2dpdmUgdXAKICAgICAgICBpZiAoY291bnQgPiAxMCl7CiAgICAgICAgICBjbGVhckludGVydmFsKHBvbGxWaWV3cG9ydEhlaWdodCk7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVkVmlld3BvcnRIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CgogICAgICAgIGlmICh1cGRhdGVkVmlld3BvcnRIZWlnaHQgIT09IGtleWJvYXJkVmlld3BvcnRIZWlnaHQpewogICAgICAgICAgaWYgKHVwZGF0ZWRWaWV3cG9ydEhlaWdodCA8IGtleWJvYXJkVmlld3BvcnRIZWlnaHQpewogICAgICAgICAgICBpb25pYy5rZXlib2FyZC5sYW5kc2NhcGUgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGlvbmljLmtleWJvYXJkLmxhbmRzY2FwZSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCA9IHVwZGF0ZWRWaWV3cG9ydEhlaWdodDsKICAgICAgICAgIGNsZWFySW50ZXJ2YWwocG9sbFZpZXdwb3J0SGVpZ2h0KTsKICAgICAgICB9CiAgICAgICAgY291bnQrKzsKCiAgICAgIH0sIDUwKTsKICAgIH0KICAgIGVsc2UgewogICAgICBrZXlib2FyZFZpZXdwb3J0SGVpZ2h0ID0gdXBkYXRlZFZpZXdwb3J0SGVpZ2h0OwogICAgfQogIH0KCiAgZnVuY3Rpb24ga2V5Ym9hcmRHZXRIZWlnaHQoKSB7CiAgICAvLyBjaGVjayBpZiB3ZSBhcmUgYWxyZWFkeSBoYXZlIGEga2V5Ym9hcmQgaGVpZ2h0IGZyb20gdGhlIHBsdWdpbgogICAgaWYgKCBpb25pYy5rZXlib2FyZC5oZWlnaHQgKSB7CiAgICAgIHJldHVybiBpb25pYy5rZXlib2FyZC5oZWlnaHQ7CiAgICB9CgogICAgaWYgKCBpb25pYy5QbGF0Zm9ybS5pc0FuZHJvaWQoKSApewogICAgICAvL3Nob3VsZCBiZSB1c2luZyB0aGUgcGx1Z2luLCBubyB3YXkgdG8ga25vdyBob3cgYmlnIHRoZSBrZXlib2FyZCBpcywgc28gZ3Vlc3MKICAgICAgaWYgKCBpb25pYy5QbGF0Zm9ybS5pc0Z1bGxTY3JlZW4gKXsKICAgICAgICByZXR1cm4gMjc1OwogICAgICB9CiAgICAgIC8vb3RoZXJ3aXNlLCB3YWl0IGZvciB0aGUgc2NyZWVuIHRvIHJlc2l6ZQogICAgICBpZiAoIHdpbmRvdy5pbm5lckhlaWdodCA8IGtleWJvYXJkVmlld3BvcnRIZWlnaHQgKXsKICAgICAgICByZXR1cm4ga2V5Ym9hcmRWaWV3cG9ydEhlaWdodCAtIHdpbmRvdy5pbm5lckhlaWdodDsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgfQoKICAgIC8vIGZhbGxiYWNrIGZvciB3aGVuIGl0cyB0aGUgd2VidmlldyB3aXRob3V0IHRoZSBwbHVnaW4KICAgIC8vIG9yIGZvciBqdXN0IHRoZSBzdGFuZGFyZCB3ZWIgYnJvd3NlcgogICAgaWYoIGlvbmljLlBsYXRmb3JtLmlzSU9TKCkgKSB7CiAgICAgIGlmICggaW9uaWMua2V5Ym9hcmQubGFuZHNjYXBlICl7CiAgICAgICAgcmV0dXJuIDIwNjsKICAgICAgfQoKICAgICAgaWYgKCFpb25pYy5QbGF0Zm9ybS5pc1dlYlZpZXcoKSl7CiAgICAgICAgcmV0dXJuIDIxNjsKICAgICAgfQoKICAgICAgcmV0dXJuIDI2MDsKICAgIH0KCiAgICAvLyBzYWZlIGd1ZXNzCiAgICByZXR1cm4gMjc1OwogIH0KCiAgZnVuY3Rpb24ga2V5Ym9hcmRJc1dpdGhpblNjcm9sbChlbGUpIHsKICAgIHdoaWxlKGVsZSkgewogICAgICBpZihlbGUuY2xhc3NMaXN0LmNvbnRhaW5zKFNDUk9MTF9DT05UQUlORVJfQ1NTKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGVsZSA9IGVsZS5wYXJlbnRFbGVtZW50OwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgZnVuY3Rpb24ga2V5Ym9hcmRIYXNQbHVnaW4oKSB7CiAgICByZXR1cm4gISEod2luZG93LmNvcmRvdmEgJiYgY29yZG92YS5wbHVnaW5zICYmIGNvcmRvdmEucGx1Z2lucy5LZXlib2FyZCk7CiAgfQoKICBpb25pYy5QbGF0Zm9ybS5yZWFkeShmdW5jdGlvbigpIHsKICAgIGtleWJvYXJkVXBkYXRlVmlld3BvcnRIZWlnaHQoKTsKCiAgICAvLyBBbmRyb2lkIHNvbWV0aW1lcyByZXBvcnRzIGJhZCBpbm5lckhlaWdodCBvbiB3aW5kb3cubG9hZAogICAgLy8gdHJ5IGl0IGFnYWluIGluIGEgbGlsIGJpdCB0byBwbGF5IGl0IHNhZmUKICAgIHNldFRpbWVvdXQoa2V5Ym9hcmRVcGRhdGVWaWV3cG9ydEhlaWdodCwgOTk5KTsKCiAgICAvLyBvbmx5IGluaXRpYWxpemUgdGhlIGFkanVzdG1lbnRzIGZvciB0aGUgdmlydHVhbCBrZXlib2FyZAogICAgLy8gaWYgYSB0b3VjaHN0YXJ0IGV2ZW50IGhhcHBlbnMKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBrZXlib2FyZEluaXQsIGZhbHNlKTsKICB9KTsKCgoKICB2YXIgdmlld3BvcnRUYWc7CiAgdmFyIHZpZXdwb3J0UHJvcGVydGllcyA9IHt9OwoKICBpb25pYy52aWV3cG9ydCA9IHsKICAgIG9yaWVudGF0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgLy8gMCA9IFBvcnRyYWl0CiAgICAgIC8vIDkwID0gTGFuZHNjYXBlCiAgICAgIC8vIG5vdCB1c2luZyB3aW5kb3cub3JpZW50YXRpb24gYmVjYXVzZSBlYWNoIGRldmljZSBoYXMgYSBkaWZmZXJlbnQgaW1wbGVtZW50YXRpb24KICAgICAgcmV0dXJuICh3aW5kb3cuaW5uZXJXaWR0aCA+IHdpbmRvdy5pbm5lckhlaWdodCA/IDkwIDogMCk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gdmlld3BvcnRMb2FkVGFnKCkgewogICAgdmFyIHg7CgogICAgZm9yKHg9MDsgeDxkb2N1bWVudC5oZWFkLmNoaWxkcmVuLmxlbmd0aDsgeCsrKSB7CiAgICAgIGlmKGRvY3VtZW50LmhlYWQuY2hpbGRyZW5beF0ubmFtZSA9PSAndmlld3BvcnQnKSB7CiAgICAgICAgdmlld3BvcnRUYWcgPSBkb2N1bWVudC5oZWFkLmNoaWxkcmVuW3hdOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgaWYodmlld3BvcnRUYWcpIHsKICAgICAgdmFyIHByb3BzID0gdmlld3BvcnRUYWcuY29udGVudC50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1xzKy9nLCAnJykuc3BsaXQoJywnKTsKICAgICAgdmFyIGtleVZhbHVlOwogICAgICBmb3IoeD0wOyB4PHByb3BzLmxlbmd0aDsgeCsrKSB7CiAgICAgICAgaWYocHJvcHNbeF0pIHsKICAgICAgICAgIGtleVZhbHVlID0gcHJvcHNbeF0uc3BsaXQoJz0nKTsKICAgICAgICAgIHZpZXdwb3J0UHJvcGVydGllc1sga2V5VmFsdWVbMF0gXSA9IChrZXlWYWx1ZS5sZW5ndGggPiAxID8ga2V5VmFsdWVbMV0gOiAnXycpOwogICAgICAgIH0KICAgICAgfQogICAgICB2aWV3cG9ydFVwZGF0ZSgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdmlld3BvcnRVcGRhdGUoKSB7CiAgICAvLyB1bml0IHRlc3RzIGluIHZpZXdwb3J0LnVuaXQuanMKCiAgICB2YXIgaW5pdFdpZHRoID0gdmlld3BvcnRQcm9wZXJ0aWVzLndpZHRoOwogICAgdmFyIGluaXRIZWlnaHQgPSB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0OwogICAgdmFyIHAgPSBpb25pYy5QbGF0Zm9ybTsKICAgIHZhciB2ZXJzaW9uID0gcC52ZXJzaW9uKCk7CiAgICB2YXIgREVWSUNFX1dJRFRIID0gJ2RldmljZS13aWR0aCc7CiAgICB2YXIgREVWSUNFX0hFSUdIVCA9ICdkZXZpY2UtaGVpZ2h0JzsKICAgIHZhciBvcmllbnRhdGlvbiA9IGlvbmljLnZpZXdwb3J0Lm9yaWVudGF0aW9uKCk7CgogICAgLy8gTW9zdCB0aW1lcyB3ZSdyZSByZW1vdmluZyB0aGUgaGVpZ2h0IGFuZCBhZGRpbmcgdGhlIHdpZHRoCiAgICAvLyBTbyB0aGlzIGlzIHRoZSBkZWZhdWx0IHRvIHN0YXJ0IHdpdGgsIHRoZW4gbW9kaWZ5IHBlciBwbGF0Zm9ybS92ZXJzaW9uL29yZWludGF0aW9uCiAgICBkZWxldGUgdmlld3BvcnRQcm9wZXJ0aWVzLmhlaWdodDsKICAgIHZpZXdwb3J0UHJvcGVydGllcy53aWR0aCA9IERFVklDRV9XSURUSDsKCiAgICBpZiggcC5pc0lQYWQoKSApIHsKICAgICAgLy8gaVBhZAoKICAgICAgaWYoIHZlcnNpb24gPiA3ICkgewogICAgICAgIC8vIGlQYWQgPj0gNy4xCiAgICAgICAgLy8gaHR0cHM6Ly9pc3N1ZXMuYXBhY2hlLm9yZy9qaXJhL2Jyb3dzZS9DQi00MzIzCiAgICAgICAgZGVsZXRlIHZpZXdwb3J0UHJvcGVydGllcy53aWR0aDsKCiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gaVBhZCA8PSA3LjAKCiAgICAgICAgaWYoIHAuaXNXZWJWaWV3KCkgKSB7CiAgICAgICAgICAvLyBpUGFkIDw9IDcuMCBXZWJWaWV3CgogICAgICAgICAgaWYoIG9yaWVudGF0aW9uID09IDkwICkgewogICAgICAgICAgICAvLyBpUGFkIDw9IDcuMCBXZWJWaWV3IExhbmRzY2FwZQogICAgICAgICAgICB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0ID0gJzAnOwoKICAgICAgICAgIH0gZWxzZSBpZih2ZXJzaW9uID09IDcpIHsKICAgICAgICAgICAgLy8gaVBhZCA8PSA3LjAgV2ViVmlldyBQb3J0YWl0CiAgICAgICAgICAgIHZpZXdwb3J0UHJvcGVydGllcy5oZWlnaHQgPSBERVZJQ0VfSEVJR0hUOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBpUGFkIDw9IDYuMSBCcm93c2VyCiAgICAgICAgICBpZih2ZXJzaW9uIDwgNykgewogICAgICAgICAgICB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0ID0gJzAnOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgIH0gZWxzZSBpZiggcC5pc0lPUygpICkgewogICAgICAvLyBpUGhvbmUKCiAgICAgIGlmKCBwLmlzV2ViVmlldygpICkgewogICAgICAgIC8vIGlQaG9uZSBXZWJWaWV3CgogICAgICAgIGlmKHZlcnNpb24gPiA3KSB7CiAgICAgICAgICAvLyBpUGhvbmUgPj0gNy4xIFdlYlZpZXcKICAgICAgICAgIGRlbGV0ZSB2aWV3cG9ydFByb3BlcnRpZXMud2lkdGg7CgogICAgICAgIH0gZWxzZSBpZih2ZXJzaW9uIDwgNykgewogICAgICAgICAgLy8gaVBob25lIDw9IDYuMSBXZWJWaWV3CiAgICAgICAgICAvLyBpZiBoZWlnaHQgd2FzIHNldCBpdCBuZWVkcyB0byBnZXQgcmVtb3ZlZCB3aXRoIHRoaXMgaGFjayBmb3IgPD0gNi4xCiAgICAgICAgICBpZiggaW5pdEhlaWdodCApIHZpZXdwb3J0UHJvcGVydGllcy5oZWlnaHQgPSAnMCc7CgogICAgICAgIH0gZWxzZSBpZih2ZXJzaW9uID09IDcpIHsKICAgICAgICAgIC8vaVBob25lID09IDcuMCBXZWJWaWV3CiAgICAgICAgICB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0ID0gREVWSUNFX0hFSUdIVDsKICAgICAgICB9CgogICAgICB9IGVsc2UgewogICAgICAgIC8vIGlQaG9uZSBCcm93c2VyCgogICAgICAgIGlmICh2ZXJzaW9uIDwgNykgewogICAgICAgICAgLy8gaVBob25lIDw9IDYuMSBCcm93c2VyCiAgICAgICAgICAvLyBpZiBoZWlnaHQgd2FzIHNldCBpdCBuZWVkcyB0byBnZXQgcmVtb3ZlZCB3aXRoIHRoaXMgaGFjayBmb3IgPD0gNi4xCiAgICAgICAgICBpZiggaW5pdEhlaWdodCApIHZpZXdwb3J0UHJvcGVydGllcy5oZWlnaHQgPSAnMCc7CiAgICAgICAgfQogICAgICB9CgogICAgfQoKICAgIC8vIG9ubHkgdXBkYXRlIHRoZSB2aWV3cG9ydCB0YWcgaWYgdGhlcmUgd2FzIGEgY2hhbmdlCiAgICBpZihpbml0V2lkdGggIT09IHZpZXdwb3J0UHJvcGVydGllcy53aWR0aCB8fCBpbml0SGVpZ2h0ICE9PSB2aWV3cG9ydFByb3BlcnRpZXMuaGVpZ2h0KSB7CiAgICAgIHZpZXdwb3J0VGFnVXBkYXRlKCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB2aWV3cG9ydFRhZ1VwZGF0ZSgpIHsKICAgIHZhciBrZXksIHByb3BzID0gW107CiAgICBmb3Ioa2V5IGluIHZpZXdwb3J0UHJvcGVydGllcykgewogICAgICBpZiggdmlld3BvcnRQcm9wZXJ0aWVzW2tleV0gKSB7CiAgICAgICAgcHJvcHMucHVzaChrZXkgKyAodmlld3BvcnRQcm9wZXJ0aWVzW2tleV0gPT0gJ18nID8gJycgOiAnPScgKyB2aWV3cG9ydFByb3BlcnRpZXNba2V5XSkgKTsKICAgICAgfQogICAgfQoKICAgIHZpZXdwb3J0VGFnLmNvbnRlbnQgPSBwcm9wcy5qb2luKCcsICcpOwogIH0KCiAgaW9uaWMuUGxhdGZvcm0ucmVhZHkoZnVuY3Rpb24oKSB7CiAgICB2aWV3cG9ydExvYWRUYWcoKTsKCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigib3JpZW50YXRpb25jaGFuZ2UiLCBmdW5jdGlvbigpewogICAgICBzZXRUaW1lb3V0KHZpZXdwb3J0VXBkYXRlLCAxMDAwKTsKICAgIH0sIGZhbHNlKTsKICB9KTsKCiAgKGZ1bmN0aW9uKGlvbmljKSB7CiAgICAndXNlIHN0cmljdCc7CiAgICBpb25pYy52aWV3cy5WaWV3ID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKCiAgICBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQgPSBpb25pYy5pbmhlcml0OwoKICAgIGlvbmljLmV4dGVuZChpb25pYy52aWV3cy5WaWV3LnByb3RvdHlwZSwgewogICAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHt9CiAgICB9KTsKCiAgfSkod2luZG93LmlvbmljKTsKCiAgLyoKICAgKiBTY3JvbGxlcgogICAqIGh0dHA6Ly9naXRodWIuY29tL3p5bmdhL3Njcm9sbGVyCiAgICoKICAgKiBDb3B5cmlnaHQgMjAxMSwgWnluZ2EgSW5jLgogICAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4KICAgKiBodHRwczovL3Jhdy5naXRodWIuY29tL3p5bmdhL3Njcm9sbGVyL21hc3Rlci9NSVQtTElDRU5TRS50eHQKICAgKgogICAqIEJhc2VkIG9uIHRoZSB3b3JrIG9mOiBVbmlmeSBQcm9qZWN0ICh1bmlmeS1wcm9qZWN0Lm9yZykKICAgKiBodHRwOi8vdW5pZnktcHJvamVjdC5vcmcKICAgKiBDb3B5cmlnaHQgMjAxMSwgRGV1dHNjaGUgVGVsZWtvbSBBRwogICAqIExpY2Vuc2U6IE1JVCArIEFwYWNoZSAoVjIpCiAgICovCgogIC8qIGpzaGludCBlcW51bGw6IHRydWUgKi8KCiAgLyoqCiAgICogR2VuZXJpYyBhbmltYXRpb24gY2xhc3Mgd2l0aCBzdXBwb3J0IGZvciBkcm9wcGVkIGZyYW1lcyBib3RoIG9wdGlvbmFsIGVhc2luZyBhbmQgZHVyYXRpb24uCiAgICoKICAgKiBPcHRpb25hbCBkdXJhdGlvbiBpcyB1c2VmdWwgd2hlbiB0aGUgbGlmZXRpbWUgaXMgZGVmaW5lZCBieSBhbm90aGVyIGNvbmRpdGlvbiB0aGFuIHRpbWUKICAgKiBlLmcuIHNwZWVkIG9mIGFuIGFuaW1hdGluZyBvYmplY3QsIGV0Yy4KICAgKgogICAqIERyb3BwZWQgZnJhbWUgbG9naWMgYWxsb3dzIHRvIGtlZXAgdXNpbmcgdGhlIHNhbWUgdXBkYXRlciBsb2dpYyBpbmRlcGVuZGVudCBmcm9tIHRoZSBhY3R1YWwKICAgKiByZW5kZXJpbmcuIFRoaXMgZWFzZXMgYSBsb3Qgb2YgY2FzZXMgd2hlcmUgaXQgbWlnaHQgYmUgcHJldHR5IGNvbXBsZXggdG8gYnJlYWsgZG93biBhIHN0YXRlCiAgICogYmFzZWQgb24gdGhlIHB1cmUgdGltZSBkaWZmZXJlbmNlLgogICAqLwogIHZhciB6eW5nYUNvcmUgPSB7IGVmZmVjdDoge30gfTsKICAoZnVuY3Rpb24oZ2xvYmFsKSB7CiAgICB2YXIgdGltZSA9IERhdGUubm93IHx8IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gK25ldyBEYXRlKCk7CiAgICB9OwogICAgdmFyIGRlc2lyZWRGcmFtZXMgPSA2MDsKICAgIHZhciBtaWxsaXNlY29uZHNQZXJTZWNvbmQgPSAxMDAwOwogICAgdmFyIHJ1bm5pbmcgPSB7fTsKICAgIHZhciBjb3VudGVyID0gMTsKCiAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUgPSB7CgogICAgICAvKioKICAgICAgICogQSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgd3JhcHBlciAvIHBvbHlmaWxsLgogICAgICAgKgogICAgICAgKiBAcGFyYW0gY2FsbGJhY2sge0Z1bmN0aW9ufSBUaGUgY2FsbGJhY2sgdG8gYmUgaW52b2tlZCBiZWZvcmUgdGhlIG5leHQgcmVwYWludC4KICAgICAgICogQHBhcmFtIHJvb3Qge0hUTUxFbGVtZW50fSBUaGUgcm9vdCBlbGVtZW50IGZvciB0aGUgcmVwYWludAogICAgICAgKi8KICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lOiAoZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIENoZWNrIGZvciByZXF1ZXN0IGFuaW1hdGlvbiBGcmFtZSBzdXBwb3J0CiAgICAgICAgdmFyIHJlcXVlc3RGcmFtZSA9IGdsb2JhbC5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgZ2xvYmFsLndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCBnbG9iYWwubW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8IGdsb2JhbC5vUmVxdWVzdEFuaW1hdGlvbkZyYW1lOwogICAgICAgIHZhciBpc05hdGl2ZSA9ICEhcmVxdWVzdEZyYW1lOwoKICAgICAgICBpZiAocmVxdWVzdEZyYW1lICYmICEvcmVxdWVzdEFuaW1hdGlvbkZyYW1lXChcKVxzKlx7XHMqXFtuYXRpdmUgY29kZVxdXHMqXH0vaS50ZXN0KHJlcXVlc3RGcmFtZS50b1N0cmluZygpKSkgewogICAgICAgICAgaXNOYXRpdmUgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmIChpc05hdGl2ZSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNhbGxiYWNrLCByb290KSB7CiAgICAgICAgICAgIHJlcXVlc3RGcmFtZShjYWxsYmFjaywgcm9vdCk7CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgdmFyIFRBUkdFVF9GUFMgPSA2MDsKICAgICAgICB2YXIgcmVxdWVzdHMgPSB7fTsKICAgICAgICB2YXIgcmVxdWVzdENvdW50ID0gMDsKICAgICAgICB2YXIgcmFmSGFuZGxlID0gMTsKICAgICAgICB2YXIgaW50ZXJ2YWxIYW5kbGUgPSBudWxsOwogICAgICAgIHZhciBsYXN0QWN0aXZlID0gK25ldyBEYXRlKCk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbihjYWxsYmFjaywgcm9vdCkgewogICAgICAgICAgdmFyIGNhbGxiYWNrSGFuZGxlID0gcmFmSGFuZGxlKys7CgogICAgICAgICAgLy8gU3RvcmUgY2FsbGJhY2sKICAgICAgICAgIHJlcXVlc3RzW2NhbGxiYWNrSGFuZGxlXSA9IGNhbGxiYWNrOwogICAgICAgICAgcmVxdWVzdENvdW50Kys7CgogICAgICAgICAgLy8gQ3JlYXRlIHRpbWVvdXQgYXQgZmlyc3QgcmVxdWVzdAogICAgICAgICAgaWYgKGludGVydmFsSGFuZGxlID09PSBudWxsKSB7CgogICAgICAgICAgICBpbnRlcnZhbEhhbmRsZSA9IHNldEludGVydmFsKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICB2YXIgdGltZSA9ICtuZXcgRGF0ZSgpOwogICAgICAgICAgICAgIHZhciBjdXJyZW50UmVxdWVzdHMgPSByZXF1ZXN0czsKCiAgICAgICAgICAgICAgLy8gUmVzZXQgZGF0YSBzdHJ1Y3R1cmUgYmVmb3JlIGV4ZWN1dGluZyBjYWxsYmFja3MKICAgICAgICAgICAgICByZXF1ZXN0cyA9IHt9OwogICAgICAgICAgICAgIHJlcXVlc3RDb3VudCA9IDA7CgogICAgICAgICAgICAgIGZvcih2YXIga2V5IGluIGN1cnJlbnRSZXF1ZXN0cykgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRSZXF1ZXN0cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRSZXF1ZXN0c1trZXldKHRpbWUpOwogICAgICAgICAgICAgICAgICBsYXN0QWN0aXZlID0gdGltZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIERpc2FibGUgdGhlIHRpbWVvdXQgd2hlbiBub3RoaW5nIGhhcHBlbnMgZm9yIGEgY2VydGFpbgogICAgICAgICAgICAgIC8vIHBlcmlvZCBvZiB0aW1lCiAgICAgICAgICAgICAgaWYgKHRpbWUgLSBsYXN0QWN0aXZlID4gMjUwMCkgewogICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbEhhbmRsZSk7CiAgICAgICAgICAgICAgICBpbnRlcnZhbEhhbmRsZSA9IG51bGw7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSwgMTAwMCAvIFRBUkdFVF9GUFMpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBjYWxsYmFja0hhbmRsZTsKICAgICAgICB9OwoKICAgICAgfSkoKSwKCgogICAgICAvKioKICAgICAgICogU3RvcHMgdGhlIGdpdmVuIGFuaW1hdGlvbi4KICAgICAgICoKICAgICAgICogQHBhcmFtIGlkIHtJbnRlZ2VyfSBVbmlxdWUgYW5pbWF0aW9uIElECiAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IFdoZXRoZXIgdGhlIGFuaW1hdGlvbiB3YXMgc3RvcHBlZCAoYWthLCB3YXMgcnVubmluZyBiZWZvcmUpCiAgICAgICAqLwogICAgICBzdG9wOiBmdW5jdGlvbihpZCkgewogICAgICAgIHZhciBjbGVhcmVkID0gcnVubmluZ1tpZF0gIT0gbnVsbDsKICAgICAgICBpZiAoY2xlYXJlZCkgewogICAgICAgICAgcnVubmluZ1tpZF0gPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGNsZWFyZWQ7CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIFdoZXRoZXIgdGhlIGdpdmVuIGFuaW1hdGlvbiBpcyBzdGlsbCBydW5uaW5nLgogICAgICAgKgogICAgICAgKiBAcGFyYW0gaWQge0ludGVnZXJ9IFVuaXF1ZSBhbmltYXRpb24gSUQKICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0gV2hldGhlciB0aGUgYW5pbWF0aW9uIGlzIHN0aWxsIHJ1bm5pbmcKICAgICAgICovCiAgICAgIGlzUnVubmluZzogZnVuY3Rpb24oaWQpIHsKICAgICAgICByZXR1cm4gcnVubmluZ1tpZF0gIT0gbnVsbDsKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogU3RhcnQgdGhlIGFuaW1hdGlvbi4KICAgICAgICoKICAgICAgICogQHBhcmFtIHN0ZXBDYWxsYmFjayB7RnVuY3Rpb259IFBvaW50ZXIgdG8gZnVuY3Rpb24gd2hpY2ggaXMgZXhlY3V0ZWQgb24gZXZlcnkgc3RlcC4KICAgICAgICogICBTaWduYXR1cmUgb2YgdGhlIG1ldGhvZCBzaG91bGQgYmUgYGZ1bmN0aW9uKHBlcmNlbnQsIG5vdywgdmlydHVhbCkgeyByZXR1cm4gY29udGludWVXaXRoQW5pbWF0aW9uOyB9YAogICAgICAgKiBAcGFyYW0gdmVyaWZ5Q2FsbGJhY2sge0Z1bmN0aW9ufSBFeGVjdXRlZCBiZWZvcmUgZXZlcnkgYW5pbWF0aW9uIHN0ZXAuCiAgICAgICAqICAgU2lnbmF0dXJlIG9mIHRoZSBtZXRob2Qgc2hvdWxkIGJlIGBmdW5jdGlvbigpIHsgcmV0dXJuIGNvbnRpbnVlV2l0aEFuaW1hdGlvbjsgfWAKICAgICAgICogQHBhcmFtIGNvbXBsZXRlZENhbGxiYWNrIHtGdW5jdGlvbn0KICAgICAgICogICBTaWduYXR1cmUgb2YgdGhlIG1ldGhvZCBzaG91bGQgYmUgYGZ1bmN0aW9uKGRyb3BwZWRGcmFtZXMsIGZpbmlzaGVkQW5pbWF0aW9uKSB7fWAKICAgICAgICogQHBhcmFtIGR1cmF0aW9uIHtJbnRlZ2VyfSBNaWxsaXNlY29uZHMgdG8gcnVuIHRoZSBhbmltYXRpb24KICAgICAgICogQHBhcmFtIGVhc2luZ01ldGhvZCB7RnVuY3Rpb259IFBvaW50ZXIgdG8gZWFzaW5nIGZ1bmN0aW9uCiAgICAgICAqICAgU2lnbmF0dXJlIG9mIHRoZSBtZXRob2Qgc2hvdWxkIGJlIGBmdW5jdGlvbihwZXJjZW50KSB7IHJldHVybiBtb2RpZmllZFZhbHVlOyB9YAogICAgICAgKiBAcGFyYW0gcm9vdCB7RWxlbWVudH0gUmVuZGVyIHJvb3QsIHdoZW4gYXZhaWxhYmxlLiBVc2VkIGZvciBpbnRlcm5hbAogICAgICAgKiAgIHVzYWdlIG9mIHJlcXVlc3RBbmltYXRpb25GcmFtZS4KICAgICAgICogQHJldHVybiB7SW50ZWdlcn0gSWRlbnRpZmllciBvZiBhbmltYXRpb24uIENhbiBiZSB1c2VkIHRvIHN0b3AgaXQgYW55IHRpbWUuCiAgICAgICAqLwogICAgICBzdGFydDogZnVuY3Rpb24oc3RlcENhbGxiYWNrLCB2ZXJpZnlDYWxsYmFjaywgY29tcGxldGVkQ2FsbGJhY2ssIGR1cmF0aW9uLCBlYXNpbmdNZXRob2QsIHJvb3QpIHsKCiAgICAgICAgdmFyIHN0YXJ0ID0gdGltZSgpOwogICAgICAgIHZhciBsYXN0RnJhbWUgPSBzdGFydDsKICAgICAgICB2YXIgcGVyY2VudCA9IDA7CiAgICAgICAgdmFyIGRyb3BDb3VudGVyID0gMDsKICAgICAgICB2YXIgaWQgPSBjb3VudGVyKys7CgogICAgICAgIGlmICghcm9vdCkgewogICAgICAgICAgcm9vdCA9IGRvY3VtZW50LmJvZHk7CiAgICAgICAgfQoKICAgICAgICAvLyBDb21wYWN0aW5nIHJ1bm5pbmcgZGIgYXV0b21hdGljYWxseSBldmVyeSBmZXcgbmV3IGFuaW1hdGlvbnMKICAgICAgICBpZiAoaWQgJSAyMCA9PT0gMCkgewogICAgICAgICAgdmFyIG5ld1J1bm5pbmcgPSB7fTsKICAgICAgICAgIGZvciAodmFyIHVzZWRJZCBpbiBydW5uaW5nKSB7CiAgICAgICAgICAgIG5ld1J1bm5pbmdbdXNlZElkXSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBydW5uaW5nID0gbmV3UnVubmluZzsKICAgICAgICB9CgogICAgICAgIC8vIFRoaXMgaXMgdGhlIGludGVybmFsIHN0ZXAgbWV0aG9kIHdoaWNoIGlzIGNhbGxlZCBldmVyeSBmZXcgbWlsbGlzZWNvbmRzCiAgICAgICAgdmFyIHN0ZXAgPSBmdW5jdGlvbih2aXJ0dWFsKSB7CgogICAgICAgICAgLy8gTm9ybWFsaXplIHZpcnR1YWwgdmFsdWUKICAgICAgICAgIHZhciByZW5kZXIgPSB2aXJ0dWFsICE9PSB0cnVlOwoKICAgICAgICAgIC8vIEdldCBjdXJyZW50IHRpbWUKICAgICAgICAgIHZhciBub3cgPSB0aW1lKCk7CgogICAgICAgICAgLy8gVmVyaWZpY2F0aW9uIGlzIGV4ZWN1dGVkIGJlZm9yZSBuZXh0IGFuaW1hdGlvbiBzdGVwCiAgICAgICAgICBpZiAoIXJ1bm5pbmdbaWRdIHx8ICh2ZXJpZnlDYWxsYmFjayAmJiAhdmVyaWZ5Q2FsbGJhY2soaWQpKSkgewoKICAgICAgICAgICAgcnVubmluZ1tpZF0gPSBudWxsOwogICAgICAgICAgICBjb21wbGV0ZWRDYWxsYmFjayAmJiBjb21wbGV0ZWRDYWxsYmFjayhkZXNpcmVkRnJhbWVzIC0gKGRyb3BDb3VudGVyIC8gKChub3cgLSBzdGFydCkgLyBtaWxsaXNlY29uZHNQZXJTZWNvbmQpKSwgaWQsIGZhbHNlKTsKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBGb3IgdGhlIGN1cnJlbnQgcmVuZGVyaW5nIHRvIGFwcGx5IGxldCdzIHVwZGF0ZSBvbWl0dGVkIHN0ZXBzIGluIG1lbW9yeS4KICAgICAgICAgIC8vIFRoaXMgaXMgaW1wb3J0YW50IHRvIGJyaW5nIGludGVybmFsIHN0YXRlIHZhcmlhYmxlcyB1cC10by1kYXRlIHdpdGggcHJvZ3Jlc3MgaW4gdGltZS4KICAgICAgICAgIGlmIChyZW5kZXIpIHsKCiAgICAgICAgICAgIHZhciBkcm9wcGVkRnJhbWVzID0gTWF0aC5yb3VuZCgobm93IC0gbGFzdEZyYW1lKSAvIChtaWxsaXNlY29uZHNQZXJTZWNvbmQgLyBkZXNpcmVkRnJhbWVzKSkgLSAxOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IE1hdGgubWluKGRyb3BwZWRGcmFtZXMsIDQpOyBqKyspIHsKICAgICAgICAgICAgICBzdGVwKHRydWUpOwogICAgICAgICAgICAgIGRyb3BDb3VudGVyKys7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9CgogICAgICAgICAgLy8gQ29tcHV0ZSBwZXJjZW50IHZhbHVlCiAgICAgICAgICBpZiAoZHVyYXRpb24pIHsKICAgICAgICAgICAgcGVyY2VudCA9IChub3cgLSBzdGFydCkgLyBkdXJhdGlvbjsKICAgICAgICAgICAgaWYgKHBlcmNlbnQgPiAxKSB7CiAgICAgICAgICAgICAgcGVyY2VudCA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBFeGVjdXRlIHN0ZXAgY2FsbGJhY2ssIHRoZW4uLi4KICAgICAgICAgIHZhciB2YWx1ZSA9IGVhc2luZ01ldGhvZCA/IGVhc2luZ01ldGhvZChwZXJjZW50KSA6IHBlcmNlbnQ7CiAgICAgICAgICBpZiAoKHN0ZXBDYWxsYmFjayh2YWx1ZSwgbm93LCByZW5kZXIpID09PSBmYWxzZSB8fCBwZXJjZW50ID09PSAxKSAmJiByZW5kZXIpIHsKICAgICAgICAgICAgcnVubmluZ1tpZF0gPSBudWxsOwogICAgICAgICAgICBjb21wbGV0ZWRDYWxsYmFjayAmJiBjb21wbGV0ZWRDYWxsYmFjayhkZXNpcmVkRnJhbWVzIC0gKGRyb3BDb3VudGVyIC8gKChub3cgLSBzdGFydCkgLyBtaWxsaXNlY29uZHNQZXJTZWNvbmQpKSwgaWQsIHBlcmNlbnQgPT09IDEgfHwgZHVyYXRpb24gPT0gbnVsbCk7CiAgICAgICAgICB9IGVsc2UgaWYgKHJlbmRlcikgewogICAgICAgICAgICBsYXN0RnJhbWUgPSBub3c7CiAgICAgICAgICAgIHp5bmdhQ29yZS5lZmZlY3QuQW5pbWF0ZS5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoc3RlcCwgcm9vdCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gTWFyayBhcyBydW5uaW5nCiAgICAgICAgcnVubmluZ1tpZF0gPSB0cnVlOwoKICAgICAgICAvLyBJbml0IGZpcnN0IHN0ZXAKICAgICAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHN0ZXAsIHJvb3QpOwoKICAgICAgICAvLyBSZXR1cm4gdW5pcXVlIGFuaW1hdGlvbiBJRAogICAgICAgIHJldHVybiBpZDsKICAgICAgfQogICAgfTsKICB9KSh0aGlzKTsKCiAgLyoKICAgKiBTY3JvbGxlcgogICAqIGh0dHA6Ly9naXRodWIuY29tL3p5bmdhL3Njcm9sbGVyCiAgICoKICAgKiBDb3B5cmlnaHQgMjAxMSwgWnluZ2EgSW5jLgogICAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4KICAgKiBodHRwczovL3Jhdy5naXRodWIuY29tL3p5bmdhL3Njcm9sbGVyL21hc3Rlci9NSVQtTElDRU5TRS50eHQKICAgKgogICAqIEJhc2VkIG9uIHRoZSB3b3JrIG9mOiBVbmlmeSBQcm9qZWN0ICh1bmlmeS1wcm9qZWN0Lm9yZykKICAgKiBodHRwOi8vdW5pZnktcHJvamVjdC5vcmcKICAgKiBDb3B5cmlnaHQgMjAxMSwgRGV1dHNjaGUgVGVsZWtvbSBBRwogICAqIExpY2Vuc2U6IE1JVCArIEFwYWNoZSAoVjIpCiAgICovCgogIHZhciBTY3JvbGxlcjsKCiAgKGZ1bmN0aW9uKGlvbmljKSB7CiAgICB2YXIgTk9PUCA9IGZ1bmN0aW9uKCl7fTsKCiAgICAvLyBFYXNpbmcgRXF1YXRpb25zIChjKSAyMDAzIFJvYmVydCBQZW5uZXIsIGFsbCByaWdodHMgcmVzZXJ2ZWQuCiAgICAvLyBPcGVuIHNvdXJjZSB1bmRlciB0aGUgQlNEIExpY2Vuc2UuCgogICAgLyoqCiAgICAgKiBAcGFyYW0gcG9zIHtOdW1iZXJ9IHBvc2l0aW9uIGJldHdlZW4gMCAoc3RhcnQgb2YgZWZmZWN0KSBhbmQgMSAoZW5kIG9mIGVmZmVjdCkKICAgICAqKi8KICAgIHZhciBlYXNlT3V0Q3ViaWMgPSBmdW5jdGlvbihwb3MpIHsKICAgICAgcmV0dXJuIChNYXRoLnBvdygocG9zIC0gMSksIDMpICsgMSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQHBhcmFtIHBvcyB7TnVtYmVyfSBwb3NpdGlvbiBiZXR3ZWVuIDAgKHN0YXJ0IG9mIGVmZmVjdCkgYW5kIDEgKGVuZCBvZiBlZmZlY3QpCiAgICAgKiovCiAgICB2YXIgZWFzZUluT3V0Q3ViaWMgPSBmdW5jdGlvbihwb3MpIHsKICAgICAgaWYgKChwb3MgLz0gMC41KSA8IDEpIHsKICAgICAgICByZXR1cm4gMC41ICogTWF0aC5wb3cocG9zLCAzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIDAuNSAqIChNYXRoLnBvdygocG9zIC0gMiksIDMpICsgMik7CiAgICB9OwoKCiAgICAvKioKICAgICAqIGlvbmljLnZpZXdzLlNjcm9sbAogICAgICogQSBwb3dlcmZ1bCBzY3JvbGwgdmlldyB3aXRoIHN1cHBvcnQgZm9yIGJvdW5jaW5nLCBwdWxsIHRvIHJlZnJlc2gsIGFuZCBwYWdpbmcuCiAgICAgKiBAcGFyYW0gICB7T2JqZWN0fSAgICAgICAgb3B0aW9ucyBvcHRpb25zIGZvciB0aGUgc2Nyb2xsIHZpZXcKICAgICAqIEBjbGFzcyBBIHNjcm9sbCB2aWV3IHN5c3RlbQogICAgICogQG1lbWJlcm9mIGlvbmljLnZpZXdzCiAgICAgKi8KICAgIGlvbmljLnZpZXdzLlNjcm9sbCA9IGlvbmljLnZpZXdzLlZpZXcuaW5oZXJpdCh7CiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHRoaXMuX19jb250YWluZXIgPSBvcHRpb25zLmVsOwogICAgICAgIHRoaXMuX19jb250ZW50ID0gb3B0aW9ucy5lbC5maXJzdEVsZW1lbnRDaGlsZDsKCiAgICAgICAgLy9SZW1vdmUgYW55IHNjcm9sbFRvcCBhdHRhY2hlZCB0byB0aGVzZSBlbGVtZW50czsgdGhleSBhcmUgdmlydHVhbCBzY3JvbGwgbm93CiAgICAgICAgLy9UaGlzIGFsc28gc3RvcHMgb24tbG9hZC1zY3JvbGwtdG8td2luZG93LmxvY2F0aW9uLmhhc2ggdGhhdCB0aGUgYnJvd3NlciBkb2VzCiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChzZWxmLl9fY29udGFpbmVyICYmIHNlbGYuX19jb250ZW50KSB7CiAgICAgICAgICAgIHNlbGYuX19jb250YWluZXIuc2Nyb2xsVG9wID0gMDsKICAgICAgICAgICAgc2VsZi5fX2NvbnRlbnQuc2Nyb2xsVG9wID0gMDsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5vcHRpb25zID0gewoKICAgICAgICAgIC8qKiBEaXNhYmxlIHNjcm9sbGluZyBvbiB4LWF4aXMgYnkgZGVmYXVsdCAqLwogICAgICAgICAgc2Nyb2xsaW5nWDogZmFsc2UsCiAgICAgICAgICBzY3JvbGxiYXJYOiB0cnVlLAoKICAgICAgICAgIC8qKiBFbmFibGUgc2Nyb2xsaW5nIG9uIHktYXhpcyAqLwogICAgICAgICAgc2Nyb2xsaW5nWTogdHJ1ZSwKICAgICAgICAgIHNjcm9sbGJhclk6IHRydWUsCgogICAgICAgICAgc3RhcnRYOiAwLAogICAgICAgICAgc3RhcnRZOiAwLAoKICAgICAgICAgIC8qKiBUaGUgYW1vdW50IHRvIGRhbXBlbiBtb3VzZXdoZWVsIGV2ZW50cyAqLwogICAgICAgICAgd2hlZWxEYW1wZW46IDYsCgogICAgICAgICAgLyoqIFRoZSBtaW5pbXVtIHNpemUgdGhlIHNjcm9sbGJhcnMgc2NhbGUgdG8gd2hpbGUgc2Nyb2xsaW5nICovCiAgICAgICAgICBtaW5TY3JvbGxiYXJTaXplWDogNSwKICAgICAgICAgIG1pblNjcm9sbGJhclNpemVZOiA1LAoKICAgICAgICAgIC8qKiBTY3JvbGxiYXIgZmFkaW5nIGFmdGVyIHNjcm9sbGluZyAqLwogICAgICAgICAgc2Nyb2xsYmFyc0ZhZGU6IHRydWUsCiAgICAgICAgICBzY3JvbGxiYXJGYWRlRGVsYXk6IDMwMCwKICAgICAgICAgIC8qKiBUaGUgaW5pdGlhbCBmYWRlIGRlbGF5IHdoZW4gdGhlIHBhbmUgaXMgcmVzaXplZCBvciBpbml0aWFsaXplZCAqLwogICAgICAgICAgc2Nyb2xsYmFyUmVzaXplRmFkZURlbGF5OiAxMDAwLAoKICAgICAgICAgIC8qKiBFbmFibGUgYW5pbWF0aW9ucyBmb3IgZGVjZWxlcmF0aW9uLCBzbmFwIGJhY2ssIHpvb21pbmcgYW5kIHNjcm9sbGluZyAqLwogICAgICAgICAgYW5pbWF0aW5nOiB0cnVlLAoKICAgICAgICAgIC8qKiBkdXJhdGlvbiBmb3IgYW5pbWF0aW9ucyB0cmlnZ2VyZWQgYnkgc2Nyb2xsVG8vem9vbVRvICovCiAgICAgICAgICBhbmltYXRpb25EdXJhdGlvbjogMjUwLAoKICAgICAgICAgIC8qKiBFbmFibGUgYm91bmNpbmcgKGNvbnRlbnQgY2FuIGJlIHNsb3dseSBtb3ZlZCBvdXRzaWRlIGFuZCBqdW1wcyBiYWNrIGFmdGVyIHJlbGVhc2luZykgKi8KICAgICAgICAgIGJvdW5jaW5nOiB0cnVlLAoKICAgICAgICAgIC8qKiBFbmFibGUgbG9ja2luZyB0byB0aGUgbWFpbiBheGlzIGlmIHVzZXIgbW92ZXMgb25seSBzbGlnaHRseSBvbiBvbmUgb2YgdGhlbSBhdCBzdGFydCAqLwogICAgICAgICAgbG9ja2luZzogdHJ1ZSwKCiAgICAgICAgICAvKiogRW5hYmxlIHBhZ2luYXRpb24gbW9kZSAoc3dpdGNoaW5nIGJldHdlZW4gZnVsbCBwYWdlIGNvbnRlbnQgcGFuZXMpICovCiAgICAgICAgICBwYWdpbmc6IGZhbHNlLAoKICAgICAgICAgIC8qKiBFbmFibGUgc25hcHBpbmcgb2YgY29udGVudCB0byBhIGNvbmZpZ3VyZWQgcGl4ZWwgZ3JpZCAqLwogICAgICAgICAgc25hcHBpbmc6IGZhbHNlLAoKICAgICAgICAgIC8qKiBFbmFibGUgem9vbWluZyBvZiBjb250ZW50IHZpYSBBUEksIGZpbmdlcnMgYW5kIG1vdXNlIHdoZWVsICovCiAgICAgICAgICB6b29taW5nOiBmYWxzZSwKCiAgICAgICAgICAvKiogTWluaW11bSB6b29tIGxldmVsICovCiAgICAgICAgICBtaW5ab29tOiAwLjUsCgogICAgICAgICAgLyoqIE1heGltdW0gem9vbSBsZXZlbCAqLwogICAgICAgICAgbWF4Wm9vbTogMywKCiAgICAgICAgICAvKiogTXVsdGlwbHkgb3IgZGVjcmVhc2Ugc2Nyb2xsaW5nIHNwZWVkICoqLwogICAgICAgICAgc3BlZWRNdWx0aXBsaWVyOiAxLAoKICAgICAgICAgIGRlY2VsZXJhdGlvbjogMC45NywKCiAgICAgICAgICAvKiogQ2FsbGJhY2sgdGhhdCBpcyBmaXJlZCBvbiB0aGUgbGF0ZXIgb2YgdG91Y2ggZW5kIG9yIGRlY2VsZXJhdGlvbiBlbmQsCiAgICAgICAgICAgcHJvdmlkZWQgdGhhdCBhbm90aGVyIHNjcm9sbGluZyBhY3Rpb24gaGFzIG5vdCBiZWd1bi4gVXNlZCB0byBrbm93CiAgICAgICAgICAgd2hlbiB0byBmYWRlIG91dCBhIHNjcm9sbGJhci4gKi8KICAgICAgICAgIHNjcm9sbGluZ0NvbXBsZXRlOiBOT09QLAoKICAgICAgICAgIC8qKiBUaGlzIGNvbmZpZ3VyZXMgdGhlIGFtb3VudCBvZiBjaGFuZ2UgYXBwbGllZCB0byBkZWNlbGVyYXRpb24gd2hlbiByZWFjaGluZyBib3VuZGFyaWVzICAqKi8KICAgICAgICAgIHBlbmV0cmF0aW9uRGVjZWxlcmF0aW9uIDogMC4wMywKCiAgICAgICAgICAvKiogVGhpcyBjb25maWd1cmVzIHRoZSBhbW91bnQgb2YgY2hhbmdlIGFwcGxpZWQgdG8gYWNjZWxlcmF0aW9uIHdoZW4gcmVhY2hpbmcgYm91bmRhcmllcyAgKiovCiAgICAgICAgICBwZW5ldHJhdGlvbkFjY2VsZXJhdGlvbiA6IDAuMDgsCgogICAgICAgICAgLy8gVGhlIG1zIGludGVydmFsIGZvciB0cmlnZ2VyaW5nIHNjcm9sbCBldmVudHMKICAgICAgICAgIHNjcm9sbEV2ZW50SW50ZXJ2YWw6IDEwLAoKICAgICAgICAgIGdldENvbnRlbnRXaWR0aDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1heChzZWxmLl9fY29udGVudC5zY3JvbGxXaWR0aCwgc2VsZi5fX2NvbnRlbnQub2Zmc2V0V2lkdGgpOwogICAgICAgICAgfSwKICAgICAgICAgIGdldENvbnRlbnRIZWlnaHQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgoc2VsZi5fX2NvbnRlbnQuc2Nyb2xsSGVpZ2h0LCBzZWxmLl9fY29udGVudC5vZmZzZXRIZWlnaHQgKyBzZWxmLl9fY29udGVudC5vZmZzZXRUb3ApOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGZvciAodmFyIGtleSBpbiBvcHRpb25zKSB7CiAgICAgICAgICB0aGlzLm9wdGlvbnNba2V5XSA9IG9wdGlvbnNba2V5XTsKICAgICAgICB9CgogICAgICAgIHRoaXMuaGludFJlc2l6ZSA9IGlvbmljLmRlYm91bmNlKGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VsZi5yZXNpemUoKTsKICAgICAgICB9LCAxMDAwLCB0cnVlKTsKCiAgICAgICAgdGhpcy5vblNjcm9sbCA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAgIGlmKCFpb25pYy5zY3JvbGwuaXNTY3JvbGxpbmcpIHsKICAgICAgICAgICAgc2V0VGltZW91dChzZWxmLnNldFNjcm9sbFN0YXJ0LCA1MCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjbGVhclRpbWVvdXQoc2VsZi5zY3JvbGxUaW1lcik7CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsVGltZXIgPSBzZXRUaW1lb3V0KHNlbGYuc2V0U2Nyb2xsU3RvcCwgODApOwogICAgICAgICAgfQoKICAgICAgICB9OwoKICAgICAgICB0aGlzLnNldFNjcm9sbFN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpb25pYy5zY3JvbGwuaXNTY3JvbGxpbmcgPSBNYXRoLmFicyhpb25pYy5zY3JvbGwubGFzdFRvcCAtIHNlbGYuX19zY3JvbGxUb3ApID4gMTsKICAgICAgICAgIGNsZWFyVGltZW91dChzZWxmLnNjcm9sbFRpbWVyKTsKICAgICAgICAgIHNlbGYuc2Nyb2xsVGltZXIgPSBzZXRUaW1lb3V0KHNlbGYuc2V0U2Nyb2xsU3RvcCwgODApOwogICAgICAgIH07CgogICAgICAgIHRoaXMuc2V0U2Nyb2xsU3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaW9uaWMuc2Nyb2xsLmlzU2Nyb2xsaW5nID0gZmFsc2U7CiAgICAgICAgICBpb25pYy5zY3JvbGwubGFzdFRvcCA9IHNlbGYuX19zY3JvbGxUb3A7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy50cmlnZ2VyU2Nyb2xsRXZlbnQgPSBpb25pYy50aHJvdHRsZShmdW5jdGlvbigpIHsKICAgICAgICAgIHNlbGYub25TY3JvbGwoKTsKICAgICAgICAgIGlvbmljLnRyaWdnZXIoJ3Njcm9sbCcsIHsKICAgICAgICAgICAgc2Nyb2xsVG9wOiBzZWxmLl9fc2Nyb2xsVG9wLAogICAgICAgICAgICBzY3JvbGxMZWZ0OiBzZWxmLl9fc2Nyb2xsTGVmdCwKICAgICAgICAgICAgdGFyZ2V0OiBzZWxmLl9fY29udGFpbmVyCiAgICAgICAgICB9KTsKICAgICAgICB9LCB0aGlzLm9wdGlvbnMuc2Nyb2xsRXZlbnRJbnRlcnZhbCk7CgogICAgICAgIHRoaXMudHJpZ2dlclNjcm9sbEVuZEV2ZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpb25pYy50cmlnZ2VyKCdzY3JvbGxlbmQnLCB7CiAgICAgICAgICAgIHNjcm9sbFRvcDogc2VsZi5fX3Njcm9sbFRvcCwKICAgICAgICAgICAgc2Nyb2xsTGVmdDogc2VsZi5fX3Njcm9sbExlZnQsCiAgICAgICAgICAgIHRhcmdldDogc2VsZi5fX2NvbnRhaW5lcgogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5fX3Njcm9sbExlZnQgPSB0aGlzLm9wdGlvbnMuc3RhcnRYOwogICAgICAgIHRoaXMuX19zY3JvbGxUb3AgPSB0aGlzLm9wdGlvbnMuc3RhcnRZOwoKICAgICAgICAvLyBHZXQgdGhlIHJlbmRlciB1cGRhdGUgZnVuY3Rpb24sIGluaXRpYWxpemUgZXZlbnQgaGFuZGxlcnMsCiAgICAgICAgLy8gYW5kIGNhbGN1bGF0ZSB0aGUgc2l6ZSBvZiB0aGUgc2Nyb2xsIGNvbnRhaW5lcgogICAgICAgIHRoaXMuX19jYWxsYmFjayA9IHRoaXMuZ2V0UmVuZGVyRm4oKTsKICAgICAgICB0aGlzLl9faW5pdEV2ZW50SGFuZGxlcnMoKTsKICAgICAgICB0aGlzLl9fY3JlYXRlU2Nyb2xsYmFycygpOwoKICAgICAgfSwKCiAgICAgIHJ1bjogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZXNpemUoKTsKCiAgICAgICAgLy8gRmFkZSB0aGVtIG91dAogICAgICAgIHRoaXMuX19mYWRlU2Nyb2xsYmFycygnb3V0JywgdGhpcy5vcHRpb25zLnNjcm9sbGJhclJlc2l6ZUZhZGVEZWxheSk7CiAgICAgIH0sCgoKCiAgICAgIC8qCiAgICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgIElOVEVSTkFMIEZJRUxEUyA6OiBTVEFUVVMKICAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgKi8KCiAgICAgIC8qKiBXaGV0aGVyIG9ubHkgYSBzaW5nbGUgZmluZ2VyIGlzIHVzZWQgaW4gdG91Y2ggaGFuZGxpbmcgKi8KICAgICAgX19pc1NpbmdsZVRvdWNoOiBmYWxzZSwKCiAgICAgIC8qKiBXaGV0aGVyIGEgdG91Y2ggZXZlbnQgc2VxdWVuY2UgaXMgaW4gcHJvZ3Jlc3MgKi8KICAgICAgX19pc1RyYWNraW5nOiBmYWxzZSwKCiAgICAgIC8qKiBXaGV0aGVyIGEgZGVjZWxlcmF0aW9uIGFuaW1hdGlvbiB3ZW50IHRvIGNvbXBsZXRpb24uICovCiAgICAgIF9fZGlkRGVjZWxlcmF0aW9uQ29tcGxldGU6IGZhbHNlLAoKICAgICAgLyoqCiAgICAgICAqIFdoZXRoZXIgYSBnZXN0dXJlIHpvb20vcm90YXRlIGV2ZW50IGlzIGluIHByb2dyZXNzLiBBY3RpdmF0ZXMgd2hlbgogICAgICAgKiBhIGdlc3R1cmVzdGFydCBldmVudCBoYXBwZW5zLiBUaGlzIGhhcyBoaWdoZXIgcHJpb3JpdHkgdGhhbiBkcmFnZ2luZy4KICAgICAgICovCiAgICAgIF9faXNHZXN0dXJpbmc6IGZhbHNlLAoKICAgICAgLyoqCiAgICAgICAqIFdoZXRoZXIgdGhlIHVzZXIgaGFzIG1vdmVkIGJ5IHN1Y2ggYSBkaXN0YW5jZSB0aGF0IHdlIGhhdmUgZW5hYmxlZAogICAgICAgKiBkcmFnZ2luZyBtb2RlLiBIaW50OiBJdCdzIG9ubHkgZW5hYmxlZCBhZnRlciBzb21lIHBpeGVscyBvZiBtb3ZlbWVudCB0bwogICAgICAgKiBub3QgaW50ZXJydXB0IHdpdGggY2xpY2tzIGV0Yy4KICAgICAgICovCiAgICAgIF9faXNEcmFnZ2luZzogZmFsc2UsCgogICAgICAvKioKICAgICAgICogTm90IHRvdWNoaW5nIGFuZCBkcmFnZ2luZyBhbnltb3JlLCBhbmQgc21vb3RobHkgYW5pbWF0aW5nIHRoZQogICAgICAgKiB0b3VjaCBzZXF1ZW5jZSB1c2luZyBkZWNlbGVyYXRpb24uCiAgICAgICAqLwogICAgICBfX2lzRGVjZWxlcmF0aW5nOiBmYWxzZSwKCiAgICAgIC8qKgogICAgICAgKiBTbW9vdGhseSBhbmltYXRpbmcgdGhlIGN1cnJlbnRseSBjb25maWd1cmVkIGNoYW5nZQogICAgICAgKi8KICAgICAgX19pc0FuaW1hdGluZzogZmFsc2UsCgoKCiAgICAgIC8qCiAgICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgIElOVEVSTkFMIEZJRUxEUyA6OiBESU1FTlNJT05TCiAgICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICovCgogICAgICAvKiogQXZhaWxhYmxlIG91dGVyIGxlZnQgcG9zaXRpb24gKGZyb20gZG9jdW1lbnQgcGVyc3BlY3RpdmUpICovCiAgICAgIF9fY2xpZW50TGVmdDogMCwKCiAgICAgIC8qKiBBdmFpbGFibGUgb3V0ZXIgdG9wIHBvc2l0aW9uIChmcm9tIGRvY3VtZW50IHBlcnNwZWN0aXZlKSAqLwogICAgICBfX2NsaWVudFRvcDogMCwKCiAgICAgIC8qKiBBdmFpbGFibGUgb3V0ZXIgd2lkdGggKi8KICAgICAgX19jbGllbnRXaWR0aDogMCwKCiAgICAgIC8qKiBBdmFpbGFibGUgb3V0ZXIgaGVpZ2h0ICovCiAgICAgIF9fY2xpZW50SGVpZ2h0OiAwLAoKICAgICAgLyoqIE91dGVyIHdpZHRoIG9mIGNvbnRlbnQgKi8KICAgICAgX19jb250ZW50V2lkdGg6IDAsCgogICAgICAvKiogT3V0ZXIgaGVpZ2h0IG9mIGNvbnRlbnQgKi8KICAgICAgX19jb250ZW50SGVpZ2h0OiAwLAoKICAgICAgLyoqIFNuYXBwaW5nIHdpZHRoIGZvciBjb250ZW50ICovCiAgICAgIF9fc25hcFdpZHRoOiAxMDAsCgogICAgICAvKiogU25hcHBpbmcgaGVpZ2h0IGZvciBjb250ZW50ICovCiAgICAgIF9fc25hcEhlaWdodDogMTAwLAoKICAgICAgLyoqIEhlaWdodCB0byBhc3NpZ24gdG8gcmVmcmVzaCBhcmVhICovCiAgICAgIF9fcmVmcmVzaEhlaWdodDogbnVsbCwKCiAgICAgIC8qKiBXaGV0aGVyIHRoZSByZWZyZXNoIHByb2Nlc3MgaXMgZW5hYmxlZCB3aGVuIHRoZSBldmVudCBpcyByZWxlYXNlZCBub3cgKi8KICAgICAgX19yZWZyZXNoQWN0aXZlOiBmYWxzZSwKCiAgICAgIC8qKiBDYWxsYmFjayB0byBleGVjdXRlIG9uIGFjdGl2YXRpb24uIFRoaXMgaXMgZm9yIHNpZ25hbGxpbmcgdGhlIHVzZXIgYWJvdXQgYSByZWZyZXNoIGlzIGFib3V0IHRvIGhhcHBlbiB3aGVuIGhlIHJlbGVhc2UgKi8KICAgICAgX19yZWZyZXNoQWN0aXZhdGU6IG51bGwsCgogICAgICAvKiogQ2FsbGJhY2sgdG8gZXhlY3V0ZSBvbiBkZWFjdGl2YXRpb24uIFRoaXMgaXMgZm9yIHNpZ25hbGxpbmcgdGhlIHVzZXIgYWJvdXQgdGhlIHJlZnJlc2ggYmVpbmcgY2FuY2VsbGVkICovCiAgICAgIF9fcmVmcmVzaERlYWN0aXZhdGU6IG51bGwsCgogICAgICAvKiogQ2FsbGJhY2sgdG8gZXhlY3V0ZSB0byBzdGFydCB0aGUgYWN0dWFsIHJlZnJlc2guIENhbGwge0BsaW5rICNyZWZyZXNoRmluaXNofSB3aGVuIGRvbmUgKi8KICAgICAgX19yZWZyZXNoU3RhcnQ6IG51bGwsCgogICAgICAvKiogWm9vbSBsZXZlbCAqLwogICAgICBfX3pvb21MZXZlbDogMSwKCiAgICAgIC8qKiBTY3JvbGwgcG9zaXRpb24gb24geC1heGlzICovCiAgICAgIF9fc2Nyb2xsTGVmdDogMCwKCiAgICAgIC8qKiBTY3JvbGwgcG9zaXRpb24gb24geS1heGlzICovCiAgICAgIF9fc2Nyb2xsVG9wOiAwLAoKICAgICAgLyoqIE1heGltdW0gYWxsb3dlZCBzY3JvbGwgcG9zaXRpb24gb24geC1heGlzICovCiAgICAgIF9fbWF4U2Nyb2xsTGVmdDogMCwKCiAgICAgIC8qKiBNYXhpbXVtIGFsbG93ZWQgc2Nyb2xsIHBvc2l0aW9uIG9uIHktYXhpcyAqLwogICAgICBfX21heFNjcm9sbFRvcDogMCwKCiAgICAgIC8qIFNjaGVkdWxlZCBsZWZ0IHBvc2l0aW9uIChmaW5hbCBwb3NpdGlvbiB3aGVuIGFuaW1hdGluZykgKi8KICAgICAgX19zY2hlZHVsZWRMZWZ0OiAwLAoKICAgICAgLyogU2NoZWR1bGVkIHRvcCBwb3NpdGlvbiAoZmluYWwgcG9zaXRpb24gd2hlbiBhbmltYXRpbmcpICovCiAgICAgIF9fc2NoZWR1bGVkVG9wOiAwLAoKICAgICAgLyogU2NoZWR1bGVkIHpvb20gbGV2ZWwgKGZpbmFsIHNjYWxlIHdoZW4gYW5pbWF0aW5nKSAqLwogICAgICBfX3NjaGVkdWxlZFpvb206IDAsCgoKCiAgICAgIC8qCiAgICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgIElOVEVSTkFMIEZJRUxEUyA6OiBMQVNUIFBPU0lUSU9OUwogICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAqLwoKICAgICAgLyoqIExlZnQgcG9zaXRpb24gb2YgZmluZ2VyIGF0IHN0YXJ0ICovCiAgICAgIF9fbGFzdFRvdWNoTGVmdDogbnVsbCwKCiAgICAgIC8qKiBUb3AgcG9zaXRpb24gb2YgZmluZ2VyIGF0IHN0YXJ0ICovCiAgICAgIF9fbGFzdFRvdWNoVG9wOiBudWxsLAoKICAgICAgLyoqIFRpbWVzdGFtcCBvZiBsYXN0IG1vdmUgb2YgZmluZ2VyLiBVc2VkIHRvIGxpbWl0IHRyYWNraW5nIHJhbmdlIGZvciBkZWNlbGVyYXRpb24gc3BlZWQuICovCiAgICAgIF9fbGFzdFRvdWNoTW92ZTogbnVsbCwKCiAgICAgIC8qKiBMaXN0IG9mIHBvc2l0aW9ucywgdXNlcyB0aHJlZSBpbmRleGVzIGZvciBlYWNoIHN0YXRlOiBsZWZ0LCB0b3AsIHRpbWVzdGFtcCAqLwogICAgICBfX3Bvc2l0aW9uczogbnVsbCwKCgoKICAgICAgLyoKICAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgSU5URVJOQUwgRklFTERTIDo6IERFQ0VMRVJBVElPTiBTVVBQT1JUCiAgICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICovCgogICAgICAvKiogTWluaW11bSBsZWZ0IHNjcm9sbCBwb3NpdGlvbiBkdXJpbmcgZGVjZWxlcmF0aW9uICovCiAgICAgIF9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsTGVmdDogbnVsbCwKCiAgICAgIC8qKiBNaW5pbXVtIHRvcCBzY3JvbGwgcG9zaXRpb24gZHVyaW5nIGRlY2VsZXJhdGlvbiAqLwogICAgICBfX21pbkRlY2VsZXJhdGlvblNjcm9sbFRvcDogbnVsbCwKCiAgICAgIC8qKiBNYXhpbXVtIGxlZnQgc2Nyb2xsIHBvc2l0aW9uIGR1cmluZyBkZWNlbGVyYXRpb24gKi8KICAgICAgX19tYXhEZWNlbGVyYXRpb25TY3JvbGxMZWZ0OiBudWxsLAoKICAgICAgLyoqIE1heGltdW0gdG9wIHNjcm9sbCBwb3NpdGlvbiBkdXJpbmcgZGVjZWxlcmF0aW9uICovCiAgICAgIF9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsVG9wOiBudWxsLAoKICAgICAgLyoqIEN1cnJlbnQgZmFjdG9yIHRvIG1vZGlmeSBob3Jpem9udGFsIHNjcm9sbCBwb3NpdGlvbiB3aXRoIG9uIGV2ZXJ5IHN0ZXAgKi8KICAgICAgX19kZWNlbGVyYXRpb25WZWxvY2l0eVg6IG51bGwsCgogICAgICAvKiogQ3VycmVudCBmYWN0b3IgdG8gbW9kaWZ5IHZlcnRpY2FsIHNjcm9sbCBwb3NpdGlvbiB3aXRoIG9uIGV2ZXJ5IHN0ZXAgKi8KICAgICAgX19kZWNlbGVyYXRpb25WZWxvY2l0eVk6IG51bGwsCgoKICAgICAgLyoqIHRoZSBicm93c2VyLXNwZWNpZmljIHByb3BlcnR5IHRvIHVzZSBmb3IgdHJhbnNmb3JtcyAqLwogICAgICBfX3RyYW5zZm9ybVByb3BlcnR5OiBudWxsLAogICAgICBfX3BlcnNwZWN0aXZlUHJvcGVydHk6IG51bGwsCgogICAgICAvKiogc2Nyb2xsYmFyIGluZGljYXRvcnMgKi8KICAgICAgX19pbmRpY2F0b3JYOiBudWxsLAogICAgICBfX2luZGljYXRvclk6IG51bGwsCgogICAgICAvKiogVGltZW91dCBmb3Igc2Nyb2xsYmFyIGZhZGluZyAqLwogICAgICBfX3Njcm9sbGJhckZhZGVUaW1lb3V0OiBudWxsLAoKICAgICAgLyoqIHdoZXRoZXIgd2UndmUgdHJpZWQgdG8gd2FpdCBmb3Igc2l6ZSBhbHJlYWR5ICovCiAgICAgIF9fZGlkV2FpdEZvclNpemU6IG51bGwsCiAgICAgIF9fc2l6ZXJUaW1lb3V0OiBudWxsLAoKICAgICAgX19pbml0RXZlbnRIYW5kbGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAvLyBFdmVudCBIYW5kbGVyCiAgICAgICAgdmFyIGNvbnRhaW5lciA9IHRoaXMuX19jb250YWluZXI7CgogICAgICAgIC8vQnJvYWRjYXN0ZWQgd2hlbiBrZXlib2FyZCBpcyBzaG93biBvbiBzb21lIHBsYXRmb3Jtcy4KICAgICAgICAvL1NlZSBqcy91dGlscy9rZXlib2FyZC5qcwogICAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGxDaGlsZEludG9WaWV3JywgZnVuY3Rpb24oZSkgewoKICAgICAgICAgIC8vZGlzdGFuY2UgZnJvbSBib3R0b20gb2Ygc2Nyb2xsdmlldyB0byB0b3Agb2Ygdmlld3BvcnQKICAgICAgICAgIHZhciBzY3JvbGxCb3R0b21PZmZzZXRUb1RvcDsKCiAgICAgICAgICBpZiggIXNlbGYuaXNTY3JvbGxlZEludG9WaWV3ICkgewogICAgICAgICAgICAvLyBzaHJpbmsgc2Nyb2xsdmlldyBzbyB3ZSBjYW4gYWN0dWFsbHkgc2Nyb2xsIGlmIHRoZSBpbnB1dCBpcyBoaWRkZW4KICAgICAgICAgICAgLy8gaWYgaXQgaXNuJ3Qgc2hyaW5rIHNvIHdlIGNhbiBzY3JvbGwgdG8gaW5wdXRzIHVuZGVyIHRoZSBrZXlib2FyZAogICAgICAgICAgICBpZiAoaW9uaWMuUGxhdGZvcm0uaXNJT1MoKSB8fCBpb25pYy5QbGF0Zm9ybS5pc0Z1bGxTY3JlZW4pewogICAgICAgICAgICAgIC8vIGlmIHRoZXJlIGFyZSB0aGluZ3MgYmVsb3cgdGhlIHNjcm9sbCB2aWV3IGFjY291bnQgZm9yIHRoZW0gYW5kCiAgICAgICAgICAgICAgLy8gc3VidHJhY3QgdGhlbSBmcm9tIHRoZSBrZXlib2FyZCBoZWlnaHQgd2hlbiByZXNpemluZwogICAgICAgICAgICAgIHNjcm9sbEJvdHRvbU9mZnNldFRvVG9wID0gY29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmJvdHRvbTsKICAgICAgICAgICAgICB2YXIgc2Nyb2xsQm90dG9tT2Zmc2V0VG9Cb3R0b20gPSBlLmRldGFpbC52aWV3cG9ydEhlaWdodCAtIHNjcm9sbEJvdHRvbU9mZnNldFRvVG9wOwogICAgICAgICAgICAgIHZhciBrZXlib2FyZE9mZnNldCA9IE1hdGgubWF4KDAsIGUuZGV0YWlsLmtleWJvYXJkSGVpZ2h0IC0gc2Nyb2xsQm90dG9tT2Zmc2V0VG9Cb3R0b20pOwogICAgICAgICAgICAgIGNvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSAoY29udGFpbmVyLmNsaWVudEhlaWdodCAtIGtleWJvYXJkT2Zmc2V0KSArICJweCI7CiAgICAgICAgICAgICAgY29udGFpbmVyLnN0eWxlLm92ZXJmbG93ID0gInZpc2libGUiOwogICAgICAgICAgICAgIC8vdXBkYXRlIHNjcm9sbCB2aWV3CiAgICAgICAgICAgICAgc2VsZi5yZXNpemUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLmlzU2Nyb2xsZWRJbnRvVmlldyA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgLy9JZiB0aGUgZWxlbWVudCBpcyBwb3NpdGlvbmVkIHVuZGVyIHRoZSBrZXlib2FyZC4uLgogICAgICAgICAgaWYoIGUuZGV0YWlsLmlzRWxlbWVudFVuZGVyS2V5Ym9hcmQgKSB7CiAgICAgICAgICAgIHZhciBkZWxheTsKICAgICAgICAgICAgLy8gV2FpdCBvbiBhbmRyb2lkIGZvciB3ZWIgdmlldyB0byByZXNpemUKICAgICAgICAgICAgaWYgKCBpb25pYy5QbGF0Zm9ybS5pc0FuZHJvaWQoKSAmJiAhaW9uaWMuUGxhdGZvcm0uaXNGdWxsU2NyZWVuICkgewogICAgICAgICAgICAgIC8vIGFuZHJvaWQgeSB1IHJlc2l6ZSBzbyBzbG93CiAgICAgICAgICAgICAgaWYgKCBpb25pYy5QbGF0Zm9ybS52ZXJzaW9uKCkgPCA0LjQpIHsKICAgICAgICAgICAgICAgIGRlbGF5ID0gNTAwOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBwcm9iYWJseSBvdmVya2lsbCBmb3IgY2hyb21lCiAgICAgICAgICAgICAgICBkZWxheSA9IDM1MDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGVsYXkgPSA4MDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9QdXQgZWxlbWVudCBpbiBtaWRkbGUgb2YgdmlzaWJsZSBzY3JlZW4KICAgICAgICAgICAgLy9XYWl0IGZvciBhbmRyb2lkIHRvIHVwZGF0ZSB2aWV3IGhlaWdodCBhbmQgcmVzaXplKCkgdG8gcmVzZXQgc2Nyb2xsIHBvc2l0aW9uCiAgICAgICAgICAgIGlvbmljLnNjcm9sbC5pc1Njcm9sbGluZyA9IHRydWU7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAvL21pZGRsZSBvZiB0aGUgc2Nyb2xsdmlldywgd2hlcmUgd2Ugd2FudCB0byBzY3JvbGwgdG8KICAgICAgICAgICAgICB2YXIgc2Nyb2xsTWlkcG9pbnRPZmZzZXQgPSBjb250YWluZXIuY2xpZW50SGVpZ2h0ICogMC41OwoKICAgICAgICAgICAgICBzY3JvbGxCb3R0b21PZmZzZXRUb1RvcCA9IGNvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5ib3R0b207CiAgICAgICAgICAgICAgLy9kaXN0YW5jZSBmcm9tIHRvcCBvZiBmb2N1c2VkIGVsZW1lbnQgdG8gdGhlIGJvdHRvbSBvZiB0aGUgc2Nyb2xsIHZpZXcKICAgICAgICAgICAgICB2YXIgZWxlbWVudFRvcE9mZnNldFRvU2Nyb2xsQm90dG9tID0gZS5kZXRhaWwuZWxlbWVudFRvcCAtIHNjcm9sbEJvdHRvbU9mZnNldFRvVG9wOwoKICAgICAgICAgICAgICB2YXIgc2Nyb2xsVG9wID0gZWxlbWVudFRvcE9mZnNldFRvU2Nyb2xsQm90dG9tICArIHNjcm9sbE1pZHBvaW50T2Zmc2V0OwoKICAgICAgICAgICAgICBpZiAoc2Nyb2xsVG9wID4gMCl7CiAgICAgICAgICAgICAgICBpb25pYy50YXAuY2xvbmVGb2N1c2VkSW5wdXQoY29udGFpbmVyLCBzZWxmKTsKICAgICAgICAgICAgICAgIHNlbGYuc2Nyb2xsQnkoMCwgc2Nyb2xsVG9wLCB0cnVlKTsKICAgICAgICAgICAgICAgIHNlbGYub25TY3JvbGwoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGRlbGF5KTsKICAgICAgICAgIH0KCiAgICAgICAgICAvL09ubHkgdGhlIGZpcnN0IHNjcm9sbFZpZXcgcGFyZW50IG9mIHRoZSBlbGVtZW50IHRoYXQgYnJvYWRjYXN0ZWQgdGhpcyBldmVudAogICAgICAgICAgLy8odGhlIGFjdGl2ZSBlbGVtZW50IHRoYXQgbmVlZHMgdG8gYmUgc2hvd24pIHNob3VsZCByZWNlaXZlIHRoaXMgZXZlbnQKICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgfSk7CgogICAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdyZXNldFNjcm9sbFZpZXcnLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAvL3JldHVybiBzY3JvbGx2aWV3IHRvIG9yaWdpbmFsIGhlaWdodCBvbmNlIGtleWJvYXJkIGhhcyBoaWRkZW4KICAgICAgICAgIHNlbGYuaXNTY3JvbGxlZEludG9WaWV3ID0gZmFsc2U7CiAgICAgICAgICBjb250YWluZXIuc3R5bGUuaGVpZ2h0ID0gIiI7CiAgICAgICAgICBjb250YWluZXIuc3R5bGUub3ZlcmZsb3cgPSAiIjsKICAgICAgICAgIHNlbGYucmVzaXplKCk7CiAgICAgICAgICBpb25pYy5zY3JvbGwuaXNTY3JvbGxpbmcgPSBmYWxzZTsKICAgICAgICB9KTsKCiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRUb3VjaGVzKGUpIHsKICAgICAgICAgIHJldHVybiBlLnRvdWNoZXMgJiYgZS50b3VjaGVzLmxlbmd0aCA/IGUudG91Y2hlcyA6IFt7CiAgICAgICAgICAgIHBhZ2VYOiBlLnBhZ2VYLAogICAgICAgICAgICBwYWdlWTogZS5wYWdlWQogICAgICAgICAgfV07CiAgICAgICAgfQoKICAgICAgICBzZWxmLnRvdWNoU3RhcnQgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICBzZWxmLnN0YXJ0Q29vcmRpbmF0ZXMgPSBnZXRQb2ludGVyQ29vcmRpbmF0ZXMoZSk7CgogICAgICAgICAgaWYgKCBpb25pYy50YXAuaWdub3JlU2Nyb2xsU3RhcnQoZSkgKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBzZWxmLl9faXNEb3duID0gdHJ1ZTsKCiAgICAgICAgICBpZiggaW9uaWMudGFwLmNvbnRhaW5zT3JJc1RleHRJbnB1dChlLnRhcmdldCkgfHwgZS50YXJnZXQudGFnTmFtZSA9PT0gJ1NFTEVDVCcgKSB7CiAgICAgICAgICAgIC8vIGRvIG5vdCBzdGFydCBpZiB0aGUgdGFyZ2V0IGlzIGEgdGV4dCBpbnB1dAogICAgICAgICAgICAvLyBpZiB0aGVyZSBpcyBhIHRvdWNobW92ZSBvbiB0aGlzIGlucHV0LCB0aGVuIHdlIGNhbiBzdGFydCB0aGUgc2Nyb2xsCiAgICAgICAgICAgIHNlbGYuX19oYXNTdGFydGVkID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICBzZWxmLl9faXNTZWxlY3RhYmxlID0gdHJ1ZTsKICAgICAgICAgIHNlbGYuX19lbmFibGVTY3JvbGxZID0gdHJ1ZTsKICAgICAgICAgIHNlbGYuX19oYXNTdGFydGVkID0gdHJ1ZTsKICAgICAgICAgIHNlbGYuZG9Ub3VjaFN0YXJ0KGdldEV2ZW50VG91Y2hlcyhlKSwgZS50aW1lU3RhbXApOwogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH07CgogICAgICAgIHNlbGYudG91Y2hNb3ZlID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgaWYoIXNlbGYuX19pc0Rvd24gfHwKICAgICAgICAgICAgZS5kZWZhdWx0UHJldmVudGVkIHx8CiAgICAgICAgICAgIChlLnRhcmdldC50YWdOYW1lID09PSAnVEVYVEFSRUEnICYmIGUudGFyZ2V0LnBhcmVudEVsZW1lbnQucXVlcnlTZWxlY3RvcignOmZvY3VzJykpICkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgaWYoICFzZWxmLl9faGFzU3RhcnRlZCAmJiAoIGlvbmljLnRhcC5jb250YWluc09ySXNUZXh0SW5wdXQoZS50YXJnZXQpIHx8IGUudGFyZ2V0LnRhZ05hbWUgPT09ICdTRUxFQ1QnICkgKSB7CiAgICAgICAgICAgIC8vIHRoZSB0YXJnZXQgaXMgYSB0ZXh0IGlucHV0IGFuZCBzY3JvbGwgaGFzIHN0YXJ0ZWQKICAgICAgICAgICAgLy8gc2luY2UgdGhlIHRleHQgaW5wdXQgZG9lc24ndCBzdGFydCBvbiB0b3VjaFN0YXJ0LCBkbyBpdCBoZXJlCiAgICAgICAgICAgIHNlbGYuX19oYXNTdGFydGVkID0gdHJ1ZTsKICAgICAgICAgICAgc2VsZi5kb1RvdWNoU3RhcnQoZ2V0RXZlbnRUb3VjaGVzKGUpLCBlLnRpbWVTdGFtcCk7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGlmKHNlbGYuc3RhcnRDb29yZGluYXRlcykgewogICAgICAgICAgICAvLyB3ZSBoYXZlIHN0YXJ0IGNvb3JkaW5hdGVzLCBzbyBnZXQgdGhpcyB0b3VjaCBtb3ZlJ3MgY3VycmVudCBjb29yZGluYXRlcwogICAgICAgICAgICB2YXIgY3VycmVudENvb3JkaW5hdGVzID0gZ2V0UG9pbnRlckNvb3JkaW5hdGVzKGUpOwoKICAgICAgICAgICAgaWYoIHNlbGYuX19pc1NlbGVjdGFibGUgJiYKICAgICAgICAgICAgICBpb25pYy50YXAuaXNUZXh0SW5wdXQoZS50YXJnZXQpICYmCiAgICAgICAgICAgICAgTWF0aC5hYnMoc2VsZi5zdGFydENvb3JkaW5hdGVzLnggLSBjdXJyZW50Q29vcmRpbmF0ZXMueCkgPiAyMCApIHsKICAgICAgICAgICAgICAvLyB1c2VyIHNsaWQgdGhlIHRleHQgaW5wdXQncyBjYXJldCBvbiBpdHMgeCBheGlzLCBkaXNhYmxlIGFueSBmdXR1cmUgeSBzY3JvbGxpbmcKICAgICAgICAgICAgICBzZWxmLl9fZW5hYmxlU2Nyb2xsWSA9IGZhbHNlOwogICAgICAgICAgICAgIHNlbGYuX19pc1NlbGVjdGFibGUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiggc2VsZi5fX2VuYWJsZVNjcm9sbFkgJiYgTWF0aC5hYnMoc2VsZi5zdGFydENvb3JkaW5hdGVzLnkgLSBjdXJyZW50Q29vcmRpbmF0ZXMueSkgPiAxMCApIHsKICAgICAgICAgICAgICAvLyB1c2VyIHNjcm9sbGVkIHRoZSBlbnRpcmUgdmlldyBvbiB0aGUgeSBheGlzCiAgICAgICAgICAgICAgLy8gZGlzYWJsZWQgYmVpbmcgYWJsZSB0byBzZWxlY3QgdGV4dCBvbiBhbiBpbnB1dAogICAgICAgICAgICAgIC8vIGhpZGUgdGhlIGlucHV0IHdoaWNoIGhhcyBmb2N1cywgYW5kIHNob3cgYSBjbG9uZWQgb25lIHRoYXQgZG9lc24ndCBoYXZlIGZvY3VzCiAgICAgICAgICAgICAgc2VsZi5fX2lzU2VsZWN0YWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgIGlvbmljLnRhcC5jbG9uZUZvY3VzZWRJbnB1dChjb250YWluZXIsIHNlbGYpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgc2VsZi5kb1RvdWNoTW92ZShnZXRFdmVudFRvdWNoZXMoZSksIGUudGltZVN0YW1wLCBlLnNjYWxlKTsKICAgICAgICAgIHNlbGYuX19pc0Rvd24gPSB0cnVlOwogICAgICAgIH07CgogICAgICAgIHNlbGYudG91Y2hFbmQgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICBpZighc2VsZi5fX2lzRG93bikgcmV0dXJuOwoKICAgICAgICAgIHNlbGYuZG9Ub3VjaEVuZChlLnRpbWVTdGFtcCk7CiAgICAgICAgICBzZWxmLl9faXNEb3duID0gZmFsc2U7CiAgICAgICAgICBzZWxmLl9faGFzU3RhcnRlZCA9IGZhbHNlOwogICAgICAgICAgc2VsZi5fX2lzU2VsZWN0YWJsZSA9IHRydWU7CiAgICAgICAgICBzZWxmLl9fZW5hYmxlU2Nyb2xsWSA9IHRydWU7CgogICAgICAgICAgaWYoICFzZWxmLl9faXNEcmFnZ2luZyAmJiAhc2VsZi5fX2lzRGVjZWxlcmF0aW5nICYmICFzZWxmLl9faXNBbmltYXRpbmcgKSB7CiAgICAgICAgICAgIGlvbmljLnRhcC5yZW1vdmVDbG9uZWRJbnB1dHMoY29udGFpbmVyLCBzZWxmKTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBzZWxmLm9wdGlvbnMub3JnU2Nyb2xsaW5nQ29tcGxldGUgPSBzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nQ29tcGxldGU7CiAgICAgICAgc2VsZi5vcHRpb25zLnNjcm9sbGluZ0NvbXBsZXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpb25pYy50YXAucmVtb3ZlQ2xvbmVkSW5wdXRzKGNvbnRhaW5lciwgc2VsZik7CiAgICAgICAgICBzZWxmLm9wdGlvbnMub3JnU2Nyb2xsaW5nQ29tcGxldGUoKTsKICAgICAgICB9OwoKICAgICAgICBpZiAoJ29udG91Y2hzdGFydCcgaW4gd2luZG93KSB7CiAgICAgICAgICAvLyBUb3VjaCBFdmVudHMKICAgICAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaHN0YXJ0Iiwgc2VsZi50b3VjaFN0YXJ0LCBmYWxzZSk7CiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaG1vdmUiLCBzZWxmLnRvdWNoTW92ZSwgZmFsc2UpOwogICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2hlbmQiLCBzZWxmLnRvdWNoRW5kLCBmYWxzZSk7CiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ0b3VjaGNhbmNlbCIsIHNlbGYudG91Y2hFbmQsIGZhbHNlKTsKCiAgICAgICAgfSBlbHNlIGlmICh3aW5kb3cubmF2aWdhdG9yLnBvaW50ZXJFbmFibGVkKSB7CiAgICAgICAgICAvLyBQb2ludGVyIEV2ZW50cwogICAgICAgICAgY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgc2VsZi50b3VjaFN0YXJ0LCBmYWxzZSk7CiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVybW92ZSIsIHNlbGYudG91Y2hNb3ZlLCBmYWxzZSk7CiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVydXAiLCBzZWxmLnRvdWNoRW5kLCBmYWxzZSk7CiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJwb2ludGVyY2FuY2VsIiwgc2VsZi50b3VjaEVuZCwgZmFsc2UpOwoKICAgICAgICB9IGVsc2UgaWYgKHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCkgewogICAgICAgICAgLy8gSUUxMCwgV1A4IChQb2ludGVyIEV2ZW50cykKICAgICAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJEb3duIiwgc2VsZi50b3VjaFN0YXJ0LCBmYWxzZSk7CiAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJNb3ZlIiwgc2VsZi50b3VjaE1vdmUsIGZhbHNlKTsKICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIk1TUG9pbnRlclVwIiwgc2VsZi50b3VjaEVuZCwgZmFsc2UpOwogICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyQ2FuY2VsIiwgc2VsZi50b3VjaEVuZCwgZmFsc2UpOwoKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gTW91c2UgRXZlbnRzCiAgICAgICAgICB2YXIgbW91c2Vkb3duID0gZmFsc2U7CgogICAgICAgICAgc2VsZi5tb3VzZURvd24gPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGlmICggaW9uaWMudGFwLmlnbm9yZVNjcm9sbFN0YXJ0KGUpIHx8IGUudGFyZ2V0LnRhZ05hbWUgPT09ICdTRUxFQ1QnICkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLmRvVG91Y2hTdGFydChnZXRFdmVudFRvdWNoZXMoZSksIGUudGltZVN0YW1wKTsKCiAgICAgICAgICAgIGlmKCAhaW9uaWMudGFwLmlzVGV4dElucHV0KGUudGFyZ2V0KSApIHsKICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbW91c2Vkb3duID0gdHJ1ZTsKICAgICAgICAgIH07CgogICAgICAgICAgc2VsZi5tb3VzZU1vdmUgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGlmICghbW91c2Vkb3duIHx8IGUuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2VsZi5kb1RvdWNoTW92ZShnZXRFdmVudFRvdWNoZXMoZSksIGUudGltZVN0YW1wKTsKCiAgICAgICAgICAgIG1vdXNlZG93biA9IHRydWU7CiAgICAgICAgICB9OwoKICAgICAgICAgIHNlbGYubW91c2VVcCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgaWYgKCFtb3VzZWRvd24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNlbGYuZG9Ub3VjaEVuZChlLnRpbWVTdGFtcCk7CgogICAgICAgICAgICBtb3VzZWRvd24gPSBmYWxzZTsKICAgICAgICAgIH07CgogICAgICAgICAgc2VsZi5tb3VzZVdoZWVsID0gaW9uaWMuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZShmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHZhciBzY3JvbGxQYXJlbnQgPSBpb25pYy5Eb21VdGlsLmdldFBhcmVudE9yU2VsZldpdGhDbGFzcyhlLnRhcmdldCwgJ2lvbmljLXNjcm9sbCcpOwogICAgICAgICAgICBpZiAoc2Nyb2xsUGFyZW50ID09PSBzZWxmLl9fY29udGFpbmVyKSB7CgogICAgICAgICAgICAgIHNlbGYuaGludFJlc2l6ZSgpOwogICAgICAgICAgICAgIHNlbGYuc2Nyb2xsQnkoCiAgICAgICAgICAgICAgICAgIGUud2hlZWxEZWx0YVgvc2VsZi5vcHRpb25zLndoZWVsRGFtcGVuLAogICAgICAgICAgICAgICAgICAtZS53aGVlbERlbHRhWS9zZWxmLm9wdGlvbnMud2hlZWxEYW1wZW4KICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICBzZWxmLl9fZmFkZVNjcm9sbGJhcnMoJ2luJyk7CiAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHNlbGYuX193aGVlbEhpZGVCYXJUaW1lb3V0KTsKICAgICAgICAgICAgICBzZWxmLl9fd2hlZWxIaWRlQmFyVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzZWxmLl9fZmFkZVNjcm9sbGJhcnMoJ291dCcpOwogICAgICAgICAgICAgIH0sIDEwMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCBzZWxmLm1vdXNlRG93biwgZmFsc2UpOwogICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigibW91c2Vtb3ZlIiwgc2VsZi5tb3VzZU1vdmUsIGZhbHNlKTsKICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNldXAiLCBzZWxmLm1vdXNlVXAsIGZhbHNlKTsKICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNld2hlZWwnLCBzZWxmLm1vdXNlV2hlZWwsIGZhbHNlKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBfX3JlbW92ZUV2ZW50SGFuZGxlcnM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjb250YWluZXIgPSB0aGlzLl9fY29udGFpbmVyOwoKICAgICAgICBjb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHNlbGYudG91Y2hTdGFydCk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgc2VsZi50b3VjaE1vdmUpOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgc2VsZi50b3VjaEVuZCk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBzZWxmLnRvdWNoQ2FuY2VsKTsKCiAgICAgICAgY29udGFpbmVyLnJlbW92ZUV2ZW50TGlzdGVuZXIoInBvaW50ZXJkb3duIiwgc2VsZi50b3VjaFN0YXJ0KTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJwb2ludGVybW92ZSIsIHNlbGYudG91Y2hNb3ZlKTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJwb2ludGVydXAiLCBzZWxmLnRvdWNoRW5kKTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJwb2ludGVyY2FuY2VsIiwgc2VsZi50b3VjaEVuZCk7CgogICAgICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJEb3duIiwgc2VsZi50b3VjaFN0YXJ0KTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJNU1BvaW50ZXJNb3ZlIiwgc2VsZi50b3VjaE1vdmUpOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIk1TUG9pbnRlclVwIiwgc2VsZi50b3VjaEVuZCk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiTVNQb2ludGVyQ2FuY2VsIiwgc2VsZi50b3VjaEVuZCk7CgogICAgICAgIGNvbnRhaW5lci5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCBzZWxmLm1vdXNlRG93bik7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vtb3ZlIiwgc2VsZi5tb3VzZU1vdmUpOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNldXAiLCBzZWxmLm1vdXNlVXApOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNld2hlZWwnLCBzZWxmLm1vdXNlV2hlZWwpOwogICAgICB9LAoKICAgICAgLyoqIENyZWF0ZSBhIHNjcm9sbCBiYXIgZGl2IHdpdGggdGhlIGdpdmVuIGRpcmVjdGlvbiAqKi8KICAgICAgX19jcmVhdGVTY3JvbGxiYXI6IGZ1bmN0aW9uKGRpcmVjdGlvbikgewogICAgICAgIHZhciBiYXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKICAgICAgICAgIGluZGljYXRvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKICAgICAgICBpbmRpY2F0b3IuY2xhc3NOYW1lID0gJ3Njcm9sbC1iYXItaW5kaWNhdG9yJzsKCiAgICAgICAgaWYoZGlyZWN0aW9uID09ICdoJykgewogICAgICAgICAgYmFyLmNsYXNzTmFtZSA9ICdzY3JvbGwtYmFyIHNjcm9sbC1iYXItaCc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhci5jbGFzc05hbWUgPSAnc2Nyb2xsLWJhciBzY3JvbGwtYmFyLXYnOwogICAgICAgIH0KCiAgICAgICAgYmFyLmFwcGVuZENoaWxkKGluZGljYXRvcik7CiAgICAgICAgcmV0dXJuIGJhcjsKICAgICAgfSwKCiAgICAgIF9fY3JlYXRlU2Nyb2xsYmFyczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGluZGljYXRvclgsIGluZGljYXRvclk7CgogICAgICAgIGlmKHRoaXMub3B0aW9ucy5zY3JvbGxpbmdYKSB7CiAgICAgICAgICBpbmRpY2F0b3JYID0gewogICAgICAgICAgICBlbDogdGhpcy5fX2NyZWF0ZVNjcm9sbGJhcignaCcpLAogICAgICAgICAgICBzaXplUmF0aW86IDEKICAgICAgICAgIH07CiAgICAgICAgICBpbmRpY2F0b3JYLmluZGljYXRvciA9IGluZGljYXRvclguZWwuY2hpbGRyZW5bMF07CgogICAgICAgICAgaWYodGhpcy5vcHRpb25zLnNjcm9sbGJhclgpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbnRhaW5lci5hcHBlbmRDaGlsZChpbmRpY2F0b3JYLmVsKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX19pbmRpY2F0b3JYID0gaW5kaWNhdG9yWDsKICAgICAgICB9CgogICAgICAgIGlmKHRoaXMub3B0aW9ucy5zY3JvbGxpbmdZKSB7CiAgICAgICAgICBpbmRpY2F0b3JZID0gewogICAgICAgICAgICBlbDogdGhpcy5fX2NyZWF0ZVNjcm9sbGJhcigndicpLAogICAgICAgICAgICBzaXplUmF0aW86IDEKICAgICAgICAgIH07CiAgICAgICAgICBpbmRpY2F0b3JZLmluZGljYXRvciA9IGluZGljYXRvclkuZWwuY2hpbGRyZW5bMF07CgogICAgICAgICAgaWYodGhpcy5vcHRpb25zLnNjcm9sbGJhclkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbnRhaW5lci5hcHBlbmRDaGlsZChpbmRpY2F0b3JZLmVsKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX19pbmRpY2F0b3JZID0gaW5kaWNhdG9yWTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBfX3Jlc2l6ZVNjcm9sbGJhcnM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgLy8gVXBkYXRlIGhvcml6IGJhcgogICAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JYKSB7CiAgICAgICAgICB2YXIgd2lkdGggPSBNYXRoLm1heChNYXRoLnJvdW5kKHNlbGYuX19jbGllbnRXaWR0aCAqIHNlbGYuX19jbGllbnRXaWR0aCAvIChzZWxmLl9fY29udGVudFdpZHRoKSksIDIwKTsKICAgICAgICAgIGlmKHdpZHRoID4gc2VsZi5fX2NvbnRlbnRXaWR0aCkgewogICAgICAgICAgICB3aWR0aCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBzZWxmLl9faW5kaWNhdG9yWC5zaXplID0gd2lkdGg7CiAgICAgICAgICBzZWxmLl9faW5kaWNhdG9yWC5taW5TY2FsZSA9IHRoaXMub3B0aW9ucy5taW5TY3JvbGxiYXJTaXplWCAvIHdpZHRoOwogICAgICAgICAgc2VsZi5fX2luZGljYXRvclguaW5kaWNhdG9yLnN0eWxlLndpZHRoID0gd2lkdGggKyAncHgnOwogICAgICAgICAgc2VsZi5fX2luZGljYXRvclgubWF4UG9zID0gc2VsZi5fX2NsaWVudFdpZHRoIC0gd2lkdGg7CiAgICAgICAgICBzZWxmLl9faW5kaWNhdG9yWC5zaXplUmF0aW8gPSBzZWxmLl9fbWF4U2Nyb2xsTGVmdCA/IHNlbGYuX19pbmRpY2F0b3JYLm1heFBvcyAvIHNlbGYuX19tYXhTY3JvbGxMZWZ0IDogMTsKICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSB2ZXJ0IGJhcgogICAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JZKSB7CiAgICAgICAgICB2YXIgaGVpZ2h0ID0gTWF0aC5tYXgoTWF0aC5yb3VuZChzZWxmLl9fY2xpZW50SGVpZ2h0ICogc2VsZi5fX2NsaWVudEhlaWdodCAvIChzZWxmLl9fY29udGVudEhlaWdodCkpLCAyMCk7CiAgICAgICAgICBpZihoZWlnaHQgPiBzZWxmLl9fY29udGVudEhlaWdodCkgewogICAgICAgICAgICBoZWlnaHQgPSAwOwogICAgICAgICAgfQogICAgICAgICAgc2VsZi5fX2luZGljYXRvclkuc2l6ZSA9IGhlaWdodDsKICAgICAgICAgIHNlbGYuX19pbmRpY2F0b3JZLm1pblNjYWxlID0gdGhpcy5vcHRpb25zLm1pblNjcm9sbGJhclNpemVZIC8gaGVpZ2h0OwogICAgICAgICAgc2VsZi5fX2luZGljYXRvclkubWF4UG9zID0gc2VsZi5fX2NsaWVudEhlaWdodCAtIGhlaWdodDsKICAgICAgICAgIHNlbGYuX19pbmRpY2F0b3JZLmluZGljYXRvci5zdHlsZS5oZWlnaHQgPSBoZWlnaHQgKyAncHgnOwogICAgICAgICAgc2VsZi5fX2luZGljYXRvclkuc2l6ZVJhdGlvID0gc2VsZi5fX21heFNjcm9sbFRvcCA/IHNlbGYuX19pbmRpY2F0b3JZLm1heFBvcyAvIHNlbGYuX19tYXhTY3JvbGxUb3AgOiAxOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBNb3ZlIGFuZCBzY2FsZSB0aGUgc2Nyb2xsYmFycyBhcyB0aGUgcGFnZSBzY3JvbGxzLgogICAgICAgKi8KICAgICAgX19yZXBvc2l0aW9uU2Nyb2xsYmFyczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzLCB3aWR0aCwgaGVpZ2h0U2NhbGUsCiAgICAgICAgICB3aWR0aERpZmYsIGhlaWdodERpZmYsCiAgICAgICAgICB4LCB5LAogICAgICAgICAgeHN0b3AgPSAwLCB5c3RvcCA9IDA7CgogICAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JYKSB7CiAgICAgICAgICAvLyBIYW5kbGUgdGhlIFggc2Nyb2xsYmFyCgogICAgICAgICAgLy8gRG9uJ3QgZ28gYWxsIHRoZSB3YXkgdG8gdGhlIHJpZ2h0IGlmIHdlIGhhdmUgYSB2ZXJ0aWNhbCBzY3JvbGxiYXIgYXMgd2VsbAogICAgICAgICAgaWYoc2VsZi5fX2luZGljYXRvclkpIHhzdG9wID0gMTA7CgogICAgICAgICAgeCA9IE1hdGgucm91bmQoc2VsZi5fX2luZGljYXRvclguc2l6ZVJhdGlvICogc2VsZi5fX3Njcm9sbExlZnQpIHx8IDAsCgogICAgICAgICAgICAvLyBUaGUgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiB0aGUgbGFzdCBjb250ZW50IFggcG9zaXRpb24sIGFuZCBvdXIgb3ZlcnNjcm9sbGVkIG9uZQogICAgICAgICAgICB3aWR0aERpZmYgPSBzZWxmLl9fc2Nyb2xsTGVmdCAtIChzZWxmLl9fbWF4U2Nyb2xsTGVmdCAtIHhzdG9wKTsKCiAgICAgICAgICBpZihzZWxmLl9fc2Nyb2xsTGVmdCA8IDApIHsKCiAgICAgICAgICAgIHdpZHRoU2NhbGUgPSBNYXRoLm1heChzZWxmLl9faW5kaWNhdG9yWC5taW5TY2FsZSwKICAgICAgICAgICAgICAgIChzZWxmLl9faW5kaWNhdG9yWC5zaXplIC0gTWF0aC5hYnMoc2VsZi5fX3Njcm9sbExlZnQpKSAvIHNlbGYuX19pbmRpY2F0b3JYLnNpemUpOwoKICAgICAgICAgICAgLy8gU3RheSBhdCBsZWZ0CiAgICAgICAgICAgIHggPSAwOwoKICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHNjYWxlIGlzIHRyYW5zZm9ybWVkIGZyb20gdGhlIGxlZnQvY2VudGVyIG9yaWdpbiBwb2ludAogICAgICAgICAgICBzZWxmLl9faW5kaWNhdG9yWC5pbmRpY2F0b3Iuc3R5bGVbc2VsZi5fX3RyYW5zZm9ybU9yaWdpblByb3BlcnR5XSA9ICdsZWZ0IGNlbnRlcic7CiAgICAgICAgICB9IGVsc2UgaWYod2lkdGhEaWZmID4gMCkgewoKICAgICAgICAgICAgd2lkdGhTY2FsZSA9IE1hdGgubWF4KHNlbGYuX19pbmRpY2F0b3JYLm1pblNjYWxlLAogICAgICAgICAgICAgICAgKHNlbGYuX19pbmRpY2F0b3JYLnNpemUgLSB3aWR0aERpZmYpIC8gc2VsZi5fX2luZGljYXRvclguc2l6ZSk7CgogICAgICAgICAgICAvLyBTdGF5IGF0IHRoZSBmdXJ0aGVzdCB4IGZvciB0aGUgc2Nyb2xsYWJsZSB2aWV3cG9ydAogICAgICAgICAgICB4ID0gc2VsZi5fX2luZGljYXRvclgubWF4UG9zIC0geHN0b3A7CgogICAgICAgICAgICAvLyBNYWtlIHN1cmUgc2NhbGUgaXMgdHJhbnNmb3JtZWQgZnJvbSB0aGUgcmlnaHQvY2VudGVyIG9yaWdpbiBwb2ludAogICAgICAgICAgICBzZWxmLl9faW5kaWNhdG9yWC5pbmRpY2F0b3Iuc3R5bGVbc2VsZi5fX3RyYW5zZm9ybU9yaWdpblByb3BlcnR5XSA9ICdyaWdodCBjZW50ZXInOwoKICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAvLyBOb3JtYWwgbW90aW9uCiAgICAgICAgICAgIHggPSBNYXRoLm1pbihzZWxmLl9fbWF4U2Nyb2xsTGVmdCwgTWF0aC5tYXgoMCwgeCkpOwogICAgICAgICAgICB3aWR0aFNjYWxlID0gMTsKCiAgICAgICAgICB9CgogICAgICAgICAgc2VsZi5fX2luZGljYXRvclguaW5kaWNhdG9yLnN0eWxlW3NlbGYuX190cmFuc2Zvcm1Qcm9wZXJ0eV0gPSAndHJhbnNsYXRlM2QoJyArIHggKyAncHgsIDAsIDApIHNjYWxlWCgnICsgd2lkdGhTY2FsZSArICcpJzsKICAgICAgICB9CgogICAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JZKSB7CgogICAgICAgICAgeSA9IE1hdGgucm91bmQoc2VsZi5fX2luZGljYXRvclkuc2l6ZVJhdGlvICogc2VsZi5fX3Njcm9sbFRvcCkgfHwgMDsKCiAgICAgICAgICAvLyBEb24ndCBnbyBhbGwgdGhlIHdheSB0byB0aGUgcmlnaHQgaWYgd2UgaGF2ZSBhIHZlcnRpY2FsIHNjcm9sbGJhciBhcyB3ZWxsCiAgICAgICAgICBpZihzZWxmLl9faW5kaWNhdG9yWCkgeXN0b3AgPSAxMDsKCiAgICAgICAgICBoZWlnaHREaWZmID0gc2VsZi5fX3Njcm9sbFRvcCAtIChzZWxmLl9fbWF4U2Nyb2xsVG9wIC0geXN0b3ApOwoKICAgICAgICAgIGlmKHNlbGYuX19zY3JvbGxUb3AgPCAwKSB7CgogICAgICAgICAgICBoZWlnaHRTY2FsZSA9IE1hdGgubWF4KHNlbGYuX19pbmRpY2F0b3JZLm1pblNjYWxlLCAoc2VsZi5fX2luZGljYXRvclkuc2l6ZSAtIE1hdGguYWJzKHNlbGYuX19zY3JvbGxUb3ApKSAvIHNlbGYuX19pbmRpY2F0b3JZLnNpemUpOwoKICAgICAgICAgICAgLy8gU3RheSBhdCB0b3AKICAgICAgICAgICAgeSA9IDA7CgogICAgICAgICAgICAvLyBNYWtlIHN1cmUgc2NhbGUgaXMgdHJhbnNmb3JtZWQgZnJvbSB0aGUgY2VudGVyL3RvcCBvcmlnaW4gcG9pbnQKICAgICAgICAgICAgc2VsZi5fX2luZGljYXRvclkuaW5kaWNhdG9yLnN0eWxlW3NlbGYuX190cmFuc2Zvcm1PcmlnaW5Qcm9wZXJ0eV0gPSAnY2VudGVyIHRvcCc7CgogICAgICAgICAgfSBlbHNlIGlmKGhlaWdodERpZmYgPiAwKSB7CgogICAgICAgICAgICBoZWlnaHRTY2FsZSA9IE1hdGgubWF4KHNlbGYuX19pbmRpY2F0b3JZLm1pblNjYWxlLCAoc2VsZi5fX2luZGljYXRvclkuc2l6ZSAtIGhlaWdodERpZmYpIC8gc2VsZi5fX2luZGljYXRvclkuc2l6ZSk7CgogICAgICAgICAgICAvLyBTdGF5IGF0IGJvdHRvbSBvZiBzY3JvbGxhYmxlIHZpZXdwb3J0CiAgICAgICAgICAgIHkgPSBzZWxmLl9faW5kaWNhdG9yWS5tYXhQb3MgLSB5c3RvcDsKCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSBzY2FsZSBpcyB0cmFuc2Zvcm1lZCBmcm9tIHRoZSBjZW50ZXIvYm90dG9tIG9yaWdpbiBwb2ludAogICAgICAgICAgICBzZWxmLl9faW5kaWNhdG9yWS5pbmRpY2F0b3Iuc3R5bGVbc2VsZi5fX3RyYW5zZm9ybU9yaWdpblByb3BlcnR5XSA9ICdjZW50ZXIgYm90dG9tJzsKCiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgLy8gTm9ybWFsIG1vdGlvbgogICAgICAgICAgICB5ID0gTWF0aC5taW4oc2VsZi5fX21heFNjcm9sbFRvcCwgTWF0aC5tYXgoMCwgeSkpOwogICAgICAgICAgICBoZWlnaHRTY2FsZSA9IDE7CgogICAgICAgICAgfQoKICAgICAgICAgIHNlbGYuX19pbmRpY2F0b3JZLmluZGljYXRvci5zdHlsZVtzZWxmLl9fdHJhbnNmb3JtUHJvcGVydHldID0gJ3RyYW5zbGF0ZTNkKDAsJyArIHkgKyAncHgsIDApIHNjYWxlWSgnICsgaGVpZ2h0U2NhbGUgKyAnKSc7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgX19mYWRlU2Nyb2xsYmFyczogZnVuY3Rpb24oZGlyZWN0aW9uLCBkZWxheSkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgaWYoIXRoaXMub3B0aW9ucy5zY3JvbGxiYXJzRmFkZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGNsYXNzTmFtZSA9ICdzY3JvbGwtYmFyLWZhZGUtb3V0JzsKCiAgICAgICAgaWYoc2VsZi5vcHRpb25zLnNjcm9sbGJhcnNGYWRlID09PSB0cnVlKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQoc2VsZi5fX3Njcm9sbGJhckZhZGVUaW1lb3V0KTsKCiAgICAgICAgICBpZihkaXJlY3Rpb24gPT0gJ2luJykgewogICAgICAgICAgICBpZihzZWxmLl9faW5kaWNhdG9yWCkgeyBzZWxmLl9faW5kaWNhdG9yWC5pbmRpY2F0b3IuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOyB9CiAgICAgICAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JZKSB7IHNlbGYuX19pbmRpY2F0b3JZLmluZGljYXRvci5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7IH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNlbGYuX19zY3JvbGxiYXJGYWRlVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYoc2VsZi5fX2luZGljYXRvclgpIHsgc2VsZi5fX2luZGljYXRvclguaW5kaWNhdG9yLmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTsgfQogICAgICAgICAgICAgIGlmKHNlbGYuX19pbmRpY2F0b3JZKSB7IHNlbGYuX19pbmRpY2F0b3JZLmluZGljYXRvci5jbGFzc0xpc3QuYWRkKGNsYXNzTmFtZSk7IH0KICAgICAgICAgICAgfSwgZGVsYXkgfHwgc2VsZi5vcHRpb25zLnNjcm9sbGJhckZhZGVEZWxheSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAoKICAgICAgX19zY3JvbGxpbmdDb21wbGV0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHNlbGYub3B0aW9ucy5zY3JvbGxpbmdDb21wbGV0ZSgpOwoKICAgICAgICBzZWxmLl9fZmFkZVNjcm9sbGJhcnMoJ291dCcpOwogICAgICB9LAoKICAgICAgcmVzaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAvLyBVcGRhdGUgU2Nyb2xsZXIgZGltZW5zaW9ucyBmb3IgY2hhbmdlZCBjb250ZW50CiAgICAgICAgLy8gQWRkIHBhZGRpbmcgdG8gYm90dG9tIG9mIGNvbnRlbnQKICAgICAgICB0aGlzLnNldERpbWVuc2lvbnMoCiAgICAgICAgICB0aGlzLl9fY29udGFpbmVyLmNsaWVudFdpZHRoLAogICAgICAgICAgdGhpcy5fX2NvbnRhaW5lci5jbGllbnRIZWlnaHQsCiAgICAgICAgICB0aGlzLm9wdGlvbnMuZ2V0Q29udGVudFdpZHRoKCksCiAgICAgICAgICB0aGlzLm9wdGlvbnMuZ2V0Q29udGVudEhlaWdodCgpCiAgICAgICAgKTsKICAgICAgfSwKICAgICAgLyoKICAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgUFVCTElDIEFQSQogICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAqLwoKICAgICAgZ2V0UmVuZGVyRm46IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgdmFyIGNvbnRlbnQgPSB0aGlzLl9fY29udGVudDsKCiAgICAgICAgdmFyIGRvY1N0eWxlID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlOwoKICAgICAgICB2YXIgZW5naW5lOwogICAgICAgIGlmICgnTW96QXBwZWFyYW5jZScgaW4gZG9jU3R5bGUpIHsKICAgICAgICAgIGVuZ2luZSA9ICdnZWNrbyc7CiAgICAgICAgfSBlbHNlIGlmICgnV2Via2l0QXBwZWFyYW5jZScgaW4gZG9jU3R5bGUpIHsKICAgICAgICAgIGVuZ2luZSA9ICd3ZWJraXQnOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG5hdmlnYXRvci5jcHVDbGFzcyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgIGVuZ2luZSA9ICd0cmlkZW50JzsKICAgICAgICB9CgogICAgICAgIHZhciB2ZW5kb3JQcmVmaXggPSB7CiAgICAgICAgICB0cmlkZW50OiAnbXMnLAogICAgICAgICAgZ2Vja286ICdNb3onLAogICAgICAgICAgd2Via2l0OiAnV2Via2l0JywKICAgICAgICAgIHByZXN0bzogJ08nCiAgICAgICAgfVtlbmdpbmVdOwoKICAgICAgICB2YXIgaGVscGVyRWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIHZhciB1bmRlZjsKCiAgICAgICAgdmFyIHBlcnNwZWN0aXZlUHJvcGVydHkgPSB2ZW5kb3JQcmVmaXggKyAiUGVyc3BlY3RpdmUiOwogICAgICAgIHZhciB0cmFuc2Zvcm1Qcm9wZXJ0eSA9IHZlbmRvclByZWZpeCArICJUcmFuc2Zvcm0iOwogICAgICAgIHZhciB0cmFuc2Zvcm1PcmlnaW5Qcm9wZXJ0eSA9IHZlbmRvclByZWZpeCArICdUcmFuc2Zvcm1PcmlnaW4nOwoKICAgICAgICBzZWxmLl9fcGVyc3BlY3RpdmVQcm9wZXJ0eSA9IHRyYW5zZm9ybVByb3BlcnR5OwogICAgICAgIHNlbGYuX190cmFuc2Zvcm1Qcm9wZXJ0eSA9IHRyYW5zZm9ybVByb3BlcnR5OwogICAgICAgIHNlbGYuX190cmFuc2Zvcm1PcmlnaW5Qcm9wZXJ0eSA9IHRyYW5zZm9ybU9yaWdpblByb3BlcnR5OwoKICAgICAgICBpZiAoaGVscGVyRWxlbS5zdHlsZVtwZXJzcGVjdGl2ZVByb3BlcnR5XSAhPT0gdW5kZWYpIHsKCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24obGVmdCwgdG9wLCB6b29tLCB3YXNSZXNpemUpIHsKICAgICAgICAgICAgY29udGVudC5zdHlsZVt0cmFuc2Zvcm1Qcm9wZXJ0eV0gPSAndHJhbnNsYXRlM2QoJyArICgtbGVmdCkgKyAncHgsJyArICgtdG9wKSArICdweCwwKSBzY2FsZSgnICsgem9vbSArICcpJzsKICAgICAgICAgICAgc2VsZi5fX3JlcG9zaXRpb25TY3JvbGxiYXJzKCk7CiAgICAgICAgICAgIGlmKCF3YXNSZXNpemUpIHsKICAgICAgICAgICAgICBzZWxmLnRyaWdnZXJTY3JvbGxFdmVudCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICB9IGVsc2UgaWYgKGhlbHBlckVsZW0uc3R5bGVbdHJhbnNmb3JtUHJvcGVydHldICE9PSB1bmRlZikgewoKICAgICAgICAgIHJldHVybiBmdW5jdGlvbihsZWZ0LCB0b3AsIHpvb20sIHdhc1Jlc2l6ZSkgewogICAgICAgICAgICBjb250ZW50LnN0eWxlW3RyYW5zZm9ybVByb3BlcnR5XSA9ICd0cmFuc2xhdGUoJyArICgtbGVmdCkgKyAncHgsJyArICgtdG9wKSArICdweCkgc2NhbGUoJyArIHpvb20gKyAnKSc7CiAgICAgICAgICAgIHNlbGYuX19yZXBvc2l0aW9uU2Nyb2xsYmFycygpOwogICAgICAgICAgICBpZighd2FzUmVzaXplKSB7CiAgICAgICAgICAgICAgc2VsZi50cmlnZ2VyU2Nyb2xsRXZlbnQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24obGVmdCwgdG9wLCB6b29tLCB3YXNSZXNpemUpIHsKICAgICAgICAgICAgY29udGVudC5zdHlsZS5tYXJnaW5MZWZ0ID0gbGVmdCA/ICgtbGVmdC96b29tKSArICdweCcgOiAnJzsKICAgICAgICAgICAgY29udGVudC5zdHlsZS5tYXJnaW5Ub3AgPSB0b3AgPyAoLXRvcC96b29tKSArICdweCcgOiAnJzsKICAgICAgICAgICAgY29udGVudC5zdHlsZS56b29tID0gem9vbSB8fCAnJzsKICAgICAgICAgICAgc2VsZi5fX3JlcG9zaXRpb25TY3JvbGxiYXJzKCk7CiAgICAgICAgICAgIGlmKCF3YXNSZXNpemUpIHsKICAgICAgICAgICAgICBzZWxmLnRyaWdnZXJTY3JvbGxFdmVudCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICB9CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIENvbmZpZ3VyZXMgdGhlIGRpbWVuc2lvbnMgb2YgdGhlIGNsaWVudCAob3V0ZXIpIGFuZCBjb250ZW50IChpbm5lcikgZWxlbWVudHMuCiAgICAgICAqIFJlcXVpcmVzIHRoZSBhdmFpbGFibGUgc3BhY2UgZm9yIHRoZSBvdXRlciBlbGVtZW50IGFuZCB0aGUgb3V0ZXIgc2l6ZSBvZiB0aGUgaW5uZXIgZWxlbWVudC4KICAgICAgICogQWxsIHZhbHVlcyB3aGljaCBhcmUgZmFsc3kgKG51bGwgb3IgemVybyBldGMuKSBhcmUgaWdub3JlZCBhbmQgdGhlIG9sZCB2YWx1ZSBpcyBrZXB0LgogICAgICAgKgogICAgICAgKiBAcGFyYW0gY2xpZW50V2lkdGgge0ludGVnZXJ9IElubmVyIHdpZHRoIG9mIG91dGVyIGVsZW1lbnQKICAgICAgICogQHBhcmFtIGNsaWVudEhlaWdodCB7SW50ZWdlcn0gSW5uZXIgaGVpZ2h0IG9mIG91dGVyIGVsZW1lbnQKICAgICAgICogQHBhcmFtIGNvbnRlbnRXaWR0aCB7SW50ZWdlcn0gT3V0ZXIgd2lkdGggb2YgaW5uZXIgZWxlbWVudAogICAgICAgKiBAcGFyYW0gY29udGVudEhlaWdodCB7SW50ZWdlcn0gT3V0ZXIgaGVpZ2h0IG9mIGlubmVyIGVsZW1lbnQKICAgICAgICovCiAgICAgIHNldERpbWVuc2lvbnM6IGZ1bmN0aW9uKGNsaWVudFdpZHRoLCBjbGllbnRIZWlnaHQsIGNvbnRlbnRXaWR0aCwgY29udGVudEhlaWdodCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgLy8gT25seSB1cGRhdGUgdmFsdWVzIHdoaWNoIGFyZSBkZWZpbmVkCiAgICAgICAgaWYgKGNsaWVudFdpZHRoID09PSArY2xpZW50V2lkdGgpIHsKICAgICAgICAgIHNlbGYuX19jbGllbnRXaWR0aCA9IGNsaWVudFdpZHRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNsaWVudEhlaWdodCA9PT0gK2NsaWVudEhlaWdodCkgewogICAgICAgICAgc2VsZi5fX2NsaWVudEhlaWdodCA9IGNsaWVudEhlaWdodDsKICAgICAgICB9CgogICAgICAgIGlmIChjb250ZW50V2lkdGggPT09ICtjb250ZW50V2lkdGgpIHsKICAgICAgICAgIHNlbGYuX19jb250ZW50V2lkdGggPSBjb250ZW50V2lkdGg7CiAgICAgICAgfQoKICAgICAgICBpZiAoY29udGVudEhlaWdodCA9PT0gK2NvbnRlbnRIZWlnaHQpIHsKICAgICAgICAgIHNlbGYuX19jb250ZW50SGVpZ2h0ID0gY29udGVudEhlaWdodDsKICAgICAgICB9CgogICAgICAgIC8vIFJlZnJlc2ggbWF4aW11bXMKICAgICAgICBzZWxmLl9fY29tcHV0ZVNjcm9sbE1heCgpOwogICAgICAgIHNlbGYuX19yZXNpemVTY3JvbGxiYXJzKCk7CgogICAgICAgIC8vIFJlZnJlc2ggc2Nyb2xsIHBvc2l0aW9uCiAgICAgICAgc2VsZi5zY3JvbGxUbyhzZWxmLl9fc2Nyb2xsTGVmdCwgc2VsZi5fX3Njcm9sbFRvcCwgdHJ1ZSwgbnVsbCwgdHJ1ZSk7CgogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBTZXRzIHRoZSBjbGllbnQgY29vcmRpbmF0ZXMgaW4gcmVsYXRpb24gdG8gdGhlIGRvY3VtZW50LgogICAgICAgKgogICAgICAgKiBAcGFyYW0gbGVmdCB7SW50ZWdlcn0gTGVmdCBwb3NpdGlvbiBvZiBvdXRlciBlbGVtZW50CiAgICAgICAqIEBwYXJhbSB0b3Age0ludGVnZXJ9IFRvcCBwb3NpdGlvbiBvZiBvdXRlciBlbGVtZW50CiAgICAgICAqLwogICAgICBzZXRQb3NpdGlvbjogZnVuY3Rpb24obGVmdCwgdG9wKSB7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgc2VsZi5fX2NsaWVudExlZnQgPSBsZWZ0IHx8IDA7CiAgICAgICAgc2VsZi5fX2NsaWVudFRvcCA9IHRvcCB8fCAwOwoKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogQ29uZmlndXJlcyB0aGUgc25hcHBpbmcgKHdoZW4gc25hcHBpbmcgaXMgYWN0aXZlKQogICAgICAgKgogICAgICAgKiBAcGFyYW0gd2lkdGgge0ludGVnZXJ9IFNuYXBwaW5nIHdpZHRoCiAgICAgICAqIEBwYXJhbSBoZWlnaHQge0ludGVnZXJ9IFNuYXBwaW5nIGhlaWdodAogICAgICAgKi8KICAgICAgc2V0U25hcFNpemU6IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBzZWxmLl9fc25hcFdpZHRoID0gd2lkdGg7CiAgICAgICAgc2VsZi5fX3NuYXBIZWlnaHQgPSBoZWlnaHQ7CgogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBBY3RpdmF0ZXMgcHVsbC10by1yZWZyZXNoLiBBIHNwZWNpYWwgem9uZSBvbiB0aGUgdG9wIG9mIHRoZSBsaXN0IHRvIHN0YXJ0IGEgbGlzdCByZWZyZXNoIHdoZW5ldmVyCiAgICAgICAqIHRoZSB1c2VyIGV2ZW50IGlzIHJlbGVhc2VkIGR1cmluZyB2aXNpYmlsaXR5IG9mIHRoaXMgem9uZS4gVGhpcyB3YXMgaW50cm9kdWNlZCBieSBzb21lIGFwcHMgb24gaU9TIGxpa2UKICAgICAgICogdGhlIG9mZmljaWFsIFR3aXR0ZXIgY2xpZW50LgogICAgICAgKgogICAgICAgKiBAcGFyYW0gaGVpZ2h0IHtJbnRlZ2VyfSBIZWlnaHQgb2YgcHVsbC10by1yZWZyZXNoIHpvbmUgb24gdG9wIG9mIHJlbmRlcmVkIGxpc3QKICAgICAgICogQHBhcmFtIGFjdGl2YXRlQ2FsbGJhY2sge0Z1bmN0aW9ufSBDYWxsYmFjayB0byBleGVjdXRlIG9uIGFjdGl2YXRpb24uIFRoaXMgaXMgZm9yIHNpZ25hbGxpbmcgdGhlIHVzZXIgYWJvdXQgYSByZWZyZXNoIGlzIGFib3V0IHRvIGhhcHBlbiB3aGVuIGhlIHJlbGVhc2UuCiAgICAgICAqIEBwYXJhbSBkZWFjdGl2YXRlQ2FsbGJhY2sge0Z1bmN0aW9ufSBDYWxsYmFjayB0byBleGVjdXRlIG9uIGRlYWN0aXZhdGlvbi4gVGhpcyBpcyBmb3Igc2lnbmFsbGluZyB0aGUgdXNlciBhYm91dCB0aGUgcmVmcmVzaCBiZWluZyBjYW5jZWxsZWQuCiAgICAgICAqIEBwYXJhbSBzdGFydENhbGxiYWNrIHtGdW5jdGlvbn0gQ2FsbGJhY2sgdG8gZXhlY3V0ZSB0byBzdGFydCB0aGUgcmVhbCBhc3luYyByZWZyZXNoIGFjdGlvbi4gQ2FsbCB7QGxpbmsgI2ZpbmlzaFB1bGxUb1JlZnJlc2h9IGFmdGVyIGZpbmlzaCBvZiByZWZyZXNoLgogICAgICAgKi8KICAgICAgYWN0aXZhdGVQdWxsVG9SZWZyZXNoOiBmdW5jdGlvbihoZWlnaHQsIGFjdGl2YXRlQ2FsbGJhY2ssIGRlYWN0aXZhdGVDYWxsYmFjaywgc3RhcnRDYWxsYmFjaykgewoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHNlbGYuX19yZWZyZXNoSGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHNlbGYuX19yZWZyZXNoQWN0aXZhdGUgPSBhY3RpdmF0ZUNhbGxiYWNrOwogICAgICAgIHNlbGYuX19yZWZyZXNoRGVhY3RpdmF0ZSA9IGRlYWN0aXZhdGVDYWxsYmFjazsKICAgICAgICBzZWxmLl9fcmVmcmVzaFN0YXJ0ID0gc3RhcnRDYWxsYmFjazsKCiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIFN0YXJ0cyBwdWxsLXRvLXJlZnJlc2ggbWFudWFsbHkuCiAgICAgICAqLwogICAgICB0cmlnZ2VyUHVsbFRvUmVmcmVzaDogZnVuY3Rpb24oKSB7CiAgICAgICAgLy8gVXNlIHB1Ymxpc2ggaW5zdGVhZCBvZiBzY3JvbGxUbyB0byBhbGxvdyBzY3JvbGxpbmcgdG8gb3V0IG9mIGJvdW5kYXJ5IHBvc2l0aW9uCiAgICAgICAgLy8gV2UgZG9uJ3QgbmVlZCB0byBub3JtYWxpemUgc2Nyb2xsTGVmdCwgem9vbUxldmVsLCBldGMuIGhlcmUgYmVjYXVzZSB3ZSBvbmx5IHktc2Nyb2xsaW5nIHdoZW4gcHVsbC10by1yZWZyZXNoIGlzIGVuYWJsZWQKICAgICAgICB0aGlzLl9fcHVibGlzaCh0aGlzLl9fc2Nyb2xsTGVmdCwgLXRoaXMuX19yZWZyZXNoSGVpZ2h0LCB0aGlzLl9fem9vbUxldmVsLCB0cnVlKTsKCiAgICAgICAgaWYgKHRoaXMuX19yZWZyZXNoU3RhcnQpIHsKICAgICAgICAgIHRoaXMuX19yZWZyZXNoU3RhcnQoKTsKICAgICAgICB9CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIFNpZ25hbGl6ZXMgdGhhdCBwdWxsLXRvLXJlZnJlc2ggaXMgZmluaXNoZWQuCiAgICAgICAqLwogICAgICBmaW5pc2hQdWxsVG9SZWZyZXNoOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBzZWxmLl9fcmVmcmVzaEFjdGl2ZSA9IGZhbHNlOwogICAgICAgIGlmIChzZWxmLl9fcmVmcmVzaERlYWN0aXZhdGUpIHsKICAgICAgICAgIHNlbGYuX19yZWZyZXNoRGVhY3RpdmF0ZSgpOwogICAgICAgIH0KCiAgICAgICAgc2VsZi5zY3JvbGxUbyhzZWxmLl9fc2Nyb2xsTGVmdCwgc2VsZi5fX3Njcm9sbFRvcCwgdHJ1ZSk7CgogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBSZXR1cm5zIHRoZSBzY3JvbGwgcG9zaXRpb24gYW5kIHpvb21pbmcgdmFsdWVzCiAgICAgICAqCiAgICAgICAqIEByZXR1cm4ge01hcH0gYGxlZnRgIGFuZCBgdG9wYCBzY3JvbGwgcG9zaXRpb24gYW5kIGB6b29tYCBsZXZlbAogICAgICAgKi8KICAgICAgZ2V0VmFsdWVzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgbGVmdDogc2VsZi5fX3Njcm9sbExlZnQsCiAgICAgICAgICB0b3A6IHNlbGYuX19zY3JvbGxUb3AsCiAgICAgICAgICB6b29tOiBzZWxmLl9fem9vbUxldmVsCiAgICAgICAgfTsKCiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIFJldHVybnMgdGhlIG1heGltdW0gc2Nyb2xsIHZhbHVlcwogICAgICAgKgogICAgICAgKiBAcmV0dXJuIHtNYXB9IGBsZWZ0YCBhbmQgYHRvcGAgbWF4aW11bSBzY3JvbGwgdmFsdWVzCiAgICAgICAqLwogICAgICBnZXRTY3JvbGxNYXg6IGZ1bmN0aW9uKCkgewoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICBsZWZ0OiBzZWxmLl9fbWF4U2Nyb2xsTGVmdCwKICAgICAgICAgIHRvcDogc2VsZi5fX21heFNjcm9sbFRvcAogICAgICAgIH07CgogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBab29tcyB0byB0aGUgZ2l2ZW4gbGV2ZWwuIFN1cHBvcnRzIG9wdGlvbmFsIGFuaW1hdGlvbi4gWm9vbXMKICAgICAgICogdGhlIGNlbnRlciB3aGVuIG5vIGNvb3JkaW5hdGVzIGFyZSBnaXZlbi4KICAgICAgICoKICAgICAgICogQHBhcmFtIGxldmVsIHtOdW1iZXJ9IExldmVsIHRvIHpvb20gdG8KICAgICAgICogQHBhcmFtIGFuaW1hdGUge0Jvb2xlYW59IFdoZXRoZXIgdG8gdXNlIGFuaW1hdGlvbgogICAgICAgKiBAcGFyYW0gb3JpZ2luTGVmdCB7TnVtYmVyfSBab29tIGluIGF0IGdpdmVuIGxlZnQgY29vcmRpbmF0ZQogICAgICAgKiBAcGFyYW0gb3JpZ2luVG9wIHtOdW1iZXJ9IFpvb20gaW4gYXQgZ2l2ZW4gdG9wIGNvb3JkaW5hdGUKICAgICAgICovCiAgICAgIHpvb21UbzogZnVuY3Rpb24obGV2ZWwsIGFuaW1hdGUsIG9yaWdpbkxlZnQsIG9yaWdpblRvcCkgewoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIGlmICghc2VsZi5vcHRpb25zLnpvb21pbmcpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiWm9vbWluZyBpcyBub3QgZW5hYmxlZCEiKTsKICAgICAgICB9CgogICAgICAgIC8vIFN0b3AgZGVjZWxlcmF0aW9uCiAgICAgICAgaWYgKHNlbGYuX19pc0RlY2VsZXJhdGluZykgewogICAgICAgICAgenluZ2FDb3JlLmVmZmVjdC5BbmltYXRlLnN0b3Aoc2VsZi5fX2lzRGVjZWxlcmF0aW5nKTsKICAgICAgICAgIHNlbGYuX19pc0RlY2VsZXJhdGluZyA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdmFyIG9sZExldmVsID0gc2VsZi5fX3pvb21MZXZlbDsKCiAgICAgICAgLy8gTm9ybWFsaXplIGlucHV0IG9yaWdpbiB0byBjZW50ZXIgb2Ygdmlld3BvcnQgaWYgbm90IGRlZmluZWQKICAgICAgICBpZiAob3JpZ2luTGVmdCA9PSBudWxsKSB7CiAgICAgICAgICBvcmlnaW5MZWZ0ID0gc2VsZi5fX2NsaWVudFdpZHRoIC8gMjsKICAgICAgICB9CgogICAgICAgIGlmIChvcmlnaW5Ub3AgPT0gbnVsbCkgewogICAgICAgICAgb3JpZ2luVG9wID0gc2VsZi5fX2NsaWVudEhlaWdodCAvIDI7CiAgICAgICAgfQoKICAgICAgICAvLyBMaW1pdCBsZXZlbCBhY2NvcmRpbmcgdG8gY29uZmlndXJhdGlvbgogICAgICAgIGxldmVsID0gTWF0aC5tYXgoTWF0aC5taW4obGV2ZWwsIHNlbGYub3B0aW9ucy5tYXhab29tKSwgc2VsZi5vcHRpb25zLm1pblpvb20pOwoKICAgICAgICAvLyBSZWNvbXB1dGUgbWF4aW11bSB2YWx1ZXMgd2hpbGUgdGVtcG9yYXJ5IHR3ZWFraW5nIG1heGltdW0gc2Nyb2xsIHJhbmdlcwogICAgICAgIHNlbGYuX19jb21wdXRlU2Nyb2xsTWF4KGxldmVsKTsKCiAgICAgICAgLy8gUmVjb21wdXRlIGxlZnQgYW5kIHRvcCBjb29yZGluYXRlcyBiYXNlZCBvbiBuZXcgem9vbSBsZXZlbAogICAgICAgIHZhciBsZWZ0ID0gKChvcmlnaW5MZWZ0ICsgc2VsZi5fX3Njcm9sbExlZnQpICogbGV2ZWwgLyBvbGRMZXZlbCkgLSBvcmlnaW5MZWZ0OwogICAgICAgIHZhciB0b3AgPSAoKG9yaWdpblRvcCArIHNlbGYuX19zY3JvbGxUb3ApICogbGV2ZWwgLyBvbGRMZXZlbCkgLSBvcmlnaW5Ub3A7CgogICAgICAgIC8vIExpbWl0IHgtYXhpcwogICAgICAgIGlmIChsZWZ0ID4gc2VsZi5fX21heFNjcm9sbExlZnQpIHsKICAgICAgICAgIGxlZnQgPSBzZWxmLl9fbWF4U2Nyb2xsTGVmdDsKICAgICAgICB9IGVsc2UgaWYgKGxlZnQgPCAwKSB7CiAgICAgICAgICBsZWZ0ID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIExpbWl0IHktYXhpcwogICAgICAgIGlmICh0b3AgPiBzZWxmLl9fbWF4U2Nyb2xsVG9wKSB7CiAgICAgICAgICB0b3AgPSBzZWxmLl9fbWF4U2Nyb2xsVG9wOwogICAgICAgIH0gZWxzZSBpZiAodG9wIDwgMCkgewogICAgICAgICAgdG9wID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIFB1c2ggdmFsdWVzIG91dAogICAgICAgIHNlbGYuX19wdWJsaXNoKGxlZnQsIHRvcCwgbGV2ZWwsIGFuaW1hdGUpOwoKICAgICAgfSwKCgogICAgICAvKioKICAgICAgICogWm9vbXMgdGhlIGNvbnRlbnQgYnkgdGhlIGdpdmVuIGZhY3Rvci4KICAgICAgICoKICAgICAgICogQHBhcmFtIGZhY3RvciB7TnVtYmVyfSBab29tIGJ5IGdpdmVuIGZhY3RvcgogICAgICAgKiBAcGFyYW0gYW5pbWF0ZSB7Qm9vbGVhbn0gV2hldGhlciB0byB1c2UgYW5pbWF0aW9uCiAgICAgICAqIEBwYXJhbSBvcmlnaW5MZWZ0IHtOdW1iZXJ9IFpvb20gaW4gYXQgZ2l2ZW4gbGVmdCBjb29yZGluYXRlCiAgICAgICAqIEBwYXJhbSBvcmlnaW5Ub3Age051bWJlcn0gWm9vbSBpbiBhdCBnaXZlbiB0b3AgY29vcmRpbmF0ZQogICAgICAgKi8KICAgICAgem9vbUJ5OiBmdW5jdGlvbihmYWN0b3IsIGFuaW1hdGUsIG9yaWdpbkxlZnQsIG9yaWdpblRvcCkgewoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHNlbGYuem9vbVRvKHNlbGYuX196b29tTGV2ZWwgKiBmYWN0b3IsIGFuaW1hdGUsIG9yaWdpbkxlZnQsIG9yaWdpblRvcCk7CgogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBTY3JvbGxzIHRvIHRoZSBnaXZlbiBwb3NpdGlvbi4gUmVzcGVjdCBsaW1pdGF0aW9ucyBhbmQgc25hcHBpbmcgYXV0b21hdGljYWxseS4KICAgICAgICoKICAgICAgICogQHBhcmFtIGxlZnQge051bWJlcn0gSG9yaXpvbnRhbCBzY3JvbGwgcG9zaXRpb24sIGtlZXBzIGN1cnJlbnQgaWYgdmFsdWUgaXMgPGNvZGU+bnVsbDwvY29kZT4KICAgICAgICogQHBhcmFtIHRvcCB7TnVtYmVyfSBWZXJ0aWNhbCBzY3JvbGwgcG9zaXRpb24sIGtlZXBzIGN1cnJlbnQgaWYgdmFsdWUgaXMgPGNvZGU+bnVsbDwvY29kZT4KICAgICAgICogQHBhcmFtIGFuaW1hdGUge0Jvb2xlYW59IFdoZXRoZXIgdGhlIHNjcm9sbGluZyBzaG91bGQgaGFwcGVuIHVzaW5nIGFuIGFuaW1hdGlvbgogICAgICAgKiBAcGFyYW0gem9vbSB7TnVtYmVyfSBab29tIGxldmVsIHRvIGdvIHRvCiAgICAgICAqLwogICAgICBzY3JvbGxUbzogZnVuY3Rpb24obGVmdCwgdG9wLCBhbmltYXRlLCB6b29tLCB3YXNSZXNpemUpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIC8vIFN0b3AgZGVjZWxlcmF0aW9uCiAgICAgICAgaWYgKHNlbGYuX19pc0RlY2VsZXJhdGluZykgewogICAgICAgICAgenluZ2FDb3JlLmVmZmVjdC5BbmltYXRlLnN0b3Aoc2VsZi5fX2lzRGVjZWxlcmF0aW5nKTsKICAgICAgICAgIHNlbGYuX19pc0RlY2VsZXJhdGluZyA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgLy8gQ29ycmVjdCBjb29yZGluYXRlcyBiYXNlZCBvbiBuZXcgem9vbSBsZXZlbAogICAgICAgIGlmICh6b29tICE9IG51bGwgJiYgem9vbSAhPT0gc2VsZi5fX3pvb21MZXZlbCkgewoKICAgICAgICAgIGlmICghc2VsZi5vcHRpb25zLnpvb21pbmcpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJab29taW5nIGlzIG5vdCBlbmFibGVkISIpOwogICAgICAgICAgfQoKICAgICAgICAgIGxlZnQgKj0gem9vbTsKICAgICAgICAgIHRvcCAqPSB6b29tOwoKICAgICAgICAgIC8vIFJlY29tcHV0ZSBtYXhpbXVtIHZhbHVlcyB3aGlsZSB0ZW1wb3JhcnkgdHdlYWtpbmcgbWF4aW11bSBzY3JvbGwgcmFuZ2VzCiAgICAgICAgICBzZWxmLl9fY29tcHV0ZVNjcm9sbE1heCh6b29tKTsKCiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAvLyBLZWVwIHpvb20gd2hlbiBub3QgZGVmaW5lZAogICAgICAgICAgem9vbSA9IHNlbGYuX196b29tTGV2ZWw7CgogICAgICAgIH0KCiAgICAgICAgaWYgKCFzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nWCkgewoKICAgICAgICAgIGxlZnQgPSBzZWxmLl9fc2Nyb2xsTGVmdDsKCiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLnBhZ2luZykgewogICAgICAgICAgICBsZWZ0ID0gTWF0aC5yb3VuZChsZWZ0IC8gc2VsZi5fX2NsaWVudFdpZHRoKSAqIHNlbGYuX19jbGllbnRXaWR0aDsKICAgICAgICAgIH0gZWxzZSBpZiAoc2VsZi5vcHRpb25zLnNuYXBwaW5nKSB7CiAgICAgICAgICAgIGxlZnQgPSBNYXRoLnJvdW5kKGxlZnQgLyBzZWxmLl9fc25hcFdpZHRoKSAqIHNlbGYuX19zbmFwV2lkdGg7CiAgICAgICAgICB9CgogICAgICAgIH0KCiAgICAgICAgaWYgKCFzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nWSkgewoKICAgICAgICAgIHRvcCA9IHNlbGYuX19zY3JvbGxUb3A7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5wYWdpbmcpIHsKICAgICAgICAgICAgdG9wID0gTWF0aC5yb3VuZCh0b3AgLyBzZWxmLl9fY2xpZW50SGVpZ2h0KSAqIHNlbGYuX19jbGllbnRIZWlnaHQ7CiAgICAgICAgICB9IGVsc2UgaWYgKHNlbGYub3B0aW9ucy5zbmFwcGluZykgewogICAgICAgICAgICB0b3AgPSBNYXRoLnJvdW5kKHRvcCAvIHNlbGYuX19zbmFwSGVpZ2h0KSAqIHNlbGYuX19zbmFwSGVpZ2h0OwogICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIC8vIExpbWl0IGZvciBhbGxvd2VkIHJhbmdlcwogICAgICAgIGxlZnQgPSBNYXRoLm1heChNYXRoLm1pbihzZWxmLl9fbWF4U2Nyb2xsTGVmdCwgbGVmdCksIDApOwogICAgICAgIHRvcCA9IE1hdGgubWF4KE1hdGgubWluKHNlbGYuX19tYXhTY3JvbGxUb3AsIHRvcCksIDApOwoKICAgICAgICAvLyBEb24ndCBhbmltYXRlIHdoZW4gbm8gY2hhbmdlIGRldGVjdGVkLCBzdGlsbCBjYWxsIHB1Ymxpc2ggdG8gbWFrZSBzdXJlCiAgICAgICAgLy8gdGhhdCByZW5kZXJlZCBwb3NpdGlvbiBpcyByZWFsbHkgaW4tc3luYyB3aXRoIGludGVybmFsIGRhdGEKICAgICAgICBpZiAobGVmdCA9PT0gc2VsZi5fX3Njcm9sbExlZnQgJiYgdG9wID09PSBzZWxmLl9fc2Nyb2xsVG9wKSB7CiAgICAgICAgICBhbmltYXRlID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICAvLyBQdWJsaXNoIG5ldyB2YWx1ZXMKICAgICAgICBzZWxmLl9fcHVibGlzaChsZWZ0LCB0b3AsIHpvb20sIGFuaW1hdGUsIHdhc1Jlc2l6ZSk7CgogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBTY3JvbGwgYnkgdGhlIGdpdmVuIG9mZnNldAogICAgICAgKgogICAgICAgKiBAcGFyYW0gbGVmdCB7TnVtYmVyfSBTY3JvbGwgeC1heGlzIGJ5IGdpdmVuIG9mZnNldAogICAgICAgKiBAcGFyYW0gdG9wIHtOdW1iZXJ9IFNjcm9sbCB5LWF4aXMgYnkgZ2l2ZW4gb2Zmc2V0CiAgICAgICAqIEBwYXJhbSBhbmltYXRlIHtCb29sZWFufSBXaGV0aGVyIHRvIGFuaW1hdGUgdGhlIGdpdmVuIGNoYW5nZQogICAgICAgKi8KICAgICAgc2Nyb2xsQnk6IGZ1bmN0aW9uKGxlZnQsIHRvcCwgYW5pbWF0ZSkgewoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHZhciBzdGFydExlZnQgPSBzZWxmLl9faXNBbmltYXRpbmcgPyBzZWxmLl9fc2NoZWR1bGVkTGVmdCA6IHNlbGYuX19zY3JvbGxMZWZ0OwogICAgICAgIHZhciBzdGFydFRvcCA9IHNlbGYuX19pc0FuaW1hdGluZyA/IHNlbGYuX19zY2hlZHVsZWRUb3AgOiBzZWxmLl9fc2Nyb2xsVG9wOwoKICAgICAgICBzZWxmLnNjcm9sbFRvKHN0YXJ0TGVmdCArIChsZWZ0IHx8IDApLCBzdGFydFRvcCArICh0b3AgfHwgMCksIGFuaW1hdGUpOwoKICAgICAgfSwKCgoKICAgICAgLyoKICAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgRVZFTlQgQ0FMTEJBQ0tTCiAgICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICovCgogICAgICAvKioKICAgICAgICogTW91c2Ugd2hlZWwgaGFuZGxlciBmb3Igem9vbWluZyBzdXBwb3J0CiAgICAgICAqLwogICAgICBkb01vdXNlWm9vbTogZnVuY3Rpb24od2hlZWxEZWx0YSwgdGltZVN0YW1wLCBwYWdlWCwgcGFnZVkpIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgIHZhciBjaGFuZ2UgPSB3aGVlbERlbHRhID4gMCA/IDAuOTcgOiAxLjAzOwoKICAgICAgICByZXR1cm4gc2VsZi56b29tVG8oc2VsZi5fX3pvb21MZXZlbCAqIGNoYW5nZSwgZmFsc2UsIHBhZ2VYIC0gc2VsZi5fX2NsaWVudExlZnQsIHBhZ2VZIC0gc2VsZi5fX2NsaWVudFRvcCk7CgogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFRvdWNoIHN0YXJ0IGhhbmRsZXIgZm9yIHNjcm9sbGluZyBzdXBwb3J0CiAgICAgICAqLwogICAgICBkb1RvdWNoU3RhcnQ6IGZ1bmN0aW9uKHRvdWNoZXMsIHRpbWVTdGFtcCkgewogICAgICAgIHRoaXMuaGludFJlc2l6ZSgpOwoKICAgICAgICBpZiAodGltZVN0YW1wIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgICAgdGltZVN0YW1wID0gdGltZVN0YW1wLnZhbHVlT2YoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiB0aW1lU3RhbXAgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICB0aW1lU3RhbXAgPSBEYXRlLm5vdygpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICAvLyBSZXNldCBpbnRlcnJ1cHRlZEFuaW1hdGlvbiBmbGFnCiAgICAgICAgc2VsZi5fX2ludGVycnVwdGVkQW5pbWF0aW9uID0gdHJ1ZTsKCiAgICAgICAgLy8gU3RvcCBkZWNlbGVyYXRpb24KICAgICAgICBpZiAoc2VsZi5fX2lzRGVjZWxlcmF0aW5nKSB7CiAgICAgICAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUuc3RvcChzZWxmLl9faXNEZWNlbGVyYXRpbmcpOwogICAgICAgICAgc2VsZi5fX2lzRGVjZWxlcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICBzZWxmLl9faW50ZXJydXB0ZWRBbmltYXRpb24gPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gU3RvcCBhbmltYXRpb24KICAgICAgICBpZiAoc2VsZi5fX2lzQW5pbWF0aW5nKSB7CiAgICAgICAgICB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUuc3RvcChzZWxmLl9faXNBbmltYXRpbmcpOwogICAgICAgICAgc2VsZi5fX2lzQW5pbWF0aW5nID0gZmFsc2U7CiAgICAgICAgICBzZWxmLl9faW50ZXJydXB0ZWRBbmltYXRpb24gPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gVXNlIGNlbnRlciBwb2ludCB3aGVuIGRlYWxpbmcgd2l0aCB0d28gZmluZ2VycwogICAgICAgIHZhciBjdXJyZW50VG91Y2hMZWZ0LCBjdXJyZW50VG91Y2hUb3A7CiAgICAgICAgdmFyIGlzU2luZ2xlVG91Y2ggPSB0b3VjaGVzLmxlbmd0aCA9PT0gMTsKICAgICAgICBpZiAoaXNTaW5nbGVUb3VjaCkgewogICAgICAgICAgY3VycmVudFRvdWNoTGVmdCA9IHRvdWNoZXNbMF0ucGFnZVg7CiAgICAgICAgICBjdXJyZW50VG91Y2hUb3AgPSB0b3VjaGVzWzBdLnBhZ2VZOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdXJyZW50VG91Y2hMZWZ0ID0gTWF0aC5hYnModG91Y2hlc1swXS5wYWdlWCArIHRvdWNoZXNbMV0ucGFnZVgpIC8gMjsKICAgICAgICAgIGN1cnJlbnRUb3VjaFRvcCA9IE1hdGguYWJzKHRvdWNoZXNbMF0ucGFnZVkgKyB0b3VjaGVzWzFdLnBhZ2VZKSAvIDI7CiAgICAgICAgfQoKICAgICAgICAvLyBTdG9yZSBpbml0aWFsIHBvc2l0aW9ucwogICAgICAgIHNlbGYuX19pbml0aWFsVG91Y2hMZWZ0ID0gY3VycmVudFRvdWNoTGVmdDsKICAgICAgICBzZWxmLl9faW5pdGlhbFRvdWNoVG9wID0gY3VycmVudFRvdWNoVG9wOwoKICAgICAgICAvLyBTdG9yZSBpbml0aWFsIHRvdWNoTGlzdCBmb3Igc2NhbGUgY2FsY3VsYXRpb24KICAgICAgICBzZWxmLl9faW5pdGlhbFRvdWNoZXMgPSB0b3VjaGVzOwoKICAgICAgICAvLyBTdG9yZSBjdXJyZW50IHpvb20gbGV2ZWwKICAgICAgICBzZWxmLl9fem9vbUxldmVsU3RhcnQgPSBzZWxmLl9fem9vbUxldmVsOwoKICAgICAgICAvLyBTdG9yZSBpbml0aWFsIHRvdWNoIHBvc2l0aW9ucwogICAgICAgIHNlbGYuX19sYXN0VG91Y2hMZWZ0ID0gY3VycmVudFRvdWNoTGVmdDsKICAgICAgICBzZWxmLl9fbGFzdFRvdWNoVG9wID0gY3VycmVudFRvdWNoVG9wOwoKICAgICAgICAvLyBTdG9yZSBpbml0aWFsIG1vdmUgdGltZSBzdGFtcAogICAgICAgIHNlbGYuX19sYXN0VG91Y2hNb3ZlID0gdGltZVN0YW1wOwoKICAgICAgICAvLyBSZXNldCBpbml0aWFsIHNjYWxlCiAgICAgICAgc2VsZi5fX2xhc3RTY2FsZSA9IDE7CgogICAgICAgIC8vIFJlc2V0IGxvY2tpbmcgZmxhZ3MKICAgICAgICBzZWxmLl9fZW5hYmxlU2Nyb2xsWCA9ICFpc1NpbmdsZVRvdWNoICYmIHNlbGYub3B0aW9ucy5zY3JvbGxpbmdYOwogICAgICAgIHNlbGYuX19lbmFibGVTY3JvbGxZID0gIWlzU2luZ2xlVG91Y2ggJiYgc2VsZi5vcHRpb25zLnNjcm9sbGluZ1k7CgogICAgICAgIC8vIFJlc2V0IHRyYWNraW5nIGZsYWcKICAgICAgICBzZWxmLl9faXNUcmFja2luZyA9IHRydWU7CgogICAgICAgIC8vIFJlc2V0IGRlY2VsZXJhdGlvbiBjb21wbGV0ZSBmbGFnCiAgICAgICAgc2VsZi5fX2RpZERlY2VsZXJhdGlvbkNvbXBsZXRlID0gZmFsc2U7CgogICAgICAgIC8vIERyYWdnaW5nIHN0YXJ0cyBkaXJlY3RseSB3aXRoIHR3byBmaW5nZXJzLCBvdGhlcndpc2UgbGF6eSB3aXRoIGFuIG9mZnNldAogICAgICAgIHNlbGYuX19pc0RyYWdnaW5nID0gIWlzU2luZ2xlVG91Y2g7CgogICAgICAgIC8vIFNvbWUgZmVhdHVyZXMgYXJlIGRpc2FibGVkIGluIG11bHRpIHRvdWNoIHNjZW5hcmlvcwogICAgICAgIHNlbGYuX19pc1NpbmdsZVRvdWNoID0gaXNTaW5nbGVUb3VjaDsKCiAgICAgICAgLy8gQ2xlYXJpbmcgZGF0YSBzdHJ1Y3R1cmUKICAgICAgICBzZWxmLl9fcG9zaXRpb25zID0gW107CgogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBUb3VjaCBtb3ZlIGhhbmRsZXIgZm9yIHNjcm9sbGluZyBzdXBwb3J0CiAgICAgICAqLwogICAgICBkb1RvdWNoTW92ZTogZnVuY3Rpb24odG91Y2hlcywgdGltZVN0YW1wLCBzY2FsZSkgewogICAgICAgIGlmICh0aW1lU3RhbXAgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgICB0aW1lU3RhbXAgPSB0aW1lU3RhbXAudmFsdWVPZigpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIHRpbWVTdGFtcCAhPT0gIm51bWJlciIpIHsKICAgICAgICAgIHRpbWVTdGFtcCA9IERhdGUubm93KCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIC8vIElnbm9yZSBldmVudCB3aGVuIHRyYWNraW5nIGlzIG5vdCBlbmFibGVkIChldmVudCBtaWdodCBiZSBvdXRzaWRlIG9mIGVsZW1lbnQpCiAgICAgICAgaWYgKCFzZWxmLl9faXNUcmFja2luZykgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGN1cnJlbnRUb3VjaExlZnQsIGN1cnJlbnRUb3VjaFRvcDsKCiAgICAgICAgLy8gQ29tcHV0ZSBtb3ZlIGJhc2VkIGFyb3VuZCBvZiBjZW50ZXIgb2YgZmluZ2VycwogICAgICAgIGlmICh0b3VjaGVzLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgY3VycmVudFRvdWNoTGVmdCA9IE1hdGguYWJzKHRvdWNoZXNbMF0ucGFnZVggKyB0b3VjaGVzWzFdLnBhZ2VYKSAvIDI7CiAgICAgICAgICBjdXJyZW50VG91Y2hUb3AgPSBNYXRoLmFicyh0b3VjaGVzWzBdLnBhZ2VZICsgdG91Y2hlc1sxXS5wYWdlWSkgLyAyOwoKICAgICAgICAgIC8vIENhbGN1bGF0ZSBzY2FsZSB3aGVuIG5vdCBwcmVzZW50IGFuZCBvbmx5IHdoZW4gdG91Y2hlcyBhcmUgdXNlZAogICAgICAgICAgaWYgKCFzY2FsZSAmJiBzZWxmLm9wdGlvbnMuem9vbWluZykgewogICAgICAgICAgICBzY2FsZSA9IHNlbGYuX19nZXRTY2FsZShzZWxmLl9faW5pdGlhbFRvdWNoZXMsIHRvdWNoZXMpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjdXJyZW50VG91Y2hMZWZ0ID0gdG91Y2hlc1swXS5wYWdlWDsKICAgICAgICAgIGN1cnJlbnRUb3VjaFRvcCA9IHRvdWNoZXNbMF0ucGFnZVk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcG9zaXRpb25zID0gc2VsZi5fX3Bvc2l0aW9uczsKCiAgICAgICAgLy8gQXJlIHdlIGFscmVhZHkgaXMgZHJhZ2dpbmcgbW9kZT8KICAgICAgICBpZiAoc2VsZi5fX2lzRHJhZ2dpbmcpIHsKCiAgICAgICAgICAvLyBDb21wdXRlIG1vdmUgZGlzdGFuY2UKICAgICAgICAgIHZhciBtb3ZlWCA9IGN1cnJlbnRUb3VjaExlZnQgLSBzZWxmLl9fbGFzdFRvdWNoTGVmdDsKICAgICAgICAgIHZhciBtb3ZlWSA9IGN1cnJlbnRUb3VjaFRvcCAtIHNlbGYuX19sYXN0VG91Y2hUb3A7CgogICAgICAgICAgLy8gUmVhZCBwcmV2aW91cyBzY3JvbGwgcG9zaXRpb24gYW5kIHpvb21pbmcKICAgICAgICAgIHZhciBzY3JvbGxMZWZ0ID0gc2VsZi5fX3Njcm9sbExlZnQ7CiAgICAgICAgICB2YXIgc2Nyb2xsVG9wID0gc2VsZi5fX3Njcm9sbFRvcDsKICAgICAgICAgIHZhciBsZXZlbCA9IHNlbGYuX196b29tTGV2ZWw7CgogICAgICAgICAgLy8gV29yayB3aXRoIHNjYWxpbmcKICAgICAgICAgIGlmIChzY2FsZSAhPSBudWxsICYmIHNlbGYub3B0aW9ucy56b29taW5nKSB7CgogICAgICAgICAgICB2YXIgb2xkTGV2ZWwgPSBsZXZlbDsKCiAgICAgICAgICAgIC8vIFJlY29tcHV0ZSBsZXZlbCBiYXNlZCBvbiBwcmV2aW91cyBzY2FsZSBhbmQgbmV3IHNjYWxlCiAgICAgICAgICAgIGxldmVsID0gbGV2ZWwgLyBzZWxmLl9fbGFzdFNjYWxlICogc2NhbGU7CgogICAgICAgICAgICAvLyBMaW1pdCBsZXZlbCBhY2NvcmRpbmcgdG8gY29uZmlndXJhdGlvbgogICAgICAgICAgICBsZXZlbCA9IE1hdGgubWF4KE1hdGgubWluKGxldmVsLCBzZWxmLm9wdGlvbnMubWF4Wm9vbSksIHNlbGYub3B0aW9ucy5taW5ab29tKTsKCiAgICAgICAgICAgIC8vIE9ubHkgZG8gZnVydGhlciBjb21wdXRpb24gd2hlbiBjaGFuZ2UgaGFwcGVuZWQKICAgICAgICAgICAgaWYgKG9sZExldmVsICE9PSBsZXZlbCkgewoKICAgICAgICAgICAgICAvLyBDb21wdXRlIHJlbGF0aXZlIGV2ZW50IHBvc2l0aW9uIHRvIGNvbnRhaW5lcgogICAgICAgICAgICAgIHZhciBjdXJyZW50VG91Y2hMZWZ0UmVsID0gY3VycmVudFRvdWNoTGVmdCAtIHNlbGYuX19jbGllbnRMZWZ0OwogICAgICAgICAgICAgIHZhciBjdXJyZW50VG91Y2hUb3BSZWwgPSBjdXJyZW50VG91Y2hUb3AgLSBzZWxmLl9fY2xpZW50VG9wOwoKICAgICAgICAgICAgICAvLyBSZWNvbXB1dGUgbGVmdCBhbmQgdG9wIGNvb3JkaW5hdGVzIGJhc2VkIG9uIG5ldyB6b29tIGxldmVsCiAgICAgICAgICAgICAgc2Nyb2xsTGVmdCA9ICgoY3VycmVudFRvdWNoTGVmdFJlbCArIHNjcm9sbExlZnQpICogbGV2ZWwgLyBvbGRMZXZlbCkgLSBjdXJyZW50VG91Y2hMZWZ0UmVsOwogICAgICAgICAgICAgIHNjcm9sbFRvcCA9ICgoY3VycmVudFRvdWNoVG9wUmVsICsgc2Nyb2xsVG9wKSAqIGxldmVsIC8gb2xkTGV2ZWwpIC0gY3VycmVudFRvdWNoVG9wUmVsOwoKICAgICAgICAgICAgICAvLyBSZWNvbXB1dGUgbWF4IHNjcm9sbCB2YWx1ZXMKICAgICAgICAgICAgICBzZWxmLl9fY29tcHV0ZVNjcm9sbE1heChsZXZlbCk7CgogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHNlbGYuX19lbmFibGVTY3JvbGxYKSB7CgogICAgICAgICAgICBzY3JvbGxMZWZ0IC09IG1vdmVYICogdGhpcy5vcHRpb25zLnNwZWVkTXVsdGlwbGllcjsKICAgICAgICAgICAgdmFyIG1heFNjcm9sbExlZnQgPSBzZWxmLl9fbWF4U2Nyb2xsTGVmdDsKCiAgICAgICAgICAgIGlmIChzY3JvbGxMZWZ0ID4gbWF4U2Nyb2xsTGVmdCB8fCBzY3JvbGxMZWZ0IDwgMCkgewoKICAgICAgICAgICAgICAvLyBTbG93IGRvd24gb24gdGhlIGVkZ2VzCiAgICAgICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy5ib3VuY2luZykgewoKICAgICAgICAgICAgICAgIHNjcm9sbExlZnQgKz0gKG1vdmVYIC8gMiAgKiB0aGlzLm9wdGlvbnMuc3BlZWRNdWx0aXBsaWVyKTsKCiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzY3JvbGxMZWZ0ID4gbWF4U2Nyb2xsTGVmdCkgewoKICAgICAgICAgICAgICAgIHNjcm9sbExlZnQgPSBtYXhTY3JvbGxMZWZ0OwoKICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHNjcm9sbExlZnQgPSAwOwoKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBDb21wdXRlIG5ldyB2ZXJ0aWNhbCBzY3JvbGwgcG9zaXRpb24KICAgICAgICAgIGlmIChzZWxmLl9fZW5hYmxlU2Nyb2xsWSkgewoKICAgICAgICAgICAgc2Nyb2xsVG9wIC09IG1vdmVZICogdGhpcy5vcHRpb25zLnNwZWVkTXVsdGlwbGllcjsKICAgICAgICAgICAgdmFyIG1heFNjcm9sbFRvcCA9IHNlbGYuX19tYXhTY3JvbGxUb3A7CgogICAgICAgICAgICBpZiAoc2Nyb2xsVG9wID4gbWF4U2Nyb2xsVG9wIHx8IHNjcm9sbFRvcCA8IDApIHsKCiAgICAgICAgICAgICAgLy8gU2xvdyBkb3duIG9uIHRoZSBlZGdlcwogICAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuYm91bmNpbmcgfHwgKHNlbGYuX19yZWZyZXNoSGVpZ2h0ICYmIHNjcm9sbFRvcCA8IDApKSB7CgogICAgICAgICAgICAgICAgc2Nyb2xsVG9wICs9IChtb3ZlWSAvIDIgKiB0aGlzLm9wdGlvbnMuc3BlZWRNdWx0aXBsaWVyKTsKCiAgICAgICAgICAgICAgICAvLyBTdXBwb3J0IHB1bGwtdG8tcmVmcmVzaCAob25seSB3aGVuIG9ubHkgeSBpcyBzY3JvbGxhYmxlKQogICAgICAgICAgICAgICAgaWYgKCFzZWxmLl9fZW5hYmxlU2Nyb2xsWCAmJiBzZWxmLl9fcmVmcmVzaEhlaWdodCAhPSBudWxsKSB7CgogICAgICAgICAgICAgICAgICBpZiAoIXNlbGYuX19yZWZyZXNoQWN0aXZlICYmIHNjcm9sbFRvcCA8PSAtc2VsZi5fX3JlZnJlc2hIZWlnaHQpIHsKCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hBY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLl9fcmVmcmVzaEFjdGl2YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9fcmVmcmVzaEFjdGl2YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzZWxmLl9fcmVmcmVzaEFjdGl2ZSAmJiBzY3JvbGxUb3AgPiAtc2VsZi5fX3JlZnJlc2hIZWlnaHQpIHsKCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hBY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZi5fX3JlZnJlc2hEZWFjdGl2YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9fcmVmcmVzaERlYWN0aXZhdGUoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2Nyb2xsVG9wID4gbWF4U2Nyb2xsVG9wKSB7CgogICAgICAgICAgICAgICAgc2Nyb2xsVG9wID0gbWF4U2Nyb2xsVG9wOwoKICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHNjcm9sbFRvcCA9IDA7CgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIEtlZXAgbGlzdCBmcm9tIGdyb3dpbmcgaW5maW5pdGVseSAoaG9sZGluZyBtaW4gMTAsIG1heCAyMCBtZWFzdXJlIHBvaW50cykKICAgICAgICAgIGlmIChwb3NpdGlvbnMubGVuZ3RoID4gNjApIHsKICAgICAgICAgICAgcG9zaXRpb25zLnNwbGljZSgwLCAzMCk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gVHJhY2sgc2Nyb2xsIG1vdmVtZW50IGZvciBkZWNsZXJhdGlvbgogICAgICAgICAgcG9zaXRpb25zLnB1c2goc2Nyb2xsTGVmdCwgc2Nyb2xsVG9wLCB0aW1lU3RhbXApOwoKICAgICAgICAgIC8vIFN5bmMgc2Nyb2xsIHBvc2l0aW9uCiAgICAgICAgICBzZWxmLl9fcHVibGlzaChzY3JvbGxMZWZ0LCBzY3JvbGxUb3AsIGxldmVsKTsKCiAgICAgICAgICAvLyBPdGhlcndpc2UgZmlndXJlIG91dCB3aGV0aGVyIHdlIGFyZSBzd2l0Y2hpbmcgaW50byBkcmFnZ2luZyBtb2RlIG5vdy4KICAgICAgICB9IGVsc2UgewoKICAgICAgICAgIHZhciBtaW5pbXVtVHJhY2tpbmdGb3JTY3JvbGwgPSBzZWxmLm9wdGlvbnMubG9ja2luZyA/IDMgOiAwOwogICAgICAgICAgdmFyIG1pbmltdW1UcmFja2luZ0ZvckRyYWcgPSA1OwoKICAgICAgICAgIHZhciBkaXN0YW5jZVggPSBNYXRoLmFicyhjdXJyZW50VG91Y2hMZWZ0IC0gc2VsZi5fX2luaXRpYWxUb3VjaExlZnQpOwogICAgICAgICAgdmFyIGRpc3RhbmNlWSA9IE1hdGguYWJzKGN1cnJlbnRUb3VjaFRvcCAtIHNlbGYuX19pbml0aWFsVG91Y2hUb3ApOwoKICAgICAgICAgIHNlbGYuX19lbmFibGVTY3JvbGxYID0gc2VsZi5vcHRpb25zLnNjcm9sbGluZ1ggJiYgZGlzdGFuY2VYID49IG1pbmltdW1UcmFja2luZ0ZvclNjcm9sbDsKICAgICAgICAgIHNlbGYuX19lbmFibGVTY3JvbGxZID0gc2VsZi5vcHRpb25zLnNjcm9sbGluZ1kgJiYgZGlzdGFuY2VZID49IG1pbmltdW1UcmFja2luZ0ZvclNjcm9sbDsKCiAgICAgICAgICBwb3NpdGlvbnMucHVzaChzZWxmLl9fc2Nyb2xsTGVmdCwgc2VsZi5fX3Njcm9sbFRvcCwgdGltZVN0YW1wKTsKCiAgICAgICAgICBzZWxmLl9faXNEcmFnZ2luZyA9IChzZWxmLl9fZW5hYmxlU2Nyb2xsWCB8fCBzZWxmLl9fZW5hYmxlU2Nyb2xsWSkgJiYgKGRpc3RhbmNlWCA+PSBtaW5pbXVtVHJhY2tpbmdGb3JEcmFnIHx8IGRpc3RhbmNlWSA+PSBtaW5pbXVtVHJhY2tpbmdGb3JEcmFnKTsKICAgICAgICAgIGlmIChzZWxmLl9faXNEcmFnZ2luZykgewogICAgICAgICAgICBzZWxmLl9faW50ZXJydXB0ZWRBbmltYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgc2VsZi5fX2ZhZGVTY3JvbGxiYXJzKCdpbicpOwogICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSBsYXN0IHRvdWNoIHBvc2l0aW9ucyBhbmQgdGltZSBzdGFtcCBmb3IgbmV4dCBldmVudAogICAgICAgIHNlbGYuX19sYXN0VG91Y2hMZWZ0ID0gY3VycmVudFRvdWNoTGVmdDsKICAgICAgICBzZWxmLl9fbGFzdFRvdWNoVG9wID0gY3VycmVudFRvdWNoVG9wOwogICAgICAgIHNlbGYuX19sYXN0VG91Y2hNb3ZlID0gdGltZVN0YW1wOwogICAgICAgIHNlbGYuX19sYXN0U2NhbGUgPSBzY2FsZTsKCiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIFRvdWNoIGVuZCBoYW5kbGVyIGZvciBzY3JvbGxpbmcgc3VwcG9ydAogICAgICAgKi8KICAgICAgZG9Ub3VjaEVuZDogZnVuY3Rpb24odGltZVN0YW1wKSB7CiAgICAgICAgaWYgKHRpbWVTdGFtcCBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgICAgIHRpbWVTdGFtcCA9IHRpbWVTdGFtcC52YWx1ZU9mKCk7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgdGltZVN0YW1wICE9PSAibnVtYmVyIikgewogICAgICAgICAgdGltZVN0YW1wID0gRGF0ZS5ub3coKTsKICAgICAgICB9CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgLy8gSWdub3JlIGV2ZW50IHdoZW4gdHJhY2tpbmcgaXMgbm90IGVuYWJsZWQgKG5vIHRvdWNoc3RhcnQgZXZlbnQgb24gZWxlbWVudCkKICAgICAgICAvLyBUaGlzIGlzIHJlcXVpcmVkIGFzIHRoaXMgbGlzdGVuZXIgKCd0b3VjaG1vdmUnKSBzaXRzIG9uIHRoZSBkb2N1bWVudCBhbmQgbm90IG9uIHRoZSBlbGVtZW50IGl0c2VsZi4KICAgICAgICBpZiAoIXNlbGYuX19pc1RyYWNraW5nKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBOb3QgdG91Y2hpbmcgYW55bW9yZSAod2hlbiB0d28gZmluZ2VyIGhpdCB0aGUgc2NyZWVuIHRoZXJlIGFyZSB0d28gdG91Y2ggZW5kIGV2ZW50cykKICAgICAgICBzZWxmLl9faXNUcmFja2luZyA9IGZhbHNlOwoKICAgICAgICAvLyBCZSBzdXJlIHRvIHJlc2V0IHRoZSBkcmFnZ2luZyBmbGFnIG5vdy4gSGVyZSB3ZSBhbHNvIGRldGVjdCB3aGV0aGVyCiAgICAgICAgLy8gdGhlIGZpbmdlciBoYXMgbW92ZWQgZmFzdCBlbm91Z2ggdG8gc3dpdGNoIGludG8gYSBkZWNlbGVyYXRpb24gYW5pbWF0aW9uLgogICAgICAgIGlmIChzZWxmLl9faXNEcmFnZ2luZykgewoKICAgICAgICAgIC8vIFJlc2V0IGRyYWdnaW5nIGZsYWcKICAgICAgICAgIHNlbGYuX19pc0RyYWdnaW5nID0gZmFsc2U7CgogICAgICAgICAgLy8gU3RhcnQgZGVjZWxlcmF0aW9uCiAgICAgICAgICAvLyBWZXJpZnkgdGhhdCB0aGUgbGFzdCBtb3ZlIGRldGVjdGVkIHdhcyBpbiBzb21lIHJlbGV2YW50IHRpbWUgZnJhbWUKICAgICAgICAgIGlmIChzZWxmLl9faXNTaW5nbGVUb3VjaCAmJiBzZWxmLm9wdGlvbnMuYW5pbWF0aW5nICYmICh0aW1lU3RhbXAgLSBzZWxmLl9fbGFzdFRvdWNoTW92ZSkgPD0gMTAwKSB7CgogICAgICAgICAgICAvLyBUaGVuIGZpZ3VyZSBvdXQgd2hhdCB0aGUgc2Nyb2xsIHBvc2l0aW9uIHdhcyBhYm91dCAxMDBtcyBhZ28KICAgICAgICAgICAgdmFyIHBvc2l0aW9ucyA9IHNlbGYuX19wb3NpdGlvbnM7CiAgICAgICAgICAgIHZhciBlbmRQb3MgPSBwb3NpdGlvbnMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgdmFyIHN0YXJ0UG9zID0gZW5kUG9zOwoKICAgICAgICAgICAgLy8gTW92ZSBwb2ludGVyIHRvIHBvc2l0aW9uIG1lYXN1cmVkIDEwMG1zIGFnbwogICAgICAgICAgICBmb3IgKHZhciBpID0gZW5kUG9zOyBpID4gMCAmJiBwb3NpdGlvbnNbaV0gPiAoc2VsZi5fX2xhc3RUb3VjaE1vdmUgLSAxMDApOyBpIC09IDMpIHsKICAgICAgICAgICAgICBzdGFydFBvcyA9IGk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIElmIHN0YXJ0IGFuZCBzdG9wIHBvc2l0aW9uIGlzIGlkZW50aWNhbCBpbiBhIDEwMG1zIHRpbWVmcmFtZSwKICAgICAgICAgICAgLy8gd2UgY2Fubm90IGNvbXB1dGUgYW55IHVzZWZ1bCBkZWNlbGVyYXRpb24uCiAgICAgICAgICAgIGlmIChzdGFydFBvcyAhPT0gZW5kUG9zKSB7CgogICAgICAgICAgICAgIC8vIENvbXB1dGUgcmVsYXRpdmUgbW92ZW1lbnQgYmV0d2VlbiB0aGVzZSB0d28gcG9pbnRzCiAgICAgICAgICAgICAgdmFyIHRpbWVPZmZzZXQgPSBwb3NpdGlvbnNbZW5kUG9zXSAtIHBvc2l0aW9uc1tzdGFydFBvc107CiAgICAgICAgICAgICAgdmFyIG1vdmVkTGVmdCA9IHNlbGYuX19zY3JvbGxMZWZ0IC0gcG9zaXRpb25zW3N0YXJ0UG9zIC0gMl07CiAgICAgICAgICAgICAgdmFyIG1vdmVkVG9wID0gc2VsZi5fX3Njcm9sbFRvcCAtIHBvc2l0aW9uc1tzdGFydFBvcyAtIDFdOwoKICAgICAgICAgICAgICAvLyBCYXNlZCBvbiA1MG1zIGNvbXB1dGUgdGhlIG1vdmVtZW50IHRvIGFwcGx5IGZvciBlYWNoIHJlbmRlciBzdGVwCiAgICAgICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WCA9IG1vdmVkTGVmdCAvIHRpbWVPZmZzZXQgKiAoMTAwMCAvIDYwKTsKICAgICAgICAgICAgICBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZID0gbW92ZWRUb3AgLyB0aW1lT2Zmc2V0ICogKDEwMDAgLyA2MCk7CgogICAgICAgICAgICAgIC8vIEhvdyBtdWNoIHZlbG9jaXR5IGlzIHJlcXVpcmVkIHRvIHN0YXJ0IHRoZSBkZWNlbGVyYXRpb24KICAgICAgICAgICAgICB2YXIgbWluVmVsb2NpdHlUb1N0YXJ0RGVjZWxlcmF0aW9uID0gc2VsZi5vcHRpb25zLnBhZ2luZyB8fCBzZWxmLm9wdGlvbnMuc25hcHBpbmcgPyA0IDogMTsKCiAgICAgICAgICAgICAgLy8gVmVyaWZ5IHRoYXQgd2UgaGF2ZSBlbm91Z2ggdmVsb2NpdHkgdG8gc3RhcnQgZGVjZWxlcmF0aW9uCiAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVgpID4gbWluVmVsb2NpdHlUb1N0YXJ0RGVjZWxlcmF0aW9uIHx8IE1hdGguYWJzKHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVkpID4gbWluVmVsb2NpdHlUb1N0YXJ0RGVjZWxlcmF0aW9uKSB7CgogICAgICAgICAgICAgICAgLy8gRGVhY3RpdmF0ZSBwdWxsLXRvLXJlZnJlc2ggd2hlbiBkZWNlbGVyYXRpbmcKICAgICAgICAgICAgICAgIGlmICghc2VsZi5fX3JlZnJlc2hBY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgc2VsZi5fX3N0YXJ0RGVjZWxlcmF0aW9uKHRpbWVTdGFtcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNlbGYuX19zY3JvbGxpbmdDb21wbGV0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKCh0aW1lU3RhbXAgLSBzZWxmLl9fbGFzdFRvdWNoTW92ZSkgPiAxMDApIHsKICAgICAgICAgICAgc2VsZi5fX3Njcm9sbGluZ0NvbXBsZXRlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB0aGlzIHdhcyBhIHNsb3dlciBtb3ZlIGl0IGlzIHBlciBkZWZhdWx0IG5vbiBkZWNlbGVyYXRlZCwgYnV0IHRoaXMKICAgICAgICAvLyBzdGlsbCBtZWFucyB0aGF0IHdlIHdhbnQgc25hcCBiYWNrIHRvIHRoZSBib3VuZHMgd2hpY2ggaXMgZG9uZSBoZXJlLgogICAgICAgIC8vIFRoaXMgaXMgcGxhY2VkIG91dHNpZGUgdGhlIGNvbmRpdGlvbiBhYm92ZSB0byBpbXByb3ZlIGVkZ2UgY2FzZSBzdGFiaWxpdHkKICAgICAgICAvLyBlLmcuIHRvdWNoZW5kIGZpcmVkIHdpdGhvdXQgZW5hYmxlZCBkcmFnZ2luZy4gVGhpcyBzaG91bGQgbm9ybWFsbHkgZG8gbm90CiAgICAgICAgLy8gaGF2ZSBtb2RpZmllZCB0aGUgc2Nyb2xsIHBvc2l0aW9ucyBvciBldmVuIHNob3dlZCB0aGUgc2Nyb2xsYmFycyB0aG91Z2guCiAgICAgICAgaWYgKCFzZWxmLl9faXNEZWNlbGVyYXRpbmcpIHsKCiAgICAgICAgICBpZiAoc2VsZi5fX3JlZnJlc2hBY3RpdmUgJiYgc2VsZi5fX3JlZnJlc2hTdGFydCkgewoKICAgICAgICAgICAgLy8gVXNlIHB1Ymxpc2ggaW5zdGVhZCBvZiBzY3JvbGxUbyB0byBhbGxvdyBzY3JvbGxpbmcgdG8gb3V0IG9mIGJvdW5kYXJ5IHBvc2l0aW9uCiAgICAgICAgICAgIC8vIFdlIGRvbid0IG5lZWQgdG8gbm9ybWFsaXplIHNjcm9sbExlZnQsIHpvb21MZXZlbCwgZXRjLiBoZXJlIGJlY2F1c2Ugd2Ugb25seSB5LXNjcm9sbGluZyB3aGVuIHB1bGwtdG8tcmVmcmVzaCBpcyBlbmFibGVkCiAgICAgICAgICAgIHNlbGYuX19wdWJsaXNoKHNlbGYuX19zY3JvbGxMZWZ0LCAtc2VsZi5fX3JlZnJlc2hIZWlnaHQsIHNlbGYuX196b29tTGV2ZWwsIHRydWUpOwoKICAgICAgICAgICAgaWYgKHNlbGYuX19yZWZyZXNoU3RhcnQpIHsKICAgICAgICAgICAgICBzZWxmLl9fcmVmcmVzaFN0YXJ0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgaWYgKHNlbGYuX19pbnRlcnJ1cHRlZEFuaW1hdGlvbiB8fCBzZWxmLl9faXNEcmFnZ2luZykgewogICAgICAgICAgICAgIHNlbGYuX19zY3JvbGxpbmdDb21wbGV0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsVG8oc2VsZi5fX3Njcm9sbExlZnQsIHNlbGYuX19zY3JvbGxUb3AsIHRydWUsIHNlbGYuX196b29tTGV2ZWwpOwoKICAgICAgICAgICAgLy8gRGlyZWN0bHkgc2lnbmFsaXplIGRlYWN0aXZhdGlvbiAobm90aGluZyB0b2RvIG9uIHJlZnJlc2g/KQogICAgICAgICAgICBpZiAoc2VsZi5fX3JlZnJlc2hBY3RpdmUpIHsKCiAgICAgICAgICAgICAgc2VsZi5fX3JlZnJlc2hBY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICBpZiAoc2VsZi5fX3JlZnJlc2hEZWFjdGl2YXRlKSB7CiAgICAgICAgICAgICAgICBzZWxmLl9fcmVmcmVzaERlYWN0aXZhdGUoKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBGdWxseSBjbGVhbnVwIGxpc3QKICAgICAgICBzZWxmLl9fcG9zaXRpb25zLmxlbmd0aCA9IDA7CgogICAgICB9LAoKCgogICAgICAvKgogICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICBQUklWQVRFIEFQSQogICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEFwcGxpZXMgdGhlIHNjcm9sbCBwb3NpdGlvbiB0byB0aGUgY29udGVudCBlbGVtZW50CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSBsZWZ0IHtOdW1iZXJ9IExlZnQgc2Nyb2xsIHBvc2l0aW9uCiAgICAgICAqIEBwYXJhbSB0b3Age051bWJlcn0gVG9wIHNjcm9sbCBwb3NpdGlvbgogICAgICAgKiBAcGFyYW0gYW5pbWF0ZSB7Qm9vbGVhbn0gV2hldGhlciBhbmltYXRpb24gc2hvdWxkIGJlIHVzZWQgdG8gbW92ZSB0byB0aGUgbmV3IGNvb3JkaW5hdGVzCiAgICAgICAqLwogICAgICBfX3B1Ymxpc2g6IGZ1bmN0aW9uKGxlZnQsIHRvcCwgem9vbSwgYW5pbWF0ZSwgd2FzUmVzaXplKSB7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgLy8gUmVtZW1iZXIgd2hldGhlciB3ZSBoYWQgYW4gYW5pbWF0aW9uLCB0aGVuIHdlIHRyeSB0byBjb250aW51ZSBiYXNlZCBvbiB0aGUgY3VycmVudCAiZHJpdmUiIG9mIHRoZSBhbmltYXRpb24KICAgICAgICB2YXIgd2FzQW5pbWF0aW5nID0gc2VsZi5fX2lzQW5pbWF0aW5nOwogICAgICAgIGlmICh3YXNBbmltYXRpbmcpIHsKICAgICAgICAgIHp5bmdhQ29yZS5lZmZlY3QuQW5pbWF0ZS5zdG9wKHdhc0FuaW1hdGluZyk7CiAgICAgICAgICBzZWxmLl9faXNBbmltYXRpbmcgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmIChhbmltYXRlICYmIHNlbGYub3B0aW9ucy5hbmltYXRpbmcpIHsKCiAgICAgICAgICAvLyBLZWVwIHNjaGVkdWxlZCBwb3NpdGlvbnMgZm9yIHNjcm9sbEJ5L3pvb21CeSBmdW5jdGlvbmFsaXR5CiAgICAgICAgICBzZWxmLl9fc2NoZWR1bGVkTGVmdCA9IGxlZnQ7CiAgICAgICAgICBzZWxmLl9fc2NoZWR1bGVkVG9wID0gdG9wOwogICAgICAgICAgc2VsZi5fX3NjaGVkdWxlZFpvb20gPSB6b29tOwoKICAgICAgICAgIHZhciBvbGRMZWZ0ID0gc2VsZi5fX3Njcm9sbExlZnQ7CiAgICAgICAgICB2YXIgb2xkVG9wID0gc2VsZi5fX3Njcm9sbFRvcDsKICAgICAgICAgIHZhciBvbGRab29tID0gc2VsZi5fX3pvb21MZXZlbDsKCiAgICAgICAgICB2YXIgZGlmZkxlZnQgPSBsZWZ0IC0gb2xkTGVmdDsKICAgICAgICAgIHZhciBkaWZmVG9wID0gdG9wIC0gb2xkVG9wOwogICAgICAgICAgdmFyIGRpZmZab29tID0gem9vbSAtIG9sZFpvb207CgogICAgICAgICAgdmFyIHN0ZXAgPSBmdW5jdGlvbihwZXJjZW50LCBub3csIHJlbmRlcikgewoKICAgICAgICAgICAgaWYgKHJlbmRlcikgewoKICAgICAgICAgICAgICBzZWxmLl9fc2Nyb2xsTGVmdCA9IG9sZExlZnQgKyAoZGlmZkxlZnQgKiBwZXJjZW50KTsKICAgICAgICAgICAgICBzZWxmLl9fc2Nyb2xsVG9wID0gb2xkVG9wICsgKGRpZmZUb3AgKiBwZXJjZW50KTsKICAgICAgICAgICAgICBzZWxmLl9fem9vbUxldmVsID0gb2xkWm9vbSArIChkaWZmWm9vbSAqIHBlcmNlbnQpOwoKICAgICAgICAgICAgICAvLyBQdXNoIHZhbHVlcyBvdXQKICAgICAgICAgICAgICBpZiAoc2VsZi5fX2NhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBzZWxmLl9fY2FsbGJhY2soc2VsZi5fX3Njcm9sbExlZnQsIHNlbGYuX19zY3JvbGxUb3AsIHNlbGYuX196b29tTGV2ZWwsIHdhc1Jlc2l6ZSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICB2YXIgdmVyaWZ5ID0gZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX19pc0FuaW1hdGluZyA9PT0gaWQ7CiAgICAgICAgICB9OwoKICAgICAgICAgIHZhciBjb21wbGV0ZWQgPSBmdW5jdGlvbihyZW5kZXJlZEZyYW1lc1BlclNlY29uZCwgYW5pbWF0aW9uSWQsIHdhc0ZpbmlzaGVkKSB7CiAgICAgICAgICAgIGlmIChhbmltYXRpb25JZCA9PT0gc2VsZi5fX2lzQW5pbWF0aW5nKSB7CiAgICAgICAgICAgICAgc2VsZi5fX2lzQW5pbWF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNlbGYuX19kaWREZWNlbGVyYXRpb25Db21wbGV0ZSB8fCB3YXNGaW5pc2hlZCkgewogICAgICAgICAgICAgIHNlbGYuX19zY3JvbGxpbmdDb21wbGV0ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLnpvb21pbmcpIHsKICAgICAgICAgICAgICBzZWxmLl9fY29tcHV0ZVNjcm9sbE1heCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIFdoZW4gY29udGludWluZyBiYXNlZCBvbiBwcmV2aW91cyBhbmltYXRpb24gd2UgY2hvb3NlIGFuIGVhc2Utb3V0IGFuaW1hdGlvbiBpbnN0ZWFkIG9mIGVhc2UtaW4tb3V0CiAgICAgICAgICBzZWxmLl9faXNBbmltYXRpbmcgPSB6eW5nYUNvcmUuZWZmZWN0LkFuaW1hdGUuc3RhcnQoc3RlcCwgdmVyaWZ5LCBjb21wbGV0ZWQsIHNlbGYub3B0aW9ucy5hbmltYXRpb25EdXJhdGlvbiwgd2FzQW5pbWF0aW5nID8gZWFzZU91dEN1YmljIDogZWFzZUluT3V0Q3ViaWMpOwoKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgIHNlbGYuX19zY2hlZHVsZWRMZWZ0ID0gc2VsZi5fX3Njcm9sbExlZnQgPSBsZWZ0OwogICAgICAgICAgc2VsZi5fX3NjaGVkdWxlZFRvcCA9IHNlbGYuX19zY3JvbGxUb3AgPSB0b3A7CiAgICAgICAgICBzZWxmLl9fc2NoZWR1bGVkWm9vbSA9IHNlbGYuX196b29tTGV2ZWwgPSB6b29tOwoKICAgICAgICAgIC8vIFB1c2ggdmFsdWVzIG91dAogICAgICAgICAgaWYgKHNlbGYuX19jYWxsYmFjaykgewogICAgICAgICAgICBzZWxmLl9fY2FsbGJhY2sobGVmdCwgdG9wLCB6b29tLCB3YXNSZXNpemUpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEZpeCBtYXggc2Nyb2xsIHJhbmdlcwogICAgICAgICAgaWYgKHNlbGYub3B0aW9ucy56b29taW5nKSB7CiAgICAgICAgICAgIHNlbGYuX19jb21wdXRlU2Nyb2xsTWF4KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBSZWNvbXB1dGVzIHNjcm9sbCBtaW5pbXVtIHZhbHVlcyBiYXNlZCBvbiBjbGllbnQgZGltZW5zaW9ucyBhbmQgY29udGVudCBkaW1lbnNpb25zLgogICAgICAgKi8KICAgICAgX19jb21wdXRlU2Nyb2xsTWF4OiBmdW5jdGlvbih6b29tTGV2ZWwpIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBpZiAoem9vbUxldmVsID09IG51bGwpIHsKICAgICAgICAgIHpvb21MZXZlbCA9IHNlbGYuX196b29tTGV2ZWw7CiAgICAgICAgfQoKICAgICAgICBzZWxmLl9fbWF4U2Nyb2xsTGVmdCA9IE1hdGgubWF4KChzZWxmLl9fY29udGVudFdpZHRoICogem9vbUxldmVsKSAtIHNlbGYuX19jbGllbnRXaWR0aCwgMCk7CiAgICAgICAgc2VsZi5fX21heFNjcm9sbFRvcCA9IE1hdGgubWF4KChzZWxmLl9fY29udGVudEhlaWdodCAqIHpvb21MZXZlbCkgLSBzZWxmLl9fY2xpZW50SGVpZ2h0LCAwKTsKCiAgICAgICAgaWYoIXNlbGYuX19kaWRXYWl0Rm9yU2l6ZSAmJiAhc2VsZi5fX21heFNjcm9sbExlZnQgJiYgIXNlbGYuX19tYXhTY3JvbGxUb3ApIHsKICAgICAgICAgIHNlbGYuX19kaWRXYWl0Rm9yU2l6ZSA9IHRydWU7CiAgICAgICAgICBzZWxmLl9fd2FpdEZvclNpemUoKTsKICAgICAgICB9CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIElmIHRoZSBzY3JvbGwgdmlldyBpc24ndCBzaXplZCBjb3JyZWN0bHkgb24gc3RhcnQsIHdhaXQgdW50aWwgd2UgaGF2ZSBhdCBsZWFzdCBzb21lIHNpemUKICAgICAgICovCiAgICAgIF9fd2FpdEZvclNpemU6IGZ1bmN0aW9uKCkgewoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIGNsZWFyVGltZW91dChzZWxmLl9fc2l6ZXJUaW1lb3V0KTsKCiAgICAgICAgdmFyIHNpemVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBzZWxmLnJlc2l6ZSgpOwoKICAgICAgICAgIGlmKChzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nWCAmJiAhc2VsZi5fX21heFNjcm9sbExlZnQpIHx8IChzZWxmLm9wdGlvbnMuc2Nyb2xsaW5nWSAmJiAhc2VsZi5fX21heFNjcm9sbFRvcCkpIHsKICAgICAgICAgICAgLy9zZWxmLl9fc2l6ZXJUaW1lb3V0ID0gc2V0VGltZW91dChzaXplciwgMTAwMCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgc2l6ZXIoKTsKICAgICAgICBzZWxmLl9fc2l6ZXJUaW1lb3V0ID0gc2V0VGltZW91dChzaXplciwgMTAwMCk7CiAgICAgIH0sCgogICAgICAvKgogICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICBBTklNQVRJT04gKERFQ0VMRVJBVElPTikgU1VQUE9SVAogICAgICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIENhbGxlZCB3aGVuIGEgdG91Y2ggc2VxdWVuY2UgZW5kIGFuZCB0aGUgc3BlZWQgb2YgdGhlIGZpbmdlciB3YXMgaGlnaCBlbm91Z2gKICAgICAgICogdG8gc3dpdGNoIGludG8gZGVjZWxlcmF0aW9uIG1vZGUuCiAgICAgICAqLwogICAgICBfX3N0YXJ0RGVjZWxlcmF0aW9uOiBmdW5jdGlvbih0aW1lU3RhbXApIHsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICBpZiAoc2VsZi5vcHRpb25zLnBhZ2luZykgewoKICAgICAgICAgIHZhciBzY3JvbGxMZWZ0ID0gTWF0aC5tYXgoTWF0aC5taW4oc2VsZi5fX3Njcm9sbExlZnQsIHNlbGYuX19tYXhTY3JvbGxMZWZ0KSwgMCk7CiAgICAgICAgICB2YXIgc2Nyb2xsVG9wID0gTWF0aC5tYXgoTWF0aC5taW4oc2VsZi5fX3Njcm9sbFRvcCwgc2VsZi5fX21heFNjcm9sbFRvcCksIDApOwogICAgICAgICAgdmFyIGNsaWVudFdpZHRoID0gc2VsZi5fX2NsaWVudFdpZHRoOwogICAgICAgICAgdmFyIGNsaWVudEhlaWdodCA9IHNlbGYuX19jbGllbnRIZWlnaHQ7CgogICAgICAgICAgLy8gV2UgbGltaXQgZGVjZWxlcmF0aW9uIG5vdCB0byB0aGUgbWluL21heCB2YWx1ZXMgb2YgdGhlIGFsbG93ZWQgcmFuZ2UsIGJ1dCB0byB0aGUgc2l6ZSBvZiB0aGUgdmlzaWJsZSBjbGllbnQgYXJlYS4KICAgICAgICAgIC8vIEVhY2ggcGFnZSBzaG91bGQgaGF2ZSBleGFjdGx5IHRoZSBzaXplIG9mIHRoZSBjbGllbnQgYXJlYS4KICAgICAgICAgIHNlbGYuX19taW5EZWNlbGVyYXRpb25TY3JvbGxMZWZ0ID0gTWF0aC5mbG9vcihzY3JvbGxMZWZ0IC8gY2xpZW50V2lkdGgpICogY2xpZW50V2lkdGg7CiAgICAgICAgICBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsVG9wID0gTWF0aC5mbG9vcihzY3JvbGxUb3AgLyBjbGllbnRIZWlnaHQpICogY2xpZW50SGVpZ2h0OwogICAgICAgICAgc2VsZi5fX21heERlY2VsZXJhdGlvblNjcm9sbExlZnQgPSBNYXRoLmNlaWwoc2Nyb2xsTGVmdCAvIGNsaWVudFdpZHRoKSAqIGNsaWVudFdpZHRoOwogICAgICAgICAgc2VsZi5fX21heERlY2VsZXJhdGlvblNjcm9sbFRvcCA9IE1hdGguY2VpbChzY3JvbGxUb3AgLyBjbGllbnRIZWlnaHQpICogY2xpZW50SGVpZ2h0OwoKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgIHNlbGYuX19taW5EZWNlbGVyYXRpb25TY3JvbGxMZWZ0ID0gMDsKICAgICAgICAgIHNlbGYuX19taW5EZWNlbGVyYXRpb25TY3JvbGxUb3AgPSAwOwogICAgICAgICAgc2VsZi5fX21heERlY2VsZXJhdGlvblNjcm9sbExlZnQgPSBzZWxmLl9fbWF4U2Nyb2xsTGVmdDsKICAgICAgICAgIHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxUb3AgPSBzZWxmLl9fbWF4U2Nyb2xsVG9wOwoKICAgICAgICB9CgogICAgICAgIC8vIFdyYXAgY2xhc3MgbWV0aG9kCiAgICAgICAgdmFyIHN0ZXAgPSBmdW5jdGlvbihwZXJjZW50LCBub3csIHJlbmRlcikgewogICAgICAgICAgc2VsZi5fX3N0ZXBUaHJvdWdoRGVjZWxlcmF0aW9uKHJlbmRlcik7CiAgICAgICAgfTsKCiAgICAgICAgLy8gSG93IG11Y2ggdmVsb2NpdHkgaXMgcmVxdWlyZWQgdG8ga2VlcCB0aGUgZGVjZWxlcmF0aW9uIHJ1bm5pbmcKICAgICAgICBzZWxmLl9fbWluVmVsb2NpdHlUb0tlZXBEZWNlbGVyYXRpbmcgPSBzZWxmLm9wdGlvbnMuc25hcHBpbmcgPyA0IDogMC4xOwoKICAgICAgICAvLyBEZXRlY3Qgd2hldGhlciBpdCdzIHN0aWxsIHdvcnRoIHRvIGNvbnRpbnVlIGFuaW1hdGluZyBzdGVwcwogICAgICAgIC8vIElmIHdlIGFyZSBhbHJlYWR5IHNsb3cgZW5vdWdoIHRvIG5vdCBiZWluZyB1c2VyIHBlcmNlaXZhYmxlIGFueW1vcmUsIHdlIHN0b3AgdGhlIHdob2xlIHByb2Nlc3MgaGVyZS4KICAgICAgICB2YXIgdmVyaWZ5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgc2hvdWxkQ29udGludWUgPSBNYXRoLmFicyhzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYKSA+PSBzZWxmLl9fbWluVmVsb2NpdHlUb0tlZXBEZWNlbGVyYXRpbmcgfHwKICAgICAgICAgICAgTWF0aC5hYnMoc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSkgPj0gc2VsZi5fX21pblZlbG9jaXR5VG9LZWVwRGVjZWxlcmF0aW5nOwogICAgICAgICAgaWYgKCFzaG91bGRDb250aW51ZSkgewogICAgICAgICAgICBzZWxmLl9fZGlkRGVjZWxlcmF0aW9uQ29tcGxldGUgPSB0cnVlOwoKICAgICAgICAgICAgLy9NYWtlIHN1cmUgdGhlIHNjcm9sbCB2YWx1ZXMgYXJlIHdpdGhpbiB0aGUgYm91bmRhcmllcyBhZnRlciBhIGJvdW5jZSwKICAgICAgICAgICAgLy9ub3QgYmVsb3cgMCBvciBhYm92ZSBtYXhpbXVtCiAgICAgICAgICAgIGlmIChzZWxmLm9wdGlvbnMuYm91bmNpbmcpIHsKICAgICAgICAgICAgICBzZWxmLnNjcm9sbFRvKAogICAgICAgICAgICAgICAgTWF0aC5taW4oIE1hdGgubWF4KHNlbGYuX19zY3JvbGxMZWZ0LCAwKSwgc2VsZi5fX21heFNjcm9sbExlZnQgKSwKICAgICAgICAgICAgICAgIE1hdGgubWluKCBNYXRoLm1heChzZWxmLl9fc2Nyb2xsVG9wLCAwKSwgc2VsZi5fX21heFNjcm9sbFRvcCApLAogICAgICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2hvdWxkQ29udGludWU7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIGNvbXBsZXRlZCA9IGZ1bmN0aW9uKHJlbmRlcmVkRnJhbWVzUGVyU2Vjb25kLCBhbmltYXRpb25JZCwgd2FzRmluaXNoZWQpIHsKICAgICAgICAgIHNlbGYuX19pc0RlY2VsZXJhdGluZyA9IGZhbHNlOwogICAgICAgICAgaWYgKHNlbGYuX19kaWREZWNlbGVyYXRpb25Db21wbGV0ZSkgewogICAgICAgICAgICBzZWxmLl9fc2Nyb2xsaW5nQ29tcGxldGUoKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBBbmltYXRlIHRvIGdyaWQgd2hlbiBzbmFwcGluZyBpcyBhY3RpdmUsIG90aGVyd2lzZSBqdXN0IGZpeCBvdXQtb2YtYm91bmRhcnkgcG9zaXRpb25zCiAgICAgICAgICBpZihzZWxmLm9wdGlvbnMucGFnaW5nKSB7CiAgICAgICAgICAgIHNlbGYuc2Nyb2xsVG8oc2VsZi5fX3Njcm9sbExlZnQsIHNlbGYuX19zY3JvbGxUb3AsIHNlbGYub3B0aW9ucy5zbmFwcGluZyk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gU3RhcnQgYW5pbWF0aW9uIGFuZCBzd2l0Y2ggb24gZmxhZwogICAgICAgIHNlbGYuX19pc0RlY2VsZXJhdGluZyA9IHp5bmdhQ29yZS5lZmZlY3QuQW5pbWF0ZS5zdGFydChzdGVwLCB2ZXJpZnksIGNvbXBsZXRlZCk7CgogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBDYWxsZWQgb24gZXZlcnkgc3RlcCBvZiB0aGUgYW5pbWF0aW9uCiAgICAgICAqCiAgICAgICAqIEBwYXJhbSBpbk1lbW9yeSB7Qm9vbGVhbn0gV2hldGhlciB0byBub3QgcmVuZGVyIHRoZSBjdXJyZW50IHN0ZXAsIGJ1dCBrZWVwIGl0IGluIG1lbW9yeSBvbmx5LiBVc2VkIGludGVybmFsbHkgb25seSEKICAgICAgICovCiAgICAgIF9fc3RlcFRocm91Z2hEZWNlbGVyYXRpb246IGZ1bmN0aW9uKHJlbmRlcikgewoKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgoKICAgICAgICAvLwogICAgICAgIC8vIENPTVBVVEUgTkVYVCBTQ1JPTEwgUE9TSVRJT04KICAgICAgICAvLwoKICAgICAgICAvLyBBZGQgZGVjZWxlcmF0aW9uIHRvIHNjcm9sbCBwb3NpdGlvbgogICAgICAgIHZhciBzY3JvbGxMZWZ0ID0gc2VsZi5fX3Njcm9sbExlZnQgKyBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYOy8vICogc2VsZi5vcHRpb25zLmRlY2VsZXJhdGlvbik7CiAgICAgICAgdmFyIHNjcm9sbFRvcCA9IHNlbGYuX19zY3JvbGxUb3AgKyBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZOy8vICogc2VsZi5vcHRpb25zLmRlY2VsZXJhdGlvbik7CgoKICAgICAgICAvLwogICAgICAgIC8vIEhBUkQgTElNSVQgU0NST0xMIFBPU0lUSU9OIEZPUiBOT04gQk9VTkNJTkcgTU9ERQogICAgICAgIC8vCgogICAgICAgIGlmICghc2VsZi5vcHRpb25zLmJvdW5jaW5nKSB7CgogICAgICAgICAgdmFyIHNjcm9sbExlZnRGaXhlZCA9IE1hdGgubWF4KE1hdGgubWluKHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxMZWZ0LCBzY3JvbGxMZWZ0KSwgc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbExlZnQpOwogICAgICAgICAgaWYgKHNjcm9sbExlZnRGaXhlZCAhPT0gc2Nyb2xsTGVmdCkgewogICAgICAgICAgICBzY3JvbGxMZWZ0ID0gc2Nyb2xsTGVmdEZpeGVkOwogICAgICAgICAgICBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYID0gMDsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgc2Nyb2xsVG9wRml4ZWQgPSBNYXRoLm1heChNYXRoLm1pbihzZWxmLl9fbWF4RGVjZWxlcmF0aW9uU2Nyb2xsVG9wLCBzY3JvbGxUb3ApLCBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsVG9wKTsKICAgICAgICAgIGlmIChzY3JvbGxUb3BGaXhlZCAhPT0gc2Nyb2xsVG9wKSB7CiAgICAgICAgICAgIHNjcm9sbFRvcCA9IHNjcm9sbFRvcEZpeGVkOwogICAgICAgICAgICBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZID0gMDsKICAgICAgICAgIH0KCiAgICAgICAgfQoKCiAgICAgICAgLy8KICAgICAgICAvLyBVUERBVEUgU0NST0xMIFBPU0lUSU9OCiAgICAgICAgLy8KCiAgICAgICAgaWYgKHJlbmRlcikgewoKICAgICAgICAgIHNlbGYuX19wdWJsaXNoKHNjcm9sbExlZnQsIHNjcm9sbFRvcCwgc2VsZi5fX3pvb21MZXZlbCk7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgc2VsZi5fX3Njcm9sbExlZnQgPSBzY3JvbGxMZWZ0OwogICAgICAgICAgc2VsZi5fX3Njcm9sbFRvcCA9IHNjcm9sbFRvcDsKCiAgICAgICAgfQoKCiAgICAgICAgLy8KICAgICAgICAvLyBTTE9XIERPV04KICAgICAgICAvLwoKICAgICAgICAvLyBTbG93IGRvd24gdmVsb2NpdHkgb24gZXZlcnkgaXRlcmF0aW9uCiAgICAgICAgaWYgKCFzZWxmLm9wdGlvbnMucGFnaW5nKSB7CgogICAgICAgICAgLy8gVGhpcyBpcyB0aGUgZmFjdG9yIGFwcGxpZWQgdG8gZXZlcnkgaXRlcmF0aW9uIG9mIHRoZSBhbmltYXRpb24KICAgICAgICAgIC8vIHRvIHNsb3cgZG93biB0aGUgcHJvY2Vzcy4gVGhpcyBzaG91bGQgZW11bGF0ZSBuYXR1cmFsIGJlaGF2aW9yIHdoZXJlCiAgICAgICAgICAvLyBvYmplY3RzIHNsb3cgZG93biB3aGVuIHRoZSBpbml0aWF0b3Igb2YgdGhlIG1vdmVtZW50IGlzIHJlbW92ZWQKICAgICAgICAgIHZhciBmcmljdGlvbkZhY3RvciA9IHNlbGYub3B0aW9ucy5kZWNlbGVyYXRpb247CgogICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WCAqPSBmcmljdGlvbkZhY3RvcjsKICAgICAgICAgIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVkgKj0gZnJpY3Rpb25GYWN0b3I7CgogICAgICAgIH0KCgogICAgICAgIC8vCiAgICAgICAgLy8gQk9VTkNJTkcgU1VQUE9SVAogICAgICAgIC8vCgogICAgICAgIGlmIChzZWxmLm9wdGlvbnMuYm91bmNpbmcpIHsKCiAgICAgICAgICB2YXIgc2Nyb2xsT3V0c2lkZVggPSAwOwogICAgICAgICAgdmFyIHNjcm9sbE91dHNpZGVZID0gMDsKCiAgICAgICAgICAvLyBUaGlzIGNvbmZpZ3VyZXMgdGhlIGFtb3VudCBvZiBjaGFuZ2UgYXBwbGllZCB0byBkZWNlbGVyYXRpb24vYWNjZWxlcmF0aW9uIHdoZW4gcmVhY2hpbmcgYm91bmRhcmllcwogICAgICAgICAgdmFyIHBlbmV0cmF0aW9uRGVjZWxlcmF0aW9uID0gc2VsZi5vcHRpb25zLnBlbmV0cmF0aW9uRGVjZWxlcmF0aW9uOwogICAgICAgICAgdmFyIHBlbmV0cmF0aW9uQWNjZWxlcmF0aW9uID0gc2VsZi5vcHRpb25zLnBlbmV0cmF0aW9uQWNjZWxlcmF0aW9uOwoKICAgICAgICAgIC8vIENoZWNrIGxpbWl0cwogICAgICAgICAgaWYgKHNjcm9sbExlZnQgPCBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsTGVmdCkgewogICAgICAgICAgICBzY3JvbGxPdXRzaWRlWCA9IHNlbGYuX19taW5EZWNlbGVyYXRpb25TY3JvbGxMZWZ0IC0gc2Nyb2xsTGVmdDsKICAgICAgICAgIH0gZWxzZSBpZiAoc2Nyb2xsTGVmdCA+IHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxMZWZ0KSB7CiAgICAgICAgICAgIHNjcm9sbE91dHNpZGVYID0gc2VsZi5fX21heERlY2VsZXJhdGlvblNjcm9sbExlZnQgLSBzY3JvbGxMZWZ0OwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChzY3JvbGxUb3AgPCBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsVG9wKSB7CiAgICAgICAgICAgIHNjcm9sbE91dHNpZGVZID0gc2VsZi5fX21pbkRlY2VsZXJhdGlvblNjcm9sbFRvcCAtIHNjcm9sbFRvcDsKICAgICAgICAgIH0gZWxzZSBpZiAoc2Nyb2xsVG9wID4gc2VsZi5fX21heERlY2VsZXJhdGlvblNjcm9sbFRvcCkgewogICAgICAgICAgICBzY3JvbGxPdXRzaWRlWSA9IHNlbGYuX19tYXhEZWNlbGVyYXRpb25TY3JvbGxUb3AgLSBzY3JvbGxUb3A7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU2xvdyBkb3duIHVudGlsIHNsb3cgZW5vdWdoLCB0aGVuIGZsaXAgYmFjayB0byBzbmFwIHBvc2l0aW9uCiAgICAgICAgICBpZiAoc2Nyb2xsT3V0c2lkZVggIT09IDApIHsKICAgICAgICAgICAgdmFyIGlzSGVhZGluZ091dHdhcmRzWCA9IHNjcm9sbE91dHNpZGVYICogc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WCA8PSBzZWxmLl9fbWluRGVjZWxlcmF0aW9uU2Nyb2xsTGVmdDsKICAgICAgICAgICAgaWYgKGlzSGVhZGluZ091dHdhcmRzWCkgewogICAgICAgICAgICAgIHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVggKz0gc2Nyb2xsT3V0c2lkZVggKiBwZW5ldHJhdGlvbkRlY2VsZXJhdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaXNTdG9wcGVkWCA9IE1hdGguYWJzKHNlbGYuX19kZWNlbGVyYXRpb25WZWxvY2l0eVgpIDw9IHNlbGYuX19taW5WZWxvY2l0eVRvS2VlcERlY2VsZXJhdGluZzsKICAgICAgICAgICAgLy9JZiB3ZSdyZSBub3QgaGVhZGluZyBvdXR3YXJkcywgb3IgaWYgdGhlIGFib3ZlIHN0YXRlbWVudCBnb3QgdXMgYmVsb3cgbWluRGVjZWxlcmF0aW9uLCBnbyBiYWNrIHRvd2FyZHMgYm91bmRzCiAgICAgICAgICAgIGlmICghaXNIZWFkaW5nT3V0d2FyZHNYIHx8IGlzU3RvcHBlZFgpIHsKICAgICAgICAgICAgICBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlYID0gc2Nyb2xsT3V0c2lkZVggKiBwZW5ldHJhdGlvbkFjY2VsZXJhdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmIChzY3JvbGxPdXRzaWRlWSAhPT0gMCkgewogICAgICAgICAgICB2YXIgaXNIZWFkaW5nT3V0d2FyZHNZID0gc2Nyb2xsT3V0c2lkZVkgKiBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZIDw9IHNlbGYuX19taW5EZWNlbGVyYXRpb25TY3JvbGxUb3A7CiAgICAgICAgICAgIGlmIChpc0hlYWRpbmdPdXR3YXJkc1kpIHsKICAgICAgICAgICAgICBzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZICs9IHNjcm9sbE91dHNpZGVZICogcGVuZXRyYXRpb25EZWNlbGVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlzU3RvcHBlZFkgPSBNYXRoLmFicyhzZWxmLl9fZGVjZWxlcmF0aW9uVmVsb2NpdHlZKSA8PSBzZWxmLl9fbWluVmVsb2NpdHlUb0tlZXBEZWNlbGVyYXRpbmc7CiAgICAgICAgICAgIC8vSWYgd2UncmUgbm90IGhlYWRpbmcgb3V0d2FyZHMsIG9yIGlmIHRoZSBhYm92ZSBzdGF0ZW1lbnQgZ290IHVzIGJlbG93IG1pbkRlY2VsZXJhdGlvbiwgZ28gYmFjayB0b3dhcmRzIGJvdW5kcwogICAgICAgICAgICBpZiAoIWlzSGVhZGluZ091dHdhcmRzWSB8fCBpc1N0b3BwZWRZKSB7CiAgICAgICAgICAgICAgc2VsZi5fX2RlY2VsZXJhdGlvblZlbG9jaXR5WSA9IHNjcm9sbE91dHNpZGVZICogcGVuZXRyYXRpb25BY2NlbGVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCgoKICAgICAgLyoqCiAgICAgICAqIGNhbGN1bGF0ZSB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0d28gdG91Y2hlcwogICAgICAgKiBAcGFyYW0gICB7VG91Y2h9ICAgICB0b3VjaDEKICAgICAgICogQHBhcmFtICAge1RvdWNofSAgICAgdG91Y2gyCiAgICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9ICAgIGRpc3RhbmNlCiAgICAgICAqLwogICAgICBfX2dldERpc3RhbmNlOiBmdW5jdGlvbiBnZXREaXN0YW5jZSh0b3VjaDEsIHRvdWNoMikgewogICAgICAgIHZhciB4ID0gdG91Y2gyLnBhZ2VYIC0gdG91Y2gxLnBhZ2VYLAogICAgICAgICAgeSA9IHRvdWNoMi5wYWdlWSAtIHRvdWNoMS5wYWdlWTsKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KCh4KngpICsgKHkqeSkpOwogICAgICB9LAoKCiAgICAgIC8qKgogICAgICAgKiBjYWxjdWxhdGUgdGhlIHNjYWxlIGZhY3RvciBiZXR3ZWVuIHR3byB0b3VjaExpc3RzIChmaW5nZXJzKQogICAgICAgKiBubyBzY2FsZSBpcyAxLCBhbmQgZ29lcyBkb3duIHRvIDAgd2hlbiBwaW5jaGVkIHRvZ2V0aGVyLCBhbmQgYmlnZ2VyIHdoZW4gcGluY2hlZCBvdXQKICAgICAgICogQHBhcmFtICAge0FycmF5fSAgICAgc3RhcnQKICAgICAgICogQHBhcmFtICAge0FycmF5fSAgICAgZW5kCiAgICAgICAqIEByZXR1cm5zIHtOdW1iZXJ9ICAgIHNjYWxlCiAgICAgICAqLwogICAgICBfX2dldFNjYWxlOiBmdW5jdGlvbiBnZXRTY2FsZShzdGFydCwgZW5kKSB7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgLy8gbmVlZCB0d28gZmluZ2Vycy4uLgogICAgICAgIGlmKHN0YXJ0Lmxlbmd0aCA+PSAyICYmIGVuZC5sZW5ndGggPj0gMikgewogICAgICAgICAgcmV0dXJuIHNlbGYuX19nZXREaXN0YW5jZShlbmRbMF0sIGVuZFsxXSkgLwogICAgICAgICAgICBzZWxmLl9fZ2V0RGlzdGFuY2Uoc3RhcnRbMF0sIHN0YXJ0WzFdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDE7CiAgICAgIH0KICAgIH0pOwoKICAgIGlvbmljLnNjcm9sbCA9IHsKICAgICAgaXNTY3JvbGxpbmc6IGZhbHNlLAogICAgICBsYXN0VG9wOiAwCiAgICB9OwoKICB9KShpb25pYyk7CgogIChmdW5jdGlvbihpb25pYykgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGlvbmljLnZpZXdzLkhlYWRlckJhciA9IGlvbmljLnZpZXdzLlZpZXcuaW5oZXJpdCh7CiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgICB0aGlzLmVsID0gb3B0cy5lbDsKCiAgICAgICAgaW9uaWMuZXh0ZW5kKHRoaXMsIHsKICAgICAgICAgIGFsaWduVGl0bGU6ICdjZW50ZXInCiAgICAgICAgfSwgb3B0cyk7CgogICAgICAgIHRoaXMuYWxpZ24oKTsKICAgICAgfSwKCiAgICAgIGFsaWduOiBmdW5jdGlvbihhbGlnbikgewoKICAgICAgICBhbGlnbiB8fCAoYWxpZ24gPSB0aGlzLmFsaWduVGl0bGUpOwoKICAgICAgICAvLyBGaW5kIHRoZSB0aXRsZUVsIGVsZW1lbnQKICAgICAgICB2YXIgdGl0bGVFbCA9IHRoaXMuZWwucXVlcnlTZWxlY3RvcignLnRpdGxlJyk7CiAgICAgICAgaWYoIXRpdGxlRWwpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAvL1dlIGhhdmUgdG8gckFGIGhlcmUgc28gYWxsIG9mIHRoZSBlbGVtZW50cyBoYXZlIHRpbWUgdG8gaW5pdGlhbGl6ZQogICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBpLCBjLCBjaGlsZFNpemU7CiAgICAgICAgICB2YXIgY2hpbGROb2RlcyA9IHNlbGYuZWwuY2hpbGROb2RlczsKICAgICAgICAgIHZhciBsZWZ0V2lkdGggPSAwOwogICAgICAgICAgdmFyIHJpZ2h0V2lkdGggPSAwOwogICAgICAgICAgdmFyIGlzQ291bnRpbmdSaWdodFdpZHRoID0gZmFsc2U7CgogICAgICAgICAgLy8gQ29tcHV0ZSBob3cgd2lkZSB0aGUgbGVmdCBjaGlsZHJlbiBhcmUKICAgICAgICAgIC8vIFNraXAgYWxsIHRpdGxlcyAodGhlcmUgbWF5IHN0aWxsIGJlIHR3byB0aXRsZXMsIG9uZSBsZWF2aW5nIHRoZSBkb20pCiAgICAgICAgICAvLyBPbmNlIHdlIGVuY291bnRlciBhIHRpdGxlRWwsIHJlYWxpemUgd2UgYXJlIG5vdyBjb3VudGluZyB0aGUgcmlnaHQtYnV0dG9ucywgbm90IGxlZnQKICAgICAgICAgIGZvcihpID0gMDsgaSA8IGNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYyA9IGNoaWxkTm9kZXNbaV07CiAgICAgICAgICAgIGlmIChjLnRhZ05hbWUgJiYgYy50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT0gJ2gxJykgewogICAgICAgICAgICAgIGlzQ291bnRpbmdSaWdodFdpZHRoID0gdHJ1ZTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2hpbGRTaXplID0gbnVsbDsKICAgICAgICAgICAgaWYoYy5ub2RlVHlwZSA9PSAzKSB7CiAgICAgICAgICAgICAgdmFyIGJvdW5kcyA9IGlvbmljLkRvbVV0aWwuZ2V0VGV4dEJvdW5kcyhjKTsKICAgICAgICAgICAgICBpZihib3VuZHMpIHsKICAgICAgICAgICAgICAgIGNoaWxkU2l6ZSA9IGJvdW5kcy53aWR0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZihjLm5vZGVUeXBlID09IDEpIHsKICAgICAgICAgICAgICBjaGlsZFNpemUgPSBjLm9mZnNldFdpZHRoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGNoaWxkU2l6ZSkgewogICAgICAgICAgICAgIGlmIChpc0NvdW50aW5nUmlnaHRXaWR0aCkgewogICAgICAgICAgICAgICAgcmlnaHRXaWR0aCArPSBjaGlsZFNpemU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxlZnRXaWR0aCArPSBjaGlsZFNpemU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgdmFyIG1hcmdpbiA9IE1hdGgubWF4KGxlZnRXaWR0aCwgcmlnaHRXaWR0aCkgKyAxMDsKCiAgICAgICAgICAvL1Jlc2V0IGxlZnQgYW5kIHJpZ2h0IGJlZm9yZSBzZXR0aW5nIGFnYWluCiAgICAgICAgICB0aXRsZUVsLnN0eWxlLmxlZnQgPSB0aXRsZUVsLnN0eWxlLnJpZ2h0ID0gJyc7CgogICAgICAgICAgLy8gU2l6ZSBhbmQgYWxpZ24gdGhlIGhlYWRlciB0aXRsZUVsIGJhc2VkIG9uIHRoZSBzaXplcyBvZiB0aGUgbGVmdCBhbmQKICAgICAgICAgIC8vIHJpZ2h0IGNoaWxkcmVuLCBhbmQgdGhlIGRlc2lyZWQgYWxpZ25tZW50IG1vZGUKICAgICAgICAgIGlmKGFsaWduID09ICdjZW50ZXInKSB7CiAgICAgICAgICAgIGlmKG1hcmdpbiA+IDEwKSB7CiAgICAgICAgICAgICAgdGl0bGVFbC5zdHlsZS5sZWZ0ID0gbWFyZ2luICsgJ3B4JzsKICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLnJpZ2h0ID0gbWFyZ2luICsgJ3B4JzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZih0aXRsZUVsLm9mZnNldFdpZHRoIDwgdGl0bGVFbC5zY3JvbGxXaWR0aCkgewogICAgICAgICAgICAgIGlmKHJpZ2h0V2lkdGggPiAwKSB7CiAgICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLnJpZ2h0ID0gKHJpZ2h0V2lkdGggKyA1KSArICdweCc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYoYWxpZ24gPT0gJ2xlZnQnKSB7CiAgICAgICAgICAgIHRpdGxlRWwuY2xhc3NMaXN0LmFkZCgndGl0bGUtbGVmdCcpOwogICAgICAgICAgICBpZihsZWZ0V2lkdGggPiAwKSB7CiAgICAgICAgICAgICAgdGl0bGVFbC5zdHlsZS5sZWZ0ID0gKGxlZnRXaWR0aCArIDE1KSArICdweCc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZihhbGlnbiA9PSAncmlnaHQnKSB7CiAgICAgICAgICAgIHRpdGxlRWwuY2xhc3NMaXN0LmFkZCgndGl0bGUtcmlnaHQnKTsKICAgICAgICAgICAgaWYocmlnaHRXaWR0aCA+IDApIHsKICAgICAgICAgICAgICB0aXRsZUVsLnN0eWxlLnJpZ2h0ID0gKHJpZ2h0V2lkdGggKyAxNSkgKyAncHgnOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwoKICB9KShpb25pYyk7CgogIChmdW5jdGlvbihpb25pYykgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIHZhciBJVEVNX0NMQVNTID0gJ2l0ZW0nOwogICAgdmFyIElURU1fQ09OVEVOVF9DTEFTUyA9ICdpdGVtLWNvbnRlbnQnOwogICAgdmFyIElURU1fU0xJRElOR19DTEFTUyA9ICdpdGVtLXNsaWRpbmcnOwogICAgdmFyIElURU1fT1BUSU9OU19DTEFTUyA9ICdpdGVtLW9wdGlvbnMnOwogICAgdmFyIElURU1fUExBQ0VIT0xERVJfQ0xBU1MgPSAnaXRlbS1wbGFjZWhvbGRlcic7CiAgICB2YXIgSVRFTV9SRU9SREVSSU5HX0NMQVNTID0gJ2l0ZW0tcmVvcmRlcmluZyc7CiAgICB2YXIgSVRFTV9SRU9SREVSX0JUTl9DTEFTUyA9ICdpdGVtLXJlb3JkZXInOwoKICAgIHZhciBEcmFnT3AgPSBmdW5jdGlvbigpIHt9OwogICAgRHJhZ09wLnByb3RvdHlwZSA9IHsKICAgICAgc3RhcnQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgfSwKICAgICAgZHJhZzogZnVuY3Rpb24oZSkgewogICAgICB9LAogICAgICBlbmQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgfSwKICAgICAgaXNTYW1lSXRlbTogZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfTsKCiAgICB2YXIgU2xpZGVEcmFnID0gZnVuY3Rpb24ob3B0cykgewogICAgICB0aGlzLmRyYWdUaHJlc2hvbGRYID0gb3B0cy5kcmFnVGhyZXNob2xkWCB8fCAxMDsKICAgICAgdGhpcy5lbCA9IG9wdHMuZWw7CiAgICAgIHRoaXMuY2FuU3dpcGUgPSBvcHRzLmNhblN3aXBlOwogICAgfTsKCiAgICBTbGlkZURyYWcucHJvdG90eXBlID0gbmV3IERyYWdPcCgpOwoKICAgIFNsaWRlRHJhZy5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBjb250ZW50LCBidXR0b25zLCBvZmZzZXRYLCBidXR0b25zV2lkdGg7CgogICAgICBpZiAoIXRoaXMuY2FuU3dpcGUoKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYoZS50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKElURU1fQ09OVEVOVF9DTEFTUykpIHsKICAgICAgICBjb250ZW50ID0gZS50YXJnZXQ7CiAgICAgIH0gZWxzZSBpZihlLnRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoSVRFTV9DTEFTUykpIHsKICAgICAgICBjb250ZW50ID0gZS50YXJnZXQucXVlcnlTZWxlY3RvcignLicgKyBJVEVNX0NPTlRFTlRfQ0xBU1MpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnRlbnQgPSBpb25pYy5Eb21VdGlsLmdldFBhcmVudFdpdGhDbGFzcyhlLnRhcmdldCwgSVRFTV9DT05URU5UX0NMQVNTKTsKICAgICAgfQoKICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSBhIGNvbnRlbnQgYXJlYSBhcyBvbmUgb2Ygb3VyIGNoaWxkcmVuIChvciBvdXJzZWx2ZXMpLCBza2lwCiAgICAgIGlmKCFjb250ZW50KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBNYWtlIHN1cmUgd2UgYXJlbid0IGFuaW1hdGluZyBhcyB3ZSBzbGlkZQogICAgICBjb250ZW50LmNsYXNzTGlzdC5yZW1vdmUoSVRFTV9TTElESU5HX0NMQVNTKTsKCiAgICAgIC8vIEdyYWIgdGhlIHN0YXJ0aW5nIFggcG9pbnQgZm9yIHRoZSBpdGVtIChmb3IgZXhhbXBsZSwgc28gd2UgY2FuIHRlbGwgd2hldGhlciBpdCBpcyBvcGVuIG9yIGNsb3NlZCB0byBzdGFydCkKICAgICAgb2Zmc2V0WCA9IHBhcnNlRmxvYXQoY29udGVudC5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXS5yZXBsYWNlKCd0cmFuc2xhdGUzZCgnLCAnJykuc3BsaXQoJywnKVswXSkgfHwgMDsKCiAgICAgIC8vIEdyYWIgdGhlIGJ1dHRvbnMKICAgICAgYnV0dG9ucyA9IGNvbnRlbnQucGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yKCcuJyArIElURU1fT1BUSU9OU19DTEFTUyk7CiAgICAgIGlmKCFidXR0b25zKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGJ1dHRvbnMuY2xhc3NMaXN0LnJlbW92ZSgnaW52aXNpYmxlJyk7CgogICAgICBidXR0b25zV2lkdGggPSBidXR0b25zLm9mZnNldFdpZHRoOwoKICAgICAgdGhpcy5fY3VycmVudERyYWcgPSB7CiAgICAgICAgYnV0dG9uczogYnV0dG9ucywKICAgICAgICBidXR0b25zV2lkdGg6IGJ1dHRvbnNXaWR0aCwKICAgICAgICBjb250ZW50OiBjb250ZW50LAogICAgICAgIHN0YXJ0T2Zmc2V0WDogb2Zmc2V0WAogICAgICB9OwogICAgfTsKCiAgICAvKioKICAgICAqIENoZWNrIGlmIHRoaXMgaXMgdGhlIHNhbWUgaXRlbSB0aGF0IHdhcyBwcmV2aW91c2x5IGRyYWdnZWQuCiAgICAgKi8KICAgIFNsaWRlRHJhZy5wcm90b3R5cGUuaXNTYW1lSXRlbSA9IGZ1bmN0aW9uKG9wKSB7CiAgICAgIGlmKG9wLl9sYXN0RHJhZyAmJiB0aGlzLl9jdXJyZW50RHJhZykgewogICAgICAgIHJldHVybiB0aGlzLl9jdXJyZW50RHJhZy5jb250ZW50ID09IG9wLl9sYXN0RHJhZy5jb250ZW50OwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH07CgogICAgU2xpZGVEcmFnLnByb3RvdHlwZS5jbGVhbiA9IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGxhc3REcmFnID0gdGhpcy5fbGFzdERyYWc7CgogICAgICBpZighbGFzdERyYWcpIHJldHVybjsKCiAgICAgIGxhc3REcmFnLmNvbnRlbnQuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TSVRJT05dID0gJyc7CiAgICAgIGxhc3REcmFnLmNvbnRlbnQuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAnJzsKICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICBsYXN0RHJhZy5idXR0b25zICYmIGxhc3REcmFnLmJ1dHRvbnMuY2xhc3NMaXN0LmFkZCgnaW52aXNpYmxlJyk7CiAgICAgICAgfSwgMjUwKTsKICAgICAgfSk7CiAgICB9OwoKICAgIFNsaWRlRHJhZy5wcm90b3R5cGUuZHJhZyA9IGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoZnVuY3Rpb24oZSkgewogICAgICB2YXIgYnV0dG9uc1dpZHRoOwoKICAgICAgLy8gV2UgcmVhbGx5IGFyZW4ndCBkcmFnZ2luZwogICAgICBpZighdGhpcy5fY3VycmVudERyYWcpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIENoZWNrIGlmIHdlIHNob3VsZCBzdGFydCBkcmFnZ2luZy4gQ2hlY2sgaWYgd2UndmUgZHJhZ2dlZCBwYXN0IHRoZSB0aHJlc2hvbGQsCiAgICAgIC8vIG9yIHdlIGFyZSBzdGFydGluZyBmcm9tIHRoZSBvcGVuIHN0YXRlLgogICAgICBpZighdGhpcy5faXNEcmFnZ2luZyAmJgogICAgICAgICgoTWF0aC5hYnMoZS5nZXN0dXJlLmRlbHRhWCkgPiB0aGlzLmRyYWdUaHJlc2hvbGRYKSB8fAogICAgICAgICAgKE1hdGguYWJzKHRoaXMuX2N1cnJlbnREcmFnLnN0YXJ0T2Zmc2V0WCkgPiAwKSkpCiAgICAgIHsKICAgICAgICB0aGlzLl9pc0RyYWdnaW5nID0gdHJ1ZTsKICAgICAgfQoKICAgICAgaWYodGhpcy5faXNEcmFnZ2luZykgewogICAgICAgIGJ1dHRvbnNXaWR0aCA9IHRoaXMuX2N1cnJlbnREcmFnLmJ1dHRvbnNXaWR0aDsKCiAgICAgICAgLy8gR3JhYiB0aGUgbmV3IFggcG9pbnQsIGNhcHBpbmcgaXQgYXQgemVybwogICAgICAgIHZhciBuZXdYID0gTWF0aC5taW4oMCwgdGhpcy5fY3VycmVudERyYWcuc3RhcnRPZmZzZXRYICsgZS5nZXN0dXJlLmRlbHRhWCk7CgogICAgICAgIC8vIElmIHRoZSBuZXcgWCBwb3NpdGlvbiBpcyBwYXN0IHRoZSBidXR0b25zLCB3ZSBuZWVkIHRvIHNsb3cgZG93biB0aGUgZHJhZyAocnViYmVyIGJhbmQgc3R5bGUpCiAgICAgICAgaWYobmV3WCA8IC1idXR0b25zV2lkdGgpIHsKICAgICAgICAgIC8vIENhbGN1bGF0ZSB0aGUgbmV3IFggcG9zaXRpb24sIGNhcHBlZCBhdCB0aGUgdG9wIG9mIHRoZSBidXR0b25zCiAgICAgICAgICBuZXdYID0gTWF0aC5taW4oLWJ1dHRvbnNXaWR0aCwgLWJ1dHRvbnNXaWR0aCArICgoKGUuZ2VzdHVyZS5kZWx0YVggKyBidXR0b25zV2lkdGgpICogMC40KSkpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fY3VycmVudERyYWcuY29udGVudC5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICd0cmFuc2xhdGUzZCgnICsgbmV3WCArICdweCwgMCwgMCknOwogICAgICAgIHRoaXMuX2N1cnJlbnREcmFnLmNvbnRlbnQuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TSVRJT05dID0gJ25vbmUnOwogICAgICB9CiAgICB9KTsKCiAgICBTbGlkZURyYWcucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uKGUsIGRvbmVDYWxsYmFjaykgewogICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgLy8gVGhlcmUgaXMgbm8gZHJhZywganVzdCBlbmQgaW1tZWRpYXRlbHkKICAgICAgaWYoIXRoaXMuX2N1cnJlbnREcmFnKSB7CiAgICAgICAgZG9uZUNhbGxiYWNrICYmIGRvbmVDYWxsYmFjaygpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gSWYgd2UgYXJlIGN1cnJlbnRseSBkcmFnZ2luZywgd2Ugd2FudCB0byBzbmFwIGJhY2sgaW50byBwbGFjZQogICAgICAvLyBUaGUgZmluYWwgcmVzdGluZyBwb2ludCBYIHdpbGwgYmUgdGhlIHdpZHRoIG9mIHRoZSBleHBvc2VkIGJ1dHRvbnMKICAgICAgdmFyIHJlc3RpbmdQb2ludCA9IC10aGlzLl9jdXJyZW50RHJhZy5idXR0b25zV2lkdGg7CgogICAgICAvLyBDaGVjayBpZiB0aGUgZHJhZyBkaWRuJ3QgY2xlYXIgdGhlIGJ1dHRvbnMgbWlkLXBvaW50CiAgICAgIC8vIGFuZCB3ZSBhcmVuJ3QgbW92aW5nIGZhc3QgZW5vdWdoIHRvIHN3aXBlIG9wZW4KICAgICAgaWYoZS5nZXN0dXJlLmRlbHRhWCA+IC0odGhpcy5fY3VycmVudERyYWcuYnV0dG9uc1dpZHRoLzIpKSB7CgogICAgICAgIC8vIElmIHdlIGFyZSBnb2luZyBsZWZ0IGJ1dCB0b28gc2xvdywgb3IgZ29pbmcgcmlnaHQsIGdvIGJhY2sgdG8gcmVzdGluZwogICAgICAgIGlmKGUuZ2VzdHVyZS5kaXJlY3Rpb24gPT0gImxlZnQiICYmIE1hdGguYWJzKGUuZ2VzdHVyZS52ZWxvY2l0eVgpIDwgMC4zKSB7CiAgICAgICAgICByZXN0aW5nUG9pbnQgPSAwOwogICAgICAgIH0gZWxzZSBpZihlLmdlc3R1cmUuZGlyZWN0aW9uID09ICJyaWdodCIpIHsKICAgICAgICAgIHJlc3RpbmdQb2ludCA9IDA7CiAgICAgICAgfQoKICAgICAgfQoKICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgIGlmKHJlc3RpbmdQb2ludCA9PT0gMCkgewogICAgICAgICAgX3RoaXMuX2N1cnJlbnREcmFnLmNvbnRlbnQuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gPSAnJzsKICAgICAgICAgIHZhciBidXR0b25zID0gX3RoaXMuX2N1cnJlbnREcmFnLmJ1dHRvbnM7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBidXR0b25zICYmIGJ1dHRvbnMuY2xhc3NMaXN0LmFkZCgnaW52aXNpYmxlJyk7CiAgICAgICAgICB9LCAyNTApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBfdGhpcy5fY3VycmVudERyYWcuY29udGVudC5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICd0cmFuc2xhdGUzZCgnICsgcmVzdGluZ1BvaW50ICsgJ3B4LCAwLCAwKSc7CiAgICAgICAgfQogICAgICAgIF90aGlzLl9jdXJyZW50RHJhZy5jb250ZW50LnN0eWxlW2lvbmljLkNTUy5UUkFOU0lUSU9OXSA9ICcnOwoKCiAgICAgICAgLy8gS2lsbCB0aGUgY3VycmVudCBkcmFnCiAgICAgICAgX3RoaXMuX2xhc3REcmFnID0gX3RoaXMuX2N1cnJlbnREcmFnOwogICAgICAgIF90aGlzLl9jdXJyZW50RHJhZyA9IG51bGw7CgogICAgICAgIC8vIFdlIGFyZSBkb25lLCBub3RpZnkgY2FsbGVyCiAgICAgICAgZG9uZUNhbGxiYWNrICYmIGRvbmVDYWxsYmFjaygpOwogICAgICB9KTsKICAgIH07CgogICAgdmFyIFJlb3JkZXJEcmFnID0gZnVuY3Rpb24ob3B0cykgewogICAgICB0aGlzLmRyYWdUaHJlc2hvbGRZID0gb3B0cy5kcmFnVGhyZXNob2xkWSB8fCAwOwogICAgICB0aGlzLm9uUmVvcmRlciA9IG9wdHMub25SZW9yZGVyOwogICAgICB0aGlzLmxpc3RFbCA9IG9wdHMubGlzdEVsOwogICAgICB0aGlzLmVsID0gb3B0cy5lbDsKICAgICAgdGhpcy5zY3JvbGxFbCA9IG9wdHMuc2Nyb2xsRWw7CiAgICAgIHRoaXMuc2Nyb2xsVmlldyA9IG9wdHMuc2Nyb2xsVmlldzsKICAgICAgLy8gR2V0IHRoZSBUcnVlIFRvcCBvZiB0aGUgbGlzdCBlbCBodHRwOi8vd3d3LnF1aXJrc21vZGUub3JnL2pzL2ZpbmRwb3MuaHRtbAogICAgICB0aGlzLmxpc3RFbFRydWVUb3AgPSAwOwogICAgICBpZiAodGhpcy5saXN0RWwub2Zmc2V0UGFyZW50KSB7CiAgICAgICAgdmFyIG9iaiA9IHRoaXMubGlzdEVsOwogICAgICAgIGRvIHsKICAgICAgICAgIHRoaXMubGlzdEVsVHJ1ZVRvcCArPSBvYmoub2Zmc2V0VG9wOwogICAgICAgICAgb2JqID0gb2JqLm9mZnNldFBhcmVudDsKICAgICAgICB9IHdoaWxlIChvYmopOwogICAgICB9CiAgICB9OwoKICAgIFJlb3JkZXJEcmFnLnByb3RvdHlwZSA9IG5ldyBEcmFnT3AoKTsKCiAgICBSZW9yZGVyRHJhZy5wcm90b3R5cGUuX21vdmVFbGVtZW50ID0gZnVuY3Rpb24oZSkgewogICAgICB2YXIgeSA9IGUuZ2VzdHVyZS5jZW50ZXIucGFnZVkgKwogICAgICAgIHRoaXMuc2Nyb2xsVmlldy5nZXRWYWx1ZXMoKS50b3AgLQogICAgICAgICh0aGlzLl9jdXJyZW50RHJhZy5lbGVtZW50SGVpZ2h0IC8gMikgLQogICAgICAgIHRoaXMubGlzdEVsVHJ1ZVRvcDsKICAgICAgdGhpcy5lbC5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICd0cmFuc2xhdGUzZCgwLCAnK3krJ3B4LCAwKSc7CiAgICB9OwoKICAgIFJlb3JkZXJEcmFnLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGNvbnRlbnQ7CgogICAgICB2YXIgc3RhcnRJbmRleCA9IGlvbmljLkRvbVV0aWwuZ2V0Q2hpbGRJbmRleCh0aGlzLmVsLCB0aGlzLmVsLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICB2YXIgZWxlbWVudEhlaWdodCA9IHRoaXMuZWwuc2Nyb2xsSGVpZ2h0OwogICAgICB2YXIgcGxhY2Vob2xkZXIgPSB0aGlzLmVsLmNsb25lTm9kZSh0cnVlKTsKCiAgICAgIHBsYWNlaG9sZGVyLmNsYXNzTGlzdC5hZGQoSVRFTV9QTEFDRUhPTERFUl9DTEFTUyk7CgogICAgICB0aGlzLmVsLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHBsYWNlaG9sZGVyLCB0aGlzLmVsKTsKICAgICAgdGhpcy5lbC5jbGFzc0xpc3QuYWRkKElURU1fUkVPUkRFUklOR19DTEFTUyk7CgogICAgICB0aGlzLl9jdXJyZW50RHJhZyA9IHsKICAgICAgICBlbGVtZW50SGVpZ2h0OiBlbGVtZW50SGVpZ2h0LAogICAgICAgIHN0YXJ0SW5kZXg6IHN0YXJ0SW5kZXgsCiAgICAgICAgcGxhY2Vob2xkZXI6IHBsYWNlaG9sZGVyLAogICAgICAgIHNjcm9sbEhlaWdodDogc2Nyb2xsLAogICAgICAgIGxpc3Q6IHBsYWNlaG9sZGVyLnBhcmVudE5vZGUKICAgICAgfTsKCiAgICAgIHRoaXMuX21vdmVFbGVtZW50KGUpOwogICAgfTsKCiAgICBSZW9yZGVyRHJhZy5wcm90b3R5cGUuZHJhZyA9IGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoZnVuY3Rpb24oZSkgewogICAgICAvLyBXZSByZWFsbHkgYXJlbid0IGRyYWdnaW5nCiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgaWYoIXRoaXMuX2N1cnJlbnREcmFnKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgc2Nyb2xsWSA9IDA7CiAgICAgIHZhciBwYWdlWSA9IGUuZ2VzdHVyZS5jZW50ZXIucGFnZVk7CiAgICAgIHZhciBvZmZzZXQgPSB0aGlzLmxpc3RFbFRydWVUb3A7CgogICAgICAvL0lmIHdlIGhhdmUgYSBzY3JvbGxWaWV3LCBjaGVjayBzY3JvbGwgYm91bmRhcmllcyBmb3IgZHJhZ2dlZCBlbGVtZW50IGFuZCBzY3JvbGwgaWYgbmVjZXNzYXJ5CiAgICAgIGlmICh0aGlzLnNjcm9sbFZpZXcpIHsKCiAgICAgICAgdmFyIGNvbnRhaW5lciA9IHRoaXMuc2Nyb2xsVmlldy5fX2NvbnRhaW5lcjsKICAgICAgICBzY3JvbGxZID0gdGhpcy5zY3JvbGxWaWV3LmdldFZhbHVlcygpLnRvcDsKCiAgICAgICAgdmFyIGNvbnRhaW5lclRvcCA9IGNvbnRhaW5lci5vZmZzZXRUb3A7CiAgICAgICAgdmFyIHBpeGVsc1Bhc3RUb3AgPSBjb250YWluZXJUb3AgLSBwYWdlWSArIHRoaXMuX2N1cnJlbnREcmFnLmVsZW1lbnRIZWlnaHQvMjsKICAgICAgICB2YXIgcGl4ZWxzUGFzdEJvdHRvbSA9IHBhZ2VZICsgdGhpcy5fY3VycmVudERyYWcuZWxlbWVudEhlaWdodC8yIC0gY29udGFpbmVyVG9wIC0gY29udGFpbmVyLm9mZnNldEhlaWdodDsKCiAgICAgICAgaWYgKGUuZ2VzdHVyZS5kZWx0YVkgPCAwICYmIHBpeGVsc1Bhc3RUb3AgPiAwICYmIHNjcm9sbFkgPiAwKSB7CiAgICAgICAgICB0aGlzLnNjcm9sbFZpZXcuc2Nyb2xsQnkobnVsbCwgLXBpeGVsc1Bhc3RUb3ApOwogICAgICAgICAgLy9UcmlnZ2VyIGFub3RoZXIgZHJhZyBzbyB0aGUgc2Nyb2xsaW5nIGtlZXBzIGdvaW5nCiAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNlbGYuZHJhZyhlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoZS5nZXN0dXJlLmRlbHRhWSA+IDAgJiYgcGl4ZWxzUGFzdEJvdHRvbSA+IDApIHsKICAgICAgICAgIGlmIChzY3JvbGxZIDwgdGhpcy5zY3JvbGxWaWV3LmdldFNjcm9sbE1heCgpLnRvcCkgewogICAgICAgICAgICB0aGlzLnNjcm9sbFZpZXcuc2Nyb2xsQnkobnVsbCwgcGl4ZWxzUGFzdEJvdHRvbSk7CiAgICAgICAgICAgIC8vVHJpZ2dlciBhbm90aGVyIGRyYWcgc28gdGhlIHNjcm9sbGluZyBrZWVwcyBnb2luZwogICAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgc2VsZi5kcmFnKGUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIENoZWNrIGlmIHdlIHNob3VsZCBzdGFydCBkcmFnZ2luZy4gQ2hlY2sgaWYgd2UndmUgZHJhZ2dlZCBwYXN0IHRoZSB0aHJlc2hvbGQsCiAgICAgIC8vIG9yIHdlIGFyZSBzdGFydGluZyBmcm9tIHRoZSBvcGVuIHN0YXRlLgogICAgICBpZighdGhpcy5faXNEcmFnZ2luZyAmJiBNYXRoLmFicyhlLmdlc3R1cmUuZGVsdGFZKSA+IHRoaXMuZHJhZ1RocmVzaG9sZFkpIHsKICAgICAgICB0aGlzLl9pc0RyYWdnaW5nID0gdHJ1ZTsKICAgICAgfQoKICAgICAgaWYodGhpcy5faXNEcmFnZ2luZykgewogICAgICAgIHRoaXMuX21vdmVFbGVtZW50KGUpOwoKICAgICAgICB0aGlzLl9jdXJyZW50RHJhZy5jdXJyZW50WSA9IHNjcm9sbFkgKyBwYWdlWSAtIG9mZnNldDsKCiAgICAgICAgLy8gdGhpcy5fcmVvcmRlckl0ZW1zKCk7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIFdoZW4gYW4gaXRlbSBpcyBkcmFnZ2VkLCB3ZSBuZWVkIHRvIHJlb3JkZXIgYW55IGl0ZW1zIGZvciBzb3J0aW5nIHB1cnBvc2VzCiAgICBSZW9yZGVyRHJhZy5wcm90b3R5cGUuX2dldFJlb3JkZXJJbmRleCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBwbGFjZWhvbGRlciA9IHRoaXMuX2N1cnJlbnREcmFnLnBsYWNlaG9sZGVyOwogICAgICB2YXIgc2libGluZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzLl9jdXJyZW50RHJhZy5wbGFjZWhvbGRlci5wYXJlbnROb2RlLmNoaWxkcmVuKQogICAgICAgIC5maWx0ZXIoZnVuY3Rpb24oZWwpIHsKICAgICAgICAgIHJldHVybiBlbC5ub2RlTmFtZSA9PT0gc2VsZi5lbC5ub2RlTmFtZSAmJiBlbCAhPT0gc2VsZi5lbDsKICAgICAgICB9KTsKCiAgICAgIHZhciBkcmFnT2Zmc2V0VG9wID0gdGhpcy5fY3VycmVudERyYWcuY3VycmVudFk7CiAgICAgIHZhciBlbDsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHNpYmxpbmdzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgZWwgPSBzaWJsaW5nc1tpXTsKICAgICAgICBpZiAoaSA9PT0gbGVuIC0gMSkgewogICAgICAgICAgaWYgKGRyYWdPZmZzZXRUb3AgPiBlbC5vZmZzZXRUb3ApIHsKICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChpID09PSAwKSB7CiAgICAgICAgICBpZiAoZHJhZ09mZnNldFRvcCA8IGVsLm9mZnNldFRvcCArIGVsLm9mZnNldEhlaWdodCkgewogICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGRyYWdPZmZzZXRUb3AgPiBlbC5vZmZzZXRUb3AgLSBlbC5vZmZzZXRIZWlnaHQgLyAyICYmCiAgICAgICAgICBkcmFnT2Zmc2V0VG9wIDwgZWwub2Zmc2V0VG9wICsgZWwub2Zmc2V0SGVpZ2h0ICogMS41KSB7CiAgICAgICAgICByZXR1cm4gaTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX2N1cnJlbnREcmFnLnN0YXJ0SW5kZXg7CiAgICB9OwoKICAgIFJlb3JkZXJEcmFnLnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbihlLCBkb25lQ2FsbGJhY2spIHsKICAgICAgaWYoIXRoaXMuX2N1cnJlbnREcmFnKSB7CiAgICAgICAgZG9uZUNhbGxiYWNrICYmIGRvbmVDYWxsYmFjaygpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHBsYWNlaG9sZGVyID0gdGhpcy5fY3VycmVudERyYWcucGxhY2Vob2xkZXI7CiAgICAgIHZhciBmaW5hbEluZGV4ID0gdGhpcy5fZ2V0UmVvcmRlckluZGV4KCk7CgogICAgICAvLyBSZXBvc2l0aW9uIHRoZSBlbGVtZW50CiAgICAgIHRoaXMuZWwuY2xhc3NMaXN0LnJlbW92ZShJVEVNX1JFT1JERVJJTkdfQ0xBU1MpOwogICAgICB0aGlzLmVsLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJyc7CgogICAgICBwbGFjZWhvbGRlci5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0aGlzLmVsLCBwbGFjZWhvbGRlcik7CiAgICAgIHBsYWNlaG9sZGVyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocGxhY2Vob2xkZXIpOwoKICAgICAgdGhpcy5vblJlb3JkZXIgJiYgdGhpcy5vblJlb3JkZXIodGhpcy5lbCwgdGhpcy5fY3VycmVudERyYWcuc3RhcnRJbmRleCwgZmluYWxJbmRleCk7CgogICAgICB0aGlzLl9jdXJyZW50RHJhZyA9IG51bGw7CiAgICAgIGRvbmVDYWxsYmFjayAmJiBkb25lQ2FsbGJhY2soKTsKICAgIH07CgoKCiAgICAvKioKICAgICAqIFRoZSBMaXN0VmlldyBoYW5kbGVzIGEgbGlzdCBvZiBpdGVtcy4gSXQgd2lsbCBwcm9jZXNzIGRyYWcgYW5pbWF0aW9ucywgZWRpdCBtb2RlLAogICAgICogYW5kIG90aGVyIG9wZXJhdGlvbnMgdGhhdCBhcmUgY29tbW9uIG9uIG1vYmlsZSBsaXN0cyBvciB0YWJsZSB2aWV3cy4KICAgICAqLwogICAgaW9uaWMudmlld3MuTGlzdFZpZXcgPSBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQoewogICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgb3B0cyA9IGlvbmljLmV4dGVuZCh7CiAgICAgICAgICBvblJlb3JkZXI6IGZ1bmN0aW9uKGVsLCBvbGRJbmRleCwgbmV3SW5kZXgpIHt9LAogICAgICAgICAgdmlydHVhbFJlbW92ZVRocmVzaG9sZDogLTIwMCwKICAgICAgICAgIHZpcnR1YWxBZGRUaHJlc2hvbGQ6IDIwMCwKICAgICAgICAgIGNhblN3aXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfSwgb3B0cyk7CgogICAgICAgIGlvbmljLmV4dGVuZCh0aGlzLCBvcHRzKTsKCiAgICAgICAgaWYoIXRoaXMuaXRlbUhlaWdodCAmJiB0aGlzLmxpc3RFbCkgewogICAgICAgICAgdGhpcy5pdGVtSGVpZ2h0ID0gdGhpcy5saXN0RWwuY2hpbGRyZW5bMF0gJiYgcGFyc2VJbnQodGhpcy5saXN0RWwuY2hpbGRyZW5bMF0uc3R5bGUuaGVpZ2h0LCAxMCk7CiAgICAgICAgfQoKICAgICAgICAvL2lvbmljLnZpZXdzLkxpc3RWaWV3Ll9fc3VwZXJfXy5pbml0aWFsaXplLmNhbGwodGhpcywgb3B0cyk7CgogICAgICAgIHRoaXMub25SZWZyZXNoID0gb3B0cy5vblJlZnJlc2ggfHwgZnVuY3Rpb24oKSB7fTsKICAgICAgICB0aGlzLm9uUmVmcmVzaE9wZW5pbmcgPSBvcHRzLm9uUmVmcmVzaE9wZW5pbmcgfHwgZnVuY3Rpb24oKSB7fTsKICAgICAgICB0aGlzLm9uUmVmcmVzaEhvbGRpbmcgPSBvcHRzLm9uUmVmcmVzaEhvbGRpbmcgfHwgZnVuY3Rpb24oKSB7fTsKCiAgICAgICAgd2luZG93LmlvbmljLm9uR2VzdHVyZSgncmVsZWFzZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIF90aGlzLl9oYW5kbGVFbmREcmFnKGUpOwogICAgICAgIH0sIHRoaXMuZWwpOwoKICAgICAgICB3aW5kb3cuaW9uaWMub25HZXN0dXJlKCdkcmFnJywgZnVuY3Rpb24oZSkgewogICAgICAgICAgX3RoaXMuX2hhbmRsZURyYWcoZSk7CiAgICAgICAgfSwgdGhpcy5lbCk7CiAgICAgICAgLy8gU3RhcnQgdGhlIGRyYWcgc3RhdGVzCiAgICAgICAgdGhpcy5faW5pdERyYWcoKTsKICAgICAgfSwKICAgICAgLyoqCiAgICAgICAqIENhbGxlZCB0byB0ZWxsIHRoZSBsaXN0IHRvIHN0b3AgcmVmcmVzaGluZy4gVGhpcyBpcyB1c2VmdWwKICAgICAgICogaWYgeW91IGFyZSByZWZyZXNoaW5nIHRoZSBsaXN0IGFuZCBhcmUgZG9uZSB3aXRoIHJlZnJlc2hpbmcuCiAgICAgICAqLwogICAgICBzdG9wUmVmcmVzaGluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlZnJlc2hlciA9IHRoaXMuZWwucXVlcnlTZWxlY3RvcignLmxpc3QtcmVmcmVzaGVyJyk7CiAgICAgICAgcmVmcmVzaGVyLnN0eWxlLmhlaWdodCA9ICcwcHgnOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIElmIHdlIHNjcm9sbGVkIGFuZCBoYXZlIHZpcnR1YWwgbW9kZSBlbmFibGVkLCBjb21wdXRlIHRoZSB3aW5kb3cKICAgICAgICogb2YgYWN0aXZlIGVsZW1lbnRzIGluIG9yZGVyIHRvIGZpZ3VyZSBvdXQgdGhlIHZpZXdwb3J0IHRvIHJlbmRlci4KICAgICAgICovCiAgICAgIGRpZFNjcm9sbDogZnVuY3Rpb24oZSkgewogICAgICAgIGlmKHRoaXMuaXNWaXJ0dWFsKSB7CiAgICAgICAgICB2YXIgaXRlbUhlaWdodCA9IHRoaXMuaXRlbUhlaWdodDsKCiAgICAgICAgICAvLyBUT0RPOiBUaGlzIHdvdWxkIGJlIGluYWNjdXJhdGUgaWYgd2UgYXJlIHdpbmRvd2VkCiAgICAgICAgICB2YXIgdG90YWxJdGVtcyA9IHRoaXMubGlzdEVsLmNoaWxkcmVuLmxlbmd0aDsKCiAgICAgICAgICAvLyBHcmFiIHRoZSB0b3RhbCBoZWlnaHQgb2YgdGhlIGxpc3QKICAgICAgICAgIHZhciBzY3JvbGxIZWlnaHQgPSBlLnRhcmdldC5zY3JvbGxIZWlnaHQ7CgogICAgICAgICAgLy8gR2V0IHRoZSB2aWV3cG9ydCBoZWlnaHQKICAgICAgICAgIHZhciB2aWV3cG9ydEhlaWdodCA9IHRoaXMuZWwucGFyZW50Tm9kZS5vZmZzZXRIZWlnaHQ7CgogICAgICAgICAgLy8gc2Nyb2xsVG9wIGlzIHRoZSBjdXJyZW50IHNjcm9sbCBwb3NpdGlvbgogICAgICAgICAgdmFyIHNjcm9sbFRvcCA9IGUuc2Nyb2xsVG9wOwoKICAgICAgICAgIC8vIEhpZ2ggd2F0ZXIgaXMgdGhlIHBpeGVsIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBlbGVtZW50IHRvIGluY2x1ZGUgKGV2ZXJ5dGhpbmcgYmVmb3JlCiAgICAgICAgICAvLyB0aGF0IHdpbGwgYmUgcmVtb3ZlZCkKICAgICAgICAgIHZhciBoaWdoV2F0ZXIgPSBNYXRoLm1heCgwLCBlLnNjcm9sbFRvcCArIHRoaXMudmlydHVhbFJlbW92ZVRocmVzaG9sZCk7CgogICAgICAgICAgLy8gTG93IHdhdGVyIGlzIHRoZSBwaXhlbCBwb3NpdGlvbiBvZiB0aGUgbGFzdCBlbGVtZW50IHRvIGluY2x1ZGUgKGV2ZXJ5dGhpbmcgYWZ0ZXIKICAgICAgICAgIC8vIHRoYXQgd2lsbCBiZSByZW1vdmVkKQogICAgICAgICAgdmFyIGxvd1dhdGVyID0gTWF0aC5taW4oc2Nyb2xsSGVpZ2h0LCBNYXRoLmFicyhlLnNjcm9sbFRvcCkgKyB2aWV3cG9ydEhlaWdodCArIHRoaXMudmlydHVhbEFkZFRocmVzaG9sZCk7CgogICAgICAgICAgLy8gQ29tcHV0ZSBob3cgbWFueSBpdGVtcyBwZXIgdmlld3BvcnQgc2l6ZSBjYW4gc2hvdwogICAgICAgICAgdmFyIGl0ZW1zUGVyVmlld3BvcnQgPSBNYXRoLmZsb29yKChsb3dXYXRlciAtIGhpZ2hXYXRlcikgLyBpdGVtSGVpZ2h0KTsKCiAgICAgICAgICAvLyBHZXQgdGhlIGZpcnN0IGFuZCBsYXN0IGVsZW1lbnRzIGluIHRoZSBsaXN0IGJhc2VkIG9uIGhvdyBtYW55IGNhbiBmaXQKICAgICAgICAgIC8vIGJldHdlZW4gdGhlIHBpeGVsIHJhbmdlIG9mIGxvd1dhdGVyIGFuZCBoaWdoV2F0ZXIKICAgICAgICAgIHZhciBmaXJzdCA9IHBhcnNlSW50KE1hdGguYWJzKGhpZ2hXYXRlciAvIGl0ZW1IZWlnaHQpLCAxMCk7CiAgICAgICAgICB2YXIgbGFzdCA9IHBhcnNlSW50KE1hdGguYWJzKGxvd1dhdGVyIC8gaXRlbUhlaWdodCksIDEwKTsKCiAgICAgICAgICAvLyBHZXQgdGhlIGl0ZW1zIHdlIG5lZWQgdG8gcmVtb3ZlCiAgICAgICAgICB0aGlzLl92aXJ0dWFsSXRlbXNUb1JlbW92ZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHRoaXMubGlzdEVsLmNoaWxkcmVuLCAwLCBmaXJzdCk7CgogICAgICAgICAgLy8gR3JhYiB0aGUgbm9kZXMgd2Ugd2lsbCBiZSBzaG93aW5nCiAgICAgICAgICB2YXIgbm9kZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzLmxpc3RFbC5jaGlsZHJlbiwgZmlyc3QsIGZpcnN0ICsgaXRlbXNQZXJWaWV3cG9ydCk7CgogICAgICAgICAgdGhpcy5yZW5kZXJWaWV3cG9ydCAmJiB0aGlzLnJlbmRlclZpZXdwb3J0KGhpZ2hXYXRlciwgbG93V2F0ZXIsIGZpcnN0LCBsYXN0KTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBkaWRTdG9wU2Nyb2xsaW5nOiBmdW5jdGlvbihlKSB7CiAgICAgICAgaWYodGhpcy5pc1ZpcnR1YWwpIHsKICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCB0aGlzLl92aXJ0dWFsSXRlbXNUb1JlbW92ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgZWwgPSB0aGlzLl92aXJ0dWFsSXRlbXNUb1JlbW92ZVtpXTsKICAgICAgICAgICAgLy9lbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGVsKTsKICAgICAgICAgICAgdGhpcy5kaWRIaWRlSXRlbSAmJiB0aGlzLmRpZEhpZGVJdGVtKGkpOwogICAgICAgICAgfQogICAgICAgICAgLy8gT25jZSBzY3JvbGxpbmcgc3RvcHMsIGNoZWNrIGlmIHdlIG5lZWQgdG8gcmVtb3ZlIG9sZCBpdGVtcwoKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQ2xlYXIgYW55IGFjdGl2ZSBkcmFnIGVmZmVjdHMgb24gdGhlIGxpc3QuCiAgICAgICAqLwogICAgICBjbGVhckRyYWdFZmZlY3RzOiBmdW5jdGlvbigpIHsKICAgICAgICBpZih0aGlzLl9sYXN0RHJhZ09wKSB7CiAgICAgICAgICB0aGlzLl9sYXN0RHJhZ09wLmNsZWFuICYmIHRoaXMuX2xhc3REcmFnT3AuY2xlYW4oKTsKICAgICAgICAgIHRoaXMuX2xhc3REcmFnT3AgPSBudWxsOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIF9pbml0RHJhZzogZnVuY3Rpb24oKSB7CiAgICAgICAgLy9pb25pYy52aWV3cy5MaXN0Vmlldy5fX3N1cGVyX18uX2luaXREcmFnLmNhbGwodGhpcyk7CgogICAgICAgIC8vIFN0b3JlIHRoZSBsYXN0IG9uZQogICAgICAgIHRoaXMuX2xhc3REcmFnT3AgPSB0aGlzLl9kcmFnT3A7CgogICAgICAgIHRoaXMuX2RyYWdPcCA9IG51bGw7CiAgICAgIH0sCgogICAgICAvLyBSZXR1cm4gdGhlIGxpc3QgaXRlbSBmcm9tIHRoZSBnaXZlbiB0YXJnZXQKICAgICAgX2dldEl0ZW06IGZ1bmN0aW9uKHRhcmdldCkgewogICAgICAgIHdoaWxlKHRhcmdldCkgewogICAgICAgICAgaWYodGFyZ2V0LmNsYXNzTGlzdCAmJiB0YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKElURU1fQ0xBU1MpKSB7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgICAgICB9CiAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCgoKICAgICAgX3N0YXJ0RHJhZzogZnVuY3Rpb24oZSkgewogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHZhciBkaWRTdGFydCA9IGZhbHNlOwoKICAgICAgICB0aGlzLl9pc0RyYWdnaW5nID0gZmFsc2U7CgogICAgICAgIHZhciBsYXN0RHJhZ09wID0gdGhpcy5fbGFzdERyYWdPcDsKICAgICAgICB2YXIgaXRlbTsKCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBpcyBhIHJlb3JkZXIgZHJhZwogICAgICAgIGlmKGlvbmljLkRvbVV0aWwuZ2V0UGFyZW50T3JTZWxmV2l0aENsYXNzKGUudGFyZ2V0LCBJVEVNX1JFT1JERVJfQlROX0NMQVNTKSAmJiAoZS5nZXN0dXJlLmRpcmVjdGlvbiA9PSAndXAnIHx8IGUuZ2VzdHVyZS5kaXJlY3Rpb24gPT0gJ2Rvd24nKSkgewogICAgICAgICAgaXRlbSA9IHRoaXMuX2dldEl0ZW0oZS50YXJnZXQpOwoKICAgICAgICAgIGlmKGl0ZW0pIHsKICAgICAgICAgICAgdGhpcy5fZHJhZ09wID0gbmV3IFJlb3JkZXJEcmFnKHsKICAgICAgICAgICAgICBsaXN0RWw6IHRoaXMuZWwsCiAgICAgICAgICAgICAgZWw6IGl0ZW0sCiAgICAgICAgICAgICAgc2Nyb2xsRWw6IHRoaXMuc2Nyb2xsRWwsCiAgICAgICAgICAgICAgc2Nyb2xsVmlldzogdGhpcy5zY3JvbGxWaWV3LAogICAgICAgICAgICAgIG9uUmVvcmRlcjogZnVuY3Rpb24oZWwsIHN0YXJ0LCBlbmQpIHsKICAgICAgICAgICAgICAgIF90aGlzLm9uUmVvcmRlciAmJiBfdGhpcy5vblJlb3JkZXIoZWwsIHN0YXJ0LCBlbmQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX2RyYWdPcC5zdGFydChlKTsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gT3IgY2hlY2sgaWYgdGhpcyBpcyBhIHN3aXBlIHRvIHRoZSBzaWRlIGRyYWcKICAgICAgICBlbHNlIGlmKCF0aGlzLl9kaWREcmFnVXBPckRvd24gJiYgKGUuZ2VzdHVyZS5kaXJlY3Rpb24gPT0gJ2xlZnQnIHx8IGUuZ2VzdHVyZS5kaXJlY3Rpb24gPT0gJ3JpZ2h0JykgJiYgTWF0aC5hYnMoZS5nZXN0dXJlLmRlbHRhWCkgPiA1KSB7CgogICAgICAgICAgLy8gTWFrZSBzdXJlIHRoaXMgaXMgYW4gaXRlbSB3aXRoIGJ1dHRvbnMKICAgICAgICAgIGl0ZW0gPSB0aGlzLl9nZXRJdGVtKGUudGFyZ2V0KTsKICAgICAgICAgIGlmKGl0ZW0gJiYgaXRlbS5xdWVyeVNlbGVjdG9yKCcuaXRlbS1vcHRpb25zJykpIHsKICAgICAgICAgICAgdGhpcy5fZHJhZ09wID0gbmV3IFNsaWRlRHJhZyh7IGVsOiB0aGlzLmVsLCBjYW5Td2lwZTogdGhpcy5jYW5Td2lwZSB9KTsKICAgICAgICAgICAgdGhpcy5fZHJhZ09wLnN0YXJ0KGUpOwogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB3ZSBoYWQgYSBsYXN0IGRyYWcgb3BlcmF0aW9uIGFuZCB0aGlzIGlzIGEgbmV3IG9uZSBvbiBhIGRpZmZlcmVudCBpdGVtLCBjbGVhbiB0aGF0IGxhc3Qgb25lCiAgICAgICAgaWYobGFzdERyYWdPcCAmJiB0aGlzLl9kcmFnT3AgJiYgIXRoaXMuX2RyYWdPcC5pc1NhbWVJdGVtKGxhc3REcmFnT3ApICYmIGUuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgbGFzdERyYWdPcC5jbGVhbiAmJiBsYXN0RHJhZ09wLmNsZWFuKCk7CiAgICAgICAgfQogICAgICB9LAoKCiAgICAgIF9oYW5kbGVFbmREcmFnOiBmdW5jdGlvbihlKSB7CiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgdGhpcy5fZGlkRHJhZ1VwT3JEb3duID0gZmFsc2U7CgogICAgICAgIGlmKCF0aGlzLl9kcmFnT3ApIHsKICAgICAgICAgIC8vaW9uaWMudmlld3MuTGlzdFZpZXcuX19zdXBlcl9fLl9oYW5kbGVFbmREcmFnLmNhbGwodGhpcywgZSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9kcmFnT3AuZW5kKGUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgX3RoaXMuX2luaXREcmFnKCk7CiAgICAgICAgfSk7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogUHJvY2VzcyB0aGUgZHJhZyBldmVudCB0byBtb3ZlIHRoZSBpdGVtIHRvIHRoZSBsZWZ0IG9yIHJpZ2h0LgogICAgICAgKi8KICAgICAgX2hhbmRsZURyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzLCBjb250ZW50LCBidXR0b25zOwoKICAgICAgICBpZihNYXRoLmFicyhlLmdlc3R1cmUuZGVsdGFZKSA+IDUpIHsKICAgICAgICAgIHRoaXMuX2RpZERyYWdVcE9yRG93biA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB3ZSBnZXQgYSBkcmFnIGV2ZW50LCBtYWtlIHN1cmUgd2UgYXJlbid0IGluIGFub3RoZXIgZHJhZywgdGhlbiBjaGVjayBpZiB3ZSBzaG91bGQKICAgICAgICAvLyBzdGFydCBvbmUKICAgICAgICBpZighdGhpcy5pc0RyYWdnaW5nICYmICF0aGlzLl9kcmFnT3ApIHsKICAgICAgICAgIHRoaXMuX3N0YXJ0RHJhZyhlKTsKICAgICAgICB9CgogICAgICAgIC8vIE5vIGRyYWcgc3RpbGwsIHBhc3MgaXQgdXAKICAgICAgICBpZighdGhpcy5fZHJhZ09wKSB7CiAgICAgICAgICAvL2lvbmljLnZpZXdzLkxpc3RWaWV3Ll9fc3VwZXJfXy5faGFuZGxlRHJhZy5jYWxsKHRoaXMsIGUpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZS5nZXN0dXJlLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgdGhpcy5fZHJhZ09wLmRyYWcoZSk7CiAgICAgIH0KCiAgICB9KTsKCiAgfSkoaW9uaWMpOwoKICAoZnVuY3Rpb24oaW9uaWMpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICBpb25pYy52aWV3cy5Nb2RhbCA9IGlvbmljLnZpZXdzLlZpZXcuaW5oZXJpdCh7CiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgICBvcHRzID0gaW9uaWMuZXh0ZW5kKHsKICAgICAgICAgIGZvY3VzRmlyc3RJbnB1dDogZmFsc2UsCiAgICAgICAgICB1bmZvY3VzT25IaWRlOiB0cnVlLAogICAgICAgICAgZm9jdXNGaXJzdERlbGF5OiA2MDAsCiAgICAgICAgICBiYWNrZHJvcENsaWNrVG9DbG9zZTogdHJ1ZSwKICAgICAgICAgIGhhcmR3YXJlQmFja0J1dHRvbkNsb3NlOiB0cnVlLAogICAgICAgIH0sIG9wdHMpOwoKICAgICAgICBpb25pYy5leHRlbmQodGhpcywgb3B0cyk7CgogICAgICAgIHRoaXMuZWwgPSBvcHRzLmVsOwogICAgICB9LAogICAgICBzaG93OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIGlmKHNlbGYuZm9jdXNGaXJzdElucHV0KSB7CiAgICAgICAgICAvLyBMZXQgYW55IGFuaW1hdGlvbnMgcnVuIGZpcnN0CiAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGlucHV0ID0gc2VsZi5lbC5xdWVyeVNlbGVjdG9yKCdpbnB1dCwgdGV4dGFyZWEnKTsKICAgICAgICAgICAgaW5wdXQgJiYgaW5wdXQuZm9jdXMgJiYgaW5wdXQuZm9jdXMoKTsKICAgICAgICAgIH0sIHNlbGYuZm9jdXNGaXJzdERlbGF5KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGhpZGU6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIFVuZm9jdXMgYWxsIGVsZW1lbnRzCiAgICAgICAgaWYodGhpcy51bmZvY3VzT25IaWRlKSB7CiAgICAgICAgICB2YXIgaW5wdXRzID0gdGhpcy5lbC5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dCwgdGV4dGFyZWEnKTsKICAgICAgICAgIC8vIExldCBhbnkgYW5pbWF0aW9ucyBydW4gZmlyc3QKICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgaW5wdXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaW5wdXRzW2ldLmJsdXIgJiYgaW5wdXRzW2ldLmJsdXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgfSkoaW9uaWMpOwoKICAoZnVuY3Rpb24oaW9uaWMpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICAvKioKICAgICAqIFRoZSBzaWRlIG1lbnUgdmlldyBoYW5kbGVzIG9uZSBvZiB0aGUgc2lkZSBtZW51J3MgaW4gYSBTaWRlIE1lbnUgQ29udHJvbGxlcgogICAgICogY29uZmlndXJhdGlvbi4KICAgICAqIEl0IHRha2VzIGEgRE9NIHJlZmVyZW5jZSB0byB0aGF0IHNpZGUgbWVudSBlbGVtZW50LgogICAgICovCiAgICBpb25pYy52aWV3cy5TaWRlTWVudSA9IGlvbmljLnZpZXdzLlZpZXcuaW5oZXJpdCh7CiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgICB0aGlzLmVsID0gb3B0cy5lbDsKICAgICAgICB0aGlzLmlzRW5hYmxlZCA9ICh0eXBlb2Ygb3B0cy5pc0VuYWJsZWQgPT09ICd1bmRlZmluZWQnKSA/IHRydWUgOiBvcHRzLmlzRW5hYmxlZDsKICAgICAgICB0aGlzLnNldFdpZHRoKG9wdHMud2lkdGgpOwogICAgICB9LAoKICAgICAgZ2V0RnVsbFdpZHRoOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy53aWR0aDsKICAgICAgfSwKICAgICAgc2V0V2lkdGg6IGZ1bmN0aW9uKHdpZHRoKSB7CiAgICAgICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgICAgIHRoaXMuZWwuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CiAgICAgIH0sCiAgICAgIHNldElzRW5hYmxlZDogZnVuY3Rpb24oaXNFbmFibGVkKSB7CiAgICAgICAgdGhpcy5pc0VuYWJsZWQgPSBpc0VuYWJsZWQ7CiAgICAgIH0sCiAgICAgIGJyaW5nVXA6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmKHRoaXMuZWwuc3R5bGUuekluZGV4ICE9PSAnMCcpIHsKICAgICAgICAgIHRoaXMuZWwuc3R5bGUuekluZGV4ID0gJzAnOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHVzaERvd246IGZ1bmN0aW9uKCkgewogICAgICAgIGlmKHRoaXMuZWwuc3R5bGUuekluZGV4ICE9PSAnLTEnKSB7CiAgICAgICAgICB0aGlzLmVsLnN0eWxlLnpJbmRleCA9ICctMSc7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCiAgICBpb25pYy52aWV3cy5TaWRlTWVudUNvbnRlbnQgPSBpb25pYy52aWV3cy5WaWV3LmluaGVyaXQoewogICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgaW9uaWMuZXh0ZW5kKHRoaXMsIHsKICAgICAgICAgIGFuaW1hdGlvbkNsYXNzOiAnbWVudS1hbmltYXRlZCcsCiAgICAgICAgICBvbkRyYWc6IGZ1bmN0aW9uKGUpIHt9LAogICAgICAgICAgb25FbmREcmFnOiBmdW5jdGlvbihlKSB7fSwKICAgICAgICB9LCBvcHRzKTsKCiAgICAgICAgaW9uaWMub25HZXN0dXJlKCdkcmFnJywgaW9uaWMucHJveHkodGhpcy5fb25EcmFnLCB0aGlzKSwgdGhpcy5lbCk7CiAgICAgICAgaW9uaWMub25HZXN0dXJlKCdyZWxlYXNlJywgaW9uaWMucHJveHkodGhpcy5fb25FbmREcmFnLCB0aGlzKSwgdGhpcy5lbCk7CiAgICAgIH0sCiAgICAgIF9vbkRyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB0aGlzLm9uRHJhZyAmJiB0aGlzLm9uRHJhZyhlKTsKICAgICAgfSwKICAgICAgX29uRW5kRHJhZzogZnVuY3Rpb24oZSkgewogICAgICAgIHRoaXMub25FbmREcmFnICYmIHRoaXMub25FbmREcmFnKGUpOwogICAgICB9LAogICAgICBkaXNhYmxlQW5pbWF0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmVsLmNsYXNzTGlzdC5yZW1vdmUodGhpcy5hbmltYXRpb25DbGFzcyk7CiAgICAgIH0sCiAgICAgIGVuYWJsZUFuaW1hdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5lbC5jbGFzc0xpc3QuYWRkKHRoaXMuYW5pbWF0aW9uQ2xhc3MpOwogICAgICB9LAogICAgICBnZXRUcmFuc2xhdGVYOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gcGFyc2VGbG9hdCh0aGlzLmVsLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dLnJlcGxhY2UoJ3RyYW5zbGF0ZTNkKCcsICcnKS5zcGxpdCgnLCcpWzBdKTsKICAgICAgfSwKICAgICAgc2V0VHJhbnNsYXRlWDogaW9uaWMuYW5pbWF0aW9uRnJhbWVUaHJvdHRsZShmdW5jdGlvbih4KSB7CiAgICAgICAgdGhpcy5lbC5zdHlsZVtpb25pYy5DU1MuVFJBTlNGT1JNXSA9ICd0cmFuc2xhdGUzZCgnICsgeCArICdweCwgMCwgMCknOwogICAgICB9KQogICAgfSk7CgogIH0pKGlvbmljKTsKCiAgLyoKICAgKiBBZGFwdGVkIGZyb20gU3dpcGUuanMgMi4wCiAgICoKICAgKiBCcmFkIEJpcmRzYWxsCiAgICogQ29weXJpZ2h0IDIwMTMsIE1JVCBMaWNlbnNlCiAgICoKICAgKi8KCiAgKGZ1bmN0aW9uKGlvbmljKSB7CiAgICAndXNlIHN0cmljdCc7CgogICAgaW9uaWMudmlld3MuU2xpZGVyID0gaW9uaWMudmlld3MuVmlldy5pbmhlcml0KHsKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgICB2YXIgc2xpZGVyID0gdGhpczsKCiAgICAgICAgLy8gdXRpbGl0aWVzCiAgICAgICAgdmFyIG5vb3AgPSBmdW5jdGlvbigpIHt9OyAvLyBzaW1wbGUgbm8gb3BlcmF0aW9uIGZ1bmN0aW9uCiAgICAgICAgdmFyIG9mZmxvYWRGbiA9IGZ1bmN0aW9uKGZuKSB7IHNldFRpbWVvdXQoZm4gfHwgbm9vcCwgMCk7IH07IC8vIG9mZmxvYWQgYSBmdW5jdGlvbnMgZXhlY3V0aW9uCgogICAgICAgIC8vIGNoZWNrIGJyb3dzZXIgY2FwYWJpbGl0aWVzCiAgICAgICAgdmFyIGJyb3dzZXIgPSB7CiAgICAgICAgICBhZGRFdmVudExpc3RlbmVyOiAhIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyLAogICAgICAgICAgdG91Y2g6ICgnb250b3VjaHN0YXJ0JyBpbiB3aW5kb3cpIHx8IHdpbmRvdy5Eb2N1bWVudFRvdWNoICYmIGRvY3VtZW50IGluc3RhbmNlb2YgRG9jdW1lbnRUb3VjaCwKICAgICAgICAgIHRyYW5zaXRpb25zOiAoZnVuY3Rpb24odGVtcCkgewogICAgICAgICAgICB2YXIgcHJvcHMgPSBbJ3RyYW5zaXRpb25Qcm9wZXJ0eScsICdXZWJraXRUcmFuc2l0aW9uJywgJ01velRyYW5zaXRpb24nLCAnT1RyYW5zaXRpb24nLCAnbXNUcmFuc2l0aW9uJ107CiAgICAgICAgICAgIGZvciAoIHZhciBpIGluIHByb3BzICkgaWYgKHRlbXAuc3R5bGVbIHByb3BzW2ldIF0gIT09IHVuZGVmaW5lZCkgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0pKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N3aXBlJykpCiAgICAgICAgfTsKCgogICAgICAgIHZhciBjb250YWluZXIgPSBvcHRpb25zLmVsOwoKICAgICAgICAvLyBxdWl0IGlmIG5vIHJvb3QgZWxlbWVudAogICAgICAgIGlmICghY29udGFpbmVyKSByZXR1cm47CiAgICAgICAgdmFyIGVsZW1lbnQgPSBjb250YWluZXIuY2hpbGRyZW5bMF07CiAgICAgICAgdmFyIHNsaWRlcywgc2xpZGVQb3MsIHdpZHRoLCBsZW5ndGg7CiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgdmFyIGluZGV4ID0gcGFyc2VJbnQob3B0aW9ucy5zdGFydFNsaWRlLCAxMCkgfHwgMDsKICAgICAgICB2YXIgc3BlZWQgPSBvcHRpb25zLnNwZWVkIHx8IDMwMDsKICAgICAgICBvcHRpb25zLmNvbnRpbnVvdXMgPSBvcHRpb25zLmNvbnRpbnVvdXMgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY29udGludW91cyA6IHRydWU7CgogICAgICAgIGZ1bmN0aW9uIHNldHVwKCkgewoKICAgICAgICAgIC8vIGNhY2hlIHNsaWRlcwogICAgICAgICAgc2xpZGVzID0gZWxlbWVudC5jaGlsZHJlbjsKICAgICAgICAgIGxlbmd0aCA9IHNsaWRlcy5sZW5ndGg7CgogICAgICAgICAgLy8gc2V0IGNvbnRpbnVvdXMgdG8gZmFsc2UgaWYgb25seSBvbmUgc2xpZGUKICAgICAgICAgIGlmIChzbGlkZXMubGVuZ3RoIDwgMikgb3B0aW9ucy5jb250aW51b3VzID0gZmFsc2U7CgogICAgICAgICAgLy9zcGVjaWFsIGNhc2UgaWYgdHdvIHNsaWRlcwogICAgICAgICAgaWYgKGJyb3dzZXIudHJhbnNpdGlvbnMgJiYgb3B0aW9ucy5jb250aW51b3VzICYmIHNsaWRlcy5sZW5ndGggPCAzKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoc2xpZGVzWzBdLmNsb25lTm9kZSh0cnVlKSk7CiAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoZWxlbWVudC5jaGlsZHJlblsxXS5jbG9uZU5vZGUodHJ1ZSkpOwogICAgICAgICAgICBzbGlkZXMgPSBlbGVtZW50LmNoaWxkcmVuOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIGNyZWF0ZSBhbiBhcnJheSB0byBzdG9yZSBjdXJyZW50IHBvc2l0aW9ucyBvZiBlYWNoIHNsaWRlCiAgICAgICAgICBzbGlkZVBvcyA9IG5ldyBBcnJheShzbGlkZXMubGVuZ3RoKTsKCiAgICAgICAgICAvLyBkZXRlcm1pbmUgd2lkdGggb2YgZWFjaCBzbGlkZQogICAgICAgICAgd2lkdGggPSBjb250YWluZXIub2Zmc2V0V2lkdGggfHwgY29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoOwoKICAgICAgICAgIGVsZW1lbnQuc3R5bGUud2lkdGggPSAoc2xpZGVzLmxlbmd0aCAqIHdpZHRoKSArICdweCc7CgogICAgICAgICAgLy8gc3RhY2sgZWxlbWVudHMKICAgICAgICAgIHZhciBwb3MgPSBzbGlkZXMubGVuZ3RoOwogICAgICAgICAgd2hpbGUocG9zLS0pIHsKCiAgICAgICAgICAgIHZhciBzbGlkZSA9IHNsaWRlc1twb3NdOwoKICAgICAgICAgICAgc2xpZGUuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CiAgICAgICAgICAgIHNsaWRlLnNldEF0dHJpYnV0ZSgnZGF0YS1pbmRleCcsIHBvcyk7CgogICAgICAgICAgICBpZiAoYnJvd3Nlci50cmFuc2l0aW9ucykgewogICAgICAgICAgICAgIHNsaWRlLnN0eWxlLmxlZnQgPSAocG9zICogLXdpZHRoKSArICdweCc7CiAgICAgICAgICAgICAgbW92ZShwb3MsIGluZGV4ID4gcG9zID8gLXdpZHRoIDogKGluZGV4IDwgcG9zID8gd2lkdGggOiAwKSwgMCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICB9CgogICAgICAgICAgLy8gcmVwb3NpdGlvbiBlbGVtZW50cyBiZWZvcmUgYW5kIGFmdGVyIGluZGV4CiAgICAgICAgICBpZiAob3B0aW9ucy5jb250aW51b3VzICYmIGJyb3dzZXIudHJhbnNpdGlvbnMpIHsKICAgICAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgtMSksIC13aWR0aCwgMCk7CiAgICAgICAgICAgIG1vdmUoY2lyY2xlKGluZGV4KzEpLCB3aWR0aCwgMCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFicm93c2VyLnRyYW5zaXRpb25zKSBlbGVtZW50LnN0eWxlLmxlZnQgPSAoaW5kZXggKiAtd2lkdGgpICsgJ3B4JzsKCiAgICAgICAgICBjb250YWluZXIuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCiAgICAgICAgICBvcHRpb25zLnNsaWRlc0NoYW5nZWQgJiYgb3B0aW9ucy5zbGlkZXNDaGFuZ2VkKCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBwcmV2KCkgewoKICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMpIHNsaWRlKGluZGV4LTEpOwogICAgICAgICAgZWxzZSBpZiAoaW5kZXgpIHNsaWRlKGluZGV4LTEpOwoKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG5leHQoKSB7CgogICAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgc2xpZGUoaW5kZXgrMSk7CiAgICAgICAgICBlbHNlIGlmIChpbmRleCA8IHNsaWRlcy5sZW5ndGggLSAxKSBzbGlkZShpbmRleCsxKTsKCiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjaXJjbGUoaW5kZXgpIHsKCiAgICAgICAgICAvLyBhIHNpbXBsZSBwb3NpdGl2ZSBtb2R1bG8gdXNpbmcgc2xpZGVzLmxlbmd0aAogICAgICAgICAgcmV0dXJuIChzbGlkZXMubGVuZ3RoICsgKGluZGV4ICUgc2xpZGVzLmxlbmd0aCkpICUgc2xpZGVzLmxlbmd0aDsKCiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzbGlkZSh0bywgc2xpZGVTcGVlZCkgewoKICAgICAgICAgIC8vIGRvIG5vdGhpbmcgaWYgYWxyZWFkeSBvbiByZXF1ZXN0ZWQgc2xpZGUKICAgICAgICAgIGlmIChpbmRleCA9PSB0bykgcmV0dXJuOwoKICAgICAgICAgIGlmIChicm93c2VyLnRyYW5zaXRpb25zKSB7CgogICAgICAgICAgICB2YXIgZGlyZWN0aW9uID0gTWF0aC5hYnMoaW5kZXgtdG8pIC8gKGluZGV4LXRvKTsgLy8gMTogYmFja3dhcmQsIC0xOiBmb3J3YXJkCgogICAgICAgICAgICAvLyBnZXQgdGhlIGFjdHVhbCBwb3NpdGlvbiBvZiB0aGUgc2xpZGUKICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgewogICAgICAgICAgICAgIHZhciBuYXR1cmFsX2RpcmVjdGlvbiA9IGRpcmVjdGlvbjsKICAgICAgICAgICAgICBkaXJlY3Rpb24gPSAtc2xpZGVQb3NbY2lyY2xlKHRvKV0gLyB3aWR0aDsKCiAgICAgICAgICAgICAgLy8gaWYgZ29pbmcgZm9yd2FyZCBidXQgdG8gPCBpbmRleCwgdXNlIHRvID0gc2xpZGVzLmxlbmd0aCArIHRvCiAgICAgICAgICAgICAgLy8gaWYgZ29pbmcgYmFja3dhcmQgYnV0IHRvID4gaW5kZXgsIHVzZSB0byA9IC1zbGlkZXMubGVuZ3RoICsgdG8KICAgICAgICAgICAgICBpZiAoZGlyZWN0aW9uICE9PSBuYXR1cmFsX2RpcmVjdGlvbikgdG8gPSAgLWRpcmVjdGlvbiAqIHNsaWRlcy5sZW5ndGggKyB0bzsKCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBkaWZmID0gTWF0aC5hYnMoaW5kZXgtdG8pIC0gMTsKCiAgICAgICAgICAgIC8vIG1vdmUgYWxsIHRoZSBzbGlkZXMgYmV0d2VlbiBpbmRleCBhbmQgdG8gaW4gdGhlIHJpZ2h0IGRpcmVjdGlvbgogICAgICAgICAgICB3aGlsZSAoZGlmZi0tKSBtb3ZlKCBjaXJjbGUoKHRvID4gaW5kZXggPyB0byA6IGluZGV4KSAtIGRpZmYgLSAxKSwgd2lkdGggKiBkaXJlY3Rpb24sIDApOwoKICAgICAgICAgICAgdG8gPSBjaXJjbGUodG8pOwoKICAgICAgICAgICAgbW92ZShpbmRleCwgd2lkdGggKiBkaXJlY3Rpb24sIHNsaWRlU3BlZWQgfHwgc3BlZWQpOwogICAgICAgICAgICBtb3ZlKHRvLCAwLCBzbGlkZVNwZWVkIHx8IHNwZWVkKTsKCiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMpIG1vdmUoY2lyY2xlKHRvIC0gZGlyZWN0aW9uKSwgLSh3aWR0aCAqIGRpcmVjdGlvbiksIDApOyAvLyB3ZSBuZWVkIHRvIGdldCB0aGUgbmV4dCBpbiBwbGFjZQoKICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICB0byA9IGNpcmNsZSh0byk7CiAgICAgICAgICAgIGFuaW1hdGUoaW5kZXggKiAtd2lkdGgsIHRvICogLXdpZHRoLCBzbGlkZVNwZWVkIHx8IHNwZWVkKTsKICAgICAgICAgICAgLy9ubyBmYWxsYmFjayBmb3IgYSBjaXJjdWxhciBjb250aW51b3VzIGlmIHRoZSBicm93c2VyIGRvZXMgbm90IGFjY2VwdCB0cmFuc2l0aW9ucwogICAgICAgICAgfQoKICAgICAgICAgIGluZGV4ID0gdG87CiAgICAgICAgICBvZmZsb2FkRm4ob3B0aW9ucy5jYWxsYmFjayAmJiBvcHRpb25zLmNhbGxiYWNrKGluZGV4LCBzbGlkZXNbaW5kZXhdKSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBtb3ZlKGluZGV4LCBkaXN0LCBzcGVlZCkgewoKICAgICAgICAgIHRyYW5zbGF0ZShpbmRleCwgZGlzdCwgc3BlZWQpOwogICAgICAgICAgc2xpZGVQb3NbaW5kZXhdID0gZGlzdDsKCiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB0cmFuc2xhdGUoaW5kZXgsIGRpc3QsIHNwZWVkKSB7CgogICAgICAgICAgdmFyIHNsaWRlID0gc2xpZGVzW2luZGV4XTsKICAgICAgICAgIHZhciBzdHlsZSA9IHNsaWRlICYmIHNsaWRlLnN0eWxlOwoKICAgICAgICAgIGlmICghc3R5bGUpIHJldHVybjsKCiAgICAgICAgICBzdHlsZS53ZWJraXRUcmFuc2l0aW9uRHVyYXRpb24gPQogICAgICAgICAgICBzdHlsZS5Nb3pUcmFuc2l0aW9uRHVyYXRpb24gPQogICAgICAgICAgICAgIHN0eWxlLm1zVHJhbnNpdGlvbkR1cmF0aW9uID0KICAgICAgICAgICAgICAgIHN0eWxlLk9UcmFuc2l0aW9uRHVyYXRpb24gPQogICAgICAgICAgICAgICAgICBzdHlsZS50cmFuc2l0aW9uRHVyYXRpb24gPSBzcGVlZCArICdtcyc7CgogICAgICAgICAgc3R5bGUud2Via2l0VHJhbnNmb3JtID0gJ3RyYW5zbGF0ZSgnICsgZGlzdCArICdweCwwKScgKyAndHJhbnNsYXRlWigwKSc7CiAgICAgICAgICBzdHlsZS5tc1RyYW5zZm9ybSA9CiAgICAgICAgICAgIHN0eWxlLk1velRyYW5zZm9ybSA9CiAgICAgICAgICAgICAgc3R5bGUuT1RyYW5zZm9ybSA9ICd0cmFuc2xhdGVYKCcgKyBkaXN0ICsgJ3B4KSc7CgogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gYW5pbWF0ZShmcm9tLCB0bywgc3BlZWQpIHsKCiAgICAgICAgICAvLyBpZiBub3QgYW4gYW5pbWF0aW9uLCBqdXN0IHJlcG9zaXRpb24KICAgICAgICAgIGlmICghc3BlZWQpIHsKCiAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUubGVmdCA9IHRvICsgJ3B4JzsKICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgc3RhcnQgPSArbmV3IERhdGUoKTsKCiAgICAgICAgICB2YXIgdGltZXIgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciB0aW1lRWxhcCA9ICtuZXcgRGF0ZSgpIC0gc3RhcnQ7CgogICAgICAgICAgICBpZiAodGltZUVsYXAgPiBzcGVlZCkgewoKICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlLmxlZnQgPSB0byArICdweCc7CgogICAgICAgICAgICAgIGlmIChkZWxheSkgYmVnaW4oKTsKCiAgICAgICAgICAgICAgb3B0aW9ucy50cmFuc2l0aW9uRW5kICYmIG9wdGlvbnMudHJhbnNpdGlvbkVuZC5jYWxsKGV2ZW50LCBpbmRleCwgc2xpZGVzW2luZGV4XSk7CgogICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGltZXIpOwogICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUubGVmdCA9ICgoICh0byAtIGZyb20pICogKE1hdGguZmxvb3IoKHRpbWVFbGFwIC8gc3BlZWQpICogMTAwKSAvIDEwMCkgKSArIGZyb20pICsgJ3B4JzsKCiAgICAgICAgICB9LCA0KTsKCiAgICAgICAgfQoKICAgICAgICAvLyBzZXR1cCBhdXRvIHNsaWRlc2hvdwogICAgICAgIHZhciBkZWxheSA9IG9wdGlvbnMuYXV0byB8fCAwOwogICAgICAgIHZhciBpbnRlcnZhbDsKCiAgICAgICAgZnVuY3Rpb24gYmVnaW4oKSB7CgogICAgICAgICAgaW50ZXJ2YWwgPSBzZXRUaW1lb3V0KG5leHQsIGRlbGF5KTsKCiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzdG9wKCkgewoKICAgICAgICAgIGRlbGF5ID0gb3B0aW9ucy5hdXRvIHx8IDA7CiAgICAgICAgICBjbGVhclRpbWVvdXQoaW50ZXJ2YWwpOwoKICAgICAgICB9CgoKICAgICAgICAvLyBzZXR1cCBpbml0aWFsIHZhcnMKICAgICAgICB2YXIgc3RhcnQgPSB7fTsKICAgICAgICB2YXIgZGVsdGEgPSB7fTsKICAgICAgICB2YXIgaXNTY3JvbGxpbmc7CgogICAgICAgIC8vIHNldHVwIGV2ZW50IGNhcHR1cmluZwogICAgICAgIHZhciBldmVudHMgPSB7CgogICAgICAgICAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmKGV2ZW50LnR5cGUgPT0gJ21vdXNlZG93bicgfHwgZXZlbnQudHlwZSA9PSAnbW91c2V1cCcgfHwgZXZlbnQudHlwZSA9PSAnbW91c2Vtb3ZlJykgewogICAgICAgICAgICAgIGV2ZW50LnRvdWNoZXMgPSBbewogICAgICAgICAgICAgICAgcGFnZVg6IGV2ZW50LnBhZ2VYLAogICAgICAgICAgICAgICAgcGFnZVk6IGV2ZW50LnBhZ2VZCiAgICAgICAgICAgICAgfV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN3aXRjaCAoZXZlbnQudHlwZSkgewogICAgICAgICAgICAgIGNhc2UgJ21vdXNlZG93bic6IHRoaXMuc3RhcnQoZXZlbnQpOyBicmVhazsKICAgICAgICAgICAgICBjYXNlICd0b3VjaHN0YXJ0JzogdGhpcy5zdGFydChldmVudCk7IGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ3RvdWNobW92ZSc6IHRoaXMudG91Y2htb3ZlKGV2ZW50KTsgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAnbW91c2Vtb3ZlJzogdGhpcy50b3VjaG1vdmUoZXZlbnQpOyBicmVhazsKICAgICAgICAgICAgICBjYXNlICd0b3VjaGVuZCc6IG9mZmxvYWRGbih0aGlzLmVuZChldmVudCkpOyBicmVhazsKICAgICAgICAgICAgICBjYXNlICdtb3VzZXVwJzogb2ZmbG9hZEZuKHRoaXMuZW5kKGV2ZW50KSk7IGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgJ3dlYmtpdFRyYW5zaXRpb25FbmQnOgogICAgICAgICAgICAgIGNhc2UgJ21zVHJhbnNpdGlvbkVuZCc6CiAgICAgICAgICAgICAgY2FzZSAnb1RyYW5zaXRpb25FbmQnOgogICAgICAgICAgICAgIGNhc2UgJ290cmFuc2l0aW9uZW5kJzoKICAgICAgICAgICAgICBjYXNlICd0cmFuc2l0aW9uZW5kJzogb2ZmbG9hZEZuKHRoaXMudHJhbnNpdGlvbkVuZChldmVudCkpOyBicmVhazsKICAgICAgICAgICAgICBjYXNlICdyZXNpemUnOiBvZmZsb2FkRm4oc2V0dXApOyBicmVhazsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG9wdGlvbnMuc3RvcFByb3BhZ2F0aW9uKSBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICAgICAgICB9LAogICAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CgogICAgICAgICAgICB2YXIgdG91Y2hlcyA9IGV2ZW50LnRvdWNoZXNbMF07CgogICAgICAgICAgICAvLyBtZWFzdXJlIHN0YXJ0IHZhbHVlcwogICAgICAgICAgICBzdGFydCA9IHsKCiAgICAgICAgICAgICAgLy8gZ2V0IGluaXRpYWwgdG91Y2ggY29vcmRzCiAgICAgICAgICAgICAgeDogdG91Y2hlcy5wYWdlWCwKICAgICAgICAgICAgICB5OiB0b3VjaGVzLnBhZ2VZLAoKICAgICAgICAgICAgICAvLyBzdG9yZSB0aW1lIHRvIGRldGVybWluZSB0b3VjaCBkdXJhdGlvbgogICAgICAgICAgICAgIHRpbWU6ICtuZXcgRGF0ZSgpCgogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gdXNlZCBmb3IgdGVzdGluZyBmaXJzdCBtb3ZlIGV2ZW50CiAgICAgICAgICAgIGlzU2Nyb2xsaW5nID0gdW5kZWZpbmVkOwoKICAgICAgICAgICAgLy8gcmVzZXQgZGVsdGEgYW5kIGVuZCBtZWFzdXJlbWVudHMKICAgICAgICAgICAgZGVsdGEgPSB7fTsKCiAgICAgICAgICAgIC8vIGF0dGFjaCB0b3VjaG1vdmUgYW5kIHRvdWNoZW5kIGxpc3RlbmVycwogICAgICAgICAgICBpZihicm93c2VyLnRvdWNoKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLCBmYWxzZSk7CiAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRoaXMsIGZhbHNlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMsIGZhbHNlKTsKICAgICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLCBmYWxzZSk7CiAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHRvdWNobW92ZTogZnVuY3Rpb24oZXZlbnQpIHsKCiAgICAgICAgICAgIC8vIGVuc3VyZSBzd2lwaW5nIHdpdGggb25lIHRvdWNoIGFuZCBub3QgcGluY2hpbmcKICAgICAgICAgICAgLy8gZW5zdXJlIHNsaWRpbmcgaXMgZW5hYmxlZAogICAgICAgICAgICBpZiAoZXZlbnQudG91Y2hlcy5sZW5ndGggPiAxIHx8CiAgICAgICAgICAgICAgZXZlbnQuc2NhbGUgJiYgZXZlbnQuc2NhbGUgIT09IDEgfHwKICAgICAgICAgICAgICBzbGlkZXIuc2xpZGVJc0Rpc2FibGVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0aW9ucy5kaXNhYmxlU2Nyb2xsKSBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgdmFyIHRvdWNoZXMgPSBldmVudC50b3VjaGVzWzBdOwoKICAgICAgICAgICAgLy8gbWVhc3VyZSBjaGFuZ2UgaW4geCBhbmQgeQogICAgICAgICAgICBkZWx0YSA9IHsKICAgICAgICAgICAgICB4OiB0b3VjaGVzLnBhZ2VYIC0gc3RhcnQueCwKICAgICAgICAgICAgICB5OiB0b3VjaGVzLnBhZ2VZIC0gc3RhcnQueQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gZGV0ZXJtaW5lIGlmIHNjcm9sbGluZyB0ZXN0IGhhcyBydW4gLSBvbmUgdGltZSB0ZXN0CiAgICAgICAgICAgIGlmICggdHlwZW9mIGlzU2Nyb2xsaW5nID09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgaXNTY3JvbGxpbmcgPSAhISggaXNTY3JvbGxpbmcgfHwgTWF0aC5hYnMoZGVsdGEueCkgPCBNYXRoLmFicyhkZWx0YS55KSApOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiB1c2VyIGlzIG5vdCB0cnlpbmcgdG8gc2Nyb2xsIHZlcnRpY2FsbHkKICAgICAgICAgICAgaWYgKCFpc1Njcm9sbGluZykgewoKICAgICAgICAgICAgICAvLyBwcmV2ZW50IG5hdGl2ZSBzY3JvbGxpbmcKICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgICAvLyBzdG9wIHNsaWRlc2hvdwogICAgICAgICAgICAgIHN0b3AoKTsKCiAgICAgICAgICAgICAgLy8gaW5jcmVhc2UgcmVzaXN0YW5jZSBpZiBmaXJzdCBvciBsYXN0IHNsaWRlCiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgeyAvLyB3ZSBkb24ndCBhZGQgcmVzaXN0YW5jZSBhdCB0aGUgZW5kCgogICAgICAgICAgICAgICAgdHJhbnNsYXRlKGNpcmNsZShpbmRleC0xKSwgZGVsdGEueCArIHNsaWRlUG9zW2NpcmNsZShpbmRleC0xKV0sIDApOwogICAgICAgICAgICAgICAgdHJhbnNsYXRlKGluZGV4LCBkZWx0YS54ICsgc2xpZGVQb3NbaW5kZXhdLCAwKTsKICAgICAgICAgICAgICAgIHRyYW5zbGF0ZShjaXJjbGUoaW5kZXgrMSksIGRlbHRhLnggKyBzbGlkZVBvc1tjaXJjbGUoaW5kZXgrMSldLCAwKTsKCiAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICBkZWx0YS54ID0KICAgICAgICAgICAgICAgICAgZGVsdGEueCAvCiAgICAgICAgICAgICAgICAgICggKCFpbmRleCAmJiBkZWx0YS54ID4gMCB8fCAgICAgICAgIC8vIGlmIGZpcnN0IHNsaWRlIGFuZCBzbGlkaW5nIGxlZnQKICAgICAgICAgICAgICAgICAgICBpbmRleCA9PSBzbGlkZXMubGVuZ3RoIC0gMSAmJiAgICAgLy8gb3IgaWYgbGFzdCBzbGlkZSBhbmQgc2xpZGluZyByaWdodAogICAgICAgICAgICAgICAgICAgIGRlbHRhLnggPCAwICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgaWYgc2xpZGluZyBhdCBhbGwKICAgICAgICAgICAgICAgICAgICApID8KICAgICAgICAgICAgICAgICAgICAoIE1hdGguYWJzKGRlbHRhLngpIC8gd2lkdGggKyAxICkgICAgICAvLyBkZXRlcm1pbmUgcmVzaXN0YW5jZSBsZXZlbAogICAgICAgICAgICAgICAgICAgIDogMSApOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5vIHJlc2lzdGFuY2UgaWYgZmFsc2UKCiAgICAgICAgICAgICAgICAvLyB0cmFuc2xhdGUgMToxCiAgICAgICAgICAgICAgICB0cmFuc2xhdGUoaW5kZXgtMSwgZGVsdGEueCArIHNsaWRlUG9zW2luZGV4LTFdLCAwKTsKICAgICAgICAgICAgICAgIHRyYW5zbGF0ZShpbmRleCwgZGVsdGEueCArIHNsaWRlUG9zW2luZGV4XSwgMCk7CiAgICAgICAgICAgICAgICB0cmFuc2xhdGUoaW5kZXgrMSwgZGVsdGEueCArIHNsaWRlUG9zW2luZGV4KzFdLCAwKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CgogICAgICAgICAgfSwKICAgICAgICAgIGVuZDogZnVuY3Rpb24oZXZlbnQpIHsKCiAgICAgICAgICAgIC8vIG1lYXN1cmUgZHVyYXRpb24KICAgICAgICAgICAgdmFyIGR1cmF0aW9uID0gK25ldyBEYXRlKCkgLSBzdGFydC50aW1lOwoKICAgICAgICAgICAgLy8gZGV0ZXJtaW5lIGlmIHNsaWRlIGF0dGVtcHQgdHJpZ2dlcnMgbmV4dC9wcmV2IHNsaWRlCiAgICAgICAgICAgIHZhciBpc1ZhbGlkU2xpZGUgPQogICAgICAgICAgICAgIE51bWJlcihkdXJhdGlvbikgPCAyNTAgJiYgICAgICAgICAvLyBpZiBzbGlkZSBkdXJhdGlvbiBpcyBsZXNzIHRoYW4gMjUwbXMKICAgICAgICAgICAgICBNYXRoLmFicyhkZWx0YS54KSA+IDIwIHx8ICAgICAgICAgLy8gYW5kIGlmIHNsaWRlIGFtdCBpcyBncmVhdGVyIHRoYW4gMjBweAogICAgICAgICAgICAgIE1hdGguYWJzKGRlbHRhLngpID4gd2lkdGgvMjsgICAgICAvLyBvciBpZiBzbGlkZSBhbXQgaXMgZ3JlYXRlciB0aGFuIGhhbGYgdGhlIHdpZHRoCgogICAgICAgICAgICAvLyBkZXRlcm1pbmUgaWYgc2xpZGUgYXR0ZW1wdCBpcyBwYXN0IHN0YXJ0IGFuZCBlbmQKICAgICAgICAgICAgdmFyIGlzUGFzdEJvdW5kcyA9ICghaW5kZXggJiYgZGVsdGEueCA+IDApIHx8ICAgICAgLy8gaWYgZmlyc3Qgc2xpZGUgYW5kIHNsaWRlIGFtdCBpcyBncmVhdGVyIHRoYW4gMAogICAgICAgICAgICAgIChpbmRleCA9PSBzbGlkZXMubGVuZ3RoIC0gMSAmJiBkZWx0YS54IDwgMCk7IC8vIG9yIGlmIGxhc3Qgc2xpZGUgYW5kIHNsaWRlIGFtdCBpcyBsZXNzIHRoYW4gMAoKICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29udGludW91cykgaXNQYXN0Qm91bmRzID0gZmFsc2U7CgogICAgICAgICAgICAvLyBkZXRlcm1pbmUgZGlyZWN0aW9uIG9mIHN3aXBlICh0cnVlOnJpZ2h0LCBmYWxzZTpsZWZ0KQogICAgICAgICAgICB2YXIgZGlyZWN0aW9uID0gZGVsdGEueCA8IDA7CgogICAgICAgICAgICAvLyBpZiBub3Qgc2Nyb2xsaW5nIHZlcnRpY2FsbHkKICAgICAgICAgICAgaWYgKCFpc1Njcm9sbGluZykgewoKICAgICAgICAgICAgICBpZiAoaXNWYWxpZFNsaWRlICYmICFpc1Bhc3RCb3VuZHMpIHsKCiAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aW9uKSB7CgogICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jb250aW51b3VzKSB7IC8vIHdlIG5lZWQgdG8gZ2V0IHRoZSBuZXh0IGluIHRoaXMgZGlyZWN0aW9uIGluIHBsYWNlCgogICAgICAgICAgICAgICAgICAgIG1vdmUoY2lyY2xlKGluZGV4LTEpLCAtd2lkdGgsIDApOwogICAgICAgICAgICAgICAgICAgIG1vdmUoY2lyY2xlKGluZGV4KzIpLCB3aWR0aCwgMCk7CgogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG1vdmUoaW5kZXgtMSwgLXdpZHRoLCAwKTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgbW92ZShpbmRleCwgc2xpZGVQb3NbaW5kZXhdLXdpZHRoLCBzcGVlZCk7CiAgICAgICAgICAgICAgICAgIG1vdmUoY2lyY2xlKGluZGV4KzEpLCBzbGlkZVBvc1tjaXJjbGUoaW5kZXgrMSldLXdpZHRoLCBzcGVlZCk7CiAgICAgICAgICAgICAgICAgIGluZGV4ID0gY2lyY2xlKGluZGV4KzEpOwoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRpbnVvdXMpIHsgLy8gd2UgbmVlZCB0byBnZXQgdGhlIG5leHQgaW4gdGhpcyBkaXJlY3Rpb24gaW4gcGxhY2UKCiAgICAgICAgICAgICAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgrMSksIHdpZHRoLCAwKTsKICAgICAgICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleC0yKSwgLXdpZHRoLCAwKTsKCiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbW92ZShpbmRleCsxLCB3aWR0aCwgMCk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIG1vdmUoaW5kZXgsIHNsaWRlUG9zW2luZGV4XSt3aWR0aCwgc3BlZWQpOwogICAgICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleC0xKSwgc2xpZGVQb3NbY2lyY2xlKGluZGV4LTEpXSt3aWR0aCwgc3BlZWQpOwogICAgICAgICAgICAgICAgICBpbmRleCA9IGNpcmNsZShpbmRleC0xKTsKCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3B0aW9ucy5jYWxsYmFjayAmJiBvcHRpb25zLmNhbGxiYWNrKGluZGV4LCBzbGlkZXNbaW5kZXhdKTsKCiAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jb250aW51b3VzKSB7CgogICAgICAgICAgICAgICAgICBtb3ZlKGNpcmNsZShpbmRleC0xKSwgLXdpZHRoLCBzcGVlZCk7CiAgICAgICAgICAgICAgICAgIG1vdmUoaW5kZXgsIDAsIHNwZWVkKTsKICAgICAgICAgICAgICAgICAgbW92ZShjaXJjbGUoaW5kZXgrMSksIHdpZHRoLCBzcGVlZCk7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgIG1vdmUoaW5kZXgtMSwgLXdpZHRoLCBzcGVlZCk7CiAgICAgICAgICAgICAgICAgIG1vdmUoaW5kZXgsIDAsIHNwZWVkKTsKICAgICAgICAgICAgICAgICAgbW92ZShpbmRleCsxLCB3aWR0aCwgc3BlZWQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBraWxsIHRvdWNobW92ZSBhbmQgdG91Y2hlbmQgZXZlbnQgbGlzdGVuZXJzIHVudGlsIHRvdWNoc3RhcnQgY2FsbGVkIGFnYWluCiAgICAgICAgICAgIGlmKGJyb3dzZXIudG91Y2gpIHsKICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0sCiAgICAgICAgICB0cmFuc2l0aW9uRW5kOiBmdW5jdGlvbihldmVudCkgewoKICAgICAgICAgICAgaWYgKHBhcnNlSW50KGV2ZW50LnRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtaW5kZXgnKSwgMTApID09IGluZGV4KSB7CgogICAgICAgICAgICAgIGlmIChkZWxheSkgYmVnaW4oKTsKCiAgICAgICAgICAgICAgb3B0aW9ucy50cmFuc2l0aW9uRW5kICYmIG9wdGlvbnMudHJhbnNpdGlvbkVuZC5jYWxsKGV2ZW50LCBpbmRleCwgc2xpZGVzW2luZGV4XSk7CgogICAgICAgICAgICB9CgogICAgICAgICAgfQoKICAgICAgICB9OwoKICAgICAgICAvLyBQdWJsaWMgQVBJCiAgICAgICAgdGhpcy51cGRhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHNldFRpbWVvdXQoc2V0dXApOwogICAgICAgIH07CiAgICAgICAgdGhpcy5zZXR1cCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2V0dXAoKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmVuYWJsZVNsaWRlID0gZnVuY3Rpb24oc2hvdWxkRW5hYmxlKSB7CiAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICB0aGlzLnNsaWRlSXNEaXNhYmxlZCA9ICFzaG91bGRFbmFibGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIXRoaXMuc2xpZGVJc0Rpc2FibGVkOwogICAgICAgIH0sCiAgICAgICAgICB0aGlzLnNsaWRlID0gZnVuY3Rpb24odG8sIHNwZWVkKSB7CiAgICAgICAgICAgIC8vIGNhbmNlbCBzbGlkZXNob3cKICAgICAgICAgICAgc3RvcCgpOwoKICAgICAgICAgICAgc2xpZGUodG8sIHNwZWVkKTsKICAgICAgICAgIH07CgogICAgICAgIHRoaXMucHJldiA9IHRoaXMucHJldmlvdXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIGNhbmNlbCBzbGlkZXNob3cKICAgICAgICAgIHN0b3AoKTsKCiAgICAgICAgICBwcmV2KCk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5uZXh0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyBjYW5jZWwgc2xpZGVzaG93CiAgICAgICAgICBzdG9wKCk7CgogICAgICAgICAgbmV4dCgpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gY2FuY2VsIHNsaWRlc2hvdwogICAgICAgICAgc3RvcCgpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGJlZ2luKCk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5jdXJyZW50SW5kZXggPSBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIHJldHVybiBjdXJyZW50IGluZGV4IHBvc2l0aW9uCiAgICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5zbGlkZXNDb3VudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gcmV0dXJuIHRvdGFsIG51bWJlciBvZiBzbGlkZXMKICAgICAgICAgIHJldHVybiBsZW5ndGg7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5raWxsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyBjYW5jZWwgc2xpZGVzaG93CiAgICAgICAgICBzdG9wKCk7CgogICAgICAgICAgLy8gcmVzZXQgZWxlbWVudAogICAgICAgICAgZWxlbWVudC5zdHlsZS53aWR0aCA9ICcnOwogICAgICAgICAgZWxlbWVudC5zdHlsZS5sZWZ0ID0gJyc7CgogICAgICAgICAgLy8gcmVzZXQgc2xpZGVzCiAgICAgICAgICB2YXIgcG9zID0gc2xpZGVzLmxlbmd0aDsKICAgICAgICAgIHdoaWxlKHBvcy0tKSB7CgogICAgICAgICAgICB2YXIgc2xpZGUgPSBzbGlkZXNbcG9zXTsKICAgICAgICAgICAgc2xpZGUuc3R5bGUud2lkdGggPSAnJzsKICAgICAgICAgICAgc2xpZGUuc3R5bGUubGVmdCA9ICcnOwoKICAgICAgICAgICAgaWYgKGJyb3dzZXIudHJhbnNpdGlvbnMpIHRyYW5zbGF0ZShwb3MsIDAsIDApOwoKICAgICAgICAgIH0KCiAgICAgICAgICAvLyByZW1vdmVkIGV2ZW50IGxpc3RlbmVycwogICAgICAgICAgaWYgKGJyb3dzZXIuYWRkRXZlbnRMaXN0ZW5lcikgewoKICAgICAgICAgICAgLy8gcmVtb3ZlIGN1cnJlbnQgZXZlbnQgbGlzdGVuZXJzCiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3dlYmtpdFRyYW5zaXRpb25FbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtc1RyYW5zaXRpb25FbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdvVHJhbnNpdGlvbkVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ290cmFuc2l0aW9uZW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndHJhbnNpdGlvbmVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVzaXplJywgZXZlbnRzLCBmYWxzZSk7CgogICAgICAgICAgfQogICAgICAgICAgZWxzZSB7CgogICAgICAgICAgICB3aW5kb3cub25yZXNpemUgPSBudWxsOwoKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB0aGlzLmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIHRyaWdnZXIgc2V0dXAKICAgICAgICAgIHNldHVwKCk7CgogICAgICAgICAgLy8gc3RhcnQgYXV0byBzbGlkZXNob3cgaWYgYXBwbGljYWJsZQogICAgICAgICAgaWYgKGRlbGF5KSBiZWdpbigpOwoKCiAgICAgICAgICAvLyBhZGQgZXZlbnQgbGlzdGVuZXJzCiAgICAgICAgICBpZiAoYnJvd3Nlci5hZGRFdmVudExpc3RlbmVyKSB7CgogICAgICAgICAgICAvLyBzZXQgdG91Y2hzdGFydCBldmVudCBvbiBlbGVtZW50CiAgICAgICAgICAgIGlmIChicm93c2VyLnRvdWNoKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJyb3dzZXIudHJhbnNpdGlvbnMpIHsKICAgICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdFRyYW5zaXRpb25FbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21zVHJhbnNpdGlvbkVuZCcsIGV2ZW50cywgZmFsc2UpOwogICAgICAgICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignb1RyYW5zaXRpb25FbmQnLCBldmVudHMsIGZhbHNlKTsKICAgICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ290cmFuc2l0aW9uZW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd0cmFuc2l0aW9uZW5kJywgZXZlbnRzLCBmYWxzZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIHNldCByZXNpemUgZXZlbnQgb24gd2luZG93CiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBldmVudHMsIGZhbHNlKTsKCiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgd2luZG93Lm9ucmVzaXplID0gZnVuY3Rpb24gKCkgeyBzZXR1cCgpOyB9OyAvLyB0byBwbGF5IG5pY2Ugd2l0aCBvbGQgSUUKCiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgIH0KICAgIH0pOwoKICB9KShpb25pYyk7CgogIChmdW5jdGlvbihpb25pYykgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIGlvbmljLnZpZXdzLlRvZ2dsZSA9IGlvbmljLnZpZXdzLlZpZXcuaW5oZXJpdCh7CiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdHMpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHRoaXMuZWwgPSBvcHRzLmVsOwogICAgICAgIHRoaXMuY2hlY2tib3ggPSBvcHRzLmNoZWNrYm94OwogICAgICAgIHRoaXMudHJhY2sgPSBvcHRzLnRyYWNrOwogICAgICAgIHRoaXMuaGFuZGxlID0gb3B0cy5oYW5kbGU7CiAgICAgICAgdGhpcy5vcGVuUGVyY2VudCA9IC0xOwogICAgICAgIHRoaXMub25DaGFuZ2UgPSBvcHRzLm9uQ2hhbmdlIHx8IGZ1bmN0aW9uKCkge307CgogICAgICAgIHRoaXMudHJpZ2dlclRocmVzaG9sZCA9IG9wdHMudHJpZ2dlclRocmVzaG9sZCB8fCAyMDsKCiAgICAgICAgdGhpcy5kcmFnU3RhcnRIYW5kbGVyID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgc2VsZi5kcmFnU3RhcnQoZSk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLmRyYWdIYW5kbGVyID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgc2VsZi5kcmFnKGUpOwogICAgICAgIH07CiAgICAgICAgdGhpcy5ob2xkSGFuZGxlciA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHNlbGYuaG9sZChlKTsKICAgICAgICB9OwogICAgICAgIHRoaXMucmVsZWFzZUhhbmRsZXIgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICBzZWxmLnJlbGVhc2UoZSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5kcmFnU3RhcnRHZXN0dXJlID0gaW9uaWMub25HZXN0dXJlKCdkcmFnc3RhcnQnLCB0aGlzLmRyYWdTdGFydEhhbmRsZXIsIHRoaXMuZWwpOwogICAgICAgIHRoaXMuZHJhZ0dlc3R1cmUgPSBpb25pYy5vbkdlc3R1cmUoJ2RyYWcnLCB0aGlzLmRyYWdIYW5kbGVyLCB0aGlzLmVsKTsKICAgICAgICB0aGlzLmRyYWdIb2xkR2VzdHVyZSA9IGlvbmljLm9uR2VzdHVyZSgnaG9sZCcsIHRoaXMuaG9sZEhhbmRsZXIsIHRoaXMuZWwpOwogICAgICAgIHRoaXMuZHJhZ1JlbGVhc2VHZXN0dXJlID0gaW9uaWMub25HZXN0dXJlKCdyZWxlYXNlJywgdGhpcy5yZWxlYXNlSGFuZGxlciwgdGhpcy5lbCk7CiAgICAgIH0sCgogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpb25pYy5vZmZHZXN0dXJlKHRoaXMuZHJhZ1N0YXJ0R2VzdHVyZSwgJ2RyYWdzdGFydCcsIHRoaXMuZHJhZ1N0YXJ0R2VzdHVyZSk7CiAgICAgICAgaW9uaWMub2ZmR2VzdHVyZSh0aGlzLmRyYWdHZXN0dXJlLCAnZHJhZycsIHRoaXMuZHJhZ0dlc3R1cmUpOwogICAgICAgIGlvbmljLm9mZkdlc3R1cmUodGhpcy5kcmFnSG9sZEdlc3R1cmUsICdob2xkJywgdGhpcy5ob2xkSGFuZGxlcik7CiAgICAgICAgaW9uaWMub2ZmR2VzdHVyZSh0aGlzLmRyYWdSZWxlYXNlR2VzdHVyZSwgJ3JlbGVhc2UnLCB0aGlzLnJlbGVhc2VIYW5kbGVyKTsKICAgICAgfSwKCiAgICAgIHRhcDogZnVuY3Rpb24oZSkgewogICAgICAgIGlmKHRoaXMuZWwuZ2V0QXR0cmlidXRlKCdkaXNhYmxlZCcpICE9PSAnZGlzYWJsZWQnKSB7CiAgICAgICAgICB0aGlzLnZhbCggIXRoaXMuY2hlY2tib3guY2hlY2tlZCApOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIGRyYWdTdGFydDogZnVuY3Rpb24oZSkgewogICAgICAgIGlmKHRoaXMuY2hlY2tib3guZGlzYWJsZWQpIHJldHVybjsKCiAgICAgICAgdGhpcy5fZHJhZ0luZm8gPSB7CiAgICAgICAgICB3aWR0aDogdGhpcy5lbC5vZmZzZXRXaWR0aCwKICAgICAgICAgIGxlZnQ6IHRoaXMuZWwub2Zmc2V0TGVmdCwKICAgICAgICAgIHJpZ2h0OiB0aGlzLmVsLm9mZnNldExlZnQgKyB0aGlzLmVsLm9mZnNldFdpZHRoLAogICAgICAgICAgdHJpZ2dlclg6IHRoaXMuZWwub2Zmc2V0V2lkdGggLyAyLAogICAgICAgICAgaW5pdGlhbFN0YXRlOiB0aGlzLmNoZWNrYm94LmNoZWNrZWQKICAgICAgICB9OwoKICAgICAgICAvLyBTdG9wIGFueSBwYXJlbnQgZHJhZ2dpbmcKICAgICAgICBlLmdlc3R1cmUuc3JjRXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgLy8gVHJpZ2dlciBob2xkIHN0eWxlcwogICAgICAgIHRoaXMuaG9sZChlKTsKICAgICAgfSwKCiAgICAgIGRyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgaWYoIXRoaXMuX2RyYWdJbmZvKSB7IHJldHVybjsgfQoKICAgICAgICAvLyBTdG9wIGFueSBwYXJlbnQgZHJhZ2dpbmcKICAgICAgICBlLmdlc3R1cmUuc3JjRXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKGFtb3VudCkgewogICAgICAgICAgaWYgKCFzZWxmLl9kcmFnSW5mbykgeyByZXR1cm47IH0KCiAgICAgICAgICB2YXIgc2xpZGVQYWdlTGVmdCA9IHNlbGYudHJhY2sub2Zmc2V0TGVmdCArIChzZWxmLmhhbmRsZS5vZmZzZXRXaWR0aCAvIDIpOwogICAgICAgICAgdmFyIHNsaWRlUGFnZVJpZ2h0ID0gc2VsZi50cmFjay5vZmZzZXRMZWZ0ICsgc2VsZi50cmFjay5vZmZzZXRXaWR0aCAtIChzZWxmLmhhbmRsZS5vZmZzZXRXaWR0aCAvIDIpOwogICAgICAgICAgdmFyIGR4ID0gZS5nZXN0dXJlLmRlbHRhWDsKCiAgICAgICAgICB2YXIgcHggPSBlLmdlc3R1cmUudG91Y2hlc1swXS5wYWdlWCAtIHNlbGYuX2RyYWdJbmZvLmxlZnQ7CiAgICAgICAgICB2YXIgbXggPSBzZWxmLl9kcmFnSW5mby53aWR0aCAtIHNlbGYudHJpZ2dlclRocmVzaG9sZDsKCiAgICAgICAgICAvLyBUaGUgaW5pdGlhbCBzdGF0ZSB3YXMgb24sIHNvICJ0ZW5kIHRvd2FyZHMiIG9uCiAgICAgICAgICBpZihzZWxmLl9kcmFnSW5mby5pbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgaWYocHggPCBzZWxmLnRyaWdnZXJUaHJlc2hvbGQpIHsKICAgICAgICAgICAgICBzZWxmLnNldE9wZW5QZXJjZW50KDApOwogICAgICAgICAgICB9IGVsc2UgaWYocHggPiBzZWxmLl9kcmFnSW5mby50cmlnZ2VyWCkgewogICAgICAgICAgICAgIHNlbGYuc2V0T3BlblBlcmNlbnQoMTAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVGhlIGluaXRpYWwgc3RhdGUgd2FzIG9mZiwgc28gInRlbmQgdG93YXJkcyIgb2ZmCiAgICAgICAgICAgIGlmKHB4IDwgc2VsZi5fZHJhZ0luZm8udHJpZ2dlclgpIHsKICAgICAgICAgICAgICBzZWxmLnNldE9wZW5QZXJjZW50KDApOwogICAgICAgICAgICB9IGVsc2UgaWYocHggPiBteCkgewogICAgICAgICAgICAgIHNlbGYuc2V0T3BlblBlcmNlbnQoMTAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9LAoKICAgICAgZW5kRHJhZzogZnVuY3Rpb24oZSkgewogICAgICAgIHRoaXMuX2RyYWdJbmZvID0gbnVsbDsKICAgICAgfSwKCiAgICAgIGhvbGQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB0aGlzLmVsLmNsYXNzTGlzdC5hZGQoJ2RyYWdnaW5nJyk7CiAgICAgIH0sCiAgICAgIHJlbGVhc2U6IGZ1bmN0aW9uKGUpIHsKICAgICAgICB0aGlzLmVsLmNsYXNzTGlzdC5yZW1vdmUoJ2RyYWdnaW5nJyk7CiAgICAgICAgdGhpcy5lbmREcmFnKGUpOwogICAgICB9LAoKCiAgICAgIHNldE9wZW5QZXJjZW50OiBmdW5jdGlvbihvcGVuUGVyY2VudCkgewogICAgICAgIC8vIG9ubHkgbWFrZSBhIGNoYW5nZSBpZiB0aGUgbmV3IG9wZW4gcGVyY2VudCBoYXMgY2hhbmdlZAogICAgICAgIGlmKHRoaXMub3BlblBlcmNlbnQgPCAwIHx8IChvcGVuUGVyY2VudCA8ICh0aGlzLm9wZW5QZXJjZW50IC0gMykgfHwgb3BlblBlcmNlbnQgPiAodGhpcy5vcGVuUGVyY2VudCArIDMpICkgKSB7CiAgICAgICAgICB0aGlzLm9wZW5QZXJjZW50ID0gb3BlblBlcmNlbnQ7CgogICAgICAgICAgaWYob3BlblBlcmNlbnQgPT09IDApIHsKICAgICAgICAgICAgdGhpcy52YWwoZmFsc2UpOwogICAgICAgICAgfSBlbHNlIGlmKG9wZW5QZXJjZW50ID09PSAxMDApIHsKICAgICAgICAgICAgdGhpcy52YWwodHJ1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgb3BlblBpeGVsID0gTWF0aC5yb3VuZCggKG9wZW5QZXJjZW50IC8gMTAwKSAqIHRoaXMudHJhY2sub2Zmc2V0V2lkdGggLSAodGhpcy5oYW5kbGUub2Zmc2V0V2lkdGgpICk7CiAgICAgICAgICAgIG9wZW5QaXhlbCA9IChvcGVuUGl4ZWwgPCAxID8gMCA6IG9wZW5QaXhlbCk7CiAgICAgICAgICAgIHRoaXMuaGFuZGxlLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJ3RyYW5zbGF0ZTNkKCcgKyBvcGVuUGl4ZWwgKyAncHgsMCwwKSc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAoKICAgICAgdmFsOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIGlmKHZhbHVlID09PSB0cnVlIHx8IHZhbHVlID09PSBmYWxzZSkgewogICAgICAgICAgaWYodGhpcy5oYW5kbGUuc3R5bGVbaW9uaWMuQ1NTLlRSQU5TRk9STV0gIT09ICIiKSB7CiAgICAgICAgICAgIHRoaXMuaGFuZGxlLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmNoZWNrYm94LmNoZWNrZWQgPSB2YWx1ZTsKICAgICAgICAgIHRoaXMub3BlblBlcmNlbnQgPSAodmFsdWUgPyAxMDAgOiAwKTsKICAgICAgICAgIHRoaXMub25DaGFuZ2UgJiYgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5jaGVja2JveC5jaGVja2VkOwogICAgICB9CgogICAgfSk7CgogIH0pKGlvbmljKTsKCiAgKGZ1bmN0aW9uKGlvbmljKSB7CiAgICAndXNlIHN0cmljdCc7CiAgICBpb25pYy5jb250cm9sbGVycy5WaWV3Q29udHJvbGxlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwoKICAgIGlvbmljLmNvbnRyb2xsZXJzLlZpZXdDb250cm9sbGVyLmluaGVyaXQgPSBpb25pYy5pbmhlcml0OwoKICAgIGlvbmljLmV4dGVuZChpb25pYy5jb250cm9sbGVycy5WaWV3Q29udHJvbGxlci5wcm90b3R5cGUsIHsKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7fSwKICAgICAgLy8gRGVzdHJveSB0aGlzIHZpZXcgY29udHJvbGxlciwgaW5jbHVkaW5nIGFsbCBjaGlsZCB2aWV3cwogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgfQogICAgfSk7CgogIH0pKHdpbmRvdy5pb25pYyk7CgogIChmdW5jdGlvbihpb25pYykgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIC8qKgogICAgICogVGhlIFNpZGVNZW51Q29udHJvbGxlciBpcyBhIGNvbnRyb2xsZXIgd2l0aCBhIGxlZnQgYW5kL29yIHJpZ2h0IG1lbnUgdGhhdAogICAgICogY2FuIGJlIHNsaWQgb3V0IGFuZCB0b2dnbGVkLiBTZWVuIG9uIG1hbnkgYW4gYXBwLgogICAgICoKICAgICAqIFRoZSByaWdodCBvciBsZWZ0IG1lbnUgY2FuIGJlIGRpc2FibGVkIG9yIG5vdCB1c2VkIGF0IGFsbCwgaWYgZGVzaXJlZC4KICAgICAqLwogICAgaW9uaWMuY29udHJvbGxlcnMuU2lkZU1lbnVDb250cm9sbGVyID0gaW9uaWMuY29udHJvbGxlcnMuVmlld0NvbnRyb2xsZXIuaW5oZXJpdCh7CiAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAgIHRoaXMubGVmdCA9IG9wdGlvbnMubGVmdDsKICAgICAgICB0aGlzLnJpZ2h0ID0gb3B0aW9ucy5yaWdodDsKICAgICAgICB0aGlzLmNvbnRlbnQgPSBvcHRpb25zLmNvbnRlbnQ7CiAgICAgICAgdGhpcy5kcmFnVGhyZXNob2xkWCA9IG9wdGlvbnMuZHJhZ1RocmVzaG9sZFggfHwgMTA7CgogICAgICAgIHRoaXMuX3JpZ2h0U2hvd2luZyA9IGZhbHNlOwogICAgICAgIHRoaXMuX2xlZnRTaG93aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5faXNEcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgICBpZih0aGlzLmNvbnRlbnQpIHsKICAgICAgICAgIHRoaXMuY29udGVudC5vbkRyYWcgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIHNlbGYuX2hhbmRsZURyYWcoZSk7CiAgICAgICAgICB9OwoKICAgICAgICAgIHRoaXMuY29udGVudC5vbkVuZERyYWcgPWZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgc2VsZi5fZW5kRHJhZyhlKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9LAogICAgICAvKioKICAgICAgICogU2V0IHRoZSBjb250ZW50IHZpZXcgY29udHJvbGxlciBpZiBub3QgcGFzc2VkIGluIHRoZSBjb25zdHJ1Y3RvciBvcHRpb25zLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge29iamVjdH0gY29udGVudAogICAgICAgKi8KICAgICAgc2V0Q29udGVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgdGhpcy5jb250ZW50ID0gY29udGVudDsKCiAgICAgICAgdGhpcy5jb250ZW50Lm9uRHJhZyA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHNlbGYuX2hhbmRsZURyYWcoZSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5jb250ZW50LmVuZERyYWcgPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICBzZWxmLl9lbmREcmFnKGUpOwogICAgICAgIH07CiAgICAgIH0sCgogICAgICBpc09wZW5MZWZ0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRPcGVuQW1vdW50KCkgPiAwOwogICAgICB9LAoKICAgICAgaXNPcGVuUmlnaHQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldE9wZW5BbW91bnQoKSA8IDA7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogVG9nZ2xlIHRoZSBsZWZ0IG1lbnUgdG8gb3BlbiAxMDAlCiAgICAgICAqLwogICAgICB0b2dnbGVMZWZ0OiBmdW5jdGlvbihzaG91bGRPcGVuKSB7CiAgICAgICAgdmFyIG9wZW5BbW91bnQgPSB0aGlzLmdldE9wZW5BbW91bnQoKTsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgc2hvdWxkT3BlbiA9IG9wZW5BbW91bnQgPD0gMDsKICAgICAgICB9CiAgICAgICAgdGhpcy5jb250ZW50LmVuYWJsZUFuaW1hdGlvbigpOwogICAgICAgIGlmKCFzaG91bGRPcGVuKSB7CiAgICAgICAgICB0aGlzLm9wZW5QZXJjZW50YWdlKDApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLm9wZW5QZXJjZW50YWdlKDEwMCk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIFRvZ2dsZSB0aGUgcmlnaHQgbWVudSB0byBvcGVuIDEwMCUKICAgICAgICovCiAgICAgIHRvZ2dsZVJpZ2h0OiBmdW5jdGlvbihzaG91bGRPcGVuKSB7CiAgICAgICAgdmFyIG9wZW5BbW91bnQgPSB0aGlzLmdldE9wZW5BbW91bnQoKTsKICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgc2hvdWxkT3BlbiA9IG9wZW5BbW91bnQgPj0gMDsKICAgICAgICB9CiAgICAgICAgdGhpcy5jb250ZW50LmVuYWJsZUFuaW1hdGlvbigpOwogICAgICAgIGlmKCFzaG91bGRPcGVuKSB7CiAgICAgICAgICB0aGlzLm9wZW5QZXJjZW50YWdlKDApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLm9wZW5QZXJjZW50YWdlKC0xMDApOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBDbG9zZSBhbGwgbWVudXMuCiAgICAgICAqLwogICAgICBjbG9zZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAcmV0dXJuIHtmbG9hdH0gVGhlIGFtb3VudCB0aGUgc2lkZSBtZW51IGlzIG9wZW4sIGVpdGhlciBwb3NpdGl2ZSBvciBuZWdhdGl2ZSBmb3IgbGVmdCAocG9zaXRpdmUpLCBvciByaWdodCAobmVnYXRpdmUpCiAgICAgICAqLwogICAgICBnZXRPcGVuQW1vdW50OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb250ZW50ICYmIHRoaXMuY29udGVudC5nZXRUcmFuc2xhdGVYKCkgfHwgMDsKICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBAcmV0dXJuIHtmbG9hdH0gVGhlIHJhdGlvIG9mIG9wZW4gYW1vdW50IG92ZXIgbWVudSB3aWR0aC4gRm9yIGV4YW1wbGUsIGEKICAgICAgICogbWVudSBvZiB3aWR0aCAxMDAgb3BlbiA1MCBwaXhlbHMgd291bGQgYmUgb3BlbiA1MCUgb3IgYSByYXRpbyBvZiAwLjUuIFZhbHVlIGlzIG5lZ2F0aXZlCiAgICAgICAqIGZvciByaWdodCBtZW51LgogICAgICAgKi8KICAgICAgZ2V0T3BlblJhdGlvOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYW1vdW50ID0gdGhpcy5nZXRPcGVuQW1vdW50KCk7CiAgICAgICAgaWYoYW1vdW50ID49IDApIHsKICAgICAgICAgIHJldHVybiBhbW91bnQgLyB0aGlzLmxlZnQud2lkdGg7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhbW91bnQgLyB0aGlzLnJpZ2h0LndpZHRoOwogICAgICB9LAoKICAgICAgaXNPcGVuOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRPcGVuQW1vdW50KCkgIT09IDA7CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQHJldHVybiB7ZmxvYXR9IFRoZSBwZXJjZW50YWdlIG9mIG9wZW4gYW1vdW50IG92ZXIgbWVudSB3aWR0aC4gRm9yIGV4YW1wbGUsIGEKICAgICAgICogbWVudSBvZiB3aWR0aCAxMDAgb3BlbiA1MCBwaXhlbHMgd291bGQgYmUgb3BlbiA1MCUuIFZhbHVlIGlzIG5lZ2F0aXZlCiAgICAgICAqIGZvciByaWdodCBtZW51LgogICAgICAgKi8KICAgICAgZ2V0T3BlblBlcmNlbnRhZ2U6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldE9wZW5SYXRpbygpICogMTAwOwogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIE9wZW4gdGhlIG1lbnUgd2l0aCBhIGdpdmVuIHBlcmNlbnRhZ2UgYW1vdW50LgogICAgICAgKiBAcGFyYW0ge2Zsb2F0fSBwZXJjZW50YWdlIFRoZSBwZXJjZW50YWdlIChwb3NpdGl2ZSBvciBuZWdhdGl2ZSBmb3IgbGVmdC9yaWdodCkgdG8gb3BlbiB0aGUgbWVudS4KICAgICAgICovCiAgICAgIG9wZW5QZXJjZW50YWdlOiBmdW5jdGlvbihwZXJjZW50YWdlKSB7CiAgICAgICAgdmFyIHAgPSBwZXJjZW50YWdlIC8gMTAwOwoKICAgICAgICBpZih0aGlzLmxlZnQgJiYgcGVyY2VudGFnZSA+PSAwKSB7CiAgICAgICAgICB0aGlzLm9wZW5BbW91bnQodGhpcy5sZWZ0LndpZHRoICogcCk7CiAgICAgICAgfSBlbHNlIGlmKHRoaXMucmlnaHQgJiYgcGVyY2VudGFnZSA8IDApIHsKICAgICAgICAgIHZhciBtYXhSaWdodCA9IHRoaXMucmlnaHQud2lkdGg7CiAgICAgICAgICB0aGlzLm9wZW5BbW91bnQodGhpcy5yaWdodC53aWR0aCAqIHApOwogICAgICAgIH0KCiAgICAgICAgaWYocGVyY2VudGFnZSAhPT0gMCkgewogICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKCdtZW51LW9wZW4nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdtZW51LW9wZW4nKTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogT3BlbiB0aGUgbWVudSB0aGUgZ2l2ZW4gcGl4ZWwgYW1vdW50LgogICAgICAgKiBAcGFyYW0ge2Zsb2F0fSBhbW91bnQgdGhlIHBpeGVsIGFtb3VudCB0byBvcGVuIHRoZSBtZW51LiBQb3NpdGl2ZSB2YWx1ZSBmb3IgbGVmdCBtZW51LAogICAgICAgKiBuZWdhdGl2ZSB2YWx1ZSBmb3IgcmlnaHQgbWVudSAob25seSBvbmUgbWVudSB3aWxsIGJlIHZpc2libGUgYXQgYSB0aW1lKS4KICAgICAgICovCiAgICAgIG9wZW5BbW91bnQ6IGZ1bmN0aW9uKGFtb3VudCkgewogICAgICAgIHZhciBtYXhMZWZ0ID0gdGhpcy5sZWZ0ICYmIHRoaXMubGVmdC53aWR0aCB8fCAwOwogICAgICAgIHZhciBtYXhSaWdodCA9IHRoaXMucmlnaHQgJiYgdGhpcy5yaWdodC53aWR0aCB8fCAwOwoKICAgICAgICAvLyBDaGVjayBpZiB3ZSBjYW4gbW92ZSB0byB0aGF0IHNpZGUsIGRlcGVuZGluZyBpZiB0aGUgbGVmdC9yaWdodCBwYW5lbCBpcyBlbmFibGVkCiAgICAgICAgaWYoISh0aGlzLmxlZnQgJiYgdGhpcy5sZWZ0LmlzRW5hYmxlZCkgJiYgYW1vdW50ID4gMCkgewogICAgICAgICAgdGhpcy5jb250ZW50LnNldFRyYW5zbGF0ZVgoMCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZighKHRoaXMucmlnaHQgJiYgdGhpcy5yaWdodC5pc0VuYWJsZWQpICYmIGFtb3VudCA8IDApIHsKICAgICAgICAgIHRoaXMuY29udGVudC5zZXRUcmFuc2xhdGVYKDApOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYodGhpcy5fbGVmdFNob3dpbmcgJiYgYW1vdW50ID4gbWF4TGVmdCkgewogICAgICAgICAgdGhpcy5jb250ZW50LnNldFRyYW5zbGF0ZVgobWF4TGVmdCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZih0aGlzLl9yaWdodFNob3dpbmcgJiYgYW1vdW50IDwgLW1heFJpZ2h0KSB7CiAgICAgICAgICB0aGlzLmNvbnRlbnQuc2V0VHJhbnNsYXRlWCgtbWF4UmlnaHQpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb250ZW50LnNldFRyYW5zbGF0ZVgoYW1vdW50KTsKCiAgICAgICAgaWYoYW1vdW50ID49IDApIHsKICAgICAgICAgIHRoaXMuX2xlZnRTaG93aW5nID0gdHJ1ZTsKICAgICAgICAgIHRoaXMuX3JpZ2h0U2hvd2luZyA9IGZhbHNlOwoKICAgICAgICAgIGlmKGFtb3VudCA+IDApIHsKICAgICAgICAgICAgLy8gUHVzaCB0aGUgei1pbmRleCBvZiB0aGUgcmlnaHQgbWVudSBkb3duCiAgICAgICAgICAgIHRoaXMucmlnaHQgJiYgdGhpcy5yaWdodC5wdXNoRG93biAmJiB0aGlzLnJpZ2h0LnB1c2hEb3duKCk7CiAgICAgICAgICAgIC8vIEJyaW5nIHRoZSB6LWluZGV4IG9mIHRoZSBsZWZ0IG1lbnUgdXAKICAgICAgICAgICAgdGhpcy5sZWZ0ICYmIHRoaXMubGVmdC5icmluZ1VwICYmIHRoaXMubGVmdC5icmluZ1VwKCk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX3JpZ2h0U2hvd2luZyA9IHRydWU7CiAgICAgICAgICB0aGlzLl9sZWZ0U2hvd2luZyA9IGZhbHNlOwoKICAgICAgICAgIC8vIEJyaW5nIHRoZSB6LWluZGV4IG9mIHRoZSByaWdodCBtZW51IHVwCiAgICAgICAgICB0aGlzLnJpZ2h0ICYmIHRoaXMucmlnaHQuYnJpbmdVcCAmJiB0aGlzLnJpZ2h0LmJyaW5nVXAoKTsKICAgICAgICAgIC8vIFB1c2ggdGhlIHotaW5kZXggb2YgdGhlIGxlZnQgbWVudSBkb3duCiAgICAgICAgICB0aGlzLmxlZnQgJiYgdGhpcy5sZWZ0LnB1c2hEb3duICYmIHRoaXMubGVmdC5wdXNoRG93bigpOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8qKgogICAgICAgKiBHaXZlbiBhbiBldmVudCBvYmplY3QsIGZpbmQgdGhlIGZpbmFsIHJlc3RpbmcgcG9zaXRpb24gb2YgdGhpcyBzaWRlCiAgICAgICAqIG1lbnUuIEZvciBleGFtcGxlLCBpZiB0aGUgdXNlciAidGhyb3dzIiB0aGUgY29udGVudCB0byB0aGUgcmlnaHQgYW5kCiAgICAgICAqIHJlbGVhc2VzIHRoZSB0b3VjaCwgdGhlIGxlZnQgbWVudSBzaG91bGQgc25hcCBvcGVuIChhbmltYXRlZCwgb2YgY291cnNlKS4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtFdmVudH0gZSB0aGUgZ2VzdHVyZSBldmVudCB0byB1c2UgZm9yIHNuYXBwaW5nCiAgICAgICAqLwogICAgICBzbmFwVG9SZXN0OiBmdW5jdGlvbihlKSB7CiAgICAgICAgLy8gV2Ugd2FudCB0byBhbmltYXRlIGF0IHRoZSBlbmQgb2YgdGhpcwogICAgICAgIHRoaXMuY29udGVudC5lbmFibGVBbmltYXRpb24oKTsKICAgICAgICB0aGlzLl9pc0RyYWdnaW5nID0gZmFsc2U7CgogICAgICAgIC8vIENoZWNrIGhvdyBtdWNoIHRoZSBwYW5lbCBpcyBvcGVuIGFmdGVyIHRoZSBkcmFnLCBhbmQKICAgICAgICAvLyB3aGF0IHRoZSBkcmFnIHZlbG9jaXR5IGlzCiAgICAgICAgdmFyIHJhdGlvID0gdGhpcy5nZXRPcGVuUmF0aW8oKTsKCiAgICAgICAgaWYocmF0aW8gPT09IDApIHsKICAgICAgICAgIC8vIEp1c3QgdG8gYmUgc2FmZQogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciB2ZWxvY2l0eVRocmVzaG9sZCA9IDAuMzsKICAgICAgICB2YXIgdmVsb2NpdHlYID0gZS5nZXN0dXJlLnZlbG9jaXR5WDsKICAgICAgICB2YXIgZGlyZWN0aW9uID0gZS5nZXN0dXJlLmRpcmVjdGlvbjsKCiAgICAgICAgLy8gTGVzcyB0aGFuIGhhbGYsIGdvaW5nIGxlZnQKICAgICAgICAvL2lmKHJhdGlvID4gMCAmJiByYXRpbyA8IDAuNSAmJiBkaXJlY3Rpb24gPT0gJ2xlZnQnICYmIHZlbG9jaXR5WCA8IHZlbG9jaXR5VGhyZXNob2xkKSB7CiAgICAgICAgLy90aGlzLm9wZW5QZXJjZW50YWdlKDApOwogICAgICAgIC8vfQoKICAgICAgICAvLyBHb2luZyByaWdodCwgbGVzcyB0aGFuIGhhbGYsIHRvbyBzbG93IChzbmFwIGJhY2spCiAgICAgICAgaWYocmF0aW8gPiAwICYmIHJhdGlvIDwgMC41ICYmIGRpcmVjdGlvbiA9PSAncmlnaHQnICYmIHZlbG9jaXR5WCA8IHZlbG9jaXR5VGhyZXNob2xkKSB7CiAgICAgICAgICB0aGlzLm9wZW5QZXJjZW50YWdlKDApOwogICAgICAgIH0KCiAgICAgICAgLy8gR29pbmcgbGVmdCwgbW9yZSB0aGFuIGhhbGYsIHRvbyBzbG93IChzbmFwIGJhY2spCiAgICAgICAgZWxzZSBpZihyYXRpbyA+IDAuNSAmJiBkaXJlY3Rpb24gPT0gJ2xlZnQnICYmIHZlbG9jaXR5WCA8IHZlbG9jaXR5VGhyZXNob2xkKSB7CiAgICAgICAgICB0aGlzLm9wZW5QZXJjZW50YWdlKDEwMCk7CiAgICAgICAgfQoKICAgICAgICAvLyBHb2luZyBsZWZ0LCBsZXNzIHRoYW4gaGFsZiwgdG9vIHNsb3cgKHNuYXAgYmFjaykKICAgICAgICBlbHNlIGlmKHJhdGlvIDwgMCAmJiByYXRpbyA+IC0wLjUgJiYgZGlyZWN0aW9uID09ICdsZWZ0JyAmJiB2ZWxvY2l0eVggPCB2ZWxvY2l0eVRocmVzaG9sZCkgewogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgwKTsKICAgICAgICB9CgogICAgICAgIC8vIEdvaW5nIHJpZ2h0LCBtb3JlIHRoYW4gaGFsZiwgdG9vIHNsb3cgKHNuYXAgYmFjaykKICAgICAgICBlbHNlIGlmKHJhdGlvIDwgMC41ICYmIGRpcmVjdGlvbiA9PSAncmlnaHQnICYmIHZlbG9jaXR5WCA8IHZlbG9jaXR5VGhyZXNob2xkKSB7CiAgICAgICAgICB0aGlzLm9wZW5QZXJjZW50YWdlKC0xMDApOwogICAgICAgIH0KCiAgICAgICAgLy8gR29pbmcgcmlnaHQsIG1vcmUgdGhhbiBoYWxmLCBvciBxdWlja2x5IChzbmFwIG9wZW4pCiAgICAgICAgZWxzZSBpZihkaXJlY3Rpb24gPT0gJ3JpZ2h0JyAmJiByYXRpbyA+PSAwICYmIChyYXRpbyA+PSAwLjUgfHwgdmVsb2NpdHlYID4gdmVsb2NpdHlUaHJlc2hvbGQpKSB7CiAgICAgICAgICB0aGlzLm9wZW5QZXJjZW50YWdlKDEwMCk7CiAgICAgICAgfQoKICAgICAgICAvLyBHb2luZyBsZWZ0LCBtb3JlIHRoYW4gaGFsZiwgb3IgcXVpY2tseSAoc3BhbiBvcGVuKQogICAgICAgIGVsc2UgaWYoZGlyZWN0aW9uID09ICdsZWZ0JyAmJiByYXRpbyA8PSAwICYmIChyYXRpbyA8PSAtMC41IHx8IHZlbG9jaXR5WCA+IHZlbG9jaXR5VGhyZXNob2xkKSkgewogICAgICAgICAgdGhpcy5vcGVuUGVyY2VudGFnZSgtMTAwKTsKICAgICAgICB9CgogICAgICAgIC8vIFNuYXAgYmFjayBmb3Igc2FmZXR5CiAgICAgICAgZWxzZSB7CiAgICAgICAgICB0aGlzLm9wZW5QZXJjZW50YWdlKDApOwogICAgICAgIH0KICAgICAgfSwKCiAgICAgIC8vIEVuZCBhIGRyYWcgd2l0aCB0aGUgZ2l2ZW4gZXZlbnQKICAgICAgX2VuZERyYWc6IGZ1bmN0aW9uKGUpIHsKICAgICAgICBpZih0aGlzLl9pc0RyYWdnaW5nKSB7CiAgICAgICAgICB0aGlzLnNuYXBUb1Jlc3QoZSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3N0YXJ0WCA9IG51bGw7CiAgICAgICAgdGhpcy5fbGFzdFggPSBudWxsOwogICAgICAgIHRoaXMuX29mZnNldFggPSBudWxsOwogICAgICB9LAoKICAgICAgLy8gSGFuZGxlIGEgZHJhZyBldmVudAogICAgICBfaGFuZGxlRHJhZzogZnVuY3Rpb24oZSkgewoKICAgICAgICAvLyBJZiB3ZSBkb24ndCBoYXZlIHN0YXJ0IGNvb3JkcywgZ3JhYiBhbmQgc3RvcmUgdGhlbQogICAgICAgIGlmKCF0aGlzLl9zdGFydFgpIHsKICAgICAgICAgIHRoaXMuX3N0YXJ0WCA9IGUuZ2VzdHVyZS50b3VjaGVzWzBdLnBhZ2VYOwogICAgICAgICAgdGhpcy5fbGFzdFggPSB0aGlzLl9zdGFydFg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEdyYWIgdGhlIGN1cnJlbnQgdGFwIGNvb3JkcwogICAgICAgICAgdGhpcy5fbGFzdFggPSBlLmdlc3R1cmUudG91Y2hlc1swXS5wYWdlWDsKICAgICAgICB9CgogICAgICAgIC8vIENhbGN1bGF0ZSBkaWZmZXJlbmNlIGZyb20gdGhlIHRhcCBwb2ludHMKICAgICAgICBpZighdGhpcy5faXNEcmFnZ2luZyAmJiBNYXRoLmFicyh0aGlzLl9sYXN0WCAtIHRoaXMuX3N0YXJ0WCkgPiB0aGlzLmRyYWdUaHJlc2hvbGRYKSB7CiAgICAgICAgICAvLyBpZiB0aGUgZGlmZmVyZW5jZSBpcyBncmVhdGVyIHRoYW4gdGhyZXNob2xkLCBzdGFydCBkcmFnZ2luZyB1c2luZyB0aGUgY3VycmVudAogICAgICAgICAgLy8gcG9pbnQgYXMgdGhlIHN0YXJ0aW5nIHBvaW50CiAgICAgICAgICB0aGlzLl9zdGFydFggPSB0aGlzLl9sYXN0WDsKCiAgICAgICAgICB0aGlzLl9pc0RyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgIC8vIEluaXRpYWxpemUgZHJhZ2dpbmcKICAgICAgICAgIHRoaXMuY29udGVudC5kaXNhYmxlQW5pbWF0aW9uKCk7CiAgICAgICAgICB0aGlzLl9vZmZzZXRYID0gdGhpcy5nZXRPcGVuQW1vdW50KCk7CiAgICAgICAgfQoKICAgICAgICBpZih0aGlzLl9pc0RyYWdnaW5nKSB7CiAgICAgICAgICB0aGlzLm9wZW5BbW91bnQodGhpcy5fb2Zmc2V0WCArICh0aGlzLl9sYXN0WCAtIHRoaXMuX3N0YXJ0WCkpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CgogIH0pKGlvbmljKTsKCn0pKCk7Ci8qIQogKiBpb25pYy5idW5kbGUuanMgaXMgYSBjb25jYXRlbmF0aW9uIG9mOgogKiBpb25pYy5qcywgYW5ndWxhci5qcywgYW5ndWxhci1hbmltYXRlLmpzLAogKiBhbmd1bGFyLXNhbml0aXplLmpzLCBhbmd1bGFyLXVpLXJvdXRlci5qcywKICogYW5kIGlvbmljLWFuZ3VsYXIuanMKICovCgovKioKICogQGxpY2Vuc2UgQW5ndWxhckpTIHYxLjIuMTcKICogKGMpIDIwMTAtMjAxNCBHb29nbGUsIEluYy4gaHR0cDovL2FuZ3VsYXJqcy5vcmcKICogTGljZW5zZTogTUlUCiAqLwooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKSB7J3VzZSBzdHJpY3QnOwoKICAvKioKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIFRoaXMgb2JqZWN0IHByb3ZpZGVzIGEgdXRpbGl0eSBmb3IgcHJvZHVjaW5nIHJpY2ggRXJyb3IgbWVzc2FnZXMgd2l0aGluCiAgICogQW5ndWxhci4gSXQgY2FuIGJlIGNhbGxlZCBhcyBmb2xsb3dzOgogICAqCiAgICogdmFyIGV4YW1wbGVNaW5FcnIgPSBtaW5FcnIoJ2V4YW1wbGUnKTsKICAgKiB0aHJvdyBleGFtcGxlTWluRXJyKCdvbmUnLCAnVGhpcyB7MH0gaXMgezF9JywgZm9vLCBiYXIpOwogICAqCiAgICogVGhlIGFib3ZlIGNyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgbWluRXJyIGluIHRoZSBleGFtcGxlIG5hbWVzcGFjZS4gVGhlCiAgICogcmVzdWx0aW5nIGVycm9yIHdpbGwgaGF2ZSBhIG5hbWVzcGFjZWQgZXJyb3IgY29kZSBvZiBleGFtcGxlLm9uZS4gIFRoZQogICAqIHJlc3VsdGluZyBlcnJvciB3aWxsIHJlcGxhY2UgezB9IHdpdGggdGhlIHZhbHVlIG9mIGZvbywgYW5kIHsxfSB3aXRoIHRoZQogICAqIHZhbHVlIG9mIGJhci4gVGhlIG9iamVjdCBpcyBub3QgcmVzdHJpY3RlZCBpbiB0aGUgbnVtYmVyIG9mIGFyZ3VtZW50cyBpdCBjYW4KICAgKiB0YWtlLgogICAqCiAgICogSWYgZmV3ZXIgYXJndW1lbnRzIGFyZSBzcGVjaWZpZWQgdGhhbiBuZWNlc3NhcnkgZm9yIGludGVycG9sYXRpb24sIHRoZSBleHRyYQogICAqIGludGVycG9sYXRpb24gbWFya2VycyB3aWxsIGJlIHByZXNlcnZlZCBpbiB0aGUgZmluYWwgc3RyaW5nLgogICAqCiAgICogU2luY2UgZGF0YSB3aWxsIGJlIHBhcnNlZCBzdGF0aWNhbGx5IGR1cmluZyBhIGJ1aWxkIHN0ZXAsIHNvbWUgcmVzdHJpY3Rpb25zCiAgICogYXJlIGFwcGxpZWQgd2l0aCByZXNwZWN0IHRvIGhvdyBtaW5FcnIgaW5zdGFuY2VzIGFyZSBjcmVhdGVkIGFuZCBjYWxsZWQuCiAgICogSW5zdGFuY2VzIHNob3VsZCBoYXZlIG5hbWVzIG9mIHRoZSBmb3JtIG5hbWVzcGFjZU1pbkVyciBmb3IgYSBtaW5FcnIgY3JlYXRlZAogICAqIHVzaW5nIG1pbkVycignbmFtZXNwYWNlJykgLiBFcnJvciBjb2RlcywgbmFtZXNwYWNlcyBhbmQgdGVtcGxhdGUgc3RyaW5ncwogICAqIHNob3VsZCBhbGwgYmUgc3RhdGljIHN0cmluZ3MsIG5vdCB2YXJpYWJsZXMgb3IgZ2VuZXJhbCBleHByZXNzaW9ucy4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGUgVGhlIG5hbWVzcGFjZSB0byB1c2UgZm9yIHRoZSBuZXcgbWluRXJyIGluc3RhbmNlLgogICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb2RlOnN0cmluZywgdGVtcGxhdGU6c3RyaW5nLCAuLi50ZW1wbGF0ZUFyZ3MpOiBFcnJvcn0gbWluRXJyIGluc3RhbmNlCiAgICovCgogIGZ1bmN0aW9uIG1pbkVycihtb2R1bGUpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBjb2RlID0gYXJndW1lbnRzWzBdLAogICAgICAgIHByZWZpeCA9ICdbJyArIChtb2R1bGUgPyBtb2R1bGUgKyAnOicgOiAnJykgKyBjb2RlICsgJ10gJywKICAgICAgICB0ZW1wbGF0ZSA9IGFyZ3VtZW50c1sxXSwKICAgICAgICB0ZW1wbGF0ZUFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgc3RyaW5naWZ5ID0gZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgaWYgKHR5cGVvZiBvYmogPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgcmV0dXJuIG9iai50b1N0cmluZygpLnJlcGxhY2UoLyBce1tcc1xTXSokLywgJycpOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICByZXR1cm4gJ3VuZGVmaW5lZCc7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmogIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmopOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG9iajsKICAgICAgICB9LAogICAgICAgIG1lc3NhZ2UsIGk7CgogICAgICBtZXNzYWdlID0gcHJlZml4ICsgdGVtcGxhdGUucmVwbGFjZSgvXHtcZCtcfS9nLCBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICB2YXIgaW5kZXggPSArbWF0Y2guc2xpY2UoMSwgLTEpLCBhcmc7CgogICAgICAgIGlmIChpbmRleCArIDIgPCB0ZW1wbGF0ZUFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICBhcmcgPSB0ZW1wbGF0ZUFyZ3NbaW5kZXggKyAyXTsKICAgICAgICAgIGlmICh0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIHJldHVybiBhcmcudG9TdHJpbmcoKS5yZXBsYWNlKC8gP1x7W1xzXFNdKiQvLCAnJyk7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcmcgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHJldHVybiAndW5kZWZpbmVkJzsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZyAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgcmV0dXJuIHRvSnNvbihhcmcpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFyZzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICB9KTsKCiAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlICsgJ1xuaHR0cDovL2Vycm9ycy5hbmd1bGFyanMub3JnLzEuMi4xNy8nICsKICAgICAgICAobW9kdWxlID8gbW9kdWxlICsgJy8nIDogJycpICsgY29kZTsKICAgICAgZm9yIChpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlICsgKGkgPT0gMiA/ICc/JyA6ICcmJykgKyAncCcgKyAoaS0yKSArICc9JyArCiAgICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoc3RyaW5naWZ5KGFyZ3VtZW50c1tpXSkpOwogICAgICB9CgogICAgICByZXR1cm4gbmV3IEVycm9yKG1lc3NhZ2UpOwogICAgfTsKICB9CgogIC8qIFdlIG5lZWQgdG8gdGVsbCBqc2hpbnQgd2hhdCB2YXJpYWJsZXMgYXJlIGJlaW5nIGV4cG9ydGVkICovCiAgLyogZ2xvYmFsCiAgIC1hbmd1bGFyLAogICAtbXNpZSwKICAgLWpxTGl0ZSwKICAgLWpRdWVyeSwKICAgLXNsaWNlLAogICAtcHVzaCwKICAgLXRvU3RyaW5nLAogICAtbmdNaW5FcnIsCiAgIC1hbmd1bGFyTW9kdWxlLAogICAtbm9kZU5hbWVfLAogICAtdWlkLAoKICAgLWxvd2VyY2FzZSwKICAgLXVwcGVyY2FzZSwKICAgLW1hbnVhbExvd2VyY2FzZSwKICAgLW1hbnVhbFVwcGVyY2FzZSwKICAgLW5vZGVOYW1lXywKICAgLWlzQXJyYXlMaWtlLAogICAtZm9yRWFjaCwKICAgLXNvcnRlZEtleXMsCiAgIC1mb3JFYWNoU29ydGVkLAogICAtcmV2ZXJzZVBhcmFtcywKICAgLW5leHRVaWQsCiAgIC1zZXRIYXNoS2V5LAogICAtZXh0ZW5kLAogICAtaW50LAogICAtaW5oZXJpdCwKICAgLW5vb3AsCiAgIC1pZGVudGl0eSwKICAgLXZhbHVlRm4sCiAgIC1pc1VuZGVmaW5lZCwKICAgLWlzRGVmaW5lZCwKICAgLWlzT2JqZWN0LAogICAtaXNTdHJpbmcsCiAgIC1pc051bWJlciwKICAgLWlzRGF0ZSwKICAgLWlzQXJyYXksCiAgIC1pc0Z1bmN0aW9uLAogICAtaXNSZWdFeHAsCiAgIC1pc1dpbmRvdywKICAgLWlzU2NvcGUsCiAgIC1pc0ZpbGUsCiAgIC1pc0Jsb2IsCiAgIC1pc0Jvb2xlYW4sCiAgIC10cmltLAogICAtaXNFbGVtZW50LAogICAtbWFrZU1hcCwKICAgLW1hcCwKICAgLXNpemUsCiAgIC1pbmNsdWRlcywKICAgLWluZGV4T2YsCiAgIC1hcnJheVJlbW92ZSwKICAgLWlzTGVhZk5vZGUsCiAgIC1jb3B5LAogICAtc2hhbGxvd0NvcHksCiAgIC1lcXVhbHMsCiAgIC1jc3AsCiAgIC1jb25jYXQsCiAgIC1zbGljZUFyZ3MsCiAgIC1iaW5kLAogICAtdG9Kc29uUmVwbGFjZXIsCiAgIC10b0pzb24sCiAgIC1mcm9tSnNvbiwKICAgLXRvQm9vbGVhbiwKICAgLXN0YXJ0aW5nVGFnLAogICAtdHJ5RGVjb2RlVVJJQ29tcG9uZW50LAogICAtcGFyc2VLZXlWYWx1ZSwKICAgLXRvS2V5VmFsdWUsCiAgIC1lbmNvZGVVcmlTZWdtZW50LAogICAtZW5jb2RlVXJpUXVlcnksCiAgIC1hbmd1bGFySW5pdCwKICAgLWJvb3RzdHJhcCwKICAgLXNuYWtlX2Nhc2UsCiAgIC1iaW5kSlF1ZXJ5LAogICAtYXNzZXJ0QXJnLAogICAtYXNzZXJ0QXJnRm4sCiAgIC1hc3NlcnROb3RIYXNPd25Qcm9wZXJ0eSwKICAgLWdldHRlciwKICAgLWdldEJsb2NrRWxlbWVudHMsCiAgIC1oYXNPd25Qcm9wZXJ0eSwKCiAgICovCgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgLyoqCiAgICogQG5nZG9jIG1vZHVsZQogICAqIEBuYW1lIG5nCiAgICogQG1vZHVsZSBuZwogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogIyBuZyAoY29yZSBtb2R1bGUpCiAgICogVGhlIG5nIG1vZHVsZSBpcyBsb2FkZWQgYnkgZGVmYXVsdCB3aGVuIGFuIEFuZ3VsYXJKUyBhcHBsaWNhdGlvbiBpcyBzdGFydGVkLiBUaGUgbW9kdWxlIGl0c2VsZgogICAqIGNvbnRhaW5zIHRoZSBlc3NlbnRpYWwgY29tcG9uZW50cyBmb3IgYW4gQW5ndWxhckpTIGFwcGxpY2F0aW9uIHRvIGZ1bmN0aW9uLiBUaGUgdGFibGUgYmVsb3cKICAgKiBsaXN0cyBhIGhpZ2ggbGV2ZWwgYnJlYWtkb3duIG9mIGVhY2ggb2YgdGhlIHNlcnZpY2VzL2ZhY3RvcmllcywgZmlsdGVycywgZGlyZWN0aXZlcyBhbmQgdGVzdGluZwogICAqIGNvbXBvbmVudHMgYXZhaWxhYmxlIHdpdGhpbiB0aGlzIGNvcmUgbW9kdWxlLgogICAqCiAgICogPGRpdiBkb2MtbW9kdWxlLWNvbXBvbmVudHM9Im5nIj48L2Rpdj4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5sb3dlcmNhc2UKICAgKiBAbW9kdWxlIG5nCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbiBDb252ZXJ0cyB0aGUgc3BlY2lmaWVkIHN0cmluZyB0byBsb3dlcmNhc2UuCiAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgY29udmVydGVkIHRvIGxvd2VyY2FzZS4KICAgKiBAcmV0dXJucyB7c3RyaW5nfSBMb3dlcmNhc2VkIHN0cmluZy4KICAgKi8KICB2YXIgbG93ZXJjYXNlID0gZnVuY3Rpb24oc3RyaW5nKXtyZXR1cm4gaXNTdHJpbmcoc3RyaW5nKSA/IHN0cmluZy50b0xvd2VyQ2FzZSgpIDogc3RyaW5nO307CiAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci51cHBlcmNhc2UKICAgKiBAbW9kdWxlIG5nCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbiBDb252ZXJ0cyB0aGUgc3BlY2lmaWVkIHN0cmluZyB0byB1cHBlcmNhc2UuCiAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBTdHJpbmcgdG8gYmUgY29udmVydGVkIHRvIHVwcGVyY2FzZS4KICAgKiBAcmV0dXJucyB7c3RyaW5nfSBVcHBlcmNhc2VkIHN0cmluZy4KICAgKi8KICB2YXIgdXBwZXJjYXNlID0gZnVuY3Rpb24oc3RyaW5nKXtyZXR1cm4gaXNTdHJpbmcoc3RyaW5nKSA/IHN0cmluZy50b1VwcGVyQ2FzZSgpIDogc3RyaW5nO307CgoKICB2YXIgbWFudWFsTG93ZXJjYXNlID0gZnVuY3Rpb24ocykgewogICAgLyoganNoaW50IGJpdHdpc2U6IGZhbHNlICovCiAgICByZXR1cm4gaXNTdHJpbmcocykKICAgICAgPyBzLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKGNoKSB7cmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSB8IDMyKTt9KQogICAgICA6IHM7CiAgfTsKICB2YXIgbWFudWFsVXBwZXJjYXNlID0gZnVuY3Rpb24ocykgewogICAgLyoganNoaW50IGJpdHdpc2U6IGZhbHNlICovCiAgICByZXR1cm4gaXNTdHJpbmcocykKICAgICAgPyBzLnJlcGxhY2UoL1thLXpdL2csIGZ1bmN0aW9uKGNoKSB7cmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSAmIH4zMik7fSkKICAgICAgOiBzOwogIH07CgoKLy8gU3RyaW5nI3RvTG93ZXJDYXNlIGFuZCBTdHJpbmcjdG9VcHBlckNhc2UgZG9uJ3QgcHJvZHVjZSBjb3JyZWN0IHJlc3VsdHMgaW4gYnJvd3NlcnMgd2l0aCBUdXJraXNoCi8vIGxvY2FsZSwgZm9yIHRoaXMgcmVhc29uIHdlIG5lZWQgdG8gZGV0ZWN0IHRoaXMgY2FzZSBhbmQgcmVkZWZpbmUgbG93ZXJjYXNlL3VwcGVyY2FzZSBtZXRob2RzCi8vIHdpdGggY29ycmVjdCBidXQgc2xvd2VyIGFsdGVybmF0aXZlcy4KICBpZiAoJ2knICE9PSAnSScudG9Mb3dlckNhc2UoKSkgewogICAgbG93ZXJjYXNlID0gbWFudWFsTG93ZXJjYXNlOwogICAgdXBwZXJjYXNlID0gbWFudWFsVXBwZXJjYXNlOwogIH0KCgogIHZhciAvKiogaG9sZHMgbWFqb3IgdmVyc2lvbiBudW1iZXIgZm9yIElFIG9yIE5hTiBmb3IgcmVhbCBicm93c2VycyAqLwogICAgbXNpZSwKICAgIGpxTGl0ZSwgICAgICAgICAgIC8vIGRlbGF5IGJpbmRpbmcgc2luY2UgalF1ZXJ5IGNvdWxkIGJlIGxvYWRlZCBhZnRlciB1cy4KICAgIGpRdWVyeSwgICAgICAgICAgIC8vIGRlbGF5IGJpbmRpbmcKICAgIHNsaWNlICAgICAgICAgICAgID0gW10uc2xpY2UsCiAgICBwdXNoICAgICAgICAgICAgICA9IFtdLnB1c2gsCiAgICB0b1N0cmluZyAgICAgICAgICA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcsCiAgICBuZ01pbkVyciAgICAgICAgICA9IG1pbkVycignbmcnKSwKCiAgICAvKiogQG5hbWUgYW5ndWxhciAqLwogICAgYW5ndWxhciAgICAgICAgICAgPSB3aW5kb3cuYW5ndWxhciB8fCAod2luZG93LmFuZ3VsYXIgPSB7fSksCiAgICBhbmd1bGFyTW9kdWxlLAogICAgbm9kZU5hbWVfLAogICAgdWlkICAgICAgICAgICAgICAgPSBbJzAnLCAnMCcsICcwJ107CgogIC8qKgogICAqIElFIDExIGNoYW5nZWQgdGhlIGZvcm1hdCBvZiB0aGUgVXNlckFnZW50IHN0cmluZy4KICAgKiBTZWUgaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNTM3NTAzLmFzcHgKICAgKi8KICBtc2llID0gaW50KCgvbXNpZSAoXGQrKS8uZXhlYyhsb3dlcmNhc2UobmF2aWdhdG9yLnVzZXJBZ2VudCkpIHx8IFtdKVsxXSk7CiAgaWYgKGlzTmFOKG1zaWUpKSB7CiAgICBtc2llID0gaW50KCgvdHJpZGVudFwvLio7IHJ2OihcZCspLy5leGVjKGxvd2VyY2FzZShuYXZpZ2F0b3IudXNlckFnZW50KSkgfHwgW10pWzFdKTsKICB9CgoKICAvKioKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7Kn0gb2JqCiAgICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIGBvYmpgIGlzIGFuIGFycmF5IG9yIGFycmF5LWxpa2Ugb2JqZWN0IChOb2RlTGlzdCwgQXJndW1lbnRzLAogICAqICAgICAgICAgICAgICAgICAgIFN0cmluZyAuLi4pCiAgICovCiAgZnVuY3Rpb24gaXNBcnJheUxpa2Uob2JqKSB7CiAgICBpZiAob2JqID09IG51bGwgfHwgaXNXaW5kb3cob2JqKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGg7CgogICAgaWYgKG9iai5ub2RlVHlwZSA9PT0gMSAmJiBsZW5ndGgpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgcmV0dXJuIGlzU3RyaW5nKG9iaikgfHwgaXNBcnJheShvYmopIHx8IGxlbmd0aCA9PT0gMCB8fAogICAgICB0eXBlb2YgbGVuZ3RoID09PSAnbnVtYmVyJyAmJiBsZW5ndGggPiAwICYmIChsZW5ndGggLSAxKSBpbiBvYmo7CiAgfQoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLmZvckVhY2gKICAgKiBAbW9kdWxlIG5nCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEludm9rZXMgdGhlIGBpdGVyYXRvcmAgZnVuY3Rpb24gb25jZSBmb3IgZWFjaCBpdGVtIGluIGBvYmpgIGNvbGxlY3Rpb24sIHdoaWNoIGNhbiBiZSBlaXRoZXIgYW4KICAgKiBvYmplY3Qgb3IgYW4gYXJyYXkuIFRoZSBgaXRlcmF0b3JgIGZ1bmN0aW9uIGlzIGludm9rZWQgd2l0aCBgaXRlcmF0b3IodmFsdWUsIGtleSlgLCB3aGVyZSBgdmFsdWVgCiAgICogaXMgdGhlIHZhbHVlIG9mIGFuIG9iamVjdCBwcm9wZXJ0eSBvciBhbiBhcnJheSBlbGVtZW50IGFuZCBga2V5YCBpcyB0aGUgb2JqZWN0IHByb3BlcnR5IGtleSBvcgogICAqIGFycmF5IGVsZW1lbnQgaW5kZXguIFNwZWNpZnlpbmcgYSBgY29udGV4dGAgZm9yIHRoZSBmdW5jdGlvbiBpcyBvcHRpb25hbC4KICAgKgogICAqIEl0IGlzIHdvcnRoIG5vdGluZyB0aGF0IGAuZm9yRWFjaGAgZG9lcyBub3QgaXRlcmF0ZSBvdmVyIGluaGVyaXRlZCBwcm9wZXJ0aWVzIGJlY2F1c2UgaXQgZmlsdGVycwogICAqIHVzaW5nIHRoZSBgaGFzT3duUHJvcGVydHlgIG1ldGhvZC4KICAgKgogICBgYGBqcwogICB2YXIgdmFsdWVzID0ge25hbWU6ICdtaXNrbycsIGdlbmRlcjogJ21hbGUnfTsKICAgdmFyIGxvZyA9IFtdOwogICBhbmd1bGFyLmZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICB0aGlzLnB1c2goa2V5ICsgJzogJyArIHZhbHVlKTsKICAgICB9LCBsb2cpOwogICBleHBlY3QobG9nKS50b0VxdWFsKFsnbmFtZTogbWlza28nLCAnZ2VuZGVyOiBtYWxlJ10pOwogICBgYGAKICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fSBvYmogT2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpdGVyYXRvciBJdGVyYXRvciBmdW5jdGlvbi4KICAgKiBAcGFyYW0ge09iamVjdD19IGNvbnRleHQgT2JqZWN0IHRvIGJlY29tZSBjb250ZXh0IChgdGhpc2ApIGZvciB0aGUgaXRlcmF0b3IgZnVuY3Rpb24uCiAgICogQHJldHVybnMge09iamVjdHxBcnJheX0gUmVmZXJlbmNlIHRvIGBvYmpgLgogICAqLwogIGZ1bmN0aW9uIGZvckVhY2gob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIGtleTsKICAgIGlmIChvYmopIHsKICAgICAgaWYgKGlzRnVuY3Rpb24ob2JqKSkgewogICAgICAgIGZvciAoa2V5IGluIG9iaikgewogICAgICAgICAgLy8gTmVlZCB0byBjaGVjayBpZiBoYXNPd25Qcm9wZXJ0eSBleGlzdHMsCiAgICAgICAgICAvLyBhcyBvbiBJRTggdGhlIHJlc3VsdCBvZiBxdWVyeVNlbGVjdG9yQWxsIGlzIGFuIG9iamVjdCB3aXRob3V0IGEgaGFzT3duUHJvcGVydHkgZnVuY3Rpb24KICAgICAgICAgIGlmIChrZXkgIT0gJ3Byb3RvdHlwZScgJiYga2V5ICE9ICdsZW5ndGgnICYmIGtleSAhPSAnbmFtZScgJiYgKCFvYmouaGFzT3duUHJvcGVydHkgfHwgb2JqLmhhc093blByb3BlcnR5KGtleSkpKSB7CiAgICAgICAgICAgIGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKG9iai5mb3JFYWNoICYmIG9iai5mb3JFYWNoICE9PSBmb3JFYWNoKSB7CiAgICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICB9IGVsc2UgaWYgKGlzQXJyYXlMaWtlKG9iaikpIHsKICAgICAgICBmb3IgKGtleSA9IDA7IGtleSA8IG9iai5sZW5ndGg7IGtleSsrKQogICAgICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIG9iajsKICB9CgogIGZ1bmN0aW9uIHNvcnRlZEtleXMob2JqKSB7CiAgICB2YXIga2V5cyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGtleXMuc29ydCgpOwogIH0KCiAgZnVuY3Rpb24gZm9yRWFjaFNvcnRlZChvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIga2V5cyA9IHNvcnRlZEtleXMob2JqKTsKICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpba2V5c1tpXV0sIGtleXNbaV0pOwogICAgfQogICAgcmV0dXJuIGtleXM7CiAgfQoKCiAgLyoqCiAgICogd2hlbiB1c2luZyBmb3JFYWNoIHRoZSBwYXJhbXMgYXJlIHZhbHVlLCBrZXksIGJ1dCBpdCBpcyBvZnRlbiB1c2VmdWwgdG8gaGF2ZSBrZXksIHZhbHVlLgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nLCAqKX0gaXRlcmF0b3JGbgogICAqIEByZXR1cm5zIHtmdW5jdGlvbigqLCBzdHJpbmcpfQogICAqLwogIGZ1bmN0aW9uIHJldmVyc2VQYXJhbXMoaXRlcmF0b3JGbikgewogICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsgaXRlcmF0b3JGbihrZXksIHZhbHVlKTsgfTsKICB9CgogIC8qKgogICAqIEEgY29uc2lzdGVudCB3YXkgb2YgY3JlYXRpbmcgdW5pcXVlIElEcyBpbiBhbmd1bGFyLiBUaGUgSUQgaXMgYSBzZXF1ZW5jZSBvZiBhbHBoYSBudW1lcmljCiAgICogY2hhcmFjdGVycyBzdWNoIGFzICcwMTJBQkMnLiBUaGUgcmVhc29uIHdoeSB3ZSBhcmUgbm90IHVzaW5nIHNpbXBseSBhIG51bWJlciBjb3VudGVyIGlzIHRoYXQKICAgKiB0aGUgbnVtYmVyIHN0cmluZyBnZXRzIGxvbmdlciBvdmVyIHRpbWUsIGFuZCBpdCBjYW4gYWxzbyBvdmVyZmxvdywgd2hlcmUgYXMgdGhlIG5leHRJZAogICAqIHdpbGwgZ3JvdyBtdWNoIHNsb3dlciwgaXQgaXMgYSBzdHJpbmcsIGFuZCBpdCB3aWxsIG5ldmVyIG92ZXJmbG93LgogICAqCiAgICogQHJldHVybnMge3N0cmluZ30gYW4gdW5pcXVlIGFscGhhLW51bWVyaWMgc3RyaW5nCiAgICovCiAgZnVuY3Rpb24gbmV4dFVpZCgpIHsKICAgIHZhciBpbmRleCA9IHVpZC5sZW5ndGg7CiAgICB2YXIgZGlnaXQ7CgogICAgd2hpbGUoaW5kZXgpIHsKICAgICAgaW5kZXgtLTsKICAgICAgZGlnaXQgPSB1aWRbaW5kZXhdLmNoYXJDb2RlQXQoMCk7CiAgICAgIGlmIChkaWdpdCA9PSA1NyAvKic5JyovKSB7CiAgICAgICAgdWlkW2luZGV4XSA9ICdBJzsKICAgICAgICByZXR1cm4gdWlkLmpvaW4oJycpOwogICAgICB9CiAgICAgIGlmIChkaWdpdCA9PSA5MCAgLyonWicqLykgewogICAgICAgIHVpZFtpbmRleF0gPSAnMCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdWlkW2luZGV4XSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoZGlnaXQgKyAxKTsKICAgICAgICByZXR1cm4gdWlkLmpvaW4oJycpOwogICAgICB9CiAgICB9CiAgICB1aWQudW5zaGlmdCgnMCcpOwogICAgcmV0dXJuIHVpZC5qb2luKCcnKTsKICB9CgoKICAvKioKICAgKiBTZXQgb3IgY2xlYXIgdGhlIGhhc2hrZXkgZm9yIGFuIG9iamVjdC4KICAgKiBAcGFyYW0gb2JqIG9iamVjdAogICAqIEBwYXJhbSBoIHRoZSBoYXNoa2V5ICghdHJ1dGh5IHRvIGRlbGV0ZSB0aGUgaGFzaGtleSkKICAgKi8KICBmdW5jdGlvbiBzZXRIYXNoS2V5KG9iaiwgaCkgewogICAgaWYgKGgpIHsKICAgICAgb2JqLiQkaGFzaEtleSA9IGg7CiAgICB9CiAgICBlbHNlIHsKICAgICAgZGVsZXRlIG9iai4kJGhhc2hLZXk7CiAgICB9CiAgfQoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLmV4dGVuZAogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRXh0ZW5kcyB0aGUgZGVzdGluYXRpb24gb2JqZWN0IGBkc3RgIGJ5IGNvcHlpbmcgYWxsIG9mIHRoZSBwcm9wZXJ0aWVzIGZyb20gdGhlIGBzcmNgIG9iamVjdChzKQogICAqIHRvIGBkc3RgLiBZb3UgY2FuIHNwZWNpZnkgbXVsdGlwbGUgYHNyY2Agb2JqZWN0cy4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBkc3QgRGVzdGluYXRpb24gb2JqZWN0LgogICAqIEBwYXJhbSB7Li4uT2JqZWN0fSBzcmMgU291cmNlIG9iamVjdChzKS4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZWZlcmVuY2UgdG8gYGRzdGAuCiAgICovCiAgZnVuY3Rpb24gZXh0ZW5kKGRzdCkgewogICAgdmFyIGggPSBkc3QuJCRoYXNoS2V5OwogICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uKG9iaikgewogICAgICBpZiAob2JqICE9PSBkc3QpIHsKICAgICAgICBmb3JFYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CgogICAgc2V0SGFzaEtleShkc3QsaCk7CiAgICByZXR1cm4gZHN0OwogIH0KCiAgZnVuY3Rpb24gaW50KHN0cikgewogICAgcmV0dXJuIHBhcnNlSW50KHN0ciwgMTApOwogIH0KCgogIGZ1bmN0aW9uIGluaGVyaXQocGFyZW50LCBleHRyYSkgewogICAgcmV0dXJuIGV4dGVuZChuZXcgKGV4dGVuZChmdW5jdGlvbigpIHt9LCB7cHJvdG90eXBlOnBhcmVudH0pKSgpLCBleHRyYSk7CiAgfQoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLm5vb3AKICAgKiBAbW9kdWxlIG5nCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEEgZnVuY3Rpb24gdGhhdCBwZXJmb3JtcyBubyBvcGVyYXRpb25zLiBUaGlzIGZ1bmN0aW9uIGNhbiBiZSB1c2VmdWwgd2hlbiB3cml0aW5nIGNvZGUgaW4gdGhlCiAgICogZnVuY3Rpb25hbCBzdHlsZS4KICAgYGBganMKICAgZnVuY3Rpb24gZm9vKGNhbGxiYWNrKSB7CiAgICAgICB2YXIgcmVzdWx0ID0gY2FsY3VsYXRlUmVzdWx0KCk7CiAgICAgICAoY2FsbGJhY2sgfHwgYW5ndWxhci5ub29wKShyZXN1bHQpOwogICAgIH0KICAgYGBgCiAgICovCiAgZnVuY3Rpb24gbm9vcCgpIHt9CiAgbm9vcC4kaW5qZWN0ID0gW107CgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLmlkZW50aXR5CiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBpdHMgZmlyc3QgYXJndW1lbnQuIFRoaXMgZnVuY3Rpb24gaXMgdXNlZnVsIHdoZW4gd3JpdGluZyBjb2RlIGluIHRoZQogICAqIGZ1bmN0aW9uYWwgc3R5bGUuCiAgICoKICAgYGBganMKICAgZnVuY3Rpb24gdHJhbnNmb3JtZXIodHJhbnNmb3JtYXRpb25GbiwgdmFsdWUpIHsKICAgICAgIHJldHVybiAodHJhbnNmb3JtYXRpb25GbiB8fCBhbmd1bGFyLmlkZW50aXR5KSh2YWx1ZSk7CiAgICAgfTsKICAgYGBgCiAgICovCiAgZnVuY3Rpb24gaWRlbnRpdHkoJCkge3JldHVybiAkO30KICBpZGVudGl0eS4kaW5qZWN0ID0gW107CgoKICBmdW5jdGlvbiB2YWx1ZUZuKHZhbHVlKSB7cmV0dXJuIGZ1bmN0aW9uKCkge3JldHVybiB2YWx1ZTt9O30KCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5pc1VuZGVmaW5lZAogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyB1bmRlZmluZWQuCiAgICoKICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIHVuZGVmaW5lZC4KICAgKi8KICBmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCc7fQoKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5pc0RlZmluZWQKICAgKiBAbW9kdWxlIG5nCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgZGVmaW5lZC4KICAgKgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgZGVmaW5lZC4KICAgKi8KICBmdW5jdGlvbiBpc0RlZmluZWQodmFsdWUpe3JldHVybiB0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnO30KCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuaXNPYmplY3QKICAgKiBAbW9kdWxlIG5nCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYW4gYE9iamVjdGAuIFVubGlrZSBgdHlwZW9mYCBpbiBKYXZhU2NyaXB0LCBgbnVsbGBzIGFyZSBub3QKICAgKiBjb25zaWRlcmVkIHRvIGJlIG9iamVjdHMuIE5vdGUgdGhhdCBKYXZhU2NyaXB0IGFycmF5cyBhcmUgb2JqZWN0cy4KICAgKgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgUmVmZXJlbmNlIHRvIGNoZWNrLgogICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgYW4gYE9iamVjdGAgYnV0IG5vdCBgbnVsbGAuCiAgICovCiAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpe3JldHVybiB2YWx1ZSAhPSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCc7fQoKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5pc1N0cmluZwogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhIGBTdHJpbmdgLgogICAqCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBTdHJpbmdgLgogICAqLwogIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKXtyZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJzt9CgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLmlzTnVtYmVyCiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgYE51bWJlcmAuCiAgICoKICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYE51bWJlcmAuCiAgICovCiAgZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpe3JldHVybiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInO30KCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuaXNEYXRlCiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZXRlcm1pbmVzIGlmIGEgdmFsdWUgaXMgYSBkYXRlLgogICAqCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBEYXRlYC4KICAgKi8KICBmdW5jdGlvbiBpc0RhdGUodmFsdWUpIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gJ1tvYmplY3QgRGF0ZV0nOwogIH0KCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuaXNBcnJheQogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGV0ZXJtaW5lcyBpZiBhIHJlZmVyZW5jZSBpcyBhbiBgQXJyYXlgLgogICAqCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhbiBgQXJyYXlgLgogICAqLwogIGZ1bmN0aW9uIGlzQXJyYXkodmFsdWUpIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKICB9CgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLmlzRnVuY3Rpb24KICAgKiBAbW9kdWxlIG5nCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERldGVybWluZXMgaWYgYSByZWZlcmVuY2UgaXMgYSBgRnVuY3Rpb25gLgogICAqCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIGBGdW5jdGlvbmAuCiAgICovCiAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSl7cmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJzt9CgoKICAvKioKICAgKiBEZXRlcm1pbmVzIGlmIGEgdmFsdWUgaXMgYSByZWd1bGFyIGV4cHJlc3Npb24gb2JqZWN0LgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0geyp9IHZhbHVlIFJlZmVyZW5jZSB0byBjaGVjay4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiBgdmFsdWVgIGlzIGEgYFJlZ0V4cGAuCiAgICovCiAgZnVuY3Rpb24gaXNSZWdFeHAodmFsdWUpIHsKICAgIHJldHVybiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gJ1tvYmplY3QgUmVnRXhwXSc7CiAgfQoKCiAgLyoqCiAgICogQ2hlY2tzIGlmIGBvYmpgIGlzIGEgd2luZG93IG9iamVjdC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHsqfSBvYmogT2JqZWN0IHRvIGNoZWNrCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYG9iamAgaXMgYSB3aW5kb3cgb2JqLgogICAqLwogIGZ1bmN0aW9uIGlzV2luZG93KG9iaikgewogICAgcmV0dXJuIG9iaiAmJiBvYmouZG9jdW1lbnQgJiYgb2JqLmxvY2F0aW9uICYmIG9iai5hbGVydCAmJiBvYmouc2V0SW50ZXJ2YWw7CiAgfQoKCiAgZnVuY3Rpb24gaXNTY29wZShvYmopIHsKICAgIHJldHVybiBvYmogJiYgb2JqLiRldmFsQXN5bmMgJiYgb2JqLiR3YXRjaDsKICB9CgoKICBmdW5jdGlvbiBpc0ZpbGUob2JqKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBGaWxlXSc7CiAgfQoKCiAgZnVuY3Rpb24gaXNCbG9iKG9iaikgewogICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgQmxvYl0nOwogIH0KCgogIGZ1bmN0aW9uIGlzQm9vbGVhbih2YWx1ZSkgewogICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nOwogIH0KCgogIHZhciB0cmltID0gKGZ1bmN0aW9uKCkgewogICAgLy8gbmF0aXZlIHRyaW0gaXMgd2F5IGZhc3RlcjogaHR0cDovL2pzcGVyZi5jb20vYW5ndWxhci10cmltLXRlc3QKICAgIC8vIGJ1dCBJRSBkb2Vzbid0IGhhdmUgaXQuLi4gOi0oCiAgICAvLyBUT0RPOiB3ZSBzaG91bGQgbW92ZSB0aGlzIGludG8gSUUvRVM1IHBvbHlmaWxsCiAgICBpZiAoIVN0cmluZy5wcm90b3R5cGUudHJpbSkgewogICAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gaXNTdHJpbmcodmFsdWUpID8gdmFsdWUucmVwbGFjZSgvXlxzXHMqLywgJycpLnJlcGxhY2UoL1xzXHMqJC8sICcnKSA6IHZhbHVlOwogICAgICB9OwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS50cmltKCkgOiB2YWx1ZTsKICAgIH07CiAgfSkoKTsKCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuaXNFbGVtZW50CiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZXRlcm1pbmVzIGlmIGEgcmVmZXJlbmNlIGlzIGEgRE9NIGVsZW1lbnQgKG9yIHdyYXBwZWQgalF1ZXJ5IGVsZW1lbnQpLgogICAqCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBpcyBhIERPTSBlbGVtZW50IChvciB3cmFwcGVkIGpRdWVyeSBlbGVtZW50KS4KICAgKi8KICBmdW5jdGlvbiBpc0VsZW1lbnQobm9kZSkgewogICAgcmV0dXJuICEhKG5vZGUgJiYKICAgICAgKG5vZGUubm9kZU5hbWUgIC8vIHdlIGFyZSBhIGRpcmVjdCBlbGVtZW50CiAgICAgICAgfHwgKG5vZGUucHJvcCAmJiBub2RlLmF0dHIgJiYgbm9kZS5maW5kKSkpOyAgLy8gd2UgaGF2ZSBhbiBvbiBhbmQgZmluZCBtZXRob2QgcGFydCBvZiBqUXVlcnkgQVBJCiAgfQoKICAvKioKICAgKiBAcGFyYW0gc3RyICdrZXkxLGtleTIsLi4uJwogICAqIEByZXR1cm5zIHtvYmplY3R9IGluIHRoZSBmb3JtIG9mIHtrZXkxOnRydWUsIGtleTI6dHJ1ZSwgLi4ufQogICAqLwogIGZ1bmN0aW9uIG1ha2VNYXAoc3RyKSB7CiAgICB2YXIgb2JqID0ge30sIGl0ZW1zID0gc3RyLnNwbGl0KCIsIiksIGk7CiAgICBmb3IgKCBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrICkKICAgICAgb2JqWyBpdGVtc1tpXSBdID0gdHJ1ZTsKICAgIHJldHVybiBvYmo7CiAgfQoKCiAgaWYgKG1zaWUgPCA5KSB7CiAgICBub2RlTmFtZV8gPSBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgIGVsZW1lbnQgPSBlbGVtZW50Lm5vZGVOYW1lID8gZWxlbWVudCA6IGVsZW1lbnRbMF07CiAgICAgIHJldHVybiAoZWxlbWVudC5zY29wZU5hbWUgJiYgZWxlbWVudC5zY29wZU5hbWUgIT0gJ0hUTUwnKQogICAgICAgID8gdXBwZXJjYXNlKGVsZW1lbnQuc2NvcGVOYW1lICsgJzonICsgZWxlbWVudC5ub2RlTmFtZSkgOiBlbGVtZW50Lm5vZGVOYW1lOwogICAgfTsKICB9IGVsc2UgewogICAgbm9kZU5hbWVfID0gZnVuY3Rpb24oZWxlbWVudCkgewogICAgICByZXR1cm4gZWxlbWVudC5ub2RlTmFtZSA/IGVsZW1lbnQubm9kZU5hbWUgOiBlbGVtZW50WzBdLm5vZGVOYW1lOwogICAgfTsKICB9CgoKICBmdW5jdGlvbiBtYXAob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgIGZvckVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgcmVzdWx0cy5wdXNoKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH0KCgogIC8qKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERldGVybWluZXMgdGhlIG51bWJlciBvZiBlbGVtZW50cyBpbiBhbiBhcnJheSwgdGhlIG51bWJlciBvZiBwcm9wZXJ0aWVzIGFuIG9iamVjdCBoYXMsIG9yCiAgICogdGhlIGxlbmd0aCBvZiBhIHN0cmluZy4KICAgKgogICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0byBhdWdtZW50IHRoZSBPYmplY3QgdHlwZSBpbiBBbmd1bGFyIGV4cHJlc3Npb25zLiBTZWUKICAgKiB7QGxpbmsgYW5ndWxhci5PYmplY3R9IGZvciBtb3JlIGluZm9ybWF0aW9uIGFib3V0IEFuZ3VsYXIgYXJyYXlzLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R8QXJyYXl8c3RyaW5nfSBvYmogT2JqZWN0LCBhcnJheSwgb3Igc3RyaW5nIHRvIGluc3BlY3QuCiAgICogQHBhcmFtIHtib29sZWFufSBbb3duUHJvcHNPbmx5PWZhbHNlXSBDb3VudCBvbmx5ICJvd24iIHByb3BlcnRpZXMgaW4gYW4gb2JqZWN0CiAgICogQHJldHVybnMge251bWJlcn0gVGhlIHNpemUgb2YgYG9iamAgb3IgYDBgIGlmIGBvYmpgIGlzIG5laXRoZXIgYW4gb2JqZWN0IG5vciBhbiBhcnJheS4KICAgKi8KICBmdW5jdGlvbiBzaXplKG9iaiwgb3duUHJvcHNPbmx5KSB7CiAgICB2YXIgY291bnQgPSAwLCBrZXk7CgogICAgaWYgKGlzQXJyYXkob2JqKSB8fCBpc1N0cmluZyhvYmopKSB7CiAgICAgIHJldHVybiBvYmoubGVuZ3RoOwogICAgfSBlbHNlIGlmIChpc09iamVjdChvYmopKSB7CiAgICAgIGZvciAoa2V5IGluIG9iaikKICAgICAgICBpZiAoIW93blByb3BzT25seSB8fCBvYmouaGFzT3duUHJvcGVydHkoa2V5KSkKICAgICAgICAgIGNvdW50Kys7CiAgICB9CgogICAgcmV0dXJuIGNvdW50OwogIH0KCgogIGZ1bmN0aW9uIGluY2x1ZGVzKGFycmF5LCBvYmopIHsKICAgIHJldHVybiBpbmRleE9mKGFycmF5LCBvYmopICE9IC0xOwogIH0KCiAgZnVuY3Rpb24gaW5kZXhPZihhcnJheSwgb2JqKSB7CiAgICBpZiAoYXJyYXkuaW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2Yob2JqKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChvYmogPT09IGFycmF5W2ldKSByZXR1cm4gaTsKICAgIH0KICAgIHJldHVybiAtMTsKICB9CgogIGZ1bmN0aW9uIGFycmF5UmVtb3ZlKGFycmF5LCB2YWx1ZSkgewogICAgdmFyIGluZGV4ID0gaW5kZXhPZihhcnJheSwgdmFsdWUpOwogICAgaWYgKGluZGV4ID49MCkKICAgICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKTsKICAgIHJldHVybiB2YWx1ZTsKICB9CgogIGZ1bmN0aW9uIGlzTGVhZk5vZGUgKG5vZGUpIHsKICAgIGlmIChub2RlKSB7CiAgICAgIHN3aXRjaCAobm9kZS5ub2RlTmFtZSkgewogICAgICAgIGNhc2UgIk9QVElPTiI6CiAgICAgICAgY2FzZSAiUFJFIjoKICAgICAgICBjYXNlICJUSVRMRSI6CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5jb3B5CiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDcmVhdGVzIGEgZGVlcCBjb3B5IG9mIGBzb3VyY2VgLCB3aGljaCBzaG91bGQgYmUgYW4gb2JqZWN0IG9yIGFuIGFycmF5LgogICAqCiAgICogKiBJZiBubyBkZXN0aW5hdGlvbiBpcyBzdXBwbGllZCwgYSBjb3B5IG9mIHRoZSBvYmplY3Qgb3IgYXJyYXkgaXMgY3JlYXRlZC4KICAgKiAqIElmIGEgZGVzdGluYXRpb24gaXMgcHJvdmlkZWQsIGFsbCBvZiBpdHMgZWxlbWVudHMgKGZvciBhcnJheSkgb3IgcHJvcGVydGllcyAoZm9yIG9iamVjdHMpCiAgICogICBhcmUgZGVsZXRlZCBhbmQgdGhlbiBhbGwgZWxlbWVudHMvcHJvcGVydGllcyBmcm9tIHRoZSBzb3VyY2UgYXJlIGNvcGllZCB0byBpdC4KICAgKiAqIElmIGBzb3VyY2VgIGlzIG5vdCBhbiBvYmplY3Qgb3IgYXJyYXkgKGluYy4gYG51bGxgIGFuZCBgdW5kZWZpbmVkYCksIGBzb3VyY2VgIGlzIHJldHVybmVkLgogICAqICogSWYgYHNvdXJjZWAgaXMgaWRlbnRpY2FsIHRvICdkZXN0aW5hdGlvbicgYW4gZXhjZXB0aW9uIHdpbGwgYmUgdGhyb3duLgogICAqCiAgICogQHBhcmFtIHsqfSBzb3VyY2UgVGhlIHNvdXJjZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBtYWtlIGEgY29weS4KICAgKiAgICAgICAgICAgICAgICAgICBDYW4gYmUgYW55IHR5cGUsIGluY2x1ZGluZyBwcmltaXRpdmVzLCBgbnVsbGAsIGFuZCBgdW5kZWZpbmVkYC4KICAgKiBAcGFyYW0geyhPYmplY3R8QXJyYXkpPX0gZGVzdGluYXRpb24gRGVzdGluYXRpb24gaW50byB3aGljaCB0aGUgc291cmNlIGlzIGNvcGllZC4gSWYKICAgKiAgICAgcHJvdmlkZWQsIG11c3QgYmUgb2YgdGhlIHNhbWUgdHlwZSBhcyBgc291cmNlYC4KICAgKiBAcmV0dXJucyB7Kn0gVGhlIGNvcHkgb3IgdXBkYXRlZCBgZGVzdGluYXRpb25gLCBpZiBgZGVzdGluYXRpb25gIHdhcyBzcGVjaWZpZWQuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ29udHJvbGxlciI+CiAgIDxmb3JtIG5vdmFsaWRhdGUgY2xhc3M9InNpbXBsZS1mb3JtIj4KICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJ1c2VyLm5hbWUiIC8+PGJyIC8+CiAgIEUtbWFpbDogPGlucHV0IHR5cGU9ImVtYWlsIiBuZy1tb2RlbD0idXNlci5lbWFpbCIgLz48YnIgLz4KICAgR2VuZGVyOiA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJ1c2VyLmdlbmRlciIgdmFsdWU9Im1hbGUiIC8+bWFsZQogICA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJ1c2VyLmdlbmRlciIgdmFsdWU9ImZlbWFsZSIgLz5mZW1hbGU8YnIgLz4KICAgPGJ1dHRvbiBuZy1jbGljaz0icmVzZXQoKSI+UkVTRVQ8L2J1dHRvbj4KICAgPGJ1dHRvbiBuZy1jbGljaz0idXBkYXRlKHVzZXIpIj5TQVZFPC9idXR0b24+CiAgIDwvZm9ybT4KICAgPHByZT5mb3JtID0ge3t1c2VyIHwganNvbn19PC9wcmU+CiAgIDxwcmU+bWFzdGVyID0ge3ttYXN0ZXIgfCBqc29ufX08L3ByZT4KICAgPC9kaXY+CgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBDb250cm9sbGVyKCRzY29wZSkgewogICAgJHNjb3BlLm1hc3Rlcj0ge307CgogICAgJHNjb3BlLnVwZGF0ZSA9IGZ1bmN0aW9uKHVzZXIpIHsKICAgICAgLy8gRXhhbXBsZSB3aXRoIDEgYXJndW1lbnQKICAgICAgJHNjb3BlLm1hc3Rlcj0gYW5ndWxhci5jb3B5KHVzZXIpOwogICAgfTsKCiAgICAkc2NvcGUucmVzZXQgPSBmdW5jdGlvbigpIHsKICAgICAgLy8gRXhhbXBsZSB3aXRoIDIgYXJndW1lbnRzCiAgICAgIGFuZ3VsYXIuY29weSgkc2NvcGUubWFzdGVyLCAkc2NvcGUudXNlcik7CiAgICB9OwoKICAgICRzY29wZS5yZXNldCgpOwogIH0KICAgPC9zY3JpcHQ+CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIGZ1bmN0aW9uIGNvcHkoc291cmNlLCBkZXN0aW5hdGlvbiwgc3RhY2tTb3VyY2UsIHN0YWNrRGVzdCkgewogICAgaWYgKGlzV2luZG93KHNvdXJjZSkgfHwgaXNTY29wZShzb3VyY2UpKSB7CiAgICAgIHRocm93IG5nTWluRXJyKCdjcHdzJywKICAgICAgICAiQ2FuJ3QgY29weSEgTWFraW5nIGNvcGllcyBvZiBXaW5kb3cgb3IgU2NvcGUgaW5zdGFuY2VzIGlzIG5vdCBzdXBwb3J0ZWQuIik7CiAgICB9CgogICAgaWYgKCFkZXN0aW5hdGlvbikgewogICAgICBkZXN0aW5hdGlvbiA9IHNvdXJjZTsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgICAgIGRlc3RpbmF0aW9uID0gY29weShzb3VyY2UsIFtdLCBzdGFja1NvdXJjZSwgc3RhY2tEZXN0KTsKICAgICAgICB9IGVsc2UgaWYgKGlzRGF0ZShzb3VyY2UpKSB7CiAgICAgICAgICBkZXN0aW5hdGlvbiA9IG5ldyBEYXRlKHNvdXJjZS5nZXRUaW1lKCkpOwogICAgICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAoc291cmNlKSkgewogICAgICAgICAgZGVzdGluYXRpb24gPSBuZXcgUmVnRXhwKHNvdXJjZS5zb3VyY2UpOwogICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qoc291cmNlKSkgewogICAgICAgICAgZGVzdGluYXRpb24gPSBjb3B5KHNvdXJjZSwge30sIHN0YWNrU291cmNlLCBzdGFja0Rlc3QpOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKHNvdXJjZSA9PT0gZGVzdGluYXRpb24pIHRocm93IG5nTWluRXJyKCdjcGknLAogICAgICAgICJDYW4ndCBjb3B5ISBTb3VyY2UgYW5kIGRlc3RpbmF0aW9uIGFyZSBpZGVudGljYWwuIik7CgogICAgICBzdGFja1NvdXJjZSA9IHN0YWNrU291cmNlIHx8IFtdOwogICAgICBzdGFja0Rlc3QgPSBzdGFja0Rlc3QgfHwgW107CgogICAgICBpZiAoaXNPYmplY3Qoc291cmNlKSkgewogICAgICAgIHZhciBpbmRleCA9IGluZGV4T2Yoc3RhY2tTb3VyY2UsIHNvdXJjZSk7CiAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkgcmV0dXJuIHN0YWNrRGVzdFtpbmRleF07CgogICAgICAgIHN0YWNrU291cmNlLnB1c2goc291cmNlKTsKICAgICAgICBzdGFja0Rlc3QucHVzaChkZXN0aW5hdGlvbik7CiAgICAgIH0KCiAgICAgIHZhciByZXN1bHQ7CiAgICAgIGlmIChpc0FycmF5KHNvdXJjZSkpIHsKICAgICAgICBkZXN0aW5hdGlvbi5sZW5ndGggPSAwOwogICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNvdXJjZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmVzdWx0ID0gY29weShzb3VyY2VbaV0sIG51bGwsIHN0YWNrU291cmNlLCBzdGFja0Rlc3QpOwogICAgICAgICAgaWYgKGlzT2JqZWN0KHNvdXJjZVtpXSkpIHsKICAgICAgICAgICAgc3RhY2tTb3VyY2UucHVzaChzb3VyY2VbaV0pOwogICAgICAgICAgICBzdGFja0Rlc3QucHVzaChyZXN1bHQpOwogICAgICAgICAgfQogICAgICAgICAgZGVzdGluYXRpb24ucHVzaChyZXN1bHQpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgaCA9IGRlc3RpbmF0aW9uLiQkaGFzaEtleTsKICAgICAgICBmb3JFYWNoKGRlc3RpbmF0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBkZWxldGUgZGVzdGluYXRpb25ba2V5XTsKICAgICAgICB9KTsKICAgICAgICBmb3IgKCB2YXIga2V5IGluIHNvdXJjZSkgewogICAgICAgICAgcmVzdWx0ID0gY29weShzb3VyY2Vba2V5XSwgbnVsbCwgc3RhY2tTb3VyY2UsIHN0YWNrRGVzdCk7CiAgICAgICAgICBpZiAoaXNPYmplY3Qoc291cmNlW2tleV0pKSB7CiAgICAgICAgICAgIHN0YWNrU291cmNlLnB1c2goc291cmNlW2tleV0pOwogICAgICAgICAgICBzdGFja0Rlc3QucHVzaChyZXN1bHQpOwogICAgICAgICAgfQogICAgICAgICAgZGVzdGluYXRpb25ba2V5XSA9IHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgc2V0SGFzaEtleShkZXN0aW5hdGlvbixoKTsKICAgICAgfQoKICAgIH0KICAgIHJldHVybiBkZXN0aW5hdGlvbjsKICB9CgogIC8qKgogICAqIENyZWF0ZXMgYSBzaGFsbG93IGNvcHkgb2YgYW4gb2JqZWN0LCBhbiBhcnJheSBvciBhIHByaW1pdGl2ZQogICAqLwogIGZ1bmN0aW9uIHNoYWxsb3dDb3B5KHNyYywgZHN0KSB7CiAgICBpZiAoaXNBcnJheShzcmMpKSB7CiAgICAgIGRzdCA9IGRzdCB8fCBbXTsKCiAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHNyYy5sZW5ndGg7IGkrKykgewogICAgICAgIGRzdFtpXSA9IHNyY1tpXTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc09iamVjdChzcmMpKSB7CiAgICAgIGRzdCA9IGRzdCB8fCB7fTsKCiAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIHsKICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzcmMsIGtleSkgJiYgIShrZXkuY2hhckF0KDApID09PSAnJCcgJiYga2V5LmNoYXJBdCgxKSA9PT0gJyQnKSkgewogICAgICAgICAgZHN0W2tleV0gPSBzcmNba2V5XTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZHN0IHx8IHNyYzsKICB9CgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLmVxdWFscwogICAqIEBtb2R1bGUgbmcKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGV0ZXJtaW5lcyBpZiB0d28gb2JqZWN0cyBvciB0d28gdmFsdWVzIGFyZSBlcXVpdmFsZW50LiBTdXBwb3J0cyB2YWx1ZSB0eXBlcywgcmVndWxhcgogICAqIGV4cHJlc3Npb25zLCBhcnJheXMgYW5kIG9iamVjdHMuCiAgICoKICAgKiBUd28gb2JqZWN0cyBvciB2YWx1ZXMgYXJlIGNvbnNpZGVyZWQgZXF1aXZhbGVudCBpZiBhdCBsZWFzdCBvbmUgb2YgdGhlIGZvbGxvd2luZyBpcyB0cnVlOgogICAqCiAgICogKiBCb3RoIG9iamVjdHMgb3IgdmFsdWVzIHBhc3MgYD09PWAgY29tcGFyaXNvbi4KICAgKiAqIEJvdGggb2JqZWN0cyBvciB2YWx1ZXMgYXJlIG9mIHRoZSBzYW1lIHR5cGUgYW5kIGFsbCBvZiB0aGVpciBwcm9wZXJ0aWVzIGFyZSBlcXVhbCBieQogICAqICAgY29tcGFyaW5nIHRoZW0gd2l0aCBgYW5ndWxhci5lcXVhbHNgLgogICAqICogQm90aCB2YWx1ZXMgYXJlIE5hTi4gKEluIEphdmFTY3JpcHQsIE5hTiA9PSBOYU4gPT4gZmFsc2UuIEJ1dCB3ZSBjb25zaWRlciB0d28gTmFOIGFzIGVxdWFsKQogICAqICogQm90aCB2YWx1ZXMgcmVwcmVzZW50IHRoZSBzYW1lIHJlZ3VsYXIgZXhwcmVzc2lvbiAoSW4gSmF2YVNjcmlwdCwKICAgKiAgIC9hYmMvID09IC9hYmMvID0+IGZhbHNlLiBCdXQgd2UgY29uc2lkZXIgdHdvIHJlZ3VsYXIgZXhwcmVzc2lvbnMgYXMgZXF1YWwgd2hlbiB0aGVpciB0ZXh0dWFsCiAgICogICByZXByZXNlbnRhdGlvbiBtYXRjaGVzKS4KICAgKgogICAqIER1cmluZyBhIHByb3BlcnR5IGNvbXBhcmlzb24sIHByb3BlcnRpZXMgb2YgYGZ1bmN0aW9uYCB0eXBlIGFuZCBwcm9wZXJ0aWVzIHdpdGggbmFtZXMKICAgKiB0aGF0IGJlZ2luIHdpdGggYCRgIGFyZSBpZ25vcmVkLgogICAqCiAgICogU2NvcGUgYW5kIERPTVdpbmRvdyBvYmplY3RzIGFyZSBiZWluZyBjb21wYXJlZCBvbmx5IGJ5IGlkZW50aWZ5IChgPT09YCkuCiAgICoKICAgKiBAcGFyYW0geyp9IG8xIE9iamVjdCBvciB2YWx1ZSB0byBjb21wYXJlLgogICAqIEBwYXJhbSB7Kn0gbzIgT2JqZWN0IG9yIHZhbHVlIHRvIGNvbXBhcmUuCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYXJndW1lbnRzIGFyZSBlcXVhbC4KICAgKi8KICBmdW5jdGlvbiBlcXVhbHMobzEsIG8yKSB7CiAgICBpZiAobzEgPT09IG8yKSByZXR1cm4gdHJ1ZTsKICAgIGlmIChvMSA9PT0gbnVsbCB8fCBvMiA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgaWYgKG8xICE9PSBvMSAmJiBvMiAhPT0gbzIpIHJldHVybiB0cnVlOyAvLyBOYU4gPT09IE5hTgogICAgdmFyIHQxID0gdHlwZW9mIG8xLCB0MiA9IHR5cGVvZiBvMiwgbGVuZ3RoLCBrZXksIGtleVNldDsKICAgIGlmICh0MSA9PSB0MikgewogICAgICBpZiAodDEgPT0gJ29iamVjdCcpIHsKICAgICAgICBpZiAoaXNBcnJheShvMSkpIHsKICAgICAgICAgIGlmICghaXNBcnJheShvMikpIHJldHVybiBmYWxzZTsKICAgICAgICAgIGlmICgobGVuZ3RoID0gbzEubGVuZ3RoKSA9PSBvMi5sZW5ndGgpIHsKICAgICAgICAgICAgZm9yKGtleT0wOyBrZXk8bGVuZ3RoOyBrZXkrKykgewogICAgICAgICAgICAgIGlmICghZXF1YWxzKG8xW2tleV0sIG8yW2tleV0pKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChpc0RhdGUobzEpKSB7CiAgICAgICAgICByZXR1cm4gaXNEYXRlKG8yKSAmJiBvMS5nZXRUaW1lKCkgPT0gbzIuZ2V0VGltZSgpOwogICAgICAgIH0gZWxzZSBpZiAoaXNSZWdFeHAobzEpICYmIGlzUmVnRXhwKG8yKSkgewogICAgICAgICAgcmV0dXJuIG8xLnRvU3RyaW5nKCkgPT0gbzIudG9TdHJpbmcoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGlzU2NvcGUobzEpIHx8IGlzU2NvcGUobzIpIHx8IGlzV2luZG93KG8xKSB8fCBpc1dpbmRvdyhvMikgfHwgaXNBcnJheShvMikpIHJldHVybiBmYWxzZTsKICAgICAgICAgIGtleVNldCA9IHt9OwogICAgICAgICAgZm9yKGtleSBpbiBvMSkgewogICAgICAgICAgICBpZiAoa2V5LmNoYXJBdCgwKSA9PT0gJyQnIHx8IGlzRnVuY3Rpb24obzFba2V5XSkpIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAoIWVxdWFscyhvMVtrZXldLCBvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBrZXlTZXRba2V5XSA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBmb3Ioa2V5IGluIG8yKSB7CiAgICAgICAgICAgIGlmICgha2V5U2V0Lmhhc093blByb3BlcnR5KGtleSkgJiYKICAgICAgICAgICAgICBrZXkuY2hhckF0KDApICE9PSAnJCcgJiYKICAgICAgICAgICAgICBvMltrZXldICE9PSB1bmRlZmluZWQgJiYKICAgICAgICAgICAgICAhaXNGdW5jdGlvbihvMltrZXldKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKCiAgZnVuY3Rpb24gY3NwKCkgewogICAgcmV0dXJuIChkb2N1bWVudC5zZWN1cml0eVBvbGljeSAmJiBkb2N1bWVudC5zZWN1cml0eVBvbGljeS5pc0FjdGl2ZSkgfHwKICAgICAgKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IgJiYKICAgICAgICAhIShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbbmctY3NwXScpIHx8IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLW5nLWNzcF0nKSkpOwogIH0KCgogIGZ1bmN0aW9uIGNvbmNhdChhcnJheTEsIGFycmF5MiwgaW5kZXgpIHsKICAgIHJldHVybiBhcnJheTEuY29uY2F0KHNsaWNlLmNhbGwoYXJyYXkyLCBpbmRleCkpOwogIH0KCiAgZnVuY3Rpb24gc2xpY2VBcmdzKGFyZ3MsIHN0YXJ0SW5kZXgpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFyZ3MsIHN0YXJ0SW5kZXggfHwgMCk7CiAgfQoKCiAgLyoganNoaW50IC1XMTAxICovCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5iaW5kCiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gd2hpY2ggY2FsbHMgZnVuY3Rpb24gYGZuYCBib3VuZCB0byBgc2VsZmAgKGBzZWxmYCBiZWNvbWVzIHRoZSBgdGhpc2AgZm9yCiAgICogYGZuYCkuIFlvdSBjYW4gc3VwcGx5IG9wdGlvbmFsIGBhcmdzYCB0aGF0IGFyZSBwcmVib3VuZCB0byB0aGUgZnVuY3Rpb24uIFRoaXMgZmVhdHVyZSBpcyBhbHNvCiAgICoga25vd24gYXMgW3BhcnRpYWwgYXBwbGljYXRpb25dKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUGFydGlhbF9hcHBsaWNhdGlvbiksIGFzCiAgICogZGlzdGluZ3Vpc2hlZCBmcm9tIFtmdW5jdGlvbiBjdXJyeWluZ10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9DdXJyeWluZyNDb250cmFzdF93aXRoX3BhcnRpYWxfZnVuY3Rpb25fYXBwbGljYXRpb24pLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IHNlbGYgQ29udGV4dCB3aGljaCBgZm5gIHNob3VsZCBiZSBldmFsdWF0ZWQgaW4uCiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbiBGdW5jdGlvbiB0byBiZSBib3VuZC4KICAgKiBAcGFyYW0gey4uLip9IGFyZ3MgT3B0aW9uYWwgYXJndW1lbnRzIHRvIGJlIHByZWJvdW5kIHRvIHRoZSBgZm5gIGZ1bmN0aW9uIGNhbGwuCiAgICogQHJldHVybnMge2Z1bmN0aW9uKCl9IEZ1bmN0aW9uIHRoYXQgd3JhcHMgdGhlIGBmbmAgd2l0aCBhbGwgdGhlIHNwZWNpZmllZCBiaW5kaW5ncy4KICAgKi8KICAvKiBqc2hpbnQgK1cxMDEgKi8KICBmdW5jdGlvbiBiaW5kKHNlbGYsIGZuKSB7CiAgICB2YXIgY3VycnlBcmdzID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBzbGljZUFyZ3MoYXJndW1lbnRzLCAyKSA6IFtdOwogICAgaWYgKGlzRnVuY3Rpb24oZm4pICYmICEoZm4gaW5zdGFuY2VvZiBSZWdFeHApKSB7CiAgICAgIHJldHVybiBjdXJyeUFyZ3MubGVuZ3RoCiAgICAgICAgPyBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aAogICAgICAgICAgPyBmbi5hcHBseShzZWxmLCBjdXJyeUFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSkpCiAgICAgICAgICA6IGZuLmFwcGx5KHNlbGYsIGN1cnJ5QXJncyk7CiAgICAgIH0KICAgICAgICA6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoCiAgICAgICAgICA/IGZuLmFwcGx5KHNlbGYsIGFyZ3VtZW50cykKICAgICAgICAgIDogZm4uY2FsbChzZWxmKTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIGluIElFLCBuYXRpdmUgbWV0aG9kcyBhcmUgbm90IGZ1bmN0aW9ucyBzbyB0aGV5IGNhbm5vdCBiZSBib3VuZCAobm90ZTogdGhleSBkb24ndCBuZWVkIHRvIGJlKQogICAgICByZXR1cm4gZm47CiAgICB9CiAgfQoKCiAgZnVuY3Rpb24gdG9Kc29uUmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogICAgdmFyIHZhbCA9IHZhbHVlOwoKICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiBrZXkuY2hhckF0KDApID09PSAnJCcpIHsKICAgICAgdmFsID0gdW5kZWZpbmVkOwogICAgfSBlbHNlIGlmIChpc1dpbmRvdyh2YWx1ZSkpIHsKICAgICAgdmFsID0gJyRXSU5ET1cnOwogICAgfSBlbHNlIGlmICh2YWx1ZSAmJiAgZG9jdW1lbnQgPT09IHZhbHVlKSB7CiAgICAgIHZhbCA9ICckRE9DVU1FTlQnOwogICAgfSBlbHNlIGlmIChpc1Njb3BlKHZhbHVlKSkgewogICAgICB2YWwgPSAnJFNDT1BFJzsKICAgIH0KCiAgICByZXR1cm4gdmFsOwogIH0KCgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIudG9Kc29uCiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXJpYWxpemVzIGlucHV0IGludG8gYSBKU09OLWZvcm1hdHRlZCBzdHJpbmcuIFByb3BlcnRpZXMgd2l0aCBsZWFkaW5nICQgY2hhcmFjdGVycyB3aWxsIGJlCiAgICogc3RyaXBwZWQgc2luY2UgYW5ndWxhciB1c2VzIHRoaXMgbm90YXRpb24gaW50ZXJuYWxseS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fEFycmF5fERhdGV8c3RyaW5nfG51bWJlcn0gb2JqIElucHV0IHRvIGJlIHNlcmlhbGl6ZWQgaW50byBKU09OLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHByZXR0eSBJZiBzZXQgdG8gdHJ1ZSwgdGhlIEpTT04gb3V0cHV0IHdpbGwgY29udGFpbiBuZXdsaW5lcyBhbmQgd2hpdGVzcGFjZS4KICAgKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gSlNPTi1pZmllZCBzdHJpbmcgcmVwcmVzZW50aW5nIGBvYmpgLgogICAqLwogIGZ1bmN0aW9uIHRvSnNvbihvYmosIHByZXR0eSkgewogICAgaWYgKHR5cGVvZiBvYmogPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdW5kZWZpbmVkOwogICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaiwgdG9Kc29uUmVwbGFjZXIsIHByZXR0eSA/ICcgICcgOiBudWxsKTsKICB9CgoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSBhbmd1bGFyLmZyb21Kc29uCiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZXNlcmlhbGl6ZXMgYSBKU09OIHN0cmluZy4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBqc29uIEpTT04gc3RyaW5nIHRvIGRlc2VyaWFsaXplLgogICAqIEByZXR1cm5zIHtPYmplY3R8QXJyYXl8c3RyaW5nfG51bWJlcn0gRGVzZXJpYWxpemVkIHRoaW5neS4KICAgKi8KICBmdW5jdGlvbiBmcm9tSnNvbihqc29uKSB7CiAgICByZXR1cm4gaXNTdHJpbmcoanNvbikKICAgICAgPyBKU09OLnBhcnNlKGpzb24pCiAgICAgIDoganNvbjsKICB9CgoKICBmdW5jdGlvbiB0b0Jvb2xlYW4odmFsdWUpIHsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgdmFsdWUgPSB0cnVlOwogICAgfSBlbHNlIGlmICh2YWx1ZSAmJiB2YWx1ZS5sZW5ndGggIT09IDApIHsKICAgICAgdmFyIHYgPSBsb3dlcmNhc2UoIiIgKyB2YWx1ZSk7CiAgICAgIHZhbHVlID0gISh2ID09ICdmJyB8fCB2ID09ICcwJyB8fCB2ID09ICdmYWxzZScgfHwgdiA9PSAnbm8nIHx8IHYgPT0gJ24nIHx8IHYgPT0gJ1tdJyk7CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9IGZhbHNlOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0KCiAgLyoqCiAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBlbGVtZW50LgogICAqLwogIGZ1bmN0aW9uIHN0YXJ0aW5nVGFnKGVsZW1lbnQpIHsKICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCkuY2xvbmUoKTsKICAgIHRyeSB7CiAgICAgIC8vIHR1cm5zIG91dCBJRSBkb2VzIG5vdCBsZXQgeW91IHNldCAuaHRtbCgpIG9uIGVsZW1lbnRzIHdoaWNoCiAgICAgIC8vIGFyZSBub3QgYWxsb3dlZCB0byBoYXZlIGNoaWxkcmVuLiBTbyB3ZSBqdXN0IGlnbm9yZSBpdC4KICAgICAgZWxlbWVudC5lbXB0eSgpOwogICAgfSBjYXRjaChlKSB7fQogICAgLy8gQXMgUGVyIERPTSBTdGFuZGFyZHMKICAgIHZhciBURVhUX05PREUgPSAzOwogICAgdmFyIGVsZW1IdG1sID0ganFMaXRlKCc8ZGl2PicpLmFwcGVuZChlbGVtZW50KS5odG1sKCk7CiAgICB0cnkgewogICAgICByZXR1cm4gZWxlbWVudFswXS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gbG93ZXJjYXNlKGVsZW1IdG1sKSA6CiAgICAgICAgZWxlbUh0bWwuCiAgICAgICAgICBtYXRjaCgvXig8W14+XSs+KS8pWzFdLgogICAgICAgICAgcmVwbGFjZSgvXjwoW1x3XC1dKykvLCBmdW5jdGlvbihtYXRjaCwgbm9kZU5hbWUpIHsgcmV0dXJuICc8JyArIGxvd2VyY2FzZShub2RlTmFtZSk7IH0pOwogICAgfSBjYXRjaChlKSB7CiAgICAgIHJldHVybiBsb3dlcmNhc2UoZWxlbUh0bWwpOwogICAgfQoKICB9CgoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAvKioKICAgKiBUcmllcyB0byBkZWNvZGUgdGhlIFVSSSBjb21wb25lbnQgd2l0aG91dCB0aHJvd2luZyBhbiBleGNlcHRpb24uCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSBzdHIgdmFsdWUgcG90ZW50aWFsIFVSSSBjb21wb25lbnQgdG8gY2hlY2suCiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgYHZhbHVlYCBjYW4gYmUgZGVjb2RlZAogICAqIHdpdGggdGhlIGRlY29kZVVSSUNvbXBvbmVudCBmdW5jdGlvbi4KICAgKi8KICBmdW5jdGlvbiB0cnlEZWNvZGVVUklDb21wb25lbnQodmFsdWUpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgfSBjYXRjaChlKSB7CiAgICAgIC8vIElnbm9yZSBhbnkgaW52YWxpZCB1cmkgY29tcG9uZW50CiAgICB9CiAgfQoKCiAgLyoqCiAgICogUGFyc2VzIGFuIGVzY2FwZWQgdXJsIHF1ZXJ5IHN0cmluZyBpbnRvIGtleS12YWx1ZSBwYWlycy4KICAgKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsYm9vbGVhbnxBcnJheT59CiAgICovCiAgZnVuY3Rpb24gcGFyc2VLZXlWYWx1ZSgvKipzdHJpbmcqL2tleVZhbHVlKSB7CiAgICB2YXIgb2JqID0ge30sIGtleV92YWx1ZSwga2V5OwogICAgZm9yRWFjaCgoa2V5VmFsdWUgfHwgIiIpLnNwbGl0KCcmJyksIGZ1bmN0aW9uKGtleVZhbHVlKSB7CiAgICAgIGlmICgga2V5VmFsdWUgKSB7CiAgICAgICAga2V5X3ZhbHVlID0ga2V5VmFsdWUuc3BsaXQoJz0nKTsKICAgICAgICBrZXkgPSB0cnlEZWNvZGVVUklDb21wb25lbnQoa2V5X3ZhbHVlWzBdKTsKICAgICAgICBpZiAoIGlzRGVmaW5lZChrZXkpICkgewogICAgICAgICAgdmFyIHZhbCA9IGlzRGVmaW5lZChrZXlfdmFsdWVbMV0pID8gdHJ5RGVjb2RlVVJJQ29tcG9uZW50KGtleV92YWx1ZVsxXSkgOiB0cnVlOwogICAgICAgICAgaWYgKCFvYmpba2V5XSkgewogICAgICAgICAgICBvYmpba2V5XSA9IHZhbDsKICAgICAgICAgIH0gZWxzZSBpZihpc0FycmF5KG9ialtrZXldKSkgewogICAgICAgICAgICBvYmpba2V5XS5wdXNoKHZhbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvYmpba2V5XSA9IFtvYmpba2V5XSx2YWxdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH0KCiAgZnVuY3Rpb24gdG9LZXlWYWx1ZShvYmopIHsKICAgIHZhciBwYXJ0cyA9IFtdOwogICAgZm9yRWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgZm9yRWFjaCh2YWx1ZSwgZnVuY3Rpb24oYXJyYXlWYWx1ZSkgewogICAgICAgICAgcGFydHMucHVzaChlbmNvZGVVcmlRdWVyeShrZXksIHRydWUpICsKICAgICAgICAgICAgKGFycmF5VmFsdWUgPT09IHRydWUgPyAnJyA6ICc9JyArIGVuY29kZVVyaVF1ZXJ5KGFycmF5VmFsdWUsIHRydWUpKSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFydHMucHVzaChlbmNvZGVVcmlRdWVyeShrZXksIHRydWUpICsKICAgICAgICAgICh2YWx1ZSA9PT0gdHJ1ZSA/ICcnIDogJz0nICsgZW5jb2RlVXJpUXVlcnkodmFsdWUsIHRydWUpKSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHBhcnRzLmxlbmd0aCA/IHBhcnRzLmpvaW4oJyYnKSA6ICcnOwogIH0KCgogIC8qKgogICAqIFdlIG5lZWQgb3VyIGN1c3RvbSBtZXRob2QgYmVjYXVzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFnZ3Jlc3NpdmUgYW5kIGRvZXNuJ3QgZm9sbG93CiAgICogaHR0cDovL3d3dy5pZXRmLm9yZy9yZmMvcmZjMzk4Ni50eHQgd2l0aCByZWdhcmRzIHRvIHRoZSBjaGFyYWN0ZXIgc2V0IChwY2hhcikgYWxsb3dlZCBpbiBwYXRoCiAgICogc2VnbWVudHM6CiAgICogICAgc2VnbWVudCAgICAgICA9ICpwY2hhcgogICAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAgICogICAgcGN0LWVuY29kZWQgICA9ICIlIiBIRVhESUcgSEVYRElHCiAgICogICAgdW5yZXNlcnZlZCAgICA9IEFMUEhBIC8gRElHSVQgLyAiLSIgLyAiLiIgLyAiXyIgLyAifiIKICAgKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAgICogICAgICAgICAgICAgICAgICAgICAvICIqIiAvICIrIiAvICIsIiAvICI7IiAvICI9IgogICAqLwogIGZ1bmN0aW9uIGVuY29kZVVyaVNlZ21lbnQodmFsKSB7CiAgICByZXR1cm4gZW5jb2RlVXJpUXVlcnkodmFsLCB0cnVlKS4KICAgICAgcmVwbGFjZSgvJTI2L2dpLCAnJicpLgogICAgICByZXBsYWNlKC8lM0QvZ2ksICc9JykuCiAgICAgIHJlcGxhY2UoLyUyQi9naSwgJysnKTsKICB9CgoKICAvKioKICAgKiBUaGlzIG1ldGhvZCBpcyBpbnRlbmRlZCBmb3IgZW5jb2RpbmcgKmtleSogb3IgKnZhbHVlKiBwYXJ0cyBvZiBxdWVyeSBjb21wb25lbnQuIFdlIG5lZWQgYSBjdXN0b20KICAgKiBtZXRob2QgYmVjYXVzZSBlbmNvZGVVUklDb21wb25lbnQgaXMgdG9vIGFnZ3Jlc3NpdmUgYW5kIGVuY29kZXMgc3R1ZmYgdGhhdCBkb2Vzbid0IGhhdmUgdG8gYmUKICAgKiBlbmNvZGVkIHBlciBodHRwOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMzOTg2OgogICAqICAgIHF1ZXJ5ICAgICAgID0gKiggcGNoYXIgLyAiLyIgLyAiPyIgKQogICAqICAgIHBjaGFyICAgICAgICAgPSB1bnJlc2VydmVkIC8gcGN0LWVuY29kZWQgLyBzdWItZGVsaW1zIC8gIjoiIC8gIkAiCiAgICogICAgdW5yZXNlcnZlZCAgICA9IEFMUEhBIC8gRElHSVQgLyAiLSIgLyAiLiIgLyAiXyIgLyAifiIKICAgKiAgICBwY3QtZW5jb2RlZCAgID0gIiUiIEhFWERJRyBIRVhESUcKICAgKiAgICBzdWItZGVsaW1zICAgID0gIiEiIC8gIiQiIC8gIiYiIC8gIiciIC8gIigiIC8gIikiCiAgICogICAgICAgICAgICAgICAgICAgICAvICIqIiAvICIrIiAvICIsIiAvICI7IiAvICI9IgogICAqLwogIGZ1bmN0aW9uIGVuY29kZVVyaVF1ZXJ5KHZhbCwgcGN0RW5jb2RlU3BhY2VzKSB7CiAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkuCiAgICAgIHJlcGxhY2UoLyU0MC9naSwgJ0AnKS4KICAgICAgcmVwbGFjZSgvJTNBL2dpLCAnOicpLgogICAgICByZXBsYWNlKC8lMjQvZywgJyQnKS4KICAgICAgcmVwbGFjZSgvJTJDL2dpLCAnLCcpLgogICAgICByZXBsYWNlKC8lMjAvZywgKHBjdEVuY29kZVNwYWNlcyA/ICclMjAnIDogJysnKSk7CiAgfQoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nQXBwCiAgICogQG1vZHVsZSBuZwogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHBhcmFtIHthbmd1bGFyLk1vZHVsZX0gbmdBcHAgYW4gb3B0aW9uYWwgYXBwbGljYXRpb24KICAgKiAgIHtAbGluayBhbmd1bGFyLm1vZHVsZSBtb2R1bGV9IG5hbWUgdG8gbG9hZC4KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogVXNlIHRoaXMgZGlyZWN0aXZlIHRvICoqYXV0by1ib290c3RyYXAqKiBhbiBBbmd1bGFySlMgYXBwbGljYXRpb24uIFRoZSBgbmdBcHBgIGRpcmVjdGl2ZQogICAqIGRlc2lnbmF0ZXMgdGhlICoqcm9vdCBlbGVtZW50Kiogb2YgdGhlIGFwcGxpY2F0aW9uIGFuZCBpcyB0eXBpY2FsbHkgcGxhY2VkIG5lYXIgdGhlIHJvb3QgZWxlbWVudAogICAqIG9mIHRoZSBwYWdlIC0gZS5nLiBvbiB0aGUgYDxib2R5PmAgb3IgYDxodG1sPmAgdGFncy4KICAgKgogICAqIE9ubHkgb25lIEFuZ3VsYXJKUyBhcHBsaWNhdGlvbiBjYW4gYmUgYXV0by1ib290c3RyYXBwZWQgcGVyIEhUTUwgZG9jdW1lbnQuIFRoZSBmaXJzdCBgbmdBcHBgCiAgICogZm91bmQgaW4gdGhlIGRvY3VtZW50IHdpbGwgYmUgdXNlZCB0byBkZWZpbmUgdGhlIHJvb3QgZWxlbWVudCB0byBhdXRvLWJvb3RzdHJhcCBhcyBhbgogICAqIGFwcGxpY2F0aW9uLiBUbyBydW4gbXVsdGlwbGUgYXBwbGljYXRpb25zIGluIGFuIEhUTUwgZG9jdW1lbnQgeW91IG11c3QgbWFudWFsbHkgYm9vdHN0cmFwIHRoZW0gdXNpbmcKICAgKiB7QGxpbmsgYW5ndWxhci5ib290c3RyYXB9IGluc3RlYWQuIEFuZ3VsYXJKUyBhcHBsaWNhdGlvbnMgY2Fubm90IGJlIG5lc3RlZCB3aXRoaW4gZWFjaCBvdGhlci4KICAgKgogICAqIFlvdSBjYW4gc3BlY2lmeSBhbiAqKkFuZ3VsYXJKUyBtb2R1bGUqKiB0byBiZSB1c2VkIGFzIHRoZSByb290IG1vZHVsZSBmb3IgdGhlIGFwcGxpY2F0aW9uLiAgVGhpcwogICAqIG1vZHVsZSB3aWxsIGJlIGxvYWRlZCBpbnRvIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3J9IHdoZW4gdGhlIGFwcGxpY2F0aW9uIGlzIGJvb3RzdHJhcHBlZCBhbmQKICAgKiBzaG91bGQgY29udGFpbiB0aGUgYXBwbGljYXRpb24gY29kZSBuZWVkZWQgb3IgaGF2ZSBkZXBlbmRlbmNpZXMgb24gb3RoZXIgbW9kdWxlcyB0aGF0IHdpbGwKICAgKiBjb250YWluIHRoZSBjb2RlLiBTZWUge0BsaW5rIGFuZ3VsYXIubW9kdWxlfSBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgKgogICAqIEluIHRoZSBleGFtcGxlIGJlbG93IGlmIHRoZSBgbmdBcHBgIGRpcmVjdGl2ZSB3ZXJlIG5vdCBwbGFjZWQgb24gdGhlIGBodG1sYCBlbGVtZW50IHRoZW4gdGhlCiAgICogZG9jdW1lbnQgd291bGQgbm90IGJlIGNvbXBpbGVkLCB0aGUgYEFwcENvbnRyb2xsZXJgIHdvdWxkIG5vdCBiZSBpbnN0YW50aWF0ZWQgYW5kIHRoZSBge3sgYStiIH19YAogICAqIHdvdWxkIG5vdCBiZSByZXNvbHZlZCB0byBgM2AuCiAgICoKICAgKiBgbmdBcHBgIGlzIHRoZSBlYXNpZXN0LCBhbmQgbW9zdCBjb21tb24sIHdheSB0byBib290c3RyYXAgYW4gYXBwbGljYXRpb24uCiAgICoKICAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FwcERlbW8iPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJuZ0FwcERlbW9Db250cm9sbGVyIj4KICAgSSBjYW4gYWRkOiB7e2F9fSArIHt7Yn19ID0gIHt7IGErYiB9fQogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICBhbmd1bGFyLm1vZHVsZSgnbmdBcHBEZW1vJywgW10pLmNvbnRyb2xsZXIoJ25nQXBwRGVtb0NvbnRyb2xsZXInLCBmdW5jdGlvbigkc2NvcGUpIHsKICAgICAkc2NvcGUuYSA9IDE7CiAgICAgJHNjb3BlLmIgPSAyOwogICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICoKICAgKi8KICBmdW5jdGlvbiBhbmd1bGFySW5pdChlbGVtZW50LCBib290c3RyYXApIHsKICAgIHZhciBlbGVtZW50cyA9IFtlbGVtZW50XSwKICAgICAgYXBwRWxlbWVudCwKICAgICAgbW9kdWxlLAogICAgICBuYW1lcyA9IFsnbmc6YXBwJywgJ25nLWFwcCcsICd4LW5nLWFwcCcsICdkYXRhLW5nLWFwcCddLAogICAgICBOR19BUFBfQ0xBU1NfUkVHRVhQID0gL1xzbmdbOlwtXWFwcCg6XHMqKFtcd1xkX10rKTs/KT9ccy87CgogICAgZnVuY3Rpb24gYXBwZW5kKGVsZW1lbnQpIHsKICAgICAgZWxlbWVudCAmJiBlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogICAgfQoKICAgIGZvckVhY2gobmFtZXMsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgbmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICBhcHBlbmQoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobmFtZSkpOwogICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKCc6JywgJ1xcOicpOwogICAgICBpZiAoZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKSB7CiAgICAgICAgZm9yRWFjaChlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy4nICsgbmFtZSksIGFwcGVuZCk7CiAgICAgICAgZm9yRWFjaChlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy4nICsgbmFtZSArICdcXDonKSwgYXBwZW5kKTsKICAgICAgICBmb3JFYWNoKGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgnWycgKyBuYW1lICsgJ10nKSwgYXBwZW5kKTsKICAgICAgfQogICAgfSk7CgogICAgZm9yRWFjaChlbGVtZW50cywgZnVuY3Rpb24oZWxlbWVudCkgewogICAgICBpZiAoIWFwcEVsZW1lbnQpIHsKICAgICAgICB2YXIgY2xhc3NOYW1lID0gJyAnICsgZWxlbWVudC5jbGFzc05hbWUgKyAnICc7CiAgICAgICAgdmFyIG1hdGNoID0gTkdfQVBQX0NMQVNTX1JFR0VYUC5leGVjKGNsYXNzTmFtZSk7CiAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICBhcHBFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgIG1vZHVsZSA9IChtYXRjaFsyXSB8fCAnJykucmVwbGFjZSgvXHMrL2csICcsJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvckVhY2goZWxlbWVudC5hdHRyaWJ1dGVzLCBmdW5jdGlvbihhdHRyKSB7CiAgICAgICAgICAgIGlmICghYXBwRWxlbWVudCAmJiBuYW1lc1thdHRyLm5hbWVdKSB7CiAgICAgICAgICAgICAgYXBwRWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgICAgICAgbW9kdWxlID0gYXR0ci52YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGlmIChhcHBFbGVtZW50KSB7CiAgICAgIGJvb3RzdHJhcChhcHBFbGVtZW50LCBtb2R1bGUgPyBbbW9kdWxlXSA6IFtdKTsKICAgIH0KICB9CgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIGFuZ3VsYXIuYm9vdHN0cmFwCiAgICogQG1vZHVsZSBuZwogICAqIEBkZXNjcmlwdGlvbgogICAqIFVzZSB0aGlzIGZ1bmN0aW9uIHRvIG1hbnVhbGx5IHN0YXJ0IHVwIGFuZ3VsYXIgYXBwbGljYXRpb24uCiAgICoKICAgKiBTZWU6IHtAbGluayBndWlkZS9ib290c3RyYXAgQm9vdHN0cmFwfQogICAqCiAgICogTm90ZSB0aGF0IG5nU2NlbmFyaW8tYmFzZWQgZW5kLXRvLWVuZCB0ZXN0cyBjYW5ub3QgdXNlIHRoaXMgZnVuY3Rpb24gdG8gYm9vdHN0cmFwIG1hbnVhbGx5LgogICAqIFRoZXkgbXVzdCB1c2Uge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0FwcCBuZ0FwcH0uCiAgICoKICAgKiBBbmd1bGFyIHdpbGwgZGV0ZWN0IGlmIGl0IGhhcyBiZWVuIGxvYWRlZCBpbnRvIHRoZSBicm93c2VyIG1vcmUgdGhhbiBvbmNlIGFuZCBvbmx5IGFsbG93IHRoZQogICAqIGZpcnN0IGxvYWRlZCBzY3JpcHQgdG8gYmUgYm9vdHN0cmFwcGVkIGFuZCB3aWxsIHJlcG9ydCBhIHdhcm5pbmcgdG8gdGhlIGJyb3dzZXIgY29uc29sZSBmb3IKICAgKiBlYWNoIG9mIHRoZSBzdWJzZXF1ZW50IHNjcmlwdHMuICAgVGhpcyBwcmV2ZW50cyBzdHJhbmdlIHJlc3VsdHMgaW4gYXBwbGljYXRpb25zLCB3aGVyZSBvdGhlcndpc2UKICAgKiBtdWx0aXBsZSBpbnN0YW5jZXMgb2YgQW5ndWxhciB0cnkgdG8gd29yayBvbiB0aGUgRE9NLgogICAqCiAgICogPGV4YW1wbGUgbmFtZT0ibXVsdGktYm9vdHN0cmFwIiBtb2R1bGU9Im11bHRpLWJvb3RzdHJhcCI+CiAgICogPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICogPHNjcmlwdCBzcmM9Ii4uLy4uLy4uL2FuZ3VsYXIuanMiPjwvc2NyaXB0PgogICAqIDxkaXYgbmctY29udHJvbGxlcj0iQnJva2VuVGFibGUiPgogICAqICAgPHRhYmxlPgogICAqICAgPHRyPgogICAqICAgICA8dGggbmctcmVwZWF0PSJoZWFkaW5nIGluIGhlYWRpbmdzIj57e2hlYWRpbmd9fTwvdGg+CiAgICogICA8L3RyPgogICAqICAgPHRyIG5nLXJlcGVhdD0iZmlsbGluZyBpbiBmaWxsaW5ncyI+CiAgICogICAgIDx0ZCBuZy1yZXBlYXQ9ImZpbGwgaW4gZmlsbGluZyI+e3tmaWxsfX08L3RkPgogICAqICAgPC90cj4KICAgKiA8L3RhYmxlPgogICAqIDwvZGl2PgogICAqIDwvZmlsZT4KICAgKiA8ZmlsZSBuYW1lPSJjb250cm9sbGVyLmpzIj4KICAgKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ211bHRpLWJvb3RzdHJhcCcsIFtdKQogICAqCiAgICogLmNvbnRyb2xsZXIoJ0Jyb2tlblRhYmxlJywgZnVuY3Rpb24oJHNjb3BlKSB7CiAqICAgICAkc2NvcGUuaGVhZGluZ3MgPSBbJ09uZScsICdUd28nLCAnVGhyZWUnXTsKICogICAgICRzY29wZS5maWxsaW5ncyA9IFtbMSwgMiwgM10sIFsnQScsICdCJywgJ0MnXSwgWzcsIDgsIDldXTsKICogfSk7CiAgICogPC9maWxlPgogICAqIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAqIGl0KCdzaG91bGQgb25seSBpbnNlcnQgb25lIHRhYmxlIGNlbGwgZm9yIGVhY2ggaXRlbSBpbiAkc2NvcGUuZmlsbGluZ3MnLCBmdW5jdGlvbigpIHsKICogIGV4cGVjdChlbGVtZW50LmFsbChieS5jc3MoJ3RkJykpLmNvdW50KCkpCiAqICAgICAgLnRvQmUoOSk7CiAqIH0pOwogICAqIDwvZmlsZT4KICAgKiA8L2V4YW1wbGU+CiAgICoKICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgRE9NIGVsZW1lbnQgd2hpY2ggaXMgdGhlIHJvb3Qgb2YgYW5ndWxhciBhcHBsaWNhdGlvbi4KICAgKiBAcGFyYW0ge0FycmF5PFN0cmluZ3xGdW5jdGlvbnxBcnJheT49fSBtb2R1bGVzIGFuIGFycmF5IG9mIG1vZHVsZXMgdG8gbG9hZCBpbnRvIHRoZSBhcHBsaWNhdGlvbi4KICAgKiAgICAgRWFjaCBpdGVtIGluIHRoZSBhcnJheSBzaG91bGQgYmUgdGhlIG5hbWUgb2YgYSBwcmVkZWZpbmVkIG1vZHVsZSBvciBhIChESSBhbm5vdGF0ZWQpCiAgICogICAgIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBpbnZva2VkIGJ5IHRoZSBpbmplY3RvciBhcyBhIHJ1biBibG9jay4KICAgKiAgICAgU2VlOiB7QGxpbmsgYW5ndWxhci5tb2R1bGUgbW9kdWxlc30KICAgKiBAcmV0dXJucyB7YXV0by4kaW5qZWN0b3J9IFJldHVybnMgdGhlIG5ld2x5IGNyZWF0ZWQgaW5qZWN0b3IgZm9yIHRoaXMgYXBwLgogICAqLwogIGZ1bmN0aW9uIGJvb3RzdHJhcChlbGVtZW50LCBtb2R1bGVzKSB7CiAgICB2YXIgZG9Cb290c3RyYXAgPSBmdW5jdGlvbigpIHsKICAgICAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KTsKCiAgICAgIGlmIChlbGVtZW50LmluamVjdG9yKCkpIHsKICAgICAgICB2YXIgdGFnID0gKGVsZW1lbnRbMF0gPT09IGRvY3VtZW50KSA/ICdkb2N1bWVudCcgOiBzdGFydGluZ1RhZyhlbGVtZW50KTsKICAgICAgICB0aHJvdyBuZ01pbkVycignYnRzdHJwZCcsICJBcHAgQWxyZWFkeSBCb290c3RyYXBwZWQgd2l0aCB0aGlzIEVsZW1lbnQgJ3swfSciLCB0YWcpOwogICAgICB9CgogICAgICBtb2R1bGVzID0gbW9kdWxlcyB8fCBbXTsKICAgICAgbW9kdWxlcy51bnNoaWZ0KFsnJHByb3ZpZGUnLCBmdW5jdGlvbigkcHJvdmlkZSkgewogICAgICAgICRwcm92aWRlLnZhbHVlKCckcm9vdEVsZW1lbnQnLCBlbGVtZW50KTsKICAgICAgfV0pOwogICAgICBtb2R1bGVzLnVuc2hpZnQoJ25nJyk7CiAgICAgIHZhciBpbmplY3RvciA9IGNyZWF0ZUluamVjdG9yKG1vZHVsZXMpOwogICAgICBpbmplY3Rvci5pbnZva2UoWyckcm9vdFNjb3BlJywgJyRyb290RWxlbWVudCcsICckY29tcGlsZScsICckaW5qZWN0b3InLCAnJGFuaW1hdGUnLAogICAgICAgICAgZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGNvbXBpbGUsIGluamVjdG9yLCBhbmltYXRlKSB7CiAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBlbGVtZW50LmRhdGEoJyRpbmplY3RvcicsIGluamVjdG9yKTsKICAgICAgICAgICAgICBjb21waWxlKGVsZW1lbnQpKHNjb3BlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9XQogICAgICApOwogICAgICByZXR1cm4gaW5qZWN0b3I7CiAgICB9OwoKICAgIHZhciBOR19ERUZFUl9CT09UU1RSQVAgPSAvXk5HX0RFRkVSX0JPT1RTVFJBUCEvOwoKICAgIGlmICh3aW5kb3cgJiYgIU5HX0RFRkVSX0JPT1RTVFJBUC50ZXN0KHdpbmRvdy5uYW1lKSkgewogICAgICByZXR1cm4gZG9Cb290c3RyYXAoKTsKICAgIH0KCiAgICB3aW5kb3cubmFtZSA9IHdpbmRvdy5uYW1lLnJlcGxhY2UoTkdfREVGRVJfQk9PVFNUUkFQLCAnJyk7CiAgICBhbmd1bGFyLnJlc3VtZUJvb3RzdHJhcCA9IGZ1bmN0aW9uKGV4dHJhTW9kdWxlcykgewogICAgICBmb3JFYWNoKGV4dHJhTW9kdWxlcywgZnVuY3Rpb24obW9kdWxlKSB7CiAgICAgICAgbW9kdWxlcy5wdXNoKG1vZHVsZSk7CiAgICAgIH0pOwogICAgICBkb0Jvb3RzdHJhcCgpOwogICAgfTsKICB9CgogIHZhciBTTkFLRV9DQVNFX1JFR0VYUCA9IC9bQS1aXS9nOwogIGZ1bmN0aW9uIHNuYWtlX2Nhc2UobmFtZSwgc2VwYXJhdG9yKSB7CiAgICBzZXBhcmF0b3IgPSBzZXBhcmF0b3IgfHwgJ18nOwogICAgcmV0dXJuIG5hbWUucmVwbGFjZShTTkFLRV9DQVNFX1JFR0VYUCwgZnVuY3Rpb24obGV0dGVyLCBwb3MpIHsKICAgICAgcmV0dXJuIChwb3MgPyBzZXBhcmF0b3IgOiAnJykgKyBsZXR0ZXIudG9Mb3dlckNhc2UoKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gYmluZEpRdWVyeSgpIHsKICAgIC8vIGJpbmQgdG8galF1ZXJ5IGlmIHByZXNlbnQ7CiAgICBqUXVlcnkgPSB3aW5kb3cualF1ZXJ5OwogICAgLy8gVXNlIGpRdWVyeSBpZiBpdCBleGlzdHMgd2l0aCBwcm9wZXIgZnVuY3Rpb25hbGl0eSwgb3RoZXJ3aXNlIGRlZmF1bHQgdG8gdXMuCiAgICAvLyBBbmd1bGFyIDEuMisgcmVxdWlyZXMgalF1ZXJ5IDEuNy4xKyBmb3Igb24oKS9vZmYoKSBzdXBwb3J0LgogICAgaWYgKGpRdWVyeSAmJiBqUXVlcnkuZm4ub24pIHsKICAgICAganFMaXRlID0galF1ZXJ5OwogICAgICBleHRlbmQoalF1ZXJ5LmZuLCB7CiAgICAgICAgc2NvcGU6IEpRTGl0ZVByb3RvdHlwZS5zY29wZSwKICAgICAgICBpc29sYXRlU2NvcGU6IEpRTGl0ZVByb3RvdHlwZS5pc29sYXRlU2NvcGUsCiAgICAgICAgY29udHJvbGxlcjogSlFMaXRlUHJvdG90eXBlLmNvbnRyb2xsZXIsCiAgICAgICAgaW5qZWN0b3I6IEpRTGl0ZVByb3RvdHlwZS5pbmplY3RvciwKICAgICAgICBpbmhlcml0ZWREYXRhOiBKUUxpdGVQcm90b3R5cGUuaW5oZXJpdGVkRGF0YQogICAgICB9KTsKICAgICAgLy8gTWV0aG9kIHNpZ25hdHVyZToKICAgICAgLy8gICAgIGpxTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKG5hbWUsIGRpc3BhdGNoVGhpcywgZmlsdGVyRWxlbXMsIGdldHRlcklmTm9Bcmd1bWVudHMpCiAgICAgIGpxTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdyZW1vdmUnLCB0cnVlLCB0cnVlLCBmYWxzZSk7CiAgICAgIGpxTGl0ZVBhdGNoSlF1ZXJ5UmVtb3ZlKCdlbXB0eScsIGZhbHNlLCBmYWxzZSwgZmFsc2UpOwogICAgICBqcUxpdGVQYXRjaEpRdWVyeVJlbW92ZSgnaHRtbCcsIGZhbHNlLCBmYWxzZSwgdHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICBqcUxpdGUgPSBKUUxpdGU7CiAgICB9CiAgICBhbmd1bGFyLmVsZW1lbnQgPSBqcUxpdGU7CiAgfQoKICAvKioKICAgKiB0aHJvdyBlcnJvciBpZiB0aGUgYXJndW1lbnQgaXMgZmFsc3kuCiAgICovCiAgZnVuY3Rpb24gYXNzZXJ0QXJnKGFyZywgbmFtZSwgcmVhc29uKSB7CiAgICBpZiAoIWFyZykgewogICAgICB0aHJvdyBuZ01pbkVycignYXJlcScsICJBcmd1bWVudCAnezB9JyBpcyB7MX0iLCAobmFtZSB8fCAnPycpLCAocmVhc29uIHx8ICJyZXF1aXJlZCIpKTsKICAgIH0KICAgIHJldHVybiBhcmc7CiAgfQoKICBmdW5jdGlvbiBhc3NlcnRBcmdGbihhcmcsIG5hbWUsIGFjY2VwdEFycmF5QW5ub3RhdGlvbikgewogICAgaWYgKGFjY2VwdEFycmF5QW5ub3RhdGlvbiAmJiBpc0FycmF5KGFyZykpIHsKICAgICAgYXJnID0gYXJnW2FyZy5sZW5ndGggLSAxXTsKICAgIH0KCiAgICBhc3NlcnRBcmcoaXNGdW5jdGlvbihhcmcpLCBuYW1lLCAnbm90IGEgZnVuY3Rpb24sIGdvdCAnICsKICAgICAgKGFyZyAmJiB0eXBlb2YgYXJnID09ICdvYmplY3QnID8gYXJnLmNvbnN0cnVjdG9yLm5hbWUgfHwgJ09iamVjdCcgOiB0eXBlb2YgYXJnKSk7CiAgICByZXR1cm4gYXJnOwogIH0KCiAgLyoqCiAgICogdGhyb3cgZXJyb3IgaWYgdGhlIG5hbWUgZ2l2ZW4gaXMgaGFzT3duUHJvcGVydHkKICAgKiBAcGFyYW0gIHtTdHJpbmd9IG5hbWUgICAgdGhlIG5hbWUgdG8gdGVzdAogICAqIEBwYXJhbSAge1N0cmluZ30gY29udGV4dCB0aGUgY29udGV4dCBpbiB3aGljaCB0aGUgbmFtZSBpcyB1c2VkLCBzdWNoIGFzIG1vZHVsZSBvciBkaXJlY3RpdmUKICAgKi8KICBmdW5jdGlvbiBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCBjb250ZXh0KSB7CiAgICBpZiAobmFtZSA9PT0gJ2hhc093blByb3BlcnR5JykgewogICAgICB0aHJvdyBuZ01pbkVycignYmFkbmFtZScsICJoYXNPd25Qcm9wZXJ0eSBpcyBub3QgYSB2YWxpZCB7MH0gbmFtZSIsIGNvbnRleHQpOwogICAgfQogIH0KCiAgLyoqCiAgICogUmV0dXJuIHRoZSB2YWx1ZSBhY2Nlc3NpYmxlIGZyb20gdGhlIG9iamVjdCBieSBwYXRoLiBBbnkgdW5kZWZpbmVkIHRyYXZlcnNhbHMgYXJlIGlnbm9yZWQKICAgKiBAcGFyYW0ge09iamVjdH0gb2JqIHN0YXJ0aW5nIG9iamVjdAogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoIHBhdGggdG8gdHJhdmVyc2UKICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtiaW5kRm5Ub1Njb3BlPXRydWVdCiAgICogQHJldHVybnMge09iamVjdH0gdmFsdWUgYXMgYWNjZXNzaWJsZSBieSBwYXRoCiAgICovCi8vVE9ETyhtaXNrbyk6IHRoaXMgZnVuY3Rpb24gbmVlZHMgdG8gYmUgcmVtb3ZlZAogIGZ1bmN0aW9uIGdldHRlcihvYmosIHBhdGgsIGJpbmRGblRvU2NvcGUpIHsKICAgIGlmICghcGF0aCkgcmV0dXJuIG9iajsKICAgIHZhciBrZXlzID0gcGF0aC5zcGxpdCgnLicpOwogICAgdmFyIGtleTsKICAgIHZhciBsYXN0SW5zdGFuY2UgPSBvYmo7CiAgICB2YXIgbGVuID0ga2V5cy5sZW5ndGg7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICBrZXkgPSBrZXlzW2ldOwogICAgICBpZiAob2JqKSB7CiAgICAgICAgb2JqID0gKGxhc3RJbnN0YW5jZSA9IG9iailba2V5XTsKICAgICAgfQogICAgfQogICAgaWYgKCFiaW5kRm5Ub1Njb3BlICYmIGlzRnVuY3Rpb24ob2JqKSkgewogICAgICByZXR1cm4gYmluZChsYXN0SW5zdGFuY2UsIG9iaik7CiAgICB9CiAgICByZXR1cm4gb2JqOwogIH0KCiAgLyoqCiAgICogUmV0dXJuIHRoZSBET00gc2libGluZ3MgYmV0d2VlbiB0aGUgZmlyc3QgYW5kIGxhc3Qgbm9kZSBpbiB0aGUgZ2l2ZW4gYXJyYXkuCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgbGlrZSBvYmplY3QKICAgKiBAcmV0dXJucyB7RE9NRWxlbWVudH0gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGVsZW1lbnRzCiAgICovCiAgZnVuY3Rpb24gZ2V0QmxvY2tFbGVtZW50cyhub2RlcykgewogICAgdmFyIHN0YXJ0Tm9kZSA9IG5vZGVzWzBdLAogICAgICBlbmROb2RlID0gbm9kZXNbbm9kZXMubGVuZ3RoIC0gMV07CiAgICBpZiAoc3RhcnROb2RlID09PSBlbmROb2RlKSB7CiAgICAgIHJldHVybiBqcUxpdGUoc3RhcnROb2RlKTsKICAgIH0KCiAgICB2YXIgZWxlbWVudCA9IHN0YXJ0Tm9kZTsKICAgIHZhciBlbGVtZW50cyA9IFtlbGVtZW50XTsKCiAgICBkbyB7CiAgICAgIGVsZW1lbnQgPSBlbGVtZW50Lm5leHRTaWJsaW5nOwogICAgICBpZiAoIWVsZW1lbnQpIGJyZWFrOwogICAgICBlbGVtZW50cy5wdXNoKGVsZW1lbnQpOwogICAgfSB3aGlsZSAoZWxlbWVudCAhPT0gZW5kTm9kZSk7CgogICAgcmV0dXJuIGpxTGl0ZShlbGVtZW50cyk7CiAgfQoKICAvKioKICAgKiBAbmdkb2MgdHlwZQogICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlCiAgICogQG1vZHVsZSBuZwogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogSW50ZXJmYWNlIGZvciBjb25maWd1cmluZyBhbmd1bGFyIHtAbGluayBhbmd1bGFyLm1vZHVsZSBtb2R1bGVzfS4KICAgKi8KCiAgZnVuY3Rpb24gc2V0dXBNb2R1bGVMb2FkZXIod2luZG93KSB7CgogICAgdmFyICRpbmplY3Rvck1pbkVyciA9IG1pbkVycignJGluamVjdG9yJyk7CiAgICB2YXIgbmdNaW5FcnIgPSBtaW5FcnIoJ25nJyk7CgogICAgZnVuY3Rpb24gZW5zdXJlKG9iaiwgbmFtZSwgZmFjdG9yeSkgewogICAgICByZXR1cm4gb2JqW25hbWVdIHx8IChvYmpbbmFtZV0gPSBmYWN0b3J5KCkpOwogICAgfQoKICAgIHZhciBhbmd1bGFyID0gZW5zdXJlKHdpbmRvdywgJ2FuZ3VsYXInLCBPYmplY3QpOwoKICAgIC8vIFdlIG5lZWQgdG8gZXhwb3NlIGBhbmd1bGFyLiQkbWluRXJyYCB0byBtb2R1bGVzIHN1Y2ggYXMgYG5nUmVzb3VyY2VgIHRoYXQgcmVmZXJlbmNlIGl0IGR1cmluZyBib290c3RyYXAKICAgIGFuZ3VsYXIuJCRtaW5FcnIgPSBhbmd1bGFyLiQkbWluRXJyIHx8IG1pbkVycjsKCiAgICByZXR1cm4gZW5zdXJlKGFuZ3VsYXIsICdtb2R1bGUnLCBmdW5jdGlvbigpIHsKICAgICAgLyoqIEB0eXBlIHtPYmplY3QuPHN0cmluZywgYW5ndWxhci5Nb2R1bGU+fSAqLwogICAgICB2YXIgbW9kdWxlcyA9IHt9OwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgKiBAbmFtZSBhbmd1bGFyLm1vZHVsZQogICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKgogICAgICAgKiBUaGUgYGFuZ3VsYXIubW9kdWxlYCBpcyBhIGdsb2JhbCBwbGFjZSBmb3IgY3JlYXRpbmcsIHJlZ2lzdGVyaW5nIGFuZCByZXRyaWV2aW5nIEFuZ3VsYXIKICAgICAgICogbW9kdWxlcy4KICAgICAgICogQWxsIG1vZHVsZXMgKGFuZ3VsYXIgY29yZSBvciAzcmQgcGFydHkpIHRoYXQgc2hvdWxkIGJlIGF2YWlsYWJsZSB0byBhbiBhcHBsaWNhdGlvbiBtdXN0IGJlCiAgICAgICAqIHJlZ2lzdGVyZWQgdXNpbmcgdGhpcyBtZWNoYW5pc20uCiAgICAgICAqCiAgICAgICAqIFdoZW4gcGFzc2VkIHR3byBvciBtb3JlIGFyZ3VtZW50cywgYSBuZXcgbW9kdWxlIGlzIGNyZWF0ZWQuICBJZiBwYXNzZWQgb25seSBvbmUgYXJndW1lbnQsIGFuCiAgICAgICAqIGV4aXN0aW5nIG1vZHVsZSAodGhlIG5hbWUgcGFzc2VkIGFzIHRoZSBmaXJzdCBhcmd1bWVudCB0byBgbW9kdWxlYCkgaXMgcmV0cmlldmVkLgogICAgICAgKgogICAgICAgKgogICAgICAgKiAjIE1vZHVsZQogICAgICAgKgogICAgICAgKiBBIG1vZHVsZSBpcyBhIGNvbGxlY3Rpb24gb2Ygc2VydmljZXMsIGRpcmVjdGl2ZXMsIGZpbHRlcnMsIGFuZCBjb25maWd1cmF0aW9uIGluZm9ybWF0aW9uLgogICAgICAgKiBgYW5ndWxhci5tb2R1bGVgIGlzIHVzZWQgdG8gY29uZmlndXJlIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4KICAgICAgICoKICAgICAgICogYGBganMKICAgICAgICogLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZQogICAgICAgKiB2YXIgbXlNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnbXlNb2R1bGUnLCBbXSk7CiAgICAgICAqCiAgICAgICAqIC8vIHJlZ2lzdGVyIGEgbmV3IHNlcnZpY2UKICAgICAgICogbXlNb2R1bGUudmFsdWUoJ2FwcE5hbWUnLCAnTXlDb29sQXBwJyk7CiAgICAgICAqCiAgICAgICAqIC8vIGNvbmZpZ3VyZSBleGlzdGluZyBzZXJ2aWNlcyBpbnNpZGUgaW5pdGlhbGl6YXRpb24gYmxvY2tzLgogICAgICAgKiBteU1vZHVsZS5jb25maWcoWyckbG9jYXRpb25Qcm92aWRlcicsIGZ1bmN0aW9uKCRsb2NhdGlvblByb3ZpZGVyKSB7CiAgICAgKiAgIC8vIENvbmZpZ3VyZSBleGlzdGluZyBwcm92aWRlcnMKICAgICAqICAgJGxvY2F0aW9uUHJvdmlkZXIuaGFzaFByZWZpeCgnIScpOwogICAgICogfV0pOwogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICogVGhlbiB5b3UgY2FuIGNyZWF0ZSBhbiBpbmplY3RvciBhbmQgbG9hZCB5b3VyIG1vZHVsZXMgbGlrZSB0aGlzOgogICAgICAgKgogICAgICAgKiBgYGBqcwogICAgICAgKiB2YXIgaW5qZWN0b3IgPSBhbmd1bGFyLmluamVjdG9yKFsnbmcnLCAnbXlNb2R1bGUnXSkKICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqIEhvd2V2ZXIgaXQncyBtb3JlIGxpa2VseSB0aGF0IHlvdSdsbCBqdXN0IHVzZQogICAgICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQXBwIG5nQXBwfSBvcgogICAgICAgKiB7QGxpbmsgYW5ndWxhci5ib290c3RyYXB9IHRvIHNpbXBsaWZ5IHRoaXMgcHJvY2VzcyBmb3IgeW91LgogICAgICAgKgogICAgICAgKiBAcGFyYW0geyFzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIG1vZHVsZSB0byBjcmVhdGUgb3IgcmV0cmlldmUuCiAgICAgICA8PDw8PCogQHBhcmFtIHshQXJyYXkuPHN0cmluZz49fSByZXF1aXJlcyBJZiBzcGVjaWZpZWQgdGhlbiBuZXcgbW9kdWxlIGlzIGJlaW5nIGNyZWF0ZWQuIElmCiAgICAgICA+Pj4+PiogICAgICAgIHVuc3BlY2lmaWVkIHRoZW4gdGhlIG1vZHVsZSBpcyBiZWluZyByZXRyaWV2ZWQgZm9yIGZ1cnRoZXIgY29uZmlndXJhdGlvbi4KICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uZmlnRm4gT3B0aW9uYWwgY29uZmlndXJhdGlvbiBmdW5jdGlvbiBmb3IgdGhlIG1vZHVsZS4gU2FtZSBhcwogICAgICAgKiAgICAgICAge0BsaW5rIGFuZ3VsYXIuTW9kdWxlI2NvbmZpZyBNb2R1bGUjY29uZmlnKCl9LgogICAgICAgKiBAcmV0dXJucyB7bW9kdWxlfSBuZXcgbW9kdWxlIHdpdGggdGhlIHtAbGluayBhbmd1bGFyLk1vZHVsZX0gYXBpLgogICAgICAgKi8KICAgICAgcmV0dXJuIGZ1bmN0aW9uIG1vZHVsZShuYW1lLCByZXF1aXJlcywgY29uZmlnRm4pIHsKICAgICAgICB2YXIgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkgPSBmdW5jdGlvbihuYW1lLCBjb250ZXh0KSB7CiAgICAgICAgICBpZiAobmFtZSA9PT0gJ2hhc093blByb3BlcnR5JykgewogICAgICAgICAgICB0aHJvdyBuZ01pbkVycignYmFkbmFtZScsICdoYXNPd25Qcm9wZXJ0eSBpcyBub3QgYSB2YWxpZCB7MH0gbmFtZScsIGNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KG5hbWUsICdtb2R1bGUnKTsKICAgICAgICBpZiAocmVxdWlyZXMgJiYgbW9kdWxlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgbW9kdWxlc1tuYW1lXSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHJldHVybiBlbnN1cmUobW9kdWxlcywgbmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoIXJlcXVpcmVzKSB7CiAgICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignbm9tb2QnLCAiTW9kdWxlICd7MH0nIGlzIG5vdCBhdmFpbGFibGUhIFlvdSBlaXRoZXIgbWlzc3BlbGxlZCAiICsKICAgICAgICAgICAgICAidGhlIG1vZHVsZSBuYW1lIG9yIGZvcmdvdCB0byBsb2FkIGl0LiBJZiByZWdpc3RlcmluZyBhIG1vZHVsZSBlbnN1cmUgdGhhdCB5b3UgIiArCiAgICAgICAgICAgICAgInNwZWNpZnkgdGhlIGRlcGVuZGVuY2llcyBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50LiIsIG5hbWUpOwogICAgICAgICAgfQoKICAgICAgICAgIC8qKiBAdHlwZSB7IUFycmF5LjxBcnJheS48Kj4+fSAqLwogICAgICAgICAgdmFyIGludm9rZVF1ZXVlID0gW107CgogICAgICAgICAgLyoqIEB0eXBlIHshQXJyYXkuPEZ1bmN0aW9uPn0gKi8KICAgICAgICAgIHZhciBydW5CbG9ja3MgPSBbXTsKCiAgICAgICAgICB2YXIgY29uZmlnID0gaW52b2tlTGF0ZXIoJyRpbmplY3RvcicsICdpbnZva2UnKTsKCiAgICAgICAgICAvKiogQHR5cGUge2FuZ3VsYXIuTW9kdWxlfSAqLwogICAgICAgICAgdmFyIG1vZHVsZUluc3RhbmNlID0gewogICAgICAgICAgICAvLyBQcml2YXRlIHN0YXRlCiAgICAgICAgICAgIF9pbnZva2VRdWV1ZTogaW52b2tlUXVldWUsCiAgICAgICAgICAgIF9ydW5CbG9ja3M6IHJ1bkJsb2NrcywKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjcmVxdWlyZXMKICAgICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICAgKiBAcmV0dXJucyB7QXJyYXkuPHN0cmluZz59IExpc3Qgb2YgbW9kdWxlIG5hbWVzIHdoaWNoIG11c3QgYmUgbG9hZGVkIGJlZm9yZSB0aGlzIG1vZHVsZS4KICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIEhvbGRzIHRoZSBsaXN0IG9mIG1vZHVsZXMgd2hpY2ggdGhlIGluamVjdG9yIHdpbGwgbG9hZCBiZWZvcmUgdGhlIGN1cnJlbnQgbW9kdWxlIGlzCiAgICAgICAgICAgICAqIGxvYWRlZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJlcXVpcmVzOiByZXF1aXJlcywKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjbmFtZQogICAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IE5hbWUgb2YgdGhlIG1vZHVsZS4KICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBuYW1lOiBuYW1lLAoKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3Byb3ZpZGVyCiAgICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByb3ZpZGVyVHlwZSBDb25zdHJ1Y3Rpb24gZnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiB0aGUKICAgICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2UuCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTZWUge0BsaW5rIGF1dG8uJHByb3ZpZGUjcHJvdmlkZXIgJHByb3ZpZGUucHJvdmlkZXIoKX0uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBwcm92aWRlcjogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ3Byb3ZpZGVyJyksCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNmYWN0b3J5CiAgICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHByb3ZpZGVyRnVuY3Rpb24gRnVuY3Rpb24gZm9yIGNyZWF0aW5nIG5ldyBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNmYWN0b3J5ICRwcm92aWRlLmZhY3RvcnkoKX0uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBmYWN0b3J5OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnZmFjdG9yeScpLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjc2VydmljZQogICAgICAgICAgICAgKiBAbW9kdWxlIG5nCiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIHNlcnZpY2UgbmFtZQogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25zdHJ1Y3RvciBBIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBpbnN0YW50aWF0ZWQuCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTZWUge0BsaW5rIGF1dG8uJHByb3ZpZGUjc2VydmljZSAkcHJvdmlkZS5zZXJ2aWNlKCl9LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2VydmljZTogaW52b2tlTGF0ZXIoJyRwcm92aWRlJywgJ3NlcnZpY2UnKSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lIGFuZ3VsYXIuTW9kdWxlI3ZhbHVlCiAgICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgc2VydmljZSBuYW1lCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IFNlcnZpY2UgaW5zdGFuY2Ugb2JqZWN0LgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2VlIHtAbGluayBhdXRvLiRwcm92aWRlI3ZhbHVlICRwcm92aWRlLnZhbHVlKCl9LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdmFsdWU6IGludm9rZUxhdGVyKCckcHJvdmlkZScsICd2YWx1ZScpLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29uc3RhbnQKICAgICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBjb25zdGFudCBuYW1lCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IENvbnN0YW50IHZhbHVlLgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogQmVjYXVzZSB0aGUgY29uc3RhbnQgYXJlIGZpeGVkLCB0aGV5IGdldCBhcHBsaWVkIGJlZm9yZSBvdGhlciBwcm92aWRlIG1ldGhvZHMuCiAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgYXV0by4kcHJvdmlkZSNjb25zdGFudCAkcHJvdmlkZS5jb25zdGFudCgpfS4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNvbnN0YW50OiBpbnZva2VMYXRlcignJHByb3ZpZGUnLCAnY29uc3RhbnQnLCAndW5zaGlmdCcpLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjYW5pbWF0aW9uCiAgICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgYW5pbWF0aW9uIG5hbWUKICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gYW5pbWF0aW9uRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgYW4KICAgICAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmltYXRpb24uCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiAqKk5PVEUqKjogYW5pbWF0aW9ucyB0YWtlIGVmZmVjdCBvbmx5IGlmIHRoZSAqKm5nQW5pbWF0ZSoqIG1vZHVsZSBpcyBsb2FkZWQuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIERlZmluZXMgYW4gYW5pbWF0aW9uIGhvb2sgdGhhdCBjYW4gYmUgbGF0ZXIgdXNlZCB3aXRoCiAgICAgICAgICAgICAqIHtAbGluayBuZ0FuaW1hdGUuJGFuaW1hdGUgJGFuaW1hdGV9IHNlcnZpY2UgYW5kIGRpcmVjdGl2ZXMgdGhhdCB1c2UgdGhpcyBzZXJ2aWNlLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBgYGBqcwogICAgICAgICAgICAgKiBtb2R1bGUuYW5pbWF0aW9uKCcuYW5pbWF0aW9uLW5hbWUnLCBmdW5jdGlvbigkaW5qZWN0MSwgJGluamVjdDIpIHsKICAgICAgICAgICAqICAgcmV0dXJuIHsKICAgICAgICAgICAqICAgICBldmVudE5hbWUgOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7CiAgICAgICAgICAgKiAgICAgICAvL2NvZGUgdG8gcnVuIHRoZSBhbmltYXRpb24KICAgICAgICAgICAqICAgICAgIC8vb25jZSBjb21wbGV0ZSwgdGhlbiBydW4gZG9uZSgpCiAgICAgICAgICAgKiAgICAgICByZXR1cm4gZnVuY3Rpb24gY2FuY2VsbGF0aW9uRnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICogICAgICAgICAvL2NvZGUgdG8gY2FuY2VsIHRoZSBhbmltYXRpb24KICAgICAgICAgICAqICAgICAgIH0KICAgICAgICAgICAqICAgICB9CiAgICAgICAgICAgKiAgIH0KICAgICAgICAgICAqIH0pCiAgICAgICAgICAgICAqIGBgYAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBTZWUge0BsaW5rIG5nQW5pbWF0ZS4kYW5pbWF0ZVByb3ZpZGVyI3JlZ2lzdGVyICRhbmltYXRlUHJvdmlkZXIucmVnaXN0ZXIoKX0gYW5kCiAgICAgICAgICAgICAqIHtAbGluayBuZ0FuaW1hdGUgbmdBbmltYXRlIG1vZHVsZX0gZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBhbmltYXRpb246IGludm9rZUxhdGVyKCckYW5pbWF0ZVByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNmaWx0ZXIKICAgICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBGaWx0ZXIgbmFtZS4KICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZmlsdGVyRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YgZmlsdGVyLgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2VlIHtAbGluayBuZy4kZmlsdGVyUHJvdmlkZXIjcmVnaXN0ZXIgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCl9LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZmlsdGVyOiBpbnZva2VMYXRlcignJGZpbHRlclByb3ZpZGVyJywgJ3JlZ2lzdGVyJyksCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNjb250cm9sbGVyCiAgICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBuYW1lIENvbnRyb2xsZXIgbmFtZSwgb3IgYW4gb2JqZWN0IG1hcCBvZiBjb250cm9sbGVycyB3aGVyZSB0aGUKICAgICAgICAgICAgICogICAga2V5cyBhcmUgdGhlIG5hbWVzIGFuZCB0aGUgdmFsdWVzIGFyZSB0aGUgY29uc3RydWN0b3JzLgogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb25zdHJ1Y3RvciBDb250cm9sbGVyIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogU2VlIHtAbGluayBuZy4kY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyICRjb250cm9sbGVyUHJvdmlkZXIucmVnaXN0ZXIoKX0uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjb250cm9sbGVyOiBpbnZva2VMYXRlcignJGNvbnRyb2xsZXJQcm92aWRlcicsICdyZWdpc3RlcicpLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjZGlyZWN0aXZlCiAgICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0fSBuYW1lIERpcmVjdGl2ZSBuYW1lLCBvciBhbiBvYmplY3QgbWFwIG9mIGRpcmVjdGl2ZXMgd2hlcmUgdGhlCiAgICAgICAgICAgICAqICAgIGtleXMgYXJlIHRoZSBuYW1lcyBhbmQgdGhlIHZhbHVlcyBhcmUgdGhlIGZhY3Rvcmllcy4KICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZGlyZWN0aXZlRmFjdG9yeSBGYWN0b3J5IGZ1bmN0aW9uIGZvciBjcmVhdGluZyBuZXcgaW5zdGFuY2Ugb2YKICAgICAgICAgICAgICogZGlyZWN0aXZlcy4KICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFNlZSB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgJGNvbXBpbGVQcm92aWRlci5kaXJlY3RpdmUoKX0uCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBkaXJlY3RpdmU6IGludm9rZUxhdGVyKCckY29tcGlsZVByb3ZpZGVyJywgJ2RpcmVjdGl2ZScpLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgYW5ndWxhci5Nb2R1bGUjY29uZmlnCiAgICAgICAgICAgICAqIEBtb2R1bGUgbmcKICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uZmlnRm4gRXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIG9uIG1vZHVsZSBsb2FkLiBVc2VmdWwgZm9yIHNlcnZpY2UKICAgICAgICAgICAgICogICAgY29uZmlndXJhdGlvbi4KICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFVzZSB0aGlzIG1ldGhvZCB0byByZWdpc3RlciB3b3JrIHdoaWNoIG5lZWRzIHRvIGJlIHBlcmZvcm1lZCBvbiBtb2R1bGUgbG9hZGluZy4KICAgICAgICAgICAgICogRm9yIG1vcmUgYWJvdXQgaG93IHRvIGNvbmZpZ3VyZSBzZXJ2aWNlcywgc2VlCiAgICAgICAgICAgICAqIHtAbGluayBwcm92aWRlcnMjcHJvdmlkZXJzX3Byb3ZpZGVyLXJlY2lwZSBQcm92aWRlciBSZWNpcGV9LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY29uZmlnOiBjb25maWcsCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSBhbmd1bGFyLk1vZHVsZSNydW4KICAgICAgICAgICAgICogQG1vZHVsZSBuZwogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBpbml0aWFsaXphdGlvbkZuIEV4ZWN1dGUgdGhpcyBmdW5jdGlvbiBhZnRlciBpbmplY3RvciBjcmVhdGlvbi4KICAgICAgICAgICAgICogICAgVXNlZnVsIGZvciBhcHBsaWNhdGlvbiBpbml0aWFsaXphdGlvbi4KICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFVzZSB0aGlzIG1ldGhvZCB0byByZWdpc3RlciB3b3JrIHdoaWNoIHNob3VsZCBiZSBwZXJmb3JtZWQgd2hlbiB0aGUgaW5qZWN0b3IgaXMgZG9uZQogICAgICAgICAgICAgKiBsb2FkaW5nIGFsbCBtb2R1bGVzLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcnVuOiBmdW5jdGlvbihibG9jaykgewogICAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKGJsb2NrKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICBpZiAoY29uZmlnRm4pIHsKICAgICAgICAgICAgY29uZmlnKGNvbmZpZ0ZuKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gIG1vZHVsZUluc3RhbmNlOwoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3ZpZGVyCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kCiAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZz19IGluc2VydE1ldGhvZAogICAgICAgICAgICogQHJldHVybnMge2FuZ3VsYXIuTW9kdWxlfQogICAgICAgICAgICovCiAgICAgICAgICBmdW5jdGlvbiBpbnZva2VMYXRlcihwcm92aWRlciwgbWV0aG9kLCBpbnNlcnRNZXRob2QpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGludm9rZVF1ZXVlW2luc2VydE1ldGhvZCB8fCAncHVzaCddKFtwcm92aWRlciwgbWV0aG9kLCBhcmd1bWVudHNdKTsKICAgICAgICAgICAgICByZXR1cm4gbW9kdWxlSW5zdGFuY2U7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9KTsKCiAgfQoKICAvKiBnbG9iYWwKICAgYW5ndWxhck1vZHVsZTogdHJ1ZSwKICAgdmVyc2lvbjogdHJ1ZSwKCiAgICRMb2NhbGVQcm92aWRlciwKICAgJENvbXBpbGVQcm92aWRlciwKCiAgIGh0bWxBbmNob3JEaXJlY3RpdmUsCiAgIGlucHV0RGlyZWN0aXZlLAogICBpbnB1dERpcmVjdGl2ZSwKICAgZm9ybURpcmVjdGl2ZSwKICAgc2NyaXB0RGlyZWN0aXZlLAogICBzZWxlY3REaXJlY3RpdmUsCiAgIHN0eWxlRGlyZWN0aXZlLAogICBvcHRpb25EaXJlY3RpdmUsCiAgIG5nQmluZERpcmVjdGl2ZSwKICAgbmdCaW5kSHRtbERpcmVjdGl2ZSwKICAgbmdCaW5kVGVtcGxhdGVEaXJlY3RpdmUsCiAgIG5nQ2xhc3NEaXJlY3RpdmUsCiAgIG5nQ2xhc3NFdmVuRGlyZWN0aXZlLAogICBuZ0NsYXNzT2RkRGlyZWN0aXZlLAogICBuZ0NzcERpcmVjdGl2ZSwKICAgbmdDbG9ha0RpcmVjdGl2ZSwKICAgbmdDb250cm9sbGVyRGlyZWN0aXZlLAogICBuZ0Zvcm1EaXJlY3RpdmUsCiAgIG5nSGlkZURpcmVjdGl2ZSwKICAgbmdJZkRpcmVjdGl2ZSwKICAgbmdJbmNsdWRlRGlyZWN0aXZlLAogICBuZ0luY2x1ZGVGaWxsQ29udGVudERpcmVjdGl2ZSwKICAgbmdJbml0RGlyZWN0aXZlLAogICBuZ05vbkJpbmRhYmxlRGlyZWN0aXZlLAogICBuZ1BsdXJhbGl6ZURpcmVjdGl2ZSwKICAgbmdSZXBlYXREaXJlY3RpdmUsCiAgIG5nU2hvd0RpcmVjdGl2ZSwKICAgbmdTdHlsZURpcmVjdGl2ZSwKICAgbmdTd2l0Y2hEaXJlY3RpdmUsCiAgIG5nU3dpdGNoV2hlbkRpcmVjdGl2ZSwKICAgbmdTd2l0Y2hEZWZhdWx0RGlyZWN0aXZlLAogICBuZ09wdGlvbnNEaXJlY3RpdmUsCiAgIG5nVHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgbmdNb2RlbERpcmVjdGl2ZSwKICAgbmdMaXN0RGlyZWN0aXZlLAogICBuZ0NoYW5nZURpcmVjdGl2ZSwKICAgcmVxdWlyZWREaXJlY3RpdmUsCiAgIHJlcXVpcmVkRGlyZWN0aXZlLAogICBuZ1ZhbHVlRGlyZWN0aXZlLAogICBuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcywKICAgbmdFdmVudERpcmVjdGl2ZXMsCgogICAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIsCiAgICRBbmltYXRlUHJvdmlkZXIsCiAgICRCcm93c2VyUHJvdmlkZXIsCiAgICRDYWNoZUZhY3RvcnlQcm92aWRlciwKICAgJENvbnRyb2xsZXJQcm92aWRlciwKICAgJERvY3VtZW50UHJvdmlkZXIsCiAgICRFeGNlcHRpb25IYW5kbGVyUHJvdmlkZXIsCiAgICRGaWx0ZXJQcm92aWRlciwKICAgJEludGVycG9sYXRlUHJvdmlkZXIsCiAgICRJbnRlcnZhbFByb3ZpZGVyLAogICAkSHR0cFByb3ZpZGVyLAogICAkSHR0cEJhY2tlbmRQcm92aWRlciwKICAgJExvY2F0aW9uUHJvdmlkZXIsCiAgICRMb2dQcm92aWRlciwKICAgJFBhcnNlUHJvdmlkZXIsCiAgICRSb290U2NvcGVQcm92aWRlciwKICAgJFFQcm92aWRlciwKICAgJCRTYW5pdGl6ZVVyaVByb3ZpZGVyLAogICAkU2NlUHJvdmlkZXIsCiAgICRTY2VEZWxlZ2F0ZVByb3ZpZGVyLAogICAkU25pZmZlclByb3ZpZGVyLAogICAkVGVtcGxhdGVDYWNoZVByb3ZpZGVyLAogICAkVGltZW91dFByb3ZpZGVyLAogICAkJFJBRlByb3ZpZGVyLAogICAkJEFzeW5jQ2FsbGJhY2tQcm92aWRlciwKICAgJFdpbmRvd1Byb3ZpZGVyCiAgICovCgoKICAvKioKICAgKiBAbmdkb2Mgb2JqZWN0CiAgICogQG5hbWUgYW5ndWxhci52ZXJzaW9uCiAgICogQG1vZHVsZSBuZwogICAqIEBkZXNjcmlwdGlvbgogICAqIEFuIG9iamVjdCB0aGF0IGNvbnRhaW5zIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IEFuZ3VsYXJKUyB2ZXJzaW9uLiBUaGlzIG9iamVjdCBoYXMgdGhlCiAgICogZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICoKICAgKiAtIGBmdWxsYCDigJMgYHtzdHJpbmd9YCDigJMgRnVsbCB2ZXJzaW9uIHN0cmluZywgc3VjaCBhcyAiMC45LjE4Ii4KICAgKiAtIGBtYWpvcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1ham9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICIwIi4KICAgKiAtIGBtaW5vcmAg4oCTIGB7bnVtYmVyfWAg4oCTIE1pbm9yIHZlcnNpb24gbnVtYmVyLCBzdWNoIGFzICI5Ii4KICAgKiAtIGBkb3RgIOKAkyBge251bWJlcn1gIOKAkyBEb3QgdmVyc2lvbiBudW1iZXIsIHN1Y2ggYXMgIjE4Ii4KICAgKiAtIGBjb2RlTmFtZWAg4oCTIGB7c3RyaW5nfWAg4oCTIENvZGUgbmFtZSBvZiB0aGUgcmVsZWFzZSwgc3VjaCBhcyAiamlnZ2xpbmctYXJtZmF0Ii4KICAgKi8KICB2YXIgdmVyc2lvbiA9IHsKICAgIGZ1bGw6ICcxLjIuMTcnLCAgICAvLyBhbGwgb2YgdGhlc2UgcGxhY2Vob2xkZXIgc3RyaW5ncyB3aWxsIGJlIHJlcGxhY2VkIGJ5IGdydW50J3MKICAgIG1ham9yOiAxLCAgICAvLyBwYWNrYWdlIHRhc2sKICAgIG1pbm9yOiAyLAogICAgZG90OiAxNywKICAgIGNvZGVOYW1lOiAncXVhbnR1bS1kaXNlbnRhbmdsZW1lbnQnCiAgfTsKCgogIGZ1bmN0aW9uIHB1Ymxpc2hFeHRlcm5hbEFQSShhbmd1bGFyKXsKICAgIGV4dGVuZChhbmd1bGFyLCB7CiAgICAgICdib290c3RyYXAnOiBib290c3RyYXAsCiAgICAgICdjb3B5JzogY29weSwKICAgICAgJ2V4dGVuZCc6IGV4dGVuZCwKICAgICAgJ2VxdWFscyc6IGVxdWFscywKICAgICAgJ2VsZW1lbnQnOiBqcUxpdGUsCiAgICAgICdmb3JFYWNoJzogZm9yRWFjaCwKICAgICAgJ2luamVjdG9yJzogY3JlYXRlSW5qZWN0b3IsCiAgICAgICdub29wJzpub29wLAogICAgICAnYmluZCc6YmluZCwKICAgICAgJ3RvSnNvbic6IHRvSnNvbiwKICAgICAgJ2Zyb21Kc29uJzogZnJvbUpzb24sCiAgICAgICdpZGVudGl0eSc6aWRlbnRpdHksCiAgICAgICdpc1VuZGVmaW5lZCc6IGlzVW5kZWZpbmVkLAogICAgICAnaXNEZWZpbmVkJzogaXNEZWZpbmVkLAogICAgICAnaXNTdHJpbmcnOiBpc1N0cmluZywKICAgICAgJ2lzRnVuY3Rpb24nOiBpc0Z1bmN0aW9uLAogICAgICAnaXNPYmplY3QnOiBpc09iamVjdCwKICAgICAgJ2lzTnVtYmVyJzogaXNOdW1iZXIsCiAgICAgICdpc0VsZW1lbnQnOiBpc0VsZW1lbnQsCiAgICAgICdpc0FycmF5JzogaXNBcnJheSwKICAgICAgJ3ZlcnNpb24nOiB2ZXJzaW9uLAogICAgICAnaXNEYXRlJzogaXNEYXRlLAogICAgICAnbG93ZXJjYXNlJzogbG93ZXJjYXNlLAogICAgICAndXBwZXJjYXNlJzogdXBwZXJjYXNlLAogICAgICAnY2FsbGJhY2tzJzoge2NvdW50ZXI6IDB9LAogICAgICAnJCRtaW5FcnInOiBtaW5FcnIsCiAgICAgICckJGNzcCc6IGNzcAogICAgfSk7CgogICAgYW5ndWxhck1vZHVsZSA9IHNldHVwTW9kdWxlTG9hZGVyKHdpbmRvdyk7CiAgICB0cnkgewogICAgICBhbmd1bGFyTW9kdWxlKCduZ0xvY2FsZScpOwogICAgfSBjYXRjaCAoZSkgewogICAgICBhbmd1bGFyTW9kdWxlKCduZ0xvY2FsZScsIFtdKS5wcm92aWRlcignJGxvY2FsZScsICRMb2NhbGVQcm92aWRlcik7CiAgICB9CgogICAgYW5ndWxhck1vZHVsZSgnbmcnLCBbJ25nTG9jYWxlJ10sIFsnJHByb3ZpZGUnLAogICAgICBmdW5jdGlvbiBuZ01vZHVsZSgkcHJvdmlkZSkgewogICAgICAgIC8vICQkc2FuaXRpemVVcmlQcm92aWRlciBuZWVkcyB0byBiZSBiZWZvcmUgJGNvbXBpbGVQcm92aWRlciBhcyBpdCBpcyB1c2VkIGJ5IGl0LgogICAgICAgICRwcm92aWRlLnByb3ZpZGVyKHsKICAgICAgICAgICQkc2FuaXRpemVVcmk6ICQkU2FuaXRpemVVcmlQcm92aWRlcgogICAgICAgIH0pOwogICAgICAgICRwcm92aWRlLnByb3ZpZGVyKCckY29tcGlsZScsICRDb21waWxlUHJvdmlkZXIpLgogICAgICAgICAgZGlyZWN0aXZlKHsKICAgICAgICAgICAgYTogaHRtbEFuY2hvckRpcmVjdGl2ZSwKICAgICAgICAgICAgaW5wdXQ6IGlucHV0RGlyZWN0aXZlLAogICAgICAgICAgICB0ZXh0YXJlYTogaW5wdXREaXJlY3RpdmUsCiAgICAgICAgICAgIGZvcm06IGZvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgIHNjcmlwdDogc2NyaXB0RGlyZWN0aXZlLAogICAgICAgICAgICBzZWxlY3Q6IHNlbGVjdERpcmVjdGl2ZSwKICAgICAgICAgICAgc3R5bGU6IHN0eWxlRGlyZWN0aXZlLAogICAgICAgICAgICBvcHRpb246IG9wdGlvbkRpcmVjdGl2ZSwKICAgICAgICAgICAgbmdCaW5kOiBuZ0JpbmREaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQmluZEh0bWw6IG5nQmluZEh0bWxEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQmluZFRlbXBsYXRlOiBuZ0JpbmRUZW1wbGF0ZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdDbGFzczogbmdDbGFzc0RpcmVjdGl2ZSwKICAgICAgICAgICAgbmdDbGFzc0V2ZW46IG5nQ2xhc3NFdmVuRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0NsYXNzT2RkOiBuZ0NsYXNzT2RkRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0Nsb2FrOiBuZ0Nsb2FrRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0NvbnRyb2xsZXI6IG5nQ29udHJvbGxlckRpcmVjdGl2ZSwKICAgICAgICAgICAgbmdGb3JtOiBuZ0Zvcm1EaXJlY3RpdmUsCiAgICAgICAgICAgIG5nSGlkZTogbmdIaWRlRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0lmOiBuZ0lmRGlyZWN0aXZlLAogICAgICAgICAgICBuZ0luY2x1ZGU6IG5nSW5jbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdJbml0OiBuZ0luaXREaXJlY3RpdmUsCiAgICAgICAgICAgIG5nTm9uQmluZGFibGU6IG5nTm9uQmluZGFibGVEaXJlY3RpdmUsCiAgICAgICAgICAgIG5nUGx1cmFsaXplOiBuZ1BsdXJhbGl6ZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdSZXBlYXQ6IG5nUmVwZWF0RGlyZWN0aXZlLAogICAgICAgICAgICBuZ1Nob3c6IG5nU2hvd0RpcmVjdGl2ZSwKICAgICAgICAgICAgbmdTdHlsZTogbmdTdHlsZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdTd2l0Y2g6IG5nU3dpdGNoRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1N3aXRjaFdoZW46IG5nU3dpdGNoV2hlbkRpcmVjdGl2ZSwKICAgICAgICAgICAgbmdTd2l0Y2hEZWZhdWx0OiBuZ1N3aXRjaERlZmF1bHREaXJlY3RpdmUsCiAgICAgICAgICAgIG5nT3B0aW9uczogbmdPcHRpb25zRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1RyYW5zY2x1ZGU6IG5nVHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgbmdNb2RlbDogbmdNb2RlbERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdMaXN0OiBuZ0xpc3REaXJlY3RpdmUsCiAgICAgICAgICAgIG5nQ2hhbmdlOiBuZ0NoYW5nZURpcmVjdGl2ZSwKICAgICAgICAgICAgcmVxdWlyZWQ6IHJlcXVpcmVkRGlyZWN0aXZlLAogICAgICAgICAgICBuZ1JlcXVpcmVkOiByZXF1aXJlZERpcmVjdGl2ZSwKICAgICAgICAgICAgbmdWYWx1ZTogbmdWYWx1ZURpcmVjdGl2ZQogICAgICAgICAgfSkuCiAgICAgICAgICBkaXJlY3RpdmUoewogICAgICAgICAgICBuZ0luY2x1ZGU6IG5nSW5jbHVkZUZpbGxDb250ZW50RGlyZWN0aXZlCiAgICAgICAgICB9KS4KICAgICAgICAgIGRpcmVjdGl2ZShuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlcykuCiAgICAgICAgICBkaXJlY3RpdmUobmdFdmVudERpcmVjdGl2ZXMpOwogICAgICAgICRwcm92aWRlLnByb3ZpZGVyKHsKICAgICAgICAgICRhbmNob3JTY3JvbGw6ICRBbmNob3JTY3JvbGxQcm92aWRlciwKICAgICAgICAgICRhbmltYXRlOiAkQW5pbWF0ZVByb3ZpZGVyLAogICAgICAgICAgJGJyb3dzZXI6ICRCcm93c2VyUHJvdmlkZXIsCiAgICAgICAgICAkY2FjaGVGYWN0b3J5OiAkQ2FjaGVGYWN0b3J5UHJvdmlkZXIsCiAgICAgICAgICAkY29udHJvbGxlcjogJENvbnRyb2xsZXJQcm92aWRlciwKICAgICAgICAgICRkb2N1bWVudDogJERvY3VtZW50UHJvdmlkZXIsCiAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcjogJEV4Y2VwdGlvbkhhbmRsZXJQcm92aWRlciwKICAgICAgICAgICRmaWx0ZXI6ICRGaWx0ZXJQcm92aWRlciwKICAgICAgICAgICRpbnRlcnBvbGF0ZTogJEludGVycG9sYXRlUHJvdmlkZXIsCiAgICAgICAgICAkaW50ZXJ2YWw6ICRJbnRlcnZhbFByb3ZpZGVyLAogICAgICAgICAgJGh0dHA6ICRIdHRwUHJvdmlkZXIsCiAgICAgICAgICAkaHR0cEJhY2tlbmQ6ICRIdHRwQmFja2VuZFByb3ZpZGVyLAogICAgICAgICAgJGxvY2F0aW9uOiAkTG9jYXRpb25Qcm92aWRlciwKICAgICAgICAgICRsb2c6ICRMb2dQcm92aWRlciwKICAgICAgICAgICRwYXJzZTogJFBhcnNlUHJvdmlkZXIsCiAgICAgICAgICAkcm9vdFNjb3BlOiAkUm9vdFNjb3BlUHJvdmlkZXIsCiAgICAgICAgICAkcTogJFFQcm92aWRlciwKICAgICAgICAgICRzY2U6ICRTY2VQcm92aWRlciwKICAgICAgICAgICRzY2VEZWxlZ2F0ZTogJFNjZURlbGVnYXRlUHJvdmlkZXIsCiAgICAgICAgICAkc25pZmZlcjogJFNuaWZmZXJQcm92aWRlciwKICAgICAgICAgICR0ZW1wbGF0ZUNhY2hlOiAkVGVtcGxhdGVDYWNoZVByb3ZpZGVyLAogICAgICAgICAgJHRpbWVvdXQ6ICRUaW1lb3V0UHJvdmlkZXIsCiAgICAgICAgICAkd2luZG93OiAkV2luZG93UHJvdmlkZXIsCiAgICAgICAgICAkJHJBRjogJCRSQUZQcm92aWRlciwKICAgICAgICAgICQkYXN5bmNDYWxsYmFjayA6ICQkQXN5bmNDYWxsYmFja1Byb3ZpZGVyCiAgICAgICAgfSk7CiAgICAgIH0KICAgIF0pOwogIH0KCiAgLyogZ2xvYmFsCgogICAtSlFMaXRlUHJvdG90eXBlLAogICAtYWRkRXZlbnRMaXN0ZW5lckZuLAogICAtcmVtb3ZlRXZlbnRMaXN0ZW5lckZuLAogICAtQk9PTEVBTl9BVFRSCiAgICovCgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCi8vSlFMaXRlCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgYW5ndWxhci5lbGVtZW50CiAgICogQG1vZHVsZSBuZwogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBXcmFwcyBhIHJhdyBET00gZWxlbWVudCBvciBIVE1MIHN0cmluZyBhcyBhIFtqUXVlcnldKGh0dHA6Ly9qcXVlcnkuY29tKSBlbGVtZW50LgogICAqCiAgICogSWYgalF1ZXJ5IGlzIGF2YWlsYWJsZSwgYGFuZ3VsYXIuZWxlbWVudGAgaXMgYW4gYWxpYXMgZm9yIHRoZQogICAqIFtqUXVlcnldKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9qUXVlcnkvKSBmdW5jdGlvbi4gSWYgalF1ZXJ5IGlzIG5vdCBhdmFpbGFibGUsIGBhbmd1bGFyLmVsZW1lbnRgCiAgICogZGVsZWdhdGVzIHRvIEFuZ3VsYXIncyBidWlsdC1pbiBzdWJzZXQgb2YgalF1ZXJ5LCBjYWxsZWQgImpRdWVyeSBsaXRlIiBvciAianFMaXRlLiIKICAgKgogICAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXN1Y2Nlc3MiPmpxTGl0ZSBpcyBhIHRpbnksIEFQSS1jb21wYXRpYmxlIHN1YnNldCBvZiBqUXVlcnkgdGhhdCBhbGxvd3MKICAgKiBBbmd1bGFyIHRvIG1hbmlwdWxhdGUgdGhlIERPTSBpbiBhIGNyb3NzLWJyb3dzZXIgY29tcGF0aWJsZSB3YXkuICoqanFMaXRlKiogaW1wbGVtZW50cyBvbmx5IHRoZSBtb3N0CiAgICogY29tbW9ubHkgbmVlZGVkIGZ1bmN0aW9uYWxpdHkgd2l0aCB0aGUgZ29hbCBvZiBoYXZpbmcgYSB2ZXJ5IHNtYWxsIGZvb3RwcmludC48L2Rpdj4KICAgKgogICAqIFRvIHVzZSBqUXVlcnksIHNpbXBseSBsb2FkIGl0IGJlZm9yZSBgRE9NQ29udGVudExvYWRlZGAgZXZlbnQgZmlyZWQuCiAgICoKICAgKiA8ZGl2IGNsYXNzPSJhbGVydCI+KipOb3RlOioqIGFsbCBlbGVtZW50IHJlZmVyZW5jZXMgaW4gQW5ndWxhciBhcmUgYWx3YXlzIHdyYXBwZWQgd2l0aCBqUXVlcnkgb3IKICAgKiBqcUxpdGU7IHRoZXkgYXJlIG5ldmVyIHJhdyBET00gcmVmZXJlbmNlcy48L2Rpdj4KICAgKgogICAqICMjIEFuZ3VsYXIncyBqcUxpdGUKICAgKiBqcUxpdGUgcHJvdmlkZXMgb25seSB0aGUgZm9sbG93aW5nIGpRdWVyeSBtZXRob2RzOgogICAqCiAgICogLSBbYGFkZENsYXNzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYWRkQ2xhc3MvKQogICAqIC0gW2BhZnRlcigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2FmdGVyLykKICAgKiAtIFtgYXBwZW5kKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYXBwZW5kLykKICAgKiAtIFtgYXR0cigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2F0dHIvKQogICAqIC0gW2BiaW5kKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vYmluZC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzLCBzZWxlY3RvcnMgb3IgZXZlbnREYXRhCiAgICogLSBbYGNoaWxkcmVuKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY2hpbGRyZW4vKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAgICogLSBbYGNsb25lKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY2xvbmUvKQogICAqIC0gW2Bjb250ZW50cygpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2NvbnRlbnRzLykKICAgKiAtIFtgY3NzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vY3NzLykKICAgKiAtIFtgZGF0YSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2RhdGEvKQogICAqIC0gW2BlbXB0eSgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL2VtcHR5LykKICAgKiAtIFtgZXEoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9lcS8pCiAgICogLSBbYGZpbmQoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9maW5kLykgLSBMaW1pdGVkIHRvIGxvb2t1cHMgYnkgdGFnIG5hbWUKICAgKiAtIFtgaGFzQ2xhc3MoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9oYXNDbGFzcy8pCiAgICogLSBbYGh0bWwoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9odG1sLykKICAgKiAtIFtgbmV4dCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL25leHQvKSAtIERvZXMgbm90IHN1cHBvcnQgc2VsZWN0b3JzCiAgICogLSBbYG9uKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vb24vKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcywgc2VsZWN0b3JzIG9yIGV2ZW50RGF0YQogICAqIC0gW2BvZmYoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9vZmYvKSAtIERvZXMgbm90IHN1cHBvcnQgbmFtZXNwYWNlcyBvciBzZWxlY3RvcnMKICAgKiAtIFtgb25lKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vb25lLykgLSBEb2VzIG5vdCBzdXBwb3J0IG5hbWVzcGFjZXMgb3Igc2VsZWN0b3JzCiAgICogLSBbYHBhcmVudCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3BhcmVudC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBzZWxlY3RvcnMKICAgKiAtIFtgcHJlcGVuZCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ByZXBlbmQvKQogICAqIC0gW2Bwcm9wKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcHJvcC8pCiAgICogLSBbYHJlYWR5KClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVhZHkvKQogICAqIC0gW2ByZW1vdmUoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9yZW1vdmUvKQogICAqIC0gW2ByZW1vdmVBdHRyKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQXR0ci8pCiAgICogLSBbYHJlbW92ZUNsYXNzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlQ2xhc3MvKQogICAqIC0gW2ByZW1vdmVEYXRhKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVtb3ZlRGF0YS8pCiAgICogLSBbYHJlcGxhY2VXaXRoKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcmVwbGFjZVdpdGgvKQogICAqIC0gW2B0ZXh0KClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdGV4dC8pCiAgICogLSBbYHRvZ2dsZUNsYXNzKClgXShodHRwOi8vYXBpLmpxdWVyeS5jb20vdG9nZ2xlQ2xhc3MvKQogICAqIC0gW2B0cmlnZ2VySGFuZGxlcigpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3RyaWdnZXJIYW5kbGVyLykgLSBQYXNzZXMgYSBkdW1teSBldmVudCBvYmplY3QgdG8gaGFuZGxlcnMuCiAgICogLSBbYHVuYmluZCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3VuYmluZC8pIC0gRG9lcyBub3Qgc3VwcG9ydCBuYW1lc3BhY2VzCiAgICogLSBbYHZhbCgpYF0oaHR0cDovL2FwaS5qcXVlcnkuY29tL3ZhbC8pCiAgICogLSBbYHdyYXAoKWBdKGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS93cmFwLykKICAgKgogICAqICMjIGpRdWVyeS9qcUxpdGUgRXh0cmFzCiAgICogQW5ndWxhciBhbHNvIHByb3ZpZGVzIHRoZSBmb2xsb3dpbmcgYWRkaXRpb25hbCBtZXRob2RzIGFuZCBldmVudHMgdG8gYm90aCBqUXVlcnkgYW5kIGpxTGl0ZToKICAgKgogICAqICMjIyBFdmVudHMKICAgKiAtIGAkZGVzdHJveWAgLSBBbmd1bGFySlMgaW50ZXJjZXB0cyBhbGwganFMaXRlL2pRdWVyeSdzIERPTSBkZXN0cnVjdGlvbiBhcGlzIGFuZCBmaXJlcyB0aGlzIGV2ZW50CiAgICogICAgb24gYWxsIERPTSBub2RlcyBiZWluZyByZW1vdmVkLiAgVGhpcyBjYW4gYmUgdXNlZCB0byBjbGVhbiB1cCBhbnkgM3JkIHBhcnR5IGJpbmRpbmdzIHRvIHRoZSBET00KICAgKiAgICBlbGVtZW50IGJlZm9yZSBpdCBpcyByZW1vdmVkLgogICAqCiAgICogIyMjIE1ldGhvZHMKICAgKiAtIGBjb250cm9sbGVyKG5hbWUpYCAtIHJldHJpZXZlcyB0aGUgY29udHJvbGxlciBvZiB0aGUgY3VycmVudCBlbGVtZW50IG9yIGl0cyBwYXJlbnQuIEJ5IGRlZmF1bHQKICAgKiAgIHJldHJpZXZlcyBjb250cm9sbGVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgYG5nQ29udHJvbGxlcmAgZGlyZWN0aXZlLiBJZiBgbmFtZWAgaXMgcHJvdmlkZWQgYXMKICAgKiAgIGNhbWVsQ2FzZSBkaXJlY3RpdmUgbmFtZSwgdGhlbiB0aGUgY29udHJvbGxlciBmb3IgdGhpcyBkaXJlY3RpdmUgd2lsbCBiZSByZXRyaWV2ZWQgKGUuZy4KICAgKiAgIGAnbmdNb2RlbCdgKS4KICAgKiAtIGBpbmplY3RvcigpYCAtIHJldHJpZXZlcyB0aGUgaW5qZWN0b3Igb2YgdGhlIGN1cnJlbnQgZWxlbWVudCBvciBpdHMgcGFyZW50LgogICAqIC0gYHNjb3BlKClgIC0gcmV0cmlldmVzIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0gb2YgdGhlIGN1cnJlbnQKICAgKiAgIGVsZW1lbnQgb3IgaXRzIHBhcmVudC4KICAgKiAtIGBpc29sYXRlU2NvcGUoKWAgLSByZXRyaWV2ZXMgYW4gaXNvbGF0ZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0gaWYgb25lIGlzIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZQogICAqICAgY3VycmVudCBlbGVtZW50LiBUaGlzIGdldHRlciBzaG91bGQgYmUgdXNlZCBvbmx5IG9uIGVsZW1lbnRzIHRoYXQgY29udGFpbiBhIGRpcmVjdGl2ZSB3aGljaCBzdGFydHMgYSBuZXcgaXNvbGF0ZQogICAqICAgc2NvcGUuIENhbGxpbmcgYHNjb3BlKClgIG9uIHRoaXMgZWxlbWVudCBhbHdheXMgcmV0dXJucyB0aGUgb3JpZ2luYWwgbm9uLWlzb2xhdGUgc2NvcGUuCiAgICogLSBgaW5oZXJpdGVkRGF0YSgpYCAtIHNhbWUgYXMgYGRhdGEoKWAsIGJ1dCB3YWxrcyB1cCB0aGUgRE9NIHVudGlsIGEgdmFsdWUgaXMgZm91bmQgb3IgdGhlIHRvcAogICAqICAgcGFyZW50IGVsZW1lbnQgaXMgcmVhY2hlZC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfERPTUVsZW1lbnR9IGVsZW1lbnQgSFRNTCBzdHJpbmcgb3IgRE9NRWxlbWVudCB0byBiZSB3cmFwcGVkIGludG8galF1ZXJ5LgogICAqIEByZXR1cm5zIHtPYmplY3R9IGpRdWVyeSBvYmplY3QuCiAgICovCgogIHZhciBqcUNhY2hlID0gSlFMaXRlLmNhY2hlID0ge30sCiAgICBqcU5hbWUgPSBKUUxpdGUuZXhwYW5kbyA9ICduZycgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKICAgIGpxSWQgPSAxLAogICAgYWRkRXZlbnRMaXN0ZW5lckZuID0gKHdpbmRvdy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyCiAgICAgID8gZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZm4sIGZhbHNlKTt9CiAgICAgIDogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LmF0dGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7fSksCiAgICByZW1vdmVFdmVudExpc3RlbmVyRm4gPSAod2luZG93LmRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIKICAgICAgPyBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBmbikge2VsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOyB9CiAgICAgIDogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pIHtlbGVtZW50LmRldGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7IH0pOwoKICAvKgogICAqICEhISBUaGlzIGlzIGFuIHVuZG9jdW1lbnRlZCAicHJpdmF0ZSIgZnVuY3Rpb24gISEhCiAgICovCiAgdmFyIGpxRGF0YSA9IEpRTGl0ZS5fZGF0YSA9IGZ1bmN0aW9uKG5vZGUpIHsKICAgIC8valF1ZXJ5IGFsd2F5cyByZXR1cm5zIGFuIG9iamVjdCBvbiBjYWNoZSBtaXNzCiAgICByZXR1cm4gdGhpcy5jYWNoZVtub2RlW3RoaXMuZXhwYW5kb11dIHx8IHt9OwogIH07CgogIGZ1bmN0aW9uIGpxTmV4dElkKCkgeyByZXR1cm4gKytqcUlkOyB9CgoKICB2YXIgU1BFQ0lBTF9DSEFSU19SRUdFWFAgPSAvKFtcOlwtXF9dKyguKSkvZzsKICB2YXIgTU9aX0hBQ0tfUkVHRVhQID0gL15tb3ooW0EtWl0pLzsKICB2YXIganFMaXRlTWluRXJyID0gbWluRXJyKCdqcUxpdGUnKTsKCiAgLyoqCiAgICogQ29udmVydHMgc25ha2VfY2FzZSB0byBjYW1lbENhc2UuCiAgICogQWxzbyB0aGVyZSBpcyBzcGVjaWFsIGNhc2UgZm9yIE1veiBwcmVmaXggc3RhcnRpbmcgd2l0aCB1cHBlciBjYXNlIGxldHRlci4KICAgKiBAcGFyYW0gbmFtZSBOYW1lIHRvIG5vcm1hbGl6ZQogICAqLwogIGZ1bmN0aW9uIGNhbWVsQ2FzZShuYW1lKSB7CiAgICByZXR1cm4gbmFtZS4KICAgICAgcmVwbGFjZShTUEVDSUFMX0NIQVJTX1JFR0VYUCwgZnVuY3Rpb24oXywgc2VwYXJhdG9yLCBsZXR0ZXIsIG9mZnNldCkgewogICAgICAgIHJldHVybiBvZmZzZXQgPyBsZXR0ZXIudG9VcHBlckNhc2UoKSA6IGxldHRlcjsKICAgICAgfSkuCiAgICAgIHJlcGxhY2UoTU9aX0hBQ0tfUkVHRVhQLCAnTW96JDEnKTsKICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8galF1ZXJ5IG11dGF0aW9uIHBhdGNoCi8vCi8vIEluIGNvbmp1bmN0aW9uIHdpdGggYmluZEpRdWVyeSBpbnRlcmNlcHRzIGFsbCBqUXVlcnkncyBET00gZGVzdHJ1Y3Rpb24gYXBpcyBhbmQgZmlyZXMgYQovLyAkZGVzdHJveSBldmVudCBvbiBhbGwgRE9NIG5vZGVzIGJlaW5nIHJlbW92ZWQuCi8vCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICBmdW5jdGlvbiBqcUxpdGVQYXRjaEpRdWVyeVJlbW92ZShuYW1lLCBkaXNwYXRjaFRoaXMsIGZpbHRlckVsZW1zLCBnZXR0ZXJJZk5vQXJndW1lbnRzKSB7CiAgICB2YXIgb3JpZ2luYWxKcUZuID0galF1ZXJ5LmZuW25hbWVdOwogICAgb3JpZ2luYWxKcUZuID0gb3JpZ2luYWxKcUZuLiRvcmlnaW5hbCB8fCBvcmlnaW5hbEpxRm47CiAgICByZW1vdmVQYXRjaC4kb3JpZ2luYWwgPSBvcmlnaW5hbEpxRm47CiAgICBqUXVlcnkuZm5bbmFtZV0gPSByZW1vdmVQYXRjaDsKCiAgICBmdW5jdGlvbiByZW1vdmVQYXRjaChwYXJhbSkgewogICAgICAvLyBqc2hpbnQgLVcwNDAKICAgICAgdmFyIGxpc3QgPSBmaWx0ZXJFbGVtcyAmJiBwYXJhbSA/IFt0aGlzLmZpbHRlcihwYXJhbSldIDogW3RoaXNdLAogICAgICAgIGZpcmVFdmVudCA9IGRpc3BhdGNoVGhpcywKICAgICAgICBzZXQsIHNldEluZGV4LCBzZXRMZW5ndGgsCiAgICAgICAgZWxlbWVudCwgY2hpbGRJbmRleCwgY2hpbGRMZW5ndGgsIGNoaWxkcmVuOwoKICAgICAgaWYgKCFnZXR0ZXJJZk5vQXJndW1lbnRzIHx8IHBhcmFtICE9IG51bGwpIHsKICAgICAgICB3aGlsZShsaXN0Lmxlbmd0aCkgewogICAgICAgICAgc2V0ID0gbGlzdC5zaGlmdCgpOwogICAgICAgICAgZm9yKHNldEluZGV4ID0gMCwgc2V0TGVuZ3RoID0gc2V0Lmxlbmd0aDsgc2V0SW5kZXggPCBzZXRMZW5ndGg7IHNldEluZGV4KyspIHsKICAgICAgICAgICAgZWxlbWVudCA9IGpxTGl0ZShzZXRbc2V0SW5kZXhdKTsKICAgICAgICAgICAgaWYgKGZpcmVFdmVudCkgewogICAgICAgICAgICAgIGVsZW1lbnQudHJpZ2dlckhhbmRsZXIoJyRkZXN0cm95Jyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZmlyZUV2ZW50ID0gIWZpcmVFdmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IoY2hpbGRJbmRleCA9IDAsIGNoaWxkTGVuZ3RoID0gKGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZHJlbigpKS5sZW5ndGg7CiAgICAgICAgICAgICAgICBjaGlsZEluZGV4IDwgY2hpbGRMZW5ndGg7CiAgICAgICAgICAgICAgICBjaGlsZEluZGV4KyspIHsKICAgICAgICAgICAgICBsaXN0LnB1c2goalF1ZXJ5KGNoaWxkcmVuW2NoaWxkSW5kZXhdKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG9yaWdpbmFsSnFGbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIH0KCiAgdmFyIFNJTkdMRV9UQUdfUkVHRVhQID0gL148KFx3KylccypcLz8+KD86PFwvXDE+fCkkLzsKICB2YXIgSFRNTF9SRUdFWFAgPSAvPHwmIz9cdys7LzsKICB2YXIgVEFHX05BTUVfUkVHRVhQID0gLzwoW1x3Ol0rKS87CiAgdmFyIFhIVE1MX1RBR19SRUdFWFAgPSAvPCg/IWFyZWF8YnJ8Y29sfGVtYmVkfGhyfGltZ3xpbnB1dHxsaW5rfG1ldGF8cGFyYW0pKChbXHc6XSspW14+XSopXC8+L2dpOwoKICB2YXIgd3JhcE1hcCA9IHsKICAgICdvcHRpb24nOiBbMSwgJzxzZWxlY3QgbXVsdGlwbGU9Im11bHRpcGxlIj4nLCAnPC9zZWxlY3Q+J10sCgogICAgJ3RoZWFkJzogWzEsICc8dGFibGU+JywgJzwvdGFibGU+J10sCiAgICAnY29sJzogWzIsICc8dGFibGU+PGNvbGdyb3VwPicsICc8L2NvbGdyb3VwPjwvdGFibGU+J10sCiAgICAndHInOiBbMiwgJzx0YWJsZT48dGJvZHk+JywgJzwvdGJvZHk+PC90YWJsZT4nXSwKICAgICd0ZCc6IFszLCAnPHRhYmxlPjx0Ym9keT48dHI+JywgJzwvdHI+PC90Ym9keT48L3RhYmxlPiddLAogICAgJ19kZWZhdWx0JzogWzAsICIiLCAiIl0KICB9OwoKICB3cmFwTWFwLm9wdGdyb3VwID0gd3JhcE1hcC5vcHRpb247CiAgd3JhcE1hcC50Ym9keSA9IHdyYXBNYXAudGZvb3QgPSB3cmFwTWFwLmNvbGdyb3VwID0gd3JhcE1hcC5jYXB0aW9uID0gd3JhcE1hcC50aGVhZDsKICB3cmFwTWFwLnRoID0gd3JhcE1hcC50ZDsKCiAgZnVuY3Rpb24ganFMaXRlSXNUZXh0Tm9kZShodG1sKSB7CiAgICByZXR1cm4gIUhUTUxfUkVHRVhQLnRlc3QoaHRtbCk7CiAgfQoKICBmdW5jdGlvbiBqcUxpdGVCdWlsZEZyYWdtZW50KGh0bWwsIGNvbnRleHQpIHsKICAgIHZhciBlbGVtLCB0bXAsIHRhZywgd3JhcCwKICAgICAgZnJhZ21lbnQgPSBjb250ZXh0LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKICAgICAgbm9kZXMgPSBbXSwgaSwgaiwgamo7CgogICAgaWYgKGpxTGl0ZUlzVGV4dE5vZGUoaHRtbCkpIHsKICAgICAgLy8gQ29udmVydCBub24taHRtbCBpbnRvIGEgdGV4dCBub2RlCiAgICAgIG5vZGVzLnB1c2goY29udGV4dC5jcmVhdGVUZXh0Tm9kZShodG1sKSk7CiAgICB9IGVsc2UgewogICAgICB0bXAgPSBmcmFnbWVudC5hcHBlbmRDaGlsZChjb250ZXh0LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKTsKICAgICAgLy8gQ29udmVydCBodG1sIGludG8gRE9NIG5vZGVzCiAgICAgIHRhZyA9IChUQUdfTkFNRV9SRUdFWFAuZXhlYyhodG1sKSB8fCBbIiIsICIiXSlbMV0udG9Mb3dlckNhc2UoKTsKICAgICAgd3JhcCA9IHdyYXBNYXBbdGFnXSB8fCB3cmFwTWFwLl9kZWZhdWx0OwogICAgICB0bXAuaW5uZXJIVE1MID0gJzxkaXY+JiMxNjA7PC9kaXY+JyArCiAgICAgICAgd3JhcFsxXSArIGh0bWwucmVwbGFjZShYSFRNTF9UQUdfUkVHRVhQLCAiPCQxPjwvJDI+IikgKyB3cmFwWzJdOwogICAgICB0bXAucmVtb3ZlQ2hpbGQodG1wLmZpcnN0Q2hpbGQpOwoKICAgICAgLy8gRGVzY2VuZCB0aHJvdWdoIHdyYXBwZXJzIHRvIHRoZSByaWdodCBjb250ZW50CiAgICAgIGkgPSB3cmFwWzBdOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgdG1wID0gdG1wLmxhc3RDaGlsZDsKICAgICAgfQoKICAgICAgZm9yIChqPTAsIGpqPXRtcC5jaGlsZE5vZGVzLmxlbmd0aDsgajxqajsgKytqKSBub2Rlcy5wdXNoKHRtcC5jaGlsZE5vZGVzW2pdKTsKCiAgICAgIHRtcCA9IGZyYWdtZW50LmZpcnN0Q2hpbGQ7CiAgICAgIHRtcC50ZXh0Q29udGVudCA9ICIiOwogICAgfQoKICAgIC8vIFJlbW92ZSB3cmFwcGVyIGZyb20gZnJhZ21lbnQKICAgIGZyYWdtZW50LnRleHRDb250ZW50ID0gIiI7CiAgICBmcmFnbWVudC5pbm5lckhUTUwgPSAiIjsgLy8gQ2xlYXIgaW5uZXIgSFRNTAogICAgcmV0dXJuIG5vZGVzOwogIH0KCiAgZnVuY3Rpb24ganFMaXRlUGFyc2VIVE1MKGh0bWwsIGNvbnRleHQpIHsKICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50OwogICAgdmFyIHBhcnNlZDsKCiAgICBpZiAoKHBhcnNlZCA9IFNJTkdMRV9UQUdfUkVHRVhQLmV4ZWMoaHRtbCkpKSB7CiAgICAgIHJldHVybiBbY29udGV4dC5jcmVhdGVFbGVtZW50KHBhcnNlZFsxXSldOwogICAgfQoKICAgIHJldHVybiBqcUxpdGVCdWlsZEZyYWdtZW50KGh0bWwsIGNvbnRleHQpOwogIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIGZ1bmN0aW9uIEpRTGl0ZShlbGVtZW50KSB7CiAgICBpZiAoZWxlbWVudCBpbnN0YW5jZW9mIEpRTGl0ZSkgewogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0KICAgIGlmIChpc1N0cmluZyhlbGVtZW50KSkgewogICAgICBlbGVtZW50ID0gdHJpbShlbGVtZW50KTsKICAgIH0KICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBKUUxpdGUpKSB7CiAgICAgIGlmIChpc1N0cmluZyhlbGVtZW50KSAmJiBlbGVtZW50LmNoYXJBdCgwKSAhPSAnPCcpIHsKICAgICAgICB0aHJvdyBqcUxpdGVNaW5FcnIoJ25vc2VsJywgJ0xvb2tpbmcgdXAgZWxlbWVudHMgdmlhIHNlbGVjdG9ycyBpcyBub3Qgc3VwcG9ydGVkIGJ5IGpxTGl0ZSEgU2VlOiBodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9hbmd1bGFyLmVsZW1lbnQnKTsKICAgICAgfQogICAgICByZXR1cm4gbmV3IEpRTGl0ZShlbGVtZW50KTsKICAgIH0KCiAgICBpZiAoaXNTdHJpbmcoZWxlbWVudCkpIHsKICAgICAganFMaXRlQWRkTm9kZXModGhpcywganFMaXRlUGFyc2VIVE1MKGVsZW1lbnQpKTsKICAgICAgdmFyIGZyYWdtZW50ID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSk7CiAgICAgIGZyYWdtZW50LmFwcGVuZCh0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIGpxTGl0ZUFkZE5vZGVzKHRoaXMsIGVsZW1lbnQpOwogICAgfQogIH0KCiAgZnVuY3Rpb24ganFMaXRlQ2xvbmUoZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQuY2xvbmVOb2RlKHRydWUpOwogIH0KCiAgZnVuY3Rpb24ganFMaXRlRGVhbG9jKGVsZW1lbnQpewogICAganFMaXRlUmVtb3ZlRGF0YShlbGVtZW50KTsKICAgIGZvciAoIHZhciBpID0gMCwgY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkTm9kZXMgfHwgW107IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBqcUxpdGVEZWFsb2MoY2hpbGRyZW5baV0pOwogICAgfQogIH0KCiAgZnVuY3Rpb24ganFMaXRlT2ZmKGVsZW1lbnQsIHR5cGUsIGZuLCB1bnN1cHBvcnRlZCkgewogICAgaWYgKGlzRGVmaW5lZCh1bnN1cHBvcnRlZCkpIHRocm93IGpxTGl0ZU1pbkVycignb2ZmYXJncycsICdqcUxpdGUjb2ZmKCkgZG9lcyBub3Qgc3VwcG9ydCB0aGUgYHNlbGVjdG9yYCBhcmd1bWVudCcpOwoKICAgIHZhciBldmVudHMgPSBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2V2ZW50cycpLAogICAgICBoYW5kbGUgPSBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2hhbmRsZScpOwoKICAgIGlmICghaGFuZGxlKSByZXR1cm47IC8vbm8gbGlzdGVuZXJzIHJlZ2lzdGVyZWQKCiAgICBpZiAoaXNVbmRlZmluZWQodHlwZSkpIHsKICAgICAgZm9yRWFjaChldmVudHMsIGZ1bmN0aW9uKGV2ZW50SGFuZGxlciwgdHlwZSkgewogICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihlbGVtZW50LCB0eXBlLCBldmVudEhhbmRsZXIpOwogICAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZm9yRWFjaCh0eXBlLnNwbGl0KCcgJyksIGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICBpZiAoaXNVbmRlZmluZWQoZm4pKSB7CiAgICAgICAgICByZW1vdmVFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgZXZlbnRzW3R5cGVdKTsKICAgICAgICAgIGRlbGV0ZSBldmVudHNbdHlwZV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFycmF5UmVtb3ZlKGV2ZW50c1t0eXBlXSB8fCBbXSwgZm4pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBqcUxpdGVSZW1vdmVEYXRhKGVsZW1lbnQsIG5hbWUpIHsKICAgIHZhciBleHBhbmRvSWQgPSBlbGVtZW50W2pxTmFtZV0sCiAgICAgIGV4cGFuZG9TdG9yZSA9IGpxQ2FjaGVbZXhwYW5kb0lkXTsKCiAgICBpZiAoZXhwYW5kb1N0b3JlKSB7CiAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgZGVsZXRlIGpxQ2FjaGVbZXhwYW5kb0lkXS5kYXRhW25hbWVdOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGV4cGFuZG9TdG9yZS5oYW5kbGUpIHsKICAgICAgICBleHBhbmRvU3RvcmUuZXZlbnRzLiRkZXN0cm95ICYmIGV4cGFuZG9TdG9yZS5oYW5kbGUoe30sICckZGVzdHJveScpOwogICAgICAgIGpxTGl0ZU9mZihlbGVtZW50KTsKICAgICAgfQogICAgICBkZWxldGUganFDYWNoZVtleHBhbmRvSWRdOwogICAgICBlbGVtZW50W2pxTmFtZV0gPSB1bmRlZmluZWQ7IC8vIGllIGRvZXMgbm90IGFsbG93IGRlbGV0aW9uIG9mIGF0dHJpYnV0ZXMgb24gZWxlbWVudHMuCiAgICB9CiAgfQoKICBmdW5jdGlvbiBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogICAgdmFyIGV4cGFuZG9JZCA9IGVsZW1lbnRbanFOYW1lXSwKICAgICAgZXhwYW5kb1N0b3JlID0ganFDYWNoZVtleHBhbmRvSWQgfHwgLTFdOwoKICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgIGlmICghZXhwYW5kb1N0b3JlKSB7CiAgICAgICAgZWxlbWVudFtqcU5hbWVdID0gZXhwYW5kb0lkID0ganFOZXh0SWQoKTsKICAgICAgICBleHBhbmRvU3RvcmUgPSBqcUNhY2hlW2V4cGFuZG9JZF0gPSB7fTsKICAgICAgfQogICAgICBleHBhbmRvU3RvcmVba2V5XSA9IHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGV4cGFuZG9TdG9yZSAmJiBleHBhbmRvU3RvcmVba2V5XTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGpxTGl0ZURhdGEoZWxlbWVudCwga2V5LCB2YWx1ZSkgewogICAgdmFyIGRhdGEgPSBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2RhdGEnKSwKICAgICAgaXNTZXR0ZXIgPSBpc0RlZmluZWQodmFsdWUpLAogICAgICBrZXlEZWZpbmVkID0gIWlzU2V0dGVyICYmIGlzRGVmaW5lZChrZXkpLAogICAgICBpc1NpbXBsZUdldHRlciA9IGtleURlZmluZWQgJiYgIWlzT2JqZWN0KGtleSk7CgogICAgaWYgKCFkYXRhICYmICFpc1NpbXBsZUdldHRlcikgewogICAgICBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2RhdGEnLCBkYXRhID0ge30pOwogICAgfQoKICAgIGlmIChpc1NldHRlcikgewogICAgICBkYXRhW2tleV0gPSB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChrZXlEZWZpbmVkKSB7CiAgICAgICAgaWYgKGlzU2ltcGxlR2V0dGVyKSB7CiAgICAgICAgICAvLyBkb24ndCBjcmVhdGUgZGF0YSBpbiB0aGlzIGNhc2UuCiAgICAgICAgICByZXR1cm4gZGF0YSAmJiBkYXRhW2tleV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4dGVuZChkYXRhLCBrZXkpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24ganFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgIGlmICghZWxlbWVudC5nZXRBdHRyaWJ1dGUpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiAoKCIgIiArIChlbGVtZW50LmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICIpLnJlcGxhY2UoL1tcblx0XS9nLCAiICIpLgogICAgICBpbmRleE9mKCAiICIgKyBzZWxlY3RvciArICIgIiApID4gLTEpOwogIH0KCiAgZnVuY3Rpb24ganFMaXRlUmVtb3ZlQ2xhc3MoZWxlbWVudCwgY3NzQ2xhc3NlcykgewogICAgaWYgKGNzc0NsYXNzZXMgJiYgZWxlbWVudC5zZXRBdHRyaWJ1dGUpIHsKICAgICAgZm9yRWFjaChjc3NDbGFzc2VzLnNwbGl0KCcgJyksIGZ1bmN0aW9uKGNzc0NsYXNzKSB7CiAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgdHJpbSgKICAgICAgICAgICAgKCIgIiArIChlbGVtZW50LmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICIpCiAgICAgICAgICAgICAgLnJlcGxhY2UoL1tcblx0XS9nLCAiICIpCiAgICAgICAgICAgICAgLnJlcGxhY2UoIiAiICsgdHJpbShjc3NDbGFzcykgKyAiICIsICIgIikpCiAgICAgICAgKTsKICAgICAgfSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBqcUxpdGVBZGRDbGFzcyhlbGVtZW50LCBjc3NDbGFzc2VzKSB7CiAgICBpZiAoY3NzQ2xhc3NlcyAmJiBlbGVtZW50LnNldEF0dHJpYnV0ZSkgewogICAgICB2YXIgZXhpc3RpbmdDbGFzc2VzID0gKCcgJyArIChlbGVtZW50LmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAnICcpCiAgICAgICAgLnJlcGxhY2UoL1tcblx0XS9nLCAiICIpOwoKICAgICAgZm9yRWFjaChjc3NDbGFzc2VzLnNwbGl0KCcgJyksIGZ1bmN0aW9uKGNzc0NsYXNzKSB7CiAgICAgICAgY3NzQ2xhc3MgPSB0cmltKGNzc0NsYXNzKTsKICAgICAgICBpZiAoZXhpc3RpbmdDbGFzc2VzLmluZGV4T2YoJyAnICsgY3NzQ2xhc3MgKyAnICcpID09PSAtMSkgewogICAgICAgICAgZXhpc3RpbmdDbGFzc2VzICs9IGNzc0NsYXNzICsgJyAnOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCB0cmltKGV4aXN0aW5nQ2xhc3NlcykpOwogICAgfQogIH0KCiAgZnVuY3Rpb24ganFMaXRlQWRkTm9kZXMocm9vdCwgZWxlbWVudHMpIHsKICAgIGlmIChlbGVtZW50cykgewogICAgICBlbGVtZW50cyA9ICghZWxlbWVudHMubm9kZU5hbWUgJiYgaXNEZWZpbmVkKGVsZW1lbnRzLmxlbmd0aCkgJiYgIWlzV2luZG93KGVsZW1lbnRzKSkKICAgICAgICA/IGVsZW1lbnRzCiAgICAgICAgOiBbIGVsZW1lbnRzIF07CiAgICAgIGZvcih2YXIgaT0wOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICByb290LnB1c2goZWxlbWVudHNbaV0pOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBqcUxpdGVDb250cm9sbGVyKGVsZW1lbnQsIG5hbWUpIHsKICAgIHJldHVybiBqcUxpdGVJbmhlcml0ZWREYXRhKGVsZW1lbnQsICckJyArIChuYW1lIHx8ICduZ0NvbnRyb2xsZXInICkgKyAnQ29udHJvbGxlcicpOwogIH0KCiAgZnVuY3Rpb24ganFMaXRlSW5oZXJpdGVkRGF0YShlbGVtZW50LCBuYW1lLCB2YWx1ZSkgewogICAgZWxlbWVudCA9IGpxTGl0ZShlbGVtZW50KTsKCiAgICAvLyBpZiBlbGVtZW50IGlzIHRoZSBkb2N1bWVudCBvYmplY3Qgd29yayB3aXRoIHRoZSBodG1sIGVsZW1lbnQgaW5zdGVhZAogICAgLy8gdGhpcyBtYWtlcyAkKGRvY3VtZW50KS5zY29wZSgpIHBvc3NpYmxlCiAgICBpZihlbGVtZW50WzBdLm5vZGVUeXBlID09IDkpIHsKICAgICAgZWxlbWVudCA9IGVsZW1lbnQuZmluZCgnaHRtbCcpOwogICAgfQogICAgdmFyIG5hbWVzID0gaXNBcnJheShuYW1lKSA/IG5hbWUgOiBbbmFtZV07CgogICAgd2hpbGUgKGVsZW1lbnQubGVuZ3RoKSB7CiAgICAgIHZhciBub2RlID0gZWxlbWVudFswXTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGlpID0gbmFtZXMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgIGlmICgodmFsdWUgPSBlbGVtZW50LmRhdGEobmFtZXNbaV0pKSAhPT0gdW5kZWZpbmVkKSByZXR1cm4gdmFsdWU7CiAgICAgIH0KCiAgICAgIC8vIElmIGRlYWxpbmcgd2l0aCBhIGRvY3VtZW50IGZyYWdtZW50IG5vZGUgd2l0aCBhIGhvc3QgZWxlbWVudCwgYW5kIG5vIHBhcmVudCwgdXNlIHRoZSBob3N0CiAgICAgIC8vIGVsZW1lbnQgYXMgdGhlIHBhcmVudC4gVGhpcyBlbmFibGVzIGRpcmVjdGl2ZXMgd2l0aGluIGEgU2hhZG93IERPTSBvciBwb2x5ZmlsbGVkIFNoYWRvdyBET00KICAgICAgLy8gdG8gbG9va3VwIHBhcmVudCBjb250cm9sbGVycy4KICAgICAgZWxlbWVudCA9IGpxTGl0ZShub2RlLnBhcmVudE5vZGUgfHwgKG5vZGUubm9kZVR5cGUgPT09IDExICYmIG5vZGUuaG9zdCkpOwogICAgfQogIH0KCiAgZnVuY3Rpb24ganFMaXRlRW1wdHkoZWxlbWVudCkgewogICAgZm9yICh2YXIgaSA9IDAsIGNoaWxkTm9kZXMgPSBlbGVtZW50LmNoaWxkTm9kZXM7IGkgPCBjaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGpxTGl0ZURlYWxvYyhjaGlsZE5vZGVzW2ldKTsKICAgIH0KICAgIHdoaWxlIChlbGVtZW50LmZpcnN0Q2hpbGQpIHsKICAgICAgZWxlbWVudC5yZW1vdmVDaGlsZChlbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgfQogIH0KCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgd2hpY2ggYXJlIGRlY2xhcmVkIGRpcmVjdGx5LgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICB2YXIgSlFMaXRlUHJvdG90eXBlID0gSlFMaXRlLnByb3RvdHlwZSA9IHsKICAgIHJlYWR5OiBmdW5jdGlvbihmbikgewogICAgICB2YXIgZmlyZWQgPSBmYWxzZTsKCiAgICAgIGZ1bmN0aW9uIHRyaWdnZXIoKSB7CiAgICAgICAgaWYgKGZpcmVkKSByZXR1cm47CiAgICAgICAgZmlyZWQgPSB0cnVlOwogICAgICAgIGZuKCk7CiAgICAgIH0KCiAgICAgIC8vIGNoZWNrIGlmIGRvY3VtZW50IGFscmVhZHkgaXMgbG9hZGVkCiAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKXsKICAgICAgICBzZXRUaW1lb3V0KHRyaWdnZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub24oJ0RPTUNvbnRlbnRMb2FkZWQnLCB0cmlnZ2VyKTsgLy8gd29ya3MgZm9yIG1vZGVybiBicm93c2VycyBhbmQgSUU5CiAgICAgICAgLy8gd2UgY2FuIG5vdCB1c2UganFMaXRlIHNpbmNlIHdlIGFyZSBub3QgZG9uZSBsb2FkaW5nIGFuZCBqUXVlcnkgY291bGQgYmUgbG9hZGVkIGxhdGVyLgogICAgICAgIC8vIGpzaGludCAtVzA2NAogICAgICAgIEpRTGl0ZSh3aW5kb3cpLm9uKCdsb2FkJywgdHJpZ2dlcik7IC8vIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQgZm9yIG90aGVycwogICAgICAgIC8vIGpzaGludCArVzA2NAogICAgICB9CiAgICB9LAogICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmFsdWUgPSBbXTsKICAgICAgZm9yRWFjaCh0aGlzLCBmdW5jdGlvbihlKXsgdmFsdWUucHVzaCgnJyArIGUpO30pOwogICAgICByZXR1cm4gJ1snICsgdmFsdWUuam9pbignLCAnKSArICddJzsKICAgIH0sCgogICAgZXE6IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgIHJldHVybiAoaW5kZXggPj0gMCkgPyBqcUxpdGUodGhpc1tpbmRleF0pIDoganFMaXRlKHRoaXNbdGhpcy5sZW5ndGggKyBpbmRleF0pOwogICAgfSwKCiAgICBsZW5ndGg6IDAsCiAgICBwdXNoOiBwdXNoLAogICAgc29ydDogW10uc29ydCwKICAgIHNwbGljZTogW10uc3BsaWNlCiAgfTsKCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBGdW5jdGlvbnMgaXRlcmF0aW5nIGdldHRlci9zZXR0ZXJzLgovLyB0aGVzZSBmdW5jdGlvbnMgcmV0dXJuIHNlbGYgb24gc2V0dGVyIGFuZAovLyB2YWx1ZSBvbiBnZXQuCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIHZhciBCT09MRUFOX0FUVFIgPSB7fTsKICBmb3JFYWNoKCdtdWx0aXBsZSxzZWxlY3RlZCxjaGVja2VkLGRpc2FibGVkLHJlYWRPbmx5LHJlcXVpcmVkLG9wZW4nLnNwbGl0KCcsJyksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICBCT09MRUFOX0FUVFJbbG93ZXJjYXNlKHZhbHVlKV0gPSB2YWx1ZTsKICB9KTsKICB2YXIgQk9PTEVBTl9FTEVNRU5UUyA9IHt9OwogIGZvckVhY2goJ2lucHV0LHNlbGVjdCxvcHRpb24sdGV4dGFyZWEsYnV0dG9uLGZvcm0sZGV0YWlscycuc3BsaXQoJywnKSwgZnVuY3Rpb24odmFsdWUpIHsKICAgIEJPT0xFQU5fRUxFTUVOVFNbdXBwZXJjYXNlKHZhbHVlKV0gPSB0cnVlOwogIH0pOwoKICBmdW5jdGlvbiBnZXRCb29sZWFuQXR0ck5hbWUoZWxlbWVudCwgbmFtZSkgewogICAgLy8gY2hlY2sgZG9tIGxhc3Qgc2luY2Ugd2Ugd2lsbCBtb3N0IGxpa2VseSBmYWlsIG9uIG5hbWUKICAgIHZhciBib29sZWFuQXR0ciA9IEJPT0xFQU5fQVRUUltuYW1lLnRvTG93ZXJDYXNlKCldOwoKICAgIC8vIGJvb2xlYW5BdHRyIGlzIGhlcmUgdHdpY2UgdG8gbWluaW1pemUgRE9NIGFjY2VzcwogICAgcmV0dXJuIGJvb2xlYW5BdHRyICYmIEJPT0xFQU5fRUxFTUVOVFNbZWxlbWVudC5ub2RlTmFtZV0gJiYgYm9vbGVhbkF0dHI7CiAgfQoKICBmb3JFYWNoKHsKICAgIGRhdGE6IGpxTGl0ZURhdGEsCiAgICBpbmhlcml0ZWREYXRhOiBqcUxpdGVJbmhlcml0ZWREYXRhLAoKICAgIHNjb3BlOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgIC8vIENhbid0IHVzZSBqcUxpdGVEYXRhIGhlcmUgZGlyZWN0bHkgc28gd2Ugc3RheSBjb21wYXRpYmxlIHdpdGggalF1ZXJ5IQogICAgICByZXR1cm4ganFMaXRlKGVsZW1lbnQpLmRhdGEoJyRzY29wZScpIHx8IGpxTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudC5wYXJlbnROb2RlIHx8IGVsZW1lbnQsIFsnJGlzb2xhdGVTY29wZScsICckc2NvcGUnXSk7CiAgICB9LAoKICAgIGlzb2xhdGVTY29wZTogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAvLyBDYW4ndCB1c2UganFMaXRlRGF0YSBoZXJlIGRpcmVjdGx5IHNvIHdlIHN0YXkgY29tcGF0aWJsZSB3aXRoIGpRdWVyeSEKICAgICAgcmV0dXJuIGpxTGl0ZShlbGVtZW50KS5kYXRhKCckaXNvbGF0ZVNjb3BlJykgfHwganFMaXRlKGVsZW1lbnQpLmRhdGEoJyRpc29sYXRlU2NvcGVOb1RlbXBsYXRlJyk7CiAgICB9LAoKICAgIGNvbnRyb2xsZXI6IGpxTGl0ZUNvbnRyb2xsZXIsCgogICAgaW5qZWN0b3I6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgcmV0dXJuIGpxTGl0ZUluaGVyaXRlZERhdGEoZWxlbWVudCwgJyRpbmplY3RvcicpOwogICAgfSwKCiAgICByZW1vdmVBdHRyOiBmdW5jdGlvbihlbGVtZW50LG5hbWUpIHsKICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CiAgICB9LAoKICAgIGhhc0NsYXNzOiBqcUxpdGVIYXNDbGFzcywKCiAgICBjc3M6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUsIHZhbHVlKSB7CiAgICAgIG5hbWUgPSBjYW1lbENhc2UobmFtZSk7CgogICAgICBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgIGVsZW1lbnQuc3R5bGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgdmFsOwoKICAgICAgICBpZiAobXNpZSA8PSA4KSB7CiAgICAgICAgICAvLyB0aGlzIGlzIHNvbWUgSUUgc3BlY2lmaWMgd2VpcmRuZXNzIHRoYXQgalF1ZXJ5IDEuNi40IGRvZXMgbm90IHN1cmUgd2h5CiAgICAgICAgICB2YWwgPSBlbGVtZW50LmN1cnJlbnRTdHlsZSAmJiBlbGVtZW50LmN1cnJlbnRTdHlsZVtuYW1lXTsKICAgICAgICAgIGlmICh2YWwgPT09ICcnKSB2YWwgPSAnYXV0byc7CiAgICAgICAgfQoKICAgICAgICB2YWwgPSB2YWwgfHwgZWxlbWVudC5zdHlsZVtuYW1lXTsKCiAgICAgICAgaWYgKG1zaWUgPD0gOCkgewogICAgICAgICAgLy8ganF1ZXJ5IHdlaXJkbmVzcyA6LS8KICAgICAgICAgIHZhbCA9ICh2YWwgPT09ICcnKSA/IHVuZGVmaW5lZCA6IHZhbDsKICAgICAgICB9CgogICAgICAgIHJldHVybiAgdmFsOwogICAgICB9CiAgICB9LAoKICAgIGF0dHI6IGZ1bmN0aW9uKGVsZW1lbnQsIG5hbWUsIHZhbHVlKXsKICAgICAgdmFyIGxvd2VyY2FzZWROYW1lID0gbG93ZXJjYXNlKG5hbWUpOwogICAgICBpZiAoQk9PTEVBTl9BVFRSW2xvd2VyY2FzZWROYW1lXSkgewogICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICBpZiAoISF2YWx1ZSkgewogICAgICAgICAgICBlbGVtZW50W25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUobmFtZSwgbG93ZXJjYXNlZE5hbWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbWVudFtuYW1lXSA9IGZhbHNlOwogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZShsb3dlcmNhc2VkTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiAoZWxlbWVudFtuYW1lXSB8fAogICAgICAgICAgICAoZWxlbWVudC5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbShuYW1lKXx8IG5vb3ApLnNwZWNpZmllZCkKICAgICAgICAgICAgPyBsb3dlcmNhc2VkTmFtZQogICAgICAgICAgICA6IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHZhbHVlKSkgewogICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgICAgfSBlbHNlIGlmIChlbGVtZW50LmdldEF0dHJpYnV0ZSkgewogICAgICAgIC8vIHRoZSBleHRyYSBhcmd1bWVudCAiMiIgaXMgdG8gZ2V0IHRoZSByaWdodCB0aGluZyBmb3IgYS5ocmVmIGluIElFLCBzZWUgalF1ZXJ5IGNvZGUKICAgICAgICAvLyBzb21lIGVsZW1lbnRzIChlLmcuIERvY3VtZW50KSBkb24ndCBoYXZlIGdldCBhdHRyaWJ1dGUsIHNvIHJldHVybiB1bmRlZmluZWQKICAgICAgICB2YXIgcmV0ID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUobmFtZSwgMik7CiAgICAgICAgLy8gbm9ybWFsaXplIG5vbi1leGlzdGluZyBhdHRyaWJ1dGVzIHRvIHVuZGVmaW5lZCAoYXMgalF1ZXJ5KQogICAgICAgIHJldHVybiByZXQgPT09IG51bGwgPyB1bmRlZmluZWQgOiByZXQ7CiAgICAgIH0KICAgIH0sCgogICAgcHJvcDogZnVuY3Rpb24oZWxlbWVudCwgbmFtZSwgdmFsdWUpIHsKICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICBlbGVtZW50W25hbWVdID0gdmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnRbbmFtZV07CiAgICAgIH0KICAgIH0sCgogICAgdGV4dDogKGZ1bmN0aW9uKCkgewogICAgICB2YXIgTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFkgPSBbXTsKICAgICAgaWYgKG1zaWUgPCA5KSB7CiAgICAgICAgTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFlbMV0gPSAnaW5uZXJUZXh0JzsgICAgLyoqIEVsZW1lbnQgKiovCiAgICAgICAgTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFlbM10gPSAnbm9kZVZhbHVlJzsgICAgLyoqIFRleHQgKiovCiAgICAgIH0gZWxzZSB7CiAgICAgICAgTk9ERV9UWVBFX1RFWFRfUFJPUEVSVFlbMV0gPSAgICAgICAgICAgICAgICAgLyoqIEVsZW1lbnQgKiovCiAgICAgICAgICBOT0RFX1RZUEVfVEVYVF9QUk9QRVJUWVszXSA9ICd0ZXh0Q29udGVudCc7ICAvKiogVGV4dCAqKi8KICAgICAgfQogICAgICBnZXRUZXh0LiRkdiA9ICcnOwogICAgICByZXR1cm4gZ2V0VGV4dDsKCiAgICAgIGZ1bmN0aW9uIGdldFRleHQoZWxlbWVudCwgdmFsdWUpIHsKICAgICAgICB2YXIgdGV4dFByb3AgPSBOT0RFX1RZUEVfVEVYVF9QUk9QRVJUWVtlbGVtZW50Lm5vZGVUeXBlXTsKICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICByZXR1cm4gdGV4dFByb3AgPyBlbGVtZW50W3RleHRQcm9wXSA6ICcnOwogICAgICAgIH0KICAgICAgICBlbGVtZW50W3RleHRQcm9wXSA9IHZhbHVlOwogICAgICB9CiAgICB9KSgpLAoKICAgIHZhbDogZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgIGlmIChub2RlTmFtZV8oZWxlbWVudCkgPT09ICdTRUxFQ1QnICYmIGVsZW1lbnQubXVsdGlwbGUpIHsKICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgIGZvckVhY2goZWxlbWVudC5vcHRpb25zLCBmdW5jdGlvbiAob3B0aW9uKSB7CiAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaChvcHRpb24udmFsdWUgfHwgb3B0aW9uLnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiByZXN1bHQubGVuZ3RoID09PSAwID8gbnVsbCA6IHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGVsZW1lbnQudmFsdWU7CiAgICAgIH0KICAgICAgZWxlbWVudC52YWx1ZSA9IHZhbHVlOwogICAgfSwKCiAgICBodG1sOiBmdW5jdGlvbihlbGVtZW50LCB2YWx1ZSkgewogICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnQuaW5uZXJIVE1MOwogICAgICB9CiAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZE5vZGVzID0gZWxlbWVudC5jaGlsZE5vZGVzOyBpIDwgY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGpxTGl0ZURlYWxvYyhjaGlsZE5vZGVzW2ldKTsKICAgICAgfQogICAgICBlbGVtZW50LmlubmVySFRNTCA9IHZhbHVlOwogICAgfSwKCiAgICBlbXB0eToganFMaXRlRW1wdHkKICB9LCBmdW5jdGlvbihmbiwgbmFtZSl7CiAgICAvKioKICAgICAqIFByb3BlcnRpZXM6IHdyaXRlcyByZXR1cm4gc2VsZWN0aW9uLCByZWFkcyByZXR1cm4gZmlyc3QgdmFsdWUKICAgICAqLwogICAgSlFMaXRlLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKGFyZzEsIGFyZzIpIHsKICAgICAgdmFyIGksIGtleTsKCiAgICAgIC8vIGpxTGl0ZUhhc0NsYXNzIGhhcyBvbmx5IHR3byBhcmd1bWVudHMsIGJ1dCBpcyBhIGdldHRlci1vbmx5IGZuLCBzbyB3ZSBuZWVkIHRvIHNwZWNpYWwtY2FzZSBpdAogICAgICAvLyBpbiBhIHdheSB0aGF0IHN1cnZpdmVzIG1pbmlmaWNhdGlvbi4KICAgICAgLy8ganFMaXRlRW1wdHkgdGFrZXMgbm8gYXJndW1lbnRzIGJ1dCBpcyBhIHNldHRlci4KICAgICAgaWYgKGZuICE9PSBqcUxpdGVFbXB0eSAmJgogICAgICAgICgoKGZuLmxlbmd0aCA9PSAyICYmIChmbiAhPT0ganFMaXRlSGFzQ2xhc3MgJiYgZm4gIT09IGpxTGl0ZUNvbnRyb2xsZXIpKSA/IGFyZzEgOiBhcmcyKSA9PT0gdW5kZWZpbmVkKSkgewogICAgICAgIGlmIChpc09iamVjdChhcmcxKSkgewoKICAgICAgICAgIC8vIHdlIGFyZSBhIHdyaXRlLCBidXQgdGhlIG9iamVjdCBwcm9wZXJ0aWVzIGFyZSB0aGUga2V5L3ZhbHVlcwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKGZuID09PSBqcUxpdGVEYXRhKSB7CiAgICAgICAgICAgICAgLy8gZGF0YSgpIHRha2VzIHRoZSB3aG9sZSBvYmplY3QgaW4galF1ZXJ5CiAgICAgICAgICAgICAgZm4odGhpc1tpXSwgYXJnMSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZm9yIChrZXkgaW4gYXJnMSkgewogICAgICAgICAgICAgICAgZm4odGhpc1tpXSwga2V5LCBhcmcxW2tleV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgLy8gcmV0dXJuIHNlbGYgZm9yIGNoYWluaW5nCiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gd2UgYXJlIGEgcmVhZCwgc28gcmVhZCB0aGUgZmlyc3QgY2hpbGQuCiAgICAgICAgICB2YXIgdmFsdWUgPSBmbi4kZHY7CiAgICAgICAgICAvLyBPbmx5IGlmIHdlIGhhdmUgJGR2IGRvIHdlIGl0ZXJhdGUgb3ZlciBhbGwsIG90aGVyd2lzZSBpdCBpcyBqdXN0IHRoZSBmaXJzdCBlbGVtZW50LgogICAgICAgICAgdmFyIGpqID0gKHZhbHVlID09PSB1bmRlZmluZWQpID8gTWF0aC5taW4odGhpcy5sZW5ndGgsIDEpIDogdGhpcy5sZW5ndGg7CiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGpqOyBqKyspIHsKICAgICAgICAgICAgdmFyIG5vZGVWYWx1ZSA9IGZuKHRoaXNbal0sIGFyZzEsIGFyZzIpOwogICAgICAgICAgICB2YWx1ZSA9IHZhbHVlID8gdmFsdWUgKyBub2RlVmFsdWUgOiBub2RlVmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIHdlIGFyZSBhIHdyaXRlLCBzbyBhcHBseSB0byBhbGwgY2hpbGRyZW4KICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgZm4odGhpc1tpXSwgYXJnMSwgYXJnMik7CiAgICAgICAgfQogICAgICAgIC8vIHJldHVybiBzZWxmIGZvciBjaGFpbmluZwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICB9OwogIH0pOwoKICBmdW5jdGlvbiBjcmVhdGVFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnRzKSB7CiAgICB2YXIgZXZlbnRIYW5kbGVyID0gZnVuY3Rpb24gKGV2ZW50LCB0eXBlKSB7CiAgICAgIGlmICghZXZlbnQucHJldmVudERlZmF1bHQpIHsKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsgLy9pZQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGlmICghZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOyAvL2llCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgaWYgKCFldmVudC50YXJnZXQpIHsKICAgICAgICBldmVudC50YXJnZXQgPSBldmVudC5zcmNFbGVtZW50IHx8IGRvY3VtZW50OwogICAgICB9CgogICAgICBpZiAoaXNVbmRlZmluZWQoZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkpIHsKICAgICAgICB2YXIgcHJldmVudCA9IGV2ZW50LnByZXZlbnREZWZhdWx0OwogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgIHByZXZlbnQuY2FsbChldmVudCk7CiAgICAgICAgfTsKICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gZmFsc2U7CiAgICAgIH0KCiAgICAgIGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBldmVudC5kZWZhdWx0UHJldmVudGVkIHx8IGV2ZW50LnJldHVyblZhbHVlID09PSBmYWxzZTsKICAgICAgfTsKCiAgICAgIC8vIENvcHkgZXZlbnQgaGFuZGxlcnMgaW4gY2FzZSBldmVudCBoYW5kbGVycyBhcnJheSBpcyBtb2RpZmllZCBkdXJpbmcgZXhlY3V0aW9uLgogICAgICB2YXIgZXZlbnRIYW5kbGVyc0NvcHkgPSBzaGFsbG93Q29weShldmVudHNbdHlwZSB8fCBldmVudC50eXBlXSB8fCBbXSk7CgogICAgICBmb3JFYWNoKGV2ZW50SGFuZGxlcnNDb3B5LCBmdW5jdGlvbihmbikgewogICAgICAgIGZuLmNhbGwoZWxlbWVudCwgZXZlbnQpOwogICAgICB9KTsKCiAgICAgIC8vIFJlbW92ZSBtb25rZXktcGF0Y2hlZCBtZXRob2RzIChJRSksCiAgICAgIC8vIGFzIHRoZXkgd291bGQgY2F1c2UgbWVtb3J5IGxlYWtzIGluIElFOC4KICAgICAgaWYgKG1zaWUgPD0gOCkgewogICAgICAgIC8vIElFNy84IGRvZXMgbm90IGFsbG93IHRvIGRlbGV0ZSBwcm9wZXJ0eSBvbiBuYXRpdmUgb2JqZWN0CiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQgPSBudWxsOwogICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbiA9IG51bGw7CiAgICAgICAgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBJdCBzaG91bGRuJ3QgYWZmZWN0IG5vcm1hbCBicm93c2VycyAobmF0aXZlIG1ldGhvZHMgYXJlIGRlZmluZWQgb24gcHJvdG90eXBlKS4KICAgICAgICBkZWxldGUgZXZlbnQucHJldmVudERlZmF1bHQ7CiAgICAgICAgZGVsZXRlIGV2ZW50LnN0b3BQcm9wYWdhdGlvbjsKICAgICAgICBkZWxldGUgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkOwogICAgICB9CiAgICB9OwogICAgZXZlbnRIYW5kbGVyLmVsZW0gPSBlbGVtZW50OwogICAgcmV0dXJuIGV2ZW50SGFuZGxlcjsKICB9CgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KLy8gRnVuY3Rpb25zIGl0ZXJhdGluZyB0cmF2ZXJzYWwuCi8vIFRoZXNlIGZ1bmN0aW9ucyBjaGFpbiByZXN1bHRzIGludG8gYSBzaW5nbGUKLy8gc2VsZWN0b3IuCi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogIGZvckVhY2goewogICAgcmVtb3ZlRGF0YToganFMaXRlUmVtb3ZlRGF0YSwKCiAgICBkZWFsb2M6IGpxTGl0ZURlYWxvYywKCiAgICBvbjogZnVuY3Rpb24gb25GbihlbGVtZW50LCB0eXBlLCBmbiwgdW5zdXBwb3J0ZWQpewogICAgICBpZiAoaXNEZWZpbmVkKHVuc3VwcG9ydGVkKSkgdGhyb3cganFMaXRlTWluRXJyKCdvbmFyZ3MnLCAnanFMaXRlI29uKCkgZG9lcyBub3Qgc3VwcG9ydCB0aGUgYHNlbGVjdG9yYCBvciBgZXZlbnREYXRhYCBwYXJhbWV0ZXJzJyk7CgogICAgICB2YXIgZXZlbnRzID0ganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSwKICAgICAgICBoYW5kbGUgPSBqcUxpdGVFeHBhbmRvU3RvcmUoZWxlbWVudCwgJ2hhbmRsZScpOwoKICAgICAgaWYgKCFldmVudHMpIGpxTGl0ZUV4cGFuZG9TdG9yZShlbGVtZW50LCAnZXZlbnRzJywgZXZlbnRzID0ge30pOwogICAgICBpZiAoIWhhbmRsZSkganFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdoYW5kbGUnLCBoYW5kbGUgPSBjcmVhdGVFdmVudEhhbmRsZXIoZWxlbWVudCwgZXZlbnRzKSk7CgogICAgICBmb3JFYWNoKHR5cGUuc3BsaXQoJyAnKSwgZnVuY3Rpb24odHlwZSl7CiAgICAgICAgdmFyIGV2ZW50Rm5zID0gZXZlbnRzW3R5cGVdOwoKICAgICAgICBpZiAoIWV2ZW50Rm5zKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSAnbW91c2VlbnRlcicgfHwgdHlwZSA9PSAnbW91c2VsZWF2ZScpIHsKICAgICAgICAgICAgdmFyIGNvbnRhaW5zID0gZG9jdW1lbnQuYm9keS5jb250YWlucyB8fCBkb2N1bWVudC5ib2R5LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8KICAgICAgICAgICAgICBmdW5jdGlvbiggYSwgYiApIHsKICAgICAgICAgICAgICAgIC8vIGpzaGludCBiaXR3aXNlOiBmYWxzZQogICAgICAgICAgICAgICAgdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKICAgICAgICAgICAgICAgICAgYnVwID0gYiAmJiBiLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICByZXR1cm4gYSA9PT0gYnVwIHx8ICEhKCBidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgKICAgICAgICAgICAgICAgICAgYWRvd24uY29udGFpbnMgPwogICAgICAgICAgICAgICAgICAgIGFkb3duLmNvbnRhaW5zKCBidXAgKSA6CiAgICAgICAgICAgICAgICAgICAgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBidXAgKSAmIDE2CiAgICAgICAgICAgICAgICAgICkpOwogICAgICAgICAgICAgIH0gOgogICAgICAgICAgICAgIGZ1bmN0aW9uKCBhLCBiICkgewogICAgICAgICAgICAgICAgaWYgKCBiICkgewogICAgICAgICAgICAgICAgICB3aGlsZSAoIChiID0gYi5wYXJlbnROb2RlKSApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIGIgPT09IGEgKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgZXZlbnRzW3R5cGVdID0gW107CgogICAgICAgICAgICAvLyBSZWZlciB0byBqUXVlcnkncyBpbXBsZW1lbnRhdGlvbiBvZiBtb3VzZWVudGVyICYgbW91c2VsZWF2ZQogICAgICAgICAgICAvLyBSZWFkIGFib3V0IG1vdXNlZW50ZXIgYW5kIG1vdXNlbGVhdmU6CiAgICAgICAgICAgIC8vIGh0dHA6Ly93d3cucXVpcmtzbW9kZS5vcmcvanMvZXZlbnRzX21vdXNlLmh0bWwjbGluazgKICAgICAgICAgICAgdmFyIGV2ZW50bWFwID0geyBtb3VzZWxlYXZlIDogIm1vdXNlb3V0IiwgbW91c2VlbnRlciA6ICJtb3VzZW92ZXIifTsKCiAgICAgICAgICAgIG9uRm4oZWxlbWVudCwgZXZlbnRtYXBbdHlwZV0sIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IHRoaXMsIHJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0OwogICAgICAgICAgICAgIC8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KICAgICAgICAgICAgICAvLyBOQjogTm8gcmVsYXRlZFRhcmdldCBpZiB0aGUgbW91c2UgbGVmdC9lbnRlcmVkIHRoZSBicm93c2VyIHdpbmRvdwogICAgICAgICAgICAgIGlmICggIXJlbGF0ZWQgfHwgKHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhY29udGFpbnModGFyZ2V0LCByZWxhdGVkKSkgKXsKICAgICAgICAgICAgICAgIGhhbmRsZShldmVudCwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhZGRFdmVudExpc3RlbmVyRm4oZWxlbWVudCwgdHlwZSwgaGFuZGxlKTsKICAgICAgICAgICAgZXZlbnRzW3R5cGVdID0gW107CiAgICAgICAgICB9CiAgICAgICAgICBldmVudEZucyA9IGV2ZW50c1t0eXBlXTsKICAgICAgICB9CiAgICAgICAgZXZlbnRGbnMucHVzaChmbik7CiAgICAgIH0pOwogICAgfSwKCiAgICBvZmY6IGpxTGl0ZU9mZiwKCiAgICBvbmU6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgIGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CgogICAgICAvL2FkZCB0aGUgbGlzdGVuZXIgdHdpY2Ugc28gdGhhdCB3aGVuIGl0IGlzIGNhbGxlZAogICAgICAvL3lvdSBjYW4gcmVtb3ZlIHRoZSBvcmlnaW5hbCBmdW5jdGlvbiBhbmQgc3RpbGwgYmUKICAgICAgLy9hYmxlIHRvIGNhbGwgZWxlbWVudC5vZmYoZXYsIGZuKSBub3JtYWxseQogICAgICBlbGVtZW50Lm9uKHR5cGUsIGZ1bmN0aW9uIG9uRm4oKSB7CiAgICAgICAgZWxlbWVudC5vZmYodHlwZSwgZm4pOwogICAgICAgIGVsZW1lbnQub2ZmKHR5cGUsIG9uRm4pOwogICAgICB9KTsKICAgICAgZWxlbWVudC5vbih0eXBlLCBmbik7CiAgICB9LAoKICAgIHJlcGxhY2VXaXRoOiBmdW5jdGlvbihlbGVtZW50LCByZXBsYWNlTm9kZSkgewogICAgICB2YXIgaW5kZXgsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAganFMaXRlRGVhbG9jKGVsZW1lbnQpOwogICAgICBmb3JFYWNoKG5ldyBKUUxpdGUocmVwbGFjZU5vZGUpLCBmdW5jdGlvbihub2RlKXsKICAgICAgICBpZiAoaW5kZXgpIHsKICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobm9kZSwgaW5kZXgubmV4dFNpYmxpbmcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKG5vZGUsIGVsZW1lbnQpOwogICAgICAgIH0KICAgICAgICBpbmRleCA9IG5vZGU7CiAgICAgIH0pOwogICAgfSwKCiAgICBjaGlsZHJlbjogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICB2YXIgY2hpbGRyZW4gPSBbXTsKICAgICAgZm9yRWFjaChlbGVtZW50LmNoaWxkTm9kZXMsIGZ1bmN0aW9uKGVsZW1lbnQpewogICAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKQogICAgICAgICAgY2hpbGRyZW4ucHVzaChlbGVtZW50KTsKICAgICAgfSk7CiAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgIH0sCgogICAgY29udGVudHM6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQuY29udGVudERvY3VtZW50IHx8IGVsZW1lbnQuY2hpbGROb2RlcyB8fCBbXTsKICAgIH0sCgogICAgYXBwZW5kOiBmdW5jdGlvbihlbGVtZW50LCBub2RlKSB7CiAgICAgIGZvckVhY2gobmV3IEpRTGl0ZShub2RlKSwgZnVuY3Rpb24oY2hpbGQpewogICAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxIHx8IGVsZW1lbnQubm9kZVR5cGUgPT09IDExKSB7CiAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICBwcmVwZW5kOiBmdW5jdGlvbihlbGVtZW50LCBub2RlKSB7CiAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgdmFyIGluZGV4ID0gZWxlbWVudC5maXJzdENoaWxkOwogICAgICAgIGZvckVhY2gobmV3IEpRTGl0ZShub2RlKSwgZnVuY3Rpb24oY2hpbGQpewogICAgICAgICAgZWxlbWVudC5pbnNlcnRCZWZvcmUoY2hpbGQsIGluZGV4KTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKCiAgICB3cmFwOiBmdW5jdGlvbihlbGVtZW50LCB3cmFwTm9kZSkgewogICAgICB3cmFwTm9kZSA9IGpxTGl0ZSh3cmFwTm9kZSlbMF07CiAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgIGlmIChwYXJlbnQpIHsKICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKHdyYXBOb2RlLCBlbGVtZW50KTsKICAgICAgfQogICAgICB3cmFwTm9kZS5hcHBlbmRDaGlsZChlbGVtZW50KTsKICAgIH0sCgogICAgcmVtb3ZlOiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgIGpxTGl0ZURlYWxvYyhlbGVtZW50KTsKICAgICAgdmFyIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgaWYgKHBhcmVudCkgcGFyZW50LnJlbW92ZUNoaWxkKGVsZW1lbnQpOwogICAgfSwKCiAgICBhZnRlcjogZnVuY3Rpb24oZWxlbWVudCwgbmV3RWxlbWVudCkgewogICAgICB2YXIgaW5kZXggPSBlbGVtZW50LCBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgIGZvckVhY2gobmV3IEpRTGl0ZShuZXdFbGVtZW50KSwgZnVuY3Rpb24obm9kZSl7CiAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCBpbmRleC5uZXh0U2libGluZyk7CiAgICAgICAgaW5kZXggPSBub2RlOwogICAgICB9KTsKICAgIH0sCgogICAgYWRkQ2xhc3M6IGpxTGl0ZUFkZENsYXNzLAogICAgcmVtb3ZlQ2xhc3M6IGpxTGl0ZVJlbW92ZUNsYXNzLAoKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbihlbGVtZW50LCBzZWxlY3RvciwgY29uZGl0aW9uKSB7CiAgICAgIGlmIChzZWxlY3RvcikgewogICAgICAgIGZvckVhY2goc2VsZWN0b3Iuc3BsaXQoJyAnKSwgZnVuY3Rpb24oY2xhc3NOYW1lKXsKICAgICAgICAgIHZhciBjbGFzc0NvbmRpdGlvbiA9IGNvbmRpdGlvbjsKICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChjbGFzc0NvbmRpdGlvbikpIHsKICAgICAgICAgICAgY2xhc3NDb25kaXRpb24gPSAhanFMaXRlSGFzQ2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIChjbGFzc0NvbmRpdGlvbiA/IGpxTGl0ZUFkZENsYXNzIDoganFMaXRlUmVtb3ZlQ2xhc3MpKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgcGFyZW50OiBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgIHJldHVybiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlICE9PSAxMSA/IHBhcmVudCA6IG51bGw7CiAgICB9LAoKICAgIG5leHQ6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgaWYgKGVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nKSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nOwogICAgICB9CgogICAgICAvLyBJRTggZG9lc24ndCBoYXZlIG5leHRFbGVtZW50U2libGluZwogICAgICB2YXIgZWxtID0gZWxlbWVudC5uZXh0U2libGluZzsKICAgICAgd2hpbGUgKGVsbSAhPSBudWxsICYmIGVsbS5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgIGVsbSA9IGVsbS5uZXh0U2libGluZzsKICAgICAgfQogICAgICByZXR1cm4gZWxtOwogICAgfSwKCiAgICBmaW5kOiBmdW5jdGlvbihlbGVtZW50LCBzZWxlY3RvcikgewogICAgICBpZiAoZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSkgewogICAgICAgIHJldHVybiBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgIH0sCgogICAgY2xvbmU6IGpxTGl0ZUNsb25lLAoKICAgIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbihlbGVtZW50LCBldmVudE5hbWUsIGV2ZW50RGF0YSkgewogICAgICB2YXIgZXZlbnRGbnMgPSAoanFMaXRlRXhwYW5kb1N0b3JlKGVsZW1lbnQsICdldmVudHMnKSB8fCB7fSlbZXZlbnROYW1lXTsKCiAgICAgIGV2ZW50RGF0YSA9IGV2ZW50RGF0YSB8fCBbXTsKCiAgICAgIHZhciBldmVudCA9IFt7CiAgICAgICAgcHJldmVudERlZmF1bHQ6IG5vb3AsCiAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiBub29wCiAgICAgIH1dOwoKICAgICAgZm9yRWFjaChldmVudEZucywgZnVuY3Rpb24oZm4pIHsKICAgICAgICBmbi5hcHBseShlbGVtZW50LCBldmVudC5jb25jYXQoZXZlbnREYXRhKSk7CiAgICAgIH0pOwogICAgfQogIH0sIGZ1bmN0aW9uKGZuLCBuYW1lKXsKICAgIC8qKgogICAgICogY2hhaW5pbmcgZnVuY3Rpb25zCiAgICAgKi8KICAgIEpRTGl0ZS5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbihhcmcxLCBhcmcyLCBhcmczKSB7CiAgICAgIHZhciB2YWx1ZTsKICAgICAgZm9yKHZhciBpPTA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgdmFsdWUgPSBmbih0aGlzW2ldLCBhcmcxLCBhcmcyLCBhcmczKTsKICAgICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgIC8vIGFueSBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGEgdmFsdWUgbmVlZHMgdG8gYmUgd3JhcHBlZAogICAgICAgICAgICB2YWx1ZSA9IGpxTGl0ZSh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGpxTGl0ZUFkZE5vZGVzKHZhbHVlLCBmbih0aGlzW2ldLCBhcmcxLCBhcmcyLCBhcmczKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBpc0RlZmluZWQodmFsdWUpID8gdmFsdWUgOiB0aGlzOwogICAgfTsKCiAgICAvLyBiaW5kIGxlZ2FjeSBiaW5kL3VuYmluZCB0byBvbi9vZmYKICAgIEpRTGl0ZS5wcm90b3R5cGUuYmluZCA9IEpRTGl0ZS5wcm90b3R5cGUub247CiAgICBKUUxpdGUucHJvdG90eXBlLnVuYmluZCA9IEpRTGl0ZS5wcm90b3R5cGUub2ZmOwogIH0pOwoKICAvKioKICAgKiBDb21wdXRlcyBhIGhhc2ggb2YgYW4gJ29iaicuCiAgICogSGFzaCBvZiBhOgogICAqICBzdHJpbmcgaXMgc3RyaW5nCiAgICogIG51bWJlciBpcyBudW1iZXIgYXMgc3RyaW5nCiAgICogIG9iamVjdCBpcyBlaXRoZXIgcmVzdWx0IG9mIGNhbGxpbmcgJCRoYXNoS2V5IGZ1bmN0aW9uIG9uIHRoZSBvYmplY3Qgb3IgdW5pcXVlbHkgZ2VuZXJhdGVkIGlkLAogICAqICAgICAgICAgdGhhdCBpcyBhbHNvIGFzc2lnbmVkIHRvIHRoZSAkJGhhc2hLZXkgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSBvYmoKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBoYXNoIHN0cmluZyBzdWNoIHRoYXQgdGhlIHNhbWUgaW5wdXQgd2lsbCBoYXZlIHRoZSBzYW1lIGhhc2ggc3RyaW5nLgogICAqICAgICAgICAgVGhlIHJlc3VsdGluZyBzdHJpbmcga2V5IGlzIGluICd0eXBlOmhhc2hLZXknIGZvcm1hdC4KICAgKi8KICBmdW5jdGlvbiBoYXNoS2V5KG9iaikgewogICAgdmFyIG9ialR5cGUgPSB0eXBlb2Ygb2JqLAogICAgICBrZXk7CgogICAgaWYgKG9ialR5cGUgPT0gJ29iamVjdCcgJiYgb2JqICE9PSBudWxsKSB7CiAgICAgIGlmICh0eXBlb2YgKGtleSA9IG9iai4kJGhhc2hLZXkpID09ICdmdW5jdGlvbicpIHsKICAgICAgICAvLyBtdXN0IGludm9rZSBvbiBvYmplY3QgdG8ga2VlcCB0aGUgcmlnaHQgdGhpcwogICAgICAgIGtleSA9IG9iai4kJGhhc2hLZXkoKTsKICAgICAgfSBlbHNlIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgIGtleSA9IG9iai4kJGhhc2hLZXkgPSBuZXh0VWlkKCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGtleSA9IG9iajsKICAgIH0KCiAgICByZXR1cm4gb2JqVHlwZSArICc6JyArIGtleTsKICB9CgogIC8qKgogICAqIEhhc2hNYXAgd2hpY2ggY2FuIHVzZSBvYmplY3RzIGFzIGtleXMKICAgKi8KICBmdW5jdGlvbiBIYXNoTWFwKGFycmF5KXsKICAgIGZvckVhY2goYXJyYXksIHRoaXMucHV0LCB0aGlzKTsKICB9CiAgSGFzaE1hcC5wcm90b3R5cGUgPSB7CiAgICAvKioKICAgICAqIFN0b3JlIGtleSB2YWx1ZSBwYWlyCiAgICAgKiBAcGFyYW0ga2V5IGtleSB0byBzdG9yZSBjYW4gYmUgYW55IHR5cGUKICAgICAqIEBwYXJhbSB2YWx1ZSB2YWx1ZSB0byBzdG9yZSBjYW4gYmUgYW55IHR5cGUKICAgICAqLwogICAgcHV0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIHRoaXNbaGFzaEtleShrZXkpXSA9IHZhbHVlOwogICAgfSwKCiAgICAvKioKICAgICAqIEBwYXJhbSBrZXkKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IHRoZSB2YWx1ZSBmb3IgdGhlIGtleQogICAgICovCiAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICByZXR1cm4gdGhpc1toYXNoS2V5KGtleSldOwogICAgfSwKCiAgICAvKioKICAgICAqIFJlbW92ZSB0aGUga2V5L3ZhbHVlIHBhaXIKICAgICAqIEBwYXJhbSBrZXkKICAgICAqLwogICAgcmVtb3ZlOiBmdW5jdGlvbihrZXkpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpc1trZXkgPSBoYXNoS2V5KGtleSldOwogICAgICBkZWxldGUgdGhpc1trZXldOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG1vZHVsZSBuZwogICAqIEBuYW1lIGFuZ3VsYXIuaW5qZWN0b3IKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ3JlYXRlcyBhbiBpbmplY3RvciBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIGZvciByZXRyaWV2aW5nIHNlcnZpY2VzIGFzIHdlbGwgYXMgZm9yCiAgICogZGVwZW5kZW5jeSBpbmplY3Rpb24gKHNlZSB7QGxpbmsgZ3VpZGUvZGkgZGVwZW5kZW5jeSBpbmplY3Rpb259KS4KICAgKgoKICAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmd8RnVuY3Rpb24+fSBtb2R1bGVzIEEgbGlzdCBvZiBtb2R1bGUgZnVuY3Rpb25zIG9yIHRoZWlyIGFsaWFzZXMuIFNlZQogICAqICAgICAgICB7QGxpbmsgYW5ndWxhci5tb2R1bGV9LiBUaGUgYG5nYCBtb2R1bGUgbXVzdCBiZSBleHBsaWNpdGx5IGFkZGVkLgogICAqIEByZXR1cm5zIHtmdW5jdGlvbigpfSBJbmplY3RvciBmdW5jdGlvbi4gU2VlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LgogICAqCiAgICogQGV4YW1wbGUKICAgKiBUeXBpY2FsIHVzYWdlCiAgICogYGBganMKICAgKiAgIC8vIGNyZWF0ZSBhbiBpbmplY3RvcgogICAqICAgdmFyICRpbmplY3RvciA9IGFuZ3VsYXIuaW5qZWN0b3IoWyduZyddKTsKICAgKgogICAqICAgLy8gdXNlIHRoZSBpbmplY3RvciB0byBraWNrIG9mZiB5b3VyIGFwcGxpY2F0aW9uCiAgICogICAvLyB1c2UgdGhlIHR5cGUgaW5mZXJlbmNlIHRvIGF1dG8gaW5qZWN0IGFyZ3VtZW50cywgb3IgdXNlIGltcGxpY2l0IGluamVjdGlvbgogICAqICAgJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkcm9vdFNjb3BlLCAkY29tcGlsZSwgJGRvY3VtZW50KXsKICogICAgICRjb21waWxlKCRkb2N1bWVudCkoJHJvb3RTY29wZSk7CiAqICAgICAkcm9vdFNjb3BlLiRkaWdlc3QoKTsKICogICB9KTsKICAgKiBgYGAKICAgKgogICAqIFNvbWV0aW1lcyB5b3Ugd2FudCB0byBnZXQgYWNjZXNzIHRvIHRoZSBpbmplY3RvciBvZiBhIGN1cnJlbnRseSBydW5uaW5nIEFuZ3VsYXIgYXBwCiAgICogZnJvbSBvdXRzaWRlIEFuZ3VsYXIuIFBlcmhhcHMsIHlvdSB3YW50IHRvIGluamVjdCBhbmQgY29tcGlsZSBzb21lIG1hcmt1cCBhZnRlciB0aGUKICAgKiBhcHBsaWNhdGlvbiBoYXMgYmVlbiBib290c3RyYXBwZWQuIFlvdSBjYW4gZG8gdGhpcyB1c2luZyB0aGUgZXh0cmEgYGluamVjdG9yKClgIGFkZGVkCiAgICogdG8gSlF1ZXJ5L2pxTGl0ZSBlbGVtZW50cy4gU2VlIHtAbGluayBhbmd1bGFyLmVsZW1lbnR9LgogICAqCiAgICogKlRoaXMgaXMgZmFpcmx5IHJhcmUgYnV0IGNvdWxkIGJlIHRoZSBjYXNlIGlmIGEgdGhpcmQgcGFydHkgbGlicmFyeSBpcyBpbmplY3RpbmcgdGhlCiAgICogbWFya3VwLioKICAgKgogICAqIEluIHRoZSBmb2xsb3dpbmcgZXhhbXBsZSBhIG5ldyBibG9jayBvZiBIVE1MIGNvbnRhaW5pbmcgYSBgbmctY29udHJvbGxlcmAKICAgKiBkaXJlY3RpdmUgaXMgYWRkZWQgdG8gdGhlIGVuZCBvZiB0aGUgZG9jdW1lbnQgYm9keSBieSBKUXVlcnkuIFdlIHRoZW4gY29tcGlsZSBhbmQgbGluawogICAqIGl0IGludG8gdGhlIGN1cnJlbnQgQW5ndWxhckpTIHNjb3BlLgogICAqCiAgICogYGBganMKICAgKiB2YXIgJGRpdiA9ICQoJzxkaXYgbmctY29udHJvbGxlcj0iTXlDdHJsIj57e2NvbnRlbnQubGFiZWx9fTwvZGl2PicpOwogICAqICQoZG9jdW1lbnQuYm9keSkuYXBwZW5kKCRkaXYpOwogICAqCiAgICogYW5ndWxhci5lbGVtZW50KGRvY3VtZW50KS5pbmplY3RvcigpLmludm9rZShmdW5jdGlvbigkY29tcGlsZSkgewogKiAgIHZhciBzY29wZSA9IGFuZ3VsYXIuZWxlbWVudCgkZGl2KS5zY29wZSgpOwogKiAgICRjb21waWxlKCRkaXYpKHNjb3BlKTsKICogfSk7CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgbW9kdWxlCiAgICogQG5hbWUgYXV0bwogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogSW1wbGljaXQgbW9kdWxlIHdoaWNoIGdldHMgYXV0b21hdGljYWxseSBhZGRlZCB0byBlYWNoIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LgogICAqLwoKICB2YXIgRk5fQVJHUyA9IC9eZnVuY3Rpb25ccypbXlwoXSpcKFxzKihbXlwpXSopXCkvbTsKICB2YXIgRk5fQVJHX1NQTElUID0gLywvOwogIHZhciBGTl9BUkcgPSAvXlxzKihfPykoXFMrPylcMVxzKiQvOwogIHZhciBTVFJJUF9DT01NRU5UUyA9IC8oKFwvXC8uKiQpfChcL1wqW1xzXFNdKj9cKlwvKSkvbWc7CiAgdmFyICRpbmplY3Rvck1pbkVyciA9IG1pbkVycignJGluamVjdG9yJyk7CiAgZnVuY3Rpb24gYW5ub3RhdGUoZm4pIHsKICAgIHZhciAkaW5qZWN0LAogICAgICBmblRleHQsCiAgICAgIGFyZ0RlY2wsCiAgICAgIGxhc3Q7CgogICAgaWYgKHR5cGVvZiBmbiA9PSAnZnVuY3Rpb24nKSB7CiAgICAgIGlmICghKCRpbmplY3QgPSBmbi4kaW5qZWN0KSkgewogICAgICAgICRpbmplY3QgPSBbXTsKICAgICAgICBpZiAoZm4ubGVuZ3RoKSB7CiAgICAgICAgICBmblRleHQgPSBmbi50b1N0cmluZygpLnJlcGxhY2UoU1RSSVBfQ09NTUVOVFMsICcnKTsKICAgICAgICAgIGFyZ0RlY2wgPSBmblRleHQubWF0Y2goRk5fQVJHUyk7CiAgICAgICAgICBmb3JFYWNoKGFyZ0RlY2xbMV0uc3BsaXQoRk5fQVJHX1NQTElUKSwgZnVuY3Rpb24oYXJnKXsKICAgICAgICAgICAgYXJnLnJlcGxhY2UoRk5fQVJHLCBmdW5jdGlvbihhbGwsIHVuZGVyc2NvcmUsIG5hbWUpewogICAgICAgICAgICAgICRpbmplY3QucHVzaChuYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZm4uJGluamVjdCA9ICRpbmplY3Q7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNBcnJheShmbikpIHsKICAgICAgbGFzdCA9IGZuLmxlbmd0aCAtIDE7CiAgICAgIGFzc2VydEFyZ0ZuKGZuW2xhc3RdLCAnZm4nKTsKICAgICAgJGluamVjdCA9IGZuLnNsaWNlKDAsIGxhc3QpOwogICAgfSBlbHNlIHsKICAgICAgYXNzZXJ0QXJnRm4oZm4sICdmbicsIHRydWUpOwogICAgfQogICAgcmV0dXJuICRpbmplY3Q7CiAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGluamVjdG9yCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogYCRpbmplY3RvcmAgaXMgdXNlZCB0byByZXRyaWV2ZSBvYmplY3QgaW5zdGFuY2VzIGFzIGRlZmluZWQgYnkKICAgKiB7QGxpbmsgYXV0by4kcHJvdmlkZSBwcm92aWRlcn0sIGluc3RhbnRpYXRlIHR5cGVzLCBpbnZva2UgbWV0aG9kcywKICAgKiBhbmQgbG9hZCBtb2R1bGVzLgogICAqCiAgICogVGhlIGZvbGxvd2luZyBhbHdheXMgaG9sZHMgdHJ1ZToKICAgKgogICAqIGBgYGpzCiAgICogICB2YXIgJGluamVjdG9yID0gYW5ndWxhci5pbmplY3RvcigpOwogICAqICAgZXhwZWN0KCRpbmplY3Rvci5nZXQoJyRpbmplY3RvcicpKS50b0JlKCRpbmplY3Rvcik7CiAgICogICBleHBlY3QoJGluamVjdG9yLmludm9rZShmdW5jdGlvbigkaW5qZWN0b3IpewogKiAgICAgcmV0dXJuICRpbmplY3RvcjsKICogICB9KS50b0JlKCRpbmplY3Rvcik7CiAgICogYGBgCiAgICoKICAgKiAjIEluamVjdGlvbiBGdW5jdGlvbiBBbm5vdGF0aW9uCiAgICoKICAgKiBKYXZhU2NyaXB0IGRvZXMgbm90IGhhdmUgYW5ub3RhdGlvbnMsIGFuZCBhbm5vdGF0aW9ucyBhcmUgbmVlZGVkIGZvciBkZXBlbmRlbmN5IGluamVjdGlvbi4gVGhlCiAgICogZm9sbG93aW5nIGFyZSBhbGwgdmFsaWQgd2F5cyBvZiBhbm5vdGF0aW5nIGZ1bmN0aW9uIHdpdGggaW5qZWN0aW9uIGFyZ3VtZW50cyBhbmQgYXJlIGVxdWl2YWxlbnQuCiAgICoKICAgKiBgYGBqcwogICAqICAgLy8gaW5mZXJyZWQgKG9ubHkgd29ya3MgaWYgY29kZSBub3QgbWluaWZpZWQvb2JmdXNjYXRlZCkKICAgKiAgICRpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oc2VydmljZUEpe30pOwogICAqCiAgICogICAvLyBhbm5vdGF0ZWQKICAgKiAgIGZ1bmN0aW9uIGV4cGxpY2l0KHNlcnZpY2VBKSB7fTsKICAgKiAgIGV4cGxpY2l0LiRpbmplY3QgPSBbJ3NlcnZpY2VBJ107CiAgICogICAkaW5qZWN0b3IuaW52b2tlKGV4cGxpY2l0KTsKICAgKgogICAqICAgLy8gaW5saW5lCiAgICogICAkaW5qZWN0b3IuaW52b2tlKFsnc2VydmljZUEnLCBmdW5jdGlvbihzZXJ2aWNlQSl7fV0pOwogICAqIGBgYAogICAqCiAgICogIyMgSW5mZXJlbmNlCiAgICoKICAgKiBJbiBKYXZhU2NyaXB0IGNhbGxpbmcgYHRvU3RyaW5nKClgIG9uIGEgZnVuY3Rpb24gcmV0dXJucyB0aGUgZnVuY3Rpb24gZGVmaW5pdGlvbi4gVGhlIGRlZmluaXRpb24KICAgKiBjYW4gdGhlbiBiZSBwYXJzZWQgYW5kIHRoZSBmdW5jdGlvbiBhcmd1bWVudHMgY2FuIGJlIGV4dHJhY3RlZC4gKk5PVEU6KiBUaGlzIGRvZXMgbm90IHdvcmsgd2l0aAogICAqIG1pbmlmaWNhdGlvbiwgYW5kIG9iZnVzY2F0aW9uIHRvb2xzIHNpbmNlIHRoZXNlIHRvb2xzIGNoYW5nZSB0aGUgYXJndW1lbnQgbmFtZXMuCiAgICoKICAgKiAjIyBgJGluamVjdGAgQW5ub3RhdGlvbgogICAqIEJ5IGFkZGluZyBhbiBgJGluamVjdGAgcHJvcGVydHkgb250byBhIGZ1bmN0aW9uIHRoZSBpbmplY3Rpb24gcGFyYW1ldGVycyBjYW4gYmUgc3BlY2lmaWVkLgogICAqCiAgICogIyMgSW5saW5lCiAgICogQXMgYW4gYXJyYXkgb2YgaW5qZWN0aW9uIG5hbWVzLCB3aGVyZSB0aGUgbGFzdCBpdGVtIGluIHRoZSBhcnJheSBpcyB0aGUgZnVuY3Rpb24gdG8gY2FsbC4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRpbmplY3RvciNnZXQKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJldHVybiBhbiBpbnN0YW5jZSBvZiB0aGUgc2VydmljZS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZSB0byByZXRyaWV2ZS4KICAgKiBAcmV0dXJuIHsqfSBUaGUgaW5zdGFuY2UuCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW5qZWN0b3IjaW52b2tlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBJbnZva2UgdGhlIG1ldGhvZCBhbmQgc3VwcGx5IHRoZSBtZXRob2QgYXJndW1lbnRzIGZyb20gdGhlIGAkaW5qZWN0b3JgLgogICAqCiAgICogQHBhcmFtIHshRnVuY3Rpb259IGZuIFRoZSBmdW5jdGlvbiB0byBpbnZva2UuIEZ1bmN0aW9uIHBhcmFtZXRlcnMgYXJlIGluamVjdGVkIGFjY29yZGluZyB0byB0aGUKICAgKiAgIHtAbGluayBndWlkZS9kaSAkaW5qZWN0IEFubm90YXRpb259IHJ1bGVzLgogICAqIEBwYXJhbSB7T2JqZWN0PX0gc2VsZiBUaGUgYHRoaXNgIGZvciB0aGUgaW52b2tlZCBtZXRob2QuCiAgICogQHBhcmFtIHtPYmplY3Q9fSBsb2NhbHMgT3B0aW9uYWwgb2JqZWN0LiBJZiBwcmVzZXQgdGhlbiBhbnkgYXJndW1lbnQgbmFtZXMgYXJlIHJlYWQgZnJvbSB0aGlzCiAgICogICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0IGZpcnN0LCBiZWZvcmUgdGhlIGAkaW5qZWN0b3JgIGlzIGNvbnN1bHRlZC4KICAgKiBAcmV0dXJucyB7Kn0gdGhlIHZhbHVlIHJldHVybmVkIGJ5IHRoZSBpbnZva2VkIGBmbmAgZnVuY3Rpb24uCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW5qZWN0b3IjaGFzCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBbGxvd3MgdGhlIHVzZXIgdG8gcXVlcnkgaWYgdGhlIHBhcnRpY3VsYXIgc2VydmljZSBleGlzdHMuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gTmFtZSBvZiB0aGUgc2VydmljZSB0byBxdWVyeS4KICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gcmV0dXJucyB0cnVlIGlmIGluamVjdG9yIGhhcyBnaXZlbiBzZXJ2aWNlLgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGluamVjdG9yI2luc3RhbnRpYXRlCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIEpTIHR5cGUuIFRoZSBtZXRob2QgdGFrZXMgYSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaW52b2tlcyB0aGUgbmV3CiAgICogb3BlcmF0b3IsIGFuZCBzdXBwbGllcyBhbGwgb2YgdGhlIGFyZ3VtZW50cyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24gYXMgc3BlY2lmaWVkIGJ5IHRoZQogICAqIGNvbnN0cnVjdG9yIGFubm90YXRpb24uCiAgICoKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBUeXBlIEFubm90YXRlZCBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgKiBAcGFyYW0ge09iamVjdD19IGxvY2FscyBPcHRpb25hbCBvYmplY3QuIElmIHByZXNldCB0aGVuIGFueSBhcmd1bWVudCBuYW1lcyBhcmUgcmVhZCBmcm9tIHRoaXMKICAgKiBvYmplY3QgZmlyc3QsIGJlZm9yZSB0aGUgYCRpbmplY3RvcmAgaXMgY29uc3VsdGVkLgogICAqIEByZXR1cm5zIHtPYmplY3R9IG5ldyBpbnN0YW5jZSBvZiBgVHlwZWAuCiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkaW5qZWN0b3IjYW5ub3RhdGUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJldHVybnMgYW4gYXJyYXkgb2Ygc2VydmljZSBuYW1lcyB3aGljaCB0aGUgZnVuY3Rpb24gaXMgcmVxdWVzdGluZyBmb3IgaW5qZWN0aW9uLiBUaGlzIEFQSSBpcwogICAqIHVzZWQgYnkgdGhlIGluamVjdG9yIHRvIGRldGVybWluZSB3aGljaCBzZXJ2aWNlcyBuZWVkIHRvIGJlIGluamVjdGVkIGludG8gdGhlIGZ1bmN0aW9uIHdoZW4gdGhlCiAgICogZnVuY3Rpb24gaXMgaW52b2tlZC4gVGhlcmUgYXJlIHRocmVlIHdheXMgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIGNhbiBiZSBhbm5vdGF0ZWQgd2l0aCB0aGUgbmVlZGVkCiAgICogZGVwZW5kZW5jaWVzLgogICAqCiAgICogIyBBcmd1bWVudCBuYW1lcwogICAqCiAgICogVGhlIHNpbXBsZXN0IGZvcm0gaXMgdG8gZXh0cmFjdCB0aGUgZGVwZW5kZW5jaWVzIGZyb20gdGhlIGFyZ3VtZW50cyBvZiB0aGUgZnVuY3Rpb24uIFRoaXMgaXMgZG9uZQogICAqIGJ5IGNvbnZlcnRpbmcgdGhlIGZ1bmN0aW9uIGludG8gYSBzdHJpbmcgdXNpbmcgYHRvU3RyaW5nKClgIG1ldGhvZCBhbmQgZXh0cmFjdGluZyB0aGUgYXJndW1lbnQKICAgKiBuYW1lcy4KICAgKiBgYGBqcwogICAqICAgLy8gR2l2ZW4KICAgKiAgIGZ1bmN0aW9uIE15Q29udHJvbGxlcigkc2NvcGUsICRyb3V0ZSkgewogKiAgICAgLy8gLi4uCiAqICAgfQogICAqCiAgICogICAvLyBUaGVuCiAgICogICBleHBlY3QoaW5qZWN0b3IuYW5ub3RhdGUoTXlDb250cm9sbGVyKSkudG9FcXVhbChbJyRzY29wZScsICckcm91dGUnXSk7CiAgICogYGBgCiAgICoKICAgKiBUaGlzIG1ldGhvZCBkb2VzIG5vdCB3b3JrIHdpdGggY29kZSBtaW5pZmljYXRpb24gLyBvYmZ1c2NhdGlvbi4gRm9yIHRoaXMgcmVhc29uIHRoZSBmb2xsb3dpbmcKICAgKiBhbm5vdGF0aW9uIHN0cmF0ZWdpZXMgYXJlIHN1cHBvcnRlZC4KICAgKgogICAqICMgVGhlIGAkaW5qZWN0YCBwcm9wZXJ0eQogICAqCiAgICogSWYgYSBmdW5jdGlvbiBoYXMgYW4gYCRpbmplY3RgIHByb3BlcnR5IGFuZCBpdHMgdmFsdWUgaXMgYW4gYXJyYXkgb2Ygc3RyaW5ncywgdGhlbiB0aGUgc3RyaW5ncwogICAqIHJlcHJlc2VudCBuYW1lcyBvZiBzZXJ2aWNlcyB0byBiZSBpbmplY3RlZCBpbnRvIHRoZSBmdW5jdGlvbi4KICAgKiBgYGBqcwogICAqICAgLy8gR2l2ZW4KICAgKiAgIHZhciBNeUNvbnRyb2xsZXIgPSBmdW5jdGlvbihvYmZ1c2NhdGVkU2NvcGUsIG9iZnVzY2F0ZWRSb3V0ZSkgewogKiAgICAgLy8gLi4uCiAqICAgfQogICAqICAgLy8gRGVmaW5lIGZ1bmN0aW9uIGRlcGVuZGVuY2llcwogICAqICAgTXlDb250cm9sbGVyWyckaW5qZWN0J10gPSBbJyRzY29wZScsICckcm91dGUnXTsKICAgKgogICAqICAgLy8gVGhlbgogICAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKE15Q29udHJvbGxlcikpLnRvRXF1YWwoWyckc2NvcGUnLCAnJHJvdXRlJ10pOwogICAqIGBgYAogICAqCiAgICogIyBUaGUgYXJyYXkgbm90YXRpb24KICAgKgogICAqIEl0IGlzIG9mdGVuIGRlc2lyYWJsZSB0byBpbmxpbmUgSW5qZWN0ZWQgZnVuY3Rpb25zIGFuZCB0aGF0J3Mgd2hlbiBzZXR0aW5nIHRoZSBgJGluamVjdGAgcHJvcGVydHkKICAgKiBpcyB2ZXJ5IGluY29udmVuaWVudC4gSW4gdGhlc2Ugc2l0dWF0aW9ucyB1c2luZyB0aGUgYXJyYXkgbm90YXRpb24gdG8gc3BlY2lmeSB0aGUgZGVwZW5kZW5jaWVzIGluCiAgICogYSB3YXkgdGhhdCBzdXJ2aXZlcyBtaW5pZmljYXRpb24gaXMgYSBiZXR0ZXIgY2hvaWNlOgogICAqCiAgICogYGBganMKICAgKiAgIC8vIFdlIHdpc2ggdG8gd3JpdGUgdGhpcyAobm90IG1pbmlmaWNhdGlvbiAvIG9iZnVzY2F0aW9uIHNhZmUpCiAgICogICBpbmplY3Rvci5pbnZva2UoZnVuY3Rpb24oJGNvbXBpbGUsICRyb290U2NvcGUpIHsKICogICAgIC8vIC4uLgogKiAgIH0pOwogICAqCiAgICogICAvLyBXZSBhcmUgZm9yY2VkIHRvIHdyaXRlIGJyZWFrIGlubGluaW5nCiAgICogICB2YXIgdG1wRm4gPSBmdW5jdGlvbihvYmZ1c2NhdGVkQ29tcGlsZSwgb2JmdXNjYXRlZFJvb3RTY29wZSkgewogKiAgICAgLy8gLi4uCiAqICAgfTsKICAgKiAgIHRtcEZuLiRpbmplY3QgPSBbJyRjb21waWxlJywgJyRyb290U2NvcGUnXTsKICAgKiAgIGluamVjdG9yLmludm9rZSh0bXBGbik7CiAgICoKICAgKiAgIC8vIFRvIGJldHRlciBzdXBwb3J0IGlubGluZSBmdW5jdGlvbiB0aGUgaW5saW5lIGFubm90YXRpb24gaXMgc3VwcG9ydGVkCiAgICogICBpbmplY3Rvci5pbnZva2UoWyckY29tcGlsZScsICckcm9vdFNjb3BlJywgZnVuY3Rpb24ob2JmQ29tcGlsZSwgb2JmUm9vdFNjb3BlKSB7CiAqICAgICAvLyAuLi4KICogICB9XSk7CiAgICoKICAgKiAgIC8vIFRoZXJlZm9yZQogICAqICAgZXhwZWN0KGluamVjdG9yLmFubm90YXRlKAogICAqICAgICAgWyckY29tcGlsZScsICckcm9vdFNjb3BlJywgZnVuY3Rpb24ob2JmdXNfJGNvbXBpbGUsIG9iZnVzXyRyb290U2NvcGUpIHt9XSkKICAgKiAgICApLnRvRXF1YWwoWyckY29tcGlsZScsICckcm9vdFNjb3BlJ10pOwogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtGdW5jdGlvbnxBcnJheS48c3RyaW5nfEZ1bmN0aW9uPn0gZm4gRnVuY3Rpb24gZm9yIHdoaWNoIGRlcGVuZGVudCBzZXJ2aWNlIG5hbWVzIG5lZWQgdG8KICAgKiBiZSByZXRyaWV2ZWQgYXMgZGVzY3JpYmVkIGFib3ZlLgogICAqCiAgICogQHJldHVybnMge0FycmF5LjxzdHJpbmc+fSBUaGUgbmFtZXMgb2YgdGhlIHNlcnZpY2VzIHdoaWNoIHRoZSBmdW5jdGlvbiByZXF1aXJlcy4KICAgKi8KCgoKCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lICRwcm92aWRlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIFRoZSB7QGxpbmsgYXV0by4kcHJvdmlkZSAkcHJvdmlkZX0gc2VydmljZSBoYXMgYSBudW1iZXIgb2YgbWV0aG9kcyBmb3IgcmVnaXN0ZXJpbmcgY29tcG9uZW50cwogICAqIHdpdGggdGhlIHtAbGluayBhdXRvLiRpbmplY3RvciAkaW5qZWN0b3J9LiBNYW55IG9mIHRoZXNlIGZ1bmN0aW9ucyBhcmUgYWxzbyBleHBvc2VkIG9uCiAgICoge0BsaW5rIGFuZ3VsYXIuTW9kdWxlfS4KICAgKgogICAqIEFuIEFuZ3VsYXIgKipzZXJ2aWNlKiogaXMgYSBzaW5nbGV0b24gb2JqZWN0IGNyZWF0ZWQgYnkgYSAqKnNlcnZpY2UgZmFjdG9yeSoqLiAgVGhlc2UgKipzZXJ2aWNlCiAgICogZmFjdG9yaWVzKiogYXJlIGZ1bmN0aW9ucyB3aGljaCwgaW4gdHVybiwgYXJlIGNyZWF0ZWQgYnkgYSAqKnNlcnZpY2UgcHJvdmlkZXIqKi4KICAgKiBUaGUgKipzZXJ2aWNlIHByb3ZpZGVycyoqIGFyZSBjb25zdHJ1Y3RvciBmdW5jdGlvbnMuIFdoZW4gaW5zdGFudGlhdGVkIHRoZXkgbXVzdCBjb250YWluIGEKICAgKiBwcm9wZXJ0eSBjYWxsZWQgYCRnZXRgLCB3aGljaCBob2xkcyB0aGUgKipzZXJ2aWNlIGZhY3RvcnkqKiBmdW5jdGlvbi4KICAgKgogICAqIFdoZW4geW91IHJlcXVlc3QgYSBzZXJ2aWNlLCB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0gaXMgcmVzcG9uc2libGUgZm9yIGZpbmRpbmcgdGhlCiAgICogY29ycmVjdCAqKnNlcnZpY2UgcHJvdmlkZXIqKiwgaW5zdGFudGlhdGluZyBpdCBhbmQgdGhlbiBjYWxsaW5nIGl0cyBgJGdldGAgKipzZXJ2aWNlIGZhY3RvcnkqKgogICAqIGZ1bmN0aW9uIHRvIGdldCB0aGUgaW5zdGFuY2Ugb2YgdGhlICoqc2VydmljZSoqLgogICAqCiAgICogT2Z0ZW4gc2VydmljZXMgaGF2ZSBubyBjb25maWd1cmF0aW9uIG9wdGlvbnMgYW5kIHRoZXJlIGlzIG5vIG5lZWQgdG8gYWRkIG1ldGhvZHMgdG8gdGhlIHNlcnZpY2UKICAgKiBwcm92aWRlci4gIFRoZSBwcm92aWRlciB3aWxsIGJlIG5vIG1vcmUgdGhhbiBhIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIHdpdGggYSBgJGdldGAgcHJvcGVydHkuIEZvcgogICAqIHRoZXNlIGNhc2VzIHRoZSB7QGxpbmsgYXV0by4kcHJvdmlkZSAkcHJvdmlkZX0gc2VydmljZSBoYXMgYWRkaXRpb25hbCBoZWxwZXIgbWV0aG9kcyB0byByZWdpc3RlcgogICAqIHNlcnZpY2VzIHdpdGhvdXQgc3BlY2lmeWluZyBhIHByb3ZpZGVyLgogICAqCiAgICogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNwcm92aWRlciBwcm92aWRlcihwcm92aWRlcil9IC0gcmVnaXN0ZXJzIGEgKipzZXJ2aWNlIHByb3ZpZGVyKiogd2l0aCB0aGUKICAgKiAgICAge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0KICAgKiAqIHtAbGluayBhdXRvLiRwcm92aWRlI2NvbnN0YW50IGNvbnN0YW50KG9iail9IC0gcmVnaXN0ZXJzIGEgdmFsdWUvb2JqZWN0IHRoYXQgY2FuIGJlIGFjY2Vzc2VkIGJ5CiAgICogICAgIHByb3ZpZGVycyBhbmQgc2VydmljZXMuCiAgICogKiB7QGxpbmsgYXV0by4kcHJvdmlkZSN2YWx1ZSB2YWx1ZShvYmopfSAtIHJlZ2lzdGVycyBhIHZhbHVlL29iamVjdCB0aGF0IGNhbiBvbmx5IGJlIGFjY2Vzc2VkIGJ5CiAgICogICAgIHNlcnZpY2VzLCBub3QgcHJvdmlkZXJzLgogICAqICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjZmFjdG9yeSBmYWN0b3J5KGZuKX0gLSByZWdpc3RlcnMgYSBzZXJ2aWNlICoqZmFjdG9yeSBmdW5jdGlvbioqLCBgZm5gLAogICAqICAgICB0aGF0IHdpbGwgYmUgd3JhcHBlZCBpbiBhICoqc2VydmljZSBwcm92aWRlcioqIG9iamVjdCwgd2hvc2UgYCRnZXRgIHByb3BlcnR5IHdpbGwgY29udGFpbiB0aGUKICAgKiAgICAgZ2l2ZW4gZmFjdG9yeSBmdW5jdGlvbi4KICAgKiAqIHtAbGluayBhdXRvLiRwcm92aWRlI3NlcnZpY2Ugc2VydmljZShjbGFzcyl9IC0gcmVnaXN0ZXJzIGEgKipjb25zdHJ1Y3RvciBmdW5jdGlvbioqLCBgY2xhc3NgCiAgICogICAgIHRoYXQgd2lsbCBiZSB3cmFwcGVkIGluIGEgKipzZXJ2aWNlIHByb3ZpZGVyKiogb2JqZWN0LCB3aG9zZSBgJGdldGAgcHJvcGVydHkgd2lsbCBpbnN0YW50aWF0ZQogICAqICAgICAgYSBuZXcgb2JqZWN0IHVzaW5nIHRoZSBnaXZlbiBjb25zdHJ1Y3RvciBmdW5jdGlvbi4KICAgKgogICAqIFNlZSB0aGUgaW5kaXZpZHVhbCBtZXRob2RzIGZvciBtb3JlIGluZm9ybWF0aW9uIGFuZCBleGFtcGxlcy4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRwcm92aWRlI3Byb3ZpZGVyCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBSZWdpc3RlciBhICoqcHJvdmlkZXIgZnVuY3Rpb24qKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4gUHJvdmlkZXIgZnVuY3Rpb25zCiAgICogYXJlIGNvbnN0cnVjdG9yIGZ1bmN0aW9ucywgd2hvc2UgaW5zdGFuY2VzIGFyZSByZXNwb25zaWJsZSBmb3IgInByb3ZpZGluZyIgYSBmYWN0b3J5IGZvciBhCiAgICogc2VydmljZS4KICAgKgogICAqIFNlcnZpY2UgcHJvdmlkZXIgbmFtZXMgc3RhcnQgd2l0aCB0aGUgbmFtZSBvZiB0aGUgc2VydmljZSB0aGV5IHByb3ZpZGUgZm9sbG93ZWQgYnkgYFByb3ZpZGVyYC4KICAgKiBGb3IgZXhhbXBsZSwgdGhlIHtAbGluayBuZy4kbG9nICRsb2d9IHNlcnZpY2UgaGFzIGEgcHJvdmlkZXIgY2FsbGVkCiAgICoge0BsaW5rIG5nLiRsb2dQcm92aWRlciAkbG9nUHJvdmlkZXJ9LgogICAqCiAgICogU2VydmljZSBwcm92aWRlciBvYmplY3RzIGNhbiBoYXZlIGFkZGl0aW9uYWwgbWV0aG9kcyB3aGljaCBhbGxvdyBjb25maWd1cmF0aW9uIG9mIHRoZSBwcm92aWRlcgogICAqIGFuZCBpdHMgc2VydmljZS4gSW1wb3J0YW50bHksIHlvdSBjYW4gY29uZmlndXJlIHdoYXQga2luZCBvZiBzZXJ2aWNlIGlzIGNyZWF0ZWQgYnkgdGhlIGAkZ2V0YAogICAqIG1ldGhvZCwgb3IgaG93IHRoYXQgc2VydmljZSB3aWxsIGFjdC4gRm9yIGV4YW1wbGUsIHRoZSB7QGxpbmsgbmcuJGxvZ1Byb3ZpZGVyICRsb2dQcm92aWRlcn0gaGFzIGEKICAgKiBtZXRob2Qge0BsaW5rIG5nLiRsb2dQcm92aWRlciNkZWJ1Z0VuYWJsZWQgZGVidWdFbmFibGVkfQogICAqIHdoaWNoIGxldHMgeW91IHNwZWNpZnkgd2hldGhlciB0aGUge0BsaW5rIG5nLiRsb2cgJGxvZ30gc2VydmljZSB3aWxsIGxvZyBkZWJ1ZyBtZXNzYWdlcyB0byB0aGUKICAgKiBjb25zb2xlIG9yIG5vdC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4gTk9URTogdGhlIHByb3ZpZGVyIHdpbGwgYmUgYXZhaWxhYmxlIHVuZGVyIGBuYW1lICsKICAgJ1Byb3ZpZGVyJ2Aga2V5LgogICAqIEBwYXJhbSB7KE9iamVjdHxmdW5jdGlvbigpKX0gcHJvdmlkZXIgSWYgdGhlIHByb3ZpZGVyIGlzOgogICAqCiAgICogICAtIGBPYmplY3RgOiB0aGVuIGl0IHNob3VsZCBoYXZlIGEgYCRnZXRgIG1ldGhvZC4gVGhlIGAkZ2V0YCBtZXRob2Qgd2lsbCBiZSBpbnZva2VkIHVzaW5nCiAgICogICAgIHtAbGluayBhdXRvLiRpbmplY3RvciNpbnZva2UgJGluamVjdG9yLmludm9rZSgpfSB3aGVuIGFuIGluc3RhbmNlIG5lZWRzIHRvIGJlIGNyZWF0ZWQuCiAgICogICAtIGBDb25zdHJ1Y3RvcmA6IGEgbmV3IGluc3RhbmNlIG9mIHRoZSBwcm92aWRlciB3aWxsIGJlIGNyZWF0ZWQgdXNpbmcKICAgKiAgICAge0BsaW5rIGF1dG8uJGluamVjdG9yI2luc3RhbnRpYXRlICRpbmplY3Rvci5pbnN0YW50aWF0ZSgpfSwgdGhlbiB0cmVhdGVkIGFzIGBvYmplY3RgLgogICAqCiAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQoKICAgKiBAZXhhbXBsZQogICAqCiAgICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNob3dzIGhvdyB0byBjcmVhdGUgYSBzaW1wbGUgZXZlbnQgdHJhY2tpbmcgc2VydmljZSBhbmQgcmVnaXN0ZXIgaXQgdXNpbmcKICAgKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNwcm92aWRlciAkcHJvdmlkZS5wcm92aWRlcigpfS4KICAgKgogICAqIGBgYGpzCiAgICogIC8vIERlZmluZSB0aGUgZXZlbnRUcmFja2VyIHByb3ZpZGVyCiAgICogIGZ1bmN0aW9uIEV2ZW50VHJhY2tlclByb3ZpZGVyKCkgewogKiAgICB2YXIgdHJhY2tpbmdVcmwgPSAnL3RyYWNrJzsKICoKICogICAgLy8gQSBwcm92aWRlciBtZXRob2QgZm9yIGNvbmZpZ3VyaW5nIHdoZXJlIHRoZSB0cmFja2VkIGV2ZW50cyBzaG91bGQgYmVlbiBzYXZlZAogKiAgICB0aGlzLnNldFRyYWNraW5nVXJsID0gZnVuY3Rpb24odXJsKSB7CiAqICAgICAgdHJhY2tpbmdVcmwgPSB1cmw7CiAqICAgIH07CiAqCiAqICAgIC8vIFRoZSBzZXJ2aWNlIGZhY3RvcnkgZnVuY3Rpb24KICogICAgdGhpcy4kZ2V0ID0gWyckaHR0cCcsIGZ1bmN0aW9uKCRodHRwKSB7CiAqICAgICAgdmFyIHRyYWNrZWRFdmVudHMgPSB7fTsKICogICAgICByZXR1cm4gewogKiAgICAgICAgLy8gQ2FsbCB0aGlzIHRvIHRyYWNrIGFuIGV2ZW50CiAqICAgICAgICBldmVudDogZnVuY3Rpb24oZXZlbnQpIHsKICogICAgICAgICAgdmFyIGNvdW50ID0gdHJhY2tlZEV2ZW50c1tldmVudF0gfHwgMDsKICogICAgICAgICAgY291bnQgKz0gMTsKICogICAgICAgICAgdHJhY2tlZEV2ZW50c1tldmVudF0gPSBjb3VudDsKICogICAgICAgICAgcmV0dXJuIGNvdW50OwogKiAgICAgICAgfSwKICogICAgICAgIC8vIENhbGwgdGhpcyB0byBzYXZlIHRoZSB0cmFja2VkIGV2ZW50cyB0byB0aGUgdHJhY2tpbmdVcmwKICogICAgICAgIHNhdmU6IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAkaHR0cC5wb3N0KHRyYWNraW5nVXJsLCB0cmFja2VkRXZlbnRzKTsKICogICAgICAgIH0KICogICAgICB9OwogKiAgICB9XTsKICogIH0KICAgKgogICAqICBkZXNjcmliZSgnZXZlbnRUcmFja2VyJywgZnVuY3Rpb24oKSB7CiAqICAgIHZhciBwb3N0U3B5OwogKgogKiAgICBiZWZvcmVFYWNoKG1vZHVsZShmdW5jdGlvbigkcHJvdmlkZSkgewogKiAgICAgIC8vIFJlZ2lzdGVyIHRoZSBldmVudFRyYWNrZXIgcHJvdmlkZXIKICogICAgICAkcHJvdmlkZS5wcm92aWRlcignZXZlbnRUcmFja2VyJywgRXZlbnRUcmFja2VyUHJvdmlkZXIpOwogKiAgICB9KSk7CiAqCiAqICAgIGJlZm9yZUVhY2gobW9kdWxlKGZ1bmN0aW9uKGV2ZW50VHJhY2tlclByb3ZpZGVyKSB7CiAqICAgICAgLy8gQ29uZmlndXJlIGV2ZW50VHJhY2tlciBwcm92aWRlcgogKiAgICAgIGV2ZW50VHJhY2tlclByb3ZpZGVyLnNldFRyYWNraW5nVXJsKCcvY3VzdG9tLXRyYWNrJyk7CiAqICAgIH0pKTsKICoKICogICAgaXQoJ3RyYWNrcyBldmVudHMnLCBpbmplY3QoZnVuY3Rpb24oZXZlbnRUcmFja2VyKSB7CiAqICAgICAgZXhwZWN0KGV2ZW50VHJhY2tlci5ldmVudCgnbG9naW4nKSkudG9FcXVhbCgxKTsKICogICAgICBleHBlY3QoZXZlbnRUcmFja2VyLmV2ZW50KCdsb2dpbicpKS50b0VxdWFsKDIpOwogKiAgICB9KSk7CiAqCiAqICAgIGl0KCdzYXZlcyB0byB0aGUgdHJhY2tpbmcgdXJsJywgaW5qZWN0KGZ1bmN0aW9uKGV2ZW50VHJhY2tlciwgJGh0dHApIHsKICogICAgICBwb3N0U3B5ID0gc3B5T24oJGh0dHAsICdwb3N0Jyk7CiAqICAgICAgZXZlbnRUcmFja2VyLmV2ZW50KCdsb2dpbicpOwogKiAgICAgIGV2ZW50VHJhY2tlci5zYXZlKCk7CiAqICAgICAgZXhwZWN0KHBvc3RTcHkpLnRvSGF2ZUJlZW5DYWxsZWQoKTsKICogICAgICBleHBlY3QocG9zdFNweS5tb3N0UmVjZW50Q2FsbC5hcmdzWzBdKS5ub3QudG9FcXVhbCgnL3RyYWNrJyk7CiAqICAgICAgZXhwZWN0KHBvc3RTcHkubW9zdFJlY2VudENhbGwuYXJnc1swXSkudG9FcXVhbCgnL2N1c3RvbS10cmFjaycpOwogKiAgICAgIGV4cGVjdChwb3N0U3B5Lm1vc3RSZWNlbnRDYWxsLmFyZ3NbMV0pLnRvRXF1YWwoeyAnbG9naW4nOiAxIH0pOwogKiAgICB9KSk7CiAqICB9KTsKICAgKiBgYGAKICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRwcm92aWRlI2ZhY3RvcnkKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIFJlZ2lzdGVyIGEgKipzZXJ2aWNlIGZhY3RvcnkqKiwgd2hpY2ggd2lsbCBiZSBjYWxsZWQgdG8gcmV0dXJuIHRoZSBzZXJ2aWNlIGluc3RhbmNlLgogICAqIFRoaXMgaXMgc2hvcnQgZm9yIHJlZ2lzdGVyaW5nIGEgc2VydmljZSB3aGVyZSBpdHMgcHJvdmlkZXIgY29uc2lzdHMgb2Ygb25seSBhIGAkZ2V0YCBwcm9wZXJ0eSwKICAgKiB3aGljaCBpcyB0aGUgZ2l2ZW4gc2VydmljZSBmYWN0b3J5IGZ1bmN0aW9uLgogICAqIFlvdSBzaG91bGQgdXNlIHtAbGluayBhdXRvLiRwcm92aWRlI2ZhY3RvcnkgJHByb3ZpZGUuZmFjdG9yeShnZXRGbil9IGlmIHlvdSBkbyBub3QgbmVlZCB0bwogICAqIGNvbmZpZ3VyZSB5b3VyIHNlcnZpY2UgaW4gYSBwcm92aWRlci4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9ICRnZXRGbiBUaGUgJGdldEZuIGZvciB0aGUgaW5zdGFuY2UgY3JlYXRpb24uIEludGVybmFsbHkgdGhpcyBpcyBhIHNob3J0IGhhbmQKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgYCRwcm92aWRlLnByb3ZpZGVyKG5hbWUsIHskZ2V0OiAkZ2V0Rm59KWAuCiAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAqCiAgICogQGV4YW1wbGUKICAgKiBIZXJlIGlzIGFuIGV4YW1wbGUgb2YgcmVnaXN0ZXJpbmcgYSBzZXJ2aWNlCiAgICogYGBganMKICAgKiAgICRwcm92aWRlLmZhY3RvcnkoJ3BpbmcnLCBbJyRodHRwJywgZnVuY3Rpb24oJGh0dHApIHsKICogICAgIHJldHVybiBmdW5jdGlvbiBwaW5nKCkgewogKiAgICAgICByZXR1cm4gJGh0dHAuc2VuZCgnL3BpbmcnKTsKICogICAgIH07CiAqICAgfV0pOwogICAqIGBgYAogICAqIFlvdSB3b3VsZCB0aGVuIGluamVjdCBhbmQgdXNlIHRoaXMgc2VydmljZSBsaWtlIHRoaXM6CiAgICogYGBganMKICAgKiAgIHNvbWVNb2R1bGUuY29udHJvbGxlcignQ3RybCcsIFsncGluZycsIGZ1bmN0aW9uKHBpbmcpIHsKICogICAgIHBpbmcoKTsKICogICB9XSk7CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHByb3ZpZGUjc2VydmljZQogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogUmVnaXN0ZXIgYSAqKnNlcnZpY2UgY29uc3RydWN0b3IqKiwgd2hpY2ggd2lsbCBiZSBpbnZva2VkIHdpdGggYG5ld2AgdG8gY3JlYXRlIHRoZSBzZXJ2aWNlCiAgICogaW5zdGFuY2UuCiAgICogVGhpcyBpcyBzaG9ydCBmb3IgcmVnaXN0ZXJpbmcgYSBzZXJ2aWNlIHdoZXJlIGl0cyBwcm92aWRlcidzIGAkZ2V0YCBwcm9wZXJ0eSBpcyB0aGUgc2VydmljZQogICAqIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGluc3RhbnRpYXRlIHRoZSBzZXJ2aWNlIGluc3RhbmNlLgogICAqCiAgICogWW91IHNob3VsZCB1c2Uge0BsaW5rIGF1dG8uJHByb3ZpZGUjc2VydmljZSAkcHJvdmlkZS5zZXJ2aWNlKGNsYXNzKX0gaWYgeW91IGRlZmluZSB5b3VyIHNlcnZpY2UKICAgKiBhcyBhIHR5cGUvY2xhc3MuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgaW5zdGFuY2UuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY29uc3RydWN0b3IgQSBjbGFzcyAoY29uc3RydWN0b3IgZnVuY3Rpb24pIHRoYXQgd2lsbCBiZSBpbnN0YW50aWF0ZWQuCiAgICogQHJldHVybnMge09iamVjdH0gcmVnaXN0ZXJlZCBwcm92aWRlciBpbnN0YW5jZQogICAqCiAgICogQGV4YW1wbGUKICAgKiBIZXJlIGlzIGFuIGV4YW1wbGUgb2YgcmVnaXN0ZXJpbmcgYSBzZXJ2aWNlIHVzaW5nCiAgICoge0BsaW5rIGF1dG8uJHByb3ZpZGUjc2VydmljZSAkcHJvdmlkZS5zZXJ2aWNlKGNsYXNzKX0uCiAgICogYGBganMKICAgKiAgIHZhciBQaW5nID0gZnVuY3Rpb24oJGh0dHApIHsKICogICAgIHRoaXMuJGh0dHAgPSAkaHR0cDsKICogICB9OwogICAqCiAgICogICBQaW5nLiRpbmplY3QgPSBbJyRodHRwJ107CiAgICoKICAgKiAgIFBpbmcucHJvdG90eXBlLnNlbmQgPSBmdW5jdGlvbigpIHsKICogICAgIHJldHVybiB0aGlzLiRodHRwLmdldCgnL3BpbmcnKTsKICogICB9OwogICAqICAgJHByb3ZpZGUuc2VydmljZSgncGluZycsIFBpbmcpOwogICAqIGBgYAogICAqIFlvdSB3b3VsZCB0aGVuIGluamVjdCBhbmQgdXNlIHRoaXMgc2VydmljZSBsaWtlIHRoaXM6CiAgICogYGBganMKICAgKiAgIHNvbWVNb2R1bGUuY29udHJvbGxlcignQ3RybCcsIFsncGluZycsIGZ1bmN0aW9uKHBpbmcpIHsKICogICAgIHBpbmcuc2VuZCgpOwogKiAgIH1dKTsKICAgKiBgYGAKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkcHJvdmlkZSN2YWx1ZQogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogUmVnaXN0ZXIgYSAqKnZhbHVlIHNlcnZpY2UqKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfSwgc3VjaCBhcyBhIHN0cmluZywgYQogICAqIG51bWJlciwgYW4gYXJyYXksIGFuIG9iamVjdCBvciBhIGZ1bmN0aW9uLiAgVGhpcyBpcyBzaG9ydCBmb3IgcmVnaXN0ZXJpbmcgYSBzZXJ2aWNlIHdoZXJlIGl0cwogICAqIHByb3ZpZGVyJ3MgYCRnZXRgIHByb3BlcnR5IGlzIGEgZmFjdG9yeSBmdW5jdGlvbiB0aGF0IHRha2VzIG5vIGFyZ3VtZW50cyBhbmQgcmV0dXJucyB0aGUgKip2YWx1ZQogICAqIHNlcnZpY2UqKi4KICAgKgogICAqIFZhbHVlIHNlcnZpY2VzIGFyZSBzaW1pbGFyIHRvIGNvbnN0YW50IHNlcnZpY2VzLCBleGNlcHQgdGhhdCB0aGV5IGNhbm5vdCBiZSBpbmplY3RlZCBpbnRvIGEKICAgKiBtb2R1bGUgY29uZmlndXJhdGlvbiBmdW5jdGlvbiAoc2VlIHtAbGluayBhbmd1bGFyLk1vZHVsZSNjb25maWd9KSBidXQgdGhleSBjYW4gYmUgb3ZlcnJpZGRlbiBieQogICAqIGFuIEFuZ3VsYXIKICAgKiB7QGxpbmsgYXV0by4kcHJvdmlkZSNkZWNvcmF0b3IgZGVjb3JhdG9yfS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBpbnN0YW5jZS4KICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZS4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIHByb3ZpZGVyIGluc3RhbmNlCiAgICoKICAgKiBAZXhhbXBsZQogICAqIEhlcmUgYXJlIHNvbWUgZXhhbXBsZXMgb2YgY3JlYXRpbmcgdmFsdWUgc2VydmljZXMuCiAgICogYGBganMKICAgKiAgICRwcm92aWRlLnZhbHVlKCdBRE1JTl9VU0VSJywgJ2FkbWluJyk7CiAgICoKICAgKiAgICRwcm92aWRlLnZhbHVlKCdSb2xlTG9va3VwJywgeyBhZG1pbjogMCwgd3JpdGVyOiAxLCByZWFkZXI6IDIgfSk7CiAgICoKICAgKiAgICRwcm92aWRlLnZhbHVlKCdoYWxmT2YnLCBmdW5jdGlvbih2YWx1ZSkgewogKiAgICAgcmV0dXJuIHZhbHVlIC8gMjsKICogICB9KTsKICAgKiBgYGAKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBtZXRob2QKICAgKiBAbmFtZSAkcHJvdmlkZSNjb25zdGFudAogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogUmVnaXN0ZXIgYSAqKmNvbnN0YW50IHNlcnZpY2UqKiwgc3VjaCBhcyBhIHN0cmluZywgYSBudW1iZXIsIGFuIGFycmF5LCBhbiBvYmplY3Qgb3IgYSBmdW5jdGlvbiwKICAgKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4gVW5saWtlIHtAbGluayBhdXRvLiRwcm92aWRlI3ZhbHVlIHZhbHVlfSBpdCBjYW4gYmUKICAgKiBpbmplY3RlZCBpbnRvIGEgbW9kdWxlIGNvbmZpZ3VyYXRpb24gZnVuY3Rpb24gKHNlZSB7QGxpbmsgYW5ndWxhci5Nb2R1bGUjY29uZmlnfSkgYW5kIGl0IGNhbm5vdAogICAqIGJlIG92ZXJyaWRkZW4gYnkgYW4gQW5ndWxhciB7QGxpbmsgYXV0by4kcHJvdmlkZSNkZWNvcmF0b3IgZGVjb3JhdG9yfS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBjb25zdGFudC4KICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSBjb25zdGFudCB2YWx1ZS4KICAgKiBAcmV0dXJucyB7T2JqZWN0fSByZWdpc3RlcmVkIGluc3RhbmNlCiAgICoKICAgKiBAZXhhbXBsZQogICAqIEhlcmUgYSBzb21lIGV4YW1wbGVzIG9mIGNyZWF0aW5nIGNvbnN0YW50czoKICAgKiBgYGBqcwogICAqICAgJHByb3ZpZGUuY29uc3RhbnQoJ1NIQVJEX0hFSUdIVCcsIDMwNik7CiAgICoKICAgKiAgICRwcm92aWRlLmNvbnN0YW50KCdNWV9DT0xPVVJTJywgWydyZWQnLCAnYmx1ZScsICdncmV5J10pOwogICAqCiAgICogICAkcHJvdmlkZS5jb25zdGFudCgnZG91YmxlJywgZnVuY3Rpb24odmFsdWUpIHsKICogICAgIHJldHVybiB2YWx1ZSAqIDI7CiAqICAgfSk7CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHByb3ZpZGUjZGVjb3JhdG9yCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBSZWdpc3RlciBhICoqc2VydmljZSBkZWNvcmF0b3IqKiB3aXRoIHRoZSB7QGxpbmsgYXV0by4kaW5qZWN0b3IgJGluamVjdG9yfS4gQSBzZXJ2aWNlIGRlY29yYXRvcgogICAqIGludGVyY2VwdHMgdGhlIGNyZWF0aW9uIG9mIGEgc2VydmljZSwgYWxsb3dpbmcgaXQgdG8gb3ZlcnJpZGUgb3IgbW9kaWZ5IHRoZSBiZWhhdmlvdXIgb2YgdGhlCiAgICogc2VydmljZS4gVGhlIG9iamVjdCByZXR1cm5lZCBieSB0aGUgZGVjb3JhdG9yIG1heSBiZSB0aGUgb3JpZ2luYWwgc2VydmljZSwgb3IgYSBuZXcgc2VydmljZQogICAqIG9iamVjdCB3aGljaCByZXBsYWNlcyBvciB3cmFwcyBhbmQgZGVsZWdhdGVzIHRvIHRoZSBvcmlnaW5hbCBzZXJ2aWNlLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHNlcnZpY2UgdG8gZGVjb3JhdGUuCiAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBkZWNvcmF0b3IgVGhpcyBmdW5jdGlvbiB3aWxsIGJlIGludm9rZWQgd2hlbiB0aGUgc2VydmljZSBuZWVkcyB0byBiZQogICAqICAgIGluc3RhbnRpYXRlZCBhbmQgc2hvdWxkIHJldHVybiB0aGUgZGVjb3JhdGVkIHNlcnZpY2UgaW5zdGFuY2UuIFRoZSBmdW5jdGlvbiBpcyBjYWxsZWQgdXNpbmcKICAgKiAgICB0aGUge0BsaW5rIGF1dG8uJGluamVjdG9yI2ludm9rZSBpbmplY3Rvci5pbnZva2V9IG1ldGhvZCBhbmQgaXMgdGhlcmVmb3JlIGZ1bGx5IGluamVjdGFibGUuCiAgICogICAgTG9jYWwgaW5qZWN0aW9uIGFyZ3VtZW50czoKICAgKgogICAqICAgICogYCRkZWxlZ2F0ZWAgLSBUaGUgb3JpZ2luYWwgc2VydmljZSBpbnN0YW5jZSwgd2hpY2ggY2FuIGJlIG1vbmtleSBwYXRjaGVkLCBjb25maWd1cmVkLAogICAqICAgICAgZGVjb3JhdGVkIG9yIGRlbGVnYXRlZCB0by4KICAgKgogICAqIEBleGFtcGxlCiAgICogSGVyZSB3ZSBkZWNvcmF0ZSB0aGUge0BsaW5rIG5nLiRsb2cgJGxvZ30gc2VydmljZSB0byBjb252ZXJ0IHdhcm5pbmdzIHRvIGVycm9ycyBieSBpbnRlcmNlcHRpbmcKICAgKiBjYWxscyB0byB7QGxpbmsgbmcuJGxvZyNlcnJvciAkbG9nLndhcm4oKX0uCiAgICogYGBganMKICAgKiAgICRwcm92aWRlLmRlY29yYXRvcignJGxvZycsIFsnJGRlbGVnYXRlJywgZnVuY3Rpb24oJGRlbGVnYXRlKSB7CiAqICAgICAkZGVsZWdhdGUud2FybiA9ICRkZWxlZ2F0ZS5lcnJvcjsKICogICAgIHJldHVybiAkZGVsZWdhdGU7CiAqICAgfV0pOwogICAqIGBgYAogICAqLwoKCiAgZnVuY3Rpb24gY3JlYXRlSW5qZWN0b3IobW9kdWxlc1RvTG9hZCkgewogICAgdmFyIElOU1RBTlRJQVRJTkcgPSB7fSwKICAgICAgcHJvdmlkZXJTdWZmaXggPSAnUHJvdmlkZXInLAogICAgICBwYXRoID0gW10sCiAgICAgIGxvYWRlZE1vZHVsZXMgPSBuZXcgSGFzaE1hcCgpLAogICAgICBwcm92aWRlckNhY2hlID0gewogICAgICAgICRwcm92aWRlOiB7CiAgICAgICAgICBwcm92aWRlcjogc3VwcG9ydE9iamVjdChwcm92aWRlciksCiAgICAgICAgICBmYWN0b3J5OiBzdXBwb3J0T2JqZWN0KGZhY3RvcnkpLAogICAgICAgICAgc2VydmljZTogc3VwcG9ydE9iamVjdChzZXJ2aWNlKSwKICAgICAgICAgIHZhbHVlOiBzdXBwb3J0T2JqZWN0KHZhbHVlKSwKICAgICAgICAgIGNvbnN0YW50OiBzdXBwb3J0T2JqZWN0KGNvbnN0YW50KSwKICAgICAgICAgIGRlY29yYXRvcjogZGVjb3JhdG9yCiAgICAgICAgfQogICAgICB9LAogICAgICBwcm92aWRlckluamVjdG9yID0gKHByb3ZpZGVyQ2FjaGUuJGluamVjdG9yID0KICAgICAgICBjcmVhdGVJbnRlcm5hbEluamVjdG9yKHByb3ZpZGVyQ2FjaGUsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhyb3cgJGluamVjdG9yTWluRXJyKCd1bnByJywgIlVua25vd24gcHJvdmlkZXI6IHswfSIsIHBhdGguam9pbignIDwtICcpKTsKICAgICAgICB9KSksCiAgICAgIGluc3RhbmNlQ2FjaGUgPSB7fSwKICAgICAgaW5zdGFuY2VJbmplY3RvciA9IChpbnN0YW5jZUNhY2hlLiRpbmplY3RvciA9CiAgICAgICAgY3JlYXRlSW50ZXJuYWxJbmplY3RvcihpbnN0YW5jZUNhY2hlLCBmdW5jdGlvbihzZXJ2aWNlbmFtZSkgewogICAgICAgICAgdmFyIHByb3ZpZGVyID0gcHJvdmlkZXJJbmplY3Rvci5nZXQoc2VydmljZW5hbWUgKyBwcm92aWRlclN1ZmZpeCk7CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2VJbmplY3Rvci5pbnZva2UocHJvdmlkZXIuJGdldCwgcHJvdmlkZXIpOwogICAgICAgIH0pKTsKCgogICAgZm9yRWFjaChsb2FkTW9kdWxlcyhtb2R1bGVzVG9Mb2FkKSwgZnVuY3Rpb24oZm4pIHsgaW5zdGFuY2VJbmplY3Rvci5pbnZva2UoZm4gfHwgbm9vcCk7IH0pOwoKICAgIHJldHVybiBpbnN0YW5jZUluamVjdG9yOwoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8gJHByb3ZpZGVyCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICBmdW5jdGlvbiBzdXBwb3J0T2JqZWN0KGRlbGVnYXRlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKGlzT2JqZWN0KGtleSkpIHsKICAgICAgICAgIGZvckVhY2goa2V5LCByZXZlcnNlUGFyYW1zKGRlbGVnYXRlKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBkZWxlZ2F0ZShrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CgogICAgZnVuY3Rpb24gcHJvdmlkZXIobmFtZSwgcHJvdmlkZXJfKSB7CiAgICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KG5hbWUsICdzZXJ2aWNlJyk7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHByb3ZpZGVyXykgfHwgaXNBcnJheShwcm92aWRlcl8pKSB7CiAgICAgICAgcHJvdmlkZXJfID0gcHJvdmlkZXJJbmplY3Rvci5pbnN0YW50aWF0ZShwcm92aWRlcl8pOwogICAgICB9CiAgICAgIGlmICghcHJvdmlkZXJfLiRnZXQpIHsKICAgICAgICB0aHJvdyAkaW5qZWN0b3JNaW5FcnIoJ3BnZXQnLCAiUHJvdmlkZXIgJ3swfScgbXVzdCBkZWZpbmUgJGdldCBmYWN0b3J5IG1ldGhvZC4iLCBuYW1lKTsKICAgICAgfQogICAgICByZXR1cm4gcHJvdmlkZXJDYWNoZVtuYW1lICsgcHJvdmlkZXJTdWZmaXhdID0gcHJvdmlkZXJfOwogICAgfQoKICAgIGZ1bmN0aW9uIGZhY3RvcnkobmFtZSwgZmFjdG9yeUZuKSB7IHJldHVybiBwcm92aWRlcihuYW1lLCB7ICRnZXQ6IGZhY3RvcnlGbiB9KTsgfQoKICAgIGZ1bmN0aW9uIHNlcnZpY2UobmFtZSwgY29uc3RydWN0b3IpIHsKICAgICAgcmV0dXJuIGZhY3RvcnkobmFtZSwgWyckaW5qZWN0b3InLCBmdW5jdGlvbigkaW5qZWN0b3IpIHsKICAgICAgICByZXR1cm4gJGluamVjdG9yLmluc3RhbnRpYXRlKGNvbnN0cnVjdG9yKTsKICAgICAgfV0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHZhbHVlKG5hbWUsIHZhbCkgeyByZXR1cm4gZmFjdG9yeShuYW1lLCB2YWx1ZUZuKHZhbCkpOyB9CgogICAgZnVuY3Rpb24gY29uc3RhbnQobmFtZSwgdmFsdWUpIHsKICAgICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkobmFtZSwgJ2NvbnN0YW50Jyk7CiAgICAgIHByb3ZpZGVyQ2FjaGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgaW5zdGFuY2VDYWNoZVtuYW1lXSA9IHZhbHVlOwogICAgfQoKICAgIGZ1bmN0aW9uIGRlY29yYXRvcihzZXJ2aWNlTmFtZSwgZGVjb3JGbikgewogICAgICB2YXIgb3JpZ1Byb3ZpZGVyID0gcHJvdmlkZXJJbmplY3Rvci5nZXQoc2VydmljZU5hbWUgKyBwcm92aWRlclN1ZmZpeCksCiAgICAgICAgb3JpZyRnZXQgPSBvcmlnUHJvdmlkZXIuJGdldDsKCiAgICAgIG9yaWdQcm92aWRlci4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG9yaWdJbnN0YW5jZSA9IGluc3RhbmNlSW5qZWN0b3IuaW52b2tlKG9yaWckZ2V0LCBvcmlnUHJvdmlkZXIpOwogICAgICAgIHJldHVybiBpbnN0YW5jZUluamVjdG9yLmludm9rZShkZWNvckZuLCBudWxsLCB7JGRlbGVnYXRlOiBvcmlnSW5zdGFuY2V9KTsKICAgICAgfTsKICAgIH0KCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vIE1vZHVsZSBMb2FkaW5nCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIGZ1bmN0aW9uIGxvYWRNb2R1bGVzKG1vZHVsZXNUb0xvYWQpewogICAgICB2YXIgcnVuQmxvY2tzID0gW10sIG1vZHVsZUZuLCBpbnZva2VRdWV1ZSwgaSwgaWk7CiAgICAgIGZvckVhY2gobW9kdWxlc1RvTG9hZCwgZnVuY3Rpb24obW9kdWxlKSB7CiAgICAgICAgaWYgKGxvYWRlZE1vZHVsZXMuZ2V0KG1vZHVsZSkpIHJldHVybjsKICAgICAgICBsb2FkZWRNb2R1bGVzLnB1dChtb2R1bGUsIHRydWUpOwoKICAgICAgICB0cnkgewogICAgICAgICAgaWYgKGlzU3RyaW5nKG1vZHVsZSkpIHsKICAgICAgICAgICAgbW9kdWxlRm4gPSBhbmd1bGFyTW9kdWxlKG1vZHVsZSk7CiAgICAgICAgICAgIHJ1bkJsb2NrcyA9IHJ1bkJsb2Nrcy5jb25jYXQobG9hZE1vZHVsZXMobW9kdWxlRm4ucmVxdWlyZXMpKS5jb25jYXQobW9kdWxlRm4uX3J1bkJsb2Nrcyk7CgogICAgICAgICAgICBmb3IoaW52b2tlUXVldWUgPSBtb2R1bGVGbi5faW52b2tlUXVldWUsIGkgPSAwLCBpaSA9IGludm9rZVF1ZXVlLmxlbmd0aDsgaSA8IGlpOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgaW52b2tlQXJncyA9IGludm9rZVF1ZXVlW2ldLAogICAgICAgICAgICAgICAgcHJvdmlkZXIgPSBwcm92aWRlckluamVjdG9yLmdldChpbnZva2VBcmdzWzBdKTsKCiAgICAgICAgICAgICAgcHJvdmlkZXJbaW52b2tlQXJnc1sxXV0uYXBwbHkocHJvdmlkZXIsIGludm9rZUFyZ3NbMl0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24obW9kdWxlKSkgewogICAgICAgICAgICBydW5CbG9ja3MucHVzaChwcm92aWRlckluamVjdG9yLmludm9rZShtb2R1bGUpKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShtb2R1bGUpKSB7CiAgICAgICAgICAgIHJ1bkJsb2Nrcy5wdXNoKHByb3ZpZGVySW5qZWN0b3IuaW52b2tlKG1vZHVsZSkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXNzZXJ0QXJnRm4obW9kdWxlLCAnbW9kdWxlJyk7CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgaWYgKGlzQXJyYXkobW9kdWxlKSkgewogICAgICAgICAgICBtb2R1bGUgPSBtb2R1bGVbbW9kdWxlLmxlbmd0aCAtIDFdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGUubWVzc2FnZSAmJiBlLnN0YWNrICYmIGUuc3RhY2suaW5kZXhPZihlLm1lc3NhZ2UpID09IC0xKSB7CiAgICAgICAgICAgIC8vIFNhZmFyaSAmIEZGJ3Mgc3RhY2sgdHJhY2VzIGRvbid0IGNvbnRhaW4gZXJyb3IubWVzc2FnZSBjb250ZW50CiAgICAgICAgICAgIC8vIHVubGlrZSB0aG9zZSBvZiBDaHJvbWUgYW5kIElFCiAgICAgICAgICAgIC8vIFNvIGlmIHN0YWNrIGRvZXNuJ3QgY29udGFpbiBtZXNzYWdlLCB3ZSBjcmVhdGUgYSBuZXcgc3RyaW5nIHRoYXQgY29udGFpbnMgYm90aC4KICAgICAgICAgICAgLy8gU2luY2UgZXJyb3Iuc3RhY2sgaXMgcmVhZC1vbmx5IGluIFNhZmFyaSwgSSdtIG92ZXJyaWRpbmcgZSBhbmQgbm90IGUuc3RhY2sgaGVyZS4KICAgICAgICAgICAgLyoganNoaW50IC1XMDIyICovCiAgICAgICAgICAgIGUgPSBlLm1lc3NhZ2UgKyAnXG4nICsgZS5zdGFjazsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignbW9kdWxlcnInLCAiRmFpbGVkIHRvIGluc3RhbnRpYXRlIG1vZHVsZSB7MH0gZHVlIHRvOlxuezF9IiwKICAgICAgICAgICAgbW9kdWxlLCBlLnN0YWNrIHx8IGUubWVzc2FnZSB8fCBlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gcnVuQmxvY2tzOwogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8gaW50ZXJuYWwgSW5qZWN0b3IKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIGZ1bmN0aW9uIGNyZWF0ZUludGVybmFsSW5qZWN0b3IoY2FjaGUsIGZhY3RvcnkpIHsKCiAgICAgIGZ1bmN0aW9uIGdldFNlcnZpY2Uoc2VydmljZU5hbWUpIHsKICAgICAgICBpZiAoY2FjaGUuaGFzT3duUHJvcGVydHkoc2VydmljZU5hbWUpKSB7CiAgICAgICAgICBpZiAoY2FjaGVbc2VydmljZU5hbWVdID09PSBJTlNUQU5USUFUSU5HKSB7CiAgICAgICAgICAgIHRocm93ICRpbmplY3Rvck1pbkVycignY2RlcCcsICdDaXJjdWxhciBkZXBlbmRlbmN5IGZvdW5kOiB7MH0nLCBwYXRoLmpvaW4oJyA8LSAnKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBwYXRoLnVuc2hpZnQoc2VydmljZU5hbWUpOwogICAgICAgICAgICBjYWNoZVtzZXJ2aWNlTmFtZV0gPSBJTlNUQU5USUFUSU5HOwogICAgICAgICAgICByZXR1cm4gY2FjaGVbc2VydmljZU5hbWVdID0gZmFjdG9yeShzZXJ2aWNlTmFtZSk7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgaWYgKGNhY2hlW3NlcnZpY2VOYW1lXSA9PT0gSU5TVEFOVElBVElORykgewogICAgICAgICAgICAgIGRlbGV0ZSBjYWNoZVtzZXJ2aWNlTmFtZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcGF0aC5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gaW52b2tlKGZuLCBzZWxmLCBsb2NhbHMpewogICAgICAgIHZhciBhcmdzID0gW10sCiAgICAgICAgICAkaW5qZWN0ID0gYW5ub3RhdGUoZm4pLAogICAgICAgICAgbGVuZ3RoLCBpLAogICAgICAgICAga2V5OwoKICAgICAgICBmb3IoaSA9IDAsIGxlbmd0aCA9ICRpbmplY3QubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGtleSA9ICRpbmplY3RbaV07CiAgICAgICAgICBpZiAodHlwZW9mIGtleSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgdGhyb3cgJGluamVjdG9yTWluRXJyKCdpdGtuJywKICAgICAgICAgICAgICAnSW5jb3JyZWN0IGluamVjdGlvbiB0b2tlbiEgRXhwZWN0ZWQgc2VydmljZSBuYW1lIGFzIHN0cmluZywgZ290IHswfScsIGtleSk7CiAgICAgICAgICB9CiAgICAgICAgICBhcmdzLnB1c2goCiAgICAgICAgICAgICAgbG9jYWxzICYmIGxvY2Fscy5oYXNPd25Qcm9wZXJ0eShrZXkpCiAgICAgICAgICAgICAgPyBsb2NhbHNba2V5XQogICAgICAgICAgICAgIDogZ2V0U2VydmljZShrZXkpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoIWZuLiRpbmplY3QpIHsKICAgICAgICAgIC8vIHRoaXMgbWVhbnMgdGhhdCB3ZSBtdXN0IGJlIGFuIGFycmF5LgogICAgICAgICAgZm4gPSBmbltsZW5ndGhdOwogICAgICAgIH0KCiAgICAgICAgLy8gaHR0cDovL2pzcGVyZi5jb20vYW5ndWxhcmpzLWludm9rZS1hcHBseS12cy1zd2l0Y2gKICAgICAgICAvLyAjNTM4OAogICAgICAgIHJldHVybiBmbi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gaW5zdGFudGlhdGUoVHlwZSwgbG9jYWxzKSB7CiAgICAgICAgdmFyIENvbnN0cnVjdG9yID0gZnVuY3Rpb24oKSB7fSwKICAgICAgICAgIGluc3RhbmNlLCByZXR1cm5lZFZhbHVlOwoKICAgICAgICAvLyBDaGVjayBpZiBUeXBlIGlzIGFubm90YXRlZCBhbmQgdXNlIGp1c3QgdGhlIGdpdmVuIGZ1bmN0aW9uIGF0IG4tMSBhcyBwYXJhbWV0ZXIKICAgICAgICAvLyBlLmcuIHNvbWVNb2R1bGUuZmFjdG9yeSgnZ3JlZXRlcicsIFsnJHdpbmRvdycsIGZ1bmN0aW9uKHJlbmFtZWQkd2luZG93KSB7fV0pOwogICAgICAgIENvbnN0cnVjdG9yLnByb3RvdHlwZSA9IChpc0FycmF5KFR5cGUpID8gVHlwZVtUeXBlLmxlbmd0aCAtIDFdIDogVHlwZSkucHJvdG90eXBlOwogICAgICAgIGluc3RhbmNlID0gbmV3IENvbnN0cnVjdG9yKCk7CiAgICAgICAgcmV0dXJuZWRWYWx1ZSA9IGludm9rZShUeXBlLCBpbnN0YW5jZSwgbG9jYWxzKTsKCiAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHJldHVybmVkVmFsdWUpIHx8IGlzRnVuY3Rpb24ocmV0dXJuZWRWYWx1ZSkgPyByZXR1cm5lZFZhbHVlIDogaW5zdGFuY2U7CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgaW52b2tlOiBpbnZva2UsCiAgICAgICAgaW5zdGFudGlhdGU6IGluc3RhbnRpYXRlLAogICAgICAgIGdldDogZ2V0U2VydmljZSwKICAgICAgICBhbm5vdGF0ZTogYW5ub3RhdGUsCiAgICAgICAgaGFzOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICByZXR1cm4gcHJvdmlkZXJDYWNoZS5oYXNPd25Qcm9wZXJ0eShuYW1lICsgcHJvdmlkZXJTdWZmaXgpIHx8IGNhY2hlLmhhc093blByb3BlcnR5KG5hbWUpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGFuY2hvclNjcm9sbAogICAqIEBraW5kIGZ1bmN0aW9uCiAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgKiBAcmVxdWlyZXMgJGxvY2F0aW9uCiAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFdoZW4gY2FsbGVkLCBpdCBjaGVja3MgY3VycmVudCB2YWx1ZSBvZiBgJGxvY2F0aW9uLmhhc2goKWAgYW5kIHNjcm9sbHMgdG8gdGhlIHJlbGF0ZWQgZWxlbWVudCwKICAgKiBhY2NvcmRpbmcgdG8gcnVsZXMgc3BlY2lmaWVkIGluCiAgICogW0h0bWw1IHNwZWNdKGh0dHA6Ly9kZXYudzMub3JnL2h0bWw1L3NwZWMvT3ZlcnZpZXcuaHRtbCN0aGUtaW5kaWNhdGVkLXBhcnQtb2YtdGhlLWRvY3VtZW50KS4KICAgKgogICAqIEl0IGFsc28gd2F0Y2hlcyB0aGUgYCRsb2NhdGlvbi5oYXNoKClgIGFuZCBzY3JvbGxzIHdoZW5ldmVyIGl0IGNoYW5nZXMgdG8gbWF0Y2ggYW55IGFuY2hvci4KICAgKiBUaGlzIGNhbiBiZSBkaXNhYmxlZCBieSBjYWxsaW5nIGAkYW5jaG9yU2Nyb2xsUHJvdmlkZXIuZGlzYWJsZUF1dG9TY3JvbGxpbmcoKWAuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgaWQ9InNjcm9sbEFyZWEiIG5nLWNvbnRyb2xsZXI9IlNjcm9sbEN0cmwiPgogICA8YSBuZy1jbGljaz0iZ290b0JvdHRvbSgpIj5HbyB0byBib3R0b208L2E+CiAgIDxhIGlkPSJib3R0b20iPjwvYT4gWW91J3JlIGF0IHRoZSBib3R0b20hCiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgIGZ1bmN0aW9uIFNjcm9sbEN0cmwoJHNjb3BlLCAkbG9jYXRpb24sICRhbmNob3JTY3JvbGwpIHsKICAgICAgICAgJHNjb3BlLmdvdG9Cb3R0b20gPSBmdW5jdGlvbiAoKXsKICAgICAgICAgICAvLyBzZXQgdGhlIGxvY2F0aW9uLmhhc2ggdG8gdGhlIGlkIG9mCiAgICAgICAgICAgLy8gdGhlIGVsZW1lbnQgeW91IHdpc2ggdG8gc2Nyb2xsIHRvLgogICAgICAgICAgICRsb2NhdGlvbi5oYXNoKCdib3R0b20nKTsKCiAgICAgICAgICAgLy8gY2FsbCAkYW5jaG9yU2Nyb2xsKCkKICAgICAgICAgICAkYW5jaG9yU2Nyb2xsKCk7CiAgICAgICAgIH07CiAgICAgICB9CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgI3Njcm9sbEFyZWEgewogICAgICAgICBoZWlnaHQ6IDM1MHB4OwogICAgICAgICBvdmVyZmxvdzogYXV0bzsKICAgICAgIH0KCiAgICNib3R0b20gewogICAgICAgICBkaXNwbGF5OiBibG9jazsKICAgICAgICAgbWFyZ2luLXRvcDogMjAwMHB4OwogICAgICAgfQogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICBmdW5jdGlvbiAkQW5jaG9yU2Nyb2xsUHJvdmlkZXIoKSB7CgogICAgdmFyIGF1dG9TY3JvbGxpbmdFbmFibGVkID0gdHJ1ZTsKCiAgICB0aGlzLmRpc2FibGVBdXRvU2Nyb2xsaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgIGF1dG9TY3JvbGxpbmdFbmFibGVkID0gZmFsc2U7CiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckbG9jYXRpb24nLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKCR3aW5kb3csICRsb2NhdGlvbiwgJHJvb3RTY29wZSkgewogICAgICB2YXIgZG9jdW1lbnQgPSAkd2luZG93LmRvY3VtZW50OwoKICAgICAgLy8gaGVscGVyIGZ1bmN0aW9uIHRvIGdldCBmaXJzdCBhbmNob3IgZnJvbSBhIE5vZGVMaXN0CiAgICAgIC8vIGNhbid0IHVzZSBmaWx0ZXIuZmlsdGVyLCBhcyBpdCBhY2NlcHRzIG9ubHkgaW5zdGFuY2VzIG9mIEFycmF5CiAgICAgIC8vIGFuZCBJRSBjYW4ndCBjb252ZXJ0IE5vZGVMaXN0IHRvIGFuIGFycmF5IHVzaW5nIFtdLnNsaWNlCiAgICAgIC8vIFRPRE8odm9qdGEpOiB1c2UgZmlsdGVyIGlmIHdlIGNoYW5nZSBpdCB0byBhY2NlcHQgbGlzdHMgYXMgd2VsbAogICAgICBmdW5jdGlvbiBnZXRGaXJzdEFuY2hvcihsaXN0KSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IG51bGw7CiAgICAgICAgZm9yRWFjaChsaXN0LCBmdW5jdGlvbihlbGVtZW50KSB7CiAgICAgICAgICBpZiAoIXJlc3VsdCAmJiBsb3dlcmNhc2UoZWxlbWVudC5ub2RlTmFtZSkgPT09ICdhJykgcmVzdWx0ID0gZWxlbWVudDsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CgogICAgICBmdW5jdGlvbiBzY3JvbGwoKSB7CiAgICAgICAgdmFyIGhhc2ggPSAkbG9jYXRpb24uaGFzaCgpLCBlbG07CgogICAgICAgIC8vIGVtcHR5IGhhc2gsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgICAgaWYgKCFoYXNoKSAkd2luZG93LnNjcm9sbFRvKDAsIDApOwoKICAgICAgICAvLyBlbGVtZW50IHdpdGggZ2l2ZW4gaWQKICAgICAgICBlbHNlIGlmICgoZWxtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaGFzaCkpKSBlbG0uc2Nyb2xsSW50b1ZpZXcoKTsKCiAgICAgICAgLy8gZmlyc3QgYW5jaG9yIHdpdGggZ2l2ZW4gbmFtZSA6LUQKICAgICAgICBlbHNlIGlmICgoZWxtID0gZ2V0Rmlyc3RBbmNob3IoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeU5hbWUoaGFzaCkpKSkgZWxtLnNjcm9sbEludG9WaWV3KCk7CgogICAgICAgIC8vIG5vIGVsZW1lbnQgYW5kIGhhc2ggPT0gJ3RvcCcsIHNjcm9sbCB0byB0aGUgdG9wIG9mIHRoZSBwYWdlCiAgICAgICAgZWxzZSBpZiAoaGFzaCA9PT0gJ3RvcCcpICR3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CiAgICAgIH0KCiAgICAgIC8vIGRvZXMgbm90IHNjcm9sbCB3aGVuIHVzZXIgY2xpY2tzIG9uIGFuY2hvciBsaW5rIHRoYXQgaXMgY3VycmVudGx5IG9uCiAgICAgIC8vIChubyB1cmwgY2hhbmdlLCBubyAkbG9jYXRpb24uaGFzaCgpIGNoYW5nZSksIGJyb3dzZXIgbmF0aXZlIGRvZXMgc2Nyb2xsCiAgICAgIGlmIChhdXRvU2Nyb2xsaW5nRW5hYmxlZCkgewogICAgICAgICRyb290U2NvcGUuJHdhdGNoKGZ1bmN0aW9uIGF1dG9TY3JvbGxXYXRjaCgpIHtyZXR1cm4gJGxvY2F0aW9uLmhhc2goKTt9LAogICAgICAgICAgZnVuY3Rpb24gYXV0b1Njcm9sbFdhdGNoQWN0aW9uKCkgewogICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoc2Nyb2xsKTsKICAgICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gc2Nyb2xsOwogICAgfV07CiAgfQoKICB2YXIgJGFuaW1hdGVNaW5FcnIgPSBtaW5FcnIoJyRhbmltYXRlJyk7CgogIC8qKgogICAqIEBuZ2RvYyBwcm92aWRlcgogICAqIEBuYW1lICRhbmltYXRlUHJvdmlkZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgJGFuaW1hdGUgdGhhdCBkb2Vzbid0IHBlcmZvcm0gYW55IGFuaW1hdGlvbnMsIGluc3RlYWQganVzdAogICAqIHN5bmNocm9ub3VzbHkgcGVyZm9ybXMgRE9NCiAgICogdXBkYXRlcyBhbmQgY2FsbHMgZG9uZSgpIGNhbGxiYWNrcy4KICAgKgogICAqIEluIG9yZGVyIHRvIGVuYWJsZSBhbmltYXRpb25zIHRoZSBuZ0FuaW1hdGUgbW9kdWxlIGhhcyB0byBiZSBsb2FkZWQuCiAgICoKICAgKiBUbyBzZWUgdGhlIGZ1bmN0aW9uYWwgaW1wbGVtZW50YXRpb24gY2hlY2sgb3V0IHNyYy9uZ0FuaW1hdGUvYW5pbWF0ZS5qcwogICAqLwogIHZhciAkQW5pbWF0ZVByb3ZpZGVyID0gWyckcHJvdmlkZScsIGZ1bmN0aW9uKCRwcm92aWRlKSB7CgoKICAgIHRoaXMuJCRzZWxlY3RvcnMgPSB7fTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkYW5pbWF0ZVByb3ZpZGVyI3JlZ2lzdGVyCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZWdpc3RlcnMgYSBuZXcgaW5qZWN0YWJsZSBhbmltYXRpb24gZmFjdG9yeSBmdW5jdGlvbi4gVGhlIGZhY3RvcnkgZnVuY3Rpb24gcHJvZHVjZXMgdGhlCiAgICAgKiBhbmltYXRpb24gb2JqZWN0IHdoaWNoIGNvbnRhaW5zIGNhbGxiYWNrIGZ1bmN0aW9ucyBmb3IgZWFjaCBldmVudCB0aGF0IGlzIGV4cGVjdGVkIHRvIGJlCiAgICAgKiBhbmltYXRlZC4KICAgICAqCiAgICAgKiAgICogYGV2ZW50Rm5gOiBgZnVuY3Rpb24oRWxlbWVudCwgZG9uZUZ1bmN0aW9uKWAgVGhlIGVsZW1lbnQgdG8gYW5pbWF0ZSwgdGhlIGBkb25lRnVuY3Rpb25gCiAgICAgKiAgIG11c3QgYmUgY2FsbGVkIG9uY2UgdGhlIGVsZW1lbnQgYW5pbWF0aW9uIGlzIGNvbXBsZXRlLiBJZiBhIGZ1bmN0aW9uIGlzIHJldHVybmVkIHRoZW4gdGhlCiAgICAgKiAgIGFuaW1hdGlvbiBzZXJ2aWNlIHdpbGwgdXNlIHRoaXMgZnVuY3Rpb24gdG8gY2FuY2VsIHRoZSBhbmltYXRpb24gd2hlbmV2ZXIgYSBjYW5jZWwgZXZlbnQgaXMKICAgICAqICAgdHJpZ2dlcmVkLgogICAgICoKICAgICAqCiAgICAgKiBgYGBqcwogICAgICogICByZXR1cm4gewogICAgICogICAgIGV2ZW50Rm4gOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7CiAgICAgKiAgICAgICAvL2NvZGUgdG8gcnVuIHRoZSBhbmltYXRpb24KICAgICAqICAgICAgIC8vb25jZSBjb21wbGV0ZSwgdGhlbiBydW4gZG9uZSgpCiAgICAgKiAgICAgICByZXR1cm4gZnVuY3Rpb24gY2FuY2VsbGF0aW9uRnVuY3Rpb24oKSB7CiAgICAgKiAgICAgICAgIC8vY29kZSB0byBjYW5jZWwgdGhlIGFuaW1hdGlvbgogICAgICogICAgICAgfQogICAgICogICAgIH0KICAgICAqICAgfQogICAgICogYGBgCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIGFuaW1hdGlvbi4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZhY3RvcnkgVGhlIGZhY3RvcnkgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIHRvIHJldHVybiB0aGUgYW5pbWF0aW9uCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC4KICAgICAqLwogICAgdGhpcy5yZWdpc3RlciA9IGZ1bmN0aW9uKG5hbWUsIGZhY3RvcnkpIHsKICAgICAgdmFyIGtleSA9IG5hbWUgKyAnLWFuaW1hdGlvbic7CiAgICAgIGlmIChuYW1lICYmIG5hbWUuY2hhckF0KDApICE9ICcuJykgdGhyb3cgJGFuaW1hdGVNaW5FcnIoJ25vdGNzZWwnLAogICAgICAgICJFeHBlY3RpbmcgY2xhc3Mgc2VsZWN0b3Igc3RhcnRpbmcgd2l0aCAnLicgZ290ICd7MH0nLiIsIG5hbWUpOwogICAgICB0aGlzLiQkc2VsZWN0b3JzW25hbWUuc3Vic3RyKDEpXSA9IGtleTsKICAgICAgJHByb3ZpZGUuZmFjdG9yeShrZXksIGZhY3RvcnkpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRhbmltYXRlUHJvdmlkZXIjY2xhc3NOYW1lRmlsdGVyCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXRzIGFuZC9vciByZXR1cm5zIHRoZSBDU1MgY2xhc3MgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgY2hlY2tlZCB3aGVuIHBlcmZvcm1pbmcKICAgICAqIGFuIGFuaW1hdGlvbi4gVXBvbiBib290c3RyYXAgdGhlIGNsYXNzTmFtZUZpbHRlciB2YWx1ZSBpcyBub3Qgc2V0IGF0IGFsbCBhbmQgd2lsbAogICAgICogdGhlcmVmb3JlIGVuYWJsZSAkYW5pbWF0ZSB0byBhdHRlbXB0IHRvIHBlcmZvcm0gYW4gYW5pbWF0aW9uIG9uIGFueSBlbGVtZW50LgogICAgICogV2hlbiBzZXR0aW5nIHRoZSBjbGFzc05hbWVGaWx0ZXIgdmFsdWUsIGFuaW1hdGlvbnMgd2lsbCBvbmx5IGJlIHBlcmZvcm1lZCBvbiBlbGVtZW50cwogICAgICogdGhhdCBzdWNjZXNzZnVsbHkgbWF0Y2ggdGhlIGZpbHRlciBleHByZXNzaW9uLiBUaGlzIGluIHR1cm4gY2FuIGJvb3N0IHBlcmZvcm1hbmNlCiAgICAgKiBmb3IgbG93LXBvd2VyZWQgZGV2aWNlcyBhcyB3ZWxsIGFzIGFwcGxpY2F0aW9ucyBjb250YWluaW5nIGEgbG90IG9mIHN0cnVjdHVyYWwgb3BlcmF0aW9ucy4KICAgICAqIEBwYXJhbSB7UmVnRXhwPX0gZXhwcmVzc2lvbiBUaGUgY2xhc3NOYW1lIGV4cHJlc3Npb24gd2hpY2ggd2lsbCBiZSBjaGVja2VkIGFnYWluc3QgYWxsIGFuaW1hdGlvbnMKICAgICAqIEByZXR1cm4ge1JlZ0V4cH0gVGhlIGN1cnJlbnQgQ1NTIGNsYXNzTmFtZSBleHByZXNzaW9uIHZhbHVlLiBJZiBudWxsIHRoZW4gdGhlcmUgaXMgbm8gZXhwcmVzc2lvbiB2YWx1ZQogICAgICovCiAgICB0aGlzLmNsYXNzTmFtZUZpbHRlciA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pIHsKICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHRoaXMuJCRjbGFzc05hbWVGaWx0ZXIgPSAoZXhwcmVzc2lvbiBpbnN0YW5jZW9mIFJlZ0V4cCkgPyBleHByZXNzaW9uIDogbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy4kJGNsYXNzTmFtZUZpbHRlcjsKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gWyckdGltZW91dCcsICckJGFzeW5jQ2FsbGJhY2snLCBmdW5jdGlvbigkdGltZW91dCwgJCRhc3luY0NhbGxiYWNrKSB7CgogICAgICBmdW5jdGlvbiBhc3luYyhmbikgewogICAgICAgIGZuICYmICQkYXN5bmNDYWxsYmFjayhmbik7CiAgICAgIH0KCiAgICAgIC8qKgogICAgICAgKgogICAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICAgKiBAbmFtZSAkYW5pbWF0ZQogICAgICAgKiBAZGVzY3JpcHRpb24gVGhlICRhbmltYXRlIHNlcnZpY2UgcHJvdmlkZXMgcnVkaW1lbnRhcnkgRE9NIG1hbmlwdWxhdGlvbiBmdW5jdGlvbnMgdG8KICAgICAgICogaW5zZXJ0LCByZW1vdmUgYW5kIG1vdmUgZWxlbWVudHMgd2l0aGluIHRoZSBET00sIGFzIHdlbGwgYXMgYWRkaW5nIGFuZCByZW1vdmluZyBjbGFzc2VzLgogICAgICAgKiBUaGlzIHNlcnZpY2UgaXMgdGhlIGNvcmUgc2VydmljZSB1c2VkIGJ5IHRoZSBuZ0FuaW1hdGUgJGFuaW1hdG9yIHNlcnZpY2Ugd2hpY2ggcHJvdmlkZXMKICAgICAgICogaGlnaC1sZXZlbCBhbmltYXRpb24gaG9va3MgZm9yIENTUyBhbmQgSmF2YVNjcmlwdC4KICAgICAgICoKICAgICAgICogJGFuaW1hdGUgaXMgYXZhaWxhYmxlIGluIHRoZSBBbmd1bGFySlMgY29yZSwgaG93ZXZlciwgdGhlIG5nQW5pbWF0ZSBtb2R1bGUgbXVzdCBiZSBpbmNsdWRlZAogICAgICAgKiB0byBlbmFibGUgZnVsbCBvdXQgYW5pbWF0aW9uIHN1cHBvcnQuIE90aGVyd2lzZSwgJGFuaW1hdGUgd2lsbCBvbmx5IHBlcmZvcm0gc2ltcGxlIERPTQogICAgICAgKiBtYW5pcHVsYXRpb24gb3BlcmF0aW9ucy4KICAgICAgICoKICAgICAgICogVG8gbGVhcm4gbW9yZSBhYm91dCBlbmFibGluZyBhbmltYXRpb24gc3VwcG9ydCwgY2xpY2sgaGVyZSB0byB2aXNpdCB0aGUge0BsaW5rIG5nQW5pbWF0ZQogICAgICogbmdBbmltYXRlIG1vZHVsZSBwYWdlfSBhcyB3ZWxsIGFzIHRoZSB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlIG5nQW5pbWF0ZSAkYW5pbWF0ZSBzZXJ2aWNlCiAgICAgKiBwYWdlfS4KICAgICAgICovCiAgICAgIHJldHVybiB7CgogICAgICAgIC8qKgogICAgICAgICAqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI2VudGVyCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKiBAZGVzY3JpcHRpb24gSW5zZXJ0cyB0aGUgZWxlbWVudCBpbnRvIHRoZSBET00gZWl0aGVyIGFmdGVyIHRoZSBgYWZ0ZXJgIGVsZW1lbnQgb3Igd2l0aGluCiAgICAgICAgICogICB0aGUgYHBhcmVudGAgZWxlbWVudC4gT25jZSBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgYmUgaW5zZXJ0ZWQgaW50byB0aGUgRE9NCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBwYXJlbnQgdGhlIHBhcmVudCBlbGVtZW50IHdoaWNoIHdpbGwgYXBwZW5kIHRoZSBlbGVtZW50IGFzCiAgICAgICAgICogICBhIGNoaWxkIChpZiB0aGUgYWZ0ZXIgZWxlbWVudCBpcyBub3QgcHJlc2VudCkKICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGFmdGVyIHRoZSBzaWJsaW5nIGVsZW1lbnQgd2hpY2ggd2lsbCBhcHBlbmQgdGhlIGVsZW1lbnQKICAgICAgICAgKiAgIGFmdGVyIGl0c2VsZgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb249fSBkb25lIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgdGhlIGVsZW1lbnQgaGFzIGJlZW4KICAgICAgICAgKiAgIGluc2VydGVkIGludG8gdGhlIERPTQogICAgICAgICAqLwogICAgICAgIGVudGVyIDogZnVuY3Rpb24oZWxlbWVudCwgcGFyZW50LCBhZnRlciwgZG9uZSkgewogICAgICAgICAgaWYgKGFmdGVyKSB7CiAgICAgICAgICAgIGFmdGVyLmFmdGVyKGVsZW1lbnQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKCFwYXJlbnQgfHwgIXBhcmVudFswXSkgewogICAgICAgICAgICAgIHBhcmVudCA9IGFmdGVyLnBhcmVudCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudC5hcHBlbmQoZWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICBhc3luYyhkb25lKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNsZWF2ZQogICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICogQGRlc2NyaXB0aW9uIFJlbW92ZXMgdGhlIGVsZW1lbnQgZnJvbSB0aGUgRE9NLiBPbmNlIGNvbXBsZXRlLCB0aGUgZG9uZSgpIGNhbGxiYWNrIHdpbGwgYmUKICAgICAgICAgKiAgIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIHRoZSBET00KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZG9uZSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIGFmdGVyIHRoZSBlbGVtZW50IGhhcyBiZWVuCiAgICAgICAgICogICByZW1vdmVkIGZyb20gdGhlIERPTQogICAgICAgICAqLwogICAgICAgIGxlYXZlIDogZnVuY3Rpb24oZWxlbWVudCwgZG9uZSkgewogICAgICAgICAgZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgIGFzeW5jKGRvbmUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI21vdmUKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqIEBkZXNjcmlwdGlvbiBNb3ZlcyB0aGUgcG9zaXRpb24gb2YgdGhlIHByb3ZpZGVkIGVsZW1lbnQgd2l0aGluIHRoZSBET00gdG8gYmUgcGxhY2VkCiAgICAgICAgICogZWl0aGVyIGFmdGVyIHRoZSBgYWZ0ZXJgIGVsZW1lbnQgb3IgaW5zaWRlIG9mIHRoZSBgcGFyZW50YCBlbGVtZW50LiBPbmNlIGNvbXBsZXRlLCB0aGUKICAgICAgICAgKiBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgYmUgbW92ZWQgYXJvdW5kIHdpdGhpbiB0aGUKICAgICAgICAgKiAgIERPTQogICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gcGFyZW50IHRoZSBwYXJlbnQgZWxlbWVudCB3aGVyZSB0aGUgZWxlbWVudCB3aWxsIGJlCiAgICAgICAgICogICBpbnNlcnRlZCBpbnRvIChpZiB0aGUgYWZ0ZXIgZWxlbWVudCBpcyBub3QgcHJlc2VudCkKICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGFmdGVyIHRoZSBzaWJsaW5nIGVsZW1lbnQgd2hlcmUgdGhlIGVsZW1lbnQgd2lsbCBiZQogICAgICAgICAqICAgcG9zaXRpb25lZCBuZXh0IHRvCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbj19IGRvbmUgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIChpZiBwcm92aWRlZCkgdGhhdCB3aWxsIGJlIGZpcmVkIGFmdGVyIHRoZQogICAgICAgICAqICAgZWxlbWVudCBoYXMgYmVlbiBtb3ZlZCB0byBpdHMgbmV3IHBvc2l0aW9uCiAgICAgICAgICovCiAgICAgICAgbW92ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIHBhcmVudCwgYWZ0ZXIsIGRvbmUpIHsKICAgICAgICAgIC8vIERvIG5vdCByZW1vdmUgZWxlbWVudCBiZWZvcmUgaW5zZXJ0LiBSZW1vdmluZyB3aWxsIGNhdXNlIGRhdGEgYXNzb2NpYXRlZCB3aXRoIHRoZQogICAgICAgICAgLy8gZWxlbWVudCB0byBiZSBkcm9wcGVkLiBJbnNlcnQgd2lsbCBpbXBsaWNpdGx5IGRvIHRoZSByZW1vdmUuCiAgICAgICAgICB0aGlzLmVudGVyKGVsZW1lbnQsIHBhcmVudCwgYWZ0ZXIsIGRvbmUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI2FkZENsYXNzCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKiBAZGVzY3JpcHRpb24gQWRkcyB0aGUgcHJvdmlkZWQgY2xhc3NOYW1lIENTUyBjbGFzcyB2YWx1ZSB0byB0aGUgcHJvdmlkZWQgZWxlbWVudC4gT25jZQogICAgICAgICAqIGNvbXBsZXRlLCB0aGUgZG9uZSgpIGNhbGxiYWNrIHdpbGwgYmUgZmlyZWQgKGlmIHByb3ZpZGVkKS4KICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBoYXZlIHRoZSBjbGFzc05hbWUgdmFsdWUKICAgICAgICAgKiAgIGFkZGVkIHRvIGl0CiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzTmFtZSB0aGUgQ1NTIGNsYXNzIHdoaWNoIHdpbGwgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZG9uZSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gKGlmIHByb3ZpZGVkKSB0aGF0IHdpbGwgYmUgZmlyZWQgYWZ0ZXIgdGhlCiAgICAgICAgICogICBjbGFzc05hbWUgdmFsdWUgaGFzIGJlZW4gYWRkZWQgdG8gdGhlIGVsZW1lbnQKICAgICAgICAgKi8KICAgICAgICBhZGRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZSkgewogICAgICAgICAgY2xhc3NOYW1lID0gaXNTdHJpbmcoY2xhc3NOYW1lKSA/CiAgICAgICAgICAgIGNsYXNzTmFtZSA6CiAgICAgICAgICAgIGlzQXJyYXkoY2xhc3NOYW1lKSA/IGNsYXNzTmFtZS5qb2luKCcgJykgOiAnJzsKICAgICAgICAgIGZvckVhY2goZWxlbWVudCwgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgICAganFMaXRlQWRkQ2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgIH0pOwogICAgICAgICAgYXN5bmMoZG9uZSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICoKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjcmVtb3ZlQ2xhc3MKICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAqIEBkZXNjcmlwdGlvbiBSZW1vdmVzIHRoZSBwcm92aWRlZCBjbGFzc05hbWUgQ1NTIGNsYXNzIHZhbHVlIGZyb20gdGhlIHByb3ZpZGVkIGVsZW1lbnQuCiAgICAgICAgICogT25jZSBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgaGF2ZSB0aGUgY2xhc3NOYW1lIHZhbHVlCiAgICAgICAgICogICByZW1vdmVkIGZyb20gaXQKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lIHRoZSBDU1MgY2xhc3Mgd2hpY2ggd2lsbCBiZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZG9uZSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gKGlmIHByb3ZpZGVkKSB0aGF0IHdpbGwgYmUgZmlyZWQgYWZ0ZXIgdGhlCiAgICAgICAgICogICBjbGFzc05hbWUgdmFsdWUgaGFzIGJlZW4gcmVtb3ZlZCBmcm9tIHRoZSBlbGVtZW50CiAgICAgICAgICovCiAgICAgICAgcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGRvbmUpIHsKICAgICAgICAgIGNsYXNzTmFtZSA9IGlzU3RyaW5nKGNsYXNzTmFtZSkgPwogICAgICAgICAgICBjbGFzc05hbWUgOgogICAgICAgICAgICBpc0FycmF5KGNsYXNzTmFtZSkgPyBjbGFzc05hbWUuam9pbignICcpIDogJyc7CiAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIGpxTGl0ZVJlbW92ZUNsYXNzKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGFzeW5jKGRvbmUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRhbmltYXRlI3NldENsYXNzCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKiBAZGVzY3JpcHRpb24gQWRkcyBhbmQvb3IgcmVtb3ZlcyB0aGUgZ2l2ZW4gQ1NTIGNsYXNzZXMgdG8gYW5kIGZyb20gdGhlIGVsZW1lbnQuCiAgICAgICAgICogT25jZSBjb21wbGV0ZSwgdGhlIGRvbmUoKSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkIChpZiBwcm92aWRlZCkuCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgaGF2ZSBpdHMgQ1NTIGNsYXNzZXMgY2hhbmdlZAogICAgICAgICAqICAgcmVtb3ZlZCBmcm9tIGl0CiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGFkZCB0aGUgQ1NTIGNsYXNzZXMgd2hpY2ggd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdmUgdGhlIENTUyBjbGFzcyB3aGljaCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb249fSBkb25lIHRoZSBjYWxsYmFjayBmdW5jdGlvbiAoaWYgcHJvdmlkZWQpIHRoYXQgd2lsbCBiZSBmaXJlZCBhZnRlciB0aGUKICAgICAgICAgKiAgIENTUyBjbGFzc2VzIGhhdmUgYmVlbiBzZXQgb24gdGhlIGVsZW1lbnQKICAgICAgICAgKi8KICAgICAgICBzZXRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGFkZCwgcmVtb3ZlLCBkb25lKSB7CiAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICAgIGpxTGl0ZUFkZENsYXNzKGVsZW1lbnQsIGFkZCk7CiAgICAgICAgICAgIGpxTGl0ZVJlbW92ZUNsYXNzKGVsZW1lbnQsIHJlbW92ZSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIGFzeW5jKGRvbmUpOwogICAgICAgIH0sCgogICAgICAgIGVuYWJsZWQgOiBub29wCiAgICAgIH07CiAgICB9XTsKICB9XTsKCiAgZnVuY3Rpb24gJCRBc3luY0NhbGxiYWNrUHJvdmlkZXIoKXsKICAgIHRoaXMuJGdldCA9IFsnJCRyQUYnLCAnJHRpbWVvdXQnLCBmdW5jdGlvbigkJHJBRiwgJHRpbWVvdXQpIHsKICAgICAgcmV0dXJuICQkckFGLnN1cHBvcnRlZAogICAgICAgID8gZnVuY3Rpb24oZm4pIHsgcmV0dXJuICQkckFGKGZuKTsgfQogICAgICAgIDogZnVuY3Rpb24oZm4pIHsKICAgICAgICByZXR1cm4gJHRpbWVvdXQoZm4sIDAsIGZhbHNlKTsKICAgICAgfTsKICAgIH1dOwogIH0KCiAgLyoqCiAgICogISBUaGlzIGlzIGEgcHJpdmF0ZSB1bmRvY3VtZW50ZWQgc2VydmljZSAhCiAgICoKICAgKiBAbmFtZSAkYnJvd3NlcgogICAqIEByZXF1aXJlcyAkbG9nCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBvYmplY3QgaGFzIHR3byBnb2FsczoKICAgKgogICAqIC0gaGlkZSBhbGwgdGhlIGdsb2JhbCBzdGF0ZSBpbiB0aGUgYnJvd3NlciBjYXVzZWQgYnkgdGhlIHdpbmRvdyBvYmplY3QKICAgKiAtIGFic3RyYWN0IGF3YXkgYWxsIHRoZSBicm93c2VyIHNwZWNpZmljIGZlYXR1cmVzIGFuZCBpbmNvbnNpc3RlbmNpZXMKICAgKgogICAqIEZvciB0ZXN0cyB3ZSBwcm92aWRlIHtAbGluayBuZ01vY2suJGJyb3dzZXIgbW9jayBpbXBsZW1lbnRhdGlvbn0gb2YgdGhlIGAkYnJvd3NlcmAKICAgKiBzZXJ2aWNlLCB3aGljaCBjYW4gYmUgdXNlZCBmb3IgY29udmVuaWVudCB0ZXN0aW5nIG9mIHRoZSBhcHBsaWNhdGlvbiB3aXRob3V0IHRoZSBpbnRlcmFjdGlvbiB3aXRoCiAgICogdGhlIHJlYWwgYnJvd3NlciBhcGlzLgogICAqLwogIC8qKgogICAqIEBwYXJhbSB7b2JqZWN0fSB3aW5kb3cgVGhlIGdsb2JhbCB3aW5kb3cgb2JqZWN0LgogICAqIEBwYXJhbSB7b2JqZWN0fSBkb2N1bWVudCBqUXVlcnkgd3JhcHBlZCBkb2N1bWVudC4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IFhIUiBYTUxIdHRwUmVxdWVzdCBjb25zdHJ1Y3Rvci4KICAgKiBAcGFyYW0ge29iamVjdH0gJGxvZyBjb25zb2xlLmxvZyBvciBhbiBvYmplY3Qgd2l0aCB0aGUgc2FtZSBpbnRlcmZhY2UuCiAgICogQHBhcmFtIHtvYmplY3R9ICRzbmlmZmVyICRzbmlmZmVyIHNlcnZpY2UKICAgKi8KICBmdW5jdGlvbiBCcm93c2VyKHdpbmRvdywgZG9jdW1lbnQsICRsb2csICRzbmlmZmVyKSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgIHJhd0RvY3VtZW50ID0gZG9jdW1lbnRbMF0sCiAgICAgIGxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uLAogICAgICBoaXN0b3J5ID0gd2luZG93Lmhpc3RvcnksCiAgICAgIHNldFRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCwKICAgICAgY2xlYXJUaW1lb3V0ID0gd2luZG93LmNsZWFyVGltZW91dCwKICAgICAgcGVuZGluZ0RlZmVySWRzID0ge307CgogICAgc2VsZi5pc01vY2sgPSBmYWxzZTsKCiAgICB2YXIgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPSAwOwogICAgdmFyIG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcyA9IFtdOwoKICAgIC8vIFRPRE8odm9qdGEpOiByZW1vdmUgdGhpcyB0ZW1wb3JhcnkgYXBpCiAgICBzZWxmLiQkY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QgPSBjb21wbGV0ZU91dHN0YW5kaW5nUmVxdWVzdDsKICAgIHNlbGYuJCRpbmNPdXRzdGFuZGluZ1JlcXVlc3RDb3VudCA9IGZ1bmN0aW9uKCkgeyBvdXRzdGFuZGluZ1JlcXVlc3RDb3VudCsrOyB9OwoKICAgIC8qKgogICAgICogRXhlY3V0ZXMgdGhlIGBmbmAgZnVuY3Rpb24oc3VwcG9ydHMgY3VycnlpbmcpIGFuZCBkZWNyZW1lbnRzIHRoZSBgb3V0c3RhbmRpbmdSZXF1ZXN0Q2FsbGJhY2tzYAogICAgICogY291bnRlci4gSWYgdGhlIGNvdW50ZXIgcmVhY2hlcyAwLCBhbGwgdGhlIGBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3NgIGFyZSBleGVjdXRlZC4KICAgICAqLwogICAgZnVuY3Rpb24gY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3QoZm4pIHsKICAgICAgdHJ5IHsKICAgICAgICBmbi5hcHBseShudWxsLCBzbGljZUFyZ3MoYXJndW1lbnRzLCAxKSk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgb3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQtLTsKICAgICAgICBpZiAob3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQgPT09IDApIHsKICAgICAgICAgIHdoaWxlKG91dHN0YW5kaW5nUmVxdWVzdENhbGxiYWNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucG9wKCkoKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICRsb2cuZXJyb3IoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEBwcml2YXRlCiAgICAgKiBOb3RlOiB0aGlzIG1ldGhvZCBpcyB1c2VkIG9ubHkgYnkgc2NlbmFyaW8gcnVubmVyCiAgICAgKiBUT0RPKHZvanRhKTogcHJlZml4IHRoaXMgbWV0aG9kIHdpdGggJCQgPwogICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBjYWxsYmFjayBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIHdoZW4gbm8gb3V0c3RhbmRpbmcgcmVxdWVzdAogICAgICovCiAgICBzZWxmLm5vdGlmeVdoZW5Ob091dHN0YW5kaW5nUmVxdWVzdHMgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAvLyBmb3JjZSBicm93c2VyIHRvIGV4ZWN1dGUgYWxsIHBvbGxGbnMgLSB0aGlzIGlzIG5lZWRlZCBzbyB0aGF0IGNvb2tpZXMgYW5kIG90aGVyIHBvbGxlcnMgZmlyZQogICAgICAvLyBhdCBzb21lIGRldGVybWluaXN0aWMgdGltZSBpbiByZXNwZWN0IHRvIHRoZSB0ZXN0IHJ1bm5lcidzIGFjdGlvbnMuIExlYXZpbmcgdGhpbmdzIHVwIHRvIHRoZQogICAgICAvLyByZWd1bGFyIHBvbGxlciB3b3VsZCByZXN1bHQgaW4gZmxha3kgdGVzdHMuCiAgICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24ocG9sbEZuKXsgcG9sbEZuKCk7IH0pOwoKICAgICAgaWYgKG91dHN0YW5kaW5nUmVxdWVzdENvdW50ID09PSAwKSB7CiAgICAgICAgY2FsbGJhY2soKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvdXRzdGFuZGluZ1JlcXVlc3RDYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgICAgIH0KICAgIH07CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vIFBvbGwgV2F0Y2hlciBBUEkKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICB2YXIgcG9sbEZucyA9IFtdLAogICAgICBwb2xsVGltZW91dDsKCiAgICAvKioKICAgICAqIEBuYW1lICRicm93c2VyI2FkZFBvbGxGbgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gUG9sbCBmdW5jdGlvbiB0byBhZGQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEFkZHMgYSBmdW5jdGlvbiB0byB0aGUgbGlzdCBvZiBmdW5jdGlvbnMgdGhhdCBwb2xsZXIgcGVyaW9kaWNhbGx5IGV4ZWN1dGVzLAogICAgICogYW5kIHN0YXJ0cyBwb2xsaW5nIGlmIG5vdCBzdGFydGVkIHlldC4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gdGhlIGFkZGVkIGZ1bmN0aW9uCiAgICAgKi8KICAgIHNlbGYuYWRkUG9sbEZuID0gZnVuY3Rpb24oZm4pIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKHBvbGxUaW1lb3V0KSkgc3RhcnRQb2xsZXIoMTAwLCBzZXRUaW1lb3V0KTsKICAgICAgcG9sbEZucy5wdXNoKGZuKTsKICAgICAgcmV0dXJuIGZuOwogICAgfTsKCiAgICAvKioKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbnRlcnZhbCBIb3cgb2Z0ZW4gc2hvdWxkIGJyb3dzZXIgY2FsbCBwb2xsIGZ1bmN0aW9ucyAobXMpCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IHNldFRpbWVvdXQgUmVmZXJlbmNlIHRvIGEgcmVhbCBvciBmYWtlIGBzZXRUaW1lb3V0YCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENvbmZpZ3VyZXMgdGhlIHBvbGxlciB0byBydW4gaW4gdGhlIHNwZWNpZmllZCBpbnRlcnZhbHMsIHVzaW5nIHRoZSBzcGVjaWZpZWQKICAgICAqIHNldFRpbWVvdXQgZm4gYW5kIGtpY2tzIGl0IG9mZi4KICAgICAqLwogICAgZnVuY3Rpb24gc3RhcnRQb2xsZXIoaW50ZXJ2YWwsIHNldFRpbWVvdXQpIHsKICAgICAgKGZ1bmN0aW9uIGNoZWNrKCkgewogICAgICAgIGZvckVhY2gocG9sbEZucywgZnVuY3Rpb24ocG9sbEZuKXsgcG9sbEZuKCk7IH0pOwogICAgICAgIHBvbGxUaW1lb3V0ID0gc2V0VGltZW91dChjaGVjaywgaW50ZXJ2YWwpOwogICAgICB9KSgpOwogICAgfQoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBVUkwgQVBJCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICAgIHZhciBsYXN0QnJvd3NlclVybCA9IGxvY2F0aW9uLmhyZWYsCiAgICAgIGJhc2VFbGVtZW50ID0gZG9jdW1lbnQuZmluZCgnYmFzZScpLAogICAgICBuZXdMb2NhdGlvbiA9IG51bGw7CgogICAgLyoqCiAgICAgKiBAbmFtZSAkYnJvd3NlciN1cmwKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEdFVFRFUjoKICAgICAqIFdpdGhvdXQgYW55IGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBqdXN0IHJldHVybnMgY3VycmVudCB2YWx1ZSBvZiBsb2NhdGlvbi5ocmVmLgogICAgICoKICAgICAqIFNFVFRFUjoKICAgICAqIFdpdGggYXQgbGVhc3Qgb25lIGFyZ3VtZW50LCB0aGlzIG1ldGhvZCBzZXRzIHVybCB0byBuZXcgdmFsdWUuCiAgICAgKiBJZiBodG1sNSBoaXN0b3J5IGFwaSBzdXBwb3J0ZWQsIHB1c2hTdGF0ZS9yZXBsYWNlU3RhdGUgaXMgdXNlZCwgb3RoZXJ3aXNlCiAgICAgKiBsb2NhdGlvbi5ocmVmL2xvY2F0aW9uLnJlcGxhY2UgaXMgdXNlZC4KICAgICAqIFJldHVybnMgaXRzIG93biBpbnN0YW5jZSB0byBhbGxvdyBjaGFpbmluZwogICAgICoKICAgICAqIE5PVEU6IHRoaXMgYXBpIGlzIGludGVuZGVkIGZvciB1c2Ugb25seSBieSB0aGUgJGxvY2F0aW9uIHNlcnZpY2UuIFBsZWFzZSB1c2UgdGhlCiAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uICRsb2NhdGlvbiBzZXJ2aWNlfSB0byBjaGFuZ2UgdXJsLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgTmV3IHVybCAod2hlbiB1c2VkIGFzIHNldHRlcikKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHJlcGxhY2UgU2hvdWxkIG5ldyB1cmwgcmVwbGFjZSBjdXJyZW50IGhpc3RvcnkgcmVjb3JkID8KICAgICAqLwogICAgc2VsZi51cmwgPSBmdW5jdGlvbih1cmwsIHJlcGxhY2UpIHsKICAgICAgLy8gQW5kcm9pZCBCcm93c2VyIEJGQ2FjaGUgY2F1c2VzIGxvY2F0aW9uLCBoaXN0b3J5IHJlZmVyZW5jZSB0byBiZWNvbWUgc3RhbGUuCiAgICAgIGlmIChsb2NhdGlvbiAhPT0gd2luZG93LmxvY2F0aW9uKSBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKICAgICAgaWYgKGhpc3RvcnkgIT09IHdpbmRvdy5oaXN0b3J5KSBoaXN0b3J5ID0gd2luZG93Lmhpc3Rvcnk7CgogICAgICAvLyBzZXR0ZXIKICAgICAgaWYgKHVybCkgewogICAgICAgIGlmIChsYXN0QnJvd3NlclVybCA9PSB1cmwpIHJldHVybjsKICAgICAgICBsYXN0QnJvd3NlclVybCA9IHVybDsKICAgICAgICBpZiAoJHNuaWZmZXIuaGlzdG9yeSkgewogICAgICAgICAgaWYgKHJlcGxhY2UpIGhpc3RvcnkucmVwbGFjZVN0YXRlKG51bGwsICcnLCB1cmwpOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGhpc3RvcnkucHVzaFN0YXRlKG51bGwsICcnLCB1cmwpOwogICAgICAgICAgICAvLyBDcmF6eSBPcGVyYSBCdWc6IGh0dHA6Ly9teS5vcGVyYS5jb20vY29tbXVuaXR5L2ZvcnVtcy90b3BpYy5kbWw/aWQ9MTE4NTQ2MgogICAgICAgICAgICBiYXNlRWxlbWVudC5hdHRyKCdocmVmJywgYmFzZUVsZW1lbnQuYXR0cignaHJlZicpKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgbmV3TG9jYXRpb24gPSB1cmw7CiAgICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKHVybCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsb2NhdGlvbi5ocmVmID0gdXJsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICAvLyBnZXR0ZXIKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyAtIG5ld0xvY2F0aW9uIGlzIGEgd29ya2Fyb3VuZCBmb3IgYW4gSUU3LTkgaXNzdWUgd2l0aCBsb2NhdGlvbi5yZXBsYWNlIGFuZCBsb2NhdGlvbi5ocmVmCiAgICAgICAgLy8gICBtZXRob2RzIG5vdCB1cGRhdGluZyBsb2NhdGlvbi5ocmVmIHN5bmNocm9ub3VzbHkuCiAgICAgICAgLy8gLSB0aGUgcmVwbGFjZW1lbnQgaXMgYSB3b3JrYXJvdW5kIGZvciBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD00MDcxNzIKICAgICAgICByZXR1cm4gbmV3TG9jYXRpb24gfHwgbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8lMjcvZywiJyIpOwogICAgICB9CiAgICB9OwoKICAgIHZhciB1cmxDaGFuZ2VMaXN0ZW5lcnMgPSBbXSwKICAgICAgdXJsQ2hhbmdlSW5pdCA9IGZhbHNlOwoKICAgIGZ1bmN0aW9uIGZpcmVVcmxDaGFuZ2UoKSB7CiAgICAgIG5ld0xvY2F0aW9uID0gbnVsbDsKICAgICAgaWYgKGxhc3RCcm93c2VyVXJsID09IHNlbGYudXJsKCkpIHJldHVybjsKCiAgICAgIGxhc3RCcm93c2VyVXJsID0gc2VsZi51cmwoKTsKICAgICAgZm9yRWFjaCh1cmxDaGFuZ2VMaXN0ZW5lcnMsIGZ1bmN0aW9uKGxpc3RlbmVyKSB7CiAgICAgICAgbGlzdGVuZXIoc2VsZi51cmwoKSk7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogQG5hbWUgJGJyb3dzZXIjb25VcmxDaGFuZ2UKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJlZ2lzdGVyIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQsIHdoZW4gdXJsIGNoYW5nZXMuCiAgICAgKgogICAgICogSXQncyBvbmx5IGNhbGxlZCB3aGVuIHRoZSB1cmwgaXMgY2hhbmdlZCBmcm9tIG91dHNpZGUgb2YgYW5ndWxhcjoKICAgICAqIC0gdXNlciB0eXBlcyBkaWZmZXJlbnQgdXJsIGludG8gYWRkcmVzcyBiYXIKICAgICAqIC0gdXNlciBjbGlja3Mgb24gaGlzdG9yeSAoZm9yd2FyZC9iYWNrKSBidXR0b24KICAgICAqIC0gdXNlciBjbGlja3Mgb24gYSBsaW5rCiAgICAgKgogICAgICogSXQncyBub3QgY2FsbGVkIHdoZW4gdXJsIGlzIGNoYW5nZWQgYnkgJGJyb3dzZXIudXJsKCkgbWV0aG9kCiAgICAgKgogICAgICogVGhlIGxpc3RlbmVyIGdldHMgY2FsbGVkIHdpdGggbmV3IHVybCBhcyBwYXJhbWV0ZXIuCiAgICAgKgogICAgICogTk9URTogdGhpcyBhcGkgaXMgaW50ZW5kZWQgZm9yIHVzZSBvbmx5IGJ5IHRoZSAkbG9jYXRpb24gc2VydmljZS4gUGxlYXNlIHVzZSB0aGUKICAgICAqIHtAbGluayBuZy4kbG9jYXRpb24gJGxvY2F0aW9uIHNlcnZpY2V9IHRvIG1vbml0b3IgdXJsIGNoYW5nZXMgaW4gYW5ndWxhciBhcHBzLgogICAgICoKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nKX0gbGlzdGVuZXIgTGlzdGVuZXIgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdXJsIGNoYW5nZXMuCiAgICAgKiBAcmV0dXJuIHtmdW5jdGlvbihzdHJpbmcpfSBSZXR1cm5zIHRoZSByZWdpc3RlcmVkIGxpc3RlbmVyIGZuIC0gaGFuZHkgaWYgdGhlIGZuIGlzIGFub255bW91cy4KICAgICAqLwogICAgc2VsZi5vblVybENoYW5nZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIC8vIFRPRE8odm9qdGEpOiByZWZhY3RvciB0byB1c2Ugbm9kZSdzIHN5bnRheCBmb3IgZXZlbnRzCiAgICAgIGlmICghdXJsQ2hhbmdlSW5pdCkgewogICAgICAgIC8vIFdlIGxpc3RlbiBvbiBib3RoIChoYXNoY2hhbmdlL3BvcHN0YXRlKSB3aGVuIGF2YWlsYWJsZSwgYXMgc29tZSBicm93c2VycyAoZS5nLiBPcGVyYSkKICAgICAgICAvLyBkb24ndCBmaXJlIHBvcHN0YXRlIHdoZW4gdXNlciBjaGFuZ2UgdGhlIGFkZHJlc3MgYmFyIGFuZCBkb24ndCBmaXJlIGhhc2hjaGFuZ2Ugd2hlbiB1cmwKICAgICAgICAvLyBjaGFuZ2VkIGJ5IHB1c2gvcmVwbGFjZVN0YXRlCgogICAgICAgIC8vIGh0bWw1IGhpc3RvcnkgYXBpIC0gcG9wc3RhdGUgZXZlbnQKICAgICAgICBpZiAoJHNuaWZmZXIuaGlzdG9yeSkganFMaXRlKHdpbmRvdykub24oJ3BvcHN0YXRlJywgZmlyZVVybENoYW5nZSk7CiAgICAgICAgLy8gaGFzaGNoYW5nZSBldmVudAogICAgICAgIGlmICgkc25pZmZlci5oYXNoY2hhbmdlKSBqcUxpdGUod2luZG93KS5vbignaGFzaGNoYW5nZScsIGZpcmVVcmxDaGFuZ2UpOwogICAgICAgIC8vIHBvbGxpbmcKICAgICAgICBlbHNlIHNlbGYuYWRkUG9sbEZuKGZpcmVVcmxDaGFuZ2UpOwoKICAgICAgICB1cmxDaGFuZ2VJbml0ID0gdHJ1ZTsKICAgICAgfQoKICAgICAgdXJsQ2hhbmdlTGlzdGVuZXJzLnB1c2goY2FsbGJhY2spOwogICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICB9OwoKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBNaXNjIEFQSQogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgICAvKioKICAgICAqIEBuYW1lICRicm93c2VyI2Jhc2VIcmVmCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXR1cm5zIGN1cnJlbnQgPGJhc2UgaHJlZj4KICAgICAqIChhbHdheXMgcmVsYXRpdmUgLSB3aXRob3V0IGRvbWFpbikKICAgICAqCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgY3VycmVudCBiYXNlIGhyZWYKICAgICAqLwogICAgc2VsZi5iYXNlSHJlZiA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaHJlZiA9IGJhc2VFbGVtZW50LmF0dHIoJ2hyZWYnKTsKICAgICAgcmV0dXJuIGhyZWYgPyBocmVmLnJlcGxhY2UoL14oaHR0cHM/XDopP1wvXC9bXlwvXSovLCAnJykgOiAnJzsKICAgIH07CgogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vIENvb2tpZXMgQVBJCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgdmFyIGxhc3RDb29raWVzID0ge307CiAgICB2YXIgbGFzdENvb2tpZVN0cmluZyA9ICcnOwogICAgdmFyIGNvb2tpZVBhdGggPSBzZWxmLmJhc2VIcmVmKCk7CgogICAgLyoqCiAgICAgKiBAbmFtZSAkYnJvd3NlciNjb29raWVzCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIENvb2tpZSBuYW1lCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIENvb2tpZSB2YWx1ZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGNvb2tpZXMgbWV0aG9kIHByb3ZpZGVzIGEgJ3ByaXZhdGUnIGxvdyBsZXZlbCBhY2Nlc3MgdG8gYnJvd3NlciBjb29raWVzLgogICAgICogSXQgaXMgbm90IG1lYW50IHRvIGJlIHVzZWQgZGlyZWN0bHksIHVzZSB0aGUgJGNvb2tpZSBzZXJ2aWNlIGluc3RlYWQuCiAgICAgKgogICAgICogVGhlIHJldHVybiB2YWx1ZXMgdmFyeSBkZXBlbmRpbmcgb24gdGhlIGFyZ3VtZW50cyB0aGF0IHRoZSBtZXRob2Qgd2FzIGNhbGxlZCB3aXRoIGFzIGZvbGxvd3M6CiAgICAgKgogICAgICogLSBjb29raWVzKCkgLT4gaGFzaCBvZiBhbGwgY29va2llcywgdGhpcyBpcyBOT1QgYSBjb3B5IG9mIHRoZSBpbnRlcm5hbCBzdGF0ZSwgc28gZG8gbm90IG1vZGlmeQogICAgICogICBpdAogICAgICogLSBjb29raWVzKG5hbWUsIHZhbHVlKSAtPiBzZXQgbmFtZSB0byB2YWx1ZSwgaWYgdmFsdWUgaXMgdW5kZWZpbmVkIGRlbGV0ZSB0aGUgY29va2llCiAgICAgKiAtIGNvb2tpZXMobmFtZSkgLT4gdGhlIHNhbWUgYXMgKG5hbWUsIHVuZGVmaW5lZCkgPT0gREVMRVRFUyAobm8gb25lIGNhbGxzIGl0IHJpZ2h0IG5vdyB0aGF0CiAgICAgKiAgIHdheSkKICAgICAqCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBIYXNoIG9mIGFsbCBjb29raWVzIChpZiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyKQogICAgICovCiAgICBzZWxmLmNvb2tpZXMgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAvKiBnbG9iYWwgZXNjYXBlOiBmYWxzZSwgdW5lc2NhcGU6IGZhbHNlICovCiAgICAgIHZhciBjb29raWVMZW5ndGgsIGNvb2tpZUFycmF5LCBjb29raWUsIGksIGluZGV4OwoKICAgICAgaWYgKG5hbWUpIHsKICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmF3RG9jdW1lbnQuY29va2llID0gZXNjYXBlKG5hbWUpICsgIj07cGF0aD0iICsgY29va2llUGF0aCArCiAgICAgICAgICAgICI7ZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVCI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgY29va2llTGVuZ3RoID0gKHJhd0RvY3VtZW50LmNvb2tpZSA9IGVzY2FwZShuYW1lKSArICc9JyArIGVzY2FwZSh2YWx1ZSkgKwogICAgICAgICAgICAgICc7cGF0aD0nICsgY29va2llUGF0aCkubGVuZ3RoICsgMTsKCiAgICAgICAgICAgIC8vIHBlciBodHRwOi8vd3d3LmlldGYub3JnL3JmYy9yZmMyMTA5LnR4dCBicm93c2VyIG11c3QgYWxsb3cgYXQgbWluaW11bToKICAgICAgICAgICAgLy8gLSAzMDAgY29va2llcwogICAgICAgICAgICAvLyAtIDIwIGNvb2tpZXMgcGVyIHVuaXF1ZSBkb21haW4KICAgICAgICAgICAgLy8gLSA0MDk2IGJ5dGVzIHBlciBjb29raWUKICAgICAgICAgICAgaWYgKGNvb2tpZUxlbmd0aCA+IDQwOTYpIHsKICAgICAgICAgICAgICAkbG9nLndhcm4oIkNvb2tpZSAnIisgbmFtZSArCiAgICAgICAgICAgICAgICAiJyBwb3NzaWJseSBub3Qgc2V0IG9yIG92ZXJmbG93ZWQgYmVjYXVzZSBpdCB3YXMgdG9vIGxhcmdlICgiKwogICAgICAgICAgICAgICAgY29va2llTGVuZ3RoICsgIiA+IDQwOTYgYnl0ZXMpISIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChyYXdEb2N1bWVudC5jb29raWUgIT09IGxhc3RDb29raWVTdHJpbmcpIHsKICAgICAgICAgIGxhc3RDb29raWVTdHJpbmcgPSByYXdEb2N1bWVudC5jb29raWU7CiAgICAgICAgICBjb29raWVBcnJheSA9IGxhc3RDb29raWVTdHJpbmcuc3BsaXQoIjsgIik7CiAgICAgICAgICBsYXN0Q29va2llcyA9IHt9OwoKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb29raWVBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb29raWUgPSBjb29raWVBcnJheVtpXTsKICAgICAgICAgICAgaW5kZXggPSBjb29raWUuaW5kZXhPZignPScpOwogICAgICAgICAgICBpZiAoaW5kZXggPiAwKSB7IC8vaWdub3JlIG5hbWVsZXNzIGNvb2tpZXMKICAgICAgICAgICAgICBuYW1lID0gdW5lc2NhcGUoY29va2llLnN1YnN0cmluZygwLCBpbmRleCkpOwogICAgICAgICAgICAgIC8vIHRoZSBmaXJzdCB2YWx1ZSB0aGF0IGlzIHNlZW4gZm9yIGEgY29va2llIGlzIHRoZSBtb3N0CiAgICAgICAgICAgICAgLy8gc3BlY2lmaWMgb25lLiAgdmFsdWVzIGZvciB0aGUgc2FtZSBjb29raWUgbmFtZSB0aGF0CiAgICAgICAgICAgICAgLy8gZm9sbG93IGFyZSBmb3IgbGVzcyBzcGVjaWZpYyBwYXRocy4KICAgICAgICAgICAgICBpZiAobGFzdENvb2tpZXNbbmFtZV0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgbGFzdENvb2tpZXNbbmFtZV0gPSB1bmVzY2FwZShjb29raWUuc3Vic3RyaW5nKGluZGV4ICsgMSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbGFzdENvb2tpZXM7CiAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogQG5hbWUgJGJyb3dzZXIjZGVmZXIKICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiwgd2hvJ3MgZXhlY3V0aW9uIHNob3VsZCBiZSBkZWZlcnJlZC4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gW2RlbGF5PTBdIG9mIG1pbGxpc2Vjb25kcyB0byBkZWZlciB0aGUgZnVuY3Rpb24gZXhlY3V0aW9uLgogICAgICogQHJldHVybnMgeyp9IERlZmVySWQgdGhhdCBjYW4gYmUgdXNlZCB0byBjYW5jZWwgdGhlIHRhc2sgdmlhIGAkYnJvd3Nlci5kZWZlci5jYW5jZWwoKWAuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFeGVjdXRlcyBhIGZuIGFzeW5jaHJvbm91c2x5IHZpYSBgc2V0VGltZW91dChmbiwgZGVsYXkpYC4KICAgICAqCiAgICAgKiBVbmxpa2Ugd2hlbiBjYWxsaW5nIGBzZXRUaW1lb3V0YCBkaXJlY3RseSwgaW4gdGVzdCB0aGlzIGZ1bmN0aW9uIGlzIG1vY2tlZCBhbmQgaW5zdGVhZCBvZiB1c2luZwogICAgICogYHNldFRpbWVvdXRgIGluIHRlc3RzLCB0aGUgZm5zIGFyZSBxdWV1ZWQgaW4gYW4gYXJyYXksIHdoaWNoIGNhbiBiZSBwcm9ncmFtbWF0aWNhbGx5IGZsdXNoZWQKICAgICAqIHZpYSBgJGJyb3dzZXIuZGVmZXIuZmx1c2goKWAuCiAgICAgKgogICAgICovCiAgICBzZWxmLmRlZmVyID0gZnVuY3Rpb24oZm4sIGRlbGF5KSB7CiAgICAgIHZhciB0aW1lb3V0SWQ7CiAgICAgIG91dHN0YW5kaW5nUmVxdWVzdENvdW50Kys7CiAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgZGVsZXRlIHBlbmRpbmdEZWZlcklkc1t0aW1lb3V0SWRdOwogICAgICAgIGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KGZuKTsKICAgICAgfSwgZGVsYXkgfHwgMCk7CiAgICAgIHBlbmRpbmdEZWZlcklkc1t0aW1lb3V0SWRdID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRpbWVvdXRJZDsKICAgIH07CgoKICAgIC8qKgogICAgICogQG5hbWUgJGJyb3dzZXIjZGVmZXIuY2FuY2VsCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDYW5jZWxzIGEgZGVmZXJyZWQgdGFzayBpZGVudGlmaWVkIHdpdGggYGRlZmVySWRgLgogICAgICoKICAgICAqIEBwYXJhbSB7Kn0gZGVmZXJJZCBUb2tlbiByZXR1cm5lZCBieSB0aGUgYCRicm93c2VyLmRlZmVyYCBmdW5jdGlvbi4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bGx5CiAgICAgKiAgICAgICAgICAgICAgICAgICAgY2FuY2VsZWQuCiAgICAgKi8KICAgIHNlbGYuZGVmZXIuY2FuY2VsID0gZnVuY3Rpb24oZGVmZXJJZCkgewogICAgICBpZiAocGVuZGluZ0RlZmVySWRzW2RlZmVySWRdKSB7CiAgICAgICAgZGVsZXRlIHBlbmRpbmdEZWZlcklkc1tkZWZlcklkXTsKICAgICAgICBjbGVhclRpbWVvdXQoZGVmZXJJZCk7CiAgICAgICAgY29tcGxldGVPdXRzdGFuZGluZ1JlcXVlc3Qobm9vcCk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfTsKCiAgfQoKICBmdW5jdGlvbiAkQnJvd3NlclByb3ZpZGVyKCl7CiAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCAnJGxvZycsICckc25pZmZlcicsICckZG9jdW1lbnQnLAogICAgICBmdW5jdGlvbiggJHdpbmRvdywgICAkbG9nLCAgICRzbmlmZmVyLCAgICRkb2N1bWVudCl7CiAgICAgICAgcmV0dXJuIG5ldyBCcm93c2VyKCR3aW5kb3csICRkb2N1bWVudCwgJGxvZywgJHNuaWZmZXIpOwogICAgICB9XTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGNhY2hlRmFjdG9yeQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRmFjdG9yeSB0aGF0IGNvbnN0cnVjdHMge0BsaW5rICRjYWNoZUZhY3RvcnkuQ2FjaGUgQ2FjaGV9IG9iamVjdHMgYW5kIGdpdmVzIGFjY2VzcyB0bwogICAqIHRoZW0uCiAgICoKICAgKiBgYGBqcwogICAqCiAgICogIHZhciBjYWNoZSA9ICRjYWNoZUZhY3RvcnkoJ2NhY2hlSWQnKTsKICAgKiAgZXhwZWN0KCRjYWNoZUZhY3RvcnkuZ2V0KCdjYWNoZUlkJykpLnRvQmUoY2FjaGUpOwogICAqICBleHBlY3QoJGNhY2hlRmFjdG9yeS5nZXQoJ25vU3VjaENhY2hlSWQnKSkubm90LnRvQmVEZWZpbmVkKCk7CiAgICoKICAgKiAgY2FjaGUucHV0KCJrZXkiLCAidmFsdWUiKTsKICAgKiAgY2FjaGUucHV0KCJhbm90aGVyIGtleSIsICJhbm90aGVyIHZhbHVlIik7CiAgICoKICAgKiAgLy8gV2UndmUgc3BlY2lmaWVkIG5vIG9wdGlvbnMgb24gY3JlYXRpb24KICAgKiAgZXhwZWN0KGNhY2hlLmluZm8oKSkudG9FcXVhbCh7aWQ6ICdjYWNoZUlkJywgc2l6ZTogMn0pOwogICAqCiAgICogYGBgCiAgICoKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZUlkIE5hbWUgb3IgaWQgb2YgdGhlIG5ld2x5IGNyZWF0ZWQgY2FjaGUuCiAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIE9wdGlvbnMgb2JqZWN0IHRoYXQgc3BlY2lmaWVzIHRoZSBjYWNoZSBiZWhhdmlvci4gUHJvcGVydGllczoKICAgKgogICAqICAgLSBge251bWJlcj19YCBgY2FwYWNpdHlgIOKAlCB0dXJucyB0aGUgY2FjaGUgaW50byBMUlUgY2FjaGUuCiAgICoKICAgKiBAcmV0dXJucyB7b2JqZWN0fSBOZXdseSBjcmVhdGVkIGNhY2hlIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcgc2V0IG9mIG1ldGhvZHM6CiAgICoKICAgKiAtIGB7b2JqZWN0fWAgYGluZm8oKWAg4oCUIFJldHVybnMgaWQsIHNpemUsIGFuZCBvcHRpb25zIG9mIGNhY2hlLgogICAqIC0gYHt7Kn19YCBgcHV0KHtzdHJpbmd9IGtleSwgeyp9IHZhbHVlKWAg4oCUIFB1dHMgYSBuZXcga2V5LXZhbHVlIHBhaXIgaW50byB0aGUgY2FjaGUgYW5kIHJldHVybnMKICAgKiAgIGl0LgogICAqIC0gYHt7Kn19YCBgZ2V0KHtzdHJpbmd9IGtleSlgIOKAlCBSZXR1cm5zIGNhY2hlZCB2YWx1ZSBmb3IgYGtleWAgb3IgdW5kZWZpbmVkIGZvciBjYWNoZSBtaXNzLgogICAqIC0gYHt2b2lkfWAgYHJlbW92ZSh7c3RyaW5nfSBrZXkpYCDigJQgUmVtb3ZlcyBhIGtleS12YWx1ZSBwYWlyIGZyb20gdGhlIGNhY2hlLgogICAqIC0gYHt2b2lkfWAgYHJlbW92ZUFsbCgpYCDigJQgUmVtb3ZlcyBhbGwgY2FjaGVkIHZhbHVlcy4KICAgKiAtIGB7dm9pZH1gIGBkZXN0cm95KClgIOKAlCBSZW1vdmVzIHJlZmVyZW5jZXMgdG8gdGhpcyBjYWNoZSBmcm9tICRjYWNoZUZhY3RvcnkuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9ImNhY2hlRXhhbXBsZUFwcCI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkNhY2hlQ29udHJvbGxlciI+CiAgIDxpbnB1dCBuZy1tb2RlbD0ibmV3Q2FjaGVLZXkiIHBsYWNlaG9sZGVyPSJLZXkiPgogICA8aW5wdXQgbmctbW9kZWw9Im5ld0NhY2hlVmFsdWUiIHBsYWNlaG9sZGVyPSJWYWx1ZSI+CiAgIDxidXR0b24gbmctY2xpY2s9InB1dChuZXdDYWNoZUtleSwgbmV3Q2FjaGVWYWx1ZSkiPkNhY2hlPC9idXR0b24+CgogICA8cCBuZy1pZj0ia2V5cy5sZW5ndGgiPkNhY2hlZCBWYWx1ZXM8L3A+CiAgIDxkaXYgbmctcmVwZWF0PSJrZXkgaW4ga2V5cyI+CiAgIDxzcGFuIG5nLWJpbmQ9ImtleSI+PC9zcGFuPgogICA8c3Bhbj46IDwvc3Bhbj4KICAgPGIgbmctYmluZD0iY2FjaGUuZ2V0KGtleSkiPjwvYj4KICAgPC9kaXY+CgogICA8cD5DYWNoZSBJbmZvPC9wPgogICA8ZGl2IG5nLXJlcGVhdD0iKGtleSwgdmFsdWUpIGluIGNhY2hlLmluZm8oKSI+CiAgIDxzcGFuIG5nLWJpbmQ9ImtleSI+PC9zcGFuPgogICA8c3Bhbj46IDwvc3Bhbj4KICAgPGIgbmctYmluZD0idmFsdWUiPjwvYj4KICAgPC9kaXY+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgIGFuZ3VsYXIubW9kdWxlKCdjYWNoZUV4YW1wbGVBcHAnLCBbXSkuCiAgIGNvbnRyb2xsZXIoJ0NhY2hlQ29udHJvbGxlcicsIFsnJHNjb3BlJywgJyRjYWNoZUZhY3RvcnknLCBmdW5jdGlvbigkc2NvcGUsICRjYWNoZUZhY3RvcnkpIHsKICAgICAgICAgICAkc2NvcGUua2V5cyA9IFtdOwogICAgICAgICAgICRzY29wZS5jYWNoZSA9ICRjYWNoZUZhY3RvcnkoJ2NhY2hlSWQnKTsKICAgICAgICAgICAkc2NvcGUucHV0ID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgJHNjb3BlLmNhY2hlLnB1dChrZXksIHZhbHVlKTsKICAgICAgICAgICAgICRzY29wZS5rZXlzLnB1c2goa2V5KTsKICAgICAgICAgICB9OwogICAgICAgICB9XSk7CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgcCB7CiAgICAgICAgIG1hcmdpbjogMTBweCAwIDNweDsKICAgICAgIH0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgZnVuY3Rpb24gJENhY2hlRmFjdG9yeVByb3ZpZGVyKCkgewoKICAgIHRoaXMuJGdldCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgY2FjaGVzID0ge307CgogICAgICBmdW5jdGlvbiBjYWNoZUZhY3RvcnkoY2FjaGVJZCwgb3B0aW9ucykgewogICAgICAgIGlmIChjYWNoZUlkIGluIGNhY2hlcykgewogICAgICAgICAgdGhyb3cgbWluRXJyKCckY2FjaGVGYWN0b3J5JykoJ2lpZCcsICJDYWNoZUlkICd7MH0nIGlzIGFscmVhZHkgdGFrZW4hIiwgY2FjaGVJZCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgc2l6ZSA9IDAsCiAgICAgICAgICBzdGF0cyA9IGV4dGVuZCh7fSwgb3B0aW9ucywge2lkOiBjYWNoZUlkfSksCiAgICAgICAgICBkYXRhID0ge30sCiAgICAgICAgICBjYXBhY2l0eSA9IChvcHRpb25zICYmIG9wdGlvbnMuY2FwYWNpdHkpIHx8IE51bWJlci5NQVhfVkFMVUUsCiAgICAgICAgICBscnVIYXNoID0ge30sCiAgICAgICAgICBmcmVzaEVuZCA9IG51bGwsCiAgICAgICAgICBzdGFsZUVuZCA9IG51bGw7CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyB0eXBlCiAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZQogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQSBjYWNoZSBvYmplY3QgdXNlZCB0byBzdG9yZSBhbmQgcmV0cmlldmUgZGF0YSwgcHJpbWFyaWx5IHVzZWQgYnkKICAgICAgICAgKiB7QGxpbmsgJGh0dHAgJGh0dHB9IGFuZCB0aGUge0BsaW5rIG5nLmRpcmVjdGl2ZTpzY3JpcHQgc2NyaXB0fSBkaXJlY3RpdmUgdG8gY2FjaGUKICAgICAgICAgKiB0ZW1wbGF0ZXMgYW5kIG90aGVyIGRhdGEuCiAgICAgICAgICoKICAgICAgICAgKiBgYGBqcwogICAgICAgICAqICBhbmd1bGFyLm1vZHVsZSgnc3VwZXJDYWNoZScpCiAgICAgICAgICogICAgLmZhY3RvcnkoJ3N1cGVyQ2FjaGUnLCBbJyRjYWNoZUZhY3RvcnknLCBmdW5jdGlvbigkY2FjaGVGYWN0b3J5KSB7CiAgICAgICAqICAgICAgcmV0dXJuICRjYWNoZUZhY3RvcnkoJ3N1cGVyLWNhY2hlJyk7CiAgICAgICAqICAgIH1dKTsKICAgICAgICAgKiBgYGAKICAgICAgICAgKgogICAgICAgICAqIEV4YW1wbGUgdGVzdDoKICAgICAgICAgKgogICAgICAgICAqIGBgYGpzCiAgICAgICAgICogIGl0KCdzaG91bGQgYmVoYXZlIGxpa2UgYSBjYWNoZScsIGluamVjdChmdW5jdGlvbihzdXBlckNhY2hlKSB7CiAgICAgICAqICAgIHN1cGVyQ2FjaGUucHV0KCdrZXknLCAndmFsdWUnKTsKICAgICAgICogICAgc3VwZXJDYWNoZS5wdXQoJ2Fub3RoZXIga2V5JywgJ2Fub3RoZXIgdmFsdWUnKTsKICAgICAgICoKICAgICAgICogICAgZXhwZWN0KHN1cGVyQ2FjaGUuaW5mbygpKS50b0VxdWFsKHsKICAgICAgICogICAgICBpZDogJ3N1cGVyLWNhY2hlJywKICAgICAgICogICAgICBzaXplOiAyCiAgICAgICAqICAgIH0pOwogICAgICAgKgogICAgICAgKiAgICBzdXBlckNhY2hlLnJlbW92ZSgnYW5vdGhlciBrZXknKTsKICAgICAgICogICAgZXhwZWN0KHN1cGVyQ2FjaGUuZ2V0KCdhbm90aGVyIGtleScpKS50b0JlVW5kZWZpbmVkKCk7CiAgICAgICAqCiAgICAgICAqICAgIHN1cGVyQ2FjaGUucmVtb3ZlQWxsKCk7CiAgICAgICAqICAgIGV4cGVjdChzdXBlckNhY2hlLmluZm8oKSkudG9FcXVhbCh7CiAgICAgICAqICAgICAgaWQ6ICdzdXBlci1jYWNoZScsCiAgICAgICAqICAgICAgc2l6ZTogMAogICAgICAgKiAgICB9KTsKICAgICAgICogIH0pKTsKICAgICAgICAgKiBgYGAKICAgICAgICAgKi8KICAgICAgICByZXR1cm4gY2FjaGVzW2NhY2hlSWRdID0gewoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNwdXQKICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBJbnNlcnRzIGEgbmFtZWQgZW50cnkgaW50byB0aGUge0BsaW5rICRjYWNoZUZhY3RvcnkuQ2FjaGUgQ2FjaGV9IG9iamVjdCB0byBiZQogICAgICAgICAgICogcmV0cmlldmVkIGxhdGVyLCBhbmQgaW5jcmVtZW50aW5nIHRoZSBzaXplIG9mIHRoZSBjYWNoZSBpZiB0aGUga2V5IHdhcyBub3QgYWxyZWFkeQogICAgICAgICAgICogcHJlc2VudCBpbiB0aGUgY2FjaGUuIElmIGJlaGF2aW5nIGxpa2UgYW4gTFJVIGNhY2hlLCBpdCB3aWxsIGFsc28gcmVtb3ZlIHN0YWxlCiAgICAgICAgICAgKiBlbnRyaWVzIGZyb20gdGhlIHNldC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBJdCB3aWxsIG5vdCBpbnNlcnQgdW5kZWZpbmVkIHZhbHVlcyBpbnRvIHRoZSBjYWNoZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IHRoZSBrZXkgdW5kZXIgd2hpY2ggdGhlIGNhY2hlZCBkYXRhIGlzIHN0b3JlZC4KICAgICAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgdGhlIHZhbHVlIHRvIHN0b3JlIGFsb25nc2lkZSB0aGUga2V5LiBJZiBpdCBpcyB1bmRlZmluZWQsIHRoZSBrZXkKICAgICAgICAgICAqICAgIHdpbGwgbm90IGJlIHN0b3JlZC4KICAgICAgICAgICAqIEByZXR1cm5zIHsqfSB0aGUgdmFsdWUgc3RvcmVkLgogICAgICAgICAgICovCiAgICAgICAgICBwdXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGNhcGFjaXR5IDwgTnVtYmVyLk1BWF9WQUxVRSkgewogICAgICAgICAgICAgIHZhciBscnVFbnRyeSA9IGxydUhhc2hba2V5XSB8fCAobHJ1SGFzaFtrZXldID0ge2tleToga2V5fSk7CgogICAgICAgICAgICAgIHJlZnJlc2gobHJ1RW50cnkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWUpKSByZXR1cm47CiAgICAgICAgICAgIGlmICghKGtleSBpbiBkYXRhKSkgc2l6ZSsrOwogICAgICAgICAgICBkYXRhW2tleV0gPSB2YWx1ZTsKCiAgICAgICAgICAgIGlmIChzaXplID4gY2FwYWNpdHkpIHsKICAgICAgICAgICAgICB0aGlzLnJlbW92ZShzdGFsZUVuZC5rZXkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9LAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGNhY2hlRmFjdG9yeS5DYWNoZSNnZXQKICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBSZXRyaWV2ZXMgbmFtZWQgZGF0YSBzdG9yZWQgaW4gdGhlIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfSBvYmplY3QuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSB0aGUga2V5IG9mIHRoZSBkYXRhIHRvIGJlIHJldHJpZXZlZAogICAgICAgICAgICogQHJldHVybnMgeyp9IHRoZSB2YWx1ZSBzdG9yZWQuCiAgICAgICAgICAgKi8KICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIGlmIChjYXBhY2l0eSA8IE51bWJlci5NQVhfVkFMVUUpIHsKICAgICAgICAgICAgICB2YXIgbHJ1RW50cnkgPSBscnVIYXNoW2tleV07CgogICAgICAgICAgICAgIGlmICghbHJ1RW50cnkpIHJldHVybjsKCiAgICAgICAgICAgICAgcmVmcmVzaChscnVFbnRyeSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBkYXRhW2tleV07CiAgICAgICAgICB9LAoKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkuQ2FjaGUjcmVtb3ZlCiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogUmVtb3ZlcyBhbiBlbnRyeSBmcm9tIHRoZSB7QGxpbmsgJGNhY2hlRmFjdG9yeS5DYWNoZSBDYWNoZX0gb2JqZWN0LgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgdGhlIGtleSBvZiB0aGUgZW50cnkgdG8gYmUgcmVtb3ZlZAogICAgICAgICAgICovCiAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICBpZiAoY2FwYWNpdHkgPCBOdW1iZXIuTUFYX1ZBTFVFKSB7CiAgICAgICAgICAgICAgdmFyIGxydUVudHJ5ID0gbHJ1SGFzaFtrZXldOwoKICAgICAgICAgICAgICBpZiAoIWxydUVudHJ5KSByZXR1cm47CgogICAgICAgICAgICAgIGlmIChscnVFbnRyeSA9PSBmcmVzaEVuZCkgZnJlc2hFbmQgPSBscnVFbnRyeS5wOwogICAgICAgICAgICAgIGlmIChscnVFbnRyeSA9PSBzdGFsZUVuZCkgc3RhbGVFbmQgPSBscnVFbnRyeS5uOwogICAgICAgICAgICAgIGxpbmsobHJ1RW50cnkubixscnVFbnRyeS5wKTsKCiAgICAgICAgICAgICAgZGVsZXRlIGxydUhhc2hba2V5XTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVsZXRlIGRhdGFba2V5XTsKICAgICAgICAgICAgc2l6ZS0tOwogICAgICAgICAgfSwKCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5LkNhY2hlI3JlbW92ZUFsbAogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIENsZWFycyB0aGUgY2FjaGUgb2JqZWN0IG9mIGFueSBlbnRyaWVzLgogICAgICAgICAgICovCiAgICAgICAgICByZW1vdmVBbGw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBkYXRhID0ge307CiAgICAgICAgICAgIHNpemUgPSAwOwogICAgICAgICAgICBscnVIYXNoID0ge307CiAgICAgICAgICAgIGZyZXNoRW5kID0gc3RhbGVFbmQgPSBudWxsOwogICAgICAgICAgfSwKCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5LkNhY2hlI2Rlc3Ryb3kKICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBEZXN0cm95cyB0aGUge0BsaW5rICRjYWNoZUZhY3RvcnkuQ2FjaGUgQ2FjaGV9IG9iamVjdCBlbnRpcmVseSwKICAgICAgICAgICAqIHJlbW92aW5nIGl0IGZyb20gdGhlIHtAbGluayAkY2FjaGVGYWN0b3J5ICRjYWNoZUZhY3Rvcnl9IHNldC4KICAgICAgICAgICAqLwogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGRhdGEgPSBudWxsOwogICAgICAgICAgICBzdGF0cyA9IG51bGw7CiAgICAgICAgICAgIGxydUhhc2ggPSBudWxsOwogICAgICAgICAgICBkZWxldGUgY2FjaGVzW2NhY2hlSWRdOwogICAgICAgICAgfSwKCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkY2FjaGVGYWN0b3J5LkNhY2hlI2luZm8KICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBSZXRyaWV2ZSBpbmZvcm1hdGlvbiByZWdhcmRpbmcgYSBwYXJ0aWN1bGFyIHtAbGluayAkY2FjaGVGYWN0b3J5LkNhY2hlIENhY2hlfS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBhbiBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgICAgICAgKiAgIDx1bD4KICAgICAgICAgICAqICAgICA8bGk+KippZCoqOiB0aGUgaWQgb2YgdGhlIGNhY2hlIGluc3RhbmNlPC9saT4KICAgICAgICAgICAqICAgICA8bGk+KipzaXplKio6IHRoZSBudW1iZXIgb2YgZW50cmllcyBrZXB0IGluIHRoZSBjYWNoZSBpbnN0YW5jZTwvbGk+CiAgICAgICAgICAgKiAgICAgPGxpPioqLi4uKio6IGFueSBhZGRpdGlvbmFsIHByb3BlcnRpZXMgZnJvbSB0aGUgb3B0aW9ucyBvYmplY3Qgd2hlbiBjcmVhdGluZyB0aGUKICAgICAgICAgICAqICAgICAgIGNhY2hlLjwvbGk+CiAgICAgICAgICAgKiAgIDwvdWw+CiAgICAgICAgICAgKi8KICAgICAgICAgIGluZm86IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZXh0ZW5kKHt9LCBzdGF0cywge3NpemU6IHNpemV9KTsKICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogbWFrZXMgdGhlIGBlbnRyeWAgdGhlIGZyZXNoRW5kIG9mIHRoZSBMUlUgbGlua2VkIGxpc3QKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiByZWZyZXNoKGVudHJ5KSB7CiAgICAgICAgICBpZiAoZW50cnkgIT0gZnJlc2hFbmQpIHsKICAgICAgICAgICAgaWYgKCFzdGFsZUVuZCkgewogICAgICAgICAgICAgIHN0YWxlRW5kID0gZW50cnk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhbGVFbmQgPT0gZW50cnkpIHsKICAgICAgICAgICAgICBzdGFsZUVuZCA9IGVudHJ5Lm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxpbmsoZW50cnkubiwgZW50cnkucCk7CiAgICAgICAgICAgIGxpbmsoZW50cnksIGZyZXNoRW5kKTsKICAgICAgICAgICAgZnJlc2hFbmQgPSBlbnRyeTsKICAgICAgICAgICAgZnJlc2hFbmQubiA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgLyoqCiAgICAgICAgICogYmlkaXJlY3Rpb25hbGx5IGxpbmtzIHR3byBlbnRyaWVzIG9mIHRoZSBMUlUgbGlua2VkIGxpc3QKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBsaW5rKG5leHRFbnRyeSwgcHJldkVudHJ5KSB7CiAgICAgICAgICBpZiAobmV4dEVudHJ5ICE9IHByZXZFbnRyeSkgewogICAgICAgICAgICBpZiAobmV4dEVudHJ5KSBuZXh0RW50cnkucCA9IHByZXZFbnRyeTsgLy9wIHN0YW5kcyBmb3IgcHJldmlvdXMsICdwcmV2JyBkaWRuJ3QgbWluaWZ5CiAgICAgICAgICAgIGlmIChwcmV2RW50cnkpIHByZXZFbnRyeS5uID0gbmV4dEVudHJ5OyAvL24gc3RhbmRzIGZvciBuZXh0LCAnbmV4dCcgZGlkbid0IG1pbmlmeQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkjaW5mbwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogR2V0IGluZm9ybWF0aW9uIGFib3V0IGFsbCB0aGUgY2FjaGVzIHRoYXQgaGF2ZSBiZWVuIGNyZWF0ZWQKICAgICAgICoKICAgICAgICogQHJldHVybnMge09iamVjdH0gLSBrZXktdmFsdWUgbWFwIG9mIGBjYWNoZUlkYCB0byB0aGUgcmVzdWx0IG9mIGNhbGxpbmcgYGNhY2hlI2luZm9gCiAgICAgICAqLwogICAgICBjYWNoZUZhY3RvcnkuaW5mbyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBpbmZvID0ge307CiAgICAgICAgZm9yRWFjaChjYWNoZXMsIGZ1bmN0aW9uKGNhY2hlLCBjYWNoZUlkKSB7CiAgICAgICAgICBpbmZvW2NhY2hlSWRdID0gY2FjaGUuaW5mbygpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBpbmZvOwogICAgICB9OwoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRjYWNoZUZhY3RvcnkjZ2V0CiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBHZXQgYWNjZXNzIHRvIGEgY2FjaGUgb2JqZWN0IGJ5IHRoZSBgY2FjaGVJZGAgdXNlZCB3aGVuIGl0IHdhcyBjcmVhdGVkLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2FjaGVJZCBOYW1lIG9yIGlkIG9mIGEgY2FjaGUgdG8gYWNjZXNzLgogICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBDYWNoZSBvYmplY3QgaWRlbnRpZmllZCBieSB0aGUgY2FjaGVJZCBvciB1bmRlZmluZWQgaWYgbm8gc3VjaCBjYWNoZS4KICAgICAgICovCiAgICAgIGNhY2hlRmFjdG9yeS5nZXQgPSBmdW5jdGlvbihjYWNoZUlkKSB7CiAgICAgICAgcmV0dXJuIGNhY2hlc1tjYWNoZUlkXTsKICAgICAgfTsKCgogICAgICByZXR1cm4gY2FjaGVGYWN0b3J5OwogICAgfTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJHRlbXBsYXRlQ2FjaGUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBmaXJzdCB0aW1lIGEgdGVtcGxhdGUgaXMgdXNlZCwgaXQgaXMgbG9hZGVkIGluIHRoZSB0ZW1wbGF0ZSBjYWNoZSBmb3IgcXVpY2sgcmV0cmlldmFsLiBZb3UKICAgKiBjYW4gbG9hZCB0ZW1wbGF0ZXMgZGlyZWN0bHkgaW50byB0aGUgY2FjaGUgaW4gYSBgc2NyaXB0YCB0YWcsIG9yIGJ5IGNvbnN1bWluZyB0aGUKICAgKiBgJHRlbXBsYXRlQ2FjaGVgIHNlcnZpY2UgZGlyZWN0bHkuCiAgICoKICAgKiBBZGRpbmcgdmlhIHRoZSBgc2NyaXB0YCB0YWc6CiAgICoKICAgKiBgYGBodG1sCiAgICogICA8c2NyaXB0IHR5cGU9InRleHQvbmctdGVtcGxhdGUiIGlkPSJ0ZW1wbGF0ZUlkLmh0bWwiPgogICAqICAgICA8cD5UaGlzIGlzIHRoZSBjb250ZW50IG9mIHRoZSB0ZW1wbGF0ZTwvcD4KICAgKiAgIDwvc2NyaXB0PgogICAqIGBgYAogICAqCiAgICogKipOb3RlOioqIHRoZSBgc2NyaXB0YCB0YWcgY29udGFpbmluZyB0aGUgdGVtcGxhdGUgZG9lcyBub3QgbmVlZCB0byBiZSBpbmNsdWRlZCBpbiB0aGUgYGhlYWRgIG9mCiAgICogdGhlIGRvY3VtZW50LCBidXQgaXQgbXVzdCBiZSBiZWxvdyB0aGUgYG5nLWFwcGAgZGVmaW5pdGlvbi4KICAgKgogICAqIEFkZGluZyB2aWEgdGhlICR0ZW1wbGF0ZUNhY2hlIHNlcnZpY2U6CiAgICoKICAgKiBgYGBqcwogICAqIHZhciBteUFwcCA9IGFuZ3VsYXIubW9kdWxlKCdteUFwcCcsIFtdKTsKICAgKiBteUFwcC5ydW4oZnVuY3Rpb24oJHRlbXBsYXRlQ2FjaGUpIHsKICogICAkdGVtcGxhdGVDYWNoZS5wdXQoJ3RlbXBsYXRlSWQuaHRtbCcsICdUaGlzIGlzIHRoZSBjb250ZW50IG9mIHRoZSB0ZW1wbGF0ZScpOwogKiB9KTsKICAgKiBgYGAKICAgKgogICAqIFRvIHJldHJpZXZlIHRoZSB0ZW1wbGF0ZSBsYXRlciwgc2ltcGx5IHVzZSBpdCBpbiB5b3VyIEhUTUw6CiAgICogYGBgaHRtbAogICAqIDxkaXYgbmctaW5jbHVkZT0iICd0ZW1wbGF0ZUlkLmh0bWwnICI+PC9kaXY+CiAgICogYGBgCiAgICoKICAgKiBvciBnZXQgaXQgdmlhIEphdmFzY3JpcHQ6CiAgICogYGBganMKICAgKiAkdGVtcGxhdGVDYWNoZS5nZXQoJ3RlbXBsYXRlSWQuaHRtbCcpCiAgICogYGBgCiAgICoKICAgKiBTZWUge0BsaW5rIG5nLiRjYWNoZUZhY3RvcnkgJGNhY2hlRmFjdG9yeX0uCiAgICoKICAgKi8KICBmdW5jdGlvbiAkVGVtcGxhdGVDYWNoZVByb3ZpZGVyKCkgewogICAgdGhpcy4kZ2V0ID0gWyckY2FjaGVGYWN0b3J5JywgZnVuY3Rpb24oJGNhY2hlRmFjdG9yeSkgewogICAgICByZXR1cm4gJGNhY2hlRmFjdG9yeSgndGVtcGxhdGVzJyk7CiAgICB9XTsKICB9CgogIC8qICEgVkFSSUFCTEUvRlVOQ1RJT04gTkFNSU5HIENPTlZFTlRJT05TIFRIQVQgQVBQTFkgVE8gVEhJUyBGSUxFIQogICAqCiAgICogRE9NLXJlbGF0ZWQgdmFyaWFibGVzOgogICAqCiAgICogLSAibm9kZSIgLSBET00gTm9kZQogICAqIC0gImVsZW1lbnQiIC0gRE9NIEVsZW1lbnQgb3IgTm9kZQogICAqIC0gIiRub2RlIiBvciAiJGVsZW1lbnQiIC0ganFMaXRlLXdyYXBwZWQgbm9kZSBvciBlbGVtZW50CiAgICoKICAgKgogICAqIENvbXBpbGVyIHJlbGF0ZWQgc3R1ZmY6CiAgICoKICAgKiAtICJsaW5rRm4iIC0gbGlua2luZyBmbiBvZiBhIHNpbmdsZSBkaXJlY3RpdmUKICAgKiAtICJub2RlTGlua0ZuIiAtIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGEgcGFydGljdWxhciBub2RlCiAgICogLSAiY2hpbGRMaW5rRm4iIC0gIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGNoaWxkIG5vZGVzIG9mIGEgcGFydGljdWxhciBub2RlCiAgICogLSAiY29tcG9zaXRlTGlua0ZuIiAtIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhbGwgbGlua2luZyBmbnMgZm9yIGEgY29tcGlsYXRpb24gcm9vdCAobm9kZUxpc3QpCiAgICovCgoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRjb21waWxlCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENvbXBpbGVzIGFuIEhUTUwgc3RyaW5nIG9yIERPTSBpbnRvIGEgdGVtcGxhdGUgYW5kIHByb2R1Y2VzIGEgdGVtcGxhdGUgZnVuY3Rpb24sIHdoaWNoCiAgICogY2FuIHRoZW4gYmUgdXNlZCB0byBsaW5rIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIGBzY29wZWB9IGFuZCB0aGUgdGVtcGxhdGUgdG9nZXRoZXIuCiAgICoKICAgKiBUaGUgY29tcGlsYXRpb24gaXMgYSBwcm9jZXNzIG9mIHdhbGtpbmcgdGhlIERPTSB0cmVlIGFuZCBtYXRjaGluZyBET00gZWxlbWVudHMgdG8KICAgKiB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30uCiAgICoKICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICAgKiAqKk5vdGU6KiogVGhpcyBkb2N1bWVudCBpcyBhbiBpbi1kZXB0aCByZWZlcmVuY2Ugb2YgYWxsIGRpcmVjdGl2ZSBvcHRpb25zLgogICAqIEZvciBhIGdlbnRsZSBpbnRyb2R1Y3Rpb24gdG8gZGlyZWN0aXZlcyB3aXRoIGV4YW1wbGVzIG9mIGNvbW1vbiB1c2UgY2FzZXMsCiAgICogc2VlIHRoZSB7QGxpbmsgZ3VpZGUvZGlyZWN0aXZlIGRpcmVjdGl2ZSBndWlkZX0uCiAgICogPC9kaXY+CiAgICoKICAgKiAjIyBDb21wcmVoZW5zaXZlIERpcmVjdGl2ZSBBUEkKICAgKgogICAqIFRoZXJlIGFyZSBtYW55IGRpZmZlcmVudCBvcHRpb25zIGZvciBhIGRpcmVjdGl2ZS4KICAgKgogICAqIFRoZSBkaWZmZXJlbmNlIHJlc2lkZXMgaW4gdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZmFjdG9yeSBmdW5jdGlvbi4KICAgKiBZb3UgY2FuIGVpdGhlciByZXR1cm4gYSAiRGlyZWN0aXZlIERlZmluaXRpb24gT2JqZWN0IiAoc2VlIGJlbG93KSB0aGF0IGRlZmluZXMgdGhlIGRpcmVjdGl2ZSBwcm9wZXJ0aWVzLAogICAqIG9yIGp1c3QgdGhlIGBwb3N0TGlua2AgZnVuY3Rpb24gKGFsbCBvdGhlciBwcm9wZXJ0aWVzIHdpbGwgaGF2ZSB0aGUgZGVmYXVsdCB2YWx1ZXMpLgogICAqCiAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtc3VjY2VzcyI+CiAgICogKipCZXN0IFByYWN0aWNlOioqIEl0J3MgcmVjb21tZW5kZWQgdG8gdXNlIHRoZSAiZGlyZWN0aXZlIGRlZmluaXRpb24gb2JqZWN0IiBmb3JtLgogICAqIDwvZGl2PgogICAqCiAgICogSGVyZSdzIGFuIGV4YW1wbGUgZGlyZWN0aXZlIGRlY2xhcmVkIHdpdGggYSBEaXJlY3RpdmUgRGVmaW5pdGlvbiBPYmplY3Q6CiAgICoKICAgKiBgYGBqcwogICAqICAgdmFyIG15TW9kdWxlID0gYW5ndWxhci5tb2R1bGUoLi4uKTsKICAgKgogICAqICAgbXlNb2R1bGUuZGlyZWN0aXZlKCdkaXJlY3RpdmVOYW1lJywgZnVuY3Rpb24gZmFjdG9yeShpbmplY3RhYmxlcykgewogKiAgICAgdmFyIGRpcmVjdGl2ZURlZmluaXRpb25PYmplY3QgPSB7CiAqICAgICAgIHByaW9yaXR5OiAwLAogKiAgICAgICB0ZW1wbGF0ZTogJzxkaXY+PC9kaXY+JywgLy8gb3IgLy8gZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgeyAuLi4gfSwKICogICAgICAgLy8gb3IKICogICAgICAgLy8gdGVtcGxhdGVVcmw6ICdkaXJlY3RpdmUuaHRtbCcsIC8vIG9yIC8vIGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMpIHsgLi4uIH0sCiAqICAgICAgIHRyYW5zY2x1ZGU6IGZhbHNlLAogKiAgICAgICByZXN0cmljdDogJ0EnLAogKiAgICAgICBzY29wZTogZmFsc2UsCiAqICAgICAgIGNvbnRyb2xsZXI6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgJHRyYW5zY2x1ZGUsIG90aGVySW5qZWN0YWJsZXMpIHsgLi4uIH0sCiAqICAgICAgIGNvbnRyb2xsZXJBczogJ3N0cmluZ0FsaWFzJywKICogICAgICAgcmVxdWlyZTogJ3NpYmxpbmdEaXJlY3RpdmVOYW1lJywgLy8gb3IgLy8gWydecGFyZW50RGlyZWN0aXZlTmFtZScsICc/b3B0aW9uYWxEaXJlY3RpdmVOYW1lJywgJz9eb3B0aW9uYWxQYXJlbnQnXSwKICogICAgICAgY29tcGlsZTogZnVuY3Rpb24gY29tcGlsZSh0RWxlbWVudCwgdEF0dHJzLCB0cmFuc2NsdWRlKSB7CiAqICAgICAgICAgcmV0dXJuIHsKICogICAgICAgICAgIHByZTogZnVuY3Rpb24gcHJlTGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycywgY29udHJvbGxlcikgeyAuLi4gfSwKICogICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzLCBjb250cm9sbGVyKSB7IC4uLiB9CiAqICAgICAgICAgfQogKiAgICAgICAgIC8vIG9yCiAqICAgICAgICAgLy8gcmV0dXJuIGZ1bmN0aW9uIHBvc3RMaW5rKCAuLi4gKSB7IC4uLiB9CiAqICAgICAgIH0sCiAqICAgICAgIC8vIG9yCiAqICAgICAgIC8vIGxpbms6IHsKICogICAgICAgLy8gIHByZTogZnVuY3Rpb24gcHJlTGluayhzY29wZSwgaUVsZW1lbnQsIGlBdHRycywgY29udHJvbGxlcikgeyAuLi4gfSwKICogICAgICAgLy8gIHBvc3Q6IGZ1bmN0aW9uIHBvc3RMaW5rKHNjb3BlLCBpRWxlbWVudCwgaUF0dHJzLCBjb250cm9sbGVyKSB7IC4uLiB9CiAqICAgICAgIC8vIH0KICogICAgICAgLy8gb3IKICogICAgICAgLy8gbGluazogZnVuY3Rpb24gcG9zdExpbmsoIC4uLiApIHsgLi4uIH0KICogICAgIH07CiAqICAgICByZXR1cm4gZGlyZWN0aXZlRGVmaW5pdGlvbk9iamVjdDsKICogICB9KTsKICAgKiBgYGAKICAgKgogICAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogICAqICoqTm90ZToqKiBBbnkgdW5zcGVjaWZpZWQgb3B0aW9ucyB3aWxsIHVzZSB0aGUgZGVmYXVsdCB2YWx1ZS4gWW91IGNhbiBzZWUgdGhlIGRlZmF1bHQgdmFsdWVzIGJlbG93LgogICAqIDwvZGl2PgogICAqCiAgICogVGhlcmVmb3JlIHRoZSBhYm92ZSBjYW4gYmUgc2ltcGxpZmllZCBhczoKICAgKgogICAqIGBgYGpzCiAgICogICB2YXIgbXlNb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSguLi4pOwogICAqCiAgICogICBteU1vZHVsZS5kaXJlY3RpdmUoJ2RpcmVjdGl2ZU5hbWUnLCBmdW5jdGlvbiBmYWN0b3J5KGluamVjdGFibGVzKSB7CiAqICAgICB2YXIgZGlyZWN0aXZlRGVmaW5pdGlvbk9iamVjdCA9IHsKICogICAgICAgbGluazogZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMpIHsgLi4uIH0KICogICAgIH07CiAqICAgICByZXR1cm4gZGlyZWN0aXZlRGVmaW5pdGlvbk9iamVjdDsKICogICAgIC8vIG9yCiAqICAgICAvLyByZXR1cm4gZnVuY3Rpb24gcG9zdExpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMpIHsgLi4uIH0KICogICB9KTsKICAgKiBgYGAKICAgKgogICAqCiAgICoKICAgKiAjIyMgRGlyZWN0aXZlIERlZmluaXRpb24gT2JqZWN0CiAgICoKICAgKiBUaGUgZGlyZWN0aXZlIGRlZmluaXRpb24gb2JqZWN0IHByb3ZpZGVzIGluc3RydWN0aW9ucyB0byB0aGUge0BsaW5rIG5nLiRjb21waWxlCiAqIGNvbXBpbGVyfS4gVGhlIGF0dHJpYnV0ZXMgYXJlOgogICAqCiAgICogIyMjIyBgcHJpb3JpdHlgCiAgICogV2hlbiB0aGVyZSBhcmUgbXVsdGlwbGUgZGlyZWN0aXZlcyBkZWZpbmVkIG9uIGEgc2luZ2xlIERPTSBlbGVtZW50LCBzb21ldGltZXMgaXQKICAgKiBpcyBuZWNlc3NhcnkgdG8gc3BlY2lmeSB0aGUgb3JkZXIgaW4gd2hpY2ggdGhlIGRpcmVjdGl2ZXMgYXJlIGFwcGxpZWQuIFRoZSBgcHJpb3JpdHlgIGlzIHVzZWQKICAgKiB0byBzb3J0IHRoZSBkaXJlY3RpdmVzIGJlZm9yZSB0aGVpciBgY29tcGlsZWAgZnVuY3Rpb25zIGdldCBjYWxsZWQuIFByaW9yaXR5IGlzIGRlZmluZWQgYXMgYQogICAqIG51bWJlci4gRGlyZWN0aXZlcyB3aXRoIGdyZWF0ZXIgbnVtZXJpY2FsIGBwcmlvcml0eWAgYXJlIGNvbXBpbGVkIGZpcnN0LiBQcmUtbGluayBmdW5jdGlvbnMKICAgKiBhcmUgYWxzbyBydW4gaW4gcHJpb3JpdHkgb3JkZXIsIGJ1dCBwb3N0LWxpbmsgZnVuY3Rpb25zIGFyZSBydW4gaW4gcmV2ZXJzZSBvcmRlci4gVGhlIG9yZGVyCiAgICogb2YgZGlyZWN0aXZlcyB3aXRoIHRoZSBzYW1lIHByaW9yaXR5IGlzIHVuZGVmaW5lZC4gVGhlIGRlZmF1bHQgcHJpb3JpdHkgaXMgYDBgLgogICAqCiAgICogIyMjIyBgdGVybWluYWxgCiAgICogSWYgc2V0IHRvIHRydWUgdGhlbiB0aGUgY3VycmVudCBgcHJpb3JpdHlgIHdpbGwgYmUgdGhlIGxhc3Qgc2V0IG9mIGRpcmVjdGl2ZXMKICAgKiB3aGljaCB3aWxsIGV4ZWN1dGUgKGFueSBkaXJlY3RpdmVzIGF0IHRoZSBjdXJyZW50IHByaW9yaXR5IHdpbGwgc3RpbGwgZXhlY3V0ZQogICAqIGFzIHRoZSBvcmRlciBvZiBleGVjdXRpb24gb24gc2FtZSBgcHJpb3JpdHlgIGlzIHVuZGVmaW5lZCkuCiAgICoKICAgKiAjIyMjIGBzY29wZWAKICAgKiAqKklmIHNldCB0byBgdHJ1ZWAsKiogdGhlbiBhIG5ldyBzY29wZSB3aWxsIGJlIGNyZWF0ZWQgZm9yIHRoaXMgZGlyZWN0aXZlLiBJZiBtdWx0aXBsZSBkaXJlY3RpdmVzIG9uIHRoZQogICAqIHNhbWUgZWxlbWVudCByZXF1ZXN0IGEgbmV3IHNjb3BlLCBvbmx5IG9uZSBuZXcgc2NvcGUgaXMgY3JlYXRlZC4gVGhlIG5ldyBzY29wZSBydWxlIGRvZXMgbm90CiAgICogYXBwbHkgZm9yIHRoZSByb290IG9mIHRoZSB0ZW1wbGF0ZSBzaW5jZSB0aGUgcm9vdCBvZiB0aGUgdGVtcGxhdGUgYWx3YXlzIGdldHMgYSBuZXcgc2NvcGUuCiAgICoKICAgKiAqKklmIHNldCB0byBge31gIChvYmplY3QgaGFzaCksKiogdGhlbiBhIG5ldyAiaXNvbGF0ZSIgc2NvcGUgaXMgY3JlYXRlZC4gVGhlICdpc29sYXRlJyBzY29wZSBkaWZmZXJzIGZyb20KICAgKiBub3JtYWwgc2NvcGUgaW4gdGhhdCBpdCBkb2VzIG5vdCBwcm90b3R5cGljYWxseSBpbmhlcml0IGZyb20gdGhlIHBhcmVudCBzY29wZS4gVGhpcyBpcyB1c2VmdWwKICAgKiB3aGVuIGNyZWF0aW5nIHJldXNhYmxlIGNvbXBvbmVudHMsIHdoaWNoIHNob3VsZCBub3QgYWNjaWRlbnRhbGx5IHJlYWQgb3IgbW9kaWZ5IGRhdGEgaW4gdGhlCiAgICogcGFyZW50IHNjb3BlLgogICAqCiAgICogVGhlICdpc29sYXRlJyBzY29wZSB0YWtlcyBhbiBvYmplY3QgaGFzaCB3aGljaCBkZWZpbmVzIGEgc2V0IG9mIGxvY2FsIHNjb3BlIHByb3BlcnRpZXMKICAgKiBkZXJpdmVkIGZyb20gdGhlIHBhcmVudCBzY29wZS4gVGhlc2UgbG9jYWwgcHJvcGVydGllcyBhcmUgdXNlZnVsIGZvciBhbGlhc2luZyB2YWx1ZXMgZm9yCiAgICogdGVtcGxhdGVzLiBMb2NhbHMgZGVmaW5pdGlvbiBpcyBhIGhhc2ggb2YgbG9jYWwgc2NvcGUgcHJvcGVydHkgdG8gaXRzIHNvdXJjZToKICAgKgogICAqICogYEBgIG9yIGBAYXR0cmAgLSBiaW5kIGEgbG9jYWwgc2NvcGUgcHJvcGVydHkgdG8gdGhlIHZhbHVlIG9mIERPTSBhdHRyaWJ1dGUuIFRoZSByZXN1bHQgaXMKICAgKiAgIGFsd2F5cyBhIHN0cmluZyBzaW5jZSBET00gYXR0cmlidXRlcyBhcmUgc3RyaW5ncy4gSWYgbm8gYGF0dHJgIG5hbWUgaXMgc3BlY2lmaWVkICB0aGVuIHRoZQogICAqICAgYXR0cmlidXRlIG5hbWUgaXMgYXNzdW1lZCB0byBiZSB0aGUgc2FtZSBhcyB0aGUgbG9jYWwgbmFtZS4KICAgKiAgIEdpdmVuIGA8d2lkZ2V0IG15LWF0dHI9ImhlbGxvIHt7bmFtZX19Ij5gIGFuZCB3aWRnZXQgZGVmaW5pdGlvbgogICAqICAgb2YgYHNjb3BlOiB7IGxvY2FsTmFtZTonQG15QXR0cicgfWAsIHRoZW4gd2lkZ2V0IHNjb3BlIHByb3BlcnR5IGBsb2NhbE5hbWVgIHdpbGwgcmVmbGVjdAogICAqICAgdGhlIGludGVycG9sYXRlZCB2YWx1ZSBvZiBgaGVsbG8ge3tuYW1lfX1gLiBBcyB0aGUgYG5hbWVgIGF0dHJpYnV0ZSBjaGFuZ2VzIHNvIHdpbGwgdGhlCiAgICogICBgbG9jYWxOYW1lYCBwcm9wZXJ0eSBvbiB0aGUgd2lkZ2V0IHNjb3BlLiBUaGUgYG5hbWVgIGlzIHJlYWQgZnJvbSB0aGUgcGFyZW50IHNjb3BlIChub3QKICAgKiAgIGNvbXBvbmVudCBzY29wZSkuCiAgICoKICAgKiAqIGA9YCBvciBgPWF0dHJgIC0gc2V0IHVwIGJpLWRpcmVjdGlvbmFsIGJpbmRpbmcgYmV0d2VlbiBhIGxvY2FsIHNjb3BlIHByb3BlcnR5IGFuZCB0aGUKICAgKiAgIHBhcmVudCBzY29wZSBwcm9wZXJ0eSBvZiBuYW1lIGRlZmluZWQgdmlhIHRoZSB2YWx1ZSBvZiB0aGUgYGF0dHJgIGF0dHJpYnV0ZS4gSWYgbm8gYGF0dHJgCiAgICogICBuYW1lIGlzIHNwZWNpZmllZCB0aGVuIHRoZSBhdHRyaWJ1dGUgbmFtZSBpcyBhc3N1bWVkIHRvIGJlIHRoZSBzYW1lIGFzIHRoZSBsb2NhbCBuYW1lLgogICAqICAgR2l2ZW4gYDx3aWRnZXQgbXktYXR0cj0icGFyZW50TW9kZWwiPmAgYW5kIHdpZGdldCBkZWZpbml0aW9uIG9mCiAgICogICBgc2NvcGU6IHsgbG9jYWxNb2RlbDonPW15QXR0cicgfWAsIHRoZW4gd2lkZ2V0IHNjb3BlIHByb3BlcnR5IGBsb2NhbE1vZGVsYCB3aWxsIHJlZmxlY3QgdGhlCiAgICogICB2YWx1ZSBvZiBgcGFyZW50TW9kZWxgIG9uIHRoZSBwYXJlbnQgc2NvcGUuIEFueSBjaGFuZ2VzIHRvIGBwYXJlbnRNb2RlbGAgd2lsbCBiZSByZWZsZWN0ZWQKICAgKiAgIGluIGBsb2NhbE1vZGVsYCBhbmQgYW55IGNoYW5nZXMgaW4gYGxvY2FsTW9kZWxgIHdpbGwgcmVmbGVjdCBpbiBgcGFyZW50TW9kZWxgLiBJZiB0aGUgcGFyZW50CiAgICogICBzY29wZSBwcm9wZXJ0eSBkb2Vzbid0IGV4aXN0LCBpdCB3aWxsIHRocm93IGEgTk9OX0FTU0lHTkFCTEVfTU9ERUxfRVhQUkVTU0lPTiBleGNlcHRpb24uIFlvdQogICAqICAgY2FuIGF2b2lkIHRoaXMgYmVoYXZpb3IgdXNpbmcgYD0/YCBvciBgPT9hdHRyYCBpbiBvcmRlciB0byBmbGFnIHRoZSBwcm9wZXJ0eSBhcyBvcHRpb25hbC4KICAgKgogICAqICogYCZgIG9yIGAmYXR0cmAgLSBwcm92aWRlcyBhIHdheSB0byBleGVjdXRlIGFuIGV4cHJlc3Npb24gaW4gdGhlIGNvbnRleHQgb2YgdGhlIHBhcmVudCBzY29wZS4KICAgKiAgIElmIG5vIGBhdHRyYCBuYW1lIGlzIHNwZWNpZmllZCB0aGVuIHRoZSBhdHRyaWJ1dGUgbmFtZSBpcyBhc3N1bWVkIHRvIGJlIHRoZSBzYW1lIGFzIHRoZQogICAqICAgbG9jYWwgbmFtZS4gR2l2ZW4gYDx3aWRnZXQgbXktYXR0cj0iY291bnQgPSBjb3VudCArIHZhbHVlIj5gIGFuZCB3aWRnZXQgZGVmaW5pdGlvbiBvZgogICAqICAgYHNjb3BlOiB7IGxvY2FsRm46JyZteUF0dHInIH1gLCB0aGVuIGlzb2xhdGUgc2NvcGUgcHJvcGVydHkgYGxvY2FsRm5gIHdpbGwgcG9pbnQgdG8KICAgKiAgIGEgZnVuY3Rpb24gd3JhcHBlciBmb3IgdGhlIGBjb3VudCA9IGNvdW50ICsgdmFsdWVgIGV4cHJlc3Npb24uIE9mdGVuIGl0J3MgZGVzaXJhYmxlIHRvCiAgICogICBwYXNzIGRhdGEgZnJvbSB0aGUgaXNvbGF0ZWQgc2NvcGUgdmlhIGFuIGV4cHJlc3Npb24gYW5kIHRvIHRoZSBwYXJlbnQgc2NvcGUsIHRoaXMgY2FuIGJlCiAgICogICBkb25lIGJ5IHBhc3NpbmcgYSBtYXAgb2YgbG9jYWwgdmFyaWFibGUgbmFtZXMgYW5kIHZhbHVlcyBpbnRvIHRoZSBleHByZXNzaW9uIHdyYXBwZXIgZm4uCiAgICogICBGb3IgZXhhbXBsZSwgaWYgdGhlIGV4cHJlc3Npb24gaXMgYGluY3JlbWVudChhbW91bnQpYCB0aGVuIHdlIGNhbiBzcGVjaWZ5IHRoZSBhbW91bnQgdmFsdWUKICAgKiAgIGJ5IGNhbGxpbmcgdGhlIGBsb2NhbEZuYCBhcyBgbG9jYWxGbih7YW1vdW50OiAyMn0pYC4KICAgKgogICAqCiAgICoKICAgKiAjIyMjIGBjb250cm9sbGVyYAogICAqIENvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uIFRoZSBjb250cm9sbGVyIGlzIGluc3RhbnRpYXRlZCBiZWZvcmUgdGhlCiAgICogcHJlLWxpbmtpbmcgcGhhc2UgYW5kIGl0IGlzIHNoYXJlZCB3aXRoIG90aGVyIGRpcmVjdGl2ZXMgKHNlZQogICAqIGByZXF1aXJlYCBhdHRyaWJ1dGUpLiBUaGlzIGFsbG93cyB0aGUgZGlyZWN0aXZlcyB0byBjb21tdW5pY2F0ZSB3aXRoIGVhY2ggb3RoZXIgYW5kIGF1Z21lbnQKICAgKiBlYWNoIG90aGVyJ3MgYmVoYXZpb3IuIFRoZSBjb250cm9sbGVyIGlzIGluamVjdGFibGUgKGFuZCBzdXBwb3J0cyBicmFja2V0IG5vdGF0aW9uKSB3aXRoIHRoZSBmb2xsb3dpbmcgbG9jYWxzOgogICAqCiAgICogKiBgJHNjb3BlYCAtIEN1cnJlbnQgc2NvcGUgYXNzb2NpYXRlZCB3aXRoIHRoZSBlbGVtZW50CiAgICogKiBgJGVsZW1lbnRgIC0gQ3VycmVudCBlbGVtZW50CiAgICogKiBgJGF0dHJzYCAtIEN1cnJlbnQgYXR0cmlidXRlcyBvYmplY3QgZm9yIHRoZSBlbGVtZW50CiAgICogKiBgJHRyYW5zY2x1ZGVgIC0gQSB0cmFuc2NsdWRlIGxpbmtpbmcgZnVuY3Rpb24gcHJlLWJvdW5kIHRvIHRoZSBjb3JyZWN0IHRyYW5zY2x1c2lvbiBzY29wZS4KICAgKiAgICBUaGUgc2NvcGUgY2FuIGJlIG92ZXJyaWRkZW4gYnkgYW4gb3B0aW9uYWwgZmlyc3QgYXJndW1lbnQuCiAgICogICBgZnVuY3Rpb24oW3Njb3BlXSwgY2xvbmVMaW5raW5nRm4pYC4KICAgKgogICAqCiAgICogIyMjIyBgcmVxdWlyZWAKICAgKiBSZXF1aXJlIGFub3RoZXIgZGlyZWN0aXZlIGFuZCBpbmplY3QgaXRzIGNvbnRyb2xsZXIgYXMgdGhlIGZvdXJ0aCBhcmd1bWVudCB0byB0aGUgbGlua2luZyBmdW5jdGlvbi4gVGhlCiAgICogYHJlcXVpcmVgIHRha2VzIGEgc3RyaW5nIG5hbWUgKG9yIGFycmF5IG9mIHN0cmluZ3MpIG9mIHRoZSBkaXJlY3RpdmUocykgdG8gcGFzcyBpbi4gSWYgYW4gYXJyYXkgaXMgdXNlZCwgdGhlCiAgICogaW5qZWN0ZWQgYXJndW1lbnQgd2lsbCBiZSBhbiBhcnJheSBpbiBjb3JyZXNwb25kaW5nIG9yZGVyLiBJZiBubyBzdWNoIGRpcmVjdGl2ZSBjYW4gYmUKICAgKiBmb3VuZCwgb3IgaWYgdGhlIGRpcmVjdGl2ZSBkb2VzIG5vdCBoYXZlIGEgY29udHJvbGxlciwgdGhlbiBhbiBlcnJvciBpcyByYWlzZWQuIFRoZSBuYW1lIGNhbiBiZSBwcmVmaXhlZCB3aXRoOgogICAqCiAgICogKiAobm8gcHJlZml4KSAtIExvY2F0ZSB0aGUgcmVxdWlyZWQgY29udHJvbGxlciBvbiB0aGUgY3VycmVudCBlbGVtZW50LiBUaHJvdyBhbiBlcnJvciBpZiBub3QgZm91bmQuCiAgICogKiBgP2AgLSBBdHRlbXB0IHRvIGxvY2F0ZSB0aGUgcmVxdWlyZWQgY29udHJvbGxlciBvciBwYXNzIGBudWxsYCB0byB0aGUgYGxpbmtgIGZuIGlmIG5vdCBmb3VuZC4KICAgKiAqIGBeYCAtIExvY2F0ZSB0aGUgcmVxdWlyZWQgY29udHJvbGxlciBieSBzZWFyY2hpbmcgdGhlIGVsZW1lbnQncyBwYXJlbnRzLiBUaHJvdyBhbiBlcnJvciBpZiBub3QgZm91bmQuCiAgICogKiBgP15gIC0gQXR0ZW1wdCB0byBsb2NhdGUgdGhlIHJlcXVpcmVkIGNvbnRyb2xsZXIgYnkgc2VhcmNoaW5nIHRoZSBlbGVtZW50J3MgcGFyZW50cyBvciBwYXNzIGBudWxsYCB0byB0aGUKICAgKiAgIGBsaW5rYCBmbiBpZiBub3QgZm91bmQuCiAgICoKICAgKgogICAqICMjIyMgYGNvbnRyb2xsZXJBc2AKICAgKiBDb250cm9sbGVyIGFsaWFzIGF0IHRoZSBkaXJlY3RpdmUgc2NvcGUuIEFuIGFsaWFzIGZvciB0aGUgY29udHJvbGxlciBzbyBpdAogICAqIGNhbiBiZSByZWZlcmVuY2VkIGF0IHRoZSBkaXJlY3RpdmUgdGVtcGxhdGUuIFRoZSBkaXJlY3RpdmUgbmVlZHMgdG8gZGVmaW5lIGEgc2NvcGUgZm9yIHRoaXMKICAgKiBjb25maWd1cmF0aW9uIHRvIGJlIHVzZWQuIFVzZWZ1bCBpbiB0aGUgY2FzZSB3aGVuIGRpcmVjdGl2ZSBpcyB1c2VkIGFzIGNvbXBvbmVudC4KICAgKgogICAqCiAgICogIyMjIyBgcmVzdHJpY3RgCiAgICogU3RyaW5nIG9mIHN1YnNldCBvZiBgRUFDTWAgd2hpY2ggcmVzdHJpY3RzIHRoZSBkaXJlY3RpdmUgdG8gYSBzcGVjaWZpYyBkaXJlY3RpdmUKICAgKiBkZWNsYXJhdGlvbiBzdHlsZS4gSWYgb21pdHRlZCwgdGhlIGRlZmF1bHQgKGF0dHJpYnV0ZXMgb25seSkgaXMgdXNlZC4KICAgKgogICAqICogYEVgIC0gRWxlbWVudCBuYW1lOiBgPG15LWRpcmVjdGl2ZT48L215LWRpcmVjdGl2ZT5gCiAgICogKiBgQWAgLSBBdHRyaWJ1dGUgKGRlZmF1bHQpOiBgPGRpdiBteS1kaXJlY3RpdmU9ImV4cCI+PC9kaXY+YAogICAqICogYENgIC0gQ2xhc3M6IGA8ZGl2IGNsYXNzPSJteS1kaXJlY3RpdmU6IGV4cDsiPjwvZGl2PmAKICAgKiAqIGBNYCAtIENvbW1lbnQ6IGA8IS0tIGRpcmVjdGl2ZTogbXktZGlyZWN0aXZlIGV4cCAtLT5gCiAgICoKICAgKgogICAqICMjIyMgYHRlbXBsYXRlYAogICAqIHJlcGxhY2UgdGhlIGN1cnJlbnQgZWxlbWVudCB3aXRoIHRoZSBjb250ZW50cyBvZiB0aGUgSFRNTC4gVGhlIHJlcGxhY2VtZW50IHByb2Nlc3MKICAgKiBtaWdyYXRlcyBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgLyBjbGFzc2VzIGZyb20gdGhlIG9sZCBlbGVtZW50IHRvIHRoZSBuZXcgb25lLiBTZWUgdGhlCiAgICoge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSNjcmVhdGluZy1jdXN0b20tZGlyZWN0aXZlc19jcmVhdGluZy1kaXJlY3RpdmVzX3RlbXBsYXRlLWV4cGFuZGluZy1kaXJlY3RpdmUKICogRGlyZWN0aXZlcyBHdWlkZX0gZm9yIGFuIGV4YW1wbGUuCiAgICoKICAgKiBZb3UgY2FuIHNwZWNpZnkgYHRlbXBsYXRlYCBhcyBhIHN0cmluZyByZXByZXNlbnRpbmcgdGhlIHRlbXBsYXRlIG9yIGFzIGEgZnVuY3Rpb24gd2hpY2ggdGFrZXMKICAgKiB0d28gYXJndW1lbnRzIGB0RWxlbWVudGAgYW5kIGB0QXR0cnNgIChkZXNjcmliZWQgaW4gdGhlIGBjb21waWxlYCBmdW5jdGlvbiBhcGkgYmVsb3cpIGFuZAogICAqIHJldHVybnMgYSBzdHJpbmcgdmFsdWUgcmVwcmVzZW50aW5nIHRoZSB0ZW1wbGF0ZS4KICAgKgogICAqCiAgICogIyMjIyBgdGVtcGxhdGVVcmxgCiAgICogU2FtZSBhcyBgdGVtcGxhdGVgIGJ1dCB0aGUgdGVtcGxhdGUgaXMgbG9hZGVkIGZyb20gdGhlIHNwZWNpZmllZCBVUkwuIEJlY2F1c2UKICAgKiB0aGUgdGVtcGxhdGUgbG9hZGluZyBpcyBhc3luY2hyb25vdXMgdGhlIGNvbXBpbGF0aW9uL2xpbmtpbmcgaXMgc3VzcGVuZGVkIHVudGlsIHRoZSB0ZW1wbGF0ZQogICAqIGlzIGxvYWRlZC4KICAgKgogICAqIFlvdSBjYW4gc3BlY2lmeSBgdGVtcGxhdGVVcmxgIGFzIGEgc3RyaW5nIHJlcHJlc2VudGluZyB0aGUgVVJMIG9yIGFzIGEgZnVuY3Rpb24gd2hpY2ggdGFrZXMgdHdvCiAgICogYXJndW1lbnRzIGB0RWxlbWVudGAgYW5kIGB0QXR0cnNgIChkZXNjcmliZWQgaW4gdGhlIGBjb21waWxlYCBmdW5jdGlvbiBhcGkgYmVsb3cpIGFuZCByZXR1cm5zCiAgICogYSBzdHJpbmcgdmFsdWUgcmVwcmVzZW50aW5nIHRoZSB1cmwuICBJbiBlaXRoZXIgY2FzZSwgdGhlIHRlbXBsYXRlIFVSTCBpcyBwYXNzZWQgdGhyb3VnaCB7QGxpbmsKICAgICogYXBpL25nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsICRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsfS4KICAgKgogICAqCiAgICogIyMjIyBgcmVwbGFjZWAgKFsqREVQUkVDQVRFRCohXSwgd2lsbCBiZSByZW1vdmVkIGluIG5leHQgbWFqb3IgcmVsZWFzZSkKICAgKiBzcGVjaWZ5IHdoZXJlIHRoZSB0ZW1wbGF0ZSBzaG91bGQgYmUgaW5zZXJ0ZWQuIERlZmF1bHRzIHRvIGBmYWxzZWAuCiAgICoKICAgKiAqIGB0cnVlYCAtIHRoZSB0ZW1wbGF0ZSB3aWxsIHJlcGxhY2UgdGhlIGN1cnJlbnQgZWxlbWVudC4KICAgKiAqIGBmYWxzZWAgLSB0aGUgdGVtcGxhdGUgd2lsbCByZXBsYWNlIHRoZSBjb250ZW50cyBvZiB0aGUgY3VycmVudCBlbGVtZW50LgogICAqCiAgICoKICAgKiAjIyMjIGB0cmFuc2NsdWRlYAogICAqIGNvbXBpbGUgdGhlIGNvbnRlbnQgb2YgdGhlIGVsZW1lbnQgYW5kIG1ha2UgaXQgYXZhaWxhYmxlIHRvIHRoZSBkaXJlY3RpdmUuCiAgICogVHlwaWNhbGx5IHVzZWQgd2l0aCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nVHJhbnNjbHVkZQogKiBuZ1RyYW5zY2x1ZGV9LiBUaGUgYWR2YW50YWdlIG9mIHRyYW5zY2x1c2lvbiBpcyB0aGF0IHRoZSBsaW5raW5nIGZ1bmN0aW9uIHJlY2VpdmVzIGEKICAgKiB0cmFuc2NsdXNpb24gZnVuY3Rpb24gd2hpY2ggaXMgcHJlLWJvdW5kIHRvIHRoZSBjb3JyZWN0IHNjb3BlLiBJbiBhIHR5cGljYWwgc2V0dXAgdGhlIHdpZGdldAogICAqIGNyZWF0ZXMgYW4gYGlzb2xhdGVgIHNjb3BlLCBidXQgdGhlIHRyYW5zY2x1c2lvbiBpcyBub3QgYSBjaGlsZCwgYnV0IGEgc2libGluZyBvZiB0aGUgYGlzb2xhdGVgCiAgICogc2NvcGUuIFRoaXMgbWFrZXMgaXQgcG9zc2libGUgZm9yIHRoZSB3aWRnZXQgdG8gaGF2ZSBwcml2YXRlIHN0YXRlLCBhbmQgdGhlIHRyYW5zY2x1c2lvbiB0bwogICAqIGJlIGJvdW5kIHRvIHRoZSBwYXJlbnQgKHByZS1gaXNvbGF0ZWApIHNjb3BlLgogICAqCiAgICogKiBgdHJ1ZWAgLSB0cmFuc2NsdWRlIHRoZSBjb250ZW50IG9mIHRoZSBkaXJlY3RpdmUuCiAgICogKiBgJ2VsZW1lbnQnYCAtIHRyYW5zY2x1ZGUgdGhlIHdob2xlIGVsZW1lbnQgaW5jbHVkaW5nIGFueSBkaXJlY3RpdmVzIGRlZmluZWQgYXQgbG93ZXIgcHJpb3JpdHkuCiAgICoKICAgKgogICAqICMjIyMgYGNvbXBpbGVgCiAgICoKICAgKiBgYGBqcwogICAqICAgZnVuY3Rpb24gY29tcGlsZSh0RWxlbWVudCwgdEF0dHJzLCB0cmFuc2NsdWRlKSB7IC4uLiB9CiAgICogYGBgCiAgICoKICAgKiBUaGUgY29tcGlsZSBmdW5jdGlvbiBkZWFscyB3aXRoIHRyYW5zZm9ybWluZyB0aGUgdGVtcGxhdGUgRE9NLiBTaW5jZSBtb3N0IGRpcmVjdGl2ZXMgZG8gbm90IGRvCiAgICogdGVtcGxhdGUgdHJhbnNmb3JtYXRpb24sIGl0IGlzIG5vdCB1c2VkIG9mdGVuLiBUaGUgY29tcGlsZSBmdW5jdGlvbiB0YWtlcyB0aGUgZm9sbG93aW5nIGFyZ3VtZW50czoKICAgKgogICAqICAgKiBgdEVsZW1lbnRgIC0gdGVtcGxhdGUgZWxlbWVudCAtIFRoZSBlbGVtZW50IHdoZXJlIHRoZSBkaXJlY3RpdmUgaGFzIGJlZW4gZGVjbGFyZWQuIEl0IGlzCiAgICogICAgIHNhZmUgdG8gZG8gdGVtcGxhdGUgdHJhbnNmb3JtYXRpb24gb24gdGhlIGVsZW1lbnQgYW5kIGNoaWxkIGVsZW1lbnRzIG9ubHkuCiAgICoKICAgKiAgICogYHRBdHRyc2AgLSB0ZW1wbGF0ZSBhdHRyaWJ1dGVzIC0gTm9ybWFsaXplZCBsaXN0IG9mIGF0dHJpYnV0ZXMgZGVjbGFyZWQgb24gdGhpcyBlbGVtZW50IHNoYXJlZAogICAqICAgICBiZXR3ZWVuIGFsbCBkaXJlY3RpdmUgY29tcGlsZSBmdW5jdGlvbnMuCiAgICoKICAgKiAgICogYHRyYW5zY2x1ZGVgIC0gIFsqREVQUkVDQVRFRCohXSBBIHRyYW5zY2x1ZGUgbGlua2luZyBmdW5jdGlvbjogYGZ1bmN0aW9uKHNjb3BlLCBjbG9uZUxpbmtpbmdGbilgCiAgICoKICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICAgKiAqKk5vdGU6KiogVGhlIHRlbXBsYXRlIGluc3RhbmNlIGFuZCB0aGUgbGluayBpbnN0YW5jZSBtYXkgYmUgZGlmZmVyZW50IG9iamVjdHMgaWYgdGhlIHRlbXBsYXRlIGhhcwogICAqIGJlZW4gY2xvbmVkLiBGb3IgdGhpcyByZWFzb24gaXQgaXMgKipub3QqKiBzYWZlIHRvIGRvIGFueXRoaW5nIG90aGVyIHRoYW4gRE9NIHRyYW5zZm9ybWF0aW9ucyB0aGF0CiAgICogYXBwbHkgdG8gYWxsIGNsb25lZCBET00gbm9kZXMgd2l0aGluIHRoZSBjb21waWxlIGZ1bmN0aW9uLiBTcGVjaWZpY2FsbHksIERPTSBsaXN0ZW5lciByZWdpc3RyYXRpb24KICAgKiBzaG91bGQgYmUgZG9uZSBpbiBhIGxpbmtpbmcgZnVuY3Rpb24gcmF0aGVyIHRoYW4gaW4gYSBjb21waWxlIGZ1bmN0aW9uLgogICAqIDwvZGl2PgoKICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICAgKiAqKk5vdGU6KiogVGhlIGNvbXBpbGUgZnVuY3Rpb24gY2Fubm90IGhhbmRsZSBkaXJlY3RpdmVzIHRoYXQgcmVjdXJzaXZlbHkgdXNlIHRoZW1zZWx2ZXMgaW4gdGhlaXIKICAgKiBvd24gdGVtcGxhdGVzIG9yIGNvbXBpbGUgZnVuY3Rpb25zLiBDb21waWxpbmcgdGhlc2UgZGlyZWN0aXZlcyByZXN1bHRzIGluIGFuIGluZmluaXRlIGxvb3AgYW5kIGEKICAgKiBzdGFjayBvdmVyZmxvdyBlcnJvcnMuCiAgICoKICAgKiBUaGlzIGNhbiBiZSBhdm9pZGVkIGJ5IG1hbnVhbGx5IHVzaW5nICRjb21waWxlIGluIHRoZSBwb3N0TGluayBmdW5jdGlvbiB0byBpbXBlcmF0aXZlbHkgY29tcGlsZQogICAqIGEgZGlyZWN0aXZlJ3MgdGVtcGxhdGUgaW5zdGVhZCBvZiByZWx5aW5nIG9uIGF1dG9tYXRpYyB0ZW1wbGF0ZSBjb21waWxhdGlvbiB2aWEgYHRlbXBsYXRlYCBvcgogICAqIGB0ZW1wbGF0ZVVybGAgZGVjbGFyYXRpb24gb3IgbWFudWFsIGNvbXBpbGF0aW9uIGluc2lkZSB0aGUgY29tcGlsZSBmdW5jdGlvbi4KICAgKiA8L2Rpdj4KICAgKgogICAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LWVycm9yIj4KICAgKiAqKk5vdGU6KiogVGhlIGB0cmFuc2NsdWRlYCBmdW5jdGlvbiB0aGF0IGlzIHBhc3NlZCB0byB0aGUgY29tcGlsZSBmdW5jdGlvbiBpcyBkZXByZWNhdGVkLCBhcyBpdAogICAqICAgZS5nLiBkb2VzIG5vdCBrbm93IGFib3V0IHRoZSByaWdodCBvdXRlciBzY29wZS4gUGxlYXNlIHVzZSB0aGUgdHJhbnNjbHVkZSBmdW5jdGlvbiB0aGF0IGlzIHBhc3NlZAogICAqICAgdG8gdGhlIGxpbmsgZnVuY3Rpb24gaW5zdGVhZC4KICAgKiA8L2Rpdj4KCiAgICogQSBjb21waWxlIGZ1bmN0aW9uIGNhbiBoYXZlIGEgcmV0dXJuIHZhbHVlIHdoaWNoIGNhbiBiZSBlaXRoZXIgYSBmdW5jdGlvbiBvciBhbiBvYmplY3QuCiAgICoKICAgKiAqIHJldHVybmluZyBhIChwb3N0LWxpbmspIGZ1bmN0aW9uIC0gaXMgZXF1aXZhbGVudCB0byByZWdpc3RlcmluZyB0aGUgbGlua2luZyBmdW5jdGlvbiB2aWEgdGhlCiAgICogICBgbGlua2AgcHJvcGVydHkgb2YgdGhlIGNvbmZpZyBvYmplY3Qgd2hlbiB0aGUgY29tcGlsZSBmdW5jdGlvbiBpcyBlbXB0eS4KICAgKgogICAqICogcmV0dXJuaW5nIGFuIG9iamVjdCB3aXRoIGZ1bmN0aW9uKHMpIHJlZ2lzdGVyZWQgdmlhIGBwcmVgIGFuZCBgcG9zdGAgcHJvcGVydGllcyAtIGFsbG93cyB5b3UgdG8KICAgKiAgIGNvbnRyb2wgd2hlbiBhIGxpbmtpbmcgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCBkdXJpbmcgdGhlIGxpbmtpbmcgcGhhc2UuIFNlZSBpbmZvIGFib3V0CiAgICogICBwcmUtbGlua2luZyBhbmQgcG9zdC1saW5raW5nIGZ1bmN0aW9ucyBiZWxvdy4KICAgKgogICAqCiAgICogIyMjIyBgbGlua2AKICAgKiBUaGlzIHByb3BlcnR5IGlzIHVzZWQgb25seSBpZiB0aGUgYGNvbXBpbGVgIHByb3BlcnR5IGlzIG5vdCBkZWZpbmVkLgogICAqCiAgICogYGBganMKICAgKiAgIGZ1bmN0aW9uIGxpbmsoc2NvcGUsIGlFbGVtZW50LCBpQXR0cnMsIGNvbnRyb2xsZXIsIHRyYW5zY2x1ZGVGbikgeyAuLi4gfQogICAqIGBgYAogICAqCiAgICogVGhlIGxpbmsgZnVuY3Rpb24gaXMgcmVzcG9uc2libGUgZm9yIHJlZ2lzdGVyaW5nIERPTSBsaXN0ZW5lcnMgYXMgd2VsbCBhcyB1cGRhdGluZyB0aGUgRE9NLiBJdCBpcwogICAqIGV4ZWN1dGVkIGFmdGVyIHRoZSB0ZW1wbGF0ZSBoYXMgYmVlbiBjbG9uZWQuIFRoaXMgaXMgd2hlcmUgbW9zdCBvZiB0aGUgZGlyZWN0aXZlIGxvZ2ljIHdpbGwgYmUKICAgKiBwdXQuCiAgICoKICAgKiAgICogYHNjb3BlYCAtIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIFNjb3BlfSAtIFRoZSBzY29wZSB0byBiZSB1c2VkIGJ5IHRoZQogICAqICAgICBkaXJlY3RpdmUgZm9yIHJlZ2lzdGVyaW5nIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCB3YXRjaGVzfS4KICAgKgogICAqICAgKiBgaUVsZW1lbnRgIC0gaW5zdGFuY2UgZWxlbWVudCAtIFRoZSBlbGVtZW50IHdoZXJlIHRoZSBkaXJlY3RpdmUgaXMgdG8gYmUgdXNlZC4gSXQgaXMgc2FmZSB0bwogICAqICAgICBtYW5pcHVsYXRlIHRoZSBjaGlsZHJlbiBvZiB0aGUgZWxlbWVudCBvbmx5IGluIGBwb3N0TGlua2AgZnVuY3Rpb24gc2luY2UgdGhlIGNoaWxkcmVuIGhhdmUKICAgKiAgICAgYWxyZWFkeSBiZWVuIGxpbmtlZC4KICAgKgogICAqICAgKiBgaUF0dHJzYCAtIGluc3RhbmNlIGF0dHJpYnV0ZXMgLSBOb3JtYWxpemVkIGxpc3Qgb2YgYXR0cmlidXRlcyBkZWNsYXJlZCBvbiB0aGlzIGVsZW1lbnQgc2hhcmVkCiAgICogICAgIGJldHdlZW4gYWxsIGRpcmVjdGl2ZSBsaW5raW5nIGZ1bmN0aW9ucy4KICAgKgogICAqICAgKiBgY29udHJvbGxlcmAgLSBhIGNvbnRyb2xsZXIgaW5zdGFuY2UgLSBBIGNvbnRyb2xsZXIgaW5zdGFuY2UgaWYgYXQgbGVhc3Qgb25lIGRpcmVjdGl2ZSBvbiB0aGUKICAgKiAgICAgZWxlbWVudCBkZWZpbmVzIGEgY29udHJvbGxlci4gVGhlIGNvbnRyb2xsZXIgaXMgc2hhcmVkIGFtb25nIGFsbCB0aGUgZGlyZWN0aXZlcywgd2hpY2ggYWxsb3dzCiAgICogICAgIHRoZSBkaXJlY3RpdmVzIHRvIHVzZSB0aGUgY29udHJvbGxlcnMgYXMgYSBjb21tdW5pY2F0aW9uIGNoYW5uZWwuCiAgICoKICAgKiAgICogYHRyYW5zY2x1ZGVGbmAgLSBBIHRyYW5zY2x1ZGUgbGlua2luZyBmdW5jdGlvbiBwcmUtYm91bmQgdG8gdGhlIGNvcnJlY3QgdHJhbnNjbHVzaW9uIHNjb3BlLgogICAqICAgICBUaGUgc2NvcGUgY2FuIGJlIG92ZXJyaWRkZW4gYnkgYW4gb3B0aW9uYWwgZmlyc3QgYXJndW1lbnQuIFRoaXMgaXMgdGhlIHNhbWUgYXMgdGhlIGAkdHJhbnNjbHVkZWAKICAgKiAgICAgcGFyYW1ldGVyIG9mIGRpcmVjdGl2ZSBjb250cm9sbGVycy4KICAgKiAgICAgYGZ1bmN0aW9uKFtzY29wZV0sIGNsb25lTGlua2luZ0ZuKWAuCiAgICoKICAgKgogICAqICMjIyMgUHJlLWxpbmtpbmcgZnVuY3Rpb24KICAgKgogICAqIEV4ZWN1dGVkIGJlZm9yZSB0aGUgY2hpbGQgZWxlbWVudHMgYXJlIGxpbmtlZC4gTm90IHNhZmUgdG8gZG8gRE9NIHRyYW5zZm9ybWF0aW9uIHNpbmNlIHRoZQogICAqIGNvbXBpbGVyIGxpbmtpbmcgZnVuY3Rpb24gd2lsbCBmYWlsIHRvIGxvY2F0ZSB0aGUgY29ycmVjdCBlbGVtZW50cyBmb3IgbGlua2luZy4KICAgKgogICAqICMjIyMgUG9zdC1saW5raW5nIGZ1bmN0aW9uCiAgICoKICAgKiBFeGVjdXRlZCBhZnRlciB0aGUgY2hpbGQgZWxlbWVudHMgYXJlIGxpbmtlZC4gSXQgaXMgc2FmZSB0byBkbyBET00gdHJhbnNmb3JtYXRpb24gaW4gdGhlIHBvc3QtbGlua2luZyBmdW5jdGlvbi4KICAgKgogICAqIDxhIG5hbWU9IkF0dHJpYnV0ZXMiPjwvYT4KICAgKiAjIyMgQXR0cmlidXRlcwogICAqCiAgICogVGhlIHtAbGluayBuZy4kY29tcGlsZS5kaXJlY3RpdmUuQXR0cmlidXRlcyBBdHRyaWJ1dGVzfSBvYmplY3QgLSBwYXNzZWQgYXMgYSBwYXJhbWV0ZXIgaW4gdGhlCiAgICogYGxpbmsoKWAgb3IgYGNvbXBpbGUoKWAgZnVuY3Rpb25zLiBJdCBoYXMgYSB2YXJpZXR5IG9mIHVzZXMuCiAgICoKICAgKiBhY2Nlc3NpbmcgKk5vcm1hbGl6ZWQgYXR0cmlidXRlIG5hbWVzOioKICAgKiBEaXJlY3RpdmVzIGxpa2UgJ25nQmluZCcgY2FuIGJlIGV4cHJlc3NlZCBpbiBtYW55IHdheXM6ICduZzpiaW5kJywgYGRhdGEtbmctYmluZGAsIG9yICd4LW5nLWJpbmQnLgogICAqIHRoZSBhdHRyaWJ1dGVzIG9iamVjdCBhbGxvd3MgZm9yIG5vcm1hbGl6ZWQgYWNjZXNzIHRvCiAgICogICB0aGUgYXR0cmlidXRlcy4KICAgKgogICAqICogKkRpcmVjdGl2ZSBpbnRlci1jb21tdW5pY2F0aW9uOiogQWxsIGRpcmVjdGl2ZXMgc2hhcmUgdGhlIHNhbWUgaW5zdGFuY2Ugb2YgdGhlIGF0dHJpYnV0ZXMKICAgKiAgIG9iamVjdCB3aGljaCBhbGxvd3MgdGhlIGRpcmVjdGl2ZXMgdG8gdXNlIHRoZSBhdHRyaWJ1dGVzIG9iamVjdCBhcyBpbnRlciBkaXJlY3RpdmUKICAgKiAgIGNvbW11bmljYXRpb24uCiAgICoKICAgKiAqICpTdXBwb3J0cyBpbnRlcnBvbGF0aW9uOiogSW50ZXJwb2xhdGlvbiBhdHRyaWJ1dGVzIGFyZSBhc3NpZ25lZCB0byB0aGUgYXR0cmlidXRlIG9iamVjdAogICAqICAgYWxsb3dpbmcgb3RoZXIgZGlyZWN0aXZlcyB0byByZWFkIHRoZSBpbnRlcnBvbGF0ZWQgdmFsdWUuCiAgICoKICAgKiAqICpPYnNlcnZpbmcgaW50ZXJwb2xhdGVkIGF0dHJpYnV0ZXM6KiBVc2UgYCRvYnNlcnZlYCB0byBvYnNlcnZlIHRoZSB2YWx1ZSBjaGFuZ2VzIG9mIGF0dHJpYnV0ZXMKICAgKiAgIHRoYXQgY29udGFpbiBpbnRlcnBvbGF0aW9uIChlLmcuIGBzcmM9Int7YmFyfX0iYCkuIE5vdCBvbmx5IGlzIHRoaXMgdmVyeSBlZmZpY2llbnQgYnV0IGl0J3MgYWxzbwogICAqICAgdGhlIG9ubHkgd2F5IHRvIGVhc2lseSBnZXQgdGhlIGFjdHVhbCB2YWx1ZSBiZWNhdXNlIGR1cmluZyB0aGUgbGlua2luZyBwaGFzZSB0aGUgaW50ZXJwb2xhdGlvbgogICAqICAgaGFzbid0IGJlZW4gZXZhbHVhdGVkIHlldCBhbmQgc28gdGhlIHZhbHVlIGlzIGF0IHRoaXMgdGltZSBzZXQgdG8gYHVuZGVmaW5lZGAuCiAgICoKICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIGxpbmtpbmdGbihzY29wZSwgZWxtLCBhdHRycywgY3RybCkgewogKiAgIC8vIGdldCB0aGUgYXR0cmlidXRlIHZhbHVlCiAqICAgY29uc29sZS5sb2coYXR0cnMubmdNb2RlbCk7CiAqCiAqICAgLy8gY2hhbmdlIHRoZSBhdHRyaWJ1dGUKICogICBhdHRycy4kc2V0KCduZ01vZGVsJywgJ25ldyB2YWx1ZScpOwogKgogKiAgIC8vIG9ic2VydmUgY2hhbmdlcyB0byBpbnRlcnBvbGF0ZWQgYXR0cmlidXRlCiAqICAgYXR0cnMuJG9ic2VydmUoJ25nTW9kZWwnLCBmdW5jdGlvbih2YWx1ZSkgewogKiAgICAgY29uc29sZS5sb2coJ25nTW9kZWwgaGFzIGNoYW5nZWQgdmFsdWUgdG8gJyArIHZhbHVlKTsKICogICB9KTsKICogfQogICAqIGBgYAogICAqCiAgICogQmVsb3cgaXMgYW4gZXhhbXBsZSB1c2luZyBgJGNvbXBpbGVQcm92aWRlcmAuCiAgICoKICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICAgKiAqKk5vdGUqKjogVHlwaWNhbGx5IGRpcmVjdGl2ZXMgYXJlIHJlZ2lzdGVyZWQgd2l0aCBgbW9kdWxlLmRpcmVjdGl2ZWAuIFRoZSBleGFtcGxlIGJlbG93IGlzCiAgICogdG8gaWxsdXN0cmF0ZSBob3cgYCRjb21waWxlYCB3b3Jrcy4KICAgKiA8L2Rpdj4KICAgKgogICA8ZXhhbXBsZSBtb2R1bGU9ImNvbXBpbGUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgYW5ndWxhci5tb2R1bGUoJ2NvbXBpbGUnLCBbXSwgZnVuY3Rpb24oJGNvbXBpbGVQcm92aWRlcikgewogICAgICAgIC8vIGNvbmZpZ3VyZSBuZXcgJ2NvbXBpbGUnIGRpcmVjdGl2ZSBieSBwYXNzaW5nIGEgZGlyZWN0aXZlCiAgICAgICAgLy8gZmFjdG9yeSBmdW5jdGlvbi4gVGhlIGZhY3RvcnkgZnVuY3Rpb24gaW5qZWN0cyB0aGUgJyRjb21waWxlJwogICAgICAgICRjb21waWxlUHJvdmlkZXIuZGlyZWN0aXZlKCdjb21waWxlJywgZnVuY3Rpb24oJGNvbXBpbGUpIHsKICAgICAgICAgIC8vIGRpcmVjdGl2ZSBmYWN0b3J5IGNyZWF0ZXMgYSBsaW5rIGZ1bmN0aW9uCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAgICBmdW5jdGlvbihzY29wZSkgewogICAgICAgICAgICAgICAgIC8vIHdhdGNoIHRoZSAnY29tcGlsZScgZXhwcmVzc2lvbiBmb3IgY2hhbmdlcwogICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRldmFsKGF0dHJzLmNvbXBpbGUpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIC8vIHdoZW4gdGhlICdjb21waWxlJyBleHByZXNzaW9uIGNoYW5nZXMKICAgICAgICAgICAgICAgIC8vIGFzc2lnbiBpdCBpbnRvIHRoZSBjdXJyZW50IERPTQogICAgICAgICAgICAgICAgZWxlbWVudC5odG1sKHZhbHVlKTsKCiAgICAgICAgICAgICAgICAvLyBjb21waWxlIHRoZSBuZXcgRE9NIGFuZCBsaW5rIGl0IHRvIHRoZSBjdXJyZW50CiAgICAgICAgICAgICAgICAvLyBzY29wZS4KICAgICAgICAgICAgICAgIC8vIE5PVEU6IHdlIG9ubHkgY29tcGlsZSAuY2hpbGROb2RlcyBzbyB0aGF0CiAgICAgICAgICAgICAgICAvLyB3ZSBkb24ndCBnZXQgaW50byBpbmZpbml0ZSBsb29wIGNvbXBpbGluZyBvdXJzZWx2ZXMKICAgICAgICAgICAgICAgICRjb21waWxlKGVsZW1lbnQuY29udGVudHMoKSkoc2NvcGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgfSkKICAgICAgfSk7CgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICRzY29wZS5uYW1lID0gJ0FuZ3VsYXInOwogICAgICAgICRzY29wZS5odG1sID0gJ0hlbGxvIHt7bmFtZX19JzsKICAgICAgfQogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgPGlucHV0IG5nLW1vZGVsPSJuYW1lIj4gPGJyPgogICA8dGV4dGFyZWEgbmctbW9kZWw9Imh0bWwiPjwvdGV4dGFyZWE+IDxicj4KICAgPGRpdiBjb21waWxlPSJodG1sIj48L2Rpdj4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgYXV0byBjb21waWxlJywgZnVuY3Rpb24oKSB7CiAgICAgICB2YXIgdGV4dGFyZWEgPSAkKCd0ZXh0YXJlYScpOwogICAgICAgdmFyIG91dHB1dCA9ICQoJ2Rpdltjb21waWxlXScpOwogICAgICAgLy8gVGhlIGluaXRpYWwgc3RhdGUgcmVhZHMgJ0hlbGxvIEFuZ3VsYXInLgogICAgICAgZXhwZWN0KG91dHB1dC5nZXRUZXh0KCkpLnRvQmUoJ0hlbGxvIEFuZ3VsYXInKTsKICAgICAgIHRleHRhcmVhLmNsZWFyKCk7CiAgICAgICB0ZXh0YXJlYS5zZW5kS2V5cygne3tuYW1lfX0hJyk7CiAgICAgICBleHBlY3Qob3V0cHV0LmdldFRleHQoKSkudG9CZSgnQW5ndWxhciEnKTsKICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CgogICAqCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ3xET01FbGVtZW50fSBlbGVtZW50IEVsZW1lbnQgb3IgSFRNTCBzdHJpbmcgdG8gY29tcGlsZSBpbnRvIGEgdGVtcGxhdGUgZnVuY3Rpb24uCiAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlLCBjbG9uZUF0dGFjaEZuPSl9IHRyYW5zY2x1ZGUgZnVuY3Rpb24gYXZhaWxhYmxlIHRvIGRpcmVjdGl2ZXMuCiAgICogQHBhcmFtIHtudW1iZXJ9IG1heFByaW9yaXR5IG9ubHkgYXBwbHkgZGlyZWN0aXZlcyBsb3dlciB0aGFuIGdpdmVuIHByaW9yaXR5IChPbmx5IGVmZmVjdHMgdGhlCiAgICogICAgICAgICAgICAgICAgIHJvb3QgZWxlbWVudChzKSwgbm90IHRoZWlyIGNoaWxkcmVuKQogICAqIEByZXR1cm5zIHtmdW5jdGlvbihzY29wZSwgY2xvbmVBdHRhY2hGbj0pfSBhIGxpbmsgZnVuY3Rpb24gd2hpY2ggaXMgdXNlZCB0byBiaW5kIHRlbXBsYXRlCiAgICogKGEgRE9NIGVsZW1lbnQvdHJlZSkgdG8gYSBzY29wZS4gV2hlcmU6CiAgICoKICAgKiAgKiBgc2NvcGVgIC0gQSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBTY29wZX0gdG8gYmluZCB0by4KICAgKiAgKiBgY2xvbmVBdHRhY2hGbmAgLSBJZiBgY2xvbmVBdHRhY2hGbmAgaXMgcHJvdmlkZWQsIHRoZW4gdGhlIGxpbmsgZnVuY3Rpb24gd2lsbCBjbG9uZSB0aGUKICAgKiAgYHRlbXBsYXRlYCBhbmQgY2FsbCB0aGUgYGNsb25lQXR0YWNoRm5gIGZ1bmN0aW9uIGFsbG93aW5nIHRoZSBjYWxsZXIgdG8gYXR0YWNoIHRoZQogICAqICBjbG9uZWQgZWxlbWVudHMgdG8gdGhlIERPTSBkb2N1bWVudCBhdCB0aGUgYXBwcm9wcmlhdGUgcGxhY2UuIFRoZSBgY2xvbmVBdHRhY2hGbmAgaXMKICAgKiAgY2FsbGVkIGFzOiA8YnI+IGBjbG9uZUF0dGFjaEZuKGNsb25lZEVsZW1lbnQsIHNjb3BlKWAgd2hlcmU6CiAgICoKICAgKiAgICAgICogYGNsb25lZEVsZW1lbnRgIC0gaXMgYSBjbG9uZSBvZiB0aGUgb3JpZ2luYWwgYGVsZW1lbnRgIHBhc3NlZCBpbnRvIHRoZSBjb21waWxlci4KICAgKiAgICAgICogYHNjb3BlYCAtIGlzIHRoZSBjdXJyZW50IHNjb3BlIHdpdGggd2hpY2ggdGhlIGxpbmtpbmcgZnVuY3Rpb24gaXMgd29ya2luZyB3aXRoLgogICAqCiAgICogQ2FsbGluZyB0aGUgbGlua2luZyBmdW5jdGlvbiByZXR1cm5zIHRoZSBlbGVtZW50IG9mIHRoZSB0ZW1wbGF0ZS4gSXQgaXMgZWl0aGVyIHRoZSBvcmlnaW5hbAogICAqIGVsZW1lbnQgcGFzc2VkIGluLCBvciB0aGUgY2xvbmUgb2YgdGhlIGVsZW1lbnQgaWYgdGhlIGBjbG9uZUF0dGFjaEZuYCBpcyBwcm92aWRlZC4KICAgKgogICAqIEFmdGVyIGxpbmtpbmcgdGhlIHZpZXcgaXMgbm90IHVwZGF0ZWQgdW50aWwgYWZ0ZXIgYSBjYWxsIHRvICRkaWdlc3Qgd2hpY2ggdHlwaWNhbGx5IGlzIGRvbmUgYnkKICAgKiBBbmd1bGFyIGF1dG9tYXRpY2FsbHkuCiAgICoKICAgKiBJZiB5b3UgbmVlZCBhY2Nlc3MgdG8gdGhlIGJvdW5kIHZpZXcsIHRoZXJlIGFyZSB0d28gd2F5cyB0byBkbyBpdDoKICAgKgogICAqIC0gSWYgeW91IGFyZSBub3QgYXNraW5nIHRoZSBsaW5raW5nIGZ1bmN0aW9uIHRvIGNsb25lIHRoZSB0ZW1wbGF0ZSwgY3JlYXRlIHRoZSBET00gZWxlbWVudChzKQogICAqICAgYmVmb3JlIHlvdSBzZW5kIHRoZW0gdG8gdGhlIGNvbXBpbGVyIGFuZCBrZWVwIHRoaXMgcmVmZXJlbmNlIGFyb3VuZC4KICAgKiAgIGBgYGpzCiAgICogICAgIHZhciBlbGVtZW50ID0gJGNvbXBpbGUoJzxwPnt7dG90YWx9fTwvcD4nKShzY29wZSk7CiAgICogICBgYGAKICAgKgogICAqIC0gaWYgb24gdGhlIG90aGVyIGhhbmQsIHlvdSBuZWVkIHRoZSBlbGVtZW50IHRvIGJlIGNsb25lZCwgdGhlIHZpZXcgcmVmZXJlbmNlIGZyb20gdGhlIG9yaWdpbmFsCiAgICogICBleGFtcGxlIHdvdWxkIG5vdCBwb2ludCB0byB0aGUgY2xvbmUsIGJ1dCByYXRoZXIgdG8gdGhlIG9yaWdpbmFsIHRlbXBsYXRlIHRoYXQgd2FzIGNsb25lZC4gSW4KICAgKiAgIHRoaXMgY2FzZSwgeW91IGNhbiBhY2Nlc3MgdGhlIGNsb25lIHZpYSB0aGUgY2xvbmVBdHRhY2hGbjoKICAgKiAgIGBgYGpzCiAgICogICAgIHZhciB0ZW1wbGF0ZUVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoJzxwPnt7dG90YWx9fTwvcD4nKSwKICAgKiAgICAgICAgIHNjb3BlID0gLi4uLjsKICAgKgogICAqICAgICB2YXIgY2xvbmVkRWxlbWVudCA9ICRjb21waWxlKHRlbXBsYXRlRWxlbWVudCkoc2NvcGUsIGZ1bmN0aW9uKGNsb25lZEVsZW1lbnQsIHNjb3BlKSB7CiAqICAgICAgIC8vYXR0YWNoIHRoZSBjbG9uZSB0byBET00gZG9jdW1lbnQgYXQgdGhlIHJpZ2h0IHBsYWNlCiAqICAgICB9KTsKICAgKgogICAqICAgICAvL25vdyB3ZSBoYXZlIHJlZmVyZW5jZSB0byB0aGUgY2xvbmVkIERPTSB2aWEgYGNsb25lZEVsZW1lbnRgCiAgICogICBgYGAKICAgKgogICAqCiAgICogRm9yIGluZm9ybWF0aW9uIG9uIGhvdyB0aGUgY29tcGlsZXIgd29ya3MsIHNlZSB0aGUKICAgKiB7QGxpbmsgZ3VpZGUvY29tcGlsZXIgQW5ndWxhciBIVE1MIENvbXBpbGVyfSBzZWN0aW9uIG9mIHRoZSBEZXZlbG9wZXIgR3VpZGUuCiAgICovCgogIHZhciAkY29tcGlsZU1pbkVyciA9IG1pbkVycignJGNvbXBpbGUnKTsKCiAgLyoqCiAgICogQG5nZG9jIHByb3ZpZGVyCiAgICogQG5hbWUgJGNvbXBpbGVQcm92aWRlcgogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKi8KICAkQ29tcGlsZVByb3ZpZGVyLiRpbmplY3QgPSBbJyRwcm92aWRlJywgJyQkc2FuaXRpemVVcmlQcm92aWRlciddOwogIGZ1bmN0aW9uICRDb21waWxlUHJvdmlkZXIoJHByb3ZpZGUsICQkc2FuaXRpemVVcmlQcm92aWRlcikgewogICAgdmFyIGhhc0RpcmVjdGl2ZXMgPSB7fSwKICAgICAgU3VmZml4ID0gJ0RpcmVjdGl2ZScsCiAgICAgIENPTU1FTlRfRElSRUNUSVZFX1JFR0VYUCA9IC9eXHMqZGlyZWN0aXZlXDpccyooW1xkXHdfXC1dKylccysoLiopJC8sCiAgICAgIENMQVNTX0RJUkVDVElWRV9SRUdFWFAgPSAvKChbXGRcd19cLV0rKSg/Olw6KFteO10rKSk/Oz8pLzsKCiAgICAvLyBSZWY6IGh0dHA6Ly9kZXZlbG9wZXJzLndoYXR3Zy5vcmcvd2ViYXBwYXBpcy5odG1sI2V2ZW50LWhhbmRsZXItaWRsLWF0dHJpYnV0ZXMKICAgIC8vIFRoZSBhc3N1bXB0aW9uIGlzIHRoYXQgZnV0dXJlIERPTSBldmVudCBhdHRyaWJ1dGUgbmFtZXMgd2lsbCBiZWdpbiB3aXRoCiAgICAvLyAnb24nIGFuZCBiZSBjb21wb3NlZCBvZiBvbmx5IEVuZ2xpc2ggbGV0dGVycy4KICAgIHZhciBFVkVOVF9IQU5ETEVSX0FUVFJfUkVHRVhQID0gL14ob25bYS16XSt8Zm9ybWFjdGlvbikkLzsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlCiAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXIgYSBuZXcgZGlyZWN0aXZlIHdpdGggdGhlIGNvbXBpbGVyLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdH0gbmFtZSBOYW1lIG9mIHRoZSBkaXJlY3RpdmUgaW4gY2FtZWwtY2FzZSAoaS5lLiA8Y29kZT5uZ0JpbmQ8L2NvZGU+IHdoaWNoCiAgICAgKiAgICB3aWxsIG1hdGNoIGFzIDxjb2RlPm5nLWJpbmQ8L2NvZGU+KSwgb3IgYW4gb2JqZWN0IG1hcCBvZiBkaXJlY3RpdmVzIHdoZXJlIHRoZSBrZXlzIGFyZSB0aGUKICAgICAqICAgIG5hbWVzIGFuZCB0aGUgdmFsdWVzIGFyZSB0aGUgZmFjdG9yaWVzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxBcnJheX0gZGlyZWN0aXZlRmFjdG9yeSBBbiBpbmplY3RhYmxlIGRpcmVjdGl2ZSBmYWN0b3J5IGZ1bmN0aW9uLiBTZWUKICAgICAqICAgIHtAbGluayBndWlkZS9kaXJlY3RpdmV9IGZvciBtb3JlIGluZm8uCiAgICAgKiBAcmV0dXJucyB7bmcuJGNvbXBpbGVQcm92aWRlcn0gU2VsZiBmb3IgY2hhaW5pbmcuCiAgICAgKi8KICAgIHRoaXMuZGlyZWN0aXZlID0gZnVuY3Rpb24gcmVnaXN0ZXJEaXJlY3RpdmUobmFtZSwgZGlyZWN0aXZlRmFjdG9yeSkgewogICAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eShuYW1lLCAnZGlyZWN0aXZlJyk7CiAgICAgIGlmIChpc1N0cmluZyhuYW1lKSkgewogICAgICAgIGFzc2VydEFyZyhkaXJlY3RpdmVGYWN0b3J5LCAnZGlyZWN0aXZlRmFjdG9yeScpOwogICAgICAgIGlmICghaGFzRGlyZWN0aXZlcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgaGFzRGlyZWN0aXZlc1tuYW1lXSA9IFtdOwogICAgICAgICAgJHByb3ZpZGUuZmFjdG9yeShuYW1lICsgU3VmZml4LCBbJyRpbmplY3RvcicsICckZXhjZXB0aW9uSGFuZGxlcicsCiAgICAgICAgICAgIGZ1bmN0aW9uKCRpbmplY3RvciwgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICAgICAgICB2YXIgZGlyZWN0aXZlcyA9IFtdOwogICAgICAgICAgICAgIGZvckVhY2goaGFzRGlyZWN0aXZlc1tuYW1lXSwgZnVuY3Rpb24oZGlyZWN0aXZlRmFjdG9yeSwgaW5kZXgpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHZhciBkaXJlY3RpdmUgPSAkaW5qZWN0b3IuaW52b2tlKGRpcmVjdGl2ZUZhY3RvcnkpOwogICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihkaXJlY3RpdmUpKSB7CiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlID0geyBjb21waWxlOiB2YWx1ZUZuKGRpcmVjdGl2ZSkgfTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghZGlyZWN0aXZlLmNvbXBpbGUgJiYgZGlyZWN0aXZlLmxpbmspIHsKICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUuY29tcGlsZSA9IHZhbHVlRm4oZGlyZWN0aXZlLmxpbmspOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5wcmlvcml0eSA9IGRpcmVjdGl2ZS5wcmlvcml0eSB8fCAwOwogICAgICAgICAgICAgICAgICBkaXJlY3RpdmUuaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlLm5hbWUgPSBkaXJlY3RpdmUubmFtZSB8fCBuYW1lOwogICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVxdWlyZSA9IGRpcmVjdGl2ZS5yZXF1aXJlIHx8IChkaXJlY3RpdmUuY29udHJvbGxlciAmJiBkaXJlY3RpdmUubmFtZSk7CiAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZS5yZXN0cmljdCA9IGRpcmVjdGl2ZS5yZXN0cmljdCB8fCAnQSc7CiAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXMucHVzaChkaXJlY3RpdmUpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICByZXR1cm4gZGlyZWN0aXZlczsKICAgICAgICAgICAgfV0pOwogICAgICAgIH0KICAgICAgICBoYXNEaXJlY3RpdmVzW25hbWVdLnB1c2goZGlyZWN0aXZlRmFjdG9yeSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yRWFjaChuYW1lLCByZXZlcnNlUGFyYW1zKHJlZ2lzdGVyRGlyZWN0aXZlKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRjb21waWxlUHJvdmlkZXIjYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QKICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXRyaWV2ZXMgb3Igb3ZlcnJpZGVzIHRoZSBkZWZhdWx0IHJlZ3VsYXIgZXhwcmVzc2lvbiB0aGF0IGlzIHVzZWQgZm9yIHdoaXRlbGlzdGluZyBvZiBzYWZlCiAgICAgKiB1cmxzIGR1cmluZyBhW2hyZWZdIHNhbml0aXphdGlvbi4KICAgICAqCiAgICAgKiBUaGUgc2FuaXRpemF0aW9uIGlzIGEgc2VjdXJpdHkgbWVhc3VyZSBhaW1lZCBhdCBwcmV2ZW50IFhTUyBhdHRhY2tzIHZpYSBodG1sIGxpbmtzLgogICAgICoKICAgICAqIEFueSB1cmwgYWJvdXQgdG8gYmUgYXNzaWduZWQgdG8gYVtocmVmXSB2aWEgZGF0YS1iaW5kaW5nIGlzIGZpcnN0IG5vcm1hbGl6ZWQgYW5kIHR1cm5lZCBpbnRvCiAgICAgKiBhbiBhYnNvbHV0ZSB1cmwuIEFmdGVyd2FyZHMsIHRoZSB1cmwgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBgYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3RgCiAgICAgKiByZWd1bGFyIGV4cHJlc3Npb24uIElmIGEgbWF0Y2ggaXMgZm91bmQsIHRoZSBvcmlnaW5hbCB1cmwgaXMgd3JpdHRlbiBpbnRvIHRoZSBkb20uIE90aGVyd2lzZSwKICAgICAqIHRoZSBhYnNvbHV0ZSB1cmwgaXMgcHJlZml4ZWQgd2l0aCBgJ3Vuc2FmZTonYCBzdHJpbmcgYW5kIG9ubHkgdGhlbiBpcyBpdCB3cml0dGVuIGludG8gdGhlIERPTS4KICAgICAqCiAgICAgKiBAcGFyYW0ge1JlZ0V4cD19IHJlZ2V4cCBOZXcgcmVnZXhwIHRvIHdoaXRlbGlzdCB1cmxzIHdpdGguCiAgICAgKiBAcmV0dXJucyB7UmVnRXhwfG5nLiRjb21waWxlUHJvdmlkZXJ9IEN1cnJlbnQgUmVnRXhwIGlmIGNhbGxlZCB3aXRob3V0IHZhbHVlIG9yIHNlbGYgZm9yCiAgICAgKiAgICBjaGFpbmluZyBvdGhlcndpc2UuCiAgICAgKi8KICAgIHRoaXMuYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSBmdW5jdGlvbihyZWdleHApIHsKICAgICAgaWYgKGlzRGVmaW5lZChyZWdleHApKSB7CiAgICAgICAgJCRzYW5pdGl6ZVVyaVByb3ZpZGVyLmFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0KHJlZ2V4cCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICQkc2FuaXRpemVVcmlQcm92aWRlci5hSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCgpOwogICAgICB9CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRjb21waWxlUHJvdmlkZXIjaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0CiAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0cmlldmVzIG9yIG92ZXJyaWRlcyB0aGUgZGVmYXVsdCByZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBpcyB1c2VkIGZvciB3aGl0ZWxpc3Rpbmcgb2Ygc2FmZQogICAgICogdXJscyBkdXJpbmcgaW1nW3NyY10gc2FuaXRpemF0aW9uLgogICAgICoKICAgICAqIFRoZSBzYW5pdGl6YXRpb24gaXMgYSBzZWN1cml0eSBtZWFzdXJlIGFpbWVkIGF0IHByZXZlbnQgWFNTIGF0dGFja3MgdmlhIGh0bWwgbGlua3MuCiAgICAgKgogICAgICogQW55IHVybCBhYm91dCB0byBiZSBhc3NpZ25lZCB0byBpbWdbc3JjXSB2aWEgZGF0YS1iaW5kaW5nIGlzIGZpcnN0IG5vcm1hbGl6ZWQgYW5kIHR1cm5lZCBpbnRvCiAgICAgKiBhbiBhYnNvbHV0ZSB1cmwuIEFmdGVyd2FyZHMsIHRoZSB1cmwgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBgaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0YAogICAgICogcmVndWxhciBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kLCB0aGUgb3JpZ2luYWwgdXJsIGlzIHdyaXR0ZW4gaW50byB0aGUgZG9tLiBPdGhlcndpc2UsCiAgICAgKiB0aGUgYWJzb2x1dGUgdXJsIGlzIHByZWZpeGVkIHdpdGggYCd1bnNhZmU6J2Agc3RyaW5nIGFuZCBvbmx5IHRoZW4gaXMgaXQgd3JpdHRlbiBpbnRvIHRoZSBET00uCiAgICAgKgogICAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAgICogQHJldHVybnMge1JlZ0V4cHxuZy4kY29tcGlsZVByb3ZpZGVyfSBDdXJyZW50IFJlZ0V4cCBpZiBjYWxsZWQgd2l0aG91dCB2YWx1ZSBvciBzZWxmIGZvcgogICAgICogICAgY2hhaW5pbmcgb3RoZXJ3aXNlLgogICAgICovCiAgICB0aGlzLmltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA9IGZ1bmN0aW9uKHJlZ2V4cCkgewogICAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgICAkJHNhbml0aXplVXJpUHJvdmlkZXIuaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0KHJlZ2V4cCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICQkc2FuaXRpemVVcmlQcm92aWRlci5pbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QoKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLiRnZXQgPSBbCiAgICAgICckaW5qZWN0b3InLCAnJGludGVycG9sYXRlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRodHRwJywgJyR0ZW1wbGF0ZUNhY2hlJywgJyRwYXJzZScsCiAgICAgICckY29udHJvbGxlcicsICckcm9vdFNjb3BlJywgJyRkb2N1bWVudCcsICckc2NlJywgJyRhbmltYXRlJywgJyQkc2FuaXRpemVVcmknLAogICAgICBmdW5jdGlvbigkaW5qZWN0b3IsICAgJGludGVycG9sYXRlLCAgICRleGNlcHRpb25IYW5kbGVyLCAgICRodHRwLCAgICR0ZW1wbGF0ZUNhY2hlLCAgICRwYXJzZSwKICAgICAgICAgICAgICAgJGNvbnRyb2xsZXIsICAgJHJvb3RTY29wZSwgICAkZG9jdW1lbnQsICAgJHNjZSwgICAkYW5pbWF0ZSwgICAkJHNhbml0aXplVXJpKSB7CgogICAgICAgIHZhciBBdHRyaWJ1dGVzID0gZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICAgICAgdGhpcy4kJGVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgICAgdGhpcy4kYXR0ciA9IGF0dHIgfHwge307CiAgICAgICAgfTsKCiAgICAgICAgQXR0cmlidXRlcy5wcm90b3R5cGUgPSB7CiAgICAgICAgICAkbm9ybWFsaXplOiBkaXJlY3RpdmVOb3JtYWxpemUsCgoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGFkZENsYXNzCiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogQWRkcyB0aGUgQ1NTIGNsYXNzIHZhbHVlIHNwZWNpZmllZCBieSB0aGUgY2xhc3NWYWwgcGFyYW1ldGVyIHRvIHRoZSBlbGVtZW50LiBJZiBhbmltYXRpb25zCiAgICAgICAgICAgKiBhcmUgZW5hYmxlZCB0aGVuIGFuIGFuaW1hdGlvbiB3aWxsIGJlIHRyaWdnZXJlZCBmb3IgdGhlIGNsYXNzIGFkZGl0aW9uLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBjbGFzc1ZhbCBUaGUgY2xhc3NOYW1lIHZhbHVlIHRoYXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudAogICAgICAgICAgICovCiAgICAgICAgICAkYWRkQ2xhc3MgOiBmdW5jdGlvbihjbGFzc1ZhbCkgewogICAgICAgICAgICBpZihjbGFzc1ZhbCAmJiBjbGFzc1ZhbC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3ModGhpcy4kJGVsZW1lbnQsIGNsYXNzVmFsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRyZW1vdmVDbGFzcwogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFJlbW92ZXMgdGhlIENTUyBjbGFzcyB2YWx1ZSBzcGVjaWZpZWQgYnkgdGhlIGNsYXNzVmFsIHBhcmFtZXRlciBmcm9tIHRoZSBlbGVtZW50LiBJZgogICAgICAgICAgICogYW5pbWF0aW9ucyBhcmUgZW5hYmxlZCB0aGVuIGFuIGFuaW1hdGlvbiB3aWxsIGJlIHRyaWdnZXJlZCBmb3IgdGhlIGNsYXNzIHJlbW92YWwuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzVmFsIFRoZSBjbGFzc05hbWUgdmFsdWUgdGhhdCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgICAgICovCiAgICAgICAgICAkcmVtb3ZlQ2xhc3MgOiBmdW5jdGlvbihjbGFzc1ZhbCkgewogICAgICAgICAgICBpZihjbGFzc1ZhbCAmJiBjbGFzc1ZhbC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3ModGhpcy4kJGVsZW1lbnQsIGNsYXNzVmFsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyR1cGRhdGVDbGFzcwogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIEFkZHMgYW5kIHJlbW92ZXMgdGhlIGFwcHJvcHJpYXRlIENTUyBjbGFzcyB2YWx1ZXMgdG8gdGhlIGVsZW1lbnQgYmFzZWQgb24gdGhlIGRpZmZlcmVuY2UKICAgICAgICAgICAqIGJldHdlZW4gdGhlIG5ldyBhbmQgb2xkIENTUyBjbGFzcyB2YWx1ZXMgKHNwZWNpZmllZCBhcyBuZXdDbGFzc2VzIGFuZCBvbGRDbGFzc2VzKS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3Q2xhc3NlcyBUaGUgY3VycmVudCBDU1MgY2xhc3NOYW1lIHZhbHVlCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gb2xkQ2xhc3NlcyBUaGUgZm9ybWVyIENTUyBjbGFzc05hbWUgdmFsdWUKICAgICAgICAgICAqLwogICAgICAgICAgJHVwZGF0ZUNsYXNzIDogZnVuY3Rpb24obmV3Q2xhc3Nlcywgb2xkQ2xhc3NlcykgewogICAgICAgICAgICB2YXIgdG9BZGQgPSB0b2tlbkRpZmZlcmVuY2UobmV3Q2xhc3Nlcywgb2xkQ2xhc3Nlcyk7CiAgICAgICAgICAgIHZhciB0b1JlbW92ZSA9IHRva2VuRGlmZmVyZW5jZShvbGRDbGFzc2VzLCBuZXdDbGFzc2VzKTsKCiAgICAgICAgICAgIGlmKHRvQWRkLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKHRoaXMuJCRlbGVtZW50LCB0b1JlbW92ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZih0b1JlbW92ZS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAkYW5pbWF0ZS5hZGRDbGFzcyh0aGlzLiQkZWxlbWVudCwgdG9BZGQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICRhbmltYXRlLnNldENsYXNzKHRoaXMuJCRlbGVtZW50LCB0b0FkZCwgdG9SZW1vdmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogU2V0IGEgbm9ybWFsaXplZCBhdHRyaWJ1dGUgb24gdGhlIGVsZW1lbnQgaW4gYSB3YXkgc3VjaCB0aGF0IGFsbCBkaXJlY3RpdmVzCiAgICAgICAgICAgKiBjYW4gc2hhcmUgdGhlIGF0dHJpYnV0ZS4gVGhpcyBmdW5jdGlvbiBwcm9wZXJseSBoYW5kbGVzIGJvb2xlYW4gYXR0cmlidXRlcy4KICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgTm9ybWFsaXplZCBrZXkuIChpZSBuZ0F0dHJpYnV0ZSkKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfGJvb2xlYW59IHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQuIElmIGBudWxsYCBhdHRyaWJ1dGUgd2lsbCBiZSBkZWxldGVkLgogICAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gd3JpdGVBdHRyIElmIGZhbHNlLCBkb2VzIG5vdCB3cml0ZSB0aGUgdmFsdWUgdG8gRE9NIGVsZW1lbnQgYXR0cmlidXRlLgogICAgICAgICAgICogICAgIERlZmF1bHRzIHRvIHRydWUuCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZz19IGF0dHJOYW1lIE9wdGlvbmFsIG5vbmUgbm9ybWFsaXplZCBuYW1lLiBEZWZhdWx0cyB0byBrZXkuCiAgICAgICAgICAgKi8KICAgICAgICAgICRzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUsIHdyaXRlQXR0ciwgYXR0ck5hbWUpIHsKICAgICAgICAgICAgLy8gVE9ETzogZGVjaWRlIHdoZXRoZXIgb3Igbm90IHRvIHRocm93IGFuIGVycm9yIGlmICJjbGFzcyIKICAgICAgICAgICAgLy9pcyBzZXQgdGhyb3VnaCB0aGlzIGZ1bmN0aW9uIHNpbmNlIGl0IG1heSBjYXVzZSAkdXBkYXRlQ2xhc3MgdG8KICAgICAgICAgICAgLy9iZWNvbWUgdW5zdGFibGUuCgogICAgICAgICAgICB2YXIgYm9vbGVhbktleSA9IGdldEJvb2xlYW5BdHRyTmFtZSh0aGlzLiQkZWxlbWVudFswXSwga2V5KSwKICAgICAgICAgICAgICBub3JtYWxpemVkVmFsLAogICAgICAgICAgICAgIG5vZGVOYW1lOwoKICAgICAgICAgICAgaWYgKGJvb2xlYW5LZXkpIHsKICAgICAgICAgICAgICB0aGlzLiQkZWxlbWVudC5wcm9wKGtleSwgdmFsdWUpOwogICAgICAgICAgICAgIGF0dHJOYW1lID0gYm9vbGVhbktleTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CgogICAgICAgICAgICAvLyB0cmFuc2xhdGUgbm9ybWFsaXplZCBrZXkgdG8gYWN0dWFsIGtleQogICAgICAgICAgICBpZiAoYXR0ck5hbWUpIHsKICAgICAgICAgICAgICB0aGlzLiRhdHRyW2tleV0gPSBhdHRyTmFtZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhdHRyTmFtZSA9IHRoaXMuJGF0dHJba2V5XTsKICAgICAgICAgICAgICBpZiAoIWF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICB0aGlzLiRhdHRyW2tleV0gPSBhdHRyTmFtZSA9IHNuYWtlX2Nhc2Uoa2V5LCAnLScpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgbm9kZU5hbWUgPSBub2RlTmFtZV8odGhpcy4kJGVsZW1lbnQpOwoKICAgICAgICAgICAgLy8gc2FuaXRpemUgYVtocmVmXSBhbmQgaW1nW3NyY10gdmFsdWVzCiAgICAgICAgICAgIGlmICgobm9kZU5hbWUgPT09ICdBJyAmJiBrZXkgPT09ICdocmVmJykgfHwKICAgICAgICAgICAgICAobm9kZU5hbWUgPT09ICdJTUcnICYmIGtleSA9PT0gJ3NyYycpKSB7CiAgICAgICAgICAgICAgdGhpc1trZXldID0gdmFsdWUgPSAkJHNhbml0aXplVXJpKHZhbHVlLCBrZXkgPT09ICdzcmMnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHdyaXRlQXR0ciAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy4kJGVsZW1lbnQucmVtb3ZlQXR0cihhdHRyTmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuJCRlbGVtZW50LmF0dHIoYXR0ck5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZpcmUgb2JzZXJ2ZXJzCiAgICAgICAgICAgIHZhciAkJG9ic2VydmVycyA9IHRoaXMuJCRvYnNlcnZlcnM7CiAgICAgICAgICAgICQkb2JzZXJ2ZXJzICYmIGZvckVhY2goJCRvYnNlcnZlcnNba2V5XSwgZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZm4odmFsdWUpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAoKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRvYnNlcnZlCiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogT2JzZXJ2ZXMgYW4gaW50ZXJwb2xhdGVkIGF0dHJpYnV0ZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBUaGUgb2JzZXJ2ZXIgZnVuY3Rpb24gd2lsbCBiZSBpbnZva2VkIG9uY2UgZHVyaW5nIHRoZSBuZXh0IGAkZGlnZXN0YCBmb2xsb3dpbmcKICAgICAgICAgICAqIGNvbXBpbGF0aW9uLiBUaGUgb2JzZXJ2ZXIgaXMgdGhlbiBpbnZva2VkIHdoZW5ldmVyIHRoZSBpbnRlcnBvbGF0ZWQgdmFsdWUKICAgICAgICAgICAqIGNoYW5nZXMuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBOb3JtYWxpemVkIGtleS4gKGllIG5nQXR0cmlidXRlKSAuCiAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGludGVycG9sYXRlZFZhbHVlKX0gZm4gRnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCB3aGVuZXZlcgogICAgICAgICAgIHRoZSBpbnRlcnBvbGF0ZWQgdmFsdWUgb2YgdGhlIGF0dHJpYnV0ZSBjaGFuZ2VzLgogICAgICAgICAgICogICAgICAgIFNlZSB0aGUge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSNBdHRyaWJ1dGVzIERpcmVjdGl2ZXN9IGd1aWRlIGZvciBtb3JlIGluZm8uCiAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gdGhlIGBmbmAgcGFyYW1ldGVyLgogICAgICAgICAgICovCiAgICAgICAgICAkb2JzZXJ2ZTogZnVuY3Rpb24oa2V5LCBmbikgewogICAgICAgICAgICB2YXIgYXR0cnMgPSB0aGlzLAogICAgICAgICAgICAgICQkb2JzZXJ2ZXJzID0gKGF0dHJzLiQkb2JzZXJ2ZXJzIHx8IChhdHRycy4kJG9ic2VydmVycyA9IHt9KSksCiAgICAgICAgICAgICAgbGlzdGVuZXJzID0gKCQkb2JzZXJ2ZXJzW2tleV0gfHwgKCQkb2JzZXJ2ZXJzW2tleV0gPSBbXSkpOwoKICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goZm4pOwogICAgICAgICAgICAkcm9vdFNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCFsaXN0ZW5lcnMuJCRpbnRlcikgewogICAgICAgICAgICAgICAgLy8gbm8gb25lIHJlZ2lzdGVyZWQgYXR0cmlidXRlIGludGVycG9sYXRpb24gZnVuY3Rpb24sIHNvIGxldHMgY2FsbCBpdCBtYW51YWxseQogICAgICAgICAgICAgICAgZm4oYXR0cnNba2V5XSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBzdGFydFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCgpLAogICAgICAgICAgZW5kU3ltYm9sID0gJGludGVycG9sYXRlLmVuZFN5bWJvbCgpLAogICAgICAgICAgZGVub3JtYWxpemVUZW1wbGF0ZSA9IChzdGFydFN5bWJvbCA9PSAne3snIHx8IGVuZFN5bWJvbCAgPT0gJ319JykKICAgICAgICAgICAgPyBpZGVudGl0eQogICAgICAgICAgICA6IGZ1bmN0aW9uIGRlbm9ybWFsaXplVGVtcGxhdGUodGVtcGxhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRlbXBsYXRlLnJlcGxhY2UoL1x7XHsvZywgc3RhcnRTeW1ib2wpLnJlcGxhY2UoL319L2csIGVuZFN5bWJvbCk7CiAgICAgICAgICB9LAogICAgICAgICAgTkdfQVRUUl9CSU5ESU5HID0gL15uZ0F0dHJbQS1aXS87CgoKICAgICAgICByZXR1cm4gY29tcGlsZTsKCiAgICAgICAgLy89PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKICAgICAgICBmdW5jdGlvbiBjb21waWxlKCRjb21waWxlTm9kZXMsIHRyYW5zY2x1ZGVGbiwgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpIHsKICAgICAgICAgIGlmICghKCRjb21waWxlTm9kZXMgaW5zdGFuY2VvZiBqcUxpdGUpKSB7CiAgICAgICAgICAgIC8vIGpxdWVyeSBhbHdheXMgcmV3cmFwcywgd2hlcmVhcyB3ZSBuZWVkIHRvIHByZXNlcnZlIHRoZSBvcmlnaW5hbCBzZWxlY3RvciBzbyB0aGF0IHdlIGNhbgogICAgICAgICAgICAvLyBtb2RpZnkgaXQuCiAgICAgICAgICAgICRjb21waWxlTm9kZXMgPSBqcUxpdGUoJGNvbXBpbGVOb2Rlcyk7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBXZSBjYW4gbm90IGNvbXBpbGUgdG9wIGxldmVsIHRleHQgZWxlbWVudHMgc2luY2UgdGV4dCBub2RlcyBjYW4gYmUgbWVyZ2VkIGFuZCB3ZSB3aWxsCiAgICAgICAgICAvLyBub3QgYmUgYWJsZSB0byBhdHRhY2ggc2NvcGUgZGF0YSB0byB0aGVtLCBzbyB3ZSB3aWxsIHdyYXAgdGhlbSBpbiA8c3Bhbj4KICAgICAgICAgIGZvckVhY2goJGNvbXBpbGVOb2RlcywgZnVuY3Rpb24obm9kZSwgaW5kZXgpewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAzIC8qIHRleHQgbm9kZSAqLyAmJiBub2RlLm5vZGVWYWx1ZS5tYXRjaCgvXFMrLykgLyogbm9uLWVtcHR5ICovICkgewogICAgICAgICAgICAgICRjb21waWxlTm9kZXNbaW5kZXhdID0gbm9kZSA9IGpxTGl0ZShub2RlKS53cmFwKCc8c3Bhbj48L3NwYW4+JykucGFyZW50KClbMF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIGNvbXBvc2l0ZUxpbmtGbiA9CiAgICAgICAgICAgIGNvbXBpbGVOb2RlcygkY29tcGlsZU5vZGVzLCB0cmFuc2NsdWRlRm4sICRjb21waWxlTm9kZXMsCiAgICAgICAgICAgICAgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSwgcHJldmlvdXNDb21waWxlQ29udGV4dCk7CiAgICAgICAgICBzYWZlQWRkQ2xhc3MoJGNvbXBpbGVOb2RlcywgJ25nLXNjb3BlJyk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gcHVibGljTGlua0ZuKHNjb3BlLCBjbG9uZUNvbm5lY3RGbiwgdHJhbnNjbHVkZUNvbnRyb2xsZXJzKXsKICAgICAgICAgICAgYXNzZXJ0QXJnKHNjb3BlLCAnc2NvcGUnKTsKICAgICAgICAgICAgLy8gaW1wb3J0YW50ISE6IHdlIG11c3QgY2FsbCBvdXIganFMaXRlLmNsb25lKCkgc2luY2UgdGhlIGpRdWVyeSBvbmUgaXMgdHJ5aW5nIHRvIGJlIHNtYXJ0CiAgICAgICAgICAgIC8vIGFuZCBzb21ldGltZXMgY2hhbmdlcyB0aGUgc3RydWN0dXJlIG9mIHRoZSBET00uCiAgICAgICAgICAgIHZhciAkbGlua05vZGUgPSBjbG9uZUNvbm5lY3RGbgogICAgICAgICAgICAgID8gSlFMaXRlUHJvdG90eXBlLmNsb25lLmNhbGwoJGNvbXBpbGVOb2RlcykgLy8gSU1QT1JUQU5UISEhCiAgICAgICAgICAgICAgOiAkY29tcGlsZU5vZGVzOwoKICAgICAgICAgICAgZm9yRWFjaCh0cmFuc2NsdWRlQ29udHJvbGxlcnMsIGZ1bmN0aW9uKGluc3RhbmNlLCBuYW1lKSB7CiAgICAgICAgICAgICAgJGxpbmtOb2RlLmRhdGEoJyQnICsgbmFtZSArICdDb250cm9sbGVyJywgaW5zdGFuY2UpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIEF0dGFjaCBzY29wZSBvbmx5IHRvIG5vbi10ZXh0IG5vZGVzLgogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpaSA9ICRsaW5rTm9kZS5sZW5ndGg7IGk8aWk7IGkrKykgewogICAgICAgICAgICAgIHZhciBub2RlID0gJGxpbmtOb2RlW2ldLAogICAgICAgICAgICAgICAgbm9kZVR5cGUgPSBub2RlLm5vZGVUeXBlOwogICAgICAgICAgICAgIGlmIChub2RlVHlwZSA9PT0gMSAvKiBlbGVtZW50ICovIHx8IG5vZGVUeXBlID09PSA5IC8qIGRvY3VtZW50ICovKSB7CiAgICAgICAgICAgICAgICAkbGlua05vZGUuZXEoaSkuZGF0YSgnJHNjb3BlJywgc2NvcGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNsb25lQ29ubmVjdEZuKSBjbG9uZUNvbm5lY3RGbigkbGlua05vZGUsIHNjb3BlKTsKICAgICAgICAgICAgaWYgKGNvbXBvc2l0ZUxpbmtGbikgY29tcG9zaXRlTGlua0ZuKHNjb3BlLCAkbGlua05vZGUsICRsaW5rTm9kZSk7CiAgICAgICAgICAgIHJldHVybiAkbGlua05vZGU7CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2FmZUFkZENsYXNzKCRlbGVtZW50LCBjbGFzc05hbWUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgLy8gaWdub3JlLCBzaW5jZSBpdCBtZWFucyB0aGF0IHdlIGFyZSB0cnlpbmcgdG8gc2V0IGNsYXNzIG9uCiAgICAgICAgICAgIC8vIFNWRyBlbGVtZW50LCB3aGVyZSBjbGFzcyBuYW1lIGlzIHJlYWQtb25seS4KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIENvbXBpbGUgZnVuY3Rpb24gbWF0Y2hlcyBlYWNoIG5vZGUgaW4gbm9kZUxpc3QgYWdhaW5zdCB0aGUgZGlyZWN0aXZlcy4gT25jZSBhbGwgZGlyZWN0aXZlcwogICAgICAgICAqIGZvciBhIHBhcnRpY3VsYXIgbm9kZSBhcmUgY29sbGVjdGVkIHRoZWlyIGNvbXBpbGUgZnVuY3Rpb25zIGFyZSBleGVjdXRlZC4gVGhlIGNvbXBpbGUKICAgICAgICAgKiBmdW5jdGlvbnMgcmV0dXJuIHZhbHVlcyAtIHRoZSBsaW5raW5nIGZ1bmN0aW9ucyAtIGFyZSBjb21iaW5lZCBpbnRvIGEgY29tcG9zaXRlIGxpbmtpbmcKICAgICAgICAgKiBmdW5jdGlvbiwgd2hpY2ggaXMgdGhlIGEgbGlua2luZyBmdW5jdGlvbiBmb3IgdGhlIG5vZGUuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge05vZGVMaXN0fSBub2RlTGlzdCBhbiBhcnJheSBvZiBub2RlcyBvciBOb2RlTGlzdCB0byBjb21waWxlCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlLCBjbG9uZUF0dGFjaEZuPSl9IHRyYW5zY2x1ZGVGbiBBIGxpbmtpbmcgZnVuY3Rpb24sIHdoZXJlIHRoZQogICAgICAgICAqICAgICAgICBzY29wZSBhcmd1bWVudCBpcyBhdXRvLWdlbmVyYXRlZCB0byB0aGUgbmV3IGNoaWxkIG9mIHRoZSB0cmFuc2NsdWRlZCBwYXJlbnQgc2NvcGUuCiAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50PX0gJHJvb3RFbGVtZW50IElmIHRoZSBub2RlTGlzdCBpcyB0aGUgcm9vdCBvZiB0aGUgY29tcGlsYXRpb24gdHJlZSB0aGVuCiAgICAgICAgICogICAgICAgIHRoZSByb290RWxlbWVudCBtdXN0IGJlIHNldCB0aGUganFMaXRlIGNvbGxlY3Rpb24gb2YgdGhlIGNvbXBpbGUgcm9vdC4gVGhpcyBpcwogICAgICAgICAqICAgICAgICBuZWVkZWQgc28gdGhhdCB0aGUganFMaXRlIGNvbGxlY3Rpb24gaXRlbXMgY2FuIGJlIHJlcGxhY2VkIHdpdGggd2lkZ2V0cy4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IG1heFByaW9yaXR5IE1heCBkaXJlY3RpdmUgcHJpb3JpdHkuCiAgICAgICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBBIGNvbXBvc2l0ZSBsaW5raW5nIGZ1bmN0aW9uIG9mIGFsbCBvZiB0aGUgbWF0Y2hlZCBkaXJlY3RpdmVzIG9yIG51bGwuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gY29tcGlsZU5vZGVzKG5vZGVMaXN0LCB0cmFuc2NsdWRlRm4sICRyb290RWxlbWVudCwgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dCkgewogICAgICAgICAgdmFyIGxpbmtGbnMgPSBbXSwKICAgICAgICAgICAgYXR0cnMsIGRpcmVjdGl2ZXMsIG5vZGVMaW5rRm4sIGNoaWxkTm9kZXMsIGNoaWxkTGlua0ZuLCBsaW5rRm5Gb3VuZDsKCiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGVMaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGF0dHJzID0gbmV3IEF0dHJpYnV0ZXMoKTsKCiAgICAgICAgICAgIC8vIHdlIG11c3QgYWx3YXlzIHJlZmVyIHRvIG5vZGVMaXN0W2ldIHNpbmNlIHRoZSBub2RlcyBjYW4gYmUgcmVwbGFjZWQgdW5kZXJuZWF0aCB1cy4KICAgICAgICAgICAgZGlyZWN0aXZlcyA9IGNvbGxlY3REaXJlY3RpdmVzKG5vZGVMaXN0W2ldLCBbXSwgYXR0cnMsIGkgPT09IDAgPyBtYXhQcmlvcml0eSA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgICBpZ25vcmVEaXJlY3RpdmUpOwoKICAgICAgICAgICAgbm9kZUxpbmtGbiA9IChkaXJlY3RpdmVzLmxlbmd0aCkKICAgICAgICAgICAgICA/IGFwcGx5RGlyZWN0aXZlc1RvTm9kZShkaXJlY3RpdmVzLCBub2RlTGlzdFtpXSwgYXR0cnMsIHRyYW5zY2x1ZGVGbiwgJHJvb3RFbGVtZW50LAogICAgICAgICAgICAgIG51bGwsIFtdLCBbXSwgcHJldmlvdXNDb21waWxlQ29udGV4dCkKICAgICAgICAgICAgICA6IG51bGw7CgogICAgICAgICAgICBpZiAobm9kZUxpbmtGbiAmJiBub2RlTGlua0ZuLnNjb3BlKSB7CiAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKGpxTGl0ZShub2RlTGlzdFtpXSksICduZy1zY29wZScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjaGlsZExpbmtGbiA9IChub2RlTGlua0ZuICYmIG5vZGVMaW5rRm4udGVybWluYWwgfHwKICAgICAgICAgICAgICAhKGNoaWxkTm9kZXMgPSBub2RlTGlzdFtpXS5jaGlsZE5vZGVzKSB8fAogICAgICAgICAgICAgICFjaGlsZE5vZGVzLmxlbmd0aCkKICAgICAgICAgICAgICA/IG51bGwKICAgICAgICAgICAgICA6IGNvbXBpbGVOb2RlcyhjaGlsZE5vZGVzLAogICAgICAgICAgICAgIG5vZGVMaW5rRm4gPyBub2RlTGlua0ZuLnRyYW5zY2x1ZGUgOiB0cmFuc2NsdWRlRm4pOwoKICAgICAgICAgICAgbGlua0Zucy5wdXNoKG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuKTsKICAgICAgICAgICAgbGlua0ZuRm91bmQgPSBsaW5rRm5Gb3VuZCB8fCBub2RlTGlua0ZuIHx8IGNoaWxkTGlua0ZuOwogICAgICAgICAgICAvL3VzZSB0aGUgcHJldmlvdXMgY29udGV4dCBvbmx5IGZvciB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGUgdmlydHVhbCBncm91cAogICAgICAgICAgICBwcmV2aW91c0NvbXBpbGVDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyByZXR1cm4gYSBsaW5raW5nIGZ1bmN0aW9uIGlmIHdlIGhhdmUgZm91bmQgYW55dGhpbmcsIG51bGwgb3RoZXJ3aXNlCiAgICAgICAgICByZXR1cm4gbGlua0ZuRm91bmQgPyBjb21wb3NpdGVMaW5rRm4gOiBudWxsOwoKICAgICAgICAgIGZ1bmN0aW9uIGNvbXBvc2l0ZUxpbmtGbihzY29wZSwgbm9kZUxpc3QsICRyb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgdmFyIG5vZGVMaW5rRm4sIGNoaWxkTGlua0ZuLCBub2RlLCAkbm9kZSwgY2hpbGRTY29wZSwgY2hpbGRUcmFuc2NsdWRlRm4sIGksIGlpLCBuOwoKICAgICAgICAgICAgLy8gY29weSBub2RlTGlzdCBzbyB0aGF0IGxpbmtpbmcgZG9lc24ndCBicmVhayBkdWUgdG8gbGl2ZSBsaXN0IHVwZGF0ZXMuCiAgICAgICAgICAgIHZhciBub2RlTGlzdExlbmd0aCA9IG5vZGVMaXN0Lmxlbmd0aCwKICAgICAgICAgICAgICBzdGFibGVOb2RlTGlzdCA9IG5ldyBBcnJheShub2RlTGlzdExlbmd0aCk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBub2RlTGlzdExlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgc3RhYmxlTm9kZUxpc3RbaV0gPSBub2RlTGlzdFtpXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yKGkgPSAwLCBuID0gMCwgaWkgPSBsaW5rRm5zLmxlbmd0aDsgaSA8IGlpOyBuKyspIHsKICAgICAgICAgICAgICBub2RlID0gc3RhYmxlTm9kZUxpc3Rbbl07CiAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IGxpbmtGbnNbaSsrXTsKICAgICAgICAgICAgICBjaGlsZExpbmtGbiA9IGxpbmtGbnNbaSsrXTsKICAgICAgICAgICAgICAkbm9kZSA9IGpxTGl0ZShub2RlKTsKCiAgICAgICAgICAgICAgaWYgKG5vZGVMaW5rRm4pIHsKICAgICAgICAgICAgICAgIGlmIChub2RlTGlua0ZuLnNjb3BlKSB7CiAgICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgICRub2RlLmRhdGEoJyRzY29wZScsIGNoaWxkU2NvcGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IHNjb3BlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4gPSBub2RlTGlua0ZuLnRyYW5zY2x1ZGU7CiAgICAgICAgICAgICAgICBpZiAoY2hpbGRUcmFuc2NsdWRlRm4gfHwgKCFib3VuZFRyYW5zY2x1ZGVGbiAmJiB0cmFuc2NsdWRlRm4pKSB7CiAgICAgICAgICAgICAgICAgIG5vZGVMaW5rRm4oY2hpbGRMaW5rRm4sIGNoaWxkU2NvcGUsIG5vZGUsICRyb290RWxlbWVudCwKICAgICAgICAgICAgICAgICAgICBjcmVhdGVCb3VuZFRyYW5zY2x1ZGVGbihzY29wZSwgY2hpbGRUcmFuc2NsdWRlRm4gfHwgdHJhbnNjbHVkZUZuKQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbm9kZUxpbmtGbihjaGlsZExpbmtGbiwgY2hpbGRTY29wZSwgbm9kZSwgJHJvb3RFbGVtZW50LCBib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaGlsZExpbmtGbikgewogICAgICAgICAgICAgICAgY2hpbGRMaW5rRm4oc2NvcGUsIG5vZGUuY2hpbGROb2RlcywgdW5kZWZpbmVkLCBib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVCb3VuZFRyYW5zY2x1ZGVGbihzY29wZSwgdHJhbnNjbHVkZUZuKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYm91bmRUcmFuc2NsdWRlRm4odHJhbnNjbHVkZWRTY29wZSwgY2xvbmVGbiwgY29udHJvbGxlcnMpIHsKICAgICAgICAgICAgdmFyIHNjb3BlQ3JlYXRlZCA9IGZhbHNlOwoKICAgICAgICAgICAgaWYgKCF0cmFuc2NsdWRlZFNjb3BlKSB7CiAgICAgICAgICAgICAgdHJhbnNjbHVkZWRTY29wZSA9IHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgICB0cmFuc2NsdWRlZFNjb3BlLiQkdHJhbnNjbHVkZWQgPSB0cnVlOwogICAgICAgICAgICAgIHNjb3BlQ3JlYXRlZCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBjbG9uZSA9IHRyYW5zY2x1ZGVGbih0cmFuc2NsdWRlZFNjb3BlLCBjbG9uZUZuLCBjb250cm9sbGVycyk7CiAgICAgICAgICAgIGlmIChzY29wZUNyZWF0ZWQpIHsKICAgICAgICAgICAgICBjbG9uZS5vbignJGRlc3Ryb3knLCBiaW5kKHRyYW5zY2x1ZGVkU2NvcGUsIHRyYW5zY2x1ZGVkU2NvcGUuJGRlc3Ryb3kpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY2xvbmU7CiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogTG9va3MgZm9yIGRpcmVjdGl2ZXMgb24gdGhlIGdpdmVuIG5vZGUgYW5kIGFkZHMgdGhlbSB0byB0aGUgZGlyZWN0aXZlIGNvbGxlY3Rpb24gd2hpY2ggaXMKICAgICAgICAgKiBzb3J0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0gbm9kZSBOb2RlIHRvIHNlYXJjaC4KICAgICAgICAgKiBAcGFyYW0gZGlyZWN0aXZlcyBBbiBhcnJheSB0byB3aGljaCB0aGUgZGlyZWN0aXZlcyBhcmUgYWRkZWQgdG8uIFRoaXMgYXJyYXkgaXMgc29ydGVkIGJlZm9yZQogICAgICAgICAqICAgICAgICB0aGUgZnVuY3Rpb24gcmV0dXJucy4KICAgICAgICAgKiBAcGFyYW0gYXR0cnMgVGhlIHNoYXJlZCBhdHRycyBvYmplY3Qgd2hpY2ggaXMgdXNlZCB0byBwb3B1bGF0ZSB0aGUgbm9ybWFsaXplZCBhdHRyaWJ1dGVzLgogICAgICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbWF4UHJpb3JpdHkgTWF4IGRpcmVjdGl2ZSBwcmlvcml0eS4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjb2xsZWN0RGlyZWN0aXZlcyhub2RlLCBkaXJlY3RpdmVzLCBhdHRycywgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSkgewogICAgICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZSwKICAgICAgICAgICAgYXR0cnNNYXAgPSBhdHRycy4kYXR0ciwKICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgIGNsYXNzTmFtZTsKCiAgICAgICAgICBzd2l0Y2gobm9kZVR5cGUpIHsKICAgICAgICAgICAgY2FzZSAxOiAvKiBFbGVtZW50ICovCiAgICAgICAgICAgICAgLy8gdXNlIHRoZSBub2RlIG5hbWU6IDxkaXJlY3RpdmU+CiAgICAgICAgICAgICAgYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZXMsCiAgICAgICAgICAgICAgICBkaXJlY3RpdmVOb3JtYWxpemUobm9kZU5hbWVfKG5vZGUpLnRvTG93ZXJDYXNlKCkpLCAnRScsIG1heFByaW9yaXR5LCBpZ25vcmVEaXJlY3RpdmUpOwoKICAgICAgICAgICAgICAvLyBpdGVyYXRlIG92ZXIgdGhlIGF0dHJpYnV0ZXMKICAgICAgICAgICAgICBmb3IgKHZhciBhdHRyLCBuYW1lLCBuTmFtZSwgbmdBdHRyTmFtZSwgdmFsdWUsIG5BdHRycyA9IG5vZGUuYXR0cmlidXRlcywKICAgICAgICAgICAgICAgICAgICAgaiA9IDAsIGpqID0gbkF0dHJzICYmIG5BdHRycy5sZW5ndGg7IGogPCBqajsgaisrKSB7CiAgICAgICAgICAgICAgICB2YXIgYXR0clN0YXJ0TmFtZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdmFyIGF0dHJFbmROYW1lID0gZmFsc2U7CgogICAgICAgICAgICAgICAgYXR0ciA9IG5BdHRyc1tqXTsKICAgICAgICAgICAgICAgIGlmICghbXNpZSB8fCBtc2llID49IDggfHwgYXR0ci5zcGVjaWZpZWQpIHsKICAgICAgICAgICAgICAgICAgbmFtZSA9IGF0dHIubmFtZTsKICAgICAgICAgICAgICAgICAgLy8gc3VwcG9ydCBuZ0F0dHIgYXR0cmlidXRlIGJpbmRpbmcKICAgICAgICAgICAgICAgICAgbmdBdHRyTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lKTsKICAgICAgICAgICAgICAgICAgaWYgKE5HX0FUVFJfQklORElORy50ZXN0KG5nQXR0ck5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgbmFtZSA9IHNuYWtlX2Nhc2UobmdBdHRyTmFtZS5zdWJzdHIoNiksICctJyk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHZhciBkaXJlY3RpdmVOTmFtZSA9IG5nQXR0ck5hbWUucmVwbGFjZSgvKFN0YXJ0fEVuZCkkLywgJycpOwogICAgICAgICAgICAgICAgICBpZiAobmdBdHRyTmFtZSA9PT0gZGlyZWN0aXZlTk5hbWUgKyAnU3RhcnQnKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0clN0YXJ0TmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgICAgYXR0ckVuZE5hbWUgPSBuYW1lLnN1YnN0cigwLCBuYW1lLmxlbmd0aCAtIDUpICsgJ2VuZCc7CiAgICAgICAgICAgICAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyKDAsIG5hbWUubGVuZ3RoIC0gNik7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgIGF0dHJzTWFwW25OYW1lXSA9IG5hbWU7CiAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHZhbHVlID0gdHJpbShhdHRyLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgaWYgKGdldEJvb2xlYW5BdHRyTmFtZShub2RlLCBuTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB0cnVlOyAvLyBwcmVzZW5jZSBtZWFucyB0cnVlCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYWRkQXR0ckludGVycG9sYXRlRGlyZWN0aXZlKG5vZGUsIGRpcmVjdGl2ZXMsIHZhbHVlLCBuTmFtZSk7CiAgICAgICAgICAgICAgICAgIGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ0EnLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlLCBhdHRyU3RhcnROYW1lLAogICAgICAgICAgICAgICAgICAgIGF0dHJFbmROYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIHVzZSBjbGFzcyBhcyBkaXJlY3RpdmUKICAgICAgICAgICAgICBjbGFzc05hbWUgPSBub2RlLmNsYXNzTmFtZTsKICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcoY2xhc3NOYW1lKSAmJiBjbGFzc05hbWUgIT09ICcnKSB7CiAgICAgICAgICAgICAgICB3aGlsZSAobWF0Y2ggPSBDTEFTU19ESVJFQ1RJVkVfUkVHRVhQLmV4ZWMoY2xhc3NOYW1lKSkgewogICAgICAgICAgICAgICAgICBuTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZShtYXRjaFsyXSk7CiAgICAgICAgICAgICAgICAgIGlmIChhZGREaXJlY3RpdmUoZGlyZWN0aXZlcywgbk5hbWUsICdDJywgbWF4UHJpb3JpdHksIGlnbm9yZURpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyc1tuTmFtZV0gPSB0cmltKG1hdGNoWzNdKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWUuc3Vic3RyKG1hdGNoLmluZGV4ICsgbWF0Y2hbMF0ubGVuZ3RoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMzogLyogVGV4dCBOb2RlICovCiAgICAgICAgICAgICAgYWRkVGV4dEludGVycG9sYXRlRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIG5vZGUubm9kZVZhbHVlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSA4OiAvKiBDb21tZW50ICovCiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG1hdGNoID0gQ09NTUVOVF9ESVJFQ1RJVkVfUkVHRVhQLmV4ZWMobm9kZS5ub2RlVmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICAgIG5OYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKG1hdGNoWzFdKTsKICAgICAgICAgICAgICAgICAgaWYgKGFkZERpcmVjdGl2ZShkaXJlY3RpdmVzLCBuTmFtZSwgJ00nLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlKSkgewogICAgICAgICAgICAgICAgICAgIGF0dHJzW25OYW1lXSA9IHRyaW0obWF0Y2hbMl0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgLy8gdHVybnMgb3V0IHRoYXQgdW5kZXIgc29tZSBjaXJjdW1zdGFuY2VzIElFOSB0aHJvd3MgZXJyb3JzIHdoZW4gb25lIGF0dGVtcHRzIHRvIHJlYWQKICAgICAgICAgICAgICAgIC8vIGNvbW1lbnQncyBub2RlIHZhbHVlLgogICAgICAgICAgICAgICAgLy8gSnVzdCBpZ25vcmUgaXQgYW5kIGNvbnRpbnVlLiAoQ2FuJ3Qgc2VlbSB0byByZXByb2R1Y2UgaW4gdGVzdCBjYXNlLikKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgZGlyZWN0aXZlcy5zb3J0KGJ5UHJpb3JpdHkpOwogICAgICAgICAgcmV0dXJuIGRpcmVjdGl2ZXM7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBHaXZlbiBhIG5vZGUgd2l0aCBhbiBkaXJlY3RpdmUtc3RhcnQgaXQgY29sbGVjdHMgYWxsIG9mIHRoZSBzaWJsaW5ncyB1bnRpbCBpdCBmaW5kcwogICAgICAgICAqIGRpcmVjdGl2ZS1lbmQuCiAgICAgICAgICogQHBhcmFtIG5vZGUKICAgICAgICAgKiBAcGFyYW0gYXR0clN0YXJ0CiAgICAgICAgICogQHBhcmFtIGF0dHJFbmQKICAgICAgICAgKiBAcmV0dXJucyB7Kn0KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBncm91cFNjYW4obm9kZSwgYXR0clN0YXJ0LCBhdHRyRW5kKSB7CiAgICAgICAgICB2YXIgbm9kZXMgPSBbXTsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICBpZiAoYXR0clN0YXJ0ICYmIG5vZGUuaGFzQXR0cmlidXRlICYmIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJTdGFydCkpIHsKICAgICAgICAgICAgdmFyIHN0YXJ0Tm9kZSA9IG5vZGU7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCd1dGVyZGlyJywKICAgICAgICAgICAgICAgICAgIlVudGVybWluYXRlZCBhdHRyaWJ1dGUsIGZvdW5kICd7MH0nIGJ1dCBubyBtYXRjaGluZyAnezF9JyBmb3VuZC4iLAogICAgICAgICAgICAgICAgICBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAxIC8qKiBFbGVtZW50ICoqLykgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJTdGFydCkpIGRlcHRoKys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGUoYXR0ckVuZCkpIGRlcHRoLS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGVzLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0gd2hpbGUgKGRlcHRoID4gMCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBub2Rlcy5wdXNoKG5vZGUpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBqcUxpdGUobm9kZXMpOwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogV3JhcHBlciBmb3IgbGlua2luZyBmdW5jdGlvbiB3aGljaCBjb252ZXJ0cyBub3JtYWwgbGlua2luZyBmdW5jdGlvbiBpbnRvIGEgZ3JvdXBlZAogICAgICAgICAqIGxpbmtpbmcgZnVuY3Rpb24uCiAgICAgICAgICogQHBhcmFtIGxpbmtGbgogICAgICAgICAqIEBwYXJhbSBhdHRyU3RhcnQKICAgICAgICAgKiBAcGFyYW0gYXR0ckVuZAogICAgICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBncm91cEVsZW1lbnRzTGlua0ZuV3JhcHBlcihsaW5rRm4sIGF0dHJTdGFydCwgYXR0ckVuZCkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycywgY29udHJvbGxlcnMsIHRyYW5zY2x1ZGVGbikgewogICAgICAgICAgICBlbGVtZW50ID0gZ3JvdXBTY2FuKGVsZW1lbnRbMF0sIGF0dHJTdGFydCwgYXR0ckVuZCk7CiAgICAgICAgICAgIHJldHVybiBsaW5rRm4oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjb250cm9sbGVycywgdHJhbnNjbHVkZUZuKTsKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBPbmNlIHRoZSBkaXJlY3RpdmVzIGhhdmUgYmVlbiBjb2xsZWN0ZWQsIHRoZWlyIGNvbXBpbGUgZnVuY3Rpb25zIGFyZSBleGVjdXRlZC4gVGhpcyBtZXRob2QKICAgICAgICAgKiBpcyByZXNwb25zaWJsZSBmb3IgaW5saW5pbmcgZGlyZWN0aXZlIHRlbXBsYXRlcyBhcyB3ZWxsIGFzIHRlcm1pbmF0aW5nIHRoZSBhcHBsaWNhdGlvbgogICAgICAgICAqIG9mIHRoZSBkaXJlY3RpdmVzIGlmIHRoZSB0ZXJtaW5hbCBkaXJlY3RpdmUgaGFzIGJlZW4gcmVhY2hlZC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7QXJyYXl9IGRpcmVjdGl2ZXMgQXJyYXkgb2YgY29sbGVjdGVkIGRpcmVjdGl2ZXMgdG8gZXhlY3V0ZSB0aGVpciBjb21waWxlIGZ1bmN0aW9uLgogICAgICAgICAqICAgICAgICB0aGlzIG5lZWRzIHRvIGJlIHByZS1zb3J0ZWQgYnkgcHJpb3JpdHkgb3JkZXIuCiAgICAgICAgICogQHBhcmFtIHtOb2RlfSBjb21waWxlTm9kZSBUaGUgcmF3IERPTSBub2RlIHRvIGFwcGx5IHRoZSBjb21waWxlIGZ1bmN0aW9ucyB0bwogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0ZW1wbGF0ZUF0dHJzIFRoZSBzaGFyZWQgYXR0cmlidXRlIGZ1bmN0aW9uCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihhbmd1bGFyLlNjb3BlLCBjbG9uZUF0dGFjaEZuPSl9IHRyYW5zY2x1ZGVGbiBBIGxpbmtpbmcgZnVuY3Rpb24sIHdoZXJlIHRoZQogICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZSBhcmd1bWVudCBpcyBhdXRvLWdlbmVyYXRlZCB0byB0aGUgbmV3CiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkIG9mIHRoZSB0cmFuc2NsdWRlZCBwYXJlbnQgc2NvcGUuCiAgICAgICAgICogQHBhcmFtIHtKUUxpdGV9IGpxQ29sbGVjdGlvbiBJZiB3ZSBhcmUgd29ya2luZyBvbiB0aGUgcm9vdCBvZiB0aGUgY29tcGlsZSB0cmVlIHRoZW4gdGhpcwogICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJndW1lbnQgaGFzIHRoZSByb290IGpxTGl0ZSBhcnJheSBzbyB0aGF0IHdlIGNhbiByZXBsYWNlIG5vZGVzCiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbiBpdC4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IG9yaWdpbmFsUmVwbGFjZURpcmVjdGl2ZSBBbiBvcHRpb25hbCBkaXJlY3RpdmUgdGhhdCB3aWxsIGJlIGlnbm9yZWQgd2hlbgogICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGluZyB0aGUgdHJhbnNjbHVzaW9uLgogICAgICAgICAqIEBwYXJhbSB7QXJyYXkuPEZ1bmN0aW9uPn0gcHJlTGlua0ZucwogICAgICAgICAqIEBwYXJhbSB7QXJyYXkuPEZ1bmN0aW9uPn0gcG9zdExpbmtGbnMKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcHJldmlvdXNDb21waWxlQ29udGV4dCBDb250ZXh0IHVzZWQgZm9yIHByZXZpb3VzIGNvbXBpbGF0aW9uIG9mIHRoZSBjdXJyZW50CiAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZQogICAgICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gbGlua0ZuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gYXBwbHlEaXJlY3RpdmVzVG9Ob2RlKGRpcmVjdGl2ZXMsIGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCB0cmFuc2NsdWRlRm4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpxQ29sbGVjdGlvbiwgb3JpZ2luYWxSZXBsYWNlRGlyZWN0aXZlLCBwcmVMaW5rRm5zLCBwb3N0TGlua0ZucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dCkgewogICAgICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dCA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQgfHwge307CgogICAgICAgICAgdmFyIHRlcm1pbmFsUHJpb3JpdHkgPSAtTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICAgICAgbmV3U2NvcGVEaXJlY3RpdmUsCiAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzID0gcHJldmlvdXNDb21waWxlQ29udGV4dC5jb250cm9sbGVyRGlyZWN0aXZlcywKICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlID0gcHJldmlvdXNDb21waWxlQ29udGV4dC5uZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUsCiAgICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID0gcHJldmlvdXNDb21waWxlQ29udGV4dC50ZW1wbGF0ZURpcmVjdGl2ZSwKICAgICAgICAgICAgbm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZSA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQubm9uVGxiVHJhbnNjbHVkZURpcmVjdGl2ZSwKICAgICAgICAgICAgaGFzVHJhbnNjbHVkZURpcmVjdGl2ZSA9IGZhbHNlLAogICAgICAgICAgICBoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSA9IHByZXZpb3VzQ29tcGlsZUNvbnRleHQuaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUsCiAgICAgICAgICAgICRjb21waWxlTm9kZSA9IHRlbXBsYXRlQXR0cnMuJCRlbGVtZW50ID0ganFMaXRlKGNvbXBpbGVOb2RlKSwKICAgICAgICAgICAgZGlyZWN0aXZlLAogICAgICAgICAgICBkaXJlY3RpdmVOYW1lLAogICAgICAgICAgICAkdGVtcGxhdGUsCiAgICAgICAgICAgIHJlcGxhY2VEaXJlY3RpdmUgPSBvcmlnaW5hbFJlcGxhY2VEaXJlY3RpdmUsCiAgICAgICAgICAgIGNoaWxkVHJhbnNjbHVkZUZuID0gdHJhbnNjbHVkZUZuLAogICAgICAgICAgICBsaW5rRm4sCiAgICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlOwoKICAgICAgICAgIC8vIGV4ZWN1dGVzIGFsbCBkaXJlY3RpdmVzIG9uIHRoZSBjdXJyZW50IGVsZW1lbnQKICAgICAgICAgIGZvcih2YXIgaSA9IDAsIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgIHZhciBhdHRyU3RhcnQgPSBkaXJlY3RpdmUuJCRzdGFydDsKICAgICAgICAgICAgdmFyIGF0dHJFbmQgPSBkaXJlY3RpdmUuJCRlbmQ7CgogICAgICAgICAgICAvLyBjb2xsZWN0IG11bHRpYmxvY2sgc2VjdGlvbnMKICAgICAgICAgICAgaWYgKGF0dHJTdGFydCkgewogICAgICAgICAgICAgICRjb21waWxlTm9kZSA9IGdyb3VwU2Nhbihjb21waWxlTm9kZSwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkdGVtcGxhdGUgPSB1bmRlZmluZWQ7CgogICAgICAgICAgICBpZiAodGVybWluYWxQcmlvcml0eSA+IGRpcmVjdGl2ZS5wcmlvcml0eSkgewogICAgICAgICAgICAgIGJyZWFrOyAvLyBwcmV2ZW50IGZ1cnRoZXIgcHJvY2Vzc2luZyBvZiBkaXJlY3RpdmVzCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS5zY29wZSkgewogICAgICAgICAgICAgIG5ld1Njb3BlRGlyZWN0aXZlID0gbmV3U2NvcGVEaXJlY3RpdmUgfHwgZGlyZWN0aXZlOwoKICAgICAgICAgICAgICAvLyBza2lwIHRoZSBjaGVjayBmb3IgZGlyZWN0aXZlcyB3aXRoIGFzeW5jIHRlbXBsYXRlcywgd2UnbGwgY2hlY2sgdGhlIGRlcml2ZWQgc3luYwogICAgICAgICAgICAgIC8vIGRpcmVjdGl2ZSB3aGVuIHRoZSB0ZW1wbGF0ZSBhcnJpdmVzCiAgICAgICAgICAgICAgaWYgKCFkaXJlY3RpdmUudGVtcGxhdGVVcmwpIHsKICAgICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCduZXcvaXNvbGF0ZWQgc2NvcGUnLCBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwKICAgICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgIGlmIChpc09iamVjdChkaXJlY3RpdmVWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGlyZWN0aXZlTmFtZSA9IGRpcmVjdGl2ZS5uYW1lOwoKICAgICAgICAgICAgaWYgKCFkaXJlY3RpdmUudGVtcGxhdGVVcmwgJiYgZGlyZWN0aXZlLmNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZSA9IGRpcmVjdGl2ZS5jb250cm9sbGVyOwogICAgICAgICAgICAgIGNvbnRyb2xsZXJEaXJlY3RpdmVzID0gY29udHJvbGxlckRpcmVjdGl2ZXMgfHwge307CiAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoIiciICsgZGlyZWN0aXZlTmFtZSArICInIGNvbnRyb2xsZXIiLAogICAgICAgICAgICAgICAgY29udHJvbGxlckRpcmVjdGl2ZXNbZGlyZWN0aXZlTmFtZV0sIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSA9IGRpcmVjdGl2ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZVZhbHVlID0gZGlyZWN0aXZlLnRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgICBoYXNUcmFuc2NsdWRlRGlyZWN0aXZlID0gdHJ1ZTsKCiAgICAgICAgICAgICAgLy8gU3BlY2lhbCBjYXNlIG5nSWYgYW5kIG5nUmVwZWF0IHNvIHRoYXQgd2UgZG9uJ3QgY29tcGxhaW4gYWJvdXQgZHVwbGljYXRlIHRyYW5zY2x1c2lvbi4KICAgICAgICAgICAgICAvLyBUaGlzIG9wdGlvbiBzaG91bGQgb25seSBiZSB1c2VkIGJ5IGRpcmVjdGl2ZXMgdGhhdCBrbm93IGhvdyB0byBzYWZlbHkgaGFuZGxlIGVsZW1lbnQgdHJhbnNjbHVzaW9uLAogICAgICAgICAgICAgIC8vIHdoZXJlIHRoZSB0cmFuc2NsdWRlZCBub2RlcyBhcmUgYWRkZWQgb3IgcmVwbGFjZWQgYWZ0ZXIgbGlua2luZy4KICAgICAgICAgICAgICBpZiAoIWRpcmVjdGl2ZS4kJHRsYikgewogICAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RyYW5zY2x1c2lvbicsIG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgIG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlVmFsdWUgPT0gJ2VsZW1lbnQnKSB7CiAgICAgICAgICAgICAgICBoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0ZXJtaW5hbFByaW9yaXR5ID0gZGlyZWN0aXZlLnByaW9yaXR5OwogICAgICAgICAgICAgICAgJHRlbXBsYXRlID0gZ3JvdXBTY2FuKGNvbXBpbGVOb2RlLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlID0gdGVtcGxhdGVBdHRycy4kJGVsZW1lbnQgPQogICAgICAgICAgICAgICAgICBqcUxpdGUoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnICcgKyBkaXJlY3RpdmVOYW1lICsgJzogJyArCiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGVBdHRyc1tkaXJlY3RpdmVOYW1lXSArICcgJykpOwogICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkY29tcGlsZU5vZGVbMF07CiAgICAgICAgICAgICAgICByZXBsYWNlV2l0aChqcUNvbGxlY3Rpb24sIGpxTGl0ZShzbGljZUFyZ3MoJHRlbXBsYXRlKSksIGNvbXBpbGVOb2RlKTsKCiAgICAgICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IGNvbXBpbGUoJHRlbXBsYXRlLCB0cmFuc2NsdWRlRm4sIHRlcm1pbmFsUHJpb3JpdHksCiAgICAgICAgICAgICAgICAgICAgcmVwbGFjZURpcmVjdGl2ZSAmJiByZXBsYWNlRGlyZWN0aXZlLm5hbWUsIHsKICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBwYXNzIGluOgogICAgICAgICAgICAgICAgICAgIC8vIC0gY29udHJvbGxlckRpcmVjdGl2ZXMgLSBvdGhlcndpc2Ugd2UnbGwgY3JlYXRlIGR1cGxpY2F0ZXMgY29udHJvbGxlcnMKICAgICAgICAgICAgICAgICAgICAvLyAtIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSBvciB0ZW1wbGF0ZURpcmVjdGl2ZSAtIGNvbWJpbmluZyB0ZW1wbGF0ZXMgd2l0aAogICAgICAgICAgICAgICAgICAgIC8vICAgZWxlbWVudCB0cmFuc2NsdXNpb24gZG9lc24ndCBtYWtlIHNlbnNlLgogICAgICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAgICAgLy8gV2UgbmVlZCBvbmx5IG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUgc28gdGhhdCB3ZSBwcmV2ZW50IHB1dHRpbmcgdHJhbnNjbHVzaW9uCiAgICAgICAgICAgICAgICAgICAgLy8gb24gdGhlIHNhbWUgZWxlbWVudCBtb3JlIHRoYW4gb25jZS4KICAgICAgICAgICAgICAgICAgICBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlOiBub25UbGJUcmFuc2NsdWRlRGlyZWN0aXZlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUoanFMaXRlQ2xvbmUoY29tcGlsZU5vZGUpKS5jb250ZW50cygpOwogICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmVtcHR5KCk7IC8vIGNsZWFyIGNvbnRlbnRzCiAgICAgICAgICAgICAgICBjaGlsZFRyYW5zY2x1ZGVGbiA9IGNvbXBpbGUoJHRlbXBsYXRlLCB0cmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZS50ZW1wbGF0ZSkgewogICAgICAgICAgICAgIGFzc2VydE5vRHVwbGljYXRlKCd0ZW1wbGF0ZScsIHRlbXBsYXRlRGlyZWN0aXZlLCBkaXJlY3RpdmUsICRjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgdGVtcGxhdGVEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CgogICAgICAgICAgICAgIGRpcmVjdGl2ZVZhbHVlID0gKGlzRnVuY3Rpb24oZGlyZWN0aXZlLnRlbXBsYXRlKSkKICAgICAgICAgICAgICAgID8gZGlyZWN0aXZlLnRlbXBsYXRlKCRjb21waWxlTm9kZSwgdGVtcGxhdGVBdHRycykKICAgICAgICAgICAgICAgIDogZGlyZWN0aXZlLnRlbXBsYXRlOwoKICAgICAgICAgICAgICBkaXJlY3RpdmVWYWx1ZSA9IGRlbm9ybWFsaXplVGVtcGxhdGUoZGlyZWN0aXZlVmFsdWUpOwoKICAgICAgICAgICAgICBpZiAoZGlyZWN0aXZlLnJlcGxhY2UpIHsKICAgICAgICAgICAgICAgIHJlcGxhY2VEaXJlY3RpdmUgPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICBpZiAoanFMaXRlSXNUZXh0Tm9kZShkaXJlY3RpdmVWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlID0gW107CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAkdGVtcGxhdGUgPSBqcUxpdGUodHJpbShkaXJlY3RpdmVWYWx1ZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkdGVtcGxhdGVbMF07CgogICAgICAgICAgICAgICAgaWYgKCR0ZW1wbGF0ZS5sZW5ndGggIT0gMSB8fCBjb21waWxlTm9kZS5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndHBscnQnLAogICAgICAgICAgICAgICAgICAgICJUZW1wbGF0ZSBmb3IgZGlyZWN0aXZlICd7MH0nIG11c3QgaGF2ZSBleGFjdGx5IG9uZSByb290IGVsZW1lbnQuIHsxfSIsCiAgICAgICAgICAgICAgICAgICAgZGlyZWN0aXZlTmFtZSwgJycpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKGpxQ29sbGVjdGlvbiwgJGNvbXBpbGVOb2RlLCBjb21waWxlTm9kZSk7CgogICAgICAgICAgICAgICAgdmFyIG5ld1RlbXBsYXRlQXR0cnMgPSB7JGF0dHI6IHt9fTsKCiAgICAgICAgICAgICAgICAvLyBjb21iaW5lIGRpcmVjdGl2ZXMgZnJvbSB0aGUgb3JpZ2luYWwgbm9kZSBhbmQgZnJvbSB0aGUgdGVtcGxhdGU6CiAgICAgICAgICAgICAgICAvLyAtIHRha2UgdGhlIGFycmF5IG9mIGRpcmVjdGl2ZXMgZm9yIHRoaXMgZWxlbWVudAogICAgICAgICAgICAgICAgLy8gLSBzcGxpdCBpdCBpbnRvIHR3byBwYXJ0cywgdGhvc2UgdGhhdCBhbHJlYWR5IGFwcGxpZWQgKHByb2Nlc3NlZCkgYW5kIHRob3NlIHRoYXQgd2VyZW4ndCAodW5wcm9jZXNzZWQpCiAgICAgICAgICAgICAgICAvLyAtIGNvbGxlY3QgZGlyZWN0aXZlcyBmcm9tIHRoZSB0ZW1wbGF0ZSBhbmQgc29ydCB0aGVtIGJ5IHByaW9yaXR5CiAgICAgICAgICAgICAgICAvLyAtIGNvbWJpbmUgZGlyZWN0aXZlcyBhczogcHJvY2Vzc2VkICsgdGVtcGxhdGUgKyB1bnByb2Nlc3NlZAogICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlRGlyZWN0aXZlcyA9IGNvbGxlY3REaXJlY3RpdmVzKGNvbXBpbGVOb2RlLCBbXSwgbmV3VGVtcGxhdGVBdHRycyk7CiAgICAgICAgICAgICAgICB2YXIgdW5wcm9jZXNzZWREaXJlY3RpdmVzID0gZGlyZWN0aXZlcy5zcGxpY2UoaSArIDEsIGRpcmVjdGl2ZXMubGVuZ3RoIC0gKGkgKyAxKSk7CgogICAgICAgICAgICAgICAgaWYgKG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSkgewogICAgICAgICAgICAgICAgICBtYXJrRGlyZWN0aXZlc0FzSXNvbGF0ZSh0ZW1wbGF0ZURpcmVjdGl2ZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlyZWN0aXZlcyA9IGRpcmVjdGl2ZXMuY29uY2F0KHRlbXBsYXRlRGlyZWN0aXZlcykuY29uY2F0KHVucHJvY2Vzc2VkRGlyZWN0aXZlcyk7CiAgICAgICAgICAgICAgICBtZXJnZVRlbXBsYXRlQXR0cmlidXRlcyh0ZW1wbGF0ZUF0dHJzLCBuZXdUZW1wbGF0ZUF0dHJzKTsKCiAgICAgICAgICAgICAgICBpaSA9IGRpcmVjdGl2ZXMubGVuZ3RoOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkY29tcGlsZU5vZGUuaHRtbChkaXJlY3RpdmVWYWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGlyZWN0aXZlLnRlbXBsYXRlVXJsKSB7CiAgICAgICAgICAgICAgYXNzZXJ0Tm9EdXBsaWNhdGUoJ3RlbXBsYXRlJywgdGVtcGxhdGVEaXJlY3RpdmUsIGRpcmVjdGl2ZSwgJGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZSA9IGRpcmVjdGl2ZTsKCiAgICAgICAgICAgICAgaWYgKGRpcmVjdGl2ZS5yZXBsYWNlKSB7CiAgICAgICAgICAgICAgICByZXBsYWNlRGlyZWN0aXZlID0gZGlyZWN0aXZlOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgbm9kZUxpbmtGbiA9IGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLnNwbGljZShpLCBkaXJlY3RpdmVzLmxlbmd0aCAtIGkpLCAkY29tcGlsZU5vZGUsCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZUF0dHJzLCBqcUNvbGxlY3Rpb24sIGNoaWxkVHJhbnNjbHVkZUZuLCBwcmVMaW5rRm5zLCBwb3N0TGlua0ZucywgewogICAgICAgICAgICAgICAgICBjb250cm9sbGVyRGlyZWN0aXZlczogY29udHJvbGxlckRpcmVjdGl2ZXMsCiAgICAgICAgICAgICAgICAgIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZTogbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLAogICAgICAgICAgICAgICAgICB0ZW1wbGF0ZURpcmVjdGl2ZTogdGVtcGxhdGVEaXJlY3RpdmUsCiAgICAgICAgICAgICAgICAgIG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmU6IG5vblRsYlRyYW5zY2x1ZGVEaXJlY3RpdmUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlpID0gZGlyZWN0aXZlcy5sZW5ndGg7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZGlyZWN0aXZlLmNvbXBpbGUpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgbGlua0ZuID0gZGlyZWN0aXZlLmNvbXBpbGUoJGNvbXBpbGVOb2RlLCB0ZW1wbGF0ZUF0dHJzLCBjaGlsZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihsaW5rRm4pKSB7CiAgICAgICAgICAgICAgICAgIGFkZExpbmtGbnMobnVsbCwgbGlua0ZuLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChsaW5rRm4pIHsKICAgICAgICAgICAgICAgICAgYWRkTGlua0ZucyhsaW5rRm4ucHJlLCBsaW5rRm4ucG9zdCwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlLCBzdGFydGluZ1RhZygkY29tcGlsZU5vZGUpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaXJlY3RpdmUudGVybWluYWwpIHsKICAgICAgICAgICAgICBub2RlTGlua0ZuLnRlcm1pbmFsID0gdHJ1ZTsKICAgICAgICAgICAgICB0ZXJtaW5hbFByaW9yaXR5ID0gTWF0aC5tYXgodGVybWluYWxQcmlvcml0eSwgZGlyZWN0aXZlLnByaW9yaXR5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0KCiAgICAgICAgICBub2RlTGlua0ZuLnNjb3BlID0gbmV3U2NvcGVEaXJlY3RpdmUgJiYgbmV3U2NvcGVEaXJlY3RpdmUuc2NvcGUgPT09IHRydWU7CiAgICAgICAgICBub2RlTGlua0ZuLnRyYW5zY2x1ZGUgPSBoYXNUcmFuc2NsdWRlRGlyZWN0aXZlICYmIGNoaWxkVHJhbnNjbHVkZUZuOwogICAgICAgICAgcHJldmlvdXNDb21waWxlQ29udGV4dC5oYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSA9IGhhc0VsZW1lbnRUcmFuc2NsdWRlRGlyZWN0aXZlOwoKICAgICAgICAgIC8vIG1pZ2h0IGJlIG5vcm1hbCBvciBkZWxheWVkIG5vZGVMaW5rRm4gZGVwZW5kaW5nIG9uIGlmIHRlbXBsYXRlVXJsIGlzIHByZXNlbnQKICAgICAgICAgIHJldHVybiBub2RlTGlua0ZuOwoKICAgICAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgICAgICAgZnVuY3Rpb24gYWRkTGlua0ZucyhwcmUsIHBvc3QsIGF0dHJTdGFydCwgYXR0ckVuZCkgewogICAgICAgICAgICBpZiAocHJlKSB7CiAgICAgICAgICAgICAgaWYgKGF0dHJTdGFydCkgcHJlID0gZ3JvdXBFbGVtZW50c0xpbmtGbldyYXBwZXIocHJlLCBhdHRyU3RhcnQsIGF0dHJFbmQpOwogICAgICAgICAgICAgIHByZS5yZXF1aXJlID0gZGlyZWN0aXZlLnJlcXVpcmU7CiAgICAgICAgICAgICAgcHJlLmRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmVOYW1lOwogICAgICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPT09IGRpcmVjdGl2ZSB8fCBkaXJlY3RpdmUuJCRpc29sYXRlU2NvcGUpIHsKICAgICAgICAgICAgICAgIHByZSA9IGNsb25lQW5kQW5ub3RhdGVGbihwcmUsIHtpc29sYXRlU2NvcGU6IHRydWV9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJlTGlua0Zucy5wdXNoKHByZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBvc3QpIHsKICAgICAgICAgICAgICBpZiAoYXR0clN0YXJ0KSBwb3N0ID0gZ3JvdXBFbGVtZW50c0xpbmtGbldyYXBwZXIocG9zdCwgYXR0clN0YXJ0LCBhdHRyRW5kKTsKICAgICAgICAgICAgICBwb3N0LnJlcXVpcmUgPSBkaXJlY3RpdmUucmVxdWlyZTsKICAgICAgICAgICAgICBwb3N0LmRpcmVjdGl2ZU5hbWUgPSBkaXJlY3RpdmVOYW1lOwogICAgICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgPT09IGRpcmVjdGl2ZSB8fCBkaXJlY3RpdmUuJCRpc29sYXRlU2NvcGUpIHsKICAgICAgICAgICAgICAgIHBvc3QgPSBjbG9uZUFuZEFubm90YXRlRm4ocG9zdCwge2lzb2xhdGVTY29wZTogdHJ1ZX0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwb3N0TGlua0Zucy5wdXNoKHBvc3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgoKICAgICAgICAgIGZ1bmN0aW9uIGdldENvbnRyb2xsZXJzKGRpcmVjdGl2ZU5hbWUsIHJlcXVpcmUsICRlbGVtZW50LCBlbGVtZW50Q29udHJvbGxlcnMpIHsKICAgICAgICAgICAgdmFyIHZhbHVlLCByZXRyaWV2YWxNZXRob2QgPSAnZGF0YScsIG9wdGlvbmFsID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChpc1N0cmluZyhyZXF1aXJlKSkgewogICAgICAgICAgICAgIHdoaWxlKCh2YWx1ZSA9IHJlcXVpcmUuY2hhckF0KDApKSA9PSAnXicgfHwgdmFsdWUgPT0gJz8nKSB7CiAgICAgICAgICAgICAgICByZXF1aXJlID0gcmVxdWlyZS5zdWJzdHIoMSk7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gJ14nKSB7CiAgICAgICAgICAgICAgICAgIHJldHJpZXZhbE1ldGhvZCA9ICdpbmhlcml0ZWREYXRhJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG9wdGlvbmFsID0gb3B0aW9uYWwgfHwgdmFsdWUgPT0gJz8nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YWx1ZSA9IG51bGw7CgogICAgICAgICAgICAgIGlmIChlbGVtZW50Q29udHJvbGxlcnMgJiYgcmV0cmlldmFsTWV0aG9kID09PSAnZGF0YScpIHsKICAgICAgICAgICAgICAgIHZhbHVlID0gZWxlbWVudENvbnRyb2xsZXJzW3JlcXVpcmVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlIHx8ICRlbGVtZW50W3JldHJpZXZhbE1ldGhvZF0oJyQnICsgcmVxdWlyZSArICdDb250cm9sbGVyJyk7CgogICAgICAgICAgICAgIGlmICghdmFsdWUgJiYgIW9wdGlvbmFsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignY3RyZXEnLAogICAgICAgICAgICAgICAgICAiQ29udHJvbGxlciAnezB9JywgcmVxdWlyZWQgYnkgZGlyZWN0aXZlICd7MX0nLCBjYW4ndCBiZSBmb3VuZCEiLAogICAgICAgICAgICAgICAgICByZXF1aXJlLCBkaXJlY3RpdmVOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkocmVxdWlyZSkpIHsKICAgICAgICAgICAgICB2YWx1ZSA9IFtdOwogICAgICAgICAgICAgIGZvckVhY2gocmVxdWlyZSwgZnVuY3Rpb24ocmVxdWlyZSkgewogICAgICAgICAgICAgICAgdmFsdWUucHVzaChnZXRDb250cm9sbGVycyhkaXJlY3RpdmVOYW1lLCByZXF1aXJlLCAkZWxlbWVudCwgZWxlbWVudENvbnRyb2xsZXJzKSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQoKCiAgICAgICAgICBmdW5jdGlvbiBub2RlTGlua0ZuKGNoaWxkTGlua0ZuLCBzY29wZSwgbGlua05vZGUsICRyb290RWxlbWVudCwgYm91bmRUcmFuc2NsdWRlRm4pIHsKICAgICAgICAgICAgdmFyIGF0dHJzLCAkZWxlbWVudCwgaSwgaWksIGxpbmtGbiwgY29udHJvbGxlciwgaXNvbGF0ZVNjb3BlLCBlbGVtZW50Q29udHJvbGxlcnMgPSB7fSwgdHJhbnNjbHVkZUZuOwoKICAgICAgICAgICAgaWYgKGNvbXBpbGVOb2RlID09PSBsaW5rTm9kZSkgewogICAgICAgICAgICAgIGF0dHJzID0gdGVtcGxhdGVBdHRyczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhdHRycyA9IHNoYWxsb3dDb3B5KHRlbXBsYXRlQXR0cnMsIG5ldyBBdHRyaWJ1dGVzKGpxTGl0ZShsaW5rTm9kZSksIHRlbXBsYXRlQXR0cnMuJGF0dHIpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkZWxlbWVudCA9IGF0dHJzLiQkZWxlbWVudDsKCiAgICAgICAgICAgIGlmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUpIHsKICAgICAgICAgICAgICB2YXIgTE9DQUxfUkVHRVhQID0gL15ccyooW0A9Jl0pKFw/PylccyooXHcqKVxzKiQvOwogICAgICAgICAgICAgIHZhciAkbGlua05vZGUgPSBqcUxpdGUobGlua05vZGUpOwoKICAgICAgICAgICAgICBpc29sYXRlU2NvcGUgPSBzY29wZS4kbmV3KHRydWUpOwoKICAgICAgICAgICAgICBpZiAodGVtcGxhdGVEaXJlY3RpdmUgJiYgKHRlbXBsYXRlRGlyZWN0aXZlID09PSBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUgfHwKICAgICAgICAgICAgICAgIHRlbXBsYXRlRGlyZWN0aXZlID09PSBuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUuJCRvcmlnaW5hbERpcmVjdGl2ZSkpIHsKICAgICAgICAgICAgICAgICRsaW5rTm9kZS5kYXRhKCckaXNvbGF0ZVNjb3BlJywgaXNvbGF0ZVNjb3BlKSA7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICRsaW5rTm9kZS5kYXRhKCckaXNvbGF0ZVNjb3BlTm9UZW1wbGF0ZScsIGlzb2xhdGVTY29wZSk7CiAgICAgICAgICAgICAgfQoKCgogICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkbGlua05vZGUsICduZy1pc29sYXRlLXNjb3BlJyk7CgogICAgICAgICAgICAgIGZvckVhY2gobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLnNjb3BlLCBmdW5jdGlvbihkZWZpbml0aW9uLCBzY29wZU5hbWUpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IGRlZmluaXRpb24ubWF0Y2goTE9DQUxfUkVHRVhQKSB8fCBbXSwKICAgICAgICAgICAgICAgICAgYXR0ck5hbWUgPSBtYXRjaFszXSB8fCBzY29wZU5hbWUsCiAgICAgICAgICAgICAgICAgIG9wdGlvbmFsID0gKG1hdGNoWzJdID09ICc/JyksCiAgICAgICAgICAgICAgICAgIG1vZGUgPSBtYXRjaFsxXSwgLy8gQCwgPSwgb3IgJgogICAgICAgICAgICAgICAgICBsYXN0VmFsdWUsCiAgICAgICAgICAgICAgICAgIHBhcmVudEdldCwgcGFyZW50U2V0LCBjb21wYXJlOwoKICAgICAgICAgICAgICAgIGlzb2xhdGVTY29wZS4kJGlzb2xhdGVCaW5kaW5nc1tzY29wZU5hbWVdID0gbW9kZSArIGF0dHJOYW1lOwoKICAgICAgICAgICAgICAgIHN3aXRjaCAobW9kZSkgewoKICAgICAgICAgICAgICAgICAgY2FzZSAnQCc6CiAgICAgICAgICAgICAgICAgICAgYXR0cnMuJG9ic2VydmUoYXR0ck5hbWUsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICBpc29sYXRlU2NvcGVbc2NvcGVOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGF0dHJzLiQkb2JzZXJ2ZXJzW2F0dHJOYW1lXS4kJHNjb3BlID0gc2NvcGU7CiAgICAgICAgICAgICAgICAgICAgaWYoIGF0dHJzW2F0dHJOYW1lXSApIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBhdHRyaWJ1dGUgaGFzIGJlZW4gcHJvdmlkZWQgdGhlbiB3ZSB0cmlnZ2VyIGFuIGludGVycG9sYXRpb24gdG8gZW5zdXJlCiAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgdmFsdWUgaXMgdGhlcmUgZm9yIHVzZSBpbiB0aGUgbGluayBmbgogICAgICAgICAgICAgICAgICAgICAgaXNvbGF0ZVNjb3BlW3Njb3BlTmFtZV0gPSAkaW50ZXJwb2xhdGUoYXR0cnNbYXR0ck5hbWVdKShzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgY2FzZSAnPSc6CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbmFsICYmICFhdHRyc1thdHRyTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFyZW50R2V0ID0gJHBhcnNlKGF0dHJzW2F0dHJOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudEdldC5saXRlcmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICBjb21wYXJlID0gZXF1YWxzOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBjb21wYXJlID0gZnVuY3Rpb24oYSxiKSB7IHJldHVybiBhID09PSBiOyB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBwYXJlbnRTZXQgPSBwYXJlbnRHZXQuYXNzaWduIHx8IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgLy8gcmVzZXQgdGhlIGNoYW5nZSwgb3Igd2Ugd2lsbCB0aHJvdyB0aGlzIGV4Y2VwdGlvbiBvbiBldmVyeSAkZGlnZXN0CiAgICAgICAgICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBpc29sYXRlU2NvcGVbc2NvcGVOYW1lXSA9IHBhcmVudEdldChzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignbm9uYXNzaWduJywKICAgICAgICAgICAgICAgICAgICAgICAgIkV4cHJlc3Npb24gJ3swfScgdXNlZCB3aXRoIGRpcmVjdGl2ZSAnezF9JyBpcyBub24tYXNzaWduYWJsZSEiLAogICAgICAgICAgICAgICAgICAgICAgICBhdHRyc1thdHRyTmFtZV0sIG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZS5uYW1lKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGxhc3RWYWx1ZSA9IGlzb2xhdGVTY29wZVtzY29wZU5hbWVdID0gcGFyZW50R2V0KHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICBpc29sYXRlU2NvcGUuJHdhdGNoKGZ1bmN0aW9uIHBhcmVudFZhbHVlV2F0Y2goKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50VmFsdWUgPSBwYXJlbnRHZXQoc2NvcGUpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb21wYXJlKHBhcmVudFZhbHVlLCBpc29sYXRlU2NvcGVbc2NvcGVOYW1lXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIG91dCBvZiBzeW5jIGFuZCBuZWVkIHRvIGNvcHkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb21wYXJlKHBhcmVudFZhbHVlLCBsYXN0VmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGFyZW50IGNoYW5nZWQgYW5kIGl0IGhhcyBwcmVjZWRlbmNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgaXNvbGF0ZVNjb3BlW3Njb3BlTmFtZV0gPSBwYXJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgcGFyZW50IGNhbiBiZSBhc3NpZ25lZCB0aGVuIGRvIHNvCiAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U2V0KHNjb3BlLCBwYXJlbnRWYWx1ZSA9IGlzb2xhdGVTY29wZVtzY29wZU5hbWVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxhc3RWYWx1ZSA9IHBhcmVudFZhbHVlOwogICAgICAgICAgICAgICAgICAgIH0sIG51bGwsIHBhcmVudEdldC5saXRlcmFsKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgIGNhc2UgJyYnOgogICAgICAgICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIGlzb2xhdGVTY29wZVtzY29wZU5hbWVdID0gZnVuY3Rpb24obG9jYWxzKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyZW50R2V0KHNjb3BlLCBsb2NhbHMpOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHRocm93ICRjb21waWxlTWluRXJyKCdpc2NwJywKICAgICAgICAgICAgICAgICAgICAgICAgIkludmFsaWQgaXNvbGF0ZSBzY29wZSBkZWZpbml0aW9uIGZvciBkaXJlY3RpdmUgJ3swfScuIiArCiAgICAgICAgICAgICAgICAgICAgICAgICIgRGVmaW5pdGlvbjogey4uLiB7MX06ICd7Mn0nIC4uLn0iLAogICAgICAgICAgICAgICAgICAgICAgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLm5hbWUsIHNjb3BlTmFtZSwgZGVmaW5pdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJhbnNjbHVkZUZuID0gYm91bmRUcmFuc2NsdWRlRm4gJiYgY29udHJvbGxlcnNCb3VuZFRyYW5zY2x1ZGU7CiAgICAgICAgICAgIGlmIChjb250cm9sbGVyRGlyZWN0aXZlcykgewogICAgICAgICAgICAgIGZvckVhY2goY29udHJvbGxlckRpcmVjdGl2ZXMsIGZ1bmN0aW9uKGRpcmVjdGl2ZSkgewogICAgICAgICAgICAgICAgdmFyIGxvY2FscyA9IHsKICAgICAgICAgICAgICAgICAgJHNjb3BlOiBkaXJlY3RpdmUgPT09IG5ld0lzb2xhdGVTY29wZURpcmVjdGl2ZSB8fCBkaXJlY3RpdmUuJCRpc29sYXRlU2NvcGUgPyBpc29sYXRlU2NvcGUgOiBzY29wZSwKICAgICAgICAgICAgICAgICAgJGVsZW1lbnQ6ICRlbGVtZW50LAogICAgICAgICAgICAgICAgICAkYXR0cnM6IGF0dHJzLAogICAgICAgICAgICAgICAgICAkdHJhbnNjbHVkZTogdHJhbnNjbHVkZUZuCiAgICAgICAgICAgICAgICB9LCBjb250cm9sbGVySW5zdGFuY2U7CgogICAgICAgICAgICAgICAgY29udHJvbGxlciA9IGRpcmVjdGl2ZS5jb250cm9sbGVyOwogICAgICAgICAgICAgICAgaWYgKGNvbnRyb2xsZXIgPT0gJ0AnKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBhdHRyc1tkaXJlY3RpdmUubmFtZV07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29udHJvbGxlckluc3RhbmNlID0gJGNvbnRyb2xsZXIoY29udHJvbGxlciwgbG9jYWxzKTsKICAgICAgICAgICAgICAgIC8vIEZvciBkaXJlY3RpdmVzIHdpdGggZWxlbWVudCB0cmFuc2NsdXNpb24gdGhlIGVsZW1lbnQgaXMgYSBjb21tZW50LAogICAgICAgICAgICAgICAgLy8gYnV0IGpRdWVyeSAuZGF0YSBkb2Vzbid0IHN1cHBvcnQgYXR0YWNoaW5nIGRhdGEgdG8gY29tbWVudCBub2RlcyBhcyBpdCdzIGhhcmQgdG8KICAgICAgICAgICAgICAgIC8vIGNsZWFuIHVwIChodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC84MzM1KS4KICAgICAgICAgICAgICAgIC8vIEluc3RlYWQsIHdlIHNhdmUgdGhlIGNvbnRyb2xsZXJzIGZvciB0aGUgZWxlbWVudCBpbiBhIGxvY2FsIGhhc2ggYW5kIGF0dGFjaCB0byAuZGF0YQogICAgICAgICAgICAgICAgLy8gbGF0ZXIsIG9uY2Ugd2UgaGF2ZSB0aGUgYWN0dWFsIGVsZW1lbnQuCiAgICAgICAgICAgICAgICBlbGVtZW50Q29udHJvbGxlcnNbZGlyZWN0aXZlLm5hbWVdID0gY29udHJvbGxlckluc3RhbmNlOwogICAgICAgICAgICAgICAgaWYgKCFoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSkgewogICAgICAgICAgICAgICAgICAkZWxlbWVudC5kYXRhKCckJyArIGRpcmVjdGl2ZS5uYW1lICsgJ0NvbnRyb2xsZXInLCBjb250cm9sbGVySW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChkaXJlY3RpdmUuY29udHJvbGxlckFzKSB7CiAgICAgICAgICAgICAgICAgIGxvY2Fscy4kc2NvcGVbZGlyZWN0aXZlLmNvbnRyb2xsZXJBc10gPSBjb250cm9sbGVySW5zdGFuY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFBSRUxJTktJTkcKICAgICAgICAgICAgZm9yKGkgPSAwLCBpaSA9IHByZUxpbmtGbnMubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBsaW5rRm4gPSBwcmVMaW5rRm5zW2ldOwogICAgICAgICAgICAgICAgbGlua0ZuKGxpbmtGbi5pc29sYXRlU2NvcGUgPyBpc29sYXRlU2NvcGUgOiBzY29wZSwgJGVsZW1lbnQsIGF0dHJzLAogICAgICAgICAgICAgICAgICAgIGxpbmtGbi5yZXF1aXJlICYmIGdldENvbnRyb2xsZXJzKGxpbmtGbi5kaXJlY3RpdmVOYW1lLCBsaW5rRm4ucmVxdWlyZSwgJGVsZW1lbnQsIGVsZW1lbnRDb250cm9sbGVycyksIHRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSwgc3RhcnRpbmdUYWcoJGVsZW1lbnQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFJFQ1VSU0lPTgogICAgICAgICAgICAvLyBXZSBvbmx5IHBhc3MgdGhlIGlzb2xhdGUgc2NvcGUsIGlmIHRoZSBpc29sYXRlIGRpcmVjdGl2ZSBoYXMgYSB0ZW1wbGF0ZSwKICAgICAgICAgICAgLy8gb3RoZXJ3aXNlIHRoZSBjaGlsZCBlbGVtZW50cyBkbyBub3QgYmVsb25nIHRvIHRoZSBpc29sYXRlIGRpcmVjdGl2ZS4KICAgICAgICAgICAgdmFyIHNjb3BlVG9DaGlsZCA9IHNjb3BlOwogICAgICAgICAgICBpZiAobmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlICYmIChuZXdJc29sYXRlU2NvcGVEaXJlY3RpdmUudGVtcGxhdGUgfHwgbmV3SXNvbGF0ZVNjb3BlRGlyZWN0aXZlLnRlbXBsYXRlVXJsID09PSBudWxsKSkgewogICAgICAgICAgICAgIHNjb3BlVG9DaGlsZCA9IGlzb2xhdGVTY29wZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZExpbmtGbiAmJiBjaGlsZExpbmtGbihzY29wZVRvQ2hpbGQsIGxpbmtOb2RlLmNoaWxkTm9kZXMsIHVuZGVmaW5lZCwgYm91bmRUcmFuc2NsdWRlRm4pOwoKICAgICAgICAgICAgLy8gUE9TVExJTktJTkcKICAgICAgICAgICAgZm9yKGkgPSBwb3N0TGlua0Zucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBsaW5rRm4gPSBwb3N0TGlua0Zuc1tpXTsKICAgICAgICAgICAgICAgIGxpbmtGbihsaW5rRm4uaXNvbGF0ZVNjb3BlID8gaXNvbGF0ZVNjb3BlIDogc2NvcGUsICRlbGVtZW50LCBhdHRycywKICAgICAgICAgICAgICAgICAgICBsaW5rRm4ucmVxdWlyZSAmJiBnZXRDb250cm9sbGVycyhsaW5rRm4uZGlyZWN0aXZlTmFtZSwgbGlua0ZuLnJlcXVpcmUsICRlbGVtZW50LCBlbGVtZW50Q29udHJvbGxlcnMpLCB0cmFuc2NsdWRlRm4pOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUsIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBmdW5jdGlvbiB0aGF0IGlzIGluamVjdGVkIGFzIGAkdHJhbnNjbHVkZWAuCiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbnRyb2xsZXJzQm91bmRUcmFuc2NsdWRlKHNjb3BlLCBjbG9uZUF0dGFjaEZuKSB7CiAgICAgICAgICAgICAgdmFyIHRyYW5zY2x1ZGVDb250cm9sbGVyczsKCiAgICAgICAgICAgICAgLy8gbm8gc2NvcGUgcGFzc2VkCiAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgICAgICBjbG9uZUF0dGFjaEZuID0gc2NvcGU7CiAgICAgICAgICAgICAgICBzY29wZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChoYXNFbGVtZW50VHJhbnNjbHVkZURpcmVjdGl2ZSkgewogICAgICAgICAgICAgICAgdHJhbnNjbHVkZUNvbnRyb2xsZXJzID0gZWxlbWVudENvbnRyb2xsZXJzOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIGJvdW5kVHJhbnNjbHVkZUZuKHNjb3BlLCBjbG9uZUF0dGFjaEZuLCB0cmFuc2NsdWRlQ29udHJvbGxlcnMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBtYXJrRGlyZWN0aXZlc0FzSXNvbGF0ZShkaXJlY3RpdmVzKSB7CiAgICAgICAgICAvLyBtYXJrIGFsbCBkaXJlY3RpdmVzIGFzIG5lZWRpbmcgaXNvbGF0ZSBzY29wZS4KICAgICAgICAgIGZvciAodmFyIGogPSAwLCBqaiA9IGRpcmVjdGl2ZXMubGVuZ3RoOyBqIDwgamo7IGorKykgewogICAgICAgICAgICBkaXJlY3RpdmVzW2pdID0gaW5oZXJpdChkaXJlY3RpdmVzW2pdLCB7JCRpc29sYXRlU2NvcGU6IHRydWV9KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIGxvb2tzIHVwIHRoZSBkaXJlY3RpdmUgYW5kIGRlY29yYXRlcyBpdCB3aXRoIGV4Y2VwdGlvbiBoYW5kbGluZyBhbmQgcHJvcGVyIHBhcmFtZXRlcnMuIFdlCiAgICAgICAgICogY2FsbCB0aGlzIHRoZSBib3VuZERpcmVjdGl2ZS4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIG5hbWUgb2YgdGhlIGRpcmVjdGl2ZSB0byBsb29rIHVwLgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhdGlvbiBUaGUgZGlyZWN0aXZlIG11c3QgYmUgZm91bmQgaW4gc3BlY2lmaWMgZm9ybWF0LgogICAgICAgICAqICAgU3RyaW5nIGNvbnRhaW5pbmcgYW55IG9mIHRoZXNlcyBjaGFyYWN0ZXJzOgogICAgICAgICAqCiAgICAgICAgICogICAqIGBFYDogZWxlbWVudCBuYW1lCiAgICAgICAgICogICAqIGBBJzogYXR0cmlidXRlCiAgICAgICAgICogICAqIGBDYDogY2xhc3MKICAgICAgICAgKiAgICogYE1gOiBjb21tZW50CiAgICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgZGlyZWN0aXZlIHdhcyBhZGRlZC4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBhZGREaXJlY3RpdmUodERpcmVjdGl2ZXMsIG5hbWUsIGxvY2F0aW9uLCBtYXhQcmlvcml0eSwgaWdub3JlRGlyZWN0aXZlLCBzdGFydEF0dHJOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRBdHRyTmFtZSkgewogICAgICAgICAgaWYgKG5hbWUgPT09IGlnbm9yZURpcmVjdGl2ZSkgcmV0dXJuIG51bGw7CiAgICAgICAgICB2YXIgbWF0Y2ggPSBudWxsOwogICAgICAgICAgaWYgKGhhc0RpcmVjdGl2ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgZm9yKHZhciBkaXJlY3RpdmUsIGRpcmVjdGl2ZXMgPSAkaW5qZWN0b3IuZ2V0KG5hbWUgKyBTdWZmaXgpLAogICAgICAgICAgICAgICAgICBpID0gMCwgaWkgPSBkaXJlY3RpdmVzLmxlbmd0aDsgaTxpaTsgaSsrKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGRpcmVjdGl2ZSA9IGRpcmVjdGl2ZXNbaV07CiAgICAgICAgICAgICAgICBpZiAoIChtYXhQcmlvcml0eSA9PT0gdW5kZWZpbmVkIHx8IG1heFByaW9yaXR5ID4gZGlyZWN0aXZlLnByaW9yaXR5KSAmJgogICAgICAgICAgICAgICAgICBkaXJlY3RpdmUucmVzdHJpY3QuaW5kZXhPZihsb2NhdGlvbikgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgaWYgKHN0YXJ0QXR0ck5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBkaXJlY3RpdmUgPSBpbmhlcml0KGRpcmVjdGl2ZSwgeyQkc3RhcnQ6IHN0YXJ0QXR0ck5hbWUsICQkZW5kOiBlbmRBdHRyTmFtZX0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHREaXJlY3RpdmVzLnB1c2goZGlyZWN0aXZlKTsKICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBkaXJlY3RpdmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBjYXRjaChlKSB7ICRleGNlcHRpb25IYW5kbGVyKGUpOyB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICB9CgoKICAgICAgICAvKioKICAgICAgICAgKiBXaGVuIHRoZSBlbGVtZW50IGlzIHJlcGxhY2VkIHdpdGggSFRNTCB0ZW1wbGF0ZSB0aGVuIHRoZSBuZXcgYXR0cmlidXRlcwogICAgICAgICAqIG9uIHRoZSB0ZW1wbGF0ZSBuZWVkIHRvIGJlIG1lcmdlZCB3aXRoIHRoZSBleGlzdGluZyBhdHRyaWJ1dGVzIGluIHRoZSBET00uCiAgICAgICAgICogVGhlIGRlc2lyZWQgZWZmZWN0IGlzIHRvIGhhdmUgYm90aCBvZiB0aGUgYXR0cmlidXRlcyBwcmVzZW50LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGRzdCBkZXN0aW5hdGlvbiBhdHRyaWJ1dGVzIChvcmlnaW5hbCBET00pCiAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IHNyYyBzb3VyY2UgYXR0cmlidXRlcyAoZnJvbSB0aGUgZGlyZWN0aXZlIHRlbXBsYXRlKQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIG1lcmdlVGVtcGxhdGVBdHRyaWJ1dGVzKGRzdCwgc3JjKSB7CiAgICAgICAgICB2YXIgc3JjQXR0ciA9IHNyYy4kYXR0ciwKICAgICAgICAgICAgZHN0QXR0ciA9IGRzdC4kYXR0ciwKICAgICAgICAgICAgJGVsZW1lbnQgPSBkc3QuJCRlbGVtZW50OwoKICAgICAgICAgIC8vIHJlYXBwbHkgdGhlIG9sZCBhdHRyaWJ1dGVzIHRvIHRoZSBuZXcgZWxlbWVudAogICAgICAgICAgZm9yRWFjaChkc3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgaWYgKGtleS5jaGFyQXQoMCkgIT0gJyQnKSB7CiAgICAgICAgICAgICAgaWYgKHNyY1trZXldICYmIHNyY1trZXldICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFsdWUgKz0gKGtleSA9PT0gJ3N0eWxlJyA/ICc7JyA6ICcgJykgKyBzcmNba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZHN0LiRzZXQoa2V5LCB2YWx1ZSwgdHJ1ZSwgc3JjQXR0cltrZXldKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgLy8gY29weSB0aGUgbmV3IGF0dHJpYnV0ZXMgb24gdGhlIG9sZCBhdHRycyBvYmplY3QKICAgICAgICAgIGZvckVhY2goc3JjLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIGlmIChrZXkgPT0gJ2NsYXNzJykgewogICAgICAgICAgICAgIHNhZmVBZGRDbGFzcygkZWxlbWVudCwgdmFsdWUpOwogICAgICAgICAgICAgIGRzdFsnY2xhc3MnXSA9IChkc3RbJ2NsYXNzJ10gPyBkc3RbJ2NsYXNzJ10gKyAnICcgOiAnJykgKyB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT0gJ3N0eWxlJykgewogICAgICAgICAgICAgICRlbGVtZW50LmF0dHIoJ3N0eWxlJywgJGVsZW1lbnQuYXR0cignc3R5bGUnKSArICc7JyArIHZhbHVlKTsKICAgICAgICAgICAgICBkc3RbJ3N0eWxlJ10gPSAoZHN0WydzdHlsZSddID8gZHN0WydzdHlsZSddICsgJzsnIDogJycpICsgdmFsdWU7CiAgICAgICAgICAgICAgLy8gYGRzdGAgd2lsbCBuZXZlciBjb250YWluIGhhc093blByb3BlcnR5IGFzIERPTSBwYXJzZXIgd29uJ3QgbGV0IGl0LgogICAgICAgICAgICAgIC8vIFlvdSB3aWxsIGdldCBhbiAiSW52YWxpZENoYXJhY3RlckVycm9yOiBET00gRXhjZXB0aW9uIDUiIGVycm9yIGlmIHlvdQogICAgICAgICAgICAgIC8vIGhhdmUgYW4gYXR0cmlidXRlIGxpa2UgImhhcy1vd24tcHJvcGVydHkiIG9yICJkYXRhLWhhcy1vd24tcHJvcGVydHkiLCBldGMuCiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5LmNoYXJBdCgwKSAhPSAnJCcgJiYgIWRzdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgZHN0W2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICBkc3RBdHRyW2tleV0gPSBzcmNBdHRyW2tleV07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVUZW1wbGF0ZVVybChkaXJlY3RpdmVzLCAkY29tcGlsZU5vZGUsIHRBdHRycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJvb3RFbGVtZW50LCBjaGlsZFRyYW5zY2x1ZGVGbiwgcHJlTGlua0ZucywgcG9zdExpbmtGbnMsIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpIHsKICAgICAgICAgIHZhciBsaW5rUXVldWUgPSBbXSwKICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4sCiAgICAgICAgICAgIGFmdGVyVGVtcGxhdGVDaGlsZExpbmtGbiwKICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVDb21waWxlTm9kZSA9ICRjb21waWxlTm9kZVswXSwKICAgICAgICAgICAgb3JpZ0FzeW5jRGlyZWN0aXZlID0gZGlyZWN0aXZlcy5zaGlmdCgpLAogICAgICAgICAgLy8gVGhlIGZhY3QgdGhhdCB3ZSBoYXZlIHRvIGNvcHkgYW5kIHBhdGNoIHRoZSBkaXJlY3RpdmUgc2VlbXMgd3JvbmchCiAgICAgICAgICAgIGRlcml2ZWRTeW5jRGlyZWN0aXZlID0gZXh0ZW5kKHt9LCBvcmlnQXN5bmNEaXJlY3RpdmUsIHsKICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogbnVsbCwgdHJhbnNjbHVkZTogbnVsbCwgcmVwbGFjZTogbnVsbCwgJCRvcmlnaW5hbERpcmVjdGl2ZTogb3JpZ0FzeW5jRGlyZWN0aXZlCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICB0ZW1wbGF0ZVVybCA9IChpc0Z1bmN0aW9uKG9yaWdBc3luY0RpcmVjdGl2ZS50ZW1wbGF0ZVVybCkpCiAgICAgICAgICAgICAgPyBvcmlnQXN5bmNEaXJlY3RpdmUudGVtcGxhdGVVcmwoJGNvbXBpbGVOb2RlLCB0QXR0cnMpCiAgICAgICAgICAgICAgOiBvcmlnQXN5bmNEaXJlY3RpdmUudGVtcGxhdGVVcmw7CgogICAgICAgICAgJGNvbXBpbGVOb2RlLmVtcHR5KCk7CgogICAgICAgICAgJGh0dHAuZ2V0KCRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsKHRlbXBsYXRlVXJsKSwge2NhY2hlOiAkdGVtcGxhdGVDYWNoZX0pLgogICAgICAgICAgICBzdWNjZXNzKGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgICAgICAgICB2YXIgY29tcGlsZU5vZGUsIHRlbXBUZW1wbGF0ZUF0dHJzLCAkdGVtcGxhdGUsIGNoaWxkQm91bmRUcmFuc2NsdWRlRm47CgogICAgICAgICAgICAgIGNvbnRlbnQgPSBkZW5vcm1hbGl6ZVRlbXBsYXRlKGNvbnRlbnQpOwoKICAgICAgICAgICAgICBpZiAob3JpZ0FzeW5jRGlyZWN0aXZlLnJlcGxhY2UpIHsKICAgICAgICAgICAgICAgIGlmIChqcUxpdGVJc1RleHROb2RlKGNvbnRlbnQpKSB7CiAgICAgICAgICAgICAgICAgICR0ZW1wbGF0ZSA9IFtdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgJHRlbXBsYXRlID0ganFMaXRlKHRyaW0oY29udGVudCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSAkdGVtcGxhdGVbMF07CgogICAgICAgICAgICAgICAgaWYgKCR0ZW1wbGF0ZS5sZW5ndGggIT0gMSB8fCBjb21waWxlTm9kZS5ub2RlVHlwZSAhPT0gMSkgewogICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycigndHBscnQnLAogICAgICAgICAgICAgICAgICAgICJUZW1wbGF0ZSBmb3IgZGlyZWN0aXZlICd7MH0nIG11c3QgaGF2ZSBleGFjdGx5IG9uZSByb290IGVsZW1lbnQuIHsxfSIsCiAgICAgICAgICAgICAgICAgICAgb3JpZ0FzeW5jRGlyZWN0aXZlLm5hbWUsIHRlbXBsYXRlVXJsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0ZW1wVGVtcGxhdGVBdHRycyA9IHskYXR0cjoge319OwogICAgICAgICAgICAgICAgcmVwbGFjZVdpdGgoJHJvb3RFbGVtZW50LCAkY29tcGlsZU5vZGUsIGNvbXBpbGVOb2RlKTsKICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZURpcmVjdGl2ZXMgPSBjb2xsZWN0RGlyZWN0aXZlcyhjb21waWxlTm9kZSwgW10sIHRlbXBUZW1wbGF0ZUF0dHJzKTsKCiAgICAgICAgICAgICAgICBpZiAoaXNPYmplY3Qob3JpZ0FzeW5jRGlyZWN0aXZlLnNjb3BlKSkgewogICAgICAgICAgICAgICAgICBtYXJrRGlyZWN0aXZlc0FzSXNvbGF0ZSh0ZW1wbGF0ZURpcmVjdGl2ZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlyZWN0aXZlcyA9IHRlbXBsYXRlRGlyZWN0aXZlcy5jb25jYXQoZGlyZWN0aXZlcyk7CiAgICAgICAgICAgICAgICBtZXJnZVRlbXBsYXRlQXR0cmlidXRlcyh0QXR0cnMsIHRlbXBUZW1wbGF0ZUF0dHJzKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tcGlsZU5vZGUgPSBiZWZvcmVUZW1wbGF0ZUNvbXBpbGVOb2RlOwogICAgICAgICAgICAgICAgJGNvbXBpbGVOb2RlLmh0bWwoY29udGVudCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBkaXJlY3RpdmVzLnVuc2hpZnQoZGVyaXZlZFN5bmNEaXJlY3RpdmUpOwoKICAgICAgICAgICAgICBhZnRlclRlbXBsYXRlTm9kZUxpbmtGbiA9IGFwcGx5RGlyZWN0aXZlc1RvTm9kZShkaXJlY3RpdmVzLCBjb21waWxlTm9kZSwgdEF0dHJzLAogICAgICAgICAgICAgICAgY2hpbGRUcmFuc2NsdWRlRm4sICRjb21waWxlTm9kZSwgb3JpZ0FzeW5jRGlyZWN0aXZlLCBwcmVMaW5rRm5zLCBwb3N0TGlua0ZucywKICAgICAgICAgICAgICAgIHByZXZpb3VzQ29tcGlsZUNvbnRleHQpOwogICAgICAgICAgICAgIGZvckVhY2goJHJvb3RFbGVtZW50LCBmdW5jdGlvbihub2RlLCBpKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZSA9PSBjb21waWxlTm9kZSkgewogICAgICAgICAgICAgICAgICAkcm9vdEVsZW1lbnRbaV0gPSAkY29tcGlsZU5vZGVbMF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuID0gY29tcGlsZU5vZGVzKCRjb21waWxlTm9kZVswXS5jaGlsZE5vZGVzLCBjaGlsZFRyYW5zY2x1ZGVGbik7CgoKICAgICAgICAgICAgICB3aGlsZShsaW5rUXVldWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgICAgYmVmb3JlVGVtcGxhdGVMaW5rTm9kZSA9IGxpbmtRdWV1ZS5zaGlmdCgpLAogICAgICAgICAgICAgICAgICBsaW5rUm9vdEVsZW1lbnQgPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgICAgYm91bmRUcmFuc2NsdWRlRm4gPSBsaW5rUXVldWUuc2hpZnQoKSwKICAgICAgICAgICAgICAgICAgbGlua05vZGUgPSAkY29tcGlsZU5vZGVbMF07CgogICAgICAgICAgICAgICAgaWYgKGJlZm9yZVRlbXBsYXRlTGlua05vZGUgIT09IGJlZm9yZVRlbXBsYXRlQ29tcGlsZU5vZGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIG9sZENsYXNzZXMgPSBiZWZvcmVUZW1wbGF0ZUxpbmtOb2RlLmNsYXNzTmFtZTsKCiAgICAgICAgICAgICAgICAgIGlmICghKHByZXZpb3VzQ29tcGlsZUNvbnRleHQuaGFzRWxlbWVudFRyYW5zY2x1ZGVEaXJlY3RpdmUgJiYKICAgICAgICAgICAgICAgICAgICBvcmlnQXN5bmNEaXJlY3RpdmUucmVwbGFjZSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBpdCB3YXMgY2xvbmVkIHRoZXJlZm9yZSB3ZSBoYXZlIHRvIGNsb25lIGFzIHdlbGwuCiAgICAgICAgICAgICAgICAgICAgbGlua05vZGUgPSBqcUxpdGVDbG9uZShjb21waWxlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHJlcGxhY2VXaXRoKGxpbmtSb290RWxlbWVudCwganFMaXRlKGJlZm9yZVRlbXBsYXRlTGlua05vZGUpLCBsaW5rTm9kZSk7CgogICAgICAgICAgICAgICAgICAvLyBDb3B5IGluIENTUyBjbGFzc2VzIGZyb20gb3JpZ2luYWwgbm9kZQogICAgICAgICAgICAgICAgICBzYWZlQWRkQ2xhc3MoanFMaXRlKGxpbmtOb2RlKSwgb2xkQ2xhc3Nlcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4udHJhbnNjbHVkZSkgewogICAgICAgICAgICAgICAgICBjaGlsZEJvdW5kVHJhbnNjbHVkZUZuID0gY3JlYXRlQm91bmRUcmFuc2NsdWRlRm4oc2NvcGUsIGFmdGVyVGVtcGxhdGVOb2RlTGlua0ZuLnRyYW5zY2x1ZGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY2hpbGRCb3VuZFRyYW5zY2x1ZGVGbiA9IGJvdW5kVHJhbnNjbHVkZUZuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4oYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLCBzY29wZSwgbGlua05vZGUsICRyb290RWxlbWVudCwKICAgICAgICAgICAgICAgICAgY2hpbGRCb3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxpbmtRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIH0pLgogICAgICAgICAgICBlcnJvcihmdW5jdGlvbihyZXNwb25zZSwgY29kZSwgaGVhZGVycywgY29uZmlnKSB7CiAgICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoJ3RwbG9hZCcsICdGYWlsZWQgdG8gbG9hZCB0ZW1wbGF0ZTogezB9JywgY29uZmlnLnVybCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBkZWxheWVkTm9kZUxpbmtGbihpZ25vcmVDaGlsZExpbmtGbiwgc2NvcGUsIG5vZGUsIHJvb3RFbGVtZW50LCBib3VuZFRyYW5zY2x1ZGVGbikgewogICAgICAgICAgICBpZiAobGlua1F1ZXVlKSB7CiAgICAgICAgICAgICAgbGlua1F1ZXVlLnB1c2goc2NvcGUpOwogICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgIGxpbmtRdWV1ZS5wdXNoKHJvb3RFbGVtZW50KTsKICAgICAgICAgICAgICBsaW5rUXVldWUucHVzaChib3VuZFRyYW5zY2x1ZGVGbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYWZ0ZXJUZW1wbGF0ZU5vZGVMaW5rRm4oYWZ0ZXJUZW1wbGF0ZUNoaWxkTGlua0ZuLCBzY29wZSwgbm9kZSwgcm9vdEVsZW1lbnQsIGJvdW5kVHJhbnNjbHVkZUZuKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CgoKICAgICAgICAvKioKICAgICAgICAgKiBTb3J0aW5nIGZ1bmN0aW9uIGZvciBib3VuZCBkaXJlY3RpdmVzLgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGJ5UHJpb3JpdHkoYSwgYikgewogICAgICAgICAgdmFyIGRpZmYgPSBiLnByaW9yaXR5IC0gYS5wcmlvcml0eTsKICAgICAgICAgIGlmIChkaWZmICE9PSAwKSByZXR1cm4gZGlmZjsKICAgICAgICAgIGlmIChhLm5hbWUgIT09IGIubmFtZSkgcmV0dXJuIChhLm5hbWUgPCBiLm5hbWUpID8gLTEgOiAxOwogICAgICAgICAgcmV0dXJuIGEuaW5kZXggLSBiLmluZGV4OwogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIGFzc2VydE5vRHVwbGljYXRlKHdoYXQsIHByZXZpb3VzRGlyZWN0aXZlLCBkaXJlY3RpdmUsIGVsZW1lbnQpIHsKICAgICAgICAgIGlmIChwcmV2aW91c0RpcmVjdGl2ZSkgewogICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignbXVsdGlkaXInLCAnTXVsdGlwbGUgZGlyZWN0aXZlcyBbezB9LCB7MX1dIGFza2luZyBmb3IgezJ9IG9uOiB7M30nLAogICAgICAgICAgICAgIHByZXZpb3VzRGlyZWN0aXZlLm5hbWUsIGRpcmVjdGl2ZS5uYW1lLCB3aGF0LCBzdGFydGluZ1RhZyhlbGVtZW50KSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgZnVuY3Rpb24gYWRkVGV4dEludGVycG9sYXRlRGlyZWN0aXZlKGRpcmVjdGl2ZXMsIHRleHQpIHsKICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKHRleHQsIHRydWUpOwogICAgICAgICAgaWYgKGludGVycG9sYXRlRm4pIHsKICAgICAgICAgICAgZGlyZWN0aXZlcy5wdXNoKHsKICAgICAgICAgICAgICBwcmlvcml0eTogMCwKICAgICAgICAgICAgICBjb21waWxlOiB2YWx1ZUZuKGZ1bmN0aW9uIHRleHRJbnRlcnBvbGF0ZUxpbmtGbihzY29wZSwgbm9kZSkgewogICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IG5vZGUucGFyZW50KCksCiAgICAgICAgICAgICAgICAgIGJpbmRpbmdzID0gcGFyZW50LmRhdGEoJyRiaW5kaW5nJykgfHwgW107CiAgICAgICAgICAgICAgICBiaW5kaW5ncy5wdXNoKGludGVycG9sYXRlRm4pOwogICAgICAgICAgICAgICAgc2FmZUFkZENsYXNzKHBhcmVudC5kYXRhKCckYmluZGluZycsIGJpbmRpbmdzKSwgJ25nLWJpbmRpbmcnKTsKICAgICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZUZuV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgbm9kZVswXS5ub2RlVmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIGdldFRydXN0ZWRDb250ZXh0KG5vZGUsIGF0dHJOb3JtYWxpemVkTmFtZSkgewogICAgICAgICAgaWYgKGF0dHJOb3JtYWxpemVkTmFtZSA9PSAic3JjZG9jIikgewogICAgICAgICAgICByZXR1cm4gJHNjZS5IVE1MOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRhZyA9IG5vZGVOYW1lXyhub2RlKTsKICAgICAgICAgIC8vIG1hY3Rpb25beGxpbms6aHJlZl0gY2FuIHNvdXJjZSBTVkcuICBJdCdzIG5vdCBsaW1pdGVkIHRvIDxtYWN0aW9uPi4KICAgICAgICAgIGlmIChhdHRyTm9ybWFsaXplZE5hbWUgPT0gInhsaW5rSHJlZiIgfHwKICAgICAgICAgICAgKHRhZyA9PSAiRk9STSIgJiYgYXR0ck5vcm1hbGl6ZWROYW1lID09ICJhY3Rpb24iKSB8fAogICAgICAgICAgICAodGFnICE9ICJJTUciICYmIChhdHRyTm9ybWFsaXplZE5hbWUgPT0gInNyYyIgfHwKICAgICAgICAgICAgICBhdHRyTm9ybWFsaXplZE5hbWUgPT0gIm5nU3JjIikpKSB7CiAgICAgICAgICAgIHJldHVybiAkc2NlLlJFU09VUkNFX1VSTDsKICAgICAgICAgIH0KICAgICAgICB9CgoKICAgICAgICBmdW5jdGlvbiBhZGRBdHRySW50ZXJwb2xhdGVEaXJlY3RpdmUobm9kZSwgZGlyZWN0aXZlcywgdmFsdWUsIG5hbWUpIHsKICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKHZhbHVlLCB0cnVlKTsKCiAgICAgICAgICAvLyBubyBpbnRlcnBvbGF0aW9uIGZvdW5kIC0+IGlnbm9yZQogICAgICAgICAgaWYgKCFpbnRlcnBvbGF0ZUZuKSByZXR1cm47CgoKICAgICAgICAgIGlmIChuYW1lID09PSAibXVsdGlwbGUiICYmIG5vZGVOYW1lXyhub2RlKSA9PT0gIlNFTEVDVCIpIHsKICAgICAgICAgICAgdGhyb3cgJGNvbXBpbGVNaW5FcnIoInNlbG11bHRpIiwKICAgICAgICAgICAgICAiQmluZGluZyB0byB0aGUgJ211bHRpcGxlJyBhdHRyaWJ1dGUgaXMgbm90IHN1cHBvcnRlZC4gRWxlbWVudDogezB9IiwKICAgICAgICAgICAgICBzdGFydGluZ1RhZyhub2RlKSk7CiAgICAgICAgICB9CgogICAgICAgICAgZGlyZWN0aXZlcy5wdXNoKHsKICAgICAgICAgICAgcHJpb3JpdHk6IDEwMCwKICAgICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHByZTogZnVuY3Rpb24gYXR0ckludGVycG9sYXRlUHJlTGlua0ZuKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgICAgIHZhciAkJG9ic2VydmVycyA9IChhdHRyLiQkb2JzZXJ2ZXJzIHx8IChhdHRyLiQkb2JzZXJ2ZXJzID0ge30pKTsKCiAgICAgICAgICAgICAgICAgIGlmIChFVkVOVF9IQU5ETEVSX0FUVFJfUkVHRVhQLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyAkY29tcGlsZU1pbkVycignbm9kb21ldmVudHMnLAogICAgICAgICAgICAgICAgICAgICAgICAiSW50ZXJwb2xhdGlvbnMgZm9yIEhUTUwgRE9NIGV2ZW50IGF0dHJpYnV0ZXMgYXJlIGRpc2FsbG93ZWQuICBQbGVhc2UgdXNlIHRoZSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgIm5nLSB2ZXJzaW9ucyAoc3VjaCBhcyBuZy1jbGljayBpbnN0ZWFkIG9mIG9uY2xpY2spIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gaW50ZXJwb2xhdGUgYWdhaW4sIGluIGNhc2UgdGhlIGF0dHJpYnV0ZSB2YWx1ZSBoYXMgYmVlbiB1cGRhdGVkCiAgICAgICAgICAgICAgICAgIC8vIChlLmcuIGJ5IGFub3RoZXIgZGlyZWN0aXZlJ3MgY29tcGlsZSBmdW5jdGlvbikKICAgICAgICAgICAgICAgICAgaW50ZXJwb2xhdGVGbiA9ICRpbnRlcnBvbGF0ZShhdHRyW25hbWVdLCB0cnVlLCBnZXRUcnVzdGVkQ29udGV4dChub2RlLCBuYW1lKSk7CgogICAgICAgICAgICAgICAgICAvLyBpZiBhdHRyaWJ1dGUgd2FzIHVwZGF0ZWQgc28gdGhhdCB0aGVyZSBpcyBubyBpbnRlcnBvbGF0aW9uIGdvaW5nIG9uIHdlIGRvbid0IHdhbnQgdG8KICAgICAgICAgICAgICAgICAgLy8gcmVnaXN0ZXIgYW55IG9ic2VydmVycwogICAgICAgICAgICAgICAgICBpZiAoIWludGVycG9sYXRlRm4pIHJldHVybjsKCiAgICAgICAgICAgICAgICAgIC8vIFRPRE8oaSk6IHRoaXMgc2hvdWxkIGxpa2VseSBiZSBhdHRyLiRzZXQobmFtZSwgaXRlcnBvbGF0ZUZuKHNjb3BlKSBzbyB0aGF0IHdlIHJlc2V0IHRoZQogICAgICAgICAgICAgICAgICAvLyBhY3R1YWwgYXR0ciB2YWx1ZQogICAgICAgICAgICAgICAgICBhdHRyW25hbWVdID0gaW50ZXJwb2xhdGVGbihzY29wZSk7CiAgICAgICAgICAgICAgICAgICgkJG9ic2VydmVyc1tuYW1lXSB8fCAoJCRvYnNlcnZlcnNbbmFtZV0gPSBbXSkpLiQkaW50ZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAoYXR0ci4kJG9ic2VydmVycyAmJiBhdHRyLiQkb2JzZXJ2ZXJzW25hbWVdLiQkc2NvcGUgfHwgc2NvcGUpLgogICAgICAgICAgICAgICAgICAgICR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZUZuV2F0Y2hBY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAvL3NwZWNpYWwgY2FzZSBmb3IgY2xhc3MgYXR0cmlidXRlIGFkZGl0aW9uICsgcmVtb3ZhbAogICAgICAgICAgICAgICAgICAgICAgLy9zbyB0aGF0IGNsYXNzIGNoYW5nZXMgY2FuIHRhcCBpbnRvIHRoZSBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICAgIC8vaG9va3MgcHJvdmlkZWQgYnkgdGhlICRhbmltYXRlIHNlcnZpY2UuIEJlIHN1cmUgdG8KICAgICAgICAgICAgICAgICAgICAgIC8vc2tpcCBhbmltYXRpb25zIHdoZW4gdGhlIGZpcnN0IGRpZ2VzdCBvY2N1cnMgKHdoZW4KICAgICAgICAgICAgICAgICAgICAgIC8vYm90aCB0aGUgbmV3IGFuZCB0aGUgb2xkIHZhbHVlcyBhcmUgdGhlIHNhbWUpIHNpbmNlCiAgICAgICAgICAgICAgICAgICAgICAvL3RoZSBDU1MgY2xhc3NlcyBhcmUgdGhlIG5vbi1pbnRlcnBvbGF0ZWQgdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgICBpZihuYW1lID09PSAnY2xhc3MnICYmIG5ld1ZhbHVlICE9IG9sZFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF0dHIuJHVwZGF0ZUNsYXNzKG5ld1ZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBhdHRyLiRzZXQobmFtZSwgbmV3VmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCgogICAgICAgIC8qKgogICAgICAgICAqIFRoaXMgaXMgYSBzcGVjaWFsIGpxTGl0ZS5yZXBsYWNlV2l0aCwgd2hpY2ggY2FuIHJlcGxhY2UgaXRlbXMgd2hpY2gKICAgICAgICAgKiBoYXZlIG5vIHBhcmVudHMsIHByb3ZpZGVkIHRoYXQgdGhlIGNvbnRhaW5pbmcganFMaXRlIGNvbGxlY3Rpb24gaXMgcHJvdmlkZWQuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge0pxTGl0ZT19ICRyb290RWxlbWVudCBUaGUgcm9vdCBvZiB0aGUgY29tcGlsZSB0cmVlLiBVc2VkIHNvIHRoYXQgd2UgY2FuIHJlcGxhY2Ugbm9kZXMKICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbiB0aGUgcm9vdCBvZiB0aGUgdHJlZS4KICAgICAgICAgKiBAcGFyYW0ge0pxTGl0ZX0gZWxlbWVudHNUb1JlbW92ZSBUaGUganFMaXRlIGVsZW1lbnQgd2hpY2ggd2UgYXJlIGdvaW5nIHRvIHJlcGxhY2UuIFdlIGtlZXAKICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgc2hlbGwsIGJ1dCByZXBsYWNlIGl0cyBET00gbm9kZSByZWZlcmVuY2UuCiAgICAgICAgICogQHBhcmFtIHtOb2RlfSBuZXdOb2RlIFRoZSBuZXcgRE9NIG5vZGUuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gcmVwbGFjZVdpdGgoJHJvb3RFbGVtZW50LCBlbGVtZW50c1RvUmVtb3ZlLCBuZXdOb2RlKSB7CiAgICAgICAgICB2YXIgZmlyc3RFbGVtZW50VG9SZW1vdmUgPSBlbGVtZW50c1RvUmVtb3ZlWzBdLAogICAgICAgICAgICByZW1vdmVDb3VudCA9IGVsZW1lbnRzVG9SZW1vdmUubGVuZ3RoLAogICAgICAgICAgICBwYXJlbnQgPSBmaXJzdEVsZW1lbnRUb1JlbW92ZS5wYXJlbnROb2RlLAogICAgICAgICAgICBpLCBpaTsKCiAgICAgICAgICBpZiAoJHJvb3RFbGVtZW50KSB7CiAgICAgICAgICAgIGZvcihpID0gMCwgaWkgPSAkcm9vdEVsZW1lbnQubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgIGlmICgkcm9vdEVsZW1lbnRbaV0gPT0gZmlyc3RFbGVtZW50VG9SZW1vdmUpIHsKICAgICAgICAgICAgICAgICRyb290RWxlbWVudFtpKytdID0gbmV3Tm9kZTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSBpLCBqMiA9IGogKyByZW1vdmVDb3VudCAtIDEsCiAgICAgICAgICAgICAgICAgICAgICAgamogPSAkcm9vdEVsZW1lbnQubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICBqIDwgamo7IGorKywgajIrKykgewogICAgICAgICAgICAgICAgICBpZiAoajIgPCBqaikgewogICAgICAgICAgICAgICAgICAgICRyb290RWxlbWVudFtqXSA9ICRyb290RWxlbWVudFtqMl07CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlICRyb290RWxlbWVudFtqXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHJvb3RFbGVtZW50Lmxlbmd0aCAtPSByZW1vdmVDb3VudCAtIDE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgZmlyc3RFbGVtZW50VG9SZW1vdmUpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZmlyc3RFbGVtZW50VG9SZW1vdmUpOwogICAgICAgICAgbmV3Tm9kZVtqcUxpdGUuZXhwYW5kb10gPSBmaXJzdEVsZW1lbnRUb1JlbW92ZVtqcUxpdGUuZXhwYW5kb107CiAgICAgICAgICBmb3IgKHZhciBrID0gMSwga2sgPSBlbGVtZW50c1RvUmVtb3ZlLmxlbmd0aDsgayA8IGtrOyBrKyspIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBlbGVtZW50c1RvUmVtb3ZlW2tdOwogICAgICAgICAgICBqcUxpdGUoZWxlbWVudCkucmVtb3ZlKCk7IC8vIG11c3QgZG8gdGhpcyB3YXkgdG8gY2xlYW4gdXAgZXhwYW5kbwogICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChlbGVtZW50KTsKICAgICAgICAgICAgZGVsZXRlIGVsZW1lbnRzVG9SZW1vdmVba107CiAgICAgICAgICB9CgogICAgICAgICAgZWxlbWVudHNUb1JlbW92ZVswXSA9IG5ld05vZGU7CiAgICAgICAgICBlbGVtZW50c1RvUmVtb3ZlLmxlbmd0aCA9IDE7CiAgICAgICAgfQoKCiAgICAgICAgZnVuY3Rpb24gY2xvbmVBbmRBbm5vdGF0ZUZuKGZuLCBhbm5vdGF0aW9uKSB7CiAgICAgICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uKCkgeyByZXR1cm4gZm4uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsgfSwgZm4sIGFubm90YXRpb24pOwogICAgICAgIH0KICAgICAgfV07CiAgfQoKICB2YXIgUFJFRklYX1JFR0VYUCA9IC9eKHhbXDpcLV9dfGRhdGFbXDpcLV9dKS9pOwogIC8qKgogICAqIENvbnZlcnRzIGFsbCBhY2NlcHRlZCBkaXJlY3RpdmVzIGZvcm1hdCBpbnRvIHByb3BlciBkaXJlY3RpdmUgbmFtZS4KICAgKiBBbGwgb2YgdGhlc2Ugd2lsbCBiZWNvbWUgJ215RGlyZWN0aXZlJzoKICAgKiAgIG15OkRpcmVjdGl2ZQogICAqICAgbXktZGlyZWN0aXZlCiAgICogICB4LW15LWRpcmVjdGl2ZQogICAqICAgZGF0YS1teTpkaXJlY3RpdmUKICAgKgogICAqIEFsc28gdGhlcmUgaXMgc3BlY2lhbCBjYXNlIGZvciBNb3ogcHJlZml4IHN0YXJ0aW5nIHdpdGggdXBwZXIgY2FzZSBsZXR0ZXIuCiAgICogQHBhcmFtIG5hbWUgTmFtZSB0byBub3JtYWxpemUKICAgKi8KICBmdW5jdGlvbiBkaXJlY3RpdmVOb3JtYWxpemUobmFtZSkgewogICAgcmV0dXJuIGNhbWVsQ2FzZShuYW1lLnJlcGxhY2UoUFJFRklYX1JFR0VYUCwgJycpKTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyB0eXBlCiAgICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEEgc2hhcmVkIG9iamVjdCBiZXR3ZWVuIGRpcmVjdGl2ZSBjb21waWxlIC8gbGlua2luZyBmdW5jdGlvbnMgd2hpY2ggY29udGFpbnMgbm9ybWFsaXplZCBET00KICAgKiBlbGVtZW50IGF0dHJpYnV0ZXMuIFRoZSB2YWx1ZXMgcmVmbGVjdCBjdXJyZW50IGJpbmRpbmcgc3RhdGUgYHt7IH19YC4gVGhlIG5vcm1hbGl6YXRpb24gaXMKICAgKiBuZWVkZWQgc2luY2UgYWxsIG9mIHRoZXNlIGFyZSB0cmVhdGVkIGFzIGVxdWl2YWxlbnQgaW4gQW5ndWxhcjoKICAgKgogICAqIGBgYAogICAqICAgIDxzcGFuIG5nOmJpbmQ9ImEiIG5nLWJpbmQ9ImEiIGRhdGEtbmctYmluZD0iYSIgeC1uZy1iaW5kPSJhIj4KICAgKiBgYGAKICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIHByb3BlcnR5CiAgICogQG5hbWUgJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIKICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIG1hcCBvZiBET00gZWxlbWVudCBhdHRyaWJ1dGUgbmFtZXMgdG8gdGhlIG5vcm1hbGl6ZWQgbmFtZS4gVGhpcyBpcwogICAqICAgICAgICAgICAgICAgICAgIG5lZWRlZCB0byBkbyByZXZlcnNlIGxvb2t1cCBmcm9tIG5vcm1hbGl6ZWQgbmFtZSBiYWNrIHRvIGFjdHVhbCBuYW1lLgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIG1ldGhvZAogICAqIEBuYW1lICRjb21waWxlLmRpcmVjdGl2ZS5BdHRyaWJ1dGVzIyRzZXQKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0IERPTSBlbGVtZW50IGF0dHJpYnV0ZSB2YWx1ZS4KICAgKgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgTm9ybWFsaXplZCBlbGVtZW50IGF0dHJpYnV0ZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB0byBtb2RpZnkuIFRoZSBuYW1lIGlzCiAgICogICAgICAgICAgcmV2ZXJzZS10cmFuc2xhdGVkIHVzaW5nIHRoZSB7QGxpbmsgbmcuJGNvbXBpbGUuZGlyZWN0aXZlLkF0dHJpYnV0ZXMjJGF0dHIgJGF0dHJ9CiAgICogICAgICAgICAgcHJvcGVydHkgdG8gdGhlIG9yaWdpbmFsIG5hbWUuCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIFZhbHVlIHRvIHNldCB0aGUgYXR0cmlidXRlIHRvLiBUaGUgdmFsdWUgY2FuIGJlIGFuIGludGVycG9sYXRlZCBzdHJpbmcuCiAgICovCgoKCiAgLyoqCiAgICogQ2xvc3VyZSBjb21waWxlciB0eXBlIGluZm9ybWF0aW9uCiAgICovCgogIGZ1bmN0aW9uIG5vZGVzZXRMaW5raW5nRm4oCiAgICAvKiBhbmd1bGFyLlNjb3BlICovIHNjb3BlLAogICAgLyogTm9kZUxpc3QgKi8gbm9kZUxpc3QsCiAgICAvKiBFbGVtZW50ICovIHJvb3RFbGVtZW50LAogICAgLyogZnVuY3Rpb24oRnVuY3Rpb24pICovIGJvdW5kVHJhbnNjbHVkZUZuCiAgICApe30KCiAgZnVuY3Rpb24gZGlyZWN0aXZlTGlua2luZ0ZuKAogICAgLyogbm9kZXNldExpbmtpbmdGbiAqLyBub2Rlc2V0TGlua2luZ0ZuLAogICAgLyogYW5ndWxhci5TY29wZSAqLyBzY29wZSwKICAgIC8qIE5vZGUgKi8gbm9kZSwKICAgIC8qIEVsZW1lbnQgKi8gcm9vdEVsZW1lbnQsCiAgICAvKiBmdW5jdGlvbihGdW5jdGlvbikgKi8gYm91bmRUcmFuc2NsdWRlRm4KICAgICl7fQoKICBmdW5jdGlvbiB0b2tlbkRpZmZlcmVuY2Uoc3RyMSwgc3RyMikgewogICAgdmFyIHZhbHVlcyA9ICcnLAogICAgICB0b2tlbnMxID0gc3RyMS5zcGxpdCgvXHMrLyksCiAgICAgIHRva2VuczIgPSBzdHIyLnNwbGl0KC9ccysvKTsKCiAgICBvdXRlcjoKICAgICAgZm9yKHZhciBpID0gMDsgaSA8IHRva2VuczEubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgdG9rZW4gPSB0b2tlbnMxW2ldOwogICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCB0b2tlbnMyLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZih0b2tlbiA9PSB0b2tlbnMyW2pdKSBjb250aW51ZSBvdXRlcjsKICAgICAgICB9CiAgICAgICAgdmFsdWVzICs9ICh2YWx1ZXMubGVuZ3RoID4gMCA/ICcgJyA6ICcnKSArIHRva2VuOwogICAgICB9CiAgICByZXR1cm4gdmFsdWVzOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIHByb3ZpZGVyCiAgICogQG5hbWUgJGNvbnRyb2xsZXJQcm92aWRlcgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSB7QGxpbmsgbmcuJGNvbnRyb2xsZXIgJGNvbnRyb2xsZXIgc2VydmljZX0gaXMgdXNlZCBieSBBbmd1bGFyIHRvIGNyZWF0ZSBuZXcKICAgKiBjb250cm9sbGVycy4KICAgKgogICAqIFRoaXMgcHJvdmlkZXIgYWxsb3dzIGNvbnRyb2xsZXIgcmVnaXN0cmF0aW9uIHZpYSB0aGUKICAgKiB7QGxpbmsgbmcuJGNvbnRyb2xsZXJQcm92aWRlciNyZWdpc3RlciByZWdpc3Rlcn0gbWV0aG9kLgogICAqLwogIGZ1bmN0aW9uICRDb250cm9sbGVyUHJvdmlkZXIoKSB7CiAgICB2YXIgY29udHJvbGxlcnMgPSB7fSwKICAgICAgQ05UUkxfUkVHID0gL14oXFMrKShccythc1xzKyhcdyspKT8kLzsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkY29udHJvbGxlclByb3ZpZGVyI3JlZ2lzdGVyCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R9IG5hbWUgQ29udHJvbGxlciBuYW1lLCBvciBhbiBvYmplY3QgbWFwIG9mIGNvbnRyb2xsZXJzIHdoZXJlIHRoZSBrZXlzIGFyZQogICAgICogICAgdGhlIG5hbWVzIGFuZCB0aGUgdmFsdWVzIGFyZSB0aGUgY29uc3RydWN0b3JzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxBcnJheX0gY29uc3RydWN0b3IgQ29udHJvbGxlciBjb25zdHJ1Y3RvciBmbiAob3B0aW9uYWxseSBkZWNvcmF0ZWQgd2l0aCBESQogICAgICogICAgYW5ub3RhdGlvbnMgaW4gdGhlIGFycmF5IG5vdGF0aW9uKS4KICAgICAqLwogICAgdGhpcy5yZWdpc3RlciA9IGZ1bmN0aW9uKG5hbWUsIGNvbnN0cnVjdG9yKSB7CiAgICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KG5hbWUsICdjb250cm9sbGVyJyk7CiAgICAgIGlmIChpc09iamVjdChuYW1lKSkgewogICAgICAgIGV4dGVuZChjb250cm9sbGVycywgbmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29udHJvbGxlcnNbbmFtZV0gPSBjb25zdHJ1Y3RvcjsKICAgICAgfQogICAgfTsKCgogICAgdGhpcy4kZ2V0ID0gWyckaW5qZWN0b3InLCAnJHdpbmRvdycsIGZ1bmN0aW9uKCRpbmplY3RvciwgJHdpbmRvdykgewoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgICAqIEBuYW1lICRjb250cm9sbGVyCiAgICAgICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgICAgICoKICAgICAgICogQHBhcmFtIHtGdW5jdGlvbnxzdHJpbmd9IGNvbnN0cnVjdG9yIElmIGNhbGxlZCB3aXRoIGEgZnVuY3Rpb24gdGhlbiBpdCdzIGNvbnNpZGVyZWQgdG8gYmUgdGhlCiAgICAgICAqICAgIGNvbnRyb2xsZXIgY29uc3RydWN0b3IgZnVuY3Rpb24uIE90aGVyd2lzZSBpdCdzIGNvbnNpZGVyZWQgdG8gYmUgYSBzdHJpbmcgd2hpY2ggaXMgdXNlZAogICAgICAgKiAgICB0byByZXRyaWV2ZSB0aGUgY29udHJvbGxlciBjb25zdHJ1Y3RvciB1c2luZyB0aGUgZm9sbG93aW5nIHN0ZXBzOgogICAgICAgKgogICAgICAgKiAgICAqIGNoZWNrIGlmIGEgY29udHJvbGxlciB3aXRoIGdpdmVuIG5hbWUgaXMgcmVnaXN0ZXJlZCB2aWEgYCRjb250cm9sbGVyUHJvdmlkZXJgCiAgICAgICAqICAgICogY2hlY2sgaWYgZXZhbHVhdGluZyB0aGUgc3RyaW5nIG9uIHRoZSBjdXJyZW50IHNjb3BlIHJldHVybnMgYSBjb25zdHJ1Y3RvcgogICAgICAgKiAgICAqIGNoZWNrIGB3aW5kb3dbY29uc3RydWN0b3JdYCBvbiB0aGUgZ2xvYmFsIGB3aW5kb3dgIG9iamVjdAogICAgICAgKgogICAgICAgKiBAcGFyYW0ge09iamVjdH0gbG9jYWxzIEluamVjdGlvbiBsb2NhbHMgZm9yIENvbnRyb2xsZXIuCiAgICAgICAqIEByZXR1cm4ge09iamVjdH0gSW5zdGFuY2Ugb2YgZ2l2ZW4gY29udHJvbGxlci4KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIGAkY29udHJvbGxlcmAgc2VydmljZSBpcyByZXNwb25zaWJsZSBmb3IgaW5zdGFudGlhdGluZyBjb250cm9sbGVycy4KICAgICAgICoKICAgICAgICogSXQncyBqdXN0IGEgc2ltcGxlIGNhbGwgdG8ge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0sIGJ1dCBleHRyYWN0ZWQgaW50bwogICAgICAgKiBhIHNlcnZpY2UsIHNvIHRoYXQgb25lIGNhbiBvdmVycmlkZSB0aGlzIHNlcnZpY2Ugd2l0aCBbQkMgdmVyc2lvbl0oaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vMTY0OTc4OCkuCiAgICAgICAqLwogICAgICByZXR1cm4gZnVuY3Rpb24oZXhwcmVzc2lvbiwgbG9jYWxzKSB7CiAgICAgICAgdmFyIGluc3RhbmNlLCBtYXRjaCwgY29uc3RydWN0b3IsIGlkZW50aWZpZXI7CgogICAgICAgIGlmKGlzU3RyaW5nKGV4cHJlc3Npb24pKSB7CiAgICAgICAgICBtYXRjaCA9IGV4cHJlc3Npb24ubWF0Y2goQ05UUkxfUkVHKSwKICAgICAgICAgICAgY29uc3RydWN0b3IgPSBtYXRjaFsxXSwKICAgICAgICAgICAgaWRlbnRpZmllciA9IG1hdGNoWzNdOwogICAgICAgICAgZXhwcmVzc2lvbiA9IGNvbnRyb2xsZXJzLmhhc093blByb3BlcnR5KGNvbnN0cnVjdG9yKQogICAgICAgICAgICA/IGNvbnRyb2xsZXJzW2NvbnN0cnVjdG9yXQogICAgICAgICAgICA6IGdldHRlcihsb2NhbHMuJHNjb3BlLCBjb25zdHJ1Y3RvciwgdHJ1ZSkgfHwgZ2V0dGVyKCR3aW5kb3csIGNvbnN0cnVjdG9yLCB0cnVlKTsKCiAgICAgICAgICBhc3NlcnRBcmdGbihleHByZXNzaW9uLCBjb25zdHJ1Y3RvciwgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICBpbnN0YW5jZSA9ICRpbmplY3Rvci5pbnN0YW50aWF0ZShleHByZXNzaW9uLCBsb2NhbHMpOwoKICAgICAgICBpZiAoaWRlbnRpZmllcikgewogICAgICAgICAgaWYgKCEobG9jYWxzICYmIHR5cGVvZiBsb2NhbHMuJHNjb3BlID09ICdvYmplY3QnKSkgewogICAgICAgICAgICB0aHJvdyBtaW5FcnIoJyRjb250cm9sbGVyJykoJ25vc2NwJywKICAgICAgICAgICAgICAiQ2Fubm90IGV4cG9ydCBjb250cm9sbGVyICd7MH0nIGFzICd7MX0nISBObyAkc2NvcGUgb2JqZWN0IHByb3ZpZGVkIHZpYSBgbG9jYWxzYC4iLAogICAgICAgICAgICAgICAgY29uc3RydWN0b3IgfHwgZXhwcmVzc2lvbi5uYW1lLCBpZGVudGlmaWVyKTsKICAgICAgICAgIH0KCiAgICAgICAgICBsb2NhbHMuJHNjb3BlW2lkZW50aWZpZXJdID0gaW5zdGFuY2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgIH07CiAgICB9XTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGRvY3VtZW50CiAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEEge0BsaW5rIGFuZ3VsYXIuZWxlbWVudCBqUXVlcnkgb3IganFMaXRlfSB3cmFwcGVyIGZvciB0aGUgYnJvd3NlcidzIGB3aW5kb3cuZG9jdW1lbnRgIG9iamVjdC4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJNYWluQ3RybCI+CiAgIDxwPiRkb2N1bWVudCB0aXRsZTogPGIgbmctYmluZD0idGl0bGUiPjwvYj48L3A+CiAgIDxwPndpbmRvdy5kb2N1bWVudCB0aXRsZTogPGIgbmctYmluZD0id2luZG93VGl0bGUiPjwvYj48L3A+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgIGZ1bmN0aW9uIE1haW5DdHJsKCRzY29wZSwgJGRvY3VtZW50KSB7CiAgICAgICAgICRzY29wZS50aXRsZSA9ICRkb2N1bWVudFswXS50aXRsZTsKICAgICAgICAgJHNjb3BlLndpbmRvd1RpdGxlID0gYW5ndWxhci5lbGVtZW50KHdpbmRvdy5kb2N1bWVudClbMF0udGl0bGU7CiAgICAgICB9CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIGZ1bmN0aW9uICREb2N1bWVudFByb3ZpZGVyKCl7CiAgICB0aGlzLiRnZXQgPSBbJyR3aW5kb3cnLCBmdW5jdGlvbih3aW5kb3cpewogICAgICByZXR1cm4ganFMaXRlKHdpbmRvdy5kb2N1bWVudCk7CiAgICB9XTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGV4Y2VwdGlvbkhhbmRsZXIKICAgKiBAcmVxdWlyZXMgbmcuJGxvZwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQW55IHVuY2F1Z2h0IGV4Y2VwdGlvbiBpbiBhbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRlbGVnYXRlZCB0byB0aGlzIHNlcnZpY2UuCiAgICogVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gc2ltcGx5IGRlbGVnYXRlcyB0byBgJGxvZy5lcnJvcmAgd2hpY2ggbG9ncyBpdCBpbnRvCiAgICogdGhlIGJyb3dzZXIgY29uc29sZS4KICAgKgogICAqIEluIHVuaXQgdGVzdHMsIGlmIGBhbmd1bGFyLW1vY2tzLmpzYCBpcyBsb2FkZWQsIHRoaXMgc2VydmljZSBpcyBvdmVycmlkZGVuIGJ5CiAgICoge0BsaW5rIG5nTW9jay4kZXhjZXB0aW9uSGFuZGxlciBtb2NrICRleGNlcHRpb25IYW5kbGVyfSB3aGljaCBhaWRzIGluIHRlc3RpbmcuCiAgICoKICAgKiAjIyBFeGFtcGxlOgogICAqCiAgICogYGBganMKICAgKiAgIGFuZ3VsYXIubW9kdWxlKCdleGNlcHRpb25PdmVycmlkZScsIFtdKS5mYWN0b3J5KCckZXhjZXB0aW9uSGFuZGxlcicsIGZ1bmN0aW9uICgpIHsKICogICAgIHJldHVybiBmdW5jdGlvbiAoZXhjZXB0aW9uLCBjYXVzZSkgewogKiAgICAgICBleGNlcHRpb24ubWVzc2FnZSArPSAnIChjYXVzZWQgYnkgIicgKyBjYXVzZSArICciKSc7CiAqICAgICAgIHRocm93IGV4Y2VwdGlvbjsKICogICAgIH07CiAqICAgfSk7CiAgICogYGBgCiAgICoKICAgKiBUaGlzIGV4YW1wbGUgd2lsbCBvdmVycmlkZSB0aGUgbm9ybWFsIGFjdGlvbiBvZiBgJGV4Y2VwdGlvbkhhbmRsZXJgLCB0byBtYWtlIGFuZ3VsYXIKICAgKiBleGNlcHRpb25zIGZhaWwgaGFyZCB3aGVuIHRoZXkgaGFwcGVuLCBpbnN0ZWFkIG9mIGp1c3QgbG9nZ2luZyB0byB0aGUgY29uc29sZS4KICAgKgogICAqIEBwYXJhbSB7RXJyb3J9IGV4Y2VwdGlvbiBFeGNlcHRpb24gYXNzb2NpYXRlZCB3aXRoIHRoZSBlcnJvci4KICAgKiBAcGFyYW0ge3N0cmluZz19IGNhdXNlIG9wdGlvbmFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjb250ZXh0IGluIHdoaWNoCiAgICogICAgICAgdGhlIGVycm9yIHdhcyB0aHJvd24uCiAgICoKICAgKi8KICBmdW5jdGlvbiAkRXhjZXB0aW9uSGFuZGxlclByb3ZpZGVyKCkgewogICAgdGhpcy4kZ2V0ID0gWyckbG9nJywgZnVuY3Rpb24oJGxvZykgewogICAgICByZXR1cm4gZnVuY3Rpb24oZXhjZXB0aW9uLCBjYXVzZSkgewogICAgICAgICRsb2cuZXJyb3IuYXBwbHkoJGxvZywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH1dOwogIH0KCiAgLyoqCiAgICogUGFyc2UgaGVhZGVycyBpbnRvIGtleSB2YWx1ZSBvYmplY3QKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBoZWFkZXJzIFJhdyBoZWFkZXJzIGFzIGEgc3RyaW5nCiAgICogQHJldHVybnMge09iamVjdH0gUGFyc2VkIGhlYWRlcnMgYXMga2V5IHZhbHVlIG9iamVjdAogICAqLwogIGZ1bmN0aW9uIHBhcnNlSGVhZGVycyhoZWFkZXJzKSB7CiAgICB2YXIgcGFyc2VkID0ge30sIGtleSwgdmFsLCBpOwoKICAgIGlmICghaGVhZGVycykgcmV0dXJuIHBhcnNlZDsKCiAgICBmb3JFYWNoKGhlYWRlcnMuc3BsaXQoJ1xuJyksIGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgaSA9IGxpbmUuaW5kZXhPZignOicpOwogICAgICBrZXkgPSBsb3dlcmNhc2UodHJpbShsaW5lLnN1YnN0cigwLCBpKSkpOwogICAgICB2YWwgPSB0cmltKGxpbmUuc3Vic3RyKGkgKyAxKSk7CgogICAgICBpZiAoa2V5KSB7CiAgICAgICAgaWYgKHBhcnNlZFtrZXldKSB7CiAgICAgICAgICBwYXJzZWRba2V5XSArPSAnLCAnICsgdmFsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwYXJzZWRba2V5XSA9IHZhbDsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybiBwYXJzZWQ7CiAgfQoKCiAgLyoqCiAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgcHJvdmlkZXMgYWNjZXNzIHRvIHBhcnNlZCBoZWFkZXJzLgogICAqCiAgICogSGVhZGVycyBhcmUgbGF6eSBwYXJzZWQgd2hlbiBmaXJzdCByZXF1ZXN0ZWQuCiAgICogQHNlZSBwYXJzZUhlYWRlcnMKICAgKgogICAqIEBwYXJhbSB7KHN0cmluZ3xPYmplY3QpfSBoZWFkZXJzIEhlYWRlcnMgdG8gcHJvdmlkZSBhY2Nlc3MgdG8uCiAgICogQHJldHVybnMge2Z1bmN0aW9uKHN0cmluZz0pfSBSZXR1cm5zIGEgZ2V0dGVyIGZ1bmN0aW9uIHdoaWNoIGlmIGNhbGxlZCB3aXRoOgogICAqCiAgICogICAtIGlmIGNhbGxlZCB3aXRoIHNpbmdsZSBhbiBhcmd1bWVudCByZXR1cm5zIGEgc2luZ2xlIGhlYWRlciB2YWx1ZSBvciBudWxsCiAgICogICAtIGlmIGNhbGxlZCB3aXRoIG5vIGFyZ3VtZW50cyByZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCBoZWFkZXJzLgogICAqLwogIGZ1bmN0aW9uIGhlYWRlcnNHZXR0ZXIoaGVhZGVycykgewogICAgdmFyIGhlYWRlcnNPYmogPSBpc09iamVjdChoZWFkZXJzKSA/IGhlYWRlcnMgOiB1bmRlZmluZWQ7CgogICAgcmV0dXJuIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgaWYgKCFoZWFkZXJzT2JqKSBoZWFkZXJzT2JqID0gIHBhcnNlSGVhZGVycyhoZWFkZXJzKTsKCiAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIGhlYWRlcnNPYmpbbG93ZXJjYXNlKG5hbWUpXSB8fCBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gaGVhZGVyc09iajsKICAgIH07CiAgfQoKCiAgLyoqCiAgICogQ2hhaW4gYWxsIGdpdmVuIGZ1bmN0aW9ucwogICAqCiAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGZvciBib3RoIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRyYW5zZm9ybWluZwogICAqCiAgICogQHBhcmFtIHsqfSBkYXRhIERhdGEgdG8gdHJhbnNmb3JtLgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oc3RyaW5nPSl9IGhlYWRlcnMgSHR0cCBoZWFkZXJzIGdldHRlciBmbi4KICAgKiBAcGFyYW0geyhGdW5jdGlvbnxBcnJheS48RnVuY3Rpb24+KX0gZm5zIEZ1bmN0aW9uIG9yIGFuIGFycmF5IG9mIGZ1bmN0aW9ucy4KICAgKiBAcmV0dXJucyB7Kn0gVHJhbnNmb3JtZWQgZGF0YS4KICAgKi8KICBmdW5jdGlvbiB0cmFuc2Zvcm1EYXRhKGRhdGEsIGhlYWRlcnMsIGZucykgewogICAgaWYgKGlzRnVuY3Rpb24oZm5zKSkKICAgICAgcmV0dXJuIGZucyhkYXRhLCBoZWFkZXJzKTsKCiAgICBmb3JFYWNoKGZucywgZnVuY3Rpb24oZm4pIHsKICAgICAgZGF0YSA9IGZuKGRhdGEsIGhlYWRlcnMpOwogICAgfSk7CgogICAgcmV0dXJuIGRhdGE7CiAgfQoKCiAgZnVuY3Rpb24gaXNTdWNjZXNzKHN0YXR1cykgewogICAgcmV0dXJuIDIwMCA8PSBzdGF0dXMgJiYgc3RhdHVzIDwgMzAwOwogIH0KCgogIGZ1bmN0aW9uICRIdHRwUHJvdmlkZXIoKSB7CiAgICB2YXIgSlNPTl9TVEFSVCA9IC9eXHMqKFxbfFx7W15ce10pLywKICAgICAgSlNPTl9FTkQgPSAvW1x9XF1dXHMqJC8sCiAgICAgIFBST1RFQ1RJT05fUFJFRklYID0gL15cKVxdXH0nLD9cbi8sCiAgICAgIENPTlRFTlRfVFlQRV9BUFBMSUNBVElPTl9KU09OID0geydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PXV0Zi04J307CgogICAgdmFyIGRlZmF1bHRzID0gdGhpcy5kZWZhdWx0cyA9IHsKICAgICAgLy8gdHJhbnNmb3JtIGluY29taW5nIHJlc3BvbnNlIGRhdGEKICAgICAgdHJhbnNmb3JtUmVzcG9uc2U6IFtmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgaWYgKGlzU3RyaW5nKGRhdGEpKSB7CiAgICAgICAgICAvLyBzdHJpcCBqc29uIHZ1bG5lcmFiaWxpdHkgcHJvdGVjdGlvbiBwcmVmaXgKICAgICAgICAgIGRhdGEgPSBkYXRhLnJlcGxhY2UoUFJPVEVDVElPTl9QUkVGSVgsICcnKTsKICAgICAgICAgIGlmIChKU09OX1NUQVJULnRlc3QoZGF0YSkgJiYgSlNPTl9FTkQudGVzdChkYXRhKSkKICAgICAgICAgICAgZGF0YSA9IGZyb21Kc29uKGRhdGEpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgfV0sCgogICAgICAvLyB0cmFuc2Zvcm0gb3V0Z29pbmcgcmVxdWVzdCBkYXRhCiAgICAgIHRyYW5zZm9ybVJlcXVlc3Q6IFtmdW5jdGlvbihkKSB7CiAgICAgICAgcmV0dXJuIGlzT2JqZWN0KGQpICYmICFpc0ZpbGUoZCkgJiYgIWlzQmxvYihkKSA/IHRvSnNvbihkKSA6IGQ7CiAgICAgIH1dLAoKICAgICAgLy8gZGVmYXVsdCBoZWFkZXJzCiAgICAgIGhlYWRlcnM6IHsKICAgICAgICBjb21tb246IHsKICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbiwgdGV4dC9wbGFpbiwgKi8qJwogICAgICAgIH0sCiAgICAgICAgcG9zdDogICBzaGFsbG93Q29weShDT05URU5UX1RZUEVfQVBQTElDQVRJT05fSlNPTiksCiAgICAgICAgcHV0OiAgICBzaGFsbG93Q29weShDT05URU5UX1RZUEVfQVBQTElDQVRJT05fSlNPTiksCiAgICAgICAgcGF0Y2g6ICBzaGFsbG93Q29weShDT05URU5UX1RZUEVfQVBQTElDQVRJT05fSlNPTikKICAgICAgfSwKCiAgICAgIHhzcmZDb29raWVOYW1lOiAnWFNSRi1UT0tFTicsCiAgICAgIHhzcmZIZWFkZXJOYW1lOiAnWC1YU1JGLVRPS0VOJwogICAgfTsKCiAgICAvKioKICAgICAqIEFyZSBvcmRlcmVkIGJ5IHJlcXVlc3QsIGkuZS4gdGhleSBhcmUgYXBwbGllZCBpbiB0aGUgc2FtZSBvcmRlciBhcyB0aGUKICAgICAqIGFycmF5LCBvbiByZXF1ZXN0LCBidXQgcmV2ZXJzZSBvcmRlciwgb24gcmVzcG9uc2UuCiAgICAgKi8KICAgIHZhciBpbnRlcmNlcHRvckZhY3RvcmllcyA9IHRoaXMuaW50ZXJjZXB0b3JzID0gW107CgogICAgLyoqCiAgICAgKiBGb3IgaGlzdG9yaWNhbCByZWFzb25zLCByZXNwb25zZSBpbnRlcmNlcHRvcnMgYXJlIG9yZGVyZWQgYnkgdGhlIG9yZGVyIGluIHdoaWNoCiAgICAgKiB0aGV5IGFyZSBhcHBsaWVkIHRvIHRoZSByZXNwb25zZS4gKFRoaXMgaXMgdGhlIG9wcG9zaXRlIG9mIGludGVyY2VwdG9yRmFjdG9yaWVzKQogICAgICovCiAgICB2YXIgcmVzcG9uc2VJbnRlcmNlcHRvckZhY3RvcmllcyA9IHRoaXMucmVzcG9uc2VJbnRlcmNlcHRvcnMgPSBbXTsKCiAgICB0aGlzLiRnZXQgPSBbJyRodHRwQmFja2VuZCcsICckYnJvd3NlcicsICckY2FjaGVGYWN0b3J5JywgJyRyb290U2NvcGUnLCAnJHEnLCAnJGluamVjdG9yJywKICAgICAgZnVuY3Rpb24oJGh0dHBCYWNrZW5kLCAkYnJvd3NlciwgJGNhY2hlRmFjdG9yeSwgJHJvb3RTY29wZSwgJHEsICRpbmplY3RvcikgewoKICAgICAgICB2YXIgZGVmYXVsdENhY2hlID0gJGNhY2hlRmFjdG9yeSgnJGh0dHAnKTsKCiAgICAgICAgLyoqCiAgICAgICAgICogSW50ZXJjZXB0b3JzIHN0b3JlZCBpbiByZXZlcnNlIG9yZGVyLiBJbm5lciBpbnRlcmNlcHRvcnMgYmVmb3JlIG91dGVyIGludGVyY2VwdG9ycy4KICAgICAgICAgKiBUaGUgcmV2ZXJzYWwgaXMgbmVlZGVkIHNvIHRoYXQgd2UgY2FuIGJ1aWxkIHVwIHRoZSBpbnRlcmNlcHRpb24gY2hhaW4gYXJvdW5kIHRoZQogICAgICAgICAqIHNlcnZlciByZXF1ZXN0LgogICAgICAgICAqLwogICAgICAgIHZhciByZXZlcnNlZEludGVyY2VwdG9ycyA9IFtdOwoKICAgICAgICBmb3JFYWNoKGludGVyY2VwdG9yRmFjdG9yaWVzLCBmdW5jdGlvbihpbnRlcmNlcHRvckZhY3RvcnkpIHsKICAgICAgICAgIHJldmVyc2VkSW50ZXJjZXB0b3JzLnVuc2hpZnQoaXNTdHJpbmcoaW50ZXJjZXB0b3JGYWN0b3J5KQogICAgICAgICAgICA/ICRpbmplY3Rvci5nZXQoaW50ZXJjZXB0b3JGYWN0b3J5KSA6ICRpbmplY3Rvci5pbnZva2UoaW50ZXJjZXB0b3JGYWN0b3J5KSk7CiAgICAgICAgfSk7CgogICAgICAgIGZvckVhY2gocmVzcG9uc2VJbnRlcmNlcHRvckZhY3RvcmllcywgZnVuY3Rpb24oaW50ZXJjZXB0b3JGYWN0b3J5LCBpbmRleCkgewogICAgICAgICAgdmFyIHJlc3BvbnNlRm4gPSBpc1N0cmluZyhpbnRlcmNlcHRvckZhY3RvcnkpCiAgICAgICAgICAgID8gJGluamVjdG9yLmdldChpbnRlcmNlcHRvckZhY3RvcnkpCiAgICAgICAgICAgIDogJGluamVjdG9yLmludm9rZShpbnRlcmNlcHRvckZhY3RvcnkpOwoKICAgICAgICAgIC8qKgogICAgICAgICAgICogUmVzcG9uc2UgaW50ZXJjZXB0b3JzIGdvIGJlZm9yZSAiYXJvdW5kIiBpbnRlcmNlcHRvcnMgKG5vIHJlYWwgcmVhc29uLCBqdXN0CiAgICAgICAgICAgKiBoYWQgdG8gcGljayBvbmUuKSBCdXQgdGhleSBhcmUgYWxyZWFkeSByZXZlcnNlZCwgc28gd2UgY2FuJ3QgdXNlIHVuc2hpZnQsIGhlbmNlCiAgICAgICAgICAgKiB0aGUgc3BsaWNlLgogICAgICAgICAgICovCiAgICAgICAgICByZXZlcnNlZEludGVyY2VwdG9ycy5zcGxpY2UoaW5kZXgsIDAsIHsKICAgICAgICAgICAgcmVzcG9uc2U6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlRm4oJHEud2hlbihyZXNwb25zZSkpOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZXNwb25zZUVycm9yOiBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgIHJldHVybiByZXNwb25zZUZuKCRxLnJlamVjdChyZXNwb25zZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSAkaHR0cAogICAgICAgICAqIEByZXF1aXJlcyBuZy4kaHR0cEJhY2tlbmQKICAgICAgICAgKiBAcmVxdWlyZXMgJGNhY2hlRmFjdG9yeQogICAgICAgICAqIEByZXF1aXJlcyAkcm9vdFNjb3BlCiAgICAgICAgICogQHJlcXVpcmVzICRxCiAgICAgICAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhlIGAkaHR0cGAgc2VydmljZSBpcyBhIGNvcmUgQW5ndWxhciBzZXJ2aWNlIHRoYXQgZmFjaWxpdGF0ZXMgY29tbXVuaWNhdGlvbiB3aXRoIHRoZSByZW1vdGUKICAgICAgICAgKiBIVFRQIHNlcnZlcnMgdmlhIHRoZSBicm93c2VyJ3MgW1hNTEh0dHBSZXF1ZXN0XShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi94bWxodHRwcmVxdWVzdCkKICAgICAgICAgKiBvYmplY3Qgb3IgdmlhIFtKU09OUF0oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9KU09OUCkuCiAgICAgICAgICoKICAgICAgICAgKiBGb3IgdW5pdCB0ZXN0aW5nIGFwcGxpY2F0aW9ucyB0aGF0IHVzZSBgJGh0dHBgIHNlcnZpY2UsIHNlZQogICAgICAgICAqIHtAbGluayBuZ01vY2suJGh0dHBCYWNrZW5kICRodHRwQmFja2VuZCBtb2NrfS4KICAgICAgICAgKgogICAgICAgICAqIEZvciBhIGhpZ2hlciBsZXZlbCBvZiBhYnN0cmFjdGlvbiwgcGxlYXNlIGNoZWNrIG91dCB0aGUge0BsaW5rIG5nUmVzb3VyY2UuJHJlc291cmNlCiAgICAgKiAkcmVzb3VyY2V9IHNlcnZpY2UuCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgJGh0dHAgQVBJIGlzIGJhc2VkIG9uIHRoZSB7QGxpbmsgbmcuJHEgZGVmZXJyZWQvcHJvbWlzZSBBUElzfSBleHBvc2VkIGJ5CiAgICAgICAgICogdGhlICRxIHNlcnZpY2UuIFdoaWxlIGZvciBzaW1wbGUgdXNhZ2UgcGF0dGVybnMgdGhpcyBkb2Vzbid0IG1hdHRlciBtdWNoLCBmb3IgYWR2YW5jZWQgdXNhZ2UKICAgICAgICAgKiBpdCBpcyBpbXBvcnRhbnQgdG8gZmFtaWxpYXJpemUgeW91cnNlbGYgd2l0aCB0aGVzZSBBUElzIGFuZCB0aGUgZ3VhcmFudGVlcyB0aGV5IHByb3ZpZGUuCiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqICMgR2VuZXJhbCB1c2FnZQogICAgICAgICAqIFRoZSBgJGh0dHBgIHNlcnZpY2UgaXMgYSBmdW5jdGlvbiB3aGljaCB0YWtlcyBhIHNpbmdsZSBhcmd1bWVudCDigJQgYSBjb25maWd1cmF0aW9uIG9iamVjdCDigJQKICAgICAgICAgKiB0aGF0IGlzIHVzZWQgdG8gZ2VuZXJhdGUgYW4gSFRUUCByZXF1ZXN0IGFuZCByZXR1cm5zICBhIHtAbGluayBuZy4kcSBwcm9taXNlfQogICAgICAgICAqIHdpdGggdHdvICRodHRwIHNwZWNpZmljIG1ldGhvZHM6IGBzdWNjZXNzYCBhbmQgYGVycm9yYC4KICAgICAgICAgKgogICAgICAgICAqIGBgYGpzCiAgICAgICAgICogICAkaHR0cCh7bWV0aG9kOiAnR0VUJywgdXJsOiAnL3NvbWVVcmwnfSkuCiAgICAgICAgICogICAgIHN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSwgc3RhdHVzLCBoZWFkZXJzLCBjb25maWcpIHsKICAgICAqICAgICAgIC8vIHRoaXMgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgYXN5bmNocm9ub3VzbHkKICAgICAqICAgICAgIC8vIHdoZW4gdGhlIHJlc3BvbnNlIGlzIGF2YWlsYWJsZQogICAgICogICAgIH0pLgogICAgICAgICAqICAgICBlcnJvcihmdW5jdGlvbihkYXRhLCBzdGF0dXMsIGhlYWRlcnMsIGNvbmZpZykgewogICAgICogICAgICAgLy8gY2FsbGVkIGFzeW5jaHJvbm91c2x5IGlmIGFuIGVycm9yIG9jY3VycwogICAgICogICAgICAgLy8gb3Igc2VydmVyIHJldHVybnMgcmVzcG9uc2Ugd2l0aCBhbiBlcnJvciBzdGF0dXMuCiAgICAgKiAgICAgfSk7CiAgICAgICAgICogYGBgCiAgICAgICAgICoKICAgICAgICAgKiBTaW5jZSB0aGUgcmV0dXJuZWQgdmFsdWUgb2YgY2FsbGluZyB0aGUgJGh0dHAgZnVuY3Rpb24gaXMgYSBgcHJvbWlzZWAsIHlvdSBjYW4gYWxzbyB1c2UKICAgICAgICAgKiB0aGUgYHRoZW5gIG1ldGhvZCB0byByZWdpc3RlciBjYWxsYmFja3MsIGFuZCB0aGVzZSBjYWxsYmFja3Mgd2lsbCByZWNlaXZlIGEgc2luZ2xlIGFyZ3VtZW50IOKAkwogICAgICAgICAqIGFuIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJlc3BvbnNlLiBTZWUgdGhlIEFQSSBzaWduYXR1cmUgYW5kIHR5cGUgaW5mbyBiZWxvdyBmb3IgbW9yZQogICAgICAgICAqIGRldGFpbHMuCiAgICAgICAgICoKICAgICAgICAgKiBBIHJlc3BvbnNlIHN0YXR1cyBjb2RlIGJldHdlZW4gMjAwIGFuZCAyOTkgaXMgY29uc2lkZXJlZCBhIHN1Y2Nlc3Mgc3RhdHVzIGFuZAogICAgICAgICAqIHdpbGwgcmVzdWx0IGluIHRoZSBzdWNjZXNzIGNhbGxiYWNrIGJlaW5nIGNhbGxlZC4gTm90ZSB0aGF0IGlmIHRoZSByZXNwb25zZSBpcyBhIHJlZGlyZWN0LAogICAgICAgICAqIFhNTEh0dHBSZXF1ZXN0IHdpbGwgdHJhbnNwYXJlbnRseSBmb2xsb3cgaXQsIG1lYW5pbmcgdGhhdCB0aGUgZXJyb3IgY2FsbGJhY2sgd2lsbCBub3QgYmUKICAgICAgICAgKiBjYWxsZWQgZm9yIHN1Y2ggcmVzcG9uc2VzLgogICAgICAgICAqCiAgICAgICAgICogIyBXcml0aW5nIFVuaXQgVGVzdHMgdGhhdCB1c2UgJGh0dHAKICAgICAgICAgKiBXaGVuIHVuaXQgdGVzdGluZyAodXNpbmcge0BsaW5rIG5nTW9jayBuZ01vY2t9KSwgaXQgaXMgbmVjZXNzYXJ5IHRvIGNhbGwKICAgICAgICAgKiB7QGxpbmsgbmdNb2NrLiRodHRwQmFja2VuZCNmbHVzaCAkaHR0cEJhY2tlbmQuZmx1c2goKX0gdG8gZmx1c2ggZWFjaCBwZW5kaW5nCiAgICAgICAgICogcmVxdWVzdCB1c2luZyB0cmFpbmVkIHJlc3BvbnNlcy4KICAgICAgICAgKgogICAgICAgICAqIGBgYAogICAgICAgICAqICRodHRwQmFja2VuZC5leHBlY3RHRVQoLi4uKTsKICAgICAgICAgKiAkaHR0cC5nZXQoLi4uKTsKICAgICAgICAgKiAkaHR0cEJhY2tlbmQuZmx1c2goKTsKICAgICAgICAgKiBgYGAKICAgICAgICAgKgogICAgICAgICAqICMgU2hvcnRjdXQgbWV0aG9kcwogICAgICAgICAqCiAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kcyBhcmUgYWxzbyBhdmFpbGFibGUuIEFsbCBzaG9ydGN1dCBtZXRob2RzIHJlcXVpcmUgcGFzc2luZyBpbiB0aGUgVVJMLCBhbmQKICAgICAgICAgKiByZXF1ZXN0IGRhdGEgbXVzdCBiZSBwYXNzZWQgaW4gZm9yIFBPU1QvUFVUIHJlcXVlc3RzLgogICAgICAgICAqCiAgICAgICAgICogYGBganMKICAgICAgICAgKiAgICRodHRwLmdldCgnL3NvbWVVcmwnKS5zdWNjZXNzKHN1Y2Nlc3NDYWxsYmFjayk7CiAgICAgICAgICogICAkaHR0cC5wb3N0KCcvc29tZVVybCcsIGRhdGEpLnN1Y2Nlc3Moc3VjY2Vzc0NhbGxiYWNrKTsKICAgICAgICAgKiBgYGAKICAgICAgICAgKgogICAgICAgICAqIENvbXBsZXRlIGxpc3Qgb2Ygc2hvcnRjdXQgbWV0aG9kczoKICAgICAgICAgKgogICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2dldCAkaHR0cC5nZXR9CiAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjaGVhZCAkaHR0cC5oZWFkfQogICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI3Bvc3QgJGh0dHAucG9zdH0KICAgICAgICAgKiAtIHtAbGluayBuZy4kaHR0cCNwdXQgJGh0dHAucHV0fQogICAgICAgICAqIC0ge0BsaW5rIG5nLiRodHRwI2RlbGV0ZSAkaHR0cC5kZWxldGV9CiAgICAgICAgICogLSB7QGxpbmsgbmcuJGh0dHAjanNvbnAgJGh0dHAuanNvbnB9CiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqICMgU2V0dGluZyBIVFRQIEhlYWRlcnMKICAgICAgICAgKgogICAgICAgICAqIFRoZSAkaHR0cCBzZXJ2aWNlIHdpbGwgYXV0b21hdGljYWxseSBhZGQgY2VydGFpbiBIVFRQIGhlYWRlcnMgdG8gYWxsIHJlcXVlc3RzLiBUaGVzZSBkZWZhdWx0cwogICAgICAgICAqIGNhbiBiZSBmdWxseSBjb25maWd1cmVkIGJ5IGFjY2Vzc2luZyB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMuaGVhZGVyc2AgY29uZmlndXJhdGlvbgogICAgICAgICAqIG9iamVjdCwgd2hpY2ggY3VycmVudGx5IGNvbnRhaW5zIHRoaXMgZGVmYXVsdCBjb25maWd1cmF0aW9uOgogICAgICAgICAqCiAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vbmAgKGhlYWRlcnMgdGhhdCBhcmUgY29tbW9uIGZvciBhbGwgcmVxdWVzdHMpOgogICAgICAgICAqICAgLSBgQWNjZXB0OiBhcHBsaWNhdGlvbi9qc29uLCB0ZXh0L3BsYWluLCAqIC8gKmAKICAgICAgICAgKiAtIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMucG9zdGA6IChoZWFkZXIgZGVmYXVsdHMgZm9yIFBPU1QgcmVxdWVzdHMpCiAgICAgICAgICogICAtIGBDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb25gCiAgICAgICAgICogLSBgJGh0dHBQcm92aWRlci5kZWZhdWx0cy5oZWFkZXJzLnB1dGAgKGhlYWRlciBkZWZhdWx0cyBmb3IgUFVUIHJlcXVlc3RzKQogICAgICAgICAqICAgLSBgQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qc29uYAogICAgICAgICAqCiAgICAgICAgICogVG8gYWRkIG9yIG92ZXJ3cml0ZSB0aGVzZSBkZWZhdWx0cywgc2ltcGx5IGFkZCBvciByZW1vdmUgYSBwcm9wZXJ0eSBmcm9tIHRoZXNlIGNvbmZpZ3VyYXRpb24KICAgICAgICAgKiBvYmplY3RzLiBUbyBhZGQgaGVhZGVycyBmb3IgYW4gSFRUUCBtZXRob2Qgb3RoZXIgdGhhbiBQT1NUIG9yIFBVVCwgc2ltcGx5IGFkZCBhIG5ldyBvYmplY3QKICAgICAgICAgKiB3aXRoIHRoZSBsb3dlcmNhc2VkIEhUVFAgbWV0aG9kIG5hbWUgYXMgdGhlIGtleSwgZS5nLgogICAgICAgICAqIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLmhlYWRlcnMuZ2V0ID0geyAnTXktSGVhZGVyJyA6ICd2YWx1ZScgfS4KICAgICAgICAgKgogICAgICAgICAqIFRoZSBkZWZhdWx0cyBjYW4gYWxzbyBiZSBzZXQgYXQgcnVudGltZSB2aWEgdGhlIGAkaHR0cC5kZWZhdWx0c2Agb2JqZWN0IGluIHRoZSBzYW1lCiAgICAgICAgICogZmFzaGlvbi4gRm9yIGV4YW1wbGU6CiAgICAgICAgICoKICAgICAgICAgKiBgYGAKICAgICAgICAgKiBtb2R1bGUucnVuKGZ1bmN0aW9uKCRodHRwKSB7CiAgICAgKiAgICRodHRwLmRlZmF1bHRzLmhlYWRlcnMuY29tbW9uLkF1dGhvcml6YXRpb24gPSAnQmFzaWMgWW1WbGNEcGliMjl3JwogICAgICogfSk7CiAgICAgICAgICogYGBgCiAgICAgICAgICoKICAgICAgICAgKiBJbiBhZGRpdGlvbiwgeW91IGNhbiBzdXBwbHkgYSBgaGVhZGVyc2AgcHJvcGVydHkgaW4gdGhlIGNvbmZpZyBvYmplY3QgcGFzc2VkIHdoZW4KICAgICAgICAgKiBjYWxsaW5nIGAkaHR0cChjb25maWcpYCwgd2hpY2ggb3ZlcnJpZGVzIHRoZSBkZWZhdWx0cyB3aXRob3V0IGNoYW5naW5nIHRoZW0gZ2xvYmFsbHkuCiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqICMgVHJhbnNmb3JtaW5nIFJlcXVlc3RzIGFuZCBSZXNwb25zZXMKICAgICAgICAgKgogICAgICAgICAqIEJvdGggcmVxdWVzdHMgYW5kIHJlc3BvbnNlcyBjYW4gYmUgdHJhbnNmb3JtZWQgdXNpbmcgdHJhbnNmb3JtIGZ1bmN0aW9ucy4gQnkgZGVmYXVsdCwgQW5ndWxhcgogICAgICAgICAqIGFwcGxpZXMgdGhlc2UgdHJhbnNmb3JtYXRpb25zOgogICAgICAgICAqCiAgICAgICAgICogUmVxdWVzdCB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICoKICAgICAgICAgKiAtIElmIHRoZSBgZGF0YWAgcHJvcGVydHkgb2YgdGhlIHJlcXVlc3QgY29uZmlndXJhdGlvbiBvYmplY3QgY29udGFpbnMgYW4gb2JqZWN0LCBzZXJpYWxpemUgaXQKICAgICAgICAgKiAgIGludG8gSlNPTiBmb3JtYXQuCiAgICAgICAgICoKICAgICAgICAgKiBSZXNwb25zZSB0cmFuc2Zvcm1hdGlvbnM6CiAgICAgICAgICoKICAgICAgICAgKiAgLSBJZiBYU1JGIHByZWZpeCBpcyBkZXRlY3RlZCwgc3RyaXAgaXQgKHNlZSBTZWN1cml0eSBDb25zaWRlcmF0aW9ucyBzZWN0aW9uIGJlbG93KS4KICAgICAgICAgKiAgLSBJZiBKU09OIHJlc3BvbnNlIGlzIGRldGVjdGVkLCBkZXNlcmlhbGl6ZSBpdCB1c2luZyBhIEpTT04gcGFyc2VyLgogICAgICAgICAqCiAgICAgICAgICogVG8gZ2xvYmFsbHkgYXVnbWVudCBvciBvdmVycmlkZSB0aGUgZGVmYXVsdCB0cmFuc2Zvcm1zLCBtb2RpZnkgdGhlCiAgICAgICAgICogYCRodHRwUHJvdmlkZXIuZGVmYXVsdHMudHJhbnNmb3JtUmVxdWVzdGAgYW5kIGAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzLnRyYW5zZm9ybVJlc3BvbnNlYAogICAgICAgICAqIHByb3BlcnRpZXMuIFRoZXNlIHByb3BlcnRpZXMgYXJlIGJ5IGRlZmF1bHQgYW4gYXJyYXkgb2YgdHJhbnNmb3JtIGZ1bmN0aW9ucywgd2hpY2ggYWxsb3dzIHlvdQogICAgICAgICAqIHRvIGBwdXNoYCBvciBgdW5zaGlmdGAgYSBuZXcgdHJhbnNmb3JtYXRpb24gZnVuY3Rpb24gaW50byB0aGUgdHJhbnNmb3JtYXRpb24gY2hhaW4uIFlvdSBjYW4KICAgICAgICAgKiBhbHNvIGRlY2lkZSB0byBjb21wbGV0ZWx5IG92ZXJyaWRlIGFueSBkZWZhdWx0IHRyYW5zZm9ybWF0aW9ucyBieSBhc3NpZ25pbmcgeW91cgogICAgICAgICAqIHRyYW5zZm9ybWF0aW9uIGZ1bmN0aW9ucyB0byB0aGVzZSBwcm9wZXJ0aWVzIGRpcmVjdGx5IHdpdGhvdXQgdGhlIGFycmF5IHdyYXBwZXIuICBUaGVzZSBkZWZhdWx0cwogICAgICAgICAqIGFyZSBhZ2FpbiBhdmFpbGFibGUgb24gdGhlICRodHRwIGZhY3RvcnkgYXQgcnVuLXRpbWUsIHdoaWNoIG1heSBiZSB1c2VmdWwgaWYgeW91IGhhdmUgcnVuLXRpbWUKICAgICAgICAgKiBzZXJ2aWNlcyB5b3Ugd2lzaCB0byBiZSBpbnZvbHZlZCBpbiB5b3VyIHRyYW5zZm9ybWF0aW9ucy4KICAgICAgICAgKgogICAgICAgICAqIFNpbWlsYXJseSwgdG8gbG9jYWxseSBvdmVycmlkZSB0aGUgcmVxdWVzdC9yZXNwb25zZSB0cmFuc2Zvcm1zLCBhdWdtZW50IHRoZQogICAgICAgICAqIGB0cmFuc2Zvcm1SZXF1ZXN0YCBhbmQvb3IgYHRyYW5zZm9ybVJlc3BvbnNlYCBwcm9wZXJ0aWVzIG9mIHRoZSBjb25maWd1cmF0aW9uIG9iamVjdCBwYXNzZWQKICAgICAgICAgKiBpbnRvIGAkaHR0cGAuCiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqICMgQ2FjaGluZwogICAgICAgICAqCiAgICAgICAgICogVG8gZW5hYmxlIGNhY2hpbmcsIHNldCB0aGUgcmVxdWVzdCBjb25maWd1cmF0aW9uIGBjYWNoZWAgcHJvcGVydHkgdG8gYHRydWVgICh0byB1c2UgZGVmYXVsdAogICAgICAgICAqIGNhY2hlKSBvciB0byBhIGN1c3RvbSBjYWNoZSBvYmplY3QgKGJ1aWx0IHdpdGgge0BsaW5rIG5nLiRjYWNoZUZhY3RvcnkgYCRjYWNoZUZhY3RvcnlgfSkuCiAgICAgICAgICogV2hlbiB0aGUgY2FjaGUgaXMgZW5hYmxlZCwgYCRodHRwYCBzdG9yZXMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciBpbiB0aGUgc3BlY2lmaWVkCiAgICAgICAgICogY2FjaGUuIFRoZSBuZXh0IHRpbWUgdGhlIHNhbWUgcmVxdWVzdCBpcyBtYWRlLCB0aGUgcmVzcG9uc2UgaXMgc2VydmVkIGZyb20gdGhlIGNhY2hlIHdpdGhvdXQKICAgICAgICAgKiBzZW5kaW5nIGEgcmVxdWVzdCB0byB0aGUgc2VydmVyLgogICAgICAgICAqCiAgICAgICAgICogTm90ZSB0aGF0IGV2ZW4gaWYgdGhlIHJlc3BvbnNlIGlzIHNlcnZlZCBmcm9tIGNhY2hlLCBkZWxpdmVyeSBvZiB0aGUgZGF0YSBpcyBhc3luY2hyb25vdXMgaW4KICAgICAgICAgKiB0aGUgc2FtZSB3YXkgdGhhdCByZWFsIHJlcXVlc3RzIGFyZS4KICAgICAgICAgKgogICAgICAgICAqIElmIHRoZXJlIGFyZSBtdWx0aXBsZSBHRVQgcmVxdWVzdHMgZm9yIHRoZSBzYW1lIFVSTCB0aGF0IHNob3VsZCBiZSBjYWNoZWQgdXNpbmcgdGhlIHNhbWUKICAgICAgICAgKiBjYWNoZSwgYnV0IHRoZSBjYWNoZSBpcyBub3QgcG9wdWxhdGVkIHlldCwgb25seSBvbmUgcmVxdWVzdCB0byB0aGUgc2VydmVyIHdpbGwgYmUgbWFkZSBhbmQKICAgICAgICAgKiB0aGUgcmVtYWluaW5nIHJlcXVlc3RzIHdpbGwgYmUgZnVsZmlsbGVkIHVzaW5nIHRoZSByZXNwb25zZSBmcm9tIHRoZSBmaXJzdCByZXF1ZXN0LgogICAgICAgICAqCiAgICAgICAgICogWW91IGNhbiBjaGFuZ2UgdGhlIGRlZmF1bHQgY2FjaGUgdG8gYSBuZXcgb2JqZWN0IChidWlsdCB3aXRoCiAgICAgICAgICoge0BsaW5rIG5nLiRjYWNoZUZhY3RvcnkgYCRjYWNoZUZhY3RvcnlgfSkgYnkgdXBkYXRpbmcgdGhlCiAgICAgICAgICoge0BsaW5rIG5nLiRodHRwI3Byb3BlcnRpZXNfZGVmYXVsdHMgYCRodHRwLmRlZmF1bHRzLmNhY2hlYH0gcHJvcGVydHkuIEFsbCByZXF1ZXN0cyB3aG8gc2V0CiAgICAgICAgICogdGhlaXIgYGNhY2hlYCBwcm9wZXJ0eSB0byBgdHJ1ZWAgd2lsbCBub3cgdXNlIHRoaXMgY2FjaGUgb2JqZWN0LgogICAgICAgICAqCiAgICAgICAgICogSWYgeW91IHNldCB0aGUgZGVmYXVsdCBjYWNoZSB0byBgZmFsc2VgIHRoZW4gb25seSByZXF1ZXN0cyB0aGF0IHNwZWNpZnkgdGhlaXIgb3duIGN1c3RvbQogICAgICAgICAqIGNhY2hlIG9iamVjdCB3aWxsIGJlIGNhY2hlZC4KICAgICAgICAgKgogICAgICAgICAqICMgSW50ZXJjZXB0b3JzCiAgICAgICAgICoKICAgICAgICAgKiBCZWZvcmUgeW91IHN0YXJ0IGNyZWF0aW5nIGludGVyY2VwdG9ycywgYmUgc3VyZSB0byB1bmRlcnN0YW5kIHRoZQogICAgICAgICAqIHtAbGluayBuZy4kcSAkcSBhbmQgZGVmZXJyZWQvcHJvbWlzZSBBUElzfS4KICAgICAgICAgKgogICAgICAgICAqIEZvciBwdXJwb3NlcyBvZiBnbG9iYWwgZXJyb3IgaGFuZGxpbmcsIGF1dGhlbnRpY2F0aW9uLCBvciBhbnkga2luZCBvZiBzeW5jaHJvbm91cyBvcgogICAgICAgICAqIGFzeW5jaHJvbm91cyBwcmUtcHJvY2Vzc2luZyBvZiByZXF1ZXN0IG9yIHBvc3Rwcm9jZXNzaW5nIG9mIHJlc3BvbnNlcywgaXQgaXMgZGVzaXJhYmxlIHRvIGJlCiAgICAgICAgICogYWJsZSB0byBpbnRlcmNlcHQgcmVxdWVzdHMgYmVmb3JlIHRoZXkgYXJlIGhhbmRlZCB0byB0aGUgc2VydmVyIGFuZAogICAgICAgICAqIHJlc3BvbnNlcyBiZWZvcmUgdGhleSBhcmUgaGFuZGVkIG92ZXIgdG8gdGhlIGFwcGxpY2F0aW9uIGNvZGUgdGhhdAogICAgICAgICAqIGluaXRpYXRlZCB0aGVzZSByZXF1ZXN0cy4gVGhlIGludGVyY2VwdG9ycyBsZXZlcmFnZSB0aGUge0BsaW5rIG5nLiRxCiAgICAgKiBwcm9taXNlIEFQSXN9IHRvIGZ1bGZpbGwgdGhpcyBuZWVkIGZvciBib3RoIHN5bmNocm9ub3VzIGFuZCBhc3luY2hyb25vdXMgcHJlLXByb2Nlc3NpbmcuCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgaW50ZXJjZXB0b3JzIGFyZSBzZXJ2aWNlIGZhY3RvcmllcyB0aGF0IGFyZSByZWdpc3RlcmVkIHdpdGggdGhlIGAkaHR0cFByb3ZpZGVyYCBieQogICAgICAgICAqIGFkZGluZyB0aGVtIHRvIHRoZSBgJGh0dHBQcm92aWRlci5pbnRlcmNlcHRvcnNgIGFycmF5LiBUaGUgZmFjdG9yeSBpcyBjYWxsZWQgYW5kCiAgICAgICAgICogaW5qZWN0ZWQgd2l0aCBkZXBlbmRlbmNpZXMgKGlmIHNwZWNpZmllZCkgYW5kIHJldHVybnMgdGhlIGludGVyY2VwdG9yLgogICAgICAgICAqCiAgICAgICAgICogVGhlcmUgYXJlIHR3byBraW5kcyBvZiBpbnRlcmNlcHRvcnMgKGFuZCB0d28ga2luZHMgb2YgcmVqZWN0aW9uIGludGVyY2VwdG9ycyk6CiAgICAgICAgICoKICAgICAgICAgKiAgICogYHJlcXVlc3RgOiBpbnRlcmNlcHRvcnMgZ2V0IGNhbGxlZCB3aXRoIGEgaHR0cCBgY29uZmlnYCBvYmplY3QuIFRoZSBmdW5jdGlvbiBpcyBmcmVlIHRvCiAgICAgICAgICogICAgIG1vZGlmeSB0aGUgYGNvbmZpZ2Agb2JqZWN0IG9yIGNyZWF0ZSBhIG5ldyBvbmUuIFRoZSBmdW5jdGlvbiBuZWVkcyB0byByZXR1cm4gdGhlIGBjb25maWdgCiAgICAgICAgICogICAgIG9iamVjdCBkaXJlY3RseSwgb3IgYSBwcm9taXNlIGNvbnRhaW5pbmcgdGhlIGBjb25maWdgIG9yIGEgbmV3IGBjb25maWdgIG9iamVjdC4KICAgICAgICAgKiAgICogYHJlcXVlc3RFcnJvcmA6IGludGVyY2VwdG9yIGdldHMgY2FsbGVkIHdoZW4gYSBwcmV2aW91cyBpbnRlcmNlcHRvciB0aHJldyBhbiBlcnJvciBvcgogICAgICAgICAqICAgICByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAgICAqICAgKiBgcmVzcG9uc2VgOiBpbnRlcmNlcHRvcnMgZ2V0IGNhbGxlZCB3aXRoIGh0dHAgYHJlc3BvbnNlYCBvYmplY3QuIFRoZSBmdW5jdGlvbiBpcyBmcmVlIHRvCiAgICAgICAgICogICAgIG1vZGlmeSB0aGUgYHJlc3BvbnNlYCBvYmplY3Qgb3IgY3JlYXRlIGEgbmV3IG9uZS4gVGhlIGZ1bmN0aW9uIG5lZWRzIHRvIHJldHVybiB0aGUgYHJlc3BvbnNlYAogICAgICAgICAqICAgICBvYmplY3QgZGlyZWN0bHksIG9yIGFzIGEgcHJvbWlzZSBjb250YWluaW5nIHRoZSBgcmVzcG9uc2VgIG9yIGEgbmV3IGByZXNwb25zZWAgb2JqZWN0LgogICAgICAgICAqICAgKiBgcmVzcG9uc2VFcnJvcmA6IGludGVyY2VwdG9yIGdldHMgY2FsbGVkIHdoZW4gYSBwcmV2aW91cyBpbnRlcmNlcHRvciB0aHJldyBhbiBlcnJvciBvcgogICAgICAgICAqICAgICByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiBgYGBqcwogICAgICAgICAqICAgLy8gcmVnaXN0ZXIgdGhlIGludGVyY2VwdG9yIGFzIGEgc2VydmljZQogICAgICAgICAqICAgJHByb3ZpZGUuZmFjdG9yeSgnbXlIdHRwSW50ZXJjZXB0b3InLCBmdW5jdGlvbigkcSwgZGVwZW5kZW5jeTEsIGRlcGVuZGVuY3kyKSB7CiAgICAgKiAgICAgcmV0dXJuIHsKICAgICAqICAgICAgIC8vIG9wdGlvbmFsIG1ldGhvZAogICAgICogICAgICAgJ3JlcXVlc3QnOiBmdW5jdGlvbihjb25maWcpIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIHN1Y2Nlc3MKICAgICAqICAgICAgICAgcmV0dXJuIGNvbmZpZzsKICAgICAqICAgICAgIH0sCiAgICAgKgogICAgICogICAgICAgLy8gb3B0aW9uYWwgbWV0aG9kCiAgICAgKiAgICAgICdyZXF1ZXN0RXJyb3InOiBmdW5jdGlvbihyZWplY3Rpb24pIHsKICAgICAqICAgICAgICAgLy8gZG8gc29tZXRoaW5nIG9uIGVycm9yCiAgICAgKiAgICAgICAgIGlmIChjYW5SZWNvdmVyKHJlamVjdGlvbikpIHsKICAgICAqICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VPck5ld1Byb21pc2UKICAgICAqICAgICAgICAgfQogICAgICogICAgICAgICByZXR1cm4gJHEucmVqZWN0KHJlamVjdGlvbik7CiAgICAgKiAgICAgICB9LAogICAgICoKICAgICAqCiAgICAgKgogICAgICogICAgICAgLy8gb3B0aW9uYWwgbWV0aG9kCiAgICAgKiAgICAgICAncmVzcG9uc2UnOiBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gc3VjY2VzcwogICAgICogICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgKiAgICAgICB9LAogICAgICoKICAgICAqICAgICAgIC8vIG9wdGlvbmFsIG1ldGhvZAogICAgICogICAgICAncmVzcG9uc2VFcnJvcic6IGZ1bmN0aW9uKHJlamVjdGlvbikgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVqZWN0aW9uKSkgewogICAgICogICAgICAgICAgIHJldHVybiByZXNwb25zZU9yTmV3UHJvbWlzZQogICAgICogICAgICAgICB9CiAgICAgKiAgICAgICAgIHJldHVybiAkcS5yZWplY3QocmVqZWN0aW9uKTsKICAgICAqICAgICAgIH0KICAgICAqICAgICB9OwogICAgICogICB9KTsKICAgICAgICAgKgogICAgICAgICAqICAgJGh0dHBQcm92aWRlci5pbnRlcmNlcHRvcnMucHVzaCgnbXlIdHRwSW50ZXJjZXB0b3InKTsKICAgICAgICAgKgogICAgICAgICAqCiAgICAgICAgICogICAvLyBhbHRlcm5hdGl2ZWx5LCByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgdmlhIGFuIGFub255bW91cyBmYWN0b3J5CiAgICAgICAgICogICAkaHR0cFByb3ZpZGVyLmludGVyY2VwdG9ycy5wdXNoKGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAqICAgICByZXR1cm4gewogICAgICogICAgICAncmVxdWVzdCc6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICogICAgICAgICAgLy8gc2FtZSBhcyBhYm92ZQogICAgICogICAgICAgfSwKICAgICAqCiAgICAgKiAgICAgICAncmVzcG9uc2UnOiBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgICAgLy8gc2FtZSBhcyBhYm92ZQogICAgICogICAgICAgfQogICAgICogICAgIH07CiAgICAgKiAgIH0pOwogICAgICAgICAqIGBgYAogICAgICAgICAqCiAgICAgICAgICogIyBSZXNwb25zZSBpbnRlcmNlcHRvcnMgKERFUFJFQ0FURUQpCiAgICAgICAgICoKICAgICAgICAgKiBCZWZvcmUgeW91IHN0YXJ0IGNyZWF0aW5nIGludGVyY2VwdG9ycywgYmUgc3VyZSB0byB1bmRlcnN0YW5kIHRoZQogICAgICAgICAqIHtAbGluayBuZy4kcSAkcSBhbmQgZGVmZXJyZWQvcHJvbWlzZSBBUElzfS4KICAgICAgICAgKgogICAgICAgICAqIEZvciBwdXJwb3NlcyBvZiBnbG9iYWwgZXJyb3IgaGFuZGxpbmcsIGF1dGhlbnRpY2F0aW9uIG9yIGFueSBraW5kIG9mIHN5bmNocm9ub3VzIG9yCiAgICAgICAgICogYXN5bmNocm9ub3VzIHByZXByb2Nlc3Npbmcgb2YgcmVjZWl2ZWQgcmVzcG9uc2VzLCBpdCBpcyBkZXNpcmFibGUgdG8gYmUgYWJsZSB0byBpbnRlcmNlcHQKICAgICAgICAgKiByZXNwb25zZXMgZm9yIGh0dHAgcmVxdWVzdHMgYmVmb3JlIHRoZXkgYXJlIGhhbmRlZCBvdmVyIHRvIHRoZSBhcHBsaWNhdGlvbiBjb2RlIHRoYXQKICAgICAgICAgKiBpbml0aWF0ZWQgdGhlc2UgcmVxdWVzdHMuIFRoZSByZXNwb25zZSBpbnRlcmNlcHRvcnMgbGV2ZXJhZ2UgdGhlIHtAbGluayBuZy4kcQogICAgICogcHJvbWlzZSBhcGlzfSB0byBmdWxmaWwgdGhpcyBuZWVkIGZvciBib3RoIHN5bmNocm9ub3VzIGFuZCBhc3luY2hyb25vdXMgcHJlcHJvY2Vzc2luZy4KICAgICAgICAgKgogICAgICAgICAqIFRoZSBpbnRlcmNlcHRvcnMgYXJlIHNlcnZpY2UgZmFjdG9yaWVzIHRoYXQgYXJlIHJlZ2lzdGVyZWQgd2l0aCB0aGUgJGh0dHBQcm92aWRlciBieQogICAgICAgICAqIGFkZGluZyB0aGVtIHRvIHRoZSBgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9yc2AgYXJyYXkuIFRoZSBmYWN0b3J5IGlzIGNhbGxlZCBhbmQKICAgICAgICAgKiBpbmplY3RlZCB3aXRoIGRlcGVuZGVuY2llcyAoaWYgc3BlY2lmaWVkKSBhbmQgcmV0dXJucyB0aGUgaW50ZXJjZXB0b3IgIOKAlCBhIGZ1bmN0aW9uIHRoYXQKICAgICAgICAgKiB0YWtlcyBhIHtAbGluayBuZy4kcSBwcm9taXNlfSBhbmQgcmV0dXJucyB0aGUgb3JpZ2luYWwgb3IgYSBuZXcgcHJvbWlzZS4KICAgICAgICAgKgogICAgICAgICAqIGBgYGpzCiAgICAgICAgICogICAvLyByZWdpc3RlciB0aGUgaW50ZXJjZXB0b3IgYXMgYSBzZXJ2aWNlCiAgICAgICAgICogICAkcHJvdmlkZS5mYWN0b3J5KCdteUh0dHBJbnRlcmNlcHRvcicsIGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICogICAgICAgcmV0dXJuIHByb21pc2UudGhlbihmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gc3VjY2VzcwogICAgICogICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgKiAgICAgICB9LCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICogICAgICAgICAvLyBkbyBzb21ldGhpbmcgb24gZXJyb3IKICAgICAqICAgICAgICAgaWYgKGNhblJlY292ZXIocmVzcG9uc2UpKSB7CiAgICAgKiAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT3JOZXdQcm9taXNlCiAgICAgKiAgICAgICAgIH0KICAgICAqICAgICAgICAgcmV0dXJuICRxLnJlamVjdChyZXNwb25zZSk7CiAgICAgKiAgICAgICB9KTsKICAgICAqICAgICB9CiAgICAgKiAgIH0pOwogICAgICAgICAqCiAgICAgICAgICogICAkaHR0cFByb3ZpZGVyLnJlc3BvbnNlSW50ZXJjZXB0b3JzLnB1c2goJ215SHR0cEludGVyY2VwdG9yJyk7CiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqICAgLy8gcmVnaXN0ZXIgdGhlIGludGVyY2VwdG9yIHZpYSBhbiBhbm9ueW1vdXMgZmFjdG9yeQogICAgICAgICAqICAgJGh0dHBQcm92aWRlci5yZXNwb25zZUludGVyY2VwdG9ycy5wdXNoKGZ1bmN0aW9uKCRxLCBkZXBlbmRlbmN5MSwgZGVwZW5kZW5jeTIpIHsKICAgICAqICAgICByZXR1cm4gZnVuY3Rpb24ocHJvbWlzZSkgewogICAgICogICAgICAgLy8gc2FtZSBhcyBhYm92ZQogICAgICogICAgIH0KICAgICAqICAgfSk7CiAgICAgICAgICogYGBgCiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqICMgU2VjdXJpdHkgQ29uc2lkZXJhdGlvbnMKICAgICAgICAgKgogICAgICAgICAqIFdoZW4gZGVzaWduaW5nIHdlYiBhcHBsaWNhdGlvbnMsIGNvbnNpZGVyIHNlY3VyaXR5IHRocmVhdHMgZnJvbToKICAgICAgICAgKgogICAgICAgICAqIC0gW0pTT04gdnVsbmVyYWJpbGl0eV0oaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4KQogICAgICAgICAqIC0gW1hTUkZdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ3Jvc3Mtc2l0ZV9yZXF1ZXN0X2ZvcmdlcnkpCiAgICAgICAgICoKICAgICAgICAgKiBCb3RoIHNlcnZlciBhbmQgdGhlIGNsaWVudCBtdXN0IGNvb3BlcmF0ZSBpbiBvcmRlciB0byBlbGltaW5hdGUgdGhlc2UgdGhyZWF0cy4gQW5ndWxhciBjb21lcwogICAgICAgICAqIHByZS1jb25maWd1cmVkIHdpdGggc3RyYXRlZ2llcyB0aGF0IGFkZHJlc3MgdGhlc2UgaXNzdWVzLCBidXQgZm9yIHRoaXMgdG8gd29yayBiYWNrZW5kIHNlcnZlcgogICAgICAgICAqIGNvb3BlcmF0aW9uIGlzIHJlcXVpcmVkLgogICAgICAgICAqCiAgICAgICAgICogIyMgSlNPTiBWdWxuZXJhYmlsaXR5IFByb3RlY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIEEgW0pTT04gdnVsbmVyYWJpbGl0eV0oaHR0cDovL2hhYWNrZWQuY29tL2FyY2hpdmUvMjAwOC8xMS8yMC9hbmF0b215LW9mLWEtc3VidGxlLWpzb24tdnVsbmVyYWJpbGl0eS5hc3B4KQogICAgICAgICAqIGFsbG93cyB0aGlyZCBwYXJ0eSB3ZWJzaXRlIHRvIHR1cm4geW91ciBKU09OIHJlc291cmNlIFVSTCBpbnRvCiAgICAgICAgICogW0pTT05QXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0pTT05QKSByZXF1ZXN0IHVuZGVyIHNvbWUgY29uZGl0aW9ucy4gVG8KICAgICAgICAgKiBjb3VudGVyIHRoaXMgeW91ciBzZXJ2ZXIgY2FuIHByZWZpeCBhbGwgSlNPTiByZXF1ZXN0cyB3aXRoIGZvbGxvd2luZyBzdHJpbmcgYCIpXX0nLFxuImAuCiAgICAgICAgICogQW5ndWxhciB3aWxsIGF1dG9tYXRpY2FsbHkgc3RyaXAgdGhlIHByZWZpeCBiZWZvcmUgcHJvY2Vzc2luZyBpdCBhcyBKU09OLgogICAgICAgICAqCiAgICAgICAgICogRm9yIGV4YW1wbGUgaWYgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gcmV0dXJuOgogICAgICAgICAqIGBgYGpzCiAgICAgICAgICogWydvbmUnLCd0d28nXQogICAgICAgICAqIGBgYAogICAgICAgICAqCiAgICAgICAgICogd2hpY2ggaXMgdnVsbmVyYWJsZSB0byBhdHRhY2ssIHlvdXIgc2VydmVyIGNhbiByZXR1cm46CiAgICAgICAgICogYGBganMKICAgICAgICAgKiApXX0nLAogICAgICAgICAqIFsnb25lJywndHdvJ10KICAgICAgICAgKiBgYGAKICAgICAgICAgKgogICAgICAgICAqIEFuZ3VsYXIgd2lsbCBzdHJpcCB0aGUgcHJlZml4LCBiZWZvcmUgcHJvY2Vzc2luZyB0aGUgSlNPTi4KICAgICAgICAgKgogICAgICAgICAqCiAgICAgICAgICogIyMgQ3Jvc3MgU2l0ZSBSZXF1ZXN0IEZvcmdlcnkgKFhTUkYpIFByb3RlY3Rpb24KICAgICAgICAgKgogICAgICAgICAqIFtYU1JGXShodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0Nyb3NzLXNpdGVfcmVxdWVzdF9mb3JnZXJ5KSBpcyBhIHRlY2huaXF1ZSBieSB3aGljaAogICAgICAgICAqIGFuIHVuYXV0aG9yaXplZCBzaXRlIGNhbiBnYWluIHlvdXIgdXNlcidzIHByaXZhdGUgZGF0YS4gQW5ndWxhciBwcm92aWRlcyBhIG1lY2hhbmlzbQogICAgICAgICAqIHRvIGNvdW50ZXIgWFNSRi4gV2hlbiBwZXJmb3JtaW5nIFhIUiByZXF1ZXN0cywgdGhlICRodHRwIHNlcnZpY2UgcmVhZHMgYSB0b2tlbiBmcm9tIGEgY29va2llCiAgICAgICAgICogKGJ5IGRlZmF1bHQsIGBYU1JGLVRPS0VOYCkgYW5kIHNldHMgaXQgYXMgYW4gSFRUUCBoZWFkZXIgKGBYLVhTUkYtVE9LRU5gKS4gU2luY2Ugb25seQogICAgICAgICAqIEphdmFTY3JpcHQgdGhhdCBydW5zIG9uIHlvdXIgZG9tYWluIGNvdWxkIHJlYWQgdGhlIGNvb2tpZSwgeW91ciBzZXJ2ZXIgY2FuIGJlIGFzc3VyZWQgdGhhdAogICAgICAgICAqIHRoZSBYSFIgY2FtZSBmcm9tIEphdmFTY3JpcHQgcnVubmluZyBvbiB5b3VyIGRvbWFpbi4gVGhlIGhlYWRlciB3aWxsIG5vdCBiZSBzZXQgZm9yCiAgICAgICAgICogY3Jvc3MtZG9tYWluIHJlcXVlc3RzLgogICAgICAgICAqCiAgICAgICAgICogVG8gdGFrZSBhZHZhbnRhZ2Ugb2YgdGhpcywgeW91ciBzZXJ2ZXIgbmVlZHMgdG8gc2V0IGEgdG9rZW4gaW4gYSBKYXZhU2NyaXB0IHJlYWRhYmxlIHNlc3Npb24KICAgICAgICAgKiBjb29raWUgY2FsbGVkIGBYU1JGLVRPS0VOYCBvbiB0aGUgZmlyc3QgSFRUUCBHRVQgcmVxdWVzdC4gT24gc3Vic2VxdWVudCBYSFIgcmVxdWVzdHMgdGhlCiAgICAgICAgICogc2VydmVyIGNhbiB2ZXJpZnkgdGhhdCB0aGUgY29va2llIG1hdGNoZXMgYFgtWFNSRi1UT0tFTmAgSFRUUCBoZWFkZXIsIGFuZCB0aGVyZWZvcmUgYmUgc3VyZQogICAgICAgICAqIHRoYXQgb25seSBKYXZhU2NyaXB0IHJ1bm5pbmcgb24geW91ciBkb21haW4gY291bGQgaGF2ZSBzZW50IHRoZSByZXF1ZXN0LiBUaGUgdG9rZW4gbXVzdCBiZQogICAgICAgICAqIHVuaXF1ZSBmb3IgZWFjaCB1c2VyIGFuZCBtdXN0IGJlIHZlcmlmaWFibGUgYnkgdGhlIHNlcnZlciAodG8gcHJldmVudCB0aGUgSmF2YVNjcmlwdCBmcm9tCiAgICAgICAgICogbWFraW5nIHVwIGl0cyBvd24gdG9rZW5zKS4gV2UgcmVjb21tZW5kIHRoYXQgdGhlIHRva2VuIGlzIGEgZGlnZXN0IG9mIHlvdXIgc2l0ZSdzCiAgICAgICAgICogYXV0aGVudGljYXRpb24gY29va2llIHdpdGggYSBbc2FsdF0oaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2FsdF8oY3J5cHRvZ3JhcGh5KSkKICAgICAgICAgKiBmb3IgYWRkZWQgc2VjdXJpdHkuCiAgICAgICAgICoKICAgICAgICAgKiBUaGUgbmFtZSBvZiB0aGUgaGVhZGVycyBjYW4gYmUgc3BlY2lmaWVkIHVzaW5nIHRoZSB4c3JmSGVhZGVyTmFtZSBhbmQgeHNyZkNvb2tpZU5hbWUKICAgICAgICAgKiBwcm9wZXJ0aWVzIG9mIGVpdGhlciAkaHR0cFByb3ZpZGVyLmRlZmF1bHRzIGF0IGNvbmZpZy10aW1lLCAkaHR0cC5kZWZhdWx0cyBhdCBydW4tdGltZSwKICAgICAgICAgKiBvciB0aGUgcGVyLXJlcXVlc3QgY29uZmlnIG9iamVjdC4KICAgICAgICAgKgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGNvbmZpZyBPYmplY3QgZGVzY3JpYmluZyB0aGUgcmVxdWVzdCB0byBiZSBtYWRlIGFuZCBob3cgaXQgc2hvdWxkIGJlCiAgICAgICAgICogICAgcHJvY2Vzc2VkLiBUaGUgb2JqZWN0IGhhcyBmb2xsb3dpbmcgcHJvcGVydGllczoKICAgICAgICAgKgogICAgICAgICAqICAgIC0gKiptZXRob2QqKiDigJMgYHtzdHJpbmd9YCDigJMgSFRUUCBtZXRob2QgKGUuZy4gJ0dFVCcsICdQT1NUJywgZXRjKQogICAgICAgICAqICAgIC0gKip1cmwqKiDigJMgYHtzdHJpbmd9YCDigJMgQWJzb2x1dGUgb3IgcmVsYXRpdmUgVVJMIG9mIHRoZSByZXNvdXJjZSB0aGF0IGlzIGJlaW5nIHJlcXVlc3RlZC4KICAgICAgICAgKiAgICAtICoqcGFyYW1zKiog4oCTIGB7T2JqZWN0LjxzdHJpbmd8T2JqZWN0Pn1gIOKAkyBNYXAgb2Ygc3RyaW5ncyBvciBvYmplY3RzIHdoaWNoIHdpbGwgYmUgdHVybmVkCiAgICAgICAgICogICAgICB0byBgP2tleTE9dmFsdWUxJmtleTI9dmFsdWUyYCBhZnRlciB0aGUgdXJsLiBJZiB0aGUgdmFsdWUgaXMgbm90IGEgc3RyaW5nLCBpdCB3aWxsIGJlCiAgICAgICAgICogICAgICBKU09OaWZpZWQuCiAgICAgICAgICogICAgLSAqKmRhdGEqKiDigJMgYHtzdHJpbmd8T2JqZWN0fWAg4oCTIERhdGEgdG8gYmUgc2VudCBhcyB0aGUgcmVxdWVzdCBtZXNzYWdlIGRhdGEuCiAgICAgICAgICogICAgLSAqKmhlYWRlcnMqKiDigJMgYHtPYmplY3R9YCDigJMgTWFwIG9mIHN0cmluZ3Mgb3IgZnVuY3Rpb25zIHdoaWNoIHJldHVybiBzdHJpbmdzIHJlcHJlc2VudGluZwogICAgICAgICAqICAgICAgSFRUUCBoZWFkZXJzIHRvIHNlbmQgdG8gdGhlIHNlcnZlci4gSWYgdGhlIHJldHVybiB2YWx1ZSBvZiBhIGZ1bmN0aW9uIGlzIG51bGwsIHRoZQogICAgICAgICAqICAgICAgaGVhZGVyIHdpbGwgbm90IGJlIHNlbnQuCiAgICAgICAgICogICAgLSAqKnhzcmZIZWFkZXJOYW1lKiog4oCTIGB7c3RyaW5nfWAg4oCTIE5hbWUgb2YgSFRUUCBoZWFkZXIgdG8gcG9wdWxhdGUgd2l0aCB0aGUgWFNSRiB0b2tlbi4KICAgICAgICAgKiAgICAtICoqeHNyZkNvb2tpZU5hbWUqKiDigJMgYHtzdHJpbmd9YCDigJMgTmFtZSBvZiBjb29raWUgY29udGFpbmluZyB0aGUgWFNSRiB0b2tlbi4KICAgICAgICAgKiAgICAtICoqdHJhbnNmb3JtUmVxdWVzdCoqIOKAkwogICAgICAgICAqICAgICAgYHtmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKXxBcnJheS48ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcik+fWAg4oCTCiAgICAgICAgICogICAgICB0cmFuc2Zvcm0gZnVuY3Rpb24gb3IgYW4gYXJyYXkgb2Ygc3VjaCBmdW5jdGlvbnMuIFRoZSB0cmFuc2Zvcm0gZnVuY3Rpb24gdGFrZXMgdGhlIGh0dHAKICAgICAgICAgKiAgICAgIHJlcXVlc3QgYm9keSBhbmQgaGVhZGVycyBhbmQgcmV0dXJucyBpdHMgdHJhbnNmb3JtZWQgKHR5cGljYWxseSBzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICAgICAqICAgIC0gKip0cmFuc2Zvcm1SZXNwb25zZSoqIOKAkwogICAgICAgICAqICAgICAgYHtmdW5jdGlvbihkYXRhLCBoZWFkZXJzR2V0dGVyKXxBcnJheS48ZnVuY3Rpb24oZGF0YSwgaGVhZGVyc0dldHRlcik+fWAg4oCTCiAgICAgICAgICogICAgICB0cmFuc2Zvcm0gZnVuY3Rpb24gb3IgYW4gYXJyYXkgb2Ygc3VjaCBmdW5jdGlvbnMuIFRoZSB0cmFuc2Zvcm0gZnVuY3Rpb24gdGFrZXMgdGhlIGh0dHAKICAgICAgICAgKiAgICAgIHJlc3BvbnNlIGJvZHkgYW5kIGhlYWRlcnMgYW5kIHJldHVybnMgaXRzIHRyYW5zZm9ybWVkICh0eXBpY2FsbHkgZGVzZXJpYWxpemVkKSB2ZXJzaW9uLgogICAgICAgICAqICAgIC0gKipjYWNoZSoqIOKAkyBge2Jvb2xlYW58Q2FjaGV9YCDigJMgSWYgdHJ1ZSwgYSBkZWZhdWx0ICRodHRwIGNhY2hlIHdpbGwgYmUgdXNlZCB0byBjYWNoZSB0aGUKICAgICAgICAgKiAgICAgIEdFVCByZXF1ZXN0LCBvdGhlcndpc2UgaWYgYSBjYWNoZSBpbnN0YW5jZSBidWlsdCB3aXRoCiAgICAgICAgICogICAgICB7QGxpbmsgbmcuJGNhY2hlRmFjdG9yeSAkY2FjaGVGYWN0b3J5fSwgdGhpcyBjYWNoZSB3aWxsIGJlIHVzZWQgZm9yCiAgICAgICAgICogICAgICBjYWNoaW5nLgogICAgICAgICAqICAgIC0gKip0aW1lb3V0Kiog4oCTIGB7bnVtYmVyfFByb21pc2V9YCDigJMgdGltZW91dCBpbiBtaWxsaXNlY29uZHMsIG9yIHtAbGluayBuZy4kcSBwcm9taXNlfQogICAgICAgICAqICAgICAgdGhhdCBzaG91bGQgYWJvcnQgdGhlIHJlcXVlc3Qgd2hlbiByZXNvbHZlZC4KICAgICAgICAgKiAgICAtICoqd2l0aENyZWRlbnRpYWxzKiogLSBge2Jvb2xlYW59YCAtIHdoZXRoZXIgdG8gc2V0IHRoZSBgd2l0aENyZWRlbnRpYWxzYCBmbGFnIG9uIHRoZQogICAgICAgICAqICAgICAgWEhSIG9iamVjdC4gU2VlIFtyZXF1ZXN0cyB3aXRoIGNyZWRlbnRpYWxzXWh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL2h0dHBfYWNjZXNzX2NvbnRyb2wjc2VjdGlvbl81CiAgICAgICAgICogICAgICBmb3IgbW9yZSBpbmZvcm1hdGlvbi4KICAgICAgICAgKiAgICAtICoqcmVzcG9uc2VUeXBlKiogLSBge3N0cmluZ31gIC0gc2VlCiAgICAgICAgICogICAgICBbcmVxdWVzdFR5cGVdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL1hNTEh0dHBSZXF1ZXN0I3Jlc3BvbnNlVHlwZSkuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IFJldHVybnMgYSB7QGxpbmsgbmcuJHEgcHJvbWlzZX0gb2JqZWN0IHdpdGggdGhlCiAgICAgICAgICogICBzdGFuZGFyZCBgdGhlbmAgbWV0aG9kIGFuZCB0d28gaHR0cCBzcGVjaWZpYyBtZXRob2RzOiBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAuIFRoZSBgdGhlbmAKICAgICAgICAgKiAgIG1ldGhvZCB0YWtlcyB0d28gYXJndW1lbnRzIGEgc3VjY2VzcyBhbmQgYW4gZXJyb3IgY2FsbGJhY2sgd2hpY2ggd2lsbCBiZSBjYWxsZWQgd2l0aCBhCiAgICAgICAgICogICByZXNwb25zZSBvYmplY3QuIFRoZSBgc3VjY2Vzc2AgYW5kIGBlcnJvcmAgbWV0aG9kcyB0YWtlIGEgc2luZ2xlIGFyZ3VtZW50IC0gYSBmdW5jdGlvbiB0aGF0CiAgICAgICAgICogICB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSByZXF1ZXN0IHN1Y2NlZWRzIG9yIGZhaWxzIHJlc3BlY3RpdmVseS4gVGhlIGFyZ3VtZW50cyBwYXNzZWQgaW50bwogICAgICAgICAqICAgdGhlc2UgZnVuY3Rpb25zIGFyZSBkZXN0cnVjdHVyZWQgcmVwcmVzZW50YXRpb24gb2YgdGhlIHJlc3BvbnNlIG9iamVjdCBwYXNzZWQgaW50byB0aGUKICAgICAgICAgKiAgIGB0aGVuYCBtZXRob2QuIFRoZSByZXNwb25zZSBvYmplY3QgaGFzIHRoZXNlIHByb3BlcnRpZXM6CiAgICAgICAgICoKICAgICAgICAgKiAgIC0gKipkYXRhKiog4oCTIGB7c3RyaW5nfE9iamVjdH1gIOKAkyBUaGUgcmVzcG9uc2UgYm9keSB0cmFuc2Zvcm1lZCB3aXRoIHRoZSB0cmFuc2Zvcm0KICAgICAgICAgKiAgICAgZnVuY3Rpb25zLgogICAgICAgICAqICAgLSAqKnN0YXR1cyoqIOKAkyBge251bWJlcn1gIOKAkyBIVFRQIHN0YXR1cyBjb2RlIG9mIHRoZSByZXNwb25zZS4KICAgICAgICAgKiAgIC0gKipoZWFkZXJzKiog4oCTIGB7ZnVuY3Rpb24oW2hlYWRlck5hbWVdKX1gIOKAkyBIZWFkZXIgZ2V0dGVyIGZ1bmN0aW9uLgogICAgICAgICAqICAgLSAqKmNvbmZpZyoqIOKAkyBge09iamVjdH1gIOKAkyBUaGUgY29uZmlndXJhdGlvbiBvYmplY3QgdGhhdCB3YXMgdXNlZCB0byBnZW5lcmF0ZSB0aGUgcmVxdWVzdC4KICAgICAgICAgKiAgIC0gKipzdGF0dXNUZXh0Kiog4oCTIGB7c3RyaW5nfWAg4oCTIEhUVFAgc3RhdHVzIHRleHQgb2YgdGhlIHJlc3BvbnNlLgogICAgICAgICAqCiAgICAgICAgICogQHByb3BlcnR5IHtBcnJheS48T2JqZWN0Pn0gcGVuZGluZ1JlcXVlc3RzIEFycmF5IG9mIGNvbmZpZyBvYmplY3RzIGZvciBjdXJyZW50bHkgcGVuZGluZwogICAgICAgICAqICAgcmVxdWVzdHMuIFRoaXMgaXMgcHJpbWFyaWx5IG1lYW50IHRvIGJlIHVzZWQgZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgICAgICAgKgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgPGV4YW1wbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAgICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkZldGNoQ3RybCI+CiAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9Im1ldGhvZCI+CiAgICAgICAgIDxvcHRpb24+R0VUPC9vcHRpb24+CiAgICAgICAgIDxvcHRpb24+SlNPTlA8L29wdGlvbj4KICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0idXJsIiBzaXplPSI4MCIvPgogICAgICAgICA8YnV0dG9uIGlkPSJmZXRjaGJ0biIgbmctY2xpY2s9ImZldGNoKCkiPmZldGNoPC9idXR0b24+PGJyPgogICAgICAgICA8YnV0dG9uIGlkPSJzYW1wbGVnZXRidG4iIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnR0VUJywgJ2h0dHAtaGVsbG8uaHRtbCcpIj5TYW1wbGUgR0VUPC9idXR0b24+CiAgICAgICAgIDxidXR0b24gaWQ9InNhbXBsZWpzb25wYnRuIgogICAgICAgICBuZy1jbGljaz0idXBkYXRlTW9kZWwoJ0pTT05QJywKICAgICAgICAgJ2h0dHBzOi8vYW5ndWxhcmpzLm9yZy9ncmVldC5waHA/Y2FsbGJhY2s9SlNPTl9DQUxMQkFDSyZuYW1lPVN1cGVyJTIwSGVybycpIj4KICAgICAgICAgU2FtcGxlIEpTT05QCiAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICA8YnV0dG9uIGlkPSJpbnZhbGlkanNvbnBidG4iCiAgICAgICAgIG5nLWNsaWNrPSJ1cGRhdGVNb2RlbCgnSlNPTlAnLCAnaHR0cHM6Ly9hbmd1bGFyanMub3JnL2RvZXNudGV4aXN0JmNhbGxiYWNrPUpTT05fQ0FMTEJBQ0snKSI+CiAgICAgICAgIEludmFsaWQgSlNPTlAKICAgICAgICAgPC9idXR0b24+CiAgICAgICAgIDxwcmU+aHR0cCBzdGF0dXMgY29kZToge3tzdGF0dXN9fTwvcHJlPgogICAgICAgICA8cHJlPmh0dHAgcmVzcG9uc2UgZGF0YToge3tkYXRhfX08L3ByZT4KICAgICAgICAgPC9kaXY+CiAgICAgICAgIDwvZmlsZT4KICAgICAgICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgICAgICAgZnVuY3Rpb24gRmV0Y2hDdHJsKCRzY29wZSwgJGh0dHAsICR0ZW1wbGF0ZUNhY2hlKSB7CiAgICAkc2NvcGUubWV0aG9kID0gJ0dFVCc7CiAgICAkc2NvcGUudXJsID0gJ2h0dHAtaGVsbG8uaHRtbCc7CgogICAgJHNjb3BlLmZldGNoID0gZnVuY3Rpb24oKSB7CiAgICAgICRzY29wZS5jb2RlID0gbnVsbDsKICAgICAgJHNjb3BlLnJlc3BvbnNlID0gbnVsbDsKCiAgICAgICRodHRwKHttZXRob2Q6ICRzY29wZS5tZXRob2QsIHVybDogJHNjb3BlLnVybCwgY2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuCiAgICAgICAgc3VjY2VzcyhmdW5jdGlvbihkYXRhLCBzdGF0dXMpIHsKICAgICAgICAgICRzY29wZS5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAgICAkc2NvcGUuZGF0YSA9IGRhdGE7CiAgICAgICAgfSkuCiAgICAgICAgZXJyb3IoZnVuY3Rpb24oZGF0YSwgc3RhdHVzKSB7CiAgICAgICAgICAkc2NvcGUuZGF0YSA9IGRhdGEgfHwgIlJlcXVlc3QgZmFpbGVkIjsKICAgICAgICAgICRzY29wZS5zdGF0dXMgPSBzdGF0dXM7CiAgICAgIH0pOwogICAgfTsKCiAgICAkc2NvcGUudXBkYXRlTW9kZWwgPSBmdW5jdGlvbihtZXRob2QsIHVybCkgewogICAgICAkc2NvcGUubWV0aG9kID0gbWV0aG9kOwogICAgICAkc2NvcGUudXJsID0gdXJsOwogICAgfTsKICB9CiAgICAgICAgIDwvZmlsZT4KICAgICAgICAgPGZpbGUgbmFtZT0iaHR0cC1oZWxsby5odG1sIj4KICAgICAgICAgSGVsbG8sICRodHRwIQogICAgICAgICA8L2ZpbGU+CiAgICAgICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgICAgICB2YXIgc3RhdHVzID0gZWxlbWVudChieS5iaW5kaW5nKCdzdGF0dXMnKSk7CiAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudChieS5iaW5kaW5nKCdkYXRhJykpOwogICAgICAgICB2YXIgZmV0Y2hCdG4gPSBlbGVtZW50KGJ5LmlkKCdmZXRjaGJ0bicpKTsKICAgICAgICAgdmFyIHNhbXBsZUdldEJ0biA9IGVsZW1lbnQoYnkuaWQoJ3NhbXBsZWdldGJ0bicpKTsKICAgICAgICAgdmFyIHNhbXBsZUpzb25wQnRuID0gZWxlbWVudChieS5pZCgnc2FtcGxlanNvbnBidG4nKSk7CiAgICAgICAgIHZhciBpbnZhbGlkSnNvbnBCdG4gPSBlbGVtZW50KGJ5LmlkKCdpbnZhbGlkanNvbnBidG4nKSk7CgogICAgICAgICBpdCgnc2hvdWxkIG1ha2UgYW4geGhyIEdFVCByZXF1ZXN0JywgZnVuY3Rpb24oKSB7CiAgICBzYW1wbGVHZXRCdG4uY2xpY2soKTsKICAgIGZldGNoQnRuLmNsaWNrKCk7CiAgICBleHBlY3Qoc3RhdHVzLmdldFRleHQoKSkudG9NYXRjaCgnMjAwJyk7CiAgICBleHBlY3QoZGF0YS5nZXRUZXh0KCkpLnRvTWF0Y2goL0hlbGxvLCBcJGh0dHAhLyk7CiAgfSk7CgogICAgICAgICBpdCgnc2hvdWxkIG1ha2UgYSBKU09OUCByZXF1ZXN0IHRvIGFuZ3VsYXJqcy5vcmcnLCBmdW5jdGlvbigpIHsKICAgIHNhbXBsZUpzb25wQnRuLmNsaWNrKCk7CiAgICBmZXRjaEJ0bi5jbGljaygpOwogICAgZXhwZWN0KHN0YXR1cy5nZXRUZXh0KCkpLnRvTWF0Y2goJzIwMCcpOwogICAgZXhwZWN0KGRhdGEuZ2V0VGV4dCgpKS50b01hdGNoKC9TdXBlciBIZXJvIS8pOwogIH0pOwoKICAgICAgICAgaXQoJ3Nob3VsZCBtYWtlIEpTT05QIHJlcXVlc3QgdG8gaW52YWxpZCBVUkwgYW5kIGludm9rZSB0aGUgZXJyb3IgaGFuZGxlcicsCiAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgaW52YWxpZEpzb25wQnRuLmNsaWNrKCk7CiAgICBmZXRjaEJ0bi5jbGljaygpOwogICAgZXhwZWN0KHN0YXR1cy5nZXRUZXh0KCkpLnRvTWF0Y2goJzAnKTsKICAgIGV4cGVjdChkYXRhLmdldFRleHQoKSkudG9NYXRjaCgnUmVxdWVzdCBmYWlsZWQnKTsKICB9KTsKICAgICAgICAgPC9maWxlPgogICAgICAgICA8L2V4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gJGh0dHAocmVxdWVzdENvbmZpZykgewogICAgICAgICAgdmFyIGNvbmZpZyA9IHsKICAgICAgICAgICAgbWV0aG9kOiAnZ2V0JywKICAgICAgICAgICAgdHJhbnNmb3JtUmVxdWVzdDogZGVmYXVsdHMudHJhbnNmb3JtUmVxdWVzdCwKICAgICAgICAgICAgdHJhbnNmb3JtUmVzcG9uc2U6IGRlZmF1bHRzLnRyYW5zZm9ybVJlc3BvbnNlCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGhlYWRlcnMgPSBtZXJnZUhlYWRlcnMocmVxdWVzdENvbmZpZyk7CgogICAgICAgICAgZXh0ZW5kKGNvbmZpZywgcmVxdWVzdENvbmZpZyk7CiAgICAgICAgICBjb25maWcuaGVhZGVycyA9IGhlYWRlcnM7CiAgICAgICAgICBjb25maWcubWV0aG9kID0gdXBwZXJjYXNlKGNvbmZpZy5tZXRob2QpOwoKICAgICAgICAgIHZhciB4c3JmVmFsdWUgPSB1cmxJc1NhbWVPcmlnaW4oY29uZmlnLnVybCkKICAgICAgICAgICAgPyAkYnJvd3Nlci5jb29raWVzKClbY29uZmlnLnhzcmZDb29raWVOYW1lIHx8IGRlZmF1bHRzLnhzcmZDb29raWVOYW1lXQogICAgICAgICAgICA6IHVuZGVmaW5lZDsKICAgICAgICAgIGlmICh4c3JmVmFsdWUpIHsKICAgICAgICAgICAgaGVhZGVyc1soY29uZmlnLnhzcmZIZWFkZXJOYW1lIHx8IGRlZmF1bHRzLnhzcmZIZWFkZXJOYW1lKV0gPSB4c3JmVmFsdWU7CiAgICAgICAgICB9CgoKICAgICAgICAgIHZhciBzZXJ2ZXJSZXF1ZXN0ID0gZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgICAgIGhlYWRlcnMgPSBjb25maWcuaGVhZGVyczsKICAgICAgICAgICAgdmFyIHJlcURhdGEgPSB0cmFuc2Zvcm1EYXRhKGNvbmZpZy5kYXRhLCBoZWFkZXJzR2V0dGVyKGhlYWRlcnMpLCBjb25maWcudHJhbnNmb3JtUmVxdWVzdCk7CgogICAgICAgICAgICAvLyBzdHJpcCBjb250ZW50LXR5cGUgaWYgZGF0YSBpcyB1bmRlZmluZWQKICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGNvbmZpZy5kYXRhKSkgewogICAgICAgICAgICAgIGZvckVhY2goaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGhlYWRlcikgewogICAgICAgICAgICAgICAgaWYgKGxvd2VyY2FzZShoZWFkZXIpID09PSAnY29udGVudC10eXBlJykgewogICAgICAgICAgICAgICAgICBkZWxldGUgaGVhZGVyc1toZWFkZXJdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY29uZmlnLndpdGhDcmVkZW50aWFscykgJiYgIWlzVW5kZWZpbmVkKGRlZmF1bHRzLndpdGhDcmVkZW50aWFscykpIHsKICAgICAgICAgICAgICBjb25maWcud2l0aENyZWRlbnRpYWxzID0gZGVmYXVsdHMud2l0aENyZWRlbnRpYWxzOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBzZW5kIHJlcXVlc3QKICAgICAgICAgICAgcmV0dXJuIHNlbmRSZXEoY29uZmlnLCByZXFEYXRhLCBoZWFkZXJzKS50aGVuKHRyYW5zZm9ybVJlc3BvbnNlLCB0cmFuc2Zvcm1SZXNwb25zZSk7CiAgICAgICAgICB9OwoKICAgICAgICAgIHZhciBjaGFpbiA9IFtzZXJ2ZXJSZXF1ZXN0LCB1bmRlZmluZWRdOwogICAgICAgICAgdmFyIHByb21pc2UgPSAkcS53aGVuKGNvbmZpZyk7CgogICAgICAgICAgLy8gYXBwbHkgaW50ZXJjZXB0b3JzCiAgICAgICAgICBmb3JFYWNoKHJldmVyc2VkSW50ZXJjZXB0b3JzLCBmdW5jdGlvbihpbnRlcmNlcHRvcikgewogICAgICAgICAgICBpZiAoaW50ZXJjZXB0b3IucmVxdWVzdCB8fCBpbnRlcmNlcHRvci5yZXF1ZXN0RXJyb3IpIHsKICAgICAgICAgICAgICBjaGFpbi51bnNoaWZ0KGludGVyY2VwdG9yLnJlcXVlc3QsIGludGVyY2VwdG9yLnJlcXVlc3RFcnJvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGludGVyY2VwdG9yLnJlc3BvbnNlIHx8IGludGVyY2VwdG9yLnJlc3BvbnNlRXJyb3IpIHsKICAgICAgICAgICAgICBjaGFpbi5wdXNoKGludGVyY2VwdG9yLnJlc3BvbnNlLCBpbnRlcmNlcHRvci5yZXNwb25zZUVycm9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgd2hpbGUoY2hhaW4ubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciB0aGVuRm4gPSBjaGFpbi5zaGlmdCgpOwogICAgICAgICAgICB2YXIgcmVqZWN0Rm4gPSBjaGFpbi5zaGlmdCgpOwoKICAgICAgICAgICAgcHJvbWlzZSA9IHByb21pc2UudGhlbih0aGVuRm4sIHJlamVjdEZuKTsKICAgICAgICAgIH0KCiAgICAgICAgICBwcm9taXNlLnN1Y2Nlc3MgPSBmdW5jdGlvbihmbikgewogICAgICAgICAgICBwcm9taXNlLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICBmbihyZXNwb25zZS5kYXRhLCByZXNwb25zZS5zdGF0dXMsIHJlc3BvbnNlLmhlYWRlcnMsIGNvbmZpZyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgICAgICAgIH07CgogICAgICAgICAgcHJvbWlzZS5lcnJvciA9IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgIHByb21pc2UudGhlbihudWxsLCBmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgIGZuKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlLnN0YXR1cywgcmVzcG9uc2UuaGVhZGVycywgY29uZmlnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOwogICAgICAgICAgfTsKCiAgICAgICAgICByZXR1cm4gcHJvbWlzZTsKCiAgICAgICAgICBmdW5jdGlvbiB0cmFuc2Zvcm1SZXNwb25zZShyZXNwb25zZSkgewogICAgICAgICAgICAvLyBtYWtlIGEgY29weSBzaW5jZSB0aGUgcmVzcG9uc2UgbXVzdCBiZSBjYWNoZWFibGUKICAgICAgICAgICAgdmFyIHJlc3AgPSBleHRlbmQoe30sIHJlc3BvbnNlLCB7CiAgICAgICAgICAgICAgZGF0YTogdHJhbnNmb3JtRGF0YShyZXNwb25zZS5kYXRhLCByZXNwb25zZS5oZWFkZXJzLCBjb25maWcudHJhbnNmb3JtUmVzcG9uc2UpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gKGlzU3VjY2VzcyhyZXNwb25zZS5zdGF0dXMpKQogICAgICAgICAgICAgID8gcmVzcAogICAgICAgICAgICAgIDogJHEucmVqZWN0KHJlc3ApOwogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIG1lcmdlSGVhZGVycyhjb25maWcpIHsKICAgICAgICAgICAgdmFyIGRlZkhlYWRlcnMgPSBkZWZhdWx0cy5oZWFkZXJzLAogICAgICAgICAgICAgIHJlcUhlYWRlcnMgPSBleHRlbmQoe30sIGNvbmZpZy5oZWFkZXJzKSwKICAgICAgICAgICAgICBkZWZIZWFkZXJOYW1lLCBsb3dlcmNhc2VEZWZIZWFkZXJOYW1lLCByZXFIZWFkZXJOYW1lOwoKICAgICAgICAgICAgZGVmSGVhZGVycyA9IGV4dGVuZCh7fSwgZGVmSGVhZGVycy5jb21tb24sIGRlZkhlYWRlcnNbbG93ZXJjYXNlKGNvbmZpZy5tZXRob2QpXSk7CgogICAgICAgICAgICAvLyBleGVjdXRlIGlmIGhlYWRlciB2YWx1ZSBpcyBmdW5jdGlvbgogICAgICAgICAgICBleGVjSGVhZGVycyhkZWZIZWFkZXJzKTsKICAgICAgICAgICAgZXhlY0hlYWRlcnMocmVxSGVhZGVycyk7CgogICAgICAgICAgICAvLyB1c2luZyBmb3ItaW4gaW5zdGVhZCBvZiBmb3JFYWNoIHRvIGF2b2lkIHVuZWNlc3NhcnkgaXRlcmF0aW9uIGFmdGVyIGhlYWRlciBoYXMgYmVlbiBmb3VuZAogICAgICAgICAgICBkZWZhdWx0SGVhZGVyc0l0ZXJhdGlvbjoKICAgICAgICAgICAgICBmb3IgKGRlZkhlYWRlck5hbWUgaW4gZGVmSGVhZGVycykgewogICAgICAgICAgICAgICAgbG93ZXJjYXNlRGVmSGVhZGVyTmFtZSA9IGxvd2VyY2FzZShkZWZIZWFkZXJOYW1lKTsKCiAgICAgICAgICAgICAgICBmb3IgKHJlcUhlYWRlck5hbWUgaW4gcmVxSGVhZGVycykgewogICAgICAgICAgICAgICAgICBpZiAobG93ZXJjYXNlKHJlcUhlYWRlck5hbWUpID09PSBsb3dlcmNhc2VEZWZIZWFkZXJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWUgZGVmYXVsdEhlYWRlcnNJdGVyYXRpb247CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXFIZWFkZXJzW2RlZkhlYWRlck5hbWVdID0gZGVmSGVhZGVyc1tkZWZIZWFkZXJOYW1lXTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVxSGVhZGVyczsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGV4ZWNIZWFkZXJzKGhlYWRlcnMpIHsKICAgICAgICAgICAgICB2YXIgaGVhZGVyQ29udGVudDsKCiAgICAgICAgICAgICAgZm9yRWFjaChoZWFkZXJzLCBmdW5jdGlvbihoZWFkZXJGbiwgaGVhZGVyKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihoZWFkZXJGbikpIHsKICAgICAgICAgICAgICAgICAgaGVhZGVyQ29udGVudCA9IGhlYWRlckZuKCk7CiAgICAgICAgICAgICAgICAgIGlmIChoZWFkZXJDb250ZW50ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBoZWFkZXJzW2hlYWRlcl0gPSBoZWFkZXJDb250ZW50OwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBoZWFkZXJzW2hlYWRlcl07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgJGh0dHAucGVuZGluZ1JlcXVlc3RzID0gW107CgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkaHR0cCNnZXQKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBHRVRgIHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICovCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkaHR0cCNkZWxldGUKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFNob3J0Y3V0IG1ldGhvZCB0byBwZXJmb3JtIGBERUxFVEVgIHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0PX0gY29uZmlnIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICogQHJldHVybnMge0h0dHBQcm9taXNlfSBGdXR1cmUgb2JqZWN0CiAgICAgICAgICovCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkaHR0cCNoZWFkCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgSEVBRGAgcmVxdWVzdC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgUmVsYXRpdmUgb3IgYWJzb2x1dGUgVVJMIHNwZWNpZnlpbmcgdGhlIGRlc3RpbmF0aW9uIG9mIHRoZSByZXF1ZXN0CiAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgKi8KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRodHRwI2pzb25wCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgSlNPTlBgIHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdC4KICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgIFNob3VsZCBjb250YWluIGBKU09OX0NBTExCQUNLYCBzdHJpbmcuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgKi8KICAgICAgICBjcmVhdGVTaG9ydE1ldGhvZHMoJ2dldCcsICdkZWxldGUnLCAnaGVhZCcsICdqc29ucCcpOwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGh0dHAjcG9zdAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogU2hvcnRjdXQgbWV0aG9kIHRvIHBlcmZvcm0gYFBPU1RgIHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIFJlbGF0aXZlIG9yIGFic29sdXRlIFVSTCBzcGVjaWZ5aW5nIHRoZSBkZXN0aW5hdGlvbiBvZiB0aGUgcmVxdWVzdAogICAgICAgICAqIEBwYXJhbSB7Kn0gZGF0YSBSZXF1ZXN0IGNvbnRlbnQKICAgICAgICAgKiBAcGFyYW0ge09iamVjdD19IGNvbmZpZyBPcHRpb25hbCBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAqIEByZXR1cm5zIHtIdHRwUHJvbWlzZX0gRnV0dXJlIG9iamVjdAogICAgICAgICAqLwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGh0dHAjcHV0CiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBTaG9ydGN1dCBtZXRob2QgdG8gcGVyZm9ybSBgUFVUYCByZXF1ZXN0LgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBSZWxhdGl2ZSBvciBhYnNvbHV0ZSBVUkwgc3BlY2lmeWluZyB0aGUgZGVzdGluYXRpb24gb2YgdGhlIHJlcXVlc3QKICAgICAgICAgKiBAcGFyYW0geyp9IGRhdGEgUmVxdWVzdCBjb250ZW50CiAgICAgICAgICogQHBhcmFtIHtPYmplY3Q9fSBjb25maWcgT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvYmplY3QKICAgICAgICAgKiBAcmV0dXJucyB7SHR0cFByb21pc2V9IEZ1dHVyZSBvYmplY3QKICAgICAgICAgKi8KICAgICAgICBjcmVhdGVTaG9ydE1ldGhvZHNXaXRoRGF0YSgncG9zdCcsICdwdXQnKTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICogQG5hbWUgJGh0dHAjZGVmYXVsdHMKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFJ1bnRpbWUgZXF1aXZhbGVudCBvZiB0aGUgYCRodHRwUHJvdmlkZXIuZGVmYXVsdHNgIHByb3BlcnR5LiBBbGxvd3MgY29uZmlndXJhdGlvbiBvZgogICAgICAgICAqIGRlZmF1bHQgaGVhZGVycywgd2l0aENyZWRlbnRpYWxzIGFzIHdlbGwgYXMgcmVxdWVzdCBhbmQgcmVzcG9uc2UgdHJhbnNmb3JtYXRpb25zLgogICAgICAgICAqCiAgICAgICAgICogU2VlICJTZXR0aW5nIEhUVFAgSGVhZGVycyIgYW5kICJUcmFuc2Zvcm1pbmcgUmVxdWVzdHMgYW5kIFJlc3BvbnNlcyIgc2VjdGlvbnMgYWJvdmUuCiAgICAgICAgICovCiAgICAgICAgJGh0dHAuZGVmYXVsdHMgPSBkZWZhdWx0czsKCgogICAgICAgIHJldHVybiAkaHR0cDsKCgogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kcyhuYW1lcykgewogICAgICAgICAgZm9yRWFjaChhcmd1bWVudHMsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgJGh0dHBbbmFtZV0gPSBmdW5jdGlvbih1cmwsIGNvbmZpZykgewogICAgICAgICAgICAgIHJldHVybiAkaHR0cChleHRlbmQoY29uZmlnIHx8IHt9LCB7CiAgICAgICAgICAgICAgICBtZXRob2Q6IG5hbWUsCiAgICAgICAgICAgICAgICB1cmw6IHVybAogICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0pOwogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVNob3J0TWV0aG9kc1dpdGhEYXRhKG5hbWUpIHsKICAgICAgICAgIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICRodHRwW25hbWVdID0gZnVuY3Rpb24odXJsLCBkYXRhLCBjb25maWcpIHsKICAgICAgICAgICAgICByZXR1cm4gJGh0dHAoZXh0ZW5kKGNvbmZpZyB8fCB7fSwgewogICAgICAgICAgICAgICAgbWV0aG9kOiBuYW1lLAogICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICB9OwogICAgICAgICAgfSk7CiAgICAgICAgfQoKCiAgICAgICAgLyoqCiAgICAgICAgICogTWFrZXMgdGhlIHJlcXVlc3QuCiAgICAgICAgICoKICAgICAgICAgKiAhISEgQUNDRVNTRVMgQ0xPU1VSRSBWQVJTOgogICAgICAgICAqICRodHRwQmFja2VuZCwgZGVmYXVsdHMsICRsb2csICRyb290U2NvcGUsIGRlZmF1bHRDYWNoZSwgJGh0dHAucGVuZGluZ1JlcXVlc3RzCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gc2VuZFJlcShjb25maWcsIHJlcURhdGEsIHJlcUhlYWRlcnMpIHsKICAgICAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCksCiAgICAgICAgICAgIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlLAogICAgICAgICAgICBjYWNoZSwKICAgICAgICAgICAgY2FjaGVkUmVzcCwKICAgICAgICAgICAgdXJsID0gYnVpbGRVcmwoY29uZmlnLnVybCwgY29uZmlnLnBhcmFtcyk7CgogICAgICAgICAgJGh0dHAucGVuZGluZ1JlcXVlc3RzLnB1c2goY29uZmlnKTsKICAgICAgICAgIHByb21pc2UudGhlbihyZW1vdmVQZW5kaW5nUmVxLCByZW1vdmVQZW5kaW5nUmVxKTsKCgogICAgICAgICAgaWYgKChjb25maWcuY2FjaGUgfHwgZGVmYXVsdHMuY2FjaGUpICYmIGNvbmZpZy5jYWNoZSAhPT0gZmFsc2UgJiYgY29uZmlnLm1ldGhvZCA9PSAnR0VUJykgewogICAgICAgICAgICBjYWNoZSA9IGlzT2JqZWN0KGNvbmZpZy5jYWNoZSkgPyBjb25maWcuY2FjaGUKICAgICAgICAgICAgICA6IGlzT2JqZWN0KGRlZmF1bHRzLmNhY2hlKSA/IGRlZmF1bHRzLmNhY2hlCiAgICAgICAgICAgICAgOiBkZWZhdWx0Q2FjaGU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgICAgIGNhY2hlZFJlc3AgPSBjYWNoZS5nZXQodXJsKTsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChjYWNoZWRSZXNwKSkgewogICAgICAgICAgICAgIGlmIChjYWNoZWRSZXNwLnRoZW4pIHsKICAgICAgICAgICAgICAgIC8vIGNhY2hlZCByZXF1ZXN0IGhhcyBhbHJlYWR5IGJlZW4gc2VudCwgYnV0IHRoZXJlIGlzIG5vIHJlc3BvbnNlIHlldAogICAgICAgICAgICAgICAgY2FjaGVkUmVzcC50aGVuKHJlbW92ZVBlbmRpbmdSZXEsIHJlbW92ZVBlbmRpbmdSZXEpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhY2hlZFJlc3A7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHNlcnZpbmcgZnJvbSBjYWNoZQogICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UoY2FjaGVkUmVzcFsxXSwgY2FjaGVkUmVzcFswXSwgc2hhbGxvd0NvcHkoY2FjaGVkUmVzcFsyXSksIGNhY2hlZFJlc3BbM10pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVzb2x2ZVByb21pc2UoY2FjaGVkUmVzcCwgMjAwLCB7fSwgJ09LJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIHB1dCB0aGUgcHJvbWlzZSBmb3IgdGhlIG5vbi10cmFuc2Zvcm1lZCByZXNwb25zZSBpbnRvIGNhY2hlIGFzIGEgcGxhY2Vob2xkZXIKICAgICAgICAgICAgICBjYWNoZS5wdXQodXJsLCBwcm9taXNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIGlmIHdlIHdvbid0IGhhdmUgdGhlIHJlc3BvbnNlIGluIGNhY2hlLCBzZW5kIHRoZSByZXF1ZXN0IHRvIHRoZSBiYWNrZW5kCiAgICAgICAgICBpZiAoaXNVbmRlZmluZWQoY2FjaGVkUmVzcCkpIHsKICAgICAgICAgICAgJGh0dHBCYWNrZW5kKGNvbmZpZy5tZXRob2QsIHVybCwgcmVxRGF0YSwgZG9uZSwgcmVxSGVhZGVycywgY29uZmlnLnRpbWVvdXQsCiAgICAgICAgICAgICAgY29uZmlnLndpdGhDcmVkZW50aWFscywgY29uZmlnLnJlc3BvbnNlVHlwZSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHByb21pc2U7CgoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQ2FsbGJhY2sgcmVnaXN0ZXJlZCB0byAkaHR0cEJhY2tlbmQoKToKICAgICAgICAgICAqICAtIGNhY2hlcyB0aGUgcmVzcG9uc2UgaWYgZGVzaXJlZAogICAgICAgICAgICogIC0gcmVzb2x2ZXMgdGhlIHJhdyAkaHR0cCBwcm9taXNlCiAgICAgICAgICAgKiAgLSBjYWxscyAkYXBwbHkKICAgICAgICAgICAqLwogICAgICAgICAgZnVuY3Rpb24gZG9uZShzdGF0dXMsIHJlc3BvbnNlLCBoZWFkZXJzU3RyaW5nLCBzdGF0dXNUZXh0KSB7CiAgICAgICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgICAgIGlmIChpc1N1Y2Nlc3Moc3RhdHVzKSkgewogICAgICAgICAgICAgICAgY2FjaGUucHV0KHVybCwgW3N0YXR1cywgcmVzcG9uc2UsIHBhcnNlSGVhZGVycyhoZWFkZXJzU3RyaW5nKSwgc3RhdHVzVGV4dF0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyByZW1vdmUgcHJvbWlzZSBmcm9tIHRoZSBjYWNoZQogICAgICAgICAgICAgICAgY2FjaGUucmVtb3ZlKHVybCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXNvbHZlUHJvbWlzZShyZXNwb25zZSwgc3RhdHVzLCBoZWFkZXJzU3RyaW5nLCBzdGF0dXNUZXh0KTsKICAgICAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UpICRyb290U2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICB9CgoKICAgICAgICAgIC8qKgogICAgICAgICAgICogUmVzb2x2ZXMgdGhlIHJhdyAkaHR0cCBwcm9taXNlLgogICAgICAgICAgICovCiAgICAgICAgICBmdW5jdGlvbiByZXNvbHZlUHJvbWlzZShyZXNwb25zZSwgc3RhdHVzLCBoZWFkZXJzLCBzdGF0dXNUZXh0KSB7CiAgICAgICAgICAgIC8vIG5vcm1hbGl6ZSBpbnRlcm5hbCBzdGF0dXNlcyB0byAwCiAgICAgICAgICAgIHN0YXR1cyA9IE1hdGgubWF4KHN0YXR1cywgMCk7CgogICAgICAgICAgICAoaXNTdWNjZXNzKHN0YXR1cykgPyBkZWZlcnJlZC5yZXNvbHZlIDogZGVmZXJyZWQucmVqZWN0KSh7CiAgICAgICAgICAgICAgZGF0YTogcmVzcG9uc2UsCiAgICAgICAgICAgICAgc3RhdHVzOiBzdGF0dXMsCiAgICAgICAgICAgICAgaGVhZGVyczogaGVhZGVyc0dldHRlcihoZWFkZXJzKSwKICAgICAgICAgICAgICBjb25maWc6IGNvbmZpZywKICAgICAgICAgICAgICBzdGF0dXNUZXh0IDogc3RhdHVzVGV4dAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCgogICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlUGVuZGluZ1JlcSgpIHsKICAgICAgICAgICAgdmFyIGlkeCA9IGluZGV4T2YoJGh0dHAucGVuZGluZ1JlcXVlc3RzLCBjb25maWcpOwogICAgICAgICAgICBpZiAoaWR4ICE9PSAtMSkgJGh0dHAucGVuZGluZ1JlcXVlc3RzLnNwbGljZShpZHgsIDEpOwogICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIGZ1bmN0aW9uIGJ1aWxkVXJsKHVybCwgcGFyYW1zKSB7CiAgICAgICAgICBpZiAoIXBhcmFtcykgcmV0dXJuIHVybDsKICAgICAgICAgIHZhciBwYXJ0cyA9IFtdOwogICAgICAgICAgZm9yRWFjaFNvcnRlZChwYXJhbXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IGlzVW5kZWZpbmVkKHZhbHVlKSkgcmV0dXJuOwogICAgICAgICAgICBpZiAoIWlzQXJyYXkodmFsdWUpKSB2YWx1ZSA9IFt2YWx1ZV07CgogICAgICAgICAgICBmb3JFYWNoKHZhbHVlLCBmdW5jdGlvbih2KSB7CiAgICAgICAgICAgICAgaWYgKGlzT2JqZWN0KHYpKSB7CiAgICAgICAgICAgICAgICB2ID0gdG9Kc29uKHYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJ0cy5wdXNoKGVuY29kZVVyaVF1ZXJ5KGtleSkgKyAnPScgKwogICAgICAgICAgICAgICAgZW5jb2RlVXJpUXVlcnkodikpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgICAgaWYocGFydHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB1cmwgKz0gKCh1cmwuaW5kZXhPZignPycpID09IC0xKSA/ICc/JyA6ICcmJykgKyBwYXJ0cy5qb2luKCcmJyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXJsOwogICAgICAgIH0KCgogICAgICB9XTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZVhocihtZXRob2QpIHsKICAgIC8vaWYgSUUgYW5kIHRoZSBtZXRob2QgaXMgbm90IFJGQzI2MTYgY29tcGxpYW50LCBvciBpZiBYTUxIdHRwUmVxdWVzdAogICAgLy9pcyBub3QgYXZhaWxhYmxlLCB0cnkgZ2V0dGluZyBhbiBBY3RpdmVYT2JqZWN0LiBPdGhlcndpc2UsIHVzZSBYTUxIdHRwUmVxdWVzdAogICAgLy9pZiBpdCBpcyBhdmFpbGFibGUKICAgIGlmIChtc2llIDw9IDggJiYgKCFtZXRob2QubWF0Y2goL14oZ2V0fHBvc3R8aGVhZHxwdXR8ZGVsZXRlfG9wdGlvbnMpJC9pKSB8fAogICAgICAhd2luZG93LlhNTEh0dHBSZXF1ZXN0KSkgewogICAgICByZXR1cm4gbmV3IHdpbmRvdy5BY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MSFRUUCIpOwogICAgfSBlbHNlIGlmICh3aW5kb3cuWE1MSHR0cFJlcXVlc3QpIHsKICAgICAgcmV0dXJuIG5ldyB3aW5kb3cuWE1MSHR0cFJlcXVlc3QoKTsKICAgIH0KCiAgICB0aHJvdyBtaW5FcnIoJyRodHRwQmFja2VuZCcpKCdub3hocicsICJUaGlzIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBYTUxIdHRwUmVxdWVzdC4iKTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGh0dHBCYWNrZW5kCiAgICogQHJlcXVpcmVzICR3aW5kb3cKICAgKiBAcmVxdWlyZXMgJGRvY3VtZW50CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBIVFRQIGJhY2tlbmQgdXNlZCBieSB0aGUge0BsaW5rIG5nLiRodHRwIHNlcnZpY2V9IHRoYXQgZGVsZWdhdGVzIHRvCiAgICogWE1MSHR0cFJlcXVlc3Qgb2JqZWN0IG9yIEpTT05QIGFuZCBkZWFscyB3aXRoIGJyb3dzZXIgaW5jb21wYXRpYmlsaXRpZXMuCiAgICoKICAgKiBZb3Ugc2hvdWxkIG5ldmVyIG5lZWQgdG8gdXNlIHRoaXMgc2VydmljZSBkaXJlY3RseSwgaW5zdGVhZCB1c2UgdGhlIGhpZ2hlci1sZXZlbCBhYnN0cmFjdGlvbnM6CiAgICoge0BsaW5rIG5nLiRodHRwICRodHRwfSBvciB7QGxpbmsgbmdSZXNvdXJjZS4kcmVzb3VyY2UgJHJlc291cmNlfS4KICAgKgogICAqIER1cmluZyB0ZXN0aW5nIHRoaXMgaW1wbGVtZW50YXRpb24gaXMgc3dhcHBlZCB3aXRoIHtAbGluayBuZ01vY2suJGh0dHBCYWNrZW5kIG1vY2sKICogJGh0dHBCYWNrZW5kfSB3aGljaCBjYW4gYmUgdHJhaW5lZCB3aXRoIHJlc3BvbnNlcy4KICAgKi8KICBmdW5jdGlvbiAkSHR0cEJhY2tlbmRQcm92aWRlcigpIHsKICAgIHRoaXMuJGdldCA9IFsnJGJyb3dzZXInLCAnJHdpbmRvdycsICckZG9jdW1lbnQnLCBmdW5jdGlvbigkYnJvd3NlciwgJHdpbmRvdywgJGRvY3VtZW50KSB7CiAgICAgIHJldHVybiBjcmVhdGVIdHRwQmFja2VuZCgkYnJvd3NlciwgY3JlYXRlWGhyLCAkYnJvd3Nlci5kZWZlciwgJHdpbmRvdy5hbmd1bGFyLmNhbGxiYWNrcywgJGRvY3VtZW50WzBdKTsKICAgIH1dOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlSHR0cEJhY2tlbmQoJGJyb3dzZXIsIGNyZWF0ZVhociwgJGJyb3dzZXJEZWZlciwgY2FsbGJhY2tzLCByYXdEb2N1bWVudCkgewogICAgdmFyIEFCT1JURUQgPSAtMTsKCiAgICAvLyBUT0RPKHZvanRhKTogZml4IHRoZSBzaWduYXR1cmUKICAgIHJldHVybiBmdW5jdGlvbihtZXRob2QsIHVybCwgcG9zdCwgY2FsbGJhY2ssIGhlYWRlcnMsIHRpbWVvdXQsIHdpdGhDcmVkZW50aWFscywgcmVzcG9uc2VUeXBlKSB7CiAgICAgIHZhciBzdGF0dXM7CiAgICAgICRicm93c2VyLiQkaW5jT3V0c3RhbmRpbmdSZXF1ZXN0Q291bnQoKTsKICAgICAgdXJsID0gdXJsIHx8ICRicm93c2VyLnVybCgpOwoKICAgICAgaWYgKGxvd2VyY2FzZShtZXRob2QpID09ICdqc29ucCcpIHsKICAgICAgICB2YXIgY2FsbGJhY2tJZCA9ICdfJyArIChjYWxsYmFja3MuY291bnRlcisrKS50b1N0cmluZygzNik7CiAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEgPSBkYXRhOwogICAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmNhbGxlZCA9IHRydWU7CiAgICAgICAgfTsKCiAgICAgICAgdmFyIGpzb25wRG9uZSA9IGpzb25wUmVxKHVybC5yZXBsYWNlKCdKU09OX0NBTExCQUNLJywgJ2FuZ3VsYXIuY2FsbGJhY2tzLicgKyBjYWxsYmFja0lkKSwKICAgICAgICAgIGNhbGxiYWNrSWQsIGZ1bmN0aW9uKHN0YXR1cywgdGV4dCkgewogICAgICAgICAgICBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIHN0YXR1cywgY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmRhdGEsICIiLCB0ZXh0KTsKICAgICAgICAgICAgY2FsbGJhY2tzW2NhbGxiYWNrSWRdID0gbm9vcDsKICAgICAgICAgIH0pOwogICAgICB9IGVsc2UgewoKICAgICAgICB2YXIgeGhyID0gY3JlYXRlWGhyKG1ldGhvZCk7CgogICAgICAgIHhoci5vcGVuKG1ldGhvZCwgdXJsLCB0cnVlKTsKICAgICAgICBmb3JFYWNoKGhlYWRlcnMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBJbiBJRTYgYW5kIDcsIHRoaXMgbWlnaHQgYmUgY2FsbGVkIHN5bmNocm9ub3VzbHkgd2hlbiB4aHIuc2VuZCBiZWxvdyBpcyBjYWxsZWQgYW5kIHRoZQogICAgICAgIC8vIHJlc3BvbnNlIGlzIGluIHRoZSBjYWNoZS4gdGhlIHByb21pc2UgYXBpIHdpbGwgZW5zdXJlIHRoYXQgdG8gdGhlIGFwcCBjb2RlIHRoZSBhcGkgaXMKICAgICAgICAvLyBhbHdheXMgYXN5bmMKICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAvLyBvbnJlYWR5c3RhdGVjaGFuZ2UgbWlnaHQgZ2V0IGNhbGxlZCBtdWx0aXBsZSB0aW1lcyB3aXRoIHJlYWR5U3RhdGUgPT09IDQgb24gbW9iaWxlIHdlYmtpdCBjYXVzZWQgYnkKICAgICAgICAgIC8vIHhocnMgdGhhdCBhcmUgcmVzb2x2ZWQgd2hpbGUgdGhlIGFwcCBpcyBpbiB0aGUgYmFja2dyb3VuZCAoc2VlICM1NDI2KS4KICAgICAgICAgIC8vIHNpbmNlIGNhbGxpbmcgY29tcGxldGVSZXF1ZXN0IHNldHMgdGhlIGB4aHJgIHZhcmlhYmxlIHRvIG51bGwsIHdlIGp1c3QgY2hlY2sgaWYgaXQncyBub3QgbnVsbCBiZWZvcmUKICAgICAgICAgIC8vIGNvbnRpbnVpbmcKICAgICAgICAgIC8vCiAgICAgICAgICAvLyB3ZSBjYW4ndCBzZXQgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSB0byB1bmRlZmluZWQgb3IgZGVsZXRlIGl0IGJlY2F1c2UgdGhhdCBicmVha3MgSUU4IChtZXRob2Q9UEFUQ0gpIGFuZAogICAgICAgICAgLy8gU2FmYXJpIHJlc3BlY3RpdmVseS4KICAgICAgICAgIGlmICh4aHIgJiYgeGhyLnJlYWR5U3RhdGUgPT0gNCkgewogICAgICAgICAgICB2YXIgcmVzcG9uc2VIZWFkZXJzID0gbnVsbCwKICAgICAgICAgICAgICByZXNwb25zZSA9IG51bGw7CgogICAgICAgICAgICBpZihzdGF0dXMgIT09IEFCT1JURUQpIHsKICAgICAgICAgICAgICByZXNwb25zZUhlYWRlcnMgPSB4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCk7CgogICAgICAgICAgICAgIC8vIHJlc3BvbnNlVGV4dCBpcyB0aGUgb2xkLXNjaG9vbCB3YXkgb2YgcmV0cmlldmluZyByZXNwb25zZSAoc3VwcG9ydGVkIGJ5IElFOCAmIDkpCiAgICAgICAgICAgICAgLy8gcmVzcG9uc2UvcmVzcG9uc2VUeXBlIHByb3BlcnRpZXMgd2VyZSBpbnRyb2R1Y2VkIGluIFhIUiBMZXZlbDIgc3BlYyAoc3VwcG9ydGVkIGJ5IElFMTApCiAgICAgICAgICAgICAgcmVzcG9uc2UgPSAoJ3Jlc3BvbnNlJyBpbiB4aHIpID8geGhyLnJlc3BvbnNlIDogeGhyLnJlc3BvbnNlVGV4dDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29tcGxldGVSZXF1ZXN0KGNhbGxiYWNrLAogICAgICAgICAgICAgICAgc3RhdHVzIHx8IHhoci5zdGF0dXMsCiAgICAgICAgICAgICAgcmVzcG9uc2UsCiAgICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzLAogICAgICAgICAgICAgICAgeGhyLnN0YXR1c1RleHQgfHwgJycpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGlmICh3aXRoQ3JlZGVudGlhbHMpIHsKICAgICAgICAgIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHJlc3BvbnNlVHlwZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgeGhyLnJlc3BvbnNlVHlwZSA9IHJlc3BvbnNlVHlwZTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgLy8gV2ViS2l0IGFkZGVkIHN1cHBvcnQgZm9yIHRoZSBqc29uIHJlc3BvbnNlVHlwZSB2YWx1ZSBvbiAwOS8wMy8yMDEzCiAgICAgICAgICAgIC8vIGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD03MzY0OC4gVmVyc2lvbnMgb2YgU2FmYXJpIHByaW9yIHRvIDcgYXJlCiAgICAgICAgICAgIC8vIGtub3duIHRvIHRocm93IHdoZW4gc2V0dGluZyB0aGUgdmFsdWUgImpzb24iIGFzIHRoZSByZXNwb25zZSB0eXBlLiBPdGhlciBvbGRlcgogICAgICAgICAgICAvLyBicm93c2VycyBpbXBsZW1lbnRpbmcgdGhlIHJlc3BvbnNlVHlwZQogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBUaGUganNvbiByZXNwb25zZSB0eXBlIGNhbiBiZSBpZ25vcmVkIGlmIG5vdCBzdXBwb3J0ZWQsIGJlY2F1c2UgSlNPTiBwYXlsb2FkcyBhcmUKICAgICAgICAgICAgLy8gcGFyc2VkIG9uIHRoZSBjbGllbnQtc2lkZSByZWdhcmRsZXNzLgogICAgICAgICAgICBpZiAocmVzcG9uc2VUeXBlICE9PSAnanNvbicpIHsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB4aHIuc2VuZChwb3N0IHx8IG51bGwpOwogICAgICB9CgogICAgICBpZiAodGltZW91dCA+IDApIHsKICAgICAgICB2YXIgdGltZW91dElkID0gJGJyb3dzZXJEZWZlcih0aW1lb3V0UmVxdWVzdCwgdGltZW91dCk7CiAgICAgIH0gZWxzZSBpZiAodGltZW91dCAmJiB0aW1lb3V0LnRoZW4pIHsKICAgICAgICB0aW1lb3V0LnRoZW4odGltZW91dFJlcXVlc3QpOwogICAgICB9CgoKICAgICAgZnVuY3Rpb24gdGltZW91dFJlcXVlc3QoKSB7CiAgICAgICAgc3RhdHVzID0gQUJPUlRFRDsKICAgICAgICBqc29ucERvbmUgJiYganNvbnBEb25lKCk7CiAgICAgICAgeGhyICYmIHhoci5hYm9ydCgpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjb21wbGV0ZVJlcXVlc3QoY2FsbGJhY2ssIHN0YXR1cywgcmVzcG9uc2UsIGhlYWRlcnNTdHJpbmcsIHN0YXR1c1RleHQpIHsKICAgICAgICAvLyBjYW5jZWwgdGltZW91dCBhbmQgc3Vic2VxdWVudCB0aW1lb3V0IHByb21pc2UgcmVzb2x1dGlvbgogICAgICAgIHRpbWVvdXRJZCAmJiAkYnJvd3NlckRlZmVyLmNhbmNlbCh0aW1lb3V0SWQpOwogICAgICAgIGpzb25wRG9uZSA9IHhociA9IG51bGw7CgogICAgICAgIC8vIGZpeCBzdGF0dXMgY29kZSB3aGVuIGl0IGlzIDAgKDAgc3RhdHVzIGlzIHVuZG9jdW1lbnRlZCkuCiAgICAgICAgLy8gT2NjdXJzIHdoZW4gYWNjZXNzaW5nIGZpbGUgcmVzb3VyY2VzIG9yIG9uIEFuZHJvaWQgNC4xIHN0b2NrIGJyb3dzZXIKICAgICAgICAvLyB3aGlsZSByZXRyaWV2aW5nIGZpbGVzIGZyb20gYXBwbGljYXRpb24gY2FjaGUuCiAgICAgICAgaWYgKHN0YXR1cyA9PT0gMCkgewogICAgICAgICAgc3RhdHVzID0gcmVzcG9uc2UgPyAyMDAgOiB1cmxSZXNvbHZlKHVybCkucHJvdG9jb2wgPT0gJ2ZpbGUnID8gNDA0IDogMDsKICAgICAgICB9CgogICAgICAgIC8vIG5vcm1hbGl6ZSBJRSBidWcgKGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzE0NTApCiAgICAgICAgc3RhdHVzID0gc3RhdHVzID09PSAxMjIzID8gMjA0IDogc3RhdHVzOwogICAgICAgIHN0YXR1c1RleHQgPSBzdGF0dXNUZXh0IHx8ICcnOwoKICAgICAgICBjYWxsYmFjayhzdGF0dXMsIHJlc3BvbnNlLCBoZWFkZXJzU3RyaW5nLCBzdGF0dXNUZXh0KTsKICAgICAgICAkYnJvd3Nlci4kJGNvbXBsZXRlT3V0c3RhbmRpbmdSZXF1ZXN0KG5vb3ApOwogICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIGpzb25wUmVxKHVybCwgY2FsbGJhY2tJZCwgZG9uZSkgewogICAgICAvLyB3ZSBjYW4ndCB1c2UgalF1ZXJ5L2pxTGl0ZSBoZXJlIGJlY2F1c2UgalF1ZXJ5IGRvZXMgY3Jhenkgc2hpdCB3aXRoIHNjcmlwdCBlbGVtZW50cywgZS5nLjoKICAgICAgLy8gLSBmZXRjaGVzIGxvY2FsIHNjcmlwdHMgdmlhIFhIUiBhbmQgZXZhbHMgdGhlbQogICAgICAvLyAtIGFkZHMgYW5kIGltbWVkaWF0ZWx5IHJlbW92ZXMgc2NyaXB0IGVsZW1lbnRzIGZyb20gdGhlIGRvY3VtZW50CiAgICAgIHZhciBzY3JpcHQgPSByYXdEb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwgY2FsbGJhY2sgPSBudWxsOwogICAgICBzY3JpcHQudHlwZSA9ICJ0ZXh0L2phdmFzY3JpcHQiOwogICAgICBzY3JpcHQuc3JjID0gdXJsOwogICAgICBzY3JpcHQuYXN5bmMgPSB0cnVlOwoKICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihzY3JpcHQsICJsb2FkIiwgY2FsbGJhY2spOwogICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXJGbihzY3JpcHQsICJlcnJvciIsIGNhbGxiYWNrKTsKICAgICAgICByYXdEb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHNjcmlwdCk7CiAgICAgICAgc2NyaXB0ID0gbnVsbDsKICAgICAgICB2YXIgc3RhdHVzID0gLTE7CiAgICAgICAgdmFyIHRleHQgPSAidW5rbm93biI7CgogICAgICAgIGlmIChldmVudCkgewogICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJsb2FkIiAmJiAhY2FsbGJhY2tzW2NhbGxiYWNrSWRdLmNhbGxlZCkgewogICAgICAgICAgICBldmVudCA9IHsgdHlwZTogImVycm9yIiB9OwogICAgICAgICAgfQogICAgICAgICAgdGV4dCA9IGV2ZW50LnR5cGU7CiAgICAgICAgICBzdGF0dXMgPSBldmVudC50eXBlID09PSAiZXJyb3IiID8gNDA0IDogMjAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRvbmUpIHsKICAgICAgICAgIGRvbmUoc3RhdHVzLCB0ZXh0KTsKICAgICAgICB9CiAgICAgIH07CgogICAgICBhZGRFdmVudExpc3RlbmVyRm4oc2NyaXB0LCAibG9hZCIsIGNhbGxiYWNrKTsKICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKHNjcmlwdCwgImVycm9yIiwgY2FsbGJhY2spOwoKICAgICAgaWYgKG1zaWUgPD0gOCkgewogICAgICAgIHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChpc1N0cmluZyhzY3JpcHQucmVhZHlTdGF0ZSkgJiYgL2xvYWRlZHxjb21wbGV0ZS8udGVzdChzY3JpcHQucmVhZHlTdGF0ZSkpIHsKICAgICAgICAgICAgc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CiAgICAgICAgICAgIGNhbGxiYWNrKHsKICAgICAgICAgICAgICB0eXBlOiAnbG9hZCcKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmF3RG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgICByZXR1cm4gY2FsbGJhY2s7CiAgICB9CiAgfQoKICB2YXIgJGludGVycG9sYXRlTWluRXJyID0gbWluRXJyKCckaW50ZXJwb2xhdGUnKTsKCiAgLyoqCiAgICogQG5nZG9jIHByb3ZpZGVyCiAgICogQG5hbWUgJGludGVycG9sYXRlUHJvdmlkZXIKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBVc2VkIGZvciBjb25maWd1cmluZyB0aGUgaW50ZXJwb2xhdGlvbiBtYXJrdXAuIERlZmF1bHRzIHRvIGB7e2AgYW5kIGB9fWAuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9ImN1c3RvbUludGVycG9sYXRpb25BcHAiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgdmFyIGN1c3RvbUludGVycG9sYXRpb25BcHAgPSBhbmd1bGFyLm1vZHVsZSgnY3VzdG9tSW50ZXJwb2xhdGlvbkFwcCcsIFtdKTsKCiAgIGN1c3RvbUludGVycG9sYXRpb25BcHAuY29uZmlnKGZ1bmN0aW9uKCRpbnRlcnBvbGF0ZVByb3ZpZGVyKSB7CiAgICAkaW50ZXJwb2xhdGVQcm92aWRlci5zdGFydFN5bWJvbCgnLy8nKTsKICAgICRpbnRlcnBvbGF0ZVByb3ZpZGVyLmVuZFN5bWJvbCgnLy8nKTsKICB9KTsKCgogICBjdXN0b21JbnRlcnBvbGF0aW9uQXBwLmNvbnRyb2xsZXIoJ0RlbW9Db250cm9sbGVyJywgZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubGFiZWwgPSAiVGhpcyBiaW5kaW5nIGlzIGJyb3VnaHQgeW91IGJ5IC8vIGludGVycG9sYXRpb24gc3ltYm9scy4iOwogIH0pOwogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1hcHA9IkFwcCIgbmctY29udHJvbGxlcj0iRGVtb0NvbnRyb2xsZXIgYXMgZGVtbyI+CiAgIC8vZGVtby5sYWJlbC8vCiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGludGVycG9sYXRlIGJpbmRpbmcgd2l0aCBjdXN0b20gc3ltYm9scycsIGZ1bmN0aW9uKCkgewogICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnZGVtby5sYWJlbCcpKS5nZXRUZXh0KCkpLnRvQmUoJ1RoaXMgYmluZGluZyBpcyBicm91Z2h0IHlvdSBieSAvLyBpbnRlcnBvbGF0aW9uIHN5bWJvbHMuJyk7CiAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIGZ1bmN0aW9uICRJbnRlcnBvbGF0ZVByb3ZpZGVyKCkgewogICAgdmFyIHN0YXJ0U3ltYm9sID0gJ3t7JzsKICAgIHZhciBlbmRTeW1ib2wgPSAnfX0nOwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGludGVycG9sYXRlUHJvdmlkZXIjc3RhcnRTeW1ib2wKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3ltYm9sIHRvIGRlbm90ZSBzdGFydCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBge3tgLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSB2YWx1ZSBuZXcgdmFsdWUgdG8gc2V0IHRoZSBzdGFydGluZyBzeW1ib2wgdG8uCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAgICovCiAgICB0aGlzLnN0YXJ0U3ltYm9sID0gZnVuY3Rpb24odmFsdWUpewogICAgICBpZiAodmFsdWUpIHsKICAgICAgICBzdGFydFN5bWJvbCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBzdGFydFN5bWJvbDsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpbnRlcnBvbGF0ZVByb3ZpZGVyI2VuZFN5bWJvbAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTeW1ib2wgdG8gZGVub3RlIHRoZSBlbmQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYH19YC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHZhbHVlIG5ldyB2YWx1ZSB0byBzZXQgdGhlIGVuZGluZyBzeW1ib2wgdG8uCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHNlbGZ9IFJldHVybnMgdGhlIHN5bWJvbCB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMgc2V0dGVyLgogICAgICovCiAgICB0aGlzLmVuZFN5bWJvbCA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgZW5kU3ltYm9sID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGVuZFN5bWJvbDsKICAgICAgfQogICAgfTsKCgogICAgdGhpcy4kZ2V0ID0gWyckcGFyc2UnLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJHNjZScsIGZ1bmN0aW9uKCRwYXJzZSwgJGV4Y2VwdGlvbkhhbmRsZXIsICRzY2UpIHsKICAgICAgdmFyIHN0YXJ0U3ltYm9sTGVuZ3RoID0gc3RhcnRTeW1ib2wubGVuZ3RoLAogICAgICAgIGVuZFN5bWJvbExlbmd0aCA9IGVuZFN5bWJvbC5sZW5ndGg7CgogICAgICAvKioKICAgICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAgICogQG5hbWUgJGludGVycG9sYXRlCiAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAqCiAgICAgICAqIEByZXF1aXJlcyAkcGFyc2UKICAgICAgICogQHJlcXVpcmVzICRzY2UKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqCiAgICAgICAqIENvbXBpbGVzIGEgc3RyaW5nIHdpdGggbWFya3VwIGludG8gYW4gaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4gVGhpcyBzZXJ2aWNlIGlzIHVzZWQgYnkgdGhlCiAgICAgICAqIEhUTUwge0BsaW5rIG5nLiRjb21waWxlICRjb21waWxlfSBzZXJ2aWNlIGZvciBkYXRhIGJpbmRpbmcuIFNlZQogICAgICAgKiB7QGxpbmsgbmcuJGludGVycG9sYXRlUHJvdmlkZXIgJGludGVycG9sYXRlUHJvdmlkZXJ9IGZvciBjb25maWd1cmluZyB0aGUKICAgICAgICogaW50ZXJwb2xhdGlvbiBtYXJrdXAuCiAgICAgICAqCiAgICAgICAqCiAgICAgICAqIGBgYGpzCiAgICAgICAqICAgdmFyICRpbnRlcnBvbGF0ZSA9IC4uLjsgLy8gaW5qZWN0ZWQKICAgICAgICogICB2YXIgZXhwID0gJGludGVycG9sYXRlKCdIZWxsbyB7e25hbWUgfCB1cHBlcmNhc2V9fSEnKTsKICAgICAgICogICBleHBlY3QoZXhwKHtuYW1lOidBbmd1bGFyJ30pLnRvRXF1YWwoJ0hlbGxvIEFOR1VMQVIhJyk7CiAgICAgICAqIGBgYAogICAgICAgKgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBUaGUgdGV4dCB3aXRoIG1hcmt1cCB0byBpbnRlcnBvbGF0ZS4KICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gbXVzdEhhdmVFeHByZXNzaW9uIGlmIHNldCB0byB0cnVlIHRoZW4gdGhlIGludGVycG9sYXRpb24gc3RyaW5nIG11c3QgaGF2ZQogICAgICAgKiAgICBlbWJlZGRlZCBleHByZXNzaW9uIGluIG9yZGVyIHRvIHJldHVybiBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uLiBTdHJpbmdzIHdpdGggbm8KICAgICAgICogICAgZW1iZWRkZWQgZXhwcmVzc2lvbiB3aWxsIHJldHVybiBudWxsIGZvciB0aGUgaW50ZXJwb2xhdGlvbiBmdW5jdGlvbi4KICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSB0cnVzdGVkQ29udGV4dCB3aGVuIHByb3ZpZGVkLCB0aGUgcmV0dXJuZWQgZnVuY3Rpb24gcGFzc2VzIHRoZSBpbnRlcnBvbGF0ZWQKICAgICAgICogICAgcmVzdWx0IHRocm91Z2gge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWQoaW50ZXJwb2xhdGVkUmVzdWx0LAogICAgICogICAgdHJ1c3RlZENvbnRleHQpfSBiZWZvcmUgcmV0dXJuaW5nIGl0LiAgUmVmZXIgdG8gdGhlIHtAbGluayBuZy4kc2NlICRzY2V9IHNlcnZpY2UgdGhhdAogICAgICAgKiAgICBwcm92aWRlcyBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyBmb3IgZGV0YWlscy4KICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQpfSBhbiBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uIHdoaWNoIGlzIHVzZWQgdG8gY29tcHV0ZSB0aGUKICAgICAgICogICAgaW50ZXJwb2xhdGVkIHN0cmluZy4gVGhlIGZ1bmN0aW9uIGhhcyB0aGVzZSBwYXJhbWV0ZXJzOgogICAgICAgKgogICAgICAgKiAgICAqIGBjb250ZXh0YDogYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzIGFyZSBldmFsdWF0ZWQKICAgICAgICogICAgICBhZ2FpbnN0LgogICAgICAgKgogICAgICAgKi8KICAgICAgZnVuY3Rpb24gJGludGVycG9sYXRlKHRleHQsIG11c3RIYXZlRXhwcmVzc2lvbiwgdHJ1c3RlZENvbnRleHQpIHsKICAgICAgICB2YXIgc3RhcnRJbmRleCwKICAgICAgICAgIGVuZEluZGV4LAogICAgICAgICAgaW5kZXggPSAwLAogICAgICAgICAgcGFydHMgPSBbXSwKICAgICAgICAgIGxlbmd0aCA9IHRleHQubGVuZ3RoLAogICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IGZhbHNlLAogICAgICAgICAgZm4sCiAgICAgICAgICBleHAsCiAgICAgICAgICBjb25jYXQgPSBbXTsKCiAgICAgICAgd2hpbGUoaW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmICggKChzdGFydEluZGV4ID0gdGV4dC5pbmRleE9mKHN0YXJ0U3ltYm9sLCBpbmRleCkpICE9IC0xKSAmJgogICAgICAgICAgICAoKGVuZEluZGV4ID0gdGV4dC5pbmRleE9mKGVuZFN5bWJvbCwgc3RhcnRJbmRleCArIHN0YXJ0U3ltYm9sTGVuZ3RoKSkgIT0gLTEpICkgewogICAgICAgICAgICAoaW5kZXggIT0gc3RhcnRJbmRleCkgJiYgcGFydHMucHVzaCh0ZXh0LnN1YnN0cmluZyhpbmRleCwgc3RhcnRJbmRleCkpOwogICAgICAgICAgICBwYXJ0cy5wdXNoKGZuID0gJHBhcnNlKGV4cCA9IHRleHQuc3Vic3RyaW5nKHN0YXJ0SW5kZXggKyBzdGFydFN5bWJvbExlbmd0aCwgZW5kSW5kZXgpKSk7CiAgICAgICAgICAgIGZuLmV4cCA9IGV4cDsKICAgICAgICAgICAgaW5kZXggPSBlbmRJbmRleCArIGVuZFN5bWJvbExlbmd0aDsKICAgICAgICAgICAgaGFzSW50ZXJwb2xhdGlvbiA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyB3ZSBkaWQgbm90IGZpbmQgYW55dGhpbmcsIHNvIHdlIGhhdmUgdG8gYWRkIHRoZSByZW1haW5kZXIgdG8gdGhlIHBhcnRzIGFycmF5CiAgICAgICAgICAgIChpbmRleCAhPSBsZW5ndGgpICYmIHBhcnRzLnB1c2godGV4dC5zdWJzdHJpbmcoaW5kZXgpKTsKICAgICAgICAgICAgaW5kZXggPSBsZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIShsZW5ndGggPSBwYXJ0cy5sZW5ndGgpKSB7CiAgICAgICAgICAvLyB3ZSBhZGRlZCwgbm90aGluZywgbXVzdCBoYXZlIGJlZW4gYW4gZW1wdHkgc3RyaW5nLgogICAgICAgICAgcGFydHMucHVzaCgnJyk7CiAgICAgICAgICBsZW5ndGggPSAxOwogICAgICAgIH0KCiAgICAgICAgLy8gQ29uY2F0ZW5hdGluZyBleHByZXNzaW9ucyBtYWtlcyBpdCBoYXJkIHRvIHJlYXNvbiBhYm91dCB3aGV0aGVyIHNvbWUgY29tYmluYXRpb24gb2YKICAgICAgICAvLyBjb25jYXRlbmF0ZWQgdmFsdWVzIGFyZSB1bnNhZmUgdG8gdXNlIGFuZCBjb3VsZCBlYXNpbHkgbGVhZCB0byBYU1MuICBCeSByZXF1aXJpbmcgdGhhdCBhCiAgICAgICAgLy8gc2luZ2xlIGV4cHJlc3Npb24gYmUgdXNlZCBmb3IgaWZyYW1lW3NyY10sIG9iamVjdFtzcmNdLCBldGMuLCB3ZSBlbnN1cmUgdGhhdCB0aGUgdmFsdWUKICAgICAgICAvLyB0aGF0J3MgdXNlZCBpcyBhc3NpZ25lZCBvciBjb25zdHJ1Y3RlZCBieSBzb21lIEpTIGNvZGUgc29tZXdoZXJlIHRoYXQgaXMgbW9yZSB0ZXN0YWJsZSBvcgogICAgICAgIC8vIG1ha2UgaXQgb2J2aW91cyB0aGF0IHlvdSBib3VuZCB0aGUgdmFsdWUgdG8gc29tZSB1c2VyIGNvbnRyb2xsZWQgdmFsdWUuICBUaGlzIGhlbHBzIHJlZHVjZQogICAgICAgIC8vIHRoZSBsb2FkIHdoZW4gYXVkaXRpbmcgZm9yIFhTUyBpc3N1ZXMuCiAgICAgICAgaWYgKHRydXN0ZWRDb250ZXh0ICYmIHBhcnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgIHRocm93ICRpbnRlcnBvbGF0ZU1pbkVycignbm9jb25jYXQnLAogICAgICAgICAgICAgICJFcnJvciB3aGlsZSBpbnRlcnBvbGF0aW5nOiB7MH1cblN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIGRpc2FsbG93cyAiICsKICAgICAgICAgICAgICAiaW50ZXJwb2xhdGlvbnMgdGhhdCBjb25jYXRlbmF0ZSBtdWx0aXBsZSBleHByZXNzaW9ucyB3aGVuIGEgdHJ1c3RlZCB2YWx1ZSBpcyAiICsKICAgICAgICAgICAgICAicmVxdWlyZWQuICBTZWUgaHR0cDovL2RvY3MuYW5ndWxhcmpzLm9yZy9hcGkvbmcuJHNjZSIsIHRleHQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFtdXN0SGF2ZUV4cHJlc3Npb24gIHx8IGhhc0ludGVycG9sYXRpb24pIHsKICAgICAgICAgIGNvbmNhdC5sZW5ndGggPSBsZW5ndGg7CiAgICAgICAgICBmbiA9IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBpaSA9IGxlbmd0aCwgcGFydDsgaTxpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIChwYXJ0ID0gcGFydHNbaV0pID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgcGFydCA9IHBhcnQoY29udGV4dCk7CiAgICAgICAgICAgICAgICAgIGlmICh0cnVzdGVkQ29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIHBhcnQgPSAkc2NlLmdldFRydXN0ZWQodHJ1c3RlZENvbnRleHQsIHBhcnQpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBhcnQgPSAkc2NlLnZhbHVlT2YocGFydCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHBhcnQgPT0gbnVsbCkgeyAvLyBudWxsIHx8IHVuZGVmaW5lZAogICAgICAgICAgICAgICAgICAgIHBhcnQgPSAnJzsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiBwYXJ0KSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ251bWJlcic6CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgPSAnJyArIHBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IHRvSnNvbihwYXJ0KTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbmNhdFtpXSA9IHBhcnQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBjb25jYXQuam9pbignJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2goZXJyKSB7CiAgICAgICAgICAgICAgdmFyIG5ld0VyciA9ICRpbnRlcnBvbGF0ZU1pbkVycignaW50ZXJyJywgIkNhbid0IGludGVycG9sYXRlOiB7MH1cbnsxfSIsIHRleHQsCiAgICAgICAgICAgICAgICBlcnIudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIobmV3RXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIGZuLmV4cCA9IHRleHQ7CiAgICAgICAgICBmbi5wYXJ0cyA9IHBhcnRzOwogICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAgICAgfQoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRpbnRlcnBvbGF0ZSNzdGFydFN5bWJvbAogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU3ltYm9sIHRvIGRlbm90ZSB0aGUgc3RhcnQgb2YgZXhwcmVzc2lvbiBpbiB0aGUgaW50ZXJwb2xhdGVkIHN0cmluZy4gRGVmYXVsdHMgdG8gYHt7YC4KICAgICAqCiAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sICRpbnRlcnBvbGF0ZVByb3ZpZGVyI3N0YXJ0U3ltYm9sfSB0byBjaGFuZ2UKICAgICAgICogdGhlIHN5bWJvbC4KICAgICAgICoKICAgICAgICogQHJldHVybnMge3N0cmluZ30gc3RhcnQgc3ltYm9sLgogICAgICAgKi8KICAgICAgJGludGVycG9sYXRlLnN0YXJ0U3ltYm9sID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHN0YXJ0U3ltYm9sOwogICAgICB9OwoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRpbnRlcnBvbGF0ZSNlbmRTeW1ib2wKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFN5bWJvbCB0byBkZW5vdGUgdGhlIGVuZCBvZiBleHByZXNzaW9uIGluIHRoZSBpbnRlcnBvbGF0ZWQgc3RyaW5nLiBEZWZhdWx0cyB0byBgfX1gLgogICAgICAgKgogICAgICAgKiBVc2Uge0BsaW5rIG5nLiRpbnRlcnBvbGF0ZVByb3ZpZGVyI2VuZFN5bWJvbCAkaW50ZXJwb2xhdGVQcm92aWRlciNlbmRTeW1ib2x9IHRvIGNoYW5nZQogICAgICAgKiB0aGUgc3ltYm9sLgogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBlbmQgc3ltYm9sLgogICAgICAgKi8KICAgICAgJGludGVycG9sYXRlLmVuZFN5bWJvbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBlbmRTeW1ib2w7CiAgICAgIH07CgogICAgICByZXR1cm4gJGludGVycG9sYXRlOwogICAgfV07CiAgfQoKICBmdW5jdGlvbiAkSW50ZXJ2YWxQcm92aWRlcigpIHsKICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckd2luZG93JywgJyRxJywKICAgICAgZnVuY3Rpb24oJHJvb3RTY29wZSwgICAkd2luZG93LCAgICRxKSB7CiAgICAgICAgdmFyIGludGVydmFscyA9IHt9OwoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAgICAgKiBAbmFtZSAkaW50ZXJ2YWwKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEFuZ3VsYXIncyB3cmFwcGVyIGZvciBgd2luZG93LnNldEludGVydmFsYC4gVGhlIGBmbmAgZnVuY3Rpb24gaXMgZXhlY3V0ZWQgZXZlcnkgYGRlbGF5YAogICAgICAgICAqIG1pbGxpc2Vjb25kcy4KICAgICAgICAgKgogICAgICAgICAqIFRoZSByZXR1cm4gdmFsdWUgb2YgcmVnaXN0ZXJpbmcgYW4gaW50ZXJ2YWwgZnVuY3Rpb24gaXMgYSBwcm9taXNlLiBUaGlzIHByb21pc2Ugd2lsbCBiZQogICAgICAgICAqIG5vdGlmaWVkIHVwb24gZWFjaCB0aWNrIG9mIHRoZSBpbnRlcnZhbCwgYW5kIHdpbGwgYmUgcmVzb2x2ZWQgYWZ0ZXIgYGNvdW50YCBpdGVyYXRpb25zLCBvcgogICAgICAgICAqIHJ1biBpbmRlZmluaXRlbHkgaWYgYGNvdW50YCBpcyBub3QgZGVmaW5lZC4gVGhlIHZhbHVlIG9mIHRoZSBub3RpZmljYXRpb24gd2lsbCBiZSB0aGUKICAgICAgICAgKiBudW1iZXIgb2YgaXRlcmF0aW9ucyB0aGF0IGhhdmUgcnVuLgogICAgICAgICAqIFRvIGNhbmNlbCBhbiBpbnRlcnZhbCwgY2FsbCBgJGludGVydmFsLmNhbmNlbChwcm9taXNlKWAuCiAgICAgICAgICoKICAgICAgICAgKiBJbiB0ZXN0cyB5b3UgY2FuIHVzZSB7QGxpbmsgbmdNb2NrLiRpbnRlcnZhbCNmbHVzaCBgJGludGVydmFsLmZsdXNoKG1pbGxpcylgfSB0bwogICAgICAgICAqIG1vdmUgZm9yd2FyZCBieSBgbWlsbGlzYCBtaWxsaXNlY29uZHMgYW5kIHRyaWdnZXIgYW55IGZ1bmN0aW9ucyBzY2hlZHVsZWQgdG8gcnVuIGluIHRoYXQKICAgICAgICAgKiB0aW1lLgogICAgICAgICAqCiAgICAgICAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAgICAgICAgICogKipOb3RlKio6IEludGVydmFscyBjcmVhdGVkIGJ5IHRoaXMgc2VydmljZSBtdXN0IGJlIGV4cGxpY2l0bHkgZGVzdHJveWVkIHdoZW4geW91IGFyZSBmaW5pc2hlZAogICAgICAgICAqIHdpdGggdGhlbS4gIEluIHBhcnRpY3VsYXIgdGhleSBhcmUgbm90IGF1dG9tYXRpY2FsbHkgZGVzdHJveWVkIHdoZW4gYSBjb250cm9sbGVyJ3Mgc2NvcGUgb3IgYQogICAgICAgICAqIGRpcmVjdGl2ZSdzIGVsZW1lbnQgYXJlIGRlc3Ryb3llZC4KICAgICAgICAgKiBZb3Ugc2hvdWxkIHRha2UgdGhpcyBpbnRvIGNvbnNpZGVyYXRpb24gYW5kIG1ha2Ugc3VyZSB0byBhbHdheXMgY2FuY2VsIHRoZSBpbnRlcnZhbCBhdCB0aGUKICAgICAgICAgKiBhcHByb3ByaWF0ZSBtb21lbnQuICBTZWUgdGhlIGV4YW1wbGUgYmVsb3cgZm9yIG1vcmUgZGV0YWlscyBvbiBob3cgYW5kIHdoZW4gdG8gZG8gdGhpcy4KICAgICAgICAgKiA8L2Rpdj4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4gQSBmdW5jdGlvbiB0aGF0IHNob3VsZCBiZSBjYWxsZWQgcmVwZWF0ZWRseS4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgTnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBiZXR3ZWVuIGVhY2ggZnVuY3Rpb24gY2FsbC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IFtjb3VudD0wXSBOdW1iZXIgb2YgdGltZXMgdG8gcmVwZWF0LiBJZiBub3Qgc2V0LCBvciAwLCB3aWxsIHJlcGVhdAogICAgICAgICAqICAgaW5kZWZpbml0ZWx5LgogICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtpbnZva2VBcHBseT10cnVlXSBJZiBzZXQgdG8gYGZhbHNlYCBza2lwcyBtb2RlbCBkaXJ0eSBjaGVja2luZywgb3RoZXJ3aXNlCiAgICAgICAgICogICB3aWxsIGludm9rZSBgZm5gIHdpdGhpbiB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGFwcGx5ICRhcHBseX0gYmxvY2suCiAgICAgICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB3aGljaCB3aWxsIGJlIG5vdGlmaWVkIG9uIGVhY2ggaXRlcmF0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgKiA8ZXhhbXBsZSBtb2R1bGU9InRpbWUiPgogICAgICAgICAqICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgICAgICogICAgIDxzY3JpcHQ+CiAgICAgICAgICogICAgICAgZnVuY3Rpb24gQ3RybDIoJHNjb3BlLCRpbnRlcnZhbCkgewogICAgICAqICAgICAgICAgJHNjb3BlLmZvcm1hdCA9ICdNL2QveXkgaDptbTpzcyBhJzsKICAgICAgKiAgICAgICAgICRzY29wZS5ibG9vZF8xID0gMTAwOwogICAgICAqICAgICAgICAgJHNjb3BlLmJsb29kXzIgPSAxMjA7CiAgICAgICoKICAgICAgKiAgICAgICAgIHZhciBzdG9wOwogICAgICAqICAgICAgICAgJHNjb3BlLmZpZ2h0ID0gZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgIC8vIERvbid0IHN0YXJ0IGEgbmV3IGZpZ2h0IGlmIHdlIGFyZSBhbHJlYWR5IGZpZ2h0aW5nCiAgICAgICogICAgICAgICAgIGlmICggYW5ndWxhci5pc0RlZmluZWQoc3RvcCkgKSByZXR1cm47CiAgICAgICoKICAgICAgKiAgICAgICAgICAgc3RvcCA9ICRpbnRlcnZhbChmdW5jdGlvbigpIHsKICAgICAgKiAgICAgICAgICAgICBpZiAoJHNjb3BlLmJsb29kXzEgPiAwICYmICRzY29wZS5ibG9vZF8yID4gMCkgewogICAgICAqICAgICAgICAgICAgICAgICAkc2NvcGUuYmxvb2RfMSA9ICRzY29wZS5ibG9vZF8xIC0gMzsKICAgICAgKiAgICAgICAgICAgICAgICAgJHNjb3BlLmJsb29kXzIgPSAkc2NvcGUuYmxvb2RfMiAtIDQ7CiAgICAgICogICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgKiAgICAgICAgICAgICAgICAgJHNjb3BlLnN0b3BGaWdodCgpOwogICAgICAqICAgICAgICAgICAgIH0KICAgICAgKiAgICAgICAgICAgfSwgMTAwKTsKICAgICAgKiAgICAgICAgIH07CiAgICAgICoKICAgICAgKiAgICAgICAgICRzY29wZS5zdG9wRmlnaHQgPSBmdW5jdGlvbigpIHsKICAgICAgKiAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKHN0b3ApKSB7CiAgICAgICogICAgICAgICAgICAgJGludGVydmFsLmNhbmNlbChzdG9wKTsKICAgICAgKiAgICAgICAgICAgICBzdG9wID0gdW5kZWZpbmVkOwogICAgICAqICAgICAgICAgICB9CiAgICAgICogICAgICAgICB9OwogICAgICAqCiAgICAgICogICAgICAgICAkc2NvcGUucmVzZXRGaWdodCA9IGZ1bmN0aW9uKCkgewogICAgICAqICAgICAgICAgICAkc2NvcGUuYmxvb2RfMSA9IDEwMDsKICAgICAgKiAgICAgICAgICAgJHNjb3BlLmJsb29kXzIgPSAxMjA7CiAgICAgICogICAgICAgICB9CiAgICAgICoKICAgICAgKiAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBpbnRlcnZhbCBpcyBkZXN0cm95ZWQgdG9vCiAgICAgICogICAgICAgICAgICRzY29wZS5zdG9wRmlnaHQoKTsKICAgICAgKiAgICAgICAgIH0pOwogICAgICAqICAgICAgIH0KICAgICAgICAgKgogICAgICAgICAqICAgICAgIGFuZ3VsYXIubW9kdWxlKCd0aW1lJywgW10pCiAgICAgICAgICogICAgICAgICAvLyBSZWdpc3RlciB0aGUgJ215Q3VycmVudFRpbWUnIGRpcmVjdGl2ZSBmYWN0b3J5IG1ldGhvZC4KICAgICAgICAgKiAgICAgICAgIC8vIFdlIGluamVjdCAkaW50ZXJ2YWwgYW5kIGRhdGVGaWx0ZXIgc2VydmljZSBzaW5jZSB0aGUgZmFjdG9yeSBtZXRob2QgaXMgREkuCiAgICAgICAgICogICAgICAgICAuZGlyZWN0aXZlKCdteUN1cnJlbnRUaW1lJywgZnVuY3Rpb24oJGludGVydmFsLCBkYXRlRmlsdGVyKSB7CiAgICAgICogICAgICAgICAgIC8vIHJldHVybiB0aGUgZGlyZWN0aXZlIGxpbmsgZnVuY3Rpb24uIChjb21waWxlIGZ1bmN0aW9uIG5vdCBuZWVkZWQpCiAgICAgICogICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgKiAgICAgICAgICAgICB2YXIgZm9ybWF0LCAgLy8gZGF0ZSBmb3JtYXQKICAgICAgKiAgICAgICAgICAgICBzdG9wVGltZTsgLy8gc28gdGhhdCB3ZSBjYW4gY2FuY2VsIHRoZSB0aW1lIHVwZGF0ZXMKICAgICAgKgogICAgICAqICAgICAgICAgICAgIC8vIHVzZWQgdG8gdXBkYXRlIHRoZSBVSQogICAgICAqICAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRpbWUoKSB7CiAgICAgICogICAgICAgICAgICAgICBlbGVtZW50LnRleHQoZGF0ZUZpbHRlcihuZXcgRGF0ZSgpLCBmb3JtYXQpKTsKICAgICAgKiAgICAgICAgICAgICB9CiAgICAgICoKICAgICAgKiAgICAgICAgICAgICAvLyB3YXRjaCB0aGUgZXhwcmVzc2lvbiwgYW5kIHVwZGF0ZSB0aGUgVUkgb24gY2hhbmdlLgogICAgICAqICAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRycy5teUN1cnJlbnRUaW1lLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAqICAgICAgICAgICAgICAgZm9ybWF0ID0gdmFsdWU7CiAgICAgICogICAgICAgICAgICAgICB1cGRhdGVUaW1lKCk7CiAgICAgICogICAgICAgICAgICAgfSk7CiAgICAgICoKICAgICAgKiAgICAgICAgICAgICBzdG9wVGltZSA9ICRpbnRlcnZhbCh1cGRhdGVUaW1lLCAxMDAwKTsKICAgICAgKgogICAgICAqICAgICAgICAgICAgIC8vIGxpc3RlbiBvbiBET00gZGVzdHJveSAocmVtb3ZhbCkgZXZlbnQsIGFuZCBjYW5jZWwgdGhlIG5leHQgVUkgdXBkYXRlCiAgICAgICogICAgICAgICAgICAgLy8gdG8gcHJldmVudCB1cGRhdGluZyB0aW1lIG9mdGVyIHRoZSBET00gZWxlbWVudCB3YXMgcmVtb3ZlZC4KICAgICAgKiAgICAgICAgICAgICBlbGVtZW50LmJpbmQoJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICogICAgICAgICAgICAgICAkaW50ZXJ2YWwuY2FuY2VsKHN0b3BUaW1lKTsKICAgICAgKiAgICAgICAgICAgICB9KTsKICAgICAgKiAgICAgICAgICAgfQogICAgICAqICAgICAgICAgfSk7CiAgICAgICAgICogICAgIDwvc2NyaXB0PgogICAgICAgICAqCiAgICAgICAgICogICAgIDxkaXY+CiAgICAgICAgICogICAgICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsMiI+CiAgICAgICAgICogICAgICAgICBEYXRlIGZvcm1hdDogPGlucHV0IG5nLW1vZGVsPSJmb3JtYXQiPiA8aHIvPgogICAgICAgICAqICAgICAgICAgQ3VycmVudCB0aW1lIGlzOiA8c3BhbiBteS1jdXJyZW50LXRpbWU9ImZvcm1hdCI+PC9zcGFuPgogICAgICAgICAqICAgICAgICAgPGhyLz4KICAgICAgICAgKiAgICAgICAgIEJsb29kIDEgOiA8Zm9udCBjb2xvcj0ncmVkJz57e2Jsb29kXzF9fTwvZm9udD4KICAgICAgICAgKiAgICAgICAgIEJsb29kIDIgOiA8Zm9udCBjb2xvcj0ncmVkJz57e2Jsb29kXzJ9fTwvZm9udD4KICAgICAgICAgKiAgICAgICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBkYXRhLW5nLWNsaWNrPSJmaWdodCgpIj5GaWdodDwvYnV0dG9uPgogICAgICAgICAqICAgICAgICAgPGJ1dHRvbiB0eXBlPSJidXR0b24iIGRhdGEtbmctY2xpY2s9InN0b3BGaWdodCgpIj5TdG9wRmlnaHQ8L2J1dHRvbj4KICAgICAgICAgKiAgICAgICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBkYXRhLW5nLWNsaWNrPSJyZXNldEZpZ2h0KCkiPnJlc2V0RmlnaHQ8L2J1dHRvbj4KICAgICAgICAgKiAgICAgICA8L2Rpdj4KICAgICAgICAgKiAgICAgPC9kaXY+CiAgICAgICAgICoKICAgICAgICAgKiAgIDwvZmlsZT4KICAgICAgICAgKiA8L2V4YW1wbGU+CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gaW50ZXJ2YWwoZm4sIGRlbGF5LCBjb3VudCwgaW52b2tlQXBwbHkpIHsKICAgICAgICAgIHZhciBzZXRJbnRlcnZhbCA9ICR3aW5kb3cuc2V0SW50ZXJ2YWwsCiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwgPSAkd2luZG93LmNsZWFySW50ZXJ2YWwsCiAgICAgICAgICAgIGRlZmVycmVkID0gJHEuZGVmZXIoKSwKICAgICAgICAgICAgcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2UsCiAgICAgICAgICAgIGl0ZXJhdGlvbiA9IDAsCiAgICAgICAgICAgIHNraXBBcHBseSA9IChpc0RlZmluZWQoaW52b2tlQXBwbHkpICYmICFpbnZva2VBcHBseSk7CgogICAgICAgICAgY291bnQgPSBpc0RlZmluZWQoY291bnQpID8gY291bnQgOiAwOwoKICAgICAgICAgIHByb21pc2UudGhlbihudWxsLCBudWxsLCBmbik7CgogICAgICAgICAgcHJvbWlzZS4kJGludGVydmFsSWQgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiB0aWNrKCkgewogICAgICAgICAgICBkZWZlcnJlZC5ub3RpZnkoaXRlcmF0aW9uKyspOwoKICAgICAgICAgICAgaWYgKGNvdW50ID4gMCAmJiBpdGVyYXRpb24gPj0gY291bnQpIHsKICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGl0ZXJhdGlvbik7CiAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChwcm9taXNlLiQkaW50ZXJ2YWxJZCk7CiAgICAgICAgICAgICAgZGVsZXRlIGludGVydmFsc1twcm9taXNlLiQkaW50ZXJ2YWxJZF07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghc2tpcEFwcGx5KSAkcm9vdFNjb3BlLiRhcHBseSgpOwoKICAgICAgICAgIH0sIGRlbGF5KTsKCiAgICAgICAgICBpbnRlcnZhbHNbcHJvbWlzZS4kJGludGVydmFsSWRdID0gZGVmZXJyZWQ7CgogICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfQoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRpbnRlcnZhbCNjYW5jZWwKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIENhbmNlbHMgYSB0YXNrIGFzc29jaWF0ZWQgd2l0aCB0aGUgYHByb21pc2VgLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtwcm9taXNlfSBwcm9taXNlIHJldHVybmVkIGJ5IHRoZSBgJGludGVydmFsYCBmdW5jdGlvbi4KICAgICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHRhc2sgd2FzIHN1Y2Nlc3NmdWxseSBjYW5jZWxlZC4KICAgICAgICAgKi8KICAgICAgICBpbnRlcnZhbC5jYW5jZWwgPSBmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgICAgICBpZiAocHJvbWlzZSAmJiBwcm9taXNlLiQkaW50ZXJ2YWxJZCBpbiBpbnRlcnZhbHMpIHsKICAgICAgICAgICAgaW50ZXJ2YWxzW3Byb21pc2UuJCRpbnRlcnZhbElkXS5yZWplY3QoJ2NhbmNlbGVkJyk7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwocHJvbWlzZS4kJGludGVydmFsSWQpOwogICAgICAgICAgICBkZWxldGUgaW50ZXJ2YWxzW3Byb21pc2UuJCRpbnRlcnZhbElkXTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGludGVydmFsOwogICAgICB9XTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGxvY2FsZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogJGxvY2FsZSBzZXJ2aWNlIHByb3ZpZGVzIGxvY2FsaXphdGlvbiBydWxlcyBmb3IgdmFyaW91cyBBbmd1bGFyIGNvbXBvbmVudHMuIEFzIG9mIHJpZ2h0IG5vdyB0aGUKICAgKiBvbmx5IHB1YmxpYyBhcGkgaXM6CiAgICoKICAgKiAqIGBpZGAg4oCTIGB7c3RyaW5nfWAg4oCTIGxvY2FsZSBpZCBmb3JtYXR0ZWQgYXMgYGxhbmd1YWdlSWQtY291bnRyeUlkYCAoZS5nLiBgZW4tdXNgKQogICAqLwogIGZ1bmN0aW9uICRMb2NhbGVQcm92aWRlcigpewogICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgaWQ6ICdlbi11cycsCgogICAgICAgIE5VTUJFUl9GT1JNQVRTOiB7CiAgICAgICAgICBERUNJTUFMX1NFUDogJy4nLAogICAgICAgICAgR1JPVVBfU0VQOiAnLCcsCiAgICAgICAgICBQQVRURVJOUzogWwogICAgICAgICAgICB7IC8vIERlY2ltYWwgUGF0dGVybgogICAgICAgICAgICAgIG1pbkludDogMSwKICAgICAgICAgICAgICBtaW5GcmFjOiAwLAogICAgICAgICAgICAgIG1heEZyYWM6IDMsCiAgICAgICAgICAgICAgcG9zUHJlOiAnJywKICAgICAgICAgICAgICBwb3NTdWY6ICcnLAogICAgICAgICAgICAgIG5lZ1ByZTogJy0nLAogICAgICAgICAgICAgIG5lZ1N1ZjogJycsCiAgICAgICAgICAgICAgZ1NpemU6IDMsCiAgICAgICAgICAgICAgbGdTaXplOiAzCiAgICAgICAgICAgIH0seyAvL0N1cnJlbmN5IFBhdHRlcm4KICAgICAgICAgICAgICBtaW5JbnQ6IDEsCiAgICAgICAgICAgICAgbWluRnJhYzogMiwKICAgICAgICAgICAgICBtYXhGcmFjOiAyLAogICAgICAgICAgICAgIHBvc1ByZTogJ1x1MDBBNCcsCiAgICAgICAgICAgICAgcG9zU3VmOiAnJywKICAgICAgICAgICAgICBuZWdQcmU6ICcoXHUwMEE0JywKICAgICAgICAgICAgICBuZWdTdWY6ICcpJywKICAgICAgICAgICAgICBnU2l6ZTogMywKICAgICAgICAgICAgICBsZ1NpemU6IDMKICAgICAgICAgICAgfQogICAgICAgICAgXSwKICAgICAgICAgIENVUlJFTkNZX1NZTTogJyQnCiAgICAgICAgfSwKCiAgICAgICAgREFURVRJTUVfRk9STUFUUzogewogICAgICAgICAgTU9OVEg6CiAgICAgICAgICAgICdKYW51YXJ5LEZlYnJ1YXJ5LE1hcmNoLEFwcmlsLE1heSxKdW5lLEp1bHksQXVndXN0LFNlcHRlbWJlcixPY3RvYmVyLE5vdmVtYmVyLERlY2VtYmVyJwogICAgICAgICAgICAgIC5zcGxpdCgnLCcpLAogICAgICAgICAgU0hPUlRNT05USDogICdKYW4sRmViLE1hcixBcHIsTWF5LEp1bixKdWwsQXVnLFNlcCxPY3QsTm92LERlYycuc3BsaXQoJywnKSwKICAgICAgICAgIERBWTogJ1N1bmRheSxNb25kYXksVHVlc2RheSxXZWRuZXNkYXksVGh1cnNkYXksRnJpZGF5LFNhdHVyZGF5Jy5zcGxpdCgnLCcpLAogICAgICAgICAgU0hPUlREQVk6ICdTdW4sTW9uLFR1ZSxXZWQsVGh1LEZyaSxTYXQnLnNwbGl0KCcsJyksCiAgICAgICAgICBBTVBNUzogWydBTScsJ1BNJ10sCiAgICAgICAgICBtZWRpdW06ICdNTU0gZCwgeSBoOm1tOnNzIGEnLAogICAgICAgICAgc2hvcnQ6ICdNL2QveXkgaDptbSBhJywKICAgICAgICAgIGZ1bGxEYXRlOiAnRUVFRSwgTU1NTSBkLCB5JywKICAgICAgICAgIGxvbmdEYXRlOiAnTU1NTSBkLCB5JywKICAgICAgICAgIG1lZGl1bURhdGU6ICdNTU0gZCwgeScsCiAgICAgICAgICBzaG9ydERhdGU6ICdNL2QveXknLAogICAgICAgICAgbWVkaXVtVGltZTogJ2g6bW06c3MgYScsCiAgICAgICAgICBzaG9ydFRpbWU6ICdoOm1tIGEnCiAgICAgICAgfSwKCiAgICAgICAgcGx1cmFsQ2F0OiBmdW5jdGlvbihudW0pIHsKICAgICAgICAgIGlmIChudW0gPT09IDEpIHsKICAgICAgICAgICAgcmV0dXJuICdvbmUnOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICdvdGhlcic7CiAgICAgICAgfQogICAgICB9OwogICAgfTsKICB9CgogIHZhciBQQVRIX01BVENIID0gL14oW15cPyNdKikoXD8oW14jXSopKT8oIyguKikpPyQvLAogICAgREVGQVVMVF9QT1JUUyA9IHsnaHR0cCc6IDgwLCAnaHR0cHMnOiA0NDMsICdmdHAnOiAyMX07CiAgdmFyICRsb2NhdGlvbk1pbkVyciA9IG1pbkVycignJGxvY2F0aW9uJyk7CgoKICAvKioKICAgKiBFbmNvZGUgcGF0aCB1c2luZyBlbmNvZGVVcmlTZWdtZW50LCBpZ25vcmluZyBmb3J3YXJkIHNsYXNoZXMKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIFBhdGggdG8gZW5jb2RlCiAgICogQHJldHVybnMge3N0cmluZ30KICAgKi8KICBmdW5jdGlvbiBlbmNvZGVQYXRoKHBhdGgpIHsKICAgIHZhciBzZWdtZW50cyA9IHBhdGguc3BsaXQoJy8nKSwKICAgICAgaSA9IHNlZ21lbnRzLmxlbmd0aDsKCiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIHNlZ21lbnRzW2ldID0gZW5jb2RlVXJpU2VnbWVudChzZWdtZW50c1tpXSk7CiAgICB9CgogICAgcmV0dXJuIHNlZ21lbnRzLmpvaW4oJy8nKTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQWJzb2x1dGVVcmwoYWJzb2x1dGVVcmwsIGxvY2F0aW9uT2JqLCBhcHBCYXNlKSB7CiAgICB2YXIgcGFyc2VkVXJsID0gdXJsUmVzb2x2ZShhYnNvbHV0ZVVybCwgYXBwQmFzZSk7CgogICAgbG9jYXRpb25PYmouJCRwcm90b2NvbCA9IHBhcnNlZFVybC5wcm90b2NvbDsKICAgIGxvY2F0aW9uT2JqLiQkaG9zdCA9IHBhcnNlZFVybC5ob3N0bmFtZTsKICAgIGxvY2F0aW9uT2JqLiQkcG9ydCA9IGludChwYXJzZWRVcmwucG9ydCkgfHwgREVGQVVMVF9QT1JUU1twYXJzZWRVcmwucHJvdG9jb2xdIHx8IG51bGw7CiAgfQoKCiAgZnVuY3Rpb24gcGFyc2VBcHBVcmwocmVsYXRpdmVVcmwsIGxvY2F0aW9uT2JqLCBhcHBCYXNlKSB7CiAgICB2YXIgcHJlZml4ZWQgPSAocmVsYXRpdmVVcmwuY2hhckF0KDApICE9PSAnLycpOwogICAgaWYgKHByZWZpeGVkKSB7CiAgICAgIHJlbGF0aXZlVXJsID0gJy8nICsgcmVsYXRpdmVVcmw7CiAgICB9CiAgICB2YXIgbWF0Y2ggPSB1cmxSZXNvbHZlKHJlbGF0aXZlVXJsLCBhcHBCYXNlKTsKICAgIGxvY2F0aW9uT2JqLiQkcGF0aCA9IGRlY29kZVVSSUNvbXBvbmVudChwcmVmaXhlZCAmJiBtYXRjaC5wYXRobmFtZS5jaGFyQXQoMCkgPT09ICcvJyA/CiAgICAgIG1hdGNoLnBhdGhuYW1lLnN1YnN0cmluZygxKSA6IG1hdGNoLnBhdGhuYW1lKTsKICAgIGxvY2F0aW9uT2JqLiQkc2VhcmNoID0gcGFyc2VLZXlWYWx1ZShtYXRjaC5zZWFyY2gpOwogICAgbG9jYXRpb25PYmouJCRoYXNoID0gZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoLmhhc2gpOwoKICAgIC8vIG1ha2Ugc3VyZSBwYXRoIHN0YXJ0cyB3aXRoICcvJzsKICAgIGlmIChsb2NhdGlvbk9iai4kJHBhdGggJiYgbG9jYXRpb25PYmouJCRwYXRoLmNoYXJBdCgwKSAhPSAnLycpIHsKICAgICAgbG9jYXRpb25PYmouJCRwYXRoID0gJy8nICsgbG9jYXRpb25PYmouJCRwYXRoOwogICAgfQogIH0KCgogIC8qKgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGJlZ2luCiAgICogQHBhcmFtIHtzdHJpbmd9IHdob2xlCiAgICogQHJldHVybnMge3N0cmluZ30gcmV0dXJucyB0ZXh0IGZyb20gd2hvbGUgYWZ0ZXIgYmVnaW4gb3IgdW5kZWZpbmVkIGlmIGl0IGRvZXMgbm90IGJlZ2luIHdpdGgKICAgKiAgICAgICAgICAgICAgICAgICBleHBlY3RlZCBzdHJpbmcuCiAgICovCiAgZnVuY3Rpb24gYmVnaW5zV2l0aChiZWdpbiwgd2hvbGUpIHsKICAgIGlmICh3aG9sZS5pbmRleE9mKGJlZ2luKSA9PT0gMCkgewogICAgICByZXR1cm4gd2hvbGUuc3Vic3RyKGJlZ2luLmxlbmd0aCk7CiAgICB9CiAgfQoKCiAgZnVuY3Rpb24gc3RyaXBIYXNoKHVybCkgewogICAgdmFyIGluZGV4ID0gdXJsLmluZGV4T2YoJyMnKTsKICAgIHJldHVybiBpbmRleCA9PSAtMSA/IHVybCA6IHVybC5zdWJzdHIoMCwgaW5kZXgpOwogIH0KCgogIGZ1bmN0aW9uIHN0cmlwRmlsZSh1cmwpIHsKICAgIHJldHVybiB1cmwuc3Vic3RyKDAsIHN0cmlwSGFzaCh1cmwpLmxhc3RJbmRleE9mKCcvJykgKyAxKTsKICB9CgogIC8qIHJldHVybiB0aGUgc2VydmVyIG9ubHkgKHNjaGVtZTovL2hvc3Q6cG9ydCkgKi8KICBmdW5jdGlvbiBzZXJ2ZXJCYXNlKHVybCkgewogICAgcmV0dXJuIHVybC5zdWJzdHJpbmcoMCwgdXJsLmluZGV4T2YoJy8nLCB1cmwuaW5kZXhPZignLy8nKSArIDIpKTsKICB9CgoKICAvKioKICAgKiBMb2NhdGlvbkh0bWw1VXJsIHJlcHJlc2VudHMgYW4gdXJsCiAgICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIEhUTUw1IG1vZGUgaXMgZW5hYmxlZCBhbmQgc3VwcG9ydGVkCiAgICoKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3N0cmluZ30gYXBwQmFzZSBhcHBsaWNhdGlvbiBiYXNlIFVSTAogICAqIEBwYXJhbSB7c3RyaW5nfSBiYXNlUHJlZml4IHVybCBwYXRoIHByZWZpeAogICAqLwogIGZ1bmN0aW9uIExvY2F0aW9uSHRtbDVVcmwoYXBwQmFzZSwgYmFzZVByZWZpeCkgewogICAgdGhpcy4kJGh0bWw1ID0gdHJ1ZTsKICAgIGJhc2VQcmVmaXggPSBiYXNlUHJlZml4IHx8ICcnOwogICAgdmFyIGFwcEJhc2VOb0ZpbGUgPSBzdHJpcEZpbGUoYXBwQmFzZSk7CiAgICBwYXJzZUFic29sdXRlVXJsKGFwcEJhc2UsIHRoaXMsIGFwcEJhc2UpOwoKCiAgICAvKioKICAgICAqIFBhcnNlIGdpdmVuIGh0bWw1IChyZWd1bGFyKSB1cmwgc3RyaW5nIGludG8gcHJvcGVydGllcwogICAgICogQHBhcmFtIHtzdHJpbmd9IG5ld0Fic29sdXRlVXJsIEhUTUw1IHVybAogICAgICogQHByaXZhdGUKICAgICAqLwogICAgdGhpcy4kJHBhcnNlID0gZnVuY3Rpb24odXJsKSB7CiAgICAgIHZhciBwYXRoVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlTm9GaWxlLCB1cmwpOwogICAgICBpZiAoIWlzU3RyaW5nKHBhdGhVcmwpKSB7CiAgICAgICAgdGhyb3cgJGxvY2F0aW9uTWluRXJyKCdpcHRocHJmeCcsICdJbnZhbGlkIHVybCAiezB9IiwgbWlzc2luZyBwYXRoIHByZWZpeCAiezF9Ii4nLCB1cmwsCiAgICAgICAgICBhcHBCYXNlTm9GaWxlKTsKICAgICAgfQoKICAgICAgcGFyc2VBcHBVcmwocGF0aFVybCwgdGhpcywgYXBwQmFzZSk7CgogICAgICBpZiAoIXRoaXMuJCRwYXRoKSB7CiAgICAgICAgdGhpcy4kJHBhdGggPSAnLyc7CiAgICAgIH0KCiAgICAgIHRoaXMuJCRjb21wb3NlKCk7CiAgICB9OwoKICAgIC8qKgogICAgICogQ29tcG9zZSB1cmwgYW5kIHVwZGF0ZSBgYWJzVXJsYCBwcm9wZXJ0eQogICAgICogQHByaXZhdGUKICAgICAqLwogICAgdGhpcy4kJGNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlYXJjaCA9IHRvS2V5VmFsdWUodGhpcy4kJHNlYXJjaCksCiAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgICB0aGlzLiQkYWJzVXJsID0gYXBwQmFzZU5vRmlsZSArIHRoaXMuJCR1cmwuc3Vic3RyKDEpOyAvLyBmaXJzdCBjaGFyIGlzIGFsd2F5cyAnLycKICAgIH07CgogICAgdGhpcy4kJHJld3JpdGUgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgdmFyIGFwcFVybCwgcHJldkFwcFVybDsKCiAgICAgIGlmICggKGFwcFVybCA9IGJlZ2luc1dpdGgoYXBwQmFzZSwgdXJsKSkgIT09IHVuZGVmaW5lZCApIHsKICAgICAgICBwcmV2QXBwVXJsID0gYXBwVXJsOwogICAgICAgIGlmICggKGFwcFVybCA9IGJlZ2luc1dpdGgoYmFzZVByZWZpeCwgYXBwVXJsKSkgIT09IHVuZGVmaW5lZCApIHsKICAgICAgICAgIHJldHVybiBhcHBCYXNlTm9GaWxlICsgKGJlZ2luc1dpdGgoJy8nLCBhcHBVcmwpIHx8IGFwcFVybCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBhcHBCYXNlICsgcHJldkFwcFVybDsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoIChhcHBVcmwgPSBiZWdpbnNXaXRoKGFwcEJhc2VOb0ZpbGUsIHVybCkpICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgcmV0dXJuIGFwcEJhc2VOb0ZpbGUgKyBhcHBVcmw7CiAgICAgIH0gZWxzZSBpZiAoYXBwQmFzZU5vRmlsZSA9PSB1cmwgKyAnLycpIHsKICAgICAgICByZXR1cm4gYXBwQmFzZU5vRmlsZTsKICAgICAgfQogICAgfTsKICB9CgoKICAvKioKICAgKiBMb2NhdGlvbkhhc2hiYW5nVXJsIHJlcHJlc2VudHMgdXJsCiAgICogVGhpcyBvYmplY3QgaXMgZXhwb3NlZCBhcyAkbG9jYXRpb24gc2VydmljZSB3aGVuIGRldmVsb3BlciBkb2Vzbid0IG9wdCBpbnRvIGh0bWw1IG1vZGUuCiAgICogSXQgYWxzbyBzZXJ2ZXMgYXMgdGhlIGJhc2UgY2xhc3MgZm9yIGh0bWw1IG1vZGUgZmFsbGJhY2sgb24gbGVnYWN5IGJyb3dzZXJzLgogICAqCiAgICogQGNvbnN0cnVjdG9yCiAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEJhc2UgYXBwbGljYXRpb24gYmFzZSBVUkwKICAgKiBAcGFyYW0ge3N0cmluZ30gaGFzaFByZWZpeCBoYXNoYmFuZyBwcmVmaXgKICAgKi8KICBmdW5jdGlvbiBMb2NhdGlvbkhhc2hiYW5nVXJsKGFwcEJhc2UsIGhhc2hQcmVmaXgpIHsKICAgIHZhciBhcHBCYXNlTm9GaWxlID0gc3RyaXBGaWxlKGFwcEJhc2UpOwoKICAgIHBhcnNlQWJzb2x1dGVVcmwoYXBwQmFzZSwgdGhpcywgYXBwQmFzZSk7CgoKICAgIC8qKgogICAgICogUGFyc2UgZ2l2ZW4gaGFzaGJhbmcgdXJsIGludG8gcHJvcGVydGllcwogICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCBIYXNoYmFuZyB1cmwKICAgICAqIEBwcml2YXRlCiAgICAgKi8KICAgIHRoaXMuJCRwYXJzZSA9IGZ1bmN0aW9uKHVybCkgewogICAgICB2YXIgd2l0aG91dEJhc2VVcmwgPSBiZWdpbnNXaXRoKGFwcEJhc2UsIHVybCkgfHwgYmVnaW5zV2l0aChhcHBCYXNlTm9GaWxlLCB1cmwpOwogICAgICB2YXIgd2l0aG91dEhhc2hVcmwgPSB3aXRob3V0QmFzZVVybC5jaGFyQXQoMCkgPT0gJyMnCiAgICAgICAgPyBiZWdpbnNXaXRoKGhhc2hQcmVmaXgsIHdpdGhvdXRCYXNlVXJsKQogICAgICAgIDogKHRoaXMuJCRodG1sNSkKICAgICAgICA/IHdpdGhvdXRCYXNlVXJsCiAgICAgICAgOiAnJzsKCiAgICAgIGlmICghaXNTdHJpbmcod2l0aG91dEhhc2hVcmwpKSB7CiAgICAgICAgdGhyb3cgJGxvY2F0aW9uTWluRXJyKCdpaHNocHJmeCcsICdJbnZhbGlkIHVybCAiezB9IiwgbWlzc2luZyBoYXNoIHByZWZpeCAiezF9Ii4nLCB1cmwsCiAgICAgICAgICBoYXNoUHJlZml4KTsKICAgICAgfQogICAgICBwYXJzZUFwcFVybCh3aXRob3V0SGFzaFVybCwgdGhpcywgYXBwQmFzZSk7CgogICAgICB0aGlzLiQkcGF0aCA9IHJlbW92ZVdpbmRvd3NEcml2ZU5hbWUodGhpcy4kJHBhdGgsIHdpdGhvdXRIYXNoVXJsLCBhcHBCYXNlKTsKCiAgICAgIHRoaXMuJCRjb21wb3NlKCk7CgogICAgICAvKgogICAgICAgKiBJbiBXaW5kb3dzLCBvbiBhbiBhbmNob3Igbm9kZSBvbiBkb2N1bWVudHMgbG9hZGVkIGZyb20KICAgICAgICogdGhlIGZpbGVzeXN0ZW0sIHRoZSBicm93c2VyIHdpbGwgcmV0dXJuIGEgcGF0aG5hbWUKICAgICAgICogcHJlZml4ZWQgd2l0aCB0aGUgZHJpdmUgbmFtZSAoJy9DOi9wYXRoJykgd2hlbiBhCiAgICAgICAqIHBhdGhuYW1lIHdpdGhvdXQgYSBkcml2ZSBpcyBzZXQ6CiAgICAgICAqICAqIGEuc2V0QXR0cmlidXRlKCdocmVmJywgJy9mb28nKQogICAgICAgKiAgICogYS5wYXRobmFtZSA9PT0gJy9DOi9mb28nIC8vdHJ1ZQogICAgICAgKgogICAgICAgKiBJbnNpZGUgb2YgQW5ndWxhciwgd2UncmUgYWx3YXlzIHVzaW5nIHBhdGhuYW1lcyB0aGF0CiAgICAgICAqIGRvIG5vdCBpbmNsdWRlIGRyaXZlIG5hbWVzIGZvciByb3V0aW5nLgogICAgICAgKi8KICAgICAgZnVuY3Rpb24gcmVtb3ZlV2luZG93c0RyaXZlTmFtZSAocGF0aCwgdXJsLCBiYXNlKSB7CiAgICAgICAgLyoKICAgICAgICAgTWF0Y2hlcyBwYXRocyBmb3IgZmlsZSBwcm90b2NvbCBvbiB3aW5kb3dzLAogICAgICAgICBzdWNoIGFzIC9DOi9mb28vYmFyLCBhbmQgY2FwdHVyZXMgb25seSAvZm9vL2Jhci4KICAgICAgICAgKi8KICAgICAgICB2YXIgd2luZG93c0ZpbGVQYXRoRXhwID0gL15cL1tBLVpdOihcLy4qKS87CgogICAgICAgIHZhciBmaXJzdFBhdGhTZWdtZW50TWF0Y2g7CgogICAgICAgIC8vR2V0IHRoZSByZWxhdGl2ZSBwYXRoIGZyb20gdGhlIGlucHV0IFVSTC4KICAgICAgICBpZiAodXJsLmluZGV4T2YoYmFzZSkgPT09IDApIHsKICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKGJhc2UsICcnKTsKICAgICAgICB9CgogICAgICAgIC8vIFRoZSBpbnB1dCBVUkwgaW50ZW50aW9uYWxseSBjb250YWlucyBhIGZpcnN0IHBhdGggc2VnbWVudCB0aGF0IGVuZHMgd2l0aCBhIGNvbG9uLgogICAgICAgIGlmICh3aW5kb3dzRmlsZVBhdGhFeHAuZXhlYyh1cmwpKSB7CiAgICAgICAgICByZXR1cm4gcGF0aDsKICAgICAgICB9CgogICAgICAgIGZpcnN0UGF0aFNlZ21lbnRNYXRjaCA9IHdpbmRvd3NGaWxlUGF0aEV4cC5leGVjKHBhdGgpOwogICAgICAgIHJldHVybiBmaXJzdFBhdGhTZWdtZW50TWF0Y2ggPyBmaXJzdFBhdGhTZWdtZW50TWF0Y2hbMV0gOiBwYXRoOwogICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQ29tcG9zZSBoYXNoYmFuZyB1cmwgYW5kIHVwZGF0ZSBgYWJzVXJsYCBwcm9wZXJ0eQogICAgICogQHByaXZhdGUKICAgICAqLwogICAgdGhpcy4kJGNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHNlYXJjaCA9IHRvS2V5VmFsdWUodGhpcy4kJHNlYXJjaCksCiAgICAgICAgaGFzaCA9IHRoaXMuJCRoYXNoID8gJyMnICsgZW5jb2RlVXJpU2VnbWVudCh0aGlzLiQkaGFzaCkgOiAnJzsKCiAgICAgIHRoaXMuJCR1cmwgPSBlbmNvZGVQYXRoKHRoaXMuJCRwYXRoKSArIChzZWFyY2ggPyAnPycgKyBzZWFyY2ggOiAnJykgKyBoYXNoOwogICAgICB0aGlzLiQkYWJzVXJsID0gYXBwQmFzZSArICh0aGlzLiQkdXJsID8gaGFzaFByZWZpeCArIHRoaXMuJCR1cmwgOiAnJyk7CiAgICB9OwoKICAgIHRoaXMuJCRyZXdyaXRlID0gZnVuY3Rpb24odXJsKSB7CiAgICAgIGlmKHN0cmlwSGFzaChhcHBCYXNlKSA9PSBzdHJpcEhhc2godXJsKSkgewogICAgICAgIHJldHVybiB1cmw7CiAgICAgIH0KICAgIH07CiAgfQoKCiAgLyoqCiAgICogTG9jYXRpb25IYXNoYmFuZ1VybCByZXByZXNlbnRzIHVybAogICAqIFRoaXMgb2JqZWN0IGlzIGV4cG9zZWQgYXMgJGxvY2F0aW9uIHNlcnZpY2Ugd2hlbiBodG1sNSBoaXN0b3J5IGFwaSBpcyBlbmFibGVkIGJ1dCB0aGUgYnJvd3NlcgogICAqIGRvZXMgbm90IHN1cHBvcnQgaXQuCiAgICoKICAgKiBAY29uc3RydWN0b3IKICAgKiBAcGFyYW0ge3N0cmluZ30gYXBwQmFzZSBhcHBsaWNhdGlvbiBiYXNlIFVSTAogICAqIEBwYXJhbSB7c3RyaW5nfSBoYXNoUHJlZml4IGhhc2hiYW5nIHByZWZpeAogICAqLwogIGZ1bmN0aW9uIExvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsKGFwcEJhc2UsIGhhc2hQcmVmaXgpIHsKICAgIHRoaXMuJCRodG1sNSA9IHRydWU7CiAgICBMb2NhdGlvbkhhc2hiYW5nVXJsLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgdmFyIGFwcEJhc2VOb0ZpbGUgPSBzdHJpcEZpbGUoYXBwQmFzZSk7CgogICAgdGhpcy4kJHJld3JpdGUgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgdmFyIGFwcFVybDsKCiAgICAgIGlmICggYXBwQmFzZSA9PSBzdHJpcEhhc2godXJsKSApIHsKICAgICAgICByZXR1cm4gdXJsOwogICAgICB9IGVsc2UgaWYgKCAoYXBwVXJsID0gYmVnaW5zV2l0aChhcHBCYXNlTm9GaWxlLCB1cmwpKSApIHsKICAgICAgICByZXR1cm4gYXBwQmFzZSArIGhhc2hQcmVmaXggKyBhcHBVcmw7CiAgICAgIH0gZWxzZSBpZiAoIGFwcEJhc2VOb0ZpbGUgPT09IHVybCArICcvJykgewogICAgICAgIHJldHVybiBhcHBCYXNlTm9GaWxlOwogICAgICB9CiAgICB9OwoKICAgIHRoaXMuJCRjb21wb3NlID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzZWFyY2ggPSB0b0tleVZhbHVlKHRoaXMuJCRzZWFyY2gpLAogICAgICAgIGhhc2ggPSB0aGlzLiQkaGFzaCA/ICcjJyArIGVuY29kZVVyaVNlZ21lbnQodGhpcy4kJGhhc2gpIDogJyc7CgogICAgICB0aGlzLiQkdXJsID0gZW5jb2RlUGF0aCh0aGlzLiQkcGF0aCkgKyAoc2VhcmNoID8gJz8nICsgc2VhcmNoIDogJycpICsgaGFzaDsKICAgICAgLy8gaW5jbHVkZSBoYXNoUHJlZml4IGluICQkYWJzVXJsIHdoZW4gJCR1cmwgaXMgZW1wdHkgc28gSUU4ICYgOSBkbyBub3QgcmVsb2FkIHBhZ2UgYmVjYXVzZSBvZiByZW1vdmFsIG9mICcjJwogICAgICB0aGlzLiQkYWJzVXJsID0gYXBwQmFzZSArIGhhc2hQcmVmaXggKyB0aGlzLiQkdXJsOwogICAgfTsKCiAgfQoKCiAgTG9jYXRpb25IYXNoYmFuZ0luSHRtbDVVcmwucHJvdG90eXBlID0KICAgIExvY2F0aW9uSGFzaGJhbmdVcmwucHJvdG90eXBlID0KICAgICAgTG9jYXRpb25IdG1sNVVybC5wcm90b3R5cGUgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIEFyZSB3ZSBpbiBodG1sNSBtb2RlPwogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgJCRodG1sNTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEhhcyBhbnkgY2hhbmdlIGJlZW4gcmVwbGFjaW5nID8KICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAqLwogICAgICAgICQkcmVwbGFjZTogZmFsc2UsCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkbG9jYXRpb24jYWJzVXJsCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgb25seS4KICAgICAgICAgKgogICAgICAgICAqIFJldHVybiBmdWxsIHVybCByZXByZXNlbnRhdGlvbiB3aXRoIGFsbCBzZWdtZW50cyBlbmNvZGVkIGFjY29yZGluZyB0byBydWxlcyBzcGVjaWZpZWQgaW4KICAgICAgICAgKiBbUkZDIDM5ODZdKGh0dHA6Ly93d3cuaWV0Zi5vcmcvcmZjL3JmYzM5ODYudHh0KS4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gZnVsbCB1cmwKICAgICAgICAgKi8KICAgICAgICBhYnNVcmw6IGxvY2F0aW9uR2V0dGVyKCckJGFic1VybCcpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGxvY2F0aW9uI3VybAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIC8gc2V0dGVyLgogICAgICAgICAqCiAgICAgICAgICogUmV0dXJuIHVybCAoZS5nLiBgL3BhdGg/YT1iI2hhc2hgKSB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBDaGFuZ2UgcGF0aCwgc2VhcmNoIGFuZCBoYXNoLCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSB1cmwgTmV3IHVybCB3aXRob3V0IGJhc2UgcHJlZml4IChlLmcuIGAvcGF0aD9hPWIjaGFzaGApCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXBsYWNlIFRoZSBwYXRoIHRoYXQgd2lsbCBiZSBjaGFuZ2VkCiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSB1cmwKICAgICAgICAgKi8KICAgICAgICB1cmw6IGZ1bmN0aW9uKHVybCwgcmVwbGFjZSkgewogICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHVybCkpCiAgICAgICAgICAgIHJldHVybiB0aGlzLiQkdXJsOwoKICAgICAgICAgIHZhciBtYXRjaCA9IFBBVEhfTUFUQ0guZXhlYyh1cmwpOwogICAgICAgICAgaWYgKG1hdGNoWzFdKSB0aGlzLnBhdGgoZGVjb2RlVVJJQ29tcG9uZW50KG1hdGNoWzFdKSk7CiAgICAgICAgICBpZiAobWF0Y2hbMl0gfHwgbWF0Y2hbMV0pIHRoaXMuc2VhcmNoKG1hdGNoWzNdIHx8ICcnKTsKICAgICAgICAgIHRoaXMuaGFzaChtYXRjaFs1XSB8fCAnJywgcmVwbGFjZSk7CgogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRsb2NhdGlvbiNwcm90b2NvbAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gcHJvdG9jb2wgb2YgY3VycmVudCB1cmwuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9IHByb3RvY29sIG9mIGN1cnJlbnQgdXJsCiAgICAgICAgICovCiAgICAgICAgcHJvdG9jb2w6IGxvY2F0aW9uR2V0dGVyKCckJHByb3RvY29sJyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkbG9jYXRpb24jaG9zdAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gaG9zdCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gaG9zdCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKi8KICAgICAgICBob3N0OiBsb2NhdGlvbkdldHRlcignJCRob3N0JyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkbG9jYXRpb24jcG9ydAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogVGhpcyBtZXRob2QgaXMgZ2V0dGVyIG9ubHkuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gcG9ydCBvZiBjdXJyZW50IHVybC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge051bWJlcn0gcG9ydAogICAgICAgICAqLwogICAgICAgIHBvcnQ6IGxvY2F0aW9uR2V0dGVyKCckJHBvcnQnKSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRsb2NhdGlvbiNwYXRoCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gcGF0aCBvZiBjdXJyZW50IHVybCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBDaGFuZ2UgcGF0aCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAgICAgICAqCiAgICAgICAgICogTm90ZTogUGF0aCBzaG91bGQgYWx3YXlzIGJlZ2luIHdpdGggZm9yd2FyZCBzbGFzaCAoLyksIHRoaXMgbWV0aG9kIHdpbGwgYWRkIHRoZSBmb3J3YXJkIHNsYXNoCiAgICAgICAgICogaWYgaXQgaXMgbWlzc2luZy4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcGF0aCBOZXcgcGF0aAogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30gcGF0aAogICAgICAgICAqLwogICAgICAgIHBhdGg6IGxvY2F0aW9uR2V0dGVyU2V0dGVyKCckJHBhdGgnLCBmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgICByZXR1cm4gcGF0aC5jaGFyQXQoMCkgPT0gJy8nID8gcGF0aCA6ICcvJyArIHBhdGg7CiAgICAgICAgfSksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkbG9jYXRpb24jc2VhcmNoCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gc2VhcmNoIHBhcnQgKGFzIG9iamVjdCkgb2YgY3VycmVudCB1cmwgd2hlbiBjYWxsZWQgd2l0aG91dCBhbnkgcGFyYW1ldGVyLgogICAgICAgICAqCiAgICAgICAgICogQ2hhbmdlIHNlYXJjaCBwYXJ0IHdoZW4gY2FsbGVkIHdpdGggcGFyYW1ldGVyIGFuZCByZXR1cm4gYCRsb2NhdGlvbmAuCiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqIGBgYGpzCiAgICAgICAgICogLy8gZ2l2ZW4gdXJsIGh0dHA6Ly9leGFtcGxlLmNvbS8jL3NvbWUvcGF0aD9mb289YmFyJmJhej14b3hvCiAgICAgICAgICogdmFyIHNlYXJjaE9iamVjdCA9ICRsb2NhdGlvbi5zZWFyY2goKTsKICAgICAgICAgKiAvLyA9PiB7Zm9vOiAnYmFyJywgYmF6OiAneG94byd9CiAgICAgICAgICoKICAgICAgICAgKgogICAgICAgICAqIC8vIHNldCBmb28gdG8gJ3lpcGVlJwogICAgICAgICAqICRsb2NhdGlvbi5zZWFyY2goJ2ZvbycsICd5aXBlZScpOwogICAgICAgICAqIC8vID0+ICRsb2NhdGlvbgogICAgICAgICAqIGBgYAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd8T2JqZWN0LjxzdHJpbmc+fE9iamVjdC48QXJyYXkuPHN0cmluZz4+fSBzZWFyY2ggTmV3IHNlYXJjaCBwYXJhbXMgLSBzdHJpbmcgb3IKICAgICAgICAgKiBoYXNoIG9iamVjdC4KICAgICAgICAgKgogICAgICAgICAqIFdoZW4gY2FsbGVkIHdpdGggYSBzaW5nbGUgYXJndW1lbnQgdGhlIG1ldGhvZCBhY3RzIGFzIGEgc2V0dGVyLCBzZXR0aW5nIHRoZSBgc2VhcmNoYCBjb21wb25lbnQKICAgICAgICAgKiBvZiBgJGxvY2F0aW9uYCB0byB0aGUgc3BlY2lmaWVkIHZhbHVlLgogICAgICAgICAqCiAgICAgICAgICogSWYgdGhlIGFyZ3VtZW50IGlzIGEgaGFzaCBvYmplY3QgY29udGFpbmluZyBhbiBhcnJheSBvZiB2YWx1ZXMsIHRoZXNlIHZhbHVlcyB3aWxsIGJlIGVuY29kZWQKICAgICAgICAgKiBhcyBkdXBsaWNhdGUgc2VhcmNoIHBhcmFtZXRlcnMgaW4gdGhlIHVybC4KICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7KHN0cmluZ3xBcnJheTxzdHJpbmc+KT19IHBhcmFtVmFsdWUgSWYgYHNlYXJjaGAgaXMgYSBzdHJpbmcsIHRoZW4gYHBhcmFtVmFsdWVgIHdpbGwKICAgICAgICAgKiBvdmVycmlkZSBvbmx5IGEgc2luZ2xlIHNlYXJjaCBwcm9wZXJ0eS4KICAgICAgICAgKgogICAgICAgICAqIElmIGBwYXJhbVZhbHVlYCBpcyBhbiBhcnJheSwgaXQgd2lsbCBvdmVycmlkZSB0aGUgcHJvcGVydHkgb2YgdGhlIGBzZWFyY2hgIGNvbXBvbmVudCBvZgogICAgICAgICAqIGAkbG9jYXRpb25gIHNwZWNpZmllZCB2aWEgdGhlIGZpcnN0IGFyZ3VtZW50LgogICAgICAgICAqCiAgICAgICAgICogSWYgYHBhcmFtVmFsdWVgIGlzIGBudWxsYCwgdGhlIHByb3BlcnR5IHNwZWNpZmllZCB2aWEgdGhlIGZpcnN0IGFyZ3VtZW50IHdpbGwgYmUgZGVsZXRlZC4KICAgICAgICAgKgogICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gSWYgY2FsbGVkIHdpdGggbm8gYXJndW1lbnRzIHJldHVybnMgdGhlIHBhcnNlZCBgc2VhcmNoYCBvYmplY3QuIElmIGNhbGxlZCB3aXRoCiAgICAgICAgICogb25lIG9yIG1vcmUgYXJndW1lbnRzIHJldHVybnMgYCRsb2NhdGlvbmAgb2JqZWN0IGl0c2VsZi4KICAgICAgICAgKi8KICAgICAgICBzZWFyY2g6IGZ1bmN0aW9uKHNlYXJjaCwgcGFyYW1WYWx1ZSkgewogICAgICAgICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kJHNlYXJjaDsKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgIGlmIChpc1N0cmluZyhzZWFyY2gpKSB7CiAgICAgICAgICAgICAgICB0aGlzLiQkc2VhcmNoID0gcGFyc2VLZXlWYWx1ZShzZWFyY2gpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qoc2VhcmNoKSkgewogICAgICAgICAgICAgICAgdGhpcy4kJHNlYXJjaCA9IHNlYXJjaDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgJGxvY2F0aW9uTWluRXJyKCdpc3JjaGFyZycsCiAgICAgICAgICAgICAgICAgICdUaGUgZmlyc3QgYXJndW1lbnQgb2YgdGhlIGAkbG9jYXRpb24jc2VhcmNoKClgIGNhbGwgbXVzdCBiZSBhIHN0cmluZyBvciBhbiBvYmplY3QuJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmIChpc1VuZGVmaW5lZChwYXJhbVZhbHVlKSB8fCBwYXJhbVZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy4kJHNlYXJjaFtzZWFyY2hdOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLiQkc2VhcmNoW3NlYXJjaF0gPSBwYXJhbVZhbHVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICB0aGlzLiQkY29tcG9zZSgpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRsb2NhdGlvbiNoYXNoCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBUaGlzIG1ldGhvZCBpcyBnZXR0ZXIgLyBzZXR0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBSZXR1cm4gaGFzaCBmcmFnbWVudCB3aGVuIGNhbGxlZCB3aXRob3V0IGFueSBwYXJhbWV0ZXIuCiAgICAgICAgICoKICAgICAgICAgKiBDaGFuZ2UgaGFzaCBmcmFnbWVudCB3aGVuIGNhbGxlZCB3aXRoIHBhcmFtZXRlciBhbmQgcmV0dXJuIGAkbG9jYXRpb25gLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBoYXNoIE5ldyBoYXNoIGZyYWdtZW50CiAgICAgICAgICogQHJldHVybiB7c3RyaW5nfSBoYXNoCiAgICAgICAgICovCiAgICAgICAgaGFzaDogbG9jYXRpb25HZXR0ZXJTZXR0ZXIoJyQkaGFzaCcsIGlkZW50aXR5KSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRsb2NhdGlvbiNyZXBsYWNlCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBJZiBjYWxsZWQsIGFsbCBjaGFuZ2VzIHRvICRsb2NhdGlvbiBkdXJpbmcgY3VycmVudCBgJGRpZ2VzdGAgd2lsbCBiZSByZXBsYWNpbmcgY3VycmVudCBoaXN0b3J5CiAgICAgICAgICogcmVjb3JkLCBpbnN0ZWFkIG9mIGFkZGluZyBuZXcgb25lLgogICAgICAgICAqLwogICAgICAgIHJlcGxhY2U6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy4kJHJlcGxhY2UgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQogICAgICB9OwoKICBmdW5jdGlvbiBsb2NhdGlvbkdldHRlcihwcm9wZXJ0eSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpc1twcm9wZXJ0eV07CiAgICB9OwogIH0KCgogIGZ1bmN0aW9uIGxvY2F0aW9uR2V0dGVyU2V0dGVyKHByb3BlcnR5LCBwcmVwcm9jZXNzKSB7CiAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKGlzVW5kZWZpbmVkKHZhbHVlKSkKICAgICAgICByZXR1cm4gdGhpc1twcm9wZXJ0eV07CgogICAgICB0aGlzW3Byb3BlcnR5XSA9IHByZXByb2Nlc3ModmFsdWUpOwogICAgICB0aGlzLiQkY29tcG9zZSgpOwoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogIH0KCgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGxvY2F0aW9uCiAgICoKICAgKiBAcmVxdWlyZXMgJHJvb3RFbGVtZW50CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgJGxvY2F0aW9uIHNlcnZpY2UgcGFyc2VzIHRoZSBVUkwgaW4gdGhlIGJyb3dzZXIgYWRkcmVzcyBiYXIgKGJhc2VkIG9uIHRoZQogICAqIFt3aW5kb3cubG9jYXRpb25dKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL3dpbmRvdy5sb2NhdGlvbikpIGFuZCBtYWtlcyB0aGUgVVJMCiAgICogYXZhaWxhYmxlIHRvIHlvdXIgYXBwbGljYXRpb24uIENoYW5nZXMgdG8gdGhlIFVSTCBpbiB0aGUgYWRkcmVzcyBiYXIgYXJlIHJlZmxlY3RlZCBpbnRvCiAgICogJGxvY2F0aW9uIHNlcnZpY2UgYW5kIGNoYW5nZXMgdG8gJGxvY2F0aW9uIGFyZSByZWZsZWN0ZWQgaW50byB0aGUgYnJvd3NlciBhZGRyZXNzIGJhci4KICAgKgogICAqICoqVGhlICRsb2NhdGlvbiBzZXJ2aWNlOioqCiAgICoKICAgKiAtIEV4cG9zZXMgdGhlIGN1cnJlbnQgVVJMIGluIHRoZSBicm93c2VyIGFkZHJlc3MgYmFyLCBzbyB5b3UgY2FuCiAgICogICAtIFdhdGNoIGFuZCBvYnNlcnZlIHRoZSBVUkwuCiAgICogICAtIENoYW5nZSB0aGUgVVJMLgogICAqIC0gU3luY2hyb25pemVzIHRoZSBVUkwgd2l0aCB0aGUgYnJvd3NlciB3aGVuIHRoZSB1c2VyCiAgICogICAtIENoYW5nZXMgdGhlIGFkZHJlc3MgYmFyLgogICAqICAgLSBDbGlja3MgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gKG9yIGNsaWNrcyBhIEhpc3RvcnkgbGluaykuCiAgICogICAtIENsaWNrcyBvbiBhIGxpbmsuCiAgICogLSBSZXByZXNlbnRzIHRoZSBVUkwgb2JqZWN0IGFzIGEgc2V0IG9mIG1ldGhvZHMgKHByb3RvY29sLCBob3N0LCBwb3J0LCBwYXRoLCBzZWFyY2gsIGhhc2gpLgogICAqCiAgICogRm9yIG1vcmUgaW5mb3JtYXRpb24gc2VlIHtAbGluayBndWlkZS8kbG9jYXRpb24gRGV2ZWxvcGVyIEd1aWRlOiBVc2luZyAkbG9jYXRpb259CiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBwcm92aWRlcgogICAqIEBuYW1lICRsb2NhdGlvblByb3ZpZGVyCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXNlIHRoZSBgJGxvY2F0aW9uUHJvdmlkZXJgIHRvIGNvbmZpZ3VyZSBob3cgdGhlIGFwcGxpY2F0aW9uIGRlZXAgbGlua2luZyBwYXRocyBhcmUgc3RvcmVkLgogICAqLwogIGZ1bmN0aW9uICRMb2NhdGlvblByb3ZpZGVyKCl7CiAgICB2YXIgaGFzaFByZWZpeCA9ICcnLAogICAgICBodG1sNU1vZGUgPSBmYWxzZTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgJGxvY2F0aW9uUHJvdmlkZXIjaGFzaFByZWZpeAogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHByZWZpeCBQcmVmaXggZm9yIGhhc2ggcGFydCAoY29udGFpbmluZyBwYXRoIGFuZCBzZWFyY2gpCiAgICAgKiBAcmV0dXJucyB7Kn0gY3VycmVudCB2YWx1ZSBpZiB1c2VkIGFzIGdldHRlciBvciBpdHNlbGYgKGNoYWluaW5nKSBpZiB1c2VkIGFzIHNldHRlcgogICAgICovCiAgICB0aGlzLmhhc2hQcmVmaXggPSBmdW5jdGlvbihwcmVmaXgpIHsKICAgICAgaWYgKGlzRGVmaW5lZChwcmVmaXgpKSB7CiAgICAgICAgaGFzaFByZWZpeCA9IHByZWZpeDsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaGFzaFByZWZpeDsKICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBwcm9wZXJ0eQogICAgICogQG5hbWUgJGxvY2F0aW9uUHJvdmlkZXIjaHRtbDVNb2RlCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IG1vZGUgVXNlIEhUTUw1IHN0cmF0ZWd5IGlmIGF2YWlsYWJsZS4KICAgICAqIEByZXR1cm5zIHsqfSBjdXJyZW50IHZhbHVlIGlmIHVzZWQgYXMgZ2V0dGVyIG9yIGl0c2VsZiAoY2hhaW5pbmcpIGlmIHVzZWQgYXMgc2V0dGVyCiAgICAgKi8KICAgIHRoaXMuaHRtbDVNb2RlID0gZnVuY3Rpb24obW9kZSkgewogICAgICBpZiAoaXNEZWZpbmVkKG1vZGUpKSB7CiAgICAgICAgaHRtbDVNb2RlID0gbW9kZTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaHRtbDVNb2RlOwogICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGV2ZW50CiAgICAgKiBAbmFtZSAkbG9jYXRpb24jJGxvY2F0aW9uQ2hhbmdlU3RhcnQKICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQnJvYWRjYXN0ZWQgYmVmb3JlIGEgVVJMIHdpbGwgY2hhbmdlLiBUaGlzIGNoYW5nZSBjYW4gYmUgcHJldmVudGVkIGJ5IGNhbGxpbmcKICAgICAqIGBwcmV2ZW50RGVmYXVsdGAgbWV0aG9kIG9mIHRoZSBldmVudC4gU2VlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0gZm9yIG1vcmUKICAgICAqIGRldGFpbHMgYWJvdXQgZXZlbnQgb2JqZWN0LiBVcG9uIHN1Y2Nlc3NmdWwgY2hhbmdlCiAgICAgKiB7QGxpbmsgbmcuJGxvY2F0aW9uI2V2ZW50c18kbG9jYXRpb25DaGFuZ2VTdWNjZXNzICRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3N9IGlzIGZpcmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBhbmd1bGFyRXZlbnQgU3ludGhldGljIGV2ZW50IG9iamVjdC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZXdVcmwgTmV3IFVSTAogICAgICogQHBhcmFtIHtzdHJpbmc9fSBvbGRVcmwgVVJMIHRoYXQgd2FzIGJlZm9yZSBpdCB3YXMgY2hhbmdlZC4KICAgICAqLwoKICAgIC8qKgogICAgICogQG5nZG9jIGV2ZW50CiAgICAgKiBAbmFtZSAkbG9jYXRpb24jJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcwogICAgICogQGV2ZW50VHlwZSBicm9hZGNhc3Qgb24gcm9vdCBzY29wZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBCcm9hZGNhc3RlZCBhZnRlciBhIFVSTCB3YXMgY2hhbmdlZC4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdH0gYW5ndWxhckV2ZW50IFN5bnRoZXRpYyBldmVudCBvYmplY3QuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmV3VXJsIE5ldyBVUkwKICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gb2xkVXJsIFVSTCB0aGF0IHdhcyBiZWZvcmUgaXQgd2FzIGNoYW5nZWQuCiAgICAgKi8KCiAgICB0aGlzLiRnZXQgPSBbJyRyb290U2NvcGUnLCAnJGJyb3dzZXInLCAnJHNuaWZmZXInLCAnJHJvb3RFbGVtZW50JywKICAgICAgZnVuY3Rpb24oICRyb290U2NvcGUsICAgJGJyb3dzZXIsICAgJHNuaWZmZXIsICAgJHJvb3RFbGVtZW50KSB7CiAgICAgICAgdmFyICRsb2NhdGlvbiwKICAgICAgICAgIExvY2F0aW9uTW9kZSwKICAgICAgICAgIGJhc2VIcmVmID0gJGJyb3dzZXIuYmFzZUhyZWYoKSwgLy8gaWYgYmFzZVtocmVmXSBpcyB1bmRlZmluZWQsIGl0IGRlZmF1bHRzIHRvICcnCiAgICAgICAgICBpbml0aWFsVXJsID0gJGJyb3dzZXIudXJsKCksCiAgICAgICAgICBhcHBCYXNlOwoKICAgICAgICBpZiAoaHRtbDVNb2RlKSB7CiAgICAgICAgICBhcHBCYXNlID0gc2VydmVyQmFzZShpbml0aWFsVXJsKSArIChiYXNlSHJlZiB8fCAnLycpOwogICAgICAgICAgTG9jYXRpb25Nb2RlID0gJHNuaWZmZXIuaGlzdG9yeSA/IExvY2F0aW9uSHRtbDVVcmwgOiBMb2NhdGlvbkhhc2hiYW5nSW5IdG1sNVVybDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYXBwQmFzZSA9IHN0cmlwSGFzaChpbml0aWFsVXJsKTsKICAgICAgICAgIExvY2F0aW9uTW9kZSA9IExvY2F0aW9uSGFzaGJhbmdVcmw7CiAgICAgICAgfQogICAgICAgICRsb2NhdGlvbiA9IG5ldyBMb2NhdGlvbk1vZGUoYXBwQmFzZSwgJyMnICsgaGFzaFByZWZpeCk7CiAgICAgICAgJGxvY2F0aW9uLiQkcGFyc2UoJGxvY2F0aW9uLiQkcmV3cml0ZShpbml0aWFsVXJsKSk7CgogICAgICAgICRyb290RWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IHJld3JpdGUgbGluayB3aGVuIG9wZW5pbmcgaW4gbmV3IHRhYi93aW5kb3cgKGluIGxlZ2FjeSBicm93c2VyKQogICAgICAgICAgLy8gY3VycmVudGx5IHdlIG9wZW4gbmljZSB1cmwgbGluayBhbmQgcmVkaXJlY3QgdGhlbgoKICAgICAgICAgIGlmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkgfHwgZXZlbnQud2hpY2ggPT0gMikgcmV0dXJuOwoKICAgICAgICAgIHZhciBlbG0gPSBqcUxpdGUoZXZlbnQudGFyZ2V0KTsKCiAgICAgICAgICAvLyB0cmF2ZXJzZSB0aGUgRE9NIHVwIHRvIGZpbmQgZmlyc3QgQSB0YWcKICAgICAgICAgIHdoaWxlIChsb3dlcmNhc2UoZWxtWzBdLm5vZGVOYW1lKSAhPT0gJ2EnKSB7CiAgICAgICAgICAgIC8vIGlnbm9yZSByZXdyaXRpbmcgaWYgbm8gQSB0YWcgKHJlYWNoZWQgcm9vdCBlbGVtZW50LCBvciBubyBwYXJlbnQgLSByZW1vdmVkIGZyb20gZG9jdW1lbnQpCiAgICAgICAgICAgIGlmIChlbG1bMF0gPT09ICRyb290RWxlbWVudFswXSB8fCAhKGVsbSA9IGVsbS5wYXJlbnQoKSlbMF0pIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgYWJzSHJlZiA9IGVsbS5wcm9wKCdocmVmJyk7CgogICAgICAgICAgaWYgKGlzT2JqZWN0KGFic0hyZWYpICYmIGFic0hyZWYudG9TdHJpbmcoKSA9PT0gJ1tvYmplY3QgU1ZHQW5pbWF0ZWRTdHJpbmddJykgewogICAgICAgICAgICAvLyBTVkdBbmltYXRlZFN0cmluZy5hbmltVmFsIHNob3VsZCBiZSBpZGVudGljYWwgdG8gU1ZHQW5pbWF0ZWRTdHJpbmcuYmFzZVZhbCwgdW5sZXNzIGR1cmluZwogICAgICAgICAgICAvLyBhbiBhbmltYXRpb24uCiAgICAgICAgICAgIGFic0hyZWYgPSB1cmxSZXNvbHZlKGFic0hyZWYuYW5pbVZhbCkuaHJlZjsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBNYWtlIHJlbGF0aXZlIGxpbmtzIHdvcmsgaW4gSFRNTDUgbW9kZSBmb3IgbGVnYWN5IGJyb3dzZXJzIChvciBhdCBsZWFzdCBJRTggJiA5KQogICAgICAgICAgLy8gVGhlIGhyZWYgc2hvdWxkIGJlIGEgcmVndWxhciB1cmwgZS5nLiAvbGluay9zb21ld2hlcmUgb3IgbGluay9zb21ld2hlcmUgb3IgLi4vc29tZXdoZXJlIG9yCiAgICAgICAgICAvLyBzb21ld2hlcmUjYW5jaG9yIG9yIGh0dHA6Ly9leGFtcGxlLmNvbS9zb21ld2hlcmUKICAgICAgICAgIGlmIChMb2NhdGlvbk1vZGUgPT09IExvY2F0aW9uSGFzaGJhbmdJbkh0bWw1VXJsKSB7CiAgICAgICAgICAgIC8vIGdldCB0aGUgYWN0dWFsIGhyZWYgYXR0cmlidXRlIC0gc2VlCiAgICAgICAgICAgIC8vIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9kZDM0NzE0OCh2PXZzLjg1KS5hc3B4CiAgICAgICAgICAgIHZhciBocmVmID0gZWxtLmF0dHIoJ2hyZWYnKSB8fCBlbG0uYXR0cigneGxpbms6aHJlZicpOwoKICAgICAgICAgICAgaWYgKGhyZWYuaW5kZXhPZignOi8vJykgPCAwKSB7ICAgICAgICAgLy8gSWdub3JlIGFic29sdXRlIFVSTHMKICAgICAgICAgICAgICB2YXIgcHJlZml4ID0gJyMnICsgaGFzaFByZWZpeDsKICAgICAgICAgICAgICBpZiAoaHJlZlswXSA9PSAnLycpIHsKICAgICAgICAgICAgICAgIC8vIGFic29sdXRlIHBhdGggLSByZXBsYWNlIG9sZCBwYXRoCiAgICAgICAgICAgICAgICBhYnNIcmVmID0gYXBwQmFzZSArIHByZWZpeCArIGhyZWY7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChocmVmWzBdID09ICcjJykgewogICAgICAgICAgICAgICAgLy8gbG9jYWwgYW5jaG9yCiAgICAgICAgICAgICAgICBhYnNIcmVmID0gYXBwQmFzZSArIHByZWZpeCArICgkbG9jYXRpb24ucGF0aCgpIHx8ICcvJykgKyBocmVmOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyByZWxhdGl2ZSBwYXRoIC0gam9pbiB3aXRoIGN1cnJlbnQgcGF0aAogICAgICAgICAgICAgICAgdmFyIHN0YWNrID0gJGxvY2F0aW9uLnBhdGgoKS5zcGxpdCgiLyIpLAogICAgICAgICAgICAgICAgICBwYXJ0cyA9IGhyZWYuc3BsaXQoIi8iKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGk9MDsgaTxwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICBpZiAocGFydHNbaV0gPT0gIi4iKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICBlbHNlIGlmIChwYXJ0c1tpXSA9PSAiLi4iKQogICAgICAgICAgICAgICAgICAgIHN0YWNrLnBvcCgpOwogICAgICAgICAgICAgICAgICBlbHNlIGlmIChwYXJ0c1tpXS5sZW5ndGgpCiAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaChwYXJ0c1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhYnNIcmVmID0gYXBwQmFzZSArIHByZWZpeCArIHN0YWNrLmpvaW4oJy8nKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgcmV3cml0dGVuVXJsID0gJGxvY2F0aW9uLiQkcmV3cml0ZShhYnNIcmVmKTsKCiAgICAgICAgICBpZiAoYWJzSHJlZiAmJiAhZWxtLmF0dHIoJ3RhcmdldCcpICYmIHJld3JpdHRlblVybCAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgaWYgKHJld3JpdHRlblVybCAhPSAkYnJvd3Nlci51cmwoKSkgewogICAgICAgICAgICAgIC8vIHVwZGF0ZSBsb2NhdGlvbiBtYW51YWxseQogICAgICAgICAgICAgICRsb2NhdGlvbi4kJHBhcnNlKHJld3JpdHRlblVybCk7CiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICAvLyBoYWNrIHRvIHdvcmsgYXJvdW5kIEZGNiBidWcgNjg0MjA4IHdoZW4gc2NlbmFyaW8gcnVubmVyIGNsaWNrcyBvbiBsaW5rcwogICAgICAgICAgICAgIHdpbmRvdy5hbmd1bGFyWydmZi02ODQyMDgtcHJldmVudERlZmF1bHQnXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKCgogICAgICAgIC8vIHJld3JpdGUgaGFzaGJhbmcgdXJsIDw+IGh0bWw1IHVybAogICAgICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gaW5pdGlhbFVybCkgewogICAgICAgICAgJGJyb3dzZXIudXJsKCRsb2NhdGlvbi5hYnNVcmwoKSwgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyB1cGRhdGUgJGxvY2F0aW9uIHdoZW4gJGJyb3dzZXIgdXJsIGNoYW5nZXMKICAgICAgICAkYnJvd3Nlci5vblVybENoYW5nZShmdW5jdGlvbihuZXdVcmwpIHsKICAgICAgICAgIGlmICgkbG9jYXRpb24uYWJzVXJsKCkgIT0gbmV3VXJsKSB7CiAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgb2xkVXJsID0gJGxvY2F0aW9uLmFic1VybCgpOwoKICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShuZXdVcmwpOwogICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRsb2NhdGlvbkNoYW5nZVN0YXJ0JywgbmV3VXJsLAogICAgICAgICAgICAgICAgb2xkVXJsKS5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAkbG9jYXRpb24uJCRwYXJzZShvbGRVcmwpOwogICAgICAgICAgICAgICAgJGJyb3dzZXIudXJsKG9sZFVybCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoISRyb290U2NvcGUuJCRwaGFzZSkgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8vIHVwZGF0ZSBicm93c2VyCiAgICAgICAgdmFyIGNoYW5nZUNvdW50ZXIgPSAwOwogICAgICAgICRyb290U2NvcGUuJHdhdGNoKGZ1bmN0aW9uICRsb2NhdGlvbldhdGNoKCkgewogICAgICAgICAgdmFyIG9sZFVybCA9ICRicm93c2VyLnVybCgpOwogICAgICAgICAgdmFyIGN1cnJlbnRSZXBsYWNlID0gJGxvY2F0aW9uLiQkcmVwbGFjZTsKCiAgICAgICAgICBpZiAoIWNoYW5nZUNvdW50ZXIgfHwgb2xkVXJsICE9ICRsb2NhdGlvbi5hYnNVcmwoKSkgewogICAgICAgICAgICBjaGFuZ2VDb3VudGVyKys7CiAgICAgICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdGFydCcsICRsb2NhdGlvbi5hYnNVcmwoKSwgb2xkVXJsKS4KICAgICAgICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgICAgICRsb2NhdGlvbi4kJHBhcnNlKG9sZFVybCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICRicm93c2VyLnVybCgkbG9jYXRpb24uYWJzVXJsKCksIGN1cnJlbnRSZXBsYWNlKTsKICAgICAgICAgICAgICAgIGFmdGVyTG9jYXRpb25DaGFuZ2Uob2xkVXJsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgJGxvY2F0aW9uLiQkcmVwbGFjZSA9IGZhbHNlOwoKICAgICAgICAgIHJldHVybiBjaGFuZ2VDb3VudGVyOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gJGxvY2F0aW9uOwoKICAgICAgICBmdW5jdGlvbiBhZnRlckxvY2F0aW9uQ2hhbmdlKG9sZFVybCkgewogICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckbG9jYXRpb25DaGFuZ2VTdWNjZXNzJywgJGxvY2F0aW9uLmFic1VybCgpLCBvbGRVcmwpOwogICAgICAgIH0KICAgICAgfV07CiAgfQoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRsb2cKICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2ltcGxlIHNlcnZpY2UgZm9yIGxvZ2dpbmcuIERlZmF1bHQgaW1wbGVtZW50YXRpb24gc2FmZWx5IHdyaXRlcyB0aGUgbWVzc2FnZQogICAqIGludG8gdGhlIGJyb3dzZXIncyBjb25zb2xlIChpZiBwcmVzZW50KS4KICAgKgogICAqIFRoZSBtYWluIHB1cnBvc2Ugb2YgdGhpcyBzZXJ2aWNlIGlzIHRvIHNpbXBsaWZ5IGRlYnVnZ2luZyBhbmQgdHJvdWJsZXNob290aW5nLgogICAqCiAgICogVGhlIGRlZmF1bHQgaXMgdG8gbG9nIGBkZWJ1Z2AgbWVzc2FnZXMuIFlvdSBjYW4gdXNlCiAgICoge0BsaW5rIG5nLiRsb2dQcm92aWRlciBuZy4kbG9nUHJvdmlkZXIjZGVidWdFbmFibGVkfSB0byBjaGFuZ2UgdGhpcy4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICBmdW5jdGlvbiBMb2dDdHJsKCRzY29wZSwgJGxvZykgewogICAgICAgICAkc2NvcGUuJGxvZyA9ICRsb2c7CiAgICAgICAgICRzY29wZS5tZXNzYWdlID0gJ0hlbGxvIFdvcmxkISc7CiAgICAgICB9CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iTG9nQ3RybCI+CiAgIDxwPlJlbG9hZCB0aGlzIHBhZ2Ugd2l0aCBvcGVuIGNvbnNvbGUsIGVudGVyIHRleHQgYW5kIGhpdCB0aGUgbG9nIGJ1dHRvbi4uLjwvcD4KICAgTWVzc2FnZToKICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJtZXNzYWdlIi8+CiAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cubG9nKG1lc3NhZ2UpIj5sb2c8L2J1dHRvbj4KICAgPGJ1dHRvbiBuZy1jbGljaz0iJGxvZy53YXJuKG1lc3NhZ2UpIj53YXJuPC9idXR0b24+CiAgIDxidXR0b24gbmctY2xpY2s9IiRsb2cuaW5mbyhtZXNzYWdlKSI+aW5mbzwvYnV0dG9uPgogICA8YnV0dG9uIG5nLWNsaWNrPSIkbG9nLmVycm9yKG1lc3NhZ2UpIj5lcnJvcjwvYnV0dG9uPgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBwcm92aWRlcgogICAqIEBuYW1lICRsb2dQcm92aWRlcgogICAqIEBkZXNjcmlwdGlvbgogICAqIFVzZSB0aGUgYCRsb2dQcm92aWRlcmAgdG8gY29uZmlndXJlIGhvdyB0aGUgYXBwbGljYXRpb24gbG9ncyBtZXNzYWdlcwogICAqLwogIGZ1bmN0aW9uICRMb2dQcm92aWRlcigpewogICAgdmFyIGRlYnVnID0gdHJ1ZSwKICAgICAgc2VsZiA9IHRoaXM7CgogICAgLyoqCiAgICAgKiBAbmdkb2MgcHJvcGVydHkKICAgICAqIEBuYW1lICRsb2dQcm92aWRlciNkZWJ1Z0VuYWJsZWQKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQHBhcmFtIHtib29sZWFuPX0gZmxhZyBlbmFibGUgb3IgZGlzYWJsZSBkZWJ1ZyBsZXZlbCBtZXNzYWdlcwogICAgICogQHJldHVybnMgeyp9IGN1cnJlbnQgdmFsdWUgaWYgdXNlZCBhcyBnZXR0ZXIgb3IgaXRzZWxmIChjaGFpbmluZykgaWYgdXNlZCBhcyBzZXR0ZXIKICAgICAqLwogICAgdGhpcy5kZWJ1Z0VuYWJsZWQgPSBmdW5jdGlvbihmbGFnKSB7CiAgICAgIGlmIChpc0RlZmluZWQoZmxhZykpIHsKICAgICAgICBkZWJ1ZyA9IGZsYWc7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGRlYnVnOwogICAgICB9CiAgICB9OwoKICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsIGZ1bmN0aW9uKCR3aW5kb3cpewogICAgICByZXR1cm4gewogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkbG9nI2xvZwogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogV3JpdGUgYSBsb2cgbWVzc2FnZQogICAgICAgICAqLwogICAgICAgIGxvZzogY29uc29sZUxvZygnbG9nJyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkbG9nI2luZm8KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFdyaXRlIGFuIGluZm9ybWF0aW9uIG1lc3NhZ2UKICAgICAgICAgKi8KICAgICAgICBpbmZvOiBjb25zb2xlTG9nKCdpbmZvJyksCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSAkbG9nI3dhcm4KICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIFdyaXRlIGEgd2FybmluZyBtZXNzYWdlCiAgICAgICAgICovCiAgICAgICAgd2FybjogY29uc29sZUxvZygnd2FybicpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGxvZyNlcnJvcgogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogV3JpdGUgYW4gZXJyb3IgbWVzc2FnZQogICAgICAgICAqLwogICAgICAgIGVycm9yOiBjb25zb2xlTG9nKCdlcnJvcicpLAoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGxvZyNkZWJ1ZwogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogV3JpdGUgYSBkZWJ1ZyBtZXNzYWdlCiAgICAgICAgICovCiAgICAgICAgZGVidWc6IChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgZm4gPSBjb25zb2xlTG9nKCdkZWJ1ZycpOwoKICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGRlYnVnKSB7CiAgICAgICAgICAgICAgZm4uYXBwbHkoc2VsZiwgYXJndW1lbnRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9KCkpCiAgICAgIH07CgogICAgICBmdW5jdGlvbiBmb3JtYXRFcnJvcihhcmcpIHsKICAgICAgICBpZiAoYXJnIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICAgIGlmIChhcmcuc3RhY2spIHsKICAgICAgICAgICAgYXJnID0gKGFyZy5tZXNzYWdlICYmIGFyZy5zdGFjay5pbmRleE9mKGFyZy5tZXNzYWdlKSA9PT0gLTEpCiAgICAgICAgICAgICAgPyAnRXJyb3I6ICcgKyBhcmcubWVzc2FnZSArICdcbicgKyBhcmcuc3RhY2sKICAgICAgICAgICAgICA6IGFyZy5zdGFjazsKICAgICAgICAgIH0gZWxzZSBpZiAoYXJnLnNvdXJjZVVSTCkgewogICAgICAgICAgICBhcmcgPSBhcmcubWVzc2FnZSArICdcbicgKyBhcmcuc291cmNlVVJMICsgJzonICsgYXJnLmxpbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcmc7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNvbnNvbGVMb2codHlwZSkgewogICAgICAgIHZhciBjb25zb2xlID0gJHdpbmRvdy5jb25zb2xlIHx8IHt9LAogICAgICAgICAgbG9nRm4gPSBjb25zb2xlW3R5cGVdIHx8IGNvbnNvbGUubG9nIHx8IG5vb3AsCiAgICAgICAgICBoYXNBcHBseSA9IGZhbHNlOwoKICAgICAgICAvLyBOb3RlOiByZWFkaW5nIGxvZ0ZuLmFwcGx5IHRocm93cyBhbiBlcnJvciBpbiBJRTExIGluIElFOCBkb2N1bWVudCBtb2RlLgogICAgICAgIC8vIFRoZSByZWFzb24gYmVoaW5kIHRoaXMgaXMgdGhhdCBjb25zb2xlLmxvZyBoYXMgdHlwZSAib2JqZWN0IiBpbiBJRTguLi4KICAgICAgICB0cnkgewogICAgICAgICAgaGFzQXBwbHkgPSAhIWxvZ0ZuLmFwcGx5OwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CgogICAgICAgIGlmIChoYXNBcHBseSkgewogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKGFyZ3VtZW50cywgZnVuY3Rpb24oYXJnKSB7CiAgICAgICAgICAgICAgYXJncy5wdXNoKGZvcm1hdEVycm9yKGFyZykpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGxvZ0ZuLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIC8vIHdlIGFyZSBJRSB3aGljaCBlaXRoZXIgZG9lc24ndCBoYXZlIHdpbmRvdy5jb25zb2xlID0+IHRoaXMgaXMgbm9vcCBhbmQgd2UgZG8gbm90aGluZywKICAgICAgICAvLyBvciB3ZSBhcmUgSUUgd2hlcmUgY29uc29sZS5sb2cgZG9lc24ndCBoYXZlIGFwcGx5IHNvIHdlIGxvZyBhdCBsZWFzdCBmaXJzdCAyIGFyZ3MKICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJnMSwgYXJnMikgewogICAgICAgICAgbG9nRm4oYXJnMSwgYXJnMiA9PSBudWxsID8gJycgOiBhcmcyKTsKICAgICAgICB9OwogICAgICB9CiAgICB9XTsKICB9CgogIHZhciAkcGFyc2VNaW5FcnIgPSBtaW5FcnIoJyRwYXJzZScpOwogIHZhciBwcm9taXNlV2FybmluZ0NhY2hlID0ge307CiAgdmFyIHByb21pc2VXYXJuaW5nOwoKLy8gU2FuZGJveGluZyBBbmd1bGFyIEV4cHJlc3Npb25zCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyBBbmd1bGFyIGV4cHJlc3Npb25zIGFyZSBnZW5lcmFsbHkgY29uc2lkZXJlZCBzYWZlIGJlY2F1c2UgdGhlc2UgZXhwcmVzc2lvbnMgb25seSBoYXZlIGRpcmVjdAovLyBhY2Nlc3MgdG8gJHNjb3BlIGFuZCBsb2NhbHMuIEhvd2V2ZXIsIG9uZSBjYW4gb2J0YWluIHRoZSBhYmlsaXR5IHRvIGV4ZWN1dGUgYXJiaXRyYXJ5IEpTIGNvZGUgYnkKLy8gb2J0YWluaW5nIGEgcmVmZXJlbmNlIHRvIG5hdGl2ZSBKUyBmdW5jdGlvbnMgc3VjaCBhcyB0aGUgRnVuY3Rpb24gY29uc3RydWN0b3IuCi8vCi8vIEFzIGFuIGV4YW1wbGUsIGNvbnNpZGVyIHRoZSBmb2xsb3dpbmcgQW5ndWxhciBleHByZXNzaW9uOgovLwovLyAgIHt9LnRvU3RyaW5nLmNvbnN0cnVjdG9yKGFsZXJ0KCJldmlsIEpTIGNvZGUiKSkKLy8KLy8gV2Ugd2FudCB0byBwcmV2ZW50IHRoaXMgdHlwZSBvZiBhY2Nlc3MuIEZvciB0aGUgc2FrZSBvZiBwZXJmb3JtYW5jZSwgZHVyaW5nIHRoZSBsZXhpbmcgcGhhc2Ugd2UKLy8gZGlzYWxsb3cgYW55ICJkb3R0ZWQiIGFjY2VzcyB0byBhbnkgbWVtYmVyIG5hbWVkICJjb25zdHJ1Y3RvciIuCi8vCi8vIEZvciByZWZsZWN0aXZlIGNhbGxzIChhW2JdKSB3ZSBjaGVjayB0aGF0IHRoZSB2YWx1ZSBvZiB0aGUgbG9va3VwIGlzIG5vdCB0aGUgRnVuY3Rpb24gY29uc3RydWN0b3IKLy8gd2hpbGUgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbiwgd2hpY2ggaXMgYSBzdHJvbmdlciBidXQgbW9yZSBleHBlbnNpdmUgdGVzdC4gU2luY2UgcmVmbGVjdGl2ZQovLyBjYWxscyBhcmUgZXhwZW5zaXZlIGFueXdheSwgdGhpcyBpcyBub3Qgc3VjaCBhIGJpZyBkZWFsIGNvbXBhcmVkIHRvIHN0YXRpYyBkZXJlZmVyZW5jaW5nLgovLwovLyBUaGlzIHNhbmRib3hpbmcgdGVjaG5pcXVlIGlzIG5vdCBwZXJmZWN0IGFuZCBkb2Vzbid0IGFpbSB0byBiZS4gVGhlIGdvYWwgaXMgdG8gcHJldmVudCBleHBsb2l0cwovLyBhZ2FpbnN0IHRoZSBleHByZXNzaW9uIGxhbmd1YWdlLCBidXQgbm90IHRvIHByZXZlbnQgZXhwbG9pdHMgdGhhdCB3ZXJlIGVuYWJsZWQgYnkgZXhwb3NpbmcKLy8gc2Vuc2l0aXZlIEphdmFTY3JpcHQgb3IgYnJvd3NlciBhcGlzIG9uIFNjb3BlLiBFeHBvc2luZyBzdWNoIG9iamVjdHMgb24gYSBTY29wZSBpcyBuZXZlciBhIGdvb2QKLy8gcHJhY3RpY2UgYW5kIHRoZXJlZm9yZSB3ZSBhcmUgbm90IGV2ZW4gdHJ5aW5nIHRvIHByb3RlY3QgYWdhaW5zdCBpbnRlcmFjdGlvbiB3aXRoIGFuIG9iamVjdAovLyBleHBsaWNpdGx5IGV4cG9zZWQgaW4gdGhpcyB3YXkuCi8vCi8vIEEgZGV2ZWxvcGVyIGNvdWxkIGZvaWwgdGhlIG5hbWUgY2hlY2sgYnkgYWxpYXNpbmcgdGhlIEZ1bmN0aW9uIGNvbnN0cnVjdG9yIHVuZGVyIGEgZGlmZmVyZW50Ci8vIG5hbWUgb24gdGhlIHNjb3BlLgovLwovLyBJbiBnZW5lcmFsLCBpdCBpcyBub3QgcG9zc2libGUgdG8gYWNjZXNzIGEgV2luZG93IG9iamVjdCBmcm9tIGFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB1bmxlc3MgYQovLyB3aW5kb3cgb3Igc29tZSBET00gb2JqZWN0IHRoYXQgaGFzIGEgcmVmZXJlbmNlIHRvIHdpbmRvdyBpcyBwdWJsaXNoZWQgb250byBhIFNjb3BlLgoKICBmdW5jdGlvbiBlbnN1cmVTYWZlTWVtYmVyTmFtZShuYW1lLCBmdWxsRXhwcmVzc2lvbikgewogICAgaWYgKG5hbWUgPT09ICJjb25zdHJ1Y3RvciIpIHsKICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdpc2VjZmxkJywKICAgICAgICAnUmVmZXJlbmNpbmcgImNvbnN0cnVjdG9yIiBmaWVsZCBpbiBBbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRpc2FsbG93ZWQhIEV4cHJlc3Npb246IHswfScsCiAgICAgICAgZnVsbEV4cHJlc3Npb24pOwogICAgfQogICAgcmV0dXJuIG5hbWU7CiAgfQoKICBmdW5jdGlvbiBlbnN1cmVTYWZlT2JqZWN0KG9iaiwgZnVsbEV4cHJlc3Npb24pIHsKICAgIC8vIG5pZnR5IGNoZWNrIGlmIG9iaiBpcyBGdW5jdGlvbiB0aGF0IGlzIGZhc3QgYW5kIHdvcmtzIGFjcm9zcyBpZnJhbWVzIGFuZCBvdGhlciBjb250ZXh0cwogICAgaWYgKG9iaikgewogICAgICBpZiAob2JqLmNvbnN0cnVjdG9yID09PSBvYmopIHsKICAgICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2lzZWNmbicsCiAgICAgICAgICAnUmVmZXJlbmNpbmcgRnVuY3Rpb24gaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLAogICAgICAgICAgZnVsbEV4cHJlc3Npb24pOwogICAgICB9IGVsc2UgaWYgKC8vIGlzV2luZG93KG9iaikKICAgICAgICBvYmouZG9jdW1lbnQgJiYgb2JqLmxvY2F0aW9uICYmIG9iai5hbGVydCAmJiBvYmouc2V0SW50ZXJ2YWwpIHsKICAgICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2lzZWN3aW5kb3cnLAogICAgICAgICAgJ1JlZmVyZW5jaW5nIHRoZSBXaW5kb3cgaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkaXNhbGxvd2VkISBFeHByZXNzaW9uOiB7MH0nLAogICAgICAgICAgZnVsbEV4cHJlc3Npb24pOwogICAgICB9IGVsc2UgaWYgKC8vIGlzRWxlbWVudChvYmopCiAgICAgICAgb2JqLmNoaWxkcmVuICYmIChvYmoubm9kZU5hbWUgfHwgKG9iai5wcm9wICYmIG9iai5hdHRyICYmIG9iai5maW5kKSkpIHsKICAgICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2lzZWNkb20nLAogICAgICAgICAgJ1JlZmVyZW5jaW5nIERPTSBub2RlcyBpbiBBbmd1bGFyIGV4cHJlc3Npb25zIGlzIGRpc2FsbG93ZWQhIEV4cHJlc3Npb246IHswfScsCiAgICAgICAgICBmdWxsRXhwcmVzc2lvbik7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvYmo7CiAgfQoKICB2YXIgT1BFUkFUT1JTID0gewogICAgLyoganNoaW50IGJpdHdpc2UgOiBmYWxzZSAqLwogICAgJ251bGwnOmZ1bmN0aW9uKCl7cmV0dXJuIG51bGw7fSwKICAgICd0cnVlJzpmdW5jdGlvbigpe3JldHVybiB0cnVlO30sCiAgICAnZmFsc2UnOmZ1bmN0aW9uKCl7cmV0dXJuIGZhbHNlO30sCiAgICB1bmRlZmluZWQ6bm9vcCwKICAgICcrJzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7CiAgICAgIGE9YShzZWxmLCBsb2NhbHMpOyBiPWIoc2VsZiwgbG9jYWxzKTsKICAgICAgaWYgKGlzRGVmaW5lZChhKSkgewogICAgICAgIGlmIChpc0RlZmluZWQoYikpIHsKICAgICAgICAgIHJldHVybiBhICsgYjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGE7CiAgICAgIH0KICAgICAgcmV0dXJuIGlzRGVmaW5lZChiKT9iOnVuZGVmaW5lZDt9LAogICAgJy0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXsKICAgICAgYT1hKHNlbGYsIGxvY2Fscyk7IGI9YihzZWxmLCBsb2NhbHMpOwogICAgICByZXR1cm4gKGlzRGVmaW5lZChhKT9hOjApLShpc0RlZmluZWQoYik/YjowKTsKICAgIH0sCiAgICAnKic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykqYihzZWxmLCBsb2NhbHMpO30sCiAgICAnLyc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykvYihzZWxmLCBsb2NhbHMpO30sCiAgICAnJSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscyklYihzZWxmLCBsb2NhbHMpO30sCiAgICAnXic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscyleYihzZWxmLCBsb2NhbHMpO30sCiAgICAnPSc6bm9vcCwKICAgICc9PT0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSwgYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKT09PWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJyE9PSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLCBiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpIT09YihzZWxmLCBsb2NhbHMpO30sCiAgICAnPT0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPT1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICchPSc6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykhPWIoc2VsZiwgbG9jYWxzKTt9LAogICAgJzwnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPGIoc2VsZiwgbG9jYWxzKTt9LAogICAgJz4nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPmIoc2VsZiwgbG9jYWxzKTt9LAogICAgJzw9JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKTw9YihzZWxmLCBsb2NhbHMpO30sCiAgICAnPj0nOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYShzZWxmLCBsb2NhbHMpPj1iKHNlbGYsIGxvY2Fscyk7fSwKICAgICcmJic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykmJmIoc2VsZiwgbG9jYWxzKTt9LAogICAgJ3x8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGEoc2VsZiwgbG9jYWxzKXx8YihzZWxmLCBsb2NhbHMpO30sCiAgICAnJic6ZnVuY3Rpb24oc2VsZiwgbG9jYWxzLCBhLGIpe3JldHVybiBhKHNlbGYsIGxvY2FscykmYihzZWxmLCBsb2NhbHMpO30sCi8vICAgICd8JzpmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGEsYil7cmV0dXJuIGF8Yjt9LAogICAgJ3wnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSxiKXtyZXR1cm4gYihzZWxmLCBsb2NhbHMpKHNlbGYsIGxvY2FscywgYShzZWxmLCBsb2NhbHMpKTt9LAogICAgJyEnOmZ1bmN0aW9uKHNlbGYsIGxvY2FscywgYSl7cmV0dXJuICFhKHNlbGYsIGxvY2Fscyk7fQogIH07CiAgLyoganNoaW50IGJpdHdpc2U6IHRydWUgKi8KICB2YXIgRVNDQVBFID0geyJuIjoiXG4iLCAiZiI6IlxmIiwgInIiOiJcciIsICJ0IjoiXHQiLCAidiI6Ilx2IiwgIiciOiInIiwgJyInOiciJ307CgoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCgogIC8qKgogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIHZhciBMZXhlciA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogIH07CgogIExleGVyLnByb3RvdHlwZSA9IHsKICAgIGNvbnN0cnVjdG9yOiBMZXhlciwKCiAgICBsZXg6IGZ1bmN0aW9uICh0ZXh0KSB7CiAgICAgIHRoaXMudGV4dCA9IHRleHQ7CgogICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgdGhpcy5jaCA9IHVuZGVmaW5lZDsKICAgICAgdGhpcy5sYXN0Q2ggPSAnOic7IC8vIGNhbiBzdGFydCByZWdleHAKCiAgICAgIHRoaXMudG9rZW5zID0gW107CgogICAgICB3aGlsZSAodGhpcy5pbmRleCA8IHRoaXMudGV4dC5sZW5ndGgpIHsKICAgICAgICB0aGlzLmNoID0gdGhpcy50ZXh0LmNoYXJBdCh0aGlzLmluZGV4KTsKICAgICAgICBpZiAodGhpcy5pcygnIlwnJykpIHsKICAgICAgICAgIHRoaXMucmVhZFN0cmluZyh0aGlzLmNoKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNOdW1iZXIodGhpcy5jaCkgfHwgdGhpcy5pcygnLicpICYmIHRoaXMuaXNOdW1iZXIodGhpcy5wZWVrKCkpKSB7CiAgICAgICAgICB0aGlzLnJlYWROdW1iZXIoKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNJZGVudCh0aGlzLmNoKSkgewogICAgICAgICAgdGhpcy5yZWFkSWRlbnQoKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXMoJygpe31bXS4sOzo/JykpIHsKICAgICAgICAgIHRoaXMudG9rZW5zLnB1c2goewogICAgICAgICAgICBpbmRleDogdGhpcy5pbmRleCwKICAgICAgICAgICAgdGV4dDogdGhpcy5jaAogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLmluZGV4Kys7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzV2hpdGVzcGFjZSh0aGlzLmNoKSkgewogICAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBjaDIgPSB0aGlzLmNoICsgdGhpcy5wZWVrKCk7CiAgICAgICAgICB2YXIgY2gzID0gY2gyICsgdGhpcy5wZWVrKDIpOwogICAgICAgICAgdmFyIGZuID0gT1BFUkFUT1JTW3RoaXMuY2hdOwogICAgICAgICAgdmFyIGZuMiA9IE9QRVJBVE9SU1tjaDJdOwogICAgICAgICAgdmFyIGZuMyA9IE9QRVJBVE9SU1tjaDNdOwogICAgICAgICAgaWYgKGZuMykgewogICAgICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHtpbmRleDogdGhpcy5pbmRleCwgdGV4dDogY2gzLCBmbjogZm4zfSk7CiAgICAgICAgICAgIHRoaXMuaW5kZXggKz0gMzsKICAgICAgICAgIH0gZWxzZSBpZiAoZm4yKSB7CiAgICAgICAgICAgIHRoaXMudG9rZW5zLnB1c2goe2luZGV4OiB0aGlzLmluZGV4LCB0ZXh0OiBjaDIsIGZuOiBmbjJ9KTsKICAgICAgICAgICAgdGhpcy5pbmRleCArPSAyOwogICAgICAgICAgfSBlbHNlIGlmIChmbikgewogICAgICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICBpbmRleDogdGhpcy5pbmRleCwKICAgICAgICAgICAgICB0ZXh0OiB0aGlzLmNoLAogICAgICAgICAgICAgIGZuOiBmbgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5pbmRleCArPSAxOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdVbmV4cGVjdGVkIG5leHQgY2hhcmFjdGVyICcsIHRoaXMuaW5kZXgsIHRoaXMuaW5kZXggKyAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5sYXN0Q2ggPSB0aGlzLmNoOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnRva2VuczsKICAgIH0sCgogICAgaXM6IGZ1bmN0aW9uKGNoYXJzKSB7CiAgICAgIHJldHVybiBjaGFycy5pbmRleE9mKHRoaXMuY2gpICE9PSAtMTsKICAgIH0sCgogICAgd2FzOiBmdW5jdGlvbihjaGFycykgewogICAgICByZXR1cm4gY2hhcnMuaW5kZXhPZih0aGlzLmxhc3RDaCkgIT09IC0xOwogICAgfSwKCiAgICBwZWVrOiBmdW5jdGlvbihpKSB7CiAgICAgIHZhciBudW0gPSBpIHx8IDE7CiAgICAgIHJldHVybiAodGhpcy5pbmRleCArIG51bSA8IHRoaXMudGV4dC5sZW5ndGgpID8gdGhpcy50ZXh0LmNoYXJBdCh0aGlzLmluZGV4ICsgbnVtKSA6IGZhbHNlOwogICAgfSwKCiAgICBpc051bWJlcjogZnVuY3Rpb24oY2gpIHsKICAgICAgcmV0dXJuICgnMCcgPD0gY2ggJiYgY2ggPD0gJzknKTsKICAgIH0sCgogICAgaXNXaGl0ZXNwYWNlOiBmdW5jdGlvbihjaCkgewogICAgICAvLyBJRSB0cmVhdHMgbm9uLWJyZWFraW5nIHNwYWNlIGFzIFx1MDBBMAogICAgICByZXR1cm4gKGNoID09PSAnICcgfHwgY2ggPT09ICdccicgfHwgY2ggPT09ICdcdCcgfHwKICAgICAgICBjaCA9PT0gJ1xuJyB8fCBjaCA9PT0gJ1x2JyB8fCBjaCA9PT0gJ1x1MDBBMCcpOwogICAgfSwKCiAgICBpc0lkZW50OiBmdW5jdGlvbihjaCkgewogICAgICByZXR1cm4gKCdhJyA8PSBjaCAmJiBjaCA8PSAneicgfHwKICAgICAgICAnQScgPD0gY2ggJiYgY2ggPD0gJ1onIHx8CiAgICAgICAgJ18nID09PSBjaCB8fCBjaCA9PT0gJyQnKTsKICAgIH0sCgogICAgaXNFeHBPcGVyYXRvcjogZnVuY3Rpb24oY2gpIHsKICAgICAgcmV0dXJuIChjaCA9PT0gJy0nIHx8IGNoID09PSAnKycgfHwgdGhpcy5pc051bWJlcihjaCkpOwogICAgfSwKCiAgICB0aHJvd0Vycm9yOiBmdW5jdGlvbihlcnJvciwgc3RhcnQsIGVuZCkgewogICAgICBlbmQgPSBlbmQgfHwgdGhpcy5pbmRleDsKICAgICAgdmFyIGNvbFN0ciA9IChpc0RlZmluZWQoc3RhcnQpCiAgICAgICAgPyAncyAnICsgc3RhcnQgKyAgJy0nICsgdGhpcy5pbmRleCArICcgWycgKyB0aGlzLnRleHQuc3Vic3RyaW5nKHN0YXJ0LCBlbmQpICsgJ10nCiAgICAgICAgOiAnICcgKyBlbmQpOwogICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ2xleGVycicsICdMZXhlciBFcnJvcjogezB9IGF0IGNvbHVtbnsxfSBpbiBleHByZXNzaW9uIFt7Mn1dLicsCiAgICAgICAgZXJyb3IsIGNvbFN0ciwgdGhpcy50ZXh0KTsKICAgIH0sCgogICAgcmVhZE51bWJlcjogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBudW1iZXIgPSAnJzsKICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5pbmRleDsKICAgICAgd2hpbGUgKHRoaXMuaW5kZXggPCB0aGlzLnRleHQubGVuZ3RoKSB7CiAgICAgICAgdmFyIGNoID0gbG93ZXJjYXNlKHRoaXMudGV4dC5jaGFyQXQodGhpcy5pbmRleCkpOwogICAgICAgIGlmIChjaCA9PSAnLicgfHwgdGhpcy5pc051bWJlcihjaCkpIHsKICAgICAgICAgIG51bWJlciArPSBjaDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHBlZWtDaCA9IHRoaXMucGVlaygpOwogICAgICAgICAgaWYgKGNoID09ICdlJyAmJiB0aGlzLmlzRXhwT3BlcmF0b3IocGVla0NoKSkgewogICAgICAgICAgICBudW1iZXIgKz0gY2g7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNFeHBPcGVyYXRvcihjaCkgJiYKICAgICAgICAgICAgcGVla0NoICYmIHRoaXMuaXNOdW1iZXIocGVla0NoKSAmJgogICAgICAgICAgICBudW1iZXIuY2hhckF0KG51bWJlci5sZW5ndGggLSAxKSA9PSAnZScpIHsKICAgICAgICAgICAgbnVtYmVyICs9IGNoOwogICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzRXhwT3BlcmF0b3IoY2gpICYmCiAgICAgICAgICAgICghcGVla0NoIHx8ICF0aGlzLmlzTnVtYmVyKHBlZWtDaCkpICYmCiAgICAgICAgICAgIG51bWJlci5jaGFyQXQobnVtYmVyLmxlbmd0aCAtIDEpID09ICdlJykgewogICAgICAgICAgICB0aGlzLnRocm93RXJyb3IoJ0ludmFsaWQgZXhwb25lbnQnKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmluZGV4Kys7CiAgICAgIH0KICAgICAgbnVtYmVyID0gMSAqIG51bWJlcjsKICAgICAgdGhpcy50b2tlbnMucHVzaCh7CiAgICAgICAgaW5kZXg6IHN0YXJ0LAogICAgICAgIHRleHQ6IG51bWJlciwKICAgICAgICBsaXRlcmFsOiB0cnVlLAogICAgICAgIGNvbnN0YW50OiB0cnVlLAogICAgICAgIGZuOiBmdW5jdGlvbigpIHsgcmV0dXJuIG51bWJlcjsgfQogICAgICB9KTsKICAgIH0sCgogICAgcmVhZElkZW50OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHBhcnNlciA9IHRoaXM7CgogICAgICB2YXIgaWRlbnQgPSAnJzsKICAgICAgdmFyIHN0YXJ0ID0gdGhpcy5pbmRleDsKCiAgICAgIHZhciBsYXN0RG90LCBwZWVrSW5kZXgsIG1ldGhvZE5hbWUsIGNoOwoKICAgICAgd2hpbGUgKHRoaXMuaW5kZXggPCB0aGlzLnRleHQubGVuZ3RoKSB7CiAgICAgICAgY2ggPSB0aGlzLnRleHQuY2hhckF0KHRoaXMuaW5kZXgpOwogICAgICAgIGlmIChjaCA9PT0gJy4nIHx8IHRoaXMuaXNJZGVudChjaCkgfHwgdGhpcy5pc051bWJlcihjaCkpIHsKICAgICAgICAgIGlmIChjaCA9PT0gJy4nKSBsYXN0RG90ID0gdGhpcy5pbmRleDsKICAgICAgICAgIGlkZW50ICs9IGNoOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICB9CgogICAgICAvL2NoZWNrIGlmIHRoaXMgaXMgbm90IGEgbWV0aG9kIGludm9jYXRpb24gYW5kIGlmIGl0IGlzIGJhY2sgb3V0IHRvIGxhc3QgZG90CiAgICAgIGlmIChsYXN0RG90KSB7CiAgICAgICAgcGVla0luZGV4ID0gdGhpcy5pbmRleDsKICAgICAgICB3aGlsZSAocGVla0luZGV4IDwgdGhpcy50ZXh0Lmxlbmd0aCkgewogICAgICAgICAgY2ggPSB0aGlzLnRleHQuY2hhckF0KHBlZWtJbmRleCk7CiAgICAgICAgICBpZiAoY2ggPT09ICcoJykgewogICAgICAgICAgICBtZXRob2ROYW1lID0gaWRlbnQuc3Vic3RyKGxhc3REb3QgLSBzdGFydCArIDEpOwogICAgICAgICAgICBpZGVudCA9IGlkZW50LnN1YnN0cigwLCBsYXN0RG90IC0gc3RhcnQpOwogICAgICAgICAgICB0aGlzLmluZGV4ID0gcGVla0luZGV4OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLmlzV2hpdGVzcGFjZShjaCkpIHsKICAgICAgICAgICAgcGVla0luZGV4Kys7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCgogICAgICB2YXIgdG9rZW4gPSB7CiAgICAgICAgaW5kZXg6IHN0YXJ0LAogICAgICAgIHRleHQ6IGlkZW50CiAgICAgIH07CgogICAgICAvLyBPUEVSQVRPUlMgaXMgb3VyIG93biBvYmplY3Qgc28gd2UgZG9uJ3QgbmVlZCB0byB1c2Ugc3BlY2lhbCBoYXNPd25Qcm9wZXJ0eUZuCiAgICAgIGlmIChPUEVSQVRPUlMuaGFzT3duUHJvcGVydHkoaWRlbnQpKSB7CiAgICAgICAgdG9rZW4uZm4gPSBPUEVSQVRPUlNbaWRlbnRdOwogICAgICAgIHRva2VuLmxpdGVyYWwgPSB0cnVlOwogICAgICAgIHRva2VuLmNvbnN0YW50ID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgZ2V0dGVyID0gZ2V0dGVyRm4oaWRlbnQsIHRoaXMub3B0aW9ucywgdGhpcy50ZXh0KTsKICAgICAgICB0b2tlbi5mbiA9IGV4dGVuZChmdW5jdGlvbihzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgIHJldHVybiAoZ2V0dGVyKHNlbGYsIGxvY2FscykpOwogICAgICAgIH0sIHsKICAgICAgICAgIGFzc2lnbjogZnVuY3Rpb24oc2VsZiwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIHNldHRlcihzZWxmLCBpZGVudCwgdmFsdWUsIHBhcnNlci50ZXh0LCBwYXJzZXIub3B0aW9ucyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRoaXMudG9rZW5zLnB1c2godG9rZW4pOwoKICAgICAgaWYgKG1ldGhvZE5hbWUpIHsKICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgICAgIGluZGV4Omxhc3REb3QsCiAgICAgICAgICB0ZXh0OiAnLicKICAgICAgICB9KTsKICAgICAgICB0aGlzLnRva2Vucy5wdXNoKHsKICAgICAgICAgIGluZGV4OiBsYXN0RG90ICsgMSwKICAgICAgICAgIHRleHQ6IG1ldGhvZE5hbWUKICAgICAgICB9KTsKICAgICAgfQogICAgfSwKCiAgICByZWFkU3RyaW5nOiBmdW5jdGlvbihxdW90ZSkgewogICAgICB2YXIgc3RhcnQgPSB0aGlzLmluZGV4OwogICAgICB0aGlzLmluZGV4Kys7CiAgICAgIHZhciBzdHJpbmcgPSAnJzsKICAgICAgdmFyIHJhd1N0cmluZyA9IHF1b3RlOwogICAgICB2YXIgZXNjYXBlID0gZmFsc2U7CiAgICAgIHdoaWxlICh0aGlzLmluZGV4IDwgdGhpcy50ZXh0Lmxlbmd0aCkgewogICAgICAgIHZhciBjaCA9IHRoaXMudGV4dC5jaGFyQXQodGhpcy5pbmRleCk7CiAgICAgICAgcmF3U3RyaW5nICs9IGNoOwogICAgICAgIGlmIChlc2NhcGUpIHsKICAgICAgICAgIGlmIChjaCA9PT0gJ3UnKSB7CiAgICAgICAgICAgIHZhciBoZXggPSB0aGlzLnRleHQuc3Vic3RyaW5nKHRoaXMuaW5kZXggKyAxLCB0aGlzLmluZGV4ICsgNSk7CiAgICAgICAgICAgIGlmICghaGV4Lm1hdGNoKC9bXGRhLWZdezR9L2kpKQogICAgICAgICAgICAgIHRoaXMudGhyb3dFcnJvcignSW52YWxpZCB1bmljb2RlIGVzY2FwZSBbXFx1JyArIGhleCArICddJyk7CiAgICAgICAgICAgIHRoaXMuaW5kZXggKz0gNDsKICAgICAgICAgICAgc3RyaW5nICs9IFN0cmluZy5mcm9tQ2hhckNvZGUocGFyc2VJbnQoaGV4LCAxNikpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJlcCA9IEVTQ0FQRVtjaF07CiAgICAgICAgICAgIGlmIChyZXApIHsKICAgICAgICAgICAgICBzdHJpbmcgKz0gcmVwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZXNjYXBlID0gZmFsc2U7CiAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gJ1xcJykgewogICAgICAgICAgZXNjYXBlID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKGNoID09PSBxdW90ZSkgewogICAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICAgICAgdGhpcy50b2tlbnMucHVzaCh7CiAgICAgICAgICAgIGluZGV4OiBzdGFydCwKICAgICAgICAgICAgdGV4dDogcmF3U3RyaW5nLAogICAgICAgICAgICBzdHJpbmc6IHN0cmluZywKICAgICAgICAgICAgbGl0ZXJhbDogdHJ1ZSwKICAgICAgICAgICAgY29uc3RhbnQ6IHRydWUsCiAgICAgICAgICAgIGZuOiBmdW5jdGlvbigpIHsgcmV0dXJuIHN0cmluZzsgfQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0cmluZyArPSBjaDsKICAgICAgICB9CiAgICAgICAgdGhpcy5pbmRleCsrOwogICAgICB9CiAgICAgIHRoaXMudGhyb3dFcnJvcignVW50ZXJtaW5hdGVkIHF1b3RlJywgc3RhcnQpOwogICAgfQogIH07CgoKICAvKioKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICB2YXIgUGFyc2VyID0gZnVuY3Rpb24gKGxleGVyLCAkZmlsdGVyLCBvcHRpb25zKSB7CiAgICB0aGlzLmxleGVyID0gbGV4ZXI7CiAgICB0aGlzLiRmaWx0ZXIgPSAkZmlsdGVyOwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICB9OwoKICBQYXJzZXIuWkVSTyA9IGV4dGVuZChmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gMDsKICB9LCB7CiAgICBjb25zdGFudDogdHJ1ZQogIH0pOwoKICBQYXJzZXIucHJvdG90eXBlID0gewogICAgY29uc3RydWN0b3I6IFBhcnNlciwKCiAgICBwYXJzZTogZnVuY3Rpb24gKHRleHQpIHsKICAgICAgdGhpcy50ZXh0ID0gdGV4dDsKCiAgICAgIHRoaXMudG9rZW5zID0gdGhpcy5sZXhlci5sZXgodGV4dCk7CgogICAgICB2YXIgdmFsdWUgPSB0aGlzLnN0YXRlbWVudHMoKTsKCiAgICAgIGlmICh0aGlzLnRva2Vucy5sZW5ndGggIT09IDApIHsKICAgICAgICB0aGlzLnRocm93RXJyb3IoJ2lzIGFuIHVuZXhwZWN0ZWQgdG9rZW4nLCB0aGlzLnRva2Vuc1swXSk7CiAgICAgIH0KCiAgICAgIHZhbHVlLmxpdGVyYWwgPSAhIXZhbHVlLmxpdGVyYWw7CiAgICAgIHZhbHVlLmNvbnN0YW50ID0gISF2YWx1ZS5jb25zdGFudDsKCiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCgogICAgcHJpbWFyeTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgcHJpbWFyeTsKICAgICAgaWYgKHRoaXMuZXhwZWN0KCcoJykpIHsKICAgICAgICBwcmltYXJ5ID0gdGhpcy5maWx0ZXJDaGFpbigpOwogICAgICAgIHRoaXMuY29uc3VtZSgnKScpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuZXhwZWN0KCdbJykpIHsKICAgICAgICBwcmltYXJ5ID0gdGhpcy5hcnJheURlY2xhcmF0aW9uKCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5leHBlY3QoJ3snKSkgewogICAgICAgIHByaW1hcnkgPSB0aGlzLm9iamVjdCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciB0b2tlbiA9IHRoaXMuZXhwZWN0KCk7CiAgICAgICAgcHJpbWFyeSA9IHRva2VuLmZuOwogICAgICAgIGlmICghcHJpbWFyeSkgewogICAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdub3QgYSBwcmltYXJ5IGV4cHJlc3Npb24nLCB0b2tlbik7CiAgICAgICAgfQogICAgICAgIHByaW1hcnkubGl0ZXJhbCA9ICEhdG9rZW4ubGl0ZXJhbDsKICAgICAgICBwcmltYXJ5LmNvbnN0YW50ID0gISF0b2tlbi5jb25zdGFudDsKICAgICAgfQoKICAgICAgdmFyIG5leHQsIGNvbnRleHQ7CiAgICAgIHdoaWxlICgobmV4dCA9IHRoaXMuZXhwZWN0KCcoJywgJ1snLCAnLicpKSkgewogICAgICAgIGlmIChuZXh0LnRleHQgPT09ICcoJykgewogICAgICAgICAgcHJpbWFyeSA9IHRoaXMuZnVuY3Rpb25DYWxsKHByaW1hcnksIGNvbnRleHQpOwogICAgICAgICAgY29udGV4dCA9IG51bGw7CiAgICAgICAgfSBlbHNlIGlmIChuZXh0LnRleHQgPT09ICdbJykgewogICAgICAgICAgY29udGV4dCA9IHByaW1hcnk7CiAgICAgICAgICBwcmltYXJ5ID0gdGhpcy5vYmplY3RJbmRleChwcmltYXJ5KTsKICAgICAgICB9IGVsc2UgaWYgKG5leHQudGV4dCA9PT0gJy4nKSB7CiAgICAgICAgICBjb250ZXh0ID0gcHJpbWFyeTsKICAgICAgICAgIHByaW1hcnkgPSB0aGlzLmZpZWxkQWNjZXNzKHByaW1hcnkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnRocm93RXJyb3IoJ0lNUE9TU0lCTEUnKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHByaW1hcnk7CiAgICB9LAoKICAgIHRocm93RXJyb3I6IGZ1bmN0aW9uKG1zZywgdG9rZW4pIHsKICAgICAgdGhyb3cgJHBhcnNlTWluRXJyKCdzeW50YXgnLAogICAgICAgICdTeW50YXggRXJyb3I6IFRva2VuIFwnezB9XCcgezF9IGF0IGNvbHVtbiB7Mn0gb2YgdGhlIGV4cHJlc3Npb24gW3szfV0gc3RhcnRpbmcgYXQgW3s0fV0uJywKICAgICAgICB0b2tlbi50ZXh0LCBtc2csICh0b2tlbi5pbmRleCArIDEpLCB0aGlzLnRleHQsIHRoaXMudGV4dC5zdWJzdHJpbmcodG9rZW4uaW5kZXgpKTsKICAgIH0sCgogICAgcGVla1Rva2VuOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMudG9rZW5zLmxlbmd0aCA9PT0gMCkKICAgICAgICB0aHJvdyAkcGFyc2VNaW5FcnIoJ3Vlb2UnLCAnVW5leHBlY3RlZCBlbmQgb2YgZXhwcmVzc2lvbjogezB9JywgdGhpcy50ZXh0KTsKICAgICAgcmV0dXJuIHRoaXMudG9rZW5zWzBdOwogICAgfSwKCiAgICBwZWVrOiBmdW5jdGlvbihlMSwgZTIsIGUzLCBlNCkgewogICAgICBpZiAodGhpcy50b2tlbnMubGVuZ3RoID4gMCkgewogICAgICAgIHZhciB0b2tlbiA9IHRoaXMudG9rZW5zWzBdOwogICAgICAgIHZhciB0ID0gdG9rZW4udGV4dDsKICAgICAgICBpZiAodCA9PT0gZTEgfHwgdCA9PT0gZTIgfHwgdCA9PT0gZTMgfHwgdCA9PT0gZTQgfHwKICAgICAgICAgICghZTEgJiYgIWUyICYmICFlMyAmJiAhZTQpKSB7CiAgICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgZXhwZWN0OiBmdW5jdGlvbihlMSwgZTIsIGUzLCBlNCl7CiAgICAgIHZhciB0b2tlbiA9IHRoaXMucGVlayhlMSwgZTIsIGUzLCBlNCk7CiAgICAgIGlmICh0b2tlbikgewogICAgICAgIHRoaXMudG9rZW5zLnNoaWZ0KCk7CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgY29uc3VtZTogZnVuY3Rpb24oZTEpewogICAgICBpZiAoIXRoaXMuZXhwZWN0KGUxKSkgewogICAgICAgIHRoaXMudGhyb3dFcnJvcignaXMgdW5leHBlY3RlZCwgZXhwZWN0aW5nIFsnICsgZTEgKyAnXScsIHRoaXMucGVlaygpKTsKICAgICAgfQogICAgfSwKCiAgICB1bmFyeUZuOiBmdW5jdGlvbihmbiwgcmlnaHQpIHsKICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbihzZWxmLCBsb2NhbHMpIHsKICAgICAgICByZXR1cm4gZm4oc2VsZiwgbG9jYWxzLCByaWdodCk7CiAgICAgIH0sIHsKICAgICAgICBjb25zdGFudDpyaWdodC5jb25zdGFudAogICAgICB9KTsKICAgIH0sCgogICAgdGVybmFyeUZuOiBmdW5jdGlvbihsZWZ0LCBtaWRkbGUsIHJpZ2h0KXsKICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbihzZWxmLCBsb2NhbHMpewogICAgICAgIHJldHVybiBsZWZ0KHNlbGYsIGxvY2FscykgPyBtaWRkbGUoc2VsZiwgbG9jYWxzKSA6IHJpZ2h0KHNlbGYsIGxvY2Fscyk7CiAgICAgIH0sIHsKICAgICAgICBjb25zdGFudDogbGVmdC5jb25zdGFudCAmJiBtaWRkbGUuY29uc3RhbnQgJiYgcmlnaHQuY29uc3RhbnQKICAgICAgfSk7CiAgICB9LAoKICAgIGJpbmFyeUZuOiBmdW5jdGlvbihsZWZ0LCBmbiwgcmlnaHQpIHsKICAgICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbihzZWxmLCBsb2NhbHMpIHsKICAgICAgICByZXR1cm4gZm4oc2VsZiwgbG9jYWxzLCBsZWZ0LCByaWdodCk7CiAgICAgIH0sIHsKICAgICAgICBjb25zdGFudDpsZWZ0LmNvbnN0YW50ICYmIHJpZ2h0LmNvbnN0YW50CiAgICAgIH0pOwogICAgfSwKCiAgICBzdGF0ZW1lbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHN0YXRlbWVudHMgPSBbXTsKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBpZiAodGhpcy50b2tlbnMubGVuZ3RoID4gMCAmJiAhdGhpcy5wZWVrKCd9JywgJyknLCAnOycsICddJykpCiAgICAgICAgICBzdGF0ZW1lbnRzLnB1c2godGhpcy5maWx0ZXJDaGFpbigpKTsKICAgICAgICBpZiAoIXRoaXMuZXhwZWN0KCc7JykpIHsKICAgICAgICAgIC8vIG9wdGltaXplIGZvciB0aGUgY29tbW9uIGNhc2Ugd2hlcmUgdGhlcmUgaXMgb25seSBvbmUgc3RhdGVtZW50LgogICAgICAgICAgLy8gVE9ETyhzaXplKTogbWF5YmUgd2Ugc2hvdWxkIG5vdCBzdXBwb3J0IG11bHRpcGxlIHN0YXRlbWVudHM/CiAgICAgICAgICByZXR1cm4gKHN0YXRlbWVudHMubGVuZ3RoID09PSAxKQogICAgICAgICAgICA/IHN0YXRlbWVudHNbMF0KICAgICAgICAgICAgOiBmdW5jdGlvbihzZWxmLCBsb2NhbHMpIHsKICAgICAgICAgICAgdmFyIHZhbHVlOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0YXRlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgc3RhdGVtZW50ID0gc3RhdGVtZW50c1tpXTsKICAgICAgICAgICAgICBpZiAoc3RhdGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IHN0YXRlbWVudChzZWxmLCBsb2NhbHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBmaWx0ZXJDaGFpbjogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsZWZ0ID0gdGhpcy5leHByZXNzaW9uKCk7CiAgICAgIHZhciB0b2tlbjsKICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJ3wnKSkpIHsKICAgICAgICAgIGxlZnQgPSB0aGlzLmJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCB0aGlzLmZpbHRlcigpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIGZpbHRlcjogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0b2tlbiA9IHRoaXMuZXhwZWN0KCk7CiAgICAgIHZhciBmbiA9IHRoaXMuJGZpbHRlcih0b2tlbi50ZXh0KTsKICAgICAgdmFyIGFyZ3NGbiA9IFtdOwogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnOicpKSkgewogICAgICAgICAgYXJnc0ZuLnB1c2godGhpcy5leHByZXNzaW9uKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgZm5JbnZva2UgPSBmdW5jdGlvbihzZWxmLCBsb2NhbHMsIGlucHV0KSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW2lucHV0XTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzRm4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBhcmdzLnB1c2goYXJnc0ZuW2ldKHNlbGYsIGxvY2FscykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseShzZWxmLCBhcmdzKTsKICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBmbkludm9rZTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIGV4cHJlc3Npb246IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5hc3NpZ25tZW50KCk7CiAgICB9LAoKICAgIGFzc2lnbm1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGVmdCA9IHRoaXMudGVybmFyeSgpOwogICAgICB2YXIgcmlnaHQ7CiAgICAgIHZhciB0b2tlbjsKICAgICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCc9JykpKSB7CiAgICAgICAgaWYgKCFsZWZ0LmFzc2lnbikgewogICAgICAgICAgdGhpcy50aHJvd0Vycm9yKCdpbXBsaWVzIGFzc2lnbm1lbnQgYnV0IFsnICsKICAgICAgICAgICAgdGhpcy50ZXh0LnN1YnN0cmluZygwLCB0b2tlbi5pbmRleCkgKyAnXSBjYW4gbm90IGJlIGFzc2lnbmVkIHRvJywgdG9rZW4pOwogICAgICAgIH0KICAgICAgICByaWdodCA9IHRoaXMudGVybmFyeSgpOwogICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgICByZXR1cm4gbGVmdC5hc3NpZ24oc2NvcGUsIHJpZ2h0KHNjb3BlLCBsb2NhbHMpLCBsb2NhbHMpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQ7CiAgICB9LAoKICAgIHRlcm5hcnk6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGVmdCA9IHRoaXMubG9naWNhbE9SKCk7CiAgICAgIHZhciBtaWRkbGU7CiAgICAgIHZhciB0b2tlbjsKICAgICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCc/JykpKSB7CiAgICAgICAgbWlkZGxlID0gdGhpcy50ZXJuYXJ5KCk7CiAgICAgICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCc6JykpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy50ZXJuYXJ5Rm4obGVmdCwgbWlkZGxlLCB0aGlzLnRlcm5hcnkoKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMudGhyb3dFcnJvcignZXhwZWN0ZWQgOicsIHRva2VuKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGxlZnQ7CiAgICAgIH0KICAgIH0sCgogICAgbG9naWNhbE9SOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGxlZnQgPSB0aGlzLmxvZ2ljYWxBTkQoKTsKICAgICAgdmFyIHRva2VuOwogICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnfHwnKSkpIHsKICAgICAgICAgIGxlZnQgPSB0aGlzLmJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCB0aGlzLmxvZ2ljYWxBTkQoKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBsZWZ0OwogICAgICAgIH0KICAgICAgfQogICAgfSwKCiAgICBsb2dpY2FsQU5EOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGxlZnQgPSB0aGlzLmVxdWFsaXR5KCk7CiAgICAgIHZhciB0b2tlbjsKICAgICAgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCcmJicpKSkgewogICAgICAgIGxlZnQgPSB0aGlzLmJpbmFyeUZuKGxlZnQsIHRva2VuLmZuLCB0aGlzLmxvZ2ljYWxBTkQoKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQ7CiAgICB9LAoKICAgIGVxdWFsaXR5OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGxlZnQgPSB0aGlzLnJlbGF0aW9uYWwoKTsKICAgICAgdmFyIHRva2VuOwogICAgICBpZiAoKHRva2VuID0gdGhpcy5leHBlY3QoJz09JywnIT0nLCc9PT0nLCchPT0nKSkpIHsKICAgICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy5lcXVhbGl0eSgpKTsKICAgICAgfQogICAgICByZXR1cm4gbGVmdDsKICAgIH0sCgogICAgcmVsYXRpb25hbDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsZWZ0ID0gdGhpcy5hZGRpdGl2ZSgpOwogICAgICB2YXIgdG9rZW47CiAgICAgIGlmICgodG9rZW4gPSB0aGlzLmV4cGVjdCgnPCcsICc+JywgJzw9JywgJz49JykpKSB7CiAgICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMucmVsYXRpb25hbCgpKTsKICAgICAgfQogICAgICByZXR1cm4gbGVmdDsKICAgIH0sCgogICAgYWRkaXRpdmU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGVmdCA9IHRoaXMubXVsdGlwbGljYXRpdmUoKTsKICAgICAgdmFyIHRva2VuOwogICAgICB3aGlsZSAoKHRva2VuID0gdGhpcy5leHBlY3QoJysnLCctJykpKSB7CiAgICAgICAgbGVmdCA9IHRoaXMuYmluYXJ5Rm4obGVmdCwgdG9rZW4uZm4sIHRoaXMubXVsdGlwbGljYXRpdmUoKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQ7CiAgICB9LAoKICAgIG11bHRpcGxpY2F0aXZlOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGxlZnQgPSB0aGlzLnVuYXJ5KCk7CiAgICAgIHZhciB0b2tlbjsKICAgICAgd2hpbGUgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCcqJywnLycsJyUnKSkpIHsKICAgICAgICBsZWZ0ID0gdGhpcy5iaW5hcnlGbihsZWZ0LCB0b2tlbi5mbiwgdGhpcy51bmFyeSgpKTsKICAgICAgfQogICAgICByZXR1cm4gbGVmdDsKICAgIH0sCgogICAgdW5hcnk6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdG9rZW47CiAgICAgIGlmICh0aGlzLmV4cGVjdCgnKycpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucHJpbWFyeSgpOwogICAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCctJykpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYmluYXJ5Rm4oUGFyc2VyLlpFUk8sIHRva2VuLmZuLCB0aGlzLnVuYXJ5KCkpOwogICAgICB9IGVsc2UgaWYgKCh0b2tlbiA9IHRoaXMuZXhwZWN0KCchJykpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5hcnlGbih0b2tlbi5mbiwgdGhpcy51bmFyeSgpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5wcmltYXJ5KCk7CiAgICAgIH0KICAgIH0sCgogICAgZmllbGRBY2Nlc3M6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICB2YXIgcGFyc2VyID0gdGhpczsKICAgICAgdmFyIGZpZWxkID0gdGhpcy5leHBlY3QoKS50ZXh0OwogICAgICB2YXIgZ2V0dGVyID0gZ2V0dGVyRm4oZmllbGQsIHRoaXMub3B0aW9ucywgdGhpcy50ZXh0KTsKCiAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oc2NvcGUsIGxvY2Fscywgc2VsZikgewogICAgICAgIHJldHVybiBnZXR0ZXIoc2VsZiB8fCBvYmplY3Qoc2NvcGUsIGxvY2FscykpOwogICAgICB9LCB7CiAgICAgICAgYXNzaWduOiBmdW5jdGlvbihzY29wZSwgdmFsdWUsIGxvY2FscykgewogICAgICAgICAgcmV0dXJuIHNldHRlcihvYmplY3Qoc2NvcGUsIGxvY2FscyksIGZpZWxkLCB2YWx1ZSwgcGFyc2VyLnRleHQsIHBhcnNlci5vcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICBvYmplY3RJbmRleDogZnVuY3Rpb24ob2JqKSB7CiAgICAgIHZhciBwYXJzZXIgPSB0aGlzOwoKICAgICAgdmFyIGluZGV4Rm4gPSB0aGlzLmV4cHJlc3Npb24oKTsKICAgICAgdGhpcy5jb25zdW1lKCddJyk7CgogICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICAgIHZhciBvID0gb2JqKHNlbGYsIGxvY2FscyksCiAgICAgICAgICBpID0gaW5kZXhGbihzZWxmLCBsb2NhbHMpLAogICAgICAgICAgdiwgcDsKCiAgICAgICAgaWYgKCFvKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIHYgPSBlbnN1cmVTYWZlT2JqZWN0KG9baV0sIHBhcnNlci50ZXh0KTsKICAgICAgICBpZiAodiAmJiB2LnRoZW4gJiYgcGFyc2VyLm9wdGlvbnMudW53cmFwUHJvbWlzZXMpIHsKICAgICAgICAgIHAgPSB2OwogICAgICAgICAgaWYgKCEoJyQkdicgaW4gdikpIHsKICAgICAgICAgICAgcC4kJHYgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHAudGhlbihmdW5jdGlvbih2YWwpIHsgcC4kJHYgPSB2YWw7IH0pOwogICAgICAgICAgfQogICAgICAgICAgdiA9IHYuJCR2OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdjsKICAgICAgfSwgewogICAgICAgIGFzc2lnbjogZnVuY3Rpb24oc2VsZiwgdmFsdWUsIGxvY2FscykgewogICAgICAgICAgdmFyIGtleSA9IGluZGV4Rm4oc2VsZiwgbG9jYWxzKTsKICAgICAgICAgIC8vIHByZXZlbnQgb3ZlcndyaXRpbmcgb2YgRnVuY3Rpb24uY29uc3RydWN0b3Igd2hpY2ggd291bGQgYnJlYWsgZW5zdXJlU2FmZU9iamVjdCBjaGVjawogICAgICAgICAgdmFyIHNhZmUgPSBlbnN1cmVTYWZlT2JqZWN0KG9iaihzZWxmLCBsb2NhbHMpLCBwYXJzZXIudGV4dCk7CiAgICAgICAgICByZXR1cm4gc2FmZVtrZXldID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgZnVuY3Rpb25DYWxsOiBmdW5jdGlvbihmbiwgY29udGV4dEdldHRlcikgewogICAgICB2YXIgYXJnc0ZuID0gW107CiAgICAgIGlmICh0aGlzLnBlZWtUb2tlbigpLnRleHQgIT09ICcpJykgewogICAgICAgIGRvIHsKICAgICAgICAgIGFyZ3NGbi5wdXNoKHRoaXMuZXhwcmVzc2lvbigpKTsKICAgICAgICB9IHdoaWxlICh0aGlzLmV4cGVjdCgnLCcpKTsKICAgICAgfQogICAgICB0aGlzLmNvbnN1bWUoJyknKTsKCiAgICAgIHZhciBwYXJzZXIgPSB0aGlzOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICB2YXIgYXJncyA9IFtdOwogICAgICAgIHZhciBjb250ZXh0ID0gY29udGV4dEdldHRlciA/IGNvbnRleHRHZXR0ZXIoc2NvcGUsIGxvY2FscykgOiBzY29wZTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzRm4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGFyZ3MucHVzaChhcmdzRm5baV0oc2NvcGUsIGxvY2FscykpOwogICAgICAgIH0KICAgICAgICB2YXIgZm5QdHIgPSBmbihzY29wZSwgbG9jYWxzLCBjb250ZXh0KSB8fCBub29wOwoKICAgICAgICBlbnN1cmVTYWZlT2JqZWN0KGNvbnRleHQsIHBhcnNlci50ZXh0KTsKICAgICAgICBlbnN1cmVTYWZlT2JqZWN0KGZuUHRyLCBwYXJzZXIudGV4dCk7CgogICAgICAgIC8vIElFIHN0dXBpZGl0eSEgKElFIGRvZXNuJ3QgaGF2ZSBhcHBseSBmb3Igc29tZSBuYXRpdmUgZnVuY3Rpb25zKQogICAgICAgIHZhciB2ID0gZm5QdHIuYXBwbHkKICAgICAgICAgID8gZm5QdHIuYXBwbHkoY29udGV4dCwgYXJncykKICAgICAgICAgIDogZm5QdHIoYXJnc1swXSwgYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXSwgYXJnc1s0XSk7CgogICAgICAgIHJldHVybiBlbnN1cmVTYWZlT2JqZWN0KHYsIHBhcnNlci50ZXh0KTsKICAgICAgfTsKICAgIH0sCgogICAgLy8gVGhpcyBpcyB1c2VkIHdpdGgganNvbiBhcnJheSBkZWNsYXJhdGlvbgogICAgYXJyYXlEZWNsYXJhdGlvbjogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZWxlbWVudEZucyA9IFtdOwogICAgICB2YXIgYWxsQ29uc3RhbnQgPSB0cnVlOwogICAgICBpZiAodGhpcy5wZWVrVG9rZW4oKS50ZXh0ICE9PSAnXScpIHsKICAgICAgICBkbyB7CiAgICAgICAgICBpZiAodGhpcy5wZWVrKCddJykpIHsKICAgICAgICAgICAgLy8gU3VwcG9ydCB0cmFpbGluZyBjb21tYXMgcGVyIEVTNS4xLgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbGVtZW50Rm4gPSB0aGlzLmV4cHJlc3Npb24oKTsKICAgICAgICAgIGVsZW1lbnRGbnMucHVzaChlbGVtZW50Rm4pOwogICAgICAgICAgaWYgKCFlbGVtZW50Rm4uY29uc3RhbnQpIHsKICAgICAgICAgICAgYWxsQ29uc3RhbnQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9IHdoaWxlICh0aGlzLmV4cGVjdCgnLCcpKTsKICAgICAgfQogICAgICB0aGlzLmNvbnN1bWUoJ10nKTsKCiAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24oc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgdmFyIGFycmF5ID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbGVtZW50Rm5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBhcnJheS5wdXNoKGVsZW1lbnRGbnNbaV0oc2VsZiwgbG9jYWxzKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfSwgewogICAgICAgIGxpdGVyYWw6IHRydWUsCiAgICAgICAgY29uc3RhbnQ6IGFsbENvbnN0YW50CiAgICAgIH0pOwogICAgfSwKCiAgICBvYmplY3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGtleVZhbHVlcyA9IFtdOwogICAgICB2YXIgYWxsQ29uc3RhbnQgPSB0cnVlOwogICAgICBpZiAodGhpcy5wZWVrVG9rZW4oKS50ZXh0ICE9PSAnfScpIHsKICAgICAgICBkbyB7CiAgICAgICAgICBpZiAodGhpcy5wZWVrKCd9JykpIHsKICAgICAgICAgICAgLy8gU3VwcG9ydCB0cmFpbGluZyBjb21tYXMgcGVyIEVTNS4xLgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0b2tlbiA9IHRoaXMuZXhwZWN0KCksCiAgICAgICAgICAgIGtleSA9IHRva2VuLnN0cmluZyB8fCB0b2tlbi50ZXh0OwogICAgICAgICAgdGhpcy5jb25zdW1lKCc6Jyk7CiAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLmV4cHJlc3Npb24oKTsKICAgICAgICAgIGtleVZhbHVlcy5wdXNoKHtrZXk6IGtleSwgdmFsdWU6IHZhbHVlfSk7CiAgICAgICAgICBpZiAoIXZhbHVlLmNvbnN0YW50KSB7CiAgICAgICAgICAgIGFsbENvbnN0YW50ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSB3aGlsZSAodGhpcy5leHBlY3QoJywnKSk7CiAgICAgIH0KICAgICAgdGhpcy5jb25zdW1lKCd9Jyk7CgogICAgICByZXR1cm4gZXh0ZW5kKGZ1bmN0aW9uKHNlbGYsIGxvY2FscykgewogICAgICAgIHZhciBvYmplY3QgPSB7fTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleVZhbHVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGtleVZhbHVlID0ga2V5VmFsdWVzW2ldOwogICAgICAgICAgb2JqZWN0W2tleVZhbHVlLmtleV0gPSBrZXlWYWx1ZS52YWx1ZShzZWxmLCBsb2NhbHMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICB9LCB7CiAgICAgICAgbGl0ZXJhbDogdHJ1ZSwKICAgICAgICBjb25zdGFudDogYWxsQ29uc3RhbnQKICAgICAgfSk7CiAgICB9CiAgfTsKCgovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwovLyBQYXJzZXIgaGVscGVyIGZ1bmN0aW9ucwovLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKICBmdW5jdGlvbiBzZXR0ZXIob2JqLCBwYXRoLCBzZXRWYWx1ZSwgZnVsbEV4cCwgb3B0aW9ucykgewogICAgLy9uZWVkZWQ/CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICB2YXIgZWxlbWVudCA9IHBhdGguc3BsaXQoJy4nKSwga2V5OwogICAgZm9yICh2YXIgaSA9IDA7IGVsZW1lbnQubGVuZ3RoID4gMTsgaSsrKSB7CiAgICAgIGtleSA9IGVuc3VyZVNhZmVNZW1iZXJOYW1lKGVsZW1lbnQuc2hpZnQoKSwgZnVsbEV4cCk7CiAgICAgIHZhciBwcm9wZXJ0eU9iaiA9IG9ialtrZXldOwogICAgICBpZiAoIXByb3BlcnR5T2JqKSB7CiAgICAgICAgcHJvcGVydHlPYmogPSB7fTsKICAgICAgICBvYmpba2V5XSA9IHByb3BlcnR5T2JqOwogICAgICB9CiAgICAgIG9iaiA9IHByb3BlcnR5T2JqOwogICAgICBpZiAob2JqLnRoZW4gJiYgb3B0aW9ucy51bndyYXBQcm9taXNlcykgewogICAgICAgIHByb21pc2VXYXJuaW5nKGZ1bGxFeHApOwogICAgICAgIGlmICghKCIkJHYiIGluIG9iaikpIHsKICAgICAgICAgIChmdW5jdGlvbihwcm9taXNlKSB7CiAgICAgICAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWwpIHsgcHJvbWlzZS4kJHYgPSB2YWw7IH0pOyB9CiAgICAgICAgICAgICkob2JqKTsKICAgICAgICB9CiAgICAgICAgaWYgKG9iai4kJHYgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgb2JqLiQkdiA9IHt9OwogICAgICAgIH0KICAgICAgICBvYmogPSBvYmouJCR2OwogICAgICB9CiAgICB9CiAgICBrZXkgPSBlbnN1cmVTYWZlTWVtYmVyTmFtZShlbGVtZW50LnNoaWZ0KCksIGZ1bGxFeHApOwogICAgb2JqW2tleV0gPSBzZXRWYWx1ZTsKICAgIHJldHVybiBzZXRWYWx1ZTsKICB9CgogIHZhciBnZXR0ZXJGbkNhY2hlID0ge307CgogIC8qKgogICAqIEltcGxlbWVudGF0aW9uIG9mIHRoZSAiQmxhY2sgSG9sZSIgdmFyaWFudCBmcm9tOgogICAqIC0gaHR0cDovL2pzcGVyZi5jb20vYW5ndWxhcmpzLXBhcnNlLWdldHRlci80CiAgICogLSBodHRwOi8vanNwZXJmLmNvbS9wYXRoLWV2YWx1YXRpb24tc2ltcGxpZmllZC83CiAgICovCiAgZnVuY3Rpb24gY3NwU2FmZUdldHRlckZuKGtleTAsIGtleTEsIGtleTIsIGtleTMsIGtleTQsIGZ1bGxFeHAsIG9wdGlvbnMpIHsKICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTAsIGZ1bGxFeHApOwogICAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MSwgZnVsbEV4cCk7CiAgICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXkyLCBmdWxsRXhwKTsKICAgIGVuc3VyZVNhZmVNZW1iZXJOYW1lKGtleTMsIGZ1bGxFeHApOwogICAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5NCwgZnVsbEV4cCk7CgogICAgcmV0dXJuICFvcHRpb25zLnVud3JhcFByb21pc2VzCiAgICAgID8gZnVuY3Rpb24gY3NwU2FmZUdldHRlcihzY29wZSwgbG9jYWxzKSB7CiAgICAgIHZhciBwYXRoVmFsID0gKGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5MCkpID8gbG9jYWxzIDogc2NvcGU7CgogICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gcGF0aFZhbDsKICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5MF07CgogICAgICBpZiAoIWtleTEpIHJldHVybiBwYXRoVmFsOwogICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXkxXTsKCiAgICAgIGlmICgha2V5MikgcmV0dXJuIHBhdGhWYWw7CiAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHBhdGhWYWwgPSBwYXRoVmFsW2tleTJdOwoKICAgICAgaWYgKCFrZXkzKSByZXR1cm4gcGF0aFZhbDsKICAgICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5M107CgogICAgICBpZiAoIWtleTQpIHJldHVybiBwYXRoVmFsOwogICAgICBpZiAocGF0aFZhbCA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICBwYXRoVmFsID0gcGF0aFZhbFtrZXk0XTsKCiAgICAgIHJldHVybiBwYXRoVmFsOwogICAgfQogICAgICA6IGZ1bmN0aW9uIGNzcFNhZmVQcm9taXNlRW5hYmxlZEdldHRlcihzY29wZSwgbG9jYWxzKSB7CiAgICAgIHZhciBwYXRoVmFsID0gKGxvY2FscyAmJiBsb2NhbHMuaGFzT3duUHJvcGVydHkoa2V5MCkpID8gbG9jYWxzIDogc2NvcGUsCiAgICAgICAgcHJvbWlzZTsKCiAgICAgIGlmIChwYXRoVmFsID09IG51bGwpIHJldHVybiBwYXRoVmFsOwoKICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5MF07CiAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgIHByb21pc2VXYXJuaW5nKGZ1bGxFeHApOwogICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgfQogICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsLiQkdjsKICAgICAgfQoKICAgICAgaWYgKCFrZXkxKSByZXR1cm4gcGF0aFZhbDsKICAgICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5MV07CiAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgIHByb21pc2VXYXJuaW5nKGZ1bGxFeHApOwogICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgfQogICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsLiQkdjsKICAgICAgfQoKICAgICAgaWYgKCFrZXkyKSByZXR1cm4gcGF0aFZhbDsKICAgICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5Ml07CiAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgIHByb21pc2VXYXJuaW5nKGZ1bGxFeHApOwogICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgfQogICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsLiQkdjsKICAgICAgfQoKICAgICAgaWYgKCFrZXkzKSByZXR1cm4gcGF0aFZhbDsKICAgICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5M107CiAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgIHByb21pc2VXYXJuaW5nKGZ1bGxFeHApOwogICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgfQogICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsLiQkdjsKICAgICAgfQoKICAgICAgaWYgKCFrZXk0KSByZXR1cm4gcGF0aFZhbDsKICAgICAgaWYgKHBhdGhWYWwgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgcGF0aFZhbCA9IHBhdGhWYWxba2V5NF07CiAgICAgIGlmIChwYXRoVmFsICYmIHBhdGhWYWwudGhlbikgewogICAgICAgIHByb21pc2VXYXJuaW5nKGZ1bGxFeHApOwogICAgICAgIGlmICghKCIkJHYiIGluIHBhdGhWYWwpKSB7CiAgICAgICAgICBwcm9taXNlID0gcGF0aFZhbDsKICAgICAgICAgIHByb21pc2UuJCR2ID0gdW5kZWZpbmVkOwogICAgICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbCkgeyBwcm9taXNlLiQkdiA9IHZhbDsgfSk7CiAgICAgICAgfQogICAgICAgIHBhdGhWYWwgPSBwYXRoVmFsLiQkdjsKICAgICAgfQogICAgICByZXR1cm4gcGF0aFZhbDsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBzaW1wbGVHZXR0ZXJGbjEoa2V5MCwgZnVsbEV4cCkgewogICAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MCwgZnVsbEV4cCk7CgogICAgcmV0dXJuIGZ1bmN0aW9uIHNpbXBsZUdldHRlckZuMShzY29wZSwgbG9jYWxzKSB7CiAgICAgIGlmIChzY29wZSA9PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICByZXR1cm4gKChsb2NhbHMgJiYgbG9jYWxzLmhhc093blByb3BlcnR5KGtleTApKSA/IGxvY2FscyA6IHNjb3BlKVtrZXkwXTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBzaW1wbGVHZXR0ZXJGbjIoa2V5MCwga2V5MSwgZnVsbEV4cCkgewogICAgZW5zdXJlU2FmZU1lbWJlck5hbWUoa2V5MCwgZnVsbEV4cCk7CiAgICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXkxLCBmdWxsRXhwKTsKCiAgICByZXR1cm4gZnVuY3Rpb24gc2ltcGxlR2V0dGVyRm4yKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgaWYgKHNjb3BlID09IG51bGwpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIHNjb3BlID0gKChsb2NhbHMgJiYgbG9jYWxzLmhhc093blByb3BlcnR5KGtleTApKSA/IGxvY2FscyA6IHNjb3BlKVtrZXkwXTsKICAgICAgcmV0dXJuIHNjb3BlID09IG51bGwgPyB1bmRlZmluZWQgOiBzY29wZVtrZXkxXTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBnZXR0ZXJGbihwYXRoLCBvcHRpb25zLCBmdWxsRXhwKSB7CiAgICAvLyBDaGVjayB3aGV0aGVyIHRoZSBjYWNoZSBoYXMgdGhpcyBnZXR0ZXIgYWxyZWFkeS4KICAgIC8vIFdlIGNhbiB1c2UgaGFzT3duUHJvcGVydHkgZGlyZWN0bHkgb24gdGhlIGNhY2hlIGJlY2F1c2Ugd2UgZW5zdXJlLAogICAgLy8gc2VlIGJlbG93LCB0aGF0IHRoZSBjYWNoZSBuZXZlciBzdG9yZXMgYSBwYXRoIGNhbGxlZCAnaGFzT3duUHJvcGVydHknCiAgICBpZiAoZ2V0dGVyRm5DYWNoZS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkgewogICAgICByZXR1cm4gZ2V0dGVyRm5DYWNoZVtwYXRoXTsKICAgIH0KCiAgICB2YXIgcGF0aEtleXMgPSBwYXRoLnNwbGl0KCcuJyksCiAgICAgIHBhdGhLZXlzTGVuZ3RoID0gcGF0aEtleXMubGVuZ3RoLAogICAgICBmbjsKCiAgICAvLyBXaGVuIHdlIGhhdmUgb25seSAxIG9yIDIgdG9rZW5zLCB1c2Ugb3B0aW1pemVkIHNwZWNpYWwgY2FzZSBjbG9zdXJlcy4KICAgIC8vIGh0dHA6Ly9qc3BlcmYuY29tL2FuZ3VsYXJqcy1wYXJzZS1nZXR0ZXIvNgogICAgaWYgKCFvcHRpb25zLnVud3JhcFByb21pc2VzICYmIHBhdGhLZXlzTGVuZ3RoID09PSAxKSB7CiAgICAgIGZuID0gc2ltcGxlR2V0dGVyRm4xKHBhdGhLZXlzWzBdLCBmdWxsRXhwKTsKICAgIH0gZWxzZSBpZiAoIW9wdGlvbnMudW53cmFwUHJvbWlzZXMgJiYgcGF0aEtleXNMZW5ndGggPT09IDIpIHsKICAgICAgZm4gPSBzaW1wbGVHZXR0ZXJGbjIocGF0aEtleXNbMF0sIHBhdGhLZXlzWzFdLCBmdWxsRXhwKTsKICAgIH0gZWxzZSBpZiAob3B0aW9ucy5jc3ApIHsKICAgICAgaWYgKHBhdGhLZXlzTGVuZ3RoIDwgNikgewogICAgICAgIGZuID0gY3NwU2FmZUdldHRlckZuKHBhdGhLZXlzWzBdLCBwYXRoS2V5c1sxXSwgcGF0aEtleXNbMl0sIHBhdGhLZXlzWzNdLCBwYXRoS2V5c1s0XSwgZnVsbEV4cCwKICAgICAgICAgIG9wdGlvbnMpOwogICAgICB9IGVsc2UgewogICAgICAgIGZuID0gZnVuY3Rpb24oc2NvcGUsIGxvY2FscykgewogICAgICAgICAgdmFyIGkgPSAwLCB2YWw7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhbCA9IGNzcFNhZmVHZXR0ZXJGbihwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLCBwYXRoS2V5c1tpKytdLAogICAgICAgICAgICAgIHBhdGhLZXlzW2krK10sIGZ1bGxFeHAsIG9wdGlvbnMpKHNjb3BlLCBsb2NhbHMpOwoKICAgICAgICAgICAgbG9jYWxzID0gdW5kZWZpbmVkOyAvLyBjbGVhciBhZnRlciBmaXJzdCBpdGVyYXRpb24KICAgICAgICAgICAgc2NvcGUgPSB2YWw7CiAgICAgICAgICB9IHdoaWxlIChpIDwgcGF0aEtleXNMZW5ndGgpOwogICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9OwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB2YXIgY29kZSA9ICd2YXIgcDtcbic7CiAgICAgIGZvckVhY2gocGF0aEtleXMsIGZ1bmN0aW9uKGtleSwgaW5kZXgpIHsKICAgICAgICBlbnN1cmVTYWZlTWVtYmVyTmFtZShrZXksIGZ1bGxFeHApOwogICAgICAgIGNvZGUgKz0gJ2lmKHMgPT0gbnVsbCkgcmV0dXJuIHVuZGVmaW5lZDtcbicgKwogICAgICAgICAgJ3M9JysgKGluZGV4CiAgICAgICAgICAvLyB3ZSBzaW1wbHkgZGVyZWZlcmVuY2UgJ3MnIG9uIGFueSAuZG90IG5vdGF0aW9uCiAgICAgICAgICA/ICdzJwogICAgICAgICAgLy8gYnV0IGlmIHdlIGFyZSBmaXJzdCB0aGVuIHdlIGNoZWNrIGxvY2FscyBmaXJzdCwgYW5kIGlmIHNvIHJlYWQgaXQgZmlyc3QKICAgICAgICAgIDogJygoayYmay5oYXNPd25Qcm9wZXJ0eSgiJyArIGtleSArICciKSk/azpzKScpICsgJ1siJyArIGtleSArICciXScgKyAnO1xuJyArCiAgICAgICAgICAob3B0aW9ucy51bndyYXBQcm9taXNlcwogICAgICAgICAgICA/ICdpZiAocyAmJiBzLnRoZW4pIHtcbicgKwogICAgICAgICAgICAnIHB3KCInICsgZnVsbEV4cC5yZXBsYWNlKC8oWyJcclxuXSkvZywgJ1xcJDEnKSArICciKTtcbicgKwogICAgICAgICAgICAnIGlmICghKCIkJHYiIGluIHMpKSB7XG4nICsKICAgICAgICAgICAgJyBwPXM7XG4nICsKICAgICAgICAgICAgJyBwLiQkdiA9IHVuZGVmaW5lZDtcbicgKwogICAgICAgICAgICAnIHAudGhlbihmdW5jdGlvbih2KSB7cC4kJHY9djt9KTtcbicgKwogICAgICAgICAgICAnfVxuJyArCiAgICAgICAgICAgICcgcz1zLiQkdlxuJyArCiAgICAgICAgICAgICd9XG4nCiAgICAgICAgICAgIDogJycpOwogICAgICB9KTsKICAgICAgY29kZSArPSAncmV0dXJuIHM7JzsKCiAgICAgIC8qIGpzaGludCAtVzA1NCAqLwogICAgICB2YXIgZXZhbGVkRm5HZXR0ZXIgPSBuZXcgRnVuY3Rpb24oJ3MnLCAnaycsICdwdycsIGNvZGUpOyAvLyBzPXNjb3BlLCBrPWxvY2FscywgcHc9cHJvbWlzZVdhcm5pbmcKICAgICAgLyoganNoaW50ICtXMDU0ICovCiAgICAgIGV2YWxlZEZuR2V0dGVyLnRvU3RyaW5nID0gdmFsdWVGbihjb2RlKTsKICAgICAgZm4gPSBvcHRpb25zLnVud3JhcFByb21pc2VzID8gZnVuY3Rpb24oc2NvcGUsIGxvY2FscykgewogICAgICAgIHJldHVybiBldmFsZWRGbkdldHRlcihzY29wZSwgbG9jYWxzLCBwcm9taXNlV2FybmluZyk7CiAgICAgIH0gOiBldmFsZWRGbkdldHRlcjsKICAgIH0KCiAgICAvLyBPbmx5IGNhY2hlIHRoZSB2YWx1ZSBpZiBpdCdzIG5vdCBnb2luZyB0byBtZXNzIHVwIHRoZSBjYWNoZSBvYmplY3QKICAgIC8vIFRoaXMgaXMgbW9yZSBwZXJmb3JtYW50IHRoYXQgdXNpbmcgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsCiAgICBpZiAocGF0aCAhPT0gJ2hhc093blByb3BlcnR5JykgewogICAgICBnZXR0ZXJGbkNhY2hlW3BhdGhdID0gZm47CiAgICB9CiAgICByZXR1cm4gZm47CiAgfQoKLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkcGFyc2UKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBDb252ZXJ0cyBBbmd1bGFyIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGludG8gYSBmdW5jdGlvbi4KICAgKgogICAqIGBgYGpzCiAgICogICB2YXIgZ2V0dGVyID0gJHBhcnNlKCd1c2VyLm5hbWUnKTsKICAgKiAgIHZhciBzZXR0ZXIgPSBnZXR0ZXIuYXNzaWduOwogICAqICAgdmFyIGNvbnRleHQgPSB7dXNlcjp7bmFtZTonYW5ndWxhcid9fTsKICAgKiAgIHZhciBsb2NhbHMgPSB7dXNlcjp7bmFtZTonbG9jYWwnfX07CiAgICoKICAgKiAgIGV4cGVjdChnZXR0ZXIoY29udGV4dCkpLnRvRXF1YWwoJ2FuZ3VsYXInKTsKICAgKiAgIHNldHRlcihjb250ZXh0LCAnbmV3VmFsdWUnKTsKICAgKiAgIGV4cGVjdChjb250ZXh0LnVzZXIubmFtZSkudG9FcXVhbCgnbmV3VmFsdWUnKTsKICAgKiAgIGV4cGVjdChnZXR0ZXIoY29udGV4dCwgbG9jYWxzKSkudG9FcXVhbCgnbG9jYWwnKTsKICAgKiBgYGAKICAgKgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAqCiAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgKiAgICAgIGBjb250ZXh0YC4KICAgKgogICAqICAgIFRoZSByZXR1cm5lZCBmdW5jdGlvbiBhbHNvIGhhcyB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICogICAgICAqIGBsaXRlcmFsYCDigJMgYHtib29sZWFufWAg4oCTIHdoZXRoZXIgdGhlIGV4cHJlc3Npb24ncyB0b3AtbGV2ZWwgbm9kZSBpcyBhIEphdmFTY3JpcHQKICAgKiAgICAgICAgbGl0ZXJhbC4KICAgKiAgICAgICogYGNvbnN0YW50YCDigJMgYHtib29sZWFufWAg4oCTIHdoZXRoZXIgdGhlIGV4cHJlc3Npb24gaXMgbWFkZSBlbnRpcmVseSBvZiBKYXZhU2NyaXB0CiAgICogICAgICAgIGNvbnN0YW50IGxpdGVyYWxzLgogICAqICAgICAgKiBgYXNzaWduYCDigJMgYHs/ZnVuY3Rpb24oY29udGV4dCwgdmFsdWUpfWAg4oCTIGlmIHRoZSBleHByZXNzaW9uIGlzIGFzc2lnbmFibGUsIHRoaXMgd2lsbCBiZQogICAqICAgICAgICBzZXQgdG8gYSBmdW5jdGlvbiB0byBjaGFuZ2UgaXRzIHZhbHVlIG9uIHRoZSBnaXZlbiBjb250ZXh0LgogICAqCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgcHJvdmlkZXIKICAgKiBAbmFtZSAkcGFyc2VQcm92aWRlcgogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBgJHBhcnNlUHJvdmlkZXJgIGNhbiBiZSB1c2VkIGZvciBjb25maWd1cmluZyB0aGUgZGVmYXVsdCBiZWhhdmlvciBvZiB0aGUge0BsaW5rIG5nLiRwYXJzZSAkcGFyc2V9CiAgICogIHNlcnZpY2UuCiAgICovCiAgZnVuY3Rpb24gJFBhcnNlUHJvdmlkZXIoKSB7CiAgICB2YXIgY2FjaGUgPSB7fTsKCiAgICB2YXIgJHBhcnNlT3B0aW9ucyA9IHsKICAgICAgY3NwOiBmYWxzZSwKICAgICAgdW53cmFwUHJvbWlzZXM6IGZhbHNlLAogICAgICBsb2dQcm9taXNlV2FybmluZ3M6IHRydWUKICAgIH07CgoKICAgIC8qKgogICAgICogQGRlcHJlY2F0ZWQgUHJvbWlzZSB1bndyYXBwaW5nIHZpYSAkcGFyc2UgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBmdXR1cmUuCiAgICAgKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHBhcnNlUHJvdmlkZXIjdW53cmFwUHJvbWlzZXMKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqICoqVGhpcyBmZWF0dXJlIGlzIGRlcHJlY2F0ZWQsIHNlZSBkZXByZWNhdGlvbiBub3RlcyBiZWxvdyBmb3IgbW9yZSBpbmZvKioKICAgICAqCiAgICAgKiBJZiBzZXQgdG8gdHJ1ZSAoZGVmYXVsdCBpcyBmYWxzZSksICRwYXJzZSB3aWxsIHVud3JhcCBwcm9taXNlcyBhdXRvbWF0aWNhbGx5IHdoZW4gYSBwcm9taXNlIGlzCiAgICAgKiBmb3VuZCBhdCBhbnkgcGFydCBvZiB0aGUgZXhwcmVzc2lvbi4gSW4gb3RoZXIgd29yZHMsIGlmIHNldCB0byB0cnVlLCB0aGUgZXhwcmVzc2lvbiB3aWxsIGFsd2F5cwogICAgICogcmVzdWx0IGluIGEgbm9uLXByb21pc2UgdmFsdWUuCiAgICAgKgogICAgICogV2hpbGUgdGhlIHByb21pc2UgaXMgdW5yZXNvbHZlZCwgaXQncyB0cmVhdGVkIGFzIHVuZGVmaW5lZCwgYnV0IG9uY2UgcmVzb2x2ZWQgYW5kIGZ1bGZpbGxlZCwKICAgICAqIHRoZSBmdWxmaWxsbWVudCB2YWx1ZSBpcyB1c2VkIGluIHBsYWNlIG9mIHRoZSBwcm9taXNlIHdoaWxlIGV2YWx1YXRpbmcgdGhlIGV4cHJlc3Npb24uCiAgICAgKgogICAgICogKipEZXByZWNhdGlvbiBub3RpY2UqKgogICAgICoKICAgICAqIFRoaXMgaXMgYSBmZWF0dXJlIHRoYXQgZGlkbid0IHByb3ZlIHRvIGJlIHdpbGRseSB1c2VmdWwgb3IgcG9wdWxhciwgcHJpbWFyaWx5IGJlY2F1c2Ugb2YgdGhlCiAgICAgKiBkaWNob3RvbXkgYmV0d2VlbiBkYXRhIGFjY2VzcyBpbiB0ZW1wbGF0ZXMgKGFjY2Vzc2VkIGFzIHJhdyB2YWx1ZXMpIGFuZCBjb250cm9sbGVyIGNvZGUKICAgICAqIChhY2Nlc3NlZCBhcyBwcm9taXNlcykuCiAgICAgKgogICAgICogSW4gbW9zdCBjb2RlIHdlIGVuZGVkIHVwIHJlc29sdmluZyBwcm9taXNlcyBtYW51YWxseSBpbiBjb250cm9sbGVycyBhbnl3YXkgYW5kIHRodXMgdW5pZnlpbmcKICAgICAqIHRoZSBtb2RlbCBhY2Nlc3MgdGhlcmUuCiAgICAgKgogICAgICogT3RoZXIgZG93bnNpZGVzIG9mIGF1dG9tYXRpYyBwcm9taXNlIHVud3JhcHBpbmc6CiAgICAgKgogICAgICogLSB3aGVuIGJ1aWxkaW5nIGNvbXBvbmVudHMgaXQncyBvZnRlbiBkZXNpcmFibGUgdG8gcmVjZWl2ZSB0aGUgcmF3IHByb21pc2VzCiAgICAgKiAtIGFkZHMgY29tcGxleGl0eSBhbmQgc2xvd3MgZG93biBleHByZXNzaW9uIGV2YWx1YXRpb24KICAgICAqIC0gbWFrZXMgZXhwcmVzc2lvbiBjb2RlIHByZS1nZW5lcmF0aW9uIHVuYXR0cmFjdGl2ZSBkdWUgdG8gdGhlIGFtb3VudCBvZiBjb2RlIHRoYXQgbmVlZHMgdG8gYmUKICAgICAqICAgZ2VuZXJhdGVkCiAgICAgKiAtIG1ha2VzIElERSBhdXRvLWNvbXBsZXRpb24gYW5kIHRvb2wgc3VwcG9ydCBoYXJkCiAgICAgKgogICAgICogKipXYXJuaW5nIExvZ3MqKgogICAgICoKICAgICAqIElmIHRoZSB1bndyYXBwaW5nIGlzIGVuYWJsZWQsIEFuZ3VsYXIgd2lsbCBsb2cgYSB3YXJuaW5nIGFib3V0IGVhY2ggZXhwcmVzc2lvbiB0aGF0IHVud3JhcHMgYQogICAgICogcHJvbWlzZSAodG8gcmVkdWNlIHRoZSBub2lzZSwgZWFjaCBleHByZXNzaW9uIGlzIGxvZ2dlZCBvbmx5IG9uY2UpLiBUbyBkaXNhYmxlIHRoaXMgbG9nZ2luZyB1c2UKICAgICAqIGAkcGFyc2VQcm92aWRlci5sb2dQcm9taXNlV2FybmluZ3MoZmFsc2UpYCBhcGkuCiAgICAgKgogICAgICoKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHZhbHVlIE5ldyB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufHNlbGZ9IFJldHVybnMgdGhlIGN1cnJlbnQgc2V0dGluZyB3aGVuIHVzZWQgYXMgZ2V0dGVyIGFuZCBzZWxmIGlmIHVzZWQgYXMKICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgIHNldHRlci4KICAgICAqLwogICAgdGhpcy51bndyYXBQcm9taXNlcyA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgJHBhcnNlT3B0aW9ucy51bndyYXBQcm9taXNlcyA9ICEhdmFsdWU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICRwYXJzZU9wdGlvbnMudW53cmFwUHJvbWlzZXM7CiAgICAgIH0KICAgIH07CgoKICAgIC8qKgogICAgICogQGRlcHJlY2F0ZWQgUHJvbWlzZSB1bndyYXBwaW5nIHZpYSAkcGFyc2UgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBmdXR1cmUuCiAgICAgKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHBhcnNlUHJvdmlkZXIjbG9nUHJvbWlzZVdhcm5pbmdzCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqCiAgICAgKiBDb250cm9scyB3aGV0aGVyIEFuZ3VsYXIgc2hvdWxkIGxvZyBhIHdhcm5pbmcgb24gYW55IGVuY291bnRlciBvZiBhIHByb21pc2UgaW4gYW4gZXhwcmVzc2lvbi4KICAgICAqCiAgICAgKiBUaGUgZGVmYXVsdCBpcyBzZXQgdG8gYHRydWVgLgogICAgICoKICAgICAqIFRoaXMgc2V0dGluZyBhcHBsaWVzIG9ubHkgaWYgYCRwYXJzZVByb3ZpZGVyLnVud3JhcFByb21pc2VzYCBzZXR0aW5nIGlzIHNldCB0byB0cnVlIGFzIHdlbGwuCiAgICAgKgogICAgICogQHBhcmFtIHtib29sZWFuPX0gdmFsdWUgTmV3IHZhbHVlLgogICAgICogQHJldHVybnMge2Jvb2xlYW58c2VsZn0gUmV0dXJucyB0aGUgY3VycmVudCBzZXR0aW5nIHdoZW4gdXNlZCBhcyBnZXR0ZXIgYW5kIHNlbGYgaWYgdXNlZCBhcwogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGVyLgogICAgICovCiAgICB0aGlzLmxvZ1Byb21pc2VXYXJuaW5ncyA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgJHBhcnNlT3B0aW9ucy5sb2dQcm9taXNlV2FybmluZ3MgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gJHBhcnNlT3B0aW9ucy5sb2dQcm9taXNlV2FybmluZ3M7CiAgICAgIH0KICAgIH07CgoKICAgIHRoaXMuJGdldCA9IFsnJGZpbHRlcicsICckc25pZmZlcicsICckbG9nJywgZnVuY3Rpb24oJGZpbHRlciwgJHNuaWZmZXIsICRsb2cpIHsKICAgICAgJHBhcnNlT3B0aW9ucy5jc3AgPSAkc25pZmZlci5jc3A7CgogICAgICBwcm9taXNlV2FybmluZyA9IGZ1bmN0aW9uIHByb21pc2VXYXJuaW5nRm4oZnVsbEV4cCkgewogICAgICAgIGlmICghJHBhcnNlT3B0aW9ucy5sb2dQcm9taXNlV2FybmluZ3MgfHwgcHJvbWlzZVdhcm5pbmdDYWNoZS5oYXNPd25Qcm9wZXJ0eShmdWxsRXhwKSkgcmV0dXJuOwogICAgICAgIHByb21pc2VXYXJuaW5nQ2FjaGVbZnVsbEV4cF0gPSB0cnVlOwogICAgICAgICRsb2cud2FybignWyRwYXJzZV0gUHJvbWlzZSBmb3VuZCBpbiB0aGUgZXhwcmVzc2lvbiBgJyArIGZ1bGxFeHAgKyAnYC4gJyArCiAgICAgICAgICAnQXV0b21hdGljIHVud3JhcHBpbmcgb2YgcHJvbWlzZXMgaW4gQW5ndWxhciBleHByZXNzaW9ucyBpcyBkZXByZWNhdGVkLicpOwogICAgICB9OwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV4cCkgewogICAgICAgIHZhciBwYXJzZWRFeHByZXNzaW9uOwoKICAgICAgICBzd2l0Y2ggKHR5cGVvZiBleHApIHsKICAgICAgICAgIGNhc2UgJ3N0cmluZyc6CgogICAgICAgICAgICBpZiAoY2FjaGUuaGFzT3duUHJvcGVydHkoZXhwKSkgewogICAgICAgICAgICAgIHJldHVybiBjYWNoZVtleHBdOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbGV4ZXIgPSBuZXcgTGV4ZXIoJHBhcnNlT3B0aW9ucyk7CiAgICAgICAgICAgIHZhciBwYXJzZXIgPSBuZXcgUGFyc2VyKGxleGVyLCAkZmlsdGVyLCAkcGFyc2VPcHRpb25zKTsKICAgICAgICAgICAgcGFyc2VkRXhwcmVzc2lvbiA9IHBhcnNlci5wYXJzZShleHApOwoKICAgICAgICAgICAgaWYgKGV4cCAhPT0gJ2hhc093blByb3BlcnR5JykgewogICAgICAgICAgICAgIC8vIE9ubHkgY2FjaGUgdGhlIHZhbHVlIGlmIGl0J3Mgbm90IGdvaW5nIHRvIG1lc3MgdXAgdGhlIGNhY2hlIG9iamVjdAogICAgICAgICAgICAgIC8vIFRoaXMgaXMgbW9yZSBwZXJmb3JtYW50IHRoYXQgdXNpbmcgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsCiAgICAgICAgICAgICAgY2FjaGVbZXhwXSA9IHBhcnNlZEV4cHJlc3Npb247CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBwYXJzZWRFeHByZXNzaW9uOwoKICAgICAgICAgIGNhc2UgJ2Z1bmN0aW9uJzoKICAgICAgICAgICAgcmV0dXJuIGV4cDsKCiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gbm9vcDsKICAgICAgICB9CiAgICAgIH07CiAgICB9XTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJHEKICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQSBwcm9taXNlL2RlZmVycmVkIGltcGxlbWVudGF0aW9uIGluc3BpcmVkIGJ5IFtLcmlzIEtvd2FsJ3MgUV0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xKS4KICAgKgogICAqIFtUaGUgQ29tbW9uSlMgUHJvbWlzZSBwcm9wb3NhbF0oaHR0cDovL3dpa2kuY29tbW9uanMub3JnL3dpa2kvUHJvbWlzZXMpIGRlc2NyaWJlcyBhIHByb21pc2UgYXMgYW4KICAgKiBpbnRlcmZhY2UgZm9yIGludGVyYWN0aW5nIHdpdGggYW4gb2JqZWN0IHRoYXQgcmVwcmVzZW50cyB0aGUgcmVzdWx0IG9mIGFuIGFjdGlvbiB0aGF0IGlzCiAgICogcGVyZm9ybWVkIGFzeW5jaHJvbm91c2x5LCBhbmQgbWF5IG9yIG1heSBub3QgYmUgZmluaXNoZWQgYXQgYW55IGdpdmVuIHBvaW50IGluIHRpbWUuCiAgICoKICAgKiBGcm9tIHRoZSBwZXJzcGVjdGl2ZSBvZiBkZWFsaW5nIHdpdGggZXJyb3IgaGFuZGxpbmcsIGRlZmVycmVkIGFuZCBwcm9taXNlIEFQSXMgYXJlIHRvCiAgICogYXN5bmNocm9ub3VzIHByb2dyYW1taW5nIHdoYXQgYHRyeWAsIGBjYXRjaGAgYW5kIGB0aHJvd2Aga2V5d29yZHMgYXJlIHRvIHN5bmNocm9ub3VzIHByb2dyYW1taW5nLgogICAqCiAgICogYGBganMKICAgKiAgIC8vIGZvciB0aGUgcHVycG9zZSBvZiB0aGlzIGV4YW1wbGUgbGV0J3MgYXNzdW1lIHRoYXQgdmFyaWFibGVzIGAkcWAsIGBzY29wZWAgYW5kIGBva1RvR3JlZXRgCiAgICogICAvLyBhcmUgYXZhaWxhYmxlIGluIHRoZSBjdXJyZW50IGxleGljYWwgc2NvcGUgKHRoZXkgY291bGQgaGF2ZSBiZWVuIGluamVjdGVkIG9yIHBhc3NlZCBpbikuCiAgICoKICAgKiAgIGZ1bmN0aW9uIGFzeW5jR3JlZXQobmFtZSkgewogKiAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTsKICoKICogICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAqICAgICAgIC8vIHNpbmNlIHRoaXMgZm4gZXhlY3V0ZXMgYXN5bmMgaW4gYSBmdXR1cmUgdHVybiBvZiB0aGUgZXZlbnQgbG9vcCwgd2UgbmVlZCB0byB3cmFwCiAqICAgICAgIC8vIG91ciBjb2RlIGludG8gYW4gJGFwcGx5IGNhbGwgc28gdGhhdCB0aGUgbW9kZWwgY2hhbmdlcyBhcmUgcHJvcGVybHkgb2JzZXJ2ZWQuCiAqICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICogICAgICAgICBkZWZlcnJlZC5ub3RpZnkoJ0Fib3V0IHRvIGdyZWV0ICcgKyBuYW1lICsgJy4nKTsKICoKICogICAgICAgICBpZiAob2tUb0dyZWV0KG5hbWUpKSB7CiAqICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKCdIZWxsbywgJyArIG5hbWUgKyAnIScpOwogKiAgICAgICAgIH0gZWxzZSB7CiAqICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoJ0dyZWV0aW5nICcgKyBuYW1lICsgJyBpcyBub3QgYWxsb3dlZC4nKTsKICogICAgICAgICB9CiAqICAgICAgIH0pOwogKiAgICAgfSwgMTAwMCk7CiAqCiAqICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTsKICogICB9CiAgICoKICAgKiAgIHZhciBwcm9taXNlID0gYXN5bmNHcmVldCgnUm9iaW4gSG9vZCcpOwogICAqICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAqICAgICBhbGVydCgnU3VjY2VzczogJyArIGdyZWV0aW5nKTsKICogICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICogICAgIGFsZXJ0KCdGYWlsZWQ6ICcgKyByZWFzb24pOwogKiAgIH0sIGZ1bmN0aW9uKHVwZGF0ZSkgewogKiAgICAgYWxlcnQoJ0dvdCBub3RpZmljYXRpb246ICcgKyB1cGRhdGUpOwogKiAgIH0pOwogICAqIGBgYAogICAqCiAgICogQXQgZmlyc3QgaXQgbWlnaHQgbm90IGJlIG9idmlvdXMgd2h5IHRoaXMgZXh0cmEgY29tcGxleGl0eSBpcyB3b3J0aCB0aGUgdHJvdWJsZS4gVGhlIHBheW9mZgogICAqIGNvbWVzIGluIHRoZSB3YXkgb2YgZ3VhcmFudGVlcyB0aGF0IHByb21pc2UgYW5kIGRlZmVycmVkIEFQSXMgbWFrZSwgc2VlCiAgICogaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC91bmNvbW1vbmpzL2Jsb2IvbWFzdGVyL3Byb21pc2VzL3NwZWNpZmljYXRpb24ubWQuCiAgICoKICAgKiBBZGRpdGlvbmFsbHkgdGhlIHByb21pc2UgYXBpIGFsbG93cyBmb3IgY29tcG9zaXRpb24gdGhhdCBpcyB2ZXJ5IGhhcmQgdG8gZG8gd2l0aCB0aGUKICAgKiB0cmFkaXRpb25hbCBjYWxsYmFjayAoW0NQU10oaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Db250aW51YXRpb24tcGFzc2luZ19zdHlsZSkpIGFwcHJvYWNoLgogICAqIEZvciBtb3JlIG9uIHRoaXMgcGxlYXNlIHNlZSB0aGUgW1EgZG9jdW1lbnRhdGlvbl0oaHR0cHM6Ly9naXRodWIuY29tL2tyaXNrb3dhbC9xKSBlc3BlY2lhbGx5IHRoZQogICAqIHNlY3Rpb24gb24gc2VyaWFsIG9yIHBhcmFsbGVsIGpvaW5pbmcgb2YgcHJvbWlzZXMuCiAgICoKICAgKgogICAqICMgVGhlIERlZmVycmVkIEFQSQogICAqCiAgICogQSBuZXcgaW5zdGFuY2Ugb2YgZGVmZXJyZWQgaXMgY29uc3RydWN0ZWQgYnkgY2FsbGluZyBgJHEuZGVmZXIoKWAuCiAgICoKICAgKiBUaGUgcHVycG9zZSBvZiB0aGUgZGVmZXJyZWQgb2JqZWN0IGlzIHRvIGV4cG9zZSB0aGUgYXNzb2NpYXRlZCBQcm9taXNlIGluc3RhbmNlIGFzIHdlbGwgYXMgQVBJcwogICAqIHRoYXQgY2FuIGJlIHVzZWQgZm9yIHNpZ25hbGluZyB0aGUgc3VjY2Vzc2Z1bCBvciB1bnN1Y2Nlc3NmdWwgY29tcGxldGlvbiwgYXMgd2VsbCBhcyB0aGUgc3RhdHVzCiAgICogb2YgdGhlIHRhc2suCiAgICoKICAgKiAqKk1ldGhvZHMqKgogICAqCiAgICogLSBgcmVzb2x2ZSh2YWx1ZSlgIOKAkyByZXNvbHZlcyB0aGUgZGVyaXZlZCBwcm9taXNlIHdpdGggdGhlIGB2YWx1ZWAuIElmIHRoZSB2YWx1ZSBpcyBhIHJlamVjdGlvbgogICAqICAgY29uc3RydWN0ZWQgdmlhIGAkcS5yZWplY3RgLCB0aGUgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkIGluc3RlYWQuCiAgICogLSBgcmVqZWN0KHJlYXNvbilgIOKAkyByZWplY3RzIHRoZSBkZXJpdmVkIHByb21pc2Ugd2l0aCB0aGUgYHJlYXNvbmAuIFRoaXMgaXMgZXF1aXZhbGVudCB0bwogICAqICAgcmVzb2x2aW5nIGl0IHdpdGggYSByZWplY3Rpb24gY29uc3RydWN0ZWQgdmlhIGAkcS5yZWplY3RgLgogICAqIC0gYG5vdGlmeSh2YWx1ZSlgIC0gcHJvdmlkZXMgdXBkYXRlcyBvbiB0aGUgc3RhdHVzIG9mIHRoZSBwcm9taXNlJ3MgZXhlY3V0aW9uLiBUaGlzIG1heSBiZSBjYWxsZWQKICAgKiAgIG11bHRpcGxlIHRpbWVzIGJlZm9yZSB0aGUgcHJvbWlzZSBpcyBlaXRoZXIgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQuCiAgICoKICAgKiAqKlByb3BlcnRpZXMqKgogICAqCiAgICogLSBwcm9taXNlIOKAkyBge1Byb21pc2V9YCDigJMgcHJvbWlzZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoaXMgZGVmZXJyZWQuCiAgICoKICAgKgogICAqICMgVGhlIFByb21pc2UgQVBJCiAgICoKICAgKiBBIG5ldyBwcm9taXNlIGluc3RhbmNlIGlzIGNyZWF0ZWQgd2hlbiBhIGRlZmVycmVkIGluc3RhbmNlIGlzIGNyZWF0ZWQgYW5kIGNhbiBiZSByZXRyaWV2ZWQgYnkKICAgKiBjYWxsaW5nIGBkZWZlcnJlZC5wcm9taXNlYC4KICAgKgogICAqIFRoZSBwdXJwb3NlIG9mIHRoZSBwcm9taXNlIG9iamVjdCBpcyB0byBhbGxvdyBmb3IgaW50ZXJlc3RlZCBwYXJ0aWVzIHRvIGdldCBhY2Nlc3MgdG8gdGhlIHJlc3VsdAogICAqIG9mIHRoZSBkZWZlcnJlZCB0YXNrIHdoZW4gaXQgY29tcGxldGVzLgogICAqCiAgICogKipNZXRob2RzKioKICAgKgogICAqIC0gYHRoZW4oc3VjY2Vzc0NhbGxiYWNrLCBlcnJvckNhbGxiYWNrLCBub3RpZnlDYWxsYmFjaylgIOKAkyByZWdhcmRsZXNzIG9mIHdoZW4gdGhlIHByb21pc2Ugd2FzIG9yCiAgICogICB3aWxsIGJlIHJlc29sdmVkIG9yIHJlamVjdGVkLCBgdGhlbmAgY2FsbHMgb25lIG9mIHRoZSBzdWNjZXNzIG9yIGVycm9yIGNhbGxiYWNrcyBhc3luY2hyb25vdXNseQogICAqICAgYXMgc29vbiBhcyB0aGUgcmVzdWx0IGlzIGF2YWlsYWJsZS4gVGhlIGNhbGxiYWNrcyBhcmUgY2FsbGVkIHdpdGggYSBzaW5nbGUgYXJndW1lbnQ6IHRoZSByZXN1bHQKICAgKiAgIG9yIHJlamVjdGlvbiByZWFzb24uIEFkZGl0aW9uYWxseSwgdGhlIG5vdGlmeSBjYWxsYmFjayBtYXkgYmUgY2FsbGVkIHplcm8gb3IgbW9yZSB0aW1lcyB0bwogICAqICAgcHJvdmlkZSBhIHByb2dyZXNzIGluZGljYXRpb24sIGJlZm9yZSB0aGUgcHJvbWlzZSBpcyByZXNvbHZlZCBvciByZWplY3RlZC4KICAgKgogICAqICAgVGhpcyBtZXRob2QgKnJldHVybnMgYSBuZXcgcHJvbWlzZSogd2hpY2ggaXMgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQgdmlhIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlCiAgICogICBgc3VjY2Vzc0NhbGxiYWNrYCwgYGVycm9yQ2FsbGJhY2tgLiBJdCBhbHNvIG5vdGlmaWVzIHZpYSB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZQogICAqICAgYG5vdGlmeUNhbGxiYWNrYCBtZXRob2QuIFRoZSBwcm9taXNlIGNhbiBub3QgYmUgcmVzb2x2ZWQgb3IgcmVqZWN0ZWQgZnJvbSB0aGUgbm90aWZ5Q2FsbGJhY2sKICAgKiAgIG1ldGhvZC4KICAgKgogICAqIC0gYGNhdGNoKGVycm9yQ2FsbGJhY2spYCDigJMgc2hvcnRoYW5kIGZvciBgcHJvbWlzZS50aGVuKG51bGwsIGVycm9yQ2FsbGJhY2spYAogICAqCiAgICogLSBgZmluYWxseShjYWxsYmFjaylgIOKAkyBhbGxvd3MgeW91IHRvIG9ic2VydmUgZWl0aGVyIHRoZSBmdWxmaWxsbWVudCBvciByZWplY3Rpb24gb2YgYSBwcm9taXNlLAogICAqICAgYnV0IHRvIGRvIHNvIHdpdGhvdXQgbW9kaWZ5aW5nIHRoZSBmaW5hbCB2YWx1ZS4gVGhpcyBpcyB1c2VmdWwgdG8gcmVsZWFzZSByZXNvdXJjZXMgb3IgZG8gc29tZQogICAqICAgY2xlYW4tdXAgdGhhdCBuZWVkcyB0byBiZSBkb25lIHdoZXRoZXIgdGhlIHByb21pc2Ugd2FzIHJlamVjdGVkIG9yIHJlc29sdmVkLiBTZWUgdGhlIFtmdWxsCiAgICogICBzcGVjaWZpY2F0aW9uXShodHRwczovL2dpdGh1Yi5jb20va3Jpc2tvd2FsL3Evd2lraS9BUEktUmVmZXJlbmNlI3Byb21pc2VmaW5hbGx5Y2FsbGJhY2spIGZvcgogICAqICAgbW9yZSBpbmZvcm1hdGlvbi4KICAgKgogICAqICAgQmVjYXVzZSBgZmluYWxseWAgaXMgYSByZXNlcnZlZCB3b3JkIGluIEphdmFTY3JpcHQgYW5kIHJlc2VydmVkIGtleXdvcmRzIGFyZSBub3Qgc3VwcG9ydGVkIGFzCiAgICogICBwcm9wZXJ0eSBuYW1lcyBieSBFUzMsIHlvdSdsbCBuZWVkIHRvIGludm9rZSB0aGUgbWV0aG9kIGxpa2UgYHByb21pc2VbJ2ZpbmFsbHknXShjYWxsYmFjaylgIHRvCiAgICogICBtYWtlIHlvdXIgY29kZSBJRTggYW5kIEFuZHJvaWQgMi54IGNvbXBhdGlibGUuCiAgICoKICAgKiAjIENoYWluaW5nIHByb21pc2VzCiAgICoKICAgKiBCZWNhdXNlIGNhbGxpbmcgdGhlIGB0aGVuYCBtZXRob2Qgb2YgYSBwcm9taXNlIHJldHVybnMgYSBuZXcgZGVyaXZlZCBwcm9taXNlLCBpdCBpcyBlYXNpbHkKICAgKiBwb3NzaWJsZSB0byBjcmVhdGUgYSBjaGFpbiBvZiBwcm9taXNlczoKICAgKgogICAqIGBgYGpzCiAgICogICBwcm9taXNlQiA9IHByb21pc2VBLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CiAqICAgICByZXR1cm4gcmVzdWx0ICsgMTsKICogICB9KTsKICAgKgogICAqICAgLy8gcHJvbWlzZUIgd2lsbCBiZSByZXNvbHZlZCBpbW1lZGlhdGVseSBhZnRlciBwcm9taXNlQSBpcyByZXNvbHZlZCBhbmQgaXRzIHZhbHVlCiAgICogICAvLyB3aWxsIGJlIHRoZSByZXN1bHQgb2YgcHJvbWlzZUEgaW5jcmVtZW50ZWQgYnkgMQogICAqIGBgYAogICAqCiAgICogSXQgaXMgcG9zc2libGUgdG8gY3JlYXRlIGNoYWlucyBvZiBhbnkgbGVuZ3RoIGFuZCBzaW5jZSBhIHByb21pc2UgY2FuIGJlIHJlc29sdmVkIHdpdGggYW5vdGhlcgogICAqIHByb21pc2UgKHdoaWNoIHdpbGwgZGVmZXIgaXRzIHJlc29sdXRpb24gZnVydGhlciksIGl0IGlzIHBvc3NpYmxlIHRvIHBhdXNlL2RlZmVyIHJlc29sdXRpb24gb2YKICAgKiB0aGUgcHJvbWlzZXMgYXQgYW55IHBvaW50IGluIHRoZSBjaGFpbi4gVGhpcyBtYWtlcyBpdCBwb3NzaWJsZSB0byBpbXBsZW1lbnQgcG93ZXJmdWwgQVBJcyBsaWtlCiAgICogJGh0dHAncyByZXNwb25zZSBpbnRlcmNlcHRvcnMuCiAgICoKICAgKgogICAqICMgRGlmZmVyZW5jZXMgYmV0d2VlbiBLcmlzIEtvd2FsJ3MgUSBhbmQgJHEKICAgKgogICAqICBUaGVyZSBhcmUgdHdvIG1haW4gZGlmZmVyZW5jZXM6CiAgICoKICAgKiAtICRxIGlzIGludGVncmF0ZWQgd2l0aCB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGV9IFNjb3BlIG1vZGVsIG9ic2VydmF0aW9uCiAgICogICBtZWNoYW5pc20gaW4gYW5ndWxhciwgd2hpY2ggbWVhbnMgZmFzdGVyIHByb3BhZ2F0aW9uIG9mIHJlc29sdXRpb24gb3IgcmVqZWN0aW9uIGludG8geW91cgogICAqICAgbW9kZWxzIGFuZCBhdm9pZGluZyB1bm5lY2Vzc2FyeSBicm93c2VyIHJlcGFpbnRzLCB3aGljaCB3b3VsZCByZXN1bHQgaW4gZmxpY2tlcmluZyBVSS4KICAgKiAtIFEgaGFzIG1hbnkgbW9yZSBmZWF0dXJlcyB0aGFuICRxLCBidXQgdGhhdCBjb21lcyBhdCBhIGNvc3Qgb2YgYnl0ZXMuICRxIGlzIHRpbnksIGJ1dCBjb250YWlucwogICAqICAgYWxsIHRoZSBpbXBvcnRhbnQgZnVuY3Rpb25hbGl0eSBuZWVkZWQgZm9yIGNvbW1vbiBhc3luYyB0YXNrcy4KICAgKgogICAqICAjIFRlc3RpbmcKICAgKgogICAqICBgYGBqcwogICAqICAgIGl0KCdzaG91bGQgc2ltdWxhdGUgcHJvbWlzZScsIGluamVjdChmdW5jdGlvbigkcSwgJHJvb3RTY29wZSkgewogKiAgICAgIHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7CiAqICAgICAgdmFyIHByb21pc2UgPSBkZWZlcnJlZC5wcm9taXNlOwogKiAgICAgIHZhciByZXNvbHZlZFZhbHVlOwogKgogKiAgICAgIHByb21pc2UudGhlbihmdW5jdGlvbih2YWx1ZSkgeyByZXNvbHZlZFZhbHVlID0gdmFsdWU7IH0pOwogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0JlVW5kZWZpbmVkKCk7CiAqCiAqICAgICAgLy8gU2ltdWxhdGUgcmVzb2x2aW5nIG9mIHByb21pc2UKICogICAgICBkZWZlcnJlZC5yZXNvbHZlKDEyMyk7CiAqICAgICAgLy8gTm90ZSB0aGF0IHRoZSAndGhlbicgZnVuY3Rpb24gZG9lcyBub3QgZ2V0IGNhbGxlZCBzeW5jaHJvbm91c2x5LgogKiAgICAgIC8vIFRoaXMgaXMgYmVjYXVzZSB3ZSB3YW50IHRoZSBwcm9taXNlIEFQSSB0byBhbHdheXMgYmUgYXN5bmMsIHdoZXRoZXIgb3Igbm90CiAqICAgICAgLy8gaXQgZ290IGNhbGxlZCBzeW5jaHJvbm91c2x5IG9yIGFzeW5jaHJvbm91c2x5LgogKiAgICAgIGV4cGVjdChyZXNvbHZlZFZhbHVlKS50b0JlVW5kZWZpbmVkKCk7CiAqCiAqICAgICAgLy8gUHJvcGFnYXRlIHByb21pc2UgcmVzb2x1dGlvbiB0byAndGhlbicgZnVuY3Rpb25zIHVzaW5nICRhcHBseSgpLgogKiAgICAgICRyb290U2NvcGUuJGFwcGx5KCk7CiAqICAgICAgZXhwZWN0KHJlc29sdmVkVmFsdWUpLnRvRXF1YWwoMTIzKTsKICogICAgfSkpOwogICAqICBgYGAKICAgKi8KICBmdW5jdGlvbiAkUVByb3ZpZGVyKCkgewoKICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckZXhjZXB0aW9uSGFuZGxlcicsIGZ1bmN0aW9uKCRyb290U2NvcGUsICRleGNlcHRpb25IYW5kbGVyKSB7CiAgICAgIHJldHVybiBxRmFjdG9yeShmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhjYWxsYmFjayk7CiAgICAgIH0sICRleGNlcHRpb25IYW5kbGVyKTsKICAgIH1dOwogIH0KCgogIC8qKgogICAqIENvbnN0cnVjdHMgYSBwcm9taXNlIG1hbmFnZXIuCiAgICoKICAgKiBAcGFyYW0ge2Z1bmN0aW9uKEZ1bmN0aW9uKX0gbmV4dFRpY2sgRnVuY3Rpb24gZm9yIGV4ZWN1dGluZyBmdW5jdGlvbnMgaW4gdGhlIG5leHQgdHVybi4KICAgKiBAcGFyYW0ge2Z1bmN0aW9uKC4uLiopfSBleGNlcHRpb25IYW5kbGVyIEZ1bmN0aW9uIGludG8gd2hpY2ggdW5leHBlY3RlZCBleGNlcHRpb25zIGFyZSBwYXNzZWQgZm9yCiAgICogICAgIGRlYnVnZ2luZyBwdXJwb3Nlcy4KICAgKiBAcmV0dXJucyB7b2JqZWN0fSBQcm9taXNlIG1hbmFnZXIuCiAgICovCiAgZnVuY3Rpb24gcUZhY3RvcnkobmV4dFRpY2ssIGV4Y2VwdGlvbkhhbmRsZXIpIHsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRxI2RlZmVyCiAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQ3JlYXRlcyBhIGBEZWZlcnJlZGAgb2JqZWN0IHdoaWNoIHJlcHJlc2VudHMgYSB0YXNrIHdoaWNoIHdpbGwgZmluaXNoIGluIHRoZSBmdXR1cmUuCiAgICAgKgogICAgICogQHJldHVybnMge0RlZmVycmVkfSBSZXR1cm5zIGEgbmV3IGluc3RhbmNlIG9mIGRlZmVycmVkLgogICAgICovCiAgICB2YXIgZGVmZXIgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHBlbmRpbmcgPSBbXSwKICAgICAgICB2YWx1ZSwgZGVmZXJyZWQ7CgogICAgICBkZWZlcnJlZCA9IHsKCiAgICAgICAgcmVzb2x2ZTogZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICBpZiAocGVuZGluZykgewogICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gcGVuZGluZzsKICAgICAgICAgICAgcGVuZGluZyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdmFsdWUgPSByZWYodmFsKTsKCiAgICAgICAgICAgIGlmIChjYWxsYmFja3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2s7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBjYWxsYmFja3MubGVuZ3RoOyBpIDwgaWk7IGkrKykgewogICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrc1tpXTsKICAgICAgICAgICAgICAgICAgdmFsdWUudGhlbihjYWxsYmFja1swXSwgY2FsbGJhY2tbMV0sIGNhbGxiYWNrWzJdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCgoKICAgICAgICByZWplY3Q6IGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShjcmVhdGVJbnRlcm5hbFJlamVjdGVkUHJvbWlzZShyZWFzb24pKTsKICAgICAgICB9LAoKCiAgICAgICAgbm90aWZ5OiBmdW5jdGlvbihwcm9ncmVzcykgewogICAgICAgICAgaWYgKHBlbmRpbmcpIHsKICAgICAgICAgICAgdmFyIGNhbGxiYWNrcyA9IHBlbmRpbmc7CgogICAgICAgICAgICBpZiAocGVuZGluZy5sZW5ndGgpIHsKICAgICAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjazsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpaSA9IGNhbGxiYWNrcy5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2tzW2ldOwogICAgICAgICAgICAgICAgICBjYWxsYmFja1syXShwcm9ncmVzcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAoKCiAgICAgICAgcHJvbWlzZTogewogICAgICAgICAgdGhlbjogZnVuY3Rpb24oY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzYmFjaykgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKCiAgICAgICAgICAgIHZhciB3cmFwcGVkQ2FsbGJhY2sgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoaXNGdW5jdGlvbihjYWxsYmFjaykgPyBjYWxsYmFjayA6IGRlZmF1bHRDYWxsYmFjaykodmFsdWUpKTsKICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5yZWplY3QoZSk7CiAgICAgICAgICAgICAgICBleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciB3cmFwcGVkRXJyYmFjayA9IGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoaXNGdW5jdGlvbihlcnJiYWNrKSA/IGVycmJhY2sgOiBkZWZhdWx0RXJyYmFjaykocmVhc29uKSk7CiAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICByZXN1bHQucmVqZWN0KGUpOwogICAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgd3JhcHBlZFByb2dyZXNzYmFjayA9IGZ1bmN0aW9uKHByb2dyZXNzKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJlc3VsdC5ub3RpZnkoKGlzRnVuY3Rpb24ocHJvZ3Jlc3NiYWNrKSA/IHByb2dyZXNzYmFjayA6IGRlZmF1bHRDYWxsYmFjaykocHJvZ3Jlc3MpKTsKICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKHBlbmRpbmcpIHsKICAgICAgICAgICAgICBwZW5kaW5nLnB1c2goW3dyYXBwZWRDYWxsYmFjaywgd3JhcHBlZEVycmJhY2ssIHdyYXBwZWRQcm9ncmVzc2JhY2tdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YWx1ZS50aGVuKHdyYXBwZWRDYWxsYmFjaywgd3JhcHBlZEVycmJhY2ssIHdyYXBwZWRQcm9ncmVzc2JhY2spOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgICB9LAoKICAgICAgICAgICJjYXRjaCI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRoZW4obnVsbCwgY2FsbGJhY2spOwogICAgICAgICAgfSwKCiAgICAgICAgICAiZmluYWxseSI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgogICAgICAgICAgICBmdW5jdGlvbiBtYWtlUHJvbWlzZSh2YWx1ZSwgcmVzb2x2ZWQpIHsKICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKTsKICAgICAgICAgICAgICBpZiAocmVzb2x2ZWQpIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKHZhbHVlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzdWx0LnJlamVjdCh2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlQ2FsbGJhY2sodmFsdWUsIGlzUmVzb2x2ZWQpIHsKICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tPdXRwdXQgPSBudWxsOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja091dHB1dCA9IChjYWxsYmFjayB8fGRlZmF1bHRDYWxsYmFjaykoKTsKICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYWtlUHJvbWlzZShlLCBmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjYWxsYmFja091dHB1dCAmJiBpc0Z1bmN0aW9uKGNhbGxiYWNrT3V0cHV0LnRoZW4pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tPdXRwdXQudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ha2VQcm9taXNlKHZhbHVlLCBpc1Jlc29sdmVkKTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBtYWtlUHJvbWlzZShlcnJvciwgZmFsc2UpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBtYWtlUHJvbWlzZSh2YWx1ZSwgaXNSZXNvbHZlZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpcy50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUNhbGxiYWNrKHZhbHVlLCB0cnVlKTsKICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IpIHsKICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlQ2FsbGJhY2soZXJyb3IsIGZhbHNlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwoKICAgICAgcmV0dXJuIGRlZmVycmVkOwogICAgfTsKCgogICAgdmFyIHJlZiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSAmJiBpc0Z1bmN0aW9uKHZhbHVlLnRoZW4pKSByZXR1cm4gdmFsdWU7CiAgICAgIHJldHVybiB7CiAgICAgICAgdGhlbjogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHZhciByZXN1bHQgPSBkZWZlcigpOwogICAgICAgICAgbmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJlc3VsdC5yZXNvbHZlKGNhbGxiYWNrKHZhbHVlKSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiByZXN1bHQucHJvbWlzZTsKICAgICAgICB9CiAgICAgIH07CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRxI3JlamVjdAogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSBwcm9taXNlIHRoYXQgaXMgcmVzb2x2ZWQgYXMgcmVqZWN0ZWQgd2l0aCB0aGUgc3BlY2lmaWVkIGByZWFzb25gLiBUaGlzIGFwaSBzaG91bGQgYmUKICAgICAqIHVzZWQgdG8gZm9yd2FyZCByZWplY3Rpb24gaW4gYSBjaGFpbiBvZiBwcm9taXNlcy4gSWYgeW91IGFyZSBkZWFsaW5nIHdpdGggdGhlIGxhc3QgcHJvbWlzZSBpbgogICAgICogYSBwcm9taXNlIGNoYWluLCB5b3UgZG9uJ3QgbmVlZCB0byB3b3JyeSBhYm91dCBpdC4KICAgICAqCiAgICAgKiBXaGVuIGNvbXBhcmluZyBkZWZlcnJlZHMvcHJvbWlzZXMgdG8gdGhlIGZhbWlsaWFyIGJlaGF2aW9yIG9mIHRyeS9jYXRjaC90aHJvdywgdGhpbmsgb2YKICAgICAqIGByZWplY3RgIGFzIHRoZSBgdGhyb3dgIGtleXdvcmQgaW4gSmF2YVNjcmlwdC4gVGhpcyBhbHNvIG1lYW5zIHRoYXQgaWYgeW91ICJjYXRjaCIgYW4gZXJyb3IgdmlhCiAgICAgKiBhIHByb21pc2UgZXJyb3IgY2FsbGJhY2sgYW5kIHlvdSB3YW50IHRvIGZvcndhcmQgdGhlIGVycm9yIHRvIHRoZSBwcm9taXNlIGRlcml2ZWQgZnJvbSB0aGUKICAgICAqIGN1cnJlbnQgcHJvbWlzZSwgeW91IGhhdmUgdG8gInJldGhyb3ciIHRoZSBlcnJvciBieSByZXR1cm5pbmcgYSByZWplY3Rpb24gY29uc3RydWN0ZWQgdmlhCiAgICAgKiBgcmVqZWN0YC4KICAgICAqCiAgICAgKiBgYGBqcwogICAgICogICBwcm9taXNlQiA9IHByb21pc2VBLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CiAgICogICAgIC8vIHN1Y2Nlc3M6IGRvIHNvbWV0aGluZyBhbmQgcmVzb2x2ZSBwcm9taXNlQgogICAqICAgICAvLyAgICAgICAgICB3aXRoIHRoZSBvbGQgb3IgYSBuZXcgcmVzdWx0CiAgICogICAgIHJldHVybiByZXN1bHQ7CiAgICogICB9LCBmdW5jdGlvbihyZWFzb24pIHsKICAgKiAgICAgLy8gZXJyb3I6IGhhbmRsZSB0aGUgZXJyb3IgaWYgcG9zc2libGUgYW5kCiAgICogICAgIC8vICAgICAgICByZXNvbHZlIHByb21pc2VCIHdpdGggbmV3UHJvbWlzZU9yVmFsdWUsCiAgICogICAgIC8vICAgICAgICBvdGhlcndpc2UgZm9yd2FyZCB0aGUgcmVqZWN0aW9uIHRvIHByb21pc2VCCiAgICogICAgIGlmIChjYW5IYW5kbGUocmVhc29uKSkgewogICAqICAgICAgLy8gaGFuZGxlIHRoZSBlcnJvciBhbmQgcmVjb3ZlcgogICAqICAgICAgcmV0dXJuIG5ld1Byb21pc2VPclZhbHVlOwogICAqICAgICB9CiAgICogICAgIHJldHVybiAkcS5yZWplY3QocmVhc29uKTsKICAgKiAgIH0pOwogICAgICogYGBgCiAgICAgKgogICAgICogQHBhcmFtIHsqfSByZWFzb24gQ29uc3RhbnQsIG1lc3NhZ2UsIGV4Y2VwdGlvbiBvciBhbiBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByZWplY3Rpb24gcmVhc29uLgogICAgICogQHJldHVybnMge1Byb21pc2V9IFJldHVybnMgYSBwcm9taXNlIHRoYXQgd2FzIGFscmVhZHkgcmVzb2x2ZWQgYXMgcmVqZWN0ZWQgd2l0aCB0aGUgYHJlYXNvbmAuCiAgICAgKi8KICAgIHZhciByZWplY3QgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgIHJlc3VsdC5yZWplY3QocmVhc29uKTsKICAgICAgcmV0dXJuIHJlc3VsdC5wcm9taXNlOwogICAgfTsKCiAgICB2YXIgY3JlYXRlSW50ZXJuYWxSZWplY3RlZFByb21pc2UgPSBmdW5jdGlvbihyZWFzb24pIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB0aGVuOiBmdW5jdGlvbihjYWxsYmFjaywgZXJyYmFjaykgewogICAgICAgICAgdmFyIHJlc3VsdCA9IGRlZmVyKCk7CiAgICAgICAgICBuZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXN1bHQucmVzb2x2ZSgoaXNGdW5jdGlvbihlcnJiYWNrKSA/IGVycmJhY2sgOiBkZWZhdWx0RXJyYmFjaykocmVhc29uKSk7CiAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgIHJlc3VsdC5yZWplY3QoZSk7CiAgICAgICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICAgICAgfQogICAgICB9OwogICAgfTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkcSN3aGVuCiAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogV3JhcHMgYW4gb2JqZWN0IHRoYXQgbWlnaHQgYmUgYSB2YWx1ZSBvciBhICgzcmQgcGFydHkpIHRoZW4tYWJsZSBwcm9taXNlIGludG8gYSAkcSBwcm9taXNlLgogICAgICogVGhpcyBpcyB1c2VmdWwgd2hlbiB5b3UgYXJlIGRlYWxpbmcgd2l0aCBhbiBvYmplY3QgdGhhdCBtaWdodCBvciBtaWdodCBub3QgYmUgYSBwcm9taXNlLCBvciBpZgogICAgICogdGhlIHByb21pc2UgY29tZXMgZnJvbSBhIHNvdXJjZSB0aGF0IGNhbid0IGJlIHRydXN0ZWQuCiAgICAgKgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBWYWx1ZSBvciBhIHByb21pc2UKICAgICAqIEByZXR1cm5zIHtQcm9taXNlfSBSZXR1cm5zIGEgcHJvbWlzZSBvZiB0aGUgcGFzc2VkIHZhbHVlIG9yIHByb21pc2UKICAgICAqLwogICAgdmFyIHdoZW4gPSBmdW5jdGlvbih2YWx1ZSwgY2FsbGJhY2ssIGVycmJhY2ssIHByb2dyZXNzYmFjaykgewogICAgICB2YXIgcmVzdWx0ID0gZGVmZXIoKSwKICAgICAgICBkb25lOwoKICAgICAgdmFyIHdyYXBwZWRDYWxsYmFjayA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiAoaXNGdW5jdGlvbihjYWxsYmFjaykgPyBjYWxsYmFjayA6IGRlZmF1bHRDYWxsYmFjaykodmFsdWUpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICByZXR1cm4gcmVqZWN0KGUpOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciB3cmFwcGVkRXJyYmFjayA9IGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gKGlzRnVuY3Rpb24oZXJyYmFjaykgPyBlcnJiYWNrIDogZGVmYXVsdEVycmJhY2spKHJlYXNvbik7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgIHJldHVybiByZWplY3QoZSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIHdyYXBwZWRQcm9ncmVzc2JhY2sgPSBmdW5jdGlvbihwcm9ncmVzcykgewogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gKGlzRnVuY3Rpb24ocHJvZ3Jlc3NiYWNrKSA/IHByb2dyZXNzYmFjayA6IGRlZmF1bHRDYWxsYmFjaykocHJvZ3Jlc3MpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgbmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgcmVmKHZhbHVlKS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAoZG9uZSkgcmV0dXJuOwogICAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgICByZXN1bHQucmVzb2x2ZShyZWYodmFsdWUpLnRoZW4od3JhcHBlZENhbGxiYWNrLCB3cmFwcGVkRXJyYmFjaywgd3JhcHBlZFByb2dyZXNzYmFjaykpOwogICAgICAgIH0sIGZ1bmN0aW9uKHJlYXNvbikgewogICAgICAgICAgaWYgKGRvbmUpIHJldHVybjsKICAgICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgICAgcmVzdWx0LnJlc29sdmUod3JhcHBlZEVycmJhY2socmVhc29uKSk7CiAgICAgICAgfSwgZnVuY3Rpb24ocHJvZ3Jlc3MpIHsKICAgICAgICAgIGlmIChkb25lKSByZXR1cm47CiAgICAgICAgICByZXN1bHQubm90aWZ5KHdyYXBwZWRQcm9ncmVzc2JhY2socHJvZ3Jlc3MpKTsKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICByZXR1cm4gcmVzdWx0LnByb21pc2U7CiAgICB9OwoKCiAgICBmdW5jdGlvbiBkZWZhdWx0Q2FsbGJhY2sodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKCiAgICBmdW5jdGlvbiBkZWZhdWx0RXJyYmFjayhyZWFzb24pIHsKICAgICAgcmV0dXJuIHJlamVjdChyZWFzb24pOwogICAgfQoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRxI2FsbAogICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENvbWJpbmVzIG11bHRpcGxlIHByb21pc2VzIGludG8gYSBzaW5nbGUgcHJvbWlzZSB0aGF0IGlzIHJlc29sdmVkIHdoZW4gYWxsIG9mIHRoZSBpbnB1dAogICAgICogcHJvbWlzZXMgYXJlIHJlc29sdmVkLgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXkuPFByb21pc2U+fE9iamVjdC48UHJvbWlzZT59IHByb21pc2VzIEFuIGFycmF5IG9yIGhhc2ggb2YgcHJvbWlzZXMuCiAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUmV0dXJucyBhIHNpbmdsZSBwcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCB3aXRoIGFuIGFycmF5L2hhc2ggb2YgdmFsdWVzLAogICAgICogICBlYWNoIHZhbHVlIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHByb21pc2UgYXQgdGhlIHNhbWUgaW5kZXgva2V5IGluIHRoZSBgcHJvbWlzZXNgIGFycmF5L2hhc2guCiAgICAgKiAgIElmIGFueSBvZiB0aGUgcHJvbWlzZXMgaXMgcmVzb2x2ZWQgd2l0aCBhIHJlamVjdGlvbiwgdGhpcyByZXN1bHRpbmcgcHJvbWlzZSB3aWxsIGJlIHJlamVjdGVkCiAgICAgKiAgIHdpdGggdGhlIHNhbWUgcmVqZWN0aW9uIHZhbHVlLgogICAgICovCiAgICBmdW5jdGlvbiBhbGwocHJvbWlzZXMpIHsKICAgICAgdmFyIGRlZmVycmVkID0gZGVmZXIoKSwKICAgICAgICBjb3VudGVyID0gMCwKICAgICAgICByZXN1bHRzID0gaXNBcnJheShwcm9taXNlcykgPyBbXSA6IHt9OwoKICAgICAgZm9yRWFjaChwcm9taXNlcywgZnVuY3Rpb24ocHJvbWlzZSwga2V5KSB7CiAgICAgICAgY291bnRlcisrOwogICAgICAgIHJlZihwcm9taXNlKS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAocmVzdWx0cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXR1cm47CiAgICAgICAgICByZXN1bHRzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgIGlmICghKC0tY291bnRlcikpIGRlZmVycmVkLnJlc29sdmUocmVzdWx0cyk7CiAgICAgICAgfSwgZnVuY3Rpb24ocmVhc29uKSB7CiAgICAgICAgICBpZiAocmVzdWx0cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSByZXR1cm47CiAgICAgICAgICBkZWZlcnJlZC5yZWplY3QocmVhc29uKTsKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICBpZiAoY291bnRlciA9PT0gMCkgewogICAgICAgIGRlZmVycmVkLnJlc29sdmUocmVzdWx0cyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGRlZmVyOiBkZWZlciwKICAgICAgcmVqZWN0OiByZWplY3QsCiAgICAgIHdoZW46IHdoZW4sCiAgICAgIGFsbDogYWxsCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gJCRSQUZQcm92aWRlcigpeyAvL3JBRgogICAgdGhpcy4kZ2V0ID0gWyckd2luZG93JywgJyR0aW1lb3V0JywgZnVuY3Rpb24oJHdpbmRvdywgJHRpbWVvdXQpIHsKICAgICAgdmFyIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9ICR3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgJHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAkd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZTsKCiAgICAgIHZhciBjYW5jZWxBbmltYXRpb25GcmFtZSA9ICR3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAkd2luZG93LndlYmtpdENhbmNlbEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgJHdpbmRvdy5tb3pDYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICAgICR3aW5kb3cud2Via2l0Q2FuY2VsUmVxdWVzdEFuaW1hdGlvbkZyYW1lOwoKICAgICAgdmFyIHJhZlN1cHBvcnRlZCA9ICEhcmVxdWVzdEFuaW1hdGlvbkZyYW1lOwogICAgICB2YXIgcmFmID0gcmFmU3VwcG9ydGVkCiAgICAgICAgPyBmdW5jdGlvbihmbikgewogICAgICAgIHZhciBpZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShmbik7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoaWQpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgICA6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgdmFyIHRpbWVyID0gJHRpbWVvdXQoZm4sIDE2LjY2LCBmYWxzZSk7IC8vIDEwMDAgLyA2MCA9IDE2LjY2NgogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICR0aW1lb3V0LmNhbmNlbCh0aW1lcik7CiAgICAgICAgfTsKICAgICAgfTsKCiAgICAgIHJhZi5zdXBwb3J0ZWQgPSByYWZTdXBwb3J0ZWQ7CgogICAgICByZXR1cm4gcmFmOwogICAgfV07CiAgfQoKICAvKioKICAgKiBERVNJR04gTk9URVMKICAgKgogICAqIFRoZSBkZXNpZ24gZGVjaXNpb25zIGJlaGluZCB0aGUgc2NvcGUgYXJlIGhlYXZpbHkgZmF2b3JlZCBmb3Igc3BlZWQgYW5kIG1lbW9yeSBjb25zdW1wdGlvbi4KICAgKgogICAqIFRoZSB0eXBpY2FsIHVzZSBvZiBzY29wZSBpcyB0byB3YXRjaCB0aGUgZXhwcmVzc2lvbnMsIHdoaWNoIG1vc3Qgb2YgdGhlIHRpbWUgcmV0dXJuIHRoZSBzYW1lCiAgICogdmFsdWUgYXMgbGFzdCB0aW1lIHNvIHdlIG9wdGltaXplIHRoZSBvcGVyYXRpb24uCiAgICoKICAgKiBDbG9zdXJlcyBjb25zdHJ1Y3Rpb24gaXMgZXhwZW5zaXZlIGluIHRlcm1zIG9mIHNwZWVkIGFzIHdlbGwgYXMgbWVtb3J5OgogICAqICAgLSBObyBjbG9zdXJlcywgaW5zdGVhZCB1c2UgcHJvdG90eXBpY2FsIGluaGVyaXRhbmNlIGZvciBBUEkKICAgKiAgIC0gSW50ZXJuYWwgc3RhdGUgbmVlZHMgdG8gYmUgc3RvcmVkIG9uIHNjb3BlIGRpcmVjdGx5LCB3aGljaCBtZWFucyB0aGF0IHByaXZhdGUgc3RhdGUgaXMKICAgKiAgICAgZXhwb3NlZCBhcyAkJF9fX18gcHJvcGVydGllcwogICAqCiAgICogTG9vcCBvcGVyYXRpb25zIGFyZSBvcHRpbWl6ZWQgYnkgdXNpbmcgd2hpbGUoY291bnQtLSkgeyAuLi4gfQogICAqICAgLSB0aGlzIG1lYW5zIHRoYXQgaW4gb3JkZXIgdG8ga2VlcCB0aGUgc2FtZSBvcmRlciBvZiBleGVjdXRpb24gYXMgYWRkaXRpb24gd2UgaGF2ZSB0byBhZGQKICAgKiAgICAgaXRlbXMgdG8gdGhlIGFycmF5IGF0IHRoZSBiZWdpbm5pbmcgKHVuc2hpZnQpIGluc3RlYWQgb2YgYXQgdGhlIGVuZCAocHVzaCkKICAgKgogICAqIENoaWxkIHNjb3BlcyBhcmUgY3JlYXRlZCBhbmQgcmVtb3ZlZCBvZnRlbgogICAqICAgLSBVc2luZyBhbiBhcnJheSB3b3VsZCBiZSBzbG93IHNpbmNlIGluc2VydHMgaW4gbWlkZGxlIGFyZSBleHBlbnNpdmUgc28gd2UgdXNlIGxpbmtlZCBsaXN0CiAgICoKICAgKiBUaGVyZSBhcmUgZmV3IHdhdGNoZXMgdGhlbiBhIGxvdCBvZiBvYnNlcnZlcnMuIFRoaXMgaXMgd2h5IHlvdSBkb24ndCB3YW50IHRoZSBvYnNlcnZlciB0byBiZQogICAqIGltcGxlbWVudGVkIGluIHRoZSBzYW1lIHdheSBhcyB3YXRjaC4gV2F0Y2ggcmVxdWlyZXMgcmV0dXJuIG9mIGluaXRpYWxpemF0aW9uIGZ1bmN0aW9uIHdoaWNoCiAgICogYXJlIGV4cGVuc2l2ZSB0byBjb25zdHJ1Y3QuCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgcHJvdmlkZXIKICAgKiBAbmFtZSAkcm9vdFNjb3BlUHJvdmlkZXIKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIFByb3ZpZGVyIGZvciB0aGUgJHJvb3RTY29wZSBzZXJ2aWNlLgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJHJvb3RTY29wZVByb3ZpZGVyI2RpZ2VzdFR0bAogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogU2V0cyB0aGUgbnVtYmVyIG9mIGAkZGlnZXN0YCBpdGVyYXRpb25zIHRoZSBzY29wZSBzaG91bGQgYXR0ZW1wdCB0byBleGVjdXRlIGJlZm9yZSBnaXZpbmcgdXAgYW5kCiAgICogYXNzdW1pbmcgdGhhdCB0aGUgbW9kZWwgaXMgdW5zdGFibGUuCiAgICoKICAgKiBUaGUgY3VycmVudCBkZWZhdWx0IGlzIDEwIGl0ZXJhdGlvbnMuCiAgICoKICAgKiBJbiBjb21wbGV4IGFwcGxpY2F0aW9ucyBpdCdzIHBvc3NpYmxlIHRoYXQgdGhlIGRlcGVuZGVuY2llcyBiZXR3ZWVuIGAkd2F0Y2hgcyB3aWxsIHJlc3VsdCBpbgogICAqIHNldmVyYWwgZGlnZXN0IGl0ZXJhdGlvbnMuIEhvd2V2ZXIgaWYgYW4gYXBwbGljYXRpb24gbmVlZHMgbW9yZSB0aGFuIHRoZSBkZWZhdWx0IDEwIGRpZ2VzdAogICAqIGl0ZXJhdGlvbnMgZm9yIGl0cyBtb2RlbCB0byBzdGFiaWxpemUgdGhlbiB5b3Ugc2hvdWxkIGludmVzdGlnYXRlIHdoYXQgaXMgY2F1c2luZyB0aGUgbW9kZWwgdG8KICAgKiBjb250aW51b3VzbHkgY2hhbmdlIGR1cmluZyB0aGUgZGlnZXN0LgogICAqCiAgICogSW5jcmVhc2luZyB0aGUgVFRMIGNvdWxkIGhhdmUgcGVyZm9ybWFuY2UgaW1wbGljYXRpb25zLCBzbyB5b3Ugc2hvdWxkIG5vdCBjaGFuZ2UgaXQgd2l0aG91dAogICAqIHByb3BlciBqdXN0aWZpY2F0aW9uLgogICAqCiAgICogQHBhcmFtIHtudW1iZXJ9IGxpbWl0IFRoZSBudW1iZXIgb2YgZGlnZXN0IGl0ZXJhdGlvbnMuCiAgICovCgoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRyb290U2NvcGUKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIEV2ZXJ5IGFwcGxpY2F0aW9uIGhhcyBhIHNpbmdsZSByb290IHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIHNjb3BlfS4KICAgKiBBbGwgb3RoZXIgc2NvcGVzIGFyZSBkZXNjZW5kYW50IHNjb3BlcyBvZiB0aGUgcm9vdCBzY29wZS4gU2NvcGVzIHByb3ZpZGUgc2VwYXJhdGlvbgogICAqIGJldHdlZW4gdGhlIG1vZGVsIGFuZCB0aGUgdmlldywgdmlhIGEgbWVjaGFuaXNtIGZvciB3YXRjaGluZyB0aGUgbW9kZWwgZm9yIGNoYW5nZXMuCiAgICogVGhleSBhbHNvIHByb3ZpZGUgYW4gZXZlbnQgZW1pc3Npb24vYnJvYWRjYXN0IGFuZCBzdWJzY3JpcHRpb24gZmFjaWxpdHkuIFNlZSB0aGUKICAgKiB7QGxpbmsgZ3VpZGUvc2NvcGUgZGV2ZWxvcGVyIGd1aWRlIG9uIHNjb3Blc30uCiAgICovCiAgZnVuY3Rpb24gJFJvb3RTY29wZVByb3ZpZGVyKCl7CiAgICB2YXIgVFRMID0gMTA7CiAgICB2YXIgJHJvb3RTY29wZU1pbkVyciA9IG1pbkVycignJHJvb3RTY29wZScpOwogICAgdmFyIGxhc3REaXJ0eVdhdGNoID0gbnVsbDsKCiAgICB0aGlzLmRpZ2VzdFR0bCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgVFRMID0gdmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIFRUTDsKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gWyckaW5qZWN0b3InLCAnJGV4Y2VwdGlvbkhhbmRsZXInLCAnJHBhcnNlJywgJyRicm93c2VyJywKICAgICAgZnVuY3Rpb24oICRpbmplY3RvciwgICAkZXhjZXB0aW9uSGFuZGxlciwgICAkcGFyc2UsICAgJGJyb3dzZXIpIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIHR5cGUKICAgICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlCiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBBIHJvb3Qgc2NvcGUgY2FuIGJlIHJldHJpZXZlZCB1c2luZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUgJHJvb3RTY29wZX0ga2V5IGZyb20gdGhlCiAgICAgICAgICoge0BsaW5rIGF1dG8uJGluamVjdG9yICRpbmplY3Rvcn0uIENoaWxkIHNjb3BlcyBhcmUgY3JlYXRlZCB1c2luZyB0aGUKICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkbmV3ICRuZXcoKX0gbWV0aG9kLiAoTW9zdCBzY29wZXMgYXJlIGNyZWF0ZWQgYXV0b21hdGljYWxseSB3aGVuCiAgICAgICAgICogY29tcGlsZWQgSFRNTCB0ZW1wbGF0ZSBpcyBleGVjdXRlZC4pCiAgICAgICAgICoKICAgICAgICAgKiBIZXJlIGlzIGEgc2ltcGxlIHNjb3BlIHNuaXBwZXQgdG8gc2hvdyBob3cgeW91IGNhbiBpbnRlcmFjdCB3aXRoIHRoZSBzY29wZS4KICAgICAgICAgKiBgYGBodG1sCiAgICAgICAgICogPGZpbGUgc3JjPSIuL3Rlc3Qvbmcvcm9vdFNjb3BlU3BlYy5qcyIgdGFnPSJkb2NzMSIgLz4KICAgICAgICAgKiBgYGAKICAgICAgICAgKgogICAgICAgICAqICMgSW5oZXJpdGFuY2UKICAgICAgICAgKiBBIHNjb3BlIGNhbiBpbmhlcml0IGZyb20gYSBwYXJlbnQgc2NvcGUsIGFzIGluIHRoaXMgZXhhbXBsZToKICAgICAgICAgKiBgYGBqcwogICAgICAgICB2YXIgcGFyZW50ID0gJHJvb3RTY29wZTsKICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LiRuZXcoKTsKCiAgICAgICAgIHBhcmVudC5zYWx1dGF0aW9uID0gIkhlbGxvIjsKICAgICAgICAgY2hpbGQubmFtZSA9ICJXb3JsZCI7CiAgICAgICAgIGV4cGVjdChjaGlsZC5zYWx1dGF0aW9uKS50b0VxdWFsKCdIZWxsbycpOwoKICAgICAgICAgY2hpbGQuc2FsdXRhdGlvbiA9ICJXZWxjb21lIjsKICAgICAgICAgZXhwZWN0KGNoaWxkLnNhbHV0YXRpb24pLnRvRXF1YWwoJ1dlbGNvbWUnKTsKICAgICAgICAgZXhwZWN0KHBhcmVudC5zYWx1dGF0aW9uKS50b0VxdWFsKCdIZWxsbycpOwogICAgICAgICAqIGBgYAogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCBmdW5jdGlvbigpPj19IHByb3ZpZGVycyBNYXAgb2Ygc2VydmljZSBmYWN0b3J5IHdoaWNoIG5lZWQgdG8gYmUKICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb3ZpZGVkIGZvciB0aGUgY3VycmVudCBzY29wZS4gRGVmYXVsdHMgdG8ge0BsaW5rIG5nfS4KICAgICAgICAgKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCAqPj19IGluc3RhbmNlQ2FjaGUgUHJvdmlkZXMgcHJlLWluc3RhbnRpYXRlZCBzZXJ2aWNlcyB3aGljaCBzaG91bGQKICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGVuZC9vdmVycmlkZSBzZXJ2aWNlcyBwcm92aWRlZCBieSBgcHJvdmlkZXJzYC4gVGhpcyBpcyBoYW5keQogICAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hlbiB1bml0LXRlc3RpbmcgYW5kIGhhdmluZyB0aGUgbmVlZCB0byBvdmVycmlkZSBhIGRlZmF1bHQKICAgICAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2UuCiAgICAgICAgICogQHJldHVybnMge09iamVjdH0gTmV3bHkgY3JlYXRlZCBzY29wZS4KICAgICAgICAgKgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIFNjb3BlKCkgewogICAgICAgICAgdGhpcy4kaWQgPSBuZXh0VWlkKCk7CiAgICAgICAgICB0aGlzLiQkcGhhc2UgPSB0aGlzLiRwYXJlbnQgPSB0aGlzLiQkd2F0Y2hlcnMgPQogICAgICAgICAgICB0aGlzLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkcHJldlNpYmxpbmcgPQogICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgIHRoaXNbJ3RoaXMnXSA9IHRoaXMuJHJvb3QgPSAgdGhpczsKICAgICAgICAgIHRoaXMuJCRkZXN0cm95ZWQgPSBmYWxzZTsKICAgICAgICAgIHRoaXMuJCRhc3luY1F1ZXVlID0gW107CiAgICAgICAgICB0aGlzLiQkcG9zdERpZ2VzdFF1ZXVlID0gW107CiAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzID0ge307CiAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJDb3VudCA9IHt9OwogICAgICAgICAgdGhpcy4kJGlzb2xhdGVCaW5kaW5ncyA9IHt9OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIHByb3BlcnR5CiAgICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkaWQKICAgICAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBVbmlxdWUgc2NvcGUgSUQgKG1vbm90b25pY2FsbHkgaW5jcmVhc2luZyBhbHBoYW51bWVyaWMgc2VxdWVuY2UpIHVzZWZ1bCBmb3IKICAgICAgICAgKiAgIGRlYnVnZ2luZy4KICAgICAgICAgKi8KCgogICAgICAgIFNjb3BlLnByb3RvdHlwZSA9IHsKICAgICAgICAgIGNvbnN0cnVjdG9yOiBTY29wZSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkbmV3CiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogQ3JlYXRlcyBhIG5ldyBjaGlsZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSBzY29wZX0uCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhlIHBhcmVudCBzY29wZSB3aWxsIHByb3BhZ2F0ZSB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZAogICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGV2ZW50cy4gVGhlIHNjb3BlIGNhbiBiZSByZW1vdmVkIGZyb20gdGhlCiAgICAgICAgICAgKiBzY29wZSBoaWVyYXJjaHkgdXNpbmcge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRlc3Ryb3kgJGRlc3Ryb3koKX0uCiAgICAgICAgICAgKgogICAgICAgICAgICoge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRlc3Ryb3kgJGRlc3Ryb3koKX0gbXVzdCBiZSBjYWxsZWQgb24gYSBzY29wZSB3aGVuIGl0IGlzCiAgICAgICAgICAgKiBkZXNpcmVkIGZvciB0aGUgc2NvcGUgYW5kIGl0cyBjaGlsZCBzY29wZXMgdG8gYmUgcGVybWFuZW50bHkgZGV0YWNoZWQgZnJvbSB0aGUgcGFyZW50IGFuZAogICAgICAgICAgICogdGh1cyBzdG9wIHBhcnRpY2lwYXRpbmcgaW4gbW9kZWwgY2hhbmdlIGRldGVjdGlvbiBhbmQgbGlzdGVuZXIgbm90aWZpY2F0aW9uIGJ5IGludm9raW5nLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNvbGF0ZSBJZiB0cnVlLCB0aGVuIHRoZSBzY29wZSBkb2VzIG5vdCBwcm90b3R5cGljYWxseSBpbmhlcml0IGZyb20gdGhlCiAgICAgICAgICAgKiAgICAgICAgIHBhcmVudCBzY29wZS4gVGhlIHNjb3BlIGlzIGlzb2xhdGVkLCBhcyBpdCBjYW4gbm90IHNlZSBwYXJlbnQgc2NvcGUgcHJvcGVydGllcy4KICAgICAgICAgICAqICAgICAgICAgV2hlbiBjcmVhdGluZyB3aWRnZXRzLCBpdCBpcyB1c2VmdWwgZm9yIHRoZSB3aWRnZXQgdG8gbm90IGFjY2lkZW50YWxseSByZWFkIHBhcmVudAogICAgICAgICAgICogICAgICAgICBzdGF0ZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBUaGUgbmV3bHkgY3JlYXRlZCBjaGlsZCBzY29wZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKi8KICAgICAgICAgICRuZXc6IGZ1bmN0aW9uKGlzb2xhdGUpIHsKICAgICAgICAgICAgdmFyIENoaWxkU2NvcGUsCiAgICAgICAgICAgICAgY2hpbGQ7CgogICAgICAgICAgICBpZiAoaXNvbGF0ZSkgewogICAgICAgICAgICAgIGNoaWxkID0gbmV3IFNjb3BlKCk7CiAgICAgICAgICAgICAgY2hpbGQuJHJvb3QgPSB0aGlzLiRyb290OwogICAgICAgICAgICAgIC8vIGVuc3VyZSB0aGF0IHRoZXJlIGlzIGp1c3Qgb25lIGFzeW5jIHF1ZXVlIHBlciAkcm9vdFNjb3BlIGFuZCBpdHMgY2hpbGRyZW4KICAgICAgICAgICAgICBjaGlsZC4kJGFzeW5jUXVldWUgPSB0aGlzLiQkYXN5bmNRdWV1ZTsKICAgICAgICAgICAgICBjaGlsZC4kJHBvc3REaWdlc3RRdWV1ZSA9IHRoaXMuJCRwb3N0RGlnZXN0UXVldWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gT25seSBjcmVhdGUgYSBjaGlsZCBzY29wZSBjbGFzcyBpZiBzb21lYm9keSBhc2tzIGZvciBvbmUsCiAgICAgICAgICAgICAgLy8gYnV0IGNhY2hlIGl0IHRvIGFsbG93IHRoZSBWTSB0byBvcHRpbWl6ZSBsb29rdXBzLgogICAgICAgICAgICAgIGlmICghdGhpcy4kJGNoaWxkU2NvcGVDbGFzcykgewogICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkU2NvcGVDbGFzcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aGlzLiQkd2F0Y2hlcnMgPSB0aGlzLiQkbmV4dFNpYmxpbmcgPQogICAgICAgICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gbnVsbDsKICAgICAgICAgICAgICAgICAgdGhpcy4kJGxpc3RlbmVycyA9IHt9OwogICAgICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJDb3VudCA9IHt9OwogICAgICAgICAgICAgICAgICB0aGlzLiRpZCA9IG5leHRVaWQoKTsKICAgICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkU2NvcGVDbGFzcyA9IG51bGw7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkU2NvcGVDbGFzcy5wcm90b3R5cGUgPSB0aGlzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IG5ldyB0aGlzLiQkY2hpbGRTY29wZUNsYXNzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGRbJ3RoaXMnXSA9IGNoaWxkOwogICAgICAgICAgICBjaGlsZC4kcGFyZW50ID0gdGhpczsKICAgICAgICAgICAgY2hpbGQuJCRwcmV2U2libGluZyA9IHRoaXMuJCRjaGlsZFRhaWw7CiAgICAgICAgICAgIGlmICh0aGlzLiQkY2hpbGRIZWFkKSB7CiAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkVGFpbC4kJG5leHRTaWJsaW5nID0gY2hpbGQ7CiAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkVGFpbCA9IGNoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuJCRjaGlsZEhlYWQgPSB0aGlzLiQkY2hpbGRUYWlsID0gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJHdhdGNoCiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogUmVnaXN0ZXJzIGEgYGxpc3RlbmVyYCBjYWxsYmFjayB0byBiZSBleGVjdXRlZCB3aGVuZXZlciB0aGUgYHdhdGNoRXhwcmVzc2lvbmAgY2hhbmdlcy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiAtIFRoZSBgd2F0Y2hFeHByZXNzaW9uYCBpcyBjYWxsZWQgb24gZXZlcnkgY2FsbCB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0CiAgICAgICAqICAgJGRpZ2VzdCgpfSBhbmQgc2hvdWxkIHJldHVybiB0aGUgdmFsdWUgdGhhdCB3aWxsIGJlIHdhdGNoZWQuIChTaW5jZQogICAgICAgICAgICogICB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gcmVydW5zIHdoZW4gaXQgZGV0ZWN0cyBjaGFuZ2VzIHRoZQogICAgICAgICAgICogICBgd2F0Y2hFeHByZXNzaW9uYCBjYW4gZXhlY3V0ZSBtdWx0aXBsZSB0aW1lcyBwZXIKICAgICAgICAgICAqICAge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGRpZ2VzdCAkZGlnZXN0KCl9IGFuZCBzaG91bGQgYmUgaWRlbXBvdGVudC4pCiAgICAgICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCBvbmx5IHdoZW4gdGhlIHZhbHVlIGZyb20gdGhlIGN1cnJlbnQgYHdhdGNoRXhwcmVzc2lvbmAgYW5kIHRoZQogICAgICAgICAgICogICBwcmV2aW91cyBjYWxsIHRvIGB3YXRjaEV4cHJlc3Npb25gIGFyZSBub3QgZXF1YWwgKHdpdGggdGhlIGV4Y2VwdGlvbiBvZiB0aGUgaW5pdGlhbCBydW4sCiAgICAgICAgICAgKiAgIHNlZSBiZWxvdykuIEluZXF1YWxpdHkgaXMgZGV0ZXJtaW5lZCBhY2NvcmRpbmcgdG8gcmVmZXJlbmNlIGluZXF1YWxpdHksCiAgICAgICAgICAgKiAgIFtzdHJpY3QgY29tcGFyaXNvbl0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvT3BlcmF0b3JzL0NvbXBhcmlzb25fT3BlcmF0b3JzKQogICAgICAgICAgICogICAgdmlhIHRoZSBgIT09YCBKYXZhc2NyaXB0IG9wZXJhdG9yLCB1bmxlc3MgYG9iamVjdEVxdWFsaXR5ID09IHRydWVgCiAgICAgICAgICAgKiAgIChzZWUgbmV4dCBwb2ludCkKICAgICAgICAgICAqIC0gV2hlbiBgb2JqZWN0RXF1YWxpdHkgPT0gdHJ1ZWAsIGluZXF1YWxpdHkgb2YgdGhlIGB3YXRjaEV4cHJlc3Npb25gIGlzIGRldGVybWluZWQKICAgICAgICAgICAqICAgYWNjb3JkaW5nIHRvIHRoZSB7QGxpbmsgYW5ndWxhci5lcXVhbHN9IGZ1bmN0aW9uLiBUbyBzYXZlIHRoZSB2YWx1ZSBvZiB0aGUgb2JqZWN0IGZvcgogICAgICAgICAgICogICBsYXRlciBjb21wYXJpc29uLCB0aGUge0BsaW5rIGFuZ3VsYXIuY29weX0gZnVuY3Rpb24gaXMgdXNlZC4gVGhpcyB0aGVyZWZvcmUgbWVhbnMgdGhhdAogICAgICAgICAgICogICB3YXRjaGluZyBjb21wbGV4IG9iamVjdHMgd2lsbCBoYXZlIGFkdmVyc2UgbWVtb3J5IGFuZCBwZXJmb3JtYW5jZSBpbXBsaWNhdGlvbnMuCiAgICAgICAgICAgKiAtIFRoZSB3YXRjaCBgbGlzdGVuZXJgIG1heSBjaGFuZ2UgdGhlIG1vZGVsLCB3aGljaCBtYXkgdHJpZ2dlciBvdGhlciBgbGlzdGVuZXJgcyB0byBmaXJlLgogICAgICAgICAgICogICBUaGlzIGlzIGFjaGlldmVkIGJ5IHJlcnVubmluZyB0aGUgd2F0Y2hlcnMgdW50aWwgbm8gY2hhbmdlcyBhcmUgZGV0ZWN0ZWQuIFRoZSByZXJ1bgogICAgICAgICAgICogICBpdGVyYXRpb24gbGltaXQgaXMgMTAgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wIGRlYWRsb2NrLgogICAgICAgICAgICoKICAgICAgICAgICAqCiAgICAgICAgICAgKiBJZiB5b3Ugd2FudCB0byBiZSBub3RpZmllZCB3aGVuZXZlciB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3R9IGlzIGNhbGxlZCwKICAgICAgICAgICAqIHlvdSBjYW4gcmVnaXN0ZXIgYSBgd2F0Y2hFeHByZXNzaW9uYCBmdW5jdGlvbiB3aXRoIG5vIGBsaXN0ZW5lcmAuIChTaW5jZSBgd2F0Y2hFeHByZXNzaW9uYAogICAgICAgICAgICogY2FuIGV4ZWN1dGUgbXVsdGlwbGUgdGltZXMgcGVyIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUgd2hlbiBhCiAgICAgICAgICAgKiBjaGFuZ2UgaXMgZGV0ZWN0ZWQsIGJlIHByZXBhcmVkIGZvciBtdWx0aXBsZSBjYWxscyB0byB5b3VyIGxpc3RlbmVyLikKICAgICAgICAgICAqCiAgICAgICAgICAgKiBBZnRlciBhIHdhdGNoZXIgaXMgcmVnaXN0ZXJlZCB3aXRoIHRoZSBzY29wZSwgdGhlIGBsaXN0ZW5lcmAgZm4gaXMgY2FsbGVkIGFzeW5jaHJvbm91c2x5CiAgICAgICAgICAgKiAodmlhIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMgJGV2YWxBc3luY30pIHRvIGluaXRpYWxpemUgdGhlCiAgICAgICAgICAgKiB3YXRjaGVyLiBJbiByYXJlIGNhc2VzLCB0aGlzIGlzIHVuZGVzaXJhYmxlIGJlY2F1c2UgdGhlIGxpc3RlbmVyIGlzIGNhbGxlZCB3aGVuIHRoZSByZXN1bHQKICAgICAgICAgICAqIG9mIGB3YXRjaEV4cHJlc3Npb25gIGRpZG4ndCBjaGFuZ2UuIFRvIGRldGVjdCB0aGlzIHNjZW5hcmlvIHdpdGhpbiB0aGUgYGxpc3RlbmVyYCBmbiwgeW91CiAgICAgICAgICAgKiBjYW4gY29tcGFyZSB0aGUgYG5ld1ZhbGAgYW5kIGBvbGRWYWxgLiBJZiB0aGVzZSB0d28gdmFsdWVzIGFyZSBpZGVudGljYWwgKGA9PT1gKSB0aGVuIHRoZQogICAgICAgICAgICogbGlzdGVuZXIgd2FzIGNhbGxlZCBkdWUgdG8gaW5pdGlhbGl6YXRpb24uCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhlIGV4YW1wbGUgYmVsb3cgY29udGFpbnMgYW4gaWxsdXN0cmF0aW9uIG9mIHVzaW5nIGEgZnVuY3Rpb24gYXMgeW91ciAkd2F0Y2ggbGlzdGVuZXIKICAgICAgICAgICAqCiAgICAgICAgICAgKgogICAgICAgICAgICogIyBFeGFtcGxlCiAgICAgICAgICAgKiBgYGBqcwogICAgICAgICAgIC8vIGxldCdzIGFzc3VtZSB0aGF0IHNjb3BlIHdhcyBkZXBlbmRlbmN5IGluamVjdGVkIGFzIHRoZSAkcm9vdFNjb3BlCiAgICAgICAgICAgdmFyIHNjb3BlID0gJHJvb3RTY29wZTsKICAgICAgICAgICBzY29wZS5uYW1lID0gJ21pc2tvJzsKICAgICAgICAgICBzY29wZS5jb3VudGVyID0gMDsKCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CiAgICAgICAgICAgc2NvcGUuJHdhdGNoKCduYW1lJywgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICBzY29wZS5jb3VudGVyID0gc2NvcGUuY291bnRlciArIDE7CiAgICAgICAgICAgfSk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICAvLyB0aGUgbGlzdGVuZXIgaXMgYWx3YXlzIGNhbGxlZCBkdXJpbmcgdGhlIGZpcnN0ICRkaWdlc3QgbG9vcCBhZnRlciBpdCB3YXMgcmVnaXN0ZXJlZAogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwoKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgLy8gYnV0IG5vdyBpdCB3aWxsIG5vdCBiZSBjYWxsZWQgdW5sZXNzIHRoZSB2YWx1ZSBjaGFuZ2VzCiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmNvdW50ZXIpLnRvRXF1YWwoMSk7CgogICAgICAgICAgIHNjb3BlLm5hbWUgPSAnYWRhbSc7CiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDIpOwoKCgogICAgICAgICAgIC8vIFVzaW5nIGEgbGlzdGVuZXIgZnVuY3Rpb24KICAgICAgICAgICB2YXIgZm9vZDsKICAgICAgICAgICBzY29wZS5mb29kQ291bnRlciA9IDA7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLmZvb2RDb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBsaXN0ZW5lciBmdW5jdGlvbgogICAgICAgICAgIGZ1bmN0aW9uKCkgeyByZXR1cm4gZm9vZDsgfSwKICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBjaGFuZ2UgaGFuZGxlcgogICAgICAgICAgIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgICBpZiAoIG5ld1ZhbHVlICE9PSBvbGRWYWx1ZSApIHsKICAgICAgICAgICAgICAgICAvLyBPbmx5IGluY3JlbWVudCB0aGUgY291bnRlciBpZiB0aGUgdmFsdWUgY2hhbmdlZAogICAgICAgICAgICAgICAgIHNjb3BlLmZvb2RDb3VudGVyID0gc2NvcGUuZm9vZENvdW50ZXIgKyAxOwogICAgICAgICAgICAgICB9CiAgICAgICAgICAgICB9CiAgICAgICAgICAgKTsKICAgICAgICAgICAvLyBObyBkaWdlc3QgaGFzIGJlZW4gcnVuIHNvIHRoZSBjb3VudGVyIHdpbGwgYmUgemVybwogICAgICAgICAgIGV4cGVjdChzY29wZS5mb29kQ291bnRlcikudG9FcXVhbCgwKTsKCiAgICAgICAgICAgLy8gUnVuIHRoZSBkaWdlc3QgYnV0IHNpbmNlIGZvb2QgaGFzIG5vdCBjaGFuZ2VkIGNvdW50IHdpbGwgc3RpbGwgYmUgemVybwogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuZm9vZENvdW50ZXIpLnRvRXF1YWwoMCk7CgogICAgICAgICAgIC8vIFVwZGF0ZSBmb29kIGFuZCBydW4gZGlnZXN0LiAgTm93IHRoZSBjb3VudGVyIHdpbGwgaW5jcmVtZW50CiAgICAgICAgICAgZm9vZCA9ICdjaGVlc2VidXJnZXInOwogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuZm9vZENvdW50ZXIpLnRvRXF1YWwoMSk7CgogICAgICAgICAgICogYGBgCiAgICAgICAgICAgKgogICAgICAgICAgICoKICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0geyhmdW5jdGlvbigpfHN0cmluZyl9IHdhdGNoRXhwcmVzc2lvbiBFeHByZXNzaW9uIHRoYXQgaXMgZXZhbHVhdGVkIG9uIGVhY2gKICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUuIEEgY2hhbmdlIGluIHRoZSByZXR1cm4gdmFsdWUgdHJpZ2dlcnMKICAgICAgICAgICAqICAgIGEgY2FsbCB0byB0aGUgYGxpc3RlbmVyYC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBFdmFsdWF0ZWQgYXMge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0KICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGNhbGxlZCB3aXRoIGN1cnJlbnQgYHNjb3BlYCBhcyBhIHBhcmFtZXRlci4KICAgICAgICAgICAqIEBwYXJhbSB7KGZ1bmN0aW9uKCl8c3RyaW5nKT19IGxpc3RlbmVyIENhbGxiYWNrIGNhbGxlZCB3aGVuZXZlciB0aGUgcmV0dXJuIHZhbHVlIG9mCiAgICAgICAgICAgKiAgIHRoZSBgd2F0Y2hFeHByZXNzaW9uYCBjaGFuZ2VzLgogICAgICAgICAgICoKICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IEV2YWx1YXRlZCBhcyB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufQogICAgICAgICAgICogICAgLSBgZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlLCBzY29wZSlgOiBjYWxsZWQgd2l0aCBjdXJyZW50IGFuZCBwcmV2aW91cyB2YWx1ZXMgYXMKICAgICAgICAgICAqICAgICAgcGFyYW1ldGVycy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBvYmplY3RFcXVhbGl0eSBDb21wYXJlIGZvciBvYmplY3QgZXF1YWxpdHkgdXNpbmcge0BsaW5rIGFuZ3VsYXIuZXF1YWxzfSBpbnN0ZWFkIG9mCiAgICAgICAgICAgKiAgICAgY29tcGFyaW5nIGZvciByZWZlcmVuY2UgZXF1YWxpdHkuCiAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGZvciB0aGlzIGxpc3RlbmVyLgogICAgICAgICAgICovCiAgICAgICAgICAkd2F0Y2g6IGZ1bmN0aW9uKHdhdGNoRXhwLCBsaXN0ZW5lciwgb2JqZWN0RXF1YWxpdHkpIHsKICAgICAgICAgICAgdmFyIHNjb3BlID0gdGhpcywKICAgICAgICAgICAgICBnZXQgPSBjb21waWxlVG9Gbih3YXRjaEV4cCwgJ3dhdGNoJyksCiAgICAgICAgICAgICAgYXJyYXkgPSBzY29wZS4kJHdhdGNoZXJzLAogICAgICAgICAgICAgIHdhdGNoZXIgPSB7CiAgICAgICAgICAgICAgICBmbjogbGlzdGVuZXIsCiAgICAgICAgICAgICAgICBsYXN0OiBpbml0V2F0Y2hWYWwsCiAgICAgICAgICAgICAgICBnZXQ6IGdldCwKICAgICAgICAgICAgICAgIGV4cDogd2F0Y2hFeHAsCiAgICAgICAgICAgICAgICBlcTogISFvYmplY3RFcXVhbGl0eQogICAgICAgICAgICAgIH07CgogICAgICAgICAgICBsYXN0RGlydHlXYXRjaCA9IG51bGw7CgogICAgICAgICAgICAvLyBpbiB0aGUgY2FzZSB1c2VyIHBhc3Mgc3RyaW5nLCB3ZSBuZWVkIHRvIGNvbXBpbGUgaXQsIGRvIHdlIHJlYWxseSBuZWVkIHRoaXMgPwogICAgICAgICAgICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKSB7CiAgICAgICAgICAgICAgdmFyIGxpc3RlbkZuID0gY29tcGlsZVRvRm4obGlzdGVuZXIgfHwgbm9vcCwgJ2xpc3RlbmVyJyk7CiAgICAgICAgICAgICAgd2F0Y2hlci5mbiA9IGZ1bmN0aW9uKG5ld1ZhbCwgb2xkVmFsLCBzY29wZSkge2xpc3RlbkZuKHNjb3BlKTt9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mIHdhdGNoRXhwID09ICdzdHJpbmcnICYmIGdldC5jb25zdGFudCkgewogICAgICAgICAgICAgIHZhciBvcmlnaW5hbEZuID0gd2F0Y2hlci5mbjsKICAgICAgICAgICAgICB3YXRjaGVyLmZuID0gZnVuY3Rpb24obmV3VmFsLCBvbGRWYWwsIHNjb3BlKSB7CiAgICAgICAgICAgICAgICBvcmlnaW5hbEZuLmNhbGwodGhpcywgbmV3VmFsLCBvbGRWYWwsIHNjb3BlKTsKICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKGFycmF5LCB3YXRjaGVyKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFycmF5KSB7CiAgICAgICAgICAgICAgYXJyYXkgPSBzY29wZS4kJHdhdGNoZXJzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gd2UgdXNlIHVuc2hpZnQgc2luY2Ugd2UgdXNlIGEgd2hpbGUgbG9vcCBpbiAkZGlnZXN0IGZvciBzcGVlZC4KICAgICAgICAgICAgLy8gdGhlIHdoaWxlIGxvb3AgcmVhZHMgaW4gcmV2ZXJzZSBvcmRlci4KICAgICAgICAgICAgYXJyYXkudW5zaGlmdCh3YXRjaGVyKTsKCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBkZXJlZ2lzdGVyV2F0Y2goKSB7CiAgICAgICAgICAgICAgYXJyYXlSZW1vdmUoYXJyYXksIHdhdGNoZXIpOwogICAgICAgICAgICAgIGxhc3REaXJ0eVdhdGNoID0gbnVsbDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0sCgoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkd2F0Y2hDb2xsZWN0aW9uCiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogU2hhbGxvdyB3YXRjaGVzIHRoZSBwcm9wZXJ0aWVzIG9mIGFuIG9iamVjdCBhbmQgZmlyZXMgd2hlbmV2ZXIgYW55IG9mIHRoZSBwcm9wZXJ0aWVzIGNoYW5nZQogICAgICAgICAgICogKGZvciBhcnJheXMsIHRoaXMgaW1wbGllcyB3YXRjaGluZyB0aGUgYXJyYXkgaXRlbXM7IGZvciBvYmplY3QgbWFwcywgdGhpcyBpbXBsaWVzIHdhdGNoaW5nCiAgICAgICAgICAgKiB0aGUgcHJvcGVydGllcykuIElmIGEgY2hhbmdlIGlzIGRldGVjdGVkLCB0aGUgYGxpc3RlbmVyYCBjYWxsYmFjayBpcyBmaXJlZC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiAtIFRoZSBgb2JqYCBjb2xsZWN0aW9uIGlzIG9ic2VydmVkIHZpYSBzdGFuZGFyZCAkd2F0Y2ggb3BlcmF0aW9uIGFuZCBpcyBleGFtaW5lZCBvbiBldmVyeQogICAgICAgICAgICogICBjYWxsIHRvICRkaWdlc3QoKSB0byBzZWUgaWYgYW55IGl0ZW1zIGhhdmUgYmVlbiBhZGRlZCwgcmVtb3ZlZCwgb3IgbW92ZWQuCiAgICAgICAgICAgKiAtIFRoZSBgbGlzdGVuZXJgIGlzIGNhbGxlZCB3aGVuZXZlciBhbnl0aGluZyB3aXRoaW4gdGhlIGBvYmpgIGhhcyBjaGFuZ2VkLiBFeGFtcGxlcyBpbmNsdWRlCiAgICAgICAgICAgKiAgIGFkZGluZywgcmVtb3ZpbmcsIGFuZCBtb3ZpbmcgaXRlbXMgYmVsb25naW5nIHRvIGFuIG9iamVjdCBvciBhcnJheS4KICAgICAgICAgICAqCiAgICAgICAgICAgKgogICAgICAgICAgICogIyBFeGFtcGxlCiAgICAgICAgICAgKiBgYGBqcwogICAgICAgICAgICRzY29wZS5uYW1lcyA9IFsnaWdvcicsICdtYXRpYXMnLCAnbWlza28nLCAnamFtZXMnXTsKICAgICAgICAgICAkc2NvcGUuZGF0YUNvdW50ID0gNDsKCiAgICAgICAgICAgJHNjb3BlLiR3YXRjaENvbGxlY3Rpb24oJ25hbWVzJywgZnVuY3Rpb24obmV3TmFtZXMsIG9sZE5hbWVzKSB7CiAgICAgICAgICAgICRzY29wZS5kYXRhQ291bnQgPSBuZXdOYW1lcy5sZW5ndGg7CiAgICAgICAgICB9KTsKCiAgICAgICAgICAgZXhwZWN0KCRzY29wZS5kYXRhQ291bnQpLnRvRXF1YWwoNCk7CiAgICAgICAgICAgJHNjb3BlLiRkaWdlc3QoKTsKCiAgICAgICAgICAgLy9zdGlsbCBhdCA0IC4uLiBubyBjaGFuZ2VzCiAgICAgICAgICAgZXhwZWN0KCRzY29wZS5kYXRhQ291bnQpLnRvRXF1YWwoNCk7CgogICAgICAgICAgICRzY29wZS5uYW1lcy5wb3AoKTsKICAgICAgICAgICAkc2NvcGUuJGRpZ2VzdCgpOwoKICAgICAgICAgICAvL25vdyB0aGVyZSdzIGJlZW4gYSBjaGFuZ2UKICAgICAgICAgICBleHBlY3QoJHNjb3BlLmRhdGFDb3VudCkudG9FcXVhbCgzKTsKICAgICAgICAgICAqIGBgYAogICAgICAgICAgICoKICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ3xmdW5jdGlvbihzY29wZSl9IG9iaiBFdmFsdWF0ZWQgYXMge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0uIFRoZQogICAgICAgICAgICogICAgZXhwcmVzc2lvbiB2YWx1ZSBzaG91bGQgZXZhbHVhdGUgdG8gYW4gb2JqZWN0IG9yIGFuIGFycmF5IHdoaWNoIGlzIG9ic2VydmVkIG9uIGVhY2gKICAgICAgICAgICAqICAgIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdH0gY3ljbGUuIEFueSBzaGFsbG93IGNoYW5nZSB3aXRoaW4gdGhlCiAgICAgICAgICAgKiAgICBjb2xsZWN0aW9uIHdpbGwgdHJpZ2dlciBhIGNhbGwgdG8gdGhlIGBsaXN0ZW5lcmAuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbihuZXdDb2xsZWN0aW9uLCBvbGRDb2xsZWN0aW9uLCBzY29wZSl9IGxpc3RlbmVyIGEgY2FsbGJhY2sgZnVuY3Rpb24gY2FsbGVkCiAgICAgICAgICAgKiAgICB3aGVuIGEgY2hhbmdlIGlzIGRldGVjdGVkLgogICAgICAgICAgICogICAgLSBUaGUgYG5ld0NvbGxlY3Rpb25gIG9iamVjdCBpcyB0aGUgbmV3bHkgbW9kaWZpZWQgZGF0YSBvYnRhaW5lZCBmcm9tIHRoZSBgb2JqYCBleHByZXNzaW9uCiAgICAgICAgICAgKiAgICAtIFRoZSBgb2xkQ29sbGVjdGlvbmAgb2JqZWN0IGlzIGEgY29weSBvZiB0aGUgZm9ybWVyIGNvbGxlY3Rpb24gZGF0YS4KICAgICAgICAgICAqICAgICAgRHVlIHRvIHBlcmZvcm1hbmNlIGNvbnNpZGVyYXRpb25zLCB0aGVgb2xkQ29sbGVjdGlvbmAgdmFsdWUgaXMgY29tcHV0ZWQgb25seSBpZiB0aGUKICAgICAgICAgICAqICAgICAgYGxpc3RlbmVyYCBmdW5jdGlvbiBkZWNsYXJlcyB0d28gb3IgbW9yZSBhcmd1bWVudHMuCiAgICAgICAgICAgKiAgICAtIFRoZSBgc2NvcGVgIGFyZ3VtZW50IHJlZmVycyB0byB0aGUgY3VycmVudCBzY29wZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlLXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBmb3IgdGhpcyBsaXN0ZW5lci4gV2hlbiB0aGUKICAgICAgICAgICAqICAgIGRlLXJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBpcyBleGVjdXRlZCwgdGhlIGludGVybmFsIHdhdGNoIG9wZXJhdGlvbiBpcyB0ZXJtaW5hdGVkLgogICAgICAgICAgICovCiAgICAgICAgICAkd2F0Y2hDb2xsZWN0aW9uOiBmdW5jdGlvbihvYmosIGxpc3RlbmVyKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgLy8gdGhlIGN1cnJlbnQgdmFsdWUsIHVwZGF0ZWQgb24gZWFjaCBkaXJ0eS1jaGVjayBydW4KICAgICAgICAgICAgdmFyIG5ld1ZhbHVlOwogICAgICAgICAgICAvLyBhIHNoYWxsb3cgY29weSBvZiB0aGUgbmV3VmFsdWUgZnJvbSB0aGUgbGFzdCBkaXJ0eS1jaGVjayBydW4sCiAgICAgICAgICAgIC8vIHVwZGF0ZWQgdG8gbWF0Y2ggbmV3VmFsdWUgZHVyaW5nIGRpcnR5LWNoZWNrIHJ1bgogICAgICAgICAgICB2YXIgb2xkVmFsdWU7CiAgICAgICAgICAgIC8vIGEgc2hhbGxvdyBjb3B5IG9mIHRoZSBuZXdWYWx1ZSBmcm9tIHdoZW4gdGhlIGxhc3QgY2hhbmdlIGhhcHBlbmVkCiAgICAgICAgICAgIHZhciB2ZXJ5T2xkVmFsdWU7CiAgICAgICAgICAgIC8vIG9ubHkgdHJhY2sgdmVyeU9sZFZhbHVlIGlmIHRoZSBsaXN0ZW5lciBpcyBhc2tpbmcgZm9yIGl0CiAgICAgICAgICAgIHZhciB0cmFja1ZlcnlPbGRWYWx1ZSA9IChsaXN0ZW5lci5sZW5ndGggPiAxKTsKICAgICAgICAgICAgdmFyIGNoYW5nZURldGVjdGVkID0gMDsKICAgICAgICAgICAgdmFyIG9iakdldHRlciA9ICRwYXJzZShvYmopOwogICAgICAgICAgICB2YXIgaW50ZXJuYWxBcnJheSA9IFtdOwogICAgICAgICAgICB2YXIgaW50ZXJuYWxPYmplY3QgPSB7fTsKICAgICAgICAgICAgdmFyIGluaXRSdW4gPSB0cnVlOwogICAgICAgICAgICB2YXIgb2xkTGVuZ3RoID0gMDsKCiAgICAgICAgICAgIGZ1bmN0aW9uICR3YXRjaENvbGxlY3Rpb25XYXRjaCgpIHsKICAgICAgICAgICAgICBuZXdWYWx1ZSA9IG9iakdldHRlcihzZWxmKTsKICAgICAgICAgICAgICB2YXIgbmV3TGVuZ3RoLCBrZXk7CgogICAgICAgICAgICAgIGlmICghaXNPYmplY3QobmV3VmFsdWUpKSB7IC8vIGlmIHByaW1pdGl2ZQogICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBuZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgICBvbGRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheUxpa2UobmV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkVmFsdWUgIT09IGludGVybmFsQXJyYXkpIHsKICAgICAgICAgICAgICAgICAgLy8gd2UgYXJlIHRyYW5zaXRpb25pbmcgZnJvbSBzb21ldGhpbmcgd2hpY2ggd2FzIG5vdCBhbiBhcnJheSBpbnRvIGFycmF5LgogICAgICAgICAgICAgICAgICBvbGRWYWx1ZSA9IGludGVybmFsQXJyYXk7CiAgICAgICAgICAgICAgICAgIG9sZExlbmd0aCA9IG9sZFZhbHVlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICAgIGNoYW5nZURldGVjdGVkKys7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbmV3TGVuZ3RoID0gbmV3VmFsdWUubGVuZ3RoOwoKICAgICAgICAgICAgICAgIGlmIChvbGRMZW5ndGggIT09IG5ld0xlbmd0aCkgewogICAgICAgICAgICAgICAgICAvLyBpZiBsZW5ndGhzIGRvIG5vdCBtYXRjaCB3ZSBuZWVkIHRvIHRyaWdnZXIgY2hhbmdlIG5vdGlmaWNhdGlvbgogICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgICBvbGRWYWx1ZS5sZW5ndGggPSBvbGRMZW5ndGggPSBuZXdMZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBjb3B5IHRoZSBpdGVtcyB0byBvbGRWYWx1ZSBhbmQgbG9vayBmb3IgY2hhbmdlcy4KICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3TGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGJvdGhOYU4gPSAob2xkVmFsdWVbaV0gIT09IG9sZFZhbHVlW2ldKSAmJgogICAgICAgICAgICAgICAgICAgIChuZXdWYWx1ZVtpXSAhPT0gbmV3VmFsdWVbaV0pOwogICAgICAgICAgICAgICAgICBpZiAoIWJvdGhOYU4gJiYgKG9sZFZhbHVlW2ldICE9PSBuZXdWYWx1ZVtpXSkpIHsKICAgICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgICAgIG9sZFZhbHVlW2ldID0gbmV3VmFsdWVbaV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBpbnRlcm5hbE9iamVjdCkgewogICAgICAgICAgICAgICAgICAvLyB3ZSBhcmUgdHJhbnNpdGlvbmluZyBmcm9tIHNvbWV0aGluZyB3aGljaCB3YXMgbm90IGFuIG9iamVjdCBpbnRvIG9iamVjdC4KICAgICAgICAgICAgICAgICAgb2xkVmFsdWUgPSBpbnRlcm5hbE9iamVjdCA9IHt9OwogICAgICAgICAgICAgICAgICBvbGRMZW5ndGggPSAwOwogICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gY29weSB0aGUgaXRlbXMgdG8gb2xkVmFsdWUgYW5kIGxvb2sgZm9yIGNoYW5nZXMuCiAgICAgICAgICAgICAgICBuZXdMZW5ndGggPSAwOwogICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld1ZhbHVlLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICBuZXdMZW5ndGgrKzsKICAgICAgICAgICAgICAgICAgICBpZiAob2xkVmFsdWUuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlW2tleV0gIT09IG5ld1ZhbHVlW2tleV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlRGV0ZWN0ZWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWVba2V5XSA9IG5ld1ZhbHVlW2tleV07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIG9sZExlbmd0aCsrOwogICAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWVba2V5XSA9IG5ld1ZhbHVlW2tleV07CiAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9sZExlbmd0aCA+IG5ld0xlbmd0aCkgewogICAgICAgICAgICAgICAgICAvLyB3ZSB1c2VkIHRvIGhhdmUgbW9yZSBrZXlzLCBuZWVkIHRvIGZpbmQgdGhlbSBhbmQgZGVzdHJveSB0aGVtLgogICAgICAgICAgICAgICAgICBjaGFuZ2VEZXRlY3RlZCsrOwogICAgICAgICAgICAgICAgICBmb3Ioa2V5IGluIG9sZFZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9sZFZhbHVlLmhhc093blByb3BlcnR5KGtleSkgJiYgIW5ld1ZhbHVlLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgIG9sZExlbmd0aC0tOwogICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG9sZFZhbHVlW2tleV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBjaGFuZ2VEZXRlY3RlZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gJHdhdGNoQ29sbGVjdGlvbkFjdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoaW5pdFJ1bikgewogICAgICAgICAgICAgICAgaW5pdFJ1biA9IGZhbHNlOwogICAgICAgICAgICAgICAgbGlzdGVuZXIobmV3VmFsdWUsIG5ld1ZhbHVlLCBzZWxmKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGlzdGVuZXIobmV3VmFsdWUsIHZlcnlPbGRWYWx1ZSwgc2VsZik7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBtYWtlIGEgY29weSBmb3IgdGhlIG5leHQgdGltZSBhIGNvbGxlY3Rpb24gaXMgY2hhbmdlZAogICAgICAgICAgICAgIGlmICh0cmFja1ZlcnlPbGRWYWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFpc09iamVjdChuZXdWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgLy9wcmltaXRpdmUKICAgICAgICAgICAgICAgICAgdmVyeU9sZFZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXlMaWtlKG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgICB2ZXJ5T2xkVmFsdWUgPSBuZXcgQXJyYXkobmV3VmFsdWUubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdWYWx1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZlcnlPbGRWYWx1ZVtpXSA9IG5ld1ZhbHVlW2ldOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBpZiBvYmplY3QKICAgICAgICAgICAgICAgICAgdmVyeU9sZFZhbHVlID0ge307CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBuZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG5ld1ZhbHVlLCBrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICB2ZXJ5T2xkVmFsdWVba2V5XSA9IG5ld1ZhbHVlW2tleV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpcy4kd2F0Y2goJHdhdGNoQ29sbGVjdGlvbldhdGNoLCAkd2F0Y2hDb2xsZWN0aW9uQWN0aW9uKTsKICAgICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QKICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBQcm9jZXNzZXMgYWxsIG9mIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkd2F0Y2ggd2F0Y2hlcnN9IG9mIHRoZSBjdXJyZW50IHNjb3BlIGFuZAogICAgICAgICAgICogaXRzIGNoaWxkcmVuLiBCZWNhdXNlIGEge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJ9J3MgbGlzdGVuZXIgY2FuIGNoYW5nZQogICAgICAgICAgICogdGhlIG1vZGVsLCB0aGUgYCRkaWdlc3QoKWAga2VlcHMgY2FsbGluZyB0aGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNoZXJzfQogICAgICAgICAgICogdW50aWwgbm8gbW9yZSBsaXN0ZW5lcnMgYXJlIGZpcmluZy4gVGhpcyBtZWFucyB0aGF0IGl0IGlzIHBvc3NpYmxlIHRvIGdldCBpbnRvIGFuIGluZmluaXRlCiAgICAgICAgICAgKiBsb29wLiBUaGlzIGZ1bmN0aW9uIHdpbGwgdGhyb3cgYCdNYXhpbXVtIGl0ZXJhdGlvbiBsaW1pdCBleGNlZWRlZC4nYCBpZiB0aGUgbnVtYmVyIG9mCiAgICAgICAgICAgKiBpdGVyYXRpb25zIGV4Y2VlZHMgMTAuCiAgICAgICAgICAgKgogICAgICAgICAgICogVXN1YWxseSwgeW91IGRvbid0IGNhbGwgYCRkaWdlc3QoKWAgZGlyZWN0bHkgaW4KICAgICAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDb250cm9sbGVyIGNvbnRyb2xsZXJzfSBvciBpbgogICAgICAgICAgICoge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIjZGlyZWN0aXZlIGRpcmVjdGl2ZXN9LgogICAgICAgICAgICogSW5zdGVhZCwgeW91IHNob3VsZCBjYWxsIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRhcHBseSAkYXBwbHkoKX0gKHR5cGljYWxseSBmcm9tIHdpdGhpbgogICAgICAgICAgICogYSB7QGxpbmsgbmcuJGNvbXBpbGVQcm92aWRlciNkaXJlY3RpdmUgZGlyZWN0aXZlc30pLCB3aGljaCB3aWxsIGZvcmNlIGEgYCRkaWdlc3QoKWAuCiAgICAgICAgICAgKgogICAgICAgICAgICogSWYgeW91IHdhbnQgdG8gYmUgbm90aWZpZWQgd2hlbmV2ZXIgYCRkaWdlc3QoKWAgaXMgY2FsbGVkLAogICAgICAgICAgICogeW91IGNhbiByZWdpc3RlciBhIGB3YXRjaEV4cHJlc3Npb25gIGZ1bmN0aW9uIHdpdGgKICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyR3YXRjaCAkd2F0Y2goKX0gd2l0aCBubyBgbGlzdGVuZXJgLgogICAgICAgICAgICoKICAgICAgICAgICAqIEluIHVuaXQgdGVzdHMsIHlvdSBtYXkgbmVlZCB0byBjYWxsIGAkZGlnZXN0KClgIHRvIHNpbXVsYXRlIHRoZSBzY29wZSBsaWZlIGN5Y2xlLgogICAgICAgICAgICoKICAgICAgICAgICAqICMgRXhhbXBsZQogICAgICAgICAgICogYGBganMKICAgICAgICAgICB2YXIgc2NvcGUgPSAuLi47CiAgICAgICAgICAgc2NvcGUubmFtZSA9ICdtaXNrbyc7CiAgICAgICAgICAgc2NvcGUuY291bnRlciA9IDA7CgogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwogICAgICAgICAgIHNjb3BlLiR3YXRjaCgnbmFtZScsIGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgc2NvcGUuY291bnRlciA9IHNjb3BlLmNvdW50ZXIgKyAxOwogICAgICAgICAgIH0pOwogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDApOwoKICAgICAgICAgICBzY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgLy8gdGhlIGxpc3RlbmVyIGlzIGFsd2F5cyBjYWxsZWQgZHVyaW5nIHRoZSBmaXJzdCAkZGlnZXN0IGxvb3AgYWZ0ZXIgaXQgd2FzIHJlZ2lzdGVyZWQKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgxKTsKCiAgICAgICAgICAgc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgIC8vIGJ1dCBub3cgaXQgd2lsbCBub3QgYmUgY2FsbGVkIHVubGVzcyB0aGUgdmFsdWUgY2hhbmdlcwogICAgICAgICAgIGV4cGVjdChzY29wZS5jb3VudGVyKS50b0VxdWFsKDEpOwoKICAgICAgICAgICBzY29wZS5uYW1lID0gJ2FkYW0nOwogICAgICAgICAgIHNjb3BlLiRkaWdlc3QoKTsKICAgICAgICAgICBleHBlY3Qoc2NvcGUuY291bnRlcikudG9FcXVhbCgyKTsKICAgICAgICAgICAqIGBgYAogICAgICAgICAgICoKICAgICAgICAgICAqLwogICAgICAgICAgJGRpZ2VzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB3YXRjaCwgdmFsdWUsIGxhc3QsCiAgICAgICAgICAgICAgd2F0Y2hlcnMsCiAgICAgICAgICAgICAgYXN5bmNRdWV1ZSA9IHRoaXMuJCRhc3luY1F1ZXVlLAogICAgICAgICAgICAgIHBvc3REaWdlc3RRdWV1ZSA9IHRoaXMuJCRwb3N0RGlnZXN0UXVldWUsCiAgICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICAgIGRpcnR5LCB0dGwgPSBUVEwsCiAgICAgICAgICAgICAgbmV4dCwgY3VycmVudCwgdGFyZ2V0ID0gdGhpcywKICAgICAgICAgICAgICB3YXRjaExvZyA9IFtdLAogICAgICAgICAgICAgIGxvZ0lkeCwgbG9nTXNnLCBhc3luY1Rhc2s7CgogICAgICAgICAgICBiZWdpblBoYXNlKCckZGlnZXN0Jyk7CgogICAgICAgICAgICBsYXN0RGlydHlXYXRjaCA9IG51bGw7CgogICAgICAgICAgICBkbyB7IC8vICJ3aGlsZSBkaXJ0eSIgbG9vcAogICAgICAgICAgICAgIGRpcnR5ID0gZmFsc2U7CiAgICAgICAgICAgICAgY3VycmVudCA9IHRhcmdldDsKCiAgICAgICAgICAgICAgd2hpbGUoYXN5bmNRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGFzeW5jVGFzayA9IGFzeW5jUXVldWUuc2hpZnQoKTsKICAgICAgICAgICAgICAgICAgYXN5bmNUYXNrLnNjb3BlLiRldmFsKGFzeW5jVGFzay5leHByZXNzaW9uKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3REaXJ0eVdhdGNoID0gbnVsbDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHRyYXZlcnNlU2NvcGVzTG9vcDoKICAgICAgICAgICAgICAgIGRvIHsgLy8gInRyYXZlcnNlIHRoZSBzY29wZXMiIGxvb3AKICAgICAgICAgICAgICAgICAgaWYgKCh3YXRjaGVycyA9IGN1cnJlbnQuJCR3YXRjaGVycykpIHsKICAgICAgICAgICAgICAgICAgICAvLyBwcm9jZXNzIG91ciB3YXRjaGVzCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gd2F0Y2hlcnMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2ggPSB3YXRjaGVyc1tsZW5ndGhdOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBNb3N0IGNvbW1vbiB3YXRjaGVzIGFyZSBvbiBwcmltaXRpdmVzLCBpbiB3aGljaCBjYXNlIHdlIGNhbiBzaG9ydAogICAgICAgICAgICAgICAgICAgICAgICAvLyBjaXJjdWl0IGl0IHdpdGggPT09IG9wZXJhdG9yLCBvbmx5IHdoZW4gPT09IGZhaWxzIGRvIHdlIHVzZSAuZXF1YWxzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3YXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodmFsdWUgPSB3YXRjaC5nZXQoY3VycmVudCkpICE9PSAobGFzdCA9IHdhdGNoLmxhc3QpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAhKHdhdGNoLmVxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZXF1YWxzKHZhbHVlLCBsYXN0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICh0eXBlb2YgdmFsdWUgPT0gJ251bWJlcicgJiYgdHlwZW9mIGxhc3QgPT0gJ251bWJlcicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJiYgaXNOYU4odmFsdWUpICYmIGlzTmFOKGxhc3QpKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcnR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3REaXJ0eVdhdGNoID0gd2F0Y2g7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaC5sYXN0ID0gd2F0Y2guZXEgPyBjb3B5KHZhbHVlLCBudWxsKSA6IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2guZm4odmFsdWUsICgobGFzdCA9PT0gaW5pdFdhdGNoVmFsKSA/IHZhbHVlIDogbGFzdCksIGN1cnJlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR0bCA8IDUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nSWR4ID0gNCAtIHR0bDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF3YXRjaExvZ1tsb2dJZHhdKSB3YXRjaExvZ1tsb2dJZHhdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ01zZyA9IChpc0Z1bmN0aW9uKHdhdGNoLmV4cCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAnZm46ICcgKyAod2F0Y2guZXhwLm5hbWUgfHwgd2F0Y2guZXhwLnRvU3RyaW5nKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB3YXRjaC5leHA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ01zZyArPSAnOyBuZXdWYWw6ICcgKyB0b0pzb24odmFsdWUpICsgJzsgb2xkVmFsOiAnICsgdG9Kc29uKGxhc3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YXRjaExvZ1tsb2dJZHhdLnB1c2gobG9nTXNnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHdhdGNoID09PSBsYXN0RGlydHlXYXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIG1vc3QgcmVjZW50bHkgZGlydHkgd2F0Y2hlciBpcyBub3cgY2xlYW4sIHNob3J0IGNpcmN1aXQgc2luY2UgdGhlIHJlbWFpbmluZyB3YXRjaGVycwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGF2ZSBhbHJlYWR5IGJlZW4gdGVzdGVkLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIHRyYXZlcnNlU2NvcGVzTG9vcDsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJQaGFzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIC8vIEluc2FuaXR5IFdhcm5pbmc6IHNjb3BlIGRlcHRoLWZpcnN0IHRyYXZlcnNhbAogICAgICAgICAgICAgICAgICAvLyB5ZXMsIHRoaXMgY29kZSBpcyBhIGJpdCBjcmF6eSwgYnV0IGl0IHdvcmtzIGFuZCB3ZSBoYXZlIHRlc3RzIHRvIHByb3ZlIGl0IQogICAgICAgICAgICAgICAgICAvLyB0aGlzIHBpZWNlIHNob3VsZCBiZSBrZXB0IGluIHN5bmMgd2l0aCB0aGUgdHJhdmVyc2FsIGluICRicm9hZGNhc3QKICAgICAgICAgICAgICAgICAgaWYgKCEobmV4dCA9IChjdXJyZW50LiQkY2hpbGRIZWFkIHx8CiAgICAgICAgICAgICAgICAgICAgKGN1cnJlbnQgIT09IHRhcmdldCAmJiBjdXJyZW50LiQkbmV4dFNpYmxpbmcpKSkpIHsKICAgICAgICAgICAgICAgICAgICB3aGlsZShjdXJyZW50ICE9PSB0YXJnZXQgJiYgIShuZXh0ID0gY3VycmVudC4kJG5leHRTaWJsaW5nKSkgewogICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQuJHBhcmVudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gd2hpbGUgKChjdXJyZW50ID0gbmV4dCkpOwoKICAgICAgICAgICAgICAvLyBgYnJlYWsgdHJhdmVyc2VTY29wZXNMb29wO2AgdGFrZXMgdXMgdG8gaGVyZQoKICAgICAgICAgICAgICBpZigoZGlydHkgfHwgYXN5bmNRdWV1ZS5sZW5ndGgpICYmICEodHRsLS0pKSB7CiAgICAgICAgICAgICAgICBjbGVhclBoYXNlKCk7CiAgICAgICAgICAgICAgICB0aHJvdyAkcm9vdFNjb3BlTWluRXJyKCdpbmZkaWcnLAogICAgICAgICAgICAgICAgICAgICd7MH0gJGRpZ2VzdCgpIGl0ZXJhdGlvbnMgcmVhY2hlZC4gQWJvcnRpbmchXG4nICsKICAgICAgICAgICAgICAgICAgICAnV2F0Y2hlcnMgZmlyZWQgaW4gdGhlIGxhc3QgNSBpdGVyYXRpb25zOiB7MX0nLAogICAgICAgICAgICAgICAgICBUVEwsIHRvSnNvbih3YXRjaExvZykpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gd2hpbGUgKGRpcnR5IHx8IGFzeW5jUXVldWUubGVuZ3RoKTsKCiAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKCiAgICAgICAgICAgIHdoaWxlKHBvc3REaWdlc3RRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcG9zdERpZ2VzdFF1ZXVlLnNoaWZ0KCkoKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCgoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRkZXN0cm95CiAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiBzY29wZSBiZWluZyBkZXN0cm95ZWQKICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIEJyb2FkY2FzdGVkIHdoZW4gYSBzY29wZSBhbmQgaXRzIGNoaWxkcmVuIGFyZSBiZWluZyBkZXN0cm95ZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogTm90ZSB0aGF0LCBpbiBBbmd1bGFySlMsIHRoZXJlIGlzIGFsc28gYSBgJGRlc3Ryb3lgIGpRdWVyeSBldmVudCwgd2hpY2ggY2FuIGJlIHVzZWQgdG8KICAgICAgICAgICAqIGNsZWFuIHVwIERPTSBiaW5kaW5ncyBiZWZvcmUgYW4gZWxlbWVudCBpcyByZW1vdmVkIGZyb20gdGhlIERPTS4KICAgICAgICAgICAqLwoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkZGVzdHJveQogICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFJlbW92ZXMgdGhlIGN1cnJlbnQgc2NvcGUgKGFuZCBhbGwgb2YgaXRzIGNoaWxkcmVuKSBmcm9tIHRoZSBwYXJlbnQgc2NvcGUuIFJlbW92YWwgaW1wbGllcwogICAgICAgICAgICogdGhhdCBjYWxscyB0byB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QoKX0gd2lsbCBubyBsb25nZXIKICAgICAgICAgICAqIHByb3BhZ2F0ZSB0byB0aGUgY3VycmVudCBzY29wZSBhbmQgaXRzIGNoaWxkcmVuLiBSZW1vdmFsIGFsc28gaW1wbGllcyB0aGF0IHRoZSBjdXJyZW50CiAgICAgICAgICAgKiBzY29wZSBpcyBlbGlnaWJsZSBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoZSBgJGRlc3Ryb3koKWAgaXMgdXN1YWxseSB1c2VkIGJ5IGRpcmVjdGl2ZXMgc3VjaCBhcwogICAgICAgICAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBuZ1JlcGVhdH0gZm9yIG1hbmFnaW5nIHRoZQogICAgICAgICAgICogdW5yb2xsaW5nIG9mIHRoZSBsb29wLgogICAgICAgICAgICoKICAgICAgICAgICAqIEp1c3QgYmVmb3JlIGEgc2NvcGUgaXMgZGVzdHJveWVkLCBhIGAkZGVzdHJveWAgZXZlbnQgaXMgYnJvYWRjYXN0ZWQgb24gdGhpcyBzY29wZS4KICAgICAgICAgICAqIEFwcGxpY2F0aW9uIGNvZGUgY2FuIHJlZ2lzdGVyIGEgYCRkZXN0cm95YCBldmVudCBoYW5kbGVyIHRoYXQgd2lsbCBnaXZlIGl0IGEgY2hhbmNlIHRvCiAgICAgICAgICAgKiBwZXJmb3JtIGFueSBuZWNlc3NhcnkgY2xlYW51cC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBOb3RlIHRoYXQsIGluIEFuZ3VsYXJKUywgdGhlcmUgaXMgYWxzbyBhIGAkZGVzdHJveWAgalF1ZXJ5IGV2ZW50LCB3aGljaCBjYW4gYmUgdXNlZCB0bwogICAgICAgICAgICogY2xlYW4gdXAgRE9NIGJpbmRpbmdzIGJlZm9yZSBhbiBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NLgogICAgICAgICAgICovCiAgICAgICAgICAkZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIHdlIGNhbid0IGRlc3Ryb3kgdGhlIHJvb3Qgc2NvcGUgb3IgYSBzY29wZSB0aGF0IGhhcyBiZWVuIGFscmVhZHkgZGVzdHJveWVkCiAgICAgICAgICAgIGlmICh0aGlzLiQkZGVzdHJveWVkKSByZXR1cm47CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzLiRwYXJlbnQ7CgogICAgICAgICAgICB0aGlzLiRicm9hZGNhc3QoJyRkZXN0cm95Jyk7CiAgICAgICAgICAgIHRoaXMuJCRkZXN0cm95ZWQgPSB0cnVlOwogICAgICAgICAgICBpZiAodGhpcyA9PT0gJHJvb3RTY29wZSkgcmV0dXJuOwoKICAgICAgICAgICAgZm9yRWFjaCh0aGlzLiQkbGlzdGVuZXJDb3VudCwgYmluZChudWxsLCBkZWNyZW1lbnRMaXN0ZW5lckNvdW50LCB0aGlzKSk7CgogICAgICAgICAgICAvLyBzZXZlciBhbGwgdGhlIHJlZmVyZW5jZXMgdG8gcGFyZW50IHNjb3BlcyAoYWZ0ZXIgdGhpcyBjbGVhbnVwLCB0aGUgY3VycmVudCBzY29wZSBzaG91bGQKICAgICAgICAgICAgLy8gbm90IGJlIHJldGFpbmVkIGJ5IGFueSBvZiBvdXIgcmVmZXJlbmNlcyBhbmQgc2hvdWxkIGJlIGVsaWdpYmxlIGZvciBnYXJiYWdlIGNvbGxlY3Rpb24pCiAgICAgICAgICAgIGlmIChwYXJlbnQuJCRjaGlsZEhlYWQgPT0gdGhpcykgcGFyZW50LiQkY2hpbGRIZWFkID0gdGhpcy4kJG5leHRTaWJsaW5nOwogICAgICAgICAgICBpZiAocGFyZW50LiQkY2hpbGRUYWlsID09IHRoaXMpIHBhcmVudC4kJGNoaWxkVGFpbCA9IHRoaXMuJCRwcmV2U2libGluZzsKICAgICAgICAgICAgaWYgKHRoaXMuJCRwcmV2U2libGluZykgdGhpcy4kJHByZXZTaWJsaW5nLiQkbmV4dFNpYmxpbmcgPSB0aGlzLiQkbmV4dFNpYmxpbmc7CiAgICAgICAgICAgIGlmICh0aGlzLiQkbmV4dFNpYmxpbmcpIHRoaXMuJCRuZXh0U2libGluZy4kJHByZXZTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nOwoKCiAgICAgICAgICAgIC8vIEFsbCBvZiB0aGUgY29kZSBiZWxvdyBpcyBib2d1cyBjb2RlIHRoYXQgd29ya3MgYXJvdW5kIFY4J3MgbWVtb3J5IGxlYWsgdmlhIG9wdGltaXplZCBjb2RlCiAgICAgICAgICAgIC8vIGFuZCBpbmxpbmUgY2FjaGVzLgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBzZWU6CiAgICAgICAgICAgIC8vIC0gaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTIwNzMjYzI2CiAgICAgICAgICAgIC8vIC0gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvNjc5NCNpc3N1ZWNvbW1lbnQtMzg2NDg5MDkKICAgICAgICAgICAgLy8gLSBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy8xMzEzI2lzc3VlY29tbWVudC0xMDM3ODQ1MQoKICAgICAgICAgICAgdGhpcy4kcGFyZW50ID0gdGhpcy4kJG5leHRTaWJsaW5nID0gdGhpcy4kJHByZXZTaWJsaW5nID0gdGhpcy4kJGNoaWxkSGVhZCA9CiAgICAgICAgICAgICAgdGhpcy4kJGNoaWxkVGFpbCA9IHRoaXMuJHJvb3QgPSBudWxsOwoKICAgICAgICAgICAgLy8gZG9uJ3QgcmVzZXQgdGhlc2UgdG8gbnVsbCBpbiBjYXNlIHNvbWUgYXN5bmMgdGFzayB0cmllcyB0byByZWdpc3RlciBhIGxpc3RlbmVyL3dhdGNoL3Rhc2sKICAgICAgICAgICAgdGhpcy4kJGxpc3RlbmVycyA9IHt9OwogICAgICAgICAgICB0aGlzLiQkd2F0Y2hlcnMgPSB0aGlzLiQkYXN5bmNRdWV1ZSA9IHRoaXMuJCRwb3N0RGlnZXN0UXVldWUgPSBbXTsKCiAgICAgICAgICAgIC8vIHByZXZlbnQgTlBFcyBzaW5jZSB0aGVzZSBtZXRob2RzIGhhdmUgcmVmZXJlbmNlcyB0byBwcm9wZXJ0aWVzIHdlIG51bGxlZCBvdXQKICAgICAgICAgICAgdGhpcy4kZGVzdHJveSA9IHRoaXMuJGRpZ2VzdCA9IHRoaXMuJGFwcGx5ID0gbm9vcDsKICAgICAgICAgICAgdGhpcy4kb24gPSB0aGlzLiR3YXRjaCA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gbm9vcDsgfTsKICAgICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRldmFsCiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogRXhlY3V0ZXMgdGhlIGBleHByZXNzaW9uYCBvbiB0aGUgY3VycmVudCBzY29wZSBhbmQgcmV0dXJucyB0aGUgcmVzdWx0LiBBbnkgZXhjZXB0aW9ucyBpbgogICAgICAgICAgICogdGhlIGV4cHJlc3Npb24gYXJlIHByb3BhZ2F0ZWQgKHVuY2F1Z2h0KS4gVGhpcyBpcyB1c2VmdWwgd2hlbiBldmFsdWF0aW5nIEFuZ3VsYXIKICAgICAgICAgICAqIGV4cHJlc3Npb25zLgogICAgICAgICAgICoKICAgICAgICAgICAqICMgRXhhbXBsZQogICAgICAgICAgICogYGBganMKICAgICAgICAgICB2YXIgc2NvcGUgPSBuZy4kcm9vdFNjb3BlLlNjb3BlKCk7CiAgICAgICAgICAgc2NvcGUuYSA9IDE7CiAgICAgICAgICAgc2NvcGUuYiA9IDI7CgogICAgICAgICAgIGV4cGVjdChzY29wZS4kZXZhbCgnYStiJykpLnRvRXF1YWwoMyk7CiAgICAgICAgICAgZXhwZWN0KHNjb3BlLiRldmFsKGZ1bmN0aW9uKHNjb3BlKXsgcmV0dXJuIHNjb3BlLmEgKyBzY29wZS5iOyB9KSkudG9FcXVhbCgzKTsKICAgICAgICAgICAqIGBgYAogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cHJlc3Npb24gQW4gYW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkLgogICAgICAgICAgICoKICAgICAgICAgICAqICAgIC0gYHN0cmluZ2A6IGV4ZWN1dGUgdXNpbmcgdGhlIHJ1bGVzIGFzIGRlZmluZWQgaW4gIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogZXhlY3V0ZSB0aGUgZnVuY3Rpb24gd2l0aCB0aGUgY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0geyhvYmplY3QpPX0gbG9jYWxzIExvY2FsIHZhcmlhYmxlcyBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4gc2NvcGUuCiAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBleHByZXNzaW9uLgogICAgICAgICAgICovCiAgICAgICAgICAkZXZhbDogZnVuY3Rpb24oZXhwciwgbG9jYWxzKSB7CiAgICAgICAgICAgIHJldHVybiAkcGFyc2UoZXhwcikodGhpcywgbG9jYWxzKTsKICAgICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkcm9vdFNjb3BlLlNjb3BlIyRldmFsQXN5bmMKICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBFeGVjdXRlcyB0aGUgZXhwcmVzc2lvbiBvbiB0aGUgY3VycmVudCBzY29wZSBhdCBhIGxhdGVyIHBvaW50IGluIHRpbWUuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhlIGAkZXZhbEFzeW5jYCBtYWtlcyBubyBndWFyYW50ZWVzIGFzIHRvIHdoZW4gdGhlIGBleHByZXNzaW9uYCB3aWxsIGJlIGV4ZWN1dGVkLCBvbmx5CiAgICAgICAgICAgKiB0aGF0OgogICAgICAgICAgICoKICAgICAgICAgICAqICAgLSBpdCB3aWxsIGV4ZWN1dGUgYWZ0ZXIgdGhlIGZ1bmN0aW9uIHRoYXQgc2NoZWR1bGVkIHRoZSBldmFsdWF0aW9uIChwcmVmZXJhYmx5IGJlZm9yZSBET00KICAgICAgICAgICAqICAgICByZW5kZXJpbmcpLgogICAgICAgICAgICogICAtIGF0IGxlYXN0IG9uZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0ICRkaWdlc3QgY3ljbGV9IHdpbGwgYmUgcGVyZm9ybWVkIGFmdGVyCiAgICAgICAgICAgKiAgICAgYGV4cHJlc3Npb25gIGV4ZWN1dGlvbi4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBBbnkgZXhjZXB0aW9ucyBmcm9tIHRoZSBleGVjdXRpb24gb2YgdGhlIGV4cHJlc3Npb24gYXJlIGZvcndhcmRlZCB0byB0aGUKICAgICAgICAgICAqIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBfX05vdGU6X18gaWYgdGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgb3V0c2lkZSBvZiBhIGAkZGlnZXN0YCBjeWNsZSwgYSBuZXcgYCRkaWdlc3RgIGN5Y2xlCiAgICAgICAgICAgKiB3aWxsIGJlIHNjaGVkdWxlZC4gSG93ZXZlciwgaXQgaXMgZW5jb3VyYWdlZCB0byBhbHdheXMgY2FsbCBjb2RlIHRoYXQgY2hhbmdlcyB0aGUgbW9kZWwKICAgICAgICAgICAqIGZyb20gd2l0aGluIGFuIGAkYXBwbHlgIGNhbGwuIFRoYXQgaW5jbHVkZXMgY29kZSBldmFsdWF0ZWQgdmlhIGAkZXZhbEFzeW5jYC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0geyhzdHJpbmd8ZnVuY3Rpb24oKSk9fSBleHByZXNzaW9uIEFuIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiAgICAtIGBzdHJpbmdgOiBleGVjdXRlIHVzaW5nIHRoZSBydWxlcyBhcyBkZWZpbmVkIGluIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259LgogICAgICAgICAgICogICAgLSBgZnVuY3Rpb24oc2NvcGUpYDogZXhlY3V0ZSB0aGUgZnVuY3Rpb24gd2l0aCB0aGUgY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICAgICAqCiAgICAgICAgICAgKi8KICAgICAgICAgICRldmFsQXN5bmM6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgICAgICAgLy8gaWYgd2UgYXJlIG91dHNpZGUgb2YgYW4gJGRpZ2VzdCBsb29wIGFuZCB0aGlzIGlzIHRoZSBmaXJzdCB0aW1lIHdlIGFyZSBzY2hlZHVsaW5nIGFzeW5jCiAgICAgICAgICAgIC8vIHRhc2sgYWxzbyBzY2hlZHVsZSBhc3luYyBhdXRvLWZsdXNoCiAgICAgICAgICAgIGlmICghJHJvb3RTY29wZS4kJHBoYXNlICYmICEkcm9vdFNjb3BlLiQkYXN5bmNRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICgkcm9vdFNjb3BlLiQkYXN5bmNRdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuJCRhc3luY1F1ZXVlLnB1c2goe3Njb3BlOiB0aGlzLCBleHByZXNzaW9uOiBleHByfSk7CiAgICAgICAgICB9LAoKICAgICAgICAgICQkcG9zdERpZ2VzdCA6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgIHRoaXMuJCRwb3N0RGlnZXN0UXVldWUucHVzaChmbik7CiAgICAgICAgICB9LAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkYXBwbHkKICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBgJGFwcGx5KClgIGlzIHVzZWQgdG8gZXhlY3V0ZSBhbiBleHByZXNzaW9uIGluIGFuZ3VsYXIgZnJvbSBvdXRzaWRlIG9mIHRoZSBhbmd1bGFyCiAgICAgICAgICAgKiBmcmFtZXdvcmsuIChGb3IgZXhhbXBsZSBmcm9tIGJyb3dzZXIgRE9NIGV2ZW50cywgc2V0VGltZW91dCwgWEhSIG9yIHRoaXJkIHBhcnR5IGxpYnJhcmllcykuCiAgICAgICAgICAgKiBCZWNhdXNlIHdlIGFyZSBjYWxsaW5nIGludG8gdGhlIGFuZ3VsYXIgZnJhbWV3b3JrIHdlIG5lZWQgdG8gcGVyZm9ybSBwcm9wZXIgc2NvcGUgbGlmZQogICAgICAgICAgICogY3ljbGUgb2Yge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyIGV4Y2VwdGlvbiBoYW5kbGluZ30sCiAgICAgICAgICAgKiB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkZGlnZXN0IGV4ZWN1dGluZyB3YXRjaGVzfS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiAjIyBMaWZlIGN5Y2xlCiAgICAgICAgICAgKgogICAgICAgICAgICogIyBQc2V1ZG8tQ29kZSBvZiBgJGFwcGx5KClgCiAgICAgICAgICAgKiBgYGBqcwogICAgICAgICAgIGZ1bmN0aW9uICRhcHBseShleHByKSB7CiAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICByZXR1cm4gJGV2YWwoZXhwcik7CiAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgJHJvb3QuJGRpZ2VzdCgpOwogICAgICAgICAgICAgfQogICAgICAgICAgIH0KICAgICAgICAgICAqIGBgYAogICAgICAgICAgICoKICAgICAgICAgICAqCiAgICAgICAgICAgKiBTY29wZSdzIGAkYXBwbHkoKWAgbWV0aG9kIHRyYW5zaXRpb25zIHRocm91Z2ggdGhlIGZvbGxvd2luZyBzdGFnZXM6CiAgICAgICAgICAgKgogICAgICAgICAgICogMS4gVGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIGV4ZWN1dGVkIHVzaW5nIHRoZQogICAgICAgICAgICogICAge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGV2YWwgJGV2YWwoKX0gbWV0aG9kLgogICAgICAgICAgICogMi4gQW55IGV4Y2VwdGlvbnMgZnJvbSB0aGUgZXhlY3V0aW9uIG9mIHRoZSBleHByZXNzaW9uIGFyZSBmb3J3YXJkZWQgdG8gdGhlCiAgICAgICAgICAgKiAgICB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgKiAzLiBUaGUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJHdhdGNoIHdhdGNofSBsaXN0ZW5lcnMgYXJlIGZpcmVkIGltbWVkaWF0ZWx5IGFmdGVyIHRoZQogICAgICAgICAgICogICAgZXhwcmVzc2lvbiB3YXMgZXhlY3V0ZWQgdXNpbmcgdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRkaWdlc3QgJGRpZ2VzdCgpfSBtZXRob2QuCiAgICAgICAgICAgKgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7KHN0cmluZ3xmdW5jdGlvbigpKT19IGV4cCBBbiBhbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogICAgLSBgc3RyaW5nYDogZXhlY3V0ZSB1c2luZyB0aGUgcnVsZXMgYXMgZGVmaW5lZCBpbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufS4KICAgICAgICAgICAqICAgIC0gYGZ1bmN0aW9uKHNjb3BlKWA6IGV4ZWN1dGUgdGhlIGZ1bmN0aW9uIHdpdGggY3VycmVudCBgc2NvcGVgIHBhcmFtZXRlci4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJlc3VsdCBvZiBldmFsdWF0aW5nIHRoZSBleHByZXNzaW9uLgogICAgICAgICAgICovCiAgICAgICAgICAkYXBwbHk6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBiZWdpblBoYXNlKCckYXBwbHknKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy4kZXZhbChleHByKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGNsZWFyUGhhc2UoKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kZGlnZXN0KCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJG9uCiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogTGlzdGVucyBvbiBldmVudHMgb2YgYSBnaXZlbiB0eXBlLiBTZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJGVtaXQgJGVtaXR9IGZvcgogICAgICAgICAgICogZGlzY3Vzc2lvbiBvZiBldmVudCBsaWZlIGN5Y2xlLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoZSBldmVudCBsaXN0ZW5lciBmdW5jdGlvbiBmb3JtYXQgaXM6IGBmdW5jdGlvbihldmVudCwgYXJncy4uLilgLiBUaGUgYGV2ZW50YCBvYmplY3QKICAgICAgICAgICAqIHBhc3NlZCBpbnRvIHRoZSBsaXN0ZW5lciBoYXMgdGhlIGZvbGxvd2luZyBhdHRyaWJ1dGVzOgogICAgICAgICAgICoKICAgICAgICAgICAqICAgLSBgdGFyZ2V0U2NvcGVgIC0gYHtTY29wZX1gOiB0aGUgc2NvcGUgb24gd2hpY2ggdGhlIGV2ZW50IHdhcyBgJGVtaXRgLWVkIG9yCiAgICAgICAgICAgKiAgICAgYCRicm9hZGNhc3RgLWVkLgogICAgICAgICAgICogICAtIGBjdXJyZW50U2NvcGVgIC0gYHtTY29wZX1gOiB0aGUgY3VycmVudCBzY29wZSB3aGljaCBpcyBoYW5kbGluZyB0aGUgZXZlbnQuCiAgICAgICAgICAgKiAgIC0gYG5hbWVgIC0gYHtzdHJpbmd9YDogbmFtZSBvZiB0aGUgZXZlbnQuCiAgICAgICAgICAgKiAgIC0gYHN0b3BQcm9wYWdhdGlvbmAgLSBge2Z1bmN0aW9uPX1gOiBjYWxsaW5nIGBzdG9wUHJvcGFnYXRpb25gIGZ1bmN0aW9uIHdpbGwgY2FuY2VsCiAgICAgICAgICAgKiAgICAgZnVydGhlciBldmVudCBwcm9wYWdhdGlvbiAoYXZhaWxhYmxlIG9ubHkgZm9yIGV2ZW50cyB0aGF0IHdlcmUgYCRlbWl0YC1lZCkuCiAgICAgICAgICAgKiAgIC0gYHByZXZlbnREZWZhdWx0YCAtIGB7ZnVuY3Rpb259YDogY2FsbGluZyBgcHJldmVudERlZmF1bHRgIHNldHMgYGRlZmF1bHRQcmV2ZW50ZWRgIGZsYWcKICAgICAgICAgICAqICAgICB0byB0cnVlLgogICAgICAgICAgICogICAtIGBkZWZhdWx0UHJldmVudGVkYCAtIGB7Ym9vbGVhbn1gOiB0cnVlIGlmIGBwcmV2ZW50RGVmYXVsdGAgd2FzIGNhbGxlZC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBFdmVudCBuYW1lIHRvIGxpc3RlbiBvbi4KICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZXZlbnQsIC4uLmFyZ3MpfSBsaXN0ZW5lciBGdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGV2ZW50IGlzIGVtaXR0ZWQuCiAgICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oKX0gUmV0dXJucyBhIGRlcmVnaXN0cmF0aW9uIGZ1bmN0aW9uIGZvciB0aGlzIGxpc3RlbmVyLgogICAgICAgICAgICovCiAgICAgICAgICAkb246IGZ1bmN0aW9uKG5hbWUsIGxpc3RlbmVyKSB7CiAgICAgICAgICAgIHZhciBuYW1lZExpc3RlbmVycyA9IHRoaXMuJCRsaXN0ZW5lcnNbbmFtZV07CiAgICAgICAgICAgIGlmICghbmFtZWRMaXN0ZW5lcnMpIHsKICAgICAgICAgICAgICB0aGlzLiQkbGlzdGVuZXJzW25hbWVdID0gbmFtZWRMaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuYW1lZExpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTsKCiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gdGhpczsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGlmICghY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0pIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQuJCRsaXN0ZW5lckNvdW50W25hbWVdID0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0rKzsKICAgICAgICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQpKTsKCiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzW2luZGV4T2YobmFtZWRMaXN0ZW5lcnMsIGxpc3RlbmVyKV0gPSBudWxsOwogICAgICAgICAgICAgIGRlY3JlbWVudExpc3RlbmVyQ291bnQoc2VsZiwgMSwgbmFtZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9LAoKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRyb290U2NvcGUuU2NvcGUjJGVtaXQKICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgKgogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBEaXNwYXRjaGVzIGFuIGV2ZW50IGBuYW1lYCB1cHdhcmRzIHRocm91Z2ggdGhlIHNjb3BlIGhpZXJhcmNoeSBub3RpZnlpbmcgdGhlCiAgICAgICAgICAgKiByZWdpc3RlcmVkIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbn0gbGlzdGVuZXJzLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoZSBldmVudCBsaWZlIGN5Y2xlIHN0YXJ0cyBhdCB0aGUgc2NvcGUgb24gd2hpY2ggYCRlbWl0YCB3YXMgY2FsbGVkLiBBbGwKICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IGxpc3RlbmluZyBmb3IgYG5hbWVgIGV2ZW50IG9uIHRoaXMgc2NvcGUgZ2V0CiAgICAgICAgICAgKiBub3RpZmllZC4gQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHRyYXZlcnNlcyB1cHdhcmRzIHRvd2FyZCB0aGUgcm9vdCBzY29wZSBhbmQgY2FsbHMgYWxsCiAgICAgICAgICAgKiByZWdpc3RlcmVkIGxpc3RlbmVycyBhbG9uZyB0aGUgd2F5LiBUaGUgZXZlbnQgd2lsbCBzdG9wIHByb3BhZ2F0aW5nIGlmIG9uZSBvZiB0aGUgbGlzdGVuZXJzCiAgICAgICAgICAgKiBjYW5jZWxzIGl0LgogICAgICAgICAgICoKICAgICAgICAgICAqIEFueSBleGNlcHRpb24gZW1pdHRlZCBmcm9tIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb24gbGlzdGVuZXJzfSB3aWxsIGJlIHBhc3NlZAogICAgICAgICAgICogb250byB0aGUge0BsaW5rIG5nLiRleGNlcHRpb25IYW5kbGVyICRleGNlcHRpb25IYW5kbGVyfSBzZXJ2aWNlLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIEV2ZW50IG5hbWUgdG8gZW1pdC4KICAgICAgICAgICAqIEBwYXJhbSB7Li4uKn0gYXJncyBPcHRpb25hbCBvbmUgb3IgbW9yZSBhcmd1bWVudHMgd2hpY2ggd2lsbCBiZSBwYXNzZWQgb250byB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgICAgICAgICogQHJldHVybiB7T2JqZWN0fSBFdmVudCBvYmplY3QgKHNlZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259KS4KICAgICAgICAgICAqLwogICAgICAgICAgJGVtaXQ6IGZ1bmN0aW9uKG5hbWUsIGFyZ3MpIHsKICAgICAgICAgICAgdmFyIGVtcHR5ID0gW10sCiAgICAgICAgICAgICAgbmFtZWRMaXN0ZW5lcnMsCiAgICAgICAgICAgICAgc2NvcGUgPSB0aGlzLAogICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbiA9IGZhbHNlLAogICAgICAgICAgICAgIGV2ZW50ID0gewogICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgIHRhcmdldFNjb3BlOiBzY29wZSwKICAgICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7c3RvcFByb3BhZ2F0aW9uID0gdHJ1ZTt9LAogICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiBmYWxzZQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbGlzdGVuZXJBcmdzID0gY29uY2F0KFtldmVudF0sIGFyZ3VtZW50cywgMSksCiAgICAgICAgICAgICAgaSwgbGVuZ3RoOwoKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzID0gc2NvcGUuJCRsaXN0ZW5lcnNbbmFtZV0gfHwgZW1wdHk7CiAgICAgICAgICAgICAgZXZlbnQuY3VycmVudFNjb3BlID0gc2NvcGU7CiAgICAgICAgICAgICAgZm9yIChpPTAsIGxlbmd0aD1uYW1lZExpc3RlbmVycy5sZW5ndGg7IGk8bGVuZ3RoOyBpKyspIHsKCiAgICAgICAgICAgICAgICAvLyBpZiBsaXN0ZW5lcnMgd2VyZSBkZXJlZ2lzdGVyZWQsIGRlZnJhZ21lbnQgdGhlIGFycmF5CiAgICAgICAgICAgICAgICBpZiAoIW5hbWVkTGlzdGVuZXJzW2ldKSB7CiAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAvL2FsbG93IGFsbCBsaXN0ZW5lcnMgYXR0YWNoZWQgdG8gdGhlIGN1cnJlbnQgc2NvcGUgdG8gcnVuCiAgICAgICAgICAgICAgICAgIG5hbWVkTGlzdGVuZXJzW2ldLmFwcGx5KG51bGwsIGxpc3RlbmVyQXJncyk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvL2lmIGFueSBsaXN0ZW5lciBvbiB0aGUgY3VycmVudCBzY29wZSBzdG9wcyBwcm9wYWdhdGlvbiwgcHJldmVudCBidWJibGluZwogICAgICAgICAgICAgIGlmIChzdG9wUHJvcGFnYXRpb24pIHJldHVybiBldmVudDsKICAgICAgICAgICAgICAvL3RyYXZlcnNlIHVwd2FyZHMKICAgICAgICAgICAgICBzY29wZSA9IHNjb3BlLiRwYXJlbnQ7CiAgICAgICAgICAgIH0gd2hpbGUgKHNjb3BlKTsKCiAgICAgICAgICAgIHJldHVybiBldmVudDsKICAgICAgICAgIH0sCgoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJHJvb3RTY29wZS5TY29wZSMkYnJvYWRjYXN0CiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogRGlzcGF0Y2hlcyBhbiBldmVudCBgbmFtZWAgZG93bndhcmRzIHRvIGFsbCBjaGlsZCBzY29wZXMgKGFuZCB0aGVpciBjaGlsZHJlbikgbm90aWZ5aW5nIHRoZQogICAgICAgICAgICogcmVnaXN0ZXJlZCB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkb259IGxpc3RlbmVycy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBUaGUgZXZlbnQgbGlmZSBjeWNsZSBzdGFydHMgYXQgdGhlIHNjb3BlIG9uIHdoaWNoIGAkYnJvYWRjYXN0YCB3YXMgY2FsbGVkLiBBbGwKICAgICAgICAgICAqIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IGxpc3RlbmluZyBmb3IgYG5hbWVgIGV2ZW50IG9uIHRoaXMgc2NvcGUgZ2V0CiAgICAgICAgICAgKiBub3RpZmllZC4gQWZ0ZXJ3YXJkcywgdGhlIGV2ZW50IHByb3BhZ2F0ZXMgdG8gYWxsIGRpcmVjdCBhbmQgaW5kaXJlY3Qgc2NvcGVzIG9mIHRoZSBjdXJyZW50CiAgICAgICAgICAgKiBzY29wZSBhbmQgY2FsbHMgYWxsIHJlZ2lzdGVyZWQgbGlzdGVuZXJzIGFsb25nIHRoZSB3YXkuIFRoZSBldmVudCBjYW5ub3QgYmUgY2FuY2VsZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogQW55IGV4Y2VwdGlvbiBlbWl0dGVkIGZyb20gdGhlIHtAbGluayBuZy4kcm9vdFNjb3BlLlNjb3BlIyRvbiBsaXN0ZW5lcnN9IHdpbGwgYmUgcGFzc2VkCiAgICAgICAgICAgKiBvbnRvIHRoZSB7QGxpbmsgbmcuJGV4Y2VwdGlvbkhhbmRsZXIgJGV4Y2VwdGlvbkhhbmRsZXJ9IHNlcnZpY2UuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgRXZlbnQgbmFtZSB0byBicm9hZGNhc3QuCiAgICAgICAgICAgKiBAcGFyYW0gey4uLip9IGFyZ3MgT3B0aW9uYWwgb25lIG9yIG1vcmUgYXJndW1lbnRzIHdoaWNoIHdpbGwgYmUgcGFzc2VkIG9udG8gdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0gRXZlbnQgb2JqZWN0LCBzZWUge0BsaW5rIG5nLiRyb290U2NvcGUuU2NvcGUjJG9ufQogICAgICAgICAgICovCiAgICAgICAgICAkYnJvYWRjYXN0OiBmdW5jdGlvbihuYW1lLCBhcmdzKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSB0aGlzLAogICAgICAgICAgICAgIGN1cnJlbnQgPSB0YXJnZXQsCiAgICAgICAgICAgICAgbmV4dCA9IHRhcmdldCwKICAgICAgICAgICAgICBldmVudCA9IHsKICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICB0YXJnZXRTY29wZTogdGFyZ2V0LAogICAgICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiBmYWxzZQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgbGlzdGVuZXJBcmdzID0gY29uY2F0KFtldmVudF0sIGFyZ3VtZW50cywgMSksCiAgICAgICAgICAgICAgbGlzdGVuZXJzLCBpLCBsZW5ndGg7CgogICAgICAgICAgICAvL2Rvd24gd2hpbGUgeW91IGNhbiwgdGhlbiB1cCBhbmQgbmV4dCBzaWJsaW5nIG9yIHVwIGFuZCBuZXh0IHNpYmxpbmcgdW50aWwgYmFjayBhdCByb290CiAgICAgICAgICAgIHdoaWxlICgoY3VycmVudCA9IG5leHQpKSB7CiAgICAgICAgICAgICAgZXZlbnQuY3VycmVudFNjb3BlID0gY3VycmVudDsKICAgICAgICAgICAgICBsaXN0ZW5lcnMgPSBjdXJyZW50LiQkbGlzdGVuZXJzW25hbWVdIHx8IFtdOwogICAgICAgICAgICAgIGZvciAoaT0wLCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOyBpPGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBpZiBsaXN0ZW5lcnMgd2VyZSBkZXJlZ2lzdGVyZWQsIGRlZnJhZ21lbnQgdGhlIGFycmF5CiAgICAgICAgICAgICAgICBpZiAoIWxpc3RlbmVyc1tpXSkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkobnVsbCwgbGlzdGVuZXJBcmdzKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAkZXhjZXB0aW9uSGFuZGxlcihlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIEluc2FuaXR5IFdhcm5pbmc6IHNjb3BlIGRlcHRoLWZpcnN0IHRyYXZlcnNhbAogICAgICAgICAgICAgIC8vIHllcywgdGhpcyBjb2RlIGlzIGEgYml0IGNyYXp5LCBidXQgaXQgd29ya3MgYW5kIHdlIGhhdmUgdGVzdHMgdG8gcHJvdmUgaXQhCiAgICAgICAgICAgICAgLy8gdGhpcyBwaWVjZSBzaG91bGQgYmUga2VwdCBpbiBzeW5jIHdpdGggdGhlIHRyYXZlcnNhbCBpbiAkZGlnZXN0CiAgICAgICAgICAgICAgLy8gKHRob3VnaCBpdCBkaWZmZXJzIGR1ZSB0byBoYXZpbmcgdGhlIGV4dHJhIGNoZWNrIGZvciAkJGxpc3RlbmVyQ291bnQpCiAgICAgICAgICAgICAgaWYgKCEobmV4dCA9ICgoY3VycmVudC4kJGxpc3RlbmVyQ291bnRbbmFtZV0gJiYgY3VycmVudC4kJGNoaWxkSGVhZCkgfHwKICAgICAgICAgICAgICAgIChjdXJyZW50ICE9PSB0YXJnZXQgJiYgY3VycmVudC4kJG5leHRTaWJsaW5nKSkpKSB7CiAgICAgICAgICAgICAgICB3aGlsZShjdXJyZW50ICE9PSB0YXJnZXQgJiYgIShuZXh0ID0gY3VycmVudC4kJG5leHRTaWJsaW5nKSkgewogICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudC4kcGFyZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGV2ZW50OwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciAkcm9vdFNjb3BlID0gbmV3IFNjb3BlKCk7CgogICAgICAgIHJldHVybiAkcm9vdFNjb3BlOwoKCiAgICAgICAgZnVuY3Rpb24gYmVnaW5QaGFzZShwaGFzZSkgewogICAgICAgICAgaWYgKCRyb290U2NvcGUuJCRwaGFzZSkgewogICAgICAgICAgICB0aHJvdyAkcm9vdFNjb3BlTWluRXJyKCdpbnByb2cnLCAnezB9IGFscmVhZHkgaW4gcHJvZ3Jlc3MnLCAkcm9vdFNjb3BlLiQkcGhhc2UpOwogICAgICAgICAgfQoKICAgICAgICAgICRyb290U2NvcGUuJCRwaGFzZSA9IHBoYXNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gY2xlYXJQaGFzZSgpIHsKICAgICAgICAgICRyb290U2NvcGUuJCRwaGFzZSA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBjb21waWxlVG9GbihleHAsIG5hbWUpIHsKICAgICAgICAgIHZhciBmbiA9ICRwYXJzZShleHApOwogICAgICAgICAgYXNzZXJ0QXJnRm4oZm4sIG5hbWUpOwogICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZGVjcmVtZW50TGlzdGVuZXJDb3VudChjdXJyZW50LCBjb3VudCwgbmFtZSkgewogICAgICAgICAgZG8gewogICAgICAgICAgICBjdXJyZW50LiQkbGlzdGVuZXJDb3VudFtuYW1lXSAtPSBjb3VudDsKCiAgICAgICAgICAgIGlmIChjdXJyZW50LiQkbGlzdGVuZXJDb3VudFtuYW1lXSA9PT0gMCkgewogICAgICAgICAgICAgIGRlbGV0ZSBjdXJyZW50LiQkbGlzdGVuZXJDb3VudFtuYW1lXTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAoKGN1cnJlbnQgPSBjdXJyZW50LiRwYXJlbnQpKTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIGZ1bmN0aW9uIHVzZWQgYXMgYW4gaW5pdGlhbCB2YWx1ZSBmb3Igd2F0Y2hlcnMuCiAgICAgICAgICogYmVjYXVzZSBpdCdzIHVuaXF1ZSB3ZSBjYW4gZWFzaWx5IHRlbGwgaXQgYXBhcnQgZnJvbSBvdGhlciB2YWx1ZXMKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBpbml0V2F0Y2hWYWwoKSB7fQogICAgICB9XTsKICB9CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFByaXZhdGUgc2VydmljZSB0byBzYW5pdGl6ZSB1cmlzIGZvciBsaW5rcyBhbmQgaW1hZ2VzLiBVc2VkIGJ5ICRjb21waWxlIGFuZCAkc2FuaXRpemUuCiAgICovCiAgZnVuY3Rpb24gJCRTYW5pdGl6ZVVyaVByb3ZpZGVyKCkgewogICAgdmFyIGFIcmVmU2FuaXRpemF0aW9uV2hpdGVsaXN0ID0gL15ccyooaHR0cHM/fGZ0cHxtYWlsdG98dGVsfGZpbGUpOi8sCiAgICAgIGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA9IC9eXHMqKGh0dHBzP3xmdHB8ZmlsZSk6fGRhdGE6aW1hZ2VcLy87CgogICAgLyoqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldHJpZXZlcyBvciBvdmVycmlkZXMgdGhlIGRlZmF1bHQgcmVndWxhciBleHByZXNzaW9uIHRoYXQgaXMgdXNlZCBmb3Igd2hpdGVsaXN0aW5nIG9mIHNhZmUKICAgICAqIHVybHMgZHVyaW5nIGFbaHJlZl0gc2FuaXRpemF0aW9uLgogICAgICoKICAgICAqIFRoZSBzYW5pdGl6YXRpb24gaXMgYSBzZWN1cml0eSBtZWFzdXJlIGFpbWVkIGF0IHByZXZlbnQgWFNTIGF0dGFja3MgdmlhIGh0bWwgbGlua3MuCiAgICAgKgogICAgICogQW55IHVybCBhYm91dCB0byBiZSBhc3NpZ25lZCB0byBhW2hyZWZdIHZpYSBkYXRhLWJpbmRpbmcgaXMgZmlyc3Qgbm9ybWFsaXplZCBhbmQgdHVybmVkIGludG8KICAgICAqIGFuIGFic29sdXRlIHVybC4gQWZ0ZXJ3YXJkcywgdGhlIHVybCBpcyBtYXRjaGVkIGFnYWluc3QgdGhlIGBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdGAKICAgICAqIHJlZ3VsYXIgZXhwcmVzc2lvbi4gSWYgYSBtYXRjaCBpcyBmb3VuZCwgdGhlIG9yaWdpbmFsIHVybCBpcyB3cml0dGVuIGludG8gdGhlIGRvbS4gT3RoZXJ3aXNlLAogICAgICogdGhlIGFic29sdXRlIHVybCBpcyBwcmVmaXhlZCB3aXRoIGAndW5zYWZlOidgIHN0cmluZyBhbmQgb25seSB0aGVuIGlzIGl0IHdyaXR0ZW4gaW50byB0aGUgRE9NLgogICAgICoKICAgICAqIEBwYXJhbSB7UmVnRXhwPX0gcmVnZXhwIE5ldyByZWdleHAgdG8gd2hpdGVsaXN0IHVybHMgd2l0aC4KICAgICAqIEByZXR1cm5zIHtSZWdFeHB8bmcuJGNvbXBpbGVQcm92aWRlcn0gQ3VycmVudCBSZWdFeHAgaWYgY2FsbGVkIHdpdGhvdXQgdmFsdWUgb3Igc2VsZiBmb3IKICAgICAqICAgIGNoYWluaW5nIG90aGVyd2lzZS4KICAgICAqLwogICAgdGhpcy5hSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCA9IGZ1bmN0aW9uKHJlZ2V4cCkgewogICAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgICBhSHJlZlNhbml0aXphdGlvbldoaXRlbGlzdCA9IHJlZ2V4cDsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICByZXR1cm4gYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3Q7CiAgICB9OwoKCiAgICAvKioKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmV0cmlldmVzIG9yIG92ZXJyaWRlcyB0aGUgZGVmYXVsdCByZWd1bGFyIGV4cHJlc3Npb24gdGhhdCBpcyB1c2VkIGZvciB3aGl0ZWxpc3Rpbmcgb2Ygc2FmZQogICAgICogdXJscyBkdXJpbmcgaW1nW3NyY10gc2FuaXRpemF0aW9uLgogICAgICoKICAgICAqIFRoZSBzYW5pdGl6YXRpb24gaXMgYSBzZWN1cml0eSBtZWFzdXJlIGFpbWVkIGF0IHByZXZlbnQgWFNTIGF0dGFja3MgdmlhIGh0bWwgbGlua3MuCiAgICAgKgogICAgICogQW55IHVybCBhYm91dCB0byBiZSBhc3NpZ25lZCB0byBpbWdbc3JjXSB2aWEgZGF0YS1iaW5kaW5nIGlzIGZpcnN0IG5vcm1hbGl6ZWQgYW5kIHR1cm5lZCBpbnRvCiAgICAgKiBhbiBhYnNvbHV0ZSB1cmwuIEFmdGVyd2FyZHMsIHRoZSB1cmwgaXMgbWF0Y2hlZCBhZ2FpbnN0IHRoZSBgaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0YAogICAgICogcmVndWxhciBleHByZXNzaW9uLiBJZiBhIG1hdGNoIGlzIGZvdW5kLCB0aGUgb3JpZ2luYWwgdXJsIGlzIHdyaXR0ZW4gaW50byB0aGUgZG9tLiBPdGhlcndpc2UsCiAgICAgKiB0aGUgYWJzb2x1dGUgdXJsIGlzIHByZWZpeGVkIHdpdGggYCd1bnNhZmU6J2Agc3RyaW5nIGFuZCBvbmx5IHRoZW4gaXMgaXQgd3JpdHRlbiBpbnRvIHRoZSBET00uCiAgICAgKgogICAgICogQHBhcmFtIHtSZWdFeHA9fSByZWdleHAgTmV3IHJlZ2V4cCB0byB3aGl0ZWxpc3QgdXJscyB3aXRoLgogICAgICogQHJldHVybnMge1JlZ0V4cHxuZy4kY29tcGlsZVByb3ZpZGVyfSBDdXJyZW50IFJlZ0V4cCBpZiBjYWxsZWQgd2l0aG91dCB2YWx1ZSBvciBzZWxmIGZvcgogICAgICogICAgY2hhaW5pbmcgb3RoZXJ3aXNlLgogICAgICovCiAgICB0aGlzLmltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdCA9IGZ1bmN0aW9uKHJlZ2V4cCkgewogICAgICBpZiAoaXNEZWZpbmVkKHJlZ2V4cCkpIHsKICAgICAgICBpbWdTcmNTYW5pdGl6YXRpb25XaGl0ZWxpc3QgPSByZWdleHA7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgcmV0dXJuIGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdDsKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiBzYW5pdGl6ZVVyaSh1cmksIGlzSW1hZ2UpIHsKICAgICAgICB2YXIgcmVnZXggPSBpc0ltYWdlID8gaW1nU3JjU2FuaXRpemF0aW9uV2hpdGVsaXN0IDogYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3Q7CiAgICAgICAgdmFyIG5vcm1hbGl6ZWRWYWw7CiAgICAgICAgLy8gTk9URTogdXJsUmVzb2x2ZSgpIGRvZXNuJ3Qgc3VwcG9ydCBJRSA8IDggc28gd2UgZG9uJ3Qgc2FuaXRpemUgZm9yIHRoYXQgY2FzZS4KICAgICAgICBpZiAoIW1zaWUgfHwgbXNpZSA+PSA4ICkgewogICAgICAgICAgbm9ybWFsaXplZFZhbCA9IHVybFJlc29sdmUodXJpKS5ocmVmOwogICAgICAgICAgaWYgKG5vcm1hbGl6ZWRWYWwgIT09ICcnICYmICFub3JtYWxpemVkVmFsLm1hdGNoKHJlZ2V4KSkgewogICAgICAgICAgICByZXR1cm4gJ3Vuc2FmZTonK25vcm1hbGl6ZWRWYWw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB1cmk7CiAgICAgIH07CiAgICB9OwogIH0KCiAgdmFyICRzY2VNaW5FcnIgPSBtaW5FcnIoJyRzY2UnKTsKCiAgdmFyIFNDRV9DT05URVhUUyA9IHsKICAgIEhUTUw6ICdodG1sJywKICAgIENTUzogJ2NzcycsCiAgICBVUkw6ICd1cmwnLAogICAgLy8gUkVTT1VSQ0VfVVJMIGlzIGEgc3VidHlwZSBvZiBVUkwgdXNlZCBpbiBjb250ZXh0cyB3aGVyZSBhIHByaXZpbGVnZWQgcmVzb3VyY2UgaXMgc291cmNlZCBmcm9tIGEKICAgIC8vIHVybC4gIChlLmcuIG5nLWluY2x1ZGUsIHNjcmlwdCBzcmMsIHRlbXBsYXRlVXJsKQogICAgUkVTT1VSQ0VfVVJMOiAncmVzb3VyY2VVcmwnLAogICAgSlM6ICdqcycKICB9OwoKLy8gSGVscGVyIGZ1bmN0aW9ucyBmb2xsb3cuCgovLyBDb3BpZWQgZnJvbToKLy8gaHR0cDovL2RvY3MuY2xvc3VyZS1saWJyYXJ5Lmdvb2dsZWNvZGUuY29tL2dpdC9jbG9zdXJlX2dvb2dfc3RyaW5nX3N0cmluZy5qcy5zb3VyY2UuaHRtbCNsaW5lOTYyCi8vIFByZXJlcTogcyBpcyBhIHN0cmluZy4KICBmdW5jdGlvbiBlc2NhcGVGb3JSZWdleHAocykgewogICAgcmV0dXJuIHMucmVwbGFjZSgvKFstKClcW1xde30rPyouJFxefCw6IzwhXFxdKS9nLCAnXFwkMScpLgogICAgICByZXBsYWNlKC9ceDA4L2csICdcXHgwOCcpOwogIH0KCgogIGZ1bmN0aW9uIGFkanVzdE1hdGNoZXIobWF0Y2hlcikgewogICAgaWYgKG1hdGNoZXIgPT09ICdzZWxmJykgewogICAgICByZXR1cm4gbWF0Y2hlcjsKICAgIH0gZWxzZSBpZiAoaXNTdHJpbmcobWF0Y2hlcikpIHsKICAgICAgLy8gU3RyaW5ncyBtYXRjaCBleGFjdGx5IGV4Y2VwdCBmb3IgMiB3aWxkY2FyZHMgLSAnKicgYW5kICcqKicuCiAgICAgIC8vICcqJyBtYXRjaGVzIGFueSBjaGFyYWN0ZXIgZXhjZXB0IHRob3NlIGZyb20gdGhlIHNldCAnOi8uPyYnLgogICAgICAvLyAnKionIG1hdGNoZXMgYW55IGNoYXJhY3RlciAobGlrZSAuKiBpbiBhIFJlZ0V4cCkuCiAgICAgIC8vIE1vcmUgdGhhbiAyIConcyByYWlzZXMgYW4gZXJyb3IgYXMgaXQncyBpbGwgZGVmaW5lZC4KICAgICAgaWYgKG1hdGNoZXIuaW5kZXhPZignKioqJykgPiAtMSkgewogICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2l3Y2FyZCcsCiAgICAgICAgICAnSWxsZWdhbCBzZXF1ZW5jZSAqKiogaW4gc3RyaW5nIG1hdGNoZXIuICBTdHJpbmc6IHswfScsIG1hdGNoZXIpOwogICAgICB9CiAgICAgIG1hdGNoZXIgPSBlc2NhcGVGb3JSZWdleHAobWF0Y2hlcikuCiAgICAgICAgcmVwbGFjZSgnXFwqXFwqJywgJy4qJykuCiAgICAgICAgcmVwbGFjZSgnXFwqJywgJ1teOi8uPyY7XSonKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgbWF0Y2hlciArICckJyk7CiAgICB9IGVsc2UgaWYgKGlzUmVnRXhwKG1hdGNoZXIpKSB7CiAgICAgIC8vIFRoZSBvbmx5IG90aGVyIHR5cGUgb2YgbWF0Y2hlciBhbGxvd2VkIGlzIGEgUmVnZXhwLgogICAgICAvLyBNYXRjaCBlbnRpcmUgVVJMIC8gZGlzYWxsb3cgcGFydGlhbCBtYXRjaGVzLgogICAgICAvLyBGbGFncyBhcmUgcmVzZXQgKGkuZS4gbm8gZ2xvYmFsLCBpZ25vcmVDYXNlIG9yIG11bHRpbGluZSkKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgbWF0Y2hlci5zb3VyY2UgKyAnJCcpOwogICAgfSBlbHNlIHsKICAgICAgdGhyb3cgJHNjZU1pbkVycignaW1hdGNoZXInLAogICAgICAgICdNYXRjaGVycyBtYXkgb25seSBiZSAic2VsZiIsIHN0cmluZyBwYXR0ZXJucyBvciBSZWdFeHAgb2JqZWN0cycpOwogICAgfQogIH0KCgogIGZ1bmN0aW9uIGFkanVzdE1hdGNoZXJzKG1hdGNoZXJzKSB7CiAgICB2YXIgYWRqdXN0ZWRNYXRjaGVycyA9IFtdOwogICAgaWYgKGlzRGVmaW5lZChtYXRjaGVycykpIHsKICAgICAgZm9yRWFjaChtYXRjaGVycywgZnVuY3Rpb24obWF0Y2hlcikgewogICAgICAgIGFkanVzdGVkTWF0Y2hlcnMucHVzaChhZGp1c3RNYXRjaGVyKG1hdGNoZXIpKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gYWRqdXN0ZWRNYXRjaGVyczsKICB9CgoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRzY2VEZWxlZ2F0ZQogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIGAkc2NlRGVsZWdhdGVgIGlzIGEgc2VydmljZSB0aGF0IGlzIHVzZWQgYnkgdGhlIGAkc2NlYCBzZXJ2aWNlIHRvIHByb3ZpZGUge0BsaW5rIG5nLiRzY2UgU3RyaWN0CiAqIENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSl9IHNlcnZpY2VzIHRvIEFuZ3VsYXJKUy4KICAgKgogICAqIFR5cGljYWxseSwgeW91IHdvdWxkIGNvbmZpZ3VyZSBvciBvdmVycmlkZSB0aGUge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSAkc2NlRGVsZWdhdGV9IGluc3RlYWQgb2YKICAgKiB0aGUgYCRzY2VgIHNlcnZpY2UgdG8gY3VzdG9taXplIHRoZSB3YXkgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgd29ya3MgaW4gQW5ndWxhckpTLiAgVGhpcyBpcwogICAqIGJlY2F1c2UsIHdoaWxlIHRoZSBgJHNjZWAgcHJvdmlkZXMgbnVtZXJvdXMgc2hvcnRoYW5kIG1ldGhvZHMsIGV0Yy4sIHlvdSByZWFsbHkgb25seSBuZWVkIHRvCiAgICogb3ZlcnJpZGUgMyBjb3JlIGZ1bmN0aW9ucyAoYHRydXN0QXNgLCBgZ2V0VHJ1c3RlZGAgYW5kIGB2YWx1ZU9mYCkgdG8gcmVwbGFjZSB0aGUgd2F5IHRoaW5ncwogICAqIHdvcmsgYmVjYXVzZSBgJHNjZWAgZGVsZWdhdGVzIHRvIGAkc2NlRGVsZWdhdGVgIGZvciB0aGVzZSBvcGVyYXRpb25zLgogICAqCiAgICogUmVmZXIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyICRzY2VEZWxlZ2F0ZVByb3ZpZGVyfSB0byBjb25maWd1cmUgdGhpcyBzZXJ2aWNlLgogICAqCiAgICogVGhlIGRlZmF1bHQgaW5zdGFuY2Ugb2YgYCRzY2VEZWxlZ2F0ZWAgc2hvdWxkIHdvcmsgb3V0IG9mIHRoZSBib3ggd2l0aCBsaXR0bGUgcGFpbi4gIFdoaWxlIHlvdQogICAqIGNhbiBvdmVycmlkZSBpdCBjb21wbGV0ZWx5IHRvIGNoYW5nZSB0aGUgYmVoYXZpb3Igb2YgYCRzY2VgLCB0aGUgY29tbW9uIGNhc2Ugd291bGQKICAgKiBpbnZvbHZlIGNvbmZpZ3VyaW5nIHRoZSB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIgJHNjZURlbGVnYXRlUHJvdmlkZXJ9IGluc3RlYWQgYnkgc2V0dGluZwogICAqIHlvdXIgb3duIHdoaXRlbGlzdHMgYW5kIGJsYWNrbGlzdHMgZm9yIHRydXN0aW5nIFVSTHMgdXNlZCBmb3IgbG9hZGluZyBBbmd1bGFySlMgcmVzb3VyY2VzIHN1Y2ggYXMKICAgKiB0ZW1wbGF0ZXMuICBSZWZlciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxXaGl0ZWxpc3QKICogJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxXaGl0ZWxpc3R9IGFuZCB7QGxpbmsKICAgICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxCbGFja2xpc3R9CiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBwcm92aWRlcgogICAqIEBuYW1lICRzY2VEZWxlZ2F0ZVByb3ZpZGVyCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBUaGUgYCRzY2VEZWxlZ2F0ZVByb3ZpZGVyYCBwcm92aWRlciBhbGxvd3MgZGV2ZWxvcGVycyB0byBjb25maWd1cmUgdGhlIHtAbGluayBuZy4kc2NlRGVsZWdhdGUKICogJHNjZURlbGVnYXRlfSBzZXJ2aWNlLiAgVGhpcyBhbGxvd3Mgb25lIHRvIGdldC9zZXQgdGhlIHdoaXRlbGlzdHMgYW5kIGJsYWNrbGlzdHMgdXNlZCB0byBlbnN1cmUKICAgKiB0aGF0IHRoZSBVUkxzIHVzZWQgZm9yIHNvdXJjaW5nIEFuZ3VsYXIgdGVtcGxhdGVzIGFyZSBzYWZlLiAgUmVmZXIge0BsaW5rCiAgICAqIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0ICRzY2VEZWxlZ2F0ZVByb3ZpZGVyLnJlc291cmNlVXJsV2hpdGVsaXN0fSBhbmQKICAgKiB7QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgJHNjZURlbGVnYXRlUHJvdmlkZXIucmVzb3VyY2VVcmxCbGFja2xpc3R9CiAgICoKICAgKiBGb3IgdGhlIGdlbmVyYWwgZGV0YWlscyBhYm91dCB0aGlzIHNlcnZpY2UgaW4gQW5ndWxhciwgcmVhZCB0aGUgbWFpbiBwYWdlIGZvciB7QGxpbmsgbmcuJHNjZQogKiBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0uCiAgICoKICAgKiAqKkV4YW1wbGUqKjogIENvbnNpZGVyIHRoZSBmb2xsb3dpbmcgY2FzZS4gPGEgbmFtZT0iZXhhbXBsZSI+PC9hPgogICAqCiAgICogLSB5b3VyIGFwcCBpcyBob3N0ZWQgYXQgdXJsIGBodHRwOi8vbXlhcHAuZXhhbXBsZS5jb20vYAogICAqIC0gYnV0IHNvbWUgb2YgeW91ciB0ZW1wbGF0ZXMgYXJlIGhvc3RlZCBvbiBvdGhlciBkb21haW5zIHlvdSBjb250cm9sIHN1Y2ggYXMKICAgKiAgIGBodHRwOi8vc3J2MDEuYXNzZXRzLmV4YW1wbGUuY29tL2AsICBgaHR0cDovL3NydjAyLmFzc2V0cy5leGFtcGxlLmNvbS9gLCBldGMuCiAgICogLSBhbmQgeW91IGhhdmUgYW4gb3BlbiByZWRpcmVjdCBhdCBgaHR0cDovL215YXBwLmV4YW1wbGUuY29tL2NsaWNrVGhydT8uLi5gLgogICAqCiAgICogSGVyZSBpcyB3aGF0IGEgc2VjdXJlIGNvbmZpZ3VyYXRpb24gZm9yIHRoaXMgc2NlbmFyaW8gbWlnaHQgbG9vayBsaWtlOgogICAqCiAgICogPHByZSBjbGFzcz0icHJldHR5cHJpbnQiPgogICAqICAgIGFuZ3VsYXIubW9kdWxlKCdteUFwcCcsIFtdKS5jb25maWcoZnVuY3Rpb24oJHNjZURlbGVnYXRlUHJvdmlkZXIpIHsKICogICAgICAkc2NlRGVsZWdhdGVQcm92aWRlci5yZXNvdXJjZVVybFdoaXRlbGlzdChbCiAqICAgICAgICAvLyBBbGxvdyBzYW1lIG9yaWdpbiByZXNvdXJjZSBsb2Fkcy4KICogICAgICAgICdzZWxmJywKICogICAgICAgIC8vIEFsbG93IGxvYWRpbmcgZnJvbSBvdXIgYXNzZXRzIGRvbWFpbi4gIE5vdGljZSB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuICogYW5kICoqLgogKiAgICAgICAgJ2h0dHA6Ly9zcnYqLmFzc2V0cy5leGFtcGxlLmNvbS8qKiddKTsKICoKICogICAgICAvLyBUaGUgYmxhY2tsaXN0IG92ZXJyaWRlcyB0aGUgd2hpdGVsaXN0IHNvIHRoZSBvcGVuIHJlZGlyZWN0IGhlcmUgaXMgYmxvY2tlZC4KICogICAgICAkc2NlRGVsZWdhdGVQcm92aWRlci5yZXNvdXJjZVVybEJsYWNrbGlzdChbCiAqICAgICAgICAnaHR0cDovL215YXBwLmV4YW1wbGUuY29tL2NsaWNrVGhydSoqJ10pOwogKiAgICAgIH0pOwogICAqIDwvcHJlPgogICAqLwoKICBmdW5jdGlvbiAkU2NlRGVsZWdhdGVQcm92aWRlcigpIHsKICAgIHRoaXMuU0NFX0NPTlRFWFRTID0gU0NFX0NPTlRFWFRTOwoKICAgIC8vIFJlc291cmNlIFVSTHMgY2FuIGFsc28gYmUgdHJ1c3RlZCBieSBwb2xpY3kuCiAgICB2YXIgcmVzb3VyY2VVcmxXaGl0ZWxpc3QgPSBbJ3NlbGYnXSwKICAgICAgcmVzb3VyY2VVcmxCbGFja2xpc3QgPSBbXTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0CiAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXk9fSB3aGl0ZWxpc3QgV2hlbiBwcm92aWRlZCwgcmVwbGFjZXMgdGhlIHJlc291cmNlVXJsV2hpdGVsaXN0IHdpdGggdGhlIHZhbHVlCiAgICAgKiAgICAgcHJvdmlkZWQuICBUaGlzIG11c3QgYmUgYW4gYXJyYXkgb3IgbnVsbC4gIEEgc25hcHNob3Qgb2YgdGhpcyBhcnJheSBpcyB1c2VkIHNvIGZ1cnRoZXIKICAgICAqICAgICBjaGFuZ2VzIHRvIHRoZSBhcnJheSBhcmUgaWdub3JlZC4KICAgICAqCiAgICAgKiAgICAgRm9sbG93IHtAbGluayBuZy4kc2NlI3Jlc291cmNlVXJsUGF0dGVybkl0ZW0gdGhpcyBsaW5rfSBmb3IgYSBkZXNjcmlwdGlvbiBvZiB0aGUgaXRlbXMKICAgICAqICAgICBhbGxvd2VkIGluIHRoaXMgYXJyYXkuCiAgICAgKgogICAgICogICAgIE5vdGU6ICoqYW4gZW1wdHkgd2hpdGVsaXN0IGFycmF5IHdpbGwgYmxvY2sgYWxsIFVSTHMqKiEKICAgICAqCiAgICAgKiBAcmV0dXJuIHtBcnJheX0gdGhlIGN1cnJlbnRseSBzZXQgd2hpdGVsaXN0IGFycmF5LgogICAgICoKICAgICAqIFRoZSAqKmRlZmF1bHQgdmFsdWUqKiB3aGVuIG5vIHdoaXRlbGlzdCBoYXMgYmVlbiBleHBsaWNpdGx5IHNldCBpcyBgWydzZWxmJ11gIGFsbG93aW5nIG9ubHkKICAgICAqIHNhbWUgb3JpZ2luIHJlc291cmNlIHJlcXVlc3RzLgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2V0cy9HZXRzIHRoZSB3aGl0ZWxpc3Qgb2YgdHJ1c3RlZCByZXNvdXJjZSBVUkxzLgogICAgICovCiAgICB0aGlzLnJlc291cmNlVXJsV2hpdGVsaXN0ID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgcmVzb3VyY2VVcmxXaGl0ZWxpc3QgPSBhZGp1c3RNYXRjaGVycyh2YWx1ZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc291cmNlVXJsV2hpdGVsaXN0OwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsQmxhY2tsaXN0CiAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICoKICAgICAqIEBwYXJhbSB7QXJyYXk9fSBibGFja2xpc3QgV2hlbiBwcm92aWRlZCwgcmVwbGFjZXMgdGhlIHJlc291cmNlVXJsQmxhY2tsaXN0IHdpdGggdGhlIHZhbHVlCiAgICAgKiAgICAgcHJvdmlkZWQuICBUaGlzIG11c3QgYmUgYW4gYXJyYXkgb3IgbnVsbC4gIEEgc25hcHNob3Qgb2YgdGhpcyBhcnJheSBpcyB1c2VkIHNvIGZ1cnRoZXIKICAgICAqICAgICBjaGFuZ2VzIHRvIHRoZSBhcnJheSBhcmUgaWdub3JlZC4KICAgICAqCiAgICAgKiAgICAgRm9sbG93IHtAbGluayBuZy4kc2NlI3Jlc291cmNlVXJsUGF0dGVybkl0ZW0gdGhpcyBsaW5rfSBmb3IgYSBkZXNjcmlwdGlvbiBvZiB0aGUgaXRlbXMKICAgICAqICAgICBhbGxvd2VkIGluIHRoaXMgYXJyYXkuCiAgICAgKgogICAgICogICAgIFRoZSB0eXBpY2FsIHVzYWdlIGZvciB0aGUgYmxhY2tsaXN0IGlzIHRvICoqYmxvY2sKICAgICAqICAgICBbb3BlbiByZWRpcmVjdHNdKGh0dHA6Ly9jd2UubWl0cmUub3JnL2RhdGEvZGVmaW5pdGlvbnMvNjAxLmh0bWwpKiogc2VydmVkIGJ5IHlvdXIgZG9tYWluIGFzCiAgICAgKiAgICAgdGhlc2Ugd291bGQgb3RoZXJ3aXNlIGJlIHRydXN0ZWQgYnV0IGFjdHVhbGx5IHJldHVybiBjb250ZW50IGZyb20gdGhlIHJlZGlyZWN0ZWQgZG9tYWluLgogICAgICoKICAgICAqICAgICBGaW5hbGx5LCAqKnRoZSBibGFja2xpc3Qgb3ZlcnJpZGVzIHRoZSB3aGl0ZWxpc3QqKiBhbmQgaGFzIHRoZSBmaW5hbCBzYXkuCiAgICAgKgogICAgICogQHJldHVybiB7QXJyYXl9IHRoZSBjdXJyZW50bHkgc2V0IGJsYWNrbGlzdCBhcnJheS4KICAgICAqCiAgICAgKiBUaGUgKipkZWZhdWx0IHZhbHVlKiogd2hlbiBubyB3aGl0ZWxpc3QgaGFzIGJlZW4gZXhwbGljaXRseSBzZXQgaXMgdGhlIGVtcHR5IGFycmF5IChpLmUuIHRoZXJlCiAgICAgKiBpcyBubyBibGFja2xpc3QuKQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU2V0cy9HZXRzIHRoZSBibGFja2xpc3Qgb2YgdHJ1c3RlZCByZXNvdXJjZSBVUkxzLgogICAgICovCgogICAgdGhpcy5yZXNvdXJjZVVybEJsYWNrbGlzdCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHJlc291cmNlVXJsQmxhY2tsaXN0ID0gYWRqdXN0TWF0Y2hlcnModmFsdWUpOwogICAgICB9CiAgICAgIHJldHVybiByZXNvdXJjZVVybEJsYWNrbGlzdDsKICAgIH07CgogICAgdGhpcy4kZ2V0ID0gWyckaW5qZWN0b3InLCBmdW5jdGlvbigkaW5qZWN0b3IpIHsKCiAgICAgIHZhciBodG1sU2FuaXRpemVyID0gZnVuY3Rpb24gaHRtbFNhbml0aXplcihodG1sKSB7CiAgICAgICAgdGhyb3cgJHNjZU1pbkVycigndW5zYWZlJywgJ0F0dGVtcHRpbmcgdG8gdXNlIGFuIHVuc2FmZSB2YWx1ZSBpbiBhIHNhZmUgY29udGV4dC4nKTsKICAgICAgfTsKCiAgICAgIGlmICgkaW5qZWN0b3IuaGFzKCckc2FuaXRpemUnKSkgewogICAgICAgIGh0bWxTYW5pdGl6ZXIgPSAkaW5qZWN0b3IuZ2V0KCckc2FuaXRpemUnKTsKICAgICAgfQoKCiAgICAgIGZ1bmN0aW9uIG1hdGNoVXJsKG1hdGNoZXIsIHBhcnNlZFVybCkgewogICAgICAgIGlmIChtYXRjaGVyID09PSAnc2VsZicpIHsKICAgICAgICAgIHJldHVybiB1cmxJc1NhbWVPcmlnaW4ocGFyc2VkVXJsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gZGVmaW5pdGVseSBhIHJlZ2V4LiAgU2VlIGFkanVzdE1hdGNoZXJzKCkKICAgICAgICAgIHJldHVybiAhIW1hdGNoZXIuZXhlYyhwYXJzZWRVcmwuaHJlZik7CiAgICAgICAgfQogICAgICB9CgogICAgICBmdW5jdGlvbiBpc1Jlc291cmNlVXJsQWxsb3dlZEJ5UG9saWN5KHVybCkgewogICAgICAgIHZhciBwYXJzZWRVcmwgPSB1cmxSZXNvbHZlKHVybC50b1N0cmluZygpKTsKICAgICAgICB2YXIgaSwgbiwgYWxsb3dlZCA9IGZhbHNlOwogICAgICAgIC8vIEVuc3VyZSB0aGF0IGF0IGxlYXN0IG9uZSBpdGVtIGZyb20gdGhlIHdoaXRlbGlzdCBhbGxvd3MgdGhpcyB1cmwuCiAgICAgICAgZm9yIChpID0gMCwgbiA9IHJlc291cmNlVXJsV2hpdGVsaXN0Lmxlbmd0aDsgaSA8IG47IGkrKykgewogICAgICAgICAgaWYgKG1hdGNoVXJsKHJlc291cmNlVXJsV2hpdGVsaXN0W2ldLCBwYXJzZWRVcmwpKSB7CiAgICAgICAgICAgIGFsbG93ZWQgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGFsbG93ZWQpIHsKICAgICAgICAgIC8vIEVuc3VyZSB0aGF0IG5vIGl0ZW0gZnJvbSB0aGUgYmxhY2tsaXN0IGJsb2NrZWQgdGhpcyB1cmwuCiAgICAgICAgICBmb3IgKGkgPSAwLCBuID0gcmVzb3VyY2VVcmxCbGFja2xpc3QubGVuZ3RoOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICAgIGlmIChtYXRjaFVybChyZXNvdXJjZVVybEJsYWNrbGlzdFtpXSwgcGFyc2VkVXJsKSkgewogICAgICAgICAgICAgIGFsbG93ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYWxsb3dlZDsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gZ2VuZXJhdGVIb2xkZXJUeXBlKEJhc2UpIHsKICAgICAgICB2YXIgaG9sZGVyVHlwZSA9IGZ1bmN0aW9uIFRydXN0ZWRWYWx1ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlKSB7CiAgICAgICAgICB0aGlzLiQkdW53cmFwVHJ1c3RlZFZhbHVlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVzdGVkVmFsdWU7CiAgICAgICAgICB9OwogICAgICAgIH07CiAgICAgICAgaWYgKEJhc2UpIHsKICAgICAgICAgIGhvbGRlclR5cGUucHJvdG90eXBlID0gbmV3IEJhc2UoKTsKICAgICAgICB9CiAgICAgICAgaG9sZGVyVHlwZS5wcm90b3R5cGUudmFsdWVPZiA9IGZ1bmN0aW9uIHNjZVZhbHVlT2YoKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy4kJHVud3JhcFRydXN0ZWRWYWx1ZSgpOwogICAgICAgIH07CiAgICAgICAgaG9sZGVyVHlwZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiBzY2VUb1N0cmluZygpIHsKICAgICAgICAgIHJldHVybiB0aGlzLiQkdW53cmFwVHJ1c3RlZFZhbHVlKCkudG9TdHJpbmcoKTsKICAgICAgICB9OwogICAgICAgIHJldHVybiBob2xkZXJUeXBlOwogICAgICB9CgogICAgICB2YXIgdHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSA9IGdlbmVyYXRlSG9sZGVyVHlwZSgpLAogICAgICAgIGJ5VHlwZSA9IHt9OwoKICAgICAgYnlUeXBlW1NDRV9DT05URVhUUy5IVE1MXSA9IGdlbmVyYXRlSG9sZGVyVHlwZSh0cnVzdGVkVmFsdWVIb2xkZXJCYXNlKTsKICAgICAgYnlUeXBlW1NDRV9DT05URVhUUy5DU1NdID0gZ2VuZXJhdGVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpOwogICAgICBieVR5cGVbU0NFX0NPTlRFWFRTLlVSTF0gPSBnZW5lcmF0ZUhvbGRlclR5cGUodHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSk7CiAgICAgIGJ5VHlwZVtTQ0VfQ09OVEVYVFMuSlNdID0gZ2VuZXJhdGVIb2xkZXJUeXBlKHRydXN0ZWRWYWx1ZUhvbGRlckJhc2UpOwogICAgICBieVR5cGVbU0NFX0NPTlRFWFRTLlJFU09VUkNFX1VSTF0gPSBnZW5lcmF0ZUhvbGRlclR5cGUoYnlUeXBlW1NDRV9DT05URVhUUy5VUkxdKTsKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2VEZWxlZ2F0ZSN0cnVzdEFzCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBSZXR1cm5zIGFuIG9iamVjdCB0aGF0IGlzIHRydXN0ZWQgYnkgYW5ndWxhciBmb3IgdXNlIGluIHNwZWNpZmllZCBzdHJpY3QKICAgICAgICogY29udGV4dHVhbCBlc2NhcGluZyBjb250ZXh0cyAoc3VjaCBhcyBuZy1iaW5kLWh0bWwsIG5nLWluY2x1ZGUsIGFueSBzcmMKICAgICAgICogYXR0cmlidXRlIGludGVycG9sYXRpb24sIGFueSBkb20gZXZlbnQgYmluZGluZyBhdHRyaWJ1dGUgaW50ZXJwb2xhdGlvbgogICAgICAgKiBzdWNoIGFzIGZvciBvbmNsaWNrLCAgZXRjLikgdGhhdCB1c2VzIHRoZSBwcm92aWRlZCB2YWx1ZS4KICAgICAgICogU2VlIHtAbGluayBuZy4kc2NlICRzY2V9IGZvciBlbmFibGluZyBzdHJpY3QgY29udGV4dHVhbCBlc2NhcGluZy4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgY29udGV4dCBpbiB3aGljaCB0aGlzIHZhbHVlIGlzIHNhZmUgZm9yIHVzZS4gIGUuZy4gdXJsLAogICAgICAgKiAgIHJlc291cmNlVXJsLCBodG1sLCBqcyBhbmQgY3NzLgogICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0aGF0IHRoYXQgc2hvdWxkIGJlIGNvbnNpZGVyZWQgdHJ1c3RlZC9zYWZlLgogICAgICAgKiBAcmV0dXJucyB7Kn0gQSB2YWx1ZSB0aGF0IGNhbiBiZSB1c2VkIHRvIHN0YW5kIGluIGZvciB0aGUgcHJvdmlkZWQgYHZhbHVlYCBpbiBwbGFjZXMKICAgICAgICogd2hlcmUgQW5ndWxhciBleHBlY3RzIGEgJHNjZS50cnVzdEFzKCkgcmV0dXJuIHZhbHVlLgogICAgICAgKi8KICAgICAgZnVuY3Rpb24gdHJ1c3RBcyh0eXBlLCB0cnVzdGVkVmFsdWUpIHsKICAgICAgICB2YXIgQ29uc3RydWN0b3IgPSAoYnlUeXBlLmhhc093blByb3BlcnR5KHR5cGUpID8gYnlUeXBlW3R5cGVdIDogbnVsbCk7CiAgICAgICAgaWYgKCFDb25zdHJ1Y3RvcikgewogICAgICAgICAgdGhyb3cgJHNjZU1pbkVycignaWNvbnRleHQnLAogICAgICAgICAgICAnQXR0ZW1wdGVkIHRvIHRydXN0IGEgdmFsdWUgaW4gaW52YWxpZCBjb250ZXh0LiBDb250ZXh0OiB7MH07IFZhbHVlOiB7MX0nLAogICAgICAgICAgICB0eXBlLCB0cnVzdGVkVmFsdWUpOwogICAgICAgIH0KICAgICAgICBpZiAodHJ1c3RlZFZhbHVlID09PSBudWxsIHx8IHRydXN0ZWRWYWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHRydXN0ZWRWYWx1ZSA9PT0gJycpIHsKICAgICAgICAgIHJldHVybiB0cnVzdGVkVmFsdWU7CiAgICAgICAgfQogICAgICAgIC8vIEFsbCB0aGUgY3VycmVudCBjb250ZXh0cyBpbiBTQ0VfQ09OVEVYVFMgaGFwcGVuIHRvIGJlIHN0cmluZ3MuICBJbiBvcmRlciB0byBhdm9pZCB0cnVzdGluZwogICAgICAgIC8vIG11dGFibGUgb2JqZWN0cywgd2UgZW5zdXJlIGhlcmUgdGhhdCB0aGUgdmFsdWUgcGFzc2VkIGluIGlzIGFjdHVhbGx5IGEgc3RyaW5nLgogICAgICAgIGlmICh0eXBlb2YgdHJ1c3RlZFZhbHVlICE9PSAnc3RyaW5nJykgewogICAgICAgICAgdGhyb3cgJHNjZU1pbkVycignaXR5cGUnLAogICAgICAgICAgICAnQXR0ZW1wdGVkIHRvIHRydXN0IGEgbm9uLXN0cmluZyB2YWx1ZSBpbiBhIGNvbnRlbnQgcmVxdWlyaW5nIGEgc3RyaW5nOiBDb250ZXh0OiB7MH0nLAogICAgICAgICAgICB0eXBlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBDb25zdHJ1Y3Rvcih0cnVzdGVkVmFsdWUpOwogICAgICB9CgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlRGVsZWdhdGUjdmFsdWVPZgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogSWYgdGhlIHBhc3NlZCBwYXJhbWV0ZXIgaGFkIGJlZW4gcmV0dXJuZWQgYnkgYSBwcmlvciBjYWxsIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcwogICAgICogYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0sIHJldHVybnMgdGhlIHZhbHVlIHRoYXQgaGFkIGJlZW4gcGFzc2VkIHRvIHtAbGluawogICAgICAgICogbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0uCiAgICAgICAqCiAgICAgICAqIElmIHRoZSBwYXNzZWQgcGFyYW1ldGVyIGlzIG5vdCBhIHZhbHVlIHRoYXQgaGFkIGJlZW4gcmV0dXJuZWQgYnkge0BsaW5rCiAgICAgICAgKiBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSwgcmV0dXJucyBpdCBhcy1pcy4KICAgICAgICoKICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgcmVzdWx0IG9mIGEgcHJpb3Ige0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBc2B9CiAgICAgICAqICAgICAgY2FsbCBvciBhbnl0aGluZyBlbHNlLgogICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIGB2YWx1ZWAgdGhhdCB3YXMgb3JpZ2luYWxseSBwcm92aWRlZCB0byB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAqICAgICBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSBpZiBgdmFsdWVgIGlzIHRoZSByZXN1bHQgb2Ygc3VjaCBhIGNhbGwuICBPdGhlcndpc2UsIHJldHVybnMKICAgICAgICogICAgIGB2YWx1ZWAgdW5jaGFuZ2VkLgogICAgICAgKi8KICAgICAgZnVuY3Rpb24gdmFsdWVPZihtYXliZVRydXN0ZWQpIHsKICAgICAgICBpZiAobWF5YmVUcnVzdGVkIGluc3RhbmNlb2YgdHJ1c3RlZFZhbHVlSG9sZGVyQmFzZSkgewogICAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZC4kJHVud3JhcFRydXN0ZWRWYWx1ZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gbWF5YmVUcnVzdGVkOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZURlbGVnYXRlI2dldFRydXN0ZWQKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFRha2VzIHRoZSByZXN1bHQgb2YgYSB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMgYCRzY2VEZWxlZ2F0ZS50cnVzdEFzYH0gY2FsbCBhbmQKICAgICAgICogcmV0dXJucyB0aGUgb3JpZ2luYWxseSBzdXBwbGllZCB2YWx1ZSBpZiB0aGUgcXVlcmllZCBjb250ZXh0IHR5cGUgaXMgYSBzdXBlcnR5cGUgb2YgdGhlCiAgICAgICAqIGNyZWF0ZWQgdHlwZS4gIElmIHRoaXMgY29uZGl0aW9uIGlzbid0IHNhdGlzZmllZCwgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgVGhlIGtpbmQgb2YgY29udGV4dCBpbiB3aGljaCB0aGlzIHZhbHVlIGlzIHRvIGJlIHVzZWQuCiAgICAgICAqIEBwYXJhbSB7Kn0gbWF5YmVUcnVzdGVkIFRoZSByZXN1bHQgb2YgYSBwcmlvciB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAqICAgICBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSBjYWxsLgogICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHZhbHVlIHRoZSB3YXMgb3JpZ2luYWxseSBwcm92aWRlZCB0byB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI3RydXN0QXMKICAgICAqICAgICBgJHNjZURlbGVnYXRlLnRydXN0QXNgfSBpZiB2YWxpZCBpbiB0aGlzIGNvbnRleHQuICBPdGhlcndpc2UsIHRocm93cyBhbiBleGNlcHRpb24uCiAgICAgICAqLwogICAgICBmdW5jdGlvbiBnZXRUcnVzdGVkKHR5cGUsIG1heWJlVHJ1c3RlZCkgewogICAgICAgIGlmIChtYXliZVRydXN0ZWQgPT09IG51bGwgfHwgbWF5YmVUcnVzdGVkID09PSB1bmRlZmluZWQgfHwgbWF5YmVUcnVzdGVkID09PSAnJykgewogICAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZDsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbnN0cnVjdG9yID0gKGJ5VHlwZS5oYXNPd25Qcm9wZXJ0eSh0eXBlKSA/IGJ5VHlwZVt0eXBlXSA6IG51bGwpOwogICAgICAgIGlmIChjb25zdHJ1Y3RvciAmJiBtYXliZVRydXN0ZWQgaW5zdGFuY2VvZiBjb25zdHJ1Y3RvcikgewogICAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZC4kJHVud3JhcFRydXN0ZWRWYWx1ZSgpOwogICAgICAgIH0KICAgICAgICAvLyBJZiB3ZSBnZXQgaGVyZSwgdGhlbiB3ZSBtYXkgb25seSB0YWtlIG9uZSBvZiB0d28gYWN0aW9ucy4KICAgICAgICAvLyAxLiBzYW5pdGl6ZSB0aGUgdmFsdWUgZm9yIHRoZSByZXF1ZXN0ZWQgdHlwZSwgb3IKICAgICAgICAvLyAyLiB0aHJvdyBhbiBleGNlcHRpb24uCiAgICAgICAgaWYgKHR5cGUgPT09IFNDRV9DT05URVhUUy5SRVNPVVJDRV9VUkwpIHsKICAgICAgICAgIGlmIChpc1Jlc291cmNlVXJsQWxsb3dlZEJ5UG9saWN5KG1heWJlVHJ1c3RlZCkpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlVHJ1c3RlZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2luc2VjdXJsJywKICAgICAgICAgICAgICAnQmxvY2tlZCBsb2FkaW5nIHJlc291cmNlIGZyb20gdXJsIG5vdCBhbGxvd2VkIGJ5ICRzY2VEZWxlZ2F0ZSBwb2xpY3kuICBVUkw6IHswfScsCiAgICAgICAgICAgICAgbWF5YmVUcnVzdGVkLnRvU3RyaW5nKCkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gU0NFX0NPTlRFWFRTLkhUTUwpIHsKICAgICAgICAgIHJldHVybiBodG1sU2FuaXRpemVyKG1heWJlVHJ1c3RlZCk7CiAgICAgICAgfQogICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ3Vuc2FmZScsICdBdHRlbXB0aW5nIHRvIHVzZSBhbiB1bnNhZmUgdmFsdWUgaW4gYSBzYWZlIGNvbnRleHQuJyk7CiAgICAgIH0KCiAgICAgIHJldHVybiB7IHRydXN0QXM6IHRydXN0QXMsCiAgICAgICAgZ2V0VHJ1c3RlZDogZ2V0VHJ1c3RlZCwKICAgICAgICB2YWx1ZU9mOiB2YWx1ZU9mIH07CiAgICB9XTsKICB9CgoKICAvKioKICAgKiBAbmdkb2MgcHJvdmlkZXIKICAgKiBAbmFtZSAkc2NlUHJvdmlkZXIKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIFRoZSAkc2NlUHJvdmlkZXIgcHJvdmlkZXIgYWxsb3dzIGRldmVsb3BlcnMgdG8gY29uZmlndXJlIHRoZSB7QGxpbmsgbmcuJHNjZSAkc2NlfSBzZXJ2aWNlLgogICAqIC0gICBlbmFibGUvZGlzYWJsZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKSBpbiBhIG1vZHVsZQogICAqIC0gICBvdmVycmlkZSB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiB3aXRoIGEgY3VzdG9tIGRlbGVnYXRlCiAgICoKICAgKiBSZWFkIG1vcmUgYWJvdXQge0BsaW5rIG5nLiRzY2UgU3RyaWN0IENvbnRleHR1YWwgRXNjYXBpbmcgKFNDRSl9LgogICAqLwoKICAvKiBqc2hpbnQgbWF4bGVuOiBmYWxzZSovCgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJHNjZQogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqIGAkc2NlYCBpcyBhIHNlcnZpY2UgdGhhdCBwcm92aWRlcyBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyBzZXJ2aWNlcyB0byBBbmd1bGFySlMuCiAgICoKICAgKiAjIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nCiAgICoKICAgKiBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKSBpcyBhIG1vZGUgaW4gd2hpY2ggQW5ndWxhckpTIHJlcXVpcmVzIGJpbmRpbmdzIGluIGNlcnRhaW4KICAgKiBjb250ZXh0cyB0byByZXN1bHQgaW4gYSB2YWx1ZSB0aGF0IGlzIG1hcmtlZCBhcyBzYWZlIHRvIHVzZSBmb3IgdGhhdCBjb250ZXh0LiAgT25lIGV4YW1wbGUgb2YKICAgKiBzdWNoIGEgY29udGV4dCBpcyBiaW5kaW5nIGFyYml0cmFyeSBodG1sIGNvbnRyb2xsZWQgYnkgdGhlIHVzZXIgdmlhIGBuZy1iaW5kLWh0bWxgLiAgV2UgcmVmZXIKICAgKiB0byB0aGVzZSBjb250ZXh0cyBhcyBwcml2aWxlZ2VkIG9yIFNDRSBjb250ZXh0cy4KICAgKgogICAqIEFzIG9mIHZlcnNpb24gMS4yLCBBbmd1bGFyIHNoaXBzIHdpdGggU0NFIGVuYWJsZWQgYnkgZGVmYXVsdC4KICAgKgogICAqIE5vdGU6ICBXaGVuIGVuYWJsZWQgKHRoZSBkZWZhdWx0KSwgSUU4IGluIHF1aXJrcyBtb2RlIGlzIG5vdCBzdXBwb3J0ZWQuICBJbiB0aGlzIG1vZGUsIElFOCBhbGxvd3MKICAgKiBvbmUgdG8gZXhlY3V0ZSBhcmJpdHJhcnkgamF2YXNjcmlwdCBieSB0aGUgdXNlIG9mIHRoZSBleHByZXNzaW9uKCkgc3ludGF4LiAgUmVmZXIKICAgKiA8aHR0cDovL2Jsb2dzLm1zZG4uY29tL2IvaWUvYXJjaGl2ZS8yMDA4LzEwLzE2L2VuZGluZy1leHByZXNzaW9ucy5hc3B4PiB0byBsZWFybiBtb3JlIGFib3V0IHRoZW0uCiAgICogWW91IGNhbiBlbnN1cmUgeW91ciBkb2N1bWVudCBpcyBpbiBzdGFuZGFyZHMgbW9kZSBhbmQgbm90IHF1aXJrcyBtb2RlIGJ5IGFkZGluZyBgPCFkb2N0eXBlIGh0bWw+YAogICAqIHRvIHRoZSB0b3Agb2YgeW91ciBIVE1MIGRvY3VtZW50LgogICAqCiAgICogU0NFIGFzc2lzdHMgaW4gd3JpdGluZyBjb2RlIGluIHdheSB0aGF0IChhKSBpcyBzZWN1cmUgYnkgZGVmYXVsdCBhbmQgKGIpIG1ha2VzIGF1ZGl0aW5nIGZvcgogICAqIHNlY3VyaXR5IHZ1bG5lcmFiaWxpdGllcyBzdWNoIGFzIFhTUywgY2xpY2tqYWNraW5nLCBldGMuIGEgbG90IGVhc2llci4KICAgKgogICAqIEhlcmUncyBhbiBleGFtcGxlIG9mIGEgYmluZGluZyBpbiBhIHByaXZpbGVnZWQgY29udGV4dDoKICAgKgogICAqIDxwcmUgY2xhc3M9InByZXR0eXByaW50Ij4KICAgKiAgICAgPGlucHV0IG5nLW1vZGVsPSJ1c2VySHRtbCI+CiAgICogICAgIDxkaXYgbmctYmluZC1odG1sPSJ1c2VySHRtbCI+CiAgICogPC9wcmU+CiAgICoKICAgKiBOb3RpY2UgdGhhdCBgbmctYmluZC1odG1sYCBpcyBib3VuZCB0byBgdXNlckh0bWxgIGNvbnRyb2xsZWQgYnkgdGhlIHVzZXIuICBXaXRoIFNDRQogICAqIGRpc2FibGVkLCB0aGlzIGFwcGxpY2F0aW9uIGFsbG93cyB0aGUgdXNlciB0byByZW5kZXIgYXJiaXRyYXJ5IEhUTUwgaW50byB0aGUgRElWLgogICAqIEluIGEgbW9yZSByZWFsaXN0aWMgZXhhbXBsZSwgb25lIG1heSBiZSByZW5kZXJpbmcgdXNlciBjb21tZW50cywgYmxvZyBhcnRpY2xlcywgZXRjLiB2aWEKICAgKiBiaW5kaW5ncy4gIChIVE1MIGlzIGp1c3Qgb25lIGV4YW1wbGUgb2YgYSBjb250ZXh0IHdoZXJlIHJlbmRlcmluZyB1c2VyIGNvbnRyb2xsZWQgaW5wdXQgY3JlYXRlcwogICAqIHNlY3VyaXR5IHZ1bG5lcmFiaWxpdGllcy4pCiAgICoKICAgKiBGb3IgdGhlIGNhc2Ugb2YgSFRNTCwgeW91IG1pZ2h0IHVzZSBhIGxpYnJhcnksIGVpdGhlciBvbiB0aGUgY2xpZW50IHNpZGUsIG9yIG9uIHRoZSBzZXJ2ZXIgc2lkZSwKICAgKiB0byBzYW5pdGl6ZSB1bnNhZmUgSFRNTCBiZWZvcmUgYmluZGluZyB0byB0aGUgdmFsdWUgYW5kIHJlbmRlcmluZyBpdCBpbiB0aGUgZG9jdW1lbnQuCiAgICoKICAgKiBIb3cgd291bGQgeW91IGVuc3VyZSB0aGF0IGV2ZXJ5IHBsYWNlIHRoYXQgdXNlZCB0aGVzZSB0eXBlcyBvZiBiaW5kaW5ncyB3YXMgYm91bmQgdG8gYSB2YWx1ZSB0aGF0CiAgICogd2FzIHNhbml0aXplZCBieSB5b3VyIGxpYnJhcnkgKG9yIHJldHVybmVkIGFzIHNhZmUgZm9yIHJlbmRlcmluZyBieSB5b3VyIHNlcnZlcj8pICBIb3cgY2FuIHlvdQogICAqIGVuc3VyZSB0aGF0IHlvdSBkaWRuJ3QgYWNjaWRlbnRhbGx5IGRlbGV0ZSB0aGUgbGluZSB0aGF0IHNhbml0aXplZCB0aGUgdmFsdWUsIG9yIHJlbmFtZWQgc29tZQogICAqIHByb3BlcnRpZXMvZmllbGRzIGFuZCBmb3Jnb3QgdG8gdXBkYXRlIHRoZSBiaW5kaW5nIHRvIHRoZSBzYW5pdGl6ZWQgdmFsdWU/CiAgICoKICAgKiBUbyBiZSBzZWN1cmUgYnkgZGVmYXVsdCwgeW91IHdhbnQgdG8gZW5zdXJlIHRoYXQgYW55IHN1Y2ggYmluZGluZ3MgYXJlIGRpc2FsbG93ZWQgdW5sZXNzIHlvdSBjYW4KICAgKiBkZXRlcm1pbmUgdGhhdCBzb21ldGhpbmcgZXhwbGljaXRseSBzYXlzIGl0J3Mgc2FmZSB0byB1c2UgYSB2YWx1ZSBmb3IgYmluZGluZyBpbiB0aGF0CiAgICogY29udGV4dC4gIFlvdSBjYW4gdGhlbiBhdWRpdCB5b3VyIGNvZGUgKGEgc2ltcGxlIGdyZXAgd291bGQgZG8pIHRvIGVuc3VyZSB0aGF0IHRoaXMgaXMgb25seSBkb25lCiAgICogZm9yIHRob3NlIHZhbHVlcyB0aGF0IHlvdSBjYW4gZWFzaWx5IHRlbGwgYXJlIHNhZmUgLSBiZWNhdXNlIHRoZXkgd2VyZSByZWNlaXZlZCBmcm9tIHlvdXIgc2VydmVyLAogICAqIHNhbml0aXplZCBieSB5b3VyIGxpYnJhcnksIGV0Yy4gIFlvdSBjYW4gb3JnYW5pemUgeW91ciBjb2RlYmFzZSB0byBoZWxwIHdpdGggdGhpcyAtIHBlcmhhcHMKICAgKiBhbGxvd2luZyBvbmx5IHRoZSBmaWxlcyBpbiBhIHNwZWNpZmljIGRpcmVjdG9yeSB0byBkbyB0aGlzLiAgRW5zdXJpbmcgdGhhdCB0aGUgaW50ZXJuYWwgQVBJCiAgICogZXhwb3NlZCBieSB0aGF0IGNvZGUgZG9lc24ndCBtYXJrdXAgYXJiaXRyYXJ5IHZhbHVlcyBhcyBzYWZlIHRoZW4gYmVjb21lcyBhIG1vcmUgbWFuYWdlYWJsZSB0YXNrLgogICAqCiAgICogSW4gdGhlIGNhc2Ugb2YgQW5ndWxhckpTJyBTQ0Ugc2VydmljZSwgb25lIHVzZXMge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9CiAgICogKGFuZCBzaG9ydGhhbmQgbWV0aG9kcyBzdWNoIGFzIHtAbGluayBuZy4kc2NlI3RydXN0QXNIdG1sICRzY2UudHJ1c3RBc0h0bWx9LCBldGMuKSB0bwogICAqIG9idGFpbiB2YWx1ZXMgdGhhdCB3aWxsIGJlIGFjY2VwdGVkIGJ5IFNDRSAvIHByaXZpbGVnZWQgY29udGV4dHMuCiAgICoKICAgKgogICAqICMjIEhvdyBkb2VzIGl0IHdvcms/CiAgICoKICAgKiBJbiBwcml2aWxlZ2VkIGNvbnRleHRzLCBkaXJlY3RpdmVzIGFuZCBjb2RlIHdpbGwgYmluZCB0byB0aGUgcmVzdWx0IG9mIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWQKICogJHNjZS5nZXRUcnVzdGVkKGNvbnRleHQsIHZhbHVlKX0gcmF0aGVyIHRoYW4gdG8gdGhlIHZhbHVlIGRpcmVjdGx5LiAgRGlyZWN0aXZlcyB1c2Uge0BsaW5rCiAgICAqIG5nLiRzY2UjcGFyc2UgJHNjZS5wYXJzZUFzfSByYXRoZXIgdGhhbiBgJHBhcnNlYCB0byB3YXRjaCBhdHRyaWJ1dGUgYmluZGluZ3MsIHdoaWNoIHBlcmZvcm1zIHRoZQogICAqIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWQgJHNjZS5nZXRUcnVzdGVkfSBiZWhpbmQgdGhlIHNjZW5lcyBvbiBub24tY29uc3RhbnQgbGl0ZXJhbHMuCiAgICoKICAgKiBBcyBhbiBleGFtcGxlLCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQmluZEh0bWwgbmdCaW5kSHRtbH0gdXNlcyB7QGxpbmsKICAgICogbmcuJHNjZSNwYXJzZUFzSHRtbCAkc2NlLnBhcnNlQXNIdG1sKGJpbmRpbmcgZXhwcmVzc2lvbil9LiAgSGVyZSdzIHRoZSBhY3R1YWwgY29kZSAoc2xpZ2h0bHkKICAgKiBzaW1wbGlmaWVkKToKICAgKgogICAqIDxwcmUgY2xhc3M9InByZXR0eXByaW50Ij4KICAgKiAgIHZhciBuZ0JpbmRIdG1sRGlyZWN0aXZlID0gWyckc2NlJywgZnVuY3Rpb24oJHNjZSkgewogKiAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAqICAgICAgIHNjb3BlLiR3YXRjaCgkc2NlLnBhcnNlQXNIdG1sKGF0dHIubmdCaW5kSHRtbCksIGZ1bmN0aW9uKHZhbHVlKSB7CiAqICAgICAgICAgZWxlbWVudC5odG1sKHZhbHVlIHx8ICcnKTsKICogICAgICAgfSk7CiAqICAgICB9OwogKiAgIH1dOwogICAqIDwvcHJlPgogICAqCiAgICogIyMgSW1wYWN0IG9uIGxvYWRpbmcgdGVtcGxhdGVzCiAgICoKICAgKiBUaGlzIGFwcGxpZXMgYm90aCB0byB0aGUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0luY2x1ZGUgYG5nLWluY2x1ZGVgfSBkaXJlY3RpdmUgYXMgd2VsbCBhcwogICAqIGB0ZW1wbGF0ZVVybGAncyBzcGVjaWZpZWQgYnkge0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIEFuZ3VsYXIgb25seSBsb2FkcyB0ZW1wbGF0ZXMgZnJvbSB0aGUgc2FtZSBkb21haW4gYW5kIHByb3RvY29sIGFzIHRoZSBhcHBsaWNhdGlvbgogICAqIGRvY3VtZW50LiAgVGhpcyBpcyBkb25lIGJ5IGNhbGxpbmcge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAqICRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsfSBvbiB0aGUgdGVtcGxhdGUgVVJMLiAgVG8gbG9hZCB0ZW1wbGF0ZXMgZnJvbSBvdGhlciBkb21haW5zIGFuZC9vcgogICAqIHByb3RvY29scywgeW91IG1heSBlaXRoZXIgZWl0aGVyIHtAbGluayBuZy4kc2NlRGVsZWdhdGVQcm92aWRlciNyZXNvdXJjZVVybFdoaXRlbGlzdCB3aGl0ZWxpc3QKICogdGhlbX0gb3Ige0BsaW5rIG5nLiRzY2UjdHJ1c3RBc1Jlc291cmNlVXJsIHdyYXAgaXR9IGludG8gYSB0cnVzdGVkIHZhbHVlLgogICAqCiAgICogKlBsZWFzZSBub3RlKjoKICAgKiBUaGUgYnJvd3NlcidzCiAgICogW1NhbWUgT3JpZ2luIFBvbGljeV0oaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9icm93c2Vyc2VjL3dpa2kvUGFydDIjU2FtZS1vcmlnaW5fcG9saWN5X2Zvcl9YTUxIdHRwUmVxdWVzdCkKICAgKiBhbmQgW0Nyb3NzLU9yaWdpbiBSZXNvdXJjZSBTaGFyaW5nIChDT1JTKV0oaHR0cDovL3d3dy53My5vcmcvVFIvY29ycy8pCiAgICogcG9saWN5IGFwcGx5IGluIGFkZGl0aW9uIHRvIHRoaXMgYW5kIG1heSBmdXJ0aGVyIHJlc3RyaWN0IHdoZXRoZXIgdGhlIHRlbXBsYXRlIGlzIHN1Y2Nlc3NmdWxseQogICAqIGxvYWRlZC4gIFRoaXMgbWVhbnMgdGhhdCB3aXRob3V0IHRoZSByaWdodCBDT1JTIHBvbGljeSwgbG9hZGluZyB0ZW1wbGF0ZXMgZnJvbSBhIGRpZmZlcmVudCBkb21haW4KICAgKiB3b24ndCB3b3JrIG9uIGFsbCBicm93c2Vycy4gIEFsc28sIGxvYWRpbmcgdGVtcGxhdGVzIGZyb20gYGZpbGU6Ly9gIFVSTCBkb2VzIG5vdCB3b3JrIG9uIHNvbWUKICAgKiBicm93c2Vycy4KICAgKgogICAqICMjIFRoaXMgZmVlbHMgbGlrZSB0b28gbXVjaCBvdmVyaGVhZCBmb3IgdGhlIGRldmVsb3Blcj8KICAgKgogICAqIEl0J3MgaW1wb3J0YW50IHRvIHJlbWVtYmVyIHRoYXQgU0NFIG9ubHkgYXBwbGllcyB0byBpbnRlcnBvbGF0aW9uIGV4cHJlc3Npb25zLgogICAqCiAgICogSWYgeW91ciBleHByZXNzaW9ucyBhcmUgY29uc3RhbnQgbGl0ZXJhbHMsIHRoZXkncmUgYXV0b21hdGljYWxseSB0cnVzdGVkIGFuZCB5b3UgZG9uJ3QgbmVlZCB0bwogICAqIGNhbGwgYCRzY2UudHJ1c3RBc2Agb24gdGhlbSAocmVtZW1iZXIgdG8gaW5jbHVkZSB0aGUgYG5nU2FuaXRpemVgIG1vZHVsZSkgKGUuZy4KICAgKiBgPGRpdiBuZy1iaW5kLWh0bWw9Iic8Yj5pbXBsaWNpdGx5IHRydXN0ZWQ8L2I+JyI+PC9kaXY+YCkganVzdCB3b3Jrcy4KICAgKgogICAqIEFkZGl0aW9uYWxseSwgYGFbaHJlZl1gIGFuZCBgaW1nW3NyY11gIGF1dG9tYXRpY2FsbHkgc2FuaXRpemUgdGhlaXIgVVJMcyBhbmQgZG8gbm90IHBhc3MgdGhlbQogICAqIHRocm91Z2gge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZCAkc2NlLmdldFRydXN0ZWR9LiAgU0NFIGRvZXNuJ3QgcGxheSBhIHJvbGUgaGVyZS4KICAgKgogICAqIFRoZSBpbmNsdWRlZCB7QGxpbmsgbmcuJHNjZURlbGVnYXRlICRzY2VEZWxlZ2F0ZX0gY29tZXMgd2l0aCBzYW5lIGRlZmF1bHRzIHRvIGFsbG93IHlvdSB0byBsb2FkCiAgICogdGVtcGxhdGVzIGluIGBuZy1pbmNsdWRlYCBmcm9tIHlvdXIgYXBwbGljYXRpb24ncyBkb21haW4gd2l0aG91dCBoYXZpbmcgdG8gZXZlbiBrbm93IGFib3V0IFNDRS4KICAgKiBJdCBibG9ja3MgbG9hZGluZyB0ZW1wbGF0ZXMgZnJvbSBvdGhlciBkb21haW5zIG9yIGxvYWRpbmcgdGVtcGxhdGVzIG92ZXIgaHR0cCBmcm9tIGFuIGh0dHBzCiAgICogc2VydmVkIGRvY3VtZW50LiAgWW91IGNhbiBjaGFuZ2UgdGhlc2UgYnkgc2V0dGluZyB5b3VyIG93biBjdXN0b20ge0BsaW5rCiAgICAqIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0IHdoaXRlbGlzdHN9IGFuZCB7QGxpbmsKICAgICogbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgYmxhY2tsaXN0c30gZm9yIG1hdGNoaW5nIHN1Y2ggVVJMcy4KICAgKgogICAqIFRoaXMgc2lnbmlmaWNhbnRseSByZWR1Y2VzIHRoZSBvdmVyaGVhZC4gIEl0IGlzIGZhciBlYXNpZXIgdG8gcGF5IHRoZSBzbWFsbCBvdmVyaGVhZCBhbmQgaGF2ZSBhbgogICAqIGFwcGxpY2F0aW9uIHRoYXQncyBzZWN1cmUgYW5kIGNhbiBiZSBhdWRpdGVkIHRvIHZlcmlmeSB0aGF0IHdpdGggbXVjaCBtb3JlIGVhc2UgdGhhbiBib2x0aW5nCiAgICogc2VjdXJpdHkgb250byBhbiBhcHBsaWNhdGlvbiBsYXRlci4KICAgKgogICAqIDxhIG5hbWU9ImNvbnRleHRzIj48L2E+CiAgICogIyMgV2hhdCB0cnVzdGVkIGNvbnRleHQgdHlwZXMgYXJlIHN1cHBvcnRlZD8KICAgKgogICAqIHwgQ29udGV4dCAgICAgICAgICAgICB8IE5vdGVzICAgICAgICAgIHwKICAgKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS18CiAgICogfCBgJHNjZS5IVE1MYCAgICAgICAgIHwgRm9yIEhUTUwgdGhhdCdzIHNhZmUgdG8gc291cmNlIGludG8gdGhlIGFwcGxpY2F0aW9uLiAgVGhlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdCaW5kSHRtbCBuZ0JpbmRIdG1sfSBkaXJlY3RpdmUgdXNlcyB0aGlzIGNvbnRleHQgZm9yIGJpbmRpbmdzLiBJZiBhbiB1bnNhZmUgdmFsdWUgaXMgZW5jb3VudGVyZWQgYW5kIHRoZSB7QGxpbmsgbmdTYW5pdGl6ZSAkc2FuaXRpemV9IG1vZHVsZSBpcyBwcmVzZW50IHRoaXMgd2lsbCBzYW5pdGl6ZSB0aGUgdmFsdWUgaW5zdGVhZCBvZiB0aHJvd2luZyBhbiBlcnJvci4gfAogICAqIHwgYCRzY2UuQ1NTYCAgICAgICAgICB8IEZvciBDU1MgdGhhdCdzIHNhZmUgdG8gc291cmNlIGludG8gdGhlIGFwcGxpY2F0aW9uLiAgQ3VycmVudGx5IHVudXNlZC4gIEZlZWwgZnJlZSB0byB1c2UgaXQgaW4geW91ciBvd24gZGlyZWN0aXZlcy4gfAogICAqIHwgYCRzY2UuVVJMYCAgICAgICAgICB8IEZvciBVUkxzIHRoYXQgYXJlIHNhZmUgdG8gZm9sbG93IGFzIGxpbmtzLiAgQ3VycmVudGx5IHVudXNlZCAoYDxhIGhyZWY9YCBhbmQgYDxpbWcgc3JjPWAgc2FuaXRpemUgdGhlaXIgdXJscyBhbmQgZG9uJ3QgY29uc3RpdHV0ZSBhbiBTQ0UgY29udGV4dC4gfAogICAqIHwgYCRzY2UuUkVTT1VSQ0VfVVJMYCB8IEZvciBVUkxzIHRoYXQgYXJlIG5vdCBvbmx5IHNhZmUgdG8gZm9sbG93IGFzIGxpbmtzLCBidXQgd2hvc2UgY29udGVudHMgYXJlIGFsc28gc2FmZSB0byBpbmNsdWRlIGluIHlvdXIgYXBwbGljYXRpb24uICBFeGFtcGxlcyBpbmNsdWRlIGBuZy1pbmNsdWRlYCwgYHNyY2AgLyBgbmdTcmNgIGJpbmRpbmdzIGZvciB0YWdzIG90aGVyIHRoYW4gYElNR2AgKGUuZy4gYElGUkFNRWAsIGBPQkpFQ1RgLCBldGMuKSAgPGJyPjxicj5Ob3RlIHRoYXQgYCRzY2UuUkVTT1VSQ0VfVVJMYCBtYWtlcyBhIHN0cm9uZ2VyIHN0YXRlbWVudCBhYm91dCB0aGUgVVJMIHRoYW4gYCRzY2UuVVJMYCBkb2VzIGFuZCB0aGVyZWZvcmUgY29udGV4dHMgcmVxdWlyaW5nIHZhbHVlcyB0cnVzdGVkIGZvciBgJHNjZS5SRVNPVVJDRV9VUkxgIGNhbiBiZSB1c2VkIGFueXdoZXJlIHRoYXQgdmFsdWVzIHRydXN0ZWQgZm9yIGAkc2NlLlVSTGAgYXJlIHJlcXVpcmVkLiB8CiAgICogfCBgJHNjZS5KU2AgICAgICAgICAgIHwgRm9yIEphdmFTY3JpcHQgdGhhdCBpcyBzYWZlIHRvIGV4ZWN1dGUgaW4geW91ciBhcHBsaWNhdGlvbidzIGNvbnRleHQuICBDdXJyZW50bHkgdW51c2VkLiAgRmVlbCBmcmVlIHRvIHVzZSBpdCBpbiB5b3VyIG93biBkaXJlY3RpdmVzLiB8CiAgICoKICAgKiAjIyBGb3JtYXQgb2YgaXRlbXMgaW4ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0IHJlc291cmNlVXJsV2hpdGVsaXN0fS97QGxpbmsgbmcuJHNjZURlbGVnYXRlUHJvdmlkZXIjcmVzb3VyY2VVcmxCbGFja2xpc3QgQmxhY2tsaXN0fSA8YSBuYW1lPSJyZXNvdXJjZVVybFBhdHRlcm5JdGVtIj48L2E+CiAgICoKICAgKiAgRWFjaCBlbGVtZW50IGluIHRoZXNlIGFycmF5cyBtdXN0IGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nOgogICAqCiAgICogIC0gKionc2VsZicqKgogICAqICAgIC0gVGhlIHNwZWNpYWwgKipzdHJpbmcqKiwgYCdzZWxmJ2AsIGNhbiBiZSB1c2VkIHRvIG1hdGNoIGFnYWluc3QgYWxsIFVSTHMgb2YgdGhlICoqc2FtZQogICAqICAgICAgZG9tYWluKiogYXMgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVzaW5nIHRoZSAqKnNhbWUgcHJvdG9jb2wqKi4KICAgKiAgLSAqKlN0cmluZyoqIChleGNlcHQgdGhlIHNwZWNpYWwgdmFsdWUgYCdzZWxmJ2ApCiAgICogICAgLSBUaGUgc3RyaW5nIGlzIG1hdGNoZWQgYWdhaW5zdCB0aGUgZnVsbCAqbm9ybWFsaXplZCAvIGFic29sdXRlIFVSTCogb2YgdGhlIHJlc291cmNlCiAgICogICAgICBiZWluZyB0ZXN0ZWQgKHN1YnN0cmluZyBtYXRjaGVzIGFyZSBub3QgZ29vZCBlbm91Z2guKQogICAqICAgIC0gVGhlcmUgYXJlIGV4YWN0bHkgKip0d28gd2lsZGNhcmQgc2VxdWVuY2VzKiogLSBgKmAgYW5kIGAqKmAuICBBbGwgb3RoZXIgY2hhcmFjdGVycwogICAqICAgICAgbWF0Y2ggdGhlbXNlbHZlcy4KICAgKiAgICAtIGAqYDogbWF0Y2hlcyB6ZXJvIG9yIG1vcmUgb2NjdXJyZW5jZXMgb2YgYW55IGNoYXJhY3RlciBvdGhlciB0aGFuIG9uZSBvZiB0aGUgZm9sbG93aW5nIDYKICAgKiAgICAgIGNoYXJhY3RlcnM6ICdgOmAnLCAnYC9gJywgJ2AuYCcsICdgP2AnLCAnYCZgJyBhbmQgJzsnLiAgSXQncyBhIHVzZWZ1bCB3aWxkY2FyZCBmb3IgdXNlCiAgICogICAgICBpbiBhIHdoaXRlbGlzdC4KICAgKiAgICAtIGAqKmA6IG1hdGNoZXMgemVybyBvciBtb3JlIG9jY3VycmVuY2VzIG9mICphbnkqIGNoYXJhY3Rlci4gIEFzIHN1Y2gsIGl0J3Mgbm90CiAgICogICAgICBub3QgYXBwcm9wcmlhdGUgdG8gdXNlIGluIGZvciBhIHNjaGVtZSwgZG9tYWluLCBldGMuIGFzIGl0IHdvdWxkIG1hdGNoIHRvbyBtdWNoLiAgKGUuZy4KICAgKiAgICAgIGh0dHA6Ly8qKi5leGFtcGxlLmNvbS8gd291bGQgbWF0Y2ggaHR0cDovL2V2aWwuY29tLz9pZ25vcmU9LmV4YW1wbGUuY29tLyBhbmQgdGhhdCBtaWdodAogICAqICAgICAgbm90IGhhdmUgYmVlbiB0aGUgaW50ZW50aW9uLikgIEl0cyB1c2FnZSBhdCB0aGUgdmVyeSBlbmQgb2YgdGhlIHBhdGggaXMgb2suICAoZS5nLgogICAqICAgICAgaHR0cDovL2Zvby5leGFtcGxlLmNvbS90ZW1wbGF0ZXMvKiopLgogICAqICAtICoqUmVnRXhwKiogKCpzZWUgY2F2ZWF0IGJlbG93KikKICAgKiAgICAtICpDYXZlYXQqOiAgV2hpbGUgcmVndWxhciBleHByZXNzaW9ucyBhcmUgcG93ZXJmdWwgYW5kIG9mZmVyIGdyZWF0IGZsZXhpYmlsaXR5LCAgdGhlaXIgc3ludGF4CiAgICogICAgICAoYW5kIGFsbCB0aGUgaW5ldml0YWJsZSBlc2NhcGluZykgbWFrZXMgdGhlbSAqaGFyZGVyIHRvIG1haW50YWluKi4gIEl0J3MgZWFzeSB0bwogICAqICAgICAgYWNjaWRlbnRhbGx5IGludHJvZHVjZSBhIGJ1ZyB3aGVuIG9uZSB1cGRhdGVzIGEgY29tcGxleCBleHByZXNzaW9uIChpbWhvLCBhbGwgcmVnZXhlcyBzaG91bGQKICAgKiAgICAgIGhhdmUgZ29vZCB0ZXN0IGNvdmVyYWdlLikuICBGb3IgaW5zdGFuY2UsIHRoZSB1c2Ugb2YgYC5gIGluIHRoZSByZWdleCBpcyBjb3JyZWN0IG9ubHkgaW4gYQogICAqICAgICAgc21hbGwgbnVtYmVyIG9mIGNhc2VzLiAgQSBgLmAgY2hhcmFjdGVyIGluIHRoZSByZWdleCB1c2VkIHdoZW4gbWF0Y2hpbmcgdGhlIHNjaGVtZSBvciBhCiAgICogICAgICBzdWJkb21haW4gY291bGQgYmUgbWF0Y2hlZCBhZ2FpbnN0IGEgYDpgIG9yIGxpdGVyYWwgYC5gIHRoYXQgd2FzIGxpa2VseSBub3QgaW50ZW5kZWQuICAgSXQKICAgKiAgICAgIGlzIGhpZ2hseSByZWNvbW1lbmRlZCB0byB1c2UgdGhlIHN0cmluZyBwYXR0ZXJucyBhbmQgb25seSBmYWxsIGJhY2sgdG8gcmVndWxhciBleHByZXNzaW9ucwogICAqICAgICAgaWYgdGhleSBhcyBhIGxhc3QgcmVzb3J0LgogICAqICAgIC0gVGhlIHJlZ3VsYXIgZXhwcmVzc2lvbiBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIFJlZ0V4cCAoaS5lLiBub3QgYSBzdHJpbmcuKSAgSXQgaXMKICAgKiAgICAgIG1hdGNoZWQgYWdhaW5zdCB0aGUgKiplbnRpcmUqKiAqbm9ybWFsaXplZCAvIGFic29sdXRlIFVSTCogb2YgdGhlIHJlc291cmNlIGJlaW5nIHRlc3RlZAogICAqICAgICAgKGV2ZW4gd2hlbiB0aGUgUmVnRXhwIGRpZCBub3QgaGF2ZSB0aGUgYF5gIGFuZCBgJGAgY29kZXMuKSAgSW4gYWRkaXRpb24sIGFueSBmbGFncwogICAqICAgICAgcHJlc2VudCBvbiB0aGUgUmVnRXhwIChzdWNoIGFzIG11bHRpbGluZSwgZ2xvYmFsLCBpZ25vcmVDYXNlKSBhcmUgaWdub3JlZC4KICAgKiAgICAtIElmIHlvdSBhcmUgZ2VuZXJhdGluZyB5b3VyIEphdmFTY3JpcHQgZnJvbSBzb21lIG90aGVyIHRlbXBsYXRpbmcgZW5naW5lIChub3QKICAgKiAgICAgIHJlY29tbWVuZGVkLCBlLmcuIGluIGlzc3VlIFsjNDAwNl0oaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci5qcy9pc3N1ZXMvNDAwNikpLAogICAqICAgICAgcmVtZW1iZXIgdG8gZXNjYXBlIHlvdXIgcmVndWxhciBleHByZXNzaW9uIChhbmQgYmUgYXdhcmUgdGhhdCB5b3UgbWlnaHQgbmVlZCBtb3JlIHRoYW4KICAgKiAgICAgIG9uZSBsZXZlbCBvZiBlc2NhcGluZyBkZXBlbmRpbmcgb24geW91ciB0ZW1wbGF0aW5nIGVuZ2luZSBhbmQgdGhlIHdheSB5b3UgaW50ZXJwb2xhdGVkCiAgICogICAgICB0aGUgdmFsdWUuKSAgRG8gbWFrZSB1c2Ugb2YgeW91ciBwbGF0Zm9ybSdzIGVzY2FwaW5nIG1lY2hhbmlzbSBhcyBpdCBtaWdodCBiZSBnb29kCiAgICogICAgICBlbm91Z2ggYmVmb3JlIGNvZGluZyB5b3VyIG93bi4gIGUuZy4gUnVieSBoYXMKICAgKiAgICAgIFtSZWdleHAuZXNjYXBlKHN0cildKGh0dHA6Ly93d3cucnVieS1kb2Mub3JnL2NvcmUtMi4wLjAvUmVnZXhwLmh0bWwjbWV0aG9kLWMtZXNjYXBlKQogICAqICAgICAgYW5kIFB5dGhvbiBoYXMgW3JlLmVzY2FwZV0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L3JlLmh0bWwjcmUuZXNjYXBlKS4KICAgKiAgICAgIEphdmFzY3JpcHQgbGFja3MgYSBzaW1pbGFyIGJ1aWx0IGluIGZ1bmN0aW9uIGZvciBlc2NhcGluZy4gIFRha2UgYSBsb29rIGF0IEdvb2dsZQogICAqICAgICAgQ2xvc3VyZSBsaWJyYXJ5J3MgW2dvb2cuc3RyaW5nLnJlZ0V4cEVzY2FwZShzKV0oCiAgICogICAgICBodHRwOi8vZG9jcy5jbG9zdXJlLWxpYnJhcnkuZ29vZ2xlY29kZS5jb20vZ2l0L2Nsb3N1cmVfZ29vZ19zdHJpbmdfc3RyaW5nLmpzLnNvdXJjZS5odG1sI2xpbmU5NjIpLgogICAqCiAgICogUmVmZXIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyICRzY2VEZWxlZ2F0ZVByb3ZpZGVyfSBmb3IgYW4gZXhhbXBsZS4KICAgKgogICAqICMjIFNob3cgbWUgYW4gZXhhbXBsZSB1c2luZyBTQ0UuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9Im15U2NlQXBwIiBkZXBzPSJhbmd1bGFyLXNhbml0aXplLmpzIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctY29udHJvbGxlcj0ibXlBcHBDb250cm9sbGVyIGFzIG15Q3RybCI+CiAgIDxpIG5nLWJpbmQtaHRtbD0ibXlDdHJsLmV4cGxpY2l0bHlUcnVzdGVkSHRtbCIgaWQ9ImV4cGxpY2l0bHlUcnVzdGVkSHRtbCI+PC9pPjxicj48YnI+CiAgIDxiPlVzZXIgY29tbWVudHM8L2I+PGJyPgogICBCeSBkZWZhdWx0LCBIVE1MIHRoYXQgaXNuJ3QgZXhwbGljaXRseSB0cnVzdGVkIChlLmcuIEFsaWNlJ3MgY29tbWVudCkgaXMgc2FuaXRpemVkIHdoZW4KICAgJHNhbml0aXplIGlzIGF2YWlsYWJsZS4gIElmICRzYW5pdGl6ZSBpc24ndCBhdmFpbGFibGUsIHRoaXMgcmVzdWx0cyBpbiBhbiBlcnJvciBpbnN0ZWFkIG9mIGFuCiAgIGV4cGxvaXQuCiAgIDxkaXYgY2xhc3M9IndlbGwiPgogICA8ZGl2IG5nLXJlcGVhdD0idXNlckNvbW1lbnQgaW4gbXlDdHJsLnVzZXJDb21tZW50cyI+CiAgIDxiPnt7dXNlckNvbW1lbnQubmFtZX19PC9iPjoKICAgPHNwYW4gbmctYmluZC1odG1sPSJ1c2VyQ29tbWVudC5odG1sQ29tbWVudCIgY2xhc3M9Imh0bWxDb21tZW50Ij48L3NwYW4+CiAgIDxicj4KICAgPC9kaXY+CiAgIDwvZGl2PgogICA8L2Rpdj4KICAgPC9maWxlPgoKICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgdmFyIG15U2NlQXBwID0gYW5ndWxhci5tb2R1bGUoJ215U2NlQXBwJywgWyduZ1Nhbml0aXplJ10pOwoKICAgbXlTY2VBcHAuY29udHJvbGxlcigibXlBcHBDb250cm9sbGVyIiwgZnVuY3Rpb24gbXlBcHBDb250cm9sbGVyKCRodHRwLCAkdGVtcGxhdGVDYWNoZSwgJHNjZSkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgJGh0dHAuZ2V0KCJ0ZXN0X2RhdGEuanNvbiIsIHtjYWNoZTogJHRlbXBsYXRlQ2FjaGV9KS5zdWNjZXNzKGZ1bmN0aW9uKHVzZXJDb21tZW50cykgewogICAgICBzZWxmLnVzZXJDb21tZW50cyA9IHVzZXJDb21tZW50czsKICAgIH0pOwogICAgc2VsZi5leHBsaWNpdGx5VHJ1c3RlZEh0bWwgPSAkc2NlLnRydXN0QXNIdG1sKAogICAgICAgICc8c3BhbiBvbm1vdXNlb3Zlcj0idGhpcy50ZXh0Q29udGVudD0mcXVvdDtFeHBsaWNpdGx5IHRydXN0ZWQgSFRNTCBieXBhc3NlcyAnICsKICAgICAgICAnc2FuaXRpemF0aW9uLiZxdW90OyI+SG92ZXIgb3ZlciB0aGlzIHRleHQuPC9zcGFuPicpOwogIH0pOwogICA8L2ZpbGU+CgogICA8ZmlsZSBuYW1lPSJ0ZXN0X2RhdGEuanNvbiI+CiAgIFsKICAgeyAibmFtZSI6ICJBbGljZSIsCiAgICAiaHRtbENvbW1lbnQiOgogICAgICAgICI8c3BhbiBvbm1vdXNlb3Zlcj0ndGhpcy50ZXh0Q29udGVudD1cIlBXTjNEIVwiJz5JcyA8aT5hbnlvbmU8L2k+IHJlYWRpbmcgdGhpcz88L3NwYW4+IgogIH0sCiAgIHsgIm5hbWUiOiAiQm9iIiwKICAgICJodG1sQ29tbWVudCI6ICI8aT5ZZXMhPC9pPiAgQW0gSSB0aGUgb25seSBvdGhlciBvbmU/IgogIH0KICAgXQogICA8L2ZpbGU+CgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgZGVzY3JpYmUoJ1NDRSBkb2MgZGVtbycsIGZ1bmN0aW9uKCkgewogICAgaXQoJ3Nob3VsZCBzYW5pdGl6ZSB1bnRydXN0ZWQgdmFsdWVzJywgZnVuY3Rpb24oKSB7CiAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnLmh0bWxDb21tZW50JykpLmdldElubmVySHRtbCgpKQogICAgICAgICAgLnRvQmUoJzxzcGFuPklzIDxpPmFueW9uZTwvaT4gcmVhZGluZyB0aGlzPzwvc3Bhbj4nKTsKICAgIH0pOwoKICAgIGl0KCdzaG91bGQgTk9UIHNhbml0aXplIGV4cGxpY2l0bHkgdHJ1c3RlZCB2YWx1ZXMnLCBmdW5jdGlvbigpIHsKICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2V4cGxpY2l0bHlUcnVzdGVkSHRtbCcpKS5nZXRJbm5lckh0bWwoKSkudG9CZSgKICAgICAgICAgICc8c3BhbiBvbm1vdXNlb3Zlcj0idGhpcy50ZXh0Q29udGVudD0mcXVvdDtFeHBsaWNpdGx5IHRydXN0ZWQgSFRNTCBieXBhc3NlcyAnICsKICAgICAgICAgICdzYW5pdGl6YXRpb24uJnF1b3Q7Ij5Ib3ZlciBvdmVyIHRoaXMgdGV4dC48L3NwYW4+Jyk7CiAgICB9KTsKICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICoKICAgKgogICAqCiAgICogIyMgQ2FuIEkgZGlzYWJsZSBTQ0UgY29tcGxldGVseT8KICAgKgogICAqIFllcywgeW91IGNhbi4gIEhvd2V2ZXIsIHRoaXMgaXMgc3Ryb25nbHkgZGlzY291cmFnZWQuICBTQ0UgZ2l2ZXMgeW91IGEgbG90IG9mIHNlY3VyaXR5IGJlbmVmaXRzCiAgICogZm9yIGxpdHRsZSBjb2Rpbmcgb3ZlcmhlYWQuICBJdCB3aWxsIGJlIG11Y2ggaGFyZGVyIHRvIHRha2UgYW4gU0NFIGRpc2FibGVkIGFwcGxpY2F0aW9uIGFuZAogICAqIGVpdGhlciBzZWN1cmUgaXQgb24geW91ciBvd24gb3IgZW5hYmxlIFNDRSBhdCBhIGxhdGVyIHN0YWdlLiAgSXQgbWlnaHQgbWFrZSBzZW5zZSB0byBkaXNhYmxlIFNDRQogICAqIGZvciBjYXNlcyB3aGVyZSB5b3UgaGF2ZSBhIGxvdCBvZiBleGlzdGluZyBjb2RlIHRoYXQgd2FzIHdyaXR0ZW4gYmVmb3JlIFNDRSB3YXMgaW50cm9kdWNlZCBhbmQKICAgKiB5b3UncmUgbWlncmF0aW5nIHRoZW0gYSBtb2R1bGUgYXQgYSB0aW1lLgogICAqCiAgICogVGhhdCBzYWlkLCBoZXJlJ3MgaG93IHlvdSBjYW4gY29tcGxldGVseSBkaXNhYmxlIFNDRToKICAgKgogICAqIDxwcmUgY2xhc3M9InByZXR0eXByaW50Ij4KICAgKiAgIGFuZ3VsYXIubW9kdWxlKCdteUFwcFdpdGhTY2VEaXNhYmxlZG15QXBwJywgW10pLmNvbmZpZyhmdW5jdGlvbigkc2NlUHJvdmlkZXIpIHsKICogICAgIC8vIENvbXBsZXRlbHkgZGlzYWJsZSBTQ0UuICBGb3IgZGVtb25zdHJhdGlvbiBwdXJwb3NlcyBvbmx5IQogKiAgICAgLy8gRG8gbm90IHVzZSBpbiBuZXcgcHJvamVjdHMuCiAqICAgICAkc2NlUHJvdmlkZXIuZW5hYmxlZChmYWxzZSk7CiAqICAgfSk7CiAgICogPC9wcmU+CiAgICoKICAgKi8KICAvKiBqc2hpbnQgbWF4bGVuOiAxMDAgKi8KCiAgZnVuY3Rpb24gJFNjZVByb3ZpZGVyKCkgewogICAgdmFyIGVuYWJsZWQgPSB0cnVlOwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJHNjZVByb3ZpZGVyI2VuYWJsZWQKICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgKgogICAgICogQHBhcmFtIHtib29sZWFuPX0gdmFsdWUgSWYgcHJvdmlkZWQsIHRoZW4gZW5hYmxlcy9kaXNhYmxlcyBTQ0UuCiAgICAgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIFNDRSBpcyBlbmFibGVkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBFbmFibGVzL2Rpc2FibGVzIFNDRSBhbmQgcmV0dXJucyB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAqLwogICAgdGhpcy5lbmFibGVkID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgZW5hYmxlZCA9ICEhdmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGVuYWJsZWQ7CiAgICB9OwoKCiAgICAvKiBEZXNpZ24gbm90ZXMgb24gdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gZm9yIFNDRS4KICAgICAqCiAgICAgKiBUaGUgQVBJIGNvbnRyYWN0IGZvciB0aGUgU0NFIGRlbGVnYXRlCiAgICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiBUaGUgU0NFIGRlbGVnYXRlIG9iamVjdCBtdXN0IHByb3ZpZGUgdGhlIGZvbGxvd2luZyAzIG1ldGhvZHM6CiAgICAgKgogICAgICogLSB0cnVzdEFzKGNvbnRleHRFbnVtLCB2YWx1ZSkKICAgICAqICAgICBUaGlzIG1ldGhvZCBpcyB1c2VkIHRvIHRlbGwgdGhlIFNDRSBzZXJ2aWNlIHRoYXQgdGhlIHByb3ZpZGVkIHZhbHVlIGlzIE9LIHRvIHVzZSBpbiB0aGUKICAgICAqICAgICBjb250ZXh0cyBzcGVjaWZpZWQgYnkgY29udGV4dEVudW0uICBJdCBtdXN0IHJldHVybiBhbiBvYmplY3QgdGhhdCB3aWxsIGJlIGFjY2VwdGVkIGJ5CiAgICAgKiAgICAgZ2V0VHJ1c3RlZCgpIGZvciBhIGNvbXBhdGlibGUgY29udGV4dEVudW0gYW5kIHJldHVybiB0aGlzIHZhbHVlLgogICAgICoKICAgICAqIC0gdmFsdWVPZih2YWx1ZSkKICAgICAqICAgICBGb3IgdmFsdWVzIHRoYXQgd2VyZSBub3QgcHJvZHVjZWQgYnkgdHJ1c3RBcygpLCByZXR1cm4gdGhlbSBhcyBpcy4gIEZvciB2YWx1ZXMgdGhhdCB3ZXJlCiAgICAgKiAgICAgcHJvZHVjZWQgYnkgdHJ1c3RBcygpLCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgaW5wdXQgdmFsdWUgdG8gdHJ1c3RBcy4gIEJhc2ljYWxseSwgaWYKICAgICAqICAgICB0cnVzdEFzIGlzIHdyYXBwaW5nIHRoZSBnaXZlbiB2YWx1ZXMgaW50byBzb21lIHR5cGUsIHRoaXMgb3BlcmF0aW9uIHVud3JhcHMgaXQgd2hlbiBnaXZlbgogICAgICogICAgIHN1Y2ggYSB2YWx1ZS4KICAgICAqCiAgICAgKiAtIGdldFRydXN0ZWQoY29udGV4dEVudW0sIHZhbHVlKQogICAgICogICAgIFRoaXMgZnVuY3Rpb24gc2hvdWxkIHJldHVybiB0aGUgYSB2YWx1ZSB0aGF0IGlzIHNhZmUgdG8gdXNlIGluIHRoZSBjb250ZXh0IHNwZWNpZmllZCBieQogICAgICogICAgIGNvbnRleHRFbnVtIG9yIHRocm93IGFuZCBleGNlcHRpb24gb3RoZXJ3aXNlLgogICAgICoKICAgICAqIE5PVEU6IFRoaXMgY29udHJhY3QgZGVsaWJlcmF0ZWx5IGRvZXMgTk9UIHN0YXRlIHRoYXQgdmFsdWVzIHJldHVybmVkIGJ5IHRydXN0QXMoKSBtdXN0IGJlCiAgICAgKiBvcGFxdWUgb3Igd3JhcHBlZCBpbiBzb21lIGhvbGRlciBvYmplY3QuICBUaGF0IGhhcHBlbnMgdG8gYmUgYW4gaW1wbGVtZW50YXRpb24gZGV0YWlsLiAgRm9yCiAgICAgKiBpbnN0YW5jZSwgYW4gaW1wbGVtZW50YXRpb24gY291bGQgbWFpbnRhaW4gYSByZWdpc3RyeSBvZiBhbGwgdHJ1c3RlZCBvYmplY3RzIGJ5IGNvbnRleHQuICBJbgogICAgICogc3VjaCBhIGNhc2UsIHRydXN0QXMoKSB3b3VsZCByZXR1cm4gdGhlIHNhbWUgb2JqZWN0IHRoYXQgd2FzIHBhc3NlZCBpbi4gIGdldFRydXN0ZWQoKSB3b3VsZAogICAgICogcmV0dXJuIHRoZSBzYW1lIG9iamVjdCBwYXNzZWQgaW4gaWYgaXQgd2FzIGZvdW5kIGluIHRoZSByZWdpc3RyeSB1bmRlciBhIGNvbXBhdGlibGUgY29udGV4dCBvcgogICAgICogdGhyb3cgYW4gZXhjZXB0aW9uIG90aGVyd2lzZS4gIEFuIGltcGxlbWVudGF0aW9uIG1pZ2h0IG9ubHkgd3JhcCB2YWx1ZXMgc29tZSBvZiB0aGUgdGltZSBiYXNlZAogICAgICogb24gc29tZSBjcml0ZXJpYS4gIGdldFRydXN0ZWQoKSBtaWdodCByZXR1cm4gYSB2YWx1ZSBhbmQgbm90IHRocm93IGFuIGV4Y2VwdGlvbiBmb3Igc3BlY2lhbAogICAgICogY29uc3RhbnRzIG9yIG9iamVjdHMgZXZlbiBpZiBub3Qgd3JhcHBlZC4gIEFsbCBzdWNoIGltcGxlbWVudGF0aW9ucyBmdWxmaWxsIHRoaXMgY29udHJhY3QuCiAgICAgKgogICAgICoKICAgICAqIEEgbm90ZSBvbiB0aGUgaW5oZXJpdGFuY2UgbW9kZWwgZm9yIFNDRSBjb250ZXh0cwogICAgICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAgKiBJJ3ZlIHVzZWQgaW5oZXJpdGFuY2UgYW5kIG1hZGUgUkVTT1VSQ0VfVVJMIHdyYXBwZWQgdHlwZXMgYSBzdWJ0eXBlIG9mIFVSTCB3cmFwcGVkIHR5cGVzLiAgVGhpcwogICAgICogaXMgcHVyZWx5IGFuIGltcGxlbWVudGF0aW9uIGRldGFpbHMuCiAgICAgKgogICAgICogVGhlIGNvbnRyYWN0IGlzIHNpbXBseSB0aGlzOgogICAgICoKICAgICAqICAgICBnZXRUcnVzdGVkKCRzY2UuUkVTT1VSQ0VfVVJMLCB2YWx1ZSkgc3VjY2VlZGluZyBpbXBsaWVzIHRoYXQgZ2V0VHJ1c3RlZCgkc2NlLlVSTCwgdmFsdWUpCiAgICAgKiAgICAgd2lsbCBhbHNvIHN1Y2NlZWQuCiAgICAgKgogICAgICogSW5oZXJpdGFuY2UgaGFwcGVucyB0byBjYXB0dXJlIHRoaXMgaW4gYSBuYXR1cmFsIHdheS4gIEluIHNvbWUgZnV0dXJlLCB3ZQogICAgICogbWF5IG5vdCB1c2UgaW5oZXJpdGFuY2UgYW55bW9yZS4gIFRoYXQgaXMgT0sgYmVjYXVzZSBubyBjb2RlIG91dHNpZGUgb2YKICAgICAqIHNjZS5qcyBhbmQgc2NlU3BlY3MuanMgd291bGQgbmVlZCB0byBiZSBhd2FyZSBvZiB0aGlzIGRldGFpbC4KICAgICAqLwoKICAgIHRoaXMuJGdldCA9IFsnJHBhcnNlJywgJyRzbmlmZmVyJywgJyRzY2VEZWxlZ2F0ZScsIGZ1bmN0aW9uKAogICAgICAkcGFyc2UsICAgJHNuaWZmZXIsICAgJHNjZURlbGVnYXRlKSB7CiAgICAgIC8vIFByZXJlcTogRW5zdXJlIHRoYXQgd2UncmUgbm90IHJ1bm5pbmcgaW4gSUU4IHF1aXJrcyBtb2RlLiAgSW4gdGhhdCBtb2RlLCBJRSBhbGxvd3MKICAgICAgLy8gdGhlICJleHByZXNzaW9uKGphdmFzY3JpcHQgZXhwcmVzc2lvbikiIHN5bnRheCB3aGljaCBpcyBpbnNlY3VyZS4KICAgICAgaWYgKGVuYWJsZWQgJiYgJHNuaWZmZXIubXNpZSAmJiAkc25pZmZlci5tc2llRG9jdW1lbnRNb2RlIDwgOCkgewogICAgICAgIHRocm93ICRzY2VNaW5FcnIoJ2llcXVpcmtzJywKICAgICAgICAgICAgJ1N0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nIGRvZXMgbm90IHN1cHBvcnQgSW50ZXJuZXQgRXhwbG9yZXIgdmVyc2lvbiA8IDkgaW4gcXVpcmtzICcgKwogICAgICAgICAgICAnbW9kZS4gIFlvdSBjYW4gZml4IHRoaXMgYnkgYWRkaW5nIHRoZSB0ZXh0IDwhZG9jdHlwZSBodG1sPiB0byB0aGUgdG9wIG9mIHlvdXIgSFRNTCAnICsKICAgICAgICAgICAgJ2RvY3VtZW50LiAgU2VlIGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nLiRzY2UgZm9yIG1vcmUgaW5mb3JtYXRpb24uJyk7CiAgICAgIH0KCiAgICAgIHZhciBzY2UgPSBzaGFsbG93Q29weShTQ0VfQ09OVEVYVFMpOwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSNpc0VuYWJsZWQKICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICoKICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0gdHJ1ZSBpZiBTQ0UgaXMgZW5hYmxlZCwgZmFsc2Ugb3RoZXJ3aXNlLiAgSWYgeW91IHdhbnQgdG8gc2V0IHRoZSB2YWx1ZSwgeW91CiAgICAgICAqIGhhdmUgdG8gZG8gaXQgYXQgbW9kdWxlIGNvbmZpZyB0aW1lIG9uIHtAbGluayBuZy4kc2NlUHJvdmlkZXIgJHNjZVByb3ZpZGVyfS4KICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFJldHVybnMgYSBib29sZWFuIGluZGljYXRpbmcgaWYgU0NFIGlzIGVuYWJsZWQuCiAgICAgICAqLwogICAgICBzY2UuaXNFbmFibGVkID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBlbmFibGVkOwogICAgICB9OwogICAgICBzY2UudHJ1c3RBcyA9ICRzY2VEZWxlZ2F0ZS50cnVzdEFzOwogICAgICBzY2UuZ2V0VHJ1c3RlZCA9ICRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkOwogICAgICBzY2UudmFsdWVPZiA9ICRzY2VEZWxlZ2F0ZS52YWx1ZU9mOwoKICAgICAgaWYgKCFlbmFibGVkKSB7CiAgICAgICAgc2NlLnRydXN0QXMgPSBzY2UuZ2V0VHJ1c3RlZCA9IGZ1bmN0aW9uKHR5cGUsIHZhbHVlKSB7IHJldHVybiB2YWx1ZTsgfTsKICAgICAgICBzY2UudmFsdWVPZiA9IGlkZW50aXR5OwogICAgICB9CgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlI3BhcnNlCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBDb252ZXJ0cyBBbmd1bGFyIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGludG8gYSBmdW5jdGlvbi4gIFRoaXMgaXMgbGlrZSB7QGxpbmsKICAgICAgICAqIG5nLiRwYXJzZSAkcGFyc2V9IGFuZCBpcyBpZGVudGljYWwgd2hlbiB0aGUgZXhwcmVzc2lvbiBpcyBhIGxpdGVyYWwgY29uc3RhbnQuICBPdGhlcndpc2UsIGl0CiAgICAgICAqIHdyYXBzIHRoZSBleHByZXNzaW9uIGluIGEgY2FsbCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkICRzY2UuZ2V0VHJ1c3RlZCgqdHlwZSosCiAgICAgKiAqcmVzdWx0Kil9CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIFRoZSBraW5kIG9mIFNDRSBjb250ZXh0IGluIHdoaWNoIHRoaXMgcmVzdWx0IHdpbGwgYmUgdXNlZC4KICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAgICoKICAgICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAgICovCiAgICAgIHNjZS5wYXJzZUFzID0gZnVuY3Rpb24gc2NlUGFyc2VBcyh0eXBlLCBleHByKSB7CiAgICAgICAgdmFyIHBhcnNlZCA9ICRwYXJzZShleHByKTsKICAgICAgICBpZiAocGFyc2VkLmxpdGVyYWwgJiYgcGFyc2VkLmNvbnN0YW50KSB7CiAgICAgICAgICByZXR1cm4gcGFyc2VkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gc2NlUGFyc2VBc1RydXN0ZWQoc2VsZiwgbG9jYWxzKSB7CiAgICAgICAgICAgIHJldHVybiBzY2UuZ2V0VHJ1c3RlZCh0eXBlLCBwYXJzZWQoc2VsZiwgbG9jYWxzKSk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBcwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogRGVsZWdhdGVzIHRvIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXNgfS4gIEFzIHN1Y2gsCiAgICAgICAqIHJldHVybnMgYW4gb2JqZWN0IHRoYXQgaXMgdHJ1c3RlZCBieSBhbmd1bGFyIGZvciB1c2UgaW4gc3BlY2lmaWVkIHN0cmljdCBjb250ZXh0dWFsCiAgICAgICAqIGVzY2FwaW5nIGNvbnRleHRzIChzdWNoIGFzIG5nLWJpbmQtaHRtbCwgbmctaW5jbHVkZSwgYW55IHNyYyBhdHRyaWJ1dGUKICAgICAgICogaW50ZXJwb2xhdGlvbiwgYW55IGRvbSBldmVudCBiaW5kaW5nIGF0dHJpYnV0ZSBpbnRlcnBvbGF0aW9uIHN1Y2ggYXMgZm9yIG9uY2xpY2ssICBldGMuKQogICAgICAgKiB0aGF0IHVzZXMgdGhlIHByb3ZpZGVkIHZhbHVlLiAgU2VlICoge0BsaW5rIG5nLiRzY2UgJHNjZX0gZm9yIGVuYWJsaW5nIHN0cmljdCBjb250ZXh0dWFsCiAgICAgICAqIGVzY2FwaW5nLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgc2FmZSBmb3IgdXNlLiAgZS5nLiB1cmwsCiAgICAgICAqICAgcmVzb3VyY2VfdXJsLCBodG1sLCBqcyBhbmQgY3NzLgogICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0aGF0IHRoYXQgc2hvdWxkIGJlIGNvbnNpZGVyZWQgdHJ1c3RlZC9zYWZlLgogICAgICAgKiBAcmV0dXJucyB7Kn0gQSB2YWx1ZSB0aGF0IGNhbiBiZSB1c2VkIHRvIHN0YW5kIGluIGZvciB0aGUgcHJvdmlkZWQgYHZhbHVlYCBpbiBwbGFjZXMKICAgICAgICogd2hlcmUgQW5ndWxhciBleHBlY3RzIGEgJHNjZS50cnVzdEFzKCkgcmV0dXJuIHZhbHVlLgogICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2UjdHJ1c3RBc0h0bWwKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS50cnVzdEFzSHRtbCh2YWx1ZSlgIOKGkgogICAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLkhUTUwsIHZhbHVlKWB9CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRIdG1sCiAgICAgKiAgICAgJHNjZS5nZXRUcnVzdGVkSHRtbCh2YWx1ZSl9IHRvIG9idGFpbiB0aGUgb3JpZ2luYWwgdmFsdWUuICAocHJpdmlsZWdlZCBkaXJlY3RpdmVzCiAgICAgICAqICAgICBvbmx5IGFjY2VwdCBleHByZXNzaW9ucyB0aGF0IGFyZSBlaXRoZXIgbGl0ZXJhbCBjb25zdGFudHMgb3IgYXJlIHRoZQogICAgICAgKiAgICAgcmV0dXJuIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSN0cnVzdEFzVXJsCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UudHJ1c3RBc1VybCh2YWx1ZSlgIOKGkgogICAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLlVSTCwgdmFsdWUpYH0KICAgICAgICoKICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gdHJ1c3RBcy4KICAgICAgICogQHJldHVybnMgeyp9IEFuIG9iamVjdCB0aGF0IGNhbiBiZSBwYXNzZWQgdG8ge0BsaW5rIG5nLiRzY2UjZ2V0VHJ1c3RlZFVybAogICAgICogICAgICRzY2UuZ2V0VHJ1c3RlZFVybCh2YWx1ZSl9IHRvIG9idGFpbiB0aGUgb3JpZ2luYWwgdmFsdWUuICAocHJpdmlsZWdlZCBkaXJlY3RpdmVzCiAgICAgICAqICAgICBvbmx5IGFjY2VwdCBleHByZXNzaW9ucyB0aGF0IGFyZSBlaXRoZXIgbGl0ZXJhbCBjb25zdGFudHMgb3IgYXJlIHRoZQogICAgICAgKiAgICAgcmV0dXJuIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSN0cnVzdEFzUmVzb3VyY2VVcmwKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS50cnVzdEFzUmVzb3VyY2VVcmwodmFsdWUpYCDihpIKICAgICAgICogICAgIHtAbGluayBuZy4kc2NlRGVsZWdhdGUjdHJ1c3RBcyBgJHNjZURlbGVnYXRlLnRydXN0QXMoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKWB9CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHRydXN0QXMuCiAgICAgICAqIEByZXR1cm5zIHsqfSBBbiBvYmplY3QgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHtAbGluayBuZy4kc2NlI2dldFRydXN0ZWRSZXNvdXJjZVVybAogICAgICogICAgICRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsKHZhbHVlKX0gdG8gb2J0YWluIHRoZSBvcmlnaW5hbCB2YWx1ZS4gIChwcml2aWxlZ2VkIGRpcmVjdGl2ZXMKICAgICAgICogICAgIG9ubHkgYWNjZXB0IGV4cHJlc3Npb25zIHRoYXQgYXJlIGVpdGhlciBsaXRlcmFsIGNvbnN0YW50cyBvciBhcmUgdGhlIHJldHVybgogICAgICAgKiAgICAgdmFsdWUgb2Yge0BsaW5rIG5nLiRzY2UjdHJ1c3RBcyAkc2NlLnRydXN0QXN9LikKICAgICAgICovCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlI3RydXN0QXNKcwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnRydXN0QXNKcyh2YWx1ZSlgIOKGkgogICAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSN0cnVzdEFzIGAkc2NlRGVsZWdhdGUudHJ1c3RBcygkc2NlLkpTLCB2YWx1ZSlgfQogICAgICAgKgogICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB0cnVzdEFzLgogICAgICAgKiBAcmV0dXJucyB7Kn0gQW4gb2JqZWN0IHRoYXQgY2FuIGJlIHBhc3NlZCB0byB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkSnMKICAgICAqICAgICAkc2NlLmdldFRydXN0ZWRKcyh2YWx1ZSl9IHRvIG9idGFpbiB0aGUgb3JpZ2luYWwgdmFsdWUuICAocHJpdmlsZWdlZCBkaXJlY3RpdmVzCiAgICAgICAqICAgICBvbmx5IGFjY2VwdCBleHByZXNzaW9ucyB0aGF0IGFyZSBlaXRoZXIgbGl0ZXJhbCBjb25zdGFudHMgb3IgYXJlIHRoZQogICAgICAgKiAgICAgcmV0dXJuIHZhbHVlIG9mIHtAbGluayBuZy4kc2NlI3RydXN0QXMgJHNjZS50cnVzdEFzfS4pCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBEZWxlZ2F0ZXMgdG8ge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZGB9LiAgQXMgc3VjaCwKICAgICAgICogdGFrZXMgdGhlIHJlc3VsdCBvZiBhIHtAbGluayBuZy4kc2NlI3RydXN0QXMgYCRzY2UudHJ1c3RBc2B9KCkgY2FsbCBhbmQgcmV0dXJucyB0aGUKICAgICAgICogb3JpZ2luYWxseSBzdXBwbGllZCB2YWx1ZSBpZiB0aGUgcXVlcmllZCBjb250ZXh0IHR5cGUgaXMgYSBzdXBlcnR5cGUgb2YgdGhlIGNyZWF0ZWQgdHlwZS4KICAgICAgICogSWYgdGhpcyBjb25kaXRpb24gaXNuJ3Qgc2F0aXNmaWVkLCB0aHJvd3MgYW4gZXhjZXB0aW9uLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBUaGUga2luZCBvZiBjb250ZXh0IGluIHdoaWNoIHRoaXMgdmFsdWUgaXMgdG8gYmUgdXNlZC4KICAgICAgICogQHBhcmFtIHsqfSBtYXliZVRydXN0ZWQgVGhlIHJlc3VsdCBvZiBhIHByaW9yIHtAbGluayBuZy4kc2NlI3RydXN0QXMgYCRzY2UudHJ1c3RBc2B9CiAgICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGwuCiAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgdmFsdWUgdGhlIHdhcyBvcmlnaW5hbGx5IHByb3ZpZGVkIHRvCiAgICAgICAqICAgICAgICAgICAgICB7QGxpbmsgbmcuJHNjZSN0cnVzdEFzIGAkc2NlLnRydXN0QXNgfSBpZiB2YWxpZCBpbiB0aGlzIGNvbnRleHQuCiAgICAgICAqICAgICAgICAgICAgICBPdGhlcndpc2UsIHRocm93cyBhbiBleGNlcHRpb24uCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkSHRtbAogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRIdG1sKHZhbHVlKWAg4oaSCiAgICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuSFRNTCwgdmFsdWUpYH0KICAgICAgICoKICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLkhUTUwsIHZhbHVlKWAKICAgICAgICovCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlI2dldFRydXN0ZWRDc3MKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNob3J0aGFuZCBtZXRob2QuICBgJHNjZS5nZXRUcnVzdGVkQ3NzKHZhbHVlKWAg4oaSCiAgICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuQ1NTLCB2YWx1ZSlgfQogICAgICAgKgogICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBwYXNzIHRvIGAkc2NlLmdldFRydXN0ZWRgLgogICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuQ1NTLCB2YWx1ZSlgCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSNnZXRUcnVzdGVkVXJsCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZFVybCh2YWx1ZSlgIOKGkgogICAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLlVSTCwgdmFsdWUpYH0KICAgICAgICoKICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFzcyB0byBgJHNjZS5nZXRUcnVzdGVkYC4KICAgICAgICogQHJldHVybnMgeyp9IFRoZSByZXR1cm4gdmFsdWUgb2YgYCRzY2UuZ2V0VHJ1c3RlZCgkc2NlLlVSTCwgdmFsdWUpYAogICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2UjZ2V0VHJ1c3RlZFJlc291cmNlVXJsCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UuZ2V0VHJ1c3RlZFJlc291cmNlVXJsKHZhbHVlKWAg4oaSCiAgICAgICAqICAgICB7QGxpbmsgbmcuJHNjZURlbGVnYXRlI2dldFRydXN0ZWQgYCRzY2VEZWxlZ2F0ZS5nZXRUcnVzdGVkKCRzY2UuUkVTT1VSQ0VfVVJMLCB2YWx1ZSlgfQogICAgICAgKgogICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBwYXNzIHRvIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZGAuCiAgICAgICAqIEByZXR1cm5zIHsqfSBUaGUgcmV0dXJuIHZhbHVlIG9mIGAkc2NlLmdldFRydXN0ZWQoJHNjZS5SRVNPVVJDRV9VUkwsIHZhbHVlKWAKICAgICAgICovCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlI2dldFRydXN0ZWRKcwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLmdldFRydXN0ZWRKcyh2YWx1ZSlgIOKGkgogICAgICAgKiAgICAge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZSNnZXRUcnVzdGVkIGAkc2NlRGVsZWdhdGUuZ2V0VHJ1c3RlZCgkc2NlLkpTLCB2YWx1ZSlgfQogICAgICAgKgogICAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBwYXNzIHRvIGAkc2NlLmdldFRydXN0ZWRgLgogICAgICAgKiBAcmV0dXJucyB7Kn0gVGhlIHJldHVybiB2YWx1ZSBvZiBgJHNjZS5nZXRUcnVzdGVkKCRzY2UuSlMsIHZhbHVlKWAKICAgICAgICovCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlI3BhcnNlQXNIdG1sCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UucGFyc2VBc0h0bWwoZXhwcmVzc2lvbiBzdHJpbmcpYCDihpIKICAgICAgICogICAgIHtAbGluayBuZy4kc2NlI3BhcnNlIGAkc2NlLnBhcnNlQXMoJHNjZS5IVE1MLCB2YWx1ZSlgfQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICAgKgogICAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICAgKi8KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lICRzY2UjcGFyc2VBc0NzcwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNDc3ModmFsdWUpYCDihpIKICAgICAgICogICAgIHtAbGluayBuZy4kc2NlI3BhcnNlIGAkc2NlLnBhcnNlQXMoJHNjZS5DU1MsIHZhbHVlKWB9CiAgICAgICAqCiAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHByZXNzaW9uIFN0cmluZyBleHByZXNzaW9uIHRvIGNvbXBpbGUuCiAgICAgICAqIEByZXR1cm5zIHtmdW5jdGlvbihjb250ZXh0LCBsb2NhbHMpfSBhIGZ1bmN0aW9uIHdoaWNoIHJlcHJlc2VudHMgdGhlIGNvbXBpbGVkIGV4cHJlc3Npb246CiAgICAgICAqCiAgICAgICAqICAgICogYGNvbnRleHRgIOKAkyBge29iamVjdH1gIOKAkyBhbiBvYmplY3QgYWdhaW5zdCB3aGljaCBhbnkgZXhwcmVzc2lvbnMgZW1iZWRkZWQgaW4gdGhlIHN0cmluZ3MKICAgICAgICogICAgICBhcmUgZXZhbHVhdGVkIGFnYWluc3QgKHR5cGljYWxseSBhIHNjb3BlIG9iamVjdCkuCiAgICAgICAqICAgICogYGxvY2Fsc2Ag4oCTIGB7b2JqZWN0PX1gIOKAkyBsb2NhbCB2YXJpYWJsZXMgY29udGV4dCBvYmplY3QsIHVzZWZ1bCBmb3Igb3ZlcnJpZGluZyB2YWx1ZXMgaW4KICAgICAgICogICAgICBgY29udGV4dGAuCiAgICAgICAqLwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJHNjZSNwYXJzZUFzVXJsCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBTaG9ydGhhbmQgbWV0aG9kLiAgYCRzY2UucGFyc2VBc1VybCh2YWx1ZSlgIOKGkgogICAgICAgKiAgICAge0BsaW5rIG5nLiRzY2UjcGFyc2UgYCRzY2UucGFyc2VBcygkc2NlLlVSTCwgdmFsdWUpYH0KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAgICoKICAgICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAgICovCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlI3BhcnNlQXNSZXNvdXJjZVVybAogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNSZXNvdXJjZVVybCh2YWx1ZSlgIOKGkgogICAgICAgKiAgICAge0BsaW5rIG5nLiRzY2UjcGFyc2UgYCRzY2UucGFyc2VBcygkc2NlLlJFU09VUkNFX1VSTCwgdmFsdWUpYH0KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV4cHJlc3Npb24gU3RyaW5nIGV4cHJlc3Npb24gdG8gY29tcGlsZS4KICAgICAgICogQHJldHVybnMge2Z1bmN0aW9uKGNvbnRleHQsIGxvY2Fscyl9IGEgZnVuY3Rpb24gd2hpY2ggcmVwcmVzZW50cyB0aGUgY29tcGlsZWQgZXhwcmVzc2lvbjoKICAgICAgICoKICAgICAgICogICAgKiBgY29udGV4dGAg4oCTIGB7b2JqZWN0fWAg4oCTIGFuIG9iamVjdCBhZ2FpbnN0IHdoaWNoIGFueSBleHByZXNzaW9ucyBlbWJlZGRlZCBpbiB0aGUgc3RyaW5ncwogICAgICAgKiAgICAgIGFyZSBldmFsdWF0ZWQgYWdhaW5zdCAodHlwaWNhbGx5IGEgc2NvcGUgb2JqZWN0KS4KICAgICAgICogICAgKiBgbG9jYWxzYCDigJMgYHtvYmplY3Q9fWAg4oCTIGxvY2FsIHZhcmlhYmxlcyBjb250ZXh0IG9iamVjdCwgdXNlZnVsIGZvciBvdmVycmlkaW5nIHZhbHVlcyBpbgogICAgICAgKiAgICAgIGBjb250ZXh0YC4KICAgICAgICovCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkc2NlI3BhcnNlQXNKcwogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2hvcnRoYW5kIG1ldGhvZC4gIGAkc2NlLnBhcnNlQXNKcyh2YWx1ZSlgIOKGkgogICAgICAgKiAgICAge0BsaW5rIG5nLiRzY2UjcGFyc2UgYCRzY2UucGFyc2VBcygkc2NlLkpTLCB2YWx1ZSlgfQogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZXhwcmVzc2lvbiBTdHJpbmcgZXhwcmVzc2lvbiB0byBjb21waWxlLgogICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb24oY29udGV4dCwgbG9jYWxzKX0gYSBmdW5jdGlvbiB3aGljaCByZXByZXNlbnRzIHRoZSBjb21waWxlZCBleHByZXNzaW9uOgogICAgICAgKgogICAgICAgKiAgICAqIGBjb250ZXh0YCDigJMgYHtvYmplY3R9YCDigJMgYW4gb2JqZWN0IGFnYWluc3Qgd2hpY2ggYW55IGV4cHJlc3Npb25zIGVtYmVkZGVkIGluIHRoZSBzdHJpbmdzCiAgICAgICAqICAgICAgYXJlIGV2YWx1YXRlZCBhZ2FpbnN0ICh0eXBpY2FsbHkgYSBzY29wZSBvYmplY3QpLgogICAgICAgKiAgICAqIGBsb2NhbHNgIOKAkyBge29iamVjdD19YCDigJMgbG9jYWwgdmFyaWFibGVzIGNvbnRleHQgb2JqZWN0LCB1c2VmdWwgZm9yIG92ZXJyaWRpbmcgdmFsdWVzIGluCiAgICAgICAqICAgICAgYGNvbnRleHRgLgogICAgICAgKi8KCiAgICAgIC8vIFNob3J0aGFuZCBkZWxlZ2F0aW9ucy4KICAgICAgdmFyIHBhcnNlID0gc2NlLnBhcnNlQXMsCiAgICAgICAgZ2V0VHJ1c3RlZCA9IHNjZS5nZXRUcnVzdGVkLAogICAgICAgIHRydXN0QXMgPSBzY2UudHJ1c3RBczsKCiAgICAgIGZvckVhY2goU0NFX0NPTlRFWFRTLCBmdW5jdGlvbiAoZW51bVZhbHVlLCBuYW1lKSB7CiAgICAgICAgdmFyIGxOYW1lID0gbG93ZXJjYXNlKG5hbWUpOwogICAgICAgIHNjZVtjYW1lbENhc2UoInBhcnNlX2FzXyIgKyBsTmFtZSldID0gZnVuY3Rpb24gKGV4cHIpIHsKICAgICAgICAgIHJldHVybiBwYXJzZShlbnVtVmFsdWUsIGV4cHIpOwogICAgICAgIH07CiAgICAgICAgc2NlW2NhbWVsQ2FzZSgiZ2V0X3RydXN0ZWRfIiArIGxOYW1lKV0gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgIHJldHVybiBnZXRUcnVzdGVkKGVudW1WYWx1ZSwgdmFsdWUpOwogICAgICAgIH07CiAgICAgICAgc2NlW2NhbWVsQ2FzZSgidHJ1c3RfYXNfIiArIGxOYW1lKV0gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgIHJldHVybiB0cnVzdEFzKGVudW1WYWx1ZSwgdmFsdWUpOwogICAgICAgIH07CiAgICAgIH0pOwoKICAgICAgcmV0dXJuIHNjZTsKICAgIH1dOwogIH0KCiAgLyoqCiAgICogISEhIFRoaXMgaXMgYW4gdW5kb2N1bWVudGVkICJwcml2YXRlIiBzZXJ2aWNlICEhIQogICAqCiAgICogQG5hbWUgJHNuaWZmZXIKICAgKiBAcmVxdWlyZXMgJHdpbmRvdwogICAqIEByZXF1aXJlcyAkZG9jdW1lbnQKICAgKgogICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGlzdG9yeSBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgaHRtbDUgaGlzdG9yeSBhcGkgPwogICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaGFzaGNoYW5nZSBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgaGFzaGNoYW5nZSBldmVudCA/CiAgICogQHByb3BlcnR5IHtib29sZWFufSB0cmFuc2l0aW9ucyBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgQ1NTIHRyYW5zaXRpb24gZXZlbnRzID8KICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFuaW1hdGlvbnMgRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IENTUyBhbmltYXRpb24gZXZlbnRzID8KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoaXMgaXMgdmVyeSBzaW1wbGUgaW1wbGVtZW50YXRpb24gb2YgdGVzdGluZyBicm93c2VyJ3MgZmVhdHVyZXMuCiAgICovCiAgZnVuY3Rpb24gJFNuaWZmZXJQcm92aWRlcigpIHsKICAgIHRoaXMuJGdldCA9IFsnJHdpbmRvdycsICckZG9jdW1lbnQnLCBmdW5jdGlvbigkd2luZG93LCAkZG9jdW1lbnQpIHsKICAgICAgdmFyIGV2ZW50U3VwcG9ydCA9IHt9LAogICAgICAgIGFuZHJvaWQgPQogICAgICAgICAgaW50KCgvYW5kcm9pZCAoXGQrKS8uZXhlYyhsb3dlcmNhc2UoKCR3aW5kb3cubmF2aWdhdG9yIHx8IHt9KS51c2VyQWdlbnQpKSB8fCBbXSlbMV0pLAogICAgICAgIGJveGVlID0gL0JveGVlL2kudGVzdCgoJHdpbmRvdy5uYXZpZ2F0b3IgfHwge30pLnVzZXJBZ2VudCksCiAgICAgICAgZG9jdW1lbnQgPSAkZG9jdW1lbnRbMF0gfHwge30sCiAgICAgICAgZG9jdW1lbnRNb2RlID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlLAogICAgICAgIHZlbmRvclByZWZpeCwKICAgICAgICB2ZW5kb3JSZWdleCA9IC9eKE1venx3ZWJraXR8T3xtcykoPz1bQS1aXSkvLAogICAgICAgIGJvZHlTdHlsZSA9IGRvY3VtZW50LmJvZHkgJiYgZG9jdW1lbnQuYm9keS5zdHlsZSwKICAgICAgICB0cmFuc2l0aW9ucyA9IGZhbHNlLAogICAgICAgIGFuaW1hdGlvbnMgPSBmYWxzZSwKICAgICAgICBtYXRjaDsKCiAgICAgIGlmIChib2R5U3R5bGUpIHsKICAgICAgICBmb3IodmFyIHByb3AgaW4gYm9keVN0eWxlKSB7CiAgICAgICAgICBpZihtYXRjaCA9IHZlbmRvclJlZ2V4LmV4ZWMocHJvcCkpIHsKICAgICAgICAgICAgdmVuZG9yUHJlZml4ID0gbWF0Y2hbMF07CiAgICAgICAgICAgIHZlbmRvclByZWZpeCA9IHZlbmRvclByZWZpeC5zdWJzdHIoMCwgMSkudG9VcHBlckNhc2UoKSArIHZlbmRvclByZWZpeC5zdWJzdHIoMSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYoIXZlbmRvclByZWZpeCkgewogICAgICAgICAgdmVuZG9yUHJlZml4ID0gKCdXZWJraXRPcGFjaXR5JyBpbiBib2R5U3R5bGUpICYmICd3ZWJraXQnOwogICAgICAgIH0KCiAgICAgICAgdHJhbnNpdGlvbnMgPSAhISgoJ3RyYW5zaXRpb24nIGluIGJvZHlTdHlsZSkgfHwgKHZlbmRvclByZWZpeCArICdUcmFuc2l0aW9uJyBpbiBib2R5U3R5bGUpKTsKICAgICAgICBhbmltYXRpb25zICA9ICEhKCgnYW5pbWF0aW9uJyBpbiBib2R5U3R5bGUpIHx8ICh2ZW5kb3JQcmVmaXggKyAnQW5pbWF0aW9uJyBpbiBib2R5U3R5bGUpKTsKCiAgICAgICAgaWYgKGFuZHJvaWQgJiYgKCF0cmFuc2l0aW9uc3x8IWFuaW1hdGlvbnMpKSB7CiAgICAgICAgICB0cmFuc2l0aW9ucyA9IGlzU3RyaW5nKGRvY3VtZW50LmJvZHkuc3R5bGUud2Via2l0VHJhbnNpdGlvbik7CiAgICAgICAgICBhbmltYXRpb25zID0gaXNTdHJpbmcoZG9jdW1lbnQuYm9keS5zdHlsZS53ZWJraXRBbmltYXRpb24pOwogICAgICAgIH0KICAgICAgfQoKCiAgICAgIHJldHVybiB7CiAgICAgICAgLy8gQW5kcm9pZCBoYXMgaGlzdG9yeS5wdXNoU3RhdGUsIGJ1dCBpdCBkb2VzIG5vdCB1cGRhdGUgbG9jYXRpb24gY29ycmVjdGx5CiAgICAgICAgLy8gc28gbGV0J3Mgbm90IHVzZSB0aGUgaGlzdG9yeSBBUEkgYXQgYWxsLgogICAgICAgIC8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC9hbmRyb2lkL2lzc3Vlcy9kZXRhaWw/aWQ9MTc0NzEKICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL2lzc3Vlcy85MDQKCiAgICAgICAgLy8gb2xkZXIgd2Via2l0IGJyb3dzZXIgKDUzMy45KSBvbiBCb3hlZSBib3ggaGFzIGV4YWN0bHkgdGhlIHNhbWUgcHJvYmxlbSBhcyBBbmRyb2lkIGhhcwogICAgICAgIC8vIHNvIGxldCdzIG5vdCB1c2UgdGhlIGhpc3RvcnkgQVBJIGFsc28KICAgICAgICAvLyBXZSBhcmUgcHVycG9zZWZ1bGx5IHVzaW5nIGAhKGFuZHJvaWQgPCA0KWAgdG8gY292ZXIgdGhlIGNhc2Ugd2hlbiBgYW5kcm9pZGAgaXMgdW5kZWZpbmVkCiAgICAgICAgLy8ganNoaW50IC1XMDE4CiAgICAgICAgaGlzdG9yeTogISEoJHdpbmRvdy5oaXN0b3J5ICYmICR3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUgJiYgIShhbmRyb2lkIDwgNCkgJiYgIWJveGVlKSwKICAgICAgICAvLyBqc2hpbnQgK1cwMTgKICAgICAgICBoYXNoY2hhbmdlOiAnb25oYXNoY2hhbmdlJyBpbiAkd2luZG93ICYmCiAgICAgICAgICAvLyBJRTggY29tcGF0aWJsZSBtb2RlIGxpZXMKICAgICAgICAgICghZG9jdW1lbnRNb2RlIHx8IGRvY3VtZW50TW9kZSA+IDcpLAogICAgICAgIGhhc0V2ZW50OiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgLy8gSUU5IGltcGxlbWVudHMgJ2lucHV0JyBldmVudCBpdCdzIHNvIGZ1YmFyZWQgdGhhdCB3ZSByYXRoZXIgcHJldGVuZCB0aGF0IGl0IGRvZXNuJ3QgaGF2ZQogICAgICAgICAgLy8gaXQuIEluIHBhcnRpY3VsYXIgdGhlIGV2ZW50IGlzIG5vdCBmaXJlZCB3aGVuIGJhY2tzcGFjZSBvciBkZWxldGUga2V5IGFyZSBwcmVzc2VkIG9yCiAgICAgICAgICAvLyB3aGVuIGN1dCBvcGVyYXRpb24gaXMgcGVyZm9ybWVkLgogICAgICAgICAgaWYgKGV2ZW50ID09ICdpbnB1dCcgJiYgbXNpZSA9PSA5KSByZXR1cm4gZmFsc2U7CgogICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKGV2ZW50U3VwcG9ydFtldmVudF0pKSB7CiAgICAgICAgICAgIHZhciBkaXZFbG0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgZXZlbnRTdXBwb3J0W2V2ZW50XSA9ICdvbicgKyBldmVudCBpbiBkaXZFbG07CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGV2ZW50U3VwcG9ydFtldmVudF07CiAgICAgICAgfSwKICAgICAgICBjc3A6IGNzcCgpLAogICAgICAgIHZlbmRvclByZWZpeDogdmVuZG9yUHJlZml4LAogICAgICAgIHRyYW5zaXRpb25zIDogdHJhbnNpdGlvbnMsCiAgICAgICAgYW5pbWF0aW9ucyA6IGFuaW1hdGlvbnMsCiAgICAgICAgYW5kcm9pZDogYW5kcm9pZCwKICAgICAgICBtc2llIDogbXNpZSwKICAgICAgICBtc2llRG9jdW1lbnRNb2RlOiBkb2N1bWVudE1vZGUKICAgICAgfTsKICAgIH1dOwogIH0KCiAgZnVuY3Rpb24gJFRpbWVvdXRQcm92aWRlcigpIHsKICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckYnJvd3NlcicsICckcScsICckZXhjZXB0aW9uSGFuZGxlcicsCiAgICAgIGZ1bmN0aW9uKCRyb290U2NvcGUsICAgJGJyb3dzZXIsICAgJHEsICAgJGV4Y2VwdGlvbkhhbmRsZXIpIHsKICAgICAgICB2YXIgZGVmZXJyZWRzID0ge307CgoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2Mgc2VydmljZQogICAgICAgICAqIEBuYW1lICR0aW1lb3V0CiAgICAgICAgICoKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBBbmd1bGFyJ3Mgd3JhcHBlciBmb3IgYHdpbmRvdy5zZXRUaW1lb3V0YC4gVGhlIGBmbmAgZnVuY3Rpb24gaXMgd3JhcHBlZCBpbnRvIGEgdHJ5L2NhdGNoCiAgICAgICAgICogYmxvY2sgYW5kIGRlbGVnYXRlcyBhbnkgZXhjZXB0aW9ucyB0bwogICAgICAgICAqIHtAbGluayBuZy4kZXhjZXB0aW9uSGFuZGxlciAkZXhjZXB0aW9uSGFuZGxlcn0gc2VydmljZS4KICAgICAgICAgKgogICAgICAgICAqIFRoZSByZXR1cm4gdmFsdWUgb2YgcmVnaXN0ZXJpbmcgYSB0aW1lb3V0IGZ1bmN0aW9uIGlzIGEgcHJvbWlzZSwgd2hpY2ggd2lsbCBiZSByZXNvbHZlZCB3aGVuCiAgICAgICAgICogdGhlIHRpbWVvdXQgaXMgcmVhY2hlZCBhbmQgdGhlIHRpbWVvdXQgZnVuY3Rpb24gaXMgZXhlY3V0ZWQuCiAgICAgICAgICoKICAgICAgICAgKiBUbyBjYW5jZWwgYSB0aW1lb3V0IHJlcXVlc3QsIGNhbGwgYCR0aW1lb3V0LmNhbmNlbChwcm9taXNlKWAuCiAgICAgICAgICoKICAgICAgICAgKiBJbiB0ZXN0cyB5b3UgY2FuIHVzZSB7QGxpbmsgbmdNb2NrLiR0aW1lb3V0IGAkdGltZW91dC5mbHVzaCgpYH0gdG8KICAgICAgICAgKiBzeW5jaHJvbm91c2x5IGZsdXNoIHRoZSBxdWV1ZSBvZiBkZWZlcnJlZCBmdW5jdGlvbnMuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGZuIEEgZnVuY3Rpb24sIHdob3NlIGV4ZWN1dGlvbiBzaG91bGQgYmUgZGVsYXllZC4KICAgICAgICAgKiBAcGFyYW0ge251bWJlcj19IFtkZWxheT0wXSBEZWxheSBpbiBtaWxsaXNlY29uZHMuCiAgICAgICAgICogQHBhcmFtIHtib29sZWFuPX0gW2ludm9rZUFwcGx5PXRydWVdIElmIHNldCB0byBgZmFsc2VgIHNraXBzIG1vZGVsIGRpcnR5IGNoZWNraW5nLCBvdGhlcndpc2UKICAgICAgICAgKiAgIHdpbGwgaW52b2tlIGBmbmAgd2l0aGluIHRoZSB7QGxpbmsgbmcuJHJvb3RTY29wZS5TY29wZSMkYXBwbHkgJGFwcGx5fSBibG9jay4KICAgICAgICAgKiBAcmV0dXJucyB7UHJvbWlzZX0gUHJvbWlzZSB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgd2hlbiB0aGUgdGltZW91dCBpcyByZWFjaGVkLiBUaGUgdmFsdWUgdGhpcwogICAgICAgICAqICAgcHJvbWlzZSB3aWxsIGJlIHJlc29sdmVkIHdpdGggaXMgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgYGZuYCBmdW5jdGlvbi4KICAgICAgICAgKgogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHRpbWVvdXQoZm4sIGRlbGF5LCBpbnZva2VBcHBseSkgewogICAgICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKSwKICAgICAgICAgICAgcHJvbWlzZSA9IGRlZmVycmVkLnByb21pc2UsCiAgICAgICAgICAgIHNraXBBcHBseSA9IChpc0RlZmluZWQoaW52b2tlQXBwbHkpICYmICFpbnZva2VBcHBseSksCiAgICAgICAgICAgIHRpbWVvdXRJZDsKCiAgICAgICAgICB0aW1lb3V0SWQgPSAkYnJvd3Nlci5kZWZlcihmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKGZuKCkpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICBkZWZlcnJlZC5yZWplY3QoZSk7CiAgICAgICAgICAgICAgJGV4Y2VwdGlvbkhhbmRsZXIoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmluYWxseSB7CiAgICAgICAgICAgICAgZGVsZXRlIGRlZmVycmVkc1twcm9taXNlLiQkdGltZW91dElkXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFza2lwQXBwbHkpICRyb290U2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICB9LCBkZWxheSk7CgogICAgICAgICAgcHJvbWlzZS4kJHRpbWVvdXRJZCA9IHRpbWVvdXRJZDsKICAgICAgICAgIGRlZmVycmVkc1t0aW1lb3V0SWRdID0gZGVmZXJyZWQ7CgogICAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICAgICAgfQoKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICR0aW1lb3V0I2NhbmNlbAogICAgICAgICAqCiAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICogQ2FuY2VscyBhIHRhc2sgYXNzb2NpYXRlZCB3aXRoIHRoZSBgcHJvbWlzZWAuIEFzIGEgcmVzdWx0IG9mIHRoaXMsIHRoZSBwcm9taXNlIHdpbGwgYmUKICAgICAgICAgKiByZXNvbHZlZCB3aXRoIGEgcmVqZWN0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtQcm9taXNlPX0gcHJvbWlzZSBQcm9taXNlIHJldHVybmVkIGJ5IHRoZSBgJHRpbWVvdXRgIGZ1bmN0aW9uLgogICAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdGFzayBoYXNuJ3QgZXhlY3V0ZWQgeWV0IGFuZCB3YXMgc3VjY2Vzc2Z1bGx5CiAgICAgICAgICogICBjYW5jZWxlZC4KICAgICAgICAgKi8KICAgICAgICB0aW1lb3V0LmNhbmNlbCA9IGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAgICAgIGlmIChwcm9taXNlICYmIHByb21pc2UuJCR0aW1lb3V0SWQgaW4gZGVmZXJyZWRzKSB7CiAgICAgICAgICAgIGRlZmVycmVkc1twcm9taXNlLiQkdGltZW91dElkXS5yZWplY3QoJ2NhbmNlbGVkJyk7CiAgICAgICAgICAgIGRlbGV0ZSBkZWZlcnJlZHNbcHJvbWlzZS4kJHRpbWVvdXRJZF07CiAgICAgICAgICAgIHJldHVybiAkYnJvd3Nlci5kZWZlci5jYW5jZWwocHJvbWlzZS4kJHRpbWVvdXRJZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIHRpbWVvdXQ7CiAgICAgIH1dOwogIH0KCi8vIE5PVEU6ICBUaGUgdXNhZ2Ugb2Ygd2luZG93IGFuZCBkb2N1bWVudCBpbnN0ZWFkIG9mICR3aW5kb3cgYW5kICRkb2N1bWVudCBoZXJlIGlzCi8vIGRlbGliZXJhdGUuICBUaGlzIHNlcnZpY2UgZGVwZW5kcyBvbiB0aGUgc3BlY2lmaWMgYmVoYXZpb3Igb2YgYW5jaG9yIG5vZGVzIGNyZWF0ZWQgYnkgdGhlCi8vIGJyb3dzZXIgKHJlc29sdmluZyBhbmQgcGFyc2luZyBVUkxzKSB0aGF0IGlzIHVubGlrZWx5IHRvIGJlIHByb3ZpZGVkIGJ5IG1vY2sgb2JqZWN0cyBhbmQKLy8gY2F1c2UgdXMgdG8gYnJlYWsgdGVzdHMuICBJbiBhZGRpdGlvbiwgd2hlbiB0aGUgYnJvd3NlciByZXNvbHZlcyBhIFVSTCBmb3IgWEhSLCBpdAovLyBkb2Vzbid0IGtub3cgYWJvdXQgbW9ja2VkIGxvY2F0aW9ucyBhbmQgcmVzb2x2ZXMgVVJMcyB0byB0aGUgcmVhbCBkb2N1bWVudCAtIHdoaWNoIGlzCi8vIGV4YWN0bHkgdGhlIGJlaGF2aW9yIG5lZWRlZCBoZXJlLiAgVGhlcmUgaXMgbGl0dGxlIHZhbHVlIGlzIG1vY2tpbmcgdGhlc2Ugb3V0IGZvciB0aGlzCi8vIHNlcnZpY2UuCiAgdmFyIHVybFBhcnNpbmdOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogIHZhciBvcmlnaW5VcmwgPSB1cmxSZXNvbHZlKHdpbmRvdy5sb2NhdGlvbi5ocmVmLCB0cnVlKTsKCgogIC8qKgogICAqCiAgICogSW1wbGVtZW50YXRpb24gTm90ZXMgZm9yIG5vbi1JRSBicm93c2VycwogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgKiBBc3NpZ25pbmcgYSBVUkwgdG8gdGhlIGhyZWYgcHJvcGVydHkgb2YgYW4gYW5jaG9yIERPTSBub2RlLCBldmVuIG9uZSBhdHRhY2hlZCB0byB0aGUgRE9NLAogICAqIHJlc3VsdHMgYm90aCBpbiB0aGUgbm9ybWFsaXppbmcgYW5kIHBhcnNpbmcgb2YgdGhlIFVSTC4gIE5vcm1hbGl6aW5nIG1lYW5zIHRoYXQgYSByZWxhdGl2ZQogICAqIFVSTCB3aWxsIGJlIHJlc29sdmVkIGludG8gYW4gYWJzb2x1dGUgVVJMIGluIHRoZSBjb250ZXh0IG9mIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudC4KICAgKiBQYXJzaW5nIG1lYW5zIHRoYXQgdGhlIGFuY2hvciBub2RlJ3MgaG9zdCwgaG9zdG5hbWUsIHByb3RvY29sLCBwb3J0LCBwYXRobmFtZSBhbmQgcmVsYXRlZAogICAqIHByb3BlcnRpZXMgYXJlIGFsbCBwb3B1bGF0ZWQgdG8gcmVmbGVjdCB0aGUgbm9ybWFsaXplZCBVUkwuICBUaGlzIGFwcHJvYWNoIGhhcyB3aWRlCiAgICogY29tcGF0aWJpbGl0eSAtIFNhZmFyaSAxKywgTW96aWxsYSAxKywgT3BlcmEgNyssZSBldGMuICBTZWUKICAgKiBodHRwOi8vd3d3LmFwdGFuYS5jb20vcmVmZXJlbmNlL2h0bWwvYXBpL0hUTUxBbmNob3JFbGVtZW50Lmh0bWwKICAgKgogICAqIEltcGxlbWVudGF0aW9uIE5vdGVzIGZvciBJRQogICAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAqIElFID49IDggYW5kIDw9IDEwIG5vcm1hbGl6ZXMgdGhlIFVSTCB3aGVuIGFzc2lnbmVkIHRvIHRoZSBhbmNob3Igbm9kZSBzaW1pbGFyIHRvIHRoZSBvdGhlcgogICAqIGJyb3dzZXJzLiAgSG93ZXZlciwgdGhlIHBhcnNlZCBjb21wb25lbnRzIHdpbGwgbm90IGJlIHNldCBpZiB0aGUgVVJMIGFzc2lnbmVkIGRpZCBub3Qgc3BlY2lmeQogICAqIHRoZW0uICAoZS5nLiBpZiB5b3UgYXNzaWduIGEuaHJlZiA9ICJmb28iLCB0aGVuIGEucHJvdG9jb2wsIGEuaG9zdCwgZXRjLiB3aWxsIGJlIGVtcHR5LikgIFdlCiAgICogd29yayBhcm91bmQgdGhhdCBieSBwZXJmb3JtaW5nIHRoZSBwYXJzaW5nIGluIGEgMm5kIHN0ZXAgYnkgdGFraW5nIGEgcHJldmlvdXNseSBub3JtYWxpemVkCiAgICogVVJMIChlLmcuIGJ5IGFzc2lnbmluZyB0byBhLmhyZWYpIGFuZCBhc3NpZ25pbmcgaXQgYS5ocmVmIGFnYWluLiAgVGhpcyBjb3JyZWN0bHkgcG9wdWxhdGVzIHRoZQogICAqIHByb3BlcnRpZXMgc3VjaCBhcyBwcm90b2NvbCwgaG9zdG5hbWUsIHBvcnQsIGV0Yy4KICAgKgogICAqIElFNyBkb2VzIG5vdCBub3JtYWxpemUgdGhlIFVSTCB3aGVuIGFzc2lnbmVkIHRvIGFuIGFuY2hvciBub2RlLiAgKEFwcGFyZW50bHksIGl0IGRvZXMsIGlmIG9uZQogICAqIHVzZXMgdGhlIGlubmVyIEhUTUwgYXBwcm9hY2ggdG8gYXNzaWduIHRoZSBVUkwgYXMgcGFydCBvZiBhbiBIVE1MIHNuaXBwZXQgLQogICAqIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzQ3MjcyOSkgIEhvd2V2ZXIsIHNldHRpbmcgaW1nW3NyY10gZG9lcyBub3JtYWxpemUgdGhlIFVSTC4KICAgKiBVbmZvcnR1bmF0ZWx5LCBzZXR0aW5nIGltZ1tzcmNdIHRvIHNvbWV0aGluZyBsaWtlICJqYXZhc2NyaXB0OmZvbyIgb24gSUUgdGhyb3dzIGFuIGV4Y2VwdGlvbi4KICAgKiBTaW5jZSB0aGUgcHJpbWFyeSB1c2FnZSBmb3Igbm9ybWFsaXppbmcgVVJMcyBpcyB0byBzYW5pdGl6ZSBzdWNoIFVSTHMsIHdlIGNhbid0IHVzZSB0aGF0CiAgICogbWV0aG9kIGFuZCBJRSA8IDggaXMgdW5zdXBwb3J0ZWQuCiAgICoKICAgKiBSZWZlcmVuY2VzOgogICAqICAgaHR0cDovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvSFRNTEFuY2hvckVsZW1lbnQKICAgKiAgIGh0dHA6Ly93d3cuYXB0YW5hLmNvbS9yZWZlcmVuY2UvaHRtbC9hcGkvSFRNTEFuY2hvckVsZW1lbnQuaHRtbAogICAqICAgaHR0cDovL3VybC5zcGVjLndoYXR3Zy5vcmcvI3VybHV0aWxzCiAgICogICBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL3B1bGwvMjkwMgogICAqICAgaHR0cDovL2phbWVzLnBhZG9sc2V5LmNvbS9qYXZhc2NyaXB0L3BhcnNpbmctdXJscy13aXRoLXRoZS1kb20vCiAgICoKICAgKiBAa2luZCBmdW5jdGlvbgogICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIFVSTCB0byBiZSBwYXJzZWQuCiAgICogQGRlc2NyaXB0aW9uIE5vcm1hbGl6ZXMgYW5kIHBhcnNlcyBhIFVSTC4KICAgKiBAcmV0dXJucyB7b2JqZWN0fSBSZXR1cm5zIHRoZSBub3JtYWxpemVkIFVSTCBhcyBhIGRpY3Rpb25hcnkuCiAgICoKICAgKiAgIHwgbWVtYmVyIG5hbWUgICB8IERlc2NyaXB0aW9uICAgIHwKICAgKiAgIHwtLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLXwKICAgKiAgIHwgaHJlZiAgICAgICAgICB8IEEgbm9ybWFsaXplZCB2ZXJzaW9uIG9mIHRoZSBwcm92aWRlZCBVUkwgaWYgaXQgd2FzIG5vdCBhbiBhYnNvbHV0ZSBVUkwgfAogICAqICAgfCBwcm90b2NvbCAgICAgIHwgVGhlIHByb3RvY29sIGluY2x1ZGluZyB0aGUgdHJhaWxpbmcgY29sb24gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICogICB8IGhvc3QgICAgICAgICAgfCBUaGUgaG9zdCBhbmQgcG9ydCAoaWYgdGhlIHBvcnQgaXMgbm9uLWRlZmF1bHQpIG9mIHRoZSBub3JtYWxpemVkVXJsICAgIHwKICAgKiAgIHwgc2VhcmNoICAgICAgICB8IFRoZSBzZWFyY2ggcGFyYW1zLCBtaW51cyB0aGUgcXVlc3Rpb24gbWFyayAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfAogICAqICAgfCBoYXNoICAgICAgICAgIHwgVGhlIGhhc2ggc3RyaW5nLCBtaW51cyB0aGUgaGFzaCBzeW1ib2wKICAgKiAgIHwgaG9zdG5hbWUgICAgICB8IFRoZSBob3N0bmFtZQogICAqICAgfCBwb3J0ICAgICAgICAgIHwgVGhlIHBvcnQsIHdpdGhvdXQgIjoiCiAgICogICB8IHBhdGhuYW1lICAgICAgfCBUaGUgcGF0aG5hbWUsIGJlZ2lubmluZyB3aXRoICIvIgogICAqCiAgICovCiAgZnVuY3Rpb24gdXJsUmVzb2x2ZSh1cmwsIGJhc2UpIHsKICAgIHZhciBocmVmID0gdXJsOwoKICAgIGlmIChtc2llKSB7CiAgICAgIC8vIE5vcm1hbGl6ZSBiZWZvcmUgcGFyc2UuICBSZWZlciBJbXBsZW1lbnRhdGlvbiBOb3RlcyBvbiB3aHkgdGhpcyBpcwogICAgICAvLyBkb25lIGluIHR3byBzdGVwcyBvbiBJRS4KICAgICAgdXJsUGFyc2luZ05vZGUuc2V0QXR0cmlidXRlKCJocmVmIiwgaHJlZik7CiAgICAgIGhyZWYgPSB1cmxQYXJzaW5nTm9kZS5ocmVmOwogICAgfQoKICAgIHVybFBhcnNpbmdOb2RlLnNldEF0dHJpYnV0ZSgnaHJlZicsIGhyZWYpOwoKICAgIC8vIHVybFBhcnNpbmdOb2RlIHByb3ZpZGVzIHRoZSBVcmxVdGlscyBpbnRlcmZhY2UgLSBodHRwOi8vdXJsLnNwZWMud2hhdHdnLm9yZy8jdXJsdXRpbHMKICAgIHJldHVybiB7CiAgICAgIGhyZWY6IHVybFBhcnNpbmdOb2RlLmhyZWYsCiAgICAgIHByb3RvY29sOiB1cmxQYXJzaW5nTm9kZS5wcm90b2NvbCA/IHVybFBhcnNpbmdOb2RlLnByb3RvY29sLnJlcGxhY2UoLzokLywgJycpIDogJycsCiAgICAgIGhvc3Q6IHVybFBhcnNpbmdOb2RlLmhvc3QsCiAgICAgIHNlYXJjaDogdXJsUGFyc2luZ05vZGUuc2VhcmNoID8gdXJsUGFyc2luZ05vZGUuc2VhcmNoLnJlcGxhY2UoL15cPy8sICcnKSA6ICcnLAogICAgICBoYXNoOiB1cmxQYXJzaW5nTm9kZS5oYXNoID8gdXJsUGFyc2luZ05vZGUuaGFzaC5yZXBsYWNlKC9eIy8sICcnKSA6ICcnLAogICAgICBob3N0bmFtZTogdXJsUGFyc2luZ05vZGUuaG9zdG5hbWUsCiAgICAgIHBvcnQ6IHVybFBhcnNpbmdOb2RlLnBvcnQsCiAgICAgIHBhdGhuYW1lOiAodXJsUGFyc2luZ05vZGUucGF0aG5hbWUuY2hhckF0KDApID09PSAnLycpCiAgICAgICAgPyB1cmxQYXJzaW5nTm9kZS5wYXRobmFtZQogICAgICAgIDogJy8nICsgdXJsUGFyc2luZ05vZGUucGF0aG5hbWUKICAgIH07CiAgfQoKICAvKioKICAgKiBQYXJzZSBhIHJlcXVlc3QgVVJMIGFuZCBkZXRlcm1pbmUgd2hldGhlciB0aGlzIGlzIGEgc2FtZS1vcmlnaW4gcmVxdWVzdCBhcyB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3R9IHJlcXVlc3RVcmwgVGhlIHVybCBvZiB0aGUgcmVxdWVzdCBhcyBhIHN0cmluZyB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQKICAgKiBvciBhIHBhcnNlZCBVUkwgb2JqZWN0LgogICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSByZXF1ZXN0IGlzIGZvciB0aGUgc2FtZSBvcmlnaW4gYXMgdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50LgogICAqLwogIGZ1bmN0aW9uIHVybElzU2FtZU9yaWdpbihyZXF1ZXN0VXJsKSB7CiAgICB2YXIgcGFyc2VkID0gKGlzU3RyaW5nKHJlcXVlc3RVcmwpKSA/IHVybFJlc29sdmUocmVxdWVzdFVybCkgOiByZXF1ZXN0VXJsOwogICAgcmV0dXJuIChwYXJzZWQucHJvdG9jb2wgPT09IG9yaWdpblVybC5wcm90b2NvbCAmJgogICAgICBwYXJzZWQuaG9zdCA9PT0gb3JpZ2luVXJsLmhvc3QpOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkd2luZG93CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBIHJlZmVyZW5jZSB0byB0aGUgYnJvd3NlcidzIGB3aW5kb3dgIG9iamVjdC4gV2hpbGUgYHdpbmRvd2AKICAgKiBpcyBnbG9iYWxseSBhdmFpbGFibGUgaW4gSmF2YVNjcmlwdCwgaXQgY2F1c2VzIHRlc3RhYmlsaXR5IHByb2JsZW1zLCBiZWNhdXNlCiAgICogaXQgaXMgYSBnbG9iYWwgdmFyaWFibGUuIEluIGFuZ3VsYXIgd2UgYWx3YXlzIHJlZmVyIHRvIGl0IHRocm91Z2ggdGhlCiAgICogYCR3aW5kb3dgIHNlcnZpY2UsIHNvIGl0IG1heSBiZSBvdmVycmlkZGVuLCByZW1vdmVkIG9yIG1vY2tlZCBmb3IgdGVzdGluZy4KICAgKgogICAqIEV4cHJlc3Npb25zLCBsaWtlIHRoZSBvbmUgZGVmaW5lZCBmb3IgdGhlIGBuZ0NsaWNrYCBkaXJlY3RpdmUgaW4gdGhlIGV4YW1wbGUKICAgKiBiZWxvdywgYXJlIGV2YWx1YXRlZCB3aXRoIHJlc3BlY3QgdG8gdGhlIGN1cnJlbnQgc2NvcGUuICBUaGVyZWZvcmUsIHRoZXJlIGlzCiAgICogbm8gcmlzayBvZiBpbmFkdmVydGVudGx5IGNvZGluZyBpbiBhIGRlcGVuZGVuY3kgb24gYSBnbG9iYWwgdmFsdWUgaW4gc3VjaCBhbgogICAqIGV4cHJlc3Npb24uCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlLCAkd2luZG93KSB7CiAgICAgICAgICAgJHNjb3BlLmdyZWV0aW5nID0gJ0hlbGxvLCBXb3JsZCEnOwogICAgICAgICAgICRzY29wZS5kb0dyZWV0aW5nID0gZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgICAgICAgICAgICAgJHdpbmRvdy5hbGVydChncmVldGluZyk7CiAgICAgICAgICAgfTsKICAgICAgICAgfQogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJncmVldGluZyIgLz4KICAgPGJ1dHRvbiBuZy1jbGljaz0iZG9HcmVldGluZyhncmVldGluZykiPkFMRVJUPC9idXR0b24+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGRpc3BsYXkgdGhlIGdyZWV0aW5nIGluIHRoZSBpbnB1dCBib3gnLCBmdW5jdGlvbigpIHsKICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2dyZWV0aW5nJykpLnNlbmRLZXlzKCdIZWxsbywgRTJFIFRlc3RzJyk7CiAgICAgICAvLyBJZiB3ZSBjbGljayB0aGUgYnV0dG9uIGl0IHdpbGwgYmxvY2sgdGhlIHRlc3QgcnVubmVyCiAgICAgICAvLyBlbGVtZW50KCc6YnV0dG9uJykuY2xpY2soKTsKICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIGZ1bmN0aW9uICRXaW5kb3dQcm92aWRlcigpewogICAgdGhpcy4kZ2V0ID0gdmFsdWVGbih3aW5kb3cpOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIHByb3ZpZGVyCiAgICogQG5hbWUgJGZpbHRlclByb3ZpZGVyCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBGaWx0ZXJzIGFyZSBqdXN0IGZ1bmN0aW9ucyB3aGljaCB0cmFuc2Zvcm0gaW5wdXQgdG8gYW4gb3V0cHV0LiBIb3dldmVyIGZpbHRlcnMgbmVlZCB0byBiZQogICAqIERlcGVuZGVuY3kgSW5qZWN0ZWQuIFRvIGFjaGlldmUgdGhpcyBhIGZpbHRlciBkZWZpbml0aW9uIGNvbnNpc3RzIG9mIGEgZmFjdG9yeSBmdW5jdGlvbiB3aGljaCBpcwogICAqIGFubm90YXRlZCB3aXRoIGRlcGVuZGVuY2llcyBhbmQgaXMgcmVzcG9uc2libGUgZm9yIGNyZWF0aW5nIGEgZmlsdGVyIGZ1bmN0aW9uLgogICAqCiAgICogYGBganMKICAgKiAgIC8vIEZpbHRlciByZWdpc3RyYXRpb24KICAgKiAgIGZ1bmN0aW9uIE15TW9kdWxlKCRwcm92aWRlLCAkZmlsdGVyUHJvdmlkZXIpIHsKICogICAgIC8vIGNyZWF0ZSBhIHNlcnZpY2UgdG8gZGVtb25zdHJhdGUgaW5qZWN0aW9uIChub3QgYWx3YXlzIG5lZWRlZCkKICogICAgICRwcm92aWRlLnZhbHVlKCdncmVldCcsIGZ1bmN0aW9uKG5hbWUpewogKiAgICAgICByZXR1cm4gJ0hlbGxvICcgKyBuYW1lICsgJyEnOwogKiAgICAgfSk7CiAqCiAqICAgICAvLyByZWdpc3RlciBhIGZpbHRlciBmYWN0b3J5IHdoaWNoIHVzZXMgdGhlCiAqICAgICAvLyBncmVldCBzZXJ2aWNlIHRvIGRlbW9uc3RyYXRlIERJLgogKiAgICAgJGZpbHRlclByb3ZpZGVyLnJlZ2lzdGVyKCdncmVldCcsIGZ1bmN0aW9uKGdyZWV0KXsKICogICAgICAgLy8gcmV0dXJuIHRoZSBmaWx0ZXIgZnVuY3Rpb24gd2hpY2ggdXNlcyB0aGUgZ3JlZXQgc2VydmljZQogKiAgICAgICAvLyB0byBnZW5lcmF0ZSBzYWx1dGF0aW9uCiAqICAgICAgIHJldHVybiBmdW5jdGlvbih0ZXh0KSB7CiAqICAgICAgICAgLy8gZmlsdGVycyBuZWVkIHRvIGJlIGZvcmdpdmluZyBzbyBjaGVjayBpbnB1dCB2YWxpZGl0eQogKiAgICAgICAgIHJldHVybiB0ZXh0ICYmIGdyZWV0KHRleHQpIHx8IHRleHQ7CiAqICAgICAgIH07CiAqICAgICB9KTsKICogICB9CiAgICogYGBgCiAgICoKICAgKiBUaGUgZmlsdGVyIGZ1bmN0aW9uIGlzIHJlZ2lzdGVyZWQgd2l0aCB0aGUgYCRpbmplY3RvcmAgdW5kZXIgdGhlIGZpbHRlciBuYW1lIHN1ZmZpeCB3aXRoCiAgICogYEZpbHRlcmAuCiAgICoKICAgKiBgYGBqcwogICAqICAgaXQoJ3Nob3VsZCBiZSB0aGUgc2FtZSBpbnN0YW5jZScsIGluamVjdCgKICAgKiAgICAgZnVuY3Rpb24oJGZpbHRlclByb3ZpZGVyKSB7CiAqICAgICAgICRmaWx0ZXJQcm92aWRlci5yZWdpc3RlcigncmV2ZXJzZScsIGZ1bmN0aW9uKCl7CiAqICAgICAgICAgcmV0dXJuIC4uLjsKICogICAgICAgfSk7CiAqICAgICB9LAogICAqICAgICBmdW5jdGlvbigkZmlsdGVyLCByZXZlcnNlRmlsdGVyKSB7CiAqICAgICAgIGV4cGVjdCgkZmlsdGVyKCdyZXZlcnNlJykpLnRvQmUocmV2ZXJzZUZpbHRlcik7CiAqICAgICB9KTsKICAgKiBgYGAKICAgKgogICAqCiAgICogRm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgaG93IGFuZ3VsYXIgZmlsdGVycyB3b3JrLCBhbmQgaG93IHRvIGNyZWF0ZSB5b3VyIG93biBmaWx0ZXJzLCBzZWUKICAgKiB7QGxpbmsgZ3VpZGUvZmlsdGVyIEZpbHRlcnN9IGluIHRoZSBBbmd1bGFyIERldmVsb3BlciBHdWlkZS4KICAgKi8KICAvKioKICAgKiBAbmdkb2MgbWV0aG9kCiAgICogQG5hbWUgJGZpbHRlclByb3ZpZGVyI3JlZ2lzdGVyCiAgICogQGRlc2NyaXB0aW9uCiAgICogUmVnaXN0ZXIgZmlsdGVyIGZhY3RvcnkgZnVuY3Rpb24uCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZpbHRlciBmYWN0b3J5IGZ1bmN0aW9uIHdoaWNoIGlzIGluamVjdGFibGUuCiAgICovCgoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRmaWx0ZXIKICAgKiBAa2luZCBmdW5jdGlvbgogICAqIEBkZXNjcmlwdGlvbgogICAqIEZpbHRlcnMgYXJlIHVzZWQgZm9yIGZvcm1hdHRpbmcgZGF0YSBkaXNwbGF5ZWQgdG8gdGhlIHVzZXIuCiAgICoKICAgKiBUaGUgZ2VuZXJhbCBzeW50YXggaW4gdGVtcGxhdGVzIGlzIGFzIGZvbGxvd3M6CiAgICoKICAgKiAgICAgICAgIHt7IGV4cHJlc3Npb24gW3wgZmlsdGVyX25hbWVbOnBhcmFtZXRlcl92YWx1ZV0gLi4uIF0gfX0KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIGZpbHRlciBmdW5jdGlvbiB0byByZXRyaWV2ZQogICAqIEByZXR1cm4ge0Z1bmN0aW9ufSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbmFtZT0iJGZpbHRlciIgbW9kdWxlPSJmaWx0ZXJFeGFtcGxlIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iTWFpbkN0cmwiPgogICA8aDM+e3sgb3JpZ2luYWxUZXh0IH19PC9oMz4KICAgPGgzPnt7IGZpbHRlcmVkVGV4dCB9fTwvaDM+CiAgIDwvZGl2PgogICA8L2ZpbGU+CgogICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICBhbmd1bGFyLm1vZHVsZSgnZmlsdGVyRXhhbXBsZScsIFtdKQogICAuY29udHJvbGxlcignTWFpbkN0cmwnLCBmdW5jdGlvbigkc2NvcGUsICRmaWx0ZXIpIHsKICAgICAgICAkc2NvcGUub3JpZ2luYWxUZXh0ID0gJ2hlbGxvJzsKICAgICAgICAkc2NvcGUuZmlsdGVyZWRUZXh0ID0gJGZpbHRlcigndXBwZXJjYXNlJykoJHNjb3BlLm9yaWdpbmFsVGV4dCk7CiAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICAkRmlsdGVyUHJvdmlkZXIuJGluamVjdCA9IFsnJHByb3ZpZGUnXTsKICBmdW5jdGlvbiAkRmlsdGVyUHJvdmlkZXIoJHByb3ZpZGUpIHsKICAgIHZhciBzdWZmaXggPSAnRmlsdGVyJzsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRjb250cm9sbGVyUHJvdmlkZXIjcmVnaXN0ZXIKICAgICAqIEBwYXJhbSB7c3RyaW5nfE9iamVjdH0gbmFtZSBOYW1lIG9mIHRoZSBmaWx0ZXIgZnVuY3Rpb24sIG9yIGFuIG9iamVjdCBtYXAgb2YgZmlsdGVycyB3aGVyZQogICAgICogICAgdGhlIGtleXMgYXJlIHRoZSBmaWx0ZXIgbmFtZXMgYW5kIHRoZSB2YWx1ZXMgYXJlIHRoZSBmaWx0ZXIgZmFjdG9yaWVzLgogICAgICogQHJldHVybnMge09iamVjdH0gUmVnaXN0ZXJlZCBmaWx0ZXIgaW5zdGFuY2UsIG9yIGlmIGEgbWFwIG9mIGZpbHRlcnMgd2FzIHByb3ZpZGVkIHRoZW4gYSBtYXAKICAgICAqICAgIG9mIHRoZSByZWdpc3RlcmVkIGZpbHRlciBpbnN0YW5jZXMuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlZ2lzdGVyKG5hbWUsIGZhY3RvcnkpIHsKICAgICAgaWYoaXNPYmplY3QobmFtZSkpIHsKICAgICAgICB2YXIgZmlsdGVycyA9IHt9OwogICAgICAgIGZvckVhY2gobmFtZSwgZnVuY3Rpb24oZmlsdGVyLCBrZXkpIHsKICAgICAgICAgIGZpbHRlcnNba2V5XSA9IHJlZ2lzdGVyKGtleSwgZmlsdGVyKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZmlsdGVyczsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gJHByb3ZpZGUuZmFjdG9yeShuYW1lICsgc3VmZml4LCBmYWN0b3J5KTsKICAgICAgfQogICAgfQogICAgdGhpcy5yZWdpc3RlciA9IHJlZ2lzdGVyOwoKICAgIHRoaXMuJGdldCA9IFsnJGluamVjdG9yJywgZnVuY3Rpb24oJGluamVjdG9yKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgcmV0dXJuICRpbmplY3Rvci5nZXQobmFtZSArIHN1ZmZpeCk7CiAgICAgIH07CiAgICB9XTsKCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogICAgLyogZ2xvYmFsCiAgICAgY3VycmVuY3lGaWx0ZXI6IGZhbHNlLAogICAgIGRhdGVGaWx0ZXI6IGZhbHNlLAogICAgIGZpbHRlckZpbHRlcjogZmFsc2UsCiAgICAganNvbkZpbHRlcjogZmFsc2UsCiAgICAgbGltaXRUb0ZpbHRlcjogZmFsc2UsCiAgICAgbG93ZXJjYXNlRmlsdGVyOiBmYWxzZSwKICAgICBudW1iZXJGaWx0ZXI6IGZhbHNlLAogICAgIG9yZGVyQnlGaWx0ZXI6IGZhbHNlLAogICAgIHVwcGVyY2FzZUZpbHRlcjogZmFsc2UsCiAgICAgKi8KCiAgICByZWdpc3RlcignY3VycmVuY3knLCBjdXJyZW5jeUZpbHRlcik7CiAgICByZWdpc3RlcignZGF0ZScsIGRhdGVGaWx0ZXIpOwogICAgcmVnaXN0ZXIoJ2ZpbHRlcicsIGZpbHRlckZpbHRlcik7CiAgICByZWdpc3RlcignanNvbicsIGpzb25GaWx0ZXIpOwogICAgcmVnaXN0ZXIoJ2xpbWl0VG8nLCBsaW1pdFRvRmlsdGVyKTsKICAgIHJlZ2lzdGVyKCdsb3dlcmNhc2UnLCBsb3dlcmNhc2VGaWx0ZXIpOwogICAgcmVnaXN0ZXIoJ251bWJlcicsIG51bWJlckZpbHRlcik7CiAgICByZWdpc3Rlcignb3JkZXJCeScsIG9yZGVyQnlGaWx0ZXIpOwogICAgcmVnaXN0ZXIoJ3VwcGVyY2FzZScsIHVwcGVyY2FzZUZpbHRlcik7CiAgfQoKICAvKioKICAgKiBAbmdkb2MgZmlsdGVyCiAgICogQG5hbWUgZmlsdGVyCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNlbGVjdHMgYSBzdWJzZXQgb2YgaXRlbXMgZnJvbSBgYXJyYXlgIGFuZCByZXR1cm5zIGl0IGFzIGEgbmV3IGFycmF5LgogICAqCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIHNvdXJjZSBhcnJheS4KICAgKiBAcGFyYW0ge3N0cmluZ3xPYmplY3R8ZnVuY3Rpb24oKX0gZXhwcmVzc2lvbiBUaGUgcHJlZGljYXRlIHRvIGJlIHVzZWQgZm9yIHNlbGVjdGluZyBpdGVtcyBmcm9tCiAgICogICBgYXJyYXlgLgogICAqCiAgICogICBDYW4gYmUgb25lIG9mOgogICAqCiAgICogICAtIGBzdHJpbmdgOiBUaGUgc3RyaW5nIGlzIGV2YWx1YXRlZCBhcyBhbiBleHByZXNzaW9uIGFuZCB0aGUgcmVzdWx0aW5nIHZhbHVlIGlzIHVzZWQgZm9yIHN1YnN0cmluZyBtYXRjaCBhZ2FpbnN0CiAgICogICAgIHRoZSBjb250ZW50cyBvZiB0aGUgYGFycmF5YC4gQWxsIHN0cmluZ3Mgb3Igb2JqZWN0cyB3aXRoIHN0cmluZyBwcm9wZXJ0aWVzIGluIGBhcnJheWAgdGhhdCBjb250YWluIHRoaXMgc3RyaW5nCiAgICogICAgIHdpbGwgYmUgcmV0dXJuZWQuIFRoZSBwcmVkaWNhdGUgY2FuIGJlIG5lZ2F0ZWQgYnkgcHJlZml4aW5nIHRoZSBzdHJpbmcgd2l0aCBgIWAuCiAgICoKICAgKiAgIC0gYE9iamVjdGA6IEEgcGF0dGVybiBvYmplY3QgY2FuIGJlIHVzZWQgdG8gZmlsdGVyIHNwZWNpZmljIHByb3BlcnRpZXMgb24gb2JqZWN0cyBjb250YWluZWQKICAgKiAgICAgYnkgYGFycmF5YC4gRm9yIGV4YW1wbGUgYHtuYW1lOiJNIiwgcGhvbmU6IjEifWAgcHJlZGljYXRlIHdpbGwgcmV0dXJuIGFuIGFycmF5IG9mIGl0ZW1zCiAgICogICAgIHdoaWNoIGhhdmUgcHJvcGVydHkgYG5hbWVgIGNvbnRhaW5pbmcgIk0iIGFuZCBwcm9wZXJ0eSBgcGhvbmVgIGNvbnRhaW5pbmcgIjEiLiBBIHNwZWNpYWwKICAgKiAgICAgcHJvcGVydHkgbmFtZSBgJGAgY2FuIGJlIHVzZWQgKGFzIGluIGB7JDoidGV4dCJ9YCkgdG8gYWNjZXB0IGEgbWF0Y2ggYWdhaW5zdCBhbnkKICAgKiAgICAgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4gVGhhdCdzIGVxdWl2YWxlbnQgdG8gdGhlIHNpbXBsZSBzdWJzdHJpbmcgbWF0Y2ggd2l0aCBhIGBzdHJpbmdgCiAgICogICAgIGFzIGRlc2NyaWJlZCBhYm92ZS4KICAgKgogICAqICAgLSBgZnVuY3Rpb24odmFsdWUpYDogQSBwcmVkaWNhdGUgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gd3JpdGUgYXJiaXRyYXJ5IGZpbHRlcnMuIFRoZSBmdW5jdGlvbiBpcwogICAqICAgICBjYWxsZWQgZm9yIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgLiBUaGUgZmluYWwgcmVzdWx0IGlzIGFuIGFycmF5IG9mIHRob3NlIGVsZW1lbnRzIHRoYXQKICAgKiAgICAgdGhlIHByZWRpY2F0ZSByZXR1cm5lZCB0cnVlIGZvci4KICAgKgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCl8dHJ1ZXx1bmRlZmluZWR9IGNvbXBhcmF0b3IgQ29tcGFyYXRvciB3aGljaCBpcyB1c2VkIGluCiAgICogICAgIGRldGVybWluaW5nIGlmIHRoZSBleHBlY3RlZCB2YWx1ZSAoZnJvbSB0aGUgZmlsdGVyIGV4cHJlc3Npb24pIGFuZCBhY3R1YWwgdmFsdWUgKGZyb20KICAgKiAgICAgdGhlIG9iamVjdCBpbiB0aGUgYXJyYXkpIHNob3VsZCBiZSBjb25zaWRlcmVkIGEgbWF0Y2guCiAgICoKICAgKiAgIENhbiBiZSBvbmUgb2Y6CiAgICoKICAgKiAgIC0gYGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQpYDoKICAgKiAgICAgVGhlIGZ1bmN0aW9uIHdpbGwgYmUgZ2l2ZW4gdGhlIG9iamVjdCB2YWx1ZSBhbmQgdGhlIHByZWRpY2F0ZSB2YWx1ZSB0byBjb21wYXJlIGFuZAogICAqICAgICBzaG91bGQgcmV0dXJuIHRydWUgaWYgdGhlIGl0ZW0gc2hvdWxkIGJlIGluY2x1ZGVkIGluIGZpbHRlcmVkIHJlc3VsdC4KICAgKgogICAqICAgLSBgdHJ1ZWA6IEEgc2hvcnRoYW5kIGZvciBgZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCkgeyByZXR1cm4gYW5ndWxhci5lcXVhbHMoZXhwZWN0ZWQsIGFjdHVhbCl9YC4KICAgKiAgICAgdGhpcyBpcyBlc3NlbnRpYWxseSBzdHJpY3QgY29tcGFyaXNvbiBvZiBleHBlY3RlZCBhbmQgYWN0dWFsLgogICAqCiAgICogICAtIGBmYWxzZXx1bmRlZmluZWRgOiBBIHNob3J0IGhhbmQgZm9yIGEgZnVuY3Rpb24gd2hpY2ggd2lsbCBsb29rIGZvciBhIHN1YnN0cmluZyBtYXRjaCBpbiBjYXNlCiAgICogICAgIGluc2Vuc2l0aXZlIHdheS4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGRpdiBuZy1pbml0PSJmcmllbmRzID0gW3tuYW1lOidKb2huJywgcGhvbmU6JzU1NS0xMjc2J30sCiAgIHtuYW1lOidNYXJ5JywgcGhvbmU6JzgwMC1CSUctTUFSWSd9LAogICB7bmFtZTonTWlrZScsIHBob25lOic1NTUtNDMyMSd9LAogICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCd9LAogICB7bmFtZTonSnVsaWUnLCBwaG9uZTonNTU1LTg3NjUnfSwKICAge25hbWU6J0p1bGlldHRlJywgcGhvbmU6JzU1NS01Njc4J31dIj48L2Rpdj4KCiAgIFNlYXJjaDogPGlucHV0IG5nLW1vZGVsPSJzZWFyY2hUZXh0Ij4KICAgPHRhYmxlIGlkPSJzZWFyY2hUZXh0UmVzdWx0cyI+CiAgIDx0cj48dGg+TmFtZTwvdGg+PHRoPlBob25lPC90aD48L3RyPgogICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2hUZXh0Ij4KICAgPHRkPnt7ZnJpZW5kLm5hbWV9fTwvdGQ+CiAgIDx0ZD57e2ZyaWVuZC5waG9uZX19PC90ZD4KICAgPC90cj4KICAgPC90YWJsZT4KICAgPGhyPgogICBBbnk6IDxpbnB1dCBuZy1tb2RlbD0ic2VhcmNoLiQiPiA8YnI+CiAgIE5hbWUgb25seSA8aW5wdXQgbmctbW9kZWw9InNlYXJjaC5uYW1lIj48YnI+CiAgIFBob25lIG9ubHkgPGlucHV0IG5nLW1vZGVsPSJzZWFyY2gucGhvbmUiPjxicj4KICAgRXF1YWxpdHkgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ic3RyaWN0Ij48YnI+CiAgIDx0YWJsZSBpZD0ic2VhcmNoT2JqUmVzdWx0cyI+CiAgIDx0cj48dGg+TmFtZTwvdGg+PHRoPlBob25lPC90aD48L3RyPgogICA8dHIgbmctcmVwZWF0PSJmcmllbmRPYmogaW4gZnJpZW5kcyB8IGZpbHRlcjpzZWFyY2g6c3RyaWN0Ij4KICAgPHRkPnt7ZnJpZW5kT2JqLm5hbWV9fTwvdGQ+CiAgIDx0ZD57e2ZyaWVuZE9iai5waG9uZX19PC90ZD4KICAgPC90cj4KICAgPC90YWJsZT4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgdmFyIGV4cGVjdEZyaWVuZE5hbWVzID0gZnVuY3Rpb24oZXhwZWN0ZWROYW1lcywga2V5KSB7CiAgICAgICAgIGVsZW1lbnQuYWxsKGJ5LnJlcGVhdGVyKGtleSArICcgaW4gZnJpZW5kcycpLmNvbHVtbihrZXkgKyAnLm5hbWUnKSkudGhlbihmdW5jdGlvbihhcnIpIHsKICAgICAgICAgICBhcnIuZm9yRWFjaChmdW5jdGlvbih3ZCwgaSkgewogICAgICAgICAgICAgZXhwZWN0KHdkLmdldFRleHQoKSkudG9NYXRjaChleHBlY3RlZE5hbWVzW2ldKTsKICAgICAgICAgICB9KTsKICAgICAgICAgfSk7CiAgICAgICB9OwoKICAgaXQoJ3Nob3VsZCBzZWFyY2ggYWNyb3NzIGFsbCBmaWVsZHMgd2hlbiBmaWx0ZXJpbmcgd2l0aCBhIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICB2YXIgc2VhcmNoVGV4dCA9IGVsZW1lbnQoYnkubW9kZWwoJ3NlYXJjaFRleHQnKSk7CiAgICAgICAgIHNlYXJjaFRleHQuY2xlYXIoKTsKICAgICAgICAgc2VhcmNoVGV4dC5zZW5kS2V5cygnbScpOwogICAgICAgICBleHBlY3RGcmllbmROYW1lcyhbJ01hcnknLCAnTWlrZScsICdBZGFtJ10sICdmcmllbmQnKTsKCiAgICAgICAgIHNlYXJjaFRleHQuY2xlYXIoKTsKICAgICAgICAgc2VhcmNoVGV4dC5zZW5kS2V5cygnNzYnKTsKICAgICAgICAgZXhwZWN0RnJpZW5kTmFtZXMoWydKb2huJywgJ0p1bGllJ10sICdmcmllbmQnKTsKICAgICAgIH0pOwoKICAgaXQoJ3Nob3VsZCBzZWFyY2ggaW4gc3BlY2lmaWMgZmllbGRzIHdoZW4gZmlsdGVyaW5nIHdpdGggYSBwcmVkaWNhdGUgb2JqZWN0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBzZWFyY2hBbnkgPSBlbGVtZW50KGJ5Lm1vZGVsKCdzZWFyY2guJCcpKTsKICAgICAgICAgc2VhcmNoQW55LmNsZWFyKCk7CiAgICAgICAgIHNlYXJjaEFueS5zZW5kS2V5cygnaScpOwogICAgICAgICBleHBlY3RGcmllbmROYW1lcyhbJ01hcnknLCAnTWlrZScsICdKdWxpZScsICdKdWxpZXR0ZSddLCAnZnJpZW5kT2JqJyk7CiAgICAgICB9KTsKICAgaXQoJ3Nob3VsZCB1c2UgYSBlcXVhbCBjb21wYXJpc29uIHdoZW4gY29tcGFyYXRvciBpcyB0cnVlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIHZhciBzZWFyY2hOYW1lID0gZWxlbWVudChieS5tb2RlbCgnc2VhcmNoLm5hbWUnKSk7CiAgICAgICAgIHZhciBzdHJpY3QgPSBlbGVtZW50KGJ5Lm1vZGVsKCdzdHJpY3QnKSk7CiAgICAgICAgIHNlYXJjaE5hbWUuY2xlYXIoKTsKICAgICAgICAgc2VhcmNoTmFtZS5zZW5kS2V5cygnSnVsaWUnKTsKICAgICAgICAgc3RyaWN0LmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdEZyaWVuZE5hbWVzKFsnSnVsaWUnXSwgJ2ZyaWVuZE9iaicpOwogICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIGZ1bmN0aW9uIGZpbHRlckZpbHRlcigpIHsKICAgIHJldHVybiBmdW5jdGlvbihhcnJheSwgZXhwcmVzc2lvbiwgY29tcGFyYXRvcikgewogICAgICBpZiAoIWlzQXJyYXkoYXJyYXkpKSByZXR1cm4gYXJyYXk7CgogICAgICB2YXIgY29tcGFyYXRvclR5cGUgPSB0eXBlb2YoY29tcGFyYXRvciksCiAgICAgICAgcHJlZGljYXRlcyA9IFtdOwoKICAgICAgcHJlZGljYXRlcy5jaGVjayA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBwcmVkaWNhdGVzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZighcHJlZGljYXRlc1tqXSh2YWx1ZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfTsKCiAgICAgIGlmIChjb21wYXJhdG9yVHlwZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGlmIChjb21wYXJhdG9yVHlwZSA9PT0gJ2Jvb2xlYW4nICYmIGNvbXBhcmF0b3IpIHsKICAgICAgICAgIGNvbXBhcmF0b3IgPSBmdW5jdGlvbihvYmosIHRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuZXF1YWxzKG9iaiwgdGV4dCk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb21wYXJhdG9yID0gZnVuY3Rpb24ob2JqLCB0ZXh0KSB7CiAgICAgICAgICAgIGlmIChvYmogJiYgdGV4dCAmJiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgdGV4dCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBvYmpLZXkgaW4gb2JqKSB7CiAgICAgICAgICAgICAgICBpZiAob2JqS2V5LmNoYXJBdCgwKSAhPT0gJyQnICYmIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBvYmpLZXkpICYmCiAgICAgICAgICAgICAgICAgIGNvbXBhcmF0b3Iob2JqW29iaktleV0sIHRleHRbb2JqS2V5XSkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0ZXh0ID0gKCcnK3RleHQpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHJldHVybiAoJycrb2JqKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodGV4dCkgPiAtMTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgc2VhcmNoID0gZnVuY3Rpb24ob2JqLCB0ZXh0KXsKICAgICAgICBpZiAodHlwZW9mIHRleHQgPT0gJ3N0cmluZycgJiYgdGV4dC5jaGFyQXQoMCkgPT09ICchJykgewogICAgICAgICAgcmV0dXJuICFzZWFyY2gob2JqLCB0ZXh0LnN1YnN0cigxKSk7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAodHlwZW9mIG9iaikgewogICAgICAgICAgY2FzZSAiYm9vbGVhbiI6CiAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmF0b3Iob2JqLCB0ZXh0KTsKICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHRleHQpIHsKICAgICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmF0b3Iob2JqLCB0ZXh0KTsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgZm9yICggdmFyIG9iaktleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgICAgaWYgKG9iaktleS5jaGFyQXQoMCkgIT09ICckJyAmJiBzZWFyY2gob2JqW29iaktleV0sIHRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIGNhc2UgImFycmF5IjoKICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgb2JqLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKHNlYXJjaChvYmpbaV0sIHRleHQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfTsKICAgICAgc3dpdGNoICh0eXBlb2YgZXhwcmVzc2lvbikgewogICAgICAgIGNhc2UgImJvb2xlYW4iOgogICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgIC8vIFNldCB1cCBleHByZXNzaW9uIG9iamVjdCBhbmQgZmFsbCB0aHJvdWdoCiAgICAgICAgICBleHByZXNzaW9uID0geyQ6ZXhwcmVzc2lvbn07CiAgICAgICAgLy8ganNoaW50IC1XMDg2CiAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgIC8vIGpzaGludCArVzA4NgogICAgICAgICAgZm9yICh2YXIga2V5IGluIGV4cHJlc3Npb24pIHsKICAgICAgICAgICAgKGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGV4cHJlc3Npb25bcGF0aF0gPT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKICAgICAgICAgICAgICBwcmVkaWNhdGVzLnB1c2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzZWFyY2gocGF0aCA9PSAnJCcgPyB2YWx1ZSA6ICh2YWx1ZSAmJiB2YWx1ZVtwYXRoXSksIGV4cHJlc3Npb25bcGF0aF0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KShrZXkpOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnZnVuY3Rpb24nOgogICAgICAgICAgcHJlZGljYXRlcy5wdXNoKGV4cHJlc3Npb24pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfQogICAgICB2YXIgZmlsdGVyZWQgPSBbXTsKICAgICAgZm9yICggdmFyIGogPSAwOyBqIDwgYXJyYXkubGVuZ3RoOyBqKyspIHsKICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtqXTsKICAgICAgICBpZiAocHJlZGljYXRlcy5jaGVjayh2YWx1ZSkpIHsKICAgICAgICAgIGZpbHRlcmVkLnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZmlsdGVyZWQ7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGZpbHRlcgogICAqIEBuYW1lIGN1cnJlbmN5CiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEZvcm1hdHMgYSBudW1iZXIgYXMgYSBjdXJyZW5jeSAoaWUgJDEsMjM0LjU2KS4gV2hlbiBubyBjdXJyZW5jeSBzeW1ib2wgaXMgcHJvdmlkZWQsIGRlZmF1bHQKICAgKiBzeW1ib2wgZm9yIGN1cnJlbnQgbG9jYWxlIGlzIHVzZWQuCiAgICoKICAgKiBAcGFyYW0ge251bWJlcn0gYW1vdW50IElucHV0IHRvIGZpbHRlci4KICAgKiBAcGFyYW0ge3N0cmluZz19IHN5bWJvbCBDdXJyZW5jeSBzeW1ib2wgb3IgaWRlbnRpZmllciB0byBiZSBkaXNwbGF5ZWQuCiAgICogQHJldHVybnMge3N0cmluZ30gRm9ybWF0dGVkIG51bWJlci4KICAgKgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5hbW91bnQgPSAxMjM0LjU2OwogICAgICAgICB9CiAgIDwvc2NyaXB0PgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICA8aW5wdXQgdHlwZT0ibnVtYmVyIiBuZy1tb2RlbD0iYW1vdW50Ij4gPGJyPgogICBkZWZhdWx0IGN1cnJlbmN5IHN5bWJvbCAoJCk6IDxzcGFuIGlkPSJjdXJyZW5jeS1kZWZhdWx0Ij57e2Ftb3VudCB8IGN1cnJlbmN5fX08L3NwYW4+PGJyPgogICBjdXN0b20gY3VycmVuY3kgaWRlbnRpZmllciAoVVNEJCk6IDxzcGFuPnt7YW1vdW50IHwgY3VycmVuY3k6IlVTRCQifX08L3NwYW4+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGluaXQgd2l0aCAxMjM0LjU2JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdjdXJyZW5jeS1kZWZhdWx0JykpLmdldFRleHQoKSkudG9CZSgnJDEsMjM0LjU2Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2Ftb3VudCB8IGN1cnJlbmN5OiJVU0QkIicpKS5nZXRUZXh0KCkpLnRvQmUoJ1VTRCQxLDIzNC41NicpOwogICAgICAgfSk7CiAgIGl0KCdzaG91bGQgdXBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGlmIChicm93c2VyLnBhcmFtcy5icm93c2VyID09ICdzYWZhcmknKSB7CiAgICAgICAgICAgLy8gU2FmYXJpIGRvZXMgbm90IHVuZGVyc3RhbmQgdGhlIG1pbnVzIGtleS4gU2VlCiAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvcHJvdHJhY3Rvci9pc3N1ZXMvNDgxCiAgICAgICAgICAgcmV0dXJuOwogICAgICAgICB9CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2Ftb3VudCcpKS5jbGVhcigpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdhbW91bnQnKSkuc2VuZEtleXMoJy0xMjM0Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdjdXJyZW5jeS1kZWZhdWx0JykpLmdldFRleHQoKSkudG9CZSgnKCQxLDIzNC4wMCknKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygnYW1vdW50IHwgY3VycmVuY3k6IlVTRCQiJykpLmdldFRleHQoKSkudG9CZSgnKFVTRCQxLDIzNC4wMCknKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICBjdXJyZW5jeUZpbHRlci4kaW5qZWN0ID0gWyckbG9jYWxlJ107CiAgZnVuY3Rpb24gY3VycmVuY3lGaWx0ZXIoJGxvY2FsZSkgewogICAgdmFyIGZvcm1hdHMgPSAkbG9jYWxlLk5VTUJFUl9GT1JNQVRTOwogICAgcmV0dXJuIGZ1bmN0aW9uKGFtb3VudCwgY3VycmVuY3lTeW1ib2wpewogICAgICBpZiAoaXNVbmRlZmluZWQoY3VycmVuY3lTeW1ib2wpKSBjdXJyZW5jeVN5bWJvbCA9IGZvcm1hdHMuQ1VSUkVOQ1lfU1lNOwogICAgICByZXR1cm4gZm9ybWF0TnVtYmVyKGFtb3VudCwgZm9ybWF0cy5QQVRURVJOU1sxXSwgZm9ybWF0cy5HUk9VUF9TRVAsIGZvcm1hdHMuREVDSU1BTF9TRVAsIDIpLgogICAgICAgIHJlcGxhY2UoL1x1MDBBNC9nLCBjdXJyZW5jeVN5bWJvbCk7CiAgICB9OwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGZpbHRlcgogICAqIEBuYW1lIG51bWJlcgogICAqIEBraW5kIGZ1bmN0aW9uCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBGb3JtYXRzIGEgbnVtYmVyIGFzIHRleHQuCiAgICoKICAgKiBJZiB0aGUgaW5wdXQgaXMgbm90IGEgbnVtYmVyIGFuIGVtcHR5IHN0cmluZyBpcyByZXR1cm5lZC4KICAgKgogICAqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ30gbnVtYmVyIE51bWJlciB0byBmb3JtYXQuCiAgICogQHBhcmFtIHsobnVtYmVyfHN0cmluZyk9fSBmcmFjdGlvblNpemUgTnVtYmVyIG9mIGRlY2ltYWwgcGxhY2VzIHRvIHJvdW5kIHRoZSBudW1iZXIgdG8uCiAgICogSWYgdGhpcyBpcyBub3QgcHJvdmlkZWQgdGhlbiB0aGUgZnJhY3Rpb24gc2l6ZSBpcyBjb21wdXRlZCBmcm9tIHRoZSBjdXJyZW50IGxvY2FsZSdzIG51bWJlcgogICAqIGZvcm1hdHRpbmcgcGF0dGVybi4gSW4gdGhlIGNhc2Ugb2YgdGhlIGRlZmF1bHQgbG9jYWxlLCBpdCB3aWxsIGJlIDMuCiAgICogQHJldHVybnMge3N0cmluZ30gTnVtYmVyIHJvdW5kZWQgdG8gZGVjaW1hbFBsYWNlcyBhbmQgcGxhY2VzIGEg4oCcLOKAnSBhZnRlciBlYWNoIHRoaXJkIGRpZ2l0LgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS52YWwgPSAxMjM0LjU2Nzg5OwogICAgICAgICB9CiAgIDwvc2NyaXB0PgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICBFbnRlciBudW1iZXI6IDxpbnB1dCBuZy1tb2RlbD0ndmFsJz48YnI+CiAgIERlZmF1bHQgZm9ybWF0dGluZzogPHNwYW4gaWQ9J251bWJlci1kZWZhdWx0Jz57e3ZhbCB8IG51bWJlcn19PC9zcGFuPjxicj4KICAgTm8gZnJhY3Rpb25zOiA8c3Bhbj57e3ZhbCB8IG51bWJlcjowfX08L3NwYW4+PGJyPgogICBOZWdhdGl2ZSBudW1iZXI6IDxzcGFuPnt7LXZhbCB8IG51bWJlcjo0fX08L3NwYW4+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGZvcm1hdCBudW1iZXJzJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdudW1iZXItZGVmYXVsdCcpKS5nZXRUZXh0KCkpLnRvQmUoJzEsMjM0LjU2OCcpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd2YWwgfCBudW1iZXI6MCcpKS5nZXRUZXh0KCkpLnRvQmUoJzEsMjM1Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS5nZXRUZXh0KCkpLnRvQmUoJy0xLDIzNC41Njc5Jyk7CiAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgdXBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3ZhbCcpKS5jbGVhcigpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCd2YWwnKSkuc2VuZEtleXMoJzMzNzQuMzMzJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdudW1iZXItZGVmYXVsdCcpKS5nZXRUZXh0KCkpLnRvQmUoJzMsMzc0LjMzMycpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd2YWwgfCBudW1iZXI6MCcpKS5nZXRUZXh0KCkpLnRvQmUoJzMsMzc0Jyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJy12YWwgfCBudW1iZXI6NCcpKS5nZXRUZXh0KCkpLnRvQmUoJy0zLDM3NC4zMzMwJyk7CiAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KCgogIG51bWJlckZpbHRlci4kaW5qZWN0ID0gWyckbG9jYWxlJ107CiAgZnVuY3Rpb24gbnVtYmVyRmlsdGVyKCRsb2NhbGUpIHsKICAgIHZhciBmb3JtYXRzID0gJGxvY2FsZS5OVU1CRVJfRk9STUFUUzsKICAgIHJldHVybiBmdW5jdGlvbihudW1iZXIsIGZyYWN0aW9uU2l6ZSkgewogICAgICByZXR1cm4gZm9ybWF0TnVtYmVyKG51bWJlciwgZm9ybWF0cy5QQVRURVJOU1swXSwgZm9ybWF0cy5HUk9VUF9TRVAsIGZvcm1hdHMuREVDSU1BTF9TRVAsCiAgICAgICAgZnJhY3Rpb25TaXplKTsKICAgIH07CiAgfQoKICB2YXIgREVDSU1BTF9TRVAgPSAnLic7CiAgZnVuY3Rpb24gZm9ybWF0TnVtYmVyKG51bWJlciwgcGF0dGVybiwgZ3JvdXBTZXAsIGRlY2ltYWxTZXAsIGZyYWN0aW9uU2l6ZSkgewogICAgaWYgKG51bWJlciA9PSBudWxsIHx8ICFpc0Zpbml0ZShudW1iZXIpIHx8IGlzT2JqZWN0KG51bWJlcikpIHJldHVybiAnJzsKCiAgICB2YXIgaXNOZWdhdGl2ZSA9IG51bWJlciA8IDA7CiAgICBudW1iZXIgPSBNYXRoLmFicyhudW1iZXIpOwogICAgdmFyIG51bVN0ciA9IG51bWJlciArICcnLAogICAgICBmb3JtYXRlZFRleHQgPSAnJywKICAgICAgcGFydHMgPSBbXTsKCiAgICB2YXIgaGFzRXhwb25lbnQgPSBmYWxzZTsKICAgIGlmIChudW1TdHIuaW5kZXhPZignZScpICE9PSAtMSkgewogICAgICB2YXIgbWF0Y2ggPSBudW1TdHIubWF0Y2goLyhbXGRcLl0rKWUoLT8pKFxkKykvKTsKICAgICAgaWYgKG1hdGNoICYmIG1hdGNoWzJdID09ICctJyAmJiBtYXRjaFszXSA+IGZyYWN0aW9uU2l6ZSArIDEpIHsKICAgICAgICBudW1TdHIgPSAnMCc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9ybWF0ZWRUZXh0ID0gbnVtU3RyOwogICAgICAgIGhhc0V4cG9uZW50ID0gdHJ1ZTsKICAgICAgfQogICAgfQoKICAgIGlmICghaGFzRXhwb25lbnQpIHsKICAgICAgdmFyIGZyYWN0aW9uTGVuID0gKG51bVN0ci5zcGxpdChERUNJTUFMX1NFUClbMV0gfHwgJycpLmxlbmd0aDsKCiAgICAgIC8vIGRldGVybWluZSBmcmFjdGlvblNpemUgaWYgaXQgaXMgbm90IHNwZWNpZmllZAogICAgICBpZiAoaXNVbmRlZmluZWQoZnJhY3Rpb25TaXplKSkgewogICAgICAgIGZyYWN0aW9uU2l6ZSA9IE1hdGgubWluKE1hdGgubWF4KHBhdHRlcm4ubWluRnJhYywgZnJhY3Rpb25MZW4pLCBwYXR0ZXJuLm1heEZyYWMpOwogICAgICB9CgogICAgICB2YXIgcG93ID0gTWF0aC5wb3coMTAsIGZyYWN0aW9uU2l6ZSArIDEpOwogICAgICBudW1iZXIgPSBNYXRoLmZsb29yKG51bWJlciAqIHBvdyArIDUpIC8gcG93OwogICAgICB2YXIgZnJhY3Rpb24gPSAoJycgKyBudW1iZXIpLnNwbGl0KERFQ0lNQUxfU0VQKTsKICAgICAgdmFyIHdob2xlID0gZnJhY3Rpb25bMF07CiAgICAgIGZyYWN0aW9uID0gZnJhY3Rpb25bMV0gfHwgJyc7CgogICAgICB2YXIgaSwgcG9zID0gMCwKICAgICAgICBsZ3JvdXAgPSBwYXR0ZXJuLmxnU2l6ZSwKICAgICAgICBncm91cCA9IHBhdHRlcm4uZ1NpemU7CgogICAgICBpZiAod2hvbGUubGVuZ3RoID49IChsZ3JvdXAgKyBncm91cCkpIHsKICAgICAgICBwb3MgPSB3aG9sZS5sZW5ndGggLSBsZ3JvdXA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHBvczsgaSsrKSB7CiAgICAgICAgICBpZiAoKHBvcyAtIGkpJWdyb3VwID09PSAwICYmIGkgIT09IDApIHsKICAgICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IGdyb3VwU2VwOwogICAgICAgICAgfQogICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IHdob2xlLmNoYXJBdChpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IHBvczsgaSA8IHdob2xlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKCh3aG9sZS5sZW5ndGggLSBpKSVsZ3JvdXAgPT09IDAgJiYgaSAhPT0gMCkgewogICAgICAgICAgZm9ybWF0ZWRUZXh0ICs9IGdyb3VwU2VwOwogICAgICAgIH0KICAgICAgICBmb3JtYXRlZFRleHQgKz0gd2hvbGUuY2hhckF0KGkpOwogICAgICB9CgogICAgICAvLyBmb3JtYXQgZnJhY3Rpb24gcGFydC4KICAgICAgd2hpbGUoZnJhY3Rpb24ubGVuZ3RoIDwgZnJhY3Rpb25TaXplKSB7CiAgICAgICAgZnJhY3Rpb24gKz0gJzAnOwogICAgICB9CgogICAgICBpZiAoZnJhY3Rpb25TaXplICYmIGZyYWN0aW9uU2l6ZSAhPT0gIjAiKSBmb3JtYXRlZFRleHQgKz0gZGVjaW1hbFNlcCArIGZyYWN0aW9uLnN1YnN0cigwLCBmcmFjdGlvblNpemUpOwogICAgfSBlbHNlIHsKCiAgICAgIGlmIChmcmFjdGlvblNpemUgPiAwICYmIG51bWJlciA+IC0xICYmIG51bWJlciA8IDEpIHsKICAgICAgICBmb3JtYXRlZFRleHQgPSBudW1iZXIudG9GaXhlZChmcmFjdGlvblNpemUpOwogICAgICB9CiAgICB9CgogICAgcGFydHMucHVzaChpc05lZ2F0aXZlID8gcGF0dGVybi5uZWdQcmUgOiBwYXR0ZXJuLnBvc1ByZSk7CiAgICBwYXJ0cy5wdXNoKGZvcm1hdGVkVGV4dCk7CiAgICBwYXJ0cy5wdXNoKGlzTmVnYXRpdmUgPyBwYXR0ZXJuLm5lZ1N1ZiA6IHBhdHRlcm4ucG9zU3VmKTsKICAgIHJldHVybiBwYXJ0cy5qb2luKCcnKTsKICB9CgogIGZ1bmN0aW9uIHBhZE51bWJlcihudW0sIGRpZ2l0cywgdHJpbSkgewogICAgdmFyIG5lZyA9ICcnOwogICAgaWYgKG51bSA8IDApIHsKICAgICAgbmVnID0gICctJzsKICAgICAgbnVtID0gLW51bTsKICAgIH0KICAgIG51bSA9ICcnICsgbnVtOwogICAgd2hpbGUobnVtLmxlbmd0aCA8IGRpZ2l0cykgbnVtID0gJzAnICsgbnVtOwogICAgaWYgKHRyaW0pCiAgICAgIG51bSA9IG51bS5zdWJzdHIobnVtLmxlbmd0aCAtIGRpZ2l0cyk7CiAgICByZXR1cm4gbmVnICsgbnVtOwogIH0KCgogIGZ1bmN0aW9uIGRhdGVHZXR0ZXIobmFtZSwgc2l6ZSwgb2Zmc2V0LCB0cmltKSB7CiAgICBvZmZzZXQgPSBvZmZzZXQgfHwgMDsKICAgIHJldHVybiBmdW5jdGlvbihkYXRlKSB7CiAgICAgIHZhciB2YWx1ZSA9IGRhdGVbJ2dldCcgKyBuYW1lXSgpOwogICAgICBpZiAob2Zmc2V0ID4gMCB8fCB2YWx1ZSA+IC1vZmZzZXQpCiAgICAgICAgdmFsdWUgKz0gb2Zmc2V0OwogICAgICBpZiAodmFsdWUgPT09IDAgJiYgb2Zmc2V0ID09IC0xMiApIHZhbHVlID0gMTI7CiAgICAgIHJldHVybiBwYWROdW1iZXIodmFsdWUsIHNpemUsIHRyaW0pOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGRhdGVTdHJHZXR0ZXIobmFtZSwgc2hvcnRGb3JtKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oZGF0ZSwgZm9ybWF0cykgewogICAgICB2YXIgdmFsdWUgPSBkYXRlWydnZXQnICsgbmFtZV0oKTsKICAgICAgdmFyIGdldCA9IHVwcGVyY2FzZShzaG9ydEZvcm0gPyAoJ1NIT1JUJyArIG5hbWUpIDogbmFtZSk7CgogICAgICByZXR1cm4gZm9ybWF0c1tnZXRdW3ZhbHVlXTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiB0aW1lWm9uZUdldHRlcihkYXRlKSB7CiAgICB2YXIgem9uZSA9IC0xICogZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpOwogICAgdmFyIHBhZGRlZFpvbmUgPSAoem9uZSA+PSAwKSA/ICIrIiA6ICIiOwoKICAgIHBhZGRlZFpvbmUgKz0gcGFkTnVtYmVyKE1hdGhbem9uZSA+IDAgPyAnZmxvb3InIDogJ2NlaWwnXSh6b25lIC8gNjApLCAyKSArCiAgICAgIHBhZE51bWJlcihNYXRoLmFicyh6b25lICUgNjApLCAyKTsKCiAgICByZXR1cm4gcGFkZGVkWm9uZTsKICB9CgogIGZ1bmN0aW9uIGFtcG1HZXR0ZXIoZGF0ZSwgZm9ybWF0cykgewogICAgcmV0dXJuIGRhdGUuZ2V0SG91cnMoKSA8IDEyID8gZm9ybWF0cy5BTVBNU1swXSA6IGZvcm1hdHMuQU1QTVNbMV07CiAgfQoKICB2YXIgREFURV9GT1JNQVRTID0gewogICAgeXl5eTogZGF0ZUdldHRlcignRnVsbFllYXInLCA0KSwKICAgIHl5OiBkYXRlR2V0dGVyKCdGdWxsWWVhcicsIDIsIDAsIHRydWUpLAogICAgeTogZGF0ZUdldHRlcignRnVsbFllYXInLCAxKSwKICAgIE1NTU06IGRhdGVTdHJHZXR0ZXIoJ01vbnRoJyksCiAgICBNTU06IGRhdGVTdHJHZXR0ZXIoJ01vbnRoJywgdHJ1ZSksCiAgICBNTTogZGF0ZUdldHRlcignTW9udGgnLCAyLCAxKSwKICAgIE06IGRhdGVHZXR0ZXIoJ01vbnRoJywgMSwgMSksCiAgICBkZDogZGF0ZUdldHRlcignRGF0ZScsIDIpLAogICAgZDogZGF0ZUdldHRlcignRGF0ZScsIDEpLAogICAgSEg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMiksCiAgICBIOiBkYXRlR2V0dGVyKCdIb3VycycsIDEpLAogICAgaGg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMiwgLTEyKSwKICAgIGg6IGRhdGVHZXR0ZXIoJ0hvdXJzJywgMSwgLTEyKSwKICAgIG1tOiBkYXRlR2V0dGVyKCdNaW51dGVzJywgMiksCiAgICBtOiBkYXRlR2V0dGVyKCdNaW51dGVzJywgMSksCiAgICBzczogZGF0ZUdldHRlcignU2Vjb25kcycsIDIpLAogICAgczogZGF0ZUdldHRlcignU2Vjb25kcycsIDEpLAogICAgLy8gd2hpbGUgSVNPIDg2MDEgcmVxdWlyZXMgZnJhY3Rpb25zIHRvIGJlIHByZWZpeGVkIHdpdGggYC5gIG9yIGAsYAogICAgLy8gd2UgY2FuIGJlIGp1c3Qgc2FmZWx5IHJlbHkgb24gdXNpbmcgYHNzc2Agc2luY2Ugd2UgY3VycmVudGx5IGRvbid0IHN1cHBvcnQgc2luZ2xlIG9yIHR3byBkaWdpdCBmcmFjdGlvbnMKICAgIHNzczogZGF0ZUdldHRlcignTWlsbGlzZWNvbmRzJywgMyksCiAgICBFRUVFOiBkYXRlU3RyR2V0dGVyKCdEYXknKSwKICAgIEVFRTogZGF0ZVN0ckdldHRlcignRGF5JywgdHJ1ZSksCiAgICBhOiBhbXBtR2V0dGVyLAogICAgWjogdGltZVpvbmVHZXR0ZXIKICB9OwoKICB2YXIgREFURV9GT1JNQVRTX1NQTElUID0gLygoPzpbXnlNZEhobXNhWkUnXSspfCg/OicoPzpbXiddfCcnKSonKXwoPzpFK3x5K3xNK3xkK3xIK3xoK3xtK3xzK3xhfFopKSguKikvLAogICAgTlVNQkVSX1NUUklORyA9IC9eXC0/XGQrJC87CgogIC8qKgogICAqIEBuZ2RvYyBmaWx0ZXIKICAgKiBAbmFtZSBkYXRlCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqICAgRm9ybWF0cyBgZGF0ZWAgdG8gYSBzdHJpbmcgYmFzZWQgb24gdGhlIHJlcXVlc3RlZCBgZm9ybWF0YC4KICAgKgogICAqICAgYGZvcm1hdGAgc3RyaW5nIGNhbiBiZSBjb21wb3NlZCBvZiB0aGUgZm9sbG93aW5nIGVsZW1lbnRzOgogICAqCiAgICogICAqIGAneXl5eSdgOiA0IGRpZ2l0IHJlcHJlc2VudGF0aW9uIG9mIHllYXIgKGUuZy4gQUQgMSA9PiAwMDAxLCBBRCAyMDEwID0+IDIwMTApCiAgICogICAqIGAneXknYDogMiBkaWdpdCByZXByZXNlbnRhdGlvbiBvZiB5ZWFyLCBwYWRkZWQgKDAwLTk5KS4gKGUuZy4gQUQgMjAwMSA9PiAwMSwgQUQgMjAxMCA9PiAxMCkKICAgKiAgICogYCd5J2A6IDEgZGlnaXQgcmVwcmVzZW50YXRpb24gb2YgeWVhciwgZS5nLiAoQUQgMSA9PiAxLCBBRCAxOTkgPT4gMTk5KQogICAqICAgKiBgJ01NTU0nYDogTW9udGggaW4geWVhciAoSmFudWFyeS1EZWNlbWJlcikKICAgKiAgICogYCdNTU0nYDogTW9udGggaW4geWVhciAoSmFuLURlYykKICAgKiAgICogYCdNTSdgOiBNb250aCBpbiB5ZWFyLCBwYWRkZWQgKDAxLTEyKQogICAqICAgKiBgJ00nYDogTW9udGggaW4geWVhciAoMS0xMikKICAgKiAgICogYCdkZCdgOiBEYXkgaW4gbW9udGgsIHBhZGRlZCAoMDEtMzEpCiAgICogICAqIGAnZCdgOiBEYXkgaW4gbW9udGggKDEtMzEpCiAgICogICAqIGAnRUVFRSdgOiBEYXkgaW4gV2VlaywoU3VuZGF5LVNhdHVyZGF5KQogICAqICAgKiBgJ0VFRSdgOiBEYXkgaW4gV2VlaywgKFN1bi1TYXQpCiAgICogICAqIGAnSEgnYDogSG91ciBpbiBkYXksIHBhZGRlZCAoMDAtMjMpCiAgICogICAqIGAnSCdgOiBIb3VyIGluIGRheSAoMC0yMykKICAgKiAgICogYCdoaCdgOiBIb3VyIGluIGFtL3BtLCBwYWRkZWQgKDAxLTEyKQogICAqICAgKiBgJ2gnYDogSG91ciBpbiBhbS9wbSwgKDEtMTIpCiAgICogICAqIGAnbW0nYDogTWludXRlIGluIGhvdXIsIHBhZGRlZCAoMDAtNTkpCiAgICogICAqIGAnbSdgOiBNaW51dGUgaW4gaG91ciAoMC01OSkKICAgKiAgICogYCdzcydgOiBTZWNvbmQgaW4gbWludXRlLCBwYWRkZWQgKDAwLTU5KQogICAqICAgKiBgJ3MnYDogU2Vjb25kIGluIG1pbnV0ZSAoMC01OSkKICAgKiAgICogYCcuc3NzJyBvciAnLHNzcydgOiBNaWxsaXNlY29uZCBpbiBzZWNvbmQsIHBhZGRlZCAoMDAwLTk5OSkKICAgKiAgICogYCdhJ2A6IGFtL3BtIG1hcmtlcgogICAqICAgKiBgJ1onYDogNCBkaWdpdCAoK3NpZ24pIHJlcHJlc2VudGF0aW9uIG9mIHRoZSB0aW1lem9uZSBvZmZzZXQgKC0xMjAwLSsxMjAwKQogICAqCiAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGFsc28gYmUgb25lIG9mIHRoZSBmb2xsb3dpbmcgcHJlZGVmaW5lZAogICAqICAge0BsaW5rIGd1aWRlL2kxOG4gbG9jYWxpemFibGUgZm9ybWF0c306CiAgICoKICAgKiAgICogYCdtZWRpdW0nYDogZXF1aXZhbGVudCB0byBgJ01NTSBkLCB5IGg6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUKICAgKiAgICAgKGUuZy4gU2VwIDMsIDIwMTAgMTI6MDU6MDggcG0pCiAgICogICAqIGAnc2hvcnQnYDogZXF1aXZhbGVudCB0byBgJ00vZC95eSBoOm1tIGEnYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiA5LzMvMTAgMTI6MDUgcG0pCiAgICogICAqIGAnZnVsbERhdGUnYDogZXF1aXZhbGVudCB0byBgJ0VFRUUsIE1NTU0gZCx5J2AgZm9yIGVuX1VTICBsb2NhbGUKICAgKiAgICAgKGUuZy4gRnJpZGF5LCBTZXB0ZW1iZXIgMywgMjAxMCkKICAgKiAgICogYCdsb25nRGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnTU1NTSBkLCB5J2AgZm9yIGVuX1VTICBsb2NhbGUgKGUuZy4gU2VwdGVtYmVyIDMsIDIwMTApCiAgICogICAqIGAnbWVkaXVtRGF0ZSdgOiBlcXVpdmFsZW50IHRvIGAnTU1NIGQsIHknYCBmb3IgZW5fVVMgIGxvY2FsZSAoZS5nLiBTZXAgMywgMjAxMCkKICAgKiAgICogYCdzaG9ydERhdGUnYDogZXF1aXZhbGVudCB0byBgJ00vZC95eSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gOS8zLzEwKQogICAqICAgKiBgJ21lZGl1bVRpbWUnYDogZXF1aXZhbGVudCB0byBgJ2g6bW06c3MgYSdgIGZvciBlbl9VUyBsb2NhbGUgKGUuZy4gMTI6MDU6MDggcG0pCiAgICogICAqIGAnc2hvcnRUaW1lJ2A6IGVxdWl2YWxlbnQgdG8gYCdoOm1tIGEnYCBmb3IgZW5fVVMgbG9jYWxlIChlLmcuIDEyOjA1IHBtKQogICAqCiAgICogICBgZm9ybWF0YCBzdHJpbmcgY2FuIGNvbnRhaW4gbGl0ZXJhbCB2YWx1ZXMuIFRoZXNlIG5lZWQgdG8gYmUgcXVvdGVkIHdpdGggc2luZ2xlIHF1b3RlcyAoZS5nLgogICAqICAgYCJoICdpbiB0aGUgbW9ybmluZyciYCkuIEluIG9yZGVyIHRvIG91dHB1dCBzaW5nbGUgcXVvdGUsIHVzZSB0d28gc2luZ2xlIHF1b3RlcyBpbiBhIHNlcXVlbmNlCiAgICogICAoZS5nLiBgImggJ28nJ2Nsb2NrJyJgKS4KICAgKgogICAqIEBwYXJhbSB7KERhdGV8bnVtYmVyfHN0cmluZyl9IGRhdGUgRGF0ZSB0byBmb3JtYXQgZWl0aGVyIGFzIERhdGUgb2JqZWN0LCBtaWxsaXNlY29uZHMgKHN0cmluZyBvcgogICAqICAgIG51bWJlcikgb3IgdmFyaW91cyBJU08gODYwMSBkYXRldGltZSBzdHJpbmcgZm9ybWF0cyAoZS5nLiB5eXl5LU1NLWRkVEhIOm1tOnNzLlNTU1ogYW5kIGl0cwogICAqICAgIHNob3J0ZXIgdmVyc2lvbnMgbGlrZSB5eXl5LU1NLWRkVEhIOm1tWiwgeXl5eS1NTS1kZCBvciB5eXl5TU1kZFRISG1tc3NaKS4gSWYgbm8gdGltZXpvbmUgaXMKICAgKiAgICBzcGVjaWZpZWQgaW4gdGhlIHN0cmluZyBpbnB1dCwgdGhlIHRpbWUgaXMgY29uc2lkZXJlZCB0byBiZSBpbiB0aGUgbG9jYWwgdGltZXpvbmUuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBmb3JtYXQgRm9ybWF0dGluZyBydWxlcyAoc2VlIERlc2NyaXB0aW9uKS4gSWYgbm90IHNwZWNpZmllZCwKICAgKiAgICBgbWVkaXVtRGF0ZWAgaXMgdXNlZC4KICAgKiBAcmV0dXJucyB7c3RyaW5nfSBGb3JtYXR0ZWQgc3RyaW5nIG9yIHRoZSBpbnB1dCBpZiBpbnB1dCBpcyBub3QgcmVjb2duaXplZCBhcyBkYXRlL21pbGxpcy4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSd9fTwvc3Bhbj46CiAgIDxzcGFuPnt7MTI4ODMyMzYyMzAwNiB8IGRhdGU6J21lZGl1bSd9fTwvc3Bhbj48YnI+CiAgIDxzcGFuIG5nLW5vbi1iaW5kYWJsZT57ezEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonfX08L3NwYW4+OgogICA8c3Bhbj57ezEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonfX08L3NwYW4+PGJyPgogICA8c3BhbiBuZy1ub24tYmluZGFibGU+e3sxMjg4MzIzNjIzMDA2IHwgZGF0ZTonTU0vZGQveXl5eSBAIGg6bW1hJ319PC9zcGFuPjoKICAgPHNwYW4+e3snMTI4ODMyMzYyMzAwNicgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnfX08L3NwYW4+PGJyPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGZvcm1hdCBkYXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoIjEyODgzMjM2MjMwMDYgfCBkYXRlOidtZWRpdW0nIikpLmdldFRleHQoKSkuCiAgICAgICAgICAgIHRvTWF0Y2goL09jdCAyXGQsIDIwMTAgXGR7MSwyfTpcZHsyfTpcZHsyfSAoQU18UE0pLyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoIjEyODgzMjM2MjMwMDYgfCBkYXRlOid5eXl5LU1NLWRkIEhIOm1tOnNzIFonIikpLmdldFRleHQoKSkuCiAgICAgICAgICAgIHRvTWF0Y2goLzIwMTBcLTEwXC0yXGQgXGR7Mn06XGR7Mn06XGR7Mn0gKFwtfFwrKT9cZHs0fS8pOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCInMTI4ODMyMzYyMzAwNicgfCBkYXRlOidNTS9kZC95eXl5IEAgaDptbWEnIikpLmdldFRleHQoKSkuCiAgIHRvTWF0Y2goLzEwXC8yXGRcLzIwMTAgQCBcZHsxLDJ9OlxkezJ9KEFNfFBNKS8pOwogICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgZGF0ZUZpbHRlci4kaW5qZWN0ID0gWyckbG9jYWxlJ107CiAgZnVuY3Rpb24gZGF0ZUZpbHRlcigkbG9jYWxlKSB7CgoKICAgIHZhciBSX0lTTzg2MDFfU1RSID0gL14oXGR7NH0pLT8oXGRcZCktPyhcZFxkKSg/OlQoXGRcZCkoPzo6PyhcZFxkKSg/Ojo/KFxkXGQpKD86XC4oXGQrKSk/KT8pPyhafChbKy1dKShcZFxkKTo/KFxkXGQpKT8pPyQvOwogICAgLy8gMSAgICAgICAgMiAgICAgICAzICAgICAgICAgNCAgICAgICAgICA1ICAgICAgICAgIDYgICAgICAgICAgNyAgICAgICAgICA4ICA5ICAgICAxMCAgICAgIDExCiAgICBmdW5jdGlvbiBqc29uU3RyaW5nVG9EYXRlKHN0cmluZykgewogICAgICB2YXIgbWF0Y2g7CiAgICAgIGlmIChtYXRjaCA9IHN0cmluZy5tYXRjaChSX0lTTzg2MDFfU1RSKSkgewogICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoMCksCiAgICAgICAgICB0ekhvdXIgPSAwLAogICAgICAgICAgdHpNaW4gID0gMCwKICAgICAgICAgIGRhdGVTZXR0ZXIgPSBtYXRjaFs4XSA/IGRhdGUuc2V0VVRDRnVsbFllYXIgOiBkYXRlLnNldEZ1bGxZZWFyLAogICAgICAgICAgdGltZVNldHRlciA9IG1hdGNoWzhdID8gZGF0ZS5zZXRVVENIb3VycyA6IGRhdGUuc2V0SG91cnM7CgogICAgICAgIGlmIChtYXRjaFs5XSkgewogICAgICAgICAgdHpIb3VyID0gaW50KG1hdGNoWzldICsgbWF0Y2hbMTBdKTsKICAgICAgICAgIHR6TWluID0gaW50KG1hdGNoWzldICsgbWF0Y2hbMTFdKTsKICAgICAgICB9CiAgICAgICAgZGF0ZVNldHRlci5jYWxsKGRhdGUsIGludChtYXRjaFsxXSksIGludChtYXRjaFsyXSkgLSAxLCBpbnQobWF0Y2hbM10pKTsKICAgICAgICB2YXIgaCA9IGludChtYXRjaFs0XXx8MCkgLSB0ekhvdXI7CiAgICAgICAgdmFyIG0gPSBpbnQobWF0Y2hbNV18fDApIC0gdHpNaW47CiAgICAgICAgdmFyIHMgPSBpbnQobWF0Y2hbNl18fDApOwogICAgICAgIHZhciBtcyA9IE1hdGgucm91bmQocGFyc2VGbG9hdCgnMC4nICsgKG1hdGNoWzddfHwwKSkgKiAxMDAwKTsKICAgICAgICB0aW1lU2V0dGVyLmNhbGwoZGF0ZSwgaCwgbSwgcywgbXMpOwogICAgICAgIHJldHVybiBkYXRlOwogICAgICB9CiAgICAgIHJldHVybiBzdHJpbmc7CiAgICB9CgoKICAgIHJldHVybiBmdW5jdGlvbihkYXRlLCBmb3JtYXQpIHsKICAgICAgdmFyIHRleHQgPSAnJywKICAgICAgICBwYXJ0cyA9IFtdLAogICAgICAgIGZuLCBtYXRjaDsKCiAgICAgIGZvcm1hdCA9IGZvcm1hdCB8fCAnbWVkaXVtRGF0ZSc7CiAgICAgIGZvcm1hdCA9ICRsb2NhbGUuREFURVRJTUVfRk9STUFUU1tmb3JtYXRdIHx8IGZvcm1hdDsKICAgICAgaWYgKGlzU3RyaW5nKGRhdGUpKSB7CiAgICAgICAgaWYgKE5VTUJFUl9TVFJJTkcudGVzdChkYXRlKSkgewogICAgICAgICAgZGF0ZSA9IGludChkYXRlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGF0ZSA9IGpzb25TdHJpbmdUb0RhdGUoZGF0ZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNOdW1iZXIoZGF0ZSkpIHsKICAgICAgICBkYXRlID0gbmV3IERhdGUoZGF0ZSk7CiAgICAgIH0KCiAgICAgIGlmICghaXNEYXRlKGRhdGUpKSB7CiAgICAgICAgcmV0dXJuIGRhdGU7CiAgICAgIH0KCiAgICAgIHdoaWxlKGZvcm1hdCkgewogICAgICAgIG1hdGNoID0gREFURV9GT1JNQVRTX1NQTElULmV4ZWMoZm9ybWF0KTsKICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgIHBhcnRzID0gY29uY2F0KHBhcnRzLCBtYXRjaCwgMSk7CiAgICAgICAgICBmb3JtYXQgPSBwYXJ0cy5wb3AoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGFydHMucHVzaChmb3JtYXQpOwogICAgICAgICAgZm9ybWF0ID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvckVhY2gocGFydHMsIGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICBmbiA9IERBVEVfRk9STUFUU1t2YWx1ZV07CiAgICAgICAgdGV4dCArPSBmbiA/IGZuKGRhdGUsICRsb2NhbGUuREFURVRJTUVfRk9STUFUUykKICAgICAgICAgIDogdmFsdWUucmVwbGFjZSgvKF4nfCckKS9nLCAnJykucmVwbGFjZSgvJycvZywgIiciKTsKICAgICAgfSk7CgogICAgICByZXR1cm4gdGV4dDsKICAgIH07CiAgfQoKCiAgLyoqCiAgICogQG5nZG9jIGZpbHRlcgogICAqIEBuYW1lIGpzb24KICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogICBBbGxvd3MgeW91IHRvIGNvbnZlcnQgYSBKYXZhU2NyaXB0IG9iamVjdCBpbnRvIEpTT04gc3RyaW5nLgogICAqCiAgICogICBUaGlzIGZpbHRlciBpcyBtb3N0bHkgdXNlZnVsIGZvciBkZWJ1Z2dpbmcuIFdoZW4gdXNpbmcgdGhlIGRvdWJsZSBjdXJseSB7e3ZhbHVlfX0gbm90YXRpb24KICAgKiAgIHRoZSBiaW5kaW5nIGlzIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIEpTT04uCiAgICoKICAgKiBAcGFyYW0geyp9IG9iamVjdCBBbnkgSmF2YVNjcmlwdCBvYmplY3QgKGluY2x1ZGluZyBhcnJheXMgYW5kIHByaW1pdGl2ZSB0eXBlcykgdG8gZmlsdGVyLgogICAqIEByZXR1cm5zIHtzdHJpbmd9IEpTT04gc3RyaW5nLgogICAqCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxwcmU+e3sgeyduYW1lJzondmFsdWUnfSB8IGpzb24gfX08L3ByZT4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBqc29uaWZ5IGZpbHRlcmVkIG9iamVjdHMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygieyduYW1lJzondmFsdWUnfSIpKS5nZXRUZXh0KCkpLnRvTWF0Y2goL1x7XG4gICJuYW1lIjogPyJ2YWx1ZSJcbn0vKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKgogICAqLwogIGZ1bmN0aW9uIGpzb25GaWx0ZXIoKSB7CiAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgIHJldHVybiB0b0pzb24ob2JqZWN0LCB0cnVlKTsKICAgIH07CiAgfQoKCiAgLyoqCiAgICogQG5nZG9jIGZpbHRlcgogICAqIEBuYW1lIGxvd2VyY2FzZQogICAqIEBraW5kIGZ1bmN0aW9uCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ29udmVydHMgc3RyaW5nIHRvIGxvd2VyY2FzZS4KICAgKiBAc2VlIGFuZ3VsYXIubG93ZXJjYXNlCiAgICovCiAgdmFyIGxvd2VyY2FzZUZpbHRlciA9IHZhbHVlRm4obG93ZXJjYXNlKTsKCgogIC8qKgogICAqIEBuZ2RvYyBmaWx0ZXIKICAgKiBAbmFtZSB1cHBlcmNhc2UKICAgKiBAa2luZCBmdW5jdGlvbgogICAqIEBkZXNjcmlwdGlvbgogICAqIENvbnZlcnRzIHN0cmluZyB0byB1cHBlcmNhc2UuCiAgICogQHNlZSBhbmd1bGFyLnVwcGVyY2FzZQogICAqLwogIHZhciB1cHBlcmNhc2VGaWx0ZXIgPSB2YWx1ZUZuKHVwcGVyY2FzZSk7CgogIC8qKgogICAqIEBuZ2RvYyBmaWx0ZXIKICAgKiBAbmFtZSBsaW1pdFRvCiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSBuZXcgYXJyYXkgb3Igc3RyaW5nIGNvbnRhaW5pbmcgb25seSBhIHNwZWNpZmllZCBudW1iZXIgb2YgZWxlbWVudHMuIFRoZSBlbGVtZW50cwogICAqIGFyZSB0YWtlbiBmcm9tIGVpdGhlciB0aGUgYmVnaW5uaW5nIG9yIHRoZSBlbmQgb2YgdGhlIHNvdXJjZSBhcnJheSBvciBzdHJpbmcsIGFzIHNwZWNpZmllZCBieQogICAqIHRoZSB2YWx1ZSBhbmQgc2lnbiAocG9zaXRpdmUgb3IgbmVnYXRpdmUpIG9mIGBsaW1pdGAuCiAgICoKICAgKiBAcGFyYW0ge0FycmF5fHN0cmluZ30gaW5wdXQgU291cmNlIGFycmF5IG9yIHN0cmluZyB0byBiZSBsaW1pdGVkLgogICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gbGltaXQgVGhlIGxlbmd0aCBvZiB0aGUgcmV0dXJuZWQgYXJyYXkgb3Igc3RyaW5nLiBJZiB0aGUgYGxpbWl0YCBudW1iZXIKICAgKiAgICAgaXMgcG9zaXRpdmUsIGBsaW1pdGAgbnVtYmVyIG9mIGl0ZW1zIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgc291cmNlIGFycmF5L3N0cmluZyBhcmUgY29waWVkLgogICAqICAgICBJZiB0aGUgbnVtYmVyIGlzIG5lZ2F0aXZlLCBgbGltaXRgIG51bWJlciAgb2YgaXRlbXMgZnJvbSB0aGUgZW5kIG9mIHRoZSBzb3VyY2UgYXJyYXkvc3RyaW5nCiAgICogICAgIGFyZSBjb3BpZWQuIFRoZSBgbGltaXRgIHdpbGwgYmUgdHJpbW1lZCBpZiBpdCBleGNlZWRzIGBhcnJheS5sZW5ndGhgCiAgICogQHJldHVybnMge0FycmF5fHN0cmluZ30gQSBuZXcgc3ViLWFycmF5IG9yIHN1YnN0cmluZyBvZiBsZW5ndGggYGxpbWl0YCBvciBsZXNzIGlmIGlucHV0IGFycmF5CiAgICogICAgIGhhZCBsZXNzIHRoYW4gYGxpbWl0YCBlbGVtZW50cy4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubnVtYmVycyA9IFsxLDIsMyw0LDUsNiw3LDgsOV07CiAgICAgICAgICAgJHNjb3BlLmxldHRlcnMgPSAiYWJjZGVmZ2hpIjsKICAgICAgICAgICAkc2NvcGUubnVtTGltaXQgPSAzOwogICAgICAgICAgICRzY29wZS5sZXR0ZXJMaW1pdCA9IDM7CiAgICAgICAgIH0KICAgPC9zY3JpcHQ+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIExpbWl0IHt7bnVtYmVyc319IHRvOiA8aW5wdXQgdHlwZT0iaW50ZWdlciIgbmctbW9kZWw9Im51bUxpbWl0Ij4KICAgPHA+T3V0cHV0IG51bWJlcnM6IHt7IG51bWJlcnMgfCBsaW1pdFRvOm51bUxpbWl0IH19PC9wPgogICBMaW1pdCB7e2xldHRlcnN9fSB0bzogPGlucHV0IHR5cGU9ImludGVnZXIiIG5nLW1vZGVsPSJsZXR0ZXJMaW1pdCI+CiAgIDxwPk91dHB1dCBsZXR0ZXJzOiB7eyBsZXR0ZXJzIHwgbGltaXRUbzpsZXR0ZXJMaW1pdCB9fTwvcD4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIHZhciBudW1MaW1pdElucHV0ID0gZWxlbWVudChieS5tb2RlbCgnbnVtTGltaXQnKSk7CiAgIHZhciBsZXR0ZXJMaW1pdElucHV0ID0gZWxlbWVudChieS5tb2RlbCgnbGV0dGVyTGltaXQnKSk7CiAgIHZhciBsaW1pdGVkTnVtYmVycyA9IGVsZW1lbnQoYnkuYmluZGluZygnbnVtYmVycyB8IGxpbWl0VG86bnVtTGltaXQnKSk7CiAgIHZhciBsaW1pdGVkTGV0dGVycyA9IGVsZW1lbnQoYnkuYmluZGluZygnbGV0dGVycyB8IGxpbWl0VG86bGV0dGVyTGltaXQnKSk7CgogICBpdCgnc2hvdWxkIGxpbWl0IHRoZSBudW1iZXIgYXJyYXkgdG8gZmlyc3QgdGhyZWUgaXRlbXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KG51bUxpbWl0SW5wdXQuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0JlKCczJyk7CiAgICAgICAgIGV4cGVjdChsZXR0ZXJMaW1pdElucHV0LmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9CZSgnMycpOwogICAgICAgICBleHBlY3QobGltaXRlZE51bWJlcnMuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbnVtYmVyczogWzEsMiwzXScpOwogICAgICAgICBleHBlY3QobGltaXRlZExldHRlcnMuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbGV0dGVyczogYWJjJyk7CiAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgdXBkYXRlIHRoZSBvdXRwdXQgd2hlbiAtMyBpcyBlbnRlcmVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIG51bUxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgbnVtTGltaXRJbnB1dC5zZW5kS2V5cygnLTMnKTsKICAgICAgICAgbGV0dGVyTGltaXRJbnB1dC5jbGVhcigpOwogICAgICAgICBsZXR0ZXJMaW1pdElucHV0LnNlbmRLZXlzKCctMycpOwogICAgICAgICBleHBlY3QobGltaXRlZE51bWJlcnMuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbnVtYmVyczogWzcsOCw5XScpOwogICAgICAgICBleHBlY3QobGltaXRlZExldHRlcnMuZ2V0VGV4dCgpKS50b0VxdWFsKCdPdXRwdXQgbGV0dGVyczogZ2hpJyk7CiAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgbm90IGV4Y2VlZCB0aGUgbWF4aW11bSBzaXplIG9mIGlucHV0IGFycmF5JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIG51bUxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgbnVtTGltaXRJbnB1dC5zZW5kS2V5cygnMTAwJyk7CiAgICAgICAgIGxldHRlckxpbWl0SW5wdXQuY2xlYXIoKTsKICAgICAgICAgbGV0dGVyTGltaXRJbnB1dC5zZW5kS2V5cygnMTAwJyk7CiAgICAgICAgIGV4cGVjdChsaW1pdGVkTnVtYmVycy5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBudW1iZXJzOiBbMSwyLDMsNCw1LDYsNyw4LDldJyk7CiAgICAgICAgIGV4cGVjdChsaW1pdGVkTGV0dGVycy5nZXRUZXh0KCkpLnRvRXF1YWwoJ091dHB1dCBsZXR0ZXJzOiBhYmNkZWZnaGknKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICBmdW5jdGlvbiBsaW1pdFRvRmlsdGVyKCl7CiAgICByZXR1cm4gZnVuY3Rpb24oaW5wdXQsIGxpbWl0KSB7CiAgICAgIGlmICghaXNBcnJheShpbnB1dCkgJiYgIWlzU3RyaW5nKGlucHV0KSkgcmV0dXJuIGlucHV0OwoKICAgICAgaWYgKE1hdGguYWJzKE51bWJlcihsaW1pdCkpID09PSBJbmZpbml0eSkgewogICAgICAgIGxpbWl0ID0gTnVtYmVyKGxpbWl0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBsaW1pdCA9IGludChsaW1pdCk7CiAgICAgIH0KCiAgICAgIGlmIChpc1N0cmluZyhpbnB1dCkpIHsKICAgICAgICAvL05hTiBjaGVjayBvbiBsaW1pdAogICAgICAgIGlmIChsaW1pdCkgewogICAgICAgICAgcmV0dXJuIGxpbWl0ID49IDAgPyBpbnB1dC5zbGljZSgwLCBsaW1pdCkgOiBpbnB1dC5zbGljZShsaW1pdCwgaW5wdXQubGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIG91dCA9IFtdLAogICAgICAgIGksIG47CgogICAgICAvLyBpZiBhYnMobGltaXQpIGV4Y2VlZHMgbWF4aW11bSBsZW5ndGgsIHRyaW0gaXQKICAgICAgaWYgKGxpbWl0ID4gaW5wdXQubGVuZ3RoKQogICAgICAgIGxpbWl0ID0gaW5wdXQubGVuZ3RoOwogICAgICBlbHNlIGlmIChsaW1pdCA8IC1pbnB1dC5sZW5ndGgpCiAgICAgICAgbGltaXQgPSAtaW5wdXQubGVuZ3RoOwoKICAgICAgaWYgKGxpbWl0ID4gMCkgewogICAgICAgIGkgPSAwOwogICAgICAgIG4gPSBsaW1pdDsKICAgICAgfSBlbHNlIHsKICAgICAgICBpID0gaW5wdXQubGVuZ3RoICsgbGltaXQ7CiAgICAgICAgbiA9IGlucHV0Lmxlbmd0aDsKICAgICAgfQoKICAgICAgZm9yICg7IGk8bjsgaSsrKSB7CiAgICAgICAgb3V0LnB1c2goaW5wdXRbaV0pOwogICAgICB9CgogICAgICByZXR1cm4gb3V0OwogICAgfTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBmaWx0ZXIKICAgKiBAbmFtZSBvcmRlckJ5CiAgICogQGtpbmQgZnVuY3Rpb24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIE9yZGVycyBhIHNwZWNpZmllZCBgYXJyYXlgIGJ5IHRoZSBgZXhwcmVzc2lvbmAgcHJlZGljYXRlLiBJdCBpcyBvcmRlcmVkIGFscGhhYmV0aWNhbGx5CiAgICogZm9yIHN0cmluZ3MgYW5kIG51bWVyaWNhbGx5IGZvciBudW1iZXJzLiBOb3RlOiBpZiB5b3Ugbm90aWNlIG51bWJlcnMgYXJlIG5vdCBiZWluZyBzb3J0ZWQKICAgKiBjb3JyZWN0bHksIG1ha2Ugc3VyZSB0aGV5IGFyZSBhY3R1YWxseSBiZWluZyBzYXZlZCBhcyBudW1iZXJzIGFuZCBub3Qgc3RyaW5ncy4KICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzb3J0LgogICAqIEBwYXJhbSB7ZnVuY3Rpb24oKil8c3RyaW5nfEFycmF5LjwoZnVuY3Rpb24oKil8c3RyaW5nKT59IGV4cHJlc3Npb24gQSBwcmVkaWNhdGUgdG8gYmUKICAgKiAgICB1c2VkIGJ5IHRoZSBjb21wYXJhdG9yIHRvIGRldGVybWluZSB0aGUgb3JkZXIgb2YgZWxlbWVudHMuCiAgICoKICAgKiAgICBDYW4gYmUgb25lIG9mOgogICAqCiAgICogICAgLSBgZnVuY3Rpb25gOiBHZXR0ZXIgZnVuY3Rpb24uIFRoZSByZXN1bHQgb2YgdGhpcyBmdW5jdGlvbiB3aWxsIGJlIHNvcnRlZCB1c2luZyB0aGUKICAgKiAgICAgIGA8YCwgYD1gLCBgPmAgb3BlcmF0b3IuCiAgICogICAgLSBgc3RyaW5nYDogQW4gQW5ndWxhciBleHByZXNzaW9uIHdoaWNoIGV2YWx1YXRlcyB0byBhbiBvYmplY3QgdG8gb3JkZXIgYnksIHN1Y2ggYXMgJ25hbWUnCiAgICogICAgICB0byBzb3J0IGJ5IGEgcHJvcGVydHkgY2FsbGVkICduYW1lJy4gT3B0aW9uYWxseSBwcmVmaXhlZCB3aXRoIGArYCBvciBgLWAgdG8gY29udHJvbAogICAqICAgICAgYXNjZW5kaW5nIG9yIGRlc2NlbmRpbmcgc29ydCBvcmRlciAoZm9yIGV4YW1wbGUsICtuYW1lIG9yIC1uYW1lKS4KICAgKiAgICAtIGBBcnJheWA6IEFuIGFycmF5IG9mIGZ1bmN0aW9uIG9yIHN0cmluZyBwcmVkaWNhdGVzLiBUaGUgZmlyc3QgcHJlZGljYXRlIGluIHRoZSBhcnJheQogICAqICAgICAgaXMgdXNlZCBmb3Igc29ydGluZywgYnV0IHdoZW4gdHdvIGl0ZW1zIGFyZSBlcXVpdmFsZW50LCB0aGUgbmV4dCBwcmVkaWNhdGUgaXMgdXNlZC4KICAgKgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IHJldmVyc2UgUmV2ZXJzZSB0aGUgb3JkZXIgb2YgdGhlIGFycmF5LgogICAqIEByZXR1cm5zIHtBcnJheX0gU29ydGVkIGNvcHkgb2YgdGhlIHNvdXJjZSBhcnJheS4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUuZnJpZW5kcyA9CiAgICAgICAgICAgICAgIFt7bmFtZTonSm9obicsIHBob25lOic1NTUtMTIxMicsIGFnZToxMH0sCiAgICAgICAgICAgICAgICB7bmFtZTonTWFyeScsIHBob25lOic1NTUtOTg3NicsIGFnZToxOX0sCiAgICAgICAgICAgICAgICB7bmFtZTonTWlrZScsIHBob25lOic1NTUtNDMyMScsIGFnZToyMX0sCiAgICAgICAgICAgICAgICB7bmFtZTonQWRhbScsIHBob25lOic1NTUtNTY3OCcsIGFnZTozNX0sCiAgICAgICAgICAgICAgICB7bmFtZTonSnVsaWUnLCBwaG9uZTonNTU1LTg3NjUnLCBhZ2U6Mjl9XQogICAgICAgICAgICRzY29wZS5wcmVkaWNhdGUgPSAnLWFnZSc7CiAgICAgICAgIH0KICAgPC9zY3JpcHQ+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIDxwcmU+U29ydGluZyBwcmVkaWNhdGUgPSB7e3ByZWRpY2F0ZX19OyByZXZlcnNlID0ge3tyZXZlcnNlfX08L3ByZT4KICAgPGhyLz4KICAgWyA8YSBocmVmPSIiIG5nLWNsaWNrPSJwcmVkaWNhdGU9JyciPnVuc29ydGVkPC9hPiBdCiAgIDx0YWJsZSBjbGFzcz0iZnJpZW5kIj4KICAgPHRyPgogICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlID0gJ25hbWUnOyByZXZlcnNlPWZhbHNlIj5OYW1lPC9hPgogICAoPGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlID0gJy1uYW1lJzsgcmV2ZXJzZT1mYWxzZSI+XjwvYT4pPC90aD4KICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InByZWRpY2F0ZSA9ICdwaG9uZSc7IHJldmVyc2U9IXJldmVyc2UiPlBob25lIE51bWJlcjwvYT48L3RoPgogICA8dGg+PGEgaHJlZj0iIiBuZy1jbGljaz0icHJlZGljYXRlID0gJ2FnZSc7IHJldmVyc2U9IXJldmVyc2UiPkFnZTwvYT48L3RoPgogICA8L3RyPgogICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyB8IG9yZGVyQnk6cHJlZGljYXRlOnJldmVyc2UiPgogICA8dGQ+e3tmcmllbmQubmFtZX19PC90ZD4KICAgPHRkPnt7ZnJpZW5kLnBob25lfX08L3RkPgogICA8dGQ+e3tmcmllbmQuYWdlfX08L3RkPgogICA8L3RyPgogICA8L3RhYmxlPgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICoKICAgKiBJdCdzIGFsc28gcG9zc2libGUgdG8gY2FsbCB0aGUgb3JkZXJCeSBmaWx0ZXIgbWFudWFsbHksIGJ5IGluamVjdGluZyBgJGZpbHRlcmAsIHJldHJpZXZpbmcgdGhlCiAgICogZmlsdGVyIHJvdXRpbmUgd2l0aCBgJGZpbHRlcignb3JkZXJCeScpYCwgYW5kIGNhbGxpbmcgdGhlIHJldHVybmVkIGZpbHRlciByb3V0aW5lIHdpdGggdGhlCiAgICogZGVzaXJlZCBwYXJhbWV0ZXJzLgogICAqCiAgICogRXhhbXBsZToKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgPHRhYmxlIGNsYXNzPSJmcmllbmQiPgogICA8dHI+CiAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJyZXZlcnNlPWZhbHNlO29yZGVyKCduYW1lJywgZmFsc2UpIj5OYW1lPC9hPgogICAoPGEgaHJlZj0iIiBuZy1jbGljaz0ib3JkZXIoJy1uYW1lJyxmYWxzZSkiPl48L2E+KTwvdGg+CiAgIDx0aD48YSBocmVmPSIiIG5nLWNsaWNrPSJyZXZlcnNlPSFyZXZlcnNlO29yZGVyKCdwaG9uZScsIHJldmVyc2UpIj5QaG9uZSBOdW1iZXI8L2E+PC90aD4KICAgPHRoPjxhIGhyZWY9IiIgbmctY2xpY2s9InJldmVyc2U9IXJldmVyc2U7b3JkZXIoJ2FnZScscmV2ZXJzZSkiPkFnZTwvYT48L3RoPgogICA8L3RyPgogICA8dHIgbmctcmVwZWF0PSJmcmllbmQgaW4gZnJpZW5kcyI+CiAgIDx0ZD57e2ZyaWVuZC5uYW1lfX08L3RkPgogICA8dGQ+e3tmcmllbmQucGhvbmV9fTwvdGQ+CiAgIDx0ZD57e2ZyaWVuZC5hZ2V9fTwvdGQ+CiAgIDwvdHI+CiAgIDwvdGFibGU+CiAgIDwvZGl2PgogICA8L2ZpbGU+CgogICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSwgJGZpbHRlcikgewogICAgICAgIHZhciBvcmRlckJ5ID0gJGZpbHRlcignb3JkZXJCeScpOwogICAgICAgICRzY29wZS5mcmllbmRzID0gWwogICAgICAgICAgeyBuYW1lOiAnSm9obicsICAgIHBob25lOiAnNTU1LTEyMTInLCAgICBhZ2U6IDEwIH0sCiAgICAgICAgICB7IG5hbWU6ICdNYXJ5JywgICAgcGhvbmU6ICc1NTUtOTg3NicsICAgIGFnZTogMTkgfSwKICAgICAgICAgIHsgbmFtZTogJ01pa2UnLCAgICBwaG9uZTogJzU1NS00MzIxJywgICAgYWdlOiAyMSB9LAogICAgICAgICAgeyBuYW1lOiAnQWRhbScsICAgIHBob25lOiAnNTU1LTU2NzgnLCAgICBhZ2U6IDM1IH0sCiAgICAgICAgICB7IG5hbWU6ICdKdWxpZScsICAgcGhvbmU6ICc1NTUtODc2NScsICAgIGFnZTogMjkgfQogICAgICAgIF07CgogICAgICAgICRzY29wZS5vcmRlciA9IGZ1bmN0aW9uKHByZWRpY2F0ZSwgcmV2ZXJzZSkgewogICAgICAgICAgJHNjb3BlLmZyaWVuZHMgPSBvcmRlckJ5KCRzY29wZS5mcmllbmRzLCBwcmVkaWNhdGUsIHJldmVyc2UpOwogICAgICAgIH07CiAgICAgICAgJHNjb3BlLm9yZGVyKCctYWdlJyxmYWxzZSk7CiAgICAgIH0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgb3JkZXJCeUZpbHRlci4kaW5qZWN0ID0gWyckcGFyc2UnXTsKICBmdW5jdGlvbiBvcmRlckJ5RmlsdGVyKCRwYXJzZSl7CiAgICByZXR1cm4gZnVuY3Rpb24oYXJyYXksIHNvcnRQcmVkaWNhdGUsIHJldmVyc2VPcmRlcikgewogICAgICBpZiAoIWlzQXJyYXkoYXJyYXkpKSByZXR1cm4gYXJyYXk7CiAgICAgIGlmICghc29ydFByZWRpY2F0ZSkgcmV0dXJuIGFycmF5OwogICAgICBzb3J0UHJlZGljYXRlID0gaXNBcnJheShzb3J0UHJlZGljYXRlKSA/IHNvcnRQcmVkaWNhdGU6IFtzb3J0UHJlZGljYXRlXTsKICAgICAgc29ydFByZWRpY2F0ZSA9IG1hcChzb3J0UHJlZGljYXRlLCBmdW5jdGlvbihwcmVkaWNhdGUpewogICAgICAgIHZhciBkZXNjZW5kaW5nID0gZmFsc2UsIGdldCA9IHByZWRpY2F0ZSB8fCBpZGVudGl0eTsKICAgICAgICBpZiAoaXNTdHJpbmcocHJlZGljYXRlKSkgewogICAgICAgICAgaWYgKChwcmVkaWNhdGUuY2hhckF0KDApID09ICcrJyB8fCBwcmVkaWNhdGUuY2hhckF0KDApID09ICctJykpIHsKICAgICAgICAgICAgZGVzY2VuZGluZyA9IHByZWRpY2F0ZS5jaGFyQXQoMCkgPT0gJy0nOwogICAgICAgICAgICBwcmVkaWNhdGUgPSBwcmVkaWNhdGUuc3Vic3RyaW5nKDEpOwogICAgICAgICAgfQogICAgICAgICAgZ2V0ID0gJHBhcnNlKHByZWRpY2F0ZSk7CiAgICAgICAgICBpZiAoZ2V0LmNvbnN0YW50KSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBnZXQoKTsKICAgICAgICAgICAgcmV0dXJuIHJldmVyc2VDb21wYXJhdG9yKGZ1bmN0aW9uKGEsYikgewogICAgICAgICAgICAgIHJldHVybiBjb21wYXJlKGFba2V5XSwgYltrZXldKTsKICAgICAgICAgICAgfSwgZGVzY2VuZGluZyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXZlcnNlQ29tcGFyYXRvcihmdW5jdGlvbihhLGIpewogICAgICAgICAgcmV0dXJuIGNvbXBhcmUoZ2V0KGEpLGdldChiKSk7CiAgICAgICAgfSwgZGVzY2VuZGluZyk7CiAgICAgIH0pOwogICAgICB2YXIgYXJyYXlDb3B5ID0gW107CiAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7IGFycmF5Q29weS5wdXNoKGFycmF5W2ldKTsgfQogICAgICByZXR1cm4gYXJyYXlDb3B5LnNvcnQocmV2ZXJzZUNvbXBhcmF0b3IoY29tcGFyYXRvciwgcmV2ZXJzZU9yZGVyKSk7CgogICAgICBmdW5jdGlvbiBjb21wYXJhdG9yKG8xLCBvMil7CiAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgc29ydFByZWRpY2F0ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGNvbXAgPSBzb3J0UHJlZGljYXRlW2ldKG8xLCBvMik7CiAgICAgICAgICBpZiAoY29tcCAhPT0gMCkgcmV0dXJuIGNvbXA7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJldmVyc2VDb21wYXJhdG9yKGNvbXAsIGRlc2NlbmRpbmcpIHsKICAgICAgICByZXR1cm4gdG9Cb29sZWFuKGRlc2NlbmRpbmcpCiAgICAgICAgICA/IGZ1bmN0aW9uKGEsYil7cmV0dXJuIGNvbXAoYixhKTt9CiAgICAgICAgICA6IGNvbXA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY29tcGFyZSh2MSwgdjIpewogICAgICAgIHZhciB0MSA9IHR5cGVvZiB2MTsKICAgICAgICB2YXIgdDIgPSB0eXBlb2YgdjI7CiAgICAgICAgaWYgKHQxID09IHQyKSB7CiAgICAgICAgICBpZiAodDEgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdjEgPSB2MS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB2MiA9IHYyLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodjEgPT09IHYyKSByZXR1cm4gMDsKICAgICAgICAgIHJldHVybiB2MSA8IHYyID8gLTEgOiAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gdDEgPCB0MiA/IC0xIDogMTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBuZ0RpcmVjdGl2ZShkaXJlY3RpdmUpIHsKICAgIGlmIChpc0Z1bmN0aW9uKGRpcmVjdGl2ZSkpIHsKICAgICAgZGlyZWN0aXZlID0gewogICAgICAgIGxpbms6IGRpcmVjdGl2ZQogICAgICB9OwogICAgfQogICAgZGlyZWN0aXZlLnJlc3RyaWN0ID0gZGlyZWN0aXZlLnJlc3RyaWN0IHx8ICdBQyc7CiAgICByZXR1cm4gdmFsdWVGbihkaXJlY3RpdmUpOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGEKICAgKiBAcmVzdHJpY3QgRQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogTW9kaWZpZXMgdGhlIGRlZmF1bHQgYmVoYXZpb3Igb2YgdGhlIGh0bWwgQSB0YWcgc28gdGhhdCB0aGUgZGVmYXVsdCBhY3Rpb24gaXMgcHJldmVudGVkIHdoZW4KICAgKiB0aGUgaHJlZiBhdHRyaWJ1dGUgaXMgZW1wdHkuCiAgICoKICAgKiBUaGlzIGNoYW5nZSBwZXJtaXRzIHRoZSBlYXN5IGNyZWF0aW9uIG9mIGFjdGlvbiBsaW5rcyB3aXRoIHRoZSBgbmdDbGlja2AgZGlyZWN0aXZlCiAgICogd2l0aG91dCBjaGFuZ2luZyB0aGUgbG9jYXRpb24gb3IgY2F1c2luZyBwYWdlIHJlbG9hZHMsIGUuZy46CiAgICogYDxhIGhyZWY9IiIgbmctY2xpY2s9Imxpc3QuYWRkSXRlbSgpIj5BZGQgSXRlbTwvYT5gCiAgICovCiAgdmFyIGh0bWxBbmNob3JEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CgogICAgICBpZiAobXNpZSA8PSA4KSB7CgogICAgICAgIC8vIHR1cm4gPGEgaHJlZiBuZy1jbGljaz0iLi4iPmxpbms8L2E+IGludG8gYSBzdHlsYWJsZSBsaW5rIGluIElFCiAgICAgICAgLy8gYnV0IG9ubHkgaWYgaXQgZG9lc24ndCBoYXZlIG5hbWUgYXR0cmlidXRlLCBpbiB3aGljaCBjYXNlIGl0J3MgYW4gYW5jaG9yCiAgICAgICAgaWYgKCFhdHRyLmhyZWYgJiYgIWF0dHIubmFtZSkgewogICAgICAgICAgYXR0ci4kc2V0KCdocmVmJywgJycpOwogICAgICAgIH0KCiAgICAgICAgLy8gYWRkIGEgY29tbWVudCBub2RlIHRvIGFuY2hvcnMgdG8gd29ya2Fyb3VuZCBJRSBidWcgdGhhdCBjYXVzZXMgZWxlbWVudCBjb250ZW50IHRvIGJlIHJlc2V0CiAgICAgICAgLy8gdG8gbmV3IGF0dHJpYnV0ZSBjb250ZW50IGlmIGF0dHJpYnV0ZSBpcyB1cGRhdGVkIHdpdGggdmFsdWUgY29udGFpbmluZyBAIGFuZCBlbGVtZW50IGFsc28KICAgICAgICAvLyBjb250YWlucyB2YWx1ZSB3aXRoIEAKICAgICAgICAvLyBzZWUgaXNzdWUgIzE5NDkKICAgICAgICBlbGVtZW50LmFwcGVuZChkb2N1bWVudC5jcmVhdGVDb21tZW50KCdJRSBmaXgnKSk7CiAgICAgIH0KCiAgICAgIGlmICghYXR0ci5ocmVmICYmICFhdHRyLnhsaW5rSHJlZiAmJiAhYXR0ci5uYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50KSB7CiAgICAgICAgICAvLyBTVkdBRWxlbWVudCBkb2VzIG5vdCB1c2UgdGhlIGhyZWYgYXR0cmlidXRlLCBidXQgcmF0aGVyIHRoZSAneGxpbmtIcmVmJyBhdHRyaWJ1dGUuCiAgICAgICAgICB2YXIgaHJlZiA9IHRvU3RyaW5nLmNhbGwoZWxlbWVudC5wcm9wKCdocmVmJykpID09PSAnW29iamVjdCBTVkdBbmltYXRlZFN0cmluZ10nID8KICAgICAgICAgICAgJ3hsaW5rOmhyZWYnIDogJ2hyZWYnOwogICAgICAgICAgZWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbihldmVudCl7CiAgICAgICAgICAgIC8vIGlmIHdlIGhhdmUgbm8gaHJlZiB1cmwsIHRoZW4gZG9uJ3QgbmF2aWdhdGUgYW55d2hlcmUuCiAgICAgICAgICAgIGlmICghZWxlbWVudC5hdHRyKGhyZWYpKSB7CiAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgfQogICAgfQogIH0pOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdIcmVmCiAgICogQHJlc3RyaWN0IEEKICAgKiBAcHJpb3JpdHkgOTkKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFVzaW5nIEFuZ3VsYXIgbWFya3VwIGxpa2UgYHt7aGFzaH19YCBpbiBhbiBocmVmIGF0dHJpYnV0ZSB3aWxsCiAgICogbWFrZSB0aGUgbGluayBnbyB0byB0aGUgd3JvbmcgVVJMIGlmIHRoZSB1c2VyIGNsaWNrcyBpdCBiZWZvcmUKICAgKiBBbmd1bGFyIGhhcyBhIGNoYW5jZSB0byByZXBsYWNlIHRoZSBge3toYXNofX1gIG1hcmt1cCB3aXRoIGl0cwogICAqIHZhbHVlLiBVbnRpbCBBbmd1bGFyIHJlcGxhY2VzIHRoZSBtYXJrdXAgdGhlIGxpbmsgd2lsbCBiZSBicm9rZW4KICAgKiBhbmQgd2lsbCBtb3N0IGxpa2VseSByZXR1cm4gYSA0MDQgZXJyb3IuCiAgICoKICAgKiBUaGUgYG5nSHJlZmAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0uCiAgICoKICAgKiBUaGUgd3Jvbmcgd2F5IHRvIHdyaXRlIGl0OgogICAqIGBgYGh0bWwKICAgKiA8YSBocmVmPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgKiBgYGAKICAgKgogICAqIFRoZSBjb3JyZWN0IHdheSB0byB3cml0ZSBpdDoKICAgKiBgYGBodG1sCiAgICogPGEgbmctaHJlZj0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19Ii8+CiAgICogYGBgCiAgICoKICAgKiBAZWxlbWVudCBBCiAgICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdIcmVmIGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICAgKgogICAqIEBleGFtcGxlCiAgICogVGhpcyBleGFtcGxlIHNob3dzIHZhcmlvdXMgY29tYmluYXRpb25zIG9mIGBocmVmYCwgYG5nLWhyZWZgIGFuZCBgbmctY2xpY2tgIGF0dHJpYnV0ZXMKICAgKiBpbiBsaW5rcyBhbmQgdGhlaXIgZGlmZmVyZW50IGJlaGF2aW9yczoKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8aW5wdXQgbmctbW9kZWw9InZhbHVlIiAvPjxiciAvPgogICA8YSBpZD0ibGluay0xIiBocmVmIG5nLWNsaWNrPSJ2YWx1ZSA9IDEiPmxpbmsgMTwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgPGEgaWQ9ImxpbmstMiIgaHJlZj0iIiBuZy1jbGljaz0idmFsdWUgPSAyIj5saW5rIDI8L2E+IChsaW5rLCBkb24ndCByZWxvYWQpPGJyIC8+CiAgIDxhIGlkPSJsaW5rLTMiIG5nLWhyZWY9Ii97eycxMjMnfX0iPmxpbmsgMzwvYT4gKGxpbmssIHJlbG9hZCEpPGJyIC8+CiAgIDxhIGlkPSJsaW5rLTQiIGhyZWY9IiIgbmFtZT0ieHgiIG5nLWNsaWNrPSJ2YWx1ZSA9IDQiPmFuY2hvcjwvYT4gKGxpbmssIGRvbid0IHJlbG9hZCk8YnIgLz4KICAgPGEgaWQ9ImxpbmstNSIgbmFtZT0ieHh4IiBuZy1jbGljaz0idmFsdWUgPSA1Ij5hbmNob3I8L2E+IChubyBsaW5rKTxiciAvPgogICA8YSBpZD0ibGluay02IiBuZy1ocmVmPSJ7e3ZhbHVlfX0iPmxpbms8L2E+IChsaW5rLCBjaGFuZ2UgbG9jYXRpb24pCiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIGhyZWYgd2l0aG91dCB2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZWxlbWVudChieS5pZCgnbGluay0xJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0VxdWFsKCcxJyk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGluay0xJykpLmdldEF0dHJpYnV0ZSgnaHJlZicpKS50b0JlKCcnKTsKICAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgZXhlY3V0ZSBuZy1jbGljayBidXQgbm90IHJlbG9hZCB3aGVuIGhyZWYgZW1wdHkgc3RyaW5nJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTInKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvRXF1YWwoJzInKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTInKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvQmUoJycpOwogICAgICAgIH0pOwoKICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGFuZCBjaGFuZ2UgdXJsIHdoZW4gbmctaHJlZiBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTMnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvTWF0Y2goL1wvMTIzJC8pOwoKICAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ2xpbmstMycpKS5jbGljaygpOwoKICAgICAgICAgIC8vIEF0IHRoaXMgcG9pbnQsIHdlIG5hdmlnYXRlIGF3YXkgZnJvbSBhbiBBbmd1bGFyIHBhZ2UsIHNvIHdlIG5lZWQKICAgICAgICAgIC8vIHRvIHVzZSBicm93c2VyLmRyaXZlciB0byBnZXQgdGhlIGJhc2Ugd2ViZHJpdmVyLgoKICAgICAgICAgIGJyb3dzZXIud2FpdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGJyb3dzZXIuZHJpdmVyLmdldEN1cnJlbnRVcmwoKS50aGVuKGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICAgIHJldHVybiB1cmwubWF0Y2goL1wvMTIzJC8pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIDEwMDAsICdwYWdlIHNob3VsZCBuYXZpZ2F0ZSB0byAvMTIzJyk7CiAgICAgICAgfSk7CgogICB4aXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gaHJlZiBlbXB0eSBzdHJpbmcgYW5kIG5hbWUgc3BlY2lmaWVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTQnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpLnRvRXF1YWwoJzQnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTQnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvQmUoJycpOwogICAgICAgIH0pOwoKICAgaXQoJ3Nob3VsZCBleGVjdXRlIG5nLWNsaWNrIGJ1dCBub3QgcmVsb2FkIHdoZW4gbm8gaHJlZiBidXQgbmFtZSBzcGVjaWZpZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ2xpbmstNScpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkubW9kZWwoJ3ZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9FcXVhbCgnNScpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2xpbmstNScpKS5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSkudG9CZShudWxsKTsKICAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgb25seSBjaGFuZ2UgdXJsIHdoZW4gb25seSBuZy1ocmVmJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZScpKS5jbGVhcigpOwogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSkuc2VuZEtleXMoJzYnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5rLTYnKSkuZ2V0QXR0cmlidXRlKCdocmVmJykpLnRvTWF0Y2goL1wvNiQvKTsKCiAgICAgICAgICBlbGVtZW50KGJ5LmlkKCdsaW5rLTYnKSkuY2xpY2soKTsKCiAgICAgICAgICAvLyBBdCB0aGlzIHBvaW50LCB3ZSBuYXZpZ2F0ZSBhd2F5IGZyb20gYW4gQW5ndWxhciBwYWdlLCBzbyB3ZSBuZWVkCiAgICAgICAgICAvLyB0byB1c2UgYnJvd3Nlci5kcml2ZXIgdG8gZ2V0IHRoZSBiYXNlIHdlYmRyaXZlci4KICAgICAgICAgIGJyb3dzZXIud2FpdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGJyb3dzZXIuZHJpdmVyLmdldEN1cnJlbnRVcmwoKS50aGVuKGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICAgIHJldHVybiB1cmwubWF0Y2goL1wvNiQvKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LCAxMDAwLCAncGFnZSBzaG91bGQgbmF2aWdhdGUgdG8gLzYnKTsKICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ1NyYwogICAqIEByZXN0cmljdCBBCiAgICogQHByaW9yaXR5IDk5CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2luZyBBbmd1bGFyIG1hcmt1cCBsaWtlIGB7e2hhc2h9fWAgaW4gYSBgc3JjYCBhdHRyaWJ1dGUgZG9lc24ndAogICAqIHdvcmsgcmlnaHQ6IFRoZSBicm93c2VyIHdpbGwgZmV0Y2ggZnJvbSB0aGUgVVJMIHdpdGggdGhlIGxpdGVyYWwKICAgKiB0ZXh0IGB7e2hhc2h9fWAgdW50aWwgQW5ndWxhciByZXBsYWNlcyB0aGUgZXhwcmVzc2lvbiBpbnNpZGUKICAgKiBge3toYXNofX1gLiBUaGUgYG5nU3JjYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbS4KICAgKgogICAqIFRoZSBidWdneSB3YXkgdG8gd3JpdGUgaXQ6CiAgICogYGBgaHRtbAogICAqIDxpbWcgc3JjPSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0iLz4KICAgKiBgYGAKICAgKgogICAqIFRoZSBjb3JyZWN0IHdheSB0byB3cml0ZSBpdDoKICAgKiBgYGBodG1sCiAgICogPGltZyBuZy1zcmM9Imh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci97e2hhc2h9fSIvPgogICAqIGBgYAogICAqCiAgICogQGVsZW1lbnQgSU1HCiAgICogQHBhcmFtIHt0ZW1wbGF0ZX0gbmdTcmMgYW55IHN0cmluZyB3aGljaCBjYW4gY29udGFpbiBge3t9fWAgbWFya3VwLgogICAqLwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdTcmNzZXQKICAgKiBAcmVzdHJpY3QgQQogICAqIEBwcmlvcml0eSA5OQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVXNpbmcgQW5ndWxhciBtYXJrdXAgbGlrZSBge3toYXNofX1gIGluIGEgYHNyY3NldGAgYXR0cmlidXRlIGRvZXNuJ3QKICAgKiB3b3JrIHJpZ2h0OiBUaGUgYnJvd3NlciB3aWxsIGZldGNoIGZyb20gdGhlIFVSTCB3aXRoIHRoZSBsaXRlcmFsCiAgICogdGV4dCBge3toYXNofX1gIHVudGlsIEFuZ3VsYXIgcmVwbGFjZXMgdGhlIGV4cHJlc3Npb24gaW5zaWRlCiAgICogYHt7aGFzaH19YC4gVGhlIGBuZ1NyY3NldGAgZGlyZWN0aXZlIHNvbHZlcyB0aGlzIHByb2JsZW0uCiAgICoKICAgKiBUaGUgYnVnZ3kgd2F5IHRvIHdyaXRlIGl0OgogICAqIGBgYGh0bWwKICAgKiA8aW1nIHNyY3NldD0iaHR0cDovL3d3dy5ncmF2YXRhci5jb20vYXZhdGFyL3t7aGFzaH19IDJ4Ii8+CiAgICogYGBgCiAgICoKICAgKiBUaGUgY29ycmVjdCB3YXkgdG8gd3JpdGUgaXQ6CiAgICogYGBgaHRtbAogICAqIDxpbWcgbmctc3Jjc2V0PSJodHRwOi8vd3d3LmdyYXZhdGFyLmNvbS9hdmF0YXIve3toYXNofX0gMngiLz4KICAgKiBgYGAKICAgKgogICAqIEBlbGVtZW50IElNRwogICAqIEBwYXJhbSB7dGVtcGxhdGV9IG5nU3Jjc2V0IGFueSBzdHJpbmcgd2hpY2ggY2FuIGNvbnRhaW4gYHt7fX1gIG1hcmt1cC4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nRGlzYWJsZWQKICAgKiBAcmVzdHJpY3QgQQogICAqIEBwcmlvcml0eSAxMDAKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogVGhlIGZvbGxvd2luZyBtYXJrdXAgd2lsbCBtYWtlIHRoZSBidXR0b24gZW5hYmxlZCBvbiBDaHJvbWUvRmlyZWZveCBidXQgbm90IG9uIElFOCBhbmQgb2xkZXIgSUVzOgogICAqIGBgYGh0bWwKICAgKiA8ZGl2IG5nLWluaXQ9InNjb3BlID0geyBpc0Rpc2FibGVkOiBmYWxzZSB9Ij4KICAgKiAgPGJ1dHRvbiBkaXNhYmxlZD0ie3tzY29wZS5pc0Rpc2FibGVkfX0iPkRpc2FibGVkPC9idXR0b24+CiAgICogPC9kaXY+CiAgICogYGBgCiAgICoKICAgKiBUaGUgSFRNTCBzcGVjaWZpY2F0aW9uIGRvZXMgbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHZhbHVlcyBvZiBib29sZWFuIGF0dHJpYnV0ZXMKICAgKiBzdWNoIGFzIGRpc2FibGVkLiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAgICogSWYgd2UgcHV0IGFuIEFuZ3VsYXIgaW50ZXJwb2xhdGlvbiBleHByZXNzaW9uIGludG8gc3VjaCBhbiBhdHRyaWJ1dGUgdGhlbiB0aGUKICAgKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAgICogVGhlIGBuZ0Rpc2FibGVkYCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGBkaXNhYmxlZGAgYXR0cmlidXRlLgogICAqIFRoaXMgY29tcGxlbWVudGFyeSBkaXJlY3RpdmUgaXMgbm90IHJlbW92ZWQgYnkgdGhlIGJyb3dzZXIgYW5kIHNvIHByb3ZpZGVzCiAgICogYSBwZXJtYW5lbnQgcmVsaWFibGUgcGxhY2UgdG8gc3RvcmUgdGhlIGJpbmRpbmcgaW5mb3JtYXRpb24uCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIENsaWNrIG1lIHRvIHRvZ2dsZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgPGJ1dHRvbiBuZy1tb2RlbD0iYnV0dG9uIiBuZy1kaXNhYmxlZD0iY2hlY2tlZCI+QnV0dG9uPC9idXR0b24+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgdG9nZ2xlIGJ1dHRvbicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCdidXR0b24nKSkuZ2V0QXR0cmlidXRlKCdkaXNhYmxlZCcpKS50b0JlRmFsc3koKTsKICAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ2NoZWNrZWQnKSkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnYnV0dG9uJykpLmdldEF0dHJpYnV0ZSgnZGlzYWJsZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKgogICAqIEBlbGVtZW50IElOUFVUCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0Rpc2FibGVkIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHksCiAgICogICAgIHRoZW4gc3BlY2lhbCBhdHRyaWJ1dGUgImRpc2FibGVkIiB3aWxsIGJlIHNldCBvbiB0aGUgZWxlbWVudAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nQ2hlY2tlZAogICAqIEByZXN0cmljdCBBCiAgICogQHByaW9yaXR5IDEwMAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIEhUTUwgc3BlY2lmaWNhdGlvbiBkb2VzIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSB2YWx1ZXMgb2YgYm9vbGVhbiBhdHRyaWJ1dGVzCiAgICogc3VjaCBhcyBjaGVja2VkLiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAgICogSWYgd2UgcHV0IGFuIEFuZ3VsYXIgaW50ZXJwb2xhdGlvbiBleHByZXNzaW9uIGludG8gc3VjaCBhbiBhdHRyaWJ1dGUgdGhlbiB0aGUKICAgKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAgICogVGhlIGBuZ0NoZWNrZWRgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtIGZvciB0aGUgYGNoZWNrZWRgIGF0dHJpYnV0ZS4KICAgKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogICAqIGEgcGVybWFuZW50IHJlbGlhYmxlIHBsYWNlIHRvIHN0b3JlIHRoZSBiaW5kaW5nIGluZm9ybWF0aW9uLgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgQ2hlY2sgbWUgdG8gY2hlY2sgYm90aDogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0ibWFzdGVyIj48YnIvPgogICA8aW5wdXQgaWQ9ImNoZWNrU2xhdmUiIHR5cGU9ImNoZWNrYm94IiBuZy1jaGVja2VkPSJtYXN0ZXIiPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGNoZWNrIGJvdGggY2hlY2tCb3hlcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2NoZWNrU2xhdmUnKSkuZ2V0QXR0cmlidXRlKCdjaGVja2VkJykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnbWFzdGVyJykpLmNsaWNrKCk7CiAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnY2hlY2tTbGF2ZScpKS5nZXRBdHRyaWJ1dGUoJ2NoZWNrZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKgogICAqIEBlbGVtZW50IElOUFVUCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NoZWNrZWQgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSwKICAgKiAgICAgdGhlbiBzcGVjaWFsIGF0dHJpYnV0ZSAiY2hlY2tlZCIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ1JlYWRvbmx5CiAgICogQHJlc3RyaWN0IEEKICAgKiBAcHJpb3JpdHkgMTAwCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgSFRNTCBzcGVjaWZpY2F0aW9uIGRvZXMgbm90IHJlcXVpcmUgYnJvd3NlcnMgdG8gcHJlc2VydmUgdGhlIHZhbHVlcyBvZiBib29sZWFuIGF0dHJpYnV0ZXMKICAgKiBzdWNoIGFzIHJlYWRvbmx5LiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAgICogSWYgd2UgcHV0IGFuIEFuZ3VsYXIgaW50ZXJwb2xhdGlvbiBleHByZXNzaW9uIGludG8gc3VjaCBhbiBhdHRyaWJ1dGUgdGhlbiB0aGUKICAgKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAgICogVGhlIGBuZ1JlYWRvbmx5YCBkaXJlY3RpdmUgc29sdmVzIHRoaXMgcHJvYmxlbSBmb3IgdGhlIGByZWFkb25seWAgYXR0cmlidXRlLgogICAqIFRoaXMgY29tcGxlbWVudGFyeSBkaXJlY3RpdmUgaXMgbm90IHJlbW92ZWQgYnkgdGhlIGJyb3dzZXIgYW5kIHNvIHByb3ZpZGVzCiAgICogYSBwZXJtYW5lbnQgcmVsaWFibGUgcGxhY2UgdG8gc3RvcmUgdGhlIGJpbmRpbmcgaW5mb3JtYXRpb24uCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICBDaGVjayBtZSB0byBtYWtlIHRleHQgcmVhZG9ubHk6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNoZWNrZWQiPjxici8+CiAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1yZWFkb25seT0iY2hlY2tlZCIgdmFsdWU9IkknbSBBbmd1bGFyIi8+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgdG9nZ2xlIHJlYWRvbmx5IGF0dHInLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnW3R5cGU9InRleHQiXScpKS5nZXRBdHRyaWJ1dGUoJ3JlYWRvbmx5JykpLnRvQmVGYWxzeSgpOwogICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnY2hlY2tlZCcpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCdbdHlwZT0idGV4dCJdJykpLmdldEF0dHJpYnV0ZSgncmVhZG9ubHknKSkudG9CZVRydXRoeSgpOwogICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKgogICAqIEBlbGVtZW50IElOUFVUCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1JlYWRvbmx5IElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHksCiAgICogICAgIHRoZW4gc3BlY2lhbCBhdHRyaWJ1dGUgInJlYWRvbmx5IiB3aWxsIGJlIHNldCBvbiB0aGUgZWxlbWVudAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nU2VsZWN0ZWQKICAgKiBAcmVzdHJpY3QgQQogICAqIEBwcmlvcml0eSAxMDAKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBIVE1MIHNwZWNpZmljYXRpb24gZG9lcyBub3QgcmVxdWlyZSBicm93c2VycyB0byBwcmVzZXJ2ZSB0aGUgdmFsdWVzIG9mIGJvb2xlYW4gYXR0cmlidXRlcwogICAqIHN1Y2ggYXMgc2VsZWN0ZWQuIChUaGVpciBwcmVzZW5jZSBtZWFucyB0cnVlIGFuZCB0aGVpciBhYnNlbmNlIG1lYW5zIGZhbHNlLikKICAgKiBJZiB3ZSBwdXQgYW4gQW5ndWxhciBpbnRlcnBvbGF0aW9uIGV4cHJlc3Npb24gaW50byBzdWNoIGFuIGF0dHJpYnV0ZSB0aGVuIHRoZQogICAqIGJpbmRpbmcgaW5mb3JtYXRpb24gd291bGQgYmUgbG9zdCB3aGVuIHRoZSBicm93c2VyIHJlbW92ZXMgdGhlIGF0dHJpYnV0ZS4KICAgKiBUaGUgYG5nU2VsZWN0ZWRgIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtIGZvciB0aGUgYHNlbGVjdGVkYCBhdHRyaWJ1dGUuCiAgICogVGhpcyBjb21wbGVtZW50YXJ5IGRpcmVjdGl2ZSBpcyBub3QgcmVtb3ZlZCBieSB0aGUgYnJvd3NlciBhbmQgc28gcHJvdmlkZXMKICAgKiBhIHBlcm1hbmVudCByZWxpYWJsZSBwbGFjZSB0byBzdG9yZSB0aGUgYmluZGluZyBpbmZvcm1hdGlvbi4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgQ2hlY2sgbWUgdG8gc2VsZWN0OiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJzZWxlY3RlZCI+PGJyLz4KICAgPHNlbGVjdD4KICAgPG9wdGlvbj5IZWxsbyE8L29wdGlvbj4KICAgPG9wdGlvbiBpZD0iZ3JlZXQiIG5nLXNlbGVjdGVkPSJzZWxlY3RlZCI+R3JlZXRpbmdzITwvb3B0aW9uPgogICA8L3NlbGVjdD4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBzZWxlY3QgR3JlZXRpbmdzIScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2dyZWV0JykpLmdldEF0dHJpYnV0ZSgnc2VsZWN0ZWQnKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzZWxlY3RlZCcpKS5jbGljaygpOwogICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2dyZWV0JykpLmdldEF0dHJpYnV0ZSgnc2VsZWN0ZWQnKSkudG9CZVRydXRoeSgpOwogICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKgogICAqIEBlbGVtZW50IE9QVElPTgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTZWxlY3RlZCBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5LAogICAqICAgICB0aGVuIHNwZWNpYWwgYXR0cmlidXRlICJzZWxlY3RlZCIgd2lsbCBiZSBzZXQgb24gdGhlIGVsZW1lbnQKICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nT3BlbgogICAqIEByZXN0cmljdCBBCiAgICogQHByaW9yaXR5IDEwMAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIEhUTUwgc3BlY2lmaWNhdGlvbiBkb2VzIG5vdCByZXF1aXJlIGJyb3dzZXJzIHRvIHByZXNlcnZlIHRoZSB2YWx1ZXMgb2YgYm9vbGVhbiBhdHRyaWJ1dGVzCiAgICogc3VjaCBhcyBvcGVuLiAoVGhlaXIgcHJlc2VuY2UgbWVhbnMgdHJ1ZSBhbmQgdGhlaXIgYWJzZW5jZSBtZWFucyBmYWxzZS4pCiAgICogSWYgd2UgcHV0IGFuIEFuZ3VsYXIgaW50ZXJwb2xhdGlvbiBleHByZXNzaW9uIGludG8gc3VjaCBhbiBhdHRyaWJ1dGUgdGhlbiB0aGUKICAgKiBiaW5kaW5nIGluZm9ybWF0aW9uIHdvdWxkIGJlIGxvc3Qgd2hlbiB0aGUgYnJvd3NlciByZW1vdmVzIHRoZSBhdHRyaWJ1dGUuCiAgICogVGhlIGBuZ09wZW5gIGRpcmVjdGl2ZSBzb2x2ZXMgdGhpcyBwcm9ibGVtIGZvciB0aGUgYG9wZW5gIGF0dHJpYnV0ZS4KICAgKiBUaGlzIGNvbXBsZW1lbnRhcnkgZGlyZWN0aXZlIGlzIG5vdCByZW1vdmVkIGJ5IHRoZSBicm93c2VyIGFuZCBzbyBwcm92aWRlcwogICAqIGEgcGVybWFuZW50IHJlbGlhYmxlIHBsYWNlIHRvIHN0b3JlIHRoZSBiaW5kaW5nIGluZm9ybWF0aW9uLgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgQ2hlY2sgbWUgY2hlY2sgbXVsdGlwbGU6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9Im9wZW4iPjxici8+CiAgIDxkZXRhaWxzIGlkPSJkZXRhaWxzIiBuZy1vcGVuPSJvcGVuIj4KICAgPHN1bW1hcnk+U2hvdy9IaWRlIG1lPC9zdW1tYXJ5PgogICA8L2RldGFpbHM+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgdG9nZ2xlIG9wZW4nLCBmdW5jdGlvbigpIHsKICAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnZGV0YWlscycpKS5nZXRBdHRyaWJ1dGUoJ29wZW4nKSkudG9CZUZhbHN5KCk7CiAgICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnb3BlbicpKS5jbGljaygpOwogICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdkZXRhaWxzJykpLmdldEF0dHJpYnV0ZSgnb3BlbicpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKgogICAqIEBlbGVtZW50IERFVEFJTFMKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nT3BlbiBJZiB0aGUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gZXhwcmVzc2lvbn0gaXMgdHJ1dGh5LAogICAqICAgICB0aGVuIHNwZWNpYWwgYXR0cmlidXRlICJvcGVuIiB3aWxsIGJlIHNldCBvbiB0aGUgZWxlbWVudAogICAqLwoKICB2YXIgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXMgPSB7fTsKCgovLyBib29sZWFuIGF0dHJzIGFyZSBldmFsdWF0ZWQKICBmb3JFYWNoKEJPT0xFQU5fQVRUUiwgZnVuY3Rpb24ocHJvcE5hbWUsIGF0dHJOYW1lKSB7CiAgICAvLyBiaW5kaW5nIHRvIG11bHRpcGxlIGlzIG5vdCBzdXBwb3J0ZWQKICAgIGlmIChwcm9wTmFtZSA9PSAibXVsdGlwbGUiKSByZXR1cm47CgogICAgdmFyIG5vcm1hbGl6ZWQgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ25nLScgKyBhdHRyTmFtZSk7CiAgICBuZ0F0dHJpYnV0ZUFsaWFzRGlyZWN0aXZlc1tub3JtYWxpemVkXSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyW25vcm1hbGl6ZWRdLCBmdW5jdGlvbiBuZ0Jvb2xlYW5BdHRyV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgYXR0ci4kc2V0KGF0dHJOYW1lLCAhIXZhbHVlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKICAgIH07CiAgfSk7CgoKLy8gbmctc3JjLCBuZy1zcmNzZXQsIG5nLWhyZWYgYXJlIGludGVycG9sYXRlZAogIGZvckVhY2goWydzcmMnLCAnc3Jjc2V0JywgJ2hyZWYnXSwgZnVuY3Rpb24oYXR0ck5hbWUpIHsKICAgIHZhciBub3JtYWxpemVkID0gZGlyZWN0aXZlTm9ybWFsaXplKCduZy0nICsgYXR0ck5hbWUpOwogICAgbmdBdHRyaWJ1dGVBbGlhc0RpcmVjdGl2ZXNbbm9ybWFsaXplZF0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBwcmlvcml0eTogOTksIC8vIGl0IG5lZWRzIHRvIHJ1biBhZnRlciB0aGUgYXR0cmlidXRlcyBhcmUgaW50ZXJwb2xhdGVkCiAgICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIHZhciBwcm9wTmFtZSA9IGF0dHJOYW1lLAogICAgICAgICAgICBuYW1lID0gYXR0ck5hbWU7CgogICAgICAgICAgaWYgKGF0dHJOYW1lID09PSAnaHJlZicgJiYKICAgICAgICAgICAgdG9TdHJpbmcuY2FsbChlbGVtZW50LnByb3AoJ2hyZWYnKSkgPT09ICdbb2JqZWN0IFNWR0FuaW1hdGVkU3RyaW5nXScpIHsKICAgICAgICAgICAgbmFtZSA9ICd4bGlua0hyZWYnOwogICAgICAgICAgICBhdHRyLiRhdHRyW25hbWVdID0gJ3hsaW5rOmhyZWYnOwogICAgICAgICAgICBwcm9wTmFtZSA9IG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgYXR0ci4kb2JzZXJ2ZShub3JtYWxpemVkLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAoIXZhbHVlKQogICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIGF0dHIuJHNldChuYW1lLCB2YWx1ZSk7CgogICAgICAgICAgICAvLyBvbiBJRSwgaWYgIm5nOnNyYyIgZGlyZWN0aXZlIGRlY2xhcmF0aW9uIGlzIHVzZWQgYW5kICJzcmMiIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0CiAgICAgICAgICAgIC8vIHRoZW4gY2FsbGluZyBlbGVtZW50LnNldEF0dHJpYnV0ZSgnc3JjJywgJ2ZvbycpIGRvZXNuJ3QgZG8gYW55dGhpbmcsIHNvIHdlIG5lZWQKICAgICAgICAgICAgLy8gdG8gc2V0IHRoZSBwcm9wZXJ0eSBhcyB3ZWxsIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgZWZmZWN0LgogICAgICAgICAgICAvLyB3ZSB1c2UgYXR0clthdHRyTmFtZV0gdmFsdWUgc2luY2UgJHNldCBjYW4gc2FuaXRpemUgdGhlIHVybC4KICAgICAgICAgICAgaWYgKG1zaWUgJiYgcHJvcE5hbWUpIGVsZW1lbnQucHJvcChwcm9wTmFtZSwgYXR0cltuYW1lXSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CiAgICB9OwogIH0pOwoKICAvKiBnbG9iYWwgLW51bGxGb3JtQ3RybCAqLwogIHZhciBudWxsRm9ybUN0cmwgPSB7CiAgICAkYWRkQ29udHJvbDogbm9vcCwKICAgICRyZW1vdmVDb250cm9sOiBub29wLAogICAgJHNldFZhbGlkaXR5OiBub29wLAogICAgJHNldERpcnR5OiBub29wLAogICAgJHNldFByaXN0aW5lOiBub29wCiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIHR5cGUKICAgKiBAbmFtZSBmb3JtLkZvcm1Db250cm9sbGVyCiAgICoKICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRwcmlzdGluZSBUcnVlIGlmIHVzZXIgaGFzIG5vdCBpbnRlcmFjdGVkIHdpdGggdGhlIGZvcm0geWV0LgogICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGRpcnR5IFRydWUgaWYgdXNlciBoYXMgYWxyZWFkeSBpbnRlcmFjdGVkIHdpdGggdGhlIGZvcm0uCiAgICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiBhbGwgb2YgdGhlIGNvbnRhaW5pbmcgZm9ybXMgYW5kIGNvbnRyb2xzIGFyZSB2YWxpZC4KICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRpbnZhbGlkIFRydWUgaWYgYXQgbGVhc3Qgb25lIGNvbnRhaW5pbmcgY29udHJvbCBvciBmb3JtIGlzIGludmFsaWQuCiAgICoKICAgKiBAcHJvcGVydHkge09iamVjdH0gJGVycm9yIElzIGFuIG9iamVjdCBoYXNoLCBjb250YWluaW5nIHJlZmVyZW5jZXMgdG8gYWxsIGludmFsaWQgY29udHJvbHMgb3IKICAgKiAgZm9ybXMsIHdoZXJlOgogICAqCiAgICogIC0ga2V5cyBhcmUgdmFsaWRhdGlvbiB0b2tlbnMgKGVycm9yIG5hbWVzKSwKICAgKiAgLSB2YWx1ZXMgYXJlIGFycmF5cyBvZiBjb250cm9scyBvciBmb3JtcyB0aGF0IGFyZSBpbnZhbGlkIGZvciBnaXZlbiBlcnJvciBuYW1lLgogICAqCiAgICoKICAgKiAgQnVpbHQtaW4gdmFsaWRhdGlvbiB0b2tlbnM6CiAgICoKICAgKiAgLSBgZW1haWxgCiAgICogIC0gYG1heGAKICAgKiAgLSBgbWF4bGVuZ3RoYAogICAqICAtIGBtaW5gCiAgICogIC0gYG1pbmxlbmd0aGAKICAgKiAgLSBgbnVtYmVyYAogICAqICAtIGBwYXR0ZXJuYAogICAqICAtIGByZXF1aXJlZGAKICAgKiAgLSBgdXJsYAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogYEZvcm1Db250cm9sbGVyYCBrZWVwcyB0cmFjayBvZiBhbGwgaXRzIGNvbnRyb2xzIGFuZCBuZXN0ZWQgZm9ybXMgYXMgd2VsbCBhcyB0aGUgc3RhdGUgb2YgdGhlbSwKICAgKiBzdWNoIGFzIGJlaW5nIHZhbGlkL2ludmFsaWQgb3IgZGlydHkvcHJpc3RpbmUuCiAgICoKICAgKiBFYWNoIHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSBmb3JtfSBkaXJlY3RpdmUgY3JlYXRlcyBhbiBpbnN0YW5jZQogICAqIG9mIGBGb3JtQ29udHJvbGxlcmAuCiAgICoKICAgKi8KLy9hc2tzIGZvciAkc2NvcGUgdG8gZm9vbCB0aGUgQkMgY29udHJvbGxlciBtb2R1bGUKICBGb3JtQ29udHJvbGxlci4kaW5qZWN0ID0gWyckZWxlbWVudCcsICckYXR0cnMnLCAnJHNjb3BlJywgJyRhbmltYXRlJ107CiAgZnVuY3Rpb24gRm9ybUNvbnRyb2xsZXIoZWxlbWVudCwgYXR0cnMsICRzY29wZSwgJGFuaW1hdGUpIHsKICAgIHZhciBmb3JtID0gdGhpcywKICAgICAgcGFyZW50Rm9ybSA9IGVsZW1lbnQucGFyZW50KCkuY29udHJvbGxlcignZm9ybScpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgaW52YWxpZENvdW50ID0gMCwgLy8gdXNlZCB0byBlYXNpbHkgZGV0ZXJtaW5lIGlmIHdlIGFyZSB2YWxpZAogICAgICBlcnJvcnMgPSBmb3JtLiRlcnJvciA9IHt9LAogICAgICBjb250cm9scyA9IFtdOwoKICAgIC8vIGluaXQgc3RhdGUKICAgIGZvcm0uJG5hbWUgPSBhdHRycy5uYW1lIHx8IGF0dHJzLm5nRm9ybTsKICAgIGZvcm0uJGRpcnR5ID0gZmFsc2U7CiAgICBmb3JtLiRwcmlzdGluZSA9IHRydWU7CiAgICBmb3JtLiR2YWxpZCA9IHRydWU7CiAgICBmb3JtLiRpbnZhbGlkID0gZmFsc2U7CgogICAgcGFyZW50Rm9ybS4kYWRkQ29udHJvbChmb3JtKTsKCiAgICAvLyBTZXR1cCBpbml0aWFsIHN0YXRlIG9mIHRoZSBjb250cm9sCiAgICBlbGVtZW50LmFkZENsYXNzKFBSSVNUSU5FX0NMQVNTKTsKICAgIHRvZ2dsZVZhbGlkQ3NzKHRydWUpOwoKICAgIC8vIGNvbnZlbmllbmNlIG1ldGhvZCBmb3IgZWFzeSB0b2dnbGluZyBvZiBjbGFzc2VzCiAgICBmdW5jdGlvbiB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpIHsKICAgICAgdmFsaWRhdGlvbkVycm9yS2V5ID0gdmFsaWRhdGlvbkVycm9yS2V5ID8gJy0nICsgc25ha2VfY2FzZSh2YWxpZGF0aW9uRXJyb3JLZXksICctJykgOiAnJzsKICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoZWxlbWVudCwgKGlzVmFsaWQgPyBJTlZBTElEX0NMQVNTIDogVkFMSURfQ0xBU1MpICsgdmFsaWRhdGlvbkVycm9yS2V5KTsKICAgICAgJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgKGlzVmFsaWQgPyBWQUxJRF9DTEFTUyA6IElOVkFMSURfQ0xBU1MpICsgdmFsaWRhdGlvbkVycm9yS2V5KTsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJGFkZENvbnRyb2wKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJlZ2lzdGVyIGEgY29udHJvbCB3aXRoIHRoZSBmb3JtLgogICAgICoKICAgICAqIElucHV0IGVsZW1lbnRzIHVzaW5nIG5nTW9kZWxDb250cm9sbGVyIGRvIHRoaXMgYXV0b21hdGljYWxseSB3aGVuIHRoZXkgYXJlIGxpbmtlZC4KICAgICAqLwogICAgZm9ybS4kYWRkQ29udHJvbCA9IGZ1bmN0aW9uKGNvbnRyb2wpIHsKICAgICAgLy8gQnJlYWtpbmcgY2hhbmdlIC0gYmVmb3JlLCBpbnB1dHMgd2hvc2UgbmFtZSB3YXMgImhhc093blByb3BlcnR5IiB3ZXJlIHF1aWV0bHkgaWdub3JlZAogICAgICAvLyBhbmQgbm90IGFkZGVkIHRvIHRoZSBzY29wZS4gIE5vdyB3ZSB0aHJvdyBhbiBlcnJvci4KICAgICAgYXNzZXJ0Tm90SGFzT3duUHJvcGVydHkoY29udHJvbC4kbmFtZSwgJ2lucHV0Jyk7CiAgICAgIGNvbnRyb2xzLnB1c2goY29udHJvbCk7CgogICAgICBpZiAoY29udHJvbC4kbmFtZSkgewogICAgICAgIGZvcm1bY29udHJvbC4kbmFtZV0gPSBjb250cm9sOwogICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgZm9ybS5Gb3JtQ29udHJvbGxlciMkcmVtb3ZlQ29udHJvbAogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGVyZWdpc3RlciBhIGNvbnRyb2wgZnJvbSB0aGUgZm9ybS4KICAgICAqCiAgICAgKiBJbnB1dCBlbGVtZW50cyB1c2luZyBuZ01vZGVsQ29udHJvbGxlciBkbyB0aGlzIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGV5IGFyZSBkZXN0cm95ZWQuCiAgICAgKi8KICAgIGZvcm0uJHJlbW92ZUNvbnRyb2wgPSBmdW5jdGlvbihjb250cm9sKSB7CiAgICAgIGlmIChjb250cm9sLiRuYW1lICYmIGZvcm1bY29udHJvbC4kbmFtZV0gPT09IGNvbnRyb2wpIHsKICAgICAgICBkZWxldGUgZm9ybVtjb250cm9sLiRuYW1lXTsKICAgICAgfQogICAgICBmb3JFYWNoKGVycm9ycywgZnVuY3Rpb24ocXVldWUsIHZhbGlkYXRpb25Ub2tlbikgewogICAgICAgIGZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25Ub2tlbiwgdHJ1ZSwgY29udHJvbCk7CiAgICAgIH0pOwoKICAgICAgYXJyYXlSZW1vdmUoY29udHJvbHMsIGNvbnRyb2wpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXRzIHRoZSB2YWxpZGl0eSBvZiBhIGZvcm0gY29udHJvbC4KICAgICAqCiAgICAgKiBUaGlzIG1ldGhvZCB3aWxsIGFsc28gcHJvcGFnYXRlIHRvIHBhcmVudCBmb3Jtcy4KICAgICAqLwogICAgZm9ybS4kc2V0VmFsaWRpdHkgPSBmdW5jdGlvbih2YWxpZGF0aW9uVG9rZW4sIGlzVmFsaWQsIGNvbnRyb2wpIHsKICAgICAgdmFyIHF1ZXVlID0gZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl07CgogICAgICBpZiAoaXNWYWxpZCkgewogICAgICAgIGlmIChxdWV1ZSkgewogICAgICAgICAgYXJyYXlSZW1vdmUocXVldWUsIGNvbnRyb2wpOwogICAgICAgICAgaWYgKCFxdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgaW52YWxpZENvdW50LS07CiAgICAgICAgICAgIGlmICghaW52YWxpZENvdW50KSB7CiAgICAgICAgICAgICAgdG9nZ2xlVmFsaWRDc3MoaXNWYWxpZCk7CiAgICAgICAgICAgICAgZm9ybS4kdmFsaWQgPSB0cnVlOwogICAgICAgICAgICAgIGZvcm0uJGludmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlcnJvcnNbdmFsaWRhdGlvblRva2VuXSA9IGZhbHNlOwogICAgICAgICAgICB0b2dnbGVWYWxpZENzcyh0cnVlLCB2YWxpZGF0aW9uVG9rZW4pOwogICAgICAgICAgICBwYXJlbnRGb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uVG9rZW4sIHRydWUsIGZvcm0pOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFpbnZhbGlkQ291bnQpIHsKICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQpOwogICAgICAgIH0KICAgICAgICBpZiAocXVldWUpIHsKICAgICAgICAgIGlmIChpbmNsdWRlcyhxdWV1ZSwgY29udHJvbCkpIHJldHVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZXJyb3JzW3ZhbGlkYXRpb25Ub2tlbl0gPSBxdWV1ZSA9IFtdOwogICAgICAgICAgaW52YWxpZENvdW50Kys7CiAgICAgICAgICB0b2dnbGVWYWxpZENzcyhmYWxzZSwgdmFsaWRhdGlvblRva2VuKTsKICAgICAgICAgIHBhcmVudEZvcm0uJHNldFZhbGlkaXR5KHZhbGlkYXRpb25Ub2tlbiwgZmFsc2UsIGZvcm0pOwogICAgICAgIH0KICAgICAgICBxdWV1ZS5wdXNoKGNvbnRyb2wpOwoKICAgICAgICBmb3JtLiR2YWxpZCA9IGZhbHNlOwogICAgICAgIGZvcm0uJGludmFsaWQgPSB0cnVlOwogICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgZm9ybS5Gb3JtQ29udHJvbGxlciMkc2V0RGlydHkKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNldHMgdGhlIGZvcm0gdG8gYSBkaXJ0eSBzdGF0ZS4KICAgICAqCiAgICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIGFkZCB0aGUgJ25nLWRpcnR5JyBjbGFzcyBhbmQgc2V0IHRoZSBmb3JtIHRvIGEgZGlydHkKICAgICAqIHN0YXRlIChuZy1kaXJ0eSBjbGFzcykuIFRoaXMgbWV0aG9kIHdpbGwgYWxzbyBwcm9wYWdhdGUgdG8gcGFyZW50IGZvcm1zLgogICAgICovCiAgICBmb3JtLiRzZXREaXJ0eSA9IGZ1bmN0aW9uKCkgewogICAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCBQUklTVElORV9DTEFTUyk7CiAgICAgICRhbmltYXRlLmFkZENsYXNzKGVsZW1lbnQsIERJUlRZX0NMQVNTKTsKICAgICAgZm9ybS4kZGlydHkgPSB0cnVlOwogICAgICBmb3JtLiRwcmlzdGluZSA9IGZhbHNlOwogICAgICBwYXJlbnRGb3JtLiRzZXREaXJ0eSgpOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lIGZvcm0uRm9ybUNvbnRyb2xsZXIjJHNldFByaXN0aW5lCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXRzIHRoZSBmb3JtIHRvIGl0cyBwcmlzdGluZSBzdGF0ZS4KICAgICAqCiAgICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIHJlbW92ZSB0aGUgJ25nLWRpcnR5JyBjbGFzcyBhbmQgc2V0IHRoZSBmb3JtIHRvIGl0cyBwcmlzdGluZQogICAgICogc3RhdGUgKG5nLXByaXN0aW5lIGNsYXNzKS4gVGhpcyBtZXRob2Qgd2lsbCBhbHNvIHByb3BhZ2F0ZSB0byBhbGwgdGhlIGNvbnRyb2xzIGNvbnRhaW5lZAogICAgICogaW4gdGhpcyBmb3JtLgogICAgICoKICAgICAqIFNldHRpbmcgYSBmb3JtIGJhY2sgdG8gYSBwcmlzdGluZSBzdGF0ZSBpcyBvZnRlbiB1c2VmdWwgd2hlbiB3ZSB3YW50IHRvICdyZXVzZScgYSBmb3JtIGFmdGVyCiAgICAgKiBzYXZpbmcgb3IgcmVzZXR0aW5nIGl0LgogICAgICovCiAgICBmb3JtLiRzZXRQcmlzdGluZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoZWxlbWVudCwgRElSVFlfQ0xBU1MpOwogICAgICAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCBQUklTVElORV9DTEFTUyk7CiAgICAgIGZvcm0uJGRpcnR5ID0gZmFsc2U7CiAgICAgIGZvcm0uJHByaXN0aW5lID0gdHJ1ZTsKICAgICAgZm9yRWFjaChjb250cm9scywgZnVuY3Rpb24oY29udHJvbCkgewogICAgICAgIGNvbnRyb2wuJHNldFByaXN0aW5lKCk7CiAgICAgIH0pOwogICAgfTsKICB9CgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdGb3JtCiAgICogQHJlc3RyaWN0IEVBQwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogTmVzdGFibGUgYWxpYXMgb2Yge0BsaW5rIG5nLmRpcmVjdGl2ZTpmb3JtIGBmb3JtYH0gZGlyZWN0aXZlLiBIVE1MCiAgICogZG9lcyBub3QgYWxsb3cgbmVzdGluZyBvZiBmb3JtIGVsZW1lbnRzLiBJdCBpcyB1c2VmdWwgdG8gbmVzdCBmb3JtcywgZm9yIGV4YW1wbGUgaWYgdGhlIHZhbGlkaXR5IG9mIGEKICAgKiBzdWItZ3JvdXAgb2YgY29udHJvbHMgbmVlZHMgdG8gYmUgZGV0ZXJtaW5lZC4KICAgKgogICAqIE5vdGU6IHRoZSBwdXJwb3NlIG9mIGBuZ0Zvcm1gIGlzIHRvIGdyb3VwIGNvbnRyb2xzLAogICAqIGJ1dCBub3QgdG8gYmUgYSByZXBsYWNlbWVudCBmb3IgdGhlIGA8Zm9ybT5gIHRhZyB3aXRoIGFsbCBvZiBpdHMgY2FwYWJpbGl0aWVzCiAgICogKGUuZy4gcG9zdGluZyB0byB0aGUgc2VydmVyLCAuLi4pLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0Zvcm18bmFtZSBOYW1lIG9mIHRoZSBmb3JtLiBJZiBzcGVjaWZpZWQsIHRoZSBmb3JtIGNvbnRyb2xsZXIgd2lsbCBiZSBwdWJsaXNoZWQgaW50bwogICAqICAgICAgICAgICAgICAgICAgICAgICByZWxhdGVkIHNjb3BlLCB1bmRlciB0aGlzIG5hbWUuCiAgICoKICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGZvcm0KICAgKiBAcmVzdHJpY3QgRQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGlyZWN0aXZlIHRoYXQgaW5zdGFudGlhdGVzCiAgICoge0BsaW5rIGZvcm0uRm9ybUNvbnRyb2xsZXIgRm9ybUNvbnRyb2xsZXJ9LgogICAqCiAgICogSWYgdGhlIGBuYW1lYCBhdHRyaWJ1dGUgaXMgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIGlzIHB1Ymxpc2hlZCBvbnRvIHRoZSBjdXJyZW50IHNjb3BlIHVuZGVyCiAgICogdGhpcyBuYW1lLgogICAqCiAgICogIyBBbGlhczoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Zvcm0gYG5nRm9ybWB9CiAgICoKICAgKiBJbiBBbmd1bGFyIGZvcm1zIGNhbiBiZSBuZXN0ZWQuIFRoaXMgbWVhbnMgdGhhdCB0aGUgb3V0ZXIgZm9ybSBpcyB2YWxpZCB3aGVuIGFsbCBvZiB0aGUgY2hpbGQKICAgKiBmb3JtcyBhcmUgdmFsaWQgYXMgd2VsbC4gSG93ZXZlciwgYnJvd3NlcnMgZG8gbm90IGFsbG93IG5lc3Rpbmcgb2YgYDxmb3JtPmAgZWxlbWVudHMsIHNvCiAgICogQW5ndWxhciBwcm92aWRlcyB0aGUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Zvcm0gYG5nRm9ybWB9IGRpcmVjdGl2ZSB3aGljaCBiZWhhdmVzIGlkZW50aWNhbGx5IHRvCiAgICogYDxmb3JtPmAgYnV0IGNhbiBiZSBuZXN0ZWQuICBUaGlzIGFsbG93cyB5b3UgdG8gaGF2ZSBuZXN0ZWQgZm9ybXMsIHdoaWNoIGlzIHZlcnkgdXNlZnVsIHdoZW4KICAgKiB1c2luZyBBbmd1bGFyIHZhbGlkYXRpb24gZGlyZWN0aXZlcyBpbiBmb3JtcyB0aGF0IGFyZSBkeW5hbWljYWxseSBnZW5lcmF0ZWQgdXNpbmcgdGhlCiAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ1JlcGVhdCBgbmdSZXBlYXRgfSBkaXJlY3RpdmUuIFNpbmNlIHlvdSBjYW5ub3QgZHluYW1pY2FsbHkgZ2VuZXJhdGUgdGhlIGBuYW1lYAogICAqIGF0dHJpYnV0ZSBvZiBpbnB1dCBlbGVtZW50cyB1c2luZyBpbnRlcnBvbGF0aW9uLCB5b3UgaGF2ZSB0byB3cmFwIGVhY2ggc2V0IG9mIHJlcGVhdGVkIGlucHV0cyBpbiBhbgogICAqIGBuZ0Zvcm1gIGRpcmVjdGl2ZSBhbmQgbmVzdCB0aGVzZSBpbiBhbiBvdXRlciBgZm9ybWAgZWxlbWVudC4KICAgKgogICAqCiAgICogIyBDU1MgY2xhc3NlcwogICAqICAtIGBuZy12YWxpZGAgaXMgc2V0IGlmIHRoZSBmb3JtIGlzIHZhbGlkLgogICAqICAtIGBuZy1pbnZhbGlkYCBpcyBzZXQgaWYgdGhlIGZvcm0gaXMgaW52YWxpZC4KICAgKiAgLSBgbmctcHJpc3RpbmVgIGlzIHNldCBpZiB0aGUgZm9ybSBpcyBwcmlzdGluZS4KICAgKiAgLSBgbmctZGlydHlgIGlzIHNldCBpZiB0aGUgZm9ybSBpcyBkaXJ0eS4KICAgKgogICAqIEtlZXAgaW4gbWluZCB0aGF0IG5nQW5pbWF0ZSBjYW4gZGV0ZWN0IGVhY2ggb2YgdGhlc2UgY2xhc3NlcyB3aGVuIGFkZGVkIGFuZCByZW1vdmVkLgogICAqCiAgICoKICAgKiAjIFN1Ym1pdHRpbmcgYSBmb3JtIGFuZCBwcmV2ZW50aW5nIHRoZSBkZWZhdWx0IGFjdGlvbgogICAqCiAgICogU2luY2UgdGhlIHJvbGUgb2YgZm9ybXMgaW4gY2xpZW50LXNpZGUgQW5ndWxhciBhcHBsaWNhdGlvbnMgaXMgZGlmZmVyZW50IHRoYW4gaW4gY2xhc3NpY2FsCiAgICogcm91bmR0cmlwIGFwcHMsIGl0IGlzIGRlc2lyYWJsZSBmb3IgdGhlIGJyb3dzZXIgbm90IHRvIHRyYW5zbGF0ZSB0aGUgZm9ybSBzdWJtaXNzaW9uIGludG8gYSBmdWxsCiAgICogcGFnZSByZWxvYWQgdGhhdCBzZW5kcyB0aGUgZGF0YSB0byB0aGUgc2VydmVyLiBJbnN0ZWFkIHNvbWUgamF2YXNjcmlwdCBsb2dpYyBzaG91bGQgYmUgdHJpZ2dlcmVkCiAgICogdG8gaGFuZGxlIHRoZSBmb3JtIHN1Ym1pc3Npb24gaW4gYW4gYXBwbGljYXRpb24tc3BlY2lmaWMgd2F5LgogICAqCiAgICogRm9yIHRoaXMgcmVhc29uLCBBbmd1bGFyIHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAoZm9ybSBzdWJtaXNzaW9uIHRvIHRoZSBzZXJ2ZXIpIHVubGVzcyB0aGUKICAgKiBgPGZvcm0+YCBlbGVtZW50IGhhcyBhbiBgYWN0aW9uYCBhdHRyaWJ1dGUgc3BlY2lmaWVkLgogICAqCiAgICogWW91IGNhbiB1c2Ugb25lIG9mIHRoZSBmb2xsb3dpbmcgdHdvIHdheXMgdG8gc3BlY2lmeSB3aGF0IGphdmFzY3JpcHQgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgd2hlbgogICAqIGEgZm9ybSBpcyBzdWJtaXR0ZWQ6CiAgICoKICAgKiAtIHtAbGluayBuZy5kaXJlY3RpdmU6bmdTdWJtaXQgbmdTdWJtaXR9IGRpcmVjdGl2ZSBvbiB0aGUgZm9ybSBlbGVtZW50CiAgICogLSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30gZGlyZWN0aXZlIG9uIHRoZSBmaXJzdAogICAqICBidXR0b24gb3IgaW5wdXQgZmllbGQgb2YgdHlwZSBzdWJtaXQgKGlucHV0W3R5cGU9c3VibWl0XSkKICAgKgogICAqIFRvIHByZXZlbnQgZG91YmxlIGV4ZWN1dGlvbiBvZiB0aGUgaGFuZGxlciwgdXNlIG9ubHkgb25lIG9mIHRoZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nU3VibWl0IG5nU3VibWl0fQogICAqIG9yIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfSBkaXJlY3RpdmVzLgogICAqIFRoaXMgaXMgYmVjYXVzZSBvZiB0aGUgZm9sbG93aW5nIGZvcm0gc3VibWlzc2lvbiBydWxlcyBpbiB0aGUgSFRNTCBzcGVjaWZpY2F0aW9uOgogICAqCiAgICogLSBJZiBhIGZvcm0gaGFzIG9ubHkgb25lIGlucHV0IGZpZWxkIHRoZW4gaGl0dGluZyBlbnRlciBpbiB0aGlzIGZpZWxkIHRyaWdnZXJzIGZvcm0gc3VibWl0CiAgICogKGBuZ1N1Ym1pdGApCiAgICogLSBpZiBhIGZvcm0gaGFzIDIrIGlucHV0IGZpZWxkcyBhbmQgbm8gYnV0dG9ucyBvciBpbnB1dFt0eXBlPXN1Ym1pdF0gdGhlbiBoaXR0aW5nIGVudGVyCiAgICogZG9lc24ndCB0cmlnZ2VyIHN1Ym1pdAogICAqIC0gaWYgYSBmb3JtIGhhcyBvbmUgb3IgbW9yZSBpbnB1dCBmaWVsZHMgYW5kIG9uZSBvciBtb3JlIGJ1dHRvbnMgb3IgaW5wdXRbdHlwZT1zdWJtaXRdIHRoZW4KICAgKiBoaXR0aW5nIGVudGVyIGluIGFueSBvZiB0aGUgaW5wdXQgZmllbGRzIHdpbGwgdHJpZ2dlciB0aGUgY2xpY2sgaGFuZGxlciBvbiB0aGUgKmZpcnN0KiBidXR0b24gb3IKICAgKiBpbnB1dFt0eXBlPXN1Ym1pdF0gKGBuZ0NsaWNrYCkgKmFuZCogYSBzdWJtaXQgaGFuZGxlciBvbiB0aGUgZW5jbG9zaW5nIGZvcm0gKGBuZ1N1Ym1pdGApCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgTmFtZSBvZiB0aGUgZm9ybS4gSWYgc3BlY2lmaWVkLCB0aGUgZm9ybSBjb250cm9sbGVyIHdpbGwgYmUgcHVibGlzaGVkIGludG8KICAgKiAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRlZCBzY29wZSwgdW5kZXIgdGhpcyBuYW1lLgogICAqCiAgICogIyMgQW5pbWF0aW9uIEhvb2tzCiAgICoKICAgKiBBbmltYXRpb25zIGluIG5nRm9ybSBhcmUgdHJpZ2dlcmVkIHdoZW4gYW55IG9mIHRoZSBhc3NvY2lhdGVkIENTUyBjbGFzc2VzIGFyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KICAgKiBUaGVzZSBjbGFzc2VzIGFyZTogYC5uZy1wcmlzdGluZWAsIGAubmctZGlydHlgLCBgLm5nLWludmFsaWRgIGFuZCBgLm5nLXZhbGlkYCBhcyB3ZWxsIGFzIGFueQogICAqIG90aGVyIHZhbGlkYXRpb25zIHRoYXQgYXJlIHBlcmZvcm1lZCB3aXRoaW4gdGhlIGZvcm0uIEFuaW1hdGlvbnMgaW4gbmdGb3JtIGFyZSBzaW1pbGFyIHRvIGhvdwogICAqIHRoZXkgd29yayBpbiBuZ0NsYXNzIGFuZCBhbmltYXRpb25zIGNhbiBiZSBob29rZWQgaW50byB1c2luZyBDU1MgdHJhbnNpdGlvbnMsIGtleWZyYW1lcyBhcyB3ZWxsCiAgICogYXMgSlMgYW5pbWF0aW9ucy4KICAgKgogICAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzaG93cyBhIHNpbXBsZSB3YXkgdG8gdXRpbGl6ZSBDU1MgdHJhbnNpdGlvbnMgdG8gc3R5bGUgYSBmb3JtIGVsZW1lbnQKICAgKiB0aGF0IGhhcyBiZWVuIHJlbmRlcmVkIGFzIGludmFsaWQgYWZ0ZXIgaXQgaGFzIGJlZW4gdmFsaWRhdGVkOgogICAqCiAgICogPHByZT4KICAgKiAvL2JlIHN1cmUgdG8gaW5jbHVkZSBuZ0FuaW1hdGUgYXMgYSBtb2R1bGUgdG8gaG9vayBpbnRvIG1vcmUKICAgKiAvL2FkdmFuY2VkIGFuaW1hdGlvbnMKICAgKiAubXktZm9ybSB7CiAqICAgdHJhbnNpdGlvbjowLjVzIGxpbmVhciBhbGw7CiAqICAgYmFja2dyb3VuZDogd2hpdGU7CiAqIH0KICAgKiAubXktZm9ybS5uZy1pbnZhbGlkIHsKICogICBiYWNrZ3JvdW5kOiByZWQ7CiAqICAgY29sb3I6d2hpdGU7CiAqIH0KICAgKiA8L3ByZT4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSIgZml4QmFzZT0idHJ1ZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS51c2VyVHlwZSA9ICdndWVzdCc7CiAgICAgICAgIH0KICAgPC9zY3JpcHQ+CiAgIDxzdHlsZT4KICAgLm15LWZvcm0gewogICAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7CiAgICAgICAgfQogICAubXktZm9ybS5uZy1pbnZhbGlkIHsKICAgICAgICAgIGJhY2tncm91bmQ6IHJlZDsKICAgICAgICB9CiAgIDwvc3R5bGU+CiAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCIgY2xhc3M9Im15LWZvcm0iPgogICB1c2VyVHlwZTogPGlucHV0IG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idXNlclR5cGUiIHJlcXVpcmVkPgogICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPlJlcXVpcmVkITwvc3Bhbj48YnI+CiAgIDx0dD51c2VyVHlwZSA9IHt7dXNlclR5cGV9fTwvdHQ+PGJyPgogICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnI+CiAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxicj4KICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyPgogICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxicj4KICAgPC9mb3JtPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB1c2VyVHlwZSA9IGVsZW1lbnQoYnkuYmluZGluZygndXNlclR5cGUnKSk7CiAgICAgICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CgogICAgICAgICAgZXhwZWN0KHVzZXJUeXBlLmdldFRleHQoKSkudG9Db250YWluKCdndWVzdCcpOwogICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgICAgfSk7CgogICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB1c2VyVHlwZSA9IGVsZW1lbnQoYnkuYmluZGluZygndXNlclR5cGUnKSk7CiAgICAgICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgICAgICB2YXIgdXNlcklucHV0ID0gZWxlbWVudChieS5tb2RlbCgndXNlclR5cGUnKSk7CgogICAgICAgICAgdXNlcklucHV0LmNsZWFyKCk7CiAgICAgICAgICB1c2VySW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyVHlwZS5nZXRUZXh0KCkpLnRvRXF1YWwoJ3VzZXJUeXBlID0nKTsKICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICoKICAgKi8KICB2YXIgZm9ybURpcmVjdGl2ZUZhY3RvcnkgPSBmdW5jdGlvbihpc05nRm9ybSkgewogICAgcmV0dXJuIFsnJHRpbWVvdXQnLCBmdW5jdGlvbigkdGltZW91dCkgewogICAgICB2YXIgZm9ybURpcmVjdGl2ZSA9IHsKICAgICAgICBuYW1lOiAnZm9ybScsCiAgICAgICAgcmVzdHJpY3Q6IGlzTmdGb3JtID8gJ0VBQycgOiAnRScsCiAgICAgICAgY29udHJvbGxlcjogRm9ybUNvbnRyb2xsZXIsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBwcmU6IGZ1bmN0aW9uKHNjb3BlLCBmb3JtRWxlbWVudCwgYXR0ciwgY29udHJvbGxlcikgewogICAgICAgICAgICAgIGlmICghYXR0ci5hY3Rpb24pIHsKICAgICAgICAgICAgICAgIC8vIHdlIGNhbid0IHVzZSBqcSBldmVudHMgYmVjYXVzZSBpZiBhIGZvcm0gaXMgZGVzdHJveWVkIGR1cmluZyBzdWJtaXNzaW9uIHRoZSBkZWZhdWx0CiAgICAgICAgICAgICAgICAvLyBhY3Rpb24gaXMgbm90IHByZXZlbnRlZC4gc2VlICMxMjM4CiAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgLy8gSUUgOSBpcyBub3QgYWZmZWN0ZWQgYmVjYXVzZSBpdCBkb2Vzbid0IGZpcmUgYSBzdWJtaXQgZXZlbnQgYW5kIHRyeSB0byBkbyBhIGZ1bGwKICAgICAgICAgICAgICAgIC8vIHBhZ2UgcmVsb2FkIGlmIHRoZSBmb3JtIHdhcyBkZXN0cm95ZWQgYnkgc3VibWlzc2lvbiBvZiB0aGUgZm9ybSB2aWEgYSBjbGljayBoYW5kbGVyCiAgICAgICAgICAgICAgICAvLyBvbiBhIGJ1dHRvbiBpbiB0aGUgZm9ybS4gTG9va3MgbGlrZSBhbiBJRTkgc3BlY2lmaWMgYnVnLgogICAgICAgICAgICAgICAgdmFyIHByZXZlbnREZWZhdWx0TGlzdGVuZXIgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdAogICAgICAgICAgICAgICAgICAgID8gZXZlbnQucHJldmVudERlZmF1bHQoKQogICAgICAgICAgICAgICAgICAgIDogZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsgLy8gSUUKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgYWRkRXZlbnRMaXN0ZW5lckZuKGZvcm1FbGVtZW50WzBdLCAnc3VibWl0JywgcHJldmVudERlZmF1bHRMaXN0ZW5lcik7CgogICAgICAgICAgICAgICAgLy8gdW5yZWdpc3RlciB0aGUgcHJldmVudERlZmF1bHQgbGlzdGVuZXIgc28gdGhhdCB3ZSBkb24ndCBub3QgbGVhayBtZW1vcnkgYnV0IGluIGEKICAgICAgICAgICAgICAgIC8vIHdheSB0aGF0IHdpbGwgYWNoaWV2ZSB0aGUgcHJldmVudGlvbiBvZiB0aGUgZGVmYXVsdCBhY3Rpb24uCiAgICAgICAgICAgICAgICBmb3JtRWxlbWVudC5vbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lckZuKGZvcm1FbGVtZW50WzBdLCAnc3VibWl0JywgcHJldmVudERlZmF1bHRMaXN0ZW5lcik7CiAgICAgICAgICAgICAgICAgIH0sIDAsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgdmFyIHBhcmVudEZvcm1DdHJsID0gZm9ybUVsZW1lbnQucGFyZW50KCkuY29udHJvbGxlcignZm9ybScpLAogICAgICAgICAgICAgICAgYWxpYXMgPSBhdHRyLm5hbWUgfHwgYXR0ci5uZ0Zvcm07CgogICAgICAgICAgICAgIGlmIChhbGlhcykgewogICAgICAgICAgICAgICAgc2V0dGVyKHNjb3BlLCBhbGlhcywgY29udHJvbGxlciwgYWxpYXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocGFyZW50Rm9ybUN0cmwpIHsKICAgICAgICAgICAgICAgIGZvcm1FbGVtZW50Lm9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBwYXJlbnRGb3JtQ3RybC4kcmVtb3ZlQ29udHJvbChjb250cm9sbGVyKTsKICAgICAgICAgICAgICAgICAgaWYgKGFsaWFzKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0dGVyKHNjb3BlLCBhbGlhcywgdW5kZWZpbmVkLCBhbGlhcyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXh0ZW5kKGNvbnRyb2xsZXIsIG51bGxGb3JtQ3RybCk7IC8vc3RvcCBwcm9wYWdhdGluZyBjaGlsZCBkZXN0cnVjdGlvbiBoYW5kbGVycyB1cHdhcmRzCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9OwoKICAgICAgcmV0dXJuIGZvcm1EaXJlY3RpdmU7CiAgICB9XTsKICB9OwoKICB2YXIgZm9ybURpcmVjdGl2ZSA9IGZvcm1EaXJlY3RpdmVGYWN0b3J5KCk7CiAgdmFyIG5nRm9ybURpcmVjdGl2ZSA9IGZvcm1EaXJlY3RpdmVGYWN0b3J5KHRydWUpOwoKICAvKiBnbG9iYWwKCiAgIC1WQUxJRF9DTEFTUywKICAgLUlOVkFMSURfQ0xBU1MsCiAgIC1QUklTVElORV9DTEFTUywKICAgLURJUlRZX0NMQVNTCiAgICovCgogIHZhciBVUkxfUkVHRVhQID0gL14oZnRwfGh0dHB8aHR0cHMpOlwvXC8oXHcrOnswLDF9XHcqQCk/KFxTKykoOlswLTldKyk/KFwvfFwvKFtcdyMhOi4/Kz0mJUAhXC1cL10pKT8kLzsKICB2YXIgRU1BSUxfUkVHRVhQID0gL15bYS16MC05ISMkJSYnKisvPT9eX2B7fH1+Li1dK0BbYS16MC05LV0rKFwuW2EtejAtOS1dKykqJC9pOwogIHZhciBOVU1CRVJfUkVHRVhQID0gL15ccyooXC18XCspPyhcZCt8KFxkKihcLlxkKikpKVxzKiQvOwoKICB2YXIgaW5wdXRUeXBlID0gewoKICAgIC8qKgogICAgICogQG5nZG9jIGlucHV0CiAgICAgKiBAbmFtZSBpbnB1dFt0ZXh0XQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3RhbmRhcmQgSFRNTCB0ZXh0IGlucHV0IHdpdGggYW5ndWxhciBkYXRhIGJpbmRpbmcuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICogICAgbWlubGVuZ3RoLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAgICogICAgbWF4bGVuZ3RoLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IFtuZ1RyaW09dHJ1ZV0gSWYgc2V0IHRvIGZhbHNlIEFuZ3VsYXIgd2lsbCBub3QgYXV0b21hdGljYWxseSB0cmltIHRoZSBpbnB1dC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlIG5hbWU9InRleHQtaW5wdXQtZGlyZWN0aXZlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudGV4dCA9ICdndWVzdCc7CiAgICAgICAgICAgICAkc2NvcGUud29yZCA9IC9eXHMqXHcqXHMqJC87CiAgICAgICAgICAgfQogICAgIDwvc2NyaXB0PgogICAgIDxmb3JtIG5hbWU9Im15Rm9ybSIgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgICAgU2luZ2xlIHdvcmQ6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJpbnB1dCIgbmctbW9kZWw9InRleHQiCiAgICAgbmctcGF0dGVybj0id29yZCIgcmVxdWlyZWQgbmctdHJpbT0iZmFsc2UiPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgICAgUmVxdWlyZWQhPC9zcGFuPgogICAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmlucHV0LiRlcnJvci5wYXR0ZXJuIj4KICAgICBTaW5nbGUgd29yZCBvbmx5ITwvc3Bhbj4KCiAgICAgPHR0PnRleHQgPSB7e3RleHR9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLmlucHV0LiR2YWxpZCA9IHt7bXlGb3JtLmlucHV0LiR2YWxpZH19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uaW5wdXQuJGVycm9yID0ge3tteUZvcm0uaW5wdXQuJGVycm9yfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxici8+CiAgICAgPC9mb3JtPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICB2YXIgdGV4dCA9IGVsZW1lbnQoYnkuYmluZGluZygndGV4dCcpKTsKICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndGV4dCcpKTsKCiAgICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4cGVjdCh0ZXh0LmdldFRleHQoKSkudG9Db250YWluKCdndWVzdCcpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgZW1wdHknLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0VxdWFsKCd0ZXh0ID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBtdWx0aSB3b3JkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCdoZWxsbyB3b3JsZCcpOwoKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgJ3RleHQnOiB0ZXh0SW5wdXRUeXBlLAoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBpbnB1dAogICAgICogQG5hbWUgaW5wdXRbbnVtYmVyXQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGV4dCBpbnB1dCB3aXRoIG51bWJlciB2YWxpZGF0aW9uIGFuZCB0cmFuc2Zvcm1hdGlvbi4gU2V0cyB0aGUgYG51bWJlcmAgdmFsaWRhdGlvbgogICAgICogZXJyb3IgaWYgbm90IGEgdmFsaWQgbnVtYmVyLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWluIFNldHMgdGhlIGBtaW5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGxlc3MgdGhhbiBgbWluYC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbWF4IFNldHMgdGhlIGBtYXhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBlbnRlcmVkIGlzIGdyZWF0ZXIgdGhhbiBgbWF4YC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVxdWlyZWQgU2V0cyBgcmVxdWlyZWRgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBub3QgZW50ZXJlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgICAqICAgIGByZXF1aXJlZGAgd2hlbiB5b3Ugd2FudCB0byBkYXRhLWJpbmQgdG8gdGhlIGByZXF1aXJlZGAgYXR0cmlidXRlLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgICAqICAgIG1pbmxlbmd0aC4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNYXhsZW5ndGggU2V0cyBgbWF4bGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbG9uZ2VyIHRoYW4KICAgICAqICAgIG1heGxlbmd0aC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgICAqICAgIFJlZ0V4cCBwYXR0ZXJuIGV4cHJlc3Npb24uIEV4cGVjdGVkIHZhbHVlIGlzIGAvcmVnZXhwL2AgZm9yIGlubGluZSBwYXR0ZXJucyBvciBgcmVnZXhwYCBmb3IKICAgICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgICAqICAgIGludGVyYWN0aW9uIHdpdGggdGhlIGlucHV0IGVsZW1lbnQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICA8ZXhhbXBsZSBuYW1lPSJudW1iZXItaW5wdXQtZGlyZWN0aXZlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudmFsdWUgPSAxMjsKICAgICAgICAgICB9CiAgICAgPC9zY3JpcHQ+CiAgICAgPGZvcm0gbmFtZT0ibXlGb3JtIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgICBOdW1iZXI6IDxpbnB1dCB0eXBlPSJudW1iZXIiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idmFsdWUiCiAgICAgbWluPSIwIiBtYXg9Ijk5IiByZXF1aXJlZD4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IubnVtYmVyIj4KICAgICBOb3QgdmFsaWQgbnVtYmVyITwvc3Bhbj4KICAgICA8dHQ+dmFsdWUgPSB7e3ZhbHVlfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgIDwvZm9ybT4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgdmFyIHZhbHVlID0gZWxlbWVudChieS5iaW5kaW5nKCd2YWx1ZScpKTsKICAgICB2YXIgdmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS5pbnB1dC4kdmFsaWQnKSk7CiAgICAgdmFyIGlucHV0ID0gZWxlbWVudChieS5tb2RlbCgndmFsdWUnKSk7CgogICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHBlY3QodmFsdWUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJzEyJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvRXF1YWwoJ3ZhbHVlID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBvdmVyIG1heCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnMTIzJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZS5nZXRUZXh0KCkpLnRvRXF1YWwoJ3ZhbHVlID0nKTsKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgJ251bWJlcic6IG51bWJlcklucHV0VHlwZSwKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgaW5wdXQKICAgICAqIEBuYW1lIGlucHV0W3VybF0KICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFRleHQgaW5wdXQgd2l0aCBVUkwgdmFsaWRhdGlvbi4gU2V0cyB0aGUgYHVybGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIGNvbnRlbnQgaXMgbm90IGEKICAgICAqIHZhbGlkIFVSTC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgUHJvcGVydHkgbmFtZSBvZiB0aGUgZm9ybSB1bmRlciB3aGljaCB0aGUgY29udHJvbCBpcyBwdWJsaXNoZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUmVxdWlyZWQgQWRkcyBgcmVxdWlyZWRgIGF0dHJpYnV0ZSBhbmQgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGNvbnN0cmFpbnQgdG8KICAgICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gbmdNaW5sZW5ndGggU2V0cyBgbWlubGVuZ3RoYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgc2hvcnRlciB0aGFuCiAgICAgKiAgICBtaW5sZW5ndGguCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICAgKiAgICBtYXhsZW5ndGguCiAgICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICAgKiAgICBwYXR0ZXJucyBkZWZpbmVkIGFzIHNjb3BlIGV4cHJlc3Npb25zLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGUgbmFtZT0idXJsLWlucHV0LWRpcmVjdGl2ZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnaHR0cDovL2dvb2dsZS5jb20nOwogICAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIFVSTDogPGlucHV0IHR5cGU9InVybCIgbmFtZT0iaW5wdXQiIG5nLW1vZGVsPSJ0ZXh0IiByZXF1aXJlZD4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IucmVxdWlyZWQiPgogICAgIFJlcXVpcmVkITwvc3Bhbj4KICAgICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5pbnB1dC4kZXJyb3IudXJsIj4KICAgICBOb3QgdmFsaWQgdXJsITwvc3Bhbj4KICAgICA8dHQ+dGV4dCA9IHt7dGV4dH19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uaW5wdXQuJHZhbGlkID0ge3tteUZvcm0uaW5wdXQuJHZhbGlkfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kZXJyb3IgPSB7e215Rm9ybS5pbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLiR2YWxpZCA9IHt7bXlGb3JtLiR2YWxpZH19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uJGVycm9yLnJlcXVpcmVkID0ge3shIW15Rm9ybS4kZXJyb3IucmVxdWlyZWR9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLiRlcnJvci51cmwgPSB7eyEhbXlGb3JtLiRlcnJvci51cmx9fTwvdHQ+PGJyLz4KICAgICA8L2Zvcm0+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgIHZhciB0ZXh0ID0gZWxlbWVudChieS5iaW5kaW5nKCd0ZXh0JykpOwogICAgIHZhciB2YWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKTsKICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZXh0JykpOwoKICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2h0dHA6Ly9nb29nbGUuY29tJyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnJyk7CgogICAgICAgICAgICBleHBlY3QodGV4dC5nZXRUZXh0KCkpLnRvRXF1YWwoJ3RleHQgPScpOwogICAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICB9KTsKCiAgICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIG5vdCB1cmwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5wdXQuY2xlYXIoKTsKICAgICAgICAgICAgaW5wdXQuc2VuZEtleXMoJ2JveCcpOwoKICAgICAgICAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgJ3VybCc6IHVybElucHV0VHlwZSwKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgaW5wdXQKICAgICAqIEBuYW1lIGlucHV0W2VtYWlsXQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGV4dCBpbnB1dCB3aXRoIGVtYWlsIHZhbGlkYXRpb24uIFNldHMgdGhlIGBlbWFpbGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgbm90IGEgdmFsaWQgZW1haWwKICAgICAqIGFkZHJlc3MuCiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuYW1lIFByb3BlcnR5IG5hbWUgb2YgdGhlIGZvcm0gdW5kZXIgd2hpY2ggdGhlIGNvbnRyb2wgaXMgcHVibGlzaGVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSByZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIG5vdCBlbnRlcmVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICAgKiAgICB0aGUgZWxlbWVudCB3aGVuIHRoZSBuZ1JlcXVpcmVkIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUuIFVzZSBgbmdSZXF1aXJlZGAgaW5zdGVhZCBvZgogICAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAgICogICAgbWlubGVuZ3RoLgogICAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAgICogICAgbWF4bGVuZ3RoLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1BhdHRlcm4gU2V0cyBgcGF0dGVybmAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGRvZXMgbm90IG1hdGNoIHRoZQogICAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgIDxleGFtcGxlIG5hbWU9ImVtYWlsLWlucHV0LWRpcmVjdGl2ZSI+CiAgICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICAgPHNjcmlwdD4KICAgICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnbWVAZXhhbXBsZS5jb20nOwogICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIEVtYWlsOiA8aW5wdXQgdHlwZT0iZW1haWwiIG5hbWU9ImlucHV0IiBuZy1tb2RlbD0idGV4dCIgcmVxdWlyZWQ+CiAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLnJlcXVpcmVkIj4KICAgICBSZXF1aXJlZCE8L3NwYW4+CiAgICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0uaW5wdXQuJGVycm9yLmVtYWlsIj4KICAgICBOb3QgdmFsaWQgZW1haWwhPC9zcGFuPgogICAgIDx0dD50ZXh0ID0ge3t0ZXh0fX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS5pbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5pbnB1dC4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgICA8dHQ+bXlGb3JtLmlucHV0LiRlcnJvciA9IHt7bXlGb3JtLmlucHV0LiRlcnJvcn19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uJHZhbGlkID0ge3tteUZvcm0uJHZhbGlkfX08L3R0Pjxici8+CiAgICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICAgIDx0dD5teUZvcm0uJGVycm9yLmVtYWlsID0ge3shIW15Rm9ybS4kZXJyb3IuZW1haWx9fTwvdHQ+PGJyLz4KICAgICA8L2Zvcm0+CiAgICAgPC9maWxlPgogICAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAgIHZhciB0ZXh0ID0gZWxlbWVudChieS5iaW5kaW5nKCd0ZXh0JykpOwogICAgIHZhciB2YWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLmlucHV0LiR2YWxpZCcpKTsKICAgICB2YXIgaW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZXh0JykpOwoKICAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgdG8gbW9kZWwnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXhwZWN0KHRleHQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ21lQGV4YW1wbGUuY29tJyk7CiAgICAgZXhwZWN0KHZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCd0cnVlJyk7CiAgICAgfSk7CgogICAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5jbGVhcigpOwogICAgICAgICAgICBpbnB1dC5zZW5kS2V5cygnJyk7CiAgICAgICAgICAgIGV4cGVjdCh0ZXh0LmdldFRleHQoKSkudG9FcXVhbCgndGV4dCA9Jyk7CiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwoKICAgICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbm90IGVtYWlsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlucHV0LmNsZWFyKCk7CiAgICAgICAgICAgIGlucHV0LnNlbmRLZXlzKCd4eHgnKTsKCiAgICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgICdlbWFpbCc6IGVtYWlsSW5wdXRUeXBlLAoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBpbnB1dAogICAgICogQG5hbWUgaW5wdXRbcmFkaW9dCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBIVE1MIHJhZGlvIGJ1dHRvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmdNb2RlbCBBc3NpZ25hYmxlIGFuZ3VsYXIgZXhwcmVzc2lvbiB0byBkYXRhLWJpbmQgdG8uCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdDaGFuZ2UgQW5ndWxhciBleHByZXNzaW9uIHRvIGJlIGV4ZWN1dGVkIHdoZW4gaW5wdXQgY2hhbmdlcyBkdWUgdG8gdXNlcgogICAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ1ZhbHVlIEFuZ3VsYXIgZXhwcmVzc2lvbiB3aGljaCBzZXRzIHRoZSB2YWx1ZSB0byB3aGljaCB0aGUgZXhwcmVzc2lvbiBzaG91bGQKICAgICAqICAgIGJlIHNldCB3aGVuIHNlbGVjdGVkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGUgbmFtZT0icmFkaW8taW5wdXQtZGlyZWN0aXZlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUuY29sb3IgPSAnYmx1ZSc7CiAgICAgICAgICAgICAkc2NvcGUuc3BlY2lhbFZhbHVlID0gewogICAgICAgICAgICAgICAiaWQiOiAiMTIzNDUiLAogICAgICAgICAgICAgICAidmFsdWUiOiAiZ3JlZW4iCiAgICAgICAgICAgICB9OwogICAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiB2YWx1ZT0icmVkIj4gIFJlZCA8YnIvPgogICAgIDxpbnB1dCB0eXBlPSJyYWRpbyIgbmctbW9kZWw9ImNvbG9yIiBuZy12YWx1ZT0ic3BlY2lhbFZhbHVlIj4gR3JlZW4gPGJyLz4KICAgICA8aW5wdXQgdHlwZT0icmFkaW8iIG5nLW1vZGVsPSJjb2xvciIgdmFsdWU9ImJsdWUiPiBCbHVlIDxici8+CiAgICAgPHR0PmNvbG9yID0ge3tjb2xvciB8IGpzb259fTwvdHQ+PGJyLz4KICAgICA8L2Zvcm0+CiAgICAgTm90ZSB0aGF0IGBuZy12YWx1ZT0ic3BlY2lhbFZhbHVlImAgc2V0cyByYWRpbyBpdGVtJ3MgdmFsdWUgdG8gYmUgdGhlIHZhbHVlIG9mIGAkc2NvcGUuc3BlY2lhbFZhbHVlYC4KICAgICA8L2ZpbGU+CiAgICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICAgaXQoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGNvbG9yID0gZWxlbWVudChieS5iaW5kaW5nKCdjb2xvcicpKTsKCiAgICAgICAgICAgIGV4cGVjdChjb2xvci5nZXRUZXh0KCkpLnRvQ29udGFpbignYmx1ZScpOwoKICAgICAgICAgICAgZWxlbWVudC5hbGwoYnkubW9kZWwoJ2NvbG9yJykpLmdldCgwKS5jbGljaygpOwoKICAgICAgICAgICAgZXhwZWN0KGNvbG9yLmdldFRleHQoKSkudG9Db250YWluKCdyZWQnKTsKICAgICAgICAgIH0pOwogICAgIDwvZmlsZT4KICAgICA8L2V4YW1wbGU+CiAgICAgKi8KICAgICdyYWRpbyc6IHJhZGlvSW5wdXRUeXBlLAoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBpbnB1dAogICAgICogQG5hbWUgaW5wdXRbY2hlY2tib3hdCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBIVE1MIGNoZWNrYm94LgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBuZ01vZGVsIEFzc2lnbmFibGUgYW5ndWxhciBleHByZXNzaW9uIHRvIGRhdGEtYmluZCB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdUcnVlVmFsdWUgVGhlIHZhbHVlIHRvIHdoaWNoIHRoZSBleHByZXNzaW9uIHNob3VsZCBiZSBzZXQgd2hlbiBzZWxlY3RlZC4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdGYWxzZVZhbHVlIFRoZSB2YWx1ZSB0byB3aGljaCB0aGUgZXhwcmVzc2lvbiBzaG91bGQgYmUgc2V0IHdoZW4gbm90IHNlbGVjdGVkLgogICAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgPGV4YW1wbGUgbmFtZT0iY2hlY2tib3gtaW5wdXQtZGlyZWN0aXZlIj4KICAgICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgICA8c2NyaXB0PgogICAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICAkc2NvcGUudmFsdWUxID0gdHJ1ZTsKICAgICAgICAgICAgICRzY29wZS52YWx1ZTIgPSAnWUVTJwogICAgICAgICAgIH0KICAgICA8L3NjcmlwdD4KICAgICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICAgIFZhbHVlMTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0idmFsdWUxIj4gPGJyLz4KICAgICBWYWx1ZTI6IDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9InZhbHVlMiIKICAgICBuZy10cnVlLXZhbHVlPSJZRVMiIG5nLWZhbHNlLXZhbHVlPSJOTyI+IDxici8+CiAgICAgPHR0PnZhbHVlMSA9IHt7dmFsdWUxfX08L3R0Pjxici8+CiAgICAgPHR0PnZhbHVlMiA9IHt7dmFsdWUyfX08L3R0Pjxici8+CiAgICAgPC9mb3JtPgogICAgIDwvZmlsZT4KICAgICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgICBpdCgnc2hvdWxkIGNoYW5nZSBzdGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgdmFsdWUxID0gZWxlbWVudChieS5iaW5kaW5nKCd2YWx1ZTEnKSk7CiAgICAgICAgICAgIHZhciB2YWx1ZTIgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ3ZhbHVlMicpKTsKCiAgICAgICAgICAgIGV4cGVjdCh2YWx1ZTEuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICAgICAgICAgICAgZXhwZWN0KHZhbHVlMi5nZXRUZXh0KCkpLnRvQ29udGFpbignWUVTJyk7CgogICAgICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCd2YWx1ZTEnKSkuY2xpY2soKTsKICAgICAgICAgICAgZWxlbWVudChieS5tb2RlbCgndmFsdWUyJykpLmNsaWNrKCk7CgogICAgICAgICAgICBleHBlY3QodmFsdWUxLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgICBleHBlY3QodmFsdWUyLmdldFRleHQoKSkudG9Db250YWluKCdOTycpOwogICAgICAgICAgfSk7CiAgICAgPC9maWxlPgogICAgIDwvZXhhbXBsZT4KICAgICAqLwogICAgJ2NoZWNrYm94JzogY2hlY2tib3hJbnB1dFR5cGUsCgogICAgJ2hpZGRlbic6IG5vb3AsCiAgICAnYnV0dG9uJzogbm9vcCwKICAgICdzdWJtaXQnOiBub29wLAogICAgJ3Jlc2V0Jzogbm9vcCwKICAgICdmaWxlJzogbm9vcAogIH07CgovLyBBIGhlbHBlciBmdW5jdGlvbiB0byBjYWxsICRzZXRWYWxpZGl0eSBhbmQgcmV0dXJuIHRoZSB2YWx1ZSAvIHVuZGVmaW5lZCwKLy8gYSBwYXR0ZXJuIHRoYXQgaXMgcmVwZWF0ZWQgYSBsb3QgaW4gdGhlIGlucHV0IHZhbGlkYXRpb24gbG9naWMuCiAgZnVuY3Rpb24gdmFsaWRhdGUoY3RybCwgdmFsaWRhdG9yTmFtZSwgdmFsaWRpdHksIHZhbHVlKXsKICAgIGN0cmwuJHNldFZhbGlkaXR5KHZhbGlkYXRvck5hbWUsIHZhbGlkaXR5KTsKICAgIHJldHVybiB2YWxpZGl0eSA/IHZhbHVlIDogdW5kZWZpbmVkOwogIH0KCgogIGZ1bmN0aW9uIGFkZE5hdGl2ZUh0bWw1VmFsaWRhdG9ycyhjdHJsLCB2YWxpZGF0b3JOYW1lLCBlbGVtZW50KSB7CiAgICB2YXIgdmFsaWRpdHkgPSBlbGVtZW50LnByb3AoJ3ZhbGlkaXR5Jyk7CiAgICBpZiAoaXNPYmplY3QodmFsaWRpdHkpKSB7CiAgICAgIHZhciB2YWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIC8vIERvbid0IG92ZXJ3cml0ZSBwcmV2aW91cyB2YWxpZGF0aW9uLCBkb24ndCBjb25zaWRlciB2YWx1ZU1pc3NpbmcgdG8gYXBwbHkgKG5nLXJlcXVpcmVkIGNhbgogICAgICAgIC8vIHBlcmZvcm0gdGhlIHJlcXVpcmVkIHZhbGlkYXRpb24pCiAgICAgICAgaWYgKCFjdHJsLiRlcnJvclt2YWxpZGF0b3JOYW1lXSAmJiAodmFsaWRpdHkuYmFkSW5wdXQgfHwgdmFsaWRpdHkuY3VzdG9tRXJyb3IgfHwKICAgICAgICAgIHZhbGlkaXR5LnR5cGVNaXNtYXRjaCkgJiYgIXZhbGlkaXR5LnZhbHVlTWlzc2luZykgewogICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkodmFsaWRhdG9yTmFtZSwgZmFsc2UpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH07CiAgICAgIGN0cmwuJHBhcnNlcnMucHVzaCh2YWxpZGF0b3IpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdGV4dElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgICB2YXIgdmFsaWRpdHkgPSBlbGVtZW50LnByb3AoJ3ZhbGlkaXR5Jyk7CiAgICB2YXIgcGxhY2Vob2xkZXIgPSBlbGVtZW50WzBdLnBsYWNlaG9sZGVyLCBub2V2ZW50ID0ge307CgogICAgLy8gSW4gY29tcG9zaXRpb24gbW9kZSwgdXNlcnMgYXJlIHN0aWxsIGlucHV0aW5nIGludGVybWVkaWF0ZSB0ZXh0IGJ1ZmZlciwKICAgIC8vIGhvbGQgdGhlIGxpc3RlbmVyIHVudGlsIGNvbXBvc2l0aW9uIGlzIGRvbmUuCiAgICAvLyBNb3JlIGFib3V0IGNvbXBvc2l0aW9uIGV2ZW50czogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0NvbXBvc2l0aW9uRXZlbnQKICAgIGlmICghJHNuaWZmZXIuYW5kcm9pZCkgewogICAgICB2YXIgY29tcG9zaW5nID0gZmFsc2U7CgogICAgICBlbGVtZW50Lm9uKCdjb21wb3NpdGlvbnN0YXJ0JywgZnVuY3Rpb24oZGF0YSkgewogICAgICAgIGNvbXBvc2luZyA9IHRydWU7CiAgICAgIH0pOwoKICAgICAgZWxlbWVudC5vbignY29tcG9zaXRpb25lbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICBjb21wb3NpbmcgPSBmYWxzZTsKICAgICAgICBsaXN0ZW5lcigpOwogICAgICB9KTsKICAgIH0KCiAgICB2YXIgbGlzdGVuZXIgPSBmdW5jdGlvbihldikgewogICAgICBpZiAoY29tcG9zaW5nKSByZXR1cm47CiAgICAgIHZhciB2YWx1ZSA9IGVsZW1lbnQudmFsKCk7CgogICAgICAvLyBJRSAoMTEgYW5kIHVuZGVyKSBzZWVtIHRvIGVtaXQgYW4gJ2lucHV0JyBldmVudCBpZiB0aGUgcGxhY2Vob2xkZXIgdmFsdWUgY2hhbmdlcy4KICAgICAgLy8gV2UgZG9uJ3Qgd2FudCB0byBkaXJ0eSB0aGUgdmFsdWUgd2hlbiB0aGlzIGhhcHBlbnMsIHNvIHdlIGFib3J0IGhlcmUuIFVuZm9ydHVuYXRlbHksCiAgICAgIC8vIElFIGFsc28gc2VuZHMgaW5wdXQgZXZlbnRzIGZvciBvdGhlciBub24taW5wdXQtcmVsYXRlZCB0aGluZ3MsIChzdWNoIGFzIGZvY3VzaW5nIG9uIGEKICAgICAgLy8gZm9ybSBjb250cm9sKSwgc28gdGhpcyBjaGFuZ2UgaXMgbm90IGVudGlyZWx5IGVub3VnaCB0byBzb2x2ZSB0aGlzLgogICAgICBpZiAobXNpZSAmJiAoZXYgfHwgbm9ldmVudCkudHlwZSA9PT0gJ2lucHV0JyAmJiBlbGVtZW50WzBdLnBsYWNlaG9sZGVyICE9PSBwbGFjZWhvbGRlcikgewogICAgICAgIHBsYWNlaG9sZGVyID0gZWxlbWVudFswXS5wbGFjZWhvbGRlcjsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIEJ5IGRlZmF1bHQgd2Ugd2lsbCB0cmltIHRoZSB2YWx1ZQogICAgICAvLyBJZiB0aGUgYXR0cmlidXRlIG5nLXRyaW0gZXhpc3RzIHdlIHdpbGwgYXZvaWQgdHJpbW1pbmcKICAgICAgLy8gZS5nLiA8aW5wdXQgbmctbW9kZWw9ImZvbyIgbmctdHJpbT0iZmFsc2UiPgogICAgICBpZiAodG9Cb29sZWFuKGF0dHIubmdUcmltIHx8ICdUJykpIHsKICAgICAgICB2YWx1ZSA9IHRyaW0odmFsdWUpOwogICAgICB9CgogICAgICBpZiAoY3RybC4kdmlld1ZhbHVlICE9PSB2YWx1ZSB8fAogICAgICAgIC8vIElmIHRoZSB2YWx1ZSBpcyBzdGlsbCBlbXB0eS9mYWxzeSwgYW5kIHRoZXJlIGlzIG5vIGByZXF1aXJlZGAgZXJyb3IsIHJ1biB2YWxpZGF0b3JzCiAgICAgICAgLy8gYWdhaW4uIFRoaXMgZW5hYmxlcyBIVE1MNSBjb25zdHJhaW50IHZhbGlkYXRpb24gZXJyb3JzIHRvIGFmZmVjdCBBbmd1bGFyIHZhbGlkYXRpb24KICAgICAgICAvLyBldmVuIHdoZW4gdGhlIGZpcnN0IGNoYXJhY3RlciBlbnRlcmVkIGNhdXNlcyBhbiBlcnJvci4KICAgICAgICAodmFsaWRpdHkgJiYgdmFsdWUgPT09ICcnICYmICF2YWxpZGl0eS52YWx1ZU1pc3NpbmcpKSB7CiAgICAgICAgaWYgKHNjb3BlLiQkcGhhc2UpIHsKICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZSh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICAvLyBpZiB0aGUgYnJvd3NlciBkb2VzIHN1cHBvcnQgImlucHV0IiBldmVudCwgd2UgYXJlIGZpbmUgLSBleGNlcHQgb24gSUU5IHdoaWNoIGRvZXNuJ3QgZmlyZSB0aGUKICAgIC8vIGlucHV0IGV2ZW50IG9uIGJhY2tzcGFjZSwgZGVsZXRlIG9yIGN1dAogICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdpbnB1dCcpKSB7CiAgICAgIGVsZW1lbnQub24oJ2lucHV0JywgbGlzdGVuZXIpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIHRpbWVvdXQ7CgogICAgICB2YXIgZGVmZXJMaXN0ZW5lciA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGltZW91dCkgewogICAgICAgICAgdGltZW91dCA9ICRicm93c2VyLmRlZmVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsaXN0ZW5lcigpOwogICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGVsZW1lbnQub24oJ2tleWRvd24nLCBmdW5jdGlvbihldmVudCkgewogICAgICAgIHZhciBrZXkgPSBldmVudC5rZXlDb2RlOwoKICAgICAgICAvLyBpZ25vcmUKICAgICAgICAvLyAgICBjb21tYW5kICAgICAgICAgICAgbW9kaWZpZXJzICAgICAgICAgICAgICAgICAgIGFycm93cwogICAgICAgIGlmIChrZXkgPT09IDkxIHx8ICgxNSA8IGtleSAmJiBrZXkgPCAxOSkgfHwgKDM3IDw9IGtleSAmJiBrZXkgPD0gNDApKSByZXR1cm47CgogICAgICAgIGRlZmVyTGlzdGVuZXIoKTsKICAgICAgfSk7CgogICAgICAvLyBpZiB1c2VyIG1vZGlmaWVzIGlucHV0IHZhbHVlIHVzaW5nIGNvbnRleHQgbWVudSBpbiBJRSwgd2UgbmVlZCAicGFzdGUiIGFuZCAiY3V0IiBldmVudHMgdG8gY2F0Y2ggaXQKICAgICAgaWYgKCRzbmlmZmVyLmhhc0V2ZW50KCdwYXN0ZScpKSB7CiAgICAgICAgZWxlbWVudC5vbigncGFzdGUgY3V0JywgZGVmZXJMaXN0ZW5lcik7CiAgICAgIH0KICAgIH0KCiAgICAvLyBpZiB1c2VyIHBhc3RlIGludG8gaW5wdXQgdXNpbmcgbW91c2Ugb24gb2xkZXIgYnJvd3NlcgogICAgLy8gb3IgZm9ybSBhdXRvY29tcGxldGUgb24gbmV3ZXIgYnJvd3Nlciwgd2UgbmVlZCAiY2hhbmdlIiBldmVudCB0byBjYXRjaCBpdAogICAgZWxlbWVudC5vbignY2hhbmdlJywgbGlzdGVuZXIpOwoKICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICBlbGVtZW50LnZhbChjdHJsLiRpc0VtcHR5KGN0cmwuJHZpZXdWYWx1ZSkgPyAnJyA6IGN0cmwuJHZpZXdWYWx1ZSk7CiAgICB9OwoKICAgIC8vIHBhdHRlcm4gdmFsaWRhdG9yCiAgICB2YXIgcGF0dGVybiA9IGF0dHIubmdQYXR0ZXJuLAogICAgICBwYXR0ZXJuVmFsaWRhdG9yLAogICAgICBtYXRjaDsKCiAgICBpZiAocGF0dGVybikgewogICAgICB2YXIgdmFsaWRhdGVSZWdleCA9IGZ1bmN0aW9uKHJlZ2V4cCwgdmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ3BhdHRlcm4nLCBjdHJsLiRpc0VtcHR5KHZhbHVlKSB8fCByZWdleHAudGVzdCh2YWx1ZSksIHZhbHVlKTsKICAgICAgfTsKICAgICAgbWF0Y2ggPSBwYXR0ZXJuLm1hdGNoKC9eXC8oLiopXC8oW2dpbV0qKSQvKTsKICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgcGF0dGVybiA9IG5ldyBSZWdFeHAobWF0Y2hbMV0sIG1hdGNoWzJdKTsKICAgICAgICBwYXR0ZXJuVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiB2YWxpZGF0ZVJlZ2V4KHBhdHRlcm4sIHZhbHVlKTsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHBhdHRlcm5WYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgdmFyIHBhdHRlcm5PYmogPSBzY29wZS4kZXZhbChwYXR0ZXJuKTsKCiAgICAgICAgICBpZiAoIXBhdHRlcm5PYmogfHwgIXBhdHRlcm5PYmoudGVzdCkgewogICAgICAgICAgICB0aHJvdyBtaW5FcnIoJ25nUGF0dGVybicpKCdub3JlZ2V4cCcsCiAgICAgICAgICAgICAgJ0V4cGVjdGVkIHswfSB0byBiZSBhIFJlZ0V4cCBidXQgd2FzIHsxfS4gRWxlbWVudDogezJ9JywgcGF0dGVybiwKICAgICAgICAgICAgICBwYXR0ZXJuT2JqLCBzdGFydGluZ1RhZyhlbGVtZW50KSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsaWRhdGVSZWdleChwYXR0ZXJuT2JqLCB2YWx1ZSk7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKHBhdHRlcm5WYWxpZGF0b3IpOwogICAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGF0dGVyblZhbGlkYXRvcik7CiAgICB9CgogICAgLy8gbWluIGxlbmd0aCB2YWxpZGF0b3IKICAgIGlmIChhdHRyLm5nTWlubGVuZ3RoKSB7CiAgICAgIHZhciBtaW5sZW5ndGggPSBpbnQoYXR0ci5uZ01pbmxlbmd0aCk7CiAgICAgIHZhciBtaW5MZW5ndGhWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWxpZGF0ZShjdHJsLCAnbWlubGVuZ3RoJywgY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgdmFsdWUubGVuZ3RoID49IG1pbmxlbmd0aCwgdmFsdWUpOwogICAgICB9OwoKICAgICAgY3RybC4kcGFyc2Vycy5wdXNoKG1pbkxlbmd0aFZhbGlkYXRvcik7CiAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChtaW5MZW5ndGhWYWxpZGF0b3IpOwogICAgfQoKICAgIC8vIG1heCBsZW5ndGggdmFsaWRhdG9yCiAgICBpZiAoYXR0ci5uZ01heGxlbmd0aCkgewogICAgICB2YXIgbWF4bGVuZ3RoID0gaW50KGF0dHIubmdNYXhsZW5ndGgpOwogICAgICB2YXIgbWF4TGVuZ3RoVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ21heGxlbmd0aCcsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IHZhbHVlLmxlbmd0aCA8PSBtYXhsZW5ndGgsIHZhbHVlKTsKICAgICAgfTsKCiAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtYXhMZW5ndGhWYWxpZGF0b3IpOwogICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWF4TGVuZ3RoVmFsaWRhdG9yKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG51bWJlcklucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICAgIGN0cmwuJHBhcnNlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgZW1wdHkgPSBjdHJsLiRpc0VtcHR5KHZhbHVlKTsKICAgICAgaWYgKGVtcHR5IHx8IE5VTUJFUl9SRUdFWFAudGVzdCh2YWx1ZSkpIHsKICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbnVtYmVyJywgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIHZhbHVlID09PSAnJyA/IG51bGwgOiAoZW1wdHkgPyB2YWx1ZSA6IHBhcnNlRmxvYXQodmFsdWUpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgnbnVtYmVyJywgZmFsc2UpOwogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgIH0KICAgIH0pOwoKICAgIGFkZE5hdGl2ZUh0bWw1VmFsaWRhdG9ycyhjdHJsLCAnbnVtYmVyJywgZWxlbWVudCk7CgogICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBjdHJsLiRpc0VtcHR5KHZhbHVlKSA/ICcnIDogJycgKyB2YWx1ZTsKICAgIH0pOwoKICAgIGlmIChhdHRyLm1pbikgewogICAgICB2YXIgbWluVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgbWluID0gcGFyc2VGbG9hdChhdHRyLm1pbik7CiAgICAgICAgcmV0dXJuIHZhbGlkYXRlKGN0cmwsICdtaW4nLCBjdHJsLiRpc0VtcHR5KHZhbHVlKSB8fCB2YWx1ZSA+PSBtaW4sIHZhbHVlKTsKICAgICAgfTsKCiAgICAgIGN0cmwuJHBhcnNlcnMucHVzaChtaW5WYWxpZGF0b3IpOwogICAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2gobWluVmFsaWRhdG9yKTsKICAgIH0KCiAgICBpZiAoYXR0ci5tYXgpIHsKICAgICAgdmFyIG1heFZhbGlkYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG1heCA9IHBhcnNlRmxvYXQoYXR0ci5tYXgpOwogICAgICAgIHJldHVybiB2YWxpZGF0ZShjdHJsLCAnbWF4JywgY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgdmFsdWUgPD0gbWF4LCB2YWx1ZSk7CiAgICAgIH07CgogICAgICBjdHJsLiRwYXJzZXJzLnB1c2gobWF4VmFsaWRhdG9yKTsKICAgICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKG1heFZhbGlkYXRvcik7CiAgICB9CgogICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWxpZGF0ZShjdHJsLCAnbnVtYmVyJywgY3RybC4kaXNFbXB0eSh2YWx1ZSkgfHwgaXNOdW1iZXIodmFsdWUpLCB2YWx1ZSk7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHVybElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCwgJHNuaWZmZXIsICRicm93c2VyKSB7CiAgICB0ZXh0SW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpOwoKICAgIHZhciB1cmxWYWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsaWRhdGUoY3RybCwgJ3VybCcsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IFVSTF9SRUdFWFAudGVzdCh2YWx1ZSksIHZhbHVlKTsKICAgIH07CgogICAgY3RybC4kZm9ybWF0dGVycy5wdXNoKHVybFZhbGlkYXRvcik7CiAgICBjdHJsLiRwYXJzZXJzLnB1c2godXJsVmFsaWRhdG9yKTsKICB9CgogIGZ1bmN0aW9uIGVtYWlsSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwgJGJyb3dzZXIpIHsKICAgIHRleHRJbnB1dFR5cGUoc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwsICRzbmlmZmVyLCAkYnJvd3Nlcik7CgogICAgdmFyIGVtYWlsVmFsaWRhdG9yID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbGlkYXRlKGN0cmwsICdlbWFpbCcsIGN0cmwuJGlzRW1wdHkodmFsdWUpIHx8IEVNQUlMX1JFR0VYUC50ZXN0KHZhbHVlKSwgdmFsdWUpOwogICAgfTsKCiAgICBjdHJsLiRmb3JtYXR0ZXJzLnB1c2goZW1haWxWYWxpZGF0b3IpOwogICAgY3RybC4kcGFyc2Vycy5wdXNoKGVtYWlsVmFsaWRhdG9yKTsKICB9CgogIGZ1bmN0aW9uIHJhZGlvSW5wdXRUeXBlKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAvLyBtYWtlIHRoZSBuYW1lIHVuaXF1ZSwgaWYgbm90IGRlZmluZWQKICAgIGlmIChpc1VuZGVmaW5lZChhdHRyLm5hbWUpKSB7CiAgICAgIGVsZW1lbnQuYXR0cignbmFtZScsIG5leHRVaWQoKSk7CiAgICB9CgogICAgZWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKGVsZW1lbnRbMF0uY2hlY2tlZCkgewogICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShhdHRyLnZhbHVlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CgogICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2YWx1ZSA9IGF0dHIudmFsdWU7CiAgICAgIGVsZW1lbnRbMF0uY2hlY2tlZCA9ICh2YWx1ZSA9PSBjdHJsLiR2aWV3VmFsdWUpOwogICAgfTsKCiAgICBhdHRyLiRvYnNlcnZlKCd2YWx1ZScsIGN0cmwuJHJlbmRlcik7CiAgfQoKICBmdW5jdGlvbiBjaGVja2JveElucHV0VHlwZShzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybCkgewogICAgdmFyIHRydWVWYWx1ZSA9IGF0dHIubmdUcnVlVmFsdWUsCiAgICAgIGZhbHNlVmFsdWUgPSBhdHRyLm5nRmFsc2VWYWx1ZTsKCiAgICBpZiAoIWlzU3RyaW5nKHRydWVWYWx1ZSkpIHRydWVWYWx1ZSA9IHRydWU7CiAgICBpZiAoIWlzU3RyaW5nKGZhbHNlVmFsdWUpKSBmYWxzZVZhbHVlID0gZmFsc2U7CgogICAgZWxlbWVudC5vbignY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgIGN0cmwuJHNldFZpZXdWYWx1ZShlbGVtZW50WzBdLmNoZWNrZWQpOwogICAgICB9KTsKICAgIH0pOwoKICAgIGN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICBlbGVtZW50WzBdLmNoZWNrZWQgPSBjdHJsLiR2aWV3VmFsdWU7CiAgICB9OwoKICAgIC8vIE92ZXJyaWRlIHRoZSBzdGFuZGFyZCBgJGlzRW1wdHlgIGJlY2F1c2UgYSB2YWx1ZSBvZiBgZmFsc2VgIG1lYW5zIGVtcHR5IGluIGEgY2hlY2tib3guCiAgICBjdHJsLiRpc0VtcHR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlICE9PSB0cnVlVmFsdWU7CiAgICB9OwoKICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRydWVWYWx1ZTsKICAgIH0pOwoKICAgIGN0cmwuJHBhcnNlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPyB0cnVlVmFsdWUgOiBmYWxzZVZhbHVlOwogICAgfSk7CiAgfQoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIHRleHRhcmVhCiAgICogQHJlc3RyaWN0IEUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEhUTUwgdGV4dGFyZWEgZWxlbWVudCBjb250cm9sIHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuIFRoZSBkYXRhLWJpbmRpbmcgYW5kIHZhbGlkYXRpb24KICAgKiBwcm9wZXJ0aWVzIG9mIHRoaXMgZWxlbWVudCBhcmUgZXhhY3RseSB0aGUgc2FtZSBhcyB0aG9zZSBvZiB0aGUKICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0IGVsZW1lbnR9LgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ1JlcXVpcmVkIEFkZHMgYHJlcXVpcmVkYCBhdHRyaWJ1dGUgYW5kIGByZXF1aXJlZGAgdmFsaWRhdGlvbiBjb25zdHJhaW50IHRvCiAgICogICAgdGhlIGVsZW1lbnQgd2hlbiB0aGUgbmdSZXF1aXJlZCBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlLiBVc2UgYG5nUmVxdWlyZWRgIGluc3RlYWQgb2YKICAgKiAgICBgcmVxdWlyZWRgIHdoZW4geW91IHdhbnQgdG8gZGF0YS1iaW5kIHRvIHRoZSBgcmVxdWlyZWRgIGF0dHJpYnV0ZS4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWlubGVuZ3RoIFNldHMgYG1pbmxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIHNob3J0ZXIgdGhhbgogICAqICAgIG1pbmxlbmd0aC4KICAgKiBAcGFyYW0ge251bWJlcj19IG5nTWF4bGVuZ3RoIFNldHMgYG1heGxlbmd0aGAgdmFsaWRhdGlvbiBlcnJvciBrZXkgaWYgdGhlIHZhbHVlIGlzIGxvbmdlciB0aGFuCiAgICogICAgbWF4bGVuZ3RoLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdQYXR0ZXJuIFNldHMgYHBhdHRlcm5gIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBkb2VzIG5vdCBtYXRjaCB0aGUKICAgKiAgICBSZWdFeHAgcGF0dGVybiBleHByZXNzaW9uLiBFeHBlY3RlZCB2YWx1ZSBpcyBgL3JlZ2V4cC9gIGZvciBpbmxpbmUgcGF0dGVybnMgb3IgYHJlZ2V4cGAgZm9yCiAgICogICAgcGF0dGVybnMgZGVmaW5lZCBhcyBzY29wZSBleHByZXNzaW9ucy4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nQ2hhbmdlIEFuZ3VsYXIgZXhwcmVzc2lvbiB0byBiZSBleGVjdXRlZCB3aGVuIGlucHV0IGNoYW5nZXMgZHVlIHRvIHVzZXIKICAgKiAgICBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbnB1dCBlbGVtZW50LgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlucHV0CiAgICogQHJlc3RyaWN0IEUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEhUTUwgaW5wdXQgZWxlbWVudCBjb250cm9sIHdpdGggYW5ndWxhciBkYXRhLWJpbmRpbmcuIElucHV0IGNvbnRyb2wgZm9sbG93cyBIVE1MNSBpbnB1dCB0eXBlcwogICAqIGFuZCBwb2x5ZmlsbHMgdGhlIEhUTUw1IHZhbGlkYXRpb24gYmVoYXZpb3IgZm9yIG9sZGVyIGJyb3dzZXJzLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFNldHMgYHJlcXVpcmVkYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgaXMgbm90IGVudGVyZWQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gbmdSZXF1aXJlZCBTZXRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGlmIHNldCB0byB0cnVlCiAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01pbmxlbmd0aCBTZXRzIGBtaW5sZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBzaG9ydGVyIHRoYW4KICAgKiAgICBtaW5sZW5ndGguCiAgICogQHBhcmFtIHtudW1iZXI9fSBuZ01heGxlbmd0aCBTZXRzIGBtYXhsZW5ndGhgIHZhbGlkYXRpb24gZXJyb3Iga2V5IGlmIHRoZSB2YWx1ZSBpcyBsb25nZXIgdGhhbgogICAqICAgIG1heGxlbmd0aC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG5nUGF0dGVybiBTZXRzIGBwYXR0ZXJuYCB2YWxpZGF0aW9uIGVycm9yIGtleSBpZiB0aGUgdmFsdWUgZG9lcyBub3QgbWF0Y2ggdGhlCiAgICogICAgUmVnRXhwIHBhdHRlcm4gZXhwcmVzc2lvbi4gRXhwZWN0ZWQgdmFsdWUgaXMgYC9yZWdleHAvYCBmb3IgaW5saW5lIHBhdHRlcm5zIG9yIGByZWdleHBgIGZvcgogICAqICAgIHBhdHRlcm5zIGRlZmluZWQgYXMgc2NvcGUgZXhwcmVzc2lvbnMuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0NoYW5nZSBBbmd1bGFyIGV4cHJlc3Npb24gdG8gYmUgZXhlY3V0ZWQgd2hlbiBpbnB1dCBjaGFuZ2VzIGR1ZSB0byB1c2VyCiAgICogICAgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5wdXQgZWxlbWVudC4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG5hbWU9ImlucHV0LWRpcmVjdGl2ZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS51c2VyID0ge25hbWU6ICdndWVzdCcsIGxhc3Q6ICd2aXNpdG9yJ307CiAgICAgICAgIH0KICAgPC9zY3JpcHQ+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIDxmb3JtIG5hbWU9Im15Rm9ybSI+CiAgIFVzZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InVzZXJOYW1lIiBuZy1tb2RlbD0idXNlci5uYW1lIiByZXF1aXJlZD4KICAgPHNwYW4gY2xhc3M9ImVycm9yIiBuZy1zaG93PSJteUZvcm0udXNlck5hbWUuJGVycm9yLnJlcXVpcmVkIj4KICAgUmVxdWlyZWQhPC9zcGFuPjxicj4KICAgTGFzdCBuYW1lOiA8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0ibGFzdE5hbWUiIG5nLW1vZGVsPSJ1c2VyLmxhc3QiCiAgIG5nLW1pbmxlbmd0aD0iMyIgbmctbWF4bGVuZ3RoPSIxMCI+CiAgIDxzcGFuIGNsYXNzPSJlcnJvciIgbmctc2hvdz0ibXlGb3JtLmxhc3ROYW1lLiRlcnJvci5taW5sZW5ndGgiPgogICBUb28gc2hvcnQhPC9zcGFuPgogICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5sYXN0TmFtZS4kZXJyb3IubWF4bGVuZ3RoIj4KICAgVG9vIGxvbmchPC9zcGFuPjxicj4KICAgPC9mb3JtPgogICA8aHI+CiAgIDx0dD51c2VyID0ge3t1c2VyfX08L3R0Pjxici8+CiAgIDx0dD5teUZvcm0udXNlck5hbWUuJHZhbGlkID0ge3tteUZvcm0udXNlck5hbWUuJHZhbGlkfX08L3R0Pjxicj4KICAgPHR0Pm15Rm9ybS51c2VyTmFtZS4kZXJyb3IgPSB7e215Rm9ybS51c2VyTmFtZS4kZXJyb3J9fTwvdHQ+PGJyPgogICA8dHQ+bXlGb3JtLmxhc3ROYW1lLiR2YWxpZCA9IHt7bXlGb3JtLmxhc3ROYW1lLiR2YWxpZH19PC90dD48YnI+CiAgIDx0dD5teUZvcm0ubGFzdE5hbWUuJGVycm9yID0ge3tteUZvcm0ubGFzdE5hbWUuJGVycm9yfX08L3R0Pjxicj4KICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyPgogICA8dHQ+bXlGb3JtLiRlcnJvci5yZXF1aXJlZCA9IHt7ISFteUZvcm0uJGVycm9yLnJlcXVpcmVkfX08L3R0Pjxicj4KICAgPHR0Pm15Rm9ybS4kZXJyb3IubWlubGVuZ3RoID0ge3shIW15Rm9ybS4kZXJyb3IubWlubGVuZ3RofX08L3R0Pjxicj4KICAgPHR0Pm15Rm9ybS4kZXJyb3IubWF4bGVuZ3RoID0ge3shIW15Rm9ybS4kZXJyb3IubWF4bGVuZ3RofX08L3R0Pjxicj4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIHZhciB1c2VyID0gZWxlbWVudChieS5iaW5kaW5nKCd7e3VzZXJ9fScpKTsKICAgdmFyIHVzZXJOYW1lVmFsaWQgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215Rm9ybS51c2VyTmFtZS4kdmFsaWQnKSk7CiAgIHZhciBsYXN0TmFtZVZhbGlkID0gZWxlbWVudChieS5iaW5kaW5nKCdteUZvcm0ubGFzdE5hbWUuJHZhbGlkJykpOwogICB2YXIgbGFzdE5hbWVFcnJvciA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLmxhc3ROYW1lLiRlcnJvcicpKTsKICAgdmFyIGZvcm1WYWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLiR2YWxpZCcpKTsKICAgdmFyIHVzZXJOYW1lSW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCd1c2VyLm5hbWUnKSk7CiAgIHZhciB1c2VyTGFzdElucHV0ID0gZWxlbWVudChieS5tb2RlbCgndXNlci5sYXN0JykpOwoKICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QodXNlci5nZXRUZXh0KCkpLnRvQ29udGFpbigneyJuYW1lIjoiZ3Vlc3QiLCJsYXN0IjoidmlzaXRvciJ9Jyk7CiAgICAgICAgICBleHBlY3QodXNlck5hbWVWYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgZXhwZWN0KGZvcm1WYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgIH0pOwoKICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGVtcHR5IHdoZW4gcmVxdWlyZWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHVzZXJOYW1lSW5wdXQuY2xlYXIoKTsKICAgICAgICAgIHVzZXJOYW1lSW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyLmdldFRleHQoKSkudG9Db250YWluKCd7Imxhc3QiOiJ2aXNpdG9yIn0nKTsKICAgICAgICAgIGV4cGVjdCh1c2VyTmFtZVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGZvcm1WYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgYmUgdmFsaWQgaWYgZW1wdHkgd2hlbiBtaW4gbGVuZ3RoIGlzIHNldCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdXNlckxhc3RJbnB1dC5jbGVhcigpOwogICAgICAgICAgdXNlckxhc3RJbnB1dC5zZW5kS2V5cygnJyk7CgogICAgICAgICAgZXhwZWN0KHVzZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3sibmFtZSI6Imd1ZXN0IiwibGFzdCI6IiJ9Jyk7CiAgICAgICAgICBleHBlY3QobGFzdE5hbWVWYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgZXhwZWN0KGZvcm1WYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgIH0pOwoKICAgaXQoJ3Nob3VsZCBiZSBpbnZhbGlkIGlmIGxlc3MgdGhhbiByZXF1aXJlZCBtaW4gbGVuZ3RoJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB1c2VyTGFzdElucHV0LmNsZWFyKCk7CiAgICAgICAgICB1c2VyTGFzdElucHV0LnNlbmRLZXlzKCd4eCcpOwoKICAgICAgICAgIGV4cGVjdCh1c2VyLmdldFRleHQoKSkudG9Db250YWluKCd7Im5hbWUiOiJndWVzdCJ9Jyk7CiAgICAgICAgICBleHBlY3QobGFzdE5hbWVWYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICAgIGV4cGVjdChsYXN0TmFtZUVycm9yLmdldFRleHQoKSkudG9Db250YWluKCdtaW5sZW5ndGgnKTsKICAgICAgICAgIGV4cGVjdChmb3JtVmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgfSk7CgogICBpdCgnc2hvdWxkIGJlIGludmFsaWQgaWYgbG9uZ2VyIHRoYW4gbWF4IGxlbmd0aCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdXNlckxhc3RJbnB1dC5jbGVhcigpOwogICAgICAgICAgdXNlckxhc3RJbnB1dC5zZW5kS2V5cygnc29tZSByaWRpY3Vsb3VzbHkgbG9uZyBuYW1lJyk7CgogICAgICAgICAgZXhwZWN0KHVzZXIuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3sibmFtZSI6Imd1ZXN0In0nKTsKICAgICAgICAgIGV4cGVjdChsYXN0TmFtZVZhbGlkLmdldFRleHQoKSkudG9Db250YWluKCdmYWxzZScpOwogICAgICAgICAgZXhwZWN0KGxhc3ROYW1lRXJyb3IuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ21heGxlbmd0aCcpOwogICAgICAgICAgZXhwZWN0KGZvcm1WYWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbignZmFsc2UnKTsKICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIGlucHV0RGlyZWN0aXZlID0gWyckYnJvd3NlcicsICckc25pZmZlcicsIGZ1bmN0aW9uKCRicm93c2VyLCAkc25pZmZlcikgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIsIGN0cmwpIHsKICAgICAgICBpZiAoY3RybCkgewogICAgICAgICAgKGlucHV0VHlwZVtsb3dlcmNhc2UoYXR0ci50eXBlKV0gfHwgaW5wdXRUeXBlLnRleHQpKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkc25pZmZlciwKICAgICAgICAgICAgJGJyb3dzZXIpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XTsKCiAgdmFyIFZBTElEX0NMQVNTID0gJ25nLXZhbGlkJywKICAgIElOVkFMSURfQ0xBU1MgPSAnbmctaW52YWxpZCcsCiAgICBQUklTVElORV9DTEFTUyA9ICduZy1wcmlzdGluZScsCiAgICBESVJUWV9DTEFTUyA9ICduZy1kaXJ0eSc7CgogIC8qKgogICAqIEBuZ2RvYyB0eXBlCiAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlcgogICAqCiAgICogQHByb3BlcnR5IHtzdHJpbmd9ICR2aWV3VmFsdWUgQWN0dWFsIHN0cmluZyB2YWx1ZSBpbiB0aGUgdmlldy4KICAgKiBAcHJvcGVydHkgeyp9ICRtb2RlbFZhbHVlIFRoZSB2YWx1ZSBpbiB0aGUgbW9kZWwsIHRoYXQgdGhlIGNvbnRyb2wgaXMgYm91bmQgdG8uCiAgICogQHByb3BlcnR5IHtBcnJheS48RnVuY3Rpb24+fSAkcGFyc2VycyBBcnJheSBvZiBmdW5jdGlvbnMgdG8gZXhlY3V0ZSwgYXMgYSBwaXBlbGluZSwgd2hlbmV2ZXIKICAgdGhlIGNvbnRyb2wgcmVhZHMgdmFsdWUgZnJvbSB0aGUgRE9NLiAgRWFjaCBmdW5jdGlvbiBpcyBjYWxsZWQsIGluIHR1cm4sIHBhc3NpbmcgdGhlIHZhbHVlCiAgIHRocm91Z2ggdG8gdGhlIG5leHQuIFRoZSBsYXN0IHJldHVybiB2YWx1ZSBpcyB1c2VkIHRvIHBvcHVsYXRlIHRoZSBtb2RlbC4KICAgVXNlZCB0byBzYW5pdGl6ZSAvIGNvbnZlcnQgdGhlIHZhbHVlIGFzIHdlbGwgYXMgdmFsaWRhdGlvbi4gRm9yIHZhbGlkYXRpb24sCiAgIHRoZSBwYXJzZXJzIHNob3VsZCB1cGRhdGUgdGhlIHZhbGlkaXR5IHN0YXRlIHVzaW5nCiAgIHtAbGluayBuZ01vZGVsLk5nTW9kZWxDb250cm9sbGVyIyRzZXRWYWxpZGl0eSAkc2V0VmFsaWRpdHkoKX0sCiAgIGFuZCByZXR1cm4gYHVuZGVmaW5lZGAgZm9yIGludmFsaWQgdmFsdWVzLgoKICAgKgogICAqIEBwcm9wZXJ0eSB7QXJyYXkuPEZ1bmN0aW9uPn0gJGZvcm1hdHRlcnMgQXJyYXkgb2YgZnVuY3Rpb25zIHRvIGV4ZWN1dGUsIGFzIGEgcGlwZWxpbmUsIHdoZW5ldmVyCiAgIHRoZSBtb2RlbCB2YWx1ZSBjaGFuZ2VzLiBFYWNoIGZ1bmN0aW9uIGlzIGNhbGxlZCwgaW4gdHVybiwgcGFzc2luZyB0aGUgdmFsdWUgdGhyb3VnaCB0byB0aGUKICAgbmV4dC4gVXNlZCB0byBmb3JtYXQgLyBjb252ZXJ0IHZhbHVlcyBmb3IgZGlzcGxheSBpbiB0aGUgY29udHJvbCBhbmQgdmFsaWRhdGlvbi4KICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIGZvcm1hdHRlcih2YWx1ZSkgewogKiAgIGlmICh2YWx1ZSkgewogKiAgICAgcmV0dXJuIHZhbHVlLnRvVXBwZXJDYXNlKCk7CiAqICAgfQogKiB9CiAgICogbmdNb2RlbC4kZm9ybWF0dGVycy5wdXNoKGZvcm1hdHRlcik7CiAgICogYGBgCiAgICoKICAgKiBAcHJvcGVydHkge0FycmF5LjxGdW5jdGlvbj59ICR2aWV3Q2hhbmdlTGlzdGVuZXJzIEFycmF5IG9mIGZ1bmN0aW9ucyB0byBleGVjdXRlIHdoZW5ldmVyIHRoZQogICAqICAgICB2aWV3IHZhbHVlIGhhcyBjaGFuZ2VkLiBJdCBpcyBjYWxsZWQgd2l0aCBubyBhcmd1bWVudHMsIGFuZCBpdHMgcmV0dXJuIHZhbHVlIGlzIGlnbm9yZWQuCiAgICogICAgIFRoaXMgY2FuIGJlIHVzZWQgaW4gcGxhY2Ugb2YgYWRkaXRpb25hbCAkd2F0Y2hlcyBhZ2FpbnN0IHRoZSBtb2RlbCB2YWx1ZS4KICAgKgogICAqIEBwcm9wZXJ0eSB7T2JqZWN0fSAkZXJyb3IgQW4gb2JqZWN0IGhhc2ggd2l0aCBhbGwgZXJyb3JzIGFzIGtleXMuCiAgICoKICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRwcmlzdGluZSBUcnVlIGlmIHVzZXIgaGFzIG5vdCBpbnRlcmFjdGVkIHdpdGggdGhlIGNvbnRyb2wgeWV0LgogICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gJGRpcnR5IFRydWUgaWYgdXNlciBoYXMgYWxyZWFkeSBpbnRlcmFjdGVkIHdpdGggdGhlIGNvbnRyb2wuCiAgICogQHByb3BlcnR5IHtib29sZWFufSAkdmFsaWQgVHJ1ZSBpZiB0aGVyZSBpcyBubyBlcnJvci4KICAgKiBAcHJvcGVydHkge2Jvb2xlYW59ICRpbnZhbGlkIFRydWUgaWYgYXQgbGVhc3Qgb25lIGVycm9yIG9uIHRoZSBjb250cm9sLgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBgTmdNb2RlbENvbnRyb2xsZXJgIHByb3ZpZGVzIEFQSSBmb3IgdGhlIGBuZy1tb2RlbGAgZGlyZWN0aXZlLiBUaGUgY29udHJvbGxlciBjb250YWlucwogICAqIHNlcnZpY2VzIGZvciBkYXRhLWJpbmRpbmcsIHZhbGlkYXRpb24sIENTUyB1cGRhdGVzLCBhbmQgdmFsdWUgZm9ybWF0dGluZyBhbmQgcGFyc2luZy4gSXQKICAgKiBwdXJwb3NlZnVsbHkgZG9lcyBub3QgY29udGFpbiBhbnkgbG9naWMgd2hpY2ggZGVhbHMgd2l0aCBET00gcmVuZGVyaW5nIG9yIGxpc3RlbmluZyB0bwogICAqIERPTSBldmVudHMuIFN1Y2ggRE9NIHJlbGF0ZWQgbG9naWMgc2hvdWxkIGJlIHByb3ZpZGVkIGJ5IG90aGVyIGRpcmVjdGl2ZXMgd2hpY2ggbWFrZSB1c2Ugb2YKICAgKiBgTmdNb2RlbENvbnRyb2xsZXJgIGZvciBkYXRhLWJpbmRpbmcuCiAgICoKICAgKiAjIyBDdXN0b20gQ29udHJvbCBFeGFtcGxlCiAgICogVGhpcyBleGFtcGxlIHNob3dzIGhvdyB0byB1c2UgYE5nTW9kZWxDb250cm9sbGVyYCB3aXRoIGEgY3VzdG9tIGNvbnRyb2wgdG8gYWNoaWV2ZQogICAqIGRhdGEtYmluZGluZy4gTm90aWNlIGhvdyBkaWZmZXJlbnQgZGlyZWN0aXZlcyAoYGNvbnRlbnRlZGl0YWJsZWAsIGBuZy1tb2RlbGAsIGFuZCBgcmVxdWlyZWRgKQogICAqIGNvbGxhYm9yYXRlIHRvZ2V0aGVyIHRvIGFjaGlldmUgdGhlIGRlc2lyZWQgcmVzdWx0LgogICAqCiAgICogTm90ZSB0aGF0IGBjb250ZW50ZWRpdGFibGVgIGlzIGFuIEhUTUw1IGF0dHJpYnV0ZSwgd2hpY2ggdGVsbHMgdGhlIGJyb3dzZXIgdG8gbGV0IHRoZSBlbGVtZW50CiAgICogY29udGVudHMgYmUgZWRpdGVkIGluIHBsYWNlIGJ5IHRoZSB1c2VyLiAgVGhpcyB3aWxsIG5vdCB3b3JrIG9uIG9sZGVyIGJyb3dzZXJzLgogICAqCiAgICogV2UgYXJlIHVzaW5nIHRoZSB7QGxpbmsgbmcuc2VydmljZTokc2NlICRzY2V9IHNlcnZpY2UgaGVyZSBhbmQgaW5jbHVkZSB0aGUge0BsaW5rIG5nU2FuaXRpemUgJHNhbml0aXplfQogICAqIG1vZHVsZSB0byBhdXRvbWF0aWNhbGx5IHJlbW92ZSAiYmFkIiBjb250ZW50IGxpa2UgaW5saW5lIGV2ZW50IGxpc3RlbmVyIChlLmcuIGA8c3BhbiBvbmNsaWNrPSIuLi4iPmApLgogICAqIEhvd2V2ZXIsIGFzIHdlIGFyZSB1c2luZyBgJHNjZWAgdGhlIG1vZGVsIGNhbiBzdGlsbCBkZWNpZGUgdG8gdG8gcHJvdmlkZSB1bnNhZmUgY29udGVudCBpZiBpdCBtYXJrcwogICAqIHRoYXQgY29udGVudCB1c2luZyB0aGUgYCRzY2VgIHNlcnZpY2UuCiAgICoKICAgKiA8ZXhhbXBsZSBuYW1lPSJOZ01vZGVsQ29udHJvbGxlciIgbW9kdWxlPSJjdXN0b21Db250cm9sIiBkZXBzPSJhbmd1bGFyLXNhbml0aXplLmpzIj4KICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgW2NvbnRlbnRlZGl0YWJsZV0gewogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQtY29sb3I6IHdoaXRlOwogICAgICAgIG1pbi1oZWlnaHQ6IDIwcHg7CiAgICAgIH0KCiAgIC5uZy1pbnZhbGlkIHsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCByZWQ7CiAgICAgIH0KCiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgYW5ndWxhci5tb2R1bGUoJ2N1c3RvbUNvbnRyb2wnLCBbJ25nU2FuaXRpemUnXSkuCiAgIGRpcmVjdGl2ZSgnY29udGVudGVkaXRhYmxlJywgWyckc2NlJywgZnVuY3Rpb24oJHNjZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgcmVzdHJpY3Q6ICdBJywgLy8gb25seSBhY3RpdmF0ZSBvbiBlbGVtZW50IGF0dHJpYnV0ZQogICAgICAgICAgICByZXF1aXJlOiAnP25nTW9kZWwnLCAvLyBnZXQgYSBob2xkIG9mIE5nTW9kZWxDb250cm9sbGVyCiAgICAgICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycywgbmdNb2RlbCkgewogICAgICAgICAgICAgIGlmKCFuZ01vZGVsKSByZXR1cm47IC8vIGRvIG5vdGhpbmcgaWYgbm8gbmctbW9kZWwKCiAgICAgICAgICAgICAgLy8gU3BlY2lmeSBob3cgVUkgc2hvdWxkIGJlIHVwZGF0ZWQKICAgICAgICAgICAgICBuZ01vZGVsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuaHRtbCgkc2NlLmdldFRydXN0ZWRIdG1sKG5nTW9kZWwuJHZpZXdWYWx1ZSB8fCAnJykpOwogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIC8vIExpc3RlbiBmb3IgY2hhbmdlIGV2ZW50cyB0byBlbmFibGUgYmluZGluZwogICAgICAgICAgICAgIGVsZW1lbnQub24oJ2JsdXIga2V5dXAgY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkocmVhZCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcmVhZCgpOyAvLyBpbml0aWFsaXplCgogICAgICAgICAgICAgIC8vIFdyaXRlIGRhdGEgdG8gdGhlIG1vZGVsCiAgICAgICAgICAgICAgZnVuY3Rpb24gcmVhZCgpIHsKICAgICAgICAgICAgICAgIHZhciBodG1sID0gZWxlbWVudC5odG1sKCk7CiAgICAgICAgICAgICAgICAvLyBXaGVuIHdlIGNsZWFyIHRoZSBjb250ZW50IGVkaXRhYmxlIHRoZSBicm93c2VyIGxlYXZlcyBhIDxicj4gYmVoaW5kCiAgICAgICAgICAgICAgICAvLyBJZiBzdHJpcC1iciBhdHRyaWJ1dGUgaXMgcHJvdmlkZWQgdGhlbiB3ZSBzdHJpcCB0aGlzIG91dAogICAgICAgICAgICAgICAgaWYoIGF0dHJzLnN0cmlwQnIgJiYgaHRtbCA9PSAnPGJyPicgKSB7CiAgICAgICAgICAgICAgICAgIGh0bWwgPSAnJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5nTW9kZWwuJHNldFZpZXdWYWx1ZShodG1sKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfV0pOwogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8Zm9ybSBuYW1lPSJteUZvcm0iPgogICA8ZGl2IGNvbnRlbnRlZGl0YWJsZQogICBuYW1lPSJteVdpZGdldCIgbmctbW9kZWw9InVzZXJDb250ZW50IgogICBzdHJpcC1icj0idHJ1ZSIKICAgcmVxdWlyZWQ+Q2hhbmdlIG1lITwvZGl2PgogICA8c3BhbiBuZy1zaG93PSJteUZvcm0ubXlXaWRnZXQuJGVycm9yLnJlcXVpcmVkIj5SZXF1aXJlZCE8L3NwYW4+CiAgIDxocj4KICAgPHRleHRhcmVhIG5nLW1vZGVsPSJ1c2VyQ29udGVudCI+PC90ZXh0YXJlYT4KICAgPC9mb3JtPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGRhdGEtYmluZCBhbmQgYmVjb21lIGludmFsaWQnLCBmdW5jdGlvbigpIHsKICAgICAgaWYgKGJyb3dzZXIucGFyYW1zLmJyb3dzZXIgPT0gJ3NhZmFyaScgfHwgYnJvd3Nlci5wYXJhbXMuYnJvd3NlciA9PSAnZmlyZWZveCcpIHsKICAgICAgICAvLyBTYWZhcmlEcml2ZXIgY2FuJ3QgaGFuZGxlIGNvbnRlbnRlZGl0YWJsZQogICAgICAgIC8vIGFuZCBGaXJlZm94IGRyaXZlciBjYW4ndCBjbGVhciBjb250ZW50ZWRpdGFibGVzIHZlcnkgd2VsbAogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgY29udGVudEVkaXRhYmxlID0gZWxlbWVudChieS5jc3MoJ1tjb250ZW50ZWRpdGFibGVdJykpOwogICAgICB2YXIgY29udGVudCA9ICdDaGFuZ2UgbWUhJzsKCiAgICAgIGV4cGVjdChjb250ZW50RWRpdGFibGUuZ2V0VGV4dCgpKS50b0VxdWFsKGNvbnRlbnQpOwoKICAgICAgY29udGVudEVkaXRhYmxlLmNsZWFyKCk7CiAgICAgIGNvbnRlbnRFZGl0YWJsZS5zZW5kS2V5cyhwcm90cmFjdG9yLktleS5CQUNLX1NQQUNFKTsKICAgICAgZXhwZWN0KGNvbnRlbnRFZGl0YWJsZS5nZXRUZXh0KCkpLnRvRXF1YWwoJycpOwogICAgICBleHBlY3QoY29udGVudEVkaXRhYmxlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9NYXRjaCgvbmctaW52YWxpZC1yZXF1aXJlZC8pOwogICAgfSk7CiAgIDwvZmlsZT4KICAgKiA8L2V4YW1wbGU+CiAgICoKICAgKgogICAqLwogIHZhciBOZ01vZGVsQ29udHJvbGxlciA9IFsnJHNjb3BlJywgJyRleGNlcHRpb25IYW5kbGVyJywgJyRhdHRycycsICckZWxlbWVudCcsICckcGFyc2UnLCAnJGFuaW1hdGUnLAogICAgZnVuY3Rpb24oJHNjb3BlLCAkZXhjZXB0aW9uSGFuZGxlciwgJGF0dHIsICRlbGVtZW50LCAkcGFyc2UsICRhbmltYXRlKSB7CiAgICAgIHRoaXMuJHZpZXdWYWx1ZSA9IE51bWJlci5OYU47CiAgICAgIHRoaXMuJG1vZGVsVmFsdWUgPSBOdW1iZXIuTmFOOwogICAgICB0aGlzLiRwYXJzZXJzID0gW107CiAgICAgIHRoaXMuJGZvcm1hdHRlcnMgPSBbXTsKICAgICAgdGhpcy4kdmlld0NoYW5nZUxpc3RlbmVycyA9IFtdOwogICAgICB0aGlzLiRwcmlzdGluZSA9IHRydWU7CiAgICAgIHRoaXMuJGRpcnR5ID0gZmFsc2U7CiAgICAgIHRoaXMuJHZhbGlkID0gdHJ1ZTsKICAgICAgdGhpcy4kaW52YWxpZCA9IGZhbHNlOwogICAgICB0aGlzLiRuYW1lID0gJGF0dHIubmFtZTsKCiAgICAgIHZhciBuZ01vZGVsR2V0ID0gJHBhcnNlKCRhdHRyLm5nTW9kZWwpLAogICAgICAgIG5nTW9kZWxTZXQgPSBuZ01vZGVsR2V0LmFzc2lnbjsKCiAgICAgIGlmICghbmdNb2RlbFNldCkgewogICAgICAgIHRocm93IG1pbkVycignbmdNb2RlbCcpKCdub25hc3NpZ24nLCAiRXhwcmVzc2lvbiAnezB9JyBpcyBub24tYXNzaWduYWJsZS4gRWxlbWVudDogezF9IiwKICAgICAgICAgICRhdHRyLm5nTW9kZWwsIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICAgIH0KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHJlbmRlcgogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogQ2FsbGVkIHdoZW4gdGhlIHZpZXcgbmVlZHMgdG8gYmUgdXBkYXRlZC4gSXQgaXMgZXhwZWN0ZWQgdGhhdCB0aGUgdXNlciBvZiB0aGUgbmctbW9kZWwKICAgICAgICogZGlyZWN0aXZlIHdpbGwgaW1wbGVtZW50IHRoaXMgbWV0aG9kLgogICAgICAgKi8KICAgICAgdGhpcy4kcmVuZGVyID0gbm9vcDsKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJGlzRW1wdHkKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFRoaXMgaXMgY2FsbGVkIHdoZW4gd2UgbmVlZCB0byBkZXRlcm1pbmUgaWYgdGhlIHZhbHVlIG9mIHRoZSBpbnB1dCBpcyBlbXB0eS4KICAgICAgICoKICAgICAgICogRm9yIGluc3RhbmNlLCB0aGUgcmVxdWlyZWQgZGlyZWN0aXZlIGRvZXMgdGhpcyB0byB3b3JrIG91dCBpZiB0aGUgaW5wdXQgaGFzIGRhdGEgb3Igbm90LgogICAgICAgKiBUaGUgZGVmYXVsdCBgJGlzRW1wdHlgIGZ1bmN0aW9uIGNoZWNrcyB3aGV0aGVyIHRoZSB2YWx1ZSBpcyBgdW5kZWZpbmVkYCwgYCcnYCwgYG51bGxgIG9yIGBOYU5gLgogICAgICAgKgogICAgICAgKiBZb3UgY2FuIG92ZXJyaWRlIHRoaXMgZm9yIGlucHV0IGRpcmVjdGl2ZXMgd2hvc2UgY29uY2VwdCBvZiBiZWluZyBlbXB0eSBpcyBkaWZmZXJlbnQgdG8gdGhlCiAgICAgICAqIGRlZmF1bHQuIFRoZSBgY2hlY2tib3hJbnB1dFR5cGVgIGRpcmVjdGl2ZSBkb2VzIHRoaXMgYmVjYXVzZSBpbiBpdHMgY2FzZSBhIHZhbHVlIG9mIGBmYWxzZWAKICAgICAgICogaW1wbGllcyBlbXB0eS4KICAgICAgICoKICAgICAgICogQHBhcmFtIHsqfSB2YWx1ZSBSZWZlcmVuY2UgdG8gY2hlY2suCiAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIGB2YWx1ZWAgaXMgZW1wdHkuCiAgICAgICAqLwogICAgICB0aGlzLiRpc0VtcHR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gaXNVbmRlZmluZWQodmFsdWUpIHx8IHZhbHVlID09PSAnJyB8fCB2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSAhPT0gdmFsdWU7CiAgICAgIH07CgogICAgICB2YXIgcGFyZW50Rm9ybSA9ICRlbGVtZW50LmluaGVyaXRlZERhdGEoJyRmb3JtQ29udHJvbGxlcicpIHx8IG51bGxGb3JtQ3RybCwKICAgICAgICBpbnZhbGlkQ291bnQgPSAwLCAvLyB1c2VkIHRvIGVhc2lseSBkZXRlcm1pbmUgaWYgd2UgYXJlIHZhbGlkCiAgICAgICAgJGVycm9yID0gdGhpcy4kZXJyb3IgPSB7fTsgLy8ga2VlcCBpbnZhbGlkIGtleXMgaGVyZQoKCiAgICAgIC8vIFNldHVwIGluaXRpYWwgc3RhdGUgb2YgdGhlIGNvbnRyb2wKICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoUFJJU1RJTkVfQ0xBU1MpOwogICAgICB0b2dnbGVWYWxpZENzcyh0cnVlKTsKCiAgICAgIC8vIGNvbnZlbmllbmNlIG1ldGhvZCBmb3IgZWFzeSB0b2dnbGluZyBvZiBjbGFzc2VzCiAgICAgIGZ1bmN0aW9uIHRvZ2dsZVZhbGlkQ3NzKGlzVmFsaWQsIHZhbGlkYXRpb25FcnJvcktleSkgewogICAgICAgIHZhbGlkYXRpb25FcnJvcktleSA9IHZhbGlkYXRpb25FcnJvcktleSA/ICctJyArIHNuYWtlX2Nhc2UodmFsaWRhdGlvbkVycm9yS2V5LCAnLScpIDogJyc7CiAgICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoJGVsZW1lbnQsIChpc1ZhbGlkID8gSU5WQUxJRF9DTEFTUyA6IFZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3MoJGVsZW1lbnQsIChpc1ZhbGlkID8gVkFMSURfQ0xBU1MgOiBJTlZBTElEX0NMQVNTKSArIHZhbGlkYXRpb25FcnJvcktleSk7CiAgICAgIH0KCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAqIEBuYW1lIG5nTW9kZWwuTmdNb2RlbENvbnRyb2xsZXIjJHNldFZhbGlkaXR5CiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBDaGFuZ2UgdGhlIHZhbGlkaXR5IHN0YXRlLCBhbmQgbm90aWZpZXMgdGhlIGZvcm0gd2hlbiB0aGUgY29udHJvbCBjaGFuZ2VzIHZhbGlkaXR5LiAoaS5lLiBpdAogICAgICAgKiBkb2VzIG5vdCBub3RpZnkgZm9ybSBpZiBnaXZlbiB2YWxpZGF0b3IgaXMgYWxyZWFkeSBtYXJrZWQgYXMgaW52YWxpZCkuCiAgICAgICAqCiAgICAgICAqIFRoaXMgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgYnkgdmFsaWRhdG9ycyAtIGkuZS4gdGhlIHBhcnNlciBvciBmb3JtYXR0ZXIgZnVuY3Rpb25zLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsaWRhdGlvbkVycm9yS2V5IE5hbWUgb2YgdGhlIHZhbGlkYXRvci4gdGhlIGB2YWxpZGF0aW9uRXJyb3JLZXlgIHdpbGwgYXNzaWduCiAgICAgICAqICAgICAgICB0byBgJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV09aXNWYWxpZGAgc28gdGhhdCBpdCBpcyBhdmFpbGFibGUgZm9yIGRhdGEtYmluZGluZy4KICAgICAgICogICAgICAgIFRoZSBgdmFsaWRhdGlvbkVycm9yS2V5YCBzaG91bGQgYmUgaW4gY2FtZWxDYXNlIGFuZCB3aWxsIGdldCBjb252ZXJ0ZWQgaW50byBkYXNoLWNhc2UKICAgICAgICogICAgICAgIGZvciBjbGFzcyBuYW1lLiBFeGFtcGxlOiBgbXlFcnJvcmAgd2lsbCByZXN1bHQgaW4gYG5nLXZhbGlkLW15LWVycm9yYCBhbmQgYG5nLWludmFsaWQtbXktZXJyb3JgCiAgICAgICAqICAgICAgICBjbGFzcyBhbmQgY2FuIGJlIGJvdW5kIHRvIGFzICBge3tzb21lRm9ybS5zb21lQ29udHJvbC4kZXJyb3IubXlFcnJvcn19YCAuCiAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNWYWxpZCBXaGV0aGVyIHRoZSBjdXJyZW50IHN0YXRlIGlzIHZhbGlkICh0cnVlKSBvciBpbnZhbGlkIChmYWxzZSkuCiAgICAgICAqLwogICAgICB0aGlzLiRzZXRWYWxpZGl0eSA9IGZ1bmN0aW9uKHZhbGlkYXRpb25FcnJvcktleSwgaXNWYWxpZCkgewogICAgICAgIC8vIFB1cnBvc2VmdWwgdXNlIG9mICEgaGVyZSB0byBjYXN0IGlzVmFsaWQgdG8gYm9vbGVhbiBpbiBjYXNlIGl0IGlzIHVuZGVmaW5lZAogICAgICAgIC8vIGpzaGludCAtVzAxOAogICAgICAgIGlmICgkZXJyb3JbdmFsaWRhdGlvbkVycm9yS2V5XSA9PT0gIWlzVmFsaWQpIHJldHVybjsKICAgICAgICAvLyBqc2hpbnQgK1cwMTgKCiAgICAgICAgaWYgKGlzVmFsaWQpIHsKICAgICAgICAgIGlmICgkZXJyb3JbdmFsaWRhdGlvbkVycm9yS2V5XSkgaW52YWxpZENvdW50LS07CiAgICAgICAgICBpZiAoIWludmFsaWRDb3VudCkgewogICAgICAgICAgICB0b2dnbGVWYWxpZENzcyh0cnVlKTsKICAgICAgICAgICAgdGhpcy4kdmFsaWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLiRpbnZhbGlkID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRvZ2dsZVZhbGlkQ3NzKGZhbHNlKTsKICAgICAgICAgIHRoaXMuJGludmFsaWQgPSB0cnVlOwogICAgICAgICAgdGhpcy4kdmFsaWQgPSBmYWxzZTsKICAgICAgICAgIGludmFsaWRDb3VudCsrOwogICAgICAgIH0KCiAgICAgICAgJGVycm9yW3ZhbGlkYXRpb25FcnJvcktleV0gPSAhaXNWYWxpZDsKICAgICAgICB0b2dnbGVWYWxpZENzcyhpc1ZhbGlkLCB2YWxpZGF0aW9uRXJyb3JLZXkpOwoKICAgICAgICBwYXJlbnRGb3JtLiRzZXRWYWxpZGl0eSh2YWxpZGF0aW9uRXJyb3JLZXksIGlzVmFsaWQsIHRoaXMpOwogICAgICB9OwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0UHJpc3RpbmUKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIFNldHMgdGhlIGNvbnRyb2wgdG8gaXRzIHByaXN0aW5lIHN0YXRlLgogICAgICAgKgogICAgICAgKiBUaGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIHJlbW92ZSB0aGUgJ25nLWRpcnR5JyBjbGFzcyBhbmQgc2V0IHRoZSBjb250cm9sIHRvIGl0cyBwcmlzdGluZQogICAgICAgKiBzdGF0ZSAobmctcHJpc3RpbmUgY2xhc3MpLgogICAgICAgKi8KICAgICAgdGhpcy4kc2V0UHJpc3RpbmUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy4kZGlydHkgPSBmYWxzZTsKICAgICAgICB0aGlzLiRwcmlzdGluZSA9IHRydWU7CiAgICAgICAgJGFuaW1hdGUucmVtb3ZlQ2xhc3MoJGVsZW1lbnQsIERJUlRZX0NMQVNTKTsKICAgICAgICAkYW5pbWF0ZS5hZGRDbGFzcygkZWxlbWVudCwgUFJJU1RJTkVfQ0xBU1MpOwogICAgICB9OwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciMkc2V0Vmlld1ZhbHVlCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBVcGRhdGUgdGhlIHZpZXcgdmFsdWUuCiAgICAgICAqCiAgICAgICAqIFRoaXMgbWV0aG9kIHNob3VsZCBiZSBjYWxsZWQgd2hlbiB0aGUgdmlldyB2YWx1ZSBjaGFuZ2VzLCB0eXBpY2FsbHkgZnJvbSB3aXRoaW4gYSBET00gZXZlbnQgaGFuZGxlci4KICAgICAgICogRm9yIGV4YW1wbGUge0BsaW5rIG5nLmRpcmVjdGl2ZTppbnB1dCBpbnB1dH0gYW5kCiAgICAgICAqIHtAbGluayBuZy5kaXJlY3RpdmU6c2VsZWN0IHNlbGVjdH0gZGlyZWN0aXZlcyBjYWxsIGl0LgogICAgICAgKgogICAgICAgKiBJdCB3aWxsIHVwZGF0ZSB0aGUgJHZpZXdWYWx1ZSwgdGhlbiBwYXNzIHRoaXMgdmFsdWUgdGhyb3VnaCBlYWNoIG9mIHRoZSBmdW5jdGlvbnMgaW4gYCRwYXJzZXJzYCwKICAgICAgICogd2hpY2ggaW5jbHVkZXMgYW55IHZhbGlkYXRvcnMuIFRoZSB2YWx1ZSB0aGF0IGNvbWVzIG91dCBvZiB0aGlzIGAkcGFyc2Vyc2AgcGlwZWxpbmUsIGJlIGFwcGxpZWQgdG8KICAgICAgICogYCRtb2RlbFZhbHVlYCBhbmQgdGhlICoqZXhwcmVzc2lvbioqIHNwZWNpZmllZCBpbiB0aGUgYG5nLW1vZGVsYCBhdHRyaWJ1dGUuCiAgICAgICAqCiAgICAgICAqIExhc3RseSwgYWxsIHRoZSByZWdpc3RlcmVkIGNoYW5nZSBsaXN0ZW5lcnMsIGluIHRoZSBgJHZpZXdDaGFuZ2VMaXN0ZW5lcnNgIGxpc3QsIGFyZSBjYWxsZWQuCiAgICAgICAqCiAgICAgICAqIE5vdGUgdGhhdCBjYWxsaW5nIHRoaXMgZnVuY3Rpb24gZG9lcyBub3QgdHJpZ2dlciBhIGAkZGlnZXN0YC4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIFZhbHVlIGZyb20gdGhlIHZpZXcuCiAgICAgICAqLwogICAgICB0aGlzLiRzZXRWaWV3VmFsdWUgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMuJHZpZXdWYWx1ZSA9IHZhbHVlOwoKICAgICAgICAvLyBjaGFuZ2UgdG8gZGlydHkKICAgICAgICBpZiAodGhpcy4kcHJpc3RpbmUpIHsKICAgICAgICAgIHRoaXMuJGRpcnR5ID0gdHJ1ZTsKICAgICAgICAgIHRoaXMuJHByaXN0aW5lID0gZmFsc2U7CiAgICAgICAgICAkYW5pbWF0ZS5yZW1vdmVDbGFzcygkZWxlbWVudCwgUFJJU1RJTkVfQ0xBU1MpOwogICAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3MoJGVsZW1lbnQsIERJUlRZX0NMQVNTKTsKICAgICAgICAgIHBhcmVudEZvcm0uJHNldERpcnR5KCk7CiAgICAgICAgfQoKICAgICAgICBmb3JFYWNoKHRoaXMuJHBhcnNlcnMsIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICB2YWx1ZSA9IGZuKHZhbHVlKTsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKHRoaXMuJG1vZGVsVmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICB0aGlzLiRtb2RlbFZhbHVlID0gdmFsdWU7CiAgICAgICAgICBuZ01vZGVsU2V0KCRzY29wZSwgdmFsdWUpOwogICAgICAgICAgZm9yRWFjaCh0aGlzLiR2aWV3Q2hhbmdlTGlzdGVuZXJzLCBmdW5jdGlvbihsaXN0ZW5lcikgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGxpc3RlbmVyKCk7CiAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICRleGNlcHRpb25IYW5kbGVyKGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CgogICAgICAvLyBtb2RlbCAtPiB2YWx1ZQogICAgICB2YXIgY3RybCA9IHRoaXM7CgogICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uIG5nTW9kZWxXYXRjaCgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBuZ01vZGVsR2V0KCRzY29wZSk7CgogICAgICAgIC8vIGlmIHNjb3BlIG1vZGVsIHZhbHVlIGFuZCBuZ01vZGVsIHZhbHVlIGFyZSBvdXQgb2Ygc3luYwogICAgICAgIGlmIChjdHJsLiRtb2RlbFZhbHVlICE9PSB2YWx1ZSkgewoKICAgICAgICAgIHZhciBmb3JtYXR0ZXJzID0gY3RybC4kZm9ybWF0dGVycywKICAgICAgICAgICAgaWR4ID0gZm9ybWF0dGVycy5sZW5ndGg7CgogICAgICAgICAgY3RybC4kbW9kZWxWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgd2hpbGUoaWR4LS0pIHsKICAgICAgICAgICAgdmFsdWUgPSBmb3JtYXR0ZXJzW2lkeF0odmFsdWUpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChjdHJsLiR2aWV3VmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIGN0cmwuJHZpZXdWYWx1ZSA9IHZhbHVlOwogICAgICAgICAgICBjdHJsLiRyZW5kZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfSk7CiAgICB9XTsKCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ01vZGVsCiAgICoKICAgKiBAZWxlbWVudCBpbnB1dAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGBuZ01vZGVsYCBkaXJlY3RpdmUgYmluZHMgYW4gYGlucHV0YCxgc2VsZWN0YCwgYHRleHRhcmVhYCAob3IgY3VzdG9tIGZvcm0gY29udHJvbCkgdG8gYQogICAqIHByb3BlcnR5IG9uIHRoZSBzY29wZSB1c2luZyB7QGxpbmsgbmdNb2RlbC5OZ01vZGVsQ29udHJvbGxlciBOZ01vZGVsQ29udHJvbGxlcn0sCiAgICogd2hpY2ggaXMgY3JlYXRlZCBhbmQgZXhwb3NlZCBieSB0aGlzIGRpcmVjdGl2ZS4KICAgKgogICAqIGBuZ01vZGVsYCBpcyByZXNwb25zaWJsZSBmb3I6CiAgICoKICAgKiAtIEJpbmRpbmcgdGhlIHZpZXcgaW50byB0aGUgbW9kZWwsIHdoaWNoIG90aGVyIGRpcmVjdGl2ZXMgc3VjaCBhcyBgaW5wdXRgLCBgdGV4dGFyZWFgIG9yIGBzZWxlY3RgCiAgICogICByZXF1aXJlLgogICAqIC0gUHJvdmlkaW5nIHZhbGlkYXRpb24gYmVoYXZpb3IgKGkuZS4gcmVxdWlyZWQsIG51bWJlciwgZW1haWwsIHVybCkuCiAgICogLSBLZWVwaW5nIHRoZSBzdGF0ZSBvZiB0aGUgY29udHJvbCAodmFsaWQvaW52YWxpZCwgZGlydHkvcHJpc3RpbmUsIHZhbGlkYXRpb24gZXJyb3JzKS4KICAgKiAtIFNldHRpbmcgcmVsYXRlZCBjc3MgY2xhc3NlcyBvbiB0aGUgZWxlbWVudCAoYG5nLXZhbGlkYCwgYG5nLWludmFsaWRgLCBgbmctZGlydHlgLCBgbmctcHJpc3RpbmVgKSBpbmNsdWRpbmcgYW5pbWF0aW9ucy4KICAgKiAtIFJlZ2lzdGVyaW5nIHRoZSBjb250cm9sIHdpdGggaXRzIHBhcmVudCB7QGxpbmsgbmcuZGlyZWN0aXZlOmZvcm0gZm9ybX0uCiAgICoKICAgKiBOb3RlOiBgbmdNb2RlbGAgd2lsbCB0cnkgdG8gYmluZCB0byB0aGUgcHJvcGVydHkgZ2l2ZW4gYnkgZXZhbHVhdGluZyB0aGUgZXhwcmVzc2lvbiBvbiB0aGUKICAgKiBjdXJyZW50IHNjb3BlLiBJZiB0aGUgcHJvcGVydHkgZG9lc24ndCBhbHJlYWR5IGV4aXN0IG9uIHRoaXMgc2NvcGUsIGl0IHdpbGwgYmUgY3JlYXRlZAogICAqIGltcGxpY2l0bHkgYW5kIGFkZGVkIHRvIHRoZSBzY29wZS4KICAgKgogICAqIEZvciBiZXN0IHByYWN0aWNlcyBvbiB1c2luZyBgbmdNb2RlbGAsIHNlZToKICAgKgogICAqICAtIFtodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL3dpa2kvVW5kZXJzdGFuZGluZy1TY29wZXNdCiAgICoKICAgKiBGb3IgYmFzaWMgZXhhbXBsZXMsIGhvdyB0byB1c2UgYG5nTW9kZWxgLCBzZWU6CiAgICoKICAgKiAgLSB7QGxpbmsgbmcuZGlyZWN0aXZlOmlucHV0IGlucHV0fQogICAqICAgIC0ge0BsaW5rIGlucHV0W3RleHRdIHRleHR9CiAgICogICAgLSB7QGxpbmsgaW5wdXRbY2hlY2tib3hdIGNoZWNrYm94fQogICAqICAgIC0ge0BsaW5rIGlucHV0W3JhZGlvXSByYWRpb30KICAgKiAgICAtIHtAbGluayBpbnB1dFtudW1iZXJdIG51bWJlcn0KICAgKiAgICAtIHtAbGluayBpbnB1dFtlbWFpbF0gZW1haWx9CiAgICogICAgLSB7QGxpbmsgaW5wdXRbdXJsXSB1cmx9CiAgICogIC0ge0BsaW5rIG5nLmRpcmVjdGl2ZTpzZWxlY3Qgc2VsZWN0fQogICAqICAtIHtAbGluayBuZy5kaXJlY3RpdmU6dGV4dGFyZWEgdGV4dGFyZWF9CiAgICoKICAgKiAjIENTUyBjbGFzc2VzCiAgICogVGhlIGZvbGxvd2luZyBDU1MgY2xhc3NlcyBhcmUgYWRkZWQgYW5kIHJlbW92ZWQgb24gdGhlIGFzc29jaWF0ZWQgaW5wdXQvc2VsZWN0L3RleHRhcmVhIGVsZW1lbnQKICAgKiBkZXBlbmRpbmcgb24gdGhlIHZhbGlkaXR5IG9mIHRoZSBtb2RlbC4KICAgKgogICAqICAtIGBuZy12YWxpZGAgaXMgc2V0IGlmIHRoZSBtb2RlbCBpcyB2YWxpZC4KICAgKiAgLSBgbmctaW52YWxpZGAgaXMgc2V0IGlmIHRoZSBtb2RlbCBpcyBpbnZhbGlkLgogICAqICAtIGBuZy1wcmlzdGluZWAgaXMgc2V0IGlmIHRoZSBtb2RlbCBpcyBwcmlzdGluZS4KICAgKiAgLSBgbmctZGlydHlgIGlzIHNldCBpZiB0aGUgbW9kZWwgaXMgZGlydHkuCiAgICoKICAgKiBLZWVwIGluIG1pbmQgdGhhdCBuZ0FuaW1hdGUgY2FuIGRldGVjdCBlYWNoIG9mIHRoZXNlIGNsYXNzZXMgd2hlbiBhZGRlZCBhbmQgcmVtb3ZlZC4KICAgKgogICAqICMjIEFuaW1hdGlvbiBIb29rcwogICAqCiAgICogQW5pbWF0aW9ucyB3aXRoaW4gbW9kZWxzIGFyZSB0cmlnZ2VyZWQgd2hlbiBhbnkgb2YgdGhlIGFzc29jaWF0ZWQgQ1NTIGNsYXNzZXMgYXJlIGFkZGVkIGFuZCByZW1vdmVkCiAgICogb24gdGhlIGlucHV0IGVsZW1lbnQgd2hpY2ggaXMgYXR0YWNoZWQgdG8gdGhlIG1vZGVsLiBUaGVzZSBjbGFzc2VzIGFyZTogYC5uZy1wcmlzdGluZWAsIGAubmctZGlydHlgLAogICAqIGAubmctaW52YWxpZGAgYW5kIGAubmctdmFsaWRgIGFzIHdlbGwgYXMgYW55IG90aGVyIHZhbGlkYXRpb25zIHRoYXQgYXJlIHBlcmZvcm1lZCBvbiB0aGUgbW9kZWwgaXRzZWxmLgogICAqIFRoZSBhbmltYXRpb25zIHRoYXQgYXJlIHRyaWdnZXJlZCB3aXRoaW4gbmdNb2RlbCBhcmUgc2ltaWxhciB0byBob3cgdGhleSB3b3JrIGluIG5nQ2xhc3MgYW5kCiAgICogYW5pbWF0aW9ucyBjYW4gYmUgaG9va2VkIGludG8gdXNpbmcgQ1NTIHRyYW5zaXRpb25zLCBrZXlmcmFtZXMgYXMgd2VsbCBhcyBKUyBhbmltYXRpb25zLgogICAqCiAgICogVGhlIGZvbGxvd2luZyBleGFtcGxlIHNob3dzIGEgc2ltcGxlIHdheSB0byB1dGlsaXplIENTUyB0cmFuc2l0aW9ucyB0byBzdHlsZSBhbiBpbnB1dCBlbGVtZW50CiAgICogdGhhdCBoYXMgYmVlbiByZW5kZXJlZCBhcyBpbnZhbGlkIGFmdGVyIGl0IGhhcyBiZWVuIHZhbGlkYXRlZDoKICAgKgogICAqIDxwcmU+CiAgICogLy9iZSBzdXJlIHRvIGluY2x1ZGUgbmdBbmltYXRlIGFzIGEgbW9kdWxlIHRvIGhvb2sgaW50byBtb3JlCiAgICogLy9hZHZhbmNlZCBhbmltYXRpb25zCiAgICogLm15LWlucHV0IHsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogICBiYWNrZ3JvdW5kOiB3aGl0ZTsKICogfQogICAqIC5teS1pbnB1dC5uZy1pbnZhbGlkIHsKICogICBiYWNrZ3JvdW5kOiByZWQ7CiAqICAgY29sb3I6d2hpdGU7CiAqIH0KICAgKiA8L3ByZT4KICAgKgogICAqIEBleGFtcGxlCiAgICogPGV4YW1wbGUgZGVwcz0iYW5ndWxhci1hbmltYXRlLmpzIiBhbmltYXRpb25zPSJ0cnVlIiBmaXhCYXNlPSJ0cnVlIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUudmFsID0gJzEnOwogICAgICAgIH0KICAgPC9zY3JpcHQ+CiAgIDxzdHlsZT4KICAgLm15LWlucHV0IHsKICAgICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50OwogICAgICAgICB9CiAgIC5teS1pbnB1dC5uZy1pbnZhbGlkIHsKICAgICAgICAgICBjb2xvcjp3aGl0ZTsKICAgICAgICAgICBiYWNrZ3JvdW5kOiByZWQ7CiAgICAgICAgIH0KICAgPC9zdHlsZT4KICAgVXBkYXRlIGlucHV0IHRvIHNlZSB0cmFuc2l0aW9ucyB3aGVuIHZhbGlkL2ludmFsaWQuCiAgIEludGVnZXIgaXMgYSB2YWxpZCB2YWx1ZS4KICAgPGZvcm0gbmFtZT0idGVzdEZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICA8aW5wdXQgbmctbW9kZWw9InZhbCIgbmctcGF0dGVybj0iL15cZCskLyIgbmFtZT0iYW5pbSIgY2xhc3M9Im15LWlucHV0IiAvPgogICA8L2Zvcm0+CiAgIDwvZmlsZT4KICAgKiA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nTW9kZWxEaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHJlcXVpcmU6IFsnbmdNb2RlbCcsICdeP2Zvcm0nXSwKICAgICAgY29udHJvbGxlcjogTmdNb2RlbENvbnRyb2xsZXIsCiAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJscykgewogICAgICAgIC8vIG5vdGlmeSBvdGhlcnMsIGVzcGVjaWFsbHkgcGFyZW50IGZvcm1zCgogICAgICAgIHZhciBtb2RlbEN0cmwgPSBjdHJsc1swXSwKICAgICAgICAgIGZvcm1DdHJsID0gY3RybHNbMV0gfHwgbnVsbEZvcm1DdHJsOwoKICAgICAgICBmb3JtQ3RybC4kYWRkQ29udHJvbChtb2RlbEN0cmwpOwoKICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBmb3JtQ3RybC4kcmVtb3ZlQ29udHJvbChtb2RlbEN0cmwpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogIH07CgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdDaGFuZ2UKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEV2YWx1YXRlIHRoZSBnaXZlbiBleHByZXNzaW9uIHdoZW4gdGhlIHVzZXIgY2hhbmdlcyB0aGUgaW5wdXQuCiAgICogVGhlIGV4cHJlc3Npb24gaXMgZXZhbHVhdGVkIGltbWVkaWF0ZWx5LCB1bmxpa2UgdGhlIEphdmFTY3JpcHQgb25jaGFuZ2UgZXZlbnQKICAgKiB3aGljaCBvbmx5IHRyaWdnZXJzIGF0IHRoZSBlbmQgb2YgYSBjaGFuZ2UgKHVzdWFsbHksIHdoZW4gdGhlIHVzZXIgbGVhdmVzIHRoZQogICAqIGZvcm0gZWxlbWVudCBvciBwcmVzc2VzIHRoZSByZXR1cm4ga2V5KS4KICAgKiBUaGUgZXhwcmVzc2lvbiBpcyBub3QgZXZhbHVhdGVkIHdoZW4gdGhlIHZhbHVlIGNoYW5nZSBpcyBjb21pbmcgZnJvbSB0aGUgbW9kZWwuCiAgICoKICAgKiBOb3RlLCB0aGlzIGRpcmVjdGl2ZSByZXF1aXJlcyBgbmdNb2RlbGAgdG8gYmUgcHJlc2VudC4KICAgKgogICAqIEBlbGVtZW50IGlucHV0CiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NoYW5nZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uIGNoYW5nZQogICAqIGluIGlucHV0IHZhbHVlLgogICAqCiAgICogQGV4YW1wbGUKICAgKiA8ZXhhbXBsZSBuYW1lPSJuZ0NoYW5nZS1kaXJlY3RpdmUiPgogICAqICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgICogICAgIDxzY3JpcHQ+CiAgICogICAgICAgZnVuY3Rpb24gQ29udHJvbGxlcigkc2NvcGUpIHsKICogICAgICAgICAkc2NvcGUuY291bnRlciA9IDA7CiAqICAgICAgICAgJHNjb3BlLmNoYW5nZSA9IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAgJHNjb3BlLmNvdW50ZXIrKzsKICogICAgICAgICB9OwogKiAgICAgICB9CiAgICogICAgIDwvc2NyaXB0PgogICAqICAgICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkNvbnRyb2xsZXIiPgogICAqICAgICAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImNvbmZpcm1lZCIgbmctY2hhbmdlPSJjaGFuZ2UoKSIgaWQ9Im5nLWNoYW5nZS1leGFtcGxlMSIgLz4KICAgKiAgICAgICA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjb25maXJtZWQiIGlkPSJuZy1jaGFuZ2UtZXhhbXBsZTIiIC8+CiAgICogICAgICAgPGxhYmVsIGZvcj0ibmctY2hhbmdlLWV4YW1wbGUyIj5Db25maXJtZWQ8L2xhYmVsPjxiciAvPgogICAqICAgICAgIDx0dD5kZWJ1ZyA9IHt7Y29uZmlybWVkfX08L3R0Pjxici8+CiAgICogICAgICAgPHR0PmNvdW50ZXIgPSB7e2NvdW50ZXJ9fTwvdHQ+PGJyLz4KICAgKiAgICAgPC9kaXY+CiAgICogICA8L2ZpbGU+CiAgICogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgKiAgICAgdmFyIGNvdW50ZXIgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ2NvdW50ZXInKSk7CiAgICogICAgIHZhciBkZWJ1ZyA9IGVsZW1lbnQoYnkuYmluZGluZygnY29uZmlybWVkJykpOwogICAqCiAgICogICAgIGl0KCdzaG91bGQgZXZhbHVhdGUgdGhlIGV4cHJlc3Npb24gaWYgY2hhbmdpbmcgZnJvbSB2aWV3JywgZnVuY3Rpb24oKSB7CiAqICAgICAgIGV4cGVjdChjb3VudGVyLmdldFRleHQoKSkudG9Db250YWluKCcwJyk7CiAqCiAqICAgICAgIGVsZW1lbnQoYnkuaWQoJ25nLWNoYW5nZS1leGFtcGxlMScpKS5jbGljaygpOwogKgogKiAgICAgICBleHBlY3QoY291bnRlci5nZXRUZXh0KCkpLnRvQ29udGFpbignMScpOwogKiAgICAgICBleHBlY3QoZGVidWcuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICogICAgIH0pOwogICAqCiAgICogICAgIGl0KCdzaG91bGQgbm90IGV2YWx1YXRlIHRoZSBleHByZXNzaW9uIGlmIGNoYW5naW5nIGZyb20gbW9kZWwnLCBmdW5jdGlvbigpIHsKICogICAgICAgZWxlbWVudChieS5pZCgnbmctY2hhbmdlLWV4YW1wbGUyJykpLmNsaWNrKCk7CgogKiAgICAgICBleHBlY3QoY291bnRlci5nZXRUZXh0KCkpLnRvQ29udGFpbignMCcpOwogKiAgICAgICBleHBlY3QoZGVidWcuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3RydWUnKTsKICogICAgIH0pOwogICAqICAgPC9maWxlPgogICAqIDwvZXhhbXBsZT4KICAgKi8KICB2YXIgbmdDaGFuZ2VEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICAgIHJlcXVpcmU6ICduZ01vZGVsJywKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgIGN0cmwuJHZpZXdDaGFuZ2VMaXN0ZW5lcnMucHVzaChmdW5jdGlvbigpIHsKICAgICAgICBzY29wZS4kZXZhbChhdHRyLm5nQ2hhbmdlKTsKICAgICAgfSk7CiAgICB9CiAgfSk7CgoKICB2YXIgcmVxdWlyZWREaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsCiAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbG0sIGF0dHIsIGN0cmwpIHsKICAgICAgICBpZiAoIWN0cmwpIHJldHVybjsKICAgICAgICBhdHRyLnJlcXVpcmVkID0gdHJ1ZTsgLy8gZm9yY2UgdHJ1dGh5IGluIGNhc2Ugd2UgYXJlIG9uIG5vbiBpbnB1dCBlbGVtZW50CgogICAgICAgIHZhciB2YWxpZGF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgaWYgKGF0dHIucmVxdWlyZWQgJiYgY3RybC4kaXNFbXB0eSh2YWx1ZSkpIHsKICAgICAgICAgICAgY3RybC4kc2V0VmFsaWRpdHkoJ3JlcXVpcmVkJywgZmFsc2UpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjdHJsLiRzZXRWYWxpZGl0eSgncmVxdWlyZWQnLCB0cnVlKTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaCh2YWxpZGF0b3IpOwogICAgICAgIGN0cmwuJHBhcnNlcnMudW5zaGlmdCh2YWxpZGF0b3IpOwoKICAgICAgICBhdHRyLiRvYnNlcnZlKCdyZXF1aXJlZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFsaWRhdG9yKGN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgfTsKCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0xpc3QKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRleHQgaW5wdXQgdGhhdCBjb252ZXJ0cyBiZXR3ZWVuIGEgZGVsaW1pdGVkIHN0cmluZyBhbmQgYW4gYXJyYXkgb2Ygc3RyaW5ncy4gVGhlIGRlbGltaXRlcgogICAqIGNhbiBiZSBhIGZpeGVkIHN0cmluZyAoYnkgZGVmYXVsdCBhIGNvbW1hKSBvciBhIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgKgogICAqIEBlbGVtZW50IGlucHV0CiAgICogQHBhcmFtIHtzdHJpbmc9fSBuZ0xpc3Qgb3B0aW9uYWwgZGVsaW1pdGVyIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gc3BsaXQgdGhlIHZhbHVlLiBJZgogICAqICAgc3BlY2lmaWVkIGluIGZvcm0gYC9zb21ldGhpbmcvYCB0aGVuIHRoZSB2YWx1ZSB3aWxsIGJlIGNvbnZlcnRlZCBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbmFtZT0ibmdMaXN0LWRpcmVjdGl2ZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBDdHJsKCRzY29wZSkgewogICAgICAgICAgICRzY29wZS5uYW1lcyA9IFsnaWdvcicsICdtaXNrbycsICd2b2p0YSddOwogICAgICAgICB9CiAgIDwvc2NyaXB0PgogICA8Zm9ybSBuYW1lPSJteUZvcm0iIG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICBMaXN0OiA8aW5wdXQgbmFtZT0ibmFtZXNJbnB1dCIgbmctbW9kZWw9Im5hbWVzIiBuZy1saXN0IHJlcXVpcmVkPgogICA8c3BhbiBjbGFzcz0iZXJyb3IiIG5nLXNob3c9Im15Rm9ybS5uYW1lc0lucHV0LiRlcnJvci5yZXF1aXJlZCI+CiAgIFJlcXVpcmVkITwvc3Bhbj4KICAgPGJyPgogICA8dHQ+bmFtZXMgPSB7e25hbWVzfX08L3R0Pjxici8+CiAgIDx0dD5teUZvcm0ubmFtZXNJbnB1dC4kdmFsaWQgPSB7e215Rm9ybS5uYW1lc0lucHV0LiR2YWxpZH19PC90dD48YnIvPgogICA8dHQ+bXlGb3JtLm5hbWVzSW5wdXQuJGVycm9yID0ge3tteUZvcm0ubmFtZXNJbnB1dC4kZXJyb3J9fTwvdHQ+PGJyLz4KICAgPHR0Pm15Rm9ybS4kdmFsaWQgPSB7e215Rm9ybS4kdmFsaWR9fTwvdHQ+PGJyLz4KICAgPHR0Pm15Rm9ybS4kZXJyb3IucmVxdWlyZWQgPSB7eyEhbXlGb3JtLiRlcnJvci5yZXF1aXJlZH19PC90dD48YnIvPgogICA8L2Zvcm0+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIHZhciBsaXN0SW5wdXQgPSBlbGVtZW50KGJ5Lm1vZGVsKCduYW1lcycpKTsKICAgdmFyIG5hbWVzID0gZWxlbWVudChieS5iaW5kaW5nKCd7e25hbWVzfX0nKSk7CiAgIHZhciB2YWxpZCA9IGVsZW1lbnQoYnkuYmluZGluZygnbXlGb3JtLm5hbWVzSW5wdXQuJHZhbGlkJykpOwogICB2YXIgZXJyb3IgPSBlbGVtZW50KGJ5LmNzcygnc3Bhbi5lcnJvcicpKTsKCiAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB0byBtb2RlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZXhwZWN0KG5hbWVzLmdldFRleHQoKSkudG9Db250YWluKCdbImlnb3IiLCJtaXNrbyIsInZvanRhIl0nKTsKICAgICAgICAgIGV4cGVjdCh2YWxpZC5nZXRUZXh0KCkpLnRvQ29udGFpbigndHJ1ZScpOwogICAgICAgICAgZXhwZWN0KGVycm9yLmdldENzc1ZhbHVlKCdkaXNwbGF5JykpLnRvQmUoJ25vbmUnKTsKICAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgYmUgaW52YWxpZCBpZiBlbXB0eScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgbGlzdElucHV0LmNsZWFyKCk7CiAgICAgICAgICBsaXN0SW5wdXQuc2VuZEtleXMoJycpOwoKICAgICAgICAgIGV4cGVjdChuYW1lcy5nZXRUZXh0KCkpLnRvQ29udGFpbignJyk7CiAgICAgICAgICBleHBlY3QodmFsaWQuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2ZhbHNlJyk7CiAgICAgICAgICBleHBlY3QoZXJyb3IuZ2V0Q3NzVmFsdWUoJ2Rpc3BsYXknKSkubm90LnRvQmUoJ25vbmUnKTsgICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICB2YXIgbmdMaXN0RGlyZWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gewogICAgICByZXF1aXJlOiAnbmdNb2RlbCcsCiAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsKSB7CiAgICAgICAgdmFyIG1hdGNoID0gL1wvKC4qKVwvLy5leGVjKGF0dHIubmdMaXN0KSwKICAgICAgICAgIHNlcGFyYXRvciA9IG1hdGNoICYmIG5ldyBSZWdFeHAobWF0Y2hbMV0pIHx8IGF0dHIubmdMaXN0IHx8ICcsJzsKCiAgICAgICAgdmFyIHBhcnNlID0gZnVuY3Rpb24odmlld1ZhbHVlKSB7CiAgICAgICAgICAvLyBJZiB0aGUgdmlld1ZhbHVlIGlzIGludmFsaWQgKHNheSByZXF1aXJlZCBidXQgZW1wdHkpIGl0IHdpbGwgYmUgYHVuZGVmaW5lZGAKICAgICAgICAgIGlmIChpc1VuZGVmaW5lZCh2aWV3VmFsdWUpKSByZXR1cm47CgogICAgICAgICAgdmFyIGxpc3QgPSBbXTsKCiAgICAgICAgICBpZiAodmlld1ZhbHVlKSB7CiAgICAgICAgICAgIGZvckVhY2godmlld1ZhbHVlLnNwbGl0KHNlcGFyYXRvciksIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKHZhbHVlKSBsaXN0LnB1c2godHJpbSh2YWx1ZSkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gbGlzdDsKICAgICAgICB9OwoKICAgICAgICBjdHJsLiRwYXJzZXJzLnB1c2gocGFyc2UpOwogICAgICAgIGN0cmwuJGZvcm1hdHRlcnMucHVzaChmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgaWYgKGlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZS5qb2luKCcsICcpOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgfSk7CgogICAgICAgIC8vIE92ZXJyaWRlIHRoZSBzdGFuZGFyZCAkaXNFbXB0eSBiZWNhdXNlIGFuIGVtcHR5IGFycmF5IG1lYW5zIHRoZSBpbnB1dCBpcyBlbXB0eS4KICAgICAgICBjdHJsLiRpc0VtcHR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAhdmFsdWUgfHwgIXZhbHVlLmxlbmd0aDsKICAgICAgICB9OwogICAgICB9CiAgICB9OwogIH07CgoKICB2YXIgQ09OU1RBTlRfVkFMVUVfUkVHRVhQID0gL14odHJ1ZXxmYWxzZXxcZCspJC87CiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nVmFsdWUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEJpbmRzIHRoZSBnaXZlbiBleHByZXNzaW9uIHRvIHRoZSB2YWx1ZSBvZiBgaW5wdXRbc2VsZWN0XWAgb3IgYGlucHV0W3JhZGlvXWAsIHNvCiAgICogdGhhdCB3aGVuIHRoZSBlbGVtZW50IGlzIHNlbGVjdGVkLCB0aGUgYG5nTW9kZWxgIG9mIHRoYXQgZWxlbWVudCBpcyBzZXQgdG8gdGhlCiAgICogYm91bmQgdmFsdWUuCiAgICoKICAgKiBgbmdWYWx1ZWAgaXMgdXNlZnVsIHdoZW4gZHluYW1pY2FsbHkgZ2VuZXJhdGluZyBsaXN0cyBvZiByYWRpbyBidXR0b25zIHVzaW5nIGBuZy1yZXBlYXRgLCBhcwogICAqIHNob3duIGJlbG93LgogICAqCiAgICogQGVsZW1lbnQgaW5wdXQKICAgKiBAcGFyYW0ge3N0cmluZz19IG5nVmFsdWUgYW5ndWxhciBleHByZXNzaW9uLCB3aG9zZSB2YWx1ZSB3aWxsIGJlIGJvdW5kIHRvIHRoZSBgdmFsdWVgIGF0dHJpYnV0ZQogICAqICAgb2YgdGhlIGBpbnB1dGAgZWxlbWVudAogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbmFtZT0ibmdWYWx1ZS1kaXJlY3RpdmUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAgJHNjb3BlLm5hbWVzID0gWydwaXp6YScsICd1bmljb3JucycsICdyb2JvdHMnXTsKICAgICAgICAgICAgJHNjb3BlLm15ID0geyBmYXZvcml0ZTogJ3VuaWNvcm5zJyB9OwogICAgICAgICAgfQogICA8L3NjcmlwdD4KICAgPGZvcm0gbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIDxoMj5XaGljaCBpcyB5b3VyIGZhdm9yaXRlPzwvaDI+CiAgIDxsYWJlbCBuZy1yZXBlYXQ9Im5hbWUgaW4gbmFtZXMiIGZvcj0ie3tuYW1lfX0iPgogICB7e25hbWV9fQogICA8aW5wdXQgdHlwZT0icmFkaW8iCiAgIG5nLW1vZGVsPSJteS5mYXZvcml0ZSIKICAgbmctdmFsdWU9Im5hbWUiCiAgIGlkPSJ7e25hbWV9fSIKICAgbmFtZT0iZmF2b3JpdGUiPgogICA8L2xhYmVsPgogICA8ZGl2PllvdSBjaG9zZSB7e215LmZhdm9yaXRlfX08L2Rpdj4KICAgPC9mb3JtPgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICB2YXIgZmF2b3JpdGUgPSBlbGVtZW50KGJ5LmJpbmRpbmcoJ215LmZhdm9yaXRlJykpOwoKICAgaXQoJ3Nob3VsZCBpbml0aWFsaXplIHRvIG1vZGVsJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICBleHBlY3QoZmF2b3JpdGUuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ3VuaWNvcm5zJyk7CiAgICAgICAgfSk7CiAgIGl0KCdzaG91bGQgYmluZCB0aGUgdmFsdWVzIHRvIHRoZSBpbnB1dHMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGVsZW1lbnQuYWxsKGJ5Lm1vZGVsKCdteS5mYXZvcml0ZScpKS5nZXQoMCkuY2xpY2soKTsKICAgICAgICAgIGV4cGVjdChmYXZvcml0ZS5nZXRUZXh0KCkpLnRvQ29udGFpbigncGl6emEnKTsKICAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nVmFsdWVEaXJlY3RpdmUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRwbCwgdHBsQXR0cikgewogICAgICAgIGlmIChDT05TVEFOVF9WQUxVRV9SRUdFWFAudGVzdCh0cGxBdHRyLm5nVmFsdWUpKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gbmdWYWx1ZUNvbnN0YW50TGluayhzY29wZSwgZWxtLCBhdHRyKSB7CiAgICAgICAgICAgIGF0dHIuJHNldCgndmFsdWUnLCBzY29wZS4kZXZhbChhdHRyLm5nVmFsdWUpKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBuZ1ZhbHVlTGluayhzY29wZSwgZWxtLCBhdHRyKSB7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nVmFsdWUsIGZ1bmN0aW9uIHZhbHVlV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgdmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0JpbmQKICAgKiBAcmVzdHJpY3QgQUMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdCaW5kYCBhdHRyaWJ1dGUgdGVsbHMgQW5ndWxhciB0byByZXBsYWNlIHRoZSB0ZXh0IGNvbnRlbnQgb2YgdGhlIHNwZWNpZmllZCBIVE1MIGVsZW1lbnQKICAgKiB3aXRoIHRoZSB2YWx1ZSBvZiBhIGdpdmVuIGV4cHJlc3Npb24sIGFuZCB0byB1cGRhdGUgdGhlIHRleHQgY29udGVudCB3aGVuIHRoZSB2YWx1ZSBvZiB0aGF0CiAgICogZXhwcmVzc2lvbiBjaGFuZ2VzLgogICAqCiAgICogVHlwaWNhbGx5LCB5b3UgZG9uJ3QgdXNlIGBuZ0JpbmRgIGRpcmVjdGx5LCBidXQgaW5zdGVhZCB5b3UgdXNlIHRoZSBkb3VibGUgY3VybHkgbWFya3VwIGxpa2UKICAgKiBge3sgZXhwcmVzc2lvbiB9fWAgd2hpY2ggaXMgc2ltaWxhciBidXQgbGVzcyB2ZXJib3NlLgogICAqCiAgICogSXQgaXMgcHJlZmVyYWJsZSB0byB1c2UgYG5nQmluZGAgaW5zdGVhZCBvZiBge3sgZXhwcmVzc2lvbiB9fWAgd2hlbiBhIHRlbXBsYXRlIGlzIG1vbWVudGFyaWx5CiAgICogZGlzcGxheWVkIGJ5IHRoZSBicm93c2VyIGluIGl0cyByYXcgc3RhdGUgYmVmb3JlIEFuZ3VsYXIgY29tcGlsZXMgaXQuIFNpbmNlIGBuZ0JpbmRgIGlzIGFuCiAgICogZWxlbWVudCBhdHRyaWJ1dGUsIGl0IG1ha2VzIHRoZSBiaW5kaW5ncyBpbnZpc2libGUgdG8gdGhlIHVzZXIgd2hpbGUgdGhlIHBhZ2UgaXMgbG9hZGluZy4KICAgKgogICAqIEFuIGFsdGVybmF0aXZlIHNvbHV0aW9uIHRvIHRoaXMgcHJvYmxlbSB3b3VsZCBiZSB1c2luZyB0aGUKICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xvYWsgbmdDbG9ha30gZGlyZWN0aXZlLgogICAqCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZS4KICAgKgogICAqIEBleGFtcGxlCiAgICogRW50ZXIgYSBuYW1lIGluIHRoZSBMaXZlIFByZXZpZXcgdGV4dCBib3g7IHRoZSBncmVldGluZyBiZWxvdyB0aGUgdGV4dCBib3ggY2hhbmdlcyBpbnN0YW50bHkuCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUubmFtZSA9ICdXaGlybGVkJzsKICAgICAgICAgfQogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgRW50ZXIgbmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJuYW1lIj48YnI+CiAgIEhlbGxvIDxzcGFuIG5nLWJpbmQ9Im5hbWUiPjwvc3Bhbj4hCiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdmFyIG5hbWVJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ25hbWUnKSk7CgogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCduYW1lJykpLmdldFRleHQoKSkudG9CZSgnV2hpcmxlZCcpOwogICAgICAgICBuYW1lSW5wdXQuY2xlYXIoKTsKICAgICAgICAgbmFtZUlucHV0LnNlbmRLZXlzKCd3b3JsZCcpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCduYW1lJykpLmdldFRleHQoKSkudG9CZSgnd29ybGQnKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICB2YXIgbmdCaW5kRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kKTsKICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nQmluZCwgZnVuY3Rpb24gbmdCaW5kV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgLy8gV2UgYXJlIHB1cnBvc2VmdWxseSB1c2luZyA9PSBoZXJlIHJhdGhlciB0aGFuID09PSBiZWNhdXNlIHdlIHdhbnQgdG8KICAgICAgLy8gY2F0Y2ggd2hlbiB2YWx1ZSBpcyAibnVsbCBvciB1bmRlZmluZWQiCiAgICAgIC8vIGpzaGludCAtVzA0MQogICAgICBlbGVtZW50LnRleHQodmFsdWUgPT0gdW5kZWZpbmVkID8gJycgOiB2YWx1ZSk7CiAgICB9KTsKICB9KTsKCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0JpbmRUZW1wbGF0ZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGBuZ0JpbmRUZW1wbGF0ZWAgZGlyZWN0aXZlIHNwZWNpZmllcyB0aGF0IHRoZSBlbGVtZW50CiAgICogdGV4dCBjb250ZW50IHNob3VsZCBiZSByZXBsYWNlZCB3aXRoIHRoZSBpbnRlcnBvbGF0aW9uIG9mIHRoZSB0ZW1wbGF0ZQogICAqIGluIHRoZSBgbmdCaW5kVGVtcGxhdGVgIGF0dHJpYnV0ZS4KICAgKiBVbmxpa2UgYG5nQmluZGAsIHRoZSBgbmdCaW5kVGVtcGxhdGVgIGNhbiBjb250YWluIG11bHRpcGxlIGB7e2AgYH19YAogICAqIGV4cHJlc3Npb25zLiBUaGlzIGRpcmVjdGl2ZSBpcyBuZWVkZWQgc2luY2Ugc29tZSBIVE1MIGVsZW1lbnRzCiAgICogKHN1Y2ggYXMgVElUTEUgYW5kIE9QVElPTikgY2Fubm90IGNvbnRhaW4gU1BBTiBlbGVtZW50cy4KICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwYXJhbSB7c3RyaW5nfSBuZ0JpbmRUZW1wbGF0ZSB0ZW1wbGF0ZSBvZiBmb3JtCiAgICogICA8dHQ+e3s8L3R0PiA8dHQ+ZXhwcmVzc2lvbjwvdHQ+IDx0dD59fTwvdHQ+IHRvIGV2YWwuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIFRyeSBpdCBoZXJlOiBlbnRlciB0ZXh0IGluIHRleHQgYm94IGFuZCB3YXRjaCB0aGUgZ3JlZXRpbmcgY2hhbmdlLgogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnNhbHV0YXRpb24gPSAnSGVsbG8nOwogICAgICAgICAgICRzY29wZS5uYW1lID0gJ1dvcmxkJzsKICAgICAgICAgfQogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgU2FsdXRhdGlvbjogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzYWx1dGF0aW9uIj48YnI+CiAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSI+PGJyPgogICA8cHJlIG5nLWJpbmQtdGVtcGxhdGU9Int7c2FsdXRhdGlvbn19IHt7bmFtZX19ISI+PC9wcmU+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIGNoZWNrIG5nLWJpbmQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdmFyIHNhbHV0YXRpb25FbGVtID0gZWxlbWVudChieS5iaW5kaW5nKCdzYWx1dGF0aW9uJykpOwogICAgICAgICB2YXIgc2FsdXRhdGlvbklucHV0ID0gZWxlbWVudChieS5tb2RlbCgnc2FsdXRhdGlvbicpKTsKICAgICAgICAgdmFyIG5hbWVJbnB1dCA9IGVsZW1lbnQoYnkubW9kZWwoJ25hbWUnKSk7CgogICAgICAgICBleHBlY3Qoc2FsdXRhdGlvbkVsZW0uZ2V0VGV4dCgpKS50b0JlKCdIZWxsbyBXb3JsZCEnKTsKCiAgICAgICAgIHNhbHV0YXRpb25JbnB1dC5jbGVhcigpOwogICAgICAgICBzYWx1dGF0aW9uSW5wdXQuc2VuZEtleXMoJ0dyZWV0aW5ncycpOwogICAgICAgICBuYW1lSW5wdXQuY2xlYXIoKTsKICAgICAgICAgbmFtZUlucHV0LnNlbmRLZXlzKCd1c2VyJyk7CgogICAgICAgICBleHBlY3Qoc2FsdXRhdGlvbkVsZW0uZ2V0VGV4dCgpKS50b0JlKCdHcmVldGluZ3MgdXNlciEnKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICB2YXIgbmdCaW5kVGVtcGxhdGVEaXJlY3RpdmUgPSBbJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRpbnRlcnBvbGF0ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgIC8vIFRPRE86IG1vdmUgdGhpcyB0byBzY2VuYXJpbyBydW5uZXIKICAgICAgdmFyIGludGVycG9sYXRlRm4gPSAkaW50ZXJwb2xhdGUoZWxlbWVudC5hdHRyKGF0dHIuJGF0dHIubmdCaW5kVGVtcGxhdGUpKTsKICAgICAgZWxlbWVudC5hZGRDbGFzcygnbmctYmluZGluZycpLmRhdGEoJyRiaW5kaW5nJywgaW50ZXJwb2xhdGVGbik7CiAgICAgIGF0dHIuJG9ic2VydmUoJ25nQmluZFRlbXBsYXRlJywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBlbGVtZW50LnRleHQodmFsdWUpOwogICAgICB9KTsKICAgIH07CiAgfV07CgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdCaW5kSHRtbAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ3JlYXRlcyBhIGJpbmRpbmcgdGhhdCB3aWxsIGlubmVySFRNTCB0aGUgcmVzdWx0IG9mIGV2YWx1YXRpbmcgdGhlIGBleHByZXNzaW9uYCBpbnRvIHRoZSBjdXJyZW50CiAgICogZWxlbWVudCBpbiBhIHNlY3VyZSB3YXkuICBCeSBkZWZhdWx0LCB0aGUgaW5uZXJIVE1MLWVkIGNvbnRlbnQgd2lsbCBiZSBzYW5pdGl6ZWQgdXNpbmcgdGhlIHtAbGluawogICAgKiBuZ1Nhbml0aXplLiRzYW5pdGl6ZSAkc2FuaXRpemV9IHNlcnZpY2UuICBUbyB1dGlsaXplIHRoaXMgZnVuY3Rpb25hbGl0eSwgZW5zdXJlIHRoYXQgYCRzYW5pdGl6ZWAKICAgKiBpcyBhdmFpbGFibGUsIGZvciBleGFtcGxlLCBieSBpbmNsdWRpbmcge0BsaW5rIG5nU2FuaXRpemV9IGluIHlvdXIgbW9kdWxlJ3MgZGVwZW5kZW5jaWVzIChub3QgaW4KICAgKiBjb3JlIEFuZ3VsYXIuKSAgWW91IG1heSBhbHNvIGJ5cGFzcyBzYW5pdGl6YXRpb24gZm9yIHZhbHVlcyB5b3Uga25vdyBhcmUgc2FmZS4gVG8gZG8gc28sIGJpbmQgdG8KICAgKiBhbiBleHBsaWNpdGx5IHRydXN0ZWQgdmFsdWUgdmlhIHtAbGluayBuZy4kc2NlI3RydXN0QXNIdG1sICRzY2UudHJ1c3RBc0h0bWx9LiAgU2VlIHRoZSBleGFtcGxlCiAgICogdW5kZXIge0BsaW5rIG5nLiRzY2UjRXhhbXBsZSBTdHJpY3QgQ29udGV4dHVhbCBFc2NhcGluZyAoU0NFKX0uCiAgICoKICAgKiBOb3RlOiBJZiBhIGAkc2FuaXRpemVgIHNlcnZpY2UgaXMgdW5hdmFpbGFibGUgYW5kIHRoZSBib3VuZCB2YWx1ZSBpc24ndCBleHBsaWNpdGx5IHRydXN0ZWQsIHlvdQogICAqIHdpbGwgaGF2ZSBhbiBleGNlcHRpb24gKGluc3RlYWQgb2YgYW4gZXhwbG9pdC4pCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQmluZEh0bWwge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUuCiAgICoKICAgKiBAZXhhbXBsZQogICBUcnkgaXQgaGVyZTogZW50ZXIgdGV4dCBpbiB0ZXh0IGJveCBhbmQgd2F0Y2ggdGhlIGdyZWV0aW5nIGNoYW5nZS4KCiAgIDxleGFtcGxlIG1vZHVsZT0ibmdCaW5kSHRtbEV4YW1wbGUiIGRlcHM9ImFuZ3VsYXItc2FuaXRpemUuanMiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJuZ0JpbmRIdG1sQ3RybCI+CiAgIDxwIG5nLWJpbmQtaHRtbD0ibXlIVE1MIj48L3A+CiAgIDwvZGl2PgogICA8L2ZpbGU+CgogICA8ZmlsZSBuYW1lPSJzY3JpcHQuanMiPgogICBhbmd1bGFyLm1vZHVsZSgnbmdCaW5kSHRtbEV4YW1wbGUnLCBbJ25nU2FuaXRpemUnXSkKCiAgIC5jb250cm9sbGVyKCduZ0JpbmRIdG1sQ3RybCcsIFsnJHNjb3BlJywgZnVuY3Rpb24gbmdCaW5kSHRtbEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICRzY29wZS5teUhUTUwgPQogICAgICAgICAgICAnSSBhbSBhbiA8Y29kZT5IVE1MPC9jb2RlPnN0cmluZyB3aXRoIDxhIGhyZWY9IiMiPmxpbmtzITwvYT4gYW5kIG90aGVyIDxlbT5zdHVmZjwvZW0+JzsKICAgICAgIH1dKTsKICAgPC9maWxlPgoKICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgY2hlY2sgbmctYmluZC1odG1sJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ215SFRNTCcpKS5nZXRUZXh0KCkpLnRvQmUoCiAgICAgICAgICAgICAnSSBhbSBhbiBIVE1Mc3RyaW5nIHdpdGggbGlua3MhIGFuZCBvdGhlciBzdHVmZicpOwogICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIHZhciBuZ0JpbmRIdG1sRGlyZWN0aXZlID0gWyckc2NlJywgJyRwYXJzZScsIGZ1bmN0aW9uKCRzY2UsICRwYXJzZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ25nLWJpbmRpbmcnKS5kYXRhKCckYmluZGluZycsIGF0dHIubmdCaW5kSHRtbCk7CgogICAgICB2YXIgcGFyc2VkID0gJHBhcnNlKGF0dHIubmdCaW5kSHRtbCk7CiAgICAgIGZ1bmN0aW9uIGdldFN0cmluZ1ZhbHVlKCkgeyByZXR1cm4gKHBhcnNlZChzY29wZSkgfHwgJycpLnRvU3RyaW5nKCk7IH0KCiAgICAgIHNjb3BlLiR3YXRjaChnZXRTdHJpbmdWYWx1ZSwgZnVuY3Rpb24gbmdCaW5kSHRtbFdhdGNoQWN0aW9uKHZhbHVlKSB7CiAgICAgICAgZWxlbWVudC5odG1sKCRzY2UuZ2V0VHJ1c3RlZEh0bWwocGFyc2VkKHNjb3BlKSkgfHwgJycpOwogICAgICB9KTsKICAgIH07CiAgfV07CgogIGZ1bmN0aW9uIGNsYXNzRGlyZWN0aXZlKG5hbWUsIHNlbGVjdG9yKSB7CiAgICBuYW1lID0gJ25nQ2xhc3MnICsgbmFtZTsKICAgIHJldHVybiBbJyRhbmltYXRlJywgZnVuY3Rpb24oJGFuaW1hdGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0FDJywKICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgdmFyIG9sZFZhbDsKCiAgICAgICAgICBzY29wZS4kd2F0Y2goYXR0cltuYW1lXSwgbmdDbGFzc1dhdGNoQWN0aW9uLCB0cnVlKTsKCiAgICAgICAgICBhdHRyLiRvYnNlcnZlKCdjbGFzcycsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIG5nQ2xhc3NXYXRjaEFjdGlvbihzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICB9KTsKCgogICAgICAgICAgaWYgKG5hbWUgIT09ICduZ0NsYXNzJykgewogICAgICAgICAgICBzY29wZS4kd2F0Y2goJyRpbmRleCcsIGZ1bmN0aW9uKCRpbmRleCwgb2xkJGluZGV4KSB7CiAgICAgICAgICAgICAgLy8ganNoaW50IGJpdHdpc2U6IGZhbHNlCiAgICAgICAgICAgICAgdmFyIG1vZCA9ICRpbmRleCAmIDE7CiAgICAgICAgICAgICAgaWYgKG1vZCAhPT0gKG9sZCRpbmRleCAmIDEpKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xhc3NlcyA9IGFycmF5Q2xhc3NlcyhzY29wZS4kZXZhbChhdHRyW25hbWVdKSk7CiAgICAgICAgICAgICAgICBtb2QgPT09IHNlbGVjdG9yID8KICAgICAgICAgICAgICAgICAgYWRkQ2xhc3NlcyhjbGFzc2VzKSA6CiAgICAgICAgICAgICAgICAgIHJlbW92ZUNsYXNzZXMoY2xhc3Nlcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBhZGRDbGFzc2VzKGNsYXNzZXMpIHsKICAgICAgICAgICAgdmFyIG5ld0NsYXNzZXMgPSBkaWdlc3RDbGFzc0NvdW50cyhjbGFzc2VzLCAxKTsKICAgICAgICAgICAgYXR0ci4kYWRkQ2xhc3MobmV3Q2xhc3Nlcyk7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlQ2xhc3NlcyhjbGFzc2VzKSB7CiAgICAgICAgICAgIHZhciBuZXdDbGFzc2VzID0gZGlnZXN0Q2xhc3NDb3VudHMoY2xhc3NlcywgLTEpOwogICAgICAgICAgICBhdHRyLiRyZW1vdmVDbGFzcyhuZXdDbGFzc2VzKTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBkaWdlc3RDbGFzc0NvdW50cyAoY2xhc3NlcywgY291bnQpIHsKICAgICAgICAgICAgdmFyIGNsYXNzQ291bnRzID0gZWxlbWVudC5kYXRhKCckY2xhc3NDb3VudHMnKSB8fCB7fTsKICAgICAgICAgICAgdmFyIGNsYXNzZXNUb1VwZGF0ZSA9IFtdOwogICAgICAgICAgICBmb3JFYWNoKGNsYXNzZXMsIGZ1bmN0aW9uIChjbGFzc05hbWUpIHsKICAgICAgICAgICAgICBpZiAoY291bnQgPiAwIHx8IGNsYXNzQ291bnRzW2NsYXNzTmFtZV0pIHsKICAgICAgICAgICAgICAgIGNsYXNzQ291bnRzW2NsYXNzTmFtZV0gPSAoY2xhc3NDb3VudHNbY2xhc3NOYW1lXSB8fCAwKSArIGNvdW50OwogICAgICAgICAgICAgICAgaWYgKGNsYXNzQ291bnRzW2NsYXNzTmFtZV0gPT09ICsoY291bnQgPiAwKSkgewogICAgICAgICAgICAgICAgICBjbGFzc2VzVG9VcGRhdGUucHVzaChjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGVsZW1lbnQuZGF0YSgnJGNsYXNzQ291bnRzJywgY2xhc3NDb3VudHMpOwogICAgICAgICAgICByZXR1cm4gY2xhc3Nlc1RvVXBkYXRlLmpvaW4oJyAnKTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVDbGFzc2VzIChvbGRDbGFzc2VzLCBuZXdDbGFzc2VzKSB7CiAgICAgICAgICAgIHZhciB0b0FkZCA9IGFycmF5RGlmZmVyZW5jZShuZXdDbGFzc2VzLCBvbGRDbGFzc2VzKTsKICAgICAgICAgICAgdmFyIHRvUmVtb3ZlID0gYXJyYXlEaWZmZXJlbmNlKG9sZENsYXNzZXMsIG5ld0NsYXNzZXMpOwogICAgICAgICAgICB0b1JlbW92ZSA9IGRpZ2VzdENsYXNzQ291bnRzKHRvUmVtb3ZlLCAtMSk7CiAgICAgICAgICAgIHRvQWRkID0gZGlnZXN0Q2xhc3NDb3VudHModG9BZGQsIDEpOwoKICAgICAgICAgICAgaWYgKHRvQWRkLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsIHRvUmVtb3ZlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0b1JlbW92ZS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAkYW5pbWF0ZS5hZGRDbGFzcyhlbGVtZW50LCB0b0FkZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgJGFuaW1hdGUuc2V0Q2xhc3MoZWxlbWVudCwgdG9BZGQsIHRvUmVtb3ZlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIG5nQ2xhc3NXYXRjaEFjdGlvbihuZXdWYWwpIHsKICAgICAgICAgICAgaWYgKHNlbGVjdG9yID09PSB0cnVlIHx8IHNjb3BlLiRpbmRleCAlIDIgPT09IHNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgdmFyIG5ld0NsYXNzZXMgPSBhcnJheUNsYXNzZXMobmV3VmFsIHx8IFtdKTsKICAgICAgICAgICAgICBpZiAoIW9sZFZhbCkgewogICAgICAgICAgICAgICAgYWRkQ2xhc3NlcyhuZXdDbGFzc2VzKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFlcXVhbHMobmV3VmFsLG9sZFZhbCkpIHsKICAgICAgICAgICAgICAgIHZhciBvbGRDbGFzc2VzID0gYXJyYXlDbGFzc2VzKG9sZFZhbCk7CiAgICAgICAgICAgICAgICB1cGRhdGVDbGFzc2VzKG9sZENsYXNzZXMsIG5ld0NsYXNzZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBvbGRWYWwgPSBzaGFsbG93Q29weShuZXdWYWwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIGFycmF5RGlmZmVyZW5jZSh0b2tlbnMxLCB0b2tlbnMyKSB7CiAgICAgICAgdmFyIHZhbHVlcyA9IFtdOwoKICAgICAgICBvdXRlcjoKICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCB0b2tlbnMxLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciB0b2tlbiA9IHRva2VuczFbaV07CiAgICAgICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCB0b2tlbnMyLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgaWYodG9rZW4gPT0gdG9rZW5zMltqXSkgY29udGludWUgb3V0ZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFsdWVzLnB1c2godG9rZW4pOwogICAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFycmF5Q2xhc3NlcyAoY2xhc3NWYWwpIHsKICAgICAgICBpZiAoaXNBcnJheShjbGFzc1ZhbCkpIHsKICAgICAgICAgIHJldHVybiBjbGFzc1ZhbDsKICAgICAgICB9IGVsc2UgaWYgKGlzU3RyaW5nKGNsYXNzVmFsKSkgewogICAgICAgICAgcmV0dXJuIGNsYXNzVmFsLnNwbGl0KCcgJyk7CiAgICAgICAgfSBlbHNlIGlmIChpc09iamVjdChjbGFzc1ZhbCkpIHsKICAgICAgICAgIHZhciBjbGFzc2VzID0gW10sIGkgPSAwOwogICAgICAgICAgZm9yRWFjaChjbGFzc1ZhbCwgZnVuY3Rpb24odiwgaykgewogICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgIGNsYXNzZXMgPSBjbGFzc2VzLmNvbmNhdChrLnNwbGl0KCcgJykpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBjbGFzc2VzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY2xhc3NWYWw7CiAgICAgIH0KICAgIH1dOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nQ2xhc3MKICAgKiBAcmVzdHJpY3QgQUMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdDbGFzc2AgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gZHluYW1pY2FsbHkgc2V0IENTUyBjbGFzc2VzIG9uIGFuIEhUTUwgZWxlbWVudCBieSBkYXRhYmluZGluZwogICAqIGFuIGV4cHJlc3Npb24gdGhhdCByZXByZXNlbnRzIGFsbCBjbGFzc2VzIHRvIGJlIGFkZGVkLgogICAqCiAgICogVGhlIGRpcmVjdGl2ZSBvcGVyYXRlcyBpbiB0aHJlZSBkaWZmZXJlbnQgd2F5cywgZGVwZW5kaW5nIG9uIHdoaWNoIG9mIHRocmVlIHR5cGVzIHRoZSBleHByZXNzaW9uCiAgICogZXZhbHVhdGVzIHRvOgogICAqCiAgICogMS4gSWYgdGhlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgc3RyaW5nLCB0aGUgc3RyaW5nIHNob3VsZCBiZSBvbmUgb3IgbW9yZSBzcGFjZS1kZWxpbWl0ZWQgY2xhc3MKICAgKiBuYW1lcy4KICAgKgogICAqIDIuIElmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhbiBhcnJheSwgZWFjaCBlbGVtZW50IG9mIHRoZSBhcnJheSBzaG91bGQgYmUgYSBzdHJpbmcgdGhhdCBpcwogICAqIG9uZSBvciBtb3JlIHNwYWNlLWRlbGltaXRlZCBjbGFzcyBuYW1lcy4KICAgKgogICAqIDMuIElmIHRoZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhbiBvYmplY3QsIHRoZW4gZm9yIGVhY2gga2V5LXZhbHVlIHBhaXIgb2YgdGhlCiAgICogb2JqZWN0IHdpdGggYSB0cnV0aHkgdmFsdWUgdGhlIGNvcnJlc3BvbmRpbmcga2V5IGlzIHVzZWQgYXMgYSBjbGFzcyBuYW1lLgogICAqCiAgICogVGhlIGRpcmVjdGl2ZSB3b24ndCBhZGQgZHVwbGljYXRlIGNsYXNzZXMgaWYgYSBwYXJ0aWN1bGFyIGNsYXNzIHdhcyBhbHJlYWR5IHNldC4KICAgKgogICAqIFdoZW4gdGhlIGV4cHJlc3Npb24gY2hhbmdlcywgdGhlIHByZXZpb3VzbHkgYWRkZWQgY2xhc3NlcyBhcmUgcmVtb3ZlZCBhbmQgb25seSB0aGVuIHRoZQogICAqIG5ldyBjbGFzc2VzIGFyZSBhZGRlZC4KICAgKgogICAqIEBhbmltYXRpb25zCiAgICogYWRkIC0gaGFwcGVucyBqdXN0IGJlZm9yZSB0aGUgY2xhc3MgaXMgYXBwbGllZCB0byB0aGUgZWxlbWVudAogICAqIHJlbW92ZSAtIGhhcHBlbnMganVzdCBiZWZvcmUgdGhlIGNsYXNzIGlzIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICAgKiAgIG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzCiAgICogICBuYW1lcywgYW4gYXJyYXksIG9yIGEgbWFwIG9mIGNsYXNzIG5hbWVzIHRvIGJvb2xlYW4gdmFsdWVzLiBJbiB0aGUgY2FzZSBvZiBhIG1hcCwgdGhlCiAgICogICBuYW1lcyBvZiB0aGUgcHJvcGVydGllcyB3aG9zZSB2YWx1ZXMgYXJlIHRydXRoeSB3aWxsIGJlIGFkZGVkIGFzIGNzcyBjbGFzc2VzIHRvIHRoZQogICAqICAgZWxlbWVudC4KICAgKgogICAqIEBleGFtcGxlIEV4YW1wbGUgdGhhdCBkZW1vbnN0cmF0ZXMgYmFzaWMgYmluZGluZ3MgdmlhIG5nQ2xhc3MgZGlyZWN0aXZlLgogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxwIG5nLWNsYXNzPSJ7c3RyaWtlOiBkZWxldGVkLCBib2xkOiBpbXBvcnRhbnQsIHJlZDogZXJyb3J9Ij5NYXAgU3ludGF4IEV4YW1wbGU8L3A+CiAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImRlbGV0ZWQiPiBkZWxldGVkIChhcHBseSAic3RyaWtlIiBjbGFzcyk8YnI+CiAgIDxpbnB1dCB0eXBlPSJjaGVja2JveCIgbmctbW9kZWw9ImltcG9ydGFudCI+IGltcG9ydGFudCAoYXBwbHkgImJvbGQiIGNsYXNzKTxicj4KICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iZXJyb3IiPiBlcnJvciAoYXBwbHkgInJlZCIgY2xhc3MpCiAgIDxocj4KICAgPHAgbmctY2xhc3M9InN0eWxlIj5Vc2luZyBTdHJpbmcgU3ludGF4PC9wPgogICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InN0eWxlIiBwbGFjZWhvbGRlcj0iVHlwZTogYm9sZCBzdHJpa2UgcmVkIj4KICAgPGhyPgogICA8cCBuZy1jbGFzcz0iW3N0eWxlMSwgc3R5bGUyLCBzdHlsZTNdIj5Vc2luZyBBcnJheSBTeW50YXg8L3A+CiAgIDxpbnB1dCBuZy1tb2RlbD0ic3R5bGUxIiBwbGFjZWhvbGRlcj0iVHlwZTogYm9sZCwgc3RyaWtlIG9yIHJlZCI+PGJyPgogICA8aW5wdXQgbmctbW9kZWw9InN0eWxlMiIgcGxhY2Vob2xkZXI9IlR5cGU6IGJvbGQsIHN0cmlrZSBvciByZWQiPjxicj4KICAgPGlucHV0IG5nLW1vZGVsPSJzdHlsZTMiIHBsYWNlaG9sZGVyPSJUeXBlOiBib2xkLCBzdHJpa2Ugb3IgcmVkIj48YnI+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgLnN0cmlrZSB7CiAgICAgICAgIHRleHQtZGVjb3JhdGlvbjogbGluZS10aHJvdWdoOwogICAgICAgfQogICAuYm9sZCB7CiAgICAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7CiAgICAgICB9CiAgIC5yZWQgewogICAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIHZhciBwcyA9IGVsZW1lbnQuYWxsKGJ5LmNzcygncCcpKTsKCiAgIGl0KCdzaG91bGQgbGV0IHlvdSB0b2dnbGUgdGhlIGNsYXNzJywgZnVuY3Rpb24oKSB7CgogICAgICAgICBleHBlY3QocHMuZmlyc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLm5vdC50b01hdGNoKC9ib2xkLyk7CiAgICAgICAgIGV4cGVjdChwcy5maXJzdCgpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkubm90LnRvTWF0Y2goL3JlZC8pOwoKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnaW1wb3J0YW50JykpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChwcy5maXJzdCgpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9NYXRjaCgvYm9sZC8pOwoKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnZXJyb3InKSkuY2xpY2soKTsKICAgICAgICAgZXhwZWN0KHBzLmZpcnN0KCkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS50b01hdGNoKC9yZWQvKTsKICAgICAgIH0pOwoKICAgaXQoJ3Nob3VsZCBsZXQgeW91IHRvZ2dsZSBzdHJpbmcgZXhhbXBsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QocHMuZ2V0KDEpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkudG9CZSgnJyk7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3N0eWxlJykpLmNsZWFyKCk7CiAgICAgICAgIGVsZW1lbnQoYnkubW9kZWwoJ3N0eWxlJykpLnNlbmRLZXlzKCdyZWQnKTsKICAgICAgICAgZXhwZWN0KHBzLmdldCgxKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvQmUoJ3JlZCcpOwogICAgICAgfSk7CgogICBpdCgnYXJyYXkgZXhhbXBsZSBzaG91bGQgaGF2ZSAzIGNsYXNzZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KHBzLmxhc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvQmUoJycpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzdHlsZTEnKSkuc2VuZEtleXMoJ2JvbGQnKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc3R5bGUyJykpLnNlbmRLZXlzKCdzdHJpa2UnKTsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc3R5bGUzJykpLnNlbmRLZXlzKCdyZWQnKTsKICAgICAgICAgZXhwZWN0KHBzLmxhc3QoKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLnRvQmUoJ2JvbGQgc3RyaWtlIHJlZCcpOwogICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgoKICAgIyMgQW5pbWF0aW9ucwoKICAgVGhlIGV4YW1wbGUgYmVsb3cgZGVtb25zdHJhdGVzIGhvdyB0byBwZXJmb3JtIGFuaW1hdGlvbnMgdXNpbmcgbmdDbGFzcy4KCiAgIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGlucHV0IGlkPSJzZXRidG4iIHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCIgbmctY2xpY2s9Im15VmFyPSdteS1jbGFzcyciPgogICA8aW5wdXQgaWQ9ImNsZWFyYnRuIiB0eXBlPSJidXR0b24iIHZhbHVlPSJjbGVhciIgbmctY2xpY2s9Im15VmFyPScnIj4KICAgPGJyPgogICA8c3BhbiBjbGFzcz0iYmFzZS1jbGFzcyIgbmctY2xhc3M9Im15VmFyIj5TYW1wbGUgVGV4dDwvc3Bhbj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAuYmFzZS1jbGFzcyB7CiAgICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgICB0cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICB9CgogICAuYmFzZS1jbGFzcy5teS1jbGFzcyB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICAgIGZvbnQtc2l6ZTozZW07CiAgICAgICB9CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcuYmFzZS1jbGFzcycpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLm5vdC4KICAgICAgICAgICB0b01hdGNoKC9teS1jbGFzcy8pOwoKICAgICAgICAgZWxlbWVudChieS5pZCgnc2V0YnRuJykpLmNsaWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJy5iYXNlLWNsYXNzJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvbXktY2xhc3MvKTsKCiAgICAgICAgIGVsZW1lbnQoYnkuaWQoJ2NsZWFyYnRuJykpLmNsaWNrKCk7CgogICAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJy5iYXNlLWNsYXNzJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkubm90LgogICAgICAgICAgIHRvTWF0Y2goL215LWNsYXNzLyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CgoKICAgIyMgbmdDbGFzcyBhbmQgcHJlLWV4aXN0aW5nIENTUzMgVHJhbnNpdGlvbnMvQW5pbWF0aW9ucwogICBUaGUgbmdDbGFzcyBkaXJlY3RpdmUgc3RpbGwgc3VwcG9ydHMgQ1NTMyBUcmFuc2l0aW9ucy9BbmltYXRpb25zIGV2ZW4gaWYgdGhleSBkbyBub3QgZm9sbG93IHRoZSBuZ0FuaW1hdGUgQ1NTIG5hbWluZyBzdHJ1Y3R1cmUuCiAgIFVwb24gYW5pbWF0aW9uIG5nQW5pbWF0ZSB3aWxsIGFwcGx5IHN1cHBsZW1lbnRhcnkgQ1NTIGNsYXNzZXMgdG8gdHJhY2sgdGhlIHN0YXJ0IGFuZCBlbmQgb2YgYW4gYW5pbWF0aW9uLCBidXQgdGhpcyB3aWxsIG5vdCBoaW5kZXIKICAgYW55IHByZS1leGlzdGluZyBDU1MgdHJhbnNpdGlvbnMgYWxyZWFkeSBvbiB0aGUgZWxlbWVudC4gVG8gZ2V0IGFuIGlkZWEgb2Ygd2hhdCBoYXBwZW5zIGR1cmluZyBhIGNsYXNzLWJhc2VkIGFuaW1hdGlvbiwgYmUgc3VyZQogICB0byB2aWV3IHRoZSBzdGVwIGJ5IHN0ZXAgZGV0YWlscyBvZiB7QGxpbmsgbmdBbmltYXRlLiRhbmltYXRlI2FkZGNsYXNzICRhbmltYXRlLmFkZENsYXNzfSBhbmQKICAge0BsaW5rIG5nQW5pbWF0ZS4kYW5pbWF0ZSNyZW1vdmVjbGFzcyAkYW5pbWF0ZS5yZW1vdmVDbGFzc30uCiAgICovCiAgdmFyIG5nQ2xhc3NEaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnJywgdHJ1ZSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0NsYXNzT2RkCiAgICogQHJlc3RyaWN0IEFDCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgYG5nQ2xhc3NPZGRgIGFuZCBgbmdDbGFzc0V2ZW5gIGRpcmVjdGl2ZXMgd29yayBleGFjdGx5IGFzCiAgICoge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NsYXNzIG5nQ2xhc3N9LCBleGNlcHQgdGhleSB3b3JrIGluCiAgICogY29uanVuY3Rpb24gd2l0aCBgbmdSZXBlYXRgIGFuZCB0YWtlIGVmZmVjdCBvbmx5IG9uIG9kZCAoZXZlbikgcm93cy4KICAgKgogICAqIFRoaXMgZGlyZWN0aXZlIGNhbiBiZSBhcHBsaWVkIG9ubHkgd2l0aGluIHRoZSBzY29wZSBvZiBhbgogICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQgbmdSZXBlYXR9LgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NsYXNzT2RkIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuIFRoZSByZXN1bHQKICAgKiAgIG9mIHRoZSBldmFsdWF0aW9uIGNhbiBiZSBhIHN0cmluZyByZXByZXNlbnRpbmcgc3BhY2UgZGVsaW1pdGVkIGNsYXNzIG5hbWVzIG9yIGFuIGFycmF5LgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8b2wgbmctaW5pdD0ibmFtZXM9WydKb2huJywgJ01hcnknLCAnQ2F0ZScsICdTdXonXSI+CiAgIDxsaSBuZy1yZXBlYXQ9Im5hbWUgaW4gbmFtZXMiPgogICA8c3BhbiBuZy1jbGFzcy1vZGQ9IidvZGQnIiBuZy1jbGFzcy1ldmVuPSInZXZlbiciPgogICB7e25hbWV9fQogICA8L3NwYW4+CiAgIDwvbGk+CiAgIDwvb2w+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0ic3R5bGUuY3NzIj4KICAgLm9kZCB7CiAgICAgICAgIGNvbG9yOiByZWQ7CiAgICAgICB9CiAgIC5ldmVuIHsKICAgICAgICAgY29sb3I6IGJsdWU7CiAgICAgICB9CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgY2hlY2sgbmctY2xhc3Mtb2RkIGFuZCBuZy1jbGFzcy1ldmVuJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LnJlcGVhdGVyKCduYW1lIGluIG5hbWVzJykucm93KDApLmNvbHVtbignbmFtZScpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLgogICAgICAgICAgIHRvTWF0Y2goL29kZC8pOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5yZXBlYXRlcignbmFtZSBpbiBuYW1lcycpLnJvdygxKS5jb2x1bW4oJ25hbWUnKSkuZ2V0QXR0cmlidXRlKCdjbGFzcycpKS4KICAgICAgICAgICB0b01hdGNoKC9ldmVuLyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nQ2xhc3NPZGREaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnT2RkJywgMCk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0NsYXNzRXZlbgogICAqIEByZXN0cmljdCBBQwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGBuZ0NsYXNzT2RkYCBhbmQgYG5nQ2xhc3NFdmVuYCBkaXJlY3RpdmVzIHdvcmsgZXhhY3RseSBhcwogICAqIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGFzcyBuZ0NsYXNzfSwgZXhjZXB0IHRoZXkgd29yayBpbgogICAqIGNvbmp1bmN0aW9uIHdpdGggYG5nUmVwZWF0YCBhbmQgdGFrZSBlZmZlY3Qgb25seSBvbiBvZGQgKGV2ZW4pIHJvd3MuCiAgICoKICAgKiBUaGlzIGRpcmVjdGl2ZSBjYW4gYmUgYXBwbGllZCBvbmx5IHdpdGhpbiB0aGUgc2NvcGUgb2YgYW4KICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fS4KICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDbGFzc0V2ZW4ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4gVGhlCiAgICogICByZXN1bHQgb2YgdGhlIGV2YWx1YXRpb24gY2FuIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBzcGFjZSBkZWxpbWl0ZWQgY2xhc3MgbmFtZXMgb3IgYW4gYXJyYXkuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxvbCBuZy1pbml0PSJuYW1lcz1bJ0pvaG4nLCAnTWFyeScsICdDYXRlJywgJ1N1eiddIj4KICAgPGxpIG5nLXJlcGVhdD0ibmFtZSBpbiBuYW1lcyI+CiAgIDxzcGFuIG5nLWNsYXNzLW9kZD0iJ29kZCciIG5nLWNsYXNzLWV2ZW49IidldmVuJyI+CiAgIHt7bmFtZX19ICZuYnNwOyAmbmJzcDsgJm5ic3A7CiAgIDwvc3Bhbj4KICAgPC9saT4KICAgPC9vbD4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICAub2RkIHsKICAgICAgICAgY29sb3I6IHJlZDsKICAgICAgIH0KICAgLmV2ZW4gewogICAgICAgICBjb2xvcjogYmx1ZTsKICAgICAgIH0KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGFzcy1vZGQgYW5kIG5nLWNsYXNzLWV2ZW4nLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkucmVwZWF0ZXIoJ25hbWUgaW4gbmFtZXMnKS5yb3coMCkuY29sdW1uKCduYW1lJykpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSkuCiAgICAgICAgICAgdG9NYXRjaCgvb2RkLyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LnJlcGVhdGVyKCduYW1lIGluIG5hbWVzJykucm93KDEpLmNvbHVtbignbmFtZScpKS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykpLgogICAgICAgICAgIHRvTWF0Y2goL2V2ZW4vKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICB2YXIgbmdDbGFzc0V2ZW5EaXJlY3RpdmUgPSBjbGFzc0RpcmVjdGl2ZSgnRXZlbicsIDEpOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdDbG9hawogICAqIEByZXN0cmljdCBBQwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgaXMgdXNlZCB0byBwcmV2ZW50IHRoZSBBbmd1bGFyIGh0bWwgdGVtcGxhdGUgZnJvbSBiZWluZyBicmllZmx5CiAgICogZGlzcGxheWVkIGJ5IHRoZSBicm93c2VyIGluIGl0cyByYXcgKHVuY29tcGlsZWQpIGZvcm0gd2hpbGUgeW91ciBhcHBsaWNhdGlvbiBpcyBsb2FkaW5nLiBVc2UgdGhpcwogICAqIGRpcmVjdGl2ZSB0byBhdm9pZCB0aGUgdW5kZXNpcmFibGUgZmxpY2tlciBlZmZlY3QgY2F1c2VkIGJ5IHRoZSBodG1sIHRlbXBsYXRlIGRpc3BsYXkuCiAgICoKICAgKiBUaGUgZGlyZWN0aXZlIGNhbiBiZSBhcHBsaWVkIHRvIHRoZSBgPGJvZHk+YCBlbGVtZW50LCBidXQgdGhlIHByZWZlcnJlZCB1c2FnZSBpcyB0byBhcHBseQogICAqIG11bHRpcGxlIGBuZ0Nsb2FrYCBkaXJlY3RpdmVzIHRvIHNtYWxsIHBvcnRpb25zIG9mIHRoZSBwYWdlIHRvIHBlcm1pdCBwcm9ncmVzc2l2ZSByZW5kZXJpbmcKICAgKiBvZiB0aGUgYnJvd3NlciB2aWV3LgogICAqCiAgICogYG5nQ2xvYWtgIHdvcmtzIGluIGNvb3BlcmF0aW9uIHdpdGggdGhlIGZvbGxvd2luZyBjc3MgcnVsZSBlbWJlZGRlZCB3aXRoaW4gYGFuZ3VsYXIuanNgIGFuZAogICAqIGBhbmd1bGFyLm1pbi5qc2AuCiAgICogRm9yIENTUCBtb2RlIHBsZWFzZSBhZGQgYGFuZ3VsYXItY3NwLmNzc2AgdG8geW91ciBodG1sIGZpbGUgKHNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ3NwIG5nQ3NwfSkuCiAgICoKICAgKiBgYGBjc3MKICAgKiBbbmdcOmNsb2FrXSwgW25nLWNsb2FrXSwgW2RhdGEtbmctY2xvYWtdLCBbeC1uZy1jbG9ha10sIC5uZy1jbG9haywgLngtbmctY2xvYWsgewogKiAgIGRpc3BsYXk6IG5vbmUgIWltcG9ydGFudDsKICogfQogICAqIGBgYAogICAqCiAgICogV2hlbiB0aGlzIGNzcyBydWxlIGlzIGxvYWRlZCBieSB0aGUgYnJvd3NlciwgYWxsIGh0bWwgZWxlbWVudHMgKGluY2x1ZGluZyB0aGVpciBjaGlsZHJlbikgdGhhdAogICAqIGFyZSB0YWdnZWQgd2l0aCB0aGUgYG5nQ2xvYWtgIGRpcmVjdGl2ZSBhcmUgaGlkZGVuLiBXaGVuIEFuZ3VsYXIgZW5jb3VudGVycyB0aGlzIGRpcmVjdGl2ZQogICAqIGR1cmluZyB0aGUgY29tcGlsYXRpb24gb2YgdGhlIHRlbXBsYXRlIGl0IGRlbGV0ZXMgdGhlIGBuZ0Nsb2FrYCBlbGVtZW50IGF0dHJpYnV0ZSwgbWFraW5nCiAgICogdGhlIGNvbXBpbGVkIGVsZW1lbnQgdmlzaWJsZS4KICAgKgogICAqIEZvciB0aGUgYmVzdCByZXN1bHQsIHRoZSBgYW5ndWxhci5qc2Agc2NyaXB0IG11c3QgYmUgbG9hZGVkIGluIHRoZSBoZWFkIHNlY3Rpb24gb2YgdGhlIGh0bWwKICAgKiBkb2N1bWVudDsgYWx0ZXJuYXRpdmVseSwgdGhlIGNzcyBydWxlIGFib3ZlIG11c3QgYmUgaW5jbHVkZWQgaW4gdGhlIGV4dGVybmFsIHN0eWxlc2hlZXQgb2YgdGhlCiAgICogYXBwbGljYXRpb24uCiAgICoKICAgKiBMZWdhY3kgYnJvd3NlcnMsIGxpa2UgSUU3LCBkbyBub3QgcHJvdmlkZSBhdHRyaWJ1dGUgc2VsZWN0b3Igc3VwcG9ydCAoYWRkZWQgaW4gQ1NTIDIuMSkgc28gdGhleQogICAqIGNhbm5vdCBtYXRjaCB0aGUgYFtuZ1w6Y2xvYWtdYCBzZWxlY3Rvci4gVG8gd29yayBhcm91bmQgdGhpcyBsaW1pdGF0aW9uLCB5b3UgbXVzdCBhZGQgdGhlIGNzcwogICAqIGNsYXNzIGBuZy1jbG9ha2AgaW4gYWRkaXRpb24gdG8gdGhlIGBuZ0Nsb2FrYCBkaXJlY3RpdmUgYXMgc2hvd24gaW4gdGhlIGV4YW1wbGUgYmVsb3cuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGRpdiBpZD0idGVtcGxhdGUxIiBuZy1jbG9haz57eyAnaGVsbG8nIH19PC9kaXY+CiAgIDxkaXYgaWQ9InRlbXBsYXRlMiIgbmctY2xvYWsgY2xhc3M9Im5nLWNsb2FrIj57eyAnaGVsbG8gSUU3JyB9fTwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIHJlbW92ZSB0aGUgdGVtcGxhdGUgZGlyZWN0aXZlIGFuZCBjc3MgY2xhc3MnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KCQoJyN0ZW1wbGF0ZTEnKS5nZXRBdHRyaWJ1dGUoJ25nLWNsb2FrJykpLgogICAgICAgICAgIHRvQmVOdWxsKCk7CiAgICAgICAgIGV4cGVjdCgkKCcjdGVtcGxhdGUyJykuZ2V0QXR0cmlidXRlKCduZy1jbG9haycpKS4KICAgICAgICAgICB0b0JlTnVsbCgpOwogICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqCiAgICovCiAgdmFyIG5nQ2xvYWtEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgIGF0dHIuJHNldCgnbmdDbG9haycsIHVuZGVmaW5lZCk7CiAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoJ25nLWNsb2FrJyk7CiAgICB9CiAgfSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0NvbnRyb2xsZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdDb250cm9sbGVyYCBkaXJlY3RpdmUgYXR0YWNoZXMgYSBjb250cm9sbGVyIGNsYXNzIHRvIHRoZSB2aWV3LiBUaGlzIGlzIGEga2V5IGFzcGVjdCBvZiBob3cgYW5ndWxhcgogICAqIHN1cHBvcnRzIHRoZSBwcmluY2lwbGVzIGJlaGluZCB0aGUgTW9kZWwtVmlldy1Db250cm9sbGVyIGRlc2lnbiBwYXR0ZXJuLgogICAqCiAgICogTVZDIGNvbXBvbmVudHMgaW4gYW5ndWxhcjoKICAgKgogICAqICogTW9kZWwg4oCUIFRoZSBNb2RlbCBpcyBzY29wZSBwcm9wZXJ0aWVzOyBzY29wZXMgYXJlIGF0dGFjaGVkIHRvIHRoZSBET00gd2hlcmUgc2NvcGUgcHJvcGVydGllcwogICAqICAgYXJlIGFjY2Vzc2VkIHRocm91Z2ggYmluZGluZ3MuCiAgICogKiBWaWV3IOKAlCBUaGUgdGVtcGxhdGUgKEhUTUwgd2l0aCBkYXRhIGJpbmRpbmdzKSB0aGF0IGlzIHJlbmRlcmVkIGludG8gdGhlIFZpZXcuCiAgICogKiBDb250cm9sbGVyIOKAlCBUaGUgYG5nQ29udHJvbGxlcmAgZGlyZWN0aXZlIHNwZWNpZmllcyBhIENvbnRyb2xsZXIgY2xhc3M7IHRoZSBjbGFzcyBjb250YWlucyBidXNpbmVzcwogICAqICAgbG9naWMgYmVoaW5kIHRoZSBhcHBsaWNhdGlvbiB0byBkZWNvcmF0ZSB0aGUgc2NvcGUgd2l0aCBmdW5jdGlvbnMgYW5kIHZhbHVlcwogICAqCiAgICogTm90ZSB0aGF0IHlvdSBjYW4gYWxzbyBhdHRhY2ggY29udHJvbGxlcnMgdG8gdGhlIERPTSBieSBkZWNsYXJpbmcgaXQgaW4gYSByb3V0ZSBkZWZpbml0aW9uCiAgICogdmlhIHRoZSB7QGxpbmsgbmdSb3V0ZS4kcm91dGUgJHJvdXRlfSBzZXJ2aWNlLiBBIGNvbW1vbiBtaXN0YWtlIGlzIHRvIGRlY2xhcmUgdGhlIGNvbnRyb2xsZXIKICAgKiBhZ2FpbiB1c2luZyBgbmctY29udHJvbGxlcmAgaW4gdGhlIHRlbXBsYXRlIGl0c2VsZi4gIFRoaXMgd2lsbCBjYXVzZSB0aGUgY29udHJvbGxlciB0byBiZSBhdHRhY2hlZAogICAqIGFuZCBleGVjdXRlZCB0d2ljZS4KICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBzY29wZQogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdDb250cm9sbGVyIE5hbWUgb2YgYSBnbG9iYWxseSBhY2Nlc3NpYmxlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIG9yIGFuCiAgICogICAgIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IHRoYXQgb24gdGhlIGN1cnJlbnQgc2NvcGUgZXZhbHVhdGVzIHRvIGEKICAgKiAgICAgY29uc3RydWN0b3IgZnVuY3Rpb24uIFRoZSBjb250cm9sbGVyIGluc3RhbmNlIGNhbiBiZSBwdWJsaXNoZWQgaW50byBhIHNjb3BlIHByb3BlcnR5CiAgICogICAgIGJ5IHNwZWNpZnlpbmcgYGFzIHByb3BlcnR5TmFtZWAuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIEhlcmUgaXMgYSBzaW1wbGUgZm9ybSBmb3IgZWRpdGluZyB1c2VyIGNvbnRhY3QgaW5mb3JtYXRpb24uIEFkZGluZywgcmVtb3ZpbmcsIGNsZWFyaW5nLCBhbmQKICAgKiBncmVldGluZyBhcmUgbWV0aG9kcyBkZWNsYXJlZCBvbiB0aGUgY29udHJvbGxlciAoc2VlIHNvdXJjZSB0YWIpLiBUaGVzZSBtZXRob2RzIGNhbgogICAqIGVhc2lseSBiZSBjYWxsZWQgZnJvbSB0aGUgYW5ndWxhciBtYXJrdXAuIEFueSBjaGFuZ2VzIHRvIHRoZSBkYXRhIGFyZSBhdXRvbWF0aWNhbGx5IHJlZmxlY3RlZAogICAqIGluIHRoZSBWaWV3IHdpdGhvdXQgdGhlIG5lZWQgZm9yIGEgbWFudWFsIHVwZGF0ZS4KICAgKgogICAqIFR3byBkaWZmZXJlbnQgZGVjbGFyYXRpb24gc3R5bGVzIGFyZSBpbmNsdWRlZCBiZWxvdzoKICAgKgogICAqICogb25lIGJpbmRzIG1ldGhvZHMgYW5kIHByb3BlcnRpZXMgZGlyZWN0bHkgb250byB0aGUgY29udHJvbGxlciB1c2luZyBgdGhpc2A6CiAgICogYG5nLWNvbnRyb2xsZXI9IlNldHRpbmdzQ29udHJvbGxlcjEgYXMgc2V0dGluZ3MiYAogICAqICogb25lIGluamVjdHMgYCRzY29wZWAgaW50byB0aGUgY29udHJvbGxlcjoKICAgKiBgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyMiJgCiAgICoKICAgKiBUaGUgc2Vjb25kIG9wdGlvbiBpcyBtb3JlIGNvbW1vbiBpbiB0aGUgQW5ndWxhciBjb21tdW5pdHksIGFuZCBpcyBnZW5lcmFsbHkgdXNlZCBpbiBib2lsZXJwbGF0ZXMKICAgKiBhbmQgaW4gdGhpcyBndWlkZS4gSG93ZXZlciwgdGhlcmUgYXJlIGFkdmFudGFnZXMgdG8gYmluZGluZyBwcm9wZXJ0aWVzIGRpcmVjdGx5IHRvIHRoZSBjb250cm9sbGVyCiAgICogYW5kIGF2b2lkaW5nIHNjb3BlLgogICAqCiAgICogKiBVc2luZyBgY29udHJvbGxlciBhc2AgbWFrZXMgaXQgb2J2aW91cyB3aGljaCBjb250cm9sbGVyIHlvdSBhcmUgYWNjZXNzaW5nIGluIHRoZSB0ZW1wbGF0ZSB3aGVuCiAgICogbXVsdGlwbGUgY29udHJvbGxlcnMgYXBwbHkgdG8gYW4gZWxlbWVudC4KICAgKiAqIElmIHlvdSBhcmUgd3JpdGluZyB5b3VyIGNvbnRyb2xsZXJzIGFzIGNsYXNzZXMgeW91IGhhdmUgZWFzaWVyIGFjY2VzcyB0byB0aGUgcHJvcGVydGllcyBhbmQKICAgKiBtZXRob2RzLCB3aGljaCB3aWxsIGFwcGVhciBvbiB0aGUgc2NvcGUsIGZyb20gaW5zaWRlIHRoZSBjb250cm9sbGVyIGNvZGUuCiAgICogKiBTaW5jZSB0aGVyZSBpcyBhbHdheXMgYSBgLmAgaW4gdGhlIGJpbmRpbmdzLCB5b3UgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCBwcm90b3R5cGFsCiAgICogaW5oZXJpdGFuY2UgbWFza2luZyBwcmltaXRpdmVzLgogICAqCiAgICogVGhpcyBleGFtcGxlIGRlbW9uc3RyYXRlcyB0aGUgYGNvbnRyb2xsZXIgYXNgIHN5bnRheC4KICAgKgogICAqIDxleGFtcGxlIG5hbWU9Im5nQ29udHJvbGxlckFzIj4KICAgKiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAqICAgIDxkaXYgaWQ9ImN0cmwtYXMtZXhtcGwiIG5nLWNvbnRyb2xsZXI9IlNldHRpbmdzQ29udHJvbGxlcjEgYXMgc2V0dGluZ3MiPgogICAqICAgICAgTmFtZTogPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJzZXR0aW5ncy5uYW1lIi8+CiAgICogICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLmdyZWV0KCkiPmdyZWV0PC9hPiBdPGJyLz4KICAgKiAgICAgIENvbnRhY3Q6CiAgICogICAgICA8dWw+CiAgICogICAgICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gc2V0dGluZ3MuY29udGFjdHMiPgogICAqICAgICAgICAgIDxzZWxlY3QgbmctbW9kZWw9ImNvbnRhY3QudHlwZSI+CiAgICogICAgICAgICAgICAgPG9wdGlvbj5waG9uZTwvb3B0aW9uPgogICAqICAgICAgICAgICAgIDxvcHRpb24+ZW1haWw8L29wdGlvbj4KICAgKiAgICAgICAgICA8L3NlbGVjdD4KICAgKiAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9ImNvbnRhY3QudmFsdWUiLz4KICAgKiAgICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLmNsZWFyQ29udGFjdChjb250YWN0KSI+Y2xlYXI8L2E+CiAgICogICAgICAgICAgfCA8YSBocmVmPSIiIG5nLWNsaWNrPSJzZXR0aW5ncy5yZW1vdmVDb250YWN0KGNvbnRhY3QpIj5YPC9hPiBdCiAgICogICAgICAgIDwvbGk+CiAgICogICAgICAgIDxsaT5bIDxhIGhyZWY9IiIgbmctY2xpY2s9InNldHRpbmdzLmFkZENvbnRhY3QoKSI+YWRkPC9hPiBdPC9saT4KICAgKiAgICAgPC91bD4KICAgKiAgICA8L2Rpdj4KICAgKiAgIDwvZmlsZT4KICAgKiAgIDxmaWxlIG5hbWU9ImFwcC5qcyI+CiAgICogICAgZnVuY3Rpb24gU2V0dGluZ3NDb250cm9sbGVyMSgpIHsKICogICAgICB0aGlzLm5hbWUgPSAiSm9obiBTbWl0aCI7CiAqICAgICAgdGhpcy5jb250YWN0cyA9IFsKICogICAgICAgIHt0eXBlOiAncGhvbmUnLCB2YWx1ZTogJzQwOCA1NTUgMTIxMid9LAogKiAgICAgICAge3R5cGU6ICdlbWFpbCcsIHZhbHVlOiAnam9obi5zbWl0aEBleGFtcGxlLm9yZyd9IF07CiAgICogICAgfQogICAqCiAgICogICAgU2V0dGluZ3NDb250cm9sbGVyMS5wcm90b3R5cGUuZ3JlZXQgPSBmdW5jdGlvbigpIHsKICogICAgICBhbGVydCh0aGlzLm5hbWUpOwogKiAgICB9OwogICAqCiAgICogICAgU2V0dGluZ3NDb250cm9sbGVyMS5wcm90b3R5cGUuYWRkQ29udGFjdCA9IGZ1bmN0aW9uKCkgewogKiAgICAgIHRoaXMuY29udGFjdHMucHVzaCh7dHlwZTogJ2VtYWlsJywgdmFsdWU6ICd5b3VybmFtZUBleGFtcGxlLm9yZyd9KTsKICAgKiAgICB9OwogICAqCiAgICogICAgU2V0dGluZ3NDb250cm9sbGVyMS5wcm90b3R5cGUucmVtb3ZlQ29udGFjdCA9IGZ1bmN0aW9uKGNvbnRhY3RUb1JlbW92ZSkgewogKiAgICAgdmFyIGluZGV4ID0gdGhpcy5jb250YWN0cy5pbmRleE9mKGNvbnRhY3RUb1JlbW92ZSk7CiAqICAgICAgdGhpcy5jb250YWN0cy5zcGxpY2UoaW5kZXgsIDEpOwogKiAgICB9OwogICAqCiAgICogICAgU2V0dGluZ3NDb250cm9sbGVyMS5wcm90b3R5cGUuY2xlYXJDb250YWN0ID0gZnVuY3Rpb24oY29udGFjdCkgewogKiAgICAgIGNvbnRhY3QudHlwZSA9ICdwaG9uZSc7CiAqICAgICAgY29udGFjdC52YWx1ZSA9ICcnOwogKiAgICB9OwogICAqICAgPC9maWxlPgogICAqICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgICogICAgIGl0KCdzaG91bGQgY2hlY2sgY29udHJvbGxlciBhcycsIGZ1bmN0aW9uKCkgewogKiAgICAgICB2YXIgY29udGFpbmVyID0gZWxlbWVudChieS5pZCgnY3RybC1hcy1leG1wbCcpKTsKICogICAgICAgICBleHBlY3QoY29udGFpbmVyLmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdzZXR0aW5ncy5uYW1lJykpCiAqICAgICAgICAgICAuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKS50b0JlKCdKb2huIFNtaXRoJyk7CiAqCiAqICAgICAgIHZhciBmaXJzdFJlcGVhdCA9CiAqICAgICAgICAgICBjb250YWluZXIuZmluZEVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gc2V0dGluZ3MuY29udGFjdHMnKS5yb3coMCkpOwogKiAgICAgICB2YXIgc2Vjb25kUmVwZWF0ID0KICogICAgICAgICAgIGNvbnRhaW5lci5maW5kRWxlbWVudChieS5yZXBlYXRlcignY29udGFjdCBpbiBzZXR0aW5ncy5jb250YWN0cycpLnJvdygxKSk7CiAqCiAqICAgICAgIGV4cGVjdChmaXJzdFJlcGVhdC5maW5kRWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykpCiAqICAgICAgICAgICAudG9CZSgnNDA4IDU1NSAxMjEyJyk7CiAqCiAqICAgICAgIGV4cGVjdChzZWNvbmRSZXBlYXQuZmluZEVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAgLnRvQmUoJ2pvaG4uc21pdGhAZXhhbXBsZS5vcmcnKTsKICAgKgogICAqICAgICAgIGZpcnN0UmVwZWF0LmZpbmRFbGVtZW50KGJ5LmxpbmtUZXh0KCdjbGVhcicpKS5jbGljaygpOwogICAqCiAgICogICAgICAgZXhwZWN0KGZpcnN0UmVwZWF0LmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICAgKiAgICAgICAgICAgLnRvQmUoJycpOwogICAqCiAgICogICAgICAgY29udGFpbmVyLmZpbmRFbGVtZW50KGJ5LmxpbmtUZXh0KCdhZGQnKSkuY2xpY2soKTsKICAgKgogICAqICAgICAgIGV4cGVjdChjb250YWluZXIuZmluZEVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gc2V0dGluZ3MuY29udGFjdHMnKS5yb3coMikpCiAgICogICAgICAgICAgIC5maW5kRWxlbWVudChieS5tb2RlbCgnY29udGFjdC52YWx1ZScpKQogICAqICAgICAgICAgICAuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogICAqICAgICAgICAgICAudG9CZSgneW91cm5hbWVAZXhhbXBsZS5vcmcnKTsKICAgKiAgICAgfSk7CiAgICogICA8L2ZpbGU+CiAgICogPC9leGFtcGxlPgogICAqCiAgICogVGhpcyBleGFtcGxlIGRlbW9uc3RyYXRlcyB0aGUgImF0dGFjaCB0byBgJHNjb3BlYCIgc3R5bGUgb2YgY29udHJvbGxlci4KICAgKgogICAqIDxleGFtcGxlIG5hbWU9Im5nQ29udHJvbGxlciI+CiAgICogIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICAqICAgPGRpdiBpZD0iY3RybC1leG1wbCIgbmctY29udHJvbGxlcj0iU2V0dGluZ3NDb250cm9sbGVyMiI+CiAgICogICAgIE5hbWU6IDxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0ibmFtZSIvPgogICAqICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9ImdyZWV0KCkiPmdyZWV0PC9hPiBdPGJyLz4KICAgKiAgICAgQ29udGFjdDoKICAgKiAgICAgPHVsPgogICAqICAgICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gY29udGFjdHMiPgogICAqICAgICAgICAgPHNlbGVjdCBuZy1tb2RlbD0iY29udGFjdC50eXBlIj4KICAgKiAgICAgICAgICAgIDxvcHRpb24+cGhvbmU8L29wdGlvbj4KICAgKiAgICAgICAgICAgIDxvcHRpb24+ZW1haWw8L29wdGlvbj4KICAgKiAgICAgICAgIDwvc2VsZWN0PgogICAqICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJjb250YWN0LnZhbHVlIi8+CiAgICogICAgICAgICBbIDxhIGhyZWY9IiIgbmctY2xpY2s9ImNsZWFyQ29udGFjdChjb250YWN0KSI+Y2xlYXI8L2E+CiAgICogICAgICAgICB8IDxhIGhyZWY9IiIgbmctY2xpY2s9InJlbW92ZUNvbnRhY3QoY29udGFjdCkiPlg8L2E+IF0KICAgKiAgICAgICA8L2xpPgogICAqICAgICAgIDxsaT5bIDxhIGhyZWY9IiIgbmctY2xpY2s9ImFkZENvbnRhY3QoKSI+YWRkPC9hPiBdPC9saT4KICAgKiAgICA8L3VsPgogICAqICAgPC9kaXY+CiAgICogIDwvZmlsZT4KICAgKiAgPGZpbGUgbmFtZT0iYXBwLmpzIj4KICAgKiAgIGZ1bmN0aW9uIFNldHRpbmdzQ29udHJvbGxlcjIoJHNjb3BlKSB7CiAqICAgICAkc2NvcGUubmFtZSA9ICJKb2huIFNtaXRoIjsKICogICAgICRzY29wZS5jb250YWN0cyA9IFsKICogICAgICAge3R5cGU6J3Bob25lJywgdmFsdWU6JzQwOCA1NTUgMTIxMid9LAogKiAgICAgICB7dHlwZTonZW1haWwnLCB2YWx1ZTonam9obi5zbWl0aEBleGFtcGxlLm9yZyd9IF07CiAgICoKICAgKiAgICAgJHNjb3BlLmdyZWV0ID0gZnVuY3Rpb24oKSB7CiAqICAgICAgIGFsZXJ0KCRzY29wZS5uYW1lKTsKICogICAgIH07CiAgICoKICAgKiAgICAgJHNjb3BlLmFkZENvbnRhY3QgPSBmdW5jdGlvbigpIHsKICogICAgICAgJHNjb3BlLmNvbnRhY3RzLnB1c2goe3R5cGU6J2VtYWlsJywgdmFsdWU6J3lvdXJuYW1lQGV4YW1wbGUub3JnJ30pOwogICAqICAgICB9OwogICAqCiAgICogICAgICRzY29wZS5yZW1vdmVDb250YWN0ID0gZnVuY3Rpb24oY29udGFjdFRvUmVtb3ZlKSB7CiAqICAgICAgIHZhciBpbmRleCA9ICRzY29wZS5jb250YWN0cy5pbmRleE9mKGNvbnRhY3RUb1JlbW92ZSk7CiAqICAgICAgICRzY29wZS5jb250YWN0cy5zcGxpY2UoaW5kZXgsIDEpOwogKiAgICAgfTsKICAgKgogICAqICAgICAkc2NvcGUuY2xlYXJDb250YWN0ID0gZnVuY3Rpb24oY29udGFjdCkgewogKiAgICAgICBjb250YWN0LnR5cGUgPSAncGhvbmUnOwogKiAgICAgICBjb250YWN0LnZhbHVlID0gJyc7CiAqICAgICB9OwogICAqICAgfQogICAqICA8L2ZpbGU+CiAgICogIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICAqICAgIGl0KCdzaG91bGQgY2hlY2sgY29udHJvbGxlcicsIGZ1bmN0aW9uKCkgewogKiAgICAgIHZhciBjb250YWluZXIgPSBlbGVtZW50KGJ5LmlkKCdjdHJsLWV4bXBsJykpOwogKgogKiAgICAgIGV4cGVjdChjb250YWluZXIuZmluZEVsZW1lbnQoYnkubW9kZWwoJ25hbWUnKSkKICogICAgICAgICAgLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9CZSgnSm9obiBTbWl0aCcpOwogKgogKiAgICAgIHZhciBmaXJzdFJlcGVhdCA9CiAqICAgICAgICAgIGNvbnRhaW5lci5maW5kRWxlbWVudChieS5yZXBlYXRlcignY29udGFjdCBpbiBjb250YWN0cycpLnJvdygwKSk7CiAqICAgICAgdmFyIHNlY29uZFJlcGVhdCA9CiAqICAgICAgICAgIGNvbnRhaW5lci5maW5kRWxlbWVudChieS5yZXBlYXRlcignY29udGFjdCBpbiBjb250YWN0cycpLnJvdygxKSk7CiAqCiAqICAgICAgZXhwZWN0KGZpcnN0UmVwZWF0LmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICogICAgICAgICAgLnRvQmUoJzQwOCA1NTUgMTIxMicpOwogKiAgICAgIGV4cGVjdChzZWNvbmRSZXBlYXQuZmluZEVsZW1lbnQoYnkubW9kZWwoJ2NvbnRhY3QudmFsdWUnKSkuZ2V0QXR0cmlidXRlKCd2YWx1ZScpKQogKiAgICAgICAgICAudG9CZSgnam9obi5zbWl0aEBleGFtcGxlLm9yZycpOwogICAqCiAgICogICAgICBmaXJzdFJlcGVhdC5maW5kRWxlbWVudChieS5saW5rVGV4dCgnY2xlYXInKSkuY2xpY2soKTsKICAgKgogICAqICAgICAgZXhwZWN0KGZpcnN0UmVwZWF0LmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICAgKiAgICAgICAgICAudG9CZSgnJyk7CiAgICoKICAgKiAgICAgIGNvbnRhaW5lci5maW5kRWxlbWVudChieS5saW5rVGV4dCgnYWRkJykpLmNsaWNrKCk7CiAgICoKICAgKiAgICAgIGV4cGVjdChjb250YWluZXIuZmluZEVsZW1lbnQoYnkucmVwZWF0ZXIoJ2NvbnRhY3QgaW4gY29udGFjdHMnKS5yb3coMikpCiAgICogICAgICAgICAgLmZpbmRFbGVtZW50KGJ5Lm1vZGVsKCdjb250YWN0LnZhbHVlJykpCiAgICogICAgICAgICAgLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkKICAgKiAgICAgICAgICAudG9CZSgneW91cm5hbWVAZXhhbXBsZS5vcmcnKTsKICAgKiAgICB9KTsKICAgKiAgPC9maWxlPgogICAqPC9leGFtcGxlPgoKICAgKi8KICB2YXIgbmdDb250cm9sbGVyRGlyZWN0aXZlID0gW2Z1bmN0aW9uKCkgewogICAgcmV0dXJuIHsKICAgICAgc2NvcGU6IHRydWUsCiAgICAgIGNvbnRyb2xsZXI6ICdAJywKICAgICAgcHJpb3JpdHk6IDUwMAogICAgfTsKICB9XTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nQ3NwCiAgICoKICAgKiBAZWxlbWVudCBodG1sCiAgICogQGRlc2NyaXB0aW9uCiAgICogRW5hYmxlcyBbQ1NQIChDb250ZW50IFNlY3VyaXR5IFBvbGljeSldKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL1NlY3VyaXR5L0NTUCkgc3VwcG9ydC4KICAgKgogICAqIFRoaXMgaXMgbmVjZXNzYXJ5IHdoZW4gZGV2ZWxvcGluZyB0aGluZ3MgbGlrZSBHb29nbGUgQ2hyb21lIEV4dGVuc2lvbnMuCiAgICoKICAgKiBDU1AgZm9yYmlkcyBhcHBzIHRvIHVzZSBgZXZhbGAgb3IgYEZ1bmN0aW9uKHN0cmluZylgIGdlbmVyYXRlZCBmdW5jdGlvbnMgKGFtb25nIG90aGVyIHRoaW5ncykuCiAgICogRm9yIHVzIHRvIGJlIGNvbXBhdGlibGUsIHdlIGp1c3QgbmVlZCB0byBpbXBsZW1lbnQgdGhlICJnZXR0ZXJGbiIgaW4gJHBhcnNlIHdpdGhvdXQgdmlvbGF0aW5nCiAgICogYW55IG9mIHRoZXNlIHJlc3RyaWN0aW9ucy4KICAgKgogICAqIEFuZ3VsYXJKUyB1c2VzIGBGdW5jdGlvbihzdHJpbmcpYCBnZW5lcmF0ZWQgZnVuY3Rpb25zIGFzIGEgc3BlZWQgb3B0aW1pemF0aW9uLiBBcHBseWluZyB0aGUgYG5nQ3NwYAogICAqIGRpcmVjdGl2ZSB3aWxsIGNhdXNlIEFuZ3VsYXIgdG8gdXNlIENTUCBjb21wYXRpYmlsaXR5IG1vZGUuIFdoZW4gdGhpcyBtb2RlIGlzIG9uIEFuZ3VsYXJKUyB3aWxsCiAgICogZXZhbHVhdGUgYWxsIGV4cHJlc3Npb25zIHVwIHRvIDMwJSBzbG93ZXIgdGhhbiBpbiBub24tQ1NQIG1vZGUsIGJ1dCBubyBzZWN1cml0eSB2aW9sYXRpb25zIHdpbGwKICAgKiBiZSByYWlzZWQuCiAgICoKICAgKiBDU1AgZm9yYmlkcyBKYXZhU2NyaXB0IHRvIGlubGluZSBzdHlsZXNoZWV0IHJ1bGVzLiBJbiBub24gQ1NQIG1vZGUgQW5ndWxhciBhdXRvbWF0aWNhbGx5CiAgICogaW5jbHVkZXMgc29tZSBDU1MgcnVsZXMgKGUuZy4ge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0Nsb2FrIG5nQ2xvYWt9KS4KICAgKiBUbyBtYWtlIHRob3NlIGRpcmVjdGl2ZXMgd29yayBpbiBDU1AgbW9kZSwgaW5jbHVkZSB0aGUgYGFuZ3VsYXItY3NwLmNzc2AgbWFudWFsbHkuCiAgICoKICAgKiBJbiBvcmRlciB0byB1c2UgdGhpcyBmZWF0dXJlIHB1dCB0aGUgYG5nQ3NwYCBkaXJlY3RpdmUgb24gdGhlIHJvb3QgZWxlbWVudCBvZiB0aGUgYXBwbGljYXRpb24uCiAgICoKICAgKiAqTm90ZTogVGhpcyBkaXJlY3RpdmUgaXMgb25seSBhdmFpbGFibGUgaW4gdGhlIGBuZy1jc3BgIGFuZCBgZGF0YS1uZy1jc3BgIGF0dHJpYnV0ZSBmb3JtLioKICAgKgogICAqIEBleGFtcGxlCiAgICogVGhpcyBleGFtcGxlIHNob3dzIGhvdyB0byBhcHBseSB0aGUgYG5nQ3NwYCBkaXJlY3RpdmUgdG8gdGhlIGBodG1sYCB0YWcuCiAgIGBgYGh0bWwKICAgPCFkb2N0eXBlIGh0bWw+CiAgIDxodG1sIG5nLWFwcCBuZy1jc3A+CiAgIC4uLgogICAuLi4KICAgPC9odG1sPgogICBgYGAKICAgKi8KCi8vIG5nQ3NwIGlzIG5vdCBpbXBsZW1lbnRlZCBhcyBhIHByb3BlciBkaXJlY3RpdmUgYW55IG1vcmUsIGJlY2F1c2Ugd2UgbmVlZCBpdCBiZSBwcm9jZXNzZWQgd2hpbGUgd2UgYm9vdHN0cmFwCi8vIHRoZSBzeXN0ZW0gKGJlZm9yZSAkcGFyc2UgaXMgaW5zdGFudGlhdGVkKSwgZm9yIHRoaXMgcmVhc29uIHdlIGp1c3QgaGF2ZSBhIGNzcCgpIGZuIHRoYXQgbG9va3MgZm9yIG5nLWNzcCBhdHRyaWJ1dGUKLy8gYW55d2hlcmUgaW4gdGhlIGN1cnJlbnQgZG9jCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0NsaWNrCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgbmdDbGljayBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuCiAgICogYW4gZWxlbWVudCBpcyBjbGlja2VkLgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHByaW9yaXR5IDAKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nQ2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAqIGNsaWNrLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGJ1dHRvbiBuZy1jbGljaz0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICBJbmNyZW1lbnQKICAgPC9idXR0b24+CiAgIGNvdW50OiB7e2NvdW50fX0KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1jbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdjb3VudCcpKS5nZXRUZXh0KCkpLnRvTWF0Y2goJzAnKTsKICAgICAgICAgZWxlbWVudChieS5jc3MoJ2J1dHRvbicpKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdjb3VudCcpKS5nZXRUZXh0KCkpLnRvTWF0Y2goJzEnKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICAvKgogICAqIEEgZGlyZWN0aXZlIHRoYXQgYWxsb3dzIGNyZWF0aW9uIG9mIGN1c3RvbSBvbmNsaWNrIGhhbmRsZXJzIHRoYXQgYXJlIGRlZmluZWQgYXMgYW5ndWxhcgogICAqIGV4cHJlc3Npb25zIGFuZCBhcmUgY29tcGlsZWQgYW5kIGV4ZWN1dGVkIHdpdGhpbiB0aGUgY3VycmVudCBzY29wZS4KICAgKgogICAqIEV2ZW50cyB0aGF0IGFyZSBoYW5kbGVkIHZpYSB0aGVzZSBoYW5kbGVyIGFyZSBhbHdheXMgY29uZmlndXJlZCBub3QgdG8gcHJvcGFnYXRlIGZ1cnRoZXIuCiAgICovCiAgdmFyIG5nRXZlbnREaXJlY3RpdmVzID0ge307CiAgZm9yRWFjaCgKICAgICdjbGljayBkYmxjbGljayBtb3VzZWRvd24gbW91c2V1cCBtb3VzZW92ZXIgbW91c2VvdXQgbW91c2Vtb3ZlIG1vdXNlZW50ZXIgbW91c2VsZWF2ZSBrZXlkb3duIGtleXVwIGtleXByZXNzIHN1Ym1pdCBmb2N1cyBibHVyIGNvcHkgY3V0IHBhc3RlJy5zcGxpdCgnICcpLAogICAgZnVuY3Rpb24obmFtZSkgewogICAgICB2YXIgZGlyZWN0aXZlTmFtZSA9IGRpcmVjdGl2ZU5vcm1hbGl6ZSgnbmctJyArIG5hbWUpOwogICAgICBuZ0V2ZW50RGlyZWN0aXZlc1tkaXJlY3RpdmVOYW1lXSA9IFsnJHBhcnNlJywgZnVuY3Rpb24oJHBhcnNlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIHZhciBmbiA9ICRwYXJzZShhdHRyW2RpcmVjdGl2ZU5hbWVdKTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5vbihsb3dlcmNhc2UobmFtZSksIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGZuKHNjb3BlLCB7JGV2ZW50OmV2ZW50fSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XTsKICAgIH0KICApOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdEYmxjbGljawogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGBuZ0RibGNsaWNrYCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBhIGRibGNsaWNrIGV2ZW50LgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHByaW9yaXR5IDAKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nRGJsY2xpY2sge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAqIGEgZGJsY2xpY2suIChUaGUgRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGJ1dHRvbiBuZy1kYmxjbGljaz0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICBJbmNyZW1lbnQgKG9uIGRvdWJsZSBjbGljaykKICAgPC9idXR0b24+CiAgIGNvdW50OiB7e2NvdW50fX0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdNb3VzZWRvd24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBuZ01vdXNlZG93biBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZWRvd24gZXZlbnQuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcHJpb3JpdHkgMAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWRvd24ge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAqIG1vdXNlZG93bi4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxidXR0b24gbmctbW91c2Vkb3duPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgIEluY3JlbWVudCAob24gbW91c2UgZG93bikKICAgPC9idXR0b24+CiAgIGNvdW50OiB7e2NvdW50fX0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdNb3VzZXVwCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZXVwIGV2ZW50LgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHByaW9yaXR5IDAKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nTW91c2V1cCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICogbW91c2V1cC4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxidXR0b24gbmctbW91c2V1cD0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICBJbmNyZW1lbnQgKG9uIG1vdXNlIHVwKQogICA8L2J1dHRvbj4KICAgY291bnQ6IHt7Y291bnR9fQogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nTW91c2VvdmVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBtb3VzZW92ZXIgZXZlbnQuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcHJpb3JpdHkgMAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZW92ZXIge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAqIG1vdXNlb3Zlci4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxidXR0b24gbmctbW91c2VvdmVyPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgIEluY3JlbWVudCAod2hlbiBtb3VzZSBpcyBvdmVyKQogICA8L2J1dHRvbj4KICAgY291bnQ6IHt7Y291bnR9fQogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ01vdXNlZW50ZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlZW50ZXIgZXZlbnQuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcHJpb3JpdHkgMAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdNb3VzZWVudGVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBtb3VzZWVudGVyLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGJ1dHRvbiBuZy1tb3VzZWVudGVyPSJjb3VudCA9IGNvdW50ICsgMSIgbmctaW5pdD0iY291bnQ9MCI+CiAgIEluY3JlbWVudCAod2hlbiBtb3VzZSBlbnRlcnMpCiAgIDwvYnV0dG9uPgogICBjb3VudDoge3tjb3VudH19CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nTW91c2VsZWF2ZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gbW91c2VsZWF2ZSBldmVudC4KICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwcmlvcml0eSAwCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbGVhdmUge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAqIG1vdXNlbGVhdmUuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8YnV0dG9uIG5nLW1vdXNlbGVhdmU9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgSW5jcmVtZW50ICh3aGVuIG1vdXNlIGxlYXZlcykKICAgPC9idXR0b24+CiAgIGNvdW50OiB7e2NvdW50fX0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdNb3VzZW1vdmUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIG1vdXNlbW92ZSBldmVudC4KICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwcmlvcml0eSAwCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ01vdXNlbW92ZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICogbW91c2Vtb3ZlLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGJ1dHRvbiBuZy1tb3VzZW1vdmU9ImNvdW50ID0gY291bnQgKyAxIiBuZy1pbml0PSJjb3VudD0wIj4KICAgSW5jcmVtZW50ICh3aGVuIG1vdXNlIG1vdmVzKQogICA8L2J1dHRvbj4KICAgY291bnQ6IHt7Y291bnR9fQogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0tleWRvd24KICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGtleWRvd24gZXZlbnQuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcHJpb3JpdHkgMAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdLZXlkb3duIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBrZXlkb3duLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCBhbmQgY2FuIGJlIGludGVycm9nYXRlZCBmb3Iga2V5Q29kZSwgYWx0S2V5LCBldGMuKQogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8aW5wdXQgbmcta2V5ZG93bj0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICBrZXkgZG93biBjb3VudDoge3tjb3VudH19CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nS2V5dXAKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGtleXVwIGV2ZW50LgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHByaW9yaXR5IDAKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nS2V5dXAge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAqIGtleXVwLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCBhbmQgY2FuIGJlIGludGVycm9nYXRlZCBmb3Iga2V5Q29kZSwgYWx0S2V5LCBldGMuKQogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8cD5UeXBpbmcgaW4gdGhlIGlucHV0IGJveCBiZWxvdyB1cGRhdGVzIHRoZSBrZXkgY291bnQ8L3A+CiAgIDxpbnB1dCBuZy1rZXl1cD0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPiBrZXkgdXAgY291bnQ6IHt7Y291bnR9fQoKICAgPHA+VHlwaW5nIGluIHRoZSBpbnB1dCBib3ggYmVsb3cgdXBkYXRlcyB0aGUga2V5Y29kZTwvcD4KICAgPGlucHV0IG5nLWtleXVwPSJldmVudD0kZXZlbnQiPgogICA8cD5ldmVudCBrZXlDb2RlOiB7eyBldmVudC5rZXlDb2RlIH19PC9wPgogICA8cD5ldmVudCBhbHRLZXk6IHt7IGV2ZW50LmFsdEtleSB9fTwvcD4KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdLZXlwcmVzcwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24ga2V5cHJlc3MgZXZlbnQuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nS2V5cHJlc3Mge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAqIGtleXByZXNzLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfQogICAqIGFuZCBjYW4gYmUgaW50ZXJyb2dhdGVkIGZvciBrZXlDb2RlLCBhbHRLZXksIGV0Yy4pCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxpbnB1dCBuZy1rZXlwcmVzcz0iY291bnQgPSBjb3VudCArIDEiIG5nLWluaXQ9ImNvdW50PTAiPgogICBrZXkgcHJlc3MgY291bnQ6IHt7Y291bnR9fQogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ1N1Ym1pdAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRW5hYmxlcyBiaW5kaW5nIGFuZ3VsYXIgZXhwcmVzc2lvbnMgdG8gb25zdWJtaXQgZXZlbnRzLgogICAqCiAgICogQWRkaXRpb25hbGx5IGl0IHByZXZlbnRzIHRoZSBkZWZhdWx0IGFjdGlvbiAod2hpY2ggZm9yIGZvcm0gbWVhbnMgc2VuZGluZyB0aGUgcmVxdWVzdCB0byB0aGUKICAgKiBzZXJ2ZXIgYW5kIHJlbG9hZGluZyB0aGUgY3VycmVudCBwYWdlKSwgYnV0IG9ubHkgaWYgdGhlIGZvcm0gZG9lcyBub3QgY29udGFpbiBgYWN0aW9uYCwKICAgKiBgZGF0YS1hY3Rpb25gLCBvciBgeC1hY3Rpb25gIGF0dHJpYnV0ZXMuCiAgICoKICAgKiBAZWxlbWVudCBmb3JtCiAgICogQHByaW9yaXR5IDAKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU3VibWl0IHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWwuCiAgICogKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAkc2NvcGUubGlzdCA9IFtdOwogICAgICAgICAgJHNjb3BlLnRleHQgPSAnaGVsbG8nOwogICAgICAgICAgJHNjb3BlLnN1Ym1pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoJHNjb3BlLnRleHQpIHsKICAgICAgICAgICAgICAkc2NvcGUubGlzdC5wdXNoKHRoaXMudGV4dCk7CiAgICAgICAgICAgICAgJHNjb3BlLnRleHQgPSAnJzsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgIDwvc2NyaXB0PgogICA8Zm9ybSBuZy1zdWJtaXQ9InN1Ym1pdCgpIiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgRW50ZXIgdGV4dCBhbmQgaGl0IGVudGVyOgogICA8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InRleHQiIG5hbWU9InRleHQiIC8+CiAgIDxpbnB1dCB0eXBlPSJzdWJtaXQiIGlkPSJzdWJtaXQiIHZhbHVlPSJTdWJtaXQiIC8+CiAgIDxwcmU+bGlzdD17e2xpc3R9fTwvcHJlPgogICA8L2Zvcm0+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgY2hlY2sgbmctc3VibWl0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2xpc3QnKSkuZ2V0VGV4dCgpKS50b0JlKCdsaXN0PVtdJyk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCcjc3VibWl0JykpLmNsaWNrKCk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ2xpc3QnKSkuZ2V0VGV4dCgpKS50b0NvbnRhaW4oJ2hlbGxvJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlucHV0KCd0ZXh0JykpLmdldEF0dHJpYnV0ZSgndmFsdWUnKSkudG9CZSgnJyk7CiAgICAgICB9KTsKICAgaXQoJ3Nob3VsZCBpZ25vcmUgZW1wdHkgc3RyaW5ncycsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdsaXN0JykpLmdldFRleHQoKSkudG9CZSgnbGlzdD1bXScpOwogICAgICAgICBlbGVtZW50KGJ5LmNzcygnI3N1Ym1pdCcpKS5jbGljaygpOwogICAgICAgICBlbGVtZW50KGJ5LmNzcygnI3N1Ym1pdCcpKS5jbGljaygpOwogICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdsaXN0JykpLmdldFRleHQoKSkudG9Db250YWluKCdoZWxsbycpOwogICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nRm9jdXMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIGZvY3VzIGV2ZW50LgogICAqCiAgICogQGVsZW1lbnQgd2luZG93LCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYQogICAqIEBwcmlvcml0eSAwCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0ZvY3VzIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBmb2N1cy4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAgICoKICAgKiBAZXhhbXBsZQogICAqIFNlZSB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nQ2xpY2sgbmdDbGlja30KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nQmx1cgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gYmx1ciBldmVudC4KICAgKgogICAqIEBlbGVtZW50IHdpbmRvdywgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIGEKICAgKiBAcHJpb3JpdHkgMAogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdCbHVyIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBibHVyLiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICAgKgogICAqIEBleGFtcGxlCiAgICogU2VlIHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGljayBuZ0NsaWNrfQogICAqLwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdDb3B5CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciBvbiBjb3B5IGV2ZW50LgogICAqCiAgICogQGVsZW1lbnQgd2luZG93LCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYQogICAqIEBwcmlvcml0eSAwCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0NvcHkge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogICAqIGNvcHkuICh7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8aW5wdXQgbmctY29weT0iY29waWVkPXRydWUiIG5nLWluaXQ9ImNvcGllZD1mYWxzZTsgdmFsdWU9J2NvcHkgbWUnIiBuZy1tb2RlbD0idmFsdWUiPgogICBjb3BpZWQ6IHt7Y29waWVkfX0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0N1dAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogU3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igb24gY3V0IGV2ZW50LgogICAqCiAgICogQGVsZW1lbnQgd2luZG93LCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYQogICAqIEBwcmlvcml0eSAwCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0N1dCB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBFeHByZXNzaW9ufSB0byBldmFsdWF0ZSB1cG9uCiAgICogY3V0LiAoe0BsaW5rIGd1aWRlL2V4cHJlc3Npb24jLWV2ZW50LSBFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgfSkKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGlucHV0IG5nLWN1dD0iY3V0PXRydWUiIG5nLWluaXQ9ImN1dD1mYWxzZTsgdmFsdWU9J2N1dCBtZSciIG5nLW1vZGVsPSJ2YWx1ZSI+CiAgIGN1dDoge3tjdXR9fQogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nUGFzdGUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIG9uIHBhc3RlIGV2ZW50LgogICAqCiAgICogQGVsZW1lbnQgd2luZG93LCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYQogICAqIEBwcmlvcml0eSAwCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ1Bhc3RlIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICAgKiBwYXN0ZS4gKHtAbGluayBndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxpbnB1dCBuZy1wYXN0ZT0icGFzdGU9dHJ1ZSIgbmctaW5pdD0icGFzdGU9ZmFsc2UiIHBsYWNlaG9sZGVyPSdwYXN0ZSBoZXJlJz4KICAgcGFzdGVkOiB7e3Bhc3RlfX0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0lmCiAgICogQHJlc3RyaWN0IEEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdJZmAgZGlyZWN0aXZlIHJlbW92ZXMgb3IgcmVjcmVhdGVzIGEgcG9ydGlvbiBvZiB0aGUgRE9NIHRyZWUgYmFzZWQgb24gYW4KICAgKiB7ZXhwcmVzc2lvbn0uIElmIHRoZSBleHByZXNzaW9uIGFzc2lnbmVkIHRvIGBuZ0lmYCBldmFsdWF0ZXMgdG8gYSBmYWxzZQogICAqIHZhbHVlIHRoZW4gdGhlIGVsZW1lbnQgaXMgcmVtb3ZlZCBmcm9tIHRoZSBET00sIG90aGVyd2lzZSBhIGNsb25lIG9mIHRoZQogICAqIGVsZW1lbnQgaXMgcmVpbnNlcnRlZCBpbnRvIHRoZSBET00uCiAgICoKICAgKiBgbmdJZmAgZGlmZmVycyBmcm9tIGBuZ1Nob3dgIGFuZCBgbmdIaWRlYCBpbiB0aGF0IGBuZ0lmYCBjb21wbGV0ZWx5IHJlbW92ZXMgYW5kIHJlY3JlYXRlcyB0aGUKICAgKiBlbGVtZW50IGluIHRoZSBET00gcmF0aGVyIHRoYW4gY2hhbmdpbmcgaXRzIHZpc2liaWxpdHkgdmlhIHRoZSBgZGlzcGxheWAgY3NzIHByb3BlcnR5LiAgQSBjb21tb24KICAgKiBjYXNlIHdoZW4gdGhpcyBkaWZmZXJlbmNlIGlzIHNpZ25pZmljYW50IGlzIHdoZW4gdXNpbmcgY3NzIHNlbGVjdG9ycyB0aGF0IHJlbHkgb24gYW4gZWxlbWVudCdzCiAgICogcG9zaXRpb24gd2l0aGluIHRoZSBET00sIHN1Y2ggYXMgdGhlIGA6Zmlyc3QtY2hpbGRgIG9yIGA6bGFzdC1jaGlsZGAgcHNldWRvLWNsYXNzZXMuCiAgICoKICAgKiBOb3RlIHRoYXQgd2hlbiBhbiBlbGVtZW50IGlzIHJlbW92ZWQgdXNpbmcgYG5nSWZgIGl0cyBzY29wZSBpcyBkZXN0cm95ZWQgYW5kIGEgbmV3IHNjb3BlCiAgICogaXMgY3JlYXRlZCB3aGVuIHRoZSBlbGVtZW50IGlzIHJlc3RvcmVkLiAgVGhlIHNjb3BlIGNyZWF0ZWQgd2l0aGluIGBuZ0lmYCBpbmhlcml0cyBmcm9tCiAgICogaXRzIHBhcmVudCBzY29wZSB1c2luZwogICAqIFtwcm90b3R5cGFsIGluaGVyaXRhbmNlXShodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyLmpzL3dpa2kvVGhlLU51YW5jZXMtb2YtU2NvcGUtUHJvdG90eXBhbC1Jbmhlcml0YW5jZSkuCiAgICogQW4gaW1wb3J0YW50IGltcGxpY2F0aW9uIG9mIHRoaXMgaXMgaWYgYG5nTW9kZWxgIGlzIHVzZWQgd2l0aGluIGBuZ0lmYCB0byBiaW5kIHRvCiAgICogYSBqYXZhc2NyaXB0IHByaW1pdGl2ZSBkZWZpbmVkIGluIHRoZSBwYXJlbnQgc2NvcGUuIEluIHRoaXMgY2FzZSBhbnkgbW9kaWZpY2F0aW9ucyBtYWRlIHRvIHRoZQogICAqIHZhcmlhYmxlIHdpdGhpbiB0aGUgY2hpbGQgc2NvcGUgd2lsbCBvdmVycmlkZSAoaGlkZSkgdGhlIHZhbHVlIGluIHRoZSBwYXJlbnQgc2NvcGUuCiAgICoKICAgKiBBbHNvLCBgbmdJZmAgcmVjcmVhdGVzIGVsZW1lbnRzIHVzaW5nIHRoZWlyIGNvbXBpbGVkIHN0YXRlLiBBbiBleGFtcGxlIG9mIHRoaXMgYmVoYXZpb3IKICAgKiBpcyBpZiBhbiBlbGVtZW50J3MgY2xhc3MgYXR0cmlidXRlIGlzIGRpcmVjdGx5IG1vZGlmaWVkIGFmdGVyIGl0J3MgY29tcGlsZWQsIHVzaW5nIHNvbWV0aGluZyBsaWtlCiAgICogalF1ZXJ5J3MgYC5hZGRDbGFzcygpYCBtZXRob2QsIGFuZCB0aGUgZWxlbWVudCBpcyBsYXRlciByZW1vdmVkLiBXaGVuIGBuZ0lmYCByZWNyZWF0ZXMgdGhlIGVsZW1lbnQKICAgKiB0aGUgYWRkZWQgY2xhc3Mgd2lsbCBiZSBsb3N0IGJlY2F1c2UgdGhlIG9yaWdpbmFsIGNvbXBpbGVkIHN0YXRlIGlzIHVzZWQgdG8gcmVnZW5lcmF0ZSB0aGUgZWxlbWVudC4KICAgKgogICAqIEFkZGl0aW9uYWxseSwgeW91IGNhbiBwcm92aWRlIGFuaW1hdGlvbnMgdmlhIHRoZSBgbmdBbmltYXRlYCBtb2R1bGUgdG8gYW5pbWF0ZSB0aGUgYGVudGVyYAogICAqIGFuZCBgbGVhdmVgIGVmZmVjdHMuCiAgICoKICAgKiBAYW5pbWF0aW9ucwogICAqIGVudGVyIC0gaGFwcGVucyBqdXN0IGFmdGVyIHRoZSBuZ0lmIGNvbnRlbnRzIGNoYW5nZSBhbmQgYSBuZXcgRE9NIGVsZW1lbnQgaXMgY3JlYXRlZCBhbmQgaW5qZWN0ZWQgaW50byB0aGUgbmdJZiBjb250YWluZXIKICAgKiBsZWF2ZSAtIGhhcHBlbnMganVzdCBiZWZvcmUgdGhlIG5nSWYgY29udGVudHMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgRE9NCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAc2NvcGUKICAgKiBAcHJpb3JpdHkgNjAwCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0lmIElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyBmYWxzeSB0aGVuCiAgICogICAgIHRoZSBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NIHRyZWUuIElmIGl0IGlzIHRydXRoeSBhIGNvcHkgb2YgdGhlIGNvbXBpbGVkCiAgICogICAgIGVsZW1lbnQgaXMgYWRkZWQgdG8gdGhlIERPTSB0cmVlLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCIgbmctaW5pdD0iY2hlY2tlZD10cnVlIiAvPjxici8+CiAgIFNob3cgd2hlbiBjaGVja2VkOgogICA8c3BhbiBuZy1pZj0iY2hlY2tlZCIgY2xhc3M9ImFuaW1hdGUtaWYiPgogICBJJ20gcmVtb3ZlZCB3aGVuIHRoZSBjaGVja2JveCBpcyB1bmNoZWNrZWQuCiAgIDwvc3Bhbj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgIC5hbmltYXRlLWlmIHsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICB9CgogICAuYW5pbWF0ZS1pZi5uZy1lbnRlciwgLmFuaW1hdGUtaWYubmctbGVhdmUgewogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgfQoKICAgLmFuaW1hdGUtaWYubmctZW50ZXIsCiAgIC5hbmltYXRlLWlmLm5nLWxlYXZlLm5nLWxlYXZlLWFjdGl2ZSB7CiAgICAgICAgb3BhY2l0eTowOwogICAgICB9CgogICAuYW5pbWF0ZS1pZi5uZy1sZWF2ZSwKICAgLmFuaW1hdGUtaWYubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICAgICAgICBvcGFjaXR5OjE7CiAgICAgIH0KICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nSWZEaXJlY3RpdmUgPSBbJyRhbmltYXRlJywgZnVuY3Rpb24oJGFuaW1hdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgcHJpb3JpdHk6IDYwMCwKICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgICQkdGxiOiB0cnVlLAogICAgICBsaW5rOiBmdW5jdGlvbiAoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmwsICR0cmFuc2NsdWRlKSB7CiAgICAgICAgdmFyIGJsb2NrLCBjaGlsZFNjb3BlLCBwcmV2aW91c0VsZW1lbnRzOwogICAgICAgICRzY29wZS4kd2F0Y2goJGF0dHIubmdJZiwgZnVuY3Rpb24gbmdJZldhdGNoQWN0aW9uKHZhbHVlKSB7CgogICAgICAgICAgaWYgKHRvQm9vbGVhbih2YWx1ZSkpIHsKICAgICAgICAgICAgaWYgKCFjaGlsZFNjb3BlKSB7CiAgICAgICAgICAgICAgY2hpbGRTY29wZSA9ICRzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgJHRyYW5zY2x1ZGUoY2hpbGRTY29wZSwgZnVuY3Rpb24gKGNsb25lKSB7CiAgICAgICAgICAgICAgICBjbG9uZVtjbG9uZS5sZW5ndGgrK10gPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KCcgZW5kIG5nSWY6ICcgKyAkYXR0ci5uZ0lmICsgJyAnKTsKICAgICAgICAgICAgICAgIC8vIE5vdGU6IFdlIG9ubHkgbmVlZCB0aGUgZmlyc3QvbGFzdCBub2RlIG9mIHRoZSBjbG9uZWQgbm9kZXMuCiAgICAgICAgICAgICAgICAvLyBIb3dldmVyLCB3ZSBuZWVkIHRvIGtlZXAgdGhlIHJlZmVyZW5jZSB0byB0aGUganFsaXRlIHdyYXBwZXIgYXMgaXQgbWlnaHQgYmUgY2hhbmdlZCBsYXRlcgogICAgICAgICAgICAgICAgLy8gYnkgYSBkaXJlY3RpdmUgd2l0aCB0ZW1wbGF0ZVVybCB3aGVuIGl0cyB0ZW1wbGF0ZSBhcnJpdmVzLgogICAgICAgICAgICAgICAgYmxvY2sgPSB7CiAgICAgICAgICAgICAgICAgIGNsb25lOiBjbG9uZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGNsb25lLCAkZWxlbWVudC5wYXJlbnQoKSwgJGVsZW1lbnQpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZihwcmV2aW91c0VsZW1lbnRzKSB7CiAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50cy5yZW1vdmUoKTsKICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihjaGlsZFNjb3BlKSB7CiAgICAgICAgICAgICAgY2hpbGRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgIGNoaWxkU2NvcGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmKGJsb2NrKSB7CiAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50cyA9IGdldEJsb2NrRWxlbWVudHMoYmxvY2suY2xvbmUpOwogICAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKHByZXZpb3VzRWxlbWVudHMsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50cyA9IG51bGw7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgYmxvY2sgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgfV07CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0luY2x1ZGUKICAgKiBAcmVzdHJpY3QgRUNBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBGZXRjaGVzLCBjb21waWxlcyBhbmQgaW5jbHVkZXMgYW4gZXh0ZXJuYWwgSFRNTCBmcmFnbWVudC4KICAgKgogICAqIEJ5IGRlZmF1bHQsIHRoZSB0ZW1wbGF0ZSBVUkwgaXMgcmVzdHJpY3RlZCB0byB0aGUgc2FtZSBkb21haW4gYW5kIHByb3RvY29sIGFzIHRoZQogICAqIGFwcGxpY2F0aW9uIGRvY3VtZW50LiBUaGlzIGlzIGRvbmUgYnkgY2FsbGluZyB7QGxpbmsgbmcuJHNjZSNnZXRUcnVzdGVkUmVzb3VyY2VVcmwKICogJHNjZS5nZXRUcnVzdGVkUmVzb3VyY2VVcmx9IG9uIGl0LiBUbyBsb2FkIHRlbXBsYXRlcyBmcm9tIG90aGVyIGRvbWFpbnMgb3IgcHJvdG9jb2xzCiAgICogeW91IG1heSBlaXRoZXIge0BsaW5rIG5nLiRzY2VEZWxlZ2F0ZVByb3ZpZGVyI3Jlc291cmNlVXJsV2hpdGVsaXN0IHdoaXRlbGlzdCB0aGVtfSBvcgogICAqIFt3cmFwIHRoZW1dKG5nLiRzY2UjdHJ1c3RBc1Jlc291cmNlVXJsKSBhcyB0cnVzdGVkIHZhbHVlcy4gUmVmZXIgdG8gQW5ndWxhcidzIHtAbGluawogICAgKiBuZy4kc2NlIFN0cmljdCBDb250ZXh0dWFsIEVzY2FwaW5nfS4KICAgKgogICAqIEluIGFkZGl0aW9uLCB0aGUgYnJvd3NlcidzCiAgICogW1NhbWUgT3JpZ2luIFBvbGljeV0oaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9icm93c2Vyc2VjL3dpa2kvUGFydDIjU2FtZS1vcmlnaW5fcG9saWN5X2Zvcl9YTUxIdHRwUmVxdWVzdCkKICAgKiBhbmQgW0Nyb3NzLU9yaWdpbiBSZXNvdXJjZSBTaGFyaW5nIChDT1JTKV0oaHR0cDovL3d3dy53My5vcmcvVFIvY29ycy8pCiAgICogcG9saWN5IG1heSBmdXJ0aGVyIHJlc3RyaWN0IHdoZXRoZXIgdGhlIHRlbXBsYXRlIGlzIHN1Y2Nlc3NmdWxseSBsb2FkZWQuCiAgICogRm9yIGV4YW1wbGUsIGBuZ0luY2x1ZGVgIHdvbid0IHdvcmsgZm9yIGNyb3NzLWRvbWFpbiByZXF1ZXN0cyBvbiBhbGwgYnJvd3NlcnMgYW5kIGZvciBgZmlsZTovL2AKICAgKiBhY2Nlc3Mgb24gc29tZSBicm93c2Vycy4KICAgKgogICAqIEBhbmltYXRpb25zCiAgICogZW50ZXIgLSBhbmltYXRpb24gaXMgdXNlZCB0byBicmluZyBuZXcgY29udGVudCBpbnRvIHRoZSBicm93c2VyLgogICAqIGxlYXZlIC0gYW5pbWF0aW9uIGlzIHVzZWQgdG8gYW5pbWF0ZSBleGlzdGluZyBjb250ZW50IGF3YXkuCiAgICoKICAgKiBUaGUgZW50ZXIgYW5kIGxlYXZlIGFuaW1hdGlvbiBvY2N1ciBjb25jdXJyZW50bHkuCiAgICoKICAgKiBAc2NvcGUKICAgKiBAcHJpb3JpdHkgNDAwCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gbmdJbmNsdWRlfHNyYyBhbmd1bGFyIGV4cHJlc3Npb24gZXZhbHVhdGluZyB0byBVUkwuIElmIHRoZSBzb3VyY2UgaXMgYSBzdHJpbmcgY29uc3RhbnQsCiAgICogICAgICAgICAgICAgICAgIG1ha2Ugc3VyZSB5b3Ugd3JhcCBpdCBpbiAqKnNpbmdsZSoqIHF1b3RlcywgZS5nLiBgc3JjPSInbXlQYXJ0aWFsVGVtcGxhdGUuaHRtbCciYC4KICAgKiBAcGFyYW0ge3N0cmluZz19IG9ubG9hZCBFeHByZXNzaW9uIHRvIGV2YWx1YXRlIHdoZW4gYSBuZXcgcGFydGlhbCBpcyBsb2FkZWQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IGF1dG9zY3JvbGwgV2hldGhlciBgbmdJbmNsdWRlYCBzaG91bGQgY2FsbCB7QGxpbmsgbmcuJGFuY2hvclNjcm9sbAogKiAgICAgICAgICAgICAgICAgICRhbmNob3JTY3JvbGx9IHRvIHNjcm9sbCB0aGUgdmlld3BvcnQgYWZ0ZXIgdGhlIGNvbnRlbnQgaXMgbG9hZGVkLgogICAqCiAgICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgbm90IHNldCwgZGlzYWJsZSBzY3JvbGxpbmcuCiAgICogICAgICAgICAgICAgICAgICAtIElmIHRoZSBhdHRyaWJ1dGUgaXMgc2V0IHdpdGhvdXQgdmFsdWUsIGVuYWJsZSBzY3JvbGxpbmcuCiAgICogICAgICAgICAgICAgICAgICAtIE90aGVyd2lzZSBlbmFibGUgc2Nyb2xsaW5nIG9ubHkgaWYgdGhlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydXRoeSB2YWx1ZS4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgPHNlbGVjdCBuZy1tb2RlbD0idGVtcGxhdGUiIG5nLW9wdGlvbnM9InQubmFtZSBmb3IgdCBpbiB0ZW1wbGF0ZXMiPgogICA8b3B0aW9uIHZhbHVlPSIiPihibGFuayk8L29wdGlvbj4KICAgPC9zZWxlY3Q+CiAgIHVybCBvZiB0aGUgdGVtcGxhdGU6IDx0dD57e3RlbXBsYXRlLnVybH19PC90dD4KICAgPGhyLz4KICAgPGRpdiBjbGFzcz0ic2xpZGUtYW5pbWF0ZS1jb250YWluZXIiPgogICA8ZGl2IGNsYXNzPSJzbGlkZS1hbmltYXRlIiBuZy1pbmNsdWRlPSJ0ZW1wbGF0ZS51cmwiPjwvZGl2PgogICA8L2Rpdj4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0ic2NyaXB0LmpzIj4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAkc2NvcGUudGVtcGxhdGVzID0KICAgICAgICAgIFsgeyBuYW1lOiAndGVtcGxhdGUxLmh0bWwnLCB1cmw6ICd0ZW1wbGF0ZTEuaHRtbCd9LAogICAgICAgICAgICB7IG5hbWU6ICd0ZW1wbGF0ZTIuaHRtbCcsIHVybDogJ3RlbXBsYXRlMi5odG1sJ30gXTsKICAgICAgICAkc2NvcGUudGVtcGxhdGUgPSAkc2NvcGUudGVtcGxhdGVzWzBdOwogICAgICB9CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0idGVtcGxhdGUxLmh0bWwiPgogICBDb250ZW50IG9mIHRlbXBsYXRlMS5odG1sCiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0idGVtcGxhdGUyLmh0bWwiPgogICBDb250ZW50IG9mIHRlbXBsYXRlMi5odG1sCiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0iYW5pbWF0aW9ucy5jc3MiPgogICAuc2xpZGUtYW5pbWF0ZS1jb250YWluZXIgewogICAgICAgIHBvc2l0aW9uOnJlbGF0aXZlOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgICAgYm9yZGVyOjFweCBzb2xpZCBibGFjazsKICAgICAgICBoZWlnaHQ6NDBweDsKICAgICAgICBvdmVyZmxvdzpoaWRkZW47CiAgICAgIH0KCiAgIC5zbGlkZS1hbmltYXRlIHsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgIH0KCiAgIC5zbGlkZS1hbmltYXRlLm5nLWVudGVyLCAuc2xpZGUtYW5pbWF0ZS5uZy1sZWF2ZSB7CiAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CiAgICAgICAgdHJhbnNpdGlvbjphbGwgY3ViaWMtYmV6aWVyKDAuMjUwLCAwLjQ2MCwgMC40NTAsIDAuOTQwKSAwLjVzOwoKICAgICAgICBwb3NpdGlvbjphYnNvbHV0ZTsKICAgICAgICB0b3A6MDsKICAgICAgICBsZWZ0OjA7CiAgICAgICAgcmlnaHQ6MDsKICAgICAgICBib3R0b206MDsKICAgICAgICBkaXNwbGF5OmJsb2NrOwogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgfQoKICAgLnNsaWRlLWFuaW1hdGUubmctZW50ZXIgewogICAgICAgIHRvcDotNTBweDsKICAgICAgfQogICAuc2xpZGUtYW5pbWF0ZS5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogICAgICAgIHRvcDowOwogICAgICB9CgogICAuc2xpZGUtYW5pbWF0ZS5uZy1sZWF2ZSB7CiAgICAgICAgdG9wOjA7CiAgICAgIH0KICAgLnNsaWRlLWFuaW1hdGUubmctbGVhdmUubmctbGVhdmUtYWN0aXZlIHsKICAgICAgICB0b3A6NTBweDsKICAgICAgfQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICB2YXIgdGVtcGxhdGVTZWxlY3QgPSBlbGVtZW50KGJ5Lm1vZGVsKCd0ZW1wbGF0ZScpKTsKICAgdmFyIGluY2x1ZGVFbGVtID0gZWxlbWVudChieS5jc3MoJ1tuZy1pbmNsdWRlXScpKTsKCiAgIGl0KCdzaG91bGQgbG9hZCB0ZW1wbGF0ZTEuaHRtbCcsIGZ1bmN0aW9uKCkgewogICAgICAgIGV4cGVjdChpbmNsdWRlRWxlbS5nZXRUZXh0KCkpLnRvTWF0Y2goL0NvbnRlbnQgb2YgdGVtcGxhdGUxLmh0bWwvKTsKICAgICAgfSk7CgogICBpdCgnc2hvdWxkIGxvYWQgdGVtcGxhdGUyLmh0bWwnLCBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoYnJvd3Nlci5wYXJhbXMuYnJvd3NlciA9PSAnZmlyZWZveCcpIHsKICAgICAgICAgIC8vIEZpcmVmb3ggY2FuJ3QgaGFuZGxlIHVzaW5nIHNlbGVjdHMKICAgICAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9wcm90cmFjdG9yL2lzc3Vlcy80ODAKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGVtcGxhdGVTZWxlY3QuY2xpY2soKTsKICAgICAgICB0ZW1wbGF0ZVNlbGVjdC5lbGVtZW50LmFsbChieS5jc3MoJ29wdGlvbicpKS5nZXQoMikuY2xpY2soKTsKICAgICAgICBleHBlY3QoaW5jbHVkZUVsZW0uZ2V0VGV4dCgpKS50b01hdGNoKC9Db250ZW50IG9mIHRlbXBsYXRlMi5odG1sLyk7CiAgICAgIH0pOwoKICAgaXQoJ3Nob3VsZCBjaGFuZ2UgdG8gYmxhbmsnLCBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoYnJvd3Nlci5wYXJhbXMuYnJvd3NlciA9PSAnZmlyZWZveCcpIHsKICAgICAgICAgIC8vIEZpcmVmb3ggY2FuJ3QgaGFuZGxlIHVzaW5nIHNlbGVjdHMKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGVtcGxhdGVTZWxlY3QuY2xpY2soKTsKICAgICAgICB0ZW1wbGF0ZVNlbGVjdC5lbGVtZW50LmFsbChieS5jc3MoJ29wdGlvbicpKS5nZXQoMCkuY2xpY2soKTsKICAgICAgICBleHBlY3QoaW5jbHVkZUVsZW0uaXNQcmVzZW50KCkpLnRvQmUoZmFsc2UpOwogICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZXZlbnQKICAgKiBAbmFtZSBuZ0luY2x1ZGUjJGluY2x1ZGVDb250ZW50UmVxdWVzdGVkCiAgICogQGV2ZW50VHlwZSBlbWl0IG9uIHRoZSBzY29wZSBuZ0luY2x1ZGUgd2FzIGRlY2xhcmVkIGluCiAgICogQGRlc2NyaXB0aW9uCiAgICogRW1pdHRlZCBldmVyeSB0aW1lIHRoZSBuZ0luY2x1ZGUgY29udGVudCBpcyByZXF1ZXN0ZWQuCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZXZlbnQKICAgKiBAbmFtZSBuZ0luY2x1ZGUjJGluY2x1ZGVDb250ZW50TG9hZGVkCiAgICogQGV2ZW50VHlwZSBlbWl0IG9uIHRoZSBjdXJyZW50IG5nSW5jbHVkZSBzY29wZQogICAqIEBkZXNjcmlwdGlvbgogICAqIEVtaXR0ZWQgZXZlcnkgdGltZSB0aGUgbmdJbmNsdWRlIGNvbnRlbnQgaXMgcmVsb2FkZWQuCiAgICovCiAgdmFyIG5nSW5jbHVkZURpcmVjdGl2ZSA9IFsnJGh0dHAnLCAnJHRlbXBsYXRlQ2FjaGUnLCAnJGFuY2hvclNjcm9sbCcsICckYW5pbWF0ZScsICckc2NlJywKICAgIGZ1bmN0aW9uKCRodHRwLCAgICR0ZW1wbGF0ZUNhY2hlLCAgICRhbmNob3JTY3JvbGwsICAgJGFuaW1hdGUsICAgJHNjZSkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRUNBJywKICAgICAgICBwcmlvcml0eTogNDAwLAogICAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgICBjb250cm9sbGVyOiBhbmd1bGFyLm5vb3AsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICAgICAgdmFyIHNyY0V4cCA9IGF0dHIubmdJbmNsdWRlIHx8IGF0dHIuc3JjLAogICAgICAgICAgICBvbmxvYWRFeHAgPSBhdHRyLm9ubG9hZCB8fCAnJywKICAgICAgICAgICAgYXV0b1Njcm9sbEV4cCA9IGF0dHIuYXV0b3Njcm9sbDsKCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgY3RybCwgJHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgdmFyIGNoYW5nZUNvdW50ZXIgPSAwLAogICAgICAgICAgICAgIGN1cnJlbnRTY29wZSwKICAgICAgICAgICAgICBwcmV2aW91c0VsZW1lbnQsCiAgICAgICAgICAgICAgY3VycmVudEVsZW1lbnQ7CgogICAgICAgICAgICB2YXIgY2xlYW51cExhc3RJbmNsdWRlQ29udGVudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmKHByZXZpb3VzRWxlbWVudCkgewogICAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50LnJlbW92ZSgpOwogICAgICAgICAgICAgICAgcHJldmlvdXNFbGVtZW50ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYoY3VycmVudFNjb3BlKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50U2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRTY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmKGN1cnJlbnRFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAkYW5pbWF0ZS5sZWF2ZShjdXJyZW50RWxlbWVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudCA9IGN1cnJlbnRFbGVtZW50OwogICAgICAgICAgICAgICAgY3VycmVudEVsZW1lbnQgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgkc2NlLnBhcnNlQXNSZXNvdXJjZVVybChzcmNFeHApLCBmdW5jdGlvbiBuZ0luY2x1ZGVXYXRjaEFjdGlvbihzcmMpIHsKICAgICAgICAgICAgICB2YXIgYWZ0ZXJBbmltYXRpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmIChpc0RlZmluZWQoYXV0b1Njcm9sbEV4cCkgJiYgKCFhdXRvU2Nyb2xsRXhwIHx8IHNjb3BlLiRldmFsKGF1dG9TY3JvbGxFeHApKSkgewogICAgICAgICAgICAgICAgICAkYW5jaG9yU2Nyb2xsKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB2YXIgdGhpc0NoYW5nZUlkID0gKytjaGFuZ2VDb3VudGVyOwoKICAgICAgICAgICAgICBpZiAoc3JjKSB7CiAgICAgICAgICAgICAgICAkaHR0cC5nZXQoc3JjLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkuc3VjY2VzcyhmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgICAgICAgICAgICBpZiAodGhpc0NoYW5nZUlkICE9PSBjaGFuZ2VDb3VudGVyKSByZXR1cm47CiAgICAgICAgICAgICAgICAgIHZhciBuZXdTY29wZSA9IHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgICAgICAgY3RybC50ZW1wbGF0ZSA9IHJlc3BvbnNlOwoKICAgICAgICAgICAgICAgICAgLy8gTm90ZTogVGhpcyB3aWxsIGFsc28gbGluayBhbGwgY2hpbGRyZW4gb2YgbmctaW5jbHVkZSB0aGF0IHdlcmUgY29udGFpbmVkIGluIHRoZSBvcmlnaW5hbAogICAgICAgICAgICAgICAgICAvLyBodG1sLiBJZiB0aGF0IGNvbnRlbnQgY29udGFpbnMgY29udHJvbGxlcnMsIC4uLiB0aGV5IGNvdWxkIHBvbGx1dGUvY2hhbmdlIHRoZSBzY29wZS4KICAgICAgICAgICAgICAgICAgLy8gSG93ZXZlciwgdXNpbmcgbmctaW5jbHVkZSBvbiBhbiBlbGVtZW50IHdpdGggYWRkaXRpb25hbCBjb250ZW50IGRvZXMgbm90IG1ha2Ugc2Vuc2UuLi4KICAgICAgICAgICAgICAgICAgLy8gTm90ZTogV2UgY2FuJ3QgcmVtb3ZlIHRoZW0gaW4gdGhlIGNsb25lQXR0Y2hGbiBvZiAkdHJhbnNjbHVkZSBhcyB0aGF0CiAgICAgICAgICAgICAgICAgIC8vIGZ1bmN0aW9uIGlzIGNhbGxlZCBiZWZvcmUgbGlua2luZyB0aGUgY29udGVudCwgd2hpY2ggd291bGQgYXBwbHkgY2hpbGQKICAgICAgICAgICAgICAgICAgLy8gZGlyZWN0aXZlcyB0byBub24gZXhpc3RpbmcgZWxlbWVudHMuCiAgICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9ICR0cmFuc2NsdWRlKG5ld1Njb3BlLCBmdW5jdGlvbihjbG9uZSkgewogICAgICAgICAgICAgICAgICAgIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQoKTsKICAgICAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihjbG9uZSwgbnVsbCwgJGVsZW1lbnQsIGFmdGVyQW5pbWF0aW9uKTsKICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICBjdXJyZW50U2NvcGUgPSBuZXdTY29wZTsKICAgICAgICAgICAgICAgICAgY3VycmVudEVsZW1lbnQgPSBjbG9uZTsKCiAgICAgICAgICAgICAgICAgIGN1cnJlbnRTY29wZS4kZW1pdCgnJGluY2x1ZGVDb250ZW50TG9hZGVkJyk7CiAgICAgICAgICAgICAgICAgIHNjb3BlLiRldmFsKG9ubG9hZEV4cCk7CiAgICAgICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKHRoaXNDaGFuZ2VJZCA9PT0gY2hhbmdlQ291bnRlcikgY2xlYW51cExhc3RJbmNsdWRlQ29udGVudCgpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBzY29wZS4kZW1pdCgnJGluY2x1ZGVDb250ZW50UmVxdWVzdGVkJyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNsZWFudXBMYXN0SW5jbHVkZUNvbnRlbnQoKTsKICAgICAgICAgICAgICAgIGN0cmwudGVtcGxhdGUgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfTsKICAgIH1dOwoKLy8gVGhpcyBkaXJlY3RpdmUgaXMgY2FsbGVkIGR1cmluZyB0aGUgJHRyYW5zY2x1ZGUgY2FsbCBvZiB0aGUgZmlyc3QgYG5nSW5jbHVkZWAgZGlyZWN0aXZlLgovLyBJdCB3aWxsIHJlcGxhY2UgYW5kIGNvbXBpbGUgdGhlIGNvbnRlbnQgb2YgdGhlIGVsZW1lbnQgd2l0aCB0aGUgbG9hZGVkIHRlbXBsYXRlLgovLyBXZSBuZWVkIHRoaXMgZGlyZWN0aXZlIHNvIHRoYXQgdGhlIGVsZW1lbnQgY29udGVudCBpcyBhbHJlYWR5IGZpbGxlZCB3aGVuCi8vIHRoZSBsaW5rIGZ1bmN0aW9uIG9mIGFub3RoZXIgZGlyZWN0aXZlIG9uIHRoZSBzYW1lIGVsZW1lbnQgYXMgbmdJbmNsdWRlCi8vIGlzIGNhbGxlZC4KICB2YXIgbmdJbmNsdWRlRmlsbENvbnRlbnREaXJlY3RpdmUgPSBbJyRjb21waWxlJywKICAgIGZ1bmN0aW9uKCRjb21waWxlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgICAgIHByaW9yaXR5OiAtNDAwLAogICAgICAgIHJlcXVpcmU6ICduZ0luY2x1ZGUnLAogICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmwpIHsKICAgICAgICAgICRlbGVtZW50Lmh0bWwoY3RybC50ZW1wbGF0ZSk7CiAgICAgICAgICAkY29tcGlsZSgkZWxlbWVudC5jb250ZW50cygpKShzY29wZSk7CiAgICAgICAgfQogICAgICB9OwogICAgfV07CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ0luaXQKICAgKiBAcmVzdHJpY3QgQUMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdJbml0YCBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBldmFsdWF0ZSBhbiBleHByZXNzaW9uIGluIHRoZQogICAqIGN1cnJlbnQgc2NvcGUuCiAgICoKICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC1lcnJvciI+CiAgICogVGhlIG9ubHkgYXBwcm9wcmlhdGUgdXNlIG9mIGBuZ0luaXRgIGlzIGZvciBhbGlhc2luZyBzcGVjaWFsIHByb3BlcnRpZXMgb2YKICAgKiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IGBuZ1JlcGVhdGB9LCBhcyBzZWVuIGluIHRoZSBkZW1vIGJlbG93LiBCZXNpZGVzIHRoaXMgY2FzZSwgeW91CiAgICogc2hvdWxkIHVzZSB7QGxpbmsgZ3VpZGUvY29udHJvbGxlciBjb250cm9sbGVyc30gcmF0aGVyIHRoYW4gYG5nSW5pdGAKICAgKiB0byBpbml0aWFsaXplIHZhbHVlcyBvbiBhIHNjb3BlLgogICAqIDwvZGl2PgogICAqIDxkaXYgY2xhc3M9ImFsZXJ0IGFsZXJ0LXdhcm5pbmciPgogICAqICoqTm90ZSoqOiBJZiB5b3UgaGF2ZSBhc3NpZ25tZW50IGluIGBuZ0luaXRgIGFsb25nIHdpdGgge0BsaW5rIG5nLiRmaWx0ZXIgYCRmaWx0ZXJgfSwgbWFrZQogICAqIHN1cmUgeW91IGhhdmUgcGFyZW50aGVzaXMgZm9yIGNvcnJlY3QgcHJlY2VkZW5jZToKICAgKiA8cHJlIGNsYXNzPSJwcmV0dHlwcmludCI+CiAgICogICA8ZGl2IG5nLWluaXQ9InRlc3QxID0gKGRhdGEgfCBvcmRlckJ5OiduYW1lJykiPjwvZGl2PgogICAqIDwvcHJlPgogICAqIDwvZGl2PgogICAqCiAgICogQHByaW9yaXR5IDQ1MAogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0luaXQge0BsaW5rIGd1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbC4KICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICRzY29wZS5saXN0ID0gW1snYScsICdiJ10sIFsnYycsICdkJ11dOwogICAgIH0KICAgPC9zY3JpcHQ+CiAgIDxkaXYgbmctY29udHJvbGxlcj0iQ3RybCI+CiAgIDxkaXYgbmctcmVwZWF0PSJpbm5lckxpc3QgaW4gbGlzdCIgbmctaW5pdD0ib3V0ZXJJbmRleCA9ICRpbmRleCI+CiAgIDxkaXYgbmctcmVwZWF0PSJ2YWx1ZSBpbiBpbm5lckxpc3QiIG5nLWluaXQ9ImlubmVySW5kZXggPSAkaW5kZXgiPgogICA8c3BhbiBjbGFzcz0iZXhhbXBsZS1pbml0Ij5saXN0WyB7e291dGVySW5kZXh9fSBdWyB7e2lubmVySW5kZXh9fSBdID0ge3t2YWx1ZX19Ozwvc3Bhbj4KICAgPC9kaXY+CiAgIDwvZGl2PgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBhbGlhcyBpbmRleCBwb3NpdGlvbnMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgdmFyIGVsZW1lbnRzID0gZWxlbWVudC5hbGwoYnkuY3NzKCcuZXhhbXBsZS1pbml0JykpOwogICAgICAgICBleHBlY3QoZWxlbWVudHMuZ2V0KDApLmdldFRleHQoKSkudG9CZSgnbGlzdFsgMCBdWyAwIF0gPSBhOycpOwogICAgICAgICBleHBlY3QoZWxlbWVudHMuZ2V0KDEpLmdldFRleHQoKSkudG9CZSgnbGlzdFsgMCBdWyAxIF0gPSBiOycpOwogICAgICAgICBleHBlY3QoZWxlbWVudHMuZ2V0KDIpLmdldFRleHQoKSkudG9CZSgnbGlzdFsgMSBdWyAwIF0gPSBjOycpOwogICAgICAgICBleHBlY3QoZWxlbWVudHMuZ2V0KDMpLmdldFRleHQoKSkudG9CZSgnbGlzdFsgMSBdWyAxIF0gPSBkOycpOwogICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIHZhciBuZ0luaXREaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZSh7CiAgICBwcmlvcml0eTogNDUwLAogICAgY29tcGlsZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcHJlOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICAgIHNjb3BlLiRldmFsKGF0dHJzLm5nSW5pdCk7CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH0pOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdOb25CaW5kYWJsZQogICAqIEByZXN0cmljdCBBQwogICAqIEBwcmlvcml0eSAxMDAwCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgYG5nTm9uQmluZGFibGVgIGRpcmVjdGl2ZSB0ZWxscyBBbmd1bGFyIG5vdCB0byBjb21waWxlIG9yIGJpbmQgdGhlIGNvbnRlbnRzIG9mIHRoZSBjdXJyZW50CiAgICogRE9NIGVsZW1lbnQuIFRoaXMgaXMgdXNlZnVsIGlmIHRoZSBlbGVtZW50IGNvbnRhaW5zIHdoYXQgYXBwZWFycyB0byBiZSBBbmd1bGFyIGRpcmVjdGl2ZXMgYW5kCiAgICogYmluZGluZ3MgYnV0IHdoaWNoIHNob3VsZCBiZSBpZ25vcmVkIGJ5IEFuZ3VsYXIuIFRoaXMgY291bGQgYmUgdGhlIGNhc2UgaWYgeW91IGhhdmUgYSBzaXRlIHRoYXQKICAgKiBkaXNwbGF5cyBzbmlwcGV0cyBvZiBjb2RlLCBmb3IgaW5zdGFuY2UuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKgogICAqIEBleGFtcGxlCiAgICogSW4gdGhpcyBleGFtcGxlIHRoZXJlIGFyZSB0d28gbG9jYXRpb25zIHdoZXJlIGEgc2ltcGxlIGludGVycG9sYXRpb24gYmluZGluZyAoYHt7fX1gKSBpcyBwcmVzZW50LAogICAqIGJ1dCB0aGUgb25lIHdyYXBwZWQgaW4gYG5nTm9uQmluZGFibGVgIGlzIGxlZnQgYWxvbmUuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxkaXY+Tm9ybWFsOiB7ezEgKyAyfX08L2Rpdj4KICAgPGRpdiBuZy1ub24tYmluZGFibGU+SWdub3JlZDoge3sxICsgMn19PC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgY2hlY2sgbmctbm9uLWJpbmRhYmxlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJzEgKyAyJykpLmdldFRleHQoKSkudG9Db250YWluKCczJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50LmFsbChieS5jc3MoJ2RpdicpKS5sYXN0KCkuZ2V0VGV4dCgpKS50b01hdGNoKC8xIFwrIDIvKTsKICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICB2YXIgbmdOb25CaW5kYWJsZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsgdGVybWluYWw6IHRydWUsIHByaW9yaXR5OiAxMDAwIH0pOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdQbHVyYWxpemUKICAgKiBAcmVzdHJpY3QgRUEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIGBuZ1BsdXJhbGl6ZWAgaXMgYSBkaXJlY3RpdmUgdGhhdCBkaXNwbGF5cyBtZXNzYWdlcyBhY2NvcmRpbmcgdG8gZW4tVVMgbG9jYWxpemF0aW9uIHJ1bGVzLgogICAqIFRoZXNlIHJ1bGVzIGFyZSBidW5kbGVkIHdpdGggYW5ndWxhci5qcywgYnV0IGNhbiBiZSBvdmVycmlkZGVuCiAgICogKHNlZSB7QGxpbmsgZ3VpZGUvaTE4biBBbmd1bGFyIGkxOG59IGRldiBndWlkZSkuIFlvdSBjb25maWd1cmUgbmdQbHVyYWxpemUgZGlyZWN0aXZlCiAgICogYnkgc3BlY2lmeWluZyB0aGUgbWFwcGluZ3MgYmV0d2VlbgogICAqIFtwbHVyYWwgY2F0ZWdvcmllc10oaHR0cDovL3VuaWNvZGUub3JnL3JlcG9zL2NsZHItdG1wL3RydW5rL2RpZmYvc3VwcGxlbWVudGFsL2xhbmd1YWdlX3BsdXJhbF9ydWxlcy5odG1sKQogICAqIGFuZCB0aGUgc3RyaW5ncyB0byBiZSBkaXNwbGF5ZWQuCiAgICoKICAgKiAjIFBsdXJhbCBjYXRlZ29yaWVzIGFuZCBleHBsaWNpdCBudW1iZXIgcnVsZXMKICAgKiBUaGVyZSBhcmUgdHdvCiAgICogW3BsdXJhbCBjYXRlZ29yaWVzXShodHRwOi8vdW5pY29kZS5vcmcvcmVwb3MvY2xkci10bXAvdHJ1bmsvZGlmZi9zdXBwbGVtZW50YWwvbGFuZ3VhZ2VfcGx1cmFsX3J1bGVzLmh0bWwpCiAgICogaW4gQW5ndWxhcidzIGRlZmF1bHQgZW4tVVMgbG9jYWxlOiAib25lIiBhbmQgIm90aGVyIi4KICAgKgogICAqIFdoaWxlIGEgcGx1cmFsIGNhdGVnb3J5IG1heSBtYXRjaCBtYW55IG51bWJlcnMgKGZvciBleGFtcGxlLCBpbiBlbi1VUyBsb2NhbGUsICJvdGhlciIgY2FuIG1hdGNoCiAgICogYW55IG51bWJlciB0aGF0IGlzIG5vdCAxKSwgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUgY2FuIG9ubHkgbWF0Y2ggb25lIG51bWJlci4gRm9yIGV4YW1wbGUsIHRoZQogICAqIGV4cGxpY2l0IG51bWJlciBydWxlIGZvciAiMyIgbWF0Y2hlcyB0aGUgbnVtYmVyIDMuIFRoZXJlIGFyZSBleGFtcGxlcyBvZiBwbHVyYWwgY2F0ZWdvcmllcwogICAqIGFuZCBleHBsaWNpdCBudW1iZXIgcnVsZXMgdGhyb3VnaG91dCB0aGUgcmVzdCBvZiB0aGlzIGRvY3VtZW50YXRpb24uCiAgICoKICAgKiAjIENvbmZpZ3VyaW5nIG5nUGx1cmFsaXplCiAgICogWW91IGNvbmZpZ3VyZSBuZ1BsdXJhbGl6ZSBieSBwcm92aWRpbmcgMiBhdHRyaWJ1dGVzOiBgY291bnRgIGFuZCBgd2hlbmAuCiAgICogWW91IGNhbiBhbHNvIHByb3ZpZGUgYW4gb3B0aW9uYWwgYXR0cmlidXRlLCBgb2Zmc2V0YC4KICAgKgogICAqIFRoZSB2YWx1ZSBvZiB0aGUgYGNvdW50YCBhdHRyaWJ1dGUgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvciBhbiB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbgogKiBBbmd1bGFyIGV4cHJlc3Npb259OyB0aGVzZSBhcmUgZXZhbHVhdGVkIG9uIHRoZSBjdXJyZW50IHNjb3BlIGZvciBpdHMgYm91bmQgdmFsdWUuCiAgICoKICAgKiBUaGUgYHdoZW5gIGF0dHJpYnV0ZSBzcGVjaWZpZXMgdGhlIG1hcHBpbmdzIGJldHdlZW4gcGx1cmFsIGNhdGVnb3JpZXMgYW5kIHRoZSBhY3R1YWwKICAgKiBzdHJpbmcgdG8gYmUgZGlzcGxheWVkLiBUaGUgdmFsdWUgb2YgdGhlIGF0dHJpYnV0ZSBzaG91bGQgYmUgYSBKU09OIG9iamVjdC4KICAgKgogICAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBzaG93cyBob3cgdG8gY29uZmlndXJlIG5nUGx1cmFsaXplOgogICAqCiAgICogYGBgaHRtbAogICAqIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IgogICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICcxIHBlcnNvbiBpcyB2aWV3aW5nLicsCiAqICAgICAgICAgICAgICAgICAgICAgICdvdGhlcic6ICd7fSBwZW9wbGUgYXJlIHZpZXdpbmcuJ30iPgogICAqIDwvbmctcGx1cmFsaXplPgogICAqYGBgCiAgICoKICAgKiBJbiB0aGUgZXhhbXBsZSwgYCIwOiBOb2JvZHkgaXMgdmlld2luZy4iYCBpcyBhbiBleHBsaWNpdCBudW1iZXIgcnVsZS4gSWYgeW91IGRpZCBub3QKICAgKiBzcGVjaWZ5IHRoaXMgcnVsZSwgMCB3b3VsZCBiZSBtYXRjaGVkIHRvIHRoZSAib3RoZXIiIGNhdGVnb3J5IGFuZCAiMCBwZW9wbGUgYXJlIHZpZXdpbmciCiAgICogd291bGQgYmUgc2hvd24gaW5zdGVhZCBvZiAiTm9ib2R5IGlzIHZpZXdpbmciLiBZb3UgY2FuIHNwZWNpZnkgYW4gZXhwbGljaXQgbnVtYmVyIHJ1bGUgZm9yCiAgICogb3RoZXIgbnVtYmVycywgZm9yIGV4YW1wbGUgMTIsIHNvIHRoYXQgaW5zdGVhZCBvZiBzaG93aW5nICIxMiBwZW9wbGUgYXJlIHZpZXdpbmciLCB5b3UgY2FuCiAgICogc2hvdyAiYSBkb3plbiBwZW9wbGUgYXJlIHZpZXdpbmciLgogICAqCiAgICogWW91IGNhbiB1c2UgYSBzZXQgb2YgY2xvc2VkIGJyYWNlcyAoYHt9YCkgYXMgYSBwbGFjZWhvbGRlciBmb3IgdGhlIG51bWJlciB0aGF0IHlvdSB3YW50IHN1YnN0aXR1dGVkCiAgICogaW50byBwbHVyYWxpemVkIHN0cmluZ3MuIEluIHRoZSBwcmV2aW91cyBleGFtcGxlLCBBbmd1bGFyIHdpbGwgcmVwbGFjZSBge31gIHdpdGgKICAgKiA8c3BhbiBuZy1ub24tYmluZGFibGU+YHt7cGVyc29uQ291bnR9fWA8L3NwYW4+LiBUaGUgY2xvc2VkIGJyYWNlcyBge31gIGlzIGEgcGxhY2Vob2xkZXIKICAgKiBmb3IgPHNwYW4gbmctbm9uLWJpbmRhYmxlPnt7bnVtYmVyRXhwcmVzc2lvbn19PC9zcGFuPi4KICAgKgogICAqICMgQ29uZmlndXJpbmcgbmdQbHVyYWxpemUgd2l0aCBvZmZzZXQKICAgKiBUaGUgYG9mZnNldGAgYXR0cmlidXRlIGFsbG93cyBmdXJ0aGVyIGN1c3RvbWl6YXRpb24gb2YgcGx1cmFsaXplZCB0ZXh0LCB3aGljaCBjYW4gcmVzdWx0IGluCiAgICogYSBiZXR0ZXIgdXNlciBleHBlcmllbmNlLiBGb3IgZXhhbXBsZSwgaW5zdGVhZCBvZiB0aGUgbWVzc2FnZSAiNCBwZW9wbGUgYXJlIHZpZXdpbmcgdGhpcyBkb2N1bWVudCIsCiAgICogeW91IG1pZ2h0IGRpc3BsYXkgIkpvaG4sIEthdGUgYW5kIDIgb3RoZXJzIGFyZSB2aWV3aW5nIHRoaXMgZG9jdW1lbnQiLgogICAqIFRoZSBvZmZzZXQgYXR0cmlidXRlIGFsbG93cyB5b3UgdG8gb2Zmc2V0IGEgbnVtYmVyIGJ5IGFueSBkZXNpcmVkIHZhbHVlLgogICAqIExldCdzIHRha2UgYSBsb29rIGF0IGFuIGV4YW1wbGU6CiAgICoKICAgKiBgYGBodG1sCiAgICogPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiIG9mZnNldD0yCiAgICogICAgICAgICAgICAgICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogKiAgICAgICAgICAgICAgICAgICAgICAnMic6ICd7e3BlcnNvbjF9fSBhbmQge3twZXJzb24yfX0gYXJlIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ29uZSc6ICd7e3BlcnNvbjF9fSwge3twZXJzb24yfX0gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJywKICogICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgKiA8L25nLXBsdXJhbGl6ZT4KICAgKiBgYGAKICAgKgogICAqIE5vdGljZSB0aGF0IHdlIGFyZSBzdGlsbCB1c2luZyB0d28gcGx1cmFsIGNhdGVnb3JpZXMob25lLCBvdGhlciksIGJ1dCB3ZSBhZGRlZAogICAqIHRocmVlIGV4cGxpY2l0IG51bWJlciBydWxlcyAwLCAxIGFuZCAyLgogICAqIFdoZW4gb25lIHBlcnNvbiwgcGVyaGFwcyBKb2huLCB2aWV3cyB0aGUgZG9jdW1lbnQsICJKb2huIGlzIHZpZXdpbmciIHdpbGwgYmUgc2hvd24uCiAgICogV2hlbiB0aHJlZSBwZW9wbGUgdmlldyB0aGUgZG9jdW1lbnQsIG5vIGV4cGxpY2l0IG51bWJlciBydWxlIGlzIGZvdW5kLCBzbwogICAqIGFuIG9mZnNldCBvZiAyIGlzIHRha2VuIG9mZiAzLCBhbmQgQW5ndWxhciB1c2VzIDEgdG8gZGVjaWRlIHRoZSBwbHVyYWwgY2F0ZWdvcnkuCiAgICogSW4gdGhpcyBjYXNlLCBwbHVyYWwgY2F0ZWdvcnkgJ29uZScgaXMgbWF0Y2hlZCBhbmQgIkpvaG4sIE1hcnJ5IGFuZCBvbmUgb3RoZXIgcGVyc29uIGFyZSB2aWV3aW5nIgogICAqIGlzIHNob3duLgogICAqCiAgICogTm90ZSB0aGF0IHdoZW4geW91IHNwZWNpZnkgb2Zmc2V0cywgeW91IG11c3QgcHJvdmlkZSBleHBsaWNpdCBudW1iZXIgcnVsZXMgZm9yCiAgICogbnVtYmVycyBmcm9tIDAgdXAgdG8gYW5kIGluY2x1ZGluZyB0aGUgb2Zmc2V0LiBJZiB5b3UgdXNlIGFuIG9mZnNldCBvZiAzLCBmb3IgZXhhbXBsZSwKICAgKiB5b3UgbXVzdCBwcm92aWRlIGV4cGxpY2l0IG51bWJlciBydWxlcyBmb3IgMCwgMSwgMiBhbmQgMy4gWW91IG11c3QgYWxzbyBwcm92aWRlIHBsdXJhbCBzdHJpbmdzIGZvcgogICAqIHBsdXJhbCBjYXRlZ29yaWVzICJvbmUiIGFuZCAib3RoZXIiLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd8ZXhwcmVzc2lvbn0gY291bnQgVGhlIHZhcmlhYmxlIHRvIGJlIGJvdW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nfSB3aGVuIFRoZSBtYXBwaW5nIGJldHdlZW4gcGx1cmFsIGNhdGVnb3J5IHRvIGl0cyBjb3JyZXNwb25kaW5nIHN0cmluZ3MuCiAgICogQHBhcmFtIHtudW1iZXI9fSBvZmZzZXQgT2Zmc2V0IHRvIGRlZHVjdCBmcm9tIHRoZSB0b3RhbCBudW1iZXIuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS5wZXJzb24xID0gJ0lnb3InOwogICAgICAgICAgICAkc2NvcGUucGVyc29uMiA9ICdNaXNrbyc7CiAgICAgICAgICAgICRzY29wZS5wZXJzb25Db3VudCA9IDE7CiAgICAgICAgICB9CiAgIDwvc2NyaXB0PgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICBQZXJzb24gMTo8aW5wdXQgdHlwZT0idGV4dCIgbmctbW9kZWw9InBlcnNvbjEiIHZhbHVlPSJJZ29yIiAvPjxici8+CiAgIFBlcnNvbiAyOjxpbnB1dCB0eXBlPSJ0ZXh0IiBuZy1tb2RlbD0icGVyc29uMiIgdmFsdWU9Ik1pc2tvIiAvPjxici8+CiAgIE51bWJlciBvZiBQZW9wbGU6PGlucHV0IHR5cGU9InRleHQiIG5nLW1vZGVsPSJwZXJzb25Db3VudCIgdmFsdWU9IjEiIC8+PGJyLz4KCiAgIDwhLS0tIEV4YW1wbGUgd2l0aCBzaW1wbGUgcGx1cmFsaXphdGlvbiBydWxlcyBmb3IgZW4gbG9jYWxlIC0tLT4KICAgV2l0aG91dCBPZmZzZXQ6CiAgIDxuZy1wbHVyYWxpemUgY291bnQ9InBlcnNvbkNvdW50IgogICB3aGVuPSJ7JzAnOiAnTm9ib2R5IGlzIHZpZXdpbmcuJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvbmUnOiAnMSBwZXJzb24gaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t9IHBlb3BsZSBhcmUgdmlld2luZy4nfSI+CiAgIDwvbmctcGx1cmFsaXplPjxicj4KCiAgIDwhLS0tIEV4YW1wbGUgd2l0aCBvZmZzZXQgLS0tPgogICBXaXRoIE9mZnNldCgyKToKICAgPG5nLXBsdXJhbGl6ZSBjb3VudD0icGVyc29uQ291bnQiIG9mZnNldD0yCiAgIHdoZW49InsnMCc6ICdOb2JvZHkgaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzEnOiAne3twZXJzb24xfX0gaXMgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzInOiAne3twZXJzb24xfX0gYW5kIHt7cGVyc29uMn19IGFyZSB2aWV3aW5nLicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb25lJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQgb25lIG90aGVyIHBlcnNvbiBhcmUgdmlld2luZy4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ290aGVyJzogJ3t7cGVyc29uMX19LCB7e3BlcnNvbjJ9fSBhbmQge30gb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLid9Ij4KICAgPC9uZy1wbHVyYWxpemU+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIHNob3cgY29ycmVjdCBwbHVyYWxpemVkIHN0cmluZycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHdpdGhvdXRPZmZzZXQgPSBlbGVtZW50LmFsbChieS5jc3MoJ25nLXBsdXJhbGl6ZScpKS5nZXQoMCk7CiAgICAgICAgICB2YXIgd2l0aE9mZnNldCA9IGVsZW1lbnQuYWxsKGJ5LmNzcygnbmctcGx1cmFsaXplJykpLmdldCgxKTsKICAgICAgICAgIHZhciBjb3VudElucHV0ID0gZWxlbWVudChieS5tb2RlbCgncGVyc29uQ291bnQnKSk7CgogICAgICAgICAgZXhwZWN0KHdpdGhvdXRPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCcxIHBlcnNvbiBpcyB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdJZ29yIGlzIHZpZXdpbmcuJyk7CgogICAgICAgICAgY291bnRJbnB1dC5jbGVhcigpOwogICAgICAgICAgY291bnRJbnB1dC5zZW5kS2V5cygnMCcpOwoKICAgICAgICAgIGV4cGVjdCh3aXRob3V0T2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnTm9ib2R5IGlzIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3Qod2l0aE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ05vYm9keSBpcyB2aWV3aW5nLicpOwoKICAgICAgICAgIGNvdW50SW5wdXQuY2xlYXIoKTsKICAgICAgICAgIGNvdW50SW5wdXQuc2VuZEtleXMoJzInKTsKCiAgICAgICAgICBleHBlY3Qod2l0aG91dE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJzIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdJZ29yIGFuZCBNaXNrbyBhcmUgdmlld2luZy4nKTsKCiAgICAgICAgICBjb3VudElucHV0LmNsZWFyKCk7CiAgICAgICAgICBjb3VudElucHV0LnNlbmRLZXlzKCczJyk7CgogICAgICAgICAgZXhwZWN0KHdpdGhvdXRPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCczIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICAgIGV4cGVjdCh3aXRoT2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnSWdvciwgTWlza28gYW5kIG9uZSBvdGhlciBwZXJzb24gYXJlIHZpZXdpbmcuJyk7CgogICAgICAgICAgY291bnRJbnB1dC5jbGVhcigpOwogICAgICAgICAgY291bnRJbnB1dC5zZW5kS2V5cygnNCcpOwoKICAgICAgICAgIGV4cGVjdCh3aXRob3V0T2Zmc2V0LmdldFRleHQoKSkudG9FcXVhbCgnNCBwZW9wbGUgYXJlIHZpZXdpbmcuJyk7CiAgICAgICAgICBleHBlY3Qod2l0aE9mZnNldC5nZXRUZXh0KCkpLnRvRXF1YWwoJ0lnb3IsIE1pc2tvIGFuZCAyIG90aGVyIHBlb3BsZSBhcmUgdmlld2luZy4nKTsKICAgICAgICB9KTsKICAgaXQoJ3Nob3VsZCBzaG93IGRhdGEtYm91bmQgbmFtZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciB3aXRoT2Zmc2V0ID0gZWxlbWVudC5hbGwoYnkuY3NzKCduZy1wbHVyYWxpemUnKSkuZ2V0KDEpOwogICAgICAgICAgdmFyIHBlcnNvbkNvdW50ID0gZWxlbWVudChieS5tb2RlbCgncGVyc29uQ291bnQnKSk7CiAgICAgICAgICB2YXIgcGVyc29uMSA9IGVsZW1lbnQoYnkubW9kZWwoJ3BlcnNvbjEnKSk7CiAgICAgICAgICB2YXIgcGVyc29uMiA9IGVsZW1lbnQoYnkubW9kZWwoJ3BlcnNvbjInKSk7CiAgICAgICAgICBwZXJzb25Db3VudC5jbGVhcigpOwogICAgICAgICAgcGVyc29uQ291bnQuc2VuZEtleXMoJzQnKTsKICAgICAgICAgIHBlcnNvbjEuY2xlYXIoKTsKICAgICAgICAgIHBlcnNvbjEuc2VuZEtleXMoJ0RpJyk7CiAgICAgICAgICBwZXJzb24yLmNsZWFyKCk7CiAgICAgICAgICBwZXJzb24yLnNlbmRLZXlzKCdWb2p0YScpOwogICAgICAgICAgZXhwZWN0KHdpdGhPZmZzZXQuZ2V0VGV4dCgpKS50b0VxdWFsKCdEaSwgVm9qdGEgYW5kIDIgb3RoZXIgcGVvcGxlIGFyZSB2aWV3aW5nLicpOwogICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICB2YXIgbmdQbHVyYWxpemVEaXJlY3RpdmUgPSBbJyRsb2NhbGUnLCAnJGludGVycG9sYXRlJywgZnVuY3Rpb24oJGxvY2FsZSwgJGludGVycG9sYXRlKSB7CiAgICB2YXIgQlJBQ0UgPSAve30vZzsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgIHZhciBudW1iZXJFeHAgPSBhdHRyLmNvdW50LAogICAgICAgICAgd2hlbkV4cCA9IGF0dHIuJGF0dHIud2hlbiAmJiBlbGVtZW50LmF0dHIoYXR0ci4kYXR0ci53aGVuKSwgLy8gd2UgaGF2ZSB7e319IGluIGF0dHJzCiAgICAgICAgICBvZmZzZXQgPSBhdHRyLm9mZnNldCB8fCAwLAogICAgICAgICAgd2hlbnMgPSBzY29wZS4kZXZhbCh3aGVuRXhwKSB8fCB7fSwKICAgICAgICAgIHdoZW5zRXhwRm5zID0ge30sCiAgICAgICAgICBzdGFydFN5bWJvbCA9ICRpbnRlcnBvbGF0ZS5zdGFydFN5bWJvbCgpLAogICAgICAgICAgZW5kU3ltYm9sID0gJGludGVycG9sYXRlLmVuZFN5bWJvbCgpLAogICAgICAgICAgaXNXaGVuID0gL153aGVuKE1pbnVzKT8oLispJC87CgogICAgICAgIGZvckVhY2goYXR0ciwgZnVuY3Rpb24oZXhwcmVzc2lvbiwgYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgaWYgKGlzV2hlbi50ZXN0KGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgIHdoZW5zW2xvd2VyY2FzZShhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoJ3doZW4nLCAnJykucmVwbGFjZSgnTWludXMnLCAnLScpKV0gPQogICAgICAgICAgICAgIGVsZW1lbnQuYXR0cihhdHRyLiRhdHRyW2F0dHJpYnV0ZU5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBmb3JFYWNoKHdoZW5zLCBmdW5jdGlvbihleHByZXNzaW9uLCBrZXkpIHsKICAgICAgICAgIHdoZW5zRXhwRm5zW2tleV0gPQogICAgICAgICAgICAkaW50ZXJwb2xhdGUoZXhwcmVzc2lvbi5yZXBsYWNlKEJSQUNFLCBzdGFydFN5bWJvbCArIG51bWJlckV4cCArICctJyArCiAgICAgICAgICAgICAgb2Zmc2V0ICsgZW5kU3ltYm9sKSk7CiAgICAgICAgfSk7CgogICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBuZ1BsdXJhbGl6ZVdhdGNoKCkgewogICAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VGbG9hdChzY29wZS4kZXZhbChudW1iZXJFeHApKTsKCiAgICAgICAgICBpZiAoIWlzTmFOKHZhbHVlKSkgewogICAgICAgICAgICAvL2lmIGV4cGxpY2l0IG51bWJlciBydWxlIHN1Y2ggYXMgMSwgMiwgMy4uLiBpcyBkZWZpbmVkLCBqdXN0IHVzZSBpdC4gT3RoZXJ3aXNlLAogICAgICAgICAgICAvL2NoZWNrIGl0IGFnYWluc3QgcGx1cmFsaXphdGlvbiBydWxlcyBpbiAkbG9jYWxlIHNlcnZpY2UKICAgICAgICAgICAgaWYgKCEodmFsdWUgaW4gd2hlbnMpKSB2YWx1ZSA9ICRsb2NhbGUucGx1cmFsQ2F0KHZhbHVlIC0gb2Zmc2V0KTsKICAgICAgICAgICAgcmV0dXJuIHdoZW5zRXhwRm5zW3ZhbHVlXShzY29wZSwgZWxlbWVudCwgdHJ1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgICB9CiAgICAgICAgfSwgZnVuY3Rpb24gbmdQbHVyYWxpemVXYXRjaEFjdGlvbihuZXdWYWwpIHsKICAgICAgICAgIGVsZW1lbnQudGV4dChuZXdWYWwpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogIH1dOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdSZXBlYXQKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdSZXBlYXRgIGRpcmVjdGl2ZSBpbnN0YW50aWF0ZXMgYSB0ZW1wbGF0ZSBvbmNlIHBlciBpdGVtIGZyb20gYSBjb2xsZWN0aW9uLiBFYWNoIHRlbXBsYXRlCiAgICogaW5zdGFuY2UgZ2V0cyBpdHMgb3duIHNjb3BlLCB3aGVyZSB0aGUgZ2l2ZW4gbG9vcCB2YXJpYWJsZSBpcyBzZXQgdG8gdGhlIGN1cnJlbnQgY29sbGVjdGlvbiBpdGVtLAogICAqIGFuZCBgJGluZGV4YCBpcyBzZXQgdG8gdGhlIGl0ZW0gaW5kZXggb3Iga2V5LgogICAqCiAgICogU3BlY2lhbCBwcm9wZXJ0aWVzIGFyZSBleHBvc2VkIG9uIHRoZSBsb2NhbCBzY29wZSBvZiBlYWNoIHRlbXBsYXRlIGluc3RhbmNlLCBpbmNsdWRpbmc6CiAgICoKICAgKiB8IFZhcmlhYmxlICB8IFR5cGUgICAgICAgICAgICB8IERldGFpbHMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICogfC0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAqIHwgYCRpbmRleGAgIHwge0B0eXBlIG51bWJlcn0gIHwgaXRlcmF0b3Igb2Zmc2V0IG9mIHRoZSByZXBlYXRlZCBlbGVtZW50ICgwLi5sZW5ndGgtMSkgICAgICAgICAgICAgICAgICAgICAgIHwKICAgKiB8IGAkZmlyc3RgICB8IHtAdHlwZSBib29sZWFufSB8IHRydWUgaWYgdGhlIHJlcGVhdGVkIGVsZW1lbnQgaXMgZmlyc3QgaW4gdGhlIGl0ZXJhdG9yLiAgICAgICAgICAgICAgICAgICAgICB8CiAgICogfCBgJG1pZGRsZWAgfCB7QHR5cGUgYm9vbGVhbn0gfCB0cnVlIGlmIHRoZSByZXBlYXRlZCBlbGVtZW50IGlzIGJldHdlZW4gdGhlIGZpcnN0IGFuZCBsYXN0IGluIHRoZSBpdGVyYXRvci4gfAogICAqIHwgYCRsYXN0YCAgIHwge0B0eXBlIGJvb2xlYW59IHwgdHJ1ZSBpZiB0aGUgcmVwZWF0ZWQgZWxlbWVudCBpcyBsYXN0IGluIHRoZSBpdGVyYXRvci4gICAgICAgICAgICAgICAgICAgICAgIHwKICAgKiB8IGAkZXZlbmAgICB8IHtAdHlwZSBib29sZWFufSB8IHRydWUgaWYgdGhlIGl0ZXJhdG9yIHBvc2l0aW9uIGAkaW5kZXhgIGlzIGV2ZW4gKG90aGVyd2lzZSBmYWxzZSkuICAgICAgICAgICB8CiAgICogfCBgJG9kZGAgICAgfCB7QHR5cGUgYm9vbGVhbn0gfCB0cnVlIGlmIHRoZSBpdGVyYXRvciBwb3NpdGlvbiBgJGluZGV4YCBpcyBvZGQgKG90aGVyd2lzZSBmYWxzZSkuICAgICAgICAgICAgfAogICAqCiAgICogQ3JlYXRpbmcgYWxpYXNlcyBmb3IgdGhlc2UgcHJvcGVydGllcyBpcyBwb3NzaWJsZSB3aXRoIHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbml0IGBuZ0luaXRgfS4KICAgKiBUaGlzIG1heSBiZSB1c2VmdWwgd2hlbiwgZm9yIGluc3RhbmNlLCBuZXN0aW5nIG5nUmVwZWF0cy4KICAgKgogICAqICMgU3BlY2lhbCByZXBlYXQgc3RhcnQgYW5kIGVuZCBwb2ludHMKICAgKiBUbyByZXBlYXQgYSBzZXJpZXMgb2YgZWxlbWVudHMgaW5zdGVhZCBvZiBqdXN0IG9uZSBwYXJlbnQgZWxlbWVudCwgbmdSZXBlYXQgKGFzIHdlbGwgYXMgb3RoZXIgbmcgZGlyZWN0aXZlcykgc3VwcG9ydHMgZXh0ZW5kaW5nCiAgICogdGhlIHJhbmdlIG9mIHRoZSByZXBlYXRlciBieSBkZWZpbmluZyBleHBsaWNpdCBzdGFydCBhbmQgZW5kIHBvaW50cyBieSB1c2luZyAqKm5nLXJlcGVhdC1zdGFydCoqIGFuZCAqKm5nLXJlcGVhdC1lbmQqKiByZXNwZWN0aXZlbHkuCiAgICogVGhlICoqbmctcmVwZWF0LXN0YXJ0KiogZGlyZWN0aXZlIHdvcmtzIHRoZSBzYW1lIGFzICoqbmctcmVwZWF0KiosIGJ1dCB3aWxsIHJlcGVhdCBhbGwgdGhlIEhUTUwgY29kZSAoaW5jbHVkaW5nIHRoZSB0YWcgaXQncyBkZWZpbmVkIG9uKQogICAqIHVwIHRvIGFuZCBpbmNsdWRpbmcgdGhlIGVuZGluZyBIVE1MIHRhZyB3aGVyZSAqKm5nLXJlcGVhdC1lbmQqKiBpcyBwbGFjZWQuCiAgICoKICAgKiBUaGUgZXhhbXBsZSBiZWxvdyBtYWtlcyB1c2Ugb2YgdGhpcyBmZWF0dXJlOgogICAqIGBgYGh0bWwKICAgKiAgIDxoZWFkZXIgbmctcmVwZWF0LXN0YXJ0PSJpdGVtIGluIGl0ZW1zIj4KICAgKiAgICAgSGVhZGVyIHt7IGl0ZW0gfX0KICAgKiAgIDwvaGVhZGVyPgogICAqICAgPGRpdiBjbGFzcz0iYm9keSI+CiAgICogICAgIEJvZHkge3sgaXRlbSB9fQogICAqICAgPC9kaXY+CiAgICogICA8Zm9vdGVyIG5nLXJlcGVhdC1lbmQ+CiAgICogICAgIEZvb3RlciB7eyBpdGVtIH19CiAgICogICA8L2Zvb3Rlcj4KICAgKiBgYGAKICAgKgogICAqIEFuZCB3aXRoIGFuIGlucHV0IG9mIHtAdHlwZSBbJ0EnLCdCJ119IGZvciB0aGUgaXRlbXMgdmFyaWFibGUgaW4gdGhlIGV4YW1wbGUgYWJvdmUsIHRoZSBvdXRwdXQgd2lsbCBldmFsdWF0ZSB0bzoKICAgKiBgYGBodG1sCiAgICogICA8aGVhZGVyPgogICAqICAgICBIZWFkZXIgQQogICAqICAgPC9oZWFkZXI+CiAgICogICA8ZGl2IGNsYXNzPSJib2R5Ij4KICAgKiAgICAgQm9keSBBCiAgICogICA8L2Rpdj4KICAgKiAgIDxmb290ZXI+CiAgICogICAgIEZvb3RlciBBCiAgICogICA8L2Zvb3Rlcj4KICAgKiAgIDxoZWFkZXI+CiAgICogICAgIEhlYWRlciBCCiAgICogICA8L2hlYWRlcj4KICAgKiAgIDxkaXYgY2xhc3M9ImJvZHkiPgogICAqICAgICBCb2R5IEIKICAgKiAgIDwvZGl2PgogICAqICAgPGZvb3Rlcj4KICAgKiAgICAgRm9vdGVyIEIKICAgKiAgIDwvZm9vdGVyPgogICAqIGBgYAogICAqCiAgICogVGhlIGN1c3RvbSBzdGFydCBhbmQgZW5kIHBvaW50cyBmb3IgbmdSZXBlYXQgYWxzbyBzdXBwb3J0IGFsbCBvdGhlciBIVE1MIGRpcmVjdGl2ZSBzeW50YXggZmxhdm9ycyBwcm92aWRlZCBpbiBBbmd1bGFySlMgKHN1Y2gKICAgKiBhcyAqKmRhdGEtbmctcmVwZWF0LXN0YXJ0KiosICoqeC1uZy1yZXBlYXQtc3RhcnQqKiBhbmQgKipuZzpyZXBlYXQtc3RhcnQqKikuCiAgICoKICAgKiBAYW5pbWF0aW9ucwogICAqICoqLmVudGVyKiogLSB3aGVuIGEgbmV3IGl0ZW0gaXMgYWRkZWQgdG8gdGhlIGxpc3Qgb3Igd2hlbiBhbiBpdGVtIGlzIHJldmVhbGVkIGFmdGVyIGEgZmlsdGVyCiAgICoKICAgKiAqKi5sZWF2ZSoqIC0gd2hlbiBhbiBpdGVtIGlzIHJlbW92ZWQgZnJvbSB0aGUgbGlzdCBvciB3aGVuIGFuIGl0ZW0gaXMgZmlsdGVyZWQgb3V0CiAgICoKICAgKiAqKi5tb3ZlKiogLSB3aGVuIGFuIGFkamFjZW50IGl0ZW0gaXMgZmlsdGVyZWQgb3V0IGNhdXNpbmcgYSByZW9yZGVyIG9yIHdoZW4gdGhlIGl0ZW0gY29udGVudHMgYXJlIHJlb3JkZXJlZAogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHNjb3BlCiAgICogQHByaW9yaXR5IDEwMDAKICAgKiBAcGFyYW0ge3JlcGVhdF9leHByZXNzaW9ufSBuZ1JlcGVhdCBUaGUgZXhwcmVzc2lvbiBpbmRpY2F0aW5nIGhvdyB0byBlbnVtZXJhdGUgYSBjb2xsZWN0aW9uLiBUaGVzZQogICAqICAgZm9ybWF0cyBhcmUgY3VycmVudGx5IHN1cHBvcnRlZDoKICAgKgogICAqICAgKiBgdmFyaWFibGUgaW4gZXhwcmVzc2lvbmAg4oCTIHdoZXJlIHZhcmlhYmxlIGlzIHRoZSB1c2VyIGRlZmluZWQgbG9vcCB2YXJpYWJsZSBhbmQgYGV4cHJlc3Npb25gCiAgICogICAgIGlzIGEgc2NvcGUgZXhwcmVzc2lvbiBnaXZpbmcgdGhlIGNvbGxlY3Rpb24gdG8gZW51bWVyYXRlLgogICAqCiAgICogICAgIEZvciBleGFtcGxlOiBgYWxidW0gaW4gYXJ0aXN0LmFsYnVtc2AuCiAgICoKICAgKiAgICogYChrZXksIHZhbHVlKSBpbiBleHByZXNzaW9uYCDigJMgd2hlcmUgYGtleWAgYW5kIGB2YWx1ZWAgY2FuIGJlIGFueSB1c2VyIGRlZmluZWQgaWRlbnRpZmllcnMsCiAgICogICAgIGFuZCBgZXhwcmVzc2lvbmAgaXMgdGhlIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICAgKgogICAqICAgICBGb3IgZXhhbXBsZTogYChuYW1lLCBhZ2UpIGluIHsnYWRhbSc6MTAsICdhbWFsaWUnOjEyfWAuCiAgICoKICAgKiAgICogYHZhcmlhYmxlIGluIGV4cHJlc3Npb24gdHJhY2sgYnkgdHJhY2tpbmdfZXhwcmVzc2lvbmAg4oCTIFlvdSBjYW4gYWxzbyBwcm92aWRlIGFuIG9wdGlvbmFsIHRyYWNraW5nIGZ1bmN0aW9uCiAgICogICAgIHdoaWNoIGNhbiBiZSB1c2VkIHRvIGFzc29jaWF0ZSB0aGUgb2JqZWN0cyBpbiB0aGUgY29sbGVjdGlvbiB3aXRoIHRoZSBET00gZWxlbWVudHMuIElmIG5vIHRyYWNraW5nIGZ1bmN0aW9uCiAgICogICAgIGlzIHNwZWNpZmllZCB0aGUgbmctcmVwZWF0IGFzc29jaWF0ZXMgZWxlbWVudHMgYnkgaWRlbnRpdHkgaW4gdGhlIGNvbGxlY3Rpb24uIEl0IGlzIGFuIGVycm9yIHRvIGhhdmUKICAgKiAgICAgbW9yZSB0aGFuIG9uZSB0cmFja2luZyBmdW5jdGlvbiB0byByZXNvbHZlIHRvIHRoZSBzYW1lIGtleS4gKFRoaXMgd291bGQgbWVhbiB0aGF0IHR3byBkaXN0aW5jdCBvYmplY3RzIGFyZQogICAqICAgICBtYXBwZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQsIHdoaWNoIGlzIG5vdCBwb3NzaWJsZS4pICBGaWx0ZXJzIHNob3VsZCBiZSBhcHBsaWVkIHRvIHRoZSBleHByZXNzaW9uLAogICAqICAgICBiZWZvcmUgc3BlY2lmeWluZyBhIHRyYWNraW5nIGV4cHJlc3Npb24uCiAgICoKICAgKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zYCBpcyBlcXVpdmFsZW50IHRvIGBpdGVtIGluIGl0ZW1zIHRyYWNrIGJ5ICRpZChpdGVtKWAuIFRoaXMgaW1wbGllcyB0aGF0IHRoZSBET00gZWxlbWVudHMKICAgKiAgICAgd2lsbCBiZSBhc3NvY2lhdGVkIGJ5IGl0ZW0gaWRlbnRpdHkgaW4gdGhlIGFycmF5LgogICAqCiAgICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSAkaWQoaXRlbSlgLiBBIGJ1aWx0IGluIGAkaWQoKWAgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gYXNzaWduIGEgdW5pcXVlCiAgICogICAgIGAkJGhhc2hLZXlgIHByb3BlcnR5IHRvIGVhY2ggaXRlbSBpbiB0aGUgYXJyYXkuIFRoaXMgcHJvcGVydHkgaXMgdGhlbiB1c2VkIGFzIGEga2V5IHRvIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnRzCiAgICogICAgIHdpdGggdGhlIGNvcnJlc3BvbmRpbmcgaXRlbSBpbiB0aGUgYXJyYXkgYnkgaWRlbnRpdHkuIE1vdmluZyB0aGUgc2FtZSBvYmplY3QgaW4gYXJyYXkgd291bGQgbW92ZSB0aGUgRE9NCiAgICogICAgIGVsZW1lbnQgaW4gdGhlIHNhbWUgd2F5IGluIHRoZSBET00uCiAgICoKICAgKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHRyYWNrIGJ5IGl0ZW0uaWRgIGlzIGEgdHlwaWNhbCBwYXR0ZXJuIHdoZW4gdGhlIGl0ZW1zIGNvbWUgZnJvbSB0aGUgZGF0YWJhc2UuIEluIHRoaXMKICAgKiAgICAgY2FzZSB0aGUgb2JqZWN0IGlkZW50aXR5IGRvZXMgbm90IG1hdHRlci4gVHdvIG9iamVjdHMgYXJlIGNvbnNpZGVyZWQgZXF1aXZhbGVudCBhcyBsb25nIGFzIHRoZWlyIGBpZGAKICAgKiAgICAgcHJvcGVydHkgaXMgc2FtZS4KICAgKgogICAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXMgfCBmaWx0ZXI6c2VhcmNoVGV4dCB0cmFjayBieSBpdGVtLmlkYCBpcyBhIHBhdHRlcm4gdGhhdCBtaWdodCBiZSB1c2VkIHRvIGFwcGx5IGEgZmlsdGVyCiAgICogICAgIHRvIGl0ZW1zIGluIGNvbmp1bmN0aW9uIHdpdGggYSB0cmFja2luZyBleHByZXNzaW9uLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBUaGlzIGV4YW1wbGUgaW5pdGlhbGl6ZXMgdGhlIHNjb3BlIHRvIGEgbGlzdCBvZiBuYW1lcyBhbmQKICAgKiB0aGVuIHVzZXMgYG5nUmVwZWF0YCB0byBkaXNwbGF5IGV2ZXJ5IHBlcnNvbjoKICAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8ZGl2IG5nLWluaXQ9ImZyaWVuZHMgPSBbCiAgIHtuYW1lOidKb2huJywgYWdlOjI1LCBnZW5kZXI6J2JveSd9LAogICB7bmFtZTonSmVzc2llJywgYWdlOjMwLCBnZW5kZXI6J2dpcmwnfSwKICAge25hbWU6J0pvaGFubmEnLCBhZ2U6MjgsIGdlbmRlcjonZ2lybCd9LAogICB7bmFtZTonSm95JywgYWdlOjE1LCBnZW5kZXI6J2dpcmwnfSwKICAge25hbWU6J01hcnknLCBhZ2U6MjgsIGdlbmRlcjonZ2lybCd9LAogICB7bmFtZTonUGV0ZXInLCBhZ2U6OTUsIGdlbmRlcjonYm95J30sCiAgIHtuYW1lOidTZWJhc3RpYW4nLCBhZ2U6NTAsIGdlbmRlcjonYm95J30sCiAgIHtuYW1lOidFcmlrYScsIGFnZToyNywgZ2VuZGVyOidnaXJsJ30sCiAgIHtuYW1lOidQYXRyaWNrJywgYWdlOjQwLCBnZW5kZXI6J2JveSd9LAogICB7bmFtZTonU2FtYW50aGEnLCBhZ2U6NjAsIGdlbmRlcjonZ2lybCd9CiAgIF0iPgogICBJIGhhdmUge3tmcmllbmRzLmxlbmd0aH19IGZyaWVuZHMuIFRoZXkgYXJlOgogICA8aW5wdXQgdHlwZT0ic2VhcmNoIiBuZy1tb2RlbD0icSIgcGxhY2Vob2xkZXI9ImZpbHRlciBmcmllbmRzLi4uIiAvPgogICA8dWwgY2xhc3M9ImV4YW1wbGUtYW5pbWF0ZS1jb250YWluZXIiPgogICA8bGkgY2xhc3M9ImFuaW1hdGUtcmVwZWF0IiBuZy1yZXBlYXQ9ImZyaWVuZCBpbiBmcmllbmRzIHwgZmlsdGVyOnEiPgogICBbe3skaW5kZXggKyAxfX1dIHt7ZnJpZW5kLm5hbWV9fSB3aG8gaXMge3tmcmllbmQuYWdlfX0geWVhcnMgb2xkLgogICA8L2xpPgogICA8L3VsPgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgIC5leGFtcGxlLWFuaW1hdGUtY29udGFpbmVyIHsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgbGlzdC1zdHlsZTpub25lOwogICAgICAgIG1hcmdpbjowOwogICAgICAgIHBhZGRpbmc6MCAxMHB4OwogICAgICB9CgogICAuYW5pbWF0ZS1yZXBlYXQgewogICAgICAgIGxpbmUtaGVpZ2h0OjQwcHg7CiAgICAgICAgbGlzdC1zdHlsZTpub25lOwogICAgICAgIGJveC1zaXppbmc6Ym9yZGVyLWJveDsKICAgICAgfQoKICAgLmFuaW1hdGUtcmVwZWF0Lm5nLW1vdmUsCiAgIC5hbmltYXRlLXJlcGVhdC5uZy1lbnRlciwKICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWxlYXZlIHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICAgIHRyYW5zaXRpb246YWxsIGxpbmVhciAwLjVzOwogICAgICB9CgogICAuYW5pbWF0ZS1yZXBlYXQubmctbGVhdmUubmctbGVhdmUtYWN0aXZlLAogICAuYW5pbWF0ZS1yZXBlYXQubmctbW92ZSwKICAgLmFuaW1hdGUtcmVwZWF0Lm5nLWVudGVyIHsKICAgICAgICBvcGFjaXR5OjA7CiAgICAgICAgbWF4LWhlaWdodDowOwogICAgICB9CgogICAuYW5pbWF0ZS1yZXBlYXQubmctbGVhdmUsCiAgIC5hbmltYXRlLXJlcGVhdC5uZy1tb3ZlLm5nLW1vdmUtYWN0aXZlLAogICAuYW5pbWF0ZS1yZXBlYXQubmctZW50ZXIubmctZW50ZXItYWN0aXZlIHsKICAgICAgICBvcGFjaXR5OjE7CiAgICAgICAgbWF4LWhlaWdodDo0MHB4OwogICAgICB9CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIHZhciBmcmllbmRzID0gZWxlbWVudC5hbGwoYnkucmVwZWF0ZXIoJ2ZyaWVuZCBpbiBmcmllbmRzJykpOwoKICAgaXQoJ3Nob3VsZCByZW5kZXIgaW5pdGlhbCBkYXRhIHNldCcsIGZ1bmN0aW9uKCkgewogICAgICAgIGV4cGVjdChmcmllbmRzLmNvdW50KCkpLnRvQmUoMTApOwogICAgICAgIGV4cGVjdChmcmllbmRzLmdldCgwKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1sxXSBKb2huIHdobyBpcyAyNSB5ZWFycyBvbGQuJyk7CiAgICAgICAgZXhwZWN0KGZyaWVuZHMuZ2V0KDEpLmdldFRleHQoKSkudG9FcXVhbCgnWzJdIEplc3NpZSB3aG8gaXMgMzAgeWVhcnMgb2xkLicpOwogICAgICAgIGV4cGVjdChmcmllbmRzLmxhc3QoKS5nZXRUZXh0KCkpLnRvRXF1YWwoJ1sxMF0gU2FtYW50aGEgd2hvIGlzIDYwIHllYXJzIG9sZC4nKTsKICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCdmcmllbmRzLmxlbmd0aCcpKS5nZXRUZXh0KCkpCiAgICAgICAgICAgIC50b01hdGNoKCJJIGhhdmUgMTAgZnJpZW5kcy4gVGhleSBhcmU6Iik7CiAgICAgIH0pOwoKICAgaXQoJ3Nob3VsZCB1cGRhdGUgcmVwZWF0ZXIgd2hlbiBmaWx0ZXIgcHJlZGljYXRlIGNoYW5nZXMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGZyaWVuZHMuY291bnQoKSkudG9CZSgxMCk7CgogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdxJykpLnNlbmRLZXlzKCdtYScpOwoKICAgICAgICAgZXhwZWN0KGZyaWVuZHMuY291bnQoKSkudG9CZSgyKTsKICAgICAgICAgZXhwZWN0KGZyaWVuZHMuZ2V0KDApLmdldFRleHQoKSkudG9FcXVhbCgnWzFdIE1hcnkgd2hvIGlzIDI4IHllYXJzIG9sZC4nKTsKICAgICAgICAgZXhwZWN0KGZyaWVuZHMubGFzdCgpLmdldFRleHQoKSkudG9FcXVhbCgnWzJdIFNhbWFudGhhIHdobyBpcyA2MCB5ZWFycyBvbGQuJyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nUmVwZWF0RGlyZWN0aXZlID0gWyckcGFyc2UnLCAnJGFuaW1hdGUnLCBmdW5jdGlvbigkcGFyc2UsICRhbmltYXRlKSB7CiAgICB2YXIgTkdfUkVNT1ZFRCA9ICckJE5HX1JFTU9WRUQnOwogICAgdmFyIG5nUmVwZWF0TWluRXJyID0gbWluRXJyKCduZ1JlcGVhdCcpOwogICAgcmV0dXJuIHsKICAgICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgICBwcmlvcml0eTogMTAwMCwKICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgICQkdGxiOiB0cnVlLAogICAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgY3RybCwgJHRyYW5zY2x1ZGUpewogICAgICAgIHZhciBleHByZXNzaW9uID0gJGF0dHIubmdSZXBlYXQ7CiAgICAgICAgdmFyIG1hdGNoID0gZXhwcmVzc2lvbi5tYXRjaCgvXlxzKihbXHNcU10rPylccytpblxzKyhbXHNcU10rPykoPzpccyt0cmFja1xzK2J5XHMrKFtcc1xTXSs/KSk/XHMqJC8pLAogICAgICAgICAgdHJhY2tCeUV4cCwgdHJhY2tCeUV4cEdldHRlciwgdHJhY2tCeUlkRXhwRm4sIHRyYWNrQnlJZEFycmF5Rm4sIHRyYWNrQnlJZE9iakZuLAogICAgICAgICAgbGhzLCByaHMsIHZhbHVlSWRlbnRpZmllciwga2V5SWRlbnRpZmllciwKICAgICAgICAgIGhhc2hGbkxvY2FscyA9IHskaWQ6IGhhc2hLZXl9OwoKICAgICAgICBpZiAoIW1hdGNoKSB7CiAgICAgICAgICB0aHJvdyBuZ1JlcGVhdE1pbkVycignaWV4cCcsICJFeHBlY3RlZCBleHByZXNzaW9uIGluIGZvcm0gb2YgJ19pdGVtXyBpbiBfY29sbGVjdGlvbl9bIHRyYWNrIGJ5IF9pZF9dJyBidXQgZ290ICd7MH0nLiIsCiAgICAgICAgICAgIGV4cHJlc3Npb24pOwogICAgICAgIH0KCiAgICAgICAgbGhzID0gbWF0Y2hbMV07CiAgICAgICAgcmhzID0gbWF0Y2hbMl07CiAgICAgICAgdHJhY2tCeUV4cCA9IG1hdGNoWzNdOwoKICAgICAgICBpZiAodHJhY2tCeUV4cCkgewogICAgICAgICAgdHJhY2tCeUV4cEdldHRlciA9ICRwYXJzZSh0cmFja0J5RXhwKTsKICAgICAgICAgIHRyYWNrQnlJZEV4cEZuID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgLy8gYXNzaWduIGtleSwgdmFsdWUsIGFuZCAkaW5kZXggdG8gdGhlIGxvY2FscyBzbyB0aGF0IHRoZXkgY2FuIGJlIHVzZWQgaW4gaGFzaCBmdW5jdGlvbnMKICAgICAgICAgICAgaWYgKGtleUlkZW50aWZpZXIpIGhhc2hGbkxvY2Fsc1trZXlJZGVudGlmaWVyXSA9IGtleTsKICAgICAgICAgICAgaGFzaEZuTG9jYWxzW3ZhbHVlSWRlbnRpZmllcl0gPSB2YWx1ZTsKICAgICAgICAgICAgaGFzaEZuTG9jYWxzLiRpbmRleCA9IGluZGV4OwogICAgICAgICAgICByZXR1cm4gdHJhY2tCeUV4cEdldHRlcigkc2NvcGUsIGhhc2hGbkxvY2Fscyk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0cmFja0J5SWRBcnJheUZuID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gaGFzaEtleSh2YWx1ZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdHJhY2tCeUlkT2JqRm4gPSBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBtYXRjaCA9IGxocy5tYXRjaCgvXig/OihbXCRcd10rKXxcKChbXCRcd10rKVxzKixccyooW1wkXHddKylcKSkkLyk7CiAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgdGhyb3cgbmdSZXBlYXRNaW5FcnIoJ2lpZGV4cCcsICInX2l0ZW1fJyBpbiAnX2l0ZW1fIGluIF9jb2xsZWN0aW9uXycgc2hvdWxkIGJlIGFuIGlkZW50aWZpZXIgb3IgJyhfa2V5XywgX3ZhbHVlXyknIGV4cHJlc3Npb24sIGJ1dCBnb3QgJ3swfScuIiwKICAgICAgICAgICAgbGhzKTsKICAgICAgICB9CiAgICAgICAgdmFsdWVJZGVudGlmaWVyID0gbWF0Y2hbM10gfHwgbWF0Y2hbMV07CiAgICAgICAga2V5SWRlbnRpZmllciA9IG1hdGNoWzJdOwoKICAgICAgICAvLyBTdG9yZSBhIGxpc3Qgb2YgZWxlbWVudHMgZnJvbSBwcmV2aW91cyBydW4uIFRoaXMgaXMgYSBoYXNoIHdoZXJlIGtleSBpcyB0aGUgaXRlbSBmcm9tIHRoZQogICAgICAgIC8vIGl0ZXJhdG9yLCBhbmQgdGhlIHZhbHVlIGlzIG9iamVjdHMgd2l0aCBmb2xsb3dpbmcgcHJvcGVydGllcy4KICAgICAgICAvLyAgIC0gc2NvcGU6IGJvdW5kIHNjb3BlCiAgICAgICAgLy8gICAtIGVsZW1lbnQ6IHByZXZpb3VzIGVsZW1lbnQuCiAgICAgICAgLy8gICAtIGluZGV4OiBwb3NpdGlvbgogICAgICAgIHZhciBsYXN0QmxvY2tNYXAgPSB7fTsKCiAgICAgICAgLy93YXRjaCBwcm9wcwogICAgICAgICRzY29wZS4kd2F0Y2hDb2xsZWN0aW9uKHJocywgZnVuY3Rpb24gbmdSZXBlYXRBY3Rpb24oY29sbGVjdGlvbil7CiAgICAgICAgICB2YXIgaW5kZXgsIGxlbmd0aCwKICAgICAgICAgICAgcHJldmlvdXNOb2RlID0gJGVsZW1lbnRbMF0sICAgICAvLyBjdXJyZW50IHBvc2l0aW9uIG9mIHRoZSBub2RlCiAgICAgICAgICAgIG5leHROb2RlLAogICAgICAgICAgLy8gU2FtZSBhcyBsYXN0QmxvY2tNYXAgYnV0IGl0IGhhcyB0aGUgY3VycmVudCBzdGF0ZS4gSXQgd2lsbCBiZWNvbWUgdGhlCiAgICAgICAgICAvLyBsYXN0QmxvY2tNYXAgb24gdGhlIG5leHQgaXRlcmF0aW9uLgogICAgICAgICAgICBuZXh0QmxvY2tNYXAgPSB7fSwKICAgICAgICAgICAgYXJyYXlMZW5ndGgsCiAgICAgICAgICAgIGNoaWxkU2NvcGUsCiAgICAgICAgICAgIGtleSwgdmFsdWUsIC8vIGtleS92YWx1ZSBvZiBpdGVyYXRpb24KICAgICAgICAgICAgdHJhY2tCeUlkLAogICAgICAgICAgICB0cmFja0J5SWRGbiwKICAgICAgICAgICAgY29sbGVjdGlvbktleXMsCiAgICAgICAgICAgIGJsb2NrLCAgICAgICAvLyBsYXN0IG9iamVjdCBpbmZvcm1hdGlvbiB7c2NvcGUsIGVsZW1lbnQsIGlkfQogICAgICAgICAgICBuZXh0QmxvY2tPcmRlciA9IFtdLAogICAgICAgICAgICBlbGVtZW50c1RvUmVtb3ZlOwoKCiAgICAgICAgICBpZiAoaXNBcnJheUxpa2UoY29sbGVjdGlvbikpIHsKICAgICAgICAgICAgY29sbGVjdGlvbktleXMgPSBjb2xsZWN0aW9uOwogICAgICAgICAgICB0cmFja0J5SWRGbiA9IHRyYWNrQnlJZEV4cEZuIHx8IHRyYWNrQnlJZEFycmF5Rm47CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0cmFja0J5SWRGbiA9IHRyYWNrQnlJZEV4cEZuIHx8IHRyYWNrQnlJZE9iakZuOwogICAgICAgICAgICAvLyBpZiBvYmplY3QsIGV4dHJhY3Qga2V5cywgc29ydCB0aGVtIGFuZCB1c2UgdG8gZGV0ZXJtaW5lIG9yZGVyIG9mIGl0ZXJhdGlvbiBvdmVyIG9iaiBwcm9wcwogICAgICAgICAgICBjb2xsZWN0aW9uS2V5cyA9IFtdOwogICAgICAgICAgICBmb3IgKGtleSBpbiBjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgICAgaWYgKGNvbGxlY3Rpb24uaGFzT3duUHJvcGVydHkoa2V5KSAmJiBrZXkuY2hhckF0KDApICE9ICckJykgewogICAgICAgICAgICAgICAgY29sbGVjdGlvbktleXMucHVzaChrZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb2xsZWN0aW9uS2V5cy5zb3J0KCk7CiAgICAgICAgICB9CgogICAgICAgICAgYXJyYXlMZW5ndGggPSBjb2xsZWN0aW9uS2V5cy5sZW5ndGg7CgogICAgICAgICAgLy8gbG9jYXRlIGV4aXN0aW5nIGl0ZW1zCiAgICAgICAgICBsZW5ndGggPSBuZXh0QmxvY2tPcmRlci5sZW5ndGggPSBjb2xsZWN0aW9uS2V5cy5sZW5ndGg7CiAgICAgICAgICBmb3IoaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICBrZXkgPSAoY29sbGVjdGlvbiA9PT0gY29sbGVjdGlvbktleXMpID8gaW5kZXggOiBjb2xsZWN0aW9uS2V5c1tpbmRleF07CiAgICAgICAgICAgIHZhbHVlID0gY29sbGVjdGlvbltrZXldOwogICAgICAgICAgICB0cmFja0J5SWQgPSB0cmFja0J5SWRGbihrZXksIHZhbHVlLCBpbmRleCk7CiAgICAgICAgICAgIGFzc2VydE5vdEhhc093blByb3BlcnR5KHRyYWNrQnlJZCwgJ2B0cmFjayBieWAgaWQnKTsKICAgICAgICAgICAgaWYobGFzdEJsb2NrTWFwLmhhc093blByb3BlcnR5KHRyYWNrQnlJZCkpIHsKICAgICAgICAgICAgICBibG9jayA9IGxhc3RCbG9ja01hcFt0cmFja0J5SWRdOwogICAgICAgICAgICAgIGRlbGV0ZSBsYXN0QmxvY2tNYXBbdHJhY2tCeUlkXTsKICAgICAgICAgICAgICBuZXh0QmxvY2tNYXBbdHJhY2tCeUlkXSA9IGJsb2NrOwogICAgICAgICAgICAgIG5leHRCbG9ja09yZGVyW2luZGV4XSA9IGJsb2NrOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRCbG9ja01hcC5oYXNPd25Qcm9wZXJ0eSh0cmFja0J5SWQpKSB7CiAgICAgICAgICAgICAgLy8gcmVzdG9yZSBsYXN0QmxvY2tNYXAKICAgICAgICAgICAgICBmb3JFYWNoKG5leHRCbG9ja09yZGVyLCBmdW5jdGlvbihibG9jaykgewogICAgICAgICAgICAgICAgaWYgKGJsb2NrICYmIGJsb2NrLnNjb3BlKSBsYXN0QmxvY2tNYXBbYmxvY2suaWRdID0gYmxvY2s7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhIGR1cGxpY2F0ZSBhbmQgd2UgbmVlZCB0byB0aHJvdyBhbiBlcnJvcgogICAgICAgICAgICAgIHRocm93IG5nUmVwZWF0TWluRXJyKCdkdXBlcycsICJEdXBsaWNhdGVzIGluIGEgcmVwZWF0ZXIgYXJlIG5vdCBhbGxvd2VkLiBVc2UgJ3RyYWNrIGJ5JyBleHByZXNzaW9uIHRvIHNwZWNpZnkgdW5pcXVlIGtleXMuIFJlcGVhdGVyOiB7MH0sIER1cGxpY2F0ZSBrZXk6IHsxfSIsCiAgICAgICAgICAgICAgICBleHByZXNzaW9uLCAgICAgICB0cmFja0J5SWQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIG5ldyBuZXZlciBiZWZvcmUgc2VlbiBibG9jawogICAgICAgICAgICAgIG5leHRCbG9ja09yZGVyW2luZGV4XSA9IHsgaWQ6IHRyYWNrQnlJZCB9OwogICAgICAgICAgICAgIG5leHRCbG9ja01hcFt0cmFja0J5SWRdID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyByZW1vdmUgZXhpc3RpbmcgaXRlbXMKICAgICAgICAgIGZvciAoa2V5IGluIGxhc3RCbG9ja01hcCkgewogICAgICAgICAgICAvLyBsYXN0QmxvY2tNYXAgaXMgb3VyIG93biBvYmplY3Qgc28gd2UgZG9uJ3QgbmVlZCB0byB1c2Ugc3BlY2lhbCBoYXNPd25Qcm9wZXJ0eUZuCiAgICAgICAgICAgIGlmIChsYXN0QmxvY2tNYXAuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgICAgICAgIGJsb2NrID0gbGFzdEJsb2NrTWFwW2tleV07CiAgICAgICAgICAgICAgZWxlbWVudHNUb1JlbW92ZSA9IGdldEJsb2NrRWxlbWVudHMoYmxvY2suY2xvbmUpOwogICAgICAgICAgICAgICRhbmltYXRlLmxlYXZlKGVsZW1lbnRzVG9SZW1vdmUpOwogICAgICAgICAgICAgIGZvckVhY2goZWxlbWVudHNUb1JlbW92ZSwgZnVuY3Rpb24oZWxlbWVudCkgeyBlbGVtZW50W05HX1JFTU9WRURdID0gdHJ1ZTsgfSk7CiAgICAgICAgICAgICAgYmxvY2suc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIHdlIGFyZSBub3QgdXNpbmcgZm9yRWFjaCBmb3IgcGVyZiByZWFzb25zICh0cnlpbmcgdG8gYXZvaWQgI2NhbGwpCiAgICAgICAgICBmb3IgKGluZGV4ID0gMCwgbGVuZ3RoID0gY29sbGVjdGlvbktleXMubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICBrZXkgPSAoY29sbGVjdGlvbiA9PT0gY29sbGVjdGlvbktleXMpID8gaW5kZXggOiBjb2xsZWN0aW9uS2V5c1tpbmRleF07CiAgICAgICAgICAgIHZhbHVlID0gY29sbGVjdGlvbltrZXldOwogICAgICAgICAgICBibG9jayA9IG5leHRCbG9ja09yZGVyW2luZGV4XTsKICAgICAgICAgICAgaWYgKG5leHRCbG9ja09yZGVyW2luZGV4IC0gMV0pIHByZXZpb3VzTm9kZSA9IGdldEJsb2NrRW5kKG5leHRCbG9ja09yZGVyW2luZGV4IC0gMV0pOwoKICAgICAgICAgICAgaWYgKGJsb2NrLnNjb3BlKSB7CiAgICAgICAgICAgICAgLy8gaWYgd2UgaGF2ZSBhbHJlYWR5IHNlZW4gdGhpcyBvYmplY3QsIHRoZW4gd2UgbmVlZCB0byByZXVzZSB0aGUKICAgICAgICAgICAgICAvLyBhc3NvY2lhdGVkIHNjb3BlL2VsZW1lbnQKICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gYmxvY2suc2NvcGU7CgogICAgICAgICAgICAgIG5leHROb2RlID0gcHJldmlvdXNOb2RlOwogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIG5leHROb2RlID0gbmV4dE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgICAgfSB3aGlsZShuZXh0Tm9kZSAmJiBuZXh0Tm9kZVtOR19SRU1PVkVEXSk7CgogICAgICAgICAgICAgIGlmIChnZXRCbG9ja1N0YXJ0KGJsb2NrKSAhPSBuZXh0Tm9kZSkgewogICAgICAgICAgICAgICAgLy8gZXhpc3RpbmcgaXRlbSB3aGljaCBnb3QgbW92ZWQKICAgICAgICAgICAgICAgICRhbmltYXRlLm1vdmUoZ2V0QmxvY2tFbGVtZW50cyhibG9jay5jbG9uZSksIG51bGwsIGpxTGl0ZShwcmV2aW91c05vZGUpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJldmlvdXNOb2RlID0gZ2V0QmxvY2tFbmQoYmxvY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIG5ldyBpdGVtIHdoaWNoIHdlIGRvbid0IGtub3cgYWJvdXQKICAgICAgICAgICAgICBjaGlsZFNjb3BlID0gJHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2hpbGRTY29wZVt2YWx1ZUlkZW50aWZpZXJdID0gdmFsdWU7CiAgICAgICAgICAgIGlmIChrZXlJZGVudGlmaWVyKSBjaGlsZFNjb3BlW2tleUlkZW50aWZpZXJdID0ga2V5OwogICAgICAgICAgICBjaGlsZFNjb3BlLiRpbmRleCA9IGluZGV4OwogICAgICAgICAgICBjaGlsZFNjb3BlLiRmaXJzdCA9IChpbmRleCA9PT0gMCk7CiAgICAgICAgICAgIGNoaWxkU2NvcGUuJGxhc3QgPSAoaW5kZXggPT09IChhcnJheUxlbmd0aCAtIDEpKTsKICAgICAgICAgICAgY2hpbGRTY29wZS4kbWlkZGxlID0gIShjaGlsZFNjb3BlLiRmaXJzdCB8fCBjaGlsZFNjb3BlLiRsYXN0KTsKICAgICAgICAgICAgLy8ganNoaW50IGJpdHdpc2U6IGZhbHNlCiAgICAgICAgICAgIGNoaWxkU2NvcGUuJG9kZCA9ICEoY2hpbGRTY29wZS4kZXZlbiA9IChpbmRleCYxKSA9PT0gMCk7CiAgICAgICAgICAgIC8vIGpzaGludCBiaXR3aXNlOiB0cnVlCgogICAgICAgICAgICBpZiAoIWJsb2NrLnNjb3BlKSB7CiAgICAgICAgICAgICAgJHRyYW5zY2x1ZGUoY2hpbGRTY29wZSwgZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgICAgICAgICAgIGNsb25lW2Nsb25lLmxlbmd0aCsrXSA9IGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJyBlbmQgbmdSZXBlYXQ6ICcgKyBleHByZXNzaW9uICsgJyAnKTsKICAgICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGNsb25lLCBudWxsLCBqcUxpdGUocHJldmlvdXNOb2RlKSk7CiAgICAgICAgICAgICAgICBwcmV2aW91c05vZGUgPSBjbG9uZTsKICAgICAgICAgICAgICAgIGJsb2NrLnNjb3BlID0gY2hpbGRTY29wZTsKICAgICAgICAgICAgICAgIC8vIE5vdGU6IFdlIG9ubHkgbmVlZCB0aGUgZmlyc3QvbGFzdCBub2RlIG9mIHRoZSBjbG9uZWQgbm9kZXMuCiAgICAgICAgICAgICAgICAvLyBIb3dldmVyLCB3ZSBuZWVkIHRvIGtlZXAgdGhlIHJlZmVyZW5jZSB0byB0aGUganFsaXRlIHdyYXBwZXIgYXMgaXQgbWlnaHQgYmUgY2hhbmdlZCBsYXRlcgogICAgICAgICAgICAgICAgLy8gYnkgYSBkaXJlY3RpdmUgd2l0aCB0ZW1wbGF0ZVVybCB3aGVuIGl0cyB0ZW1wbGF0ZSBhcnJpdmVzLgogICAgICAgICAgICAgICAgYmxvY2suY2xvbmUgPSBjbG9uZTsKICAgICAgICAgICAgICAgIG5leHRCbG9ja01hcFtibG9jay5pZF0gPSBibG9jazsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbGFzdEJsb2NrTWFwID0gbmV4dEJsb2NrTWFwOwogICAgICAgIH0pOwogICAgICB9CiAgICB9OwoKICAgIGZ1bmN0aW9uIGdldEJsb2NrU3RhcnQoYmxvY2spIHsKICAgICAgcmV0dXJuIGJsb2NrLmNsb25lWzBdOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldEJsb2NrRW5kKGJsb2NrKSB7CiAgICAgIHJldHVybiBibG9jay5jbG9uZVtibG9jay5jbG9uZS5sZW5ndGggLSAxXTsKICAgIH0KICB9XTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nU2hvdwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGBuZ1Nob3dgIGRpcmVjdGl2ZSBzaG93cyBvciBoaWRlcyB0aGUgZ2l2ZW4gSFRNTCBlbGVtZW50IGJhc2VkIG9uIHRoZSBleHByZXNzaW9uCiAgICogcHJvdmlkZWQgdG8gdGhlIG5nU2hvdyBhdHRyaWJ1dGUuIFRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiBieSByZW1vdmluZyBvciBhZGRpbmcKICAgKiB0aGUgYG5nLWhpZGVgIENTUyBjbGFzcyBvbnRvIHRoZSBlbGVtZW50LiBUaGUgYC5uZy1oaWRlYCBDU1MgY2xhc3MgaXMgcHJlZGVmaW5lZAogICAqIGluIEFuZ3VsYXJKUyBhbmQgc2V0cyB0aGUgZGlzcGxheSBzdHlsZSB0byBub25lICh1c2luZyBhbiAhaW1wb3J0YW50IGZsYWcpLgogICAqIEZvciBDU1AgbW9kZSBwbGVhc2UgYWRkIGBhbmd1bGFyLWNzcC5jc3NgIHRvIHlvdXIgaHRtbCBmaWxlIChzZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NzcCBuZ0NzcH0pLgogICAqCiAgICogYGBgaHRtbAogICAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyB0cnV0aHkgKGVsZW1lbnQgaXMgdmlzaWJsZSkgLS0+CiAgICogPGRpdiBuZy1zaG93PSJteVZhbHVlIj48L2Rpdj4KICAgKgogICAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyBmYWxzeSAoZWxlbWVudCBpcyBoaWRkZW4pIC0tPgogICAqIDxkaXYgbmctc2hvdz0ibXlWYWx1ZSIgY2xhc3M9Im5nLWhpZGUiPjwvZGl2PgogICAqIGBgYAogICAqCiAgICogV2hlbiB0aGUgbmdTaG93IGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGZhbHNlIHRoZW4gdGhlIG5nLWhpZGUgQ1NTIGNsYXNzIGlzIGFkZGVkIHRvIHRoZSBjbGFzcyBhdHRyaWJ1dGUKICAgKiBvbiB0aGUgZWxlbWVudCBjYXVzaW5nIGl0IHRvIGJlY29tZSBoaWRkZW4uIFdoZW4gdHJ1ZSwgdGhlIG5nLWhpZGUgQ1NTIGNsYXNzIGlzIHJlbW92ZWQKICAgKiBmcm9tIHRoZSBlbGVtZW50IGNhdXNpbmcgdGhlIGVsZW1lbnQgbm90IHRvIGFwcGVhciBoaWRkZW4uCiAgICoKICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICAgKiAqKk5vdGU6KiogSGVyZSBpcyBhIGxpc3Qgb2YgdmFsdWVzIHRoYXQgbmdTaG93IHdpbGwgY29uc2lkZXIgYXMgYSBmYWxzeSB2YWx1ZSAoY2FzZSBpbnNlbnNpdGl2ZSk6PGJyIC8+CiAgICogImYiIC8gIjAiIC8gImZhbHNlIiAvICJubyIgLyAibiIgLyAiW10iCiAgICogPC9kaXY+CiAgICoKICAgKiAjIyBXaHkgaXMgIWltcG9ydGFudCB1c2VkPwogICAqCiAgICogWW91IG1heSBiZSB3b25kZXJpbmcgd2h5ICFpbXBvcnRhbnQgaXMgdXNlZCBmb3IgdGhlIC5uZy1oaWRlIENTUyBjbGFzcy4gVGhpcyBpcyBiZWNhdXNlIHRoZSBgLm5nLWhpZGVgIHNlbGVjdG9yCiAgICogY2FuIGJlIGVhc2lseSBvdmVycmlkZGVuIGJ5IGhlYXZpZXIgc2VsZWN0b3JzLiBGb3IgZXhhbXBsZSwgc29tZXRoaW5nIGFzIHNpbXBsZQogICAqIGFzIGNoYW5naW5nIHRoZSBkaXNwbGF5IHN0eWxlIG9uIGEgSFRNTCBsaXN0IGl0ZW0gd291bGQgbWFrZSBoaWRkZW4gZWxlbWVudHMgYXBwZWFyIHZpc2libGUuCiAgICogVGhpcyBhbHNvIGJlY29tZXMgYSBiaWdnZXIgaXNzdWUgd2hlbiBkZWFsaW5nIHdpdGggQ1NTIGZyYW1ld29ya3MuCiAgICoKICAgKiBCeSB1c2luZyAhaW1wb3J0YW50LCB0aGUgc2hvdyBhbmQgaGlkZSBiZWhhdmlvciB3aWxsIHdvcmsgYXMgZXhwZWN0ZWQgZGVzcGl0ZSBhbnkgY2xhc2ggYmV0d2VlbiBDU1Mgc2VsZWN0b3IKICAgKiBzcGVjaWZpY2l0eSAod2hlbiAhaW1wb3J0YW50IGlzbid0IHVzZWQgd2l0aCBhbnkgY29uZmxpY3Rpbmcgc3R5bGVzKS4gSWYgYSBkZXZlbG9wZXIgY2hvb3NlcyB0byBvdmVycmlkZSB0aGUKICAgKiBzdHlsaW5nIHRvIGNoYW5nZSBob3cgdG8gaGlkZSBhbiBlbGVtZW50IHRoZW4gaXQgaXMganVzdCBhIG1hdHRlciBvZiB1c2luZyAhaW1wb3J0YW50IGluIHRoZWlyIG93biBDU1MgY29kZS4KICAgKgogICAqICMjIyBPdmVycmlkaW5nIC5uZy1oaWRlCiAgICoKICAgKiBCeSBkZWZhdWx0LCB0aGUgYC5uZy1oaWRlYCBjbGFzcyB3aWxsIHN0eWxlIHRoZSBlbGVtZW50IHdpdGggYGRpc3BsYXk6bm9uZSFpbXBvcnRhbnRgLiBJZiB5b3Ugd2lzaCB0byBjaGFuZ2UKICAgKiB0aGUgaGlkZSBiZWhhdmlvciB3aXRoIG5nU2hvdy9uZ0hpZGUgdGhlbiB0aGlzIGNhbiBiZSBhY2hpZXZlZCBieSByZXN0YXRpbmcgdGhlIHN0eWxlcyBmb3IgdGhlIGAubmctaGlkZWAKICAgKiBjbGFzcyBpbiBDU1M6CiAgICoKICAgKiBgYGBjc3MKICAgKiAubmctaGlkZSB7CiAqICAgLy90aGlzIGlzIGp1c3QgYW5vdGhlciBmb3JtIG9mIGhpZGluZyBhbiBlbGVtZW50CiAqICAgZGlzcGxheTpibG9jayFpbXBvcnRhbnQ7CiAqICAgcG9zaXRpb246YWJzb2x1dGU7CiAqICAgdG9wOi05OTk5cHg7CiAqICAgbGVmdDotOTk5OXB4OwogKiB9CiAgICogYGBgCiAgICoKICAgKiBCeSBkZWZhdWx0IHlvdSBkb24ndCBuZWVkIHRvIG92ZXJyaWRlIGluIENTUyBhbnl0aGluZyBhbmQgdGhlIGFuaW1hdGlvbnMgd2lsbCB3b3JrIGFyb3VuZCB0aGUgZGlzcGxheSBzdHlsZS4KICAgKgogICAqICMjIEEgbm90ZSBhYm91dCBhbmltYXRpb25zIHdpdGggbmdTaG93CiAgICoKICAgKiBBbmltYXRpb25zIGluIG5nU2hvdy9uZ0hpZGUgd29yayB3aXRoIHRoZSBzaG93IGFuZCBoaWRlIGV2ZW50cyB0aGF0IGFyZSB0cmlnZ2VyZWQgd2hlbiB0aGUgZGlyZWN0aXZlIGV4cHJlc3Npb24KICAgKiBpcyB0cnVlIGFuZCBmYWxzZS4gVGhpcyBzeXN0ZW0gd29ya3MgbGlrZSB0aGUgYW5pbWF0aW9uIHN5c3RlbSBwcmVzZW50IHdpdGggbmdDbGFzcyBleGNlcHQgdGhhdAogICAqIHlvdSBtdXN0IGFsc28gaW5jbHVkZSB0aGUgIWltcG9ydGFudCBmbGFnIHRvIG92ZXJyaWRlIHRoZSBkaXNwbGF5IHByb3BlcnR5CiAgICogc28gdGhhdCB5b3UgY2FuIHBlcmZvcm0gYW4gYW5pbWF0aW9uIHdoZW4gdGhlIGVsZW1lbnQgaXMgaGlkZGVuIGR1cmluZyB0aGUgdGltZSBvZiB0aGUgYW5pbWF0aW9uLgogICAqCiAgICogYGBgY3NzCiAgICogLy8KICAgKiAvL2Egd29ya2luZyBleGFtcGxlIGNhbiBiZSBmb3VuZCBhdCB0aGUgYm90dG9tIG9mIHRoaXMgcGFnZQogICAqIC8vCiAgICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQsIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlIHsKICogICB0cmFuc2l0aW9uOjAuNXMgbGluZWFyIGFsbDsKICogfQogICAqCiAgICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQgeyAuLi4gfQogICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtYWRkLm5nLWhpZGUtYWRkLWFjdGl2ZSB7IC4uLiB9CiAgICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgeyAuLi4gfQogICAqIC5teS1lbGVtZW50Lm5nLWhpZGUtcmVtb3ZlLm5nLWhpZGUtcmVtb3ZlLWFjdGl2ZSB7IC4uLiB9CiAgICogYGBgCiAgICoKICAgKiBLZWVwIGluIG1pbmQgdGhhdCwgYXMgb2YgQW5ndWxhckpTIHZlcnNpb24gMS4yLjE3IChhbmQgMS4zLjAtYmV0YS4xMSksIHRoZXJlIGlzIG5vIG5lZWQgdG8gY2hhbmdlIHRoZSBkaXNwbGF5CiAgICogcHJvcGVydHkgdG8gYmxvY2sgZHVyaW5nIGFuaW1hdGlvbiBzdGF0ZXMtLW5nQW5pbWF0ZSB3aWxsIGhhbmRsZSB0aGUgc3R5bGUgdG9nZ2xpbmcgYXV0b21hdGljYWxseSBmb3IgeW91LgogICAqCiAgICogQGFuaW1hdGlvbnMKICAgKiBhZGRDbGFzczogLm5nLWhpZGUgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ1Nob3cgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSB0cnV0aHkgdmFsdWUgYW5kIHRoZSBqdXN0IGJlZm9yZSBjb250ZW50cyBhcmUgc2V0IHRvIHZpc2libGUKICAgKiByZW1vdmVDbGFzczogLm5nLWhpZGUgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ1Nob3cgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSBub24gdHJ1dGh5IHZhbHVlIGFuZCBqdXN0IGJlZm9yZSB0aGUgY29udGVudHMgYXJlIHNldCB0byBoaWRkZW4KICAgKgogICAqIEBlbGVtZW50IEFOWQogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gbmdTaG93IElmIHRoZSB7QGxpbmsgZ3VpZGUvZXhwcmVzc2lvbiBleHByZXNzaW9ufSBpcyB0cnV0aHkKICAgKiAgICAgdGhlbiB0aGUgZWxlbWVudCBpcyBzaG93biBvciBoaWRkZW4gcmVzcGVjdGl2ZWx5LgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJuZ0FuaW1hdGUiIGRlcHM9ImFuZ3VsYXItYW5pbWF0ZS5qcyIgYW5pbWF0aW9ucz0idHJ1ZSI+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICBDbGljayBtZTogPGlucHV0IHR5cGU9ImNoZWNrYm94IiBuZy1tb2RlbD0iY2hlY2tlZCI+PGJyLz4KICAgPGRpdj4KICAgU2hvdzoKICAgPGRpdiBjbGFzcz0iY2hlY2stZWxlbWVudCBhbmltYXRlLXNob3ciIG5nLXNob3c9ImNoZWNrZWQiPgogICA8c3BhbiBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi10aHVtYnMtdXAiPjwvc3Bhbj4gSSBzaG93IHVwIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICA8L2Rpdj4KICAgPC9kaXY+CiAgIDxkaXY+CiAgIEhpZGU6CiAgIDxkaXYgY2xhc3M9ImNoZWNrLWVsZW1lbnQgYW5pbWF0ZS1zaG93IiBuZy1oaWRlPSJjaGVja2VkIj4KICAgPHNwYW4gY2xhc3M9ImdseXBoaWNvbiBnbHlwaGljb24tdGh1bWJzLWRvd24iPjwvc3Bhbj4gSSBoaWRlIHdoZW4geW91ciBjaGVja2JveCBpcyBjaGVja2VkLgogICA8L2Rpdj4KICAgPC9kaXY+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0iZ2x5cGhpY29ucy5jc3MiPgogICBAaW1wb3J0IHVybCgvL25ldGRuYS5ib290c3RyYXBjZG4uY29tL2Jvb3RzdHJhcC8zLjAuMC9jc3MvYm9vdHN0cmFwLWdseXBoaWNvbnMuY3NzKTsKICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJhbmltYXRpb25zLmNzcyI+CiAgIC5hbmltYXRlLXNob3cgewogICAgICAgIC13ZWJraXQtdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgdHJhbnNpdGlvbjphbGwgbGluZWFyIDAuNXM7CiAgICAgICAgbGluZS1oZWlnaHQ6MjBweDsKICAgICAgICBvcGFjaXR5OjE7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgfQoKICAgLmFuaW1hdGUtc2hvdy5uZy1oaWRlIHsKICAgICAgICBsaW5lLWhlaWdodDowOwogICAgICAgIG9wYWNpdHk6MDsKICAgICAgICBwYWRkaW5nOjAgMTBweDsKICAgICAgfQoKICAgLmNoZWNrLWVsZW1lbnQgewogICAgICAgIHBhZGRpbmc6MTBweDsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGJhY2tncm91bmQ6d2hpdGU7CiAgICAgIH0KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgdmFyIHRodW1ic1VwID0gZWxlbWVudChieS5jc3MoJ3NwYW4uZ2x5cGhpY29uLXRodW1icy11cCcpKTsKICAgdmFyIHRodW1ic0Rvd24gPSBlbGVtZW50KGJ5LmNzcygnc3Bhbi5nbHlwaGljb24tdGh1bWJzLWRvd24nKSk7CgogICBpdCgnc2hvdWxkIGNoZWNrIG5nLXNob3cgLyBuZy1oaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgZXhwZWN0KHRodW1ic1VwLmlzRGlzcGxheWVkKCkpLnRvQmVGYWxzeSgpOwogICAgICAgIGV4cGVjdCh0aHVtYnNEb3duLmlzRGlzcGxheWVkKCkpLnRvQmVUcnV0aHkoKTsKCiAgICAgICAgZWxlbWVudChieS5tb2RlbCgnY2hlY2tlZCcpKS5jbGljaygpOwoKICAgICAgICBleHBlY3QodGh1bWJzVXAuaXNEaXNwbGF5ZWQoKSkudG9CZVRydXRoeSgpOwogICAgICAgIGV4cGVjdCh0aHVtYnNEb3duLmlzRGlzcGxheWVkKCkpLnRvQmVGYWxzeSgpOwogICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nU2hvd0RpcmVjdGl2ZSA9IFsnJGFuaW1hdGUnLCBmdW5jdGlvbigkYW5pbWF0ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgIHNjb3BlLiR3YXRjaChhdHRyLm5nU2hvdywgZnVuY3Rpb24gbmdTaG93V2F0Y2hBY3Rpb24odmFsdWUpewogICAgICAgICRhbmltYXRlW3RvQm9vbGVhbih2YWx1ZSkgPyAncmVtb3ZlQ2xhc3MnIDogJ2FkZENsYXNzJ10oZWxlbWVudCwgJ25nLWhpZGUnKTsKICAgICAgfSk7CiAgICB9OwogIH1dOwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nSGlkZQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGBuZ0hpZGVgIGRpcmVjdGl2ZSBzaG93cyBvciBoaWRlcyB0aGUgZ2l2ZW4gSFRNTCBlbGVtZW50IGJhc2VkIG9uIHRoZSBleHByZXNzaW9uCiAgICogcHJvdmlkZWQgdG8gdGhlIG5nSGlkZSBhdHRyaWJ1dGUuIFRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiBieSByZW1vdmluZyBvciBhZGRpbmcKICAgKiB0aGUgYG5nLWhpZGVgIENTUyBjbGFzcyBvbnRvIHRoZSBlbGVtZW50LiBUaGUgYC5uZy1oaWRlYCBDU1MgY2xhc3MgaXMgcHJlZGVmaW5lZAogICAqIGluIEFuZ3VsYXJKUyBhbmQgc2V0cyB0aGUgZGlzcGxheSBzdHlsZSB0byBub25lICh1c2luZyBhbiAhaW1wb3J0YW50IGZsYWcpLgogICAqIEZvciBDU1AgbW9kZSBwbGVhc2UgYWRkIGBhbmd1bGFyLWNzcC5jc3NgIHRvIHlvdXIgaHRtbCBmaWxlIChzZWUge0BsaW5rIG5nLmRpcmVjdGl2ZTpuZ0NzcCBuZ0NzcH0pLgogICAqCiAgICogYGBgaHRtbAogICAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyB0cnV0aHkgKGVsZW1lbnQgaXMgaGlkZGVuKSAtLT4KICAgKiA8ZGl2IG5nLWhpZGU9Im15VmFsdWUiIGNsYXNzPSJuZy1oaWRlIj48L2Rpdj4KICAgKgogICAqIDwhLS0gd2hlbiAkc2NvcGUubXlWYWx1ZSBpcyBmYWxzeSAoZWxlbWVudCBpcyB2aXNpYmxlKSAtLT4KICAgKiA8ZGl2IG5nLWhpZGU9Im15VmFsdWUiPjwvZGl2PgogICAqIGBgYAogICAqCiAgICogV2hlbiB0aGUgbmdIaWRlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIHRydWUgdGhlbiB0aGUgLm5nLWhpZGUgQ1NTIGNsYXNzIGlzIGFkZGVkIHRvIHRoZSBjbGFzcyBhdHRyaWJ1dGUKICAgKiBvbiB0aGUgZWxlbWVudCBjYXVzaW5nIGl0IHRvIGJlY29tZSBoaWRkZW4uIFdoZW4gZmFsc2UsIHRoZSBuZy1oaWRlIENTUyBjbGFzcyBpcyByZW1vdmVkCiAgICogZnJvbSB0aGUgZWxlbWVudCBjYXVzaW5nIHRoZSBlbGVtZW50IG5vdCB0byBhcHBlYXIgaGlkZGVuLgogICAqCiAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAgICogKipOb3RlOioqIEhlcmUgaXMgYSBsaXN0IG9mIHZhbHVlcyB0aGF0IG5nSGlkZSB3aWxsIGNvbnNpZGVyIGFzIGEgZmFsc3kgdmFsdWUgKGNhc2UgaW5zZW5zaXRpdmUpOjxiciAvPgogICAqICJmIiAvICIwIiAvICJmYWxzZSIgLyAibm8iIC8gIm4iIC8gIltdIgogICAqIDwvZGl2PgogICAqCiAgICogIyMgV2h5IGlzICFpbXBvcnRhbnQgdXNlZD8KICAgKgogICAqIFlvdSBtYXkgYmUgd29uZGVyaW5nIHdoeSAhaW1wb3J0YW50IGlzIHVzZWQgZm9yIHRoZSAubmctaGlkZSBDU1MgY2xhc3MuIFRoaXMgaXMgYmVjYXVzZSB0aGUgYC5uZy1oaWRlYCBzZWxlY3RvcgogICAqIGNhbiBiZSBlYXNpbHkgb3ZlcnJpZGRlbiBieSBoZWF2aWVyIHNlbGVjdG9ycy4gRm9yIGV4YW1wbGUsIHNvbWV0aGluZyBhcyBzaW1wbGUKICAgKiBhcyBjaGFuZ2luZyB0aGUgZGlzcGxheSBzdHlsZSBvbiBhIEhUTUwgbGlzdCBpdGVtIHdvdWxkIG1ha2UgaGlkZGVuIGVsZW1lbnRzIGFwcGVhciB2aXNpYmxlLgogICAqIFRoaXMgYWxzbyBiZWNvbWVzIGEgYmlnZ2VyIGlzc3VlIHdoZW4gZGVhbGluZyB3aXRoIENTUyBmcmFtZXdvcmtzLgogICAqCiAgICogQnkgdXNpbmcgIWltcG9ydGFudCwgdGhlIHNob3cgYW5kIGhpZGUgYmVoYXZpb3Igd2lsbCB3b3JrIGFzIGV4cGVjdGVkIGRlc3BpdGUgYW55IGNsYXNoIGJldHdlZW4gQ1NTIHNlbGVjdG9yCiAgICogc3BlY2lmaWNpdHkgKHdoZW4gIWltcG9ydGFudCBpc24ndCB1c2VkIHdpdGggYW55IGNvbmZsaWN0aW5nIHN0eWxlcykuIElmIGEgZGV2ZWxvcGVyIGNob29zZXMgdG8gb3ZlcnJpZGUgdGhlCiAgICogc3R5bGluZyB0byBjaGFuZ2UgaG93IHRvIGhpZGUgYW4gZWxlbWVudCB0aGVuIGl0IGlzIGp1c3QgYSBtYXR0ZXIgb2YgdXNpbmcgIWltcG9ydGFudCBpbiB0aGVpciBvd24gQ1NTIGNvZGUuCiAgICoKICAgKiAjIyMgT3ZlcnJpZGluZyAubmctaGlkZQogICAqCiAgICogQnkgZGVmYXVsdCwgdGhlIGAubmctaGlkZWAgY2xhc3Mgd2lsbCBzdHlsZSB0aGUgZWxlbWVudCB3aXRoIGBkaXNwbGF5Om5vbmUhaW1wb3J0YW50YC4gSWYgeW91IHdpc2ggdG8gY2hhbmdlCiAgICogdGhlIGhpZGUgYmVoYXZpb3Igd2l0aCBuZ1Nob3cvbmdIaWRlIHRoZW4gdGhpcyBjYW4gYmUgYWNoaWV2ZWQgYnkgcmVzdGF0aW5nIHRoZSBzdHlsZXMgZm9yIHRoZSBgLm5nLWhpZGVgCiAgICogY2xhc3MgaW4gQ1NTOgogICAqCiAgICogYGBgY3NzCiAgICogLm5nLWhpZGUgewogKiAgIC8vdGhpcyBpcyBqdXN0IGFub3RoZXIgZm9ybSBvZiBoaWRpbmcgYW4gZWxlbWVudAogKiAgIGRpc3BsYXk6YmxvY2shaW1wb3J0YW50OwogKiAgIHBvc2l0aW9uOmFic29sdXRlOwogKiAgIHRvcDotOTk5OXB4OwogKiAgIGxlZnQ6LTk5OTlweDsKICogfQogICAqIGBgYAogICAqCiAgICogQnkgZGVmYXVsdCB5b3UgZG9uJ3QgbmVlZCB0byBvdmVycmlkZSBpbiBDU1MgYW55dGhpbmcgYW5kIHRoZSBhbmltYXRpb25zIHdpbGwgd29yayBhcm91bmQgdGhlIGRpc3BsYXkgc3R5bGUuCiAgICoKICAgKiAjIyBBIG5vdGUgYWJvdXQgYW5pbWF0aW9ucyB3aXRoIG5nSGlkZQogICAqCiAgICogQW5pbWF0aW9ucyBpbiBuZ1Nob3cvbmdIaWRlIHdvcmsgd2l0aCB0aGUgc2hvdyBhbmQgaGlkZSBldmVudHMgdGhhdCBhcmUgdHJpZ2dlcmVkIHdoZW4gdGhlIGRpcmVjdGl2ZSBleHByZXNzaW9uCiAgICogaXMgdHJ1ZSBhbmQgZmFsc2UuIFRoaXMgc3lzdGVtIHdvcmtzIGxpa2UgdGhlIGFuaW1hdGlvbiBzeXN0ZW0gcHJlc2VudCB3aXRoIG5nQ2xhc3MsIGV4Y2VwdCB0aGF0IHRoZSBgLm5nLWhpZGVgCiAgICogQ1NTIGNsYXNzIGlzIGFkZGVkIGFuZCByZW1vdmVkIGZvciB5b3UgaW5zdGVhZCBvZiB5b3VyIG93biBDU1MgY2xhc3MuCiAgICoKICAgKiBgYGBjc3MKICAgKiAvLwogICAqIC8vYSB3b3JraW5nIGV4YW1wbGUgY2FuIGJlIGZvdW5kIGF0IHRoZSBib3R0b20gb2YgdGhpcyBwYWdlCiAgICogLy8KICAgKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCwgLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUgewogKiAgIHRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogKiB9CiAgICoKICAgKiAubXktZWxlbWVudC5uZy1oaWRlLWFkZCB7IC4uLiB9CiAgICogLm15LWVsZW1lbnQubmctaGlkZS1hZGQubmctaGlkZS1hZGQtYWN0aXZlIHsgLi4uIH0KICAgKiAubXktZWxlbWVudC5uZy1oaWRlLXJlbW92ZSB7IC4uLiB9CiAgICogLm15LWVsZW1lbnQubmctaGlkZS1yZW1vdmUubmctaGlkZS1yZW1vdmUtYWN0aXZlIHsgLi4uIH0KICAgKiBgYGAKICAgKgogICAqIEtlZXAgaW4gbWluZCB0aGF0LCBhcyBvZiBBbmd1bGFySlMgdmVyc2lvbiAxLjIuMTcgKGFuZCAxLjMuMC1iZXRhLjExKSwgdGhlcmUgaXMgbm8gbmVlZCB0byBjaGFuZ2UgdGhlIGRpc3BsYXkKICAgKiBwcm9wZXJ0eSB0byBibG9jayBkdXJpbmcgYW5pbWF0aW9uIHN0YXRlcy0tbmdBbmltYXRlIHdpbGwgaGFuZGxlIHRoZSBzdHlsZSB0b2dnbGluZyBhdXRvbWF0aWNhbGx5IGZvciB5b3UuCiAgICoKICAgKiBAYW5pbWF0aW9ucwogICAqIHJlbW92ZUNsYXNzOiAubmctaGlkZSAtIGhhcHBlbnMgYWZ0ZXIgdGhlIG5nSGlkZSBleHByZXNzaW9uIGV2YWx1YXRlcyB0byBhIHRydXRoeSB2YWx1ZSBhbmQganVzdCBiZWZvcmUgdGhlIGNvbnRlbnRzIGFyZSBzZXQgdG8gaGlkZGVuCiAgICogYWRkQ2xhc3M6IC5uZy1oaWRlIC0gaGFwcGVucyBhZnRlciB0aGUgbmdIaWRlIGV4cHJlc3Npb24gZXZhbHVhdGVzIHRvIGEgbm9uIHRydXRoeSB2YWx1ZSBhbmQganVzdCBiZWZvcmUgdGhlIGNvbnRlbnRzIGFyZSBzZXQgdG8gdmlzaWJsZQogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBuZ0hpZGUgSWYgdGhlIHtAbGluayBndWlkZS9leHByZXNzaW9uIGV4cHJlc3Npb259IGlzIHRydXRoeSB0aGVuCiAgICogICAgIHRoZSBlbGVtZW50IGlzIHNob3duIG9yIGhpZGRlbiByZXNwZWN0aXZlbHkuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9Im5nQW5pbWF0ZSIgZGVwcz0iYW5ndWxhci1hbmltYXRlLmpzIiBhbmltYXRpb25zPSJ0cnVlIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIENsaWNrIG1lOiA8aW5wdXQgdHlwZT0iY2hlY2tib3giIG5nLW1vZGVsPSJjaGVja2VkIj48YnIvPgogICA8ZGl2PgogICBTaG93OgogICA8ZGl2IGNsYXNzPSJjaGVjay1lbGVtZW50IGFuaW1hdGUtaGlkZSIgbmctc2hvdz0iY2hlY2tlZCI+CiAgIDxzcGFuIGNsYXNzPSJnbHlwaGljb24gZ2x5cGhpY29uLXRodW1icy11cCI+PC9zcGFuPiBJIHNob3cgdXAgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuCiAgIDwvZGl2PgogICA8L2Rpdj4KICAgPGRpdj4KICAgSGlkZToKICAgPGRpdiBjbGFzcz0iY2hlY2stZWxlbWVudCBhbmltYXRlLWhpZGUiIG5nLWhpZGU9ImNoZWNrZWQiPgogICA8c3BhbiBjbGFzcz0iZ2x5cGhpY29uIGdseXBoaWNvbi10aHVtYnMtZG93biI+PC9zcGFuPiBJIGhpZGUgd2hlbiB5b3VyIGNoZWNrYm94IGlzIGNoZWNrZWQuCiAgIDwvZGl2PgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJnbHlwaGljb25zLmNzcyI+CiAgIEBpbXBvcnQgdXJsKC8vbmV0ZG5hLmJvb3RzdHJhcGNkbi5jb20vYm9vdHN0cmFwLzMuMC4wL2Nzcy9ib290c3RyYXAtZ2x5cGhpY29ucy5jc3MpOwogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9ImFuaW1hdGlvbnMuY3NzIj4KICAgLmFuaW1hdGUtaGlkZSB7CiAgICAgICAgLXdlYmtpdC10cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICB0cmFuc2l0aW9uOmFsbCBsaW5lYXIgMC41czsKICAgICAgICBsaW5lLWhlaWdodDoyMHB4OwogICAgICAgIG9wYWNpdHk6MTsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgICAgYm9yZGVyOjFweCBzb2xpZCBibGFjazsKICAgICAgICBiYWNrZ3JvdW5kOndoaXRlOwogICAgICB9CgogICAuYW5pbWF0ZS1oaWRlLm5nLWhpZGUgewogICAgICAgIGxpbmUtaGVpZ2h0OjA7CiAgICAgICAgb3BhY2l0eTowOwogICAgICAgIHBhZGRpbmc6MCAxMHB4OwogICAgICB9CgogICAuY2hlY2stZWxlbWVudCB7CiAgICAgICAgcGFkZGluZzoxMHB4OwogICAgICAgIGJvcmRlcjoxcHggc29saWQgYmxhY2s7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgfQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICB2YXIgdGh1bWJzVXAgPSBlbGVtZW50KGJ5LmNzcygnc3Bhbi5nbHlwaGljb24tdGh1bWJzLXVwJykpOwogICB2YXIgdGh1bWJzRG93biA9IGVsZW1lbnQoYnkuY3NzKCdzcGFuLmdseXBoaWNvbi10aHVtYnMtZG93bicpKTsKCiAgIGl0KCdzaG91bGQgY2hlY2sgbmctc2hvdyAvIG5nLWhpZGUnLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3QodGh1bWJzVXAuaXNEaXNwbGF5ZWQoKSkudG9CZUZhbHN5KCk7CiAgICAgICAgZXhwZWN0KHRodW1ic0Rvd24uaXNEaXNwbGF5ZWQoKSkudG9CZVRydXRoeSgpOwoKICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdjaGVja2VkJykpLmNsaWNrKCk7CgogICAgICAgIGV4cGVjdCh0aHVtYnNVcC5pc0Rpc3BsYXllZCgpKS50b0JlVHJ1dGh5KCk7CiAgICAgICAgZXhwZWN0KHRodW1ic0Rvd24uaXNEaXNwbGF5ZWQoKSkudG9CZUZhbHN5KCk7CiAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KICB2YXIgbmdIaWRlRGlyZWN0aXZlID0gWyckYW5pbWF0ZScsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgc2NvcGUuJHdhdGNoKGF0dHIubmdIaWRlLCBmdW5jdGlvbiBuZ0hpZGVXYXRjaEFjdGlvbih2YWx1ZSl7CiAgICAgICAgJGFuaW1hdGVbdG9Cb29sZWFuKHZhbHVlKSA/ICdhZGRDbGFzcycgOiAncmVtb3ZlQ2xhc3MnXShlbGVtZW50LCAnbmctaGlkZScpOwogICAgICB9KTsKICAgIH07CiAgfV07CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBuZ1N0eWxlCiAgICogQHJlc3RyaWN0IEFDCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgYG5nU3R5bGVgIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNldCBDU1Mgc3R5bGUgb24gYW4gSFRNTCBlbGVtZW50IGNvbmRpdGlvbmFsbHkuCiAgICoKICAgKiBAZWxlbWVudCBBTlkKICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IG5nU3R5bGUKICAgKgogICAqIHtAbGluayBndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHdoaWNoIGV2YWxzIHRvIGFuCiAgICogb2JqZWN0IHdob3NlIGtleXMgYXJlIENTUyBzdHlsZSBuYW1lcyBhbmQgdmFsdWVzIGFyZSBjb3JyZXNwb25kaW5nIHZhbHVlcyBmb3IgdGhvc2UgQ1NTCiAgICoga2V5cy4KICAgKgogICAqIFNpbmNlIHNvbWUgQ1NTIHN0eWxlIG5hbWVzIGFyZSBub3QgdmFsaWQga2V5cyBmb3IgYW4gb2JqZWN0LCB0aGV5IG11c3QgYmUgcXVvdGVkLgogICAqIFNlZSB0aGUgJ2JhY2tncm91bmQtY29sb3InIHN0eWxlIGluIHRoZSBleGFtcGxlIGJlbG93LgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0ic2V0IGNvbG9yIiBuZy1jbGljaz0ibXlTdHlsZT17Y29sb3I6J3JlZCd9Ij4KICAgPGlucHV0IHR5cGU9ImJ1dHRvbiIgdmFsdWU9InNldCBiYWNrZ3JvdW5kIiBuZy1jbGljaz0ibXlTdHlsZT17J2JhY2tncm91bmQtY29sb3InOidibHVlJ30iPgogICA8aW5wdXQgdHlwZT0iYnV0dG9uIiB2YWx1ZT0iY2xlYXIiIG5nLWNsaWNrPSJteVN0eWxlPXt9Ij4KICAgPGJyLz4KICAgPHNwYW4gbmctc3R5bGU9Im15U3R5bGUiPlNhbXBsZSBUZXh0PC9zcGFuPgogICA8cHJlPm15U3R5bGU9e3tteVN0eWxlfX08L3ByZT4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJzdHlsZS5jc3MiPgogICBzcGFuIHsKICAgICAgICAgY29sb3I6IGJsYWNrOwogICAgICAgfQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICB2YXIgY29sb3JTcGFuID0gZWxlbWVudChieS5jc3MoJ3NwYW4nKSk7CgogICBpaXQoJ3Nob3VsZCBjaGVjayBuZy1zdHlsZScsIGZ1bmN0aW9uKCkgewogICAgICAgICBleHBlY3QoY29sb3JTcGFuLmdldENzc1ZhbHVlKCdjb2xvcicpKS50b0JlKCdyZ2JhKDAsIDAsIDAsIDEpJyk7CiAgICAgICAgIGVsZW1lbnQoYnkuY3NzKCdpbnB1dFt2YWx1ZT1cJ3NldCBjb2xvclwnXScpKS5jbGljaygpOwogICAgICAgICBleHBlY3QoY29sb3JTcGFuLmdldENzc1ZhbHVlKCdjb2xvcicpKS50b0JlKCdyZ2JhKDI1NSwgMCwgMCwgMSknKTsKICAgICAgICAgZWxlbWVudChieS5jc3MoJ2lucHV0W3ZhbHVlPWNsZWFyXScpKS5jbGljaygpOwogICAgICAgICBleHBlY3QoY29sb3JTcGFuLmdldENzc1ZhbHVlKCdjb2xvcicpKS50b0JlKCdyZ2JhKDAsIDAsIDAsIDEpJyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nU3R5bGVEaXJlY3RpdmUgPSBuZ0RpcmVjdGl2ZShmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgc2NvcGUuJHdhdGNoKGF0dHIubmdTdHlsZSwgZnVuY3Rpb24gbmdTdHlsZVdhdGNoQWN0aW9uKG5ld1N0eWxlcywgb2xkU3R5bGVzKSB7CiAgICAgIGlmIChvbGRTdHlsZXMgJiYgKG5ld1N0eWxlcyAhPT0gb2xkU3R5bGVzKSkgewogICAgICAgIGZvckVhY2gob2xkU3R5bGVzLCBmdW5jdGlvbih2YWwsIHN0eWxlKSB7IGVsZW1lbnQuY3NzKHN0eWxlLCAnJyk7fSk7CiAgICAgIH0KICAgICAgaWYgKG5ld1N0eWxlcykgZWxlbWVudC5jc3MobmV3U3R5bGVzKTsKICAgIH0sIHRydWUpOwogIH0pOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgbmdTd2l0Y2gKICAgKiBAcmVzdHJpY3QgRUEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRoZSBgbmdTd2l0Y2hgIGRpcmVjdGl2ZSBpcyB1c2VkIHRvIGNvbmRpdGlvbmFsbHkgc3dhcCBET00gc3RydWN0dXJlIG9uIHlvdXIgdGVtcGxhdGUgYmFzZWQgb24gYSBzY29wZSBleHByZXNzaW9uLgogICAqIEVsZW1lbnRzIHdpdGhpbiBgbmdTd2l0Y2hgIGJ1dCB3aXRob3V0IGBuZ1N3aXRjaFdoZW5gIG9yIGBuZ1N3aXRjaERlZmF1bHRgIGRpcmVjdGl2ZXMgd2lsbCBiZSBwcmVzZXJ2ZWQgYXQgdGhlIGxvY2F0aW9uCiAgICogYXMgc3BlY2lmaWVkIGluIHRoZSB0ZW1wbGF0ZS4KICAgKgogICAqIFRoZSBkaXJlY3RpdmUgaXRzZWxmIHdvcmtzIHNpbWlsYXIgdG8gbmdJbmNsdWRlLCBob3dldmVyLCBpbnN0ZWFkIG9mIGRvd25sb2FkaW5nIHRlbXBsYXRlIGNvZGUgKG9yIGxvYWRpbmcgaXQKICAgKiBmcm9tIHRoZSB0ZW1wbGF0ZSBjYWNoZSksIGBuZ1N3aXRjaGAgc2ltcGx5IGNob29zZXMgb25lIG9mIHRoZSBuZXN0ZWQgZWxlbWVudHMgYW5kIG1ha2VzIGl0IHZpc2libGUgYmFzZWQgb24gd2hpY2ggZWxlbWVudAogICAqIG1hdGNoZXMgdGhlIHZhbHVlIG9idGFpbmVkIGZyb20gdGhlIGV2YWx1YXRlZCBleHByZXNzaW9uLiBJbiBvdGhlciB3b3JkcywgeW91IGRlZmluZSBhIGNvbnRhaW5lciBlbGVtZW50CiAgICogKHdoZXJlIHlvdSBwbGFjZSB0aGUgZGlyZWN0aXZlKSwgcGxhY2UgYW4gZXhwcmVzc2lvbiBvbiB0aGUgKipgb249Ii4uLiJgIGF0dHJpYnV0ZSoqCiAgICogKG9yIHRoZSAqKmBuZy1zd2l0Y2g9Ii4uLiJgIGF0dHJpYnV0ZSoqKSwgZGVmaW5lIGFueSBpbm5lciBlbGVtZW50cyBpbnNpZGUgb2YgdGhlIGRpcmVjdGl2ZSBhbmQgcGxhY2UKICAgKiBhIHdoZW4gYXR0cmlidXRlIHBlciBlbGVtZW50LiBUaGUgd2hlbiBhdHRyaWJ1dGUgaXMgdXNlZCB0byBpbmZvcm0gbmdTd2l0Y2ggd2hpY2ggZWxlbWVudCB0byBkaXNwbGF5IHdoZW4gdGhlIG9uCiAgICogZXhwcmVzc2lvbiBpcyBldmFsdWF0ZWQuIElmIGEgbWF0Y2hpbmcgZXhwcmVzc2lvbiBpcyBub3QgZm91bmQgdmlhIGEgd2hlbiBhdHRyaWJ1dGUgdGhlbiBhbiBlbGVtZW50IHdpdGggdGhlIGRlZmF1bHQKICAgKiBhdHRyaWJ1dGUgaXMgZGlzcGxheWVkLgogICAqCiAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtaW5mbyI+CiAgICogQmUgYXdhcmUgdGhhdCB0aGUgYXR0cmlidXRlIHZhbHVlcyB0byBtYXRjaCBhZ2FpbnN0IGNhbm5vdCBiZSBleHByZXNzaW9ucy4gVGhleSBhcmUgaW50ZXJwcmV0ZWQKICAgKiBhcyBsaXRlcmFsIHN0cmluZyB2YWx1ZXMgdG8gbWF0Y2ggYWdhaW5zdC4KICAgKiBGb3IgZXhhbXBsZSwgKipgbmctc3dpdGNoLXdoZW49InNvbWVWYWwiYCoqIHdpbGwgbWF0Y2ggYWdhaW5zdCB0aGUgc3RyaW5nIGAic29tZVZhbCJgIG5vdCBhZ2FpbnN0IHRoZQogICAqIHZhbHVlIG9mIHRoZSBleHByZXNzaW9uIGAkc2NvcGUuc29tZVZhbGAuCiAgICogPC9kaXY+CgogICAqIEBhbmltYXRpb25zCiAgICogZW50ZXIgLSBoYXBwZW5zIGFmdGVyIHRoZSBuZ1N3aXRjaCBjb250ZW50cyBjaGFuZ2UgYW5kIHRoZSBtYXRjaGVkIGNoaWxkIGVsZW1lbnQgaXMgcGxhY2VkIGluc2lkZSB0aGUgY29udGFpbmVyCiAgICogbGVhdmUgLSBoYXBwZW5zIGp1c3QgYWZ0ZXIgdGhlIG5nU3dpdGNoIGNvbnRlbnRzIGNoYW5nZSBhbmQganVzdCBiZWZvcmUgdGhlIGZvcm1lciBjb250ZW50cyBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBET00KICAgKgogICAqIEB1c2FnZQogICAqCiAgICogYGBgCiAgICogPEFOWSBuZy1zd2l0Y2g9ImV4cHJlc3Npb24iPgogICAqICAgPEFOWSBuZy1zd2l0Y2gtd2hlbj0ibWF0Y2hWYWx1ZTEiPi4uLjwvQU5ZPgogICAqICAgPEFOWSBuZy1zd2l0Y2gtd2hlbj0ibWF0Y2hWYWx1ZTIiPi4uLjwvQU5ZPgogICAqICAgPEFOWSBuZy1zd2l0Y2gtZGVmYXVsdD4uLi48L0FOWT4KICAgKiA8L0FOWT4KICAgKiBgYGAKICAgKgogICAqCiAgICogQHNjb3BlCiAgICogQHByaW9yaXR5IDgwMAogICAqIEBwYXJhbSB7Kn0gbmdTd2l0Y2h8b24gZXhwcmVzc2lvbiB0byBtYXRjaCBhZ2FpbnN0IDx0dD5uZy1zd2l0Y2gtd2hlbjwvdHQ+LgogICAqIE9uIGNoaWxkIGVsZW1lbnRzIGFkZDoKICAgKgogICAqICogYG5nU3dpdGNoV2hlbmA6IHRoZSBjYXNlIHN0YXRlbWVudCB0byBtYXRjaCBhZ2FpbnN0LiBJZiBtYXRjaCB0aGVuIHRoaXMKICAgKiAgIGNhc2Ugd2lsbCBiZSBkaXNwbGF5ZWQuIElmIHRoZSBzYW1lIG1hdGNoIGFwcGVhcnMgbXVsdGlwbGUgdGltZXMsIGFsbCB0aGUKICAgKiAgIGVsZW1lbnRzIHdpbGwgYmUgZGlzcGxheWVkLgogICAqICogYG5nU3dpdGNoRGVmYXVsdGA6IHRoZSBkZWZhdWx0IGNhc2Ugd2hlbiBubyBvdGhlciBjYXNlIG1hdGNoLiBJZiB0aGVyZQogICAqICAgYXJlIG11bHRpcGxlIGRlZmF1bHQgY2FzZXMsIGFsbCBvZiB0aGVtIHdpbGwgYmUgZGlzcGxheWVkIHdoZW4gbm8gb3RoZXIKICAgKiAgIGNhc2UgbWF0Y2guCiAgICoKICAgKgogICAqIEBleGFtcGxlCiAgIDxleGFtcGxlIG1vZHVsZT0ibmdBbmltYXRlIiBkZXBzPSJhbmd1bGFyLWFuaW1hdGUuanMiIGFuaW1hdGlvbnM9InRydWUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgPHNlbGVjdCBuZy1tb2RlbD0ic2VsZWN0aW9uIiBuZy1vcHRpb25zPSJpdGVtIGZvciBpdGVtIGluIGl0ZW1zIj4KICAgPC9zZWxlY3Q+CiAgIDx0dD5zZWxlY3Rpb249e3tzZWxlY3Rpb259fTwvdHQ+CiAgIDxoci8+CiAgIDxkaXYgY2xhc3M9ImFuaW1hdGUtc3dpdGNoLWNvbnRhaW5lciIKICAgbmctc3dpdGNoIG9uPSJzZWxlY3Rpb24iPgogICA8ZGl2IGNsYXNzPSJhbmltYXRlLXN3aXRjaCIgbmctc3dpdGNoLXdoZW49InNldHRpbmdzIj5TZXR0aW5ncyBEaXY8L2Rpdj4KICAgPGRpdiBjbGFzcz0iYW5pbWF0ZS1zd2l0Y2giIG5nLXN3aXRjaC13aGVuPSJob21lIj5Ib21lIFNwYW48L2Rpdj4KICAgPGRpdiBjbGFzcz0iYW5pbWF0ZS1zd2l0Y2giIG5nLXN3aXRjaC1kZWZhdWx0PmRlZmF1bHQ8L2Rpdj4KICAgPC9kaXY+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InNjcmlwdC5qcyI+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgJHNjb3BlLml0ZW1zID0gWydzZXR0aW5ncycsICdob21lJywgJ290aGVyJ107CiAgICAgICAgJHNjb3BlLnNlbGVjdGlvbiA9ICRzY29wZS5pdGVtc1swXTsKICAgICAgfQogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9ImFuaW1hdGlvbnMuY3NzIj4KICAgLmFuaW1hdGUtc3dpdGNoLWNvbnRhaW5lciB7CiAgICAgICAgcG9zaXRpb246cmVsYXRpdmU7CiAgICAgICAgYmFja2dyb3VuZDp3aGl0ZTsKICAgICAgICBib3JkZXI6MXB4IHNvbGlkIGJsYWNrOwogICAgICAgIGhlaWdodDo0MHB4OwogICAgICAgIG92ZXJmbG93OmhpZGRlbjsKICAgICAgfQoKICAgLmFuaW1hdGUtc3dpdGNoIHsKICAgICAgICBwYWRkaW5nOjEwcHg7CiAgICAgIH0KCiAgIC5hbmltYXRlLXN3aXRjaC5uZy1hbmltYXRlIHsKICAgICAgICAtd2Via2l0LXRyYW5zaXRpb246YWxsIGN1YmljLWJlemllcigwLjI1MCwgMC40NjAsIDAuNDUwLCAwLjk0MCkgMC41czsKICAgICAgICB0cmFuc2l0aW9uOmFsbCBjdWJpYy1iZXppZXIoMC4yNTAsIDAuNDYwLCAwLjQ1MCwgMC45NDApIDAuNXM7CgogICAgICAgIHBvc2l0aW9uOmFic29sdXRlOwogICAgICAgIHRvcDowOwogICAgICAgIGxlZnQ6MDsKICAgICAgICByaWdodDowOwogICAgICAgIGJvdHRvbTowOwogICAgICB9CgogICAuYW5pbWF0ZS1zd2l0Y2gubmctbGVhdmUubmctbGVhdmUtYWN0aXZlLAogICAuYW5pbWF0ZS1zd2l0Y2gubmctZW50ZXIgewogICAgICAgIHRvcDotNTBweDsKICAgICAgfQogICAuYW5pbWF0ZS1zd2l0Y2gubmctbGVhdmUsCiAgIC5hbmltYXRlLXN3aXRjaC5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogICAgICAgIHRvcDowOwogICAgICB9CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIHZhciBzd2l0Y2hFbGVtID0gZWxlbWVudChieS5jc3MoJ1tuZy1zd2l0Y2hdJykpOwogICB2YXIgc2VsZWN0ID0gZWxlbWVudChieS5tb2RlbCgnc2VsZWN0aW9uJykpOwoKICAgaXQoJ3Nob3VsZCBzdGFydCBpbiBzZXR0aW5ncycsIGZ1bmN0aW9uKCkgewogICAgICAgIGV4cGVjdChzd2l0Y2hFbGVtLmdldFRleHQoKSkudG9NYXRjaCgvU2V0dGluZ3MgRGl2Lyk7CiAgICAgIH0pOwogICBpdCgnc2hvdWxkIGNoYW5nZSB0byBob21lJywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZWN0LmVsZW1lbnQuYWxsKGJ5LmNzcygnb3B0aW9uJykpLmdldCgxKS5jbGljaygpOwogICAgICAgIGV4cGVjdChzd2l0Y2hFbGVtLmdldFRleHQoKSkudG9NYXRjaCgvSG9tZSBTcGFuLyk7CiAgICAgIH0pOwogICBpdCgnc2hvdWxkIHNlbGVjdCBkZWZhdWx0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZWN0LmVsZW1lbnQuYWxsKGJ5LmNzcygnb3B0aW9uJykpLmdldCgyKS5jbGljaygpOwogICAgICAgIGV4cGVjdChzd2l0Y2hFbGVtLmdldFRleHQoKSkudG9NYXRjaCgvZGVmYXVsdC8pOwogICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIG5nU3dpdGNoRGlyZWN0aXZlID0gWyckYW5pbWF0ZScsIGZ1bmN0aW9uKCRhbmltYXRlKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VBJywKICAgICAgcmVxdWlyZTogJ25nU3dpdGNoJywKCiAgICAgIC8vIGFza3MgZm9yICRzY29wZSB0byBmb29sIHRoZSBCQyBjb250cm9sbGVyIG1vZHVsZQogICAgICBjb250cm9sbGVyOiBbJyRzY29wZScsIGZ1bmN0aW9uIG5nU3dpdGNoQ29udHJvbGxlcigpIHsKICAgICAgICB0aGlzLmNhc2VzID0ge307CiAgICAgIH1dLAogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgbmdTd2l0Y2hDb250cm9sbGVyKSB7CiAgICAgICAgdmFyIHdhdGNoRXhwciA9IGF0dHIubmdTd2l0Y2ggfHwgYXR0ci5vbiwKICAgICAgICAgIHNlbGVjdGVkVHJhbnNjbHVkZXMgPSBbXSwKICAgICAgICAgIHNlbGVjdGVkRWxlbWVudHMgPSBbXSwKICAgICAgICAgIHByZXZpb3VzRWxlbWVudHMgPSBbXSwKICAgICAgICAgIHNlbGVjdGVkU2NvcGVzID0gW107CgogICAgICAgIHNjb3BlLiR3YXRjaCh3YXRjaEV4cHIsIGZ1bmN0aW9uIG5nU3dpdGNoV2F0Y2hBY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHZhciBpLCBpaTsKICAgICAgICAgIGZvciAoaSA9IDAsIGlpID0gcHJldmlvdXNFbGVtZW50cy5sZW5ndGg7IGkgPCBpaTsgKytpKSB7CiAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudHNbaV0ucmVtb3ZlKCk7CiAgICAgICAgICB9CiAgICAgICAgICBwcmV2aW91c0VsZW1lbnRzLmxlbmd0aCA9IDA7CgogICAgICAgICAgZm9yIChpID0gMCwgaWkgPSBzZWxlY3RlZFNjb3Blcy5sZW5ndGg7IGkgPCBpaTsgKytpKSB7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZCA9IHNlbGVjdGVkRWxlbWVudHNbaV07CiAgICAgICAgICAgIHNlbGVjdGVkU2NvcGVzW2ldLiRkZXN0cm95KCk7CiAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudHNbaV0gPSBzZWxlY3RlZDsKICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoc2VsZWN0ZWQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHByZXZpb3VzRWxlbWVudHMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBzZWxlY3RlZEVsZW1lbnRzLmxlbmd0aCA9IDA7CiAgICAgICAgICBzZWxlY3RlZFNjb3Blcy5sZW5ndGggPSAwOwoKICAgICAgICAgIGlmICgoc2VsZWN0ZWRUcmFuc2NsdWRlcyA9IG5nU3dpdGNoQ29udHJvbGxlci5jYXNlc1snIScgKyB2YWx1ZV0gfHwgbmdTd2l0Y2hDb250cm9sbGVyLmNhc2VzWyc/J10pKSB7CiAgICAgICAgICAgIHNjb3BlLiRldmFsKGF0dHIuY2hhbmdlKTsKICAgICAgICAgICAgZm9yRWFjaChzZWxlY3RlZFRyYW5zY2x1ZGVzLCBmdW5jdGlvbihzZWxlY3RlZFRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgICB2YXIgc2VsZWN0ZWRTY29wZSA9IHNjb3BlLiRuZXcoKTsKICAgICAgICAgICAgICBzZWxlY3RlZFNjb3Blcy5wdXNoKHNlbGVjdGVkU2NvcGUpOwogICAgICAgICAgICAgIHNlbGVjdGVkVHJhbnNjbHVkZS50cmFuc2NsdWRlKHNlbGVjdGVkU2NvcGUsIGZ1bmN0aW9uKGNhc2VFbGVtZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgYW5jaG9yID0gc2VsZWN0ZWRUcmFuc2NsdWRlLmVsZW1lbnQ7CgogICAgICAgICAgICAgICAgc2VsZWN0ZWRFbGVtZW50cy5wdXNoKGNhc2VFbGVtZW50KTsKICAgICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGNhc2VFbGVtZW50LCBhbmNob3IucGFyZW50KCksIGFuY2hvcik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9OwogIH1dOwoKICB2YXIgbmdTd2l0Y2hXaGVuRGlyZWN0aXZlID0gbmdEaXJlY3RpdmUoewogICAgdHJhbnNjbHVkZTogJ2VsZW1lbnQnLAogICAgcHJpb3JpdHk6IDgwMCwKICAgIHJlcXVpcmU6ICdebmdTd2l0Y2gnLAogICAgbGluazogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzLCBjdHJsLCAkdHJhbnNjbHVkZSkgewogICAgICBjdHJsLmNhc2VzWychJyArIGF0dHJzLm5nU3dpdGNoV2hlbl0gPSAoY3RybC5jYXNlc1snIScgKyBhdHRycy5uZ1N3aXRjaFdoZW5dIHx8IFtdKTsKICAgICAgY3RybC5jYXNlc1snIScgKyBhdHRycy5uZ1N3aXRjaFdoZW5dLnB1c2goeyB0cmFuc2NsdWRlOiAkdHJhbnNjbHVkZSwgZWxlbWVudDogZWxlbWVudCB9KTsKICAgIH0KICB9KTsKCiAgdmFyIG5nU3dpdGNoRGVmYXVsdERpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgIHByaW9yaXR5OiA4MDAsCiAgICByZXF1aXJlOiAnXm5nU3dpdGNoJywKICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjdHJsLCAkdHJhbnNjbHVkZSkgewogICAgICBjdHJsLmNhc2VzWyc/J10gPSAoY3RybC5jYXNlc1snPyddIHx8IFtdKTsKICAgICAgY3RybC5jYXNlc1snPyddLnB1c2goeyB0cmFuc2NsdWRlOiAkdHJhbnNjbHVkZSwgZWxlbWVudDogZWxlbWVudCB9KTsKICAgIH0KICB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5nVHJhbnNjbHVkZQogICAqIEByZXN0cmljdCBBQwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGlyZWN0aXZlIHRoYXQgbWFya3MgdGhlIGluc2VydGlvbiBwb2ludCBmb3IgdGhlIHRyYW5zY2x1ZGVkIERPTSBvZiB0aGUgbmVhcmVzdCBwYXJlbnQgZGlyZWN0aXZlIHRoYXQgdXNlcyB0cmFuc2NsdXNpb24uCiAgICoKICAgKiBBbnkgZXhpc3RpbmcgY29udGVudCBvZiB0aGUgZWxlbWVudCB0aGF0IHRoaXMgZGlyZWN0aXZlIGlzIHBsYWNlZCBvbiB3aWxsIGJlIHJlbW92ZWQgYmVmb3JlIHRoZSB0cmFuc2NsdWRlZCBjb250ZW50IGlzIGluc2VydGVkLgogICAqCiAgICogQGVsZW1lbnQgQU5ZCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9InRyYW5zY2x1ZGUiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUpIHsKICAgICAgICAgICAkc2NvcGUudGl0bGUgPSAnTG9yZW0gSXBzdW0nOwogICAgICAgICAgICRzY29wZS50ZXh0ID0gJ05lcXVlIHBvcnJvIHF1aXNxdWFtIGVzdCBxdWkgZG9sb3JlbSBpcHN1bSBxdWlhIGRvbG9yLi4uJzsKICAgICAgICAgfQoKICAgYW5ndWxhci5tb2R1bGUoJ3RyYW5zY2x1ZGUnLCBbXSkKICAgLmRpcmVjdGl2ZSgncGFuZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgICAgICAgICBzY29wZTogeyB0aXRsZTonQCcgfSwKICAgdGVtcGxhdGU6ICc8ZGl2IHN0eWxlPSJib3JkZXI6IDFweCBzb2xpZCBibGFjazsiPicgKwogICAnPGRpdiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogZ3JheSI+e3t0aXRsZX19PC9kaXY+JyArCiAgICc8ZGl2IG5nLXRyYW5zY2x1ZGU+PC9kaXY+JyArCiAgICc8L2Rpdj4nCiAgIH07CiAgIH0pOwogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJDdHJsIj4KICAgPGlucHV0IG5nLW1vZGVsPSJ0aXRsZSI+PGJyPgogICA8dGV4dGFyZWEgbmctbW9kZWw9InRleHQiPjwvdGV4dGFyZWE+IDxici8+CiAgIDxwYW5lIHRpdGxlPSJ7e3RpdGxlfX0iPnt7dGV4dH19PC9wYW5lPgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBoYXZlIHRyYW5zY2x1ZGVkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgdGl0bGVFbGVtZW50ID0gZWxlbWVudChieS5tb2RlbCgndGl0bGUnKSk7CiAgICAgICAgICB0aXRsZUVsZW1lbnQuY2xlYXIoKTsKICAgICAgICAgIHRpdGxlRWxlbWVudC5zZW5kS2V5cygnVElUTEUnKTsKICAgICAgICAgIHZhciB0ZXh0RWxlbWVudCA9IGVsZW1lbnQoYnkubW9kZWwoJ3RleHQnKSk7CiAgICAgICAgICB0ZXh0RWxlbWVudC5jbGVhcigpOwogICAgICAgICAgdGV4dEVsZW1lbnQuc2VuZEtleXMoJ1RFWFQnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3RpdGxlJykpLmdldFRleHQoKSkudG9FcXVhbCgnVElUTEUnKTsKICAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmJpbmRpbmcoJ3RleHQnKSkuZ2V0VGV4dCgpKS50b0VxdWFsKCdURVhUJyk7CiAgICAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqCiAgICovCiAgdmFyIG5nVHJhbnNjbHVkZURpcmVjdGl2ZSA9IG5nRGlyZWN0aXZlKHsKICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgY29udHJvbGxlciwgJHRyYW5zY2x1ZGUpIHsKICAgICAgaWYgKCEkdHJhbnNjbHVkZSkgewogICAgICAgIHRocm93IG1pbkVycignbmdUcmFuc2NsdWRlJykoJ29ycGhhbicsCiAgICAgICAgICAgICdJbGxlZ2FsIHVzZSBvZiBuZ1RyYW5zY2x1ZGUgZGlyZWN0aXZlIGluIHRoZSB0ZW1wbGF0ZSEgJyArCiAgICAgICAgICAgICdObyBwYXJlbnQgZGlyZWN0aXZlIHRoYXQgcmVxdWlyZXMgYSB0cmFuc2NsdXNpb24gZm91bmQuICcgKwogICAgICAgICAgICAnRWxlbWVudDogezB9JywKICAgICAgICAgIHN0YXJ0aW5nVGFnKCRlbGVtZW50KSk7CiAgICAgIH0KCiAgICAgICR0cmFuc2NsdWRlKGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgJGVsZW1lbnQuZW1wdHkoKTsKICAgICAgICAkZWxlbWVudC5hcHBlbmQoY2xvbmUpOwogICAgICB9KTsKICAgIH0KICB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIHNjcmlwdAogICAqIEByZXN0cmljdCBFCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBMb2FkIHRoZSBjb250ZW50IG9mIGEgYDxzY3JpcHQ+YCBlbGVtZW50IGludG8ge0BsaW5rIG5nLiR0ZW1wbGF0ZUNhY2hlIGAkdGVtcGxhdGVDYWNoZWB9LCBzbyB0aGF0IHRoZQogICAqIHRlbXBsYXRlIGNhbiBiZSB1c2VkIGJ5IHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlIGBuZ0luY2x1ZGVgfSwKICAgKiB7QGxpbmsgbmdSb3V0ZS5kaXJlY3RpdmU6bmdWaWV3IGBuZ1ZpZXdgfSwgb3Ige0BsaW5rIGd1aWRlL2RpcmVjdGl2ZSBkaXJlY3RpdmVzfS4gVGhlIHR5cGUgb2YgdGhlCiAgICogYDxzY3JpcHQ+YCBlbGVtZW50IG11c3QgYmUgc3BlY2lmaWVkIGFzIGB0ZXh0L25nLXRlbXBsYXRlYCwgYW5kIGEgY2FjaGUgbmFtZSBmb3IgdGhlIHRlbXBsYXRlIG11c3QgYmUKICAgKiBhc3NpZ25lZCB0aHJvdWdoIHRoZSBlbGVtZW50J3MgYGlkYCwgd2hpY2ggY2FuIHRoZW4gYmUgdXNlZCBhcyBhIGRpcmVjdGl2ZSdzIGB0ZW1wbGF0ZVVybGAuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSBNdXN0IGJlIHNldCB0byBgJ3RleHQvbmctdGVtcGxhdGUnYC4KICAgKiBAcGFyYW0ge3N0cmluZ30gaWQgQ2FjaGUgbmFtZSBvZiB0aGUgdGVtcGxhdGUuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZT4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSIgaWQ9Ii90cGwuaHRtbCI+CiAgIENvbnRlbnQgb2YgdGhlIHRlbXBsYXRlLgogICA8L3NjcmlwdD4KCiAgIDxhIG5nLWNsaWNrPSJjdXJyZW50VHBsPScvdHBsLmh0bWwnIiBpZD0idHBsLWxpbmsiPkxvYWQgaW5saW5lZCB0ZW1wbGF0ZTwvYT4KICAgPGRpdiBpZD0idHBsLWNvbnRlbnQiIG5nLWluY2x1ZGUgc3JjPSJjdXJyZW50VHBsIj48L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBsb2FkIHRlbXBsYXRlIGRlZmluZWQgaW5zaWRlIHNjcmlwdCB0YWcnLCBmdW5jdGlvbigpIHsKICAgICAgICBlbGVtZW50KGJ5LmNzcygnI3RwbC1saW5rJykpLmNsaWNrKCk7CiAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjdHBsLWNvbnRlbnQnKSkuZ2V0VGV4dCgpKS50b01hdGNoKC9Db250ZW50IG9mIHRoZSB0ZW1wbGF0ZS8pOwogICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgdmFyIHNjcmlwdERpcmVjdGl2ZSA9IFsnJHRlbXBsYXRlQ2FjaGUnLCBmdW5jdGlvbigkdGVtcGxhdGVDYWNoZSkgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICBpZiAoYXR0ci50eXBlID09ICd0ZXh0L25nLXRlbXBsYXRlJykgewogICAgICAgICAgdmFyIHRlbXBsYXRlVXJsID0gYXR0ci5pZCwKICAgICAgICAgIC8vIElFIGlzIG5vdCBjb25zaXN0ZW50LCBpbiBzY3JpcHRzIHdlIGhhdmUgdG8gcmVhZCAudGV4dCBidXQgaW4gb3RoZXIgbm9kZXMgd2UgaGF2ZSB0byByZWFkIC50ZXh0Q29udGVudAogICAgICAgICAgICB0ZXh0ID0gZWxlbWVudFswXS50ZXh0OwoKICAgICAgICAgICR0ZW1wbGF0ZUNhY2hlLnB1dCh0ZW1wbGF0ZVVybCwgdGV4dCk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH1dOwoKICB2YXIgbmdPcHRpb25zTWluRXJyID0gbWluRXJyKCduZ09wdGlvbnMnKTsKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgc2VsZWN0CiAgICogQHJlc3RyaWN0IEUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEhUTUwgYFNFTEVDVGAgZWxlbWVudCB3aXRoIGFuZ3VsYXIgZGF0YS1iaW5kaW5nLgogICAqCiAgICogIyBgbmdPcHRpb25zYAogICAqCiAgICogVGhlIGBuZ09wdGlvbnNgIGF0dHJpYnV0ZSBjYW4gYmUgdXNlZCB0byBkeW5hbWljYWxseSBnZW5lcmF0ZSBhIGxpc3Qgb2YgYDxvcHRpb24+YAogICAqIGVsZW1lbnRzIGZvciB0aGUgYDxzZWxlY3Q+YCBlbGVtZW50IHVzaW5nIHRoZSBhcnJheSBvciBvYmplY3Qgb2J0YWluZWQgYnkgZXZhbHVhdGluZyB0aGUKICAgKiBgbmdPcHRpb25zYCBjb21wcmVoZW5zaW9uX2V4cHJlc3Npb24uCiAgICoKICAgKiBXaGVuIGFuIGl0ZW0gaW4gdGhlIGA8c2VsZWN0PmAgbWVudSBpcyBzZWxlY3RlZCwgdGhlIGFycmF5IGVsZW1lbnQgb3Igb2JqZWN0IHByb3BlcnR5CiAgICogcmVwcmVzZW50ZWQgYnkgdGhlIHNlbGVjdGVkIG9wdGlvbiB3aWxsIGJlIGJvdW5kIHRvIHRoZSBtb2RlbCBpZGVudGlmaWVkIGJ5IHRoZSBgbmdNb2RlbGAKICAgKiBkaXJlY3RpdmUuCiAgICoKICAgKiA8ZGl2IGNsYXNzPSJhbGVydCBhbGVydC13YXJuaW5nIj4KICAgKiAqKk5vdGU6KiogYG5nTW9kZWxgIGNvbXBhcmVzIGJ5IHJlZmVyZW5jZSwgbm90IHZhbHVlLiBUaGlzIGlzIGltcG9ydGFudCB3aGVuIGJpbmRpbmcgdG8gYW4KICAgKiBhcnJheSBvZiBvYmplY3RzLiBTZWUgYW4gZXhhbXBsZSBbaW4gdGhpcyBqc2ZpZGRsZV0oaHR0cDovL2pzZmlkZGxlLm5ldC9xV3pUYi8pLgogICAqIDwvZGl2PgogICAqCiAgICogT3B0aW9uYWxseSwgYSBzaW5nbGUgaGFyZC1jb2RlZCBgPG9wdGlvbj5gIGVsZW1lbnQsIHdpdGggdGhlIHZhbHVlIHNldCB0byBhbiBlbXB0eSBzdHJpbmcsIGNhbgogICAqIGJlIG5lc3RlZCBpbnRvIHRoZSBgPHNlbGVjdD5gIGVsZW1lbnQuIFRoaXMgZWxlbWVudCB3aWxsIHRoZW4gcmVwcmVzZW50IHRoZSBgbnVsbGAgb3IgIm5vdCBzZWxlY3RlZCIKICAgKiBvcHRpb24uIFNlZSBleGFtcGxlIGJlbG93IGZvciBkZW1vbnN0cmF0aW9uLgogICAqCiAgICogPGRpdiBjbGFzcz0iYWxlcnQgYWxlcnQtd2FybmluZyI+CiAgICogKipOb3RlOioqIGBuZ09wdGlvbnNgIHByb3ZpZGVzIGFuIGl0ZXJhdG9yIGZhY2lsaXR5IGZvciB0aGUgYDxvcHRpb24+YCBlbGVtZW50IHdoaWNoIHNob3VsZCBiZSB1c2VkIGluc3RlYWQKICAgKiBvZiB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nUmVwZWF0IG5nUmVwZWF0fSB3aGVuIHlvdSB3YW50IHRoZQogICAqIGBzZWxlY3RgIG1vZGVsIHRvIGJlIGJvdW5kIHRvIGEgbm9uLXN0cmluZyB2YWx1ZS4gVGhpcyBpcyBiZWNhdXNlIGFuIG9wdGlvbiBlbGVtZW50IGNhbiBvbmx5CiAgICogYmUgYm91bmQgdG8gc3RyaW5nIHZhbHVlcyBhdCBwcmVzZW50LgogICAqIDwvZGl2PgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IG5nTW9kZWwgQXNzaWduYWJsZSBhbmd1bGFyIGV4cHJlc3Npb24gdG8gZGF0YS1iaW5kIHRvLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmFtZSBQcm9wZXJ0eSBuYW1lIG9mIHRoZSBmb3JtIHVuZGVyIHdoaWNoIHRoZSBjb250cm9sIGlzIHB1Ymxpc2hlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IHJlcXVpcmVkIFRoZSBjb250cm9sIGlzIGNvbnNpZGVyZWQgdmFsaWQgb25seSBpZiB2YWx1ZSBpcyBlbnRlcmVkLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gbmdSZXF1aXJlZCBBZGRzIGByZXF1aXJlZGAgYXR0cmlidXRlIGFuZCBgcmVxdWlyZWRgIHZhbGlkYXRpb24gY29uc3RyYWludCB0bwogICAqICAgIHRoZSBlbGVtZW50IHdoZW4gdGhlIG5nUmVxdWlyZWQgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gdHJ1ZS4gVXNlIGBuZ1JlcXVpcmVkYCBpbnN0ZWFkIG9mCiAgICogICAgYHJlcXVpcmVkYCB3aGVuIHlvdSB3YW50IHRvIGRhdGEtYmluZCB0byB0aGUgYHJlcXVpcmVkYCBhdHRyaWJ1dGUuCiAgICogQHBhcmFtIHtjb21wcmVoZW5zaW9uX2V4cHJlc3Npb249fSBuZ09wdGlvbnMgaW4gb25lIG9mIHRoZSBmb2xsb3dpbmcgZm9ybXM6CiAgICoKICAgKiAgICogZm9yIGFycmF5IGRhdGEgc291cmNlczoKICAgKiAgICAgKiBgbGFiZWxgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgKiAgICAgKiBgbGFiZWxgICAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvcmAqKiBgdmFsdWVgICoqYGluYCoqIGBhcnJheWAKICAgKiAgICAgKiBgc2VsZWN0YCAqKmBhc2AqKiBgbGFiZWxgICoqYGdyb3VwIGJ5YCoqIGBncm91cGAgKipgZm9yYCoqIGB2YWx1ZWAgKipgaW5gKiogYGFycmF5YCAqKmB0cmFjayBieWAqKiBgdHJhY2tleHByYAogICAqICAgKiBmb3Igb2JqZWN0IGRhdGEgc291cmNlczoKICAgKiAgICAgKiBgbGFiZWxgICoqYGZvciAoYCoqYGtleWAgKipgLGAqKiBgdmFsdWVgKipgKSBpbmAqKiBgb2JqZWN0YAogICAqICAgICAqIGBzZWxlY3RgICoqYGFzYCoqIGBsYWJlbGAgKipgZm9yIChgKipga2V5YCAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAgICogICAgICogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgICoqYGZvciAoYCoqYGtleWAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAgICogICAgICogYHNlbGVjdGAgKipgYXNgKiogYGxhYmVsYCAqKmBncm91cCBieWAqKiBgZ3JvdXBgCiAgICogICAgICAgICAqKmBmb3JgIGAoYCoqYGtleWAqKmAsYCoqIGB2YWx1ZWAqKmApIGluYCoqIGBvYmplY3RgCiAgICoKICAgKiBXaGVyZToKICAgKgogICAqICAgKiBgYXJyYXlgIC8gYG9iamVjdGA6IGFuIGV4cHJlc3Npb24gd2hpY2ggZXZhbHVhdGVzIHRvIGFuIGFycmF5IC8gb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgKiAgICogYHZhbHVlYDogbG9jYWwgdmFyaWFibGUgd2hpY2ggd2lsbCByZWZlciB0byBlYWNoIGl0ZW0gaW4gdGhlIGBhcnJheWAgb3IgZWFjaCBwcm9wZXJ0eSB2YWx1ZQogICAqICAgICAgb2YgYG9iamVjdGAgZHVyaW5nIGl0ZXJhdGlvbi4KICAgKiAgICogYGtleWA6IGxvY2FsIHZhcmlhYmxlIHdoaWNoIHdpbGwgcmVmZXIgdG8gYSBwcm9wZXJ0eSBuYW1lIGluIGBvYmplY3RgIGR1cmluZyBpdGVyYXRpb24uCiAgICogICAqIGBsYWJlbGA6IFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUgdGhlIGxhYmVsIGZvciBgPG9wdGlvbj5gIGVsZW1lbnQuIFRoZQogICAqICAgICBgZXhwcmVzc2lvbmAgd2lsbCBtb3N0IGxpa2VseSByZWZlciB0byB0aGUgYHZhbHVlYCB2YXJpYWJsZSAoZS5nLiBgdmFsdWUucHJvcGVydHlOYW1lYCkuCiAgICogICAqIGBzZWxlY3RgOiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlIGJvdW5kIHRvIHRoZSBtb2RlbCBvZiB0aGUgcGFyZW50IGA8c2VsZWN0PmAKICAgKiAgICAgIGVsZW1lbnQuIElmIG5vdCBzcGVjaWZpZWQsIGBzZWxlY3RgIGV4cHJlc3Npb24gd2lsbCBkZWZhdWx0IHRvIGB2YWx1ZWAuCiAgICogICAqIGBncm91cGA6IFRoZSByZXN1bHQgb2YgdGhpcyBleHByZXNzaW9uIHdpbGwgYmUgdXNlZCB0byBncm91cCBvcHRpb25zIHVzaW5nIHRoZSBgPG9wdGdyb3VwPmAKICAgKiAgICAgIERPTSBlbGVtZW50LgogICAqICAgKiBgdHJhY2tleHByYDogVXNlZCB3aGVuIHdvcmtpbmcgd2l0aCBhbiBhcnJheSBvZiBvYmplY3RzLiBUaGUgcmVzdWx0IG9mIHRoaXMgZXhwcmVzc2lvbiB3aWxsIGJlCiAgICogICAgICB1c2VkIHRvIGlkZW50aWZ5IHRoZSBvYmplY3RzIGluIHRoZSBhcnJheS4gVGhlIGB0cmFja2V4cHJgIHdpbGwgbW9zdCBsaWtlbHkgcmVmZXIgdG8gdGhlCiAgICogICAgIGB2YWx1ZWAgdmFyaWFibGUgKGUuZy4gYHZhbHVlLnByb3BlcnR5TmFtZWApLgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGU+CiAgIDxmaWxlIG5hbWU9ImluZGV4Lmh0bWwiPgogICA8c2NyaXB0PgogICBmdW5jdGlvbiBNeUNudHJsKCRzY29wZSkgewogICAgICAgICAgJHNjb3BlLmNvbG9ycyA9IFsKICAgICAgICAgICAge25hbWU6J2JsYWNrJywgc2hhZGU6J2RhcmsnfSwKICAgICAgICAgICAge25hbWU6J3doaXRlJywgc2hhZGU6J2xpZ2h0J30sCiAgICAgICAgICAgIHtuYW1lOidyZWQnLCBzaGFkZTonZGFyayd9LAogICAgICAgICAgICB7bmFtZTonYmx1ZScsIHNoYWRlOidkYXJrJ30sCiAgICAgICAgICAgIHtuYW1lOid5ZWxsb3cnLCBzaGFkZTonbGlnaHQnfQogICAgICAgICAgXTsKICAgICAgICAgICRzY29wZS5teUNvbG9yID0gJHNjb3BlLmNvbG9yc1syXTsgLy8gcmVkCiAgICAgICAgfQogICA8L3NjcmlwdD4KICAgPGRpdiBuZy1jb250cm9sbGVyPSJNeUNudHJsIj4KICAgPHVsPgogICA8bGkgbmctcmVwZWF0PSJjb2xvciBpbiBjb2xvcnMiPgogICBOYW1lOiA8aW5wdXQgbmctbW9kZWw9ImNvbG9yLm5hbWUiPgogICBbPGEgaHJlZiBuZy1jbGljaz0iY29sb3JzLnNwbGljZSgkaW5kZXgsIDEpIj5YPC9hPl0KICAgPC9saT4KICAgPGxpPgogICBbPGEgaHJlZiBuZy1jbGljaz0iY29sb3JzLnB1c2goe30pIj5hZGQ8L2E+XQogICA8L2xpPgogICA8L3VsPgogICA8aHIvPgogICBDb2xvciAobnVsbCBub3QgYWxsb3dlZCk6CiAgIDxzZWxlY3QgbmctbW9kZWw9Im15Q29sb3IiIG5nLW9wdGlvbnM9ImNvbG9yLm5hbWUgZm9yIGNvbG9yIGluIGNvbG9ycyI+PC9zZWxlY3Q+PGJyPgoKICAgQ29sb3IgKG51bGwgYWxsb3dlZCk6CiAgIDxzcGFuICBjbGFzcz0ibnVsbGFibGUiPgogICA8c2VsZWN0IG5nLW1vZGVsPSJteUNvbG9yIiBuZy1vcHRpb25zPSJjb2xvci5uYW1lIGZvciBjb2xvciBpbiBjb2xvcnMiPgogICA8b3B0aW9uIHZhbHVlPSIiPi0tIGNob29zZSBjb2xvciAtLTwvb3B0aW9uPgogICA8L3NlbGVjdD4KICAgPC9zcGFuPjxici8+CgogICBDb2xvciBncm91cGVkIGJ5IHNoYWRlOgogICA8c2VsZWN0IG5nLW1vZGVsPSJteUNvbG9yIiBuZy1vcHRpb25zPSJjb2xvci5uYW1lIGdyb3VwIGJ5IGNvbG9yLnNoYWRlIGZvciBjb2xvciBpbiBjb2xvcnMiPgogICA8L3NlbGVjdD48YnIvPgoKCiAgIFNlbGVjdCA8YSBocmVmIG5nLWNsaWNrPSJteUNvbG9yID0geyBuYW1lOidub3QgaW4gbGlzdCcsIHNoYWRlOiAnb3RoZXInIH0iPmJvZ3VzPC9hPi48YnI+CiAgIDxoci8+CiAgIEN1cnJlbnRseSBzZWxlY3RlZDoge3sge3NlbGVjdGVkX2NvbG9yOm15Q29sb3J9ICB9fQogICA8ZGl2IHN0eWxlPSJib3JkZXI6c29saWQgMXB4IGJsYWNrOyBoZWlnaHQ6MjBweCIKICAgbmctc3R5bGU9InsnYmFja2dyb3VuZC1jb2xvcic6bXlDb2xvci5uYW1lfSI+CiAgIDwvZGl2PgogICA8L2Rpdj4KICAgPC9maWxlPgogICA8ZmlsZSBuYW1lPSJwcm90cmFjdG9yLmpzIiB0eXBlPSJwcm90cmFjdG9yIj4KICAgaXQoJ3Nob3VsZCBjaGVjayBuZy1vcHRpb25zJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygne3NlbGVjdGVkX2NvbG9yOm15Q29sb3J9JykpLmdldFRleHQoKSkudG9NYXRjaCgncmVkJyk7CiAgICAgICAgICAgZWxlbWVudC5hbGwoYnkuc2VsZWN0KCdteUNvbG9yJykpLmZpcnN0KCkuY2xpY2soKTsKICAgICAgICAgICBlbGVtZW50LmFsbChieS5jc3MoJ3NlbGVjdFtuZy1tb2RlbD0ibXlDb2xvciJdIG9wdGlvbicpKS5maXJzdCgpLmNsaWNrKCk7CiAgICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuYmluZGluZygne3NlbGVjdGVkX2NvbG9yOm15Q29sb3J9JykpLmdldFRleHQoKSkudG9NYXRjaCgnYmxhY2snKTsKICAgICAgICAgICBlbGVtZW50KGJ5LmNzcygnLm51bGxhYmxlIHNlbGVjdFtuZy1tb2RlbD0ibXlDb2xvciJdJykpLmNsaWNrKCk7CiAgICAgICAgICAgZWxlbWVudC5hbGwoYnkuY3NzKCcubnVsbGFibGUgc2VsZWN0W25nLW1vZGVsPSJteUNvbG9yIl0gb3B0aW9uJykpLmZpcnN0KCkuY2xpY2soKTsKICAgICAgICAgICBleHBlY3QoZWxlbWVudChieS5iaW5kaW5nKCd7c2VsZWN0ZWRfY29sb3I6bXlDb2xvcn0nKSkuZ2V0VGV4dCgpKS50b01hdGNoKCdudWxsJyk7CiAgICAgICAgIH0pOwogICA8L2ZpbGU+CiAgIDwvZXhhbXBsZT4KICAgKi8KCiAgdmFyIG5nT3B0aW9uc0RpcmVjdGl2ZSA9IHZhbHVlRm4oeyB0ZXJtaW5hbDogdHJ1ZSB9KTsKLy8ganNoaW50IG1heGxlbjogZmFsc2UKICB2YXIgc2VsZWN0RGlyZWN0aXZlID0gWyckY29tcGlsZScsICckcGFyc2UnLCBmdW5jdGlvbigkY29tcGlsZSwgICAkcGFyc2UpIHsKICAgIC8vMDAwMDExMTExMTExMTEwMDAwMDAwMDAwMDIyMjIyMjIyMjIwMDAwMDAwMDAwMDAwMDAwMDAwMDAzMzMzMzMzMzMzMDAwMDAwMDAwMDAwMDA0NDQ0NDQ0NDQ0NDQ0NDQwMDAwMDAwMDA1NTU1NTU1NTU1NTU1NTUwMDAwMDAwNjY2NjY2NjY2NjY2NjY2MDAwMDAwMDAwMDAwMDAwNzc3Nzc3Nzc3NzAwMDAwMDAwMDAwMDAwMDAwMDA4ODg4ODg4ODg4CiAgICB2YXIgTkdfT1BUSU9OU19SRUdFWFAgPSAvXlxzKihbXHNcU10rPykoPzpccythc1xzKyhbXHNcU10rPykpPyg/OlxzK2dyb3VwXHMrYnlccysoW1xzXFNdKz8pKT9ccytmb3JccysoPzooW1wkXHddW1wkXHddKil8KD86XChccyooW1wkXHddW1wkXHddKilccyosXHMqKFtcJFx3XVtcJFx3XSopXHMqXCkpKVxzK2luXHMrKFtcc1xTXSs/KSg/OlxzK3RyYWNrXHMrYnlccysoW1xzXFNdKz8pKT8kLywKICAgICAgbnVsbE1vZGVsQ3RybCA9IHskc2V0Vmlld1ZhbHVlOiBub29wfTsKLy8ganNoaW50IG1heGxlbjogMTAwCgogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgcmVxdWlyZTogWydzZWxlY3QnLCAnP25nTW9kZWwnXSwKICAgICAgY29udHJvbGxlcjogWyckZWxlbWVudCcsICckc2NvcGUnLCAnJGF0dHJzJywgZnVuY3Rpb24oJGVsZW1lbnQsICRzY29wZSwgJGF0dHJzKSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgb3B0aW9uc01hcCA9IHt9LAogICAgICAgICAgbmdNb2RlbEN0cmwgPSBudWxsTW9kZWxDdHJsLAogICAgICAgICAgbnVsbE9wdGlvbiwKICAgICAgICAgIHVua25vd25PcHRpb247CgoKICAgICAgICBzZWxmLmRhdGFib3VuZCA9ICRhdHRycy5uZ01vZGVsOwoKCiAgICAgICAgc2VsZi5pbml0ID0gZnVuY3Rpb24obmdNb2RlbEN0cmxfLCBudWxsT3B0aW9uXywgdW5rbm93bk9wdGlvbl8pIHsKICAgICAgICAgIG5nTW9kZWxDdHJsID0gbmdNb2RlbEN0cmxfOwogICAgICAgICAgbnVsbE9wdGlvbiA9IG51bGxPcHRpb25fOwogICAgICAgICAgdW5rbm93bk9wdGlvbiA9IHVua25vd25PcHRpb25fOwogICAgICAgIH07CgoKICAgICAgICBzZWxmLmFkZE9wdGlvbiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBhc3NlcnROb3RIYXNPd25Qcm9wZXJ0eSh2YWx1ZSwgJyJvcHRpb24gdmFsdWUiJyk7CiAgICAgICAgICBvcHRpb25zTWFwW3ZhbHVlXSA9IHRydWU7CgogICAgICAgICAgaWYgKG5nTW9kZWxDdHJsLiR2aWV3VmFsdWUgPT0gdmFsdWUpIHsKICAgICAgICAgICAgJGVsZW1lbnQudmFsKHZhbHVlKTsKICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCgogICAgICAgIHNlbGYucmVtb3ZlT3B0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICh0aGlzLmhhc09wdGlvbih2YWx1ZSkpIHsKICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnNNYXBbdmFsdWVdOwogICAgICAgICAgICBpZiAobmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSA9PSB2YWx1ZSkgewogICAgICAgICAgICAgIHRoaXMucmVuZGVyVW5rbm93bk9wdGlvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwoKCiAgICAgICAgc2VsZi5yZW5kZXJVbmtub3duT3B0aW9uID0gZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICB2YXIgdW5rbm93blZhbCA9ICc/ICcgKyBoYXNoS2V5KHZhbCkgKyAnID8nOwogICAgICAgICAgdW5rbm93bk9wdGlvbi52YWwodW5rbm93blZhbCk7CiAgICAgICAgICAkZWxlbWVudC5wcmVwZW5kKHVua25vd25PcHRpb24pOwogICAgICAgICAgJGVsZW1lbnQudmFsKHVua25vd25WYWwpOwogICAgICAgICAgdW5rbm93bk9wdGlvbi5wcm9wKCdzZWxlY3RlZCcsIHRydWUpOyAvLyBuZWVkZWQgZm9yIElFCiAgICAgICAgfTsKCgogICAgICAgIHNlbGYuaGFzT3B0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiBvcHRpb25zTWFwLmhhc093blByb3BlcnR5KHZhbHVlKTsKICAgICAgICB9OwoKICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gZGlzYWJsZSB1bmtub3duIG9wdGlvbiBzbyB0aGF0IHdlIGRvbid0IGRvIHdvcmsgd2hlbiB0aGUgd2hvbGUgc2VsZWN0IGlzIGJlaW5nIGRlc3Ryb3llZAogICAgICAgICAgc2VsZi5yZW5kZXJVbmtub3duT3B0aW9uID0gbm9vcDsKICAgICAgICB9KTsKICAgICAgfV0sCgogICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0ciwgY3RybHMpIHsKICAgICAgICAvLyBpZiBuZ01vZGVsIGlzIG5vdCBkZWZpbmVkLCB3ZSBkb24ndCBuZWVkIHRvIGRvIGFueXRoaW5nCiAgICAgICAgaWYgKCFjdHJsc1sxXSkgcmV0dXJuOwoKICAgICAgICB2YXIgc2VsZWN0Q3RybCA9IGN0cmxzWzBdLAogICAgICAgICAgbmdNb2RlbEN0cmwgPSBjdHJsc1sxXSwKICAgICAgICAgIG11bHRpcGxlID0gYXR0ci5tdWx0aXBsZSwKICAgICAgICAgIG9wdGlvbnNFeHAgPSBhdHRyLm5nT3B0aW9ucywKICAgICAgICAgIG51bGxPcHRpb24gPSBmYWxzZSwgLy8gaWYgZmFsc2UsIHVzZXIgd2lsbCBub3QgYmUgYWJsZSB0byBzZWxlY3QgaXQgKHVzZWQgYnkgbmdPcHRpb25zKQogICAgICAgICAgZW1wdHlPcHRpb24sCiAgICAgICAgLy8gd2UgY2FuJ3QganVzdCBqcUxpdGUoJzxvcHRpb24+Jykgc2luY2UganFMaXRlIGlzIG5vdCBzbWFydCBlbm91Z2gKICAgICAgICAvLyB0byBjcmVhdGUgaXQgaW4gPHNlbGVjdD4gYW5kIElFIGJhcmZzIG90aGVyd2lzZS4KICAgICAgICAgIG9wdGlvblRlbXBsYXRlID0ganFMaXRlKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpKSwKICAgICAgICAgIG9wdEdyb3VwVGVtcGxhdGUgPWpxTGl0ZShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRncm91cCcpKSwKICAgICAgICAgIHVua25vd25PcHRpb24gPSBvcHRpb25UZW1wbGF0ZS5jbG9uZSgpOwoKICAgICAgICAvLyBmaW5kICJudWxsIiBvcHRpb24KICAgICAgICBmb3IodmFyIGkgPSAwLCBjaGlsZHJlbiA9IGVsZW1lbnQuY2hpbGRyZW4oKSwgaWkgPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBpaTsgaSsrKSB7CiAgICAgICAgICBpZiAoY2hpbGRyZW5baV0udmFsdWUgPT09ICcnKSB7CiAgICAgICAgICAgIGVtcHR5T3B0aW9uID0gbnVsbE9wdGlvbiA9IGNoaWxkcmVuLmVxKGkpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNlbGVjdEN0cmwuaW5pdChuZ01vZGVsQ3RybCwgbnVsbE9wdGlvbiwgdW5rbm93bk9wdGlvbik7CgogICAgICAgIC8vIHJlcXVpcmVkIHZhbGlkYXRvcgogICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgbmdNb2RlbEN0cmwuJGlzRW1wdHkgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gIXZhbHVlIHx8IHZhbHVlLmxlbmd0aCA9PT0gMDsKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBpZiAob3B0aW9uc0V4cCkgc2V0dXBBc09wdGlvbnMoc2NvcGUsIGVsZW1lbnQsIG5nTW9kZWxDdHJsKTsKICAgICAgICBlbHNlIGlmIChtdWx0aXBsZSkgc2V0dXBBc011bHRpcGxlKHNjb3BlLCBlbGVtZW50LCBuZ01vZGVsQ3RybCk7CiAgICAgICAgZWxzZSBzZXR1cEFzU2luZ2xlKHNjb3BlLCBlbGVtZW50LCBuZ01vZGVsQ3RybCwgc2VsZWN0Q3RybCk7CgoKICAgICAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgoKCiAgICAgICAgZnVuY3Rpb24gc2V0dXBBc1NpbmdsZShzY29wZSwgc2VsZWN0RWxlbWVudCwgbmdNb2RlbEN0cmwsIHNlbGVjdEN0cmwpIHsKICAgICAgICAgIG5nTW9kZWxDdHJsLiRyZW5kZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZpZXdWYWx1ZSA9IG5nTW9kZWxDdHJsLiR2aWV3VmFsdWU7CgogICAgICAgICAgICBpZiAoc2VsZWN0Q3RybC5oYXNPcHRpb24odmlld1ZhbHVlKSkgewogICAgICAgICAgICAgIGlmICh1bmtub3duT3B0aW9uLnBhcmVudCgpKSB1bmtub3duT3B0aW9uLnJlbW92ZSgpOwogICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgaWYgKHZpZXdWYWx1ZSA9PT0gJycpIGVtcHR5T3B0aW9uLnByb3AoJ3NlbGVjdGVkJywgdHJ1ZSk7IC8vIHRvIG1ha2UgSUU5IGhhcHB5CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHZpZXdWYWx1ZSkgJiYgZW1wdHlPcHRpb24pIHsKICAgICAgICAgICAgICAgIHNlbGVjdEVsZW1lbnQudmFsKCcnKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW5kZXJVbmtub3duT3B0aW9uKHZpZXdWYWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIHNlbGVjdEVsZW1lbnQub24oJ2NoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKHVua25vd25PcHRpb24ucGFyZW50KCkpIHVua25vd25PcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHNldFZpZXdWYWx1ZShzZWxlY3RFbGVtZW50LnZhbCgpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNldHVwQXNNdWx0aXBsZShzY29wZSwgc2VsZWN0RWxlbWVudCwgY3RybCkgewogICAgICAgICAgdmFyIGxhc3RWaWV3OwogICAgICAgICAgY3RybC4kcmVuZGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBpdGVtcyA9IG5ldyBIYXNoTWFwKGN0cmwuJHZpZXdWYWx1ZSk7CiAgICAgICAgICAgIGZvckVhY2goc2VsZWN0RWxlbWVudC5maW5kKCdvcHRpb24nKSwgZnVuY3Rpb24ob3B0aW9uKSB7CiAgICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gaXNEZWZpbmVkKGl0ZW1zLmdldChvcHRpb24udmFsdWUpKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIHdlIGhhdmUgdG8gZG8gaXQgb24gZWFjaCB3YXRjaCBzaW5jZSBuZ01vZGVsIHdhdGNoZXMgcmVmZXJlbmNlLCBidXQKICAgICAgICAgIC8vIHdlIG5lZWQgdG8gd29yayBvZiBhbiBhcnJheSwgc28gd2UgbmVlZCB0byBzZWUgaWYgYW55dGhpbmcgd2FzIGluc2VydGVkL3JlbW92ZWQKICAgICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbiBzZWxlY3RNdWx0aXBsZVdhdGNoKCkgewogICAgICAgICAgICBpZiAoIWVxdWFscyhsYXN0VmlldywgY3RybC4kdmlld1ZhbHVlKSkgewogICAgICAgICAgICAgIGxhc3RWaWV3ID0gc2hhbGxvd0NvcHkoY3RybC4kdmlld1ZhbHVlKTsKICAgICAgICAgICAgICBjdHJsLiRyZW5kZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgc2VsZWN0RWxlbWVudC5vbignY2hhbmdlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgICBmb3JFYWNoKHNlbGVjdEVsZW1lbnQuZmluZCgnb3B0aW9uJyksIGZ1bmN0aW9uKG9wdGlvbikgewogICAgICAgICAgICAgICAgaWYgKG9wdGlvbi5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICBhcnJheS5wdXNoKG9wdGlvbi52YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKGFycmF5KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNldHVwQXNPcHRpb25zKHNjb3BlLCBzZWxlY3RFbGVtZW50LCBjdHJsKSB7CiAgICAgICAgICB2YXIgbWF0Y2g7CgogICAgICAgICAgaWYgKCEobWF0Y2ggPSBvcHRpb25zRXhwLm1hdGNoKE5HX09QVElPTlNfUkVHRVhQKSkpIHsKICAgICAgICAgICAgdGhyb3cgbmdPcHRpb25zTWluRXJyKCdpZXhwJywKICAgICAgICAgICAgICAgICJFeHBlY3RlZCBleHByZXNzaW9uIGluIGZvcm0gb2YgIiArCiAgICAgICAgICAgICAgICAiJ19zZWxlY3RfIChhcyBfbGFiZWxfKT8gZm9yIChfa2V5XywpP192YWx1ZV8gaW4gX2NvbGxlY3Rpb25fJyIgKwogICAgICAgICAgICAgICAgIiBidXQgZ290ICd7MH0nLiBFbGVtZW50OiB7MX0iLAogICAgICAgICAgICAgIG9wdGlvbnNFeHAsIHN0YXJ0aW5nVGFnKHNlbGVjdEVsZW1lbnQpKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgZGlzcGxheUZuID0gJHBhcnNlKG1hdGNoWzJdIHx8IG1hdGNoWzFdKSwKICAgICAgICAgICAgdmFsdWVOYW1lID0gbWF0Y2hbNF0gfHwgbWF0Y2hbNl0sCiAgICAgICAgICAgIGtleU5hbWUgPSBtYXRjaFs1XSwKICAgICAgICAgICAgZ3JvdXBCeUZuID0gJHBhcnNlKG1hdGNoWzNdIHx8ICcnKSwKICAgICAgICAgICAgdmFsdWVGbiA9ICRwYXJzZShtYXRjaFsyXSA/IG1hdGNoWzFdIDogdmFsdWVOYW1lKSwKICAgICAgICAgICAgdmFsdWVzRm4gPSAkcGFyc2UobWF0Y2hbN10pLAogICAgICAgICAgICB0cmFjayA9IG1hdGNoWzhdLAogICAgICAgICAgICB0cmFja0ZuID0gdHJhY2sgPyAkcGFyc2UobWF0Y2hbOF0pIDogbnVsbCwKICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJyYXkgb2YgYXJyYXkgb2YgZXhpc3Rpbmcgb3B0aW9uIGdyb3VwcyBpbiBET00uCiAgICAgICAgICAvLyBXZSB0cnkgdG8gcmV1c2UgdGhlc2UgaWYgcG9zc2libGUKICAgICAgICAgIC8vIC0gb3B0aW9uR3JvdXBzQ2FjaGVbMF0gaXMgdGhlIG9wdGlvbnMgd2l0aCBubyBvcHRpb24gZ3JvdXAKICAgICAgICAgIC8vIC0gb3B0aW9uR3JvdXBzQ2FjaGVbP11bMF0gaXMgdGhlIHBhcmVudDogZWl0aGVyIHRoZSBTRUxFQ1Qgb3IgT1BUR1JPVVAgZWxlbWVudAogICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZSA9IFtbe2VsZW1lbnQ6IHNlbGVjdEVsZW1lbnQsIGxhYmVsOicnfV1dOwoKICAgICAgICAgIGlmIChudWxsT3B0aW9uKSB7CiAgICAgICAgICAgIC8vIGNvbXBpbGUgdGhlIGVsZW1lbnQgc2luY2UgdGhlcmUgbWlnaHQgYmUgYmluZGluZ3MgaW4gaXQKICAgICAgICAgICAgJGNvbXBpbGUobnVsbE9wdGlvbikoc2NvcGUpOwoKICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBjbGFzcywgd2hpY2ggaXMgYWRkZWQgYXV0b21hdGljYWxseSBiZWNhdXNlIHdlIHJlY29tcGlsZSB0aGUgZWxlbWVudCBhbmQgaXQKICAgICAgICAgICAgLy8gYmVjb21lcyB0aGUgY29tcGlsYXRpb24gcm9vdAogICAgICAgICAgICBudWxsT3B0aW9uLnJlbW92ZUNsYXNzKCduZy1zY29wZScpOwoKICAgICAgICAgICAgLy8gd2UgbmVlZCB0byByZW1vdmUgaXQgYmVmb3JlIGNhbGxpbmcgc2VsZWN0RWxlbWVudC5lbXB0eSgpIGJlY2F1c2Ugb3RoZXJ3aXNlIElFIHdpbGwKICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBsYWJlbCBmcm9tIHRoZSBlbGVtZW50LiB3dGY/CiAgICAgICAgICAgIG51bGxPcHRpb24ucmVtb3ZlKCk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gY2xlYXIgY29udGVudHMsIHdlJ2xsIGFkZCB3aGF0J3MgbmVlZGVkIGJhc2VkIG9uIHRoZSBtb2RlbAogICAgICAgICAgc2VsZWN0RWxlbWVudC5lbXB0eSgpOwoKICAgICAgICAgIHNlbGVjdEVsZW1lbnQub24oJ2NoYW5nZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIG9wdGlvbkdyb3VwLAogICAgICAgICAgICAgICAgY29sbGVjdGlvbiA9IHZhbHVlc0ZuKHNjb3BlKSB8fCBbXSwKICAgICAgICAgICAgICAgIGxvY2FscyA9IHt9LAogICAgICAgICAgICAgICAga2V5LCB2YWx1ZSwgb3B0aW9uRWxlbWVudCwgaW5kZXgsIGdyb3VwSW5kZXgsIGxlbmd0aCwgZ3JvdXBMZW5ndGgsIHRyYWNrSW5kZXg7CgogICAgICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICAgICAgdmFsdWUgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoZ3JvdXBJbmRleCA9IDAsIGdyb3VwTGVuZ3RoID0gb3B0aW9uR3JvdXBzQ2FjaGUubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgIGdyb3VwSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAvLyBsaXN0IG9mIG9wdGlvbnMgZm9yIHRoYXQgZ3JvdXAuIChmaXJzdCBpdGVtIGhhcyB0aGUgcGFyZW50KQogICAgICAgICAgICAgICAgICBvcHRpb25Hcm91cCA9IG9wdGlvbkdyb3Vwc0NhY2hlW2dyb3VwSW5kZXhdOwoKICAgICAgICAgICAgICAgICAgZm9yKGluZGV4ID0gMSwgbGVuZ3RoID0gb3B0aW9uR3JvdXAubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgIGlmICgob3B0aW9uRWxlbWVudCA9IG9wdGlvbkdyb3VwW2luZGV4XS5lbGVtZW50KVswXS5zZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICAgICAga2V5ID0gb3B0aW9uRWxlbWVudC52YWwoKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXlOYW1lKSBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAodHJhY2tGbikgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHRyYWNrSW5kZXggPSAwOyB0cmFja0luZGV4IDwgY29sbGVjdGlvbi5sZW5ndGg7IHRyYWNrSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2Fsc1t2YWx1ZU5hbWVdID0gY29sbGVjdGlvblt0cmFja0luZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHJhY2tGbihzY29wZSwgbG9jYWxzKSA9PSBrZXkpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLnB1c2godmFsdWVGbihzY29wZSwgbG9jYWxzKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGtleSA9IHNlbGVjdEVsZW1lbnQudmFsKCk7CiAgICAgICAgICAgICAgICBpZiAoa2V5ID09ICc/JykgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnJyl7CiAgICAgICAgICAgICAgICAgIHZhbHVlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmICh0cmFja0ZuKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh0cmFja0luZGV4ID0gMDsgdHJhY2tJbmRleCA8IGNvbGxlY3Rpb24ubGVuZ3RoOyB0cmFja0luZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgIGxvY2Fsc1t2YWx1ZU5hbWVdID0gY29sbGVjdGlvblt0cmFja0luZGV4XTsKICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFja0ZuKHNjb3BlLCBsb2NhbHMpID09IGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlRm4oc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IGNvbGxlY3Rpb25ba2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAoa2V5TmFtZSkgbG9jYWxzW2tleU5hbWVdID0ga2V5OwogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWVGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBudWxsIG9wdGlvbidzIHNlbGVjdGVkIHByb3BlcnR5IGhlcmUgc28gJHJlbmRlciBjbGVhbnMgaXQgdXAgY29ycmVjdGx5CiAgICAgICAgICAgICAgICBpZiAob3B0aW9uR3JvdXBzQ2FjaGVbMF0ubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICBpZiAob3B0aW9uR3JvdXBzQ2FjaGVbMF1bMV0uaWQgIT09IGtleSkgewogICAgICAgICAgICAgICAgICAgIG9wdGlvbkdyb3Vwc0NhY2hlWzBdWzFdLnNlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3RybC4kc2V0Vmlld1ZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBjdHJsLiRyZW5kZXIgPSByZW5kZXI7CgogICAgICAgICAgLy8gVE9ETyh2b2p0YSk6IGNhbid0IHdlIG9wdGltaXplIHRoaXMgPwogICAgICAgICAgc2NvcGUuJHdhdGNoKHJlbmRlcik7CgogICAgICAgICAgZnVuY3Rpb24gcmVuZGVyKCkgewogICAgICAgICAgICAvLyBUZW1wb3JhcnkgbG9jYXRpb24gZm9yIHRoZSBvcHRpb24gZ3JvdXBzIGJlZm9yZSB3ZSByZW5kZXIgdGhlbQogICAgICAgICAgICB2YXIgb3B0aW9uR3JvdXBzID0geycnOltdfSwKICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWVzID0gWycnXSwKICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUsCiAgICAgICAgICAgICAgb3B0aW9uR3JvdXAsCiAgICAgICAgICAgICAgb3B0aW9uLAogICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LCBleGlzdGluZ09wdGlvbnMsIGV4aXN0aW5nT3B0aW9uLAogICAgICAgICAgICAgIG1vZGVsVmFsdWUgPSBjdHJsLiRtb2RlbFZhbHVlLAogICAgICAgICAgICAgIHZhbHVlcyA9IHZhbHVlc0ZuKHNjb3BlKSB8fCBbXSwKICAgICAgICAgICAgICBrZXlzID0ga2V5TmFtZSA/IHNvcnRlZEtleXModmFsdWVzKSA6IHZhbHVlcywKICAgICAgICAgICAgICBrZXksCiAgICAgICAgICAgICAgZ3JvdXBMZW5ndGgsIGxlbmd0aCwKICAgICAgICAgICAgICBncm91cEluZGV4LCBpbmRleCwKICAgICAgICAgICAgICBsb2NhbHMgPSB7fSwKICAgICAgICAgICAgICBzZWxlY3RlZCwKICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IGZhbHNlLCAvLyBub3RoaW5nIGlzIHNlbGVjdGVkIHlldAogICAgICAgICAgICAgIGxhc3RFbGVtZW50LAogICAgICAgICAgICAgIGVsZW1lbnQsCiAgICAgICAgICAgICAgbGFiZWw7CgogICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICBpZiAodHJhY2tGbiAmJiBpc0FycmF5KG1vZGVsVmFsdWUpKSB7CiAgICAgICAgICAgICAgICBzZWxlY3RlZFNldCA9IG5ldyBIYXNoTWFwKFtdKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIHRyYWNrSW5kZXggPSAwOyB0cmFja0luZGV4IDwgbW9kZWxWYWx1ZS5sZW5ndGg7IHRyYWNrSW5kZXgrKykgewogICAgICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IG1vZGVsVmFsdWVbdHJhY2tJbmRleF07CiAgICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0LnB1dCh0cmFja0ZuKHNjb3BlLCBsb2NhbHMpLCBtb2RlbFZhbHVlW3RyYWNrSW5kZXhdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2VsZWN0ZWRTZXQgPSBuZXcgSGFzaE1hcChtb2RlbFZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFdlIG5vdyBidWlsZCB1cCB0aGUgbGlzdCBvZiBvcHRpb25zIHdlIG5lZWQgKHdlIG1lcmdlIGxhdGVyKQogICAgICAgICAgICBmb3IgKGluZGV4ID0gMDsgbGVuZ3RoID0ga2V5cy5sZW5ndGgsIGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CgogICAgICAgICAgICAgIGtleSA9IGluZGV4OwogICAgICAgICAgICAgIGlmIChrZXlOYW1lKSB7CiAgICAgICAgICAgICAgICBrZXkgPSBrZXlzW2luZGV4XTsKICAgICAgICAgICAgICAgIGlmICgga2V5LmNoYXJBdCgwKSA9PT0gJyQnICkgY29udGludWU7CiAgICAgICAgICAgICAgICBsb2NhbHNba2V5TmFtZV0gPSBrZXk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBsb2NhbHNbdmFsdWVOYW1lXSA9IHZhbHVlc1trZXldOwoKICAgICAgICAgICAgICBvcHRpb25Hcm91cE5hbWUgPSBncm91cEJ5Rm4oc2NvcGUsIGxvY2FscykgfHwgJyc7CiAgICAgICAgICAgICAgaWYgKCEob3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXSkpIHsKICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uR3JvdXBzW29wdGlvbkdyb3VwTmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZXMucHVzaChvcHRpb25Hcm91cE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gaXNEZWZpbmVkKAogICAgICAgICAgICAgICAgICBzZWxlY3RlZFNldC5yZW1vdmUodHJhY2tGbiA/IHRyYWNrRm4oc2NvcGUsIGxvY2FscykgOiB2YWx1ZUZuKHNjb3BlLCBsb2NhbHMpKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRyYWNrRm4pIHsKICAgICAgICAgICAgICAgICAgdmFyIG1vZGVsQ2FzdCA9IHt9OwogICAgICAgICAgICAgICAgICBtb2RlbENhc3RbdmFsdWVOYW1lXSA9IG1vZGVsVmFsdWU7CiAgICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gdHJhY2tGbihzY29wZSwgbW9kZWxDYXN0KSA9PT0gdHJhY2tGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHNlbGVjdGVkID0gbW9kZWxWYWx1ZSA9PT0gdmFsdWVGbihzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNlbGVjdGVkU2V0ID0gc2VsZWN0ZWRTZXQgfHwgc2VsZWN0ZWQ7IC8vIHNlZSBpZiBhdCBsZWFzdCBvbmUgaXRlbSBpcyBzZWxlY3RlZAogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYWJlbCA9IGRpc3BsYXlGbihzY29wZSwgbG9jYWxzKTsgLy8gd2hhdCB3aWxsIGJlIHNlZW4gYnkgdGhlIHVzZXIKCiAgICAgICAgICAgICAgLy8gZG9pbmcgZGlzcGxheUZuKHNjb3BlLCBsb2NhbHMpIHx8ICcnIG92ZXJ3cml0ZXMgemVybyB2YWx1ZXMKICAgICAgICAgICAgICBsYWJlbCA9IGlzRGVmaW5lZChsYWJlbCkgPyBsYWJlbCA6ICcnOwogICAgICAgICAgICAgIG9wdGlvbkdyb3VwLnB1c2goewogICAgICAgICAgICAgICAgLy8gZWl0aGVyIHRoZSBpbmRleCBpbnRvIGFycmF5IG9yIGtleSBmcm9tIG9iamVjdAogICAgICAgICAgICAgICAgaWQ6IHRyYWNrRm4gPyB0cmFja0ZuKHNjb3BlLCBsb2NhbHMpIDogKGtleU5hbWUgPyBrZXlzW2luZGV4XSA6IGluZGV4KSwKICAgICAgICAgICAgICAgIGxhYmVsOiBsYWJlbCwKICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBzZWxlY3RlZCAgICAgICAgICAgICAgICAgICAvLyBkZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGJlIHNlbGVjdGVkCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFtdWx0aXBsZSkgewogICAgICAgICAgICAgIGlmIChudWxsT3B0aW9uIHx8IG1vZGVsVmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIC8vIGluc2VydCBudWxsIG9wdGlvbiBpZiB3ZSBoYXZlIGEgcGxhY2Vob2xkZXIsIG9yIHRoZSBtb2RlbCBpcyBudWxsCiAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNbJyddLnVuc2hpZnQoe2lkOicnLCBsYWJlbDonJywgc2VsZWN0ZWQ6IXNlbGVjdGVkU2V0fSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghc2VsZWN0ZWRTZXQpIHsKICAgICAgICAgICAgICAgIC8vIG9wdGlvbiBjb3VsZCBub3QgYmUgZm91bmQsIHdlIGhhdmUgdG8gaW5zZXJ0IHRoZSB1bmRlZmluZWQgaXRlbQogICAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzWycnXS51bnNoaWZ0KHtpZDonPycsIGxhYmVsOicnLCBzZWxlY3RlZDp0cnVlfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOb3cgd2UgbmVlZCB0byB1cGRhdGUgdGhlIGxpc3Qgb2YgRE9NIG5vZGVzIHRvIG1hdGNoIHRoZSBvcHRpb25Hcm91cHMgd2UgY29tcHV0ZWQgYWJvdmUKICAgICAgICAgICAgZm9yIChncm91cEluZGV4ID0gMCwgZ3JvdXBMZW5ndGggPSBvcHRpb25Hcm91cE5hbWVzLmxlbmd0aDsKICAgICAgICAgICAgICAgICBncm91cEluZGV4IDwgZ3JvdXBMZW5ndGg7CiAgICAgICAgICAgICAgICAgZ3JvdXBJbmRleCsrKSB7CiAgICAgICAgICAgICAgLy8gY3VycmVudCBvcHRpb24gZ3JvdXAgbmFtZSBvciAnJyBpZiBubyBncm91cAogICAgICAgICAgICAgIG9wdGlvbkdyb3VwTmFtZSA9IG9wdGlvbkdyb3VwTmFtZXNbZ3JvdXBJbmRleF07CgogICAgICAgICAgICAgIC8vIGxpc3Qgb2Ygb3B0aW9ucyBmb3IgdGhhdCBncm91cC4gKGZpcnN0IGl0ZW0gaGFzIHRoZSBwYXJlbnQpCiAgICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb25Hcm91cHNbb3B0aW9uR3JvdXBOYW1lXTsKCiAgICAgICAgICAgICAgaWYgKG9wdGlvbkdyb3Vwc0NhY2hlLmxlbmd0aCA8PSBncm91cEluZGV4KSB7CiAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIGdyb3cgdGhlIG9wdGlvbkdyb3VwcwogICAgICAgICAgICAgICAgZXhpc3RpbmdQYXJlbnQgPSB7CiAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IG9wdEdyb3VwVGVtcGxhdGUuY2xvbmUoKS5hdHRyKCdsYWJlbCcsIG9wdGlvbkdyb3VwTmFtZSksCiAgICAgICAgICAgICAgICAgIGxhYmVsOiBvcHRpb25Hcm91cC5sYWJlbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucyA9IFtleGlzdGluZ1BhcmVudF07CiAgICAgICAgICAgICAgICBvcHRpb25Hcm91cHNDYWNoZS5wdXNoKGV4aXN0aW5nT3B0aW9ucyk7CiAgICAgICAgICAgICAgICBzZWxlY3RFbGVtZW50LmFwcGVuZChleGlzdGluZ1BhcmVudC5lbGVtZW50KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zID0gb3B0aW9uR3JvdXBzQ2FjaGVbZ3JvdXBJbmRleF07CiAgICAgICAgICAgICAgICBleGlzdGluZ1BhcmVudCA9IGV4aXN0aW5nT3B0aW9uc1swXTsgIC8vIGVpdGhlciBTRUxFQ1QgKG5vIGdyb3VwKSBvciBPUFRHUk9VUCBlbGVtZW50CgogICAgICAgICAgICAgICAgLy8gdXBkYXRlIHRoZSBPUFRHUk9VUCBsYWJlbCBpZiBub3QgdGhlIHNhbWUuCiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdQYXJlbnQubGFiZWwgIT0gb3B0aW9uR3JvdXBOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXR0cignbGFiZWwnLCBleGlzdGluZ1BhcmVudC5sYWJlbCA9IG9wdGlvbkdyb3VwTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBsYXN0RWxlbWVudCA9IG51bGw7ICAvLyBzdGFydCBhdCB0aGUgYmVnaW5uaW5nCiAgICAgICAgICAgICAgZm9yKGluZGV4ID0gMCwgbGVuZ3RoID0gb3B0aW9uR3JvdXAubGVuZ3RoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgb3B0aW9uID0gb3B0aW9uR3JvdXBbaW5kZXhdOwogICAgICAgICAgICAgICAgaWYgKChleGlzdGluZ09wdGlvbiA9IGV4aXN0aW5nT3B0aW9uc1tpbmRleCsxXSkpIHsKICAgICAgICAgICAgICAgICAgLy8gcmV1c2UgZWxlbWVudHMKICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQgPSBleGlzdGluZ09wdGlvbi5lbGVtZW50OwogICAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdPcHRpb24ubGFiZWwgIT09IG9wdGlvbi5sYWJlbCkgewogICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LnRleHQoZXhpc3RpbmdPcHRpb24ubGFiZWwgPSBvcHRpb24ubGFiZWwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ09wdGlvbi5pZCAhPT0gb3B0aW9uLmlkKSB7CiAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQudmFsKGV4aXN0aW5nT3B0aW9uLmlkID0gb3B0aW9uLmlkKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAvLyBsYXN0RWxlbWVudC5wcm9wKCdzZWxlY3RlZCcpIHByb3ZpZGVkIGJ5IGpRdWVyeSBoYXMgc2lkZS1lZmZlY3RzCiAgICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ09wdGlvbi5zZWxlY3RlZCAhPT0gb3B0aW9uLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgbGFzdEVsZW1lbnQucHJvcCgnc2VsZWN0ZWQnLCAoZXhpc3RpbmdPcHRpb24uc2VsZWN0ZWQgPSBvcHRpb24uc2VsZWN0ZWQpKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgLy8gZ3JvdyBlbGVtZW50cwoKICAgICAgICAgICAgICAgICAgLy8gaWYgaXQncyBhIG51bGwgb3B0aW9uCiAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24uaWQgPT09ICcnICYmIG51bGxPcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAvLyBwdXQgYmFjayB0aGUgcHJlLWNvbXBpbGVkIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0gbnVsbE9wdGlvbjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBqUXVlcnkodjEuNC4yKSBCdWc6IFdlIHNob3VsZCBiZSBhYmxlIHRvIGNoYWluIHRoZSBtZXRob2QgY2FsbHMsIGJ1dAogICAgICAgICAgICAgICAgICAgIC8vIGluIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnkgb24gc29tZSBicm93c2VyIHRoZSAudGV4dCgpIHJldHVybnMgYSBzdHJpbmcKICAgICAgICAgICAgICAgICAgICAvLyByYXRoZXIgdGhlbiB0aGUgZWxlbWVudC4KICAgICAgICAgICAgICAgICAgICAoZWxlbWVudCA9IG9wdGlvblRlbXBsYXRlLmNsb25lKCkpCiAgICAgICAgICAgICAgICAgICAgICAudmFsKG9wdGlvbi5pZCkKICAgICAgICAgICAgICAgICAgICAgIC5hdHRyKCdzZWxlY3RlZCcsIG9wdGlvbi5zZWxlY3RlZCkKICAgICAgICAgICAgICAgICAgICAgIC50ZXh0KG9wdGlvbi5sYWJlbCk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nT3B0aW9ucy5wdXNoKGV4aXN0aW5nT3B0aW9uID0gewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsCiAgICAgICAgICAgICAgICAgICAgbGFiZWw6IG9wdGlvbi5sYWJlbCwKICAgICAgICAgICAgICAgICAgICBpZDogb3B0aW9uLmlkLAogICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBvcHRpb24uc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIGlmIChsYXN0RWxlbWVudCkgewogICAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50LmFmdGVyKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nUGFyZW50LmVsZW1lbnQuYXBwZW5kKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGxhc3RFbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gcmVtb3ZlIGFueSBleGNlc3NpdmUgT1BUSU9OcyBpbiBhIGdyb3VwCiAgICAgICAgICAgICAgaW5kZXgrKzsgLy8gaW5jcmVtZW50IHNpbmNlIHRoZSBleGlzdGluZ09wdGlvbnNbMF0gaXMgcGFyZW50IGVsZW1lbnQgbm90IE9QVElPTgogICAgICAgICAgICAgIHdoaWxlKGV4aXN0aW5nT3B0aW9ucy5sZW5ndGggPiBpbmRleCkgewogICAgICAgICAgICAgICAgZXhpc3RpbmdPcHRpb25zLnBvcCgpLmVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHJlbW92ZSBhbnkgZXhjZXNzaXZlIE9QVEdST1VQcyBmcm9tIHNlbGVjdAogICAgICAgICAgICB3aGlsZShvcHRpb25Hcm91cHNDYWNoZS5sZW5ndGggPiBncm91cEluZGV4KSB7CiAgICAgICAgICAgICAgb3B0aW9uR3JvdXBzQ2FjaGUucG9wKClbMF0uZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XTsKCiAgdmFyIG9wdGlvbkRpcmVjdGl2ZSA9IFsnJGludGVycG9sYXRlJywgZnVuY3Rpb24oJGludGVycG9sYXRlKSB7CiAgICB2YXIgbnVsbFNlbGVjdEN0cmwgPSB7CiAgICAgIGFkZE9wdGlvbjogbm9vcCwKICAgICAgcmVtb3ZlT3B0aW9uOiBub29wCiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICBpZiAoaXNVbmRlZmluZWQoYXR0ci52YWx1ZSkpIHsKICAgICAgICAgIHZhciBpbnRlcnBvbGF0ZUZuID0gJGludGVycG9sYXRlKGVsZW1lbnQudGV4dCgpLCB0cnVlKTsKICAgICAgICAgIGlmICghaW50ZXJwb2xhdGVGbikgewogICAgICAgICAgICBhdHRyLiRzZXQoJ3ZhbHVlJywgZWxlbWVudC50ZXh0KCkpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgdmFyIHNlbGVjdEN0cmxOYW1lID0gJyRzZWxlY3RDb250cm9sbGVyJywKICAgICAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnQoKSwKICAgICAgICAgICAgc2VsZWN0Q3RybCA9IHBhcmVudC5kYXRhKHNlbGVjdEN0cmxOYW1lKSB8fAogICAgICAgICAgICAgIHBhcmVudC5wYXJlbnQoKS5kYXRhKHNlbGVjdEN0cmxOYW1lKTsgLy8gaW4gY2FzZSB3ZSBhcmUgaW4gb3B0Z3JvdXAKCiAgICAgICAgICBpZiAoc2VsZWN0Q3RybCAmJiBzZWxlY3RDdHJsLmRhdGFib3VuZCkgewogICAgICAgICAgICAvLyBGb3Igc29tZSByZWFzb24gT3BlcmEgZGVmYXVsdHMgdG8gdHJ1ZSBhbmQgaWYgbm90IG92ZXJyaWRkZW4gdGhpcyBtZXNzZXMgdXAgdGhlIHJlcGVhdGVyLgogICAgICAgICAgICAvLyBXZSBkb24ndCB3YW50IHRoZSB2aWV3IHRvIGRyaXZlIHRoZSBpbml0aWFsaXphdGlvbiBvZiB0aGUgbW9kZWwgYW55d2F5LgogICAgICAgICAgICBlbGVtZW50LnByb3AoJ3NlbGVjdGVkJywgZmFsc2UpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZWN0Q3RybCA9IG51bGxTZWxlY3RDdHJsOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChpbnRlcnBvbGF0ZUZuKSB7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaChpbnRlcnBvbGF0ZUZuLCBmdW5jdGlvbiBpbnRlcnBvbGF0ZVdhdGNoQWN0aW9uKG5ld1ZhbCwgb2xkVmFsKSB7CiAgICAgICAgICAgICAgYXR0ci4kc2V0KCd2YWx1ZScsIG5ld1ZhbCk7CiAgICAgICAgICAgICAgaWYgKG5ld1ZhbCAhPT0gb2xkVmFsKSBzZWxlY3RDdHJsLnJlbW92ZU9wdGlvbihvbGRWYWwpOwogICAgICAgICAgICAgIHNlbGVjdEN0cmwuYWRkT3B0aW9uKG5ld1ZhbCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZWN0Q3RybC5hZGRPcHRpb24oYXR0ci52YWx1ZSk7CiAgICAgICAgICB9CgogICAgICAgICAgZWxlbWVudC5vbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2VsZWN0Q3RybC5yZW1vdmVPcHRpb24oYXR0ci52YWx1ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICB9CiAgICB9OwogIH1dOwoKICB2YXIgc3R5bGVEaXJlY3RpdmUgPSB2YWx1ZUZuKHsKICAgIHJlc3RyaWN0OiAnRScsCiAgICB0ZXJtaW5hbDogdHJ1ZQogIH0pOwoKICBpZiAod2luZG93LmFuZ3VsYXIuYm9vdHN0cmFwKSB7CiAgICAvL0FuZ3VsYXJKUyBpcyBhbHJlYWR5IGxvYWRlZCwgc28gd2UgY2FuIHJldHVybiBoZXJlLi4uCiAgICBjb25zb2xlLmxvZygnV0FSTklORzogVHJpZWQgdG8gbG9hZCBhbmd1bGFyIG1vcmUgdGhhbiBvbmNlLicpOwogICAgcmV0dXJuOwogIH0KCiAgLy90cnkgdG8gYmluZCB0byBqcXVlcnkgbm93IHNvIHRoYXQgb25lIGNhbiB3cml0ZSBhbmd1bGFyLmVsZW1lbnQoKS5yZWFkKCkKICAvL2J1dCB3ZSB3aWxsIHJlYmluZCBvbiBib290c3RyYXAgYWdhaW4uCiAgYmluZEpRdWVyeSgpOwoKICBwdWJsaXNoRXh0ZXJuYWxBUEkoYW5ndWxhcik7CgogIGpxTGl0ZShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgICBhbmd1bGFySW5pdChkb2N1bWVudCwgYm9vdHN0cmFwKTsKICB9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwoKIXdpbmRvdy5hbmd1bGFyLiQkY3NwKCkgJiYgd2luZG93LmFuZ3VsYXIuZWxlbWVudChkb2N1bWVudCkuZmluZCgnaGVhZCcpLnByZXBlbmQoJzxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+QGNoYXJzZXQgIlVURi04IjtbbmdcXDpjbG9ha10sW25nLWNsb2FrXSxbZGF0YS1uZy1jbG9ha10sW3gtbmctY2xvYWtdLC5uZy1jbG9haywueC1uZy1jbG9haywubmctaGlkZXtkaXNwbGF5Om5vbmUgIWltcG9ydGFudDt9bmdcXDpmb3Jte2Rpc3BsYXk6YmxvY2s7fS5uZy1hbmltYXRlLWJsb2NrLXRyYW5zaXRpb25ze3RyYW5zaXRpb246MHMgYWxsIWltcG9ydGFudDstd2Via2l0LXRyYW5zaXRpb246MHMgYWxsIWltcG9ydGFudDt9Lm5nLWhpZGUtYWRkLWFjdGl2ZSwubmctaGlkZS1yZW1vdmV7ZGlzcGxheTpibG9jayFpbXBvcnRhbnQ7fTwvc3R5bGU+Jyk7Ci8qIQogKiBpb25pYy5idW5kbGUuanMgaXMgYSBjb25jYXRlbmF0aW9uIG9mOgogKiBpb25pYy5qcywgYW5ndWxhci5qcywgYW5ndWxhci1hbmltYXRlLmpzLAogKiBhbmd1bGFyLXNhbml0aXplLmpzLCBhbmd1bGFyLXVpLXJvdXRlci5qcywKICogYW5kIGlvbmljLWFuZ3VsYXIuanMKICovCgovKioKICogQGxpY2Vuc2UgQW5ndWxhckpTIHYxLjIuMTcKICogKGMpIDIwMTAtMjAxNCBHb29nbGUsIEluYy4gaHR0cDovL2FuZ3VsYXJqcy5vcmcKICogTGljZW5zZTogTUlUCiAqLwooZnVuY3Rpb24od2luZG93LCBhbmd1bGFyLCB1bmRlZmluZWQpIHsndXNlIHN0cmljdCc7CgogIC8qIGpzaGludCBtYXhsZW46IGZhbHNlICovCgogIC8qKgogICAqIEBuZ2RvYyBtb2R1bGUKICAgKiBAbmFtZSBuZ0FuaW1hdGUKICAgKiBAZGVzY3JpcHRpb24KICAgKgogICAqICMgbmdBbmltYXRlCiAgICoKICAgKiBUaGUgYG5nQW5pbWF0ZWAgbW9kdWxlIHByb3ZpZGVzIHN1cHBvcnQgZm9yIEphdmFTY3JpcHQsIENTUzMgdHJhbnNpdGlvbiBhbmQgQ1NTMyBrZXlmcmFtZSBhbmltYXRpb24gaG9va3Mgd2l0aGluIGV4aXN0aW5nIGNvcmUgYW5kIGN1c3RvbSBkaXJlY3RpdmVzLgogICAqCiAgICoKICAgKiA8ZGl2IGRvYy1tb2R1bGUtY29tcG9uZW50cz0ibmdBbmltYXRlIj48L2Rpdj4KICAgKgogICAqICMgVXNhZ2UKICAgKgogICAqIFRvIHNlZSBhbmltYXRpb25zIGluIGFjdGlvbiwgYWxsIHRoYXQgaXMgcmVxdWlyZWQgaXMgdG8gZGVmaW5lIHRoZSBhcHByb3ByaWF0ZSBDU1MgY2xhc3NlcwogICAqIG9yIHRvIHJlZ2lzdGVyIGEgSmF2YVNjcmlwdCBhbmltYXRpb24gdmlhIHRoZSBteU1vZHVsZS5hbmltYXRpb24oKSBmdW5jdGlvbi4gVGhlIGRpcmVjdGl2ZXMgdGhhdCBzdXBwb3J0IGFuaW1hdGlvbiBhdXRvbWF0aWNhbGx5IGFyZToKICAgKiBgbmdSZXBlYXRgLCBgbmdJbmNsdWRlYCwgYG5nSWZgLCBgbmdTd2l0Y2hgLCBgbmdTaG93YCwgYG5nSGlkZWAsIGBuZ1ZpZXdgIGFuZCBgbmdDbGFzc2AuIEN1c3RvbSBkaXJlY3RpdmVzIGNhbiB0YWtlIGFkdmFudGFnZSBvZiBhbmltYXRpb24KICAgKiBieSB1c2luZyB0aGUgYCRhbmltYXRlYCBzZXJ2aWNlLgogICAqCiAgICogQmVsb3cgaXMgYSBtb3JlIGRldGFpbGVkIGJyZWFrZG93biBvZiB0aGUgc3VwcG9ydGVkIGFuaW1hdGlvbiBldmVudHMgcHJvdmlkZWQgYnkgcHJlLWV4aXN0aW5nIG5nIGRpcmVjdGl2ZXM6CiAgICoKICAgKiB8IERpcmVjdGl2ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IFN1cHBvcnRlZCBBbmltYXRpb25zICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdSZXBlYXQjdXNhZ2VfYW5pbWF0aW9ucyBuZ1JlcGVhdH0gICAgICAgICB8IGVudGVyLCBsZWF2ZSBhbmQgbW92ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgKiB8IHtAbGluayBuZ1JvdXRlLmRpcmVjdGl2ZTpuZ1ZpZXcjdXNhZ2VfYW5pbWF0aW9ucyBuZ1ZpZXd9ICAgICAgICB8IGVudGVyIGFuZCBsZWF2ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdJbmNsdWRlI3VzYWdlX2FuaW1hdGlvbnMgbmdJbmNsdWRlfSAgICAgICB8IGVudGVyIGFuZCBsZWF2ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdTd2l0Y2gjdXNhZ2VfYW5pbWF0aW9ucyBuZ1N3aXRjaH0gICAgICAgICB8IGVudGVyIGFuZCBsZWF2ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdJZiN1c2FnZV9hbmltYXRpb25zIG5nSWZ9ICAgICAgICAgICAgICAgICB8IGVudGVyIGFuZCBsZWF2ZSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdDbGFzcyN1c2FnZV9hbmltYXRpb25zIG5nQ2xhc3N9ICAgICAgICAgICB8IGFkZCBhbmQgcmVtb3ZlICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6bmdTaG93I3VzYWdlX2FuaW1hdGlvbnMgbmdTaG93ICYgbmdIaWRlfSAgICB8IGFkZCBhbmQgcmVtb3ZlICh0aGUgbmctaGlkZSBjbGFzcyB2YWx1ZSkgICAgICAgICAgIHwKICAgKiB8IHtAbGluayBuZy5kaXJlY3RpdmU6Zm9ybSN1c2FnZV9hbmltYXRpb25zIGZvcm19ICAgICAgICAgICAgICAgICB8IGFkZCBhbmQgcmVtb3ZlIChkaXJ0eSwgcHJpc3RpbmUsIHZhbGlkLCBpbnZhbGlkICYgYWxsIG90aGVyIHZhbGlkYXRpb25zKSAgICAgICAgICAgICAgICB8CiAgICogfCB7QGxpbmsgbmcuZGlyZWN0aXZlOm5nTW9kZWwjdXNhZ2VfYW5pbWF0aW9ucyBuZ01vZGVsfSAgICAgICAgICAgfCBhZGQgYW5kIHJlbW92ZSAoZGlydHksIHByaXN0aW5lLCB2YWxpZCwgaW52YWxpZCAmIGFsbCBvdGhlciB2YWxpZGF0aW9ucykgICAgICAgICAgICAgICAgfAogICAqCiAgICogWW91IGNhbiBmaW5kIG91dCBtb3JlIGluZm9ybWF0aW9uIGFib3V0IGFuaW1hdGlvbnMgdXBvbiB2aXNpdGluZyBlYWNoIGRpcmVjdGl2ZSBwYWdlLgogICAqCiAgICogQmVsb3cgaXMgYW4gZXhhbXBsZSBvZiBob3cgdG8gYXBwbHkgYW5pbWF0aW9ucyB0byBhIGRpcmVjdGl2ZSB0aGF0IHN1cHBvcnRzIGFuaW1hdGlvbiBob29rczoKICAgKgogICAqIGBgYGh0bWwKICAgKiA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgogICAqIC5zbGlkZS5uZy1lbnRlciwgLnNsaWRlLm5nLWxlYXZlIHsKICogICAtd2Via2l0LXRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogKiAgIHRyYW5zaXRpb246MC41cyBsaW5lYXIgYWxsOwogKiB9CiAgICoKICAgKiAuc2xpZGUubmctZW50ZXIgeyB9ICAgICAgICAvJiM0Mjsgc3RhcnRpbmcgYW5pbWF0aW9ucyBmb3IgZW50ZXIgJiM0MjsvCiAgICogLnNsaWRlLm5nLWVudGVyLWFjdGl2ZSB7IH0gLyYjNDI7IHRlcm1pbmFsIGFuaW1hdGlvbnMgZm9yIGVudGVyICYjNDI7LwogICAqIC5zbGlkZS5uZy1sZWF2ZSB7IH0gICAgICAgIC8mIzQyOyBzdGFydGluZyBhbmltYXRpb25zIGZvciBsZWF2ZSAmIzQyOy8KICAgKiAuc2xpZGUubmctbGVhdmUtYWN0aXZlIHsgfSAvJiM0MjsgdGVybWluYWwgYW5pbWF0aW9ucyBmb3IgbGVhdmUgJiM0MjsvCiAgICogPC9zdHlsZT4KICAgKgogICAqIDwhLS0KICAgKiB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgYXV0b21hdGljYWxseSBhZGQgLm5nLWVudGVyIGFuZCAubmctbGVhdmUgdG8gdGhlIGVsZW1lbnQKICAgKiB0byB0cmlnZ2VyIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb25zCiAgICogLS0+CiAgICogPEFOWSBjbGFzcz0ic2xpZGUiIG5nLWluY2x1ZGU9Ii4uLiI+PC9BTlk+CiAgICogYGBgCiAgICoKICAgKiBLZWVwIGluIG1pbmQgdGhhdCBpZiBhbiBhbmltYXRpb24gaXMgcnVubmluZywgYW55IGNoaWxkIGVsZW1lbnRzIGNhbm5vdCBiZSBhbmltYXRlZCB1bnRpbCB0aGUgcGFyZW50IGVsZW1lbnQncwogICAqIGFuaW1hdGlvbiBoYXMgY29tcGxldGVkLgogICAqCiAgICogPGgyPkNTUy1kZWZpbmVkIEFuaW1hdGlvbnM8L2gyPgogICAqIFRoZSBhbmltYXRlIHNlcnZpY2Ugd2lsbCBhdXRvbWF0aWNhbGx5IGFwcGx5IHR3byBDU1MgY2xhc3NlcyB0byB0aGUgYW5pbWF0ZWQgZWxlbWVudCBhbmQgdGhlc2UgdHdvIENTUyBjbGFzc2VzCiAgICogYXJlIGRlc2lnbmVkIHRvIGNvbnRhaW4gdGhlIHN0YXJ0IGFuZCBlbmQgQ1NTIHN0eWxpbmcuIEJvdGggQ1NTIHRyYW5zaXRpb25zIGFuZCBrZXlmcmFtZSBhbmltYXRpb25zIGFyZSBzdXBwb3J0ZWQKICAgKiBhbmQgY2FuIGJlIHVzZWQgdG8gcGxheSBhbG9uZyB3aXRoIHRoaXMgbmFtaW5nIHN0cnVjdHVyZS4KICAgKgogICAqIFRoZSBmb2xsb3dpbmcgY29kZSBiZWxvdyBkZW1vbnN0cmF0ZXMgaG93IHRvIHBlcmZvcm0gYW5pbWF0aW9ucyB1c2luZyAqKkNTUyB0cmFuc2l0aW9ucyoqIHdpdGggQW5ndWxhcjoKICAgKgogICAqIGBgYGh0bWwKICAgKiA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgogICAqIC8mIzQyOwogICAqICBUaGUgYW5pbWF0ZSBjbGFzcyBpcyBhcGFydCBvZiB0aGUgZWxlbWVudCBhbmQgdGhlIG5nLWVudGVyIGNsYXNzCiAgICogIGlzIGF0dGFjaGVkIHRvIHRoZSBlbGVtZW50IG9uY2UgdGhlIGVudGVyIGFuaW1hdGlvbiBldmVudCBpcyB0cmlnZ2VyZWQKICAgKiAmIzQyOy8KICAgKiAucmV2ZWFsLWFuaW1hdGlvbi5uZy1lbnRlciB7CiAqICAtd2Via2l0LXRyYW5zaXRpb246IDFzIGxpbmVhciBhbGw7IC8mIzQyOyBTYWZhcmkvQ2hyb21lICYjNDI7LwogKiAgdHJhbnNpdGlvbjogMXMgbGluZWFyIGFsbDsgLyYjNDI7IEFsbCBvdGhlciBtb2Rlcm4gYnJvd3NlcnMgYW5kIElFMTArICYjNDI7LwogKgogKiAgLyYjNDI7IFRoZSBhbmltYXRpb24gcHJlcGFyYXRpb24gY29kZSAmIzQyOy8KICogIG9wYWNpdHk6IDA7CiAqIH0KICAgKgogICAqIC8mIzQyOwogICAqICBLZWVwIGluIG1pbmQgdGhhdCB5b3Ugd2FudCB0byBjb21iaW5lIGJvdGggQ1NTCiAgICogIGNsYXNzZXMgdG9nZXRoZXIgdG8gYXZvaWQgYW55IENTUy1zcGVjaWZpY2l0eQogICAqICBjb25mbGljdHMKICAgKiAmIzQyOy8KICAgKiAucmV2ZWFsLWFuaW1hdGlvbi5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogKiAgLyYjNDI7IFRoZSBhbmltYXRpb24gY29kZSBpdHNlbGYgJiM0MjsvCiAqICBvcGFjaXR5OiAxOwogKiB9CiAgICogPC9zdHlsZT4KICAgKgogICAqIDxkaXYgY2xhc3M9InZpZXctY29udGFpbmVyIj4KICAgKiAgIDxkaXYgbmctdmlldyBjbGFzcz0icmV2ZWFsLWFuaW1hdGlvbiI+PC9kaXY+CiAgICogPC9kaXY+CiAgICogYGBgCiAgICoKICAgKiBUaGUgZm9sbG93aW5nIGNvZGUgYmVsb3cgZGVtb25zdHJhdGVzIGhvdyB0byBwZXJmb3JtIGFuaW1hdGlvbnMgdXNpbmcgKipDU1MgYW5pbWF0aW9ucyoqIHdpdGggQW5ndWxhcjoKICAgKgogICAqIGBgYGh0bWwKICAgKiA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgogICAqIC5yZXZlYWwtYW5pbWF0aW9uLm5nLWVudGVyIHsKICogICAtd2Via2l0LWFuaW1hdGlvbjogZW50ZXJfc2VxdWVuY2UgMXMgbGluZWFyOyAvJiM0MjsgU2FmYXJpL0Nocm9tZSAmIzQyOy8KICogICBhbmltYXRpb246IGVudGVyX3NlcXVlbmNlIDFzIGxpbmVhcjsgLyYjNDI7IElFMTArIGFuZCBGdXR1cmUgQnJvd3NlcnMgJiM0MjsvCiAqIH0KICAgKiBALXdlYmtpdC1rZXlmcmFtZXMgZW50ZXJfc2VxdWVuY2UgewogKiAgIGZyb20geyBvcGFjaXR5OjA7IH0KICogICB0byB7IG9wYWNpdHk6MTsgfQogKiB9CiAgICogQGtleWZyYW1lcyBlbnRlcl9zZXF1ZW5jZSB7CiAqICAgZnJvbSB7IG9wYWNpdHk6MDsgfQogKiAgIHRvIHsgb3BhY2l0eToxOyB9CiAqIH0KICAgKiA8L3N0eWxlPgogICAqCiAgICogPGRpdiBjbGFzcz0idmlldy1jb250YWluZXIiPgogICAqICAgPGRpdiBuZy12aWV3IGNsYXNzPSJyZXZlYWwtYW5pbWF0aW9uIj48L2Rpdj4KICAgKiA8L2Rpdj4KICAgKiBgYGAKICAgKgogICAqIEJvdGggQ1NTMyBhbmltYXRpb25zIGFuZCB0cmFuc2l0aW9ucyBjYW4gYmUgdXNlZCB0b2dldGhlciBhbmQgdGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIGZpZ3VyZSBvdXQgdGhlIGNvcnJlY3QgZHVyYXRpb24gYW5kIGRlbGF5IHRpbWluZy4KICAgKgogICAqIFVwb24gRE9NIG11dGF0aW9uLCB0aGUgZXZlbnQgY2xhc3MgaXMgYWRkZWQgZmlyc3QgKHNvbWV0aGluZyBsaWtlIGBuZy1lbnRlcmApLCB0aGVuIHRoZSBicm93c2VyIHByZXBhcmVzIGl0c2VsZiB0byBhZGQKICAgKiB0aGUgYWN0aXZlIGNsYXNzIChpbiB0aGlzIGNhc2UgYG5nLWVudGVyLWFjdGl2ZWApIHdoaWNoIHRoZW4gdHJpZ2dlcnMgdGhlIGFuaW1hdGlvbi4gVGhlIGFuaW1hdGlvbiBtb2R1bGUgd2lsbCBhdXRvbWF0aWNhbGx5CiAgICogZGV0ZWN0IHRoZSBDU1MgY29kZSB0byBkZXRlcm1pbmUgd2hlbiB0aGUgYW5pbWF0aW9uIGVuZHMuIE9uY2UgdGhlIGFuaW1hdGlvbiBpcyBvdmVyIHRoZW4gYm90aCBDU1MgY2xhc3NlcyB3aWxsIGJlCiAgICogcmVtb3ZlZCBmcm9tIHRoZSBET00uIElmIGEgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IENTUyB0cmFuc2l0aW9ucyBvciBDU1MgYW5pbWF0aW9ucyB0aGVuIHRoZSBhbmltYXRpb24gd2lsbCBzdGFydCBhbmQgZW5kCiAgICogaW1tZWRpYXRlbHkgcmVzdWx0aW5nIGluIGEgRE9NIGVsZW1lbnQgdGhhdCBpcyBhdCBpdHMgZmluYWwgc3RhdGUuIFRoaXMgZmluYWwgc3RhdGUgaXMgd2hlbiB0aGUgRE9NIGVsZW1lbnQKICAgKiBoYXMgbm8gQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGNsYXNzZXMgYXBwbGllZCB0byBpdC4KICAgKgogICAqIDxoMz5DU1MgU3RhZ2dlcmluZyBBbmltYXRpb25zPC9oMz4KICAgKiBBIFN0YWdnZXJpbmcgYW5pbWF0aW9uIGlzIGEgY29sbGVjdGlvbiBvZiBhbmltYXRpb25zIHRoYXQgYXJlIGlzc3VlZCB3aXRoIGEgc2xpZ2h0IGRlbGF5IGluIGJldHdlZW4gZWFjaCBzdWNjZXNzaXZlIG9wZXJhdGlvbiByZXN1bHRpbmcgaW4gYQogICAqIGN1cnRhaW4tbGlrZSBlZmZlY3QuIFRoZSBuZ0FuaW1hdGUgbW9kdWxlLCBhcyBvZiAxLjIuMCwgc3VwcG9ydHMgc3RhZ2dlcmluZyBhbmltYXRpb25zIGFuZCB0aGUgc3RhZ2dlciBlZmZlY3QgY2FuIGJlCiAgICogcGVyZm9ybWVkIGJ5IGNyZWF0aW5nIGEgKipuZy1FVkVOVC1zdGFnZ2VyKiogQ1NTIGNsYXNzIGFuZCBhdHRhY2hpbmcgdGhhdCBjbGFzcyB0byB0aGUgYmFzZSBDU1MgY2xhc3MgdXNlZCBmb3IKICAgKiB0aGUgYW5pbWF0aW9uLiBUaGUgc3R5bGUgcHJvcGVydHkgZXhwZWN0ZWQgd2l0aGluIHRoZSBzdGFnZ2VyIGNsYXNzIGNhbiBlaXRoZXIgYmUgYSAqKnRyYW5zaXRpb24tZGVsYXkqKiBvciBhbgogICAqICoqYW5pbWF0aW9uLWRlbGF5KiogcHJvcGVydHkgKG9yIGJvdGggaWYgeW91ciBhbmltYXRpb24gY29udGFpbnMgYm90aCB0cmFuc2l0aW9ucyBhbmQga2V5ZnJhbWUgYW5pbWF0aW9ucykuCiAgICoKICAgKiBgYGBjc3MKICAgKiAubXktYW5pbWF0aW9uLm5nLWVudGVyIHsKICogICAvJiM0Mjsgc3RhbmRhcmQgdHJhbnNpdGlvbiBjb2RlICYjNDI7LwogKiAgIC13ZWJraXQtdHJhbnNpdGlvbjogMXMgbGluZWFyIGFsbDsKICogICB0cmFuc2l0aW9uOiAxcyBsaW5lYXIgYWxsOwogKiAgIG9wYWNpdHk6MDsKICogfQogICAqIC5teS1hbmltYXRpb24ubmctZW50ZXItc3RhZ2dlciB7CiAqICAgLyYjNDI7IHRoaXMgd2lsbCBoYXZlIGEgMTAwbXMgZGVsYXkgYmV0d2VlbiBlYWNoIHN1Y2Nlc3NpdmUgbGVhdmUgYW5pbWF0aW9uICYjNDI7LwogKiAgIC13ZWJraXQtdHJhbnNpdGlvbi1kZWxheTogMC4xczsKICogICB0cmFuc2l0aW9uLWRlbGF5OiAwLjFzOwogKgogKiAgIC8mIzQyOyBpbiBjYXNlIHRoZSBzdGFnZ2VyIGRvZXNuJ3Qgd29yayB0aGVuIHRoZXNlIHR3byB2YWx1ZXMKICogICAgbXVzdCBiZSBzZXQgdG8gMCB0byBhdm9pZCBhbiBhY2NpZGVudGFsIENTUyBpbmhlcml0YW5jZSAmIzQyOy8KICogICAtd2Via2l0LXRyYW5zaXRpb24tZHVyYXRpb246IDBzOwogKiAgIHRyYW5zaXRpb24tZHVyYXRpb246IDBzOwogKiB9CiAgICogLm15LWFuaW1hdGlvbi5uZy1lbnRlci5uZy1lbnRlci1hY3RpdmUgewogKiAgIC8mIzQyOyBzdGFuZGFyZCB0cmFuc2l0aW9uIHN0eWxlcyAmIzQyOy8KICogICBvcGFjaXR5OjE7CiAqIH0KICAgKiBgYGAKICAgKgogICAqIFN0YWdnZXJpbmcgYW5pbWF0aW9ucyB3b3JrIGJ5IGRlZmF1bHQgaW4gbmdSZXBlYXQgKHNvIGxvbmcgYXMgdGhlIENTUyBjbGFzcyBpcyBkZWZpbmVkKS4gT3V0c2lkZSBvZiBuZ1JlcGVhdCwgdG8gdXNlIHN0YWdnZXJpbmcgYW5pbWF0aW9ucwogICAqIG9uIHlvdXIgb3duLCB0aGV5IGNhbiBiZSB0cmlnZ2VyZWQgYnkgZmlyaW5nIG11bHRpcGxlIGNhbGxzIHRvIHRoZSBzYW1lIGV2ZW50IG9uICRhbmltYXRlLiBIb3dldmVyLCB0aGUgcmVzdHJpY3Rpb25zIHN1cnJvdW5kaW5nIHRoaXMKICAgKiBhcmUgdGhhdCBlYWNoIG9mIHRoZSBlbGVtZW50cyBtdXN0IGhhdmUgdGhlIHNhbWUgQ1NTIGNsYXNzTmFtZSB2YWx1ZSBhcyB3ZWxsIGFzIHRoZSBzYW1lIHBhcmVudCBlbGVtZW50LiBBIHN0YWdnZXIgb3BlcmF0aW9uCiAgICogd2lsbCBhbHNvIGJlIHJlc2V0IGlmIG1vcmUgdGhhbiAxMG1zIGhhcyBwYXNzZWQgYWZ0ZXIgdGhlIGxhc3QgYW5pbWF0aW9uIGhhcyBiZWVuIGZpcmVkLgogICAqCiAgICogVGhlIGZvbGxvd2luZyBjb2RlIHdpbGwgaXNzdWUgdGhlICoqbmctbGVhdmUtc3RhZ2dlcioqIGV2ZW50IG9uIHRoZSBlbGVtZW50IHByb3ZpZGVkOgogICAqCiAgICogYGBganMKICAgKiB2YXIga2lkcyA9IHBhcmVudC5jaGlsZHJlbigpOwogICAqCiAgICogJGFuaW1hdGUubGVhdmUoa2lkc1swXSk7IC8vc3RhZ2dlciBpbmRleD0wCiAgICogJGFuaW1hdGUubGVhdmUoa2lkc1sxXSk7IC8vc3RhZ2dlciBpbmRleD0xCiAgICogJGFuaW1hdGUubGVhdmUoa2lkc1syXSk7IC8vc3RhZ2dlciBpbmRleD0yCiAgICogJGFuaW1hdGUubGVhdmUoa2lkc1szXSk7IC8vc3RhZ2dlciBpbmRleD0zCiAgICogJGFuaW1hdGUubGVhdmUoa2lkc1s0XSk7IC8vc3RhZ2dlciBpbmRleD00CiAgICoKICAgKiAkdGltZW91dChmdW5jdGlvbigpIHsKICogICAvL3N0YWdnZXIgaGFzIHJlc2V0IGl0c2VsZgogKiAgICRhbmltYXRlLmxlYXZlKGtpZHNbNV0pOyAvL3N0YWdnZXIgaW5kZXg9MAogKiAgICRhbmltYXRlLmxlYXZlKGtpZHNbNl0pOyAvL3N0YWdnZXIgaW5kZXg9MQogKiB9LCAxMDAsIGZhbHNlKTsKICAgKiBgYGAKICAgKgogICAqIFN0YWdnZXIgYW5pbWF0aW9ucyBhcmUgY3VycmVudGx5IG9ubHkgc3VwcG9ydGVkIHdpdGhpbiBDU1MtZGVmaW5lZCBhbmltYXRpb25zLgogICAqCiAgICogPGgyPkphdmFTY3JpcHQtZGVmaW5lZCBBbmltYXRpb25zPC9oMj4KICAgKiBJbiB0aGUgZXZlbnQgdGhhdCB5b3UgZG8gbm90IHdhbnQgdG8gdXNlIENTUzMgdHJhbnNpdGlvbnMgb3IgQ1NTMyBhbmltYXRpb25zIG9yIGlmIHlvdSB3aXNoIHRvIG9mZmVyIGFuaW1hdGlvbnMgb24gYnJvd3NlcnMgdGhhdCBkbyBub3QKICAgKiB5ZXQgc3VwcG9ydCBDU1MgdHJhbnNpdGlvbnMvYW5pbWF0aW9ucywgdGhlbiB5b3UgY2FuIG1ha2UgdXNlIG9mIEphdmFTY3JpcHQgYW5pbWF0aW9ucyBkZWZpbmVkIGluc2lkZSBvZiB5b3VyIEFuZ3VsYXJKUyBtb2R1bGUuCiAgICoKICAgKiBgYGBqcwogICAqIC8vIWFubm90YXRlPSJZb3VyQXBwIiBZb3VyIEFuZ3VsYXJKUyBNb2R1bGV8UmVwbGFjZSB0aGlzIG9yIG5nTW9kdWxlIHdpdGggdGhlIG1vZHVsZSB0aGF0IHlvdSB1c2VkIHRvIGRlZmluZSB5b3VyIGFwcGxpY2F0aW9uLgogICAqIHZhciBuZ01vZHVsZSA9IGFuZ3VsYXIubW9kdWxlKCdZb3VyQXBwJywgWyduZ0FuaW1hdGUnXSk7CiAgICogbmdNb2R1bGUuYW5pbWF0aW9uKCcubXktY3JhenktYW5pbWF0aW9uJywgZnVuY3Rpb24oKSB7CiAqICAgcmV0dXJuIHsKICogICAgIGVudGVyOiBmdW5jdGlvbihlbGVtZW50LCBkb25lKSB7CiAqICAgICAgIC8vcnVuIHRoZSBhbmltYXRpb24gaGVyZSBhbmQgY2FsbCBkb25lIHdoZW4gdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogKiAgICAgICByZXR1cm4gZnVuY3Rpb24oY2FuY2VsbGVkKSB7CiAqICAgICAgICAgLy90aGlzIChvcHRpb25hbCkgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgYW5pbWF0aW9uCiAqICAgICAgICAgLy9jb21wbGV0ZXMgb3Igd2hlbiB0aGUgYW5pbWF0aW9uIGlzIGNhbmNlbGxlZCAodGhlIGNhbmNlbGxlZAogKiAgICAgICAgIC8vZmxhZyB3aWxsIGJlIHNldCB0byB0cnVlIGlmIGNhbmNlbGxlZCkuCiAqICAgICAgIH07CiAqICAgICB9LAogKiAgICAgbGVhdmU6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsgfSwKICogICAgIG1vdmU6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmUpIHsgfSwKICoKICogICAgIC8vYW5pbWF0aW9uIHRoYXQgY2FuIGJlIHRyaWdnZXJlZCBiZWZvcmUgdGhlIGNsYXNzIGlzIGFkZGVkCiAqICAgICBiZWZvcmVBZGRDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7IH0sCiAqCiAqICAgICAvL2FuaW1hdGlvbiB0aGF0IGNhbiBiZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGNsYXNzIGlzIGFkZGVkCiAqICAgICBhZGRDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7IH0sCiAqCiAqICAgICAvL2FuaW1hdGlvbiB0aGF0IGNhbiBiZSB0cmlnZ2VyZWQgYmVmb3JlIHRoZSBjbGFzcyBpcyByZW1vdmVkCiAqICAgICBiZWZvcmVSZW1vdmVDbGFzczogZnVuY3Rpb24oZWxlbWVudCwgY2xhc3NOYW1lLCBkb25lKSB7IH0sCiAqCiAqICAgICAvL2FuaW1hdGlvbiB0aGF0IGNhbiBiZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGNsYXNzIGlzIHJlbW92ZWQKICogICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGRvbmUpIHsgfQogKiAgIH07CiAqIH0pOwogICAqIGBgYAogICAqCiAgICogSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgYXJlIGNyZWF0ZWQgd2l0aCBhIENTUy1saWtlIGNsYXNzIHNlbGVjdG9yIGFuZCBhIGNvbGxlY3Rpb24gb2YgZXZlbnRzIHdoaWNoIGFyZSBzZXQgdG8gcnVuCiAgICogYSBqYXZhc2NyaXB0IGNhbGxiYWNrIGZ1bmN0aW9uLiBXaGVuIGFuIGFuaW1hdGlvbiBpcyB0cmlnZ2VyZWQsICRhbmltYXRlIHdpbGwgbG9vayBmb3IgYSBtYXRjaGluZyBhbmltYXRpb24gd2hpY2ggZml0cwogICAqIHRoZSBlbGVtZW50J3MgQ1NTIGNsYXNzIGF0dHJpYnV0ZSB2YWx1ZSBhbmQgdGhlbiBydW4gdGhlIG1hdGNoaW5nIGFuaW1hdGlvbiBldmVudCBmdW5jdGlvbiAoaWYgZm91bmQpLgogICAqIEluIG90aGVyIHdvcmRzLCBpZiB0aGUgQ1NTIGNsYXNzZXMgcHJlc2VudCBvbiB0aGUgYW5pbWF0ZWQgZWxlbWVudCBtYXRjaCBhbnkgb2YgdGhlIEphdmFTY3JpcHQgYW5pbWF0aW9ucyB0aGVuIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aWxsCiAgICogYmUgZXhlY3V0ZWQuIEl0IHNob3VsZCBiZSBhbHNvIG5vdGVkIHRoYXQgb25seSBzaW1wbGUsIHNpbmdsZSBjbGFzcyBzZWxlY3RvcnMgYXJlIGFsbG93ZWQgKGNvbXBvdW5kIGNsYXNzIHNlbGVjdG9ycyBhcmUgbm90IHN1cHBvcnRlZCkuCiAgICoKICAgKiBXaXRoaW4gYSBKYXZhU2NyaXB0IGFuaW1hdGlvbiwgYW4gb2JqZWN0IGNvbnRhaW5pbmcgdmFyaW91cyBldmVudCBjYWxsYmFjayBhbmltYXRpb24gZnVuY3Rpb25zIGlzIGV4cGVjdGVkIHRvIGJlIHJldHVybmVkLgogICAqIEFzIGV4cGxhaW5lZCBhYm92ZSwgdGhlc2UgY2FsbGJhY2tzIGFyZSB0cmlnZ2VyZWQgYmFzZWQgb24gdGhlIGFuaW1hdGlvbiBldmVudC4gVGhlcmVmb3JlIGlmIGFuIGVudGVyIGFuaW1hdGlvbiBpcyBydW4sCiAgICogYW5kIHRoZSBKYXZhU2NyaXB0IGFuaW1hdGlvbiBpcyBmb3VuZCwgdGhlbiB0aGUgZW50ZXIgY2FsbGJhY2sgd2lsbCBoYW5kbGUgdGhhdCBhbmltYXRpb24gKGluIGFkZGl0aW9uIHRvIHRoZSBDU1Mga2V5ZnJhbWUgYW5pbWF0aW9uCiAgICogb3IgdHJhbnNpdGlvbiBjb2RlIHRoYXQgaXMgZGVmaW5lZCB2aWEgYSBzdHlsZXNoZWV0KS4KICAgKgogICAqLwoKICBhbmd1bGFyLm1vZHVsZSgnbmdBbmltYXRlJywgWyduZyddKQoKICAvKioKICAgKiBAbmdkb2MgcHJvdmlkZXIKICAgKiBAbmFtZSAkYW5pbWF0ZVByb3ZpZGVyCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBUaGUgYCRhbmltYXRlUHJvdmlkZXJgIGFsbG93cyBkZXZlbG9wZXJzIHRvIHJlZ2lzdGVyIEphdmFTY3JpcHQgYW5pbWF0aW9uIGV2ZW50IGhhbmRsZXJzIGRpcmVjdGx5IGluc2lkZSBvZiBhIG1vZHVsZS4KICAgKiBXaGVuIGFuIGFuaW1hdGlvbiBpcyB0cmlnZ2VyZWQsIHRoZSAkYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgcXVlcnkgdGhlICRhbmltYXRlIHNlcnZpY2UgdG8gZmluZCBhbnkgYW5pbWF0aW9ucyB0aGF0IG1hdGNoCiAgICogdGhlIHByb3ZpZGVkIG5hbWUgdmFsdWUuCiAgICoKICAgKiBSZXF1aXJlcyB0aGUge0BsaW5rIG5nQW5pbWF0ZSBgbmdBbmltYXRlYH0gbW9kdWxlIHRvIGJlIGluc3RhbGxlZC4KICAgKgogICAqIFBsZWFzZSB2aXNpdCB0aGUge0BsaW5rIG5nQW5pbWF0ZSBgbmdBbmltYXRlYH0gbW9kdWxlIG92ZXJ2aWV3IHBhZ2UgbGVhcm4gbW9yZSBhYm91dCBob3cgdG8gdXNlIGFuaW1hdGlvbnMgaW4geW91ciBhcHBsaWNhdGlvbi4KICAgKgogICAqLwoKICAgIC8vdGhpcyBwcml2YXRlIHNlcnZpY2UgaXMgb25seSB1c2VkIHdpdGhpbiBDU1MtZW5hYmxlZCBhbmltYXRpb25zCiAgICAvL0lFOCArIElFOSBkbyBub3Qgc3VwcG9ydCByQUYgbmF0aXZlbHksIGJ1dCB0aGF0IGlzIGZpbmUgc2luY2UgdGhleQogICAgLy9hbHNvIGRvbid0IHN1cHBvcnQgdHJhbnNpdGlvbnMgYW5kIGtleWZyYW1lcyB3aGljaCBtZWFucyB0aGF0IHRoZSBjb2RlCiAgICAvL2JlbG93IHdpbGwgbmV2ZXIgYmUgdXNlZCBieSB0aGUgdHdvIGJyb3dzZXJzLgogICAgLmZhY3RvcnkoJyQkYW5pbWF0ZVJlZmxvdycsIFsnJCRyQUYnLCAnJGRvY3VtZW50JywgZnVuY3Rpb24oJCRyQUYsICRkb2N1bWVudCkgewogICAgICB2YXIgYm9kID0gJGRvY3VtZW50WzBdLmJvZHk7CiAgICAgIHJldHVybiBmdW5jdGlvbihmbikgewogICAgICAgIC8vdGhlIHJldHVybmVkIGZ1bmN0aW9uIGFjdHMgYXMgdGhlIGNhbmNlbGxhdGlvbiBmdW5jdGlvbgogICAgICAgIHJldHVybiAkJHJBRihmdW5jdGlvbigpIHsKICAgICAgICAgIC8vdGhlIGxpbmUgYmVsb3cgd2lsbCBmb3JjZSB0aGUgYnJvd3NlciB0byBwZXJmb3JtIGEgcmVwYWludAogICAgICAgICAgLy9zbyB0aGF0IGFsbCB0aGUgYW5pbWF0ZWQgZWxlbWVudHMgd2l0aGluIHRoZSBhbmltYXRpb24gZnJhbWUKICAgICAgICAgIC8vd2lsbCBiZSBwcm9wZXJseSB1cGRhdGVkIGFuZCBkcmF3biBvbiBzY3JlZW4uIFRoaXMgaXMKICAgICAgICAgIC8vcmVxdWlyZWQgdG8gcGVyZm9ybSBtdWx0aS1jbGFzcyBDU1MgYmFzZWQgYW5pbWF0aW9ucyB3aXRoCiAgICAgICAgICAvL0ZpcmVmb3guIERPIE5PVCBSRU1PVkUgVEhJUyBMSU5FLgogICAgICAgICAgdmFyIGEgPSBib2Qub2Zmc2V0V2lkdGggKyAxOwogICAgICAgICAgZm4oKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH1dKQoKICAgIC5jb25maWcoWyckcHJvdmlkZScsICckYW5pbWF0ZVByb3ZpZGVyJywgZnVuY3Rpb24oJHByb3ZpZGUsICRhbmltYXRlUHJvdmlkZXIpIHsKICAgICAgdmFyIG5vb3AgPSBhbmd1bGFyLm5vb3A7CiAgICAgIHZhciBmb3JFYWNoID0gYW5ndWxhci5mb3JFYWNoOwogICAgICB2YXIgc2VsZWN0b3JzID0gJGFuaW1hdGVQcm92aWRlci4kJHNlbGVjdG9yczsKCiAgICAgIHZhciBFTEVNRU5UX05PREUgPSAxOwogICAgICB2YXIgTkdfQU5JTUFURV9TVEFURSA9ICckJG5nQW5pbWF0ZVN0YXRlJzsKICAgICAgdmFyIE5HX0FOSU1BVEVfQ0xBU1NfTkFNRSA9ICduZy1hbmltYXRlJzsKICAgICAgdmFyIHJvb3RBbmltYXRlU3RhdGUgPSB7cnVubmluZzogdHJ1ZX07CgogICAgICBmdW5jdGlvbiBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCkgewogICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBlbGVtZW50Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgZWxtID0gZWxlbWVudFtpXTsKICAgICAgICAgIGlmKGVsbS5ub2RlVHlwZSA9PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGVsbTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHByZXBhcmVFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICByZXR1cm4gZWxlbWVudCAmJiBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIHN0cmlwQ29tbWVudHNGcm9tRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgcmV0dXJuIGFuZ3VsYXIuZWxlbWVudChleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCkpOwogICAgICB9CgogICAgICBmdW5jdGlvbiBpc01hdGNoaW5nRWxlbWVudChlbG0xLCBlbG0yKSB7CiAgICAgICAgcmV0dXJuIGV4dHJhY3RFbGVtZW50Tm9kZShlbG0xKSA9PSBleHRyYWN0RWxlbWVudE5vZGUoZWxtMik7CiAgICAgIH0KCiAgICAgICRwcm92aWRlLmRlY29yYXRvcignJGFuaW1hdGUnLCBbJyRkZWxlZ2F0ZScsICckaW5qZWN0b3InLCAnJHNuaWZmZXInLCAnJHJvb3RFbGVtZW50JywgJyQkYXN5bmNDYWxsYmFjaycsICckcm9vdFNjb3BlJywgJyRkb2N1bWVudCcsCiAgICAgICAgZnVuY3Rpb24oJGRlbGVnYXRlLCAgICRpbmplY3RvciwgICAkc25pZmZlciwgICAkcm9vdEVsZW1lbnQsICAgJCRhc3luY0NhbGxiYWNrLCAgICAkcm9vdFNjb3BlLCAgICRkb2N1bWVudCkgewoKICAgICAgICAgIHZhciBnbG9iYWxBbmltYXRpb25Db3VudGVyID0gMDsKICAgICAgICAgICRyb290RWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUsIHJvb3RBbmltYXRlU3RhdGUpOwoKICAgICAgICAgIC8vIGRpc2FibGUgYW5pbWF0aW9ucyBkdXJpbmcgYm9vdHN0cmFwLCBidXQgb25jZSB3ZSBib290c3RyYXBwZWQsIHdhaXQgYWdhaW4KICAgICAgICAgIC8vIGZvciBhbm90aGVyIGRpZ2VzdCB1bnRpbCBlbmFibGluZyBhbmltYXRpb25zLiBUaGUgcmVhc29uIHdoeSB3ZSBkaWdlc3QgdHdpY2UKICAgICAgICAgIC8vIGlzIGJlY2F1c2UgYWxsIHN0cnVjdHVyYWwgYW5pbWF0aW9ucyAoZW50ZXIsIGxlYXZlIGFuZCBtb3ZlKSBhbGwgcGVyZm9ybSBhCiAgICAgICAgICAvLyBwb3N0IGRpZ2VzdCBvcGVyYXRpb24gYmVmb3JlIGFuaW1hdGluZy4gSWYgd2Ugb25seSB3YWl0IGZvciBhIHNpbmdsZSBkaWdlc3QKICAgICAgICAgIC8vIHRvIHBhc3MgdGhlbiB0aGUgc3RydWN0dXJhbCBhbmltYXRpb24gd291bGQgcmVuZGVyIGl0cyBhbmltYXRpb24gb24gcGFnZSBsb2FkLgogICAgICAgICAgLy8gKHdoaWNoIGlzIHdoYXQgd2UncmUgdHJ5aW5nIHRvIGF2b2lkIHdoZW4gdGhlIGFwcGxpY2F0aW9uIGZpcnN0IGJvb3RzIHVwLikKICAgICAgICAgICRyb290U2NvcGUuJCRwb3N0RGlnZXN0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkcm9vdFNjb3BlLiQkcG9zdERpZ2VzdChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByb290QW5pbWF0ZVN0YXRlLnJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB2YXIgY2xhc3NOYW1lRmlsdGVyID0gJGFuaW1hdGVQcm92aWRlci5jbGFzc05hbWVGaWx0ZXIoKTsKICAgICAgICAgIHZhciBpc0FuaW1hdGFibGVDbGFzc05hbWUgPSAhY2xhc3NOYW1lRmlsdGVyCiAgICAgICAgICAgID8gZnVuY3Rpb24oKSB7IHJldHVybiB0cnVlOyB9CiAgICAgICAgICAgIDogZnVuY3Rpb24oY2xhc3NOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBjbGFzc05hbWVGaWx0ZXIudGVzdChjbGFzc05hbWUpOwogICAgICAgICAgfTsKCiAgICAgICAgICBmdW5jdGlvbiBsb29rdXAobmFtZSkgewogICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgIHZhciBtYXRjaGVzID0gW10sCiAgICAgICAgICAgICAgICBmbGFnTWFwID0ge30sCiAgICAgICAgICAgICAgICBjbGFzc2VzID0gbmFtZS5zdWJzdHIoMSkuc3BsaXQoJy4nKTsKCiAgICAgICAgICAgICAgLy90aGUgZW1wdHkgc3RyaW5nIHZhbHVlIGlzIHRoZSBkZWZhdWx0IGFuaW1hdGlvbgogICAgICAgICAgICAgIC8vb3BlcmF0aW9uIHdoaWNoIHBlcmZvcm1zIENTUyB0cmFuc2l0aW9uIGFuZCBrZXlmcmFtZQogICAgICAgICAgICAgIC8vYW5pbWF0aW9ucyBzbmlmZmluZy4gVGhpcyBpcyBhbHdheXMgaW5jbHVkZWQgZm9yIGVhY2gKICAgICAgICAgICAgICAvL2VsZW1lbnQgYW5pbWF0aW9uIHByb2NlZHVyZSBpZiB0aGUgYnJvd3NlciBzdXBwb3J0cwogICAgICAgICAgICAgIC8vdHJhbnNpdGlvbnMgYW5kL29yIGtleWZyYW1lIGFuaW1hdGlvbnMuIFRoZSBkZWZhdWx0CiAgICAgICAgICAgICAgLy9hbmltYXRpb24gaXMgYWRkZWQgdG8gdGhlIHRvcCBvZiB0aGUgbGlzdCB0byBwcmV2ZW50CiAgICAgICAgICAgICAgLy9hbnkgcHJldmlvdXMgYW5pbWF0aW9ucyBmcm9tIGFmZmVjdGluZyB0aGUgZWxlbWVudCBzdHlsaW5nCiAgICAgICAgICAgICAgLy9wcmlvciB0byB0aGUgZWxlbWVudCBiZWluZyBhbmltYXRlZC4KICAgICAgICAgICAgICBpZiAoJHNuaWZmZXIudHJhbnNpdGlvbnMgfHwgJHNuaWZmZXIuYW5pbWF0aW9ucykgewogICAgICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKCRpbmplY3Rvci5nZXQoc2VsZWN0b3JzWycnXSkpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZm9yKHZhciBpPTA7IGkgPCBjbGFzc2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIga2xhc3MgPSBjbGFzc2VzW2ldLAogICAgICAgICAgICAgICAgICBzZWxlY3RvckZhY3RvcnlOYW1lID0gc2VsZWN0b3JzW2tsYXNzXTsKICAgICAgICAgICAgICAgIGlmKHNlbGVjdG9yRmFjdG9yeU5hbWUgJiYgIWZsYWdNYXBba2xhc3NdKSB7CiAgICAgICAgICAgICAgICAgIG1hdGNoZXMucHVzaCgkaW5qZWN0b3IuZ2V0KHNlbGVjdG9yRmFjdG9yeU5hbWUpKTsKICAgICAgICAgICAgICAgICAgZmxhZ01hcFtrbGFzc10gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hlczsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGFuaW1hdGlvblJ1bm5lcihlbGVtZW50LCBhbmltYXRpb25FdmVudCwgY2xhc3NOYW1lKSB7CiAgICAgICAgICAgIC8vdHJhbnNjbHVkZWQgZGlyZWN0aXZlcyBtYXkgc29tZXRpbWVzIGZpcmUgYW4gYW5pbWF0aW9uIHVzaW5nIG9ubHkgY29tbWVudCBub2RlcwogICAgICAgICAgICAvL2Jlc3QgdG8gY2F0Y2ggdGhpcyBlYXJseSBvbiB0byBwcmV2ZW50IGFueSBhbmltYXRpb24gb3BlcmF0aW9ucyBmcm9tIG9jY3VycmluZwogICAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnRbMF07CiAgICAgICAgICAgIGlmKCFub2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgaXNTZXRDbGFzc09wZXJhdGlvbiA9IGFuaW1hdGlvbkV2ZW50ID09ICdzZXRDbGFzcyc7CiAgICAgICAgICAgIHZhciBpc0NsYXNzQmFzZWQgPSBpc1NldENsYXNzT3BlcmF0aW9uIHx8CiAgICAgICAgICAgICAgYW5pbWF0aW9uRXZlbnQgPT0gJ2FkZENsYXNzJyB8fAogICAgICAgICAgICAgIGFuaW1hdGlvbkV2ZW50ID09ICdyZW1vdmVDbGFzcyc7CgogICAgICAgICAgICB2YXIgY2xhc3NOYW1lQWRkLCBjbGFzc05hbWVSZW1vdmU7CiAgICAgICAgICAgIGlmKGFuZ3VsYXIuaXNBcnJheShjbGFzc05hbWUpKSB7CiAgICAgICAgICAgICAgY2xhc3NOYW1lQWRkID0gY2xhc3NOYW1lWzBdOwogICAgICAgICAgICAgIGNsYXNzTmFtZVJlbW92ZSA9IGNsYXNzTmFtZVsxXTsKICAgICAgICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWVBZGQgKyAnICcgKyBjbGFzc05hbWVSZW1vdmU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBjdXJyZW50Q2xhc3NOYW1lID0gZWxlbWVudC5hdHRyKCdjbGFzcycpOwogICAgICAgICAgICB2YXIgY2xhc3NlcyA9IGN1cnJlbnRDbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWU7CiAgICAgICAgICAgIGlmKCFpc0FuaW1hdGFibGVDbGFzc05hbWUoY2xhc3NlcykpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBiZWZvcmVDb21wbGV0ZSA9IG5vb3AsCiAgICAgICAgICAgICAgYmVmb3JlQ2FuY2VsID0gW10sCiAgICAgICAgICAgICAgYmVmb3JlID0gW10sCiAgICAgICAgICAgICAgYWZ0ZXJDb21wbGV0ZSA9IG5vb3AsCiAgICAgICAgICAgICAgYWZ0ZXJDYW5jZWwgPSBbXSwKICAgICAgICAgICAgICBhZnRlciA9IFtdOwoKICAgICAgICAgICAgdmFyIGFuaW1hdGlvbkxvb2t1cCA9ICgnICcgKyBjbGFzc2VzKS5yZXBsYWNlKC9ccysvZywnLicpOwogICAgICAgICAgICBmb3JFYWNoKGxvb2t1cChhbmltYXRpb25Mb29rdXApLCBmdW5jdGlvbihhbmltYXRpb25GYWN0b3J5KSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSByZWdpc3RlckFuaW1hdGlvbihhbmltYXRpb25GYWN0b3J5LCBhbmltYXRpb25FdmVudCk7CiAgICAgICAgICAgICAgaWYoIWNyZWF0ZWQgJiYgaXNTZXRDbGFzc09wZXJhdGlvbikgewogICAgICAgICAgICAgICAgcmVnaXN0ZXJBbmltYXRpb24oYW5pbWF0aW9uRmFjdG9yeSwgJ2FkZENsYXNzJyk7CiAgICAgICAgICAgICAgICByZWdpc3RlckFuaW1hdGlvbihhbmltYXRpb25GYWN0b3J5LCAncmVtb3ZlQ2xhc3MnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJBbmltYXRpb24oYW5pbWF0aW9uRmFjdG9yeSwgZXZlbnQpIHsKICAgICAgICAgICAgICB2YXIgYWZ0ZXJGbiA9IGFuaW1hdGlvbkZhY3RvcnlbZXZlbnRdOwogICAgICAgICAgICAgIHZhciBiZWZvcmVGbiA9IGFuaW1hdGlvbkZhY3RvcnlbJ2JlZm9yZScgKyBldmVudC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGV2ZW50LnN1YnN0cigxKV07CiAgICAgICAgICAgICAgaWYoYWZ0ZXJGbiB8fCBiZWZvcmVGbikgewogICAgICAgICAgICAgICAgaWYoZXZlbnQgPT0gJ2xlYXZlJykgewogICAgICAgICAgICAgICAgICBiZWZvcmVGbiA9IGFmdGVyRm47CiAgICAgICAgICAgICAgICAgIC8vd2hlbiBzZXQgYXMgbnVsbCB0aGVuIGFuaW1hdGlvbiBrbm93cyB0byBza2lwIHRoaXMgcGhhc2UKICAgICAgICAgICAgICAgICAgYWZ0ZXJGbiA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhZnRlci5wdXNoKHsKICAgICAgICAgICAgICAgICAgZXZlbnQgOiBldmVudCwgZm4gOiBhZnRlckZuCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGJlZm9yZS5wdXNoKHsKICAgICAgICAgICAgICAgICAgZXZlbnQgOiBldmVudCwgZm4gOiBiZWZvcmVGbgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHJ1bihmbnMsIGNhbmNlbGxhdGlvbnMsIGFsbENvbXBsZXRlRm4pIHsKICAgICAgICAgICAgICB2YXIgYW5pbWF0aW9ucyA9IFtdOwogICAgICAgICAgICAgIGZvckVhY2goZm5zLCBmdW5jdGlvbihhbmltYXRpb24pIHsKICAgICAgICAgICAgICAgIGFuaW1hdGlvbi5mbiAmJiBhbmltYXRpb25zLnB1c2goYW5pbWF0aW9uKTsKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgdmFyIGNvdW50ID0gMDsKICAgICAgICAgICAgICBmdW5jdGlvbiBhZnRlckFuaW1hdGlvbkNvbXBsZXRlKGluZGV4KSB7CiAgICAgICAgICAgICAgICBpZihjYW5jZWxsYXRpb25zKSB7CiAgICAgICAgICAgICAgICAgIChjYW5jZWxsYXRpb25zW2luZGV4XSB8fCBub29wKSgpOwogICAgICAgICAgICAgICAgICBpZigrK2NvdW50IDwgYW5pbWF0aW9ucy5sZW5ndGgpIHJldHVybjsKICAgICAgICAgICAgICAgICAgY2FuY2VsbGF0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhbGxDb21wbGV0ZUZuKCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvL1RoZSBjb2RlIGJlbG93IGFkZHMgZGlyZWN0bHkgdG8gdGhlIGFycmF5IGluIG9yZGVyIHRvIHdvcmsgd2l0aAogICAgICAgICAgICAgIC8vYm90aCBzeW5jIGFuZCBhc3luYyBhbmltYXRpb25zLiBTeW5jIGFuaW1hdGlvbnMgYXJlIHdoZW4gdGhlIGRvbmUoKQogICAgICAgICAgICAgIC8vb3BlcmF0aW9uIGlzIGNhbGxlZCByaWdodCBhd2F5LiBETyBOT1QgUkVGQUNUT1IhCiAgICAgICAgICAgICAgZm9yRWFjaChhbmltYXRpb25zLCBmdW5jdGlvbihhbmltYXRpb24sIGluZGV4KSB7CiAgICAgICAgICAgICAgICB2YXIgcHJvZ3Jlc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgYWZ0ZXJBbmltYXRpb25Db21wbGV0ZShpbmRleCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgc3dpdGNoKGFuaW1hdGlvbi5ldmVudCkgewogICAgICAgICAgICAgICAgICBjYXNlICdzZXRDbGFzcyc6CiAgICAgICAgICAgICAgICAgICAgY2FuY2VsbGF0aW9ucy5wdXNoKGFuaW1hdGlvbi5mbihlbGVtZW50LCBjbGFzc05hbWVBZGQsIGNsYXNzTmFtZVJlbW92ZSwgcHJvZ3Jlc3MpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAnYWRkQ2xhc3MnOgogICAgICAgICAgICAgICAgICAgIGNhbmNlbGxhdGlvbnMucHVzaChhbmltYXRpb24uZm4oZWxlbWVudCwgY2xhc3NOYW1lQWRkIHx8IGNsYXNzTmFtZSwgICAgIHByb2dyZXNzKSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgJ3JlbW92ZUNsYXNzJzoKICAgICAgICAgICAgICAgICAgICBjYW5jZWxsYXRpb25zLnB1c2goYW5pbWF0aW9uLmZuKGVsZW1lbnQsIGNsYXNzTmFtZVJlbW92ZSB8fCBjbGFzc05hbWUsICBwcm9ncmVzcykpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGNhbmNlbGxhdGlvbnMucHVzaChhbmltYXRpb24uZm4oZWxlbWVudCwgcHJvZ3Jlc3MpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgaWYoY2FuY2VsbGF0aW9ucyAmJiBjYW5jZWxsYXRpb25zLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgYWxsQ29tcGxldGVGbigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBub2RlIDogbm9kZSwKICAgICAgICAgICAgICBldmVudCA6IGFuaW1hdGlvbkV2ZW50LAogICAgICAgICAgICAgIGNsYXNzTmFtZSA6IGNsYXNzTmFtZSwKICAgICAgICAgICAgICBpc0NsYXNzQmFzZWQgOiBpc0NsYXNzQmFzZWQsCiAgICAgICAgICAgICAgaXNTZXRDbGFzc09wZXJhdGlvbiA6IGlzU2V0Q2xhc3NPcGVyYXRpb24sCiAgICAgICAgICAgICAgYmVmb3JlIDogZnVuY3Rpb24oYWxsQ29tcGxldGVGbikgewogICAgICAgICAgICAgICAgYmVmb3JlQ29tcGxldGUgPSBhbGxDb21wbGV0ZUZuOwogICAgICAgICAgICAgICAgcnVuKGJlZm9yZSwgYmVmb3JlQ2FuY2VsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgYmVmb3JlQ29tcGxldGUgPSBub29wOwogICAgICAgICAgICAgICAgICBhbGxDb21wbGV0ZUZuKCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGFmdGVyIDogZnVuY3Rpb24oYWxsQ29tcGxldGVGbikgewogICAgICAgICAgICAgICAgYWZ0ZXJDb21wbGV0ZSA9IGFsbENvbXBsZXRlRm47CiAgICAgICAgICAgICAgICBydW4oYWZ0ZXIsIGFmdGVyQ2FuY2VsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgYWZ0ZXJDb21wbGV0ZSA9IG5vb3A7CiAgICAgICAgICAgICAgICAgIGFsbENvbXBsZXRlRm4oKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgY2FuY2VsIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZihiZWZvcmVDYW5jZWwpIHsKICAgICAgICAgICAgICAgICAgZm9yRWFjaChiZWZvcmVDYW5jZWwsIGZ1bmN0aW9uKGNhbmNlbEZuKSB7CiAgICAgICAgICAgICAgICAgICAgKGNhbmNlbEZuIHx8IG5vb3ApKHRydWUpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgYmVmb3JlQ29tcGxldGUodHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihhZnRlckNhbmNlbCkgewogICAgICAgICAgICAgICAgICBmb3JFYWNoKGFmdGVyQ2FuY2VsLCBmdW5jdGlvbihjYW5jZWxGbikgewogICAgICAgICAgICAgICAgICAgIChjYW5jZWxGbiB8fCBub29wKSh0cnVlKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIGFmdGVyQ29tcGxldGUodHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAgICAgICAqIEBuYW1lICRhbmltYXRlCiAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICoKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogVGhlIGAkYW5pbWF0ZWAgc2VydmljZSBwcm92aWRlcyBhbmltYXRpb24gZGV0ZWN0aW9uIHN1cHBvcnQgd2hpbGUgcGVyZm9ybWluZyBET00gb3BlcmF0aW9ucyAoZW50ZXIsIGxlYXZlIGFuZCBtb3ZlKSBhcyB3ZWxsIGFzIGR1cmluZyBhZGRDbGFzcyBhbmQgcmVtb3ZlQ2xhc3Mgb3BlcmF0aW9ucy4KICAgICAgICAgICAqIFdoZW4gYW55IG9mIHRoZXNlIG9wZXJhdGlvbnMgYXJlIHJ1biwgdGhlICRhbmltYXRlIHNlcnZpY2UKICAgICAgICAgICAqIHdpbGwgZXhhbWluZSBhbnkgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgKHdoaWNoIGFyZSBkZWZpbmVkIGJ5IHVzaW5nIHRoZSAkYW5pbWF0ZVByb3ZpZGVyIHByb3ZpZGVyIG9iamVjdCkKICAgICAgICAgICAqIGFzIHdlbGwgYXMgYW55IENTUy1kZWZpbmVkIGFuaW1hdGlvbnMgYWdhaW5zdCB0aGUgQ1NTIGNsYXNzZXMgcHJlc2VudCBvbiB0aGUgZWxlbWVudCBvbmNlIHRoZSBET00gb3BlcmF0aW9uIGlzIHJ1bi4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBUaGUgYCRhbmltYXRlYCBzZXJ2aWNlIGlzIHVzZWQgYmVoaW5kIHRoZSBzY2VuZXMgd2l0aCBwcmUtZXhpc3RpbmcgZGlyZWN0aXZlcyBhbmQgYW5pbWF0aW9uIHdpdGggdGhlc2UgZGlyZWN0aXZlcwogICAgICAgICAgICogd2lsbCB3b3JrIG91dCBvZiB0aGUgYm94IHdpdGhvdXQgYW55IGV4dHJhIGNvbmZpZ3VyYXRpb24uCiAgICAgICAgICAgKgogICAgICAgICAgICogUmVxdWlyZXMgdGhlIHtAbGluayBuZ0FuaW1hdGUgYG5nQW5pbWF0ZWB9IG1vZHVsZSB0byBiZSBpbnN0YWxsZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogUGxlYXNlIHZpc2l0IHRoZSB7QGxpbmsgbmdBbmltYXRlIGBuZ0FuaW1hdGVgfSBtb2R1bGUgb3ZlcnZpZXcgcGFnZSBsZWFybiBtb3JlIGFib3V0IGhvdyB0byB1c2UgYW5pbWF0aW9ucyBpbiB5b3VyIGFwcGxpY2F0aW9uLgogICAgICAgICAgICoKICAgICAgICAgICAqLwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjZW50ZXIKICAgICAgICAgICAgICogQGtpbmQgZnVuY3Rpb24KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIEFwcGVuZHMgdGhlIGVsZW1lbnQgdG8gdGhlIHBhcmVudEVsZW1lbnQgZWxlbWVudCB0aGF0IHJlc2lkZXMgaW4gdGhlIGRvY3VtZW50IGFuZCB0aGVuIHJ1bnMgdGhlIGVudGVyIGFuaW1hdGlvbi4gT25jZQogICAgICAgICAgICAgKiB0aGUgYW5pbWF0aW9uIGlzIHN0YXJ0ZWQsIHRoZSBmb2xsb3dpbmcgQ1NTIGNsYXNzZXMgd2lsbCBiZSBwcmVzZW50IG9uIHRoZSBlbGVtZW50IGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIGFuaW1hdGlvbjoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQmVsb3cgaXMgYSBicmVha2Rvd24gb2YgZWFjaCBzdGVwIHRoYXQgb2NjdXJzIGR1cmluZyBlbnRlciBhbmltYXRpb246CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBXaGF0IHRoZSBlbGVtZW50IGNsYXNzIGF0dHJpYnV0ZSBsb29rcyBsaWtlIHwKICAgICAgICAgICAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAgICAgKiB8IDEuICRhbmltYXRlLmVudGVyKC4uLikgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgMi4gZWxlbWVudCBpcyBpbnNlcnRlZCBpbnRvIHRoZSBwYXJlbnRFbGVtZW50IGVsZW1lbnQgb3IgYmVzaWRlIHRoZSBhZnRlckVsZW1lbnQgZWxlbWVudCAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCAzLiAkYW5pbWF0ZSBydW5zIGFueSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSIgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiB8IDQuIHRoZSAubmctZW50ZXIgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWVudGVyIiAgICB8CiAgICAgICAgICAgICAqIHwgNS4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctZW50ZXIiICAgIHwKICAgICAgICAgICAgICogfCA2LiAkYW5pbWF0ZSB3YWl0cyBmb3IgMTBtcyAodGhpcyBwZXJmb3JtcyBhIHJlZmxvdykgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1lbnRlciIgICAgfAogICAgICAgICAgICAgKiB8IDcuIHRoZSAubmctZW50ZXItYWN0aXZlIGFuZCAubmctYW5pbWF0ZS1hY3RpdmUgY2xhc3NlcyBhcmUgYWRkZWQgKHRoaXMgdHJpZ2dlcnMgdGhlIENTUyB0cmFuc2l0aW9uL2FuaW1hdGlvbikgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctYW5pbWF0ZS1hY3RpdmUgbmctZW50ZXIgbmctZW50ZXItYWN0aXZlIiB8CiAgICAgICAgICAgICAqIHwgOC4gJGFuaW1hdGUgd2FpdHMgZm9yIFggbWlsbGlzZWNvbmRzIGZvciB0aGUgYW5pbWF0aW9uIHRvIGNvbXBsZXRlICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctYW5pbWF0ZS1hY3RpdmUgbmctZW50ZXIgbmctZW50ZXItYWN0aXZlIiB8CiAgICAgICAgICAgICAqIHwgOS4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCAxMC4gVGhlIGRvbmVDYWxsYmFjaygpIGNhbGxiYWNrIGlzIGZpcmVkIChpZiBwcm92aWRlZCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgZW50ZXIgYW5pbWF0aW9uCiAgICAgICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gcGFyZW50RWxlbWVudCB0aGUgcGFyZW50IGVsZW1lbnQgb2YgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgZW50ZXIgYW5pbWF0aW9uCiAgICAgICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gYWZ0ZXJFbGVtZW50IHRoZSBzaWJsaW5nIGVsZW1lbnQgKHdoaWNoIGlzIHRoZSBwcmV2aW91cyBlbGVtZW50KSBvZiB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlIGZvY3VzIG9mIHRoZSBlbnRlciBhbmltYXRpb24KICAgICAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbigpPX0gZG9uZUNhbGxiYWNrIHRoZSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uY2UgdGhlIGFuaW1hdGlvbiBpcyBjb21wbGV0ZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZW50ZXIgOiBmdW5jdGlvbihlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQsIGRvbmVDYWxsYmFjaykgewogICAgICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgcGFyZW50RWxlbWVudCA9IHByZXBhcmVFbGVtZW50KHBhcmVudEVsZW1lbnQpOwogICAgICAgICAgICAgIGFmdGVyRWxlbWVudCA9IHByZXBhcmVFbGVtZW50KGFmdGVyRWxlbWVudCk7CgogICAgICAgICAgICAgIHRoaXMuZW5hYmxlZChmYWxzZSwgZWxlbWVudCk7CiAgICAgICAgICAgICAgJGRlbGVnYXRlLmVudGVyKGVsZW1lbnQsIHBhcmVudEVsZW1lbnQsIGFmdGVyRWxlbWVudCk7CiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50ID0gc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgcGVyZm9ybUFuaW1hdGlvbignZW50ZXInLCAnbmctZW50ZXInLCBlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQsIG5vb3AsIGRvbmVDYWxsYmFjayk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNsZWF2ZQogICAgICAgICAgICAgKiBAa2luZCBmdW5jdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogUnVucyB0aGUgbGVhdmUgYW5pbWF0aW9uIG9wZXJhdGlvbiBhbmQsIHVwb24gY29tcGxldGlvbiwgcmVtb3ZlcyB0aGUgZWxlbWVudCBmcm9tIHRoZSBET00uIE9uY2UKICAgICAgICAgICAgICogdGhlIGFuaW1hdGlvbiBpcyBzdGFydGVkLCB0aGUgZm9sbG93aW5nIENTUyBjbGFzc2VzIHdpbGwgYmUgYWRkZWQgZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgYW5pbWF0aW9uOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBCZWxvdyBpcyBhIGJyZWFrZG93biBvZiBlYWNoIHN0ZXAgdGhhdCBvY2N1cnMgZHVyaW5nIGxlYXZlIGFuaW1hdGlvbjoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogfCBBbmltYXRpb24gU3RlcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IFdoYXQgdGhlIGVsZW1lbnQgY2xhc3MgYXR0cmlidXRlIGxvb2tzIGxpa2UgfAogICAgICAgICAgICAgKiB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICAgICAqIHwgMS4gJGFuaW1hdGUubGVhdmUoLi4uKSBpcyBjYWxsZWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCAyLiAkYW5pbWF0ZSBydW5zIGFueSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSIgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiB8IDMuIHRoZSAubmctbGVhdmUgY2xhc3MgaXMgYWRkZWQgdG8gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWxlYXZlIiAgICB8CiAgICAgICAgICAgICAqIHwgNC4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbGVhdmUiICAgIHwKICAgICAgICAgICAgICogfCA1LiAkYW5pbWF0ZSB3YWl0cyBmb3IgMTBtcyAodGhpcyBwZXJmb3JtcyBhIHJlZmxvdykgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1sZWF2ZSIgICAgfAogICAgICAgICAgICAgKiB8IDYuIHRoZSAubmctbGVhdmUtYWN0aXZlIGFuZCAubmctYW5pbWF0ZS1hY3RpdmUgY2xhc3NlcyBpcyBhZGRlZCAodGhpcyB0cmlnZ2VycyB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uKSB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBuZy1sZWF2ZSBuZy1sZWF2ZS1hY3RpdmUiIHwKICAgICAgICAgICAgICogfCA3LiAkYW5pbWF0ZSB3YWl0cyBmb3IgWCBtaWxsaXNlY29uZHMgZm9yIHRoZSBhbmltYXRpb24gdG8gY29tcGxldGUgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBuZy1sZWF2ZSBuZy1sZWF2ZS1hY3RpdmUiIHwKICAgICAgICAgICAgICogfCA4LiBUaGUgYW5pbWF0aW9uIGVuZHMgYW5kIGFsbCBnZW5lcmF0ZWQgQ1NTIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudCAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiB8IDkuIFRoZSBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSB0aGUgRE9NICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgLi4uICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgMTAuIFRoZSBkb25lQ2FsbGJhY2soKSBjYWxsYmFjayBpcyBmaXJlZCAoaWYgcHJvdmlkZWQpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCAuLi4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIGxlYXZlIGFuaW1hdGlvbgogICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCk9fSBkb25lQ2FsbGJhY2sgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgb25jZSB0aGUgYW5pbWF0aW9uIGlzIGNvbXBsZXRlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBsZWF2ZSA6IGZ1bmN0aW9uKGVsZW1lbnQsIGRvbmVDYWxsYmFjaykgewogICAgICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgY2FuY2VsQ2hpbGRBbmltYXRpb25zKGVsZW1lbnQpOwogICAgICAgICAgICAgIHRoaXMuZW5hYmxlZChmYWxzZSwgZWxlbWVudCk7CiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBwZXJmb3JtQW5pbWF0aW9uKCdsZWF2ZScsICduZy1sZWF2ZScsIHN0cmlwQ29tbWVudHNGcm9tRWxlbWVudChlbGVtZW50KSwgbnVsbCwgbnVsbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICRkZWxlZ2F0ZS5sZWF2ZShlbGVtZW50KTsKICAgICAgICAgICAgICAgIH0sIGRvbmVDYWxsYmFjayk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNtb3ZlCiAgICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBGaXJlcyB0aGUgbW92ZSBET00gb3BlcmF0aW9uLiBKdXN0IGJlZm9yZSB0aGUgYW5pbWF0aW9uIHN0YXJ0cywgdGhlIGFuaW1hdGUgc2VydmljZSB3aWxsIGVpdGhlciBhcHBlbmQgaXQgaW50byB0aGUgcGFyZW50RWxlbWVudCBjb250YWluZXIgb3IKICAgICAgICAgICAgICogYWRkIHRoZSBlbGVtZW50IGRpcmVjdGx5IGFmdGVyIHRoZSBhZnRlckVsZW1lbnQgZWxlbWVudCBpZiBwcmVzZW50LiBUaGVuIHRoZSBtb3ZlIGFuaW1hdGlvbiB3aWxsIGJlIHJ1bi4gT25jZQogICAgICAgICAgICAgKiB0aGUgYW5pbWF0aW9uIGlzIHN0YXJ0ZWQsIHRoZSBmb2xsb3dpbmcgQ1NTIGNsYXNzZXMgd2lsbCBiZSBhZGRlZCBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSBhbmltYXRpb246CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEJlbG93IGlzIGEgYnJlYWtkb3duIG9mIGVhY2ggc3RlcCB0aGF0IG9jY3VycyBkdXJpbmcgbW92ZSBhbmltYXRpb246CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIHwgQW5pbWF0aW9uIFN0ZXAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBXaGF0IHRoZSBlbGVtZW50IGNsYXNzIGF0dHJpYnV0ZSBsb29rcyBsaWtlIHwKICAgICAgICAgICAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAgICAgICAgKiB8IDEuICRhbmltYXRlLm1vdmUoLi4uKSBpcyBjYWxsZWQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiIgICAgICAgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgMi4gZWxlbWVudCBpcyBtb3ZlZCBpbnRvIHRoZSBwYXJlbnRFbGVtZW50IGVsZW1lbnQgb3IgYmVzaWRlIHRoZSBhZnRlckVsZW1lbnQgZWxlbWVudCAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCAzLiAkYW5pbWF0ZSBydW5zIGFueSBKYXZhU2NyaXB0LWRlZmluZWQgYW5pbWF0aW9ucyBvbiB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSIgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiB8IDQuIHRoZSAubmctbW92ZSBjbGFzcyBpcyBhZGRlZCB0byB0aGUgZWxlbWVudCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLW1vdmUiICAgICB8CiAgICAgICAgICAgICAqIHwgNS4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgbmctbW92ZSIgICAgIHwKICAgICAgICAgICAgICogfCA2LiAkYW5pbWF0ZSB3YWl0cyBmb3IgMTBtcyAodGhpcyBwZXJmb3JtcyBhIHJlZmxvdykgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1tb3ZlIiAgICAgfAogICAgICAgICAgICAgKiB8IDcuIHRoZSAubmctbW92ZS1hY3RpdmUgYW5kIC5uZy1hbmltYXRlLWFjdGl2ZSBjbGFzc2VzIGlzIGFkZGVkICh0aGlzIHRyaWdnZXJzIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24pIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWFuaW1hdGUtYWN0aXZlIG5nLW1vdmUgbmctbW92ZS1hY3RpdmUiIHwKICAgICAgICAgICAgICogfCA4LiAkYW5pbWF0ZSB3YWl0cyBmb3IgWCBtaWxsaXNlY29uZHMgZm9yIHRoZSBhbmltYXRpb24gdG8gY29tcGxldGUgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBuZy1hbmltYXRlLWFjdGl2ZSBuZy1tb3ZlIG5nLW1vdmUtYWN0aXZlIiB8CiAgICAgICAgICAgICAqIHwgOS4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCAxMC4gVGhlIGRvbmVDYWxsYmFjaygpIGNhbGxiYWNrIGlzIGZpcmVkIChpZiBwcm92aWRlZCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgbW92ZSBhbmltYXRpb24KICAgICAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBwYXJlbnRFbGVtZW50IHRoZSBwYXJlbnRFbGVtZW50IGVsZW1lbnQgb2YgdGhlIGVsZW1lbnQgdGhhdCB3aWxsIGJlIHRoZSBmb2N1cyBvZiB0aGUgbW92ZSBhbmltYXRpb24KICAgICAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBhZnRlckVsZW1lbnQgdGhlIHNpYmxpbmcgZWxlbWVudCAod2hpY2ggaXMgdGhlIHByZXZpb3VzIGVsZW1lbnQpIG9mIHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgZm9jdXMgb2YgdGhlIG1vdmUgYW5pbWF0aW9uCiAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKT19IGRvbmVDYWxsYmFjayB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCBvbmNlIHRoZSBhbmltYXRpb24gaXMgY29tcGxldGUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIG1vdmUgOiBmdW5jdGlvbihlbGVtZW50LCBwYXJlbnRFbGVtZW50LCBhZnRlckVsZW1lbnQsIGRvbmVDYWxsYmFjaykgewogICAgICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgcGFyZW50RWxlbWVudCA9IHByZXBhcmVFbGVtZW50KHBhcmVudEVsZW1lbnQpOwogICAgICAgICAgICAgIGFmdGVyRWxlbWVudCA9IHByZXBhcmVFbGVtZW50KGFmdGVyRWxlbWVudCk7CgogICAgICAgICAgICAgIGNhbmNlbENoaWxkQW5pbWF0aW9ucyhlbGVtZW50KTsKICAgICAgICAgICAgICB0aGlzLmVuYWJsZWQoZmFsc2UsIGVsZW1lbnQpOwogICAgICAgICAgICAgICRkZWxlZ2F0ZS5tb3ZlKGVsZW1lbnQsIHBhcmVudEVsZW1lbnQsIGFmdGVyRWxlbWVudCk7CiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kJHBvc3REaWdlc3QoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50ID0gc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgcGVyZm9ybUFuaW1hdGlvbignbW92ZScsICduZy1tb3ZlJywgZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50LCBub29wLCBkb25lQ2FsbGJhY2spOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgJGFuaW1hdGUjYWRkQ2xhc3MKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFRyaWdnZXJzIGEgY3VzdG9tIGFuaW1hdGlvbiBldmVudCBiYXNlZCBvZmYgdGhlIGNsYXNzTmFtZSB2YXJpYWJsZSBhbmQgdGhlbiBhdHRhY2hlcyB0aGUgY2xhc3NOYW1lIHZhbHVlIHRvIHRoZSBlbGVtZW50IGFzIGEgQ1NTIGNsYXNzLgogICAgICAgICAgICAgKiBVbmxpa2UgdGhlIG90aGVyIGFuaW1hdGlvbiBtZXRob2RzLCB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHdpbGwgc3VmZml4IHRoZSBjbGFzc05hbWUgdmFsdWUgd2l0aCB7QHR5cGUgLWFkZH0gaW4gb3JkZXIgdG8gcHJvdmlkZQogICAgICAgICAgICAgKiB0aGUgYW5pbWF0ZSBzZXJ2aWNlIHRoZSBzZXR1cCBhbmQgYWN0aXZlIENTUyBjbGFzc2VzIGluIG9yZGVyIHRvIHRyaWdnZXIgdGhlIGFuaW1hdGlvbiAodGhpcyB3aWxsIGJlIHNraXBwZWQgaWYgbm8gQ1NTIHRyYW5zaXRpb25zCiAgICAgICAgICAgICAqIG9yIGtleWZyYW1lcyBhcmUgZGVmaW5lZCBvbiB0aGUgLWFkZCBvciBiYXNlIENTUyBjbGFzcykuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEJlbG93IGlzIGEgYnJlYWtkb3duIG9mIGVhY2ggc3RlcCB0aGF0IG9jY3VycyBkdXJpbmcgYWRkQ2xhc3MgYW5pbWF0aW9uOgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiB8IEFuaW1hdGlvbiBTdGVwICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBXaGF0IHRoZSBlbGVtZW50IGNsYXNzIGF0dHJpYnV0ZSBsb29rcyBsaWtlIHwKICAgICAgICAgICAgICogfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICAgICAqIHwgMS4gJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgJ3N1cGVyJykgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24iICAgICAgICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiB8IDIuICRhbmltYXRlIHJ1bnMgYW55IEphdmFTY3JpcHQtZGVmaW5lZCBhbmltYXRpb25zIG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUiICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCAzLiB0aGUgLnN1cGVyLWFkZCBjbGFzcyBhcmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIHN1cGVyLWFkZCIgICB8CiAgICAgICAgICAgICAqIHwgNC4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gbmctYW5pbWF0ZSBzdXBlci1hZGQiICAgfAogICAgICAgICAgICAgKiB8IDUuICRhbmltYXRlIHdhaXRzIGZvciAxMG1zICh0aGlzIHBlcmZvcm1zIGEgcmVmbG93KSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIG5nLWFuaW1hdGUgc3VwZXItYWRkIiAgIHwKICAgICAgICAgICAgICogfCA2LiB0aGUgLnN1cGVyLCAuc3VwZXItYWRkLWFjdGl2ZSBhbmQgLm5nLWFuaW1hdGUtYWN0aXZlIGNsYXNzZXMgYXJlIGFkZGVkICh0aGlzIHRyaWdnZXJzIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24pIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWFuaW1hdGUtYWN0aXZlIHN1cGVyIHN1cGVyLWFkZCBzdXBlci1hZGQtYWN0aXZlIiAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgNy4gJGFuaW1hdGUgd2FpdHMgZm9yIFggbWlsbGlzZWNvbmRzIGZvciB0aGUgYW5pbWF0aW9uIHRvIGNvbXBsZXRlICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIgc3VwZXItYWRkIHN1cGVyLWFkZC1hY3RpdmUiICB8CiAgICAgICAgICAgICAqIHwgOC4gVGhlIGFuaW1hdGlvbiBlbmRzIGFuZCBhbGwgZ2VuZXJhdGVkIENTUyBjbGFzc2VzIGFyZSByZW1vdmVkIGZyb20gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICB8IGNsYXNzPSJteS1hbmltYXRpb24gc3VwZXIiICAgICAgICAgICAgICAgICAgfAogICAgICAgICAgICAgKiB8IDkuIFRoZSBzdXBlciBjbGFzcyBpcyBrZXB0IG9uIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIHN1cGVyIiAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCAxMC4gVGhlIGRvbmVDYWxsYmFjaygpIGNhbGxiYWNrIGlzIGZpcmVkIChpZiBwcm92aWRlZCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciIgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7RE9NRWxlbWVudH0gZWxlbWVudCB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgYW5pbWF0ZWQKICAgICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzTmFtZSB0aGUgQ1NTIGNsYXNzIHRoYXQgd2lsbCBiZSBhZGRlZCB0byB0aGUgZWxlbWVudCBhbmQgdGhlbiBhbmltYXRlZAogICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCk9fSBkb25lQ2FsbGJhY2sgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgb25jZSB0aGUgYW5pbWF0aW9uIGlzIGNvbXBsZXRlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBhZGRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZUNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICBlbGVtZW50ID0gc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgIHBlcmZvcm1BbmltYXRpb24oJ2FkZENsYXNzJywgY2xhc3NOYW1lLCBlbGVtZW50LCBudWxsLCBudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRkZWxlZ2F0ZS5hZGRDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICAgIH0sIGRvbmVDYWxsYmFjayk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNyZW1vdmVDbGFzcwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAgICogVHJpZ2dlcnMgYSBjdXN0b20gYW5pbWF0aW9uIGV2ZW50IGJhc2VkIG9mZiB0aGUgY2xhc3NOYW1lIHZhcmlhYmxlIGFuZCB0aGVuIHJlbW92ZXMgdGhlIENTUyBjbGFzcyBwcm92aWRlZCBieSB0aGUgY2xhc3NOYW1lIHZhbHVlCiAgICAgICAgICAgICAqIGZyb20gdGhlIGVsZW1lbnQuIFVubGlrZSB0aGUgb3RoZXIgYW5pbWF0aW9uIG1ldGhvZHMsIHRoZSBhbmltYXRlIHNlcnZpY2Ugd2lsbCBzdWZmaXggdGhlIGNsYXNzTmFtZSB2YWx1ZSB3aXRoIHtAdHlwZSAtcmVtb3ZlfSBpbgogICAgICAgICAgICAgKiBvcmRlciB0byBwcm92aWRlIHRoZSBhbmltYXRlIHNlcnZpY2UgdGhlIHNldHVwIGFuZCBhY3RpdmUgQ1NTIGNsYXNzZXMgaW4gb3JkZXIgdG8gdHJpZ2dlciB0aGUgYW5pbWF0aW9uICh0aGlzIHdpbGwgYmUgc2tpcHBlZCBpZgogICAgICAgICAgICAgKiBubyBDU1MgdHJhbnNpdGlvbnMgb3Iga2V5ZnJhbWVzIGFyZSBkZWZpbmVkIG9uIHRoZSAtcmVtb3ZlIG9yIGJhc2UgQ1NTIGNsYXNzZXMpLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBCZWxvdyBpcyBhIGJyZWFrZG93biBvZiBlYWNoIHN0ZXAgdGhhdCBvY2N1cnMgZHVyaW5nIHJlbW92ZUNsYXNzIGFuaW1hdGlvbjoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogfCBBbmltYXRpb24gU3RlcCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBXaGF0IHRoZSBlbGVtZW50IGNsYXNzIGF0dHJpYnV0ZSBsb29rcyBsaWtlICAgICB8CiAgICAgICAgICAgICAqIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgICAgICAgICAqIHwgMS4gJGFuaW1hdGUucmVtb3ZlQ2xhc3MoZWxlbWVudCwgJ3N1cGVyJykgaXMgY2FsbGVkICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciIgICAgICAgICAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgMi4gJGFuaW1hdGUgcnVucyBhbnkgSmF2YVNjcmlwdC1kZWZpbmVkIGFuaW1hdGlvbnMgb24gdGhlIGVsZW1lbnQgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBuZy1hbmltYXRlIiAgICAgICB8CiAgICAgICAgICAgICAqIHwgMy4gdGhlIC5zdXBlci1yZW1vdmUgY2xhc3MgYXJlIGFkZGVkIHRvIHRoZSBlbGVtZW50ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBuZy1hbmltYXRlIHN1cGVyLXJlbW92ZSJ8CiAgICAgICAgICAgICAqIHwgNC4gJGFuaW1hdGUgc2NhbnMgdGhlIGVsZW1lbnQgc3R5bGVzIHRvIGdldCB0aGUgQ1NTIHRyYW5zaXRpb24vYW5pbWF0aW9uIGR1cmF0aW9uIGFuZCBkZWxheSAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBuZy1hbmltYXRlIHN1cGVyLXJlbW92ZSIgICB8CiAgICAgICAgICAgICAqIHwgNS4gJGFuaW1hdGUgd2FpdHMgZm9yIDEwbXMgKHRoaXMgcGVyZm9ybXMgYSByZWZsb3cpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBzdXBlciBuZy1hbmltYXRlIHN1cGVyLXJlbW92ZSIgICB8CiAgICAgICAgICAgICAqIHwgNi4gdGhlIC5zdXBlci1yZW1vdmUtYWN0aXZlIGFuZCAubmctYW5pbWF0ZS1hY3RpdmUgY2xhc3NlcyBhcmUgYWRkZWQgYW5kIC5zdXBlciBpcyByZW1vdmVkICh0aGlzIHRyaWdnZXJzIHRoZSBDU1MgdHJhbnNpdGlvbi9hbmltYXRpb24pIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWFuaW1hdGUtYWN0aXZlIHN1cGVyLXJlbW92ZSBzdXBlci1yZW1vdmUtYWN0aXZlIiAgICAgICAgICB8CiAgICAgICAgICAgICAqIHwgNy4gJGFuaW1hdGUgd2FpdHMgZm9yIFggbWlsbGlzZWNvbmRzIGZvciB0aGUgYW5pbWF0aW9uIHRvIGNvbXBsZXRlICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgY2xhc3M9Im15LWFuaW1hdGlvbiBuZy1hbmltYXRlIG5nLWFuaW1hdGUtYWN0aXZlIHN1cGVyLXJlbW92ZSBzdXBlci1yZW1vdmUtYWN0aXZlIiAgIHwKICAgICAgICAgICAgICogfCA4LiBUaGUgYW5pbWF0aW9uIGVuZHMgYW5kIGFsbCBnZW5lcmF0ZWQgQ1NTIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudCAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICogfCA5LiBUaGUgZG9uZUNhbGxiYWNrKCkgY2FsbGJhY2sgaXMgZmlyZWQgKGlmIHByb3ZpZGVkKSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBjbGFzcz0ibXktYW5pbWF0aW9uIiAgICAgICAgICAgICAgICAgICAgICAgIHwKICAgICAgICAgICAgICoKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtET01FbGVtZW50fSBlbGVtZW50IHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSBhbmltYXRlZAogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NOYW1lIHRoZSBDU1MgY2xhc3MgdGhhdCB3aWxsIGJlIGFuaW1hdGVkIGFuZCB0aGVuIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCk9fSBkb25lQ2FsbGJhY2sgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgb25jZSB0aGUgYW5pbWF0aW9uIGlzIGNvbXBsZXRlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZW1vdmVDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgZG9uZUNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICBlbGVtZW50ID0gc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgIHBlcmZvcm1BbmltYXRpb24oJ3JlbW92ZUNsYXNzJywgY2xhc3NOYW1lLCBlbGVtZW50LCBudWxsLCBudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRkZWxlZ2F0ZS5yZW1vdmVDbGFzcyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICAgIH0sIGRvbmVDYWxsYmFjayk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lICRhbmltYXRlI3NldENsYXNzCiAgICAgICAgICAgICAqIEBmdW5jdGlvbgogICAgICAgICAgICAgKiBAZGVzY3JpcHRpb24gQWRkcyBhbmQvb3IgcmVtb3ZlcyB0aGUgZ2l2ZW4gQ1NTIGNsYXNzZXMgdG8gYW5kIGZyb20gdGhlIGVsZW1lbnQuCiAgICAgICAgICAgICAqIE9uY2UgY29tcGxldGUsIHRoZSBkb25lKCkgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCAoaWYgcHJvdmlkZWQpLgogICAgICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgdGhlIGVsZW1lbnQgd2hpY2ggd2lsbCBpdHMgQ1NTIGNsYXNzZXMgY2hhbmdlZAogICAgICAgICAgICAgKiAgIHJlbW92ZWQgZnJvbSBpdAogICAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gYWRkIHRoZSBDU1MgY2xhc3NlcyB3aGljaCB3aWxsIGJlIGFkZGVkIHRvIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdmUgdGhlIENTUyBjbGFzcyB3aGljaCB3aWxsIGJlIHJlbW92ZWQgZnJvbSB0aGUgZWxlbWVudAogICAgICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZG9uZSB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gKGlmIHByb3ZpZGVkKSB0aGF0IHdpbGwgYmUgZmlyZWQgYWZ0ZXIgdGhlCiAgICAgICAgICAgICAqICAgQ1NTIGNsYXNzZXMgaGF2ZSBiZWVuIHNldCBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0Q2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBhZGQsIHJlbW92ZSwgZG9uZUNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICBlbGVtZW50ID0gc3RyaXBDb21tZW50c0Zyb21FbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgIHBlcmZvcm1BbmltYXRpb24oJ3NldENsYXNzJywgW2FkZCwgcmVtb3ZlXSwgZWxlbWVudCwgbnVsbCwgbnVsbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkZGVsZWdhdGUuc2V0Q2xhc3MoZWxlbWVudCwgYWRkLCByZW1vdmUpOwogICAgICAgICAgICAgIH0sIGRvbmVDYWxsYmFjayk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSAkYW5pbWF0ZSNlbmFibGVkCiAgICAgICAgICAgICAqIEBraW5kIGZ1bmN0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHZhbHVlIElmIHByb3ZpZGVkIHRoZW4gc2V0IHRoZSBhbmltYXRpb24gb24gb3Igb2ZmLgogICAgICAgICAgICAgKiBAcGFyYW0ge0RPTUVsZW1lbnR9IGVsZW1lbnQgSWYgcHJvdmlkZWQgdGhlbiB0aGUgZWxlbWVudCB3aWxsIGJlIHVzZWQgdG8gcmVwcmVzZW50IHRoZSBlbmFibGUvZGlzYWJsZSBvcGVyYXRpb24KICAgICAgICAgICAgICogQHJldHVybiB7Ym9vbGVhbn0gQ3VycmVudCBhbmltYXRpb24gc3RhdGUuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBHbG9iYWxseSBlbmFibGVzL2Rpc2FibGVzIGFuaW1hdGlvbnMuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBlbmFibGVkIDogZnVuY3Rpb24odmFsdWUsIGVsZW1lbnQpIHsKICAgICAgICAgICAgICBzd2l0Y2goYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICBpZih2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSkgfHwge307CiAgICAgICAgICAgICAgICAgICAgZGF0YS5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUsIGRhdGEpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgICAgcm9vdEFuaW1hdGVTdGF0ZS5kaXNhYmxlZCA9ICF2YWx1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgdmFsdWUgPSAhcm9vdEFuaW1hdGVTdGF0ZS5kaXNhYmxlZDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAhIXZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIC8qCiAgICAgICAgICAgYWxsIGFuaW1hdGlvbnMgY2FsbCB0aGlzIHNoYXJlZCBhbmltYXRpb24gdHJpZ2dlcmluZyBmdW5jdGlvbiBpbnRlcm5hbGx5LgogICAgICAgICAgIFRoZSBhbmltYXRpb25FdmVudCB2YXJpYWJsZSByZWZlcnMgdG8gdGhlIEphdmFTY3JpcHQgYW5pbWF0aW9uIGV2ZW50IHRoYXQgd2lsbCBiZSB0cmlnZ2VyZWQKICAgICAgICAgICBhbmQgdGhlIGNsYXNzTmFtZSB2YWx1ZSBpcyB0aGUgbmFtZSBvZiB0aGUgYW5pbWF0aW9uIHRoYXQgd2lsbCBiZSBhcHBsaWVkIHdpdGhpbiB0aGUKICAgICAgICAgICBDU1MgY29kZS4gRWxlbWVudCwgcGFyZW50RWxlbWVudCBhbmQgYWZ0ZXJFbGVtZW50IGFyZSBwcm92aWRlZCBET00gZWxlbWVudHMgZm9yIHRoZSBhbmltYXRpb24KICAgICAgICAgICBhbmQgdGhlIG9uQ29tcGxldGUgY2FsbGJhY2sgd2lsbCBiZSBmaXJlZCBvbmNlIHRoZSBhbmltYXRpb24gaXMgZnVsbHkgY29tcGxldGUuCiAgICAgICAgICAgKi8KICAgICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1BbmltYXRpb24oYW5pbWF0aW9uRXZlbnQsIGNsYXNzTmFtZSwgZWxlbWVudCwgcGFyZW50RWxlbWVudCwgYWZ0ZXJFbGVtZW50LCBkb21PcGVyYXRpb24sIGRvbmVDYWxsYmFjaykgewoKICAgICAgICAgICAgdmFyIHJ1bm5lciA9IGFuaW1hdGlvblJ1bm5lcihlbGVtZW50LCBhbmltYXRpb25FdmVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgaWYoIXJ1bm5lcikgewogICAgICAgICAgICAgIGZpcmVET01PcGVyYXRpb24oKTsKICAgICAgICAgICAgICBmaXJlQmVmb3JlQ2FsbGJhY2tBc3luYygpOwogICAgICAgICAgICAgIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgICAgICBjbG9zZUFuaW1hdGlvbigpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2xhc3NOYW1lID0gcnVubmVyLmNsYXNzTmFtZTsKICAgICAgICAgICAgdmFyIGVsZW1lbnRFdmVudHMgPSBhbmd1bGFyLmVsZW1lbnQuX2RhdGEocnVubmVyLm5vZGUpOwogICAgICAgICAgICBlbGVtZW50RXZlbnRzID0gZWxlbWVudEV2ZW50cyAmJiBlbGVtZW50RXZlbnRzLmV2ZW50czsKCiAgICAgICAgICAgIGlmICghcGFyZW50RWxlbWVudCkgewogICAgICAgICAgICAgIHBhcmVudEVsZW1lbnQgPSBhZnRlckVsZW1lbnQgPyBhZnRlckVsZW1lbnQucGFyZW50KCkgOiBlbGVtZW50LnBhcmVudCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbmdBbmltYXRlU3RhdGUgID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfU1RBVEUpIHx8IHt9OwogICAgICAgICAgICB2YXIgcnVubmluZ0FuaW1hdGlvbnMgICAgID0gbmdBbmltYXRlU3RhdGUuYWN0aXZlIHx8IHt9OwogICAgICAgICAgICB2YXIgdG90YWxBY3RpdmVBbmltYXRpb25zID0gbmdBbmltYXRlU3RhdGUudG90YWxBY3RpdmUgfHwgMDsKICAgICAgICAgICAgdmFyIGxhc3RBbmltYXRpb24gICAgICAgICA9IG5nQW5pbWF0ZVN0YXRlLmxhc3Q7CgogICAgICAgICAgICAvL29ubHkgYWxsb3cgYW5pbWF0aW9ucyBpZiB0aGUgY3VycmVudGx5IHJ1bm5pbmcgYW5pbWF0aW9uIGlzIG5vdCBzdHJ1Y3R1cmFsCiAgICAgICAgICAgIC8vb3IgaWYgdGhlcmUgaXMgbm8gYW5pbWF0aW9uIHJ1bm5pbmcgYXQgYWxsCiAgICAgICAgICAgIHZhciBza2lwQW5pbWF0aW9ucyA9IHJ1bm5lci5pc0NsYXNzQmFzZWQgPwogICAgICAgICAgICAgIG5nQW5pbWF0ZVN0YXRlLmRpc2FibGVkIHx8IChsYXN0QW5pbWF0aW9uICYmICFsYXN0QW5pbWF0aW9uLmlzQ2xhc3NCYXNlZCkgOgogICAgICAgICAgICAgIGZhbHNlOwoKICAgICAgICAgICAgLy9za2lwIHRoZSBhbmltYXRpb24gaWYgYW5pbWF0aW9ucyBhcmUgZGlzYWJsZWQsIGEgcGFyZW50IGlzIGFscmVhZHkgYmVpbmcgYW5pbWF0ZWQsCiAgICAgICAgICAgIC8vdGhlIGVsZW1lbnQgaXMgbm90IGN1cnJlbnRseSBhdHRhY2hlZCB0byB0aGUgZG9jdW1lbnQgYm9keSBvciB0aGVuIGNvbXBsZXRlbHkgY2xvc2UKICAgICAgICAgICAgLy90aGUgYW5pbWF0aW9uIGlmIGFueSBtYXRjaGluZyBhbmltYXRpb25zIGFyZSBub3QgZm91bmQgYXQgYWxsLgogICAgICAgICAgICAvL05PVEU6IElFOCArIElFOSBzaG91bGQgY2xvc2UgcHJvcGVybHkgKHJ1biBjbG9zZUFuaW1hdGlvbigpKSBpbiBjYXNlIGFuIGFuaW1hdGlvbiB3YXMgZm91bmQuCiAgICAgICAgICAgIGlmIChza2lwQW5pbWF0aW9ucyB8fCBhbmltYXRpb25zRGlzYWJsZWQoZWxlbWVudCwgcGFyZW50RWxlbWVudCkpIHsKICAgICAgICAgICAgICBmaXJlRE9NT3BlcmF0aW9uKCk7CiAgICAgICAgICAgICAgZmlyZUJlZm9yZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgICAgICBmaXJlQWZ0ZXJDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICAgICAgY2xvc2VBbmltYXRpb24oKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBza2lwQW5pbWF0aW9uID0gZmFsc2U7CiAgICAgICAgICAgIGlmKHRvdGFsQWN0aXZlQW5pbWF0aW9ucyA+IDApIHsKICAgICAgICAgICAgICB2YXIgYW5pbWF0aW9uc1RvQ2FuY2VsID0gW107CiAgICAgICAgICAgICAgaWYoIXJ1bm5lci5pc0NsYXNzQmFzZWQpIHsKICAgICAgICAgICAgICAgIGlmKGFuaW1hdGlvbkV2ZW50ID09ICdsZWF2ZScgJiYgcnVubmluZ0FuaW1hdGlvbnNbJ25nLWxlYXZlJ10pIHsKICAgICAgICAgICAgICAgICAgc2tpcEFuaW1hdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAvL2NhbmNlbCBhbGwgYW5pbWF0aW9ucyB3aGVuIGEgc3RydWN0dXJhbCBhbmltYXRpb24gdGFrZXMgcGxhY2UKICAgICAgICAgICAgICAgICAgZm9yKHZhciBrbGFzcyBpbiBydW5uaW5nQW5pbWF0aW9ucykgewogICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbnNUb0NhbmNlbC5wdXNoKHJ1bm5pbmdBbmltYXRpb25zW2tsYXNzXSk7CiAgICAgICAgICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCBrbGFzcyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcnVubmluZ0FuaW1hdGlvbnMgPSB7fTsKICAgICAgICAgICAgICAgICAgdG90YWxBY3RpdmVBbmltYXRpb25zID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYobGFzdEFuaW1hdGlvbi5ldmVudCA9PSAnc2V0Q2xhc3MnKSB7CiAgICAgICAgICAgICAgICBhbmltYXRpb25zVG9DYW5jZWwucHVzaChsYXN0QW5pbWF0aW9uKTsKICAgICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWxzZSBpZihydW5uaW5nQW5pbWF0aW9uc1tjbGFzc05hbWVdKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudCA9IHJ1bm5pbmdBbmltYXRpb25zW2NsYXNzTmFtZV07CiAgICAgICAgICAgICAgICBpZihjdXJyZW50LmV2ZW50ID09IGFuaW1hdGlvbkV2ZW50KSB7CiAgICAgICAgICAgICAgICAgIHNraXBBbmltYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uc1RvQ2FuY2VsLnB1c2goY3VycmVudCk7CiAgICAgICAgICAgICAgICAgIGNsZWFudXAoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmKGFuaW1hdGlvbnNUb0NhbmNlbC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBmb3JFYWNoKGFuaW1hdGlvbnNUb0NhbmNlbCwgZnVuY3Rpb24ob3BlcmF0aW9uKSB7CiAgICAgICAgICAgICAgICAgIG9wZXJhdGlvbi5jYW5jZWwoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYocnVubmVyLmlzQ2xhc3NCYXNlZCAmJiAhcnVubmVyLmlzU2V0Q2xhc3NPcGVyYXRpb24gJiYgIXNraXBBbmltYXRpb24pIHsKICAgICAgICAgICAgICBza2lwQW5pbWF0aW9uID0gKGFuaW1hdGlvbkV2ZW50ID09ICdhZGRDbGFzcycpID09IGVsZW1lbnQuaGFzQ2xhc3MoY2xhc3NOYW1lKTsgLy9vcHBvc2l0ZSBvZiBYT1IKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoc2tpcEFuaW1hdGlvbikgewogICAgICAgICAgICAgIGZpcmVET01PcGVyYXRpb24oKTsKICAgICAgICAgICAgICBmaXJlQmVmb3JlQ2FsbGJhY2tBc3luYygpOwogICAgICAgICAgICAgIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgICAgICBmaXJlRG9uZUNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKGFuaW1hdGlvbkV2ZW50ID09ICdsZWF2ZScpIHsKICAgICAgICAgICAgICAvL3RoZXJlJ3Mgbm8gbmVlZCB0byBldmVyIHJlbW92ZSB0aGUgbGlzdGVuZXIgc2luY2UgdGhlIGVsZW1lbnQKICAgICAgICAgICAgICAvL3dpbGwgYmUgcmVtb3ZlZCAoZGVzdHJveWVkKSBhZnRlciB0aGUgbGVhdmUgYW5pbWF0aW9uIGVuZHMgb3IKICAgICAgICAgICAgICAvL2lzIGNhbmNlbGxlZCBtaWR3YXkKICAgICAgICAgICAgICBlbGVtZW50Lm9uZSgnJGRlc3Ryb3knLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGFuZ3VsYXIuZWxlbWVudCh0aGlzKTsKICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKTsKICAgICAgICAgICAgICAgIGlmKHN0YXRlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBhY3RpdmVMZWF2ZUFuaW1hdGlvbiA9IHN0YXRlLmFjdGl2ZVsnbmctbGVhdmUnXTsKICAgICAgICAgICAgICAgICAgaWYoYWN0aXZlTGVhdmVBbmltYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBhY3RpdmVMZWF2ZUFuaW1hdGlvbi5jYW5jZWwoKTsKICAgICAgICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQsICduZy1sZWF2ZScpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vdGhlIG5nLWFuaW1hdGUgY2xhc3MgZG9lcyBub3RoaW5nLCBidXQgaXQncyBoZXJlIHRvIGFsbG93IGZvcgogICAgICAgICAgICAvL3BhcmVudCBhbmltYXRpb25zIHRvIGZpbmQgYW5kIGNhbmNlbCBjaGlsZCBhbmltYXRpb25zIHdoZW4gbmVlZGVkCiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoTkdfQU5JTUFURV9DTEFTU19OQU1FKTsKCiAgICAgICAgICAgIHZhciBsb2NhbEFuaW1hdGlvbkNvdW50ID0gZ2xvYmFsQW5pbWF0aW9uQ291bnRlcisrOwogICAgICAgICAgICB0b3RhbEFjdGl2ZUFuaW1hdGlvbnMrKzsKICAgICAgICAgICAgcnVubmluZ0FuaW1hdGlvbnNbY2xhc3NOYW1lXSA9IHJ1bm5lcjsKCiAgICAgICAgICAgIGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFLCB7CiAgICAgICAgICAgICAgbGFzdCA6IHJ1bm5lciwKICAgICAgICAgICAgICBhY3RpdmUgOiBydW5uaW5nQW5pbWF0aW9ucywKICAgICAgICAgICAgICBpbmRleCA6IGxvY2FsQW5pbWF0aW9uQ291bnQsCiAgICAgICAgICAgICAgdG90YWxBY3RpdmUgOiB0b3RhbEFjdGl2ZUFuaW1hdGlvbnMKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvL2ZpcnN0IHdlIHJ1biB0aGUgYmVmb3JlIGFuaW1hdGlvbnMgYW5kIHdoZW4gYWxsIG9mIHRob3NlIGFyZSBjb21wbGV0ZQogICAgICAgICAgICAvL3RoZW4gd2UgcGVyZm9ybSB0aGUgRE9NIG9wZXJhdGlvbiBhbmQgcnVuIHRoZSBuZXh0IHNldCBvZiBhbmltYXRpb25zCiAgICAgICAgICAgIGZpcmVCZWZvcmVDYWxsYmFja0FzeW5jKCk7CiAgICAgICAgICAgIHJ1bm5lci5iZWZvcmUoZnVuY3Rpb24oY2FuY2VsbGVkKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICAgICAgY2FuY2VsbGVkID0gY2FuY2VsbGVkIHx8CiAgICAgICAgICAgICAgICAhZGF0YSB8fCAhZGF0YS5hY3RpdmVbY2xhc3NOYW1lXSB8fAogICAgICAgICAgICAgICAgKHJ1bm5lci5pc0NsYXNzQmFzZWQgJiYgZGF0YS5hY3RpdmVbY2xhc3NOYW1lXS5ldmVudCAhPSBhbmltYXRpb25FdmVudCk7CgogICAgICAgICAgICAgIGZpcmVET01PcGVyYXRpb24oKTsKICAgICAgICAgICAgICBpZihjYW5jZWxsZWQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGNsb3NlQW5pbWF0aW9uKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKTsKICAgICAgICAgICAgICAgIHJ1bm5lci5hZnRlcihjbG9zZUFuaW1hdGlvbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGZpcmVET01DYWxsYmFjayhhbmltYXRpb25QaGFzZSkgewogICAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSAnJGFuaW1hdGU6JyArIGFuaW1hdGlvblBoYXNlOwogICAgICAgICAgICAgIGlmKGVsZW1lbnRFdmVudHMgJiYgZWxlbWVudEV2ZW50c1tldmVudE5hbWVdICYmIGVsZW1lbnRFdmVudHNbZXZlbnROYW1lXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAkJGFzeW5jQ2FsbGJhY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGVsZW1lbnQudHJpZ2dlckhhbmRsZXIoZXZlbnROYW1lLCB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQgOiBhbmltYXRpb25FdmVudCwKICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWUgOiBjbGFzc05hbWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGZpcmVCZWZvcmVDYWxsYmFja0FzeW5jKCkgewogICAgICAgICAgICAgIGZpcmVET01DYWxsYmFjaygnYmVmb3JlJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGZpcmVBZnRlckNhbGxiYWNrQXN5bmMoKSB7CiAgICAgICAgICAgICAgZmlyZURPTUNhbGxiYWNrKCdhZnRlcicpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBmaXJlRG9uZUNhbGxiYWNrQXN5bmMoKSB7CiAgICAgICAgICAgICAgZmlyZURPTUNhbGxiYWNrKCdjbG9zZScpOwogICAgICAgICAgICAgIGlmKGRvbmVDYWxsYmFjaykgewogICAgICAgICAgICAgICAgJCRhc3luY0NhbGxiYWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBkb25lQ2FsbGJhY2soKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9pdCBpcyBsZXNzIGNvbXBsaWNhdGVkIHRvIHVzZSBhIGZsYWcgdGhhbiBtYW5hZ2luZyBhbmQgY2FuY2VsaW5nCiAgICAgICAgICAgIC8vdGltZW91dHMgY29udGFpbmluZyBtdWx0aXBsZSBjYWxsYmFja3MuCiAgICAgICAgICAgIGZ1bmN0aW9uIGZpcmVET01PcGVyYXRpb24oKSB7CiAgICAgICAgICAgICAgaWYoIWZpcmVET01PcGVyYXRpb24uaGFzQmVlblJ1bikgewogICAgICAgICAgICAgICAgZmlyZURPTU9wZXJhdGlvbi5oYXNCZWVuUnVuID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGRvbU9wZXJhdGlvbigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gY2xvc2VBbmltYXRpb24oKSB7CiAgICAgICAgICAgICAgaWYoIWNsb3NlQW5pbWF0aW9uLmhhc0JlZW5SdW4pIHsKICAgICAgICAgICAgICAgIGNsb3NlQW5pbWF0aW9uLmhhc0JlZW5SdW4gPSB0cnVlOwogICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICAgICAgICBpZihkYXRhKSB7CiAgICAgICAgICAgICAgICAgIC8qIG9ubHkgc3RydWN0dXJhbCBhbmltYXRpb25zIHdhaXQgZm9yIHJlZmxvdyBiZWZvcmUgcmVtb3ZpbmcgYW4KICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbiwgYnV0IGNsYXNzLWJhc2VkIGFuaW1hdGlvbnMgZG9uJ3QuIEFuIGV4YW1wbGUgb2YgdGhpcwogICAgICAgICAgICAgICAgICAgZmFpbGluZyB3b3VsZCBiZSB3aGVuIGEgcGFyZW50IEhUTUwgdGFnIGhhcyBhIG5nLWNsYXNzIGF0dHJpYnV0ZQogICAgICAgICAgICAgICAgICAgY2F1c2luZyBBTEwgZGlyZWN0aXZlcyBiZWxvdyB0byBza2lwIGFuaW1hdGlvbnMgZHVyaW5nIHRoZSBkaWdlc3QgKi8KICAgICAgICAgICAgICAgICAgaWYocnVubmVyICYmIHJ1bm5lci5pc0NsYXNzQmFzZWQpIHsKICAgICAgICAgICAgICAgICAgICBjbGVhbnVwKGVsZW1lbnQsIGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJCRhc3luY0NhbGxiYWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSkgfHwge307CiAgICAgICAgICAgICAgICAgICAgICBpZihsb2NhbEFuaW1hdGlvbkNvdW50ID09IGRhdGEuaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYW51cChlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmRhdGEoTkdfQU5JTUFURV9TVEFURSwgZGF0YSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZpcmVEb25lQ2FsbGJhY2tBc3luYygpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGNhbmNlbENoaWxkQW5pbWF0aW9ucyhlbGVtZW50KSB7CiAgICAgICAgICAgIHZhciBub2RlID0gZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpOwogICAgICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICAgIHZhciBub2RlcyA9IGFuZ3VsYXIuaXNGdW5jdGlvbihub2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUpID8KICAgICAgICAgICAgICAgIG5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShOR19BTklNQVRFX0NMQVNTX05BTUUpIDoKICAgICAgICAgICAgICAgIG5vZGUucXVlcnlTZWxlY3RvckFsbCgnLicgKyBOR19BTklNQVRFX0NMQVNTX05BTUUpOwogICAgICAgICAgICAgIGZvckVhY2gobm9kZXMsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKTsKICAgICAgICAgICAgICAgIGlmKGRhdGEgJiYgZGF0YS5hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgZm9yRWFjaChkYXRhLmFjdGl2ZSwgZnVuY3Rpb24ocnVubmVyKSB7CiAgICAgICAgICAgICAgICAgICAgcnVubmVyLmNhbmNlbCgpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGNsZWFudXAoZWxlbWVudCwgY2xhc3NOYW1lKSB7CiAgICAgICAgICAgIGlmKGlzTWF0Y2hpbmdFbGVtZW50KGVsZW1lbnQsICRyb290RWxlbWVudCkpIHsKICAgICAgICAgICAgICBpZighcm9vdEFuaW1hdGVTdGF0ZS5kaXNhYmxlZCkgewogICAgICAgICAgICAgICAgcm9vdEFuaW1hdGVTdGF0ZS5ydW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICByb290QW5pbWF0ZVN0YXRlLnN0cnVjdHVyYWwgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZihjbGFzc05hbWUpIHsKICAgICAgICAgICAgICB2YXIgZGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKSB8fCB7fTsKCiAgICAgICAgICAgICAgdmFyIHJlbW92ZUFuaW1hdGlvbnMgPSBjbGFzc05hbWUgPT09IHRydWU7CiAgICAgICAgICAgICAgaWYoIXJlbW92ZUFuaW1hdGlvbnMgJiYgZGF0YS5hY3RpdmUgJiYgZGF0YS5hY3RpdmVbY2xhc3NOYW1lXSkgewogICAgICAgICAgICAgICAgZGF0YS50b3RhbEFjdGl2ZS0tOwogICAgICAgICAgICAgICAgZGVsZXRlIGRhdGEuYWN0aXZlW2NsYXNzTmFtZV07CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZihyZW1vdmVBbmltYXRpb25zIHx8ICFkYXRhLnRvdGFsQWN0aXZlKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKE5HX0FOSU1BVEVfQ0xBU1NfTkFNRSk7CiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZURhdGEoTkdfQU5JTUFURV9TVEFURSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gYW5pbWF0aW9uc0Rpc2FibGVkKGVsZW1lbnQsIHBhcmVudEVsZW1lbnQpIHsKICAgICAgICAgICAgaWYgKHJvb3RBbmltYXRlU3RhdGUuZGlzYWJsZWQpIHJldHVybiB0cnVlOwoKICAgICAgICAgICAgaWYoaXNNYXRjaGluZ0VsZW1lbnQoZWxlbWVudCwgJHJvb3RFbGVtZW50KSkgewogICAgICAgICAgICAgIHJldHVybiByb290QW5pbWF0ZVN0YXRlLmRpc2FibGVkIHx8IHJvb3RBbmltYXRlU3RhdGUucnVubmluZzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIC8vdGhlIGVsZW1lbnQgZGlkIG5vdCByZWFjaCB0aGUgcm9vdCBlbGVtZW50IHdoaWNoIG1lYW5zIHRoYXQgaXQKICAgICAgICAgICAgICAvL2lzIG5vdCBhcGFydCBvZiB0aGUgRE9NLiBUaGVyZWZvcmUgdGhlcmUgaXMgbm8gcmVhc29uIHRvIGRvCiAgICAgICAgICAgICAgLy9hbnkgYW5pbWF0aW9ucyBvbiBpdAogICAgICAgICAgICAgIGlmKHBhcmVudEVsZW1lbnQubGVuZ3RoID09PSAwKSBicmVhazsKCiAgICAgICAgICAgICAgdmFyIGlzUm9vdCA9IGlzTWF0Y2hpbmdFbGVtZW50KHBhcmVudEVsZW1lbnQsICRyb290RWxlbWVudCk7CiAgICAgICAgICAgICAgdmFyIHN0YXRlID0gaXNSb290ID8gcm9vdEFuaW1hdGVTdGF0ZSA6IHBhcmVudEVsZW1lbnQuZGF0YShOR19BTklNQVRFX1NUQVRFKTsKICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gc3RhdGUgJiYgKCEhc3RhdGUuZGlzYWJsZWQgfHwgc3RhdGUucnVubmluZyB8fCBzdGF0ZS50b3RhbEFjdGl2ZSA+IDApOwogICAgICAgICAgICAgIGlmKGlzUm9vdCB8fCByZXN1bHQpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZihpc1Jvb3QpIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKHBhcmVudEVsZW1lbnQgPSBwYXJlbnRFbGVtZW50LnBhcmVudCgpKTsKCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH1dKTsKCiAgICAgICRhbmltYXRlUHJvdmlkZXIucmVnaXN0ZXIoJycsIFsnJHdpbmRvdycsICckc25pZmZlcicsICckdGltZW91dCcsICckJGFuaW1hdGVSZWZsb3cnLAogICAgICAgIGZ1bmN0aW9uKCR3aW5kb3csICAgJHNuaWZmZXIsICAgJHRpbWVvdXQsICAgJCRhbmltYXRlUmVmbG93KSB7CiAgICAgICAgICAvLyBEZXRlY3QgcHJvcGVyIHRyYW5zaXRpb25lbmQvYW5pbWF0aW9uZW5kIGV2ZW50IG5hbWVzLgogICAgICAgICAgdmFyIENTU19QUkVGSVggPSAnJywgVFJBTlNJVElPTl9QUk9QLCBUUkFOU0lUSU9ORU5EX0VWRU5ULCBBTklNQVRJT05fUFJPUCwgQU5JTUFUSU9ORU5EX0VWRU5UOwoKICAgICAgICAgIC8vIElmIHVucHJlZml4ZWQgZXZlbnRzIGFyZSBub3Qgc3VwcG9ydGVkIGJ1dCB3ZWJraXQtcHJlZml4ZWQgYXJlLCB1c2UgdGhlIGxhdHRlci4KICAgICAgICAgIC8vIE90aGVyd2lzZSwganVzdCB1c2UgVzNDIG5hbWVzLCBicm93c2VycyBub3Qgc3VwcG9ydGluZyB0aGVtIGF0IGFsbCB3aWxsIGp1c3QgaWdub3JlIHRoZW0uCiAgICAgICAgICAvLyBOb3RlOiBDaHJvbWUgaW1wbGVtZW50cyBgd2luZG93Lm9ud2Via2l0YW5pbWF0aW9uZW5kYCBhbmQgZG9lc24ndCBpbXBsZW1lbnQgYHdpbmRvdy5vbmFuaW1hdGlvbmVuZGAKICAgICAgICAgIC8vIGJ1dCBhdCB0aGUgc2FtZSB0aW1lIGRpc3BhdGNoZXMgdGhlIGBhbmltYXRpb25lbmRgIGV2ZW50IGFuZCBub3QgYHdlYmtpdEFuaW1hdGlvbkVuZGAuCiAgICAgICAgICAvLyBSZWdpc3RlciBib3RoIGV2ZW50cyBpbiBjYXNlIGB3aW5kb3cub25hbmltYXRpb25lbmRgIGlzIG5vdCBzdXBwb3J0ZWQgYmVjYXVzZSBvZiB0aGF0LAogICAgICAgICAgLy8gZG8gdGhlIHNhbWUgZm9yIGB0cmFuc2l0aW9uZW5kYCBhcyBTYWZhcmkgaXMgbGlrZWx5IHRvIGV4aGliaXQgc2ltaWxhciBiZWhhdmlvci4KICAgICAgICAgIC8vIEFsc28sIHRoZSBvbmx5IG1vZGVybiBicm93c2VyIHRoYXQgdXNlcyB2ZW5kb3IgcHJlZml4ZXMgZm9yIHRyYW5zaXRpb25zL2tleWZyYW1lcyBpcyB3ZWJraXQKICAgICAgICAgIC8vIHRoZXJlZm9yZSB0aGVyZSBpcyBubyByZWFzb24gdG8gdGVzdCBhbnltb3JlIGZvciBvdGhlciB2ZW5kb3IgcHJlZml4ZXM6IGh0dHA6Ly9jYW5pdXNlLmNvbS8jc2VhcmNoPXRyYW5zaXRpb24KICAgICAgICAgIGlmICh3aW5kb3cub250cmFuc2l0aW9uZW5kID09PSB1bmRlZmluZWQgJiYgd2luZG93Lm9ud2Via2l0dHJhbnNpdGlvbmVuZCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIENTU19QUkVGSVggPSAnLXdlYmtpdC0nOwogICAgICAgICAgICBUUkFOU0lUSU9OX1BST1AgPSAnV2Via2l0VHJhbnNpdGlvbic7CiAgICAgICAgICAgIFRSQU5TSVRJT05FTkRfRVZFTlQgPSAnd2Via2l0VHJhbnNpdGlvbkVuZCB0cmFuc2l0aW9uZW5kJzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIFRSQU5TSVRJT05fUFJPUCA9ICd0cmFuc2l0aW9uJzsKICAgICAgICAgICAgVFJBTlNJVElPTkVORF9FVkVOVCA9ICd0cmFuc2l0aW9uZW5kJzsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAod2luZG93Lm9uYW5pbWF0aW9uZW5kID09PSB1bmRlZmluZWQgJiYgd2luZG93Lm9ud2Via2l0YW5pbWF0aW9uZW5kICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgQ1NTX1BSRUZJWCA9ICctd2Via2l0LSc7CiAgICAgICAgICAgIEFOSU1BVElPTl9QUk9QID0gJ1dlYmtpdEFuaW1hdGlvbic7CiAgICAgICAgICAgIEFOSU1BVElPTkVORF9FVkVOVCA9ICd3ZWJraXRBbmltYXRpb25FbmQgYW5pbWF0aW9uZW5kJzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIEFOSU1BVElPTl9QUk9QID0gJ2FuaW1hdGlvbic7CiAgICAgICAgICAgIEFOSU1BVElPTkVORF9FVkVOVCA9ICdhbmltYXRpb25lbmQnOwogICAgICAgICAgfQoKICAgICAgICAgIHZhciBEVVJBVElPTl9LRVkgPSAnRHVyYXRpb24nOwogICAgICAgICAgdmFyIFBST1BFUlRZX0tFWSA9ICdQcm9wZXJ0eSc7CiAgICAgICAgICB2YXIgREVMQVlfS0VZID0gJ0RlbGF5JzsKICAgICAgICAgIHZhciBBTklNQVRJT05fSVRFUkFUSU9OX0NPVU5UX0tFWSA9ICdJdGVyYXRpb25Db3VudCc7CiAgICAgICAgICB2YXIgTkdfQU5JTUFURV9QQVJFTlRfS0VZID0gJyQkbmdBbmltYXRlS2V5JzsKICAgICAgICAgIHZhciBOR19BTklNQVRFX0NTU19EQVRBX0tFWSA9ICckJG5nQW5pbWF0ZUNTUzNEYXRhJzsKICAgICAgICAgIHZhciBOR19BTklNQVRFX0JMT0NLX0NMQVNTX05BTUUgPSAnbmctYW5pbWF0ZS1ibG9jay10cmFuc2l0aW9ucyc7CiAgICAgICAgICB2YXIgRUxBUFNFRF9USU1FX01BWF9ERUNJTUFMX1BMQUNFUyA9IDM7CiAgICAgICAgICB2YXIgQ0xPU0lOR19USU1FX0JVRkZFUiA9IDEuNTsKICAgICAgICAgIHZhciBPTkVfU0VDT05EID0gMTAwMDsKCiAgICAgICAgICB2YXIgbG9va3VwQ2FjaGUgPSB7fTsKICAgICAgICAgIHZhciBwYXJlbnRDb3VudGVyID0gMDsKICAgICAgICAgIHZhciBhbmltYXRpb25SZWZsb3dRdWV1ZSA9IFtdOwogICAgICAgICAgdmFyIGNhbmNlbEFuaW1hdGlvblJlZmxvdzsKICAgICAgICAgIGZ1bmN0aW9uIGFmdGVyUmVmbG93KGVsZW1lbnQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmKGNhbmNlbEFuaW1hdGlvblJlZmxvdykgewogICAgICAgICAgICAgIGNhbmNlbEFuaW1hdGlvblJlZmxvdygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFuaW1hdGlvblJlZmxvd1F1ZXVlLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgICBjYW5jZWxBbmltYXRpb25SZWZsb3cgPSAkJGFuaW1hdGVSZWZsb3coZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZm9yRWFjaChhbmltYXRpb25SZWZsb3dRdWV1ZSwgZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGFuaW1hdGlvblJlZmxvd1F1ZXVlID0gW107CiAgICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uUmVmbG93ID0gbnVsbDsKICAgICAgICAgICAgICBsb29rdXBDYWNoZSA9IHt9OwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgY2xvc2luZ1RpbWVyID0gbnVsbDsKICAgICAgICAgIHZhciBjbG9zaW5nVGltZXN0YW1wID0gMDsKICAgICAgICAgIHZhciBhbmltYXRpb25FbGVtZW50UXVldWUgPSBbXTsKICAgICAgICAgIGZ1bmN0aW9uIGFuaW1hdGlvbkNsb3NlSGFuZGxlcihlbGVtZW50LCB0b3RhbFRpbWUpIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgICAgIGVsZW1lbnQgPSBhbmd1bGFyLmVsZW1lbnQobm9kZSk7CgogICAgICAgICAgICAvL3RoaXMgaXRlbSB3aWxsIGJlIGdhcmJhZ2UgY29sbGVjdGVkIGJ5IHRoZSBjbG9zaW5nCiAgICAgICAgICAgIC8vYW5pbWF0aW9uIHRpbWVvdXQKICAgICAgICAgICAgYW5pbWF0aW9uRWxlbWVudFF1ZXVlLnB1c2goZWxlbWVudCk7CgogICAgICAgICAgICAvL2J1dCBpdCBtYXkgbm90IG5lZWQgdG8gY2FuY2VsIG91dCB0aGUgZXhpc3RpbmcgdGltZW91dAogICAgICAgICAgICAvL2lmIHRoZSB0aW1lc3RhbXAgaXMgbGVzcyB0aGFuIHRoZSBwcmV2aW91cyBvbmUKICAgICAgICAgICAgdmFyIGZ1dHVyZVRpbWVzdGFtcCA9IERhdGUubm93KCkgKyB0b3RhbFRpbWU7CiAgICAgICAgICAgIGlmKGZ1dHVyZVRpbWVzdGFtcCA8PSBjbG9zaW5nVGltZXN0YW1wKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkdGltZW91dC5jYW5jZWwoY2xvc2luZ1RpbWVyKTsKCiAgICAgICAgICAgIGNsb3NpbmdUaW1lc3RhbXAgPSBmdXR1cmVUaW1lc3RhbXA7CiAgICAgICAgICAgIGNsb3NpbmdUaW1lciA9ICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGNsb3NlQWxsQW5pbWF0aW9ucyhhbmltYXRpb25FbGVtZW50UXVldWUpOwogICAgICAgICAgICAgIGFuaW1hdGlvbkVsZW1lbnRRdWV1ZSA9IFtdOwogICAgICAgICAgICB9LCB0b3RhbFRpbWUsIGZhbHNlKTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBjbG9zZUFsbEFuaW1hdGlvbnMoZWxlbWVudHMpIHsKICAgICAgICAgICAgZm9yRWFjaChlbGVtZW50cywgZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBlbGVtZW50RGF0YSA9IGVsZW1lbnQuZGF0YShOR19BTklNQVRFX0NTU19EQVRBX0tFWSk7CiAgICAgICAgICAgICAgaWYoZWxlbWVudERhdGEpIHsKICAgICAgICAgICAgICAgIChlbGVtZW50RGF0YS5jbG9zZUFuaW1hdGlvbkZuIHx8IG5vb3ApKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBnZXRFbGVtZW50QW5pbWF0aW9uRGV0YWlscyhlbGVtZW50LCBjYWNoZUtleSkgewogICAgICAgICAgICB2YXIgZGF0YSA9IGNhY2hlS2V5ID8gbG9va3VwQ2FjaGVbY2FjaGVLZXldIDogbnVsbDsKICAgICAgICAgICAgaWYoIWRhdGEpIHsKICAgICAgICAgICAgICB2YXIgdHJhbnNpdGlvbkR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB2YXIgdHJhbnNpdGlvbkRlbGF5ID0gMDsKICAgICAgICAgICAgICB2YXIgYW5pbWF0aW9uRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHZhciBhbmltYXRpb25EZWxheSA9IDA7CiAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb25EZWxheVN0eWxlOwogICAgICAgICAgICAgIHZhciBhbmltYXRpb25EZWxheVN0eWxlOwogICAgICAgICAgICAgIHZhciB0cmFuc2l0aW9uRHVyYXRpb25TdHlsZTsKICAgICAgICAgICAgICB2YXIgdHJhbnNpdGlvblByb3BlcnR5U3R5bGU7CgogICAgICAgICAgICAgIC8vd2Ugd2FudCBhbGwgdGhlIHN0eWxlcyBkZWZpbmVkIGJlZm9yZSBhbmQgYWZ0ZXIKICAgICAgICAgICAgICBmb3JFYWNoKGVsZW1lbnQsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgICB2YXIgZWxlbWVudFN0eWxlcyA9ICR3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50KSB8fCB7fTsKCiAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvblN0eWxlID0gZWxlbWVudFN0eWxlc1tUUkFOU0lUSU9OX1BST1AgKyBEVVJBVElPTl9LRVldOwoKICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbkR1cmF0aW9uID0gTWF0aC5tYXgocGFyc2VNYXhUaW1lKHRyYW5zaXRpb25EdXJhdGlvblN0eWxlKSwgdHJhbnNpdGlvbkR1cmF0aW9uKTsKCiAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb25Qcm9wZXJ0eVN0eWxlID0gZWxlbWVudFN0eWxlc1tUUkFOU0lUSU9OX1BST1AgKyBQUk9QRVJUWV9LRVldOwoKICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbkRlbGF5U3R5bGUgPSBlbGVtZW50U3R5bGVzW1RSQU5TSVRJT05fUFJPUCArIERFTEFZX0tFWV07CgogICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uRGVsYXkgID0gTWF0aC5tYXgocGFyc2VNYXhUaW1lKHRyYW5zaXRpb25EZWxheVN0eWxlKSwgdHJhbnNpdGlvbkRlbGF5KTsKCiAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbkRlbGF5U3R5bGUgPSBlbGVtZW50U3R5bGVzW0FOSU1BVElPTl9QUk9QICsgREVMQVlfS0VZXTsKCiAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbkRlbGF5ICAgPSBNYXRoLm1heChwYXJzZU1heFRpbWUoYW5pbWF0aW9uRGVsYXlTdHlsZSksIGFuaW1hdGlvbkRlbGF5KTsKCiAgICAgICAgICAgICAgICAgIHZhciBhRHVyYXRpb24gID0gcGFyc2VNYXhUaW1lKGVsZW1lbnRTdHlsZXNbQU5JTUFUSU9OX1BST1AgKyBEVVJBVElPTl9LRVldKTsKCiAgICAgICAgICAgICAgICAgIGlmKGFEdXJhdGlvbiA+IDApIHsKICAgICAgICAgICAgICAgICAgICBhRHVyYXRpb24gKj0gcGFyc2VJbnQoZWxlbWVudFN0eWxlc1tBTklNQVRJT05fUFJPUCArIEFOSU1BVElPTl9JVEVSQVRJT05fQ09VTlRfS0VZXSwgMTApIHx8IDE7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbkR1cmF0aW9uID0gTWF0aC5tYXgoYUR1cmF0aW9uLCBhbmltYXRpb25EdXJhdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgZGF0YSA9IHsKICAgICAgICAgICAgICAgIHRvdGFsIDogMCwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25Qcm9wZXJ0eVN0eWxlOiB0cmFuc2l0aW9uUHJvcGVydHlTdHlsZSwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvblN0eWxlOiB0cmFuc2l0aW9uRHVyYXRpb25TdHlsZSwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25EZWxheVN0eWxlOiB0cmFuc2l0aW9uRGVsYXlTdHlsZSwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25EZWxheTogdHJhbnNpdGlvbkRlbGF5LAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbkR1cmF0aW9uOiB0cmFuc2l0aW9uRHVyYXRpb24sCiAgICAgICAgICAgICAgICBhbmltYXRpb25EZWxheVN0eWxlOiBhbmltYXRpb25EZWxheVN0eWxlLAogICAgICAgICAgICAgICAgYW5pbWF0aW9uRGVsYXk6IGFuaW1hdGlvbkRlbGF5LAogICAgICAgICAgICAgICAgYW5pbWF0aW9uRHVyYXRpb246IGFuaW1hdGlvbkR1cmF0aW9uCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZihjYWNoZUtleSkgewogICAgICAgICAgICAgICAgbG9va3VwQ2FjaGVbY2FjaGVLZXldID0gZGF0YTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gcGFyc2VNYXhUaW1lKHN0cikgewogICAgICAgICAgICB2YXIgbWF4VmFsdWUgPSAwOwogICAgICAgICAgICB2YXIgdmFsdWVzID0gYW5ndWxhci5pc1N0cmluZyhzdHIpID8KICAgICAgICAgICAgICBzdHIuc3BsaXQoL1xzKixccyovKSA6CiAgICAgICAgICAgICAgW107CiAgICAgICAgICAgIGZvckVhY2godmFsdWVzLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIG1heFZhbHVlID0gTWF0aC5tYXgocGFyc2VGbG9hdCh2YWx1ZSkgfHwgMCwgbWF4VmFsdWUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIG1heFZhbHVlOwogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGdldENhY2hlS2V5KGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIHBhcmVudEVsZW1lbnQgPSBlbGVtZW50LnBhcmVudCgpOwogICAgICAgICAgICB2YXIgcGFyZW50SUQgPSBwYXJlbnRFbGVtZW50LmRhdGEoTkdfQU5JTUFURV9QQVJFTlRfS0VZKTsKICAgICAgICAgICAgaWYoIXBhcmVudElEKSB7CiAgICAgICAgICAgICAgcGFyZW50RWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfUEFSRU5UX0tFWSwgKytwYXJlbnRDb3VudGVyKTsKICAgICAgICAgICAgICBwYXJlbnRJRCA9IHBhcmVudENvdW50ZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhcmVudElEICsgJy0nICsgZXh0cmFjdEVsZW1lbnROb2RlKGVsZW1lbnQpLmdldEF0dHJpYnV0ZSgnY2xhc3MnKTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBhbmltYXRlU2V0dXAoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgY2FsY3VsYXRpb25EZWNvcmF0b3IpIHsKICAgICAgICAgICAgdmFyIGNhY2hlS2V5ID0gZ2V0Q2FjaGVLZXkoZWxlbWVudCk7CiAgICAgICAgICAgIHZhciBldmVudENhY2hlS2V5ID0gY2FjaGVLZXkgKyAnICcgKyBjbGFzc05hbWU7CiAgICAgICAgICAgIHZhciBpdGVtSW5kZXggPSBsb29rdXBDYWNoZVtldmVudENhY2hlS2V5XSA/ICsrbG9va3VwQ2FjaGVbZXZlbnRDYWNoZUtleV0udG90YWwgOiAwOwoKICAgICAgICAgICAgdmFyIHN0YWdnZXIgPSB7fTsKICAgICAgICAgICAgaWYoaXRlbUluZGV4ID4gMCkgewogICAgICAgICAgICAgIHZhciBzdGFnZ2VyQ2xhc3NOYW1lID0gY2xhc3NOYW1lICsgJy1zdGFnZ2VyJzsKICAgICAgICAgICAgICB2YXIgc3RhZ2dlckNhY2hlS2V5ID0gY2FjaGVLZXkgKyAnICcgKyBzdGFnZ2VyQ2xhc3NOYW1lOwogICAgICAgICAgICAgIHZhciBhcHBseUNsYXNzZXMgPSAhbG9va3VwQ2FjaGVbc3RhZ2dlckNhY2hlS2V5XTsKCiAgICAgICAgICAgICAgYXBwbHlDbGFzc2VzICYmIGVsZW1lbnQuYWRkQ2xhc3Moc3RhZ2dlckNsYXNzTmFtZSk7CgogICAgICAgICAgICAgIHN0YWdnZXIgPSBnZXRFbGVtZW50QW5pbWF0aW9uRGV0YWlscyhlbGVtZW50LCBzdGFnZ2VyQ2FjaGVLZXkpOwoKICAgICAgICAgICAgICBhcHBseUNsYXNzZXMgJiYgZWxlbWVudC5yZW1vdmVDbGFzcyhzdGFnZ2VyQ2xhc3NOYW1lKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyogdGhlIGFuaW1hdGlvbiBpdHNlbGYgbWF5IG5lZWQgdG8gYWRkL3JlbW92ZSBzcGVjaWFsIENTUyBjbGFzc2VzCiAgICAgICAgICAgICAqIGJlZm9yZSBjYWxjdWxhdGluZyB0aGUgYW5tYXRpb24gc3R5bGVzICovCiAgICAgICAgICAgIGNhbGN1bGF0aW9uRGVjb3JhdG9yID0gY2FsY3VsYXRpb25EZWNvcmF0b3IgfHwKICAgICAgICAgICAgICBmdW5jdGlvbihmbikgeyByZXR1cm4gZm4oKTsgfTsKCiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoY2xhc3NOYW1lKTsKCiAgICAgICAgICAgIHZhciBmb3JtZXJEYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKSB8fCB7fTsKCiAgICAgICAgICAgIHZhciB0aW1pbmdzID0gY2FsY3VsYXRpb25EZWNvcmF0b3IoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldEVsZW1lbnRBbmltYXRpb25EZXRhaWxzKGVsZW1lbnQsIGV2ZW50Q2FjaGVLZXkpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHZhciB0cmFuc2l0aW9uRHVyYXRpb24gPSB0aW1pbmdzLnRyYW5zaXRpb25EdXJhdGlvbjsKICAgICAgICAgICAgdmFyIGFuaW1hdGlvbkR1cmF0aW9uID0gdGltaW5ncy5hbmltYXRpb25EdXJhdGlvbjsKICAgICAgICAgICAgaWYodHJhbnNpdGlvbkR1cmF0aW9uID09PSAwICYmIGFuaW1hdGlvbkR1cmF0aW9uID09PSAwKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZLCB7CiAgICAgICAgICAgICAgcnVubmluZyA6IGZvcm1lckRhdGEucnVubmluZyB8fCAwLAogICAgICAgICAgICAgIGl0ZW1JbmRleCA6IGl0ZW1JbmRleCwKICAgICAgICAgICAgICBzdGFnZ2VyIDogc3RhZ2dlciwKICAgICAgICAgICAgICB0aW1pbmdzIDogdGltaW5ncywKICAgICAgICAgICAgICBjbG9zZUFuaW1hdGlvbkZuIDogbm9vcAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vdGVtcG9yYXJpbHkgZGlzYWJsZSB0aGUgdHJhbnNpdGlvbiBzbyB0aGF0IHRoZSBlbnRlciBzdHlsZXMKICAgICAgICAgICAgLy9kb24ndCBhbmltYXRlIHR3aWNlICh0aGlzIGlzIGhlcmUgdG8gYXZvaWQgYSBidWcgaW4gQ2hyb21lL0ZGKS4KICAgICAgICAgICAgdmFyIGlzQ3VycmVudGx5QW5pbWF0aW5nID0gZm9ybWVyRGF0YS5ydW5uaW5nID4gMCB8fCBhbmltYXRpb25FdmVudCA9PSAnc2V0Q2xhc3MnOwogICAgICAgICAgICBpZih0cmFuc2l0aW9uRHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgYmxvY2tUcmFuc2l0aW9ucyhlbGVtZW50LCBjbGFzc05hbWUsIGlzQ3VycmVudGx5QW5pbWF0aW5nKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9zdGFnZ2VyaW5nIGtleWZyYW1lIGFuaW1hdGlvbnMgd29yayBieSBhZGp1c3RpbmcgdGhlIGBhbmltYXRpb24tZGVsYXlgIENTUyBwcm9wZXJ0eQogICAgICAgICAgICAvL29uIHRoZSBnaXZlbiBlbGVtZW50LCBob3dldmVyLCB0aGUgZGVsYXkgdmFsdWUgY2FuIG9ubHkgY2FsY3VsYXRlZCBhZnRlciB0aGUgcmVmbG93CiAgICAgICAgICAgIC8vc2luY2UgYnkgdGhhdCB0aW1lICRhbmltYXRlIGtub3dzIGhvdyBtYW55IGVsZW1lbnRzIGFyZSBiZWluZyBhbmltYXRlZC4gVGhlcmVmb3JlLAogICAgICAgICAgICAvL3VudGlsIHRoZSByZWZsb3cgb2NjdXJzIHRoZSBlbGVtZW50IG5lZWRzIHRvIGJlIGJsb2NrZWQgKHdoZXJlIHRoZSBrZXlmcmFtZSBhbmltYXRpb24KICAgICAgICAgICAgLy9pcyBzZXQgdG8gYG5vbmUgMHNgKS4gVGhpcyBibG9ja2luZyBtZWNoYW5pc20gc2hvdWxkIG9ubHkgYmUgc2V0IGZvciB3aGVuIGEgc3RhZ2dlcgogICAgICAgICAgICAvL2FuaW1hdGlvbiBpcyBkZXRlY3RlZCBhbmQgd2hlbiB0aGUgZWxlbWVudCBpdGVtIGluZGV4IGlzIGdyZWF0ZXIgdGhhbiAwLgogICAgICAgICAgICBpZihhbmltYXRpb25EdXJhdGlvbiA+IDAgJiYgc3RhZ2dlci5hbmltYXRpb25EZWxheSA+IDAgJiYgc3RhZ2dlci5hbmltYXRpb25EdXJhdGlvbiA9PT0gMCkgewogICAgICAgICAgICAgIGJsb2NrS2V5ZnJhbWVBbmltYXRpb25zKGVsZW1lbnQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBpc1N0cnVjdHVyYWxBbmltYXRpb24oY2xhc3NOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiBjbGFzc05hbWUgPT0gJ25nLWVudGVyJyB8fCBjbGFzc05hbWUgPT0gJ25nLW1vdmUnIHx8IGNsYXNzTmFtZSA9PSAnbmctbGVhdmUnOwogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGJsb2NrVHJhbnNpdGlvbnMoZWxlbWVudCwgY2xhc3NOYW1lLCBpc0FuaW1hdGluZykgewogICAgICAgICAgICBpZihpc1N0cnVjdHVyYWxBbmltYXRpb24oY2xhc3NOYW1lKSB8fCAhaXNBbmltYXRpbmcpIHsKICAgICAgICAgICAgICBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCkuc3R5bGVbVFJBTlNJVElPTl9QUk9QICsgUFJPUEVSVFlfS0VZXSA9ICdub25lJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKE5HX0FOSU1BVEVfQkxPQ0tfQ0xBU1NfTkFNRSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBibG9ja0tleWZyYW1lQW5pbWF0aW9ucyhlbGVtZW50KSB7CiAgICAgICAgICAgIGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KS5zdHlsZVtBTklNQVRJT05fUFJPUF0gPSAnbm9uZSAwcyc7CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gdW5ibG9ja1RyYW5zaXRpb25zKGVsZW1lbnQsIGNsYXNzTmFtZSkgewogICAgICAgICAgICB2YXIgcHJvcCA9IFRSQU5TSVRJT05fUFJPUCArIFBST1BFUlRZX0tFWTsKICAgICAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgICAgIGlmKG5vZGUuc3R5bGVbcHJvcF0gJiYgbm9kZS5zdHlsZVtwcm9wXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgbm9kZS5zdHlsZVtwcm9wXSA9ICcnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoTkdfQU5JTUFURV9CTE9DS19DTEFTU19OQU1FKTsKICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiB1bmJsb2NrS2V5ZnJhbWVBbmltYXRpb25zKGVsZW1lbnQpIHsKICAgICAgICAgICAgdmFyIHByb3AgPSBBTklNQVRJT05fUFJPUDsKICAgICAgICAgICAgdmFyIG5vZGUgPSBleHRyYWN0RWxlbWVudE5vZGUoZWxlbWVudCk7CiAgICAgICAgICAgIGlmKG5vZGUuc3R5bGVbcHJvcF0gJiYgbm9kZS5zdHlsZVtwcm9wXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgbm9kZS5zdHlsZVtwcm9wXSA9ICcnOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gYW5pbWF0ZVJ1bihhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lLCBhY3RpdmVBbmltYXRpb25Db21wbGV0ZSkgewogICAgICAgICAgICB2YXIgbm9kZSA9IGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KTsKICAgICAgICAgICAgdmFyIGVsZW1lbnREYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKTsKICAgICAgICAgICAgaWYobm9kZS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykuaW5kZXhPZihjbGFzc05hbWUpID09IC0xIHx8ICFlbGVtZW50RGF0YSkgewogICAgICAgICAgICAgIGFjdGl2ZUFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgYWN0aXZlQ2xhc3NOYW1lID0gJyc7CiAgICAgICAgICAgIGZvckVhY2goY2xhc3NOYW1lLnNwbGl0KCcgJyksIGZ1bmN0aW9uKGtsYXNzLCBpKSB7CiAgICAgICAgICAgICAgYWN0aXZlQ2xhc3NOYW1lICs9IChpID4gMCA/ICcgJyA6ICcnKSArIGtsYXNzICsgJy1hY3RpdmUnOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHZhciBzdGFnZ2VyID0gZWxlbWVudERhdGEuc3RhZ2dlcjsKICAgICAgICAgICAgdmFyIHRpbWluZ3MgPSBlbGVtZW50RGF0YS50aW1pbmdzOwogICAgICAgICAgICB2YXIgaXRlbUluZGV4ID0gZWxlbWVudERhdGEuaXRlbUluZGV4OwogICAgICAgICAgICB2YXIgbWF4RHVyYXRpb24gPSBNYXRoLm1heCh0aW1pbmdzLnRyYW5zaXRpb25EdXJhdGlvbiwgdGltaW5ncy5hbmltYXRpb25EdXJhdGlvbik7CiAgICAgICAgICAgIHZhciBtYXhEZWxheSA9IE1hdGgubWF4KHRpbWluZ3MudHJhbnNpdGlvbkRlbGF5LCB0aW1pbmdzLmFuaW1hdGlvbkRlbGF5KTsKICAgICAgICAgICAgdmFyIG1heERlbGF5VGltZSA9IG1heERlbGF5ICogT05FX1NFQ09ORDsKCiAgICAgICAgICAgIHZhciBzdGFydFRpbWUgPSBEYXRlLm5vdygpOwogICAgICAgICAgICB2YXIgY3NzM0FuaW1hdGlvbkV2ZW50cyA9IEFOSU1BVElPTkVORF9FVkVOVCArICcgJyArIFRSQU5TSVRJT05FTkRfRVZFTlQ7CgogICAgICAgICAgICB2YXIgc3R5bGUgPSAnJywgYXBwbGllZFN0eWxlcyA9IFtdOwogICAgICAgICAgICBpZih0aW1pbmdzLnRyYW5zaXRpb25EdXJhdGlvbiA+IDApIHsKICAgICAgICAgICAgICB2YXIgcHJvcGVydHlTdHlsZSA9IHRpbWluZ3MudHJhbnNpdGlvblByb3BlcnR5U3R5bGU7CiAgICAgICAgICAgICAgaWYocHJvcGVydHlTdHlsZS5pbmRleE9mKCdhbGwnKSA9PSAtMSkgewogICAgICAgICAgICAgICAgc3R5bGUgKz0gQ1NTX1BSRUZJWCArICd0cmFuc2l0aW9uLXByb3BlcnR5OiAnICsgcHJvcGVydHlTdHlsZSArICc7JzsKICAgICAgICAgICAgICAgIHN0eWxlICs9IENTU19QUkVGSVggKyAndHJhbnNpdGlvbi1kdXJhdGlvbjogJyArIHRpbWluZ3MudHJhbnNpdGlvbkR1cmF0aW9uU3R5bGUgKyAnOyc7CiAgICAgICAgICAgICAgICBhcHBsaWVkU3R5bGVzLnB1c2goQ1NTX1BSRUZJWCArICd0cmFuc2l0aW9uLXByb3BlcnR5Jyk7CiAgICAgICAgICAgICAgICBhcHBsaWVkU3R5bGVzLnB1c2goQ1NTX1BSRUZJWCArICd0cmFuc2l0aW9uLWR1cmF0aW9uJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihpdGVtSW5kZXggPiAwKSB7CiAgICAgICAgICAgICAgaWYoc3RhZ2dlci50cmFuc2l0aW9uRGVsYXkgPiAwICYmIHN0YWdnZXIudHJhbnNpdGlvbkR1cmF0aW9uID09PSAwKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVsYXlTdHlsZSA9IHRpbWluZ3MudHJhbnNpdGlvbkRlbGF5U3R5bGU7CiAgICAgICAgICAgICAgICBzdHlsZSArPSBDU1NfUFJFRklYICsgJ3RyYW5zaXRpb24tZGVsYXk6ICcgKwogICAgICAgICAgICAgICAgICBwcmVwYXJlU3RhZ2dlckRlbGF5KGRlbGF5U3R5bGUsIHN0YWdnZXIudHJhbnNpdGlvbkRlbGF5LCBpdGVtSW5kZXgpICsgJzsgJzsKICAgICAgICAgICAgICAgIGFwcGxpZWRTdHlsZXMucHVzaChDU1NfUFJFRklYICsgJ3RyYW5zaXRpb24tZGVsYXknKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmKHN0YWdnZXIuYW5pbWF0aW9uRGVsYXkgPiAwICYmIHN0YWdnZXIuYW5pbWF0aW9uRHVyYXRpb24gPT09IDApIHsKICAgICAgICAgICAgICAgIHN0eWxlICs9IENTU19QUkVGSVggKyAnYW5pbWF0aW9uLWRlbGF5OiAnICsKICAgICAgICAgICAgICAgICAgcHJlcGFyZVN0YWdnZXJEZWxheSh0aW1pbmdzLmFuaW1hdGlvbkRlbGF5U3R5bGUsIHN0YWdnZXIuYW5pbWF0aW9uRGVsYXksIGl0ZW1JbmRleCkgKyAnOyAnOwogICAgICAgICAgICAgICAgYXBwbGllZFN0eWxlcy5wdXNoKENTU19QUkVGSVggKyAnYW5pbWF0aW9uLWRlbGF5Jyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihhcHBsaWVkU3R5bGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAvL3RoZSBlbGVtZW50IGJlaW5nIGFuaW1hdGVkIG1heSBzb21ldGltZXMgY29udGFpbiBjb21tZW50IG5vZGVzIGluCiAgICAgICAgICAgICAgLy90aGUganFMaXRlIG9iamVjdCwgc28gd2UncmUgc2FmZSB0byB1c2UgYSBzaW5nbGUgdmFyaWFibGUgdG8gaG91c2UKICAgICAgICAgICAgICAvL3RoZSBzdHlsZXMgc2luY2UgdGhlcmUgaXMgYWx3YXlzIG9ubHkgb25lIGVsZW1lbnQgYmVpbmcgYW5pbWF0ZWQKICAgICAgICAgICAgICB2YXIgb2xkU3R5bGUgPSBub2RlLmdldEF0dHJpYnV0ZSgnc3R5bGUnKSB8fCAnJzsKICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZSgnc3R5bGUnLCBvbGRTdHlsZSArICc7ICcgKyBzdHlsZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGVsZW1lbnQub24oY3NzM0FuaW1hdGlvbkV2ZW50cywgb25BbmltYXRpb25Qcm9ncmVzcyk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoYWN0aXZlQ2xhc3NOYW1lKTsKICAgICAgICAgICAgZWxlbWVudERhdGEuY2xvc2VBbmltYXRpb25GbiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIG9uRW5kKCk7CiAgICAgICAgICAgICAgYWN0aXZlQW5pbWF0aW9uQ29tcGxldGUoKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciBzdGFnZ2VyVGltZSAgICAgICA9IGl0ZW1JbmRleCAqIChNYXRoLm1heChzdGFnZ2VyLmFuaW1hdGlvbkRlbGF5LCBzdGFnZ2VyLnRyYW5zaXRpb25EZWxheSkgfHwgMCk7CiAgICAgICAgICAgIHZhciBhbmltYXRpb25UaW1lICAgICA9IChtYXhEZWxheSArIG1heER1cmF0aW9uKSAqIENMT1NJTkdfVElNRV9CVUZGRVI7CiAgICAgICAgICAgIHZhciB0b3RhbFRpbWUgICAgICAgICA9IChzdGFnZ2VyVGltZSArIGFuaW1hdGlvblRpbWUpICogT05FX1NFQ09ORDsKCiAgICAgICAgICAgIGVsZW1lbnREYXRhLnJ1bm5pbmcrKzsKICAgICAgICAgICAgYW5pbWF0aW9uQ2xvc2VIYW5kbGVyKGVsZW1lbnQsIHRvdGFsVGltZSk7CiAgICAgICAgICAgIHJldHVybiBvbkVuZDsKCiAgICAgICAgICAgIC8vIFRoaXMgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIGNhbGxlZCBieSAkYW5pbWF0ZSBzbwogICAgICAgICAgICAvLyB0aGVyZSBpcyBubyBuZWVkIHRvIGF0dGFjaCB0aGlzIGludGVybmFsbHkgdG8gdGhlCiAgICAgICAgICAgIC8vIHRpbWVvdXQgZG9uZSBtZXRob2QuCiAgICAgICAgICAgIGZ1bmN0aW9uIG9uRW5kKGNhbmNlbGxlZCkgewogICAgICAgICAgICAgIGVsZW1lbnQub2ZmKGNzczNBbmltYXRpb25FdmVudHMsIG9uQW5pbWF0aW9uUHJvZ3Jlc3MpOwogICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoYWN0aXZlQ2xhc3NOYW1lKTsKICAgICAgICAgICAgICBhbmltYXRlQ2xvc2UoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IGV4dHJhY3RFbGVtZW50Tm9kZShlbGVtZW50KTsKICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIGFwcGxpZWRTdHlsZXMpIHsKICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUucmVtb3ZlUHJvcGVydHkoYXBwbGllZFN0eWxlc1tpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmdW5jdGlvbiBvbkFuaW1hdGlvblByb2dyZXNzKGV2ZW50KSB7CiAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgdmFyIGV2ID0gZXZlbnQub3JpZ2luYWxFdmVudCB8fCBldmVudDsKICAgICAgICAgICAgICB2YXIgdGltZVN0YW1wID0gZXYuJG1hbnVhbFRpbWVTdGFtcCB8fCBldi50aW1lU3RhbXAgfHwgRGF0ZS5ub3coKTsKCiAgICAgICAgICAgICAgLyogRmlyZWZveCAob3IgcG9zc2libHkganVzdCBHZWNrbykgbGlrZXMgdG8gbm90IHJvdW5kIHZhbHVlcyB1cAogICAgICAgICAgICAgICAqIHdoZW4gYSBtcyBtZWFzdXJlbWVudCBpcyB1c2VkIGZvciB0aGUgYW5pbWF0aW9uICovCiAgICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gcGFyc2VGbG9hdChldi5lbGFwc2VkVGltZS50b0ZpeGVkKEVMQVBTRURfVElNRV9NQVhfREVDSU1BTF9QTEFDRVMpKTsKCiAgICAgICAgICAgICAgLyogJG1hbnVhbFRpbWVTdGFtcCBpcyBhIG1vY2tlZCB0aW1lU3RhbXAgdmFsdWUgd2hpY2ggaXMgc2V0CiAgICAgICAgICAgICAgICogd2l0aGluIGJyb3dzZXJUcmlnZ2VyKCkuIFRoaXMgaXMgb25seSBoZXJlIHNvIHRoYXQgdGVzdHMgY2FuCiAgICAgICAgICAgICAgICogbW9jayBhbmltYXRpb25zIHByb3Blcmx5LiBSZWFsIGV2ZW50cyBmYWxsYmFjayB0byBldmVudC50aW1lU3RhbXAsCiAgICAgICAgICAgICAgICogb3IsIGlmIHRoZXkgZG9uJ3QsIHRoZW4gYSB0aW1lU3RhbXAgaXMgYXV0b21hdGljYWxseSBjcmVhdGVkIGZvciB0aGVtLgogICAgICAgICAgICAgICAqIFdlJ3JlIGNoZWNraW5nIHRvIHNlZSBpZiB0aGUgdGltZVN0YW1wIHN1cnBhc3NlcyB0aGUgZXhwZWN0ZWQgZGVsYXksCiAgICAgICAgICAgICAgICogYnV0IHdlJ3JlIHVzaW5nIGVsYXBzZWRUaW1lIGluc3RlYWQgb2YgdGhlIHRpbWVTdGFtcCBvbiB0aGUgMm5kCiAgICAgICAgICAgICAgICogcHJlLWNvbmRpdGlvbiBzaW5jZSBhbmltYXRpb25zIHNvbWV0aW1lcyBjbG9zZSBvZmYgZWFybHkgKi8KICAgICAgICAgICAgICBpZihNYXRoLm1heCh0aW1lU3RhbXAgLSBzdGFydFRpbWUsIDApID49IG1heERlbGF5VGltZSAmJiBlbGFwc2VkVGltZSA+PSBtYXhEdXJhdGlvbikgewogICAgICAgICAgICAgICAgYWN0aXZlQW5pbWF0aW9uQ29tcGxldGUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBmdW5jdGlvbiBwcmVwYXJlU3RhZ2dlckRlbGF5KGRlbGF5U3R5bGUsIHN0YWdnZXJEZWxheSwgaW5kZXgpIHsKICAgICAgICAgICAgdmFyIHN0eWxlID0gJyc7CiAgICAgICAgICAgIGZvckVhY2goZGVsYXlTdHlsZS5zcGxpdCgnLCcpLCBmdW5jdGlvbih2YWwsIGkpIHsKICAgICAgICAgICAgICBzdHlsZSArPSAoaSA+IDAgPyAnLCcgOiAnJykgKwogICAgICAgICAgICAgICAgKGluZGV4ICogc3RhZ2dlckRlbGF5ICsgcGFyc2VJbnQodmFsLCAxMCkpICsgJ3MnOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHN0eWxlOwogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGFuaW1hdGVCZWZvcmUoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgY2FsY3VsYXRpb25EZWNvcmF0b3IpIHsKICAgICAgICAgICAgaWYoYW5pbWF0ZVNldHVwKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGNhbGN1bGF0aW9uRGVjb3JhdG9yKSkgewogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihjYW5jZWxsZWQpIHsKICAgICAgICAgICAgICAgIGNhbmNlbGxlZCAmJiBhbmltYXRlQ2xvc2UoZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gYW5pbWF0ZUFmdGVyKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGFmdGVyQW5pbWF0aW9uQ29tcGxldGUpIHsKICAgICAgICAgICAgaWYoZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKSkgewogICAgICAgICAgICAgIHJldHVybiBhbmltYXRlUnVuKGFuaW1hdGlvbkV2ZW50LCBlbGVtZW50LCBjbGFzc05hbWUsIGFmdGVyQW5pbWF0aW9uQ29tcGxldGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGFuaW1hdGVDbG9zZShlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICAgIGFmdGVyQW5pbWF0aW9uQ29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIGFuaW1hdGUoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGUpIHsKICAgICAgICAgICAgLy9JZiB0aGUgYW5pbWF0ZVNldHVwIGZ1bmN0aW9uIGRvZXNuJ3QgYm90aGVyIHJldHVybmluZyBhCiAgICAgICAgICAgIC8vY2FuY2VsbGF0aW9uIGZ1bmN0aW9uIHRoZW4gaXQgbWVhbnMgdGhhdCB0aGVyZSBpcyBubyBhbmltYXRpb24KICAgICAgICAgICAgLy90byBwZXJmb3JtIGF0IGFsbAogICAgICAgICAgICB2YXIgcHJlUmVmbG93Q2FuY2VsbGF0aW9uID0gYW5pbWF0ZUJlZm9yZShhbmltYXRpb25FdmVudCwgZWxlbWVudCwgY2xhc3NOYW1lKTsKICAgICAgICAgICAgaWYoIXByZVJlZmxvd0NhbmNlbGxhdGlvbikgewogICAgICAgICAgICAgIGFuaW1hdGlvbkNvbXBsZXRlKCk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvL1RoZXJlIGFyZSB0d28gY2FuY2VsbGF0aW9uIGZ1bmN0aW9uczogb25lIGlzIGJlZm9yZSB0aGUgZmlyc3QKICAgICAgICAgICAgLy9yZWZsb3cgYW5pbWF0aW9uIGFuZCB0aGUgc2Vjb25kIGlzIGR1cmluZyB0aGUgYWN0aXZlIHN0YXRlCiAgICAgICAgICAgIC8vYW5pbWF0aW9uLiBUaGUgZmlyc3QgZnVuY3Rpb24gd2lsbCB0YWtlIGNhcmUgb2YgcmVtb3ZpbmcgdGhlCiAgICAgICAgICAgIC8vZGF0YSBmcm9tIHRoZSBlbGVtZW50IHdoaWNoIHdpbGwgbm90IG1ha2UgdGhlIDJuZCBhbmltYXRpb24KICAgICAgICAgICAgLy9oYXBwZW4gaW4gdGhlIGZpcnN0IHBsYWNlCiAgICAgICAgICAgIHZhciBjYW5jZWwgPSBwcmVSZWZsb3dDYW5jZWxsYXRpb247CiAgICAgICAgICAgIGFmdGVyUmVmbG93KGVsZW1lbnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHVuYmxvY2tUcmFuc2l0aW9ucyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICAgIHVuYmxvY2tLZXlmcmFtZUFuaW1hdGlvbnMoZWxlbWVudCk7CiAgICAgICAgICAgICAgLy9vbmNlIHRoZSByZWZsb3cgaXMgY29tcGxldGUgdGhlbiB3ZSBwb2ludCBjYW5jZWwgdG8KICAgICAgICAgICAgICAvL3RoZSBuZXcgY2FuY2VsbGF0aW9uIGZ1bmN0aW9uIHdoaWNoIHdpbGwgcmVtb3ZlIGFsbCBvZiB0aGUKICAgICAgICAgICAgICAvL2FuaW1hdGlvbiBwcm9wZXJ0aWVzIGZyb20gdGhlIGFjdGl2ZSBhbmltYXRpb24KICAgICAgICAgICAgICBjYW5jZWwgPSBhbmltYXRlQWZ0ZXIoYW5pbWF0aW9uRXZlbnQsIGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihjYW5jZWxsZWQpIHsKICAgICAgICAgICAgICAoY2FuY2VsIHx8IG5vb3ApKGNhbmNlbGxlZCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CgogICAgICAgICAgZnVuY3Rpb24gYW5pbWF0ZUNsb3NlKGVsZW1lbnQsIGNsYXNzTmFtZSkgewogICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIHZhciBkYXRhID0gZWxlbWVudC5kYXRhKE5HX0FOSU1BVEVfQ1NTX0RBVEFfS0VZKTsKICAgICAgICAgICAgaWYoZGF0YSkgewogICAgICAgICAgICAgIGlmKGRhdGEucnVubmluZykgewogICAgICAgICAgICAgICAgZGF0YS5ydW5uaW5nLS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmKCFkYXRhLnJ1bm5pbmcgfHwgZGF0YS5ydW5uaW5nID09PSAwKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZURhdGEoTkdfQU5JTUFURV9DU1NfREFUQV9LRVkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGVudGVyIDogZnVuY3Rpb24oZWxlbWVudCwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGFuaW1hdGUoJ2VudGVyJywgZWxlbWVudCwgJ25nLWVudGVyJywgYW5pbWF0aW9uQ29tcGxldGVkKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGxlYXZlIDogZnVuY3Rpb24oZWxlbWVudCwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGFuaW1hdGUoJ2xlYXZlJywgZWxlbWVudCwgJ25nLWxlYXZlJywgYW5pbWF0aW9uQ29tcGxldGVkKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIG1vdmUgOiBmdW5jdGlvbihlbGVtZW50LCBhbmltYXRpb25Db21wbGV0ZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gYW5pbWF0ZSgnbW92ZScsIGVsZW1lbnQsICduZy1tb3ZlJywgYW5pbWF0aW9uQ29tcGxldGVkKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGJlZm9yZVNldENsYXNzIDogZnVuY3Rpb24oZWxlbWVudCwgYWRkLCByZW1vdmUsIGFuaW1hdGlvbkNvbXBsZXRlZCkgewogICAgICAgICAgICAgIHZhciBjbGFzc05hbWUgPSBzdWZmaXhDbGFzc2VzKHJlbW92ZSwgJy1yZW1vdmUnKSArICcgJyArCiAgICAgICAgICAgICAgICBzdWZmaXhDbGFzc2VzKGFkZCwgJy1hZGQnKTsKICAgICAgICAgICAgICB2YXIgY2FuY2VsbGF0aW9uTWV0aG9kID0gYW5pbWF0ZUJlZm9yZSgnc2V0Q2xhc3MnLCBlbGVtZW50LCBjbGFzc05hbWUsIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgICAgICAvKiB3aGVuIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSBhbiBlbGVtZW50IHRoZW4gdGhlIHRyYW5zaXRpb24gc3R5bGUKICAgICAgICAgICAgICAgICAqIHRoYXQgaXMgYXBwbGllZCBpcyB0aGUgdHJhbnNpdGlvbiBkZWZpbmVkIG9uIHRoZSBlbGVtZW50IHdpdGhvdXQgdGhlCiAgICAgICAgICAgICAgICAgKiBDU1MgY2xhc3MgYmVpbmcgdGhlcmUuIFRoaXMgaXMgaG93IENTUzMgZnVuY3Rpb25zIG91dHNpZGUgb2YgbmdBbmltYXRlLgogICAgICAgICAgICAgICAgICogaHR0cDovL3BsbmtyLmNvL2VkaXQvajhPemdUTnhIVGI0bjN6THlqR1c/cD1wcmV2aWV3ICovCiAgICAgICAgICAgICAgICB2YXIga2xhc3MgPSBlbGVtZW50LmF0dHIoJ2NsYXNzJyk7CiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKHJlbW92ZSk7CiAgICAgICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKGFkZCk7CiAgICAgICAgICAgICAgICB2YXIgdGltaW5ncyA9IGZuKCk7CiAgICAgICAgICAgICAgICBlbGVtZW50LmF0dHIoJ2NsYXNzJywga2xhc3MpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRpbWluZ3M7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGlmKGNhbmNlbGxhdGlvbk1ldGhvZCkgewogICAgICAgICAgICAgICAgYWZ0ZXJSZWZsb3coZWxlbWVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHVuYmxvY2tUcmFuc2l0aW9ucyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgICB1bmJsb2NrS2V5ZnJhbWVBbmltYXRpb25zKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZWQoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbmNlbGxhdGlvbk1ldGhvZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYW5pbWF0aW9uQ29tcGxldGVkKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBiZWZvcmVBZGRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICAgICAgdmFyIGNhbmNlbGxhdGlvbk1ldGhvZCA9IGFuaW1hdGVCZWZvcmUoJ2FkZENsYXNzJywgZWxlbWVudCwgc3VmZml4Q2xhc3NlcyhjbGFzc05hbWUsICctYWRkJyksIGZ1bmN0aW9uKGZuKSB7CgogICAgICAgICAgICAgICAgLyogd2hlbiBhIENTUyBjbGFzcyBpcyBhZGRlZCB0byBhbiBlbGVtZW50IHRoZW4gdGhlIHRyYW5zaXRpb24gc3R5bGUgdGhhdAogICAgICAgICAgICAgICAgICogaXMgYXBwbGllZCBpcyB0aGUgdHJhbnNpdGlvbiBkZWZpbmVkIG9uIHRoZSBlbGVtZW50IHdoZW4gdGhlIENTUyBjbGFzcwogICAgICAgICAgICAgICAgICogaXMgYWRkZWQgYXQgdGhlIHRpbWUgb2YgdGhlIGFuaW1hdGlvbi4gVGhpcyBpcyBob3cgQ1NTMyBmdW5jdGlvbnMKICAgICAgICAgICAgICAgICAqIG91dHNpZGUgb2YgbmdBbmltYXRlLiAqLwogICAgICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgdmFyIHRpbWluZ3MgPSBmbigpOwogICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRpbWluZ3M7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGlmKGNhbmNlbGxhdGlvbk1ldGhvZCkgewogICAgICAgICAgICAgICAgYWZ0ZXJSZWZsb3coZWxlbWVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHVuYmxvY2tUcmFuc2l0aW9ucyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgICB1bmJsb2NrS2V5ZnJhbWVBbmltYXRpb25zKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZWQoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbmNlbGxhdGlvbk1ldGhvZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYW5pbWF0aW9uQ29tcGxldGVkKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBzZXRDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGFkZCwgcmVtb3ZlLCBhbmltYXRpb25Db21wbGV0ZWQpIHsKICAgICAgICAgICAgICByZW1vdmUgPSBzdWZmaXhDbGFzc2VzKHJlbW92ZSwgJy1yZW1vdmUnKTsKICAgICAgICAgICAgICBhZGQgPSBzdWZmaXhDbGFzc2VzKGFkZCwgJy1hZGQnKTsKICAgICAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gcmVtb3ZlICsgJyAnICsgYWRkOwogICAgICAgICAgICAgIHJldHVybiBhbmltYXRlQWZ0ZXIoJ3NldENsYXNzJywgZWxlbWVudCwgY2xhc3NOYW1lLCBhbmltYXRpb25Db21wbGV0ZWQpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgYWRkQ2xhc3MgOiBmdW5jdGlvbihlbGVtZW50LCBjbGFzc05hbWUsIGFuaW1hdGlvbkNvbXBsZXRlZCkgewogICAgICAgICAgICAgIHJldHVybiBhbmltYXRlQWZ0ZXIoJ2FkZENsYXNzJywgZWxlbWVudCwgc3VmZml4Q2xhc3NlcyhjbGFzc05hbWUsICctYWRkJyksIGFuaW1hdGlvbkNvbXBsZXRlZCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBiZWZvcmVSZW1vdmVDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICAgICAgdmFyIGNhbmNlbGxhdGlvbk1ldGhvZCA9IGFuaW1hdGVCZWZvcmUoJ3JlbW92ZUNsYXNzJywgZWxlbWVudCwgc3VmZml4Q2xhc3NlcyhjbGFzc05hbWUsICctcmVtb3ZlJyksIGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgICAgICAvKiB3aGVuIGNsYXNzZXMgYXJlIHJlbW92ZWQgZnJvbSBhbiBlbGVtZW50IHRoZW4gdGhlIHRyYW5zaXRpb24gc3R5bGUKICAgICAgICAgICAgICAgICAqIHRoYXQgaXMgYXBwbGllZCBpcyB0aGUgdHJhbnNpdGlvbiBkZWZpbmVkIG9uIHRoZSBlbGVtZW50IHdpdGhvdXQgdGhlCiAgICAgICAgICAgICAgICAgKiBDU1MgY2xhc3MgYmVpbmcgdGhlcmUuIFRoaXMgaXMgaG93IENTUzMgZnVuY3Rpb25zIG91dHNpZGUgb2YgbmdBbmltYXRlLgogICAgICAgICAgICAgICAgICogaHR0cDovL3BsbmtyLmNvL2VkaXQvajhPemdUTnhIVGI0bjN6THlqR1c/cD1wcmV2aWV3ICovCiAgICAgICAgICAgICAgICB2YXIga2xhc3MgPSBlbGVtZW50LmF0dHIoJ2NsYXNzJyk7CiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICB2YXIgdGltaW5ncyA9IGZuKCk7CiAgICAgICAgICAgICAgICBlbGVtZW50LmF0dHIoJ2NsYXNzJywga2xhc3MpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRpbWluZ3M7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGlmKGNhbmNlbGxhdGlvbk1ldGhvZCkgewogICAgICAgICAgICAgICAgYWZ0ZXJSZWZsb3coZWxlbWVudCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHVuYmxvY2tUcmFuc2l0aW9ucyhlbGVtZW50LCBjbGFzc05hbWUpOwogICAgICAgICAgICAgICAgICB1bmJsb2NrS2V5ZnJhbWVBbmltYXRpb25zKGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBhbmltYXRpb25Db21wbGV0ZWQoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbmNlbGxhdGlvbk1ldGhvZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYW5pbWF0aW9uQ29tcGxldGVkKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByZW1vdmVDbGFzcyA6IGZ1bmN0aW9uKGVsZW1lbnQsIGNsYXNzTmFtZSwgYW5pbWF0aW9uQ29tcGxldGVkKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGFuaW1hdGVBZnRlcigncmVtb3ZlQ2xhc3MnLCBlbGVtZW50LCBzdWZmaXhDbGFzc2VzKGNsYXNzTmFtZSwgJy1yZW1vdmUnKSwgYW5pbWF0aW9uQ29tcGxldGVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICBmdW5jdGlvbiBzdWZmaXhDbGFzc2VzKGNsYXNzZXMsIHN1ZmZpeCkgewogICAgICAgICAgICB2YXIgY2xhc3NOYW1lID0gJyc7CiAgICAgICAgICAgIGNsYXNzZXMgPSBhbmd1bGFyLmlzQXJyYXkoY2xhc3NlcykgPyBjbGFzc2VzIDogY2xhc3Nlcy5zcGxpdCgvXHMrLyk7CiAgICAgICAgICAgIGZvckVhY2goY2xhc3NlcywgZnVuY3Rpb24oa2xhc3MsIGkpIHsKICAgICAgICAgICAgICBpZihrbGFzcyAmJiBrbGFzcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBjbGFzc05hbWUgKz0gKGkgPiAwID8gJyAnIDogJycpICsga2xhc3MgKyBzdWZmaXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGNsYXNzTmFtZTsKICAgICAgICAgIH0KICAgICAgICB9XSk7CiAgICB9XSk7CgoKfSkod2luZG93LCB3aW5kb3cuYW5ndWxhcik7CgovKiEKICogaW9uaWMuYnVuZGxlLmpzIGlzIGEgY29uY2F0ZW5hdGlvbiBvZjoKICogaW9uaWMuanMsIGFuZ3VsYXIuanMsIGFuZ3VsYXItYW5pbWF0ZS5qcywKICogYW5ndWxhci1zYW5pdGl6ZS5qcywgYW5ndWxhci11aS1yb3V0ZXIuanMsCiAqIGFuZCBpb25pYy1hbmd1bGFyLmpzCiAqLwoKLyoqCiAqIEBsaWNlbnNlIEFuZ3VsYXJKUyB2MS4yLjE3CiAqIChjKSAyMDEwLTIwMTQgR29vZ2xlLCBJbmMuIGh0dHA6Ly9hbmd1bGFyanMub3JnCiAqIExpY2Vuc2U6IE1JVAogKi8KKGZ1bmN0aW9uKHdpbmRvdywgYW5ndWxhciwgdW5kZWZpbmVkKSB7J3VzZSBzdHJpY3QnOwoKICB2YXIgJHNhbml0aXplTWluRXJyID0gYW5ndWxhci4kJG1pbkVycignJHNhbml0aXplJyk7CgogIC8qKgogICAqIEBuZ2RvYyBtb2R1bGUKICAgKiBAbmFtZSBuZ1Nhbml0aXplCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiAjIG5nU2FuaXRpemUKICAgKgogICAqIFRoZSBgbmdTYW5pdGl6ZWAgbW9kdWxlIHByb3ZpZGVzIGZ1bmN0aW9uYWxpdHkgdG8gc2FuaXRpemUgSFRNTC4KICAgKgogICAqCiAgICogPGRpdiBkb2MtbW9kdWxlLWNvbXBvbmVudHM9Im5nU2FuaXRpemUiPjwvZGl2PgogICAqCiAgICogU2VlIHtAbGluayBuZ1Nhbml0aXplLiRzYW5pdGl6ZSBgJHNhbml0aXplYH0gZm9yIHVzYWdlLgogICAqLwoKICAvKgogICAqIEhUTUwgUGFyc2VyIEJ5IE1pc2tvIEhldmVyeSAobWlza29AaGV2ZXJ5LmNvbSkKICAgKiBiYXNlZCBvbjogIEhUTUwgUGFyc2VyIEJ5IEpvaG4gUmVzaWcgKGVqb2huLm9yZykKICAgKiBPcmlnaW5hbCBjb2RlIGJ5IEVyaWsgQXJ2aWRzc29uLCBNb3ppbGxhIFB1YmxpYyBMaWNlbnNlCiAgICogaHR0cDovL2VyaWsuZWFlLm5ldC9zaW1wbGVodG1scGFyc2VyL3NpbXBsZWh0bWxwYXJzZXIuanMKICAgKgogICAqIC8vIFVzZSBsaWtlIHNvOgogICAqIGh0bWxQYXJzZXIoaHRtbFN0cmluZywgewogICAqICAgICBzdGFydDogZnVuY3Rpb24odGFnLCBhdHRycywgdW5hcnkpIHt9LAogICAqICAgICBlbmQ6IGZ1bmN0aW9uKHRhZykge30sCiAgICogICAgIGNoYXJzOiBmdW5jdGlvbih0ZXh0KSB7fSwKICAgKiAgICAgY29tbWVudDogZnVuY3Rpb24odGV4dCkge30KICAgKiB9KTsKICAgKgogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkc2FuaXRpemUKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogICBUaGUgaW5wdXQgaXMgc2FuaXRpemVkIGJ5IHBhcnNpbmcgdGhlIGh0bWwgaW50byB0b2tlbnMuIEFsbCBzYWZlIHRva2VucyAoZnJvbSBhIHdoaXRlbGlzdCkgYXJlCiAgICogICB0aGVuIHNlcmlhbGl6ZWQgYmFjayB0byBwcm9wZXJseSBlc2NhcGVkIGh0bWwgc3RyaW5nLiBUaGlzIG1lYW5zIHRoYXQgbm8gdW5zYWZlIGlucHV0IGNhbiBtYWtlCiAgICogICBpdCBpbnRvIHRoZSByZXR1cm5lZCBzdHJpbmcsIGhvd2V2ZXIsIHNpbmNlIG91ciBwYXJzZXIgaXMgbW9yZSBzdHJpY3QgdGhhbiBhIHR5cGljYWwgYnJvd3NlcgogICAqICAgcGFyc2VyLCBpdCdzIHBvc3NpYmxlIHRoYXQgc29tZSBvYnNjdXJlIGlucHV0LCB3aGljaCB3b3VsZCBiZSByZWNvZ25pemVkIGFzIHZhbGlkIEhUTUwgYnkgYQogICAqICAgYnJvd3Nlciwgd29uJ3QgbWFrZSBpdCB0aHJvdWdoIHRoZSBzYW5pdGl6ZXIuCiAgICogICBUaGUgd2hpdGVsaXN0IGlzIGNvbmZpZ3VyZWQgdXNpbmcgdGhlIGZ1bmN0aW9ucyBgYUhyZWZTYW5pdGl6YXRpb25XaGl0ZWxpc3RgIGFuZAogICAqICAgYGltZ1NyY1Nhbml0aXphdGlvbldoaXRlbGlzdGAgb2Yge0BsaW5rIG5nLiRjb21waWxlUHJvdmlkZXIgYCRjb21waWxlUHJvdmlkZXJgfS4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBodG1sIEh0bWwgaW5wdXQuCiAgICogQHJldHVybnMge3N0cmluZ30gU2FuaXRpemVkIGh0bWwuCiAgICoKICAgKiBAZXhhbXBsZQogICA8ZXhhbXBsZSBtb2R1bGU9Im5nU2FuaXRpemUiIGRlcHM9ImFuZ3VsYXItc2FuaXRpemUuanMiPgogICA8ZmlsZSBuYW1lPSJpbmRleC5odG1sIj4KICAgPHNjcmlwdD4KICAgZnVuY3Rpb24gQ3RybCgkc2NvcGUsICRzY2UpIHsKICAgICAgICAgJHNjb3BlLnNuaXBwZXQgPQogICAgICAgICAgICc8cCBzdHlsZT0iY29sb3I6Ymx1ZSI+YW4gaHRtbFxuJyArCiAgICAgICAgICAgJzxlbSBvbm1vdXNlb3Zlcj0idGhpcy50ZXh0Q29udGVudD1cJ1BXTjNEIVwnIj5jbGljayBoZXJlPC9lbT5cbicgKwogICAgICAgICAgICdzbmlwcGV0PC9wPic7CiAgICAgICAgICRzY29wZS5kZWxpYmVyYXRlbHlUcnVzdERhbmdlcm91c1NuaXBwZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICByZXR1cm4gJHNjZS50cnVzdEFzSHRtbCgkc2NvcGUuc25pcHBldCk7CiAgICAgICAgIH07CiAgICAgICB9CiAgIDwvc2NyaXB0PgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICBTbmlwcGV0OiA8dGV4dGFyZWEgbmctbW9kZWw9InNuaXBwZXQiIGNvbHM9IjYwIiByb3dzPSIzIj48L3RleHRhcmVhPgogICA8dGFibGU+CiAgIDx0cj4KICAgPHRkPkRpcmVjdGl2ZTwvdGQ+CiAgIDx0ZD5Ib3c8L3RkPgogICA8dGQ+U291cmNlPC90ZD4KICAgPHRkPlJlbmRlcmVkPC90ZD4KICAgPC90cj4KICAgPHRyIGlkPSJiaW5kLWh0bWwtd2l0aC1zYW5pdGl6ZSI+CiAgIDx0ZD5uZy1iaW5kLWh0bWw8L3RkPgogICA8dGQ+QXV0b21hdGljYWxseSB1c2VzICRzYW5pdGl6ZTwvdGQ+CiAgIDx0ZD48cHJlPiZsdDtkaXYgbmctYmluZC1odG1sPSJzbmlwcGV0IiZndDs8YnIvPiZsdDsvZGl2Jmd0OzwvcHJlPjwvdGQ+CiAgIDx0ZD48ZGl2IG5nLWJpbmQtaHRtbD0ic25pcHBldCI+PC9kaXY+PC90ZD4KICAgPC90cj4KICAgPHRyIGlkPSJiaW5kLWh0bWwtd2l0aC10cnVzdCI+CiAgIDx0ZD5uZy1iaW5kLWh0bWw8L3RkPgogICA8dGQ+QnlwYXNzICRzYW5pdGl6ZSBieSBleHBsaWNpdGx5IHRydXN0aW5nIHRoZSBkYW5nZXJvdXMgdmFsdWU8L3RkPgogICA8dGQ+CiAgIDxwcmU+Jmx0O2RpdiBuZy1iaW5kLWh0bWw9ImRlbGliZXJhdGVseVRydXN0RGFuZ2Vyb3VzU25pcHBldCgpIiZndDsKICAgJmx0Oy9kaXYmZ3Q7PC9wcmU+CiAgIDwvdGQ+CiAgIDx0ZD48ZGl2IG5nLWJpbmQtaHRtbD0iZGVsaWJlcmF0ZWx5VHJ1c3REYW5nZXJvdXNTbmlwcGV0KCkiPjwvZGl2PjwvdGQ+CiAgIDwvdHI+CiAgIDx0ciBpZD0iYmluZC1kZWZhdWx0Ij4KICAgPHRkPm5nLWJpbmQ8L3RkPgogICA8dGQ+QXV0b21hdGljYWxseSBlc2NhcGVzPC90ZD4KICAgPHRkPjxwcmU+Jmx0O2RpdiBuZy1iaW5kPSJzbmlwcGV0IiZndDs8YnIvPiZsdDsvZGl2Jmd0OzwvcHJlPjwvdGQ+CiAgIDx0ZD48ZGl2IG5nLWJpbmQ9InNuaXBwZXQiPjwvZGl2PjwvdGQ+CiAgIDwvdHI+CiAgIDwvdGFibGU+CiAgIDwvZGl2PgogICA8L2ZpbGU+CiAgIDxmaWxlIG5hbWU9InByb3RyYWN0b3IuanMiIHR5cGU9InByb3RyYWN0b3IiPgogICBpdCgnc2hvdWxkIHNhbml0aXplIHRoZSBodG1sIHNuaXBwZXQgYnkgZGVmYXVsdCcsIGZ1bmN0aW9uKCkgewogICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjYmluZC1odG1sLXdpdGgtc2FuaXRpemUgZGl2JykpLmdldElubmVySHRtbCgpKS4KICAgICAgICAgdG9CZSgnPHA+YW4gaHRtbFxuPGVtPmNsaWNrIGhlcmU8L2VtPlxuc25pcHBldDwvcD4nKTsKICAgICB9KTsKCiAgIGl0KCdzaG91bGQgaW5saW5lIHJhdyBzbmlwcGV0IGlmIGJvdW5kIHRvIGEgdHJ1c3RlZCB2YWx1ZScsIGZ1bmN0aW9uKCkgewogICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjYmluZC1odG1sLXdpdGgtdHJ1c3QgZGl2JykpLmdldElubmVySHRtbCgpKS4KICAgICAgICAgdG9CZSgiPHAgc3R5bGU9XCJjb2xvcjpibHVlXCI+YW4gaHRtbFxuIiArCiAgICAgICAgICAgICAgIjxlbSBvbm1vdXNlb3Zlcj1cInRoaXMudGV4dENvbnRlbnQ9J1BXTjNEISdcIj5jbGljayBoZXJlPC9lbT5cbiIgKwogICAgICAgICAgICAgICJzbmlwcGV0PC9wPiIpOwogICAgIH0pOwoKICAgaXQoJ3Nob3VsZCBlc2NhcGUgc25pcHBldCB3aXRob3V0IGFueSBmaWx0ZXInLCBmdW5jdGlvbigpIHsKICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmNzcygnI2JpbmQtZGVmYXVsdCBkaXYnKSkuZ2V0SW5uZXJIdG1sKCkpLgogICAgICAgICB0b0JlKCImbHQ7cCBzdHlsZT1cImNvbG9yOmJsdWVcIiZndDthbiBodG1sXG4iICsKICAgICAgICAgICAgICAiJmx0O2VtIG9ubW91c2VvdmVyPVwidGhpcy50ZXh0Q29udGVudD0nUFdOM0QhJ1wiJmd0O2NsaWNrIGhlcmUmbHQ7L2VtJmd0O1xuIiArCiAgICAgICAgICAgICAgInNuaXBwZXQmbHQ7L3AmZ3Q7Iik7CiAgICAgfSk7CgogICBpdCgnc2hvdWxkIHVwZGF0ZScsIGZ1bmN0aW9uKCkgewogICAgICAgZWxlbWVudChieS5tb2RlbCgnc25pcHBldCcpKS5jbGVhcigpOwogICAgICAgZWxlbWVudChieS5tb2RlbCgnc25pcHBldCcpKS5zZW5kS2V5cygnbmV3IDxiIG9uY2xpY2s9ImFsZXJ0KDEpIj50ZXh0PC9iPicpOwogICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjYmluZC1odG1sLXdpdGgtc2FuaXRpemUgZGl2JykpLmdldElubmVySHRtbCgpKS4KICAgICAgICAgdG9CZSgnbmV3IDxiPnRleHQ8L2I+Jyk7CiAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJyNiaW5kLWh0bWwtd2l0aC10cnVzdCBkaXYnKSkuZ2V0SW5uZXJIdG1sKCkpLnRvQmUoCiAgICAgICAgICduZXcgPGIgb25jbGljaz0iYWxlcnQoMSkiPnRleHQ8L2I+Jyk7CiAgICAgICBleHBlY3QoZWxlbWVudChieS5jc3MoJyNiaW5kLWRlZmF1bHQgZGl2JykpLmdldElubmVySHRtbCgpKS50b0JlKAogICAgICAgICAibmV3ICZsdDtiIG9uY2xpY2s9XCJhbGVydCgxKVwiJmd0O3RleHQmbHQ7L2ImZ3Q7Iik7CiAgICAgfSk7CiAgIDwvZmlsZT4KICAgPC9leGFtcGxlPgogICAqLwogIGZ1bmN0aW9uICRTYW5pdGl6ZVByb3ZpZGVyKCkgewogICAgdGhpcy4kZ2V0ID0gWyckJHNhbml0aXplVXJpJywgZnVuY3Rpb24oJCRzYW5pdGl6ZVVyaSkgewogICAgICByZXR1cm4gZnVuY3Rpb24oaHRtbCkgewogICAgICAgIHZhciBidWYgPSBbXTsKICAgICAgICBodG1sUGFyc2VyKGh0bWwsIGh0bWxTYW5pdGl6ZVdyaXRlcihidWYsIGZ1bmN0aW9uKHVyaSwgaXNJbWFnZSkgewogICAgICAgICAgcmV0dXJuICEvXnVuc2FmZS8udGVzdCgkJHNhbml0aXplVXJpKHVyaSwgaXNJbWFnZSkpOwogICAgICAgIH0pKTsKICAgICAgICByZXR1cm4gYnVmLmpvaW4oJycpOwogICAgICB9OwogICAgfV07CiAgfQoKICBmdW5jdGlvbiBzYW5pdGl6ZVRleHQoY2hhcnMpIHsKICAgIHZhciBidWYgPSBbXTsKICAgIHZhciB3cml0ZXIgPSBodG1sU2FuaXRpemVXcml0ZXIoYnVmLCBhbmd1bGFyLm5vb3ApOwogICAgd3JpdGVyLmNoYXJzKGNoYXJzKTsKICAgIHJldHVybiBidWYuam9pbignJyk7CiAgfQoKCi8vIFJlZ3VsYXIgRXhwcmVzc2lvbnMgZm9yIHBhcnNpbmcgdGFncyBhbmQgYXR0cmlidXRlcwogIHZhciBTVEFSVF9UQUdfUkVHRVhQID0KICAgICAgL148XHMqKFtcdzotXSspKCg/OlxzK1tcdzotXSsoPzpccyo9XHMqKD86KD86IlteIl0qIil8KD86J1teJ10qJyl8W14+XHNdKykpPykqKVxzKihcLz8pXHMqPi8sCiAgICBFTkRfVEFHX1JFR0VYUCA9IC9ePFxzKlwvXHMqKFtcdzotXSspW14+XSo+LywKICAgIEFUVFJfUkVHRVhQID0gLyhbXHc6LV0rKSg/OlxzKj1ccyooPzooPzoiKCg/OlteIl0pKikiKXwoPzonKCg/OlteJ10pKiknKXwoW14+XHNdKykpKT8vZywKICAgIEJFR0lOX1RBR19SRUdFWFAgPSAvXjwvLAogICAgQkVHSU5HX0VORF9UQUdFX1JFR0VYUCA9IC9ePFxzKlwvLywKICAgIENPTU1FTlRfUkVHRVhQID0gLzwhLS0oLio/KS0tPi9nLAogICAgRE9DVFlQRV9SRUdFWFAgPSAvPCFET0NUWVBFKFtePl0qPyk+L2ksCiAgICBDREFUQV9SRUdFWFAgPSAvPCFcW0NEQVRBXFsoLio/KV1dPi9nLAogICAgU1VSUk9HQVRFX1BBSVJfUkVHRVhQID0gL1tcdUQ4MDAtXHVEQkZGXVtcdURDMDAtXHVERkZGXS9nLAogIC8vIE1hdGNoIGV2ZXJ5dGhpbmcgb3V0c2lkZSBvZiBub3JtYWwgY2hhcnMgYW5kICIgKHF1b3RlIGNoYXJhY3RlcikKICAgIE5PTl9BTFBIQU5VTUVSSUNfUkVHRVhQID0gLyhbXlwjLX58IHwhXSkvZzsKCgovLyBHb29kIHNvdXJjZSBvZiBpbmZvIGFib3V0IGVsZW1lbnRzIGFuZCBhdHRyaWJ1dGVzCi8vIGh0dHA6Ly9kZXYudzMub3JnL2h0bWw1L3NwZWMvT3ZlcnZpZXcuaHRtbCNzZW1hbnRpY3MKLy8gaHR0cDovL3NpbW9uLmh0bWw1Lm9yZy9odG1sLWVsZW1lbnRzCgovLyBTYWZlIFZvaWQgRWxlbWVudHMgLSBIVE1MNQovLyBodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjdm9pZC1lbGVtZW50cwogIHZhciB2b2lkRWxlbWVudHMgPSBtYWtlTWFwKCJhcmVhLGJyLGNvbCxocixpbWcsd2JyIik7CgovLyBFbGVtZW50cyB0aGF0IHlvdSBjYW4sIGludGVudGlvbmFsbHksIGxlYXZlIG9wZW4gKGFuZCB3aGljaCBjbG9zZSB0aGVtc2VsdmVzKQovLyBodHRwOi8vZGV2LnczLm9yZy9odG1sNS9zcGVjL092ZXJ2aWV3Lmh0bWwjb3B0aW9uYWwtdGFncwogIHZhciBvcHRpb25hbEVuZFRhZ0Jsb2NrRWxlbWVudHMgPSBtYWtlTWFwKCJjb2xncm91cCxkZCxkdCxsaSxwLHRib2R5LHRkLHRmb290LHRoLHRoZWFkLHRyIiksCiAgICBvcHRpb25hbEVuZFRhZ0lubGluZUVsZW1lbnRzID0gbWFrZU1hcCgicnAscnQiKSwKICAgIG9wdGlvbmFsRW5kVGFnRWxlbWVudHMgPSBhbmd1bGFyLmV4dGVuZCh7fSwKICAgICAgb3B0aW9uYWxFbmRUYWdJbmxpbmVFbGVtZW50cywKICAgICAgb3B0aW9uYWxFbmRUYWdCbG9ja0VsZW1lbnRzKTsKCi8vIFNhZmUgQmxvY2sgRWxlbWVudHMgLSBIVE1MNQogIHZhciBibG9ja0VsZW1lbnRzID0gYW5ndWxhci5leHRlbmQoe30sIG9wdGlvbmFsRW5kVGFnQmxvY2tFbGVtZW50cywgbWFrZU1hcCgiYWRkcmVzcyxhcnRpY2xlLCIgKwogICAgImFzaWRlLGJsb2NrcXVvdGUsY2FwdGlvbixjZW50ZXIsZGVsLGRpcixkaXYsZGwsZmlndXJlLGZpZ2NhcHRpb24sZm9vdGVyLGgxLGgyLGgzLGg0LGg1LCIgKwogICAgImg2LGhlYWRlcixoZ3JvdXAsaHIsaW5zLG1hcCxtZW51LG5hdixvbCxwcmUsc2NyaXB0LHNlY3Rpb24sdGFibGUsdWwiKSk7CgovLyBJbmxpbmUgRWxlbWVudHMgLSBIVE1MNQogIHZhciBpbmxpbmVFbGVtZW50cyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LCBvcHRpb25hbEVuZFRhZ0lubGluZUVsZW1lbnRzLCBtYWtlTWFwKCJhLGFiYnIsYWNyb255bSxiLCIgKwogICAgImJkaSxiZG8sYmlnLGJyLGNpdGUsY29kZSxkZWwsZGZuLGVtLGZvbnQsaSxpbWcsaW5zLGtiZCxsYWJlbCxtYXAsbWFyayxxLHJ1YnkscnAscnQscywiICsKICAgICJzYW1wLHNtYWxsLHNwYW4sc3RyaWtlLHN0cm9uZyxzdWIsc3VwLHRpbWUsdHQsdSx2YXIiKSk7CgoKLy8gU3BlY2lhbCBFbGVtZW50cyAoY2FuIGNvbnRhaW4gYW55dGhpbmcpCiAgdmFyIHNwZWNpYWxFbGVtZW50cyA9IG1ha2VNYXAoInNjcmlwdCxzdHlsZSIpOwoKICB2YXIgdmFsaWRFbGVtZW50cyA9IGFuZ3VsYXIuZXh0ZW5kKHt9LAogICAgdm9pZEVsZW1lbnRzLAogICAgYmxvY2tFbGVtZW50cywKICAgIGlubGluZUVsZW1lbnRzLAogICAgb3B0aW9uYWxFbmRUYWdFbGVtZW50cyk7CgovL0F0dHJpYnV0ZXMgdGhhdCBoYXZlIGhyZWYgYW5kIGhlbmNlIG5lZWQgdG8gYmUgc2FuaXRpemVkCiAgdmFyIHVyaUF0dHJzID0gbWFrZU1hcCgiYmFja2dyb3VuZCxjaXRlLGhyZWYsbG9uZ2Rlc2Msc3JjLHVzZW1hcCIpOwogIHZhciB2YWxpZEF0dHJzID0gYW5ndWxhci5leHRlbmQoe30sIHVyaUF0dHJzLCBtYWtlTWFwKAogICAgICAnYWJicixhbGlnbixhbHQsYXhpcyxiZ2NvbG9yLGJvcmRlcixjZWxscGFkZGluZyxjZWxsc3BhY2luZyxjbGFzcyxjbGVhciwnKwogICAgICAnY29sb3IsY29scyxjb2xzcGFuLGNvbXBhY3QsY29vcmRzLGRpcixmYWNlLGhlYWRlcnMsaGVpZ2h0LGhyZWZsYW5nLGhzcGFjZSwnKwogICAgICAnaXNtYXAsbGFuZyxsYW5ndWFnZSxub2hyZWYsbm93cmFwLHJlbCxyZXYscm93cyxyb3dzcGFuLHJ1bGVzLCcrCiAgICAgICdzY29wZSxzY3JvbGxpbmcsc2hhcGUsc2l6ZSxzcGFuLHN0YXJ0LHN1bW1hcnksdGFyZ2V0LHRpdGxlLHR5cGUsJysKICAgICAgJ3ZhbGlnbix2YWx1ZSx2c3BhY2Usd2lkdGgnKSk7CgogIGZ1bmN0aW9uIG1ha2VNYXAoc3RyKSB7CiAgICB2YXIgb2JqID0ge30sIGl0ZW1zID0gc3RyLnNwbGl0KCcsJyksIGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIG9ialtpdGVtc1tpXV0gPSB0cnVlOwogICAgcmV0dXJuIG9iajsKICB9CgoKICAvKioKICAgKiBAZXhhbXBsZQogICAqIGh0bWxQYXJzZXIoaHRtbFN0cmluZywgewogKiAgICAgc3RhcnQ6IGZ1bmN0aW9uKHRhZywgYXR0cnMsIHVuYXJ5KSB7fSwKICogICAgIGVuZDogZnVuY3Rpb24odGFnKSB7fSwKICogICAgIGNoYXJzOiBmdW5jdGlvbih0ZXh0KSB7fSwKICogICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKHRleHQpIHt9CiAqIH0pOwogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IGh0bWwgc3RyaW5nCiAgICogQHBhcmFtIHtvYmplY3R9IGhhbmRsZXIKICAgKi8KICBmdW5jdGlvbiBodG1sUGFyc2VyKCBodG1sLCBoYW5kbGVyICkgewogICAgdmFyIGluZGV4LCBjaGFycywgbWF0Y2gsIHN0YWNrID0gW10sIGxhc3QgPSBodG1sOwogICAgc3RhY2subGFzdCA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gc3RhY2tbIHN0YWNrLmxlbmd0aCAtIDEgXTsgfTsKCiAgICB3aGlsZSAoIGh0bWwgKSB7CiAgICAgIGNoYXJzID0gdHJ1ZTsKCiAgICAgIC8vIE1ha2Ugc3VyZSB3ZSdyZSBub3QgaW4gYSBzY3JpcHQgb3Igc3R5bGUgZWxlbWVudAogICAgICBpZiAoICFzdGFjay5sYXN0KCkgfHwgIXNwZWNpYWxFbGVtZW50c1sgc3RhY2subGFzdCgpIF0gKSB7CgogICAgICAgIC8vIENvbW1lbnQKICAgICAgICBpZiAoIGh0bWwuaW5kZXhPZigiPCEtLSIpID09PSAwICkgewogICAgICAgICAgLy8gY29tbWVudHMgY29udGFpbmluZyAtLSBhcmUgbm90IGFsbG93ZWQgdW5sZXNzIHRoZXkgdGVybWluYXRlIHRoZSBjb21tZW50CiAgICAgICAgICBpbmRleCA9IGh0bWwuaW5kZXhPZigiLS0iLCA0KTsKCiAgICAgICAgICBpZiAoIGluZGV4ID49IDAgJiYgaHRtbC5sYXN0SW5kZXhPZigiLS0+IiwgaW5kZXgpID09PSBpbmRleCkgewogICAgICAgICAgICBpZiAoaGFuZGxlci5jb21tZW50KSBoYW5kbGVyLmNvbW1lbnQoIGh0bWwuc3Vic3RyaW5nKCA0LCBpbmRleCApICk7CiAgICAgICAgICAgIGh0bWwgPSBodG1sLnN1YnN0cmluZyggaW5kZXggKyAzICk7CiAgICAgICAgICAgIGNoYXJzID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICAvLyBET0NUWVBFCiAgICAgICAgfSBlbHNlIGlmICggRE9DVFlQRV9SRUdFWFAudGVzdChodG1sKSApIHsKICAgICAgICAgIG1hdGNoID0gaHRtbC5tYXRjaCggRE9DVFlQRV9SRUdFWFAgKTsKCiAgICAgICAgICBpZiAoIG1hdGNoICkgewogICAgICAgICAgICBodG1sID0gaHRtbC5yZXBsYWNlKCBtYXRjaFswXSwgJycpOwogICAgICAgICAgICBjaGFycyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgLy8gZW5kIHRhZwogICAgICAgIH0gZWxzZSBpZiAoIEJFR0lOR19FTkRfVEFHRV9SRUdFWFAudGVzdChodG1sKSApIHsKICAgICAgICAgIG1hdGNoID0gaHRtbC5tYXRjaCggRU5EX1RBR19SRUdFWFAgKTsKCiAgICAgICAgICBpZiAoIG1hdGNoICkgewogICAgICAgICAgICBodG1sID0gaHRtbC5zdWJzdHJpbmcoIG1hdGNoWzBdLmxlbmd0aCApOwogICAgICAgICAgICBtYXRjaFswXS5yZXBsYWNlKCBFTkRfVEFHX1JFR0VYUCwgcGFyc2VFbmRUYWcgKTsKICAgICAgICAgICAgY2hhcnMgPSBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBzdGFydCB0YWcKICAgICAgICB9IGVsc2UgaWYgKCBCRUdJTl9UQUdfUkVHRVhQLnRlc3QoaHRtbCkgKSB7CiAgICAgICAgICBtYXRjaCA9IGh0bWwubWF0Y2goIFNUQVJUX1RBR19SRUdFWFAgKTsKCiAgICAgICAgICBpZiAoIG1hdGNoICkgewogICAgICAgICAgICBodG1sID0gaHRtbC5zdWJzdHJpbmcoIG1hdGNoWzBdLmxlbmd0aCApOwogICAgICAgICAgICBtYXRjaFswXS5yZXBsYWNlKCBTVEFSVF9UQUdfUkVHRVhQLCBwYXJzZVN0YXJ0VGFnICk7CiAgICAgICAgICAgIGNoYXJzID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIGNoYXJzICkgewogICAgICAgICAgaW5kZXggPSBodG1sLmluZGV4T2YoIjwiKTsKCiAgICAgICAgICB2YXIgdGV4dCA9IGluZGV4IDwgMCA/IGh0bWwgOiBodG1sLnN1YnN0cmluZyggMCwgaW5kZXggKTsKICAgICAgICAgIGh0bWwgPSBpbmRleCA8IDAgPyAiIiA6IGh0bWwuc3Vic3RyaW5nKCBpbmRleCApOwoKICAgICAgICAgIGlmIChoYW5kbGVyLmNoYXJzKSBoYW5kbGVyLmNoYXJzKCBkZWNvZGVFbnRpdGllcyh0ZXh0KSApOwogICAgICAgIH0KCiAgICAgIH0gZWxzZSB7CiAgICAgICAgaHRtbCA9IGh0bWwucmVwbGFjZShuZXcgUmVnRXhwKCIoLiopPFxccypcXC9cXHMqIiArIHN0YWNrLmxhc3QoKSArICJbXj5dKj4iLCAnaScpLAogICAgICAgICAgZnVuY3Rpb24oYWxsLCB0ZXh0KXsKICAgICAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZShDT01NRU5UX1JFR0VYUCwgIiQxIikucmVwbGFjZShDREFUQV9SRUdFWFAsICIkMSIpOwoKICAgICAgICAgICAgaWYgKGhhbmRsZXIuY2hhcnMpIGhhbmRsZXIuY2hhcnMoIGRlY29kZUVudGl0aWVzKHRleHQpICk7CgogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9KTsKCiAgICAgICAgcGFyc2VFbmRUYWcoICIiLCBzdGFjay5sYXN0KCkgKTsKICAgICAgfQoKICAgICAgaWYgKCBodG1sID09IGxhc3QgKSB7CiAgICAgICAgdGhyb3cgJHNhbml0aXplTWluRXJyKCdiYWRwYXJzZScsICJUaGUgc2FuaXRpemVyIHdhcyB1bmFibGUgdG8gcGFyc2UgdGhlIGZvbGxvd2luZyBibG9jayAiICsKICAgICAgICAgICJvZiBodG1sOiB7MH0iLCBodG1sKTsKICAgICAgfQogICAgICBsYXN0ID0gaHRtbDsKICAgIH0KCiAgICAvLyBDbGVhbiB1cCBhbnkgcmVtYWluaW5nIHRhZ3MKICAgIHBhcnNlRW5kVGFnKCk7CgogICAgZnVuY3Rpb24gcGFyc2VTdGFydFRhZyggdGFnLCB0YWdOYW1lLCByZXN0LCB1bmFyeSApIHsKICAgICAgdGFnTmFtZSA9IGFuZ3VsYXIubG93ZXJjYXNlKHRhZ05hbWUpOwogICAgICBpZiAoIGJsb2NrRWxlbWVudHNbIHRhZ05hbWUgXSApIHsKICAgICAgICB3aGlsZSAoIHN0YWNrLmxhc3QoKSAmJiBpbmxpbmVFbGVtZW50c1sgc3RhY2subGFzdCgpIF0gKSB7CiAgICAgICAgICBwYXJzZUVuZFRhZyggIiIsIHN0YWNrLmxhc3QoKSApOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCBvcHRpb25hbEVuZFRhZ0VsZW1lbnRzWyB0YWdOYW1lIF0gJiYgc3RhY2subGFzdCgpID09IHRhZ05hbWUgKSB7CiAgICAgICAgcGFyc2VFbmRUYWcoICIiLCB0YWdOYW1lICk7CiAgICAgIH0KCiAgICAgIHVuYXJ5ID0gdm9pZEVsZW1lbnRzWyB0YWdOYW1lIF0gfHwgISF1bmFyeTsKCiAgICAgIGlmICggIXVuYXJ5ICkKICAgICAgICBzdGFjay5wdXNoKCB0YWdOYW1lICk7CgogICAgICB2YXIgYXR0cnMgPSB7fTsKCiAgICAgIHJlc3QucmVwbGFjZShBVFRSX1JFR0VYUCwKICAgICAgICBmdW5jdGlvbihtYXRjaCwgbmFtZSwgZG91YmxlUXVvdGVkVmFsdWUsIHNpbmdsZVF1b3RlZFZhbHVlLCB1bnF1b3RlZFZhbHVlKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSBkb3VibGVRdW90ZWRWYWx1ZQogICAgICAgICAgICB8fCBzaW5nbGVRdW90ZWRWYWx1ZQogICAgICAgICAgICB8fCB1bnF1b3RlZFZhbHVlCiAgICAgICAgICAgIHx8ICcnOwoKICAgICAgICAgIGF0dHJzW25hbWVdID0gZGVjb2RlRW50aXRpZXModmFsdWUpOwogICAgICAgIH0pOwogICAgICBpZiAoaGFuZGxlci5zdGFydCkgaGFuZGxlci5zdGFydCggdGFnTmFtZSwgYXR0cnMsIHVuYXJ5ICk7CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VFbmRUYWcoIHRhZywgdGFnTmFtZSApIHsKICAgICAgdmFyIHBvcyA9IDAsIGk7CiAgICAgIHRhZ05hbWUgPSBhbmd1bGFyLmxvd2VyY2FzZSh0YWdOYW1lKTsKICAgICAgaWYgKCB0YWdOYW1lICkKICAgICAgLy8gRmluZCB0aGUgY2xvc2VzdCBvcGVuZWQgdGFnIG9mIHRoZSBzYW1lIHR5cGUKICAgICAgICBmb3IgKCBwb3MgPSBzdGFjay5sZW5ndGggLSAxOyBwb3MgPj0gMDsgcG9zLS0gKQogICAgICAgICAgaWYgKCBzdGFja1sgcG9zIF0gPT0gdGFnTmFtZSApCiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgaWYgKCBwb3MgPj0gMCApIHsKICAgICAgICAvLyBDbG9zZSBhbGwgdGhlIG9wZW4gZWxlbWVudHMsIHVwIHRoZSBzdGFjawogICAgICAgIGZvciAoIGkgPSBzdGFjay5sZW5ndGggLSAxOyBpID49IHBvczsgaS0tICkKICAgICAgICAgIGlmIChoYW5kbGVyLmVuZCkgaGFuZGxlci5lbmQoIHN0YWNrWyBpIF0gKTsKCiAgICAgICAgLy8gUmVtb3ZlIHRoZSBvcGVuIGVsZW1lbnRzIGZyb20gdGhlIHN0YWNrCiAgICAgICAgc3RhY2subGVuZ3RoID0gcG9zOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgaGlkZGVuUHJlPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInByZSIpOwogIHZhciBzcGFjZVJlID0gL14oXHMqKShbXHNcU10qPykoXHMqKSQvOwogIC8qKgogICAqIGRlY29kZXMgYWxsIGVudGl0aWVzIGludG8gcmVndWxhciBzdHJpbmcKICAgKiBAcGFyYW0gdmFsdWUKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBBIHN0cmluZyB3aXRoIGRlY29kZWQgZW50aXRpZXMuCiAgICovCiAgZnVuY3Rpb24gZGVjb2RlRW50aXRpZXModmFsdWUpIHsKICAgIGlmICghdmFsdWUpIHsgcmV0dXJuICcnOyB9CgogICAgLy8gTm90ZTogSUU4IGRvZXMgbm90IHByZXNlcnZlIHNwYWNlcyBhdCB0aGUgc3RhcnQvZW5kIG9mIGlubmVySFRNTAogICAgLy8gc28gd2UgbXVzdCBjYXB0dXJlIHRoZW0gYW5kIHJlYXR0YWNoIHRoZW0gYWZ0ZXJ3YXJkCiAgICB2YXIgcGFydHMgPSBzcGFjZVJlLmV4ZWModmFsdWUpOwogICAgdmFyIHNwYWNlQmVmb3JlID0gcGFydHNbMV07CiAgICB2YXIgc3BhY2VBZnRlciA9IHBhcnRzWzNdOwogICAgdmFyIGNvbnRlbnQgPSBwYXJ0c1syXTsKICAgIGlmIChjb250ZW50KSB7CiAgICAgIGhpZGRlblByZS5pbm5lckhUTUw9Y29udGVudC5yZXBsYWNlKC88L2csIiZsdDsiKTsKICAgICAgLy8gaW5uZXJUZXh0IGRlcGVuZHMgb24gc3R5bGluZyBhcyBpdCBkb2Vzbid0IGRpc3BsYXkgaGlkZGVuIGVsZW1lbnRzLgogICAgICAvLyBUaGVyZWZvcmUsIGl0J3MgYmV0dGVyIHRvIHVzZSB0ZXh0Q29udGVudCBub3QgdG8gY2F1c2UgdW5uZWNlc3NhcnkKICAgICAgLy8gcmVmbG93cy4gSG93ZXZlciwgSUU8OSBkb24ndCBzdXBwb3J0IHRleHRDb250ZW50IHNvIHRoZSBpbm5lclRleHQKICAgICAgLy8gZmFsbGJhY2sgaXMgbmVjZXNzYXJ5LgogICAgICBjb250ZW50ID0gJ3RleHRDb250ZW50JyBpbiBoaWRkZW5QcmUgPwogICAgICAgIGhpZGRlblByZS50ZXh0Q29udGVudCA6IGhpZGRlblByZS5pbm5lclRleHQ7CiAgICB9CiAgICByZXR1cm4gc3BhY2VCZWZvcmUgKyBjb250ZW50ICsgc3BhY2VBZnRlcjsKICB9CgogIC8qKgogICAqIEVzY2FwZXMgYWxsIHBvdGVudGlhbGx5IGRhbmdlcm91cyBjaGFyYWN0ZXJzLCBzbyB0aGF0IHRoZQogICAqIHJlc3VsdGluZyBzdHJpbmcgY2FuIGJlIHNhZmVseSBpbnNlcnRlZCBpbnRvIGF0dHJpYnV0ZSBvcgogICAqIGVsZW1lbnQgdGV4dC4KICAgKiBAcGFyYW0gdmFsdWUKICAgKiBAcmV0dXJucyB7c3RyaW5nfSBlc2NhcGVkIHRleHQKICAgKi8KICBmdW5jdGlvbiBlbmNvZGVFbnRpdGllcyh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLgogICAgICByZXBsYWNlKC8mL2csICcmYW1wOycpLgogICAgICByZXBsYWNlKFNVUlJPR0FURV9QQUlSX1JFR0VYUCwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdmFyIGhpID0gdmFsdWUuY2hhckNvZGVBdCgwKTsKICAgICAgICB2YXIgbG93ID0gdmFsdWUuY2hhckNvZGVBdCgxKTsKICAgICAgICByZXR1cm4gJyYjJyArICgoKGhpIC0gMHhEODAwKSAqIDB4NDAwKSArIChsb3cgLSAweERDMDApICsgMHgxMDAwMCkgKyAnOyc7CiAgICAgIH0pLgogICAgICByZXBsYWNlKE5PTl9BTFBIQU5VTUVSSUNfUkVHRVhQLCBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgcmV0dXJuICcmIycgKyB2YWx1ZS5jaGFyQ29kZUF0KDApICsgJzsnOwogICAgICB9KS4KICAgICAgcmVwbGFjZSgvPC9nLCAnJmx0OycpLgogICAgICByZXBsYWNlKC8+L2csICcmZ3Q7Jyk7CiAgfQoKICAvKioKICAgKiBjcmVhdGUgYW4gSFRNTC9YTUwgd3JpdGVyIHdoaWNoIHdyaXRlcyB0byBidWZmZXIKICAgKiBAcGFyYW0ge0FycmF5fSBidWYgdXNlIGJ1Zi5qYWluKCcnKSB0byBnZXQgb3V0IHNhbml0aXplZCBodG1sIHN0cmluZwogICAqIEByZXR1cm5zIHtvYmplY3R9IGluIHRoZSBmb3JtIG9mIHsKICogICAgIHN0YXJ0OiBmdW5jdGlvbih0YWcsIGF0dHJzLCB1bmFyeSkge30sCiAqICAgICBlbmQ6IGZ1bmN0aW9uKHRhZykge30sCiAqICAgICBjaGFyczogZnVuY3Rpb24odGV4dCkge30sCiAqICAgICBjb21tZW50OiBmdW5jdGlvbih0ZXh0KSB7fQogKiB9CiAgICovCiAgZnVuY3Rpb24gaHRtbFNhbml0aXplV3JpdGVyKGJ1ZiwgdXJpVmFsaWRhdG9yKXsKICAgIHZhciBpZ25vcmUgPSBmYWxzZTsKICAgIHZhciBvdXQgPSBhbmd1bGFyLmJpbmQoYnVmLCBidWYucHVzaCk7CiAgICByZXR1cm4gewogICAgICBzdGFydDogZnVuY3Rpb24odGFnLCBhdHRycywgdW5hcnkpewogICAgICAgIHRhZyA9IGFuZ3VsYXIubG93ZXJjYXNlKHRhZyk7CiAgICAgICAgaWYgKCFpZ25vcmUgJiYgc3BlY2lhbEVsZW1lbnRzW3RhZ10pIHsKICAgICAgICAgIGlnbm9yZSA9IHRhZzsKICAgICAgICB9CiAgICAgICAgaWYgKCFpZ25vcmUgJiYgdmFsaWRFbGVtZW50c1t0YWddID09PSB0cnVlKSB7CiAgICAgICAgICBvdXQoJzwnKTsKICAgICAgICAgIG91dCh0YWcpOwogICAgICAgICAgYW5ndWxhci5mb3JFYWNoKGF0dHJzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKICAgICAgICAgICAgdmFyIGxrZXk9YW5ndWxhci5sb3dlcmNhc2Uoa2V5KTsKICAgICAgICAgICAgdmFyIGlzSW1hZ2UgPSAodGFnID09PSAnaW1nJyAmJiBsa2V5ID09PSAnc3JjJykgfHwgKGxrZXkgPT09ICdiYWNrZ3JvdW5kJyk7CiAgICAgICAgICAgIGlmICh2YWxpZEF0dHJzW2xrZXldID09PSB0cnVlICYmCiAgICAgICAgICAgICAgKHVyaUF0dHJzW2xrZXldICE9PSB0cnVlIHx8IHVyaVZhbGlkYXRvcih2YWx1ZSwgaXNJbWFnZSkpKSB7CiAgICAgICAgICAgICAgb3V0KCcgJyk7CiAgICAgICAgICAgICAgb3V0KGtleSk7CiAgICAgICAgICAgICAgb3V0KCc9IicpOwogICAgICAgICAgICAgIG91dChlbmNvZGVFbnRpdGllcyh2YWx1ZSkpOwogICAgICAgICAgICAgIG91dCgnIicpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIG91dCh1bmFyeSA/ICcvPicgOiAnPicpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZW5kOiBmdW5jdGlvbih0YWcpewogICAgICAgIHRhZyA9IGFuZ3VsYXIubG93ZXJjYXNlKHRhZyk7CiAgICAgICAgaWYgKCFpZ25vcmUgJiYgdmFsaWRFbGVtZW50c1t0YWddID09PSB0cnVlKSB7CiAgICAgICAgICBvdXQoJzwvJyk7CiAgICAgICAgICBvdXQodGFnKTsKICAgICAgICAgIG91dCgnPicpOwogICAgICAgIH0KICAgICAgICBpZiAodGFnID09IGlnbm9yZSkgewogICAgICAgICAgaWdub3JlID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9LAogICAgICBjaGFyczogZnVuY3Rpb24oY2hhcnMpewogICAgICAgIGlmICghaWdub3JlKSB7CiAgICAgICAgICBvdXQoZW5jb2RlRW50aXRpZXMoY2hhcnMpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQoKCi8vIGRlZmluZSBuZ1Nhbml0aXplIG1vZHVsZSBhbmQgcmVnaXN0ZXIgJHNhbml0aXplIHNlcnZpY2UKICBhbmd1bGFyLm1vZHVsZSgnbmdTYW5pdGl6ZScsIFtdKS5wcm92aWRlcignJHNhbml0aXplJywgJFNhbml0aXplUHJvdmlkZXIpOwoKICAvKiBnbG9iYWwgc2FuaXRpemVUZXh0OiBmYWxzZSAqLwoKICAvKioKICAgKiBAbmdkb2MgZmlsdGVyCiAgICogQG5hbWUgbGlua3kKICAgKiBAa2luZCBmdW5jdGlvbgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRmluZHMgbGlua3MgaW4gdGV4dCBpbnB1dCBhbmQgdHVybnMgdGhlbSBpbnRvIGh0bWwgbGlua3MuIFN1cHBvcnRzIGh0dHAvaHR0cHMvZnRwL21haWx0byBhbmQKICAgKiBwbGFpbiBlbWFpbCBhZGRyZXNzIGxpbmtzLgogICAqCiAgICogUmVxdWlyZXMgdGhlIHtAbGluayBuZ1Nhbml0aXplIGBuZ1Nhbml0aXplYH0gbW9kdWxlIHRvIGJlIGluc3RhbGxlZC4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IElucHV0IHRleHQuCiAgICogQHBhcmFtIHtzdHJpbmd9IHRhcmdldCBXaW5kb3cgKF9ibGFua3xfc2VsZnxfcGFyZW50fF90b3ApIG9yIG5hbWVkIGZyYW1lIHRvIG9wZW4gbGlua3MgaW4uCiAgICogQHJldHVybnMge3N0cmluZ30gSHRtbC1saW5raWZpZWQgdGV4dC4KICAgKgogICAqIEB1c2FnZQogICA8c3BhbiBuZy1iaW5kLWh0bWw9Imxpbmt5X2V4cHJlc3Npb24gfCBsaW5reSI+PC9zcGFuPgogICAqCiAgICogQGV4YW1wbGUKICAgPGV4YW1wbGUgbW9kdWxlPSJuZ1Nhbml0aXplIiBkZXBzPSJhbmd1bGFyLXNhbml0aXplLmpzIj4KICAgPGZpbGUgbmFtZT0iaW5kZXguaHRtbCI+CiAgIDxzY3JpcHQ+CiAgIGZ1bmN0aW9uIEN0cmwoJHNjb3BlKSB7CiAgICAgICAgICAgJHNjb3BlLnNuaXBwZXQgPQogICAgICAgICAgICAgJ1ByZXR0eSB0ZXh0IHdpdGggc29tZSBsaW5rczpcbicrCiAgICAgICAgICAgICAnaHR0cDovL2FuZ3VsYXJqcy5vcmcvLFxuJysKICAgICAgICAgICAgICdtYWlsdG86dXNAc29tZXdoZXJlLm9yZyxcbicrCiAgICdhbm90aGVyQHNvbWV3aGVyZS5vcmcsXG4nKwogICAnYW5kIG9uZSBtb3JlOiBmdHA6Ly8xMjcuMC4wLjEvLic7CiAgICRzY29wZS5zbmlwcGV0V2l0aFRhcmdldCA9ICdodHRwOi8vYW5ndWxhcmpzLm9yZy8nOwogICB9CiAgIDwvc2NyaXB0PgogICA8ZGl2IG5nLWNvbnRyb2xsZXI9IkN0cmwiPgogICBTbmlwcGV0OiA8dGV4dGFyZWEgbmctbW9kZWw9InNuaXBwZXQiIGNvbHM9IjYwIiByb3dzPSIzIj48L3RleHRhcmVhPgogICA8dGFibGU+CiAgIDx0cj4KICAgPHRkPkZpbHRlcjwvdGQ+CiAgIDx0ZD5Tb3VyY2U8L3RkPgogICA8dGQ+UmVuZGVyZWQ8L3RkPgogICA8L3RyPgogICA8dHIgaWQ9Imxpbmt5LWZpbHRlciI+CiAgIDx0ZD5saW5reSBmaWx0ZXI8L3RkPgogICA8dGQ+CiAgIDxwcmU+Jmx0O2RpdiBuZy1iaW5kLWh0bWw9InNuaXBwZXQgfCBsaW5reSImZ3Q7PGJyPiZsdDsvZGl2Jmd0OzwvcHJlPgogICA8L3RkPgogICA8dGQ+CiAgIDxkaXYgbmctYmluZC1odG1sPSJzbmlwcGV0IHwgbGlua3kiPjwvZGl2PgogICA8L3RkPgogICA8L3RyPgogICA8dHIgaWQ9Imxpbmt5LXRhcmdldCI+CiAgIDx0ZD5saW5reSB0YXJnZXQ8L3RkPgogICA8dGQ+CiAgIDxwcmU+Jmx0O2RpdiBuZy1iaW5kLWh0bWw9InNuaXBwZXRXaXRoVGFyZ2V0IHwgbGlua3k6J19ibGFuayciJmd0Ozxicj4mbHQ7L2RpdiZndDs8L3ByZT4KICAgPC90ZD4KICAgPHRkPgogICA8ZGl2IG5nLWJpbmQtaHRtbD0ic25pcHBldFdpdGhUYXJnZXQgfCBsaW5reTonX2JsYW5rJyI+PC9kaXY+CiAgIDwvdGQ+CiAgIDwvdHI+CiAgIDx0ciBpZD0iZXNjYXBlZC1odG1sIj4KICAgPHRkPm5vIGZpbHRlcjwvdGQ+CiAgIDx0ZD48cHJlPiZsdDtkaXYgbmctYmluZD0ic25pcHBldCImZ3Q7PGJyPiZsdDsvZGl2Jmd0OzwvcHJlPjwvdGQ+CiAgIDx0ZD48ZGl2IG5nLWJpbmQ9InNuaXBwZXQiPjwvZGl2PjwvdGQ+CiAgIDwvdHI+CiAgIDwvdGFibGU+CiAgIDwvZmlsZT4KICAgPGZpbGUgbmFtZT0icHJvdHJhY3Rvci5qcyIgdHlwZT0icHJvdHJhY3RvciI+CiAgIGl0KCdzaG91bGQgbGlua2lmeSB0aGUgc25pcHBldCB3aXRoIHVybHMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2xpbmt5LWZpbHRlcicpKS5lbGVtZW50KGJ5LmJpbmRpbmcoJ3NuaXBwZXQgfCBsaW5reScpKS5nZXRUZXh0KCkpLgogICAgICAgICAgICAgdG9CZSgnUHJldHR5IHRleHQgd2l0aCBzb21lIGxpbmtzOiBodHRwOi8vYW5ndWxhcmpzLm9yZy8sIHVzQHNvbWV3aGVyZS5vcmcsICcgKwogICAnYW5vdGhlckBzb21ld2hlcmUub3JnLCBhbmQgb25lIG1vcmU6IGZ0cDovLzEyNy4wLjAuMS8uJyk7CiAgIGV4cGVjdChlbGVtZW50LmFsbChieS5jc3MoJyNsaW5reS1maWx0ZXIgYScpKS5jb3VudCgpKS50b0VxdWFsKDQpOwogICB9KTsKCiAgIGl0KCdzaG91bGQgbm90IGxpbmtpZnkgc25pcHBldCB3aXRob3V0IHRoZSBsaW5reSBmaWx0ZXInLCBmdW5jdGlvbigpIHsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuaWQoJ2VzY2FwZWQtaHRtbCcpKS5lbGVtZW50KGJ5LmJpbmRpbmcoJ3NuaXBwZXQnKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgIHRvQmUoJ1ByZXR0eSB0ZXh0IHdpdGggc29tZSBsaW5rczogaHR0cDovL2FuZ3VsYXJqcy5vcmcvLCBtYWlsdG86dXNAc29tZXdoZXJlLm9yZywgJyArCiAgICdhbm90aGVyQHNvbWV3aGVyZS5vcmcsIGFuZCBvbmUgbW9yZTogZnRwOi8vMTI3LjAuMC4xLy4nKTsKICAgZXhwZWN0KGVsZW1lbnQuYWxsKGJ5LmNzcygnI2VzY2FwZWQtaHRtbCBhJykpLmNvdW50KCkpLnRvRXF1YWwoMCk7CiAgIH0pOwoKICAgaXQoJ3Nob3VsZCB1cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgZWxlbWVudChieS5tb2RlbCgnc25pcHBldCcpKS5jbGVhcigpOwogICAgICAgICBlbGVtZW50KGJ5Lm1vZGVsKCdzbmlwcGV0JykpLnNlbmRLZXlzKCduZXcgaHR0cDovL2xpbmsuJyk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdsaW5reS1maWx0ZXInKSkuZWxlbWVudChieS5iaW5kaW5nKCdzbmlwcGV0IHwgbGlua3knKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgIHRvQmUoJ25ldyBodHRwOi8vbGluay4nKTsKICAgICAgICAgZXhwZWN0KGVsZW1lbnQuYWxsKGJ5LmNzcygnI2xpbmt5LWZpbHRlciBhJykpLmNvdW50KCkpLnRvRXF1YWwoMSk7CiAgICAgICAgIGV4cGVjdChlbGVtZW50KGJ5LmlkKCdlc2NhcGVkLWh0bWwnKSkuZWxlbWVudChieS5iaW5kaW5nKCdzbmlwcGV0JykpLmdldFRleHQoKSkKICAgICAgICAgICAgIC50b0JlKCduZXcgaHR0cDovL2xpbmsuJyk7CiAgICAgICB9KTsKCiAgIGl0KCdzaG91bGQgd29yayB3aXRoIHRoZSB0YXJnZXQgcHJvcGVydHknLCBmdW5jdGlvbigpIHsKICAgICAgICBleHBlY3QoZWxlbWVudChieS5pZCgnbGlua3ktdGFyZ2V0JykpLgogICAgICAgICAgICBlbGVtZW50KGJ5LmJpbmRpbmcoInNuaXBwZXRXaXRoVGFyZ2V0IHwgbGlua3k6J19ibGFuayciKSkuZ2V0VGV4dCgpKS4KICAgICAgICAgICAgdG9CZSgnaHR0cDovL2FuZ3VsYXJqcy5vcmcvJyk7CiAgICAgICAgZXhwZWN0KGVsZW1lbnQoYnkuY3NzKCcjbGlua3ktdGFyZ2V0IGEnKSkuZ2V0QXR0cmlidXRlKCd0YXJnZXQnKSkudG9FcXVhbCgnX2JsYW5rJyk7CiAgICAgICB9KTsKICAgPC9maWxlPgogICA8L2V4YW1wbGU+CiAgICovCiAgYW5ndWxhci5tb2R1bGUoJ25nU2FuaXRpemUnKS5maWx0ZXIoJ2xpbmt5JywgWyckc2FuaXRpemUnLCBmdW5jdGlvbigkc2FuaXRpemUpIHsKICAgIHZhciBMSU5LWV9VUkxfUkVHRVhQID0KICAgICAgICAvKChmdHB8aHR0cHM/KTpcL1wvfChtYWlsdG86KT9bQS1aYS16MC05Ll8lKy1dK0ApXFMqW15ccy47LCgpe308Pl0vLAogICAgICBNQUlMVE9fUkVHRVhQID0gL15tYWlsdG86LzsKCiAgICByZXR1cm4gZnVuY3Rpb24odGV4dCwgdGFyZ2V0KSB7CiAgICAgIGlmICghdGV4dCkgcmV0dXJuIHRleHQ7CiAgICAgIHZhciBtYXRjaDsKICAgICAgdmFyIHJhdyA9IHRleHQ7CiAgICAgIHZhciBodG1sID0gW107CiAgICAgIHZhciB1cmw7CiAgICAgIHZhciBpOwogICAgICB3aGlsZSAoKG1hdGNoID0gcmF3Lm1hdGNoKExJTktZX1VSTF9SRUdFWFApKSkgewogICAgICAgIC8vIFdlIGNhbiBub3QgZW5kIGluIHRoZXNlIGFzIHRoZXkgYXJlIHNvbWV0aW1lcyBmb3VuZCBhdCB0aGUgZW5kIG9mIHRoZSBzZW50ZW5jZQogICAgICAgIHVybCA9IG1hdGNoWzBdOwogICAgICAgIC8vIGlmIHdlIGRpZCBub3QgbWF0Y2ggZnRwL2h0dHAvbWFpbHRvIHRoZW4gYXNzdW1lIG1haWx0bwogICAgICAgIGlmIChtYXRjaFsyXSA9PSBtYXRjaFszXSkgdXJsID0gJ21haWx0bzonICsgdXJsOwogICAgICAgIGkgPSBtYXRjaC5pbmRleDsKICAgICAgICBhZGRUZXh0KHJhdy5zdWJzdHIoMCwgaSkpOwogICAgICAgIGFkZExpbmsodXJsLCBtYXRjaFswXS5yZXBsYWNlKE1BSUxUT19SRUdFWFAsICcnKSk7CiAgICAgICAgcmF3ID0gcmF3LnN1YnN0cmluZyhpICsgbWF0Y2hbMF0ubGVuZ3RoKTsKICAgICAgfQogICAgICBhZGRUZXh0KHJhdyk7CiAgICAgIHJldHVybiAkc2FuaXRpemUoaHRtbC5qb2luKCcnKSk7CgogICAgICBmdW5jdGlvbiBhZGRUZXh0KHRleHQpIHsKICAgICAgICBpZiAoIXRleHQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaHRtbC5wdXNoKHNhbml0aXplVGV4dCh0ZXh0KSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGFkZExpbmsodXJsLCB0ZXh0KSB7CiAgICAgICAgaHRtbC5wdXNoKCc8YSAnKTsKICAgICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQodGFyZ2V0KSkgewogICAgICAgICAgaHRtbC5wdXNoKCd0YXJnZXQ9IicpOwogICAgICAgICAgaHRtbC5wdXNoKHRhcmdldCk7CiAgICAgICAgICBodG1sLnB1c2goJyIgJyk7CiAgICAgICAgfQogICAgICAgIGh0bWwucHVzaCgnaHJlZj0iJyk7CiAgICAgICAgaHRtbC5wdXNoKHVybCk7CiAgICAgICAgaHRtbC5wdXNoKCciPicpOwogICAgICAgIGFkZFRleHQodGV4dCk7CiAgICAgICAgaHRtbC5wdXNoKCc8L2E+Jyk7CiAgICAgIH0KICAgIH07CiAgfV0pOwoKCn0pKHdpbmRvdywgd2luZG93LmFuZ3VsYXIpOwoKLyohCiAqIGlvbmljLmJ1bmRsZS5qcyBpcyBhIGNvbmNhdGVuYXRpb24gb2Y6CiAqIGlvbmljLmpzLCBhbmd1bGFyLmpzLCBhbmd1bGFyLWFuaW1hdGUuanMsCiAqIGFuZ3VsYXItc2FuaXRpemUuanMsIGFuZ3VsYXItdWktcm91dGVyLmpzLAogKiBhbmQgaW9uaWMtYW5ndWxhci5qcwogKi8KCi8qKgogKiBTdGF0ZS1iYXNlZCByb3V0aW5nIGZvciBBbmd1bGFySlMKICogQHZlcnNpb24gdjAuMi4xMAogKiBAbGluayBodHRwOi8vYW5ndWxhci11aS5naXRodWIuY29tLwogKiBAbGljZW5zZSBNSVQgTGljZW5zZSwgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9NSVQKICovCgovKiBjb21tb25qcyBwYWNrYWdlIG1hbmFnZXIgc3VwcG9ydCAoZWcgY29tcG9uZW50anMpICovCmlmICh0eXBlb2YgbW9kdWxlICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgZXhwb3J0cyAhPT0gInVuZGVmaW5lZCIgJiYgbW9kdWxlLmV4cG9ydHMgPT09IGV4cG9ydHMpewogIG1vZHVsZS5leHBvcnRzID0gJ3VpLnJvdXRlcic7Cn0KCihmdW5jdGlvbiAod2luZG93LCBhbmd1bGFyLCB1bmRlZmluZWQpIHsKICAvKmpzaGludCBnbG9iYWxzdHJpY3Q6dHJ1ZSovCiAgLypnbG9iYWwgYW5ndWxhcjpmYWxzZSovCiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgaXNEZWZpbmVkID0gYW5ndWxhci5pc0RlZmluZWQsCiAgICBpc0Z1bmN0aW9uID0gYW5ndWxhci5pc0Z1bmN0aW9uLAogICAgaXNTdHJpbmcgPSBhbmd1bGFyLmlzU3RyaW5nLAogICAgaXNPYmplY3QgPSBhbmd1bGFyLmlzT2JqZWN0LAogICAgaXNBcnJheSA9IGFuZ3VsYXIuaXNBcnJheSwKICAgIGZvckVhY2ggPSBhbmd1bGFyLmZvckVhY2gsCiAgICBleHRlbmQgPSBhbmd1bGFyLmV4dGVuZCwKICAgIGNvcHkgPSBhbmd1bGFyLmNvcHk7CgogIGZ1bmN0aW9uIGluaGVyaXQocGFyZW50LCBleHRyYSkgewogICAgcmV0dXJuIGV4dGVuZChuZXcgKGV4dGVuZChmdW5jdGlvbigpIHt9LCB7IHByb3RvdHlwZTogcGFyZW50IH0pKSgpLCBleHRyYSk7CiAgfQoKICBmdW5jdGlvbiBtZXJnZShkc3QpIHsKICAgIGZvckVhY2goYXJndW1lbnRzLCBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iaiAhPT0gZHN0KSB7CiAgICAgICAgZm9yRWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICAgIGlmICghZHN0Lmhhc093blByb3BlcnR5KGtleSkpIGRzdFtrZXldID0gdmFsdWU7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGRzdDsKICB9CgogIC8qKgogICAqIEZpbmRzIHRoZSBjb21tb24gYW5jZXN0b3IgcGF0aCBiZXR3ZWVuIHR3byBzdGF0ZXMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gZmlyc3QgVGhlIGZpcnN0IHN0YXRlLgogICAqIEBwYXJhbSB7T2JqZWN0fSBzZWNvbmQgVGhlIHNlY29uZCBzdGF0ZS4KICAgKiBAcmV0dXJuIHtBcnJheX0gUmV0dXJucyBhbiBhcnJheSBvZiBzdGF0ZSBuYW1lcyBpbiBkZXNjZW5kaW5nIG9yZGVyLCBub3QgaW5jbHVkaW5nIHRoZSByb290LgogICAqLwogIGZ1bmN0aW9uIGFuY2VzdG9ycyhmaXJzdCwgc2Vjb25kKSB7CiAgICB2YXIgcGF0aCA9IFtdOwoKICAgIGZvciAodmFyIG4gaW4gZmlyc3QucGF0aCkgewogICAgICBpZiAoZmlyc3QucGF0aFtuXSAhPT0gc2Vjb25kLnBhdGhbbl0pIGJyZWFrOwogICAgICBwYXRoLnB1c2goZmlyc3QucGF0aFtuXSk7CiAgICB9CiAgICByZXR1cm4gcGF0aDsKICB9CgogIC8qKgogICAqIElFOC1zYWZlIHdyYXBwZXIgZm9yIGBPYmplY3Qua2V5cygpYC4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgQSBKYXZhU2NyaXB0IG9iamVjdC4KICAgKiBAcmV0dXJuIHtBcnJheX0gUmV0dXJucyB0aGUga2V5cyBvZiB0aGUgb2JqZWN0IGFzIGFuIGFycmF5LgogICAqLwogIGZ1bmN0aW9uIGtleXMob2JqZWN0KSB7CiAgICBpZiAoT2JqZWN0LmtleXMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKG9iamVjdCk7CiAgICB9CiAgICB2YXIgcmVzdWx0ID0gW107CgogICAgYW5ndWxhci5mb3JFYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsLCBrZXkpIHsKICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIC8qKgogICAqIElFOC1zYWZlIHdyYXBwZXIgZm9yIGBBcnJheS5wcm90b3R5cGUuaW5kZXhPZigpYC4KICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IEEgSmF2YVNjcmlwdCBhcnJheS4KICAgKiBAcGFyYW0geyp9IHZhbHVlIEEgdmFsdWUgdG8gc2VhcmNoIHRoZSBhcnJheSBmb3IuCiAgICogQHJldHVybiB7TnVtYmVyfSBSZXR1cm5zIHRoZSBhcnJheSBpbmRleCB2YWx1ZSBvZiBgdmFsdWVgLCBvciBgLTFgIGlmIG5vdCBwcmVzZW50LgogICAqLwogIGZ1bmN0aW9uIGFycmF5U2VhcmNoKGFycmF5LCB2YWx1ZSkgewogICAgaWYgKEFycmF5LnByb3RvdHlwZS5pbmRleE9mKSB7CiAgICAgIHJldHVybiBhcnJheS5pbmRleE9mKHZhbHVlLCBOdW1iZXIoYXJndW1lbnRzWzJdKSB8fCAwKTsKICAgIH0KICAgIHZhciBsZW4gPSBhcnJheS5sZW5ndGggPj4+IDAsIGZyb20gPSBOdW1iZXIoYXJndW1lbnRzWzJdKSB8fCAwOwogICAgZnJvbSA9IChmcm9tIDwgMCkgPyBNYXRoLmNlaWwoZnJvbSkgOiBNYXRoLmZsb29yKGZyb20pOwoKICAgIGlmIChmcm9tIDwgMCkgZnJvbSArPSBsZW47CgogICAgZm9yICg7IGZyb20gPCBsZW47IGZyb20rKykgewogICAgICBpZiAoZnJvbSBpbiBhcnJheSAmJiBhcnJheVtmcm9tXSA9PT0gdmFsdWUpIHJldHVybiBmcm9tOwogICAgfQogICAgcmV0dXJuIC0xOwogIH0KCiAgLyoqCiAgICogTWVyZ2VzIGEgc2V0IG9mIHBhcmFtZXRlcnMgd2l0aCBhbGwgcGFyYW1ldGVycyBpbmhlcml0ZWQgYmV0d2VlbiB0aGUgY29tbW9uIHBhcmVudHMgb2YgdGhlCiAgICogY3VycmVudCBzdGF0ZSBhbmQgYSBnaXZlbiBkZXN0aW5hdGlvbiBzdGF0ZS4KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBjdXJyZW50UGFyYW1zIFRoZSB2YWx1ZSBvZiB0aGUgY3VycmVudCBzdGF0ZSBwYXJhbWV0ZXJzICgkc3RhdGVQYXJhbXMpLgogICAqIEBwYXJhbSB7T2JqZWN0fSBuZXdQYXJhbXMgVGhlIHNldCBvZiBwYXJhbWV0ZXJzIHdoaWNoIHdpbGwgYmUgY29tcG9zaXRlZCB3aXRoIGluaGVyaXRlZCBwYXJhbXMuCiAgICogQHBhcmFtIHtPYmplY3R9ICRjdXJyZW50IEludGVybmFsIGRlZmluaXRpb24gb2Ygb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgY3VycmVudCBzdGF0ZS4KICAgKiBAcGFyYW0ge09iamVjdH0gJHRvIEludGVybmFsIGRlZmluaXRpb24gb2Ygb2JqZWN0IHJlcHJlc2VudGluZyBzdGF0ZSB0byB0cmFuc2l0aW9uIHRvLgogICAqLwogIGZ1bmN0aW9uIGluaGVyaXRQYXJhbXMoY3VycmVudFBhcmFtcywgbmV3UGFyYW1zLCAkY3VycmVudCwgJHRvKSB7CiAgICB2YXIgcGFyZW50cyA9IGFuY2VzdG9ycygkY3VycmVudCwgJHRvKSwgcGFyZW50UGFyYW1zLCBpbmhlcml0ZWQgPSB7fSwgaW5oZXJpdExpc3QgPSBbXTsKCiAgICBmb3IgKHZhciBpIGluIHBhcmVudHMpIHsKICAgICAgaWYgKCFwYXJlbnRzW2ldLnBhcmFtcyB8fCAhcGFyZW50c1tpXS5wYXJhbXMubGVuZ3RoKSBjb250aW51ZTsKICAgICAgcGFyZW50UGFyYW1zID0gcGFyZW50c1tpXS5wYXJhbXM7CgogICAgICBmb3IgKHZhciBqIGluIHBhcmVudFBhcmFtcykgewogICAgICAgIGlmIChhcnJheVNlYXJjaChpbmhlcml0TGlzdCwgcGFyZW50UGFyYW1zW2pdKSA+PSAwKSBjb250aW51ZTsKICAgICAgICBpbmhlcml0TGlzdC5wdXNoKHBhcmVudFBhcmFtc1tqXSk7CiAgICAgICAgaW5oZXJpdGVkW3BhcmVudFBhcmFtc1tqXV0gPSBjdXJyZW50UGFyYW1zW3BhcmVudFBhcmFtc1tqXV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBleHRlbmQoe30sIGluaGVyaXRlZCwgbmV3UGFyYW1zKTsKICB9CgogIC8qKgogICAqIE5vcm1hbGl6ZXMgYSBzZXQgb2YgdmFsdWVzIHRvIHN0cmluZyBvciBgbnVsbGAsIGZpbHRlcmluZyB0aGVtIGJ5IGEgbGlzdCBvZiBrZXlzLgogICAqCiAgICogQHBhcmFtIHtBcnJheX0ga2V5cyBUaGUgbGlzdCBvZiBrZXlzIHRvIG5vcm1hbGl6ZS9yZXR1cm4uCiAgICogQHBhcmFtIHtPYmplY3R9IHZhbHVlcyBBbiBvYmplY3QgaGFzaCBvZiB2YWx1ZXMgdG8gbm9ybWFsaXplLgogICAqIEByZXR1cm4ge09iamVjdH0gUmV0dXJucyBhbiBvYmplY3QgaGFzaCBvZiBub3JtYWxpemVkIHN0cmluZyB2YWx1ZXMuCiAgICovCiAgZnVuY3Rpb24gbm9ybWFsaXplKGtleXMsIHZhbHVlcykgewogICAgdmFyIG5vcm1hbGl6ZWQgPSB7fTsKCiAgICBmb3JFYWNoKGtleXMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHZhciB2YWx1ZSA9IHZhbHVlc1tuYW1lXTsKICAgICAgbm9ybWFsaXplZFtuYW1lXSA9ICh2YWx1ZSAhPSBudWxsKSA/IFN0cmluZyh2YWx1ZSkgOiBudWxsOwogICAgfSk7CiAgICByZXR1cm4gbm9ybWFsaXplZDsKICB9CgogIC8qKgogICAqIFBlcmZvcm1zIGEgbm9uLXN0cmljdCBjb21wYXJpc29uIG9mIHRoZSBzdWJzZXQgb2YgdHdvIG9iamVjdHMsIGRlZmluZWQgYnkgYSBsaXN0IG9mIGtleXMuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gYSBUaGUgZmlyc3Qgb2JqZWN0LgogICAqIEBwYXJhbSB7T2JqZWN0fSBiIFRoZSBzZWNvbmQgb2JqZWN0LgogICAqIEBwYXJhbSB7QXJyYXl9IGtleXMgVGhlIGxpc3Qgb2Yga2V5cyB3aXRoaW4gZWFjaCBvYmplY3QgdG8gY29tcGFyZS4gSWYgdGhlIGxpc3QgaXMgZW1wdHkgb3Igbm90IHNwZWNpZmllZCwKICAgKiAgICAgICAgICAgICAgICAgICAgIGl0IGRlZmF1bHRzIHRvIHRoZSBsaXN0IG9mIGtleXMgaW4gYGFgLgogICAqIEByZXR1cm4ge0Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBrZXlzIG1hdGNoLCBvdGhlcndpc2UgYGZhbHNlYC4KICAgKi8KICBmdW5jdGlvbiBlcXVhbEZvcktleXMoYSwgYiwga2V5cykgewogICAgaWYgKCFrZXlzKSB7CiAgICAgIGtleXMgPSBbXTsKICAgICAgZm9yICh2YXIgbiBpbiBhKSBrZXlzLnB1c2gobik7IC8vIFVzZWQgaW5zdGVhZCBvZiBPYmplY3Qua2V5cygpIGZvciBJRTggY29tcGF0aWJpbGl0eQogICAgfQoKICAgIGZvciAodmFyIGk9MDsgaTxrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBrID0ga2V5c1tpXTsKICAgICAgaWYgKGFba10gIT0gYltrXSkgcmV0dXJuIGZhbHNlOyAvLyBOb3QgJz09PScsIHZhbHVlcyBhcmVuJ3QgbmVjZXNzYXJpbHkgbm9ybWFsaXplZAogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQoKICAvKioKICAgKiBSZXR1cm5zIHRoZSBzdWJzZXQgb2YgYW4gb2JqZWN0LCBiYXNlZCBvbiBhIGxpc3Qgb2Yga2V5cy4KICAgKgogICAqIEBwYXJhbSB7QXJyYXl9IGtleXMKICAgKiBAcGFyYW0ge09iamVjdH0gdmFsdWVzCiAgICogQHJldHVybiB7Qm9vbGVhbn0gUmV0dXJucyBhIHN1YnNldCBvZiBgdmFsdWVzYC4KICAgKi8KICBmdW5jdGlvbiBmaWx0ZXJCeUtleXMoa2V5cywgdmFsdWVzKSB7CiAgICB2YXIgZmlsdGVyZWQgPSB7fTsKCiAgICBmb3JFYWNoKGtleXMsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIGZpbHRlcmVkW25hbWVdID0gdmFsdWVzW25hbWVdOwogICAgfSk7CiAgICByZXR1cm4gZmlsdGVyZWQ7CiAgfQogIC8qKgogICAqIEBuZ2RvYyBvdmVydmlldwogICAqIEBuYW1lIHVpLnJvdXRlci51dGlsCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiAjIHVpLnJvdXRlci51dGlsIHN1Yi1tb2R1bGUKICAgKgogICAqIFRoaXMgbW9kdWxlIGlzIGEgZGVwZW5kZW5jeSBvZiBvdGhlciBzdWItbW9kdWxlcy4gRG8gbm90IGluY2x1ZGUgdGhpcyBtb2R1bGUgYXMgYSBkZXBlbmRlbmN5CiAgICogaW4geW91ciBhbmd1bGFyIGFwcCAodXNlIHtAbGluayB1aS5yb3V0ZXJ9IG1vZHVsZSBpbnN0ZWFkKS4KICAgKgogICAqLwogIGFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIudXRpbCcsIFsnbmcnXSk7CgogIC8qKgogICAqIEBuZ2RvYyBvdmVydmlldwogICAqIEBuYW1lIHVpLnJvdXRlci5yb3V0ZXIKICAgKgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIudXRpbAogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogIyB1aS5yb3V0ZXIucm91dGVyIHN1Yi1tb2R1bGUKICAgKgogICAqIFRoaXMgbW9kdWxlIGlzIGEgZGVwZW5kZW5jeSBvZiBvdGhlciBzdWItbW9kdWxlcy4gRG8gbm90IGluY2x1ZGUgdGhpcyBtb2R1bGUgYXMgYSBkZXBlbmRlbmN5CiAgICogaW4geW91ciBhbmd1bGFyIGFwcCAodXNlIHtAbGluayB1aS5yb3V0ZXJ9IG1vZHVsZSBpbnN0ZWFkKS4KICAgKi8KICBhbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnJvdXRlcicsIFsndWkucm91dGVyLnV0aWwnXSk7CgogIC8qKgogICAqIEBuZ2RvYyBvdmVydmlldwogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZQogICAqCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5yb3V0ZXIKICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnV0aWwKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqICMgdWkucm91dGVyLnN0YXRlIHN1Yi1tb2R1bGUKICAgKgogICAqIFRoaXMgbW9kdWxlIGlzIGEgZGVwZW5kZW5jeSBvZiB0aGUgbWFpbiB1aS5yb3V0ZXIgbW9kdWxlLiBEbyBub3QgaW5jbHVkZSB0aGlzIG1vZHVsZSBhcyBhIGRlcGVuZGVuY3kKICAgKiBpbiB5b3VyIGFuZ3VsYXIgYXBwICh1c2Uge0BsaW5rIHVpLnJvdXRlcn0gbW9kdWxlIGluc3RlYWQpLgogICAqCiAgICovCiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5zdGF0ZScsIFsndWkucm91dGVyLnJvdXRlcicsICd1aS5yb3V0ZXIudXRpbCddKTsKCiAgLyoqCiAgICogQG5nZG9jIG92ZXJ2aWV3CiAgICogQG5hbWUgdWkucm91dGVyCiAgICoKICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiAjIHVpLnJvdXRlcgogICAqCiAgICogIyMgVGhlIG1haW4gbW9kdWxlIGZvciB1aS5yb3V0ZXIKICAgKiBUaGVyZSBhcmUgc2V2ZXJhbCBzdWItbW9kdWxlcyBpbmNsdWRlZCB3aXRoIHRoZSB1aS5yb3V0ZXIgbW9kdWxlLCBob3dldmVyIG9ubHkgdGhpcyBtb2R1bGUgaXMgbmVlZGVkCiAgICogYXMgYSBkZXBlbmRlbmN5IHdpdGhpbiB5b3VyIGFuZ3VsYXIgYXBwLiBUaGUgb3RoZXIgbW9kdWxlcyBhcmUgZm9yIG9yZ2FuaXphdGlvbiBwdXJwb3Nlcy4KICAgKgogICAqIFRoZSBtb2R1bGVzIGFyZToKICAgKiAqIHVpLnJvdXRlciAtIHRoZSBtYWluICJ1bWJyZWxsYSIgbW9kdWxlCiAgICogKiB1aS5yb3V0ZXIucm91dGVyIC0KICAgKgogICAqICpZb3UnbGwgbmVlZCB0byBpbmNsdWRlICoqb25seSoqIHRoaXMgbW9kdWxlIGFzIHRoZSBkZXBlbmRlbmN5IHdpdGhpbiB5b3VyIGFuZ3VsYXIgYXBwLioKICAgKgogICAqIDxwcmU+CiAgICogPCFkb2N0eXBlIGh0bWw+CiAgICogPGh0bWwgbmctYXBwPSJteUFwcCI+CiAgICogPGhlYWQ+CiAgICogICA8c2NyaXB0IHNyYz0ianMvYW5ndWxhci5qcyI+PC9zY3JpcHQ+CiAgICogICA8IS0tIEluY2x1ZGUgdGhlIHVpLXJvdXRlciBzY3JpcHQgLS0+CiAgICogICA8c2NyaXB0IHNyYz0ianMvYW5ndWxhci11aS1yb3V0ZXIubWluLmpzIj48L3NjcmlwdD4KICAgKiAgIDxzY3JpcHQ+CiAgICogICAgIC8vIC4uLmFuZCBhZGQgJ3VpLnJvdXRlcicgYXMgYSBkZXBlbmRlbmN5CiAgICogICAgIHZhciBteUFwcCA9IGFuZ3VsYXIubW9kdWxlKCdteUFwcCcsIFsndWkucm91dGVyJ10pOwogICAqICAgPC9zY3JpcHQ+CiAgICogPC9oZWFkPgogICAqIDxib2R5PgogICAqIDwvYm9keT4KICAgKiA8L2h0bWw+CiAgICogPC9wcmU+CiAgICovCiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlcicsIFsndWkucm91dGVyLnN0YXRlJ10pOwoKICBhbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLmNvbXBhdCcsIFsndWkucm91dGVyJ10pOwoKICAvKioKICAgKiBAbmdkb2Mgb2JqZWN0CiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHJlc29sdmUKICAgKgogICAqIEByZXF1aXJlcyAkcQogICAqIEByZXF1aXJlcyAkaW5qZWN0b3IKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIE1hbmFnZXMgcmVzb2x1dGlvbiBvZiAoYWN5Y2xpYykgZ3JhcGhzIG9mIHByb21pc2VzLgogICAqLwogICRSZXNvbHZlLiRpbmplY3QgPSBbJyRxJywgJyRpbmplY3RvciddOwogIGZ1bmN0aW9uICRSZXNvbHZlKCAgJHEsICAgICRpbmplY3RvcikgewoKICAgIHZhciBWSVNJVF9JTl9QUk9HUkVTUyA9IDEsCiAgICAgIFZJU0lUX0RPTkUgPSAyLAogICAgICBOT1RISU5HID0ge30sCiAgICAgIE5PX0RFUEVOREVOQ0lFUyA9IFtdLAogICAgICBOT19MT0NBTFMgPSBOT1RISU5HLAogICAgICBOT19QQVJFTlQgPSBleHRlbmQoJHEud2hlbihOT1RISU5HKSwgeyAkJHByb21pc2VzOiBOT1RISU5HLCAkJHZhbHVlczogTk9USElORyB9KTsKCgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLiRyZXNvbHZlI3N0dWR5CiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHJlc29sdmUKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFN0dWRpZXMgYSBzZXQgb2YgaW52b2NhYmxlcyB0aGF0IGFyZSBsaWtlbHkgdG8gYmUgdXNlZCBtdWx0aXBsZSB0aW1lcy4KICAgICAqIDxwcmU+CiAgICAgKiAkcmVzb2x2ZS5zdHVkeShpbnZvY2FibGVzKShsb2NhbHMsIHBhcmVudCwgc2VsZikKICAgICAqIDwvcHJlPgogICAgICogaXMgZXF1aXZhbGVudCB0bwogICAgICogPHByZT4KICAgICAqICRyZXNvbHZlLnJlc29sdmUoaW52b2NhYmxlcywgbG9jYWxzLCBwYXJlbnQsIHNlbGYpCiAgICAgKiA8L3ByZT4KICAgICAqIGJ1dCB0aGUgZm9ybWVyIGlzIG1vcmUgZWZmaWNpZW50IChpbiBmYWN0IGByZXNvbHZlYCBqdXN0IGNhbGxzIGBzdHVkeWAKICAgICAqIGludGVybmFsbHkpLgogICAgICoKICAgICAqIEBwYXJhbSB7b2JqZWN0fSBpbnZvY2FibGVzIEludm9jYWJsZSBvYmplY3RzCiAgICAgKiBAcmV0dXJuIHtmdW5jdGlvbn0gYSBmdW5jdGlvbiB0byBwYXNzIGluIGxvY2FscywgcGFyZW50IGFuZCBzZWxmCiAgICAgKi8KICAgIHRoaXMuc3R1ZHkgPSBmdW5jdGlvbiAoaW52b2NhYmxlcykgewogICAgICBpZiAoIWlzT2JqZWN0KGludm9jYWJsZXMpKSB0aHJvdyBuZXcgRXJyb3IoIidpbnZvY2FibGVzJyBtdXN0IGJlIGFuIG9iamVjdCIpOwoKICAgICAgLy8gUGVyZm9ybSBhIHRvcG9sb2dpY2FsIHNvcnQgb2YgaW52b2NhYmxlcyB0byBidWlsZCBhbiBvcmRlcmVkIHBsYW4KICAgICAgdmFyIHBsYW4gPSBbXSwgY3ljbGUgPSBbXSwgdmlzaXRlZCA9IHt9OwogICAgICBmdW5jdGlvbiB2aXNpdCh2YWx1ZSwga2V5KSB7CiAgICAgICAgaWYgKHZpc2l0ZWRba2V5XSA9PT0gVklTSVRfRE9ORSkgcmV0dXJuOwoKICAgICAgICBjeWNsZS5wdXNoKGtleSk7CiAgICAgICAgaWYgKHZpc2l0ZWRba2V5XSA9PT0gVklTSVRfSU5fUFJPR1JFU1MpIHsKICAgICAgICAgIGN5Y2xlLnNwbGljZSgwLCBjeWNsZS5pbmRleE9mKGtleSkpOwogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDeWNsaWMgZGVwZW5kZW5jeTogIiArIGN5Y2xlLmpvaW4oIiAtPiAiKSk7CiAgICAgICAgfQogICAgICAgIHZpc2l0ZWRba2V5XSA9IFZJU0lUX0lOX1BST0dSRVNTOwoKICAgICAgICBpZiAoaXNTdHJpbmcodmFsdWUpKSB7CiAgICAgICAgICBwbGFuLnB1c2goa2V5LCBbIGZ1bmN0aW9uKCkgeyByZXR1cm4gJGluamVjdG9yLmdldCh2YWx1ZSk7IH1dLCBOT19ERVBFTkRFTkNJRVMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgcGFyYW1zID0gJGluamVjdG9yLmFubm90YXRlKHZhbHVlKTsKICAgICAgICAgIGZvckVhY2gocGFyYW1zLCBmdW5jdGlvbiAocGFyYW0pIHsKICAgICAgICAgICAgaWYgKHBhcmFtICE9PSBrZXkgJiYgaW52b2NhYmxlcy5oYXNPd25Qcm9wZXJ0eShwYXJhbSkpIHZpc2l0KGludm9jYWJsZXNbcGFyYW1dLCBwYXJhbSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHBsYW4ucHVzaChrZXksIHZhbHVlLCBwYXJhbXMpOwogICAgICAgIH0KCiAgICAgICAgY3ljbGUucG9wKCk7CiAgICAgICAgdmlzaXRlZFtrZXldID0gVklTSVRfRE9ORTsKICAgICAgfQogICAgICBmb3JFYWNoKGludm9jYWJsZXMsIHZpc2l0KTsKICAgICAgaW52b2NhYmxlcyA9IGN5Y2xlID0gdmlzaXRlZCA9IG51bGw7IC8vIHBsYW4gaXMgYWxsIHRoYXQncyByZXF1aXJlZAoKICAgICAgZnVuY3Rpb24gaXNSZXNvbHZlKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHZhbHVlKSAmJiB2YWx1ZS50aGVuICYmIHZhbHVlLiQkcHJvbWlzZXM7CiAgICAgIH0KCiAgICAgIHJldHVybiBmdW5jdGlvbiAobG9jYWxzLCBwYXJlbnQsIHNlbGYpIHsKICAgICAgICBpZiAoaXNSZXNvbHZlKGxvY2FscykgJiYgc2VsZiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBzZWxmID0gcGFyZW50OyBwYXJlbnQgPSBsb2NhbHM7IGxvY2FscyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICghbG9jYWxzKSBsb2NhbHMgPSBOT19MT0NBTFM7CiAgICAgICAgZWxzZSBpZiAoIWlzT2JqZWN0KGxvY2FscykpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiJ2xvY2FscycgbXVzdCBiZSBhbiBvYmplY3QiKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFwYXJlbnQpIHBhcmVudCA9IE5PX1BBUkVOVDsKICAgICAgICBlbHNlIGlmICghaXNSZXNvbHZlKHBhcmVudCkpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiJ3BhcmVudCcgbXVzdCBiZSBhIHByb21pc2UgcmV0dXJuZWQgYnkgJHJlc29sdmUucmVzb2x2ZSgpIik7CiAgICAgICAgfQoKICAgICAgICAvLyBUbyBjb21wbGV0ZSB0aGUgb3ZlcmFsbCByZXNvbHV0aW9uLCB3ZSBoYXZlIHRvIHdhaXQgZm9yIHRoZSBwYXJlbnQKICAgICAgICAvLyBwcm9taXNlIGFuZCBmb3IgdGhlIHByb21pc2UgZm9yIGVhY2ggaW52b2thYmxlIGluIG91ciBwbGFuLgogICAgICAgIHZhciByZXNvbHV0aW9uID0gJHEuZGVmZXIoKSwKICAgICAgICAgIHJlc3VsdCA9IHJlc29sdXRpb24ucHJvbWlzZSwKICAgICAgICAgIHByb21pc2VzID0gcmVzdWx0LiQkcHJvbWlzZXMgPSB7fSwKICAgICAgICAgIHZhbHVlcyA9IGV4dGVuZCh7fSwgbG9jYWxzKSwKICAgICAgICAgIHdhaXQgPSAxICsgcGxhbi5sZW5ndGgvMywKICAgICAgICAgIG1lcmdlZCA9IGZhbHNlOwoKICAgICAgICBmdW5jdGlvbiBkb25lKCkgewogICAgICAgICAgLy8gTWVyZ2UgcGFyZW50IHZhbHVlcyB3ZSBoYXZlbid0IGdvdCB5ZXQgYW5kIHB1Ymxpc2ggb3VyIG93biAkJHZhbHVlcwogICAgICAgICAgaWYgKCEtLXdhaXQpIHsKICAgICAgICAgICAgaWYgKCFtZXJnZWQpIG1lcmdlKHZhbHVlcywgcGFyZW50LiQkdmFsdWVzKTsKICAgICAgICAgICAgcmVzdWx0LiQkdmFsdWVzID0gdmFsdWVzOwogICAgICAgICAgICByZXN1bHQuJCRwcm9taXNlcyA9IHRydWU7IC8vIGtlZXAgZm9yIGlzUmVzb2x2ZSgpCiAgICAgICAgICAgIHJlc29sdXRpb24ucmVzb2x2ZSh2YWx1ZXMpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZmFpbChyZWFzb24pIHsKICAgICAgICAgIHJlc3VsdC4kJGZhaWx1cmUgPSByZWFzb247CiAgICAgICAgICByZXNvbHV0aW9uLnJlamVjdChyZWFzb24pOwogICAgICAgIH0KCiAgICAgICAgLy8gU2hvcnQtY2lyY3VpdCBpZiBwYXJlbnQgaGFzIGFscmVhZHkgZmFpbGVkCiAgICAgICAgaWYgKGlzRGVmaW5lZChwYXJlbnQuJCRmYWlsdXJlKSkgewogICAgICAgICAgZmFpbChwYXJlbnQuJCRmYWlsdXJlKTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQoKICAgICAgICAvLyBNZXJnZSBwYXJlbnQgdmFsdWVzIGlmIHRoZSBwYXJlbnQgaGFzIGFscmVhZHkgcmVzb2x2ZWQsIG9yIG1lcmdlCiAgICAgICAgLy8gcGFyZW50IHByb21pc2VzIGFuZCB3YWl0IGlmIHRoZSBwYXJlbnQgcmVzb2x2ZSBpcyBzdGlsbCBpbiBwcm9ncmVzcy4KICAgICAgICBpZiAocGFyZW50LiQkdmFsdWVzKSB7CiAgICAgICAgICBtZXJnZWQgPSBtZXJnZSh2YWx1ZXMsIHBhcmVudC4kJHZhbHVlcyk7CiAgICAgICAgICBkb25lKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4dGVuZChwcm9taXNlcywgcGFyZW50LiQkcHJvbWlzZXMpOwogICAgICAgICAgcGFyZW50LnRoZW4oZG9uZSwgZmFpbCk7CiAgICAgICAgfQoKICAgICAgICAvLyBQcm9jZXNzIGVhY2ggaW52b2NhYmxlIGluIHRoZSBwbGFuLCBidXQgaWdub3JlIGFueSB3aGVyZSBhIGxvY2FsIG9mIHRoZSBzYW1lIG5hbWUgZXhpc3RzLgogICAgICAgIGZvciAodmFyIGk9MCwgaWk9cGxhbi5sZW5ndGg7IGk8aWk7IGkrPTMpIHsKICAgICAgICAgIGlmIChsb2NhbHMuaGFzT3duUHJvcGVydHkocGxhbltpXSkpIGRvbmUoKTsKICAgICAgICAgIGVsc2UgaW52b2tlKHBsYW5baV0sIHBsYW5baSsxXSwgcGxhbltpKzJdKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGludm9rZShrZXksIGludm9jYWJsZSwgcGFyYW1zKSB7CiAgICAgICAgICAvLyBDcmVhdGUgYSBkZWZlcnJlZCBmb3IgdGhpcyBpbnZvY2F0aW9uLiBGYWlsdXJlcyB3aWxsIHByb3BhZ2F0ZSB0byB0aGUgcmVzb2x1dGlvbiBhcyB3ZWxsLgogICAgICAgICAgdmFyIGludm9jYXRpb24gPSAkcS5kZWZlcigpLCB3YWl0UGFyYW1zID0gMDsKICAgICAgICAgIGZ1bmN0aW9uIG9uZmFpbHVyZShyZWFzb24pIHsKICAgICAgICAgICAgaW52b2NhdGlvbi5yZWplY3QocmVhc29uKTsKICAgICAgICAgICAgZmFpbChyZWFzb24pOwogICAgICAgICAgfQogICAgICAgICAgLy8gV2FpdCBmb3IgYW55IHBhcmFtZXRlciB0aGF0IHdlIGhhdmUgYSBwcm9taXNlIGZvciAoZWl0aGVyIGZyb20gcGFyZW50IG9yIGZyb20gdGhpcwogICAgICAgICAgLy8gcmVzb2x2ZTsgaW4gdGhhdCBjYXNlIHN0dWR5KCkgd2lsbCBoYXZlIG1hZGUgc3VyZSBpdCdzIG9yZGVyZWQgYmVmb3JlIHVzIGluIHRoZSBwbGFuKS4KICAgICAgICAgIGZvckVhY2gocGFyYW1zLCBmdW5jdGlvbiAoZGVwKSB7CiAgICAgICAgICAgIGlmIChwcm9taXNlcy5oYXNPd25Qcm9wZXJ0eShkZXApICYmICFsb2NhbHMuaGFzT3duUHJvcGVydHkoZGVwKSkgewogICAgICAgICAgICAgIHdhaXRQYXJhbXMrKzsKICAgICAgICAgICAgICBwcm9taXNlc1tkZXBdLnRoZW4oZnVuY3Rpb24gKHJlc3VsdCkgewogICAgICAgICAgICAgICAgdmFsdWVzW2RlcF0gPSByZXN1bHQ7CiAgICAgICAgICAgICAgICBpZiAoISgtLXdhaXRQYXJhbXMpKSBwcm9jZWVkKCk7CiAgICAgICAgICAgICAgfSwgb25mYWlsdXJlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoIXdhaXRQYXJhbXMpIHByb2NlZWQoKTsKICAgICAgICAgIGZ1bmN0aW9uIHByb2NlZWQoKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQocmVzdWx0LiQkZmFpbHVyZSkpIHJldHVybjsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpbnZvY2F0aW9uLnJlc29sdmUoJGluamVjdG9yLmludm9rZShpbnZvY2FibGUsIHNlbGYsIHZhbHVlcykpOwogICAgICAgICAgICAgIGludm9jYXRpb24ucHJvbWlzZS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgICAgICAgIHZhbHVlc1trZXldID0gcmVzdWx0OwogICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICAgIH0sIG9uZmFpbHVyZSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBvbmZhaWx1cmUoZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIC8vIFB1Ymxpc2ggcHJvbWlzZSBzeW5jaHJvbm91c2x5OyBpbnZvY2F0aW9ucyBmdXJ0aGVyIGRvd24gaW4gdGhlIHBsYW4gbWF5IGRlcGVuZCBvbiBpdC4KICAgICAgICAgIHByb21pc2VzW2tleV0gPSBpbnZvY2F0aW9uLnByb21pc2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHJlc29sdmUjcmVzb2x2ZQogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci51dGlsLiRyZXNvbHZlCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZXNvbHZlcyBhIHNldCBvZiBpbnZvY2FibGVzLiBBbiBpbnZvY2FibGUgaXMgYSBmdW5jdGlvbiB0byBiZSBpbnZva2VkIHZpYQogICAgICogYCRpbmplY3Rvci5pbnZva2UoKWAsIGFuZCBjYW4gaGF2ZSBhbiBhcmJpdHJhcnkgbnVtYmVyIG9mIGRlcGVuZGVuY2llcy4KICAgICAqIEFuIGludm9jYWJsZSBjYW4gZWl0aGVyIHJldHVybiBhIHZhbHVlIGRpcmVjdGx5LAogICAgICogb3IgYSBgJHFgIHByb21pc2UuIElmIGEgcHJvbWlzZSBpcyByZXR1cm5lZCBpdCB3aWxsIGJlIHJlc29sdmVkIGFuZCB0aGUKICAgICAqIHJlc3VsdGluZyB2YWx1ZSB3aWxsIGJlIHVzZWQgaW5zdGVhZC4gRGVwZW5kZW5jaWVzIG9mIGludm9jYWJsZXMgYXJlIHJlc29sdmVkCiAgICAgKiAoaW4gdGhpcyBvcmRlciBvZiBwcmVjZWRlbmNlKQogICAgICoKICAgICAqIC0gZnJvbSB0aGUgc3BlY2lmaWVkIGBsb2NhbHNgCiAgICAgKiAtIGZyb20gYW5vdGhlciBpbnZvY2FibGUgdGhhdCBpcyBwYXJ0IG9mIHRoaXMgYCRyZXNvbHZlYCBjYWxsCiAgICAgKiAtIGZyb20gYW4gaW52b2NhYmxlIHRoYXQgaXMgaW5oZXJpdGVkIGZyb20gYSBgcGFyZW50YCBjYWxsIHRvIGAkcmVzb2x2ZWAKICAgICAqICAgKG9yIHJlY3Vyc2l2ZWx5CiAgICAgKiAtIGZyb20gYW55IGFuY2VzdG9yIGAkcmVzb2x2ZWAgb2YgdGhhdCBwYXJlbnQpLgogICAgICoKICAgICAqIFRoZSByZXR1cm4gdmFsdWUgb2YgYCRyZXNvbHZlYCBpcyBhIHByb21pc2UgZm9yIGFuIG9iamVjdCB0aGF0IGNvbnRhaW5zCiAgICAgKiAoaW4gdGhpcyBvcmRlciBvZiBwcmVjZWRlbmNlKQogICAgICoKICAgICAqIC0gYW55IGBsb2NhbHNgIChpZiBzcGVjaWZpZWQpCiAgICAgKiAtIHRoZSByZXNvbHZlZCByZXR1cm4gdmFsdWVzIG9mIGFsbCBpbmplY3RhYmxlcwogICAgICogLSBhbnkgdmFsdWVzIGluaGVyaXRlZCBmcm9tIGEgYHBhcmVudGAgY2FsbCB0byBgJHJlc29sdmVgIChpZiBzcGVjaWZpZWQpCiAgICAgKgogICAgICogVGhlIHByb21pc2Ugd2lsbCByZXNvbHZlIGFmdGVyIHRoZSBgcGFyZW50YCBwcm9taXNlIChpZiBhbnkpIGFuZCBhbGwgcHJvbWlzZXMKICAgICAqIHJldHVybmVkIGJ5IGluamVjdGFibGVzIGhhdmUgYmVlbiByZXNvbHZlZC4gSWYgYW55IGludm9jYWJsZQogICAgICogKG9yIGAkaW5qZWN0b3IuaW52b2tlYCkgdGhyb3dzIGFuIGV4Y2VwdGlvbiwgb3IgaWYgYSBwcm9taXNlIHJldHVybmVkIGJ5IGFuCiAgICAgKiBpbnZvY2FibGUgaXMgcmVqZWN0ZWQsIHRoZSBgJHJlc29sdmVgIHByb21pc2UgaXMgaW1tZWRpYXRlbHkgcmVqZWN0ZWQgd2l0aCB0aGUKICAgICAqIHNhbWUgZXJyb3IuIEEgcmVqZWN0aW9uIG9mIGEgYHBhcmVudGAgcHJvbWlzZSAoaWYgc3BlY2lmaWVkKSB3aWxsIGxpa2V3aXNlIGJlCiAgICAgKiBwcm9wYWdhdGVkIGltbWVkaWF0ZWx5LiBPbmNlIHRoZSBgJHJlc29sdmVgIHByb21pc2UgaGFzIGJlZW4gcmVqZWN0ZWQsIG5vCiAgICAgKiBmdXJ0aGVyIGludm9jYWJsZXMgd2lsbCBiZSBjYWxsZWQuCiAgICAgKgogICAgICogQ3ljbGljIGRlcGVuZGVuY2llcyBiZXR3ZWVuIGludm9jYWJsZXMgYXJlIG5vdCBwZXJtaXR0ZWQgYW5kIHdpbGwgY2F1ZXMgYCRyZXNvbHZlYAogICAgICogdG8gdGhyb3cgYW4gZXJyb3IuIEFzIGEgc3BlY2lhbCBjYXNlLCBhbiBpbmplY3RhYmxlIGNhbiBkZXBlbmQgb24gYSBwYXJhbWV0ZXIKICAgICAqIHdpdGggdGhlIHNhbWUgbmFtZSBhcyB0aGUgaW5qZWN0YWJsZSwgd2hpY2ggd2lsbCBiZSBmdWxmaWxsZWQgZnJvbSB0aGUgYHBhcmVudGAKICAgICAqIGluamVjdGFibGUgb2YgdGhlIHNhbWUgbmFtZS4gVGhpcyBhbGxvd3MgaW5oZXJpdGVkIHZhbHVlcyB0byBiZSBkZWNvcmF0ZWQuCiAgICAgKiBOb3RlIHRoYXQgaW4gdGhpcyBjYXNlIGFueSBvdGhlciBpbmplY3RhYmxlIGluIHRoZSBzYW1lIGAkcmVzb2x2ZWAgd2l0aCB0aGUgc2FtZQogICAgICogZGVwZW5kZW5jeSB3b3VsZCBzZWUgdGhlIGRlY29yYXRlZCB2YWx1ZSwgbm90IHRoZSBpbmhlcml0ZWQgdmFsdWUuCiAgICAgKgogICAgICogTm90ZSB0aGF0IG1pc3NpbmcgZGVwZW5kZW5jaWVzIC0tIHVubGlrZSBjeWNsaWMgZGVwZW5kZW5jaWVzIC0tIHdpbGwgY2F1c2UgYW4KICAgICAqIChhc3luY2hyb25vdXMpIHJlamVjdGlvbiBvZiB0aGUgYCRyZXNvbHZlYCBwcm9taXNlIHJhdGhlciB0aGFuIGEgKHN5bmNocm9ub3VzKQogICAgICogZXhjZXB0aW9uLgogICAgICoKICAgICAqIEludm9jYWJsZXMgYXJlIGludm9rZWQgZWFnZXJseSBhcyBzb29uIGFzIGFsbCBkZXBlbmRlbmNpZXMgYXJlIGF2YWlsYWJsZS4KICAgICAqIFRoaXMgaXMgdHJ1ZSBldmVuIGZvciBkZXBlbmRlbmNpZXMgaW5oZXJpdGVkIGZyb20gYSBgcGFyZW50YCBjYWxsIHRvIGAkcmVzb2x2ZWAuCiAgICAgKgogICAgICogQXMgYSBzcGVjaWFsIGNhc2UsIGFuIGludm9jYWJsZSBjYW4gYmUgYSBzdHJpbmcsIGluIHdoaWNoIGNhc2UgaXQgaXMgdGFrZW4gdG8KICAgICAqIGJlIGEgc2VydmljZSBuYW1lIHRvIGJlIHBhc3NlZCB0byBgJGluamVjdG9yLmdldCgpYC4gVGhpcyBpcyBzdXBwb3J0ZWQgcHJpbWFyaWx5CiAgICAgKiBmb3IgYmFja3dhcmRzLWNvbXBhdGliaWxpdHkgd2l0aCB0aGUgYHJlc29sdmVgIHByb3BlcnR5IG9mIGAkcm91dGVQcm92aWRlcmAKICAgICAqIHJvdXRlcy4KICAgICAqCiAgICAgKiBAcGFyYW0ge29iamVjdH0gaW52b2NhYmxlcyBmdW5jdGlvbnMgdG8gaW52b2tlIG9yCiAgICAgKiBgJGluamVjdG9yYCBzZXJ2aWNlcyB0byBmZXRjaC4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBsb2NhbHMgIHZhbHVlcyB0byBtYWtlIGF2YWlsYWJsZSB0byB0aGUgaW5qZWN0YWJsZXMKICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJlbnQgIGEgcHJvbWlzZSByZXR1cm5lZCBieSBhbm90aGVyIGNhbGwgdG8gYCRyZXNvbHZlYC4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzZWxmICB0aGUgYHRoaXNgIGZvciB0aGUgaW52b2tlZCBtZXRob2RzCiAgICAgKiBAcmV0dXJuIHtvYmplY3R9IFByb21pc2UgZm9yIGFuIG9iamVjdCB0aGF0IGNvbnRhaW5zIHRoZSByZXNvbHZlZCByZXR1cm4gdmFsdWUKICAgICAqIG9mIGFsbCBpbnZvY2FibGVzLCBhcyB3ZWxsIGFzIGFueSBpbmhlcml0ZWQgYW5kIGxvY2FsIHZhbHVlcy4KICAgICAqLwogICAgdGhpcy5yZXNvbHZlID0gZnVuY3Rpb24gKGludm9jYWJsZXMsIGxvY2FscywgcGFyZW50LCBzZWxmKSB7CiAgICAgIHJldHVybiB0aGlzLnN0dWR5KGludm9jYWJsZXMpKGxvY2FscywgcGFyZW50LCBzZWxmKTsKICAgIH07CiAgfQoKICBhbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnV0aWwnKS5zZXJ2aWNlKCckcmVzb2x2ZScsICRSZXNvbHZlKTsKCgogIC8qKgogICAqIEBuZ2RvYyBvYmplY3QKICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5CiAgICoKICAgKiBAcmVxdWlyZXMgJGh0dHAKICAgKiBAcmVxdWlyZXMgJHRlbXBsYXRlQ2FjaGUKICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBTZXJ2aWNlLiBNYW5hZ2VzIGxvYWRpbmcgb2YgdGVtcGxhdGVzLgogICAqLwogICRUZW1wbGF0ZUZhY3RvcnkuJGluamVjdCA9IFsnJGh0dHAnLCAnJHRlbXBsYXRlQ2FjaGUnLCAnJGluamVjdG9yJ107CiAgZnVuY3Rpb24gJFRlbXBsYXRlRmFjdG9yeSggICRodHRwLCAgICR0ZW1wbGF0ZUNhY2hlLCAgICRpbmplY3RvcikgewoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5I2Zyb21Db25maWcKICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgdGVtcGxhdGUgZnJvbSBhIGNvbmZpZ3VyYXRpb24gb2JqZWN0LgogICAgICoKICAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb25maWcgQ29uZmlndXJhdGlvbiBvYmplY3QgZm9yIHdoaWNoIHRvIGxvYWQgYSB0ZW1wbGF0ZS4KICAgICAqIFRoZSBmb2xsb3dpbmcgcHJvcGVydGllcyBhcmUgc2VhcmNoIGluIHRoZSBzcGVjaWZpZWQgb3JkZXIsIGFuZCB0aGUgZmlyc3Qgb25lCiAgICAgKiB0aGF0IGlzIGRlZmluZWQgaXMgdXNlZCB0byBjcmVhdGUgdGhlIHRlbXBsYXRlOgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gY29uZmlnLnRlbXBsYXRlIGh0bWwgc3RyaW5nIHRlbXBsYXRlIG9yIGZ1bmN0aW9uIHRvCiAgICAgKiBsb2FkIHZpYSB7QGxpbmsgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeSNmcm9tU3RyaW5nIGZyb21TdHJpbmd9LgogICAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSBjb25maWcudGVtcGxhdGVVcmwgdXJsIHRvIGxvYWQgb3IgYSBmdW5jdGlvbiByZXR1cm5pbmcKICAgICAqIHRoZSB1cmwgdG8gbG9hZCB2aWEge0BsaW5rIHVpLnJvdXRlci51dGlsLiR0ZW1wbGF0ZUZhY3RvcnkjZnJvbVVybCBmcm9tVXJsfS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbmZpZy50ZW1wbGF0ZVByb3ZpZGVyIGZ1bmN0aW9uIHRvIGludm9rZSB2aWEKICAgICAqIHtAbGluayB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5I2Zyb21Qcm92aWRlciBmcm9tUHJvdmlkZXJ9LgogICAgICogQHBhcmFtIHtvYmplY3R9IHBhcmFtcyAgUGFyYW1ldGVycyB0byBwYXNzIHRvIHRoZSB0ZW1wbGF0ZSBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBsb2NhbHMgTG9jYWxzIHRvIHBhc3MgdG8gYGludm9rZWAgaWYgdGhlIHRlbXBsYXRlIGlzIGxvYWRlZAogICAgICogdmlhIGEgYHRlbXBsYXRlUHJvdmlkZXJgLiBEZWZhdWx0cyB0byBgeyBwYXJhbXM6IHBhcmFtcyB9YC4KICAgICAqCiAgICAgKiBAcmV0dXJuIHtzdHJpbmd8b2JqZWN0fSAgVGhlIHRlbXBsYXRlIGh0bWwgYXMgYSBzdHJpbmcsIG9yIGEgcHJvbWlzZSBmb3IKICAgICAqIHRoYXQgc3RyaW5nLG9yIGBudWxsYCBpZiBubyB0ZW1wbGF0ZSBpcyBjb25maWd1cmVkLgogICAgICovCiAgICB0aGlzLmZyb21Db25maWcgPSBmdW5jdGlvbiAoY29uZmlnLCBwYXJhbXMsIGxvY2FscykgewogICAgICByZXR1cm4gKAogICAgICAgIGlzRGVmaW5lZChjb25maWcudGVtcGxhdGUpID8gdGhpcy5mcm9tU3RyaW5nKGNvbmZpZy50ZW1wbGF0ZSwgcGFyYW1zKSA6CiAgICAgICAgICBpc0RlZmluZWQoY29uZmlnLnRlbXBsYXRlVXJsKSA/IHRoaXMuZnJvbVVybChjb25maWcudGVtcGxhdGVVcmwsIHBhcmFtcykgOgogICAgICAgICAgICBpc0RlZmluZWQoY29uZmlnLnRlbXBsYXRlUHJvdmlkZXIpID8gdGhpcy5mcm9tUHJvdmlkZXIoY29uZmlnLnRlbXBsYXRlUHJvdmlkZXIsIHBhcmFtcywgbG9jYWxzKSA6CiAgICAgICAgICAgICAgbnVsbAogICAgICAgICk7CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5I2Zyb21TdHJpbmcKICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgdGVtcGxhdGUgZnJvbSBhIHN0cmluZyBvciBhIGZ1bmN0aW9uIHJldHVybmluZyBhIHN0cmluZy4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3R9IHRlbXBsYXRlIGh0bWwgdGVtcGxhdGUgYXMgYSBzdHJpbmcgb3IgZnVuY3Rpb24gdGhhdAogICAgICogcmV0dXJucyBhbiBodG1sIHRlbXBsYXRlIGFzIGEgc3RyaW5nLgogICAgICogQHBhcmFtIHtvYmplY3R9IHBhcmFtcyBQYXJhbWV0ZXJzIHRvIHBhc3MgdG8gdGhlIHRlbXBsYXRlIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEByZXR1cm4ge3N0cmluZ3xvYmplY3R9IFRoZSB0ZW1wbGF0ZSBodG1sIGFzIGEgc3RyaW5nLCBvciBhIHByb21pc2UgZm9yIHRoYXQKICAgICAqIHN0cmluZy4KICAgICAqLwogICAgdGhpcy5mcm9tU3RyaW5nID0gZnVuY3Rpb24gKHRlbXBsYXRlLCBwYXJhbXMpIHsKICAgICAgcmV0dXJuIGlzRnVuY3Rpb24odGVtcGxhdGUpID8gdGVtcGxhdGUocGFyYW1zKSA6IHRlbXBsYXRlOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeSNmcm9tVXJsCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnV0aWwuJHRlbXBsYXRlRmFjdG9yeQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogTG9hZHMgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBhIFVSTCB2aWEgYCRodHRwYCBhbmQgYCR0ZW1wbGF0ZUNhY2hlYC4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xGdW5jdGlvbn0gdXJsIHVybCBvZiB0aGUgdGVtcGxhdGUgdG8gbG9hZCwgb3IgYSBmdW5jdGlvbgogICAgICogdGhhdCByZXR1cm5zIGEgdXJsLgogICAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcyBQYXJhbWV0ZXJzIHRvIHBhc3MgdG8gdGhlIHVybCBmdW5jdGlvbi4KICAgICAqIEByZXR1cm4ge3N0cmluZ3xQcm9taXNlLjxzdHJpbmc+fSBUaGUgdGVtcGxhdGUgaHRtbCBhcyBhIHN0cmluZywgb3IgYSBwcm9taXNlCiAgICAgKiBmb3IgdGhhdCBzdHJpbmcuCiAgICAgKi8KICAgIHRoaXMuZnJvbVVybCA9IGZ1bmN0aW9uICh1cmwsIHBhcmFtcykgewogICAgICBpZiAoaXNGdW5jdGlvbih1cmwpKSB1cmwgPSB1cmwocGFyYW1zKTsKICAgICAgaWYgKHVybCA9PSBudWxsKSByZXR1cm4gbnVsbDsKICAgICAgZWxzZSByZXR1cm4gJGh0dHAKICAgICAgICAuZ2V0KHVybCwgeyBjYWNoZTogJHRlbXBsYXRlQ2FjaGUgfSkKICAgICAgICAudGhlbihmdW5jdGlvbihyZXNwb25zZSkgeyByZXR1cm4gcmVzcG9uc2UuZGF0YTsgfSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5I2Zyb21VcmwKICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5CiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDcmVhdGVzIGEgdGVtcGxhdGUgYnkgaW52b2tpbmcgYW4gaW5qZWN0YWJsZSBwcm92aWRlciBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBwcm92aWRlciBGdW5jdGlvbiB0byBpbnZva2UgdmlhIGAkaW5qZWN0b3IuaW52b2tlYAogICAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcyBQYXJhbWV0ZXJzIGZvciB0aGUgdGVtcGxhdGUuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gbG9jYWxzIExvY2FscyB0byBwYXNzIHRvIGBpbnZva2VgLiBEZWZhdWx0cyB0bwogICAgICogYHsgcGFyYW1zOiBwYXJhbXMgfWAuCiAgICAgKiBAcmV0dXJuIHtzdHJpbmd8UHJvbWlzZS48c3RyaW5nPn0gVGhlIHRlbXBsYXRlIGh0bWwgYXMgYSBzdHJpbmcsIG9yIGEgcHJvbWlzZQogICAgICogZm9yIHRoYXQgc3RyaW5nLgogICAgICovCiAgICB0aGlzLmZyb21Qcm92aWRlciA9IGZ1bmN0aW9uIChwcm92aWRlciwgcGFyYW1zLCBsb2NhbHMpIHsKICAgICAgcmV0dXJuICRpbmplY3Rvci5pbnZva2UocHJvdmlkZXIsIG51bGwsIGxvY2FscyB8fCB7IHBhcmFtczogcGFyYW1zIH0pOwogICAgfTsKICB9CgogIGFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIudXRpbCcpLnNlcnZpY2UoJyR0ZW1wbGF0ZUZhY3RvcnknLCAkVGVtcGxhdGVGYWN0b3J5KTsKCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogTWF0Y2hlcyBVUkxzIGFnYWluc3QgcGF0dGVybnMgYW5kIGV4dHJhY3RzIG5hbWVkIHBhcmFtZXRlcnMgZnJvbSB0aGUgcGF0aCBvciB0aGUgc2VhcmNoCiAgICogcGFydCBvZiB0aGUgVVJMLiBBIFVSTCBwYXR0ZXJuIGNvbnNpc3RzIG9mIGEgcGF0aCBwYXR0ZXJuLCBvcHRpb25hbGx5IGZvbGxvd2VkIGJ5ICc/JyBhbmQgYSBsaXN0CiAgICogb2Ygc2VhcmNoIHBhcmFtZXRlcnMuIE11bHRpcGxlIHNlYXJjaCBwYXJhbWV0ZXIgbmFtZXMgYXJlIHNlcGFyYXRlZCBieSAnJicuIFNlYXJjaCBwYXJhbWV0ZXJzCiAgICogZG8gbm90IGluZmx1ZW5jZSB3aGV0aGVyIG9yIG5vdCBhIFVSTCBpcyBtYXRjaGVkLCBidXQgdGhlaXIgdmFsdWVzIGFyZSBwYXNzZWQgdGhyb3VnaCBpbnRvCiAgICogdGhlIG1hdGNoZWQgcGFyYW1ldGVycyByZXR1cm5lZCBieSB7QGxpbmsgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyI21ldGhvZHNfZXhlYyBleGVjfS4KICAgKgogICAqIFBhdGggcGFyYW1ldGVyIHBsYWNlaG9sZGVycyBjYW4gYmUgc3BlY2lmaWVkIHVzaW5nIHNpbXBsZSBjb2xvbi9jYXRjaC1hbGwgc3ludGF4IG9yIGN1cmx5IGJyYWNlCiAgICogc3ludGF4LCB3aGljaCBvcHRpb25hbGx5IGFsbG93cyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiBmb3IgdGhlIHBhcmFtZXRlciB0byBiZSBzcGVjaWZpZWQ6CiAgICoKICAgKiAqIGAnOidgIG5hbWUgLSBjb2xvbiBwbGFjZWhvbGRlcgogICAqICogYCcqJ2AgbmFtZSAtIGNhdGNoLWFsbCBwbGFjZWhvbGRlcgogICAqICogYCd7JyBuYW1lICd9J2AgLSBjdXJseSBwbGFjZWhvbGRlcgogICAqICogYCd7JyBuYW1lICc6JyByZWdleHAgJ30nYCAtIGN1cmx5IHBsYWNlaG9sZGVyIHdpdGggcmVnZXhwLiBTaG91bGQgdGhlIHJlZ2V4cCBpdHNlbGYgY29udGFpbgogICAqICAgY3VybHkgYnJhY2VzLCB0aGV5IG11c3QgYmUgaW4gbWF0Y2hlZCBwYWlycyBvciBlc2NhcGVkIHdpdGggYSBiYWNrc2xhc2guCiAgICoKICAgKiBQYXJhbWV0ZXIgbmFtZXMgbWF5IGNvbnRhaW4gb25seSB3b3JkIGNoYXJhY3RlcnMgKGxhdGluIGxldHRlcnMsIGRpZ2l0cywgYW5kIHVuZGVyc2NvcmUpIGFuZAogICAqIG11c3QgYmUgdW5pcXVlIHdpdGhpbiB0aGUgcGF0dGVybiAoYWNyb3NzIGJvdGggcGF0aCBhbmQgc2VhcmNoIHBhcmFtZXRlcnMpLiBGb3IgY29sb24KICAgKiBwbGFjZWhvbGRlcnMgb3IgY3VybHkgcGxhY2Vob2xkZXJzIHdpdGhvdXQgYW4gZXhwbGljaXQgcmVnZXhwLCBhIHBhdGggcGFyYW1ldGVyIG1hdGNoZXMgYW55CiAgICogbnVtYmVyIG9mIGNoYXJhY3RlcnMgb3RoZXIgdGhhbiAnLycuIEZvciBjYXRjaC1hbGwgcGxhY2Vob2xkZXJzIHRoZSBwYXRoIHBhcmFtZXRlciBtYXRjaGVzCiAgICogYW55IG51bWJlciBvZiBjaGFyYWN0ZXJzLgogICAqCiAgICogRXhhbXBsZXM6CiAgICoKICAgKiAqIGAnL2hlbGxvLydgIC0gTWF0Y2hlcyBvbmx5IGlmIHRoZSBwYXRoIGlzIGV4YWN0bHkgJy9oZWxsby8nLiBUaGVyZSBpcyBubyBzcGVjaWFsIHRyZWF0bWVudCBmb3IKICAgKiAgIHRyYWlsaW5nIHNsYXNoZXMsIGFuZCBwYXR0ZXJucyBoYXZlIHRvIG1hdGNoIHRoZSBlbnRpcmUgcGF0aCwgbm90IGp1c3QgYSBwcmVmaXguCiAgICogKiBgJy91c2VyLzppZCdgIC0gTWF0Y2hlcyAnL3VzZXIvYm9iJyBvciAnL3VzZXIvMTIzNCEhIScgb3IgZXZlbiAnL3VzZXIvJyBidXQgbm90ICcvdXNlcicgb3IKICAgKiAgICcvdXNlci9ib2IvZGV0YWlscycuIFRoZSBzZWNvbmQgcGF0aCBzZWdtZW50IHdpbGwgYmUgY2FwdHVyZWQgYXMgdGhlIHBhcmFtZXRlciAnaWQnLgogICAqICogYCcvdXNlci97aWR9J2AgLSBTYW1lIGFzIHRoZSBwcmV2aW91cyBleGFtcGxlLCBidXQgdXNpbmcgY3VybHkgYnJhY2Ugc3ludGF4LgogICAqICogYCcvdXNlci97aWQ6W14vXSp9J2AgLSBTYW1lIGFzIHRoZSBwcmV2aW91cyBleGFtcGxlLgogICAqICogYCcvdXNlci97aWQ6WzAtOWEtZkEtRl17MSw4fX0nYCAtIFNpbWlsYXIgdG8gdGhlIHByZXZpb3VzIGV4YW1wbGUsIGJ1dCBvbmx5IG1hdGNoZXMgaWYgdGhlIGlkCiAgICogICBwYXJhbWV0ZXIgY29uc2lzdHMgb2YgMSB0byA4IGhleCBkaWdpdHMuCiAgICogKiBgJy9maWxlcy97cGF0aDouKn0nYCAtIE1hdGNoZXMgYW55IFVSTCBzdGFydGluZyB3aXRoICcvZmlsZXMvJyBhbmQgY2FwdHVyZXMgdGhlIHJlc3Qgb2YgdGhlCiAgICogICBwYXRoIGludG8gdGhlIHBhcmFtZXRlciAncGF0aCcuCiAgICogKiBgJy9maWxlcy8qcGF0aCdgIC0gZGl0dG8uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0dGVybiAgdGhlIHBhdHRlcm4gdG8gY29tcGlsZSBpbnRvIGEgbWF0Y2hlci4KICAgKgogICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBwcmVmaXggIEEgc3RhdGljIHByZWZpeCBvZiB0aGlzIHBhdHRlcm4uIFRoZSBtYXRjaGVyIGd1YXJhbnRlZXMgdGhhdCBhbnkKICAgKiAgIFVSTCBtYXRjaGluZyB0aGlzIG1hdGNoZXIgKGkuZS4gYW55IHN0cmluZyBmb3Igd2hpY2gge0BsaW5rIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlciNtZXRob2RzX2V4ZWMgZXhlYygpfSByZXR1cm5zCiAgICogICBub24tbnVsbCkgd2lsbCBzdGFydCB3aXRoIHRoaXMgcHJlZml4LgogICAqCiAgICogQHByb3BlcnR5IHtzdHJpbmd9IHNvdXJjZSAgVGhlIHBhdHRlcm4gdGhhdCB3YXMgcGFzc2VkIGludG8gdGhlIGNvbnRydWN0b3IKICAgKgogICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBzb3VyY2VQYXRoICBUaGUgcGF0aCBwb3J0aW9uIG9mIHRoZSBzb3VyY2UgcHJvcGVydHkKICAgKgogICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBzb3VyY2VTZWFyY2ggIFRoZSBzZWFyY2ggcG9ydGlvbiBvZiB0aGUgc291cmNlIHByb3BlcnR5CiAgICoKICAgKiBAcHJvcGVydHkge3N0cmluZ30gcmVnZXggIFRoZSBjb25zdHJ1Y3RlZCByZWdleCB0aGF0IHdpbGwgYmUgdXNlZCB0byBtYXRjaCBhZ2FpbnN0IHRoZSB1cmwgd2hlbgogICAqICAgaXQgaXMgdGltZSB0byBkZXRlcm1pbmUgd2hpY2ggdXJsIHdpbGwgbWF0Y2guCiAgICoKICAgKiBAcmV0dXJucyB7T2JqZWN0fSAgTmV3IFVybE1hdGNoZXIgb2JqZWN0CiAgICovCiAgZnVuY3Rpb24gVXJsTWF0Y2hlcihwYXR0ZXJuKSB7CgogICAgLy8gRmluZCBhbGwgcGxhY2Vob2xkZXJzIGFuZCBjcmVhdGUgYSBjb21waWxlZCBwYXR0ZXJuLCB1c2luZyBlaXRoZXIgY2xhc3NpYyBvciBjdXJseSBzeW50YXg6CiAgICAvLyAgICcqJyBuYW1lCiAgICAvLyAgICc6JyBuYW1lCiAgICAvLyAgICd7JyBuYW1lICd9JwogICAgLy8gICAneycgbmFtZSAnOicgcmVnZXhwICd9JwogICAgLy8gVGhlIHJlZ3VsYXIgZXhwcmVzc2lvbiBpcyBzb21ld2hhdCBjb21wbGljYXRlZCBkdWUgdG8gdGhlIG5lZWQgdG8gYWxsb3cgY3VybHkgYnJhY2VzCiAgICAvLyBpbnNpZGUgdGhlIHJlZ3VsYXIgZXhwcmVzc2lvbi4gVGhlIHBsYWNlaG9sZGVyIHJlZ2V4cCBicmVha3MgZG93biBhcyBmb2xsb3dzOgogICAgLy8gICAgKFs6Kl0pKFx3KykgICAgICAgICAgICAgICBjbGFzc2ljIHBsYWNlaG9sZGVyICgkMSAvICQyKQogICAgLy8gICAgXHsoXHcrKSg/Olw6KCAuLi4gKSk/XH0gICBjdXJseSBicmFjZSBwbGFjZWhvbGRlciAoJDMpIHdpdGggb3B0aW9uYWwgcmVnZXhwIC4uLiAoJDQpCiAgICAvLyAgICAoPzogLi4uIHwgLi4uIHwgLi4uICkrICAgIHRoZSByZWdleHAgY29uc2lzdHMgb2YgYW55IG51bWJlciBvZiBhdG9tcywgYW4gYXRvbSBiZWluZyBlaXRoZXIKICAgIC8vICAgIFtee31cXF0rICAgICAgICAgICAgICAgICAgLSBhbnl0aGluZyBvdGhlciB0aGFuIGN1cmx5IGJyYWNlcyBvciBiYWNrc2xhc2gKICAgIC8vICAgIFxcLiAgICAgICAgICAgICAgICAgICAgICAgLSBhIGJhY2tzbGFzaCBlc2NhcGUKICAgIC8vICAgIFx7KD86W157fVxcXSt8XFwuKSpcfSAgICAgLSBhIG1hdGNoZWQgc2V0IG9mIGN1cmx5IGJyYWNlcyBjb250YWluaW5nIG90aGVyIGF0b21zCiAgICB2YXIgcGxhY2Vob2xkZXIgPSAvKFs6Kl0pKFx3Kyl8XHsoXHcrKSg/Olw6KCg/Oltee31cXF0rfFxcLnxceyg/Oltee31cXF0rfFxcLikqXH0pKykpP1x9L2csCiAgICAgIG5hbWVzID0ge30sIGNvbXBpbGVkID0gJ14nLCBsYXN0ID0gMCwgbSwKICAgICAgc2VnbWVudHMgPSB0aGlzLnNlZ21lbnRzID0gW10sCiAgICAgIHBhcmFtcyA9IHRoaXMucGFyYW1zID0gW107CgogICAgZnVuY3Rpb24gYWRkUGFyYW1ldGVyKGlkKSB7CiAgICAgIGlmICghL15cdysoLStcdyspKiQvLnRlc3QoaWQpKSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcGFyYW1ldGVyIG5hbWUgJyIgKyBpZCArICInIGluIHBhdHRlcm4gJyIgKyBwYXR0ZXJuICsgIiciKTsKICAgICAgaWYgKG5hbWVzW2lkXSkgdGhyb3cgbmV3IEVycm9yKCJEdXBsaWNhdGUgcGFyYW1ldGVyIG5hbWUgJyIgKyBpZCArICInIGluIHBhdHRlcm4gJyIgKyBwYXR0ZXJuICsgIiciKTsKICAgICAgbmFtZXNbaWRdID0gdHJ1ZTsKICAgICAgcGFyYW1zLnB1c2goaWQpOwogICAgfQoKICAgIGZ1bmN0aW9uIHF1b3RlUmVnRXhwKHN0cmluZykgewogICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoL1tcXFxbXF1cXiQqKz8uKCl8e31dL2csICJcXCQmIik7CiAgICB9CgogICAgdGhpcy5zb3VyY2UgPSBwYXR0ZXJuOwoKICAgIC8vIFNwbGl0IGludG8gc3RhdGljIHNlZ21lbnRzIHNlcGFyYXRlZCBieSBwYXRoIHBhcmFtZXRlciBwbGFjZWhvbGRlcnMuCiAgICAvLyBUaGUgbnVtYmVyIG9mIHNlZ21lbnRzIGlzIGFsd2F5cyAxIG1vcmUgdGhhbiB0aGUgbnVtYmVyIG9mIHBhcmFtZXRlcnMuCiAgICB2YXIgaWQsIHJlZ2V4cCwgc2VnbWVudDsKICAgIHdoaWxlICgobSA9IHBsYWNlaG9sZGVyLmV4ZWMocGF0dGVybikpKSB7CiAgICAgIGlkID0gbVsyXSB8fCBtWzNdOyAvLyBJRVs3OF0gcmV0dXJucyAnJyBmb3IgdW5tYXRjaGVkIGdyb3VwcyBpbnN0ZWFkIG9mIG51bGwKICAgICAgcmVnZXhwID0gbVs0XSB8fCAobVsxXSA9PSAnKicgPyAnLionIDogJ1teL10qJyk7CiAgICAgIHNlZ21lbnQgPSBwYXR0ZXJuLnN1YnN0cmluZyhsYXN0LCBtLmluZGV4KTsKICAgICAgaWYgKHNlZ21lbnQuaW5kZXhPZignPycpID49IDApIGJyZWFrOyAvLyB3ZSdyZSBpbnRvIHRoZSBzZWFyY2ggcGFydAogICAgICBjb21waWxlZCArPSBxdW90ZVJlZ0V4cChzZWdtZW50KSArICcoJyArIHJlZ2V4cCArICcpJzsKICAgICAgYWRkUGFyYW1ldGVyKGlkKTsKICAgICAgc2VnbWVudHMucHVzaChzZWdtZW50KTsKICAgICAgbGFzdCA9IHBsYWNlaG9sZGVyLmxhc3RJbmRleDsKICAgIH0KICAgIHNlZ21lbnQgPSBwYXR0ZXJuLnN1YnN0cmluZyhsYXN0KTsKCiAgICAvLyBGaW5kIGFueSBzZWFyY2ggcGFyYW1ldGVyIG5hbWVzIGFuZCByZW1vdmUgdGhlbSBmcm9tIHRoZSBsYXN0IHNlZ21lbnQKICAgIHZhciBpID0gc2VnbWVudC5pbmRleE9mKCc/Jyk7CiAgICBpZiAoaSA+PSAwKSB7CiAgICAgIHZhciBzZWFyY2ggPSB0aGlzLnNvdXJjZVNlYXJjaCA9IHNlZ21lbnQuc3Vic3RyaW5nKGkpOwogICAgICBzZWdtZW50ID0gc2VnbWVudC5zdWJzdHJpbmcoMCwgaSk7CiAgICAgIHRoaXMuc291cmNlUGF0aCA9IHBhdHRlcm4uc3Vic3RyaW5nKDAsIGxhc3QraSk7CgogICAgICAvLyBBbGxvdyBwYXJhbWV0ZXJzIHRvIGJlIHNlcGFyYXRlZCBieSAnPycgYXMgd2VsbCBhcyAnJicgdG8gbWFrZSBjb25jYXQoKSBlYXNpZXIKICAgICAgZm9yRWFjaChzZWFyY2guc3Vic3RyaW5nKDEpLnNwbGl0KC9bJj9dLyksIGFkZFBhcmFtZXRlcik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnNvdXJjZVBhdGggPSBwYXR0ZXJuOwogICAgICB0aGlzLnNvdXJjZVNlYXJjaCA9ICcnOwogICAgfQoKICAgIGNvbXBpbGVkICs9IHF1b3RlUmVnRXhwKHNlZ21lbnQpICsgJyQnOwogICAgc2VnbWVudHMucHVzaChzZWdtZW50KTsKICAgIHRoaXMucmVnZXhwID0gbmV3IFJlZ0V4cChjb21waWxlZCk7CiAgICB0aGlzLnByZWZpeCA9IHNlZ21lbnRzWzBdOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyI2NvbmNhdAogICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJldHVybnMgYSBuZXcgbWF0Y2hlciBmb3IgYSBwYXR0ZXJuIGNvbnN0cnVjdGVkIGJ5IGFwcGVuZGluZyB0aGUgcGF0aCBwYXJ0IGFuZCBhZGRpbmcgdGhlCiAgICogc2VhcmNoIHBhcmFtZXRlcnMgb2YgdGhlIHNwZWNpZmllZCBwYXR0ZXJuIHRvIHRoaXMgcGF0dGVybi4gVGhlIGN1cnJlbnQgcGF0dGVybiBpcyBub3QKICAgKiBtb2RpZmllZC4gVGhpcyBjYW4gYmUgdW5kZXJzdG9vZCBhcyBjcmVhdGluZyBhIHBhdHRlcm4gZm9yIFVSTHMgdGhhdCBhcmUgcmVsYXRpdmUgdG8gKG9yCiAgICogc3VmZml4ZXMgb2YpIHRoZSBjdXJyZW50IHBhdHRlcm4uCiAgICoKICAgKiBAZXhhbXBsZQogICAqIFRoZSBmb2xsb3dpbmcgdHdvIG1hdGNoZXJzIGFyZSBlcXVpdmFsZW50OgogICAqIGBgYAogICAqIG5ldyBVcmxNYXRjaGVyKCcvdXNlci97aWR9P3EnKS5jb25jYXQoJy9kZXRhaWxzP2RhdGUnKTsKICAgKiBuZXcgVXJsTWF0Y2hlcignL3VzZXIve2lkfS9kZXRhaWxzP3EmZGF0ZScpOwogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdHRlcm4gIFRoZSBwYXR0ZXJuIHRvIGFwcGVuZC4KICAgKiBAcmV0dXJucyB7dWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyfSAgQSBtYXRjaGVyIGZvciB0aGUgY29uY2F0ZW5hdGVkIHBhdHRlcm4uCiAgICovCiAgVXJsTWF0Y2hlci5wcm90b3R5cGUuY29uY2F0ID0gZnVuY3Rpb24gKHBhdHRlcm4pIHsKICAgIC8vIEJlY2F1c2Ugb3JkZXIgb2Ygc2VhcmNoIHBhcmFtZXRlcnMgaXMgaXJyZWxldmFudCwgd2UgY2FuIGFkZCBvdXIgb3duIHNlYXJjaAogICAgLy8gcGFyYW1ldGVycyB0byB0aGUgZW5kIG9mIHRoZSBuZXcgcGF0dGVybi4gUGFyc2UgdGhlIG5ldyBwYXR0ZXJuIGJ5IGl0c2VsZgogICAgLy8gYW5kIHRoZW4gam9pbiB0aGUgYml0cyB0b2dldGhlciwgYnV0IGl0J3MgbXVjaCBlYXNpZXIgdG8gZG8gdGhpcyBvbiBhIHN0cmluZyBsZXZlbC4KICAgIHJldHVybiBuZXcgVXJsTWF0Y2hlcih0aGlzLnNvdXJjZVBhdGggKyBwYXR0ZXJuICsgdGhpcy5zb3VyY2VTZWFyY2gpOwogIH07CgogIFVybE1hdGNoZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuc291cmNlOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBmdW5jdGlvbgogICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlciNleGVjCiAgICogQG1ldGhvZE9mIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGVzdHMgdGhlIHNwZWNpZmllZCBwYXRoIGFnYWluc3QgdGhpcyBtYXRjaGVyLCBhbmQgcmV0dXJucyBhbiBvYmplY3QgY29udGFpbmluZyB0aGUgY2FwdHVyZWQKICAgKiBwYXJhbWV0ZXIgdmFsdWVzLCBvciBudWxsIGlmIHRoZSBwYXRoIGRvZXMgbm90IG1hdGNoLiBUaGUgcmV0dXJuZWQgb2JqZWN0IGNvbnRhaW5zIHRoZSB2YWx1ZXMKICAgKiBvZiBhbnkgc2VhcmNoIHBhcmFtZXRlcnMgdGhhdCBhcmUgbWVudGlvbmVkIGluIHRoZSBwYXR0ZXJuLCBidXQgdGhlaXIgdmFsdWUgbWF5IGJlIG51bGwgaWYKICAgKiB0aGV5IGFyZSBub3QgcHJlc2VudCBpbiBgc2VhcmNoUGFyYW1zYC4gVGhpcyBtZWFucyB0aGF0IHNlYXJjaCBwYXJhbWV0ZXJzIGFyZSBhbHdheXMgdHJlYXRlZAogICAqIGFzIG9wdGlvbmFsLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGAKICAgKiBuZXcgVXJsTWF0Y2hlcignL3VzZXIve2lkfT9xJnInKS5leGVjKCcvdXNlci9ib2InLCB7IHg6JzEnLCBxOidoZWxsbycgfSk7CiAgICogLy8gcmV0dXJucyB7IGlkOidib2InLCBxOidoZWxsbycsIHI6bnVsbCB9CiAgICogYGBgCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aCAgVGhlIFVSTCBwYXRoIHRvIG1hdGNoLCBlLmcuIGAkbG9jYXRpb24ucGF0aCgpYC4KICAgKiBAcGFyYW0ge09iamVjdH0gc2VhcmNoUGFyYW1zICBVUkwgc2VhcmNoIHBhcmFtZXRlcnMsIGUuZy4gYCRsb2NhdGlvbi5zZWFyY2goKWAuCiAgICogQHJldHVybnMge09iamVjdH0gIFRoZSBjYXB0dXJlZCBwYXJhbWV0ZXIgdmFsdWVzLgogICAqLwogIFVybE1hdGNoZXIucHJvdG90eXBlLmV4ZWMgPSBmdW5jdGlvbiAocGF0aCwgc2VhcmNoUGFyYW1zKSB7CiAgICB2YXIgbSA9IHRoaXMucmVnZXhwLmV4ZWMocGF0aCk7CiAgICBpZiAoIW0pIHJldHVybiBudWxsOwoKICAgIHZhciBwYXJhbXMgPSB0aGlzLnBhcmFtcywgblRvdGFsID0gcGFyYW1zLmxlbmd0aCwKICAgICAgblBhdGggPSB0aGlzLnNlZ21lbnRzLmxlbmd0aC0xLAogICAgICB2YWx1ZXMgPSB7fSwgaTsKCiAgICBpZiAoblBhdGggIT09IG0ubGVuZ3RoIC0gMSkgdGhyb3cgbmV3IEVycm9yKCJVbmJhbGFuY2VkIGNhcHR1cmUgZ3JvdXAgaW4gcm91dGUgJyIgKyB0aGlzLnNvdXJjZSArICInIik7CgogICAgZm9yIChpPTA7IGk8blBhdGg7IGkrKykgdmFsdWVzW3BhcmFtc1tpXV0gPSBtW2krMV07CiAgICBmb3IgKC8qKi87IGk8blRvdGFsOyBpKyspIHZhbHVlc1twYXJhbXNbaV1dID0gc2VhcmNoUGFyYW1zW3BhcmFtc1tpXV07CgogICAgcmV0dXJuIHZhbHVlczsKICB9OwoKICAvKioKICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgKiBAbmFtZSB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIjcGFyYW1ldGVycwogICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFJldHVybnMgdGhlIG5hbWVzIG9mIGFsbCBwYXRoIGFuZCBzZWFyY2ggcGFyYW1ldGVycyBvZiB0aGlzIHBhdHRlcm4gaW4gYW4gdW5zcGVjaWZpZWQgb3JkZXIuCiAgICoKICAgKiBAcmV0dXJucyB7QXJyYXkuPHN0cmluZz59ICBBbiBhcnJheSBvZiBwYXJhbWV0ZXIgbmFtZXMuIE11c3QgYmUgdHJlYXRlZCBhcyByZWFkLW9ubHkuIElmIHRoZQogICAqICAgIHBhdHRlcm4gaGFzIG5vIHBhcmFtZXRlcnMsIGFuIGVtcHR5IGFycmF5IGlzIHJldHVybmVkLgogICAqLwogIFVybE1hdGNoZXIucHJvdG90eXBlLnBhcmFtZXRlcnMgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5wYXJhbXM7CiAgfTsKCiAgLyoqCiAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICogQG5hbWUgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyI2Zvcm1hdAogICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC50eXBlOlVybE1hdGNoZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSBVUkwgdGhhdCBtYXRjaGVzIHRoaXMgcGF0dGVybiBieSBzdWJzdGl0dXRpbmcgdGhlIHNwZWNpZmllZCB2YWx1ZXMKICAgKiBmb3IgdGhlIHBhdGggYW5kIHNlYXJjaCBwYXJhbWV0ZXJzLiBOdWxsIHZhbHVlcyBmb3IgcGF0aCBwYXJhbWV0ZXJzIGFyZQogICAqIHRyZWF0ZWQgYXMgZW1wdHkgc3RyaW5ncy4KICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgCiAgICogbmV3IFVybE1hdGNoZXIoJy91c2VyL3tpZH0/cScpLmZvcm1hdCh7IGlkOidib2InLCBxOid5ZXMnIH0pOwogICAqIC8vIHJldHVybnMgJy91c2VyL2JvYj9xPXllcycKICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSB2YWx1ZXMgIHRoZSB2YWx1ZXMgdG8gc3Vic3RpdHV0ZSBmb3IgdGhlIHBhcmFtZXRlcnMgaW4gdGhpcyBwYXR0ZXJuLgogICAqIEByZXR1cm5zIHtzdHJpbmd9ICB0aGUgZm9ybWF0dGVkIFVSTCAocGF0aCBhbmQgb3B0aW9uYWxseSBzZWFyY2ggcGFydCkuCiAgICovCiAgVXJsTWF0Y2hlci5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24gKHZhbHVlcykgewogICAgdmFyIHNlZ21lbnRzID0gdGhpcy5zZWdtZW50cywgcGFyYW1zID0gdGhpcy5wYXJhbXM7CiAgICBpZiAoIXZhbHVlcykgcmV0dXJuIHNlZ21lbnRzLmpvaW4oJycpOwoKICAgIHZhciBuUGF0aCA9IHNlZ21lbnRzLmxlbmd0aC0xLCBuVG90YWwgPSBwYXJhbXMubGVuZ3RoLAogICAgICByZXN1bHQgPSBzZWdtZW50c1swXSwgaSwgc2VhcmNoLCB2YWx1ZTsKCiAgICBmb3IgKGk9MDsgaTxuUGF0aDsgaSsrKSB7CiAgICAgIHZhbHVlID0gdmFsdWVzW3BhcmFtc1tpXV07CiAgICAgIC8vIFRPRE86IE1heWJlIHdlIHNob3VsZCB0aHJvdyBvbiBudWxsIGhlcmU/IEl0J3Mgbm90IHJlYWxseSBnb29kIHN0eWxlIHRvIHVzZSAnJyBhbmQgbnVsbCBpbnRlcmNoYW5nZWFibGV5CiAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSByZXN1bHQgKz0gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICAgICAgcmVzdWx0ICs9IHNlZ21lbnRzW2krMV07CiAgICB9CiAgICBmb3IgKC8qKi87IGk8blRvdGFsOyBpKyspIHsKICAgICAgdmFsdWUgPSB2YWx1ZXNbcGFyYW1zW2ldXTsKICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICByZXN1bHQgKz0gKHNlYXJjaCA/ICcmJyA6ICc/JykgKyBwYXJhbXNbaV0gKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwogICAgICAgIHNlYXJjaCA9IHRydWU7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVzdWx0OwogIH07CgoKCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLiR1cmxNYXRjaGVyRmFjdG9yeQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRmFjdG9yeSBmb3Ige0BsaW5rIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcn0gaW5zdGFuY2VzLiBUaGUgZmFjdG9yeSBpcyBhbHNvIGF2YWlsYWJsZSB0byBwcm92aWRlcnMKICAgKiB1bmRlciB0aGUgbmFtZSBgJHVybE1hdGNoZXJGYWN0b3J5UHJvdmlkZXJgLgogICAqLwogIGZ1bmN0aW9uICRVcmxNYXRjaGVyRmFjdG9yeSgpIHsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnV0aWwuJHVybE1hdGNoZXJGYWN0b3J5I2NvbXBpbGUKICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC4kdXJsTWF0Y2hlckZhY3RvcnkKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIENyZWF0ZXMgYSB7QGxpbmsgdWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyfSBmb3IgdGhlIHNwZWNpZmllZCBwYXR0ZXJuLgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXR0ZXJuICBUaGUgVVJMIHBhdHRlcm4uCiAgICAgKiBAcmV0dXJucyB7dWkucm91dGVyLnV0aWwudHlwZTpVcmxNYXRjaGVyfSAgVGhlIFVybE1hdGNoZXIuCiAgICAgKi8KICAgIHRoaXMuY29tcGlsZSA9IGZ1bmN0aW9uIChwYXR0ZXJuKSB7CiAgICAgIHJldHVybiBuZXcgVXJsTWF0Y2hlcihwYXR0ZXJuKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci51dGlsLiR1cmxNYXRjaGVyRmFjdG9yeSNpc01hdGNoZXIKICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIudXRpbC4kdXJsTWF0Y2hlckZhY3RvcnkKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBpcyBhIFVybE1hdGNoZXIsIG9yIGZhbHNlIG90aGVyd2lzZS4KICAgICAqCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0ICBUaGUgb2JqZWN0IHRvIHBlcmZvcm0gdGhlIHR5cGUgY2hlY2sgYWdhaW5zdC4KICAgICAqIEByZXR1cm5zIHtCb29sZWFufSAgUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIG9iamVjdCBoYXMgdGhlIGZvbGxvd2luZyBmdW5jdGlvbnM6IGBleGVjYCwgYGZvcm1hdGAsIGFuZCBgY29uY2F0YC4KICAgICAqLwogICAgdGhpcy5pc01hdGNoZXIgPSBmdW5jdGlvbiAobykgewogICAgICByZXR1cm4gaXNPYmplY3QobykgJiYgaXNGdW5jdGlvbihvLmV4ZWMpICYmIGlzRnVuY3Rpb24oby5mb3JtYXQpICYmIGlzRnVuY3Rpb24oby5jb25jYXQpOwogICAgfTsKCiAgICAvKiBObyBuZWVkIHRvIGRvY3VtZW50ICRnZXQsIHNpbmNlIGl0IHJldHVybnMgdGhpcyAqLwogICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgfQoKLy8gUmVnaXN0ZXIgYXMgYSBwcm92aWRlciBzbyBpdCdzIGF2YWlsYWJsZSB0byBvdGhlciBwcm92aWRlcnMKICBhbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnV0aWwnKS5wcm92aWRlcignJHVybE1hdGNoZXJGYWN0b3J5JywgJFVybE1hdGNoZXJGYWN0b3J5KTsKCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlclByb3ZpZGVyCiAgICoKICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnV0aWwuJHVybE1hdGNoZXJGYWN0b3J5UHJvdmlkZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIGAkdXJsUm91dGVyUHJvdmlkZXJgIGhhcyB0aGUgcmVzcG9uc2liaWxpdHkgb2Ygd2F0Y2hpbmcgYCRsb2NhdGlvbmAuCiAgICogV2hlbiBgJGxvY2F0aW9uYCBjaGFuZ2VzIGl0IHJ1bnMgdGhyb3VnaCBhIGxpc3Qgb2YgcnVsZXMgb25lIGJ5IG9uZSB1bnRpbCBhCiAgICogbWF0Y2ggaXMgZm91bmQuIGAkdXJsUm91dGVyUHJvdmlkZXJgIGlzIHVzZWQgYmVoaW5kIHRoZSBzY2VuZXMgYW55dGltZSB5b3Ugc3BlY2lmeQogICAqIGEgdXJsIGluIGEgc3RhdGUgY29uZmlndXJhdGlvbi4gQWxsIHVybHMgYXJlIGNvbXBpbGVkIGludG8gYSBVcmxNYXRjaGVyIG9iamVjdC4KICAgKgogICAqIFRoZXJlIGFyZSBzZXZlcmFsIG1ldGhvZHMgb24gYCR1cmxSb3V0ZXJQcm92aWRlcmAgdGhhdCBtYWtlIGl0IHVzZWZ1bCB0byB1c2UgZGlyZWN0bHkKICAgKiBpbiB5b3VyIG1vZHVsZSBjb25maWcuCiAgICovCiAgJFVybFJvdXRlclByb3ZpZGVyLiRpbmplY3QgPSBbJyR1cmxNYXRjaGVyRmFjdG9yeVByb3ZpZGVyJ107CiAgZnVuY3Rpb24gJFVybFJvdXRlclByb3ZpZGVyKCAgJHVybE1hdGNoZXJGYWN0b3J5KSB7CiAgICB2YXIgcnVsZXMgPSBbXSwKICAgICAgb3RoZXJ3aXNlID0gbnVsbDsKCiAgICAvLyBSZXR1cm5zIGEgc3RyaW5nIHRoYXQgaXMgYSBwcmVmaXggb2YgYWxsIHN0cmluZ3MgbWF0Y2hpbmcgdGhlIFJlZ0V4cAogICAgZnVuY3Rpb24gcmVnRXhwUHJlZml4KHJlKSB7CiAgICAgIHZhciBwcmVmaXggPSAvXlxeKCg/OlxcW15hLXpBLVowLTldfFteXFxcW1xdXF4kKis/LigpfHt9XSspKikvLmV4ZWMocmUuc291cmNlKTsKICAgICAgcmV0dXJuIChwcmVmaXggIT0gbnVsbCkgPyBwcmVmaXhbMV0ucmVwbGFjZSgvXFwoLikvZywgIiQxIikgOiAnJzsKICAgIH0KCiAgICAvLyBJbnRlcnBvbGF0ZXMgbWF0Y2hlZCB2YWx1ZXMgaW50byBhIFN0cmluZy5yZXBsYWNlKCktc3R5bGUgcGF0dGVybgogICAgZnVuY3Rpb24gaW50ZXJwb2xhdGUocGF0dGVybiwgbWF0Y2gpIHsKICAgICAgcmV0dXJuIHBhdHRlcm4ucmVwbGFjZSgvXCQoXCR8XGR7MSwyfSkvLCBmdW5jdGlvbiAobSwgd2hhdCkgewogICAgICAgIHJldHVybiBtYXRjaFt3aGF0ID09PSAnJCcgPyAwIDogTnVtYmVyKHdoYXQpXTsKICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlclByb3ZpZGVyI3J1bGUKICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGVmaW5lcyBydWxlcyB0aGF0IGFyZSB1c2VkIGJ5IGAkdXJsUm91dGVyUHJvdmlkZXIgdG8gZmluZCBtYXRjaGVzIGZvcgogICAgICogc3BlY2lmaWMgVVJMcy4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogPHByZT4KICAgICAqIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnYXBwJywgWyd1aS5yb3V0ZXIucm91dGVyJ10pOwogICAgICoKICAgICAqIGFwcC5jb25maWcoZnVuY3Rpb24gKCR1cmxSb3V0ZXJQcm92aWRlcikgewogICAqICAgLy8gSGVyZSdzIGFuIGV4YW1wbGUgb2YgaG93IHlvdSBtaWdodCBhbGxvdyBjYXNlIGluc2Vuc2l0aXZlIHVybHMKICAgKiAgICR1cmxSb3V0ZXJQcm92aWRlci5ydWxlKGZ1bmN0aW9uICgkaW5qZWN0b3IsICRsb2NhdGlvbikgewogICAqICAgICB2YXIgcGF0aCA9ICRsb2NhdGlvbi5wYXRoKCksCiAgICogICAgICAgICBub3JtYWxpemVkID0gcGF0aC50b0xvd2VyQ2FzZSgpOwogICAqCiAgICogICAgIGlmIChwYXRoICE9PSBub3JtYWxpemVkKSB7CiAgICogICAgICAgcmV0dXJuIG5vcm1hbGl6ZWQ7CiAgICogICAgIH0KICAgKiAgIH0pOwogICAqIH0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtvYmplY3R9IHJ1bGUgSGFuZGxlciBmdW5jdGlvbiB0aGF0IHRha2VzIGAkaW5qZWN0b3JgIGFuZCBgJGxvY2F0aW9uYAogICAgICogc2VydmljZXMgYXMgYXJndW1lbnRzLiBZb3UgY2FuIHVzZSB0aGVtIHRvIHJldHVybiBhIHZhbGlkIHBhdGggYXMgYSBzdHJpbmcuCiAgICAgKgogICAgICogQHJldHVybiB7b2JqZWN0fSAkdXJsUm91dGVyUHJvdmlkZXIgLSAkdXJsUm91dGVyUHJvdmlkZXIgaW5zdGFuY2UKICAgICAqLwogICAgdGhpcy5ydWxlID0KICAgICAgZnVuY3Rpb24gKHJ1bGUpIHsKICAgICAgICBpZiAoIWlzRnVuY3Rpb24ocnVsZSkpIHRocm93IG5ldyBFcnJvcigiJ3J1bGUnIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICAgIHJ1bGVzLnB1c2gocnVsZSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlciNvdGhlcndpc2UKICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogRGVmaW5lcyBhIHBhdGggdGhhdCBpcyB1c2VkIHdoZW4gYW4gaW52YWxpZWQgcm91dGUgaXMgcmVxdWVzdGVkLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiA8cHJlPgogICAgICogdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdhcHAnLCBbJ3VpLnJvdXRlci5yb3V0ZXInXSk7CiAgICAgKgogICAgICogYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHVybFJvdXRlclByb3ZpZGVyKSB7CiAgICogICAvLyBpZiB0aGUgcGF0aCBkb2Vzbid0IG1hdGNoIGFueSBvZiB0aGUgdXJscyB5b3UgY29uZmlndXJlZAogICAqICAgLy8gb3RoZXJ3aXNlIHdpbGwgdGFrZSBjYXJlIG9mIHJvdXRpbmcgdGhlIHVzZXIgdG8gdGhlCiAgICogICAvLyBzcGVjaWZpZWQgdXJsCiAgICogICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlKCcvaW5kZXgnKTsKICAgKgogICAqICAgLy8gRXhhbXBsZSBvZiB1c2luZyBmdW5jdGlvbiBydWxlIGFzIHBhcmFtCiAgICogICAkdXJsUm91dGVyUHJvdmlkZXIub3RoZXJ3aXNlKGZ1bmN0aW9uICgkaW5qZWN0b3IsICRsb2NhdGlvbikgewogICAqICAgICAuLi4KICAgKiAgIH0pOwogICAqIH0pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSBydWxlIFRoZSB1cmwgcGF0aCB5b3Ugd2FudCB0byByZWRpcmVjdCB0byBvciBhIGZ1bmN0aW9uCiAgICAgKiBydWxlIHRoYXQgcmV0dXJucyB0aGUgdXJsIHBhdGguIFRoZSBmdW5jdGlvbiB2ZXJzaW9uIGlzIHBhc3NlZCB0d28gcGFyYW1zOgogICAgICogYCRpbmplY3RvcmAgYW5kIGAkbG9jYXRpb25gIHNlcnZpY2VzLgogICAgICoKICAgICAqIEByZXR1cm4ge29iamVjdH0gJHVybFJvdXRlclByb3ZpZGVyIC0gJHVybFJvdXRlclByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KICAgIHRoaXMub3RoZXJ3aXNlID0KICAgICAgZnVuY3Rpb24gKHJ1bGUpIHsKICAgICAgICBpZiAoaXNTdHJpbmcocnVsZSkpIHsKICAgICAgICAgIHZhciByZWRpcmVjdCA9IHJ1bGU7CiAgICAgICAgICBydWxlID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gcmVkaXJlY3Q7IH07CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCFpc0Z1bmN0aW9uKHJ1bGUpKSB0aHJvdyBuZXcgRXJyb3IoIidydWxlJyBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgICAgICBvdGhlcndpc2UgPSBydWxlOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9OwoKCiAgICBmdW5jdGlvbiBoYW5kbGVJZk1hdGNoKCRpbmplY3RvciwgaGFuZGxlciwgbWF0Y2gpIHsKICAgICAgaWYgKCFtYXRjaCkgcmV0dXJuIGZhbHNlOwogICAgICB2YXIgcmVzdWx0ID0gJGluamVjdG9yLmludm9rZShoYW5kbGVyLCBoYW5kbGVyLCB7ICRtYXRjaDogbWF0Y2ggfSk7CiAgICAgIHJldHVybiBpc0RlZmluZWQocmVzdWx0KSA/IHJlc3VsdCA6IHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAqIEBuYW1lIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlclByb3ZpZGVyI3doZW4KICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXJzIGEgaGFuZGxlciBmb3IgYSBnaXZlbiB1cmwgbWF0Y2hpbmcuIGlmIGhhbmRsZSBpcyBhIHN0cmluZywgaXQgaXMKICAgICAqIHRyZWF0ZWQgYXMgYSByZWRpcmVjdCwgYW5kIGlzIGludGVycG9sYXRlZCBhY2NvcmRpbmcgdG8gdGhlIHN5eW50YXggb2YgbWF0Y2gKICAgICAqIChpLmUuIGxpa2UgU3RyaW5nLnJlcGxhY2UoKSBmb3IgUmVnRXhwLCBvciBsaWtlIGEgVXJsTWF0Y2hlciBwYXR0ZXJuIG90aGVyd2lzZSkuCiAgICAgKgogICAgICogSWYgdGhlIGhhbmRsZXIgaXMgYSBmdW5jdGlvbiwgaXQgaXMgaW5qZWN0YWJsZS4gSXQgZ2V0cyBpbnZva2VkIGlmIGAkbG9jYXRpb25gCiAgICAgKiBtYXRjaGVzLiBZb3UgaGF2ZSB0aGUgb3B0aW9uIG9mIGluamVjdCB0aGUgbWF0Y2ggb2JqZWN0IGFzIGAkbWF0Y2hgLgogICAgICoKICAgICAqIFRoZSBoYW5kbGVyIGNhbiByZXR1cm4KICAgICAqCiAgICAgKiAtICoqZmFsc3kqKiB0byBpbmRpY2F0ZSB0aGF0IHRoZSBydWxlIGRpZG4ndCBtYXRjaCBhZnRlciBhbGwsIHRoZW4gYCR1cmxSb3V0ZXJgCiAgICAgKiAgIHdpbGwgY29udGludWUgdHJ5aW5nIHRvIGZpbmQgYW5vdGhlciBvbmUgdGhhdCBtYXRjaGVzLgogICAgICogLSAqKnN0cmluZyoqIHdoaWNoIGlzIHRyZWF0ZWQgYXMgYSByZWRpcmVjdCBhbmQgcGFzc2VkIHRvIGAkbG9jYXRpb24udXJsKClgCiAgICAgKiAtICoqdm9pZCoqIG9yIGFueSAqKnRydXRoeSoqIHZhbHVlIHRlbGxzIGAkdXJsUm91dGVyYCB0aGF0IHRoZSB1cmwgd2FzIGhhbmRsZWQuCiAgICAgKgogICAgICogQGV4YW1wbGUKICAgICAqIDxwcmU+CiAgICAgKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsndWkucm91dGVyLnJvdXRlciddKTsKICAgICAqCiAgICAgKiBhcHAuY29uZmlnKGZ1bmN0aW9uICgkdXJsUm91dGVyUHJvdmlkZXIpIHsKICAgKiAgICR1cmxSb3V0ZXJQcm92aWRlci53aGVuKCRzdGF0ZS51cmwsIGZ1bmN0aW9uICgkbWF0Y2gsICRzdGF0ZVBhcmFtcykgewogICAqICAgICBpZiAoJHN0YXRlLiRjdXJyZW50Lm5hdmlnYWJsZSAhPT0gc3RhdGUgfHwKICAgKiAgICAgICAgICFlcXVhbEZvcktleXMoJG1hdGNoLCAkc3RhdGVQYXJhbXMpIHsKICAgKiAgICAgICRzdGF0ZS50cmFuc2l0aW9uVG8oc3RhdGUsICRtYXRjaCwgZmFsc2UpOwogICAqICAgICB9CiAgICogICB9KTsKICAgKiB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gd2hhdCBUaGUgaW5jb21pbmcgcGF0aCB0aGF0IHlvdSB3YW50IHRvIHJlZGlyZWN0LgogICAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSBoYW5kbGVyIFRoZSBwYXRoIHlvdSB3YW50IHRvIHJlZGlyZWN0IHlvdXIgdXNlciB0by4KICAgICAqLwogICAgdGhpcy53aGVuID0KICAgICAgZnVuY3Rpb24gKHdoYXQsIGhhbmRsZXIpIHsKICAgICAgICB2YXIgcmVkaXJlY3QsIGhhbmRsZXJJc1N0cmluZyA9IGlzU3RyaW5nKGhhbmRsZXIpOwogICAgICAgIGlmIChpc1N0cmluZyh3aGF0KSkgd2hhdCA9ICR1cmxNYXRjaGVyRmFjdG9yeS5jb21waWxlKHdoYXQpOwoKICAgICAgICBpZiAoIWhhbmRsZXJJc1N0cmluZyAmJiAhaXNGdW5jdGlvbihoYW5kbGVyKSAmJiAhaXNBcnJheShoYW5kbGVyKSkKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiaW52YWxpZCAnaGFuZGxlcicgaW4gd2hlbigpIik7CgogICAgICAgIHZhciBzdHJhdGVnaWVzID0gewogICAgICAgICAgbWF0Y2hlcjogZnVuY3Rpb24gKHdoYXQsIGhhbmRsZXIpIHsKICAgICAgICAgICAgaWYgKGhhbmRsZXJJc1N0cmluZykgewogICAgICAgICAgICAgIHJlZGlyZWN0ID0gJHVybE1hdGNoZXJGYWN0b3J5LmNvbXBpbGUoaGFuZGxlcik7CiAgICAgICAgICAgICAgaGFuZGxlciA9IFsnJG1hdGNoJywgZnVuY3Rpb24gKCRtYXRjaCkgeyByZXR1cm4gcmVkaXJlY3QuZm9ybWF0KCRtYXRjaCk7IH1dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gKCRpbmplY3RvciwgJGxvY2F0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUlmTWF0Y2goJGluamVjdG9yLCBoYW5kbGVyLCB3aGF0LmV4ZWMoJGxvY2F0aW9uLnBhdGgoKSwgJGxvY2F0aW9uLnNlYXJjaCgpKSk7CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBwcmVmaXg6IGlzU3RyaW5nKHdoYXQucHJlZml4KSA/IHdoYXQucHJlZml4IDogJycKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgcmVnZXg6IGZ1bmN0aW9uICh3aGF0LCBoYW5kbGVyKSB7CiAgICAgICAgICAgIGlmICh3aGF0Lmdsb2JhbCB8fCB3aGF0LnN0aWNreSkgdGhyb3cgbmV3IEVycm9yKCJ3aGVuKCkgUmVnRXhwIG11c3Qgbm90IGJlIGdsb2JhbCBvciBzdGlja3kiKTsKCiAgICAgICAgICAgIGlmIChoYW5kbGVySXNTdHJpbmcpIHsKICAgICAgICAgICAgICByZWRpcmVjdCA9IGhhbmRsZXI7CiAgICAgICAgICAgICAgaGFuZGxlciA9IFsnJG1hdGNoJywgZnVuY3Rpb24gKCRtYXRjaCkgeyByZXR1cm4gaW50ZXJwb2xhdGUocmVkaXJlY3QsICRtYXRjaCk7IH1dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBleHRlbmQoZnVuY3Rpb24gKCRpbmplY3RvciwgJGxvY2F0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZUlmTWF0Y2goJGluamVjdG9yLCBoYW5kbGVyLCB3aGF0LmV4ZWMoJGxvY2F0aW9uLnBhdGgoKSkpOwogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgcHJlZml4OiByZWdFeHBQcmVmaXgod2hhdCkKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIGNoZWNrID0geyBtYXRjaGVyOiAkdXJsTWF0Y2hlckZhY3RvcnkuaXNNYXRjaGVyKHdoYXQpLCByZWdleDogd2hhdCBpbnN0YW5jZW9mIFJlZ0V4cCB9OwoKICAgICAgICBmb3IgKHZhciBuIGluIGNoZWNrKSB7CiAgICAgICAgICBpZiAoY2hlY2tbbl0pIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucnVsZShzdHJhdGVnaWVzW25dKHdoYXQsIGhhbmRsZXIpKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRocm93IG5ldyBFcnJvcigiaW52YWxpZCAnd2hhdCcgaW4gd2hlbigpIik7CiAgICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXIKICAgICAqCiAgICAgKiBAcmVxdWlyZXMgJGxvY2F0aW9uCiAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICogQHJlcXVpcmVzICRpbmplY3RvcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqLwogICAgdGhpcy4kZ2V0ID0KICAgICAgWyAgICAgICAgJyRsb2NhdGlvbicsICckcm9vdFNjb3BlJywgJyRpbmplY3RvcicsCiAgICAgICAgZnVuY3Rpb24gKCRsb2NhdGlvbiwgICAkcm9vdFNjb3BlLCAgICRpbmplY3RvcikgewogICAgICAgICAgLy8gVE9ETzogT3B0aW1pemUgZ3JvdXBzIG9mIHJ1bGVzIHdpdGggbm9uLWVtcHR5IHByZWZpeCBpbnRvIHNvbWUgc29ydCBvZiBkZWNpc2lvbiB0cmVlCiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGUoZXZ0KSB7CiAgICAgICAgICAgIGlmIChldnQgJiYgZXZ0LmRlZmF1bHRQcmV2ZW50ZWQpIHJldHVybjsKICAgICAgICAgICAgZnVuY3Rpb24gY2hlY2socnVsZSkgewogICAgICAgICAgICAgIHZhciBoYW5kbGVkID0gcnVsZSgkaW5qZWN0b3IsICRsb2NhdGlvbik7CiAgICAgICAgICAgICAgaWYgKGhhbmRsZWQpIHsKICAgICAgICAgICAgICAgIGlmIChpc1N0cmluZyhoYW5kbGVkKSkgJGxvY2F0aW9uLnJlcGxhY2UoKS51cmwoaGFuZGxlZCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuPXJ1bGVzLmxlbmd0aCwgaTsKICAgICAgICAgICAgZm9yIChpPTA7IGk8bjsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKGNoZWNrKHJ1bGVzW2ldKSkgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGFsd2F5cyBjaGVjayBvdGhlcndpc2UgbGFzdCB0byBhbGxvdyBkeW5hbWljIHVwZGF0ZXMgdG8gdGhlIHNldCBvZiBydWxlcwogICAgICAgICAgICBpZiAob3RoZXJ3aXNlKSBjaGVjayhvdGhlcndpc2UpOwogICAgICAgICAgfQoKICAgICAgICAgICRyb290U2NvcGUuJG9uKCckbG9jYXRpb25DaGFuZ2VTdWNjZXNzJywgdXBkYXRlKTsKCiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlciNzeW5jCiAgICAgICAgICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFRyaWdnZXJzIGFuIHVwZGF0ZTsgdGhlIHNhbWUgdXBkYXRlIHRoYXQgaGFwcGVucyB3aGVuIHRoZSBhZGRyZXNzIGJhciB1cmwgY2hhbmdlcywgYWthIGAkbG9jYXRpb25DaGFuZ2VTdWNjZXNzYC4KICAgICAgICAgICAgICogVGhpcyBtZXRob2QgaXMgdXNlZnVsIHdoZW4geW91IG5lZWQgdG8gdXNlIGBwcmV2ZW50RGVmYXVsdCgpYCBvbiB0aGUgYCRsb2NhdGlvbkNoYW5nZVN1Y2Nlc3NgIGV2ZW50LAogICAgICAgICAgICAgKiBwZXJmb3JtIHNvbWUgY3VzdG9tIGxvZ2ljIChyb3V0ZSBwcm90ZWN0aW9uLCBhdXRoLCBjb25maWcsIHJlZGlyZWN0aW9uLCBldGMpIGFuZCB0aGVuIGZpbmFsbHkgcHJvY2VlZAogICAgICAgICAgICAgKiB3aXRoIHRoZSB0cmFuc2l0aW9uIGJ5IGNhbGxpbmcgYCR1cmxSb3V0ZXIuc3luYygpYC4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAgICogPHByZT4KICAgICAgICAgICAgICogYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsndWkucm91dGVyJ10pOwogICAgICAgICAgICAgKiAgIC5ydW4oZnVuY3Rpb24oJHJvb3RTY29wZSwgJHVybFJvdXRlcikgewogICAgICAgICAqICAgICAkcm9vdFNjb3BlLiRvbignJGxvY2F0aW9uQ2hhbmdlU3VjY2VzcycsIGZ1bmN0aW9uKGV2dCkgewogICAgICAgICAqICAgICAgIC8vIEhhbHQgc3RhdGUgY2hhbmdlIGZyb20gZXZlbiBzdGFydGluZwogICAgICAgICAqICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAqICAgICAgIC8vIFBlcmZvcm0gY3VzdG9tIGxvZ2ljCiAgICAgICAgICogICAgICAgdmFyIG1lZXRzUmVxdWlyZW1lbnQgPSAuLi4KICAgICAgICAgKiAgICAgICAvLyBDb250aW51ZSB3aXRoIHRoZSB1cGRhdGUgYW5kIHN0YXRlIHRyYW5zaXRpb24gaWYgbG9naWMgYWxsb3dzCiAgICAgICAgICogICAgICAgaWYgKG1lZXRzUmVxdWlyZW1lbnQpICR1cmxSb3V0ZXIuc3luYygpOwogICAgICAgICAqICAgICB9KTsKICAgICAgICAgKiB9KTsKICAgICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBzeW5jOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfV07CiAgfQoKICBhbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnJvdXRlcicpLnByb3ZpZGVyKCckdXJsUm91dGVyJywgJFVybFJvdXRlclByb3ZpZGVyKTsKCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlcgogICAqCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlclByb3ZpZGVyCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci51dGlsLiR1cmxNYXRjaGVyRmFjdG9yeVByb3ZpZGVyCiAgICogQHJlcXVpcmVzICRsb2NhdGlvblByb3ZpZGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgbmV3IGAkc3RhdGVQcm92aWRlcmAgd29ya3Mgc2ltaWxhciB0byBBbmd1bGFyJ3MgdjEgcm91dGVyLCBidXQgaXQgZm9jdXNlcyBwdXJlbHkKICAgKiBvbiBzdGF0ZS4KICAgKgogICAqIEEgc3RhdGUgY29ycmVzcG9uZHMgdG8gYSAicGxhY2UiIGluIHRoZSBhcHBsaWNhdGlvbiBpbiB0ZXJtcyBvZiB0aGUgb3ZlcmFsbCBVSSBhbmQKICAgKiBuYXZpZ2F0aW9uLiBBIHN0YXRlIGRlc2NyaWJlcyAodmlhIHRoZSBjb250cm9sbGVyIC8gdGVtcGxhdGUgLyB2aWV3IHByb3BlcnRpZXMpIHdoYXQKICAgKiB0aGUgVUkgbG9va3MgbGlrZSBhbmQgZG9lcyBhdCB0aGF0IHBsYWNlLgogICAqCiAgICogU3RhdGVzIG9mdGVuIGhhdmUgdGhpbmdzIGluIGNvbW1vbiwgYW5kIHRoZSBwcmltYXJ5IHdheSBvZiBmYWN0b3Jpbmcgb3V0IHRoZXNlCiAgICogY29tbW9uYWxpdGllcyBpbiB0aGlzIG1vZGVsIGlzIHZpYSB0aGUgc3RhdGUgaGllcmFyY2h5LCBpLmUuIHBhcmVudC9jaGlsZCBzdGF0ZXMgYWthCiAgICogbmVzdGVkIHN0YXRlcy4KICAgKgogICAqIFRoZSBgJHN0YXRlUHJvdmlkZXJgIHByb3ZpZGVzIGludGVyZmFjZXMgdG8gZGVjbGFyZSB0aGVzZSBzdGF0ZXMgZm9yIHlvdXIgYXBwLgogICAqLwogICRTdGF0ZVByb3ZpZGVyLiRpbmplY3QgPSBbJyR1cmxSb3V0ZXJQcm92aWRlcicsICckdXJsTWF0Y2hlckZhY3RvcnlQcm92aWRlcicsICckbG9jYXRpb25Qcm92aWRlciddOwogIGZ1bmN0aW9uICRTdGF0ZVByb3ZpZGVyKCAgICR1cmxSb3V0ZXJQcm92aWRlciwgICAkdXJsTWF0Y2hlckZhY3RvcnksICAgICAgICAgICAkbG9jYXRpb25Qcm92aWRlcikgewoKICAgIHZhciByb290LCBzdGF0ZXMgPSB7fSwgJHN0YXRlLCBxdWV1ZSA9IHt9LCBhYnN0cmFjdEtleSA9ICdhYnN0cmFjdCc7CgogICAgLy8gQnVpbGRzIHN0YXRlIHByb3BlcnRpZXMgZnJvbSBkZWZpbml0aW9uIHBhc3NlZCB0byByZWdpc3RlclN0YXRlKCkKICAgIHZhciBzdGF0ZUJ1aWxkZXIgPSB7CgogICAgICAvLyBEZXJpdmUgcGFyZW50IHN0YXRlIGZyb20gYSBoaWVyYXJjaGljYWwgbmFtZSBvbmx5IGlmICdwYXJlbnQnIGlzIG5vdCBleHBsaWNpdGx5IGRlZmluZWQuCiAgICAgIC8vIHN0YXRlLmNoaWxkcmVuID0gW107CiAgICAgIC8vIGlmIChwYXJlbnQpIHBhcmVudC5jaGlsZHJlbi5wdXNoKHN0YXRlKTsKICAgICAgcGFyZW50OiBmdW5jdGlvbihzdGF0ZSkgewogICAgICAgIGlmIChpc0RlZmluZWQoc3RhdGUucGFyZW50KSAmJiBzdGF0ZS5wYXJlbnQpIHJldHVybiBmaW5kU3RhdGUoc3RhdGUucGFyZW50KTsKICAgICAgICAvLyByZWdleCBtYXRjaGVzIGFueSB2YWxpZCBjb21wb3NpdGUgc3RhdGUgbmFtZQogICAgICAgIC8vIHdvdWxkIG1hdGNoICJjb250YWN0Lmxpc3QiIGJ1dCBub3QgImNvbnRhY3RzIgogICAgICAgIHZhciBjb21wb3NpdGVOYW1lID0gL14oLispXC5bXi5dKyQvLmV4ZWMoc3RhdGUubmFtZSk7CiAgICAgICAgcmV0dXJuIGNvbXBvc2l0ZU5hbWUgPyBmaW5kU3RhdGUoY29tcG9zaXRlTmFtZVsxXSkgOiByb290OwogICAgICB9LAoKICAgICAgLy8gaW5oZXJpdCAnZGF0YScgZnJvbSBwYXJlbnQgYW5kIG92ZXJyaWRlIGJ5IG93biB2YWx1ZXMgKGlmIGFueSkKICAgICAgZGF0YTogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgICBpZiAoc3RhdGUucGFyZW50ICYmIHN0YXRlLnBhcmVudC5kYXRhKSB7CiAgICAgICAgICBzdGF0ZS5kYXRhID0gc3RhdGUuc2VsZi5kYXRhID0gZXh0ZW5kKHt9LCBzdGF0ZS5wYXJlbnQuZGF0YSwgc3RhdGUuZGF0YSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdGF0ZS5kYXRhOwogICAgICB9LAoKICAgICAgLy8gQnVpbGQgYSBVUkxNYXRjaGVyIGlmIG5lY2Vzc2FyeSwgZWl0aGVyIHZpYSBhIHJlbGF0aXZlIG9yIGFic29sdXRlIFVSTAogICAgICB1cmw6IGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgICAgdmFyIHVybCA9IHN0YXRlLnVybDsKCiAgICAgICAgaWYgKGlzU3RyaW5nKHVybCkpIHsKICAgICAgICAgIGlmICh1cmwuY2hhckF0KDApID09ICdeJykgewogICAgICAgICAgICByZXR1cm4gJHVybE1hdGNoZXJGYWN0b3J5LmNvbXBpbGUodXJsLnN1YnN0cmluZygxKSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gKHN0YXRlLnBhcmVudC5uYXZpZ2FibGUgfHwgcm9vdCkudXJsLmNvbmNhdCh1cmwpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCR1cmxNYXRjaGVyRmFjdG9yeS5pc01hdGNoZXIodXJsKSB8fCB1cmwgPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIHVybDsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHVybCAnIiArIHVybCArICInIGluIHN0YXRlICciICsgc3RhdGUgKyAiJyIpOwogICAgICB9LAoKICAgICAgLy8gS2VlcCB0cmFjayBvZiB0aGUgY2xvc2VzdCBhbmNlc3RvciBzdGF0ZSB0aGF0IGhhcyBhIFVSTCAoaS5lLiBpcyBuYXZpZ2FibGUpCiAgICAgIG5hdmlnYWJsZTogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgICByZXR1cm4gc3RhdGUudXJsID8gc3RhdGUgOiAoc3RhdGUucGFyZW50ID8gc3RhdGUucGFyZW50Lm5hdmlnYWJsZSA6IG51bGwpOwogICAgICB9LAoKICAgICAgLy8gRGVyaXZlIHBhcmFtZXRlcnMgZm9yIHRoaXMgc3RhdGUgYW5kIGVuc3VyZSB0aGV5J3JlIGEgc3VwZXItc2V0IG9mIHBhcmVudCdzIHBhcmFtZXRlcnMKICAgICAgcGFyYW1zOiBmdW5jdGlvbihzdGF0ZSkgewogICAgICAgIGlmICghc3RhdGUucGFyYW1zKSB7CiAgICAgICAgICByZXR1cm4gc3RhdGUudXJsID8gc3RhdGUudXJsLnBhcmFtZXRlcnMoKSA6IHN0YXRlLnBhcmVudC5wYXJhbXM7CiAgICAgICAgfQogICAgICAgIGlmICghaXNBcnJheShzdGF0ZS5wYXJhbXMpKSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcGFyYW1zIGluIHN0YXRlICciICsgc3RhdGUgKyAiJyIpOwogICAgICAgIGlmIChzdGF0ZS51cmwpIHRocm93IG5ldyBFcnJvcigiQm90aCBwYXJhbXMgYW5kIHVybCBzcGVjaWNpZmllZCBpbiBzdGF0ZSAnIiArIHN0YXRlICsgIiciKTsKICAgICAgICByZXR1cm4gc3RhdGUucGFyYW1zOwogICAgICB9LAoKICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gZXhwbGljaXQgbXVsdGktdmlldyBjb25maWd1cmF0aW9uLCBtYWtlIG9uZSB1cCBzbyB3ZSBkb24ndCBoYXZlCiAgICAgIC8vIHRvIGhhbmRsZSBib3RoIGNhc2VzIGluIHRoZSB2aWV3IGRpcmVjdGl2ZSBsYXRlci4gTm90ZSB0aGF0IGhhdmluZyBhbiBleHBsaWNpdAogICAgICAvLyAndmlld3MnIHByb3BlcnR5IHdpbGwgbWVhbiB0aGUgZGVmYXVsdCB1bm5hbWVkIHZpZXcgcHJvcGVydGllcyBhcmUgaWdub3JlZC4gVGhpcwogICAgICAvLyBpcyBhbHNvIGEgZ29vZCB0aW1lIHRvIHJlc29sdmUgdmlldyBuYW1lcyB0byBhYnNvbHV0ZSBuYW1lcywgc28gZXZlcnl0aGluZyBpcyBhCiAgICAgIC8vIHN0cmFpZ2h0IGxvb2t1cCBhdCBsaW5rIHRpbWUuCiAgICAgIHZpZXdzOiBmdW5jdGlvbihzdGF0ZSkgewogICAgICAgIHZhciB2aWV3cyA9IHt9OwoKICAgICAgICBmb3JFYWNoKGlzRGVmaW5lZChzdGF0ZS52aWV3cykgPyBzdGF0ZS52aWV3cyA6IHsgJyc6IHN0YXRlIH0sIGZ1bmN0aW9uICh2aWV3LCBuYW1lKSB7CiAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCdAJykgPCAwKSBuYW1lICs9ICdAJyArIHN0YXRlLnBhcmVudC5uYW1lOwogICAgICAgICAgdmlld3NbbmFtZV0gPSB2aWV3OwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB2aWV3czsKICAgICAgfSwKCiAgICAgIG93blBhcmFtczogZnVuY3Rpb24oc3RhdGUpIHsKICAgICAgICBpZiAoIXN0YXRlLnBhcmVudCkgewogICAgICAgICAgcmV0dXJuIHN0YXRlLnBhcmFtczsKICAgICAgICB9CiAgICAgICAgdmFyIHBhcmFtTmFtZXMgPSB7fTsgZm9yRWFjaChzdGF0ZS5wYXJhbXMsIGZ1bmN0aW9uIChwKSB7IHBhcmFtTmFtZXNbcF0gPSB0cnVlOyB9KTsKCiAgICAgICAgZm9yRWFjaChzdGF0ZS5wYXJlbnQucGFyYW1zLCBmdW5jdGlvbiAocCkgewogICAgICAgICAgaWYgKCFwYXJhbU5hbWVzW3BdKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyByZXF1aXJlZCBwYXJhbWV0ZXIgJyIgKyBwICsgIicgaW4gc3RhdGUgJyIgKyBzdGF0ZS5uYW1lICsgIiciKTsKICAgICAgICAgIH0KICAgICAgICAgIHBhcmFtTmFtZXNbcF0gPSBmYWxzZTsKICAgICAgICB9KTsKICAgICAgICB2YXIgb3duUGFyYW1zID0gW107CgogICAgICAgIGZvckVhY2gocGFyYW1OYW1lcywgZnVuY3Rpb24gKG93biwgcCkgewogICAgICAgICAgaWYgKG93bikgb3duUGFyYW1zLnB1c2gocCk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIG93blBhcmFtczsKICAgICAgfSwKCiAgICAgIC8vIEtlZXAgYSBmdWxsIHBhdGggZnJvbSB0aGUgcm9vdCBkb3duIHRvIHRoaXMgc3RhdGUgYXMgdGhpcyBpcyBuZWVkZWQgZm9yIHN0YXRlIGFjdGl2YXRpb24uCiAgICAgIHBhdGg6IGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgICAgcmV0dXJuIHN0YXRlLnBhcmVudCA/IHN0YXRlLnBhcmVudC5wYXRoLmNvbmNhdChzdGF0ZSkgOiBbXTsgLy8gZXhjbHVkZSByb290IGZyb20gcGF0aAogICAgICB9LAoKICAgICAgLy8gU3BlZWQgdXAgJHN0YXRlLmNvbnRhaW5zKCkgYXMgaXQncyB1c2VkIGEgbG90CiAgICAgIGluY2x1ZGVzOiBmdW5jdGlvbihzdGF0ZSkgewogICAgICAgIHZhciBpbmNsdWRlcyA9IHN0YXRlLnBhcmVudCA/IGV4dGVuZCh7fSwgc3RhdGUucGFyZW50LmluY2x1ZGVzKSA6IHt9OwogICAgICAgIGluY2x1ZGVzW3N0YXRlLm5hbWVdID0gdHJ1ZTsKICAgICAgICByZXR1cm4gaW5jbHVkZXM7CiAgICAgIH0sCgogICAgICAkZGVsZWdhdGVzOiB7fQogICAgfTsKCiAgICBmdW5jdGlvbiBpc1JlbGF0aXZlKHN0YXRlTmFtZSkgewogICAgICByZXR1cm4gc3RhdGVOYW1lLmluZGV4T2YoIi4iKSA9PT0gMCB8fCBzdGF0ZU5hbWUuaW5kZXhPZigiXiIpID09PSAwOwogICAgfQoKICAgIGZ1bmN0aW9uIGZpbmRTdGF0ZShzdGF0ZU9yTmFtZSwgYmFzZSkgewogICAgICB2YXIgaXNTdHIgPSBpc1N0cmluZyhzdGF0ZU9yTmFtZSksCiAgICAgICAgbmFtZSAgPSBpc1N0ciA/IHN0YXRlT3JOYW1lIDogc3RhdGVPck5hbWUubmFtZSwKICAgICAgICBwYXRoICA9IGlzUmVsYXRpdmUobmFtZSk7CgogICAgICBpZiAocGF0aCkgewogICAgICAgIGlmICghYmFzZSkgdGhyb3cgbmV3IEVycm9yKCJObyByZWZlcmVuY2UgcG9pbnQgZ2l2ZW4gZm9yIHBhdGggJyIgICsgbmFtZSArICInIik7CiAgICAgICAgdmFyIHJlbCA9IG5hbWUuc3BsaXQoIi4iKSwgaSA9IDAsIHBhdGhMZW5ndGggPSByZWwubGVuZ3RoLCBjdXJyZW50ID0gYmFzZTsKCiAgICAgICAgZm9yICg7IGkgPCBwYXRoTGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChyZWxbaV0gPT09ICIiICYmIGkgPT09IDApIHsKICAgICAgICAgICAgY3VycmVudCA9IGJhc2U7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlbFtpXSA9PT0gIl4iKSB7CiAgICAgICAgICAgIGlmICghY3VycmVudC5wYXJlbnQpIHRocm93IG5ldyBFcnJvcigiUGF0aCAnIiArIG5hbWUgKyAiJyBub3QgdmFsaWQgZm9yIHN0YXRlICciICsgYmFzZS5uYW1lICsgIiciKTsKICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucGFyZW50OwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZWwgPSByZWwuc2xpY2UoaSkuam9pbigiLiIpOwogICAgICAgIG5hbWUgPSBjdXJyZW50Lm5hbWUgKyAoY3VycmVudC5uYW1lICYmIHJlbCA/ICIuIiA6ICIiKSArIHJlbDsKICAgICAgfQogICAgICB2YXIgc3RhdGUgPSBzdGF0ZXNbbmFtZV07CgogICAgICBpZiAoc3RhdGUgJiYgKGlzU3RyIHx8ICghaXNTdHIgJiYgKHN0YXRlID09PSBzdGF0ZU9yTmFtZSB8fCBzdGF0ZS5zZWxmID09PSBzdGF0ZU9yTmFtZSkpKSkgewogICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQoKICAgIGZ1bmN0aW9uIHF1ZXVlU3RhdGUocGFyZW50TmFtZSwgc3RhdGUpIHsKICAgICAgaWYgKCFxdWV1ZVtwYXJlbnROYW1lXSkgewogICAgICAgIHF1ZXVlW3BhcmVudE5hbWVdID0gW107CiAgICAgIH0KICAgICAgcXVldWVbcGFyZW50TmFtZV0ucHVzaChzdGF0ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gcmVnaXN0ZXJTdGF0ZShzdGF0ZSkgewogICAgICAvLyBXcmFwIGEgbmV3IG9iamVjdCBhcm91bmQgdGhlIHN0YXRlIHNvIHdlIGNhbiBzdG9yZSBvdXIgcHJpdmF0ZSBkZXRhaWxzIGVhc2lseS4KICAgICAgc3RhdGUgPSBpbmhlcml0KHN0YXRlLCB7CiAgICAgICAgc2VsZjogc3RhdGUsCiAgICAgICAgcmVzb2x2ZTogc3RhdGUucmVzb2x2ZSB8fCB7fSwKICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLm5hbWU7IH0KICAgICAgfSk7CgogICAgICB2YXIgbmFtZSA9IHN0YXRlLm5hbWU7CiAgICAgIGlmICghaXNTdHJpbmcobmFtZSkgfHwgbmFtZS5pbmRleE9mKCdAJykgPj0gMCkgdGhyb3cgbmV3IEVycm9yKCJTdGF0ZSBtdXN0IGhhdmUgYSB2YWxpZCBuYW1lIik7CiAgICAgIGlmIChzdGF0ZXMuaGFzT3duUHJvcGVydHkobmFtZSkpIHRocm93IG5ldyBFcnJvcigiU3RhdGUgJyIgKyBuYW1lICsgIicnIGlzIGFscmVhZHkgZGVmaW5lZCIpOwoKICAgICAgLy8gR2V0IHBhcmVudCBuYW1lCiAgICAgIHZhciBwYXJlbnROYW1lID0gKG5hbWUuaW5kZXhPZignLicpICE9PSAtMSkgPyBuYW1lLnN1YnN0cmluZygwLCBuYW1lLmxhc3RJbmRleE9mKCcuJykpCiAgICAgICAgOiAoaXNTdHJpbmcoc3RhdGUucGFyZW50KSkgPyBzdGF0ZS5wYXJlbnQKICAgICAgICA6ICcnOwoKICAgICAgLy8gSWYgcGFyZW50IGlzIG5vdCByZWdpc3RlcmVkIHlldCwgYWRkIHN0YXRlIHRvIHF1ZXVlIGFuZCByZWdpc3RlciBsYXRlcgogICAgICBpZiAocGFyZW50TmFtZSAmJiAhc3RhdGVzW3BhcmVudE5hbWVdKSB7CiAgICAgICAgcmV0dXJuIHF1ZXVlU3RhdGUocGFyZW50TmFtZSwgc3RhdGUuc2VsZik7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGtleSBpbiBzdGF0ZUJ1aWxkZXIpIHsKICAgICAgICBpZiAoaXNGdW5jdGlvbihzdGF0ZUJ1aWxkZXJba2V5XSkpIHN0YXRlW2tleV0gPSBzdGF0ZUJ1aWxkZXJba2V5XShzdGF0ZSwgc3RhdGVCdWlsZGVyLiRkZWxlZ2F0ZXNba2V5XSk7CiAgICAgIH0KICAgICAgc3RhdGVzW25hbWVdID0gc3RhdGU7CgogICAgICAvLyBSZWdpc3RlciB0aGUgc3RhdGUgaW4gdGhlIGdsb2JhbCBzdGF0ZSBsaXN0IGFuZCB3aXRoICR1cmxSb3V0ZXIgaWYgbmVjZXNzYXJ5LgogICAgICBpZiAoIXN0YXRlW2Fic3RyYWN0S2V5XSAmJiBzdGF0ZS51cmwpIHsKICAgICAgICAkdXJsUm91dGVyUHJvdmlkZXIud2hlbihzdGF0ZS51cmwsIFsnJG1hdGNoJywgJyRzdGF0ZVBhcmFtcycsIGZ1bmN0aW9uICgkbWF0Y2gsICRzdGF0ZVBhcmFtcykgewogICAgICAgICAgaWYgKCRzdGF0ZS4kY3VycmVudC5uYXZpZ2FibGUgIT0gc3RhdGUgfHwgIWVxdWFsRm9yS2V5cygkbWF0Y2gsICRzdGF0ZVBhcmFtcykpIHsKICAgICAgICAgICAgJHN0YXRlLnRyYW5zaXRpb25UbyhzdGF0ZSwgJG1hdGNoLCB7IGxvY2F0aW9uOiBmYWxzZSB9KTsKICAgICAgICAgIH0KICAgICAgICB9XSk7CiAgICAgIH0KCiAgICAgIC8vIFJlZ2lzdGVyIGFueSBxdWV1ZWQgY2hpbGRyZW4KICAgICAgaWYgKHF1ZXVlW25hbWVdKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZVtuYW1lXS5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmVnaXN0ZXJTdGF0ZShxdWV1ZVtuYW1lXVtpXSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gc3RhdGU7CiAgICB9CgogICAgLy8gQ2hlY2tzIHRleHQgdG8gc2VlIGlmIGl0IGxvb2tzIGxpa2UgYSBnbG9iLgogICAgZnVuY3Rpb24gaXNHbG9iICh0ZXh0KSB7CiAgICAgIHJldHVybiB0ZXh0LmluZGV4T2YoJyonKSA+IC0xOwogICAgfQoKICAgIC8vIFJldHVybnMgdHJ1ZSBpZiBnbG9iIG1hdGNoZXMgY3VycmVudCAkc3RhdGUgbmFtZS4KICAgIGZ1bmN0aW9uIGRvZXNTdGF0ZU1hdGNoR2xvYiAoZ2xvYikgewogICAgICB2YXIgZ2xvYlNlZ21lbnRzID0gZ2xvYi5zcGxpdCgnLicpLAogICAgICAgIHNlZ21lbnRzID0gJHN0YXRlLiRjdXJyZW50Lm5hbWUuc3BsaXQoJy4nKTsKCiAgICAgIC8vbWF0Y2ggZ3JlZWR5IHN0YXJ0cwogICAgICBpZiAoZ2xvYlNlZ21lbnRzWzBdID09PSAnKionKSB7CiAgICAgICAgc2VnbWVudHMgPSBzZWdtZW50cy5zbGljZShzZWdtZW50cy5pbmRleE9mKGdsb2JTZWdtZW50c1sxXSkpOwogICAgICAgIHNlZ21lbnRzLnVuc2hpZnQoJyoqJyk7CiAgICAgIH0KICAgICAgLy9tYXRjaCBncmVlZHkgZW5kcwogICAgICBpZiAoZ2xvYlNlZ21lbnRzW2dsb2JTZWdtZW50cy5sZW5ndGggLSAxXSA9PT0gJyoqJykgewogICAgICAgIHNlZ21lbnRzLnNwbGljZShzZWdtZW50cy5pbmRleE9mKGdsb2JTZWdtZW50c1tnbG9iU2VnbWVudHMubGVuZ3RoIC0gMl0pICsgMSwgTnVtYmVyLk1BWF9WQUxVRSk7CiAgICAgICAgc2VnbWVudHMucHVzaCgnKionKTsKICAgICAgfQoKICAgICAgaWYgKGdsb2JTZWdtZW50cy5sZW5ndGggIT0gc2VnbWVudHMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICAvL21hdGNoIHNpbmdsZSBzdGFycwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGdsb2JTZWdtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAoZ2xvYlNlZ21lbnRzW2ldID09PSAnKicpIHsKICAgICAgICAgIHNlZ21lbnRzW2ldID0gJyonOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHNlZ21lbnRzLmpvaW4oJycpID09PSBnbG9iU2VnbWVudHMuam9pbignJyk7CiAgICB9CgoKICAgIC8vIEltcGxpY2l0IHJvb3Qgc3RhdGUgdGhhdCBpcyBhbHdheXMgYWN0aXZlCiAgICByb290ID0gcmVnaXN0ZXJTdGF0ZSh7CiAgICAgIG5hbWU6ICcnLAogICAgICB1cmw6ICdeJywKICAgICAgdmlld3M6IG51bGwsCiAgICAgICdhYnN0cmFjdCc6IHRydWUKICAgIH0pOwogICAgcm9vdC5uYXZpZ2FibGUgPSBudWxsOwoKCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVByb3ZpZGVyI2RlY29yYXRvcgogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGVQcm92aWRlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogQWxsb3dzIHlvdSB0byBleHRlbmQgKGNhcmVmdWxseSkgb3Igb3ZlcnJpZGUgKGF0IHlvdXIgb3duIHBlcmlsKSB0aGUKICAgICAqIGBzdGF0ZUJ1aWxkZXJgIG9iamVjdCB1c2VkIGludGVybmFsbHkgYnkgYCRzdGF0ZVByb3ZpZGVyYC4gVGhpcyBjYW4gYmUgdXNlZAogICAgICogdG8gYWRkIGN1c3RvbSBmdW5jdGlvbmFsaXR5IHRvIHVpLXJvdXRlciwgZm9yIGV4YW1wbGUgaW5mZXJyaW5nIHRlbXBsYXRlVXJsCiAgICAgKiBiYXNlZCBvbiB0aGUgc3RhdGUgbmFtZS4KICAgICAqCiAgICAgKiBXaGVuIHBhc3Npbmcgb25seSBhIG5hbWUsIGl0IHJldHVybnMgdGhlIGN1cnJlbnQgKG9yaWdpbmFsIG9yIGRlY29yYXRlZCkgYnVpbGRlcgogICAgICogZnVuY3Rpb24gdGhhdCBtYXRjaGVzIGBuYW1lYC4KICAgICAqCiAgICAgKiBUaGUgYnVpbGRlciBmdW5jdGlvbnMgdGhhdCBjYW4gYmUgZGVjb3JhdGVkIGFyZSBsaXN0ZWQgYmVsb3cuIFRob3VnaCBub3QgYWxsCiAgICAgKiBuZWNlc3NhcmlseSBoYXZlIGEgZ29vZCB1c2UgY2FzZSBmb3IgZGVjb3JhdGlvbiwgdGhhdCBpcyB1cCB0byB5b3UgdG8gZGVjaWRlLgogICAgICoKICAgICAqIEluIGFkZGl0aW9uLCB1c2VycyBjYW4gYXR0YWNoIGN1c3RvbSBkZWNvcmF0b3JzLCB3aGljaCB3aWxsIGdlbmVyYXRlIG5ldwogICAgICogcHJvcGVydGllcyB3aXRoaW4gdGhlIHN0YXRlJ3MgaW50ZXJuYWwgZGVmaW5pdGlvbi4gVGhlcmUgaXMgY3VycmVudGx5IG5vIGNsZWFyCiAgICAgKiB1c2UtY2FzZSBmb3IgdGhpcyBiZXlvbmQgYWNjZXNzaW5nIGludGVybmFsIHN0YXRlcyAoaS5lLiAkc3RhdGUuJGN1cnJlbnQpLAogICAgICogaG93ZXZlciwgZXhwZWN0IHRoaXMgdG8gYmVjb21lIGluY3JlYXNpbmdseSByZWxldmFudCBhcyB3ZSBpbnRyb2R1Y2UgYWRkaXRpb25hbAogICAgICogbWV0YS1wcm9ncmFtbWluZyBmZWF0dXJlcy4KICAgICAqCiAgICAgKiAqKldhcm5pbmcqKjogRGVjb3JhdG9ycyBzaG91bGQgbm90IGJlIGludGVyZGVwZW5kZW50IGJlY2F1c2UgdGhlIG9yZGVyIG9mCiAgICAgKiBleGVjdXRpb24gb2YgdGhlIGJ1aWxkZXIgZnVuY3Rpb25zIGluIG5vbi1kZXRlcm1pbmlzdGljLiBCdWlsZGVyIGZ1bmN0aW9ucwogICAgICogc2hvdWxkIG9ubHkgYmUgZGVwZW5kZW50IG9uIHRoZSBzdGF0ZSBkZWZpbml0aW9uIG9iamVjdCBhbmQgc3VwZXIgZnVuY3Rpb24uCiAgICAgKgogICAgICoKICAgICAqIEV4aXN0aW5nIGJ1aWxkZXIgZnVuY3Rpb25zIGFuZCBjdXJyZW50IHJldHVybiB2YWx1ZXM6CiAgICAgKgogICAgICogLSAqKnBhcmVudCoqIGB7b2JqZWN0fWAgLSByZXR1cm5zIHRoZSBwYXJlbnQgc3RhdGUgb2JqZWN0LgogICAgICogLSAqKmRhdGEqKiBge29iamVjdH1gIC0gcmV0dXJucyBzdGF0ZSBkYXRhLCBpbmNsdWRpbmcgYW55IGluaGVyaXRlZCBkYXRhIHRoYXQgaXMgbm90CiAgICAgKiAgIG92ZXJyaWRkZW4gYnkgb3duIHZhbHVlcyAoaWYgYW55KS4KICAgICAqIC0gKip1cmwqKiBge29iamVjdH1gIC0gcmV0dXJucyBhIHtsaW5rIHVpLnJvdXRlci51dGlsLnR5cGU6VXJsTWF0Y2hlcn0gb3IgbnVsbC4KICAgICAqIC0gKipuYXZpZ2FibGUqKiBge29iamVjdH1gIC0gcmV0dXJucyBjbG9zZXN0IGFuY2VzdG9yIHN0YXRlIHRoYXQgaGFzIGEgVVJMIChha2EgaXMKICAgICAqICAgbmF2aWdhYmxlKS4KICAgICAqIC0gKipwYXJhbXMqKiBge29iamVjdH1gIC0gcmV0dXJucyBhbiBhcnJheSBvZiBzdGF0ZSBwYXJhbXMgdGhhdCBhcmUgZW5zdXJlZCB0bwogICAgICogICBiZSBhIHN1cGVyLXNldCBvZiBwYXJlbnQncyBwYXJhbXMuCiAgICAgKiAtICoqdmlld3MqKiBge29iamVjdH1gIC0gcmV0dXJucyBhIHZpZXdzIG9iamVjdCB3aGVyZSBlYWNoIGtleSBpcyBhbiBhYnNvbHV0ZSB2aWV3CiAgICAgKiAgIG5hbWUgKGkuZS4gInZpZXdOYW1lQHN0YXRlTmFtZSIpIGFuZCBlYWNoIHZhbHVlIGlzIHRoZSBjb25maWcgb2JqZWN0CiAgICAgKiAgICh0ZW1wbGF0ZSwgY29udHJvbGxlcikgZm9yIHRoZSB2aWV3LiBFdmVuIHdoZW4geW91IGRvbid0IHVzZSB0aGUgdmlld3Mgb2JqZWN0CiAgICAgKiAgIGV4cGxpY2l0bHkgb24gYSBzdGF0ZSBjb25maWcsIG9uZSBpcyBzdGlsbCBjcmVhdGVkIGZvciB5b3UgaW50ZXJuYWxseS4KICAgICAqICAgU28gYnkgZGVjb3JhdGluZyB0aGlzIGJ1aWxkZXIgZnVuY3Rpb24geW91IGhhdmUgYWNjZXNzIHRvIGRlY29yYXRpbmcgdGVtcGxhdGUKICAgICAqICAgYW5kIGNvbnRyb2xsZXIgcHJvcGVydGllcy4KICAgICAqIC0gKipvd25QYXJhbXMqKiBge29iamVjdH1gIC0gcmV0dXJucyBhbiBhcnJheSBvZiBwYXJhbXMgdGhhdCBiZWxvbmcgdG8gdGhlIHN0YXRlLAogICAgICogICBub3QgaW5jbHVkaW5nIGFueSBwYXJhbXMgZGVmaW5lZCBieSBhbmNlc3RvciBzdGF0ZXMuCiAgICAgKiAtICoqcGF0aCoqIGB7c3RyaW5nfWAgLSByZXR1cm5zIHRoZSBmdWxsIHBhdGggZnJvbSB0aGUgcm9vdCBkb3duIHRvIHRoaXMgc3RhdGUuCiAgICAgKiAgIE5lZWRlZCBmb3Igc3RhdGUgYWN0aXZhdGlvbi4KICAgICAqIC0gKippbmNsdWRlcyoqIGB7b2JqZWN0fWAgLSByZXR1cm5zIGFuIG9iamVjdCB0aGF0IGluY2x1ZGVzIGV2ZXJ5IHN0YXRlIHRoYXQKICAgICAqICAgd291bGQgcGFzcyBhICckc3RhdGUuaW5jbHVkZXMoKScgdGVzdC4KICAgICAqCiAgICAgKiBAZXhhbXBsZQogICAgICogPHByZT4KICAgICAqIC8vIE92ZXJyaWRlIHRoZSBpbnRlcm5hbCAndmlld3MnIGJ1aWxkZXIgd2l0aCBhIGZ1bmN0aW9uIHRoYXQgdGFrZXMgdGhlIHN0YXRlCiAgICAgKiAvLyBkZWZpbml0aW9uLCBhbmQgYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGZ1bmN0aW9uIGJlaW5nIG92ZXJyaWRkZW46CiAgICAgKiAkc3RhdGVQcm92aWRlci5kZWNvcmF0b3IoJ3ZpZXdzJywgZnVuY3Rpb24gKCRzdGF0ZSwgcGFyZW50KSB7CiAgICogICB2YXIgcmVzdWx0ID0ge30sCiAgICogICAgICAgdmlld3MgPSBwYXJlbnQoc3RhdGUpOwogICAqCiAgICogICBhbmd1bGFyLmZvckVhY2godmlldywgZnVuY3Rpb24gKGNvbmZpZywgbmFtZSkgewogICAqICAgICB2YXIgYXV0b05hbWUgPSAoc3RhdGUubmFtZSArICcuJyArIG5hbWUpLnJlcGxhY2UoJy4nLCAnLycpOwogICAqICAgICBjb25maWcudGVtcGxhdGVVcmwgPSBjb25maWcudGVtcGxhdGVVcmwgfHwgJy9wYXJ0aWFscy8nICsgYXV0b05hbWUgKyAnLmh0bWwnOwogICAqICAgICByZXN1bHRbbmFtZV0gPSBjb25maWc7CiAgICogICB9KTsKICAgKiAgIHJldHVybiByZXN1bHQ7CiAgICogfSk7CiAgICAgKgogICAgICogJHN0YXRlUHJvdmlkZXIuc3RhdGUoJ2hvbWUnLCB7CiAgICogICB2aWV3czogewogICAqICAgICAnY29udGFjdC5saXN0JzogeyBjb250cm9sbGVyOiAnTGlzdENvbnRyb2xsZXInIH0sCiAgICogICAgICdjb250YWN0Lml0ZW0nOiB7IGNvbnRyb2xsZXI6ICdJdGVtQ29udHJvbGxlcicgfQogICAqICAgfQogICAqIH0pOwogICAgICoKICAgICAqIC8vIC4uLgogICAgICoKICAgICAqICRzdGF0ZS5nbygnaG9tZScpOwogICAgICogLy8gQXV0by1wb3B1bGF0ZXMgbGlzdCBhbmQgaXRlbSB2aWV3cyB3aXRoIC9wYXJ0aWFscy9ob21lL2NvbnRhY3QvbGlzdC5odG1sLAogICAgICogLy8gYW5kIC9wYXJ0aWFscy9ob21lL2NvbnRhY3QvaXRlbS5odG1sLCByZXNwZWN0aXZlbHkuCiAgICAgKiA8L3ByZT4KICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgYnVpbGRlciBmdW5jdGlvbiB0byBkZWNvcmF0ZS4KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBmdW5jIEEgZnVuY3Rpb24gdGhhdCBpcyByZXNwb25zaWJsZSBmb3IgZGVjb3JhdGluZyB0aGUgb3JpZ2luYWwKICAgICAqIGJ1aWxkZXIgZnVuY3Rpb24uIFRoZSBmdW5jdGlvbiByZWNlaXZlcyB0d28gcGFyYW1ldGVyczoKICAgICAqCiAgICAgKiAgIC0gYHtvYmplY3R9YCAtIHN0YXRlIC0gVGhlIHN0YXRlIGNvbmZpZyBvYmplY3QuCiAgICAgKiAgIC0gYHtvYmplY3R9YCAtIHN1cGVyIC0gVGhlIG9yaWdpbmFsIGJ1aWxkZXIgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHJldHVybiB7b2JqZWN0fSAkc3RhdGVQcm92aWRlciAtICRzdGF0ZVByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KICAgIHRoaXMuZGVjb3JhdG9yID0gZGVjb3JhdG9yOwogICAgZnVuY3Rpb24gZGVjb3JhdG9yKG5hbWUsIGZ1bmMpIHsKICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovCiAgICAgIGlmIChpc1N0cmluZyhuYW1lKSAmJiAhaXNEZWZpbmVkKGZ1bmMpKSB7CiAgICAgICAgcmV0dXJuIHN0YXRlQnVpbGRlcltuYW1lXTsKICAgICAgfQogICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykgfHwgIWlzU3RyaW5nKG5hbWUpKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgaWYgKHN0YXRlQnVpbGRlcltuYW1lXSAmJiAhc3RhdGVCdWlsZGVyLiRkZWxlZ2F0ZXNbbmFtZV0pIHsKICAgICAgICBzdGF0ZUJ1aWxkZXIuJGRlbGVnYXRlc1tuYW1lXSA9IHN0YXRlQnVpbGRlcltuYW1lXTsKICAgICAgfQogICAgICBzdGF0ZUJ1aWxkZXJbbmFtZV0gPSBmdW5jOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVByb3ZpZGVyI3N0YXRlCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVByb3ZpZGVyCiAgICAgKgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBSZWdpc3RlcnMgYSBzdGF0ZSBjb25maWd1cmF0aW9uIHVuZGVyIGEgZ2l2ZW4gc3RhdGUgbmFtZS4gVGhlIHN0YXRlQ29uZmlnIG9iamVjdAogICAgICogaGFzIHRoZSBmb2xsb3dpbmcgYWNjZXB0YWJsZSBwcm9wZXJ0aWVzLgogICAgICoKICAgICAqIDxhIGlkPSd0ZW1wbGF0ZSc+PC9hPgogICAgICoKICAgICAqIC0gKipgdGVtcGxhdGVgKiogLSB7c3RyaW5nfGZ1bmN0aW9uPX0gLSBodG1sIHRlbXBsYXRlIGFzIGEgc3RyaW5nIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zCiAgICAgKiAgIGFuIGh0bWwgdGVtcGxhdGUgYXMgYSBzdHJpbmcgd2hpY2ggc2hvdWxkIGJlIHVzZWQgYnkgdGhlIHVpVmlldyBkaXJlY3RpdmVzLiBUaGlzIHByb3BlcnR5CiAgICAgKiAgIHRha2VzIHByZWNlZGVuY2Ugb3ZlciB0ZW1wbGF0ZVVybC4KICAgICAqCiAgICAgKiAgIElmIGB0ZW1wbGF0ZWAgaXMgYSBmdW5jdGlvbiwgaXQgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnM6CiAgICAgKgogICAgICogICAtIHthcnJheS4mbHQ7b2JqZWN0Jmd0O30gLSBzdGF0ZSBwYXJhbWV0ZXJzIGV4dHJhY3RlZCBmcm9tIHRoZSBjdXJyZW50ICRsb2NhdGlvbi5wYXRoKCkgYnkKICAgICAqICAgICBhcHBseWluZyB0aGUgY3VycmVudCBzdGF0ZQogICAgICoKICAgICAqIDxhIGlkPSd0ZW1wbGF0ZVVybCc+PC9hPgogICAgICoKICAgICAqIC0gKipgdGVtcGxhdGVVcmxgKiogLSB7c3RyaW5nfGZ1bmN0aW9uPX0gLSBwYXRoIG9yIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIHBhdGggdG8gYW4gaHRtbAogICAgICogICB0ZW1wbGF0ZSB0aGF0IHNob3VsZCBiZSB1c2VkIGJ5IHVpVmlldy4KICAgICAqCiAgICAgKiAgIElmIGB0ZW1wbGF0ZVVybGAgaXMgYSBmdW5jdGlvbiwgaXQgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnM6CiAgICAgKgogICAgICogICAtIHthcnJheS4mbHQ7b2JqZWN0Jmd0O30gLSBzdGF0ZSBwYXJhbWV0ZXJzIGV4dHJhY3RlZCBmcm9tIHRoZSBjdXJyZW50ICRsb2NhdGlvbi5wYXRoKCkgYnkKICAgICAqICAgICBhcHBseWluZyB0aGUgY3VycmVudCBzdGF0ZQogICAgICoKICAgICAqIDxhIGlkPSd0ZW1wbGF0ZVByb3ZpZGVyJz48L2E+CiAgICAgKgogICAgICogLSAqKmB0ZW1wbGF0ZVByb3ZpZGVyYCoqIC0ge2Z1bmN0aW9uPX0gLSBQcm92aWRlciBmdW5jdGlvbiB0aGF0IHJldHVybnMgSFRNTCBjb250ZW50CiAgICAgKiAgIHN0cmluZy4KICAgICAqCiAgICAgKiA8YSBpZD0nY29udHJvbGxlcic+PC9hPgogICAgICoKICAgICAqIC0gKipgY29udHJvbGxlcmAqKiAtIHtzdHJpbmd8ZnVuY3Rpb249fSAtICBDb250cm9sbGVyIGZuIHRoYXQgc2hvdWxkIGJlIGFzc29jaWF0ZWQgd2l0aCBuZXdseQogICAgICogICByZWxhdGVkIHNjb3BlIG9yIHRoZSBuYW1lIG9mIGEgcmVnaXN0ZXJlZCBjb250cm9sbGVyIGlmIHBhc3NlZCBhcyBhIHN0cmluZy4KICAgICAqCiAgICAgKiA8YSBpZD0nY29udHJvbGxlclByb3ZpZGVyJz48L2E+CiAgICAgKgogICAgICogLSAqKmBjb250cm9sbGVyUHJvdmlkZXJgKiogLSB7ZnVuY3Rpb249fSAtIEluamVjdGFibGUgcHJvdmlkZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zCiAgICAgKiAgIHRoZSBhY3R1YWwgY29udHJvbGxlciBvciBzdHJpbmcuCiAgICAgKgogICAgICogPGEgaWQ9J2NvbnRyb2xsZXJBcyc+PC9hPgogICAgICoKICAgICAqIC0gKipgY29udHJvbGxlckFzYCoqIOKAkyB7c3RyaW5nPX0g4oCTIEEgY29udHJvbGxlciBhbGlhcyBuYW1lLiBJZiBwcmVzZW50IHRoZSBjb250cm9sbGVyIHdpbGwgYmUKICAgICAqICAgcHVibGlzaGVkIHRvIHNjb3BlIHVuZGVyIHRoZSBjb250cm9sbGVyQXMgbmFtZS4KICAgICAqCiAgICAgKiA8YSBpZD0ncmVzb2x2ZSc+PC9hPgogICAgICoKICAgICAqIC0gKipgcmVzb2x2ZWAqKiAtIHtvYmplY3QuJmx0O3N0cmluZywgZnVuY3Rpb24mZ3Q7PX0gLSBBbiBvcHRpb25hbCBtYXAgb2YgZGVwZW5kZW5jaWVzIHdoaWNoCiAgICAgKiAgIHNob3VsZCBiZSBpbmplY3RlZCBpbnRvIHRoZSBjb250cm9sbGVyLiBJZiBhbnkgb2YgdGhlc2UgZGVwZW5kZW5jaWVzIGFyZSBwcm9taXNlcywKICAgICAqICAgdGhlIHJvdXRlciB3aWxsIHdhaXQgZm9yIHRoZW0gYWxsIHRvIGJlIHJlc29sdmVkIG9yIG9uZSB0byBiZSByZWplY3RlZCBiZWZvcmUgdGhlCiAgICAgKiAgIGNvbnRyb2xsZXIgaXMgaW5zdGFudGlhdGVkLiBJZiBhbGwgdGhlIHByb21pc2VzIGFyZSByZXNvbHZlZCBzdWNjZXNzZnVsbHksIHRoZSB2YWx1ZXMKICAgICAqICAgb2YgdGhlIHJlc29sdmVkIHByb21pc2VzIGFyZSBpbmplY3RlZCBhbmQgJHN0YXRlQ2hhbmdlU3VjY2VzcyBldmVudCBpcyBmaXJlZC4gSWYgYW55CiAgICAgKiAgIG9mIHRoZSBwcm9taXNlcyBhcmUgcmVqZWN0ZWQgdGhlICRzdGF0ZUNoYW5nZUVycm9yIGV2ZW50IGlzIGZpcmVkLiBUaGUgbWFwIG9iamVjdCBpczoKICAgICAqCiAgICAgKiAgIC0ga2V5IC0ge3N0cmluZ306IG5hbWUgb2YgZGVwZW5kZW5jeSB0byBiZSBpbmplY3RlZCBpbnRvIGNvbnRyb2xsZXIKICAgICAqICAgLSBmYWN0b3J5IC0ge3N0cmluZ3xmdW5jdGlvbn06IElmIHN0cmluZyB0aGVuIGl0IGlzIGFsaWFzIGZvciBzZXJ2aWNlLiBPdGhlcndpc2UgaWYgZnVuY3Rpb24sCiAgICAgKiAgICAgaXQgaXMgaW5qZWN0ZWQgYW5kIHJldHVybiB2YWx1ZSBpdCB0cmVhdGVkIGFzIGRlcGVuZGVuY3kuIElmIHJlc3VsdCBpcyBhIHByb21pc2UsIGl0IGlzCiAgICAgKiAgICAgcmVzb2x2ZWQgYmVmb3JlIGl0cyB2YWx1ZSBpcyBpbmplY3RlZCBpbnRvIGNvbnRyb2xsZXIuCiAgICAgKgogICAgICogPGEgaWQ9J3VybCc+PC9hPgogICAgICoKICAgICAqIC0gKipgdXJsYCoqIC0ge3N0cmluZz19IC0gQSB1cmwgd2l0aCBvcHRpb25hbCBwYXJhbWV0ZXJzLiBXaGVuIGEgc3RhdGUgaXMgbmF2aWdhdGVkIG9yCiAgICAgKiAgIHRyYW5zaXRpb25lZCB0bywgdGhlIGAkc3RhdGVQYXJhbXNgIHNlcnZpY2Ugd2lsbCBiZSBwb3B1bGF0ZWQgd2l0aCBhbnkKICAgICAqICAgcGFyYW1ldGVycyB0aGF0IHdlcmUgcGFzc2VkLgogICAgICoKICAgICAqIDxhIGlkPSdwYXJhbXMnPjwvYT4KICAgICAqCiAgICAgKiAtICoqYHBhcmFtc2AqKiAtIHtvYmplY3Q9fSAtIEFuIGFycmF5IG9mIHBhcmFtZXRlciBuYW1lcyBvciByZWd1bGFyIGV4cHJlc3Npb25zLiBPbmx5CiAgICAgKiAgIHVzZSB0aGlzIHdpdGhpbiBhIHN0YXRlIGlmIHlvdSBhcmUgbm90IHVzaW5nIHVybC4gT3RoZXJ3aXNlIHlvdSBjYW4gc3BlY2lmeSB5b3VyCiAgICAgKiAgIHBhcmFtZXRlcnMgd2l0aGluIHRoZSB1cmwuIFdoZW4gYSBzdGF0ZSBpcyBuYXZpZ2F0ZWQgb3IgdHJhbnNpdGlvbmVkIHRvLCB0aGUKICAgICAqICAgJHN0YXRlUGFyYW1zIHNlcnZpY2Ugd2lsbCBiZSBwb3B1bGF0ZWQgd2l0aCBhbnkgcGFyYW1ldGVycyB0aGF0IHdlcmUgcGFzc2VkLgogICAgICoKICAgICAqIDxhIGlkPSd2aWV3cyc+PC9hPgogICAgICoKICAgICAqIC0gKipgdmlld3NgKiogLSB7b2JqZWN0PX0gLSBVc2UgdGhlIHZpZXdzIHByb3BlcnR5IHRvIHNldCB1cCBtdWx0aXBsZSB2aWV3cyBvciB0byB0YXJnZXQgdmlld3MKICAgICAqICAgbWFudWFsbHkvZXhwbGljaXRseS4KICAgICAqCiAgICAgKiA8YSBpZD0nYWJzdHJhY3QnPjwvYT4KICAgICAqCiAgICAgKiAtICoqYGFic3RyYWN0YCoqIC0ge2Jvb2xlYW49fSAtIEFuIGFic3RyYWN0IHN0YXRlIHdpbGwgbmV2ZXIgYmUgZGlyZWN0bHkgYWN0aXZhdGVkLAogICAgICogICBidXQgY2FuIHByb3ZpZGUgaW5oZXJpdGVkIHByb3BlcnRpZXMgdG8gaXRzIGNvbW1vbiBjaGlsZHJlbiBzdGF0ZXMuCiAgICAgKgogICAgICogPGEgaWQ9J29uRW50ZXInPjwvYT4KICAgICAqCiAgICAgKiAtICoqYG9uRW50ZXJgKiogLSB7b2JqZWN0PX0gLSBDYWxsYmFjayBmdW5jdGlvbiBmb3Igd2hlbiBhIHN0YXRlIGlzIGVudGVyZWQuIEdvb2Qgd2F5CiAgICAgKiAgIHRvIHRyaWdnZXIgYW4gYWN0aW9uIG9yIGRpc3BhdGNoIGFuIGV2ZW50LCBzdWNoIGFzIG9wZW5pbmcgYSBkaWFsb2cuCiAgICAgKgogICAgICogPGEgaWQ9J29uRXhpdCc+PC9hPgogICAgICoKICAgICAqIC0gKipgb25FeGl0YCoqIC0ge29iamVjdD19IC0gQ2FsbGJhY2sgZnVuY3Rpb24gZm9yIHdoZW4gYSBzdGF0ZSBpcyBleGl0ZWQuIEdvb2Qgd2F5IHRvCiAgICAgKiAgIHRyaWdnZXIgYW4gYWN0aW9uIG9yIGRpc3BhdGNoIGFuIGV2ZW50LCBzdWNoIGFzIG9wZW5pbmcgYSBkaWFsb2cuCiAgICAgKgogICAgICogPGEgaWQ9J3JlbG9hZE9uU2VhcmNoJz48L2E+CiAgICAgKgogICAgICogLSAqKmByZWxvYWRPblNlYXJjaCA9IHRydWVgKiogLSB7Ym9vbGVhbj19IC0gSWYgYGZhbHNlYCwgd2lsbCBub3QgcmV0cmlnZ2VyIHRoZSBzYW1lIHN0YXRlCiAgICAgKiAgIGp1c3QgYmVjYXVzZSBhIHNlYXJjaC9xdWVyeSBwYXJhbWV0ZXIgaGFzIGNoYW5nZWQgKHZpYSAkbG9jYXRpb24uc2VhcmNoKCkgb3IgJGxvY2F0aW9uLmhhc2goKSkuCiAgICAgKiAgIFVzZWZ1bCBmb3Igd2hlbiB5b3UnZCBsaWtlIHRvIG1vZGlmeSAkbG9jYXRpb24uc2VhcmNoKCkgd2l0aG91dCB0cmlnZ2VyaW5nIGEgcmVsb2FkLgogICAgICoKICAgICAqIDxhIGlkPSdkYXRhJz48L2E+CiAgICAgKgogICAgICogLSAqKmBkYXRhYCoqIC0ge29iamVjdD19IC0gQXJiaXRyYXJ5IGRhdGEgb2JqZWN0LCB1c2VmdWwgZm9yIGN1c3RvbSBjb25maWd1cmF0aW9uLgogICAgICoKICAgICAqIEBleGFtcGxlCiAgICAgKiA8cHJlPgogICAgICogLy8gU29tZSBzdGF0ZSBuYW1lIGV4YW1wbGVzCiAgICAgKgogICAgICogLy8gc3RhdGVOYW1lIGNhbiBiZSBhIHNpbmdsZSB0b3AtbGV2ZWwgbmFtZSAobXVzdCBiZSB1bmlxdWUpLgogICAgICogJHN0YXRlUHJvdmlkZXIuc3RhdGUoImhvbWUiLCB7fSk7CiAgICAgKgogICAgICogLy8gT3IgaXQgY2FuIGJlIGEgbmVzdGVkIHN0YXRlIG5hbWUuIFRoaXMgc3RhdGUgaXMgYSBjaGlsZCBvZiB0aGUKICAgICAqIC8vIGFib3ZlICJob21lIiBzdGF0ZS4KICAgICAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCJob21lLm5ld2VzdCIsIHt9KTsKICAgICAqCiAgICAgKiAvLyBOZXN0IHN0YXRlcyBhcyBkZWVwbHkgYXMgbmVlZGVkLgogICAgICogJHN0YXRlUHJvdmlkZXIuc3RhdGUoImhvbWUubmV3ZXN0LmFiYy54eXouaW5jZXB0aW9uIiwge30pOwogICAgICoKICAgICAqIC8vIHN0YXRlKCkgcmV0dXJucyAkc3RhdGVQcm92aWRlciwgc28geW91IGNhbiBjaGFpbiBzdGF0ZSBkZWNsYXJhdGlvbnMuCiAgICAgKiAkc3RhdGVQcm92aWRlcgogICAgICogICAuc3RhdGUoImhvbWUiLCB7fSkKICAgICAqICAgLnN0YXRlKCJhYm91dCIsIHt9KQogICAgICogICAuc3RhdGUoImNvbnRhY3RzIiwge30pOwogICAgICogPC9wcmU+CiAgICAgKgogICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgQSB1bmlxdWUgc3RhdGUgbmFtZSwgZS5nLiAiaG9tZSIsICJhYm91dCIsICJjb250YWN0cyIuCiAgICAgKiBUbyBjcmVhdGUgYSBwYXJlbnQvY2hpbGQgc3RhdGUgdXNlIGEgZG90LCBlLmcuICJhYm91dC5zYWxlcyIsICJob21lLm5ld2VzdCIuCiAgICAgKiBAcGFyYW0ge29iamVjdH0gZGVmaW5pdGlvbiBTdGF0ZSBjb25maWd1cmF0aW9uIG9iamVjdC4KICAgICAqLwogICAgdGhpcy5zdGF0ZSA9IHN0YXRlOwogICAgZnVuY3Rpb24gc3RhdGUobmFtZSwgZGVmaW5pdGlvbikgewogICAgICAvKmpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KICAgICAgaWYgKGlzT2JqZWN0KG5hbWUpKSBkZWZpbml0aW9uID0gbmFtZTsKICAgICAgZWxzZSBkZWZpbml0aW9uLm5hbWUgPSBuYW1lOwogICAgICByZWdpc3RlclN0YXRlKGRlZmluaXRpb24pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAqCiAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICogQHJlcXVpcmVzICRxCiAgICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiR2aWV3CiAgICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnV0aWwuJHJlc29sdmUKICAgICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlUGFyYW1zCiAgICAgKgogICAgICogQHByb3BlcnR5IHtvYmplY3R9IHBhcmFtcyBBIHBhcmFtIG9iamVjdCwgZS5nLiB7c2VjdGlvbklkOiBzZWN0aW9uLmlkKX0sIHRoYXQKICAgICAqIHlvdSdkIGxpa2UgdG8gdGVzdCBhZ2FpbnN0IHRoZSBjdXJyZW50IGFjdGl2ZSBzdGF0ZS4KICAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBjdXJyZW50IEEgcmVmZXJlbmNlIHRvIHRoZSBzdGF0ZSdzIGNvbmZpZyBvYmplY3QuIEhvd2V2ZXIKICAgICAqIHlvdSBwYXNzZWQgaXQgaW4uIFVzZWZ1bCBmb3IgYWNjZXNzaW5nIGN1c3RvbSBkYXRhLgogICAgICogQHByb3BlcnR5IHtvYmplY3R9IHRyYW5zaXRpb24gQ3VycmVudGx5IHBlbmRpbmcgdHJhbnNpdGlvbi4gQSBwcm9taXNlIHRoYXQnbGwKICAgICAqIHJlc29sdmUgb3IgcmVqZWN0LgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogYCRzdGF0ZWAgc2VydmljZSBpcyByZXNwb25zaWJsZSBmb3IgcmVwcmVzZW50aW5nIHN0YXRlcyBhcyB3ZWxsIGFzIHRyYW5zaXRpb25pbmcKICAgICAqIGJldHdlZW4gdGhlbS4gSXQgYWxzbyBwcm92aWRlcyBpbnRlcmZhY2VzIHRvIGFzayBmb3IgY3VycmVudCBzdGF0ZSBvciBldmVuIHN0YXRlcwogICAgICogeW91J3JlIGNvbWluZyBmcm9tLgogICAgICovCiAgICAgIC8vICR1cmxSb3V0ZXIgaXMgaW5qZWN0ZWQganVzdCB0byBlbnN1cmUgaXQgZ2V0cyBpbnN0YW50aWF0ZWQKICAgIHRoaXMuJGdldCA9ICRnZXQ7CiAgICAkZ2V0LiRpbmplY3QgPSBbJyRyb290U2NvcGUnLCAnJHEnLCAnJHZpZXcnLCAnJGluamVjdG9yJywgJyRyZXNvbHZlJywgJyRzdGF0ZVBhcmFtcycsICckbG9jYXRpb24nLCAnJHVybFJvdXRlcicsICckYnJvd3NlciddOwogICAgZnVuY3Rpb24gJGdldCggICAkcm9vdFNjb3BlLCAgICRxLCAgICR2aWV3LCAgICRpbmplY3RvciwgICAkcmVzb2x2ZSwgICAkc3RhdGVQYXJhbXMsICAgJGxvY2F0aW9uLCAgICR1cmxSb3V0ZXIsICAgJGJyb3dzZXIpIHsKCiAgICAgIHZhciBUcmFuc2l0aW9uU3VwZXJzZWRlZCA9ICRxLnJlamVjdChuZXcgRXJyb3IoJ3RyYW5zaXRpb24gc3VwZXJzZWRlZCcpKTsKICAgICAgdmFyIFRyYW5zaXRpb25QcmV2ZW50ZWQgPSAkcS5yZWplY3QobmV3IEVycm9yKCd0cmFuc2l0aW9uIHByZXZlbnRlZCcpKTsKICAgICAgdmFyIFRyYW5zaXRpb25BYm9ydGVkID0gJHEucmVqZWN0KG5ldyBFcnJvcigndHJhbnNpdGlvbiBhYm9ydGVkJykpOwogICAgICB2YXIgVHJhbnNpdGlvbkZhaWxlZCA9ICRxLnJlamVjdChuZXcgRXJyb3IoJ3RyYW5zaXRpb24gZmFpbGVkJykpOwogICAgICB2YXIgY3VycmVudExvY2F0aW9uID0gJGxvY2F0aW9uLnVybCgpOwogICAgICB2YXIgYmFzZUhyZWYgPSAkYnJvd3Nlci5iYXNlSHJlZigpOwoKICAgICAgZnVuY3Rpb24gc3luY1VybCgpIHsKICAgICAgICBpZiAoJGxvY2F0aW9uLnVybCgpICE9PSBjdXJyZW50TG9jYXRpb24pIHsKICAgICAgICAgICRsb2NhdGlvbi51cmwoY3VycmVudExvY2F0aW9uKTsKICAgICAgICAgICRsb2NhdGlvbi5yZXBsYWNlKCk7CiAgICAgICAgfQogICAgICB9CgogICAgICByb290LmxvY2FscyA9IHsgcmVzb2x2ZTogbnVsbCwgZ2xvYmFsczogeyAkc3RhdGVQYXJhbXM6IHt9IH0gfTsKICAgICAgJHN0YXRlID0gewogICAgICAgIHBhcmFtczoge30sCiAgICAgICAgY3VycmVudDogcm9vdC5zZWxmLAogICAgICAgICRjdXJyZW50OiByb290LAogICAgICAgIHRyYW5zaXRpb246IG51bGwKICAgICAgfTsKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNyZWxvYWQKICAgICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEEgbWV0aG9kIHRoYXQgZm9yY2UgcmVsb2FkcyB0aGUgY3VycmVudCBzdGF0ZS4gQWxsIHJlc29sdmVzIGFyZSByZS1yZXNvbHZlZCwgZXZlbnRzIGFyZSBub3QgcmUtZmlyZWQsCiAgICAgICAqIGFuZCBjb250cm9sbGVycyByZWluc3RhbnRpYXRlZCAoYnVnIHdpdGggY29udHJvbGxlcnMgcmVpbnN0YW50aWF0aW5nIHJpZ2h0IG5vdywgZml4aW5nIHNvb24pLgogICAgICAgKgogICAgICAgKiBAZXhhbXBsZQogICAgICAgKiA8cHJlPgogICAgICAgKiB2YXIgYXBwIGFuZ3VsYXIubW9kdWxlKCdhcHAnLCBbJ3VpLnJvdXRlciddKTsKICAgICAgICoKICAgICAgICogYXBwLmNvbnRyb2xsZXIoJ2N0cmwnLCBmdW5jdGlvbiAoJHNjb3BlLCAkc3RhdGUpIHsKICAgICAqICAgJHNjb3BlLnJlbG9hZCA9IGZ1bmN0aW9uKCl7CiAgICAgKiAgICAgJHN0YXRlLnJlbG9hZCgpOwogICAgICogICB9CiAgICAgKiB9KTsKICAgICAgICogPC9wcmU+CiAgICAgICAqCiAgICAgICAqIGByZWxvYWQoKWAgaXMganVzdCBhbiBhbGlhcyBmb3I6CiAgICAgICAqIDxwcmU+CiAgICAgICAqICRzdGF0ZS50cmFuc2l0aW9uVG8oJHN0YXRlLmN1cnJlbnQsICRzdGF0ZVBhcmFtcywgeyAKICAgICAqICAgcmVsb2FkOiB0cnVlLCBpbmhlcml0OiBmYWxzZSwgbm90aWZ5OiBmYWxzZSAKICAgICAqIH0pOwogICAgICAgKiA8L3ByZT4KICAgICAgICovCiAgICAgICRzdGF0ZS5yZWxvYWQgPSBmdW5jdGlvbiByZWxvYWQoKSB7CiAgICAgICAgJHN0YXRlLnRyYW5zaXRpb25Ubygkc3RhdGUuY3VycmVudCwgJHN0YXRlUGFyYW1zLCB7IHJlbG9hZDogdHJ1ZSwgaW5oZXJpdDogZmFsc2UsIG5vdGlmeTogZmFsc2UgfSk7CiAgICAgIH07CgogICAgICAvKioKICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjZ28KICAgICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIENvbnZlbmllbmNlIG1ldGhvZCBmb3IgdHJhbnNpdGlvbmluZyB0byBhIG5ldyBzdGF0ZS4gYCRzdGF0ZS5nb2AgY2FsbHMKICAgICAgICogYCRzdGF0ZS50cmFuc2l0aW9uVG9gIGludGVybmFsbHkgYnV0IGF1dG9tYXRpY2FsbHkgc2V0cyBvcHRpb25zIHRvCiAgICAgICAqIGB7IGxvY2F0aW9uOiB0cnVlLCBpbmhlcml0OiB0cnVlLCByZWxhdGl2ZTogJHN0YXRlLiRjdXJyZW50LCBub3RpZnk6IHRydWUgfWAuCiAgICAgICAqIFRoaXMgYWxsb3dzIHlvdSB0byBlYXNpbHkgdXNlIGFuIGFic29sdXRlIG9yIHJlbGF0aXZlIHRvIHBhdGggYW5kIHNwZWNpZnkKICAgICAgICogb25seSB0aGUgcGFyYW1ldGVycyB5b3UnZCBsaWtlIHRvIHVwZGF0ZSAod2hpbGUgbGV0dGluZyB1bnNwZWNpZmllZCBwYXJhbWV0ZXJzCiAgICAgICAqIGluaGVyaXQgZnJvbSB0aGUgY3VycmVudGx5IGFjdGl2ZSBhbmNlc3RvciBzdGF0ZXMpLgogICAgICAgKgogICAgICAgKiBAZXhhbXBsZQogICAgICAgKiA8cHJlPgogICAgICAgKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsndWkucm91dGVyJ10pOwogICAgICAgKgogICAgICAgKiBhcHAuY29udHJvbGxlcignY3RybCcsIGZ1bmN0aW9uICgkc2NvcGUsICRzdGF0ZSkgewogICAgICogICAkc2NvcGUuY2hhbmdlU3RhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgKiAgICAgJHN0YXRlLmdvKCdjb250YWN0LmRldGFpbCcpOwogICAgICogICB9OwogICAgICogfSk7CiAgICAgICAqIDwvcHJlPgogICAgICAgKiA8aW1nIHNyYz0nLi4vbmdkb2NfYXNzZXRzL1N0YXRlR29FeGFtcGxlcy5wbmcnLz4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRvIEFic29sdXRlIHN0YXRlIG5hbWUgb3IgcmVsYXRpdmUgc3RhdGUgcGF0aC4gU29tZSBleGFtcGxlczoKICAgICAgICoKICAgICAgICogLSBgJHN0YXRlLmdvKCdjb250YWN0LmRldGFpbCcpYCAtIHdpbGwgZ28gdG8gdGhlIGBjb250YWN0LmRldGFpbGAgc3RhdGUKICAgICAgICogLSBgJHN0YXRlLmdvKCdeJylgIC0gd2lsbCBnbyB0byBhIHBhcmVudCBzdGF0ZQogICAgICAgKiAtIGAkc3RhdGUuZ28oJ14uc2libGluZycpYCAtIHdpbGwgZ28gdG8gYSBzaWJsaW5nIHN0YXRlCiAgICAgICAqIC0gYCRzdGF0ZS5nbygnLmNoaWxkLmdyYW5kY2hpbGQnKWAgLSB3aWxsIGdvIHRvIGdyYW5kY2hpbGQgc3RhdGUKICAgICAgICoKICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSBwYXJhbXMgQSBtYXAgb2YgdGhlIHBhcmFtZXRlcnMgdGhhdCB3aWxsIGJlIHNlbnQgdG8gdGhlIHN0YXRlLAogICAgICAgKiB3aWxsIHBvcHVsYXRlICRzdGF0ZVBhcmFtcy4gQW55IHBhcmFtZXRlcnMgdGhhdCBhcmUgbm90IHNwZWNpZmllZCB3aWxsIGJlIGluaGVyaXRlZCBmcm9tIGN1cnJlbnRseQogICAgICAgKiBkZWZpbmVkIHBhcmFtZXRlcnMuIFRoaXMgYWxsb3dzLCBmb3IgZXhhbXBsZSwgZ29pbmcgdG8gYSBzaWJsaW5nIHN0YXRlIHRoYXQgc2hhcmVzIHBhcmFtZXRlcnMKICAgICAgICogc3BlY2lmaWVkIGluIGEgcGFyZW50IHN0YXRlLiBQYXJhbWV0ZXIgaW5oZXJpdGFuY2Ugb25seSB3b3JrcyBiZXR3ZWVuIGNvbW1vbiBhbmNlc3RvciBzdGF0ZXMsIEkuZS4KICAgICAgICogdHJhbnNpdGlvbmluZyB0byBhIHNpYmxpbmcgd2lsbCBnZXQgeW91IHRoZSBwYXJhbWV0ZXJzIGZvciBhbGwgcGFyZW50cywgdHJhbnNpdGlvbmluZyB0byBhIGNoaWxkCiAgICAgICAqIHdpbGwgZ2V0IHlvdSBhbGwgY3VycmVudCBwYXJhbWV0ZXJzLCBldGMuCiAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gb3B0aW9ucyBPcHRpb25zIG9iamVjdC4gVGhlIG9wdGlvbnMgYXJlOgogICAgICAgKgogICAgICAgKiAtICoqYGxvY2F0aW9uYCoqIC0ge2Jvb2xlYW49dHJ1ZXxzdHJpbmc9fSAtIElmIGB0cnVlYCB3aWxsIHVwZGF0ZSB0aGUgdXJsIGluIHRoZSBsb2NhdGlvbiBiYXIsIGlmIGBmYWxzZWAKICAgICAgICogICAgd2lsbCBub3QuIElmIHN0cmluZywgbXVzdCBiZSBgInJlcGxhY2UiYCwgd2hpY2ggd2lsbCB1cGRhdGUgdXJsIGFuZCBhbHNvIHJlcGxhY2UgbGFzdCBoaXN0b3J5IHJlY29yZC4KICAgICAgICogLSAqKmBpbmhlcml0YCoqIC0ge2Jvb2xlYW49dHJ1ZX0sIElmIGB0cnVlYCB3aWxsIGluaGVyaXQgdXJsIHBhcmFtZXRlcnMgZnJvbSBjdXJyZW50IHVybC4KICAgICAgICogLSAqKmByZWxhdGl2ZWAqKiAtIHtvYmplY3Q9JHN0YXRlLiRjdXJyZW50fSwgV2hlbiB0cmFuc2l0aW9uaW5nIHdpdGggcmVsYXRpdmUgcGF0aCAoZS5nICdeJyksCiAgICAgICAqICAgIGRlZmluZXMgd2hpY2ggc3RhdGUgdG8gYmUgcmVsYXRpdmUgZnJvbS4KICAgICAgICogLSAqKmBub3RpZnlgKiogLSB7Ym9vbGVhbj10cnVlfSwgSWYgYHRydWVgIHdpbGwgYnJvYWRjYXN0ICRzdGF0ZUNoYW5nZVN0YXJ0IGFuZCAkc3RhdGVDaGFuZ2VTdWNjZXNzIGV2ZW50cy4KICAgICAgICogLSAqKmByZWxvYWRgKiogKHYwLjIuNSkgLSB7Ym9vbGVhbj1mYWxzZX0sIElmIGB0cnVlYCB3aWxsIGZvcmNlIHRyYW5zaXRpb24gZXZlbiBpZiB0aGUgc3RhdGUgb3IgcGFyYW1zCiAgICAgICAqICAgIGhhdmUgbm90IGNoYW5nZWQsIGFrYSBhIHJlbG9hZCBvZiB0aGUgc2FtZSBzdGF0ZS4gSXQgZGlmZmVycyBmcm9tIHJlbG9hZE9uU2VhcmNoIGJlY2F1c2UgeW91J2QKICAgICAgICogICAgdXNlIHRoaXMgd2hlbiB5b3Ugd2FudCB0byBmb3JjZSBhIHJlbG9hZCB3aGVuICpldmVyeXRoaW5nKiBpcyB0aGUgc2FtZSwgaW5jbHVkaW5nIHNlYXJjaCBwYXJhbXMuCiAgICAgICAqCiAgICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2UgcmVwcmVzZW50aW5nIHRoZSBzdGF0ZSBvZiB0aGUgbmV3IHRyYW5zaXRpb24uCiAgICAgICAqCiAgICAgICAqIFBvc3NpYmxlIHN1Y2Nlc3MgdmFsdWVzOgogICAgICAgKgogICAgICAgKiAtICRzdGF0ZS5jdXJyZW50CiAgICAgICAqCiAgICAgICAqIDxici8+UG9zc2libGUgcmVqZWN0aW9uIHZhbHVlczoKICAgICAgICoKICAgICAgICogLSAndHJhbnNpdGlvbiBzdXBlcnNlZGVkJyAtIHdoZW4gYSBuZXdlciB0cmFuc2l0aW9uIGhhcyBiZWVuIHN0YXJ0ZWQgYWZ0ZXIgdGhpcyBvbmUKICAgICAgICogLSAndHJhbnNpdGlvbiBwcmV2ZW50ZWQnIC0gd2hlbiBgZXZlbnQucHJldmVudERlZmF1bHQoKWAgaGFzIGJlZW4gY2FsbGVkIGluIGEgYCRzdGF0ZUNoYW5nZVN0YXJ0YCBsaXN0ZW5lcgogICAgICAgKiAtICd0cmFuc2l0aW9uIGFib3J0ZWQnIC0gd2hlbiBgZXZlbnQucHJldmVudERlZmF1bHQoKWAgaGFzIGJlZW4gY2FsbGVkIGluIGEgYCRzdGF0ZU5vdEZvdW5kYCBsaXN0ZW5lciBvcgogICAgICAgKiAgIHdoZW4gYSBgJHN0YXRlTm90Rm91bmRgIGBldmVudC5yZXRyeWAgcHJvbWlzZSBlcnJvcnMuCiAgICAgICAqIC0gJ3RyYW5zaXRpb24gZmFpbGVkJyAtIHdoZW4gYSBzdGF0ZSBoYXMgYmVlbiB1bnN1Y2Nlc3NmdWxseSBmb3VuZCBhZnRlciAyIHRyaWVzLgogICAgICAgKiAtICpyZXNvbHZlIGVycm9yKiAtIHdoZW4gYW4gZXJyb3IgaGFzIG9jY3VycmVkIHdpdGggYSBgcmVzb2x2ZWAKICAgICAgICoKICAgICAgICovCiAgICAgICRzdGF0ZS5nbyA9IGZ1bmN0aW9uIGdvKHRvLCBwYXJhbXMsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gdGhpcy50cmFuc2l0aW9uVG8odG8sIHBhcmFtcywgZXh0ZW5kKHsgaW5oZXJpdDogdHJ1ZSwgcmVsYXRpdmU6ICRzdGF0ZS4kY3VycmVudCB9LCBvcHRpb25zKSk7CiAgICAgIH07CgogICAgICAvKioKICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjdHJhbnNpdGlvblRvCiAgICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBMb3ctbGV2ZWwgbWV0aG9kIGZvciB0cmFuc2l0aW9uaW5nIHRvIGEgbmV3IHN0YXRlLiB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNtZXRob2RzX2dvICRzdGF0ZS5nb30KICAgICAgICogdXNlcyBgdHJhbnNpdGlvblRvYCBpbnRlcm5hbGx5LiBgJHN0YXRlLmdvYCBpcyByZWNvbW1lbmRlZCBpbiBtb3N0IHNpdHVhdGlvbnMuCiAgICAgICAqCiAgICAgICAqIEBleGFtcGxlCiAgICAgICAqIDxwcmU+CiAgICAgICAqIHZhciBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnYXBwJywgWyd1aS5yb3V0ZXInXSk7CiAgICAgICAqCiAgICAgICAqIGFwcC5jb250cm9sbGVyKCdjdHJsJywgZnVuY3Rpb24gKCRzY29wZSwgJHN0YXRlKSB7CiAgICAgKiAgICRzY29wZS5jaGFuZ2VTdGF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAqICAgICAkc3RhdGUudHJhbnNpdGlvblRvKCdjb250YWN0LmRldGFpbCcpOwogICAgICogICB9OwogICAgICogfSk7CiAgICAgICAqIDwvcHJlPgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdG8gU3RhdGUgbmFtZS4KICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSB0b1BhcmFtcyBBIG1hcCBvZiB0aGUgcGFyYW1ldGVycyB0aGF0IHdpbGwgYmUgc2VudCB0byB0aGUgc3RhdGUsCiAgICAgICAqIHdpbGwgcG9wdWxhdGUgJHN0YXRlUGFyYW1zLgogICAgICAgKiBAcGFyYW0ge29iamVjdD19IG9wdGlvbnMgT3B0aW9ucyBvYmplY3QuIFRoZSBvcHRpb25zIGFyZToKICAgICAgICoKICAgICAgICogLSAqKmBsb2NhdGlvbmAqKiAtIHtib29sZWFuPXRydWV8c3RyaW5nPX0gLSBJZiBgdHJ1ZWAgd2lsbCB1cGRhdGUgdGhlIHVybCBpbiB0aGUgbG9jYXRpb24gYmFyLCBpZiBgZmFsc2VgCiAgICAgICAqICAgIHdpbGwgbm90LiBJZiBzdHJpbmcsIG11c3QgYmUgYCJyZXBsYWNlImAsIHdoaWNoIHdpbGwgdXBkYXRlIHVybCBhbmQgYWxzbyByZXBsYWNlIGxhc3QgaGlzdG9yeSByZWNvcmQuCiAgICAgICAqIC0gKipgaW5oZXJpdGAqKiAtIHtib29sZWFuPWZhbHNlfSwgSWYgYHRydWVgIHdpbGwgaW5oZXJpdCB1cmwgcGFyYW1ldGVycyBmcm9tIGN1cnJlbnQgdXJsLgogICAgICAgKiAtICoqYHJlbGF0aXZlYCoqIC0ge29iamVjdD19LCBXaGVuIHRyYW5zaXRpb25pbmcgd2l0aCByZWxhdGl2ZSBwYXRoIChlLmcgJ14nKSwKICAgICAgICogICAgZGVmaW5lcyB3aGljaCBzdGF0ZSB0byBiZSByZWxhdGl2ZSBmcm9tLgogICAgICAgKiAtICoqYG5vdGlmeWAqKiAtIHtib29sZWFuPXRydWV9LCBJZiBgdHJ1ZWAgd2lsbCBicm9hZGNhc3QgJHN0YXRlQ2hhbmdlU3RhcnQgYW5kICRzdGF0ZUNoYW5nZVN1Y2Nlc3MgZXZlbnRzLgogICAgICAgKiAtICoqYHJlbG9hZGAqKiAodjAuMi41KSAtIHtib29sZWFuPWZhbHNlfSwgSWYgYHRydWVgIHdpbGwgZm9yY2UgdHJhbnNpdGlvbiBldmVuIGlmIHRoZSBzdGF0ZSBvciBwYXJhbXMKICAgICAgICogICAgaGF2ZSBub3QgY2hhbmdlZCwgYWthIGEgcmVsb2FkIG9mIHRoZSBzYW1lIHN0YXRlLiBJdCBkaWZmZXJzIGZyb20gcmVsb2FkT25TZWFyY2ggYmVjYXVzZSB5b3UnZAogICAgICAgKiAgICB1c2UgdGhpcyB3aGVuIHlvdSB3YW50IHRvIGZvcmNlIGEgcmVsb2FkIHdoZW4gKmV2ZXJ5dGhpbmcqIGlzIHRoZSBzYW1lLCBpbmNsdWRpbmcgc2VhcmNoIHBhcmFtcy4KICAgICAgICoKICAgICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSByZXByZXNlbnRpbmcgdGhlIHN0YXRlIG9mIHRoZSBuZXcgdHJhbnNpdGlvbi4gU2VlCiAgICAgICAqIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI21ldGhvZHNfZ28gJHN0YXRlLmdvfS4KICAgICAgICovCiAgICAgICRzdGF0ZS50cmFuc2l0aW9uVG8gPSBmdW5jdGlvbiB0cmFuc2l0aW9uVG8odG8sIHRvUGFyYW1zLCBvcHRpb25zKSB7CiAgICAgICAgdG9QYXJhbXMgPSB0b1BhcmFtcyB8fCB7fTsKICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHsKICAgICAgICAgIGxvY2F0aW9uOiB0cnVlLCBpbmhlcml0OiBmYWxzZSwgcmVsYXRpdmU6IG51bGwsIG5vdGlmeTogdHJ1ZSwgcmVsb2FkOiBmYWxzZSwgJHJldHJ5OiBmYWxzZQogICAgICAgIH0sIG9wdGlvbnMgfHwge30pOwoKICAgICAgICB2YXIgZnJvbSA9ICRzdGF0ZS4kY3VycmVudCwgZnJvbVBhcmFtcyA9ICRzdGF0ZS5wYXJhbXMsIGZyb21QYXRoID0gZnJvbS5wYXRoOwogICAgICAgIHZhciBldnQsIHRvU3RhdGUgPSBmaW5kU3RhdGUodG8sIG9wdGlvbnMucmVsYXRpdmUpOwoKICAgICAgICBpZiAoIWlzRGVmaW5lZCh0b1N0YXRlKSkgewogICAgICAgICAgLy8gQnJvYWRjYXN0IG5vdCBmb3VuZCBldmVudCBhbmQgYWJvcnQgdGhlIHRyYW5zaXRpb24gaWYgcHJldmVudGVkCiAgICAgICAgICB2YXIgcmVkaXJlY3QgPSB7IHRvOiB0bywgdG9QYXJhbXM6IHRvUGFyYW1zLCBvcHRpb25zOiBvcHRpb25zIH07CgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjJHN0YXRlTm90Rm91bmQKICAgICAgICAgICAqIEBldmVudE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAgICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogRmlyZWQgd2hlbiBhIHJlcXVlc3RlZCBzdGF0ZSAqKmNhbm5vdCBiZSBmb3VuZCoqIHVzaW5nIHRoZSBwcm92aWRlZCBzdGF0ZSBuYW1lIGR1cmluZyB0cmFuc2l0aW9uLgogICAgICAgICAgICogVGhlIGV2ZW50IGlzIGJyb2FkY2FzdCBhbGxvd2luZyBhbnkgaGFuZGxlcnMgYSBzaW5nbGUgY2hhbmNlIHRvIGRlYWwgd2l0aCB0aGUgZXJyb3IgKHVzdWFsbHkgYnkKICAgICAgICAgICAqIGxhenktbG9hZGluZyB0aGUgdW5mb3VuZCBzdGF0ZSkuIEEgc3BlY2lhbCBgdW5mb3VuZFN0YXRlYCBvYmplY3QgaXMgcGFzc2VkIHRvIHRoZSBsaXN0ZW5lciBoYW5kbGVyLAogICAgICAgICAgICogeW91IGNhbiBzZWUgaXRzIHRocmVlIHByb3BlcnRpZXMgaW4gdGhlIGV4YW1wbGUuIFlvdSBjYW4gdXNlIGBldmVudC5wcmV2ZW50RGVmYXVsdCgpYCB0byBhYm9ydCB0aGUKICAgICAgICAgICAqIHRyYW5zaXRpb24gYW5kIHRoZSBwcm9taXNlIHJldHVybmVkIGZyb20gYGdvYCB3aWxsIGJlIHJlamVjdGVkIHdpdGggYSBgJ3RyYW5zaXRpb24gYWJvcnRlZCdgIHZhbHVlLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBFdmVudCBvYmplY3QuCiAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdW5mb3VuZFN0YXRlIFVuZm91bmQgU3RhdGUgaW5mb3JtYXRpb24uIENvbnRhaW5zOiBgdG8sIHRvUGFyYW1zLCBvcHRpb25zYCBwcm9wZXJ0aWVzLgogICAgICAgICAgICogQHBhcmFtIHtTdGF0ZX0gZnJvbVN0YXRlIEN1cnJlbnQgc3RhdGUgb2JqZWN0LgogICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGZyb21QYXJhbXMgQ3VycmVudCBzdGF0ZSBwYXJhbXMuCiAgICAgICAgICAgKgogICAgICAgICAgICogQGV4YW1wbGUKICAgICAgICAgICAqCiAgICAgICAgICAgKiA8cHJlPgogICAgICAgICAgICogLy8gc29tZXdoZXJlLCBhc3N1bWUgbGF6eS5zdGF0ZSBoYXMgbm90IGJlZW4gZGVmaW5lZAogICAgICAgICAgICogJHN0YXRlLmdvKCJsYXp5LnN0YXRlIiwge2E6MSwgYjoyfSwge2luaGVyaXQ6ZmFsc2V9KTsKICAgICAgICAgICAqCiAgICAgICAgICAgKiAvLyBzb21ld2hlcmUgZWxzZQogICAgICAgICAgICogJHNjb3BlLiRvbignJHN0YXRlTm90Rm91bmQnLAogICAgICAgICAgICogZnVuY3Rpb24oZXZlbnQsIHVuZm91bmRTdGF0ZSwgZnJvbVN0YXRlLCBmcm9tUGFyYW1zKXsKICAgICAgICAgKiAgICAgY29uc29sZS5sb2codW5mb3VuZFN0YXRlLnRvKTsgLy8gImxhenkuc3RhdGUiCiAgICAgICAgICogICAgIGNvbnNvbGUubG9nKHVuZm91bmRTdGF0ZS50b1BhcmFtcyk7IC8vIHthOjEsIGI6Mn0KICAgICAgICAgKiAgICAgY29uc29sZS5sb2codW5mb3VuZFN0YXRlLm9wdGlvbnMpOyAvLyB7aW5oZXJpdDpmYWxzZX0gKyBkZWZhdWx0IG9wdGlvbnMKICAgICAgICAgKiB9KQogICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgKi8KICAgICAgICAgIGV2dCA9ICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHN0YXRlTm90Rm91bmQnLCByZWRpcmVjdCwgZnJvbS5zZWxmLCBmcm9tUGFyYW1zKTsKICAgICAgICAgIGlmIChldnQuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICBzeW5jVXJsKCk7CiAgICAgICAgICAgIHJldHVybiBUcmFuc2l0aW9uQWJvcnRlZDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBBbGxvdyB0aGUgaGFuZGxlciB0byByZXR1cm4gYSBwcm9taXNlIHRvIGRlZmVyIHN0YXRlIGxvb2t1cCByZXRyeQogICAgICAgICAgaWYgKGV2dC5yZXRyeSkgewogICAgICAgICAgICBpZiAob3B0aW9ucy4kcmV0cnkpIHsKICAgICAgICAgICAgICBzeW5jVXJsKCk7CiAgICAgICAgICAgICAgcmV0dXJuIFRyYW5zaXRpb25GYWlsZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJldHJ5VHJhbnNpdGlvbiA9ICRzdGF0ZS50cmFuc2l0aW9uID0gJHEud2hlbihldnQucmV0cnkpOwogICAgICAgICAgICByZXRyeVRyYW5zaXRpb24udGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAocmV0cnlUcmFuc2l0aW9uICE9PSAkc3RhdGUudHJhbnNpdGlvbikgcmV0dXJuIFRyYW5zaXRpb25TdXBlcnNlZGVkOwogICAgICAgICAgICAgIHJlZGlyZWN0Lm9wdGlvbnMuJHJldHJ5ID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gJHN0YXRlLnRyYW5zaXRpb25UbyhyZWRpcmVjdC50bywgcmVkaXJlY3QudG9QYXJhbXMsIHJlZGlyZWN0Lm9wdGlvbnMpOwogICAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gVHJhbnNpdGlvbkFib3J0ZWQ7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzeW5jVXJsKCk7CiAgICAgICAgICAgIHJldHVybiByZXRyeVRyYW5zaXRpb247CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQWx3YXlzIHJldHJ5IG9uY2UgaWYgdGhlICRzdGF0ZU5vdEZvdW5kIHdhcyBub3QgcHJldmVudGVkCiAgICAgICAgICAvLyAoaGFuZGxlcyBlaXRoZXIgcmVkaXJlY3QgY2hhbmdlZCBvciBzdGF0ZSBsYXp5LWRlZmluaXRpb24pCiAgICAgICAgICB0byA9IHJlZGlyZWN0LnRvOwogICAgICAgICAgdG9QYXJhbXMgPSByZWRpcmVjdC50b1BhcmFtczsKICAgICAgICAgIG9wdGlvbnMgPSByZWRpcmVjdC5vcHRpb25zOwogICAgICAgICAgdG9TdGF0ZSA9IGZpbmRTdGF0ZSh0bywgb3B0aW9ucy5yZWxhdGl2ZSk7CiAgICAgICAgICBpZiAoIWlzRGVmaW5lZCh0b1N0YXRlKSkgewogICAgICAgICAgICBpZiAob3B0aW9ucy5yZWxhdGl2ZSkgdGhyb3cgbmV3IEVycm9yKCJDb3VsZCBub3QgcmVzb2x2ZSAnIiArIHRvICsgIicgZnJvbSBzdGF0ZSAnIiArIG9wdGlvbnMucmVsYXRpdmUgKyAiJyIpOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vIHN1Y2ggc3RhdGUgJyIgKyB0byArICInIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICh0b1N0YXRlW2Fic3RyYWN0S2V5XSkgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgdHJhbnNpdGlvbiB0byBhYnN0cmFjdCBzdGF0ZSAnIiArIHRvICsgIiciKTsKICAgICAgICBpZiAob3B0aW9ucy5pbmhlcml0KSB0b1BhcmFtcyA9IGluaGVyaXRQYXJhbXMoJHN0YXRlUGFyYW1zLCB0b1BhcmFtcyB8fCB7fSwgJHN0YXRlLiRjdXJyZW50LCB0b1N0YXRlKTsKICAgICAgICB0byA9IHRvU3RhdGU7CgogICAgICAgIHZhciB0b1BhdGggPSB0by5wYXRoOwoKICAgICAgICAvLyBTdGFydGluZyBmcm9tIHRoZSByb290IG9mIHRoZSBwYXRoLCBrZWVwIGFsbCBsZXZlbHMgdGhhdCBoYXZlbid0IGNoYW5nZWQKICAgICAgICB2YXIga2VlcCwgc3RhdGUsIGxvY2FscyA9IHJvb3QubG9jYWxzLCB0b0xvY2FscyA9IFtdOwogICAgICAgIGZvciAoa2VlcCA9IDAsIHN0YXRlID0gdG9QYXRoW2tlZXBdOwogICAgICAgICAgICAgc3RhdGUgJiYgc3RhdGUgPT09IGZyb21QYXRoW2tlZXBdICYmIGVxdWFsRm9yS2V5cyh0b1BhcmFtcywgZnJvbVBhcmFtcywgc3RhdGUub3duUGFyYW1zKSAmJiAhb3B0aW9ucy5yZWxvYWQ7CiAgICAgICAgICAgICBrZWVwKyssIHN0YXRlID0gdG9QYXRoW2tlZXBdKSB7CiAgICAgICAgICBsb2NhbHMgPSB0b0xvY2Fsc1trZWVwXSA9IHN0YXRlLmxvY2FsczsKICAgICAgICB9CgogICAgICAgIC8vIElmIHdlJ3JlIGdvaW5nIHRvIHRoZSBzYW1lIHN0YXRlIGFuZCBhbGwgbG9jYWxzIGFyZSBrZXB0LCB3ZSd2ZSBnb3Qgbm90aGluZyB0byBkby4KICAgICAgICAvLyBCdXQgY2xlYXIgJ3RyYW5zaXRpb24nLCBhcyB3ZSBzdGlsbCB3YW50IHRvIGNhbmNlbCBhbnkgb3RoZXIgcGVuZGluZyB0cmFuc2l0aW9ucy4KICAgICAgICAvLyBUT0RPOiBXZSBtYXkgbm90IHdhbnQgdG8gYnVtcCAndHJhbnNpdGlvbicgaWYgd2UncmUgY2FsbGVkIGZyb20gYSBsb2NhdGlvbiBjaGFuZ2UgdGhhdCB3ZSd2ZSBpbml0aWF0ZWQgb3Vyc2VsdmVzLAogICAgICAgIC8vIGJlY2F1c2Ugd2UgbWlnaHQgYWNjaWRlbnRhbGx5IGFib3J0IGEgbGVnaXRpbWF0ZSB0cmFuc2l0aW9uIGluaXRpYXRlZCBmcm9tIGNvZGU/CiAgICAgICAgaWYgKHNob3VsZFRyaWdnZXJSZWxvYWQodG8sIGZyb20sIGxvY2Fscywgb3B0aW9ucykgKSB7CiAgICAgICAgICBpZiAoIHRvLnNlbGYucmVsb2FkT25TZWFyY2ggIT09IGZhbHNlICkKICAgICAgICAgICAgc3luY1VybCgpOwogICAgICAgICAgJHN0YXRlLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgcmV0dXJuICRxLndoZW4oJHN0YXRlLmN1cnJlbnQpOwogICAgICAgIH0KCiAgICAgICAgLy8gTm9ybWFsaXplL2ZpbHRlciBwYXJhbWV0ZXJzIGJlZm9yZSB3ZSBwYXNzIHRoZW0gdG8gZXZlbnQgaGFuZGxlcnMgZXRjLgogICAgICAgIHRvUGFyYW1zID0gbm9ybWFsaXplKHRvLnBhcmFtcywgdG9QYXJhbXMgfHwge30pOwoKICAgICAgICAvLyBCcm9hZGNhc3Qgc3RhcnQgZXZlbnQgYW5kIGNhbmNlbCB0aGUgdHJhbnNpdGlvbiBpZiByZXF1ZXN0ZWQKICAgICAgICBpZiAob3B0aW9ucy5ub3RpZnkpIHsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlIyRzdGF0ZUNoYW5nZVN0YXJ0CiAgICAgICAgICAgKiBAZXZlbnRPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAgICAgKiBAZXZlbnRUeXBlIGJyb2FkY2FzdCBvbiByb290IHNjb3BlCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIEZpcmVkIHdoZW4gdGhlIHN0YXRlIHRyYW5zaXRpb24gKipiZWdpbnMqKi4gWW91IGNhbiB1c2UgYGV2ZW50LnByZXZlbnREZWZhdWx0KClgCiAgICAgICAgICAgKiB0byBwcmV2ZW50IHRoZSB0cmFuc2l0aW9uIGZyb20gaGFwcGVuaW5nIGFuZCB0aGVuIHRoZSB0cmFuc2l0aW9uIHByb21pc2Ugd2lsbCBiZQogICAgICAgICAgICogcmVqZWN0ZWQgd2l0aCBhIGAndHJhbnNpdGlvbiBwcmV2ZW50ZWQnYCB2YWx1ZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgRXZlbnQgb2JqZWN0LgogICAgICAgICAgICogQHBhcmFtIHtTdGF0ZX0gdG9TdGF0ZSBUaGUgc3RhdGUgYmVpbmcgdHJhbnNpdGlvbmVkIHRvLgogICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHRvUGFyYW1zIFRoZSBwYXJhbXMgc3VwcGxpZWQgdG8gdGhlIGB0b1N0YXRlYC4KICAgICAgICAgICAqIEBwYXJhbSB7U3RhdGV9IGZyb21TdGF0ZSBUaGUgY3VycmVudCBzdGF0ZSwgcHJlLXRyYW5zaXRpb24uCiAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZnJvbVBhcmFtcyBUaGUgcGFyYW1zIHN1cHBsaWVkIHRvIHRoZSBgZnJvbVN0YXRlYC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAZXhhbXBsZQogICAgICAgICAgICoKICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgKiAkcm9vdFNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3RhcnQnLAogICAgICAgICAgICogZnVuY3Rpb24oZXZlbnQsIHRvU3RhdGUsIHRvUGFyYW1zLCBmcm9tU3RhdGUsIGZyb21QYXJhbXMpewogICAgICAgICAqICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAqICAgICAvLyB0cmFuc2l0aW9uVG8oKSBwcm9taXNlIHdpbGwgYmUgcmVqZWN0ZWQgd2l0aAogICAgICAgICAqICAgICAvLyBhICd0cmFuc2l0aW9uIHByZXZlbnRlZCcgZXJyb3IKICAgICAgICAgKiB9KQogICAgICAgICAgICogPC9wcmU+CiAgICAgICAgICAgKi8KICAgICAgICAgIGV2dCA9ICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHN0YXRlQ2hhbmdlU3RhcnQnLCB0by5zZWxmLCB0b1BhcmFtcywgZnJvbS5zZWxmLCBmcm9tUGFyYW1zKTsKICAgICAgICAgIGlmIChldnQuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICBzeW5jVXJsKCk7CiAgICAgICAgICAgIHJldHVybiBUcmFuc2l0aW9uUHJldmVudGVkOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gUmVzb2x2ZSBsb2NhbHMgZm9yIHRoZSByZW1haW5pbmcgc3RhdGVzLCBidXQgZG9uJ3QgdXBkYXRlIGFueSBnbG9iYWwgc3RhdGUganVzdAogICAgICAgIC8vIHlldCAtLSBpZiBhbnl0aGluZyBmYWlscyB0byByZXNvbHZlIHRoZSBjdXJyZW50IHN0YXRlIG5lZWRzIHRvIHJlbWFpbiB1bnRvdWNoZWQuCiAgICAgICAgLy8gV2UgYWxzbyBzZXQgdXAgYW4gaW5oZXJpdGFuY2UgY2hhaW4gZm9yIHRoZSBsb2NhbHMgaGVyZS4gVGhpcyBhbGxvd3MgdGhlIHZpZXcgZGlyZWN0aXZlCiAgICAgICAgLy8gdG8gcXVpY2tseSBsb29rIHVwIHRoZSBjb3JyZWN0IGRlZmluaXRpb24gZm9yIGVhY2ggdmlldyBpbiB0aGUgY3VycmVudCBzdGF0ZS4gRXZlbgogICAgICAgIC8vIHRob3VnaCB3ZSBjcmVhdGUgdGhlIGxvY2FscyBvYmplY3QgaXRzZWxmIG91dHNpZGUgcmVzb2x2ZVN0YXRlKCksIGl0IGlzIGluaXRpYWxseQogICAgICAgIC8vIGVtcHR5IGFuZCBnZXRzIGZpbGxlZCBhc3luY2hyb25vdXNseS4gV2UgbmVlZCB0byBrZWVwIHRyYWNrIG9mIHRoZSBwcm9taXNlIGZvciB0aGUKICAgICAgICAvLyAoZnVsbHkgcmVzb2x2ZWQpIGN1cnJlbnQgbG9jYWxzLCBhbmQgcGFzcyB0aGlzIGRvd24gdGhlIGNoYWluLgogICAgICAgIHZhciByZXNvbHZlZCA9ICRxLndoZW4obG9jYWxzKTsKICAgICAgICBmb3IgKHZhciBsPWtlZXA7IGw8dG9QYXRoLmxlbmd0aDsgbCsrLCBzdGF0ZT10b1BhdGhbbF0pIHsKICAgICAgICAgIGxvY2FscyA9IHRvTG9jYWxzW2xdID0gaW5oZXJpdChsb2NhbHMpOwogICAgICAgICAgcmVzb2x2ZWQgPSByZXNvbHZlU3RhdGUoc3RhdGUsIHRvUGFyYW1zLCBzdGF0ZT09PXRvLCByZXNvbHZlZCwgbG9jYWxzKTsKICAgICAgICB9CgogICAgICAgIC8vIE9uY2UgZXZlcnl0aGluZyBpcyByZXNvbHZlZCwgd2UgYXJlIHJlYWR5IHRvIHBlcmZvcm0gdGhlIGFjdHVhbCB0cmFuc2l0aW9uCiAgICAgICAgLy8gYW5kIHJldHVybiBhIHByb21pc2UgZm9yIHRoZSBuZXcgc3RhdGUuIFdlIGFsc28ga2VlcCB0cmFjayBvZiB3aGF0IHRoZQogICAgICAgIC8vIGN1cnJlbnQgcHJvbWlzZSBpcywgc28gdGhhdCB3ZSBjYW4gZGV0ZWN0IG92ZXJsYXBwaW5nIHRyYW5zaXRpb25zIGFuZAogICAgICAgIC8vIGtlZXAgb25seSB0aGUgb3V0Y29tZSBvZiB0aGUgbGFzdCB0cmFuc2l0aW9uLgogICAgICAgIHZhciB0cmFuc2l0aW9uID0gJHN0YXRlLnRyYW5zaXRpb24gPSByZXNvbHZlZC50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBsLCBlbnRlcmluZywgZXhpdGluZzsKCiAgICAgICAgICBpZiAoJHN0YXRlLnRyYW5zaXRpb24gIT09IHRyYW5zaXRpb24pIHJldHVybiBUcmFuc2l0aW9uU3VwZXJzZWRlZDsKCiAgICAgICAgICAvLyBFeGl0ICdmcm9tJyBzdGF0ZXMgbm90IGtlcHQKICAgICAgICAgIGZvciAobD1mcm9tUGF0aC5sZW5ndGgtMTsgbD49a2VlcDsgbC0tKSB7CiAgICAgICAgICAgIGV4aXRpbmcgPSBmcm9tUGF0aFtsXTsKICAgICAgICAgICAgaWYgKGV4aXRpbmcuc2VsZi5vbkV4aXQpIHsKICAgICAgICAgICAgICAkaW5qZWN0b3IuaW52b2tlKGV4aXRpbmcuc2VsZi5vbkV4aXQsIGV4aXRpbmcuc2VsZiwgZXhpdGluZy5sb2NhbHMuZ2xvYmFscyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXhpdGluZy5sb2NhbHMgPSBudWxsOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEVudGVyICd0bycgc3RhdGVzIG5vdCBrZXB0CiAgICAgICAgICBmb3IgKGw9a2VlcDsgbDx0b1BhdGgubGVuZ3RoOyBsKyspIHsKICAgICAgICAgICAgZW50ZXJpbmcgPSB0b1BhdGhbbF07CiAgICAgICAgICAgIGVudGVyaW5nLmxvY2FscyA9IHRvTG9jYWxzW2xdOwogICAgICAgICAgICBpZiAoZW50ZXJpbmcuc2VsZi5vbkVudGVyKSB7CiAgICAgICAgICAgICAgJGluamVjdG9yLmludm9rZShlbnRlcmluZy5zZWxmLm9uRW50ZXIsIGVudGVyaW5nLnNlbGYsIGVudGVyaW5nLmxvY2Fscy5nbG9iYWxzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIFJ1biBpdCBhZ2FpbiwgdG8gY2F0Y2ggYW55IHRyYW5zaXRpb25zIGluIGNhbGxiYWNrcwogICAgICAgICAgaWYgKCRzdGF0ZS50cmFuc2l0aW9uICE9PSB0cmFuc2l0aW9uKSByZXR1cm4gVHJhbnNpdGlvblN1cGVyc2VkZWQ7CgogICAgICAgICAgLy8gVXBkYXRlIGdsb2JhbHMgaW4gJHN0YXRlCiAgICAgICAgICAkc3RhdGUuJGN1cnJlbnQgPSB0bzsKICAgICAgICAgICRzdGF0ZS5jdXJyZW50ID0gdG8uc2VsZjsKICAgICAgICAgICRzdGF0ZS5wYXJhbXMgPSB0b1BhcmFtczsKICAgICAgICAgIGNvcHkoJHN0YXRlLnBhcmFtcywgJHN0YXRlUGFyYW1zKTsKICAgICAgICAgICRzdGF0ZS50cmFuc2l0aW9uID0gbnVsbDsKCiAgICAgICAgICAvLyBVcGRhdGUgJGxvY2F0aW9uCiAgICAgICAgICB2YXIgdG9OYXYgPSB0by5uYXZpZ2FibGU7CiAgICAgICAgICBpZiAob3B0aW9ucy5sb2NhdGlvbiAmJiB0b05hdikgewogICAgICAgICAgICAkbG9jYXRpb24udXJsKHRvTmF2LnVybC5mb3JtYXQodG9OYXYubG9jYWxzLmdsb2JhbHMuJHN0YXRlUGFyYW1zKSk7CgogICAgICAgICAgICBpZiAob3B0aW9ucy5sb2NhdGlvbiA9PT0gJ3JlcGxhY2UnKSB7CiAgICAgICAgICAgICAgJGxvY2F0aW9uLnJlcGxhY2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGlmIChvcHRpb25zLm5vdGlmeSkgewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjJHN0YXRlQ2hhbmdlU3VjY2VzcwogICAgICAgICAgICAgKiBAZXZlbnRPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAgICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIEZpcmVkIG9uY2UgdGhlIHN0YXRlIHRyYW5zaXRpb24gaXMgKipjb21wbGV0ZSoqLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgRXZlbnQgb2JqZWN0LgogICAgICAgICAgICAgKiBAcGFyYW0ge1N0YXRlfSB0b1N0YXRlIFRoZSBzdGF0ZSBiZWluZyB0cmFuc2l0aW9uZWQgdG8uCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0b1BhcmFtcyBUaGUgcGFyYW1zIHN1cHBsaWVkIHRvIHRoZSBgdG9TdGF0ZWAuCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RhdGV9IGZyb21TdGF0ZSBUaGUgY3VycmVudCBzdGF0ZSwgcHJlLXRyYW5zaXRpb24uCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBmcm9tUGFyYW1zIFRoZSBwYXJhbXMgc3VwcGxpZWQgdG8gdGhlIGBmcm9tU3RhdGVgLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckc3RhdGVDaGFuZ2VTdWNjZXNzJywgdG8uc2VsZiwgdG9QYXJhbXMsIGZyb20uc2VsZiwgZnJvbVBhcmFtcyk7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50TG9jYXRpb24gPSAkbG9jYXRpb24udXJsKCk7CgogICAgICAgICAgcmV0dXJuICRzdGF0ZS5jdXJyZW50OwogICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgaWYgKCRzdGF0ZS50cmFuc2l0aW9uICE9PSB0cmFuc2l0aW9uKSByZXR1cm4gVHJhbnNpdGlvblN1cGVyc2VkZWQ7CgogICAgICAgICAgJHN0YXRlLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgZXZlbnQKICAgICAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjJHN0YXRlQ2hhbmdlRXJyb3IKICAgICAgICAgICAqIEBldmVudE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAgICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICogRmlyZWQgd2hlbiBhbiAqKmVycm9yIG9jY3VycyoqIGR1cmluZyB0cmFuc2l0aW9uLiBJdCdzIGltcG9ydGFudCB0byBub3RlIHRoYXQgaWYgeW91CiAgICAgICAgICAgKiBoYXZlIGFueSBlcnJvcnMgaW4geW91ciByZXNvbHZlIGZ1bmN0aW9ucyAoamF2YXNjcmlwdCBlcnJvcnMsIG5vbi1leGlzdGVudCBzZXJ2aWNlcywgZXRjKQogICAgICAgICAgICogdGhleSB3aWxsIG5vdCB0aHJvdyB0cmFkaXRpb25hbGx5LiBZb3UgbXVzdCBsaXN0ZW4gZm9yIHRoaXMgJHN0YXRlQ2hhbmdlRXJyb3IgZXZlbnQgdG8KICAgICAgICAgICAqIGNhdGNoICoqQUxMKiogZXJyb3JzLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudCBFdmVudCBvYmplY3QuCiAgICAgICAgICAgKiBAcGFyYW0ge1N0YXRlfSB0b1N0YXRlIFRoZSBzdGF0ZSBiZWluZyB0cmFuc2l0aW9uZWQgdG8uCiAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdG9QYXJhbXMgVGhlIHBhcmFtcyBzdXBwbGllZCB0byB0aGUgYHRvU3RhdGVgLgogICAgICAgICAgICogQHBhcmFtIHtTdGF0ZX0gZnJvbVN0YXRlIFRoZSBjdXJyZW50IHN0YXRlLCBwcmUtdHJhbnNpdGlvbi4KICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBmcm9tUGFyYW1zIFRoZSBwYXJhbXMgc3VwcGxpZWQgdG8gdGhlIGBmcm9tU3RhdGVgLgogICAgICAgICAgICogQHBhcmFtIHtFcnJvcn0gZXJyb3IgVGhlIHJlc29sdmUgZXJyb3Igb2JqZWN0LgogICAgICAgICAgICovCiAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRzdGF0ZUNoYW5nZUVycm9yJywgdG8uc2VsZiwgdG9QYXJhbXMsIGZyb20uc2VsZiwgZnJvbVBhcmFtcywgZXJyb3IpOwogICAgICAgICAgc3luY1VybCgpOwoKICAgICAgICAgIHJldHVybiAkcS5yZWplY3QoZXJyb3IpOwogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gdHJhbnNpdGlvbjsKICAgICAgfTsKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNpcwogICAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogU2ltaWxhciB0byB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNtZXRob2RzX2luY2x1ZGVzICRzdGF0ZS5pbmNsdWRlc30sCiAgICAgICAqIGJ1dCBvbmx5IGNoZWNrcyBmb3IgdGhlIGZ1bGwgc3RhdGUgbmFtZS4gSWYgcGFyYW1zIGlzIHN1cHBsaWVkIHRoZW4gaXQgd2lsbCBiZQogICAgICAgKiB0ZXN0ZWQgZm9yIHN0cmljdCBlcXVhbGl0eSBhZ2FpbnN0IHRoZSBjdXJyZW50IGFjdGl2ZSBwYXJhbXMgb2JqZWN0LCBzbyBhbGwgcGFyYW1zCiAgICAgICAqIG11c3QgbWF0Y2ggd2l0aCBub25lIG1pc3NpbmcgYW5kIG5vIGV4dHJhcy4KICAgICAgICoKICAgICAgICogQGV4YW1wbGUKICAgICAgICogPHByZT4KICAgICAgICogJHN0YXRlLmlzKCdjb250YWN0LmRldGFpbHMuaXRlbScpOyAvLyByZXR1cm5zIHRydWUKICAgICAgICogJHN0YXRlLmlzKGNvbnRhY3REZXRhaWxJdGVtU3RhdGVPYmplY3QpOyAvLyByZXR1cm5zIHRydWUKICAgICAgICoKICAgICAgICogLy8gZXZlcnl0aGluZyBlbHNlIHdvdWxkIHJldHVybiBmYWxzZQogICAgICAgKiA8L3ByZT4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSBzdGF0ZU5hbWUgVGhlIHN0YXRlIG5hbWUgb3Igc3RhdGUgb2JqZWN0IHlvdSdkIGxpa2UgdG8gY2hlY2suCiAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gcGFyYW1zIEEgcGFyYW0gb2JqZWN0LCBlLmcuIGB7c2VjdGlvbklkOiBzZWN0aW9uLmlkfWAsIHRoYXQgeW91J2QgbGlrZQogICAgICAgKiB0byB0ZXN0IGFnYWluc3QgdGhlIGN1cnJlbnQgYWN0aXZlIHN0YXRlLgogICAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIGl0IGlzIHRoZSBzdGF0ZS4KICAgICAgICovCiAgICAgICRzdGF0ZS5pcyA9IGZ1bmN0aW9uIGlzKHN0YXRlT3JOYW1lLCBwYXJhbXMpIHsKICAgICAgICB2YXIgc3RhdGUgPSBmaW5kU3RhdGUoc3RhdGVPck5hbWUpOwoKICAgICAgICBpZiAoIWlzRGVmaW5lZChzdGF0ZSkpIHsKICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgfQoKICAgICAgICBpZiAoJHN0YXRlLiRjdXJyZW50ICE9PSBzdGF0ZSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGlzRGVmaW5lZChwYXJhbXMpICYmIHBhcmFtcyAhPT0gbnVsbCA/IGFuZ3VsYXIuZXF1YWxzKCRzdGF0ZVBhcmFtcywgcGFyYW1zKSA6IHRydWU7CiAgICAgIH07CgogICAgICAvKioKICAgICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjaW5jbHVkZXMKICAgICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgICAgICoKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIEEgbWV0aG9kIHRvIGRldGVybWluZSBpZiB0aGUgY3VycmVudCBhY3RpdmUgc3RhdGUgaXMgZXF1YWwgdG8gb3IgaXMgdGhlIGNoaWxkIG9mIHRoZQogICAgICAgKiBzdGF0ZSBzdGF0ZU5hbWUuIElmIGFueSBwYXJhbXMgYXJlIHBhc3NlZCB0aGVuIHRoZXkgd2lsbCBiZSB0ZXN0ZWQgZm9yIGEgbWF0Y2ggYXMgd2VsbC4KICAgICAgICogTm90IGFsbCB0aGUgcGFyYW1ldGVycyBuZWVkIHRvIGJlIHBhc3NlZCwganVzdCB0aGUgb25lcyB5b3UnZCBsaWtlIHRvIHRlc3QgZm9yIGVxdWFsaXR5LgogICAgICAgKgogICAgICAgKiBAZXhhbXBsZQogICAgICAgKiA8cHJlPgogICAgICAgKiAkc3RhdGUuJGN1cnJlbnQubmFtZSA9ICdjb250YWN0cy5kZXRhaWxzLml0ZW0nOwogICAgICAgKgogICAgICAgKiAkc3RhdGUuaW5jbHVkZXMoImNvbnRhY3RzIik7IC8vIHJldHVybnMgdHJ1ZQogICAgICAgKiAkc3RhdGUuaW5jbHVkZXMoImNvbnRhY3RzLmRldGFpbHMiKTsgLy8gcmV0dXJucyB0cnVlCiAgICAgICAqICRzdGF0ZS5pbmNsdWRlcygiY29udGFjdHMuZGV0YWlscy5pdGVtIik7IC8vIHJldHVybnMgdHJ1ZQogICAgICAgKiAkc3RhdGUuaW5jbHVkZXMoImNvbnRhY3RzLmxpc3QiKTsgLy8gcmV0dXJucyBmYWxzZQogICAgICAgKiAkc3RhdGUuaW5jbHVkZXMoImFib3V0Iik7IC8vIHJldHVybnMgZmFsc2UKICAgICAgICogPC9wcmU+CiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBCYXNpYyBnbG9iaW5nIHBhdHRlcm5zIHdpbGwgYWxzbyB3b3JrLgogICAgICAgKgogICAgICAgKiBAZXhhbXBsZQogICAgICAgKiA8cHJlPgogICAgICAgKiAkc3RhdGUuJGN1cnJlbnQubmFtZSA9ICdjb250YWN0cy5kZXRhaWxzLml0ZW0udXJsJzsKICAgICAgICoKICAgICAgICogJHN0YXRlLmluY2x1ZGVzKCIqLmRldGFpbHMuKi4qIik7IC8vIHJldHVybnMgdHJ1ZQogICAgICAgKiAkc3RhdGUuaW5jbHVkZXMoIiouZGV0YWlscy4qKiIpOyAvLyByZXR1cm5zIHRydWUKICAgICAgICogJHN0YXRlLmluY2x1ZGVzKCIqKi5pdGVtLioqIik7IC8vIHJldHVybnMgdHJ1ZQogICAgICAgKiAkc3RhdGUuaW5jbHVkZXMoIiouZGV0YWlscy5pdGVtLnVybCIpOyAvLyByZXR1cm5zIHRydWUKICAgICAgICogJHN0YXRlLmluY2x1ZGVzKCIqLmRldGFpbHMuKi51cmwiKTsgLy8gcmV0dXJucyB0cnVlCiAgICAgICAqICRzdGF0ZS5pbmNsdWRlcygiKi5kZXRhaWxzLioiKTsgLy8gcmV0dXJucyBmYWxzZQogICAgICAgKiAkc3RhdGUuaW5jbHVkZXMoIml0ZW0uKioiKTsgLy8gcmV0dXJucyBmYWxzZQogICAgICAgKiA8L3ByZT4KICAgICAgICoKICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHN0YXRlT3JOYW1lIEEgcGFydGlhbCBuYW1lIHRvIGJlIHNlYXJjaGVkIGZvciB3aXRoaW4gdGhlIGN1cnJlbnQgc3RhdGUgbmFtZS4KICAgICAgICogQHBhcmFtIHtvYmplY3R9IHBhcmFtcyBBIHBhcmFtIG9iamVjdCwgZS5nLiBge3NlY3Rpb25JZDogc2VjdGlvbi5pZH1gLAogICAgICAgKiB0aGF0IHlvdSdkIGxpa2UgdG8gdGVzdCBhZ2FpbnN0IHRoZSBjdXJyZW50IGFjdGl2ZSBzdGF0ZS4KICAgICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBpdCBkb2VzIGluY2x1ZGUgdGhlIHN0YXRlCiAgICAgICAqLwoKICAgICAgJHN0YXRlLmluY2x1ZGVzID0gZnVuY3Rpb24gaW5jbHVkZXMoc3RhdGVPck5hbWUsIHBhcmFtcykgewogICAgICAgIGlmIChpc1N0cmluZyhzdGF0ZU9yTmFtZSkgJiYgaXNHbG9iKHN0YXRlT3JOYW1lKSkgewogICAgICAgICAgaWYgKGRvZXNTdGF0ZU1hdGNoR2xvYihzdGF0ZU9yTmFtZSkpIHsKICAgICAgICAgICAgc3RhdGVPck5hbWUgPSAkc3RhdGUuJGN1cnJlbnQubmFtZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBzdGF0ZSA9IGZpbmRTdGF0ZShzdGF0ZU9yTmFtZSk7CiAgICAgICAgaWYgKCFpc0RlZmluZWQoc3RhdGUpKSB7CiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFpc0RlZmluZWQoJHN0YXRlLiRjdXJyZW50LmluY2x1ZGVzW3N0YXRlLm5hbWVdKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdmFyIHZhbGlkUGFyYW1zID0gdHJ1ZTsKICAgICAgICBhbmd1bGFyLmZvckVhY2gocGFyYW1zLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICBpZiAoIWlzRGVmaW5lZCgkc3RhdGVQYXJhbXNba2V5XSkgfHwgJHN0YXRlUGFyYW1zW2tleV0gIT09IHZhbHVlKSB7CiAgICAgICAgICAgIHZhbGlkUGFyYW1zID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHZhbGlkUGFyYW1zOwogICAgICB9OwoKCiAgICAgIC8qKgogICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNocmVmCiAgICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICAgICAqCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBBIHVybCBnZW5lcmF0aW9uIG1ldGhvZCB0aGF0IHJldHVybnMgdGhlIGNvbXBpbGVkIHVybCBmb3IgdGhlIGdpdmVuIHN0YXRlIHBvcHVsYXRlZCB3aXRoIHRoZSBnaXZlbiBwYXJhbXMuCiAgICAgICAqCiAgICAgICAqIEBleGFtcGxlCiAgICAgICAqIDxwcmU+CiAgICAgICAqIGV4cGVjdCgkc3RhdGUuaHJlZigiYWJvdXQucGVyc29uIiwgeyBwZXJzb246ICJib2IiIH0pKS50b0VxdWFsKCIvYWJvdXQvYm9iIik7CiAgICAgICAqIDwvcHJlPgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3R9IHN0YXRlT3JOYW1lIFRoZSBzdGF0ZSBuYW1lIG9yIHN0YXRlIG9iamVjdCB5b3UnZCBsaWtlIHRvIGdlbmVyYXRlIGEgdXJsIGZyb20uCiAgICAgICAqIEBwYXJhbSB7b2JqZWN0PX0gcGFyYW1zIEFuIG9iamVjdCBvZiBwYXJhbWV0ZXIgdmFsdWVzIHRvIGZpbGwgdGhlIHN0YXRlJ3MgcmVxdWlyZWQgcGFyYW1ldGVycy4KICAgICAgICogQHBhcmFtIHtvYmplY3Q9fSBvcHRpb25zIE9wdGlvbnMgb2JqZWN0LiBUaGUgb3B0aW9ucyBhcmU6CiAgICAgICAqCiAgICAgICAqIC0gKipgbG9zc3lgKiogLSB7Ym9vbGVhbj10cnVlfSAtICBJZiB0cnVlLCBhbmQgaWYgdGhlcmUgaXMgbm8gdXJsIGFzc29jaWF0ZWQgd2l0aCB0aGUgc3RhdGUgcHJvdmlkZWQgaW4gdGhlCiAgICAgICAqICAgIGZpcnN0IHBhcmFtZXRlciwgdGhlbiB0aGUgY29uc3RydWN0ZWQgaHJlZiB1cmwgd2lsbCBiZSBidWlsdCBmcm9tIHRoZSBmaXJzdCBuYXZpZ2FibGUgYW5jZXN0b3IgKGFrYQogICAgICAgKiAgICBhbmNlc3RvciB3aXRoIGEgdmFsaWQgdXJsKS4KICAgICAgICogLSAqKmBpbmhlcml0YCoqIC0ge2Jvb2xlYW49ZmFsc2V9LCBJZiBgdHJ1ZWAgd2lsbCBpbmhlcml0IHVybCBwYXJhbWV0ZXJzIGZyb20gY3VycmVudCB1cmwuCiAgICAgICAqIC0gKipgcmVsYXRpdmVgKiogLSB7b2JqZWN0PSRzdGF0ZS4kY3VycmVudH0sIFdoZW4gdHJhbnNpdGlvbmluZyB3aXRoIHJlbGF0aXZlIHBhdGggKGUuZyAnXicpLAogICAgICAgKiAgICBkZWZpbmVzIHdoaWNoIHN0YXRlIHRvIGJlIHJlbGF0aXZlIGZyb20uCiAgICAgICAqIC0gKipgYWJzb2x1dGVgKiogLSB7Ym9vbGVhbj1mYWxzZX0sICBJZiB0cnVlIHdpbGwgZ2VuZXJhdGUgYW4gYWJzb2x1dGUgdXJsLCBlLmcuICJodHRwOi8vd3d3LmV4YW1wbGUuY29tL2Z1bGx1cmwiLgogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBjb21waWxlZCBzdGF0ZSB1cmwKICAgICAgICovCiAgICAgICRzdGF0ZS5ocmVmID0gZnVuY3Rpb24gaHJlZihzdGF0ZU9yTmFtZSwgcGFyYW1zLCBvcHRpb25zKSB7CiAgICAgICAgb3B0aW9ucyA9IGV4dGVuZCh7IGxvc3N5OiB0cnVlLCBpbmhlcml0OiBmYWxzZSwgYWJzb2x1dGU6IGZhbHNlLCByZWxhdGl2ZTogJHN0YXRlLiRjdXJyZW50IH0sIG9wdGlvbnMgfHwge30pOwogICAgICAgIHZhciBzdGF0ZSA9IGZpbmRTdGF0ZShzdGF0ZU9yTmFtZSwgb3B0aW9ucy5yZWxhdGl2ZSk7CiAgICAgICAgaWYgKCFpc0RlZmluZWQoc3RhdGUpKSByZXR1cm4gbnVsbDsKCiAgICAgICAgcGFyYW1zID0gaW5oZXJpdFBhcmFtcygkc3RhdGVQYXJhbXMsIHBhcmFtcyB8fCB7fSwgJHN0YXRlLiRjdXJyZW50LCBzdGF0ZSk7CiAgICAgICAgdmFyIG5hdiA9IChzdGF0ZSAmJiBvcHRpb25zLmxvc3N5KSA/IHN0YXRlLm5hdmlnYWJsZSA6IHN0YXRlOwogICAgICAgIHZhciB1cmwgPSAobmF2ICYmIG5hdi51cmwpID8gbmF2LnVybC5mb3JtYXQobm9ybWFsaXplKHN0YXRlLnBhcmFtcywgcGFyYW1zIHx8IHt9KSkgOiBudWxsOwogICAgICAgIGlmICghJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKCkgJiYgdXJsKSB7CiAgICAgICAgICB1cmwgPSAiIyIgKyAkbG9jYXRpb25Qcm92aWRlci5oYXNoUHJlZml4KCkgKyB1cmw7CiAgICAgICAgfQoKICAgICAgICBpZiAoYmFzZUhyZWYgIT09ICcvJykgewogICAgICAgICAgaWYgKCRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSgpKSB7CiAgICAgICAgICAgIHVybCA9IGJhc2VIcmVmLnNsaWNlKDAsIC0xKSArIHVybDsKICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5hYnNvbHV0ZSl7CiAgICAgICAgICAgIHVybCA9IGJhc2VIcmVmLnNsaWNlKDEpICsgdXJsOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKG9wdGlvbnMuYWJzb2x1dGUgJiYgdXJsKSB7CiAgICAgICAgICB1cmwgPSAkbG9jYXRpb24ucHJvdG9jb2woKSArICc6Ly8nICsKICAgICAgICAgICAgJGxvY2F0aW9uLmhvc3QoKSArCiAgICAgICAgICAgICgkbG9jYXRpb24ucG9ydCgpID09IDgwIHx8ICRsb2NhdGlvbi5wb3J0KCkgPT0gNDQzID8gJycgOiAnOicgKyAkbG9jYXRpb24ucG9ydCgpKSArCiAgICAgICAgICAgICghJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKCkgJiYgdXJsID8gJy8nIDogJycpICsKICAgICAgICAgICAgdXJsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdXJsOwogICAgICB9OwoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI2dldAogICAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICAgKgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogUmV0dXJucyB0aGUgc3RhdGUgY29uZmlndXJhdGlvbiBvYmplY3QgZm9yIGFueSBzcGVjaWZpYyBzdGF0ZSBvciBhbGwgc3RhdGVzLgogICAgICAgKgogICAgICAgKiBAcGFyYW0ge3N0cmluZ3xvYmplY3Q9fSBzdGF0ZU9yTmFtZSBJZiBwcm92aWRlZCwgd2lsbCBvbmx5IGdldCB0aGUgY29uZmlnIGZvcgogICAgICAgKiB0aGUgcmVxdWVzdGVkIHN0YXRlLiBJZiBub3QgcHJvdmlkZWQsIHJldHVybnMgYW4gYXJyYXkgb2YgQUxMIHN0YXRlIGNvbmZpZ3MuCiAgICAgICAqIEByZXR1cm5zIHtvYmplY3R8YXJyYXl9IFN0YXRlIGNvbmZpZ3VyYXRpb24gb2JqZWN0IG9yIGFycmF5IG9mIGFsbCBvYmplY3RzLgogICAgICAgKi8KICAgICAgJHN0YXRlLmdldCA9IGZ1bmN0aW9uIChzdGF0ZU9yTmFtZSwgY29udGV4dCkgewogICAgICAgIGlmICghaXNEZWZpbmVkKHN0YXRlT3JOYW1lKSkgewogICAgICAgICAgdmFyIGxpc3QgPSBbXTsKICAgICAgICAgIGZvckVhY2goc3RhdGVzLCBmdW5jdGlvbihzdGF0ZSkgeyBsaXN0LnB1c2goc3RhdGUuc2VsZik7IH0pOwogICAgICAgICAgcmV0dXJuIGxpc3Q7CiAgICAgICAgfQogICAgICAgIHZhciBzdGF0ZSA9IGZpbmRTdGF0ZShzdGF0ZU9yTmFtZSwgY29udGV4dCk7CiAgICAgICAgcmV0dXJuIChzdGF0ZSAmJiBzdGF0ZS5zZWxmKSA/IHN0YXRlLnNlbGYgOiBudWxsOwogICAgICB9OwoKICAgICAgZnVuY3Rpb24gcmVzb2x2ZVN0YXRlKHN0YXRlLCBwYXJhbXMsIHBhcmFtc0FyZUZpbHRlcmVkLCBpbmhlcml0ZWQsIGRzdCkgewogICAgICAgIC8vIE1ha2UgYSByZXN0cmljdGVkICRzdGF0ZVBhcmFtcyB3aXRoIG9ubHkgdGhlIHBhcmFtZXRlcnMgdGhhdCBhcHBseSB0byB0aGlzIHN0YXRlIGlmCiAgICAgICAgLy8gbmVjZXNzYXJ5LiBJbiBhZGRpdGlvbiB0byBiZWluZyBhdmFpbGFibGUgdG8gdGhlIGNvbnRyb2xsZXIgYW5kIG9uRW50ZXIvb25FeGl0IGNhbGxiYWNrcywKICAgICAgICAvLyB3ZSBhbHNvIG5lZWQgJHN0YXRlUGFyYW1zIHRvIGJlIGF2YWlsYWJsZSBmb3IgYW55ICRpbmplY3RvciBjYWxscyB3ZSBtYWtlIGR1cmluZyB0aGUKICAgICAgICAvLyBkZXBlbmRlbmN5IHJlc29sdXRpb24gcHJvY2Vzcy4KICAgICAgICB2YXIgJHN0YXRlUGFyYW1zID0gKHBhcmFtc0FyZUZpbHRlcmVkKSA/IHBhcmFtcyA6IGZpbHRlckJ5S2V5cyhzdGF0ZS5wYXJhbXMsIHBhcmFtcyk7CiAgICAgICAgdmFyIGxvY2FscyA9IHsgJHN0YXRlUGFyYW1zOiAkc3RhdGVQYXJhbXMgfTsKCiAgICAgICAgLy8gUmVzb2x2ZSAnZ2xvYmFsJyBkZXBlbmRlbmNpZXMgZm9yIHRoZSBzdGF0ZSwgaS5lLiB0aG9zZSBub3Qgc3BlY2lmaWMgdG8gYSB2aWV3LgogICAgICAgIC8vIFdlJ3JlIGFsc28gaW5jbHVkaW5nICRzdGF0ZVBhcmFtcyBpbiB0aGlzOyB0aGF0IHdheSB0aGUgcGFyYW1ldGVycyBhcmUgcmVzdHJpY3RlZAogICAgICAgIC8vIHRvIHRoZSBzZXQgdGhhdCBzaG91bGQgYmUgdmlzaWJsZSB0byB0aGUgc3RhdGUsIGFuZCBhcmUgaW5kZXBlbmRlbnQgb2Ygd2hlbiB3ZSB1cGRhdGUKICAgICAgICAvLyB0aGUgZ2xvYmFsICRzdGF0ZSBhbmQgJHN0YXRlUGFyYW1zIHZhbHVlcy4KICAgICAgICBkc3QucmVzb2x2ZSA9ICRyZXNvbHZlLnJlc29sdmUoc3RhdGUucmVzb2x2ZSwgbG9jYWxzLCBkc3QucmVzb2x2ZSwgc3RhdGUpOwogICAgICAgIHZhciBwcm9taXNlcyA9IFsgZHN0LnJlc29sdmUudGhlbihmdW5jdGlvbiAoZ2xvYmFscykgewogICAgICAgICAgZHN0Lmdsb2JhbHMgPSBnbG9iYWxzOwogICAgICAgIH0pIF07CiAgICAgICAgaWYgKGluaGVyaXRlZCkgcHJvbWlzZXMucHVzaChpbmhlcml0ZWQpOwoKICAgICAgICAvLyBSZXNvbHZlIHRlbXBsYXRlIGFuZCBkZXBlbmRlbmNpZXMgZm9yIGFsbCB2aWV3cy4KICAgICAgICBmb3JFYWNoKHN0YXRlLnZpZXdzLCBmdW5jdGlvbiAodmlldywgbmFtZSkgewogICAgICAgICAgdmFyIGluamVjdGFibGVzID0gKHZpZXcucmVzb2x2ZSAmJiB2aWV3LnJlc29sdmUgIT09IHN0YXRlLnJlc29sdmUgPyB2aWV3LnJlc29sdmUgOiB7fSk7CiAgICAgICAgICBpbmplY3RhYmxlcy4kdGVtcGxhdGUgPSBbIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuICR2aWV3LmxvYWQobmFtZSwgeyB2aWV3OiB2aWV3LCBsb2NhbHM6IGxvY2FscywgcGFyYW1zOiAkc3RhdGVQYXJhbXMsIG5vdGlmeTogZmFsc2UgfSkgfHwgJyc7CiAgICAgICAgICB9XTsKCiAgICAgICAgICBwcm9taXNlcy5wdXNoKCRyZXNvbHZlLnJlc29sdmUoaW5qZWN0YWJsZXMsIGxvY2FscywgZHN0LnJlc29sdmUsIHN0YXRlKS50aGVuKGZ1bmN0aW9uIChyZXN1bHQpIHsKICAgICAgICAgICAgLy8gUmVmZXJlbmNlcyB0byB0aGUgY29udHJvbGxlciAob25seSBpbnN0YW50aWF0ZWQgYXQgbGluayB0aW1lKQogICAgICAgICAgICBpZiAoaXNGdW5jdGlvbih2aWV3LmNvbnRyb2xsZXJQcm92aWRlcikgfHwgaXNBcnJheSh2aWV3LmNvbnRyb2xsZXJQcm92aWRlcikpIHsKICAgICAgICAgICAgICB2YXIgaW5qZWN0TG9jYWxzID0gYW5ndWxhci5leHRlbmQoe30sIGluamVjdGFibGVzLCBsb2NhbHMpOwogICAgICAgICAgICAgIHJlc3VsdC4kJGNvbnRyb2xsZXIgPSAkaW5qZWN0b3IuaW52b2tlKHZpZXcuY29udHJvbGxlclByb3ZpZGVyLCBudWxsLCBpbmplY3RMb2NhbHMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdC4kJGNvbnRyb2xsZXIgPSB2aWV3LmNvbnRyb2xsZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gUHJvdmlkZSBhY2Nlc3MgdG8gdGhlIHN0YXRlIGl0c2VsZiBmb3IgaW50ZXJuYWwgdXNlCiAgICAgICAgICAgIHJlc3VsdC4kJHN0YXRlID0gc3RhdGU7CiAgICAgICAgICAgIHJlc3VsdC4kJGNvbnRyb2xsZXJBcyA9IHZpZXcuY29udHJvbGxlckFzOwogICAgICAgICAgICBkc3RbbmFtZV0gPSByZXN1bHQ7CiAgICAgICAgICB9KSk7CiAgICAgICAgfSk7CgogICAgICAgIC8vIFdhaXQgZm9yIGFsbCB0aGUgcHJvbWlzZXMgYW5kIHRoZW4gcmV0dXJuIHRoZSBhY3RpdmF0aW9uIG9iamVjdAogICAgICAgIHJldHVybiAkcS5hbGwocHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24gKHZhbHVlcykgewogICAgICAgICAgcmV0dXJuIGRzdDsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcmV0dXJuICRzdGF0ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBzaG91bGRUcmlnZ2VyUmVsb2FkKHRvLCBmcm9tLCBsb2NhbHMsIG9wdGlvbnMpIHsKICAgICAgaWYgKCB0byA9PT0gZnJvbSAmJiAoKGxvY2FscyA9PT0gZnJvbS5sb2NhbHMgJiYgIW9wdGlvbnMucmVsb2FkKSB8fCAodG8uc2VsZi5yZWxvYWRPblNlYXJjaCA9PT0gZmFsc2UpKSApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogIH0KCiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5zdGF0ZScpCiAgICAudmFsdWUoJyRzdGF0ZVBhcmFtcycsIHt9KQogICAgLnByb3ZpZGVyKCckc3RhdGUnLCAkU3RhdGVQcm92aWRlcik7CgoKICAkVmlld1Byb3ZpZGVyLiRpbmplY3QgPSBbXTsKICBmdW5jdGlvbiAkVmlld1Byb3ZpZGVyKCkgewoKICAgIHRoaXMuJGdldCA9ICRnZXQ7CiAgICAvKioKICAgICAqIEBuZ2RvYyBvYmplY3QKICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kdmlldwogICAgICoKICAgICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIudXRpbC4kdGVtcGxhdGVGYWN0b3J5CiAgICAgKiBAcmVxdWlyZXMgJHJvb3RTY29wZQogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICoKICAgICAqLwogICAgJGdldC4kaW5qZWN0ID0gWyckcm9vdFNjb3BlJywgJyR0ZW1wbGF0ZUZhY3RvcnknXTsKICAgIGZ1bmN0aW9uICRnZXQoICAgJHJvb3RTY29wZSwgICAkdGVtcGxhdGVGYWN0b3J5KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgLy8gJHZpZXcubG9hZCgnZnVsbC52aWV3TmFtZScsIHsgdGVtcGxhdGU6IC4uLiwgY29udHJvbGxlcjogLi4uLCByZXNvbHZlOiAuLi4sIGFzeW5jOiBmYWxzZSwgcGFyYW1zOiAuLi4gfSkKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgZnVuY3Rpb24KICAgICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHZpZXcjbG9hZAogICAgICAgICAqIEBtZXRob2RPZiB1aS5yb3V0ZXIuc3RhdGUuJHZpZXcKICAgICAgICAgKgogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgbmFtZQogICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIG9wdGlvbiBvYmplY3QuCiAgICAgICAgICovCiAgICAgICAgbG9hZDogZnVuY3Rpb24gbG9hZChuYW1lLCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIgcmVzdWx0LCBkZWZhdWx0cyA9IHsKICAgICAgICAgICAgdGVtcGxhdGU6IG51bGwsIGNvbnRyb2xsZXI6IG51bGwsIHZpZXc6IG51bGwsIGxvY2FsczogbnVsbCwgbm90aWZ5OiB0cnVlLCBhc3luYzogdHJ1ZSwgcGFyYW1zOiB7fQogICAgICAgICAgfTsKICAgICAgICAgIG9wdGlvbnMgPSBleHRlbmQoZGVmYXVsdHMsIG9wdGlvbnMpOwoKICAgICAgICAgIGlmIChvcHRpb25zLnZpZXcpIHsKICAgICAgICAgICAgcmVzdWx0ID0gJHRlbXBsYXRlRmFjdG9yeS5mcm9tQ29uZmlnKG9wdGlvbnMudmlldywgb3B0aW9ucy5wYXJhbXMsIG9wdGlvbnMubG9jYWxzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZXN1bHQgJiYgb3B0aW9ucy5ub3RpZnkpIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBldmVudAogICAgICAgICAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlIyR2aWV3Q29udGVudExvYWRpbmcKICAgICAgICAgICAgICogQGV2ZW50T2YgdWkucm91dGVyLnN0YXRlLiR2aWV3CiAgICAgICAgICAgICAqIEBldmVudFR5cGUgYnJvYWRjYXN0IG9uIHJvb3Qgc2NvcGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEZpcmVkIG9uY2UgdGhlIHZpZXcgKipiZWdpbnMgbG9hZGluZyoqLCAqYmVmb3JlKiB0aGUgRE9NIGlzIHJlbmRlcmVkLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgRXZlbnQgb2JqZWN0LgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gdmlld0NvbmZpZyBUaGUgdmlldyBjb25maWcgcHJvcGVydGllcyAodGVtcGxhdGUsIGNvbnRyb2xsZXIsIGV0YykuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBleGFtcGxlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIDxwcmU+CiAgICAgICAgICAgICAqICRzY29wZS4kb24oJyR2aWV3Q29udGVudExvYWRpbmcnLAogICAgICAgICAgICAgKiBmdW5jdGlvbihldmVudCwgdmlld0NvbmZpZyl7CiAgICAgICAgICogICAgIC8vIEFjY2VzcyB0byBhbGwgdGhlIHZpZXcgY29uZmlnIHByb3BlcnRpZXMuCiAgICAgICAgICogICAgIC8vIGFuZCBvbmUgc3BlY2lhbCBwcm9wZXJ0eSAndGFyZ2V0VmlldycKICAgICAgICAgKiAgICAgLy8gdmlld0NvbmZpZy50YXJnZXRWaWV3CiAgICAgICAgICogfSk7CiAgICAgICAgICAgICAqIDwvcHJlPgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckdmlld0NvbnRlbnRMb2FkaW5nJywgb3B0aW9ucyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9CgogIGFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIuc3RhdGUnKS5wcm92aWRlcignJHZpZXcnLCAkVmlld1Byb3ZpZGVyKTsKCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS4kdWlWaWV3U2Nyb2xsUHJvdmlkZXIKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFByb3ZpZGVyIHRoYXQgcmV0dXJucyB0aGUge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kdWlWaWV3U2Nyb2xsfSBzZXJ2aWNlIGZ1bmN0aW9uLgogICAqLwogIGZ1bmN0aW9uICRWaWV3U2Nyb2xsUHJvdmlkZXIoKSB7CgogICAgdmFyIHVzZUFuY2hvclNjcm9sbCA9IGZhbHNlOwoKICAgIC8qKgogICAgICogQG5nZG9jIGZ1bmN0aW9uCiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHVpVmlld1Njcm9sbFByb3ZpZGVyI3VzZUFuY2hvclNjcm9sbAogICAgICogQG1ldGhvZE9mIHVpLnJvdXRlci5zdGF0ZS4kdWlWaWV3U2Nyb2xsUHJvdmlkZXIKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJldmVydHMgYmFjayB0byB1c2luZyB0aGUgY29yZSBbYCRhbmNob3JTY3JvbGxgXShodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy4kYW5jaG9yU2Nyb2xsKSBzZXJ2aWNlIGZvcgogICAgICogc2Nyb2xsaW5nIGJhc2VkIG9uIHRoZSB1cmwgYW5jaG9yLgogICAgICovCiAgICB0aGlzLnVzZUFuY2hvclNjcm9sbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgdXNlQW5jaG9yU2Nyb2xsID0gdHJ1ZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2Mgb2JqZWN0CiAgICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuJHVpVmlld1Njcm9sbAogICAgICoKICAgICAqIEByZXF1aXJlcyAkYW5jaG9yU2Nyb2xsCiAgICAgKiBAcmVxdWlyZXMgJHRpbWVvdXQKICAgICAqCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFdoZW4gY2FsbGVkIHdpdGggYSBqcUxpdGUgZWxlbWVudCwgaXQgc2Nyb2xscyB0aGUgZWxlbWVudCBpbnRvIHZpZXcgKGFmdGVyIGEKICAgICAqIGAkdGltZW91dGAgc28gdGhlIERPTSBoYXMgdGltZSB0byByZWZyZXNoKS4KICAgICAqCiAgICAgKiBJZiB5b3UgcHJlZmVyIHRvIHJlbHkgb24gYCRhbmNob3JTY3JvbGxgIHRvIHNjcm9sbCB0aGUgdmlldyB0byB0aGUgYW5jaG9yLAogICAgICogdGhpcyBjYW4gYmUgZW5hYmxlZCBieSBjYWxsaW5nIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHVpVmlld1Njcm9sbFByb3ZpZGVyI21ldGhvZHNfdXNlQW5jaG9yU2Nyb2xsIGAkdWlWaWV3U2Nyb2xsUHJvdmlkZXIudXNlQW5jaG9yU2Nyb2xsKClgfS4KICAgICAqLwogICAgdGhpcy4kZ2V0ID0gWyckYW5jaG9yU2Nyb2xsJywgJyR0aW1lb3V0JywgZnVuY3Rpb24gKCRhbmNob3JTY3JvbGwsICR0aW1lb3V0KSB7CiAgICAgIGlmICh1c2VBbmNob3JTY3JvbGwpIHsKICAgICAgICByZXR1cm4gJGFuY2hvclNjcm9sbDsKICAgICAgfQoKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgkZWxlbWVudCkgewogICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICRlbGVtZW50WzBdLnNjcm9sbEludG9WaWV3KCk7CiAgICAgICAgfSwgMCwgZmFsc2UpOwogICAgICB9OwogICAgfV07CiAgfQoKICBhbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnN0YXRlJykucHJvdmlkZXIoJyR1aVZpZXdTY3JvbGwnLCAkVmlld1Njcm9sbFByb3ZpZGVyKTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS5kaXJlY3RpdmU6dWktdmlldwogICAqCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgKiBAcmVxdWlyZXMgJGNvbXBpbGUKICAgKiBAcmVxdWlyZXMgJGNvbnRyb2xsZXIKICAgKiBAcmVxdWlyZXMgJGluamVjdG9yCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kdWlWaWV3U2Nyb2xsCiAgICogQHJlcXVpcmVzICRkb2N1bWVudAogICAqCiAgICogQHJlc3RyaWN0IEVDQQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIHVpLXZpZXcgZGlyZWN0aXZlIHRlbGxzICRzdGF0ZSB3aGVyZSB0byBwbGFjZSB5b3VyIHRlbXBsYXRlcy4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gdWktdmlldyBBIHZpZXcgbmFtZS4gVGhlIG5hbWUgc2hvdWxkIGJlIHVuaXF1ZSBhbW9uZ3N0IHRoZSBvdGhlciB2aWV3cyBpbiB0aGUKICAgKiBzYW1lIHN0YXRlLiBZb3UgY2FuIGhhdmUgdmlld3Mgb2YgdGhlIHNhbWUgbmFtZSB0aGF0IGxpdmUgaW4gZGlmZmVyZW50IHN0YXRlcy4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gYXV0b3Njcm9sbCBJdCBhbGxvd3MgeW91IHRvIHNldCB0aGUgc2Nyb2xsIGJlaGF2aW9yIG9mIHRoZSBicm93c2VyIHdpbmRvdwogICAqIHdoZW4gYSB2aWV3IGlzIHBvcHVsYXRlZC4gQnkgZGVmYXVsdCwgJGFuY2hvclNjcm9sbCBpcyBvdmVycmlkZGVuIGJ5IHVpLXJvdXRlcidzIGN1c3RvbSBzY3JvbGwKICAgKiBzZXJ2aWNlLCB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiR1aVZpZXdTY3JvbGx9LiBUaGlzIGN1c3RvbSBzZXJ2aWNlIGxldCdzIHlvdQogICAqIHNjcm9sbCB1aS12aWV3IGVsZW1lbnRzIGludG8gdmlldyB3aGVuIHRoZXkgYXJlIHBvcHVsYXRlZCBkdXJpbmcgYSBzdGF0ZSBhY3RpdmF0aW9uLgogICAqCiAgICogKk5vdGU6IFRvIHJldmVydCBiYWNrIHRvIG9sZCBbYCRhbmNob3JTY3JvbGxgXShodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy4kYW5jaG9yU2Nyb2xsKQogICAqIGZ1bmN0aW9uYWxpdHksIGNhbGwgYCR1aVZpZXdTY3JvbGxQcm92aWRlci51c2VBbmNob3JTY3JvbGwoKWAuKgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBvbmxvYWQgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB3aGVuZXZlciB0aGUgdmlldyB1cGRhdGVzLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBBIHZpZXcgY2FuIGJlIHVubmFtZWQgb3IgbmFtZWQuCiAgICogPHByZT4KICAgKiA8IS0tIFVubmFtZWQgLS0+CiAgICogPGRpdiB1aS12aWV3PjwvZGl2PgogICAqCiAgICogPCEtLSBOYW1lZCAtLT4KICAgKiA8ZGl2IHVpLXZpZXc9InZpZXdOYW1lIj48L2Rpdj4KICAgKiA8L3ByZT4KICAgKgogICAqIFlvdSBjYW4gb25seSBoYXZlIG9uZSB1bm5hbWVkIHZpZXcgd2l0aGluIGFueSB0ZW1wbGF0ZSAob3Igcm9vdCBodG1sKS4gSWYgeW91IGFyZSBvbmx5IHVzaW5nIGEKICAgKiBzaW5nbGUgdmlldyBhbmQgaXQgaXMgdW5uYW1lZCB0aGVuIHlvdSBjYW4gcG9wdWxhdGUgaXQgbGlrZSBzbzoKICAgKiA8cHJlPgogICAqIDxkaXYgdWktdmlldz48L2Rpdj4KICAgKiAkc3RhdGVQcm92aWRlci5zdGF0ZSgiaG9tZSIsIHsKICogICB0ZW1wbGF0ZTogIjxoMT5IRUxMTyE8L2gxPiIKICogfSkKICAgKiA8L3ByZT4KICAgKgogICAqIFRoZSBhYm92ZSBpcyBhIGNvbnZlbmllbnQgc2hvcnRjdXQgZXF1aXZhbGVudCB0byBzcGVjaWZ5aW5nIHlvdXIgdmlldyBleHBsaWNpdGx5IHdpdGggdGhlIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlUHJvdmlkZXIjdmlld3MgYHZpZXdzYH0KICAgKiBjb25maWcgcHJvcGVydHksIGJ5IG5hbWUsIGluIHRoaXMgY2FzZSBhbiBlbXB0eSBuYW1lOgogICAqIDxwcmU+CiAgICogJHN0YXRlUHJvdmlkZXIuc3RhdGUoImhvbWUiLCB7CiAqICAgdmlld3M6IHsKICogICAgICIiOiB7CiAqICAgICAgIHRlbXBsYXRlOiAiPGgxPkhFTExPITwvaDE+IgogKiAgICAgfQogKiAgIH0gICAgCiAqIH0pCiAgICogPC9wcmU+CiAgICoKICAgKiBCdXQgdHlwaWNhbGx5IHlvdSdsbCBvbmx5IHVzZSB0aGUgdmlld3MgcHJvcGVydHkgaWYgeW91IG5hbWUgeW91ciB2aWV3IG9yIGhhdmUgbW9yZSB0aGFuIG9uZSB2aWV3CiAgICogaW4gdGhlIHNhbWUgdGVtcGxhdGUuIFRoZXJlJ3Mgbm90IHJlYWxseSBhIGNvbXBlbGxpbmcgcmVhc29uIHRvIG5hbWUgYSB2aWV3IGlmIGl0cyB0aGUgb25seSBvbmUsCiAgICogYnV0IHlvdSBjb3VsZCBpZiB5b3Ugd2FudGVkLCBsaWtlIHNvOgogICAqIDxwcmU+CiAgICogPGRpdiB1aS12aWV3PSJtYWluIj48L2Rpdj4KICAgKiA8L3ByZT4KICAgKiA8cHJlPgogICAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCJob21lIiwgewogKiAgIHZpZXdzOiB7CiAqICAgICAibWFpbiI6IHsKICogICAgICAgdGVtcGxhdGU6ICI8aDE+SEVMTE8hPC9oMT4iCiAqICAgICB9CiAqICAgfSAgICAKICogfSkKICAgKiA8L3ByZT4KICAgKgogICAqIFJlYWxseSB0aG91Z2gsIHlvdSdsbCB1c2Ugdmlld3MgdG8gc2V0IHVwIG11bHRpcGxlIHZpZXdzOgogICAqIDxwcmU+CiAgICogPGRpdiB1aS12aWV3PjwvZGl2PgogICAqIDxkaXYgdWktdmlldz0iY2hhcnQiPjwvZGl2PgogICAqIDxkaXYgdWktdmlldz0iZGF0YSI+PC9kaXY+CiAgICogPC9wcmU+CiAgICoKICAgKiA8cHJlPgogICAqICRzdGF0ZVByb3ZpZGVyLnN0YXRlKCJob21lIiwgewogKiAgIHZpZXdzOiB7CiAqICAgICAiIjogewogKiAgICAgICB0ZW1wbGF0ZTogIjxoMT5IRUxMTyE8L2gxPiIKICogICAgIH0sCiAqICAgICAiY2hhcnQiOiB7CiAqICAgICAgIHRlbXBsYXRlOiAiPGNoYXJ0X3RoaW5nLz4iCiAqICAgICB9LAogKiAgICAgImRhdGEiOiB7CiAqICAgICAgIHRlbXBsYXRlOiAiPGRhdGFfdGhpbmcvPiIKICogICAgIH0KICogICB9ICAgIAogKiB9KQogICAqIDwvcHJlPgogICAqCiAgICogRXhhbXBsZXMgZm9yIGBhdXRvc2Nyb2xsYDoKICAgKgogICAqIDxwcmU+CiAgICogPCEtLSBJZiBhdXRvc2Nyb2xsIHByZXNlbnQgd2l0aCBubyBleHByZXNzaW9uLAogICAqICAgICAgdGhlbiBzY3JvbGwgdWktdmlldyBpbnRvIHZpZXcgLS0+CiAgICogPHVpLXZpZXcgYXV0b3Njcm9sbC8+CiAgICoKICAgKiA8IS0tIElmIGF1dG9zY3JvbGwgcHJlc2VudCB3aXRoIHZhbGlkIGV4cHJlc3Npb24sCiAgICogICAgICB0aGVuIHNjcm9sbCB1aS12aWV3IGludG8gdmlldyBpZiBleHByZXNzaW9uIGV2YWx1YXRlcyB0byB0cnVlIC0tPgogICAqIDx1aS12aWV3IGF1dG9zY3JvbGw9J3RydWUnLz4KICAgKiA8dWktdmlldyBhdXRvc2Nyb2xsPSdmYWxzZScvPgogICAqIDx1aS12aWV3IGF1dG9zY3JvbGw9J3Njb3BlVmFyaWFibGUnLz4KICAgKiA8L3ByZT4KICAgKi8KICAkVmlld0RpcmVjdGl2ZS4kaW5qZWN0ID0gWyckc3RhdGUnLCAnJGluamVjdG9yJywgJyR1aVZpZXdTY3JvbGwnXTsKICBmdW5jdGlvbiAkVmlld0RpcmVjdGl2ZSggICAkc3RhdGUsICAgJGluamVjdG9yLCAgICR1aVZpZXdTY3JvbGwpIHsKCiAgICBmdW5jdGlvbiBnZXRTZXJ2aWNlKCkgewogICAgICByZXR1cm4gKCRpbmplY3Rvci5oYXMpID8gZnVuY3Rpb24oc2VydmljZSkgewogICAgICAgIHJldHVybiAkaW5qZWN0b3IuaGFzKHNlcnZpY2UpID8gJGluamVjdG9yLmdldChzZXJ2aWNlKSA6IG51bGw7CiAgICAgIH0gOiBmdW5jdGlvbihzZXJ2aWNlKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiAkaW5qZWN0b3IuZ2V0KHNlcnZpY2UpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KCiAgICB2YXIgc2VydmljZSA9IGdldFNlcnZpY2UoKSwKICAgICAgJGFuaW1hdG9yID0gc2VydmljZSgnJGFuaW1hdG9yJyksCiAgICAgICRhbmltYXRlID0gc2VydmljZSgnJGFuaW1hdGUnKTsKCiAgICAvLyBSZXR1cm5zIGEgc2V0IG9mIERPTSBtYW5pcHVsYXRpb24gZnVuY3Rpb25zIGJhc2VkIG9uIHdoaWNoIEFuZ3VsYXIgdmVyc2lvbgogICAgLy8gaXQgc2hvdWxkIHVzZQogICAgZnVuY3Rpb24gZ2V0UmVuZGVyZXIoYXR0cnMsIHNjb3BlKSB7CiAgICAgIHZhciBzdGF0aWNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGVudGVyOiBmdW5jdGlvbiAoZWxlbWVudCwgdGFyZ2V0LCBjYikgeyB0YXJnZXQuYWZ0ZXIoZWxlbWVudCk7IGNiKCk7IH0sCiAgICAgICAgICBsZWF2ZTogZnVuY3Rpb24gKGVsZW1lbnQsIGNiKSB7IGVsZW1lbnQucmVtb3ZlKCk7IGNiKCk7IH0KICAgICAgICB9OwogICAgICB9OwoKICAgICAgaWYgKCRhbmltYXRlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGVudGVyOiBmdW5jdGlvbihlbGVtZW50LCB0YXJnZXQsIGNiKSB7ICRhbmltYXRlLmVudGVyKGVsZW1lbnQsIG51bGwsIHRhcmdldCwgY2IpOyB9LAogICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uKGVsZW1lbnQsIGNiKSB7ICRhbmltYXRlLmxlYXZlKGVsZW1lbnQsIGNiKTsgfQogICAgICAgIH07CiAgICAgIH0KCiAgICAgIGlmICgkYW5pbWF0b3IpIHsKICAgICAgICB2YXIgYW5pbWF0ZSA9ICRhbmltYXRvciAmJiAkYW5pbWF0b3Ioc2NvcGUsIGF0dHJzKTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGVudGVyOiBmdW5jdGlvbihlbGVtZW50LCB0YXJnZXQsIGNiKSB7YW5pbWF0ZS5lbnRlcihlbGVtZW50LCBudWxsLCB0YXJnZXQpOyBjYigpOyB9LAogICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uKGVsZW1lbnQsIGNiKSB7IGFuaW1hdGUubGVhdmUoZWxlbWVudCk7IGNiKCk7IH0KICAgICAgICB9OwogICAgICB9CgogICAgICByZXR1cm4gc3RhdGljcygpOwogICAgfQoKICAgIHZhciBkaXJlY3RpdmUgPSB7CiAgICAgIHJlc3RyaWN0OiAnRUNBJywKICAgICAgdGVybWluYWw6IHRydWUsCiAgICAgIHByaW9yaXR5OiA0MDAsCiAgICAgIHRyYW5zY2x1ZGU6ICdlbGVtZW50JywKICAgICAgY29tcGlsZTogZnVuY3Rpb24gKHRFbGVtZW50LCB0QXR0cnMsICR0cmFuc2NsdWRlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgJGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNFbCwgY3VycmVudEVsLCBjdXJyZW50U2NvcGUsIGxhdGVzdExvY2FscywKICAgICAgICAgICAgb25sb2FkRXhwICAgICA9IGF0dHJzLm9ubG9hZCB8fCAnJywKICAgICAgICAgICAgYXV0b1Njcm9sbEV4cCA9IGF0dHJzLmF1dG9zY3JvbGwsCiAgICAgICAgICAgIHJlbmRlcmVyICAgICAgPSBnZXRSZW5kZXJlcihhdHRycywgc2NvcGUpOwoKICAgICAgICAgIHNjb3BlLiRvbignJHN0YXRlQ2hhbmdlU3VjY2VzcycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB1cGRhdGVWaWV3KGZhbHNlKTsKICAgICAgICAgIH0pOwogICAgICAgICAgc2NvcGUuJG9uKCckdmlld0NvbnRlbnRMb2FkaW5nJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHVwZGF0ZVZpZXcoZmFsc2UpOwogICAgICAgICAgfSk7CgogICAgICAgICAgdXBkYXRlVmlldyh0cnVlKTsKCiAgICAgICAgICBmdW5jdGlvbiBjbGVhbnVwTGFzdFZpZXcoKSB7CiAgICAgICAgICAgIGlmIChwcmV2aW91c0VsKSB7CiAgICAgICAgICAgICAgcHJldmlvdXNFbC5yZW1vdmUoKTsKICAgICAgICAgICAgICBwcmV2aW91c0VsID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGN1cnJlbnRTY29wZSkgewogICAgICAgICAgICAgIGN1cnJlbnRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgIGN1cnJlbnRTY29wZSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjdXJyZW50RWwpIHsKICAgICAgICAgICAgICByZW5kZXJlci5sZWF2ZShjdXJyZW50RWwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcHJldmlvdXNFbCA9IG51bGw7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIHByZXZpb3VzRWwgPSBjdXJyZW50RWw7CiAgICAgICAgICAgICAgY3VycmVudEVsID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVZpZXcoZmlyc3RUaW1lKSB7CiAgICAgICAgICAgIHZhciBuZXdTY29wZSAgICAgICAgPSBzY29wZS4kbmV3KCksCiAgICAgICAgICAgICAgbmFtZSAgICAgICAgICAgID0gY3VycmVudEVsICYmIGN1cnJlbnRFbC5kYXRhKCckdWlWaWV3TmFtZScpLAogICAgICAgICAgICAgIHByZXZpb3VzTG9jYWxzICA9IG5hbWUgJiYgJHN0YXRlLiRjdXJyZW50ICYmICRzdGF0ZS4kY3VycmVudC5sb2NhbHNbbmFtZV07CgogICAgICAgICAgICBpZiAoIWZpcnN0VGltZSAmJiBwcmV2aW91c0xvY2FscyA9PT0gbGF0ZXN0TG9jYWxzKSByZXR1cm47IC8vIG5vdGhpbmcgdG8gZG8KCiAgICAgICAgICAgIHZhciBjbG9uZSA9ICR0cmFuc2NsdWRlKG5ld1Njb3BlLCBmdW5jdGlvbihjbG9uZSkgewogICAgICAgICAgICAgIHJlbmRlcmVyLmVudGVyKGNsb25lLCAkZWxlbWVudCwgZnVuY3Rpb24gb25VaVZpZXdFbnRlcigpIHsKICAgICAgICAgICAgICAgIGlmIChhbmd1bGFyLmlzRGVmaW5lZChhdXRvU2Nyb2xsRXhwKSAmJiAhYXV0b1Njcm9sbEV4cCB8fCBzY29wZS4kZXZhbChhdXRvU2Nyb2xsRXhwKSkgewogICAgICAgICAgICAgICAgICAkdWlWaWV3U2Nyb2xsKGNsb25lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBjbGVhbnVwTGFzdFZpZXcoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBsYXRlc3RMb2NhbHMgPSAkc3RhdGUuJGN1cnJlbnQubG9jYWxzW2Nsb25lLmRhdGEoJyR1aVZpZXdOYW1lJyldOwoKICAgICAgICAgICAgY3VycmVudEVsID0gY2xvbmU7CiAgICAgICAgICAgIGN1cnJlbnRTY29wZSA9IG5ld1Njb3BlOwogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIGV2ZW50CiAgICAgICAgICAgICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS5kaXJlY3RpdmU6dWktdmlldyMkdmlld0NvbnRlbnRMb2FkZWQKICAgICAgICAgICAgICogQGV2ZW50T2YgdWkucm91dGVyLnN0YXRlLmRpcmVjdGl2ZTp1aS12aWV3CiAgICAgICAgICAgICAqIEBldmVudFR5cGUgZW1pdHMgb24gdWktdmlldyBkaXJlY3RpdmUgc2NvcGUKICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEZpcmVkIG9uY2UgdGhlIHZpZXcgaXMgKipsb2FkZWQqKiwgKmFmdGVyKiB0aGUgRE9NIGlzIHJlbmRlcmVkLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgRXZlbnQgb2JqZWN0LgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY3VycmVudFNjb3BlLiRlbWl0KCckdmlld0NvbnRlbnRMb2FkZWQnKTsKICAgICAgICAgICAgY3VycmVudFNjb3BlLiRldmFsKG9ubG9hZEV4cCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gZGlyZWN0aXZlOwogIH0KCiAgJFZpZXdEaXJlY3RpdmVGaWxsLiRpbmplY3QgPSBbJyRjb21waWxlJywgJyRjb250cm9sbGVyJywgJyRzdGF0ZSddOwogIGZ1bmN0aW9uICRWaWV3RGlyZWN0aXZlRmlsbCAoJGNvbXBpbGUsICRjb250cm9sbGVyLCAkc3RhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRUNBJywKICAgICAgcHJpb3JpdHk6IC00MDAsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uICh0RWxlbWVudCkgewogICAgICAgIHZhciBpbml0aWFsID0gdEVsZW1lbnQuaHRtbCgpOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoc2NvcGUsICRlbGVtZW50LCBhdHRycykgewogICAgICAgICAgdmFyIG5hbWUgICAgICA9IGF0dHJzLnVpVmlldyB8fCBhdHRycy5uYW1lIHx8ICcnLAogICAgICAgICAgICBpbmhlcml0ZWQgPSAkZWxlbWVudC5pbmhlcml0ZWREYXRhKCckdWlWaWV3Jyk7CgogICAgICAgICAgaWYgKG5hbWUuaW5kZXhPZignQCcpIDwgMCkgewogICAgICAgICAgICBuYW1lID0gbmFtZSArICdAJyArIChpbmhlcml0ZWQgPyBpbmhlcml0ZWQuc3RhdGUubmFtZSA6ICcnKTsKICAgICAgICAgIH0KCiAgICAgICAgICAkZWxlbWVudC5kYXRhKCckdWlWaWV3TmFtZScsIG5hbWUpOwoKICAgICAgICAgIHZhciBjdXJyZW50ID0gJHN0YXRlLiRjdXJyZW50LAogICAgICAgICAgICBsb2NhbHMgID0gY3VycmVudCAmJiBjdXJyZW50LmxvY2Fsc1tuYW1lXTsKCiAgICAgICAgICBpZiAoISBsb2NhbHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgICRlbGVtZW50LmRhdGEoJyR1aVZpZXcnLCB7IG5hbWU6IG5hbWUsIHN0YXRlOiBsb2NhbHMuJCRzdGF0ZSB9KTsKICAgICAgICAgICRlbGVtZW50Lmh0bWwobG9jYWxzLiR0ZW1wbGF0ZSA/IGxvY2Fscy4kdGVtcGxhdGUgOiBpbml0aWFsKTsKCiAgICAgICAgICB2YXIgbGluayA9ICRjb21waWxlKCRlbGVtZW50LmNvbnRlbnRzKCkpOwoKICAgICAgICAgIGlmIChsb2NhbHMuJCRjb250cm9sbGVyKSB7CiAgICAgICAgICAgIGxvY2Fscy4kc2NvcGUgPSBzY29wZTsKICAgICAgICAgICAgdmFyIGNvbnRyb2xsZXIgPSAkY29udHJvbGxlcihsb2NhbHMuJCRjb250cm9sbGVyLCBsb2NhbHMpOwogICAgICAgICAgICBpZiAobG9jYWxzLiQkY29udHJvbGxlckFzKSB7CiAgICAgICAgICAgICAgc2NvcGVbbG9jYWxzLiQkY29udHJvbGxlckFzXSA9IGNvbnRyb2xsZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJGVsZW1lbnQuZGF0YSgnJG5nQ29udHJvbGxlckNvbnRyb2xsZXInLCBjb250cm9sbGVyKTsKICAgICAgICAgICAgJGVsZW1lbnQuY2hpbGRyZW4oKS5kYXRhKCckbmdDb250cm9sbGVyQ29udHJvbGxlcicsIGNvbnRyb2xsZXIpOwogICAgICAgICAgfQoKICAgICAgICAgIGxpbmsoc2NvcGUpOwogICAgICAgIH07CiAgICAgIH0KICAgIH07CiAgfQoKICBhbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnN0YXRlJykuZGlyZWN0aXZlKCd1aVZpZXcnLCAkVmlld0RpcmVjdGl2ZSk7CiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5zdGF0ZScpLmRpcmVjdGl2ZSgndWlWaWV3JywgJFZpZXdEaXJlY3RpdmVGaWxsKTsKCiAgZnVuY3Rpb24gcGFyc2VTdGF0ZVJlZihyZWYpIHsKICAgIHZhciBwYXJzZWQgPSByZWYucmVwbGFjZSgvXG4vZywgIiAiKS5tYXRjaCgvXihbXihdKz8pXHMqKFwoKC4qKVwpKT8kLyk7CiAgICBpZiAoIXBhcnNlZCB8fCBwYXJzZWQubGVuZ3RoICE9PSA0KSB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgc3RhdGUgcmVmICciICsgcmVmICsgIiciKTsKICAgIHJldHVybiB7IHN0YXRlOiBwYXJzZWRbMV0sIHBhcmFtRXhwcjogcGFyc2VkWzNdIHx8IG51bGwgfTsKICB9CgogIGZ1bmN0aW9uIHN0YXRlQ29udGV4dChlbCkgewogICAgdmFyIHN0YXRlRGF0YSA9IGVsLnBhcmVudCgpLmluaGVyaXRlZERhdGEoJyR1aVZpZXcnKTsKCiAgICBpZiAoc3RhdGVEYXRhICYmIHN0YXRlRGF0YS5zdGF0ZSAmJiBzdGF0ZURhdGEuc3RhdGUubmFtZSkgewogICAgICByZXR1cm4gc3RhdGVEYXRhLnN0YXRlOwogICAgfQogIH0KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS5kaXJlY3RpdmU6dWktc3JlZgogICAqCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgKiBAcmVxdWlyZXMgJHRpbWVvdXQKICAgKgogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBIGRpcmVjdGl2ZSB0aGF0IGJpbmRzIGEgbGluayAoYDxhPmAgdGFnKSB0byBhIHN0YXRlLiBJZiB0aGUgc3RhdGUgaGFzIGFuIGFzc29jaWF0ZWQKICAgKiBVUkwsIHRoZSBkaXJlY3RpdmUgd2lsbCBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlICYgdXBkYXRlIHRoZSBgaHJlZmAgYXR0cmlidXRlIHZpYQogICAqIHRoZSB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNtZXRob2RzX2hyZWYgJHN0YXRlLmhyZWYoKX0gbWV0aG9kLiBDbGlja2luZwogICAqIHRoZSBsaW5rIHdpbGwgdHJpZ2dlciBhIHN0YXRlIHRyYW5zaXRpb24gd2l0aCBvcHRpb25hbCBwYXJhbWV0ZXJzLgogICAqCiAgICogQWxzbyBtaWRkbGUtY2xpY2tpbmcsIHJpZ2h0LWNsaWNraW5nLCBhbmQgY3RybC1jbGlja2luZyBvbiB0aGUgbGluayB3aWxsIGJlCiAgICogaGFuZGxlZCBuYXRpdmVseSBieSB0aGUgYnJvd3Nlci4KICAgKgogICAqIFlvdSBjYW4gYWxzbyB1c2UgcmVsYXRpdmUgc3RhdGUgcGF0aHMgd2l0aGluIHVpLXNyZWYsIGp1c3QgbGlrZSB0aGUgcmVsYXRpdmUKICAgKiBwYXRocyBwYXNzZWQgdG8gYCRzdGF0ZS5nbygpYC4gWW91IGp1c3QgbmVlZCB0byBiZSBhd2FyZSB0aGF0IHRoZSBwYXRoIGlzIHJlbGF0aXZlCiAgICogdG8gdGhlIHN0YXRlIHRoYXQgdGhlIGxpbmsgbGl2ZXMgaW4sIGluIG90aGVyIHdvcmRzIHRoZSBzdGF0ZSB0aGF0IGxvYWRlZCB0aGUKICAgKiB0ZW1wbGF0ZSBjb250YWluaW5nIHRoZSBsaW5rLgogICAqCiAgICogWW91IGNhbiBzcGVjaWZ5IG9wdGlvbnMgdG8gcGFzcyB0byB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZSNnbyAkc3RhdGUuZ28oKX0KICAgKiB1c2luZyB0aGUgYHVpLXNyZWYtb3B0c2AgYXR0cmlidXRlLiBPcHRpb25zIGFyZSByZXN0cmljdGVkIHRvIGBsb2NhdGlvbmAsIGBpbmhlcml0YCwKICAgKiBhbmQgYHJlbG9hZGAuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIEhlcmUncyBhbiBleGFtcGxlIG9mIGhvdyB5b3UnZCB1c2UgdWktc3JlZiBhbmQgaG93IGl0IHdvdWxkIGNvbXBpbGUuIElmIHlvdSBoYXZlIHRoZQogICAqIGZvbGxvd2luZyB0ZW1wbGF0ZToKICAgKiA8cHJlPgogICAqIDxhIHVpLXNyZWY9ImhvbWUiPkhvbWU8L2E+IHwgPGEgdWktc3JlZj0iYWJvdXQiPkFib3V0PC9hPgogICAqCiAgICogPHVsPgogICAqICAgICA8bGkgbmctcmVwZWF0PSJjb250YWN0IGluIGNvbnRhY3RzIj4KICAgKiAgICAgICAgIDxhIHVpLXNyZWY9ImNvbnRhY3RzLmRldGFpbCh7IGlkOiBjb250YWN0LmlkIH0pIj57eyBjb250YWN0Lm5hbWUgfX08L2E+CiAgICogICAgIDwvbGk+CiAgICogPC91bD4KICAgKiA8L3ByZT4KICAgKgogICAqIFRoZW4gdGhlIGNvbXBpbGVkIGh0bWwgd291bGQgYmUgKGFzc3VtaW5nIEh0bWw1TW9kZSBpcyBvZmYpOgogICAqIDxwcmU+CiAgICogPGEgaHJlZj0iIy9ob21lIiB1aS1zcmVmPSJob21lIj5Ib21lPC9hPiB8IDxhIGhyZWY9IiMvYWJvdXQiIHVpLXNyZWY9ImFib3V0Ij5BYm91dDwvYT4KICAgKgogICAqIDx1bD4KICAgKiAgICAgPGxpIG5nLXJlcGVhdD0iY29udGFjdCBpbiBjb250YWN0cyI+CiAgICogICAgICAgICA8YSBocmVmPSIjL2NvbnRhY3RzLzEiIHVpLXNyZWY9ImNvbnRhY3RzLmRldGFpbCh7IGlkOiBjb250YWN0LmlkIH0pIj5Kb2U8L2E+CiAgICogICAgIDwvbGk+CiAgICogICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gY29udGFjdHMiPgogICAqICAgICAgICAgPGEgaHJlZj0iIy9jb250YWN0cy8yIiB1aS1zcmVmPSJjb250YWN0cy5kZXRhaWwoeyBpZDogY29udGFjdC5pZCB9KSI+QWxpY2U8L2E+CiAgICogICAgIDwvbGk+CiAgICogICAgIDxsaSBuZy1yZXBlYXQ9ImNvbnRhY3QgaW4gY29udGFjdHMiPgogICAqICAgICAgICAgPGEgaHJlZj0iIy9jb250YWN0cy8zIiB1aS1zcmVmPSJjb250YWN0cy5kZXRhaWwoeyBpZDogY29udGFjdC5pZCB9KSI+Qm9iPC9hPgogICAqICAgICA8L2xpPgogICAqIDwvdWw+CiAgICoKICAgKiA8YSB1aS1zcmVmPSJob21lIiB1aS1zcmVmLW9wdHM9IntyZWxvYWQ6IHRydWV9Ij5Ib21lPC9hPgogICAqIDwvcHJlPgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHVpLXNyZWYgJ3N0YXRlTmFtZScgY2FuIGJlIGFueSB2YWxpZCBhYnNvbHV0ZSBvciByZWxhdGl2ZSBzdGF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSB1aS1zcmVmLW9wdHMgb3B0aW9ucyB0byBwYXNzIHRvIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI2dvICRzdGF0ZS5nbygpfQogICAqLwogICRTdGF0ZVJlZkRpcmVjdGl2ZS4kaW5qZWN0ID0gWyckc3RhdGUnLCAnJHRpbWVvdXQnXTsKICBmdW5jdGlvbiAkU3RhdGVSZWZEaXJlY3RpdmUoJHN0YXRlLCAkdGltZW91dCkgewogICAgdmFyIGFsbG93ZWRPcHRpb25zID0gWydsb2NhdGlvbicsICdpbmhlcml0JywgJ3JlbG9hZCddOwoKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgIHJlcXVpcmU6ICc/XnVpU3JlZkFjdGl2ZScsCiAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycywgdWlTcmVmQWN0aXZlKSB7CiAgICAgICAgdmFyIHJlZiA9IHBhcnNlU3RhdGVSZWYoYXR0cnMudWlTcmVmKTsKICAgICAgICB2YXIgcGFyYW1zID0gbnVsbCwgdXJsID0gbnVsbCwgYmFzZSA9IHN0YXRlQ29udGV4dChlbGVtZW50KSB8fCAkc3RhdGUuJGN1cnJlbnQ7CiAgICAgICAgdmFyIGlzRm9ybSA9IGVsZW1lbnRbMF0ubm9kZU5hbWUgPT09ICJGT1JNIjsKICAgICAgICB2YXIgYXR0ciA9IGlzRm9ybSA/ICJhY3Rpb24iIDogImhyZWYiLCBuYXYgPSB0cnVlOwoKICAgICAgICB2YXIgb3B0aW9ucyA9IHsKICAgICAgICAgIHJlbGF0aXZlOiBiYXNlCiAgICAgICAgfTsKICAgICAgICB2YXIgb3B0aW9uc092ZXJyaWRlID0gc2NvcGUuJGV2YWwoYXR0cnMudWlTcmVmT3B0cykgfHwge307CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKGFsbG93ZWRPcHRpb25zLCBmdW5jdGlvbihvcHRpb24pIHsKICAgICAgICAgIGlmIChvcHRpb24gaW4gb3B0aW9uc092ZXJyaWRlKSB7CiAgICAgICAgICAgIG9wdGlvbnNbb3B0aW9uXSA9IG9wdGlvbnNPdmVycmlkZVtvcHRpb25dOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB2YXIgdXBkYXRlID0gZnVuY3Rpb24obmV3VmFsKSB7CiAgICAgICAgICBpZiAobmV3VmFsKSBwYXJhbXMgPSBuZXdWYWw7CiAgICAgICAgICBpZiAoIW5hdikgcmV0dXJuOwoKICAgICAgICAgIHZhciBuZXdIcmVmID0gJHN0YXRlLmhyZWYocmVmLnN0YXRlLCBwYXJhbXMsIG9wdGlvbnMpOwoKICAgICAgICAgIGlmICh1aVNyZWZBY3RpdmUpIHsKICAgICAgICAgICAgdWlTcmVmQWN0aXZlLiQkc2V0U3RhdGVJbmZvKHJlZi5zdGF0ZSwgcGFyYW1zKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghbmV3SHJlZikgewogICAgICAgICAgICBuYXYgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZWxlbWVudFswXVthdHRyXSA9IG5ld0hyZWY7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKHJlZi5wYXJhbUV4cHIpIHsKICAgICAgICAgIHNjb3BlLiR3YXRjaChyZWYucGFyYW1FeHByLCBmdW5jdGlvbihuZXdWYWwsIG9sZFZhbCkgewogICAgICAgICAgICBpZiAobmV3VmFsICE9PSBwYXJhbXMpIHVwZGF0ZShuZXdWYWwpOwogICAgICAgICAgfSwgdHJ1ZSk7CiAgICAgICAgICBwYXJhbXMgPSBzY29wZS4kZXZhbChyZWYucGFyYW1FeHByKTsKICAgICAgICB9CiAgICAgICAgdXBkYXRlKCk7CgogICAgICAgIGlmIChpc0Zvcm0pIHJldHVybjsKCiAgICAgICAgZWxlbWVudC5iaW5kKCJjbGljayIsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgIHZhciBidXR0b24gPSBlLndoaWNoIHx8IGUuYnV0dG9uOwogICAgICAgICAgaWYgKCAhKGJ1dHRvbiA+IDEgfHwgZS5jdHJsS2V5IHx8IGUubWV0YUtleSB8fCBlLnNoaWZ0S2V5IHx8IGVsZW1lbnQuYXR0cigndGFyZ2V0JykpICkgewogICAgICAgICAgICAvLyBIQUNLOiBUaGlzIGlzIHRvIGFsbG93IG5nLWNsaWNrcyB0byBiZSBwcm9jZXNzZWQgYmVmb3JlIHRoZSB0cmFuc2l0aW9uIGlzIGluaXRpYXRlZDoKICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgJHN0YXRlLmdvKHJlZi5zdGF0ZSwgcGFyYW1zLCBvcHRpb25zKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSB1aS5yb3V0ZXIuc3RhdGUuZGlyZWN0aXZlOnVpLXNyZWYtYWN0aXZlCiAgICoKICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlUGFyYW1zCiAgICogQHJlcXVpcmVzICRpbnRlcnBvbGF0ZQogICAqCiAgICogQHJlc3RyaWN0IEEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEEgZGlyZWN0aXZlIHdvcmtpbmcgYWxvbmdzaWRlIHVpLXNyZWYgdG8gYWRkIGNsYXNzZXMgdG8gYW4gZWxlbWVudCB3aGVuIHRoZQogICAqIHJlbGF0ZWQgdWktc3JlZiBkaXJlY3RpdmUncyBzdGF0ZSBpcyBhY3RpdmUsIGFuZCByZW1vdmluZyB0aGVtIHdoZW4gaXQgaXMgaW5hY3RpdmUuCiAgICogVGhlIHByaW1hcnkgdXNlLWNhc2UgaXMgdG8gc2ltcGxpZnkgdGhlIHNwZWNpYWwgYXBwZWFyYW5jZSBvZiBuYXZpZ2F0aW9uIG1lbnVzCiAgICogcmVseWluZyBvbiBgdWktc3JlZmAsIGJ5IGhhdmluZyB0aGUgImFjdGl2ZSIgc3RhdGUncyBtZW51IGJ1dHRvbiBhcHBlYXIgZGlmZmVyZW50LAogICAqIGRpc3Rpbmd1aXNoaW5nIGl0IGZyb20gdGhlIGluYWN0aXZlIG1lbnUgaXRlbXMuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIEdpdmVuIHRoZSBmb2xsb3dpbmcgdGVtcGxhdGU6CiAgICogPHByZT4KICAgKiA8dWw+CiAgICogICA8bGkgdWktc3JlZi1hY3RpdmU9ImFjdGl2ZSIgY2xhc3M9Iml0ZW0iPgogICAqICAgICA8YSBocmVmIHVpLXNyZWY9ImFwcC51c2VyKHt1c2VyOiAnYmlsYm9iYWdnaW5zJ30pIj5AYmlsYm9iYWdnaW5zPC9hPgogICAqICAgPC9saT4KICAgKiA8L3VsPgogICAqIDwvcHJlPgogICAqCiAgICogV2hlbiB0aGUgYXBwIHN0YXRlIGlzICJhcHAudXNlciIsIGFuZCBjb250YWlucyB0aGUgc3RhdGUgcGFyYW1ldGVyICJ1c2VyIiB3aXRoIHZhbHVlICJiaWxib2JhZ2dpbnMiLAogICAqIHRoZSByZXN1bHRpbmcgSFRNTCB3aWxsIGFwcGVhciBhcyAobm90ZSB0aGUgJ2FjdGl2ZScgY2xhc3MpOgogICAqIDxwcmU+CiAgICogPHVsPgogICAqICAgPGxpIHVpLXNyZWYtYWN0aXZlPSJhY3RpdmUiIGNsYXNzPSJpdGVtIGFjdGl2ZSI+CiAgICogICAgIDxhIHVpLXNyZWY9ImFwcC51c2VyKHt1c2VyOiAnYmlsYm9iYWdnaW5zJ30pIiBocmVmPSIvdXNlcnMvYmlsYm9iYWdnaW5zIj5AYmlsYm9iYWdnaW5zPC9hPgogICAqICAgPC9saT4KICAgKiA8L3VsPgogICAqIDwvcHJlPgogICAqCiAgICogVGhlIGNsYXNzIG5hbWUgaXMgaW50ZXJwb2xhdGVkICoqb25jZSoqIGR1cmluZyB0aGUgZGlyZWN0aXZlcyBsaW5rIHRpbWUgKGFueSBmdXJ0aGVyIGNoYW5nZXMgdG8gdGhlCiAgICogaW50ZXJwb2xhdGVkIHZhbHVlIGFyZSBpZ25vcmVkKS4KICAgKgogICAqIE11bHRpcGxlIGNsYXNzZXMgbWF5IGJlIHNwZWNpZmllZCBpbiBhIHNwYWNlLXNlcGFyYXRlZCBmb3JtYXQ6CiAgICogPHByZT4KICAgKiA8dWw+CiAgICogICA8bGkgdWktc3JlZi1hY3RpdmU9J2NsYXNzMSBjbGFzczIgY2xhc3MzJz4KICAgKiAgICAgPGEgdWktc3JlZj0iYXBwLnVzZXIiPmxpbms8L2E+CiAgICogICA8L2xpPgogICAqIDwvdWw+CiAgICogPC9wcmU+CiAgICovCiAgJFN0YXRlQWN0aXZlRGlyZWN0aXZlLiRpbmplY3QgPSBbJyRzdGF0ZScsICckc3RhdGVQYXJhbXMnLCAnJGludGVycG9sYXRlJ107CiAgZnVuY3Rpb24gJFN0YXRlQWN0aXZlRGlyZWN0aXZlKCRzdGF0ZSwgJHN0YXRlUGFyYW1zLCAkaW50ZXJwb2xhdGUpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAiQSIsCiAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRlbGVtZW50JywgJyRhdHRycycsIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycykgewogICAgICAgIHZhciBzdGF0ZSwgcGFyYW1zLCBhY3RpdmVDbGFzczsKCiAgICAgICAgLy8gVGhlcmUgcHJvYmFibHkgaXNuJ3QgbXVjaCBwb2ludCBpbiAkb2JzZXJ2aW5nIHRoaXMKICAgICAgICBhY3RpdmVDbGFzcyA9ICRpbnRlcnBvbGF0ZSgkYXR0cnMudWlTcmVmQWN0aXZlIHx8ICcnLCBmYWxzZSkoJHNjb3BlKTsKCiAgICAgICAgLy8gQWxsb3cgdWlTcmVmIHRvIGNvbW11bmljYXRlIHdpdGggdWlTcmVmQWN0aXZlCiAgICAgICAgdGhpcy4kJHNldFN0YXRlSW5mbyA9IGZ1bmN0aW9uKG5ld1N0YXRlLCBuZXdQYXJhbXMpIHsKICAgICAgICAgIHN0YXRlID0gJHN0YXRlLmdldChuZXdTdGF0ZSwgc3RhdGVDb250ZXh0KCRlbGVtZW50KSk7CiAgICAgICAgICBwYXJhbXMgPSBuZXdQYXJhbXM7CiAgICAgICAgICB1cGRhdGUoKTsKICAgICAgICB9OwoKICAgICAgICAkc2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdWNjZXNzJywgdXBkYXRlKTsKCiAgICAgICAgLy8gVXBkYXRlIHJvdXRlIHN0YXRlCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlKCkgewogICAgICAgICAgaWYgKCRzdGF0ZS4kY3VycmVudC5zZWxmID09PSBzdGF0ZSAmJiBtYXRjaGVzUGFyYW1zKCkpIHsKICAgICAgICAgICAgJGVsZW1lbnQuYWRkQ2xhc3MoYWN0aXZlQ2xhc3MpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJGVsZW1lbnQucmVtb3ZlQ2xhc3MoYWN0aXZlQ2xhc3MpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gbWF0Y2hlc1BhcmFtcygpIHsKICAgICAgICAgIHJldHVybiAhcGFyYW1zIHx8IGVxdWFsRm9yS2V5cyhwYXJhbXMsICRzdGF0ZVBhcmFtcyk7CiAgICAgICAgfQogICAgICB9XQogICAgfTsKICB9CgogIGFuZ3VsYXIubW9kdWxlKCd1aS5yb3V0ZXIuc3RhdGUnKQogICAgLmRpcmVjdGl2ZSgndWlTcmVmJywgJFN0YXRlUmVmRGlyZWN0aXZlKQogICAgLmRpcmVjdGl2ZSgndWlTcmVmQWN0aXZlJywgJFN0YXRlQWN0aXZlRGlyZWN0aXZlKTsKCiAgLyoqCiAgICogQG5nZG9jIGZpbHRlcgogICAqIEBuYW1lIHVpLnJvdXRlci5zdGF0ZS5maWx0ZXI6aXNTdGF0ZQogICAqCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRyYW5zbGF0ZXMgdG8ge0BsaW5rIHVpLnJvdXRlci5zdGF0ZS4kc3RhdGUjbWV0aG9kc19pcyAkc3RhdGUuaXMoInN0YXRlTmFtZSIpfS4KICAgKi8KICAkSXNTdGF0ZUZpbHRlci4kaW5qZWN0ID0gWyckc3RhdGUnXTsKICBmdW5jdGlvbiAkSXNTdGF0ZUZpbHRlcigkc3RhdGUpIHsKICAgIHJldHVybiBmdW5jdGlvbihzdGF0ZSkgewogICAgICByZXR1cm4gJHN0YXRlLmlzKHN0YXRlKTsKICAgIH07CiAgfQoKICAvKioKICAgKiBAbmdkb2MgZmlsdGVyCiAgICogQG5hbWUgdWkucm91dGVyLnN0YXRlLmZpbHRlcjppbmNsdWRlZEJ5U3RhdGUKICAgKgogICAqIEByZXF1aXJlcyB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUcmFuc2xhdGVzIHRvIHtAbGluayB1aS5yb3V0ZXIuc3RhdGUuJHN0YXRlI21ldGhvZHNfaW5jbHVkZXMgJHN0YXRlLmluY2x1ZGVzKCdmdWxsT3JQYXJ0aWFsU3RhdGVOYW1lJyl9LgogICAqLwogICRJbmNsdWRlZEJ5U3RhdGVGaWx0ZXIuJGluamVjdCA9IFsnJHN0YXRlJ107CiAgZnVuY3Rpb24gJEluY2x1ZGVkQnlTdGF0ZUZpbHRlcigkc3RhdGUpIHsKICAgIHJldHVybiBmdW5jdGlvbihzdGF0ZSkgewogICAgICByZXR1cm4gJHN0YXRlLmluY2x1ZGVzKHN0YXRlKTsKICAgIH07CiAgfQoKICBhbmd1bGFyLm1vZHVsZSgndWkucm91dGVyLnN0YXRlJykKICAgIC5maWx0ZXIoJ2lzU3RhdGUnLCAkSXNTdGF0ZUZpbHRlcikKICAgIC5maWx0ZXIoJ2luY2x1ZGVkQnlTdGF0ZScsICRJbmNsdWRlZEJ5U3RhdGVGaWx0ZXIpOwoKICAvKgogICAqIEBuZ2RvYyBvYmplY3QKICAgKiBAbmFtZSB1aS5yb3V0ZXIuY29tcGF0LiRyb3V0ZVByb3ZpZGVyCiAgICoKICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVByb3ZpZGVyCiAgICogQHJlcXVpcmVzIHVpLnJvdXRlci5yb3V0ZXIuJHVybFJvdXRlclByb3ZpZGVyCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBgJHJvdXRlUHJvdmlkZXJgIG9mIHRoZSBgdWkucm91dGVyLmNvbXBhdGAgbW9kdWxlIG92ZXJ3cml0ZXMgdGhlIGV4aXN0aW5nCiAgICogYHJvdXRlUHJvdmlkZXJgIGZyb20gdGhlIGNvcmUuIFRoaXMgaXMgZG9uZSB0byBwcm92aWRlIGNvbXBhdGliaWxpdHkgYmV0d2VlbgogICAqIHRoZSBVSSBSb3V0ZXIgYW5kIHRoZSBjb3JlIHJvdXRlci4KICAgKgogICAqIEl0IGFsc28gcHJvdmlkZXMgYSBgd2hlbigpYCBtZXRob2QgdG8gcmVnaXN0ZXIgcm91dGVzIHRoYXQgbWFwIHRvIGNlcnRhaW4gdXJscy4KICAgKiBCZWhpbmQgdGhlIHNjZW5lcyBpdCBhY3R1YWxseSBkZWxlZ2F0ZXMgZWl0aGVyIHRvIAogICAqIHtAbGluayB1aS5yb3V0ZXIucm91dGVyLiR1cmxSb3V0ZXJQcm92aWRlciAkdXJsUm91dGVyUHJvdmlkZXJ9IG9yIHRvIHRoZSAKICAgKiB7QGxpbmsgdWkucm91dGVyLnN0YXRlLiRzdGF0ZVByb3ZpZGVyICRzdGF0ZVByb3ZpZGVyfSB0byBwb3N0cHJvY2VzcyB0aGUgZ2l2ZW4gCiAgICogcm91dGVyIGRlZmluaXRpb24gb2JqZWN0LgogICAqLwogICRSb3V0ZVByb3ZpZGVyLiRpbmplY3QgPSBbJyRzdGF0ZVByb3ZpZGVyJywgJyR1cmxSb3V0ZXJQcm92aWRlciddOwogIGZ1bmN0aW9uICRSb3V0ZVByb3ZpZGVyKCAgJHN0YXRlUHJvdmlkZXIsICAgICR1cmxSb3V0ZXJQcm92aWRlcikgewoKICAgIHZhciByb3V0ZXMgPSBbXTsKCiAgICBvbkVudGVyUm91dGUuJGluamVjdCA9IFsnJCRzdGF0ZSddOwogICAgZnVuY3Rpb24gb25FbnRlclJvdXRlKCAgICQkc3RhdGUpIHsKICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOiB0cnVlICovCiAgICAgIHRoaXMubG9jYWxzID0gJCRzdGF0ZS5sb2NhbHMuZ2xvYmFsczsKICAgICAgdGhpcy5wYXJhbXMgPSB0aGlzLmxvY2Fscy4kc3RhdGVQYXJhbXM7CiAgICB9CgogICAgZnVuY3Rpb24gb25FeGl0Um91dGUoKSB7CiAgICAgIC8qanNoaW50IHZhbGlkdGhpczogdHJ1ZSAqLwogICAgICB0aGlzLmxvY2FscyA9IG51bGw7CiAgICAgIHRoaXMucGFyYW1zID0gbnVsbDsKICAgIH0KCiAgICB0aGlzLndoZW4gPSB3aGVuOwogICAgLyoKICAgICAqIEBuZ2RvYyBmdW5jdGlvbgogICAgICogQG5hbWUgdWkucm91dGVyLmNvbXBhdC4kcm91dGVQcm92aWRlciN3aGVuCiAgICAgKiBAbWV0aG9kT2YgdWkucm91dGVyLmNvbXBhdC4kcm91dGVQcm92aWRlcgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXJzIGEgcm91dGUgd2l0aCBhIGdpdmVuIHJvdXRlIGRlZmluaXRpb24gb2JqZWN0LiBUaGUgcm91dGUgZGVmaW5pdGlvbgogICAgICogb2JqZWN0IGhhcyB0aGUgc2FtZSBpbnRlcmZhY2UgdGhlIGFuZ3VsYXIgY29yZSByb3V0ZSBkZWZpbml0aW9uIG9iamVjdCBoYXMuCiAgICAgKiAKICAgICAqIEBleGFtcGxlCiAgICAgKiA8cHJlPgogICAgICogdmFyIGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdhcHAnLCBbJ3VpLnJvdXRlci5jb21wYXQnXSk7CiAgICAgKgogICAgICogYXBwLmNvbmZpZyhmdW5jdGlvbiAoJHJvdXRlUHJvdmlkZXIpIHsKICAgICAqICAgJHJvdXRlUHJvdmlkZXIud2hlbignaG9tZScsIHsKICAgICAqICAgICBjb250cm9sbGVyOiBmdW5jdGlvbiAoKSB7IC4uLiB9LAogICAgICogICAgIHRlbXBsYXRlVXJsOiAncGF0aC90by90ZW1wbGF0ZScKICAgICAqICAgfSk7CiAgICAgKiB9KTsKICAgICAqIDwvcHJlPgogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgVVJMIGFzIHN0cmluZwogICAgICogQHBhcmFtIHtvYmplY3R9IHJvdXRlIFJvdXRlIGRlZmluaXRpb24gb2JqZWN0CiAgICAgKgogICAgICogQHJldHVybiB7b2JqZWN0fSAkcm91dGVQcm92aWRlciAtICRyb3V0ZVByb3ZpZGVyIGluc3RhbmNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHdoZW4odXJsLCByb3V0ZSkgewogICAgICAvKmpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KICAgICAgaWYgKHJvdXRlLnJlZGlyZWN0VG8gIT0gbnVsbCkgewogICAgICAgIC8vIFJlZGlyZWN0LCBjb25maWd1cmUgZGlyZWN0bHkgb24gJHVybFJvdXRlclByb3ZpZGVyCiAgICAgICAgdmFyIHJlZGlyZWN0ID0gcm91dGUucmVkaXJlY3RUbywgaGFuZGxlcjsKICAgICAgICBpZiAoaXNTdHJpbmcocmVkaXJlY3QpKSB7CiAgICAgICAgICBoYW5kbGVyID0gcmVkaXJlY3Q7IC8vIGxlYXZlICR1cmxSb3V0ZXJQcm92aWRlciB0byBoYW5kbGUKICAgICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24ocmVkaXJlY3QpKSB7CiAgICAgICAgICAvLyBBZGFwdCB0byAkdXJsUm91dGVyUHJvdmlkZXIgQVBJCiAgICAgICAgICBoYW5kbGVyID0gZnVuY3Rpb24gKHBhcmFtcywgJGxvY2F0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiByZWRpcmVjdChwYXJhbXMsICRsb2NhdGlvbi5wYXRoKCksICRsb2NhdGlvbi5zZWFyY2goKSk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgJ3JlZGlyZWN0VG8nIGluIHdoZW4oKSIpOwogICAgICAgIH0KICAgICAgICAkdXJsUm91dGVyUHJvdmlkZXIud2hlbih1cmwsIGhhbmRsZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFJlZ3VsYXIgcm91dGUsIGNvbmZpZ3VyZSBhcyBzdGF0ZQogICAgICAgICRzdGF0ZVByb3ZpZGVyLnN0YXRlKGluaGVyaXQocm91dGUsIHsKICAgICAgICAgIHBhcmVudDogbnVsbCwKICAgICAgICAgIG5hbWU6ICdyb3V0ZTonICsgZW5jb2RlVVJJQ29tcG9uZW50KHVybCksCiAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgIG9uRW50ZXI6IG9uRW50ZXJSb3V0ZSwKICAgICAgICAgIG9uRXhpdDogb25FeGl0Um91dGUKICAgICAgICB9KSk7CiAgICAgIH0KICAgICAgcm91dGVzLnB1c2gocm91dGUpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvKgogICAgICogQG5nZG9jIG9iamVjdAogICAgICogQG5hbWUgdWkucm91dGVyLmNvbXBhdC4kcm91dGUKICAgICAqCiAgICAgKiBAcmVxdWlyZXMgdWkucm91dGVyLnN0YXRlLiRzdGF0ZQogICAgICogQHJlcXVpcmVzICRyb290U2NvcGUKICAgICAqIEByZXF1aXJlcyAkcm91dGVQYXJhbXMKICAgICAqCiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gcm91dGVzIC0gQXJyYXkgb2YgcmVnaXN0ZXJlZCByb3V0ZXMuCiAgICAgKiBAcHJvcGVydHkge29iamVjdH0gcGFyYW1zIC0gQ3VycmVudCByb3V0ZSBwYXJhbXMgYXMgb2JqZWN0LgogICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGN1cnJlbnQgLSBOYW1lIG9mIHRoZSBjdXJyZW50IHJvdXRlLgogICAgICoKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogVGhlIGAkcm91dGVgIHNlcnZpY2UgcHJvdmlkZXMgaW50ZXJmYWNlcyB0byBhY2Nlc3MgZGVmaW5lZCByb3V0ZXMuIEl0IGFsc28gbGV0J3MKICAgICAqIHlvdSBhY2Nlc3Mgcm91dGUgcGFyYW1zIHRocm91Z2ggYCRyb3V0ZVBhcmFtc2Agc2VydmljZSwgc28geW91IGhhdmUgZnVsbHkKICAgICAqIGNvbnRyb2wgb3ZlciBhbGwgdGhlIHN0dWZmIHlvdSB3b3VsZCBhY3R1YWxseSBnZXQgZnJvbSBhbmd1bGFyJ3MgY29yZSBgJHJvdXRlYAogICAgICogc2VydmljZS4KICAgICAqLwogICAgdGhpcy4kZ2V0ID0gJGdldDsKICAgICRnZXQuJGluamVjdCA9IFsnJHN0YXRlJywgJyRyb290U2NvcGUnLCAnJHJvdXRlUGFyYW1zJ107CiAgICBmdW5jdGlvbiAkZ2V0KCAgICRzdGF0ZSwgICAkcm9vdFNjb3BlLCAgICRyb3V0ZVBhcmFtcykgewoKICAgICAgdmFyICRyb3V0ZSA9IHsKICAgICAgICByb3V0ZXM6IHJvdXRlcywKICAgICAgICBwYXJhbXM6ICRyb3V0ZVBhcmFtcywKICAgICAgICBjdXJyZW50OiB1bmRlZmluZWQKICAgICAgfTsKCiAgICAgIGZ1bmN0aW9uIHN0YXRlQXNSb3V0ZShzdGF0ZSkgewogICAgICAgIHJldHVybiAoc3RhdGUubmFtZSAhPT0gJycpID8gc3RhdGUgOiB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdGFydCcsIGZ1bmN0aW9uIChldiwgdG8sIHRvUGFyYW1zLCBmcm9tLCBmcm9tUGFyYW1zKSB7CiAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCckcm91dGVDaGFuZ2VTdGFydCcsIHN0YXRlQXNSb3V0ZSh0byksIHN0YXRlQXNSb3V0ZShmcm9tKSk7CiAgICAgIH0pOwoKICAgICAgJHJvb3RTY29wZS4kb24oJyRzdGF0ZUNoYW5nZVN1Y2Nlc3MnLCBmdW5jdGlvbiAoZXYsIHRvLCB0b1BhcmFtcywgZnJvbSwgZnJvbVBhcmFtcykgewogICAgICAgICRyb3V0ZS5jdXJyZW50ID0gc3RhdGVBc1JvdXRlKHRvKTsKICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJyRyb3V0ZUNoYW5nZVN1Y2Nlc3MnLCBzdGF0ZUFzUm91dGUodG8pLCBzdGF0ZUFzUm91dGUoZnJvbSkpOwogICAgICAgIGNvcHkodG9QYXJhbXMsICRyb3V0ZS5wYXJhbXMpOwogICAgICB9KTsKCiAgICAgICRyb290U2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VFcnJvcicsIGZ1bmN0aW9uIChldiwgdG8sIHRvUGFyYW1zLCBmcm9tLCBmcm9tUGFyYW1zLCBlcnJvcikgewogICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHJvdXRlQ2hhbmdlRXJyb3InLCBzdGF0ZUFzUm91dGUodG8pLCBzdGF0ZUFzUm91dGUoZnJvbSksIGVycm9yKTsKICAgICAgfSk7CgogICAgICByZXR1cm4gJHJvdXRlOwogICAgfQogIH0KCiAgYW5ndWxhci5tb2R1bGUoJ3VpLnJvdXRlci5jb21wYXQnKQogICAgLnByb3ZpZGVyKCckcm91dGUnLCAkUm91dGVQcm92aWRlcikKICAgIC5kaXJlY3RpdmUoJ25nVmlldycsICRWaWV3RGlyZWN0aXZlKTsKfSkod2luZG93LCB3aW5kb3cuYW5ndWxhcik7Ci8qIQogKiBpb25pYy5idW5kbGUuanMgaXMgYSBjb25jYXRlbmF0aW9uIG9mOgogKiBpb25pYy5qcywgYW5ndWxhci5qcywgYW5ndWxhci1hbmltYXRlLmpzLAogKiBhbmd1bGFyLXNhbml0aXplLmpzLCBhbmd1bGFyLXVpLXJvdXRlci5qcywKICogYW5kIGlvbmljLWFuZ3VsYXIuanMKICovCgovKiEKICogQ29weXJpZ2h0IDIwMTQgRHJpZnR5IENvLgogKiBodHRwOi8vZHJpZnR5LmNvbS8KICoKICogSW9uaWMsIHYxLjAuMC1iZXRhLjExCiAqIEEgcG93ZXJmdWwgSFRNTDUgbW9iaWxlIGFwcCBmcmFtZXdvcmsuCiAqIGh0dHA6Ly9pb25pY2ZyYW1ld29yay5jb20vCiAqCiAqIEJ5IEBtYXhseW5jaCwgQGJlbmpzcGVycnksIEBhZGFtZGJyYWRsZXkgPDMKICoKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLiBQbGVhc2Ugc2VlIExJQ0VOU0UgZm9yIG1vcmUgaW5mb3JtYXRpb24uCiAqCiAqLwoKKGZ1bmN0aW9uKCkgewogIC8qCiAgICogZGVwcmVjYXRlZC5qcwogICAqIGh0dHBzOi8vZ2l0aHViLmNvbS93ZWFyZWZyYWN0YWwvZGVwcmVjYXRlZC8KICAgKiBDb3B5cmlnaHQgKGMpIDIwMTQgRnJhY3RhbCA8Y29udGFjdEB3ZWFyZWZyYWN0YWwuY29tPgogICAqIExpY2Vuc2UgTUlUCiAgICovCi8vSW50ZXJ2YWwgb2JqZWN0CiAgdmFyIGRlcHJlY2F0ZWQgPSB7CiAgICBtZXRob2Q6IGZ1bmN0aW9uKG1zZywgbG9nLCBmbikgewogICAgICB2YXIgY2FsbGVkID0gZmFsc2U7CiAgICAgIHJldHVybiBmdW5jdGlvbiBkZXByZWNhdGVkTWV0aG9kKCl7CiAgICAgICAgaWYgKCFjYWxsZWQpIHsKICAgICAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgICAgICBsb2cobXNnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9LAoKICAgIGZpZWxkOiBmdW5jdGlvbihtc2csIGxvZywgcGFyZW50LCBmaWVsZCwgdmFsKSB7CiAgICAgIHZhciBjYWxsZWQgPSBmYWxzZTsKICAgICAgdmFyIGdldHRlciA9IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKCFjYWxsZWQpIHsKICAgICAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgICAgICBsb2cobXNnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgfTsKICAgICAgdmFyIHNldHRlciA9IGZ1bmN0aW9uKHYpIHsKICAgICAgICBpZiAoIWNhbGxlZCkgewogICAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICAgIGxvZyhtc2cpOwogICAgICAgIH0KICAgICAgICB2YWwgPSB2OwogICAgICAgIHJldHVybiB2OwogICAgICB9OwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocGFyZW50LCBmaWVsZCwgewogICAgICAgIGdldDogZ2V0dGVyLAogICAgICAgIHNldDogc2V0dGVyLAogICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgfSk7CiAgICAgIHJldHVybjsKICAgIH0KICB9OwoKCiAgdmFyIElvbmljTW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ2lvbmljJywgWyduZ0FuaW1hdGUnLCAnbmdTYW5pdGl6ZScsICd1aS5yb3V0ZXInXSksCiAgICBleHRlbmQgPSBhbmd1bGFyLmV4dGVuZCwKICAgIGZvckVhY2ggPSBhbmd1bGFyLmZvckVhY2gsCiAgICBpc0RlZmluZWQgPSBhbmd1bGFyLmlzRGVmaW5lZCwKICAgIGlzU3RyaW5nID0gYW5ndWxhci5pc1N0cmluZywKICAgIGpxTGl0ZSA9IGFuZ3VsYXIuZWxlbWVudDsKCgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljQWN0aW9uU2hlZXQKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIEFjdGlvbiBTaGVldCBpcyBhIHNsaWRlLXVwIHBhbmUgdGhhdCBsZXRzIHRoZSB1c2VyIGNob29zZSBmcm9tIGEgc2V0IG9mIG9wdGlvbnMuCiAgICogRGFuZ2Vyb3VzIG9wdGlvbnMgYXJlIGhpZ2hsaWdodGVkIGluIHJlZCBhbmQgbWFkZSBvYnZpb3VzLgogICAqCiAgICogVGhlcmUgYXJlIGVhc3kgd2F5cyB0byBjYW5jZWwgb3V0IG9mIHRoZSBhY3Rpb24gc2hlZXQsIHN1Y2ggYXMgdGFwcGluZyB0aGUgYmFja2Ryb3Agb3IgZXZlbgogICAqIGhpdHRpbmcgZXNjYXBlIG9uIHRoZSBrZXlib2FyZCBmb3IgZGVza3RvcCB0ZXN0aW5nLgogICAqCiAgICogIVtBY3Rpb24gU2hlZXRdKGh0dHA6Ly9pb25pY2ZyYW1ld29yay5jb20uczMuYW1hem9uYXdzLmNvbS9kb2NzL2NvbnRyb2xsZXJzL2FjdGlvblNoZWV0LmdpZikKICAgKgogICAqIEB1c2FnZQogICAqIFRvIHRyaWdnZXIgYW4gQWN0aW9uIFNoZWV0IGluIHlvdXIgY29kZSwgdXNlIHRoZSAkaW9uaWNBY3Rpb25TaGVldCBzZXJ2aWNlIGluIHlvdXIgYW5ndWxhciBjb250cm9sbGVyczoKICAgKgogICAqIGBgYGpzCiAgICogYW5ndWxhci5tb2R1bGUoJ215U3VwZXJBcHAnLCBbJ2lvbmljJ10pCiAgICogLmNvbnRyb2xsZXIoZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNBY3Rpb25TaGVldCwgJHRpbWVvdXQpIHsKICoKICogIC8vIFRyaWdnZXJlZCBvbiBhIGJ1dHRvbiBjbGljaywgb3Igc29tZSBvdGhlciB0YXJnZXQKICogICRzY29wZS5zaG93ID0gZnVuY3Rpb24oKSB7CiAqCiAqICAgIC8vIFNob3cgdGhlIGFjdGlvbiBzaGVldAogKiAgICB2YXIgaGlkZVNoZWV0ID0gJGlvbmljQWN0aW9uU2hlZXQuc2hvdyh7CiAqICAgICAgYnV0dG9uczogWwogKiAgICAgICAgeyB0ZXh0OiAnPGI+U2hhcmU8L2I+IFRoaXMnIH0sCiAqICAgICAgICB7IHRleHQ6ICdNb3ZlJyB9CiAqICAgICAgXSwKICogICAgICBkZXN0cnVjdGl2ZVRleHQ6ICdEZWxldGUnLAogKiAgICAgIHRpdGxlVGV4dDogJ01vZGlmeSB5b3VyIGFsYnVtJywKICogICAgICBjYW5jZWxUZXh0OiAnQ2FuY2VsJywKICogICAgICBjYW5jZWw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgLy8gYWRkIGNhbmNlbCBjb2RlLi4KICAgICAgICB9LAogKiAgICAgIGJ1dHRvbkNsaWNrZWQ6IGZ1bmN0aW9uKGluZGV4KSB7CiAqICAgICAgICByZXR1cm4gdHJ1ZTsKICogICAgICB9CiAqICAgIH0pOwogKgogKiAgICAvLyBGb3IgZXhhbXBsZSdzIHNha2UsIGhpZGUgdGhlIHNoZWV0IGFmdGVyIHR3byBzZWNvbmRzCiAqICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogKiAgICAgIGhpZGVTaGVldCgpOwogKiAgICB9LCAyMDAwKTsKICoKICogIH07CiAqIH0pOwogICAqIGBgYAogICAqCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5mYWN0b3J5KCckaW9uaWNBY3Rpb25TaGVldCcsIFsKICAgICAgJyRyb290U2NvcGUnLAogICAgICAnJGRvY3VtZW50JywKICAgICAgJyRjb21waWxlJywKICAgICAgJyRhbmltYXRlJywKICAgICAgJyR0aW1lb3V0JywKICAgICAgJyRpb25pY1RlbXBsYXRlTG9hZGVyJywKICAgICAgJyRpb25pY1BsYXRmb3JtJywKICAgICAgZnVuY3Rpb24oJHJvb3RTY29wZSwgJGRvY3VtZW50LCAkY29tcGlsZSwgJGFuaW1hdGUsICR0aW1lb3V0LCAkaW9uaWNUZW1wbGF0ZUxvYWRlciwgJGlvbmljUGxhdGZvcm0pIHsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHNob3c6IGFjdGlvblNoZWV0CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRpb25pY0FjdGlvblNoZWV0I3Nob3cKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBMb2FkIGFuZCByZXR1cm4gYSBuZXcgYWN0aW9uIHNoZWV0LgogICAgICAgICAqCiAgICAgICAgICogQSBuZXcgaXNvbGF0ZWQgc2NvcGUgd2lsbCBiZSBjcmVhdGVkIGZvciB0aGUKICAgICAgICAgKiBhY3Rpb24gc2hlZXQgYW5kIHRoZSBuZXcgZWxlbWVudCB3aWxsIGJlIGFwcGVuZGVkIGludG8gdGhlIGJvZHkuCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBUaGUgb3B0aW9ucyBmb3IgdGhpcyBBY3Rpb25TaGVldC4gUHJvcGVydGllczoKICAgICAgICAgKgogICAgICAgICAqICAtIGBbT2JqZWN0XWAgYGJ1dHRvbnNgIFdoaWNoIGJ1dHRvbnMgdG8gc2hvdy4gIEVhY2ggYnV0dG9uIGlzIGFuIG9iamVjdCB3aXRoIGEgYHRleHRgIGZpZWxkLgogICAgICAgICAqICAtIGB7c3RyaW5nfWAgYHRpdGxlVGV4dGAgVGhlIHRpdGxlIHRvIHNob3cgb24gdGhlIGFjdGlvbiBzaGVldC4KICAgICAgICAgKiAgLSBge3N0cmluZz19YCBgY2FuY2VsVGV4dGAgdGhlIHRleHQgZm9yIGEgJ2NhbmNlbCcgYnV0dG9uIG9uIHRoZSBhY3Rpb24gc2hlZXQuCiAgICAgICAgICogIC0gYHtzdHJpbmc9fWAgYGRlc3RydWN0aXZlVGV4dGAgVGhlIHRleHQgZm9yIGEgJ2Rhbmdlcicgb24gdGhlIGFjdGlvbiBzaGVldC4KICAgICAgICAgKiAgLSBge2Z1bmN0aW9uPX1gIGBjYW5jZWxgIENhbGxlZCBpZiB0aGUgY2FuY2VsIGJ1dHRvbiBpcyBwcmVzc2VkLCB0aGUgYmFja2Ryb3AgaXMgdGFwcGVkIG9yCiAgICAgICAgICogICAgIHRoZSBoYXJkd2FyZSBiYWNrIGJ1dHRvbiBpcyBwcmVzc2VkLgogICAgICAgICAqICAtIGB7ZnVuY3Rpb249fWAgYGJ1dHRvbkNsaWNrZWRgIENhbGxlZCB3aGVuIG9uZSBvZiB0aGUgbm9uLWRlc3RydWN0aXZlIGJ1dHRvbnMgaXMgY2xpY2tlZCwKICAgICAgICAgKiAgICAgd2l0aCB0aGUgaW5kZXggb2YgdGhlIGJ1dHRvbiB0aGF0IHdhcyBjbGlja2VkIGFuZCB0aGUgYnV0dG9uIG9iamVjdC4gUmV0dXJuIHRydWUgdG8gY2xvc2UKICAgICAgICAgKiAgICAgdGhlIGFjdGlvbiBzaGVldCwgb3IgZmFsc2UgdG8ga2VlcCBpdCBvcGVuZWQuCiAgICAgICAgICogIC0gYHtmdW5jdGlvbj19YCBgZGVzdHJ1Y3RpdmVCdXR0b25DbGlja2VkYCBDYWxsZWQgd2hlbiB0aGUgZGVzdHJ1Y3RpdmUgYnV0dG9uIGlzIGNsaWNrZWQuCiAgICAgICAgICogICAgIFJldHVybiB0cnVlIHRvIGNsb3NlIHRoZSBhY3Rpb24gc2hlZXQsIG9yIGZhbHNlIHRvIGtlZXAgaXQgb3BlbmVkLgogICAgICAgICAqICAtICBge2Jvb2xlYW49fWAgYGNhbmNlbE9uU3RhdGVDaGFuZ2VgIFdoZXRoZXIgdG8gY2FuY2VsIHRoZSBhY3Rpb25TaGVldCB3aGVuIG5hdmlnYXRpbmcKICAgICAgICAgKiAgICAgdG8gYSBuZXcgc3RhdGUuICBEZWZhdWx0IHRydWUuCiAgICAgICAgICoKICAgICAgICAgKiBAcmV0dXJucyB7ZnVuY3Rpb259IGBoaWRlU2hlZXRgIEEgZnVuY3Rpb24gd2hpY2gsIHdoZW4gY2FsbGVkLCBoaWRlcyAmIGNhbmNlbHMgdGhlIGFjdGlvbiBzaGVldC4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBhY3Rpb25TaGVldChvcHRzKSB7CiAgICAgICAgICB2YXIgc2NvcGUgPSAkcm9vdFNjb3BlLiRuZXcodHJ1ZSk7CgogICAgICAgICAgYW5ndWxhci5leHRlbmQoc2NvcGUsIHsKICAgICAgICAgICAgY2FuY2VsOiBhbmd1bGFyLm5vb3AsCiAgICAgICAgICAgIGRlc3RydWN0aXZlQnV0dG9uQ2xpY2tlZDogYW5ndWxhci5ub29wLAogICAgICAgICAgICBidXR0b25DbGlja2VkOiBhbmd1bGFyLm5vb3AsCiAgICAgICAgICAgICRkZXJlZ2lzdGVyQmFja0J1dHRvbjogYW5ndWxhci5ub29wLAogICAgICAgICAgICBidXR0b25zOiBbXSwKICAgICAgICAgICAgY2FuY2VsT25TdGF0ZUNoYW5nZTogdHJ1ZQogICAgICAgICAgfSwgb3B0cyB8fCB7fSk7CgoKICAgICAgICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlCiAgICAgICAgICB2YXIgZWxlbWVudCA9IHNjb3BlLmVsZW1lbnQgPSAkY29tcGlsZSgnPGlvbi1hY3Rpb24tc2hlZXQgYnV0dG9ucz0iYnV0dG9ucyI+PC9pb24tYWN0aW9uLXNoZWV0PicpKHNjb3BlKTsKCiAgICAgICAgICAvLyBHcmFiIHRoZSBzaGVldCBlbGVtZW50IGZvciBhbmltYXRpb24KICAgICAgICAgIHZhciBzaGVldEVsID0ganFMaXRlKGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignLmFjdGlvbi1zaGVldC13cmFwcGVyJykpOwoKICAgICAgICAgIHZhciBzdGF0ZUNoYW5nZUxpc3RlbkRvbmUgPSBzY29wZS5jYW5jZWxPblN0YXRlQ2hhbmdlID8KICAgICAgICAgICAgJHJvb3RTY29wZS4kb24oJyRzdGF0ZUNoYW5nZVN1Y2Nlc3MnLCBmdW5jdGlvbigpIHsgc2NvcGUuY2FuY2VsKCk7IH0pIDoKICAgICAgICAgICAgYW5ndWxhci5ub29wOwoKICAgICAgICAgIC8vIHJlbW92ZXMgdGhlIGFjdGlvblNoZWV0IGZyb20gdGhlIHNjcmVlbgogICAgICAgICAgc2NvcGUucmVtb3ZlU2hlZXQgPSBmdW5jdGlvbihkb25lKSB7CiAgICAgICAgICAgIGlmIChzY29wZS5yZW1vdmVkKSByZXR1cm47CgogICAgICAgICAgICBzY29wZS5yZW1vdmVkID0gdHJ1ZTsKICAgICAgICAgICAgc2hlZXRFbC5yZW1vdmVDbGFzcygnYWN0aW9uLXNoZWV0LXVwJyk7CiAgICAgICAgICAgICRkb2N1bWVudFswXS5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGlvbi1zaGVldC1vcGVuJyk7CiAgICAgICAgICAgIHNjb3BlLiRkZXJlZ2lzdGVyQmFja0J1dHRvbigpOwogICAgICAgICAgICBzdGF0ZUNoYW5nZUxpc3RlbkRvbmUoKTsKCiAgICAgICAgICAgICRhbmltYXRlLnJlbW92ZUNsYXNzKGVsZW1lbnQsICdhY3RpdmUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgLy8gc2NvcGUuY2FuY2VsLiRzY29wZSBpcyBkZWZpbmVkIG5lYXIgdGhlIGJvdHRvbQogICAgICAgICAgICAgIHNjb3BlLmNhbmNlbC4kc2NvcGUgPSBudWxsOwogICAgICAgICAgICAgIChkb25lIHx8IGFuZ3VsYXIubm9vcCkoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwoKICAgICAgICAgIHNjb3BlLnNob3dTaGVldCA9IGZ1bmN0aW9uKGRvbmUpIHsKICAgICAgICAgICAgaWYgKHNjb3BlLnJlbW92ZWQpIHJldHVybjsKCiAgICAgICAgICAgICRkb2N1bWVudFswXS5ib2R5LmFwcGVuZENoaWxkKGVsZW1lbnRbMF0pOwogICAgICAgICAgICAkZG9jdW1lbnRbMF0uYm9keS5jbGFzc0xpc3QuYWRkKCdhY3Rpb24tc2hlZXQtb3BlbicpOwoKICAgICAgICAgICAgJGFuaW1hdGUuYWRkQ2xhc3MoZWxlbWVudCwgJ2FjdGl2ZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmIChzY29wZS5yZW1vdmVkKSByZXR1cm47CiAgICAgICAgICAgICAgKGRvbmUgfHwgYW5ndWxhci5ub29wKSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBpZiAoc2NvcGUucmVtb3ZlZCkgcmV0dXJuOwogICAgICAgICAgICAgIHNoZWV0RWwuYWRkQ2xhc3MoJ2FjdGlvbi1zaGVldC11cCcpOwogICAgICAgICAgICB9LCAyMCwgZmFsc2UpOwogICAgICAgICAgfTsKCiAgICAgICAgICAvLyByZWdpc3RlckJhY2tCdXR0b25BY3Rpb24gcmV0dXJucyBhIGNhbGxiYWNrIHRvIGRlcmVnaXN0ZXIgdGhlIGFjdGlvbgogICAgICAgICAgc2NvcGUuJGRlcmVnaXN0ZXJCYWNrQnV0dG9uID0gJGlvbmljUGxhdGZvcm0ucmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uKAogICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAkdGltZW91dChzY29wZS5jYW5jZWwpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9BQ1RJT05fU0hFRVQKICAgICAgICAgICk7CgogICAgICAgICAgLy8gY2FsbGVkIHdoZW4gdGhlIHVzZXIgcHJlc3NlcyB0aGUgY2FuY2VsIGJ1dHRvbgogICAgICAgICAgc2NvcGUuY2FuY2VsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIGFmdGVyIHRoZSBhbmltYXRpb24gaXMgb3V0LCBjYWxsIHRoZSBjYW5jZWwgY2FsbGJhY2sKICAgICAgICAgICAgc2NvcGUucmVtb3ZlU2hlZXQob3B0cy5jYW5jZWwpOwogICAgICAgICAgfTsKCiAgICAgICAgICBzY29wZS5idXR0b25DbGlja2VkID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGJ1dHRvbiBjbGljayBldmVudCByZXR1cm5lZCB0cnVlLCB3aGljaCBtZWFucwogICAgICAgICAgICAvLyB3ZSBjYW4gY2xvc2UgdGhlIGFjdGlvbiBzaGVldAogICAgICAgICAgICBpZiAob3B0cy5idXR0b25DbGlja2VkKGluZGV4LCBvcHRzLmJ1dHRvbnNbaW5kZXhdKSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIHNjb3BlLnJlbW92ZVNoZWV0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CgogICAgICAgICAgc2NvcGUuZGVzdHJ1Y3RpdmVCdXR0b25DbGlja2VkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBkZXN0cnVjdGl2ZSBidXR0b24gY2xpY2sgZXZlbnQgcmV0dXJuZWQgdHJ1ZSwgd2hpY2ggbWVhbnMKICAgICAgICAgICAgLy8gd2UgY2FuIGNsb3NlIHRoZSBhY3Rpb24gc2hlZXQKICAgICAgICAgICAgaWYgKG9wdHMuZGVzdHJ1Y3RpdmVCdXR0b25DbGlja2VkKCkgPT09IHRydWUpIHsKICAgICAgICAgICAgICBzY29wZS5yZW1vdmVTaGVldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwoKICAgICAgICAgIHNjb3BlLnNob3dTaGVldCgpOwoKICAgICAgICAgIC8vIEV4cG9zZSB0aGUgc2NvcGUgb24gJGlvbmljQWN0aW9uU2hlZXQncyByZXR1cm4gdmFsdWUgZm9yIHRoZSBzYWtlCiAgICAgICAgICAvLyBvZiB0ZXN0aW5nIGl0LgogICAgICAgICAgc2NvcGUuY2FuY2VsLiRzY29wZSA9IHNjb3BlOwoKICAgICAgICAgIHJldHVybiBzY29wZS5jYW5jZWw7CiAgICAgICAgfQogICAgICB9XSk7CgoKICBqcUxpdGUucHJvdG90eXBlLmFkZENsYXNzID0gZnVuY3Rpb24oY3NzQ2xhc3NlcykgewogICAgdmFyIHgsIHksIGNzc0NsYXNzLCBlbCwgc3BsaXRDbGFzc2VzLCBleGlzdGluZ0NsYXNzZXM7CiAgICBpZiAoY3NzQ2xhc3NlcyAmJiBjc3NDbGFzc2VzICE9ICduZy1zY29wZScgJiYgY3NzQ2xhc3NlcyAhPSAnbmctaXNvbGF0ZS1zY29wZScpIHsKICAgICAgZm9yKHg9MDsgeDx0aGlzLmxlbmd0aDsgeCsrKSB7CiAgICAgICAgZWwgPSB0aGlzW3hdOwogICAgICAgIGlmKGVsLnNldEF0dHJpYnV0ZSkgewoKICAgICAgICAgIGlmKGNzc0NsYXNzZXMuaW5kZXhPZignICcpIDwgMCkgewogICAgICAgICAgICBlbC5jbGFzc0xpc3QuYWRkKGNzc0NsYXNzZXMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZXhpc3RpbmdDbGFzc2VzID0gKCcgJyArIChlbC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgfHwgJycpICsgJyAnKQogICAgICAgICAgICAgIC5yZXBsYWNlKC9bXG5cdF0vZywgIiAiKTsKICAgICAgICAgICAgc3BsaXRDbGFzc2VzID0gY3NzQ2xhc3Nlcy5zcGxpdCgnICcpOwoKICAgICAgICAgICAgZm9yICh5PTA7IHk8c3BsaXRDbGFzc2VzLmxlbmd0aDsgeSsrKSB7CiAgICAgICAgICAgICAgY3NzQ2xhc3MgPSBzcGxpdENsYXNzZXNbeV0udHJpbSgpOwogICAgICAgICAgICAgIGlmIChleGlzdGluZ0NsYXNzZXMuaW5kZXhPZignICcgKyBjc3NDbGFzcyArICcgJykgPT09IC0xKSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ0NsYXNzZXMgKz0gY3NzQ2xhc3MgKyAnICc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBleGlzdGluZ0NsYXNzZXMudHJpbSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CgogIGpxTGl0ZS5wcm90b3R5cGUucmVtb3ZlQ2xhc3MgPSBmdW5jdGlvbihjc3NDbGFzc2VzKSB7CiAgICB2YXIgeCwgeSwgc3BsaXRDbGFzc2VzLCBjc3NDbGFzcywgZWw7CiAgICBpZiAoY3NzQ2xhc3NlcykgewogICAgICBmb3IoeD0wOyB4PHRoaXMubGVuZ3RoOyB4KyspIHsKICAgICAgICBlbCA9IHRoaXNbeF07CiAgICAgICAgaWYoZWwuZ2V0QXR0cmlidXRlKSB7CiAgICAgICAgICBpZihjc3NDbGFzc2VzLmluZGV4T2YoJyAnKSA8IDApIHsKICAgICAgICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjc3NDbGFzc2VzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNwbGl0Q2xhc3NlcyA9IGNzc0NsYXNzZXMuc3BsaXQoJyAnKTsKCiAgICAgICAgICAgIGZvciAoeT0wOyB5PHNwbGl0Q2xhc3Nlcy5sZW5ndGg7IHkrKykgewogICAgICAgICAgICAgIGNzc0NsYXNzID0gc3BsaXRDbGFzc2VzW3ldOwogICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAoCiAgICAgICAgICAgICAgICAgICgiICIgKyAoZWwuZ2V0QXR0cmlidXRlKCdjbGFzcycpIHx8ICcnKSArICIgIikKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvW1xuXHRdL2csICIgIikKICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgiICIgKyBjc3NDbGFzcy50cmltKCkgKyAiICIsICIgIikpLnRyaW0oKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljQmFja2Ryb3AKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2hvd3MgYW5kIGhpZGVzIGEgYmFja2Ryb3Agb3ZlciB0aGUgVUkuICBBcHBlYXJzIGJlaGluZCBwb3B1cHMsIGxvYWRpbmcsCiAgICogYW5kIG90aGVyIG92ZXJsYXlzLgogICAqCiAgICogT2Z0ZW4sIG11bHRpcGxlIFVJIGNvbXBvbmVudHMgcmVxdWlyZSBhIGJhY2tkcm9wLCBidXQgb25seSBvbmUgYmFja2Ryb3AgaXMKICAgKiBldmVyIG5lZWRlZCBpbiB0aGUgRE9NIGF0IGEgdGltZS4KICAgKgogICAqIFRoZXJlZm9yZSwgZWFjaCBjb21wb25lbnQgdGhhdCByZXF1aXJlcyB0aGUgYmFja2Ryb3AgdG8gYmUgc2hvd24gY2FsbHMKICAgKiBgJGlvbmljQmFja2Ryb3AucmV0YWluKClgIHdoZW4gaXQgd2FudHMgdGhlIGJhY2tkcm9wLCB0aGVuIGAkaW9uaWNCYWNrZHJvcC5yZWxlYXNlKClgCiAgICogd2hlbiBpdCBpcyBkb25lIHdpdGggdGhlIGJhY2tkcm9wLgogICAqCiAgICogRm9yIGVhY2ggdGltZSBgcmV0YWluYCBpcyBjYWxsZWQsIHRoZSBiYWNrZHJvcCB3aWxsIGJlIHNob3duIHVudGlsIGByZWxlYXNlYCBpcyBjYWxsZWQuCiAgICoKICAgKiBGb3IgZXhhbXBsZSwgaWYgYHJldGFpbmAgaXMgY2FsbGVkIHRocmVlIHRpbWVzLCB0aGUgYmFja2Ryb3Agd2lsbCBiZSBzaG93biB1bnRpbCBgcmVsZWFzZWAKICAgKiBpcyBjYWxsZWQgdGhyZWUgdGltZXMuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIGBgYGpzCiAgICogZnVuY3Rpb24gTXlDb250cm9sbGVyKCRzY29wZSwgJGlvbmljQmFja2Ryb3AsICR0aW1lb3V0KSB7CiAqICAgLy9TaG93IGEgYmFja2Ryb3AgZm9yIG9uZSBzZWNvbmQKICogICAkc2NvcGUuYWN0aW9uID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNCYWNrZHJvcC5yZXRhaW4oKTsKICogICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogKiAgICAgICAkaW9uaWNCYWNrZHJvcC5yZWxlYXNlKCk7CiAqICAgICB9LCAxMDAwKTsKICogICB9OwogKiB9CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5mYWN0b3J5KCckaW9uaWNCYWNrZHJvcCcsIFsKICAgICAgJyRkb2N1bWVudCcsICckdGltZW91dCcsCiAgICAgIGZ1bmN0aW9uKCRkb2N1bWVudCwgJHRpbWVvdXQpIHsKCiAgICAgICAgdmFyIGVsID0ganFMaXRlKCc8ZGl2IGNsYXNzPSJiYWNrZHJvcCI+Jyk7CiAgICAgICAgdmFyIGJhY2tkcm9wSG9sZHMgPSAwOwoKICAgICAgICAkZG9jdW1lbnRbMF0uYm9keS5hcHBlbmRDaGlsZChlbFswXSk7CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRpb25pY0JhY2tkcm9wI3JldGFpbgogICAgICAgICAgICogQGRlc2NyaXB0aW9uIFJldGFpbnMgdGhlIGJhY2tkcm9wLgogICAgICAgICAgICovCiAgICAgICAgICByZXRhaW46IHJldGFpbiwKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGlvbmljQmFja2Ryb3AjcmVsZWFzZQogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBSZWxlYXNlcyB0aGUgYmFja2Ryb3AuCiAgICAgICAgICAgKi8KICAgICAgICAgIHJlbGVhc2U6IHJlbGVhc2UsCgogICAgICAgICAgZ2V0RWxlbWVudDogZ2V0RWxlbWVudCwKCiAgICAgICAgICAvLyBleHBvc2VkIGZvciB0ZXN0aW5nCiAgICAgICAgICBfZWxlbWVudDogZWwKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiByZXRhaW4oKSB7CiAgICAgICAgICBpZiAoICgrK2JhY2tkcm9wSG9sZHMpID09PSAxICkgewogICAgICAgICAgICBlbC5hZGRDbGFzcygndmlzaWJsZScpOwogICAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgYmFja2Ryb3BIb2xkcyAmJiBlbC5hZGRDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWxlYXNlKCkgewogICAgICAgICAgaWYgKCAoLS1iYWNrZHJvcEhvbGRzKSA9PT0gMCApIHsKICAgICAgICAgICAgZWwucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAhYmFja2Ryb3BIb2xkcyAmJiBlbC5yZW1vdmVDbGFzcygndmlzaWJsZScpOwogICAgICAgICAgICB9LCA0MDAsIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGdldEVsZW1lbnQoKSB7CiAgICAgICAgICByZXR1cm4gZWw7CiAgICAgICAgfQoKICAgICAgfV0pOwoKICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIElvbmljTW9kdWxlCiAgICAuZmFjdG9yeSgnJGlvbmljQmluZCcsIFsnJHBhcnNlJywgJyRpbnRlcnBvbGF0ZScsIGZ1bmN0aW9uKCRwYXJzZSwgJGludGVycG9sYXRlKSB7CiAgICAgIHZhciBMT0NBTF9SRUdFWFAgPSAvXlxzKihbQD0mXSkoXD8/KVxzKihcdyopXHMqJC87CiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgYXR0cnMsIGJpbmREZWZpbml0aW9uKSB7CiAgICAgICAgZm9yRWFjaChiaW5kRGVmaW5pdGlvbiB8fCB7fSwgZnVuY3Rpb24gKGRlZmluaXRpb24sIHNjb3BlTmFtZSkgewogICAgICAgICAgLy9BZGFwdGVkIGZyb20gYW5ndWxhci5qcyAkY29tcGlsZQogICAgICAgICAgdmFyIG1hdGNoID0gZGVmaW5pdGlvbi5tYXRjaChMT0NBTF9SRUdFWFApIHx8IFtdLAogICAgICAgICAgICBhdHRyTmFtZSA9IG1hdGNoWzNdIHx8IHNjb3BlTmFtZSwKICAgICAgICAgICAgbW9kZSA9IG1hdGNoWzFdLCAvLyBALCA9LCBvciAmCiAgICAgICAgICAgIHBhcmVudEdldCwKICAgICAgICAgICAgdW53YXRjaDsKCiAgICAgICAgICBzd2l0Y2gobW9kZSkgewogICAgICAgICAgICBjYXNlICdAJzoKICAgICAgICAgICAgICBpZiAoIWF0dHJzW2F0dHJOYW1lXSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhdHRycy4kb2JzZXJ2ZShhdHRyTmFtZSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHNjb3BlW3Njb3BlTmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAvLyB3ZSB0cmlnZ2VyIGFuIGludGVycG9sYXRpb24gdG8gZW5zdXJlCiAgICAgICAgICAgICAgLy8gdGhlIHZhbHVlIGlzIHRoZXJlIGZvciB1c2UgaW1tZWRpYXRlbHkKICAgICAgICAgICAgICBpZiAoYXR0cnNbYXR0ck5hbWVdKSB7CiAgICAgICAgICAgICAgICBzY29wZVtzY29wZU5hbWVdID0gJGludGVycG9sYXRlKGF0dHJzW2F0dHJOYW1lXSkoc2NvcGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJz0nOgogICAgICAgICAgICAgIGlmICghYXR0cnNbYXR0ck5hbWVdKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVud2F0Y2ggPSBzY29wZS4kd2F0Y2goYXR0cnNbYXR0ck5hbWVdLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgc2NvcGVbc2NvcGVOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIC8vRGVzdHJveSBwYXJlbnQgc2NvcGUgd2F0Y2hlciB3aGVuIHRoaXMgc2NvcGUgaXMgZGVzdHJveWVkCiAgICAgICAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIHVud2F0Y2gpOwogICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnJic6CiAgICAgICAgICAgICAgLyoganNoaW50IC1XMDQ0ICovCiAgICAgICAgICAgICAgaWYgKGF0dHJzW2F0dHJOYW1lXSAmJiBhdHRyc1thdHRyTmFtZV0ubWF0Y2goUmVnRXhwKHNjb3BlTmFtZSArICdcKC4qP1wpJykpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJyYgZXhwcmVzc2lvbiBiaW5kaW5nICInICsgc2NvcGVOYW1lICsgJyIgbG9va3MgbGlrZSBpdCB3aWxsIHJlY3Vyc2l2ZWx5IGNhbGwgIicgKwogICAgICAgICAgICAgICAgICBhdHRyc1thdHRyTmFtZV0gKyAnIiBhbmQgY2F1c2UgYSBzdGFjayBvdmVyZmxvdyEgUGxlYXNlIGNob29zZSBhIGRpZmZlcmVudCBzY29wZU5hbWUuJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudEdldCA9ICRwYXJzZShhdHRyc1thdHRyTmFtZV0pOwogICAgICAgICAgICAgIHNjb3BlW3Njb3BlTmFtZV0gPSBmdW5jdGlvbihsb2NhbHMpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRHZXQoc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfTsKICAgIH1dKTsKCiAgSW9uaWNNb2R1bGUKICAgIC5mYWN0b3J5KCckY29sbGVjdGlvbkRhdGFTb3VyY2UnLCBbCiAgICAgICckY2FjaGVGYWN0b3J5JywKICAgICAgJyRwYXJzZScsCiAgICAgICckcm9vdFNjb3BlJywKICAgICAgZnVuY3Rpb24oJGNhY2hlRmFjdG9yeSwgJHBhcnNlLCAkcm9vdFNjb3BlKSB7CiAgICAgICAgZnVuY3Rpb24gaGlkZVdpdGhUcmFuc2Zvcm0oZWxlbWVudCkgewogICAgICAgICAgZWxlbWVudC5jc3MoaW9uaWMuQ1NTLlRSQU5TRk9STSwgJ3RyYW5zbGF0ZTNkKC0yMDAwcHgsLTIwMDBweCwwKScpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gQ29sbGVjdGlvblJlcGVhdERhdGFTb3VyY2Uob3B0aW9ucykgewogICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgdGhpcy5zY29wZSA9IG9wdGlvbnMuc2NvcGU7CiAgICAgICAgICB0aGlzLnRyYW5zY2x1ZGVGbiA9IG9wdGlvbnMudHJhbnNjbHVkZUZuOwogICAgICAgICAgdGhpcy50cmFuc2NsdWRlUGFyZW50ID0gb3B0aW9ucy50cmFuc2NsdWRlUGFyZW50OwogICAgICAgICAgdGhpcy5lbGVtZW50ID0gb3B0aW9ucy5lbGVtZW50OwoKICAgICAgICAgIHRoaXMua2V5RXhwciA9IG9wdGlvbnMua2V5RXhwcjsKICAgICAgICAgIHRoaXMubGlzdEV4cHIgPSBvcHRpb25zLmxpc3RFeHByOwogICAgICAgICAgdGhpcy50cmFja0J5RXhwciA9IG9wdGlvbnMudHJhY2tCeUV4cHI7CgogICAgICAgICAgdGhpcy5oZWlnaHRHZXR0ZXIgPSBvcHRpb25zLmhlaWdodEdldHRlcjsKICAgICAgICAgIHRoaXMud2lkdGhHZXR0ZXIgPSBvcHRpb25zLndpZHRoR2V0dGVyOwoKICAgICAgICAgIHRoaXMuZGltZW5zaW9ucyA9IFtdOwogICAgICAgICAgdGhpcy5kYXRhID0gW107CgogICAgICAgICAgaWYgKHRoaXMudHJhY2tCeUV4cHIpIHsKICAgICAgICAgICAgdmFyIHRyYWNrQnlHZXR0ZXIgPSAkcGFyc2UodGhpcy50cmFja0J5RXhwcik7CiAgICAgICAgICAgIHZhciBoYXNoRm5Mb2NhbHMgPSB7JGlkOiBoYXNoS2V5fTsKICAgICAgICAgICAgdGhpcy5pdGVtSGFzaEdldHRlciA9IGZ1bmN0aW9uKGluZGV4LCB2YWx1ZSkgewogICAgICAgICAgICAgIGhhc2hGbkxvY2Fsc1tzZWxmLmtleUV4cHJdID0gdmFsdWU7CiAgICAgICAgICAgICAgaGFzaEZuTG9jYWxzLiRpbmRleCA9IGluZGV4OwogICAgICAgICAgICAgIHJldHVybiB0cmFja0J5R2V0dGVyKHNlbGYuc2NvcGUsIGhhc2hGbkxvY2Fscyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLml0ZW1IYXNoR2V0dGVyID0gZnVuY3Rpb24oaW5kZXgsIHZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGhhc2hLZXkodmFsdWUpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMuYXR0YWNoZWRJdGVtcyA9IHt9OwogICAgICAgICAgdGhpcy5CQUNLVVBfSVRFTVNfTEVOR1RIID0gMTA7CiAgICAgICAgICB0aGlzLmJhY2t1cEl0ZW1zQXJyYXkgPSBbXTsKICAgICAgICB9CiAgICAgICAgQ29sbGVjdGlvblJlcGVhdERhdGFTb3VyY2UucHJvdG90eXBlID0gewogICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuQkFDS1VQX0lURU1TX0xFTkdUSDsgaSsrKSB7CiAgICAgICAgICAgICAgdGhpcy5kZXRhY2hJdGVtKHRoaXMuY3JlYXRlSXRlbSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmRpbWVuc2lvbnMubGVuZ3RoID0gMDsKICAgICAgICAgICAgdGhpcy5kYXRhID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5iYWNrdXBJdGVtc0FycmF5Lmxlbmd0aCA9IDA7CiAgICAgICAgICAgIHRoaXMuYXR0YWNoZWRJdGVtcyA9IHt9OwogICAgICAgICAgfSwKICAgICAgICAgIGNhbGN1bGF0ZURhdGFEaW1lbnNpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGxvY2FscyA9IHt9OwogICAgICAgICAgICB0aGlzLmRpbWVuc2lvbnMgPSB0aGlzLmRhdGEubWFwKGZ1bmN0aW9uKHZhbHVlLCBpbmRleCkgewogICAgICAgICAgICAgIGxvY2Fsc1t0aGlzLmtleUV4cHJdID0gdmFsdWU7CiAgICAgICAgICAgICAgbG9jYWxzLiRpbmRleCA9IGluZGV4OwogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB3aWR0aDogdGhpcy53aWR0aEdldHRlcih0aGlzLnNjb3BlLCBsb2NhbHMpLAogICAgICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLmhlaWdodEdldHRlcih0aGlzLnNjb3BlLCBsb2NhbHMpCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMuZGltZW5zaW9ucyA9IHRoaXMuYmVmb3JlU2libGluZ3MuY29uY2F0KHRoaXMuZGltZW5zaW9ucykuY29uY2F0KHRoaXMuYWZ0ZXJTaWJsaW5ncyk7CiAgICAgICAgICAgIHRoaXMuZGF0YVN0YXJ0SW5kZXggPSB0aGlzLmJlZm9yZVNpYmxpbmdzLmxlbmd0aDsKICAgICAgICAgIH0sCiAgICAgICAgICBjcmVhdGVJdGVtOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSB7fTsKICAgICAgICAgICAgaXRlbS5zY29wZSA9IHRoaXMuc2NvcGUuJG5ldygpOwoKICAgICAgICAgICAgdGhpcy50cmFuc2NsdWRlRm4oaXRlbS5zY29wZSwgZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgICAgICAgICBjbG9uZS5jc3MoJ3Bvc2l0aW9uJywgJ2Fic29sdXRlJyk7CiAgICAgICAgICAgICAgaXRlbS5lbGVtZW50ID0gY2xvbmU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdGhpcy50cmFuc2NsdWRlUGFyZW50LmFwcGVuZChpdGVtLmVsZW1lbnQpOwoKICAgICAgICAgICAgcmV0dXJuIGl0ZW07CiAgICAgICAgICB9LAogICAgICAgICAgZ2V0SXRlbTogZnVuY3Rpb24oaGFzaCkgewogICAgICAgICAgICBpZiAoIChpdGVtID0gdGhpcy5hdHRhY2hlZEl0ZW1zW2hhc2hdKSApIHsKICAgICAgICAgICAgICAvL2RvIG5vdGhpbmcsIHRoZSBpdGVtIGlzIGdvb2QKICAgICAgICAgICAgfSBlbHNlIGlmICggKGl0ZW0gPSB0aGlzLmJhY2t1cEl0ZW1zQXJyYXkucG9wKCkpICkgewogICAgICAgICAgICAgIHJlY29ubmVjdFNjb3BlKGl0ZW0uc2NvcGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGl0ZW0gPSB0aGlzLmNyZWF0ZUl0ZW0oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgICAgIH0sCiAgICAgICAgICBhdHRhY2hJdGVtQXRJbmRleDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5kYXRhW2luZGV4XTsKCiAgICAgICAgICAgIGlmIChpbmRleCA8IHRoaXMuZGF0YVN0YXJ0SW5kZXgpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5iZWZvcmVTaWJsaW5nc1tpbmRleF07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPiB0aGlzLmRhdGEubGVuZ3RoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWZ0ZXJTaWJsaW5nc1tpbmRleCAtIHRoaXMuZGF0YS5sZW5ndGggLSB0aGlzLmRhdGFTdGFydEluZGV4XTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGhhc2ggPSB0aGlzLml0ZW1IYXNoR2V0dGVyKGluZGV4LCB2YWx1ZSk7CiAgICAgICAgICAgIHZhciBpdGVtID0gdGhpcy5nZXRJdGVtKGhhc2gpOwoKICAgICAgICAgICAgaWYgKGl0ZW0uc2NvcGUuJGluZGV4ICE9PSBpbmRleCB8fCBpdGVtLnNjb3BlW3RoaXMua2V5RXhwcl0gIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgaXRlbS5zY29wZVt0aGlzLmtleUV4cHJdID0gdmFsdWU7CiAgICAgICAgICAgICAgaXRlbS5zY29wZS4kaW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICBpdGVtLnNjb3BlLiRmaXJzdCA9IChpbmRleCA9PT0gMCk7CiAgICAgICAgICAgICAgaXRlbS5zY29wZS4kbGFzdCA9IChpbmRleCA9PT0gKHRoaXMuZ2V0TGVuZ3RoKCkgLSAxKSk7CiAgICAgICAgICAgICAgaXRlbS5zY29wZS4kbWlkZGxlID0gIShpdGVtLnNjb3BlLiRmaXJzdCB8fCBpdGVtLnNjb3BlLiRsYXN0KTsKICAgICAgICAgICAgICBpdGVtLnNjb3BlLiRvZGQgPSAhKGl0ZW0uc2NvcGUuJGV2ZW4gPSAoaW5kZXgmMSkgPT09IDApOwoKICAgICAgICAgICAgICAvL1dlIGNoYW5nZWQgdGhlIHNjb3BlLCBzbyBkaWdlc3QgaWYgbmVlZGVkCiAgICAgICAgICAgICAgaWYgKCEkcm9vdFNjb3BlLiQkcGhhc2UpIHsKICAgICAgICAgICAgICAgIGl0ZW0uc2NvcGUuJGRpZ2VzdCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaXRlbS5oYXNoID0gaGFzaDsKICAgICAgICAgICAgdGhpcy5hdHRhY2hlZEl0ZW1zW2hhc2hdID0gaXRlbTsKCiAgICAgICAgICAgIHJldHVybiBpdGVtOwogICAgICAgICAgfSwKICAgICAgICAgIGRlc3Ryb3lJdGVtOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgIGl0ZW0uZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgaXRlbS5zY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICBpdGVtLnNjb3BlID0gbnVsbDsKICAgICAgICAgICAgaXRlbS5lbGVtZW50ID0gbnVsbDsKICAgICAgICAgIH0sCiAgICAgICAgICBkZXRhY2hJdGVtOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmF0dGFjaGVkSXRlbXNbaXRlbS5oYXNoXTsKCiAgICAgICAgICAgIC8vSWYgaXQncyBhbiBvdXRzaWRlIGl0ZW0sIG9ubHkgaGlkZSBpdC4gVGhlc2UgaXRlbXMgYXJlbid0IHBhcnQgb2YgY29sbGVjdGlvbgogICAgICAgICAgICAvL3JlcGVhdCdzIGxpc3QsIG9ubHkgc2l0IG91dHNpZGUKICAgICAgICAgICAgaWYgKGl0ZW0uaXNPdXRzaWRlKSB7CiAgICAgICAgICAgICAgaGlkZVdpdGhUcmFuc2Zvcm0oaXRlbS5lbGVtZW50KTsKCiAgICAgICAgICAgICAgLy8gSWYgd2UgYXJlIGF0IHRoZSBsaW1pdCBvZiBiYWNrdXAgaXRlbXMsIGp1c3QgZ2V0IHJpZCBvZiB0aGUgdGhpcyBlbGVtZW50CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5iYWNrdXBJdGVtc0FycmF5Lmxlbmd0aCA+PSB0aGlzLkJBQ0tVUF9JVEVNU19MRU5HVEgpIHsKICAgICAgICAgICAgICB0aGlzLmRlc3Ryb3lJdGVtKGl0ZW0pOwogICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgYWRkIGl0IHRvIG91ciBiYWNrdXAgaXRlbXMKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmJhY2t1cEl0ZW1zQXJyYXkucHVzaChpdGVtKTsKICAgICAgICAgICAgICBoaWRlV2l0aFRyYW5zZm9ybShpdGVtLmVsZW1lbnQpOwogICAgICAgICAgICAgIC8vRG9uJ3QgLiRkZXN0cm95KCksIGp1c3Qgc3RvcCB3YXRjaGVycyBhbmQgZXZlbnRzIGZpcmluZwogICAgICAgICAgICAgIGRpc2Nvbm5lY3RTY29wZShpdGVtLnNjb3BlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0sCiAgICAgICAgICBnZXRMZW5ndGg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kaW1lbnNpb25zICYmIHRoaXMuZGltZW5zaW9ucy5sZW5ndGggfHwgMDsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXREYXRhOiBmdW5jdGlvbih2YWx1ZSwgYmVmb3JlU2libGluZ3MsIGFmdGVyU2libGluZ3MpIHsKICAgICAgICAgICAgdGhpcy5kYXRhID0gdmFsdWUgfHwgW107CiAgICAgICAgICAgIHRoaXMuYmVmb3JlU2libGluZ3MgPSBiZWZvcmVTaWJsaW5ncyB8fCBbXTsKICAgICAgICAgICAgdGhpcy5hZnRlclNpYmxpbmdzID0gYWZ0ZXJTaWJsaW5ncyB8fCBbXTsKICAgICAgICAgICAgdGhpcy5jYWxjdWxhdGVEYXRhRGltZW5zaW9ucygpOwoKICAgICAgICAgICAgdGhpcy5hZnRlclNpYmxpbmdzLmZvckVhY2goZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgIGl0ZW0uZWxlbWVudC5jc3Moe3Bvc2l0aW9uOiAnYWJzb2x1dGUnLCB0b3A6ICcwJywgbGVmdDogJzAnIH0pOwogICAgICAgICAgICAgIGhpZGVXaXRoVHJhbnNmb3JtKGl0ZW0uZWxlbWVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICB9OwoKICAgICAgICByZXR1cm4gQ29sbGVjdGlvblJlcGVhdERhdGFTb3VyY2U7CiAgICAgIH1dKTsKCiAgLyoqCiAgICogQ29tcHV0ZXMgYSBoYXNoIG9mIGFuICdvYmonLgogICAqIEhhc2ggb2YgYToKICAgKiAgc3RyaW5nIGlzIHN0cmluZwogICAqICBudW1iZXIgaXMgbnVtYmVyIGFzIHN0cmluZwogICAqICBvYmplY3QgaXMgZWl0aGVyIHJlc3VsdCBvZiBjYWxsaW5nICQkaGFzaEtleSBmdW5jdGlvbiBvbiB0aGUgb2JqZWN0IG9yIHVuaXF1ZWx5IGdlbmVyYXRlZCBpZCwKICAgKiAgICAgICAgIHRoYXQgaXMgYWxzbyBhc3NpZ25lZCB0byB0aGUgJCRoYXNoS2V5IHByb3BlcnR5IG9mIHRoZSBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0gb2JqCiAgICogQHJldHVybnMge3N0cmluZ30gaGFzaCBzdHJpbmcgc3VjaCB0aGF0IHRoZSBzYW1lIGlucHV0IHdpbGwgaGF2ZSB0aGUgc2FtZSBoYXNoIHN0cmluZy4KICAgKiAgICAgICAgIFRoZSByZXN1bHRpbmcgc3RyaW5nIGtleSBpcyBpbiAndHlwZTpoYXNoS2V5JyBmb3JtYXQuCiAgICovCiAgZnVuY3Rpb24gaGFzaEtleShvYmopIHsKICAgIHZhciBvYmpUeXBlID0gdHlwZW9mIG9iaiwKICAgICAga2V5OwoKICAgIGlmIChvYmpUeXBlID09ICdvYmplY3QnICYmIG9iaiAhPT0gbnVsbCkgewogICAgICBpZiAodHlwZW9mIChrZXkgPSBvYmouJCRoYXNoS2V5KSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgLy8gbXVzdCBpbnZva2Ugb24gb2JqZWN0IHRvIGtlZXAgdGhlIHJpZ2h0IHRoaXMKICAgICAgICBrZXkgPSBvYmouJCRoYXNoS2V5KCk7CiAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBrZXkgPSBvYmouJCRoYXNoS2V5ID0gaW9uaWMuVXRpbHMubmV4dFVpZCgpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBrZXkgPSBvYmo7CiAgICB9CgogICAgcmV0dXJuIG9ialR5cGUgKyAnOicgKyBrZXk7CiAgfQoKICBmdW5jdGlvbiBkaXNjb25uZWN0U2NvcGUoc2NvcGUpIHsKICAgIGlmIChzY29wZS4kcm9vdCA9PT0gc2NvcGUpIHsKICAgICAgcmV0dXJuOyAvLyB3ZSBjYW4ndCBkaXNjb25uZWN0IHRoZSByb290IG5vZGU7CiAgICB9CiAgICB2YXIgcGFyZW50ID0gc2NvcGUuJHBhcmVudDsKICAgIHNjb3BlLiQkZGlzY29ubmVjdGVkID0gdHJ1ZTsKICAgIC8vIFNlZSBTY29wZS4kZGVzdHJveQogICAgaWYgKHBhcmVudC4kJGNoaWxkSGVhZCA9PT0gc2NvcGUpIHsKICAgICAgcGFyZW50LiQkY2hpbGRIZWFkID0gc2NvcGUuJCRuZXh0U2libGluZzsKICAgIH0KICAgIGlmIChwYXJlbnQuJCRjaGlsZFRhaWwgPT09IHNjb3BlKSB7CiAgICAgIHBhcmVudC4kJGNoaWxkVGFpbCA9IHNjb3BlLiQkcHJldlNpYmxpbmc7CiAgICB9CiAgICBpZiAoc2NvcGUuJCRwcmV2U2libGluZykgewogICAgICBzY29wZS4kJHByZXZTaWJsaW5nLiQkbmV4dFNpYmxpbmcgPSBzY29wZS4kJG5leHRTaWJsaW5nOwogICAgfQogICAgaWYgKHNjb3BlLiQkbmV4dFNpYmxpbmcpIHsKICAgICAgc2NvcGUuJCRuZXh0U2libGluZy4kJHByZXZTaWJsaW5nID0gc2NvcGUuJCRwcmV2U2libGluZzsKICAgIH0KICAgIHNjb3BlLiQkbmV4dFNpYmxpbmcgPSBzY29wZS4kJHByZXZTaWJsaW5nID0gbnVsbDsKICB9CgogIGZ1bmN0aW9uIHJlY29ubmVjdFNjb3BlKHNjb3BlKSB7CiAgICBpZiAoc2NvcGUuJHJvb3QgPT09IHNjb3BlKSB7CiAgICAgIHJldHVybjsgLy8gd2UgY2FuJ3QgZGlzY29ubmVjdCB0aGUgcm9vdCBub2RlOwogICAgfQogICAgaWYgKCFzY29wZS4kJGRpc2Nvbm5lY3RlZCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgcGFyZW50ID0gc2NvcGUuJHBhcmVudDsKICAgIHNjb3BlLiQkZGlzY29ubmVjdGVkID0gZmFsc2U7CiAgICAvLyBTZWUgU2NvcGUuJG5ldyBmb3IgdGhpcyBsb2dpYy4uLgogICAgc2NvcGUuJCRwcmV2U2libGluZyA9IHBhcmVudC4kJGNoaWxkVGFpbDsKICAgIGlmIChwYXJlbnQuJCRjaGlsZEhlYWQpIHsKICAgICAgcGFyZW50LiQkY2hpbGRUYWlsLiQkbmV4dFNpYmxpbmcgPSBzY29wZTsKICAgICAgcGFyZW50LiQkY2hpbGRUYWlsID0gc2NvcGU7CiAgICB9IGVsc2UgewogICAgICBwYXJlbnQuJCRjaGlsZEhlYWQgPSBwYXJlbnQuJCRjaGlsZFRhaWwgPSBzY29wZTsKICAgIH0KICB9CgoKICBJb25pY01vZHVsZQogICAgLmZhY3RvcnkoJyRjb2xsZWN0aW9uUmVwZWF0TWFuYWdlcicsIFsKICAgICAgJyRyb290U2NvcGUnLAogICAgICAnJHRpbWVvdXQnLAogICAgICBmdW5jdGlvbigkcm9vdFNjb3BlLCAkdGltZW91dCkgewogICAgICAgIC8qKgogICAgICAgICAqIFZvY2FidWxhcnk6ICJwcmltYXJ5IiBhbmQgInNlY29uZGFyeSIgc2l6ZS9kaXJlY3Rpb24vcG9zaXRpb24gbWVhbgogICAgICAgICAqICJ5IiBhbmQgIngiIGZvciB2ZXJ0aWNhbCBzY3JvbGxpbmcsIG9yICJ4IiBhbmQgInkiIGZvciBob3Jpem9udGFsIHNjcm9sbGluZy4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBDb2xsZWN0aW9uUmVwZWF0TWFuYWdlcihvcHRpb25zKSB7CiAgICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgICB0aGlzLmRhdGFTb3VyY2UgPSBvcHRpb25zLmRhdGFTb3VyY2U7CiAgICAgICAgICB0aGlzLmVsZW1lbnQgPSBvcHRpb25zLmVsZW1lbnQ7CiAgICAgICAgICB0aGlzLnNjcm9sbFZpZXcgPSBvcHRpb25zLnNjcm9sbFZpZXc7CgogICAgICAgICAgdGhpcy5pc1ZlcnRpY2FsID0gISF0aGlzLnNjcm9sbFZpZXcub3B0aW9ucy5zY3JvbGxpbmdZOwogICAgICAgICAgdGhpcy5yZW5kZXJlZEl0ZW1zID0ge307CiAgICAgICAgICB0aGlzLmRpbWVuc2lvbnMgPSBbXTsKICAgICAgICAgIHRoaXMuc2V0Q3VycmVudEluZGV4KDApOwoKICAgICAgICAgIC8vT3ZlcnJpZGUgc2Nyb2xsdmlldydzIHJlbmRlciBjYWxsYmFjawogICAgICAgICAgdGhpcy5zY3JvbGxWaWV3Ll9fJGNhbGxiYWNrID0gdGhpcy5zY3JvbGxWaWV3Ll9fY2FsbGJhY2s7CiAgICAgICAgICB0aGlzLnNjcm9sbFZpZXcuX19jYWxsYmFjayA9IGFuZ3VsYXIuYmluZCh0aGlzLCB0aGlzLnJlbmRlclNjcm9sbCk7CgogICAgICAgICAgZnVuY3Rpb24gZ2V0Vmlld3BvcnRTaXplKCkgeyByZXR1cm4gc2VsZi52aWV3cG9ydFNpemU7IH0KICAgICAgICAgIC8vU2V0IGdldHRlcnMgYW5kIHNldHRlcnMgdG8gbWF0Y2ggd2hldGhlciB0aGlzIHNjcm9sbHZpZXcgaXMgdmVydGljYWwgb3Igbm90CiAgICAgICAgICBpZiAodGhpcy5pc1ZlcnRpY2FsKSB7CiAgICAgICAgICAgIHRoaXMuc2Nyb2xsVmlldy5vcHRpb25zLmdldENvbnRlbnRIZWlnaHQgPSBnZXRWaWV3cG9ydFNpemU7CgogICAgICAgICAgICB0aGlzLnNjcm9sbFZhbHVlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsVmlldy5fX3Njcm9sbFRvcDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5zY3JvbGxNYXhWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX19tYXhTY3JvbGxUb3A7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2Nyb2xsU2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX19jbGllbnRIZWlnaHQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2Vjb25kYXJ5U2Nyb2xsU2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX19jbGllbnRXaWR0aDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy50cmFuc2Zvcm1TdHJpbmcgPSBmdW5jdGlvbih5LCB4KSB7CiAgICAgICAgICAgICAgcmV0dXJuICd0cmFuc2xhdGUzZCgnK3grJ3B4LCcreSsncHgsMCknOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnByaW1hcnlEaW1lbnNpb24gPSBmdW5jdGlvbihkaW0pIHsKICAgICAgICAgICAgICByZXR1cm4gZGltLmhlaWdodDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5zZWNvbmRhcnlEaW1lbnNpb24gPSBmdW5jdGlvbihkaW0pIHsKICAgICAgICAgICAgICByZXR1cm4gZGltLndpZHRoOwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zY3JvbGxWaWV3Lm9wdGlvbnMuZ2V0Q29udGVudFdpZHRoID0gZ2V0Vmlld3BvcnRTaXplOwoKICAgICAgICAgICAgdGhpcy5zY3JvbGxWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX19zY3JvbGxMZWZ0OwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnNjcm9sbE1heFZhbHVlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsVmlldy5fX21heFNjcm9sbExlZnQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuc2Nyb2xsU2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX19jbGllbnRXaWR0aDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5zZWNvbmRhcnlTY3JvbGxTaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsVmlldy5fX2NsaWVudEhlaWdodDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy50cmFuc2Zvcm1TdHJpbmcgPSBmdW5jdGlvbih4LCB5KSB7CiAgICAgICAgICAgICAgcmV0dXJuICd0cmFuc2xhdGUzZCgnK3grJ3B4LCcreSsncHgsMCknOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnByaW1hcnlEaW1lbnNpb24gPSBmdW5jdGlvbihkaW0pIHsKICAgICAgICAgICAgICByZXR1cm4gZGltLndpZHRoOwogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLnNlY29uZGFyeURpbWVuc2lvbiA9IGZ1bmN0aW9uKGRpbSkgewogICAgICAgICAgICAgIHJldHVybiBkaW0uaGVpZ2h0OwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgQ29sbGVjdGlvblJlcGVhdE1hbmFnZXIucHJvdG90eXBlID0gewogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyZWRJdGVtcyA9IHt9OwogICAgICAgICAgICB0aGlzLnJlbmRlciA9IGFuZ3VsYXIubm9vcDsKICAgICAgICAgICAgdGhpcy5jYWxjdWxhdGVEaW1lbnNpb25zID0gYW5ndWxhci5ub29wOwogICAgICAgICAgICB0aGlzLmRpbWVuc2lvbnMgPSBbXTsKICAgICAgICAgIH0sCgogICAgICAgICAgLyoKICAgICAgICAgICAqIFByZS1jYWxjdWxhdGUgdGhlIHBvc2l0aW9uIG9mIGFsbCBpdGVtcyBpbiB0aGUgZGF0YSBsaXN0LgogICAgICAgICAgICogRG8gdGhpcyB1c2luZyB0aGUgcHJvdmlkZWQgd2lkdGggYW5kIGhlaWdodCAocHJpbWFyeVNpemUgYW5kIHNlY29uZGFyeVNpemUpCiAgICAgICAgICAgKiBwcm92aWRlZCBieSB0aGUgZGF0YVNvdXJjZS4KICAgICAgICAgICAqLwogICAgICAgICAgY2FsY3VsYXRlRGltZW5zaW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAqIEZvciB0aGUgc2FrZSBvZiBleHBsYW5hdGlvbnMgYmVsb3csIHdlJ3JlIGdvaW5nIHRvIHByZXRlbmQgd2UgYXJlIHNjcm9sbGluZwogICAgICAgICAgICAgKiB2ZXJ0aWNhbGx5OiBJdGVtcyBhcmUgbGFpZCBvdXQgd2l0aCBwcmltYXJ5U2l6ZSBiZWluZyBoZWlnaHQsCiAgICAgICAgICAgICAqIHNlY29uZGFyeVNpemUgYmVpbmcgd2lkdGguCiAgICAgICAgICAgICAqLwogICAgICAgICAgICB2YXIgcHJpbWFyeVBvcyA9IDA7CiAgICAgICAgICAgIHZhciBzZWNvbmRhcnlQb3MgPSAwOwogICAgICAgICAgICB2YXIgc2Vjb25kYXJ5U2Nyb2xsU2l6ZSA9IHRoaXMuc2Vjb25kYXJ5U2Nyb2xsU2l6ZSgpOwogICAgICAgICAgICB2YXIgcHJldmlvdXNJdGVtOwoKICAgICAgICAgICAgdGhpcy5kYXRhU291cmNlLmJlZm9yZVNpYmxpbmdzICYmIHRoaXMuZGF0YVNvdXJjZS5iZWZvcmVTaWJsaW5ncy5mb3JFYWNoKGNhbGN1bGF0ZVNpemUsIHRoaXMpOwogICAgICAgICAgICB2YXIgYmVmb3JlU2l6ZSA9IHByaW1hcnlQb3MgKyAocHJldmlvdXNJdGVtID8gcHJldmlvdXNJdGVtLnByaW1hcnlTaXplIDogMCk7CgogICAgICAgICAgICBwcmltYXJ5UG9zID0gc2Vjb25kYXJ5UG9zID0gMDsKICAgICAgICAgICAgcHJldmlvdXNJdGVtID0gbnVsbDsKCgogICAgICAgICAgICB2YXIgZGltZW5zaW9ucyA9IHRoaXMuZGF0YVNvdXJjZS5kaW1lbnNpb25zLm1hcChjYWxjdWxhdGVTaXplLCB0aGlzKTsKICAgICAgICAgICAgdmFyIHRvdGFsU2l6ZSA9IHByaW1hcnlQb3MgKyAocHJldmlvdXNJdGVtID8gcHJldmlvdXNJdGVtLnByaW1hcnlTaXplIDogMCk7CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGJlZm9yZVNpemU6IGJlZm9yZVNpemUsCiAgICAgICAgICAgICAgdG90YWxTaXplOiB0b3RhbFNpemUsCiAgICAgICAgICAgICAgZGltZW5zaW9uczogZGltZW5zaW9ucwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZnVuY3Rpb24gY2FsY3VsYXRlU2l6ZShkaW0pIHsKCiAgICAgICAgICAgICAgLy9FYWNoIGRpbWVuc2lvbiBpcyBhbiBvYmplY3Qge3dpZHRoOiBOdW1iZXIsIGhlaWdodDogTnVtYmVyfSBwcm92aWRlZCBieQogICAgICAgICAgICAgIC8vdGhlIGRhdGFTb3VyY2UKICAgICAgICAgICAgICB2YXIgcmVjdCA9IHsKICAgICAgICAgICAgICAgIC8vR2V0IHRoZSBoZWlnaHQgb3V0IG9mIHRoZSBkaW1lbnNpb24gb2JqZWN0CiAgICAgICAgICAgICAgICBwcmltYXJ5U2l6ZTogdGhpcy5wcmltYXJ5RGltZW5zaW9uKGRpbSksCiAgICAgICAgICAgICAgICAvL01heCBvdXQgdGhlIGl0ZW0ncyB3aWR0aCB0byB0aGUgd2lkdGggb2YgdGhlIHNjcm9sbHZpZXcKICAgICAgICAgICAgICAgIHNlY29uZGFyeVNpemU6IE1hdGgubWluKHRoaXMuc2Vjb25kYXJ5RGltZW5zaW9uKGRpbSksIHNlY29uZGFyeVNjcm9sbFNpemUpCiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgLy9JZiB0aGlzIGlzbid0IHRoZSBmaXJzdCBpdGVtCiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzSXRlbSkgewogICAgICAgICAgICAgICAgLy9Nb3ZlIHRoZSBpdGVtJ3MgeCBwb3NpdGlvbiBvdmVyIGJ5IHRoZSB3aWR0aCBvZiB0aGUgcHJldmlvdXMgaXRlbQogICAgICAgICAgICAgICAgc2Vjb25kYXJ5UG9zICs9IHByZXZpb3VzSXRlbS5zZWNvbmRhcnlTaXplOwogICAgICAgICAgICAgICAgLy9JZiB0aGUgeSBwb3NpdGlvbiBpcyB0aGUgc2FtZSBhcyB0aGUgcHJldmlvdXMgaXRlbSBhbmQKICAgICAgICAgICAgICAgIC8vdGhlIHggcG9zaXRpb24gaXMgYmlnZ2VyIHRoYW4gdGhlIHNjcm9sbGVyJ3Mgd2lkdGgKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0l0ZW0ucHJpbWFyeVBvcyA9PT0gcHJpbWFyeVBvcyAmJgogICAgICAgICAgICAgICAgICBzZWNvbmRhcnlQb3MgKyByZWN0LnNlY29uZGFyeVNpemUgPiBzZWNvbmRhcnlTY3JvbGxTaXplKSB7CiAgICAgICAgICAgICAgICAgIC8vVGhlbiBnbyB0byB0aGUgbmV4dCByb3csIHdpdGggeCBwb3NpdGlvbiAwCiAgICAgICAgICAgICAgICAgIHNlY29uZGFyeVBvcyA9IDA7CiAgICAgICAgICAgICAgICAgIHByaW1hcnlQb3MgKz0gcHJldmlvdXNJdGVtLnByaW1hcnlTaXplOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmVjdC5wcmltYXJ5UG9zID0gcHJpbWFyeVBvczsKICAgICAgICAgICAgICByZWN0LnNlY29uZGFyeVBvcyA9IHNlY29uZGFyeVBvczsKCiAgICAgICAgICAgICAgcHJldmlvdXNJdGVtID0gcmVjdDsKICAgICAgICAgICAgICByZXR1cm4gcmVjdDsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIHJlc2l6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSB0aGlzLmNhbGN1bGF0ZURpbWVuc2lvbnMoKTsKICAgICAgICAgICAgdGhpcy5kaW1lbnNpb25zID0gcmVzdWx0LmRpbWVuc2lvbnM7CiAgICAgICAgICAgIHRoaXMudmlld3BvcnRTaXplID0gcmVzdWx0LnRvdGFsU2l6ZTsKICAgICAgICAgICAgdGhpcy5iZWZvcmVTaXplID0gcmVzdWx0LmJlZm9yZVNpemU7CiAgICAgICAgICAgIHRoaXMuc2V0Q3VycmVudEluZGV4KDApOwogICAgICAgICAgICB0aGlzLnJlbmRlcih0cnVlKTsKICAgICAgICAgICAgaWYgKCF0aGlzLmRhdGFTb3VyY2UuYmFja3VwSXRlbXNBcnJheS5sZW5ndGgpIHsKICAgICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2Uuc2V0dXAoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIC8qCiAgICAgICAgICAgKiBzZXRDdXJyZW50SW5kZXggc2V0cyB0aGUgaW5kZXggaW4gdGhlIGxpc3QgdGhhdCBtYXRjaGVzIHRoZSBzY3JvbGxlcidzIHBvc2l0aW9uLgogICAgICAgICAgICogQWxzbyBzYXZlIHRoZSBwb3NpdGlvbiBpbiB0aGUgc2Nyb2xsZXIgZm9yIG5leHQgYW5kIHByZXZpb3VzIGl0ZW1zIChpZiB0aGV5IGV4aXN0KQogICAgICAgICAgICovCiAgICAgICAgICBzZXRDdXJyZW50SW5kZXg6IGZ1bmN0aW9uKGluZGV4LCBoZWlnaHQpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRQb3MgPSAodGhpcy5kaW1lbnNpb25zW2luZGV4XSB8fCB7fSkucHJpbWFyeVBvcyB8fCAwOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRJbmRleCA9IGluZGV4OwoKICAgICAgICAgICAgdGhpcy5oYXNQcmV2SW5kZXggPSBpbmRleCA+IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmhhc1ByZXZJbmRleCkgewogICAgICAgICAgICAgIHRoaXMucHJldmlvdXNQb3MgPSBNYXRoLm1heCgKICAgICAgICAgICAgICAgICAgY3VycmVudFBvcyAtIHRoaXMuZGltZW5zaW9uc1tpbmRleCAtIDFdLnByaW1hcnlTaXplLAogICAgICAgICAgICAgICAgdGhpcy5kaW1lbnNpb25zW2luZGV4IC0gMV0ucHJpbWFyeVBvcwogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5oYXNOZXh0SW5kZXggPSBpbmRleCArIDEgPCB0aGlzLmRhdGFTb3VyY2UuZ2V0TGVuZ3RoKCk7CiAgICAgICAgICAgIGlmICh0aGlzLmhhc05leHRJbmRleCkgewogICAgICAgICAgICAgIHRoaXMubmV4dFBvcyA9IE1hdGgubWluKAogICAgICAgICAgICAgICAgICBjdXJyZW50UG9zICsgdGhpcy5kaW1lbnNpb25zW2luZGV4ICsgMV0ucHJpbWFyeVNpemUsCiAgICAgICAgICAgICAgICB0aGlzLmRpbWVuc2lvbnNbaW5kZXggKyAxXS5wcmltYXJ5UG9zCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogb3ZlcnJpZGUgdGhlIHNjcm9sbGVyJ3MgcmVuZGVyIGNhbGxiYWNrIHRvIGNoZWNrIGlmIHdlIG5lZWQgdG8KICAgICAgICAgICAqIHJlLXJlbmRlciBvdXIgY29sbGVjdGlvbgogICAgICAgICAgICovCiAgICAgICAgICByZW5kZXJTY3JvbGw6IGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoZnVuY3Rpb24odHJhbnNmb3JtTGVmdCwgdHJhbnNmb3JtVG9wLCB6b29tLCB3YXNSZXNpemUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNWZXJ0aWNhbCkgewogICAgICAgICAgICAgIHRoaXMucmVuZGVySWZOZWVkZWQodHJhbnNmb3JtVG9wKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLnJlbmRlcklmTmVlZGVkKHRyYW5zZm9ybUxlZnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNjcm9sbFZpZXcuX18kY2FsbGJhY2sodHJhbnNmb3JtTGVmdCwgdHJhbnNmb3JtVG9wLCB6b29tLCB3YXNSZXNpemUpOwogICAgICAgICAgfSksCiAgICAgICAgICByZW5kZXJJZk5lZWRlZDogZnVuY3Rpb24oc2Nyb2xsUG9zKSB7CiAgICAgICAgICAgIGlmICgodGhpcy5oYXNOZXh0SW5kZXggJiYgc2Nyb2xsUG9zID49IHRoaXMubmV4dFBvcykgfHwKICAgICAgICAgICAgICAodGhpcy5oYXNQcmV2SW5kZXggJiYgc2Nyb2xsUG9zIDwgdGhpcy5wcmV2aW91c1BvcykpIHsKICAgICAgICAgICAgICAvLyBNYXRoLmFicyh0cmFuc2Zvcm1Qb3MgLSB0aGlzLmxhc3RSZW5kZXJTY3JvbGxWYWx1ZSkgPiAxMDApIHsKICAgICAgICAgICAgICB0aGlzLnJlbmRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgLyoKICAgICAgICAgICAqIGdldEluZGV4Rm9yU2Nyb2xsVmFsdWU6IEdpdmVuIHRoZSBtb3N0IHJlY2VudCBkYXRhIGluZGV4IGFuZCBhIG5ldyBzY3JvbGxWYWx1ZSwKICAgICAgICAgICAqIGZpbmQgdGhlIGRhdGEgaW5kZXggdGhhdCBtYXRjaGVzIHRoYXQgc2Nyb2xsVmFsdWUuCiAgICAgICAgICAgKgogICAgICAgICAgICogU3RyYXRlZ3kgKGlmIHdlIGFyZSBzY3JvbGxpbmcgZG93bik6IGtlZXAgZ29pbmcgZm9yd2FyZCBpbiB0aGUgZGltZW5zaW9ucyBsaXN0LAogICAgICAgICAgICogc3RhcnRpbmcgYXQgdGhlIGdpdmVuIGluZGV4LCB1bnRpbCBhbiBpdGVtIHdpdGggaGVpZ2h0IG1hdGNoaW5nIHRoZSBuZXcgc2Nyb2xsVmFsdWUKICAgICAgICAgICAqIGlzIGZvdW5kLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoaXMgaXMgYSB3aGlsZSBsb29wLiBJbiB0aGUgd29yc3QgY2FzZSBpdCB3aWxsIGhhdmUgdG8gZ28gdGhyb3VnaCB0aGUgd2hvbGUgbGlzdAogICAgICAgICAgICogKGVnIHRvIHNjcm9sbCBmcm9tIHRvcCB0byBib3R0b20pLiAgVGhlIG1vc3QgY29tbW9uIGNhc2UgaXMgdG8gc2Nyb2xsCiAgICAgICAgICAgKiBkb3duIDEtMyBpdGVtcyBhdCBhIHRpbWUuCiAgICAgICAgICAgKgogICAgICAgICAgICogV2hpbGUgdGhpcyBpcyBub3QgYXMgZWZmaWNpZW50IGFzIGl0IGNvdWxkIGJlLCBvcHRpbWl6aW5nIGl0IGdpdmVzIG5vIG5vdGljZWFibGUKICAgICAgICAgICAqIGJlbmVmaXQuICBXZSB3b3VsZCBoYXZlIHRvIHVzZSBhIG5ldyBtZW1vcnktaW50ZW5zaXZlIGRhdGEgc3RydWN0dXJlIGZvciBkaW1lbnNpb25zCiAgICAgICAgICAgKiB0byBmdWxseSBvcHRpbWl6ZSBpdC4KICAgICAgICAgICAqLwogICAgICAgICAgZ2V0SW5kZXhGb3JTY3JvbGxWYWx1ZTogZnVuY3Rpb24oaSwgc2Nyb2xsVmFsdWUpIHsKICAgICAgICAgICAgdmFyIHJlY3Q7CiAgICAgICAgICAgIC8vU2Nyb2xsaW5nIHVwCiAgICAgICAgICAgIGlmIChzY3JvbGxWYWx1ZSA8PSB0aGlzLmRpbWVuc2lvbnNbaV0ucHJpbWFyeVBvcykgewogICAgICAgICAgICAgIHdoaWxlICggKHJlY3QgPSB0aGlzLmRpbWVuc2lvbnNbaSAtIDFdKSAmJiByZWN0LnByaW1hcnlQb3MgPiBzY3JvbGxWYWx1ZSkgewogICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvL1Njcm9sbGluZyBkb3duCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd2hpbGUgKCAocmVjdCA9IHRoaXMuZGltZW5zaW9uc1tpICsgMV0pICYmIHJlY3QucHJpbWFyeVBvcyA8IHNjcm9sbFZhbHVlKSB7CiAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgfSwKICAgICAgICAgIC8qCiAgICAgICAgICAgKiByZW5kZXI6IEZpZ3VyZSBvdXQgdGhlIHNjcm9sbCBwb3NpdGlvbiwgdGhlIGluZGV4IG1hdGNoaW5nIGl0LCBhbmQgdGhlbiB0ZWxsCiAgICAgICAgICAgKiB0aGUgZGF0YSBzb3VyY2UgdG8gcmVuZGVyIHRoZSBjb3JyZWN0IGl0ZW1zIGludG8gdGhlIERPTS4KICAgICAgICAgICAqLwogICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbihzaG91bGRSZWRyYXdBbGwpIHsKICAgICAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICAgICAgICB2YXIgaTsKICAgICAgICAgICAgdmFyIGlzT3V0T2ZCb3VuZHMgPSAoIHRoaXMuY3VycmVudEluZGV4ID49IHRoaXMuZGF0YVNvdXJjZS5nZXRMZW5ndGgoKSApOwogICAgICAgICAgICAvLyBXZSB3YW50IHRvIHJlbW92ZSBhbGwgdGhlIGl0ZW1zIGFuZCByZWRyYXcgZXZlcnl0aGluZyBpZiB3ZSdyZSBvdXQgb2YgYm91bmRzCiAgICAgICAgICAgIC8vIG9yIGEgZmxhZyBpcyBwYXNzZWQgaW4uCiAgICAgICAgICAgIGlmIChpc091dE9mQm91bmRzIHx8IHNob3VsZFJlZHJhd0FsbCkgewogICAgICAgICAgICAgIGZvciAoaSBpbiB0aGlzLnJlbmRlcmVkSXRlbXMpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlSXRlbShpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gSnVzdCBkb24ndCByZW5kZXIgYW55dGhpbmcgaWYgd2UncmUgb3V0IG9mIGJvdW5kcwogICAgICAgICAgICAgIGlmIChpc091dE9mQm91bmRzKSByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciByZWN0OwogICAgICAgICAgICB2YXIgc2Nyb2xsVmFsdWUgPSB0aGlzLnNjcm9sbFZhbHVlKCk7CiAgICAgICAgICAgIC8vIFNjcm9sbCBzaXplID0gaG93IG1hbnkgcGl4ZWxzIGFyZSB2aXNpYmxlIGluIHRoZSBzY3JvbGxlciBhdCBvbmUgdGltZQogICAgICAgICAgICB2YXIgc2Nyb2xsU2l6ZSA9IHRoaXMuc2Nyb2xsU2l6ZSgpOwogICAgICAgICAgICAvLyBXZSB0YWtlIHRoZSBjdXJyZW50IHNjcm9sbCB2YWx1ZSBhbmQgYWRkIGl0IHRvIHRoZSBzY3JvbGxTaXplIHRvIGdldAogICAgICAgICAgICAvLyB3aGF0IHNjcm9sbFZhbHVlIHRoZSBjdXJyZW50IHZpc2libGUgc2Nyb2xsIGFyZWEgZW5kcyBhdC4KICAgICAgICAgICAgdmFyIHNjcm9sbFNpemVFbmQgPSBzY3JvbGxTaXplICsgc2Nyb2xsVmFsdWU7CiAgICAgICAgICAgIC8vIEdldCB0aGUgbmV3IHN0YXJ0IGluZGV4IGZvciBzY3JvbGxpbmcsIGJhc2VkIG9uIHRoZSBjdXJyZW50IHNjcm9sbFZhbHVlIGFuZAogICAgICAgICAgICAvLyB0aGUgbW9zdCByZWNlbnQga25vd24gaW5kZXgKICAgICAgICAgICAgdmFyIHN0YXJ0SW5kZXggPSB0aGlzLmdldEluZGV4Rm9yU2Nyb2xsVmFsdWUodGhpcy5jdXJyZW50SW5kZXgsIHNjcm9sbFZhbHVlKTsKCiAgICAgICAgICAgIC8vIElmIHdlIGFyZW4ndCBvbiB0aGUgZmlyc3QgaXRlbSwgYWRkIG9uZSByb3cgb2YgaXRlbXMgYmVmb3JlIHNvIHRoYXQgd2hlbiB0aGUgdXNlciBpcwogICAgICAgICAgICAvLyBzY3JvbGxpbmcgdXAgaGUgc2VlcyB0aGUgcHJldmlvdXMgaXRlbQogICAgICAgICAgICB2YXIgcmVuZGVyU3RhcnRJbmRleCA9IE1hdGgubWF4KHN0YXJ0SW5kZXggLSAxLCAwKTsKICAgICAgICAgICAgLy8gS2VlcCBhZGRpbmcgaXRlbXMgdG8gdGhlICdleHRyYSByb3cgYWJvdmUnIHVudGlsIHdlIGdldCB0byBhIG5ldyByb3cuCiAgICAgICAgICAgIC8vIFRoaXMgaXMgZm9yIHRoZSBjYXNlIHdoZXJlIHRoZXJlIGFyZSBtdWx0aXBsZSBpdGVtcyBvbiBvbmUgcm93IGFib3ZlCiAgICAgICAgICAgIC8vIHRoZSBjdXJyZW50IGl0ZW07IHdlIHdhbnQgdG8ga2VlcCBhZGRpbmcgaXRlbXMgYWJvdmUgdW50aWwKICAgICAgICAgICAgLy8gYSBuZXcgcm93IGlzIHJlYWNoZWQuCiAgICAgICAgICAgIHdoaWxlIChyZW5kZXJTdGFydEluZGV4ID4gMCAmJgogICAgICAgICAgICAgIChyZWN0ID0gdGhpcy5kaW1lbnNpb25zW3JlbmRlclN0YXJ0SW5kZXhdKSAmJgogICAgICAgICAgICAgIHJlY3QucHJpbWFyeVBvcyA9PT0gdGhpcy5kaW1lbnNpb25zW3N0YXJ0SW5kZXggLSAxXS5wcmltYXJ5UG9zKSB7CiAgICAgICAgICAgICAgcmVuZGVyU3RhcnRJbmRleC0tOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBLZWVwIHJlbmRlcmluZyBpdGVtcywgYWRkaW5nIHRoZW0gdW50aWwgd2UgYXJlIHBhc3QgdGhlIGVuZCBvZiB0aGUgdmlzaWJsZSBzY3JvbGwgYXJlYQogICAgICAgICAgICBpID0gcmVuZGVyU3RhcnRJbmRleDsKICAgICAgICAgICAgd2hpbGUgKChyZWN0ID0gdGhpcy5kaW1lbnNpb25zW2ldKSAmJiAocmVjdC5wcmltYXJ5UG9zIC0gcmVjdC5wcmltYXJ5U2l6ZSA8IHNjcm9sbFNpemVFbmQpKSB7CiAgICAgICAgICAgICAgZG9SZW5kZXIoaSsrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvL0FkZCB0d28gbW9yZSBpdGVtcyBhdCB0aGUgZW5kCiAgICAgICAgICAgIGRvUmVuZGVyKGkrKyk7CiAgICAgICAgICAgIGRvUmVuZGVyKGkpOwogICAgICAgICAgICB2YXIgcmVuZGVyRW5kSW5kZXggPSBpOwoKICAgICAgICAgICAgLy8gUmVtb3ZlIGFueSBpdGVtcyB0aGF0IHdlcmUgcmVuZGVyZWQgYW5kIGFyZW4ndCB2aXNpYmxlIGFueW1vcmUKICAgICAgICAgICAgZm9yIChpIGluIHRoaXMucmVuZGVyZWRJdGVtcykgewogICAgICAgICAgICAgIGlmIChpIDwgcmVuZGVyU3RhcnRJbmRleCB8fCBpID4gcmVuZGVyRW5kSW5kZXgpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlSXRlbShpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc2V0Q3VycmVudEluZGV4KHN0YXJ0SW5kZXgpOwoKICAgICAgICAgICAgZnVuY3Rpb24gZG9SZW5kZXIoZGF0YUluZGV4KSB7CiAgICAgICAgICAgICAgdmFyIHJlY3QgPSBzZWxmLmRpbWVuc2lvbnNbZGF0YUluZGV4XTsKICAgICAgICAgICAgICBpZiAoIXJlY3QpIHsKCiAgICAgICAgICAgICAgfWVsc2UgaWYgKGRhdGFJbmRleCA8IHNlbGYuZGF0YVNvdXJjZS5kYXRhU3RhcnRJbmRleCkgewogICAgICAgICAgICAgICAgLy8gZG8gbm90aGluZwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzZWxmLnJlbmRlckl0ZW0oZGF0YUluZGV4LCByZWN0LnByaW1hcnlQb3MgLSBzZWxmLmJlZm9yZVNpemUsIHJlY3Quc2Vjb25kYXJ5UG9zKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICByZW5kZXJJdGVtOiBmdW5jdGlvbihkYXRhSW5kZXgsIHByaW1hcnlQb3MsIHNlY29uZGFyeVBvcykgewogICAgICAgICAgICAvLyBBdHRhY2ggYW4gaXRlbSwgYW5kIHNldCBpdHMgdHJhbnNmb3JtIHBvc2l0aW9uIHRvIHRoZSByZXF1aXJlZCB2YWx1ZQogICAgICAgICAgICB2YXIgaXRlbSA9IHRoaXMuZGF0YVNvdXJjZS5hdHRhY2hJdGVtQXRJbmRleChkYXRhSW5kZXgpOwogICAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtLmVsZW1lbnQpIHsKICAgICAgICAgICAgICBpZiAoaXRlbS5wcmltYXJ5UG9zICE9PSBwcmltYXJ5UG9zIHx8IGl0ZW0uc2Vjb25kYXJ5UG9zICE9PSBzZWNvbmRhcnlQb3MpIHsKICAgICAgICAgICAgICAgIGl0ZW0uZWxlbWVudC5jc3MoaW9uaWMuQ1NTLlRSQU5TRk9STSwgdGhpcy50cmFuc2Zvcm1TdHJpbmcoCiAgICAgICAgICAgICAgICAgIHByaW1hcnlQb3MsIHNlY29uZGFyeVBvcwogICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICAgICAgICBpdGVtLnByaW1hcnlQb3MgPSBwcmltYXJ5UG9zOwogICAgICAgICAgICAgICAgaXRlbS5zZWNvbmRhcnlQb3MgPSBzZWNvbmRhcnlQb3M7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIC8vIFNhdmUgdGhlIGl0ZW0gaW4gcmVuZGVyZWQgaXRlbXMKICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVkSXRlbXNbZGF0YUluZGV4XSA9IGl0ZW07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gSWYgYW4gaXRlbSBhdCB0aGlzIGluZGV4IGRvZXNuJ3QgZXhpc3QgYW55bW9yZSwgYmUgc3VyZSB0byBkZWxldGUKICAgICAgICAgICAgICAvLyBpdCBmcm9tIHJlbmRlcmVkIGl0ZW1zCiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMucmVuZGVyZWRJdGVtc1tkYXRhSW5kZXhdOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgcmVtb3ZlSXRlbTogZnVuY3Rpb24oZGF0YUluZGV4KSB7CiAgICAgICAgICAgIC8vIERldGFjaCBhIGdpdmVuIGl0ZW0KICAgICAgICAgICAgdmFyIGl0ZW0gPSB0aGlzLnJlbmRlcmVkSXRlbXNbZGF0YUluZGV4XTsKICAgICAgICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAgICAgICBpdGVtLnByaW1hcnlQb3MgPSBpdGVtLnNlY29uZGFyeVBvcyA9IG51bGw7CiAgICAgICAgICAgICAgdGhpcy5kYXRhU291cmNlLmRldGFjaEl0ZW0oaXRlbSk7CiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMucmVuZGVyZWRJdGVtc1tkYXRhSW5kZXhdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIGV4Y2VwdGlvbnMgPSB7J3JlbmRlclNjcm9sbCc6MSwgJ3JlbmRlcklmTmVlZGVkJzoxfTsKICAgICAgICBmb3JFYWNoKENvbGxlY3Rpb25SZXBlYXRNYW5hZ2VyLnByb3RvdHlwZSwgZnVuY3Rpb24obWV0aG9kLCBrZXkpIHsKICAgICAgICAgIGlmIChleGNlcHRpb25zW2tleV0pIHJldHVybjsKICAgICAgICAgIENvbGxlY3Rpb25SZXBlYXRNYW5hZ2VyLnByb3RvdHlwZVtrZXldID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZvaWQgMDsKICAgICAgICAgICAgcmV0dXJuIG1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgfTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIENvbGxlY3Rpb25SZXBlYXRNYW5hZ2VyOwogICAgICB9XSk7CgoKICBmdW5jdGlvbiBkZWxlZ2F0ZVNlcnZpY2UobWV0aG9kTmFtZXMpIHsKICAgIHJldHVybiBbJyRsb2cnLCBmdW5jdGlvbigkbG9nKSB7CiAgICAgIHZhciBkZWxlZ2F0ZSA9IHRoaXM7CgogICAgICB2YXIgaW5zdGFuY2VzID0gdGhpcy5faW5zdGFuY2VzID0gW107CiAgICAgIHRoaXMuX3JlZ2lzdGVySW5zdGFuY2UgPSBmdW5jdGlvbihpbnN0YW5jZSwgaGFuZGxlKSB7CiAgICAgICAgaW5zdGFuY2UuJCRkZWxlZ2F0ZUhhbmRsZSA9IGhhbmRsZTsKICAgICAgICBpbnN0YW5jZXMucHVzaChpbnN0YW5jZSk7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiBkZXJlZ2lzdGVyKCkgewogICAgICAgICAgdmFyIGluZGV4ID0gaW5zdGFuY2VzLmluZGV4T2YoaW5zdGFuY2UpOwogICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgICAgICBpbnN0YW5jZXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9OwoKICAgICAgdGhpcy4kZ2V0QnlIYW5kbGUgPSBmdW5jdGlvbihoYW5kbGUpIHsKICAgICAgICBpZiAoIWhhbmRsZSkgewogICAgICAgICAgcmV0dXJuIGRlbGVnYXRlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEluc3RhbmNlRm9ySGFuZGxlKGhhbmRsZSk7CiAgICAgIH07CgogICAgICAvKgogICAgICAgKiBDcmVhdGVzIGEgbmV3IG9iamVjdCB0aGF0IHdpbGwgaGF2ZSBhbGwgdGhlIG1ldGhvZE5hbWVzIGdpdmVuLAogICAgICAgKiBhbmQgY2FsbCB0aGVtIG9uIHRoZSBnaXZlbiB0aGUgY29udHJvbGxlciBpbnN0YW5jZSBtYXRjaGluZyBnaXZlbgogICAgICAgKiBoYW5kbGUuCiAgICAgICAqIFRoZSByZWFzb24gd2UgZG9uJ3QganVzdCBsZXQgJGdldEJ5SGFuZGxlIHJldHVybiB0aGUgY29udHJvbGxlciBpbnN0YW5jZQogICAgICAgKiBpdHNlbGYgaXMgdGhhdCB0aGUgY29udHJvbGxlciBpbnN0YW5jZSBtaWdodCBub3QgZXhpc3QgeWV0LgogICAgICAgKgogICAgICAgKiBXZSB3YW50IHBlb3BsZSB0byBiZSBhYmxlIHRvIGRvCiAgICAgICAqIGB2YXIgaW5zdGFuY2UgPSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ2ZvbycpYCBvbiBjb250cm9sbGVyCiAgICAgICAqIGluc3RhbnRpYXRpb24sIGJ1dCBvbiBjb250cm9sbGVyIGluc3RhbnRpYXRpb24gYSBjaGlsZCBkaXJlY3RpdmUKICAgICAgICogbWF5IG5vdCBoYXZlIGJlZW4gY29tcGlsZWQgeWV0IQogICAgICAgKgogICAgICAgKiBTbyB0aGlzIGlzIG91ciB3YXkgb2Ygc29sdmluZyB0aGlzIHByb2JsZW06IHdlIGNyZWF0ZSBhbiBvYmplY3QKICAgICAgICogdGhhdCB3aWxsIG9ubHkgdHJ5IHRvIGZldGNoIHRoZSBjb250cm9sbGVyIHdpdGggZ2l2ZW4gaGFuZGxlCiAgICAgICAqIG9uY2UgdGhlIG1ldGhvZHMgYXJlIGFjdHVhbGx5IGNhbGxlZC4KICAgICAgICovCiAgICAgIGZ1bmN0aW9uIEluc3RhbmNlRm9ySGFuZGxlKGhhbmRsZSkgewogICAgICAgIHRoaXMuaGFuZGxlID0gaGFuZGxlOwogICAgICB9CiAgICAgIG1ldGhvZE5hbWVzLmZvckVhY2goZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICAgIEluc3RhbmNlRm9ySGFuZGxlLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGhhbmRsZSA9IHRoaXMuaGFuZGxlOwogICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICB2YXIgbWF0Y2hpbmdJbnN0YW5jZXNGb3VuZCA9IDA7CiAgICAgICAgICB2YXIgZmluYWxSZXN1bHQ7CiAgICAgICAgICB2YXIgcmVzdWx0OwoKICAgICAgICAgIC8vVGhpcyBsb2dpYyBpcyByZXBlYXRlZCBiZWxvdzsgd2UgY291bGQgZmFjdG9yIHNvbWUgb2YgaXQgb3V0IHRvIGEgZnVuY3Rpb24KICAgICAgICAgIC8vYnV0IGRvbid0IGJlY2F1c2UgaXQgbGV0cyB0aGlzIG1ldGhvZCBiZSBtb3JlIHBlcmZvcm1hbnQgKG9uZSBsb29wIHZlcnN1cyAyKQogICAgICAgICAgaW5zdGFuY2VzLmZvckVhY2goZnVuY3Rpb24oaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKGluc3RhbmNlLiQkZGVsZWdhdGVIYW5kbGUgPT09IGhhbmRsZSkgewogICAgICAgICAgICAgIG1hdGNoaW5nSW5zdGFuY2VzRm91bmQrKzsKICAgICAgICAgICAgICByZXN1bHQgPSBpbnN0YW5jZVttZXRob2ROYW1lXS5hcHBseShpbnN0YW5jZSwgYXJncyk7CiAgICAgICAgICAgICAgLy9Pbmx5IHJldHVybiB0aGUgdmFsdWUgZnJvbSB0aGUgZmlyc3QgY2FsbAogICAgICAgICAgICAgIGlmIChtYXRjaGluZ0luc3RhbmNlc0ZvdW5kID09PSAxKSB7CiAgICAgICAgICAgICAgICBmaW5hbFJlc3VsdCA9IHJlc3VsdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIGlmICghbWF0Y2hpbmdJbnN0YW5jZXNGb3VuZCkgewogICAgICAgICAgICByZXR1cm4gJGxvZy53YXJuKAogICAgICAgICAgICAgICAgJ0RlbGVnYXRlIGZvciBoYW5kbGUgIicrdGhpcy5oYW5kbGUrJyIgY291bGQgbm90IGZpbmQgYSAnICsKICAgICAgICAgICAgICAgICdjb3JyZXNwb25kaW5nIGVsZW1lbnQgd2l0aCBkZWxlZ2F0ZS1oYW5kbGU9IicrdGhpcy5oYW5kbGUrJyIhICcgKwogICAgICAgICAgICAgICAgbWV0aG9kTmFtZSArICcoKSB3YXMgbm90IGNhbGxlZCFcbicgKwogICAgICAgICAgICAgICAgJ1Bvc3NpYmxlIGNhdXNlOiBJZiB5b3UgYXJlIGNhbGxpbmcgJyArIG1ldGhvZE5hbWUgKyAnKCkgaW1tZWRpYXRlbHksIGFuZCAnICsKICAgICAgICAgICAgICAgICd5b3VyIGVsZW1lbnQgd2l0aCBkZWxlZ2F0ZS1oYW5kbGU9IicgKyB0aGlzLmhhbmRsZSArICciIGlzIGEgY2hpbGQgb2YgeW91ciAnICsKICAgICAgICAgICAgICAgICdjb250cm9sbGVyLCB0aGVuIHlvdXIgZWxlbWVudCBtYXkgbm90IGJlIGNvbXBpbGVkIHlldC4gUHV0IGEgJHRpbWVvdXQgJyArCiAgICAgICAgICAgICAgICAnYXJvdW5kIHlvdXIgY2FsbCB0byAnICsgbWV0aG9kTmFtZSArICcoKSBhbmQgdHJ5IGFnYWluLicKICAgICAgICAgICAgKTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gZmluYWxSZXN1bHQ7CiAgICAgICAgfTsKICAgICAgICBkZWxlZ2F0ZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICB2YXIgZmluYWxSZXN1bHQ7CiAgICAgICAgICB2YXIgcmVzdWx0OwoKICAgICAgICAgIC8vVGhpcyBsb2dpYyBpcyByZXBlYXRlZCBhYm92ZQogICAgICAgICAgaW5zdGFuY2VzLmZvckVhY2goZnVuY3Rpb24oaW5zdGFuY2UsIGluZGV4KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGluc3RhbmNlW21ldGhvZE5hbWVdLmFwcGx5KGluc3RhbmNlLCBhcmdzKTsKICAgICAgICAgICAgLy9Pbmx5IHJldHVybiB0aGUgdmFsdWUgZnJvbSB0aGUgZmlyc3QgY2FsbAogICAgICAgICAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgICAgICAgICBmaW5hbFJlc3VsdCA9IHJlc3VsdDsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgcmV0dXJuIGZpbmFsUmVzdWx0OwogICAgICAgIH07CgogICAgICAgIGZ1bmN0aW9uIGNhbGxNZXRob2QoaW5zdGFuY2VzVG9Vc2UsIG1ldGhvZE5hbWUsIGFyZ3MpIHsKICAgICAgICAgIHZhciBmaW5hbFJlc3VsdDsKICAgICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgICBpbnN0YW5jZXNUb1VzZS5mb3JFYWNoKGZ1bmN0aW9uKGluc3RhbmNlLCBpbmRleCkgewogICAgICAgICAgICByZXN1bHQgPSBpbnN0YW5jZVttZXRob2ROYW1lXS5hcHBseShpbnN0YW5jZSwgYXJncyk7CiAgICAgICAgICAgIC8vTWFrZSBpdCBzbyB0aGUgZmlyc3QgcmVzdWx0IGlzIHRoZSBvbmUgcmV0dXJuZWQKICAgICAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7CiAgICAgICAgICAgICAgZmluYWxSZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGZpbmFsUmVzdWx0OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9XTsKICB9CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljR2VzdHVyZQogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVzY3JpcHRpb24gQW4gYW5ndWxhciBzZXJ2aWNlIGV4cG9zaW5nIGlvbmljCiAgICoge0BsaW5rIGlvbmljLnV0aWxpdHk6aW9uaWMuRXZlbnRDb250cm9sbGVyfSdzIGdlc3R1cmVzLgogICAqLwogIElvbmljTW9kdWxlCiAgICAuZmFjdG9yeSgnJGlvbmljR2VzdHVyZScsIFtmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgJGlvbmljR2VzdHVyZSNvbgogICAgICAgICAqIEBkZXNjcmlwdGlvbiBBZGQgYW4gZXZlbnQgbGlzdGVuZXIgZm9yIGEgZ2VzdHVyZSBvbiBhbiBlbGVtZW50LiBTZWUge0BsaW5rIGlvbmljLnV0aWxpdHk6aW9uaWMuRXZlbnRDb250cm9sbGVyI29uR2VzdHVyZX0uCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50VHlwZSBUaGUgZ2VzdHVyZSBldmVudCB0byBsaXN0ZW4gZm9yLgogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oZSl9IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGdlc3R1cmUKICAgICAgICAgKiBoYXBwZW5zLgogICAgICAgICAqIEBwYXJhbSB7ZWxlbWVudH0gJGVsZW1lbnQgVGhlIGFuZ3VsYXIgZWxlbWVudCB0byBsaXN0ZW4gZm9yIHRoZSBldmVudCBvbi4KICAgICAgICAgKiBAcmV0dXJucyB7aW9uaWMuR2VzdHVyZX0gVGhlIGdlc3R1cmUgb2JqZWN0ICh1c2UgdGhpcyB0byByZW1vdmUgdGhlIGdlc3R1cmUgbGF0ZXIgb24pLgogICAgICAgICAqLwogICAgICAgIG9uOiBmdW5jdGlvbihldmVudFR5cGUsIGNiLCAkZWxlbWVudCkgewogICAgICAgICAgcmV0dXJuIHdpbmRvdy5pb25pYy5vbkdlc3R1cmUoZXZlbnRUeXBlLCBjYiwgJGVsZW1lbnRbMF0pOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRpb25pY0dlc3R1cmUjb2ZmCiAgICAgICAgICogQGRlc2NyaXB0aW9uIFJlbW92ZSBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBnZXN0dXJlIG9uIGFuIGVsZW1lbnQuIFNlZSB7QGxpbmsgaW9uaWMudXRpbGl0eTppb25pYy5FdmVudENvbnRyb2xsZXIjb2ZmR2VzdHVyZX0uCiAgICAgICAgICogQHBhcmFtIHtpb25pYy5HZXN0dXJlfSBnZXN0dXJlIFRoZSBnZXN0dXJlIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQuCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50VHlwZSBUaGUgZ2VzdHVyZSBldmVudCB0byByZW1vdmUgdGhlIGxpc3RlbmVyIGZvci4KICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9uKGUpfSBjYWxsYmFjayBUaGUgbGlzdGVuZXIgdG8gcmVtb3ZlLgogICAgICAgICAqLwogICAgICAgIG9mZjogZnVuY3Rpb24oZ2VzdHVyZSwgZXZlbnRUeXBlLCBjYikgewogICAgICAgICAgcmV0dXJuIHdpbmRvdy5pb25pYy5vZmZHZXN0dXJlKGdlc3R1cmUsIGV2ZW50VHlwZSwgY2IpOwogICAgICAgIH0KICAgICAgfTsKICAgIH1dKTsKCgogIHZhciBMT0FESU5HX1RQTCA9CiAgICAnPGRpdiBjbGFzcz0ibG9hZGluZy1jb250YWluZXIiPicgKwogICAgJzxkaXYgY2xhc3M9ImxvYWRpbmciPicgKwogICAgJzwvZGl2PicgKwogICAgJzwvZGl2Pic7CgogIHZhciBMT0FESU5HX0hJREVfREVQUkVDQVRFRCA9ICckaW9uaWNMb2FkaW5nIGluc3RhbmNlLmhpZGUoKSBoYXMgYmVlbiBkZXByZWNhdGVkLiBVc2UgJGlvbmljTG9hZGluZy5oaWRlKCkuJzsKICB2YXIgTE9BRElOR19TSE9XX0RFUFJFQ0FURUQgPSAnJGlvbmljTG9hZGluZyBpbnN0YW5jZS5zaG93KCkgaGFzIGJlZW4gZGVwcmVjYXRlZC4gVXNlICRpb25pY0xvYWRpbmcuc2hvdygpLic7CiAgdmFyIExPQURJTkdfU0VUX0RFUFJFQ0FURUQgPSAnJGlvbmljTG9hZGluZyBpbnN0YW5jZS5zZXRDb250ZW50KCkgaGFzIGJlZW4gZGVwcmVjYXRlZC4gVXNlICRpb25pY0xvYWRpbmcuc2hvdyh7IHRlbXBsYXRlOiBcJ215IGNvbnRlbnRcJyB9KS4nOwoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRpb25pY0xvYWRpbmcKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICogQW4gb3ZlcmxheSB0aGF0IGNhbiBiZSB1c2VkIHRvIGluZGljYXRlIGFjdGl2aXR5IHdoaWxlIGJsb2NraW5nIHVzZXIKICAgKiBpbnRlcmFjdGlvbi4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGpzCiAgICogYW5ndWxhci5tb2R1bGUoJ0xvYWRpbmdBcHAnLCBbJ2lvbmljJ10pCiAgICogLmNvbnRyb2xsZXIoJ0xvYWRpbmdDdHJsJywgZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNMb2FkaW5nKSB7CiAqICAgJHNjb3BlLnNob3cgPSBmdW5jdGlvbigpIHsKICogICAgICRpb25pY0xvYWRpbmcuc2hvdyh7CiAqICAgICAgIHRlbXBsYXRlOiAnTG9hZGluZy4uLicKICogICAgIH0pOwogKiAgIH07CiAqICAgJHNjb3BlLmhpZGUgPSBmdW5jdGlvbigpewogKiAgICAgJGlvbmljTG9hZGluZy5oaWRlKCk7CiAqICAgfTsKICogfSk7CiAgICogYGBgCiAgICovCiAgLyoqCiAgICogQG5nZG9jIG9iamVjdAogICAqIEBuYW1lICRpb25pY0xvYWRpbmdDb25maWcKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICogU2V0IHRoZSBkZWZhdWx0IG9wdGlvbnMgdG8gYmUgcGFzc2VkIHRvIHRoZSB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNMb2FkaW5nfSBzZXJ2aWNlLgogICAqCiAgICogQHVzYWdlCiAgICogYGBganMKICAgKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ215QXBwJywgWydpb25pYyddKQogICAqIGFwcC5jb25zdGFudCgnJGlvbmljTG9hZGluZ0NvbmZpZycsIHsKICogICB0ZW1wbGF0ZTogJ0RlZmF1bHQgTG9hZGluZyBUZW1wbGF0ZS4uLicKICogfSk7CiAgICogYXBwLmNvbnRyb2xsZXIoJ0FwcEN0cmwnLCBmdW5jdGlvbigkc2NvcGUsICRpb25pY0xvYWRpbmcpIHsKICogICAkc2NvcGUuc2hvd0xvYWRpbmcgPSBmdW5jdGlvbigpIHsKICogICAgICRpb25pY0xvYWRpbmcuc2hvdygpOyAvL29wdGlvbnMgZGVmYXVsdCB0byB2YWx1ZXMgaW4gJGlvbmljTG9hZGluZ0NvbmZpZwogKiAgIH07CiAqIH0pOwogICAqIGBgYAogICAqLwogIElvbmljTW9kdWxlCiAgICAuY29uc3RhbnQoJyRpb25pY0xvYWRpbmdDb25maWcnLCB7CiAgICAgIHRlbXBsYXRlOiAnPGkgY2xhc3M9Imlvbi1sb2FkaW5nLWQiPjwvaT4nCiAgICB9KQogICAgLmZhY3RvcnkoJyRpb25pY0xvYWRpbmcnLCBbCiAgICAgICckaW9uaWNMb2FkaW5nQ29uZmlnJywKICAgICAgJyRkb2N1bWVudCcsCiAgICAgICckaW9uaWNUZW1wbGF0ZUxvYWRlcicsCiAgICAgICckaW9uaWNCYWNrZHJvcCcsCiAgICAgICckdGltZW91dCcsCiAgICAgICckcScsCiAgICAgICckbG9nJywKICAgICAgJyRjb21waWxlJywKICAgICAgJyRpb25pY1BsYXRmb3JtJywKICAgICAgZnVuY3Rpb24oJGlvbmljTG9hZGluZ0NvbmZpZywgJGRvY3VtZW50LCAkaW9uaWNUZW1wbGF0ZUxvYWRlciwgJGlvbmljQmFja2Ryb3AsICR0aW1lb3V0LCAkcSwgJGxvZywgJGNvbXBpbGUsICRpb25pY1BsYXRmb3JtKSB7CgogICAgICAgIHZhciBsb2FkZXJJbnN0YW5jZTsKICAgICAgICAvL2RlZmF1bHQgdmFsdWVzCiAgICAgICAgdmFyIGRlcmVnaXN0ZXJCYWNrQWN0aW9uID0gYW5ndWxhci5ub29wOwogICAgICAgIHZhciBsb2FkaW5nU2hvd0RlbGF5ID0gJHEud2hlbigpOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNMb2FkaW5nI3Nob3cKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbiBTaG93cyBhIGxvYWRpbmcgaW5kaWNhdG9yLiBJZiB0aGUgaW5kaWNhdG9yIGlzIGFscmVhZHkgc2hvd24sCiAgICAgICAgICAgKiBpdCB3aWxsIHNldCB0aGUgb3B0aW9ucyBnaXZlbiBhbmQga2VlcCB0aGUgaW5kaWNhdG9yIHNob3duLgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdHMgVGhlIG9wdGlvbnMgZm9yIHRoZSBsb2FkaW5nIGluZGljYXRvci4gQXZhaWxhYmxlIHByb3BlcnRpZXM6CiAgICAgICAgICAgKiAgLSBge3N0cmluZz19YCBgdGVtcGxhdGVgIFRoZSBodG1sIGNvbnRlbnQgb2YgdGhlIGluZGljYXRvci4KICAgICAgICAgICAqICAtIGB7c3RyaW5nPX1gIGB0ZW1wbGF0ZVVybGAgVGhlIHVybCBvZiBhbiBodG1sIHRlbXBsYXRlIHRvIGxvYWQgYXMgdGhlIGNvbnRlbnQgb2YgdGhlIGluZGljYXRvci4KICAgICAgICAgICAqICAtIGB7Ym9vbGVhbj19YCBgbm9CYWNrZHJvcGAgV2hldGhlciB0byBoaWRlIHRoZSBiYWNrZHJvcC4gQnkgZGVmYXVsdCBpdCB3aWxsIGJlIHNob3duLgogICAgICAgICAgICogIC0gYHtudW1iZXI9fWAgYGRlbGF5YCBIb3cgbWFueSBtaWxsaXNlY29uZHMgdG8gZGVsYXkgc2hvd2luZyB0aGUgaW5kaWNhdG9yLiBCeSBkZWZhdWx0IHRoZXJlIGlzIG5vIGRlbGF5LgogICAgICAgICAgICogIC0gYHtudW1iZXI9fWAgYGR1cmF0aW9uYCBIb3cgbWFueSBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbCBhdXRvbWF0aWNhbGx5CiAgICAgICAgICAgKiAgaGlkaW5nIHRoZSBpbmRpY2F0b3IuIEJ5IGRlZmF1bHQsIHRoZSBpbmRpY2F0b3Igd2lsbCBiZSBzaG93biB1bnRpbCBgLmhpZGUoKWAgaXMgY2FsbGVkLgogICAgICAgICAgICovCiAgICAgICAgICBzaG93OiBzaG93TG9hZGVyLAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNMb2FkaW5nI2hpZGUKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbiBIaWRlcyB0aGUgbG9hZGluZyBpbmRpY2F0b3IsIGlmIHNob3duLgogICAgICAgICAgICovCiAgICAgICAgICBoaWRlOiBoaWRlTG9hZGVyLAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAcHJpdmF0ZSBmb3IgdGVzdGluZwogICAgICAgICAgICovCiAgICAgICAgICBfZ2V0TG9hZGVyOiBnZXRMb2FkZXIKICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBnZXRMb2FkZXIoKSB7CiAgICAgICAgICBpZiAoIWxvYWRlckluc3RhbmNlKSB7CiAgICAgICAgICAgIGxvYWRlckluc3RhbmNlID0gJGlvbmljVGVtcGxhdGVMb2FkZXIuY29tcGlsZSh7CiAgICAgICAgICAgICAgdGVtcGxhdGU6IExPQURJTkdfVFBMLAogICAgICAgICAgICAgIGFwcGVuZFRvOiAkZG9jdW1lbnRbMF0uYm9keQogICAgICAgICAgICB9KQogICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKGxvYWRlcikgewogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSBsb2FkZXI7CgogICAgICAgICAgICAgICAgbG9hZGVyLnNob3cgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZVByb21pc2UgPSBvcHRpb25zLnRlbXBsYXRlVXJsID8KICAgICAgICAgICAgICAgICAgICAkaW9uaWNUZW1wbGF0ZUxvYWRlci5sb2FkKG9wdGlvbnMudGVtcGxhdGVVcmwpIDoKICAgICAgICAgICAgICAgICAgICAvL29wdGlvbnMuY29udGVudDogZGVwcmVjYXRlZAogICAgICAgICAgICAgICAgICAgICRxLndoZW4ob3B0aW9ucy50ZW1wbGF0ZSB8fCBvcHRpb25zLmNvbnRlbnQgfHwgJycpOwoKCiAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc1Nob3duKSB7CiAgICAgICAgICAgICAgICAgICAgLy9vcHRpb25zLnNob3dCYWNrZHJvcDogZGVwcmVjYXRlZAogICAgICAgICAgICAgICAgICAgIHRoaXMuaGFzQmFja2Ryb3AgPSAhb3B0aW9ucy5ub0JhY2tkcm9wICYmIG9wdGlvbnMuc2hvd0JhY2tkcm9wICE9PSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWNrZHJvcCkgewogICAgICAgICAgICAgICAgICAgICAgJGlvbmljQmFja2Ryb3AucmV0YWluKCk7CiAgICAgICAgICAgICAgICAgICAgICAkaW9uaWNCYWNrZHJvcC5nZXRFbGVtZW50KCkuYWRkQ2xhc3MoJ2JhY2tkcm9wLWxvYWRpbmcnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQuY2FuY2VsKHRoaXMuZHVyYXRpb25UaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmR1cmF0aW9uVGltZW91dCA9ICR0aW1lb3V0KAogICAgICAgICAgICAgICAgICAgICAgYW5ndWxhci5iaW5kKHRoaXMsIHRoaXMuaGlkZSksCiAgICAgICAgICAgICAgICAgICAgICArb3B0aW9ucy5kdXJhdGlvbgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgIHRlbXBsYXRlUHJvbWlzZS50aGVuKGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaHRtbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGxvYWRpbmcgPSBzZWxmLmVsZW1lbnQuY2hpbGRyZW4oKTsKICAgICAgICAgICAgICAgICAgICAgIGxvYWRpbmcuaHRtbChodG1sKTsKICAgICAgICAgICAgICAgICAgICAgICRjb21waWxlKGxvYWRpbmcuY29udGVudHMoKSkoc2VsZi5zY29wZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvL0Rvbid0IHNob3cgdW50aWwgdGVtcGxhdGUgY2hhbmdlcwogICAgICAgICAgICAgICAgICAgIGlmIChzZWxmLmlzU2hvd24pIHsKICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZWxlbWVudC5hZGRDbGFzcygndmlzaWJsZScpOwogICAgICAgICAgICAgICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmlzU2hvd24gJiYgc2VsZi5lbGVtZW50LmFkZENsYXNzKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgJGRvY3VtZW50WzBdLmJvZHkuY2xhc3NMaXN0LmFkZCgnbG9hZGluZy1hY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICB0aGlzLmlzU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGxvYWRlci5oaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzU2hvd24pIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNCYWNrZHJvcCkgewogICAgICAgICAgICAgICAgICAgICAgJGlvbmljQmFja2Ryb3AucmVsZWFzZSgpOwogICAgICAgICAgICAgICAgICAgICAgJGlvbmljQmFja2Ryb3AuZ2V0RWxlbWVudCgpLnJlbW92ZUNsYXNzKCdiYWNrZHJvcC1sb2FkaW5nJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgJGRvY3VtZW50WzBdLmJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnbG9hZGluZy1hY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgIXNlbGYuaXNTaG93biAmJiBzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoJ3Zpc2libGUnKTsKICAgICAgICAgICAgICAgICAgICB9LCAyMDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICR0aW1lb3V0LmNhbmNlbCh0aGlzLmR1cmF0aW9uVGltZW91dCk7CiAgICAgICAgICAgICAgICAgIHRoaXMuaXNTaG93biA9IGZhbHNlOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICByZXR1cm4gbG9hZGVyOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxvYWRlckluc3RhbmNlOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2hvd0xvYWRlcihvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKCRpb25pY0xvYWRpbmdDb25maWcgfHwge30sIG9wdGlvbnMgfHwge30pOwogICAgICAgICAgdmFyIGRlbGF5ID0gb3B0aW9ucy5kZWxheSB8fCBvcHRpb25zLnNob3dEZWxheSB8fCAwOwoKICAgICAgICAgIC8vSWYgbG9hZGluZy5zaG93KCkgd2FzIGNhbGxlZCBwcmV2aW91c2x5LCBjYW5jZWwgaXQgYW5kIHNob3cgd2l0aCBvdXIgbmV3IG9wdGlvbnMKICAgICAgICAgIGxvYWRpbmdTaG93RGVsYXkgJiYgJHRpbWVvdXQuY2FuY2VsKGxvYWRpbmdTaG93RGVsYXkpOwogICAgICAgICAgbG9hZGluZ1Nob3dEZWxheSA9ICR0aW1lb3V0KGFuZ3VsYXIubm9vcCwgZGVsYXkpOwoKICAgICAgICAgIGxvYWRpbmdTaG93RGVsYXkudGhlbihnZXRMb2FkZXIpLnRoZW4oZnVuY3Rpb24obG9hZGVyKSB7CiAgICAgICAgICAgIGRlcmVnaXN0ZXJCYWNrQWN0aW9uKCk7CiAgICAgICAgICAgIC8vRGlzYWJsZSBoYXJkd2FyZSBiYWNrIGJ1dHRvbiB3aGlsZSBsb2FkaW5nCiAgICAgICAgICAgIGRlcmVnaXN0ZXJCYWNrQWN0aW9uID0gJGlvbmljUGxhdGZvcm0ucmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uKAogICAgICAgICAgICAgIGFuZ3VsYXIubm9vcCwKICAgICAgICAgICAgICBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9MT0FESU5HCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybiBsb2FkZXIuc2hvdyhvcHRpb25zKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGhpZGU6IGRlcHJlY2F0ZWQubWV0aG9kKExPQURJTkdfSElERV9ERVBSRUNBVEVELCAkbG9nLmVycm9yLCBoaWRlTG9hZGVyKSwKICAgICAgICAgICAgc2hvdzogZGVwcmVjYXRlZC5tZXRob2QoTE9BRElOR19TSE9XX0RFUFJFQ0FURUQsICRsb2cuZXJyb3IsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNob3dMb2FkZXIob3B0aW9ucyk7CiAgICAgICAgICAgIH0pLAogICAgICAgICAgICBzZXRDb250ZW50OiBkZXByZWNhdGVkLm1ldGhvZChMT0FESU5HX1NFVF9ERVBSRUNBVEVELCAkbG9nLmVycm9yLCBmdW5jdGlvbihjb250ZW50KSB7CiAgICAgICAgICAgICAgZ2V0TG9hZGVyKCkudGhlbihmdW5jdGlvbihsb2FkZXIpIHsKICAgICAgICAgICAgICAgIGxvYWRlci5zaG93KHsgdGVtcGxhdGU6IGNvbnRlbnQgfSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaGlkZUxvYWRlcigpIHsKICAgICAgICAgIGRlcmVnaXN0ZXJCYWNrQWN0aW9uKCk7CiAgICAgICAgICAkdGltZW91dC5jYW5jZWwobG9hZGluZ1Nob3dEZWxheSk7CiAgICAgICAgICBnZXRMb2FkZXIoKS50aGVuKGZ1bmN0aW9uKGxvYWRlcikgewogICAgICAgICAgICBsb2FkZXIuaGlkZSgpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9XSk7CgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljTW9kYWwKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBSZWxhdGVkOiB7QGxpbmsgaW9uaWMuY29udHJvbGxlcjppb25pY01vZGFsIGlvbmljTW9kYWwgY29udHJvbGxlcn0uCiAgICoKICAgKiBUaGUgTW9kYWwgaXMgYSBjb250ZW50IHBhbmUgdGhhdCBjYW4gZ28gb3ZlciB0aGUgdXNlcidzIG1haW4gdmlldwogICAqIHRlbXBvcmFyaWx5LiAgVXN1YWxseSB1c2VkIGZvciBtYWtpbmcgYSBjaG9pY2Ugb3IgZWRpdGluZyBhbiBpdGVtLgogICAqCiAgICogUHV0IHRoZSBjb250ZW50IG9mIHRoZSBtb2RhbCBpbnNpZGUgb2YgYW4gYDxpb24tbW9kYWwtdmlldz5gIGVsZW1lbnQuCiAgICoKICAgKiBOb3RlOiBhIG1vZGFsIHdpbGwgYnJvYWRjYXN0ICdtb2RhbC5zaG93bicsICdtb2RhbC5oaWRkZW4nLCBhbmQgJ21vZGFsLnJlbW92ZWQnIGV2ZW50cyBmcm9tIGl0cyBvcmlnaW5hdGluZwogICAqIHNjb3BlLCBwYXNzaW5nIGluIGl0c2VsZiBhcyBhbiBldmVudCBhcmd1bWVudC4gQm90aCB0aGUgbW9kYWwucmVtb3ZlZCBhbmQgbW9kYWwuaGlkZGVuIGV2ZW50cyBhcmUKICAgKiBjYWxsZWQgd2hlbiB0aGUgbW9kYWwgaXMgcmVtb3ZlZC4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8c2NyaXB0IGlkPSJteS1tb2RhbC5odG1sIiB0eXBlPSJ0ZXh0L25nLXRlbXBsYXRlIj4KICAgKiAgIDxpb24tbW9kYWwtdmlldz4KICAgKiAgICAgPGlvbi1oZWFkZXItYmFyPgogICAqICAgICAgIDxoMSBjbGFzcz0idGl0bGUiPk15IE1vZGFsIHRpdGxlPC9oMT4KICAgKiAgICAgPC9pb24taGVhZGVyLWJhcj4KICAgKiAgICAgPGlvbi1jb250ZW50PgogICAqICAgICAgIEhlbGxvIQogICAqICAgICA8L2lvbi1jb250ZW50PgogICAqICAgPC9pb24tbW9kYWwtdmlldz4KICAgKiA8L3NjcmlwdD4KICAgKiBgYGAKICAgKiBgYGBqcwogICAqIGFuZ3VsYXIubW9kdWxlKCd0ZXN0QXBwJywgWydpb25pYyddKQogICAqIC5jb250cm9sbGVyKCdNeUNvbnRyb2xsZXInLCBmdW5jdGlvbigkc2NvcGUsICRpb25pY01vZGFsKSB7CiAqICAgJGlvbmljTW9kYWwuZnJvbVRlbXBsYXRlVXJsKCdteS1tb2RhbC5odG1sJywgewogKiAgICAgc2NvcGU6ICRzY29wZSwKICogICAgIGFuaW1hdGlvbjogJ3NsaWRlLWluLXVwJwogKiAgIH0pLnRoZW4oZnVuY3Rpb24obW9kYWwpIHsKICogICAgICRzY29wZS5tb2RhbCA9IG1vZGFsOwogKiAgIH0pOwogKiAgICRzY29wZS5vcGVuTW9kYWwgPSBmdW5jdGlvbigpIHsKICogICAgICRzY29wZS5tb2RhbC5zaG93KCk7CiAqICAgfTsKICogICAkc2NvcGUuY2xvc2VNb2RhbCA9IGZ1bmN0aW9uKCkgewogKiAgICAgJHNjb3BlLm1vZGFsLmhpZGUoKTsKICogICB9OwogKiAgIC8vQ2xlYW51cCB0aGUgbW9kYWwgd2hlbiB3ZSdyZSBkb25lIHdpdGggaXQhCiAqICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICogICAgICRzY29wZS5tb2RhbC5yZW1vdmUoKTsKICogICB9KTsKICogICAvLyBFeGVjdXRlIGFjdGlvbiBvbiBoaWRlIG1vZGFsCiAqICAgJHNjb3BlLiRvbignbW9kYWwuaGlkZGVuJywgZnVuY3Rpb24oKSB7CiAqICAgICAvLyBFeGVjdXRlIGFjdGlvbgogKiAgIH0pOwogKiAgIC8vIEV4ZWN1dGUgYWN0aW9uIG9uIHJlbW92ZSBtb2RhbAogKiAgICRzY29wZS4kb24oJ21vZGFsLnJlbW92ZWQnLCBmdW5jdGlvbigpIHsKICogICAgIC8vIEV4ZWN1dGUgYWN0aW9uCiAqICAgfSk7CiAqIH0pOwogICAqIGBgYAogICAqLwogIElvbmljTW9kdWxlCiAgICAuZmFjdG9yeSgnJGlvbmljTW9kYWwnLCBbCiAgICAgICckcm9vdFNjb3BlJywKICAgICAgJyRkb2N1bWVudCcsCiAgICAgICckY29tcGlsZScsCiAgICAgICckdGltZW91dCcsCiAgICAgICckaW9uaWNQbGF0Zm9ybScsCiAgICAgICckaW9uaWNUZW1wbGF0ZUxvYWRlcicsCiAgICAgICckcScsCiAgICAgICckbG9nJywKICAgICAgZnVuY3Rpb24oJHJvb3RTY29wZSwgJGRvY3VtZW50LCAkY29tcGlsZSwgJHRpbWVvdXQsICRpb25pY1BsYXRmb3JtLCAkaW9uaWNUZW1wbGF0ZUxvYWRlciwgJHEsICRsb2cpIHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIGNvbnRyb2xsZXIKICAgICAgICAgKiBAbmFtZSBpb25pY01vZGFsCiAgICAgICAgICogQG1vZHVsZSBpb25pYwogICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAqIEluc3RhbnRpYXRlZCBieSB0aGUge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljTW9kYWx9IHNlcnZpY2UuCiAgICAgICAgICoKICAgICAgICAgKiBCZSBzdXJlIHRvIGNhbGwgW3JlbW92ZSgpXSgjcmVtb3ZlKSB3aGVuIHlvdSBhcmUgZG9uZSB3aXRoIGVhY2ggbW9kYWwKICAgICAgICAgKiB0byBjbGVhbiBpdCB1cCBhbmQgYXZvaWQgbWVtb3J5IGxlYWtzLgogICAgICAgICAqCiAgICAgICAgICogTm90ZTogYSBtb2RhbCB3aWxsIGJyb2FkY2FzdCAnbW9kYWwuc2hvd24nLCAnbW9kYWwuaGlkZGVuJywgYW5kICdtb2RhbC5yZW1vdmVkJyBldmVudHMgZnJvbSBpdHMgb3JpZ2luYXRpbmcKICAgICAgICAgKiBzY29wZSwgcGFzc2luZyBpbiBpdHNlbGYgYXMgYW4gZXZlbnQgYXJndW1lbnQuIE5vdGU6IGJvdGggbW9kYWwucmVtb3ZlZCBhbmQgbW9kYWwuaGlkZGVuIGFyZQogICAgICAgICAqIGNhbGxlZCB3aGVuIHRoZSBtb2RhbCBpcyByZW1vdmVkLgogICAgICAgICAqLwogICAgICAgIHZhciBNb2RhbFZpZXcgPSBpb25pYy52aWV3cy5Nb2RhbC5pbmhlcml0KHsKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgaW9uaWNNb2RhbCNpbml0aWFsaXplCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24gQ3JlYXRlcyBhIG5ldyBtb2RhbCBjb250cm9sbGVyIGluc3RhbmNlLgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgQW4gb3B0aW9ucyBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgICAgICAgKiAgLSBge29iamVjdD19YCBgc2NvcGVgIFRoZSBzY29wZSB0byBiZSBhIGNoaWxkIG9mLgogICAgICAgICAgICogICAgRGVmYXVsdDogY3JlYXRlcyBhIGNoaWxkIG9mICRyb290U2NvcGUuCiAgICAgICAgICAgKiAgLSBge3N0cmluZz19YCBgYW5pbWF0aW9uYCBUaGUgYW5pbWF0aW9uIHRvIHNob3cgJiBoaWRlIHdpdGguCiAgICAgICAgICAgKiAgICBEZWZhdWx0OiAnc2xpZGUtaW4tdXAnCiAgICAgICAgICAgKiAgLSBge2Jvb2xlYW49fWAgYGZvY3VzRmlyc3RJbnB1dGAgV2hldGhlciB0byBhdXRvZm9jdXMgdGhlIGZpcnN0IGlucHV0IG9mCiAgICAgICAgICAgKiAgICB0aGUgbW9kYWwgd2hlbiBzaG93bi4gIERlZmF1bHQ6IGZhbHNlLgogICAgICAgICAgICogIC0gYHtib29sZWFuPX1gIGBiYWNrZHJvcENsaWNrVG9DbG9zZWAgV2hldGhlciB0byBjbG9zZSB0aGUgbW9kYWwgb24gY2xpY2tpbmcgdGhlIGJhY2tkcm9wLgogICAgICAgICAgICogICAgRGVmYXVsdDogdHJ1ZS4KICAgICAgICAgICAqICAtIGB7Ym9vbGVhbj19YCBgaGFyZHdhcmVCYWNrQnV0dG9uQ2xvc2VgIFdoZXRoZXIgdGhlIG1vZGFsIGNhbiBiZSBjbG9zZWQgdXNpbmcgdGhlIGhhcmR3YXJlCiAgICAgICAgICAgKiAgICBiYWNrIGJ1dHRvbiBvbiBBbmRyb2lkIGFuZCBzaW1pbGFyIGRldmljZXMuICBEZWZhdWx0OiB0cnVlLgogICAgICAgICAgICovCiAgICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgICAgICAgIGlvbmljLnZpZXdzLk1vZGFsLnByb3RvdHlwZS5pbml0aWFsaXplLmNhbGwodGhpcywgb3B0cyk7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0aW9uID0gb3B0cy5hbmltYXRpb24gfHwgJ3NsaWRlLWluLXVwJzsKICAgICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBpb25pY01vZGFsI3Nob3cKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbiBTaG93IHRoaXMgbW9kYWwgaW5zdGFuY2UuCiAgICAgICAgICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIG1vZGFsIGlzIGZpbmlzaGVkIGFuaW1hdGluZyBpbi4KICAgICAgICAgICAqLwogICAgICAgICAgc2hvdzogZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgICAgIGlmKHNlbGYuc2NvcGUuJCRkZXN0cm95ZWQpIHsKICAgICAgICAgICAgICAkbG9nLmVycm9yKCdDYW5ub3QgY2FsbCAnICsgIHNlbGYudmlld1R5cGUgKyAnLnNob3coKSBhZnRlciByZW1vdmUoKS4gUGxlYXNlIGNyZWF0ZSBhIG5ldyAnICsgIHNlbGYudmlld1R5cGUgKyAnIGluc3RhbmNlLicpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG1vZGFsRWwgPSBqcUxpdGUoc2VsZi5tb2RhbEVsKTsKCiAgICAgICAgICAgIHNlbGYuZWwuY2xhc3NMaXN0LnJlbW92ZSgnaGlkZScpOwogICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICRkb2N1bWVudFswXS5ib2R5LmNsYXNzTGlzdC5hZGQoc2VsZi52aWV3VHlwZSArICctb3BlbicpOwogICAgICAgICAgICB9LCA0MDApOwoKICAgICAgICAgICAgaWYoIXNlbGYuZWwucGFyZW50RWxlbWVudCkgewogICAgICAgICAgICAgIG1vZGFsRWwuYWRkQ2xhc3Moc2VsZi5hbmltYXRpb24pOwogICAgICAgICAgICAgICRkb2N1bWVudFswXS5ib2R5LmFwcGVuZENoaWxkKHNlbGYuZWwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZih0YXJnZXQgJiYgc2VsZi5wb3NpdGlvblZpZXcpIHsKICAgICAgICAgICAgICBzZWxmLnBvc2l0aW9uVmlldyh0YXJnZXQsIG1vZGFsRWwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtb2RhbEVsLmFkZENsYXNzKCduZy1lbnRlciBhY3RpdmUnKQogICAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnbmctbGVhdmUgbmctbGVhdmUtYWN0aXZlJyk7CgogICAgICAgICAgICBzZWxmLl9pc1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgc2VsZi5fZGVyZWdpc3RlckJhY2tCdXR0b24gPSAkaW9uaWNQbGF0Zm9ybS5yZWdpc3RlckJhY2tCdXR0b25BY3Rpb24oCiAgICAgICAgICAgICAgc2VsZi5oYXJkd2FyZUJhY2tCdXR0b25DbG9zZSA/IGFuZ3VsYXIuYmluZChzZWxmLCBzZWxmLmhpZGUpIDogYW5ndWxhci5ub29wLAogICAgICAgICAgICAgIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX01PREFMCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBzZWxmLl9pc09wZW5Qcm9taXNlID0gJHEuZGVmZXIoKTsKCiAgICAgICAgICAgIGlvbmljLnZpZXdzLk1vZGFsLnByb3RvdHlwZS5zaG93LmNhbGwoc2VsZik7CgogICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgIG1vZGFsRWwuYWRkQ2xhc3MoJ25nLWVudGVyLWFjdGl2ZScpOwogICAgICAgICAgICAgIGlvbmljLnRyaWdnZXIoJ3Jlc2l6ZScpOwogICAgICAgICAgICAgIHNlbGYuc2NvcGUuJHBhcmVudCAmJiBzZWxmLnNjb3BlLiRwYXJlbnQuJGJyb2FkY2FzdChzZWxmLnZpZXdUeXBlICsgJy5zaG93bicsIHNlbGYpOwogICAgICAgICAgICAgIHNlbGYuZWwuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgIH0sIDIwKTsKCiAgICAgICAgICAgIHJldHVybiAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAvL0FmdGVyIGFuaW1hdGluZyBpbiwgYWxsb3cgaGlkZSBvbiBiYWNrZHJvcCBjbGljawogICAgICAgICAgICAgIHNlbGYuJGVsLm9uKCdjbGljaycsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIGlmIChzZWxmLmJhY2tkcm9wQ2xpY2tUb0Nsb3NlICYmIGUudGFyZ2V0ID09PSBzZWxmLmVsKSB7CiAgICAgICAgICAgICAgICAgIHNlbGYuaGlkZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCA0MDApOwogICAgICAgICAgfSwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lIGlvbmljTW9kYWwjaGlkZQogICAgICAgICAgICogQGRlc2NyaXB0aW9uIEhpZGUgdGhpcyBtb2RhbCBpbnN0YW5jZS4KICAgICAgICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgbW9kYWwgaXMgZmluaXNoZWQgYW5pbWF0aW5nIG91dC4KICAgICAgICAgICAqLwogICAgICAgICAgaGlkZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgdmFyIG1vZGFsRWwgPSBqcUxpdGUoc2VsZi5tb2RhbEVsKTsKCiAgICAgICAgICAgIHNlbGYuZWwuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgIG1vZGFsRWwuYWRkQ2xhc3MoJ25nLWxlYXZlJyk7CgogICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgIG1vZGFsRWwuYWRkQ2xhc3MoJ25nLWxlYXZlLWFjdGl2ZScpCiAgICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ25nLWVudGVyIG5nLWVudGVyLWFjdGl2ZSBhY3RpdmUnKTsKICAgICAgICAgICAgfSwgMjApOwoKICAgICAgICAgICAgc2VsZi4kZWwub2ZmKCdjbGljaycpOwogICAgICAgICAgICBzZWxmLl9pc1Nob3duID0gZmFsc2U7CiAgICAgICAgICAgIHNlbGYuc2NvcGUuJHBhcmVudCAmJiBzZWxmLnNjb3BlLiRwYXJlbnQuJGJyb2FkY2FzdChzZWxmLnZpZXdUeXBlICsgJy5oaWRkZW4nLCBzZWxmKTsKICAgICAgICAgICAgc2VsZi5fZGVyZWdpc3RlckJhY2tCdXR0b24gJiYgc2VsZi5fZGVyZWdpc3RlckJhY2tCdXR0b24oKTsKCiAgICAgICAgICAgIGlvbmljLnZpZXdzLk1vZGFsLnByb3RvdHlwZS5oaWRlLmNhbGwoc2VsZik7CgogICAgICAgICAgICByZXR1cm4gJHRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAkZG9jdW1lbnRbMF0uYm9keS5jbGFzc0xpc3QucmVtb3ZlKHNlbGYudmlld1R5cGUgKyAnLW9wZW4nKTsKICAgICAgICAgICAgICBzZWxmLmVsLmNsYXNzTGlzdC5hZGQoJ2hpZGUnKTsKICAgICAgICAgICAgfSwgc2VsZi5oaWRlRGVsYXkgfHwgNTAwKTsKICAgICAgICAgIH0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSBpb25pY01vZGFsI3JlbW92ZQogICAgICAgICAgICogQGRlc2NyaXB0aW9uIFJlbW92ZSB0aGlzIG1vZGFsIGluc3RhbmNlIGZyb20gdGhlIERPTSBhbmQgY2xlYW4gdXAuCiAgICAgICAgICAgKiBAcmV0dXJucyB7cHJvbWlzZX0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIG1vZGFsIGlzIGZpbmlzaGVkIGFuaW1hdGluZyBvdXQuCiAgICAgICAgICAgKi8KICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICAgICAgc2VsZi5zY29wZS4kcGFyZW50ICYmIHNlbGYuc2NvcGUuJHBhcmVudC4kYnJvYWRjYXN0KHNlbGYudmlld1R5cGUgKyAnLnJlbW92ZWQnLCBzZWxmKTsKCiAgICAgICAgICAgIHJldHVybiBzZWxmLmhpZGUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYuc2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICBzZWxmLiRlbC5yZW1vdmUoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgaW9uaWNNb2RhbCNpc1Nob3duCiAgICAgICAgICAgKiBAcmV0dXJucyBib29sZWFuIFdoZXRoZXIgdGhpcyBtb2RhbCBpcyBjdXJyZW50bHkgc2hvd24uCiAgICAgICAgICAgKi8KICAgICAgICAgIGlzU2hvd246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gISF0aGlzLl9pc1Nob3duOwogICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICB2YXIgY3JlYXRlTW9kYWwgPSBmdW5jdGlvbih0ZW1wbGF0ZVN0cmluZywgb3B0aW9ucykgewogICAgICAgICAgLy8gQ3JlYXRlIGEgbmV3IHNjb3BlIGZvciB0aGUgbW9kYWwKICAgICAgICAgIHZhciBzY29wZSA9IG9wdGlvbnMuc2NvcGUgJiYgb3B0aW9ucy5zY29wZS4kbmV3KCkgfHwgJHJvb3RTY29wZS4kbmV3KHRydWUpOwoKICAgICAgICAgIG9wdGlvbnMudmlld1R5cGUgPSBvcHRpb25zLnZpZXdUeXBlIHx8ICdtb2RhbCc7CgogICAgICAgICAgZXh0ZW5kKHNjb3BlLCB7CiAgICAgICAgICAgICRoYXNIZWFkZXI6IGZhbHNlLAogICAgICAgICAgICAkaGFzU3ViaGVhZGVyOiBmYWxzZSwKICAgICAgICAgICAgJGhhc0Zvb3RlcjogZmFsc2UsCiAgICAgICAgICAgICRoYXNTdWJmb290ZXI6IGZhbHNlLAogICAgICAgICAgICAkaGFzVGFiczogZmFsc2UsCiAgICAgICAgICAgICRoYXNUYWJzVG9wOiBmYWxzZQogICAgICAgICAgfSk7CgogICAgICAgICAgLy8gQ29tcGlsZSB0aGUgdGVtcGxhdGUKICAgICAgICAgIHZhciBlbGVtZW50ID0gJGNvbXBpbGUoJzxpb24tJyArIG9wdGlvbnMudmlld1R5cGUgKyAnPicgKyB0ZW1wbGF0ZVN0cmluZyArICc8L2lvbi0nICsgb3B0aW9ucy52aWV3VHlwZSArICc+Jykoc2NvcGUpOwoKICAgICAgICAgIG9wdGlvbnMuJGVsID0gZWxlbWVudDsKICAgICAgICAgIG9wdGlvbnMuZWwgPSBlbGVtZW50WzBdOwogICAgICAgICAgb3B0aW9ucy5tb2RhbEVsID0gb3B0aW9ucy5lbC5xdWVyeVNlbGVjdG9yKCcuJyArIG9wdGlvbnMudmlld1R5cGUpOwogICAgICAgICAgdmFyIG1vZGFsID0gbmV3IE1vZGFsVmlldyhvcHRpb25zKTsKCiAgICAgICAgICBtb2RhbC5zY29wZSA9IHNjb3BlOwoKICAgICAgICAgIC8vIElmIHRoaXMgd2Fzbid0IGEgZGVmaW5lZCBzY29wZSwgd2UgY2FuIGFzc2lnbiB0aGUgdmlld1R5cGUgdG8gdGhlIGlzb2xhdGVkIHNjb3BlCiAgICAgICAgICAvLyB3ZSBjcmVhdGVkCiAgICAgICAgICBpZighb3B0aW9ucy5zY29wZSkgewogICAgICAgICAgICBzY29wZVsgb3B0aW9ucy52aWV3VHlwZSBdID0gbW9kYWw7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIG1vZGFsOwogICAgICAgIH07CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRpb25pY01vZGFsI2Zyb21UZW1wbGF0ZQogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRlbXBsYXRlU3RyaW5nIFRoZSB0ZW1wbGF0ZSBzdHJpbmcgdG8gdXNlIGFzIHRoZSBtb2RhbCdzCiAgICAgICAgICAgKiBjb250ZW50LgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgT3B0aW9ucyB0byBiZSBwYXNzZWQge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNNb2RhbCNpbml0aWFsaXplIGlvbmljTW9kYWwjaW5pdGlhbGl6ZX0gbWV0aG9kLgogICAgICAgICAgICogQHJldHVybnMge29iamVjdH0gQW4gaW5zdGFuY2Ugb2YgYW4ge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNNb2RhbH0KICAgICAgICAgICAqIGNvbnRyb2xsZXIuCiAgICAgICAgICAgKi8KICAgICAgICAgIGZyb21UZW1wbGF0ZTogZnVuY3Rpb24odGVtcGxhdGVTdHJpbmcsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIG1vZGFsID0gY3JlYXRlTW9kYWwodGVtcGxhdGVTdHJpbmcsIG9wdGlvbnMgfHwge30pOwogICAgICAgICAgICByZXR1cm4gbW9kYWw7CiAgICAgICAgICB9LAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNNb2RhbCNmcm9tVGVtcGxhdGVVcmwKICAgICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZW1wbGF0ZVVybCBUaGUgdXJsIHRvIGxvYWQgdGhlIHRlbXBsYXRlIGZyb20uCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBPcHRpb25zIHRvIGJlIHBhc3NlZCB7QGxpbmsgaW9uaWMuY29udHJvbGxlcjppb25pY01vZGFsI2luaXRpYWxpemUgaW9uaWNNb2RhbCNpbml0aWFsaXplfSBtZXRob2QuCiAgICAgICAgICAgKiBvcHRpb25zIG9iamVjdC4KICAgICAgICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2UgdGhhdCB3aWxsIGJlIHJlc29sdmVkIHdpdGggYW4gaW5zdGFuY2Ugb2YKICAgICAgICAgICAqIGFuIHtAbGluayBpb25pYy5jb250cm9sbGVyOmlvbmljTW9kYWx9IGNvbnRyb2xsZXIuCiAgICAgICAgICAgKi8KICAgICAgICAgIGZyb21UZW1wbGF0ZVVybDogZnVuY3Rpb24odXJsLCBvcHRpb25zLCBfKSB7CiAgICAgICAgICAgIHZhciBjYjsKICAgICAgICAgICAgLy9EZXByZWNhdGVkOiBhbGxvdyBhIGNhbGxiYWNrIGFzIHNlY29uZCBwYXJhbWV0ZXIuIE5vdyB3ZSByZXR1cm4gYSBwcm9taXNlLgogICAgICAgICAgICBpZiAoYW5ndWxhci5pc0Z1bmN0aW9uKG9wdGlvbnMpKSB7CiAgICAgICAgICAgICAgY2IgPSBvcHRpb25zOwogICAgICAgICAgICAgIG9wdGlvbnMgPSBfOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAkaW9uaWNUZW1wbGF0ZUxvYWRlci5sb2FkKHVybCkudGhlbihmdW5jdGlvbih0ZW1wbGF0ZVN0cmluZykgewogICAgICAgICAgICAgIHZhciBtb2RhbCA9IGNyZWF0ZU1vZGFsKHRlbXBsYXRlU3RyaW5nLCBvcHRpb25zIHx8IHt9KTsKICAgICAgICAgICAgICBjYiAmJiBjYihtb2RhbCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vZGFsOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XSk7CgoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlCiAgICogQG1vZHVsZSBpb25pYwogICAqIEBkZXNjcmlwdGlvbgogICAqIERlbGVnYXRlIGZvciBjb250cm9sbGluZyB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9IGRpcmVjdGl2ZS4KICAgKgogICAqIEB1c2FnZQogICAqCiAgICogYGBgaHRtbAogICAqIDxib2R5IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+CiAgICogICA8aW9uLW5hdi1iYXI+CiAgICogICAgIDxidXR0b24gbmctY2xpY2s9InNldE5hdlRpdGxlKCdiYW5hbmEnKSI+CiAgICogICAgICAgU2V0IHRpdGxlIHRvIGJhbmFuYSEKICAgKiAgICAgPC9idXR0b24+CiAgICogICA8L2lvbi1uYXYtYmFyPgogICAqIDwvYm9keT4KICAgKiBgYGAKICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIE15Q3RybCgkc2NvcGUsICRpb25pY05hdkJhckRlbGVnYXRlKSB7CiAqICAgJHNjb3BlLnNldE5hdlRpdGxlID0gZnVuY3Rpb24odGl0bGUpIHsKICogICAgICRpb25pY05hdkJhckRlbGVnYXRlLnNldFRpdGxlKHRpdGxlKTsKICogICB9CiAqIH0KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLnNlcnZpY2UoJyRpb25pY05hdkJhckRlbGVnYXRlJywgZGVsZWdhdGVTZXJ2aWNlKFsKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUjYmFjawogICAgICogQGRlc2NyaXB0aW9uIEdvZXMgYmFjayBpbiB0aGUgdmlldyBoaXN0b3J5LgogICAgICogQHBhcmFtIHtET01FdmVudD19IGV2ZW50IFRoZSBldmVudCBvYmplY3QgKGVnIGZyb20gYSB0YXAgZXZlbnQpCiAgICAgKi8KICAgICAgJ2JhY2snLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSNhbGlnbgogICAgICogQGRlc2NyaXB0aW9uIEFsaWducyB0aGUgdGl0bGUgd2l0aCB0aGUgYnV0dG9ucyBpbiBhIGdpdmVuIGRpcmVjdGlvbi4KICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gZGlyZWN0aW9uIFRoZSBkaXJlY3Rpb24gdG8gdGhlIGFsaWduIHRoZSB0aXRsZSB0ZXh0IHRvd2FyZHMuCiAgICAgKiBBdmFpbGFibGU6ICdsZWZ0JywgJ3JpZ2h0JywgJ2NlbnRlcicuIERlZmF1bHQ6ICdjZW50ZXInLgogICAgICovCiAgICAgICdhbGlnbicsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY05hdkJhckRlbGVnYXRlI3Nob3dCYWNrQnV0dG9uCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFNldC9nZXQgd2hldGhlciB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYWNrQnV0dG9ufSBpcyBzaG93bgogICAgICogKGlmIGl0IGV4aXN0cykuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93IFdoZXRoZXIgdG8gc2hvdyB0aGUgYmFjayBidXR0b24uCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgYmFjayBidXR0b24gaXMgc2hvd24uCiAgICAgKi8KICAgICAgJ3Nob3dCYWNrQnV0dG9uJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUjc2hvd0JhcgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXQvZ2V0IHdoZXRoZXIgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfSBpcyBzaG93bi4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gc2hvdyBXaGV0aGVyIHRvIHNob3cgdGhlIGJhci4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSBiYXIgaXMgc2hvd24uCiAgICAgKi8KICAgICAgJ3Nob3dCYXInLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSNzZXRUaXRsZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBTZXQgdGhlIHRpdGxlIGZvciB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9LgogICAgICogQHBhcmFtIHtzdHJpbmd9IHRpdGxlIFRoZSBuZXcgdGl0bGUgdG8gc2hvdy4KICAgICAqLwogICAgICAnc2V0VGl0bGUnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSNjaGFuZ2VUaXRsZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBDaGFuZ2UgdGhlIHRpdGxlLCB0cmFuc2l0aW9uaW5nIHRoZSBuZXcgdGl0bGUgaW4gYW5kIHRoZSBvbGQgb25lIG91dCBpbiBhIGdpdmVuIGRpcmVjdGlvbi4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0aXRsZSBUaGUgbmV3IHRpdGxlIHRvIHNob3cuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZGlyZWN0aW9uIFRoZSBkaXJlY3Rpb24gdG8gdHJhbnNpdGlvbiB0aGUgbmV3IHRpdGxlIGluLgogICAgICogQXZhaWxhYmxlOiAnZm9yd2FyZCcsICdiYWNrJy4KICAgICAqLwogICAgICAnY2hhbmdlVGl0bGUnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSNnZXRUaXRsZQogICAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGN1cnJlbnQgdGl0bGUgb2YgdGhlIG5hdmJhci4KICAgICAqLwogICAgICAnZ2V0VGl0bGUnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSNnZXRQcmV2aW91c1RpdGxlCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgcHJldmlvdXMgdGl0bGUgb2YgdGhlIG5hdmJhci4KICAgICAqLwogICAgICAnZ2V0UHJldmlvdXNUaXRsZScKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTmF2QmFyRGVsZWdhdGUjJGdldEJ5SGFuZGxlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGFuZGxlCiAgICAgKiBAcmV0dXJucyBgZGVsZWdhdGVJbnN0YW5jZWAgQSBkZWxlZ2F0ZSBpbnN0YW5jZSB0aGF0IGNvbnRyb2xzIG9ubHkgdGhlCiAgICAgKiBuYXZCYXJzIHdpdGggZGVsZWdhdGUtaGFuZGxlIG1hdGNoaW5nIHRoZSBnaXZlbiBoYW5kbGUuCiAgICAgKgogICAgICogRXhhbXBsZTogYCRpb25pY05hdkJhckRlbGVnYXRlLiRnZXRCeUhhbmRsZSgnbXlIYW5kbGUnKS5zZXRUaXRsZSgnbmV3VGl0bGUnKWAKICAgICAqLwogICAgXSkpOwoKICB2YXIgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfVklFVyA9IDEwMDsKICB2YXIgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfU0lERV9NRU5VID0gMTUwOwogIHZhciBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9NT0RBTCA9IDIwMDsKICB2YXIgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfQUNUSU9OX1NIRUVUID0gMzAwOwogIHZhciBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9QT1BVUCA9IDQwMDsKICB2YXIgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfTE9BRElORyA9IDUwMDsKCiAgZnVuY3Rpb24gY29tcG9uZW50Q29uZmlnKGRlZmF1bHRzKSB7CiAgICBkZWZhdWx0cy4kZ2V0ID0gZnVuY3Rpb24oKSB7IHJldHVybiBkZWZhdWx0czsgfTsKICAgIHJldHVybiBkZWZhdWx0czsKICB9CgogIElvbmljTW9kdWxlCiAgICAuY29uc3RhbnQoJyRpb25pY1BsYXRmb3JtRGVmYXVsdHMnLCB7CiAgICAgICdpb3MnOiB7CiAgICAgICAgJyRpb25pY05hdkJhckNvbmZpZyc6IHsKICAgICAgICAgIHRyYW5zaXRpb246ICduYXYtdGl0bGUtc2xpZGUtaW9zNycsCiAgICAgICAgICBhbGlnblRpdGxlOiAnY2VudGVyJywKICAgICAgICAgIGJhY2tCdXR0b25JY29uOiAnaW9uLWlvczctYXJyb3ctYmFjaycKICAgICAgICB9LAogICAgICAgICckaW9uaWNOYXZWaWV3Q29uZmlnJzogewogICAgICAgICAgdHJhbnNpdGlvbjogJ3NsaWRlLWxlZnQtcmlnaHQtaW9zNycKICAgICAgICB9LAogICAgICAgICckaW9uaWNUYWJzQ29uZmlnJzogewogICAgICAgICAgdHlwZTogJycsCiAgICAgICAgICBwb3NpdGlvbjogJycKICAgICAgICB9CiAgICAgIH0sCiAgICAgICdhbmRyb2lkJzogewogICAgICAgICckaW9uaWNOYXZCYXJDb25maWcnOiB7CiAgICAgICAgICB0cmFuc2l0aW9uOiAnbmF2LXRpdGxlLXNsaWRlLWlvczcnLAogICAgICAgICAgYWxpZ25UaXRsZTogJ2NlbnRlcicsCiAgICAgICAgICBiYWNrQnV0dG9uSWNvbjogJ2lvbi1pb3M3LWFycm93LWJhY2snCiAgICAgICAgfSwKICAgICAgICAnJGlvbmljTmF2Vmlld0NvbmZpZyc6IHsKICAgICAgICAgIHRyYW5zaXRpb246ICdzbGlkZS1sZWZ0LXJpZ2h0LWlvczcnCiAgICAgICAgfSwKICAgICAgICAnJGlvbmljVGFic0NvbmZpZyc6IHsKICAgICAgICAgIHR5cGU6ICd0YWJzLXN0cmlwZWQnLAogICAgICAgICAgcG9zaXRpb246ICcnCiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCgogIElvbmljTW9kdWxlLmNvbmZpZyhbCiAgICAnJGlvbmljUGxhdGZvcm1EZWZhdWx0cycsCgogICAgJyRpbmplY3RvcicsCgogICAgZnVuY3Rpb24oJGlvbmljUGxhdGZvcm1EZWZhdWx0cywgJGluamVjdG9yKSB7CiAgICAgIHZhciBwbGF0Zm9ybSA9IGlvbmljLlBsYXRmb3JtLnBsYXRmb3JtKCk7CgogICAgICB2YXIgYXBwbHlDb25maWcgPSBmdW5jdGlvbihwbGF0Zm9ybURlZmF1bHRzKSB7CiAgICAgICAgZm9yRWFjaChwbGF0Zm9ybURlZmF1bHRzLCBmdW5jdGlvbihkZWZhdWx0cywgY29uc3RhbnROYW1lKSB7CiAgICAgICAgICBleHRlbmQoJGluamVjdG9yLmdldChjb25zdGFudE5hbWUpLCBkZWZhdWx0cyk7CiAgICAgICAgfSk7CiAgICAgIH07CgogICAgICBzd2l0Y2gocGxhdGZvcm0pIHsKICAgICAgICBjYXNlICdpb3MnOgogICAgICAgICAgYXBwbHlDb25maWcoJGlvbmljUGxhdGZvcm1EZWZhdWx0cy5pb3MpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnYW5kcm9pZCc6CiAgICAgICAgICBhcHBseUNvbmZpZygkaW9uaWNQbGF0Zm9ybURlZmF1bHRzLmFuZHJvaWQpOwogICAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH1dKTsKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkaW9uaWNQbGF0Zm9ybQogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBbiBhbmd1bGFyIGFic3RyYWN0aW9uIG9mIHtAbGluayBpb25pYy51dGlsaXR5OmlvbmljLlBsYXRmb3JtfS4KICAgKgogICAqIFVzZWQgdG8gZGV0ZWN0IHRoZSBjdXJyZW50IHBsYXRmb3JtLCBhcyB3ZWxsIGFzIGRvIHRoaW5ncyBsaWtlIG92ZXJyaWRlIHRoZQogICAqIEFuZHJvaWQgYmFjayBidXR0b24gaW4gUGhvbmVHYXAvQ29yZG92YS4KICAgKi8KICBJb25pY01vZHVsZQogICAgLnByb3ZpZGVyKCckaW9uaWNQbGF0Zm9ybScsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgICRnZXQ6IFsnJHEnLCAnJHJvb3RTY29wZScsIGZ1bmN0aW9uKCRxLCAkcm9vdFNjb3BlKSB7CiAgICAgICAgICB2YXIgc2VsZiA9IHsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lICRpb25pY1BsYXRmb3JtI29uSGFyZHdhcmVCYWNrQnV0dG9uCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBTb21lIHBsYXRmb3JtcyBoYXZlIGEgaGFyZHdhcmUgYmFjayBidXR0b24sIHNvIHRoaXMgaXMgb25lIHdheSB0bwogICAgICAgICAgICAgKiBiaW5kIHRvIGl0LgogICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayB0aGUgY2FsbGJhY2sgdG8gdHJpZ2dlciB3aGVuIHRoaXMgZXZlbnQgb2NjdXJzCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBvbkhhcmR3YXJlQmFja0J1dHRvbjogZnVuY3Rpb24oY2IpIHsKICAgICAgICAgICAgICBpb25pYy5QbGF0Zm9ybS5yZWFkeShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2JhY2tidXR0b24nLCBjYiwgZmFsc2UpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAgICogQG5hbWUgJGlvbmljUGxhdGZvcm0jb2ZmSGFyZHdhcmVCYWNrQnV0dG9uCiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBSZW1vdmUgYW4gZXZlbnQgbGlzdGVuZXIgZm9yIHRoZSBiYWNrYnV0dG9uLgogICAgICAgICAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgbGlzdGVuZXIgZnVuY3Rpb24gdGhhdCB3YXMKICAgICAgICAgICAgICogb3JpZ2luYWxseSBib3VuZC4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIG9mZkhhcmR3YXJlQmFja0J1dHRvbjogZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgICBpb25pYy5QbGF0Zm9ybS5yZWFkeShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2JhY2tidXR0b24nLCBmbik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNQbGF0Zm9ybSNyZWdpc3RlckJhY2tCdXR0b25BY3Rpb24KICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgICAqIFJlZ2lzdGVyIGEgaGFyZHdhcmUgYmFjayBidXR0b24gYWN0aW9uLiBPbmx5IG9uZSBhY3Rpb24gd2lsbCBleGVjdXRlCiAgICAgICAgICAgICAqIHdoZW4gdGhlIGJhY2sgYnV0dG9uIGlzIGNsaWNrZWQsIHNvIHRoaXMgbWV0aG9kIGRlY2lkZXMgd2hpY2ggb2YKICAgICAgICAgICAgICogdGhlIHJlZ2lzdGVyZWQgYmFjayBidXR0b24gYWN0aW9ucyBoYXMgdGhlIGhpZ2hlc3QgcHJpb3JpdHkuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEZvciBleGFtcGxlLCBpZiBhbiBhY3Rpb25zaGVldCBpcyBzaG93aW5nLCB0aGUgYmFjayBidXR0b24gc2hvdWxkCiAgICAgICAgICAgICAqIGNsb3NlIHRoZSBhY3Rpb25zaGVldCwgYnV0IGl0IHNob3VsZCBub3QgYWxzbyBnbyBiYWNrIGEgcGFnZSB2aWV3CiAgICAgICAgICAgICAqIG9yIGNsb3NlIGEgbW9kYWwgd2hpY2ggbWF5IGJlIG9wZW4uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCB3aGVuIHRoZSBiYWNrIGJ1dHRvbiBpcyBwcmVzc2VkLAogICAgICAgICAgICAgKiBpZiB0aGlzIGxpc3RlbmVyIGlzIHRoZSBoaWdoZXN0IHByaW9yaXR5LgogICAgICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gcHJpb3JpdHkgT25seSB0aGUgaGlnaGVzdCBwcmlvcml0eSB3aWxsIGV4ZWN1dGUuCiAgICAgICAgICAgICAqIEBwYXJhbSB7Kj19IGFjdGlvbklkIFRoZSBpZCB0byBhc3NpZ24gdGhpcyBhY3Rpb24uIERlZmF1bHQ6IGEKICAgICAgICAgICAgICogcmFuZG9tIHVuaXF1ZSBpZC4KICAgICAgICAgICAgICogQHJldHVybnMge2Z1bmN0aW9ufSBBIGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCB3aWxsIGRlcmVnaXN0ZXIKICAgICAgICAgICAgICogdGhpcyBiYWNrQnV0dG9uQWN0aW9uLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgJGJhY2tCdXR0b25BY3Rpb25zOiB7fSwKICAgICAgICAgICAgcmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uOiBmdW5jdGlvbihmbiwgcHJpb3JpdHksIGFjdGlvbklkKSB7CgogICAgICAgICAgICAgIGlmKCFzZWxmLl9oYXNCYWNrQnV0dG9uSGFuZGxlcikgewogICAgICAgICAgICAgICAgLy8gYWRkIGEgYmFjayBidXR0b24gbGlzdGVuZXIgaWYgb25lIGhhc24ndCBiZWVuIHNldHVwIHlldAogICAgICAgICAgICAgICAgc2VsZi4kYmFja0J1dHRvbkFjdGlvbnMgPSB7fTsKICAgICAgICAgICAgICAgIHNlbGYub25IYXJkd2FyZUJhY2tCdXR0b24oc2VsZi5oYXJkd2FyZUJhY2tCdXR0b25DbGljayk7CiAgICAgICAgICAgICAgICBzZWxmLl9oYXNCYWNrQnV0dG9uSGFuZGxlciA9IHRydWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gewogICAgICAgICAgICAgICAgaWQ6IChhY3Rpb25JZCA/IGFjdGlvbklkIDogaW9uaWMuVXRpbHMubmV4dFVpZCgpKSwKICAgICAgICAgICAgICAgIHByaW9yaXR5OiAocHJpb3JpdHkgPyBwcmlvcml0eSA6IDApLAogICAgICAgICAgICAgICAgZm46IGZuCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBzZWxmLiRiYWNrQnV0dG9uQWN0aW9uc1thY3Rpb24uaWRdID0gYWN0aW9uOwoKICAgICAgICAgICAgICAvLyByZXR1cm4gYSBmdW5jdGlvbiB0byBkZS1yZWdpc3RlciB0aGlzIGJhY2sgYnV0dG9uIGFjdGlvbgogICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBzZWxmLiRiYWNrQnV0dG9uQWN0aW9uc1thY3Rpb24uaWRdOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGhhcmR3YXJlQmFja0J1dHRvbkNsaWNrOiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAvLyBsb29wIHRocm91Z2ggYWxsIHRoZSByZWdpc3RlcmVkIGJhY2sgYnV0dG9uIGFjdGlvbnMKICAgICAgICAgICAgICAvLyBhbmQgb25seSBydW4gdGhlIGxhc3Qgb25lIG9mIHRoZSBoaWdoZXN0IHByaW9yaXR5CiAgICAgICAgICAgICAgdmFyIHByaW9yaXR5QWN0aW9uLCBhY3Rpb25JZDsKICAgICAgICAgICAgICBmb3IoYWN0aW9uSWQgaW4gc2VsZi4kYmFja0J1dHRvbkFjdGlvbnMpIHsKICAgICAgICAgICAgICAgIGlmKCFwcmlvcml0eUFjdGlvbiB8fCBzZWxmLiRiYWNrQnV0dG9uQWN0aW9uc1thY3Rpb25JZF0ucHJpb3JpdHkgPj0gcHJpb3JpdHlBY3Rpb24ucHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgICAgcHJpb3JpdHlBY3Rpb24gPSBzZWxmLiRiYWNrQnV0dG9uQWN0aW9uc1thY3Rpb25JZF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmKHByaW9yaXR5QWN0aW9uKSB7CiAgICAgICAgICAgICAgICBwcmlvcml0eUFjdGlvbi5mbihlKTsKICAgICAgICAgICAgICAgIHJldHVybiBwcmlvcml0eUFjdGlvbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBpczogZnVuY3Rpb24odHlwZSkgewogICAgICAgICAgICAgIHJldHVybiBpb25pYy5QbGF0Zm9ybS5pcyh0eXBlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgICAqIEBuYW1lICRpb25pY1BsYXRmb3JtI3JlYWR5CiAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgICAgICAgKiBUcmlnZ2VyIGEgY2FsbGJhY2sgb25jZSB0aGUgZGV2aWNlIGlzIHJlYWR5LAogICAgICAgICAgICAgKiBvciBpbW1lZGlhdGVseSBpZiB0aGUgZGV2aWNlIGlzIGFscmVhZHkgcmVhZHkuCiAgICAgICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb249fSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gY2FsbC4KICAgICAgICAgICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBkZXZpY2UgaXMgcmVhZHkuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICByZWFkeTogZnVuY3Rpb24oY2IpIHsKICAgICAgICAgICAgICB2YXIgcSA9ICRxLmRlZmVyKCk7CgogICAgICAgICAgICAgIGlvbmljLlBsYXRmb3JtLnJlYWR5KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBxLnJlc29sdmUoKTsKICAgICAgICAgICAgICAgIGNiICYmIGNiKCk7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIHJldHVybiBxLnByb21pc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICB9XQogICAgICB9OwoKICAgIH0pOwoKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkaW9uaWNQb3BvdmVyCiAgICogQG1vZHVsZSBpb25pYwogICAqIEBkZXNjcmlwdGlvbgogICAqCiAgICogUmVsYXRlZDoge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNQb3BvdmVyIGlvbmljUG9wb3ZlciBjb250cm9sbGVyfS4KICAgKgogICAqIFRoZSBQb3BvdmVyIGlzIGEgdmlldyB0aGF0IGZsb2F0cyBhYm92ZSBhbiBhcHDigJlzIGNvbnRlbnQuIFBvcG92ZXJzIHByb3ZpZGUgYW4KICAgKiBlYXN5IHdheSB0byBwcmVzZW50IG9yIGdhdGhlciBpbmZvcm1hdGlvbiBmcm9tIHRoZSB1c2VyIGFuZCBhcmUKICAgKiBjb21tb25seSB1c2VkIGluIHRoZSBmb2xsb3dpbmcgc2l0dWF0aW9uczoKICAgKgogICAqIC0gU2hvdyBtb3JlIGluZm8gYWJvdXQgdGhlIGN1cnJlbnQgdmlldwogICAqIC0gU2VsZWN0IGEgY29tbW9ubHkgdXNlZCB0b29sIG9yIGNvbmZpZ3VyYXRpb24KICAgKiAtIFByZXNlbnQgYSBsaXN0IG9mIGFjdGlvbnMgdG8gcGVyZm9ybSBpbnNpZGUgb25lIG9mIHlvdXIgdmlld3MKICAgKgogICAqIFB1dCB0aGUgY29udGVudCBvZiB0aGUgcG9wb3ZlciBpbnNpZGUgb2YgYW4gYDxpb24tcG9wb3Zlci12aWV3PmAgZWxlbWVudC4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8cD4KICAgKiAgIDxidXR0b24gbmctY2xpY2s9Im9wZW5Qb3BvdmVyKCRldmVudCkiPk9wZW4gUG9wb3ZlcjwvYnV0dG9uPgogICAqIDwvcD4KICAgKgogICAqIDxzY3JpcHQgaWQ9Im15LXBvcG92ZXIuaHRtbCIgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSI+CiAgICogICA8aW9uLXBvcG92ZXItdmlldz4KICAgKiAgICAgPGlvbi1oZWFkZXItYmFyPgogICAqICAgICAgIDxoMSBjbGFzcz0idGl0bGUiPk15IFBvcG92ZXIgVGl0bGU8L2gxPgogICAqICAgICA8L2lvbi1oZWFkZXItYmFyPgogICAqICAgICA8aW9uLWNvbnRlbnQ+CiAgICogICAgICAgSGVsbG8hCiAgICogICAgIDwvaW9uLWNvbnRlbnQ+CiAgICogICA8L2lvbi1wb3BvdmVyLXZpZXc+CiAgICogPC9zY3JpcHQ+CiAgICogYGBgCiAgICogYGBganMKICAgKiBhbmd1bGFyLm1vZHVsZSgndGVzdEFwcCcsIFsnaW9uaWMnXSkKICAgKiAuY29udHJvbGxlcignTXlDb250cm9sbGVyJywgZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNQb3BvdmVyKSB7CiAqICAgJGlvbmljUG9wb3Zlci5mcm9tVGVtcGxhdGVVcmwoJ215LXBvcG92ZXIuaHRtbCcsIHsKICogICAgIHNjb3BlOiAkc2NvcGUsCiAqICAgfSkudGhlbihmdW5jdGlvbihwb3BvdmVyKSB7CiAqICAgICAkc2NvcGUucG9wb3ZlciA9IHBvcG92ZXI7CiAqICAgfSk7CiAqICAgJHNjb3BlLm9wZW5Qb3BvdmVyID0gZnVuY3Rpb24oJGV2ZW50KSB7CiAqICAgICAkc2NvcGUucG9wb3Zlci5zaG93KCRldmVudCk7CiAqICAgfTsKICogICAkc2NvcGUuY2xvc2VQb3BvdmVyID0gZnVuY3Rpb24oKSB7CiAqICAgICAkc2NvcGUucG9wb3Zlci5oaWRlKCk7CiAqICAgfTsKICogICAvL0NsZWFudXAgdGhlIHBvcG92ZXIgd2hlbiB3ZSdyZSBkb25lIHdpdGggaXQhCiAqICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICogICAgICRzY29wZS5wb3BvdmVyLnJlbW92ZSgpOwogKiAgIH0pOwogKiAgIC8vIEV4ZWN1dGUgYWN0aW9uIG9uIGhpZGUgcG9wb3ZlcgogKiAgICRzY29wZS4kb24oJ3BvcG92ZXIuaGlkZGVuJywgZnVuY3Rpb24oKSB7CiAqICAgICAvLyBFeGVjdXRlIGFjdGlvbgogKiAgIH0pOwogKiAgIC8vIEV4ZWN1dGUgYWN0aW9uIG9uIHJlbW92ZSBwb3BvdmVyCiAqICAgJHNjb3BlLiRvbigncG9wb3Zlci5yZW1vdmVkJywgZnVuY3Rpb24oKSB7CiAqICAgICAvLyBFeGVjdXRlIGFjdGlvbgogKiAgIH0pOwogKiB9KTsKICAgKiBgYGAKICAgKi8KCgogIElvbmljTW9kdWxlCiAgICAuZmFjdG9yeSgnJGlvbmljUG9wb3ZlcicsIFsnJGlvbmljTW9kYWwnLCAnJGlvbmljUG9zaXRpb24nLCAnJGRvY3VtZW50JywKICAgICAgZnVuY3Rpb24oJGlvbmljTW9kYWwsICRpb25pY1Bvc2l0aW9uLCAkZG9jdW1lbnQpIHsKCiAgICAgICAgdmFyIFBPUE9WRVJfQk9EWV9QQURESU5HID0gNjsKCiAgICAgICAgdmFyIFBPUE9WRVJfT1BUSU9OUyA9IHsKICAgICAgICAgIHZpZXdUeXBlOiAncG9wb3ZlcicsCiAgICAgICAgICBoaWRlRGVsYXk6IDEsCiAgICAgICAgICBhbmltYXRpb246ICdub25lJywKICAgICAgICAgIHBvc2l0aW9uVmlldzogcG9zaXRpb25WaWV3CiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gcG9zaXRpb25WaWV3KHRhcmdldCwgcG9wb3ZlckVsZSkgewogICAgICAgICAgdmFyIHRhcmdldEVsZSA9IGFuZ3VsYXIuZWxlbWVudCh0YXJnZXQudGFyZ2V0IHx8IHRhcmdldCk7CiAgICAgICAgICB2YXIgYnV0dG9uT2Zmc2V0ID0gJGlvbmljUG9zaXRpb24ub2Zmc2V0KCB0YXJnZXRFbGUgKTsKICAgICAgICAgIHZhciBwb3BvdmVyV2lkdGggPSBwb3BvdmVyRWxlLnByb3AoJ29mZnNldFdpZHRoJyk7CiAgICAgICAgICB2YXIgYm9keVdpZHRoID0gJGRvY3VtZW50WzBdLmJvZHkuY2xpZW50V2lkdGg7CiAgICAgICAgICB2YXIgYm9keUhlaWdodCA9ICRkb2N1bWVudFswXS5ib2R5LmNsaWVudEhlaWdodDsKCiAgICAgICAgICB2YXIgcG9wb3ZlckNTUyA9IHsKICAgICAgICAgICAgdG9wOiBidXR0b25PZmZzZXQudG9wICsgYnV0dG9uT2Zmc2V0LmhlaWdodCwKICAgICAgICAgICAgbGVmdDogYnV0dG9uT2Zmc2V0LmxlZnQgKyBidXR0b25PZmZzZXQud2lkdGggLyAyIC0gcG9wb3ZlcldpZHRoIC8gMgogICAgICAgICAgfTsKCiAgICAgICAgICBpZihwb3BvdmVyQ1NTLmxlZnQgPCBQT1BPVkVSX0JPRFlfUEFERElORykgewogICAgICAgICAgICBwb3BvdmVyQ1NTLmxlZnQgPSBQT1BPVkVSX0JPRFlfUEFERElORzsKICAgICAgICAgIH0gZWxzZSBpZihwb3BvdmVyQ1NTLmxlZnQgKyBwb3BvdmVyV2lkdGggKyBQT1BPVkVSX0JPRFlfUEFERElORyA+IGJvZHlXaWR0aCkgewogICAgICAgICAgICBwb3BvdmVyQ1NTLmxlZnQgPSBib2R5V2lkdGggLSBwb3BvdmVyV2lkdGggLSBQT1BPVkVSX0JPRFlfUEFERElORzsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgYXJyb3dFbGUgPSBwb3BvdmVyRWxlWzBdLnF1ZXJ5U2VsZWN0b3IoJy5wb3BvdmVyLWFycm93Jyk7CiAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoYXJyb3dFbGUpLmNzcyh7CiAgICAgICAgICAgIGxlZnQ6IChidXR0b25PZmZzZXQubGVmdCAtIHBvcG92ZXJDU1MubGVmdCkgKyAoYnV0dG9uT2Zmc2V0LndpZHRoIC8gMikgLSAoYXJyb3dFbGUub2Zmc2V0V2lkdGggLyAyKSArICdweCcKICAgICAgICAgIH0pOwoKICAgICAgICAgIHBvcG92ZXJFbGUuY3NzKHsKICAgICAgICAgICAgdG9wOiBwb3BvdmVyQ1NTLnRvcCArICdweCcsCiAgICAgICAgICAgIGxlZnQ6IHBvcG92ZXJDU1MubGVmdCArICdweCcsCiAgICAgICAgICAgIG1hcmdpbkxlZnQ6ICcwJywKICAgICAgICAgICAgb3BhY2l0eTogJzEnCiAgICAgICAgICB9KTsKCiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgY29udHJvbGxlcgogICAgICAgICAqIEBuYW1lIGlvbmljUG9wb3ZlcgogICAgICAgICAqIEBtb2R1bGUgaW9uaWMKICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgKiBJbnN0YW50aWF0ZWQgYnkgdGhlIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1BvcG92ZXJ9IHNlcnZpY2UuCiAgICAgICAgICoKICAgICAgICAgKiBCZSBzdXJlIHRvIGNhbGwgW3JlbW92ZSgpXSgjcmVtb3ZlKSB3aGVuIHlvdSBhcmUgZG9uZSB3aXRoIGVhY2ggcG9wb3ZlcgogICAgICAgICAqIHRvIGNsZWFuIGl0IHVwIGFuZCBhdm9pZCBtZW1vcnkgbGVha3MuCiAgICAgICAgICoKICAgICAgICAgKiBOb3RlOiBhIHBvcG92ZXIgd2lsbCBicm9hZGNhc3QgJ3BvcG92ZXIuc2hvd24nLCAncG9wb3Zlci5oaWRkZW4nLCBhbmQgJ3BvcG92ZXIucmVtb3ZlZCcgZXZlbnRzIGZyb20gaXRzIG9yaWdpbmF0aW5nCiAgICAgICAgICogc2NvcGUsIHBhc3NpbmcgaW4gaXRzZWxmIGFzIGFuIGV2ZW50IGFyZ3VtZW50LiBCb3RoIHRoZSBwb3BvdmVyLnJlbW92ZWQgYW5kIHBvcG92ZXIuaGlkZGVuIGV2ZW50cyBhcmUKICAgICAgICAgKiBjYWxsZWQgd2hlbiB0aGUgcG9wb3ZlciBpcyByZW1vdmVkLgogICAgICAgICAqLwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgaW9uaWNQb3BvdmVyI2luaXRpYWxpemUKICAgICAgICAgKiBAZGVzY3JpcHRpb24gQ3JlYXRlcyBhIG5ldyBwb3BvdmVyIGNvbnRyb2xsZXIgaW5zdGFuY2UuCiAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgQW4gb3B0aW9ucyBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgICAgICogIC0gYHtvYmplY3Q9fWAgYHNjb3BlYCBUaGUgc2NvcGUgdG8gYmUgYSBjaGlsZCBvZi4KICAgICAgICAgKiAgICBEZWZhdWx0OiBjcmVhdGVzIGEgY2hpbGQgb2YgJHJvb3RTY29wZS4KICAgICAgICAgKiAgLSBge2Jvb2xlYW49fWAgYGZvY3VzRmlyc3RJbnB1dGAgV2hldGhlciB0byBhdXRvZm9jdXMgdGhlIGZpcnN0IGlucHV0IG9mCiAgICAgICAgICogICAgdGhlIHBvcG92ZXIgd2hlbiBzaG93bi4gIERlZmF1bHQ6IGZhbHNlLgogICAgICAgICAqICAtIGB7Ym9vbGVhbj19YCBgYmFja2Ryb3BDbGlja1RvQ2xvc2VgIFdoZXRoZXIgdG8gY2xvc2UgdGhlIHBvcG92ZXIgb24gY2xpY2tpbmcgdGhlIGJhY2tkcm9wLgogICAgICAgICAqICAgIERlZmF1bHQ6IHRydWUuCiAgICAgICAgICogIC0gYHtib29sZWFuPX1gIGBoYXJkd2FyZUJhY2tCdXR0b25DbG9zZWAgV2hldGhlciB0aGUgcG9wb3ZlciBjYW4gYmUgY2xvc2VkIHVzaW5nIHRoZSBoYXJkd2FyZQogICAgICAgICAqICAgIGJhY2sgYnV0dG9uIG9uIEFuZHJvaWQgYW5kIHNpbWlsYXIgZGV2aWNlcy4gIERlZmF1bHQ6IHRydWUuCiAgICAgICAgICovCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBpb25pY1BvcG92ZXIjc2hvdwogICAgICAgICAqIEBkZXNjcmlwdGlvbiBTaG93IHRoaXMgcG9wb3ZlciBpbnN0YW5jZS4KICAgICAgICAgKiBAcGFyYW0geyRldmVudH0gJGV2ZW50IFRoZSAkZXZlbnQgb3IgdGFyZ2V0IGVsZW1lbnQgd2hpY2ggdGhlIHBvcG92ZXIgc2hvdWxkIGFsaWduCiAgICAgICAgICogaXRzZWxmIG5leHQgdG8uCiAgICAgICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBwb3BvdmVyIGlzIGZpbmlzaGVkIGFuaW1hdGluZyBpbi4KICAgICAgICAgKi8KCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lIGlvbmljUG9wb3ZlciNoaWRlCiAgICAgICAgICogQGRlc2NyaXB0aW9uIEhpZGUgdGhpcyBwb3BvdmVyIGluc3RhbmNlLgogICAgICAgICAqIEByZXR1cm5zIHtwcm9taXNlfSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgcG9wb3ZlciBpcyBmaW5pc2hlZCBhbmltYXRpbmcgb3V0LgogICAgICAgICAqLwoKICAgICAgICAvKioKICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICogQG5hbWUgaW9uaWNQb3BvdmVyI3JlbW92ZQogICAgICAgICAqIEBkZXNjcmlwdGlvbiBSZW1vdmUgdGhpcyBwb3BvdmVyIGluc3RhbmNlIGZyb20gdGhlIERPTSBhbmQgY2xlYW4gdXAuCiAgICAgICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBwb3BvdmVyIGlzIGZpbmlzaGVkIGFuaW1hdGluZyBvdXQuCiAgICAgICAgICovCgogICAgICAgIC8qKgogICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgKiBAbmFtZSBpb25pY1BvcG92ZXIjaXNTaG93bgogICAgICAgICAqIEByZXR1cm5zIGJvb2xlYW4gV2hldGhlciB0aGlzIHBvcG92ZXIgaXMgY3VycmVudGx5IHNob3duLgogICAgICAgICAqLwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNQb3BvdmVyI2Zyb21UZW1wbGF0ZQogICAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRlbXBsYXRlU3RyaW5nIFRoZSB0ZW1wbGF0ZSBzdHJpbmcgdG8gdXNlIGFzIHRoZSBwb3BvdmVycydzCiAgICAgICAgICAgKiBjb250ZW50LgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgT3B0aW9ucyB0byBiZSBwYXNzZWQgdG8gdGhlIGluaXRpYWxpemUgbWV0aG9kLgogICAgICAgICAgICogQHJldHVybnMge29iamVjdH0gQW4gaW5zdGFuY2Ugb2YgYW4ge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNQb3BvdmVyfQogICAgICAgICAgICogY29udHJvbGxlciAoJGlvbmljUG9wb3ZlciBpcyBidWlsdCBvbiB0b3Agb2YgJGlvbmljUG9wb3ZlcikuCiAgICAgICAgICAgKi8KICAgICAgICAgIGZyb21UZW1wbGF0ZTogZnVuY3Rpb24odGVtcGxhdGVTdHJpbmcsIG9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuICRpb25pY01vZGFsLmZyb21UZW1wbGF0ZSh0ZW1wbGF0ZVN0cmluZywgaW9uaWMuVXRpbHMuZXh0ZW5kKG9wdGlvbnMgfHwge30sIFBPUE9WRVJfT1BUSU9OUykgKTsKICAgICAgICAgIH0sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRpb25pY1BvcG92ZXIjZnJvbVRlbXBsYXRlVXJsCiAgICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGVtcGxhdGVVcmwgVGhlIHVybCB0byBsb2FkIHRoZSB0ZW1wbGF0ZSBmcm9tLgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgT3B0aW9ucyB0byBiZSBwYXNzZWQgdG8gdGhlIGluaXRpYWxpemUgbWV0aG9kLgogICAgICAgICAgICogQHJldHVybnMge3Byb21pc2V9IEEgcHJvbWlzZSB0aGF0IHdpbGwgYmUgcmVzb2x2ZWQgd2l0aCBhbiBpbnN0YW5jZSBvZgogICAgICAgICAgICogYW4ge0BsaW5rIGlvbmljLmNvbnRyb2xsZXI6aW9uaWNQb3BvdmVyfSBjb250cm9sbGVyICgkaW9uaWNQb3BvdmVyIGlzIGJ1aWx0IG9uIHRvcCBvZiAkaW9uaWNQb3BvdmVyKS4KICAgICAgICAgICAqLwogICAgICAgICAgZnJvbVRlbXBsYXRlVXJsOiBmdW5jdGlvbih1cmwsIG9wdGlvbnMsIF8pIHsKICAgICAgICAgICAgcmV0dXJuICRpb25pY01vZGFsLmZyb21UZW1wbGF0ZVVybCh1cmwsIG9wdGlvbnMsIGlvbmljLlV0aWxzLmV4dGVuZChvcHRpb25zIHx8IHt9LCBQT1BPVkVSX09QVElPTlMpICk7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgIH1dKTsKCgogIHZhciBQT1BVUF9UUEwgPQogICAgJzxkaXYgY2xhc3M9InBvcHVwIj4nICsKICAgICc8ZGl2IGNsYXNzPSJwb3B1cC1oZWFkIj4nICsKICAgICc8aDMgY2xhc3M9InBvcHVwLXRpdGxlIiBuZy1iaW5kLWh0bWw9InRpdGxlIj48L2gzPicgKwogICAgJzxoNSBjbGFzcz0icG9wdXAtc3ViLXRpdGxlIiBuZy1iaW5kLWh0bWw9InN1YlRpdGxlIiBuZy1pZj0ic3ViVGl0bGUiPjwvaDU+JyArCiAgICAnPC9kaXY+JyArCiAgICAnPGRpdiBjbGFzcz0icG9wdXAtYm9keSI+JyArCiAgICAnPC9kaXY+JyArCiAgICAnPGRpdiBjbGFzcz0icG9wdXAtYnV0dG9ucyByb3ciPicgKwogICAgJzxidXR0b24gbmctcmVwZWF0PSJidXR0b24gaW4gYnV0dG9ucyIgbmctY2xpY2s9IiRidXR0b25UYXBwZWQoYnV0dG9uLCAkZXZlbnQpIiBjbGFzcz0iYnV0dG9uIGNvbCIgbmctY2xhc3M9ImJ1dHRvbi50eXBlIHx8IFwnYnV0dG9uLWRlZmF1bHRcJyIgbmctYmluZC1odG1sPSJidXR0b24udGV4dCI+PC9idXR0b24+JyArCiAgICAnPC9kaXY+JyArCiAgICAnPC9kaXY+JzsKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkaW9uaWNQb3B1cAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgRQogICAqIEBjb2RlcGVuIHprbWhKCiAgICogQGRlc2NyaXB0aW9uCiAgICoKICAgKiBUaGUgSW9uaWMgUG9wdXAgc2VydmljZSBhbGxvd3MgcHJvZ3JhbW1hdGljYWxseSBjcmVhdGluZyBhbmQgc2hvd2luZyBwb3B1cAogICAqIHdpbmRvd3MgdGhhdCByZXF1aXJlIHRoZSB1c2VyIHRvIHJlc3BvbmQgaW4gb3JkZXIgdG8gY29udGludWUuCiAgICoKICAgKiBUaGUgcG9wdXAgc3lzdGVtIGhhcyBzdXBwb3J0IGZvciBtb3JlIGZsZXhpYmxlIHZlcnNpb25zIG9mIHRoZSBidWlsdCBpbiBgYWxlcnQoKWAsIGBwcm9tcHQoKWAsCiAgICogYW5kIGBjb25maXJtKClgIGZ1bmN0aW9ucyB0aGF0IHVzZXJzIGFyZSB1c2VkIHRvLCBpbiBhZGRpdGlvbiB0byBhbGxvd2luZyBwb3B1cHMgd2l0aCBjb21wbGV0ZWx5CiAgICogY3VzdG9tIGNvbnRlbnQgYW5kIGxvb2suCiAgICoKICAgKiBBbiBpbnB1dCBjYW4gYmUgZ2l2ZW4gYW4gYGF1dG9mb2N1c2AgYXR0cmlidXRlIHNvIGl0IGF1dG9tYXRpY2FsbHkgcmVjZWl2ZXMgZm9jdXMgd2hlbgogICAqIHRoZSBwb3B1cCBmaXJzdCBzaG93cy4gSG93ZXZlciwgZGVwZW5kaW5nIG9uIGNlcnRhaW4gdXNlLWNhc2VzIHRoaXMgY2FuIGNhdXNlIGlzc3VlcyB3aXRoCiAgICogdGhlIHRhcC9jbGljayBzeXN0ZW0sIHdoaWNoIGlzIHdoeSBJb25pYyBwcmVmZXJzIHVzaW5nIHRoZSBgYXV0b2ZvY3VzYCBhdHRyaWJ1dGUgYXMKICAgKiBhbiBvcHQtaW4gZmVhdHVyZSBhbmQgbm90IHRoZSBkZWZhdWx0LgogICAqCiAgICogQHVzYWdlCiAgICogQSBmZXcgYmFzaWMgZXhhbXBsZXMsIHNlZSBiZWxvdyBmb3IgZGV0YWlscyBhYm91dCBhbGwgb2YgdGhlIG9wdGlvbnMgYXZhaWxhYmxlLgogICAqCiAgICogYGBganMKICAgKmFuZ3VsYXIubW9kdWxlKCdteVN1cGVyQXBwJywgWydpb25pYyddKQogICAqLmNvbnRyb2xsZXIoJ1BvcHVwQ3RybCcsZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNQb3B1cCwgJHRpbWVvdXQpIHsKICoKICogLy8gVHJpZ2dlcmVkIG9uIGEgYnV0dG9uIGNsaWNrLCBvciBzb21lIG90aGVyIHRhcmdldAogKiAkc2NvcGUuc2hvd1BvcHVwID0gZnVuY3Rpb24oKSB7CiAqICAgJHNjb3BlLmRhdGEgPSB7fQogKgogKiAgIC8vIEFuIGVsYWJvcmF0ZSwgY3VzdG9tIHBvcHVwCiAqICAgdmFyIG15UG9wdXAgPSAkaW9uaWNQb3B1cC5zaG93KHsKICogICAgIHRlbXBsYXRlOiAnPGlucHV0IHR5cGU9InBhc3N3b3JkIiBuZy1tb2RlbD0iZGF0YS53aWZpIj4nLAogKiAgICAgdGl0bGU6ICdFbnRlciBXaS1GaSBQYXNzd29yZCcsCiAqICAgICBzdWJUaXRsZTogJ1BsZWFzZSB1c2Ugbm9ybWFsIHRoaW5ncycsCiAqICAgICBzY29wZTogJHNjb3BlLAogKiAgICAgYnV0dG9uczogWwogKiAgICAgICB7IHRleHQ6ICdDYW5jZWwnIH0sCiAqICAgICAgIHsKICogICAgICAgICB0ZXh0OiAnPGI+U2F2ZTwvYj4nLAogKiAgICAgICAgIHR5cGU6ICdidXR0b24tcG9zaXRpdmUnLAogKiAgICAgICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7CiAqICAgICAgICAgICBpZiAoISRzY29wZS5kYXRhLndpZmkpIHsKICogICAgICAgICAgICAgLy9kb24ndCBhbGxvdyB0aGUgdXNlciB0byBjbG9zZSB1bmxlc3MgaGUgZW50ZXJzIHdpZmkgcGFzc3dvcmQKICogICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogKiAgICAgICAgICAgfSBlbHNlIHsKICogICAgICAgICAgICAgcmV0dXJuICRzY29wZS5kYXRhLndpZmk7CiAqICAgICAgICAgICB9CiAqICAgICAgICAgfQogKiAgICAgICB9LAogKiAgICAgXQogKiAgIH0pOwogKiAgIG15UG9wdXAudGhlbihmdW5jdGlvbihyZXMpIHsKICogICAgIGNvbnNvbGUubG9nKCdUYXBwZWQhJywgcmVzKTsKICogICB9KTsKICogICAkdGltZW91dChmdW5jdGlvbigpIHsKICogICAgICBteVBvcHVwLmNsb3NlKCk7IC8vY2xvc2UgdGhlIHBvcHVwIGFmdGVyIDMgc2Vjb25kcyBmb3Igc29tZSByZWFzb24KICogICB9LCAzMDAwKTsKICogIH07CiAqICAvLyBBIGNvbmZpcm0gZGlhbG9nCiAqICAkc2NvcGUuc2hvd0NvbmZpcm0gPSBmdW5jdGlvbigpIHsKICogICAgdmFyIGNvbmZpcm1Qb3B1cCA9ICRpb25pY1BvcHVwLmNvbmZpcm0oewogKiAgICAgIHRpdGxlOiAnQ29uc3VtZSBJY2UgQ3JlYW0nLAogKiAgICAgIHRlbXBsYXRlOiAnQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGVhdCB0aGlzIGljZSBjcmVhbT8nCiAqICAgIH0pOwogKiAgICBjb25maXJtUG9wdXAudGhlbihmdW5jdGlvbihyZXMpIHsKICogICAgICBpZihyZXMpIHsKICogICAgICAgIGNvbnNvbGUubG9nKCdZb3UgYXJlIHN1cmUnKTsKICogICAgICB9IGVsc2UgewogKiAgICAgICAgY29uc29sZS5sb2coJ1lvdSBhcmUgbm90IHN1cmUnKTsKICogICAgICB9CiAqICAgIH0pOwogKiAgfTsKICoKICogIC8vIEFuIGFsZXJ0IGRpYWxvZwogKiAgJHNjb3BlLnNob3dBbGVydCA9IGZ1bmN0aW9uKCkgewogKiAgICB2YXIgYWxlcnRQb3B1cCA9ICRpb25pY1BvcHVwLmFsZXJ0KHsKICogICAgICB0aXRsZTogJ0RvblwndCBlYXQgdGhhdCEnLAogKiAgICAgIHRlbXBsYXRlOiAnSXQgbWlnaHQgdGFzdGUgZ29vZCcKICogICAgfSk7CiAqICAgIGFsZXJ0UG9wdXAudGhlbihmdW5jdGlvbihyZXMpIHsKICogICAgICBjb25zb2xlLmxvZygnVGhhbmsgeW91IGZvciBub3QgZWF0aW5nIG15IGRlbGljaW91cyBpY2UgY3JlYW0gY29uZScpOwogKiAgICB9KTsKICogIH07CiAqfSk7CiAgICpgYGAKICAgKi8KCiAgSW9uaWNNb2R1bGUKICAgIC5mYWN0b3J5KCckaW9uaWNQb3B1cCcsIFsKICAgICAgJyRpb25pY1RlbXBsYXRlTG9hZGVyJywKICAgICAgJyRpb25pY0JhY2tkcm9wJywKICAgICAgJyRxJywKICAgICAgJyR0aW1lb3V0JywKICAgICAgJyRyb290U2NvcGUnLAogICAgICAnJGRvY3VtZW50JywKICAgICAgJyRjb21waWxlJywKICAgICAgJyRpb25pY1BsYXRmb3JtJywKICAgICAgZnVuY3Rpb24oJGlvbmljVGVtcGxhdGVMb2FkZXIsICRpb25pY0JhY2tkcm9wLCAkcSwgJHRpbWVvdXQsICRyb290U2NvcGUsICRkb2N1bWVudCwgJGNvbXBpbGUsICRpb25pY1BsYXRmb3JtKSB7CiAgICAgICAgLy9UT0RPIGFsbG93IHRoaXMgdG8gYmUgY29uZmlndXJlZAogICAgICAgIHZhciBjb25maWcgPSB7CiAgICAgICAgICBzdGFja1B1c2hEZWxheTogNTAKICAgICAgICB9OwogICAgICAgIHZhciBwb3B1cFN0YWNrID0gW107CiAgICAgICAgdmFyICRpb25pY1BvcHVwID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICAgICAqIFNob3cgYSBjb21wbGV4IHBvcHVwLiBUaGlzIGlzIHRoZSBtYXN0ZXIgc2hvdyBmdW5jdGlvbiBmb3IgYWxsIHBvcHVwcy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBBIGNvbXBsZXggcG9wdXAgaGFzIGEgYGJ1dHRvbnNgIGFycmF5LCB3aXRoIGVhY2ggYnV0dG9uIGhhdmluZyBhIGB0ZXh0YCBhbmQgYHR5cGVgCiAgICAgICAgICAgKiBmaWVsZCwgaW4gYWRkaXRpb24gdG8gYW4gYG9uVGFwYCBmdW5jdGlvbi4gIFRoZSBgb25UYXBgIGZ1bmN0aW9uLCBjYWxsZWQgd2hlbgogICAgICAgICAgICogdGhlIGNvcnJlc3BvbmRpbmdidXR0b24gb24gdGhlIHBvcHVwIGlzIHRhcHBlZCwgd2lsbCBieSBkZWZhdWx0IGNsb3NlIHRoZSBwb3B1cAogICAgICAgICAgICogYW5kIHJlc29sdmUgdGhlIHBvcHVwIHByb21pc2Ugd2l0aCBpdHMgcmV0dXJuIHZhbHVlLiAgSWYgeW91IHdpc2ggdG8gcHJldmVudCB0aGUKICAgICAgICAgICAqIGRlZmF1bHQgYW5kIGtlZXAgdGhlIHBvcHVwIG9wZW4gb24gYnV0dG9uIHRhcCwgY2FsbCBgZXZlbnQucHJldmVudERlZmF1bHQoKWAgb24gdGhlCiAgICAgICAgICAgKiBwYXNzZWQgaW4gdGFwIGV2ZW50LiAgRGV0YWlscyBiZWxvdy4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNQb3B1cCNzaG93CiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBUaGUgb3B0aW9ucyBmb3IgdGhlIG5ldyBwb3B1cCwgb2YgdGhlIGZvcm06CiAgICAgICAgICAgKgogICAgICAgICAgICogYGBgCiAgICAgICAgICAgKiB7CiAgICAgKiAgIHRpdGxlOiAnJywgLy8gU3RyaW5nLiBUaGUgdGl0bGUgb2YgdGhlIHBvcHVwLgogICAgICogICBzdWJUaXRsZTogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgc3ViLXRpdGxlIG9mIHRoZSBwb3B1cC4KICAgICAqICAgdGVtcGxhdGU6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIGh0bWwgdGVtcGxhdGUgdG8gcGxhY2UgaW4gdGhlIHBvcHVwIGJvZHkuCiAgICAgKiAgIHRlbXBsYXRlVXJsOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBVUkwgb2YgYW4gaHRtbCB0ZW1wbGF0ZSB0byBwbGFjZSBpbiB0aGUgcG9wdXAgICBib2R5LgogICAgICogICBzY29wZTogbnVsbCwgLy8gU2NvcGUgKG9wdGlvbmFsKS4gQSBzY29wZSB0byBsaW5rIHRvIHRoZSBwb3B1cCBjb250ZW50LgogICAgICogICBidXR0b25zOiBbeyAvL0FycmF5W09iamVjdF0gKG9wdGlvbmFsKS4gQnV0dG9ucyB0byBwbGFjZSBpbiB0aGUgcG9wdXAgZm9vdGVyLgogICAgICogICAgIHRleHQ6ICdDYW5jZWwnLAogICAgICogICAgIHR5cGU6ICdidXR0b24tZGVmYXVsdCcsCiAgICAgKiAgICAgb25UYXA6IGZ1bmN0aW9uKGUpIHsKICAgICAqICAgICAgIC8vIGUucHJldmVudERlZmF1bHQoKSB3aWxsIHN0b3AgdGhlIHBvcHVwIGZyb20gY2xvc2luZyB3aGVuIHRhcHBlZC4KICAgICAqICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAqICAgICB9CiAgICAgKiAgIH0sIHsKICAgICAqICAgICB0ZXh0OiAnT0snLAogICAgICogICAgIHR5cGU6ICdidXR0b24tcG9zaXRpdmUnLAogICAgICogICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7CiAgICAgKiAgICAgICAvLyBSZXR1cm5pbmcgYSB2YWx1ZSB3aWxsIGNhdXNlIHRoZSBwcm9taXNlIHRvIHJlc29sdmUgd2l0aCB0aGUgZ2l2ZW4gdmFsdWUuCiAgICAgKiAgICAgICByZXR1cm4gc2NvcGUuZGF0YS5yZXNwb25zZTsKICAgICAqICAgICB9CiAgICAgKiAgIH1dCiAgICAgKiB9CiAgICAgICAgICAgKiBgYGAKICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgcG9wdXAgaXMgY2xvc2VkLiBIYXMgYW4gYWRkaXRpb25hbAogICAgICAgICAgICogYGNsb3NlYCBmdW5jdGlvbiwgd2hpY2ggY2FuIGJlIHVzZWQgdG8gcHJvZ3JhbW1hdGljYWxseSBjbG9zZSB0aGUgcG9wdXAuCiAgICAgICAgICAgKi8KICAgICAgICAgIHNob3c6IHNob3dQb3B1cCwKCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICAgICAqIEBuYW1lICRpb25pY1BvcHVwI2FsZXJ0CiAgICAgICAgICAgKiBAZGVzY3JpcHRpb24gU2hvdyBhIHNpbXBsZSBhbGVydCBwb3B1cCB3aXRoIGEgbWVzc2FnZSBhbmQgb25lIGJ1dHRvbiB0aGF0IHRoZSB1c2VyIGNhbgogICAgICAgICAgICogdGFwIHRvIGNsb3NlIHRoZSBwb3B1cC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBUaGUgb3B0aW9ucyBmb3Igc2hvd2luZyB0aGUgYWxlcnQsIG9mIHRoZSBmb3JtOgogICAgICAgICAgICoKICAgICAgICAgICAqIGBgYAogICAgICAgICAgICogewogICAgICogICB0aXRsZTogJycsIC8vIFN0cmluZy4gVGhlIHRpdGxlIG9mIHRoZSBwb3B1cC4KICAgICAqICAgc3ViVGl0bGU6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIHN1Yi10aXRsZSBvZiB0aGUgcG9wdXAuCiAgICAgKiAgIHRlbXBsYXRlOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBodG1sIHRlbXBsYXRlIHRvIHBsYWNlIGluIHRoZSBwb3B1cCBib2R5LgogICAgICogICB0ZW1wbGF0ZVVybDogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgVVJMIG9mIGFuIGh0bWwgdGVtcGxhdGUgdG8gcGxhY2UgaW4gdGhlIHBvcHVwICAgYm9keS4KICAgICAqICAgb2tUZXh0OiAnJywgLy8gU3RyaW5nIChkZWZhdWx0OiAnT0snKS4gVGhlIHRleHQgb2YgdGhlIE9LIGJ1dHRvbi4KICAgICAqICAgb2tUeXBlOiAnJywgLy8gU3RyaW5nIChkZWZhdWx0OiAnYnV0dG9uLXBvc2l0aXZlJykuIFRoZSB0eXBlIG9mIHRoZSBPSyBidXR0b24uCiAgICAgKiB9CiAgICAgICAgICAgKiBgYGAKICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBIHByb21pc2Ugd2hpY2ggaXMgcmVzb2x2ZWQgd2hlbiB0aGUgcG9wdXAgaXMgY2xvc2VkLiBIYXMgb25lIGFkZGl0aW9uYWwKICAgICAgICAgICAqIGZ1bmN0aW9uIGBjbG9zZWAsIHdoaWNoIGNhbiBiZSBjYWxsZWQgd2l0aCBhbnkgdmFsdWUgdG8gcHJvZ3JhbW1hdGljYWxseSBjbG9zZSB0aGUgcG9wdXAKICAgICAgICAgICAqIHdpdGggdGhlIGdpdmVuIHZhbHVlLgogICAgICAgICAgICovCiAgICAgICAgICBhbGVydDogc2hvd0FsZXJ0LAoKICAgICAgICAgIC8qKgogICAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAgICogQG5hbWUgJGlvbmljUG9wdXAjY29uZmlybQogICAgICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAgICAgKiBTaG93IGEgc2ltcGxlIGNvbmZpcm0gcG9wdXAgd2l0aCBhIENhbmNlbCBhbmQgT0sgYnV0dG9uLgogICAgICAgICAgICoKICAgICAgICAgICAqIFJlc29sdmVzIHRoZSBwcm9taXNlIHdpdGggdHJ1ZSBpZiB0aGUgdXNlciBwcmVzc2VzIHRoZSBPSyBidXR0b24sIGFuZCBmYWxzZSBpZiB0aGUKICAgICAgICAgICAqIHVzZXIgcHJlc3NlcyB0aGUgQ2FuY2VsIGJ1dHRvbi4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyBUaGUgb3B0aW9ucyBmb3Igc2hvd2luZyB0aGUgY29uZmlybSBwb3B1cCwgb2YgdGhlIGZvcm06CiAgICAgICAgICAgKgogICAgICAgICAgICogYGBgCiAgICAgICAgICAgKiB7CiAgICAgKiAgIHRpdGxlOiAnJywgLy8gU3RyaW5nLiBUaGUgdGl0bGUgb2YgdGhlIHBvcHVwLgogICAgICogICBzdWJUaXRsZTogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgc3ViLXRpdGxlIG9mIHRoZSBwb3B1cC4KICAgICAqICAgdGVtcGxhdGU6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIGh0bWwgdGVtcGxhdGUgdG8gcGxhY2UgaW4gdGhlIHBvcHVwIGJvZHkuCiAgICAgKiAgIHRlbXBsYXRlVXJsOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBVUkwgb2YgYW4gaHRtbCB0ZW1wbGF0ZSB0byBwbGFjZSBpbiB0aGUgcG9wdXAgICBib2R5LgogICAgICogICBjYW5jZWxUZXh0OiAnJywgLy8gU3RyaW5nIChkZWZhdWx0OiAnQ2FuY2VsJykuIFRoZSB0ZXh0IG9mIHRoZSBDYW5jZWwgYnV0dG9uLgogICAgICogICBjYW5jZWxUeXBlOiAnJywgLy8gU3RyaW5nIChkZWZhdWx0OiAnYnV0dG9uLWRlZmF1bHQnKS4gVGhlIHR5cGUgb2YgdGhlIENhbmNlbCBidXR0b24uCiAgICAgKiAgIG9rVGV4dDogJycsIC8vIFN0cmluZyAoZGVmYXVsdDogJ09LJykuIFRoZSB0ZXh0IG9mIHRoZSBPSyBidXR0b24uCiAgICAgKiAgIG9rVHlwZTogJycsIC8vIFN0cmluZyAoZGVmYXVsdDogJ2J1dHRvbi1wb3NpdGl2ZScpLiBUaGUgdHlwZSBvZiB0aGUgT0sgYnV0dG9uLgogICAgICogfQogICAgICAgICAgICogYGBgCiAgICAgICAgICAgKgogICAgICAgICAgICogQHJldHVybnMge29iamVjdH0gQSBwcm9taXNlIHdoaWNoIGlzIHJlc29sdmVkIHdoZW4gdGhlIHBvcHVwIGlzIGNsb3NlZC4gSGFzIG9uZSBhZGRpdGlvbmFsCiAgICAgICAgICAgKiBmdW5jdGlvbiBgY2xvc2VgLCB3aGljaCBjYW4gYmUgY2FsbGVkIHdpdGggYW55IHZhbHVlIHRvIHByb2dyYW1tYXRpY2FsbHkgY2xvc2UgdGhlIHBvcHVwCiAgICAgICAgICAgKiB3aXRoIHRoZSBnaXZlbiB2YWx1ZS4KICAgICAgICAgICAqLwogICAgICAgICAgY29uZmlybTogc2hvd0NvbmZpcm0sCgogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgICAgICAgKiBAbmFtZSAkaW9uaWNQb3B1cCNwcm9tcHQKICAgICAgICAgICAqIEBkZXNjcmlwdGlvbiBTaG93IGEgc2ltcGxlIHByb21wdCBwb3B1cCwgd2hpY2ggaGFzIGFuIGlucHV0LCBPSyBidXR0b24sIGFuZCBDYW5jZWwgYnV0dG9uLgogICAgICAgICAgICogUmVzb2x2ZXMgdGhlIHByb21pc2Ugd2l0aCB0aGUgdmFsdWUgb2YgdGhlIGlucHV0IGlmIHRoZSB1c2VyIHByZXNzZXMgT0ssIGFuZCB3aXRoIHVuZGVmaW5lZAogICAgICAgICAgICogaWYgdGhlIHVzZXIgcHJlc3NlcyBDYW5jZWwuCiAgICAgICAgICAgKgogICAgICAgICAgICogYGBgamF2YXNjcmlwdAogICAgICAgICAgICogICRpb25pY1BvcHVwLnByb21wdCh7CiAgICAgKiAgICB0aXRsZTogJ1Bhc3N3b3JkIENoZWNrJywKICAgICAqICAgIHRlbXBsYXRlOiAnRW50ZXIgeW91ciBzZWNyZXQgcGFzc3dvcmQnLAogICAgICogICAgaW5wdXRUeXBlOiAncGFzc3dvcmQnLAogICAgICogICAgaW5wdXRQbGFjZWhvbGRlcjogJ1lvdXIgcGFzc3dvcmQnCiAgICAgKiAgfSkudGhlbihmdW5jdGlvbihyZXMpIHsKICAgICAqICAgIGNvbnNvbGUubG9nKCdZb3VyIHBhc3N3b3JkIGlzJywgcmVzKTsKICAgICAqICB9KTsKICAgICAgICAgICAqIGBgYAogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgVGhlIG9wdGlvbnMgZm9yIHNob3dpbmcgdGhlIHByb21wdCBwb3B1cCwgb2YgdGhlIGZvcm06CiAgICAgICAgICAgKgogICAgICAgICAgICogYGBgCiAgICAgICAgICAgKiB7CiAgICAgKiAgIHRpdGxlOiAnJywgLy8gU3RyaW5nLiBUaGUgdGl0bGUgb2YgdGhlIHBvcHVwLgogICAgICogICBzdWJUaXRsZTogJycsIC8vIFN0cmluZyAob3B0aW9uYWwpLiBUaGUgc3ViLXRpdGxlIG9mIHRoZSBwb3B1cC4KICAgICAqICAgdGVtcGxhdGU6ICcnLCAvLyBTdHJpbmcgKG9wdGlvbmFsKS4gVGhlIGh0bWwgdGVtcGxhdGUgdG8gcGxhY2UgaW4gdGhlIHBvcHVwIGJvZHkuCiAgICAgKiAgIHRlbXBsYXRlVXJsOiAnJywgLy8gU3RyaW5nIChvcHRpb25hbCkuIFRoZSBVUkwgb2YgYW4gaHRtbCB0ZW1wbGF0ZSB0byBwbGFjZSBpbiB0aGUgcG9wdXAgICBib2R5LgogICAgICogICBpbnB1dFR5cGU6IC8vIFN0cmluZyAoZGVmYXVsdDogJ3RleHQnKS4gVGhlIHR5cGUgb2YgaW5wdXQgdG8gdXNlCiAgICAgKiAgIGlucHV0UGxhY2Vob2xkZXI6IC8vIFN0cmluZyAoZGVmYXVsdDogJycpLiBBIHBsYWNlaG9sZGVyIHRvIHVzZSBmb3IgdGhlIGlucHV0LgogICAgICogICBjYW5jZWxUZXh0OiAvLyBTdHJpbmcgKGRlZmF1bHQ6ICdDYW5jZWwnLiBUaGUgdGV4dCBvZiB0aGUgQ2FuY2VsIGJ1dHRvbi4KICAgICAqICAgY2FuY2VsVHlwZTogLy8gU3RyaW5nIChkZWZhdWx0OiAnYnV0dG9uLWRlZmF1bHQnKS4gVGhlIHR5cGUgb2YgdGhlIENhbmNlbCBidXR0b24uCiAgICAgKiAgIG9rVGV4dDogLy8gU3RyaW5nIChkZWZhdWx0OiAnT0snKS4gVGhlIHRleHQgb2YgdGhlIE9LIGJ1dHRvbi4KICAgICAqICAgb2tUeXBlOiAvLyBTdHJpbmcgKGRlZmF1bHQ6ICdidXR0b24tcG9zaXRpdmUnKS4gVGhlIHR5cGUgb2YgdGhlIE9LIGJ1dHRvbi4KICAgICAqIH0KICAgICAgICAgICAqIGBgYAogICAgICAgICAgICoKICAgICAgICAgICAqIEByZXR1cm5zIHtvYmplY3R9IEEgcHJvbWlzZSB3aGljaCBpcyByZXNvbHZlZCB3aGVuIHRoZSBwb3B1cCBpcyBjbG9zZWQuIEhhcyBvbmUgYWRkaXRpb25hbAogICAgICAgICAgICogZnVuY3Rpb24gYGNsb3NlYCwgd2hpY2ggY2FuIGJlIGNhbGxlZCB3aXRoIGFueSB2YWx1ZSB0byBwcm9ncmFtbWF0aWNhbGx5IGNsb3NlIHRoZSBwb3B1cAogICAgICAgICAgICogd2l0aCB0aGUgZ2l2ZW4gdmFsdWUuCiAgICAgICAgICAgKi8KICAgICAgICAgIHByb21wdDogc2hvd1Byb21wdCwKICAgICAgICAgIC8qKgogICAgICAgICAgICogQHByaXZhdGUgZm9yIHRlc3RpbmcKICAgICAgICAgICAqLwogICAgICAgICAgX2NyZWF0ZVBvcHVwOiBjcmVhdGVQb3B1cCwKICAgICAgICAgIF9wb3B1cFN0YWNrOiBwb3B1cFN0YWNrCiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuICRpb25pY1BvcHVwOwoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVQb3B1cChvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHsKICAgICAgICAgICAgc2NvcGU6IG51bGwsCiAgICAgICAgICAgIHRpdGxlOiAnJywKICAgICAgICAgICAgYnV0dG9uczogW10sCiAgICAgICAgICB9LCBvcHRpb25zIHx8IHt9KTsKCiAgICAgICAgICB2YXIgcG9wdXBQcm9taXNlID0gJGlvbmljVGVtcGxhdGVMb2FkZXIuY29tcGlsZSh7CiAgICAgICAgICAgIHRlbXBsYXRlOiBQT1BVUF9UUEwsCiAgICAgICAgICAgIHNjb3BlOiBvcHRpb25zLnNjb3BlICYmIG9wdGlvbnMuc2NvcGUuJG5ldygpLAogICAgICAgICAgICBhcHBlbmRUbzogJGRvY3VtZW50WzBdLmJvZHkKICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIGNvbnRlbnRQcm9taXNlID0gb3B0aW9ucy50ZW1wbGF0ZVVybCA/CiAgICAgICAgICAgICRpb25pY1RlbXBsYXRlTG9hZGVyLmxvYWQob3B0aW9ucy50ZW1wbGF0ZVVybCkgOgogICAgICAgICAgICAkcS53aGVuKG9wdGlvbnMudGVtcGxhdGUgfHwgb3B0aW9ucy5jb250ZW50IHx8ICcnKTsKCiAgICAgICAgICByZXR1cm4gJHEuYWxsKFtwb3B1cFByb21pc2UsIGNvbnRlbnRQcm9taXNlXSkKICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0cykgewogICAgICAgICAgICAgIHZhciBzZWxmID0gcmVzdWx0c1swXTsKICAgICAgICAgICAgICB2YXIgY29udGVudCA9IHJlc3VsdHNbMV07CiAgICAgICAgICAgICAgdmFyIHJlc3BvbnNlRGVmZXJyZWQgPSAkcS5kZWZlcigpOwoKICAgICAgICAgICAgICBzZWxmLnJlc3BvbnNlRGVmZXJyZWQgPSByZXNwb25zZURlZmVycmVkOwoKICAgICAgICAgICAgICAvL0Nhbid0IG5nLWJpbmQtaHRtbCBmb3IgcG9wdXAtYm9keSBiZWNhdXNlIGl0IGNhbiBiZSBpbnNlY3VyZSBodG1sCiAgICAgICAgICAgICAgLy8oZWcgYW4gaW5wdXQgaW4gY2FzZSBvZiBwcm9tcHQpCiAgICAgICAgICAgICAgdmFyIGJvZHkgPSBqcUxpdGUoc2VsZi5lbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3IoJy5wb3B1cC1ib2R5JykpOwogICAgICAgICAgICAgIGlmIChjb250ZW50KSB7CiAgICAgICAgICAgICAgICBib2R5Lmh0bWwoY29udGVudCk7CiAgICAgICAgICAgICAgICAkY29tcGlsZShib2R5LmNvbnRlbnRzKCkpKHNlbGYuc2NvcGUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBib2R5LnJlbW92ZSgpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgZXh0ZW5kKHNlbGYuc2NvcGUsIHsKICAgICAgICAgICAgICAgIHRpdGxlOiBvcHRpb25zLnRpdGxlLAogICAgICAgICAgICAgICAgYnV0dG9uczogb3B0aW9ucy5idXR0b25zLAogICAgICAgICAgICAgICAgc3ViVGl0bGU6IG9wdGlvbnMuc3ViVGl0bGUsCiAgICAgICAgICAgICAgICAkYnV0dG9uVGFwcGVkOiBmdW5jdGlvbihidXR0b24sIGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSAoYnV0dG9uLm9uVGFwIHx8IGFuZ3VsYXIubm9vcCkoZXZlbnQpOwogICAgICAgICAgICAgICAgICBldmVudCA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQgfHwgZXZlbnQ7IC8vanF1ZXJ5IGV2ZW50cwoKICAgICAgICAgICAgICAgICAgaWYgKCFldmVudC5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VEZWZlcnJlZC5yZXNvbHZlKHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgc2VsZi5zaG93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoc2VsZi5pc1Nob3duKSByZXR1cm47CgogICAgICAgICAgICAgICAgc2VsZi5pc1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlvbmljLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgLy9pZiBoaWRkZW4gd2hpbGUgd2FpdGluZyBmb3IgcmFmLCBkb24ndCBzaG93CiAgICAgICAgICAgICAgICAgIGlmICghc2VsZi5pc1Nob3duKSByZXR1cm47CgogICAgICAgICAgICAgICAgICAvL2lmIHRoZSBwb3B1cCBpcyB0YWxsZXIgdGhhbiB0aGUgd2luZG93LCBtYWtlIHRoZSBwb3B1cCBib2R5IHNjcm9sbGFibGUKICAgICAgICAgICAgICAgICAgaWYoc2VsZi5lbGVtZW50WzBdLm9mZnNldEhlaWdodCA+IHdpbmRvdy5pbm5lckhlaWdodCAtIDIwKXsKICAgICAgICAgICAgICAgICAgICBzZWxmLmVsZW1lbnRbMF0uc3R5bGUuaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0IC0gMjArJ3B4JzsKICAgICAgICAgICAgICAgICAgICBwb3B1cEJvZHkgPSBzZWxmLmVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvckFsbCgnLnBvcHVwLWJvZHknKTsKICAgICAgICAgICAgICAgICAgICBwb3B1cEhlYWQgPSBzZWxmLmVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvckFsbCgnLnBvcHVwLWhlYWQnKTsKICAgICAgICAgICAgICAgICAgICBwb3B1cEJ1dHRvbnMgPSBzZWxmLmVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvckFsbCgnLnBvcHVwLWJ1dHRvbnMnKTsKICAgICAgICAgICAgICAgICAgICBzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoJ3BvcHVwLXRhbGwnKTsKICAgICAgICAgICAgICAgICAgICBuZXdIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQgLSBwb3B1cEhlYWRbMF0ub2Zmc2V0SGVpZ2h0IC0gcG9wdXBCdXR0b25zWzBdLm9mZnNldEhlaWdodCAtMjA7CiAgICAgICAgICAgICAgICAgICAgcG9wdXBCb2R5WzBdLnN0eWxlLmhlaWdodCA9ICBuZXdIZWlnaHQgKyAncHgnOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICBzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoJ3BvcHVwLWhpZGRlbicpOwogICAgICAgICAgICAgICAgICBzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoJ3BvcHVwLXNob3dpbmcgYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgIGlvbmljLkRvbVV0aWwuY2VudGVyRWxlbWVudEJ5TWFyZ2luVHdpY2Uoc2VsZi5lbGVtZW50WzBdKTsKICAgICAgICAgICAgICAgICAgZm9jdXNJbnB1dChzZWxmLmVsZW1lbnQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBzZWxmLmhpZGUgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjayB8fCBhbmd1bGFyLm5vb3A7CiAgICAgICAgICAgICAgICBpZiAoIXNlbGYuaXNTaG93bikgcmV0dXJuIGNhbGxiYWNrKCk7CgogICAgICAgICAgICAgICAgc2VsZi5pc1Nob3duID0gZmFsc2U7CiAgICAgICAgICAgICAgICBzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgc2VsZi5lbGVtZW50LmFkZENsYXNzKCdwb3B1cC1oaWRkZW4nKTsKICAgICAgICAgICAgICAgICR0aW1lb3V0KGNhbGxiYWNrLCAyNTApOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgc2VsZi5yZW1vdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmIChzZWxmLnJlbW92ZWQpIHJldHVybjsKCiAgICAgICAgICAgICAgICBzZWxmLmhpZGUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHNlbGYuZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgc2VsZi5zY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgc2VsZi5yZW1vdmVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBvbkhhcmR3YXJlQmFja0J1dHRvbihlKSB7CiAgICAgICAgICBwb3B1cFN0YWNrWzBdICYmIHBvcHVwU3RhY2tbMF0ucmVzcG9uc2VEZWZlcnJlZC5yZXNvbHZlKCk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzaG93UG9wdXAob3B0aW9ucykgewogICAgICAgICAgdmFyIHBvcHVwUHJvbWlzZSA9ICRpb25pY1BvcHVwLl9jcmVhdGVQb3B1cChvcHRpb25zKTsKICAgICAgICAgIHZhciBwcmV2aW91c1BvcHVwID0gcG9wdXBTdGFja1swXTsKCiAgICAgICAgICBpZiAocHJldmlvdXNQb3B1cCkgewogICAgICAgICAgICBwcmV2aW91c1BvcHVwLmhpZGUoKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgcmVzdWx0UHJvbWlzZSA9ICR0aW1lb3V0KGFuZ3VsYXIubm9vcCwgcHJldmlvdXNQb3B1cCA/IGNvbmZpZy5zdGFja1B1c2hEZWxheSA6IDApCiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgeyByZXR1cm4gcG9wdXBQcm9taXNlOyB9KQogICAgICAgICAgICAudGhlbihmdW5jdGlvbihwb3B1cCkgewogICAgICAgICAgICAgIGlmICghcHJldmlvdXNQb3B1cCkgewogICAgICAgICAgICAgICAgLy9BZGQgcG9wdXAtb3BlbiAmIGJhY2tkcm9wIGlmIHRoaXMgaXMgZmlyc3QgcG9wdXAKICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgncG9wdXAtb3BlbicpOwogICAgICAgICAgICAgICAgJGlvbmljQmFja2Ryb3AucmV0YWluKCk7CiAgICAgICAgICAgICAgICAkaW9uaWNQb3B1cC5fYmFja0J1dHRvbkFjdGlvbkRvbmUgPSAkaW9uaWNQbGF0Zm9ybS5yZWdpc3RlckJhY2tCdXR0b25BY3Rpb24oCiAgICAgICAgICAgICAgICAgIG9uSGFyZHdhcmVCYWNrQnV0dG9uLAogICAgICAgICAgICAgICAgICBQTEFURk9STV9CQUNLX0JVVFRPTl9QUklPUklUWV9QT1BVUAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcG9wdXBTdGFjay51bnNoaWZ0KHBvcHVwKTsKICAgICAgICAgICAgICBwb3B1cC5zaG93KCk7CgogICAgICAgICAgICAgIC8vREVQUkVDQVRFRDogbm90aWZ5IHRoZSBwcm9taXNlIHdpdGggYW4gb2JqZWN0IHdpdGggYSBjbG9zZSBtZXRob2QKICAgICAgICAgICAgICBwb3B1cC5yZXNwb25zZURlZmVycmVkLm5vdGlmeSh7CiAgICAgICAgICAgICAgICBjbG9zZTogcmVzdWx0UHJvbWlzZS5jbG9zZQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICByZXR1cm4gcG9wdXAucmVzcG9uc2VEZWZlcnJlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBwb3B1cFN0YWNrLmluZGV4T2YocG9wdXApOwogICAgICAgICAgICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgICAgICAgICAgICBwb3B1cFN0YWNrLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwb3B1cC5yZW1vdmUoKTsKCiAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNQb3B1cCA9IHBvcHVwU3RhY2tbMF07CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNQb3B1cCkgewogICAgICAgICAgICAgICAgICBwcmV2aW91c1BvcHVwLnNob3coKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vUmVtb3ZlIHBvcHVwLW9wZW4gJiBiYWNrZHJvcCBpZiB0aGlzIGlzIGxhc3QgcG9wdXAKICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdwb3B1cC1vcGVuJyk7CiAgICAgICAgICAgICAgICAgICgkaW9uaWNQb3B1cC5fYmFja0J1dHRvbkFjdGlvbkRvbmUgfHwgYW5ndWxhci5ub29wKSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gYWx3YXlzIHJlbGVhc2UgdGhlIGJhY2tkcm9wIHNpbmNlIGl0IGhhcyBhbiBpbnRlcm5hbCBiYWNrZHJvcCBjb3VudGVyCiAgICAgICAgICAgICAgICAkaW9uaWNCYWNrZHJvcC5yZWxlYXNlKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICBmdW5jdGlvbiBjbG9zZShyZXN1bHQpIHsKICAgICAgICAgICAgcG9wdXBQcm9taXNlLnRoZW4oZnVuY3Rpb24ocG9wdXApIHsKICAgICAgICAgICAgICBpZiAoIXBvcHVwLnJlbW92ZWQpIHsKICAgICAgICAgICAgICAgIHBvcHVwLnJlc3BvbnNlRGVmZXJyZWQucmVzb2x2ZShyZXN1bHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHRQcm9taXNlLmNsb3NlID0gY2xvc2U7CgogICAgICAgICAgcmV0dXJuIHJlc3VsdFByb21pc2U7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBmb2N1c0lucHV0KGVsZW1lbnQpIHsKICAgICAgICAgIHZhciBmb2N1c09uID0gZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yKCdbYXV0b2ZvY3VzXScpOwogICAgICAgICAgaWYgKGZvY3VzT24pIHsKICAgICAgICAgICAgZm9jdXNPbi5mb2N1cygpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc2hvd0FsZXJ0KG9wdHMpIHsKICAgICAgICAgIHJldHVybiBzaG93UG9wdXAoIGV4dGVuZCh7CiAgICAgICAgICAgIGJ1dHRvbnM6IFt7CiAgICAgICAgICAgICAgdGV4dDogb3B0cy5va1RleHQgfHwgJ09LJywKICAgICAgICAgICAgICB0eXBlOiBvcHRzLm9rVHlwZSB8fCAnYnV0dG9uLXBvc2l0aXZlJywKICAgICAgICAgICAgICBvblRhcDogZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9XQogICAgICAgICAgfSwgb3B0cyB8fCB7fSkgKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIHNob3dDb25maXJtKG9wdHMpIHsKICAgICAgICAgIHJldHVybiBzaG93UG9wdXAoIGV4dGVuZCh7CiAgICAgICAgICAgIGJ1dHRvbnM6IFt7CiAgICAgICAgICAgICAgdGV4dDogb3B0cy5jYW5jZWxUZXh0IHx8ICdDYW5jZWwnICwKICAgICAgICAgICAgICB0eXBlOiBvcHRzLmNhbmNlbFR5cGUgfHwgJ2J1dHRvbi1kZWZhdWx0JywKICAgICAgICAgICAgICBvblRhcDogZnVuY3Rpb24oZSkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIHRleHQ6IG9wdHMub2tUZXh0IHx8ICdPSycsCiAgICAgICAgICAgICAgdHlwZTogb3B0cy5va1R5cGUgfHwgJ2J1dHRvbi1wb3NpdGl2ZScsCiAgICAgICAgICAgICAgb25UYXA6IGZ1bmN0aW9uKGUpIHsgcmV0dXJuIHRydWU7IH0KICAgICAgICAgICAgfV0KICAgICAgICAgIH0sIG9wdHMgfHwge30pICk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBzaG93UHJvbXB0KG9wdHMpIHsKICAgICAgICAgIHZhciBzY29wZSA9ICRyb290U2NvcGUuJG5ldyh0cnVlKTsKICAgICAgICAgIHNjb3BlLmRhdGEgPSB7fTsKICAgICAgICAgIHJldHVybiBzaG93UG9wdXAoIGV4dGVuZCh7CiAgICAgICAgICAgIHRlbXBsYXRlOiAnPGlucHV0IG5nLW1vZGVsPSJkYXRhLnJlc3BvbnNlIiB0eXBlPSInICsgKG9wdHMuaW5wdXRUeXBlIHx8ICd0ZXh0JykgKwogICAgICAgICAgICAgICciIHBsYWNlaG9sZGVyPSInICsgKG9wdHMuaW5wdXRQbGFjZWhvbGRlciB8fCAnJykgKyAnIj4nLAogICAgICAgICAgICBzY29wZTogc2NvcGUsCiAgICAgICAgICAgIGJ1dHRvbnM6IFt7CiAgICAgICAgICAgICAgdGV4dDogb3B0cy5jYW5jZWxUZXh0IHx8ICdDYW5jZWwnLAogICAgICAgICAgICAgIHR5cGU6IG9wdHMuY2FuY2VsVHlwZXx8ICdidXR0b24tZGVmYXVsdCcsCiAgICAgICAgICAgICAgb25UYXA6IGZ1bmN0aW9uKGUpIHt9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICB0ZXh0OiBvcHRzLm9rVGV4dCB8fCAnT0snLAogICAgICAgICAgICAgIHR5cGU6IG9wdHMub2tUeXBlIHx8ICdidXR0b24tcG9zaXRpdmUnLAogICAgICAgICAgICAgIG9uVGFwOiBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuZGF0YS5yZXNwb25zZSB8fCAnJzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1dCiAgICAgICAgICB9LCBvcHRzIHx8IHt9KSApOwogICAgICAgIH0KICAgICAgfV0pOwoKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkaW9uaWNQb3NpdGlvbgogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBIHNldCBvZiB1dGlsaXR5IG1ldGhvZHMgdGhhdCBjYW4gYmUgdXNlIHRvIHJldHJpZXZlIHBvc2l0aW9uIG9mIERPTSBlbGVtZW50cy4KICAgKiBJdCBpcyBtZWFudCB0byBiZSB1c2VkIHdoZXJlIHdlIG5lZWQgdG8gYWJzb2x1dGUtcG9zaXRpb24gRE9NIGVsZW1lbnRzIGluCiAgICogcmVsYXRpb24gdG8gb3RoZXIsIGV4aXN0aW5nIGVsZW1lbnRzICh0aGlzIGlzIHRoZSBjYXNlIGZvciB0b29sdGlwcywgcG9wb3ZlcnMsIGV0Yy4pLgogICAqCiAgICogQWRhcHRlZCBmcm9tIFtBbmd1bGFyVUkgQm9vdHN0cmFwXShodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci11aS9ib290c3RyYXAvYmxvYi9tYXN0ZXIvc3JjL3Bvc2l0aW9uL3Bvc2l0aW9uLmpzKSwKICAgKiAoW2xpY2Vuc2VdKGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyLXVpL2Jvb3RzdHJhcC9ibG9iL21hc3Rlci9MSUNFTlNFKSkKICAgKi8KICBJb25pY01vZHVsZQogICAgLmZhY3RvcnkoJyRpb25pY1Bvc2l0aW9uJywgWyckZG9jdW1lbnQnLCAnJHdpbmRvdycsIGZ1bmN0aW9uICgkZG9jdW1lbnQsICR3aW5kb3cpIHsKCiAgICAgIGZ1bmN0aW9uIGdldFN0eWxlKGVsLCBjc3Nwcm9wKSB7CiAgICAgICAgaWYgKGVsLmN1cnJlbnRTdHlsZSkgeyAvL0lFCiAgICAgICAgICByZXR1cm4gZWwuY3VycmVudFN0eWxlW2Nzc3Byb3BdOwogICAgICAgIH0gZWxzZSBpZiAoJHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKSB7CiAgICAgICAgICByZXR1cm4gJHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsKVtjc3Nwcm9wXTsKICAgICAgICB9CiAgICAgICAgLy8gZmluYWxseSB0cnkgYW5kIGdldCBpbmxpbmUgc3R5bGUKICAgICAgICByZXR1cm4gZWwuc3R5bGVbY3NzcHJvcF07CiAgICAgIH0KCiAgICAgIC8qKgogICAgICAgKiBDaGVja3MgaWYgYSBnaXZlbiBlbGVtZW50IGlzIHN0YXRpY2FsbHkgcG9zaXRpb25lZAogICAgICAgKiBAcGFyYW0gZWxlbWVudCAtIHJhdyBET00gZWxlbWVudAogICAgICAgKi8KICAgICAgZnVuY3Rpb24gaXNTdGF0aWNQb3NpdGlvbmVkKGVsZW1lbnQpIHsKICAgICAgICByZXR1cm4gKGdldFN0eWxlKGVsZW1lbnQsICdwb3NpdGlvbicpIHx8ICdzdGF0aWMnICkgPT09ICdzdGF0aWMnOwogICAgICB9CgogICAgICAvKioKICAgICAgICogcmV0dXJucyB0aGUgY2xvc2VzdCwgbm9uLXN0YXRpY2FsbHkgcG9zaXRpb25lZCBwYXJlbnRPZmZzZXQgb2YgYSBnaXZlbiBlbGVtZW50CiAgICAgICAqIEBwYXJhbSBlbGVtZW50CiAgICAgICAqLwogICAgICB2YXIgcGFyZW50T2Zmc2V0RWwgPSBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgIHZhciBkb2NEb21FbCA9ICRkb2N1bWVudFswXTsKICAgICAgICB2YXIgb2Zmc2V0UGFyZW50ID0gZWxlbWVudC5vZmZzZXRQYXJlbnQgfHwgZG9jRG9tRWw7CiAgICAgICAgd2hpbGUgKG9mZnNldFBhcmVudCAmJiBvZmZzZXRQYXJlbnQgIT09IGRvY0RvbUVsICYmIGlzU3RhdGljUG9zaXRpb25lZChvZmZzZXRQYXJlbnQpICkgewogICAgICAgICAgb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2NEb21FbDsKICAgICAgfTsKCiAgICAgIHJldHVybiB7CiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRpb25pY1Bvc2l0aW9uI3Bvc2l0aW9uCiAgICAgICAgICogQGRlc2NyaXB0aW9uIEdldCB0aGUgY3VycmVudCBjb29yZGluYXRlcyBvZiB0aGUgZWxlbWVudCwgcmVsYXRpdmUgdG8gdGhlIG9mZnNldCBwYXJlbnQuCiAgICAgICAgICogUmVhZC1vbmx5IGVxdWl2YWxlbnQgb2YgW2pRdWVyeSdzIHBvc2l0aW9uIGZ1bmN0aW9uXShodHRwOi8vYXBpLmpxdWVyeS5jb20vcG9zaXRpb24vKS4KICAgICAgICAgKiBAcGFyYW0ge2VsZW1lbnR9IGVsZW1lbnQgVGhlIGVsZW1lbnQgdG8gZ2V0IHRoZSBwb3NpdGlvbiBvZi4KICAgICAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBwcm9wZXJ0aWVzIHRvcCwgbGVmdCwgd2lkdGggYW5kIGhlaWdodC4KICAgICAgICAgKi8KICAgICAgICBwb3NpdGlvbjogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgIHZhciBlbEJDUiA9IHRoaXMub2Zmc2V0KGVsZW1lbnQpOwogICAgICAgICAgdmFyIG9mZnNldFBhcmVudEJDUiA9IHsgdG9wOiAwLCBsZWZ0OiAwIH07CiAgICAgICAgICB2YXIgb2Zmc2V0UGFyZW50RWwgPSBwYXJlbnRPZmZzZXRFbChlbGVtZW50WzBdKTsKICAgICAgICAgIGlmIChvZmZzZXRQYXJlbnRFbCAhPSAkZG9jdW1lbnRbMF0pIHsKICAgICAgICAgICAgb2Zmc2V0UGFyZW50QkNSID0gdGhpcy5vZmZzZXQoYW5ndWxhci5lbGVtZW50KG9mZnNldFBhcmVudEVsKSk7CiAgICAgICAgICAgIG9mZnNldFBhcmVudEJDUi50b3AgKz0gb2Zmc2V0UGFyZW50RWwuY2xpZW50VG9wIC0gb2Zmc2V0UGFyZW50RWwuc2Nyb2xsVG9wOwogICAgICAgICAgICBvZmZzZXRQYXJlbnRCQ1IubGVmdCArPSBvZmZzZXRQYXJlbnRFbC5jbGllbnRMZWZ0IC0gb2Zmc2V0UGFyZW50RWwuc2Nyb2xsTGVmdDsKICAgICAgICAgIH0KCiAgICAgICAgICB2YXIgYm91bmRpbmdDbGllbnRSZWN0ID0gZWxlbWVudFswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHdpZHRoOiBib3VuZGluZ0NsaWVudFJlY3Qud2lkdGggfHwgZWxlbWVudC5wcm9wKCdvZmZzZXRXaWR0aCcpLAogICAgICAgICAgICBoZWlnaHQ6IGJvdW5kaW5nQ2xpZW50UmVjdC5oZWlnaHQgfHwgZWxlbWVudC5wcm9wKCdvZmZzZXRIZWlnaHQnKSwKICAgICAgICAgICAgdG9wOiBlbEJDUi50b3AgLSBvZmZzZXRQYXJlbnRCQ1IudG9wLAogICAgICAgICAgICBsZWZ0OiBlbEJDUi5sZWZ0IC0gb2Zmc2V0UGFyZW50QkNSLmxlZnQKICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgICAqIEBuYW1lICRpb25pY1Bvc2l0aW9uI29mZnNldAogICAgICAgICAqIEBkZXNjcmlwdGlvbiBHZXQgdGhlIGN1cnJlbnQgY29vcmRpbmF0ZXMgb2YgdGhlIGVsZW1lbnQsIHJlbGF0aXZlIHRvIHRoZSBkb2N1bWVudC4KICAgICAgICAgKiBSZWFkLW9ubHkgZXF1aXZhbGVudCBvZiBbalF1ZXJ5J3Mgb2Zmc2V0IGZ1bmN0aW9uXShodHRwOi8vYXBpLmpxdWVyeS5jb20vb2Zmc2V0LykuCiAgICAgICAgICogQHBhcmFtIHtlbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIGdldCB0aGUgb2Zmc2V0IG9mLgogICAgICAgICAqIEByZXR1cm5zIHtvYmplY3R9IFJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHByb3BlcnRpZXMgdG9wLCBsZWZ0LCB3aWR0aCBhbmQgaGVpZ2h0LgogICAgICAgICAqLwogICAgICAgIG9mZnNldDogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICAgIHZhciBib3VuZGluZ0NsaWVudFJlY3QgPSBlbGVtZW50WzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgd2lkdGg6IGJvdW5kaW5nQ2xpZW50UmVjdC53aWR0aCB8fCBlbGVtZW50LnByb3AoJ29mZnNldFdpZHRoJyksCiAgICAgICAgICAgIGhlaWdodDogYm91bmRpbmdDbGllbnRSZWN0LmhlaWdodCB8fCBlbGVtZW50LnByb3AoJ29mZnNldEhlaWdodCcpLAogICAgICAgICAgICB0b3A6IGJvdW5kaW5nQ2xpZW50UmVjdC50b3AgKyAoJHdpbmRvdy5wYWdlWU9mZnNldCB8fCAkZG9jdW1lbnRbMF0uZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCksCiAgICAgICAgICAgIGxlZnQ6IGJvdW5kaW5nQ2xpZW50UmVjdC5sZWZ0ICsgKCR3aW5kb3cucGFnZVhPZmZzZXQgfHwgJGRvY3VtZW50WzBdLmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0KQogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICB9OwogICAgfV0pOwoKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZQogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZWxlZ2F0ZSBmb3IgY29udHJvbGxpbmcgc2Nyb2xsVmlld3MgKGNyZWF0ZWQgYnkKICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkNvbnRlbnR9IGFuZAogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2Nyb2xsfSBkaXJlY3RpdmVzKS4KICAgKgogICAqIE1ldGhvZHMgY2FsbGVkIGRpcmVjdGx5IG9uIHRoZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSBzZXJ2aWNlIHdpbGwgY29udHJvbCBhbGwgc2Nyb2xsCiAgICogdmlld3MuICBVc2UgdGhlIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1Njcm9sbERlbGVnYXRlIyRnZXRCeUhhbmRsZSAkZ2V0QnlIYW5kbGV9CiAgICogbWV0aG9kIHRvIGNvbnRyb2wgc3BlY2lmaWMgc2Nyb2xsVmlld3MuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIGBgYGh0bWwKICAgKiA8Ym9keSBuZy1jb250cm9sbGVyPSJNYWluQ3RybCI+CiAgICogICA8aW9uLWNvbnRlbnQ+CiAgICogICAgIDxidXR0b24gbmctY2xpY2s9InNjcm9sbFRvcCgpIj5TY3JvbGwgdG8gVG9wITwvYnV0dG9uPgogICAqICAgPC9pb24tY29udGVudD4KICAgKiA8L2JvZHk+CiAgICogYGBgCiAgICogYGBganMKICAgKiBmdW5jdGlvbiBNYWluQ3RybCgkc2NvcGUsICRpb25pY1Njcm9sbERlbGVnYXRlKSB7CiAqICAgJHNjb3BlLnNjcm9sbFRvcCA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljU2Nyb2xsRGVsZWdhdGUuc2Nyb2xsVG9wKCk7CiAqICAgfTsKICogfQogICAqIGBgYAogICAqCiAgICogRXhhbXBsZSBvZiBhZHZhbmNlZCB1c2FnZSwgd2l0aCB0d28gc2Nyb2xsIGFyZWFzIHVzaW5nIGBkZWxlZ2F0ZS1oYW5kbGVgCiAgICogZm9yIGZpbmUgY29udHJvbC4KICAgKgogICAqIGBgYGh0bWwKICAgKiA8Ym9keSBuZy1jb250cm9sbGVyPSJNYWluQ3RybCI+CiAgICogICA8aW9uLWNvbnRlbnQgZGVsZWdhdGUtaGFuZGxlPSJtYWluU2Nyb2xsIj4KICAgKiAgICAgPGJ1dHRvbiBuZy1jbGljaz0ic2Nyb2xsTWFpblRvVG9wKCkiPgogICAqICAgICAgIFNjcm9sbCBjb250ZW50IHRvIHRvcCEKICAgKiAgICAgPC9idXR0b24+CiAgICogICAgIDxpb24tc2Nyb2xsIGRlbGVnYXRlLWhhbmRsZT0ic21hbGwiIHN0eWxlPSJoZWlnaHQ6IDEwMHB4OyI+CiAgICogICAgICAgPGJ1dHRvbiBuZy1jbGljaz0ic2Nyb2xsU21hbGxUb1RvcCgpIj4KICAgKiAgICAgICAgIFNjcm9sbCBzbWFsbCBhcmVhIHRvIHRvcCEKICAgKiAgICAgICA8L2J1dHRvbj4KICAgKiAgICAgPC9pb24tc2Nyb2xsPgogICAqICAgPC9pb24tY29udGVudD4KICAgKiA8L2JvZHk+CiAgICogYGBgCiAgICogYGBganMKICAgKiBmdW5jdGlvbiBNYWluQ3RybCgkc2NvcGUsICRpb25pY1Njcm9sbERlbGVnYXRlKSB7CiAqICAgJHNjb3BlLnNjcm9sbE1haW5Ub1RvcCA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljU2Nyb2xsRGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdtYWluU2Nyb2xsJykuc2Nyb2xsVG9wKCk7CiAqICAgfTsKICogICAkc2NvcGUuc2Nyb2xsU21hbGxUb1RvcCA9IGZ1bmN0aW9uKCkgewogKiAgICAgJGlvbmljU2Nyb2xsRGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdzbWFsbCcpLnNjcm9sbFRvcCgpOwogKiAgIH07CiAqIH0KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLnNlcnZpY2UoJyRpb25pY1Njcm9sbERlbGVnYXRlJywgZGVsZWdhdGVTZXJ2aWNlKFsKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjcmVzaXplCiAgICAgKiBAZGVzY3JpcHRpb24gVGVsbCB0aGUgc2Nyb2xsVmlldyB0byByZWNhbGN1bGF0ZSB0aGUgc2l6ZSBvZiBpdHMgY29udGFpbmVyLgogICAgICovCiAgICAgICdyZXNpemUnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNzY3JvbGxUb3AKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3VsZEFuaW1hdGUgV2hldGhlciB0aGUgc2Nyb2xsIHNob3VsZCBhbmltYXRlLgogICAgICovCiAgICAgICdzY3JvbGxUb3AnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNzY3JvbGxCb3R0b20KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3VsZEFuaW1hdGUgV2hldGhlciB0aGUgc2Nyb2xsIHNob3VsZCBhbmltYXRlLgogICAgICovCiAgICAgICdzY3JvbGxCb3R0b20nLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNzY3JvbGxUbwogICAgICogQHBhcmFtIHtudW1iZXJ9IGxlZnQgVGhlIHgtdmFsdWUgdG8gc2Nyb2xsIHRvLgogICAgICogQHBhcmFtIHtudW1iZXJ9IHRvcCBUaGUgeS12YWx1ZSB0byBzY3JvbGwgdG8uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG91bGRBbmltYXRlIFdoZXRoZXIgdGhlIHNjcm9sbCBzaG91bGQgYW5pbWF0ZS4KICAgICAqLwogICAgICAnc2Nyb2xsVG8nLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNzY3JvbGxCeQogICAgICogQHBhcmFtIHtudW1iZXJ9IGxlZnQgVGhlIHgtb2Zmc2V0IHRvIHNjcm9sbCBieS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB0b3AgVGhlIHktb2Zmc2V0IHRvIHNjcm9sbCBieS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3VsZEFuaW1hdGUgV2hldGhlciB0aGUgc2Nyb2xsIHNob3VsZCBhbmltYXRlLgogICAgICovCiAgICAgICdzY3JvbGxCeScsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI2dldFNjcm9sbFBvc2l0aW9uCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSBUaGUgc2Nyb2xsIHBvc2l0aW9uIG9mIHRoaXMgdmlldywgd2l0aCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6CiAgICAgKiAgLSBge251bWJlcn1gIGBsZWZ0YCBUaGUgZGlzdGFuY2UgdGhlIHVzZXIgaGFzIHNjcm9sbGVkIGZyb20gdGhlIGxlZnQgKHN0YXJ0cyBhdCAwKS4KICAgICAqICAtIGB7bnVtYmVyfWAgYHRvcGAgVGhlIGRpc3RhbmNlIHRoZSB1c2VyIGhhcyBzY3JvbGxlZCBmcm9tIHRoZSB0b3AgKHN0YXJ0cyBhdCAwKS4KICAgICAqLwogICAgICAnZ2V0U2Nyb2xsUG9zaXRpb24nLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZSNhbmNob3JTY3JvbGwKICAgICAqIEBkZXNjcmlwdGlvbiBUZWxsIHRoZSBzY3JvbGxWaWV3IHRvIHNjcm9sbCB0byB0aGUgZWxlbWVudCB3aXRoIGFuIGlkCiAgICAgKiBtYXRjaGluZyB3aW5kb3cubG9jYXRpb24uaGFzaC4KICAgICAqCiAgICAgKiBJZiBubyBtYXRjaGluZyBlbGVtZW50IGlzIGZvdW5kLCBpdCB3aWxsIHNjcm9sbCB0byB0b3AuCiAgICAgKgogICAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdWxkQW5pbWF0ZSBXaGV0aGVyIHRoZSBzY3JvbGwgc2hvdWxkIGFuaW1hdGUuCiAgICAgKi8KICAgICAgJ2FuY2hvclNjcm9sbCcsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlI2dldFNjcm9sbFZpZXcKICAgICAqIEByZXR1cm5zIHtvYmplY3R9IFRoZSBzY3JvbGxWaWV3IGFzc29jaWF0ZWQgd2l0aCB0aGlzIGRlbGVnYXRlLgogICAgICovCiAgICAgICdnZXRTY3JvbGxWaWV3JywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjcmVtZW1iZXJTY3JvbGxQb3NpdGlvbgogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBXaWxsIG1ha2UgaXQgc28sIHdoZW4gdGhpcyBzY3JvbGxWaWV3IGlzIGRlc3Ryb3llZCAodXNlciBsZWF2ZXMgdGhlIHBhZ2UpLAogICAgICogdGhlIGxhc3Qgc2Nyb2xsIHBvc2l0aW9uIHRoZSBwYWdlIHdhcyBvbiB3aWxsIGJlIHNhdmVkLCBpbmRleGVkIGJ5IHRoZQogICAgICogZ2l2ZW4gaWQuCiAgICAgKgogICAgICogTm90ZTogZm9yIHBhZ2VzIGFzc29jaWF0ZWQgd2l0aCBhIHZpZXcgdW5kZXIgYW4gaW9uLW5hdi12aWV3LAogICAgICogcmVtZW1iZXJTY3JvbGxQb3NpdGlvbiBhdXRvbWF0aWNhbGx5IHNhdmVzIHRoZWlyIHNjcm9sbC4KICAgICAqCiAgICAgKiBSZWxhdGVkIG1ldGhvZHM6IHNjcm9sbFRvUmVtZW1iZXJlZFBvc2l0aW9uLCBmb3JnZXRTY3JvbGxQb3NpdGlvbiAoYmVsb3cpLgogICAgICoKICAgICAqIEluIHRoZSBmb2xsb3dpbmcgZXhhbXBsZSwgdGhlIHNjcm9sbCBwb3NpdGlvbiBvZiB0aGUgaW9uLXNjcm9sbCBlbGVtZW50CiAgICAgKiB3aWxsIHBlcnNpc3QsIGV2ZW4gd2hlbiB0aGUgdXNlciBjaGFuZ2VzIHRoZSB0b2dnbGUgc3dpdGNoLgogICAgICoKICAgICAqIGBgYGh0bWwKICAgICAqIDxpb24tdG9nZ2xlIG5nLW1vZGVsPSJzaG91bGRTaG93U2Nyb2xsVmlldyI+PC9pb24tdG9nZ2xlPgogICAgICogPGlvbi1zY3JvbGwgZGVsZWdhdGUtaGFuZGxlPSJteVNjcm9sbCIgbmctaWY9InNob3VsZFNob3dTY3JvbGxWaWV3Ij4KICAgICAqICAgPGRpdiBuZy1jb250cm9sbGVyPSJTY3JvbGxDdHJsIj4KICAgICAqICAgICA8aW9uLWxpc3Q+CiAgICAgKiAgICAgICB7JSByYXcgJX08aW9uLWl0ZW0gbmctcmVwZWF0PSJpIGluIGl0ZW1zIj57e2l9fTwvaW9uLWl0ZW0+eyUgZW5kcmF3ICV9CiAgICAgKiAgICAgPC9pb24tbGlzdD4KICAgICAqICAgPC9kaXY+CiAgICAgKiA8L2lvbi1zY3JvbGw+CiAgICAgKiBgYGAKICAgICAqIGBgYGpzCiAgICAgKiBmdW5jdGlvbiBTY3JvbGxDdHJsKCRzY29wZSwgJGlvbmljU2Nyb2xsRGVsZWdhdGUpIHsKICAgKiAgIHZhciBkZWxlZ2F0ZSA9ICRpb25pY1Njcm9sbERlbGVnYXRlLiRnZXRCeUhhbmRsZSgnbXlTY3JvbGwnKTsKICAgKgogICAqICAgLy8gUHV0IGFueSB1bmlxdWUgSUQgaGVyZS4gIFRoZSBwb2ludCBvZiB0aGlzIGlzOiBldmVyeSB0aW1lIHRoZSBjb250cm9sbGVyIGlzIHJlY3JlYXRlZAogICAqICAgLy8gd2Ugd2FudCB0byBsb2FkIHRoZSBjb3JyZWN0IHJlbWVtYmVyZWQgc2Nyb2xsIHZhbHVlcy4KICAgKiAgIGRlbGVnYXRlLnJlbWVtYmVyU2Nyb2xsUG9zaXRpb24oJ215LXNjcm9sbC1pZCcpOwogICAqICAgZGVsZWdhdGUuc2Nyb2xsVG9SZW1lbWJlcmVkUG9zaXRpb24oKTsKICAgKiAgICRzY29wZS5pdGVtcyA9IFtdOwogICAqICAgZm9yICh2YXIgaT0wOyBpPDEwMDsgaSsrKSB7CiAgICogICAgICRzY29wZS5pdGVtcy5wdXNoKGkpOwogICAqICAgfQogICAqIH0KICAgICAqIGBgYAogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBpZCBUaGUgaWQgdG8gcmVtZW1iZXIgdGhlIHNjcm9sbCBwb3NpdGlvbiBvZiB0aGlzCiAgICAgKiBzY3JvbGxWaWV3IGJ5LgogICAgICovCiAgICAgICdyZW1lbWJlclNjcm9sbFBvc2l0aW9uJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjZm9yZ2V0U2Nyb2xsUG9zaXRpb24KICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogU3RvcCByZW1lbWJlcmluZyB0aGUgc2Nyb2xsIHBvc2l0aW9uIGZvciB0aGlzIHNjcm9sbFZpZXcuCiAgICAgKi8KICAgICAgJ2ZvcmdldFNjcm9sbFBvc2l0aW9uJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2Nyb2xsRGVsZWdhdGUjc2Nyb2xsVG9SZW1lbWJlcmVkUG9zaXRpb24KICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogSWYgdGhpcyBzY3JvbGxWaWV3IGhhcyBhbiBpZCBhc3NvY2lhdGVkIHdpdGggaXRzIHNjcm9sbCBwb3NpdGlvbiwKICAgICAqICh0aHJvdWdoIGNhbGxpbmcgcmVtZW1iZXJTY3JvbGxQb3NpdGlvbiksIGFuZCB0aGF0IHBvc2l0aW9uIGlzIHJlbWVtYmVyZWQsCiAgICAgKiBsb2FkIHRoZSBwb3NpdGlvbiBhbmQgc2Nyb2xsIHRvIGl0LgogICAgICogQHBhcmFtIHtib29sZWFuPX0gc2hvdWxkQW5pbWF0ZSBXaGV0aGVyIHRvIGFuaW1hdGUgdGhlIHNjcm9sbC4KICAgICAqLwogICAgICAnc2Nyb2xsVG9SZW1lbWJlcmVkUG9zaXRpb24nCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1Njcm9sbERlbGVnYXRlIyRnZXRCeUhhbmRsZQogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhbmRsZQogICAgICogQHJldHVybnMgYGRlbGVnYXRlSW5zdGFuY2VgIEEgZGVsZWdhdGUgaW5zdGFuY2UgdGhhdCBjb250cm9scyBvbmx5IHRoZQogICAgICogc2Nyb2xsVmlld3Mgd2l0aCBgZGVsZWdhdGUtaGFuZGxlYCBtYXRjaGluZyB0aGUgZ2l2ZW4gaGFuZGxlLgogICAgICoKICAgICAqIEV4YW1wbGU6IGAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ215LWhhbmRsZScpLnNjcm9sbFRvcCgpO2AKICAgICAqLwogICAgXSkpOwoKCiAgLyoqCiAgICogQG5nZG9jIHNlcnZpY2UKICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlCiAgICogQG1vZHVsZSBpb25pYwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGVsZWdhdGUgZm9yIGNvbnRyb2xsaW5nIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51c30gZGlyZWN0aXZlLgogICAqCiAgICogTWV0aG9kcyBjYWxsZWQgZGlyZWN0bHkgb24gdGhlICRpb25pY1NpZGVNZW51RGVsZWdhdGUgc2VydmljZSB3aWxsIGNvbnRyb2wgYWxsIHNpZGUKICAgKiBtZW51cy4gIFVzZSB0aGUge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUgJGdldEJ5SGFuZGxlfQogICAqIG1ldGhvZCB0byBjb250cm9sIHNwZWNpZmljIGlvblNpZGVNZW51cyBpbnN0YW5jZXMuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIGBgYGh0bWwKICAgKiA8Ym9keSBuZy1jb250cm9sbGVyPSJNYWluQ3RybCI+CiAgICogICA8aW9uLXNpZGUtbWVudXM+CiAgICogICAgIDxpb24tc2lkZS1tZW51LWNvbnRlbnQ+CiAgICogICAgICAgQ29udGVudCEKICAgKiAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJ0b2dnbGVMZWZ0U2lkZU1lbnUoKSI+CiAgICogICAgICAgICBUb2dnbGUgTGVmdCBTaWRlIE1lbnUKICAgKiAgICAgICA8L2J1dHRvbj4KICAgKiAgICAgPC9pb24tc2lkZS1tZW51LWNvbnRlbnQ+CiAgICogICAgIDxpb24tc2lkZS1tZW51IHNpZGU9ImxlZnQiPgogICAqICAgICAgIExlZnQgTWVudSEKICAgKiAgICAgPGlvbi1zaWRlLW1lbnU+CiAgICogICA8L2lvbi1zaWRlLW1lbnVzPgogICAqIDwvYm9keT4KICAgKiBgYGAKICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIE1haW5DdHJsKCRzY29wZSwgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSkgewogKiAgICRzY29wZS50b2dnbGVMZWZ0U2lkZU1lbnUgPSBmdW5jdGlvbigpIHsKICogICAgICRpb25pY1NpZGVNZW51RGVsZWdhdGUudG9nZ2xlTGVmdCgpOwogKiAgIH07CiAqIH0KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLnNlcnZpY2UoJyRpb25pY1NpZGVNZW51RGVsZWdhdGUnLCBkZWxlZ2F0ZVNlcnZpY2UoWwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI3RvZ2dsZUxlZnQKICAgICAqIEBkZXNjcmlwdGlvbiBUb2dnbGUgdGhlIGxlZnQgc2lkZSBtZW51IChpZiBpdCBleGlzdHMpLgogICAgICogQHBhcmFtIHtib29sZWFuPX0gaXNPcGVuIFdoZXRoZXIgdG8gb3BlbiBvciBjbG9zZSB0aGUgbWVudS4KICAgICAqIERlZmF1bHQ6IFRvZ2dsZXMgdGhlIG1lbnUuCiAgICAgKi8KICAgICAgJ3RvZ2dsZUxlZnQnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI3RvZ2dsZVJpZ2h0CiAgICAgKiBAZGVzY3JpcHRpb24gVG9nZ2xlIHRoZSByaWdodCBzaWRlIG1lbnUgKGlmIGl0IGV4aXN0cykuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBpc09wZW4gV2hldGhlciB0byBvcGVuIG9yIGNsb3NlIHRoZSBtZW51LgogICAgICogRGVmYXVsdDogVG9nZ2xlcyB0aGUgbWVudS4KICAgICAqLwogICAgICAndG9nZ2xlUmlnaHQnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI2dldE9wZW5SYXRpbwogICAgICogQGRlc2NyaXB0aW9uIEdldHMgdGhlIHJhdGlvIG9mIG9wZW4gYW1vdW50IG92ZXIgbWVudSB3aWR0aC4gRm9yIGV4YW1wbGUsIGEKICAgICAqIG1lbnUgb2Ygd2lkdGggMTAwIHRoYXQgaXMgb3BlbmVkIGJ5IDUwIHBpeGVscyBpcyA1MCUgb3BlbmVkLCBhbmQgd291bGQgcmV0dXJuCiAgICAgKiBhIHJhdGlvIG9mIDAuNS4KICAgICAqCiAgICAgKiBAcmV0dXJucyB7ZmxvYXR9IDAgaWYgbm90aGluZyBpcyBvcGVuLCBiZXR3ZWVuIDAgYW5kIDEgaWYgbGVmdCBtZW51IGlzCiAgICAgKiBvcGVuZWQvb3BlbmluZywgYW5kIGJldHdlZW4gMCBhbmQgLTEgaWYgcmlnaHQgbWVudSBpcyBvcGVuZWQvb3BlbmluZy4KICAgICAqLwogICAgICAnZ2V0T3BlblJhdGlvJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSNpc09wZW4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIGVpdGhlciB0aGUgbGVmdCBvciByaWdodCBtZW51IGlzIGN1cnJlbnRseSBvcGVuZWQuCiAgICAgKi8KICAgICAgJ2lzT3BlbicsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1NpZGVNZW51RGVsZWdhdGUjaXNPcGVuTGVmdAogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGxlZnQgbWVudSBpcyBjdXJyZW50bHkgb3BlbmVkLgogICAgICovCiAgICAgICdpc09wZW5MZWZ0JywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSNpc09wZW5SaWdodAogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIHJpZ2h0IG1lbnUgaXMgY3VycmVudGx5IG9wZW5lZC4KICAgICAqLwogICAgICAnaXNPcGVuUmlnaHQnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlI2NhbkRyYWdDb250ZW50CiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBjYW5EcmFnIFNldCB3aGV0aGVyIHRoZSBjb250ZW50IGNhbiBvciBjYW5ub3QgYmUgZHJhZ2dlZCB0byBvcGVuCiAgICAgKiBzaWRlIG1lbnVzLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGNvbnRlbnQgY2FuIGJlIGRyYWdnZWQgdG8gb3BlbiBzaWRlIG1lbnVzLgogICAgICovCiAgICAgICdjYW5EcmFnQ29udGVudCcsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1NpZGVNZW51RGVsZWdhdGUjZWRnZURyYWdUaHJlc2hvbGQKICAgICAqIEBwYXJhbSB7Ym9vbGVhbnxudW1iZXI9fSB2YWx1ZSBTZXQgd2hldGhlciB0aGUgY29udGVudCBkcmFnIGNhbiBvbmx5IHN0YXJ0IGlmIGl0IGlzIGJlbG93IGEgY2VydGFpbiB0aHJlc2hvbGQgZGlzdGFuY2UgZnJvbSB0aGUgZWRnZSBvZiB0aGUgc2NyZWVuLiBBY2NlcHRzIHRocmVlIGRpZmZlcmVudCB2YWx1ZXM6CiAgICAgKiAgLSBJZiBhIG5vbi16ZXJvIG51bWJlciBpcyBnaXZlbiwgdGhhdCBtYW55IHBpeGVscyBpcyB1c2VkIGFzIHRoZSBtYXhpbXVtIGFsbG93ZWQgZGlzdGFuY2UgZnJvbSB0aGUgZWRnZSB0aGF0IHN0YXJ0cyBkcmFnZ2luZyB0aGUgc2lkZSBtZW51LgogICAgICogIC0gSWYgdHJ1ZSBpcyBnaXZlbiwgdGhlIGRlZmF1bHQgbnVtYmVyIG9mIHBpeGVscyAoMjUpIGlzIHVzZWQgYXMgdGhlIG1heGltdW0gYWxsb3dlZCBkaXN0YW5jZS4KICAgICAqICAtIElmIGZhbHNlIG9yIDAgaXMgZ2l2ZW4sIHRoZSBlZGdlIGRyYWcgdGhyZXNob2xkIGlzIGRpc2FibGVkLCBhbmQgZHJhZ2dpbmcgZnJvbSBhbnl3aGVyZSBvbiB0aGUgY29udGVudCBpcyBhbGxvd2VkLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIGRyYWcgY2FuIHN0YXJ0IG9ubHkgZnJvbSB3aXRoaW4gdGhlIGVkZ2Ugb2Ygc2NyZWVuIHRocmVzaG9sZC4KICAgICAqLwogICAgICAnZWRnZURyYWdUaHJlc2hvbGQnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTaWRlTWVudURlbGVnYXRlIyRnZXRCeUhhbmRsZQogICAgICogQHBhcmFtIHtzdHJpbmd9IGhhbmRsZQogICAgICogQHJldHVybnMgYGRlbGVnYXRlSW5zdGFuY2VgIEEgZGVsZWdhdGUgaW5zdGFuY2UgdGhhdCBjb250cm9scyBvbmx5IHRoZQogICAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXN9IGRpcmVjdGl2ZXMgd2l0aCBgZGVsZWdhdGUtaGFuZGxlYCBtYXRjaGluZwogICAgICogdGhlIGdpdmVuIGhhbmRsZS4KICAgICAqCiAgICAgKiBFeGFtcGxlOiBgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZS4kZ2V0QnlIYW5kbGUoJ215LWhhbmRsZScpLnRvZ2dsZUxlZnQoKTtgCiAgICAgKi8KICAgIF0pKTsKCgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZQogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVzY3JpcHRpb24KICAgKiBEZWxlZ2F0ZSB0aGF0IGNvbnRyb2xzIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNsaWRlQm94fSBkaXJlY3RpdmUuCiAgICoKICAgKiBNZXRob2RzIGNhbGxlZCBkaXJlY3RseSBvbiB0aGUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSBzZXJ2aWNlIHdpbGwgY29udHJvbCBhbGwgc2xpZGUgYm94ZXMuICBVc2UgdGhlIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1NsaWRlQm94RGVsZWdhdGUjJGdldEJ5SGFuZGxlICRnZXRCeUhhbmRsZX0KICAgKiBtZXRob2QgdG8gY29udHJvbCBzcGVjaWZpYyBzbGlkZSBib3ggaW5zdGFuY2VzLgogICAqCiAgICogQHVzYWdlCiAgICoKICAgKiBgYGBodG1sCiAgICogPGJvZHkgbmctY29udHJvbGxlcj0iTXlDdHJsIj4KICAgKiAgIDxpb24tc2xpZGUtYm94PgogICAqICAgICA8aW9uLXNsaWRlPgogICAqICAgICAgIDxkaXYgY2xhc3M9ImJveCBibHVlIj4KICAgKiAgICAgICAgIDxidXR0b24gbmctY2xpY2s9Im5leHRTbGlkZSgpIj5OZXh0IHNsaWRlITwvYnV0dG9uPgogICAqICAgICAgIDwvZGl2PgogICAqICAgICA8L2lvbi1zbGlkZT4KICAgKiAgICAgPGlvbi1zbGlkZT4KICAgKiAgICAgICA8ZGl2IGNsYXNzPSJib3ggcmVkIj4KICAgKiAgICAgICAgIFNsaWRlIDIhCiAgICogICAgICAgPC9kaXY+CiAgICogICAgIDwvaW9uLXNsaWRlPgogICAqICAgPC9pb24tc2xpZGUtYm94PgogICAqIDwvYm9keT4KICAgKiBgYGAKICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIE15Q3RybCgkc2NvcGUsICRpb25pY1NsaWRlQm94RGVsZWdhdGUpIHsKICogICAkc2NvcGUubmV4dFNsaWRlID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNTbGlkZUJveERlbGVnYXRlLm5leHQoKTsKICogICB9CiAqIH0KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLnNlcnZpY2UoJyRpb25pY1NsaWRlQm94RGVsZWdhdGUnLCBkZWxlZ2F0ZVNlcnZpY2UoWwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlI3VwZGF0ZQogICAgICogQGRlc2NyaXB0aW9uCiAgICAgKiBVcGRhdGUgdGhlIHNsaWRlYm94IChmb3IgZXhhbXBsZSBpZiB1c2luZyBBbmd1bGFyIHdpdGggbmctcmVwZWF0LAogICAgICogcmVzaXplIGl0IGZvciB0aGUgZWxlbWVudHMgaW5zaWRlKS4KICAgICAqLwogICAgICAndXBkYXRlJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNzbGlkZQogICAgICogQHBhcmFtIHtudW1iZXJ9IHRvIFRoZSBpbmRleCB0byBzbGlkZSB0by4KICAgICAqIEBwYXJhbSB7bnVtYmVyPX0gc3BlZWQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgZm9yIHRoZSBjaGFuZ2UgdG8gdGFrZS4KICAgICAqLwogICAgICAnc2xpZGUnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlI2VuYWJsZVNsaWRlCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG91bGRFbmFibGUgV2hldGhlciB0byBlbmFibGUgc2xpZGluZyB0aGUgc2xpZGVib3guCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciBzbGlkaW5nIGlzIGVuYWJsZWQuCiAgICAgKi8KICAgICAgJ2VuYWJsZVNsaWRlJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNwcmV2aW91cwogICAgICogQGRlc2NyaXB0aW9uIEdvIHRvIHRoZSBwcmV2aW91cyBzbGlkZS4gV3JhcHMgYXJvdW5kIGlmIGF0IHRoZSBiZWdpbm5pbmcuCiAgICAgKi8KICAgICAgJ3ByZXZpb3VzJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNuZXh0CiAgICAgKiBAZGVzY3JpcHRpb24gR28gdG8gdGhlIG5leHQgc2xpZGUuIFdyYXBzIGFyb3VuZCBpZiBhdCB0aGUgZW5kLgogICAgICovCiAgICAgICduZXh0JywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNzdG9wCiAgICAgKiBAZGVzY3JpcHRpb24gU3RvcCBzbGlkaW5nLiBUaGUgc2xpZGVCb3ggd2lsbCBub3QgbW92ZSBhZ2FpbiB1bnRpbAogICAgICogZXhwbGljaXRseSB0b2xkIHRvIGRvIHNvLgogICAgICovCiAgICAgICdzdG9wJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSNzdGFydAogICAgICogQGRlc2NyaXB0aW9uIFN0YXJ0IHNsaWRpbmcgYWdhaW4gaWYgdGhlIHNsaWRlQm94IHdhcyBzdG9wcGVkLgogICAgICovCiAgICAgICdzdGFydCcsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjY3VycmVudEluZGV4CiAgICAgKiBAcmV0dXJucyBudW1iZXIgVGhlIGluZGV4IG9mIHRoZSBjdXJyZW50IHNsaWRlLgogICAgICovCiAgICAgICdjdXJyZW50SW5kZXgnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNTbGlkZUJveERlbGVnYXRlI3NsaWRlc0NvdW50CiAgICAgKiBAcmV0dXJucyBudW1iZXIgVGhlIG51bWJlciBvZiBzbGlkZXMgdGhlcmUgYXJlIGN1cnJlbnRseS4KICAgICAqLwogICAgICAnc2xpZGVzQ291bnQnCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1NsaWRlQm94RGVsZWdhdGUjJGdldEJ5SGFuZGxlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGFuZGxlCiAgICAgKiBAcmV0dXJucyBgZGVsZWdhdGVJbnN0YW5jZWAgQSBkZWxlZ2F0ZSBpbnN0YW5jZSB0aGF0IGNvbnRyb2xzIG9ubHkgdGhlCiAgICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNsaWRlQm94fSBkaXJlY3RpdmVzIHdpdGggYGRlbGVnYXRlLWhhbmRsZWAgbWF0Y2hpbmcKICAgICAqIHRoZSBnaXZlbiBoYW5kbGUuCiAgICAgKgogICAgICogRXhhbXBsZTogYCRpb25pY1NsaWRlQm94RGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdteS1oYW5kbGUnKS5zdG9wKCk7YAogICAgICovCiAgICBdKSk7CgoKICAvKioKICAgKiBAbmdkb2Mgc2VydmljZQogICAqIEBuYW1lICRpb25pY1RhYnNEZWxlZ2F0ZQogICAqIEBtb2R1bGUgaW9uaWMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIERlbGVnYXRlIGZvciBjb250cm9sbGluZyB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25UYWJzfSBkaXJlY3RpdmUuCiAgICoKICAgKiBNZXRob2RzIGNhbGxlZCBkaXJlY3RseSBvbiB0aGUgJGlvbmljVGFic0RlbGVnYXRlIHNlcnZpY2Ugd2lsbCBjb250cm9sIGFsbCBpb25UYWJzCiAgICogZGlyZWN0aXZlcy4gVXNlIHRoZSB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNUYWJzRGVsZWdhdGUjJGdldEJ5SGFuZGxlICRnZXRCeUhhbmRsZX0KICAgKiBtZXRob2QgdG8gY29udHJvbCBzcGVjaWZpYyBpb25UYWJzIGluc3RhbmNlcy4KICAgKgogICAqIEB1c2FnZQogICAqCiAgICogYGBgaHRtbAogICAqIDxib2R5IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+CiAgICogICA8aW9uLXRhYnM+CiAgICoKICAgKiAgICAgPGlvbi10YWIgdGl0bGU9IlRhYiAxIj4KICAgKiAgICAgICBIZWxsbyB0YWIgMSEKICAgKiAgICAgICA8YnV0dG9uIG5nLWNsaWNrPSJzZWxlY3RUYWJXaXRoSW5kZXgoMSkiPlNlbGVjdCB0YWIgMiE8L2J1dHRvbj4KICAgKiAgICAgPC9pb24tdGFiPgogICAqICAgICA8aW9uLXRhYiB0aXRsZT0iVGFiIDIiPkhlbGxvIHRhYiAyITwvaW9uLXRhYj4KICAgKgogICAqICAgPC9pb24tdGFicz4KICAgKiA8L2JvZHk+CiAgICogYGBgCiAgICogYGBganMKICAgKiBmdW5jdGlvbiBNeUN0cmwoJHNjb3BlLCAkaW9uaWNUYWJzRGVsZWdhdGUpIHsKICogICAkc2NvcGUuc2VsZWN0VGFiV2l0aEluZGV4ID0gZnVuY3Rpb24oaW5kZXgpIHsKICogICAgICRpb25pY1RhYnNEZWxlZ2F0ZS5zZWxlY3QoaW5kZXgpOwogKiAgIH0KICogfQogICAqIGBgYAogICAqLwogIElvbmljTW9kdWxlCiAgICAuc2VydmljZSgnJGlvbmljVGFic0RlbGVnYXRlJywgZGVsZWdhdGVTZXJ2aWNlKFsKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljVGFic0RlbGVnYXRlI3NlbGVjdAogICAgICogQGRlc2NyaXB0aW9uIFNlbGVjdCB0aGUgdGFiIG1hdGNoaW5nIHRoZSBnaXZlbiBpbmRleC4KICAgICAqCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggSW5kZXggb2YgdGhlIHRhYiB0byBzZWxlY3QuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG91bGRDaGFuZ2VIaXN0b3J5IFdoZXRoZXIgdGhpcyBzZWxlY3Rpb24gc2hvdWxkIGxvYWQgdGhpcyB0YWIncwogICAgICogdmlldyBoaXN0b3J5IChpZiBpdCBleGlzdHMpIGFuZCB1c2UgaXQsIG9yIGp1c3QgbG9hZCB0aGUgZGVmYXVsdCBwYWdlLgogICAgICogRGVmYXVsdCBmYWxzZS4KICAgICAqIEhpbnQ6IHlvdSBwcm9iYWJseSB3YW50IHRoaXMgdG8gYmUgdHJ1ZSBpZiB5b3UgaGF2ZSBhbgogICAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZWaWV3fSBpbnNpZGUgeW91ciB0YWIuCiAgICAgKi8KICAgICAgJ3NlbGVjdCcsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1RhYnNEZWxlZ2F0ZSNzZWxlY3RlZEluZGV4CiAgICAgKiBAcmV0dXJucyBgbnVtYmVyYCBUaGUgaW5kZXggb2YgdGhlIHNlbGVjdGVkIHRhYiwgb3IgLTEuCiAgICAgKi8KICAgICAgJ3NlbGVjdGVkSW5kZXgnCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY1RhYnNEZWxlZ2F0ZSMkZ2V0QnlIYW5kbGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBoYW5kbGUKICAgICAqIEByZXR1cm5zIGBkZWxlZ2F0ZUluc3RhbmNlYCBBIGRlbGVnYXRlIGluc3RhbmNlIHRoYXQgY29udHJvbHMgb25seSB0aGUKICAgICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uVGFic30gZGlyZWN0aXZlcyB3aXRoIGBkZWxlZ2F0ZS1oYW5kbGVgIG1hdGNoaW5nCiAgICAgKiB0aGUgZ2l2ZW4gaGFuZGxlLgogICAgICoKICAgICAqIEV4YW1wbGU6IGAkaW9uaWNUYWJzRGVsZWdhdGUuJGdldEJ5SGFuZGxlKCdteS1oYW5kbGUnKS5zZWxlY3QoMCk7YAogICAgICovCiAgICBdKSk7CgoKICBJb25pY01vZHVsZQogICAgLmZhY3RvcnkoJyRpb25pY1RlbXBsYXRlTG9hZGVyJywgWwogICAgICAnJGNvbXBpbGUnLAogICAgICAnJGNvbnRyb2xsZXInLAogICAgICAnJGh0dHAnLAogICAgICAnJHEnLAogICAgICAnJHJvb3RTY29wZScsCiAgICAgICckdGVtcGxhdGVDYWNoZScsCiAgICAgIGZ1bmN0aW9uKCRjb21waWxlLCAkY29udHJvbGxlciwgJGh0dHAsICRxLCAkcm9vdFNjb3BlLCAkdGVtcGxhdGVDYWNoZSkgewoKICAgICAgICByZXR1cm4gewogICAgICAgICAgbG9hZDogZmV0Y2hUZW1wbGF0ZSwKICAgICAgICAgIGNvbXBpbGU6IGxvYWRBbmRDb21waWxlCiAgICAgICAgfTsKCiAgICAgICAgZnVuY3Rpb24gZmV0Y2hUZW1wbGF0ZSh1cmwpIHsKICAgICAgICAgIHJldHVybiAkaHR0cC5nZXQodXJsLCB7Y2FjaGU6ICR0ZW1wbGF0ZUNhY2hlfSkKICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuZGF0YSAmJiByZXNwb25zZS5kYXRhLnRyaW0oKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBsb2FkQW5kQ29tcGlsZShvcHRpb25zKSB7CiAgICAgICAgICBvcHRpb25zID0gZXh0ZW5kKHsKICAgICAgICAgICAgdGVtcGxhdGU6ICcnLAogICAgICAgICAgICB0ZW1wbGF0ZVVybDogJycsCiAgICAgICAgICAgIHNjb3BlOiBudWxsLAogICAgICAgICAgICBjb250cm9sbGVyOiBudWxsLAogICAgICAgICAgICBsb2NhbHM6IHt9LAogICAgICAgICAgICBhcHBlbmRUbzogbnVsbAogICAgICAgICAgfSwgb3B0aW9ucyB8fCB7fSk7CgogICAgICAgICAgdmFyIHRlbXBsYXRlUHJvbWlzZSA9IG9wdGlvbnMudGVtcGxhdGVVcmwgPwogICAgICAgICAgICB0aGlzLmxvYWQob3B0aW9ucy50ZW1wbGF0ZVVybCkgOgogICAgICAgICAgICAkcS53aGVuKG9wdGlvbnMudGVtcGxhdGUpOwoKICAgICAgICAgIHJldHVybiB0ZW1wbGF0ZVByb21pc2UudGhlbihmdW5jdGlvbih0ZW1wbGF0ZSkgewogICAgICAgICAgICB2YXIgY29udHJvbGxlcjsKICAgICAgICAgICAgdmFyIHNjb3BlID0gb3B0aW9ucy5zY29wZSB8fCAkcm9vdFNjb3BlLiRuZXcoKTsKCiAgICAgICAgICAgIC8vSW5jYXNlIHRlbXBsYXRlIGRvZXNuJ3QgaGF2ZSBqdXN0IG9uZSByb290IGVsZW1lbnQsIGRvIHRoaXMKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBqcUxpdGUoJzxkaXY+JykuaHRtbCh0ZW1wbGF0ZSkuY29udGVudHMoKTsKCiAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRyb2xsZXIpIHsKICAgICAgICAgICAgICBjb250cm9sbGVyID0gJGNvbnRyb2xsZXIoCiAgICAgICAgICAgICAgICBvcHRpb25zLmNvbnRyb2xsZXIsCiAgICAgICAgICAgICAgICBleHRlbmQob3B0aW9ucy5sb2NhbHMsIHsKICAgICAgICAgICAgICAgICAgJHNjb3BlOiBzY29wZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIGVsZW1lbnQuY2hpbGRyZW4oKS5kYXRhKCckbmdDb250cm9sbGVyQ29udHJvbGxlcicsIGNvbnRyb2xsZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zLmFwcGVuZFRvKSB7CiAgICAgICAgICAgICAganFMaXRlKG9wdGlvbnMuYXBwZW5kVG8pLmFwcGVuZChlbGVtZW50KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGNvbXBpbGUoZWxlbWVudCkoc2NvcGUpOwoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBlbGVtZW50OiBlbGVtZW50LAogICAgICAgICAgICAgIHNjb3BlOiBzY29wZQogICAgICAgICAgICB9OwogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgfV0pOwoKICAvKioKICAgKiBAcHJpdmF0ZQogICAqIFRPRE8gZG9jdW1lbnQKICAgKi8KICBJb25pY01vZHVsZQogICAgLnJ1bihbCiAgICAgICckcm9vdFNjb3BlJywKICAgICAgJyRzdGF0ZScsCiAgICAgICckbG9jYXRpb24nLAogICAgICAnJGRvY3VtZW50JywKICAgICAgJyRhbmltYXRlJywKICAgICAgJyRpb25pY1BsYXRmb3JtJywKICAgICAgJyRpb25pY1ZpZXdTZXJ2aWNlJywKICAgICAgZnVuY3Rpb24oJHJvb3RTY29wZSwgJHN0YXRlLCAkbG9jYXRpb24sICRkb2N1bWVudCwgJGFuaW1hdGUsICRpb25pY1BsYXRmb3JtLCAkaW9uaWNWaWV3U2VydmljZSkgewoKICAgICAgICAvLyBpbml0IHRoZSB2YXJpYWJsZXMgdGhhdCBrZWVwIHRyYWNrIG9mIHRoZSB2aWV3IGhpc3RvcnkKICAgICAgICAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeSA9IHsKICAgICAgICAgIGhpc3RvcmllczogeyByb290OiB7IGhpc3RvcnlJZDogJ3Jvb3QnLCBwYXJlbnRIaXN0b3J5SWQ6IG51bGwsIHN0YWNrOiBbXSwgY3Vyc29yOiAtMSB9IH0sCiAgICAgICAgICB2aWV3czoge30sCiAgICAgICAgICBiYWNrVmlldzogbnVsbCwKICAgICAgICAgIGZvcndhcmRWaWV3OiBudWxsLAogICAgICAgICAgY3VycmVudFZpZXc6IG51bGwsCiAgICAgICAgICBkaXNhYmxlZFJlZ2lzdHJhYmxlVGFnTmFtZXM6IFtdCiAgICAgICAgfTsKCiAgICAgICAgLy8gc2V0IHRoYXQgdGhlc2UgZGlyZWN0aXZlcyBzaG91bGQgbm90IGFuaW1hdGUgd2hlbiB0cmFuc2l0aW9uaW5nCiAgICAgICAgLy8gdG8gaXQuIEluc3RlYWQsIHRoZSBjaGlsZHJlbiA8dGFiPiBkaXJlY3RpdmVzIHdvdWxkIGFuaW1hdGUKICAgICAgICBpZiAoJGlvbmljVmlld1NlcnZpY2UuZGlzYWJsZVJlZ2lzdGVyQnlUYWdOYW1lKSB7CiAgICAgICAgICAkaW9uaWNWaWV3U2VydmljZS5kaXNhYmxlUmVnaXN0ZXJCeVRhZ05hbWUoJ2lvbi10YWJzJyk7CiAgICAgICAgICAkaW9uaWNWaWV3U2VydmljZS5kaXNhYmxlUmVnaXN0ZXJCeVRhZ05hbWUoJ2lvbi1zaWRlLW1lbnVzJyk7CiAgICAgICAgfQoKICAgICAgICAkcm9vdFNjb3BlLiRvbigndmlld1N0YXRlLmNoYW5nZUhpc3RvcnknLCBmdW5jdGlvbihlLCBkYXRhKSB7CiAgICAgICAgICBpZighZGF0YSkgcmV0dXJuOwoKICAgICAgICAgIHZhciBoaXN0ID0gKGRhdGEuaGlzdG9yeUlkID8gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuaGlzdG9yaWVzWyBkYXRhLmhpc3RvcnlJZCBdIDogbnVsbCApOwogICAgICAgICAgaWYoaGlzdCAmJiBoaXN0LmN1cnNvciA+IC0xICYmIGhpc3QuY3Vyc29yIDwgaGlzdC5zdGFjay5sZW5ndGgpIHsKICAgICAgICAgICAgLy8gdGhlIGhpc3RvcnkgdGhleSdyZSBnb2luZyB0byBhbHJlYWR5IGV4aXN0cwogICAgICAgICAgICAvLyBnbyB0byBpdCdzIGxhc3QgdmlldyBpbiBpdHMgc3RhY2sKICAgICAgICAgICAgdmFyIHZpZXcgPSBoaXN0LnN0YWNrWyBoaXN0LmN1cnNvciBdOwogICAgICAgICAgICByZXR1cm4gdmlldy5nbyhkYXRhKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyB0aGlzIGhpc3RvcnkgZG9lcyBub3QgaGF2ZSBhIFVSTCwgYnV0IGl0IGRvZXMgaGF2ZSBhIHVpU3JlZgogICAgICAgICAgLy8gZmlndXJlIG91dCBpdHMgVVJMIGZyb20gdGhlIHVpU3JlZgogICAgICAgICAgaWYoIWRhdGEudXJsICYmIGRhdGEudWlTcmVmKSB7CiAgICAgICAgICAgIGRhdGEudXJsID0gJHN0YXRlLmhyZWYoZGF0YS51aVNyZWYpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmKGRhdGEudXJsKSB7CiAgICAgICAgICAgIC8vIGRvbid0IGxldCBpdCBzdGFydCB3aXRoIGEgIywgbWVzc2VzIHdpdGggJGxvY2F0aW9uLnVybCgpCiAgICAgICAgICAgIGlmKGRhdGEudXJsLmluZGV4T2YoJyMnKSA9PT0gMCkgewogICAgICAgICAgICAgIGRhdGEudXJsID0gZGF0YS51cmwucmVwbGFjZSgnIycsICcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihkYXRhLnVybCAhPT0gJGxvY2F0aW9uLnVybCgpKSB7CiAgICAgICAgICAgICAgLy8gd2UndmUgZ290IGEgZ29vZCBVUkwsIHJlYWR5IEdPIQogICAgICAgICAgICAgICRsb2NhdGlvbi51cmwoZGF0YS51cmwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8vIFNldCB0aGUgZG9jdW1lbnQgdGl0bGUgd2hlbiBhIG5ldyB2aWV3IGlzIHNob3duCiAgICAgICAgJHJvb3RTY29wZS4kb24oJ3ZpZXdTdGF0ZS52aWV3RW50ZXInLCBmdW5jdGlvbihlLCBkYXRhKSB7CiAgICAgICAgICBpZihkYXRhICYmIGRhdGEudGl0bGUpIHsKICAgICAgICAgICAgJGRvY3VtZW50WzBdLnRpdGxlID0gZGF0YS50aXRsZTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgLy8gVHJpZ2dlcmVkIHdoZW4gZGV2aWNlcyB3aXRoIGEgaGFyZHdhcmUgYmFjayBidXR0b24gKEFuZHJvaWQpIGlzIGNsaWNrZWQgYnkgdGhlIHVzZXIKICAgICAgICAvLyBUaGlzIGlzIGEgQ29yZG92YS9QaG9uZWdhcCBwbGF0Zm9ybSBzcGVjaWZjIG1ldGhvZAogICAgICAgIGZ1bmN0aW9uIG9uSGFyZHdhcmVCYWNrQnV0dG9uKGUpIHsKICAgICAgICAgIGlmKCRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmJhY2tWaWV3KSB7CiAgICAgICAgICAgIC8vIHRoZXJlIGlzIGEgYmFjayB2aWV3LCBnbyB0byBpdAogICAgICAgICAgICAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5iYWNrVmlldy5nbygpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gdGhlcmUgaXMgbm8gYmFjayB2aWV3LCBzbyBjbG9zZSB0aGUgYXBwIGluc3RlYWQKICAgICAgICAgICAgaW9uaWMuUGxhdGZvcm0uZXhpdEFwcCgpOwogICAgICAgICAgfQogICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICAkaW9uaWNQbGF0Zm9ybS5yZWdpc3RlckJhY2tCdXR0b25BY3Rpb24oCiAgICAgICAgICBvbkhhcmR3YXJlQmFja0J1dHRvbiwKICAgICAgICAgIFBMQVRGT1JNX0JBQ0tfQlVUVE9OX1BSSU9SSVRZX1ZJRVcKICAgICAgICApOwoKICAgICAgfV0pCgogICAgLmZhY3RvcnkoJyRpb25pY1ZpZXdTZXJ2aWNlJywgWwogICAgICAnJHJvb3RTY29wZScsCiAgICAgICckc3RhdGUnLAogICAgICAnJGxvY2F0aW9uJywKICAgICAgJyR3aW5kb3cnLAogICAgICAnJGluamVjdG9yJywKICAgICAgJyRhbmltYXRlJywKICAgICAgJyRpb25pY05hdlZpZXdDb25maWcnLAogICAgICBmdW5jdGlvbigkcm9vdFNjb3BlLCAkc3RhdGUsICRsb2NhdGlvbiwgJHdpbmRvdywgJGluamVjdG9yLCAkYW5pbWF0ZSwgJGlvbmljTmF2Vmlld0NvbmZpZykgewoKICAgICAgICB2YXIgVmlldyA9IGZ1bmN0aW9uKCl7fTsKICAgICAgICBWaWV3LnByb3RvdHlwZS5pbml0aWFsaXplID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgaWYoZGF0YSkgewogICAgICAgICAgICBmb3IodmFyIG5hbWUgaW4gZGF0YSkgdGhpc1tuYW1lXSA9IGRhdGFbbmFtZV07CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBWaWV3LnByb3RvdHlwZS5nbyA9IGZ1bmN0aW9uKCkgewoKICAgICAgICAgIGlmKHRoaXMuc3RhdGVOYW1lKSB7CiAgICAgICAgICAgIHJldHVybiAkc3RhdGUuZ28odGhpcy5zdGF0ZU5hbWUsIHRoaXMuc3RhdGVQYXJhbXMpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmKHRoaXMudXJsICYmIHRoaXMudXJsICE9PSAkbG9jYXRpb24udXJsKCkpIHsKCiAgICAgICAgICAgIGlmKCRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmJhY2tWaWV3ID09PSB0aGlzKSB7CiAgICAgICAgICAgICAgcmV0dXJuICR3aW5kb3cuaGlzdG9yeS5nbygtMSk7CiAgICAgICAgICAgIH0gZWxzZSBpZigkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5mb3J3YXJkVmlldyA9PT0gdGhpcykgewogICAgICAgICAgICAgIHJldHVybiAkd2luZG93Lmhpc3RvcnkuZ28oMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRsb2NhdGlvbi51cmwodGhpcy51cmwpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfTsKICAgICAgICBWaWV3LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZih0aGlzLnNjb3BlKSB7CiAgICAgICAgICAgIHRoaXMuc2NvcGUuJGRlc3Ryb3kgJiYgdGhpcy5zY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICB0aGlzLnNjb3BlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBmdW5jdGlvbiBjcmVhdGVWaWV3SWQoc3RhdGVJZCkgewogICAgICAgICAgcmV0dXJuIGlvbmljLlV0aWxzLm5leHRVaWQoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CgogICAgICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGNvbnRhaW5lclNjb3BlLCBlbGVtZW50KSB7CgogICAgICAgICAgICB2YXIgdmlld0hpc3RvcnkgPSAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeSwKICAgICAgICAgICAgICBjdXJyZW50U3RhdGVJZCA9IHRoaXMuZ2V0Q3VycmVudFN0YXRlSWQoKSwKICAgICAgICAgICAgICBoaXN0ID0gdGhpcy5fZ2V0SGlzdG9yeShjb250YWluZXJTY29wZSksCiAgICAgICAgICAgICAgY3VycmVudFZpZXcgPSB2aWV3SGlzdG9yeS5jdXJyZW50VmlldywKICAgICAgICAgICAgICBiYWNrVmlldyA9IHZpZXdIaXN0b3J5LmJhY2tWaWV3LAogICAgICAgICAgICAgIGZvcndhcmRWaWV3ID0gdmlld0hpc3RvcnkuZm9yd2FyZFZpZXcsCiAgICAgICAgICAgICAgbmV4dFZpZXdPcHRpb25zID0gdGhpcy5uZXh0Vmlld09wdGlvbnMoKSwKICAgICAgICAgICAgICByc3AgPSB7CiAgICAgICAgICAgICAgICB2aWV3SWQ6IG51bGwsCiAgICAgICAgICAgICAgICBuYXZBY3Rpb246IG51bGwsCiAgICAgICAgICAgICAgICBuYXZEaXJlY3Rpb246IG51bGwsCiAgICAgICAgICAgICAgICBoaXN0b3J5SWQ6IGhpc3QuaGlzdG9yeUlkCiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlmKGVsZW1lbnQgJiYgIXRoaXMuaXNUYWdOYW1lUmVnaXN0cmFibGUoZWxlbWVudCkpIHsKICAgICAgICAgICAgICAvLyBmaXJzdCBjaGVjayB0byBzZWUgaWYgdGhpcyBlbGVtZW50IGNhbiBldmVuIGJlIHJlZ2lzdGVyZWQgYXMgYSB2aWV3LgogICAgICAgICAgICAgIC8vIENlcnRhaW4gdGFncyBhcmUgb25seSBjb250YWluZXJzIGZvciB2aWV3cywgYnV0IGFyZSBub3Qgdmlld3MgdGhlbXNlbHZlcy4KICAgICAgICAgICAgICAvLyBGb3IgZXhhbXBsZSwgdGhlIDxpb24tdGFicz4gZGlyZWN0aXZlIGNvbnRhaW5zIGEgPGlvbi10YWI+IGFuZCB0aGUgPGlvbi10YWI+IGlzIHRoZQogICAgICAgICAgICAgIC8vIHZpZXcsIGJ1dCB0aGUgPGlvbi10YWJzPiBkaXJlY3RpdmUgaXRzZWxmIHNob3VsZCBub3QgYmUgcmVnaXN0ZXJlZCBhcyBhIHZpZXcuCiAgICAgICAgICAgICAgcnNwLm5hdkFjdGlvbiA9ICdkaXNhYmxlZEJ5VGFnTmFtZSc7CiAgICAgICAgICAgICAgcmV0dXJuIHJzcDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoY3VycmVudFZpZXcgJiYKICAgICAgICAgICAgICBjdXJyZW50Vmlldy5zdGF0ZUlkID09PSBjdXJyZW50U3RhdGVJZCAmJgogICAgICAgICAgICAgIGN1cnJlbnRWaWV3Lmhpc3RvcnlJZCA9PT0gaGlzdC5oaXN0b3J5SWQpIHsKICAgICAgICAgICAgICAvLyBkbyBub3RoaW5nIGlmIGl0cyB0aGUgc2FtZSBzdGF0ZUlkIGluIHRoZSBzYW1lIGhpc3RvcnkKICAgICAgICAgICAgICByc3AubmF2QWN0aW9uID0gJ25vQ2hhbmdlJzsKICAgICAgICAgICAgICByZXR1cm4gcnNwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZih2aWV3SGlzdG9yeS5mb3JjZWROYXYpIHsKICAgICAgICAgICAgICAvLyB3ZSd2ZSBwcmV2aW91c2x5IHNldCBleGFjdGx5IHdoYXQgdG8gZG8KICAgICAgICAgICAgICBpb25pYy5VdGlscy5leHRlbmQocnNwLCB2aWV3SGlzdG9yeS5mb3JjZWROYXYpOwogICAgICAgICAgICAgICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmZvcmNlZE5hdiA9IG51bGw7CgogICAgICAgICAgICB9IGVsc2UgaWYoYmFja1ZpZXcgJiYgYmFja1ZpZXcuc3RhdGVJZCA9PT0gY3VycmVudFN0YXRlSWQpIHsKICAgICAgICAgICAgICAvLyB0aGV5IHdlbnQgYmFjayBvbmUsIHNldCB0aGUgb2xkIGN1cnJlbnQgdmlldyBhcyBhIGZvcndhcmQgdmlldwogICAgICAgICAgICAgIHJzcC52aWV3SWQgPSBiYWNrVmlldy52aWV3SWQ7CiAgICAgICAgICAgICAgcnNwLm5hdkFjdGlvbiA9ICdtb3ZlQmFjayc7CiAgICAgICAgICAgICAgcnNwLnZpZXdJZCA9IGJhY2tWaWV3LnZpZXdJZDsKICAgICAgICAgICAgICBpZihiYWNrVmlldy5oaXN0b3J5SWQgPT09IGN1cnJlbnRWaWV3Lmhpc3RvcnlJZCkgewogICAgICAgICAgICAgICAgLy8gd2VudCBiYWNrIGluIHRoZSBzYW1lIGhpc3RvcnkKICAgICAgICAgICAgICAgIHJzcC5uYXZEaXJlY3Rpb24gPSAnYmFjayc7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIGlmKGZvcndhcmRWaWV3ICYmIGZvcndhcmRWaWV3LnN0YXRlSWQgPT09IGN1cnJlbnRTdGF0ZUlkKSB7CiAgICAgICAgICAgICAgLy8gdGhleSB3ZW50IHRvIHRoZSBmb3J3YXJkIG9uZSwgc2V0IHRoZSBmb3J3YXJkIHZpZXcgdG8gbm8gbG9uZ2VyIGEgZm9yd2FyZCB2aWV3CiAgICAgICAgICAgICAgcnNwLnZpZXdJZCA9IGZvcndhcmRWaWV3LnZpZXdJZDsKICAgICAgICAgICAgICByc3AubmF2QWN0aW9uID0gJ21vdmVGb3J3YXJkJzsKICAgICAgICAgICAgICBpZihmb3J3YXJkVmlldy5oaXN0b3J5SWQgPT09IGN1cnJlbnRWaWV3Lmhpc3RvcnlJZCkgewogICAgICAgICAgICAgICAgcnNwLm5hdkRpcmVjdGlvbiA9ICdmb3J3YXJkJzsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHZhciBwYXJlbnRIaXN0b3J5ID0gdGhpcy5fZ2V0UGFyZW50SGlzdG9yeU9iaihjb250YWluZXJTY29wZSk7CiAgICAgICAgICAgICAgaWYoZm9yd2FyZFZpZXcuaGlzdG9yeUlkICYmIHBhcmVudEhpc3Rvcnkuc2NvcGUpIHsKICAgICAgICAgICAgICAgIC8vIGlmIGEgaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIGNyZWF0ZWQgYnkgdGhlIGZvcndhcmQgdmlldyB0aGVuIG1ha2Ugc3VyZSBpdCBzdGF5cyB0aGUgc2FtZQogICAgICAgICAgICAgICAgcGFyZW50SGlzdG9yeS5zY29wZS4kaGlzdG9yeUlkID0gZm9yd2FyZFZpZXcuaGlzdG9yeUlkOwogICAgICAgICAgICAgICAgcnNwLmhpc3RvcnlJZCA9IGZvcndhcmRWaWV3Lmhpc3RvcnlJZDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgaWYoY3VycmVudFZpZXcgJiYgY3VycmVudFZpZXcuaGlzdG9yeUlkICE9PSBoaXN0Lmhpc3RvcnlJZCAmJgogICAgICAgICAgICAgIGhpc3QuY3Vyc29yID4gLTEgJiYgaGlzdC5zdGFjay5sZW5ndGggPiAwICYmIGhpc3QuY3Vyc29yIDwgaGlzdC5zdGFjay5sZW5ndGggJiYKICAgICAgICAgICAgICBoaXN0LnN0YWNrW2hpc3QuY3Vyc29yXS5zdGF0ZUlkID09PSBjdXJyZW50U3RhdGVJZCkgewogICAgICAgICAgICAgIC8vIHRoZXkganVzdCBjaGFuZ2VkIHRvIGEgZGlmZmVyZW50IGhpc3RvcnkgYW5kIHRoZSBoaXN0b3J5IGFscmVhZHkgaGFzIHZpZXdzIGluIGl0CiAgICAgICAgICAgICAgcnNwLnZpZXdJZCA9IGhpc3Quc3RhY2tbaGlzdC5jdXJzb3JdLnZpZXdJZDsKICAgICAgICAgICAgICByc3AubmF2QWN0aW9uID0gJ21vdmVCYWNrJzsKCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgIC8vIHNldCBhIG5ldyB1bmlxdWUgdmlld0lkCiAgICAgICAgICAgICAgcnNwLnZpZXdJZCA9IGNyZWF0ZVZpZXdJZChjdXJyZW50U3RhdGVJZCk7CgogICAgICAgICAgICAgIGlmKGN1cnJlbnRWaWV3KSB7CiAgICAgICAgICAgICAgICAvLyBzZXQgdGhlIGZvcndhcmQgdmlldyBpZiB0aGVyZSBpcyBhIGN1cnJlbnQgdmlldyAoaWU6IGlmIGl0cyBub3QgdGhlIGZpcnN0IHZpZXcpCiAgICAgICAgICAgICAgICBjdXJyZW50Vmlldy5mb3J3YXJkVmlld0lkID0gcnNwLnZpZXdJZDsKCiAgICAgICAgICAgICAgICAvLyBpdHMgb25seSBtb3ZpbmcgZm9yd2FyZCBpZiBpdHMgaW4gdGhlIHNhbWUgaGlzdG9yeQogICAgICAgICAgICAgICAgaWYoaGlzdC5oaXN0b3J5SWQgPT09IGN1cnJlbnRWaWV3Lmhpc3RvcnlJZCkgewogICAgICAgICAgICAgICAgICByc3AubmF2RGlyZWN0aW9uID0gJ2ZvcndhcmQnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcnNwLm5hdkFjdGlvbiA9ICduZXdWaWV3JzsKCiAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiB0aGVyZSBpcyBhIG5ldyBmb3J3YXJkIHZpZXcKICAgICAgICAgICAgICAgIGlmKGZvcndhcmRWaWV3ICYmIGN1cnJlbnRWaWV3LnN0YXRlSWQgIT09IGZvcndhcmRWaWV3LnN0YXRlSWQpIHsKICAgICAgICAgICAgICAgICAgLy8gdGhleSBuYXZpZ2F0ZWQgdG8gYSBuZXcgdmlldyBidXQgdGhlIHN0YWNrIGFscmVhZHkgaGFzIGEgZm9yd2FyZCB2aWV3CiAgICAgICAgICAgICAgICAgIC8vIHNpbmNlIGl0cyBhIG5ldyB2aWV3IHJlbW92ZSBhbnkgZm9yd2FyZHMgdGhhdCBleGlzdGVkCiAgICAgICAgICAgICAgICAgIHZhciBmb3J3YXJkc0hpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5QnlJZChmb3J3YXJkVmlldy5oaXN0b3J5SWQpOwogICAgICAgICAgICAgICAgICBpZihmb3J3YXJkc0hpc3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0aGUgZm9yd2FyZCBoYXMgYSBoaXN0b3J5CiAgICAgICAgICAgICAgICAgICAgZm9yKHZhciB4PWZvcndhcmRzSGlzdG9yeS5zdGFjay5sZW5ndGggLSAxOyB4ID49IGZvcndhcmRWaWV3LmluZGV4OyB4LS0pIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIHN0YXJ0aW5nIGZyb20gdGhlIGVuZCBkZXN0cm95IGFsbCBmb3J3YXJkcyBpbiB0aGlzIGhpc3RvcnkgZnJvbSB0aGlzIHBvaW50CiAgICAgICAgICAgICAgICAgICAgICBmb3J3YXJkc0hpc3Rvcnkuc3RhY2tbeF0uZGVzdHJveSgpOwogICAgICAgICAgICAgICAgICAgICAgZm9yd2FyZHNIaXN0b3J5LnN0YWNrLnNwbGljZSh4KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHRoZXJlJ3Mgbm8gY3VycmVudCB2aWV3LCBzbyB0aGlzIG11c3QgYmUgdGhlIGluaXRpYWwgdmlldwogICAgICAgICAgICAgICAgcnNwLm5hdkFjdGlvbiA9ICdpbml0aWFsVmlldyc7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBhZGQgdGhlIG5ldyB2aWV3CiAgICAgICAgICAgICAgdmlld0hpc3Rvcnkudmlld3NbcnNwLnZpZXdJZF0gPSB0aGlzLmNyZWF0ZVZpZXcoewogICAgICAgICAgICAgICAgdmlld0lkOiByc3Audmlld0lkLAogICAgICAgICAgICAgICAgaW5kZXg6IGhpc3Quc3RhY2subGVuZ3RoLAogICAgICAgICAgICAgICAgaGlzdG9yeUlkOiBoaXN0Lmhpc3RvcnlJZCwKICAgICAgICAgICAgICAgIGJhY2tWaWV3SWQ6IChjdXJyZW50VmlldyAmJiBjdXJyZW50Vmlldy52aWV3SWQgPyBjdXJyZW50Vmlldy52aWV3SWQgOiBudWxsKSwKICAgICAgICAgICAgICAgIGZvcndhcmRWaWV3SWQ6IG51bGwsCiAgICAgICAgICAgICAgICBzdGF0ZUlkOiBjdXJyZW50U3RhdGVJZCwKICAgICAgICAgICAgICAgIHN0YXRlTmFtZTogdGhpcy5nZXRDdXJyZW50U3RhdGVOYW1lKCksCiAgICAgICAgICAgICAgICBzdGF0ZVBhcmFtczogdGhpcy5nZXRDdXJyZW50U3RhdGVQYXJhbXMoKSwKICAgICAgICAgICAgICAgIHVybDogJGxvY2F0aW9uLnVybCgpLAogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBpZiAocnNwLm5hdkFjdGlvbiA9PSAnbW92ZUJhY2snKSB7CiAgICAgICAgICAgICAgICAvL21vdmVCYWNrKGZyb20sIHRvKTsKICAgICAgICAgICAgICAgICRyb290U2NvcGUuJGVtaXQoJyR2aWV3SGlzdG9yeS52aWV3QmFjaycsIGN1cnJlbnRWaWV3LnZpZXdJZCwgcnNwLnZpZXdJZCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBhZGQgdGhlIG5ldyB2aWV3IHRvIHRoaXMgaGlzdG9yeSdzIHN0YWNrCiAgICAgICAgICAgICAgaGlzdC5zdGFjay5wdXNoKHZpZXdIaXN0b3J5LnZpZXdzW3JzcC52aWV3SWRdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYobmV4dFZpZXdPcHRpb25zKSB7CiAgICAgICAgICAgICAgaWYobmV4dFZpZXdPcHRpb25zLmRpc2FibGVBbmltYXRlKSByc3AubmF2RGlyZWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICBpZihuZXh0Vmlld09wdGlvbnMuZGlzYWJsZUJhY2spIHZpZXdIaXN0b3J5LnZpZXdzW3JzcC52aWV3SWRdLmJhY2tWaWV3SWQgPSBudWxsOwogICAgICAgICAgICAgIHRoaXMubmV4dFZpZXdPcHRpb25zKG51bGwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnNldE5hdlZpZXdzKHJzcC52aWV3SWQpOwoKICAgICAgICAgICAgaGlzdC5jdXJzb3IgPSB2aWV3SGlzdG9yeS5jdXJyZW50Vmlldy5pbmRleDsKCiAgICAgICAgICAgIHJldHVybiByc3A7CiAgICAgICAgICB9LAoKICAgICAgICAgIHNldE5hdlZpZXdzOiBmdW5jdGlvbih2aWV3SWQpIHsKICAgICAgICAgICAgdmFyIHZpZXdIaXN0b3J5ID0gJHJvb3RTY29wZS4kdmlld0hpc3Rvcnk7CgogICAgICAgICAgICB2aWV3SGlzdG9yeS5jdXJyZW50VmlldyA9IHRoaXMuX2dldFZpZXdCeUlkKHZpZXdJZCk7CiAgICAgICAgICAgIHZpZXdIaXN0b3J5LmJhY2tWaWV3ID0gdGhpcy5fZ2V0QmFja1ZpZXcodmlld0hpc3RvcnkuY3VycmVudFZpZXcpOwogICAgICAgICAgICB2aWV3SGlzdG9yeS5mb3J3YXJkVmlldyA9IHRoaXMuX2dldEZvcndhcmRWaWV3KHZpZXdIaXN0b3J5LmN1cnJlbnRWaWV3KTsKCiAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgnJHZpZXdIaXN0b3J5Lmhpc3RvcnlDaGFuZ2UnLCB7CiAgICAgICAgICAgICAgc2hvd0JhY2s6ICh2aWV3SGlzdG9yeS5iYWNrVmlldyAmJiB2aWV3SGlzdG9yeS5iYWNrVmlldy5oaXN0b3J5SWQgPT09IHZpZXdIaXN0b3J5LmN1cnJlbnRWaWV3Lmhpc3RvcnlJZCkKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAoKICAgICAgICAgIHJlZ2lzdGVySGlzdG9yeTogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgICAgc2NvcGUuJGhpc3RvcnlJZCA9IGlvbmljLlV0aWxzLm5leHRVaWQoKTsKICAgICAgICAgIH0sCgogICAgICAgICAgY3JlYXRlVmlldzogZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICB2YXIgbmV3VmlldyA9IG5ldyBWaWV3KCk7CiAgICAgICAgICAgIHJldHVybiBuZXdWaWV3LmluaXRpYWxpemUoZGF0YSk7CiAgICAgICAgICB9LAoKICAgICAgICAgIGdldEN1cnJlbnRWaWV3OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmN1cnJlbnRWaWV3OwogICAgICAgICAgfSwKCiAgICAgICAgICBnZXRCYWNrVmlldzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5iYWNrVmlldzsKICAgICAgICAgIH0sCgogICAgICAgICAgZ2V0Rm9yd2FyZFZpZXc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuZm9yd2FyZFZpZXc7CiAgICAgICAgICB9LAoKICAgICAgICAgIGdldE5hdkRpcmVjdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5uYXZEaXJlY3Rpb247CiAgICAgICAgICB9LAoKICAgICAgICAgIGdldEN1cnJlbnRTdGF0ZU5hbWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gKCRzdGF0ZSAmJiAkc3RhdGUuY3VycmVudCA/ICRzdGF0ZS5jdXJyZW50Lm5hbWUgOiBudWxsKTsKICAgICAgICAgIH0sCgogICAgICAgICAgaXNDdXJyZW50U3RhdGVOYXZWaWV3OiBmdW5jdGlvbihuYXZWaWV3KSB7CiAgICAgICAgICAgIHJldHVybiAoJHN0YXRlICYmCiAgICAgICAgICAgICAgJHN0YXRlLmN1cnJlbnQgJiYKICAgICAgICAgICAgICAkc3RhdGUuY3VycmVudC52aWV3cyAmJgogICAgICAgICAgICAgICRzdGF0ZS5jdXJyZW50LnZpZXdzW25hdlZpZXddID8gdHJ1ZSA6IGZhbHNlKTsKICAgICAgICAgIH0sCgogICAgICAgICAgZ2V0Q3VycmVudFN0YXRlUGFyYW1zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHJ0bjsKICAgICAgICAgICAgaWYgKCRzdGF0ZSAmJiAkc3RhdGUucGFyYW1zKSB7CiAgICAgICAgICAgICAgZm9yKHZhciBrZXkgaW4gJHN0YXRlLnBhcmFtcykgewogICAgICAgICAgICAgICAgaWYoJHN0YXRlLnBhcmFtcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgIHJ0biA9IHJ0biB8fCB7fTsKICAgICAgICAgICAgICAgICAgcnRuW2tleV0gPSAkc3RhdGUucGFyYW1zW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBydG47CiAgICAgICAgICB9LAoKICAgICAgICAgIGdldEN1cnJlbnRTdGF0ZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGlkOwogICAgICAgICAgICBpZigkc3RhdGUgJiYgJHN0YXRlLmN1cnJlbnQgJiYgJHN0YXRlLmN1cnJlbnQubmFtZSkgewogICAgICAgICAgICAgIGlkID0gJHN0YXRlLmN1cnJlbnQubmFtZTsKICAgICAgICAgICAgICBpZigkc3RhdGUucGFyYW1zKSB7CiAgICAgICAgICAgICAgICBmb3IodmFyIGtleSBpbiAkc3RhdGUucGFyYW1zKSB7CiAgICAgICAgICAgICAgICAgIGlmKCRzdGF0ZS5wYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAkc3RhdGUucGFyYW1zW2tleV0pIHsKICAgICAgICAgICAgICAgICAgICBpZCArPSAiXyIgKyBrZXkgKyAiPSIgKyAkc3RhdGUucGFyYW1zW2tleV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGlmIHNvbWV0aGluZyBnb2VzIHdyb25nIG1ha2Ugc3VyZSBpdHMgZ290IGEgdW5pcXVlIHN0YXRlSWQKICAgICAgICAgICAgcmV0dXJuIGlvbmljLlV0aWxzLm5leHRVaWQoKTsKICAgICAgICAgIH0sCgogICAgICAgICAgZ29Ub0hpc3RvcnlSb290OiBmdW5jdGlvbihoaXN0b3J5SWQpIHsKICAgICAgICAgICAgaWYoaGlzdG9yeUlkKSB7CiAgICAgICAgICAgICAgdmFyIGhpc3QgPSAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5oaXN0b3JpZXNbIGhpc3RvcnlJZCBdOwogICAgICAgICAgICAgIGlmKGhpc3QgJiYgaGlzdC5zdGFjay5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGlmKCRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmN1cnJlbnRWaWV3ICYmICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LmN1cnJlbnRWaWV3LnZpZXdJZCA9PT0gaGlzdC5zdGFja1swXS52aWV3SWQpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuZm9yY2VkTmF2ID0gewogICAgICAgICAgICAgICAgICB2aWV3SWQ6IGhpc3Quc3RhY2tbMF0udmlld0lkLAogICAgICAgICAgICAgICAgICBuYXZBY3Rpb246ICdtb3ZlQmFjaycsCiAgICAgICAgICAgICAgICAgIG5hdkRpcmVjdGlvbjogJ2JhY2snCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaGlzdC5zdGFja1swXS5nbygpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSwKCiAgICAgICAgICBfZ2V0Vmlld0J5SWQ6IGZ1bmN0aW9uKHZpZXdJZCkgewogICAgICAgICAgICByZXR1cm4gKHZpZXdJZCA/ICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LnZpZXdzWyB2aWV3SWQgXSA6IG51bGwgKTsKICAgICAgICAgIH0sCgogICAgICAgICAgX2dldEJhY2tWaWV3OiBmdW5jdGlvbih2aWV3KSB7CiAgICAgICAgICAgIHJldHVybiAodmlldyA/IHRoaXMuX2dldFZpZXdCeUlkKHZpZXcuYmFja1ZpZXdJZCkgOiBudWxsICk7CiAgICAgICAgICB9LAoKICAgICAgICAgIF9nZXRGb3J3YXJkVmlldzogZnVuY3Rpb24odmlldykgewogICAgICAgICAgICByZXR1cm4gKHZpZXcgPyB0aGlzLl9nZXRWaWV3QnlJZCh2aWV3LmZvcndhcmRWaWV3SWQpIDogbnVsbCApOwogICAgICAgICAgfSwKCiAgICAgICAgICBfZ2V0SGlzdG9yeUJ5SWQ6IGZ1bmN0aW9uKGhpc3RvcnlJZCkgewogICAgICAgICAgICByZXR1cm4gKGhpc3RvcnlJZCA/ICRyb290U2NvcGUuJHZpZXdIaXN0b3J5Lmhpc3Rvcmllc1sgaGlzdG9yeUlkIF0gOiBudWxsICk7CiAgICAgICAgICB9LAoKICAgICAgICAgIF9nZXRIaXN0b3J5OiBmdW5jdGlvbihzY29wZSkgewogICAgICAgICAgICB2YXIgaGlzdE9iaiA9IHRoaXMuX2dldFBhcmVudEhpc3RvcnlPYmooc2NvcGUpOwoKICAgICAgICAgICAgaWYoICEkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5oaXN0b3JpZXNbIGhpc3RPYmouaGlzdG9yeUlkIF0gKSB7CiAgICAgICAgICAgICAgLy8gdGhpcyBoaXN0b3J5IG9iamVjdCBleGlzdHMgaW4gcGFyZW50IHNjb3BlLCBidXQgZG9lc24ndAogICAgICAgICAgICAgIC8vIGV4aXN0IGluIHRoZSBoaXN0b3J5IGRhdGEgeWV0CiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuaGlzdG9yaWVzWyBoaXN0T2JqLmhpc3RvcnlJZCBdID0gewogICAgICAgICAgICAgICAgaGlzdG9yeUlkOiBoaXN0T2JqLmhpc3RvcnlJZCwKICAgICAgICAgICAgICAgIHBhcmVudEhpc3RvcnlJZDogdGhpcy5fZ2V0UGFyZW50SGlzdG9yeU9iaihoaXN0T2JqLnNjb3BlLiRwYXJlbnQpLmhpc3RvcnlJZCwKICAgICAgICAgICAgICAgIHN0YWNrOiBbXSwKICAgICAgICAgICAgICAgIGN1cnNvcjogLTEKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuaGlzdG9yaWVzWyBoaXN0T2JqLmhpc3RvcnlJZCBdOwogICAgICAgICAgfSwKCiAgICAgICAgICBfZ2V0UGFyZW50SGlzdG9yeU9iajogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICAgICAgdmFyIHBhcmVudFNjb3BlID0gc2NvcGU7CiAgICAgICAgICAgIHdoaWxlKHBhcmVudFNjb3BlKSB7CiAgICAgICAgICAgICAgaWYocGFyZW50U2NvcGUuaGFzT3duUHJvcGVydHkoJyRoaXN0b3J5SWQnKSkgewogICAgICAgICAgICAgICAgLy8gdGhpcyBwYXJlbnQgc2NvcGUgaGFzIGEgaGlzdG9yeUlkCiAgICAgICAgICAgICAgICByZXR1cm4geyBoaXN0b3J5SWQ6IHBhcmVudFNjb3BlLiRoaXN0b3J5SWQsIHNjb3BlOiBwYXJlbnRTY29wZSB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBub3RoaW5nIGZvdW5kIGtlZXAgY2xpbWJpbmcgdXAKICAgICAgICAgICAgICBwYXJlbnRTY29wZSA9IHBhcmVudFNjb3BlLiRwYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gbm8gaGlzdG9yeSBmb3IgZm9yIHRoZSBwYXJlbnQsIHVzZSB0aGUgcm9vdAogICAgICAgICAgICByZXR1cm4geyBoaXN0b3J5SWQ6ICdyb290Jywgc2NvcGU6ICRyb290U2NvcGUgfTsKICAgICAgICAgIH0sCgogICAgICAgICAgbmV4dFZpZXdPcHRpb25zOiBmdW5jdGlvbihvcHRzKSB7CiAgICAgICAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICB0aGlzLl9uZXh0T3B0cyA9IG9wdHM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX25leHRPcHRzOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAoKICAgICAgICAgIGdldFJlbmRlcmVyOiBmdW5jdGlvbihuYXZWaWV3RWxlbWVudCwgbmF2Vmlld0F0dHJzLCBuYXZWaWV3U2NvcGUpIHsKICAgICAgICAgICAgdmFyIHNlcnZpY2UgPSB0aGlzOwogICAgICAgICAgICB2YXIgcmVnaXN0ZXJEYXRhOwogICAgICAgICAgICB2YXIgZG9BbmltYXRpb247CgogICAgICAgICAgICAvLyBjbGltYiB1cCB0aGUgRE9NIGFuZCBzZWUgd2hpY2ggYW5pbWF0aW9uIGNsYXNzbmFtZSB0byB1c2UsIGlmIGFueQogICAgICAgICAgICB2YXIgYW5pbWF0aW9uQ2xhc3MgPSBnZXRQYXJlbnRBbmltYXRpb25DbGFzcyhuYXZWaWV3RWxlbWVudFswXSk7CgogICAgICAgICAgICBmdW5jdGlvbiBnZXRQYXJlbnRBbmltYXRpb25DbGFzcyhlbCkgewogICAgICAgICAgICAgIHZhciBjbGFzc05hbWUgPSAnJzsKICAgICAgICAgICAgICB3aGlsZSghY2xhc3NOYW1lICYmIGVsKSB7CiAgICAgICAgICAgICAgICBjbGFzc05hbWUgPSBlbC5nZXRBdHRyaWJ1dGUoJ2FuaW1hdGlvbicpOwogICAgICAgICAgICAgICAgZWwgPSBlbC5wYXJlbnRFbGVtZW50OwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gSWYgdGhleSBkb24ndCBoYXZlIGFuIGFuaW1hdGlvbiBzZXQgZXhwbGljaXRseSwgdXNlIHRoZSB2YWx1ZSBpbiB0aGUgY29uZmlnCiAgICAgICAgICAgICAgaWYoIWNsYXNzTmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICRpb25pY05hdlZpZXdDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHJldHVybiBjbGFzc05hbWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIHNldEFuaW1hdGlvbkNsYXNzKCkgewogICAgICAgICAgICAgIC8vIGFkZCB0aGUgYW5pbWF0aW9uIENTUyBjbGFzcyB3ZSdyZSBnb25uYSB1c2UgdG8gdHJhbnNpdGlvbiBiZXR3ZWVuIHZpZXdzCiAgICAgICAgICAgICAgaWYgKGFuaW1hdGlvbkNsYXNzKSB7CiAgICAgICAgICAgICAgICBuYXZWaWV3RWxlbWVudFswXS5jbGFzc0xpc3QuYWRkKGFuaW1hdGlvbkNsYXNzKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmKHJlZ2lzdGVyRGF0YS5uYXZEaXJlY3Rpb24gPT09ICdiYWNrJykgewogICAgICAgICAgICAgICAgLy8gYW5pbWF0ZSBsaWtlIHdlJ3JlIG1vdmluZyBiYWNrd2FyZAogICAgICAgICAgICAgICAgbmF2Vmlld0VsZW1lbnRbMF0uY2xhc3NMaXN0LmFkZCgncmV2ZXJzZScpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBkZWZhdWx0cyB0byBhbmltYXRlIGZvcndhcmQKICAgICAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSB0aGUgcmV2ZXJzZSBjbGFzcyBpc24ndCBhbHJlYWR5IGFkZGVkCiAgICAgICAgICAgICAgICBuYXZWaWV3RWxlbWVudFswXS5jbGFzc0xpc3QucmVtb3ZlKCdyZXZlcnNlJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oc2hvdWxkQW5pbWF0ZSkgewoKICAgICAgICAgICAgICByZXR1cm4gewoKICAgICAgICAgICAgICAgIGVudGVyOiBmdW5jdGlvbihlbGVtZW50KSB7CgogICAgICAgICAgICAgICAgICBpZihkb0FuaW1hdGlvbiAmJiBzaG91bGRBbmltYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gZW50ZXIgd2l0aCBhbiBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICBzZXRBbmltYXRpb25DbGFzcygpOwoKICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKCduZy1lbnRlcicpOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NMaXN0LmFkZCgnZGlzYWJsZS1wb2ludGVyLWV2ZW50cycpOwoKICAgICAgICAgICAgICAgICAgICAkYW5pbWF0ZS5lbnRlcihlbGVtZW50LCBuYXZWaWV3RWxlbWVudCwgbnVsbCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ2Rpc2FibGUtcG9pbnRlci1ldmVudHMnKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChhbmltYXRpb25DbGFzcykgewogICAgICAgICAgICAgICAgICAgICAgICBuYXZWaWV3RWxlbWVudFswXS5jbGFzc0xpc3QucmVtb3ZlKGFuaW1hdGlvbkNsYXNzKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZighZG9BbmltYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ2Rpc2FibGUtcG9pbnRlci1ldmVudHMnKTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgLy8gbm8gYW5pbWF0aW9uCiAgICAgICAgICAgICAgICAgIG5hdlZpZXdFbGVtZW50LmFwcGVuZChlbGVtZW50KTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgbGVhdmU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IG5hdlZpZXdFbGVtZW50LmNvbnRlbnRzKCk7CgogICAgICAgICAgICAgICAgICBpZihkb0FuaW1hdGlvbiAmJiBzaG91bGRBbmltYXRlKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gbGVhdmUgd2l0aCBhbiBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgICBzZXRBbmltYXRpb25DbGFzcygpOwoKICAgICAgICAgICAgICAgICAgICAkYW5pbWF0ZS5sZWF2ZShlbGVtZW50LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyBubyBhbmltYXRpb24KICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgICAgLy8gcmVnaXN0ZXIgYSBuZXcgdmlldwogICAgICAgICAgICAgICAgICByZWdpc3RlckRhdGEgPSBzZXJ2aWNlLnJlZ2lzdGVyKG5hdlZpZXdTY29wZSwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGRvQW5pbWF0aW9uID0gKGFuaW1hdGlvbkNsYXNzICE9PSBudWxsICYmIHJlZ2lzdGVyRGF0YS5uYXZEaXJlY3Rpb24gIT09IG51bGwpOwogICAgICAgICAgICAgICAgICByZXR1cm4gcmVnaXN0ZXJEYXRhOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9OwogICAgICAgICAgfSwKCiAgICAgICAgICBkaXNhYmxlUmVnaXN0ZXJCeVRhZ05hbWU6IGZ1bmN0aW9uKHRhZ05hbWUpIHsKICAgICAgICAgICAgLy8gbm90IGV2ZXJ5IGVsZW1lbnQgc2hvdWxkIGFuaW1hdGUgYmV0d2VlIHRyYW5zaXRpb25zCiAgICAgICAgICAgIC8vIEZvciBleGFtcGxlLCB0aGUgPGlvbi10YWJzPiBkaXJlY3RpdmUgc2hvdWxkIG5vdCBhbmltYXRlIHdoZW4gaXQgZW50ZXJzLAogICAgICAgICAgICAvLyBidXQgaW5zdGVhZCB0aGUgPGlvbi10YWJzPiBkaXJlY3R2ZSB3b3VsZCBqdXN0IHNob3csIGFuZCBpdHMgY2hpbGRyZW4KICAgICAgICAgICAgLy8gPGlvbi10YWI+IGRpcmVjdGl2ZXMgd291bGQgZG8gdGhlIGFuaW1hdGluZywgYnV0IDxpb24tdGFicz4gaXRzZWxmIGlzIG5vdCBhIHZpZXcKICAgICAgICAgICAgJHJvb3RTY29wZS4kdmlld0hpc3RvcnkuZGlzYWJsZWRSZWdpc3RyYWJsZVRhZ05hbWVzLnB1c2godGFnTmFtZS50b1VwcGVyQ2FzZSgpKTsKICAgICAgICAgIH0sCgogICAgICAgICAgaXNUYWdOYW1lUmVnaXN0cmFibGU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgLy8gY2hlY2sgaWYgdGhpcyBlbGVtZW50IGhhcyBhIHRhZ05hbWUgKGF0IGl0cyByb290LCBub3QgcmVjdXJzaXZlbHkpCiAgICAgICAgICAgIC8vIHRoYXQgc2hvdWxkbid0IGJlIGFuaW1hdGVkLCBsaWtlIDxpb24tdGFicz4gb3IgPGlvbi1zaWRlLW1lbnU+CiAgICAgICAgICAgIHZhciB4LCB5LCBkaXNhYmxlZFRhZ3MgPSAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5kaXNhYmxlZFJlZ2lzdHJhYmxlVGFnTmFtZXM7CiAgICAgICAgICAgIGZvcih4PTA7IHg8ZWxlbWVudC5sZW5ndGg7IHgrKykgewogICAgICAgICAgICAgIGlmKGVsZW1lbnRbeF0ubm9kZVR5cGUgIT09IDEpIGNvbnRpbnVlOwogICAgICAgICAgICAgIGZvcih5PTA7IHk8ZGlzYWJsZWRUYWdzLmxlbmd0aDsgeSsrKSB7CiAgICAgICAgICAgICAgICBpZihlbGVtZW50W3hdLnRhZ05hbWUgPT09IGRpc2FibGVkVGFnc1t5XSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSwKCiAgICAgICAgICBjbGVhckhpc3Rvcnk6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIKICAgICAgICAgICAgICBoaXN0b3JpZXMgPSAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5oaXN0b3JpZXMsCiAgICAgICAgICAgICAgY3VycmVudFZpZXcgPSAkcm9vdFNjb3BlLiR2aWV3SGlzdG9yeS5jdXJyZW50VmlldzsKCiAgICAgICAgICAgIGlmKGhpc3RvcmllcykgewogICAgICAgICAgICAgIGZvcih2YXIgaGlzdG9yeUlkIGluIGhpc3RvcmllcykgewoKICAgICAgICAgICAgICAgIGlmKGhpc3Rvcmllc1toaXN0b3J5SWRdLnN0YWNrKSB7CiAgICAgICAgICAgICAgICAgIGhpc3Rvcmllc1toaXN0b3J5SWRdLnN0YWNrID0gW107CiAgICAgICAgICAgICAgICAgIGhpc3Rvcmllc1toaXN0b3J5SWRdLmN1cnNvciA9IC0xOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmKGN1cnJlbnRWaWV3ICYmIGN1cnJlbnRWaWV3Lmhpc3RvcnlJZCA9PT0gaGlzdG9yeUlkKSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3LmJhY2tWaWV3SWQgPSBudWxsOwogICAgICAgICAgICAgICAgICBjdXJyZW50Vmlldy5mb3J3YXJkVmlld0lkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgaGlzdG9yaWVzW2hpc3RvcnlJZF0uc3RhY2sucHVzaChjdXJyZW50Vmlldyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYoaGlzdG9yaWVzW2hpc3RvcnlJZF0uZGVzdHJveSkgewogICAgICAgICAgICAgICAgICBoaXN0b3JpZXNbaGlzdG9yeUlkXS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yKHZhciB2aWV3SWQgaW4gJHJvb3RTY29wZS4kdmlld0hpc3Rvcnkudmlld3MpIHsKICAgICAgICAgICAgICBpZih2aWV3SWQgIT09IGN1cnJlbnRWaWV3LnZpZXdJZCkgewogICAgICAgICAgICAgICAgZGVsZXRlICRyb290U2NvcGUuJHZpZXdIaXN0b3J5LnZpZXdzW3ZpZXdJZF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZihjdXJyZW50VmlldykgewogICAgICAgICAgICAgIHRoaXMuc2V0TmF2Vmlld3MoY3VycmVudFZpZXcudmlld0lkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICB9OwoKICAgICAgfV0pOwoKICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIElvbmljTW9kdWxlLmNvbmZpZyhbCiAgICAnJHByb3ZpZGUnLAogICAgZnVuY3Rpb24oJHByb3ZpZGUpIHsKICAgICAgZnVuY3Rpb24gJExvY2F0aW9uRGVjb3JhdG9yKCRsb2NhdGlvbiwgJHRpbWVvdXQpIHsKCiAgICAgICAgJGxvY2F0aW9uLl9faGFzaCA9ICRsb2NhdGlvbi5oYXNoOwogICAgICAgIC8vRml4OiB3aGVuIHdpbmRvdy5sb2NhdGlvbi5oYXNoIGlzIHNldCwgdGhlIHNjcm9sbGFibGUgYXJlYQogICAgICAgIC8vZm91bmQgbmVhcmVzdCB0byBib2R5J3Mgc2Nyb2xsVG9wIGlzIHNldCB0byBzY3JvbGwgdG8gYW4gZWxlbWVudAogICAgICAgIC8vd2l0aCB0aGF0IElELgogICAgICAgICRsb2NhdGlvbi5oYXNoID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmIChhbmd1bGFyLmlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIHNjcm9sbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zY3JvbGwtY29udGVudCcpOwogICAgICAgICAgICAgIGlmIChzY3JvbGwpCiAgICAgICAgICAgICAgICBzY3JvbGwuc2Nyb2xsVG9wID0gMDsKICAgICAgICAgICAgfSwgMCwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICRsb2NhdGlvbi5fX2hhc2godmFsdWUpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiAkbG9jYXRpb247CiAgICAgIH0KCiAgICAgICRwcm92aWRlLmRlY29yYXRvcignJGxvY2F0aW9uJywgWyckZGVsZWdhdGUnLCAnJHRpbWVvdXQnLCAkTG9jYXRpb25EZWNvcmF0b3JdKTsKICAgIH1dKTsKCgogIC8qKgogICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICogQG5hbWUgJGlvbmljTGlzdERlbGVnYXRlCiAgICogQG1vZHVsZSBpb25pYwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogRGVsZWdhdGUgZm9yIGNvbnRyb2xsaW5nIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3R9IGRpcmVjdGl2ZS4KICAgKgogICAqIE1ldGhvZHMgY2FsbGVkIGRpcmVjdGx5IG9uIHRoZSAkaW9uaWNMaXN0RGVsZWdhdGUgc2VydmljZSB3aWxsIGNvbnRyb2wgYWxsIGxpc3RzLgogICAqIFVzZSB0aGUge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljTGlzdERlbGVnYXRlIyRnZXRCeUhhbmRsZSAkZ2V0QnlIYW5kbGV9CiAgICogbWV0aG9kIHRvIGNvbnRyb2wgc3BlY2lmaWMgaW9uTGlzdCBpbnN0YW5jZXMuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIGBgYGBodG1sCiAgICogPGlvbi1jb250ZW50IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+CiAgICogICA8YnV0dG9uIGNsYXNzPSJidXR0b24iIG5nLWNsaWNrPSJzaG93RGVsZXRlQnV0dG9ucygpIj48L2J1dHRvbj4KICAgKiAgIDxpb24tbGlzdD4KICAgKiAgICAgPGlvbi1pdGVtIG5nLXJlcGVhdD0iaSBpbiBpdGVtcyI+PgogICAqICAgICAgIHslIHJhdyAlfUhlbGxvLCB7e2l9fSF7JSBlbmRyYXcgJX0KICAgKiAgICAgICA8aW9uLWRlbGV0ZS1idXR0b24gY2xhc3M9Imlvbi1taW51cy1jaXJjbGVkIj48L2lvbi1kZWxldGUtYnV0dG9uPgogICAqICAgICA8L2lvbi1pdGVtPgogICAqICAgPC9pb24tbGlzdD4KICAgKiA8L2lvbi1jb250ZW50PgogICAqIGBgYAogICAqIGBgYGpzCiAgICogZnVuY3Rpb24gTXlDdHJsKCRzY29wZSwgJGlvbmljTGlzdERlbGVnYXRlKSB7CiAqICAgJHNjb3BlLnNob3dEZWxldGVCdXR0b25zID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNMaXN0RGVsZWdhdGUuc2hvd0RlbGV0ZSh0cnVlKTsKICogICB9OwogKiB9CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5zZXJ2aWNlKCckaW9uaWNMaXN0RGVsZWdhdGUnLCBkZWxlZ2F0ZVNlcnZpY2UoWwogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNMaXN0RGVsZWdhdGUjc2hvd1Jlb3JkZXIKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3dSZW9yZGVyIFNldCB3aGV0aGVyIG9yIG5vdCB0aGlzIGxpc3QgaXMgc2hvd2luZyBpdHMgcmVvcmRlciBidXR0b25zLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdoZXRoZXIgdGhlIHJlb3JkZXIgYnV0dG9ucyBhcmUgc2hvd24uCiAgICAgKi8KICAgICAgJ3Nob3dSZW9yZGVyJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTGlzdERlbGVnYXRlI3Nob3dEZWxldGUKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3dSZW9yZGVyIFNldCB3aGV0aGVyIG9yIG5vdCB0aGlzIGxpc3QgaXMgc2hvd2luZyBpdHMgZGVsZXRlIGJ1dHRvbnMuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgZGVsZXRlIGJ1dHRvbnMgYXJlIHNob3duLgogICAgICovCiAgICAgICdzaG93RGVsZXRlJywKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGlvbmljTGlzdERlbGVnYXRlI2NhblN3aXBlSXRlbXMKICAgICAqIEBwYXJhbSB7Ym9vbGVhbj19IHNob3dSZW9yZGVyIFNldCB3aGV0aGVyIG9yIG5vdCB0aGlzIGxpc3QgaXMgYWJsZSB0byBzd2lwZSB0byBzaG93CiAgICAgKiBvcHRpb24gYnV0dG9ucy4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXaGV0aGVyIHRoZSBsaXN0IGlzIGFibGUgdG8gc3dpcGUgdG8gc2hvdyBvcHRpb24gYnV0dG9ucy4KICAgICAqLwogICAgICAnY2FuU3dpcGVJdGVtcycsCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRpb25pY0xpc3REZWxlZ2F0ZSNjbG9zZU9wdGlvbkJ1dHRvbnMKICAgICAqIEBkZXNjcmlwdGlvbiBDbG9zZXMgYW55IG9wdGlvbiBidXR0b25zIG9uIHRoZSBsaXN0IHRoYXQgYXJlIHN3aXBlZCBvcGVuLgogICAgICovCiAgICAgICdjbG9zZU9wdGlvbkJ1dHRvbnMnLAogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkaW9uaWNMaXN0RGVsZWdhdGUjJGdldEJ5SGFuZGxlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGFuZGxlCiAgICAgKiBAcmV0dXJucyBgZGVsZWdhdGVJbnN0YW5jZWAgQSBkZWxlZ2F0ZSBpbnN0YW5jZSB0aGF0IGNvbnRyb2xzIG9ubHkgdGhlCiAgICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3R9IGRpcmVjdGl2ZXMgd2l0aCBgZGVsZWdhdGUtaGFuZGxlYCBtYXRjaGluZwogICAgICogdGhlIGdpdmVuIGhhbmRsZS4KICAgICAqCiAgICAgKiBFeGFtcGxlOiBgJGlvbmljTGlzdERlbGVnYXRlLiRnZXRCeUhhbmRsZSgnbXktaGFuZGxlJykuc2hvd1Jlb3JkZXIodHJ1ZSk7YAogICAgICovCiAgICBdKSkKCiAgICAuY29udHJvbGxlcignJGlvbmljTGlzdCcsIFsKICAgICAgJyRzY29wZScsCiAgICAgICckYXR0cnMnLAogICAgICAnJHBhcnNlJywKICAgICAgJyRpb25pY0xpc3REZWxlZ2F0ZScsCiAgICAgIGZ1bmN0aW9uKCRzY29wZSwgJGF0dHJzLCAkcGFyc2UsICRpb25pY0xpc3REZWxlZ2F0ZSkgewoKICAgICAgICB2YXIgaXNTd2lwZWFibGUgPSB0cnVlOwogICAgICAgIHZhciBpc1Jlb3JkZXJTaG93biA9IGZhbHNlOwogICAgICAgIHZhciBpc0RlbGV0ZVNob3duID0gZmFsc2U7CgogICAgICAgIHZhciBkZXJlZ2lzdGVySW5zdGFuY2UgPSAkaW9uaWNMaXN0RGVsZWdhdGUuX3JlZ2lzdGVySW5zdGFuY2UodGhpcywgJGF0dHJzLmRlbGVnYXRlSGFuZGxlKTsKICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGRlcmVnaXN0ZXJJbnN0YW5jZSk7CgogICAgICAgIHRoaXMuc2hvd1Jlb3JkZXIgPSBmdW5jdGlvbihzaG93KSB7CiAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICBpc1Jlb3JkZXJTaG93biA9ICEhc2hvdzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpc1Jlb3JkZXJTaG93bjsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnNob3dEZWxldGUgPSBmdW5jdGlvbihzaG93KSB7CiAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICBpc0RlbGV0ZVNob3duID0gISFzaG93OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGlzRGVsZXRlU2hvd247CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5jYW5Td2lwZUl0ZW1zID0gZnVuY3Rpb24oY2FuKSB7CiAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICBpc1N3aXBlYWJsZSA9ICEhY2FuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGlzU3dpcGVhYmxlOwogICAgICAgIH07CgogICAgICAgIHRoaXMuY2xvc2VPcHRpb25CdXR0b25zID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLmxpc3RWaWV3ICYmIHRoaXMubGlzdFZpZXcuY2xlYXJEcmFnRWZmZWN0cygpOwogICAgICAgIH07CiAgICAgIH1dKTsKCiAgSW9uaWNNb2R1bGUKICAgIC5jb250cm9sbGVyKCckaW9uaWNOYXZCYXInLCBbCiAgICAgICckc2NvcGUnLAogICAgICAnJGVsZW1lbnQnLAogICAgICAnJGF0dHJzJywKICAgICAgJyRpb25pY1ZpZXdTZXJ2aWNlJywKICAgICAgJyRhbmltYXRlJywKICAgICAgJyRjb21waWxlJywKICAgICAgJyRpb25pY05hdkJhckRlbGVnYXRlJywKICAgICAgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzLCAkaW9uaWNWaWV3U2VydmljZSwgJGFuaW1hdGUsICRjb21waWxlLCAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSkgewogICAgICAgIC8vTGV0IHRoZSBwYXJlbnQga25vdyBhYm91dCBvdXIgY29udHJvbGxlciB0b28gc28gdGhhdCBjaGlsZHJlbiBvZgogICAgICAgIC8vc2libGluZyBjb250ZW50IGVsZW1lbnRzIGNhbiBrbm93IGFib3V0IHVzCiAgICAgICAgJGVsZW1lbnQucGFyZW50KCkuZGF0YSgnJGlvbk5hdkJhckNvbnRyb2xsZXInLCB0aGlzKTsKCiAgICAgICAgdmFyIGRlcmVnaXN0ZXJJbnN0YW5jZSA9ICRpb25pY05hdkJhckRlbGVnYXRlLl9yZWdpc3Rlckluc3RhbmNlKHRoaXMsICRhdHRycy5kZWxlZ2F0ZUhhbmRsZSk7CgogICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZGVyZWdpc3Rlckluc3RhbmNlKTsKCiAgICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgICB0aGlzLmxlZnRCdXR0b25zRWxlbWVudCA9IGpxTGl0ZSgKICAgICAgICAgICRlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3IoJy5idXR0b25zLmxlZnQtYnV0dG9ucycpCiAgICAgICAgKTsKICAgICAgICB0aGlzLnJpZ2h0QnV0dG9uc0VsZW1lbnQgPSBqcUxpdGUoCiAgICAgICAgICAkZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yKCcuYnV0dG9ucy5yaWdodC1idXR0b25zJykKICAgICAgICApOwoKICAgICAgICB0aGlzLmJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBiYWNrVmlldyA9ICRpb25pY1ZpZXdTZXJ2aWNlLmdldEJhY2tWaWV3KCk7CiAgICAgICAgICBiYWNrVmlldyAmJiBiYWNrVmlldy5nbygpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CgogICAgICAgIHRoaXMuYWxpZ24gPSBmdW5jdGlvbihkaXJlY3Rpb24pIHsKICAgICAgICAgIHRoaXMuX2hlYWRlckJhclZpZXcuYWxpZ24oZGlyZWN0aW9uKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnNob3dCYWNrQnV0dG9uID0gZnVuY3Rpb24oc2hvdykgewogICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgJHNjb3BlLmJhY2tCdXR0b25TaG93biA9ICEhc2hvdzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAhISgkc2NvcGUuaGFzQmFja0J1dHRvbiAmJiAkc2NvcGUuYmFja0J1dHRvblNob3duKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnNob3dCYXIgPSBmdW5jdGlvbihzaG93KSB7CiAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgICAgICAkc2NvcGUuaXNJbnZpc2libGUgPSAhc2hvdzsKICAgICAgICAgICAgJHNjb3BlLiRwYXJlbnQuJGhhc0hlYWRlciA9ICEhc2hvdzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAhJHNjb3BlLmlzSW52aXNpYmxlOwogICAgICAgIH07CgogICAgICAgIHRoaXMuc2V0VGl0bGUgPSBmdW5jdGlvbih0aXRsZSkgewogICAgICAgICAgaWYgKCRzY29wZS50aXRsZSA9PT0gdGl0bGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgJHNjb3BlLm9sZFRpdGxlID0gJHNjb3BlLnRpdGxlOwogICAgICAgICAgJHNjb3BlLnRpdGxlID0gdGl0bGUgfHwgJyc7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5jaGFuZ2VUaXRsZSA9IGZ1bmN0aW9uKHRpdGxlLCBkaXJlY3Rpb24pIHsKICAgICAgICAgIGlmICgkc2NvcGUudGl0bGUgPT09IHRpdGxlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc2V0VGl0bGUodGl0bGUpOwogICAgICAgICAgJHNjb3BlLmlzUmV2ZXJzZSA9IGRpcmVjdGlvbiA9PSAnYmFjayc7CiAgICAgICAgICAkc2NvcGUuc2hvdWxkQW5pbWF0ZSA9ICEhZGlyZWN0aW9uOwoKICAgICAgICAgIGlmICghJHNjb3BlLnNob3VsZEFuaW1hdGUpIHsKICAgICAgICAgICAgLy9XZSdyZSBkb25lIQogICAgICAgICAgICB0aGlzLl9oZWFkZXJCYXJWaWV3LmFsaWduKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9hbmltYXRlVGl0bGVzKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmdldFRpdGxlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gJHNjb3BlLnRpdGxlIHx8ICcnOwogICAgICAgIH07CgogICAgICAgIHRoaXMuZ2V0UHJldmlvdXNUaXRsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuICRzY29wZS5vbGRUaXRsZSB8fCAnJzsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBFeHBvc2VkIGZvciB0ZXN0aW5nCiAgICAgICAgICovCiAgICAgICAgdGhpcy5fYW5pbWF0ZVRpdGxlcyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG9sZFRpdGxlRWwsIG5ld1RpdGxlRWwsIGN1cnJlbnRUaXRsZXM7CgogICAgICAgICAgLy9JZiB3ZSBoYXZlIGFueSB0aXRsZSByaWdodCBub3cKICAgICAgICAgIC8vKG9yIG1vcmUgdGhhbiBvbmUsIHRoZXkgY291bGQgYmUgdHJhbnNpdGlvbmluZyBvbiBzd2l0Y2gpLAogICAgICAgICAgLy9yZXBsYWNlIHRoZSBmaXJzdCBvbmUgd2l0aCBhbiBvbGRUaXRsZSBlbGVtZW50CiAgICAgICAgICBjdXJyZW50VGl0bGVzID0gJGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvckFsbCgnLnRpdGxlJyk7CiAgICAgICAgICBpZiAoY3VycmVudFRpdGxlcy5sZW5ndGgpIHsKICAgICAgICAgICAgb2xkVGl0bGVFbCA9ICRjb21waWxlKCc8aDEgY2xhc3M9InRpdGxlIiBuZy1iaW5kLWh0bWw9Im9sZFRpdGxlIj48L2gxPicpKCRzY29wZSk7CiAgICAgICAgICAgIGpxTGl0ZShjdXJyZW50VGl0bGVzWzBdKS5yZXBsYWNlV2l0aChvbGRUaXRsZUVsKTsKICAgICAgICAgIH0KICAgICAgICAgIC8vQ29tcGlsZSBuZXcgdGl0bGUKICAgICAgICAgIG5ld1RpdGxlRWwgPSAkY29tcGlsZSgnPGgxIGNsYXNzPSJ0aXRsZSBpbnZpc2libGUiIG5nLWJpbmQtaHRtbD0idGl0bGUiPjwvaDE+JykoJHNjb3BlKTsKCiAgICAgICAgICAvL0FuaW1hdGUgaW4gb24gbmV4dCBmcmFtZQogICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgb2xkVGl0bGVFbCAmJiAkYW5pbWF0ZS5sZWF2ZShqcUxpdGUob2xkVGl0bGVFbCkpOwoKICAgICAgICAgICAgdmFyIGluc2VydCA9IG9sZFRpdGxlRWwgJiYganFMaXRlKG9sZFRpdGxlRWwpIHx8IG51bGw7CiAgICAgICAgICAgICRhbmltYXRlLmVudGVyKG5ld1RpdGxlRWwsICRlbGVtZW50LCBpbnNlcnQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNlbGYuX2hlYWRlckJhclZpZXcuYWxpZ24oKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvL0NsZWFudXAgYW55IG9sZCB0aXRsZXMgbGVmdG92ZXIgKGJlc2lkZXMgdGhlIG9uZSB3ZSBhbHJlYWR5IGRpZCByZXBsYWNlV2l0aCBvbikKICAgICAgICAgICAgZm9yRWFjaChjdXJyZW50VGl0bGVzLCBmdW5jdGlvbihlbCkgewogICAgICAgICAgICAgIGlmIChlbCAmJiBlbC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAvL1VzZSAucmVtb3ZlKCkgdG8gY2xlYW51cCB0aGluZ3MgbGlrZSAuZGF0YSgpCiAgICAgICAgICAgICAgICBqcUxpdGUoZWwpLnJlbW92ZSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyRhcHBseSBzbyBiaW5kaW5ncyBmaXJlCiAgICAgICAgICAgICRzY29wZS4kZGlnZXN0KCk7CgogICAgICAgICAgICAvL1N0b3AgZmxpY2tlciBvZiBuZXcgdGl0bGUgb24gaW9zNwogICAgICAgICAgICBpb25pYy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgbmV3VGl0bGVFbFswXS5jbGFzc0xpc3QucmVtb3ZlKCdpbnZpc2libGUnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICB9XSk7CgoKICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogIElvbmljTW9kdWxlCgogICAgLmZhY3RvcnkoJyQkc2Nyb2xsVmFsdWVDYWNoZScsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4ge307CiAgICB9KQoKICAgIC5jb250cm9sbGVyKCckaW9uaWNTY3JvbGwnLCBbCiAgICAgICckc2NvcGUnLAogICAgICAnc2Nyb2xsVmlld09wdGlvbnMnLAogICAgICAnJHRpbWVvdXQnLAogICAgICAnJHdpbmRvdycsCiAgICAgICckJHNjcm9sbFZhbHVlQ2FjaGUnLAogICAgICAnJGxvY2F0aW9uJywKICAgICAgJyRyb290U2NvcGUnLAogICAgICAnJGRvY3VtZW50JywKICAgICAgJyRpb25pY1Njcm9sbERlbGVnYXRlJywKICAgICAgZnVuY3Rpb24oJHNjb3BlLCBzY3JvbGxWaWV3T3B0aW9ucywgJHRpbWVvdXQsICR3aW5kb3csICQkc2Nyb2xsVmFsdWVDYWNoZSwgJGxvY2F0aW9uLCAkcm9vdFNjb3BlLCAkZG9jdW1lbnQsICRpb25pY1Njcm9sbERlbGVnYXRlKSB7CgogICAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICAgdGhpcy5fc2Nyb2xsVmlld09wdGlvbnMgPSBzY3JvbGxWaWV3T3B0aW9uczsgLy9mb3IgdGVzdGluZwoKICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudCA9IHNjcm9sbFZpZXdPcHRpb25zLmVsOwogICAgICAgIHZhciAkZWxlbWVudCA9IHRoaXMuJGVsZW1lbnQgPSBqcUxpdGUoZWxlbWVudCk7CiAgICAgICAgdmFyIHNjcm9sbFZpZXcgPSB0aGlzLnNjcm9sbFZpZXcgPSBuZXcgaW9uaWMudmlld3MuU2Nyb2xsKHNjcm9sbFZpZXdPcHRpb25zKTsKCiAgICAgICAgLy9BdHRhY2ggc2VsZiB0byBlbGVtZW50IGFzIGEgY29udHJvbGxlciBzbyBvdGhlciBkaXJlY3RpdmVzIGNhbiByZXF1aXJlIHRoaXMgY29udHJvbGxlcgogICAgICAgIC8vdGhyb3VnaCBgcmVxdWlyZTogJyRpb25pY1Njcm9sbCcKICAgICAgICAvL0Fsc28gYXR0YWNoIHRvIHBhcmVudCBzbyB0aGF0IHNpYmxpbmcgZWxlbWVudHMgY2FuIHJlcXVpcmUgdGhpcwogICAgICAgICgkZWxlbWVudC5wYXJlbnQoKS5sZW5ndGggPyAkZWxlbWVudC5wYXJlbnQoKSA6ICRlbGVtZW50KQogICAgICAgICAgLmRhdGEoJyQkaW9uaWNTY3JvbGxDb250cm9sbGVyJywgdGhpcyk7CgogICAgICAgIHZhciBkZXJlZ2lzdGVySW5zdGFuY2UgPSAkaW9uaWNTY3JvbGxEZWxlZ2F0ZS5fcmVnaXN0ZXJJbnN0YW5jZSgKICAgICAgICAgIHRoaXMsIHNjcm9sbFZpZXdPcHRpb25zLmRlbGVnYXRlSGFuZGxlCiAgICAgICAgKTsKCiAgICAgICAgaWYgKCFhbmd1bGFyLmlzRGVmaW5lZChzY3JvbGxWaWV3T3B0aW9ucy5ib3VuY2luZykpIHsKICAgICAgICAgIGlvbmljLlBsYXRmb3JtLnJlYWR5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzY3JvbGxWaWV3Lm9wdGlvbnMuYm91bmNpbmcgPSB0cnVlOwoKICAgICAgICAgICAgaWYoaW9uaWMuUGxhdGZvcm0uaXNBbmRyb2lkKCkpIHsKICAgICAgICAgICAgICAvLyBObyBib3VuY2luZyBieSBkZWZhdWx0IG9uIEFuZHJvaWQKICAgICAgICAgICAgICBzY3JvbGxWaWV3Lm9wdGlvbnMuYm91bmNpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAvLyBGYXN0ZXIgc2Nyb2xsIGRlY2VsCiAgICAgICAgICAgICAgc2Nyb2xsVmlldy5vcHRpb25zLmRlY2VsZXJhdGlvbiA9IDAuOTU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgdmFyIHJlc2l6ZSA9IGFuZ3VsYXIuYmluZChzY3JvbGxWaWV3LCBzY3JvbGxWaWV3LnJlc2l6ZSk7CiAgICAgICAgaW9uaWMub24oJ3Jlc2l6ZScsIHJlc2l6ZSwgJHdpbmRvdyk7CgogICAgICAgIC8vIHNldCBieSByb290U2NvcGUgbGlzdGVuZXIgaWYgbmVlZGVkCiAgICAgICAgdmFyIGJhY2tMaXN0ZW5Eb25lID0gYW5ndWxhci5ub29wOwoKICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZGVyZWdpc3Rlckluc3RhbmNlKCk7CiAgICAgICAgICBzY3JvbGxWaWV3Ll9fcmVtb3ZlRXZlbnRIYW5kbGVycygpOwogICAgICAgICAgaW9uaWMub2ZmKCdyZXNpemUnLCByZXNpemUsICR3aW5kb3cpOwogICAgICAgICAgJHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCByZXNpemUpOwogICAgICAgICAgYmFja0xpc3RlbkRvbmUoKTsKICAgICAgICAgIGlmIChzZWxmLl9yZW1lbWJlclNjcm9sbElkKSB7CiAgICAgICAgICAgICQkc2Nyb2xsVmFsdWVDYWNoZVtzZWxmLl9yZW1lbWJlclNjcm9sbElkXSA9IHNjcm9sbFZpZXcuZ2V0VmFsdWVzKCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgICRlbGVtZW50Lm9uKCdzY3JvbGwnLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICB2YXIgZGV0YWlsID0gKGUub3JpZ2luYWxFdmVudCB8fCBlKS5kZXRhaWwgfHwge307CiAgICAgICAgICAkc2NvcGUuJG9uU2Nyb2xsICYmICRzY29wZS4kb25TY3JvbGwoewogICAgICAgICAgICBldmVudDogZSwKICAgICAgICAgICAgc2Nyb2xsVG9wOiBkZXRhaWwuc2Nyb2xsVG9wIHx8IDAsCiAgICAgICAgICAgIHNjcm9sbExlZnQ6IGRldGFpbC5zY3JvbGxMZWZ0IHx8IDAKICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICAkc2NvcGUuJG9uKCckdmlld0NvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbihlLCBoaXN0b3J5RGF0YSkgewogICAgICAgICAgLy9vbmx5IHRoZSB0b3AtbW9zdCBzY3JvbGwgYXJlYSB1bmRlciBhIHZpZXcgc2hvdWxkIHJlbWVtYmVyIHRoYXQgdmlldydzCiAgICAgICAgICAvL3Njcm9sbCBwb3NpdGlvbgogICAgICAgICAgaWYgKGUuZGVmYXVsdFByZXZlbnRlZCkgeyByZXR1cm47IH0KICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICB2YXIgdmlld0lkID0gaGlzdG9yeURhdGEgJiYgaGlzdG9yeURhdGEudmlld0lkIHx8ICRzY29wZS4kaGlzdG9yeUlkOwogICAgICAgICAgaWYgKHZpZXdJZCkgewogICAgICAgICAgICAkdGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzZWxmLnJlbWVtYmVyU2Nyb2xsUG9zaXRpb24odmlld0lkKTsKICAgICAgICAgICAgICBzZWxmLnNjcm9sbFRvUmVtZW1iZXJlZFBvc2l0aW9uKCk7CgogICAgICAgICAgICAgIGJhY2tMaXN0ZW5Eb25lID0gJHJvb3RTY29wZS4kb24oJyR2aWV3SGlzdG9yeS52aWV3QmFjaycsIGZ1bmN0aW9uKGUsIGZyb21WaWV3SWQsIHRvVmlld0lkKSB7CiAgICAgICAgICAgICAgICAvL1doZW4gZ29pbmcgYmFjayBmcm9tIHRoaXMgdmlldywgZm9yZ2V0IGl0cyBzYXZlZCBzY3JvbGwgcG9zaXRpb24KICAgICAgICAgICAgICAgIGlmICh2aWV3SWQgPT09IGZyb21WaWV3SWQpIHsKICAgICAgICAgICAgICAgICAgc2VsZi5mb3JnZXRTY3JvbGxQb3NpdGlvbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LCAwLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgc2Nyb2xsVmlldy5ydW4oKTsKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5fcmVtZW1iZXJTY3JvbGxJZCA9IG51bGw7CgogICAgICAgIHRoaXMuZ2V0U2Nyb2xsVmlldyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsVmlldzsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmdldFNjcm9sbFBvc2l0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zY3JvbGxWaWV3LmdldFZhbHVlcygpOwogICAgICAgIH07CgogICAgICAgIHRoaXMucmVzaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gJHRpbWVvdXQocmVzaXplKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnNjcm9sbFRvcCA9IGZ1bmN0aW9uKHNob3VsZEFuaW1hdGUpIHsKICAgICAgICAgIHRoaXMucmVzaXplKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2Nyb2xsVmlldy5zY3JvbGxUbygwLCAwLCAhIXNob3VsZEFuaW1hdGUpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5zY3JvbGxCb3R0b20gPSBmdW5jdGlvbihzaG91bGRBbmltYXRlKSB7CiAgICAgICAgICB0aGlzLnJlc2l6ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBtYXggPSBzY3JvbGxWaWV3LmdldFNjcm9sbE1heCgpOwogICAgICAgICAgICBzY3JvbGxWaWV3LnNjcm9sbFRvKG1heC5sZWZ0LCBtYXgudG9wLCAhIXNob3VsZEFuaW1hdGUpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5zY3JvbGxUbyA9IGZ1bmN0aW9uKGxlZnQsIHRvcCwgc2hvdWxkQW5pbWF0ZSkgewogICAgICAgICAgdGhpcy5yZXNpemUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBzY3JvbGxWaWV3LnNjcm9sbFRvKGxlZnQsIHRvcCwgISFzaG91bGRBbmltYXRlKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHRoaXMuc2Nyb2xsQnkgPSBmdW5jdGlvbihsZWZ0LCB0b3AsIHNob3VsZEFuaW1hdGUpIHsKICAgICAgICAgIHRoaXMucmVzaXplKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgc2Nyb2xsVmlldy5zY3JvbGxCeShsZWZ0LCB0b3AsICEhc2hvdWxkQW5pbWF0ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmFuY2hvclNjcm9sbCA9IGZ1bmN0aW9uKHNob3VsZEFuaW1hdGUpIHsKICAgICAgICAgIHRoaXMucmVzaXplKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGhhc2ggPSAkbG9jYXRpb24uaGFzaCgpOwogICAgICAgICAgICB2YXIgZWxtID0gaGFzaCAmJiAkZG9jdW1lbnRbMF0uZ2V0RWxlbWVudEJ5SWQoaGFzaCk7CiAgICAgICAgICAgIGlmICghKGhhc2ggJiYgZWxtKSkgewogICAgICAgICAgICAgIHNjcm9sbFZpZXcuc2Nyb2xsVG8oMCwwLCAhIXNob3VsZEFuaW1hdGUpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3VyRWxtID0gZWxtOwogICAgICAgICAgICB2YXIgc2Nyb2xsTGVmdCA9IDAsIHNjcm9sbFRvcCA9IDAsIGxldmVsc0NsaW1iZWQgPSAwOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYoY3VyRWxtICE9PSBudWxsKXNjcm9sbExlZnQgKz0gY3VyRWxtLm9mZnNldExlZnQ7CiAgICAgICAgICAgICAgaWYoY3VyRWxtICE9PSBudWxsKXNjcm9sbFRvcCArPSBjdXJFbG0ub2Zmc2V0VG9wOwogICAgICAgICAgICAgIGN1ckVsbSA9IGN1ckVsbS5vZmZzZXRQYXJlbnQ7CiAgICAgICAgICAgICAgbGV2ZWxzQ2xpbWJlZCsrOwogICAgICAgICAgICB9IHdoaWxlIChjdXJFbG0uYXR0cmlidXRlcyAhPSBzZWxmLmVsZW1lbnQuYXR0cmlidXRlcyAmJiBjdXJFbG0ub2Zmc2V0UGFyZW50KTsKICAgICAgICAgICAgc2Nyb2xsVmlldy5zY3JvbGxUbyhzY3JvbGxMZWZ0LCBzY3JvbGxUb3AsICEhc2hvdWxkQW5pbWF0ZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnJlbWVtYmVyU2Nyb2xsUG9zaXRpb24gPSBmdW5jdGlvbihpZCkgewogICAgICAgICAgaWYgKCFpZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk11c3Qgc3VwcGx5IGFuIGlkIHRvIHJlbWVtYmVyIHRoZSBzY3JvbGwgYnkhIik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9yZW1lbWJlclNjcm9sbElkID0gaWQ7CiAgICAgICAgfTsKICAgICAgICB0aGlzLmZvcmdldFNjcm9sbFBvc2l0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBkZWxldGUgJCRzY3JvbGxWYWx1ZUNhY2hlW3RoaXMuX3JlbWVtYmVyU2Nyb2xsSWRdOwogICAgICAgICAgdGhpcy5fcmVtZW1iZXJTY3JvbGxJZCA9IG51bGw7CiAgICAgICAgfTsKICAgICAgICB0aGlzLnNjcm9sbFRvUmVtZW1iZXJlZFBvc2l0aW9uID0gZnVuY3Rpb24oc2hvdWxkQW5pbWF0ZSkgewogICAgICAgICAgdmFyIHZhbHVlcyA9ICQkc2Nyb2xsVmFsdWVDYWNoZVt0aGlzLl9yZW1lbWJlclNjcm9sbElkXTsKICAgICAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICAgICAgdGhpcy5yZXNpemUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNjcm9sbFZpZXcuc2Nyb2xsVG8oK3ZhbHVlcy5sZWZ0LCArdmFsdWVzLnRvcCwgc2hvdWxkQW5pbWF0ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICovCiAgICAgICAgdGhpcy5fc2V0UmVmcmVzaGVyID0gZnVuY3Rpb24ocmVmcmVzaGVyU2NvcGUsIHJlZnJlc2hlckVsZW1lbnQpIHsKICAgICAgICAgIHZhciByZWZyZXNoZXIgPSB0aGlzLnJlZnJlc2hlciA9IHJlZnJlc2hlckVsZW1lbnQ7CiAgICAgICAgICB2YXIgcmVmcmVzaGVySGVpZ2h0ID0gc2VsZi5yZWZyZXNoZXIuY2xpZW50SGVpZ2h0IHx8IDA7CiAgICAgICAgICBzY3JvbGxWaWV3LmFjdGl2YXRlUHVsbFRvUmVmcmVzaChyZWZyZXNoZXJIZWlnaHQsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZWZyZXNoZXIuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgIHJlZnJlc2hlclNjb3BlLiRvblB1bGxpbmcoKTsKICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZWZyZXNoZXIuY2xhc3NMaXN0LnJlbW92ZSgncmVmcmVzaGluZycpOwogICAgICAgICAgICByZWZyZXNoZXIuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmVmcmVzaGVyLmNsYXNzTGlzdC5hZGQoJ3JlZnJlc2hpbmcnKTsKICAgICAgICAgICAgcmVmcmVzaGVyU2NvcGUuJG9uUmVmcmVzaCgpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgfV0pOwoKCiAgSW9uaWNNb2R1bGUKICAgIC5jb250cm9sbGVyKCckaW9uaWNTaWRlTWVudXMnLCBbCiAgICAgICckc2NvcGUnLAogICAgICAnJGF0dHJzJywKICAgICAgJyRpb25pY1NpZGVNZW51RGVsZWdhdGUnLAogICAgICAnJGlvbmljUGxhdGZvcm0nLAogICAgICBmdW5jdGlvbigkc2NvcGUsICRhdHRycywgJGlvbmljU2lkZU1lbnVEZWxlZ2F0ZSwgJGlvbmljUGxhdGZvcm0pIHsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgZXh0ZW5kKHRoaXMsIGlvbmljLmNvbnRyb2xsZXJzLlNpZGVNZW51Q29udHJvbGxlci5wcm90b3R5cGUpOwoKICAgICAgICB0aGlzLiRzY29wZSA9ICRzY29wZTsKCiAgICAgICAgaW9uaWMuY29udHJvbGxlcnMuU2lkZU1lbnVDb250cm9sbGVyLmNhbGwodGhpcywgewogICAgICAgICAgbGVmdDogeyB3aWR0aDogMjc1IH0sCiAgICAgICAgICByaWdodDogeyB3aWR0aDogMjc1IH0KICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5jYW5EcmFnQ29udGVudCA9IGZ1bmN0aW9uKGNhbkRyYWcpIHsKICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICRzY29wZS5kcmFnQ29udGVudCA9ICEhY2FuRHJhZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAkc2NvcGUuZHJhZ0NvbnRlbnQ7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5lZGdlVGhyZXNob2xkID0gMjU7CiAgICAgICAgdGhpcy5lZGdlVGhyZXNob2xkRW5hYmxlZCA9IGZhbHNlOwogICAgICAgIHRoaXMuZWRnZURyYWdUaHJlc2hvbGQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNOdW1iZXIodmFsdWUpICYmIHZhbHVlID4gMCkgewogICAgICAgICAgICAgIHRoaXMuZWRnZVRocmVzaG9sZCA9IHZhbHVlOwogICAgICAgICAgICAgIHRoaXMuZWRnZVRocmVzaG9sZEVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMuZWRnZVRocmVzaG9sZEVuYWJsZWQgPSAhIXZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpcy5lZGdlVGhyZXNob2xkRW5hYmxlZDsKICAgICAgICB9OwoKICAgICAgICB0aGlzLmlzRHJhZ2dhYmxlVGFyZ2V0ID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgLy9Pbmx5IHJlc3RyaWN0IGVkZ2Ugd2hlbiBzaWRlbWVudSBpcyBjbG9zZWQgYW5kIHJlc3RyaWN0aW9uIGlzIGVuYWJsZWQKICAgICAgICAgIHZhciBzaG91bGRPbmx5QWxsb3dFZGdlRHJhZyA9IHNlbGYuZWRnZVRocmVzaG9sZEVuYWJsZWQgJiYgIXNlbGYuaXNPcGVuKCk7CiAgICAgICAgICB2YXIgc3RhcnRYID0gZS5nZXN0dXJlLnN0YXJ0RXZlbnQgJiYgZS5nZXN0dXJlLnN0YXJ0RXZlbnQuY2VudGVyICYmCiAgICAgICAgICAgIGUuZ2VzdHVyZS5zdGFydEV2ZW50LmNlbnRlci5wYWdlWDsKCiAgICAgICAgICB2YXIgZHJhZ0lzV2l0aGluQm91bmRzID0gIXNob3VsZE9ubHlBbGxvd0VkZ2VEcmFnIHx8CiAgICAgICAgICAgIHN0YXJ0WCA8PSBzZWxmLmVkZ2VUaHJlc2hvbGQgfHwKICAgICAgICAgICAgc3RhcnRYID49IHNlbGYuY29udGVudC5vZmZzZXRXaWR0aCAtIHNlbGYuZWRnZVRocmVzaG9sZDsKCiAgICAgICAgICByZXR1cm4gKCRzY29wZS5kcmFnQ29udGVudCB8fCBzZWxmLmlzT3BlbigpKSAmJgogICAgICAgICAgICBkcmFnSXNXaXRoaW5Cb3VuZHMgJiYKICAgICAgICAgICAgIWUuZ2VzdHVyZS5zcmNFdmVudC5kZWZhdWx0UHJldmVudGVkICYmCiAgICAgICAgICAgICFlLnRhcmdldC50YWdOYW1lLm1hdGNoKC9pbnB1dHx0ZXh0YXJlYXxzZWxlY3R8b2JqZWN0fGVtYmVkL2kpICYmCiAgICAgICAgICAgICFlLnRhcmdldC5pc0NvbnRlbnRFZGl0YWJsZSAmJgogICAgICAgICAgICAhKGUudGFyZ2V0LmRhdGFzZXQgPyBlLnRhcmdldC5kYXRhc2V0LnByZXZlbnRTY3JvbGwgOiBlLnRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtcHJldmVudC1kZWZhdWx0JykgPT0gJ3RydWUnKTsKICAgICAgICB9OwoKICAgICAgICAkc2NvcGUuc2lkZU1lbnVDb250ZW50VHJhbnNsYXRlWCA9IDA7CgoKICAgICAgICB2YXIgZGVyZWdpc3RlckJhY2tCdXR0b25BY3Rpb24gPSBhbmd1bGFyLm5vb3A7CiAgICAgICAgdmFyIGNsb3NlU2lkZU1lbnUgPSBhbmd1bGFyLmJpbmQodGhpcywgdGhpcy5jbG9zZSk7CiAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBzZWxmLmdldE9wZW5BbW91bnQoKSAhPT0gMDsKICAgICAgICB9LCBmdW5jdGlvbihpc09wZW4pIHsKICAgICAgICAgIGRlcmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uKCk7CiAgICAgICAgICBpZiAoaXNPcGVuKSB7CiAgICAgICAgICAgIGRlcmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uID0gJGlvbmljUGxhdGZvcm0ucmVnaXN0ZXJCYWNrQnV0dG9uQWN0aW9uKAogICAgICAgICAgICAgIGNsb3NlU2lkZU1lbnUsCiAgICAgICAgICAgICAgUExBVEZPUk1fQkFDS19CVVRUT05fUFJJT1JJVFlfU0lERV9NRU5VCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIHZhciBkZXJlZ2lzdGVySW5zdGFuY2UgPSAkaW9uaWNTaWRlTWVudURlbGVnYXRlLl9yZWdpc3Rlckluc3RhbmNlKAogICAgICAgICAgdGhpcywgJGF0dHJzLmRlbGVnYXRlSGFuZGxlCiAgICAgICAgKTsKICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgZGVyZWdpc3Rlckluc3RhbmNlKCk7CiAgICAgICAgICBkZXJlZ2lzdGVyQmFja0J1dHRvbkFjdGlvbigpOwogICAgICAgIH0pOwogICAgICB9XSk7CgogIElvbmljTW9kdWxlCiAgICAuY29udHJvbGxlcignJGlvbmljVGFiJywgWwogICAgICAnJHNjb3BlJywKICAgICAgJyRpb25pY1ZpZXdTZXJ2aWNlJywKICAgICAgJyRhdHRycycsCiAgICAgICckbG9jYXRpb24nLAogICAgICAnJHN0YXRlJywKICAgICAgZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNWaWV3U2VydmljZSwgJGF0dHJzLCAkbG9jYXRpb24sICRzdGF0ZSkgewogICAgICAgIHRoaXMuJHNjb3BlID0gJHNjb3BlOwoKICAgICAgICAvL0FsbCBvZiB0aGVzZSBleHBvc2VkIGZvciB0ZXN0aW5nCiAgICAgICAgdGhpcy5ocmVmTWF0Y2hlc1N0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gJGF0dHJzLmhyZWYgJiYgJGxvY2F0aW9uLnBhdGgoKS5pbmRleE9mKAogICAgICAgICAgICAkYXR0cnMuaHJlZi5yZXBsYWNlKC9eIy8sICcnKS5yZXBsYWNlKC9cLyQvLCAnJykKICAgICAgICAgICkgPT09IDA7CiAgICAgICAgfTsKICAgICAgICB0aGlzLnNyZWZNYXRjaGVzU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiAkYXR0cnMudWlTcmVmICYmICRzdGF0ZS5pbmNsdWRlcyggJGF0dHJzLnVpU3JlZi5zcGxpdCgnKCcpWzBdICk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLm5hdk5hbWVNYXRjaGVzU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm5hdlZpZXdOYW1lICYmICRpb25pY1ZpZXdTZXJ2aWNlLmlzQ3VycmVudFN0YXRlTmF2Vmlldyh0aGlzLm5hdlZpZXdOYW1lKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnRhYk1hdGNoZXNTdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuaHJlZk1hdGNoZXNTdGF0ZSgpIHx8IHRoaXMuc3JlZk1hdGNoZXNTdGF0ZSgpIHx8IHRoaXMubmF2TmFtZU1hdGNoZXNTdGF0ZSgpOwogICAgICAgIH07CiAgICAgIH1dKTsKCiAgSW9uaWNNb2R1bGUKICAgIC5jb250cm9sbGVyKCckaW9uaWNUYWJzJywgWwogICAgICAnJHNjb3BlJywKICAgICAgJyRpb25pY1ZpZXdTZXJ2aWNlJywKICAgICAgJyRlbGVtZW50JywKICAgICAgZnVuY3Rpb24oJHNjb3BlLCAkaW9uaWNWaWV3U2VydmljZSwgJGVsZW1lbnQpIHsKICAgICAgICB2YXIgX3NlbGVjdGVkVGFiID0gbnVsbDsKICAgICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgICAgc2VsZi50YWJzID0gW107CgogICAgICAgIHNlbGYuc2VsZWN0ZWRJbmRleCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHNlbGYudGFicy5pbmRleE9mKF9zZWxlY3RlZFRhYik7CiAgICAgICAgfTsKICAgICAgICBzZWxmLnNlbGVjdGVkVGFiID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gX3NlbGVjdGVkVGFiOwogICAgICAgIH07CgogICAgICAgIHNlbGYuYWRkID0gZnVuY3Rpb24odGFiKSB7CiAgICAgICAgICAkaW9uaWNWaWV3U2VydmljZS5yZWdpc3Rlckhpc3RvcnkodGFiKTsKICAgICAgICAgIHNlbGYudGFicy5wdXNoKHRhYik7CiAgICAgICAgICBpZihzZWxmLnRhYnMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHNlbGYuc2VsZWN0KHRhYik7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgc2VsZi5yZW1vdmUgPSBmdW5jdGlvbih0YWIpIHsKICAgICAgICAgIHZhciB0YWJJbmRleCA9IHNlbGYudGFicy5pbmRleE9mKHRhYik7CiAgICAgICAgICBpZiAodGFiSW5kZXggPT09IC0xKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIC8vVXNlIGEgZmllbGQgbGlrZSAnJHRhYlNlbGVjdGVkJyBzbyBkZXZlbG9wZXJzIHdvbid0IGFjY2lkZW50YWxseSBzZXQgaXQgaW4gY29udHJvbGxlcnMgZXRjCiAgICAgICAgICBpZiAodGFiLiR0YWJTZWxlY3RlZCkgewogICAgICAgICAgICBzZWxmLmRlc2VsZWN0KHRhYik7CiAgICAgICAgICAgIC8vVHJ5IHRvIHNlbGVjdCBhIG5ldyB0YWIgaWYgd2UncmUgcmVtb3ZpbmcgYSB0YWIKICAgICAgICAgICAgaWYgKHNlbGYudGFicy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAvL2RvIG5vdGhpbmcgaWYgdGhlcmUgYXJlIG5vIG90aGVyIHRhYnMgdG8gc2VsZWN0CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy9TZWxlY3QgcHJldmlvdXMgdGFiIGlmIGl0J3MgdGhlIGxhc3QgdGFiLCBlbHNlIHNlbGVjdCBuZXh0IHRhYgogICAgICAgICAgICAgIHZhciBuZXdUYWJJbmRleCA9IHRhYkluZGV4ID09PSBzZWxmLnRhYnMubGVuZ3RoIC0gMSA/IHRhYkluZGV4IC0gMSA6IHRhYkluZGV4ICsgMTsKICAgICAgICAgICAgICBzZWxmLnNlbGVjdChzZWxmLnRhYnNbbmV3VGFiSW5kZXhdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc2VsZi50YWJzLnNwbGljZSh0YWJJbmRleCwgMSk7CiAgICAgICAgfTsKCiAgICAgICAgc2VsZi5kZXNlbGVjdCA9IGZ1bmN0aW9uKHRhYikgewogICAgICAgICAgaWYgKHRhYi4kdGFiU2VsZWN0ZWQpIHsKICAgICAgICAgICAgX3NlbGVjdGVkVGFiID0gbnVsbDsKICAgICAgICAgICAgdGFiLiR0YWJTZWxlY3RlZCA9IGZhbHNlOwogICAgICAgICAgICAodGFiLm9uRGVzZWxlY3QgfHwgYW5ndWxhci5ub29wKSgpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHNlbGYuc2VsZWN0ID0gZnVuY3Rpb24odGFiLCBzaG91bGRFbWl0RXZlbnQpIHsKICAgICAgICAgIHZhciB0YWJJbmRleDsKICAgICAgICAgIGlmIChhbmd1bGFyLmlzTnVtYmVyKHRhYikpIHsKICAgICAgICAgICAgdGFiSW5kZXggPSB0YWI7CiAgICAgICAgICAgIHRhYiA9IHNlbGYudGFic1t0YWJJbmRleF07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0YWJJbmRleCA9IHNlbGYudGFicy5pbmRleE9mKHRhYik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXRhYiB8fCB0YWJJbmRleCA9PSAtMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzZWxlY3QgdGFiICInICsgdGFiSW5kZXggKyAnIiEnKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoX3NlbGVjdGVkVGFiICYmIF9zZWxlY3RlZFRhYi4kaGlzdG9yeUlkID09IHRhYi4kaGlzdG9yeUlkKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRFbWl0RXZlbnQpIHsKICAgICAgICAgICAgICAkaW9uaWNWaWV3U2VydmljZS5nb1RvSGlzdG9yeVJvb3QodGFiLiRoaXN0b3J5SWQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3JFYWNoKHNlbGYudGFicywgZnVuY3Rpb24odGFiKSB7CiAgICAgICAgICAgICAgc2VsZi5kZXNlbGVjdCh0YWIpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIF9zZWxlY3RlZFRhYiA9IHRhYjsKICAgICAgICAgICAgLy9Vc2UgYSBmdW5ueSBuYW1lIGxpa2UgJHRhYlNlbGVjdGVkIHNvIHRoZSBkZXZlbG9wZXIgZG9lc24ndCBvdmVyd3JpdGUgdGhlIHZhciBpbiBhIGNoaWxkIHNjb3BlCiAgICAgICAgICAgIHRhYi4kdGFiU2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAodGFiLm9uU2VsZWN0IHx8IGFuZ3VsYXIubm9vcCkoKTsKCiAgICAgICAgICAgIGlmIChzaG91bGRFbWl0RXZlbnQpIHsKICAgICAgICAgICAgICB2YXIgdmlld0RhdGEgPSB7CiAgICAgICAgICAgICAgICB0eXBlOiAndGFiJywKICAgICAgICAgICAgICAgIHRhYkluZGV4OiB0YWJJbmRleCwKICAgICAgICAgICAgICAgIGhpc3RvcnlJZDogdGFiLiRoaXN0b3J5SWQsCiAgICAgICAgICAgICAgICBuYXZWaWV3TmFtZTogdGFiLm5hdlZpZXdOYW1lLAogICAgICAgICAgICAgICAgaGFzTmF2VmlldzogISF0YWIubmF2Vmlld05hbWUsCiAgICAgICAgICAgICAgICB0aXRsZTogdGFiLnRpdGxlLAogICAgICAgICAgICAgICAgLy9Ta2lwIHRoZSBmaXJzdCBjaGFyYWN0ZXIgb2YgaHJlZiBpZiBpdCdzICMKICAgICAgICAgICAgICAgIHVybDogdGFiLmhyZWYsCiAgICAgICAgICAgICAgICB1aVNyZWY6IHRhYi51aVNyZWYKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICRzY29wZS4kZW1pdCgndmlld1N0YXRlLmNoYW5nZUhpc3RvcnknLCB2aWV3RGF0YSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XSk7CgoKICAvKgogICAqIFdlIGRvbid0IGRvY3VtZW50IHRoZSBpb25BY3Rpb25TaGVldCBkaXJlY3RpdmUsIHdlIGluc3RlYWQgZG9jdW1lbnQKICAgKiB0aGUgJGlvbmljQWN0aW9uU2hlZXQgc2VydmljZQogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25BY3Rpb25TaGVldCcsIFsnJGRvY3VtZW50JywgZnVuY3Rpb24oJGRvY3VtZW50KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICBzY29wZTogdHJ1ZSwKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQpewogICAgICAgICAgdmFyIGtleVVwID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICBpZihlLndoaWNoID09IDI3KSB7CiAgICAgICAgICAgICAgJHNjb3BlLmNhbmNlbCgpOwogICAgICAgICAgICAgICRzY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICB2YXIgYmFja2Ryb3BDbGljayA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgaWYoZS50YXJnZXQgPT0gJGVsZW1lbnRbMF0pIHsKICAgICAgICAgICAgICAkc2NvcGUuY2FuY2VsKCk7CiAgICAgICAgICAgICAgJHNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgJGVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICRkb2N1bWVudC51bmJpbmQoJ2tleXVwJywga2V5VXApOwogICAgICAgICAgfSk7CgogICAgICAgICAgJGRvY3VtZW50LmJpbmQoJ2tleXVwJywga2V5VXApOwogICAgICAgICAgJGVsZW1lbnQuYmluZCgnY2xpY2snLCBiYWNrZHJvcENsaWNrKTsKICAgICAgICB9LAogICAgICAgIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0iYWN0aW9uLXNoZWV0LWJhY2tkcm9wIj4nICsKICAgICAgICAgICc8ZGl2IGNsYXNzPSJhY3Rpb24tc2hlZXQtd3JhcHBlciI+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0iYWN0aW9uLXNoZWV0Ij4nICsKICAgICAgICAgICc8ZGl2IGNsYXNzPSJhY3Rpb24tc2hlZXQtZ3JvdXAiPicgKwogICAgICAgICAgJzxkaXYgY2xhc3M9ImFjdGlvbi1zaGVldC10aXRsZSIgbmctaWY9InRpdGxlVGV4dCIgbmctYmluZC1odG1sPSJ0aXRsZVRleHQiPjwvZGl2PicgKwogICAgICAgICAgJzxidXR0b24gY2xhc3M9ImJ1dHRvbiIgbmctY2xpY2s9ImJ1dHRvbkNsaWNrZWQoJGluZGV4KSIgbmctcmVwZWF0PSJidXR0b24gaW4gYnV0dG9ucyIgbmctYmluZC1odG1sPSJidXR0b24udGV4dCI+PC9idXR0b24+JyArCiAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0iYWN0aW9uLXNoZWV0LWdyb3VwIiBuZy1pZj0iZGVzdHJ1Y3RpdmVUZXh0Ij4nICsKICAgICAgICAgICc8YnV0dG9uIGNsYXNzPSJidXR0b24gZGVzdHJ1Y3RpdmUiIG5nLWNsaWNrPSJkZXN0cnVjdGl2ZUJ1dHRvbkNsaWNrZWQoKSIgbmctYmluZC1odG1sPSJkZXN0cnVjdGl2ZVRleHQiPjwvYnV0dG9uPicgKwogICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgJzxkaXYgY2xhc3M9ImFjdGlvbi1zaGVldC1ncm91cCIgbmctaWY9ImNhbmNlbFRleHQiPicgKwogICAgICAgICAgJzxidXR0b24gY2xhc3M9ImJ1dHRvbiIgbmctY2xpY2s9ImNhbmNlbCgpIiBuZy1iaW5kLWh0bWw9ImNhbmNlbFRleHQiPjwvYnV0dG9uPicgKwogICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgJzwvZGl2PicKICAgICAgfTsKICAgIH1dKTsKCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25DaGVja2JveAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgRQogICAqIEBjb2RlcGVuIGhxY2p1CiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGNoZWNrYm94IGlzIG5vIGRpZmZlcmVudCB0aGFuIHRoZSBIVE1MIGNoZWNrYm94IGlucHV0LCBleGNlcHQgaXQncyBzdHlsZWQgZGlmZmVyZW50bHkuCiAgICoKICAgKiBUaGUgY2hlY2tib3ggYmVoYXZlcyBsaWtlIGFueSBbQW5ndWxhckpTIGNoZWNrYm94XShodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy9pbnB1dC9pbnB1dFtjaGVja2JveF0pLgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxpb24tY2hlY2tib3ggbmctbW9kZWw9ImlzQ2hlY2tlZCI+Q2hlY2tib3ggTGFiZWw8L2lvbi1jaGVja2JveD4KICAgKiBgYGAKICAgKi8KCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvbkNoZWNrYm94JywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICB0ZW1wbGF0ZToKICAgICAgICAgICc8bGFiZWwgY2xhc3M9Iml0ZW0gaXRlbS1jaGVja2JveCI+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0iY2hlY2tib3ggY2hlY2tib3gtaW5wdXQtaGlkZGVuIGRpc2FibGUtcG9pbnRlci1ldmVudHMiPicgKwogICAgICAgICAgJzxpbnB1dCB0eXBlPSJjaGVja2JveCI+JyArCiAgICAgICAgICAnPGkgY2xhc3M9ImNoZWNrYm94LWljb24iPjwvaT4nICsKICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICc8ZGl2IGNsYXNzPSJpdGVtLWNvbnRlbnQgZGlzYWJsZS1wb2ludGVyLWV2ZW50cyIgbmctdHJhbnNjbHVkZT48L2Rpdj4nICsKICAgICAgICAgICc8L2xhYmVsPicsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICAgICAgdmFyIGlucHV0ID0gZWxlbWVudC5maW5kKCdpbnB1dCcpOwogICAgICAgICAgZm9yRWFjaCh7CiAgICAgICAgICAgICduYW1lJzogYXR0ci5uYW1lLAogICAgICAgICAgICAnbmctdmFsdWUnOiBhdHRyLm5nVmFsdWUsCiAgICAgICAgICAgICduZy1tb2RlbCc6IGF0dHIubmdNb2RlbCwKICAgICAgICAgICAgJ25nLWNoZWNrZWQnOiBhdHRyLm5nQ2hlY2tlZCwKICAgICAgICAgICAgJ25nLWRpc2FibGVkJzogYXR0ci5uZ0Rpc2FibGVkLAogICAgICAgICAgICAnbmctdHJ1ZS12YWx1ZSc6IGF0dHIubmdUcnVlVmFsdWUsCiAgICAgICAgICAgICduZy1mYWxzZS12YWx1ZSc6IGF0dHIubmdGYWxzZVZhbHVlLAogICAgICAgICAgICAnbmctY2hhbmdlJzogYXR0ci5uZ0NoYW5nZQogICAgICAgICAgfSwgZnVuY3Rpb24odmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCh2YWx1ZSkpIHsKICAgICAgICAgICAgICBpbnB1dC5hdHRyKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgfTsKICAgIH0pOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG1vZHVsZSBpb25pYwogICAqIEBuYW1lIGNvbGxlY3Rpb25SZXBlYXQKICAgKiBAcmVzdHJpY3QgQQogICAqIEBjb2RlcGVuIG1GeWdoCiAgICogQGRlc2NyaXB0aW9uCiAgICogYGNvbGxlY3Rpb24tcmVwZWF0YCBpcyBhIGRpcmVjdGl2ZSB0aGF0IGFsbG93cyB5b3UgdG8gcmVuZGVyIGxpc3RzIHdpdGgKICAgKiB0aG91c2FuZHMgb2YgaXRlbXMgaW4gdGhlbSwgYW5kIGV4cGVyaWVuY2UgbGl0dGxlIHRvIG5vIHBlcmZvcm1hbmNlIHBlbmFsdHkuCiAgICoKICAgKiBEZW1vOgogICAqCiAgICogVGhlIGRpcmVjdGl2ZSByZW5kZXJzIG9udG8gdGhlIHNjcmVlbiBvbmx5IHRoZSBpdGVtcyB0aGF0IHNob3VsZCBiZSBjdXJyZW50bHkgdmlzaWJsZS4KICAgKiBTbyBpZiB5b3UgaGF2ZSAxLDAwMCBpdGVtcyBpbiB5b3VyIGxpc3QgYnV0IG9ubHkgdGVuIGZpdCBvbiB5b3VyIHNjcmVlbiwKICAgKiBjb2xsZWN0aW9uLXJlcGVhdCB3aWxsIG9ubHkgcmVuZGVyIGludG8gdGhlIERPTSB0aGUgdGVuIHRoYXQgYXJlIGluIHRoZSBjdXJyZW50CiAgICogc2Nyb2xsIHBvc2l0aW9uLgogICAqCiAgICogSGVyZSBhcmUgYSBmZXcgdGhpbmdzIHRvIGtlZXAgaW4gbWluZCB3aGlsZSB1c2luZyBjb2xsZWN0aW9uLXJlcGVhdDoKICAgKgogICAqIDEuIFRoZSBkYXRhIHN1cHBsaWVkIHRvIGNvbGxlY3Rpb24tcmVwZWF0IG11c3QgYmUgYW4gYXJyYXkuCiAgICogMi4gWW91IG11c3QgZXhwbGljaXRseSB0ZWxsIHRoZSBkaXJlY3RpdmUgd2hhdCBzaXplIHlvdXIgaXRlbXMgd2lsbCBiZSBpbiB0aGUgRE9NLCB1c2luZyBkaXJlY3RpdmUgYXR0cmlidXRlcy4KICAgKiBQaXhlbCBhbW91bnRzIG9yIHBlcmNlbnRhZ2VzIGFyZSBhbGxvd2VkIChzZWUgYmVsb3cpLgogICAqIDMuIFRoZSBlbGVtZW50cyByZW5kZXJlZCB3aWxsIGJlIGFic29sdXRlbHkgcG9zaXRpb25lZDogYmUgc3VyZSB0byBsZXQgeW91ciBDU1Mgd29yayB3aXRoCiAgICogdGhpcyAoc2VlIGJlbG93KS4KICAgKiA0LiBFYWNoIGNvbGxlY3Rpb24tcmVwZWF0IGxpc3Qgd2lsbCB0YWtlIHVwIGFsbCBvZiBpdHMgcGFyZW50IHNjcm9sbFZpZXcncyBzcGFjZS4KICAgKiBJZiB5b3Ugd2lzaCB0byBoYXZlIG11bHRpcGxlIGxpc3RzIG9uIG9uZSBwYWdlLCBwdXQgZWFjaCBsaXN0IHdpdGhpbiBpdHMgb3duCiAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TY3JvbGwgaW9uU2Nyb2xsfSBjb250YWluZXIuCiAgICogNS4gWW91IHNob3VsZCBub3QgdXNlIHRoZSBuZy1zaG93IGFuZCBuZy1oaWRlIGRpcmVjdGl2ZXMgb24geW91ciBpb24tY29udGVudC9pb24tc2Nyb2xsIGVsZW1lbnRzIHRoYXQKICAgKiBoYXZlIGEgY29sbGVjdGlvbi1yZXBlYXQgaW5zaWRlLiAgbmctc2hvdyBhbmQgbmctaGlkZSBhcHBseSB0aGUgYGRpc3BsYXk6IG5vbmVgIGNzcyBydWxlIHRvIHRoZSBjb250ZW50J3MKICAgKiBzdHlsZSwgY2F1c2luZyB0aGUgc2Nyb2xsVmlldyB0byByZWFkIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIHRoZSBjb250ZW50IGFzIDAuICBSZXN1bHRpbmdseSwKICAgKiBjb2xsZWN0aW9uLXJlcGVhdCB3aWxsIHJlbmRlciBlbGVtZW50cyB0aGF0IGhhdmUganVzdCBiZWVuIHVuLWhpZGRlbiBpbmNvcnJlY3RseS4KICAgKgogICAqCiAgICogQHVzYWdlCiAgICoKICAgKiAjIyMjIEJhc2ljIFVzYWdlIChzaW5nbGUgcm93cyBvZiBpdGVtcykKICAgKgogICAqIE5vdGljZSB0d28gdGhpbmdzIGhlcmU6IHdlIHVzZSBuZy1zdHlsZSB0byBzZXQgdGhlIGhlaWdodCBvZiB0aGUgaXRlbSB0byBtYXRjaAogICAqIHdoYXQgdGhlIHJlcGVhdGVyIHRoaW5rcyBvdXIgaXRlbSBoZWlnaHQgaXMuICBBZGRpdGlvbmFsbHksIHdlIGFkZCBhIGNzcyBydWxlCiAgICogdG8gbWFrZSBvdXIgaXRlbSBzdHJldGNoIHRvIGZpdCB0aGUgZnVsbCBzY3JlZW4gKHNpbmNlIGl0IHdpbGwgYmUgYWJzb2x1dGVseQogICAqIHBvc2l0aW9uZWQpLgogICAqCiAgICogYGBgaHRtbAogICAqIDxpb24tY29udGVudCBuZy1jb250cm9sbGVyPSJDb250ZW50Q3RybCI+CiAgICogICA8ZGl2IGNsYXNzPSJsaXN0Ij4KICAgKiAgICAgPGRpdiBjbGFzcz0iaXRlbSBteS1pdGVtIgogICAqICAgICAgIGNvbGxlY3Rpb24tcmVwZWF0PSJpdGVtIGluIGl0ZW1zIgogICAqICAgICAgIGNvbGxlY3Rpb24taXRlbS13aWR0aD0iJzEwMCUnIgogICAqICAgICAgIGNvbGxlY3Rpb24taXRlbS1oZWlnaHQ9ImdldEl0ZW1IZWlnaHQoaXRlbSwgJGluZGV4KSIKICAgKiAgICAgICBuZy1zdHlsZT0ie2hlaWdodDogZ2V0SXRlbUhlaWdodChpdGVtLCAkaW5kZXgpfSI+CiAgICogICAgICAgeyUgcmF3ICV9e3tpdGVtfX17JSBlbmRyYXcgJX0KICAgKiAgICAgPC9kaXY+CiAgICogICA8L2Rpdj4KICAgKiA8L2Rpdj4KICAgKiBgYGAKICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIENvbnRlbnRDdHJsKCRzY29wZSkgewogKiAgICRzY29wZS5pdGVtcyA9IFtdOwogKiAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTAwMDsgaSsrKSB7CiAqICAgICAkc2NvcGUuaXRlbXMucHVzaCgnSXRlbSAnICsgaSk7CiAqICAgfQogKgogKiAgICRzY29wZS5nZXRJdGVtSGVpZ2h0ID0gZnVuY3Rpb24oaXRlbSwgaW5kZXgpIHsKICogICAgIC8vTWFrZSBldmVubHkgaW5kZXhlZCBpdGVtcyBiZSAxMHB4IHRhbGxlciwgZm9yIHRoZSBzYWtlIG9mIGV4YW1wbGUKICogICAgIHJldHVybiAoaW5kZXggJSAyKSA9PT0gMCA/IDUwIDogNjA7CiAqICAgfTsKICogfQogICAqIGBgYAogICAqIGBgYGNzcwogICAqIC5teS1pdGVtIHsKICogICBsZWZ0OiAwOwogKiAgIHJpZ2h0OiAwOwogKiB9CiAgICogYGBgCiAgICoKICAgKiAjIyMjIEdyaWQgVXNhZ2UgKHRocmVlIGl0ZW1zIHBlciByb3cpCiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi1jb250ZW50PgogICAqICAgPGRpdiBjbGFzcz0iaXRlbSBpdGVtLWF2YXRhciBteS1pbWFnZS1pdGVtIgogICAqICAgICBjb2xsZWN0aW9uLXJlcGVhdD0iaW1hZ2UgaW4gaW1hZ2VzIgogICAqICAgICBjb2xsZWN0aW9uLWl0ZW0td2lkdGg9IiczMyUnIgogICAqICAgICBjb2xsZWN0aW9uLWl0ZW0taGVpZ2h0PSInMzMlJyI+CiAgICogICAgIDxpbWcgbmctc3JjPSJ7e2ltYWdlLnNyY319Ij4KICAgKiAgIDwvZGl2PgogICAqIDwvaW9uLWNvbnRlbnQ+CiAgICogYGBgCiAgICogUGVyY2VudGFnZSBvZiB0b3RhbCB2aXNpYmxlIGxpc3QgZGltZW5zaW9ucy4gVGhpcyBleGFtcGxlIHNob3dzIGEgMyBieSAzIG1hdHJpeCB0aGF0IGZpdHMgb24gdGhlIHNjcmVlbiAoMyByb3dzIGFuZCAzIGNvbHVtcykuIE5vdGUgdGhhdCBkaW1lbnNpb25zIGFyZSB1c2VkIGluIHRoZSBjcmVhdGlvbiBvZiB0aGUgZWxlbWVudCBhbmQgdGhlcmVmb3JlIGEgbWVhc3VyZW1lbnQgb2YgdGhlIGl0ZW0gY2Fubm5vdCBiZSB1c2VkIGFzIGFuIGlucHV0IGRpbWVuc2lvbi4KICAgKiBgYGBjc3MKICAgKiAubXktaW1hZ2UtaXRlbSBpbWcgewogKiAgIGhlaWdodDogMzMlOwogKiAgIHdpZHRoOiAzMyU7CiAqIH0KICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gY29sbGVjdGlvbi1yZXBlYXQgVGhlIGV4cHJlc3Npb24gaW5kaWNhdGluZyBob3cgdG8gZW51bWVyYXRlIGEgY29sbGVjdGlvbi4gVGhlc2UKICAgKiAgIGZvcm1hdHMgYXJlIGN1cnJlbnRseSBzdXBwb3J0ZWQ6CiAgICoKICAgKiAgICogYHZhcmlhYmxlIGluIGV4cHJlc3Npb25gIOKAkyB3aGVyZSB2YXJpYWJsZSBpcyB0aGUgdXNlciBkZWZpbmVkIGxvb3AgdmFyaWFibGUgYW5kIGBleHByZXNzaW9uYAogICAqICAgICBpcyBhIHNjb3BlIGV4cHJlc3Npb24gZ2l2aW5nIHRoZSBjb2xsZWN0aW9uIHRvIGVudW1lcmF0ZS4KICAgKgogICAqICAgICBGb3IgZXhhbXBsZTogYGFsYnVtIGluIGFydGlzdC5hbGJ1bXNgLgogICAqCiAgICogICAqIGB2YXJpYWJsZSBpbiBleHByZXNzaW9uIHRyYWNrIGJ5IHRyYWNraW5nX2V4cHJlc3Npb25gIOKAkyBZb3UgY2FuIGFsc28gcHJvdmlkZSBhbiBvcHRpb25hbCB0cmFja2luZyBmdW5jdGlvbgogICAqICAgICB3aGljaCBjYW4gYmUgdXNlZCB0byBhc3NvY2lhdGUgdGhlIG9iamVjdHMgaW4gdGhlIGNvbGxlY3Rpb24gd2l0aCB0aGUgRE9NIGVsZW1lbnRzLiBJZiBubyB0cmFja2luZyBmdW5jdGlvbgogICAqICAgICBpcyBzcGVjaWZpZWQgdGhlIGNvbGxlY3Rpb24tcmVwZWF0IGFzc29jaWF0ZXMgZWxlbWVudHMgYnkgaWRlbnRpdHkgaW4gdGhlIGNvbGxlY3Rpb24uIEl0IGlzIGFuIGVycm9yIHRvIGhhdmUKICAgKiAgICAgbW9yZSB0aGFuIG9uZSB0cmFja2luZyBmdW5jdGlvbiB0byByZXNvbHZlIHRvIHRoZSBzYW1lIGtleS4gKFRoaXMgd291bGQgbWVhbiB0aGF0IHR3byBkaXN0aW5jdCBvYmplY3RzIGFyZQogICAqICAgICBtYXBwZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQsIHdoaWNoIGlzIG5vdCBwb3NzaWJsZS4pICBGaWx0ZXJzIHNob3VsZCBiZSBhcHBsaWVkIHRvIHRoZSBleHByZXNzaW9uLAogICAqICAgICBiZWZvcmUgc3BlY2lmeWluZyBhIHRyYWNraW5nIGV4cHJlc3Npb24uCiAgICoKICAgKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zYCBpcyBlcXVpdmFsZW50IHRvIGBpdGVtIGluIGl0ZW1zIHRyYWNrIGJ5ICRpZChpdGVtKScuIFRoaXMgaW1wbGllcyB0aGF0IHRoZSBET00gZWxlbWVudHMKICAgKiAgICAgd2lsbCBiZSBhc3NvY2lhdGVkIGJ5IGl0ZW0gaWRlbnRpdHkgaW4gdGhlIGFycmF5LgogICAqCiAgICogICAgIEZvciBleGFtcGxlOiBgaXRlbSBpbiBpdGVtcyB0cmFjayBieSAkaWQoaXRlbSlgLiBBIGJ1aWx0IGluIGAkaWQoKWAgZnVuY3Rpb24gY2FuIGJlIHVzZWQgdG8gYXNzaWduIGEgdW5pcXVlCiAgICogICAgIGAkJGhhc2hLZXlgIHByb3BlcnR5IHRvIGVhY2ggaXRlbSBpbiB0aGUgYXJyYXkuIFRoaXMgcHJvcGVydHkgaXMgdGhlbiB1c2VkIGFzIGEga2V5IHRvIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnRzCiAgICogICAgIHdpdGggdGhlIGNvcnJlc3BvbmRpbmcgaXRlbSBpbiB0aGUgYXJyYXkgYnkgaWRlbnRpdHkuIE1vdmluZyB0aGUgc2FtZSBvYmplY3QgaW4gYXJyYXkgd291bGQgbW92ZSB0aGUgRE9NCiAgICogICAgIGVsZW1lbnQgaW4gdGhlIHNhbWUgd2F5IGluIHRoZSBET00uCiAgICoKICAgKiAgICAgRm9yIGV4YW1wbGU6IGBpdGVtIGluIGl0ZW1zIHRyYWNrIGJ5IGl0ZW0uaWRgIGlzIGEgdHlwaWNhbCBwYXR0ZXJuIHdoZW4gdGhlIGl0ZW1zIGNvbWUgZnJvbSB0aGUgZGF0YWJhc2UuIEluIHRoaXMKICAgKiAgICAgY2FzZSB0aGUgb2JqZWN0IGlkZW50aXR5IGRvZXMgbm90IG1hdHRlci4gVHdvIG9iamVjdHMgYXJlIGNvbnNpZGVyZWQgZXF1aXZhbGVudCBhcyBsb25nIGFzIHRoZWlyIGBpZGAKICAgKiAgICAgcHJvcGVydHkgaXMgc2FtZS4KICAgKgogICAqICAgICBGb3IgZXhhbXBsZTogYGl0ZW0gaW4gaXRlbXMgfCBmaWx0ZXI6c2VhcmNoVGV4dCB0cmFjayBieSBpdGVtLmlkYCBpcyBhIHBhdHRlcm4gdGhhdCBtaWdodCBiZSB1c2VkIHRvIGFwcGx5IGEgZmlsdGVyCiAgICogICAgIHRvIGl0ZW1zIGluIGNvbmp1bmN0aW9uIHdpdGggYSB0cmFja2luZyBleHByZXNzaW9uLgogICAqCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBjb2xsZWN0aW9uLWl0ZW0td2lkdGggVGhlIHdpZHRoIG9mIHRoZSByZXBlYXRlZCBlbGVtZW50LiAgQ2FuIGJlIGEgbnVtYmVyIChpbiBwaXhlbHMpIG9yIGEgcGVyY2VudGFnZS4KICAgKiBAcGFyYW0ge2V4cHJlc3Npb259IGNvbGxlY3Rpb24taXRlbS1oZWlnaHQgVGhlIGhlaWdodCBvZiB0aGUgcmVwZWF0ZWQgZWxlbWVudC4gIENhbiBiZSBhIG51bWJlciAoaW4gcGl4ZWxzKSwgb3IgYSBwZXJjZW50YWdlLgogICAqCiAgICovCiAgdmFyIENPTExFQ1RJT05fUkVQRUFUX1NDUk9MTFZJRVdfWFlfRVJST1IgPSAiQ2Fubm90IGNyZWF0ZSBhIGNvbGxlY3Rpb24tcmVwZWF0IHdpdGhpbiBhIHNjcm9sbFZpZXcgdGhhdCBpcyBzY3JvbGxhYmxlIG9uIGJvdGggeCBhbmQgeSBheGlzLiAgQ2hvb3NlIGVpdGhlciB4IGRpcmVjdGlvbiBvciB5IGRpcmVjdGlvbi4iOwogIHZhciBDT0xMRUNUSU9OX1JFUEVBVF9BVFRSX0hFSUdIVF9FUlJPUiA9ICJjb2xsZWN0aW9uLXJlcGVhdCBleHBlY3RlZCBhdHRyaWJ1dGUgY29sbGVjdGlvbi1pdGVtLWhlaWdodCB0byBiZSBhIGFuIGV4cHJlc3Npb24gdGhhdCByZXR1cm5zIGEgbnVtYmVyIChpbiBwaXhlbHMpIG9yIHBlcmNlbnRhZ2UuIjsKICB2YXIgQ09MTEVDVElPTl9SRVBFQVRfQVRUUl9XSURUSF9FUlJPUiA9ICJjb2xsZWN0aW9uLXJlcGVhdCBleHBlY3RlZCBhdHRyaWJ1dGUgY29sbGVjdGlvbi1pdGVtLXdpZHRoIHRvIGJlIGEgYW4gZXhwcmVzc2lvbiB0aGF0IHJldHVybnMgYSBudW1iZXIgKGluIHBpeGVscykgb3IgcGVyY2VudGFnZS4iOwogIHZhciBDT0xMRUNUSU9OX1JFUEVBVF9BVFRSX1JFUEVBVF9FUlJPUiA9ICJjb2xsZWN0aW9uLXJlcGVhdCBleHBlY3RlZCBleHByZXNzaW9uIGluIGZvcm0gb2YgJ19pdGVtXyBpbiBfY29sbGVjdGlvbl9bIHRyYWNrIGJ5IF9pZF9dJyBidXQgZ290ICclJyI7CgogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKHsKICAgICAgbmdTcmM6IGNvbGxlY3Rpb25SZXBlYXRTcmNEaXJlY3RpdmUoJ25nU3JjJywgJ3NyYycpLAogICAgICBuZ1NyY3NldDogY29sbGVjdGlvblJlcGVhdFNyY0RpcmVjdGl2ZSgnbmdTcmNzZXQnLCAnc3Jjc2V0JyksCiAgICAgIG5nSHJlZjogY29sbGVjdGlvblJlcGVhdFNyY0RpcmVjdGl2ZSgnbmdIcmVmJywgJ2hyZWYnKQogICAgfSkKICAgIC5kaXJlY3RpdmUoJ2NvbGxlY3Rpb25SZXBlYXQnLCBbCiAgICAgICckY29sbGVjdGlvblJlcGVhdE1hbmFnZXInLAogICAgICAnJGNvbGxlY3Rpb25EYXRhU291cmNlJywKICAgICAgJyRwYXJzZScsCiAgICAgIGZ1bmN0aW9uKCRjb2xsZWN0aW9uUmVwZWF0TWFuYWdlciwgJGNvbGxlY3Rpb25EYXRhU291cmNlLCAkcGFyc2UpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcHJpb3JpdHk6IDEwMDAsCiAgICAgICAgICB0cmFuc2NsdWRlOiAnZWxlbWVudCcsCiAgICAgICAgICB0ZXJtaW5hbDogdHJ1ZSwKICAgICAgICAgICQkdGxiOiB0cnVlLAogICAgICAgICAgcmVxdWlyZTogJ14kaW9uaWNTY3JvbGwnLAogICAgICAgICAgY29udHJvbGxlcjogW2Z1bmN0aW9uKCl7fV0sCiAgICAgICAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgc2Nyb2xsQ3RybCwgJHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgdmFyIHdyYXAgPSBqcUxpdGUoJzxkaXYgc3R5bGU9InBvc2l0aW9uOnJlbGF0aXZlOyI+Jyk7CiAgICAgICAgICAgICRlbGVtZW50LnBhcmVudCgpWzBdLmluc2VydEJlZm9yZSh3cmFwWzBdLCAkZWxlbWVudFswXSk7CiAgICAgICAgICAgIHdyYXAuYXBwZW5kKCRlbGVtZW50KTsKCiAgICAgICAgICAgIHZhciBzY3JvbGxWaWV3ID0gc2Nyb2xsQ3RybC5zY3JvbGxWaWV3OwogICAgICAgICAgICBpZiAoc2Nyb2xsVmlldy5vcHRpb25zLnNjcm9sbGluZ1ggJiYgc2Nyb2xsVmlldy5vcHRpb25zLnNjcm9sbGluZ1kpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoQ09MTEVDVElPTl9SRVBFQVRfU0NST0xMVklFV19YWV9FUlJPUik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBpc1ZlcnRpY2FsID0gISFzY3JvbGxWaWV3Lm9wdGlvbnMuc2Nyb2xsaW5nWTsKICAgICAgICAgICAgaWYgKGlzVmVydGljYWwgJiYgISRhdHRyLmNvbGxlY3Rpb25JdGVtSGVpZ2h0KSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKENPTExFQ1RJT05fUkVQRUFUX0FUVFJfSEVJR0hUX0VSUk9SKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghaXNWZXJ0aWNhbCAmJiAhJGF0dHIuY29sbGVjdGlvbkl0ZW1XaWR0aCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihDT0xMRUNUSU9OX1JFUEVBVF9BVFRSX1dJRFRIX0VSUk9SKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGhlaWdodFBhcnNlZCA9ICRwYXJzZSgkYXR0ci5jb2xsZWN0aW9uSXRlbUhlaWdodCB8fCAnIjEwMCUiJyk7CiAgICAgICAgICAgIHZhciB3aWR0aFBhcnNlZCA9ICRwYXJzZSgkYXR0ci5jb2xsZWN0aW9uSXRlbVdpZHRoIHx8ICciMTAwJSInKTsKCiAgICAgICAgICAgIHZhciBoZWlnaHRHZXR0ZXIgPSBmdW5jdGlvbihzY29wZSwgbG9jYWxzKSB7CiAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGhlaWdodFBhcnNlZChzY29wZSwgbG9jYWxzKTsKICAgICAgICAgICAgICBpZiAoaXNTdHJpbmcocmVzdWx0KSAmJiByZXN1bHQuaW5kZXhPZignJScpID4gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKHBhcnNlSW50KHJlc3VsdCwgMTApIC8gMTAwICogc2Nyb2xsVmlldy5fX2NsaWVudEhlaWdodCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciB3aWR0aEdldHRlciA9IGZ1bmN0aW9uKHNjb3BlLCBsb2NhbHMpIHsKICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gd2lkdGhQYXJzZWQoc2NvcGUsIGxvY2Fscyk7CiAgICAgICAgICAgICAgaWYgKGlzU3RyaW5nKHJlc3VsdCkgJiYgcmVzdWx0LmluZGV4T2YoJyUnKSA+IC0xKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihwYXJzZUludChyZXN1bHQsIDEwKSAvIDEwMCAqIHNjcm9sbFZpZXcuX19jbGllbnRXaWR0aCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgbWF0Y2ggPSAkYXR0ci5jb2xsZWN0aW9uUmVwZWF0Lm1hdGNoKC9eXHMqKFtcc1xTXSs/KVxzK2luXHMrKFtcc1xTXSs/KSg/OlxzK3RyYWNrXHMrYnlccysoW1xzXFNdKz8pKT9ccyokLyk7CiAgICAgICAgICAgIGlmICghbWF0Y2gpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoQ09MTEVDVElPTl9SRVBFQVRfQVRUUl9SRVBFQVRfRVJST1IKICAgICAgICAgICAgICAgIC5yZXBsYWNlKCclJywgJGF0dHIuY29sbGVjdGlvblJlcGVhdCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBrZXlFeHByID0gbWF0Y2hbMV07CiAgICAgICAgICAgIHZhciBsaXN0RXhwciA9IG1hdGNoWzJdOwogICAgICAgICAgICB2YXIgdHJhY2tCeUV4cHIgPSBtYXRjaFszXTsKCiAgICAgICAgICAgIHZhciBkYXRhU291cmNlID0gbmV3ICRjb2xsZWN0aW9uRGF0YVNvdXJjZSh7CiAgICAgICAgICAgICAgc2NvcGU6ICRzY29wZSwKICAgICAgICAgICAgICB0cmFuc2NsdWRlRm46ICR0cmFuc2NsdWRlLAogICAgICAgICAgICAgIHRyYW5zY2x1ZGVQYXJlbnQ6ICRlbGVtZW50LnBhcmVudCgpLAogICAgICAgICAgICAgIGtleUV4cHI6IGtleUV4cHIsCiAgICAgICAgICAgICAgbGlzdEV4cHI6IGxpc3RFeHByLAogICAgICAgICAgICAgIHRyYWNrQnlFeHByOiB0cmFja0J5RXhwciwKICAgICAgICAgICAgICBoZWlnaHRHZXR0ZXI6IGhlaWdodEdldHRlciwKICAgICAgICAgICAgICB3aWR0aEdldHRlcjogd2lkdGhHZXR0ZXIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBjb2xsZWN0aW9uUmVwZWF0TWFuYWdlciA9IG5ldyAkY29sbGVjdGlvblJlcGVhdE1hbmFnZXIoewogICAgICAgICAgICAgIGRhdGFTb3VyY2U6IGRhdGFTb3VyY2UsCiAgICAgICAgICAgICAgZWxlbWVudDogc2Nyb2xsQ3RybC4kZWxlbWVudCwKICAgICAgICAgICAgICBzY3JvbGxWaWV3OiBzY3JvbGxDdHJsLnNjcm9sbFZpZXcsCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaENvbGxlY3Rpb24obGlzdEV4cHIsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgaWYgKHZhbHVlICYmICFhbmd1bGFyLmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNvbGxlY3Rpb24tcmVwZWF0IGV4cGVjdHMgYW4gYXJyYXkgdG8gcmVwZWF0IG92ZXIsIGJ1dCBpbnN0ZWFkIGdvdCAnIiArIHR5cGVvZiB2YWx1ZSArICInLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXJlbmRlcih2YWx1ZSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIHNjcm9sbFZpZXdDb250ZW50ID0gc2Nyb2xsQ3RybC5zY3JvbGxWaWV3Ll9fY29udGVudDsKICAgICAgICAgICAgZnVuY3Rpb24gcmVyZW5kZXIodmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgYmVmb3JlU2libGluZ3MgPSBbXTsKICAgICAgICAgICAgICB2YXIgYWZ0ZXJTaWJsaW5ncyA9IFtdOwogICAgICAgICAgICAgIHZhciBiZWZvcmUgPSB0cnVlOwogICAgICAgICAgICAgIGZvckVhY2goc2Nyb2xsVmlld0NvbnRlbnQuY2hpbGRyZW4sIGZ1bmN0aW9uKG5vZGUsIGkpIHsKICAgICAgICAgICAgICAgIGlmICggaW9uaWMuRG9tVXRpbC5lbGVtZW50SXNEZXNjZW5kYW50KCRlbGVtZW50WzBdLCBub2RlLCBzY3JvbGxWaWV3Q29udGVudCkgKSB7CiAgICAgICAgICAgICAgICAgIGJlZm9yZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIHdpZHRoID0gbm9kZS5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgICAgICAgdmFyIGhlaWdodCA9IG5vZGUub2Zmc2V0SGVpZ2h0OwogICAgICAgICAgICAgICAgICBpZiAod2lkdGggJiYgaGVpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBqcUxpdGUobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgKGJlZm9yZSA/IGJlZm9yZVNpYmxpbmdzIDogYWZ0ZXJTaWJsaW5ncykucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogbm9kZS5vZmZzZXRXaWR0aCwKICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogbm9kZS5vZmZzZXRIZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50OiBlbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IGVsZW1lbnQuaXNvbGF0ZVNjb3BlKCkgfHwgZWxlbWVudC5zY29wZSgpLAogICAgICAgICAgICAgICAgICAgICAgaXNPdXRzaWRlOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgc2Nyb2xsVmlldy5yZXNpemUoKTsKICAgICAgICAgICAgICBkYXRhU291cmNlLnNldERhdGEodmFsdWUsIGJlZm9yZVNpYmxpbmdzLCBhZnRlclNpYmxpbmdzKTsKICAgICAgICAgICAgICBjb2xsZWN0aW9uUmVwZWF0TWFuYWdlci5yZXNpemUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmdW5jdGlvbiBvbldpbmRvd1Jlc2l6ZSgpIHsKICAgICAgICAgICAgICByZXJlbmRlcigkc2NvcGUuJGV2YWwobGlzdEV4cHIpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaW9uaWMub24oJ3Jlc2l6ZScsIG9uV2luZG93UmVzaXplLCB3aW5kb3cpOwoKICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjb2xsZWN0aW9uUmVwZWF0TWFuYWdlci5kZXN0cm95KCk7CiAgICAgICAgICAgICAgZGF0YVNvdXJjZS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgaW9uaWMub2ZmKCdyZXNpemUnLCBvbldpbmRvd1Jlc2l6ZSwgd2luZG93KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfV0pOwoKLy8gRml4IGZvciAjMTY3NAovLyBQcm9ibGVtOiBpZiBhbiBuZ1NyYyBvciBuZ0hyZWYgZXhwcmVzc2lvbiBldmFsdWF0ZXMgdG8gYSBmYWxzeSB2YWx1ZSwgaXQgd2lsbAovLyBub3QgZXJhc2UgdGhlIHByZXZpb3VzIHRydXRoeSB2YWx1ZSBvZiB0aGUgaHJlZi4KLy8gSW4gY29sbGVjdGlvblJlcGVhdCwgd2UgcmUtdXNlIGVsZW1lbnRzIGZyb20gYmVmb3JlLiBTbyBpZiB0aGUgbmdIcmVmIGV4cHJlc3Npb24KLy8gZXZhbHVhdGVzIHRvIHRydXRoeSBmb3IgaXRlbSAxIGFuZCB0aGVuIGZhbHN5IGZvciBpdGVtIDIsIGlmIGFuIGVsZW1lbnQgY2hhbmdlcwovLyBmcm9tIHJlcHJlc2VudGluZyBpdGVtIDEgdG8gcmVwcmVzZW50aW5nIGl0ZW0gMiwgaXRlbSAyIHdpbGwgc3RpbGwgaGF2ZQovLyBpdGVtIDEncyBocmVmIHZhbHVlLgovLyBTb2x1dGlvbjogIGVyYXNlIHRoZSBocmVmIG9yIHNyYyBhdHRyaWJ1dGUgaWYgbmdIcmVmL25nU3JjIGFyZSBmYWxzeS4KICBmdW5jdGlvbiBjb2xsZWN0aW9uUmVwZWF0U3JjRGlyZWN0aXZlKG5nQXR0ck5hbWUsIGF0dHJOYW1lKSB7CiAgICByZXR1cm4gW2Z1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIHByaW9yaXR5OiAnOTknLCAvLyBpdCBuZWVkcyB0byBydW4gYWZ0ZXIgdGhlIGF0dHJpYnV0ZXMgYXJlIGludGVycG9sYXRlZAogICAgICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBjb2xsZWN0aW9uUmVwZWF0Q3RybCkgewogICAgICAgICAgaWYgKCFjb2xsZWN0aW9uUmVwZWF0Q3RybCkgcmV0dXJuOwogICAgICAgICAgYXR0ci4kb2JzZXJ2ZShuZ0F0dHJOYW1lLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBlbGVtZW50WzBdW2F0dHJdID0gJyc7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZWxlbWVudFswXVthdHRyXSA9IHZhbHVlOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKICAgIH1dOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvbkNvbnRlbnQKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljU2Nyb2xsRGVsZWdhdGUKICAgKiBAcmVzdHJpY3QgRQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGlvbkNvbnRlbnQgZGlyZWN0aXZlIHByb3ZpZGVzIGFuIGVhc3kgdG8gdXNlIGNvbnRlbnQgYXJlYSB0aGF0IGNhbiBiZSBjb25maWd1cmVkCiAgICogdG8gdXNlIElvbmljJ3MgY3VzdG9tIFNjcm9sbCBWaWV3LCBvciB0aGUgYnVpbHQgaW4gb3ZlcmZsb3cgc2Nyb2xsaW5nIG9mIHRoZSBicm93c2VyLgogICAqCiAgICogV2hpbGUgd2UgcmVjb21tZW5kIHVzaW5nIHRoZSBjdXN0b20gU2Nyb2xsIGZlYXR1cmVzIGluIElvbmljIGluIG1vc3QgY2FzZXMsIHNvbWV0aW1lcwogICAqIChmb3IgcGVyZm9ybWFuY2UgcmVhc29ucykgb25seSB0aGUgYnJvd3NlcidzIG5hdGl2ZSBvdmVyZmxvdyBzY3JvbGxpbmcgd2lsbCBzdWZmaWNlLAogICAqIGFuZCBzbyB3ZSd2ZSBtYWRlIGl0IGVhc3kgdG8gdG9nZ2xlIGJldHdlZW4gdGhlIElvbmljIHNjcm9sbCBpbXBsZW1lbnRhdGlvbiBhbmQKICAgKiBvdmVyZmxvdyBzY3JvbGxpbmcuCiAgICoKICAgKiBZb3UgY2FuIGltcGxlbWVudCBwdWxsLXRvLXJlZnJlc2ggd2l0aCB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25SZWZyZXNoZXJ9CiAgICogZGlyZWN0aXZlLCBhbmQgaW5maW5pdGUgc2Nyb2xsaW5nIHdpdGggdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uSW5maW5pdGVTY3JvbGx9CiAgICogZGlyZWN0aXZlLgogICAqCiAgICogQmUgYXdhcmUgdGhhdCB0aGlzIGRpcmVjdGl2ZSBnZXRzIGl0cyBvd24gY2hpbGQgc2NvcGUuIElmIHlvdSBkbyBub3QgdW5kZXJzdGFuZCB3aHkgdGhpcwogICAqIGlzIGltcG9ydGFudCwgeW91IGNhbiByZWFkIFtodHRwczovL2RvY3MuYW5ndWxhcmpzLm9yZy9ndWlkZS9zY29wZV0oaHR0cHM6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvZ3VpZGUvc2NvcGUpLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBkZWxlZ2F0ZS1oYW5kbGUgVGhlIGhhbmRsZSB1c2VkIHRvIGlkZW50aWZ5IHRoaXMgc2Nyb2xsVmlldwogICAqIHdpdGgge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljU2Nyb2xsRGVsZWdhdGV9LgogICAqIEBwYXJhbSB7c3RyaW5nPX0gZGlyZWN0aW9uIFdoaWNoIHdheSB0byBzY3JvbGwuICd4JyBvciAneScgb3IgJ3h5Jy4gRGVmYXVsdCAneScuCiAgICogQHBhcmFtIHtib29sZWFuPX0gcGFkZGluZyBXaGV0aGVyIHRvIGFkZCBwYWRkaW5nIHRvIHRoZSBjb250ZW50LgogICAqIG9mIHRoZSBjb250ZW50LiAgRGVmYXVsdHMgdG8gdHJ1ZSBvbiBpT1MsIGZhbHNlIG9uIEFuZHJvaWQuCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2Nyb2xsIFdoZXRoZXIgdG8gYWxsb3cgc2Nyb2xsaW5nIG9mIGNvbnRlbnQuICBEZWZhdWx0cyB0byB0cnVlLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG92ZXJmbG93LXNjcm9sbCBXaGV0aGVyIHRvIHVzZSBvdmVyZmxvdy1zY3JvbGxpbmcgaW5zdGVhZCBvZgogICAqIElvbmljIHNjcm9sbC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzY3JvbGxiYXIteCBXaGV0aGVyIHRvIHNob3cgdGhlIGhvcml6b250YWwgc2Nyb2xsYmFyLiBEZWZhdWx0IHRydWUuCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2Nyb2xsYmFyLXkgV2hldGhlciB0byBzaG93IHRoZSB2ZXJ0aWNhbCBzY3JvbGxiYXIuIERlZmF1bHQgdHJ1ZS4KICAgKiBAcGFyYW0ge3N0cmluZz19IHN0YXJ0LXkgSW5pdGlhbCB2ZXJ0aWNhbCBzY3JvbGwgcG9zaXRpb24uIERlZmF1bHQgMC4KICAgKiBvZiB0aGUgY29udGVudC4gIERlZmF1bHRzIHRvIHRydWUgb24gaU9TLCBmYWxzZSBvbiBBbmRyb2lkLgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXNjcm9sbCBFeHByZXNzaW9uIHRvIGV2YWx1YXRlIHdoZW4gdGhlIGNvbnRlbnQgaXMgc2Nyb2xsZWQuCiAgICogQHBhcmFtIHtleHByZXNzaW9uPX0gb24tc2Nyb2xsLWNvbXBsZXRlIEV4cHJlc3Npb24gdG8gZXZhbHVhdGUgd2hlbiBhIHNjcm9sbCBhY3Rpb24gY29tcGxldGVzLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IGhhcy1ib3VuY2luZyBXaGV0aGVyIHRvIGFsbG93IHNjcm9sbGluZyB0byBib3VuY2UgcGFzdCB0aGUgZWRnZXMKICAgKiBvZiB0aGUgY29udGVudC4gIERlZmF1bHRzIHRvIHRydWUgb24gaU9TLCBmYWxzZSBvbiBBbmRyb2lkLgogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25Db250ZW50JywgWwogICAgICAnJHRpbWVvdXQnLAogICAgICAnJGNvbnRyb2xsZXInLAogICAgICAnJGlvbmljQmluZCcsCiAgICAgIGZ1bmN0aW9uKCR0aW1lb3V0LCAkY29udHJvbGxlciwgJGlvbmljQmluZCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgcmVxdWlyZTogJ14/aW9uTmF2VmlldycsCiAgICAgICAgICBzY29wZTogdHJ1ZSwKICAgICAgICAgIHByaW9yaXR5OiA4MDAsCiAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgICAgIHZhciBpbm5lckVsZW1lbnQ7CgogICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKCdzY3JvbGwtY29udGVudCBpb25pYy1zY3JvbGwnKTsKCiAgICAgICAgICAgIGlmIChhdHRyLnNjcm9sbCAhPSAnZmFsc2UnKSB7CiAgICAgICAgICAgICAgLy9XZSBjYW5ub3QgdXNlIG5vcm1hbCB0cmFuc2NsdWRlIGhlcmUgYmVjYXVzZSBpdCBicmVha3MgZWxlbWVudC5kYXRhKCkKICAgICAgICAgICAgICAvL2luaGVyaXRhbmNlIG9uIGNvbXBpbGUKICAgICAgICAgICAgICBpbm5lckVsZW1lbnQgPSBqcUxpdGUoJzxkaXYgY2xhc3M9InNjcm9sbCI+PC9kaXY+Jyk7CiAgICAgICAgICAgICAgaW5uZXJFbGVtZW50LmFwcGVuZChlbGVtZW50LmNvbnRlbnRzKCkpOwogICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKGlubmVyRWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnc2Nyb2xsLWNvbnRlbnQtZmFsc2UnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsgcHJlOiBwcmVsaW5rIH07CiAgICAgICAgICAgIGZ1bmN0aW9uIHByZWxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIG5hdlZpZXdDdHJsKSB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudFNjb3BlID0gJHNjb3BlLiRwYXJlbnQ7CiAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiAocGFyZW50U2NvcGUuJGhhc0hlYWRlciA/ICcgaGFzLWhlYWRlcicgOiAnJykgICsKICAgICAgICAgICAgICAgICAgKHBhcmVudFNjb3BlLiRoYXNTdWJoZWFkZXIgPyAnIGhhcy1zdWJoZWFkZXInIDogJycpICsKICAgICAgICAgICAgICAgICAgKHBhcmVudFNjb3BlLiRoYXNGb290ZXIgPyAnIGhhcy1mb290ZXInIDogJycpICsKICAgICAgICAgICAgICAgICAgKHBhcmVudFNjb3BlLiRoYXNTdWJmb290ZXIgPyAnIGhhcy1zdWJmb290ZXInIDogJycpICsKICAgICAgICAgICAgICAgICAgKHBhcmVudFNjb3BlLiRoYXNUYWJzID8gJyBoYXMtdGFicycgOiAnJykgKwogICAgICAgICAgICAgICAgICAocGFyZW50U2NvcGUuJGhhc1RhYnNUb3AgPyAnIGhhcy10YWJzLXRvcCcgOiAnJyk7CiAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oY2xhc3NOYW1lLCBvbGRDbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgICRlbGVtZW50LnJlbW92ZUNsYXNzKG9sZENsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAvL09ubHkgdGhpcyBpb25Db250ZW50IHNob3VsZCB1c2UgdGhlc2UgdmFyaWFibGVzIGZyb20gcGFyZW50IHNjb3BlcwogICAgICAgICAgICAgICRzY29wZS4kaGFzSGVhZGVyID0gJHNjb3BlLiRoYXNTdWJoZWFkZXIgPQogICAgICAgICAgICAgICAgJHNjb3BlLiRoYXNGb290ZXIgPSAkc2NvcGUuJGhhc1N1YmZvb3RlciA9CiAgICAgICAgICAgICAgICAgICRzY29wZS4kaGFzVGFicyA9ICRzY29wZS4kaGFzVGFic1RvcCA9CiAgICAgICAgICAgICAgICAgICAgZmFsc2U7CiAgICAgICAgICAgICAgJGlvbmljQmluZCgkc2NvcGUsICRhdHRyLCB7CiAgICAgICAgICAgICAgICAkb25TY3JvbGw6ICcmb25TY3JvbGwnLAogICAgICAgICAgICAgICAgJG9uU2Nyb2xsQ29tcGxldGU6ICcmb25TY3JvbGxDb21wbGV0ZScsCiAgICAgICAgICAgICAgICBoYXNCb3VuY2luZzogJ0AnLAogICAgICAgICAgICAgICAgcGFkZGluZzogJ0AnLAogICAgICAgICAgICAgICAgZGlyZWN0aW9uOiAnQCcsCiAgICAgICAgICAgICAgICBzY3JvbGxiYXJYOiAnQCcsCiAgICAgICAgICAgICAgICBzY3JvbGxiYXJZOiAnQCcsCiAgICAgICAgICAgICAgICBzdGFydFg6ICdAJywKICAgICAgICAgICAgICAgIHN0YXJ0WTogJ0AnLAogICAgICAgICAgICAgICAgc2Nyb2xsRXZlbnRJbnRlcnZhbDogJ0AnCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgJHNjb3BlLmRpcmVjdGlvbiA9ICRzY29wZS5kaXJlY3Rpb24gfHwgJ3knOwoKICAgICAgICAgICAgICBpZiAoYW5ndWxhci5pc0RlZmluZWQoJGF0dHIucGFkZGluZykpIHsKICAgICAgICAgICAgICAgICRzY29wZS4kd2F0Y2goJGF0dHIucGFkZGluZywgZnVuY3Rpb24obmV3VmFsKSB7CiAgICAgICAgICAgICAgICAgIChpbm5lckVsZW1lbnQgfHwgJGVsZW1lbnQpLnRvZ2dsZUNsYXNzKCdwYWRkaW5nJywgISFuZXdWYWwpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAoJGF0dHIuc2Nyb2xsID09PSAiZmFsc2UiKSB7CiAgICAgICAgICAgICAgICAvL2RvIG5vdGhpbmcKICAgICAgICAgICAgICB9IGVsc2UgaWYoYXR0ci5vdmVyZmxvd1Njcm9sbCA9PT0gInRydWUiKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcygnb3ZlcmZsb3ctc2Nyb2xsJyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICRjb250cm9sbGVyKCckaW9uaWNTY3JvbGwnLCB7CiAgICAgICAgICAgICAgICAgICRzY29wZTogJHNjb3BlLAogICAgICAgICAgICAgICAgICBzY3JvbGxWaWV3T3B0aW9uczogewogICAgICAgICAgICAgICAgICAgIGVsOiAkZWxlbWVudFswXSwKICAgICAgICAgICAgICAgICAgICBkZWxlZ2F0ZUhhbmRsZTogYXR0ci5kZWxlZ2F0ZUhhbmRsZSwKICAgICAgICAgICAgICAgICAgICBib3VuY2luZzogJHNjb3BlLiRldmFsKCRzY29wZS5oYXNCb3VuY2luZyksCiAgICAgICAgICAgICAgICAgICAgc3RhcnRYOiAkc2NvcGUuJGV2YWwoJHNjb3BlLnN0YXJ0WCkgfHwgMCwKICAgICAgICAgICAgICAgICAgICBzdGFydFk6ICRzY29wZS4kZXZhbCgkc2NvcGUuc3RhcnRZKSB8fCAwLAogICAgICAgICAgICAgICAgICAgIHNjcm9sbGJhclg6ICRzY29wZS4kZXZhbCgkc2NvcGUuc2Nyb2xsYmFyWCkgIT09IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIHNjcm9sbGJhclk6ICRzY29wZS4kZXZhbCgkc2NvcGUuc2Nyb2xsYmFyWSkgIT09IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIHNjcm9sbGluZ1g6ICRzY29wZS5kaXJlY3Rpb24uaW5kZXhPZigneCcpID49IDAsCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsaW5nWTogJHNjb3BlLmRpcmVjdGlvbi5pbmRleE9mKCd5JykgPj0gMCwKICAgICAgICAgICAgICAgICAgICBzY3JvbGxFdmVudEludGVydmFsOiBwYXJzZUludCgkc2NvcGUuc2Nyb2xsRXZlbnRJbnRlcnZhbCwgMTApIHx8IDEwLAogICAgICAgICAgICAgICAgICAgIHNjcm9sbGluZ0NvbXBsZXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICRzY29wZS4kb25TY3JvbGxDb21wbGV0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbFRvcDogdGhpcy5fX3Njcm9sbFRvcCwKICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsTGVmdDogdGhpcy5fX3Njcm9sbExlZnQKICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH1dKTsKCiAgdmFyIEdFU1RVUkVfRElSRUNUSVZFUyA9ICdvbkhvbGQgb25UYXAgb25Ub3VjaCBvblJlbGVhc2Ugb25EcmFnIG9uRHJhZ1VwIG9uRHJhZ1JpZ2h0IG9uRHJhZ0Rvd24gb25EcmFnTGVmdCBvblN3aXBlIG9uU3dpcGVVcCBvblN3aXBlUmlnaHQgb25Td2lwZURvd24gb25Td2lwZUxlZnQnLnNwbGl0KCcgJyk7CgogIEdFU1RVUkVfRElSRUNUSVZFUy5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgIElvbmljTW9kdWxlLmRpcmVjdGl2ZShuYW1lLCBnZXN0dXJlRGlyZWN0aXZlKG5hbWUpKTsKICB9KTsKCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBvbkhvbGQKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFRvdWNoIHN0YXlzIGF0IHRoZSBzYW1lIGxvY2F0aW9uIGZvciA1MDBtcy4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8YnV0dG9uIG9uLWhvbGQ9Im9uSG9sZCgpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgb25UYXAKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIFF1aWNrIHRvdWNoIGF0IGEgbG9jYXRpb24uIElmIHRoZSBkdXJhdGlvbiBvZiB0aGUgdG91Y2ggZ29lcwogICAqIGxvbmdlciB0aGFuIDI1MG1zIGl0IGlzIG5vIGxvbmdlciBhIHRhcCBnZXN0dXJlLgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxidXR0b24gb24tdGFwPSJvblRhcCgpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgb25Ub3VjaAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgQQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2FsbGVkIGltbWVkaWF0ZWx5IHdoZW4gdGhlIHVzZXIgZmlyc3QgYmVnaW5zIGEgdG91Y2guIFRoaXMKICAgKiBnZXN0dXJlIGRvZXMgbm90IHdhaXQgZm9yIGEgdG91Y2hlbmQvbW91c2V1cC4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8YnV0dG9uIG9uLXRvdWNoPSJvblRvdWNoKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICAgKiBgYGAKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBvblJlbGVhc2UKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENhbGxlZCB3aGVuIHRoZSB1c2VyIGVuZHMgYSB0b3VjaC4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8YnV0dG9uIG9uLXJlbGVhc2U9Im9uUmVsZWFzZSgpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgb25EcmFnCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBNb3ZlIHdpdGggb25lIHRvdWNoIGFyb3VuZCBvbiB0aGUgcGFnZS4gQmxvY2tpbmcgdGhlIHNjcm9sbGluZyB3aGVuCiAgICogbW92aW5nIGxlZnQgYW5kIHJpZ2h0IGlzIGEgZ29vZCBwcmFjdGljZS4gV2hlbiBhbGwgdGhlIGRyYWcgZXZlbnRzIGFyZQogICAqIGJsb2NraW5nIHlvdSBkaXNhYmxlIHNjcm9sbGluZyBvbiB0aGF0IGFyZWEuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGJ1dHRvbiBvbi1kcmFnPSJvbkRyYWcoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogICAqIGBgYAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG9uRHJhZ1VwCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYWxsZWQgd2hlbiB0aGUgZWxlbWVudCBpcyBkcmFnZ2VkIHVwLgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxidXR0b24gb24tZHJhZy11cD0ib25EcmFnVXAoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogICAqIGBgYAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG9uRHJhZ1JpZ2h0CiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYWxsZWQgd2hlbiB0aGUgZWxlbWVudCBpcyBkcmFnZ2VkIHRvIHRoZSByaWdodC4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8YnV0dG9uIG9uLWRyYWctcmlnaHQ9Im9uRHJhZ1JpZ2h0KCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICAgKiBgYGAKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBvbkRyYWdEb3duCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYWxsZWQgd2hlbiB0aGUgZWxlbWVudCBpcyBkcmFnZ2VkIGRvd24uCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGJ1dHRvbiBvbi1kcmFnLWRvd249Im9uRHJhZ0Rvd24oKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogICAqIGBgYAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG9uRHJhZ0xlZnQKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENhbGxlZCB3aGVuIHRoZSBlbGVtZW50IGlzIGRyYWdnZWQgdG8gdGhlIGxlZnQuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGJ1dHRvbiBvbi1kcmFnLWxlZnQ9Im9uRHJhZ0xlZnQoKSIgY2xhc3M9ImJ1dHRvbiI+VGVzdDwvYnV0dG9uPgogICAqIGBgYAogICAqLwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG9uU3dpcGUKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENhbGxlZCB3aGVuIGEgbW92aW5nIHRvdWNoIGhhcyBhIGhpZ2ggdmVsb2NpdHkgaW4gYW55IGRpcmVjdGlvbi4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8YnV0dG9uIG9uLXN3aXBlPSJvblN3aXBlKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICAgKiBgYGAKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBvblN3aXBlVXAKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEEKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENhbGxlZCB3aGVuIGEgbW92aW5nIHRvdWNoIGhhcyBhIGhpZ2ggdmVsb2NpdHkgbW92aW5nIHVwLgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxidXR0b24gb24tc3dpcGUtdXA9Im9uU3dpcGVVcCgpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAgICogYGBgCiAgICovCgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgb25Td2lwZVJpZ2h0CiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDYWxsZWQgd2hlbiBhIG1vdmluZyB0b3VjaCBoYXMgYSBoaWdoIHZlbG9jaXR5IG1vdmluZyB0byB0aGUgcmlnaHQuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGJ1dHRvbiBvbi1zd2lwZS1yaWdodD0ib25Td2lwZVJpZ2h0KCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICAgKiBgYGAKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBvblN3aXBlRG93bgogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgQQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2FsbGVkIHdoZW4gYSBtb3ZpbmcgdG91Y2ggaGFzIGEgaGlnaCB2ZWxvY2l0eSBtb3ZpbmcgZG93bi4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8YnV0dG9uIG9uLXN3aXBlLWRvd249Im9uU3dpcGVEb3duKCkiIGNsYXNzPSJidXR0b24iPlRlc3Q8L2J1dHRvbj4KICAgKiBgYGAKICAgKi8KCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBvblN3aXBlTGVmdAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgQQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQ2FsbGVkIHdoZW4gYSBtb3ZpbmcgdG91Y2ggaGFzIGEgaGlnaCB2ZWxvY2l0eSBtb3ZpbmcgdG8gdGhlIGxlZnQuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGJ1dHRvbiBvbi1zd2lwZS1sZWZ0PSJvblN3aXBlTGVmdCgpIiBjbGFzcz0iYnV0dG9uIj5UZXN0PC9idXR0b24+CiAgICogYGBgCiAgICovCgoKICBmdW5jdGlvbiBnZXN0dXJlRGlyZWN0aXZlKGRpcmVjdGl2ZU5hbWUpIHsKICAgIHJldHVybiBbJyRpb25pY0dlc3R1cmUnLCAnJHBhcnNlJywgZnVuY3Rpb24oJGlvbmljR2VzdHVyZSwgJHBhcnNlKSB7CiAgICAgIHZhciBldmVudFR5cGUgPSBkaXJlY3RpdmVOYW1lLnN1YnN0cigyKS50b0xvd2VyQ2FzZSgpOwoKICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyKSB7CiAgICAgICAgdmFyIGZuID0gJHBhcnNlKCBhdHRyW2RpcmVjdGl2ZU5hbWVdICk7CgogICAgICAgIHZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uKGV2KSB7CiAgICAgICAgICBzY29wZS4kYXBwbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZuKHNjb3BlLCB7CiAgICAgICAgICAgICAgJGV2ZW50OiBldgogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHZhciBnZXN0dXJlID0gJGlvbmljR2VzdHVyZS5vbihldmVudFR5cGUsIGxpc3RlbmVyLCBlbGVtZW50KTsKCiAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgJGlvbmljR2VzdHVyZS5vZmYoZ2VzdHVyZSwgZXZlbnRUeXBlLCBsaXN0ZW5lcik7CiAgICAgICAgfSk7CiAgICAgIH07CiAgICB9XTsKICB9CgoKICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uTmF2QmFyJywgdGFwU2Nyb2xsVG9Ub3BEaXJlY3RpdmUoKSkKICAgIC5kaXJlY3RpdmUoJ2lvbkhlYWRlckJhcicsIHRhcFNjcm9sbFRvVG9wRGlyZWN0aXZlKCkpCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25IZWFkZXJCYXIKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEFkZHMgYSBmaXhlZCBoZWFkZXIgYmFyIGFib3ZlIHNvbWUgY29udGVudC4KICAgKgogICAqIENhbiBhbHNvIGJlIGEgc3ViaGVhZGVyIChsb3dlciBkb3duKSBpZiB0aGUgJ2Jhci1zdWJoZWFkZXInIGNsYXNzIGlzIGFwcGxpZWQuCiAgICogU2VlIFt0aGUgaGVhZGVyIENTUyBkb2NzXSgvZG9jcy9jb21wb25lbnRzLyNzdWJoZWFkZXIpLgogICAqCiAgICogTm90ZTogSWYgeW91IHVzZSBpb25IZWFkZXJCYXIgaW4gY29tYmluYXRpb24gd2l0aCBuZy1pZiwgdGhlIHN1cnJvdW5kaW5nIGNvbnRlbnQKICAgKiB3aWxsIG5vdCBhbGlnbiBjb3JyZWN0bHkuICBUaGlzIHdpbGwgYmUgZml4ZWQgc29vbi4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gYWxpZ24tdGl0bGUgV2hlcmUgdG8gYWxpZ24gdGhlIHRpdGxlLgogICAqIEF2YWlsYWJsZTogJ2xlZnQnLCAncmlnaHQnLCBvciAnY2VudGVyJy4gIERlZmF1bHRzIHRvICdjZW50ZXInLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG5vLXRhcC1zY3JvbGwgQnkgZGVmYXVsdCwgdGhlIGhlYWRlciBiYXIgd2lsbCBzY3JvbGwgdGhlCiAgICogY29udGVudCB0byB0aGUgdG9wIHdoZW4gdGFwcGVkLiAgU2V0IG5vLXRhcC1zY3JvbGwgdG8gdHJ1ZSB0byBkaXNhYmxlIHRoaXMKICAgKiBiZWhhdmlvci4KICAgKiBBdmFpbGFibGU6IHRydWUgb3IgZmFsc2UuICBEZWZhdWx0cyB0byBmYWxzZS4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8aW9uLWhlYWRlci1iYXIgYWxpZ24tdGl0bGU9ImxlZnQiIGNsYXNzPSJiYXItcG9zaXRpdmUiPgogICAqICAgPGRpdiBjbGFzcz0iYnV0dG9ucyI+CiAgICogICAgIDxidXR0b24gY2xhc3M9ImJ1dHRvbiIgbmctY2xpY2s9ImRvU29tZXRoaW5nKCkiPkxlZnQgQnV0dG9uPC9idXR0b24+CiAgICogICA8L2Rpdj4KICAgKiAgIDxoMSBjbGFzcz0idGl0bGUiPlRpdGxlITwvaDE+CiAgICogICA8ZGl2IGNsYXNzPSJidXR0b25zIj4KICAgKiAgICAgPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIj5SaWdodCBCdXR0b248L2J1dHRvbj4KICAgKiAgIDwvZGl2PgogICAqIDwvaW9uLWhlYWRlci1iYXI+CiAgICogPGlvbi1jb250ZW50PgogICAqICAgU29tZSBjb250ZW50IQogICAqIDwvaW9uLWNvbnRlbnQ+CiAgICogYGBgCiAgICovCiAgICAuZGlyZWN0aXZlKCdpb25IZWFkZXJCYXInLCBoZWFkZXJGb290ZXJCYXJEaXJlY3RpdmUodHJ1ZSkpCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25Gb290ZXJCYXIKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEFkZHMgYSBmaXhlZCBmb290ZXIgYmFyIGJlbG93IHNvbWUgY29udGVudC4KICAgKgogICAqIENhbiBhbHNvIGJlIGEgc3ViZm9vdGVyIChoaWdoZXIgdXApIGlmIHRoZSAnYmFyLXN1YmZvb3RlcicgY2xhc3MgaXMgYXBwbGllZC4KICAgKiBTZWUgW3RoZSBmb290ZXIgQ1NTIGRvY3NdKC9kb2NzL2NvbXBvbmVudHMvI2Zvb3RlcikuCiAgICoKICAgKiBOb3RlOiBJZiB5b3UgdXNlIGlvbkZvb3RlckJhciBpbiBjb21iaW5hdGlvbiB3aXRoIG5nLWlmLCB0aGUgc3Vycm91bmRpbmcgY29udGVudAogICAqIHdpbGwgbm90IGFsaWduIGNvcnJlY3RseS4gIFRoaXMgd2lsbCBiZSBmaXhlZCBzb29uLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBhbGlnbi10aXRsZSBXaGVyZSB0byBhbGlnbiB0aGUgdGl0bGUuCiAgICogQXZhaWxhYmxlOiAnbGVmdCcsICdyaWdodCcsIG9yICdjZW50ZXInLiAgRGVmYXVsdHMgdG8gJ2NlbnRlcicuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGlvbi1jb250ZW50PgogICAqICAgU29tZSBjb250ZW50IQogICAqIDwvaW9uLWNvbnRlbnQ+CiAgICogPGlvbi1mb290ZXItYmFyIGFsaWduLXRpdGxlPSJsZWZ0IiBjbGFzcz0iYmFyLWFzc2VydGl2ZSI+CiAgICogICA8ZGl2IGNsYXNzPSJidXR0b25zIj4KICAgKiAgICAgPGJ1dHRvbiBjbGFzcz0iYnV0dG9uIj5MZWZ0IEJ1dHRvbjwvYnV0dG9uPgogICAqICAgPC9kaXY+CiAgICogICA8aDEgY2xhc3M9InRpdGxlIj5UaXRsZSE8L2gxPgogICAqICAgPGRpdiBjbGFzcz0iYnV0dG9ucyIgbmctY2xpY2s9ImRvU29tZXRoaW5nKCkiPgogICAqICAgICA8YnV0dG9uIGNsYXNzPSJidXR0b24iPlJpZ2h0IEJ1dHRvbjwvYnV0dG9uPgogICAqICAgPC9kaXY+CiAgICogPC9pb24tZm9vdGVyLWJhcj4KICAgKiBgYGAKICAgKi8KICAgIC5kaXJlY3RpdmUoJ2lvbkZvb3RlckJhcicsIGhlYWRlckZvb3RlckJhckRpcmVjdGl2ZShmYWxzZSkpOwoKICBmdW5jdGlvbiB0YXBTY3JvbGxUb1RvcERpcmVjdGl2ZSgpIHsKICAgIHJldHVybiBbJyRpb25pY1Njcm9sbERlbGVnYXRlJywgZnVuY3Rpb24oJGlvbmljU2Nyb2xsRGVsZWdhdGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgICAgICBpZiAoJGF0dHIubm9UYXBTY3JvbGwgPT0gJ3RydWUnKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlvbmljLm9uKCd0YXAnLCBvblRhcCwgJGVsZW1lbnRbMF0pOwogICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW9uaWMub2ZmKCd0YXAnLCBvblRhcCwgJGVsZW1lbnRbMF0pOwogICAgICAgICAgfSk7CgogICAgICAgICAgZnVuY3Rpb24gb25UYXAoZSkgewogICAgICAgICAgICB2YXIgZGVwdGggPSAzOwogICAgICAgICAgICB2YXIgY3VycmVudCA9IGUudGFyZ2V0OwogICAgICAgICAgICAvL0Rvbid0IHNjcm9sbCB0byB0b3AgaW4gY2VydGFpbiBjYXNlcwogICAgICAgICAgICB3aGlsZSAoZGVwdGgtLSAmJiBjdXJyZW50KSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCdidXR0b24nKSB8fAogICAgICAgICAgICAgICAgY3VycmVudC50YWdOYW1lLm1hdGNoKC9pbnB1dHx0ZXh0YXJlYXxzZWxlY3QvaSkgfHwKICAgICAgICAgICAgICAgIGN1cnJlbnQuaXNDb250ZW50RWRpdGFibGUpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdG91Y2ggPSBlLmdlc3R1cmUgJiYgZS5nZXN0dXJlLnRvdWNoZXNbMF0gfHwgZS5kZXRhaWwudG91Y2hlc1swXTsKICAgICAgICAgICAgdmFyIGJvdW5kcyA9ICRlbGVtZW50WzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICBpZiAoaW9uaWMuRG9tVXRpbC5yZWN0Q29udGFpbnMoCiAgICAgICAgICAgICAgdG91Y2gucGFnZVgsIHRvdWNoLnBhZ2VZLAogICAgICAgICAgICAgIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wIC0gMjAsCiAgICAgICAgICAgICAgICBib3VuZHMubGVmdCArIGJvdW5kcy53aWR0aCwgYm91bmRzLnRvcCArIGJvdW5kcy5oZWlnaHQKICAgICAgICAgICAgKSkgewogICAgICAgICAgICAgICRpb25pY1Njcm9sbERlbGVnYXRlLnNjcm9sbFRvcCh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH1dOwogIH0KCiAgZnVuY3Rpb24gaGVhZGVyRm9vdGVyQmFyRGlyZWN0aXZlKGlzSGVhZGVyKSB7CiAgICByZXR1cm4gW2Z1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhpc0hlYWRlciA/ICdiYXIgYmFyLWhlYWRlcicgOiAnYmFyIGJhci1mb290ZXInKTsKICAgICAgICAgIHZhciBwYXJlbnQgPSAkZWxlbWVudFswXS5wYXJlbnROb2RlOwogICAgICAgICAgaWYocGFyZW50LnF1ZXJ5U2VsZWN0b3IoJy50YWJzLXRvcCcpKSRlbGVtZW50LmFkZENsYXNzKCdoYXMtdGFicy10b3AnKTsKICAgICAgICAgIHJldHVybiB7IHByZTogcHJlbGluayB9OwogICAgICAgICAgZnVuY3Rpb24gcHJlbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0cikgewogICAgICAgICAgICB2YXIgaGIgPSBuZXcgaW9uaWMudmlld3MuSGVhZGVyQmFyKHsKICAgICAgICAgICAgICBlbDogJGVsZW1lbnRbMF0sCiAgICAgICAgICAgICAgYWxpZ25UaXRsZTogJGF0dHIuYWxpZ25UaXRsZSB8fCAnY2VudGVyJwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHZhciBlbCA9ICRlbGVtZW50WzBdOwoKICAgICAgICAgICAgaWYgKGlzSGVhZGVyKSB7CiAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsgcmV0dXJuIGVsLmNsYXNzTmFtZTsgfSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBpc1Nob3duID0gdmFsdWUuaW5kZXhPZignbmctaGlkZScpID09PSAtMTsKICAgICAgICAgICAgICAgIHZhciBpc1N1YmhlYWRlciA9IHZhbHVlLmluZGV4T2YoJ2Jhci1zdWJoZWFkZXInKSAhPT0gLTE7CiAgICAgICAgICAgICAgICAkc2NvcGUuJGhhc0hlYWRlciA9IGlzU2hvd24gJiYgIWlzU3ViaGVhZGVyOwogICAgICAgICAgICAgICAgJHNjb3BlLiRoYXNTdWJoZWFkZXIgPSBpc1Nob3duICYmIGlzU3ViaGVhZGVyOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgJHNjb3BlLiRoYXNIZWFkZXI7CiAgICAgICAgICAgICAgICBkZWxldGUgJHNjb3BlLiRoYXNTdWJoZWFkZXI7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsgcmV0dXJuIGVsLmNsYXNzTmFtZTsgfSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBpc1Nob3duID0gdmFsdWUuaW5kZXhPZignbmctaGlkZScpID09PSAtMTsKICAgICAgICAgICAgICAgIHZhciBpc1N1YmZvb3RlciA9IHZhbHVlLmluZGV4T2YoJ2Jhci1zdWJmb290ZXInKSAhPT0gLTE7CiAgICAgICAgICAgICAgICAkc2NvcGUuJGhhc0Zvb3RlciA9IGlzU2hvd24gJiYgIWlzU3ViZm9vdGVyOwogICAgICAgICAgICAgICAgJHNjb3BlLiRoYXNTdWJmb290ZXIgPSBpc1Nob3duICYmIGlzU3ViZm9vdGVyOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgJHNjb3BlLiRoYXNGb290ZXI7CiAgICAgICAgICAgICAgICBkZWxldGUgJHNjb3BlLiRoYXNTdWJmb290ZXI7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnJGhhc1RhYnMnLCBmdW5jdGlvbih2YWwpIHsKICAgICAgICAgICAgICAgICRlbGVtZW50LnRvZ2dsZUNsYXNzKCdoYXMtdGFicycsICEhdmFsKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH1dOwogIH0KCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvbkluZmluaXRlU2Nyb2xsCiAgICogQG1vZHVsZSBpb25pYwogICAqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvbkNvbnRlbnQsIGlvbmljLmRpcmVjdGl2ZTppb25TY3JvbGwKICAgKiBAcmVzdHJpY3QgRQogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIGlvbkluZmluaXRlU2Nyb2xsIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIGNhbGwgYSBmdW5jdGlvbiB3aGVuZXZlcgogICAqIHRoZSB1c2VyIGdldHMgdG8gdGhlIGJvdHRvbSBvZiB0aGUgcGFnZSBvciBuZWFyIHRoZSBib3R0b20gb2YgdGhlIHBhZ2UuCiAgICoKICAgKiBUaGUgZXhwcmVzc2lvbiB5b3UgcGFzcyBpbiBmb3IgYG9uLWluZmluaXRlYCBpcyBjYWxsZWQgd2hlbiB0aGUgdXNlciBzY3JvbGxzCiAgICogZ3JlYXRlciB0aGFuIGBkaXN0YW5jZWAgYXdheSBmcm9tIHRoZSBib3R0b20gb2YgdGhlIGNvbnRlbnQuICBPbmNlIGBvbi1pbmZpbml0ZWAKICAgKiBpcyBkb25lIGxvYWRpbmcgbmV3IGRhdGEsIGl0IHNob3VsZCBicm9hZGNhc3QgdGhlIGBzY3JvbGwuaW5maW5pdGVTY3JvbGxDb21wbGV0ZWAKICAgKiBldmVudCBmcm9tIHlvdXIgY29udHJvbGxlciAoc2VlIGJlbG93IGV4YW1wbGUpLgogICAqCiAgICogQHBhcmFtIHtleHByZXNzaW9ufSBvbi1pbmZpbml0ZSBXaGF0IHRvIGNhbGwgd2hlbiB0aGUgc2Nyb2xsZXIgcmVhY2hlcyB0aGUKICAgKiBib3R0b20uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBkaXN0YW5jZSBUaGUgZGlzdGFuY2UgZnJvbSB0aGUgYm90dG9tIHRoYXQgdGhlIHNjcm9sbCBtdXN0CiAgICogcmVhY2ggdG8gdHJpZ2dlciB0aGUgb24taW5maW5pdGUgZXhwcmVzc2lvbi4gRGVmYXVsdDogMSUuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBpY29uIFRoZSBpY29uIHRvIHNob3cgd2hpbGUgbG9hZGluZy4gRGVmYXVsdDogJ2lvbi1sb2FkaW5nLWQnLgogICAqCiAgICogQHVzYWdlCiAgICogYGBgaHRtbAogICAqIDxpb24tY29udGVudCBuZy1jb250cm9sbGVyPSJNeUNvbnRyb2xsZXIiPgogICAqICAgPGlvbi1pbmZpbml0ZS1zY3JvbGwKICAgKiAgICAgb24taW5maW5pdGU9ImxvYWRNb3JlKCkiCiAgICogICAgIGRpc3RhbmNlPSIxJSI+CiAgICogICA8L2lvbi1pbmZpbml0ZS1zY3JvbGw+CiAgICogPC9pb24tY29udGVudD4KICAgKiBgYGAKICAgKiBgYGBqcwogICAqIGZ1bmN0aW9uIE15Q29udHJvbGxlcigkc2NvcGUsICRodHRwKSB7CiAqICAgJHNjb3BlLml0ZW1zID0gW107CiAqICAgJHNjb3BlLmxvYWRNb3JlID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaHR0cC5nZXQoJy9tb3JlLWl0ZW1zJykuc3VjY2VzcyhmdW5jdGlvbihpdGVtcykgewogKiAgICAgICB1c2VJdGVtcyhpdGVtcyk7CiAqICAgICAgICRzY29wZS4kYnJvYWRjYXN0KCdzY3JvbGwuaW5maW5pdGVTY3JvbGxDb21wbGV0ZScpOwogKiAgICAgfSk7CiAqICAgfTsKICoKICogICAkc2NvcGUuJG9uKCdzdGF0ZUNoYW5nZVN1Y2Nlc3MnLCBmdW5jdGlvbigpIHsKICogICAgICRzY29wZS5sb2FkTW9yZSgpOwogKiAgIH0pOwogKiB9CiAgICogYGBgCiAgICoKICAgKiBBbiBlYXN5IHRvIHdheSB0byBzdG9wIGluZmluaXRlIHNjcm9sbCBvbmNlIHRoZXJlIGlzIG5vIG1vcmUgZGF0YSB0byBsb2FkCiAgICogaXMgdG8gdXNlIGFuZ3VsYXIncyBgbmctaWZgIGRpcmVjdGl2ZToKICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLWluZmluaXRlLXNjcm9sbAogICAqICAgbmctaWY9Im1vcmVEYXRhQ2FuQmVMb2FkZWQoKSIKICAgKiAgIGljb249Imlvbi1sb2FkaW5nLWMiCiAgICogICBvbi1pbmZpbml0ZT0ibG9hZE1vcmVEYXRhKCkiPgogICAqIDwvaW9uLWluZmluaXRlLXNjcm9sbD4KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uSW5maW5pdGVTY3JvbGwnLCBbJyR0aW1lb3V0JywgZnVuY3Rpb24oJHRpbWVvdXQpIHsKICAgICAgZnVuY3Rpb24gY2FsY3VsYXRlTWF4VmFsdWUoZGlzdGFuY2UsIG1heGltdW0sIGlzUGVyY2VudCkgewogICAgICAgIHJldHVybiBpc1BlcmNlbnQgPwogICAgICAgICAgbWF4aW11bSAqICgxIC0gcGFyc2VGbG9hdChkaXN0YW5jZSwxMCkgLyAxMDApIDoKICAgICAgICAgIG1heGltdW0gLSBwYXJzZUZsb2F0KGRpc3RhbmNlLCAxMCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcXVpcmU6IFsnXiRpb25pY1Njcm9sbCcsICdpb25JbmZpbml0ZVNjcm9sbCddLAogICAgICAgIHRlbXBsYXRlOiAnPGkgY2xhc3M9Imljb24ge3tpY29uKCl9fSBpY29uLXJlZnJlc2hpbmciPjwvaT4nLAogICAgICAgIHNjb3BlOiB0cnVlLAogICAgICAgIGNvbnRyb2xsZXI6IFsnJHNjb3BlJywgJyRhdHRycycsIGZ1bmN0aW9uKCRzY29wZSwgJGF0dHJzKSB7CiAgICAgICAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgdGhpcy5zY3JvbGxWaWV3ID0gbnVsbDsgLy9naXZlbiBieSBsaW5rIGZ1bmN0aW9uCiAgICAgICAgICB0aGlzLmdldE1heFNjcm9sbCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgZGlzdGFuY2UgPSAoJGF0dHJzLmRpc3RhbmNlIHx8ICcyLjUlJykudHJpbSgpOwogICAgICAgICAgICB2YXIgaXNQZXJjZW50ID0gZGlzdGFuY2UuaW5kZXhPZignJScpICE9PSAtMTsKICAgICAgICAgICAgdmFyIG1heFZhbHVlcyA9IHRoaXMuc2Nyb2xsVmlldy5nZXRTY3JvbGxNYXgoKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBsZWZ0OiB0aGlzLnNjcm9sbFZpZXcub3B0aW9ucy5zY3JvbGxpbmdYID8KICAgICAgICAgICAgICAgIGNhbGN1bGF0ZU1heFZhbHVlKGRpc3RhbmNlLCBtYXhWYWx1ZXMubGVmdCwgaXNQZXJjZW50KSA6CiAgICAgICAgICAgICAgICAtMSwKICAgICAgICAgICAgICB0b3A6IHRoaXMuc2Nyb2xsVmlldy5vcHRpb25zLnNjcm9sbGluZ1kgPwogICAgICAgICAgICAgICAgY2FsY3VsYXRlTWF4VmFsdWUoZGlzdGFuY2UsIG1heFZhbHVlcy50b3AsIGlzUGVyY2VudCkgOgogICAgICAgICAgICAgICAgLTEKICAgICAgICAgICAgfTsKICAgICAgICAgIH07CiAgICAgICAgfV0sCiAgICAgICAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzLCBjdHJscykgewogICAgICAgICAgdmFyIHNjcm9sbEN0cmwgPSBjdHJsc1swXTsKICAgICAgICAgIHZhciBpbmZpbml0ZVNjcm9sbEN0cmwgPSBjdHJsc1sxXTsKICAgICAgICAgIHZhciBzY3JvbGxWaWV3ID0gaW5maW5pdGVTY3JvbGxDdHJsLnNjcm9sbFZpZXcgPSBzY3JvbGxDdHJsLnNjcm9sbFZpZXc7CgogICAgICAgICAgJHNjb3BlLmljb24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRycy5pY29uKSA/ICRhdHRycy5pY29uIDogJ2lvbi1sb2FkaW5nLWQnOwogICAgICAgICAgfTsKCiAgICAgICAgICB2YXIgb25JbmZpbml0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkZWxlbWVudFswXS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgaW5maW5pdGVTY3JvbGxDdHJsLmlzTG9hZGluZyA9IHRydWU7CiAgICAgICAgICAgICRzY29wZS4kcGFyZW50ICYmICRzY29wZS4kcGFyZW50LiRhcHBseSgkYXR0cnMub25JbmZpbml0ZSB8fCAnJyk7CiAgICAgICAgICB9OwoKICAgICAgICAgIHZhciBmaW5pc2hJbmZpbml0ZVNjcm9sbCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAkZWxlbWVudFswXS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgc2Nyb2xsVmlldy5yZXNpemUoKTsKICAgICAgICAgICAgICBjaGVja0JvdW5kcygpOwogICAgICAgICAgICB9LCAwLCBmYWxzZSk7CiAgICAgICAgICAgIGluZmluaXRlU2Nyb2xsQ3RybC5pc0xvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgIH07CgogICAgICAgICAgJHNjb3BlLiRvbignc2Nyb2xsLmluZmluaXRlU2Nyb2xsQ29tcGxldGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZmluaXNoSW5maW5pdGVTY3JvbGwoKTsKICAgICAgICAgIH0pOwoKICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHNjcm9sbEN0cmwuJGVsZW1lbnQub2ZmKCdzY3JvbGwnLCBjaGVja0JvdW5kcyk7CiAgICAgICAgICB9KTsKCiAgICAgICAgICB2YXIgY2hlY2tCb3VuZHMgPSBpb25pYy5hbmltYXRpb25GcmFtZVRocm90dGxlKGNoZWNrSW5maW5pdGVCb3VuZHMpOwoKICAgICAgICAgIC8vQ2hlY2sgYm91bmRzIG9uIHN0YXJ0LCBhZnRlciBzY3JvbGxWaWV3IGlzIGZ1bGx5IHJlbmRlcmVkCiAgICAgICAgICBzZXRUaW1lb3V0KGNoZWNrQm91bmRzKTsKICAgICAgICAgIHNjcm9sbEN0cmwuJGVsZW1lbnQub24oJ3Njcm9sbCcsIGNoZWNrQm91bmRzKTsKCiAgICAgICAgICBmdW5jdGlvbiBjaGVja0luZmluaXRlQm91bmRzKCkgewogICAgICAgICAgICBpZiAoaW5maW5pdGVTY3JvbGxDdHJsLmlzTG9hZGluZykgcmV0dXJuOwoKICAgICAgICAgICAgdmFyIHNjcm9sbFZhbHVlcyA9IHNjcm9sbFZpZXcuZ2V0VmFsdWVzKCk7CiAgICAgICAgICAgIHZhciBtYXhTY3JvbGwgPSBpbmZpbml0ZVNjcm9sbEN0cmwuZ2V0TWF4U2Nyb2xsKCk7CgogICAgICAgICAgICBpZiAoKG1heFNjcm9sbC5sZWZ0ICE9PSAtMSAmJiBzY3JvbGxWYWx1ZXMubGVmdCA+PSBtYXhTY3JvbGwubGVmdCkgfHwKICAgICAgICAgICAgICAobWF4U2Nyb2xsLnRvcCAhPT0gLTEgJiYgc2Nyb2xsVmFsdWVzLnRvcCA+PSBtYXhTY3JvbGwudG9wKSkgewogICAgICAgICAgICAgIG9uSW5maW5pdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH1dKTsKCiAgdmFyIElURU1fVFBMX0NPTlRFTlRfQU5DSE9SID0KICAgICc8YSBjbGFzcz0iaXRlbS1jb250ZW50IiBuZy1ocmVmPSJ7eyRocmVmKCl9fSIgdGFyZ2V0PSJ7eyR0YXJnZXQoKX19Ij48L2E+JzsKICB2YXIgSVRFTV9UUExfQ09OVEVOVCA9CiAgICAnPGRpdiBjbGFzcz0iaXRlbS1jb250ZW50Ij48L2Rpdj4nOwogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25JdGVtCiAgICogQHBhcmVudCBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgRQogICAqIENyZWF0ZXMgYSBsaXN0LWl0ZW0gdGhhdCBjYW4gZWFzaWx5IGJlIHN3aXBlZCwKICAgKiBkZWxldGVkLCByZW9yZGVyZWQsIGVkaXRlZCwgYW5kIG1vcmUuCiAgICoKICAgKiBTZWUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25MaXN0fSBmb3IgYSBjb21wbGV0ZSBleGFtcGxlICYgZXhwbGFuYXRpb24uCiAgICoKICAgKiBDYW4gYmUgYXNzaWduZWQgYW55IGl0ZW0gY2xhc3MgbmFtZS4gU2VlIHRoZQogICAqIFtsaXN0IENTUyBkb2N1bWVudGF0aW9uXSgvZG9jcy9jb21wb25lbnRzLyNsaXN0KS4KICAgKgogICAqIEB1c2FnZQogICAqCiAgICogYGBgaHRtbAogICAqIDxpb24tbGlzdD4KICAgKiAgIDxpb24taXRlbT5IZWxsbyE8L2lvbi1pdGVtPgogICAqIDwvaW9uLWxpc3Q+CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvbkl0ZW0nLCBbCiAgICAgICckYW5pbWF0ZScsCiAgICAgICckY29tcGlsZScsCiAgICAgIGZ1bmN0aW9uKCRhbmltYXRlLCAkY29tcGlsZSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50KSB7CiAgICAgICAgICAgIHRoaXMuJHNjb3BlID0gJHNjb3BlOwogICAgICAgICAgICB0aGlzLiRlbGVtZW50ID0gJGVsZW1lbnQ7CiAgICAgICAgICB9XSwKICAgICAgICAgIHNjb3BlOiB0cnVlLAogICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oJGVsZW1lbnQsICRhdHRycykgewogICAgICAgICAgICB2YXIgaXNBbmNob3IgPSBhbmd1bGFyLmlzRGVmaW5lZCgkYXR0cnMuaHJlZikgfHwKICAgICAgICAgICAgICBhbmd1bGFyLmlzRGVmaW5lZCgkYXR0cnMubmdIcmVmKSB8fAogICAgICAgICAgICAgIGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRycy51aVNyZWYpOwogICAgICAgICAgICB2YXIgaXNDb21wbGV4SXRlbSA9IGlzQW5jaG9yIHx8CiAgICAgICAgICAgICAgLy9MYW1lIHdheSBvZiB0ZXN0aW5nLCBidXQgd2UgaGF2ZSB0byBrbm93IGF0IGNvbXBpbGUgd2hhdCB0byBkbyB3aXRoIHRoZSBlbGVtZW50CiAgICAgICAgICAgICAgL2lvbi0oZGVsZXRlfG9wdGlvbnxyZW9yZGVyKS1idXR0b24vaS50ZXN0KCRlbGVtZW50Lmh0bWwoKSk7CgogICAgICAgICAgICBpZiAoaXNDb21wbGV4SXRlbSkgewogICAgICAgICAgICAgIHZhciBpbm5lckVsZW1lbnQgPSBqcUxpdGUoaXNBbmNob3IgPyBJVEVNX1RQTF9DT05URU5UX0FOQ0hPUiA6IElURU1fVFBMX0NPTlRFTlQpOwogICAgICAgICAgICAgIGlubmVyRWxlbWVudC5hcHBlbmQoJGVsZW1lbnQuY29udGVudHMoKSk7CgogICAgICAgICAgICAgICRlbGVtZW50LmFwcGVuZChpbm5lckVsZW1lbnQpOwogICAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKCdpdGVtIGl0ZW0tY29tcGxleCcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKCdpdGVtJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycykgewogICAgICAgICAgICAgICRzY29wZS4kaHJlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICRhdHRycy5ocmVmIHx8ICRhdHRycy5uZ0hyZWY7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAkc2NvcGUuJHRhcmdldCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuICRhdHRycy50YXJnZXQgfHwgJ19zZWxmJzsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH1dKTsKCgogIHZhciBJVEVNX1RQTF9ERUxFVEVfQlVUVE9OID0KICAgICc8ZGl2IGNsYXNzPSJpdGVtLWxlZnQtZWRpdCBpdGVtLWRlbGV0ZSBlbmFibGUtcG9pbnRlci1ldmVudHMiPicgKwogICAgJzwvZGl2Pic7CiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvbkRlbGV0ZUJ1dHRvbgogICAqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvbkl0ZW0KICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKiBDcmVhdGVzIGEgZGVsZXRlIGJ1dHRvbiBpbnNpZGUgYSBsaXN0IGl0ZW0sIHRoYXQgaXMgdmlzaWJsZSB3aGVuIHRoZQogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdCBpb25MaXN0IHBhcmVudCdzfSBgc2hvdy1kZWxldGVgIGV2YWx1YXRlcyB0byB0cnVlIG9yCiAgICogYCRpb25pY0xpc3REZWxlZ2F0ZS5zaG93RGVsZXRlKHRydWUpYCBpcyBjYWxsZWQuCiAgICoKICAgKiBUYWtlcyBhbnkgaW9uaWNvbiBhcyBhIGNsYXNzLgogICAqCiAgICogU2VlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdH0gZm9yIGEgY29tcGxldGUgZXhhbXBsZSAmIGV4cGxhbmF0aW9uLgogICAqCiAgICogQHVzYWdlCiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi1saXN0IHNob3ctZGVsZXRlPSJzaG91bGRTaG93RGVsZXRlIj4KICAgKiAgIDxpb24taXRlbT4KICAgKiAgICAgPGlvbi1kZWxldGUtYnV0dG9uIGNsYXNzPSJpb24tbWludXMtY2lyY2xlZCI+PC9pb24tZGVsZXRlLWJ1dHRvbj4KICAgKiAgICAgSGVsbG8sIGxpc3QgaXRlbSEKICAgKiAgIDwvaW9uLWl0ZW0+CiAgICogPC9pb24tbGlzdD4KICAgKiA8aW9uLXRvZ2dsZSBuZy1tb2RlbD0ic2hvdWxkU2hvd0RlbGV0ZSI+CiAgICogICBTaG93IERlbGV0ZT8KICAgKiA8L2lvbi10b2dnbGU+CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvbkRlbGV0ZUJ1dHRvbicsIFsnJGFuaW1hdGUnLCBmdW5jdGlvbigkYW5pbWF0ZSkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZTogWydeaW9uSXRlbScsICdeP2lvbkxpc3QnXSwKICAgICAgICAvL1J1biBiZWZvcmUgYW55dGhpbmcgZWxzZSwgc28gd2UgY2FuIG1vdmUgaXQgYmVmb3JlIG90aGVyIGRpcmVjdGl2ZXMgcHJvY2VzcwogICAgICAgIC8vaXRzIGxvY2F0aW9uIChlZyBuZ0lmIHJlbGllcyBvbiB0aGUgbG9jYXRpb24gb2YgdGhlIGRpcmVjdGl2ZSBpbiB0aGUgZG9tKQogICAgICAgIHByaW9yaXR5OiBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cikgewogICAgICAgICAgLy9BZGQgdGhlIGNsYXNzZXMgd2UgbmVlZCBkdXJpbmcgdGhlIGNvbXBpbGUgcGhhc2UsIHNvIHRoYXQgdGhleSBzdGF5CiAgICAgICAgICAvL2V2ZW4gaWYgc29tZXRoaW5nIGVsc2UgbGlrZSBuZ0lmIHJlbW92ZXMgdGhlIGVsZW1lbnQgYW5kIHJlLWFkZHNzIGl0CiAgICAgICAgICAkYXR0ci4kc2V0KCdjbGFzcycsICgkYXR0clsnY2xhc3MnXSB8fCAnJykgKyAnIGJ1dHRvbiBpY29uIGJ1dHRvbi1pY29uJywgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmxzKSB7CiAgICAgICAgICAgIHZhciBpdGVtQ3RybCA9IGN0cmxzWzBdOwogICAgICAgICAgICB2YXIgbGlzdEN0cmwgPSBjdHJsc1sxXTsKICAgICAgICAgICAgdmFyIGNvbnRhaW5lciA9IGpxTGl0ZShJVEVNX1RQTF9ERUxFVEVfQlVUVE9OKTsKICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZCgkZWxlbWVudCk7CiAgICAgICAgICAgIGl0ZW1DdHJsLiRlbGVtZW50LmFwcGVuZChjb250YWluZXIpLmFkZENsYXNzKCdpdGVtLWxlZnQtZWRpdGFibGUnKTsKCiAgICAgICAgICAgIGlmIChsaXN0Q3RybCAmJiBsaXN0Q3RybC5zaG93RGVsZXRlKCkpIHsKICAgICAgICAgICAgICBjb250YWluZXIuYWRkQ2xhc3MoJ3Zpc2libGUgYWN0aXZlJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9OwogICAgfV0pOwoKCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2l0ZW1GbG9hdGluZ0xhYmVsJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdDJywKICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCkgewogICAgICAgICAgdmFyIGVsID0gZWxlbWVudFswXTsKICAgICAgICAgIHZhciBpbnB1dCA9IGVsLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0LCB0ZXh0YXJlYScpOwogICAgICAgICAgdmFyIGlucHV0TGFiZWwgPSBlbC5xdWVyeVNlbGVjdG9yKCcuaW5wdXQtbGFiZWwnKTsKCiAgICAgICAgICBpZiAoICFpbnB1dCB8fCAhaW5wdXRMYWJlbCApIHJldHVybjsKCiAgICAgICAgICB2YXIgb25JbnB1dCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIGlucHV0LnZhbHVlICkgewogICAgICAgICAgICAgIGlucHV0TGFiZWwuY2xhc3NMaXN0LmFkZCgnaGFzLWlucHV0Jyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaW5wdXRMYWJlbC5jbGFzc0xpc3QucmVtb3ZlKCdoYXMtaW5wdXQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICBpbnB1dC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsIG9uSW5wdXQpOwoKICAgICAgICAgIHZhciBuZ01vZGVsQ3RybCA9IGFuZ3VsYXIuZWxlbWVudChpbnB1dCkuY29udHJvbGxlcignbmdNb2RlbCcpOwogICAgICAgICAgaWYgKCBuZ01vZGVsQ3RybCApIHsKICAgICAgICAgICAgbmdNb2RlbEN0cmwuJHJlbmRlciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gbmdNb2RlbEN0cmwuJHZpZXdWYWx1ZSB8fCAnJzsKICAgICAgICAgICAgICBvbklucHV0KCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CgogICAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbnB1dC5yZW1vdmVFdmVudExpc3RlbmVyKCdpbnB1dCcsIG9uSW5wdXQpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwogICAgfSk7CgogIHZhciBJVEVNX1RQTF9PUFRJT05fQlVUVE9OUyA9CiAgICAnPGRpdiBjbGFzcz0iaXRlbS1vcHRpb25zIGludmlzaWJsZSI+JyArCiAgICAnPC9kaXY+JzsKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgaW9uT3B0aW9uQnV0dG9uCiAgICogQHBhcmVudCBpb25pYy5kaXJlY3RpdmU6aW9uSXRlbQogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgRQogICAqIENyZWF0ZXMgYW4gb3B0aW9uIGJ1dHRvbiBpbnNpZGUgYSBsaXN0IGl0ZW0sIHRoYXQgaXMgdmlzaWJsZSB3aGVuIHRoZSBpdGVtIGlzIHN3aXBlZAogICAqIHRvIHRoZSBsZWZ0IGJ5IHRoZSB1c2VyLiAgU3dpcGVkIG9wZW4gb3B0aW9uIGJ1dHRvbnMgY2FuIGJlIGhpZGRlbiB3aXRoCiAgICoge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljTGlzdERlbGVnYXRlI2Nsb3NlT3B0aW9uQnV0dG9ucyAkaW9uaWNMaXN0RGVsZWdhdGUjY2xvc2VPcHRpb25CdXR0b25zfS4KICAgKgogICAqIENhbiBiZSBhc3NpZ25lZCBhbnkgYnV0dG9uIGNsYXNzLgogICAqCiAgICogU2VlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTGlzdH0gZm9yIGEgY29tcGxldGUgZXhhbXBsZSAmIGV4cGxhbmF0aW9uLgogICAqCiAgICogQHVzYWdlCiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi1saXN0PgogICAqICAgPGlvbi1pdGVtPgogICAqICAgICBJIGxvdmUga2l0dGVucyEKICAgKiAgICAgPGlvbi1vcHRpb24tYnV0dG9uIGNsYXNzPSJidXR0b24tcG9zaXRpdmUiPlNoYXJlPC9pb24tb3B0aW9uLWJ1dHRvbj4KICAgKiAgICAgPGlvbi1vcHRpb24tYnV0dG9uIGNsYXNzPSJidXR0b24tYXNzZXJ0aXZlIj5FZGl0PC9pb24tb3B0aW9uLWJ1dHRvbj4KICAgKiAgIDwvaW9uLWl0ZW0+CiAgICogPC9pb24tbGlzdD4KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uT3B0aW9uQnV0dG9uJywgWyckY29tcGlsZScsIGZ1bmN0aW9uKCRjb21waWxlKSB7CiAgICAgIGZ1bmN0aW9uIHN0b3BQcm9wYWdhdGlvbihlKSB7CiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZTogJ15pb25JdGVtJywKICAgICAgICBwcmlvcml0eTogTnVtYmVyLk1BWF9WQUxVRSwKICAgICAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgJGF0dHIpIHsKICAgICAgICAgICRhdHRyLiRzZXQoJ2NsYXNzJywgKCRhdHRyWydjbGFzcyddIHx8ICcnKSArICcgYnV0dG9uJywgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGl0ZW1DdHJsKSB7CiAgICAgICAgICAgIGlmICghaXRlbUN0cmwub3B0aW9uc0NvbnRhaW5lcikgewogICAgICAgICAgICAgIGl0ZW1DdHJsLm9wdGlvbnNDb250YWluZXIgPSBqcUxpdGUoSVRFTV9UUExfT1BUSU9OX0JVVFRPTlMpOwogICAgICAgICAgICAgIGl0ZW1DdHJsLiRlbGVtZW50LmFwcGVuZChpdGVtQ3RybC5vcHRpb25zQ29udGFpbmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpdGVtQ3RybC5vcHRpb25zQ29udGFpbmVyLmFwcGVuZCgkZWxlbWVudCk7CgogICAgICAgICAgICAvL0Rvbid0IGJ1YmJsZSBjbGljayB1cCB0byBtYWluIC5pdGVtCiAgICAgICAgICAgICRlbGVtZW50Lm9uKCdjbGljaycsIHN0b3BQcm9wYWdhdGlvbik7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfTsKICAgIH1dKTsKCiAgdmFyIElURU1fVFBMX1JFT1JERVJfQlVUVE9OID0KICAgICc8ZGl2IGRhdGEtcHJldmVudC1zY3JvbGw9InRydWUiIGNsYXNzPSJpdGVtLXJpZ2h0LWVkaXQgaXRlbS1yZW9yZGVyIGVuYWJsZS1wb2ludGVyLWV2ZW50cyI+JyArCiAgICAnPC9kaXY+JzsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvblJlb3JkZXJCdXR0b24KICAgKiBAcGFyZW50IGlvbmljLmRpcmVjdGl2ZTppb25JdGVtCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBFCiAgICogQ3JlYXRlcyBhIHJlb3JkZXIgYnV0dG9uIGluc2lkZSBhIGxpc3QgaXRlbSwgdGhhdCBpcyB2aXNpYmxlIHdoZW4gdGhlCiAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25MaXN0IGlvbkxpc3QgcGFyZW50J3N9IGBzaG93LXJlb3JkZXJgIGV2YWx1YXRlcyB0byB0cnVlIG9yCiAgICogYCRpb25pY0xpc3REZWxlZ2F0ZS5zaG93UmVvcmRlcih0cnVlKWAgaXMgY2FsbGVkLgogICAqCiAgICogQ2FuIGJlIGRyYWdnZWQgdG8gcmVvcmRlciBpdGVtcyBpbiB0aGUgbGlzdC4gVGFrZXMgYW55IGlvbmljb24gY2xhc3MuCiAgICoKICAgKiBOb3RlOiBSZW9yZGVyaW5nIHdvcmtzIGJlc3Qgd2hlbiB1c2VkIHdpdGggYG5nLXJlcGVhdGAuICBCZSBzdXJlIHRoYXQgYWxsIGBpb24taXRlbWAgY2hpbGRyZW4gb2YgYW4gYGlvbi1saXN0YCBhcmUgcGFydCBvZiB0aGUgc2FtZSBgbmctcmVwZWF0YCBleHByZXNzaW9uLgogICAqCiAgICogV2hlbiBhbiBpdGVtIHJlb3JkZXIgaXMgY29tcGxldGUsIHRoZSBleHByZXNzaW9uIGdpdmVuIGluIHRoZSBgb24tcmVvcmRlcmAgYXR0cmlidXRlIGlzIGNhbGxlZC4gVGhlIGBvbi1yZW9yZGVyYCBleHByZXNzaW9uIGlzIGdpdmVuIHR3byBsb2NhbHMgdGhhdCBjYW4gYmUgdXNlZDogYCRmcm9tSW5kZXhgIGFuZCBgJHRvSW5kZXhgLiAgU2VlIGJlbG93IGZvciBhbiBleGFtcGxlLgogICAqCiAgICogTG9vayBhdCB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkxpc3R9IGZvciBtb3JlIGV4YW1wbGVzLgogICAqCiAgICogQHVzYWdlCiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi1saXN0IG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+CiAgICogICA8aW9uLWl0ZW0gbmctcmVwZWF0PSJpdGVtIGluIGl0ZW1zIj4KICAgKiAgICAgSXRlbSB7e2l0ZW19fQogICAqICAgICA8aW9uLXJlb3JkZXItYnV0dG9uIGNsYXNzPSJpb24tbmF2aWNvbiIKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICBvbi1yZW9yZGVyPSJtb3ZlSXRlbShpdGVtLCAkZnJvbUluZGV4LCAkdG9JbmRleCkiPgogICAqICAgICA8L2lvbi1yZW9yZGVyPgogICAqICAgPC9pb24taXRlbT4KICAgKiA8L2lvbi1saXN0PgogICAqIGBgYAogICAqIGBgYGpzCiAgICogZnVuY3Rpb24gTXlDdHJsKCRzY29wZSkgewoqICAgJHNjb3BlLml0ZW1zID0gWzEsIDIsIDMsIDRdOwoqICAgJHNjb3BlLm1vdmVJdGVtID0gZnVuY3Rpb24oaXRlbSwgZnJvbUluZGV4LCB0b0luZGV4KSB7CiogICAgIC8vTW92ZSB0aGUgaXRlbSBpbiB0aGUgYXJyYXkKKiAgICAgJHNjb3BlLml0ZW1zLnNwbGljZShmcm9tSW5kZXgsIDEpOwoqICAgICAkc2NvcGUuaXRlbXMuc3BsaWNlKHRvSW5kZXgsIDAsIGl0ZW0pOwoqICAgfTsKKiB9CiAgICogYGBgCiAgICoKICAgKiBAcGFyYW0ge2V4cHJlc3Npb249fSBvbi1yZW9yZGVyIEV4cHJlc3Npb24gdG8gY2FsbCB3aGVuIGFuIGl0ZW0gaXMgcmVvcmRlcmVkLgogICAqIFBhcmFtZXRlcnMgZ2l2ZW46ICRmcm9tSW5kZXgsICR0b0luZGV4LgogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25SZW9yZGVyQnV0dG9uJywgWyckYW5pbWF0ZScsICckcGFyc2UnLCBmdW5jdGlvbigkYW5pbWF0ZSwgJHBhcnNlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXF1aXJlOiBbJ15pb25JdGVtJywgJ14/aW9uTGlzdCddLAogICAgICAgIHByaW9yaXR5OiBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50LCAkYXR0cikgewogICAgICAgICAgJGF0dHIuJHNldCgnY2xhc3MnLCAoJGF0dHJbJ2NsYXNzJ10gfHwgJycpICsgJyBidXR0b24gaWNvbiBidXR0b24taWNvbicsIHRydWUpOwogICAgICAgICAgJGVsZW1lbnRbMF0uc2V0QXR0cmlidXRlKCdkYXRhLXByZXZlbnQtc2Nyb2xsJywgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmxzKSB7CiAgICAgICAgICAgIHZhciBpdGVtQ3RybCA9IGN0cmxzWzBdOwogICAgICAgICAgICB2YXIgbGlzdEN0cmwgPSBjdHJsc1sxXTsKICAgICAgICAgICAgdmFyIG9uUmVvcmRlckZuID0gJHBhcnNlKCRhdHRyLm9uUmVvcmRlcik7CgogICAgICAgICAgICAkc2NvcGUuJG9uUmVvcmRlciA9IGZ1bmN0aW9uKG9sZEluZGV4LCBuZXdJbmRleCkgewogICAgICAgICAgICAgIG9uUmVvcmRlckZuKCRzY29wZSwgewogICAgICAgICAgICAgICAgJGZyb21JbmRleDogb2xkSW5kZXgsCiAgICAgICAgICAgICAgICAkdG9JbmRleDogbmV3SW5kZXgKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSBqcUxpdGUoSVRFTV9UUExfUkVPUkRFUl9CVVRUT04pOwogICAgICAgICAgICBjb250YWluZXIuYXBwZW5kKCRlbGVtZW50KTsKICAgICAgICAgICAgaXRlbUN0cmwuJGVsZW1lbnQuYXBwZW5kKGNvbnRhaW5lcikuYWRkQ2xhc3MoJ2l0ZW0tcmlnaHQtZWRpdGFibGUnKTsKCiAgICAgICAgICAgIGlmIChsaXN0Q3RybCAmJiBsaXN0Q3RybC5zaG93UmVvcmRlcigpKSB7CiAgICAgICAgICAgICAgY29udGFpbmVyLmFkZENsYXNzKCd2aXNpYmxlIGFjdGl2ZScpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfTsKICAgIH1dKTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGtleWJvYXJkQXR0YWNoCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBrZXlib2FyZC1hdHRhY2ggaXMgYW4gYXR0cmlidXRlIGRpcmVjdGl2ZSB3aGljaCB3aWxsIGNhdXNlIGFuIGVsZW1lbnQgdG8gZmxvYXQgYWJvdmUKICAgKiB0aGUga2V5Ym9hcmQgd2hlbiB0aGUga2V5Ym9hcmQgc2hvd3MuIEN1cnJlbnRseSBvbmx5IHN1cHBvcnRzIHRoZQogICAqIFtpb24tZm9vdGVyLWJhcl0oe3sgcGFnZS52ZXJzaW9uSHJlZiB9fS9hcGkvZGlyZWN0aXZlL2lvbkZvb3RlckJhci8pIGRpcmVjdGl2ZS4KICAgKgogICAqICMjIyBOb3RlcwogICAqIC0gVGhpcyBkaXJlY3RpdmUgcmVxdWlyZXMgdGhlCiAgICogW0lvbmljIEtleWJvYXJkIFBsdWdpbl0oaHR0cHM6Ly9naXRodWIuY29tL2RyaWZ0eWNvL2lvbmljLXBsdWdpbnMta2V5Ym9hcmQpLgogICAqIC0gT24gQW5kcm9pZCBub3QgaW4gZnVsbHNjcmVlbiBtb2RlLCBpLmUuIHlvdSBoYXZlCiAgICogICBgPHByZWZlcmVuY2UgbmFtZT0iRnVsbHNjcmVlbiIgdmFsdWU9ImZhbHNlIiAvPmAgb3Igbm8gcHJlZmVyZW5jZSBpbiB5b3VyIGBjb25maWcueG1sYCBmaWxlLAogICAqICAgdGhpcyBkaXJlY3RpdmUgaXMgdW5uZWNlc3Nhcnkgc2luY2UgaXQgaXMgdGhlIGRlZmF1bHQgYmVoYXZpb3IuCiAgICogLSBPbiBpT1MsIGlmIHRoZXJlIGlzIGFuIGlucHV0IGluIHlvdXIgZm9vdGVyLCB5b3Ugd2lsbCBuZWVkIHRvIHNldAogICAqICAgYGNvcmRvdmEucGx1Z2lucy5LZXlib2FyZC5kaXNhYmxlU2Nyb2xsKHRydWUpYC4KICAgKgogICAqIEB1c2FnZQogICAqCiAgICogYGBgaHRtbAogICAqICA8aW9uLWZvb3Rlci1iYXIgYWxpZ24tdGl0bGU9ImxlZnQiIGtleWJvYXJkLWF0dGFjaCBjbGFzcz0iYmFyLWFzc2VydGl2ZSI+CiAgICogICAgPGgxIGNsYXNzPSJ0aXRsZSI+VGl0bGUhPC9oMT4KICAgKiAgPC9pb24tZm9vdGVyLWJhcj4KICAgKiBgYGAKICAgKi8KCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2tleWJvYXJkQXR0YWNoJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICBpb25pYy5vbignbmF0aXZlLmtleWJvYXJkc2hvdycsIG9uU2hvdywgd2luZG93KTsKICAgICAgICBpb25pYy5vbignbmF0aXZlLmtleWJvYXJkaGlkZScsIG9uSGlkZSwgd2luZG93KTsKCiAgICAgICAgLy9kZXByZWNhdGVkCiAgICAgICAgaW9uaWMub24oJ25hdGl2ZS5zaG93a2V5Ym9hcmQnLCBvblNob3csIHdpbmRvdyk7CiAgICAgICAgaW9uaWMub24oJ25hdGl2ZS5oaWRla2V5Ym9hcmQnLCBvbkhpZGUsIHdpbmRvdyk7CgoKICAgICAgICB2YXIgc2Nyb2xsQ3RybDsKCiAgICAgICAgZnVuY3Rpb24gb25TaG93KGUpIHsKICAgICAgICAgIGlmIChpb25pYy5QbGF0Zm9ybS5pc0FuZHJvaWQoKSAmJiAhaW9uaWMuUGxhdGZvcm0uaXNGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICAvL2ZvciB0ZXN0aW5nCiAgICAgICAgICB2YXIga2V5Ym9hcmRIZWlnaHQgPSBlLmtleWJvYXJkSGVpZ2h0IHx8IGUuZGV0YWlsLmtleWJvYXJkSGVpZ2h0OwogICAgICAgICAgZWxlbWVudC5jc3MoJ2JvdHRvbScsIGtleWJvYXJkSGVpZ2h0ICsgInB4Iik7CiAgICAgICAgICBzY3JvbGxDdHJsID0gZWxlbWVudC5jb250cm9sbGVyKCckaW9uaWNTY3JvbGwnKTsKICAgICAgICAgIGlmICggc2Nyb2xsQ3RybCApIHsKICAgICAgICAgICAgc2Nyb2xsQ3RybC5zY3JvbGxWaWV3Ll9fY29udGFpbmVyLnN0eWxlLmJvdHRvbSA9IGtleWJvYXJkSGVpZ2h0ICsga2V5Ym9hcmRBdHRhY2hHZXRDbGllbnRIZWlnaHQoZWxlbWVudFswXSkgKyAicHgiOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gb25IaWRlKCkgewogICAgICAgICAgaWYgKGlvbmljLlBsYXRmb3JtLmlzQW5kcm9pZCgpICYmICFpb25pYy5QbGF0Zm9ybS5pc0Z1bGxTY3JlZW4pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIGVsZW1lbnQuY3NzKCdib3R0b20nLCAnJyk7CiAgICAgICAgICBpZiAoIHNjcm9sbEN0cmwgKSB7CiAgICAgICAgICAgIHNjcm9sbEN0cmwuc2Nyb2xsVmlldy5fX2NvbnRhaW5lci5zdHlsZS5ib3R0b20gPSAnJzsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgIGlvbmljLm9mZignbmF0aXZlLmtleWJvYXJkc2hvdycsIG9uU2hvdywgd2luZG93KTsKICAgICAgICAgIGlvbmljLm9mZignbmF0aXZlLmtleWJvYXJkaGlkZScsIG9uSGlkZSwgd2luZG93KTsKCiAgICAgICAgICAvL2RlcHJlY2F0ZWQKICAgICAgICAgIGlvbmljLm9mZignbmF0aXZlLnNob3drZXlib2FyZCcsIG9uU2hvdywgd2luZG93KTsKICAgICAgICAgIGlvbmljLm9mZignbmF0aXZlLmhpZGVrZXlib2FyZCcsIG9uSGlkZSwgd2luZG93KTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0pOwoKICBmdW5jdGlvbiBrZXlib2FyZEF0dGFjaEdldENsaWVudEhlaWdodChlbGVtZW50KSB7CiAgICByZXR1cm4gZWxlbWVudC5jbGllbnRIZWlnaHQ7CiAgfQoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgaW9uTGlzdAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVsZWdhdGUgaW9uaWMuc2VydmljZTokaW9uaWNMaXN0RGVsZWdhdGUKICAgKiBAY29kZXBlbiBKc0hqZgogICAqIEByZXN0cmljdCBFCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIExpc3QgaXMgYSB3aWRlbHkgdXNlZCBpbnRlcmZhY2UgZWxlbWVudCBpbiBhbG1vc3QgYW55IG1vYmlsZSBhcHAsIGFuZCBjYW4gaW5jbHVkZQogICAqIGNvbnRlbnQgcmFuZ2luZyBmcm9tIGJhc2ljIHRleHQgYWxsIHRoZSB3YXkgdG8gYnV0dG9ucywgdG9nZ2xlcywgaWNvbnMsIGFuZCB0aHVtYm5haWxzLgogICAqCiAgICogQm90aCB0aGUgbGlzdCwgd2hpY2ggY29udGFpbnMgaXRlbXMsIGFuZCB0aGUgbGlzdCBpdGVtcyB0aGVtc2VsdmVzIGNhbiBiZSBhbnkgSFRNTAogICAqIGVsZW1lbnQuIFRoZSBjb250YWluaW5nIGVsZW1lbnQgcmVxdWlyZXMgdGhlIGBsaXN0YCBjbGFzcyBhbmQgZWFjaCBsaXN0IGl0ZW0gcmVxdWlyZXMKICAgKiB0aGUgYGl0ZW1gIGNsYXNzLgogICAqCiAgICogSG93ZXZlciwgdXNpbmcgdGhlIGlvbkxpc3QgYW5kIGlvbkl0ZW0gZGlyZWN0aXZlcyBtYWtlIGl0IGVhc3kgdG8gc3VwcG9ydCB2YXJpb3VzCiAgICogaW50ZXJhY3Rpb24gbW9kZXMgc3VjaCBhcyBzd2lwZSB0byBlZGl0LCBkcmFnIHRvIHJlb3JkZXIsIGFuZCByZW1vdmluZyBpdGVtcy4KICAgKgogICAqIFJlbGF0ZWQ6IHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uSXRlbX0sIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uT3B0aW9uQnV0dG9ufQogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uUmVvcmRlckJ1dHRvbn0sIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uRGVsZXRlQnV0dG9ufSwgW2BsaXN0IENTUyBkb2N1bWVudGF0aW9uYF0oL2RvY3MvY29tcG9uZW50cy8jbGlzdCkuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIEJhc2ljIFVzYWdlOgogICAqCiAgICogYGBgaHRtbAogICAqIDxpb24tbGlzdD4KICAgKiAgIDxpb24taXRlbSBuZy1yZXBlYXQ9Iml0ZW0gaW4gaXRlbXMiPgogICAqICAgICB7JSByYXcgJX1IZWxsbywge3tpdGVtfX0heyUgZW5kcmF3ICV9CiAgICogICA8L2lvbi1pdGVtPgogICAqIDwvaW9uLWxpc3Q+CiAgICogYGBgCiAgICoKICAgKiBBZHZhbmNlZCBVc2FnZTogVGh1bWJuYWlscywgRGVsZXRlIGJ1dHRvbnMsIFJlb3JkZXJpbmcsIFN3aXBpbmcKICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLWxpc3QgbmctY29udHJvbGxlcj0iTXlDdHJsIgogICAqICAgICAgICAgICBzaG93LWRlbGV0ZT0ic2hvdWxkU2hvd0RlbGV0ZSIKICAgKiAgICAgICAgICAgc2hvdy1yZW9yZGVyPSJzaG91bGRTaG93UmVvcmRlciIKICAgKiAgICAgICAgICAgY2FuLXN3aXBlPSJsaXN0Q2FuU3dpcGUiPgogICAqICAgPGlvbi1pdGVtIG5nLXJlcGVhdD0iaXRlbSBpbiBpdGVtcyIKICAgKiAgICAgICAgICAgICBjbGFzcz0iaXRlbS10aHVtYm5haWwtbGVmdCI+CiAgICoKICAgKiAgICAgeyUgcmF3ICV9PGltZyBuZy1zcmM9Int7aXRlbS5pbWd9fSI+CiAgICogICAgIDxoMj57e2l0ZW0udGl0bGV9fTwvaDI+CiAgICogICAgIDxwPnt7aXRlbS5kZXNjcmlwdGlvbn19PC9wPnslIGVuZHJhdyAlfQogICAqICAgICA8aW9uLW9wdGlvbi1idXR0b24gY2xhc3M9ImJ1dHRvbi1wb3NpdGl2ZSIKICAgKiAgICAgICAgICAgICAgICAgICAgICAgIG5nLWNsaWNrPSJzaGFyZShpdGVtKSI+CiAgICogICAgICAgU2hhcmUKICAgKiAgICAgPC9pb24tb3B0aW9uLWJ1dHRvbj4KICAgKiAgICAgPGlvbi1vcHRpb24tYnV0dG9uIGNsYXNzPSJidXR0b24taW5mbyIKICAgKiAgICAgICAgICAgICAgICAgICAgICAgIG5nLWNsaWNrPSJlZGl0KGl0ZW0pIj4KICAgKiAgICAgICBFZGl0CiAgICogICAgIDwvaW9uLW9wdGlvbi1idXR0b24+CiAgICogICAgIDxpb24tZGVsZXRlLWJ1dHRvbiBjbGFzcz0iaW9uLW1pbnVzLWNpcmNsZWQiCiAgICogICAgICAgICAgICAgICAgICAgICAgICBuZy1jbGljaz0iaXRlbXMuc3BsaWNlKCRpbmRleCwgMSkiPgogICAqICAgICA8L2lvbi1kZWxldGUtYnV0dG9uPgogICAqICAgICA8aW9uLXJlb3JkZXItYnV0dG9uIGNsYXNzPSJpb24tbmF2aWNvbiIKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICBvbi1yZW9yZGVyPSJyZW9yZGVySXRlbShpdGVtLCAkZnJvbUluZGV4LCAkdG9JbmRleCkiPgogICAqICAgICA8L2lvbi1yZW9yZGVyLWJ1dHRvbj4KICAgKgogICAqICAgPC9pb24taXRlbT4KICAgKiA8L2lvbi1saXN0PgogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBkZWxlZ2F0ZS1oYW5kbGUgVGhlIGhhbmRsZSB1c2VkIHRvIGlkZW50aWZ5IHRoaXMgbGlzdCB3aXRoCiAgICoge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljTGlzdERlbGVnYXRlfS4KICAgKiBAcGFyYW0gdHlwZSB7c3RyaW5nPX0gVGhlIHR5cGUgb2YgbGlzdCB0byB1c2UgKGZvciBleGFtcGxlLCBsaXN0LWluc2V0IGZvciBhbiBpbnNldCBsaXN0KQogICAqIEBwYXJhbSBzaG93LWRlbGV0ZSB7Ym9vbGVhbj19IFdoZXRoZXIgdGhlIGRlbGV0ZSBidXR0b25zIGZvciB0aGUgaXRlbXMgaW4gdGhlIGxpc3QgYXJlCiAgICogY3VycmVudGx5IHNob3duIG9yIGhpZGRlbi4KICAgKiBAcGFyYW0gc2hvdy1yZW9yZGVyIHtib29sZWFuPX0gV2hldGhlciB0aGUgcmVvcmRlciBidXR0b25zIGZvciB0aGUgaXRlbXMgaW4gdGhlIGxpc3QgYXJlCiAgICogY3VycmVudGx5IHNob3duIG9yIGhpZGRlbi4KICAgKiBAcGFyYW0gY2FuLXN3aXBlIHtib29sZWFuPX0gV2hldGhlciB0aGUgaXRlbXMgaW4gdGhlIGxpc3QgYXJlIGFsbG93ZWQgdG8gYmUgc3dpcGVkIHRvIHJldmVhbAogICAqIG9wdGlvbiBidXR0b25zLiBEZWZhdWx0OiB0cnVlLgogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25MaXN0JywgWwogICAgICAnJGFuaW1hdGUnLAogICAgICAnJHRpbWVvdXQnLAogICAgICBmdW5jdGlvbigkYW5pbWF0ZSwgJHRpbWVvdXQpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgIHJlcXVpcmU6IFsnaW9uTGlzdCcsICdePyRpb25pY1Njcm9sbCddLAogICAgICAgICAgY29udHJvbGxlcjogJyRpb25pY0xpc3QnLAogICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgICAgICAgIHZhciBsaXN0RWwgPSBqcUxpdGUoJzxkaXYgY2xhc3M9Imxpc3QiPicpCiAgICAgICAgICAgICAgLmFwcGVuZCggJGVsZW1lbnQuY29udGVudHMoKSApCiAgICAgICAgICAgICAgLmFkZENsYXNzKCRhdHRyLnR5cGUpOwogICAgICAgICAgICAkZWxlbWVudC5hcHBlbmQobGlzdEVsKTsKCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsIGN0cmxzKSB7CiAgICAgICAgICAgICAgdmFyIGxpc3RDdHJsID0gY3RybHNbMF07CiAgICAgICAgICAgICAgdmFyIHNjcm9sbEN0cmwgPSBjdHJsc1sxXTsKCiAgICAgICAgICAgICAgLy9XYWl0IGZvciBjaGlsZCBlbGVtZW50cyB0byByZW5kZXIuLi4KICAgICAgICAgICAgICAkdGltZW91dChpbml0KTsKCiAgICAgICAgICAgICAgZnVuY3Rpb24gaW5pdCgpIHsKICAgICAgICAgICAgICAgIHZhciBsaXN0VmlldyA9IGxpc3RDdHJsLmxpc3RWaWV3ID0gbmV3IGlvbmljLnZpZXdzLkxpc3RWaWV3KHsKICAgICAgICAgICAgICAgICAgZWw6ICRlbGVtZW50WzBdLAogICAgICAgICAgICAgICAgICBsaXN0RWw6ICRlbGVtZW50LmNoaWxkcmVuKClbMF0sCiAgICAgICAgICAgICAgICAgIHNjcm9sbEVsOiBzY3JvbGxDdHJsICYmIHNjcm9sbEN0cmwuZWxlbWVudCwKICAgICAgICAgICAgICAgICAgc2Nyb2xsVmlldzogc2Nyb2xsQ3RybCAmJiBzY3JvbGxDdHJsLnNjcm9sbFZpZXcsCiAgICAgICAgICAgICAgICAgIG9uUmVvcmRlcjogZnVuY3Rpb24oZWwsIG9sZEluZGV4LCBuZXdJbmRleCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpdGVtU2NvcGUgPSBqcUxpdGUoZWwpLnNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1TY29wZSAmJiBpdGVtU2NvcGUuJG9uUmVvcmRlcikgewogICAgICAgICAgICAgICAgICAgICAgLy9NYWtlIHN1cmUgb25SZW9yZGVyIGlzIGNhbGxlZCBpbiBhcHBseSBjeWNsZSwKICAgICAgICAgICAgICAgICAgICAgIC8vYnV0IGFsc28gbWFrZSBzdXJlIGl0IGhhcyBubyBjb25mbGljdHMgYnkgZG9pbmcKICAgICAgICAgICAgICAgICAgICAgIC8vJGV2YWxBc3luYwogICAgICAgICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1TY29wZS4kb25SZW9yZGVyKG9sZEluZGV4LCBuZXdJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIGNhblN3aXBlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGlzdEN0cmwuY2FuU3dpcGVJdGVtcygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKCRhdHRyLmNhblN3aXBlKSkgewogICAgICAgICAgICAgICAgICAkc2NvcGUuJHdhdGNoKCchISgnICsgJGF0dHIuY2FuU3dpcGUgKyAnKScsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdEN0cmwuY2FuU3dpcGVJdGVtcyh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZCgkYXR0ci5zaG93RGVsZXRlKSkgewogICAgICAgICAgICAgICAgICAkc2NvcGUuJHdhdGNoKCchISgnICsgJGF0dHIuc2hvd0RlbGV0ZSArICcpJywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBsaXN0Q3RybC5zaG93RGVsZXRlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKCRhdHRyLnNob3dSZW9yZGVyKSkgewogICAgICAgICAgICAgICAgICAkc2NvcGUuJHdhdGNoKCchISgnICsgJGF0dHIuc2hvd1Jlb3JkZXIgKyAnKScsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgbGlzdEN0cmwuc2hvd1Jlb3JkZXIodmFsdWUpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbGlzdEN0cmwuc2hvd0RlbGV0ZSgpOwogICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oaXNTaG93biwgd2FzU2hvd24pIHsKICAgICAgICAgICAgICAgICAgLy9Pbmx5IHVzZSBpc1Nob3duPWZhbHNlIGlmIGl0IHdhcyBhbHJlYWR5IHNob3duCiAgICAgICAgICAgICAgICAgIGlmICghaXNTaG93biAmJiAhd2FzU2hvd24pIHsgcmV0dXJuOyB9CgogICAgICAgICAgICAgICAgICBpZiAoaXNTaG93bikgbGlzdEN0cmwuY2xvc2VPcHRpb25CdXR0b25zKCk7CiAgICAgICAgICAgICAgICAgIGxpc3RDdHJsLmNhblN3aXBlSXRlbXMoIWlzU2hvd24pOwoKICAgICAgICAgICAgICAgICAgJGVsZW1lbnQuY2hpbGRyZW4oKS50b2dnbGVDbGFzcygnbGlzdC1sZWZ0LWVkaXRpbmcnLCBpc1Nob3duKTsKICAgICAgICAgICAgICAgICAgJGVsZW1lbnQudG9nZ2xlQ2xhc3MoJ2Rpc2FibGUtcG9pbnRlci1ldmVudHMnLCBpc1Nob3duKTsKCiAgICAgICAgICAgICAgICAgIHZhciBkZWxldGVCdXR0b24gPSBqcUxpdGUoJGVsZW1lbnRbMF0uZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnaXRlbS1kZWxldGUnKSk7CiAgICAgICAgICAgICAgICAgIHNldEJ1dHRvblNob3duKGRlbGV0ZUJ1dHRvbiwgbGlzdEN0cmwuc2hvd0RlbGV0ZSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbGlzdEN0cmwuc2hvd1Jlb3JkZXIoKTsKICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGlzU2hvd24sIHdhc1Nob3duKSB7CiAgICAgICAgICAgICAgICAgIC8vT25seSB1c2UgaXNTaG93bj1mYWxzZSBpZiBpdCB3YXMgYWxyZWFkeSBzaG93bgogICAgICAgICAgICAgICAgICBpZiAoIWlzU2hvd24gJiYgIXdhc1Nob3duKSB7IHJldHVybjsgfQoKICAgICAgICAgICAgICAgICAgaWYgKGlzU2hvd24pIGxpc3RDdHJsLmNsb3NlT3B0aW9uQnV0dG9ucygpOwogICAgICAgICAgICAgICAgICBsaXN0Q3RybC5jYW5Td2lwZUl0ZW1zKCFpc1Nob3duKTsKCiAgICAgICAgICAgICAgICAgICRlbGVtZW50LmNoaWxkcmVuKCkudG9nZ2xlQ2xhc3MoJ2xpc3QtcmlnaHQtZWRpdGluZycsIGlzU2hvd24pOwogICAgICAgICAgICAgICAgICAkZWxlbWVudC50b2dnbGVDbGFzcygnZGlzYWJsZS1wb2ludGVyLWV2ZW50cycsIGlzU2hvd24pOwoKICAgICAgICAgICAgICAgICAgdmFyIHJlb3JkZXJCdXR0b24gPSBqcUxpdGUoJGVsZW1lbnRbMF0uZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnaXRlbS1yZW9yZGVyJykpOwogICAgICAgICAgICAgICAgICBzZXRCdXR0b25TaG93bihyZW9yZGVyQnV0dG9uLCBsaXN0Q3RybC5zaG93UmVvcmRlcik7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzZXRCdXR0b25TaG93bihlbCwgc2hvd24pIHsKICAgICAgICAgICAgICAgICAgc2hvd24oKSAmJiBlbC5hZGRDbGFzcygndmlzaWJsZScpIHx8IGVsLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHNob3duKCkgJiYgZWwuYWRkQ2xhc3MoJ2FjdGl2ZScpIHx8IGVsLnJlbW92ZUNsYXNzKCdpbnZpc2libGUnKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBtZW51Q2xvc2UKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEFDCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDbG9zZXMgYSBzaWRlIG1lbnUgd2hpY2ggaXMgY3VycmVudGx5IG9wZW5lZC4KICAgKgogICAqIEB1c2FnZQogICAqIEJlbG93IGlzIGFuIGV4YW1wbGUgb2YgYSBsaW5rIHdpdGhpbiBhIHNpZGUgbWVudS4gVGFwcGluZyB0aGlzIGxpbmsgd291bGQKICAgKiBhdXRvbWF0aWNhbGx5IGNsb3NlIHRoZSBjdXJyZW50bHkgb3BlbmVkIG1lbnUuCiAgICoKICAgKiBgYGBodG1sCiAgICogPGEgbWVudS1jbG9zZSBocmVmPSIjL2hvbWUiIGNsYXNzPSJpdGVtIj5Ib21lPC9hPgogICAqIGBgYAogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdtZW51Q2xvc2UnLCBbJyRpb25pY1ZpZXdTZXJ2aWNlJywgZnVuY3Rpb24oJGlvbmljVmlld1NlcnZpY2UpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0FDJywKICAgICAgICByZXF1aXJlOiAnXmlvblNpZGVNZW51cycsCiAgICAgICAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNpZGVNZW51Q3RybCkgewogICAgICAgICAgJGVsZW1lbnQuYmluZCgnY2xpY2snLCBmdW5jdGlvbigpewogICAgICAgICAgICBzaWRlTWVudUN0cmwuY2xvc2UoKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfTsKICAgIH1dKTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG1lbnVUb2dnbGUKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEFDCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUb2dnbGUgYSBzaWRlIG1lbnUgb24gdGhlIGdpdmVuIHNpZGUKICAgKgogICAqIEB1c2FnZQogICAqIEJlbG93IGlzIGFuIGV4YW1wbGUgb2YgYSBsaW5rIHdpdGhpbiBhIG5hdiBiYXIuIFRhcHBpbmcgdGhpcyBsaW5rIHdvdWxkCiAgICogYXV0b21hdGljYWxseSBvcGVuIHRoZSBnaXZlbiBzaWRlIG1lbnUKICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLXZpZXc+CiAgICogICA8aW9uLW5hdi1idXR0b25zIHNpZGU9ImxlZnQiPgogICAqICAgIDxidXR0b24gbWVudS10b2dnbGU9ImxlZnQiIGNsYXNzPSJidXR0b24gYnV0dG9uLWljb24gaWNvbiBpb24tbmF2aWNvbiI+PC9idXR0b24+CiAgICogICA8L2lvbi1uYXYtYnV0dG9ucz4KICAgKiAgLi4uCiAgICogPC9pb24tdmlldz4KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnbWVudVRvZ2dsZScsIFsnJGlvbmljVmlld1NlcnZpY2UnLCBmdW5jdGlvbigkaW9uaWNWaWV3U2VydmljZSkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnQUMnLAogICAgICAgIHJlcXVpcmU6ICdeaW9uU2lkZU1lbnVzJywKICAgICAgICBsaW5rOiBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgc2lkZU1lbnVDdHJsKSB7CiAgICAgICAgICB2YXIgc2lkZSA9ICRhdHRyLm1lbnVUb2dnbGUgfHwgJ2xlZnQnOwogICAgICAgICAgJGVsZW1lbnQuYmluZCgnY2xpY2snLCBmdW5jdGlvbigpewogICAgICAgICAgICBpZihzaWRlID09PSAnbGVmdCcpIHsKICAgICAgICAgICAgICBzaWRlTWVudUN0cmwudG9nZ2xlTGVmdCgpOwogICAgICAgICAgICB9IGVsc2UgaWYoc2lkZSA9PT0gJ3JpZ2h0JykgewogICAgICAgICAgICAgIHNpZGVNZW51Q3RybC50b2dnbGVSaWdodCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH07CiAgICB9XSk7CgoKICAvKgogICAqIFdlIGRvbid0IGRvY3VtZW50IHRoZSBpb25Nb2RhbCBkaXJlY3RpdmUsIHdlIGluc3RlYWQgZG9jdW1lbnQKICAgKiB0aGUgJGlvbmljTW9kYWwgc2VydmljZQogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25Nb2RhbCcsIFtmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICBjb250cm9sbGVyOiBbZnVuY3Rpb24oKXt9XSwKICAgICAgICB0ZW1wbGF0ZTogJzxkaXYgY2xhc3M9Im1vZGFsLWJhY2tkcm9wIj4nICsKICAgICAgICAgICc8ZGl2IGNsYXNzPSJtb2RhbC13cmFwcGVyIiBuZy10cmFuc2NsdWRlPjwvZGl2PicgKwogICAgICAgICAgJzwvZGl2PicKICAgICAgfTsKICAgIH1dKTsKCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvbk1vZGFsVmlldycsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbW9kYWwnKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvbk5hdkJhY2tCdXR0b24KICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKiBAcGFyZW50IGlvbk5hdkJhcgogICAqIEBkZXNjcmlwdGlvbgogICAqIENyZWF0ZXMgYSBiYWNrIGJ1dHRvbiBpbnNpZGUgYW4ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9LgogICAqCiAgICogV2lsbCBzaG93IHVwIHdoZW4gdGhlIHVzZXIgaXMgYWJsZSB0byBnbyBiYWNrIGluIHRoZSBjdXJyZW50IG5hdmlnYXRpb24gc3RhY2suCiAgICoKICAgKiBCeSBkZWZhdWx0LCB3aWxsIGdvIGJhY2sgd2hlbiBjbGlja2VkLiAgSWYgeW91IHdpc2ggZm9yIG1vcmUgYWR2YW5jZWQgYmVoYXZpb3IsIHNlZSB0aGUKICAgKiBleGFtcGxlcyBiZWxvdy4KICAgKgogICAqIEB1c2FnZQogICAqCiAgICogV2l0aCBkZWZhdWx0IGNsaWNrIGFjdGlvbjoKICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLW5hdi1iYXI+CiAgICogICA8aW9uLW5hdi1iYWNrLWJ1dHRvbiBjbGFzcz0iYnV0dG9uLWNsZWFyIj4KICAgKiAgICAgPGkgY2xhc3M9Imlvbi1hcnJvdy1sZWZ0LWMiPjwvaT4gQmFjawogICAqICAgPC9pb24tbmF2LWJhY2stYnV0dG9uPgogICAqIDwvaW9uLW5hdi1iYXI+CiAgICogYGBgCiAgICoKICAgKiBXaXRoIGN1c3RvbSBjbGljayBhY3Rpb24sIHVzaW5nIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY05hdkJhckRlbGVnYXRlfToKICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLW5hdi1iYXIgbmctY29udHJvbGxlcj0iTXlDdHJsIj4KICAgKiAgIDxpb24tbmF2LWJhY2stYnV0dG9uIGNsYXNzPSJidXR0b24tY2xlYXIiCiAgICogICAgIG5nLWNsaWNrPSJnb0JhY2soKSI+CiAgICogICAgIDxpIGNsYXNzPSJpb24tYXJyb3ctbGVmdC1jIj48L2k+IEJhY2sKICAgKiAgIDwvaW9uLW5hdi1iYWNrLWJ1dHRvbj4KICAgKiA8L2lvbi1uYXYtYmFyPgogICAqIGBgYAogICAqIGBgYGpzCiAgICogZnVuY3Rpb24gTXlDdHJsKCRzY29wZSwgJGlvbmljTmF2QmFyRGVsZWdhdGUpIHsKICogICAkc2NvcGUuZ29CYWNrID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaW9uaWNOYXZCYXJEZWxlZ2F0ZS5iYWNrKCk7CiAqICAgfTsKICogfQogICAqIGBgYAogICAqCiAgICogRGlzcGxheWluZyB0aGUgcHJldmlvdXMgdGl0bGUgb24gdGhlIGJhY2sgYnV0dG9uLCBhZ2FpbiB1c2luZwogICAqIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY05hdkJhckRlbGVnYXRlfS4KICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLW5hdi1iYXIgbmctY29udHJvbGxlcj0iTXlDdHJsIj4KICAgKiAgIDxpb24tbmF2LWJhY2stYnV0dG9uIGNsYXNzPSJidXR0b24taWNvbiI+CiAgICogICAgIDxpIGNsYXNzPSJpY29uIGlvbi1hcnJvdy1sZWZ0LWMiPjwvaT57JSByYXcgJX17e2dldFByZXZpb3VzVGl0bGUoKSB8fCAnQmFjayd9fXslIGVuZHJhdyAlfQogICAqICAgPC9pb24tbmF2LWJhY2stYnV0dG9uPgogICAqIDwvaW9uLW5hdi1iYXI+CiAgICogYGBgCiAgICogYGBganMKICAgKiBmdW5jdGlvbiBNeUN0cmwoJHNjb3BlLCAkaW9uaWNOYXZCYXJEZWxlZ2F0ZSkgewogKiAgICRzY29wZS5nZXRQcmV2aW91c1RpdGxlID0gZnVuY3Rpb24oKSB7CiAqICAgICByZXR1cm4gJGlvbmljTmF2QmFyRGVsZWdhdGUuZ2V0UHJldmlvdXNUaXRsZSgpOwogKiAgIH07CiAqIH0KICAgKiBgYGAKICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uTmF2QmFja0J1dHRvbicsIFsKICAgICAgJyRhbmltYXRlJywKICAgICAgJyRyb290U2NvcGUnLAogICAgICAnJHNhbml0aXplJywKICAgICAgJyRpb25pY05hdkJhckNvbmZpZycsCiAgICAgICckaW9uaWNOZ0NsaWNrJywKICAgICAgZnVuY3Rpb24oJGFuaW1hdGUsICRyb290U2NvcGUsICRzYW5pdGl6ZSwgJGlvbmljTmF2QmFyQ29uZmlnLCAkaW9uaWNOZ0NsaWNrKSB7CiAgICAgICAgdmFyIGJhY2tJc1Nob3duID0gZmFsc2U7CiAgICAgICAgLy9JZiB0aGUgY3VycmVudCB2aWV3c3RhdGUgZG9lcyBub3QgYWxsb3cgYSBiYWNrIGJ1dHRvbiwKICAgICAgICAvL2Fsd2F5cyBoaWRlIGl0LgogICAgICAgICRyb290U2NvcGUuJG9uKCckdmlld0hpc3RvcnkuaGlzdG9yeUNoYW5nZScsIGZ1bmN0aW9uKGUsIGRhdGEpIHsKICAgICAgICAgIGJhY2tJc1Nob3duID0gISFkYXRhLnNob3dCYWNrOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgcmVxdWlyZTogJ15pb25OYXZCYXInLAogICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycykgewogICAgICAgICAgICB0RWxlbWVudC5hZGRDbGFzcygnYnV0dG9uIGJhY2stYnV0dG9uIG5nLWhpZGUnKTsKCiAgICAgICAgICAgIHZhciBoYXNJY29uQ2hpbGQgPSAhISh0RWxlbWVudC5odG1sKCkgfHwgJycpLm1hdGNoKC9jbGFzcz0uKj9pb24tLyk7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIG5hdkJhckN0cmwpIHsKCiAgICAgICAgICAgICAgLy8gQWRkIGEgZGVmYXVsdCBiYWNrIGJ1dHRvbiBpY29uIGJhc2VkIG9uIHRoZSBuYXYgY29uZmlnLCB1bmxlc3Mgb25lIGlzIHNldAogICAgICAgICAgICAgIGlmICghaGFzSWNvbkNoaWxkICYmICRlbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCdpb24tJykgPT09IC0xKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcygkaW9uaWNOYXZCYXJDb25maWcuYmFja0J1dHRvbkljb24pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy9EZWZhdWx0IHRvIG5nQ2xpY2sgZ29pbmcgYmFjaywgYnV0IGRvbid0IG92ZXJyaWRlIGEgY3VzdG9tIG9uZQogICAgICAgICAgICAgIGlmICghaXNEZWZpbmVkKCRhdHRyLm5nQ2xpY2spKSB7CiAgICAgICAgICAgICAgICAkaW9uaWNOZ0NsaWNrKCRzY29wZSwgJGVsZW1lbnQsIG5hdkJhckN0cmwuYmFjayk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvL01ha2Ugc3VyZSBib3RoIHRoYXQgYSBiYWNrQnV0dG9uIGlzIGFsbG93ZWQgaW4gdGhlIGZpcnN0IHBsYWNlLAogICAgICAgICAgICAgIC8vYW5kIHRoYXQgaXQgaXMgc2hvd24gYnkgdGhlIGN1cnJlbnQgdmlldy4KICAgICAgICAgICAgICAkc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYoaXNEZWZpbmVkKCRhdHRyLmZyb21UaXRsZSkpIHsKICAgICAgICAgICAgICAgICAgJGVsZW1lbnRbMF0uaW5uZXJIVE1MID0gJzxzcGFuIGNsYXNzPSJiYWNrLWJ1dHRvbi10aXRsZSI+JyArICRzYW5pdGl6ZSgkc2NvcGUub2xkVGl0bGUpICsgJzwvc3Bhbj4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuICEhKGJhY2tJc1Nob3duICYmICRzY29wZS5iYWNrQnV0dG9uU2hvd24pOwogICAgICAgICAgICAgIH0sIGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoZnVuY3Rpb24oc2hvdykgewogICAgICAgICAgICAgICAgaWYgKHNob3cpICRhbmltYXRlLnJlbW92ZUNsYXNzKCRlbGVtZW50LCAnbmctaGlkZScpOwogICAgICAgICAgICAgICAgZWxzZSAkYW5pbWF0ZS5hZGRDbGFzcygkZWxlbWVudCwgJ25nLWhpZGUnKTsKICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfV0pOwoKCiAgSW9uaWNNb2R1bGUuY29uc3RhbnQoJyRpb25pY05hdkJhckNvbmZpZycsIHsKICAgIHRyYW5zaXRpb246ICduYXYtdGl0bGUtc2xpZGUtaW9zNycsCiAgICBhbGlnblRpdGxlOiAnY2VudGVyJywKICAgIGJhY2tCdXR0b25JY29uOiAnaW9uLWlvczctYXJyb3ctYmFjaycKICB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvbk5hdkJhcgogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVsZWdhdGUgaW9uaWMuc2VydmljZTokaW9uaWNOYXZCYXJEZWxlZ2F0ZQogICAqIEByZXN0cmljdCBFCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBJZiB3ZSBoYXZlIGFuIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2Vmlld30gZGlyZWN0aXZlLCB3ZSBjYW4gYWxzbyBjcmVhdGUgYW4KICAgKiBgPGlvbi1uYXYtYmFyPmAsIHdoaWNoIHdpbGwgY3JlYXRlIGEgdG9wYmFyIHRoYXQgdXBkYXRlcyBhcyB0aGUgYXBwbGljYXRpb24gc3RhdGUgY2hhbmdlcy4KICAgKgogICAqIFdlIGNhbiBhZGQgYSBiYWNrIGJ1dHRvbiBieSBwdXR0aW5nIGFuIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFja0J1dHRvbn0gaW5zaWRlLgogICAqCiAgICogV2UgY2FuIGFkZCBidXR0b25zIGRlcGVuZGluZyBvbiB0aGUgY3VycmVudGx5IHZpc2libGUgdmlldyB1c2luZwogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QnV0dG9uc30uCiAgICoKICAgKiBBZGQgYW4gW2FuaW1hdGlvbiBjbGFzc10oL2RvY3MvY29tcG9uZW50cyNhbmltYXRpb25zKSB0byB0aGUgZWxlbWVudCB2aWEgdGhlCiAgICogYGFuaW1hdGlvbmAgYXR0cmlidXRlIHRvIGVuYWJsZSBhbmltYXRlZCBjaGFuZ2luZyBvZiB0aXRsZXMKICAgKiAocmVjb21tZW5kZWQ6ICduYXYtdGl0bGUtc2xpZGUtaW9zNycpLgogICAqCiAgICogTm90ZSB0aGF0IHRoZSBpb24tbmF2LWJhciBlbGVtZW50IHdpbGwgb25seSB3b3JrIGNvcnJlY3RseSBpZiB5b3VyIGNvbnRlbnQgaGFzIGFuCiAgICogaW9uVmlldyBhcm91bmQgaXQuCiAgICoKICAgKiBAdXNhZ2UKICAgKgogICAqIGBgYGh0bWwKICAgKiA8Ym9keSBuZy1hcHA9InN0YXJ0ZXIiPgogICAqICAgPCEtLSBUaGUgbmF2IGJhciB0aGF0IHdpbGwgYmUgdXBkYXRlZCBhcyB3ZSBuYXZpZ2F0ZSAtLT4KICAgKiAgIDxpb24tbmF2LWJhciBjbGFzcz0iYmFyLXBvc2l0aXZlIiBhbmltYXRpb249Im5hdi10aXRsZS1zbGlkZS1pb3M3Ij4KICAgKiAgIDwvaW9uLW5hdi1iYXI+CiAgICoKICAgKiAgIDwhLS0gd2hlcmUgdGhlIGluaXRpYWwgdmlldyB0ZW1wbGF0ZSB3aWxsIGJlIHJlbmRlcmVkIC0tPgogICAqICAgPGlvbi1uYXYtdmlldz4KICAgKiAgICAgPGlvbi12aWV3PgogICAqICAgICAgIDxpb24tY29udGVudD5IZWxsbyE8L2lvbi1jb250ZW50PgogICAqICAgICA8L2lvbi12aWV3PgogICAqICAgPC9pb24tbmF2LXZpZXc+CiAgICogPC9ib2R5PgogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBkZWxlZ2F0ZS1oYW5kbGUgVGhlIGhhbmRsZSB1c2VkIHRvIGlkZW50aWZ5IHRoaXMgbmF2QmFyCiAgICogd2l0aCB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNOYXZCYXJEZWxlZ2F0ZX0uCiAgICogQHBhcmFtIGFsaWduLXRpdGxlIHtzdHJpbmc9fSBXaGVyZSB0byBhbGlnbiB0aGUgdGl0bGUgb2YgdGhlIG5hdmJhci4KICAgKiBBdmFpbGFibGU6ICdsZWZ0JywgJ3JpZ2h0JywgJ2NlbnRlcicuIERlZmF1bHRzIHRvICdjZW50ZXInLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IG5vLXRhcC1zY3JvbGwgQnkgZGVmYXVsdCwgdGhlIG5hdmJhciB3aWxsIHNjcm9sbCB0aGUgY29udGVudAogICAqIHRvIHRoZSB0b3Agd2hlbiB0YXBwZWQuICBTZXQgbm8tdGFwLXNjcm9sbCB0byB0cnVlIHRvIGRpc2FibGUgdGhpcyBiZWhhdmlvci4KICAgKgogICAqIDwvdGFibGU+PGJyLz4KICAgKgogICAqICMjIyBBbHRlcm5hdGl2ZSBVc2FnZQogICAqCiAgICogQWx0ZXJuYXRpdmVseSwgeW91IG1heSBwdXQgaW9uLW5hdi1iYXIgaW5zaWRlIG9mIGVhY2ggaW5kaXZpZHVhbCB2aWV3J3MgaW9uLXZpZXcgZWxlbWVudC4KICAgKiBUaGlzIHdpbGwgYWxsb3cgeW91IHRvIGhhdmUgdGhlIHdob2xlIG5hdmJhciwgbm90IGp1c3QgaXRzIGNvbnRlbnRzLCB0cmFuc2l0aW9uIGV2ZXJ5IHZpZXcgY2hhbmdlLgogICAqCiAgICogVGhpcyBpcyBzaW1pbGFyIHRvIHVzaW5nIGEgaGVhZGVyIGJhciBpbnNpZGUgeW91ciBpb24tdmlldywgZXhjZXB0IGl0IHdpbGwgaGF2ZSBhbGwgdGhlIHBvd2VyIG9mIGEgbmF2YmFyLgogICAqCiAgICogSWYgeW91IGRvIHRoaXMsIHNpbXBseSBwdXQgbmF2IGJ1dHRvbnMgaW5zaWRlIHRoZSBuYXZiYXIgaXRzZWxmOyBkbyBub3QgdXNlIGA8aW9uLW5hdi1idXR0b25zPmAuCiAgICoKICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLXZpZXcgdGl0bGU9Im15VGl0bGUiPgogICAqICAgPGlvbi1uYXYtYmFyIGNsYXNzPSJiYXItcG9zaXRpdmUiPgogICAqICAgICA8aW9uLW5hdi1iYWNrLWJ1dHRvbj4KICAgKiAgICAgICBCYWNrCiAgICogICAgIDwvaW9uLW5hdi1iYWNrLWJ1dHRvbj4KICAgKiAgICAgPGRpdiBjbGFzcz0iYnV0dG9ucyByaWdodC1idXR0b25zIj4KICAgKiAgICAgICA8YnV0dG9uIGNsYXNzPSJidXR0b24iPgogICAqICAgICAgICAgUmlnaHQgQnV0dG9uCiAgICogICAgICAgPC9idXR0b24+CiAgICogICAgIDwvZGl2PgogICAqICAgPC9pb24tbmF2LWJhcj4KICAgKiA8L2lvbi12aWV3PgogICAqIGBgYAogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25OYXZCYXInLCBbCiAgICAgICckaW9uaWNWaWV3U2VydmljZScsCiAgICAgICckcm9vdFNjb3BlJywKICAgICAgJyRhbmltYXRlJywKICAgICAgJyRjb21waWxlJywKICAgICAgJyRpb25pY05hdkJhckNvbmZpZycsCiAgICAgIGZ1bmN0aW9uKCRpb25pY1ZpZXdTZXJ2aWNlLCAkcm9vdFNjb3BlLCAkYW5pbWF0ZSwgJGNvbXBpbGUsICRpb25pY05hdkJhckNvbmZpZykgewoKICAgICAgICByZXR1cm4gewogICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgIGNvbnRyb2xsZXI6ICckaW9uaWNOYXZCYXInLAogICAgICAgICAgc2NvcGU6IHRydWUsCiAgICAgICAgICBjb21waWxlOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzKSB7CiAgICAgICAgICAgIC8vV2UgY2Fubm90IHRyYW5zY2x1ZGUgaGVyZSBiZWNhdXNlIGl0IGJyZWFrcyBlbGVtZW50LmRhdGEoKSBpbmhlcml0YW5jZSBvbiBjb21waWxlCiAgICAgICAgICAgIHRFbGVtZW50CiAgICAgICAgICAgICAgLmFkZENsYXNzKCdiYXIgYmFyLWhlYWRlciBuYXYtYmFyJykKICAgICAgICAgICAgICAuYXBwZW5kKAogICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImJ1dHRvbnMgbGVmdC1idXR0b25zIj4gJyArCiAgICAgICAgICAgICAgICAnPC9kaXY+JyArCiAgICAgICAgICAgICAgICAnPGgxIG5nLWJpbmQtaHRtbD0idGl0bGUiIGNsYXNzPSJ0aXRsZSI+PC9oMT4nICsKICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJidXR0b25zIHJpZ2h0LWJ1dHRvbnMiPiAnICsKICAgICAgICAgICAgICAgICc8L2Rpdj4nCiAgICAgICAgICAgICk7CgogICAgICAgICAgICBpZiAoaXNEZWZpbmVkKHRBdHRycy5hbmltYXRpb24pKSB7CiAgICAgICAgICAgICAgdEVsZW1lbnQuYWRkQ2xhc3ModEF0dHJzLmFuaW1hdGlvbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdEVsZW1lbnQuYWRkQ2xhc3MoJGlvbmljTmF2QmFyQ29uZmlnLnRyYW5zaXRpb24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4geyBwcmU6IHByZWxpbmsgfTsKICAgICAgICAgICAgZnVuY3Rpb24gcHJlbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgbmF2QmFyQ3RybCkgewogICAgICAgICAgICAgIG5hdkJhckN0cmwuX2hlYWRlckJhclZpZXcgPSBuZXcgaW9uaWMudmlld3MuSGVhZGVyQmFyKHsKICAgICAgICAgICAgICAgIGVsOiAkZWxlbWVudFswXSwKICAgICAgICAgICAgICAgIGFsaWduVGl0bGU6ICRhdHRyLmFsaWduVGl0bGUgfHwgJGlvbmljTmF2QmFyQ29uZmlnLmFsaWduVGl0bGUgfHwgJ2NlbnRlcicKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgLy9kZWZhdWx0cwogICAgICAgICAgICAgICRzY29wZS5iYWNrQnV0dG9uU2hvd24gPSBmYWxzZTsKICAgICAgICAgICAgICAkc2NvcGUuc2hvdWxkQW5pbWF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgJHNjb3BlLmlzUmV2ZXJzZSA9IGZhbHNlOwogICAgICAgICAgICAgICRzY29wZS5pc0ludmlzaWJsZSA9IHRydWU7CgogICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuJHBhcmVudC4kaGFzSGVhZGVyID0gZmFsc2U7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICRzY29wZS4kd2F0Y2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKCRzY29wZS5pc1JldmVyc2UgPyAnIHJldmVyc2UnIDogJycpICsKICAgICAgICAgICAgICAgICAgKCRzY29wZS5pc0ludmlzaWJsZSA/ICcgaW52aXNpYmxlJyA6ICcnKSArCiAgICAgICAgICAgICAgICAgICghJHNjb3BlLnNob3VsZEFuaW1hdGUgPyAnIG5vLWFuaW1hdGlvbicgOiAnJyk7CiAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oY2xhc3NOYW1lLCBvbGRDbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgICRlbGVtZW50LnJlbW92ZUNsYXNzKG9sZENsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICAkZWxlbWVudC5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH1dKTsKCgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25OYXZCdXR0b25zCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBFCiAgICogQHBhcmVudCBpb25OYXZWaWV3CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBVc2UgaW9uTmF2QnV0dG9ucyB0byBzZXQgdGhlIGJ1dHRvbnMgb24geW91ciB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0KICAgKiBmcm9tIHdpdGhpbiBhbiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblZpZXd9LgogICAqCiAgICogQW55IGJ1dHRvbnMgeW91IGRlY2xhcmUgd2lsbCBiZSBwbGFjZWQgb250byB0aGUgbmF2YmFyJ3MgY29ycmVzcG9uZGluZyBzaWRlLAogICAqIGFuZCB0aGVuIGRlc3Ryb3llZCB3aGVuIHRoZSB1c2VyIGxlYXZlcyB0aGVpciBwYXJlbnQgdmlldy4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8aW9uLW5hdi1iYXI+CiAgICogPC9pb24tbmF2LWJhcj4KICAgKiA8aW9uLW5hdi12aWV3PgogICAqICAgPGlvbi12aWV3PgogICAqICAgICA8aW9uLW5hdi1idXR0b25zIHNpZGU9ImxlZnQiPgogICAqICAgICAgIDxidXR0b24gY2xhc3M9ImJ1dHRvbiIgbmctY2xpY2s9ImRvU29tZXRoaW5nKCkiPgogICAqICAgICAgICAgSSdtIGEgYnV0dG9uIG9uIHRoZSBsZWZ0IG9mIHRoZSBuYXZiYXIhCiAgICogICAgICAgPC9idXR0b24+CiAgICogICAgIDwvaW9uLW5hdi1idXR0b25zPgogICAqICAgICA8aW9uLWNvbnRlbnQ+CiAgICogICAgICAgU29tZSBzdXBlciBjb250ZW50IGhlcmUhCiAgICogICAgIDwvaW9uLWNvbnRlbnQ+CiAgICogICA8L2lvbi12aWV3PgogICAqIDwvaW9uLW5hdi12aWV3PgogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHNpZGUgVGhlIHNpZGUgdG8gcGxhY2UgdGhlIGJ1dHRvbnMgb24gaW4gdGhlIHBhcmVudAogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uTmF2QmFyfS4gQXZhaWxhYmxlOiAnbGVmdCcgb3IgJ3JpZ2h0Jy4KICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uTmF2QnV0dG9ucycsIFsnJGNvbXBpbGUnLCAnJGFuaW1hdGUnLCBmdW5jdGlvbigkY29tcGlsZSwgJGFuaW1hdGUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXF1aXJlOiAnXmlvbk5hdkJhcicsCiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICBjb21waWxlOiBmdW5jdGlvbigkZWxlbWVudCwgJGF0dHJzKSB7CiAgICAgICAgICB2YXIgY29udGVudCA9ICRlbGVtZW50LmNvbnRlbnRzKCkucmVtb3ZlKCk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzLCBuYXZCYXJDdHJsKSB7CiAgICAgICAgICAgIHZhciBuYXZFbGVtZW50ID0gJGF0dHJzLnNpZGUgPT09ICdyaWdodCcgPwogICAgICAgICAgICAgIG5hdkJhckN0cmwucmlnaHRCdXR0b25zRWxlbWVudCA6CiAgICAgICAgICAgICAgbmF2QmFyQ3RybC5sZWZ0QnV0dG9uc0VsZW1lbnQ7CgogICAgICAgICAgICAvL1B1dCBhbGwgb2Ygb3VyIGluc2lkZSBidXR0b25zIGludG8gdGhlaXIgb3duIHNwYW4sCiAgICAgICAgICAgIC8vc28gd2UgY2FuIHJlbW92ZSB0aGVtIGFsbCB3aGVuIHRoaXMgZWxlbWVudCBkaWVzIC0KICAgICAgICAgICAgLy9ldmVuIGlmIHRoZSBidXR0b25zIGhhdmUgY2hhbmdlZCB0aHJvdWdoIGFuIG5nLXJlcGVhdCBvciB0aGUgbGlrZSwKICAgICAgICAgICAgLy93ZSBqdXN0IHJlbW92ZSB0aGVpciBkaXYgcGFyZW50IGFuZCB0aGV5IGFyZSBnb25lLgogICAgICAgICAgICB2YXIgYnV0dG9ucyA9IGpxTGl0ZSgnPHNwYW4+JykuYXBwZW5kKGNvbnRlbnQpOwoKICAgICAgICAgICAgLy9Db21waWxlIGJ1dHRvbnMgaW5zaWRlIGNvbnRlbnQgc28gdGhleSBoYXZlIGFjY2VzcyB0byBldmVyeXRoaW5nCiAgICAgICAgICAgIC8vc29tZXRoaW5nIGluc2lkZSBjb250ZW50IGRvZXMgKGVnIHBhcmVudCBpb25pY1Njcm9sbCkKICAgICAgICAgICAgJGVsZW1lbnQuYXBwZW5kKGJ1dHRvbnMpOwogICAgICAgICAgICAkY29tcGlsZShidXR0b25zKSgkc2NvcGUpOwoKICAgICAgICAgICAgLy9BcHBlbmQgYnV0dG9ucyB0byBuYXZiYXIKICAgICAgICAgICAgaW9uaWMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIC8vSWYgdGhlIHNjb3BlIGlzIGRlc3Ryb3llZCBiZWZvcmUgcmFmIHJ1bnMsIGJlIHN1cmUgbm90IHRvIGVudGVyCiAgICAgICAgICAgICAgaWYgKCEkc2NvcGUuJCRkZXN0cm95ZWQpIHsKICAgICAgICAgICAgICAgICRhbmltYXRlLmVudGVyKGJ1dHRvbnMsIG5hdkVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvL1doZW4gb3VyIGlvbi1uYXYtYnV0dG9ucyBjb250YWluZXIgaXMgZGVzdHJveWVkLAogICAgICAgICAgICAvL2Rlc3Ryb3kgZXZlcnl0aGluZyBpbiB0aGUgbmF2YmFyCiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgJGFuaW1hdGUubGVhdmUoYnV0dG9ucyk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gVGhlIG9yaWdpbmFsIGVsZW1lbnQgaXMganVzdCBhIGNvbXBsZXRlbHkgZW1wdHkgPGlvbi1uYXYtYnV0dG9ucz4gZWxlbWVudC4KICAgICAgICAgICAgLy8gbWFrZSBpdCBpbnZpc2libGUganVzdCB0byBiZSBzdXJlIGl0IGRvZXNuJ3QgY2hhbmdlIGFueSBsYXlvdXQKICAgICAgICAgICAgJGVsZW1lbnQuY3NzKCdkaXNwbGF5JywgJ25vbmUnKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9OwogICAgfV0pOwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIG5hdkNsZWFyCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBBQwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogbmF2LWNsZWFyIGlzIGFuIGF0dHJpYnV0ZSBkaXJlY3RpdmUgd2hpY2ggc2hvdWxkIGJlIHVzZWQgd2l0aCBhbiBlbGVtZW50IHRoYXQgY2hhbmdlcwogICAqIHRoZSB2aWV3IG9uIGNsaWNrLCBmb3IgZXhhbXBsZSBhbiBgPGEgaHJlZj5gIG9yIGEgYDxidXR0b24gdWktc3JlZj5gLgogICAqCiAgICogbmF2LWNsZWFyIHdpbGwgY2F1c2UgdGhlIGdpdmVuIGVsZW1lbnQsIHdoZW4gY2xpY2tlZCwgdG8gZGlzYWJsZSB0aGUgbmV4dCB2aWV3IHRyYW5zaXRpb24uCiAgICogVGhpcyBkaXJlY3RpdmUgaXMgdXNlZnVsLCBmb3IgZXhhbXBsZSwgZm9yIGxpbmtzIHdpdGhpbiBhIHNpZGVNZW51LgogICAqCiAgICogQHVzYWdlCiAgICogQmVsb3cgaXMgYSBsaW5rIGluIGEgc2lkZSBtZW51LCB3aXRoIHRoZSBuYXYtY2xlYXIgZGlyZWN0aXZlIGFkZGVkIHRvIGl0LgogICAqIFRhcHBpbmcgdGhpcyBsaW5rIHdpbGwgZGlzYWJsZSBhbnkgYW5pbWF0aW9ucyB0aGF0IHdvdWxkIG5vcm1hbGx5IG9jY3VyCiAgICogYmV0d2VlbiB2aWV3cy4KICAgKgogICAqIGBgYGh0bWwKICAgKiA8YSBuYXYtY2xlYXIgbWVudS1jbG9zZSBocmVmPSIjL2hvbWUiIGNsYXNzPSJpdGVtIj5Ib21lPC9hPgogICAqIGBgYAogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCduYXZDbGVhcicsIFsKICAgICAgJyRpb25pY1ZpZXdTZXJ2aWNlJywKICAgICAgJyRzdGF0ZScsCiAgICAgICckbG9jYXRpb24nLAogICAgICAnJHdpbmRvdycsCiAgICAgICckcm9vdFNjb3BlJywKICAgICAgZnVuY3Rpb24oJGlvbmljVmlld1NlcnZpY2UsICRsb2NhdGlvbiwgJHN0YXRlLCAkd2luZG93LCAkcm9vdFNjb3BlKSB7CiAgICAgICAgJHJvb3RTY29wZS4kb24oJyRzdGF0ZUNoYW5nZUVycm9yJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAkaW9uaWNWaWV3U2VydmljZS5uZXh0Vmlld09wdGlvbnMobnVsbCk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHByaW9yaXR5OiAxMDAsCiAgICAgICAgICByZXN0cmljdDogJ0FDJywKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCRlbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybiB7IHByZTogcHJlbGluayB9OwogICAgICAgICAgICBmdW5jdGlvbiBwcmVsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycykgewogICAgICAgICAgICAgIHZhciB1bnJlZ2lzdGVyTGlzdGVuZXI7CiAgICAgICAgICAgICAgZnVuY3Rpb24gbGlzdGVuRm9yU3RhdGVDaGFuZ2UoKSB7CiAgICAgICAgICAgICAgICB1bnJlZ2lzdGVyTGlzdGVuZXIgPSAkc2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdGFydCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAkaW9uaWNWaWV3U2VydmljZS5uZXh0Vmlld09wdGlvbnMoewogICAgICAgICAgICAgICAgICAgIGRpc2FibGVBbmltYXRlOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGRpc2FibGVCYWNrOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB1bnJlZ2lzdGVyTGlzdGVuZXIoKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgJHdpbmRvdy5zZXRUaW1lb3V0KHVucmVnaXN0ZXJMaXN0ZW5lciwgMzAwKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICRlbGVtZW50Lm9uKCdjbGljaycsIGxpc3RlbkZvclN0YXRlQ2hhbmdlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH1dKTsKCiAgSW9uaWNNb2R1bGUuY29uc3RhbnQoJyRpb25pY05hdlZpZXdDb25maWcnLCB7CiAgICB0cmFuc2l0aW9uOiAnc2xpZGUtbGVmdC1yaWdodC1pb3M3JwogIH0pOwoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgaW9uTmF2VmlldwogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgRQogICAqIEBjb2RlcGVuIG9kcUN6CiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBcyBhIHVzZXIgbmF2aWdhdGVzIHRocm91Z2hvdXQgeW91ciBhcHAsIElvbmljIGlzIGFibGUgdG8ga2VlcCB0cmFjayBvZiB0aGVpcgogICAqIG5hdmlnYXRpb24gaGlzdG9yeS4gQnkga25vd2luZyB0aGVpciBoaXN0b3J5LCB0cmFuc2l0aW9ucyBiZXR3ZWVuIHZpZXdzCiAgICogY29ycmVjdGx5IHNsaWRlIGVpdGhlciBsZWZ0IG9yIHJpZ2h0LCBvciBubyB0cmFuc2l0aW9uIGF0IGFsbC4gQW4gYWRkaXRpb25hbAogICAqIGJlbmVmaXQgdG8gSW9uaWMncyBuYXZpZ2F0aW9uIHN5c3RlbSBpcyBpdHMgYWJpbGl0eSB0byBtYW5hZ2UgbXVsdGlwbGUKICAgKiBoaXN0b3JpZXMuCiAgICoKICAgKiBJb25pYyB1c2VzIHRoZSBBbmd1bGFyVUkgUm91dGVyIG1vZHVsZSBzbyBhcHAgaW50ZXJmYWNlcyBjYW4gYmUgb3JnYW5pemVkCiAgICogaW50byB2YXJpb3VzICJzdGF0ZXMiLiBMaWtlIEFuZ3VsYXIncyBjb3JlICRyb3V0ZSBzZXJ2aWNlLCBVUkxzIGNhbiBiZSB1c2VkCiAgICogdG8gY29udHJvbCB0aGUgdmlld3MuIEhvd2V2ZXIsIHRoZSBBbmd1bGFyVUkgUm91dGVyIHByb3ZpZGVzIGEgbW9yZSBwb3dlcmZ1bAogICAqIHN0YXRlIG1hbmFnZXIgaW4gdGhhdCBzdGF0ZXMgYXJlIGJvdW5kIHRvIG5hbWVkLCBuZXN0ZWQsIGFuZCBwYXJhbGxlbCB2aWV3cywKICAgKiBhbGxvd2luZyBtb3JlIHRoYW4gb25lIHRlbXBsYXRlIHRvIGJlIHJlbmRlcmVkIG9uIHRoZSBzYW1lIHBhZ2UuCiAgICogQWRkaXRpb25hbGx5LCBlYWNoIHN0YXRlIGlzIG5vdCByZXF1aXJlZCB0byBiZSBib3VuZCB0byBhIFVSTCwgYW5kIGRhdGEgY2FuCiAgICogYmUgcHVzaGVkIHRvIGVhY2ggc3RhdGUgd2hpY2ggYWxsb3dzIG11Y2ggZmxleGliaWxpdHkuCiAgICoKICAgKiBUaGUgaW9uTmF2VmlldyBkaXJlY3RpdmUgaXMgdXNlZCB0byByZW5kZXIgdGVtcGxhdGVzIGluIHlvdXIgYXBwbGljYXRpb24uIEVhY2ggdGVtcGxhdGUKICAgKiBpcyBwYXJ0IG9mIGEgc3RhdGUuIFN0YXRlcyBhcmUgdXN1YWxseSBtYXBwZWQgdG8gYSB1cmwsIGFuZCBhcmUgZGVmaW5lZCBwcm9ncmFtYXRpY2FsbHkKICAgKiB1c2luZyBhbmd1bGFyLXVpLXJvdXRlciAoc2VlIFt0aGVpciBkb2NzXShodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci11aS91aS1yb3V0ZXIvd2lraSksCiAgICogYW5kIHJlbWVtYmVyIHRvIHJlcGxhY2UgdWktdmlldyB3aXRoIGlvbi1uYXYtdmlldyBpbiBleGFtcGxlcykuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBJbiB0aGlzIGV4YW1wbGUsIHdlIHdpbGwgY3JlYXRlIGEgbmF2aWdhdGlvbiB2aWV3IHRoYXQgY29udGFpbnMgb3VyIGRpZmZlcmVudCBzdGF0ZXMgZm9yIHRoZSBhcHAuCiAgICoKICAgKiBUbyBkbyB0aGlzLCBpbiBvdXIgbWFya3VwIHdlIHVzZSBpb25OYXZWaWV3IHRvcCBsZXZlbCBkaXJlY3RpdmUuIFRvIGRpc3BsYXkgYSBoZWFkZXIgYmFyIHdlIHVzZQogICAqIHRoZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0gZGlyZWN0aXZlIHRoYXQgdXBkYXRlcyBhcyB3ZSBuYXZpZ2F0ZSB0aHJvdWdoIHRoZQogICAqIG5hdmlnYXRpb24gc3RhY2suCiAgICoKICAgKiBZb3UgY2FuIHVzZSBhbnkgW2FuaW1hdGlvbiBjbGFzc10oL2RvY3MvY29tcG9uZW50cyNhbmltYXRpb24pIG9uIHRoZSBuYXZWaWV3J3MgYGFuaW1hdGlvbmAgYXR0cmlidXRlCiAgICogdG8gaGF2ZSBpdHMgcGFnZXMgYW5pbWF0ZS4KICAgKgogICAqIFJlY29tbWVuZGVkIGZvciBwYWdlIHRyYW5zaXRpb25zOiAnc2xpZGUtbGVmdC1yaWdodCcsICdzbGlkZS1sZWZ0LXJpZ2h0LWlvczcnLCAnc2xpZGUtaW4tdXAnLgogICAqCiAgICogYGBgaHRtbAogICAqIDxpb24tbmF2LWJhcj48L2lvbi1uYXYtYmFyPgogICAqIDxpb24tbmF2LXZpZXcgYW5pbWF0aW9uPSJzbGlkZS1sZWZ0LXJpZ2h0Ij4KICAgKiAgIDwhLS0gQ2VudGVyIGNvbnRlbnQgLS0+CiAgICogPC9pb24tbmF2LXZpZXc+CiAgICogYGBgCiAgICoKICAgKiBOZXh0LCB3ZSBuZWVkIHRvIHNldHVwIG91ciBzdGF0ZXMgdGhhdCB3aWxsIGJlIHJlbmRlcmVkLgogICAqCiAgICogYGBganMKICAgKiB2YXIgYXBwID0gYW5ndWxhci5tb2R1bGUoJ215QXBwJywgWydpb25pYyddKTsKICAgKiBhcHAuY29uZmlnKGZ1bmN0aW9uKCRzdGF0ZVByb3ZpZGVyKSB7CiAqICAgJHN0YXRlUHJvdmlkZXIKICogICAuc3RhdGUoJ2luZGV4JywgewogKiAgICAgdXJsOiAnLycsCiAqICAgICB0ZW1wbGF0ZVVybDogJ2hvbWUuaHRtbCcKICogICB9KQogKiAgIC5zdGF0ZSgnbXVzaWMnLCB7CiAqICAgICB1cmw6ICcvbXVzaWMnLAogKiAgICAgdGVtcGxhdGVVcmw6ICdtdXNpYy5odG1sJwogKiAgIH0pOwogKiB9KTsKICAgKiBgYGAKICAgKiBUaGVuIG9uIGFwcCBzdGFydCwgJHN0YXRlUHJvdmlkZXIgd2lsbCBsb29rIGF0IHRoZSB1cmwsIHNlZSBpdCBtYXRjaGVzIHRoZSBpbmRleCBzdGF0ZSwKICAgKiBhbmQgdGhlbiB0cnkgdG8gbG9hZCBob21lLmh0bWwgaW50byB0aGUgYDxpb24tbmF2LXZpZXc+YC4KICAgKgogICAqIFBhZ2VzIGFyZSBsb2FkZWQgYnkgdGhlIFVSTHMgZ2l2ZW4uIE9uZSBzaW1wbGUgd2F5IHRvIGNyZWF0ZSB0ZW1wbGF0ZXMgaW4gQW5ndWxhciBpcyB0byBwdXQKICAgKiB0aGVtIGRpcmVjdGx5IGludG8geW91ciBIVE1MIGZpbGUgYW5kIHVzZSB0aGUgYDxzY3JpcHQgdHlwZT0idGV4dC9uZy10ZW1wbGF0ZSI+YCBzeW50YXguCiAgICogU28gaGVyZSBpcyBvbmUgd2F5IHRvIHB1dCBob21lLmh0bWwgaW50byBvdXIgYXBwOgogICAqCiAgICogYGBgaHRtbAogICAqIDxzY3JpcHQgaWQ9ImhvbWUiIHR5cGU9InRleHQvbmctdGVtcGxhdGUiPgogICAqICAgPCEtLSBUaGUgdGl0bGUgb2YgdGhlIGlvbi12aWV3IHdpbGwgYmUgc2hvd24gb24gdGhlIG5hdmJhciAtLT4KICAgKiAgIDxpb24tdmlldyB0aXRsZT0iJ0hvbWUnIj4KICAgKiAgICAgPGlvbi1jb250ZW50IG5nLWNvbnRyb2xsZXI9IkhvbWVDdHJsIj4KICAgKiAgICAgICA8IS0tIFRoZSBjb250ZW50IG9mIHRoZSBwYWdlIC0tPgogICAqICAgICAgIDxhIGhyZWY9IiMvbXVzaWMiPkdvIHRvIG11c2ljIHBhZ2UhPC9hPgogICAqICAgICA8L2lvbi1jb250ZW50PgogICAqICAgPC9pb24tdmlldz4KICAgKiA8L3NjcmlwdD4KICAgKiBgYGAKICAgKgogICAqIFRoaXMgaXMgZ29vZCB0byBkbyBiZWNhdXNlIHRoZSB0ZW1wbGF0ZSB3aWxsIGJlIGNhY2hlZCBmb3IgdmVyeSBmYXN0IGxvYWRpbmcsIGluc3RlYWQgb2YKICAgKiBoYXZpbmcgdG8gZmV0Y2ggdGhlbSBmcm9tIHRoZSBuZXR3b3JrLgogICAqCiAgICogUGxlYXNlIHZpc2l0IFtBbmd1bGFyVUkgUm91dGVyJ3MgZG9jc10oaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXItdWkvdWktcm91dGVyL3dpa2kpIGZvcgogICAqIG1vcmUgaW5mby4gQmVsb3cgaXMgYSBncmVhdCB2aWRlbyBieSB0aGUgQW5ndWxhclVJIFJvdXRlciBndXlzIHRoYXQgbWF5IGhlbHAgdG8gZXhwbGFpbgogICAqIGhvdyBpdCBhbGwgd29ya3M6CiAgICoKICAgKiA8aWZyYW1lIHdpZHRoPSI1NjAiIGhlaWdodD0iMzE1IiBzcmM9Ii8vd3d3LnlvdXR1YmUuY29tL2VtYmVkL2RxSlJvaDhNbkJvIgogICAqIGZyYW1lYm9yZGVyPSIwIiBhbGxvd2Z1bGxzY3JlZW4+PC9pZnJhbWU+CiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IG5hbWUgQSB2aWV3IG5hbWUuIFRoZSBuYW1lIHNob3VsZCBiZSB1bmlxdWUgYW1vbmdzdCB0aGUgb3RoZXIgdmlld3MgaW4gdGhlCiAgICogc2FtZSBzdGF0ZS4gWW91IGNhbiBoYXZlIHZpZXdzIG9mIHRoZSBzYW1lIG5hbWUgdGhhdCBsaXZlIGluIGRpZmZlcmVudCBzdGF0ZXMuIEZvciBtb3JlCiAgICogaW5mb3JtYXRpb24sIHNlZSB1aS1yb3V0ZXIncyBbdWktdmlldyBkb2N1bWVudGF0aW9uXShodHRwOi8vYW5ndWxhci11aS5naXRodWIuaW8vdWktcm91dGVyL3NpdGUvIy9hcGkvdWkucm91dGVyLnN0YXRlLmRpcmVjdGl2ZTp1aS12aWV3KS4KICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uTmF2VmlldycsIFsKICAgICAgJyRpb25pY1ZpZXdTZXJ2aWNlJywKICAgICAgJyRzdGF0ZScsCiAgICAgICckY29tcGlsZScsCiAgICAgICckY29udHJvbGxlcicsCiAgICAgICckYW5pbWF0ZScsCiAgICAgIGZ1bmN0aW9uKCAkaW9uaWNWaWV3U2VydmljZSwgICAkc3RhdGUsICAgJGNvbXBpbGUsICAgJGNvbnRyb2xsZXIsICAgJGFuaW1hdGUpIHsKICAgICAgICAvLyBJT05JQydzIGZvcmsgb2YgQW5ndWxhciBVSSBSb3V0ZXIsIHYwLjIuNwogICAgICAgIC8vIHRoZSBuYXZWaWV3IGhhbmRsZXMgcmVnaXN0ZXJpbmcgdmlld3MgaW4gdGhlIGhpc3RvcnksIHdoaWNoIGFuaW1hdGlvbiB0byB1c2UsIGFuZCB3aGljaAogICAgICAgIHZhciB2aWV3SXNVcGRhdGluZyA9IGZhbHNlOwoKICAgICAgICB2YXIgZGlyZWN0aXZlID0gewogICAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICAgIHRlcm1pbmFsOiB0cnVlLAogICAgICAgICAgcHJpb3JpdHk6IDIwMDAsCiAgICAgICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICAgICAgY29udHJvbGxlcjogZnVuY3Rpb24oKXt9LAogICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24gKGVsZW1lbnQsIGF0dHIsIHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRyLCBuYXZWaWV3Q3RybCkgewogICAgICAgICAgICAgIHZhciB2aWV3U2NvcGUsIHZpZXdMb2NhbHMsCiAgICAgICAgICAgICAgICBuYW1lID0gYXR0cltkaXJlY3RpdmUubmFtZV0gfHwgYXR0ci5uYW1lIHx8ICcnLAogICAgICAgICAgICAgICAgb25sb2FkRXhwID0gYXR0ci5vbmxvYWQgfHwgJycsCiAgICAgICAgICAgICAgICBpbml0aWFsVmlldyA9IHRyYW5zY2x1ZGUoc2NvcGUpOwoKICAgICAgICAgICAgICAvLyBQdXQgYmFjayB0aGUgY29tcGlsZWQgaW5pdGlhbCB2aWV3CiAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmQoaW5pdGlhbFZpZXcpOwoKICAgICAgICAgICAgICAvLyBGaW5kIHRoZSBkZXRhaWxzIG9mIHRoZSBwYXJlbnQgdmlldyBkaXJlY3RpdmUgKGlmIGFueSkgYW5kIHVzZSBpdAogICAgICAgICAgICAgIC8vIHRvIGRlcml2ZSBvdXIgb3duIHF1YWxpZmllZCB2aWV3IG5hbWUsIHRoZW4gaGFuZyBvdXIgb3duIGRldGFpbHMKICAgICAgICAgICAgICAvLyBvZmYgdGhlIERPTSBzbyBjaGlsZCBkaXJlY3RpdmVzIGNhbiBmaW5kIGl0LgogICAgICAgICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudCgpLmluaGVyaXRlZERhdGEoJyR1aVZpZXcnKTsKICAgICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCdAJykgPCAwKSBuYW1lICA9IG5hbWUgKyAnQCcgKyAoKHBhcmVudCAmJiBwYXJlbnQuc3RhdGUpID8gcGFyZW50LnN0YXRlLm5hbWUgOiAnJyk7CiAgICAgICAgICAgICAgdmFyIHZpZXcgPSB7IG5hbWU6IG5hbWUsIHN0YXRlOiBudWxsIH07CiAgICAgICAgICAgICAgZWxlbWVudC5kYXRhKCckdWlWaWV3Jywgdmlldyk7CgogICAgICAgICAgICAgIHZhciBldmVudEhvb2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICh2aWV3SXNVcGRhdGluZykgcmV0dXJuOwogICAgICAgICAgICAgICAgdmlld0lzVXBkYXRpbmcgPSB0cnVlOwoKICAgICAgICAgICAgICAgIHRyeSB7IHVwZGF0ZVZpZXcodHJ1ZSk7IH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgdmlld0lzVXBkYXRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZpZXdJc1VwZGF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgc2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdWNjZXNzJywgZXZlbnRIb29rKTsKICAgICAgICAgICAgICAvLyBzY29wZS4kb24oJyR2aWV3Q29udGVudExvYWRpbmcnLCBldmVudEhvb2spOwogICAgICAgICAgICAgIHVwZGF0ZVZpZXcoZmFsc2UpOwoKICAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVWaWV3KGRvQW5pbWF0ZSkgewogICAgICAgICAgICAgICAgLy89PT1mYWxzZSBiZWNhdXNlICRhbmltYXRlLmVuYWJsZWQoKSBpcyBhIG5vb3Agd2l0aG91dCBhbmd1bGFyLWFuaW1hdGUgaW5jbHVkZWQKICAgICAgICAgICAgICAgIGlmICgkYW5pbWF0ZS5lbmFibGVkKCkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgIGRvQW5pbWF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBsb2NhbHMgPSAkc3RhdGUuJGN1cnJlbnQgJiYgJHN0YXRlLiRjdXJyZW50LmxvY2Fsc1tuYW1lXTsKICAgICAgICAgICAgICAgIGlmIChsb2NhbHMgPT09IHZpZXdMb2NhbHMpIHJldHVybjsgLy8gbm90aGluZyB0byBkbwogICAgICAgICAgICAgICAgdmFyIHJlbmRlcmVyID0gJGlvbmljVmlld1NlcnZpY2UuZ2V0UmVuZGVyZXIoZWxlbWVudCwgYXR0ciwgc2NvcGUpOwoKICAgICAgICAgICAgICAgIC8vIERlc3Ryb3kgcHJldmlvdXMgdmlldyBzY29wZQogICAgICAgICAgICAgICAgaWYgKHZpZXdTY29wZSkgewogICAgICAgICAgICAgICAgICB2aWV3U2NvcGUuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgdmlld1Njb3BlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIWxvY2FscykgewogICAgICAgICAgICAgICAgICB2aWV3TG9jYWxzID0gbnVsbDsKICAgICAgICAgICAgICAgICAgdmlldy5zdGF0ZSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIHRoZSBpbml0aWFsIHZpZXcKICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQuYXBwZW5kKGluaXRpYWxWaWV3KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgbmV3RWxlbWVudCA9IGpxTGl0ZSgnPGRpdj48L2Rpdj4nKS5odG1sKGxvY2Fscy4kdGVtcGxhdGUpLmNvbnRlbnRzKCk7CiAgICAgICAgICAgICAgICB2YXIgdmlld1JlZ2lzdGVyRGF0YSA9IHJlbmRlcmVyKCkucmVnaXN0ZXIobmV3RWxlbWVudCk7CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGV4aXN0aW5nIGNvbnRlbnQKICAgICAgICAgICAgICAgIHJlbmRlcmVyKGRvQW5pbWF0ZSkubGVhdmUoKTsKCiAgICAgICAgICAgICAgICB2aWV3TG9jYWxzID0gbG9jYWxzOwogICAgICAgICAgICAgICAgdmlldy5zdGF0ZSA9IGxvY2Fscy4kJHN0YXRlOwoKICAgICAgICAgICAgICAgIHJlbmRlcmVyKGRvQW5pbWF0ZSkuZW50ZXIobmV3RWxlbWVudCk7CgogICAgICAgICAgICAgICAgdmFyIGxpbmsgPSAkY29tcGlsZShuZXdFbGVtZW50KTsKICAgICAgICAgICAgICAgIHZpZXdTY29wZSA9IHNjb3BlLiRuZXcoKTsKCiAgICAgICAgICAgICAgICB2aWV3U2NvcGUuJG5hdkRpcmVjdGlvbiA9IHZpZXdSZWdpc3RlckRhdGEubmF2RGlyZWN0aW9uOwoKICAgICAgICAgICAgICAgIGlmIChsb2NhbHMuJCRjb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgICAgIGxvY2Fscy4kc2NvcGUgPSB2aWV3U2NvcGU7CiAgICAgICAgICAgICAgICAgIHZhciBjb250cm9sbGVyID0gJGNvbnRyb2xsZXIobG9jYWxzLiQkY29udHJvbGxlciwgbG9jYWxzKTsKICAgICAgICAgICAgICAgICAgZWxlbWVudC5jaGlsZHJlbigpLmRhdGEoJyRuZ0NvbnRyb2xsZXJDb250cm9sbGVyJywgY29udHJvbGxlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsaW5rKHZpZXdTY29wZSk7CgogICAgICAgICAgICAgICAgdmFyIHZpZXdIaXN0b3J5RGF0YSA9ICRpb25pY1ZpZXdTZXJ2aWNlLl9nZXRWaWV3QnlJZCh2aWV3UmVnaXN0ZXJEYXRhLnZpZXdJZCkgfHwge307CiAgICAgICAgICAgICAgICB2aWV3U2NvcGUuJGJyb2FkY2FzdCgnJHZpZXdDb250ZW50TG9hZGVkJywgdmlld0hpc3RvcnlEYXRhKTsKCiAgICAgICAgICAgICAgICBpZiAob25sb2FkRXhwKSB2aWV3U2NvcGUuJGV2YWwob25sb2FkRXhwKTsKCiAgICAgICAgICAgICAgICBuZXdFbGVtZW50ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gZGlyZWN0aXZlOwogICAgICB9XSk7CgoKICBJb25pY01vZHVsZQoKICAgIC5jb25maWcoWyckcHJvdmlkZScsIGZ1bmN0aW9uKCRwcm92aWRlKSB7CiAgICAgICRwcm92aWRlLmRlY29yYXRvcignbmdDbGlja0RpcmVjdGl2ZScsIFsnJGRlbGVnYXRlJywgZnVuY3Rpb24oJGRlbGVnYXRlKSB7CiAgICAgICAgLy8gZHJvcCB0aGUgZGVmYXVsdCBuZ0NsaWNrIGRpcmVjdGl2ZQogICAgICAgICRkZWxlZ2F0ZS5zaGlmdCgpOwogICAgICAgIHJldHVybiAkZGVsZWdhdGU7CiAgICAgIH1dKTsKICAgIH1dKQoKICAvKioKICAgKiBAcHJpdmF0ZQogICAqLwogICAgLmZhY3RvcnkoJyRpb25pY05nQ2xpY2snLCBbJyRwYXJzZScsIGZ1bmN0aW9uKCRwYXJzZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGNsaWNrRXhwcikgewogICAgICAgIHZhciBjbGlja0hhbmRsZXIgPSBhbmd1bGFyLmlzRnVuY3Rpb24oY2xpY2tFeHByKSA/CiAgICAgICAgICBjbGlja0V4cHIgOgogICAgICAgICAgJHBhcnNlKGNsaWNrRXhwcik7CgogICAgICAgIGVsZW1lbnQub24oJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIHNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2xpY2tIYW5kbGVyKHNjb3BlLCB7JGV2ZW50OiAoZXZlbnQpfSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gSGFjayBmb3IgaU9TIFNhZmFyaSdzIGJlbmVmaXQuIEl0IGdvZXMgc2VhcmNoaW5nIGZvciBvbmNsaWNrIGhhbmRsZXJzIGFuZCBpcyBsaWFibGUgdG8gY2xpY2sKICAgICAgICAvLyBzb21ldGhpbmcgZWxzZSBuZWFyYnkuCiAgICAgICAgZWxlbWVudC5vbmNsaWNrID0gZnVuY3Rpb24oZXZlbnQpIHsgfTsKICAgICAgfTsKICAgIH1dKQoKICAgIC5kaXJlY3RpdmUoJ25nQ2xpY2snLCBbJyRpb25pY05nQ2xpY2snLCBmdW5jdGlvbigkaW9uaWNOZ0NsaWNrKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICRpb25pY05nQ2xpY2soc2NvcGUsIGVsZW1lbnQsIGF0dHIubmdDbGljayk7CiAgICAgIH07CiAgICB9XSkKCiAgICAuZGlyZWN0aXZlKCdpb25TdG9wRXZlbnQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgICBsaW5rOiBmdW5jdGlvbiAoc2NvcGUsIGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIGVsZW1lbnQuYmluZChhdHRyLmlvblN0b3BFdmVudCwgZXZlbnRTdG9wUHJvcGFnYXRpb24pOwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwogIGZ1bmN0aW9uIGV2ZW50U3RvcFByb3BhZ2F0aW9uKGUpIHsKICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgfQoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvblBhbmUKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKgogICAqIEBkZXNjcmlwdGlvbiBBIHNpbXBsZSBjb250YWluZXIgdGhhdCBmaXRzIGNvbnRlbnQsIHdpdGggbm8gc2lkZSBlZmZlY3RzLiAgQWRkcyB0aGUgJ3BhbmUnIGNsYXNzIHRvIHRoZSBlbGVtZW50LgogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25QYW5lJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICBsaW5rOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygncGFuZScpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwoKICAvKgogICAqIFdlIGRvbid0IGRvY3VtZW50IHRoZSBpb25Qb3BvdmVyIGRpcmVjdGl2ZSwgd2UgaW5zdGVhZCBkb2N1bWVudAogICAqIHRoZSAkaW9uaWNQb3BvdmVyIHNlcnZpY2UKICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uUG9wb3ZlcicsIFtmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICBjb250cm9sbGVyOiBbZnVuY3Rpb24oKXt9XSwKICAgICAgICB0ZW1wbGF0ZTogJzxkaXYgY2xhc3M9InBvcG92ZXItYmFja2Ryb3AiPicgKwogICAgICAgICAgJzxkaXYgY2xhc3M9InBvcG92ZXItd3JhcHBlciIgbmctdHJhbnNjbHVkZT48L2Rpdj4nICsKICAgICAgICAgICc8L2Rpdj4nCiAgICAgIH07CiAgICB9XSk7CgogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25Qb3BvdmVyVmlldycsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgICAgZWxlbWVudC5hcHBlbmQoIGFuZ3VsYXIuZWxlbWVudCgnPGRpdiBjbGFzcz0icG9wb3Zlci1hcnJvdyI+PC9kaXY+JykgKTsKICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ3BvcG92ZXInKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvblJhZGlvCiAgICogQG1vZHVsZSBpb25pYwogICAqIEByZXN0cmljdCBFCiAgICogQGNvZGVwZW4gc2FvQkcKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGUgcmFkaW8gZGlyZWN0aXZlIGlzIG5vIGRpZmZlcmVudCB0aGFuIHRoZSBIVE1MIHJhZGlvIGlucHV0LCBleGNlcHQgaXQncyBzdHlsZWQgZGlmZmVyZW50bHkuCiAgICoKICAgKiBSYWRpbyBiZWhhdmVzIGxpa2UgYW55IFtBbmd1bGFySlMgcmFkaW9dKGh0dHA6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nL2lucHV0L2lucHV0W3JhZGlvXSkuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGlvbi1yYWRpbyBuZy1tb2RlbD0iY2hvaWNlIiBuZy12YWx1ZT0iJ0EnIj5DaG9vc2UgQTwvaW9uLXJhZGlvPgogICAqIDxpb24tcmFkaW8gbmctbW9kZWw9ImNob2ljZSIgbmctdmFsdWU9IidCJyI+Q2hvb3NlIEI8L2lvbi1yYWRpbz4KICAgKiA8aW9uLXJhZGlvIG5nLW1vZGVsPSJjaG9pY2UiIG5nLXZhbHVlPSInQyciPkNob29zZSBDPC9pb24tcmFkaW8+CiAgICogYGBgCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvblJhZGlvJywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgIHJlcXVpcmU6ICc/bmdNb2RlbCcsCiAgICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgICB0ZW1wbGF0ZToKICAgICAgICAgICc8bGFiZWwgY2xhc3M9Iml0ZW0gaXRlbS1yYWRpbyI+JyArCiAgICAgICAgICAnPGlucHV0IHR5cGU9InJhZGlvIiBuYW1lPSJyYWRpby1ncm91cCI+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0iaXRlbS1jb250ZW50IGRpc2FibGUtcG9pbnRlci1ldmVudHMiIG5nLXRyYW5zY2x1ZGU+PC9kaXY+JyArCiAgICAgICAgICAnPGkgY2xhc3M9InJhZGlvLWljb24gZGlzYWJsZS1wb2ludGVyLWV2ZW50cyBpY29uIGlvbi1jaGVja21hcmsiPjwvaT4nICsKICAgICAgICAgICc8L2xhYmVsPicsCgogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIGlmKGF0dHIuaWNvbikgZWxlbWVudC5jaGlsZHJlbigpLmVxKDIpLnJlbW92ZUNsYXNzKCdpb24tY2hlY2ttYXJrJykuYWRkQ2xhc3MoYXR0ci5pY29uKTsKICAgICAgICAgIHZhciBpbnB1dCA9IGVsZW1lbnQuZmluZCgnaW5wdXQnKTsKICAgICAgICAgIGZvckVhY2goewogICAgICAgICAgICAnbmFtZSc6IGF0dHIubmFtZSwKICAgICAgICAgICAgJ3ZhbHVlJzogYXR0ci52YWx1ZSwKICAgICAgICAgICAgJ2Rpc2FibGVkJzogYXR0ci5kaXNhYmxlZCwKICAgICAgICAgICAgJ25nLXZhbHVlJzogYXR0ci5uZ1ZhbHVlLAogICAgICAgICAgICAnbmctbW9kZWwnOiBhdHRyLm5nTW9kZWwsCiAgICAgICAgICAgICduZy1kaXNhYmxlZCc6IGF0dHIubmdEaXNhYmxlZCwKICAgICAgICAgICAgJ25nLWNoYW5nZSc6IGF0dHIubmdDaGFuZ2UKICAgICAgICAgIH0sIGZ1bmN0aW9uKHZhbHVlLCBuYW1lKSB7CiAgICAgICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgaW5wdXQuYXR0cihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIHJldHVybiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICBzY29wZS5nZXRWYWx1ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBzY29wZS5uZ1ZhbHVlIHx8IGF0dHIudmFsdWU7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvblJlZnJlc2hlcgogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgRQogICAqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvbkNvbnRlbnQsIGlvbmljLmRpcmVjdGl2ZTppb25TY3JvbGwKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBbGxvd3MgeW91IHRvIGFkZCBwdWxsLXRvLXJlZnJlc2ggdG8gYSBzY3JvbGxWaWV3LgogICAqCiAgICogUGxhY2UgaXQgYXMgdGhlIGZpcnN0IGNoaWxkIG9mIHlvdXIge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25Db250ZW50fSBvcgogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2Nyb2xsfSBlbGVtZW50LgogICAqCiAgICogV2hlbiByZWZyZXNoaW5nIGlzIGNvbXBsZXRlLCAkYnJvYWRjYXN0IHRoZSAnc2Nyb2xsLnJlZnJlc2hDb21wbGV0ZScgZXZlbnQKICAgKiBmcm9tIHlvdXIgY29udHJvbGxlci4KICAgKgogICAqIEB1c2FnZQogICAqCiAgICogYGBgaHRtbAogICAqIDxpb24tY29udGVudCBuZy1jb250cm9sbGVyPSJNeUNvbnRyb2xsZXIiPgogICAqICAgPGlvbi1yZWZyZXNoZXIKICAgKiAgICAgcHVsbGluZy10ZXh0PSJQdWxsIHRvIHJlZnJlc2guLi4iCiAgICogICAgIG9uLXJlZnJlc2g9ImRvUmVmcmVzaCgpIj4KICAgKiAgIDwvaW9uLXJlZnJlc2hlcj4KICAgKiAgIDxpb24tbGlzdD4KICAgKiAgICAgPGlvbi1pdGVtIG5nLXJlcGVhdD0iaXRlbSBpbiBpdGVtcyI+PC9pb24taXRlbT4KICAgKiAgIDwvaW9uLWxpc3Q+CiAgICogPC9pb24tY29udGVudD4KICAgKiBgYGAKICAgKiBgYGBqcwogICAqIGFuZ3VsYXIubW9kdWxlKCd0ZXN0QXBwJywgWydpb25pYyddKQogICAqIC5jb250cm9sbGVyKCdNeUNvbnRyb2xsZXInLCBmdW5jdGlvbigkc2NvcGUsICRodHRwKSB7CiAqICAgJHNjb3BlLml0ZW1zID0gWzEsMiwzXTsKICogICAkc2NvcGUuZG9SZWZyZXNoID0gZnVuY3Rpb24oKSB7CiAqICAgICAkaHR0cC5nZXQoJy9uZXctaXRlbXMnKQogKiAgICAgIC5zdWNjZXNzKGZ1bmN0aW9uKG5ld0l0ZW1zKSB7CiAqICAgICAgICAkc2NvcGUuaXRlbXMgPSBuZXdJdGVtczsKICogICAgICB9KQogKiAgICAgIC5maW5hbGx5KGZ1bmN0aW9uKCkgewogKiAgICAgICAgLy8gU3RvcCB0aGUgaW9uLXJlZnJlc2hlciBmcm9tIHNwaW5uaW5nCiAqICAgICAgICAkc2NvcGUuJGJyb2FkY2FzdCgnc2Nyb2xsLnJlZnJlc2hDb21wbGV0ZScpOwogKiAgICAgIH0pOwogKiAgIH07CiAqIH0pOwogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtleHByZXNzaW9uPX0gb24tcmVmcmVzaCBDYWxsZWQgd2hlbiB0aGUgdXNlciBwdWxscyBkb3duIGVub3VnaCBhbmQgbGV0cyBnbwogICAqIG9mIHRoZSByZWZyZXNoZXIuCiAgICogQHBhcmFtIHtleHByZXNzaW9uPX0gb24tcHVsbGluZyBDYWxsZWQgd2hlbiB0aGUgdXNlciBzdGFydHMgdG8gcHVsbCBkb3duCiAgICogb24gdGhlIHJlZnJlc2hlci4KICAgKiBAcGFyYW0ge3N0cmluZz19IHB1bGxpbmctaWNvbiBUaGUgaWNvbiB0byBkaXNwbGF5IHdoaWxlIHRoZSB1c2VyIGlzIHB1bGxpbmcgZG93bi4KICAgKiBEZWZhdWx0OiAnaW9uLWFycm93LWRvd24tYycuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBwdWxsaW5nLXRleHQgVGhlIHRleHQgdG8gZGlzcGxheSB3aGlsZSB0aGUgdXNlciBpcyBwdWxsaW5nIGRvd24uCiAgICogQHBhcmFtIHtzdHJpbmc9fSByZWZyZXNoaW5nLWljb24gVGhlIGljb24gdG8gZGlzcGxheSBhZnRlciB1c2VyIGxldHMgZ28gb2YgdGhlCiAgICogcmVmcmVzaGVyLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gcmVmcmVzaGluZy10ZXh0IFRoZSB0ZXh0IHRvIGRpc3BsYXkgYWZ0ZXIgdGhlIHVzZXIgbGV0cyBnbyBvZgogICAqIHRoZSByZWZyZXNoZXIuCiAgICoKICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uUmVmcmVzaGVyJywgWyckaW9uaWNCaW5kJywgZnVuY3Rpb24oJGlvbmljQmluZCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICByZXF1aXJlOiAnXiRpb25pY1Njcm9sbCcsCiAgICAgICAgdGVtcGxhdGU6CiAgICAgICAgICAnPGRpdiBjbGFzcz0ic2Nyb2xsLXJlZnJlc2hlciI+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0iaW9uaWMtcmVmcmVzaGVyLWNvbnRlbnQiICcgKwogICAgICAgICAgJ25nLWNsYXNzPSJ7XCdpb25pYy1yZWZyZXNoZXItd2l0aC10ZXh0XCc6IHB1bGxpbmdUZXh0IHx8IHJlZnJlc2hpbmdUZXh0fSI+JyArCiAgICAgICAgICAnPGRpdiBjbGFzcz0iaWNvbi1wdWxsaW5nIj4nICsKICAgICAgICAgICc8aSBjbGFzcz0iaWNvbiB7e3B1bGxpbmdJY29ufX0iPjwvaT4nICsKICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICc8ZGl2IGNsYXNzPSJ0ZXh0LXB1bGxpbmciIG5nLWJpbmQtaHRtbD0icHVsbGluZ1RleHQiPjwvZGl2PicgKwogICAgICAgICAgJzxpIGNsYXNzPSJpY29uIHt7cmVmcmVzaGluZ0ljb259fSBpY29uLXJlZnJlc2hpbmciPjwvaT4nICsKICAgICAgICAgICc8ZGl2IGNsYXNzPSJ0ZXh0LXJlZnJlc2hpbmciIG5nLWJpbmQtaHRtbD0icmVmcmVzaGluZ1RleHQiPjwvZGl2PicgKwogICAgICAgICAgJzwvZGl2PicgKwogICAgICAgICAgJzwvZGl2PicsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oJGVsZW1lbnQsICRhdHRycykgewogICAgICAgICAgaWYgKGFuZ3VsYXIuaXNVbmRlZmluZWQoJGF0dHJzLnB1bGxpbmdJY29uKSkgewogICAgICAgICAgICAkYXR0cnMuJHNldCgncHVsbGluZ0ljb24nLCAnaW9uLWFycm93LWRvd24tYycpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGFuZ3VsYXIuaXNVbmRlZmluZWQoJGF0dHJzLnJlZnJlc2hpbmdJY29uKSkgewogICAgICAgICAgICAkYXR0cnMuJHNldCgncmVmcmVzaGluZ0ljb24nLCAnaW9uLWxvYWRpbmctZCcpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgc2Nyb2xsQ3RybCkgewogICAgICAgICAgICAkaW9uaWNCaW5kKCRzY29wZSwgJGF0dHJzLCB7CiAgICAgICAgICAgICAgcHVsbGluZ0ljb246ICdAJywKICAgICAgICAgICAgICBwdWxsaW5nVGV4dDogJ0AnLAogICAgICAgICAgICAgIHJlZnJlc2hpbmdJY29uOiAnQCcsCiAgICAgICAgICAgICAgcmVmcmVzaGluZ1RleHQ6ICdAJywKICAgICAgICAgICAgICAkb25SZWZyZXNoOiAnJm9uUmVmcmVzaCcsCiAgICAgICAgICAgICAgJG9uUHVsbGluZzogJyZvblB1bGxpbmcnCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc2Nyb2xsQ3RybC5fc2V0UmVmcmVzaGVyKCRzY29wZSwgJGVsZW1lbnRbMF0pOwogICAgICAgICAgICAkc2NvcGUuJG9uKCdzY3JvbGwucmVmcmVzaENvbXBsZXRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgJHNjb3BlLiRldmFsQXN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkZWxlbWVudFswXS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHNjcm9sbEN0cmwuc2Nyb2xsVmlldy5maW5pc2hQdWxsVG9SZWZyZXNoKCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH07CiAgICB9XSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25TY3JvbGwKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljU2Nyb2xsRGVsZWdhdGUKICAgKiBAY29kZXBlbiBtd0Z1aAogICAqIEByZXN0cmljdCBFCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBDcmVhdGVzIGEgc2Nyb2xsYWJsZSBjb250YWluZXIgZm9yIGFsbCBjb250ZW50IGluc2lkZS4KICAgKgogICAqIEB1c2FnZQogICAqCiAgICogQmFzaWMgdXNhZ2U6CiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi1zY3JvbGwgem9vbWluZz0idHJ1ZSIgZGlyZWN0aW9uPSJ4eSIgc3R5bGU9IndpZHRoOiA1MDBweDsgaGVpZ2h0OiA1MDBweCI+CiAgICogICA8ZGl2IHN0eWxlPSJ3aWR0aDogNTAwMHB4OyBoZWlnaHQ6IDUwMDBweDsgYmFja2dyb3VuZDogdXJsKCdodHRwczovL3VwbG9hZC53aWtpbWVkaWEub3JnL3dpa2lwZWRpYS9jb21tb25zL2EvYWQvRXVyb3BlX2dlb2xvZ2ljYWxfbWFwLWVuLmpwZycpIHJlcGVhdCI+PC9kaXY+CiAgICogIDwvaW9uLXNjcm9sbD4KICAgKiBgYGAKICAgKgogICAqIE5vdGUgdGhhdCBpdCdzIGltcG9ydGFudCB0byBzZXQgdGhlIGhlaWdodCBvZiB0aGUgc2Nyb2xsIGJveCBhcyB3ZWxsIGFzIHRoZSBoZWlnaHQgb2YgdGhlIGlubmVyCiAgICogY29udGVudCB0byBlbmFibGUgc2Nyb2xsaW5nLiBUaGlzIG1ha2VzIGl0IHBvc3NpYmxlIHRvIGhhdmUgZnVsbCBjb250cm9sIG92ZXIgc2Nyb2xsYWJsZSBhcmVhcy4KICAgKgogICAqIElmIHlvdSdkIGp1c3QgbGlrZSB0byBoYXZlIGEgY2VudGVyIGNvbnRlbnQgc2Nyb2xsaW5nIGFyZWEsIHVzZSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbkNvbnRlbnR9IGluc3RlYWQuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZz19IGRlbGVnYXRlLWhhbmRsZSBUaGUgaGFuZGxlIHVzZWQgdG8gaWRlbnRpZnkgdGhpcyBzY3JvbGxWaWV3CiAgICogd2l0aCB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNTY3JvbGxEZWxlZ2F0ZX0uCiAgICogQHBhcmFtIHtzdHJpbmc9fSBkaXJlY3Rpb24gV2hpY2ggd2F5IHRvIHNjcm9sbC4gJ3gnIG9yICd5JyBvciAneHknLiBEZWZhdWx0ICd5Jy4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBwYWdpbmcgV2hldGhlciB0byBzY3JvbGwgd2l0aCBwYWdpbmcuCiAgICogQHBhcmFtIHtleHByZXNzaW9uPX0gb24tcmVmcmVzaCBDYWxsZWQgb24gcHVsbC10by1yZWZyZXNoLCB0cmlnZ2VyZWQgYnkgYW4ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25SZWZyZXNoZXJ9LgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXNjcm9sbCBDYWxsZWQgd2hlbmV2ZXIgdGhlIHVzZXIgc2Nyb2xscy4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzY3JvbGxiYXIteCBXaGV0aGVyIHRvIHNob3cgdGhlIGhvcml6b250YWwgc2Nyb2xsYmFyLiBEZWZhdWx0IHRydWUuCiAgICogQHBhcmFtIHtib29sZWFuPX0gc2Nyb2xsYmFyLXkgV2hldGhlciB0byBzaG93IHRoZSB2ZXJ0aWNhbCBzY3JvbGxiYXIuIERlZmF1bHQgdHJ1ZS4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSB6b29taW5nIFdoZXRoZXIgdG8gc3VwcG9ydCBwaW5jaC10by16b29tCiAgICogQHBhcmFtIHtpbnRlZ2VyPX0gbWluLXpvb20gVGhlIHNtYWxsZXN0IHpvb20gYW1vdW50IGFsbG93ZWQgKGRlZmF1bHQgaXMgMC41KQogICAqIEBwYXJhbSB7aW50ZWdlcj19IG1heC16b29tIFRoZSBsYXJnZXN0IHpvb20gYW1vdW50IGFsbG93ZWQgKGRlZmF1bHQgaXMgMykKICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBoYXMtYm91bmNpbmcgV2hldGhlciB0byBhbGxvdyBzY3JvbGxpbmcgdG8gYm91bmNlIHBhc3QgdGhlIGVkZ2VzCiAgICogb2YgdGhlIGNvbnRlbnQuICBEZWZhdWx0cyB0byB0cnVlIG9uIGlPUywgZmFsc2Ugb24gQW5kcm9pZC4KICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uU2Nyb2xsJywgWwogICAgICAnJHRpbWVvdXQnLAogICAgICAnJGNvbnRyb2xsZXInLAogICAgICAnJGlvbmljQmluZCcsCiAgICAgIGZ1bmN0aW9uKCR0aW1lb3V0LCAkY29udHJvbGxlciwgJGlvbmljQmluZCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgc2NvcGU6IHRydWUsCiAgICAgICAgICBjb250cm9sbGVyOiBmdW5jdGlvbigpIHt9LAogICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICBlbGVtZW50LmFkZENsYXNzKCdzY3JvbGwtdmlldyBpb25pYy1zY3JvbGwnKTsKCiAgICAgICAgICAgIC8vV2UgY2Fubm90IHRyYW5zY2x1ZGUgaGVyZSBiZWNhdXNlIGl0IGJyZWFrcyBlbGVtZW50LmRhdGEoKSBpbmhlcml0YW5jZSBvbiBjb21waWxlCiAgICAgICAgICAgIHZhciBpbm5lckVsZW1lbnQgPSBqcUxpdGUoJzxkaXYgY2xhc3M9InNjcm9sbCI+PC9kaXY+Jyk7CiAgICAgICAgICAgIGlubmVyRWxlbWVudC5hcHBlbmQoZWxlbWVudC5jb250ZW50cygpKTsKICAgICAgICAgICAgZWxlbWVudC5hcHBlbmQoaW5uZXJFbGVtZW50KTsKCiAgICAgICAgICAgIHJldHVybiB7IHByZTogcHJlbGluayB9OwogICAgICAgICAgICBmdW5jdGlvbiBwcmVsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgICAgICAgICAgdmFyIHNjcm9sbFZpZXcsIHNjcm9sbEN0cmw7CgogICAgICAgICAgICAgICRpb25pY0JpbmQoJHNjb3BlLCAkYXR0ciwgewogICAgICAgICAgICAgICAgZGlyZWN0aW9uOiAnQCcsCiAgICAgICAgICAgICAgICBwYWdpbmc6ICdAJywKICAgICAgICAgICAgICAgICRvblNjcm9sbDogJyZvblNjcm9sbCcsCiAgICAgICAgICAgICAgICBzY3JvbGw6ICdAJywKICAgICAgICAgICAgICAgIHNjcm9sbGJhclg6ICdAJywKICAgICAgICAgICAgICAgIHNjcm9sbGJhclk6ICdAJywKICAgICAgICAgICAgICAgIHpvb21pbmc6ICdAJywKICAgICAgICAgICAgICAgIG1pblpvb206ICdAJywKICAgICAgICAgICAgICAgIG1heFpvb206ICdAJwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICRzY29wZS5kaXJlY3Rpb24gPSAkc2NvcGUuZGlyZWN0aW9uIHx8ICd5JzsKCiAgICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRyLnBhZGRpbmcpKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuJHdhdGNoKCRhdHRyLnBhZGRpbmcsIGZ1bmN0aW9uKG5ld1ZhbCkgewogICAgICAgICAgICAgICAgICBpbm5lckVsZW1lbnQudG9nZ2xlQ2xhc3MoJ3BhZGRpbmcnLCAhIW5ld1ZhbCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYoJHNjb3BlLiRldmFsKCRzY29wZS5wYWdpbmcpID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBpbm5lckVsZW1lbnQuYWRkQ2xhc3MoJ3Njcm9sbC1wYWdpbmcnKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmKCEkc2NvcGUuZGlyZWN0aW9uKSB7ICRzY29wZS5kaXJlY3Rpb24gPSAneSc7IH0KICAgICAgICAgICAgICB2YXIgaXNQYWdpbmcgPSAkc2NvcGUuJGV2YWwoJHNjb3BlLnBhZ2luZykgPT09IHRydWU7CgogICAgICAgICAgICAgIHZhciBzY3JvbGxWaWV3T3B0aW9ucz0gewogICAgICAgICAgICAgICAgZWw6ICRlbGVtZW50WzBdLAogICAgICAgICAgICAgICAgZGVsZWdhdGVIYW5kbGU6ICRhdHRyLmRlbGVnYXRlSGFuZGxlLAogICAgICAgICAgICAgICAgYm91bmNpbmc6ICRzY29wZS4kZXZhbCgkYXR0ci5oYXNCb3VuY2luZyksCiAgICAgICAgICAgICAgICBwYWdpbmc6IGlzUGFnaW5nLAogICAgICAgICAgICAgICAgc2Nyb2xsYmFyWDogJHNjb3BlLiRldmFsKCRzY29wZS5zY3JvbGxiYXJYKSAhPT0gZmFsc2UsCiAgICAgICAgICAgICAgICBzY3JvbGxiYXJZOiAkc2NvcGUuJGV2YWwoJHNjb3BlLnNjcm9sbGJhclkpICE9PSBmYWxzZSwKICAgICAgICAgICAgICAgIHNjcm9sbGluZ1g6ICRzY29wZS5kaXJlY3Rpb24uaW5kZXhPZigneCcpID49IDAsCiAgICAgICAgICAgICAgICBzY3JvbGxpbmdZOiAkc2NvcGUuZGlyZWN0aW9uLmluZGV4T2YoJ3knKSA+PSAwLAogICAgICAgICAgICAgICAgem9vbWluZzogJHNjb3BlLiRldmFsKCRzY29wZS56b29taW5nKSA9PT0gdHJ1ZSwKICAgICAgICAgICAgICAgIG1heFpvb206ICRzY29wZS4kZXZhbCgkc2NvcGUubWF4Wm9vbSkgfHwgMywKICAgICAgICAgICAgICAgIG1pblpvb206ICRzY29wZS4kZXZhbCgkc2NvcGUubWluWm9vbSkgfHwgMC41CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZiAoaXNQYWdpbmcpIHsKICAgICAgICAgICAgICAgIHNjcm9sbFZpZXdPcHRpb25zLnNwZWVkTXVsdGlwbGllciA9IDAuODsKICAgICAgICAgICAgICAgIHNjcm9sbFZpZXdPcHRpb25zLmJvdW5jaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBzY3JvbGxDdHJsID0gJGNvbnRyb2xsZXIoJyRpb25pY1Njcm9sbCcsIHsKICAgICAgICAgICAgICAgICRzY29wZTogJHNjb3BlLAogICAgICAgICAgICAgICAgc2Nyb2xsVmlld09wdGlvbnM6IHNjcm9sbFZpZXdPcHRpb25zCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgc2Nyb2xsVmlldyA9ICRzY29wZS4kcGFyZW50LnNjcm9sbFZpZXcgPSBzY3JvbGxDdHJsLnNjcm9sbFZpZXc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XSk7CgogIC8qKgogICAqIEBuZ2RvYyBkaXJlY3RpdmUKICAgKiBAbmFtZSBpb25TaWRlTWVudQogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgRQogICAqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51cwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQSBjb250YWluZXIgZm9yIGEgc2lkZSBtZW51LCBzaWJsaW5nIHRvIGFuIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnVDb250ZW50fSBkaXJlY3RpdmUuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGlvbi1zaWRlLW1lbnUKICAgKiAgIHNpZGU9ImxlZnQiCiAgICogICB3aWR0aD0ibXlXaWR0aFZhbHVlICsgMjAiCiAgICogICBpcy1lbmFibGVkPSJzaG91bGRMZWZ0U2lkZU1lbnVCZUVuYWJsZWQoKSI+CiAgICogPC9pb24tc2lkZS1tZW51PgogICAqIGBgYAogICAqIEZvciBhIGNvbXBsZXRlIHNpZGUgbWVudSBleGFtcGxlLCBzZWUgdGhlCiAgICoge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudXN9IGRvY3VtZW50YXRpb24uCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gc2lkZSBXaGljaCBzaWRlIHRoZSBzaWRlIG1lbnUgaXMgY3VycmVudGx5IG9uLiAgQWxsb3dlZCB2YWx1ZXM6ICdsZWZ0JyBvciAncmlnaHQnLgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IGlzLWVuYWJsZWQgV2hldGhlciB0aGlzIHNpZGUgbWVudSBpcyBlbmFibGVkLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gd2lkdGggSG93IG1hbnkgcGl4ZWxzIHdpZGUgdGhlIHNpZGUgbWVudSBzaG91bGQgYmUuICBEZWZhdWx0cyB0byAyNzUuCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvblNpZGVNZW51JywgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgICByZXF1aXJlOiAnXmlvblNpZGVNZW51cycsCiAgICAgICAgc2NvcGU6IHRydWUsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICAgICAgYW5ndWxhci5pc1VuZGVmaW5lZChhdHRyLmlzRW5hYmxlZCkgJiYgYXR0ci4kc2V0KCdpc0VuYWJsZWQnLCAndHJ1ZScpOwogICAgICAgICAgYW5ndWxhci5pc1VuZGVmaW5lZChhdHRyLndpZHRoKSAmJiBhdHRyLiRzZXQoJ3dpZHRoJywgJzI3NScpOwoKICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJ21lbnUgbWVudS0nICsgYXR0ci5zaWRlKTsKCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNpZGVNZW51Q3RybCkgewogICAgICAgICAgICAkc2NvcGUuc2lkZSA9ICRhdHRyLnNpZGUgfHwgJ2xlZnQnOwoKICAgICAgICAgICAgdmFyIHNpZGVNZW51ID0gc2lkZU1lbnVDdHJsWyRzY29wZS5zaWRlXSA9IG5ldyBpb25pYy52aWV3cy5TaWRlTWVudSh7CiAgICAgICAgICAgICAgd2lkdGg6IDI3NSwKICAgICAgICAgICAgICBlbDogJGVsZW1lbnRbMF0sCiAgICAgICAgICAgICAgaXNFbmFibGVkOiB0cnVlCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgkYXR0ci53aWR0aCwgZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgdmFyIG51bWJlclZhbCA9ICt2YWw7CiAgICAgICAgICAgICAgaWYgKG51bWJlclZhbCAmJiBudW1iZXJWYWwgPT0gdmFsKSB7CiAgICAgICAgICAgICAgICBzaWRlTWVudS5zZXRXaWR0aCgrdmFsKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAkc2NvcGUuJHdhdGNoKCRhdHRyLmlzRW5hYmxlZCwgZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgc2lkZU1lbnUuc2V0SXNFbmFibGVkKCEhdmFsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfTsKICAgIH0pOwoKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvblNpZGVNZW51Q29udGVudAogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgRQogICAqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51cwogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogQSBjb250YWluZXIgZm9yIHRoZSBtYWluIHZpc2libGUgY29udGVudCwgc2libGluZyB0byBvbmUgb3IgbW9yZQogICAqIHtAbGluayBpb25pYy5kaXJlY3RpdmU6aW9uU2lkZU1lbnV9IGRpcmVjdGl2ZXMuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGlvbi1zaWRlLW1lbnUtY29udGVudAogICAqICAgZWRnZS1kcmFnLXRocmVzaG9sZD0idHJ1ZSIKICAgKiAgIGRyYWctY29udGVudD0idHJ1ZSI+CiAgICogPC9pb24tc2lkZS1tZW51LWNvbnRlbnQ+CiAgICogYGBgCiAgICogRm9yIGEgY29tcGxldGUgc2lkZSBtZW51IGV4YW1wbGUsIHNlZSB0aGUKICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51c30gZG9jdW1lbnRhdGlvbi4KICAgKgogICAqIEBwYXJhbSB7Ym9vbGVhbj19IGRyYWctY29udGVudCBXaGV0aGVyIHRoZSBjb250ZW50IGNhbiBiZSBkcmFnZ2VkLiBEZWZhdWx0IHRydWUuCiAgICogQHBhcmFtIHtib29sZWFufG51bWJlcj19IGVkZ2UtZHJhZy10aHJlc2hvbGQgV2hldGhlciB0aGUgY29udGVudCBkcmFnIGNhbiBvbmx5IHN0YXJ0IGlmIGl0IGlzIGJlbG93IGEgY2VydGFpbiB0aHJlc2hvbGQgZGlzdGFuY2UgZnJvbSB0aGUgZWRnZSBvZiB0aGUgc2NyZWVuLiAgRGVmYXVsdCBmYWxzZS4gQWNjZXB0cyB0aHJlZSB0eXBlcyBvZiB2YWx1ZXM6CiAgICogIC0gSWYgYSBub24temVybyBudW1iZXIgaXMgZ2l2ZW4sIHRoYXQgbWFueSBwaXhlbHMgaXMgdXNlZCBhcyB0aGUgbWF4aW11bSBhbGxvd2VkIGRpc3RhbmNlIGZyb20gdGhlIGVkZ2UgdGhhdCBzdGFydHMgZHJhZ2dpbmcgdGhlIHNpZGUgbWVudS4KICAgKiAgLSBJZiB0cnVlIGlzIGdpdmVuLCB0aGUgZGVmYXVsdCBudW1iZXIgb2YgcGl4ZWxzICgyNSkgaXMgdXNlZCBhcyB0aGUgbWF4aW11bSBhbGxvd2VkIGRpc3RhbmNlLgogICAqICAtIElmIGZhbHNlIG9yIDAgaXMgZ2l2ZW4sIHRoZSBlZGdlIGRyYWcgdGhyZXNob2xkIGlzIGRpc2FibGVkLCBhbmQgZHJhZ2dpbmcgZnJvbSBhbnl3aGVyZSBvbiB0aGUgY29udGVudCBpcyBhbGxvd2VkLgogICAqCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvblNpZGVNZW51Q29udGVudCcsIFsKICAgICAgJyR0aW1lb3V0JywKICAgICAgJyRpb25pY0dlc3R1cmUnLAogICAgICBmdW5jdGlvbigkdGltZW91dCwgJGlvbmljR2VzdHVyZSkgewoKICAgICAgICByZXR1cm4gewogICAgICAgICAgcmVzdHJpY3Q6ICdFQScsIC8vREVQUkVDQVRFRCAnQScKICAgICAgICAgIHJlcXVpcmU6ICdeaW9uU2lkZU1lbnVzJywKICAgICAgICAgIHNjb3BlOiB0cnVlLAogICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICAgICAgICByZXR1cm4geyBwcmU6IHByZWxpbmsgfTsKICAgICAgICAgICAgZnVuY3Rpb24gcHJlbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0ciwgc2lkZU1lbnVDdHJsKSB7CgogICAgICAgICAgICAgICRlbGVtZW50LmFkZENsYXNzKCdtZW51LWNvbnRlbnQgcGFuZScpOwoKICAgICAgICAgICAgICBpZiAoaXNEZWZpbmVkKGF0dHIuZHJhZ0NvbnRlbnQpKSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuJHdhdGNoKGF0dHIuZHJhZ0NvbnRlbnQsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIHNpZGVNZW51Q3RybC5jYW5EcmFnQ29udGVudCh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2lkZU1lbnVDdHJsLmNhbkRyYWdDb250ZW50KHRydWUpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKGlzRGVmaW5lZChhdHRyLmVkZ2VEcmFnVGhyZXNob2xkKSkgewogICAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChhdHRyLmVkZ2VEcmFnVGhyZXNob2xkLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgICBzaWRlTWVudUN0cmwuZWRnZURyYWdUaHJlc2hvbGQodmFsdWUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB2YXIgZGVmYXVsdFByZXZlbnRlZCA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBpc0RyYWdnaW5nID0gZmFsc2U7CgogICAgICAgICAgICAgIC8vIExpc3RlbiBmb3IgdGFwcyBvbiB0aGUgY29udGVudCB0byBjbG9zZSB0aGUgbWVudQogICAgICAgICAgICAgIGZ1bmN0aW9uIGNvbnRlbnRUYXAoZSkgewogICAgICAgICAgICAgICAgaWYoc2lkZU1lbnVDdHJsLmdldE9wZW5BbW91bnQoKSAhPT0gMCkgewogICAgICAgICAgICAgICAgICBzaWRlTWVudUN0cmwuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgZS5nZXN0dXJlLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlvbmljLm9uKCd0YXAnLCBjb250ZW50VGFwLCAkZWxlbWVudFswXSk7CgogICAgICAgICAgICAgIHZhciBkcmFnRm4gPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBpZihkZWZhdWx0UHJldmVudGVkIHx8ICFzaWRlTWVudUN0cmwuaXNEcmFnZ2FibGVUYXJnZXQoZSkpIHJldHVybjsKICAgICAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgc2lkZU1lbnVDdHJsLl9oYW5kbGVEcmFnKGUpOwogICAgICAgICAgICAgICAgZS5nZXN0dXJlLnNyY0V2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgdmFyIGRyYWdWZXJ0Rm4gPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICBpZihpc0RyYWdnaW5nKSB7CiAgICAgICAgICAgICAgICAgIGUuZ2VzdHVyZS5zcmNFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgIC8vdmFyIGRyYWdHZXN0dXJlID0gR2VzdHVyZS5vbignZHJhZycsIGRyYWdGbiwgJGVsZW1lbnQpOwogICAgICAgICAgICAgIHZhciBkcmFnUmlnaHRHZXN0dXJlID0gJGlvbmljR2VzdHVyZS5vbignZHJhZ3JpZ2h0JywgZHJhZ0ZuLCAkZWxlbWVudCk7CiAgICAgICAgICAgICAgdmFyIGRyYWdMZWZ0R2VzdHVyZSA9ICRpb25pY0dlc3R1cmUub24oJ2RyYWdsZWZ0JywgZHJhZ0ZuLCAkZWxlbWVudCk7CiAgICAgICAgICAgICAgdmFyIGRyYWdVcEdlc3R1cmUgPSAkaW9uaWNHZXN0dXJlLm9uKCdkcmFndXAnLCBkcmFnVmVydEZuLCAkZWxlbWVudCk7CiAgICAgICAgICAgICAgdmFyIGRyYWdEb3duR2VzdHVyZSA9ICRpb25pY0dlc3R1cmUub24oJ2RyYWdkb3duJywgZHJhZ1ZlcnRGbiwgJGVsZW1lbnQpOwoKICAgICAgICAgICAgICB2YXIgZHJhZ1JlbGVhc2VGbiA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmKCFkZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgIHNpZGVNZW51Q3RybC5fZW5kRHJhZyhlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICB2YXIgcmVsZWFzZUdlc3R1cmUgPSAkaW9uaWNHZXN0dXJlLm9uKCdyZWxlYXNlJywgZHJhZ1JlbGVhc2VGbiwgJGVsZW1lbnQpOwoKICAgICAgICAgICAgICBzaWRlTWVudUN0cmwuc2V0Q29udGVudCh7CiAgICAgICAgICAgICAgICBlbGVtZW50OiBlbGVtZW50WzBdLAogICAgICAgICAgICAgICAgb25EcmFnOiBmdW5jdGlvbihlKSB7fSwKICAgICAgICAgICAgICAgIGVuZERyYWc6IGZ1bmN0aW9uKGUpIHt9LAogICAgICAgICAgICAgICAgZ2V0VHJhbnNsYXRlWDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiAkc2NvcGUuc2lkZU1lbnVDb250ZW50VHJhbnNsYXRlWCB8fCAwOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldFRyYW5zbGF0ZVg6IGlvbmljLmFuaW1hdGlvbkZyYW1lVGhyb3R0bGUoZnVuY3Rpb24oYW1vdW50KSB7CiAgICAgICAgICAgICAgICAgICRlbGVtZW50WzBdLnN0eWxlW2lvbmljLkNTUy5UUkFOU0ZPUk1dID0gJ3RyYW5zbGF0ZTNkKCcgKyBhbW91bnQgKyAncHgsIDAsIDApJzsKICAgICAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgJHNjb3BlLnNpZGVNZW51Q29udGVudFRyYW5zbGF0ZVggPSBhbW91bnQ7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBlbmFibGVBbmltYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAvL3RoaXMuZWwuY2xhc3NMaXN0LmFkZCh0aGlzLmFuaW1hdGVDbGFzcyk7CiAgICAgICAgICAgICAgICAgICRzY29wZS5hbmltYXRpb25FbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgJGVsZW1lbnRbMF0uY2xhc3NMaXN0LmFkZCgnbWVudS1hbmltYXRlZCcpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGRpc2FibGVBbmltYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAvL3RoaXMuZWwuY2xhc3NMaXN0LnJlbW92ZSh0aGlzLmFuaW1hdGVDbGFzcyk7CiAgICAgICAgICAgICAgICAgICRzY29wZS5hbmltYXRpb25FbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICRlbGVtZW50WzBdLmNsYXNzTGlzdC5yZW1vdmUoJ21lbnUtYW5pbWF0ZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgLy8gQ2xlYW51cAogICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAkaW9uaWNHZXN0dXJlLm9mZihkcmFnTGVmdEdlc3R1cmUsICdkcmFnbGVmdCcsIGRyYWdGbik7CiAgICAgICAgICAgICAgICAkaW9uaWNHZXN0dXJlLm9mZihkcmFnUmlnaHRHZXN0dXJlLCAnZHJhZ3JpZ2h0JywgZHJhZ0ZuKTsKICAgICAgICAgICAgICAgICRpb25pY0dlc3R1cmUub2ZmKGRyYWdVcEdlc3R1cmUsICdkcmFndXAnLCBkcmFnRm4pOwogICAgICAgICAgICAgICAgJGlvbmljR2VzdHVyZS5vZmYoZHJhZ0Rvd25HZXN0dXJlLCAnZHJhZ2Rvd24nLCBkcmFnRm4pOwogICAgICAgICAgICAgICAgJGlvbmljR2VzdHVyZS5vZmYocmVsZWFzZUdlc3R1cmUsICdyZWxlYXNlJywgZHJhZ1JlbGVhc2VGbik7CiAgICAgICAgICAgICAgICBpb25pYy5vZmYoJ3RhcCcsIGNvbnRlbnRUYXAsICRlbGVtZW50WzBdKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH1dKTsKCiAgSW9uaWNNb2R1bGUKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvblNpZGVNZW51cwogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAZGVsZWdhdGUgaW9uaWMuc2VydmljZTokaW9uaWNTaWRlTWVudURlbGVnYXRlCiAgICogQHJlc3RyaWN0IEUKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEEgY29udGFpbmVyIGVsZW1lbnQgZm9yIHNpZGUgbWVudShzKSBhbmQgdGhlIG1haW4gY29udGVudC4gQWxsb3dzIHRoZSBsZWZ0CiAgICogYW5kL29yIHJpZ2h0IHNpZGUgbWVudSB0byBiZSB0b2dnbGVkIGJ5IGRyYWdnaW5nIHRoZSBtYWluIGNvbnRlbnQgYXJlYSBzaWRlCiAgICogdG8gc2lkZS4KICAgKgogICAqIFRvIGF1dG9tYXRpY2FsbHkgY2xvc2UgYW4gb3BlbmVkIG1lbnUgeW91IGNhbiBhZGQgdGhlIHtAbGluayBpb25pYy5kaXJlY3RpdmU6bWVudUNsb3NlfQogICAqIGF0dHJpYnV0ZSBkaXJlY3RpdmUuIEluY2x1ZGluZyB0aGUgYG1lbnUtY2xvc2VgIGF0dHJpYnV0ZSBpcyB1c3VhbGx5IGFkZGVkIHRvCiAgICogbGlua3MgYW5kIGJ1dHRvbnMgd2l0aGluIGBpb24tc2lkZS1tZW51YCBjb250ZW50LCBzbyB0aGF0IHdoZW4gdGhlIGVsZW1lbnQgaXMKICAgKiBjbGlja2VkIHRoZW4gdGhlIG9wZW5lZCBzaWRlIG1lbnUgd2lsbCBhdXRvbWF0aWNhbGx5IGNsb3NlLgogICAqCiAgICogIVtTaWRlIE1lbnVdKGh0dHA6Ly9pb25pY2ZyYW1ld29yay5jb20uczMuYW1hem9uYXdzLmNvbS9kb2NzL2NvbnRyb2xsZXJzL3NpZGVtZW51LmdpZikKICAgKgogICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHNpZGUgbWVudXMsIGNoZWNrIG91dDoKICAgKgogICAqIC0ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25TaWRlTWVudUNvbnRlbnR9CiAgICogLSB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvblNpZGVNZW51fQogICAqIC0ge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTptZW51Q2xvc2V9CiAgICoKICAgKiBAdXNhZ2UKICAgKiBUbyB1c2Ugc2lkZSBtZW51cywgYWRkIGFuIGA8aW9uLXNpZGUtbWVudXM+YCBwYXJlbnQgZWxlbWVudCwKICAgKiBhbiBgPGlvbi1zaWRlLW1lbnUtY29udGVudD5gIGZvciB0aGUgY2VudGVyIGNvbnRlbnQsCiAgICogYW5kIG9uZSBvciBtb3JlIGA8aW9uLXNpZGUtbWVudT5gIGRpcmVjdGl2ZXMuCiAgICoKICAgKiBgYGBodG1sCiAgICogPGlvbi1zaWRlLW1lbnVzPgogICAqICAgPCEtLSBDZW50ZXIgY29udGVudCAtLT4KICAgKiAgIDxpb24tc2lkZS1tZW51LWNvbnRlbnQgbmctY29udHJvbGxlcj0iQ29udGVudENvbnRyb2xsZXIiPgogICAqICAgPC9pb24tc2lkZS1tZW51LWNvbnRlbnQ+CiAgICoKICAgKiAgIDwhLS0gTGVmdCBtZW51IC0tPgogICAqICAgPGlvbi1zaWRlLW1lbnUgc2lkZT0ibGVmdCI+CiAgICogICA8L2lvbi1zaWRlLW1lbnU+CiAgICoKICAgKiAgIDwhLS0gUmlnaHQgbWVudSAtLT4KICAgKiAgIDxpb24tc2lkZS1tZW51IHNpZGU9InJpZ2h0Ij4KICAgKiAgIDwvaW9uLXNpZGUtbWVudT4KICAgKiA8L2lvbi1zaWRlLW1lbnVzPgogICAqIGBgYAogICAqIGBgYGpzCiAgICogZnVuY3Rpb24gQ29udGVudENvbnRyb2xsZXIoJHNjb3BlLCAkaW9uaWNTaWRlTWVudURlbGVnYXRlKSB7CiAqICAgJHNjb3BlLnRvZ2dsZUxlZnQgPSBmdW5jdGlvbigpIHsKICogICAgICRpb25pY1NpZGVNZW51RGVsZWdhdGUudG9nZ2xlTGVmdCgpOwogKiAgIH07CiAqIH0KICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gZGVsZWdhdGUtaGFuZGxlIFRoZSBoYW5kbGUgdXNlZCB0byBpZGVudGlmeSB0aGlzIHNpZGUgbWVudQogICAqIHdpdGgge0BsaW5rIGlvbmljLnNlcnZpY2U6JGlvbmljU2lkZU1lbnVEZWxlZ2F0ZX0uCiAgICoKICAgKi8KICAgIC5kaXJlY3RpdmUoJ2lvblNpZGVNZW51cycsIFsnJGRvY3VtZW50JywgZnVuY3Rpb24oJGRvY3VtZW50KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgcmVzdHJpY3Q6ICdFQ0EnLAogICAgICAgIGNvbnRyb2xsZXI6ICckaW9uaWNTaWRlTWVudXMnLAogICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgIGF0dHIuJHNldCgnY2xhc3MnLCAoYXR0clsnY2xhc3MnXSB8fCAnJykgKyAnIHZpZXcnKTsKCiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlKSB7CiAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAkZG9jdW1lbnRbMF0uYm9keS5jbGFzc0xpc3QucmVtb3ZlKCdtZW51LW9wZW4nKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH07CiAgICB9XSk7CgoKICAvKioKICAgKiBAbmdkb2MgZGlyZWN0aXZlCiAgICogQG5hbWUgaW9uU2xpZGVCb3gKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljU2xpZGVCb3hEZWxlZ2F0ZQogICAqIEByZXN0cmljdCBFCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhlIFNsaWRlIEJveCBpcyBhIG11bHRpLXBhZ2UgY29udGFpbmVyIHdoZXJlIGVhY2ggcGFnZSBjYW4gYmUgc3dpcGVkIG9yIGRyYWdnZWQgYmV0d2VlbjoKICAgKgogICAqICFbU2xpZGVCb3hdKGh0dHA6Ly9pb25pY2ZyYW1ld29yay5jb20uczMuYW1hem9uYXdzLmNvbS9kb2NzL2NvbnRyb2xsZXJzL3NsaWRlQm94LmdpZikKICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8aW9uLXNsaWRlLWJveCBvbi1zbGlkZS1jaGFuZ2VkPSJzbGlkZUhhc0NoYW5nZWQoJGluZGV4KSI+CiAgICogICA8aW9uLXNsaWRlPgogICAqICAgICA8ZGl2IGNsYXNzPSJib3ggYmx1ZSI+PGgxPkJMVUU8L2gxPjwvZGl2PgogICAqICAgPC9pb24tc2xpZGU+CiAgICogICA8aW9uLXNsaWRlPgogICAqICAgICA8ZGl2IGNsYXNzPSJib3ggeWVsbG93Ij48aDE+WUVMTE9XPC9oMT48L2Rpdj4KICAgKiAgIDwvaW9uLXNsaWRlPgogICAqICAgPGlvbi1zbGlkZT4KICAgKiAgICAgPGRpdiBjbGFzcz0iYm94IHBpbmsiPjxoMT5QSU5LPC9oMT48L2Rpdj4KICAgKiAgIDwvaW9uLXNsaWRlPgogICAqIDwvaW9uLXNsaWRlLWJveD4KICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gZGVsZWdhdGUtaGFuZGxlIFRoZSBoYW5kbGUgdXNlZCB0byBpZGVudGlmeSB0aGlzIHNsaWRlQm94CiAgICogd2l0aCB7QGxpbmsgaW9uaWMuc2VydmljZTokaW9uaWNTbGlkZUJveERlbGVnYXRlfS4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBkb2VzLWNvbnRpbnVlIFdoZXRoZXIgdGhlIHNsaWRlIGJveCBzaG91bGQgbG9vcC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBhdXRvLXBsYXkgV2hldGhlciB0aGUgc2xpZGUgYm94IHNob3VsZCBhdXRvbWF0aWNhbGx5IHNsaWRlLiBEZWZhdWx0IHRydWUgaWYgZG9lcy1jb250aW51ZSBpcyB0cnVlLgogICAqIEBwYXJhbSB7bnVtYmVyPX0gc2xpZGUtaW50ZXJ2YWwgSG93IG1hbnkgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdG8gY2hhbmdlIHNsaWRlcyAoaWYgZG9lcy1jb250aW51ZSBpcyB0cnVlKS4gRGVmYXVsdHMgdG8gNDAwMC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBzaG93LXBhZ2VyIFdoZXRoZXIgYSBwYWdlciBzaG91bGQgYmUgc2hvd24gZm9yIHRoaXMgc2xpZGUgYm94LgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IHBhZ2VyLWNsaWNrIEV4cHJlc3Npb24gdG8gY2FsbCB3aGVuIGEgcGFnZXIgaXMgY2xpY2tlZCAoaWYgc2hvdy1wYWdlciBpcyB0cnVlKS4gSXMgcGFzc2VkIHRoZSAnaW5kZXgnIHZhcmlhYmxlLgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXNsaWRlLWNoYW5nZWQgRXhwcmVzc2lvbiBjYWxsZWQgd2hlbmV2ZXIgdGhlIHNsaWRlIGlzIGNoYW5nZWQuICBJcyBwYXNzZWQgYW4gJyRpbmRleCcgdmFyaWFibGUuCiAgICogQHBhcmFtIHtleHByZXNzaW9uPX0gYWN0aXZlLXNsaWRlIE1vZGVsIHRvIGJpbmQgdGhlIGN1cnJlbnQgc2xpZGUgdG8uCiAgICovCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvblNsaWRlQm94JywgWwogICAgICAnJHRpbWVvdXQnLAogICAgICAnJGNvbXBpbGUnLAogICAgICAnJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZScsCiAgICAgIGZ1bmN0aW9uKCR0aW1lb3V0LCAkY29tcGlsZSwgJGlvbmljU2xpZGVCb3hEZWxlZ2F0ZSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgcmVwbGFjZTogdHJ1ZSwKICAgICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgICBzY29wZTogewogICAgICAgICAgICBhdXRvUGxheTogJz0nLAogICAgICAgICAgICBkb2VzQ29udGludWU6ICdAJywKICAgICAgICAgICAgc2xpZGVJbnRlcnZhbDogJ0AnLAogICAgICAgICAgICBzaG93UGFnZXI6ICdAJywKICAgICAgICAgICAgcGFnZXJDbGljazogJyYnLAogICAgICAgICAgICBkaXNhYmxlU2Nyb2xsOiAnQCcsCiAgICAgICAgICAgIG9uU2xpZGVDaGFuZ2VkOiAnJicsCiAgICAgICAgICAgIGFjdGl2ZVNsaWRlOiAnPT8nCiAgICAgICAgICB9LAogICAgICAgICAgY29udHJvbGxlcjogWyckc2NvcGUnLCAnJGVsZW1lbnQnLCAnJGF0dHJzJywgZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHJzKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICB2YXIgY29udGludW91cyA9ICRzY29wZS4kZXZhbCgkc2NvcGUuZG9lc0NvbnRpbnVlKSA9PT0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHNob3VsZEF1dG9QbGF5ID0gaXNEZWZpbmVkKCRhdHRycy5hdXRvUGxheSkgPyAhISRzY29wZS5hdXRvUGxheSA6IGZhbHNlOwogICAgICAgICAgICB2YXIgc2xpZGVJbnRlcnZhbCA9IHNob3VsZEF1dG9QbGF5ID8gJHNjb3BlLiRldmFsKCRzY29wZS5zbGlkZUludGVydmFsKSB8fCA0MDAwIDogMDsKCiAgICAgICAgICAgIHZhciBzbGlkZXIgPSBuZXcgaW9uaWMudmlld3MuU2xpZGVyKHsKICAgICAgICAgICAgICBlbDogJGVsZW1lbnRbMF0sCiAgICAgICAgICAgICAgYXV0bzogc2xpZGVJbnRlcnZhbCwKICAgICAgICAgICAgICBjb250aW51b3VzOiBjb250aW51b3VzLAogICAgICAgICAgICAgIHN0YXJ0U2xpZGU6ICRzY29wZS5hY3RpdmVTbGlkZSwKICAgICAgICAgICAgICBzbGlkZXNDaGFuZ2VkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICRzY29wZS5jdXJyZW50U2xpZGUgPSBzbGlkZXIuY3VycmVudEluZGV4KCk7CgogICAgICAgICAgICAgICAgLy8gVHJ5IHRvIHRyaWdnZXIgYSBkaWdlc3QKICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkge30pOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKHNsaWRlSW5kZXgpIHsKICAgICAgICAgICAgICAgICRzY29wZS5jdXJyZW50U2xpZGUgPSBzbGlkZUluZGV4OwogICAgICAgICAgICAgICAgJHNjb3BlLm9uU2xpZGVDaGFuZ2VkKHsgaW5kZXg6ICRzY29wZS5jdXJyZW50U2xpZGUsICRpbmRleDogJHNjb3BlLmN1cnJlbnRTbGlkZX0pOwogICAgICAgICAgICAgICAgJHNjb3BlLiRwYXJlbnQuJGJyb2FkY2FzdCgnc2xpZGVCb3guc2xpZGVDaGFuZ2VkJywgc2xpZGVJbmRleCk7CiAgICAgICAgICAgICAgICAkc2NvcGUuYWN0aXZlU2xpZGUgPSBzbGlkZUluZGV4OwogICAgICAgICAgICAgICAgLy8gVHJ5IHRvIHRyaWdnZXIgYSBkaWdlc3QKICAgICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCkge30pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzbGlkZXIuZW5hYmxlU2xpZGUoJHNjb3BlLiRldmFsKCRhdHRycy5kaXNhYmxlU2Nyb2xsKSAhPT0gdHJ1ZSk7CgogICAgICAgICAgICAkc2NvcGUuJHdhdGNoKCdhY3RpdmVTbGlkZScsIGZ1bmN0aW9uKG52KSB7CiAgICAgICAgICAgICAgaWYoYW5ndWxhci5pc0RlZmluZWQobnYpKXsKICAgICAgICAgICAgICAgIHNsaWRlci5zbGlkZShudik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICRzY29wZS4kb24oJ3NsaWRlQm94Lm5leHRTbGlkZScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNsaWRlci5uZXh0KCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgJHNjb3BlLiRvbignc2xpZGVCb3gucHJldlNsaWRlJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgc2xpZGVyLnByZXYoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkc2NvcGUuJG9uKCdzbGlkZUJveC5zZXRTbGlkZScsIGZ1bmN0aW9uKGUsIGluZGV4KSB7CiAgICAgICAgICAgICAgc2xpZGVyLnNsaWRlKGluZGV4KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvL0V4cG9zZWQgZm9yIHRlc3RpbmcKICAgICAgICAgICAgdGhpcy5fX3NsaWRlciA9IHNsaWRlcjsKCiAgICAgICAgICAgIHZhciBkZXJlZ2lzdGVySW5zdGFuY2UgPSAkaW9uaWNTbGlkZUJveERlbGVnYXRlLl9yZWdpc3Rlckluc3RhbmNlKHNsaWRlciwgJGF0dHJzLmRlbGVnYXRlSGFuZGxlKTsKICAgICAgICAgICAgJHNjb3BlLiRvbignJGRlc3Ryb3knLCBkZXJlZ2lzdGVySW5zdGFuY2UpOwoKICAgICAgICAgICAgdGhpcy5zbGlkZXNDb3VudCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBzbGlkZXIuc2xpZGVzQ291bnQoKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMub25QYWdlckNsaWNrID0gZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgICAgICB2b2lkIDA7CiAgICAgICAgICAgICAgJHNjb3BlLnBhZ2VyQ2xpY2soe2luZGV4OiBpbmRleH0pOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgc2xpZGVyLmxvYWQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9XSwKICAgICAgICAgIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0ic2xpZGVyIj4nICsKICAgICAgICAgICAgJzxkaXYgY2xhc3M9InNsaWRlci1zbGlkZXMiIG5nLXRyYW5zY2x1ZGU+JyArCiAgICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICAgJzwvZGl2PicsCgogICAgICAgICAgbGluazogZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIHNsaWRlQm94Q3RybCkgewogICAgICAgICAgICAvLyBJZiB0aGUgcGFnZXIgc2hvdWxkIHNob3csIGFwcGVuZCBpdCB0byB0aGUgc2xpZGUgYm94CiAgICAgICAgICAgIGlmKCRzY29wZS4kZXZhbCgkc2NvcGUuc2hvd1BhZ2VyKSAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRTY29wZSA9ICRzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgdmFyIHBhZ2VyID0ganFMaXRlKCc8aW9uLXBhZ2VyPjwvaW9uLXBhZ2VyPicpOwogICAgICAgICAgICAgICRlbGVtZW50LmFwcGVuZChwYWdlcik7CiAgICAgICAgICAgICAgJGNvbXBpbGUocGFnZXIpKGNoaWxkU2NvcGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfV0pCiAgICAuZGlyZWN0aXZlKCdpb25TbGlkZScsIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gewogICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgcmVxdWlyZTogJ15pb25TbGlkZUJveCcsCiAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewogICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnc2xpZGVyLXNsaWRlJyk7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIpIHsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgfTsKICAgIH0pCgogICAgLmRpcmVjdGl2ZSgnaW9uUGFnZXInLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgcmVxdWlyZTogJ15pb25TbGlkZUJveCcsCiAgICAgICAgdGVtcGxhdGU6ICc8ZGl2IGNsYXNzPSJzbGlkZXItcGFnZXIiPjxzcGFuIGNsYXNzPSJzbGlkZXItcGFnZXItcGFnZSIgbmctcmVwZWF0PSJzbGlkZSBpbiBudW1TbGlkZXMoKSB0cmFjayBieSAkaW5kZXgiIG5nLWNsYXNzPSJ7YWN0aXZlOiAkaW5kZXggPT0gY3VycmVudFNsaWRlfSIgbmctY2xpY2s9InBhZ2VyQ2xpY2soJGluZGV4KSI+PGkgY2xhc3M9Imljb24gaW9uLXJlY29yZCI+PC9pPjwvc3Bhbj48L2Rpdj4nLAogICAgICAgIGxpbms6IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBzbGlkZUJveCkgewogICAgICAgICAgdmFyIHNlbGVjdFBhZ2UgPSBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSAkZWxlbWVudFswXS5jaGlsZHJlbjsKICAgICAgICAgICAgdmFyIGxlbmd0aCA9IGNoaWxkcmVuLmxlbmd0aDsKICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYoaSA9PSBpbmRleCkgewogICAgICAgICAgICAgICAgY2hpbGRyZW5baV0uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNoaWxkcmVuW2ldLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKCiAgICAgICAgICAkc2NvcGUucGFnZXJDbGljayA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICAgIHNsaWRlQm94Lm9uUGFnZXJDbGljayhpbmRleCk7CiAgICAgICAgICB9OwoKICAgICAgICAgICRzY29wZS5udW1TbGlkZXMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBBcnJheShzbGlkZUJveC5zbGlkZXNDb3VudCgpKTsKICAgICAgICAgIH07CgogICAgICAgICAgJHNjb3BlLiR3YXRjaCgnY3VycmVudFNsaWRlJywgZnVuY3Rpb24odikgewogICAgICAgICAgICBzZWxlY3RQYWdlKHYpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwoKICAgIH0pOwoKICBJb25pY01vZHVsZS5jb25zdGFudCgnJGlvbmljVGFiQ29uZmlnJywgewogICAgdHlwZTogJycKICB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvblRhYgogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAcmVzdHJpY3QgRQogICAqIEBwYXJlbnQgaW9uaWMuZGlyZWN0aXZlOmlvblRhYnMKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIENvbnRhaW5zIGEgdGFiJ3MgY29udGVudC4gIFRoZSBjb250ZW50IG9ubHkgZXhpc3RzIHdoaWxlIHRoZSBnaXZlbiB0YWIgaXMgc2VsZWN0ZWQuCiAgICoKICAgKiBFYWNoIGlvblRhYiBoYXMgaXRzIG93biB2aWV3IGhpc3RvcnkuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBgYGBodG1sCiAgICogPGlvbi10YWIKICAgKiAgIHRpdGxlPSJUYWIhIgogICAqICAgaWNvbj0ibXktaWNvbiIKICAgKiAgIGhyZWY9IiMvdGFiL3RhYi1saW5rIgogICAqICAgb24tc2VsZWN0PSJvblRhYlNlbGVjdGVkKCkiCiAgICogICBvbi1kZXNlbGVjdD0ib25UYWJEZXNlbGVjdGVkKCkiPgogICAqIDwvaW9uLXRhYj4KICAgKiBgYGAKICAgKiBGb3IgYSBjb21wbGV0ZSwgd29ya2luZyB0YWIgYmFyIGV4YW1wbGUsIHNlZSB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25UYWJzfSBkb2N1bWVudGF0aW9uLgogICAqCiAgICogQHBhcmFtIHtzdHJpbmd9IHRpdGxlIFRoZSB0aXRsZSBvZiB0aGUgdGFiLgogICAqIEBwYXJhbSB7c3RyaW5nPX0gaHJlZiBUaGUgbGluayB0aGF0IHRoaXMgdGFiIHdpbGwgbmF2aWdhdGUgdG8gd2hlbiB0YXBwZWQuCiAgICogQHBhcmFtIHtzdHJpbmc9fSBpY29uIFRoZSBpY29uIG9mIHRoZSB0YWIuIElmIGdpdmVuLCB0aGlzIHdpbGwgYmVjb21lIHRoZSBkZWZhdWx0IGZvciBpY29uLW9uIGFuZCBpY29uLW9mZi4KICAgKiBAcGFyYW0ge3N0cmluZz19IGljb24tb24gVGhlIGljb24gb2YgdGhlIHRhYiB3aGlsZSBpdCBpcyBzZWxlY3RlZC4KICAgKiBAcGFyYW0ge3N0cmluZz19IGljb24tb2ZmIFRoZSBpY29uIG9mIHRoZSB0YWIgd2hpbGUgaXQgaXMgbm90IHNlbGVjdGVkLgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IGJhZGdlIFRoZSBiYWRnZSB0byBwdXQgb24gdGhpcyB0YWIgKHVzdWFsbHkgYSBudW1iZXIpLgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IGJhZGdlLXN0eWxlIFRoZSBzdHlsZSBvZiBiYWRnZSB0byBwdXQgb24gdGhpcyB0YWIgKGVnIHRhYnMtcG9zaXRpdmUpLgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG9uLXNlbGVjdCBDYWxsZWQgd2hlbiB0aGlzIHRhYiBpcyBzZWxlY3RlZC4KICAgKiBAcGFyYW0ge2V4cHJlc3Npb249fSBvbi1kZXNlbGVjdCBDYWxsZWQgd2hlbiB0aGlzIHRhYiBpcyBkZXNlbGVjdGVkLgogICAqIEBwYXJhbSB7ZXhwcmVzc2lvbj19IG5nLWNsaWNrIEJ5IGRlZmF1bHQsIHRoZSB0YWIgd2lsbCBiZSBzZWxlY3RlZCBvbiBjbGljay4gSWYgbmdDbGljayBpcyBzZXQsIGl0IHdpbGwgbm90LiAgWW91IGNhbiBleHBsaWNpdGx5IHN3aXRjaCB0YWJzIHVzaW5nIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1RhYnNEZWxlZ2F0ZSNzZWxlY3QgJGlvbmljVGFic0RlbGVnYXRlLnNlbGVjdCgpfS4KICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uVGFiJywgWwogICAgICAnJHJvb3RTY29wZScsCiAgICAgICckYW5pbWF0ZScsCiAgICAgICckaW9uaWNCaW5kJywKICAgICAgJyRjb21waWxlJywKICAgICAgZnVuY3Rpb24oJHJvb3RTY29wZSwgJGFuaW1hdGUsICRpb25pY0JpbmQsICRjb21waWxlKSB7CgogICAgICAgIC8vUmV0dXJucyAnIGtleT0idmFsdWUiJyBpZiB2YWx1ZSBleGlzdHMKICAgICAgICBmdW5jdGlvbiBhdHRyU3RyKGssdikgewogICAgICAgICAgcmV0dXJuIGFuZ3VsYXIuaXNEZWZpbmVkKHYpID8gJyAnICsgayArICc9IicgKyB2ICsgJyInIDogJyc7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgICAgcmVxdWlyZTogWydeaW9uVGFicycsICdpb25UYWInXSwKICAgICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgICBjb250cm9sbGVyOiAnJGlvbmljVGFiJywKICAgICAgICAgIHNjb3BlOiB0cnVlLAogICAgICAgICAgY29tcGlsZTogZnVuY3Rpb24oZWxlbWVudCwgYXR0cikgewoKICAgICAgICAgICAgLy9XZSBjcmVhdGUgdGhlIHRhYk5hdlRlbXBsYXRlIGluIHRoZSBjb21waWxlIHBoYXNlIHNvIHRoYXQgdGhlCiAgICAgICAgICAgIC8vYXR0cmlidXRlcyB3ZSBwYXNzIGRvd24gd29uJ3QgYmUgaW50ZXJwb2xhdGVkIHlldCAtIHdlIHdhbnQKICAgICAgICAgICAgLy90byBwYXNzIGRvd24gdGhlICdyYXcnIHZlcnNpb25zIG9mIHRoZSBhdHRyaWJ1dGVzCiAgICAgICAgICAgIHZhciB0YWJOYXZUZW1wbGF0ZSA9ICc8aW9uLXRhYi1uYXYnICsKICAgICAgICAgICAgICBhdHRyU3RyKCduZy1jbGljaycsIGF0dHIubmdDbGljaykgKwogICAgICAgICAgICAgIGF0dHJTdHIoJ3RpdGxlJywgYXR0ci50aXRsZSkgKwogICAgICAgICAgICAgIGF0dHJTdHIoJ2ljb24nLCBhdHRyLmljb24pICsKICAgICAgICAgICAgICBhdHRyU3RyKCdpY29uLW9uJywgYXR0ci5pY29uT24pICsKICAgICAgICAgICAgICBhdHRyU3RyKCdpY29uLW9mZicsIGF0dHIuaWNvbk9mZikgKwogICAgICAgICAgICAgIGF0dHJTdHIoJ2JhZGdlJywgYXR0ci5iYWRnZSkgKwogICAgICAgICAgICAgIGF0dHJTdHIoJ2JhZGdlLXN0eWxlJywgYXR0ci5iYWRnZVN0eWxlKSArCiAgICAgICAgICAgICAgYXR0clN0cignaGlkZGVuJywgYXR0ci5oaWRkZW4pICsKICAgICAgICAgICAgICBhdHRyU3RyKCdjbGFzcycsIGF0dHJbJ2NsYXNzJ10pICsKICAgICAgICAgICAgICAnPjwvaW9uLXRhYi1uYXY+JzsKCiAgICAgICAgICAgIC8vUmVtb3ZlIHRoZSBjb250ZW50cyBvZiB0aGUgZWxlbWVudCBzbyB3ZSBjYW4gY29tcGlsZSB0aGVtIGxhdGVyLCBpZiB0YWIgaXMgc2VsZWN0ZWQKICAgICAgICAgICAgLy9XZSBkb24ndCB1c2UgcmVndWxhciB0cmFuc2NsdXNpb24gYmVjYXVzZSBpdCBicmVha3MgZWxlbWVudCBpbmhlcml0YW5jZQogICAgICAgICAgICB2YXIgdGFiQ29udGVudCA9IGpxTGl0ZSgnPGRpdiBjbGFzcz0icGFuZSI+JykKICAgICAgICAgICAgICAuYXBwZW5kKCBlbGVtZW50LmNvbnRlbnRzKCkucmVtb3ZlKCkgKTsKCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCBjdHJscykgewogICAgICAgICAgICAgIHZhciBjaGlsZFNjb3BlOwogICAgICAgICAgICAgIHZhciBjaGlsZEVsZW1lbnQ7CiAgICAgICAgICAgICAgdmFyIHRhYnNDdHJsID0gY3RybHNbMF07CiAgICAgICAgICAgICAgdmFyIHRhYkN0cmwgPSBjdHJsc1sxXTsKCiAgICAgICAgICAgICAgdmFyIG5hdlZpZXcgPSB0YWJDb250ZW50WzBdLnF1ZXJ5U2VsZWN0b3IoJ2lvbi1uYXYtdmlldycpIHx8CiAgICAgICAgICAgICAgICB0YWJDb250ZW50WzBdLnF1ZXJ5U2VsZWN0b3IoJ2RhdGEtaW9uLW5hdi12aWV3Jyk7CiAgICAgICAgICAgICAgdmFyIG5hdlZpZXdOYW1lID0gbmF2VmlldyAmJiBuYXZWaWV3LmdldEF0dHJpYnV0ZSgnbmFtZScpOwoKICAgICAgICAgICAgICAkaW9uaWNCaW5kKCRzY29wZSwgJGF0dHIsIHsKICAgICAgICAgICAgICAgIGFuaW1hdGU6ICc9JywKICAgICAgICAgICAgICAgIG9uU2VsZWN0OiAnJicsCiAgICAgICAgICAgICAgICBvbkRlc2VsZWN0OiAnJicsCiAgICAgICAgICAgICAgICB0aXRsZTogJ0AnLAogICAgICAgICAgICAgICAgdWlTcmVmOiAnQCcsCiAgICAgICAgICAgICAgICBocmVmOiAnQCcsCiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIHRhYnNDdHJsLmFkZCgkc2NvcGUpOwogICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0YWJzQ3RybC5yZW1vdmUoJHNjb3BlKTsKICAgICAgICAgICAgICAgIHRhYk5hdkVsZW1lbnQuaXNvbGF0ZVNjb3BlKCkuJGRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIHRhYk5hdkVsZW1lbnQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIC8vUmVtb3ZlIHRpdGxlIGF0dHJpYnV0ZSBzbyBicm93c2VyLXRvb2x0aXAgZG9lcyBub3QgYXBlYXIKICAgICAgICAgICAgICAkZWxlbWVudFswXS5yZW1vdmVBdHRyaWJ1dGUoJ3RpdGxlJyk7CgogICAgICAgICAgICAgIGlmIChuYXZWaWV3TmFtZSkgewogICAgICAgICAgICAgICAgdGFiQ3RybC5uYXZWaWV3TmFtZSA9IG5hdlZpZXdOYW1lOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAkc2NvcGUuJG9uKCckc3RhdGVDaGFuZ2VTdWNjZXNzJywgc2VsZWN0SWZNYXRjaGVzU3RhdGUpOwogICAgICAgICAgICAgIHNlbGVjdElmTWF0Y2hlc1N0YXRlKCk7CiAgICAgICAgICAgICAgZnVuY3Rpb24gc2VsZWN0SWZNYXRjaGVzU3RhdGUoKSB7CiAgICAgICAgICAgICAgICBpZiAodGFiQ3RybC50YWJNYXRjaGVzU3RhdGUoKSkgewogICAgICAgICAgICAgICAgICB0YWJzQ3RybC5zZWxlY3QoJHNjb3BlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHZhciB0YWJOYXZFbGVtZW50ID0ganFMaXRlKHRhYk5hdlRlbXBsYXRlKTsKICAgICAgICAgICAgICB0YWJOYXZFbGVtZW50LmRhdGEoJyRpb25UYWJzQ29udHJvbGxlcicsIHRhYnNDdHJsKTsKICAgICAgICAgICAgICB0YWJOYXZFbGVtZW50LmRhdGEoJyRpb25UYWJDb250cm9sbGVyJywgdGFiQ3RybCk7CiAgICAgICAgICAgICAgdGFic0N0cmwuJHRhYnNFbGVtZW50LmFwcGVuZCgkY29tcGlsZSh0YWJOYXZFbGVtZW50KSgkc2NvcGUpKTsKCiAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaCgnJHRhYlNlbGVjdGVkJywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGNoaWxkU2NvcGUgJiYgY2hpbGRTY29wZS4kZGVzdHJveSgpOwogICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgICBjaGlsZEVsZW1lbnQgJiYgJGFuaW1hdGUubGVhdmUoY2hpbGRFbGVtZW50KTsKICAgICAgICAgICAgICAgIGNoaWxkRWxlbWVudCA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgY2hpbGRTY29wZSA9ICRzY29wZS4kbmV3KCk7CiAgICAgICAgICAgICAgICAgIGNoaWxkRWxlbWVudCA9IHRhYkNvbnRlbnQuY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgJGFuaW1hdGUuZW50ZXIoY2hpbGRFbGVtZW50LCB0YWJzQ3RybC4kZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICRjb21waWxlKGNoaWxkRWxlbWVudCkoY2hpbGRTY29wZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH1dKTsKCiAgSW9uaWNNb2R1bGUKICAgIC5kaXJlY3RpdmUoJ2lvblRhYk5hdicsIFtmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICByZXN0cmljdDogJ0UnLAogICAgICAgIHJlcGxhY2U6IHRydWUsCiAgICAgICAgcmVxdWlyZTogWydeaW9uVGFicycsICdeaW9uVGFiJ10sCiAgICAgICAgdGVtcGxhdGU6CiAgICAgICAgICAnPGEgbmctY2xhc3M9IntcJ3RhYi1pdGVtLWFjdGl2ZVwnOiBpc1RhYkFjdGl2ZSgpLCBcJ2hhcy1iYWRnZVwnOmJhZGdlLCBcJ3RhYi1oaWRkZW5cJzppc0hpZGRlbigpfSIgJyArCiAgICAgICAgICAnIGNsYXNzPSJ0YWItaXRlbSI+JyArCiAgICAgICAgICAnPHNwYW4gY2xhc3M9ImJhZGdlIHt7YmFkZ2VTdHlsZX19IiBuZy1pZj0iYmFkZ2UiPnt7YmFkZ2V9fTwvc3Bhbj4nICsKICAgICAgICAgICc8aSBjbGFzcz0iaWNvbiB7e2dldEljb25PbigpfX0iIG5nLWlmPSJnZXRJY29uT24oKSAmJiBpc1RhYkFjdGl2ZSgpIj48L2k+JyArCiAgICAgICAgICAnPGkgY2xhc3M9Imljb24ge3tnZXRJY29uT2ZmKCl9fSIgbmctaWY9ImdldEljb25PZmYoKSAmJiAhaXNUYWJBY3RpdmUoKSI+PC9pPicgKwogICAgICAgICAgJzxzcGFuIGNsYXNzPSJ0YWItdGl0bGUiIG5nLWJpbmQtaHRtbD0idGl0bGUiPjwvc3Bhbj4nICsKICAgICAgICAgICc8L2E+JywKICAgICAgICBzY29wZTogewogICAgICAgICAgdGl0bGU6ICdAJywKICAgICAgICAgIGljb246ICdAJywKICAgICAgICAgIGljb25PbjogJ0AnLAogICAgICAgICAgaWNvbk9mZjogJ0AnLAogICAgICAgICAgYmFkZ2U6ICc9JywKICAgICAgICAgIGhpZGRlbjogJ0AnLAogICAgICAgICAgYmFkZ2VTdHlsZTogJ0AnLAogICAgICAgICAgJ2NsYXNzJzogJ0AnCiAgICAgICAgfSwKICAgICAgICBjb21waWxlOiBmdW5jdGlvbihlbGVtZW50LCBhdHRyLCB0cmFuc2NsdWRlKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gbGluaygkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsIGN0cmxzKSB7CiAgICAgICAgICAgIHZhciB0YWJzQ3RybCA9IGN0cmxzWzBdLAogICAgICAgICAgICAgIHRhYkN0cmwgPSBjdHJsc1sxXTsKCiAgICAgICAgICAgIC8vUmVtb3ZlIHRpdGxlIGF0dHJpYnV0ZSBzbyBicm93c2VyLXRvb2x0aXAgZG9lcyBub3QgYXBlYXIKICAgICAgICAgICAgJGVsZW1lbnRbMF0ucmVtb3ZlQXR0cmlidXRlKCd0aXRsZScpOwoKICAgICAgICAgICAgJHNjb3BlLnNlbGVjdFRhYiA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgdGFic0N0cmwuc2VsZWN0KHRhYkN0cmwuJHNjb3BlLCB0cnVlKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKCEkYXR0cnMubmdDbGljaykgewogICAgICAgICAgICAgICRlbGVtZW50Lm9uKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAkc2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAkc2NvcGUuc2VsZWN0VGFiKGV2ZW50KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkc2NvcGUuaXNIaWRkZW4gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZigkYXR0cnMuaGlkZGVuID09PSAndHJ1ZScgfHwgJGF0dHJzLmhpZGRlbiA9PT0gdHJ1ZSlyZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAkc2NvcGUuZ2V0SWNvbk9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuICRzY29wZS5pY29uT24gfHwgJHNjb3BlLmljb247CiAgICAgICAgICAgIH07CiAgICAgICAgICAgICRzY29wZS5nZXRJY29uT2ZmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuICRzY29wZS5pY29uT2ZmIHx8ICRzY29wZS5pY29uOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgJHNjb3BlLmlzVGFiQWN0aXZlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRhYnNDdHJsLnNlbGVjdGVkVGFiKCkgPT09IHRhYkN0cmwuJHNjb3BlOwogICAgICAgICAgICB9OwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH07CiAgICB9XSk7CgogIElvbmljTW9kdWxlLmNvbnN0YW50KCckaW9uaWNUYWJzQ29uZmlnJywgewogICAgcG9zaXRpb246ICcnLAogICAgdHlwZTogJycKICB9KTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvblRhYnMKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQGRlbGVnYXRlIGlvbmljLnNlcnZpY2U6JGlvbmljVGFic0RlbGVnYXRlCiAgICogQHJlc3RyaWN0IEUKICAgKiBAY29kZXBlbiBLYnJ6SgogICAqCiAgICogQGRlc2NyaXB0aW9uCiAgICogUG93ZXJzIGEgbXVsdGktdGFiYmVkIGludGVyZmFjZSB3aXRoIGEgVGFiIEJhciBhbmQgYSBzZXQgb2YgInBhZ2VzIiB0aGF0IGNhbiBiZSB0YWJiZWQKICAgKiB0aHJvdWdoLgogICAqCiAgICogQXNzaWduIGFueSBbdGFicyBjbGFzc10oL2RvY3MvY29tcG9uZW50cyN0YWJzKSBvcgogICAqIFthbmltYXRpb24gY2xhc3NdKC9kb2NzL2NvbXBvbmVudHMjYW5pbWF0aW9uKSB0byB0aGUgZWxlbWVudCB0byBkZWZpbmUKICAgKiBpdHMgbG9vayBhbmQgZmVlbC4KICAgKgogICAqIFNlZSB0aGUge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25UYWJ9IGRpcmVjdGl2ZSdzIGRvY3VtZW50YXRpb24gZm9yIG1vcmUgZGV0YWlscyBvbgogICAqIGluZGl2aWR1YWwgdGFicy4KICAgKgogICAqIE5vdGU6IGRvIG5vdCBwbGFjZSBpb24tdGFicyBpbnNpZGUgb2YgYW4gaW9uLWNvbnRlbnQgZWxlbWVudDsgaXQgaGFzIGJlZW4ga25vd24gdG8gY2F1c2UgYQogICAqIGNlcnRhaW4gQ1NTIGJ1Zy4KICAgKgogICAqIEB1c2FnZQogICAqIGBgYGh0bWwKICAgKiA8aW9uLXRhYnMgY2xhc3M9InRhYnMtcG9zaXRpdmUgdGFicy1pY29uLW9ubHkiPgogICAqCiAgICogICA8aW9uLXRhYiB0aXRsZT0iSG9tZSIgaWNvbi1vbj0iaW9uLWlvczctZmlsaW5nIiBpY29uLW9mZj0iaW9uLWlvczctZmlsaW5nLW91dGxpbmUiPgogICAqICAgICA8IS0tIFRhYiAxIGNvbnRlbnQgLS0+CiAgICogICA8L2lvbi10YWI+CiAgICoKICAgKiAgIDxpb24tdGFiIHRpdGxlPSJBYm91dCIgaWNvbi1vbj0iaW9uLWlvczctY2xvY2siIGljb24tb2ZmPSJpb24taW9zNy1jbG9jay1vdXRsaW5lIj4KICAgKiAgICAgPCEtLSBUYWIgMiBjb250ZW50IC0tPgogICAqICAgPC9pb24tdGFiPgogICAqCiAgICogICA8aW9uLXRhYiB0aXRsZT0iU2V0dGluZ3MiIGljb24tb249Imlvbi1pb3M3LWdlYXIiIGljb24tb2ZmPSJpb24taW9zNy1nZWFyLW91dGxpbmUiPgogICAqICAgICA8IS0tIFRhYiAzIGNvbnRlbnQgLS0+CiAgICogICA8L2lvbi10YWI+CiAgICoKICAgKiA8L2lvbi10YWJzPgogICAqIGBgYAogICAqCiAgICogQHBhcmFtIHtzdHJpbmc9fSBkZWxlZ2F0ZS1oYW5kbGUgVGhlIGhhbmRsZSB1c2VkIHRvIGlkZW50aWZ5IHRoZXNlIHRhYnMKICAgKiB3aXRoIHtAbGluayBpb25pYy5zZXJ2aWNlOiRpb25pY1RhYnNEZWxlZ2F0ZX0uCiAgICovCgogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25UYWJzJywgWwogICAgICAnJGlvbmljVmlld1NlcnZpY2UnLAogICAgICAnJGlvbmljVGFic0RlbGVnYXRlJywKICAgICAgJyRpb25pY1RhYnNDb25maWcnLAogICAgICBmdW5jdGlvbigkaW9uaWNWaWV3U2VydmljZSwgJGlvbmljVGFic0RlbGVnYXRlLCAkaW9uaWNUYWJzQ29uZmlnKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICBzY29wZTogdHJ1ZSwKICAgICAgICAgIGNvbnRyb2xsZXI6ICckaW9uaWNUYWJzJywKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygndmlldycpOwogICAgICAgICAgICAvL1dlIGNhbm5vdCB1c2UgcmVndWxhciB0cmFuc2NsdWRlIGhlcmUgYmVjYXVzZSBpdCBicmVha3MgZWxlbWVudC5kYXRhKCkKICAgICAgICAgICAgLy9pbmhlcml0YW5jZSBvbiBjb21waWxlCiAgICAgICAgICAgIHZhciBpbm5lckVsZW1lbnQgPSBqcUxpdGUoJzxkaXYgY2xhc3M9InRhYnMiPjwvZGl2PicpOwogICAgICAgICAgICBpbm5lckVsZW1lbnQuYXBwZW5kKGVsZW1lbnQuY29udGVudHMoKSk7CiAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKGlubmVyRWxlbWVudCk7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJGlvbmljVGFic0NvbmZpZy5wb3NpdGlvbik7CiAgICAgICAgICAgIGVsZW1lbnQuYWRkQ2xhc3MoJGlvbmljVGFic0NvbmZpZy50eXBlKTsKCiAgICAgICAgICAgIHJldHVybiB7IHByZTogcHJlbGluayB9OwogICAgICAgICAgICBmdW5jdGlvbiBwcmVsaW5rKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyLCB0YWJzQ3RybCkgewogICAgICAgICAgICAgIHZhciBkZXJlZ2lzdGVySW5zdGFuY2UgPSAkaW9uaWNUYWJzRGVsZWdhdGUuX3JlZ2lzdGVySW5zdGFuY2UoCiAgICAgICAgICAgICAgICB0YWJzQ3RybCwgJGF0dHIuZGVsZWdhdGVIYW5kbGUKICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGRlcmVnaXN0ZXJJbnN0YW5jZSk7CgogICAgICAgICAgICAgIHRhYnNDdHJsLiRzY29wZSA9ICRzY29wZTsKICAgICAgICAgICAgICB0YWJzQ3RybC4kZWxlbWVudCA9ICRlbGVtZW50OwogICAgICAgICAgICAgIHRhYnNDdHJsLiR0YWJzRWxlbWVudCA9IGpxTGl0ZSgkZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yKCcudGFicycpKTsKCiAgICAgICAgICAgICAgdmFyIGVsID0gJGVsZW1lbnRbMF07CiAgICAgICAgICAgICAgJHNjb3BlLiR3YXRjaChmdW5jdGlvbigpIHsgcmV0dXJuIGVsLmNsYXNzTmFtZTsgfSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBpc1RhYnNUb3AgPSB2YWx1ZS5pbmRleE9mKCd0YWJzLXRvcCcpICE9PSAtMTsKICAgICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IHZhbHVlLmluZGV4T2YoJ3RhYnMtaXRlbS1oaWRlJykgIT09IC0xOwogICAgICAgICAgICAgICAgJHNjb3BlLiRoYXNUYWJzID0gIWlzVGFic1RvcCAmJiAhaXNIaWRkZW47CiAgICAgICAgICAgICAgICAkc2NvcGUuJGhhc1RhYnNUb3AgPSBpc1RhYnNUb3AgJiYgIWlzSGlkZGVuOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICRzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBkZWxldGUgJHNjb3BlLiRoYXNUYWJzOwogICAgICAgICAgICAgICAgZGVsZXRlICRzY29wZS4kaGFzVGFic1RvcDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH1dKTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvblRvZ2dsZQogICAqIEBtb2R1bGUgaW9uaWMKICAgKiBAY29kZXBlbiB0ZkF6agogICAqIEByZXN0cmljdCBFCiAgICoKICAgKiBAZGVzY3JpcHRpb24KICAgKiBBIHRvZ2dsZSBpcyBhbiBhbmltYXRlZCBzd2l0Y2ggd2hpY2ggYmluZHMgYSBnaXZlbiBtb2RlbCB0byBhIGJvb2xlYW4uCiAgICoKICAgKiBBbGxvd3MgZHJhZ2dpbmcgb2YgdGhlIHN3aXRjaCdzIG51Yi4KICAgKgogICAqIFRoZSB0b2dnbGUgYmVoYXZlcyBsaWtlIGFueSBbQW5ndWxhckpTIGNoZWNrYm94XShodHRwOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZy9pbnB1dC9pbnB1dFtjaGVja2JveF0pIG90aGVyd2lzZS4KICAgKgogICAqIEBwYXJhbSB0b2dnbGUtY2xhc3Mge3N0cmluZz19IFNldHMgdGhlIENTUyBjbGFzcyBvbiB0aGUgaW5uZXIgYGxhYmVsLnRvZ2dsZWAgZWxlbWVudCBjcmVhdGVkIGJ5IHRoZSBkaXJlY3RpdmUuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBCZWxvdyBpcyBhbiBleGFtcGxlIG9mIGEgdG9nZ2xlIGRpcmVjdGl2ZSB3aGljaCBpcyB3aXJlZCB1cCB0byB0aGUgYGFpcnBsYW5lTW9kZWAgbW9kZWwKICAgKiBhbmQgaGFzIHRoZSBgdG9nZ2xlLWNhbG1gIENTUyBjbGFzcyBhc3NpZ25lZCB0byB0aGUgaW5uZXIgZWxlbWVudC4KICAgKgogICAqIGBgYGh0bWwKICAgKiA8aW9uLXRvZ2dsZSBuZy1tb2RlbD0iYWlycGxhbmVNb2RlIiB0b2dnbGUtY2xhc3M9InRvZ2dsZS1jYWxtIj5BaXJwbGFuZSBNb2RlPC9pb24tdG9nZ2xlPgogICAqIGBgYAogICAqLwogIElvbmljTW9kdWxlCiAgICAuZGlyZWN0aXZlKCdpb25Ub2dnbGUnLCBbCiAgICAgICckaW9uaWNHZXN0dXJlJywKICAgICAgJyR0aW1lb3V0JywKICAgICAgZnVuY3Rpb24oJGlvbmljR2VzdHVyZSwgJHRpbWVvdXQpIHsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgICAgICByZXBsYWNlOiB0cnVlLAogICAgICAgICAgcmVxdWlyZTogJz9uZ01vZGVsJywKICAgICAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgICAgICB0ZW1wbGF0ZToKICAgICAgICAgICAgJzxkaXYgY2xhc3M9Iml0ZW0gaXRlbS10b2dnbGUiPicgKwogICAgICAgICAgICAnPGRpdiBuZy10cmFuc2NsdWRlPjwvZGl2PicgKwogICAgICAgICAgICAnPGxhYmVsIGNsYXNzPSJ0b2dnbGUiPicgKwogICAgICAgICAgICAnPGlucHV0IHR5cGU9ImNoZWNrYm94Ij4nICsKICAgICAgICAgICAgJzxkaXYgY2xhc3M9InRyYWNrIj4nICsKICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImhhbmRsZSI+PC9kaXY+JyArCiAgICAgICAgICAgICc8L2Rpdj4nICsKICAgICAgICAgICAgJzwvbGFiZWw+JyArCiAgICAgICAgICAgICc8L2Rpdj4nLAoKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHIpIHsKICAgICAgICAgICAgdmFyIGlucHV0ID0gZWxlbWVudC5maW5kKCdpbnB1dCcpOwogICAgICAgICAgICBmb3JFYWNoKHsKICAgICAgICAgICAgICAnbmFtZSc6IGF0dHIubmFtZSwKICAgICAgICAgICAgICAnbmctdmFsdWUnOiBhdHRyLm5nVmFsdWUsCiAgICAgICAgICAgICAgJ25nLW1vZGVsJzogYXR0ci5uZ01vZGVsLAogICAgICAgICAgICAgICduZy1jaGVja2VkJzogYXR0ci5uZ0NoZWNrZWQsCiAgICAgICAgICAgICAgJ25nLWRpc2FibGVkJzogYXR0ci5uZ0Rpc2FibGVkLAogICAgICAgICAgICAgICduZy10cnVlLXZhbHVlJzogYXR0ci5uZ1RydWVWYWx1ZSwKICAgICAgICAgICAgICAnbmctZmFsc2UtdmFsdWUnOiBhdHRyLm5nRmFsc2VWYWx1ZSwKICAgICAgICAgICAgICAnbmctY2hhbmdlJzogYXR0ci5uZ0NoYW5nZQogICAgICAgICAgICB9LCBmdW5jdGlvbih2YWx1ZSwgbmFtZSkgewogICAgICAgICAgICAgIGlmIChpc0RlZmluZWQodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpbnB1dC5hdHRyKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYoYXR0ci50b2dnbGVDbGFzcykgewogICAgICAgICAgICAgIGVsZW1lbnRbMF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2xhYmVsJylbMF0uY2xhc3NMaXN0LmFkZChhdHRyLnRvZ2dsZUNsYXNzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRyKSB7CiAgICAgICAgICAgICAgdmFyIGVsLCBjaGVja2JveCwgdHJhY2ssIGhhbmRsZTsKCiAgICAgICAgICAgICAgZWwgPSAkZWxlbWVudFswXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnbGFiZWwnKVswXTsKICAgICAgICAgICAgICBjaGVja2JveCA9IGVsLmNoaWxkcmVuWzBdOwogICAgICAgICAgICAgIHRyYWNrID0gZWwuY2hpbGRyZW5bMV07CiAgICAgICAgICAgICAgaGFuZGxlID0gdHJhY2suY2hpbGRyZW5bMF07CgogICAgICAgICAgICAgIHZhciBuZ01vZGVsQ29udHJvbGxlciA9IGpxTGl0ZShjaGVja2JveCkuY29udHJvbGxlcignbmdNb2RlbCcpOwoKICAgICAgICAgICAgICAkc2NvcGUudG9nZ2xlID0gbmV3IGlvbmljLnZpZXdzLlRvZ2dsZSh7CiAgICAgICAgICAgICAgICBlbDogZWwsCiAgICAgICAgICAgICAgICB0cmFjazogdHJhY2ssCiAgICAgICAgICAgICAgICBjaGVja2JveDogY2hlY2tib3gsCiAgICAgICAgICAgICAgICBoYW5kbGU6IGhhbmRsZSwKICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYoY2hlY2tib3guY2hlY2tlZCkgewogICAgICAgICAgICAgICAgICAgIG5nTW9kZWxDb250cm9sbGVyLiRzZXRWaWV3VmFsdWUodHJ1ZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmdNb2RlbENvbnRyb2xsZXIuJHNldFZpZXdWYWx1ZShmYWxzZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgJHNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAkc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgJHNjb3BlLnRvZ2dsZS5kZXN0cm95KCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CgogICAgICAgIH07CiAgICAgIH1dKTsKCiAgLyoqCiAgICogQG5nZG9jIGRpcmVjdGl2ZQogICAqIEBuYW1lIGlvblZpZXcKICAgKiBAbW9kdWxlIGlvbmljCiAgICogQHJlc3RyaWN0IEUKICAgKiBAcGFyZW50IGlvbk5hdlZpZXcKICAgKgogICAqIEBkZXNjcmlwdGlvbgogICAqIEEgY29udGFpbmVyIGZvciBjb250ZW50LCB1c2VkIHRvIHRlbGwgYSBwYXJlbnQge0BsaW5rIGlvbmljLmRpcmVjdGl2ZTppb25OYXZCYXJ9CiAgICogYWJvdXQgdGhlIGN1cnJlbnQgdmlldy4KICAgKgogICAqIEB1c2FnZQogICAqIEJlbG93IGlzIGFuIGV4YW1wbGUgd2hlcmUgb3VyIHBhZ2Ugd2lsbCBsb2FkIHdpdGggYSBuYXZiYXIgY29udGFpbmluZyAiTXkgUGFnZSIgYXMgdGhlIHRpdGxlLgogICAqCiAgICogYGBgaHRtbAogICAqIDxpb24tbmF2LWJhcj48L2lvbi1uYXYtYmFyPgogICAqIDxpb24tbmF2LXZpZXcgY2xhc3M9InNsaWRlLWxlZnQtcmlnaHQiPgogICAqICAgPGlvbi12aWV3IHRpdGxlPSJNeSBQYWdlIj4KICAgKiAgICAgPGlvbi1jb250ZW50PgogICAqICAgICAgIEhlbGxvIQogICAqICAgICA8L2lvbi1jb250ZW50PgogICAqICAgPC9pb24tdmlldz4KICAgKiA8L2lvbi1uYXYtdmlldz4KICAgKiBgYGAKICAgKgogICAqIEBwYXJhbSB7c3RyaW5nPX0gdGl0bGUgVGhlIHRpdGxlIHRvIGRpc3BsYXkgb24gdGhlIHBhcmVudCB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0uCiAgICogQHBhcmFtIHtib29sZWFuPX0gaGlkZS1iYWNrLWJ1dHRvbiBXaGV0aGVyIHRvIGhpZGUgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBwYXJlbnQKICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0gYnkgZGVmYXVsdC4KICAgKiBAcGFyYW0ge2Jvb2xlYW49fSBoaWRlLW5hdi1iYXIgV2hldGhlciB0byBoaWRlIHRoZSBwYXJlbnQKICAgKiB7QGxpbmsgaW9uaWMuZGlyZWN0aXZlOmlvbk5hdkJhcn0gYnkgZGVmYXVsdC4KICAgKi8KICBJb25pY01vZHVsZQogICAgLmRpcmVjdGl2ZSgnaW9uVmlldycsIFsnJGlvbmljVmlld1NlcnZpY2UnLCAnJHJvb3RTY29wZScsICckYW5pbWF0ZScsCiAgICAgIGZ1bmN0aW9uKCAkaW9uaWNWaWV3U2VydmljZSwgICAkcm9vdFNjb3BlLCAgICRhbmltYXRlKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICAgICAgcHJpb3JpdHk6IDEwMDAsCiAgICAgICAgICByZXF1aXJlOiBbJ14/aW9uTmF2QmFyJywgJ14/aW9uTW9kYWwnXSwKICAgICAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMsIHRyYW5zY2x1ZGUpIHsKICAgICAgICAgICAgdEVsZW1lbnQuYWRkQ2xhc3MoJ3BhbmUnKTsKICAgICAgICAgICAgdEVsZW1lbnRbMF0ucmVtb3ZlQXR0cmlidXRlKCd0aXRsZScpOwoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGxpbmsoJHNjb3BlLCAkZWxlbWVudCwgJGF0dHIsIGN0cmxzKSB7CiAgICAgICAgICAgICAgdmFyIG5hdkJhckN0cmwgPSBjdHJsc1swXTsKICAgICAgICAgICAgICB2YXIgbW9kYWxDdHJsID0gY3RybHNbMV07CgogICAgICAgICAgICAgIC8vRG9uJ3QgdXNlIHRoZSBpb25WaWV3IGlmIHdlJ3JlIGluc2lkZSBhIG1vZGFsIG9yIHRoZXJlJ3Mgbm8gbmF2YmFyCiAgICAgICAgICAgICAgaWYgKCFuYXZCYXJDdHJsIHx8IG1vZGFsQ3RybCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRyLnRpdGxlKSkgewoKICAgICAgICAgICAgICAgIHZhciBpbml0aWFsVGl0bGUgPSAkYXR0ci50aXRsZTsKICAgICAgICAgICAgICAgIG5hdkJhckN0cmwuY2hhbmdlVGl0bGUoaW5pdGlhbFRpdGxlLCAkc2NvcGUuJG5hdkRpcmVjdGlvbik7CgogICAgICAgICAgICAgICAgLy8gd2F0Y2ggZm9yIGNoYW5nZXMgaW4gdGhlIHRpdGxlLCBkb24ndCBzZXQgaW5pdGlhbCB2YWx1ZSBhcyBjaGFuZ2VUaXRsZSBkb2VzIHRoYXQKICAgICAgICAgICAgICAgICRhdHRyLiRvYnNlcnZlKCd0aXRsZScsIGZ1bmN0aW9uKHZhbCwgb2xkVmFsKSB7CiAgICAgICAgICAgICAgICAgIG5hdkJhckN0cmwuc2V0VGl0bGUodmFsKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgdmFyIGhpZGVCYWNrQXR0ciA9IGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRyLmhpZGVCYWNrQnV0dG9uKSA/CiAgICAgICAgICAgICAgICAkYXR0ci5oaWRlQmFja0J1dHRvbiA6CiAgICAgICAgICAgICAgICAnZmFsc2UnOwogICAgICAgICAgICAgICRzY29wZS4kd2F0Y2goaGlkZUJhY2tBdHRyLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgLy8gU2hvdWxkIHdlIGhpZGUgYSBiYWNrIGJ1dHRvbiB3aGVuIHRoaXMgdGFiIGlzIHNob3duCiAgICAgICAgICAgICAgICBuYXZCYXJDdHJsLnNob3dCYWNrQnV0dG9uKCF2YWx1ZSk7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIHZhciBoaWRlTmF2QXR0ciA9IGFuZ3VsYXIuaXNEZWZpbmVkKCRhdHRyLmhpZGVOYXZCYXIpID8KICAgICAgICAgICAgICAgICRhdHRyLmhpZGVOYXZCYXIgOgogICAgICAgICAgICAgICAgJ2ZhbHNlJzsKICAgICAgICAgICAgICAkc2NvcGUuJHdhdGNoKGhpZGVOYXZBdHRyLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgLy8gU2hvdWxkIHRoZSBuYXYgYmFyIGJlIGhpZGRlbiBmb3IgdGhpcyB2aWV3IG9yIG5vdD8KICAgICAgICAgICAgICAgIG5hdkJhckN0cmwuc2hvd0JhcighdmFsdWUpOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9XSk7Cgp9KSgpOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 18:59:35 GMT",
                    "Content-Length": "1569910",
                    "Date": "Fri, 07 Nov 2014 19:00:04 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}