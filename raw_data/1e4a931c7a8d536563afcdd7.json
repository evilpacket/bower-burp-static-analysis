{
    "url": "http://localhost:9999/koala-framework/extjs/plugins/src/flash/html-template/history/history.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>window.location.pathname</b> and written to <b>the 'innerHTML' property of a DOM element</b> via the following statements:<ul><li>var file = window.location.pathname.toString();</li><li>file = file.substring(file.lastIndexOf(\"/\")+1);</li><li>getFormElement().innerHTML = '&lt;form name=\"historyForm\" action=\"'+file+'#' + flexAppUrl + '\" method=\"GET\"&gt;&lt;/form&gt;';</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/koala-framework/extjs/plugins/src/flash/html-template/history/history.js",
                "path": "/koala-framework/extjs/plugins/src/flash/html-template/history/history.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9rb2FsYS1mcmFtZXdvcmsvZXh0anMvcGx1Z2lucy9zcmMvZmxhc2gvaHRtbC10ZW1wbGF0ZS9oaXN0b3J5L2hpc3RvcnkuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjQ2NTYNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMjM6NTY6NTAgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDIzOjU2OjMwIEdNVA0KDQpCcm93c2VySGlzdG9yeVV0aWxzID0gewogICAgYWRkRXZlbnQ6IGZ1bmN0aW9uKGVsbSwgZXZUeXBlLCBmbiwgdXNlQ2FwdHVyZSkgewogICAgICAgIHVzZUNhcHR1cmUgPSB1c2VDYXB0dXJlIHx8IGZhbHNlOwogICAgICAgIGlmIChlbG0uYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICBlbG0uYWRkRXZlbnRMaXN0ZW5lcihldlR5cGUsIGZuLCB1c2VDYXB0dXJlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGVsbS5hdHRhY2hFdmVudCkgewogICAgICAgICAgICB2YXIgciA9IGVsbS5hdHRhY2hFdmVudCgnb24nICsgZXZUeXBlLCBmbik7CiAgICAgICAgICAgIHJldHVybiByOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZWxtWydvbicgKyBldlR5cGVdID0gZm47CiAgICAgICAgfQogICAgfQp9OwoKQnJvd3Nlckhpc3RvcnkgPSAoZnVuY3Rpb24oKSB7CiAgICAvLyB0eXBlIG9mIGJyb3dzZXIKICAgIHZhciBicm93c2VyID0gewogICAgICAgIGllOiBmYWxzZSwgCiAgICAgICAgaWU4OiBmYWxzZSwgCiAgICAgICAgZmlyZWZveDogZmFsc2UsIAogICAgICAgIHNhZmFyaTogZmFsc2UsIAogICAgICAgIG9wZXJhOiBmYWxzZSwgCiAgICAgICAgdmVyc2lvbjogLTEKICAgIH07CgogICAgLy8gRGVmYXVsdCBhcHAgc3RhdGUgVVJMIHRvIHVzZSB3aGVuIG5vIGZyYWdtZW50IElEIHByZXNlbnQKICAgIHZhciBkZWZhdWx0SGFzaCA9ICcnOwoKICAgIC8vIExhc3Qta25vd24gYXBwIHN0YXRlIFVSTAogICAgdmFyIGN1cnJlbnRIcmVmID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKCiAgICAvLyBJbml0aWFsIFVSTCAodXNlZCBvbmx5IGJ5IElFKQogICAgdmFyIGluaXRpYWxIcmVmID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKCiAgICAvLyBJbml0aWFsIFVSTCAodXNlZCBvbmx5IGJ5IElFKQogICAgdmFyIGluaXRpYWxIYXNoID0gZG9jdW1lbnQubG9jYXRpb24uaGFzaDsKCiAgICAvLyBIaXN0b3J5IGZyYW1lIHNvdXJjZSBVUkwgcHJlZml4ICh1c2VkIG9ubHkgYnkgSUUpCiAgICB2YXIgaGlzdG9yeUZyYW1lU291cmNlUHJlZml4ID0gJ2hpc3RvcnkvaGlzdG9yeUZyYW1lLmh0bWw/JzsKCiAgICAvLyBIaXN0b3J5IG1haW50ZW5hbmNlICh1c2VkIG9ubHkgYnkgU2FmYXJpKQogICAgdmFyIGN1cnJlbnRIaXN0b3J5TGVuZ3RoID0gLTE7CiAgICAKICAgIC8vIEZsYWcgdG8gZGVub3RlIHRoZSBleGlzdGVuY2Ugb2Ygb25oYXNoY2hhbmdlCiAgICB2YXIgYnJvd3Nlckhhc0hhc2hDaGFuZ2UgPSBmYWxzZTsKCiAgICB2YXIgaGlzdG9yeUhhc2ggPSBbXTsKCiAgICB2YXIgaW5pdGlhbFN0YXRlID0gY3JlYXRlU3RhdGUoaW5pdGlhbEhyZWYsIGluaXRpYWxIcmVmICsgJyMnICsgaW5pdGlhbEhhc2gsIGluaXRpYWxIYXNoKTsKCiAgICB2YXIgYmFja1N0YWNrID0gW107CiAgICB2YXIgZm9yd2FyZFN0YWNrID0gW107CgogICAgdmFyIGN1cnJlbnRPYmplY3RJZCA9IG51bGw7CgogICAgLy9Vc2VyQWdlbnQgZGV0ZWN0aW9uCiAgICB2YXIgdXNlcmFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpOwoKICAgIGlmICh1c2VyYWdlbnQuaW5kZXhPZigib3BlcmEiKSAhPSAtMSkgewogICAgICAgIGJyb3dzZXIub3BlcmEgPSB0cnVlOwogICAgfSBlbHNlIGlmICh1c2VyYWdlbnQuaW5kZXhPZigibXNpZSIpICE9IC0xKSB7CiAgICAgICAgYnJvd3Nlci5pZSA9IHRydWU7CiAgICAgICAgYnJvd3Nlci52ZXJzaW9uID0gcGFyc2VGbG9hdCh1c2VyYWdlbnQuc3Vic3RyaW5nKHVzZXJhZ2VudC5pbmRleE9mKCdtc2llJykgKyA0KSk7CiAgICAgICAgaWYgKGJyb3dzZXIudmVyc2lvbiA9PSA4KQogICAgICAgIHsKICAgICAgICAgICAgYnJvd3Nlci5pZSA9IGZhbHNlOwogICAgICAgICAgICBicm93c2VyLmllOCA9IHRydWU7CiAgICAgICAgfQogICAgfSBlbHNlIGlmICh1c2VyYWdlbnQuaW5kZXhPZigic2FmYXJpIikgIT0gLTEpIHsKICAgICAgICBicm93c2VyLnNhZmFyaSA9IHRydWU7CiAgICAgICAgYnJvd3Nlci52ZXJzaW9uID0gcGFyc2VGbG9hdCh1c2VyYWdlbnQuc3Vic3RyaW5nKHVzZXJhZ2VudC5pbmRleE9mKCdzYWZhcmknKSArIDcpKTsKICAgIH0gZWxzZSBpZiAodXNlcmFnZW50LmluZGV4T2YoImdlY2tvIikgIT0gLTEpIHsKICAgICAgICBicm93c2VyLmZpcmVmb3ggPSB0cnVlOwogICAgfQoKICAgIGlmIChicm93c2VyLmllID09IHRydWUgJiYgYnJvd3Nlci52ZXJzaW9uID09IDcpIHsKICAgICAgICB3aW5kb3dbIl9pZV9maXJzdGxvYWQiXSA9IGZhbHNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGhhc2hDaGFuZ2VIYW5kbGVyKCkKICAgIHsKICAgICAgICBjdXJyZW50SHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgdmFyIGZsZXhBcHBVcmwgPSBnZXRIYXNoKCk7CiAgICAgICAgLy9BRFI6IHRvIGZpeCBtdWx0aXBsZQogICAgICAgIGlmICh0eXBlb2YgQnJvd3Nlckhpc3RvcnlfbXVsdGlwbGUgIT0gInVuZGVmaW5lZCIgJiYgQnJvd3Nlckhpc3RvcnlfbXVsdGlwbGUgPT0gdHJ1ZSkgewogICAgICAgICAgICB2YXIgcGwgPSBnZXRQbGF5ZXJzKCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHBsW2ldLmJyb3dzZXJVUkxDaGFuZ2UoZmxleEFwcFVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnZXRQbGF5ZXIoKS5icm93c2VyVVJMQ2hhbmdlKGZsZXhBcHBVcmwpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBBY2Nlc3NvciBmdW5jdGlvbnMgZm9yIG9idGFpbmluZyBzcGVjaWZpYyBlbGVtZW50cyBvZiB0aGUgcGFnZS4KICAgIGZ1bmN0aW9uIGdldEhpc3RvcnlGcmFtZSgpCiAgICB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpZV9oaXN0b3J5RnJhbWUnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRGb3JtRWxlbWVudCgpCiAgICB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzYWZhcmlfZm9ybURpdicpOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFJlbWVtYmVyRWxlbWVudCgpCiAgICB7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzYWZhcmlfcmVtZW1iZXJfZmllbGQiKTsKICAgIH0KCiAgICAvLyBHZXQgdGhlIEZsYXNoIHBsYXllciBvYmplY3QgZm9yIHBlcmZvcm1pbmcgRXh0ZXJuYWxJbnRlcmZhY2UgY2FsbGJhY2tzLgogICAgLy8gVXBkYXRlZCBmb3IgY2hhbmdlcyB0byBTV0ZPYmplY3QyLgogICAgZnVuY3Rpb24gZ2V0UGxheWVyKGlkKSB7CiAgICAgICAgdmFyIGk7CgoJCWlmIChpZCAmJiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCkpIHsKCQkJdmFyIHIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CgkJCWlmICh0eXBlb2Ygci5TZXRWYXJpYWJsZSAhPSAidW5kZWZpbmVkIikgewoJCQkJcmV0dXJuIHI7CgkJCX0KCQkJZWxzZSB7CgkJCQl2YXIgbyA9IHIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9iamVjdCIpOwoJCQkJdmFyIGUgPSByLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJlbWJlZCIpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG8ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9baV0uYnJvd3NlclVSTENoYW5nZSAhPSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9baV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZVtpXS5icm93c2VyVVJMQ2hhbmdlICE9ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZVtpXTsKICAgICAgICAgICAgICAgIH0KCQkJfQoJCX0KCQllbHNlIHsKCQkJdmFyIG8gPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgib2JqZWN0Iik7CgkJCXZhciBlID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImVtYmVkIik7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVbaV0uYnJvd3NlclVSTENoYW5nZSAhPSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZVtpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgby5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvW2ldLmJyb3dzZXJVUkxDaGFuZ2UgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9baV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCQl9CgkJcmV0dXJuIHVuZGVmaW5lZDsKCX0KICAgIAogICAgZnVuY3Rpb24gZ2V0UGxheWVycygpIHsKICAgICAgICB2YXIgaTsKICAgICAgICB2YXIgcGxheWVycyA9IFtdOwogICAgICAgIGlmIChwbGF5ZXJzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgIHZhciB0bXAgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0Jyk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0bXAubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdG1wW2ldLmJyb3dzZXJVUkxDaGFuZ2UgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICAgICAgcGxheWVycy5wdXNoKHRtcFtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHBsYXllcnMubGVuZ3RoID09IDAgfHwgcGxheWVyc1swXS5vYmplY3QgPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdG1wID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2VtYmVkJyk7CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0bXAubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdG1wW2ldLmJyb3dzZXJVUkxDaGFuZ2UgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICAgICAgcGxheWVycy5wdXNoKHRtcFtpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHBsYXllcnM7CiAgICB9CgoJZnVuY3Rpb24gZ2V0SWZyYW1lSGFzaCgpIHsKCQl2YXIgZG9jID0gZ2V0SGlzdG9yeUZyYW1lKCkuY29udGVudFdpbmRvdy5kb2N1bWVudDsKCQl2YXIgaGFzaCA9IFN0cmluZyhkb2MubG9jYXRpb24uc2VhcmNoKTsKCQlpZiAoaGFzaC5sZW5ndGggPT0gMSAmJiBoYXNoLmNoYXJBdCgwKSA9PSAiPyIpIHsKCQkJaGFzaCA9ICIiOwoJCX0KCQllbHNlIGlmIChoYXNoLmxlbmd0aCA+PSAyICYmIGhhc2guY2hhckF0KDApID09ICI/IikgewoJCQloYXNoID0gaGFzaC5zdWJzdHJpbmcoMSk7CgkJfQoJCXJldHVybiBoYXNoOwoJfQoKICAgIC8qIEdldCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoIGV4Y2x1ZGluZyB0aGUgJyMnIHN5bWJvbC4gKi8KICAgIGZ1bmN0aW9uIGdldEhhc2goKSB7CiAgICAgICAvLyBJdCB3b3VsZCBiZSBuaWNlIGlmIHdlIGNvdWxkIHVzZSBkb2N1bWVudC5sb2NhdGlvbi5oYXNoIGhlcmUsCiAgICAgICAvLyBidXQgaXQncyBmYXVsdHkgc29tZXRpbWVzLgogICAgICAgdmFyIGlkeCA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYuaW5kZXhPZignIycpOwogICAgICAgcmV0dXJuIChpZHggPj0gMCkgPyBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLnN1YnN0cihpZHgrMSkgOiAnJzsKICAgIH0KCiAgICAvKiBHZXQgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaCBleGNsdWRpbmcgdGhlICcjJyBzeW1ib2wuICovCiAgICBmdW5jdGlvbiBzZXRIYXNoKGhhc2gpIHsKICAgICAgIC8vIEl0IHdvdWxkIGJlIG5pY2UgaWYgd2UgY291bGQgdXNlIGRvY3VtZW50LmxvY2F0aW9uLmhhc2ggaGVyZSwKICAgICAgIC8vIGJ1dCBpdCdzIGZhdWx0eSBzb21ldGltZXMuCiAgICAgICBpZiAoaGFzaCA9PSAnJykgaGFzaCA9ICcjJzsKICAgICAgIGRvY3VtZW50LmxvY2F0aW9uLmhhc2ggPSBoYXNoOwogICAgfQoKICAgIGZ1bmN0aW9uIGNyZWF0ZVN0YXRlKGJhc2VVcmwsIG5ld1VybCwgZmxleEFwcFVybCkgewogICAgICAgIHJldHVybiB7ICdiYXNlVXJsJzogYmFzZVVybCwgJ25ld1VybCc6IG5ld1VybCwgJ2ZsZXhBcHBVcmwnOiBmbGV4QXBwVXJsLCAndGl0bGUnOiBudWxsIH07CiAgICB9CgogICAgLyogQWRkIGEgaGlzdG9yeSBlbnRyeSB0byB0aGUgYnJvd3Nlci4KICAgICAqICAgYmFzZVVybDogdGhlIHBvcnRpb24gb2YgdGhlIGxvY2F0aW9uIHByaW9yIHRvIHRoZSAnIycKICAgICAqICAgbmV3VXJsOiB0aGUgZW50aXJlIG5ldyBVUkwsIGluY2x1ZGluZyAnIycgYW5kIGZvbGxvd2luZyBmcmFnbWVudAogICAgICogICBmbGV4QXBwVXJsOiB0aGUgcG9ydGlvbiBvZiB0aGUgbG9jYXRpb24gZm9sbG93aW5nIHRoZSAnIycgb25seQogICAgICovCiAgICBmdW5jdGlvbiBhZGRIaXN0b3J5RW50cnkoYmFzZVVybCwgbmV3VXJsLCBmbGV4QXBwVXJsKSB7CgogICAgICAgIC8vZGVsZXRlIGFsbCB0aGUgaGlzdG9yeSBlbnRyaWVzCiAgICAgICAgZm9yd2FyZFN0YWNrID0gW107CgogICAgICAgIGlmIChicm93c2VyLmllKSB7CiAgICAgICAgICAgIC8vQ2hlY2sgdG8gc2VlIGlmIHdlIGFyZSBiZWluZyBhc2tlZCB0byBkbyBhIG5hdmlnYXRlIGZvciB0aGUgZmlyc3QKICAgICAgICAgICAgLy9oaXN0b3J5IGVudHJ5LCBhbmQgaWYgc28gaWdub3JlLCBiZWNhdXNlIGl0J3MgY29taW5nIGZyb20gdGhlIGNyZWF0aW9uCiAgICAgICAgICAgIC8vb2YgdGhlIGhpc3RvcnkgaWZyYW1lCiAgICAgICAgICAgIGlmIChmbGV4QXBwVXJsID09IGRlZmF1bHRIYXNoICYmIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgPT0gaW5pdGlhbEhyZWYgJiYgd2luZG93WydfaWVfZmlyc3Rsb2FkJ10pIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIcmVmID0gaW5pdGlhbEhyZWY7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCghZmxleEFwcFVybCB8fCBmbGV4QXBwVXJsID09IGRlZmF1bHRIYXNoKSAmJiB3aW5kb3dbJ19pZV9maXJzdGxvYWQnXSkgewogICAgICAgICAgICAgICAgbmV3VXJsID0gYmFzZVVybCArICcjJyArIGRlZmF1bHRIYXNoOwogICAgICAgICAgICAgICAgZmxleEFwcFVybCA9IGRlZmF1bHRIYXNoOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gZm9yIElFLCB0ZWxsIHRoZSBoaXN0b3J5IGZyYW1lIHRvIGdvIHNvbWV3aGVyZSB3aXRob3V0IGEgJyMnCiAgICAgICAgICAgICAgICAvLyBpbiBvcmRlciB0byBnZXQgdGhpcyBlbnRyeSBpbnRvIHRoZSBicm93c2VyIGhpc3RvcnkuCiAgICAgICAgICAgICAgICBnZXRIaXN0b3J5RnJhbWUoKS5zcmMgPSBoaXN0b3J5RnJhbWVTb3VyY2VQcmVmaXggKyBmbGV4QXBwVXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldEhhc2goZmxleEFwcFVybCk7CiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIC8vQURSCiAgICAgICAgICAgIGlmIChiYWNrU3RhY2subGVuZ3RoID09IDAgJiYgaW5pdGlhbFN0YXRlLmZsZXhBcHBVcmwgPT0gZmxleEFwcFVybCkgewogICAgICAgICAgICAgICAgaW5pdGlhbFN0YXRlID0gY3JlYXRlU3RhdGUoYmFzZVVybCwgbmV3VXJsLCBmbGV4QXBwVXJsKTsKICAgICAgICAgICAgfSBlbHNlIGlmKGJhY2tTdGFjay5sZW5ndGggPiAwICYmIGJhY2tTdGFja1tiYWNrU3RhY2subGVuZ3RoIC0gMV0uZmxleEFwcFVybCA9PSBmbGV4QXBwVXJsKSB7CiAgICAgICAgICAgICAgICBiYWNrU3RhY2tbYmFja1N0YWNrLmxlbmd0aCAtIDFdID0gY3JlYXRlU3RhdGUoYmFzZVVybCwgbmV3VXJsLCBmbGV4QXBwVXJsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGJyb3dzZXIuc2FmYXJpICYmICFicm93c2VySGFzSGFzaENoYW5nZSkgewogICAgICAgICAgICAgICAgLy8gZm9yIFNhZmFyaSwgc3VibWl0IGEgZm9ybSB3aG9zZSBhY3Rpb24gcG9pbnRzIHRvIHRoZSBkZXNpcmVkIFVSTAogICAgICAgICAgICAgICAgaWYgKGJyb3dzZXIudmVyc2lvbiA8PSA0MTkuMykgewogICAgICAgICAgICAgICAgICAgIHZhciBmaWxlID0gd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgZmlsZSA9IGZpbGUuc3Vic3RyaW5nKGZpbGUubGFzdEluZGV4T2YoIi8iKSsxKTsKICAgICAgICAgICAgICAgICAgICBnZXRGb3JtRWxlbWVudCgpLmlubmVySFRNTCA9ICc8Zm9ybSBuYW1lPSJoaXN0b3J5Rm9ybSIgYWN0aW9uPSInK2ZpbGUrJyMnICsgZmxleEFwcFVybCArICciIG1ldGhvZD0iR0VUIj48L2Zvcm0+JzsKICAgICAgICAgICAgICAgICAgICAvL2dldCB0aGUgY3VycmVudCBlbGVtZW50cyBhbmQgYWRkIHRoZW0gdG8gdGhlIGZvcm0KICAgICAgICAgICAgICAgICAgICB2YXIgcXMgPSB3aW5kb3cubG9jYXRpb24uc2VhcmNoLnN1YnN0cmluZygxKTsKICAgICAgICAgICAgICAgICAgICB2YXIgcXNfYXJyID0gcXMuc3BsaXQoIiYiKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHFzX2Fyci5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG1wID0gcXNfYXJyW2ldLnNwbGl0KCI9Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS50eXBlID0gImhpZGRlbiI7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0ubmFtZSA9IHRtcFswXTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxlbS52YWx1ZSA9IHRtcFsxXTsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZm9ybXMuaGlzdG9yeUZvcm0uYXBwZW5kQ2hpbGQoZWxlbSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmZvcm1zLmhpc3RvcnlGb3JtLnN1Ym1pdCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0b3AubG9jYXRpb24uaGFzaCA9IGZsZXhBcHBVcmw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBXZSBhbHNvIGhhdmUgdG8gbWFpbnRhaW4gdGhlIGhpc3RvcnkgYnkgaGFuZCBmb3IgU2FmYXJpCiAgICAgICAgICAgICAgICBoaXN0b3J5SGFzaFtoaXN0b3J5Lmxlbmd0aF0gPSBmbGV4QXBwVXJsOwogICAgICAgICAgICAgICAgX3N0b3JlU3RhdGVzKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2UsIGp1c3QgdGVsbCB0aGUgYnJvd3NlciB0byBnbyB0aGVyZQogICAgICAgICAgICAgICAgc2V0SGFzaChmbGV4QXBwVXJsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBiYWNrU3RhY2sucHVzaChjcmVhdGVTdGF0ZShiYXNlVXJsLCBuZXdVcmwsIGZsZXhBcHBVcmwpKTsKICAgIH0KCiAgICBmdW5jdGlvbiBfc3RvcmVTdGF0ZXMoKSB7CiAgICAgICAgaWYgKGJyb3dzZXIuc2FmYXJpKSB7CiAgICAgICAgICAgIGdldFJlbWVtYmVyRWxlbWVudCgpLnZhbHVlID0gaGlzdG9yeUhhc2guam9pbigiLCIpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVCYWNrQnV0dG9uKCkgewogICAgICAgIC8vVGhlICJjdXJyZW50IiBwYWdlIGlzIGFsd2F5cyBhdCB0aGUgdG9wIG9mIHRoZSBoaXN0b3J5IHN0YWNrLgogICAgICAgIHZhciBjdXJyZW50ID0gYmFja1N0YWNrLnBvcCgpOwogICAgICAgIGlmICghY3VycmVudCkgeyByZXR1cm47IH0KICAgICAgICB2YXIgbGFzdCA9IGJhY2tTdGFja1tiYWNrU3RhY2subGVuZ3RoIC0gMV07CiAgICAgICAgaWYgKCFsYXN0ICYmIGJhY2tTdGFjay5sZW5ndGggPT0gMCl7CiAgICAgICAgICAgIGxhc3QgPSBpbml0aWFsU3RhdGU7CiAgICAgICAgfQogICAgICAgIGZvcndhcmRTdGFjay5wdXNoKGN1cnJlbnQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZUZvcndhcmRCdXR0b24oKSB7CiAgICAgICAgLy9zdW1tYXJ5OiBwcml2YXRlIG1ldGhvZC4gRG8gbm90IGNhbGwgdGhpcyBkaXJlY3RseS4KCiAgICAgICAgdmFyIGxhc3QgPSBmb3J3YXJkU3RhY2sucG9wKCk7CiAgICAgICAgaWYgKCFsYXN0KSB7IHJldHVybjsgfQogICAgICAgIGJhY2tTdGFjay5wdXNoKGxhc3QpOwogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZUFyYml0cmFyeVVybCgpIHsKICAgICAgICAvL2RlbGV0ZSBhbGwgdGhlIGhpc3RvcnkgZW50cmllcwogICAgICAgIGZvcndhcmRTdGFjayA9IFtdOwogICAgfQoKICAgIC8qIENhbGxlZCBwZXJpb2RpY2FsbHkgdG8gcG9sbCB0byBzZWUgaWYgd2UgbmVlZCB0byBkZXRlY3QgbmF2aWdhdGlvbiB0aGF0IGhhcyBvY2N1cnJlZCAqLwogICAgZnVuY3Rpb24gY2hlY2tGb3JVcmxDaGFuZ2UoKSB7CgogICAgICAgIGlmIChicm93c2VyLmllKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50SHJlZiAhPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmICYmIGN1cnJlbnRIcmVmICsgJyMnICE9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYpIHsKICAgICAgICAgICAgICAgIC8vVGhpcyBvY2N1cnMgd2hlbiB0aGUgdXNlciBoYXMgbmF2aWdhdGVkIHRvIGEgc3BlY2lmaWMgVVJMCiAgICAgICAgICAgICAgICAvL3dpdGhpbiB0aGUgYXBwLCBhbmQgZGlkbid0IHVzZSBicm93c2VyIGJhY2svZm9yd2FyZAogICAgICAgICAgICAgICAgLy9JRSBzZWVtcyB0byBoYXZlIGEgYnVnIHdoZXJlIGl0IHN0b3BzIHVwZGF0aW5nIHRoZSBVUkwgaXQKICAgICAgICAgICAgICAgIC8vc2hvd3MgdGhlIGVuZC11c2VyIGF0IHRoaXMgcG9pbnQsIGJ1dCBwcm9ncmFtYXRpY2FsbHkgaXQKICAgICAgICAgICAgICAgIC8vYXBwZWFycyB0byBiZSBjb3JyZWN0LiAgRG8gYSBmdWxsIGFwcCByZWxvYWQgdG8gZ2V0IGFyb3VuZAogICAgICAgICAgICAgICAgLy90aGlzIGlzc3VlLgogICAgICAgICAgICAgICAgaWYgKGJyb3dzZXIudmVyc2lvbiA8IDcpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50SHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQubG9jYXRpb24ucmVsb2FkKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewoJCQkJCWlmIChnZXRIYXNoKCkgIT0gZ2V0SWZyYW1lSGFzaCgpKSB7CgkJCQkJCS8vIHRoaXMuaWZyYW1lLnNyYyA9IHRoaXMuYmxhbmtVUkwgKyBoYXNoOwoJCQkJCQl2YXIgc291cmNlVG9TZXQgPSBoaXN0b3J5RnJhbWVTb3VyY2VQcmVmaXggKyBnZXRIYXNoKCk7CgkJCQkJCWdldEhpc3RvcnlGcmFtZSgpLnNyYyA9IHNvdXJjZVRvU2V0OwogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50SHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CgkJCQkJfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYnJvd3Nlci5zYWZhcmkgJiYgIWJyb3dzZXJIYXNIYXNoQ2hhbmdlKSB7CiAgICAgICAgICAgIC8vIEZvciBTYWZhcmksIHdlIGhhdmUgdG8gY2hlY2sgdG8gc2VlIGlmIGhpc3RvcnkubGVuZ3RoIGNoYW5nZWQuCiAgICAgICAgICAgIGlmIChjdXJyZW50SGlzdG9yeUxlbmd0aCA+PSAwICYmIGhpc3RvcnkubGVuZ3RoICE9IGN1cnJlbnRIaXN0b3J5TGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAvL2FsZXJ0KCJkaWQgY2hhbmdlOiAiICsgaGlzdG9yeS5sZW5ndGggKyAiLCAiICsgaGlzdG9yeUhhc2gubGVuZ3RoICsgInwiICsgaGlzdG9yeUhhc2hbaGlzdG9yeS5sZW5ndGhdICsgInw+IiArIGhpc3RvcnlIYXNoLmpvaW4oInwiKSk7CiAgICAgICAgICAgICAgICB2YXIgZmxleEFwcFVybCA9IGdldEhhc2goKTsKICAgICAgICAgICAgICAgIGlmIChicm93c2VyLnZlcnNpb24gPCA1MjguMTYgLyogQW55dGhpbmcgZWFybGllciB0aGFuIFNhZmFyaSA0LjAgKi8pCiAgICAgICAgICAgICAgICB7ICAgIAogICAgICAgICAgICAgICAgICAgIC8vIElmIGl0IGRpZCBjaGFuZ2UgYW5kIHdlJ3JlIHJ1bm5pbmcgU2FmYXJpIDMueCBvciBlYXJsaWVyLCAKICAgICAgICAgICAgICAgICAgICAvLyB0aGVuIHdlIGhhdmUgdG8gbG9vayB0aGUgb2xkIHN0YXRlIHVwIGluIG91ciBoYW5kLW1haW50YWluZWQgCiAgICAgICAgICAgICAgICAgICAgLy8gYXJyYXkgc2luY2UgZG9jdW1lbnQubG9jYXRpb24uaGFzaCB3b24ndCBoYXZlIGNoYW5nZWQsIAogICAgICAgICAgICAgICAgICAgIC8vIHRoZW4gY2FsbCBiYWNrIGludG8gQnJvd3Nlck1hbmFnZXIuCiAgICAgICAgICAgICAgICBjdXJyZW50SGlzdG9yeUxlbmd0aCA9IGhpc3RvcnkubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGZsZXhBcHBVcmwgPSBoaXN0b3J5SGFzaFtjdXJyZW50SGlzdG9yeUxlbmd0aF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy9BRFI6IHRvIGZpeCBtdWx0aXBsZQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBCcm93c2VySGlzdG9yeV9tdWx0aXBsZSAhPSAidW5kZWZpbmVkIiAmJiBCcm93c2VySGlzdG9yeV9tdWx0aXBsZSA9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBsID0gZ2V0UGxheWVycygpOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxbaV0uYnJvd3NlclVSTENoYW5nZShmbGV4QXBwVXJsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGdldFBsYXllcigpLmJyb3dzZXJVUkxDaGFuZ2UoZmxleEFwcFVybCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfc3RvcmVTdGF0ZXMoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoYnJvd3Nlci5maXJlZm94ICYmICFicm93c2VySGFzSGFzaENoYW5nZSkgewogICAgICAgICAgICBpZiAoY3VycmVudEhyZWYgIT0gZG9jdW1lbnQubG9jYXRpb24uaHJlZikgewogICAgICAgICAgICAgICAgdmFyIGJzbCA9IGJhY2tTdGFjay5sZW5ndGg7CgogICAgICAgICAgICAgICAgdmFyIHVybEFjdGlvbnMgPSB7CiAgICAgICAgICAgICAgICAgICAgYmFjazogZmFsc2UsIAogICAgICAgICAgICAgICAgICAgIGZvcndhcmQ6IGZhbHNlLCAKICAgICAgICAgICAgICAgICAgICBzZXQ6IGZhbHNlCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGlmICgod2luZG93LmxvY2F0aW9uLmhhc2ggPT0gaW5pdGlhbEhhc2ggfHwgd2luZG93LmxvY2F0aW9uLmhyZWYgPT0gaW5pdGlhbEhyZWYpICYmIChic2wgPT0gMSkpIHsKICAgICAgICAgICAgICAgICAgICB1cmxBY3Rpb25zLmJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIC8vIEZJWE1FOiBjb3VsZCB0aGlzIGV2ZXIgYmUgYSBmb3J3YXJkIGJ1dHRvbj8KICAgICAgICAgICAgICAgICAgICAvLyB3ZSBjYW4ndCBjbGVhciBpdCBiZWNhdXNlIHdlIHN0aWxsIG5lZWQgdG8gY2hlY2sgZm9yIGZvcndhcmRzLiBVZ2cuCiAgICAgICAgICAgICAgICAgICAgLy8gY2xlYXJJbnRlcnZhbCh0aGlzLmxvY2F0aW9uVGltZXIpOwogICAgICAgICAgICAgICAgICAgIGhhbmRsZUJhY2tCdXR0b24oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gZmlyc3QgY2hlY2sgdG8gc2VlIGlmIHdlIGNvdWxkIGhhdmUgZ29uZSBmb3J3YXJkLiBXZSBhbHdheXMgaGFsdCBvbgogICAgICAgICAgICAgICAgLy8gYSBuby1oYXNoIGl0ZW0uCiAgICAgICAgICAgICAgICBpZiAoZm9yd2FyZFN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZm9yd2FyZFN0YWNrW2ZvcndhcmRTdGFjay5sZW5ndGgtMV0uZmxleEFwcFVybCA9PSBnZXRIYXNoKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsQWN0aW9ucy5mb3J3YXJkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlRm9yd2FyZEJ1dHRvbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBvaywgdGhhdCBkaWRuJ3Qgd29yaywgdHJ5IHNvbWVwbGFjZSBiYWNrIGluIHRoZSBoaXN0b3J5IHN0YWNrCiAgICAgICAgICAgICAgICBpZiAoKGJzbCA+PSAyKSAmJiAoYmFja1N0YWNrW2JzbCAtIDJdKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChiYWNrU3RhY2tbYnNsIC0gMl0uZmxleEFwcFVybCA9PSBnZXRIYXNoKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsQWN0aW9ucy5iYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlQmFja0J1dHRvbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCF1cmxBY3Rpb25zLmJhY2sgJiYgIXVybEFjdGlvbnMuZm9yd2FyZCkgewogICAgICAgICAgICAgICAgICAgIHZhciBmb3VuZEluU3RhY2tzID0gewogICAgICAgICAgICAgICAgICAgICAgICBiYWNrOiAtMSwgCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcndhcmQ6IC0xCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBiYWNrU3RhY2subGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhY2tTdGFja1tpXS5mbGV4QXBwVXJsID09IGdldEhhc2goKSAmJiBpICE9IChic2wgLSAyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJiaXRyYXJ5VXJsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kSW5TdGFja3MuYmFjayA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmb3J3YXJkU3RhY2subGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvcndhcmRTdGFja1tpXS5mbGV4QXBwVXJsID09IGdldEhhc2goKSAmJiBpICE9IChic2wgLSAyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJiaXRyYXJ5VXJsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kSW5TdGFja3MuZm9yd2FyZCA9IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlQXJiaXRyYXJ5VXJsKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRmlyZWZveCBjaGFuZ2VkOyBkbyBhIGNhbGxiYWNrIGludG8gQnJvd3Nlck1hbmFnZXIgdG8gdGVsbCBpdC4KICAgICAgICAgICAgICAgIGN1cnJlbnRIcmVmID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKICAgICAgICAgICAgICAgIHZhciBmbGV4QXBwVXJsID0gZ2V0SGFzaCgpOwogICAgICAgICAgICAgICAgLy9BRFI6IHRvIGZpeCBtdWx0aXBsZQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBCcm93c2VySGlzdG9yeV9tdWx0aXBsZSAhPSAidW5kZWZpbmVkIiAmJiBCcm93c2VySGlzdG9yeV9tdWx0aXBsZSA9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBsID0gZ2V0UGxheWVycygpOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxbaV0uYnJvd3NlclVSTENoYW5nZShmbGV4QXBwVXJsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGdldFBsYXllcigpLmJyb3dzZXJVUkxDaGFuZ2UoZmxleEFwcFVybCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgdmFyIF9pbml0aWFsaXplID0gZnVuY3Rpb24gKCkgewogICAgICAgIAogICAgICAgIGJyb3dzZXJIYXNIYXNoQ2hhbmdlID0gKCJvbmhhc2hjaGFuZ2UiIGluIGRvY3VtZW50LmJvZHkpOwogICAgICAgIAogICAgICAgIGlmIChicm93c2VyLmllKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHNjcmlwdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0Jyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBzOyBzID0gc2NyaXB0c1tpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocy5zcmMuaW5kZXhPZigiaGlzdG9yeS5qcyIpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaWZyYW1lX2xvY2F0aW9uID0gKG5ldyBTdHJpbmcocy5zcmMpKS5yZXBsYWNlKCJoaXN0b3J5LmpzIiwgImhpc3RvcnlGcmFtZS5odG1sIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGlzdG9yeUZyYW1lU291cmNlUHJlZml4ID0gaWZyYW1lX2xvY2F0aW9uICsgIj8iOwogICAgICAgICAgICB2YXIgc3JjID0gaGlzdG9yeUZyYW1lU291cmNlUHJlZml4OwoKICAgICAgICAgICAgdmFyIGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlmcmFtZSIpOwogICAgICAgICAgICBpZnJhbWUuaWQgPSAnaWVfaGlzdG9yeUZyYW1lJzsKICAgICAgICAgICAgaWZyYW1lLm5hbWUgPSAnaWVfaGlzdG9yeUZyYW1lJzsKICAgICAgICAgICAgaWZyYW1lLnNyYyA9ICdqYXZhc2NyaXB0OmZhbHNlOyc7IAoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaWZyYW1lKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoaWZyYW1lKTsKICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYnJvd3Nlci5zYWZhcmkgJiYgIWJyb3dzZXJIYXNIYXNoQ2hhbmdlKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHJlbWVtYmVyRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIHJlbWVtYmVyRGl2LmlkID0gJ3NhZmFyaV9yZW1lbWJlckRpdic7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocmVtZW1iZXJEaXYpOwogICAgICAgICAgICByZW1lbWJlckRpdi5pbm5lckhUTUwgPSAnPGlucHV0IHR5cGU9InRleHQiIGlkPSJzYWZhcmlfcmVtZW1iZXJfZmllbGQiIHN0eWxlPSJ3aWR0aDogNTAwcHg7Ij4nOwoKICAgICAgICAgICAgdmFyIGZvcm1EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgZm9ybURpdi5pZCA9ICdzYWZhcmlfZm9ybURpdic7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZm9ybURpdik7CgogICAgICAgICAgICB2YXIgcmVsb2FkZXJfY29udGVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICByZWxvYWRlcl9jb250ZW50LmlkID0gJ3NhZmFyaXJlbG9hZGVyJzsKICAgICAgICAgICAgdmFyIHNjcmlwdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0Jyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBzOyBzID0gc2NyaXB0c1tpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocy5zcmMuaW5kZXhPZigiaGlzdG9yeS5qcyIpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICBodG1sID0gKG5ldyBTdHJpbmcocy5zcmMpKS5yZXBsYWNlKCIuanMiLCAiLmh0bWwiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZWxvYWRlcl9jb250ZW50LmlubmVySFRNTCA9ICc8aWZyYW1lIGlkPSJzYWZhcmlyZWxvYWRlci1pZnJhbWUiIHNyYz0iYWJvdXQ6YmxhbmsiIGZyYW1lYm9yZGVyPSJubyIgc2Nyb2xsaW5nPSJubyI+PC9pZnJhbWU+JzsKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChyZWxvYWRlcl9jb250ZW50KTsKICAgICAgICAgICAgcmVsb2FkZXJfY29udGVudC5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgICAgICAgIHJlbG9hZGVyX2NvbnRlbnQuc3R5bGUubGVmdCA9IHJlbG9hZGVyX2NvbnRlbnQuc3R5bGUudG9wID0gJy05OTk5cHgnOwogICAgICAgICAgICBpZnJhbWUgPSByZWxvYWRlcl9jb250ZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKVswXTsKCiAgICAgICAgICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2FmYXJpX3JlbWVtYmVyX2ZpZWxkIikudmFsdWUgIT0gIiIgKSB7CiAgICAgICAgICAgICAgICBoaXN0b3J5SGFzaCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJzYWZhcmlfcmVtZW1iZXJfZmllbGQiKS52YWx1ZS5zcGxpdCgiLCIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYnJvd3Nlckhhc0hhc2hDaGFuZ2UpICAgICAgICAKICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5vbmhhc2hjaGFuZ2UgPSBoYXNoQ2hhbmdlSGFuZGxlcjsKICAgIH07CgogICAgcmV0dXJuIHsKICAgICAgICBoaXN0b3J5SGFzaDogaGlzdG9yeUhhc2gsIAogICAgICAgIGJhY2tTdGFjazogZnVuY3Rpb24oKSB7IHJldHVybiBiYWNrU3RhY2s7IH0sIAogICAgICAgIGZvcndhcmRTdGFjazogZnVuY3Rpb24oKSB7IHJldHVybiBmb3J3YXJkU3RhY2sgfSwgCiAgICAgICAgZ2V0UGxheWVyOiBnZXRQbGF5ZXIsIAogICAgICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKHNyYykgewogICAgICAgICAgICBfaW5pdGlhbGl6ZShzcmMpOwogICAgICAgIH0sIAogICAgICAgIHNldFVSTDogZnVuY3Rpb24odXJsKSB7CiAgICAgICAgICAgIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgPSB1cmw7CiAgICAgICAgfSwgCiAgICAgICAgZ2V0VVJMOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgfSwgCiAgICAgICAgZ2V0VGl0bGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQudGl0bGU7CiAgICAgICAgfSwgCiAgICAgICAgc2V0VGl0bGU6IGZ1bmN0aW9uKHRpdGxlKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBiYWNrU3RhY2tbYmFja1N0YWNrLmxlbmd0aCAtIDFdLnRpdGxlID0gdGl0bGU7CiAgICAgICAgICAgIH0gY2F0Y2goZSkgeyB9CiAgICAgICAgICAgIC8vaWYgb24gc2FmYXJpLCBzZXQgdGhlIHRpdGxlIHRvIGJlIHRoZSBlbXB0eSBzdHJpbmcuIAogICAgICAgICAgICBpZiAoYnJvd3Nlci5zYWZhcmkpIHsKICAgICAgICAgICAgICAgIGlmICh0aXRsZSA9PSAiIikgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRtcCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgdGl0bGUgPSB0bXAuc3Vic3RyaW5nKCh0bXAubGFzdEluZGV4T2YoIi8iKSsxKSwgdG1wLmxhc3RJbmRleE9mKCIjIikpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aXRsZSA9ICIiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkb2N1bWVudC50aXRsZSA9IHRpdGxlOwogICAgICAgIH0sIAogICAgICAgIHNldERlZmF1bHRVUkw6IGZ1bmN0aW9uKGRlZikKICAgICAgICB7CiAgICAgICAgICAgIGRlZmF1bHRIYXNoID0gZGVmOwogICAgICAgICAgICBkZWYgPSBnZXRIYXNoKCk7CiAgICAgICAgICAgIC8vdHJhaWxpbmcgPyBpcyBpbXBvcnRhbnQgZWxzZSBhbiBleHRyYSBmcmFtZSBnZXRzIGFkZGVkIHRvIHRoZSBoaXN0b3J5CiAgICAgICAgICAgIC8vd2hlbiBuYXZpZ2F0aW5nIGJhY2sgdG8gdGhlIGZpcnN0IHBhZ2UuICBBbHRlcm5hdGl2ZWx5IGNvdWxkIGNoZWNrCiAgICAgICAgICAgIC8vaW4gaGlzdG9yeSBmcmFtZSBuYXZpZ2F0aW9uIHRvIGNvbXBhcmUgIyBhbmQgPy4KICAgICAgICAgICAgaWYgKGJyb3dzZXIuaWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdpbmRvd1snX2llX2ZpcnN0bG9hZCddID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciBzb3VyY2VUb1NldCA9IGhpc3RvcnlGcmFtZVNvdXJjZVByZWZpeCArIGRlZjsKICAgICAgICAgICAgICAgIHZhciBmdW5jID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgZ2V0SGlzdG9yeUZyYW1lKCkuc3JjID0gc291cmNlVG9TZXQ7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlcGxhY2UoIiMiICsgZGVmKTsKICAgICAgICAgICAgICAgICAgICBzZXRJbnRlcnZhbChjaGVja0ZvclVybENoYW5nZSwgNTApOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgZnVuYygpOwogICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGZ1bmMoKTsgfSwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChicm93c2VyLnNhZmFyaSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY3VycmVudEhpc3RvcnlMZW5ndGggPSBoaXN0b3J5Lmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChoaXN0b3J5SGFzaC5sZW5ndGggPT0gMCkgewogICAgICAgICAgICAgICAgICAgIGhpc3RvcnlIYXNoW2N1cnJlbnRIaXN0b3J5TGVuZ3RoXSA9IGRlZjsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV3bG9jID0gIiMiICsgZGVmOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKG5ld2xvYyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vYWxlcnQoaGlzdG9yeUhhc2hbaGlzdG9yeUhhc2gubGVuZ3RoLTFdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNldEludGVydmFsKGNoZWNrRm9yVXJsQ2hhbmdlLCA1MCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoYnJvd3Nlci5maXJlZm94IHx8IGJyb3dzZXIub3BlcmEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciByZWcgPSBuZXcgUmVnRXhwKCIjIiArIGRlZiArICIkIik7CiAgICAgICAgICAgICAgICBpZiAod2luZG93LmxvY2F0aW9uLnRvU3RyaW5nKCkubWF0Y2gocmVnKSkgewogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV3bG9jID0iIyIgKyBkZWY7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlcGxhY2UobmV3bG9jKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNldEludGVydmFsKGNoZWNrRm9yVXJsQ2hhbmdlLCA1MCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwgCgogICAgICAgIC8qIFNldCB0aGUgY3VycmVudCBicm93c2VyIFVSTDsgY2FsbGVkIGZyb20gaW5zaWRlIEJyb3dzZXJNYW5hZ2VyIHRvIHByb3BhZ2F0ZQogICAgICAgICAqIHRoZSBhcHBsaWNhdGlvbiBzdGF0ZSBvdXQgdG8gdGhlIGNvbnRhaW5lci4KICAgICAgICAgKi8KICAgICAgICBzZXRCcm93c2VyVVJMOiBmdW5jdGlvbihmbGV4QXBwVXJsLCBvYmplY3RJZCkgewogICAgICAgICAgICBpZiAoYnJvd3Nlci5pZSAmJiB0eXBlb2Ygb2JqZWN0SWQgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRPYmplY3RJZCA9IG9iamVjdElkOwogICAgICAgICAgICB9CiAgICAgICAgICAgLy9mcm9tSWZyYW1lID0gZnJvbUlmcmFtZSB8fCBmYWxzZTsKICAgICAgICAgICAvL2Zyb21GbGV4ID0gZnJvbUZsZXggfHwgZmFsc2U7CiAgICAgICAgICAgLy9hbGVydCgic2V0QnJvd3NlclVSTDogIiArIGZsZXhBcHBVcmwpOwogICAgICAgICAgIC8vZmxleEFwcFVybCA9IChmbGV4QXBwVXJsID09ICIiKSA/IGRlZmF1bHRIYXNoIDogZmxleEFwcFVybCA7CgogICAgICAgICAgIHZhciBwb3MgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLmluZGV4T2YoJyMnKTsKICAgICAgICAgICB2YXIgYmFzZVVybCA9IHBvcyAhPSAtMSA/IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYuc3Vic3RyKDAsIHBvcykgOiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwogICAgICAgICAgIHZhciBuZXdVcmwgPSBiYXNlVXJsICsgJyMnICsgZmxleEFwcFVybDsKCiAgICAgICAgICAgaWYgKGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgIT0gbmV3VXJsICYmIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgKyAnIycgIT0gbmV3VXJsKSB7CiAgICAgICAgICAgICAgIGN1cnJlbnRIcmVmID0gbmV3VXJsOwogICAgICAgICAgICAgICBhZGRIaXN0b3J5RW50cnkoYmFzZVVybCwgbmV3VXJsLCBmbGV4QXBwVXJsKTsKICAgICAgICAgICAgICAgY3VycmVudEhpc3RvcnlMZW5ndGggPSBoaXN0b3J5Lmxlbmd0aDsKICAgICAgICAgICB9CiAgICAgICAgfSwgCgogICAgICAgIGJyb3dzZXJVUkxDaGFuZ2U6IGZ1bmN0aW9uKGZsZXhBcHBVcmwpIHsKICAgICAgICAgICAgdmFyIG9iamVjdElkID0gbnVsbDsKICAgICAgICAgICAgaWYgKGJyb3dzZXIuaWUgJiYgY3VycmVudE9iamVjdElkICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIG9iamVjdElkID0gY3VycmVudE9iamVjdElkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodHlwZW9mIEJyb3dzZXJIaXN0b3J5X211bHRpcGxlICE9ICJ1bmRlZmluZWQiICYmIEJyb3dzZXJIaXN0b3J5X211bHRpcGxlID09IHRydWUpIHsKICAgICAgICAgICAgICAgIHZhciBwbCA9IGdldFBsYXllcnMoKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBwbFtpXS5icm93c2VyVVJMQ2hhbmdlKGZsZXhBcHBVcmwpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgeyB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGdldFBsYXllcihvYmplY3RJZCkuYnJvd3NlclVSTENoYW5nZShmbGV4QXBwVXJsKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgeyB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN1cnJlbnRPYmplY3RJZCA9IG51bGw7CiAgICAgICAgfSwKICAgICAgICBnZXRVc2VyQWdlbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICAgICAgICB9LAogICAgICAgIGdldFBsYXRmb3JtOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIG5hdmlnYXRvci5wbGF0Zm9ybTsKICAgICAgICB9CgogICAgfQoKfSkoKTsKCi8vIEluaXRpYWxpemF0aW9uCgovLyBBdXRvbWF0ZWQgdW5pdCB0ZXN0aW5nIGFuZCBvdGhlciBkaWFnbm9zdGljcwoKZnVuY3Rpb24gc2V0VVJMKHVybCkKewogICAgZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9IHVybDsKfQoKZnVuY3Rpb24gYmFja0J1dHRvbigpCnsKICAgIGhpc3RvcnkuYmFjaygpOwp9CgpmdW5jdGlvbiBmb3J3YXJkQnV0dG9uKCkKewogICAgaGlzdG9yeS5mb3J3YXJkKCk7Cn0KCmZ1bmN0aW9uIGdvRm9yd2FyZE9yQmFja0luSGlzdG9yeShzdGVwKQp7CiAgICBoaXN0b3J5LmdvKHN0ZXApOwp9CgovL0Jyb3dzZXJIaXN0b3J5VXRpbHMuYWRkRXZlbnQod2luZG93LCAibG9hZCIsIGZ1bmN0aW9uKCkgeyBCcm93c2VySGlzdG9yeS5pbml0aWFsaXplKCk7IH0pOwooZnVuY3Rpb24oaSkgewogICAgdmFyIHUgPW5hdmlnYXRvci51c2VyQWdlbnQ7dmFyIGU9LypAY2Nfb24hQCovZmFsc2U7IAogICAgdmFyIHN0ID0gc2V0VGltZW91dDsKICAgIGlmKC93ZWJraXQvaS50ZXN0KHUpKXsKICAgICAgICBzdChmdW5jdGlvbigpewogICAgICAgICAgICB2YXIgZHI9ZG9jdW1lbnQucmVhZHlTdGF0ZTsKICAgICAgICAgICAgaWYoZHI9PSJsb2FkZWQifHxkcj09ImNvbXBsZXRlIil7aSgpfQogICAgICAgICAgICBlbHNle3N0KGFyZ3VtZW50cy5jYWxsZWUsMTApO319LDEwKTsKICAgIH0gZWxzZSBpZigoL21vemlsbGEvaS50ZXN0KHUpJiYhLyhjb21wYXRpKS8udGVzdCh1KSkgfHwgKC9vcGVyYS9pLnRlc3QodSkpKXsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIixpLGZhbHNlKTsKICAgIH0gZWxzZSBpZihlKXsKICAgIChmdW5jdGlvbigpewogICAgICAgIHZhciB0PWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RvYzpyZHknKTsKICAgICAgICB0cnl7dC5kb1Njcm9sbCgnbGVmdCcpOwogICAgICAgICAgICBpKCk7dD1udWxsOwogICAgICAgIH1jYXRjaChlKXtzdChhcmd1bWVudHMuY2FsbGVlLDApO319KSgpOwogICAgfSBlbHNlewogICAgICAgIHdpbmRvdy5vbmxvYWQ9aTsKICAgIH0KfSkoIGZ1bmN0aW9uKCkge0Jyb3dzZXJIaXN0b3J5LmluaXRpYWxpemUoKTt9ICk7Cg==",
                "body": "QnJvd3Nlckhpc3RvcnlVdGlscyA9IHsKICAgIGFkZEV2ZW50OiBmdW5jdGlvbihlbG0sIGV2VHlwZSwgZm4sIHVzZUNhcHR1cmUpIHsKICAgICAgICB1c2VDYXB0dXJlID0gdXNlQ2FwdHVyZSB8fCBmYWxzZTsKICAgICAgICBpZiAoZWxtLmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgZWxtLmFkZEV2ZW50TGlzdGVuZXIoZXZUeXBlLCBmbiwgdXNlQ2FwdHVyZSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChlbG0uYXR0YWNoRXZlbnQpIHsKICAgICAgICAgICAgdmFyIHIgPSBlbG0uYXR0YWNoRXZlbnQoJ29uJyArIGV2VHlwZSwgZm4pOwogICAgICAgICAgICByZXR1cm4gcjsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGVsbVsnb24nICsgZXZUeXBlXSA9IGZuOwogICAgICAgIH0KICAgIH0KfTsKCkJyb3dzZXJIaXN0b3J5ID0gKGZ1bmN0aW9uKCkgewogICAgLy8gdHlwZSBvZiBicm93c2VyCiAgICB2YXIgYnJvd3NlciA9IHsKICAgICAgICBpZTogZmFsc2UsIAogICAgICAgIGllODogZmFsc2UsIAogICAgICAgIGZpcmVmb3g6IGZhbHNlLCAKICAgICAgICBzYWZhcmk6IGZhbHNlLCAKICAgICAgICBvcGVyYTogZmFsc2UsIAogICAgICAgIHZlcnNpb246IC0xCiAgICB9OwoKICAgIC8vIERlZmF1bHQgYXBwIHN0YXRlIFVSTCB0byB1c2Ugd2hlbiBubyBmcmFnbWVudCBJRCBwcmVzZW50CiAgICB2YXIgZGVmYXVsdEhhc2ggPSAnJzsKCiAgICAvLyBMYXN0LWtub3duIGFwcCBzdGF0ZSBVUkwKICAgIHZhciBjdXJyZW50SHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CgogICAgLy8gSW5pdGlhbCBVUkwgKHVzZWQgb25seSBieSBJRSkKICAgIHZhciBpbml0aWFsSHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CgogICAgLy8gSW5pdGlhbCBVUkwgKHVzZWQgb25seSBieSBJRSkKICAgIHZhciBpbml0aWFsSGFzaCA9IGRvY3VtZW50LmxvY2F0aW9uLmhhc2g7CgogICAgLy8gSGlzdG9yeSBmcmFtZSBzb3VyY2UgVVJMIHByZWZpeCAodXNlZCBvbmx5IGJ5IElFKQogICAgdmFyIGhpc3RvcnlGcmFtZVNvdXJjZVByZWZpeCA9ICdoaXN0b3J5L2hpc3RvcnlGcmFtZS5odG1sPyc7CgogICAgLy8gSGlzdG9yeSBtYWludGVuYW5jZSAodXNlZCBvbmx5IGJ5IFNhZmFyaSkKICAgIHZhciBjdXJyZW50SGlzdG9yeUxlbmd0aCA9IC0xOwogICAgCiAgICAvLyBGbGFnIHRvIGRlbm90ZSB0aGUgZXhpc3RlbmNlIG9mIG9uaGFzaGNoYW5nZQogICAgdmFyIGJyb3dzZXJIYXNIYXNoQ2hhbmdlID0gZmFsc2U7CgogICAgdmFyIGhpc3RvcnlIYXNoID0gW107CgogICAgdmFyIGluaXRpYWxTdGF0ZSA9IGNyZWF0ZVN0YXRlKGluaXRpYWxIcmVmLCBpbml0aWFsSHJlZiArICcjJyArIGluaXRpYWxIYXNoLCBpbml0aWFsSGFzaCk7CgogICAgdmFyIGJhY2tTdGFjayA9IFtdOwogICAgdmFyIGZvcndhcmRTdGFjayA9IFtdOwoKICAgIHZhciBjdXJyZW50T2JqZWN0SWQgPSBudWxsOwoKICAgIC8vVXNlckFnZW50IGRldGVjdGlvbgogICAgdmFyIHVzZXJhZ2VudCA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKTsKCiAgICBpZiAodXNlcmFnZW50LmluZGV4T2YoIm9wZXJhIikgIT0gLTEpIHsKICAgICAgICBicm93c2VyLm9wZXJhID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAodXNlcmFnZW50LmluZGV4T2YoIm1zaWUiKSAhPSAtMSkgewogICAgICAgIGJyb3dzZXIuaWUgPSB0cnVlOwogICAgICAgIGJyb3dzZXIudmVyc2lvbiA9IHBhcnNlRmxvYXQodXNlcmFnZW50LnN1YnN0cmluZyh1c2VyYWdlbnQuaW5kZXhPZignbXNpZScpICsgNCkpOwogICAgICAgIGlmIChicm93c2VyLnZlcnNpb24gPT0gOCkKICAgICAgICB7CiAgICAgICAgICAgIGJyb3dzZXIuaWUgPSBmYWxzZTsKICAgICAgICAgICAgYnJvd3Nlci5pZTggPSB0cnVlOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAodXNlcmFnZW50LmluZGV4T2YoInNhZmFyaSIpICE9IC0xKSB7CiAgICAgICAgYnJvd3Nlci5zYWZhcmkgPSB0cnVlOwogICAgICAgIGJyb3dzZXIudmVyc2lvbiA9IHBhcnNlRmxvYXQodXNlcmFnZW50LnN1YnN0cmluZyh1c2VyYWdlbnQuaW5kZXhPZignc2FmYXJpJykgKyA3KSk7CiAgICB9IGVsc2UgaWYgKHVzZXJhZ2VudC5pbmRleE9mKCJnZWNrbyIpICE9IC0xKSB7CiAgICAgICAgYnJvd3Nlci5maXJlZm94ID0gdHJ1ZTsKICAgIH0KCiAgICBpZiAoYnJvd3Nlci5pZSA9PSB0cnVlICYmIGJyb3dzZXIudmVyc2lvbiA9PSA3KSB7CiAgICAgICAgd2luZG93WyJfaWVfZmlyc3Rsb2FkIl0gPSBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiBoYXNoQ2hhbmdlSGFuZGxlcigpCiAgICB7CiAgICAgICAgY3VycmVudEhyZWYgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwogICAgICAgIHZhciBmbGV4QXBwVXJsID0gZ2V0SGFzaCgpOwogICAgICAgIC8vQURSOiB0byBmaXggbXVsdGlwbGUKICAgICAgICBpZiAodHlwZW9mIEJyb3dzZXJIaXN0b3J5X211bHRpcGxlICE9ICJ1bmRlZmluZWQiICYmIEJyb3dzZXJIaXN0b3J5X211bHRpcGxlID09IHRydWUpIHsKICAgICAgICAgICAgdmFyIHBsID0gZ2V0UGxheWVycygpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBsLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBwbFtpXS5icm93c2VyVVJMQ2hhbmdlKGZsZXhBcHBVcmwpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2V0UGxheWVyKCkuYnJvd3NlclVSTENoYW5nZShmbGV4QXBwVXJsKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gQWNjZXNzb3IgZnVuY3Rpb25zIGZvciBvYnRhaW5pbmcgc3BlY2lmaWMgZWxlbWVudHMgb2YgdGhlIHBhZ2UuCiAgICBmdW5jdGlvbiBnZXRIaXN0b3J5RnJhbWUoKQogICAgewogICAgICAgIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaWVfaGlzdG9yeUZyYW1lJyk7CiAgICB9CgogICAgZnVuY3Rpb24gZ2V0Rm9ybUVsZW1lbnQoKQogICAgewogICAgICAgIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2FmYXJpX2Zvcm1EaXYnKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRSZW1lbWJlckVsZW1lbnQoKQogICAgewogICAgICAgIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2FmYXJpX3JlbWVtYmVyX2ZpZWxkIik7CiAgICB9CgogICAgLy8gR2V0IHRoZSBGbGFzaCBwbGF5ZXIgb2JqZWN0IGZvciBwZXJmb3JtaW5nIEV4dGVybmFsSW50ZXJmYWNlIGNhbGxiYWNrcy4KICAgIC8vIFVwZGF0ZWQgZm9yIGNoYW5nZXMgdG8gU1dGT2JqZWN0Mi4KICAgIGZ1bmN0aW9uIGdldFBsYXllcihpZCkgewogICAgICAgIHZhciBpOwoKCQlpZiAoaWQgJiYgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpKSB7CgkJCXZhciByID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwoJCQlpZiAodHlwZW9mIHIuU2V0VmFyaWFibGUgIT0gInVuZGVmaW5lZCIpIHsKCQkJCXJldHVybiByOwoJCQl9CgkJCWVsc2UgewoJCQkJdmFyIG8gPSByLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJvYmplY3QiKTsKCQkJCXZhciBlID0gci5nZXRFbGVtZW50c0J5VGFnTmFtZSgiZW1iZWQiKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBvLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvW2ldLmJyb3dzZXJVUkxDaGFuZ2UgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGVbaV0uYnJvd3NlclVSTENoYW5nZSAhPSAidW5kZWZpbmVkIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVbaV07CiAgICAgICAgICAgICAgICB9CgkJCX0KCQl9CgkJZWxzZSB7CgkJCXZhciBvID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9iamVjdCIpOwoJCQl2YXIgZSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJlbWJlZCIpOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlW2ldLmJyb3dzZXJVUkxDaGFuZ2UgIT0gInVuZGVmaW5lZCIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVbaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG8ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb1tpXS5icm93c2VyVVJMQ2hhbmdlICE9ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgkJfQoJCXJldHVybiB1bmRlZmluZWQ7Cgl9CiAgICAKICAgIGZ1bmN0aW9uIGdldFBsYXllcnMoKSB7CiAgICAgICAgdmFyIGk7CiAgICAgICAgdmFyIHBsYXllcnMgPSBbXTsKICAgICAgICBpZiAocGxheWVycy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICB2YXIgdG1wID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ29iamVjdCcpOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdG1wLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRtcFtpXS5icm93c2VyVVJMQ2hhbmdlICE9ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgICAgIHBsYXllcnMucHVzaCh0bXBbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwbGF5ZXJzLmxlbmd0aCA9PSAwIHx8IHBsYXllcnNbMF0ub2JqZWN0ID09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHRtcCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdlbWJlZCcpOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdG1wLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRtcFtpXS5icm93c2VyVVJMQ2hhbmdlICE9ICJ1bmRlZmluZWQiKQogICAgICAgICAgICAgICAgICAgIHBsYXllcnMucHVzaCh0bXBbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBwbGF5ZXJzOwogICAgfQoKCWZ1bmN0aW9uIGdldElmcmFtZUhhc2goKSB7CgkJdmFyIGRvYyA9IGdldEhpc3RvcnlGcmFtZSgpLmNvbnRlbnRXaW5kb3cuZG9jdW1lbnQ7CgkJdmFyIGhhc2ggPSBTdHJpbmcoZG9jLmxvY2F0aW9uLnNlYXJjaCk7CgkJaWYgKGhhc2gubGVuZ3RoID09IDEgJiYgaGFzaC5jaGFyQXQoMCkgPT0gIj8iKSB7CgkJCWhhc2ggPSAiIjsKCQl9CgkJZWxzZSBpZiAoaGFzaC5sZW5ndGggPj0gMiAmJiBoYXNoLmNoYXJBdCgwKSA9PSAiPyIpIHsKCQkJaGFzaCA9IGhhc2guc3Vic3RyaW5nKDEpOwoJCX0KCQlyZXR1cm4gaGFzaDsKCX0KCiAgICAvKiBHZXQgdGhlIGN1cnJlbnQgbG9jYXRpb24gaGFzaCBleGNsdWRpbmcgdGhlICcjJyBzeW1ib2wuICovCiAgICBmdW5jdGlvbiBnZXRIYXNoKCkgewogICAgICAgLy8gSXQgd291bGQgYmUgbmljZSBpZiB3ZSBjb3VsZCB1c2UgZG9jdW1lbnQubG9jYXRpb24uaGFzaCBoZXJlLAogICAgICAgLy8gYnV0IGl0J3MgZmF1bHR5IHNvbWV0aW1lcy4KICAgICAgIHZhciBpZHggPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLmluZGV4T2YoJyMnKTsKICAgICAgIHJldHVybiAoaWR4ID49IDApID8gZG9jdW1lbnQubG9jYXRpb24uaHJlZi5zdWJzdHIoaWR4KzEpIDogJyc7CiAgICB9CgogICAgLyogR2V0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2ggZXhjbHVkaW5nIHRoZSAnIycgc3ltYm9sLiAqLwogICAgZnVuY3Rpb24gc2V0SGFzaChoYXNoKSB7CiAgICAgICAvLyBJdCB3b3VsZCBiZSBuaWNlIGlmIHdlIGNvdWxkIHVzZSBkb2N1bWVudC5sb2NhdGlvbi5oYXNoIGhlcmUsCiAgICAgICAvLyBidXQgaXQncyBmYXVsdHkgc29tZXRpbWVzLgogICAgICAgaWYgKGhhc2ggPT0gJycpIGhhc2ggPSAnIyc7CiAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgIH0KCiAgICBmdW5jdGlvbiBjcmVhdGVTdGF0ZShiYXNlVXJsLCBuZXdVcmwsIGZsZXhBcHBVcmwpIHsKICAgICAgICByZXR1cm4geyAnYmFzZVVybCc6IGJhc2VVcmwsICduZXdVcmwnOiBuZXdVcmwsICdmbGV4QXBwVXJsJzogZmxleEFwcFVybCwgJ3RpdGxlJzogbnVsbCB9OwogICAgfQoKICAgIC8qIEFkZCBhIGhpc3RvcnkgZW50cnkgdG8gdGhlIGJyb3dzZXIuCiAgICAgKiAgIGJhc2VVcmw6IHRoZSBwb3J0aW9uIG9mIHRoZSBsb2NhdGlvbiBwcmlvciB0byB0aGUgJyMnCiAgICAgKiAgIG5ld1VybDogdGhlIGVudGlyZSBuZXcgVVJMLCBpbmNsdWRpbmcgJyMnIGFuZCBmb2xsb3dpbmcgZnJhZ21lbnQKICAgICAqICAgZmxleEFwcFVybDogdGhlIHBvcnRpb24gb2YgdGhlIGxvY2F0aW9uIGZvbGxvd2luZyB0aGUgJyMnIG9ubHkKICAgICAqLwogICAgZnVuY3Rpb24gYWRkSGlzdG9yeUVudHJ5KGJhc2VVcmwsIG5ld1VybCwgZmxleEFwcFVybCkgewoKICAgICAgICAvL2RlbGV0ZSBhbGwgdGhlIGhpc3RvcnkgZW50cmllcwogICAgICAgIGZvcndhcmRTdGFjayA9IFtdOwoKICAgICAgICBpZiAoYnJvd3Nlci5pZSkgewogICAgICAgICAgICAvL0NoZWNrIHRvIHNlZSBpZiB3ZSBhcmUgYmVpbmcgYXNrZWQgdG8gZG8gYSBuYXZpZ2F0ZSBmb3IgdGhlIGZpcnN0CiAgICAgICAgICAgIC8vaGlzdG9yeSBlbnRyeSwgYW5kIGlmIHNvIGlnbm9yZSwgYmVjYXVzZSBpdCdzIGNvbWluZyBmcm9tIHRoZSBjcmVhdGlvbgogICAgICAgICAgICAvL29mIHRoZSBoaXN0b3J5IGlmcmFtZQogICAgICAgICAgICBpZiAoZmxleEFwcFVybCA9PSBkZWZhdWx0SGFzaCAmJiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmID09IGluaXRpYWxIcmVmICYmIHdpbmRvd1snX2llX2ZpcnN0bG9hZCddKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SHJlZiA9IGluaXRpYWxIcmVmOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgoIWZsZXhBcHBVcmwgfHwgZmxleEFwcFVybCA9PSBkZWZhdWx0SGFzaCkgJiYgd2luZG93WydfaWVfZmlyc3Rsb2FkJ10pIHsKICAgICAgICAgICAgICAgIG5ld1VybCA9IGJhc2VVcmwgKyAnIycgKyBkZWZhdWx0SGFzaDsKICAgICAgICAgICAgICAgIGZsZXhBcHBVcmwgPSBkZWZhdWx0SGFzaDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIGZvciBJRSwgdGVsbCB0aGUgaGlzdG9yeSBmcmFtZSB0byBnbyBzb21ld2hlcmUgd2l0aG91dCBhICcjJwogICAgICAgICAgICAgICAgLy8gaW4gb3JkZXIgdG8gZ2V0IHRoaXMgZW50cnkgaW50byB0aGUgYnJvd3NlciBoaXN0b3J5LgogICAgICAgICAgICAgICAgZ2V0SGlzdG9yeUZyYW1lKCkuc3JjID0gaGlzdG9yeUZyYW1lU291cmNlUHJlZml4ICsgZmxleEFwcFVybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRIYXNoKGZsZXhBcHBVcmwpOwogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAvL0FEUgogICAgICAgICAgICBpZiAoYmFja1N0YWNrLmxlbmd0aCA9PSAwICYmIGluaXRpYWxTdGF0ZS5mbGV4QXBwVXJsID09IGZsZXhBcHBVcmwpIHsKICAgICAgICAgICAgICAgIGluaXRpYWxTdGF0ZSA9IGNyZWF0ZVN0YXRlKGJhc2VVcmwsIG5ld1VybCwgZmxleEFwcFVybCk7CiAgICAgICAgICAgIH0gZWxzZSBpZihiYWNrU3RhY2subGVuZ3RoID4gMCAmJiBiYWNrU3RhY2tbYmFja1N0YWNrLmxlbmd0aCAtIDFdLmZsZXhBcHBVcmwgPT0gZmxleEFwcFVybCkgewogICAgICAgICAgICAgICAgYmFja1N0YWNrW2JhY2tTdGFjay5sZW5ndGggLSAxXSA9IGNyZWF0ZVN0YXRlKGJhc2VVcmwsIG5ld1VybCwgZmxleEFwcFVybCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChicm93c2VyLnNhZmFyaSAmJiAhYnJvd3Nlckhhc0hhc2hDaGFuZ2UpIHsKICAgICAgICAgICAgICAgIC8vIGZvciBTYWZhcmksIHN1Ym1pdCBhIGZvcm0gd2hvc2UgYWN0aW9uIHBvaW50cyB0byB0aGUgZGVzaXJlZCBVUkwKICAgICAgICAgICAgICAgIGlmIChicm93c2VyLnZlcnNpb24gPD0gNDE5LjMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZmlsZSA9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgIGZpbGUgPSBmaWxlLnN1YnN0cmluZyhmaWxlLmxhc3RJbmRleE9mKCIvIikrMSk7CiAgICAgICAgICAgICAgICAgICAgZ2V0Rm9ybUVsZW1lbnQoKS5pbm5lckhUTUwgPSAnPGZvcm0gbmFtZT0iaGlzdG9yeUZvcm0iIGFjdGlvbj0iJytmaWxlKycjJyArIGZsZXhBcHBVcmwgKyAnIiBtZXRob2Q9IkdFVCI+PC9mb3JtPic7CiAgICAgICAgICAgICAgICAgICAgLy9nZXQgdGhlIGN1cnJlbnQgZWxlbWVudHMgYW5kIGFkZCB0aGVtIHRvIHRoZSBmb3JtCiAgICAgICAgICAgICAgICAgICAgdmFyIHFzID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaC5zdWJzdHJpbmcoMSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHFzX2FyciA9IHFzLnNwbGl0KCImIik7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxc19hcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRtcCA9IHFzX2FycltpXS5zcGxpdCgiPSIpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0udHlwZSA9ICJoaWRkZW4iOwogICAgICAgICAgICAgICAgICAgICAgICBlbGVtLm5hbWUgPSB0bXBbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW0udmFsdWUgPSB0bXBbMV07CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmZvcm1zLmhpc3RvcnlGb3JtLmFwcGVuZENoaWxkKGVsZW0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5mb3Jtcy5oaXN0b3J5Rm9ybS5zdWJtaXQoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdG9wLmxvY2F0aW9uLmhhc2ggPSBmbGV4QXBwVXJsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gV2UgYWxzbyBoYXZlIHRvIG1haW50YWluIHRoZSBoaXN0b3J5IGJ5IGhhbmQgZm9yIFNhZmFyaQogICAgICAgICAgICAgICAgaGlzdG9yeUhhc2hbaGlzdG9yeS5sZW5ndGhdID0gZmxleEFwcFVybDsKICAgICAgICAgICAgICAgIF9zdG9yZVN0YXRlcygpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBqdXN0IHRlbGwgdGhlIGJyb3dzZXIgdG8gZ28gdGhlcmUKICAgICAgICAgICAgICAgIHNldEhhc2goZmxleEFwcFVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYmFja1N0YWNrLnB1c2goY3JlYXRlU3RhdGUoYmFzZVVybCwgbmV3VXJsLCBmbGV4QXBwVXJsKSk7CiAgICB9CgogICAgZnVuY3Rpb24gX3N0b3JlU3RhdGVzKCkgewogICAgICAgIGlmIChicm93c2VyLnNhZmFyaSkgewogICAgICAgICAgICBnZXRSZW1lbWJlckVsZW1lbnQoKS52YWx1ZSA9IGhpc3RvcnlIYXNoLmpvaW4oIiwiKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlQmFja0J1dHRvbigpIHsKICAgICAgICAvL1RoZSAiY3VycmVudCIgcGFnZSBpcyBhbHdheXMgYXQgdGhlIHRvcCBvZiB0aGUgaGlzdG9yeSBzdGFjay4KICAgICAgICB2YXIgY3VycmVudCA9IGJhY2tTdGFjay5wb3AoKTsKICAgICAgICBpZiAoIWN1cnJlbnQpIHsgcmV0dXJuOyB9CiAgICAgICAgdmFyIGxhc3QgPSBiYWNrU3RhY2tbYmFja1N0YWNrLmxlbmd0aCAtIDFdOwogICAgICAgIGlmICghbGFzdCAmJiBiYWNrU3RhY2subGVuZ3RoID09IDApewogICAgICAgICAgICBsYXN0ID0gaW5pdGlhbFN0YXRlOwogICAgICAgIH0KICAgICAgICBmb3J3YXJkU3RhY2sucHVzaChjdXJyZW50KTsKICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVGb3J3YXJkQnV0dG9uKCkgewogICAgICAgIC8vc3VtbWFyeTogcHJpdmF0ZSBtZXRob2QuIERvIG5vdCBjYWxsIHRoaXMgZGlyZWN0bHkuCgogICAgICAgIHZhciBsYXN0ID0gZm9yd2FyZFN0YWNrLnBvcCgpOwogICAgICAgIGlmICghbGFzdCkgeyByZXR1cm47IH0KICAgICAgICBiYWNrU3RhY2sucHVzaChsYXN0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVBcmJpdHJhcnlVcmwoKSB7CiAgICAgICAgLy9kZWxldGUgYWxsIHRoZSBoaXN0b3J5IGVudHJpZXMKICAgICAgICBmb3J3YXJkU3RhY2sgPSBbXTsKICAgIH0KCiAgICAvKiBDYWxsZWQgcGVyaW9kaWNhbGx5IHRvIHBvbGwgdG8gc2VlIGlmIHdlIG5lZWQgdG8gZGV0ZWN0IG5hdmlnYXRpb24gdGhhdCBoYXMgb2NjdXJyZWQgKi8KICAgIGZ1bmN0aW9uIGNoZWNrRm9yVXJsQ2hhbmdlKCkgewoKICAgICAgICBpZiAoYnJvd3Nlci5pZSkgewogICAgICAgICAgICBpZiAoY3VycmVudEhyZWYgIT0gZG9jdW1lbnQubG9jYXRpb24uaHJlZiAmJiBjdXJyZW50SHJlZiArICcjJyAhPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmKSB7CiAgICAgICAgICAgICAgICAvL1RoaXMgb2NjdXJzIHdoZW4gdGhlIHVzZXIgaGFzIG5hdmlnYXRlZCB0byBhIHNwZWNpZmljIFVSTAogICAgICAgICAgICAgICAgLy93aXRoaW4gdGhlIGFwcCwgYW5kIGRpZG4ndCB1c2UgYnJvd3NlciBiYWNrL2ZvcndhcmQKICAgICAgICAgICAgICAgIC8vSUUgc2VlbXMgdG8gaGF2ZSBhIGJ1ZyB3aGVyZSBpdCBzdG9wcyB1cGRhdGluZyB0aGUgVVJMIGl0CiAgICAgICAgICAgICAgICAvL3Nob3dzIHRoZSBlbmQtdXNlciBhdCB0aGlzIHBvaW50LCBidXQgcHJvZ3JhbWF0aWNhbGx5IGl0CiAgICAgICAgICAgICAgICAvL2FwcGVhcnMgdG8gYmUgY29ycmVjdC4gIERvIGEgZnVsbCBhcHAgcmVsb2FkIHRvIGdldCBhcm91bmQKICAgICAgICAgICAgICAgIC8vdGhpcyBpc3N1ZS4KICAgICAgICAgICAgICAgIGlmIChicm93c2VyLnZlcnNpb24gPCA3KSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudEhyZWYgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmxvY2F0aW9uLnJlbG9hZCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKCQkJCQlpZiAoZ2V0SGFzaCgpICE9IGdldElmcmFtZUhhc2goKSkgewoJCQkJCQkvLyB0aGlzLmlmcmFtZS5zcmMgPSB0aGlzLmJsYW5rVVJMICsgaGFzaDsKCQkJCQkJdmFyIHNvdXJjZVRvU2V0ID0gaGlzdG9yeUZyYW1lU291cmNlUHJlZml4ICsgZ2V0SGFzaCgpOwoJCQkJCQlnZXRIaXN0b3J5RnJhbWUoKS5zcmMgPSBzb3VyY2VUb1NldDsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEhyZWYgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwoJCQkJCX0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGJyb3dzZXIuc2FmYXJpICYmICFicm93c2VySGFzSGFzaENoYW5nZSkgewogICAgICAgICAgICAvLyBGb3IgU2FmYXJpLCB3ZSBoYXZlIHRvIGNoZWNrIHRvIHNlZSBpZiBoaXN0b3J5Lmxlbmd0aCBjaGFuZ2VkLgogICAgICAgICAgICBpZiAoY3VycmVudEhpc3RvcnlMZW5ndGggPj0gMCAmJiBoaXN0b3J5Lmxlbmd0aCAhPSBjdXJyZW50SGlzdG9yeUxlbmd0aCkgewogICAgICAgICAgICAgICAgLy9hbGVydCgiZGlkIGNoYW5nZTogIiArIGhpc3RvcnkubGVuZ3RoICsgIiwgIiArIGhpc3RvcnlIYXNoLmxlbmd0aCArICJ8IiArIGhpc3RvcnlIYXNoW2hpc3RvcnkubGVuZ3RoXSArICJ8PiIgKyBoaXN0b3J5SGFzaC5qb2luKCJ8IikpOwogICAgICAgICAgICAgICAgdmFyIGZsZXhBcHBVcmwgPSBnZXRIYXNoKCk7CiAgICAgICAgICAgICAgICBpZiAoYnJvd3Nlci52ZXJzaW9uIDwgNTI4LjE2IC8qIEFueXRoaW5nIGVhcmxpZXIgdGhhbiBTYWZhcmkgNC4wICovKQogICAgICAgICAgICAgICAgeyAgICAKICAgICAgICAgICAgICAgICAgICAvLyBJZiBpdCBkaWQgY2hhbmdlIGFuZCB3ZSdyZSBydW5uaW5nIFNhZmFyaSAzLnggb3IgZWFybGllciwgCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlbiB3ZSBoYXZlIHRvIGxvb2sgdGhlIG9sZCBzdGF0ZSB1cCBpbiBvdXIgaGFuZC1tYWludGFpbmVkIAogICAgICAgICAgICAgICAgICAgIC8vIGFycmF5IHNpbmNlIGRvY3VtZW50LmxvY2F0aW9uLmhhc2ggd29uJ3QgaGF2ZSBjaGFuZ2VkLCAKICAgICAgICAgICAgICAgICAgICAvLyB0aGVuIGNhbGwgYmFjayBpbnRvIEJyb3dzZXJNYW5hZ2VyLgogICAgICAgICAgICAgICAgY3VycmVudEhpc3RvcnlMZW5ndGggPSBoaXN0b3J5Lmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBmbGV4QXBwVXJsID0gaGlzdG9yeUhhc2hbY3VycmVudEhpc3RvcnlMZW5ndGhdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vQURSOiB0byBmaXggbXVsdGlwbGUKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgQnJvd3Nlckhpc3RvcnlfbXVsdGlwbGUgIT0gInVuZGVmaW5lZCIgJiYgQnJvd3Nlckhpc3RvcnlfbXVsdGlwbGUgPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwbCA9IGdldFBsYXllcnMoKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBsLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsW2ldLmJyb3dzZXJVUkxDaGFuZ2UoZmxleEFwcFVybCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBnZXRQbGF5ZXIoKS5icm93c2VyVVJMQ2hhbmdlKGZsZXhBcHBVcmwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgX3N0b3JlU3RhdGVzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGJyb3dzZXIuZmlyZWZveCAmJiAhYnJvd3Nlckhhc0hhc2hDaGFuZ2UpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRIcmVmICE9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYpIHsKICAgICAgICAgICAgICAgIHZhciBic2wgPSBiYWNrU3RhY2subGVuZ3RoOwoKICAgICAgICAgICAgICAgIHZhciB1cmxBY3Rpb25zID0gewogICAgICAgICAgICAgICAgICAgIGJhY2s6IGZhbHNlLCAKICAgICAgICAgICAgICAgICAgICBmb3J3YXJkOiBmYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgc2V0OiBmYWxzZQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAoKHdpbmRvdy5sb2NhdGlvbi5oYXNoID09IGluaXRpYWxIYXNoIHx8IHdpbmRvdy5sb2NhdGlvbi5ocmVmID09IGluaXRpYWxIcmVmKSAmJiAoYnNsID09IDEpKSB7CiAgICAgICAgICAgICAgICAgICAgdXJsQWN0aW9ucy5iYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAvLyBGSVhNRTogY291bGQgdGhpcyBldmVyIGJlIGEgZm9yd2FyZCBidXR0b24/CiAgICAgICAgICAgICAgICAgICAgLy8gd2UgY2FuJ3QgY2xlYXIgaXQgYmVjYXVzZSB3ZSBzdGlsbCBuZWVkIHRvIGNoZWNrIGZvciBmb3J3YXJkcy4gVWdnLgogICAgICAgICAgICAgICAgICAgIC8vIGNsZWFySW50ZXJ2YWwodGhpcy5sb2NhdGlvblRpbWVyKTsKICAgICAgICAgICAgICAgICAgICBoYW5kbGVCYWNrQnV0dG9uKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIGZpcnN0IGNoZWNrIHRvIHNlZSBpZiB3ZSBjb3VsZCBoYXZlIGdvbmUgZm9yd2FyZC4gV2UgYWx3YXlzIGhhbHQgb24KICAgICAgICAgICAgICAgIC8vIGEgbm8taGFzaCBpdGVtLgogICAgICAgICAgICAgICAgaWYgKGZvcndhcmRTdGFjay5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcndhcmRTdGFja1tmb3J3YXJkU3RhY2subGVuZ3RoLTFdLmZsZXhBcHBVcmwgPT0gZ2V0SGFzaCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybEFjdGlvbnMuZm9yd2FyZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUZvcndhcmRCdXR0b24oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gb2ssIHRoYXQgZGlkbid0IHdvcmssIHRyeSBzb21lcGxhY2UgYmFjayBpbiB0aGUgaGlzdG9yeSBzdGFjawogICAgICAgICAgICAgICAgaWYgKChic2wgPj0gMikgJiYgKGJhY2tTdGFja1tic2wgLSAyXSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYmFja1N0YWNrW2JzbCAtIDJdLmZsZXhBcHBVcmwgPT0gZ2V0SGFzaCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybEFjdGlvbnMuYmFjayA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZUJhY2tCdXR0b24oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICghdXJsQWN0aW9ucy5iYWNrICYmICF1cmxBY3Rpb25zLmZvcndhcmQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZm91bmRJblN0YWNrcyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgYmFjazogLTEsIAogICAgICAgICAgICAgICAgICAgICAgICBmb3J3YXJkOiAtMQogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYmFja1N0YWNrLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWNrU3RhY2tbaV0uZmxleEFwcFVybCA9PSBnZXRIYXNoKCkgJiYgaSAhPSAoYnNsIC0gMikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyYml0cmFyeVVybCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZEluU3RhY2tzLmJhY2sgPSBpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZm9yd2FyZFN0YWNrLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3J3YXJkU3RhY2tbaV0uZmxleEFwcFVybCA9PSBnZXRIYXNoKCkgJiYgaSAhPSAoYnNsIC0gMikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyYml0cmFyeVVybCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZEluU3RhY2tzLmZvcndhcmQgPSBpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGhhbmRsZUFyYml0cmFyeVVybCgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggY2hhbmdlZDsgZG8gYSBjYWxsYmFjayBpbnRvIEJyb3dzZXJNYW5hZ2VyIHRvIHRlbGwgaXQuCiAgICAgICAgICAgICAgICBjdXJyZW50SHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgICAgICAgICB2YXIgZmxleEFwcFVybCA9IGdldEhhc2goKTsKICAgICAgICAgICAgICAgIC8vQURSOiB0byBmaXggbXVsdGlwbGUKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgQnJvd3Nlckhpc3RvcnlfbXVsdGlwbGUgIT0gInVuZGVmaW5lZCIgJiYgQnJvd3Nlckhpc3RvcnlfbXVsdGlwbGUgPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBwbCA9IGdldFBsYXllcnMoKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBsLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsW2ldLmJyb3dzZXJVUkxDaGFuZ2UoZmxleEFwcFVybCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBnZXRQbGF5ZXIoKS5icm93c2VyVVJMQ2hhbmdlKGZsZXhBcHBVcmwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHZhciBfaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAKICAgICAgICBicm93c2VySGFzSGFzaENoYW5nZSA9ICgib25oYXNoY2hhbmdlIiBpbiBkb2N1bWVudC5ib2R5KTsKICAgICAgICAKICAgICAgICBpZiAoYnJvd3Nlci5pZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBzY3JpcHRzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgczsgcyA9IHNjcmlwdHNbaV07IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHMuc3JjLmluZGV4T2YoImhpc3RvcnkuanMiKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGlmcmFtZV9sb2NhdGlvbiA9IChuZXcgU3RyaW5nKHMuc3JjKSkucmVwbGFjZSgiaGlzdG9yeS5qcyIsICJoaXN0b3J5RnJhbWUuaHRtbCIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGhpc3RvcnlGcmFtZVNvdXJjZVByZWZpeCA9IGlmcmFtZV9sb2NhdGlvbiArICI/IjsKICAgICAgICAgICAgdmFyIHNyYyA9IGhpc3RvcnlGcmFtZVNvdXJjZVByZWZpeDsKCiAgICAgICAgICAgIHZhciBpZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpZnJhbWUiKTsKICAgICAgICAgICAgaWZyYW1lLmlkID0gJ2llX2hpc3RvcnlGcmFtZSc7CiAgICAgICAgICAgIGlmcmFtZS5uYW1lID0gJ2llX2hpc3RvcnlGcmFtZSc7CiAgICAgICAgICAgIGlmcmFtZS5zcmMgPSAnamF2YXNjcmlwdDpmYWxzZTsnOyAKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGlmcmFtZSk7CiAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGlmcmFtZSk7CiAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGJyb3dzZXIuc2FmYXJpICYmICFicm93c2VySGFzSGFzaENoYW5nZSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciByZW1lbWJlckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICByZW1lbWJlckRpdi5pZCA9ICdzYWZhcmlfcmVtZW1iZXJEaXYnOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHJlbWVtYmVyRGl2KTsKICAgICAgICAgICAgcmVtZW1iZXJEaXYuaW5uZXJIVE1MID0gJzxpbnB1dCB0eXBlPSJ0ZXh0IiBpZD0ic2FmYXJpX3JlbWVtYmVyX2ZpZWxkIiBzdHlsZT0id2lkdGg6IDUwMHB4OyI+JzsKCiAgICAgICAgICAgIHZhciBmb3JtRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIGZvcm1EaXYuaWQgPSAnc2FmYXJpX2Zvcm1EaXYnOwogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGZvcm1EaXYpOwoKICAgICAgICAgICAgdmFyIHJlbG9hZGVyX2NvbnRlbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgcmVsb2FkZXJfY29udGVudC5pZCA9ICdzYWZhcmlyZWxvYWRlcic7CiAgICAgICAgICAgIHZhciBzY3JpcHRzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgczsgcyA9IHNjcmlwdHNbaV07IGkrKykgewogICAgICAgICAgICAgICAgaWYgKHMuc3JjLmluZGV4T2YoImhpc3RvcnkuanMiKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgaHRtbCA9IChuZXcgU3RyaW5nKHMuc3JjKSkucmVwbGFjZSgiLmpzIiwgIi5odG1sIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVsb2FkZXJfY29udGVudC5pbm5lckhUTUwgPSAnPGlmcmFtZSBpZD0ic2FmYXJpcmVsb2FkZXItaWZyYW1lIiBzcmM9ImFib3V0OmJsYW5rIiBmcmFtZWJvcmRlcj0ibm8iIHNjcm9sbGluZz0ibm8iPjwvaWZyYW1lPic7CiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQocmVsb2FkZXJfY29udGVudCk7CiAgICAgICAgICAgIHJlbG9hZGVyX2NvbnRlbnQuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnOwogICAgICAgICAgICByZWxvYWRlcl9jb250ZW50LnN0eWxlLmxlZnQgPSByZWxvYWRlcl9jb250ZW50LnN0eWxlLnRvcCA9ICctOTk5OXB4JzsKICAgICAgICAgICAgaWZyYW1lID0gcmVsb2FkZXJfY29udGVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaWZyYW1lJylbMF07CgogICAgICAgICAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoInNhZmFyaV9yZW1lbWJlcl9maWVsZCIpLnZhbHVlICE9ICIiICkgewogICAgICAgICAgICAgICAgaGlzdG9yeUhhc2ggPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic2FmYXJpX3JlbWVtYmVyX2ZpZWxkIikudmFsdWUuc3BsaXQoIiwiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGJyb3dzZXJIYXNIYXNoQ2hhbmdlKSAgICAgICAgCiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkub25oYXNoY2hhbmdlID0gaGFzaENoYW5nZUhhbmRsZXI7CiAgICB9OwoKICAgIHJldHVybiB7CiAgICAgICAgaGlzdG9yeUhhc2g6IGhpc3RvcnlIYXNoLCAKICAgICAgICBiYWNrU3RhY2s6IGZ1bmN0aW9uKCkgeyByZXR1cm4gYmFja1N0YWNrOyB9LCAKICAgICAgICBmb3J3YXJkU3RhY2s6IGZ1bmN0aW9uKCkgeyByZXR1cm4gZm9yd2FyZFN0YWNrIH0sIAogICAgICAgIGdldFBsYXllcjogZ2V0UGxheWVyLCAKICAgICAgICBpbml0aWFsaXplOiBmdW5jdGlvbihzcmMpIHsKICAgICAgICAgICAgX2luaXRpYWxpemUoc3JjKTsKICAgICAgICB9LCAKICAgICAgICBzZXRVUkw6IGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5ocmVmID0gdXJsOwogICAgICAgIH0sIAogICAgICAgIGdldFVSTDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwogICAgICAgIH0sIAogICAgICAgIGdldFRpdGxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LnRpdGxlOwogICAgICAgIH0sIAogICAgICAgIHNldFRpdGxlOiBmdW5jdGlvbih0aXRsZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgYmFja1N0YWNrW2JhY2tTdGFjay5sZW5ndGggLSAxXS50aXRsZSA9IHRpdGxlOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsgfQogICAgICAgICAgICAvL2lmIG9uIHNhZmFyaSwgc2V0IHRoZSB0aXRsZSB0byBiZSB0aGUgZW1wdHkgc3RyaW5nLiAKICAgICAgICAgICAgaWYgKGJyb3dzZXIuc2FmYXJpKSB7CiAgICAgICAgICAgICAgICBpZiAodGl0bGUgPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciB0bXAgPSB3aW5kb3cubG9jYXRpb24uaHJlZi50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgIHRpdGxlID0gdG1wLnN1YnN0cmluZygodG1wLmxhc3RJbmRleE9mKCIvIikrMSksIHRtcC5sYXN0SW5kZXhPZigiIyIpKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGUgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSB0aXRsZTsKICAgICAgICB9LCAKICAgICAgICBzZXREZWZhdWx0VVJMOiBmdW5jdGlvbihkZWYpCiAgICAgICAgewogICAgICAgICAgICBkZWZhdWx0SGFzaCA9IGRlZjsKICAgICAgICAgICAgZGVmID0gZ2V0SGFzaCgpOwogICAgICAgICAgICAvL3RyYWlsaW5nID8gaXMgaW1wb3J0YW50IGVsc2UgYW4gZXh0cmEgZnJhbWUgZ2V0cyBhZGRlZCB0byB0aGUgaGlzdG9yeQogICAgICAgICAgICAvL3doZW4gbmF2aWdhdGluZyBiYWNrIHRvIHRoZSBmaXJzdCBwYWdlLiAgQWx0ZXJuYXRpdmVseSBjb3VsZCBjaGVjawogICAgICAgICAgICAvL2luIGhpc3RvcnkgZnJhbWUgbmF2aWdhdGlvbiB0byBjb21wYXJlICMgYW5kID8uCiAgICAgICAgICAgIGlmIChicm93c2VyLmllKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3aW5kb3dbJ19pZV9maXJzdGxvYWQnXSA9IHRydWU7CiAgICAgICAgICAgICAgICB2YXIgc291cmNlVG9TZXQgPSBoaXN0b3J5RnJhbWVTb3VyY2VQcmVmaXggKyBkZWY7CiAgICAgICAgICAgICAgICB2YXIgZnVuYyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGdldEhpc3RvcnlGcmFtZSgpLnNyYyA9IHNvdXJjZVRvU2V0OwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKCIjIiArIGRlZik7CiAgICAgICAgICAgICAgICAgICAgc2V0SW50ZXJ2YWwoY2hlY2tGb3JVcmxDaGFuZ2UsIDUwKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGZ1bmMoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBmdW5jKCk7IH0sIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYnJvd3Nlci5zYWZhcmkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRIaXN0b3J5TGVuZ3RoID0gaGlzdG9yeS5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAoaGlzdG9yeUhhc2gubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgICAgICAgICBoaXN0b3J5SGFzaFtjdXJyZW50SGlzdG9yeUxlbmd0aF0gPSBkZWY7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld2xvYyA9ICIjIiArIGRlZjsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVwbGFjZShuZXdsb2MpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvL2FsZXJ0KGhpc3RvcnlIYXNoW2hpc3RvcnlIYXNoLmxlbmd0aC0xXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRJbnRlcnZhbChjaGVja0ZvclVybENoYW5nZSwgNTApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKGJyb3dzZXIuZmlyZWZveCB8fCBicm93c2VyLm9wZXJhKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcmVnID0gbmV3IFJlZ0V4cCgiIyIgKyBkZWYgKyAiJCIpOwogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5sb2NhdGlvbi50b1N0cmluZygpLm1hdGNoKHJlZykpIHsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld2xvYyA9IiMiICsgZGVmOwogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZXBsYWNlKG5ld2xvYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZXRJbnRlcnZhbChjaGVja0ZvclVybENoYW5nZSwgNTApOwogICAgICAgICAgICB9CgogICAgICAgIH0sIAoKICAgICAgICAvKiBTZXQgdGhlIGN1cnJlbnQgYnJvd3NlciBVUkw7IGNhbGxlZCBmcm9tIGluc2lkZSBCcm93c2VyTWFuYWdlciB0byBwcm9wYWdhdGUKICAgICAgICAgKiB0aGUgYXBwbGljYXRpb24gc3RhdGUgb3V0IHRvIHRoZSBjb250YWluZXIuCiAgICAgICAgICovCiAgICAgICAgc2V0QnJvd3NlclVSTDogZnVuY3Rpb24oZmxleEFwcFVybCwgb2JqZWN0SWQpIHsKICAgICAgICAgICAgaWYgKGJyb3dzZXIuaWUgJiYgdHlwZW9mIG9iamVjdElkICE9ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50T2JqZWN0SWQgPSBvYmplY3RJZDsKICAgICAgICAgICAgfQogICAgICAgICAgIC8vZnJvbUlmcmFtZSA9IGZyb21JZnJhbWUgfHwgZmFsc2U7CiAgICAgICAgICAgLy9mcm9tRmxleCA9IGZyb21GbGV4IHx8IGZhbHNlOwogICAgICAgICAgIC8vYWxlcnQoInNldEJyb3dzZXJVUkw6ICIgKyBmbGV4QXBwVXJsKTsKICAgICAgICAgICAvL2ZsZXhBcHBVcmwgPSAoZmxleEFwcFVybCA9PSAiIikgPyBkZWZhdWx0SGFzaCA6IGZsZXhBcHBVcmwgOwoKICAgICAgICAgICB2YXIgcG9zID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZi5pbmRleE9mKCcjJyk7CiAgICAgICAgICAgdmFyIGJhc2VVcmwgPSBwb3MgIT0gLTEgPyBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLnN1YnN0cigwLCBwb3MpIDogZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKICAgICAgICAgICB2YXIgbmV3VXJsID0gYmFzZVVybCArICcjJyArIGZsZXhBcHBVcmw7CgogICAgICAgICAgIGlmIChkb2N1bWVudC5sb2NhdGlvbi5ocmVmICE9IG5ld1VybCAmJiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmICsgJyMnICE9IG5ld1VybCkgewogICAgICAgICAgICAgICBjdXJyZW50SHJlZiA9IG5ld1VybDsKICAgICAgICAgICAgICAgYWRkSGlzdG9yeUVudHJ5KGJhc2VVcmwsIG5ld1VybCwgZmxleEFwcFVybCk7CiAgICAgICAgICAgICAgIGN1cnJlbnRIaXN0b3J5TGVuZ3RoID0gaGlzdG9yeS5sZW5ndGg7CiAgICAgICAgICAgfQogICAgICAgIH0sIAoKICAgICAgICBicm93c2VyVVJMQ2hhbmdlOiBmdW5jdGlvbihmbGV4QXBwVXJsKSB7CiAgICAgICAgICAgIHZhciBvYmplY3RJZCA9IG51bGw7CiAgICAgICAgICAgIGlmIChicm93c2VyLmllICYmIGN1cnJlbnRPYmplY3RJZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBvYmplY3RJZCA9IGN1cnJlbnRPYmplY3RJZDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHR5cGVvZiBCcm93c2VySGlzdG9yeV9tdWx0aXBsZSAhPSAidW5kZWZpbmVkIiAmJiBCcm93c2VySGlzdG9yeV9tdWx0aXBsZSA9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICB2YXIgcGwgPSBnZXRQbGF5ZXJzKCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBsLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxbaV0uYnJvd3NlclVSTENoYW5nZShmbGV4QXBwVXJsKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBnZXRQbGF5ZXIob2JqZWN0SWQpLmJyb3dzZXJVUkxDaGFuZ2UoZmxleEFwcFVybCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjdXJyZW50T2JqZWN0SWQgPSBudWxsOwogICAgICAgIH0sCiAgICAgICAgZ2V0VXNlckFnZW50OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgICAgICAgfSwKICAgICAgICBnZXRQbGF0Zm9ybTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBuYXZpZ2F0b3IucGxhdGZvcm07CiAgICAgICAgfQoKICAgIH0KCn0pKCk7CgovLyBJbml0aWFsaXphdGlvbgoKLy8gQXV0b21hdGVkIHVuaXQgdGVzdGluZyBhbmQgb3RoZXIgZGlhZ25vc3RpY3MKCmZ1bmN0aW9uIHNldFVSTCh1cmwpCnsKICAgIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgPSB1cmw7Cn0KCmZ1bmN0aW9uIGJhY2tCdXR0b24oKQp7CiAgICBoaXN0b3J5LmJhY2soKTsKfQoKZnVuY3Rpb24gZm9yd2FyZEJ1dHRvbigpCnsKICAgIGhpc3RvcnkuZm9yd2FyZCgpOwp9CgpmdW5jdGlvbiBnb0ZvcndhcmRPckJhY2tJbkhpc3Rvcnkoc3RlcCkKewogICAgaGlzdG9yeS5nbyhzdGVwKTsKfQoKLy9Ccm93c2VySGlzdG9yeVV0aWxzLmFkZEV2ZW50KHdpbmRvdywgImxvYWQiLCBmdW5jdGlvbigpIHsgQnJvd3Nlckhpc3RvcnkuaW5pdGlhbGl6ZSgpOyB9KTsKKGZ1bmN0aW9uKGkpIHsKICAgIHZhciB1ID1uYXZpZ2F0b3IudXNlckFnZW50O3ZhciBlPS8qQGNjX29uIUAqL2ZhbHNlOyAKICAgIHZhciBzdCA9IHNldFRpbWVvdXQ7CiAgICBpZigvd2Via2l0L2kudGVzdCh1KSl7CiAgICAgICAgc3QoZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIGRyPWRvY3VtZW50LnJlYWR5U3RhdGU7CiAgICAgICAgICAgIGlmKGRyPT0ibG9hZGVkInx8ZHI9PSJjb21wbGV0ZSIpe2koKX0KICAgICAgICAgICAgZWxzZXtzdChhcmd1bWVudHMuY2FsbGVlLDEwKTt9fSwxMCk7CiAgICB9IGVsc2UgaWYoKC9tb3ppbGxhL2kudGVzdCh1KSYmIS8oY29tcGF0aSkvLnRlc3QodSkpIHx8ICgvb3BlcmEvaS50ZXN0KHUpKSl7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsaSxmYWxzZSk7CiAgICB9IGVsc2UgaWYoZSl7CiAgICAoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdD1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkb2M6cmR5Jyk7CiAgICAgICAgdHJ5e3QuZG9TY3JvbGwoJ2xlZnQnKTsKICAgICAgICAgICAgaSgpO3Q9bnVsbDsKICAgICAgICB9Y2F0Y2goZSl7c3QoYXJndW1lbnRzLmNhbGxlZSwwKTt9fSkoKTsKICAgIH0gZWxzZXsKICAgICAgICB3aW5kb3cub25sb2FkPWk7CiAgICB9Cn0pKCBmdW5jdGlvbigpIHtCcm93c2VySGlzdG9yeS5pbml0aWFsaXplKCk7fSApOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 23:56:30 GMT",
                    "Content-Length": "24656",
                    "Date": "Thu, 06 Nov 2014 23:56:50 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}