{
    "url": "http://localhost:9999/rpflorence/snack/builds/snack-sizzle.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>document.location.pathname</b> and written to <b>the 'open()' function of an XMLHttpRequest object</b> via the following statements:<ul><li>url = document.location.pathname</li><li>url = url.substr(0, trimPosition)</li><li>xhr.open(method.toUpperCase(), url, open.async, options.user, options.password)</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/rpflorence/snack/builds/snack-sizzle.js",
                "path": "/rpflorence/snack/builds/snack-sizzle.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9ycGZsb3JlbmNlL3NuYWNrL2J1aWxkcy9zbmFjay1zaXp6bGUuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDk5NjUNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMDQ6NTY6MzkgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDA0OjU2OjM5IEdNVA0KDQovKiEKICAqIHNuYWNrLmpzIChjKSBSeWFuIEZsb3JlbmNlCiAgKiBodHRwczovL2dpdGh1Yi5jb20vcnBmbG9yZW5jZS9zbmFjawogICogTUlUIExpY2Vuc2UKICAqIEluc3BpcmF0aW9uIGFuZCBjb2RlIGFkYXB0ZWQgZnJvbQogICogIE1vb1Rvb2xzICAgICAgKGMpIFZhbGVyaW8gUHJvaWV0dGkgICBNSVQgbGljZW5zZQogICogIGpRdWVyeSAgICAgICAgKGMpIEpvaG4gUmVzaWcgICAgICAgICBEdWFsIGxpY2Vuc2UgTUlUIG9yIEdQTCBWZXJzaW9uIDIKICAqICBjb250ZW50TG9hZGVkIChjKSBEaWVnbyBQZXJpbmkgICAgICAgTUlUIExpY2Vuc2UKICAqICBaZXB0by5qcyAgICAgIChjKSBUaG9tYXMgRnVjaHMgICAgICAgTUlUIExpY2Vuc2UKKi8KCmlmICh0eXBlb2YgT2JqZWN0LmNyZWF0ZSAhPSAnZnVuY3Rpb24nKXsKICAvLyBFUzUgT2JlamVjdC5jcmVhdGUKICBPYmplY3QuY3JlYXRlID0gZnVuY3Rpb24gKG8pewogICAgZnVuY3Rpb24gRigpIHt9CiAgICBGLnByb3RvdHlwZSA9IG8KICAgIHJldHVybiBuZXcgRgogIH0KfQoKIWZ1bmN0aW9uKHdpbmRvdyl7CiAgdmFyIHNuYWNrID0gd2luZG93LnNuYWNrID0ge30KICAgICwgZ3VpZCA9IDAKICAgICwgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nCiAgICAsIGluZGV4T2YgPSBbXS5pbmRleE9mCiAgICAsIHB1c2ggPSBbXS5wdXNoCgogIHNuYWNrLmV4dGVuZCA9IGZ1bmN0aW9uICgpewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkKICAgICAgcmV0dXJuIHNuYWNrLmV4dGVuZChzbmFjaywgYXJndW1lbnRzWzBdKQoKICAgIHZhciB0YXJnZXQgPSBhcmd1bWVudHNbMF0KCiAgICBmb3IgKHZhciBrZXksIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgZm9yIChrZXkgaW4gYXJndW1lbnRzW2ldKQogICAgICAgIHRhcmdldFtrZXldID0gYXJndW1lbnRzW2ldW2tleV0KCiAgICByZXR1cm4gdGFyZ2V0CiAgfQoKICBzbmFjay5leHRlbmQoewogICAgdjogJzEuMi4zJywKCiAgICBiaW5kOiBmdW5jdGlvbiAoZm4sIGNvbnRleHQsIGFyZ3MpIHsKICAgICAgYXJncyA9IGFyZ3MgfHwgW107CiAgICAgIHJldHVybiBmdW5jdGlvbiAoKXsKICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIGFyZ3VtZW50cyk7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KGNvbnRleHQsIGFyZ3MpCiAgICAgIH0KICAgIH0sCgogICAgcHVuY2g6IGZ1bmN0aW9uIChvYmosIG1ldGhvZCwgZm4sIGF1dG8pewogICAgICB2YXIgb2xkID0gb2JqW21ldGhvZF0KICAgICAgb2JqW21ldGhvZF0gPSBhdXRvID8gZnVuY3Rpb24gKCl7CiAgICAgICAgb2xkLmFwcGx5KG9iaiwgYXJndW1lbnRzKQogICAgICAgIHJldHVybiBmbi5hcHBseShvYmosIGFyZ3VtZW50cykKICAgICAgfSA6IGZ1bmN0aW9uICgpewogICAgICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApCiAgICAgICAgYXJncy51bnNoaWZ0KHNuYWNrLmJpbmQob2xkLCBvYmopKQogICAgICAgIHJldHVybiBmbi5hcHBseShvYmosIGFyZ3MpCiAgICAgIH0KICAgIH0sCgogICAgY3JlYXRlOiBmdW5jdGlvbiAocHJvdG8sIGV4dCl7CiAgICAgIHZhciBvYmogPSBPYmplY3QuY3JlYXRlKHByb3RvKQogICAgICBpZiAoIWV4dCkKICAgICAgICByZXR1cm4gb2JqCgogICAgICBmb3IgKHZhciBpIGluIGV4dCkgewogICAgICAgIGlmICghZXh0Lmhhc093blByb3BlcnR5KGkpKQogICAgICAgICAgY29udGludWUKCiAgICAgICAgaWYgKCFwcm90b1tpXSB8fCB0eXBlb2YgZXh0W2ldICE9ICdmdW5jdGlvbicpewogICAgICAgICAgb2JqW2ldID0gZXh0W2ldCiAgICAgICAgICBjb250aW51ZQogICAgICAgIH0KCiAgICAgICAgc25hY2sucHVuY2gob2JqLCBpLCBleHRbaV0pCiAgICAgIH0KCiAgICAgIHJldHVybiBvYmoKICAgIH0sCgogICAgaWQ6IGZ1bmN0aW9uICgpewogICAgICByZXR1cm4gKytndWlkCiAgICB9LAoKICAgIGVhY2g6IGZ1bmN0aW9uIChvYmosIGZuLCBjb250ZXh0KXsKICAgICAgaWYgKG9iai5sZW5ndGggPT09IHZvaWQrMCl7IC8vIGxvb3NlIGNoZWNrIGZvciBvYmplY3QsIHdlIHdhbnQgYXJyYXktbGlrZSBvYmplY3RzIHRvIGJlIHRyZWF0ZWQgYXMgYXJyYXlzCiAgICAgICAgZm9yICh2YXIga2V5IGluIG9iaikKICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoa2V5KSkKICAgICAgICAgICAgZm4uY2FsbChjb250ZXh0LCBvYmpba2V5XSwga2V5LCBvYmopOwogICAgICAgIHJldHVybiBvYmoKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBvYmoubGVuZ3RoOyBpIDwgbDsgaSsrKQogICAgICAgIGZuLmNhbGwoY29udGV4dCwgb2JqW2ldLCBpLCBvYmopCiAgICAgIHJldHVybiBvYmoKICAgIH0sCgogICAgcGFyc2VKU09OOiBmdW5jdGlvbihqc29uKSB7CiAgICAgIC8vIGFkYXB0ZWQgZnJvbSBqUXVlcnkKICAgICAgaWYgKHR5cGVvZiBqc29uICE9ICdzdHJpbmcnKQogICAgICAgIHJldHVybgoKICAgICAganNvbiA9IGpzb24ucmVwbGFjZSgvXlxzK3xccyskL2csICcnKQoKICAgICAgdmFyIGlzVmFsaWQgPSAvXltcXSw6e31cc10qJC8udGVzdChqc29uLnJlcGxhY2UoL1xcKD86WyJcXFwvYmZucnRdfHVbMC05YS1mQS1GXXs0fSkvZywgIkAiKQogICAgICAgIC5yZXBsYWNlKC8iW14iXFxcblxyXSoifHRydWV8ZmFsc2V8bnVsbHwtP1xkKyg/OlwuXGQqKT8oPzpbZUVdWytcLV0/XGQrKT8vZywgIl0iKQogICAgICAgIC5yZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICIiKSkKCiAgICAgIGlmICghaXNWYWxpZCkKICAgICAgICB0aHJvdyAiSW52YWxpZCBKU09OIgogICAgICAKICAgICAgdmFyIEpTT04gPSB3aW5kb3cuSlNPTiAvLyBzYXZlcyBhIGNvdXBsZSBieXRlcwogICAgICByZXR1cm4gSlNPTiAmJiBKU09OLnBhcnNlID8gSlNPTi5wYXJzZShqc29uKSA6IChuZXcgRnVuY3Rpb24oInJldHVybiAiICsganNvbikpKCkKICAgIH0sCgogICAgaXNBcnJheTogZnVuY3Rpb24gKG9iail7CiAgICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBBcnJheSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT0gIltvYmplY3QgQXJyYXldIgogICAgfSwKCiAgICBpbmRleE9mOiBpbmRleE9mID8gZnVuY3Rpb24oaXRlbSwgYXJyYXkpewogICAgICAgIHJldHVybiBpbmRleE9mLmNhbGwoYXJyYXksIGl0ZW0pCiAgICAgIH0gOiBmdW5jdGlvbiAoaXRlbSwgYXJyYXkpewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgICBpZiAoYXJyYXlbaV0gPT09IGl0ZW0pCiAgICAgICAgICByZXR1cm4gaQoKICAgICAgcmV0dXJuIC0xCiAgICB9CiAgfSkKfSh3aW5kb3cpOwohZnVuY3Rpb24gKHNuYWNrLCBkb2N1bWVudCl7CiAgdmFyIHByb3RvID0ge30KICAgICwgcXVlcnkKCiAgc25hY2sud3JhcCA9IGZ1bmN0aW9uIChub2RlcywgY29udGV4dCl7CiAgICAvLyBwYXNzZWQgaW4gYSBDU1Mgc2VsZWN0b3IKICAgIGlmICh0eXBlb2Ygbm9kZXMgPT0gJ3N0cmluZycpCiAgICAgIG5vZGVzID0gcXVlcnkobm9kZXMsIGNvbnRleHQpCgogICAgLy8gcGFzc2VkIGluIHNpbmdsZSBub2RlCiAgICBpZiAoIW5vZGVzLmxlbmd0aCkKICAgICAgbm9kZXMgPSBbbm9kZXNdCgogICAgdmFyIHdyYXBwZXIgPSBPYmplY3QuY3JlYXRlKHByb3RvKQogICAgICAsIGkgPSAwCiAgICAgICwgbCA9IG5vZGVzLmxlbmd0aAoKICAgIGZvciAoOyBpIDwgbDsgaSsrKQogICAgICB3cmFwcGVyW2ldID0gbm9kZXNbaV0KCiAgICB3cmFwcGVyLmxlbmd0aCA9IGwKICAgIHdyYXBwZXIuaWQgPSBzbmFjay5pZCgpCiAgICByZXR1cm4gd3JhcHBlcgogIH0KCiAgc25hY2suZXh0ZW5kKHNuYWNrLndyYXAsIHsKICAgIGRlZmluZTogZnVuY3Rpb24obmFtZSwgZm4pewogICAgICBpZiAodHlwZW9mIG5hbWUgIT0gJ3N0cmluZycpewogICAgICAgIGZvciAodmFyIGkgaW4gbmFtZSkKICAgICAgICAgIHNuYWNrLndyYXAuZGVmaW5lKGksIG5hbWVbaV0pCiAgICAgICAgcmV0dXJuCiAgICAgIH0KICAgICAgcHJvdG9bbmFtZV0gPSBmbgogICAgfSwKCiAgICBkZWZpbmVFbmdpbmU6IGZ1bmN0aW9uIChmbil7CiAgICAgIHF1ZXJ5ID0gZm4KICAgIH0KICB9KQoKICAvLyBRU0EgZGVmYXVsdCBzZWxlY3RvciBlbmdpbmUsIHN1cHBvcnRzIHJlYWwgYnJvd3NlcnMgYW5kIElFOCsKICBzbmFjay53cmFwLmRlZmluZUVuZ2luZShmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpewogICAgaWYgKHR5cGVvZiBjb250ZXh0ID09ICdzdHJpbmcnKQogICAgICBjb250ZXh0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihjb250ZXh0KQoKICAgIHJldHVybiAoY29udGV4dCB8fCBkb2N1bWVudCkucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikKICB9KQp9KHNuYWNrLCBkb2N1bWVudCkKIWZ1bmN0aW9uIChzbmFjaywgd2luZG93LCBkb2N1bWVudCl7CiAgdmFyIGFkZCAgICAgICAgICAgID0gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciA/ICdhZGRFdmVudExpc3RlbmVyJyA6ICdhdHRhY2hFdmVudCcKICAgICwgcmVtb3ZlICAgICAgICAgPSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyID8gJ3JlbW92ZUV2ZW50TGlzdGVuZXInIDogJ2RldGFjaEV2ZW50JwogICAgLCBwcmVmaXggICAgICAgICA9IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgPyAnJyA6ICdvbicKICAgICwgcmVhZHkgICAgICAgICAgPSBmYWxzZQogICAgLCB0b3AgICAgICAgICAgICA9IHRydWUKICAgICwgcm9vdCAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQKICAgICwgcmVhZHlIYW5kbGVycyAgPSBbXQoKICBzbmFjay5leHRlbmQoewogICAgc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbiAoZXZlbnQpewogICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKQogICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpCiAgICAgIGVsc2UKICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlCiAgICB9LAoKICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbiAoZXZlbnQpewogICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKQogICAgICBlbHNlCiAgICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZQogICAgfQogIH0pCgogIHNuYWNrLmxpc3RlbmVyID0gZnVuY3Rpb24gKHBhcmFtcywgaGFuZGxlcil7CiAgICBpZiAocGFyYW1zLmRlbGVnYXRlKXsKICAgICAgcGFyYW1zLmNhcHR1cmUgPSB0cnVlCiAgICAgIF9oYW5kbGVyID0gaGFuZGxlcgogICAgICBoYW5kbGVyID0gZnVuY3Rpb24gKGV2ZW50KXsKICAgICAgICAvLyBhZGFwdGVkIGZyb20gWmVwdG8KICAgICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0IHx8IGV2ZW50LnNyY0VsZW1lbnQKICAgICAgICAgICwgbm9kZXMgPSB0eXBlb2YgcGFyYW1zLmRlbGVnYXRlID09ICdzdHJpbmcnCiAgICAgICAgICAgID8gc25hY2sud3JhcChwYXJhbXMuZGVsZWdhdGUsIHBhcmFtcy5ub2RlKQogICAgICAgICAgICA6IHBhcmFtcy5kZWxlZ2F0ZShwYXJhbXMubm9kZSkKCiAgICAgICAgd2hpbGUgKHRhcmdldCAmJiBzbmFjay5pbmRleE9mKHRhcmdldCwgbm9kZXMpID09IC0xICkKICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlCgogICAgICAgIGlmICh0YXJnZXQgJiYgISh0YXJnZXQgPT09IHRoaXMpICYmICEodGFyZ2V0ID09PSBkb2N1bWVudCkpCiAgICAgICAgICBfaGFuZGxlci5jYWxsKHRhcmdldCwgZXZlbnQsIHRhcmdldCkKICAgICAgfQogICAgfQoKICAgIGlmIChwYXJhbXMuY29udGV4dCkKICAgICAgaGFuZGxlciA9IHNuYWNrLmJpbmQoaGFuZGxlciwgcGFyYW1zLmNvbnRleHQpCgogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgIGF0dGFjaDogZnVuY3Rpb24gKCl7CiAgICAgICAgcGFyYW1zLm5vZGVbYWRkXSgKICAgICAgICAgIHByZWZpeCArIHBhcmFtcy5ldmVudCwKICAgICAgICAgIGhhbmRsZXIsCiAgICAgICAgICBwYXJhbXMuY2FwdHVyZQogICAgICAgICkKICAgICAgfSwKCiAgICAgIGRldGFjaDogZnVuY3Rpb24gKCl7CiAgICAgICAgcGFyYW1zLm5vZGVbcmVtb3ZlXSgKICAgICAgICAgIHByZWZpeCArIHBhcmFtcy5ldmVudCwKICAgICAgICAgIGhhbmRsZXIsCiAgICAgICAgICBwYXJhbXMuY2FwdHVyZQogICAgICAgICkKICAgICAgfSwKCiAgICAgIGZpcmU6IGZ1bmN0aW9uICgpewogICAgICAgIGhhbmRsZXIuYXBwbHkocGFyYW1zLm5vZGUsIGFyZ3VtZW50cykKICAgICAgfQogICAgfQoKICAgIG1ldGhvZHMuYXR0YWNoKCkKCiAgICByZXR1cm4gbWV0aG9kcwogIH0KCgoKCiAgc25hY2sucmVhZHkgPSBmdW5jdGlvbiAoaGFuZGxlcil7CiAgICBpZiAocmVhZHkpewogICAgICBoYW5kbGVyLmFwcGx5KGRvY3VtZW50KQogICAgICByZXR1cm4KICAgIH0KICAgIHJlYWR5SGFuZGxlcnMucHVzaChoYW5kbGVyKQogIH0KCiAgLy8gYWRhcHRlZCBmcm9tIGNvbnRlbnRsb2FkZWQKICBmdW5jdGlvbiBpbml0KGUpIHsKICAgIGlmIChlLnR5cGUgPT0gJ3JlYWR5c3RhdGVjaGFuZ2UnICYmIGRvY3VtZW50LnJlYWR5U3RhdGUgIT0gJ2NvbXBsZXRlJykKICAgICAgcmV0dXJuCgogICAgKGUudHlwZSA9PSAnbG9hZCcgPyB3aW5kb3cgOiBkb2N1bWVudClbcmVtb3ZlXShwcmVmaXggKyBlLnR5cGUsIGluaXQsIGZhbHNlKQoKICAgIGlmICghcmVhZHkgJiYgKHJlYWR5ID0gdHJ1ZSkpCiAgICAgIHNuYWNrLmVhY2gocmVhZHlIYW5kbGVycywgZnVuY3Rpb24gKGhhbmRsZXIpewogICAgICAgIGhhbmRsZXIuYXBwbHkoZG9jdW1lbnQpCiAgICAgIH0pCiAgfQoKICBmdW5jdGlvbiBwb2xsKCkgewogICAgdHJ5IHsKICAgICAgcm9vdC5kb1Njcm9sbCgnbGVmdCcpCiAgICB9IGNhdGNoKGUpIHsgCiAgICAgIHNldFRpbWVvdXQocG9sbCwgNTApCiAgICAgIHJldHVybgogICAgfQogICAgaW5pdCgncG9sbCcpCiAgfQoKICBpZiAoZG9jdW1lbnQuY3JlYXRlRXZlbnRPYmplY3QgJiYgcm9vdC5kb1Njcm9sbCkgewogICAgdHJ5IHsKICAgICAgdG9wID0gIXdpbmRvdy5mcmFtZUVsZW1lbnQKICAgIH0gY2F0Y2goZSkge30KICAgIGlmICh0b3ApCiAgICAgIHBvbGwoKTsKICB9CgogIGRvY3VtZW50W2FkZF0ocHJlZml4ICsgJ0RPTUNvbnRlbnRMb2FkZWQnLCBpbml0LCBmYWxzZSkKICBkb2N1bWVudFthZGRdKHByZWZpeCArICdyZWFkeXN0YXRlY2hhbmdlJywgaW5pdCwgZmFsc2UpCiAgd2luZG93W2FkZF0ocHJlZml4ICsgJ2xvYWQnLCBpbml0LCBmYWxzZSkKfShzbmFjaywgd2luZG93LCBkb2N1bWVudCk7CiFmdW5jdGlvbiAoc25hY2spewogIHNuYWNrLnB1Ymxpc2hlciA9IGZ1bmN0aW9uIChvYmopewogICAgdmFyIGNoYW5uZWxzID0ge30KICAgIG9iaiA9IG9iaiB8fCB7fQoKICAgIHNuYWNrLmV4dGVuZChvYmosIHsKICAgICAgc3Vic2NyaWJlOiBmdW5jdGlvbiAoY2hhbm5lbCwgaGFuZGxlciwgY29udGV4dCl7CiAgICAgICAgdmFyIHN1YnNjcmlwdGlvbiA9IHsKICAgICAgICAgIGZuOiBoYW5kbGVyLAogICAgICAgICAgY3R4dDogKGNvbnRleHQgfHwge30pCiAgICAgICAgfQoKICAgICAgICBpZiAoIWNoYW5uZWxzW2NoYW5uZWxdKQogICAgICAgICAgY2hhbm5lbHNbY2hhbm5lbF0gPSBbXQoKICAgICAgICB2YXIgcHVibGlrID0gewogICAgICAgICAgYXR0YWNoOiBmdW5jdGlvbiAoKXsKICAgICAgICAgICAgY2hhbm5lbHNbY2hhbm5lbF0ucHVzaChzdWJzY3JpcHRpb24pCiAgICAgICAgICB9LAogICAgICAgICAgZGV0YWNoOiBmdW5jdGlvbiAoKXsKICAgICAgICAgICAgY2hhbm5lbHNbY2hhbm5lbF0uc3BsaWNlKHNuYWNrLmluZGV4T2YoaGFuZGxlciwgY2hhbm5lbHNbY2hhbm5lbF0pLCAxKQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBwdWJsaWsuYXR0YWNoKCkKICAgICAgICByZXR1cm4gcHVibGlrCiAgICAgIH0sCgogICAgICBwdWJsaXNoOiBmdW5jdGlvbiAoY2hhbm5lbCwgYXJnc0FycmF5KXsKICAgICAgICBpZiAoIWNoYW5uZWxzW2NoYW5uZWxdKQogICAgICAgICAgcmV0dXJuIGZhbHNlCgogICAgICAgIHNuYWNrLmVhY2goY2hhbm5lbHNbY2hhbm5lbF0sIGZ1bmN0aW9uIChzdWJzY3JpcHRpb24pewogICAgICAgICAgc3Vic2NyaXB0aW9uLmZuLmFwcGx5KHN1YnNjcmlwdGlvbi5jdHh0LCBhcmdzQXJyYXkgfHwgW10pCiAgICAgICAgfSkKCiAgICAgICAgcmV0dXJuIGNoYW5uZWxzW2NoYW5uZWxdLmxlbmd0aAogICAgICB9CiAgICB9KQoKICAgIHJldHVybiBvYmoKICB9CgogIHNuYWNrLnB1Ymxpc2hlcihzbmFjaykKfShzbmFjayk7CiFmdW5jdGlvbihzbmFjaywgd2luZG93LCBkb2N1bWVudCl7CiAgc25hY2suSlNPTlAgPSBmdW5jdGlvbihwYXJhbXMsIGNhbGxiYWNrKXsKICAgIC8vIGFkYXB0ZWQgZnJvbSBaZXB0bwogICAgdmFyIGpzb25wU3RyaW5nID0gJ2pzb25wJyArIHNuYWNrLmlkKCkKICAgICAgLCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKQogICAgICAsIHJ1bm5pbmcgPSBmYWxzZQoKICAgICAgc25hY2suSlNPTlBbanNvbnBTdHJpbmddID0gZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgcnVubmluZyA9IGZhbHNlCiAgICAgICAgZGVsZXRlIHNuYWNrLkpTT05QW2pzb25wU3RyaW5nXQogICAgICAgIGNhbGxiYWNrKGRhdGEpCiAgICAgIH0KCiAgICAgIGlmICh0eXBlb2YgcGFyYW1zLmRhdGEgPT0gJ29iamVjdCcpCiAgICAgICAgcGFyYW1zLmRhdGEgPSBzbmFjay50b1F1ZXJ5U3RyaW5nKHBhcmFtcy5kYXRhKQoKICAgIHZhciBwdWJsaWsgPSB7CiAgICAgIHNlbmQ6IGZ1bmN0aW9uICgpewogICAgICAgIHJ1bm5pbmcgPSB0cnVlCiAgICAgICAgc2NyaXB0LnNyYyA9IHBhcmFtcy51cmwgKyAnPycgKyBwYXJhbXMua2V5ICsgJz1zbmFjay5KU09OUC4nICsganNvbnBTdHJpbmcgKyAnJicgKyBwYXJhbXMuZGF0YQogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF0uYXBwZW5kQ2hpbGQoc2NyaXB0KQogICAgICB9LAoKICAgICAgY2FuY2VsOiBmdW5jdGlvbiAoKXsKICAgICAgICBydW5uaW5nICYmIHNjcmlwdC5wYXJlbnROb2RlICYmIHNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcmlwdCkKICAgICAgICBydW5uaW5nID0gZmFsc2UKICAgICAgICBzbmFjay5KU09OUFtqc29ucFN0cmluZ10gPSBmdW5jdGlvbiAoKXsKICAgICAgICAgIGRlbGV0ZSBzbmFjay5KU09OUFtqc29ucFN0cmluZ10KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAocGFyYW1zLm5vdyAhPT0gZmFsc2UpCiAgICAgIHB1Ymxpay5zZW5kKCkKCiAgICByZXR1cm4gcHVibGlrCiAgfQoKICBzbmFjay50b1F1ZXJ5U3RyaW5nID0gZnVuY3Rpb24ob2JqZWN0LCBiYXNlKXsKICAgIC8vIGFkYXB0ZWQgZnJvbSBNb29Ub29scwogICAgdmFyIHF1ZXJ5U3RyaW5nID0gW10KCiAgICBzbmFjay5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CiAgICAgIGlmIChiYXNlKQogICAgICAgIGtleSA9IGJhc2UgKyAnWycgKyBrZXkgKyAnXScKCiAgICAgIHZhciByZXN1bHQKCiAgICAgIGlmIChzbmFjay5pc0FycmF5KHZhbHVlKSl7CiAgICAgICAgdmFyIHFzID0ge30KICAgICAgICBzbmFjay5lYWNoKHZhbHVlLCBmdW5jdGlvbih2YWwsIGkpewogICAgICAgICAgcXNbaV0gPSB2YWwKICAgICAgICB9KQogICAgICAgIHJlc3VsdCA9IHNuYWNrLnRvUXVlcnlTdHJpbmcocXMsIGtleSkKICAgICAgfQogICAgICBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcpCiAgICAgICAgcmVzdWx0ID0gc25hY2sudG9RdWVyeVN0cmluZyh2YWx1ZSwga2V5KQogICAgICBlbHNlCiAgICAgICAgcmVzdWx0ID0ga2V5ICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKQoKICAgICAgaWYgKHZhbHVlICE9PSBudWxsKQogICAgICAgIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KQogICAgfSkKCiAgICByZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpCiAgfQoKICB2YXIgeGhyT2JqZWN0ID0gKGZ1bmN0aW9uKCl7CiAgICAvLyBhZGFwdGVkIGZyb20gTW9vVG9vbHMKICAgIHZhciBYTUxIVFRQID0gZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgfQoKICAgIHZhciBNU1hNTDIgPSBmdW5jdGlvbigpewogICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01TWE1MMi5YTUxIVFRQJyk7CiAgICB9CgogICAgdmFyIE1TWE1MID0gZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOwogICAgfQoKICAgIHRyeSB7CiAgICAgIFhNTEhUVFAoKQogICAgICByZXR1cm4gWE1MSFRUUAogICAgfSBjYXRjaCAoZSl7CiAgICAgIHRyeSB7CiAgICAgICAgTVNYTUwyKCkKICAgICAgICByZXR1cm4gTVNYTUwyCiAgICAgIH0gY2F0Y2ggKGUpewogICAgICAgIE1TWE1MKCkKICAgICAgICByZXR1cm4gTVNYTUwKICAgICAgfQogICAgfQogIH0pKCk7CgogIGZ1bmN0aW9uIGVtcHR5KCl7fQoKICBzbmFjay5yZXF1ZXN0ID0gZnVuY3Rpb24gKG9wdGlvbnMsIGNhbGxiYWNrKXsKICAgIC8vIGFkYXB0ZWQgZnJvbSBNb29Ub29scwogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIHNuYWNrLnJlcXVlc3QpKQogICAgICByZXR1cm4gbmV3IHNuYWNrLnJlcXVlc3Qob3B0aW9ucywgY2FsbGJhY2spCgogICAgdmFyIHNlbGYgPSB0aGlzCiAgICBzZWxmLm9wdGlvbnMgPSBzbmFjay5leHRlbmQoe30sIHNlbGYub3B0aW9ucywgb3B0aW9ucykKICAgIHNlbGYuY2FsbGJhY2sgPSBjYWxsYmFjawogICAgc2VsZi54aHIgPSBuZXcgeGhyT2JqZWN0CiAgICBzZWxmLmhlYWRlcnMgPSBzZWxmLm9wdGlvbnMuaGVhZGVycwogICAgaWYgKHNlbGYub3B0aW9ucy5ub3cgIT09IGZhbHNlKQogICAgICBzZWxmLnNlbmQoKQogIH0KCiAgc25hY2sucmVxdWVzdC5wcm90b3R5cGUgPSB7CgogICAgb3B0aW9uczogey8qCiAgICAgIHVzZXI6ICcnLAogICAgICBwYXNzd29yZDogJycsKi8KICAgICAgZXhjZXB0aW9uOiBlbXB0eSwKICAgICAgdXJsOiAnJywKICAgICAgZGF0YTogJycsCiAgICAgIG1ldGhvZDogJ2dldCcsCiAgICAgIG5vdzogdHJ1ZSwKICAgICAgaGVhZGVyczogewogICAgICAgICdYLVJlcXVlc3RlZC1XaXRoJzogJ1hNTEh0dHBSZXF1ZXN0JywKICAgICAgICAnQWNjZXB0JzogJ3RleHQvamF2YXNjcmlwdCwgdGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCiAgICAgIH0sCiAgICAgIGFzeW5jOiB0cnVlLAogICAgICBlbXVsYXRpb246IHRydWUsCiAgICAgIHVybEVuY29kZWQ6IHRydWUsCiAgICAgIGVuY29kaW5nOiAndXRmLTgnCiAgICB9LAoKICAgIG9uU3RhdGVDaGFuZ2U6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzZWxmID0gdGhpcwogICAgICAgICwgeGhyID0gc2VsZi54aHIKCiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSAhPSA0IHx8ICFzZWxmLnJ1bm5pbmcpIHJldHVybgogICAgICBzZWxmLnJ1bm5pbmcgPSBmYWxzZQogICAgICBzZWxmLnN0YXR1cyA9IDAKCiAgICAgIHRyeXsKICAgICAgICB2YXIgc3RhdHVzID0geGhyLnN0YXR1cwogICAgICAgIHNlbGYuc3RhdHVzID0gKHN0YXR1cyA9PSAxMjIzKSA/IDIwNCA6IHN0YXR1cwogICAgICB9IGNhdGNoKGUpIHt9CgogICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgogICAgICB2YXIgYXJncyA9IHNlbGYuc3RhdHVzID49IDIwMCAmJiBzZWxmLnN0YXR1cyA8IDMwMAogICAgICAgID8gW2ZhbHNlLCBzZWxmLnhoci5yZXNwb25zZVRleHQgfHwgJycsIHNlbGYueGhyLnJlc3BvbnNlWE1MXQogICAgICAgIDogW3NlbGYuc3RhdHVzXQoKICAgICAgc2VsZi5jYWxsYmFjay5hcHBseShzZWxmLCBhcmdzKQogICAgfSwKICAKICAgIHNldEhlYWRlcjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICB0aGlzLmhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIGdldEhlYWRlcjogZnVuY3Rpb24obmFtZSl7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIHRoaXMueGhyLmdldFJlc3BvbnNlSGVhZGVyKG5hbWUpCiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIHJldHVybiBudWxsCiAgICAgIH0KICAgIH0sCiAgCiAgICBzZW5kOiBmdW5jdGlvbigpewogICAgICB2YXIgc2VsZiA9IHRoaXMKICAgICAgICAsIG9wdGlvbnMgPSBzZWxmLm9wdGlvbnMKCiAgICAgIGlmIChzZWxmLnJ1bm5pbmcpIHJldHVybiBzZWxmOwoKICAgICAgc2VsZi5ydW5uaW5nID0gdHJ1ZTsKCiAgICAgIHZhciBkYXRhID0gb3B0aW9ucy5kYXRhIHx8ICcnCiAgICAgICAgLCB1cmwgPSBTdHJpbmcob3B0aW9ucy51cmwpCiAgICAgICAgLCBtZXRob2QgPSBvcHRpb25zLm1ldGhvZC50b0xvd2VyQ2FzZSgpCgogICAgICBpZiAodHlwZW9mIGRhdGEgIT0gJ3N0cmluZycpCiAgICAgICAgZGF0YSA9IHNuYWNrLnRvUXVlcnlTdHJpbmcoZGF0YSkKCiAgICAgIGlmIChvcHRpb25zLmVtdWxhdGlvbiAmJiBzbmFjay5pbmRleE9mKG1ldGhvZCwgWydnZXQnLCAncG9zdCddKSA8IDApewogICAgICAgIHZhciBfbWV0aG9kID0gJ19tZXRob2Q9JyArIG1ldGhvZAogICAgICAgIGRhdGEgPSAoZGF0YSkgPyBfbWV0aG9kICsgJyYnICsgZGF0YSA6IF9tZXRob2QKICAgICAgICBtZXRob2QgPSAncG9zdCcKICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMudXJsRW5jb2RlZCAmJiBzbmFjay5pbmRleE9mKG1ldGhvZCwgWydwb3N0JywgJ3B1dCddKSA+IC0xKXsKICAgICAgICB2YXIgZW5jb2RpbmcgPSAob3B0aW9ucy5lbmNvZGluZykgPyAnOyBjaGFyc2V0PScgKyBvcHRpb25zLmVuY29kaW5nIDogJycKICAgICAgICBzZWxmLmhlYWRlcnNbJ0NvbnRlbnQtdHlwZSddID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcgKyBlbmNvZGluZwogICAgICB9CgogICAgICBpZiAoIXVybCkKICAgICAgICB1cmwgPSBkb2N1bWVudC5sb2NhdGlvbi5wYXRobmFtZQoKICAgICAgdmFyIHRyaW1Qb3NpdGlvbiA9IHVybC5sYXN0SW5kZXhPZignLycpCiAgICAgIGlmICh0cmltUG9zaXRpb24gPiAtMSAmJiAodHJpbVBvc2l0aW9uID0gdXJsLmluZGV4T2YoJyMnKSkgPiAtMSkKICAgICAgICB1cmwgPSB1cmwuc3Vic3RyKDAsIHRyaW1Qb3NpdGlvbikKCiAgICAgIGlmIChkYXRhICYmIG1ldGhvZCA9PSAnZ2V0Jyl7CiAgICAgICAgdXJsICs9ICh1cmwuaW5kZXhPZignPycpID4gLTEgPyAnJicgOiAnPycpICsgZGF0YQogICAgICAgIGRhdGEgPSBudWxsCiAgICAgIH0KCiAgICAgIHZhciB4aHIgPSBzZWxmLnhocgoKICAgICAgeGhyLm9wZW4obWV0aG9kLnRvVXBwZXJDYXNlKCksIHVybCwgb3Blbi5hc3luYywgb3B0aW9ucy51c2VyLCBvcHRpb25zLnBhc3N3b3JkKQogICAgICBpZiAob3B0aW9ucy51c2VyICYmICd3aXRoQ3JlZGVudGlhbHMnIGluIHhocikgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWUKICAgIAogICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gc25hY2suYmluZChzZWxmLm9uU3RhdGVDaGFuZ2UsIHNlbGYpCgogICAgICBmb3IgKHZhciBpIGluIHNlbGYuaGVhZGVycyl7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGksIHNlbGYuaGVhZGVyc1tpXSkKICAgICAgICB9IGNhdGNoIChlKXsKICAgICAgICAgIG9wdGlvbnMuZXhjZXB0aW9uLmFwcGx5KHNlbGYsIFtpLCBzZWxmLmhlYWRlcnNbaV1dKQogICAgICAgIH0KICAgICAgfQoKICAgICAgeGhyLnNlbmQoZGF0YSkKICAgICAgaWYgKCFvcHRpb25zLmFzeW5jKSBzZWxmLm9uU3RhdGVDaGFuZ2UoKQogICAgCiAgICAgIHJldHVybiBzZWxmCiAgICB9LAoKICAgIGNhbmNlbDogZnVuY3Rpb24oKXsKICAgICAgdmFyIHNlbGYgPSB0aGlzCgogICAgICBpZiAoIXNlbGYucnVubmluZykKICAgICAgICByZXR1cm4gc2VsZgoKICAgICAgc2VsZi5ydW5uaW5nID0gZmFsc2UKCiAgICAgIHZhciB4aHIgPSBzZWxmLnhocgogICAgICB4aHIuYWJvcnQoKQoKICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5CgogICAgICBzZWxmLnhociA9IG5ldyB4aHJPYmplY3QoKQogICAgICByZXR1cm4gc2VsZgogICAgfQogIH0KfShzbmFjaywgd2luZG93LCBkb2N1bWVudCkKIWZ1bmN0aW9uKHNuYWNrLCBkb2N1bWVudCl7CiAgc25hY2sud3JhcC5kZWZpbmUoewogICAgZGF0YTogZnVuY3Rpb24gKCl7CiAgICAgIC8vIEFQSSBpbnNwaXJlZCBieSBqUXVlcnkKICAgICAgdmFyIHN0b3JhZ2UgPSB7fQoKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChrZXksIHZhbHVlKXsKICAgICAgICB2YXIgZGF0YSA9IHN0b3JhZ2VbdGhpcy5pZF0KCiAgICAgICAgaWYgKCFkYXRhKQogICAgICAgICAgZGF0YSA9IHN0b3JhZ2VbdGhpcy5pZF0gPSB7fQoKICAgICAgICBpZiAodmFsdWUgPT09IHZvaWQrMSkKICAgICAgICAgIHJldHVybiBkYXRhW2tleV0KCiAgICAgICAgcmV0dXJuIGRhdGFba2V5XSA9IHZhbHVlCiAgICAgIH0gIAogICAgfSgpLAoKICAgIGVhY2g6IGZ1bmN0aW9uIChmbiwgY29udGV4dCl7CiAgICAgIHJldHVybiBzbmFjay5lYWNoKHRoaXMsIGZuLCBjb250ZXh0KQogICAgfSwKICAKICAgIGFkZENsYXNzOiBmdW5jdGlvbiAoY2xhc3NOYW1lKXsKICAgICAgLy8gYWRhcHRlZCBmcm9tIE1vb1Rvb2xzCiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGVsZW1lbnQpewogICAgICAgIGlmIChjbGVhbihlbGVtZW50LmNsYXNzTmFtZSkuaW5kZXhPZihjbGFzc05hbWUpID4gLTEpCiAgICAgICAgICByZXR1cm4KICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGNsZWFuKGVsZW1lbnQuY2xhc3NOYW1lICsgJyAnICsgY2xhc3NOYW1lKQogICAgICB9KQogICAgfSwKCiAgICByZW1vdmVDbGFzczogZnVuY3Rpb24gKGNsYXNzTmFtZSl7CiAgICAgIC8vIGFkYXB0ZWQgZnJvbSBNb29Ub29scwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChlbGVtZW50KXsKICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnJlcGxhY2UobmV3IFJlZ0V4cCgnKF58XFxzKScgKyBjbGFzc05hbWUgKyAnKD86XFxzfCQpJyksICckMScpCiAgICAgIH0pCiAgICB9LAoKICAgIGF0dGFjaDogZnVuY3Rpb24gKGV2ZW50LCBoYW5kbGVyLCAvKiBpbnRlcm5hbCAqLyBkZWxlZ2F0aW9uKXsKICAgICAgdmFyIHNwbGl0ID0gZXZlbnQuc3BsaXQoJy4nKQogICAgICAgICwgbGlzdGVuZXJzID0gW10KCiAgICAgIGlmIChzcGxpdFsxXSkKICAgICAgICBsaXN0ZW5lcnMgPSB0aGlzLmRhdGEoc3BsaXRbMV0pIHx8IFtdCgogICAgICB0aGlzLmVhY2goZnVuY3Rpb24obm9kZSl7CiAgICAgICAgdmFyIHBhcmFtcyA9IHsKICAgICAgICAgIG5vZGU6IG5vZGUsCiAgICAgICAgICBldmVudDogc3BsaXRbMF0KICAgICAgICB9CgogICAgICAgIGlmIChkZWxlZ2F0aW9uKQogICAgICAgICAgcGFyYW1zLmRlbGVnYXRlID0gZGVsZWdhdGlvbgoKICAgICAgICBsaXN0ZW5lcnMucHVzaChzbmFjay5saXN0ZW5lcihwYXJhbXMsIGhhbmRsZXIpKQogICAgICB9KQoKICAgICAgaWYgKHNwbGl0WzFdKQogICAgICAgIHRoaXMuZGF0YShzcGxpdFsxXSwgbGlzdGVuZXJzKQoKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCgogICAgZGV0YWNoOiBmdW5jdGlvbiAobmFtZXNwYWNlKXsKICAgICAgbGlzdGVuZXJNZXRob2QodGhpcywgJ2RldGFjaCcsIG5hbWVzcGFjZSwgbnVsbCwgdHJ1ZSkKICAgICAgdGhpcy5kYXRhKG5hbWVzcGFjZSwgbnVsbCkKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCgogICAgZmlyZTogZnVuY3Rpb24gKG5hbWVzcGFjZSwgYXJncyl7CiAgICAgIHJldHVybiBsaXN0ZW5lck1ldGhvZCh0aGlzLCAnZmlyZScsIG5hbWVzcGFjZSwgYXJncykKICAgIH0sCgogICAgZGVsZWdhdGU6IGZ1bmN0aW9uIChldmVudCwgZGVsZWdhdGlvbiwgaGFuZGxlcil7CiAgICAgIHJldHVybiB0aGlzLmF0dGFjaChldmVudCwgaGFuZGxlciwgZGVsZWdhdGlvbikKICAgIH0KICB9KQoKICBmdW5jdGlvbiBjbGVhbihzdHIpewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9ccysvZywgJyAnKS5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpCiAgfQoKICBmdW5jdGlvbiBsaXN0ZW5lck1ldGhvZCh3cmFwcGVyLCBtZXRob2QsIG5hbWVzcGFjZSwgYXJncyl7CiAgICB2YXIgZGF0YSA9IHdyYXBwZXIuZGF0YShuYW1lc3BhY2UpCgogICAgaWYgKGRhdGEpCiAgICAgIHNuYWNrLmVhY2goZGF0YSwgZnVuY3Rpb24gKGxpc3RlbmVyKXsKICAgICAgICBsaXN0ZW5lclttZXRob2RdLmFwcGx5KHdyYXBwZXIsIGFyZ3MpCiAgICAgIH0pCgogICAgcmV0dXJuIHdyYXBwZXIKICB9Cn0oc25hY2ssIGRvY3VtZW50KTsKLyohCiAqIFNpenpsZSBDU1MgU2VsZWN0b3IgRW5naW5lCiAqICBDb3B5cmlnaHQgMjAxMSwgVGhlIERvam8gRm91bmRhdGlvbgogKiAgUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCwgQlNELCBhbmQgR1BMIExpY2Vuc2VzLgogKiAgTW9yZSBpbmZvcm1hdGlvbjogaHR0cDovL3NpenpsZWpzLmNvbS8KICovCihmdW5jdGlvbigpewoKdmFyIGNodW5rZXIgPSAvKCg/OlwoKD86XChbXigpXStcKXxbXigpXSspK1wpfFxbKD86XFtbXlxbXF1dKlxdfFsnIl1bXiciXSpbJyJdfFteXFtcXSciXSspK1xdfFxcLnxbXiA+K34sKFxbXFxdKykrfFs+K35dKShccyosXHMqKT8oKD86LnxccnxcbikqKS9nLAoJZG9uZSA9IDAsCgl0b1N0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcsCgloYXNEdXBsaWNhdGUgPSBmYWxzZSwKCWJhc2VIYXNEdXBsaWNhdGUgPSB0cnVlLAoJckJhY2tzbGFzaCA9IC9cXC9nLAoJck5vbldvcmQgPSAvXFcvOwoKLy8gSGVyZSB3ZSBjaGVjayBpZiB0aGUgSmF2YVNjcmlwdCBlbmdpbmUgaXMgdXNpbmcgc29tZSBzb3J0IG9mCi8vIG9wdGltaXphdGlvbiB3aGVyZSBpdCBkb2VzIG5vdCBhbHdheXMgY2FsbCBvdXIgY29tcGFyaXNpb24KLy8gZnVuY3Rpb24uIElmIHRoYXQgaXMgdGhlIGNhc2UsIGRpc2NhcmQgdGhlIGhhc0R1cGxpY2F0ZSB2YWx1ZS4KLy8gICBUaHVzIGZhciB0aGF0IGluY2x1ZGVzIEdvb2dsZSBDaHJvbWUuClswLCAwXS5zb3J0KGZ1bmN0aW9uKCkgewoJYmFzZUhhc0R1cGxpY2F0ZSA9IGZhbHNlOwoJcmV0dXJuIDA7Cn0pOwoKdmFyIFNpenpsZSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApIHsKCXJlc3VsdHMgPSByZXN1bHRzIHx8IFtdOwoJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgoJdmFyIG9yaWdDb250ZXh0ID0gY29udGV4dDsKCglpZiAoIGNvbnRleHQubm9kZVR5cGUgIT09IDEgJiYgY29udGV4dC5ub2RlVHlwZSAhPT0gOSApIHsKCQlyZXR1cm4gW107Cgl9CgkKCWlmICggIXNlbGVjdG9yIHx8IHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIgKSB7CgkJcmV0dXJuIHJlc3VsdHM7Cgl9CgoJdmFyIG0sIHNldCwgY2hlY2tTZXQsIGV4dHJhLCByZXQsIGN1ciwgcG9wLCBpLAoJCXBydW5lID0gdHJ1ZSwKCQljb250ZXh0WE1MID0gU2l6emxlLmlzWE1MKCBjb250ZXh0ICksCgkJcGFydHMgPSBbXSwKCQlzb0ZhciA9IHNlbGVjdG9yOwoJCgkvLyBSZXNldCB0aGUgcG9zaXRpb24gb2YgdGhlIGNodW5rZXIgcmVnZXhwIChzdGFydCBmcm9tIGhlYWQpCglkbyB7CgkJY2h1bmtlci5leGVjKCAiIiApOwoJCW0gPSBjaHVua2VyLmV4ZWMoIHNvRmFyICk7CgoJCWlmICggbSApIHsKCQkJc29GYXIgPSBtWzNdOwoJCQoJCQlwYXJ0cy5wdXNoKCBtWzFdICk7CgkJCgkJCWlmICggbVsyXSApIHsKCQkJCWV4dHJhID0gbVszXTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfSB3aGlsZSAoIG0gKTsKCglpZiAoIHBhcnRzLmxlbmd0aCA+IDEgJiYgb3JpZ1BPUy5leGVjKCBzZWxlY3RvciApICkgewoKCQlpZiAoIHBhcnRzLmxlbmd0aCA9PT0gMiAmJiBFeHByLnJlbGF0aXZlWyBwYXJ0c1swXSBdICkgewoJCQlzZXQgPSBwb3NQcm9jZXNzKCBwYXJ0c1swXSArIHBhcnRzWzFdLCBjb250ZXh0ICk7CgoJCX0gZWxzZSB7CgkJCXNldCA9IEV4cHIucmVsYXRpdmVbIHBhcnRzWzBdIF0gPwoJCQkJWyBjb250ZXh0IF0gOgoJCQkJU2l6emxlKCBwYXJ0cy5zaGlmdCgpLCBjb250ZXh0ICk7CgoJCQl3aGlsZSAoIHBhcnRzLmxlbmd0aCApIHsKCQkJCXNlbGVjdG9yID0gcGFydHMuc2hpZnQoKTsKCgkJCQlpZiAoIEV4cHIucmVsYXRpdmVbIHNlbGVjdG9yIF0gKSB7CgkJCQkJc2VsZWN0b3IgKz0gcGFydHMuc2hpZnQoKTsKCQkJCX0KCQkJCQoJCQkJc2V0ID0gcG9zUHJvY2Vzcyggc2VsZWN0b3IsIHNldCApOwoJCQl9CgkJfQoKCX0gZWxzZSB7CgkJLy8gVGFrZSBhIHNob3J0Y3V0IGFuZCBzZXQgdGhlIGNvbnRleHQgaWYgdGhlIHJvb3Qgc2VsZWN0b3IgaXMgYW4gSUQKCQkvLyAoYnV0IG5vdCBpZiBpdCdsbCBiZSBmYXN0ZXIgaWYgdGhlIGlubmVyIHNlbGVjdG9yIGlzIGFuIElEKQoJCWlmICggIXNlZWQgJiYgcGFydHMubGVuZ3RoID4gMSAmJiBjb250ZXh0Lm5vZGVUeXBlID09PSA5ICYmICFjb250ZXh0WE1MICYmCgkJCQlFeHByLm1hdGNoLklELnRlc3QocGFydHNbMF0pICYmICFFeHByLm1hdGNoLklELnRlc3QocGFydHNbcGFydHMubGVuZ3RoIC0gMV0pICkgewoKCQkJcmV0ID0gU2l6emxlLmZpbmQoIHBhcnRzLnNoaWZ0KCksIGNvbnRleHQsIGNvbnRleHRYTUwgKTsKCQkJY29udGV4dCA9IHJldC5leHByID8KCQkJCVNpenpsZS5maWx0ZXIoIHJldC5leHByLCByZXQuc2V0IClbMF0gOgoJCQkJcmV0LnNldFswXTsKCQl9CgoJCWlmICggY29udGV4dCApIHsKCQkJcmV0ID0gc2VlZCA/CgkJCQl7IGV4cHI6IHBhcnRzLnBvcCgpLCBzZXQ6IG1ha2VBcnJheShzZWVkKSB9IDoKCQkJCVNpenpsZS5maW5kKCBwYXJ0cy5wb3AoKSwgcGFydHMubGVuZ3RoID09PSAxICYmIChwYXJ0c1swXSA9PT0gIn4iIHx8IHBhcnRzWzBdID09PSAiKyIpICYmIGNvbnRleHQucGFyZW50Tm9kZSA/IGNvbnRleHQucGFyZW50Tm9kZSA6IGNvbnRleHQsIGNvbnRleHRYTUwgKTsKCgkJCXNldCA9IHJldC5leHByID8KCQkJCVNpenpsZS5maWx0ZXIoIHJldC5leHByLCByZXQuc2V0ICkgOgoJCQkJcmV0LnNldDsKCgkJCWlmICggcGFydHMubGVuZ3RoID4gMCApIHsKCQkJCWNoZWNrU2V0ID0gbWFrZUFycmF5KCBzZXQgKTsKCgkJCX0gZWxzZSB7CgkJCQlwcnVuZSA9IGZhbHNlOwoJCQl9CgoJCQl3aGlsZSAoIHBhcnRzLmxlbmd0aCApIHsKCQkJCWN1ciA9IHBhcnRzLnBvcCgpOwoJCQkJcG9wID0gY3VyOwoKCQkJCWlmICggIUV4cHIucmVsYXRpdmVbIGN1ciBdICkgewoJCQkJCWN1ciA9ICIiOwoJCQkJfSBlbHNlIHsKCQkJCQlwb3AgPSBwYXJ0cy5wb3AoKTsKCQkJCX0KCgkJCQlpZiAoIHBvcCA9PSBudWxsICkgewoJCQkJCXBvcCA9IGNvbnRleHQ7CgkJCQl9CgoJCQkJRXhwci5yZWxhdGl2ZVsgY3VyIF0oIGNoZWNrU2V0LCBwb3AsIGNvbnRleHRYTUwgKTsKCQkJfQoKCQl9IGVsc2UgewoJCQljaGVja1NldCA9IHBhcnRzID0gW107CgkJfQoJfQoKCWlmICggIWNoZWNrU2V0ICkgewoJCWNoZWNrU2V0ID0gc2V0OwoJfQoKCWlmICggIWNoZWNrU2V0ICkgewoJCVNpenpsZS5lcnJvciggY3VyIHx8IHNlbGVjdG9yICk7Cgl9CgoJaWYgKCB0b1N0cmluZy5jYWxsKGNoZWNrU2V0KSA9PT0gIltvYmplY3QgQXJyYXldIiApIHsKCQlpZiAoICFwcnVuZSApIHsKCQkJcmVzdWx0cy5wdXNoLmFwcGx5KCByZXN1bHRzLCBjaGVja1NldCApOwoKCQl9IGVsc2UgaWYgKCBjb250ZXh0ICYmIGNvbnRleHQubm9kZVR5cGUgPT09IDEgKSB7CgkJCWZvciAoIGkgPSAwOyBjaGVja1NldFtpXSAhPSBudWxsOyBpKysgKSB7CgkJCQlpZiAoIGNoZWNrU2V0W2ldICYmIChjaGVja1NldFtpXSA9PT0gdHJ1ZSB8fCBjaGVja1NldFtpXS5ub2RlVHlwZSA9PT0gMSAmJiBTaXp6bGUuY29udGFpbnMoY29udGV4dCwgY2hlY2tTZXRbaV0pKSApIHsKCQkJCQlyZXN1bHRzLnB1c2goIHNldFtpXSApOwoJCQkJfQoJCQl9CgoJCX0gZWxzZSB7CgkJCWZvciAoIGkgPSAwOyBjaGVja1NldFtpXSAhPSBudWxsOyBpKysgKSB7CgkJCQlpZiAoIGNoZWNrU2V0W2ldICYmIGNoZWNrU2V0W2ldLm5vZGVUeXBlID09PSAxICkgewoJCQkJCXJlc3VsdHMucHVzaCggc2V0W2ldICk7CgkJCQl9CgkJCX0KCQl9CgoJfSBlbHNlIHsKCQltYWtlQXJyYXkoIGNoZWNrU2V0LCByZXN1bHRzICk7Cgl9CgoJaWYgKCBleHRyYSApIHsKCQlTaXp6bGUoIGV4dHJhLCBvcmlnQ29udGV4dCwgcmVzdWx0cywgc2VlZCApOwoJCVNpenpsZS51bmlxdWVTb3J0KCByZXN1bHRzICk7Cgl9CgoJcmV0dXJuIHJlc3VsdHM7Cn07CgpTaXp6bGUudW5pcXVlU29ydCA9IGZ1bmN0aW9uKCByZXN1bHRzICkgewoJaWYgKCBzb3J0T3JkZXIgKSB7CgkJaGFzRHVwbGljYXRlID0gYmFzZUhhc0R1cGxpY2F0ZTsKCQlyZXN1bHRzLnNvcnQoIHNvcnRPcmRlciApOwoKCQlpZiAoIGhhc0R1cGxpY2F0ZSApIHsKCQkJZm9yICggdmFyIGkgPSAxOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKyApIHsKCQkJCWlmICggcmVzdWx0c1tpXSA9PT0gcmVzdWx0c1sgaSAtIDEgXSApIHsKCQkJCQlyZXN1bHRzLnNwbGljZSggaS0tLCAxICk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIHJlc3VsdHM7Cn07CgpTaXp6bGUubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBzZXQgKSB7CglyZXR1cm4gU2l6emxlKCBleHByLCBudWxsLCBudWxsLCBzZXQgKTsKfTsKClNpenpsZS5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggbm9kZSwgZXhwciApIHsKCXJldHVybiBTaXp6bGUoIGV4cHIsIG51bGwsIG51bGwsIFtub2RlXSApLmxlbmd0aCA+IDA7Cn07CgpTaXp6bGUuZmluZCA9IGZ1bmN0aW9uKCBleHByLCBjb250ZXh0LCBpc1hNTCApIHsKCXZhciBzZXQ7CgoJaWYgKCAhZXhwciApIHsKCQlyZXR1cm4gW107Cgl9CgoJZm9yICggdmFyIGkgPSAwLCBsID0gRXhwci5vcmRlci5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJdmFyIG1hdGNoLAoJCQl0eXBlID0gRXhwci5vcmRlcltpXTsKCQkKCQlpZiAoIChtYXRjaCA9IEV4cHIubGVmdE1hdGNoWyB0eXBlIF0uZXhlYyggZXhwciApKSApIHsKCQkJdmFyIGxlZnQgPSBtYXRjaFsxXTsKCQkJbWF0Y2guc3BsaWNlKCAxLCAxICk7CgoJCQlpZiAoIGxlZnQuc3Vic3RyKCBsZWZ0Lmxlbmd0aCAtIDEgKSAhPT0gIlxcIiApIHsKCQkJCW1hdGNoWzFdID0gKG1hdGNoWzFdIHx8ICIiKS5yZXBsYWNlKCByQmFja3NsYXNoLCAiIiApOwoJCQkJc2V0ID0gRXhwci5maW5kWyB0eXBlIF0oIG1hdGNoLCBjb250ZXh0LCBpc1hNTCApOwoKCQkJCWlmICggc2V0ICE9IG51bGwgKSB7CgkJCQkJZXhwciA9IGV4cHIucmVwbGFjZSggRXhwci5tYXRjaFsgdHlwZSBdLCAiIiApOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJfQoKCWlmICggIXNldCApIHsKCQlzZXQgPSB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIgPwoJCQljb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCAiKiIgKSA6CgkJCVtdOwoJfQoKCXJldHVybiB7IHNldDogc2V0LCBleHByOiBleHByIH07Cn07CgpTaXp6bGUuZmlsdGVyID0gZnVuY3Rpb24oIGV4cHIsIHNldCwgaW5wbGFjZSwgbm90ICkgewoJdmFyIG1hdGNoLCBhbnlGb3VuZCwKCQlvbGQgPSBleHByLAoJCXJlc3VsdCA9IFtdLAoJCWN1ckxvb3AgPSBzZXQsCgkJaXNYTUxGaWx0ZXIgPSBzZXQgJiYgc2V0WzBdICYmIFNpenpsZS5pc1hNTCggc2V0WzBdICk7CgoJd2hpbGUgKCBleHByICYmIHNldC5sZW5ndGggKSB7CgkJZm9yICggdmFyIHR5cGUgaW4gRXhwci5maWx0ZXIgKSB7CgkJCWlmICggKG1hdGNoID0gRXhwci5sZWZ0TWF0Y2hbIHR5cGUgXS5leGVjKCBleHByICkpICE9IG51bGwgJiYgbWF0Y2hbMl0gKSB7CgkJCQl2YXIgZm91bmQsIGl0ZW0sCgkJCQkJZmlsdGVyID0gRXhwci5maWx0ZXJbIHR5cGUgXSwKCQkJCQlsZWZ0ID0gbWF0Y2hbMV07CgoJCQkJYW55Rm91bmQgPSBmYWxzZTsKCgkJCQltYXRjaC5zcGxpY2UoMSwxKTsKCgkJCQlpZiAoIGxlZnQuc3Vic3RyKCBsZWZ0Lmxlbmd0aCAtIDEgKSA9PT0gIlxcIiApIHsKCQkJCQljb250aW51ZTsKCQkJCX0KCgkJCQlpZiAoIGN1ckxvb3AgPT09IHJlc3VsdCApIHsKCQkJCQlyZXN1bHQgPSBbXTsKCQkJCX0KCgkJCQlpZiAoIEV4cHIucHJlRmlsdGVyWyB0eXBlIF0gKSB7CgkJCQkJbWF0Y2ggPSBFeHByLnByZUZpbHRlclsgdHlwZSBdKCBtYXRjaCwgY3VyTG9vcCwgaW5wbGFjZSwgcmVzdWx0LCBub3QsIGlzWE1MRmlsdGVyICk7CgoJCQkJCWlmICggIW1hdGNoICkgewoJCQkJCQlhbnlGb3VuZCA9IGZvdW5kID0gdHJ1ZTsKCgkJCQkJfSBlbHNlIGlmICggbWF0Y2ggPT09IHRydWUgKSB7CgkJCQkJCWNvbnRpbnVlOwoJCQkJCX0KCQkJCX0KCgkJCQlpZiAoIG1hdGNoICkgewoJCQkJCWZvciAoIHZhciBpID0gMDsgKGl0ZW0gPSBjdXJMb29wW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCQkJCWlmICggaXRlbSApIHsKCQkJCQkJCWZvdW5kID0gZmlsdGVyKCBpdGVtLCBtYXRjaCwgaSwgY3VyTG9vcCApOwoJCQkJCQkJdmFyIHBhc3MgPSBub3QgXiAhIWZvdW5kOwoKCQkJCQkJCWlmICggaW5wbGFjZSAmJiBmb3VuZCAhPSBudWxsICkgewoJCQkJCQkJCWlmICggcGFzcyApIHsKCQkJCQkJCQkJYW55Rm91bmQgPSB0cnVlOwoKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQljdXJMb29wW2ldID0gZmFsc2U7CgkJCQkJCQkJfQoKCQkJCQkJCX0gZWxzZSBpZiAoIHBhc3MgKSB7CgkJCQkJCQkJcmVzdWx0LnB1c2goIGl0ZW0gKTsKCQkJCQkJCQlhbnlGb3VuZCA9IHRydWU7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJaWYgKCBmb3VuZCAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWlmICggIWlucGxhY2UgKSB7CgkJCQkJCWN1ckxvb3AgPSByZXN1bHQ7CgkJCQkJfQoKCQkJCQlleHByID0gZXhwci5yZXBsYWNlKCBFeHByLm1hdGNoWyB0eXBlIF0sICIiICk7CgoJCQkJCWlmICggIWFueUZvdW5kICkgewoJCQkJCQlyZXR1cm4gW107CgkJCQkJfQoKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gSW1wcm9wZXIgZXhwcmVzc2lvbgoJCWlmICggZXhwciA9PT0gb2xkICkgewoJCQlpZiAoIGFueUZvdW5kID09IG51bGwgKSB7CgkJCQlTaXp6bGUuZXJyb3IoIGV4cHIgKTsKCgkJCX0gZWxzZSB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJb2xkID0gZXhwcjsKCX0KCglyZXR1cm4gY3VyTG9vcDsKfTsKClNpenpsZS5lcnJvciA9IGZ1bmN0aW9uKCBtc2cgKSB7Cgl0aHJvdyAiU3ludGF4IGVycm9yLCB1bnJlY29nbml6ZWQgZXhwcmVzc2lvbjogIiArIG1zZzsKfTsKCnZhciBFeHByID0gU2l6emxlLnNlbGVjdG9ycyA9IHsKCW9yZGVyOiBbICJJRCIsICJOQU1FIiwgIlRBRyIgXSwKCgltYXRjaDogewoJCUlEOiAvIygoPzpbXHdcdTAwYzAtXHVGRkZGXC1dfFxcLikrKS8sCgkJQ0xBU1M6IC9cLigoPzpbXHdcdTAwYzAtXHVGRkZGXC1dfFxcLikrKS8sCgkJTkFNRTogL1xbbmFtZT1bJyJdKigoPzpbXHdcdTAwYzAtXHVGRkZGXC1dfFxcLikrKVsnIl0qXF0vLAoJCUFUVFI6IC9cW1xzKigoPzpbXHdcdTAwYzAtXHVGRkZGXC1dfFxcLikrKVxzKig/OihcUz89KVxzKig/OihbJyJdKSguKj8pXDN8KCM/KD86W1x3XHUwMGMwLVx1RkZGRlwtXXxcXC4pKil8KXwpXHMqXF0vLAoJCVRBRzogL14oKD86W1x3XHUwMGMwLVx1RkZGRlwqXC1dfFxcLikrKS8sCgkJQ0hJTEQ6IC86KG9ubHl8bnRofGxhc3R8Zmlyc3QpLWNoaWxkKD86XChccyooZXZlbnxvZGR8KD86WytcLV0/XGQrfCg/OlsrXC1dP1xkKik/blxzKig/OlsrXC1dXHMqXGQrKT8pKVxzKlwpKT8vLAoJCVBPUzogLzoobnRofGVxfGd0fGx0fGZpcnN0fGxhc3R8ZXZlbnxvZGQpKD86XCgoXGQqKVwpKT8oPz1bXlwtXXwkKS8sCgkJUFNFVURPOiAvOigoPzpbXHdcdTAwYzAtXHVGRkZGXC1dfFxcLikrKSg/OlwoKFsnIl0/KSgoPzpcKFteXCldK1wpfFteXChcKV0qKSspXDJcKSk/LwoJfSwKCglsZWZ0TWF0Y2g6IHt9LAoKCWF0dHJNYXA6IHsKCQkiY2xhc3MiOiAiY2xhc3NOYW1lIiwKCQkiZm9yIjogImh0bWxGb3IiCgl9LAoKCWF0dHJIYW5kbGU6IHsKCQlocmVmOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCAiaHJlZiIgKTsKCQl9LAoJCXR5cGU6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoICJ0eXBlIiApOwoJCX0KCX0sCgoJcmVsYXRpdmU6IHsKCQkiKyI6IGZ1bmN0aW9uKGNoZWNrU2V0LCBwYXJ0KXsKCQkJdmFyIGlzUGFydFN0ciA9IHR5cGVvZiBwYXJ0ID09PSAic3RyaW5nIiwKCQkJCWlzVGFnID0gaXNQYXJ0U3RyICYmICFyTm9uV29yZC50ZXN0KCBwYXJ0ICksCgkJCQlpc1BhcnRTdHJOb3RUYWcgPSBpc1BhcnRTdHIgJiYgIWlzVGFnOwoKCQkJaWYgKCBpc1RhZyApIHsKCQkJCXBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCWZvciAoIHZhciBpID0gMCwgbCA9IGNoZWNrU2V0Lmxlbmd0aCwgZWxlbTsgaSA8IGw7IGkrKyApIHsKCQkJCWlmICggKGVsZW0gPSBjaGVja1NldFtpXSkgKSB7CgkJCQkJd2hpbGUgKCAoZWxlbSA9IGVsZW0ucHJldmlvdXNTaWJsaW5nKSAmJiBlbGVtLm5vZGVUeXBlICE9PSAxICkge30KCgkJCQkJY2hlY2tTZXRbaV0gPSBpc1BhcnRTdHJOb3RUYWcgfHwgZWxlbSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IHBhcnQgPwoJCQkJCQllbGVtIHx8IGZhbHNlIDoKCQkJCQkJZWxlbSA9PT0gcGFydDsKCQkJCX0KCQkJfQoKCQkJaWYgKCBpc1BhcnRTdHJOb3RUYWcgKSB7CgkJCQlTaXp6bGUuZmlsdGVyKCBwYXJ0LCBjaGVja1NldCwgdHJ1ZSApOwoJCQl9CgkJfSwKCgkJIj4iOiBmdW5jdGlvbiggY2hlY2tTZXQsIHBhcnQgKSB7CgkJCXZhciBlbGVtLAoJCQkJaXNQYXJ0U3RyID0gdHlwZW9mIHBhcnQgPT09ICJzdHJpbmciLAoJCQkJaSA9IDAsCgkJCQlsID0gY2hlY2tTZXQubGVuZ3RoOwoKCQkJaWYgKCBpc1BhcnRTdHIgJiYgIXJOb25Xb3JkLnRlc3QoIHBhcnQgKSApIHsKCQkJCXBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CgoJCQkJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCQkJCWVsZW0gPSBjaGVja1NldFtpXTsKCgkJCQkJaWYgKCBlbGVtICkgewoJCQkJCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoJCQkJCQljaGVja1NldFtpXSA9IHBhcmVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBwYXJ0ID8gcGFyZW50IDogZmFsc2U7CgkJCQkJfQoJCQkJfQoKCQkJfSBlbHNlIHsKCQkJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJCQllbGVtID0gY2hlY2tTZXRbaV07CgoJCQkJCWlmICggZWxlbSApIHsKCQkJCQkJY2hlY2tTZXRbaV0gPSBpc1BhcnRTdHIgPwoJCQkJCQkJZWxlbS5wYXJlbnROb2RlIDoKCQkJCQkJCWVsZW0ucGFyZW50Tm9kZSA9PT0gcGFydDsKCQkJCQl9CgkJCQl9CgoJCQkJaWYgKCBpc1BhcnRTdHIgKSB7CgkJCQkJU2l6emxlLmZpbHRlciggcGFydCwgY2hlY2tTZXQsIHRydWUgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCSIiOiBmdW5jdGlvbihjaGVja1NldCwgcGFydCwgaXNYTUwpewoJCQl2YXIgbm9kZUNoZWNrLAoJCQkJZG9uZU5hbWUgPSBkb25lKyssCgkJCQljaGVja0ZuID0gZGlyQ2hlY2s7CgoJCQlpZiAoIHR5cGVvZiBwYXJ0ID09PSAic3RyaW5nIiAmJiAhck5vbldvcmQudGVzdCggcGFydCApICkgewoJCQkJcGFydCA9IHBhcnQudG9Mb3dlckNhc2UoKTsKCQkJCW5vZGVDaGVjayA9IHBhcnQ7CgkJCQljaGVja0ZuID0gZGlyTm9kZUNoZWNrOwoJCQl9CgoJCQljaGVja0ZuKCAicGFyZW50Tm9kZSIsIHBhcnQsIGRvbmVOYW1lLCBjaGVja1NldCwgbm9kZUNoZWNrLCBpc1hNTCApOwoJCX0sCgoJCSJ+IjogZnVuY3Rpb24oIGNoZWNrU2V0LCBwYXJ0LCBpc1hNTCApIHsKCQkJdmFyIG5vZGVDaGVjaywKCQkJCWRvbmVOYW1lID0gZG9uZSsrLAoJCQkJY2hlY2tGbiA9IGRpckNoZWNrOwoKCQkJaWYgKCB0eXBlb2YgcGFydCA9PT0gInN0cmluZyIgJiYgIXJOb25Xb3JkLnRlc3QoIHBhcnQgKSApIHsKCQkJCXBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CgkJCQlub2RlQ2hlY2sgPSBwYXJ0OwoJCQkJY2hlY2tGbiA9IGRpck5vZGVDaGVjazsKCQkJfQoKCQkJY2hlY2tGbiggInByZXZpb3VzU2libGluZyIsIHBhcnQsIGRvbmVOYW1lLCBjaGVja1NldCwgbm9kZUNoZWNrLCBpc1hNTCApOwoJCX0KCX0sCgoJZmluZDogewoJCUlEOiBmdW5jdGlvbiggbWF0Y2gsIGNvbnRleHQsIGlzWE1MICkgewoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSAidW5kZWZpbmVkIiAmJiAhaXNYTUwgKSB7CgkJCQl2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQobWF0Y2hbMV0pOwoJCQkJLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCXJldHVybiBtICYmIG0ucGFyZW50Tm9kZSA/IFttXSA6IFtdOwoJCQl9CgkJfSwKCgkJTkFNRTogZnVuY3Rpb24oIG1hdGNoLCBjb250ZXh0ICkgewoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlOYW1lICE9PSAidW5kZWZpbmVkIiApIHsKCQkJCXZhciByZXQgPSBbXSwKCQkJCQlyZXN1bHRzID0gY29udGV4dC5nZXRFbGVtZW50c0J5TmFtZSggbWF0Y2hbMV0gKTsKCgkJCQlmb3IgKCB2YXIgaSA9IDAsIGwgPSByZXN1bHRzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCQlpZiAoIHJlc3VsdHNbaV0uZ2V0QXR0cmlidXRlKCJuYW1lIikgPT09IG1hdGNoWzFdICkgewoJCQkJCQlyZXQucHVzaCggcmVzdWx0c1tpXSApOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gcmV0Lmxlbmd0aCA9PT0gMCA/IG51bGwgOiByZXQ7CgkJCX0KCQl9LAoKCQlUQUc6IGZ1bmN0aW9uKCBtYXRjaCwgY29udGV4dCApIHsKCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCQlyZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggbWF0Y2hbMV0gKTsKCQkJfQoJCX0KCX0sCglwcmVGaWx0ZXI6IHsKCQlDTEFTUzogZnVuY3Rpb24oIG1hdGNoLCBjdXJMb29wLCBpbnBsYWNlLCByZXN1bHQsIG5vdCwgaXNYTUwgKSB7CgkJCW1hdGNoID0gIiAiICsgbWF0Y2hbMV0ucmVwbGFjZSggckJhY2tzbGFzaCwgIiIgKSArICIgIjsKCgkJCWlmICggaXNYTUwgKSB7CgkJCQlyZXR1cm4gbWF0Y2g7CgkJCX0KCgkJCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBjdXJMb29wW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCQlpZiAoIGVsZW0gKSB7CgkJCQkJaWYgKCBub3QgXiAoZWxlbS5jbGFzc05hbWUgJiYgKCIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKC9bXHRcblxyXS9nLCAiICIpLmluZGV4T2YobWF0Y2gpID49IDApICkgewoJCQkJCQlpZiAoICFpbnBsYWNlICkgewoJCQkJCQkJcmVzdWx0LnB1c2goIGVsZW0gKTsKCQkJCQkJfQoKCQkJCQl9IGVsc2UgaWYgKCBpbnBsYWNlICkgewoJCQkJCQljdXJMb29wW2ldID0gZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCgkJSUQ6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJcmV0dXJuIG1hdGNoWzFdLnJlcGxhY2UoIHJCYWNrc2xhc2gsICIiICk7CgkJfSwKCgkJVEFHOiBmdW5jdGlvbiggbWF0Y2gsIGN1ckxvb3AgKSB7CgkJCXJldHVybiBtYXRjaFsxXS5yZXBsYWNlKCByQmFja3NsYXNoLCAiIiApLnRvTG93ZXJDYXNlKCk7CgkJfSwKCgkJQ0hJTEQ6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJaWYgKCBtYXRjaFsxXSA9PT0gIm50aCIgKSB7CgkJCQlpZiAoICFtYXRjaFsyXSApIHsKCQkJCQlTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7CgkJCQl9CgoJCQkJbWF0Y2hbMl0gPSBtYXRjaFsyXS5yZXBsYWNlKC9eXCt8XHMqL2csICcnKTsKCgkJCQkvLyBwYXJzZSBlcXVhdGlvbnMgbGlrZSAnZXZlbicsICdvZGQnLCAnNScsICcybicsICczbisyJywgJzRuLTEnLCAnLW4rNicKCQkJCXZhciB0ZXN0ID0gLygtPykoXGQqKSg/Om4oWytcLV0/XGQqKSk/Ly5leGVjKAoJCQkJCW1hdGNoWzJdID09PSAiZXZlbiIgJiYgIjJuIiB8fCBtYXRjaFsyXSA9PT0gIm9kZCIgJiYgIjJuKzEiIHx8CgkJCQkJIS9cRC8udGVzdCggbWF0Y2hbMl0gKSAmJiAiMG4rIiArIG1hdGNoWzJdIHx8IG1hdGNoWzJdKTsKCgkJCQkvLyBjYWxjdWxhdGUgdGhlIG51bWJlcnMgKGZpcnN0KW4rKGxhc3QpIGluY2x1ZGluZyBpZiB0aGV5IGFyZSBuZWdhdGl2ZQoJCQkJbWF0Y2hbMl0gPSAodGVzdFsxXSArICh0ZXN0WzJdIHx8IDEpKSAtIDA7CgkJCQltYXRjaFszXSA9IHRlc3RbM10gLSAwOwoJCQl9CgkJCWVsc2UgaWYgKCBtYXRjaFsyXSApIHsKCQkJCVNpenpsZS5lcnJvciggbWF0Y2hbMF0gKTsKCQkJfQoKCQkJLy8gVE9ETzogTW92ZSB0byBub3JtYWwgY2FjaGluZyBzeXN0ZW0KCQkJbWF0Y2hbMF0gPSBkb25lKys7CgoJCQlyZXR1cm4gbWF0Y2g7CgkJfSwKCgkJQVRUUjogZnVuY3Rpb24oIG1hdGNoLCBjdXJMb29wLCBpbnBsYWNlLCByZXN1bHQsIG5vdCwgaXNYTUwgKSB7CgkJCXZhciBuYW1lID0gbWF0Y2hbMV0gPSBtYXRjaFsxXS5yZXBsYWNlKCByQmFja3NsYXNoLCAiIiApOwoJCQkKCQkJaWYgKCAhaXNYTUwgJiYgRXhwci5hdHRyTWFwW25hbWVdICkgewoJCQkJbWF0Y2hbMV0gPSBFeHByLmF0dHJNYXBbbmFtZV07CgkJCX0KCgkJCS8vIEhhbmRsZSBpZiBhbiB1bi1xdW90ZWQgdmFsdWUgd2FzIHVzZWQKCQkJbWF0Y2hbNF0gPSAoIG1hdGNoWzRdIHx8IG1hdGNoWzVdIHx8ICIiICkucmVwbGFjZSggckJhY2tzbGFzaCwgIiIgKTsKCgkJCWlmICggbWF0Y2hbMl0gPT09ICJ+PSIgKSB7CgkJCQltYXRjaFs0XSA9ICIgIiArIG1hdGNoWzRdICsgIiAiOwoJCQl9CgoJCQlyZXR1cm4gbWF0Y2g7CgkJfSwKCgkJUFNFVURPOiBmdW5jdGlvbiggbWF0Y2gsIGN1ckxvb3AsIGlucGxhY2UsIHJlc3VsdCwgbm90ICkgewoJCQlpZiAoIG1hdGNoWzFdID09PSAibm90IiApIHsKCQkJCS8vIElmIHdlJ3JlIGRlYWxpbmcgd2l0aCBhIGNvbXBsZXggZXhwcmVzc2lvbiwgb3IgYSBzaW1wbGUgb25lCgkJCQlpZiAoICggY2h1bmtlci5leGVjKG1hdGNoWzNdKSB8fCAiIiApLmxlbmd0aCA+IDEgfHwgL15cdy8udGVzdChtYXRjaFszXSkgKSB7CgkJCQkJbWF0Y2hbM10gPSBTaXp6bGUobWF0Y2hbM10sIG51bGwsIG51bGwsIGN1ckxvb3ApOwoKCQkJCX0gZWxzZSB7CgkJCQkJdmFyIHJldCA9IFNpenpsZS5maWx0ZXIobWF0Y2hbM10sIGN1ckxvb3AsIGlucGxhY2UsIHRydWUgXiBub3QpOwoKCQkJCQlpZiAoICFpbnBsYWNlICkgewoJCQkJCQlyZXN1bHQucHVzaC5hcHBseSggcmVzdWx0LCByZXQgKTsKCQkJCQl9CgoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCX0gZWxzZSBpZiAoIEV4cHIubWF0Y2guUE9TLnRlc3QoIG1hdGNoWzBdICkgfHwgRXhwci5tYXRjaC5DSElMRC50ZXN0KCBtYXRjaFswXSApICkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQkJCgkJCXJldHVybiBtYXRjaDsKCQl9LAoKCQlQT1M6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJbWF0Y2gudW5zaGlmdCggdHJ1ZSApOwoKCQkJcmV0dXJuIG1hdGNoOwoJCX0KCX0sCgkKCWZpbHRlcnM6IHsKCQllbmFibGVkOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IGZhbHNlICYmIGVsZW0udHlwZSAhPT0gImhpZGRlbiI7CgkJfSwKCgkJZGlzYWJsZWQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gdHJ1ZTsKCQl9LAoKCQljaGVja2VkOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uY2hlY2tlZCA9PT0gdHJ1ZTsKCQl9LAoJCQoJCXNlbGVjdGVkOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gQWNjZXNzaW5nIHRoaXMgcHJvcGVydHkgbWFrZXMgc2VsZWN0ZWQtYnktZGVmYXVsdAoJCQkvLyBvcHRpb25zIGluIFNhZmFyaSB3b3JrIHByb3Blcmx5CgkJCWlmICggZWxlbS5wYXJlbnROb2RlICkgewoJCQkJZWxlbS5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CgkJCX0KCQkJCgkJCXJldHVybiBlbGVtLnNlbGVjdGVkID09PSB0cnVlOwoJCX0sCgoJCXBhcmVudDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiAhIWVsZW0uZmlyc3RDaGlsZDsKCQl9LAoKCQllbXB0eTogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiAhZWxlbS5maXJzdENoaWxkOwoJCX0sCgoJCWhhczogZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gISFTaXp6bGUoIG1hdGNoWzNdLCBlbGVtICkubGVuZ3RoOwoJCX0sCgoJCWhlYWRlcjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiAoL2hcZC9pKS50ZXN0KCBlbGVtLm5vZGVOYW1lICk7CgkJfSwKCgkJdGV4dDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBhdHRyID0gZWxlbS5nZXRBdHRyaWJ1dGUoICJ0eXBlIiApLCB0eXBlID0gZWxlbS50eXBlOwoJCQkvLyBJRTYgYW5kIDcgd2lsbCBtYXAgZWxlbS50eXBlIHRvICd0ZXh0JyBmb3IgbmV3IEhUTUw1IHR5cGVzIChzZWFyY2gsIGV0YykgCgkJCS8vIHVzZSBnZXRBdHRyaWJ1dGUgaW5zdGVhZCB0byB0ZXN0IHRoaXMgY2FzZQoJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICJ0ZXh0IiA9PT0gdHlwZSAmJiAoIGF0dHIgPT09IHR5cGUgfHwgYXR0ciA9PT0gbnVsbCApOwoJCX0sCgoJCXJhZGlvOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAicmFkaW8iID09PSBlbGVtLnR5cGU7CgkJfSwKCgkJY2hlY2tib3g6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICJjaGVja2JveCIgPT09IGVsZW0udHlwZTsKCQl9LAoKCQlmaWxlOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAiZmlsZSIgPT09IGVsZW0udHlwZTsKCQl9LAoKCQlwYXNzd29yZDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgInBhc3N3b3JkIiA9PT0gZWxlbS50eXBlOwoJCX0sCgoJCXN1Ym1pdDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gKG5hbWUgPT09ICJpbnB1dCIgfHwgbmFtZSA9PT0gImJ1dHRvbiIpICYmICJzdWJtaXQiID09PSBlbGVtLnR5cGU7CgkJfSwKCgkJaW1hZ2U6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICJpbWFnZSIgPT09IGVsZW0udHlwZTsKCQl9LAoKCQlyZXNldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gKG5hbWUgPT09ICJpbnB1dCIgfHwgbmFtZSA9PT0gImJ1dHRvbiIpICYmICJyZXNldCIgPT09IGVsZW0udHlwZTsKCQl9LAoKCQlidXR0b246IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIG5hbWUgPT09ICJpbnB1dCIgJiYgImJ1dHRvbiIgPT09IGVsZW0udHlwZSB8fCBuYW1lID09PSAiYnV0dG9uIjsKCQl9LAoKCQlpbnB1dDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiAoL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24vaSkudGVzdCggZWxlbS5ub2RlTmFtZSApOwoJCX0sCgoJCWZvY3VzOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0gPT09IGVsZW0ub3duZXJEb2N1bWVudC5hY3RpdmVFbGVtZW50OwoJCX0KCX0sCglzZXRGaWx0ZXJzOiB7CgkJZmlyc3Q6IGZ1bmN0aW9uKCBlbGVtLCBpICkgewoJCQlyZXR1cm4gaSA9PT0gMDsKCQl9LAoKCQlsYXN0OiBmdW5jdGlvbiggZWxlbSwgaSwgbWF0Y2gsIGFycmF5ICkgewoJCQlyZXR1cm4gaSA9PT0gYXJyYXkubGVuZ3RoIC0gMTsKCQl9LAoKCQlldmVuOiBmdW5jdGlvbiggZWxlbSwgaSApIHsKCQkJcmV0dXJuIGkgJSAyID09PSAwOwoJCX0sCgoJCW9kZDogZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiBpICUgMiA9PT0gMTsKCQl9LAoKCQlsdDogZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gaSA8IG1hdGNoWzNdIC0gMDsKCQl9LAoKCQlndDogZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gaSA+IG1hdGNoWzNdIC0gMDsKCQl9LAoKCQludGg6IGZ1bmN0aW9uKCBlbGVtLCBpLCBtYXRjaCApIHsKCQkJcmV0dXJuIG1hdGNoWzNdIC0gMCA9PT0gaTsKCQl9LAoKCQllcTogZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gbWF0Y2hbM10gLSAwID09PSBpOwoJCX0KCX0sCglmaWx0ZXI6IHsKCQlQU0VVRE86IGZ1bmN0aW9uKCBlbGVtLCBtYXRjaCwgaSwgYXJyYXkgKSB7CgkJCXZhciBuYW1lID0gbWF0Y2hbMV0sCgkJCQlmaWx0ZXIgPSBFeHByLmZpbHRlcnNbIG5hbWUgXTsKCgkJCWlmICggZmlsdGVyICkgewoJCQkJcmV0dXJuIGZpbHRlciggZWxlbSwgaSwgbWF0Y2gsIGFycmF5ICk7CgoJCQl9IGVsc2UgaWYgKCBuYW1lID09PSAiY29udGFpbnMiICkgewoJCQkJcmV0dXJuIChlbGVtLnRleHRDb250ZW50IHx8IGVsZW0uaW5uZXJUZXh0IHx8IFNpenpsZS5nZXRUZXh0KFsgZWxlbSBdKSB8fCAiIikuaW5kZXhPZihtYXRjaFszXSkgPj0gMDsKCgkJCX0gZWxzZSBpZiAoIG5hbWUgPT09ICJub3QiICkgewoJCQkJdmFyIG5vdCA9IG1hdGNoWzNdOwoKCQkJCWZvciAoIHZhciBqID0gMCwgbCA9IG5vdC5sZW5ndGg7IGogPCBsOyBqKysgKSB7CgkJCQkJaWYgKCBub3Rbal0gPT09IGVsZW0gKSB7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuIHRydWU7CgoJCQl9IGVsc2UgewoJCQkJU2l6emxlLmVycm9yKCBuYW1lICk7CgkJCX0KCQl9LAoKCQlDSElMRDogZnVuY3Rpb24oIGVsZW0sIG1hdGNoICkgewoJCQl2YXIgdHlwZSA9IG1hdGNoWzFdLAoJCQkJbm9kZSA9IGVsZW07CgoJCQlzd2l0Y2ggKCB0eXBlICkgewoJCQkJY2FzZSAib25seSI6CgkJCQljYXNlICJmaXJzdCI6CgkJCQkJd2hpbGUgKCAobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSApCSB7CgkJCQkJCWlmICggbm9kZS5ub2RlVHlwZSA9PT0gMSApIHsgCgkJCQkJCQlyZXR1cm4gZmFsc2U7IAoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoIHR5cGUgPT09ICJmaXJzdCIgKSB7IAoJCQkJCQlyZXR1cm4gdHJ1ZTsgCgkJCQkJfQoKCQkJCQlub2RlID0gZWxlbTsKCgkJCQljYXNlICJsYXN0IjoKCQkJCQl3aGlsZSAoIChub2RlID0gbm9kZS5uZXh0U2libGluZykgKQkgewoJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgKSB7IAoJCQkJCQkJcmV0dXJuIGZhbHNlOyAKCQkJCQkJfQoJCQkJCX0KCgkJCQkJcmV0dXJuIHRydWU7CgoJCQkJY2FzZSAibnRoIjoKCQkJCQl2YXIgZmlyc3QgPSBtYXRjaFsyXSwKCQkJCQkJbGFzdCA9IG1hdGNoWzNdOwoKCQkJCQlpZiAoIGZpcnN0ID09PSAxICYmIGxhc3QgPT09IDAgKSB7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0KCQkJCQkKCQkJCQl2YXIgZG9uZU5hbWUgPSBtYXRjaFswXSwKCQkJCQkJcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoJCgkJCQkJaWYgKCBwYXJlbnQgJiYgKHBhcmVudC5zaXpjYWNoZSAhPT0gZG9uZU5hbWUgfHwgIWVsZW0ubm9kZUluZGV4KSApIHsKCQkJCQkJdmFyIGNvdW50ID0gMDsKCQkJCQkJCgkJCQkJCWZvciAoIG5vZGUgPSBwYXJlbnQuZmlyc3RDaGlsZDsgbm9kZTsgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmcgKSB7CgkJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCQkJbm9kZS5ub2RlSW5kZXggPSArK2NvdW50OwoJCQkJCQkJfQoJCQkJCQl9IAoKCQkJCQkJcGFyZW50LnNpemNhY2hlID0gZG9uZU5hbWU7CgkJCQkJfQoJCQkJCQoJCQkJCXZhciBkaWZmID0gZWxlbS5ub2RlSW5kZXggLSBsYXN0OwoKCQkJCQlpZiAoIGZpcnN0ID09PSAwICkgewoJCQkJCQlyZXR1cm4gZGlmZiA9PT0gMDsKCgkJCQkJfSBlbHNlIHsKCQkJCQkJcmV0dXJuICggZGlmZiAlIGZpcnN0ID09PSAwICYmIGRpZmYgLyBmaXJzdCA+PSAwICk7CgkJCQkJfQoJCQl9CgkJfSwKCgkJSUQ6IGZ1bmN0aW9uKCBlbGVtLCBtYXRjaCApIHsKCQkJcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImlkIikgPT09IG1hdGNoOwoJCX0sCgoJCVRBRzogZnVuY3Rpb24oIGVsZW0sIG1hdGNoICkgewoJCQlyZXR1cm4gKG1hdGNoID09PSAiKiIgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgfHwgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBtYXRjaDsKCQl9LAoJCQoJCUNMQVNTOiBmdW5jdGlvbiggZWxlbSwgbWF0Y2ggKSB7CgkJCXJldHVybiAoIiAiICsgKGVsZW0uY2xhc3NOYW1lIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCJjbGFzcyIpKSArICIgIikKCQkJCS5pbmRleE9mKCBtYXRjaCApID4gLTE7CgkJfSwKCgkJQVRUUjogZnVuY3Rpb24oIGVsZW0sIG1hdGNoICkgewoJCQl2YXIgbmFtZSA9IG1hdGNoWzFdLAoJCQkJcmVzdWx0ID0gRXhwci5hdHRySGFuZGxlWyBuYW1lIF0gPwoJCQkJCUV4cHIuYXR0ckhhbmRsZVsgbmFtZSBdKCBlbGVtICkgOgoJCQkJCWVsZW1bIG5hbWUgXSAhPSBudWxsID8KCQkJCQkJZWxlbVsgbmFtZSBdIDoKCQkJCQkJZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKSwKCQkJCXZhbHVlID0gcmVzdWx0ICsgIiIsCgkJCQl0eXBlID0gbWF0Y2hbMl0sCgkJCQljaGVjayA9IG1hdGNoWzRdOwoKCQkJcmV0dXJuIHJlc3VsdCA9PSBudWxsID8KCQkJCXR5cGUgPT09ICIhPSIgOgoJCQkJdHlwZSA9PT0gIj0iID8KCQkJCXZhbHVlID09PSBjaGVjayA6CgkJCQl0eXBlID09PSAiKj0iID8KCQkJCXZhbHVlLmluZGV4T2YoY2hlY2spID49IDAgOgoJCQkJdHlwZSA9PT0gIn49IiA/CgkJCQkoIiAiICsgdmFsdWUgKyAiICIpLmluZGV4T2YoY2hlY2spID49IDAgOgoJCQkJIWNoZWNrID8KCQkJCXZhbHVlICYmIHJlc3VsdCAhPT0gZmFsc2UgOgoJCQkJdHlwZSA9PT0gIiE9IiA/CgkJCQl2YWx1ZSAhPT0gY2hlY2sgOgoJCQkJdHlwZSA9PT0gIl49IiA/CgkJCQl2YWx1ZS5pbmRleE9mKGNoZWNrKSA9PT0gMCA6CgkJCQl0eXBlID09PSAiJD0iID8KCQkJCXZhbHVlLnN1YnN0cih2YWx1ZS5sZW5ndGggLSBjaGVjay5sZW5ndGgpID09PSBjaGVjayA6CgkJCQl0eXBlID09PSAifD0iID8KCQkJCXZhbHVlID09PSBjaGVjayB8fCB2YWx1ZS5zdWJzdHIoMCwgY2hlY2subGVuZ3RoICsgMSkgPT09IGNoZWNrICsgIi0iIDoKCQkJCWZhbHNlOwoJCX0sCgoJCVBPUzogZnVuY3Rpb24oIGVsZW0sIG1hdGNoLCBpLCBhcnJheSApIHsKCQkJdmFyIG5hbWUgPSBtYXRjaFsyXSwKCQkJCWZpbHRlciA9IEV4cHIuc2V0RmlsdGVyc1sgbmFtZSBdOwoKCQkJaWYgKCBmaWx0ZXIgKSB7CgkJCQlyZXR1cm4gZmlsdGVyKCBlbGVtLCBpLCBtYXRjaCwgYXJyYXkgKTsKCQkJfQoJCX0KCX0KfTsKCnZhciBvcmlnUE9TID0gRXhwci5tYXRjaC5QT1MsCglmZXNjYXBlID0gZnVuY3Rpb24oYWxsLCBudW0pewoJCXJldHVybiAiXFwiICsgKG51bSAtIDAgKyAxKTsKCX07Cgpmb3IgKCB2YXIgdHlwZSBpbiBFeHByLm1hdGNoICkgewoJRXhwci5tYXRjaFsgdHlwZSBdID0gbmV3IFJlZ0V4cCggRXhwci5tYXRjaFsgdHlwZSBdLnNvdXJjZSArICgvKD8hW15cW10qXF0pKD8hW15cKF0qXCkpLy5zb3VyY2UpICk7CglFeHByLmxlZnRNYXRjaFsgdHlwZSBdID0gbmV3IFJlZ0V4cCggLyheKD86LnxccnxcbikqPykvLnNvdXJjZSArIEV4cHIubWF0Y2hbIHR5cGUgXS5zb3VyY2UucmVwbGFjZSgvXFwoXGQrKS9nLCBmZXNjYXBlKSApOwp9Cgp2YXIgbWFrZUFycmF5ID0gZnVuY3Rpb24oIGFycmF5LCByZXN1bHRzICkgewoJYXJyYXkgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCggYXJyYXksIDAgKTsKCglpZiAoIHJlc3VsdHMgKSB7CgkJcmVzdWx0cy5wdXNoLmFwcGx5KCByZXN1bHRzLCBhcnJheSApOwoJCXJldHVybiByZXN1bHRzOwoJfQoJCglyZXR1cm4gYXJyYXk7Cn07CgovLyBQZXJmb3JtIGEgc2ltcGxlIGNoZWNrIHRvIGRldGVybWluZSBpZiB0aGUgYnJvd3NlciBpcyBjYXBhYmxlIG9mCi8vIGNvbnZlcnRpbmcgYSBOb2RlTGlzdCB0byBhbiBhcnJheSB1c2luZyBidWlsdGluIG1ldGhvZHMuCi8vIEFsc28gdmVyaWZpZXMgdGhhdCB0aGUgcmV0dXJuZWQgYXJyYXkgaG9sZHMgRE9NIG5vZGVzCi8vICh3aGljaCBpcyBub3QgdGhlIGNhc2UgaW4gdGhlIEJsYWNrYmVycnkgYnJvd3NlcikKdHJ5IHsKCUFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2hpbGROb2RlcywgMCApWzBdLm5vZGVUeXBlOwoKLy8gUHJvdmlkZSBhIGZhbGxiYWNrIG1ldGhvZCBpZiBpdCBkb2VzIG5vdCB3b3JrCn0gY2F0Y2goIGUgKSB7CgltYWtlQXJyYXkgPSBmdW5jdGlvbiggYXJyYXksIHJlc3VsdHMgKSB7CgkJdmFyIGkgPSAwLAoJCQlyZXQgPSByZXN1bHRzIHx8IFtdOwoKCQlpZiAoIHRvU3RyaW5nLmNhbGwoYXJyYXkpID09PSAiW29iamVjdCBBcnJheV0iICkgewoJCQlBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseSggcmV0LCBhcnJheSApOwoKCQl9IGVsc2UgewoJCQlpZiAoIHR5cGVvZiBhcnJheS5sZW5ndGggPT09ICJudW1iZXIiICkgewoJCQkJZm9yICggdmFyIGwgPSBhcnJheS5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQkJcmV0LnB1c2goIGFycmF5W2ldICk7CgkJCQl9CgoJCQl9IGVsc2UgewoJCQkJZm9yICggOyBhcnJheVtpXTsgaSsrICkgewoJCQkJCXJldC5wdXNoKCBhcnJheVtpXSApOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfTsKfQoKdmFyIHNvcnRPcmRlciwgc2libGluZ0NoZWNrOwoKaWYgKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY29tcGFyZURvY3VtZW50UG9zaXRpb24gKSB7Cglzb3J0T3JkZXIgPSBmdW5jdGlvbiggYSwgYiApIHsKCQlpZiAoIGEgPT09IGIgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJCXJldHVybiAwOwoJCX0KCgkJaWYgKCAhYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiB8fCAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiApIHsKCQkJcmV0dXJuIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gPyAtMSA6IDE7CgkJfQoKCQlyZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSAmIDQgPyAtMSA6IDE7Cgl9OwoKfSBlbHNlIHsKCXNvcnRPcmRlciA9IGZ1bmN0aW9uKCBhLCBiICkgewoJCS8vIFRoZSBub2RlcyBhcmUgaWRlbnRpY2FsLCB3ZSBjYW4gZXhpdCBlYXJseQoJCWlmICggYSA9PT0gYiApIHsKCQkJaGFzRHVwbGljYXRlID0gdHJ1ZTsKCQkJcmV0dXJuIDA7CgoJCS8vIEZhbGxiYWNrIHRvIHVzaW5nIHNvdXJjZUluZGV4IChpbiBJRSkgaWYgaXQncyBhdmFpbGFibGUgb24gYm90aCBub2RlcwoJCX0gZWxzZSBpZiAoIGEuc291cmNlSW5kZXggJiYgYi5zb3VyY2VJbmRleCApIHsKCQkJcmV0dXJuIGEuc291cmNlSW5kZXggLSBiLnNvdXJjZUluZGV4OwoJCX0KCgkJdmFyIGFsLCBibCwKCQkJYXAgPSBbXSwKCQkJYnAgPSBbXSwKCQkJYXVwID0gYS5wYXJlbnROb2RlLAoJCQlidXAgPSBiLnBhcmVudE5vZGUsCgkJCWN1ciA9IGF1cDsKCgkJLy8gSWYgdGhlIG5vZGVzIGFyZSBzaWJsaW5ncyAob3IgaWRlbnRpY2FsKSB3ZSBjYW4gZG8gYSBxdWljayBjaGVjawoJCWlmICggYXVwID09PSBidXAgKSB7CgkJCXJldHVybiBzaWJsaW5nQ2hlY2soIGEsIGIgKTsKCgkJLy8gSWYgbm8gcGFyZW50cyB3ZXJlIGZvdW5kIHRoZW4gdGhlIG5vZGVzIGFyZSBkaXNjb25uZWN0ZWQKCQl9IGVsc2UgaWYgKCAhYXVwICkgewoJCQlyZXR1cm4gLTE7CgoJCX0gZWxzZSBpZiAoICFidXAgKSB7CgkJCXJldHVybiAxOwoJCX0KCgkJLy8gT3RoZXJ3aXNlIHRoZXkncmUgc29tZXdoZXJlIGVsc2UgaW4gdGhlIHRyZWUgc28gd2UgbmVlZAoJCS8vIHRvIGJ1aWxkIHVwIGEgZnVsbCBsaXN0IG9mIHRoZSBwYXJlbnROb2RlcyBmb3IgY29tcGFyaXNvbgoJCXdoaWxlICggY3VyICkgewoJCQlhcC51bnNoaWZ0KCBjdXIgKTsKCQkJY3VyID0gY3VyLnBhcmVudE5vZGU7CgkJfQoKCQljdXIgPSBidXA7CgoJCXdoaWxlICggY3VyICkgewoJCQlicC51bnNoaWZ0KCBjdXIgKTsKCQkJY3VyID0gY3VyLnBhcmVudE5vZGU7CgkJfQoKCQlhbCA9IGFwLmxlbmd0aDsKCQlibCA9IGJwLmxlbmd0aDsKCgkJLy8gU3RhcnQgd2Fsa2luZyBkb3duIHRoZSB0cmVlIGxvb2tpbmcgZm9yIGEgZGlzY3JlcGFuY3kKCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBhbCAmJiBpIDwgYmw7IGkrKyApIHsKCQkJaWYgKCBhcFtpXSAhPT0gYnBbaV0gKSB7CgkJCQlyZXR1cm4gc2libGluZ0NoZWNrKCBhcFtpXSwgYnBbaV0gKTsKCQkJfQoJCX0KCgkJLy8gV2UgZW5kZWQgc29tZXBsYWNlIHVwIHRoZSB0cmVlIHNvIGRvIGEgc2libGluZyBjaGVjawoJCXJldHVybiBpID09PSBhbCA/CgkJCXNpYmxpbmdDaGVjayggYSwgYnBbaV0sIC0xICkgOgoJCQlzaWJsaW5nQ2hlY2soIGFwW2ldLCBiLCAxICk7Cgl9OwoKCXNpYmxpbmdDaGVjayA9IGZ1bmN0aW9uKCBhLCBiLCByZXQgKSB7CgkJaWYgKCBhID09PSBiICkgewoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJdmFyIGN1ciA9IGEubmV4dFNpYmxpbmc7CgoJCXdoaWxlICggY3VyICkgewoJCQlpZiAoIGN1ciA9PT0gYiApIHsKCQkJCXJldHVybiAtMTsKCQkJfQoKCQkJY3VyID0gY3VyLm5leHRTaWJsaW5nOwoJCX0KCgkJcmV0dXJuIDE7Cgl9Owp9CgovLyBVdGlsaXR5IGZ1bmN0aW9uIGZvciByZXRyZWl2aW5nIHRoZSB0ZXh0IHZhbHVlIG9mIGFuIGFycmF5IG9mIERPTSBub2RlcwpTaXp6bGUuZ2V0VGV4dCA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCXZhciByZXQgPSAiIiwgZWxlbTsKCglmb3IgKCB2YXIgaSA9IDA7IGVsZW1zW2ldOyBpKysgKSB7CgkJZWxlbSA9IGVsZW1zW2ldOwoKCQkvLyBHZXQgdGhlIHRleHQgZnJvbSB0ZXh0IG5vZGVzIGFuZCBDREFUQSBub2RlcwoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA0ICkgewoJCQlyZXQgKz0gZWxlbS5ub2RlVmFsdWU7CgoJCS8vIFRyYXZlcnNlIGV2ZXJ5dGhpbmcgZWxzZSwgZXhjZXB0IGNvbW1lbnQgbm9kZXMKCQl9IGVsc2UgaWYgKCBlbGVtLm5vZGVUeXBlICE9PSA4ICkgewoJCQlyZXQgKz0gU2l6emxlLmdldFRleHQoIGVsZW0uY2hpbGROb2RlcyApOwoJCX0KCX0KCglyZXR1cm4gcmV0Owp9OwoKLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBicm93c2VyIHJldHVybnMgZWxlbWVudHMgYnkgbmFtZSB3aGVuCi8vIHF1ZXJ5aW5nIGJ5IGdldEVsZW1lbnRCeUlkIChhbmQgcHJvdmlkZSBhIHdvcmthcm91bmQpCihmdW5jdGlvbigpewoJLy8gV2UncmUgZ29pbmcgdG8gaW5qZWN0IGEgZmFrZSBpbnB1dCBlbGVtZW50IHdpdGggYSBzcGVjaWZpZWQgbmFtZQoJdmFyIGZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSwKCQlpZCA9ICJzY3JpcHQiICsgKG5ldyBEYXRlKCkpLmdldFRpbWUoKSwKCQlyb290ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCWZvcm0uaW5uZXJIVE1MID0gIjxhIG5hbWU9JyIgKyBpZCArICInLz4iOwoKCS8vIEluamVjdCBpdCBpbnRvIHRoZSByb290IGVsZW1lbnQsIGNoZWNrIGl0cyBzdGF0dXMsIGFuZCByZW1vdmUgaXQgcXVpY2tseQoJcm9vdC5pbnNlcnRCZWZvcmUoIGZvcm0sIHJvb3QuZmlyc3RDaGlsZCApOwoKCS8vIFRoZSB3b3JrYXJvdW5kIGhhcyB0byBkbyBhZGRpdGlvbmFsIGNoZWNrcyBhZnRlciBhIGdldEVsZW1lbnRCeUlkCgkvLyBXaGljaCBzbG93cyB0aGluZ3MgZG93biBmb3Igb3RoZXIgYnJvd3NlcnMgKGhlbmNlIHRoZSBicmFuY2hpbmcpCglpZiAoIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBpZCApICkgewoJCUV4cHIuZmluZC5JRCA9IGZ1bmN0aW9uKCBtYXRjaCwgY29udGV4dCwgaXNYTUwgKSB7CgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQgIT09ICJ1bmRlZmluZWQiICYmICFpc1hNTCApIHsKCQkJCXZhciBtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChtYXRjaFsxXSk7CgoJCQkJcmV0dXJuIG0gPwoJCQkJCW0uaWQgPT09IG1hdGNoWzFdIHx8IHR5cGVvZiBtLmdldEF0dHJpYnV0ZU5vZGUgIT09ICJ1bmRlZmluZWQiICYmIG0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKS5ub2RlVmFsdWUgPT09IG1hdGNoWzFdID8KCQkJCQkJW21dIDoKCQkJCQkJdW5kZWZpbmVkIDoKCQkJCQlbXTsKCQkJfQoJCX07CgoJCUV4cHIuZmlsdGVyLklEID0gZnVuY3Rpb24oIGVsZW0sIG1hdGNoICkgewoJCQl2YXIgbm9kZSA9IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZU5vZGUgIT09ICJ1bmRlZmluZWQiICYmIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsKCgkJCXJldHVybiBlbGVtLm5vZGVUeXBlID09PSAxICYmIG5vZGUgJiYgbm9kZS5ub2RlVmFsdWUgPT09IG1hdGNoOwoJCX07Cgl9CgoJcm9vdC5yZW1vdmVDaGlsZCggZm9ybSApOwoKCS8vIHJlbGVhc2UgbWVtb3J5IGluIElFCglyb290ID0gZm9ybSA9IG51bGw7Cn0pKCk7CgooZnVuY3Rpb24oKXsKCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgYnJvd3NlciByZXR1cm5zIG9ubHkgZWxlbWVudHMKCS8vIHdoZW4gZG9pbmcgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKQoKCS8vIENyZWF0ZSBhIGZha2UgZWxlbWVudAoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJZGl2LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVDb21tZW50KCIiKSApOwoKCS8vIE1ha2Ugc3VyZSBubyBjb21tZW50cyBhcmUgZm91bmQKCWlmICggZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikubGVuZ3RoID4gMCApIHsKCQlFeHByLmZpbmQuVEFHID0gZnVuY3Rpb24oIG1hdGNoLCBjb250ZXh0ICkgewoJCQl2YXIgcmVzdWx0cyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIG1hdGNoWzFdICk7CgoJCQkvLyBGaWx0ZXIgb3V0IHBvc3NpYmxlIGNvbW1lbnRzCgkJCWlmICggbWF0Y2hbMV0gPT09ICIqIiApIHsKCQkJCXZhciB0bXAgPSBbXTsKCgkJCQlmb3IgKCB2YXIgaSA9IDA7IHJlc3VsdHNbaV07IGkrKyApIHsKCQkJCQlpZiAoIHJlc3VsdHNbaV0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJCXRtcC5wdXNoKCByZXN1bHRzW2ldICk7CgkJCQkJfQoJCQkJfQoKCQkJCXJlc3VsdHMgPSB0bXA7CgkJCX0KCgkJCXJldHVybiByZXN1bHRzOwoJCX07Cgl9CgoJLy8gQ2hlY2sgdG8gc2VlIGlmIGFuIGF0dHJpYnV0ZSByZXR1cm5zIG5vcm1hbGl6ZWQgaHJlZiBhdHRyaWJ1dGVzCglkaXYuaW5uZXJIVE1MID0gIjxhIGhyZWY9JyMnPjwvYT4iOwoKCWlmICggZGl2LmZpcnN0Q2hpbGQgJiYgdHlwZW9mIGRpdi5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSAhPT0gInVuZGVmaW5lZCIgJiYKCQkJZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJocmVmIikgIT09ICIjIiApIHsKCgkJRXhwci5hdHRySGFuZGxlLmhyZWYgPSBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCAiaHJlZiIsIDIgKTsKCQl9OwoJfQoKCS8vIHJlbGVhc2UgbWVtb3J5IGluIElFCglkaXYgPSBudWxsOwp9KSgpOwoKaWYgKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsICkgewoJKGZ1bmN0aW9uKCl7CgkJdmFyIG9sZFNpenpsZSA9IFNpenpsZSwKCQkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCgkJCWlkID0gIl9fc2l6emxlX18iOwoKCQlkaXYuaW5uZXJIVE1MID0gIjxwIGNsYXNzPSdURVNUJz48L3A+IjsKCgkJLy8gU2FmYXJpIGNhbid0IGhhbmRsZSB1cHBlcmNhc2Ugb3IgdW5pY29kZSBjaGFyYWN0ZXJzIHdoZW4KCQkvLyBpbiBxdWlya3MgbW9kZS4KCQlpZiAoIGRpdi5xdWVyeVNlbGVjdG9yQWxsICYmIGRpdi5xdWVyeVNlbGVjdG9yQWxsKCIuVEVTVCIpLmxlbmd0aCA9PT0gMCApIHsKCQkJcmV0dXJuOwoJCX0KCQoJCVNpenpsZSA9IGZ1bmN0aW9uKCBxdWVyeSwgY29udGV4dCwgZXh0cmEsIHNlZWQgKSB7CgkJCWNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50OwoKCQkJLy8gT25seSB1c2UgcXVlcnlTZWxlY3RvckFsbCBvbiBub24tWE1MIGRvY3VtZW50cwoJCQkvLyAoSUQgc2VsZWN0b3JzIGRvbid0IHdvcmsgaW4gbm9uLUhUTUwgZG9jdW1lbnRzKQoJCQlpZiAoICFzZWVkICYmICFTaXp6bGUuaXNYTUwoY29udGV4dCkgKSB7CgkJCQkvLyBTZWUgaWYgd2UgZmluZCBhIHNlbGVjdG9yIHRvIHNwZWVkIHVwCgkJCQl2YXIgbWF0Y2ggPSAvXihcdyskKXxeXC4oW1x3XC1dKyQpfF4jKFtcd1wtXSskKS8uZXhlYyggcXVlcnkgKTsKCQkJCQoJCQkJaWYgKCBtYXRjaCAmJiAoY29udGV4dC5ub2RlVHlwZSA9PT0gMSB8fCBjb250ZXh0Lm5vZGVUeXBlID09PSA5KSApIHsKCQkJCQkvLyBTcGVlZC11cDogU2l6emxlKCJUQUciKQoJCQkJCWlmICggbWF0Y2hbMV0gKSB7CgkJCQkJCXJldHVybiBtYWtlQXJyYXkoIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHF1ZXJ5ICksIGV4dHJhICk7CgkJCQkJCgkJCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiLkNMQVNTIikKCQkJCQl9IGVsc2UgaWYgKCBtYXRjaFsyXSAmJiBFeHByLmZpbmQuQ0xBU1MgJiYgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICkgewoJCQkJCQlyZXR1cm4gbWFrZUFycmF5KCBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIG1hdGNoWzJdICksIGV4dHJhICk7CgkJCQkJfQoJCQkJfQoJCQkJCgkJCQlpZiAoIGNvbnRleHQubm9kZVR5cGUgPT09IDkgKSB7CgkJCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiYm9keSIpCgkJCQkJLy8gVGhlIGJvZHkgZWxlbWVudCBvbmx5IGV4aXN0cyBvbmNlLCBvcHRpbWl6ZSBmaW5kaW5nIGl0CgkJCQkJaWYgKCBxdWVyeSA9PT0gImJvZHkiICYmIGNvbnRleHQuYm9keSApIHsKCQkJCQkJcmV0dXJuIG1ha2VBcnJheSggWyBjb250ZXh0LmJvZHkgXSwgZXh0cmEgKTsKCQkJCQkJCgkJCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiI0lEIikKCQkJCQl9IGVsc2UgaWYgKCBtYXRjaCAmJiBtYXRjaFszXSApIHsKCQkJCQkJdmFyIGVsZW0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKCBtYXRjaFszXSApOwoKCQkJCQkJLy8gQ2hlY2sgcGFyZW50Tm9kZSB0byBjYXRjaCB3aGVuIEJsYWNrYmVycnkgNC42IHJldHVybnMKCQkJCQkJLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwoJCQkJCQlpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCQkJLy8gSGFuZGxlIHRoZSBjYXNlIHdoZXJlIElFIGFuZCBPcGVyYSByZXR1cm4gaXRlbXMKCQkJCQkJCS8vIGJ5IG5hbWUgaW5zdGVhZCBvZiBJRAoJCQkJCQkJaWYgKCBlbGVtLmlkID09PSBtYXRjaFszXSApIHsKCQkJCQkJCQlyZXR1cm4gbWFrZUFycmF5KCBbIGVsZW0gXSwgZXh0cmEgKTsKCQkJCQkJCX0KCQkJCQkJCQoJCQkJCQl9IGVsc2UgewoJCQkJCQkJcmV0dXJuIG1ha2VBcnJheSggW10sIGV4dHJhICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJCgkJCQkJdHJ5IHsKCQkJCQkJcmV0dXJuIG1ha2VBcnJheSggY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKHF1ZXJ5KSwgZXh0cmEgKTsKCQkJCQl9IGNhdGNoKHFzYUVycm9yKSB7fQoKCQkJCS8vIHFTQSB3b3JrcyBzdHJhbmdlbHkgb24gRWxlbWVudC1yb290ZWQgcXVlcmllcwoJCQkJLy8gV2UgY2FuIHdvcmsgYXJvdW5kIHRoaXMgYnkgc3BlY2lmeWluZyBhbiBleHRyYSBJRCBvbiB0aGUgcm9vdAoJCQkJLy8gYW5kIHdvcmtpbmcgdXAgZnJvbSB0aGVyZSAoVGhhbmtzIHRvIEFuZHJldyBEdXBvbnQgZm9yIHRoZSB0ZWNobmlxdWUpCgkJCQkvLyBJRSA4IGRvZXNuJ3Qgd29yayBvbiBvYmplY3QgZWxlbWVudHMKCQkJCX0gZWxzZSBpZiAoIGNvbnRleHQubm9kZVR5cGUgPT09IDEgJiYgY29udGV4dC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAib2JqZWN0IiApIHsKCQkJCQl2YXIgb2xkQ29udGV4dCA9IGNvbnRleHQsCgkJCQkJCW9sZCA9IGNvbnRleHQuZ2V0QXR0cmlidXRlKCAiaWQiICksCgkJCQkJCW5pZCA9IG9sZCB8fCBpZCwKCQkJCQkJaGFzUGFyZW50ID0gY29udGV4dC5wYXJlbnROb2RlLAoJCQkJCQlyZWxhdGl2ZUhpZXJhcmNoeVNlbGVjdG9yID0gL15ccypbK35dLy50ZXN0KCBxdWVyeSApOwoKCQkJCQlpZiAoICFvbGQgKSB7CgkJCQkJCWNvbnRleHQuc2V0QXR0cmlidXRlKCAiaWQiLCBuaWQgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQluaWQgPSBuaWQucmVwbGFjZSggLycvZywgIlxcJCYiICk7CgkJCQkJfQoJCQkJCWlmICggcmVsYXRpdmVIaWVyYXJjaHlTZWxlY3RvciAmJiBoYXNQYXJlbnQgKSB7CgkJCQkJCWNvbnRleHQgPSBjb250ZXh0LnBhcmVudE5vZGU7CgkJCQkJfQoKCQkJCQl0cnkgewoJCQkJCQlpZiAoICFyZWxhdGl2ZUhpZXJhcmNoeVNlbGVjdG9yIHx8IGhhc1BhcmVudCApIHsKCQkJCQkJCXJldHVybiBtYWtlQXJyYXkoIGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCggIltpZD0nIiArIG5pZCArICInXSAiICsgcXVlcnkgKSwgZXh0cmEgKTsKCQkJCQkJfQoKCQkJCQl9IGNhdGNoKHBzZXVkb0Vycm9yKSB7CgkJCQkJfSBmaW5hbGx5IHsKCQkJCQkJaWYgKCAhb2xkICkgewoJCQkJCQkJb2xkQ29udGV4dC5yZW1vdmVBdHRyaWJ1dGUoICJpZCIgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCQoJCQlyZXR1cm4gb2xkU2l6emxlKHF1ZXJ5LCBjb250ZXh0LCBleHRyYSwgc2VlZCk7CgkJfTsKCgkJZm9yICggdmFyIHByb3AgaW4gb2xkU2l6emxlICkgewoJCQlTaXp6bGVbIHByb3AgXSA9IG9sZFNpenpsZVsgcHJvcCBdOwoJCX0KCgkJLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKCQlkaXYgPSBudWxsOwoJfSkoKTsKfQoKKGZ1bmN0aW9uKCl7Cgl2YXIgaHRtbCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQltYXRjaGVzID0gaHRtbC5tYXRjaGVzU2VsZWN0b3IgfHwgaHRtbC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgaHRtbC53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgaHRtbC5tc01hdGNoZXNTZWxlY3RvcjsKCglpZiAoIG1hdGNoZXMgKSB7CgkJLy8gQ2hlY2sgdG8gc2VlIGlmIGl0J3MgcG9zc2libGUgdG8gZG8gbWF0Y2hlc1NlbGVjdG9yCgkJLy8gb24gYSBkaXNjb25uZWN0ZWQgbm9kZSAoSUUgOSBmYWlscyB0aGlzKQoJCXZhciBkaXNjb25uZWN0ZWRNYXRjaCA9ICFtYXRjaGVzLmNhbGwoIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksICJkaXYiICksCgkJCXBzZXVkb1dvcmtzID0gZmFsc2U7CgoJCXRyeSB7CgkJCS8vIFRoaXMgc2hvdWxkIGZhaWwgd2l0aCBhbiBleGNlcHRpb24KCQkJLy8gR2Vja28gZG9lcyBub3QgZXJyb3IsIHJldHVybnMgZmFsc2UgaW5zdGVhZAoJCQltYXRjaGVzLmNhbGwoIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgIlt0ZXN0IT0nJ106c2l6emxlIiApOwoJCgkJfSBjYXRjaCggcHNldWRvRXJyb3IgKSB7CgkJCXBzZXVkb1dvcmtzID0gdHJ1ZTsKCQl9CgoJCVNpenpsZS5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggbm9kZSwgZXhwciApIHsKCQkJLy8gTWFrZSBzdXJlIHRoYXQgYXR0cmlidXRlIHNlbGVjdG9ycyBhcmUgcXVvdGVkCgkJCWV4cHIgPSBleHByLnJlcGxhY2UoL1w9XHMqKFteJyJcXV0qKVxzKlxdL2csICI9JyQxJ10iKTsKCgkJCWlmICggIVNpenpsZS5pc1hNTCggbm9kZSApICkgewoJCQkJdHJ5IHsgCgkJCQkJaWYgKCBwc2V1ZG9Xb3JrcyB8fCAhRXhwci5tYXRjaC5QU0VVRE8udGVzdCggZXhwciApICYmICEvIT0vLnRlc3QoIGV4cHIgKSApIHsKCQkJCQkJdmFyIHJldCA9IG1hdGNoZXMuY2FsbCggbm9kZSwgZXhwciApOwoKCQkJCQkJLy8gSUUgOSdzIG1hdGNoZXNTZWxlY3RvciByZXR1cm5zIGZhbHNlIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwoJCQkJCQlpZiAoIHJldCB8fCAhZGlzY29ubmVjdGVkTWF0Y2ggfHwKCQkJCQkJCQkvLyBBcyB3ZWxsLCBkaXNjb25uZWN0ZWQgbm9kZXMgYXJlIHNhaWQgdG8gYmUgaW4gYSBkb2N1bWVudAoJCQkJCQkJCS8vIGZyYWdtZW50IGluIElFIDksIHNvIGNoZWNrIGZvciB0aGF0CgkJCQkJCQkJbm9kZS5kb2N1bWVudCAmJiBub2RlLmRvY3VtZW50Lm5vZGVUeXBlICE9PSAxMSApIHsKCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGNhdGNoKGUpIHt9CgkJCX0KCgkJCXJldHVybiBTaXp6bGUoZXhwciwgbnVsbCwgbnVsbCwgW25vZGVdKS5sZW5ndGggPiAwOwoJCX07Cgl9Cn0pKCk7CgooZnVuY3Rpb24oKXsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCglkaXYuaW5uZXJIVE1MID0gIjxkaXYgY2xhc3M9J3Rlc3QgZSc+PC9kaXY+PGRpdiBjbGFzcz0ndGVzdCc+PC9kaXY+IjsKCgkvLyBPcGVyYSBjYW4ndCBmaW5kIGEgc2Vjb25kIGNsYXNzbmFtZSAoaW4gOS42KQoJLy8gQWxzbywgbWFrZSBzdXJlIHRoYXQgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBhY3R1YWxseSBleGlzdHMKCWlmICggIWRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lIHx8IGRpdi5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCJlIikubGVuZ3RoID09PSAwICkgewoJCXJldHVybjsKCX0KCgkvLyBTYWZhcmkgY2FjaGVzIGNsYXNzIGF0dHJpYnV0ZXMsIGRvZXNuJ3QgY2F0Y2ggY2hhbmdlcyAoaW4gMy4yKQoJZGl2Lmxhc3RDaGlsZC5jbGFzc05hbWUgPSAiZSI7CgoJaWYgKCBkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiZSIpLmxlbmd0aCA9PT0gMSApIHsKCQlyZXR1cm47Cgl9CgkKCUV4cHIub3JkZXIuc3BsaWNlKDEsIDAsICJDTEFTUyIpOwoJRXhwci5maW5kLkNMQVNTID0gZnVuY3Rpb24oIG1hdGNoLCBjb250ZXh0LCBpc1hNTCApIHsKCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgIT09ICJ1bmRlZmluZWQiICYmICFpc1hNTCApIHsKCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShtYXRjaFsxXSk7CgkJfQoJfTsKCgkvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQoJZGl2ID0gbnVsbDsKfSkoKTsKCmZ1bmN0aW9uIGRpck5vZGVDaGVjayggZGlyLCBjdXIsIGRvbmVOYW1lLCBjaGVja1NldCwgbm9kZUNoZWNrLCBpc1hNTCApIHsKCWZvciAoIHZhciBpID0gMCwgbCA9IGNoZWNrU2V0Lmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQl2YXIgZWxlbSA9IGNoZWNrU2V0W2ldOwoKCQlpZiAoIGVsZW0gKSB7CgkJCXZhciBtYXRjaCA9IGZhbHNlOwoKCQkJZWxlbSA9IGVsZW1bZGlyXTsKCgkJCXdoaWxlICggZWxlbSApIHsKCQkJCWlmICggZWxlbS5zaXpjYWNoZSA9PT0gZG9uZU5hbWUgKSB7CgkJCQkJbWF0Y2ggPSBjaGVja1NldFtlbGVtLnNpenNldF07CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmICFpc1hNTCApewoJCQkJCWVsZW0uc2l6Y2FjaGUgPSBkb25lTmFtZTsKCQkJCQllbGVtLnNpenNldCA9IGk7CgkJCQl9CgoJCQkJaWYgKCBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IGN1ciApIHsKCQkJCQltYXRjaCA9IGVsZW07CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJZWxlbSA9IGVsZW1bZGlyXTsKCQkJfQoKCQkJY2hlY2tTZXRbaV0gPSBtYXRjaDsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGRpckNoZWNrKCBkaXIsIGN1ciwgZG9uZU5hbWUsIGNoZWNrU2V0LCBub2RlQ2hlY2ssIGlzWE1MICkgewoJZm9yICggdmFyIGkgPSAwLCBsID0gY2hlY2tTZXQubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCXZhciBlbGVtID0gY2hlY2tTZXRbaV07CgoJCWlmICggZWxlbSApIHsKCQkJdmFyIG1hdGNoID0gZmFsc2U7CgkJCQoJCQllbGVtID0gZWxlbVtkaXJdOwoKCQkJd2hpbGUgKCBlbGVtICkgewoJCQkJaWYgKCBlbGVtLnNpemNhY2hlID09PSBkb25lTmFtZSApIHsKCQkJCQltYXRjaCA9IGNoZWNrU2V0W2VsZW0uc2l6c2V0XTsKCQkJCQlicmVhazsKCQkJCX0KCgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQkJaWYgKCAhaXNYTUwgKSB7CgkJCQkJCWVsZW0uc2l6Y2FjaGUgPSBkb25lTmFtZTsKCQkJCQkJZWxlbS5zaXpzZXQgPSBpOwoJCQkJCX0KCgkJCQkJaWYgKCB0eXBlb2YgY3VyICE9PSAic3RyaW5nIiApIHsKCQkJCQkJaWYgKCBlbGVtID09PSBjdXIgKSB7CgkJCQkJCQltYXRjaCA9IHRydWU7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoKCQkJCQl9IGVsc2UgaWYgKCBTaXp6bGUuZmlsdGVyKCBjdXIsIFtlbGVtXSApLmxlbmd0aCA+IDAgKSB7CgkJCQkJCW1hdGNoID0gZWxlbTsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoKCQkJCWVsZW0gPSBlbGVtW2Rpcl07CgkJCX0KCgkJCWNoZWNrU2V0W2ldID0gbWF0Y2g7CgkJfQoJfQp9CgppZiAoIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jb250YWlucyApIHsKCVNpenpsZS5jb250YWlucyA9IGZ1bmN0aW9uKCBhLCBiICkgewoJCXJldHVybiBhICE9PSBiICYmIChhLmNvbnRhaW5zID8gYS5jb250YWlucyhiKSA6IHRydWUpOwoJfTsKCn0gZWxzZSBpZiAoIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiApIHsKCVNpenpsZS5jb250YWlucyA9IGZ1bmN0aW9uKCBhLCBiICkgewoJCXJldHVybiAhIShhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGIpICYgMTYpOwoJfTsKCn0gZWxzZSB7CglTaXp6bGUuY29udGFpbnMgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9Owp9CgpTaXp6bGUuaXNYTUwgPSBmdW5jdGlvbiggZWxlbSApIHsKCS8vIGRvY3VtZW50RWxlbWVudCBpcyB2ZXJpZmllZCBmb3IgY2FzZXMgd2hlcmUgaXQgZG9lc24ndCB5ZXQgZXhpc3QKCS8vIChzdWNoIGFzIGxvYWRpbmcgaWZyYW1lcyBpbiBJRSAtICM0ODMzKSAKCXZhciBkb2N1bWVudEVsZW1lbnQgPSAoZWxlbSA/IGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtIDogMCkuZG9jdW1lbnRFbGVtZW50OwoKCXJldHVybiBkb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudEVsZW1lbnQubm9kZU5hbWUgIT09ICJIVE1MIiA6IGZhbHNlOwp9OwoKdmFyIHBvc1Byb2Nlc3MgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7Cgl2YXIgbWF0Y2gsCgkJdG1wU2V0ID0gW10sCgkJbGF0ZXIgPSAiIiwKCQlyb290ID0gY29udGV4dC5ub2RlVHlwZSA/IFtjb250ZXh0XSA6IGNvbnRleHQ7CgoJLy8gUG9zaXRpb24gc2VsZWN0b3JzIG11c3QgYmUgZG9uZSBhZnRlciB0aGUgZmlsdGVyCgkvLyBBbmQgc28gbXVzdCA6bm90KHBvc2l0aW9uYWwpIHNvIHdlIG1vdmUgYWxsIFBTRVVET3MgdG8gdGhlIGVuZAoJd2hpbGUgKCAobWF0Y2ggPSBFeHByLm1hdGNoLlBTRVVETy5leGVjKCBzZWxlY3RvciApKSApIHsKCQlsYXRlciArPSBtYXRjaFswXTsKCQlzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoIEV4cHIubWF0Y2guUFNFVURPLCAiIiApOwoJfQoKCXNlbGVjdG9yID0gRXhwci5yZWxhdGl2ZVtzZWxlY3Rvcl0gPyBzZWxlY3RvciArICIqIiA6IHNlbGVjdG9yOwoKCWZvciAoIHZhciBpID0gMCwgbCA9IHJvb3QubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCVNpenpsZSggc2VsZWN0b3IsIHJvb3RbaV0sIHRtcFNldCApOwoJfQoKCXJldHVybiBTaXp6bGUuZmlsdGVyKCBsYXRlciwgdG1wU2V0ICk7Cn07CgovLyBFWFBPU0UKCndpbmRvdy5TaXp6bGUgPSBTaXp6bGU7Cgp9KSgpOwpzbmFjay53cmFwLmRlZmluZUVuZ2luZShmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpewogIGlmICh0eXBlb2YgY29udGV4dCA9PSAnc3RyaW5nJykKICAgIGNvbnRleHQgPSBTaXp6bGUoY29udGV4dClbMF0KICByZXR1cm4gU2l6emxlKHNlbGVjdG9yLCBjb250ZXh0KQp9KQo=",
                "body": "LyohCiAgKiBzbmFjay5qcyAoYykgUnlhbiBGbG9yZW5jZQogICogaHR0cHM6Ly9naXRodWIuY29tL3JwZmxvcmVuY2Uvc25hY2sKICAqIE1JVCBMaWNlbnNlCiAgKiBJbnNwaXJhdGlvbiBhbmQgY29kZSBhZGFwdGVkIGZyb20KICAqICBNb29Ub29scyAgICAgIChjKSBWYWxlcmlvIFByb2lldHRpICAgTUlUIGxpY2Vuc2UKICAqICBqUXVlcnkgICAgICAgIChjKSBKb2huIFJlc2lnICAgICAgICAgRHVhbCBsaWNlbnNlIE1JVCBvciBHUEwgVmVyc2lvbiAyCiAgKiAgY29udGVudExvYWRlZCAoYykgRGllZ28gUGVyaW5pICAgICAgIE1JVCBMaWNlbnNlCiAgKiAgWmVwdG8uanMgICAgICAoYykgVGhvbWFzIEZ1Y2hzICAgICAgIE1JVCBMaWNlbnNlCiovCgppZiAodHlwZW9mIE9iamVjdC5jcmVhdGUgIT0gJ2Z1bmN0aW9uJyl7CiAgLy8gRVM1IE9iZWplY3QuY3JlYXRlCiAgT2JqZWN0LmNyZWF0ZSA9IGZ1bmN0aW9uIChvKXsKICAgIGZ1bmN0aW9uIEYoKSB7fQogICAgRi5wcm90b3R5cGUgPSBvCiAgICByZXR1cm4gbmV3IEYKICB9Cn0KCiFmdW5jdGlvbih3aW5kb3cpewogIHZhciBzbmFjayA9IHdpbmRvdy5zbmFjayA9IHt9CiAgICAsIGd1aWQgPSAwCiAgICAsIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZwogICAgLCBpbmRleE9mID0gW10uaW5kZXhPZgogICAgLCBwdXNoID0gW10ucHVzaAoKICBzbmFjay5leHRlbmQgPSBmdW5jdGlvbiAoKXsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpCiAgICAgIHJldHVybiBzbmFjay5leHRlbmQoc25hY2ssIGFyZ3VtZW50c1swXSkKCiAgICB2YXIgdGFyZ2V0ID0gYXJndW1lbnRzWzBdCgogICAgZm9yICh2YXIga2V5LCBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspCiAgICAgIGZvciAoa2V5IGluIGFyZ3VtZW50c1tpXSkKICAgICAgICB0YXJnZXRba2V5XSA9IGFyZ3VtZW50c1tpXVtrZXldCgogICAgcmV0dXJuIHRhcmdldAogIH0KCiAgc25hY2suZXh0ZW5kKHsKICAgIHY6ICcxLjIuMycsCgogICAgYmluZDogZnVuY3Rpb24gKGZuLCBjb250ZXh0LCBhcmdzKSB7CiAgICAgIGFyZ3MgPSBhcmdzIHx8IFtdOwogICAgICByZXR1cm4gZnVuY3Rpb24gKCl7CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiBmbi5hcHBseShjb250ZXh0LCBhcmdzKQogICAgICB9CiAgICB9LAoKICAgIHB1bmNoOiBmdW5jdGlvbiAob2JqLCBtZXRob2QsIGZuLCBhdXRvKXsKICAgICAgdmFyIG9sZCA9IG9ialttZXRob2RdCiAgICAgIG9ialttZXRob2RdID0gYXV0byA/IGZ1bmN0aW9uICgpewogICAgICAgIG9sZC5hcHBseShvYmosIGFyZ3VtZW50cykKICAgICAgICByZXR1cm4gZm4uYXBwbHkob2JqLCBhcmd1bWVudHMpCiAgICAgIH0gOiBmdW5jdGlvbiAoKXsKICAgICAgICB2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKQogICAgICAgIGFyZ3MudW5zaGlmdChzbmFjay5iaW5kKG9sZCwgb2JqKSkKICAgICAgICByZXR1cm4gZm4uYXBwbHkob2JqLCBhcmdzKQogICAgICB9CiAgICB9LAoKICAgIGNyZWF0ZTogZnVuY3Rpb24gKHByb3RvLCBleHQpewogICAgICB2YXIgb2JqID0gT2JqZWN0LmNyZWF0ZShwcm90bykKICAgICAgaWYgKCFleHQpCiAgICAgICAgcmV0dXJuIG9iagoKICAgICAgZm9yICh2YXIgaSBpbiBleHQpIHsKICAgICAgICBpZiAoIWV4dC5oYXNPd25Qcm9wZXJ0eShpKSkKICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGlmICghcHJvdG9baV0gfHwgdHlwZW9mIGV4dFtpXSAhPSAnZnVuY3Rpb24nKXsKICAgICAgICAgIG9ialtpXSA9IGV4dFtpXQogICAgICAgICAgY29udGludWUKICAgICAgICB9CgogICAgICAgIHNuYWNrLnB1bmNoKG9iaiwgaSwgZXh0W2ldKQogICAgICB9CgogICAgICByZXR1cm4gb2JqCiAgICB9LAoKICAgIGlkOiBmdW5jdGlvbiAoKXsKICAgICAgcmV0dXJuICsrZ3VpZAogICAgfSwKCiAgICBlYWNoOiBmdW5jdGlvbiAob2JqLCBmbiwgY29udGV4dCl7CiAgICAgIGlmIChvYmoubGVuZ3RoID09PSB2b2lkKzApeyAvLyBsb29zZSBjaGVjayBmb3Igb2JqZWN0LCB3ZSB3YW50IGFycmF5LWxpa2Ugb2JqZWN0cyB0byBiZSB0cmVhdGVkIGFzIGFycmF5cwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopCiAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KGtleSkpCiAgICAgICAgICAgIGZuLmNhbGwoY29udGV4dCwgb2JqW2tleV0sIGtleSwgb2JqKTsKICAgICAgICByZXR1cm4gb2JqCiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gb2JqLmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgICBmbi5jYWxsKGNvbnRleHQsIG9ialtpXSwgaSwgb2JqKQogICAgICByZXR1cm4gb2JqCiAgICB9LAoKICAgIHBhcnNlSlNPTjogZnVuY3Rpb24oanNvbikgewogICAgICAvLyBhZGFwdGVkIGZyb20galF1ZXJ5CiAgICAgIGlmICh0eXBlb2YganNvbiAhPSAnc3RyaW5nJykKICAgICAgICByZXR1cm4KCiAgICAgIGpzb24gPSBqc29uLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJykKCiAgICAgIHZhciBpc1ZhbGlkID0gL15bXF0sOnt9XHNdKiQvLnRlc3QoanNvbi5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICJAIikKICAgICAgICAucmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICJdIikKICAgICAgICAucmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAiIikpCgogICAgICBpZiAoIWlzVmFsaWQpCiAgICAgICAgdGhyb3cgIkludmFsaWQgSlNPTiIKICAgICAgCiAgICAgIHZhciBKU09OID0gd2luZG93LkpTT04gLy8gc2F2ZXMgYSBjb3VwbGUgYnl0ZXMKICAgICAgcmV0dXJuIEpTT04gJiYgSlNPTi5wYXJzZSA/IEpTT04ucGFyc2UoanNvbikgOiAobmV3IEZ1bmN0aW9uKCJyZXR1cm4gIiArIGpzb24pKSgpCiAgICB9LAoKICAgIGlzQXJyYXk6IGZ1bmN0aW9uIChvYmopewogICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgQXJyYXkgfHwgdG9TdHJpbmcuY2FsbChvYmopID09ICJbb2JqZWN0IEFycmF5XSIKICAgIH0sCgogICAgaW5kZXhPZjogaW5kZXhPZiA/IGZ1bmN0aW9uKGl0ZW0sIGFycmF5KXsKICAgICAgICByZXR1cm4gaW5kZXhPZi5jYWxsKGFycmF5LCBpdGVtKQogICAgICB9IDogZnVuY3Rpb24gKGl0ZW0sIGFycmF5KXsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBhcnJheS5sZW5ndGg7IGkgPCBsOyBpKyspCiAgICAgICAgaWYgKGFycmF5W2ldID09PSBpdGVtKQogICAgICAgICAgcmV0dXJuIGkKCiAgICAgIHJldHVybiAtMQogICAgfQogIH0pCn0od2luZG93KTsKIWZ1bmN0aW9uIChzbmFjaywgZG9jdW1lbnQpewogIHZhciBwcm90byA9IHt9CiAgICAsIHF1ZXJ5CgogIHNuYWNrLndyYXAgPSBmdW5jdGlvbiAobm9kZXMsIGNvbnRleHQpewogICAgLy8gcGFzc2VkIGluIGEgQ1NTIHNlbGVjdG9yCiAgICBpZiAodHlwZW9mIG5vZGVzID09ICdzdHJpbmcnKQogICAgICBub2RlcyA9IHF1ZXJ5KG5vZGVzLCBjb250ZXh0KQoKICAgIC8vIHBhc3NlZCBpbiBzaW5nbGUgbm9kZQogICAgaWYgKCFub2Rlcy5sZW5ndGgpCiAgICAgIG5vZGVzID0gW25vZGVzXQoKICAgIHZhciB3cmFwcGVyID0gT2JqZWN0LmNyZWF0ZShwcm90bykKICAgICAgLCBpID0gMAogICAgICAsIGwgPSBub2Rlcy5sZW5ndGgKCiAgICBmb3IgKDsgaSA8IGw7IGkrKykKICAgICAgd3JhcHBlcltpXSA9IG5vZGVzW2ldCgogICAgd3JhcHBlci5sZW5ndGggPSBsCiAgICB3cmFwcGVyLmlkID0gc25hY2suaWQoKQogICAgcmV0dXJuIHdyYXBwZXIKICB9CgogIHNuYWNrLmV4dGVuZChzbmFjay53cmFwLCB7CiAgICBkZWZpbmU6IGZ1bmN0aW9uKG5hbWUsIGZuKXsKICAgICAgaWYgKHR5cGVvZiBuYW1lICE9ICdzdHJpbmcnKXsKICAgICAgICBmb3IgKHZhciBpIGluIG5hbWUpCiAgICAgICAgICBzbmFjay53cmFwLmRlZmluZShpLCBuYW1lW2ldKQogICAgICAgIHJldHVybgogICAgICB9CiAgICAgIHByb3RvW25hbWVdID0gZm4KICAgIH0sCgogICAgZGVmaW5lRW5naW5lOiBmdW5jdGlvbiAoZm4pewogICAgICBxdWVyeSA9IGZuCiAgICB9CiAgfSkKCiAgLy8gUVNBIGRlZmF1bHQgc2VsZWN0b3IgZW5naW5lLCBzdXBwb3J0cyByZWFsIGJyb3dzZXJzIGFuZCBJRTgrCiAgc25hY2sud3JhcC5kZWZpbmVFbmdpbmUoZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0KXsKICAgIGlmICh0eXBlb2YgY29udGV4dCA9PSAnc3RyaW5nJykKICAgICAgY29udGV4dCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoY29udGV4dCkKCiAgICByZXR1cm4gKGNvbnRleHQgfHwgZG9jdW1lbnQpLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpCiAgfSkKfShzbmFjaywgZG9jdW1lbnQpCiFmdW5jdGlvbiAoc25hY2ssIHdpbmRvdywgZG9jdW1lbnQpewogIHZhciBhZGQgICAgICAgICAgICA9IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgPyAnYWRkRXZlbnRMaXN0ZW5lcicgOiAnYXR0YWNoRXZlbnQnCiAgICAsIHJlbW92ZSAgICAgICAgID0gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciA/ICdyZW1vdmVFdmVudExpc3RlbmVyJyA6ICdkZXRhY2hFdmVudCcKICAgICwgcHJlZml4ICAgICAgICAgPSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyID8gJycgOiAnb24nCiAgICAsIHJlYWR5ICAgICAgICAgID0gZmFsc2UKICAgICwgdG9wICAgICAgICAgICAgPSB0cnVlCiAgICAsIHJvb3QgICAgICAgICAgID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50CiAgICAsIHJlYWR5SGFuZGxlcnMgID0gW10KCiAgc25hY2suZXh0ZW5kKHsKICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24gKGV2ZW50KXsKICAgICAgaWYgKGV2ZW50LnN0b3BQcm9wYWdhdGlvbikKICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKQogICAgICBlbHNlCiAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZQogICAgfSwKCiAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gKGV2ZW50KXsKICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KQogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCkKICAgICAgZWxzZQogICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2UKICAgIH0KICB9KQoKICBzbmFjay5saXN0ZW5lciA9IGZ1bmN0aW9uIChwYXJhbXMsIGhhbmRsZXIpewogICAgaWYgKHBhcmFtcy5kZWxlZ2F0ZSl7CiAgICAgIHBhcmFtcy5jYXB0dXJlID0gdHJ1ZQogICAgICBfaGFuZGxlciA9IGhhbmRsZXIKICAgICAgaGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCl7CiAgICAgICAgLy8gYWRhcHRlZCBmcm9tIFplcHRvCiAgICAgICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50CiAgICAgICAgICAsIG5vZGVzID0gdHlwZW9mIHBhcmFtcy5kZWxlZ2F0ZSA9PSAnc3RyaW5nJwogICAgICAgICAgICA/IHNuYWNrLndyYXAocGFyYW1zLmRlbGVnYXRlLCBwYXJhbXMubm9kZSkKICAgICAgICAgICAgOiBwYXJhbXMuZGVsZWdhdGUocGFyYW1zLm5vZGUpCgogICAgICAgIHdoaWxlICh0YXJnZXQgJiYgc25hY2suaW5kZXhPZih0YXJnZXQsIG5vZGVzKSA9PSAtMSApCiAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZQoKICAgICAgICBpZiAodGFyZ2V0ICYmICEodGFyZ2V0ID09PSB0aGlzKSAmJiAhKHRhcmdldCA9PT0gZG9jdW1lbnQpKQogICAgICAgICAgX2hhbmRsZXIuY2FsbCh0YXJnZXQsIGV2ZW50LCB0YXJnZXQpCiAgICAgIH0KICAgIH0KCiAgICBpZiAocGFyYW1zLmNvbnRleHQpCiAgICAgIGhhbmRsZXIgPSBzbmFjay5iaW5kKGhhbmRsZXIsIHBhcmFtcy5jb250ZXh0KQoKICAgIHZhciBtZXRob2RzID0gewogICAgICBhdHRhY2g6IGZ1bmN0aW9uICgpewogICAgICAgIHBhcmFtcy5ub2RlW2FkZF0oCiAgICAgICAgICBwcmVmaXggKyBwYXJhbXMuZXZlbnQsCiAgICAgICAgICBoYW5kbGVyLAogICAgICAgICAgcGFyYW1zLmNhcHR1cmUKICAgICAgICApCiAgICAgIH0sCgogICAgICBkZXRhY2g6IGZ1bmN0aW9uICgpewogICAgICAgIHBhcmFtcy5ub2RlW3JlbW92ZV0oCiAgICAgICAgICBwcmVmaXggKyBwYXJhbXMuZXZlbnQsCiAgICAgICAgICBoYW5kbGVyLAogICAgICAgICAgcGFyYW1zLmNhcHR1cmUKICAgICAgICApCiAgICAgIH0sCgogICAgICBmaXJlOiBmdW5jdGlvbiAoKXsKICAgICAgICBoYW5kbGVyLmFwcGx5KHBhcmFtcy5ub2RlLCBhcmd1bWVudHMpCiAgICAgIH0KICAgIH0KCiAgICBtZXRob2RzLmF0dGFjaCgpCgogICAgcmV0dXJuIG1ldGhvZHMKICB9CgoKCgogIHNuYWNrLnJlYWR5ID0gZnVuY3Rpb24gKGhhbmRsZXIpewogICAgaWYgKHJlYWR5KXsKICAgICAgaGFuZGxlci5hcHBseShkb2N1bWVudCkKICAgICAgcmV0dXJuCiAgICB9CiAgICByZWFkeUhhbmRsZXJzLnB1c2goaGFuZGxlcikKICB9CgogIC8vIGFkYXB0ZWQgZnJvbSBjb250ZW50bG9hZGVkCiAgZnVuY3Rpb24gaW5pdChlKSB7CiAgICBpZiAoZS50eXBlID09ICdyZWFkeXN0YXRlY2hhbmdlJyAmJiBkb2N1bWVudC5yZWFkeVN0YXRlICE9ICdjb21wbGV0ZScpCiAgICAgIHJldHVybgoKICAgIChlLnR5cGUgPT0gJ2xvYWQnID8gd2luZG93IDogZG9jdW1lbnQpW3JlbW92ZV0ocHJlZml4ICsgZS50eXBlLCBpbml0LCBmYWxzZSkKCiAgICBpZiAoIXJlYWR5ICYmIChyZWFkeSA9IHRydWUpKQogICAgICBzbmFjay5lYWNoKHJlYWR5SGFuZGxlcnMsIGZ1bmN0aW9uIChoYW5kbGVyKXsKICAgICAgICBoYW5kbGVyLmFwcGx5KGRvY3VtZW50KQogICAgICB9KQogIH0KCiAgZnVuY3Rpb24gcG9sbCgpIHsKICAgIHRyeSB7CiAgICAgIHJvb3QuZG9TY3JvbGwoJ2xlZnQnKQogICAgfSBjYXRjaChlKSB7IAogICAgICBzZXRUaW1lb3V0KHBvbGwsIDUwKQogICAgICByZXR1cm4KICAgIH0KICAgIGluaXQoJ3BvbGwnKQogIH0KCiAgaWYgKGRvY3VtZW50LmNyZWF0ZUV2ZW50T2JqZWN0ICYmIHJvb3QuZG9TY3JvbGwpIHsKICAgIHRyeSB7CiAgICAgIHRvcCA9ICF3aW5kb3cuZnJhbWVFbGVtZW50CiAgICB9IGNhdGNoKGUpIHt9CiAgICBpZiAodG9wKQogICAgICBwb2xsKCk7CiAgfQoKICBkb2N1bWVudFthZGRdKHByZWZpeCArICdET01Db250ZW50TG9hZGVkJywgaW5pdCwgZmFsc2UpCiAgZG9jdW1lbnRbYWRkXShwcmVmaXggKyAncmVhZHlzdGF0ZWNoYW5nZScsIGluaXQsIGZhbHNlKQogIHdpbmRvd1thZGRdKHByZWZpeCArICdsb2FkJywgaW5pdCwgZmFsc2UpCn0oc25hY2ssIHdpbmRvdywgZG9jdW1lbnQpOwohZnVuY3Rpb24gKHNuYWNrKXsKICBzbmFjay5wdWJsaXNoZXIgPSBmdW5jdGlvbiAob2JqKXsKICAgIHZhciBjaGFubmVscyA9IHt9CiAgICBvYmogPSBvYmogfHwge30KCiAgICBzbmFjay5leHRlbmQob2JqLCB7CiAgICAgIHN1YnNjcmliZTogZnVuY3Rpb24gKGNoYW5uZWwsIGhhbmRsZXIsIGNvbnRleHQpewogICAgICAgIHZhciBzdWJzY3JpcHRpb24gPSB7CiAgICAgICAgICBmbjogaGFuZGxlciwKICAgICAgICAgIGN0eHQ6IChjb250ZXh0IHx8IHt9KQogICAgICAgIH0KCiAgICAgICAgaWYgKCFjaGFubmVsc1tjaGFubmVsXSkKICAgICAgICAgIGNoYW5uZWxzW2NoYW5uZWxdID0gW10KCiAgICAgICAgdmFyIHB1YmxpayA9IHsKICAgICAgICAgIGF0dGFjaDogZnVuY3Rpb24gKCl7CiAgICAgICAgICAgIGNoYW5uZWxzW2NoYW5uZWxdLnB1c2goc3Vic2NyaXB0aW9uKQogICAgICAgICAgfSwKICAgICAgICAgIGRldGFjaDogZnVuY3Rpb24gKCl7CiAgICAgICAgICAgIGNoYW5uZWxzW2NoYW5uZWxdLnNwbGljZShzbmFjay5pbmRleE9mKGhhbmRsZXIsIGNoYW5uZWxzW2NoYW5uZWxdKSwgMSkKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcHVibGlrLmF0dGFjaCgpCiAgICAgICAgcmV0dXJuIHB1YmxpawogICAgICB9LAoKICAgICAgcHVibGlzaDogZnVuY3Rpb24gKGNoYW5uZWwsIGFyZ3NBcnJheSl7CiAgICAgICAgaWYgKCFjaGFubmVsc1tjaGFubmVsXSkKICAgICAgICAgIHJldHVybiBmYWxzZQoKICAgICAgICBzbmFjay5lYWNoKGNoYW5uZWxzW2NoYW5uZWxdLCBmdW5jdGlvbiAoc3Vic2NyaXB0aW9uKXsKICAgICAgICAgIHN1YnNjcmlwdGlvbi5mbi5hcHBseShzdWJzY3JpcHRpb24uY3R4dCwgYXJnc0FycmF5IHx8IFtdKQogICAgICAgIH0pCgogICAgICAgIHJldHVybiBjaGFubmVsc1tjaGFubmVsXS5sZW5ndGgKICAgICAgfQogICAgfSkKCiAgICByZXR1cm4gb2JqCiAgfQoKICBzbmFjay5wdWJsaXNoZXIoc25hY2spCn0oc25hY2spOwohZnVuY3Rpb24oc25hY2ssIHdpbmRvdywgZG9jdW1lbnQpewogIHNuYWNrLkpTT05QID0gZnVuY3Rpb24ocGFyYW1zLCBjYWxsYmFjayl7CiAgICAvLyBhZGFwdGVkIGZyb20gWmVwdG8KICAgIHZhciBqc29ucFN0cmluZyA9ICdqc29ucCcgKyBzbmFjay5pZCgpCiAgICAgICwgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0JykKICAgICAgLCBydW5uaW5nID0gZmFsc2UKCiAgICAgIHNuYWNrLkpTT05QW2pzb25wU3RyaW5nXSA9IGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHJ1bm5pbmcgPSBmYWxzZQogICAgICAgIGRlbGV0ZSBzbmFjay5KU09OUFtqc29ucFN0cmluZ10KICAgICAgICBjYWxsYmFjayhkYXRhKQogICAgICB9CgogICAgICBpZiAodHlwZW9mIHBhcmFtcy5kYXRhID09ICdvYmplY3QnKQogICAgICAgIHBhcmFtcy5kYXRhID0gc25hY2sudG9RdWVyeVN0cmluZyhwYXJhbXMuZGF0YSkKCiAgICB2YXIgcHVibGlrID0gewogICAgICBzZW5kOiBmdW5jdGlvbiAoKXsKICAgICAgICBydW5uaW5nID0gdHJ1ZQogICAgICAgIHNjcmlwdC5zcmMgPSBwYXJhbXMudXJsICsgJz8nICsgcGFyYW1zLmtleSArICc9c25hY2suSlNPTlAuJyArIGpzb25wU3RyaW5nICsgJyYnICsgcGFyYW1zLmRhdGEKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLmFwcGVuZENoaWxkKHNjcmlwdCkKICAgICAgfSwKCiAgICAgIGNhbmNlbDogZnVuY3Rpb24gKCl7CiAgICAgICAgcnVubmluZyAmJiBzY3JpcHQucGFyZW50Tm9kZSAmJiBzY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpCiAgICAgICAgcnVubmluZyA9IGZhbHNlCiAgICAgICAgc25hY2suSlNPTlBbanNvbnBTdHJpbmddID0gZnVuY3Rpb24gKCl7CiAgICAgICAgICBkZWxldGUgc25hY2suSlNPTlBbanNvbnBTdHJpbmddCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKHBhcmFtcy5ub3cgIT09IGZhbHNlKQogICAgICBwdWJsaWsuc2VuZCgpCgogICAgcmV0dXJuIHB1YmxpawogIH0KCiAgc25hY2sudG9RdWVyeVN0cmluZyA9IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CiAgICAvLyBhZGFwdGVkIGZyb20gTW9vVG9vbHMKICAgIHZhciBxdWVyeVN0cmluZyA9IFtdCgogICAgc25hY2suZWFjaChvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewogICAgICBpZiAoYmFzZSkKICAgICAgICBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nCgogICAgICB2YXIgcmVzdWx0CgogICAgICBpZiAoc25hY2suaXNBcnJheSh2YWx1ZSkpewogICAgICAgIHZhciBxcyA9IHt9CiAgICAgICAgc25hY2suZWFjaCh2YWx1ZSwgZnVuY3Rpb24odmFsLCBpKXsKICAgICAgICAgIHFzW2ldID0gdmFsCiAgICAgICAgfSkKICAgICAgICByZXN1bHQgPSBzbmFjay50b1F1ZXJ5U3RyaW5nKHFzLCBrZXkpCiAgICAgIH0KICAgICAgZWxzZSBpZiAodHlwZW9mIHZhbHVlID09ICdvYmplY3QnKQogICAgICAgIHJlc3VsdCA9IHNuYWNrLnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSkKICAgICAgZWxzZQogICAgICAgIHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkKCiAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCkKICAgICAgICBxdWVyeVN0cmluZy5wdXNoKHJlc3VsdCkKICAgIH0pCgogICAgcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKQogIH0KCiAgdmFyIHhock9iamVjdCA9IChmdW5jdGlvbigpewogICAgLy8gYWRhcHRlZCBmcm9tIE1vb1Rvb2xzCiAgICB2YXIgWE1MSFRUUCA9IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgIH0KCiAgICB2YXIgTVNYTUwyID0gZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNU1hNTDIuWE1MSFRUUCcpOwogICAgfQoKICAgIHZhciBNU1hNTCA9IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTEhUVFAnKTsKICAgIH0KCiAgICB0cnkgewogICAgICBYTUxIVFRQKCkKICAgICAgcmV0dXJuIFhNTEhUVFAKICAgIH0gY2F0Y2ggKGUpewogICAgICB0cnkgewogICAgICAgIE1TWE1MMigpCiAgICAgICAgcmV0dXJuIE1TWE1MMgogICAgICB9IGNhdGNoIChlKXsKICAgICAgICBNU1hNTCgpCiAgICAgICAgcmV0dXJuIE1TWE1MCiAgICAgIH0KICAgIH0KICB9KSgpOwoKICBmdW5jdGlvbiBlbXB0eSgpe30KCiAgc25hY2sucmVxdWVzdCA9IGZ1bmN0aW9uIChvcHRpb25zLCBjYWxsYmFjayl7CiAgICAvLyBhZGFwdGVkIGZyb20gTW9vVG9vbHMKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBzbmFjay5yZXF1ZXN0KSkKICAgICAgcmV0dXJuIG5ldyBzbmFjay5yZXF1ZXN0KG9wdGlvbnMsIGNhbGxiYWNrKQoKICAgIHZhciBzZWxmID0gdGhpcwogICAgc2VsZi5vcHRpb25zID0gc25hY2suZXh0ZW5kKHt9LCBzZWxmLm9wdGlvbnMsIG9wdGlvbnMpCiAgICBzZWxmLmNhbGxiYWNrID0gY2FsbGJhY2sKICAgIHNlbGYueGhyID0gbmV3IHhock9iamVjdAogICAgc2VsZi5oZWFkZXJzID0gc2VsZi5vcHRpb25zLmhlYWRlcnMKICAgIGlmIChzZWxmLm9wdGlvbnMubm93ICE9PSBmYWxzZSkKICAgICAgc2VsZi5zZW5kKCkKICB9CgogIHNuYWNrLnJlcXVlc3QucHJvdG90eXBlID0gewoKICAgIG9wdGlvbnM6IHsvKgogICAgICB1c2VyOiAnJywKICAgICAgcGFzc3dvcmQ6ICcnLCovCiAgICAgIGV4Y2VwdGlvbjogZW1wdHksCiAgICAgIHVybDogJycsCiAgICAgIGRhdGE6ICcnLAogICAgICBtZXRob2Q6ICdnZXQnLAogICAgICBub3c6IHRydWUsCiAgICAgIGhlYWRlcnM6IHsKICAgICAgICAnWC1SZXF1ZXN0ZWQtV2l0aCc6ICdYTUxIdHRwUmVxdWVzdCcsCiAgICAgICAgJ0FjY2VwdCc6ICd0ZXh0L2phdmFzY3JpcHQsIHRleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwogICAgICB9LAogICAgICBhc3luYzogdHJ1ZSwKICAgICAgZW11bGF0aW9uOiB0cnVlLAogICAgICB1cmxFbmNvZGVkOiB0cnVlLAogICAgICBlbmNvZGluZzogJ3V0Zi04JwogICAgfSwKCiAgICBvblN0YXRlQ2hhbmdlOiBmdW5jdGlvbigpewogICAgICB2YXIgc2VsZiA9IHRoaXMKICAgICAgICAsIHhociA9IHNlbGYueGhyCgogICAgICBpZiAoeGhyLnJlYWR5U3RhdGUgIT0gNCB8fCAhc2VsZi5ydW5uaW5nKSByZXR1cm4KICAgICAgc2VsZi5ydW5uaW5nID0gZmFsc2UKICAgICAgc2VsZi5zdGF0dXMgPSAwCgogICAgICB0cnl7CiAgICAgICAgdmFyIHN0YXR1cyA9IHhoci5zdGF0dXMKICAgICAgICBzZWxmLnN0YXR1cyA9IChzdGF0dXMgPT0gMTIyMykgPyAyMDQgOiBzdGF0dXMKICAgICAgfSBjYXRjaChlKSB7fQoKICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5OwoKICAgICAgdmFyIGFyZ3MgPSBzZWxmLnN0YXR1cyA+PSAyMDAgJiYgc2VsZi5zdGF0dXMgPCAzMDAKICAgICAgICA/IFtmYWxzZSwgc2VsZi54aHIucmVzcG9uc2VUZXh0IHx8ICcnLCBzZWxmLnhoci5yZXNwb25zZVhNTF0KICAgICAgICA6IFtzZWxmLnN0YXR1c10KCiAgICAgIHNlbGYuY2FsbGJhY2suYXBwbHkoc2VsZiwgYXJncykKICAgIH0sCiAgCiAgICBzZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKICAgICAgdGhpcy5oZWFkZXJzW25hbWVdID0gdmFsdWU7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICBnZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUpewogICAgICB0cnkgewogICAgICAgIHJldHVybiB0aGlzLnhoci5nZXRSZXNwb25zZUhlYWRlcihuYW1lKQogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICByZXR1cm4gbnVsbAogICAgICB9CiAgICB9LAogIAogICAgc2VuZDogZnVuY3Rpb24oKXsKICAgICAgdmFyIHNlbGYgPSB0aGlzCiAgICAgICAgLCBvcHRpb25zID0gc2VsZi5vcHRpb25zCgogICAgICBpZiAoc2VsZi5ydW5uaW5nKSByZXR1cm4gc2VsZjsKCiAgICAgIHNlbGYucnVubmluZyA9IHRydWU7CgogICAgICB2YXIgZGF0YSA9IG9wdGlvbnMuZGF0YSB8fCAnJwogICAgICAgICwgdXJsID0gU3RyaW5nKG9wdGlvbnMudXJsKQogICAgICAgICwgbWV0aG9kID0gb3B0aW9ucy5tZXRob2QudG9Mb3dlckNhc2UoKQoKICAgICAgaWYgKHR5cGVvZiBkYXRhICE9ICdzdHJpbmcnKQogICAgICAgIGRhdGEgPSBzbmFjay50b1F1ZXJ5U3RyaW5nKGRhdGEpCgogICAgICBpZiAob3B0aW9ucy5lbXVsYXRpb24gJiYgc25hY2suaW5kZXhPZihtZXRob2QsIFsnZ2V0JywgJ3Bvc3QnXSkgPCAwKXsKICAgICAgICB2YXIgX21ldGhvZCA9ICdfbWV0aG9kPScgKyBtZXRob2QKICAgICAgICBkYXRhID0gKGRhdGEpID8gX21ldGhvZCArICcmJyArIGRhdGEgOiBfbWV0aG9kCiAgICAgICAgbWV0aG9kID0gJ3Bvc3QnCiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnVybEVuY29kZWQgJiYgc25hY2suaW5kZXhPZihtZXRob2QsIFsncG9zdCcsICdwdXQnXSkgPiAtMSl7CiAgICAgICAgdmFyIGVuY29kaW5nID0gKG9wdGlvbnMuZW5jb2RpbmcpID8gJzsgY2hhcnNldD0nICsgb3B0aW9ucy5lbmNvZGluZyA6ICcnCiAgICAgICAgc2VsZi5oZWFkZXJzWydDb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnICsgZW5jb2RpbmcKICAgICAgfQoKICAgICAgaWYgKCF1cmwpCiAgICAgICAgdXJsID0gZG9jdW1lbnQubG9jYXRpb24ucGF0aG5hbWUKCiAgICAgIHZhciB0cmltUG9zaXRpb24gPSB1cmwubGFzdEluZGV4T2YoJy8nKQogICAgICBpZiAodHJpbVBvc2l0aW9uID4gLTEgJiYgKHRyaW1Qb3NpdGlvbiA9IHVybC5pbmRleE9mKCcjJykpID4gLTEpCiAgICAgICAgdXJsID0gdXJsLnN1YnN0cigwLCB0cmltUG9zaXRpb24pCgogICAgICBpZiAoZGF0YSAmJiBtZXRob2QgPT0gJ2dldCcpewogICAgICAgIHVybCArPSAodXJsLmluZGV4T2YoJz8nKSA+IC0xID8gJyYnIDogJz8nKSArIGRhdGEKICAgICAgICBkYXRhID0gbnVsbAogICAgICB9CgogICAgICB2YXIgeGhyID0gc2VsZi54aHIKCiAgICAgIHhoci5vcGVuKG1ldGhvZC50b1VwcGVyQ2FzZSgpLCB1cmwsIG9wZW4uYXN5bmMsIG9wdGlvbnMudXNlciwgb3B0aW9ucy5wYXNzd29yZCkKICAgICAgaWYgKG9wdGlvbnMudXNlciAmJiAnd2l0aENyZWRlbnRpYWxzJyBpbiB4aHIpIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlCiAgICAKICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHNuYWNrLmJpbmQoc2VsZi5vblN0YXRlQ2hhbmdlLCBzZWxmKQoKICAgICAgZm9yICh2YXIgaSBpbiBzZWxmLmhlYWRlcnMpewogICAgICAgIHRyeSB7CiAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihpLCBzZWxmLmhlYWRlcnNbaV0pCiAgICAgICAgfSBjYXRjaCAoZSl7CiAgICAgICAgICBvcHRpb25zLmV4Y2VwdGlvbi5hcHBseShzZWxmLCBbaSwgc2VsZi5oZWFkZXJzW2ldXSkKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHhoci5zZW5kKGRhdGEpCiAgICAgIGlmICghb3B0aW9ucy5hc3luYykgc2VsZi5vblN0YXRlQ2hhbmdlKCkKICAgIAogICAgICByZXR1cm4gc2VsZgogICAgfSwKCiAgICBjYW5jZWw6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzZWxmID0gdGhpcwoKICAgICAgaWYgKCFzZWxmLnJ1bm5pbmcpCiAgICAgICAgcmV0dXJuIHNlbGYKCiAgICAgIHNlbGYucnVubmluZyA9IGZhbHNlCgogICAgICB2YXIgeGhyID0gc2VsZi54aHIKICAgICAgeGhyLmFib3J0KCkKCiAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eQoKICAgICAgc2VsZi54aHIgPSBuZXcgeGhyT2JqZWN0KCkKICAgICAgcmV0dXJuIHNlbGYKICAgIH0KICB9Cn0oc25hY2ssIHdpbmRvdywgZG9jdW1lbnQpCiFmdW5jdGlvbihzbmFjaywgZG9jdW1lbnQpewogIHNuYWNrLndyYXAuZGVmaW5lKHsKICAgIGRhdGE6IGZ1bmN0aW9uICgpewogICAgICAvLyBBUEkgaW5zcGlyZWQgYnkgalF1ZXJ5CiAgICAgIHZhciBzdG9yYWdlID0ge30KCiAgICAgIHJldHVybiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSl7CiAgICAgICAgdmFyIGRhdGEgPSBzdG9yYWdlW3RoaXMuaWRdCgogICAgICAgIGlmICghZGF0YSkKICAgICAgICAgIGRhdGEgPSBzdG9yYWdlW3RoaXMuaWRdID0ge30KCiAgICAgICAgaWYgKHZhbHVlID09PSB2b2lkKzEpCiAgICAgICAgICByZXR1cm4gZGF0YVtrZXldCgogICAgICAgIHJldHVybiBkYXRhW2tleV0gPSB2YWx1ZQogICAgICB9ICAKICAgIH0oKSwKCiAgICBlYWNoOiBmdW5jdGlvbiAoZm4sIGNvbnRleHQpewogICAgICByZXR1cm4gc25hY2suZWFjaCh0aGlzLCBmbiwgY29udGV4dCkKICAgIH0sCiAgCiAgICBhZGRDbGFzczogZnVuY3Rpb24gKGNsYXNzTmFtZSl7CiAgICAgIC8vIGFkYXB0ZWQgZnJvbSBNb29Ub29scwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChlbGVtZW50KXsKICAgICAgICBpZiAoY2xlYW4oZWxlbWVudC5jbGFzc05hbWUpLmluZGV4T2YoY2xhc3NOYW1lKSA+IC0xKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBjbGVhbihlbGVtZW50LmNsYXNzTmFtZSArICcgJyArIGNsYXNzTmFtZSkKICAgICAgfSkKICAgIH0sCgogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChjbGFzc05hbWUpewogICAgICAvLyBhZGFwdGVkIGZyb20gTW9vVG9vbHMKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoZWxlbWVudCl7CiAgICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBlbGVtZW50LmNsYXNzTmFtZS5yZXBsYWNlKG5ldyBSZWdFeHAoJyhefFxccyknICsgY2xhc3NOYW1lICsgJyg/Olxcc3wkKScpLCAnJDEnKQogICAgICB9KQogICAgfSwKCiAgICBhdHRhY2g6IGZ1bmN0aW9uIChldmVudCwgaGFuZGxlciwgLyogaW50ZXJuYWwgKi8gZGVsZWdhdGlvbil7CiAgICAgIHZhciBzcGxpdCA9IGV2ZW50LnNwbGl0KCcuJykKICAgICAgICAsIGxpc3RlbmVycyA9IFtdCgogICAgICBpZiAoc3BsaXRbMV0pCiAgICAgICAgbGlzdGVuZXJzID0gdGhpcy5kYXRhKHNwbGl0WzFdKSB8fCBbXQoKICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKG5vZGUpewogICAgICAgIHZhciBwYXJhbXMgPSB7CiAgICAgICAgICBub2RlOiBub2RlLAogICAgICAgICAgZXZlbnQ6IHNwbGl0WzBdCiAgICAgICAgfQoKICAgICAgICBpZiAoZGVsZWdhdGlvbikKICAgICAgICAgIHBhcmFtcy5kZWxlZ2F0ZSA9IGRlbGVnYXRpb24KCiAgICAgICAgbGlzdGVuZXJzLnB1c2goc25hY2subGlzdGVuZXIocGFyYW1zLCBoYW5kbGVyKSkKICAgICAgfSkKCiAgICAgIGlmIChzcGxpdFsxXSkKICAgICAgICB0aGlzLmRhdGEoc3BsaXRbMV0sIGxpc3RlbmVycykKCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAoKICAgIGRldGFjaDogZnVuY3Rpb24gKG5hbWVzcGFjZSl7CiAgICAgIGxpc3RlbmVyTWV0aG9kKHRoaXMsICdkZXRhY2gnLCBuYW1lc3BhY2UsIG51bGwsIHRydWUpCiAgICAgIHRoaXMuZGF0YShuYW1lc3BhY2UsIG51bGwpCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAoKICAgIGZpcmU6IGZ1bmN0aW9uIChuYW1lc3BhY2UsIGFyZ3MpewogICAgICByZXR1cm4gbGlzdGVuZXJNZXRob2QodGhpcywgJ2ZpcmUnLCBuYW1lc3BhY2UsIGFyZ3MpCiAgICB9LAoKICAgIGRlbGVnYXRlOiBmdW5jdGlvbiAoZXZlbnQsIGRlbGVnYXRpb24sIGhhbmRsZXIpewogICAgICByZXR1cm4gdGhpcy5hdHRhY2goZXZlbnQsIGhhbmRsZXIsIGRlbGVnYXRpb24pCiAgICB9CiAgfSkKCiAgZnVuY3Rpb24gY2xlYW4oc3RyKXsKICAgIHJldHVybiBzdHIucmVwbGFjZSgvXHMrL2csICcgJykucmVwbGFjZSgvXlxzK3xccyskL2csICcnKQogIH0KCiAgZnVuY3Rpb24gbGlzdGVuZXJNZXRob2Qod3JhcHBlciwgbWV0aG9kLCBuYW1lc3BhY2UsIGFyZ3MpewogICAgdmFyIGRhdGEgPSB3cmFwcGVyLmRhdGEobmFtZXNwYWNlKQoKICAgIGlmIChkYXRhKQogICAgICBzbmFjay5lYWNoKGRhdGEsIGZ1bmN0aW9uIChsaXN0ZW5lcil7CiAgICAgICAgbGlzdGVuZXJbbWV0aG9kXS5hcHBseSh3cmFwcGVyLCBhcmdzKQogICAgICB9KQoKICAgIHJldHVybiB3cmFwcGVyCiAgfQp9KHNuYWNrLCBkb2N1bWVudCk7Ci8qIQogKiBTaXp6bGUgQ1NTIFNlbGVjdG9yIEVuZ2luZQogKiAgQ29weXJpZ2h0IDIwMTEsIFRoZSBEb2pvIEZvdW5kYXRpb24KICogIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQsIEJTRCwgYW5kIEdQTCBMaWNlbnNlcy4KICogIE1vcmUgaW5mb3JtYXRpb246IGh0dHA6Ly9zaXp6bGVqcy5jb20vCiAqLwooZnVuY3Rpb24oKXsKCnZhciBjaHVua2VyID0gLygoPzpcKCg/OlwoW14oKV0rXCl8W14oKV0rKStcKXxcWyg/OlxbW15cW1xdXSpcXXxbJyJdW14nIl0qWyciXXxbXlxbXF0nIl0rKStcXXxcXC58W14gPit+LChcW1xcXSspK3xbPit+XSkoXHMqLFxzKik/KCg/Oi58XHJ8XG4pKikvZywKCWRvbmUgPSAwLAoJdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLAoJaGFzRHVwbGljYXRlID0gZmFsc2UsCgliYXNlSGFzRHVwbGljYXRlID0gdHJ1ZSwKCXJCYWNrc2xhc2ggPSAvXFwvZywKCXJOb25Xb3JkID0gL1xXLzsKCi8vIEhlcmUgd2UgY2hlY2sgaWYgdGhlIEphdmFTY3JpcHQgZW5naW5lIGlzIHVzaW5nIHNvbWUgc29ydCBvZgovLyBvcHRpbWl6YXRpb24gd2hlcmUgaXQgZG9lcyBub3QgYWx3YXlzIGNhbGwgb3VyIGNvbXBhcmlzaW9uCi8vIGZ1bmN0aW9uLiBJZiB0aGF0IGlzIHRoZSBjYXNlLCBkaXNjYXJkIHRoZSBoYXNEdXBsaWNhdGUgdmFsdWUuCi8vICAgVGh1cyBmYXIgdGhhdCBpbmNsdWRlcyBHb29nbGUgQ2hyb21lLgpbMCwgMF0uc29ydChmdW5jdGlvbigpIHsKCWJhc2VIYXNEdXBsaWNhdGUgPSBmYWxzZTsKCXJldHVybiAwOwp9KTsKCnZhciBTaXp6bGUgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKSB7CglyZXN1bHRzID0gcmVzdWx0cyB8fCBbXTsKCWNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50OwoKCXZhciBvcmlnQ29udGV4dCA9IGNvbnRleHQ7CgoJaWYgKCBjb250ZXh0Lm5vZGVUeXBlICE9PSAxICYmIGNvbnRleHQubm9kZVR5cGUgIT09IDkgKSB7CgkJcmV0dXJuIFtdOwoJfQoJCglpZiAoICFzZWxlY3RvciB8fCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCXJldHVybiByZXN1bHRzOwoJfQoKCXZhciBtLCBzZXQsIGNoZWNrU2V0LCBleHRyYSwgcmV0LCBjdXIsIHBvcCwgaSwKCQlwcnVuZSA9IHRydWUsCgkJY29udGV4dFhNTCA9IFNpenpsZS5pc1hNTCggY29udGV4dCApLAoJCXBhcnRzID0gW10sCgkJc29GYXIgPSBzZWxlY3RvcjsKCQoJLy8gUmVzZXQgdGhlIHBvc2l0aW9uIG9mIHRoZSBjaHVua2VyIHJlZ2V4cCAoc3RhcnQgZnJvbSBoZWFkKQoJZG8gewoJCWNodW5rZXIuZXhlYyggIiIgKTsKCQltID0gY2h1bmtlci5leGVjKCBzb0ZhciApOwoKCQlpZiAoIG0gKSB7CgkJCXNvRmFyID0gbVszXTsKCQkKCQkJcGFydHMucHVzaCggbVsxXSApOwoJCQoJCQlpZiAoIG1bMl0gKSB7CgkJCQlleHRyYSA9IG1bM107CgkJCQlicmVhazsKCQkJfQoJCX0KCX0gd2hpbGUgKCBtICk7CgoJaWYgKCBwYXJ0cy5sZW5ndGggPiAxICYmIG9yaWdQT1MuZXhlYyggc2VsZWN0b3IgKSApIHsKCgkJaWYgKCBwYXJ0cy5sZW5ndGggPT09IDIgJiYgRXhwci5yZWxhdGl2ZVsgcGFydHNbMF0gXSApIHsKCQkJc2V0ID0gcG9zUHJvY2VzcyggcGFydHNbMF0gKyBwYXJ0c1sxXSwgY29udGV4dCApOwoKCQl9IGVsc2UgewoJCQlzZXQgPSBFeHByLnJlbGF0aXZlWyBwYXJ0c1swXSBdID8KCQkJCVsgY29udGV4dCBdIDoKCQkJCVNpenpsZSggcGFydHMuc2hpZnQoKSwgY29udGV4dCApOwoKCQkJd2hpbGUgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQlzZWxlY3RvciA9IHBhcnRzLnNoaWZ0KCk7CgoJCQkJaWYgKCBFeHByLnJlbGF0aXZlWyBzZWxlY3RvciBdICkgewoJCQkJCXNlbGVjdG9yICs9IHBhcnRzLnNoaWZ0KCk7CgkJCQl9CgkJCQkKCQkJCXNldCA9IHBvc1Byb2Nlc3MoIHNlbGVjdG9yLCBzZXQgKTsKCQkJfQoJCX0KCgl9IGVsc2UgewoJCS8vIFRha2UgYSBzaG9ydGN1dCBhbmQgc2V0IHRoZSBjb250ZXh0IGlmIHRoZSByb290IHNlbGVjdG9yIGlzIGFuIElECgkJLy8gKGJ1dCBub3QgaWYgaXQnbGwgYmUgZmFzdGVyIGlmIHRoZSBpbm5lciBzZWxlY3RvciBpcyBhbiBJRCkKCQlpZiAoICFzZWVkICYmIHBhcnRzLmxlbmd0aCA+IDEgJiYgY29udGV4dC5ub2RlVHlwZSA9PT0gOSAmJiAhY29udGV4dFhNTCAmJgoJCQkJRXhwci5tYXRjaC5JRC50ZXN0KHBhcnRzWzBdKSAmJiAhRXhwci5tYXRjaC5JRC50ZXN0KHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdKSApIHsKCgkJCXJldCA9IFNpenpsZS5maW5kKCBwYXJ0cy5zaGlmdCgpLCBjb250ZXh0LCBjb250ZXh0WE1MICk7CgkJCWNvbnRleHQgPSByZXQuZXhwciA/CgkJCQlTaXp6bGUuZmlsdGVyKCByZXQuZXhwciwgcmV0LnNldCApWzBdIDoKCQkJCXJldC5zZXRbMF07CgkJfQoKCQlpZiAoIGNvbnRleHQgKSB7CgkJCXJldCA9IHNlZWQgPwoJCQkJeyBleHByOiBwYXJ0cy5wb3AoKSwgc2V0OiBtYWtlQXJyYXkoc2VlZCkgfSA6CgkJCQlTaXp6bGUuZmluZCggcGFydHMucG9wKCksIHBhcnRzLmxlbmd0aCA9PT0gMSAmJiAocGFydHNbMF0gPT09ICJ+IiB8fCBwYXJ0c1swXSA9PT0gIisiKSAmJiBjb250ZXh0LnBhcmVudE5vZGUgPyBjb250ZXh0LnBhcmVudE5vZGUgOiBjb250ZXh0LCBjb250ZXh0WE1MICk7CgoJCQlzZXQgPSByZXQuZXhwciA/CgkJCQlTaXp6bGUuZmlsdGVyKCByZXQuZXhwciwgcmV0LnNldCApIDoKCQkJCXJldC5zZXQ7CgoJCQlpZiAoIHBhcnRzLmxlbmd0aCA+IDAgKSB7CgkJCQljaGVja1NldCA9IG1ha2VBcnJheSggc2V0ICk7CgoJCQl9IGVsc2UgewoJCQkJcHJ1bmUgPSBmYWxzZTsKCQkJfQoKCQkJd2hpbGUgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQljdXIgPSBwYXJ0cy5wb3AoKTsKCQkJCXBvcCA9IGN1cjsKCgkJCQlpZiAoICFFeHByLnJlbGF0aXZlWyBjdXIgXSApIHsKCQkJCQljdXIgPSAiIjsKCQkJCX0gZWxzZSB7CgkJCQkJcG9wID0gcGFydHMucG9wKCk7CgkJCQl9CgoJCQkJaWYgKCBwb3AgPT0gbnVsbCApIHsKCQkJCQlwb3AgPSBjb250ZXh0OwoJCQkJfQoKCQkJCUV4cHIucmVsYXRpdmVbIGN1ciBdKCBjaGVja1NldCwgcG9wLCBjb250ZXh0WE1MICk7CgkJCX0KCgkJfSBlbHNlIHsKCQkJY2hlY2tTZXQgPSBwYXJ0cyA9IFtdOwoJCX0KCX0KCglpZiAoICFjaGVja1NldCApIHsKCQljaGVja1NldCA9IHNldDsKCX0KCglpZiAoICFjaGVja1NldCApIHsKCQlTaXp6bGUuZXJyb3IoIGN1ciB8fCBzZWxlY3RvciApOwoJfQoKCWlmICggdG9TdHJpbmcuY2FsbChjaGVja1NldCkgPT09ICJbb2JqZWN0IEFycmF5XSIgKSB7CgkJaWYgKCAhcHJ1bmUgKSB7CgkJCXJlc3VsdHMucHVzaC5hcHBseSggcmVzdWx0cywgY2hlY2tTZXQgKTsKCgkJfSBlbHNlIGlmICggY29udGV4dCAmJiBjb250ZXh0Lm5vZGVUeXBlID09PSAxICkgewoJCQlmb3IgKCBpID0gMDsgY2hlY2tTZXRbaV0gIT0gbnVsbDsgaSsrICkgewoJCQkJaWYgKCBjaGVja1NldFtpXSAmJiAoY2hlY2tTZXRbaV0gPT09IHRydWUgfHwgY2hlY2tTZXRbaV0ubm9kZVR5cGUgPT09IDEgJiYgU2l6emxlLmNvbnRhaW5zKGNvbnRleHQsIGNoZWNrU2V0W2ldKSkgKSB7CgkJCQkJcmVzdWx0cy5wdXNoKCBzZXRbaV0gKTsKCQkJCX0KCQkJfQoKCQl9IGVsc2UgewoJCQlmb3IgKCBpID0gMDsgY2hlY2tTZXRbaV0gIT0gbnVsbDsgaSsrICkgewoJCQkJaWYgKCBjaGVja1NldFtpXSAmJiBjaGVja1NldFtpXS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJCQlyZXN1bHRzLnB1c2goIHNldFtpXSApOwoJCQkJfQoJCQl9CgkJfQoKCX0gZWxzZSB7CgkJbWFrZUFycmF5KCBjaGVja1NldCwgcmVzdWx0cyApOwoJfQoKCWlmICggZXh0cmEgKSB7CgkJU2l6emxlKCBleHRyYSwgb3JpZ0NvbnRleHQsIHJlc3VsdHMsIHNlZWQgKTsKCQlTaXp6bGUudW5pcXVlU29ydCggcmVzdWx0cyApOwoJfQoKCXJldHVybiByZXN1bHRzOwp9OwoKU2l6emxlLnVuaXF1ZVNvcnQgPSBmdW5jdGlvbiggcmVzdWx0cyApIHsKCWlmICggc29ydE9yZGVyICkgewoJCWhhc0R1cGxpY2F0ZSA9IGJhc2VIYXNEdXBsaWNhdGU7CgkJcmVzdWx0cy5zb3J0KCBzb3J0T3JkZXIgKTsKCgkJaWYgKCBoYXNEdXBsaWNhdGUgKSB7CgkJCWZvciAoIHZhciBpID0gMTsgaSA8IHJlc3VsdHMubGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIHJlc3VsdHNbaV0gPT09IHJlc3VsdHNbIGkgLSAxIF0gKSB7CgkJCQkJcmVzdWx0cy5zcGxpY2UoIGktLSwgMSApOwoJCQkJfQoJCQl9CgkJfQoJfQoKCXJldHVybiByZXN1bHRzOwp9OwoKU2l6emxlLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJcmV0dXJuIFNpenpsZSggZXhwciwgbnVsbCwgbnVsbCwgc2V0ICk7Cn07CgpTaXp6bGUubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CglyZXR1cm4gU2l6emxlKCBleHByLCBudWxsLCBudWxsLCBbbm9kZV0gKS5sZW5ndGggPiAwOwp9OwoKU2l6emxlLmZpbmQgPSBmdW5jdGlvbiggZXhwciwgY29udGV4dCwgaXNYTUwgKSB7Cgl2YXIgc2V0OwoKCWlmICggIWV4cHIgKSB7CgkJcmV0dXJuIFtdOwoJfQoKCWZvciAoIHZhciBpID0gMCwgbCA9IEV4cHIub3JkZXIubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCXZhciBtYXRjaCwKCQkJdHlwZSA9IEV4cHIub3JkZXJbaV07CgkJCgkJaWYgKCAobWF0Y2ggPSBFeHByLmxlZnRNYXRjaFsgdHlwZSBdLmV4ZWMoIGV4cHIgKSkgKSB7CgkJCXZhciBsZWZ0ID0gbWF0Y2hbMV07CgkJCW1hdGNoLnNwbGljZSggMSwgMSApOwoKCQkJaWYgKCBsZWZ0LnN1YnN0ciggbGVmdC5sZW5ndGggLSAxICkgIT09ICJcXCIgKSB7CgkJCQltYXRjaFsxXSA9IChtYXRjaFsxXSB8fCAiIikucmVwbGFjZSggckJhY2tzbGFzaCwgIiIgKTsKCQkJCXNldCA9IEV4cHIuZmluZFsgdHlwZSBdKCBtYXRjaCwgY29udGV4dCwgaXNYTUwgKTsKCgkJCQlpZiAoIHNldCAhPSBudWxsICkgewoJCQkJCWV4cHIgPSBleHByLnJlcGxhY2UoIEV4cHIubWF0Y2hbIHR5cGUgXSwgIiIgKTsKCQkJCQlicmVhazsKCQkJCX0KCQkJfQoJCX0KCX0KCglpZiAoICFzZXQgKSB7CgkJc2V0ID0gdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiID8KCQkJY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggIioiICkgOgoJCQlbXTsKCX0KCglyZXR1cm4geyBzZXQ6IHNldCwgZXhwcjogZXhwciB9Owp9OwoKU2l6emxlLmZpbHRlciA9IGZ1bmN0aW9uKCBleHByLCBzZXQsIGlucGxhY2UsIG5vdCApIHsKCXZhciBtYXRjaCwgYW55Rm91bmQsCgkJb2xkID0gZXhwciwKCQlyZXN1bHQgPSBbXSwKCQljdXJMb29wID0gc2V0LAoJCWlzWE1MRmlsdGVyID0gc2V0ICYmIHNldFswXSAmJiBTaXp6bGUuaXNYTUwoIHNldFswXSApOwoKCXdoaWxlICggZXhwciAmJiBzZXQubGVuZ3RoICkgewoJCWZvciAoIHZhciB0eXBlIGluIEV4cHIuZmlsdGVyICkgewoJCQlpZiAoIChtYXRjaCA9IEV4cHIubGVmdE1hdGNoWyB0eXBlIF0uZXhlYyggZXhwciApKSAhPSBudWxsICYmIG1hdGNoWzJdICkgewoJCQkJdmFyIGZvdW5kLCBpdGVtLAoJCQkJCWZpbHRlciA9IEV4cHIuZmlsdGVyWyB0eXBlIF0sCgkJCQkJbGVmdCA9IG1hdGNoWzFdOwoKCQkJCWFueUZvdW5kID0gZmFsc2U7CgoJCQkJbWF0Y2guc3BsaWNlKDEsMSk7CgoJCQkJaWYgKCBsZWZ0LnN1YnN0ciggbGVmdC5sZW5ndGggLSAxICkgPT09ICJcXCIgKSB7CgkJCQkJY29udGludWU7CgkJCQl9CgoJCQkJaWYgKCBjdXJMb29wID09PSByZXN1bHQgKSB7CgkJCQkJcmVzdWx0ID0gW107CgkJCQl9CgoJCQkJaWYgKCBFeHByLnByZUZpbHRlclsgdHlwZSBdICkgewoJCQkJCW1hdGNoID0gRXhwci5wcmVGaWx0ZXJbIHR5cGUgXSggbWF0Y2gsIGN1ckxvb3AsIGlucGxhY2UsIHJlc3VsdCwgbm90LCBpc1hNTEZpbHRlciApOwoKCQkJCQlpZiAoICFtYXRjaCApIHsKCQkJCQkJYW55Rm91bmQgPSBmb3VuZCA9IHRydWU7CgoJCQkJCX0gZWxzZSBpZiAoIG1hdGNoID09PSB0cnVlICkgewoJCQkJCQljb250aW51ZTsKCQkJCQl9CgkJCQl9CgoJCQkJaWYgKCBtYXRjaCApIHsKCQkJCQlmb3IgKCB2YXIgaSA9IDA7IChpdGVtID0gY3VyTG9vcFtpXSkgIT0gbnVsbDsgaSsrICkgewoJCQkJCQlpZiAoIGl0ZW0gKSB7CgkJCQkJCQlmb3VuZCA9IGZpbHRlciggaXRlbSwgbWF0Y2gsIGksIGN1ckxvb3AgKTsKCQkJCQkJCXZhciBwYXNzID0gbm90IF4gISFmb3VuZDsKCgkJCQkJCQlpZiAoIGlucGxhY2UgJiYgZm91bmQgIT0gbnVsbCApIHsKCQkJCQkJCQlpZiAoIHBhc3MgKSB7CgkJCQkJCQkJCWFueUZvdW5kID0gdHJ1ZTsKCgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJY3VyTG9vcFtpXSA9IGZhbHNlOwoJCQkJCQkJCX0KCgkJCQkJCQl9IGVsc2UgaWYgKCBwYXNzICkgewoJCQkJCQkJCXJlc3VsdC5wdXNoKCBpdGVtICk7CgkJCQkJCQkJYW55Rm91bmQgPSB0cnVlOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCWlmICggZm91bmQgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlpZiAoICFpbnBsYWNlICkgewoJCQkJCQljdXJMb29wID0gcmVzdWx0OwoJCQkJCX0KCgkJCQkJZXhwciA9IGV4cHIucmVwbGFjZSggRXhwci5tYXRjaFsgdHlwZSBdLCAiIiApOwoKCQkJCQlpZiAoICFhbnlGb3VuZCApIHsKCQkJCQkJcmV0dXJuIFtdOwoJCQkJCX0KCgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIEltcHJvcGVyIGV4cHJlc3Npb24KCQlpZiAoIGV4cHIgPT09IG9sZCApIHsKCQkJaWYgKCBhbnlGb3VuZCA9PSBudWxsICkgewoJCQkJU2l6emxlLmVycm9yKCBleHByICk7CgoJCQl9IGVsc2UgewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCW9sZCA9IGV4cHI7Cgl9CgoJcmV0dXJuIGN1ckxvb3A7Cn07CgpTaXp6bGUuZXJyb3IgPSBmdW5jdGlvbiggbXNnICkgewoJdGhyb3cgIlN5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICIgKyBtc2c7Cn07Cgp2YXIgRXhwciA9IFNpenpsZS5zZWxlY3RvcnMgPSB7CglvcmRlcjogWyAiSUQiLCAiTkFNRSIsICJUQUciIF0sCgoJbWF0Y2g6IHsKCQlJRDogLyMoKD86W1x3XHUwMGMwLVx1RkZGRlwtXXxcXC4pKykvLAoJCUNMQVNTOiAvXC4oKD86W1x3XHUwMGMwLVx1RkZGRlwtXXxcXC4pKykvLAoJCU5BTUU6IC9cW25hbWU9WyciXSooKD86W1x3XHUwMGMwLVx1RkZGRlwtXXxcXC4pKylbJyJdKlxdLywKCQlBVFRSOiAvXFtccyooKD86W1x3XHUwMGMwLVx1RkZGRlwtXXxcXC4pKylccyooPzooXFM/PSlccyooPzooWyciXSkoLio/KVwzfCgjPyg/Oltcd1x1MDBjMC1cdUZGRkZcLV18XFwuKSopfCl8KVxzKlxdLywKCQlUQUc6IC9eKCg/Oltcd1x1MDBjMC1cdUZGRkZcKlwtXXxcXC4pKykvLAoJCUNISUxEOiAvOihvbmx5fG50aHxsYXN0fGZpcnN0KS1jaGlsZCg/OlwoXHMqKGV2ZW58b2RkfCg/OlsrXC1dP1xkK3woPzpbK1wtXT9cZCopP25ccyooPzpbK1wtXVxzKlxkKyk/KSlccypcKSk/LywKCQlQT1M6IC86KG50aHxlcXxndHxsdHxmaXJzdHxsYXN0fGV2ZW58b2RkKSg/OlwoKFxkKilcKSk/KD89W15cLV18JCkvLAoJCVBTRVVETzogLzooKD86W1x3XHUwMGMwLVx1RkZGRlwtXXxcXC4pKykoPzpcKChbJyJdPykoKD86XChbXlwpXStcKXxbXlwoXCldKikrKVwyXCkpPy8KCX0sCgoJbGVmdE1hdGNoOiB7fSwKCglhdHRyTWFwOiB7CgkJImNsYXNzIjogImNsYXNzTmFtZSIsCgkJImZvciI6ICJodG1sRm9yIgoJfSwKCglhdHRySGFuZGxlOiB7CgkJaHJlZjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggImhyZWYiICk7CgkJfSwKCQl0eXBlOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCAidHlwZSIgKTsKCQl9Cgl9LAoKCXJlbGF0aXZlOiB7CgkJIisiOiBmdW5jdGlvbihjaGVja1NldCwgcGFydCl7CgkJCXZhciBpc1BhcnRTdHIgPSB0eXBlb2YgcGFydCA9PT0gInN0cmluZyIsCgkJCQlpc1RhZyA9IGlzUGFydFN0ciAmJiAhck5vbldvcmQudGVzdCggcGFydCApLAoJCQkJaXNQYXJ0U3RyTm90VGFnID0gaXNQYXJ0U3RyICYmICFpc1RhZzsKCgkJCWlmICggaXNUYWcgKSB7CgkJCQlwYXJ0ID0gcGFydC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlmb3IgKCB2YXIgaSA9IDAsIGwgPSBjaGVja1NldC5sZW5ndGgsIGVsZW07IGkgPCBsOyBpKysgKSB7CgkJCQlpZiAoIChlbGVtID0gY2hlY2tTZXRbaV0pICkgewoJCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtLnByZXZpb3VzU2libGluZykgJiYgZWxlbS5ub2RlVHlwZSAhPT0gMSApIHt9CgoJCQkJCWNoZWNrU2V0W2ldID0gaXNQYXJ0U3RyTm90VGFnIHx8IGVsZW0gJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBwYXJ0ID8KCQkJCQkJZWxlbSB8fCBmYWxzZSA6CgkJCQkJCWVsZW0gPT09IHBhcnQ7CgkJCQl9CgkJCX0KCgkJCWlmICggaXNQYXJ0U3RyTm90VGFnICkgewoJCQkJU2l6emxlLmZpbHRlciggcGFydCwgY2hlY2tTZXQsIHRydWUgKTsKCQkJfQoJCX0sCgoJCSI+IjogZnVuY3Rpb24oIGNoZWNrU2V0LCBwYXJ0ICkgewoJCQl2YXIgZWxlbSwKCQkJCWlzUGFydFN0ciA9IHR5cGVvZiBwYXJ0ID09PSAic3RyaW5nIiwKCQkJCWkgPSAwLAoJCQkJbCA9IGNoZWNrU2V0Lmxlbmd0aDsKCgkJCWlmICggaXNQYXJ0U3RyICYmICFyTm9uV29yZC50ZXN0KCBwYXJ0ICkgKSB7CgkJCQlwYXJ0ID0gcGFydC50b0xvd2VyQ2FzZSgpOwoKCQkJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJCQllbGVtID0gY2hlY2tTZXRbaV07CgoJCQkJCWlmICggZWxlbSApIHsKCQkJCQkJdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCQkJCQkJY2hlY2tTZXRbaV0gPSBwYXJlbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gcGFydCA/IHBhcmVudCA6IGZhbHNlOwoJCQkJCX0KCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCQkJZWxlbSA9IGNoZWNrU2V0W2ldOwoKCQkJCQlpZiAoIGVsZW0gKSB7CgkJCQkJCWNoZWNrU2V0W2ldID0gaXNQYXJ0U3RyID8KCQkJCQkJCWVsZW0ucGFyZW50Tm9kZSA6CgkJCQkJCQllbGVtLnBhcmVudE5vZGUgPT09IHBhcnQ7CgkJCQkJfQoJCQkJfQoKCQkJCWlmICggaXNQYXJ0U3RyICkgewoJCQkJCVNpenpsZS5maWx0ZXIoIHBhcnQsIGNoZWNrU2V0LCB0cnVlICk7CgkJCQl9CgkJCX0KCQl9LAoKCQkiIjogZnVuY3Rpb24oY2hlY2tTZXQsIHBhcnQsIGlzWE1MKXsKCQkJdmFyIG5vZGVDaGVjaywKCQkJCWRvbmVOYW1lID0gZG9uZSsrLAoJCQkJY2hlY2tGbiA9IGRpckNoZWNrOwoKCQkJaWYgKCB0eXBlb2YgcGFydCA9PT0gInN0cmluZyIgJiYgIXJOb25Xb3JkLnRlc3QoIHBhcnQgKSApIHsKCQkJCXBhcnQgPSBwYXJ0LnRvTG93ZXJDYXNlKCk7CgkJCQlub2RlQ2hlY2sgPSBwYXJ0OwoJCQkJY2hlY2tGbiA9IGRpck5vZGVDaGVjazsKCQkJfQoKCQkJY2hlY2tGbiggInBhcmVudE5vZGUiLCBwYXJ0LCBkb25lTmFtZSwgY2hlY2tTZXQsIG5vZGVDaGVjaywgaXNYTUwgKTsKCQl9LAoKCQkifiI6IGZ1bmN0aW9uKCBjaGVja1NldCwgcGFydCwgaXNYTUwgKSB7CgkJCXZhciBub2RlQ2hlY2ssCgkJCQlkb25lTmFtZSA9IGRvbmUrKywKCQkJCWNoZWNrRm4gPSBkaXJDaGVjazsKCgkJCWlmICggdHlwZW9mIHBhcnQgPT09ICJzdHJpbmciICYmICFyTm9uV29yZC50ZXN0KCBwYXJ0ICkgKSB7CgkJCQlwYXJ0ID0gcGFydC50b0xvd2VyQ2FzZSgpOwoJCQkJbm9kZUNoZWNrID0gcGFydDsKCQkJCWNoZWNrRm4gPSBkaXJOb2RlQ2hlY2s7CgkJCX0KCgkJCWNoZWNrRm4oICJwcmV2aW91c1NpYmxpbmciLCBwYXJ0LCBkb25lTmFtZSwgY2hlY2tTZXQsIG5vZGVDaGVjaywgaXNYTUwgKTsKCQl9Cgl9LAoKCWZpbmQ6IHsKCQlJRDogZnVuY3Rpb24oIG1hdGNoLCBjb250ZXh0LCBpc1hNTCApIHsKCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50QnlJZCAhPT0gInVuZGVmaW5lZCIgJiYgIWlzWE1MICkgewoJCQkJdmFyIG0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKG1hdGNoWzFdKTsKCQkJCS8vIENoZWNrIHBhcmVudE5vZGUgdG8gY2F0Y2ggd2hlbiBCbGFja2JlcnJ5IDQuNiByZXR1cm5zCgkJCQkvLyBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIGRvY3VtZW50ICM2OTYzCgkJCQlyZXR1cm4gbSAmJiBtLnBhcmVudE5vZGUgPyBbbV0gOiBbXTsKCQkJfQoJCX0sCgoJCU5BTUU6IGZ1bmN0aW9uKCBtYXRjaCwgY29udGV4dCApIHsKCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5TmFtZSAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCQl2YXIgcmV0ID0gW10sCgkJCQkJcmVzdWx0cyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeU5hbWUoIG1hdGNoWzFdICk7CgoJCQkJZm9yICggdmFyIGkgPSAwLCBsID0gcmVzdWx0cy5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJCQkJaWYgKCByZXN1bHRzW2ldLmdldEF0dHJpYnV0ZSgibmFtZSIpID09PSBtYXRjaFsxXSApIHsKCQkJCQkJcmV0LnB1c2goIHJlc3VsdHNbaV0gKTsKCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuIHJldC5sZW5ndGggPT09IDAgPyBudWxsIDogcmV0OwoJCQl9CgkJfSwKCgkJVEFHOiBmdW5jdGlvbiggbWF0Y2gsIGNvbnRleHQgKSB7CgkJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgIT09ICJ1bmRlZmluZWQiICkgewoJCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIG1hdGNoWzFdICk7CgkJCX0KCQl9Cgl9LAoJcHJlRmlsdGVyOiB7CgkJQ0xBU1M6IGZ1bmN0aW9uKCBtYXRjaCwgY3VyTG9vcCwgaW5wbGFjZSwgcmVzdWx0LCBub3QsIGlzWE1MICkgewoJCQltYXRjaCA9ICIgIiArIG1hdGNoWzFdLnJlcGxhY2UoIHJCYWNrc2xhc2gsICIiICkgKyAiICI7CgoJCQlpZiAoIGlzWE1MICkgewoJCQkJcmV0dXJuIG1hdGNoOwoJCQl9CgoJCQlmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gY3VyTG9vcFtpXSkgIT0gbnVsbDsgaSsrICkgewoJCQkJaWYgKCBlbGVtICkgewoJCQkJCWlmICggbm90IF4gKGVsZW0uY2xhc3NOYW1lICYmICgiICIgKyBlbGVtLmNsYXNzTmFtZSArICIgIikucmVwbGFjZSgvW1x0XG5ccl0vZywgIiAiKS5pbmRleE9mKG1hdGNoKSA+PSAwKSApIHsKCQkJCQkJaWYgKCAhaW5wbGFjZSApIHsKCQkJCQkJCXJlc3VsdC5wdXNoKCBlbGVtICk7CgkJCQkJCX0KCgkJCQkJfSBlbHNlIGlmICggaW5wbGFjZSApIHsKCQkJCQkJY3VyTG9vcFtpXSA9IGZhbHNlOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgoJCUlEOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCXJldHVybiBtYXRjaFsxXS5yZXBsYWNlKCByQmFja3NsYXNoLCAiIiApOwoJCX0sCgoJCVRBRzogZnVuY3Rpb24oIG1hdGNoLCBjdXJMb29wICkgewoJCQlyZXR1cm4gbWF0Y2hbMV0ucmVwbGFjZSggckJhY2tzbGFzaCwgIiIgKS50b0xvd2VyQ2FzZSgpOwoJCX0sCgoJCUNISUxEOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCWlmICggbWF0Y2hbMV0gPT09ICJudGgiICkgewoJCQkJaWYgKCAhbWF0Y2hbMl0gKSB7CgkJCQkJU2l6emxlLmVycm9yKCBtYXRjaFswXSApOwoJCQkJfQoKCQkJCW1hdGNoWzJdID0gbWF0Y2hbMl0ucmVwbGFjZSgvXlwrfFxzKi9nLCAnJyk7CgoJCQkJLy8gcGFyc2UgZXF1YXRpb25zIGxpa2UgJ2V2ZW4nLCAnb2RkJywgJzUnLCAnMm4nLCAnM24rMicsICc0bi0xJywgJy1uKzYnCgkJCQl2YXIgdGVzdCA9IC8oLT8pKFxkKikoPzpuKFsrXC1dP1xkKikpPy8uZXhlYygKCQkJCQltYXRjaFsyXSA9PT0gImV2ZW4iICYmICIybiIgfHwgbWF0Y2hbMl0gPT09ICJvZGQiICYmICIybisxIiB8fAoJCQkJCSEvXEQvLnRlc3QoIG1hdGNoWzJdICkgJiYgIjBuKyIgKyBtYXRjaFsyXSB8fCBtYXRjaFsyXSk7CgoJCQkJLy8gY2FsY3VsYXRlIHRoZSBudW1iZXJzIChmaXJzdCluKyhsYXN0KSBpbmNsdWRpbmcgaWYgdGhleSBhcmUgbmVnYXRpdmUKCQkJCW1hdGNoWzJdID0gKHRlc3RbMV0gKyAodGVzdFsyXSB8fCAxKSkgLSAwOwoJCQkJbWF0Y2hbM10gPSB0ZXN0WzNdIC0gMDsKCQkJfQoJCQllbHNlIGlmICggbWF0Y2hbMl0gKSB7CgkJCQlTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7CgkJCX0KCgkJCS8vIFRPRE86IE1vdmUgdG8gbm9ybWFsIGNhY2hpbmcgc3lzdGVtCgkJCW1hdGNoWzBdID0gZG9uZSsrOwoKCQkJcmV0dXJuIG1hdGNoOwoJCX0sCgoJCUFUVFI6IGZ1bmN0aW9uKCBtYXRjaCwgY3VyTG9vcCwgaW5wbGFjZSwgcmVzdWx0LCBub3QsIGlzWE1MICkgewoJCQl2YXIgbmFtZSA9IG1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZSggckJhY2tzbGFzaCwgIiIgKTsKCQkJCgkJCWlmICggIWlzWE1MICYmIEV4cHIuYXR0ck1hcFtuYW1lXSApIHsKCQkJCW1hdGNoWzFdID0gRXhwci5hdHRyTWFwW25hbWVdOwoJCQl9CgoJCQkvLyBIYW5kbGUgaWYgYW4gdW4tcXVvdGVkIHZhbHVlIHdhcyB1c2VkCgkJCW1hdGNoWzRdID0gKCBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAiIiApLnJlcGxhY2UoIHJCYWNrc2xhc2gsICIiICk7CgoJCQlpZiAoIG1hdGNoWzJdID09PSAifj0iICkgewoJCQkJbWF0Y2hbNF0gPSAiICIgKyBtYXRjaFs0XSArICIgIjsKCQkJfQoKCQkJcmV0dXJuIG1hdGNoOwoJCX0sCgoJCVBTRVVETzogZnVuY3Rpb24oIG1hdGNoLCBjdXJMb29wLCBpbnBsYWNlLCByZXN1bHQsIG5vdCApIHsKCQkJaWYgKCBtYXRjaFsxXSA9PT0gIm5vdCIgKSB7CgkJCQkvLyBJZiB3ZSdyZSBkZWFsaW5nIHdpdGggYSBjb21wbGV4IGV4cHJlc3Npb24sIG9yIGEgc2ltcGxlIG9uZQoJCQkJaWYgKCAoIGNodW5rZXIuZXhlYyhtYXRjaFszXSkgfHwgIiIgKS5sZW5ndGggPiAxIHx8IC9eXHcvLnRlc3QobWF0Y2hbM10pICkgewoJCQkJCW1hdGNoWzNdID0gU2l6emxlKG1hdGNoWzNdLCBudWxsLCBudWxsLCBjdXJMb29wKTsKCgkJCQl9IGVsc2UgewoJCQkJCXZhciByZXQgPSBTaXp6bGUuZmlsdGVyKG1hdGNoWzNdLCBjdXJMb29wLCBpbnBsYWNlLCB0cnVlIF4gbm90KTsKCgkJCQkJaWYgKCAhaW5wbGFjZSApIHsKCQkJCQkJcmVzdWx0LnB1c2guYXBwbHkoIHJlc3VsdCwgcmV0ICk7CgkJCQkJfQoKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKCBFeHByLm1hdGNoLlBPUy50ZXN0KCBtYXRjaFswXSApIHx8IEV4cHIubWF0Y2guQ0hJTEQudGVzdCggbWF0Y2hbMF0gKSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCQoJCQlyZXR1cm4gbWF0Y2g7CgkJfSwKCgkJUE9TOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCW1hdGNoLnVuc2hpZnQoIHRydWUgKTsKCgkJCXJldHVybiBtYXRjaDsKCQl9Cgl9LAoJCglmaWx0ZXJzOiB7CgkJZW5hYmxlZDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSBmYWxzZSAmJiBlbGVtLnR5cGUgIT09ICJoaWRkZW4iOwoJCX0sCgoJCWRpc2FibGVkOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IHRydWU7CgkJfSwKCgkJY2hlY2tlZDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmNoZWNrZWQgPT09IHRydWU7CgkJfSwKCQkKCQlzZWxlY3RlZDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCS8vIEFjY2Vzc2luZyB0aGlzIHByb3BlcnR5IG1ha2VzIHNlbGVjdGVkLWJ5LWRlZmF1bHQKCQkJLy8gb3B0aW9ucyBpbiBTYWZhcmkgd29yayBwcm9wZXJseQoJCQlpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCWVsZW0ucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCQoJCQlyZXR1cm4gZWxlbS5zZWxlY3RlZCA9PT0gdHJ1ZTsKCQl9LAoKCQlwYXJlbnQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gISFlbGVtLmZpcnN0Q2hpbGQ7CgkJfSwKCgkJZW1wdHk6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gIWVsZW0uZmlyc3RDaGlsZDsKCQl9LAoKCQloYXM6IGZ1bmN0aW9uKCBlbGVtLCBpLCBtYXRjaCApIHsKCQkJcmV0dXJuICEhU2l6emxlKCBtYXRjaFszXSwgZWxlbSApLmxlbmd0aDsKCQl9LAoKCQloZWFkZXI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gKC9oXGQvaSkudGVzdCggZWxlbS5ub2RlTmFtZSApOwoJCX0sCgoJCXRleHQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgYXR0ciA9IGVsZW0uZ2V0QXR0cmlidXRlKCAidHlwZSIgKSwgdHlwZSA9IGVsZW0udHlwZTsKCQkJLy8gSUU2IGFuZCA3IHdpbGwgbWFwIGVsZW0udHlwZSB0byAndGV4dCcgZm9yIG5ldyBIVE1MNSB0eXBlcyAoc2VhcmNoLCBldGMpIAoJCQkvLyB1c2UgZ2V0QXR0cmlidXRlIGluc3RlYWQgdG8gdGVzdCB0aGlzIGNhc2UKCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAidGV4dCIgPT09IHR5cGUgJiYgKCBhdHRyID09PSB0eXBlIHx8IGF0dHIgPT09IG51bGwgKTsKCQl9LAoKCQlyYWRpbzogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgInJhZGlvIiA9PT0gZWxlbS50eXBlOwoJCX0sCgoJCWNoZWNrYm94OiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAiY2hlY2tib3giID09PSBlbGVtLnR5cGU7CgkJfSwKCgkJZmlsZTogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgImZpbGUiID09PSBlbGVtLnR5cGU7CgkJfSwKCgkJcGFzc3dvcmQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICJwYXNzd29yZCIgPT09IGVsZW0udHlwZTsKCQl9LAoKCQlzdWJtaXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIChuYW1lID09PSAiaW5wdXQiIHx8IG5hbWUgPT09ICJidXR0b24iKSAmJiAic3VibWl0IiA9PT0gZWxlbS50eXBlOwoJCX0sCgoJCWltYWdlOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAiaW1hZ2UiID09PSBlbGVtLnR5cGU7CgkJfSwKCgkJcmVzZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIChuYW1lID09PSAiaW5wdXQiIHx8IG5hbWUgPT09ICJidXR0b24iKSAmJiAicmVzZXQiID09PSBlbGVtLnR5cGU7CgkJfSwKCgkJYnV0dG9uOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiBuYW1lID09PSAiaW5wdXQiICYmICJidXR0b24iID09PSBlbGVtLnR5cGUgfHwgbmFtZSA9PT0gImJ1dHRvbiI7CgkJfSwKCgkJaW5wdXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gKC9pbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uL2kpLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKCQl9LAoKCQlmb2N1czogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtID09PSBlbGVtLm93bmVyRG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKCQl9Cgl9LAoJc2V0RmlsdGVyczogewoJCWZpcnN0OiBmdW5jdGlvbiggZWxlbSwgaSApIHsKCQkJcmV0dXJuIGkgPT09IDA7CgkJfSwKCgkJbGFzdDogZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoLCBhcnJheSApIHsKCQkJcmV0dXJuIGkgPT09IGFycmF5Lmxlbmd0aCAtIDE7CgkJfSwKCgkJZXZlbjogZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiBpICUgMiA9PT0gMDsKCQl9LAoKCQlvZGQ6IGZ1bmN0aW9uKCBlbGVtLCBpICkgewoJCQlyZXR1cm4gaSAlIDIgPT09IDE7CgkJfSwKCgkJbHQ6IGZ1bmN0aW9uKCBlbGVtLCBpLCBtYXRjaCApIHsKCQkJcmV0dXJuIGkgPCBtYXRjaFszXSAtIDA7CgkJfSwKCgkJZ3Q6IGZ1bmN0aW9uKCBlbGVtLCBpLCBtYXRjaCApIHsKCQkJcmV0dXJuIGkgPiBtYXRjaFszXSAtIDA7CgkJfSwKCgkJbnRoOiBmdW5jdGlvbiggZWxlbSwgaSwgbWF0Y2ggKSB7CgkJCXJldHVybiBtYXRjaFszXSAtIDAgPT09IGk7CgkJfSwKCgkJZXE6IGZ1bmN0aW9uKCBlbGVtLCBpLCBtYXRjaCApIHsKCQkJcmV0dXJuIG1hdGNoWzNdIC0gMCA9PT0gaTsKCQl9Cgl9LAoJZmlsdGVyOiB7CgkJUFNFVURPOiBmdW5jdGlvbiggZWxlbSwgbWF0Y2gsIGksIGFycmF5ICkgewoJCQl2YXIgbmFtZSA9IG1hdGNoWzFdLAoJCQkJZmlsdGVyID0gRXhwci5maWx0ZXJzWyBuYW1lIF07CgoJCQlpZiAoIGZpbHRlciApIHsKCQkJCXJldHVybiBmaWx0ZXIoIGVsZW0sIGksIG1hdGNoLCBhcnJheSApOwoKCQkJfSBlbHNlIGlmICggbmFtZSA9PT0gImNvbnRhaW5zIiApIHsKCQkJCXJldHVybiAoZWxlbS50ZXh0Q29udGVudCB8fCBlbGVtLmlubmVyVGV4dCB8fCBTaXp6bGUuZ2V0VGV4dChbIGVsZW0gXSkgfHwgIiIpLmluZGV4T2YobWF0Y2hbM10pID49IDA7CgoJCQl9IGVsc2UgaWYgKCBuYW1lID09PSAibm90IiApIHsKCQkJCXZhciBub3QgPSBtYXRjaFszXTsKCgkJCQlmb3IgKCB2YXIgaiA9IDAsIGwgPSBub3QubGVuZ3RoOyBqIDwgbDsgaisrICkgewoJCQkJCWlmICggbm90W2pdID09PSBlbGVtICkgewoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfQoKCQkJCXJldHVybiB0cnVlOwoKCQkJfSBlbHNlIHsKCQkJCVNpenpsZS5lcnJvciggbmFtZSApOwoJCQl9CgkJfSwKCgkJQ0hJTEQ6IGZ1bmN0aW9uKCBlbGVtLCBtYXRjaCApIHsKCQkJdmFyIHR5cGUgPSBtYXRjaFsxXSwKCQkJCW5vZGUgPSBlbGVtOwoKCQkJc3dpdGNoICggdHlwZSApIHsKCQkJCWNhc2UgIm9ubHkiOgoJCQkJY2FzZSAiZmlyc3QiOgoJCQkJCXdoaWxlICggKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykgKQkgewoJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgKSB7IAoJCQkJCQkJcmV0dXJuIGZhbHNlOyAKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKCB0eXBlID09PSAiZmlyc3QiICkgeyAKCQkJCQkJcmV0dXJuIHRydWU7IAoJCQkJCX0KCgkJCQkJbm9kZSA9IGVsZW07CgoJCQkJY2FzZSAibGFzdCI6CgkJCQkJd2hpbGUgKCAobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpICkJIHsKCQkJCQkJaWYgKCBub2RlLm5vZGVUeXBlID09PSAxICkgeyAKCQkJCQkJCXJldHVybiBmYWxzZTsgCgkJCQkJCX0KCQkJCQl9CgoJCQkJCXJldHVybiB0cnVlOwoKCQkJCWNhc2UgIm50aCI6CgkJCQkJdmFyIGZpcnN0ID0gbWF0Y2hbMl0sCgkJCQkJCWxhc3QgPSBtYXRjaFszXTsKCgkJCQkJaWYgKCBmaXJzdCA9PT0gMSAmJiBsYXN0ID09PSAwICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQkJCgkJCQkJdmFyIGRvbmVOYW1lID0gbWF0Y2hbMF0sCgkJCQkJCXBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCQoJCQkJCWlmICggcGFyZW50ICYmIChwYXJlbnQuc2l6Y2FjaGUgIT09IGRvbmVOYW1lIHx8ICFlbGVtLm5vZGVJbmRleCkgKSB7CgkJCQkJCXZhciBjb3VudCA9IDA7CgkJCQkJCQoJCQkJCQlmb3IgKCBub2RlID0gcGFyZW50LmZpcnN0Q2hpbGQ7IG5vZGU7IG5vZGUgPSBub2RlLm5leHRTaWJsaW5nICkgewoJCQkJCQkJaWYgKCBub2RlLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQkJCW5vZGUubm9kZUluZGV4ID0gKytjb3VudDsKCQkJCQkJCX0KCQkJCQkJfSAKCgkJCQkJCXBhcmVudC5zaXpjYWNoZSA9IGRvbmVOYW1lOwoJCQkJCX0KCQkJCQkKCQkJCQl2YXIgZGlmZiA9IGVsZW0ubm9kZUluZGV4IC0gbGFzdDsKCgkJCQkJaWYgKCBmaXJzdCA9PT0gMCApIHsKCQkJCQkJcmV0dXJuIGRpZmYgPT09IDA7CgoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiAoIGRpZmYgJSBmaXJzdCA9PT0gMCAmJiBkaWZmIC8gZmlyc3QgPj0gMCApOwoJCQkJCX0KCQkJfQoJCX0sCgoJCUlEOiBmdW5jdGlvbiggZWxlbSwgbWF0Y2ggKSB7CgkJCXJldHVybiBlbGVtLm5vZGVUeXBlID09PSAxICYmIGVsZW0uZ2V0QXR0cmlidXRlKCJpZCIpID09PSBtYXRjaDsKCQl9LAoKCQlUQUc6IGZ1bmN0aW9uKCBlbGVtLCBtYXRjaCApIHsKCQkJcmV0dXJuIChtYXRjaCA9PT0gIioiICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpIHx8IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbWF0Y2g7CgkJfSwKCQkKCQlDTEFTUzogZnVuY3Rpb24oIGVsZW0sIG1hdGNoICkgewoJCQlyZXR1cm4gKCIgIiArIChlbGVtLmNsYXNzTmFtZSB8fCBlbGVtLmdldEF0dHJpYnV0ZSgiY2xhc3MiKSkgKyAiICIpCgkJCQkuaW5kZXhPZiggbWF0Y2ggKSA+IC0xOwoJCX0sCgoJCUFUVFI6IGZ1bmN0aW9uKCBlbGVtLCBtYXRjaCApIHsKCQkJdmFyIG5hbWUgPSBtYXRjaFsxXSwKCQkJCXJlc3VsdCA9IEV4cHIuYXR0ckhhbmRsZVsgbmFtZSBdID8KCQkJCQlFeHByLmF0dHJIYW5kbGVbIG5hbWUgXSggZWxlbSApIDoKCQkJCQllbGVtWyBuYW1lIF0gIT0gbnVsbCA/CgkJCQkJCWVsZW1bIG5hbWUgXSA6CgkJCQkJCWVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICksCgkJCQl2YWx1ZSA9IHJlc3VsdCArICIiLAoJCQkJdHlwZSA9IG1hdGNoWzJdLAoJCQkJY2hlY2sgPSBtYXRjaFs0XTsKCgkJCXJldHVybiByZXN1bHQgPT0gbnVsbCA/CgkJCQl0eXBlID09PSAiIT0iIDoKCQkJCXR5cGUgPT09ICI9IiA/CgkJCQl2YWx1ZSA9PT0gY2hlY2sgOgoJCQkJdHlwZSA9PT0gIio9IiA/CgkJCQl2YWx1ZS5pbmRleE9mKGNoZWNrKSA+PSAwIDoKCQkJCXR5cGUgPT09ICJ+PSIgPwoJCQkJKCIgIiArIHZhbHVlICsgIiAiKS5pbmRleE9mKGNoZWNrKSA+PSAwIDoKCQkJCSFjaGVjayA/CgkJCQl2YWx1ZSAmJiByZXN1bHQgIT09IGZhbHNlIDoKCQkJCXR5cGUgPT09ICIhPSIgPwoJCQkJdmFsdWUgIT09IGNoZWNrIDoKCQkJCXR5cGUgPT09ICJePSIgPwoJCQkJdmFsdWUuaW5kZXhPZihjaGVjaykgPT09IDAgOgoJCQkJdHlwZSA9PT0gIiQ9IiA/CgkJCQl2YWx1ZS5zdWJzdHIodmFsdWUubGVuZ3RoIC0gY2hlY2subGVuZ3RoKSA9PT0gY2hlY2sgOgoJCQkJdHlwZSA9PT0gInw9IiA/CgkJCQl2YWx1ZSA9PT0gY2hlY2sgfHwgdmFsdWUuc3Vic3RyKDAsIGNoZWNrLmxlbmd0aCArIDEpID09PSBjaGVjayArICItIiA6CgkJCQlmYWxzZTsKCQl9LAoKCQlQT1M6IGZ1bmN0aW9uKCBlbGVtLCBtYXRjaCwgaSwgYXJyYXkgKSB7CgkJCXZhciBuYW1lID0gbWF0Y2hbMl0sCgkJCQlmaWx0ZXIgPSBFeHByLnNldEZpbHRlcnNbIG5hbWUgXTsKCgkJCWlmICggZmlsdGVyICkgewoJCQkJcmV0dXJuIGZpbHRlciggZWxlbSwgaSwgbWF0Y2gsIGFycmF5ICk7CgkJCX0KCQl9Cgl9Cn07Cgp2YXIgb3JpZ1BPUyA9IEV4cHIubWF0Y2guUE9TLAoJZmVzY2FwZSA9IGZ1bmN0aW9uKGFsbCwgbnVtKXsKCQlyZXR1cm4gIlxcIiArIChudW0gLSAwICsgMSk7Cgl9OwoKZm9yICggdmFyIHR5cGUgaW4gRXhwci5tYXRjaCApIHsKCUV4cHIubWF0Y2hbIHR5cGUgXSA9IG5ldyBSZWdFeHAoIEV4cHIubWF0Y2hbIHR5cGUgXS5zb3VyY2UgKyAoLyg/IVteXFtdKlxdKSg/IVteXChdKlwpKS8uc291cmNlKSApOwoJRXhwci5sZWZ0TWF0Y2hbIHR5cGUgXSA9IG5ldyBSZWdFeHAoIC8oXig/Oi58XHJ8XG4pKj8pLy5zb3VyY2UgKyBFeHByLm1hdGNoWyB0eXBlIF0uc291cmNlLnJlcGxhY2UoL1xcKFxkKykvZywgZmVzY2FwZSkgKTsKfQoKdmFyIG1ha2VBcnJheSA9IGZ1bmN0aW9uKCBhcnJheSwgcmVzdWx0cyApIHsKCWFycmF5ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoIGFycmF5LCAwICk7CgoJaWYgKCByZXN1bHRzICkgewoJCXJlc3VsdHMucHVzaC5hcHBseSggcmVzdWx0cywgYXJyYXkgKTsKCQlyZXR1cm4gcmVzdWx0czsKCX0KCQoJcmV0dXJuIGFycmF5Owp9OwoKLy8gUGVyZm9ybSBhIHNpbXBsZSBjaGVjayB0byBkZXRlcm1pbmUgaWYgdGhlIGJyb3dzZXIgaXMgY2FwYWJsZSBvZgovLyBjb252ZXJ0aW5nIGEgTm9kZUxpc3QgdG8gYW4gYXJyYXkgdXNpbmcgYnVpbHRpbiBtZXRob2RzLgovLyBBbHNvIHZlcmlmaWVzIHRoYXQgdGhlIHJldHVybmVkIGFycmF5IGhvbGRzIERPTSBub2RlcwovLyAod2hpY2ggaXMgbm90IHRoZSBjYXNlIGluIHRoZSBCbGFja2JlcnJ5IGJyb3dzZXIpCnRyeSB7CglBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNoaWxkTm9kZXMsIDAgKVswXS5ub2RlVHlwZTsKCi8vIFByb3ZpZGUgYSBmYWxsYmFjayBtZXRob2QgaWYgaXQgZG9lcyBub3Qgd29yawp9IGNhdGNoKCBlICkgewoJbWFrZUFycmF5ID0gZnVuY3Rpb24oIGFycmF5LCByZXN1bHRzICkgewoJCXZhciBpID0gMCwKCQkJcmV0ID0gcmVzdWx0cyB8fCBbXTsKCgkJaWYgKCB0b1N0cmluZy5jYWxsKGFycmF5KSA9PT0gIltvYmplY3QgQXJyYXldIiApIHsKCQkJQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkoIHJldCwgYXJyYXkgKTsKCgkJfSBlbHNlIHsKCQkJaWYgKCB0eXBlb2YgYXJyYXkubGVuZ3RoID09PSAibnVtYmVyIiApIHsKCQkJCWZvciAoIHZhciBsID0gYXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCXJldC5wdXNoKCBhcnJheVtpXSApOwoJCQkJfQoKCQkJfSBlbHNlIHsKCQkJCWZvciAoIDsgYXJyYXlbaV07IGkrKyApIHsKCQkJCQlyZXQucHVzaCggYXJyYXlbaV0gKTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHJldDsKCX07Cn0KCnZhciBzb3J0T3JkZXIsIHNpYmxpbmdDaGVjazsKCmlmICggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICkgewoJc29ydE9yZGVyID0gZnVuY3Rpb24oIGEsIGIgKSB7CgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCQl9CgoJCWlmICggIWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gfHwgIWIuY29tcGFyZURvY3VtZW50UG9zaXRpb24gKSB7CgkJCXJldHVybiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8gLTEgOiAxOwoJCX0KCgkJcmV0dXJuIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiA0ID8gLTEgOiAxOwoJfTsKCn0gZWxzZSB7Cglzb3J0T3JkZXIgPSBmdW5jdGlvbiggYSwgYiApIHsKCQkvLyBUaGUgbm9kZXMgYXJlIGlkZW50aWNhbCwgd2UgY2FuIGV4aXQgZWFybHkKCQlpZiAoIGEgPT09IGIgKSB7CgkJCWhhc0R1cGxpY2F0ZSA9IHRydWU7CgkJCXJldHVybiAwOwoKCQkvLyBGYWxsYmFjayB0byB1c2luZyBzb3VyY2VJbmRleCAoaW4gSUUpIGlmIGl0J3MgYXZhaWxhYmxlIG9uIGJvdGggbm9kZXMKCQl9IGVsc2UgaWYgKCBhLnNvdXJjZUluZGV4ICYmIGIuc291cmNlSW5kZXggKSB7CgkJCXJldHVybiBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCQl9CgoJCXZhciBhbCwgYmwsCgkJCWFwID0gW10sCgkJCWJwID0gW10sCgkJCWF1cCA9IGEucGFyZW50Tm9kZSwKCQkJYnVwID0gYi5wYXJlbnROb2RlLAoJCQljdXIgPSBhdXA7CgoJCS8vIElmIHRoZSBub2RlcyBhcmUgc2libGluZ3MgKG9yIGlkZW50aWNhbCkgd2UgY2FuIGRvIGEgcXVpY2sgY2hlY2sKCQlpZiAoIGF1cCA9PT0gYnVwICkgewoJCQlyZXR1cm4gc2libGluZ0NoZWNrKCBhLCBiICk7CgoJCS8vIElmIG5vIHBhcmVudHMgd2VyZSBmb3VuZCB0aGVuIHRoZSBub2RlcyBhcmUgZGlzY29ubmVjdGVkCgkJfSBlbHNlIGlmICggIWF1cCApIHsKCQkJcmV0dXJuIC0xOwoKCQl9IGVsc2UgaWYgKCAhYnVwICkgewoJCQlyZXR1cm4gMTsKCQl9CgoJCS8vIE90aGVyd2lzZSB0aGV5J3JlIHNvbWV3aGVyZSBlbHNlIGluIHRoZSB0cmVlIHNvIHdlIG5lZWQKCQkvLyB0byBidWlsZCB1cCBhIGZ1bGwgbGlzdCBvZiB0aGUgcGFyZW50Tm9kZXMgZm9yIGNvbXBhcmlzb24KCQl3aGlsZSAoIGN1ciApIHsKCQkJYXAudW5zaGlmdCggY3VyICk7CgkJCWN1ciA9IGN1ci5wYXJlbnROb2RlOwoJCX0KCgkJY3VyID0gYnVwOwoKCQl3aGlsZSAoIGN1ciApIHsKCQkJYnAudW5zaGlmdCggY3VyICk7CgkJCWN1ciA9IGN1ci5wYXJlbnROb2RlOwoJCX0KCgkJYWwgPSBhcC5sZW5ndGg7CgkJYmwgPSBicC5sZW5ndGg7CgoJCS8vIFN0YXJ0IHdhbGtpbmcgZG93biB0aGUgdHJlZSBsb29raW5nIGZvciBhIGRpc2NyZXBhbmN5CgkJZm9yICggdmFyIGkgPSAwOyBpIDwgYWwgJiYgaSA8IGJsOyBpKysgKSB7CgkJCWlmICggYXBbaV0gIT09IGJwW2ldICkgewoJCQkJcmV0dXJuIHNpYmxpbmdDaGVjayggYXBbaV0sIGJwW2ldICk7CgkJCX0KCQl9CgoJCS8vIFdlIGVuZGVkIHNvbWVwbGFjZSB1cCB0aGUgdHJlZSBzbyBkbyBhIHNpYmxpbmcgY2hlY2sKCQlyZXR1cm4gaSA9PT0gYWwgPwoJCQlzaWJsaW5nQ2hlY2soIGEsIGJwW2ldLCAtMSApIDoKCQkJc2libGluZ0NoZWNrKCBhcFtpXSwgYiwgMSApOwoJfTsKCglzaWJsaW5nQ2hlY2sgPSBmdW5jdGlvbiggYSwgYiwgcmV0ICkgewoJCWlmICggYSA9PT0gYiApIHsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXZhciBjdXIgPSBhLm5leHRTaWJsaW5nOwoKCQl3aGlsZSAoIGN1ciApIHsKCQkJaWYgKCBjdXIgPT09IGIgKSB7CgkJCQlyZXR1cm4gLTE7CgkJCX0KCgkJCWN1ciA9IGN1ci5uZXh0U2libGluZzsKCQl9CgoJCXJldHVybiAxOwoJfTsKfQoKLy8gVXRpbGl0eSBmdW5jdGlvbiBmb3IgcmV0cmVpdmluZyB0aGUgdGV4dCB2YWx1ZSBvZiBhbiBhcnJheSBvZiBET00gbm9kZXMKU2l6emxlLmdldFRleHQgPSBmdW5jdGlvbiggZWxlbXMgKSB7Cgl2YXIgcmV0ID0gIiIsIGVsZW07CgoJZm9yICggdmFyIGkgPSAwOyBlbGVtc1tpXTsgaSsrICkgewoJCWVsZW0gPSBlbGVtc1tpXTsKCgkJLy8gR2V0IHRoZSB0ZXh0IGZyb20gdGV4dCBub2RlcyBhbmQgQ0RBVEEgbm9kZXMKCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gNCApIHsKCQkJcmV0ICs9IGVsZW0ubm9kZVZhbHVlOwoKCQkvLyBUcmF2ZXJzZSBldmVyeXRoaW5nIGVsc2UsIGV4Y2VwdCBjb21tZW50IG5vZGVzCgkJfSBlbHNlIGlmICggZWxlbS5ub2RlVHlwZSAhPT0gOCApIHsKCQkJcmV0ICs9IFNpenpsZS5nZXRUZXh0KCBlbGVtLmNoaWxkTm9kZXMgKTsKCQl9Cgl9CgoJcmV0dXJuIHJldDsKfTsKCi8vIENoZWNrIHRvIHNlZSBpZiB0aGUgYnJvd3NlciByZXR1cm5zIGVsZW1lbnRzIGJ5IG5hbWUgd2hlbgovLyBxdWVyeWluZyBieSBnZXRFbGVtZW50QnlJZCAoYW5kIHByb3ZpZGUgYSB3b3JrYXJvdW5kKQooZnVuY3Rpb24oKXsKCS8vIFdlJ3JlIGdvaW5nIHRvIGluamVjdCBhIGZha2UgaW5wdXQgZWxlbWVudCB3aXRoIGEgc3BlY2lmaWVkIG5hbWUKCXZhciBmb3JtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCgkJaWQgPSAic2NyaXB0IiArIChuZXcgRGF0ZSgpKS5nZXRUaW1lKCksCgkJcm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCglmb3JtLmlubmVySFRNTCA9ICI8YSBuYW1lPSciICsgaWQgKyAiJy8+IjsKCgkvLyBJbmplY3QgaXQgaW50byB0aGUgcm9vdCBlbGVtZW50LCBjaGVjayBpdHMgc3RhdHVzLCBhbmQgcmVtb3ZlIGl0IHF1aWNrbHkKCXJvb3QuaW5zZXJ0QmVmb3JlKCBmb3JtLCByb290LmZpcnN0Q2hpbGQgKTsKCgkvLyBUaGUgd29ya2Fyb3VuZCBoYXMgdG8gZG8gYWRkaXRpb25hbCBjaGVja3MgYWZ0ZXIgYSBnZXRFbGVtZW50QnlJZAoJLy8gV2hpY2ggc2xvd3MgdGhpbmdzIGRvd24gZm9yIG90aGVyIGJyb3dzZXJzIChoZW5jZSB0aGUgYnJhbmNoaW5nKQoJaWYgKCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggaWQgKSApIHsKCQlFeHByLmZpbmQuSUQgPSBmdW5jdGlvbiggbWF0Y2gsIGNvbnRleHQsIGlzWE1MICkgewoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSAidW5kZWZpbmVkIiAmJiAhaXNYTUwgKSB7CgkJCQl2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQobWF0Y2hbMV0pOwoKCQkJCXJldHVybiBtID8KCQkJCQltLmlkID09PSBtYXRjaFsxXSB8fCB0eXBlb2YgbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSAidW5kZWZpbmVkIiAmJiBtLmdldEF0dHJpYnV0ZU5vZGUoImlkIikubm9kZVZhbHVlID09PSBtYXRjaFsxXSA/CgkJCQkJCVttXSA6CgkJCQkJCXVuZGVmaW5lZCA6CgkJCQkJW107CgkJCX0KCQl9OwoKCQlFeHByLmZpbHRlci5JRCA9IGZ1bmN0aW9uKCBlbGVtLCBtYXRjaCApIHsKCQkJdmFyIG5vZGUgPSB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSAidW5kZWZpbmVkIiAmJiBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoImlkIik7CgoJCQlyZXR1cm4gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiBub2RlICYmIG5vZGUubm9kZVZhbHVlID09PSBtYXRjaDsKCQl9OwoJfQoKCXJvb3QucmVtb3ZlQ2hpbGQoIGZvcm0gKTsKCgkvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQoJcm9vdCA9IGZvcm0gPSBudWxsOwp9KSgpOwoKKGZ1bmN0aW9uKCl7CgkvLyBDaGVjayB0byBzZWUgaWYgdGhlIGJyb3dzZXIgcmV0dXJucyBvbmx5IGVsZW1lbnRzCgkvLyB3aGVuIGRvaW5nIGdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikKCgkvLyBDcmVhdGUgYSBmYWtlIGVsZW1lbnQKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCWRpdi5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikgKTsKCgkvLyBNYWtlIHN1cmUgbm8gY29tbWVudHMgYXJlIGZvdW5kCglpZiAoIGRpdi5nZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpLmxlbmd0aCA+IDAgKSB7CgkJRXhwci5maW5kLlRBRyA9IGZ1bmN0aW9uKCBtYXRjaCwgY29udGV4dCApIHsKCQkJdmFyIHJlc3VsdHMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCBtYXRjaFsxXSApOwoKCQkJLy8gRmlsdGVyIG91dCBwb3NzaWJsZSBjb21tZW50cwoJCQlpZiAoIG1hdGNoWzFdID09PSAiKiIgKSB7CgkJCQl2YXIgdG1wID0gW107CgoJCQkJZm9yICggdmFyIGkgPSAwOyByZXN1bHRzW2ldOyBpKysgKSB7CgkJCQkJaWYgKCByZXN1bHRzW2ldLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQl0bXAucHVzaCggcmVzdWx0c1tpXSApOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXN1bHRzID0gdG1wOwoJCQl9CgoJCQlyZXR1cm4gcmVzdWx0czsKCQl9OwoJfQoKCS8vIENoZWNrIHRvIHNlZSBpZiBhbiBhdHRyaWJ1dGUgcmV0dXJucyBub3JtYWxpemVkIGhyZWYgYXR0cmlidXRlcwoJZGl2LmlubmVySFRNTCA9ICI8YSBocmVmPScjJz48L2E+IjsKCglpZiAoIGRpdi5maXJzdENoaWxkICYmIHR5cGVvZiBkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUgIT09ICJ1bmRlZmluZWQiICYmCgkJCWRpdi5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgiaHJlZiIpICE9PSAiIyIgKSB7CgoJCUV4cHIuYXR0ckhhbmRsZS5ocmVmID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSggImhyZWYiLCAyICk7CgkJfTsKCX0KCgkvLyByZWxlYXNlIG1lbW9yeSBpbiBJRQoJZGl2ID0gbnVsbDsKfSkoKTsKCmlmICggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCApIHsKCShmdW5jdGlvbigpewoJCXZhciBvbGRTaXp6bGUgPSBTaXp6bGUsCgkJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLAoJCQlpZCA9ICJfX3NpenpsZV9fIjsKCgkJZGl2LmlubmVySFRNTCA9ICI8cCBjbGFzcz0nVEVTVCc+PC9wPiI7CgoJCS8vIFNhZmFyaSBjYW4ndCBoYW5kbGUgdXBwZXJjYXNlIG9yIHVuaWNvZGUgY2hhcmFjdGVycyB3aGVuCgkJLy8gaW4gcXVpcmtzIG1vZGUuCgkJaWYgKCBkaXYucXVlcnlTZWxlY3RvckFsbCAmJiBkaXYucXVlcnlTZWxlY3RvckFsbCgiLlRFU1QiKS5sZW5ndGggPT09IDAgKSB7CgkJCXJldHVybjsKCQl9CgkKCQlTaXp6bGUgPSBmdW5jdGlvbiggcXVlcnksIGNvbnRleHQsIGV4dHJhLCBzZWVkICkgewoJCQljb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKCgkJCS8vIE9ubHkgdXNlIHF1ZXJ5U2VsZWN0b3JBbGwgb24gbm9uLVhNTCBkb2N1bWVudHMKCQkJLy8gKElEIHNlbGVjdG9ycyBkb24ndCB3b3JrIGluIG5vbi1IVE1MIGRvY3VtZW50cykKCQkJaWYgKCAhc2VlZCAmJiAhU2l6emxlLmlzWE1MKGNvbnRleHQpICkgewoJCQkJLy8gU2VlIGlmIHdlIGZpbmQgYSBzZWxlY3RvciB0byBzcGVlZCB1cAoJCQkJdmFyIG1hdGNoID0gL14oXHcrJCl8XlwuKFtcd1wtXSskKXxeIyhbXHdcLV0rJCkvLmV4ZWMoIHF1ZXJ5ICk7CgkJCQkKCQkJCWlmICggbWF0Y2ggJiYgKGNvbnRleHQubm9kZVR5cGUgPT09IDEgfHwgY29udGV4dC5ub2RlVHlwZSA9PT0gOSkgKSB7CgkJCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiVEFHIikKCQkJCQlpZiAoIG1hdGNoWzFdICkgewoJCQkJCQlyZXR1cm4gbWFrZUFycmF5KCBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCBxdWVyeSApLCBleHRyYSApOwoJCQkJCQoJCQkJCS8vIFNwZWVkLXVwOiBTaXp6bGUoIi5DTEFTUyIpCgkJCQkJfSBlbHNlIGlmICggbWF0Y2hbMl0gJiYgRXhwci5maW5kLkNMQVNTICYmIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSApIHsKCQkJCQkJcmV0dXJuIG1ha2VBcnJheSggY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBtYXRjaFsyXSApLCBleHRyYSApOwoJCQkJCX0KCQkJCX0KCQkJCQoJCQkJaWYgKCBjb250ZXh0Lm5vZGVUeXBlID09PSA5ICkgewoJCQkJCS8vIFNwZWVkLXVwOiBTaXp6bGUoImJvZHkiKQoJCQkJCS8vIFRoZSBib2R5IGVsZW1lbnQgb25seSBleGlzdHMgb25jZSwgb3B0aW1pemUgZmluZGluZyBpdAoJCQkJCWlmICggcXVlcnkgPT09ICJib2R5IiAmJiBjb250ZXh0LmJvZHkgKSB7CgkJCQkJCXJldHVybiBtYWtlQXJyYXkoIFsgY29udGV4dC5ib2R5IF0sIGV4dHJhICk7CgkJCQkJCQoJCQkJCS8vIFNwZWVkLXVwOiBTaXp6bGUoIiNJRCIpCgkJCQkJfSBlbHNlIGlmICggbWF0Y2ggJiYgbWF0Y2hbM10gKSB7CgkJCQkJCXZhciBlbGVtID0gY29udGV4dC5nZXRFbGVtZW50QnlJZCggbWF0Y2hbM10gKTsKCgkJCQkJCS8vIENoZWNrIHBhcmVudE5vZGUgdG8gY2F0Y2ggd2hlbiBCbGFja2JlcnJ5IDQuNiByZXR1cm5zCgkJCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCQkJaWYgKCBlbGVtICYmIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCQkJCS8vIEhhbmRsZSB0aGUgY2FzZSB3aGVyZSBJRSBhbmQgT3BlcmEgcmV0dXJuIGl0ZW1zCgkJCQkJCQkvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKCQkJCQkJCWlmICggZWxlbS5pZCA9PT0gbWF0Y2hbM10gKSB7CgkJCQkJCQkJcmV0dXJuIG1ha2VBcnJheSggWyBlbGVtIF0sIGV4dHJhICk7CgkJCQkJCQl9CgkJCQkJCQkKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJldHVybiBtYWtlQXJyYXkoIFtdLCBleHRyYSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCQoJCQkJCXRyeSB7CgkJCQkJCXJldHVybiBtYWtlQXJyYXkoIGNvbnRleHQucXVlcnlTZWxlY3RvckFsbChxdWVyeSksIGV4dHJhICk7CgkJCQkJfSBjYXRjaChxc2FFcnJvcikge30KCgkJCQkvLyBxU0Egd29ya3Mgc3RyYW5nZWx5IG9uIEVsZW1lbnQtcm9vdGVkIHF1ZXJpZXMKCQkJCS8vIFdlIGNhbiB3b3JrIGFyb3VuZCB0aGlzIGJ5IHNwZWNpZnlpbmcgYW4gZXh0cmEgSUQgb24gdGhlIHJvb3QKCQkJCS8vIGFuZCB3b3JraW5nIHVwIGZyb20gdGhlcmUgKFRoYW5rcyB0byBBbmRyZXcgRHVwb250IGZvciB0aGUgdGVjaG5pcXVlKQoJCQkJLy8gSUUgOCBkb2Vzbid0IHdvcmsgb24gb2JqZWN0IGVsZW1lbnRzCgkJCQl9IGVsc2UgaWYgKCBjb250ZXh0Lm5vZGVUeXBlID09PSAxICYmIGNvbnRleHQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm9iamVjdCIgKSB7CgkJCQkJdmFyIG9sZENvbnRleHQgPSBjb250ZXh0LAoJCQkJCQlvbGQgPSBjb250ZXh0LmdldEF0dHJpYnV0ZSggImlkIiApLAoJCQkJCQluaWQgPSBvbGQgfHwgaWQsCgkJCQkJCWhhc1BhcmVudCA9IGNvbnRleHQucGFyZW50Tm9kZSwKCQkJCQkJcmVsYXRpdmVIaWVyYXJjaHlTZWxlY3RvciA9IC9eXHMqWyt+XS8udGVzdCggcXVlcnkgKTsKCgkJCQkJaWYgKCAhb2xkICkgewoJCQkJCQljb250ZXh0LnNldEF0dHJpYnV0ZSggImlkIiwgbmlkICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJbmlkID0gbmlkLnJlcGxhY2UoIC8nL2csICJcXCQmIiApOwoJCQkJCX0KCQkJCQlpZiAoIHJlbGF0aXZlSGllcmFyY2h5U2VsZWN0b3IgJiYgaGFzUGFyZW50ICkgewoJCQkJCQljb250ZXh0ID0gY29udGV4dC5wYXJlbnROb2RlOwoJCQkJCX0KCgkJCQkJdHJ5IHsKCQkJCQkJaWYgKCAhcmVsYXRpdmVIaWVyYXJjaHlTZWxlY3RvciB8fCBoYXNQYXJlbnQgKSB7CgkJCQkJCQlyZXR1cm4gbWFrZUFycmF5KCBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoICJbaWQ9JyIgKyBuaWQgKyAiJ10gIiArIHF1ZXJ5ICksIGV4dHJhICk7CgkJCQkJCX0KCgkJCQkJfSBjYXRjaChwc2V1ZG9FcnJvcikgewoJCQkJCX0gZmluYWxseSB7CgkJCQkJCWlmICggIW9sZCApIHsKCQkJCQkJCW9sZENvbnRleHQucmVtb3ZlQXR0cmlidXRlKCAiaWQiICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQkKCQkJcmV0dXJuIG9sZFNpenpsZShxdWVyeSwgY29udGV4dCwgZXh0cmEsIHNlZWQpOwoJCX07CgoJCWZvciAoIHZhciBwcm9wIGluIG9sZFNpenpsZSApIHsKCQkJU2l6emxlWyBwcm9wIF0gPSBvbGRTaXp6bGVbIHByb3AgXTsKCQl9CgoJCS8vIHJlbGVhc2UgbWVtb3J5IGluIElFCgkJZGl2ID0gbnVsbDsKCX0pKCk7Cn0KCihmdW5jdGlvbigpewoJdmFyIGh0bWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJbWF0Y2hlcyA9IGh0bWwubWF0Y2hlc1NlbGVjdG9yIHx8IGh0bWwubW96TWF0Y2hlc1NlbGVjdG9yIHx8IGh0bWwud2Via2l0TWF0Y2hlc1NlbGVjdG9yIHx8IGh0bWwubXNNYXRjaGVzU2VsZWN0b3I7CgoJaWYgKCBtYXRjaGVzICkgewoJCS8vIENoZWNrIHRvIHNlZSBpZiBpdCdzIHBvc3NpYmxlIHRvIGRvIG1hdGNoZXNTZWxlY3RvcgoJCS8vIG9uIGEgZGlzY29ubmVjdGVkIG5vZGUgKElFIDkgZmFpbHMgdGhpcykKCQl2YXIgZGlzY29ubmVjdGVkTWF0Y2ggPSAhbWF0Y2hlcy5jYWxsKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLCAiZGl2IiApLAoJCQlwc2V1ZG9Xb3JrcyA9IGZhbHNlOwoKCQl0cnkgewoJCQkvLyBUaGlzIHNob3VsZCBmYWlsIHdpdGggYW4gZXhjZXB0aW9uCgkJCS8vIEdlY2tvIGRvZXMgbm90IGVycm9yLCByZXR1cm5zIGZhbHNlIGluc3RlYWQKCQkJbWF0Y2hlcy5jYWxsKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsICJbdGVzdCE9JyddOnNpenpsZSIgKTsKCQoJCX0gY2F0Y2goIHBzZXVkb0Vycm9yICkgewoJCQlwc2V1ZG9Xb3JrcyA9IHRydWU7CgkJfQoKCQlTaXp6bGUubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJCS8vIE1ha2Ugc3VyZSB0aGF0IGF0dHJpYnV0ZSBzZWxlY3RvcnMgYXJlIHF1b3RlZAoJCQlleHByID0gZXhwci5yZXBsYWNlKC9cPVxzKihbXiciXF1dKilccypcXS9nLCAiPSckMSddIik7CgoJCQlpZiAoICFTaXp6bGUuaXNYTUwoIG5vZGUgKSApIHsKCQkJCXRyeSB7IAoJCQkJCWlmICggcHNldWRvV29ya3MgfHwgIUV4cHIubWF0Y2guUFNFVURPLnRlc3QoIGV4cHIgKSAmJiAhLyE9Ly50ZXN0KCBleHByICkgKSB7CgkJCQkJCXZhciByZXQgPSBtYXRjaGVzLmNhbGwoIG5vZGUsIGV4cHIgKTsKCgkJCQkJCS8vIElFIDkncyBtYXRjaGVzU2VsZWN0b3IgcmV0dXJucyBmYWxzZSBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKCQkJCQkJaWYgKCByZXQgfHwgIWRpc2Nvbm5lY3RlZE1hdGNoIHx8CgkJCQkJCQkJLy8gQXMgd2VsbCwgZGlzY29ubmVjdGVkIG5vZGVzIGFyZSBzYWlkIHRvIGJlIGluIGEgZG9jdW1lbnQKCQkJCQkJCQkvLyBmcmFnbWVudCBpbiBJRSA5LCBzbyBjaGVjayBmb3IgdGhhdAoJCQkJCQkJCW5vZGUuZG9jdW1lbnQgJiYgbm9kZS5kb2N1bWVudC5ub2RlVHlwZSAhPT0gMTEgKSB7CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBjYXRjaChlKSB7fQoJCQl9CgoJCQlyZXR1cm4gU2l6emxlKGV4cHIsIG51bGwsIG51bGwsIFtub2RlXSkubGVuZ3RoID4gMDsKCQl9OwoJfQp9KSgpOwoKKGZ1bmN0aW9uKCl7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CgoJZGl2LmlubmVySFRNTCA9ICI8ZGl2IGNsYXNzPSd0ZXN0IGUnPjwvZGl2PjxkaXYgY2xhc3M9J3Rlc3QnPjwvZGl2PiI7CgoJLy8gT3BlcmEgY2FuJ3QgZmluZCBhIHNlY29uZCBjbGFzc25hbWUgKGluIDkuNikKCS8vIEFsc28sIG1ha2Ugc3VyZSB0aGF0IGdldEVsZW1lbnRzQnlDbGFzc05hbWUgYWN0dWFsbHkgZXhpc3RzCglpZiAoICFkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCBkaXYuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgiZSIpLmxlbmd0aCA9PT0gMCApIHsKCQlyZXR1cm47Cgl9CgoJLy8gU2FmYXJpIGNhY2hlcyBjbGFzcyBhdHRyaWJ1dGVzLCBkb2Vzbid0IGNhdGNoIGNoYW5nZXMgKGluIDMuMikKCWRpdi5sYXN0Q2hpbGQuY2xhc3NOYW1lID0gImUiOwoKCWlmICggZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoImUiKS5sZW5ndGggPT09IDEgKSB7CgkJcmV0dXJuOwoJfQoJCglFeHByLm9yZGVyLnNwbGljZSgxLCAwLCAiQ0xBU1MiKTsKCUV4cHIuZmluZC5DTEFTUyA9IGZ1bmN0aW9uKCBtYXRjaCwgY29udGV4dCwgaXNYTUwgKSB7CgkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICE9PSAidW5kZWZpbmVkIiAmJiAhaXNYTUwgKSB7CgkJCXJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUobWF0Y2hbMV0pOwoJCX0KCX07CgoJLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKCWRpdiA9IG51bGw7Cn0pKCk7CgpmdW5jdGlvbiBkaXJOb2RlQ2hlY2soIGRpciwgY3VyLCBkb25lTmFtZSwgY2hlY2tTZXQsIG5vZGVDaGVjaywgaXNYTUwgKSB7Cglmb3IgKCB2YXIgaSA9IDAsIGwgPSBjaGVja1NldC5sZW5ndGg7IGkgPCBsOyBpKysgKSB7CgkJdmFyIGVsZW0gPSBjaGVja1NldFtpXTsKCgkJaWYgKCBlbGVtICkgewoJCQl2YXIgbWF0Y2ggPSBmYWxzZTsKCgkJCWVsZW0gPSBlbGVtW2Rpcl07CgoJCQl3aGlsZSAoIGVsZW0gKSB7CgkJCQlpZiAoIGVsZW0uc2l6Y2FjaGUgPT09IGRvbmVOYW1lICkgewoJCQkJCW1hdGNoID0gY2hlY2tTZXRbZWxlbS5zaXpzZXRdOwoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAhaXNYTUwgKXsKCQkJCQllbGVtLnNpemNhY2hlID0gZG9uZU5hbWU7CgkJCQkJZWxlbS5zaXpzZXQgPSBpOwoJCQkJfQoKCQkJCWlmICggZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBjdXIgKSB7CgkJCQkJbWF0Y2ggPSBlbGVtOwoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWVsZW0gPSBlbGVtW2Rpcl07CgkJCX0KCgkJCWNoZWNrU2V0W2ldID0gbWF0Y2g7CgkJfQoJfQp9CgpmdW5jdGlvbiBkaXJDaGVjayggZGlyLCBjdXIsIGRvbmVOYW1lLCBjaGVja1NldCwgbm9kZUNoZWNrLCBpc1hNTCApIHsKCWZvciAoIHZhciBpID0gMCwgbCA9IGNoZWNrU2V0Lmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQl2YXIgZWxlbSA9IGNoZWNrU2V0W2ldOwoKCQlpZiAoIGVsZW0gKSB7CgkJCXZhciBtYXRjaCA9IGZhbHNlOwoJCQkKCQkJZWxlbSA9IGVsZW1bZGlyXTsKCgkJCXdoaWxlICggZWxlbSApIHsKCQkJCWlmICggZWxlbS5zaXpjYWNoZSA9PT0gZG9uZU5hbWUgKSB7CgkJCQkJbWF0Y2ggPSBjaGVja1NldFtlbGVtLnNpenNldF07CgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCWlmICggIWlzWE1MICkgewoJCQkJCQllbGVtLnNpemNhY2hlID0gZG9uZU5hbWU7CgkJCQkJCWVsZW0uc2l6c2V0ID0gaTsKCQkJCQl9CgoJCQkJCWlmICggdHlwZW9mIGN1ciAhPT0gInN0cmluZyIgKSB7CgkJCQkJCWlmICggZWxlbSA9PT0gY3VyICkgewoJCQkJCQkJbWF0Y2ggPSB0cnVlOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCgkJCQkJfSBlbHNlIGlmICggU2l6emxlLmZpbHRlciggY3VyLCBbZWxlbV0gKS5sZW5ndGggPiAwICkgewoJCQkJCQltYXRjaCA9IGVsZW07CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCgkJCQllbGVtID0gZWxlbVtkaXJdOwoJCQl9CgoJCQljaGVja1NldFtpXSA9IG1hdGNoOwoJCX0KCX0KfQoKaWYgKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY29udGFpbnMgKSB7CglTaXp6bGUuY29udGFpbnMgPSBmdW5jdGlvbiggYSwgYiApIHsKCQlyZXR1cm4gYSAhPT0gYiAmJiAoYS5jb250YWlucyA/IGEuY29udGFpbnMoYikgOiB0cnVlKTsKCX07Cgp9IGVsc2UgaWYgKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY29tcGFyZURvY3VtZW50UG9zaXRpb24gKSB7CglTaXp6bGUuY29udGFpbnMgPSBmdW5jdGlvbiggYSwgYiApIHsKCQlyZXR1cm4gISEoYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSAmIDE2KTsKCX07Cgp9IGVsc2UgewoJU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGZhbHNlOwoJfTsKfQoKU2l6emxlLmlzWE1MID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkvLyBkb2N1bWVudEVsZW1lbnQgaXMgdmVyaWZpZWQgZm9yIGNhc2VzIHdoZXJlIGl0IGRvZXNuJ3QgeWV0IGV4aXN0CgkvLyAoc3VjaCBhcyBsb2FkaW5nIGlmcmFtZXMgaW4gSUUgLSAjNDgzMykgCgl2YXIgZG9jdW1lbnRFbGVtZW50ID0gKGVsZW0gPyBlbGVtLm93bmVyRG9jdW1lbnQgfHwgZWxlbSA6IDApLmRvY3VtZW50RWxlbWVudDsKCglyZXR1cm4gZG9jdW1lbnRFbGVtZW50ID8gZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9PSAiSFRNTCIgOiBmYWxzZTsKfTsKCnZhciBwb3NQcm9jZXNzID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJdmFyIG1hdGNoLAoJCXRtcFNldCA9IFtdLAoJCWxhdGVyID0gIiIsCgkJcm9vdCA9IGNvbnRleHQubm9kZVR5cGUgPyBbY29udGV4dF0gOiBjb250ZXh0OwoKCS8vIFBvc2l0aW9uIHNlbGVjdG9ycyBtdXN0IGJlIGRvbmUgYWZ0ZXIgdGhlIGZpbHRlcgoJLy8gQW5kIHNvIG11c3QgOm5vdChwb3NpdGlvbmFsKSBzbyB3ZSBtb3ZlIGFsbCBQU0VVRE9zIHRvIHRoZSBlbmQKCXdoaWxlICggKG1hdGNoID0gRXhwci5tYXRjaC5QU0VVRE8uZXhlYyggc2VsZWN0b3IgKSkgKSB7CgkJbGF0ZXIgKz0gbWF0Y2hbMF07CgkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBFeHByLm1hdGNoLlBTRVVETywgIiIgKTsKCX0KCglzZWxlY3RvciA9IEV4cHIucmVsYXRpdmVbc2VsZWN0b3JdID8gc2VsZWN0b3IgKyAiKiIgOiBzZWxlY3RvcjsKCglmb3IgKCB2YXIgaSA9IDAsIGwgPSByb290Lmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQlTaXp6bGUoIHNlbGVjdG9yLCByb290W2ldLCB0bXBTZXQgKTsKCX0KCglyZXR1cm4gU2l6emxlLmZpbHRlciggbGF0ZXIsIHRtcFNldCApOwp9OwoKLy8gRVhQT1NFCgp3aW5kb3cuU2l6emxlID0gU2l6emxlOwoKfSkoKTsKc25hY2sud3JhcC5kZWZpbmVFbmdpbmUoZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0KXsKICBpZiAodHlwZW9mIGNvbnRleHQgPT0gJ3N0cmluZycpCiAgICBjb250ZXh0ID0gU2l6emxlKGNvbnRleHQpWzBdCiAgcmV0dXJuIFNpenpsZShzZWxlY3RvciwgY29udGV4dCkKfSkK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 04:56:39 GMT",
                    "Content-Length": "49965",
                    "Date": "Sat, 08 Nov 2014 04:56:39 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}