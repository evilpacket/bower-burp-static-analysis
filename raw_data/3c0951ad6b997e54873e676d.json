{
    "url": "http://localhost:9999/basisjs/basis-library/basis.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cookie manipulation (DOM-based)",
    "issueType": 5245696,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based cookie manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the value of a cookie in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will set an arbitrary value in the user's cookie.<br><br>The potential impact of the vulnerability depends on the role that the cookie plays within the application. If the cookie is used to control the behavior that results from certain user actions (for example, a 'production' versus 'demo' mode setting), then the attacker may be able to cause the user to perform unintended actions by manipulating the cookie's value. If the cookie is used to track the user's session, then the attacker may be able to perform a session fixation attack, in which they set the cookie's value to a valid token that they have obtained from the application, and then hijack the session during the victim user's subsequent interaction with the application.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cookie manipulation vulnerabilities is not to dynamically write to cookies using data that originated from any untrusted source. This behavior should never be implemented for cookies that have any role in controlling privileged actions or user sessions within the application.",
    "issueDetail": "The application may be vulnerable to DOM-based cookie manipulation. Data is read from <b>location.pathname</b> and written to <b>document.cookie</b> via the following statement:<ul><li>document.cookie= nam ...in=\" + domain: \"\" ) </li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/basisjs/basis-library/basis.js",
                "path": "/basisjs/basis-library/basis.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9iYXNpc2pzL2Jhc2lzLWxpYnJhcnkvYmFzaXMuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTEzMDk2DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDEyOjExOjEwIEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAxMjoxMTowOCBHTVQNCg0KLy8gcmVzb3VyY2VzICgyNik6Ci8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9kYXRhL2RhdGFzZXQuanMgLT4gZC5qcwovLyAgW2Z1bmN0aW9uXSBsaWJyYXJ5LmpzIC0+IDAuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL2wxMG4uanMgLT4gMi5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvZXZlbnQuanMgLT4gMy5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvZGF0YS5qcyAtPiA0LmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9kb20vd3JhcHBlci5qcyAtPiA1LmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy90ZW1wbGF0ZS5qcyAtPiA2LmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy90ZW1wbGF0ZS9odG1sLmpzIC0+IDcuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL2RvbS9ldmVudC5qcyAtPiA4LmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy90ZW1wbGF0ZS9odG1sZmdlbi5qcyAtPiA5LmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9kcmFnZHJvcC5qcyAtPiBhLmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9kb20vY29tcHV0ZWRTdHlsZS5qcyAtPiBiLmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9sYXlvdXQuanMgLT4gYy5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvdWkuanMgLT4gMS5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvZGF0YS92YWx1ZS5qcyAtPiBlLmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9kYXRhL2luZGV4LmpzIC0+IGYuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL2RhdGEvb2JqZWN0LmpzIC0+IGcuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL2VudGl0eS5qcyAtPiBoLmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9uZXQvanNvbnAuanMgLT4gaS5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvbmV0LmpzIC0+IGouanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL25ldC9zZXJ2aWNlLmpzIC0+IGsuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL25ldC9hamF4LmpzIC0+IGwuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL3VhLmpzIC0+IG0uanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL25ldC9hY3Rpb24uanMgLT4gbi5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvcm91dGVyLmpzIC0+IG8uanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL2FwcC5qcyAtPiBwLmpzCi8vCi8vIGZpbGVsaXN0ICgxKTogCi8vICAgbGlicmFyeS5qcwooZnVuY3Rpb24oKXsKInVzZSBzdHJpY3QiOwoKdmFyIF9fbmFtZXNwYWNlX21hcF9fID0geyIwLmpzIjoibGlicmFyeSIsIjEuanMiOiJiYXNpcy51aSIsIjIuanMiOiJiYXNpcy5sMTBuIiwiMy5qcyI6ImJhc2lzLmV2ZW50IiwiNC5qcyI6ImJhc2lzLmRhdGEiLCI1LmpzIjoiYmFzaXMuZG9tLndyYXBwZXIiLCI2LmpzIjoiYmFzaXMudGVtcGxhdGUiLCI3LmpzIjoiYmFzaXMudGVtcGxhdGUuaHRtbCIsIjguanMiOiJiYXNpcy5kb20uZXZlbnQiLCI5LmpzIjoiYmFzaXMudGVtcGxhdGUuaHRtbGZnZW4iLCJhLmpzIjoiYmFzaXMuZHJhZ2Ryb3AiLCJiLmpzIjoiYmFzaXMuZG9tLmNvbXB1dGVkU3R5bGUiLCJjLmpzIjoiYmFzaXMubGF5b3V0IiwiZC5qcyI6ImJhc2lzLmRhdGEuZGF0YXNldCIsImUuanMiOiJiYXNpcy5kYXRhLnZhbHVlIiwiZi5qcyI6ImJhc2lzLmRhdGEuaW5kZXgiLCJnLmpzIjoiYmFzaXMuZGF0YS5vYmplY3QiLCJoLmpzIjoiYmFzaXMuZW50aXR5IiwiaS5qcyI6ImJhc2lzLm5ldC5qc29ucCIsImouanMiOiJiYXNpcy5uZXQiLCJrLmpzIjoiYmFzaXMubmV0LnNlcnZpY2UiLCJsLmpzIjoiYmFzaXMubmV0LmFqYXgiLCJtLmpzIjoiYmFzaXMudWEiLCJuLmpzIjoiYmFzaXMubmV0LmFjdGlvbiIsIm8uanMiOiJiYXNpcy5yb3V0ZXIiLCJwLmpzIjoiYmFzaXMuYXBwIn07CnZhciBsaWJyYXJ5OwoKdmFyIF9fcmVzb3VyY2VzX18gPSB7CiAgImQuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMy5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgb25lRnVuY3Rpb25Qcm9wZXJ0eSA9IENsYXNzLm9uZUZ1bmN0aW9uUHJvcGVydHk7CiAgICB2YXIgZXh0ZW5kID0gYmFzaXMub2JqZWN0LmV4dGVuZDsKICAgIHZhciB2YWx1ZXMgPSBiYXNpcy5vYmplY3QudmFsdWVzOwogICAgdmFyIGdldHRlciA9IGJhc2lzLmdldHRlcjsKICAgIHZhciAkc2VsZiA9IGJhc2lzLmZuLiRzZWxmOwogICAgdmFyICR0cnVlID0gYmFzaXMuZm4uJHRydWU7CiAgICB2YXIgJGZhbHNlID0gYmFzaXMuZm4uJGZhbHNlOwogICAgdmFyICR1bmRlZiA9IGJhc2lzLmZuLiR1bmRlZjsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheS5mcm9tOwogICAgdmFyIGNyZWF0ZUV2ZW50ID0gYmFzaXMuZXZlbnQuY3JlYXRlOwogICAgdmFyIFNVQlNDUklQVElPTiA9IGJhc2lzLmRhdGEuU1VCU0NSSVBUSU9OOwogICAgdmFyIERhdGFPYmplY3QgPSBiYXNpcy5kYXRhLk9iamVjdDsKICAgIHZhciBLZXlPYmplY3RNYXAgPSBiYXNpcy5kYXRhLktleU9iamVjdE1hcDsKICAgIHZhciBSZWFkT25seURhdGFzZXQgPSBiYXNpcy5kYXRhLlJlYWRPbmx5RGF0YXNldDsKICAgIHZhciBEYXRhc2V0ID0gYmFzaXMuZGF0YS5EYXRhc2V0OwogICAgdmFyIERhdGFzZXRXcmFwcGVyID0gYmFzaXMuZGF0YS5EYXRhc2V0V3JhcHBlcjsKICAgIHZhciBzZXRBY2N1bXVsYXRlU3RhdGUgPSBEYXRhc2V0LnNldEFjY3VtdWxhdGVTdGF0ZTsKICAgIFNVQlNDUklQVElPTi5hZGQoIlNPVVJDRSIsIHsKICAgICAgc291cmNlQ2hhbmdlZDogZnVuY3Rpb24ob2JqZWN0LCBvbGRTb3VyY2UpIHsKICAgICAgICBpZiAob2xkU291cmNlKSBTVUJTQ1JJUFRJT04udW5saW5rKCJzb3VyY2UiLCBvYmplY3QsIG9sZFNvdXJjZSk7CiAgICAgICAgaWYgKG9iamVjdC5zb3VyY2UpIFNVQlNDUklQVElPTi5saW5rKCJzb3VyY2UiLCBvYmplY3QsIG9iamVjdC5zb3VyY2UpOwogICAgICB9LAogICAgICBzb3VyY2VzQ2hhbmdlZDogZnVuY3Rpb24ob2JqZWN0LCBkZWx0YSkgewogICAgICAgIHZhciBhcnJheTsKICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5pbnNlcnRlZCkgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBhcnJheVtpXTsgaSsrKSBTVUJTQ1JJUFRJT04ubGluaygic291cmNlIiwgb2JqZWN0LCBhcnJheVtpXSk7CiAgICAgICAgaWYgKGFycmF5ID0gZGVsdGEuZGVsZXRlZCkgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBhcnJheVtpXTsgaSsrKSBTVUJTQ1JJUFRJT04udW5saW5rKCJzb3VyY2UiLCBvYmplY3QsIGFycmF5W2ldKTsKICAgICAgfQogICAgfSwgZnVuY3Rpb24oYWN0aW9uLCBvYmplY3QpIHsKICAgICAgdmFyIHNvdXJjZXMgPSBvYmplY3Quc291cmNlcyB8fCAob2JqZWN0LnNvdXJjZSA/IFsgb2JqZWN0LnNvdXJjZSBdIDogW10pOwogICAgICBmb3IgKHZhciBpID0gMCwgc291cmNlOyBzb3VyY2UgPSBzb3VyY2VzW2krK107ICkgYWN0aW9uKCJzb3VyY2UiLCBvYmplY3QsIHNvdXJjZSk7CiAgICB9KTsKICAgIFNVQlNDUklQVElPTi5hZGRQcm9wZXJ0eSgibWludWVuZCIpOwogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJzdWJ0cmFoZW5kIik7CiAgICBmdW5jdGlvbiBnZXREZWx0YShpbnNlcnRlZCwgZGVsZXRlZCkgewogICAgICB2YXIgZGVsdGEgPSB7fTsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgaWYgKGluc2VydGVkICYmIGluc2VydGVkLmxlbmd0aCkgcmVzdWx0ID0gZGVsdGEuaW5zZXJ0ZWQgPSBpbnNlcnRlZDsKICAgICAgaWYgKGRlbGV0ZWQgJiYgZGVsZXRlZC5sZW5ndGgpIHJlc3VsdCA9IGRlbHRhLmRlbGV0ZWQgPSBkZWxldGVkOwogICAgICBpZiAocmVzdWx0KSByZXR1cm4gZGVsdGE7CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVSdWxlRXZlbnRzKGZuLCBldmVudHMpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIGNyZWF0ZVJ1bGVFdmVudHNFeHRlbmQoZXZlbnRzKSB7CiAgICAgICAgaWYgKCFldmVudHMpIHJldHVybiBudWxsOwogICAgICAgIGlmIChldmVudHMuX19leHRlbmRfXykgcmV0dXJuIGV2ZW50czsKICAgICAgICBpZiAodHlwZW9mIGV2ZW50cyAhPSAic3RyaW5nIiAmJiAhQXJyYXkuaXNBcnJheShldmVudHMpKSBldmVudHMgPSBudWxsOwogICAgICAgIHJldHVybiBleHRlbmQoYmFzaXMuZXZlbnQuY3JlYXRlSGFuZGxlcihldmVudHMsIGZuKSwgewogICAgICAgICAgX19leHRlbmRfXzogY3JlYXRlUnVsZUV2ZW50c0V4dGVuZAogICAgICAgIH0pOwogICAgICB9KGV2ZW50cyk7CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVLZXlNYXAoY29uZmlnLCBrZXlHZXR0ZXIsIEl0ZW1DbGFzcywgU3Vic2V0Q2xhc3MpIHsKICAgICAgcmV0dXJuIG5ldyBLZXlPYmplY3RNYXAoZXh0ZW5kKHsKICAgICAgICBrZXlHZXR0ZXI6IGtleUdldHRlciwKICAgICAgICBpdGVtQ2xhc3M6IEl0ZW1DbGFzcywKICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uKGtleSwgb2JqZWN0KSB7CiAgICAgICAgICB2YXIgZGF0YXNldFdyYXBwZXIgPSBLZXlPYmplY3RNYXAucHJvdG90eXBlLmNyZWF0ZS5jYWxsKHRoaXMsIGtleSwgb2JqZWN0KTsKICAgICAgICAgIGRhdGFzZXRXcmFwcGVyLnJ1bGVWYWx1ZSA9IGtleTsKICAgICAgICAgIGRhdGFzZXRXcmFwcGVyLnNldERhdGFzZXQobmV3IFN1YnNldENsYXNzKHsKICAgICAgICAgICAgcnVsZVZhbHVlOiBrZXkKICAgICAgICAgIH0pKTsKICAgICAgICAgIHJldHVybiBkYXRhc2V0V3JhcHBlcjsKICAgICAgICB9CiAgICAgIH0sIGNvbmZpZykpOwogICAgfQogICAgdmFyIE1FUkdFX0RBVEFTRVRfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihzb3VyY2UsIGRlbHRhKSB7CiAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgdmFyIHVwZGF0ZWQgPSB7fTsKICAgICAgICB2YXIgb2JqZWN0OwogICAgICAgIHZhciBvYmplY3RJZDsKICAgICAgICBpZiAoZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBvYmplY3QgPSBkZWx0YS5pbnNlcnRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIG9iamVjdElkID0gb2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgIGlmIChtZW1iZXJNYXBbb2JqZWN0SWRdKSB7CiAgICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXS5jb3VudCsrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG1lbWJlck1hcFtvYmplY3RJZF0gPSB7CiAgICAgICAgICAgICAgICBjb3VudDogMSwKICAgICAgICAgICAgICAgIG9iamVjdDogb2JqZWN0CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVkW29iamVjdElkXSA9IG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWx0YS5kZWxldGVkKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgb2JqZWN0ID0gZGVsdGEuZGVsZXRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIG9iamVjdElkID0gb2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgIHVwZGF0ZWRbb2JqZWN0SWRdID0gbWVtYmVyTWFwW29iamVjdElkXTsKICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXS5jb3VudC0tOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmFwcGx5UnVsZSh1cGRhdGVkKTsKICAgICAgfQogICAgfTsKICAgIHZhciBNZXJnZSA9IENsYXNzKFJlYWRPbmx5RGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTWVyZ2UiLAogICAgICBzdWJzY3JpYmVUbzogU1VCU0NSSVBUSU9OLlNPVVJDRSwKICAgICAgZW1pdF9zb3VyY2VzQ2hhbmdlZDogY3JlYXRlRXZlbnQoInNvdXJjZXNDaGFuZ2VkIiwgImRlbHRhIiksCiAgICAgIHNvdXJjZXM6IG51bGwsCiAgICAgIHNvdXJjZVZhbHVlc186IG51bGwsCiAgICAgIHNvdXJjZXNNYXBfOiBudWxsLAogICAgICBzb3VyY2VEZWx0YV86IG51bGwsCiAgICAgIHJ1bGU6IGZ1bmN0aW9uKGNvdW50LCBzb3VyY2VDb3VudCkgewogICAgICAgIHJldHVybiBjb3VudCA+IDA7CiAgICAgIH0sCiAgICAgIGVtaXRfcnVsZUNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJydWxlQ2hhbmdlZCIsICJvbGRSdWxlIiksCiAgICAgIGxpc3RlbjogewogICAgICAgIHNvdXJjZTogTUVSR0VfREFUQVNFVF9IQU5ETEVSLAogICAgICAgIHNvdXJjZVZhbHVlOiB7CiAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbihzZW5kZXIpIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmVTb3VyY2Uoc2VuZGVyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIFJlYWRPbmx5RGF0YXNldC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBzb3VyY2VzID0gdGhpcy5zb3VyY2VzOwogICAgICAgIHRoaXMuc291cmNlcyA9IFtdOwogICAgICAgIHRoaXMuc291cmNlc01hcF8gPSB7fTsKICAgICAgICB0aGlzLnNvdXJjZVZhbHVlc18gPSBbXTsKICAgICAgICBpZiAoc291cmNlcykgdGhpcy5zZXRTb3VyY2VzKHNvdXJjZXMpOwogICAgICB9LAogICAgICBzZXRSdWxlOiBmdW5jdGlvbihydWxlKSB7CiAgICAgICAgcnVsZSA9IGdldHRlcihydWxlIHx8IE1lcmdlLlVOSU9OKTsKICAgICAgICBpZiAodGhpcy5ydWxlICE9PSBydWxlKSB7CiAgICAgICAgICB2YXIgb2xkUnVsZSA9IHRoaXMucnVsZTsKICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICB0aGlzLmVtaXRfcnVsZUNoYW5nZWQob2xkUnVsZSk7CiAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFwcGx5UnVsZTogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgcnVsZSA9IHRoaXMucnVsZTsKICAgICAgICB2YXIgc291cmNlQ291bnQgPSB0aGlzLnNvdXJjZXMubGVuZ3RoOwogICAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIG1lbWJlckNvdW50ZXI7CiAgICAgICAgdmFyIGlzTWVtYmVyOwogICAgICAgIHZhciBkZWx0YTsKICAgICAgICBpZiAoIXNjb3BlKSBzY29wZSA9IG1lbWJlck1hcDsKICAgICAgICBmb3IgKHZhciBvYmplY3RJZCBpbiBzY29wZSkgewogICAgICAgICAgbWVtYmVyQ291bnRlciA9IG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICBpc01lbWJlciA9IHNvdXJjZUNvdW50ICYmIG1lbWJlckNvdW50ZXIuY291bnQgJiYgcnVsZShtZW1iZXJDb3VudGVyLmNvdW50LCBzb3VyY2VDb3VudCk7CiAgICAgICAgICBpZiAoaXNNZW1iZXIgIT0gb2JqZWN0SWQgaW4gdGhpcy5pdGVtc18pIHsKICAgICAgICAgICAgaWYgKGlzTWVtYmVyKSBpbnNlcnRlZC5wdXNoKG1lbWJlckNvdW50ZXIub2JqZWN0KTsgZWxzZSBkZWxldGVkLnB1c2gobWVtYmVyQ291bnRlci5vYmplY3QpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1lbWJlckNvdW50ZXIuY291bnQgPT0gMCkgZGVsZXRlIG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgfQogICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICB9LAogICAgICBhZGREYXRhc2V0XzogZnVuY3Rpb24oZGF0YXNldCkgewogICAgICAgIHRoaXMuc291cmNlcy5wdXNoKGRhdGFzZXQpOwogICAgICAgIGlmICh0aGlzLmxpc3Rlbi5zb3VyY2UpIGRhdGFzZXQuYWRkSGFuZGxlcih0aGlzLmxpc3Rlbi5zb3VyY2UsIHRoaXMpOwogICAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICAgIGZvciAodmFyIG9iamVjdElkIGluIGRhdGFzZXQuaXRlbXNfKSB7CiAgICAgICAgICBpZiAobWVtYmVyTWFwW29iamVjdElkXSkgewogICAgICAgICAgICBtZW1iZXJNYXBbb2JqZWN0SWRdLmNvdW50Kys7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtZW1iZXJNYXBbb2JqZWN0SWRdID0gewogICAgICAgICAgICAgIGNvdW50OiAxLAogICAgICAgICAgICAgIG9iamVjdDogZGF0YXNldC5pdGVtc19bb2JqZWN0SWRdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9LAogICAgICByZW1vdmVEYXRhc2V0XzogZnVuY3Rpb24oZGF0YXNldCkgewogICAgICAgIGJhc2lzLmFycmF5LnJlbW92ZSh0aGlzLnNvdXJjZXMsIGRhdGFzZXQpOwogICAgICAgIGlmICh0aGlzLmxpc3Rlbi5zb3VyY2UpIGRhdGFzZXQucmVtb3ZlSGFuZGxlcih0aGlzLmxpc3Rlbi5zb3VyY2UsIHRoaXMpOwogICAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICAgIGZvciAodmFyIG9iamVjdElkIGluIGRhdGFzZXQuaXRlbXNfKSBtZW1iZXJNYXBbb2JqZWN0SWRdLmNvdW50LS07CiAgICAgIH0sCiAgICAgIHVwZGF0ZURhdGFzZXRfOiBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICB2YXIgbWVyZ2UgPSB0aGlzLm93bmVyOwogICAgICAgIHZhciBzb3VyY2VzTWFwXyA9IG1lcmdlLnNvdXJjZXNNYXBfOwogICAgICAgIHZhciBkYXRhc2V0ID0gYmFzaXMuZGF0YS5yZXNvbHZlRGF0YXNldCh0aGlzLCBtZXJnZS51cGRhdGVEYXRhc2V0Xywgc291cmNlLCAiYWRhcHRlciIpOwogICAgICAgIHZhciBpbnNlcnRlZDsKICAgICAgICB2YXIgZGVsZXRlZDsKICAgICAgICB2YXIgZGVsdGE7CiAgICAgICAgaWYgKHRoaXMuZGF0YXNldCA9PT0gZGF0YXNldCkgcmV0dXJuOwogICAgICAgIGlmIChkYXRhc2V0KSB7CiAgICAgICAgICB2YXIgY291bnQgPSAoc291cmNlc01hcF9bZGF0YXNldC5iYXNpc09iamVjdElkXSB8fCAwKSArIDE7CiAgICAgICAgICBzb3VyY2VzTWFwX1tkYXRhc2V0LmJhc2lzT2JqZWN0SWRdID0gY291bnQ7CiAgICAgICAgICBpZiAoY291bnQgPT0gMSkgewogICAgICAgICAgICBtZXJnZS5hZGREYXRhc2V0XyhkYXRhc2V0KTsKICAgICAgICAgICAgaW5zZXJ0ZWQgPSBbIGRhdGFzZXQgXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuZGF0YXNldCkgewogICAgICAgICAgdmFyIGNvdW50ID0gKHNvdXJjZXNNYXBfW3RoaXMuZGF0YXNldC5iYXNpc09iamVjdElkXSB8fCAwKSAtIDE7CiAgICAgICAgICBzb3VyY2VzTWFwX1t0aGlzLmRhdGFzZXQuYmFzaXNPYmplY3RJZF0gPSBjb3VudDsKICAgICAgICAgIGlmIChjb3VudCA9PSAwKSB7CiAgICAgICAgICAgIG1lcmdlLnJlbW92ZURhdGFzZXRfKHRoaXMuZGF0YXNldCk7CiAgICAgICAgICAgIGRlbGV0ZWQgPSBbIHRoaXMuZGF0YXNldCBdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmRhdGFzZXQgPSBkYXRhc2V0OwogICAgICAgIG1lcmdlLmFwcGx5UnVsZSgpOwogICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgewogICAgICAgICAgdmFyIHNldFNvdXJjZXNUcmFuc2FjdGlvbiA9IG1lcmdlLnNvdXJjZURlbHRhXzsKICAgICAgICAgIGlmIChzZXRTb3VyY2VzVHJhbnNhY3Rpb24pIHsKICAgICAgICAgICAgaWYgKGRlbHRhLmluc2VydGVkKSBkZWx0YS5pbnNlcnRlZC5mb3JFYWNoKGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgICAgICAgIGlmICghYmFzaXMuYXJyYXkucmVtb3ZlKHRoaXMuZGVsZXRlZCwgc291cmNlKSkgYmFzaXMuYXJyYXkuYWRkKHRoaXMuaW5zZXJ0ZWQsIHNvdXJjZSk7CiAgICAgICAgICAgIH0sIHNldFNvdXJjZXNUcmFuc2FjdGlvbik7CiAgICAgICAgICAgIGlmIChkZWx0YS5kZWxldGVkKSBkZWx0YS5kZWxldGVkLmZvckVhY2goZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgICAgICAgaWYgKCFiYXNpcy5hcnJheS5yZW1vdmUodGhpcy5pbnNlcnRlZCwgc291cmNlKSkgYmFzaXMuYXJyYXkuYWRkKHRoaXMuZGVsZXRlZCwgc291cmNlKTsKICAgICAgICAgICAgfSwgc2V0U291cmNlc1RyYW5zYWN0aW9uKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1lcmdlLmVtaXRfc291cmNlc0NoYW5nZWQoZGVsdGEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIGdldFNvdXJjZVZhbHVlczogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc291cmNlVmFsdWVzXy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgcmV0dXJuIGl0ZW0uc291cmNlOwogICAgICAgIH0pOwogICAgICB9LAogICAgICBhZGRTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIGlmICghc291cmNlIHx8IHR5cGVvZiBzb3VyY2UgIT0gIm9iamVjdCIgJiYgdHlwZW9mIHNvdXJjZSAhPSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2Fybih0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSArICIuYWRkU291cmNlOiB2YWx1ZSBzaG91bGQgYmUgYSBkYXRhc2V0IGluc3RhbmNlIG9yIHRvIGJlIGFibGUgdG8gcmVzb2x2ZSBpbiBkYXRhc2V0Iik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmhhc1NvdXJjZShzb3VyY2UpKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2Fybih0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSArICIuYWRkU291cmNlOiB2YWx1ZSBpcyBhbHJlYWR5IGluIHNvdXJjZSBsaXN0Iik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBzb3VyY2VJbmZvID0gewogICAgICAgICAgb3duZXI6IHRoaXMsCiAgICAgICAgICBzb3VyY2U6IHNvdXJjZSwKICAgICAgICAgIGFkYXB0ZXI6IG51bGwsCiAgICAgICAgICBkYXRhc2V0OiBudWxsCiAgICAgICAgfTsKICAgICAgICB0aGlzLnNvdXJjZVZhbHVlc18ucHVzaChzb3VyY2VJbmZvKTsKICAgICAgICB0aGlzLnVwZGF0ZURhdGFzZXRfLmNhbGwoc291cmNlSW5mbywgc291cmNlKTsKICAgICAgICBpZiAodGhpcy5saXN0ZW4uc291cmNlVmFsdWUgJiYgc291cmNlIGluc3RhbmNlb2YgYmFzaXMuZXZlbnQuRW1pdHRlcikgc291cmNlLmFkZEhhbmRsZXIodGhpcy5saXN0ZW4uc291cmNlVmFsdWUsIHRoaXMpOwogICAgICB9LAogICAgICByZW1vdmVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBzb3VyY2VJbmZvOyBzb3VyY2VJbmZvID0gdGhpcy5zb3VyY2VWYWx1ZXNfW2ldOyBpKyspIGlmIChzb3VyY2VJbmZvLnNvdXJjZSA9PT0gc291cmNlKSB7CiAgICAgICAgICBpZiAodGhpcy5saXN0ZW4uc291cmNlVmFsdWUgJiYgc291cmNlIGluc3RhbmNlb2YgYmFzaXMuZXZlbnQuRW1pdHRlcikgc291cmNlLnJlbW92ZUhhbmRsZXIodGhpcy5saXN0ZW4uc291cmNlVmFsdWUsIHRoaXMpOwogICAgICAgICAgdGhpcy51cGRhdGVEYXRhc2V0Xy5jYWxsKHNvdXJjZUluZm8sIG51bGwpOwogICAgICAgICAgdGhpcy5zb3VyY2VWYWx1ZXNfLnNwbGljZShpLCAxKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgYmFzaXMuZGV2Lndhcm4odGhpcy5jb25zdHJ1Y3Rvci5jbGFzc05hbWUgKyAiLnJlbW92ZVNvdXJjZTogc291cmNlIHZhbHVlIGlzbid0IGZvdW5kIGluIHNvdXJjZSBsaXN0Iik7CiAgICAgIH0sCiAgICAgIGhhc1NvdXJjZTogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIHNvdXJjZUluZm87IHNvdXJjZUluZm8gPSB0aGlzLnNvdXJjZVZhbHVlc19baV07IGkrKykgaWYgKHNvdXJjZUluZm8uc291cmNlID09PSBzb3VyY2UpIHJldHVybiB0cnVlOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgc2V0U291cmNlczogZnVuY3Rpb24oc291cmNlcykgewogICAgICAgIHZhciBleGlzdHMgPSB0aGlzLnNvdXJjZVZhbHVlc18ubWFwKGZ1bmN0aW9uKHNvdXJjZUluZm8pIHsKICAgICAgICAgIHJldHVybiBzb3VyY2VJbmZvLnNvdXJjZTsKICAgICAgICB9KTsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICAgIHZhciBkZWx0YTsKICAgICAgICBpZiAoIXNvdXJjZXMpIHNvdXJjZXMgPSBbXTsKICAgICAgICB0aGlzLnNvdXJjZURlbHRhXyA9IHsKICAgICAgICAgIGluc2VydGVkOiBpbnNlcnRlZCwKICAgICAgICAgIGRlbGV0ZWQ6IGRlbGV0ZWQKICAgICAgICB9OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc291cmNlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIHNvdXJjZSA9IHNvdXJjZXNbaV07CiAgICAgICAgICBpZiAoIWJhc2lzLmFycmF5LnJlbW92ZShleGlzdHMsIHNvdXJjZSkpIHRoaXMuYWRkU291cmNlKHNvdXJjZSk7CiAgICAgICAgfQogICAgICAgIGV4aXN0cy5mb3JFYWNoKHRoaXMucmVtb3ZlU291cmNlLCB0aGlzKTsKICAgICAgICB0aGlzLnNvdXJjZURlbHRhXyA9IG51bGw7CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfc291cmNlc0NoYW5nZWQoZGVsdGEpOwogICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXRTb3VyY2VzKCk7CiAgICAgICAgUmVhZE9ubHlEYXRhc2V0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5zb3VyY2VWYWx1ZXNfID0gbnVsbDsKICAgICAgICB0aGlzLnNvdXJjZXNNYXBfID0gbnVsbDsKICAgICAgICB0aGlzLnNvdXJjZURlbHRhXyA9IG51bGw7CiAgICAgICAgdGhpcy5zb3VyY2VzID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICBNZXJnZS5VTklPTiA9IE1lcmdlLnByb3RvdHlwZS5ydWxlOwogICAgTWVyZ2UuSU5URVJTRUNUSU9OID0gZnVuY3Rpb24oY291bnQsIHNvdXJjZUNvdW50KSB7CiAgICAgIHJldHVybiBjb3VudCA9PSBzb3VyY2VDb3VudDsKICAgIH07CiAgICBNZXJnZS5ESUZGRVJFTkNFID0gZnVuY3Rpb24oY291bnQsIHNvdXJjZUNvdW50KSB7CiAgICAgIHJldHVybiBjb3VudCA9PSAxOwogICAgfTsKICAgIE1lcmdlLk1PUkVfVEhBTl9PTkVfSU5DTFVERSA9IGZ1bmN0aW9uKGNvdW50LCBzb3VyY2VDb3VudCkgewogICAgICByZXR1cm4gc291cmNlQ291bnQgPT0gMSB8fCBjb3VudCA+IDE7CiAgICB9OwogICAgTWVyZ2UuQVRfTEVBU1RfT05FX0VYQ0xVREUgPSBmdW5jdGlvbihjb3VudCwgc291cmNlQ291bnQpIHsKICAgICAgcmV0dXJuIHNvdXJjZUNvdW50ID09IDEgfHwgY291bnQgPCBzb3VyY2VDb3VudDsKICAgIH07CiAgICB2YXIgZGF0YXNldEFic2VudEZpbHRlciA9IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuICF0aGlzLmhhcyhpdGVtKTsKICAgIH07CiAgICB2YXIgU1VCVFJBQ1REQVRBU0VUX01JTlVFTkRfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihkYXRhc2V0LCBkZWx0YSkgewogICAgICAgIGlmICghdGhpcy5zdWJ0cmFoZW5kKSByZXR1cm47CiAgICAgICAgdmFyIG5ld0RlbHRhID0gZ2V0RGVsdGEoZGVsdGEuaW5zZXJ0ZWQgJiYgZGVsdGEuaW5zZXJ0ZWQuZmlsdGVyKGRhdGFzZXRBYnNlbnRGaWx0ZXIsIHRoaXMuc3VidHJhaGVuZCksIGRlbHRhLmRlbGV0ZWQgJiYgZGVsdGEuZGVsZXRlZC5maWx0ZXIodGhpcy5oYXMsIHRoaXMpKTsKICAgICAgICBpZiAobmV3RGVsdGEpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQobmV3RGVsdGEpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMubWludWVuZEFkYXB0ZXJfKSB0aGlzLnNldE1pbnVlbmQobnVsbCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgU1VCVFJBQ1REQVRBU0VUX1NVQlRSQUhFTkRfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihkYXRhc2V0LCBkZWx0YSkgewogICAgICAgIGlmICghdGhpcy5taW51ZW5kKSByZXR1cm47CiAgICAgICAgdmFyIG5ld0RlbHRhID0gZ2V0RGVsdGEoZGVsdGEuZGVsZXRlZCAmJiBkZWx0YS5kZWxldGVkLmZpbHRlcih0aGlzLm1pbnVlbmQuaGFzLCB0aGlzLm1pbnVlbmQpLCBkZWx0YS5pbnNlcnRlZCAmJiBkZWx0YS5pbnNlcnRlZC5maWx0ZXIodGhpcy5oYXMsIHRoaXMpKTsKICAgICAgICBpZiAobmV3RGVsdGEpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQobmV3RGVsdGEpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuc3VidHJhaGVuZEFkYXB0ZXJfKSB0aGlzLnNldFN1YnRyYWhlbmQobnVsbCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgU3VidHJhY3QgPSBDbGFzcyhSZWFkT25seURhdGFzZXQsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlN1YnRyYWN0IiwKICAgICAgc3Vic2NyaWJlVG86IFNVQlNDUklQVElPTi5NSU5VRU5EICsgU1VCU0NSSVBUSU9OLlNVQlRSQUhFTkQsCiAgICAgIG1pbnVlbmQ6IG51bGwsCiAgICAgIG1pbnVlbmRBZGFwdGVyXzogbnVsbCwKICAgICAgZW1pdF9taW51ZW5kQ2hhbmdlZDogY3JlYXRlRXZlbnQoIm1pbnVlbmRDaGFuZ2VkIiwgIm9sZE1pbnVlbmQiKSwKICAgICAgc3VidHJhaGVuZDogbnVsbCwKICAgICAgc3VidHJhaGVuZEFkYXB0ZXJfOiBudWxsLAogICAgICBlbWl0X3N1YnRyYWhlbmRDaGFuZ2VkOiBjcmVhdGVFdmVudCgic3VidHJhaGVuZENoYW5nZWQiLCAib2xkU3VidHJhaGVuZCIpLAogICAgICBsaXN0ZW46IHsKICAgICAgICBtaW51ZW5kOiBTVUJUUkFDVERBVEFTRVRfTUlOVUVORF9IQU5ETEVSLAogICAgICAgIHN1YnRyYWhlbmQ6IFNVQlRSQUNUREFUQVNFVF9TVUJUUkFIRU5EX0hBTkRMRVIKICAgICAgfSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgUmVhZE9ubHlEYXRhc2V0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIG1pbnVlbmQgPSB0aGlzLm1pbnVlbmQ7CiAgICAgICAgdmFyIHN1YnRyYWhlbmQgPSB0aGlzLnN1YnRyYWhlbmQ7CiAgICAgICAgdGhpcy5taW51ZW5kID0gbnVsbDsKICAgICAgICB0aGlzLnN1YnRyYWhlbmQgPSBudWxsOwogICAgICAgIGlmIChtaW51ZW5kIHx8IHN1YnRyYWhlbmQpIHRoaXMuc2V0T3BlcmFuZHMobWludWVuZCwgc3VidHJhaGVuZCk7CiAgICAgIH0sCiAgICAgIHNldE9wZXJhbmRzOiBmdW5jdGlvbihtaW51ZW5kLCBzdWJ0cmFoZW5kKSB7CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIHZhciBvcGVyYW5kc0NoYW5nZWQgPSBmYWxzZTsKICAgICAgICBtaW51ZW5kID0gYmFzaXMuZGF0YS5yZXNvbHZlRGF0YXNldCh0aGlzLCB0aGlzLnNldE1pbnVlbmQsIG1pbnVlbmQsICJtaW51ZW5kQWRhcHRlcl8iKTsKICAgICAgICBzdWJ0cmFoZW5kID0gYmFzaXMuZGF0YS5yZXNvbHZlRGF0YXNldCh0aGlzLCB0aGlzLnNldFN1YnRyYWhlbmQsIHN1YnRyYWhlbmQsICJzdWJ0cmFoZW5kQWRhcHRlcl8iKTsKICAgICAgICB2YXIgb2xkTWludWVuZCA9IHRoaXMubWludWVuZDsKICAgICAgICB2YXIgb2xkU3VidHJhaGVuZCA9IHRoaXMuc3VidHJhaGVuZDsKICAgICAgICBpZiAob2xkTWludWVuZCAhPT0gbWludWVuZCkgewogICAgICAgICAgb3BlcmFuZHNDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgIHRoaXMubWludWVuZCA9IG1pbnVlbmQ7CiAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLm1pbnVlbmQ7CiAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgewogICAgICAgICAgICBpZiAob2xkTWludWVuZCkgb2xkTWludWVuZC5yZW1vdmVIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICBpZiAobWludWVuZCkgbWludWVuZC5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lbWl0X21pbnVlbmRDaGFuZ2VkKG9sZE1pbnVlbmQpOwogICAgICAgIH0KICAgICAgICBpZiAob2xkU3VidHJhaGVuZCAhPT0gc3VidHJhaGVuZCkgewogICAgICAgICAgb3BlcmFuZHNDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgIHRoaXMuc3VidHJhaGVuZCA9IHN1YnRyYWhlbmQ7CiAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLnN1YnRyYWhlbmQ7CiAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgewogICAgICAgICAgICBpZiAob2xkU3VidHJhaGVuZCkgb2xkU3VidHJhaGVuZC5yZW1vdmVIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICBpZiAoc3VidHJhaGVuZCkgc3VidHJhaGVuZC5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lbWl0X3N1YnRyYWhlbmRDaGFuZ2VkKG9sZFN1YnRyYWhlbmQpOwogICAgICAgIH0KICAgICAgICBpZiAoIW9wZXJhbmRzQ2hhbmdlZCkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmICghbWludWVuZCB8fCAhc3VidHJhaGVuZCkgewogICAgICAgICAgaWYgKHRoaXMuaXRlbUNvdW50KSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhID0gewogICAgICAgICAgICBkZWxldGVkOiB0aGlzLmdldEl0ZW1zKCkKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5pdGVtc18pIGlmICghbWludWVuZC5pdGVtc19ba2V5XSB8fCBzdWJ0cmFoZW5kLml0ZW1zX1trZXldKSBkZWxldGVkLnB1c2godGhpcy5pdGVtc19ba2V5XSk7CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbWludWVuZC5pdGVtc18pIGlmICghdGhpcy5pdGVtc19ba2V5XSAmJiAhc3VidHJhaGVuZC5pdGVtc19ba2V5XSkgaW5zZXJ0ZWQucHVzaChtaW51ZW5kLml0ZW1zX1trZXldKTsKICAgICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgfSwKICAgICAgc2V0TWludWVuZDogZnVuY3Rpb24obWludWVuZCkgewogICAgICAgIHJldHVybiB0aGlzLnNldE9wZXJhbmRzKG1pbnVlbmQsIHRoaXMuc3VidHJhaGVuZEFkYXB0ZXJfID8gdGhpcy5zdWJ0cmFoZW5kQWRhcHRlcl8uc291cmNlIDogdGhpcy5zdWJ0cmFoZW5kKTsKICAgICAgfSwKICAgICAgc2V0U3VidHJhaGVuZDogZnVuY3Rpb24oc3VidHJhaGVuZCkgewogICAgICAgIHJldHVybiB0aGlzLnNldE9wZXJhbmRzKHRoaXMubWludWVuZEFkYXB0ZXJfID8gdGhpcy5taW51ZW5kQWRhcHRlcl8uc291cmNlIDogdGhpcy5taW51ZW5kLCBzdWJ0cmFoZW5kKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXRPcGVyYW5kcygpOwogICAgICAgIFJlYWRPbmx5RGF0YXNldC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBTb3VyY2VEYXRhc2V0ID0gQ2xhc3MoUmVhZE9ubHlEYXRhc2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Tb3VyY2VEYXRhc2V0IiwKICAgICAgc3Vic2NyaWJlVG86IFNVQlNDUklQVElPTi5TT1VSQ0UsCiAgICAgIHNvdXJjZTogbnVsbCwKICAgICAgZW1pdF9zb3VyY2VDaGFuZ2VkOiBjcmVhdGVFdmVudCgic291cmNlQ2hhbmdlZCIsICJvbGRTb3VyY2UiKSwKICAgICAgc291cmNlQWRhcHRlcl86IG51bGwsCiAgICAgIHNvdXJjZU1hcF86IG51bGwsCiAgICAgIGxpc3RlbjogewogICAgICAgIHNvdXJjZTogewogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5zb3VyY2VBZGFwdGVyXykgdGhpcy5zZXRTb3VyY2UoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc291cmNlTWFwXyA9IHt9OwogICAgICAgIFJlYWRPbmx5RGF0YXNldC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBzb3VyY2UgPSB0aGlzLnNvdXJjZTsKICAgICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgICB0aGlzLnNvdXJjZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnNldFNvdXJjZShzb3VyY2UpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0U291cmNlOiBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICBzb3VyY2UgPSBiYXNpcy5kYXRhLnJlc29sdmVEYXRhc2V0KHRoaXMsIHRoaXMuc2V0U291cmNlLCBzb3VyY2UsICJzb3VyY2VBZGFwdGVyXyIpOwogICAgICAgIGlmICh0aGlzLnNvdXJjZSAhPT0gc291cmNlKSB7CiAgICAgICAgICB2YXIgb2xkU291cmNlID0gdGhpcy5zb3VyY2U7CiAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLnNvdXJjZTsKICAgICAgICAgIHRoaXMuc291cmNlID0gc291cmNlOwogICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgICAgdmFyIGl0ZW1zQ2hhbmdlZEhhbmRsZXIgPSBsaXN0ZW5IYW5kbGVyLml0ZW1zQ2hhbmdlZDsKICAgICAgICAgICAgc2V0QWNjdW11bGF0ZVN0YXRlKHRydWUpOwogICAgICAgICAgICBpZiAob2xkU291cmNlKSB7CiAgICAgICAgICAgICAgb2xkU291cmNlLnJlbW92ZUhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKGl0ZW1zQ2hhbmdlZEhhbmRsZXIpIGl0ZW1zQ2hhbmdlZEhhbmRsZXIuY2FsbCh0aGlzLCBvbGRTb3VyY2UsIHsKICAgICAgICAgICAgICAgIGRlbGV0ZWQ6IG9sZFNvdXJjZS5nZXRJdGVtcygpCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgICAgIHNvdXJjZS5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICAgIGlmIChpdGVtc0NoYW5nZWRIYW5kbGVyKSBpdGVtc0NoYW5nZWRIYW5kbGVyLmNhbGwodGhpcywgc291cmNlLCB7CiAgICAgICAgICAgICAgICBpbnNlcnRlZDogc291cmNlLmdldEl0ZW1zKCkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRBY2N1bXVsYXRlU3RhdGUoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lbWl0X3NvdXJjZUNoYW5nZWQob2xkU291cmNlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2V0U291cmNlKCk7CiAgICAgICAgUmVhZE9ubHlEYXRhc2V0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5zb3VyY2VNYXBfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgTUFQRklMVEVSX1NPVVJDRU9CSkVDVF9VUERBVEUgPSBmdW5jdGlvbihzb3VyY2VPYmplY3QpIHsKICAgICAgdmFyIG5ld01lbWJlciA9IHRoaXMubWFwID8gdGhpcy5tYXAoc291cmNlT2JqZWN0KSA6IG9iamVjdDsKICAgICAgaWYgKG5ld01lbWJlciBpbnN0YW5jZW9mIERhdGFPYmplY3QgPT0gZmFsc2UgfHwgdGhpcy5maWx0ZXIobmV3TWVtYmVyKSkgbmV3TWVtYmVyID0gbnVsbDsKICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwX1tzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgIHZhciBjdXJNZW1iZXIgPSBzb3VyY2VNYXAubWVtYmVyOwogICAgICBpZiAoY3VyTWVtYmVyICE9PSBuZXdNZW1iZXIpIHsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgZGVsdGE7CiAgICAgICAgdmFyIGluc2VydGVkOwogICAgICAgIHZhciBkZWxldGVkOwogICAgICAgIHNvdXJjZU1hcC5tZW1iZXIgPSBuZXdNZW1iZXI7CiAgICAgICAgaWYgKGN1ck1lbWJlcikgewogICAgICAgICAgdmFyIGN1ck1lbWJlcklkID0gY3VyTWVtYmVyLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICBpZiAodGhpcy5yZW1vdmVNZW1iZXJSZWYpIHRoaXMucmVtb3ZlTWVtYmVyUmVmKGN1ck1lbWJlciwgc291cmNlT2JqZWN0KTsKICAgICAgICAgIGlmICgtLW1lbWJlck1hcFtjdXJNZW1iZXJJZF0gPT0gMCkgewogICAgICAgICAgICBkZWxldGUgbWVtYmVyTWFwW2N1ck1lbWJlcklkXTsKICAgICAgICAgICAgZGVsZXRlZCA9IFsgY3VyTWVtYmVyIF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChuZXdNZW1iZXIpIHsKICAgICAgICAgIHZhciBuZXdNZW1iZXJJZCA9IG5ld01lbWJlci5iYXNpc09iamVjdElkOwogICAgICAgICAgaWYgKHRoaXMuYWRkTWVtYmVyUmVmKSB0aGlzLmFkZE1lbWJlclJlZihuZXdNZW1iZXIsIHNvdXJjZU9iamVjdCk7CiAgICAgICAgICBpZiAobWVtYmVyTWFwW25ld01lbWJlcklkXSkgewogICAgICAgICAgICBtZW1iZXJNYXBbbmV3TWVtYmVySWRdKys7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtZW1iZXJNYXBbbmV3TWVtYmVySWRdID0gMTsKICAgICAgICAgICAgaW5zZXJ0ZWQgPSBbIG5ld01lbWJlciBdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsdGEgPSBnZXREZWx0YShpbnNlcnRlZCwgZGVsZXRlZCkpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEpOwogICAgICB9CiAgICB9OwogICAgdmFyIE1BUEZJTFRFUl9TT1VSQ0VfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihzb3VyY2UsIGRlbHRhKSB7CiAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwXzsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICAgIHZhciBzb3VyY2VPYmplY3Q7CiAgICAgICAgdmFyIHNvdXJjZU9iamVjdElkOwogICAgICAgIHZhciBtZW1iZXI7CiAgICAgICAgdmFyIHVwZGF0ZUhhbmRsZXIgPSB0aGlzLnJ1bGVFdmVudHM7CiAgICAgICAgc2V0QWNjdW11bGF0ZVN0YXRlKHRydWUpOwogICAgICAgIGlmIChkZWx0YS5pbnNlcnRlZCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNvdXJjZU9iamVjdCA9IGRlbHRhLmluc2VydGVkW2ldOyBpKyspIHsKICAgICAgICAgICAgbWVtYmVyID0gdGhpcy5tYXAgPyB0aGlzLm1hcChzb3VyY2VPYmplY3QpIDogc291cmNlT2JqZWN0OwogICAgICAgICAgICBpZiAobWVtYmVyIGluc3RhbmNlb2YgRGF0YU9iamVjdCA9PSBmYWxzZSB8fCB0aGlzLmZpbHRlcihtZW1iZXIpKSBtZW1iZXIgPSBudWxsOwogICAgICAgICAgICBpZiAodXBkYXRlSGFuZGxlcikgc291cmNlT2JqZWN0LmFkZEhhbmRsZXIodXBkYXRlSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgIHNvdXJjZU1hcFtzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZF0gPSB7CiAgICAgICAgICAgICAgc291cmNlT2JqZWN0OiBzb3VyY2VPYmplY3QsCiAgICAgICAgICAgICAgbWVtYmVyOiBtZW1iZXIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKG1lbWJlcikgewogICAgICAgICAgICAgIHZhciBtZW1iZXJJZCA9IG1lbWJlci5iYXNpc09iamVjdElkOwogICAgICAgICAgICAgIGlmIChtZW1iZXJNYXBbbWVtYmVySWRdKSB7CiAgICAgICAgICAgICAgICBtZW1iZXJNYXBbbWVtYmVySWRdKys7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1lbWJlck1hcFttZW1iZXJJZF0gPSAxOwogICAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChtZW1iZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGhpcy5hZGRNZW1iZXJSZWYpIHRoaXMuYWRkTWVtYmVyUmVmKG1lbWJlciwgc291cmNlT2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsdGEuZGVsZXRlZCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNvdXJjZU9iamVjdCA9IGRlbHRhLmRlbGV0ZWRbaV07IGkrKykgewogICAgICAgICAgICBzb3VyY2VPYmplY3RJZCA9IHNvdXJjZU9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgICBtZW1iZXIgPSBzb3VyY2VNYXBbc291cmNlT2JqZWN0SWRdLm1lbWJlcjsKICAgICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5yZW1vdmVIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICBkZWxldGUgc291cmNlTWFwW3NvdXJjZU9iamVjdElkXTsKICAgICAgICAgICAgaWYgKG1lbWJlcikgewogICAgICAgICAgICAgIHZhciBtZW1iZXJJZCA9IG1lbWJlci5iYXNpc09iamVjdElkOwogICAgICAgICAgICAgIGlmICgtLW1lbWJlck1hcFttZW1iZXJJZF0gPT0gMCkgewogICAgICAgICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFttZW1iZXJJZF07CiAgICAgICAgICAgICAgICBkZWxldGVkLnB1c2gobWVtYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRoaXMucmVtb3ZlTWVtYmVyUmVmKSB0aGlzLnJlbW92ZU1lbWJlclJlZihtZW1iZXIsIHNvdXJjZU9iamVjdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2V0QWNjdW11bGF0ZVN0YXRlKGZhbHNlKTsKICAgICAgICBpZiAoZGVsdGEgPSBnZXREZWx0YShpbnNlcnRlZCwgZGVsZXRlZCkpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEpOwogICAgICB9CiAgICB9OwogICAgdmFyIE1hcEZpbHRlciA9IENsYXNzKFNvdXJjZURhdGFzZXQsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLk1hcEZpbHRlciIsCiAgICAgIG1hcDogJHNlbGYsCiAgICAgIGZpbHRlcjogJGZhbHNlLAogICAgICBydWxlOiBnZXR0ZXIoJHRydWUpLAogICAgICBlbWl0X3J1bGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgicnVsZUNoYW5nZWQiLCAib2xkUnVsZSIpLAogICAgICBydWxlRXZlbnRzOiBjcmVhdGVSdWxlRXZlbnRzKE1BUEZJTFRFUl9TT1VSQ0VPQkpFQ1RfVVBEQVRFLCAidXBkYXRlIiksCiAgICAgIGFkZE1lbWJlclJlZjogbnVsbCwKICAgICAgcmVtb3ZlTWVtYmVyUmVmOiBudWxsLAogICAgICBsaXN0ZW46IHsKICAgICAgICBzb3VyY2U6IE1BUEZJTFRFUl9TT1VSQ0VfSEFORExFUgogICAgICB9LAogICAgICBzZXRNYXA6IGZ1bmN0aW9uKG1hcCkgewogICAgICAgIGlmICh0eXBlb2YgbWFwICE9ICJmdW5jdGlvbiIpIG1hcCA9ICRzZWxmOwogICAgICAgIGlmICh0aGlzLm1hcCAhPT0gbWFwKSB7CiAgICAgICAgICB0aGlzLm1hcCA9IG1hcDsKICAgICAgICAgIHJldHVybiB0aGlzLmFwcGx5UnVsZSgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0RmlsdGVyOiBmdW5jdGlvbihmaWx0ZXIpIHsKICAgICAgICBpZiAodHlwZW9mIGZpbHRlciAhPSAiZnVuY3Rpb24iKSBmaWx0ZXIgPSAkZmFsc2U7CiAgICAgICAgaWYgKHRoaXMuZmlsdGVyICE9PSBmaWx0ZXIpIHsKICAgICAgICAgIHRoaXMuZmlsdGVyID0gZmlsdGVyOwogICAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRSdWxlOiBmdW5jdGlvbihydWxlKSB7CiAgICAgICAgcnVsZSA9IGdldHRlcihydWxlIHx8ICR0cnVlKTsKICAgICAgICBpZiAodGhpcy5ydWxlICE9PSBydWxlKSB7CiAgICAgICAgICB2YXIgb2xkUnVsZSA9IHRoaXMucnVsZTsKICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICB0aGlzLmVtaXRfcnVsZUNoYW5nZWQob2xkUnVsZSk7CiAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFwcGx5UnVsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwXzsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgY3VyTWVtYmVyOwogICAgICAgIHZhciBuZXdNZW1iZXI7CiAgICAgICAgdmFyIGN1ck1lbWJlcklkOwogICAgICAgIHZhciBuZXdNZW1iZXJJZDsKICAgICAgICB2YXIgc291cmNlT2JqZWN0OwogICAgICAgIHZhciBzb3VyY2VPYmplY3RJbmZvOwogICAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGZvciAodmFyIHNvdXJjZU9iamVjdElkIGluIHNvdXJjZU1hcCkgewogICAgICAgICAgc291cmNlT2JqZWN0SW5mbyA9IHNvdXJjZU1hcFtzb3VyY2VPYmplY3RJZF07CiAgICAgICAgICBzb3VyY2VPYmplY3QgPSBzb3VyY2VPYmplY3RJbmZvLnNvdXJjZU9iamVjdDsKICAgICAgICAgIGN1ck1lbWJlciA9IHNvdXJjZU9iamVjdEluZm8ubWVtYmVyOwogICAgICAgICAgbmV3TWVtYmVyID0gdGhpcy5tYXAgPyB0aGlzLm1hcChzb3VyY2VPYmplY3QpIDogc291cmNlT2JqZWN0OwogICAgICAgICAgaWYgKG5ld01lbWJlciBpbnN0YW5jZW9mIERhdGFPYmplY3QgPT0gZmFsc2UgfHwgdGhpcy5maWx0ZXIobmV3TWVtYmVyKSkgbmV3TWVtYmVyID0gbnVsbDsKICAgICAgICAgIGlmIChjdXJNZW1iZXIgIT0gbmV3TWVtYmVyKSB7CiAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8ubWVtYmVyID0gbmV3TWVtYmVyOwogICAgICAgICAgICBpZiAoY3VyTWVtYmVyKSB7CiAgICAgICAgICAgICAgY3VyTWVtYmVySWQgPSBjdXJNZW1iZXIuYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgICBpZiAodGhpcy5yZW1vdmVNZW1iZXJSZWYpIHRoaXMucmVtb3ZlTWVtYmVyUmVmKGN1ck1lbWJlciwgc291cmNlT2JqZWN0KTsKICAgICAgICAgICAgICBtZW1iZXJNYXBbY3VyTWVtYmVySWRdLS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld01lbWJlcikgewogICAgICAgICAgICAgIG5ld01lbWJlcklkID0gbmV3TWVtYmVyLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgaWYgKHRoaXMuYWRkTWVtYmVyUmVmKSB0aGlzLmFkZE1lbWJlclJlZihuZXdNZW1iZXIsIHNvdXJjZU9iamVjdCk7CiAgICAgICAgICAgICAgaWYgKG5ld01lbWJlcklkIGluIG1lbWJlck1hcCkgewogICAgICAgICAgICAgICAgbWVtYmVyTWFwW25ld01lbWJlcklkXSsrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZW1iZXJNYXBbbmV3TWVtYmVySWRdID0gMTsKICAgICAgICAgICAgICAgIGluc2VydGVkLnB1c2gobmV3TWVtYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChjdXJNZW1iZXJJZCBpbiB0aGlzLml0ZW1zXykgaWYgKG1lbWJlck1hcFtjdXJNZW1iZXJJZF0gPT0gMCkgewogICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFtjdXJNZW1iZXJJZF07CiAgICAgICAgICBkZWxldGVkLnB1c2godGhpcy5pdGVtc19bY3VyTWVtYmVySWRdKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhKTsKICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIEZpbHRlciA9IENsYXNzKE1hcEZpbHRlciwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRmlsdGVyIiwKICAgICAgZmlsdGVyOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gIXRoaXMucnVsZShvYmplY3QpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBTcGxpdCA9IENsYXNzKE1hcEZpbHRlciwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU3BsaXQiLAogICAgICBzdWJzZXRDbGFzczogUmVhZE9ubHlEYXRhc2V0LAogICAgICBzdWJzZXRXcmFwcGVyQ2xhc3M6IERhdGFzZXRXcmFwcGVyLAogICAgICBrZXlNYXA6IG51bGwsCiAgICAgIG1hcDogZnVuY3Rpb24oc291cmNlT2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLnJlc29sdmUoc291cmNlT2JqZWN0KTsKICAgICAgfSwKICAgICAgcnVsZTogZ2V0dGVyKCR1bmRlZiksCiAgICAgIHNldFJ1bGU6IGZ1bmN0aW9uKHJ1bGUpIHsKICAgICAgICBydWxlID0gZ2V0dGVyKHJ1bGUgfHwgJHVuZGVmKTsKICAgICAgICBpZiAodGhpcy5ydWxlICE9PSBydWxlKSB7CiAgICAgICAgICB2YXIgb2xkUnVsZSA9IHRoaXMucnVsZTsKICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICB0aGlzLmtleU1hcC5rZXlHZXR0ZXIgPSBydWxlOwogICAgICAgICAgdGhpcy5lbWl0X3J1bGVDaGFuZ2VkKG9sZFJ1bGUpOwogICAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBhZGRNZW1iZXJSZWY6IGZ1bmN0aW9uKHdyYXBwZXIsIHNvdXJjZU9iamVjdCkgewogICAgICAgIHdyYXBwZXIuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICBpbnNlcnRlZDogWyBzb3VyY2VPYmplY3QgXQogICAgICAgIH0pOwogICAgICB9LAogICAgICByZW1vdmVNZW1iZXJSZWY6IGZ1bmN0aW9uKHdyYXBwZXIsIHNvdXJjZU9iamVjdCkgewogICAgICAgIHdyYXBwZXIuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICBkZWxldGVkOiBbIHNvdXJjZU9iamVjdCBdCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy5rZXlNYXAgfHwgdGhpcy5rZXlNYXAgaW5zdGFuY2VvZiBLZXlPYmplY3RNYXAgPT0gZmFsc2UpIHRoaXMua2V5TWFwID0gY3JlYXRlS2V5TWFwKHRoaXMua2V5TWFwLCB0aGlzLnJ1bGUsIHRoaXMuc3Vic2V0V3JhcHBlckNsYXNzLCB0aGlzLnN1YnNldENsYXNzKTsKICAgICAgICBNYXBGaWx0ZXIucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgZ2V0U3Vic2V0OiBmdW5jdGlvbihkYXRhLCBhdXRvY3JlYXRlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLmdldChkYXRhLCBhdXRvY3JlYXRlKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgTWFwRmlsdGVyLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5rZXlNYXAuZGVzdHJveSgpOwogICAgICAgIHRoaXMua2V5TWFwID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBiaW5hcnlTZWFyY2hQb3MoYXJyYXksIG1hcCkgewogICAgICBpZiAoIWFycmF5Lmxlbmd0aCkgcmV0dXJuIDA7CiAgICAgIHZhciB2YWx1ZSA9IG1hcC52YWx1ZTsKICAgICAgdmFyIGlkID0gbWFwLm9iamVjdC5iYXNpc09iamVjdElkOwogICAgICB2YXIgY21wVmFsdWU7CiAgICAgIHZhciBjbXBJZDsKICAgICAgdmFyIHBvczsKICAgICAgdmFyIGl0ZW07CiAgICAgIHZhciBsID0gMDsKICAgICAgdmFyIHIgPSBhcnJheS5sZW5ndGggLSAxOwogICAgICBkbyB7CiAgICAgICAgcG9zID0gbCArIHIgPj4gMTsKICAgICAgICBpdGVtID0gYXJyYXlbcG9zXTsKICAgICAgICBjbXBWYWx1ZSA9IGl0ZW0udmFsdWU7CiAgICAgICAgaWYgKHZhbHVlIDwgY21wVmFsdWUpIHIgPSBwb3MgLSAxOyBlbHNlIGlmICh2YWx1ZSA+IGNtcFZhbHVlKSBsID0gcG9zICsgMTsgZWxzZSB7CiAgICAgICAgICBjbXBJZCA9IGl0ZW0ub2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICBpZiAoaWQgPCBjbXBJZCkgciA9IHBvcyAtIDE7IGVsc2UgaWYgKGlkID4gY21wSWQpIGwgPSBwb3MgKyAxOyBlbHNlIHJldHVybiBwb3M7CiAgICAgICAgfQogICAgICB9IHdoaWxlIChsIDw9IHIpOwogICAgICByZXR1cm4gcG9zICsgKGNtcFZhbHVlID09IHZhbHVlID8gY21wSWQgPCBpZCA6IGNtcFZhbHVlIDwgdmFsdWUpOwogICAgfQogICAgdmFyIFNMSUNFX1NPVVJDRU9CSkVDVF9VUERBVEUgPSBmdW5jdGlvbihzb3VyY2VPYmplY3QpIHsKICAgICAgdmFyIHNvdXJjZU9iamVjdEluZm8gPSB0aGlzLnNvdXJjZU1hcF9bc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdOwogICAgICB2YXIgbmV3VmFsdWUgPSB0aGlzLnJ1bGUoc291cmNlT2JqZWN0KTsKICAgICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleF87CiAgICAgIGlmIChuZXdWYWx1ZSAhPT0gc291cmNlT2JqZWN0SW5mby52YWx1ZSkgewogICAgICAgIHZhciBwb3MgPSBiaW5hcnlTZWFyY2hQb3MoaW5kZXgsIHNvdXJjZU9iamVjdEluZm8pOwogICAgICAgIHZhciBwcmV2ID0gaW5kZXhbcG9zIC0gMV07CiAgICAgICAgdmFyIG5leHQgPSBpbmRleFtwb3MgKyAxXTsKICAgICAgICBzb3VyY2VPYmplY3RJbmZvLnZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgaWYgKHByZXYgJiYgKHByZXYudmFsdWUgPiBuZXdWYWx1ZSB8fCBwcmV2LnZhbHVlID09IG5ld1ZhbHVlICYmIHByZXYub2JqZWN0LmJhc2lzT2JqZWN0SWQgPiBzb3VyY2VPYmplY3RJbmZvLm9iamVjdC5iYXNpc09iamVjdElkKSB8fCBuZXh0ICYmIChuZXh0LnZhbHVlIDwgbmV3VmFsdWUgfHwgbmV4dC52YWx1ZSA9PSBuZXdWYWx1ZSAmJiBuZXh0Lm9iamVjdC5iYXNpc09iamVjdElkIDwgc291cmNlT2JqZWN0SW5mby5vYmplY3QuYmFzaXNPYmplY3RJZCkpIHsKICAgICAgICAgIGluZGV4LnNwbGljZShwb3MsIDEpOwogICAgICAgICAgaW5kZXguc3BsaWNlKGJpbmFyeVNlYXJjaFBvcyhpbmRleCwgc291cmNlT2JqZWN0SW5mbyksIDAsIHNvdXJjZU9iamVjdEluZm8pOwogICAgICAgICAgdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBmdW5jdGlvbiBzbGljZUluZGV4U29ydChhLCBiKSB7CiAgICAgIHJldHVybiArKGEudmFsdWUgPiBiLnZhbHVlKSB8fCAtKGEudmFsdWUgPCBiLnZhbHVlKSB8fCBhLm9iamVjdC5iYXNpc09iamVjdElkIC0gYi5vYmplY3QuYmFzaXNPYmplY3RJZDsKICAgIH0KICAgIHZhciBTTElDRV9TT1VSQ0VfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihzb3VyY2UsIGRlbHRhKSB7CiAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwXzsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmluZGV4XzsKICAgICAgICB2YXIgdXBkYXRlSGFuZGxlciA9IHRoaXMucnVsZUV2ZW50czsKICAgICAgICB2YXIgZHJvcEluZGV4ID0gZmFsc2U7CiAgICAgICAgdmFyIGJ1aWxkSW5kZXggPSBmYWxzZTsKICAgICAgICB2YXIgc291cmNlT2JqZWN0SW5mbzsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBkZWx0YS5pbnNlcnRlZDsKICAgICAgICB2YXIgZGVsZXRlZCA9IGRlbHRhLmRlbGV0ZWQ7CiAgICAgICAgaWYgKGRlbGV0ZWQpIHsKICAgICAgICAgIGlmIChkZWxldGVkLmxlbmd0aCA+IGluZGV4Lmxlbmd0aCAtIGRlbGV0ZWQubGVuZ3RoKSB7CiAgICAgICAgICAgIGRyb3BJbmRleCA9IHRydWU7CiAgICAgICAgICAgIGJ1aWxkSW5kZXggPSBkZWxldGVkLmxlbmd0aCAhPSBpbmRleC5sZW5ndGg7CiAgICAgICAgICAgIGluZGV4Lmxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgc291cmNlT2JqZWN0OyBzb3VyY2VPYmplY3QgPSBkZWxldGVkW2ldOyBpKyspIHsKICAgICAgICAgICAgaWYgKCFkcm9wSW5kZXgpIHsKICAgICAgICAgICAgICBzb3VyY2VPYmplY3RJbmZvID0gc291cmNlTWFwW3NvdXJjZU9iamVjdC5iYXNpc09iamVjdElkXTsKICAgICAgICAgICAgICBpbmRleC5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKGluZGV4LCBzb3VyY2VPYmplY3RJbmZvKSwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIHNvdXJjZU1hcFtzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgICAgICAgIGlmICh1cGRhdGVIYW5kbGVyKSBzb3VyY2VPYmplY3QucmVtb3ZlSGFuZGxlcih1cGRhdGVIYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChidWlsZEluZGV4KSBmb3IgKHZhciBrZXkgaW4gc291cmNlTWFwKSB7CiAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8gPSBzb3VyY2VNYXBba2V5XTsKICAgICAgICAgICAgaW5kZXguc3BsaWNlKGJpbmFyeVNlYXJjaFBvcyhpbmRleCwgc291cmNlT2JqZWN0SW5mbyksIDAsIHNvdXJjZU9iamVjdEluZm8pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaW5zZXJ0ZWQpIHsKICAgICAgICAgIGJ1aWxkSW5kZXggPSAhaW5kZXgubGVuZ3RoOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHNvdXJjZU9iamVjdDsgc291cmNlT2JqZWN0ID0gaW5zZXJ0ZWRbaV07IGkrKykgewogICAgICAgICAgICBzb3VyY2VPYmplY3RJbmZvID0gewogICAgICAgICAgICAgIG9iamVjdDogc291cmNlT2JqZWN0LAogICAgICAgICAgICAgIHZhbHVlOiB0aGlzLnJ1bGUoc291cmNlT2JqZWN0KQogICAgICAgICAgICB9OwogICAgICAgICAgICBzb3VyY2VNYXBbc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdID0gc291cmNlT2JqZWN0SW5mbzsKICAgICAgICAgICAgaWYgKCFidWlsZEluZGV4KSBpbmRleC5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKGluZGV4LCBzb3VyY2VPYmplY3RJbmZvKSwgMCwgc291cmNlT2JqZWN0SW5mbyk7IGVsc2UgaW5kZXgucHVzaChzb3VyY2VPYmplY3RJbmZvKTsKICAgICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5hZGRIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJ1aWxkSW5kZXgpIGluZGV4LnNvcnQoc2xpY2VJbmRleFNvcnQpOwogICAgICAgIH0KICAgICAgICB0aGlzLmFwcGx5UnVsZSgpOwogICAgICB9CiAgICB9OwogICAgdmFyIFNsaWNlID0gQ2xhc3MoU291cmNlRGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU2xpY2UiLAogICAgICBydWxlOiBnZXR0ZXIoJHRydWUpLAogICAgICBlbWl0X3J1bGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgicnVsZUNoYW5nZWQiLCAib2xkUnVsZSIsICJvbGRPcmRlckRlc2MiKSwKICAgICAgcnVsZUV2ZW50czogY3JlYXRlUnVsZUV2ZW50cyhTTElDRV9TT1VSQ0VPQkpFQ1RfVVBEQVRFLCAidXBkYXRlIiksCiAgICAgIGluZGV4XzogbnVsbCwKICAgICAgb3JkZXJEZXNjOiBmYWxzZSwKICAgICAgb2Zmc2V0OiAwLAogICAgICBsaW1pdDogMTAsCiAgICAgIGxpc3RlbjogewogICAgICAgIHNvdXJjZTogU0xJQ0VfU09VUkNFX0hBTkRMRVIKICAgICAgfSwKICAgICAgZW1pdF9yYW5nZUNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJyYW5nZUNoYW5nZWQiLCAib2xkT2Zmc2V0IiwgIm9sZExpbWl0IiksCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaW5kZXhfID0gW107CiAgICAgICAgU291cmNlRGF0YXNldC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBzZXRSYW5nZTogZnVuY3Rpb24ob2Zmc2V0LCBsaW1pdCkgewogICAgICAgIHZhciBvbGRPZmZzZXQgPSB0aGlzLm9mZnNldDsKICAgICAgICB2YXIgb2xkTGltaXQgPSB0aGlzLmxpbWl0OwogICAgICAgIHZhciBkZWx0YSA9IGZhbHNlOwogICAgICAgIGlmIChvbGRPZmZzZXQgIT0gb2Zmc2V0IHx8IG9sZExpbWl0ICE9IGxpbWl0KSB7CiAgICAgICAgICB0aGlzLm9mZnNldCA9IG9mZnNldDsKICAgICAgICAgIHRoaXMubGltaXQgPSBsaW1pdDsKICAgICAgICAgIGRlbHRhID0gdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICAgIHRoaXMuZW1pdF9yYW5nZUNoYW5nZWQob2xkT2Zmc2V0LCBvbGRMaW1pdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgfSwKICAgICAgc2V0T2Zmc2V0OiBmdW5jdGlvbihvZmZzZXQpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRSYW5nZShvZmZzZXQsIHRoaXMubGltaXQpOwogICAgICB9LAogICAgICBzZXRMaW1pdDogZnVuY3Rpb24obGltaXQpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRSYW5nZSh0aGlzLm9mZnNldCwgbGltaXQpOwogICAgICB9LAogICAgICBzZXRSdWxlOiBmdW5jdGlvbihydWxlLCBvcmRlckRlc2MpIHsKICAgICAgICBydWxlID0gZ2V0dGVyKHJ1bGUgfHwgJHRydWUpOwogICAgICAgIG9yZGVyRGVzYyA9ICEhb3JkZXJEZXNjOwogICAgICAgIGlmICh0aGlzLnJ1bGUgIT0gcnVsZSB8fCB0aGlzLm9yZGVyRGVzYyAhPSBvcmRlckRlc2MpIHsKICAgICAgICAgIHZhciBvbGRSdWxlID0gdGhpcy5ydWxlOwogICAgICAgICAgdmFyIG9sZE9yZGVyRGVzYyA9IHRoaXMub3JkZXJEZXNjOwogICAgICAgICAgaWYgKHRoaXMucnVsZSAhPSBydWxlKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuaW5kZXhfOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluZGV4Lmxlbmd0aDsgaSsrKSBpbmRleFtpXS52YWx1ZSA9IHJ1bGUoaW5kZXhbaV0ub2JqZWN0KTsKICAgICAgICAgICAgaW5kZXguc29ydChzbGljZUluZGV4U29ydCk7CiAgICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLm9yZGVyRGVzYyA9IG9yZGVyRGVzYzsKICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICB0aGlzLmVtaXRfcnVsZUNoYW5nZWQob2xkUnVsZSwgb2xkT3JkZXJEZXNjKTsKICAgICAgICAgIHJldHVybiB0aGlzLmFwcGx5UnVsZSgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYXBwbHlSdWxlOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLm9mZnNldDsKICAgICAgICB2YXIgZW5kID0gc3RhcnQgKyB0aGlzLmxpbWl0OwogICAgICAgIGlmICh0aGlzLm9yZGVyRGVzYykgewogICAgICAgICAgc3RhcnQgPSB0aGlzLmluZGV4Xy5sZW5ndGggLSBlbmQ7CiAgICAgICAgICBlbmQgPSBzdGFydCArIHRoaXMubGltaXQ7CiAgICAgICAgfQogICAgICAgIHZhciBjdXJTZXQgPSBiYXNpcy5vYmplY3Quc2xpY2UodGhpcy5tZW1iZXJzXyk7CiAgICAgICAgdmFyIG5ld1NldCA9IHRoaXMuaW5kZXhfLnNsaWNlKE1hdGgubWF4KDAsIHN0YXJ0KSwgTWF0aC5tYXgoMCwgZW5kKSk7CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gbmV3U2V0W2ldOyBpKyspIHsKICAgICAgICAgIHZhciBvYmplY3RJZCA9IGl0ZW0ub2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICBpZiAoY3VyU2V0W29iamVjdElkXSkgZGVsZXRlIGN1clNldFtvYmplY3RJZF07IGVsc2UgewogICAgICAgICAgICBpbnNlcnRlZC5wdXNoKGl0ZW0ub2JqZWN0KTsKICAgICAgICAgICAgdGhpcy5tZW1iZXJzX1tvYmplY3RJZF0gPSBpdGVtLm9iamVjdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgb2JqZWN0SWQgaW4gY3VyU2V0KSBkZWxldGUgdGhpcy5tZW1iZXJzX1tvYmplY3RJZF07CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIHZhbHVlcyhjdXJTZXQpKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBTb3VyY2VEYXRhc2V0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5pbmRleF8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBDTE9VRF9TT1VSQ0VPQkpFQ1RfVVBEQVRFID0gZnVuY3Rpb24oc291cmNlT2JqZWN0KSB7CiAgICAgIHZhciBzb3VyY2VNYXAgPSB0aGlzLnNvdXJjZU1hcF87CiAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICB2YXIgc291cmNlT2JqZWN0SWQgPSBzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgdmFyIG9sZExpc3QgPSBzb3VyY2VNYXBbc291cmNlT2JqZWN0SWRdLmxpc3Q7CiAgICAgIHZhciBuZXdMaXN0ID0gc291cmNlTWFwW3NvdXJjZU9iamVjdElkXS5saXN0ID0ge307CiAgICAgIHZhciBsaXN0ID0gdGhpcy5ydWxlKHNvdXJjZU9iamVjdCk7CiAgICAgIHZhciBkZWx0YTsKICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgIHZhciBzdWJzZXQ7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGxpc3QpKSBmb3IgKHZhciBqID0gMDsgaiA8IGxpc3QubGVuZ3RoOyBqKyspIHsKICAgICAgICBzdWJzZXQgPSB0aGlzLmtleU1hcC5nZXQobGlzdFtqXSwgdHJ1ZSk7CiAgICAgICAgaWYgKHN1YnNldCAmJiAhc3Vic2V0Lmhhcyhzb3VyY2VPYmplY3QpKSB7CiAgICAgICAgICBzdWJzZXRJZCA9IHN1YnNldC5iYXNpc09iamVjdElkOwogICAgICAgICAgbmV3TGlzdFtzdWJzZXRJZF0gPSBzdWJzZXQ7CiAgICAgICAgICBpZiAoIW9sZExpc3Rbc3Vic2V0SWRdKSB7CiAgICAgICAgICAgIHN1YnNldC5kYXRhc2V0LmVtaXRfaXRlbXNDaGFuZ2VkKHsKICAgICAgICAgICAgICBpbnNlcnRlZDogWyBzb3VyY2VPYmplY3QgXQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKCFtZW1iZXJNYXBbc3Vic2V0SWRdKSB7CiAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChzdWJzZXQpOwogICAgICAgICAgICAgIG1lbWJlck1hcFtzdWJzZXRJZF0gPSAxOwogICAgICAgICAgICB9IGVsc2UgbWVtYmVyTWFwW3N1YnNldElkXSsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKHZhciBzdWJzZXRJZCBpbiBvbGRMaXN0KSBpZiAoIW5ld0xpc3Rbc3Vic2V0SWRdKSB7CiAgICAgICAgdmFyIHN1YnNldCA9IG9sZExpc3Rbc3Vic2V0SWRdOwogICAgICAgIHN1YnNldC5kYXRhc2V0LmVtaXRfaXRlbXNDaGFuZ2VkKHsKICAgICAgICAgIGRlbGV0ZWQ6IFsgc291cmNlT2JqZWN0IF0KICAgICAgICB9KTsKICAgICAgICBpZiAoIS0tbWVtYmVyTWFwW3N1YnNldElkXSkgewogICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFtzdWJzZXRJZF07CiAgICAgICAgICBkZWxldGVkLnB1c2goc3Vic2V0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhKTsKICAgIH07CiAgICB2YXIgQ0xPVURfU09VUkNFX0hBTkRMRVIgPSB7CiAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24oZGF0YXNldCwgZGVsdGEpIHsKICAgICAgICB2YXIgc291cmNlTWFwID0gdGhpcy5zb3VyY2VNYXBfOwogICAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICAgIHZhciB1cGRhdGVIYW5kbGVyID0gdGhpcy5ydWxlRXZlbnRzOwogICAgICAgIHZhciBhcnJheTsKICAgICAgICB2YXIgc3Vic2V0OwogICAgICAgIHZhciBzdWJzZXRJZDsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICAgIHNldEFjY3VtdWxhdGVTdGF0ZSh0cnVlKTsKICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5pbnNlcnRlZCkgZm9yICh2YXIgaSA9IDAsIHNvdXJjZU9iamVjdDsgc291cmNlT2JqZWN0ID0gYXJyYXlbaV07IGkrKykgewogICAgICAgICAgdmFyIGxpc3QgPSB0aGlzLnJ1bGUoc291cmNlT2JqZWN0KTsKICAgICAgICAgIHZhciBzb3VyY2VPYmplY3RJbmZvID0gewogICAgICAgICAgICBvYmplY3Q6IHNvdXJjZU9iamVjdCwKICAgICAgICAgICAgbGlzdDoge30KICAgICAgICAgIH07CiAgICAgICAgICBzb3VyY2VNYXBbc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdID0gc291cmNlT2JqZWN0SW5mbzsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGxpc3QpKSBmb3IgKHZhciBqID0gMCwgZHVwRmlsdGVyID0ge307IGogPCBsaXN0Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIHN1YnNldCA9IHRoaXMua2V5TWFwLmdldChsaXN0W2pdLCB0cnVlKTsKICAgICAgICAgICAgaWYgKHN1YnNldCAmJiAhZHVwRmlsdGVyW3N1YnNldC5iYXNpc09iamVjdElkXSkgewogICAgICAgICAgICAgIHN1YnNldElkID0gc3Vic2V0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgZHVwRmlsdGVyW3N1YnNldElkXSA9IHRydWU7CiAgICAgICAgICAgICAgc291cmNlT2JqZWN0SW5mby5saXN0W3N1YnNldElkXSA9IHN1YnNldDsKICAgICAgICAgICAgICBzdWJzZXQuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgICAgICBpbnNlcnRlZDogWyBzb3VyY2VPYmplY3QgXQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICghbWVtYmVyTWFwW3N1YnNldElkXSkgewogICAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChzdWJzZXQpOwogICAgICAgICAgICAgICAgbWVtYmVyTWFwW3N1YnNldElkXSA9IDE7CiAgICAgICAgICAgICAgfSBlbHNlIG1lbWJlck1hcFtzdWJzZXRJZF0rKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5hZGRIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5kZWxldGVkKSBmb3IgKHZhciBpID0gMCwgc291cmNlT2JqZWN0OyBzb3VyY2VPYmplY3QgPSBhcnJheVtpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgc291cmNlT2JqZWN0SWQgPSBzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgIHZhciBsaXN0ID0gc291cmNlTWFwW3NvdXJjZU9iamVjdElkXS5saXN0OwogICAgICAgICAgZGVsZXRlIHNvdXJjZU1hcFtzb3VyY2VPYmplY3RJZF07CiAgICAgICAgICBmb3IgKHZhciBzdWJzZXRJZCBpbiBsaXN0KSB7CiAgICAgICAgICAgIHN1YnNldCA9IGxpc3Rbc3Vic2V0SWRdOwogICAgICAgICAgICBzdWJzZXQuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgICAgZGVsZXRlZDogWyBzb3VyY2VPYmplY3QgXQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKCEtLW1lbWJlck1hcFtzdWJzZXRJZF0pIHsKICAgICAgICAgICAgICBkZWxldGUgbWVtYmVyTWFwW3N1YnNldElkXTsKICAgICAgICAgICAgICBkZWxldGVkLnB1c2goc3Vic2V0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5yZW1vdmVIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBzZXRBY2N1bXVsYXRlU3RhdGUoZmFsc2UpOwogICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgQ2xvdWQgPSBDbGFzcyhTb3VyY2VEYXRhc2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5DbG91ZCIsCiAgICAgIHN1YnNldENsYXNzOiBSZWFkT25seURhdGFzZXQsCiAgICAgIHN1YnNldFdyYXBwZXJDbGFzczogRGF0YXNldFdyYXBwZXIsCiAgICAgIHJ1bGU6IGdldHRlcigkdW5kZWYpLAogICAgICBydWxlRXZlbnRzOiBjcmVhdGVSdWxlRXZlbnRzKENMT1VEX1NPVVJDRU9CSkVDVF9VUERBVEUsICJ1cGRhdGUiKSwKICAgICAga2V5TWFwOiBudWxsLAogICAgICBtYXA6ICRzZWxmLAogICAgICBsaXN0ZW46IHsKICAgICAgICBzb3VyY2U6IENMT1VEX1NPVVJDRV9IQU5ETEVSCiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy5rZXlNYXAgfHwgdGhpcy5rZXlNYXAgaW5zdGFuY2VvZiBLZXlPYmplY3RNYXAgPT0gZmFsc2UpIHRoaXMua2V5TWFwID0gY3JlYXRlS2V5TWFwKHRoaXMua2V5TWFwLCB0aGlzLnJ1bGUsIHRoaXMuc3Vic2V0V3JhcHBlckNsYXNzLCB0aGlzLnN1YnNldENsYXNzKTsKICAgICAgICBTb3VyY2VEYXRhc2V0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGdldFN1YnNldDogZnVuY3Rpb24oZGF0YSwgYXV0b2NyZWF0ZSkgewogICAgICAgIHJldHVybiB0aGlzLmtleU1hcC5nZXQoZGF0YSwgYXV0b2NyZWF0ZSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIFNvdXJjZURhdGFzZXQucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmtleU1hcC5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5rZXlNYXAgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBFWFRSQUNUX1NPVVJDRU9CSkVDVF9VUERBVEUgPSBmdW5jdGlvbihzb3VyY2VPYmplY3QpIHsKICAgICAgdmFyIHNvdXJjZU9iamVjdEluZm8gPSB0aGlzLnNvdXJjZU1hcF9bc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdOwogICAgICB2YXIgbmV3VmFsdWUgPSB0aGlzLnJ1bGUoc291cmNlT2JqZWN0KSB8fCBudWxsOwogICAgICB2YXIgb2xkVmFsdWUgPSBzb3VyY2VPYmplY3RJbmZvLnZhbHVlOwogICAgICB2YXIgaW5zZXJ0ZWQ7CiAgICAgIHZhciBkZWxldGVkOwogICAgICB2YXIgZGVsdGE7CiAgICAgIGlmIChuZXdWYWx1ZSA9PT0gb2xkVmFsdWUpIHJldHVybjsKICAgICAgaWYgKG5ld1ZhbHVlIGluc3RhbmNlb2YgRGF0YU9iamVjdCB8fCBuZXdWYWx1ZSBpbnN0YW5jZW9mIFJlYWRPbmx5RGF0YXNldCkgaW5zZXJ0ZWQgPSBhZGRUb0V4dHJhY3QodGhpcywgbmV3VmFsdWUsIHNvdXJjZU9iamVjdCk7CiAgICAgIGlmIChvbGRWYWx1ZSkgZGVsZXRlZCA9IHJlbW92ZUZyb21FeHRyYWN0KHRoaXMsIG9sZFZhbHVlLCBzb3VyY2VPYmplY3QpOwogICAgICBzb3VyY2VPYmplY3RJbmZvLnZhbHVlID0gbmV3VmFsdWU7CiAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICB9OwogICAgdmFyIEVYVFJBQ1RfREFUQVNFVF9JVEVNU0NIQU5HRUQgPSBmdW5jdGlvbihkYXRhc2V0LCBkZWx0YSkgewogICAgICB2YXIgaW5zZXJ0ZWQgPSBkZWx0YS5pbnNlcnRlZDsKICAgICAgdmFyIGRlbGV0ZWQgPSBkZWx0YS5kZWxldGVkOwogICAgICB2YXIgZGVsdGE7CiAgICAgIGlmIChpbnNlcnRlZCkgaW5zZXJ0ZWQgPSBhZGRUb0V4dHJhY3QodGhpcywgaW5zZXJ0ZWQsIGRhdGFzZXQpOwogICAgICBpZiAoZGVsZXRlZCkgZGVsZXRlZCA9IHJlbW92ZUZyb21FeHRyYWN0KHRoaXMsIGRlbGV0ZWQsIGRhdGFzZXQpOwogICAgICBpZiAoZGVsdGEgPSBnZXREZWx0YShpbnNlcnRlZCwgZGVsZXRlZCkpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEpOwogICAgfTsKICAgIHZhciBFWFRSQUNUX0RBVEFTRVRfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBFWFRSQUNUX0RBVEFTRVRfSVRFTVNDSEFOR0VELAogICAgICBkZXN0cm95OiBmdW5jdGlvbihkYXRhc2V0KSB7CiAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwXzsKICAgICAgICBmb3IgKHZhciBjdXJzb3IgPSBzb3VyY2VNYXBbZGF0YXNldC5iYXNpc09iamVjdElkXTsgY3Vyc29yID0gY3Vyc29yLnJlZjsgKSBzb3VyY2VNYXBbY3Vyc29yLm9iamVjdC5iYXNpc09iamVjdElkXS52YWx1ZSA9IG51bGw7CiAgICAgICAgZGVsZXRlIHNvdXJjZU1hcFtkYXRhc2V0LmJhc2lzT2JqZWN0SWRdOwogICAgICB9CiAgICB9OwogICAgZnVuY3Rpb24gaGFzRXh0cmFjdFNvdXJjZVJlZihleHRyYWN0LCBvYmplY3QsIG1hcmtlcikgewogICAgICB2YXIgc291cmNlT2JqZWN0SW5mbyA9IGV4dHJhY3Quc291cmNlTWFwX1tvYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgIGlmIChzb3VyY2VPYmplY3RJbmZvICYmIHNvdXJjZU9iamVjdEluZm8udmlzaXRlZCAhPT0gbWFya2VyKSB7CiAgICAgICAgZm9yICh2YXIgY3Vyc29yID0gc291cmNlT2JqZWN0SW5mbzsgY3Vyc29yID0gY3Vyc29yLnJlZjsgKSBpZiAoY3Vyc29yLm9iamVjdCA9PT0gZXh0cmFjdC5zb3VyY2UpIHJldHVybiB0cnVlOwogICAgICAgIHNvdXJjZU9iamVjdEluZm8udmlzaXRlZCA9IG1hcmtlcjsKICAgICAgICBmb3IgKHZhciBjdXJzb3IgPSBzb3VyY2VPYmplY3RJbmZvOyBjdXJzb3IgPSBjdXJzb3IucmVmOyApIGlmIChoYXNFeHRyYWN0U291cmNlUmVmKGV4dHJhY3QsIGN1cnNvci5vYmplY3QsIG1hcmtlciB8fCB7fSkpIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGRUb0V4dHJhY3QoZXh0cmFjdCwgaXRlbXMsIHJlZikgewogICAgICB2YXIgc291cmNlTWFwID0gZXh0cmFjdC5zb3VyY2VNYXBfOwogICAgICB2YXIgbWVtYmVycyA9IGV4dHJhY3QubWVtYmVyc187CiAgICAgIHZhciBxdWV1ZSA9IGFycmF5RnJvbShpdGVtcyk7CiAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGl0ZW0gPSBxdWV1ZVtpXTsKICAgICAgICB2YXIgc291cmNlT2JqZWN0SWQgPSBpdGVtLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgaWYgKCFzb3VyY2VPYmplY3RJZCkgewogICAgICAgICAgcmVmID0gaXRlbS5yZWY7CiAgICAgICAgICBpdGVtID0gaXRlbS5vYmplY3Q7CiAgICAgICAgICBzb3VyY2VPYmplY3RJZCA9IGl0ZW0uYmFzaXNPYmplY3RJZDsKICAgICAgICB9CiAgICAgICAgdmFyIHNvdXJjZU9iamVjdEluZm8gPSBzb3VyY2VNYXBbc291cmNlT2JqZWN0SWRdOwogICAgICAgIGlmIChzb3VyY2VPYmplY3RJbmZvKSB7CiAgICAgICAgICBzb3VyY2VPYmplY3RJbmZvLnJlZiA9IHsKICAgICAgICAgICAgb2JqZWN0OiByZWYsCiAgICAgICAgICAgIHJlZjogc291cmNlT2JqZWN0SW5mby5yZWYKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8gPSBzb3VyY2VNYXBbc291cmNlT2JqZWN0SWRdID0gewogICAgICAgICAgICBzb3VyY2U6IGl0ZW0sCiAgICAgICAgICAgIHJlZjogewogICAgICAgICAgICAgIG9iamVjdDogcmVmLAogICAgICAgICAgICAgIHJlZjogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICB2aXNpdGVkOiBudWxsLAogICAgICAgICAgICB2YWx1ZTogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgRGF0YU9iamVjdCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBleHRyYWN0LnJ1bGUoaXRlbSkgfHwgbnVsbDsKICAgICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0YU9iamVjdCB8fCB2YWx1ZSBpbnN0YW5jZW9mIFJlYWRPbmx5RGF0YXNldCkgewogICAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8udmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICBxdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIG9iamVjdDogdmFsdWUsCiAgICAgICAgICAgICAgICByZWY6IGl0ZW0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtZW1iZXJzW3NvdXJjZU9iamVjdElkXSA9IHNvdXJjZU9iamVjdEluZm87CiAgICAgICAgICAgIGluc2VydGVkLnB1c2goaXRlbSk7CiAgICAgICAgICAgIGlmIChleHRyYWN0LnJ1bGVFdmVudHMpIGl0ZW0uYWRkSGFuZGxlcihleHRyYWN0LnJ1bGVFdmVudHMsIGV4dHJhY3QpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaXRlbS5hZGRIYW5kbGVyKEVYVFJBQ1RfREFUQVNFVF9IQU5ETEVSLCBleHRyYWN0KTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGRhdGFzZXRJdGVtcyA9IGl0ZW0uZ2V0SXRlbXMoKTsgaiA8IGRhdGFzZXRJdGVtcy5sZW5ndGg7IGorKykgcXVldWUucHVzaCh7CiAgICAgICAgICAgICAgb2JqZWN0OiBkYXRhc2V0SXRlbXNbal0sCiAgICAgICAgICAgICAgcmVmOiBpdGVtCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gaW5zZXJ0ZWQ7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVGcm9tRXh0cmFjdChleHRyYWN0LCBpdGVtcywgcmVmKSB7CiAgICAgIHZhciBzb3VyY2VNYXAgPSBleHRyYWN0LnNvdXJjZU1hcF87CiAgICAgIHZhciBtZW1iZXJzID0gZXh0cmFjdC5tZW1iZXJzXzsKICAgICAgdmFyIHF1ZXVlID0gYXJyYXlGcm9tKGl0ZW1zKTsKICAgICAgdmFyIGRlbGV0ZWQgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBpdGVtID0gcXVldWVbaV07CiAgICAgICAgdmFyIHNvdXJjZU9iamVjdElkID0gaXRlbS5iYXNpc09iamVjdElkOwogICAgICAgIGlmICghc291cmNlT2JqZWN0SWQpIHsKICAgICAgICAgIHJlZiA9IGl0ZW0ucmVmOwogICAgICAgICAgaXRlbSA9IGl0ZW0ub2JqZWN0OwogICAgICAgICAgc291cmNlT2JqZWN0SWQgPSBpdGVtLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgfQogICAgICAgIHZhciBzb3VyY2VPYmplY3RJbmZvID0gc291cmNlTWFwW3NvdXJjZU9iamVjdElkXTsKICAgICAgICB2YXIgc291cmNlT2JqZWN0VmFsdWUgPSBzb3VyY2VPYmplY3RJbmZvLnZhbHVlOwogICAgICAgIGZvciAodmFyIGN1cnNvciA9IHNvdXJjZU9iamVjdEluZm8sIHByZXZDdXJzb3IgPSBzb3VyY2VPYmplY3RJbmZvOyBjdXJzb3IgPSBjdXJzb3IucmVmOyApIHsKICAgICAgICAgIGlmIChjdXJzb3Iub2JqZWN0ID09PSByZWYpIHsKICAgICAgICAgICAgcHJldkN1cnNvci5yZWYgPSBjdXJzb3IucmVmOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHByZXZDdXJzb3IgPSBjdXJzb3I7CiAgICAgICAgfQogICAgICAgIGlmICghc291cmNlT2JqZWN0SW5mby5yZWYpIHsKICAgICAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgRGF0YU9iamVjdCkgewogICAgICAgICAgICBkZWxldGUgbWVtYmVyc1tzb3VyY2VPYmplY3RJZF07CiAgICAgICAgICAgIGRlbGV0ZWQucHVzaChpdGVtKTsKICAgICAgICAgICAgaWYgKGV4dHJhY3QucnVsZUV2ZW50cykgaXRlbS5yZW1vdmVIYW5kbGVyKGV4dHJhY3QucnVsZUV2ZW50cywgZXh0cmFjdCk7CiAgICAgICAgICAgIGlmIChzb3VyY2VPYmplY3RWYWx1ZSkgcXVldWUucHVzaCh7CiAgICAgICAgICAgICAgb2JqZWN0OiBzb3VyY2VPYmplY3RWYWx1ZSwKICAgICAgICAgICAgICByZWY6IGl0ZW0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpdGVtLnJlbW92ZUhhbmRsZXIoRVhUUkFDVF9EQVRBU0VUX0hBTkRMRVIsIGV4dHJhY3QpOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgZGF0YXNldEl0ZW1zID0gaXRlbS5nZXRJdGVtcygpOyBqIDwgZGF0YXNldEl0ZW1zLmxlbmd0aDsgaisrKSBxdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBvYmplY3Q6IGRhdGFzZXRJdGVtc1tqXSwKICAgICAgICAgICAgICByZWY6IGl0ZW0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgc291cmNlTWFwW3NvdXJjZU9iamVjdElkXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHNvdXJjZU9iamVjdFZhbHVlICYmICFoYXNFeHRyYWN0U291cmNlUmVmKGV4dHJhY3QsIGl0ZW0pKSB7CiAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8udmFsdWUgPSBudWxsOwogICAgICAgICAgICBxdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBvYmplY3Q6IHNvdXJjZU9iamVjdFZhbHVlLAogICAgICAgICAgICAgIHJlZjogaXRlbQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGRlbGV0ZWQ7CiAgICB9CiAgICB2YXIgRXh0cmFjdCA9IFNvdXJjZURhdGFzZXQuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRXh0cmFjdCIsCiAgICAgIHJ1bGU6IGdldHRlcigkdW5kZWYpLAogICAgICBlbWl0X3J1bGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgicnVsZUNoYW5nZWQiLCAib2xkUnVsZSIpLAogICAgICBydWxlRXZlbnRzOiBjcmVhdGVSdWxlRXZlbnRzKEVYVFJBQ1RfU09VUkNFT0JKRUNUX1VQREFURSwgInVwZGF0ZSIpLAogICAgICBsaXN0ZW46IHsKICAgICAgICBzb3VyY2U6IHsKICAgICAgICAgIGl0ZW1zQ2hhbmdlZDogRVhUUkFDVF9EQVRBU0VUX0lURU1TQ0hBTkdFRAogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0UnVsZTogZnVuY3Rpb24ocnVsZSkgewogICAgICAgIHJ1bGUgPSBnZXR0ZXIocnVsZSB8fCAkdW5kZWYpOwogICAgICAgIGlmICh0aGlzLnJ1bGUgIT09IHJ1bGUpIHsKICAgICAgICAgIHZhciBvbGRSdWxlID0gdGhpcy5ydWxlOwogICAgICAgICAgdGhpcy5ydWxlID0gcnVsZTsKICAgICAgICAgIHRoaXMuZW1pdF9ydWxlQ2hhbmdlZChvbGRSdWxlKTsKICAgICAgICAgIHJldHVybiB0aGlzLmFwcGx5UnVsZSgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYXBwbHlSdWxlOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgaW5zZXJ0ZWRNYXAgPSB7fTsKICAgICAgICB2YXIgZGVsZXRlZE1hcCA9IHt9OwogICAgICAgIHZhciBhcnJheTsKICAgICAgICB2YXIgZGVsdGE7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuc291cmNlTWFwXykgewogICAgICAgICAgdmFyIHNvdXJjZU9iamVjdEluZm8gPSB0aGlzLnNvdXJjZU1hcF9ba2V5XTsKICAgICAgICAgIHZhciBzb3VyY2VPYmplY3QgPSBzb3VyY2VPYmplY3RJbmZvLnNvdXJjZTsKICAgICAgICAgIGlmIChzb3VyY2VPYmplY3QgaW5zdGFuY2VvZiBEYXRhT2JqZWN0KSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHRoaXMucnVsZShzb3VyY2VPYmplY3QpIHx8IG51bGw7CiAgICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IHNvdXJjZU9iamVjdEluZm8udmFsdWU7CiAgICAgICAgICAgIGlmIChuZXdWYWx1ZSA9PT0gb2xkVmFsdWUpIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAobmV3VmFsdWUgaW5zdGFuY2VvZiBEYXRhT2JqZWN0IHx8IG5ld1ZhbHVlIGluc3RhbmNlb2YgUmVhZE9ubHlEYXRhc2V0KSB7CiAgICAgICAgICAgICAgdmFyIGluc2VydGVkID0gYWRkVG9FeHRyYWN0KHRoaXMsIG5ld1ZhbHVlLCBzb3VyY2VPYmplY3QpOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5zZXJ0ZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBpdGVtID0gaW5zZXJ0ZWRbaV07CiAgICAgICAgICAgICAgICB2YXIgaWQgPSBpdGVtLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgICBpZiAoZGVsZXRlZE1hcFtpZF0pIGRlbGV0ZSBkZWxldGVkTWFwW2lkXTsgZWxzZSBpbnNlcnRlZE1hcFtpZF0gPSBpdGVtOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkVmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgZGVsZXRlZCA9IHJlbW92ZUZyb21FeHRyYWN0KHRoaXMsIG9sZFZhbHVlLCBzb3VyY2VPYmplY3QpOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVsZXRlZC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSBkZWxldGVkW2ldOwogICAgICAgICAgICAgICAgdmFyIGlkID0gaXRlbS5iYXNpc09iamVjdElkOwogICAgICAgICAgICAgICAgaWYgKGluc2VydGVkTWFwW2lkXSkgZGVsZXRlIGluc2VydGVkTWFwW2lkXTsgZWxzZSBkZWxldGVkTWFwW2lkXSA9IGl0ZW07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8udmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEodmFsdWVzKGluc2VydGVkTWFwKSwgdmFsdWVzKGRlbGV0ZWRNYXApKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBnZXREZWx0YTogZ2V0RGVsdGEsCiAgICAgIGNyZWF0ZVJ1bGVFdmVudHM6IGNyZWF0ZVJ1bGVFdmVudHMsCiAgICAgIE1lcmdlOiBNZXJnZSwKICAgICAgU3VidHJhY3Q6IFN1YnRyYWN0LAogICAgICBTb3VyY2VEYXRhc2V0OiBTb3VyY2VEYXRhc2V0LAogICAgICBNYXBGaWx0ZXI6IE1hcEZpbHRlciwKICAgICAgRmlsdGVyOiBGaWx0ZXIsCiAgICAgIFNwbGl0OiBTcGxpdCwKICAgICAgRXh0cmFjdDogRXh0cmFjdCwKICAgICAgU2xpY2U6IFNsaWNlLAogICAgICBDbG91ZDogQ2xvdWQKICAgIH07CiAgfSwKICAiMC5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8xLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2EuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZC5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi9lLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2YuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZy5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi9oLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2kuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vay5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi9uLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL28uanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vcC5qcyIpOwogICAgZ2xvYmFsWyJiYXNpcyJdID0gYmFzaXM7CiAgfSwKICAiMi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgRW1pdHRlciA9IGJhc2lzLmV2ZW50LkVtaXR0ZXI7CiAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgYmFzaXMucmVzb3VyY2UuZXh0ZW5zaW9uc1siLmwxMG4iXSA9IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCkgewogICAgICByZXR1cm4gcmVzb2x2ZURpY3Rpb25hcnkodXJsKS51cGRhdGUoYmFzaXMucmVzb3VyY2UuZXh0ZW5zaW9uc1siLmpzb24iXShjb250ZW50LCB1cmwpKTsKICAgIH07CiAgICBmdW5jdGlvbiBvd25LZXlzKG9iamVjdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHZhciB0b2tlbkluZGV4ID0gW107CiAgICB2YXIgdG9rZW5Db21wdXRlRm4gPSB7fTsKICAgIHZhciB0b2tlbkNvbXB1dGVzID0ge307CiAgICB2YXIgdXBkYXRlVG9rZW4gPSBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuc2V0OwogICAgdmFyIENvbXB1dGVUb2tlbiA9IENsYXNzKGJhc2lzLlRva2VuLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Db21wdXRlVG9rZW4iLAogICAgICBpbml0OiBmdW5jdGlvbih2YWx1ZSwgdG9rZW4pIHsKICAgICAgICB0b2tlbi5jb21wdXRlVG9rZW5zW3RoaXMuYmFzaXNPYmplY3RJZF0gPSB0aGlzOwogICAgICAgIHRoaXMudG9rZW4gPSB0b2tlbjsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIga2V5ID0gdGhpcy50b2tlbi50eXBlID09ICJwbHVyYWwiID8gY3VsdHVyZXNbY3VycmVudEN1bHR1cmVdLnBsdXJhbCh0aGlzLnZhbHVlKSA6IHRoaXMudmFsdWU7CiAgICAgICAgcmV0dXJuIHRoaXMudG9rZW4uZGljdGlvbmFyeS5nZXRWYWx1ZSh0aGlzLnRva2VuLm5hbWUgKyAiLiIgKyBrZXkpOwogICAgICB9LAogICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KCk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGRlbGV0ZSB0aGlzLnRva2VuLmNvbXB1dGVUb2tlbnNbdGhpcy5iYXNpc09iamVjdElkXTsKICAgICAgICB0aGlzLnRva2VuID0gbnVsbDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUb2tlbiA9IENsYXNzKGJhc2lzLlRva2VuLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Ub2tlbiIsCiAgICAgIGluZGV4OiBOYU4sCiAgICAgIGRpY3Rpb25hcnk6IG51bGwsCiAgICAgIG5hbWU6ICIiLAogICAgICB0eXBlOiAiZGVmYXVsdCIsCiAgICAgIGNvbXB1dGVUb2tlbnM6IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKGRpY3Rpb25hcnksIHRva2VuTmFtZSwgdHlwZSwgdmFsdWUpIHsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICB0aGlzLmluZGV4ID0gdG9rZW5JbmRleC5wdXNoKHRoaXMpIC0gMTsKICAgICAgICB0aGlzLm5hbWUgPSB0b2tlbk5hbWU7CiAgICAgICAgdGhpcy5kaWN0aW9uYXJ5ID0gZGljdGlvbmFyeTsKICAgICAgICB0aGlzLmNvbXB1dGVUb2tlbnMgPSB7fTsKICAgICAgICBpZiAodHlwZSkgdGhpcy5zZXRUeXBlKHR5cGUpOyBlbHNlIHRoaXMuYXBwbHkoKTsKICAgICAgfSwKICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCgpOwogICAgICB9LAogICAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuY29tcHV0ZVRva2VucykgdGhpcy5jb21wdXRlVG9rZW5zW2tleV0uYXBwbHkoKTsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuYXBwbHkuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMubDEwbjogVmFsdWUgZm9yIGwxMG4gdG9rZW4gY2FuJ3QgYmUgc2V0IGRpcmVjdGx5LCBidXQgdGhyb3VnaCBkaWN0aW9uYXJ5IHVwZGF0ZSBvbmx5Iik7CiAgICAgIH0sCiAgICAgIHNldFR5cGU6IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICBpZiAodHlwZSAhPSAicGx1cmFsIiAmJiAoIWJhc2lzLmwxMG4uZW5hYmxlTWFya3VwIHx8IHR5cGUgIT0gIm1hcmt1cCIpKSB0eXBlID0gImRlZmF1bHQiOwogICAgICAgIGlmICh0aGlzLnR5cGUgIT0gdHlwZSkgewogICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewogICAgICAgICAgZ2V0dGVyID0gZXZlbnRzOwogICAgICAgICAgZXZlbnRzID0gIiI7CiAgICAgICAgfQogICAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIpOwogICAgICAgIGV2ZW50cyA9IFN0cmluZyhldmVudHMpLnRyaW0oKS5zcGxpdCgvXHMrfFxzKixccyovKS5zb3J0KCk7CiAgICAgICAgdmFyIHRva2VuSWQgPSB0aGlzLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgdmFyIGVudW1JZCA9IGV2ZW50cy5jb25jYXQodG9rZW5JZCwgZ2V0dGVyW2Jhc2lzLmdldHRlci5JRF0pLmpvaW4oIl8iKTsKICAgICAgICBpZiAodG9rZW5Db21wdXRlRm5bZW51bUlkXSkgcmV0dXJuIHRva2VuQ29tcHV0ZUZuW2VudW1JZF07CiAgICAgICAgdmFyIHRva2VuID0gdGhpczsKICAgICAgICB2YXIgb2JqZWN0VG9rZW5NYXAgPSB7fTsKICAgICAgICB2YXIgdXBkYXRlVmFsdWUgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgIHVwZGF0ZVRva2VuLmNhbGwodGhpcywgZ2V0dGVyKG9iamVjdCkpOwogICAgICAgIH07CiAgICAgICAgdmFyIGhhbmRsZXIgPSB7CiAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgZGVsZXRlIG9iamVjdFRva2VuTWFwW29iamVjdC5iYXNpc09iamVjdElkXTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZXZlbnROYW1lOyBldmVudE5hbWUgPSBldmVudHNbaV07IGkrKykgaWYgKGV2ZW50TmFtZSAhPSAiZGVzdHJveSIpIGhhbmRsZXJbZXZlbnROYW1lXSA9IHVwZGF0ZVZhbHVlOwogICAgICAgIHJldHVybiB0b2tlbkNvbXB1dGVGbltlbnVtSWRdID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgRW1pdHRlciA9PSBmYWxzZSkgdGhyb3cgImJhc2lzLmwxMG4uVG9rZW4jY29tcHV0ZTogb2JqZWN0IG11c3QgYmUgYW4gaW5zdGFuY2VvZiBFbWl0dGVyIjsKICAgICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgdmFyIGNvbXB1dGVUb2tlbiA9IG9iamVjdFRva2VuTWFwW29iamVjdElkXTsKICAgICAgICAgIGlmICghY29tcHV0ZVRva2VuKSB7CiAgICAgICAgICAgIGNvbXB1dGVUb2tlbiA9IG9iamVjdFRva2VuTWFwW29iamVjdElkXSA9IG5ldyBDb21wdXRlVG9rZW4oZ2V0dGVyKG9iamVjdCksIHRva2VuKTsKICAgICAgICAgICAgb2JqZWN0LmFkZEhhbmRsZXIoaGFuZGxlciwgY29tcHV0ZVRva2VuKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb21wdXRlVG9rZW47CiAgICAgICAgfTsKICAgICAgfSwKICAgICAgY29tcHV0ZVRva2VuOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBuZXcgQ29tcHV0ZVRva2VuKHZhbHVlLCB0aGlzKTsKICAgICAgfSwKICAgICAgdG9rZW46IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICBpZiAodGhpcy50eXBlID09ICJwbHVyYWwiKSBuYW1lID0gY3VsdHVyZXNbY3VycmVudEN1bHR1cmVdLnBsdXJhbChuYW1lKTsKICAgICAgICBpZiAodGhpcy5kaWN0aW9uYXJ5KSByZXR1cm4gdGhpcy5kaWN0aW9uYXJ5LnRva2VuKHRoaXMubmFtZSArICIuIiArIG5hbWUpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5jb21wdXRlVG9rZW5zKSB0aGlzLmNvbXB1dGVUb2tlbnNba2V5XS5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5jb21wdXRlVG9rZW5zID0gbnVsbDsKICAgICAgICB0aGlzLnZhbHVlID0gbnVsbDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHJlc29sdmVUb2tlbihwYXRoKSB7CiAgICAgIGlmIChwYXRoLmNoYXJBdCgwKSA9PSAiIyIpIHsKICAgICAgICByZXR1cm4gdG9rZW5JbmRleFtwYXJzZUludChwYXRoLnN1YnN0cigxKSwgMzYpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLm1hdGNoKC9eKC4rPylAKC4rKSQvKTsKICAgICAgICBpZiAocGFydHMpIHJldHVybiByZXNvbHZlRGljdGlvbmFyeShiYXNpcy5wYXRoLnJlc29sdmUocGFydHNbMl0pKS50b2tlbihwYXJ0c1sxXSk7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmwxMG4udG9rZW4gYWNjZXB0cyB0b2tlbiByZWZlcmVuY2VzIGluIGZvcm1hdCBgdG9rZW4ucGF0aEBwYXRoL3RvL2RpY3QubDEwbmAgb25seSIpOwogICAgICB9CiAgICB9CiAgICB2YXIgZGljdGlvbmFyaWVzID0gW107CiAgICB2YXIgZGljdGlvbmFyeUJ5VXJsID0ge307CiAgICB2YXIgY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyID0gbmV3IGJhc2lzLlRva2VuOwogICAgZnVuY3Rpb24gd2Fsa1Rva2VucyhkaWN0aW9uYXJ5LCBjdWx0dXJlLCB0b2tlbnMsIHBhdGgpIHsKICAgICAgdmFyIGN1bHR1cmVWYWx1ZXMgPSBkaWN0aW9uYXJ5LmN1bHR1cmVWYWx1ZXNbY3VsdHVyZV07CiAgICAgIHBhdGggPSBwYXRoID8gcGF0aCArICIuIiA6ICIiOwogICAgICBmb3IgKHZhciBuYW1lIGluIHRva2VucykgaWYgKGhhc093blByb3BlcnR5LmNhbGwodG9rZW5zLCBuYW1lKSkgewogICAgICAgIHZhciB0b2tlbk5hbWUgPSBwYXRoICsgbmFtZTsKICAgICAgICB2YXIgdG9rZW5WYWx1ZSA9IHRva2Vuc1tuYW1lXTsKICAgICAgICBjdWx0dXJlVmFsdWVzW3Rva2VuTmFtZV0gPSB0b2tlblZhbHVlOwogICAgICAgIGlmICh0b2tlblZhbHVlICYmICh0eXBlb2YgdG9rZW5WYWx1ZSA9PSAib2JqZWN0IiB8fCBBcnJheS5pc0FycmF5KHRva2VuVmFsdWUpKSkgd2Fsa1Rva2VucyhkaWN0aW9uYXJ5LCBjdWx0dXJlLCB0b2tlblZhbHVlLCB0b2tlbk5hbWUpOwogICAgICB9CiAgICB9CiAgICB2YXIgRGljdGlvbmFyeSA9IENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkRpY3Rpb25hcnkiLAogICAgICB0b2tlbnM6IG51bGwsCiAgICAgIHR5cGVzOiBudWxsLAogICAgICBjdWx0dXJlVmFsdWVzOiBudWxsLAogICAgICBpbmRleDogTmFOLAogICAgICByZXNvdXJjZTogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24oY29udGVudCkgewogICAgICAgIHRoaXMudG9rZW5zID0ge307CiAgICAgICAgdGhpcy50eXBlcyA9IHt9OwogICAgICAgIHRoaXMuY3VsdHVyZVZhbHVlcyA9IHt9OwogICAgICAgIHRoaXMuaW5kZXggPSBkaWN0aW9uYXJpZXMucHVzaCh0aGlzKSAtIDE7CiAgICAgICAgaWYgKGJhc2lzLnJlc291cmNlLmlzUmVzb3VyY2UoY29udGVudCkpIHsKICAgICAgICAgIHZhciByZXNvdXJjZSA9IGNvbnRlbnQ7CiAgICAgICAgICB0aGlzLnJlc291cmNlID0gcmVzb3VyY2U7CiAgICAgICAgICBpZiAoIWRpY3Rpb25hcnlCeVVybFtyZXNvdXJjZS51cmxdKSB7CiAgICAgICAgICAgIGRpY3Rpb25hcnlCeVVybFtyZXNvdXJjZS51cmxdID0gdGhpczsKICAgICAgICAgICAgY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyLnNldChyZXNvdXJjZS51cmwpOwogICAgICAgICAgfQogICAgICAgICAgcmVzb3VyY2UuZmV0Y2goKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlVzZSBvYmplY3QgYXMgY29udGVudCBvZiBkaWN0aW9uYXJ5IGlzIGV4cGVyaW1lbnRhbCBhbmQgbm90IHByb2R1Y3Rpb24tcmVhZHkiKTsKICAgICAgICAgIHRoaXMudXBkYXRlKGNvbnRlbnQgfHwge30pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgdXBkYXRlOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgaWYgKCFkYXRhKSBkYXRhID0ge307CiAgICAgICAgdGhpcy5jdWx0dXJlVmFsdWVzID0ge307CiAgICAgICAgZm9yICh2YXIgY3VsdHVyZSBpbiBkYXRhKSBpZiAoIS9eX3xfJC8udGVzdChjdWx0dXJlKSkgewogICAgICAgICAgdGhpcy5jdWx0dXJlVmFsdWVzW2N1bHR1cmVdID0ge307CiAgICAgICAgICB3YWxrVG9rZW5zKHRoaXMsIGN1bHR1cmUsIGRhdGFbY3VsdHVyZV0pOwogICAgICAgIH0KICAgICAgICB0aGlzLnR5cGVzID0gZGF0YS5fbWV0YSAmJiBkYXRhLl9tZXRhLnR5cGUgfHwge307CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMudG9rZW5zKSB0aGlzLnRva2Vuc1trZXldLnNldFR5cGUodGhpcy50eXBlc1trZXldKTsKICAgICAgICB0aGlzLnN5bmNWYWx1ZXMoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgc3luY1ZhbHVlczogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgdG9rZW5OYW1lIGluIHRoaXMudG9rZW5zKSB1cGRhdGVUb2tlbi5jYWxsKHRoaXMudG9rZW5zW3Rva2VuTmFtZV0sIHRoaXMuZ2V0VmFsdWUodG9rZW5OYW1lKSk7CiAgICAgIH0sCiAgICAgIGdldFZhbHVlOiBmdW5jdGlvbih0b2tlbk5hbWUpIHsKICAgICAgICB2YXIgZmFsbGJhY2sgPSBjdWx0dXJlRmFsbGJhY2tbY3VycmVudEN1bHR1cmVdIHx8IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjdWx0dXJlTmFtZTsgY3VsdHVyZU5hbWUgPSBmYWxsYmFja1tpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgY3VsdHVyZVZhbHVlcyA9IHRoaXMuY3VsdHVyZVZhbHVlc1tjdWx0dXJlTmFtZV07CiAgICAgICAgICBpZiAoY3VsdHVyZVZhbHVlcyAmJiB0b2tlbk5hbWUgaW4gY3VsdHVyZVZhbHVlcykgcmV0dXJuIGN1bHR1cmVWYWx1ZXNbdG9rZW5OYW1lXTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldEN1bHR1cmVWYWx1ZTogZnVuY3Rpb24oY3VsdHVyZSwgdG9rZW5OYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VsdHVyZVZhbHVlc1tjdWx0dXJlXSAmJiB0aGlzLmN1bHR1cmVWYWx1ZXNbY3VsdHVyZV1bdG9rZW5OYW1lXTsKICAgICAgfSwKICAgICAgdG9rZW46IGZ1bmN0aW9uKHRva2VuTmFtZSkgewogICAgICAgIHZhciB0b2tlbiA9IHRoaXMudG9rZW5zW3Rva2VuTmFtZV07CiAgICAgICAgaWYgKCF0b2tlbikgewogICAgICAgICAgdG9rZW4gPSB0aGlzLnRva2Vuc1t0b2tlbk5hbWVdID0gbmV3IFRva2VuKHRoaXMsIHRva2VuTmFtZSwgdGhpcy50eXBlc1t0b2tlbk5hbWVdLCB0aGlzLmdldFZhbHVlKHRva2VuTmFtZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudG9rZW5zID0gbnVsbDsKICAgICAgICB0aGlzLmN1bHR1cmVWYWx1ZXMgPSBudWxsOwogICAgICAgIGJhc2lzLmFycmF5LnJlbW92ZShkaWN0aW9uYXJpZXMsIHRoaXMpOwogICAgICAgIGlmICh0aGlzLnJlc291cmNlKSB7CiAgICAgICAgICBkZWxldGUgZGljdGlvbmFyeUJ5VXJsW3RoaXMucmVzb3VyY2UudXJsXTsKICAgICAgICAgIHRoaXMucmVzb3VyY2UgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlRGljdGlvbmFyeShzb3VyY2UpIHsKICAgICAgdmFyIGRpY3Rpb25hcnk7CiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJzdHJpbmciKSB7CiAgICAgICAgdmFyIGxvY2F0aW9uID0gc291cmNlOwogICAgICAgIHZhciBleHRuYW1lID0gYmFzaXMucGF0aC5leHRuYW1lKGxvY2F0aW9uKTsKICAgICAgICBpZiAoZXh0bmFtZSAhPSAiLmwxMG4iKSBsb2NhdGlvbiA9IGJhc2lzLnBhdGguZGlybmFtZShsb2NhdGlvbikgKyAiLyIgKyBiYXNpcy5wYXRoLmJhc2VuYW1lKGxvY2F0aW9uLCBleHRuYW1lKSArICIubDEwbiI7CiAgICAgICAgc291cmNlID0gYmFzaXMucmVzb3VyY2UobG9jYXRpb24pOwogICAgICB9CiAgICAgIGlmIChiYXNpcy5yZXNvdXJjZS5pc1Jlc291cmNlKHNvdXJjZSkpIGRpY3Rpb25hcnkgPSBkaWN0aW9uYXJ5QnlVcmxbc291cmNlLnVybF07CiAgICAgIHJldHVybiBkaWN0aW9uYXJ5IHx8IG5ldyBEaWN0aW9uYXJ5KHNvdXJjZSk7CiAgICB9CiAgICBmdW5jdGlvbiBnZXREaWN0aW9uYXJpZXMoKSB7CiAgICAgIHJldHVybiBkaWN0aW9uYXJpZXMuc2xpY2UoMCk7CiAgICB9CiAgICB2YXIgY3VsdHVyZUxpc3QgPSBbXTsKICAgIHZhciBjdXJyZW50Q3VsdHVyZSA9IG51bGw7CiAgICB2YXIgY3VsdHVyZXMgPSB7fTsKICAgIHZhciBjdWx0dXJlRmFsbGJhY2sgPSB7fTsKICAgIHZhciBwbHVyYWxGb3Jtc01hcCA9IHt9OwogICAgdmFyIHBsdXJhbEZvcm1zID0gWyBbIDEsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIDA7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxIHx8IG4gJSAxMCA9PSAxID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwIHx8IG4gPT0gMSA/IDAgOiAxOwogICAgfSBdLCBbIDIsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMCAhPSAxIHx8IG4gJSAxMDAgPT0gMTEgPyAxIDogMDsKICAgIH0gXSwgWyAzLCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiAlIDEwID49IDIgJiYgbiAlIDEwIDw9IDQgJiYgKG4gJSAxMDAgPCAxMCB8fCBuICUgMTAwID49IDIwKSA/IDEgOiAyOwogICAgfSBdLCBbIDMsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMCA9PSAxICYmIG4gJSAxMDAgIT0gMTEgPyAwIDogbiAhPSAwID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSA/IDAgOiBuICUgMTAgPj0gMiAmJiAobiAlIDEwMCA8IDEwIHx8IG4gJSAxMDAgPj0gMjApID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSA/IDAgOiBuICUgMTAgPj0gMiAmJiBuICUgMTAgPD0gNCAmJiAobiAlIDEwMCA8IDEwIHx8IG4gJSAxMDAgPj0gMjApID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwID8gMCA6IG4gPT0gMSA/IDEgOiAyOwogICAgfSBdLCBbIDMsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDAgfHwgbiAlIDEwMCA+IDAgJiYgbiAlIDEwMCA8IDIwID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxID8gMCA6IG4gJSAxMCA+PSAyICYmIG4gJSAxMCA8PSA0ICYmIChuICUgMTAwIDwgMTAgfHwgbiAlIDEwMCA+PSAyMCkgPyAxIDogMjsKICAgIH0gXSwgWyAzLCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA+PSAyICYmIG4gPD0gNCA/IDEgOiAyOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDIgPyAxIDogbiAhPSA4ICYmIG4gIT0gMTEgPyAyIDogMzsKICAgIH0gXSwgWyA0LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA9PSAyID8gMSA6IG4gPT0gMyA/IDIgOiAzOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMDAgPT0gMSA/IDEgOiBuICUgMTAwID09IDIgPyAyIDogbiAlIDEwMCA9PSAzIHx8IG4gJSAxMDAgPT0gNCA/IDMgOiAwOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDAgfHwgbiAlIDEwMCA+IDEgJiYgbiAlIDEwMCA8IDExID8gMSA6IG4gJSAxMDAgPiAxMCAmJiBuICUgMTAwIDwgMjAgPyAyIDogMzsKICAgIH0gXSwgWyA0LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgfHwgbiA9PSAxMSA/IDAgOiBuID09IDIgfHwgbiA9PSAxMiA/IDEgOiBuID4gMiAmJiBuIDwgMjAgPyAyIDogMzsKICAgIH0gXSwgWyA1LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA9PSAyID8gMSA6IG4gPCA3ID8gMiA6IG4gPCAxMSA/IDMgOiA0OwogICAgfSBdLCBbIDYsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMCA/IDAgOiBuID09IDEgPyAxIDogbiA9PSAyID8gMiA6IG4gJSAxMDAgPj0gMyAmJiBuICUgMTAwIDw9IDEwID8gMyA6IG4gJSAxMDAgPj0gMTEgPyA0IDogNTsKICAgIH0gXSBdOwogICAgWyAiYXkgYm8gY2dnIGR6IGZhIGlkIGphIGpibyBrYSBrayBrbSBrbyBreSBsbyBtcyBteSBzYWggc3UgdGggdHQgdWcgdmkgd28gemgiLCAibWsiLCAianYiLCAiYWYgYW4gYXN0IGF6IGJnIGJuIGJyeCBjYSBkYSBkZSBkb2kgZWwgZW4gZW8gZXMgZXMtQVIgZXQgZXUgZmYgZmkgZm8gZnVyIGZ5IGdsIGd1IGhhIGhlIGhpIGhuZSBodSBoeSBpYSBpdCBrbiBrdSBsYiBtYWkgbWwgbW4gbW5pIG1yIG5haCBuYXAgbmIgbmUgbmwgbm4gbm8gbnNvIG9yIHBhIHBhcCBwbXMgcHMgcHQgcm0gcncgc2F0IHNjbyBzZCBzZSBzaSBzbyBzb24gc3Egc3Ygc3cgdGEgdGUgdGsgdXIgeW8iLCAiYWNoIGFrIGFtIGFybiBiciBmaWwgZnIgZ3VuIGxuIG1mZSBtZyBtaSBvYyBwdC1CUiB0ZyB0aSB0ciB1eiB3YSB6aCIsICJpcyIsICJjc2IiLCAibHYiLCAibHQiLCAiYmUgYnMgaHIgcnUgc3IgdWsiLCAibW5rIiwgInJvIiwgInBsIiwgImNzIHNrIiwgImN5IiwgImt3IiwgInNsIiwgIm10IiwgImdkIiwgImdhIiwgImFyIiBdLmZvckVhY2goZnVuY3Rpb24obGFuZ3MsIGlkeCkgewogICAgICBsYW5ncy5zcGxpdCgiICIpLmZvckVhY2goZnVuY3Rpb24obGFuZykgewogICAgICAgIHBsdXJhbEZvcm1zTWFwW2xhbmddID0gdGhpczsKICAgICAgfSwgcGx1cmFsRm9ybXNbaWR4XSk7CiAgICB9KTsKICAgIHZhciBDdWx0dXJlID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQ3VsdHVyZSIsCiAgICAgIG5hbWU6ICIiLAogICAgICBwbHVyYWxGb3JtOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbihuYW1lLCBwbHVyYWxGb3JtKSB7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICBpZiAoIWN1bHR1cmVzW25hbWVdKSBjdWx0dXJlc1tuYW1lXSA9IHRoaXM7CiAgICAgICAgdGhpcy5wbHVyYWxGb3JtID0gcGx1cmFsRm9ybSB8fCBwbHVyYWxGb3Jtc01hcFtuYW1lXSB8fCBwbHVyYWxGb3Jtc01hcFtuYW1lLnNwbGl0KCItIilbMF1dIHx8IHBsdXJhbEZvcm1zWzBdOwogICAgICB9LAogICAgICBwbHVyYWw6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIE51bWJlcih0aGlzLnBsdXJhbEZvcm1bMV0oTWF0aC5hYnMocGFyc2VJbnQodmFsdWUsIDEwKSkpKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlQ3VsdHVyZShuYW1lLCBwbHVyYWxGb3JtKSB7CiAgICAgIGlmIChuYW1lICYmICFjdWx0dXJlc1tuYW1lXSkgY3VsdHVyZXNbbmFtZV0gPSBuZXcgQ3VsdHVyZShuYW1lLCBwbHVyYWxGb3JtKTsKICAgICAgcmV0dXJuIGN1bHR1cmVzW25hbWUgfHwgY3VycmVudEN1bHR1cmVdOwogICAgfQogICAgYmFzaXMub2JqZWN0LmV4dGVuZChyZXNvbHZlQ3VsdHVyZSwgbmV3IGJhc2lzLlRva2VuKTsKICAgIHJlc29sdmVDdWx0dXJlLnNldCA9IHNldEN1bHR1cmU7CiAgICBmdW5jdGlvbiBnZXRDdWx0dXJlKCkgewogICAgICByZXR1cm4gY3VycmVudEN1bHR1cmU7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRDdWx0dXJlKGN1bHR1cmUpIHsKICAgICAgaWYgKCFjdWx0dXJlKSByZXR1cm47CiAgICAgIGlmIChjdXJyZW50Q3VsdHVyZSAhPSBjdWx0dXJlKSB7CiAgICAgICAgaWYgKGN1bHR1cmVMaXN0LmluZGV4T2YoY3VsdHVyZSkgPT0gLTEpIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5sMTBuLnNldEN1bHR1cmU6IGN1bHR1cmUgYCIgKyBjdWx0dXJlICsgImAgbm90IGluIHRoZSBsaXN0LCB0aGUgY3VsdHVyZSBpc24ndCBjaGFuZ2VkIik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRDdWx0dXJlID0gY3VsdHVyZTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZGljdGlvbmFyeTsgZGljdGlvbmFyeSA9IGRpY3Rpb25hcmllc1tpXTsgaSsrKSBkaWN0aW9uYXJ5LnN5bmNWYWx1ZXMoKTsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuc2V0LmNhbGwocmVzb2x2ZUN1bHR1cmUsIGN1bHR1cmUpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXRDdWx0dXJlTGlzdCgpIHsKICAgICAgcmV0dXJuIGN1bHR1cmVMaXN0LnNsaWNlKDApOwogICAgfQogICAgZnVuY3Rpb24gc2V0Q3VsdHVyZUxpc3QobGlzdCkgewogICAgICBpZiAodHlwZW9mIGxpc3QgPT0gInN0cmluZyIpIGxpc3QgPSBsaXN0LnRyaW0oKS5zcGxpdCgiICIpOwogICAgICBpZiAoIWxpc3QubGVuZ3RoKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmwxMG4uc2V0Q3VsdHVyZUxpc3Q6IGN1bHR1cmUgbGlzdCBjYW4ndCBiZSBlbXB0eSwgdGhlIGN1bHR1cmUgbGlzdCBpc24ndCBjaGFuZ2VkIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBjdWx0dXJlcyA9IHt9OwogICAgICB2YXIgY3VsdHVyZVJvdzsKICAgICAgdmFyIGJhc2VDdWx0dXJlOwogICAgICBjdWx0dXJlRmFsbGJhY2sgPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGN1bHR1cmUsIGN1bHR1cmVOYW1lOyBjdWx0dXJlID0gbGlzdFtpXTsgaSsrKSB7CiAgICAgICAgY3VsdHVyZVJvdyA9IGN1bHR1cmUuc3BsaXQoIi8iKTsKICAgICAgICBpZiAoY3VsdHVyZVJvdy5sZW5ndGggPiAyKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMubDEwbi5zZXRDdWx0dXJlTGlzdDogb25seSBvbmUgZmFsbGJhY2sgY3VsdHVyZSBjYW4gYmUgc2V0IGZvciBjZXJ0YWluIGN1bHR1cmUsIHRyeSB0byBzZXQgYCIgKyBjdWx0dXJlICsgImA7IG90aGVyIGN1bHR1cmVzIGV4Y2VwdCBmaXJzdCBvbmUgd2FzIGlnbm9yZWQiKTsKICAgICAgICAgIGN1bHR1cmVSb3cgPSBjdWx0dXJlUm93LnNsaWNlKDAsIDIpOwogICAgICAgIH0KICAgICAgICBjdWx0dXJlTmFtZSA9IGN1bHR1cmVSb3dbMF07CiAgICAgICAgaWYgKCFiYXNlQ3VsdHVyZSkgYmFzZUN1bHR1cmUgPSBjdWx0dXJlTmFtZTsKICAgICAgICBjdWx0dXJlc1tjdWx0dXJlTmFtZV0gPSByZXNvbHZlQ3VsdHVyZShjdWx0dXJlTmFtZSk7CiAgICAgICAgY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXSA9IGN1bHR1cmVSb3c7CiAgICAgIH0KICAgICAgZm9yICh2YXIgY3VsdHVyZU5hbWUgaW4gY3VsdHVyZUZhbGxiYWNrKSB7CiAgICAgICAgY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXSA9IGJhc2lzLmFycmF5LmZsYXR0ZW4oY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXS5tYXAoZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcmV0dXJuIGN1bHR1cmVGYWxsYmFja1tuYW1lXTsKICAgICAgICB9KSkuY29uY2F0KGJhc2VDdWx0dXJlKS5maWx0ZXIoZnVuY3Rpb24oaXRlbSwgaWR4LCBhcnJheSkgewogICAgICAgICAgcmV0dXJuICFpZHggfHwgYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgaWR4IC0gMSkgPT0gLTE7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY3VsdHVyZUxpc3QgPSBiYXNpcy5vYmplY3Qua2V5cyhjdWx0dXJlcyk7CiAgICAgIGlmIChjdXJyZW50Q3VsdHVyZSBpbiBjdWx0dXJlcyA9PSBmYWxzZSkgc2V0Q3VsdHVyZShiYXNlQ3VsdHVyZSk7CiAgICB9CiAgICBmdW5jdGlvbiBvbkN1bHR1cmVDaGFuZ2UoZm4sIGNvbnRleHQsIGZpcmUpIHsKICAgICAgcmVzb2x2ZUN1bHR1cmUuYXR0YWNoKGZuLCBjb250ZXh0KTsKICAgICAgaWYgKGZpcmUpIGZuLmNhbGwoY29udGV4dCwgY3VycmVudEN1bHR1cmUpOwogICAgfQogICAgc2V0Q3VsdHVyZUxpc3QoImVuLVVTIik7CiAgICBzZXRDdWx0dXJlKCJlbi1VUyIpOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIENvbXB1dGVUb2tlbjogQ29tcHV0ZVRva2VuLAogICAgICBUb2tlbjogVG9rZW4sCiAgICAgIHRva2VuOiByZXNvbHZlVG9rZW4sCiAgICAgIERpY3Rpb25hcnk6IERpY3Rpb25hcnksCiAgICAgIGRpY3Rpb25hcnk6IHJlc29sdmVEaWN0aW9uYXJ5LAogICAgICBnZXREaWN0aW9uYXJpZXM6IGdldERpY3Rpb25hcmllcywKICAgICAgYWRkQ3JlYXRlRGljdGlvbmFyeUhhbmRsZXI6IGNyZWF0ZURpY3Rpb25hcnlOb3RpZmllci5hdHRhY2guYmluZChjcmVhdGVEaWN0aW9uYXJ5Tm90aWZpZXIpLAogICAgICByZW1vdmVDcmVhdGVEaWN0aW9uYXJ5SGFuZGxlcjogY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyLmRldGFjaC5iaW5kKGNyZWF0ZURpY3Rpb25hcnlOb3RpZmllciksCiAgICAgIEN1bHR1cmU6IEN1bHR1cmUsCiAgICAgIGN1bHR1cmU6IHJlc29sdmVDdWx0dXJlLAogICAgICBnZXRDdWx0dXJlOiBnZXRDdWx0dXJlLAogICAgICBzZXRDdWx0dXJlOiBzZXRDdWx0dXJlLAogICAgICBnZXRDdWx0dXJlTGlzdDogZ2V0Q3VsdHVyZUxpc3QsCiAgICAgIHNldEN1bHR1cmVMaXN0OiBzZXRDdWx0dXJlTGlzdCwKICAgICAgcGx1cmFsRm9ybXM6IHBsdXJhbEZvcm1zLAogICAgICBvbkN1bHR1cmVDaGFuZ2U6IG9uQ3VsdHVyZUNoYW5nZQogICAgfTsKICB9LAogICIzLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgZXh0ZW5kID0gYmFzaXMub2JqZWN0LmV4dGVuZDsKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIHZhciBOVUxMX0hBTkRMRVIgPSB7fTsKICAgIHZhciBldmVudHMgPSB7fTsKICAgIHZhciB3YXJuT25EZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgIGJhc2lzLmRldi53YXJuKCJPYmplY3QgaGFkIGJlZW4gZGVzdHJveWVkIGJlZm9yZS4gRGVzdHJveSBtZXRob2QgbXVzdCBub3QgYmUgY2FsbGVkIG1vcmUgdGhhbiBvbmNlLiIpOwogICAgfTsKICAgIGZ1bmN0aW9uIGNyZWF0ZURpc3BhdGNoZXIoZXZlbnROYW1lKSB7CiAgICAgIHZhciBldmVudEZ1bmN0aW9uID0gZXZlbnRzW2V2ZW50TmFtZV07CiAgICAgIGlmICghZXZlbnRGdW5jdGlvbikgewogICAgICAgIGV2ZW50RnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgICAgdmFyIGFyZ3M7CiAgICAgICAgICB2YXIgZm47CiAgICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpIHsKICAgICAgICAgICAgZm4gPSBjdXJzb3IuY2FsbGJhY2tzW2V2ZW50TmFtZV07CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICghYXJncykgewogICAgICAgICAgICAgICAgYXJncyA9IFsgdGhpcyBdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbi5hcHBseShjdXJzb3IuY29udGV4dCB8fCB0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbiA9IGN1cnNvci5jYWxsYmFja3NbIioiXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKCFhcmdzKSB7CiAgICAgICAgICAgICAgICBhcmdzID0gWyB0aGlzIF07CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgYXJncy5wdXNoKGFyZ3VtZW50c1tpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuLmNhbGwoY3Vyc29yLmNvbnRleHQgfHwgdGhpcywgewogICAgICAgICAgICAgICAgc2VuZGVyOiB0aGlzLAogICAgICAgICAgICAgICAgdHlwZTogZXZlbnROYW1lLAogICAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5kZWJ1Z19lbWl0KSB7CiAgICAgICAgICAgIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICB0aGlzLmRlYnVnX2VtaXQoewogICAgICAgICAgICAgIHNlbmRlcjogdGhpcywKICAgICAgICAgICAgICB0eXBlOiBldmVudE5hbWUsCiAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGV2ZW50RnVuY3Rpb24gPSAobmV3IEZ1bmN0aW9uKCJzbGljZSIsICdyZXR1cm4geyInICsgbmFtZXNwYWNlICsgIi5ldmVudHMuIiArIGV2ZW50TmFtZSArICciOlxuXG4gICAgICAnICsgImZ1bmN0aW9uKCIgKyBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuam9pbigiLCAiKSArICIpeyIgKyBldmVudEZ1bmN0aW9uLnRvU3RyaW5nKCkucmVwbGFjZSgvXGJldmVudE5hbWVcYi9nLCAnIicgKyBldmVudE5hbWUgKyAnIicpLnJlcGxhY2UoL15mdW5jdGlvblteKF0qXChcKVtee10qXHt8XH0kL2csICIiKSArICJ9IiArICdcblxufVsiJyArIG5hbWVzcGFjZSArICIuZXZlbnRzLiIgKyBldmVudE5hbWUgKyAnIl07JykpKHNsaWNlKTsKICAgICAgICBldmVudHNbZXZlbnROYW1lXSA9IGV2ZW50RnVuY3Rpb247CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50RnVuY3Rpb247CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVIYW5kbGVyKGV2ZW50cywgZXZlbnRDYWxsYmFjaykgewogICAgICB2YXIgaGFuZGxlciA9IHsKICAgICAgICBldmVudHM6IFtdCiAgICAgIH07CiAgICAgIGlmIChldmVudHMpIHsKICAgICAgICBldmVudHMgPSBTdHJpbmcoZXZlbnRzKS50cmltKCkuc3BsaXQoL1xzK3xccyosXHMqLykuc29ydCgpOwogICAgICAgIGhhbmRsZXIgPSB7CiAgICAgICAgICBldmVudHM6IGV2ZW50cwogICAgICAgIH07CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50TmFtZTsgZXZlbnROYW1lID0gZXZlbnRzW2ldOyBpKyspIGlmIChldmVudE5hbWUgIT0gImRlc3Ryb3kiKSBoYW5kbGVyW2V2ZW50TmFtZV0gPSBldmVudENhbGxiYWNrOwogICAgICB9CiAgICAgIHJldHVybiBoYW5kbGVyOwogICAgfQogICAgdmFyIEVtaXR0ZXIgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5FbWl0dGVyIiwKICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiB0cnVlLAogICAgICBoYW5kbGVyOiBudWxsLAogICAgICBlbWl0X2Rlc3Ryb3k6IGNyZWF0ZURpc3BhdGNoZXIoImRlc3Ryb3kiKSwKICAgICAgbGlzdGVuOiBDbGFzcy5uZXN0ZWRFeHRlbmRQcm9wZXJ0eSgpLAogICAgICBkZWJ1Z19oYW5kbGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgcmVzdWx0LnB1c2goWyBjdXJzb3IuY2FsbGJhY2tzLCBjdXJzb3IuY29udGV4dCBdKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9LAogICAgICBkZWJ1Z19lbWl0OiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5oYW5kbGVyICYmICF0aGlzLmhhbmRsZXIuY2FsbGJhY2tzKSB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFja3M6IHRoaXMuaGFuZGxlciwKICAgICAgICAgIGNvbnRleHQ6IHRoaXMsCiAgICAgICAgICBoYW5kbGVyOiBudWxsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgYWRkSGFuZGxlcjogZnVuY3Rpb24oY2FsbGJhY2tzLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKCFjYWxsYmFja3MpIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuRW1pdHRlciNhZGRIYW5kbGVyOiBjYWxsYmFja3MgaXMgbm90IGFuIG9iamVjdCAoIiwgY2FsbGJhY2tzLCAiKSIpOwogICAgICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IHRoaXM7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKSB7CiAgICAgICAgICBpZiAoY3Vyc29yLmNhbGxiYWNrcyA9PT0gY2FsbGJhY2tzICYmIGN1cnNvci5jb250ZXh0ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuRW1pdHRlciNhZGRIYW5kbGVyOiBhZGQgZHVwbGljYXRlIGV2ZW50IGNhbGxiYWNrcyIsIGNhbGxiYWNrcywgInRvIEVtaXR0ZXIgaW5zdGFuY2U6IiwgdGhpcyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFja3M6IGNhbGxiYWNrcywKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIKICAgICAgICB9OwogICAgICB9LAogICAgICByZW1vdmVIYW5kbGVyOiBmdW5jdGlvbihjYWxsYmFja3MsIGNvbnRleHQpIHsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB2YXIgcHJldjsKICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzOwogICAgICAgIHdoaWxlIChwcmV2ID0gY3Vyc29yLCBjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgaWYgKGN1cnNvci5jYWxsYmFja3MgPT09IGNhbGxiYWNrcyAmJiBjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgICAgY3Vyc29yLmNhbGxiYWNrcyA9IE5VTExfSEFORExFUjsKICAgICAgICAgIHByZXYuaGFuZGxlciA9IGN1cnNvci5oYW5kbGVyOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiLkVtaXR0ZXIjcmVtb3ZlSGFuZGxlcjogbm8gaGFuZGxlciByZW1vdmVkIik7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVzdHJveSA9IHdhcm5PbkRlc3Ryb3k7CiAgICAgICAgdGhpcy5lbWl0X2Rlc3Ryb3koKTsKICAgICAgICB0aGlzLmhhbmRsZXIgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBjcmVhdGU6IGNyZWF0ZURpc3BhdGNoZXIsCiAgICAgIGNyZWF0ZUhhbmRsZXI6IGNyZWF0ZUhhbmRsZXIsCiAgICAgIGV2ZW50czogZXZlbnRzLAogICAgICBFbWl0dGVyOiBFbWl0dGVyCiAgICB9OwogIH0sCiAgIjQuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMy5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBDbGFzcyA9IGJhc2lzLkNsYXNzOwogICAgdmFyIHNsaWNlQXJyYXkgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgICB2YXIgdmFsdWVzID0gYmFzaXMub2JqZWN0LnZhbHVlczsKICAgIHZhciAkc2VsZiA9IGJhc2lzLmZuLiRzZWxmOwogICAgdmFyIEVtaXR0ZXIgPSBiYXNpcy5ldmVudC5FbWl0dGVyOwogICAgdmFyIGNyZWF0ZUV2ZW50ID0gYmFzaXMuZXZlbnQuY3JlYXRlOwogICAgdmFyIGV2ZW50cyA9IGJhc2lzLmV2ZW50LmV2ZW50czsKICAgIHZhciBOVUxMX09CSkVDVCA9IHt9OwogICAgdmFyIEVNUFRZX0FSUkFZID0gW107CiAgICB2YXIgU1RBVEVfRVhJU1RTID0ge307CiAgICB2YXIgU1RBVEUgPSB7CiAgICAgIHByaW9yaXR5OiBbXSwKICAgICAgdmFsdWVzOiB7fSwKICAgICAgYWRkOiBmdW5jdGlvbihzdGF0ZSwgb3JkZXIpIHsKICAgICAgICB2YXIgbmFtZSA9IHN0YXRlOwogICAgICAgIHZhciB2YWx1ZSA9IHN0YXRlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgU1RBVEVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICBTVEFURV9FWElTVFNbdmFsdWVdID0gbmFtZTsKICAgICAgICB0aGlzLnZhbHVlc1t2YWx1ZV0gPSBuYW1lOwogICAgICAgIGlmIChvcmRlcikgb3JkZXIgPSB0aGlzLnByaW9yaXR5LmluZGV4T2Yob3JkZXIpOyBlbHNlIG9yZGVyID0gLTE7CiAgICAgICAgaWYgKG9yZGVyID09IC0xKSB0aGlzLnByaW9yaXR5LnB1c2godmFsdWUpOyBlbHNlIHRoaXMucHJpb3JpdHkuc3BsaWNlKG9yZGVyLCAwLCB2YWx1ZSk7CiAgICAgIH0sCiAgICAgIGdldExpc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB2YWx1ZXMoU1RBVEVfRVhJU1RTKTsKICAgICAgfQogICAgfTsKICAgIFNUQVRFLmFkZCgiUkVBRFkiKTsKICAgIFNUQVRFLmFkZCgiREVQUkVDQVRFRCIpOwogICAgU1RBVEUuYWRkKCJVTkRFRklORUQiKTsKICAgIFNUQVRFLmFkZCgiRVJST1IiKTsKICAgIFNUQVRFLmFkZCgiUFJPQ0VTU0lORyIpOwogICAgdmFyIHN1YnNjcmlwdGlvbkNvbmZpZyA9IHt9OwogICAgdmFyIHN1YnNjcmlwdGlvblNlZWQgPSAxOwogICAgdmFyIFNVQlNDUklQVElPTiA9IHsKICAgICAgTk9ORTogMCwKICAgICAgQUxMOiAwLAogICAgICBsaW5rOiBmdW5jdGlvbih0eXBlLCBmcm9tLCB0bykgewogICAgICAgIHZhciBzdWJzY3JpYmVySWQgPSB0eXBlICsgZnJvbS5iYXNpc09iamVjdElkOwogICAgICAgIHZhciBzdWJzY3JpYmVycyA9IHRvLnN1YnNjcmliZXJzXzsKICAgICAgICBpZiAoIXN1YnNjcmliZXJzKSBzdWJzY3JpYmVycyA9IHRvLnN1YnNjcmliZXJzXyA9IHt9OwogICAgICAgIGlmICghc3Vic2NyaWJlcnNbc3Vic2NyaWJlcklkXSkgewogICAgICAgICAgc3Vic2NyaWJlcnNbc3Vic2NyaWJlcklkXSA9IGZyb207CiAgICAgICAgICB2YXIgY291bnQgPSB0by5zdWJzY3JpYmVyQ291bnQgKz0gMTsKICAgICAgICAgIGlmIChjb3VudCA9PSAxKSB0by5lbWl0X3N1YnNjcmliZXJzQ2hhbmdlZCgrMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJBdHRlbXB0IHRvIGFkZCBkdXBsaWNhdGUgc3Vic2NyaXB0aW9uIik7CiAgICAgICAgfQogICAgICB9LAogICAgICB1bmxpbms6IGZ1bmN0aW9uKHR5cGUsIGZyb20sIHRvKSB7CiAgICAgICAgdmFyIHN1YnNjcmliZXJJZCA9IHR5cGUgKyBmcm9tLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgdmFyIHN1YnNjcmliZXJzID0gdG8uc3Vic2NyaWJlcnNfOwogICAgICAgIGlmIChzdWJzY3JpYmVycyAmJiBzdWJzY3JpYmVyc1tzdWJzY3JpYmVySWRdKSB7CiAgICAgICAgICBkZWxldGUgc3Vic2NyaWJlcnNbc3Vic2NyaWJlcklkXTsKICAgICAgICAgIHZhciBjb3VudCA9IHRvLnN1YnNjcmliZXJDb3VudCAtPSAxOwogICAgICAgICAgaWYgKGNvdW50ID09IDApIHsKICAgICAgICAgICAgdG8uZW1pdF9zdWJzY3JpYmVyc0NoYW5nZWQoLTEpOwogICAgICAgICAgICB0by5zdWJzY3JpYmVyc18gPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiVHJ5aW5nIHJlbW92ZSBub24tZXhpc3RzIHN1YnNjcmlwdGlvbiIpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYWRkOiBmdW5jdGlvbihuYW1lLCBoYW5kbGVyLCBhY3Rpb24pIHsKICAgICAgICBzdWJzY3JpcHRpb25Db25maWdbc3Vic2NyaXB0aW9uU2VlZF0gPSB7CiAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgICAgYWN0aW9uOiBhY3Rpb24KICAgICAgICB9OwogICAgICAgIFNVQlNDUklQVElPTltuYW1lXSA9IHN1YnNjcmlwdGlvblNlZWQ7CiAgICAgICAgU1VCU0NSSVBUSU9OLkFMTCB8PSBzdWJzY3JpcHRpb25TZWVkOwogICAgICAgIHN1YnNjcmlwdGlvblNlZWQgPDw9IDE7CiAgICAgIH0sCiAgICAgIGFkZFByb3BlcnR5OiBmdW5jdGlvbihwcm9wZXJ0eU5hbWUsIGV2ZW50TmFtZSkgewogICAgICAgIHZhciBoYW5kbGVyID0ge307CiAgICAgICAgaGFuZGxlcltldmVudE5hbWUgfHwgcHJvcGVydHlOYW1lICsgIkNoYW5nZWQiXSA9IGZ1bmN0aW9uKG9iamVjdCwgb2xkVmFsdWUpIHsKICAgICAgICAgIGlmIChvbGRWYWx1ZSBpbnN0YW5jZW9mIEFic3RyYWN0RGF0YSkgU1VCU0NSSVBUSU9OLnVubGluayhwcm9wZXJ0eU5hbWUsIG9iamVjdCwgb2xkVmFsdWUpOwogICAgICAgICAgaWYgKG9iamVjdFtwcm9wZXJ0eU5hbWVdIGluc3RhbmNlb2YgQWJzdHJhY3REYXRhKSBTVUJTQ1JJUFRJT04ubGluayhwcm9wZXJ0eU5hbWUsIG9iamVjdCwgb2JqZWN0W3Byb3BlcnR5TmFtZV0pOwogICAgICAgIH07CiAgICAgICAgdGhpcy5hZGQocHJvcGVydHlOYW1lLnRvVXBwZXJDYXNlKCksIGhhbmRsZXIsIGZ1bmN0aW9uKGZuLCBvYmplY3QpIHsKICAgICAgICAgIGlmIChvYmplY3RbcHJvcGVydHlOYW1lXSkgZm4ocHJvcGVydHlOYW1lLCBvYmplY3QsIG9iamVjdFtwcm9wZXJ0eU5hbWVdKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICAgIHZhciBtYXNrQ29uZmlnID0ge307CiAgICBmdW5jdGlvbiBtaXhGdW5jdGlvbnMoZm5BLCBmbkIpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIGZuQS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIGZuQi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gZ2V0TWFza0NvbmZpZyhtYXNrKSB7CiAgICAgIHZhciBjb25maWcgPSBtYXNrQ29uZmlnW21hc2tdOwogICAgICBpZiAoIWNvbmZpZykgewogICAgICAgIHZhciBhY3Rpb25zID0gW107CiAgICAgICAgdmFyIGhhbmRsZXIgPSB7fTsKICAgICAgICB2YXIgaWR4ID0gMTsKICAgICAgICBjb25maWcgPSBtYXNrQ29uZmlnW21hc2tdID0gewogICAgICAgICAgYWN0aW9uczogYWN0aW9ucywKICAgICAgICAgIGhhbmRsZXI6IGhhbmRsZXIKICAgICAgICB9OwogICAgICAgIHdoaWxlIChtYXNrKSB7CiAgICAgICAgICBpZiAobWFzayAmIDEpIHsKICAgICAgICAgICAgdmFyIGNmZyA9IHN1YnNjcmlwdGlvbkNvbmZpZ1tpZHhdOwogICAgICAgICAgICBhY3Rpb25zLnB1c2goY2ZnLmFjdGlvbik7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBjZmcuaGFuZGxlcikgaGFuZGxlcltrZXldID0gaGFuZGxlcltrZXldID8gbWl4RnVuY3Rpb25zKGhhbmRsZXJba2V5XSwgY2ZnLmhhbmRsZXJba2V5XSkgOiBjZmcuaGFuZGxlcltrZXldOwogICAgICAgICAgfQogICAgICAgICAgaWR4IDw8PSAxOwogICAgICAgICAgbWFzayA+Pj0gMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbmZpZzsKICAgIH0KICAgIGZ1bmN0aW9uIGFkZFN1YihvYmplY3QsIG1hc2spIHsKICAgICAgdmFyIGNvbmZpZyA9IGdldE1hc2tDb25maWcobWFzayk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhY3Rpb247IGFjdGlvbiA9IGNvbmZpZy5hY3Rpb25zW2ldOyBpKyspIGFjdGlvbihTVUJTQ1JJUFRJT04ubGluaywgb2JqZWN0KTsKICAgICAgb2JqZWN0LmFkZEhhbmRsZXIoY29uZmlnLmhhbmRsZXIpOwogICAgfQogICAgZnVuY3Rpb24gcmVtU3ViKG9iamVjdCwgbWFzaykgewogICAgICB2YXIgY29uZmlnID0gZ2V0TWFza0NvbmZpZyhtYXNrKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGFjdGlvbjsgYWN0aW9uID0gY29uZmlnLmFjdGlvbnNbaSsrXTsgKSBhY3Rpb24oU1VCU0NSSVBUSU9OLnVubGluaywgb2JqZWN0KTsKICAgICAgb2JqZWN0LnJlbW92ZUhhbmRsZXIoY29uZmlnLmhhbmRsZXIpOwogICAgfQogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJkZWxlZ2F0ZSIpOwogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJ0YXJnZXQiKTsKICAgIFNVQlNDUklQVElPTi5hZGRQcm9wZXJ0eSgiZGF0YXNldCIpOwogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJ2YWx1ZSIsICJjaGFuZ2UiKTsKICAgIHZhciBBYnN0cmFjdERhdGEgPSBDbGFzcyhFbWl0dGVyLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5BYnN0cmFjdERhdGEiLAogICAgICBzdGF0ZTogU1RBVEUuVU5ERUZJTkVELAogICAgICBlbWl0X3N0YXRlQ2hhbmdlZDogY3JlYXRlRXZlbnQoInN0YXRlQ2hhbmdlZCIsICJvbGRTdGF0ZSIpLAogICAgICBhY3RpdmU6IGZhbHNlLAogICAgICBlbWl0X2FjdGl2ZUNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJhY3RpdmVDaGFuZ2VkIiksCiAgICAgIHN1YnNjcmliZVRvOiBTVUJTQ1JJUFRJT04uTk9ORSwKICAgICAgc3Vic2NyaWJlckNvdW50OiAwLAogICAgICBzdWJzY3JpYmVyc186IG51bGwsCiAgICAgIGVtaXRfc3Vic2NyaWJlcnNDaGFuZ2VkOiBjcmVhdGVFdmVudCgic3Vic2NyaWJlcnNDaGFuZ2VkIiwgImRlbHRhIiksCiAgICAgIHN5bmNFdmVudHM6IENsYXNzLm9uZUZ1bmN0aW9uUHJvcGVydHkoZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuaXNTeW5jUmVxdWlyZWQoKSkgdGhpcy5zeW5jQWN0aW9uKCk7CiAgICAgIH0sIHsKICAgICAgICBzdGF0ZUNoYW5nZWQ6IHRydWUsCiAgICAgICAgc3Vic2NyaWJlcnNDaGFuZ2VkOiB0cnVlCiAgICAgIH0pLAogICAgICBzeW5jQWN0aW9uOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlKSB0aGlzLmFkZEhhbmRsZXIoZ2V0TWFza0NvbmZpZyh0aGlzLnN1YnNjcmliZVRvKS5oYW5kbGVyKTsKICAgICAgICB2YXIgc3luY0FjdGlvbiA9IHRoaXMuc3luY0FjdGlvbjsKICAgICAgICBpZiAoc3luY0FjdGlvbikgewogICAgICAgICAgdGhpcy5zeW5jQWN0aW9uID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2V0U3luY0FjdGlvbihzeW5jQWN0aW9uKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFN0YXRlOiBmdW5jdGlvbihzdGF0ZSwgZGF0YSkgewogICAgICAgIHZhciBzdGF0ZUNvZGUgPSBTdHJpbmcoc3RhdGUpOwogICAgICAgIGlmICghU1RBVEVfRVhJU1RTW3N0YXRlQ29kZV0pIHRocm93IG5ldyBFcnJvcigiV3Jvbmcgc3RhdGUgdmFsdWUiKTsKICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPSBzdGF0ZUNvZGUgfHwgdGhpcy5zdGF0ZS5kYXRhICE9IGRhdGEpIHsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IHRoaXMuc3RhdGU7CiAgICAgICAgICB0aGlzLnN0YXRlID0gT2JqZWN0KHN0YXRlQ29kZSk7CiAgICAgICAgICB0aGlzLnN0YXRlLmRhdGEgPSBkYXRhOwogICAgICAgICAgdGhpcy5lbWl0X3N0YXRlQ2hhbmdlZChvbGRTdGF0ZSk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAogICAgICBkZXByZWNhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnN0YXRlICE9IFNUQVRFLlBST0NFU1NJTkcpIHRoaXMuc2V0U3RhdGUoU1RBVEUuREVQUkVDQVRFRCk7CiAgICAgIH0sCiAgICAgIHNldEFjdGl2ZTogZnVuY3Rpb24oaXNBY3RpdmUpIHsKICAgICAgICBpc0FjdGl2ZSA9ICEhaXNBY3RpdmU7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlICE9IGlzQWN0aXZlKSB7CiAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGlzQWN0aXZlOwogICAgICAgICAgdGhpcy5lbWl0X2FjdGl2ZUNoYW5nZWQoKTsKICAgICAgICAgIGlmIChpc0FjdGl2ZSkgYWRkU3ViKHRoaXMsIHRoaXMuc3Vic2NyaWJlVG8pOyBlbHNlIHJlbVN1Yih0aGlzLCB0aGlzLnN1YnNjcmliZVRvKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0sCiAgICAgIHNldFN1YnNjcmlwdGlvbjogZnVuY3Rpb24oc3Vic2NyaXB0aW9uVHlwZSkgewogICAgICAgIHZhciBjdXJTdWJzY3JpcHRpb25UeXBlID0gdGhpcy5zdWJzY3JpYmVUbzsKICAgICAgICB2YXIgbmV3U3Vic2NyaXB0aW9uVHlwZSA9IHN1YnNjcmlwdGlvblR5cGUgJiBTVUJTQ1JJUFRJT04uQUxMOwogICAgICAgIHZhciBkZWx0YSA9IGN1clN1YnNjcmlwdGlvblR5cGUgXiBuZXdTdWJzY3JpcHRpb25UeXBlOwogICAgICAgIGlmIChkZWx0YSkgewogICAgICAgICAgdGhpcy5zdWJzY3JpYmVUbyA9IG5ld1N1YnNjcmlwdGlvblR5cGU7CiAgICAgICAgICBpZiAodGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgdmFyIGN1ckNvbmZpZyA9IGdldE1hc2tDb25maWcoY3VyU3Vic2NyaXB0aW9uVHlwZSk7CiAgICAgICAgICAgIHZhciBuZXdDb25maWcgPSBnZXRNYXNrQ29uZmlnKG5ld1N1YnNjcmlwdGlvblR5cGUpOwogICAgICAgICAgICB0aGlzLnJlbW92ZUhhbmRsZXIoY3VyQ29uZmlnLmhhbmRsZXIpOwogICAgICAgICAgICB0aGlzLmFkZEhhbmRsZXIobmV3Q29uZmlnLmhhbmRsZXIpOwogICAgICAgICAgICB2YXIgaWR4ID0gMTsKICAgICAgICAgICAgd2hpbGUgKGRlbHRhKSB7CiAgICAgICAgICAgICAgaWYgKGRlbHRhICYgMSkgewogICAgICAgICAgICAgICAgdmFyIGNmZyA9IHN1YnNjcmlwdGlvbkNvbmZpZ1tpZHhdOwogICAgICAgICAgICAgICAgaWYgKGN1clN1YnNjcmlwdGlvblR5cGUgJiBpZHgpIGNmZy5hY3Rpb24oU1VCU0NSSVBUSU9OLnVubGluaywgdGhpcyk7IGVsc2UgY2ZnLmFjdGlvbihTVUJTQ1JJUFRJT04ubGluaywgdGhpcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlkeCA8PD0gMTsKICAgICAgICAgICAgICBkZWx0YSA+Pj0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgaXNTeW5jUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnN1YnNjcmliZXJDb3VudCA+IDAgJiYgKHRoaXMuc3RhdGUgPT0gU1RBVEUuVU5ERUZJTkVEIHx8IHRoaXMuc3RhdGUgPT0gU1RBVEUuREVQUkVDQVRFRCk7CiAgICAgIH0sCiAgICAgIHNldFN5bmNBY3Rpb246IGZ1bmN0aW9uKHN5bmNBY3Rpb24pIHsKICAgICAgICB2YXIgb2xkQWN0aW9uID0gdGhpcy5zeW5jQWN0aW9uOwogICAgICAgIGlmICh0eXBlb2Ygc3luY0FjdGlvbiAhPSAiZnVuY3Rpb24iKSBzeW5jQWN0aW9uID0gbnVsbDsKICAgICAgICB0aGlzLnN5bmNBY3Rpb24gPSBzeW5jQWN0aW9uOwogICAgICAgIGlmIChzeW5jQWN0aW9uKSB7CiAgICAgICAgICBpZiAoIW9sZEFjdGlvbikgdGhpcy5hZGRIYW5kbGVyKHRoaXMuc3luY0V2ZW50cyk7CiAgICAgICAgICBpZiAodGhpcy5pc1N5bmNSZXF1aXJlZCgpKSB0aGlzLnN5bmNBY3Rpb24oKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKG9sZEFjdGlvbikgdGhpcy5yZW1vdmVIYW5kbGVyKHRoaXMuc3luY0V2ZW50cyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgICAgICB2YXIgY29uZmlnID0gZ2V0TWFza0NvbmZpZyh0aGlzLnN1YnNjcmliZVRvKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBhY3Rpb247IGFjdGlvbiA9IGNvbmZpZy5hY3Rpb25zW2ldOyBpKyspIGFjdGlvbihTVUJTQ1JJUFRJT04udW5saW5rLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zdGF0ZSA9IFNUQVRFLlVOREVGSU5FRDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgR0VUVEVSX0lEID0gYmFzaXMuZ2V0dGVyLklEOwogICAgdmFyIFZBTFVFX0VNTUlURVJfSEFORExFUiA9IHsKICAgICAgZGVzdHJveTogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgdGhpcy52YWx1ZS51bmxpbmsob2JqZWN0LCB0aGlzLmZuKTsKICAgICAgfQogICAgfTsKICAgIHZhciBWQUxVRV9FTU1JVEVSX0RFU1RST1lfSEFORExFUiA9IHsKICAgICAgZGVzdHJveTogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgdGhpcy5zZXQobnVsbCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgY29tcHV0ZUZ1bmN0aW9ucyA9IHt9OwogICAgdmFyIHZhbHVlU2V0dGVycyA9IHt9OwogICAgdmFyIHZhbHVlU3luY1Rva2VuID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy5zZXQodGhpcy5mbih2YWx1ZSkpOwogICAgfTsKICAgIHZhciBWYWx1ZSA9IENsYXNzKEFic3RyYWN0RGF0YSwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVmFsdWUiLAogICAgICBzdWJzY3JpYmVUbzogU1VCU0NSSVBUSU9OLlZBTFVFLAogICAgICBlbWl0X2NoYW5nZTogY3JlYXRlRXZlbnQoImNoYW5nZSIsICJvbGRWYWx1ZSIpICYmIGZ1bmN0aW9uKG9sZFZhbHVlKSB7CiAgICAgICAgZXZlbnRzLmNoYW5nZS5jYWxsKHRoaXMsIG9sZFZhbHVlKTsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmxpbmtzXykgY3Vyc29yLmZuLmNhbGwoY3Vyc29yLmNvbnRleHQsIHRoaXMudmFsdWUsIG9sZFZhbHVlKTsKICAgICAgfSwKICAgICAgdmFsdWU6IG51bGwsCiAgICAgIGluaXRWYWx1ZTogbnVsbCwKICAgICAgcHJveHk6IG51bGwsCiAgICAgIGxvY2tlZDogMCwKICAgICAgbG9ja2VkVmFsdWVfOiBudWxsLAogICAgICBsaW5rc186IG51bGwsCiAgICAgIHNldE51bGxPbkVtaXR0ZXJEZXN0cm95OiB0cnVlLAogICAgICBiaW5kaW5nQnJpZGdlOiB7CiAgICAgICAgYXR0YWNoOiBmdW5jdGlvbihob3N0LCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgaG9zdC5saW5rKGNvbnRleHQsIGNhbGxiYWNrLCB0cnVlKTsKICAgICAgICB9LAogICAgICAgIGRldGFjaDogZnVuY3Rpb24oaG9zdCwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgIGhvc3QudW5saW5rKGNvbnRleHQsIGNhbGxiYWNrKTsKICAgICAgICB9LAogICAgICAgIGdldDogZnVuY3Rpb24oaG9zdCkgewogICAgICAgICAgcmV0dXJuIGhvc3QudmFsdWU7CiAgICAgICAgfQogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICBpZiAodGhpcy5wcm94eSkgdGhpcy52YWx1ZSA9IHRoaXMucHJveHkodGhpcy52YWx1ZSk7CiAgICAgICAgaWYgKHRoaXMuc2V0TnVsbE9uRW1pdHRlckRlc3Ryb3kgJiYgdGhpcy52YWx1ZSBpbnN0YW5jZW9mIEVtaXR0ZXIpIHRoaXMudmFsdWUuYWRkSGFuZGxlcihWQUxVRV9FTU1JVEVSX0RFU1RST1lfSEFORExFUiwgdGhpcyk7CiAgICAgICAgdGhpcy5pbml0VmFsdWUgPSB0aGlzLnZhbHVlOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG9sZFZhbHVlID0gdGhpcy52YWx1ZTsKICAgICAgICB2YXIgbmV3VmFsdWUgPSB0aGlzLnByb3h5ID8gdGhpcy5wcm94eSh2YWx1ZSkgOiB2YWx1ZTsKICAgICAgICB2YXIgY2hhbmdlZCA9IG5ld1ZhbHVlICE9PSBvbGRWYWx1ZTsKICAgICAgICBpZiAoY2hhbmdlZCkgewogICAgICAgICAgaWYgKHRoaXMuc2V0TnVsbE9uRW1pdHRlckRlc3Ryb3kpIHsKICAgICAgICAgICAgaWYgKG9sZFZhbHVlIGluc3RhbmNlb2YgRW1pdHRlcikgb2xkVmFsdWUucmVtb3ZlSGFuZGxlcihWQUxVRV9FTU1JVEVSX0RFU1RST1lfSEFORExFUiwgdGhpcyk7CiAgICAgICAgICAgIGlmIChuZXdWYWx1ZSBpbnN0YW5jZW9mIEVtaXR0ZXIpIG5ld1ZhbHVlLmFkZEhhbmRsZXIoVkFMVUVfRU1NSVRFUl9ERVNUUk9ZX0hBTkRMRVIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy52YWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgaWYgKCF0aGlzLmxvY2tlZCkgdGhpcy5lbWl0X2NoYW5nZShvbGRWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgICB9LAogICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXQodGhpcy5pbml0VmFsdWUpOwogICAgICB9LAogICAgICBpc0xvY2tlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9ja2VkID4gMDsKICAgICAgfSwKICAgICAgbG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5sb2NrZWQrKzsKICAgICAgICBpZiAodGhpcy5sb2NrZWQgPT0gMSkgdGhpcy5sb2NrZWRWYWx1ZV8gPSB0aGlzLnZhbHVlOwogICAgICB9LAogICAgICB1bmxvY2s6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmxvY2tlZCkgewogICAgICAgICAgdGhpcy5sb2NrZWQtLTsKICAgICAgICAgIGlmICghdGhpcy5sb2NrZWQpIHsKICAgICAgICAgICAgdmFyIGxvY2tlZFZhbHVlID0gdGhpcy5sb2NrZWRWYWx1ZV87CiAgICAgICAgICAgIHRoaXMubG9ja2VkVmFsdWVfID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IGxvY2tlZFZhbHVlKSB0aGlzLmVtaXRfY2hhbmdlKGxvY2tlZFZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGV2ZW50cywgZm4pIHsKICAgICAgICBpZiAoIWZuKSB7CiAgICAgICAgICBmbiA9IGV2ZW50czsKICAgICAgICAgIGV2ZW50cyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICghZm4pIGZuID0gJHNlbGY7CiAgICAgICAgdmFyIGhvc3RWYWx1ZSA9IHRoaXM7CiAgICAgICAgdmFyIGhhbmRsZXIgPSBiYXNpcy5ldmVudC5jcmVhdGVIYW5kbGVyKGV2ZW50cywgZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICB0aGlzLnNldChmbihvYmplY3QsIGhvc3RWYWx1ZS52YWx1ZSkpOwogICAgICAgIH0pOwogICAgICAgIHZhciBmbklkID0gZm5bR0VUVEVSX0lEXSB8fCBTdHJpbmcoZm4pOwogICAgICAgIHZhciBnZXRDb21wdXRlVG9rZW5JZCA9IGhhbmRsZXIuZXZlbnRzLmNvbmNhdChmbklkLCB0aGlzLmJhc2lzT2JqZWN0SWQpLmpvaW4oIl8iKTsKICAgICAgICB2YXIgZ2V0Q29tcHV0ZVRva2VuID0gY29tcHV0ZUZ1bmN0aW9uc1tnZXRDb21wdXRlVG9rZW5JZF07CiAgICAgICAgaWYgKCFnZXRDb21wdXRlVG9rZW4pIHsKICAgICAgICAgIHZhciB0b2tlbk1hcCA9IHt9OwogICAgICAgICAgaGFuZGxlci5kZXN0cm95ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIGRlbGV0ZSB0b2tlbk1hcFtvYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgICAgICAgIHRoaXMuZGVzdHJveSgpOwogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMuYWRkSGFuZGxlcih7CiAgICAgICAgICAgIGNoYW5nZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHRva2VuTWFwKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFpciA9IHRva2VuTWFwW2tleV07CiAgICAgICAgICAgICAgICBwYWlyLnRva2VuLnNldChmbihwYWlyLm9iamVjdCwgdGhpcy52YWx1ZSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHRva2VuTWFwKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFpciA9IHRva2VuTWFwW2tleV07CiAgICAgICAgICAgICAgICBwYWlyLm9iamVjdC5yZW1vdmVIYW5kbGVyKGhhbmRsZXIsIHBhaXIudG9rZW4pOwogICAgICAgICAgICAgICAgcGFpci50b2tlbi5kZXN0cm95KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRva2VuTWFwID0gbnVsbDsKICAgICAgICAgICAgICBob3N0VmFsdWUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGdldENvbXB1dGVUb2tlbiA9IGNvbXB1dGVGdW5jdGlvbnNbZ2V0Q29tcHV0ZVRva2VuSWRdID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiBiYXNpcy5ldmVudC5FbWl0dGVyID09IGZhbHNlKSBiYXNpcy5kZXYud2FybigiYmFzaXMuZGF0YS5WYWx1ZSNjb21wdXRlOiBvYmplY3Qgc2hvdWxkIGJlIGFuIGluc3RhbmNlb2YgYmFzaXMuZXZlbnQuRW1pdHRlciIpOwogICAgICAgICAgICB2YXIgb2JqZWN0SWQgPSBvYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgdmFyIHBhaXIgPSB0b2tlbk1hcFtvYmplY3RJZF07CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGZuKG9iamVjdCwgaG9zdFZhbHVlLnZhbHVlKTsKICAgICAgICAgICAgaWYgKCFwYWlyKSB7CiAgICAgICAgICAgICAgdmFyIHRva2VuID0gbmV3IGJhc2lzLlRva2VuKHZhbHVlKTsKICAgICAgICAgICAgICBvYmplY3QuYWRkSGFuZGxlcihoYW5kbGVyLCB0b2tlbik7CiAgICAgICAgICAgICAgcGFpciA9IHRva2VuTWFwW29iamVjdElkXSA9IHsKICAgICAgICAgICAgICAgIHRva2VuOiB0b2tlbiwKICAgICAgICAgICAgICAgIG9iamVjdDogb2JqZWN0CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYWlyLnRva2VuLnNldCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhaXIudG9rZW47CiAgICAgICAgICB9OwogICAgICAgICAgZ2V0Q29tcHV0ZVRva2VuLmRlZmVycmVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcHV0ZVRva2VuKG9iamVjdCkuZGVmZXJyZWQoKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXRDb21wdXRlVG9rZW47CiAgICAgIH0sCiAgICAgIGFzOiBmdW5jdGlvbihmbiwgZGVmZXJyZWQpIHsKICAgICAgICBpZiAoIWZuKSBmbiA9ICRzZWxmOwogICAgICAgIGlmICh0aGlzLmxpbmtzXykgewogICAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgICB2YXIgZm5JZCA9IGZuW0dFVFRFUl9JRF0gfHwgU3RyaW5nKGZuKTsKICAgICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IubGlua3NfKSB7CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0gY3Vyc29yLmNvbnRleHQ7CiAgICAgICAgICAgIGlmIChjb250ZXh0IGluc3RhbmNlb2YgYmFzaXMuVG9rZW4gJiYgKGNvbnRleHQuZm5bR0VUVEVSX0lEXSB8fCBTdHJpbmcoY29udGV4dC5mbikpID09IGZuSWQpIHJldHVybiBkZWZlcnJlZCA/IGNvbnRleHQuZGVmZXJyZWQoKSA6IGNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB0b2tlbiA9IG5ldyBiYXNpcy5Ub2tlbjsKICAgICAgICB0b2tlbi5mbiA9IGZuOwogICAgICAgIHRoaXMubGluayh0b2tlbiwgdmFsdWVTeW5jVG9rZW4pOwogICAgICAgIHJldHVybiBkZWZlcnJlZCA/IHRva2VuLmRlZmVycmVkKCkgOiB0b2tlbjsKICAgICAgfSwKICAgICAgZGVmZXJyZWQ6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYXMoZm4sIHRydWUpOwogICAgICB9LAogICAgICBsaW5rOiBmdW5jdGlvbihjb250ZXh0LCBmbiwgbm9BcHBseSkgewogICAgICAgIGlmICh0eXBlb2YgZm4gIT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdmFyIHByb3BlcnR5ID0gU3RyaW5nKGZuKTsKICAgICAgICAgIGZuID0gdmFsdWVTZXR0ZXJzW3Byb3BlcnR5XTsKICAgICAgICAgIGlmICghZm4pIGZuID0gdmFsdWVTZXR0ZXJzW3Byb3BlcnR5XSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXNbcHJvcGVydHldID0gdmFsdWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmxpbmtzXykgaWYgKGN1cnNvci5jb250ZXh0ID09PSBjb250ZXh0ICYmIGN1cnNvci5mbiA9PT0gZm4pIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKHRoaXMuY29uc3RydWN0b3IuY2xhc3NOYW1lICsgIiNhdHRhY2g6IER1cGxpY2F0ZSBsaW5rIHBhaXIgY29udGV4dC1mbiIpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHRoaXMubGlua3NfID0gewogICAgICAgICAgdmFsdWU6IHRoaXMsCiAgICAgICAgICBjb250ZXh0OiBjb250ZXh0LAogICAgICAgICAgZm46IGZuLAogICAgICAgICAgbGlua3NfOiB0aGlzLmxpbmtzXwogICAgICAgIH07CiAgICAgICAgaWYgKGNvbnRleHQgaW5zdGFuY2VvZiBFbWl0dGVyKSBjb250ZXh0LmFkZEhhbmRsZXIoVkFMVUVfRU1NSVRFUl9IQU5ETEVSLCB0aGlzLmxpbmtzXyk7CiAgICAgICAgaWYgKCFub0FwcGx5KSBmbi5jYWxsKGNvbnRleHQsIHRoaXMudmFsdWUpOwogICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICB9LAogICAgICB1bmxpbms6IGZ1bmN0aW9uKGNvbnRleHQsIGZuKSB7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgdmFyIHByZXY7CiAgICAgICAgd2hpbGUgKHByZXYgPSBjdXJzb3IsIGN1cnNvciA9IGN1cnNvci5saW5rc18pIGlmIChjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCAmJiAoIWZuIHx8IGN1cnNvci5mbiA9PT0gZm4pKSB7CiAgICAgICAgICBjdXJzb3IuZm4gPSBiYXNpcy5mbi4kdW5kZWY7CiAgICAgICAgICBwcmV2LmxpbmtzXyA9IGN1cnNvci5saW5rc187CiAgICAgICAgICBpZiAoY3Vyc29yLmNvbnRleHQgaW5zdGFuY2VvZiBFbWl0dGVyKSBjdXJzb3IuY29udGV4dC5yZW1vdmVIYW5kbGVyKFZBTFVFX0VNTUlURVJfSEFORExFUiwgY3Vyc29yKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIEFic3RyYWN0RGF0YS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIGlmICh0aGlzLnNldE51bGxPbkVtaXR0ZXJEZXN0cm95ICYmIHRoaXMudmFsdWUgaW5zdGFuY2VvZiBFbWl0dGVyKSB0aGlzLnZhbHVlLnJlbW92ZUhhbmRsZXIoVkFMVUVfRU1NSVRFUl9ERVNUUk9ZX0hBTkRMRVIsIHRoaXMpOwogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IubGlua3NfKSBpZiAoY3Vyc29yLmNvbnRleHQgaW5zdGFuY2VvZiBFbWl0dGVyKSBjdXJzb3IuY29udGV4dC5yZW1vdmVIYW5kbGVyKFZBTFVFX0VNTUlURVJfSEFORExFUiwgY3Vyc29yKTsKICAgICAgICB0aGlzLnByb3h5ID0gbnVsbDsKICAgICAgICB0aGlzLmluaXRWYWx1ZSA9IG51bGw7CiAgICAgICAgdGhpcy52YWx1ZSA9IG51bGw7CiAgICAgICAgdGhpcy5sb2NrZWRWYWx1ZV8gPSBudWxsOwogICAgICAgIHRoaXMubGlua3NfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgdmFsdWVGcm9tTWFwID0ge307CiAgICB2YXIgdmFsdWVGcm9tU2V0UHJveHkgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgVmFsdWUucHJvdG90eXBlLnNldC5jYWxsKHRoaXMsIG9iamVjdCk7CiAgICB9OwogICAgVmFsdWUuZnJvbSA9IGZ1bmN0aW9uKG9iaiwgZXZlbnRzLCBnZXR0ZXIpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgaWYgKCFvYmopIHJldHVybiBudWxsOwogICAgICBpZiAob2JqIGluc3RhbmNlb2YgRW1pdHRlcikgewogICAgICAgIGlmICghZ2V0dGVyKSB7CiAgICAgICAgICBnZXR0ZXIgPSBldmVudHM7CiAgICAgICAgICBldmVudHMgPSBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAoIWdldHRlcikgZ2V0dGVyID0gJHNlbGY7CiAgICAgICAgdmFyIGhhbmRsZXIgPSBiYXNpcy5ldmVudC5jcmVhdGVIYW5kbGVyKGV2ZW50cywgdmFsdWVGcm9tU2V0UHJveHkpOwogICAgICAgIHZhciBnZXR0ZXJJZCA9IGdldHRlcltHRVRURVJfSURdIHx8IFN0cmluZyhnZXR0ZXIpOwogICAgICAgIHZhciBpZCA9IGhhbmRsZXIuZXZlbnRzLmNvbmNhdChnZXR0ZXJJZCwgb2JqLmJhc2lzT2JqZWN0SWQpLmpvaW4oIl8iKTsKICAgICAgICByZXN1bHQgPSB2YWx1ZUZyb21NYXBbaWRdOwogICAgICAgIGlmICghcmVzdWx0KSB7CiAgICAgICAgICByZXN1bHQgPSB2YWx1ZUZyb21NYXBbaWRdID0gbmV3IFZhbHVlKHsKICAgICAgICAgICAgdmFsdWU6IG9iaiwKICAgICAgICAgICAgcHJveHk6IGJhc2lzLmdldHRlcihnZXR0ZXIpLAogICAgICAgICAgICBzZXQ6IGJhc2lzLmZuLiR1bmRlZiwKICAgICAgICAgICAgaGFuZGxlcjogewogICAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFsdWVGcm9tTWFwW2lkXSA9IG51bGw7CiAgICAgICAgICAgICAgICBvYmoucmVtb3ZlSGFuZGxlcihoYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgaGFuZGxlci5kZXN0cm95ID0gZnVuY3Rpb24oc2VuZGVyKSB7CiAgICAgICAgICAgIHZhbHVlRnJvbU1hcFtpZF0gPSBudWxsOwogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgIH07CiAgICAgICAgICBvYmouYWRkSGFuZGxlcihoYW5kbGVyLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgIHZhciBpZCA9IG9iai5iYXNpc09iamVjdElkOwogICAgICAgIHZhciBiaW5kaW5nQnJpZGdlID0gb2JqLmJpbmRpbmdCcmlkZ2U7CiAgICAgICAgaWYgKGlkICYmIGJpbmRpbmdCcmlkZ2UpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlRnJvbU1hcFtpZF07CiAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICByZXN1bHQgPSB2YWx1ZUZyb21NYXBbaWRdID0gbmV3IFZhbHVlKHsKICAgICAgICAgICAgICB2YWx1ZTogYmluZGluZ0JyaWRnZS5nZXQob2JqKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYmluZGluZ0JyaWRnZS5hdHRhY2gob2JqLCByZXN1bHQuc2V0LCByZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIXJlc3VsdCkgdGhyb3cgIkJhZCBvYmplY3QgdHlwZSI7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgVmFsdWUuZmFjdG9yeSA9IGZ1bmN0aW9uKGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gVmFsdWUuZnJvbShvYmplY3QsIGV2ZW50cywgZ2V0dGVyKTsKICAgICAgfTsKICAgIH07CiAgICB2YXIgSU5JVF9EQVRBID0ge307CiAgICBmdW5jdGlvbiBpc0Nvbm5lY3RlZChhLCBiKSB7CiAgICAgIHdoaWxlIChiICYmIGIgIT09IGEgJiYgYiAhPT0gYi5kZWxlZ2F0ZSkgYiA9IGIuZGVsZWdhdGU7CiAgICAgIHJldHVybiBiID09PSBhOwogICAgfQogICAgZnVuY3Rpb24gYXBwbHlEZWxlZ2F0ZUNoYW5nZXMob2JqZWN0LCBvbGRSb290LCBvbGRUYXJnZXQpIHsKICAgICAgdmFyIGRlbGVnYXRlID0gb2JqZWN0LmRlbGVnYXRlOwogICAgICBpZiAoZGVsZWdhdGUpIHsKICAgICAgICBvYmplY3Qucm9vdCA9IGRlbGVnYXRlLnJvb3Q7CiAgICAgICAgb2JqZWN0LnRhcmdldCA9IGRlbGVnYXRlLnRhcmdldDsKICAgICAgICBvYmplY3QuZGF0YSA9IGRlbGVnYXRlLmRhdGE7CiAgICAgICAgb2JqZWN0LnN0YXRlID0gZGVsZWdhdGUuc3RhdGU7CiAgICAgIH0KICAgICAgaWYgKG9iamVjdC5yb290ICE9PSBvbGRSb290KSB7CiAgICAgICAgdmFyIHJvb3RMaXN0ZW5IYW5kbGVyID0gb2JqZWN0Lmxpc3Rlbi5yb290OwogICAgICAgIGlmIChyb290TGlzdGVuSGFuZGxlcikgewogICAgICAgICAgaWYgKG9sZFJvb3QgJiYgb2xkUm9vdCAhPT0gb2JqZWN0KSBvbGRSb290LnJlbW92ZUhhbmRsZXIocm9vdExpc3RlbkhhbmRsZXIsIG9iamVjdCk7CiAgICAgICAgICBpZiAob2JqZWN0LnJvb3QgJiYgb2JqZWN0LnJvb3QgIT09IG9iamVjdCkgb2JqZWN0LnJvb3QuYWRkSGFuZGxlcihyb290TGlzdGVuSGFuZGxlciwgb2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgb2JqZWN0LmVtaXRfcm9vdENoYW5nZWQob2xkUm9vdCk7CiAgICAgIH0KICAgICAgaWYgKG9iamVjdC50YXJnZXQgIT09IG9sZFRhcmdldCkgewogICAgICAgIHZhciB0YXJnZXRMaXN0ZW5IYW5kbGVyID0gb2JqZWN0Lmxpc3Rlbi50YXJnZXQ7CiAgICAgICAgaWYgKHRhcmdldExpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgIGlmIChvbGRUYXJnZXQgJiYgb2xkVGFyZ2V0ICE9PSBvYmplY3QpIG9sZFRhcmdldC5yZW1vdmVIYW5kbGVyKHRhcmdldExpc3RlbkhhbmRsZXIsIG9iamVjdCk7CiAgICAgICAgICBpZiAob2JqZWN0LnRhcmdldCAmJiBvYmplY3QudGFyZ2V0ICE9PSBvYmplY3QpIG9iamVjdC50YXJnZXQuYWRkSGFuZGxlcih0YXJnZXRMaXN0ZW5IYW5kbGVyLCBvYmplY3QpOwogICAgICAgIH0KICAgICAgICBvYmplY3QuZW1pdF90YXJnZXRDaGFuZ2VkKG9sZFRhcmdldCk7CiAgICAgIH0KICAgICAgdmFyIGN1cnNvciA9IG9iamVjdC5kZWxlZ2F0ZXNfOwogICAgICB3aGlsZSAoY3Vyc29yKSB7CiAgICAgICAgaWYgKGN1cnNvci5kZWxlZ2F0ZSkgYXBwbHlEZWxlZ2F0ZUNoYW5nZXMoY3Vyc29yLmRlbGVnYXRlLCBvbGRSb290LCBvbGRUYXJnZXQpOwogICAgICAgIGN1cnNvciA9IGN1cnNvci5uZXh0OwogICAgICB9CiAgICB9CiAgICB2YXIgRGF0YU9iamVjdCA9IENsYXNzKEFic3RyYWN0RGF0YSwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuT2JqZWN0IiwKICAgICAgc3Vic2NyaWJlVG86IFNVQlNDUklQVElPTi5ERUxFR0FURSArIFNVQlNDUklQVElPTi5UQVJHRVQsCiAgICAgIGRhdGE6IG51bGwsCiAgICAgIGVtaXRfdXBkYXRlOiBjcmVhdGVFdmVudCgidXBkYXRlIiwgImRlbHRhIikgJiYgZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpcy5kZWxlZ2F0ZXNfOwogICAgICAgIGV2ZW50cy51cGRhdGUuY2FsbCh0aGlzLCBkZWx0YSk7CiAgICAgICAgd2hpbGUgKGN1cnNvcikgewogICAgICAgICAgaWYgKGN1cnNvci5kZWxlZ2F0ZSkgY3Vyc29yLmRlbGVnYXRlLmVtaXRfdXBkYXRlKGRlbHRhKTsKICAgICAgICAgIGN1cnNvciA9IGN1cnNvci5uZXh0OwogICAgICAgIH0KICAgICAgfSwKICAgICAgZW1pdF9zdGF0ZUNoYW5nZWQ6IGZ1bmN0aW9uKG9sZFN0YXRlKSB7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXMuZGVsZWdhdGVzXzsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLmVtaXRfc3RhdGVDaGFuZ2VkLmNhbGwodGhpcywgb2xkU3RhdGUpOwogICAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICAgIGlmIChjdXJzb3IuZGVsZWdhdGUpIHsKICAgICAgICAgICAgY3Vyc29yLmRlbGVnYXRlLnN0YXRlID0gdGhpcy5zdGF0ZTsKICAgICAgICAgICAgY3Vyc29yLmRlbGVnYXRlLmVtaXRfc3RhdGVDaGFuZ2VkKG9sZFN0YXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnNvciA9IGN1cnNvci5uZXh0OwogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVsZWdhdGU6IG51bGwsCiAgICAgIGRlbGVnYXRlQWRhcHRlcl86IG51bGwsCiAgICAgIGRlbGVnYXRlc186IG51bGwsCiAgICAgIGRlYnVnX2RlbGVnYXRlczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXMuZGVsZWdhdGVzXzsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgd2hpbGUgKGN1cnNvcikgewogICAgICAgICAgcmVzdWx0LnB1c2goY3Vyc29yLmRlbGVnYXRlKTsKICAgICAgICAgIGN1cnNvciA9IGN1cnNvci5uZXh0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9LAogICAgICBlbWl0X2RlbGVnYXRlQ2hhbmdlZDogY3JlYXRlRXZlbnQoImRlbGVnYXRlQ2hhbmdlZCIsICJvbGREZWxlZ2F0ZSIpLAogICAgICB0YXJnZXQ6IG51bGwsCiAgICAgIGVtaXRfdGFyZ2V0Q2hhbmdlZDogY3JlYXRlRXZlbnQoInRhcmdldENoYW5nZWQiLCAib2xkVGFyZ2V0IiksCiAgICAgIHJvb3Q6IG51bGwsCiAgICAgIGVtaXRfcm9vdENoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJyb290Q2hhbmdlZCIsICJvbGRSb290IiksCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucm9vdCA9IHRoaXM7CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIGRlbGVnYXRlID0gdGhpcy5kZWxlZ2F0ZTsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTsKICAgICAgICBpZiAoZGVsZWdhdGUpIHsKICAgICAgICAgIHRoaXMuZGVsZWdhdGUgPSBudWxsOwogICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgdGhpcy5kYXRhID0gSU5JVF9EQVRBOwogICAgICAgICAgdGhpcy5zZXREZWxlZ2F0ZShkZWxlZ2F0ZSk7CiAgICAgICAgICBpZiAodGhpcy5kYXRhID09PSBJTklUX0RBVEEpIHRoaXMuZGF0YSA9IGRhdGEgfHwge307CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghZGF0YSkgdGhpcy5kYXRhID0ge307CiAgICAgICAgICBpZiAodGhpcy50YXJnZXQgIT09IG51bGwpIHRoaXMudGFyZ2V0ID0gdGhpczsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFN5bmNBY3Rpb246IGZ1bmN0aW9uKHN5bmNBY3Rpb24pIHsKICAgICAgICBpZiAoc3luY0FjdGlvbiAmJiB0aGlzLmRlbGVnYXRlKSBiYXNpcy5kZXYud2Fybih0aGlzLmNvbnN0cnVjdG9yLnN5bmNBY3Rpb24gKyAiIGluc3RhbmNlIGhhcyBhIGRlbGVnYXRlIGFuZCBzeW5jQWN0aW9uIC0gaXQgbWF5IHByb2R1Y2UgY29uZmxpY3Mgd2l0aCBkYXRhICYgc3RhdGUiKTsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLnNldFN5bmNBY3Rpb24uY2FsbCh0aGlzLCBzeW5jQWN0aW9uKTsKICAgICAgfSwKICAgICAgc2V0RGVsZWdhdGU6IGZ1bmN0aW9uKG5ld0RlbGVnYXRlKSB7CiAgICAgICAgbmV3RGVsZWdhdGUgPSByZXNvbHZlT2JqZWN0KHRoaXMsIHRoaXMuc2V0RGVsZWdhdGUsIG5ld0RlbGVnYXRlLCAiZGVsZWdhdGVBZGFwdGVyXyIpOwogICAgICAgIGlmIChuZXdEZWxlZ2F0ZSAmJiBuZXdEZWxlZ2F0ZSBpbnN0YW5jZW9mIERhdGFPYmplY3QpIHsKICAgICAgICAgIGlmIChuZXdEZWxlZ2F0ZS5kZWxlZ2F0ZSAmJiBpc0Nvbm5lY3RlZCh0aGlzLCBuZXdEZWxlZ2F0ZSkpIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIk5ldyBkZWxlZ2F0ZSBoYXMgYWxyZWFkeSBjb25uZWN0ZWQgdG8gb2JqZWN0LiBEZWxlZ2F0ZSBhc3NpZ25tZW50IGhhcyBiZWVuIGlnbm9yZWQuIiwgdGhpcywgbmV3RGVsZWdhdGUpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5ld0RlbGVnYXRlID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuZGVsZWdhdGUgIT09IG5ld0RlbGVnYXRlKSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSB0aGlzLnN0YXRlOwogICAgICAgICAgdmFyIG9sZERhdGEgPSB0aGlzLmRhdGE7CiAgICAgICAgICB2YXIgb2xkRGVsZWdhdGUgPSB0aGlzLmRlbGVnYXRlOwogICAgICAgICAgdmFyIG9sZFRhcmdldCA9IHRoaXMudGFyZ2V0OwogICAgICAgICAgdmFyIG9sZFJvb3QgPSB0aGlzLnJvb3Q7CiAgICAgICAgICB2YXIgZGVsZWdhdGVMaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4uZGVsZWdhdGU7CiAgICAgICAgICB2YXIgZGF0YUNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgIHZhciBkZWx0YTsKICAgICAgICAgIGlmIChvbGREZWxlZ2F0ZSkgewogICAgICAgICAgICBpZiAoZGVsZWdhdGVMaXN0ZW5IYW5kbGVyKSBvbGREZWxlZ2F0ZS5yZW1vdmVIYW5kbGVyKGRlbGVnYXRlTGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgIHZhciBjdXJzb3IgPSBvbGREZWxlZ2F0ZS5kZWxlZ2F0ZXNfOwogICAgICAgICAgICB2YXIgcHJldiA9IG9sZERlbGVnYXRlOwogICAgICAgICAgICB3aGlsZSAoY3Vyc29yKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnNvci5kZWxlZ2F0ZSA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgY3Vyc29yLmRlbGVnYXRlID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChwcmV2ID09PSBvbGREZWxlZ2F0ZSkgb2xkRGVsZWdhdGUuZGVsZWdhdGVzXyA9IGN1cnNvci5uZXh0OyBlbHNlIHByZXYubmV4dCA9IGN1cnNvci5uZXh0OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXYgPSBjdXJzb3I7CiAgICAgICAgICAgICAgY3Vyc29yID0gY3Vyc29yLm5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXdEZWxlZ2F0ZSkgewogICAgICAgICAgICB0aGlzLmRlbGVnYXRlID0gbmV3RGVsZWdhdGU7CiAgICAgICAgICAgIGlmIChkZWxlZ2F0ZUxpc3RlbkhhbmRsZXIpIG5ld0RlbGVnYXRlLmFkZEhhbmRsZXIoZGVsZWdhdGVMaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgbmV3RGVsZWdhdGUuZGVsZWdhdGVzXyA9IHsKICAgICAgICAgICAgICBkZWxlZ2F0ZTogdGhpcywKICAgICAgICAgICAgICBuZXh0OiBuZXdEZWxlZ2F0ZS5kZWxlZ2F0ZXNfCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh0aGlzLmRhdGEgIT09IElOSVRfREFUQSkgewogICAgICAgICAgICAgIGRlbHRhID0ge307CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG5ld0RlbGVnYXRlLmRhdGEpIGlmIChrZXkgaW4gb2xkRGF0YSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGRhdGFDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGRlbHRhW2tleV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvbGREYXRhKSBpZiAob2xkRGF0YVtrZXldICE9PSBuZXdEZWxlZ2F0ZS5kYXRhW2tleV0pIHsKICAgICAgICAgICAgICAgIGRhdGFDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGRlbHRhW2tleV0gPSBvbGREYXRhW2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmRlbGVnYXRlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgICB0aGlzLnJvb3QgPSB0aGlzOwogICAgICAgICAgICB0aGlzLmRhdGEgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG9sZERhdGEpIHRoaXMuZGF0YVtrZXldID0gb2xkRGF0YVtrZXldOwogICAgICAgICAgfQogICAgICAgICAgYXBwbHlEZWxlZ2F0ZUNoYW5nZXModGhpcywgb2xkUm9vdCwgb2xkVGFyZ2V0KTsKICAgICAgICAgIGlmIChkYXRhQ2hhbmdlZCkgdGhpcy5lbWl0X3VwZGF0ZShkZWx0YSk7CiAgICAgICAgICBpZiAoZGVsdGEgJiYgb2xkU3RhdGUgIT09IHRoaXMuc3RhdGUgJiYgKFN0cmluZyhvbGRTdGF0ZSkgIT0gdGhpcy5zdGF0ZSB8fCBvbGRTdGF0ZS5kYXRhICE9PSB0aGlzLnN0YXRlLmRhdGEpKSB0aGlzLmVtaXRfc3RhdGVDaGFuZ2VkKG9sZFN0YXRlKTsKICAgICAgICAgIHRoaXMuZW1pdF9kZWxlZ2F0ZUNoYW5nZWQob2xkRGVsZWdhdGUpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgc2V0U3RhdGU6IGZ1bmN0aW9uKHN0YXRlLCBkYXRhKSB7CiAgICAgICAgaWYgKHRoaXMuZGVsZWdhdGUpIHJldHVybiB0aGlzLnJvb3Quc2V0U3RhdGUoc3RhdGUsIGRhdGEpOyBlbHNlIHJldHVybiBBYnN0cmFjdERhdGEucHJvdG90eXBlLnNldFN0YXRlLmNhbGwodGhpcywgc3RhdGUsIGRhdGEpOwogICAgICB9LAogICAgICB1cGRhdGU6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICBpZiAodGhpcy5kZWxlZ2F0ZSkgcmV0dXJuIHRoaXMucm9vdC51cGRhdGUoZGF0YSk7CiAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgIHZhciBkZWx0YSA9IHt9OwogICAgICAgICAgdmFyIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gZGF0YSkgaWYgKHRoaXMuZGF0YVtwcm9wXSAhPT0gZGF0YVtwcm9wXSkgewogICAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgZGVsdGFbcHJvcF0gPSB0aGlzLmRhdGFbcHJvcF07CiAgICAgICAgICAgIHRoaXMuZGF0YVtwcm9wXSA9IGRhdGFbcHJvcF07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2hhbmdlZCkgewogICAgICAgICAgICB0aGlzLmVtaXRfdXBkYXRlKGRlbHRhKTsKICAgICAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIEFic3RyYWN0RGF0YS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzLmRlbGVnYXRlc187CiAgICAgICAgdGhpcy5kZWxlZ2F0ZXNfID0gbnVsbDsKICAgICAgICB3aGlsZSAoY3Vyc29yKSB7CiAgICAgICAgICBjdXJzb3IuZGVsZWdhdGUuc2V0RGVsZWdhdGUoKTsKICAgICAgICAgIGN1cnNvciA9IGN1cnNvci5uZXh0OwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5kZWxlZ2F0ZSkgdGhpcy5zZXREZWxlZ2F0ZSgpOwogICAgICAgIHRoaXMuZGF0YSA9IE5VTExfT0JKRUNUOwogICAgICAgIHRoaXMucm9vdCA9IG51bGw7CiAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBTbG90ID0gQ2xhc3MoRGF0YU9iamVjdCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU2xvdCIKICAgIH0pOwogICAgdmFyIEtFWU9CSkVDVE1BUF9NRU1CRVJfSEFORExFUiA9IHsKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgZGVsZXRlIHRoaXMubWFwW3RoaXMuaWRdOwogICAgICB9CiAgICB9OwogICAgdmFyIEtleU9iamVjdE1hcCA9IENsYXNzKEFic3RyYWN0RGF0YSwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuS2V5T2JqZWN0TWFwIiwKICAgICAgaXRlbUNsYXNzOiBEYXRhT2JqZWN0LAogICAgICBrZXlHZXR0ZXI6ICRzZWxmLAogICAgICBhdXRvRGVzdHJveU1lbWJlcnM6IHRydWUsCiAgICAgIG1hcF86IG51bGwsCiAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogdHJ1ZSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5tYXBfID0ge307CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCh0aGlzLmtleUdldHRlcihvYmplY3QpLCBvYmplY3QpOwogICAgICB9LAogICAgICBjcmVhdGU6IGZ1bmN0aW9uKGtleSwgb2JqZWN0KSB7CiAgICAgICAgdmFyIGl0ZW1Db25maWc7CiAgICAgICAgaWYgKGtleSBpbnN0YW5jZW9mIERhdGFPYmplY3QpIGl0ZW1Db25maWcgPSB7CiAgICAgICAgICBkZWxlZ2F0ZToga2V5CiAgICAgICAgfTsgZWxzZSBpdGVtQ29uZmlnID0gewogICAgICAgICAgZGF0YTogewogICAgICAgICAgICBpZDoga2V5LAogICAgICAgICAgICB0aXRsZToga2V5CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gbmV3IHRoaXMuaXRlbUNsYXNzKGl0ZW1Db25maWcpOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgYXV0b2NyZWF0ZSkgewogICAgICAgIHZhciBpdGVtSWQgPSBrZXkgaW5zdGFuY2VvZiBEYXRhT2JqZWN0ID8ga2V5LmJhc2lzT2JqZWN0SWQgOiBrZXk7CiAgICAgICAgdmFyIGl0ZW1JbmZvID0gdGhpcy5tYXBfW2l0ZW1JZF07CiAgICAgICAgaWYgKCFpdGVtSW5mbyAmJiBhdXRvY3JlYXRlKSB7CiAgICAgICAgICBpdGVtSW5mbyA9IHRoaXMubWFwX1tpdGVtSWRdID0gewogICAgICAgICAgICBtYXA6IHRoaXMubWFwXywKICAgICAgICAgICAgaWQ6IGl0ZW1JZCwKICAgICAgICAgICAgaXRlbTogdGhpcy5jcmVhdGUoa2V5LCBhdXRvY3JlYXRlKQogICAgICAgICAgfTsKICAgICAgICAgIGl0ZW1JbmZvLml0ZW0uYWRkSGFuZGxlcihLRVlPQkpFQ1RNQVBfTUVNQkVSX0hBTkRMRVIsIGl0ZW1JbmZvKTsKICAgICAgICB9CiAgICAgICAgaWYgKGl0ZW1JbmZvKSByZXR1cm4gaXRlbUluZm8uaXRlbTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIG1hcCA9IHRoaXMubWFwXzsKICAgICAgICB0aGlzLm1hcF8gPSBudWxsOwogICAgICAgIGZvciAodmFyIGl0ZW1JZCBpbiBtYXApIHsKICAgICAgICAgIHZhciBpdGVtSW5mbyA9IG1hcFtpdGVtSWRdOwogICAgICAgICAgaWYgKHRoaXMuYXV0b0Rlc3Ryb3lNZW1iZXJzKSBpdGVtSW5mby5pdGVtLmRlc3Ryb3koKTsgZWxzZSBpdGVtSW5mby5pdGVtLnJlbW92ZUhhbmRsZXIoS0VZT0JKRUNUTUFQX01FTUJFUl9IQU5ETEVSLCBpdGVtSW5mbyk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSB7CiAgICAgIHZhciBkZWx0YSA9IHt9OwogICAgICB2YXIgcmVzdWx0OwogICAgICBpZiAoaW5zZXJ0ZWQgJiYgaW5zZXJ0ZWQubGVuZ3RoKSByZXN1bHQgPSBkZWx0YS5pbnNlcnRlZCA9IGluc2VydGVkOwogICAgICBpZiAoZGVsZXRlZCAmJiBkZWxldGVkLmxlbmd0aCkgcmVzdWx0ID0gZGVsdGEuZGVsZXRlZCA9IGRlbGV0ZWQ7CiAgICAgIGlmIChyZXN1bHQpIHJldHVybiBkZWx0YTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldERhdGFzZXREZWx0YShhLCBiKSB7CiAgICAgIGlmICghYSB8fCAhYS5pdGVtQ291bnQpIHsKICAgICAgICBpZiAoYiAmJiBiLml0ZW1Db3VudCkgcmV0dXJuIHsKICAgICAgICAgIGluc2VydGVkOiBiLmdldEl0ZW1zKCkKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghYiB8fCAhYi5pdGVtQ291bnQpIHsKICAgICAgICAgIGlmIChhLml0ZW1Db3VudCkgcmV0dXJuIHsKICAgICAgICAgICAgZGVsZXRlZDogYS5nZXRJdGVtcygpCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gYS5pdGVtc18pIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBhLml0ZW1zX1trZXldOwogICAgICAgICAgICBpZiAoaXRlbS5iYXNpc09iamVjdElkIGluIGIuaXRlbXNfID09IGZhbHNlKSBkZWxldGVkLnB1c2goaXRlbSk7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gYi5pdGVtc18pIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBiLml0ZW1zX1trZXldOwogICAgICAgICAgICBpZiAoaXRlbS5iYXNpc09iamVjdElkIGluIGEuaXRlbXNfID09IGZhbHNlKSBpbnNlcnRlZC5wdXNoKGl0ZW0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHZhciBEYXRhc2V0V3JhcHBlciA9IENsYXNzKERhdGFPYmplY3QsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkRhdGFzZXRXcmFwcGVyIiwKICAgICAgc3Vic2NyaWJlVG86IERhdGFPYmplY3QucHJvdG90eXBlLnN1YnNjcmliZVRvICsgU1VCU0NSSVBUSU9OLkRBVEFTRVQsCiAgICAgIGxpc3RlbjogewogICAgICAgIGRhdGFzZXQ6IHsKICAgICAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24oZGF0YXNldCwgZGVsdGEpIHsKICAgICAgICAgICAgdGhpcy5pdGVtQ291bnQgPSBkYXRhc2V0Lml0ZW1Db3VudDsKICAgICAgICAgICAgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuc2V0RGF0YXNldCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgZGF0YXNldDogbnVsbCwKICAgICAgZGF0YXNldEFkYXB0ZXJfOiBudWxsLAogICAgICBlbWl0X2RhdGFzZXRDaGFuZ2VkOiBjcmVhdGVFdmVudCgiZGF0YXNldENoYW5nZWQiLCAib2xkRGF0YXNldCIpLAogICAgICBlbWl0X2l0ZW1zQ2hhbmdlZDogY3JlYXRlRXZlbnQoIml0ZW1zQ2hhbmdlZCIsICJkZWx0YSIpLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIGRhdGFzZXQgPSB0aGlzLmRhdGFzZXQ7CiAgICAgICAgaWYgKGRhdGFzZXQpIHsKICAgICAgICAgIHRoaXMuZGF0YXNldCA9IG51bGw7CiAgICAgICAgICB0aGlzLnNldERhdGFzZXQoZGF0YXNldCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXREYXRhc2V0OiBmdW5jdGlvbihkYXRhc2V0KSB7CiAgICAgICAgZGF0YXNldCA9IHJlc29sdmVEYXRhc2V0KHRoaXMsIHRoaXMuc2V0RGF0YXNldCwgZGF0YXNldCwgImRhdGFzZXRBZGFwdGVyXyIpOwogICAgICAgIGlmICh0aGlzLmRhdGFzZXQgIT09IGRhdGFzZXQpIHsKICAgICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4uZGF0YXNldDsKICAgICAgICAgIHZhciBvbGREYXRhc2V0ID0gdGhpcy5kYXRhc2V0OwogICAgICAgICAgdmFyIGRlbHRhOwogICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgICAgaWYgKG9sZERhdGFzZXQpIG9sZERhdGFzZXQucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgaWYgKGRhdGFzZXQpIGRhdGFzZXQuYWRkSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuaXRlbUNvdW50ID0gZGF0YXNldCA/IGRhdGFzZXQuaXRlbUNvdW50IDogMDsKICAgICAgICAgIGlmIChkZWx0YSA9IGdldERhdGFzZXREZWx0YShvbGREYXRhc2V0LCBkYXRhc2V0KSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgICB0aGlzLmRhdGFzZXQgPSBkYXRhc2V0OwogICAgICAgICAgdGhpcy5lbWl0X2RhdGFzZXRDaGFuZ2VkKG9sZERhdGFzZXQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgaGFzOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0ID8gdGhpcy5kYXRhc2V0LmhhcyhvYmplY3QpIDogbnVsbDsKICAgICAgfSwKICAgICAgZ2V0SXRlbXM6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmRhdGFzZXQgPyB0aGlzLmRhdGFzZXQuZ2V0SXRlbXMoKSA6IFtdOwogICAgICB9LAogICAgICBwaWNrOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0ID8gdGhpcy5kYXRhc2V0LnBpY2soKSA6IG51bGw7CiAgICAgIH0sCiAgICAgIHRvcDogZnVuY3Rpb24oY291bnQpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0ID8gdGhpcy5kYXRhc2V0LnRvcChjb3VudCkgOiBbXTsKICAgICAgfSwKICAgICAgZm9yRWFjaDogZnVuY3Rpb24oZm4pIHsKICAgICAgICBpZiAodGhpcy5kYXRhc2V0KSByZXR1cm4gdGhpcy5kYXRhc2V0LmZvckVhY2goZm4pOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5kYXRhc2V0IHx8IHRoaXMuZGF0YXNldEFkYXB0ZXJfKSB0aGlzLnNldERhdGFzZXQoKTsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFJlYWRPbmx5RGF0YXNldCA9IENsYXNzKEFic3RyYWN0RGF0YSwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuUmVhZE9ubHlEYXRhc2V0IiwKICAgICAgaXRlbUNvdW50OiAwLAogICAgICBpdGVtc186IG51bGwsCiAgICAgIG1lbWJlcnNfOiBudWxsLAogICAgICBjYWNoZV86IG51bGwsCiAgICAgIGVtaXRfaXRlbXNDaGFuZ2VkOiBjcmVhdGVFdmVudCgiaXRlbXNDaGFuZ2VkIiwgImRlbHRhIikgJiYgZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICB2YXIgaXRlbXM7CiAgICAgICAgdmFyIGluc2VydENvdW50ID0gMDsKICAgICAgICB2YXIgZGVsZXRlQ291bnQgPSAwOwogICAgICAgIHZhciBvYmplY3Q7CiAgICAgICAgaWYgKGl0ZW1zID0gZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIHdoaWxlIChvYmplY3QgPSBpdGVtc1tpbnNlcnRDb3VudF0pIHsKICAgICAgICAgICAgdGhpcy5pdGVtc19bb2JqZWN0LmJhc2lzT2JqZWN0SWRdID0gb2JqZWN0OwogICAgICAgICAgICBpbnNlcnRDb3VudCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXRlbXMgPSBkZWx0YS5kZWxldGVkKSB7CiAgICAgICAgICB3aGlsZSAob2JqZWN0ID0gaXRlbXNbZGVsZXRlQ291bnRdKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLml0ZW1zX1tvYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgICAgICAgIGRlbGV0ZUNvdW50Kys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuaXRlbUNvdW50ICs9IGluc2VydENvdW50IC0gZGVsZXRlQ291bnQ7CiAgICAgICAgdGhpcy5jYWNoZV8gPSBpbnNlcnRDb3VudCA9PSB0aGlzLml0ZW1Db3VudCA/IGRlbHRhLmluc2VydGVkIDogbnVsbDsKICAgICAgICBldmVudHMuaXRlbXNDaGFuZ2VkLmNhbGwodGhpcywgZGVsdGEpOwogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLm1lbWJlcnNfID0ge307CiAgICAgICAgdGhpcy5pdGVtc18gPSB7fTsKICAgICAgfSwKICAgICAgaGFzOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gISEob2JqZWN0ICYmIHRoaXMuaXRlbXNfW29iamVjdC5iYXNpc09iamVjdElkXSk7CiAgICAgIH0sCiAgICAgIGdldEl0ZW1zOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuY2FjaGVfKSB0aGlzLmNhY2hlXyA9IHZhbHVlcyh0aGlzLml0ZW1zXyk7CiAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGVfOwogICAgICB9LAogICAgICBnZXRWYWx1ZXM6IGZ1bmN0aW9uKGdldHRlcikgewogICAgICAgIHJldHVybiB0aGlzLmdldEl0ZW1zKCkubWFwKGJhc2lzLmdldHRlcihnZXR0ZXIgfHwgJHNlbGYpKTsKICAgICAgfSwKICAgICAgcGljazogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgb2JqZWN0SWQgaW4gdGhpcy5pdGVtc18pIHJldHVybiB0aGlzLml0ZW1zX1tvYmplY3RJZF07CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCiAgICAgIHRvcDogZnVuY3Rpb24oY291bnQpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgaWYgKGNvdW50KSBmb3IgKHZhciBvYmplY3RJZCBpbiB0aGlzLml0ZW1zXykgaWYgKHJlc3VsdC5wdXNoKHRoaXMuaXRlbXNfW29iamVjdElkXSkgPj0gY291bnQpIGJyZWFrOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0sCiAgICAgIGZvckVhY2g6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgdmFyIGl0ZW1zID0gdGhpcy5nZXRJdGVtcygpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIGZuKGl0ZW1zW2ldKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5jYWNoZV8gPSBFTVBUWV9BUlJBWTsKICAgICAgICB0aGlzLml0ZW1Db3VudCA9IDA7CiAgICAgICAgdGhpcy5tZW1iZXJzXyA9IG51bGw7CiAgICAgICAgdGhpcy5pdGVtc18gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBEYXRhc2V0ID0gQ2xhc3MoUmVhZE9ubHlEYXRhc2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5EYXRhc2V0IiwKICAgICAgbGlzdGVuOiB7CiAgICAgICAgaXRlbTogewogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlKFsgb2JqZWN0IF0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgUmVhZE9ubHlEYXRhc2V0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIGl0ZW1zID0gdGhpcy5pdGVtczsKICAgICAgICBpZiAoaXRlbXMpIHsKICAgICAgICAgIHRoaXMuaXRlbXMgPSBudWxsOwogICAgICAgICAgdGhpcy5zZXQoaXRlbXMpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYWRkOiBmdW5jdGlvbihpdGVtcykgewogICAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4uaXRlbTsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICB2YXIgZGVsdGE7CiAgICAgICAgaWYgKGl0ZW1zICYmICFBcnJheS5pc0FycmF5KGl0ZW1zKSkgaXRlbXMgPSBbIGl0ZW1zIF07CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIG9iamVjdCA9IGl0ZW1zW2ldOwogICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mIERhdGFPYmplY3QpIHsKICAgICAgICAgICAgdmFyIG9iamVjdElkID0gb2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgIGlmICghbWVtYmVyTWFwW29iamVjdElkXSkgewogICAgICAgICAgICAgIG1lbWJlck1hcFtvYmplY3RJZF0gPSBvYmplY3Q7CiAgICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIG9iamVjdC5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICAgIGluc2VydGVkLnB1c2gob2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIldyb25nIGRhdGEgdHlwZTogdmFsdWUgc2hvdWxkIGJlIGFuIGluc3RhbmNlIG9mIGJhc2lzLmRhdGEuT2JqZWN0Iik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpbnNlcnRlZC5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEgPSB7CiAgICAgICAgICAgIGluc2VydGVkOiBpbnNlcnRlZAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgfSwKICAgICAgcmVtb3ZlOiBmdW5jdGlvbihpdGVtcykgewogICAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4uaXRlbTsKICAgICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICAgIHZhciBkZWx0YTsKICAgICAgICBpZiAoaXRlbXMgJiYgIUFycmF5LmlzQXJyYXkoaXRlbXMpKSBpdGVtcyA9IFsgaXRlbXMgXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgb2JqZWN0ID0gaXRlbXNbaV07CiAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgRGF0YU9iamVjdCkgewogICAgICAgICAgICB2YXIgb2JqZWN0SWQgPSBvYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgaWYgKG1lbWJlck1hcFtvYmplY3RJZF0pIHsKICAgICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgb2JqZWN0LnJlbW92ZUhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICAgICAgZGVsZXRlZC5wdXNoKG9iamVjdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJXcm9uZyBkYXRhIHR5cGU6IHZhbHVlIHNob3VsZCBiZSBhbiBpbnN0YW5jZSBvZiBiYXNpcy5kYXRhLk9iamVjdCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsZXRlZC5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEgPSB7CiAgICAgICAgICAgIGRlbGV0ZWQ6IGRlbGV0ZWQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24oaXRlbXMpIHsKICAgICAgICBpZiAoIXRoaXMuaXRlbUNvdW50KSByZXR1cm4gdGhpcy5hZGQoaXRlbXMpOwogICAgICAgIGlmICghaXRlbXMgfHwgIWl0ZW1zLmxlbmd0aCkgcmV0dXJuIHRoaXMuY2xlYXIoKTsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLml0ZW07CiAgICAgICAgdmFyIGV4aXN0cyA9IHt9OwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIG9iamVjdDsKICAgICAgICB2YXIgb2JqZWN0SWQ7CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG9iamVjdCA9IGl0ZW1zW2ldOwogICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mIERhdGFPYmplY3QpIHsKICAgICAgICAgICAgb2JqZWN0SWQgPSBvYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgZXhpc3RzW29iamVjdElkXSA9IG9iamVjdDsKICAgICAgICAgICAgaWYgKCFtZW1iZXJNYXBbb2JqZWN0SWRdKSB7CiAgICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXSA9IG9iamVjdDsKICAgICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgb2JqZWN0LmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChvYmplY3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBiYXNpcy5kZXYud2FybigiV3JvbmcgZGF0YSB0eXBlOiB2YWx1ZSBzaG91bGQgYmUgYW4gaW5zdGFuY2Ugb2YgYmFzaXMuZGF0YS5PYmplY3QiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgb2JqZWN0SWQgaW4gbWVtYmVyTWFwKSB7CiAgICAgICAgICBpZiAoIWV4aXN0c1tvYmplY3RJZF0pIHsKICAgICAgICAgICAgb2JqZWN0ID0gbWVtYmVyTWFwW29iamVjdElkXTsKICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIG9iamVjdC5yZW1vdmVIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICBkZWxldGUgbWVtYmVyTWFwW29iamVjdElkXTsKICAgICAgICAgICAgZGVsZXRlZC5wdXNoKG9iamVjdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICB9LAogICAgICBzeW5jOiBmdW5jdGlvbihpdGVtcykgewogICAgICAgIHZhciBkZWx0YSA9IHRoaXMuc2V0KGl0ZW1zKSB8fCB7fTsKICAgICAgICB2YXIgZGVsZXRlZCA9IGRlbHRhLmRlbGV0ZWQ7CiAgICAgICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUodHJ1ZSk7CiAgICAgICAgaWYgKGRlbGV0ZWQpIGZvciAodmFyIGkgPSAwLCBvYmplY3Q7IG9iamVjdCA9IGRlbGV0ZWRbaV07IGkrKykgb2JqZWN0LmRlc3Ryb3koKTsKICAgICAgICBEYXRhc2V0LnNldEFjY3VtdWxhdGVTdGF0ZShmYWxzZSk7CiAgICAgICAgcmV0dXJuIGRlbHRhLmluc2VydGVkOwogICAgICB9LAogICAgICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGRlbGV0ZWQgPSB0aGlzLmdldEl0ZW1zKCk7CiAgICAgICAgdmFyIGxpc3RlbkhhbmRsZXIgPSB0aGlzLmxpc3Rlbi5pdGVtOwogICAgICAgIHZhciBkZWx0YTsKICAgICAgICBpZiAoZGVsZXRlZC5sZW5ndGgpIHsKICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSBmb3IgKHZhciBpID0gMDsgaSA8IGRlbGV0ZWQubGVuZ3RoOyBpKyspIGRlbGV0ZWRbaV0ucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEgPSB7CiAgICAgICAgICAgIGRlbGV0ZWQ6IGRlbGV0ZWQKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5tZW1iZXJzXyA9IHt9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICBSZWFkT25seURhdGFzZXQucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgUmVzb2x2ZUFkYXB0ZXIgPSBmdW5jdGlvbihjb250ZXh0LCBmbiwgc291cmNlLCBoYW5kbGVyKSB7CiAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgIHRoaXMuZm4gPSBmbjsKICAgICAgdGhpcy5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRoaXMuaGFuZGxlciA9IGhhbmRsZXI7CiAgICB9OwogICAgUmVzb2x2ZUFkYXB0ZXIucHJvdG90eXBlID0gewogICAgICBjb250ZXh0OiBudWxsLAogICAgICBmbjogbnVsbCwKICAgICAgc291cmNlOiBudWxsLAogICAgICBoYW5kbGVyOiBudWxsLAogICAgICBuZXh0OiBudWxsLAogICAgICBhdHRhY2g6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc291cmNlLmFkZEhhbmRsZXIodGhpcy5oYW5kbGVyLCB0aGlzKTsKICAgICAgfSwKICAgICAgZGV0YWNoOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNvdXJjZS5yZW1vdmVIYW5kbGVyKHRoaXMuaGFuZGxlciwgdGhpcyk7CiAgICAgIH0sCiAgICAgIHByb3h5OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmZuLmNhbGwodGhpcy5jb250ZXh0LCB0aGlzLnNvdXJjZSk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgQkJSZXNvbHZlQWRhcHRlciA9IGZ1bmN0aW9uKCkgewogICAgICBSZXNvbHZlQWRhcHRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICAgIEJCUmVzb2x2ZUFkYXB0ZXIucHJvdG90eXBlID0gbmV3IFJlc29sdmVBZGFwdGVyOwogICAgQkJSZXNvbHZlQWRhcHRlci5wcm90b3R5cGUuYXR0YWNoID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc291cmNlLmJpbmRpbmdCcmlkZ2UuYXR0YWNoKHRoaXMuc291cmNlLCB0aGlzLmhhbmRsZXIsIHRoaXMpOwogICAgfTsKICAgIEJCUmVzb2x2ZUFkYXB0ZXIucHJvdG90eXBlLmRldGFjaCA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnNvdXJjZS5iaW5kaW5nQnJpZGdlLmRldGFjaCh0aGlzLnNvdXJjZSwgdGhpcy5oYW5kbGVyLCB0aGlzKTsKICAgIH07CiAgICB2YXIgVE9LRU5fQURBUFRFUl9IQU5ETEVSID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuZm4uY2FsbCh0aGlzLmNvbnRleHQsIHRoaXMuc291cmNlKTsKICAgIH07CiAgICB2YXIgREFUQVNFVFdSQVBQRVJfQURBUFRFUl9IQU5ETEVSID0gewogICAgICBkYXRhc2V0Q2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5mbi5jYWxsKHRoaXMuY29udGV4dCwgdGhpcy5zb3VyY2UpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmZuLmNhbGwodGhpcy5jb250ZXh0LCBudWxsKTsKICAgICAgfQogICAgfTsKICAgIHZhciBWQUxVRV9BREFQVEVSX0hBTkRMRVIgPSB7CiAgICAgIGNoYW5nZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5mbi5jYWxsKHRoaXMuY29udGV4dCwgdGhpcy5zb3VyY2UpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmZuLmNhbGwodGhpcy5jb250ZXh0LCBudWxsKTsKICAgICAgfQogICAgfTsKICAgIGZ1bmN0aW9uIHJlc29sdmVEYXRhc2V0KGNvbnRleHQsIGZuLCBzb3VyY2UsIHByb3BlcnR5KSB7CiAgICAgIHZhciBvbGRBZGFwdGVyID0gY29udGV4dFtwcm9wZXJ0eV0gfHwgbnVsbDsKICAgICAgdmFyIG5ld0FkYXB0ZXIgPSBudWxsOwogICAgICBpZiAodHlwZW9mIHNvdXJjZSA9PSAiZnVuY3Rpb24iKSBzb3VyY2UgPSBzb3VyY2UuY2FsbChjb250ZXh0LCBjb250ZXh0KTsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBEYXRhc2V0V3JhcHBlcikgewogICAgICAgICAgbmV3QWRhcHRlciA9IG5ldyBSZXNvbHZlQWRhcHRlcihjb250ZXh0LCBmbiwgc291cmNlLCBEQVRBU0VUV1JBUFBFUl9BREFQVEVSX0hBTkRMRVIpOwogICAgICAgICAgc291cmNlID0gc291cmNlLmRhdGFzZXQ7CiAgICAgICAgfSBlbHNlIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBWYWx1ZSkgewogICAgICAgICAgbmV3QWRhcHRlciA9IG5ldyBSZXNvbHZlQWRhcHRlcihjb250ZXh0LCBmbiwgc291cmNlLCBWQUxVRV9BREFQVEVSX0hBTkRMRVIpOwogICAgICAgICAgc291cmNlID0gcmVzb2x2ZURhdGFzZXQobmV3QWRhcHRlciwgbmV3QWRhcHRlci5wcm94eSwgc291cmNlLnZhbHVlLCAibmV4dCIpOwogICAgICAgIH0gZWxzZSBpZiAoc291cmNlLmJpbmRpbmdCcmlkZ2UpIHsKICAgICAgICAgIG5ld0FkYXB0ZXIgPSBuZXcgQkJSZXNvbHZlQWRhcHRlcihjb250ZXh0LCBmbiwgc291cmNlLCBUT0tFTl9BREFQVEVSX0hBTkRMRVIpOwogICAgICAgICAgc291cmNlID0gcmVzb2x2ZURhdGFzZXQobmV3QWRhcHRlciwgbmV3QWRhcHRlci5wcm94eSwgc291cmNlLnZhbHVlLCAibmV4dCIpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgUmVhZE9ubHlEYXRhc2V0ID09IGZhbHNlKSBzb3VyY2UgPSBudWxsOwogICAgICBpZiAocHJvcGVydHkgJiYgb2xkQWRhcHRlciAhPT0gbmV3QWRhcHRlcikgewogICAgICAgIGlmIChvbGRBZGFwdGVyKSB7CiAgICAgICAgICBvbGRBZGFwdGVyLmRldGFjaCgpOwogICAgICAgICAgaWYgKG9sZEFkYXB0ZXIubmV4dCkgcmVzb2x2ZURhdGFzZXQob2xkQWRhcHRlciwgbnVsbCwgbnVsbCwgIm5leHQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKG5ld0FkYXB0ZXIpIG5ld0FkYXB0ZXIuYXR0YWNoKCk7CiAgICAgICAgY29udGV4dFtwcm9wZXJ0eV0gPSBuZXdBZGFwdGVyOwogICAgICB9CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlT2JqZWN0KGNvbnRleHQsIGZuLCBzb3VyY2UsIHByb3BlcnR5KSB7CiAgICAgIHZhciBvbGRBZGFwdGVyID0gY29udGV4dFtwcm9wZXJ0eV0gfHwgbnVsbDsKICAgICAgdmFyIG5ld0FkYXB0ZXIgPSBudWxsOwogICAgICBpZiAodHlwZW9mIHNvdXJjZSA9PSAiZnVuY3Rpb24iKSBzb3VyY2UgPSBzb3VyY2UuY2FsbChjb250ZXh0LCBjb250ZXh0KTsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBWYWx1ZSkgewogICAgICAgICAgbmV3QWRhcHRlciA9IG5ldyBSZXNvbHZlQWRhcHRlcihjb250ZXh0LCBmbiwgc291cmNlLCBWQUxVRV9BREFQVEVSX0hBTkRMRVIpOwogICAgICAgICAgc291cmNlID0gcmVzb2x2ZU9iamVjdChuZXdBZGFwdGVyLCBuZXdBZGFwdGVyLnByb3h5LCBzb3VyY2UudmFsdWUsICJuZXh0Iik7CiAgICAgICAgfSBlbHNlIGlmIChzb3VyY2UuYmluZGluZ0JyaWRnZSkgewogICAgICAgICAgbmV3QWRhcHRlciA9IG5ldyBCQlJlc29sdmVBZGFwdGVyKGNvbnRleHQsIGZuLCBzb3VyY2UsIFRPS0VOX0FEQVBURVJfSEFORExFUik7CiAgICAgICAgICBzb3VyY2UgPSByZXNvbHZlT2JqZWN0KG5ld0FkYXB0ZXIsIG5ld0FkYXB0ZXIucHJveHksIHNvdXJjZS52YWx1ZSwgIm5leHQiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHNvdXJjZSBpbnN0YW5jZW9mIERhdGFPYmplY3QgPT0gZmFsc2UpIHNvdXJjZSA9IG51bGw7CiAgICAgIGlmIChwcm9wZXJ0eSAmJiBvbGRBZGFwdGVyICE9PSBuZXdBZGFwdGVyKSB7CiAgICAgICAgaWYgKG9sZEFkYXB0ZXIpIHsKICAgICAgICAgIG9sZEFkYXB0ZXIuZGV0YWNoKCk7CiAgICAgICAgICBpZiAob2xkQWRhcHRlci5uZXh0KSByZXNvbHZlT2JqZWN0KG9sZEFkYXB0ZXIsIG51bGwsIG51bGwsICJuZXh0Iik7CiAgICAgICAgfQogICAgICAgIGlmIChuZXdBZGFwdGVyKSBuZXdBZGFwdGVyLmF0dGFjaCgpOwogICAgICAgIGNvbnRleHRbcHJvcGVydHldID0gbmV3QWRhcHRlcjsKICAgICAgfQogICAgICByZXR1cm4gc291cmNlOwogICAgfQogICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHByb3RvID0gUmVhZE9ubHlEYXRhc2V0LnByb3RvdHlwZTsKICAgICAgdmFyIGV2ZW50Q2FjaGUgPSB7fTsKICAgICAgdmFyIHNldFN0YXRlQ291bnQgPSAwOwogICAgICB2YXIgdXJnZW50VGltZXI7CiAgICAgIHZhciByZWFsRXZlbnQ7CiAgICAgIGZ1bmN0aW9uIGZsdXNoQ2FjaGUoY2FjaGUpIHsKICAgICAgICB2YXIgZGF0YXNldCA9IGNhY2hlLmRhdGFzZXQ7CiAgICAgICAgcmVhbEV2ZW50LmNhbGwoZGF0YXNldCwgY2FjaGUpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGZsdXNoQWxsRGF0YXNldCgpIHsKICAgICAgICB2YXIgZXZlbnRDYWNoZUNvcHkgPSBldmVudENhY2hlOwogICAgICAgIGV2ZW50Q2FjaGUgPSB7fTsKICAgICAgICBmb3IgKHZhciBkYXRhc2V0SWQgaW4gZXZlbnRDYWNoZUNvcHkpIHsKICAgICAgICAgIHZhciBlbnRyeSA9IGV2ZW50Q2FjaGVDb3B5W2RhdGFzZXRJZF07CiAgICAgICAgICBpZiAoZW50cnkpIGZsdXNoQ2FjaGUoZW50cnkpOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzdG9yZURhdGFzZXREZWx0YShkZWx0YSkgewogICAgICAgIHZhciBkYXRhc2V0ID0gdGhpczsKICAgICAgICB2YXIgZGF0YXNldElkID0gZGF0YXNldC5iYXNpc09iamVjdElkOwogICAgICAgIHZhciBpbnNlcnRlZCA9IGRlbHRhLmluc2VydGVkOwogICAgICAgIHZhciBkZWxldGVkID0gZGVsdGEuZGVsZXRlZDsKICAgICAgICB2YXIgY2FjaGUgPSBldmVudENhY2hlW2RhdGFzZXRJZF07CiAgICAgICAgaWYgKGluc2VydGVkICYmIGRlbGV0ZWQgfHwgY2FjaGUgJiYgY2FjaGUubWl4ZWQpIHsKICAgICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgICBldmVudENhY2hlW2RhdGFzZXRJZF0gPSBudWxsOwogICAgICAgICAgICBmbHVzaENhY2hlKGNhY2hlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlYWxFdmVudC5jYWxsKGRhdGFzZXQsIGRlbHRhKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGluc2VydGVkID8gImluc2VydGVkIiA6ICJkZWxldGVkIjsKICAgICAgICAgIHZhciBhcnJheSA9IGNhY2hlW21vZGVdOwogICAgICAgICAgaWYgKCFhcnJheSkgewogICAgICAgICAgICB2YXIgaW5DYWNoZU1vZGUgPSBpbnNlcnRlZCA/ICJkZWxldGVkIiA6ICJpbnNlcnRlZCI7CiAgICAgICAgICAgIHZhciBpbkNhY2hlID0gY2FjaGVbaW5DYWNoZU1vZGVdOwogICAgICAgICAgICB2YXIgaW5DYWNoZU1hcCA9IHt9OwogICAgICAgICAgICB2YXIgZGVsdGFJdGVtcyA9IGluc2VydGVkIHx8IGRlbGV0ZWQ7CiAgICAgICAgICAgIHZhciBuZXdJbkNhY2hlSXRlbXMgPSBbXTsKICAgICAgICAgICAgdmFyIGluQ2FjaGVSZW1vdmVzID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbkNhY2hlLmxlbmd0aDsgaSsrKSBpbkNhY2hlTWFwW2luQ2FjaGVbaV0uYmFzaXNPYmplY3RJZF0gPSBpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlbHRhSXRlbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgaWQgPSBkZWx0YUl0ZW1zW2ldLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgaWYgKGlkIGluIGluQ2FjaGVNYXAgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIG5ld0luQ2FjaGVJdGVtcy5wdXNoKGRlbHRhSXRlbXNbaV0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWluQ2FjaGVSZW1vdmVzKSBpbkNhY2hlID0gc2xpY2VBcnJheS5jYWxsKGluQ2FjaGUpOwogICAgICAgICAgICAgICAgaW5DYWNoZVJlbW92ZXMrKzsKICAgICAgICAgICAgICAgIGluQ2FjaGVbaW5DYWNoZU1hcFtpZF1dID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluQ2FjaGVSZW1vdmVzKSB7CiAgICAgICAgICAgICAgaWYgKGluQ2FjaGVSZW1vdmVzIDwgaW5DYWNoZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGluQ2FjaGUgPSBpbkNhY2hlLmZpbHRlcihCb29sZWFuKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaW5DYWNoZSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhY2hlW2luQ2FjaGVNb2RlXSA9IGluQ2FjaGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFuZXdJbkNhY2hlSXRlbXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgbmV3SW5DYWNoZUl0ZW1zID0gbnVsbDsKICAgICAgICAgICAgICBpZiAoIWluQ2FjaGUpIGV2ZW50Q2FjaGVbZGF0YXNldElkXSA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2FjaGVbbW9kZV0gPSBuZXdJbkNhY2hlSXRlbXM7CiAgICAgICAgICAgICAgaWYgKGluQ2FjaGUpIGNhY2hlLm1peGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGFycmF5LnB1c2guYXBwbHkoYXJyYXksIGluc2VydGVkIHx8IGRlbGV0ZWQpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBldmVudENhY2hlW2RhdGFzZXRJZF0gPSB7CiAgICAgICAgICBpbnNlcnRlZDogaW5zZXJ0ZWQsCiAgICAgICAgICBkZWxldGVkOiBkZWxldGVkLAogICAgICAgICAgZGF0YXNldDogZGF0YXNldCwKICAgICAgICAgIG1peGVkOiBmYWxzZQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdXJnZW50Rmx1c2goKSB7CiAgICAgICAgdXJnZW50VGltZXIgPSBudWxsOwogICAgICAgIGlmIChzZXRTdGF0ZUNvdW50KSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiKGRlYnVnKSBVcmdlbnQgZmx1c2ggZGF0YXNldCBjaGFuZ2VzIik7CiAgICAgICAgICBzZXRTdGF0ZUNvdW50ID0gMDsKICAgICAgICAgIHNldEFjY3VtdWxhdGVTdGF0ZU9mZigpOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzZXRBY2N1bXVsYXRlU3RhdGVPZmYoKSB7CiAgICAgICAgcHJvdG8uZW1pdF9pdGVtc0NoYW5nZWQgPSByZWFsRXZlbnQ7CiAgICAgICAgZmx1c2hBbGxEYXRhc2V0KCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgICAgaWYgKHN0YXRlKSB7CiAgICAgICAgICBpZiAoc2V0U3RhdGVDb3VudCA9PSAwKSB7CiAgICAgICAgICAgIHJlYWxFdmVudCA9IHByb3RvLmVtaXRfaXRlbXNDaGFuZ2VkOwogICAgICAgICAgICBwcm90by5lbWl0X2l0ZW1zQ2hhbmdlZCA9IHN0b3JlRGF0YXNldERlbHRhOwogICAgICAgICAgICBpZiAoIXVyZ2VudFRpbWVyKSB1cmdlbnRUaW1lciA9IGJhc2lzLnNldEltbWVkaWF0ZSh1cmdlbnRGbHVzaCk7CiAgICAgICAgICB9CiAgICAgICAgICBzZXRTdGF0ZUNvdW50Kys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNldFN0YXRlQ291bnQgLT0gc2V0U3RhdGVDb3VudCA+IDA7CiAgICAgICAgICBpZiAoc2V0U3RhdGVDb3VudCA9PSAwKSBzZXRBY2N1bXVsYXRlU3RhdGVPZmYoKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KCk7CiAgICBmdW5jdGlvbiB3cmFwRGF0YShkYXRhKSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSByZXR1cm4gZGF0YS5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBkYXRhOiBpdGVtCiAgICAgICAgfTsKICAgICAgfSk7IGVsc2UgcmV0dXJuIHsKICAgICAgICBkYXRhOiBkYXRhCiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiB3cmFwT2JqZWN0KGRhdGEpIHsKICAgICAgaWYgKCFkYXRhIHx8IGRhdGEuY29uc3RydWN0b3IgIT09IE9iamVjdCkgZGF0YSA9IHsKICAgICAgICB2YWx1ZTogZGF0YQogICAgICB9OwogICAgICByZXR1cm4gbmV3IERhdGFPYmplY3QoewogICAgICAgIGRhdGE6IGRhdGEKICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiB3cmFwKHZhbHVlLCByZXRPYmplY3QpIHsKICAgICAgdmFyIHdyYXBwZXIgPSByZXRPYmplY3QgPyB3cmFwT2JqZWN0IDogd3JhcERhdGE7CiAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHZhbHVlLm1hcCh3cmFwcGVyKSA6IHdyYXBwZXIodmFsdWUpOwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFNUQVRFOiBTVEFURSwKICAgICAgU1VCU0NSSVBUSU9OOiBTVUJTQ1JJUFRJT04sCiAgICAgIEFic3RyYWN0RGF0YTogQWJzdHJhY3REYXRhLAogICAgICBWYWx1ZTogVmFsdWUsCiAgICAgIE9iamVjdDogRGF0YU9iamVjdCwKICAgICAgU2xvdDogU2xvdCwKICAgICAgS2V5T2JqZWN0TWFwOiBLZXlPYmplY3RNYXAsCiAgICAgIFJlYWRPbmx5RGF0YXNldDogUmVhZE9ubHlEYXRhc2V0LAogICAgICBEYXRhc2V0OiBEYXRhc2V0LAogICAgICBEYXRhc2V0V3JhcHBlcjogRGF0YXNldFdyYXBwZXIsCiAgICAgIGlzQ29ubmVjdGVkOiBpc0Nvbm5lY3RlZCwKICAgICAgZ2V0RGF0YXNldERlbHRhOiBnZXREYXRhc2V0RGVsdGEsCiAgICAgIFJlc29sdmVBZGFwdGVyOiBSZXNvbHZlQWRhcHRlciwKICAgICAgcmVzb2x2ZURhdGFzZXQ6IHJlc29sdmVEYXRhc2V0LAogICAgICByZXNvbHZlT2JqZWN0OiByZXNvbHZlT2JqZWN0LAogICAgICB3cmFwRGF0YTogd3JhcERhdGEsCiAgICAgIHdyYXBPYmplY3Q6IHdyYXBPYmplY3QsCiAgICAgIHdyYXA6IHdyYXAKICAgIH07CiAgfSwKICAiNS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgQ2xhc3MgPSBiYXNpcy5DbGFzczsKICAgIHZhciBjb21wbGV0ZSA9IGJhc2lzLm9iamVjdC5jb21wbGV0ZTsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheTsKICAgIHZhciBhcnJheVJlbW92ZSA9IGJhc2lzLmFycmF5LnJlbW92ZTsKICAgIHZhciAkdW5kZWYgPSBiYXNpcy5mbi4kdW5kZWY7CiAgICB2YXIgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyOwogICAgdmFyIG51bGxHZXR0ZXIgPSBiYXNpcy5mbi5udWxsR2V0dGVyOwogICAgdmFyIG9uZUZ1bmN0aW9uUHJvcGVydHkgPSBDbGFzcy5vbmVGdW5jdGlvblByb3BlcnR5OwogICAgdmFyIGNyZWF0ZUV2ZW50ID0gYmFzaXMuZXZlbnQuY3JlYXRlOwogICAgdmFyIGV2ZW50cyA9IGJhc2lzLmV2ZW50LmV2ZW50czsKICAgIHZhciBTVUJTQ1JJUFRJT04gPSBiYXNpcy5kYXRhLlNVQlNDUklQVElPTjsKICAgIHZhciBTVEFURSA9IGJhc2lzLmRhdGEuU1RBVEU7CiAgICB2YXIgQWJzdHJhY3REYXRhID0gYmFzaXMuZGF0YS5BYnN0cmFjdERhdGE7CiAgICB2YXIgRGF0YU9iamVjdCA9IGJhc2lzLmRhdGEuT2JqZWN0OwogICAgdmFyIFJlYWRPbmx5RGF0YXNldCA9IGJhc2lzLmRhdGEuUmVhZE9ubHlEYXRhc2V0OwogICAgdmFyIERhdGFzZXQgPSBiYXNpcy5kYXRhLkRhdGFzZXQ7CiAgICB2YXIgRGF0YXNldFdyYXBwZXIgPSBiYXNpcy5kYXRhLkRhdGFzZXRXcmFwcGVyOwogICAgdmFyIEVYQ0VQVElPTl9DQU5UX0lOU0VSVCA9IG5hbWVzcGFjZSArICI6IE5vZGUgY2FuJ3QgYmUgaW5zZXJ0ZWQgYXQgc3BlY2lmaWVkIHBvaW50IGluIGhpZXJhcmNoeSI7CiAgICB2YXIgRVhDRVBUSU9OX05PREVfTk9UX0ZPVU5EID0gbmFtZXNwYWNlICsgIjogTm9kZSB3YXMgbm90IGZvdW5kIjsKICAgIHZhciBFWENFUFRJT05fQkFEX0NISUxEX0NMQVNTID0gbmFtZXNwYWNlICsgIjogQ2hpbGQgbm9kZSBoYXMgd3JvbmcgY2xhc3MiOwogICAgdmFyIEVYQ0VQVElPTl9OVUxMX0NISUxEID0gbmFtZXNwYWNlICsgIjogQ2hpbGQgbm9kZSBpcyBudWxsIjsKICAgIHZhciBFWENFUFRJT05fREFUQVNPVVJDRV9DT05GTElDVCA9IG5hbWVzcGFjZSArICI6IE9wZXJhdGlvbiBpcyBub3QgYWxsb3dlZCBiZWNhdXNlIG5vZGUgaXMgdW5kZXIgZGF0YVNvdXJjZSBjb250cm9sIjsKICAgIHZhciBFWENFUFRJT05fREFUQVNPVVJDRUFEQVBURVJfQ09ORkxJQ1QgPSBuYW1lc3BhY2UgKyAiOiBPcGVyYXRpb24gaXMgbm90IGFsbG93ZWQgYmVjYXVzZSBub2RlIGlzIHVuZGVyIGRhdGFTb3VyY2UgYWRhcHRlciBjb250cm9sIjsKICAgIHZhciBFWENFUFRJT05fUEFSRU5UTk9ERV9PV05FUl9DT05GTElDVCA9IG5hbWVzcGFjZSArICI6IE5vZGUgY2FuJ3QgaGFzIG93bmVyIGFuZCBwYXJlbnROb2RlIjsKICAgIHZhciBFWENFUFRJT05fTk9fQ0hJTERDTEFTUyA9IG5hbWVzcGFjZSArICI6IE5vZGUgY2FuJ3QgaGFzIGNoaWxkcmVuIGFuZCBkYXRhU291cmNlIGFzIGNoaWxkQ2xhc3MgaXNuJ3Qgc3BlY2lmaWVkIjsKICAgIHZhciBERUxFR0FURSA9IHsKICAgICAgQU5ZOiB0cnVlLAogICAgICBOT05FOiBmYWxzZSwKICAgICAgUEFSRU5UOiAicGFyZW50IiwKICAgICAgT1dORVI6ICJvd25lciIKICAgIH07CiAgICB2YXIgY2hpbGROb2Rlc0RhdGFzZXRNYXAgPSB7fTsKICAgIGZ1bmN0aW9uIHdhcm5PbkRhdGFTb3VyY2VJdGVtTm9kZURlc3RveSgpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogbm9kZSBjYW4ndCBiZSBkZXN0cm95ZWQgYXMgcmVwcmVzZW50aW5nIGRhdGFTb3VyY2UgaXRlbSwgZGVzdHJveSBkZWxlZ2F0ZSBpdGVtIG9yIHJlbW92ZSBpdCBmcm9tIGRhdGFTb3VyY2UgZmlyc3QiKTsKICAgIH0KICAgIGZ1bmN0aW9uIHdhcm5PbkF1dG9TYXRlbGxpdGVPd25lckNoYW5nZSgpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogc2F0ZWxsaXRlIGNhbid0IGNoYW5nZSBvd25lciBhcyBpdCBhdXRvLXNhdGVsbGl0ZSIpOwogICAgfQogICAgZnVuY3Rpb24gd2Fybk9uQXV0b1NhdGVsbGl0ZURlc3RveSgpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogc2F0ZWxsaXRlIGNhbid0IGJlIGRlc3Ryb3llZCBhcyBpdCBhdXRvLWNyZWF0ZSBzYXRlbGxpdGUsIGFuZCBjb3VsZCBiZSBkZXN0cm95ZWQgb24gb3duZXIgZGVzdHJveSIpOwogICAgfQogICAgZnVuY3Rpb24gbG9ja0RhdGFTb3VyY2VJdGVtTm9kZShub2RlKSB7CiAgICAgIG5vZGUuc2V0RGVsZWdhdGUgPSBiYXNpcy5mbi4kdW5kZWY7CiAgICAgIG5vZGUuZGVzdHJveSA9IHdhcm5PbkRhdGFTb3VyY2VJdGVtTm9kZURlc3RveTsKICAgIH0KICAgIGZ1bmN0aW9uIHVubG9ja0RhdGFTb3VyY2VJdGVtTm9kZShub2RlKSB7CiAgICAgIHZhciBwcm90byA9IG5vZGUuY29uc3RydWN0b3IucHJvdG90eXBlOwogICAgICBub2RlLnNldERlbGVnYXRlID0gcHJvdG8uc2V0RGVsZWdhdGU7CiAgICAgIG5vZGUuZGVzdHJveSA9IHByb3RvLmRlc3Ryb3k7CiAgICB9CiAgICBmdW5jdGlvbiBzb3J0aW5nU2VhcmNoKG5vZGUpIHsKICAgICAgcmV0dXJuIG5vZGUuc29ydGluZ1ZhbHVlIHx8IDA7CiAgICB9CiAgICBmdW5jdGlvbiBzb3J0QXNjKGEsIGIpIHsKICAgICAgYSA9IGEuc29ydGluZ1ZhbHVlIHx8IDA7CiAgICAgIGIgPSBiLnNvcnRpbmdWYWx1ZSB8fCAwOwogICAgICByZXR1cm4gKyhhID4gYikgfHwgLShhIDwgYik7CiAgICB9CiAgICBmdW5jdGlvbiBzb3J0RGVzYyhhLCBiKSB7CiAgICAgIGEgPSBhLnNvcnRpbmdWYWx1ZSB8fCAwOwogICAgICBiID0gYi5zb3J0aW5nVmFsdWUgfHwgMDsKICAgICAgcmV0dXJuIC0oYSA+IGIpIHx8ICsoYSA8IGIpOwogICAgfQogICAgZnVuY3Rpb24gc29ydENoaWxkTm9kZXMob2JqKSB7CiAgICAgIHJldHVybiBvYmouY2hpbGROb2Rlcy5zb3J0KG9iai5zb3J0aW5nRGVzYyA/IHNvcnREZXNjIDogc29ydEFzYyk7CiAgICB9CiAgICBmdW5jdGlvbiBiaW5hcnlTZWFyY2hQb3MoYXJyYXksIHZhbHVlLCBnZXR0ZXJfLCBkZXNjKSB7CiAgICAgIGlmICghYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgZGVzYyA9ICEhZGVzYzsKICAgICAgdmFyIHBvczsKICAgICAgdmFyIGNvbXBhcmVWYWx1ZTsKICAgICAgdmFyIGwgPSAwOwogICAgICB2YXIgciA9IGFycmF5Lmxlbmd0aCAtIDE7CiAgICAgIGRvIHsKICAgICAgICBwb3MgPSBsICsgciA+PiAxOwogICAgICAgIGNvbXBhcmVWYWx1ZSA9IGdldHRlcl8oYXJyYXlbcG9zXSk7CiAgICAgICAgaWYgKGRlc2MgPyB2YWx1ZSA+IGNvbXBhcmVWYWx1ZSA6IHZhbHVlIDwgY29tcGFyZVZhbHVlKSByID0gcG9zIC0gMTsgZWxzZSBpZiAoZGVzYyA/IHZhbHVlIDwgY29tcGFyZVZhbHVlIDogdmFsdWUgPiBjb21wYXJlVmFsdWUpIGwgPSBwb3MgKyAxOyBlbHNlIHJldHVybiB2YWx1ZSA9PSBjb21wYXJlVmFsdWUgPyBwb3MgOiAwOwogICAgICB9IHdoaWxlIChsIDw9IHIpOwogICAgICByZXR1cm4gcG9zICsgKGNvbXBhcmVWYWx1ZSA8IHZhbHVlIF4gZGVzYyk7CiAgICB9CiAgICBmdW5jdGlvbiB1cGRhdGVOb2RlQ29udGV4dFNlbGVjdGlvbihyb290LCBvbGRTZWxlY3Rpb24sIG5ld1NlbGVjdGlvbiwgcm9vdFVwZGF0ZSwgaWdub3JlUm9vdFNlbGVjdGlvbikgewogICAgICBpZiAob2xkU2VsZWN0aW9uID09PSBuZXdTZWxlY3Rpb24pIHJldHVybjsKICAgICAgdmFyIG5leHROb2RlOwogICAgICB2YXIgY3Vyc29yID0gcm9vdDsKICAgICAgdmFyIHNlbGVjdGVkID0gW107CiAgICAgIGlmIChyb290VXBkYXRlKSB7CiAgICAgICAgcm9vdC5jb250ZXh0U2VsZWN0aW9uID0gbmV3U2VsZWN0aW9uOwogICAgICAgIGlmIChyb290LnNlbGVjdGVkKSBzZWxlY3RlZC5wdXNoKHJvb3QpOwogICAgICB9CiAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICBuZXh0Tm9kZSA9ICFjdXJzb3Iuc2VsZWN0aW9uIHx8IGlnbm9yZVJvb3RTZWxlY3Rpb24gJiYgY3Vyc29yID09PSByb290ID8gY3Vyc29yLmZpcnN0Q2hpbGQgOiBudWxsOwogICAgICAgIGlmIChuZXh0Tm9kZSAmJiBuZXh0Tm9kZS5jb250ZXh0U2VsZWN0aW9uICE9PSBvbGRTZWxlY3Rpb24pIHRocm93ICJUcnkgY2hhbmdlIHdyb25nIGNvbnRleHQgc2VsZWN0aW9uIjsKICAgICAgICB3aGlsZSAoIW5leHROb2RlKSB7CiAgICAgICAgICBpZiAoY3Vyc29yID09PSByb290KSB7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZC5sZW5ndGgpIHsKICAgICAgICAgICAgICBpZiAob2xkU2VsZWN0aW9uKSBvbGRTZWxlY3Rpb24ucmVtb3ZlKHNlbGVjdGVkKTsKICAgICAgICAgICAgICBpZiAobmV3U2VsZWN0aW9uKSBuZXdTZWxlY3Rpb24uYWRkKHNlbGVjdGVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBuZXh0Tm9kZSA9IGN1cnNvci5uZXh0U2libGluZzsKICAgICAgICAgIGlmICghbmV4dE5vZGUpIGN1cnNvciA9IGN1cnNvci5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICBjdXJzb3IgPSBuZXh0Tm9kZTsKICAgICAgICBpZiAoY3Vyc29yLnNlbGVjdGVkKSBzZWxlY3RlZC5wdXNoKGN1cnNvcik7CiAgICAgICAgY3Vyc29yLmNvbnRleHRTZWxlY3Rpb24gPSBuZXdTZWxlY3Rpb247CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHVwZGF0ZU5vZGVEaXNhYmxlQ29udGV4dChub2RlLCBkaXNhYmxlZCkgewogICAgICBpZiAobm9kZS5jb250ZXh0RGlzYWJsZWQgIT0gZGlzYWJsZWQpIHsKICAgICAgICBub2RlLmNvbnRleHREaXNhYmxlZCA9IGRpc2FibGVkOwogICAgICAgIGlmIChub2RlLmRpc2FibGVkKSByZXR1cm47CiAgICAgICAgaWYgKGRpc2FibGVkKSBub2RlLmVtaXRfZGlzYWJsZSgpOyBlbHNlIG5vZGUuZW1pdF9lbmFibGUoKTsKICAgICAgfQogICAgfQogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJvd25lciIpOwogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJkYXRhU291cmNlIik7CiAgICBmdW5jdGlvbiBwcm9jZXNzU2F0ZWxsaXRlQ29uZmlnKHZhbHVlKSB7CiAgICAgIGlmICghdmFsdWUpIHJldHVybiBudWxsOwogICAgICBpZiAodmFsdWUuaXNTYXRlbGxpdGVDb25maWcpIHJldHVybiB2YWx1ZTsKICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQWJzdHJhY3ROb2RlKSByZXR1cm4gdmFsdWU7CiAgICAgIGlmIChDbGFzcy5pc0NsYXNzKHZhbHVlKSkgdmFsdWUgPSB7CiAgICAgICAgaW5zdGFuY2VPZjogdmFsdWUKICAgICAgfTsKICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICB2YXIgaGFuZGxlclJlcXVpcmVkID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbmZpZyA9IHsKICAgICAgICAgIGlzU2F0ZWxsaXRlQ29uZmlnOiB0cnVlCiAgICAgICAgfTsKICAgICAgICB2YXIgaW5zdGFuY2VDbGFzczsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgICBjYXNlICJpbnN0YW5jZSI6CiAgICAgICAgICAgIGlmICh2YWx1ZVtrZXldIGluc3RhbmNlb2YgQWJzdHJhY3ROb2RlKSBjb25maWdba2V5XSA9IHZhbHVlW2tleV07IGVsc2UgewogICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICI6IGBpbnN0YW5jZWAgdmFsdWUgaW4gc2F0ZWxsaXRlIGNvbmZpZyBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIGJhc2lzLmRvbS53cmFwcGVyLkFic3RyYWN0Tm9kZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiaW5zdGFuY2VPZiI6CiAgICAgICAgICAgIGlmIChDbGFzcy5pc0NsYXNzKHZhbHVlW2tleV0pICYmIHZhbHVlW2tleV0uaXNTdWJjbGFzc09mKEFic3RyYWN0Tm9kZSkpIGluc3RhbmNlQ2xhc3MgPSB2YWx1ZVtrZXldOyBlbHNlIHsKICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiBgaW5zdGFuY2VPZmAgdmFsdWUgaW4gc2F0ZWxsaXRlIGNvbmZpZyBtdXN0IGJlIGEgc3ViY2xhc3Mgb2YgYmFzaXMuZG9tLndyYXBwZXIuQWJzdHJhY3ROb2RlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJleGlzdHNJZiI6CiAgICAgICAgICBjYXNlICJkZWxlZ2F0ZSI6CiAgICAgICAgICBjYXNlICJkYXRhU291cmNlIjoKICAgICAgICAgICAgaGFuZGxlclJlcXVpcmVkID0gdHJ1ZTsKICAgICAgICAgICAgY29uZmlnW2tleV0gPSBnZXR0ZXIodmFsdWVba2V5XSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiY29uZmlnIjoKICAgICAgICAgICAgY29uZmlnW2tleV0gPSB2YWx1ZVtrZXldOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKCFjb25maWcuaW5zdGFuY2UpIGNvbmZpZy5pbnN0YW5jZU9mID0gaW5zdGFuY2VDbGFzcyB8fCBBYnN0cmFjdE5vZGU7IGVsc2UgewogICAgICAgICAgaWYgKGluc3RhbmNlQ2xhc3MpIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICI6IGBpbnN0YW5jZU9mYCBjYW4ndCBiZSBzZXQgd2l0aCBgaW5zdGFuY2VgIHZhbHVlIGluIHNhdGVsbGl0ZSBjb25maWcsIHZhbHVlIGlnbm9yZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGhhbmRsZXJSZXF1aXJlZCkgewogICAgICAgICAgdmFyIGV2ZW50cyA9ICJldmVudHMiIGluIHZhbHVlID8gdmFsdWUuZXZlbnRzIDogInVwZGF0ZSI7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShldmVudHMpKSBldmVudHMgPSBldmVudHMuam9pbigiICIpOwogICAgICAgICAgaWYgKHR5cGVvZiBldmVudHMgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSB7fTsKICAgICAgICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KC9ccysvKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50TmFtZTsgZXZlbnROYW1lID0gZXZlbnRzW2ldOyBpKyspIHsKICAgICAgICAgICAgICBoYW5kbGVyW2V2ZW50TmFtZV0gPSBTQVRFTExJVEVfVVBEQVRFOwogICAgICAgICAgICAgIGNvbmZpZy5oYW5kbGVyID0gaGFuZGxlcjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gY29uZmlnOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgZnVuY3Rpb24gYXBwbHlTYXRlbGxpdGVzKG5vZGUsIHNhdGVsbGl0ZXMpIHsKICAgICAgZm9yICh2YXIgbmFtZSBpbiBzYXRlbGxpdGVzKSBpZiAoc2F0ZWxsaXRlc1tuYW1lXSAmJiB0eXBlb2Ygc2F0ZWxsaXRlc1tuYW1lXSA9PSAib2JqZWN0Iikgbm9kZS5zZXRTYXRlbGxpdGUobmFtZSwgc2F0ZWxsaXRlc1tuYW1lXSk7CiAgICB9CiAgICB2YXIgTlVMTF9TQVRFTExJVEUgPSBDbGFzcy5jdXN0b21FeHRlbmRQcm9wZXJ0eSh7fSwgZnVuY3Rpb24ocmVzdWx0LCBleHRlbmQpIHsKICAgICAgZm9yICh2YXIgbmFtZSBpbiBleHRlbmQpIHJlc3VsdFtuYW1lXSA9IHByb2Nlc3NTYXRlbGxpdGVDb25maWcoZXh0ZW5kW25hbWVdKTsKICAgIH0pOwogICAgdmFyIFNBVEVMTElURV9VUERBVEUgPSBmdW5jdGlvbihvd25lcikgewogICAgICB2YXIgbmFtZSA9IHRoaXMubmFtZTsKICAgICAgdmFyIGNvbmZpZyA9IHRoaXMuY29uZmlnOwogICAgICB2YXIgZXhpc3RzID0gIWNvbmZpZy5leGlzdHNJZiB8fCBjb25maWcuZXhpc3RzSWYob3duZXIpOwogICAgICB2YXIgc2F0ZWxsaXRlID0gb3duZXIuc2F0ZWxsaXRlW25hbWVdOwogICAgICBpZiAoZXhpc3RzKSB7CiAgICAgICAgaWYgKHNhdGVsbGl0ZSkgewogICAgICAgICAgaWYgKGNvbmZpZy5kZWxlZ2F0ZSkgc2F0ZWxsaXRlLnNldERlbGVnYXRlKGNvbmZpZy5kZWxlZ2F0ZShvd25lcikpOwogICAgICAgICAgaWYgKGNvbmZpZy5kYXRhU291cmNlKSBzYXRlbGxpdGUuc2V0RGF0YVNvdXJjZShjb25maWcuZGF0YVNvdXJjZShvd25lcikpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzYXRlbGxpdGUgPSBjb25maWcuaW5zdGFuY2U7CiAgICAgICAgICBpZiAoIXNhdGVsbGl0ZSkgewogICAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlcjsKICAgICAgICAgICAgdmFyIHNhdGVsbGl0ZUNvbmZpZyA9ICh0eXBlb2YgY29uZmlnLmNvbmZpZyA9PSAiZnVuY3Rpb24iID8gY29uZmlnLmNvbmZpZyhvd25lcikgOiBjb25maWcuY29uZmlnKSB8fCB7fTsKICAgICAgICAgICAgc2F0ZWxsaXRlQ29uZmlnLm93bmVyID0gb3duZXI7CiAgICAgICAgICAgIGlmIChjb25maWcuZGVsZWdhdGUpIHsKICAgICAgICAgICAgICBzYXRlbGxpdGVDb25maWcuYXV0b0RlbGVnYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgc2F0ZWxsaXRlQ29uZmlnLmRlbGVnYXRlID0gY29uZmlnLmRlbGVnYXRlKG93bmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29uZmlnLmRhdGFTb3VyY2UpIHNhdGVsbGl0ZUNvbmZpZy5kYXRhU291cmNlID0gY29uZmlnLmRhdGFTb3VyY2Uob3duZXIpOwogICAgICAgICAgICBzYXRlbGxpdGUgPSBuZXcgY29uZmlnLmluc3RhbmNlT2Yoc2F0ZWxsaXRlQ29uZmlnKTsKICAgICAgICAgICAgc2F0ZWxsaXRlLmRlc3Ryb3kgPSB3YXJuT25BdXRvU2F0ZWxsaXRlRGVzdG95OwogICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlciA9IG93bmVyLmxpc3Rlbi5zYXRlbGxpdGUpIHNhdGVsbGl0ZS5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIG93bmVyKTsKICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIgPSBvd25lci5saXN0ZW5bInNhdGVsbGl0ZToiICsgbmFtZV0pIHNhdGVsbGl0ZS5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIG93bmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjb25maWcuZGVsZWdhdGUpIHNhdGVsbGl0ZS5zZXREZWxlZ2F0ZShjb25maWcuZGVsZWdhdGUob3duZXIpKTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5kYXRhU291cmNlKSBzYXRlbGxpdGUuc2V0RGF0YVNvdXJjZShjb25maWcuZGF0YVNvdXJjZShvd25lcikpOwogICAgICAgICAgfQogICAgICAgICAgb3duZXIuc2F0ZWxsaXRlLl9fYXV0b19fW25hbWVdLmluc3RhbmNlID0gc2F0ZWxsaXRlOwogICAgICAgICAgb3duZXIuc2V0U2F0ZWxsaXRlKG5hbWUsIHNhdGVsbGl0ZSwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChzYXRlbGxpdGUpIHsKICAgICAgICAgIGlmIChjb25maWcuaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKGNvbmZpZy5kZWxlZ2F0ZSkgc2F0ZWxsaXRlLnNldERlbGVnYXRlKCk7CiAgICAgICAgICAgIGlmIChjb25maWcuZGF0YVNvdXJjZSkgc2F0ZWxsaXRlLnNldERhdGFTb3VyY2UoKTsKICAgICAgICAgIH0KICAgICAgICAgIG93bmVyLnNhdGVsbGl0ZS5fX2F1dG9fX1tuYW1lXS5pbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBvd25lci5zZXRTYXRlbGxpdGUobmFtZSwgbnVsbCwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgdmFyIEFVVE9fU0FURUxMSVRFX0lOU1RBTkNFX0hBTkRMRVIgPSB7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMub3duZXIuc2V0U2F0ZWxsaXRlKHRoaXMubmFtZSwgbnVsbCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgQWJzdHJhY3ROb2RlID0gQ2xhc3MoRGF0YU9iamVjdCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQWJzdHJhY3ROb2RlIiwKICAgICAgc3Vic2NyaWJlVG86IERhdGFPYmplY3QucHJvdG90eXBlLnN1YnNjcmliZVRvICsgU1VCU0NSSVBUSU9OLkRBVEFTT1VSQ0UsCiAgICAgIGlzU3luY1JlcXVpcmVkOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZSA9PSBTVEFURS5VTkRFRklORUQgfHwgdGhpcy5zdGF0ZSA9PSBTVEFURS5ERVBSRUNBVEVEOwogICAgICB9LAogICAgICBzeW5jRXZlbnRzOiB7CiAgICAgICAgYWN0aXZlQ2hhbmdlZDogZmFsc2UKICAgICAgfSwKICAgICAgZW1pdF91cGRhdGU6IGZ1bmN0aW9uKGRlbHRhKSB7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuZW1pdF91cGRhdGUuY2FsbCh0aGlzLCBkZWx0YSk7CiAgICAgICAgdmFyIHBhcmVudE5vZGUgPSB0aGlzLnBhcmVudE5vZGU7CiAgICAgICAgaWYgKHBhcmVudE5vZGUpIHsKICAgICAgICAgIGlmIChwYXJlbnROb2RlLm1hdGNoRnVuY3Rpb24pIHRoaXMubWF0Y2gocGFyZW50Tm9kZS5tYXRjaEZ1bmN0aW9uKTsKICAgICAgICAgIHBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXMsIHRoaXMubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgbGlzdGVuOiB7CiAgICAgICAgb3duZXI6IHsKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMub3duZXJTYXRlbGxpdGVOYW1lKSB0aGlzLnNldE93bmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBhdXRvRGVsZWdhdGU6IERFTEVHQVRFLk5PTkUsCiAgICAgIG5hbWU6IG51bGwsCiAgICAgIGNoaWxkTm9kZXM6IG51bGwsCiAgICAgIGVtaXRfY2hpbGROb2Rlc01vZGlmaWVkOiBjcmVhdGVFdmVudCgiY2hpbGROb2Rlc01vZGlmaWVkIiwgImRlbHRhIikgJiYgZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICBldmVudHMuY2hpbGROb2Rlc01vZGlmaWVkLmNhbGwodGhpcywgZGVsdGEpOwogICAgICAgIHZhciBsaXN0ZW4gPSB0aGlzLmxpc3Rlbi5jaGlsZE5vZGU7CiAgICAgICAgdmFyIGFycmF5OwogICAgICAgIGlmIChsaXN0ZW4pIHsKICAgICAgICAgIGlmIChhcnJheSA9IGRlbHRhLmluc2VydGVkKSBmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gYXJyYXlbaV07IGkrKykgY2hpbGQuYWRkSGFuZGxlcihsaXN0ZW4sIHRoaXMpOwogICAgICAgICAgaWYgKGFycmF5ID0gZGVsdGEuZGVsZXRlZCkgZm9yICh2YXIgaSA9IDAsIGNoaWxkOyBjaGlsZCA9IGFycmF5W2ldOyBpKyspIGNoaWxkLnJlbW92ZUhhbmRsZXIobGlzdGVuLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNoaWxkTm9kZXNTdGF0ZTogU1RBVEUuVU5ERUZJTkVELAogICAgICBlbWl0X2NoaWxkTm9kZXNTdGF0ZUNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJjaGlsZE5vZGVzU3RhdGVDaGFuZ2VkIiwgIm9sZFN0YXRlIiksCiAgICAgIGNoaWxkQ2xhc3M6IEFic3RyYWN0Tm9kZSwKICAgICAgZGF0YVNvdXJjZTogbnVsbCwKICAgICAgZW1pdF9kYXRhU291cmNlQ2hhbmdlZDogY3JlYXRlRXZlbnQoImRhdGFTb3VyY2VDaGFuZ2VkIiwgIm9sZERhdGFTb3VyY2UiKSwKICAgICAgZGF0YVNvdXJjZUFkYXB0ZXJfOiBudWxsLAogICAgICBkYXRhU291cmNlTWFwXzogbnVsbCwKICAgICAgZGVzdHJveURhdGFTb3VyY2VNZW1iZXI6IHRydWUsCiAgICAgIHBhcmVudE5vZGU6IG51bGwsCiAgICAgIG5leHRTaWJsaW5nOiBudWxsLAogICAgICBwcmV2aW91c1NpYmxpbmc6IG51bGwsCiAgICAgIGZpcnN0Q2hpbGQ6IG51bGwsCiAgICAgIGxhc3RDaGlsZDogbnVsbCwKICAgICAgc29ydGluZzogbnVsbEdldHRlciwKICAgICAgc29ydGluZ0Rlc2M6IGZhbHNlLAogICAgICBlbWl0X3NvcnRpbmdDaGFuZ2VkOiBjcmVhdGVFdmVudCgic29ydGluZ0NoYW5nZWQiLCAib2xkU29ydGluZyIsICJvbGRTb3J0aW5nRGVzYyIpLAogICAgICBncm91cGluZ0NsYXNzOiBudWxsLAogICAgICBncm91cGluZzogbnVsbCwKICAgICAgZW1pdF9ncm91cGluZ0NoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJncm91cGluZ0NoYW5nZWQiLCAib2xkR3JvdXBpbmciKSwKICAgICAgZ3JvdXBOb2RlOiBudWxsLAogICAgICBncm91cElkOiBOYU4sCiAgICAgIHNhdGVsbGl0ZTogTlVMTF9TQVRFTExJVEUsCiAgICAgIG93bmVyU2F0ZWxsaXRlTmFtZTogbnVsbCwKICAgICAgZW1pdF9zYXRlbGxpdGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgic2F0ZWxsaXRlQ2hhbmdlZCIsICJuYW1lIiwgIm9sZFNhdGVsbGl0ZSIpLAogICAgICBvd25lcjogbnVsbCwKICAgICAgZW1pdF9vd25lckNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJvd25lckNoYW5nZWQiLCAib2xkT3duZXIiKSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBjaGlsZE5vZGVzID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgIHZhciBkYXRhU291cmNlID0gdGhpcy5kYXRhU291cmNlOwogICAgICAgIGlmIChjaGlsZE5vZGVzKSB0aGlzLmNoaWxkTm9kZXMgPSBudWxsOwogICAgICAgIGlmIChkYXRhU291cmNlKSB0aGlzLmRhdGFTb3VyY2UgPSBudWxsOwogICAgICAgIHZhciBncm91cGluZyA9IHRoaXMuZ3JvdXBpbmc7CiAgICAgICAgaWYgKGdyb3VwaW5nKSB7CiAgICAgICAgICB0aGlzLmdyb3VwaW5nID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2V0R3JvdXBpbmcoZ3JvdXBpbmcpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5jaGlsZENsYXNzKSB7CiAgICAgICAgICB0aGlzLmNoaWxkTm9kZXMgPSBbXTsKICAgICAgICAgIGlmIChkYXRhU291cmNlKSB7CiAgICAgICAgICAgIHRoaXMuc2V0RGF0YVNvdXJjZShkYXRhU291cmNlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjaGlsZE5vZGVzKSB0aGlzLnNldENoaWxkTm9kZXMoY2hpbGROb2Rlcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBzYXRlbGxpdGVzID0gdGhpcy5zYXRlbGxpdGU7CiAgICAgICAgaWYgKHNhdGVsbGl0ZXMgIT09IE5VTExfU0FURUxMSVRFKSB7CiAgICAgICAgICB0aGlzLnNhdGVsbGl0ZSA9IE5VTExfU0FURUxMSVRFOwogICAgICAgICAgYXBwbHlTYXRlbGxpdGVzKHRoaXMsIHNhdGVsbGl0ZXMpOwogICAgICAgIH0KICAgICAgICB2YXIgb3duZXIgPSB0aGlzLm93bmVyOwogICAgICAgIGlmIChvd25lcikgewogICAgICAgICAgdGhpcy5vd25lciA9IG51bGw7CiAgICAgICAgICB0aGlzLnNldE93bmVyKG93bmVyKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldENoaWxkTm9kZXNTdGF0ZTogZnVuY3Rpb24oc3RhdGUsIGRhdGEpIHsKICAgICAgICB2YXIgc3RhdGVDb2RlID0gU3RyaW5nKHN0YXRlKTsKICAgICAgICB2YXIgb2xkU3RhdGUgPSB0aGlzLmNoaWxkTm9kZXNTdGF0ZTsKICAgICAgICBpZiAoIVNUQVRFLnZhbHVlc1tzdGF0ZUNvZGVdKSB0aHJvdyBuZXcgRXJyb3IoIldyb25nIHN0YXRlIHZhbHVlIik7CiAgICAgICAgaWYgKG9sZFN0YXRlICE9IHN0YXRlQ29kZSB8fCBvbGRTdGF0ZS5kYXRhICE9IGRhdGEpIHsKICAgICAgICAgIHRoaXMuY2hpbGROb2Rlc1N0YXRlID0gT2JqZWN0KHN0YXRlQ29kZSk7CiAgICAgICAgICB0aGlzLmNoaWxkTm9kZXNTdGF0ZS5kYXRhID0gZGF0YTsKICAgICAgICAgIHRoaXMuZW1pdF9jaGlsZE5vZGVzU3RhdGVDaGFuZ2VkKG9sZFN0YXRlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFwcGVuZENoaWxkOiBmdW5jdGlvbihuZXdDaGlsZCkge30sCiAgICAgIGluc2VydEJlZm9yZTogZnVuY3Rpb24obmV3Q2hpbGQsIHJlZkNoaWxkKSB7fSwKICAgICAgcmVtb3ZlQ2hpbGQ6IGZ1bmN0aW9uKG9sZENoaWxkKSB7fSwKICAgICAgcmVwbGFjZUNoaWxkOiBmdW5jdGlvbihuZXdDaGlsZCwgb2xkQ2hpbGQpIHt9LAogICAgICBjbGVhcjogZnVuY3Rpb24oYWxpdmUpIHt9LAogICAgICBzZXRDaGlsZE5vZGVzOiBmdW5jdGlvbihub2Rlcykge30sCiAgICAgIHNldEdyb3VwaW5nOiBmdW5jdGlvbihncm91cGluZywgYWxpdmUpIHt9LAogICAgICBzZXRTb3J0aW5nOiBmdW5jdGlvbihzb3J0aW5nLCBkZXNjKSB7fSwKICAgICAgc2V0RGF0YVNvdXJjZTogZnVuY3Rpb24oZGF0YVNvdXJjZSkge30sCiAgICAgIHNldE93bmVyOiBmdW5jdGlvbihvd25lcikgewogICAgICAgIGlmICghb3duZXIgfHwgb3duZXIgaW5zdGFuY2VvZiBBYnN0cmFjdE5vZGUgPT0gZmFsc2UpIG93bmVyID0gbnVsbDsKICAgICAgICBpZiAob3duZXIgJiYgdGhpcy5wYXJlbnROb2RlKSB0aHJvdyBFWENFUFRJT05fUEFSRU5UTk9ERV9PV05FUl9DT05GTElDVDsKICAgICAgICB2YXIgb2xkT3duZXIgPSB0aGlzLm93bmVyOwogICAgICAgIGlmIChvbGRPd25lciAhPT0gb3duZXIpIHsKICAgICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4ub3duZXI7CiAgICAgICAgICBpZiAob2xkT3duZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMub3duZXJTYXRlbGxpdGVOYW1lICYmIG9sZE93bmVyLnNhdGVsbGl0ZS5fX2F1dG9fXyAmJiB0aGlzLm93bmVyU2F0ZWxsaXRlTmFtZSBpbiBvbGRPd25lci5zYXRlbGxpdGUuX19hdXRvX18pIHsKICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiBhdXRvLXNhdGVsbGl0ZSBjYW4ndCBjaGFuZ2UgaXQncyBvd25lciIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgb2xkT3duZXIucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgaWYgKHRoaXMub3duZXJTYXRlbGxpdGVOYW1lKSB7CiAgICAgICAgICAgICAgdGhpcy5vd25lciA9IG51bGw7CiAgICAgICAgICAgICAgb2xkT3duZXIuc2V0U2F0ZWxsaXRlKHRoaXMub3duZXJTYXRlbGxpdGVOYW1lLCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG93bmVyICYmIGxpc3RlbkhhbmRsZXIpIG93bmVyLmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICB0aGlzLm93bmVyID0gb3duZXI7CiAgICAgICAgICB0aGlzLmVtaXRfb3duZXJDaGFuZ2VkKG9sZE93bmVyKTsKICAgICAgICAgIGlmICh0aGlzLmF1dG9EZWxlZ2F0ZSA9PSBERUxFR0FURS5PV05FUiB8fCB0aGlzLmF1dG9EZWxlZ2F0ZSA9PT0gREVMRUdBVEUuQU5ZKSB0aGlzLnNldERlbGVnYXRlKG93bmVyKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFNhdGVsbGl0ZTogZnVuY3Rpb24obmFtZSwgc2F0ZWxsaXRlLCBhdXRvU2V0KSB7CiAgICAgICAgdmFyIG9sZFNhdGVsbGl0ZSA9IHRoaXMuc2F0ZWxsaXRlW25hbWVdIHx8IG51bGw7CiAgICAgICAgdmFyIGF1dG8gPSB0aGlzLnNhdGVsbGl0ZS5fX2F1dG9fXzsKICAgICAgICB2YXIgYXV0b0NvbmZpZyA9IGF1dG8gJiYgYXV0b1tuYW1lXTsKICAgICAgICB2YXIgcHJlc2VydmVBdXRvID0gYXV0b1NldCAmJiBhdXRvQ29uZmlnOwogICAgICAgIGlmIChwcmVzZXJ2ZUF1dG8pIHsKICAgICAgICAgIHNhdGVsbGl0ZSA9IGF1dG9Db25maWcuaW5zdGFuY2U7CiAgICAgICAgICBpZiAoYXV0b0NvbmZpZy5jb25maWcuaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKHNhdGVsbGl0ZSkgZGVsZXRlIGF1dG9Db25maWcuY29uZmlnLmluc3RhbmNlLnNldE93bmVyOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzYXRlbGxpdGUgPSBwcm9jZXNzU2F0ZWxsaXRlQ29uZmlnKHNhdGVsbGl0ZSk7CiAgICAgICAgICBpZiAoc2F0ZWxsaXRlICYmIHNhdGVsbGl0ZS5vd25lciAmJiBhdXRvICYmIHNhdGVsbGl0ZS5vd25lclNhdGVsbGl0ZU5hbWUgJiYgYXV0b1tzYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lXSkgewogICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiBhdXRvLWNyZWF0ZSBzYXRlbGxpdGUgY2FuJ3QgY2hhbmdlIG5hbWUgaW5zaWRlIG93bmVyIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhdXRvQ29uZmlnKSB7CiAgICAgICAgICAgIGRlbGV0ZSBhdXRvW25hbWVdOwogICAgICAgICAgICBpZiAoYXV0b0NvbmZpZy5jb25maWcuaW5zdGFuY2UpIGF1dG9Db25maWcuY29uZmlnLmluc3RhbmNlLnJlbW92ZUhhbmRsZXIoQVVUT19TQVRFTExJVEVfSU5TVEFOQ0VfSEFORExFUiwgYXV0b0NvbmZpZyk7CiAgICAgICAgICAgIGlmIChhdXRvQ29uZmlnLmNvbmZpZy5oYW5kbGVyKSB0aGlzLnJlbW92ZUhhbmRsZXIoYXV0b0NvbmZpZy5jb25maWcuaGFuZGxlciwgYXV0b0NvbmZpZyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChvbGRTYXRlbGxpdGUgIT09IHNhdGVsbGl0ZSkgewogICAgICAgICAgdmFyIHNhdGVsbGl0ZUxpc3RlbiA9IHRoaXMubGlzdGVuLnNhdGVsbGl0ZTsKICAgICAgICAgIHZhciBzYXRlbGxpdGVQZXJzb25hbExpc3RlbiA9IHRoaXMubGlzdGVuWyJzYXRlbGxpdGU6IiArIG5hbWVdOwogICAgICAgICAgdmFyIGRlc3Ryb3lTYXRlbGxpdGU7CiAgICAgICAgICBpZiAob2xkU2F0ZWxsaXRlKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnNhdGVsbGl0ZVtuYW1lXTsKICAgICAgICAgICAgb2xkU2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZSA9IG51bGw7CiAgICAgICAgICAgIGlmIChhdXRvQ29uZmlnICYmIG9sZFNhdGVsbGl0ZS5kZXN0cm95ID09PSB3YXJuT25BdXRvU2F0ZWxsaXRlRGVzdG95KSB7CiAgICAgICAgICAgICAgZGVzdHJveVNhdGVsbGl0ZSA9IG9sZFNhdGVsbGl0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlTGlzdGVuKSBvbGRTYXRlbGxpdGUucmVtb3ZlSGFuZGxlcihzYXRlbGxpdGVMaXN0ZW4sIHRoaXMpOwogICAgICAgICAgICAgIGlmIChzYXRlbGxpdGVQZXJzb25hbExpc3Rlbikgb2xkU2F0ZWxsaXRlLnJlbW92ZUhhbmRsZXIoc2F0ZWxsaXRlUGVyc29uYWxMaXN0ZW4sIHRoaXMpOwogICAgICAgICAgICAgIG9sZFNhdGVsbGl0ZS5zZXRPd25lcihudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJlc2VydmVBdXRvICYmICFzYXRlbGxpdGUgJiYgYXV0b0NvbmZpZy5jb25maWcuaW5zdGFuY2UpIGF1dG9Db25maWcuY29uZmlnLmluc3RhbmNlLnNldE93bmVyID0gd2Fybk9uQXV0b1NhdGVsbGl0ZU93bmVyQ2hhbmdlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNhdGVsbGl0ZSkgewogICAgICAgICAgICBpZiAoc2F0ZWxsaXRlIGluc3RhbmNlb2YgQWJzdHJhY3ROb2RlID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgdmFyIGF1dG9Db25maWcgPSB7CiAgICAgICAgICAgICAgICBvd25lcjogdGhpcywKICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICBjb25maWc6IHNhdGVsbGl0ZSwKICAgICAgICAgICAgICAgIGluc3RhbmNlOiBudWxsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlLmhhbmRsZXIpIHRoaXMuYWRkSGFuZGxlcihzYXRlbGxpdGUuaGFuZGxlciwgYXV0b0NvbmZpZyk7CiAgICAgICAgICAgICAgaWYgKHNhdGVsbGl0ZS5pbnN0YW5jZSkgewogICAgICAgICAgICAgICAgc2F0ZWxsaXRlLmluc3RhbmNlLmFkZEhhbmRsZXIoQVVUT19TQVRFTExJVEVfSU5TVEFOQ0VfSEFORExFUiwgYXV0b0NvbmZpZyk7CiAgICAgICAgICAgICAgICBzYXRlbGxpdGUuaW5zdGFuY2Uuc2V0T3duZXIgPSB3YXJuT25BdXRvU2F0ZWxsaXRlT3duZXJDaGFuZ2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghYXV0bykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2F0ZWxsaXRlID09PSBOVUxMX1NBVEVMTElURSkgdGhpcy5zYXRlbGxpdGUgPSB7fTsKICAgICAgICAgICAgICAgIGF1dG8gPSB0aGlzLnNhdGVsbGl0ZS5fX2F1dG9fXyA9IHt9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhdXRvW25hbWVdID0gYXV0b0NvbmZpZzsKICAgICAgICAgICAgICBTQVRFTExJVEVfVVBEQVRFLmNhbGwoYXV0b0NvbmZpZywgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKCFhdXRvQ29uZmlnLmluc3RhbmNlICYmIG9sZFNhdGVsbGl0ZSkgdGhpcy5lbWl0X3NhdGVsbGl0ZUNoYW5nZWQobmFtZSwgb2xkU2F0ZWxsaXRlKTsKICAgICAgICAgICAgICBpZiAoZGVzdHJveVNhdGVsbGl0ZSkgewogICAgICAgICAgICAgICAgZGVsZXRlIGRlc3Ryb3lTYXRlbGxpdGUuZGVzdHJveTsKICAgICAgICAgICAgICAgIGRlc3Ryb3lTYXRlbGxpdGUuZGVzdHJveSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNhdGVsbGl0ZS5vd25lciAhPT0gdGhpcykgewogICAgICAgICAgICAgIGlmIChhdXRvQ29uZmlnICYmIGF1dG9Db25maWcuY29uZmlnLmRlbGVnYXRlKSB7CiAgICAgICAgICAgICAgICB2YXIgYXV0b0RlbGVnYXRlID0gc2F0ZWxsaXRlLmF1dG9EZWxlZ2F0ZTsKICAgICAgICAgICAgICAgIHNhdGVsbGl0ZS5hdXRvRGVsZWdhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHNhdGVsbGl0ZS5zZXRPd25lcih0aGlzKTsKICAgICAgICAgICAgICAgIHNhdGVsbGl0ZS5hdXRvRGVsZWdhdGUgPSBhdXRvRGVsZWdhdGU7CiAgICAgICAgICAgICAgfSBlbHNlIHNhdGVsbGl0ZS5zZXRPd25lcih0aGlzKTsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlLm93bmVyICE9PSB0aGlzKSByZXR1cm47CiAgICAgICAgICAgICAgaWYgKHNhdGVsbGl0ZUxpc3Rlbikgc2F0ZWxsaXRlLmFkZEhhbmRsZXIoc2F0ZWxsaXRlTGlzdGVuLCB0aGlzKTsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlUGVyc29uYWxMaXN0ZW4pIHNhdGVsbGl0ZS5hZGRIYW5kbGVyKHNhdGVsbGl0ZVBlcnNvbmFsTGlzdGVuLCB0aGlzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZSkgewogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuc2F0ZWxsaXRlW3NhdGVsbGl0ZS5vd25lclNhdGVsbGl0ZU5hbWVdOwogICAgICAgICAgICAgICAgdGhpcy5lbWl0X3NhdGVsbGl0ZUNoYW5nZWQoc2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZSwgc2F0ZWxsaXRlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc2F0ZWxsaXRlID09IE5VTExfU0FURUxMSVRFKSB0aGlzLnNhdGVsbGl0ZSA9IHt9OwogICAgICAgICAgICB0aGlzLnNhdGVsbGl0ZVtuYW1lXSA9IHNhdGVsbGl0ZTsKICAgICAgICAgICAgc2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmVtaXRfc2F0ZWxsaXRlQ2hhbmdlZChuYW1lLCBvbGRTYXRlbGxpdGUpOwogICAgICAgICAgaWYgKGRlc3Ryb3lTYXRlbGxpdGUpIHsKICAgICAgICAgICAgZGVsZXRlIGRlc3Ryb3lTYXRlbGxpdGUuZGVzdHJveTsKICAgICAgICAgICAgZGVzdHJveVNhdGVsbGl0ZS5kZXN0cm95KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBnZXRDaGlsZE5vZGVzRGF0YXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGNoaWxkTm9kZXNEYXRhc2V0TWFwW3RoaXMuYmFzaXNPYmplY3RJZF0gfHwgbmV3IENoaWxkTm9kZXNEYXRhc2V0KHsKICAgICAgICAgIHNvdXJjZU5vZGU6IHRoaXMKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UgfHwgdGhpcy5kYXRhU291cmNlQWRhcHRlcl8pIHsKICAgICAgICAgIHRoaXMuc2V0RGF0YVNvdXJjZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodGhpcy5maXJzdENoaWxkKSB0aGlzLmNsZWFyKCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnBhcmVudE5vZGUpIHRoaXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzKTsKICAgICAgICBpZiAodGhpcy5ncm91cGluZykgewogICAgICAgICAgdGhpcy5ncm91cGluZy5zZXRPd25lcigpOwogICAgICAgICAgdGhpcy5ncm91cGluZyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLm93bmVyKSB0aGlzLnNldE93bmVyKCk7CiAgICAgICAgdmFyIHNhdGVsbGl0ZXMgPSB0aGlzLnNhdGVsbGl0ZTsKICAgICAgICBpZiAoc2F0ZWxsaXRlcyAhPT0gTlVMTF9TQVRFTExJVEUpIHsKICAgICAgICAgIHZhciBhdXRvID0gc2F0ZWxsaXRlcy5fX2F1dG9fXzsKICAgICAgICAgIGRlbGV0ZSBzYXRlbGxpdGVzLl9fYXV0b19fOwogICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBhdXRvKSBpZiAoYXV0b1tuYW1lXS5jb25maWcuaW5zdGFuY2UgJiYgIWF1dG9bbmFtZV0uaW5zdGFuY2UpIGF1dG9bbmFtZV0uY29uZmlnLmluc3RhbmNlLmRlc3Ryb3koKTsKICAgICAgICAgIGZvciAodmFyIG5hbWUgaW4gc2F0ZWxsaXRlcykgewogICAgICAgICAgICB2YXIgc2F0ZWxsaXRlID0gc2F0ZWxsaXRlc1tuYW1lXTsKICAgICAgICAgICAgc2F0ZWxsaXRlLm93bmVyID0gbnVsbDsKICAgICAgICAgICAgc2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZSA9IG51bGw7CiAgICAgICAgICAgIGlmIChzYXRlbGxpdGUuZGVzdHJveSA9PT0gd2Fybk9uQXV0b1NhdGVsbGl0ZURlc3RveSkgZGVsZXRlIHNhdGVsbGl0ZS5kZXN0cm95OwogICAgICAgICAgICBzYXRlbGxpdGUuZGVzdHJveSgpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5zYXRlbGxpdGUgPSBudWxsOwogICAgICAgIH0KICAgICAgICB0aGlzLmNoaWxkTm9kZXMgPSBudWxsOwogICAgICAgIHRoaXMucGFyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgdGhpcy5wcmV2aW91c1NpYmxpbmcgPSBudWxsOwogICAgICAgIHRoaXMubmV4dFNpYmxpbmcgPSBudWxsOwogICAgICAgIHRoaXMuZmlyc3RDaGlsZCA9IG51bGw7CiAgICAgICAgdGhpcy5sYXN0Q2hpbGQgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBQYXJ0aXRpb25Ob2RlID0gQ2xhc3MoQWJzdHJhY3ROb2RlLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5QYXJ0aXRpb25Ob2RlIiwKICAgICAgYXV0b0Rlc3Ryb3lJZkVtcHR5OiBmYWxzZSwKICAgICAgbm9kZXM6IG51bGwsCiAgICAgIGZpcnN0OiBudWxsLAogICAgICBsYXN0OiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLm5vZGVzID0gW107CiAgICAgICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGluc2VydDogZnVuY3Rpb24obmV3Tm9kZSwgcmVmTm9kZSkgewogICAgICAgIHZhciBub2RlcyA9IHRoaXMubm9kZXM7CiAgICAgICAgdmFyIHBvcyA9IHJlZk5vZGUgPyBub2Rlcy5pbmRleE9mKHJlZk5vZGUpIDogLTE7CiAgICAgICAgaWYgKHBvcyA9PSAtMSkgewogICAgICAgICAgbm9kZXMucHVzaChuZXdOb2RlKTsKICAgICAgICAgIHRoaXMubGFzdCA9IG5ld05vZGU7CiAgICAgICAgfSBlbHNlIG5vZGVzLnNwbGljZShwb3MsIDAsIG5ld05vZGUpOwogICAgICAgIHRoaXMuZmlyc3QgPSBub2Rlc1swXTsKICAgICAgICBuZXdOb2RlLmdyb3VwTm9kZSA9IHRoaXM7CiAgICAgICAgdGhpcy5lbWl0X2NoaWxkTm9kZXNNb2RpZmllZCh7CiAgICAgICAgICBpbnNlcnRlZDogWyBuZXdOb2RlIF0KICAgICAgICB9KTsKICAgICAgfSwKICAgICAgcmVtb3ZlOiBmdW5jdGlvbihvbGROb2RlKSB7CiAgICAgICAgdmFyIG5vZGVzID0gdGhpcy5ub2RlczsKICAgICAgICBpZiAoYXJyYXlSZW1vdmUobm9kZXMsIG9sZE5vZGUpKSB7CiAgICAgICAgICB0aGlzLmZpcnN0ID0gbm9kZXNbMF0gfHwgbnVsbDsKICAgICAgICAgIHRoaXMubGFzdCA9IG5vZGVzW25vZGVzLmxlbmd0aCAtIDFdIHx8IG51bGw7CiAgICAgICAgICBvbGROb2RlLmdyb3VwTm9kZSA9IG51bGw7CiAgICAgICAgICB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKHsKICAgICAgICAgICAgZGVsZXRlZDogWyBvbGROb2RlIF0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuZmlyc3QgJiYgdGhpcy5hdXRvRGVzdHJveUlmRW1wdHkpIHRoaXMuZGVzdHJveSgpOwogICAgICB9LAogICAgICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLmZpcnN0KSByZXR1cm47CiAgICAgICAgdmFyIG5vZGVzID0gdGhpcy5ub2RlczsKICAgICAgICBmb3IgKHZhciBpID0gbm9kZXMubGVuZ3RoOyBpLS0gPiAwOyApIG5vZGVzW2ldLmdyb3VwTm9kZSA9IG51bGw7CiAgICAgICAgdGhpcy5ub2RlcyA9IFtdOwogICAgICAgIHRoaXMuZmlyc3QgPSBudWxsOwogICAgICAgIHRoaXMubGFzdCA9IG51bGw7CiAgICAgICAgdGhpcy5lbWl0X2NoaWxkTm9kZXNNb2RpZmllZCh7CiAgICAgICAgICBkZWxldGVkOiBub2RlcwogICAgICAgIH0pOwogICAgICAgIGlmICh0aGlzLmF1dG9EZXN0cm95SWZFbXB0eSkgdGhpcy5kZXN0cm95KCk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIEFic3RyYWN0Tm9kZS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMubm9kZXMgPSBudWxsOwogICAgICAgIHRoaXMuZmlyc3QgPSBudWxsOwogICAgICAgIHRoaXMubGFzdCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIERPTU1JWElOX0RBVEFTT1VSQ0VfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihkYXRhU291cmNlLCBkZWx0YSkgewogICAgICAgIHZhciBuZXdEZWx0YSA9IHt9OwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgaWYgKGRlbHRhLmRlbGV0ZWQpIHsKICAgICAgICAgIG5ld0RlbHRhLmRlbGV0ZWQgPSBkZWxldGVkOwogICAgICAgICAgaWYgKHRoaXMuY2hpbGROb2Rlcy5sZW5ndGggPT0gZGVsdGEuZGVsZXRlZC5sZW5ndGgpIHsKICAgICAgICAgICAgZGVsZXRlZCA9IGFycmF5RnJvbSh0aGlzLmNoaWxkTm9kZXMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gZGVsZXRlZFtpXTsgaSsrKSB1bmxvY2tEYXRhU291cmNlSXRlbU5vZGUoY2hpbGQpOwogICAgICAgICAgICB2YXIgdG1wID0gdGhpcy5kYXRhU291cmNlOwogICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2UgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNsZWFyKHRydWUpOwogICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2UgPSB0bXA7CiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZU1hcF8gPSB7fTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gZGVsdGEuZGVsZXRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGRlbGVnYXRlSWQgPSBpdGVtLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgdmFyIG9sZENoaWxkID0gdGhpcy5kYXRhU291cmNlTWFwX1tkZWxlZ2F0ZUlkXTsKICAgICAgICAgICAgICB1bmxvY2tEYXRhU291cmNlSXRlbU5vZGUob2xkQ2hpbGQpOwogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmRhdGFTb3VyY2VNYXBfW2RlbGVnYXRlSWRdOwogICAgICAgICAgICAgIHRoaXMucmVtb3ZlQ2hpbGQob2xkQ2hpbGQpOwogICAgICAgICAgICAgIGRlbGV0ZWQucHVzaChvbGRDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhLmluc2VydGVkKSB7CiAgICAgICAgICBuZXdEZWx0YS5pbnNlcnRlZCA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBkZWx0YS5pbnNlcnRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZUNoaWxkQnlGYWN0b3J5KHRoaXMsIHsKICAgICAgICAgICAgICBkZWxlZ2F0ZTogaXRlbQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbG9ja0RhdGFTb3VyY2VJdGVtTm9kZShuZXdDaGlsZCk7CiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZU1hcF9baXRlbS5iYXNpc09iamVjdElkXSA9IG5ld0NoaWxkOwogICAgICAgICAgICBuZXdEZWx0YS5pbnNlcnRlZC5wdXNoKG5ld0NoaWxkKTsKICAgICAgICAgICAgaWYgKHRoaXMuZmlyc3RDaGlsZCkgdGhpcy5pbnNlcnRCZWZvcmUobmV3Q2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuZmlyc3RDaGlsZCkgdGhpcy5zZXRDaGlsZE5vZGVzKG5ld0RlbHRhLmluc2VydGVkKTsgZWxzZSB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKG5ld0RlbHRhKTsKICAgICAgICBpZiAodGhpcy5kZXN0cm95RGF0YVNvdXJjZU1lbWJlciAmJiBkZWxldGVkLmxlbmd0aCkgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBkZWxldGVkW2ldOyBpKyspIGl0ZW0uZGVzdHJveSgpOwogICAgICB9LAogICAgICBzdGF0ZUNoYW5nZWQ6IGZ1bmN0aW9uKGRhdGFTb3VyY2UpIHsKICAgICAgICB0aGlzLnNldENoaWxkTm9kZXNTdGF0ZShkYXRhU291cmNlLnN0YXRlLCBkYXRhU291cmNlLnN0YXRlLmRhdGEpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbihkYXRhU291cmNlKSB7CiAgICAgICAgaWYgKCF0aGlzLmRhdGFTb3VyY2VBZGFwdGVyXykgdGhpcy5zZXREYXRhU291cmNlKCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgTUlYSU5fREFUQVNPVVJDRV9XUkFQUEVSX0hBTkRMRVIgPSB7CiAgICAgIGRhdGFzZXRDaGFuZ2VkOiBmdW5jdGlvbih3cmFwcGVyKSB7CiAgICAgICAgdGhpcy5zZXREYXRhU291cmNlKHdyYXBwZXIpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNldERhdGFTb3VyY2UoKTsKICAgICAgfQogICAgfTsKICAgIGZ1bmN0aW9uIGZhc3RDaGlsZE5vZGVzT3JkZXIobm9kZSwgb3JkZXIpIHsKICAgICAgdmFyIGxhc3RJbmRleCA9IG9yZGVyLmxlbmd0aCAtIDE7CiAgICAgIG5vZGUuY2hpbGROb2RlcyA9IG9yZGVyOwogICAgICBub2RlLmZpcnN0Q2hpbGQgPSBvcmRlclswXSB8fCBudWxsOwogICAgICBub2RlLmxhc3RDaGlsZCA9IG9yZGVyW2xhc3RJbmRleF0gfHwgbnVsbDsKICAgICAgZm9yICh2YXIgb3JkZXJOb2RlLCBpID0gbGFzdEluZGV4OyBvcmRlck5vZGUgPSBvcmRlcltpXTsgaS0tKSB7CiAgICAgICAgb3JkZXJOb2RlLm5leHRTaWJsaW5nID0gb3JkZXJbaSArIDFdIHx8IG51bGw7CiAgICAgICAgb3JkZXJOb2RlLnByZXZpb3VzU2libGluZyA9IG9yZGVyW2kgLSAxXSB8fCBudWxsOwogICAgICAgIG5vZGUuaW5zZXJ0QmVmb3JlKG9yZGVyTm9kZSwgb3JkZXJOb2RlLm5leHRTaWJsaW5nKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZmFzdENoaWxkTm9kZXNHcm91cE9yZGVyKG5vZGUsIG9yZGVyKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBvcmRlcltpXTsgaSsrKSBjaGlsZC5ncm91cE5vZGUubm9kZXMucHVzaChjaGlsZCk7CiAgICAgIG9yZGVyLmxlbmd0aCA9IDA7CiAgICAgIGZvciAodmFyIGdyb3VwID0gbm9kZS5ncm91cGluZy5udWxsR3JvdXA7IGdyb3VwOyBncm91cCA9IGdyb3VwLm5leHRTaWJsaW5nKSB7CiAgICAgICAgdmFyIG5vZGVzID0gZ3JvdXAubm9kZXM7CiAgICAgICAgZ3JvdXAuZmlyc3QgPSBub2Rlc1swXSB8fCBudWxsOwogICAgICAgIGdyb3VwLmxhc3QgPSBub2Rlc1tub2Rlcy5sZW5ndGggLSAxXSB8fCBudWxsOwogICAgICAgIG9yZGVyLnB1c2guYXBwbHkob3JkZXIsIG5vZGVzKTsKICAgICAgICBncm91cC5lbWl0X2NoaWxkTm9kZXNNb2RpZmllZCh7CiAgICAgICAgICBpbnNlcnRlZDogbm9kZXMKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gb3JkZXI7CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVDaGlsZEJ5RmFjdG9yeShub2RlLCBjb25maWcpIHsKICAgICAgdmFyIGNoaWxkOwogICAgICBpZiAodHlwZW9mIG5vZGUuY2hpbGRGYWN0b3J5ID09ICJmdW5jdGlvbiIpIHsKICAgICAgICBjaGlsZCA9IG5vZGUuY2hpbGRGYWN0b3J5KGNvbmZpZyk7CiAgICAgICAgaWYgKGNoaWxkIGluc3RhbmNlb2Ygbm9kZS5jaGlsZENsYXNzKSByZXR1cm4gY2hpbGQ7CiAgICAgIH0KICAgICAgaWYgKCFjaGlsZCkgdGhyb3cgRVhDRVBUSU9OX05VTExfQ0hJTEQ7CiAgICAgIGJhc2lzLmRldi53YXJuKEVYQ0VQVElPTl9CQURfQ0hJTERfQ0xBU1MgKyAiIChleHBlY3RlZCAiICsgKG5vZGUuY2hpbGRDbGFzcyAmJiBub2RlLmNoaWxkQ2xhc3MuY2xhc3NOYW1lKSArICIgYnV0ICIgKyAoY2hpbGQgJiYgY2hpbGQuY29uc3RydWN0b3IgJiYgY2hpbGQuY29uc3RydWN0b3IuY2xhc3NOYW1lKSArICIpIik7CiAgICAgIHRocm93IEVYQ0VQVElPTl9CQURfQ0hJTERfQ0xBU1M7CiAgICB9CiAgICB2YXIgRG9tTWl4aW4gPSB7CiAgICAgIGNoaWxkQ2xhc3M6IEFic3RyYWN0Tm9kZSwKICAgICAgY2hpbGRGYWN0b3J5OiBudWxsLAogICAgICBsaXN0ZW46IHsKICAgICAgICBkYXRhU291cmNlOiBET01NSVhJTl9EQVRBU09VUkNFX0hBTkRMRVIKICAgICAgfSwKICAgICAgZ2V0Q2hpbGQ6IGZ1bmN0aW9uKHZhbHVlLCBnZXR0ZXIpIHsKICAgICAgICByZXR1cm4gYmFzaXMuYXJyYXkuc2VhcmNoKHRoaXMuY2hpbGROb2RlcywgdmFsdWUsIGdldHRlcik7CiAgICAgIH0sCiAgICAgIGdldENoaWxkQnlOYW1lOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2hpbGQobmFtZSwgIm5hbWUiKTsKICAgICAgfSwKICAgICAgYXBwZW5kQ2hpbGQ6IGZ1bmN0aW9uKG5ld0NoaWxkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5zZXJ0QmVmb3JlKG5ld0NoaWxkKTsKICAgICAgfSwKICAgICAgaW5zZXJ0QmVmb3JlOiBmdW5jdGlvbihuZXdDaGlsZCwgcmVmQ2hpbGQpIHsKICAgICAgICBpZiAoIXRoaXMuY2hpbGRDbGFzcykgdGhyb3cgRVhDRVBUSU9OX05PX0NISUxEQ0xBU1M7CiAgICAgICAgaWYgKG5ld0NoaWxkLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgIGlmIChjdXJzb3IgPT09IG5ld0NoaWxkKSB0aHJvdyBFWENFUFRJT05fQ0FOVF9JTlNFUlQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0NoaWxkQ2xhc3NJbnN0YW5jZSA9IG5ld0NoaWxkICYmIG5ld0NoaWxkIGluc3RhbmNlb2YgdGhpcy5jaGlsZENsYXNzOwogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UpIHsKICAgICAgICAgIGlmICghaXNDaGlsZENsYXNzSW5zdGFuY2UgfHwgIW5ld0NoaWxkLmRlbGVnYXRlIHx8IHRoaXMuZGF0YVNvdXJjZU1hcF9bbmV3Q2hpbGQuZGVsZWdhdGUuYmFzaXNPYmplY3RJZF0gIT09IG5ld0NoaWxkKSB0aHJvdyBFWENFUFRJT05fREFUQVNPVVJDRV9DT05GTElDVDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZUFkYXB0ZXJfKSB0aHJvdyBFWENFUFRJT05fREFUQVNPVVJDRUFEQVBURVJfQ09ORkxJQ1Q7CiAgICAgICAgfQogICAgICAgIGlmICghaXNDaGlsZENsYXNzSW5zdGFuY2UpIG5ld0NoaWxkID0gY3JlYXRlQ2hpbGRCeUZhY3RvcnkodGhpcywgbmV3Q2hpbGQgaW5zdGFuY2VvZiBEYXRhT2JqZWN0ID8gewogICAgICAgICAgZGVsZWdhdGU6IG5ld0NoaWxkCiAgICAgICAgfSA6IG5ld0NoaWxkKTsKICAgICAgICBpZiAobmV3Q2hpbGQub3duZXIpIHRocm93IEVYQ0VQVElPTl9QQVJFTlROT0RFX09XTkVSX0NPTkZMSUNUOwogICAgICAgIHZhciBpc0luc2lkZSA9IG5ld0NoaWxkLnBhcmVudE5vZGUgPT09IHRoaXM7CiAgICAgICAgdmFyIGNoaWxkTm9kZXMgPSB0aGlzLmNoaWxkTm9kZXM7CiAgICAgICAgdmFyIGdyb3VwaW5nID0gdGhpcy5ncm91cGluZzsKICAgICAgICB2YXIgZ3JvdXBOb2RlczsKICAgICAgICB2YXIgY3VycmVudE5ld0NoaWxkR3JvdXAgPSBuZXdDaGlsZC5ncm91cE5vZGU7CiAgICAgICAgdmFyIGdyb3VwID0gbnVsbDsKICAgICAgICB2YXIgc29ydGluZyA9IHRoaXMuc29ydGluZzsKICAgICAgICB2YXIgc29ydGluZ0Rlc2M7CiAgICAgICAgdmFyIGNvcnJlY3RTb3J0UG9zID0gZmFsc2U7CiAgICAgICAgdmFyIG5ld0NoaWxkVmFsdWU7CiAgICAgICAgdmFyIHBvcyA9IC0xOwogICAgICAgIHZhciBuZXh0U2libGluZzsKICAgICAgICB2YXIgcHJldlNpYmxpbmc7CiAgICAgICAgaWYgKGlzSW5zaWRlKSB7CiAgICAgICAgICBuZXh0U2libGluZyA9IG5ld0NoaWxkLm5leHRTaWJsaW5nOwogICAgICAgICAgcHJldlNpYmxpbmcgPSBuZXdDaGlsZC5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgfQogICAgICAgIGlmIChzb3J0aW5nICE9PSBudWxsR2V0dGVyKSB7CiAgICAgICAgICByZWZDaGlsZCA9IG51bGw7CiAgICAgICAgICBzb3J0aW5nRGVzYyA9IHRoaXMuc29ydGluZ0Rlc2M7CiAgICAgICAgICBuZXdDaGlsZFZhbHVlID0gc29ydGluZyhuZXdDaGlsZCkgfHwgMDsKICAgICAgICAgIGlmIChpc0luc2lkZSkgewogICAgICAgICAgICBpZiAobmV3Q2hpbGRWYWx1ZSA9PT0gbmV3Q2hpbGQuc29ydGluZ1ZhbHVlKSB7CiAgICAgICAgICAgICAgY29ycmVjdFNvcnRQb3MgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICgoIW5leHRTaWJsaW5nIHx8IChzb3J0aW5nRGVzYyA/IG5leHRTaWJsaW5nLnNvcnRpbmdWYWx1ZSA8PSBuZXdDaGlsZFZhbHVlIDogbmV4dFNpYmxpbmcuc29ydGluZ1ZhbHVlID49IG5ld0NoaWxkVmFsdWUpKSAmJiAoIXByZXZTaWJsaW5nIHx8IChzb3J0aW5nRGVzYyA/IHByZXZTaWJsaW5nLnNvcnRpbmdWYWx1ZSA+PSBuZXdDaGlsZFZhbHVlIDogcHJldlNpYmxpbmcuc29ydGluZ1ZhbHVlIDw9IG5ld0NoaWxkVmFsdWUpKSkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGQuc29ydGluZ1ZhbHVlID0gbmV3Q2hpbGRWYWx1ZTsKICAgICAgICAgICAgICAgIGNvcnJlY3RTb3J0UG9zID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGdyb3VwaW5nKSB7CiAgICAgICAgICB2YXIgY3Vyc29yOwogICAgICAgICAgZ3JvdXAgPSBncm91cGluZy5nZXRHcm91cE5vZGUobmV3Q2hpbGQsIHRydWUpOwogICAgICAgICAgZ3JvdXBOb2RlcyA9IGdyb3VwLm5vZGVzOwogICAgICAgICAgaWYgKGN1cnJlbnROZXdDaGlsZEdyb3VwID09PSBncm91cCkgaWYgKGNvcnJlY3RTb3J0UG9zIHx8IHNvcnRpbmcgPT09IG51bGxHZXR0ZXIgJiYgbmV4dFNpYmxpbmcgPT09IHJlZkNoaWxkKSByZXR1cm4gbmV3Q2hpbGQ7CiAgICAgICAgICBpZiAoc29ydGluZyAhPT0gbnVsbEdldHRlcikgewogICAgICAgICAgICBpZiAoY3VycmVudE5ld0NoaWxkR3JvdXAgPT09IGdyb3VwICYmIGNvcnJlY3RTb3J0UG9zKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRTaWJsaW5nICYmIG5leHRTaWJsaW5nLmdyb3VwTm9kZSA9PT0gZ3JvdXApIHBvcyA9IGdyb3VwTm9kZXMuaW5kZXhPZihuZXh0U2libGluZyk7IGVsc2UgcG9zID0gZ3JvdXBOb2Rlcy5sZW5ndGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcG9zID0gYmluYXJ5U2VhcmNoUG9zKGdyb3VwTm9kZXMsIG5ld0NoaWxkVmFsdWUsIHNvcnRpbmdTZWFyY2gsIHNvcnRpbmdEZXNjKTsKICAgICAgICAgICAgICBuZXdDaGlsZC5zb3J0aW5nVmFsdWUgPSBuZXdDaGlsZFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAocmVmQ2hpbGQgJiYgcmVmQ2hpbGQuZ3JvdXBOb2RlID09PSBncm91cCkgcG9zID0gZ3JvdXBOb2Rlcy5pbmRleE9mKHJlZkNoaWxkKTsgZWxzZSBwb3MgPSBncm91cE5vZGVzLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwb3MgPCBncm91cE5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICByZWZDaGlsZCA9IGdyb3VwTm9kZXNbcG9zXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChncm91cC5sYXN0KSB7CiAgICAgICAgICAgICAgcmVmQ2hpbGQgPSBncm91cC5sYXN0Lm5leHRTaWJsaW5nOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGN1cnNvciA9IGdyb3VwOwogICAgICAgICAgICAgIHJlZkNoaWxkID0gbnVsbDsKICAgICAgICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLm5leHRTaWJsaW5nKSBpZiAocmVmQ2hpbGQgPSBjdXJzb3IuZmlyc3QpIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmV3Q2hpbGQgPT09IHJlZkNoaWxkIHx8IGlzSW5zaWRlICYmIG5leHRTaWJsaW5nID09PSByZWZDaGlsZCkgewogICAgICAgICAgICBpZiAoY3VycmVudE5ld0NoaWxkR3JvdXAgIT09IGdyb3VwKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnROZXdDaGlsZEdyb3VwKSBjdXJyZW50TmV3Q2hpbGRHcm91cC5yZW1vdmUobmV3Q2hpbGQpOwogICAgICAgICAgICAgIGdyb3VwLmluc2VydChuZXdDaGlsZCwgcmVmQ2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHBvcyA9IC0xOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoc29ydGluZyAhPT0gbnVsbEdldHRlcikgewogICAgICAgICAgICBpZiAoY29ycmVjdFNvcnRQb3MpIHJldHVybiBuZXdDaGlsZDsKICAgICAgICAgICAgcG9zID0gYmluYXJ5U2VhcmNoUG9zKGNoaWxkTm9kZXMsIG5ld0NoaWxkVmFsdWUsIHNvcnRpbmdTZWFyY2gsIHNvcnRpbmdEZXNjKTsKICAgICAgICAgICAgcmVmQ2hpbGQgPSBjaGlsZE5vZGVzW3Bvc107CiAgICAgICAgICAgIG5ld0NoaWxkLnNvcnRpbmdWYWx1ZSA9IG5ld0NoaWxkVmFsdWU7CiAgICAgICAgICAgIGlmIChuZXdDaGlsZCA9PT0gcmVmQ2hpbGQgfHwgaXNJbnNpZGUgJiYgbmV4dFNpYmxpbmcgPT09IHJlZkNoaWxkKSByZXR1cm4gbmV3Q2hpbGQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAocmVmQ2hpbGQgJiYgcmVmQ2hpbGQucGFyZW50Tm9kZSAhPT0gdGhpcykgdGhyb3cgRVhDRVBUSU9OX05PREVfTk9UX0ZPVU5EOwogICAgICAgICAgICBpZiAoaXNJbnNpZGUpIHsKICAgICAgICAgICAgICBpZiAobmV4dFNpYmxpbmcgPT09IHJlZkNoaWxkKSByZXR1cm4gbmV3Q2hpbGQ7CiAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkID09PSByZWZDaGlsZCkgdGhyb3cgRVhDRVBUSU9OX0NBTlRfSU5TRVJUOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpc0luc2lkZSkgewogICAgICAgICAgaWYgKG5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgIG5leHRTaWJsaW5nLnByZXZpb3VzU2libGluZyA9IHByZXZTaWJsaW5nOwogICAgICAgICAgICBuZXdDaGlsZC5uZXh0U2libGluZyA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgdGhpcy5sYXN0Q2hpbGQgPSBwcmV2U2libGluZzsKICAgICAgICAgIGlmIChwcmV2U2libGluZykgewogICAgICAgICAgICBwcmV2U2libGluZy5uZXh0U2libGluZyA9IG5leHRTaWJsaW5nOwogICAgICAgICAgICBuZXdDaGlsZC5wcmV2aW91c1NpYmxpbmcgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHRoaXMuZmlyc3RDaGlsZCA9IG5leHRTaWJsaW5nOwogICAgICAgICAgaWYgKHBvcyA9PSAtMSkgYXJyYXlSZW1vdmUoY2hpbGROb2RlcywgbmV3Q2hpbGQpOyBlbHNlIHsKICAgICAgICAgICAgdmFyIG9sZFBvcyA9IGNoaWxkTm9kZXMuaW5kZXhPZihuZXdDaGlsZCk7CiAgICAgICAgICAgIGNoaWxkTm9kZXMuc3BsaWNlKG9sZFBvcywgMSk7CiAgICAgICAgICAgIHBvcyAtPSBvbGRQb3MgPCBwb3M7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudE5ld0NoaWxkR3JvdXApIHsKICAgICAgICAgICAgY3VycmVudE5ld0NoaWxkR3JvdXAucmVtb3ZlKG5ld0NoaWxkKTsKICAgICAgICAgICAgY3VycmVudE5ld0NoaWxkR3JvdXAgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAobmV3Q2hpbGQucGFyZW50Tm9kZSkgbmV3Q2hpbGQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuZXdDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGlmIChjdXJyZW50TmV3Q2hpbGRHcm91cCAhPSBncm91cCkgZ3JvdXAuaW5zZXJ0KG5ld0NoaWxkLCByZWZDaGlsZCk7CiAgICAgICAgaWYgKHJlZkNoaWxkKSB7CiAgICAgICAgICBpZiAocG9zID09IC0xKSBwb3MgPSBjaGlsZE5vZGVzLmluZGV4T2YocmVmQ2hpbGQpOwogICAgICAgICAgaWYgKHBvcyA9PSAtMSkgdGhyb3cgRVhDRVBUSU9OX05PREVfTk9UX0ZPVU5EOwogICAgICAgICAgbmV3Q2hpbGQubmV4dFNpYmxpbmcgPSByZWZDaGlsZDsKICAgICAgICAgIGNoaWxkTm9kZXMuc3BsaWNlKHBvcywgMCwgbmV3Q2hpbGQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwb3MgPSBjaGlsZE5vZGVzLmxlbmd0aDsKICAgICAgICAgIGNoaWxkTm9kZXMucHVzaChuZXdDaGlsZCk7CiAgICAgICAgICByZWZDaGlsZCA9IHsKICAgICAgICAgICAgcHJldmlvdXNTaWJsaW5nOiB0aGlzLmxhc3RDaGlsZAogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMubGFzdENoaWxkID0gbmV3Q2hpbGQ7CiAgICAgICAgfQogICAgICAgIG5ld0NoaWxkLnBhcmVudE5vZGUgPSB0aGlzOwogICAgICAgIG5ld0NoaWxkLnByZXZpb3VzU2libGluZyA9IHJlZkNoaWxkLnByZXZpb3VzU2libGluZzsKICAgICAgICBpZiAocG9zID09IDApIHRoaXMuZmlyc3RDaGlsZCA9IG5ld0NoaWxkOyBlbHNlIHJlZkNoaWxkLnByZXZpb3VzU2libGluZy5uZXh0U2libGluZyA9IG5ld0NoaWxkOwogICAgICAgIHJlZkNoaWxkLnByZXZpb3VzU2libGluZyA9IG5ld0NoaWxkOwogICAgICAgIGlmICghaXNJbnNpZGUpIHsKICAgICAgICAgIHVwZGF0ZU5vZGVDb250ZXh0U2VsZWN0aW9uKG5ld0NoaWxkLCBuZXdDaGlsZC5jb250ZXh0U2VsZWN0aW9uLCB0aGlzLnNlbGVjdGlvbiB8fCB0aGlzLmNvbnRleHRTZWxlY3Rpb24sIHRydWUpOwogICAgICAgICAgdXBkYXRlTm9kZURpc2FibGVDb250ZXh0KG5ld0NoaWxkLCB0aGlzLmRpc2FibGVkIHx8IHRoaXMuY29udGV4dERpc2FibGVkKTsKICAgICAgICAgIGlmICgobmV3Q2hpbGQudW5kZXJNYXRjaF8gfHwgdGhpcy5tYXRjaEZ1bmN0aW9uKSAmJiBuZXdDaGlsZC5tYXRjaCkgbmV3Q2hpbGQubWF0Y2godGhpcy5tYXRjaEZ1bmN0aW9uKTsKICAgICAgICAgIGlmIChuZXdDaGlsZC5hdXRvRGVsZWdhdGUgPT0gREVMRUdBVEUuUEFSRU5UIHx8IG5ld0NoaWxkLmF1dG9EZWxlZ2F0ZSA9PT0gREVMRUdBVEUuQU5ZKSBuZXdDaGlsZC5zZXREZWxlZ2F0ZSh0aGlzKTsKICAgICAgICAgIGlmICghdGhpcy5kYXRhU291cmNlKSB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKHsKICAgICAgICAgICAgaW5zZXJ0ZWQ6IFsgbmV3Q2hpbGQgXQogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAobmV3Q2hpbGQubGlzdGVuLnBhcmVudE5vZGUpIHRoaXMuYWRkSGFuZGxlcihuZXdDaGlsZC5saXN0ZW4ucGFyZW50Tm9kZSwgbmV3Q2hpbGQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3Q2hpbGQ7CiAgICAgIH0sCiAgICAgIHJlbW92ZUNoaWxkOiBmdW5jdGlvbihvbGRDaGlsZCkgewogICAgICAgIGlmICghb2xkQ2hpbGQgfHwgb2xkQ2hpbGQucGFyZW50Tm9kZSAhPT0gdGhpcykgdGhyb3cgRVhDRVBUSU9OX05PREVfTk9UX0ZPVU5EOwogICAgICAgIGlmIChvbGRDaGlsZCBpbnN0YW5jZW9mIHRoaXMuY2hpbGRDbGFzcyA9PSBmYWxzZSkgdGhyb3cgRVhDRVBUSU9OX0JBRF9DSElMRF9DTEFTUzsKICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlKSB7CiAgICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlLmhhcyhvbGRDaGlsZC5kZWxlZ2F0ZSkpIHRocm93IEVYQ0VQVElPTl9EQVRBU09VUkNFX0NPTkZMSUNUOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlQWRhcHRlcl8pIHRocm93IEVYQ0VQVElPTl9EQVRBU09VUkNFQURBUFRFUl9DT05GTElDVDsKICAgICAgICB9CiAgICAgICAgdmFyIHBvcyA9IHRoaXMuY2hpbGROb2Rlcy5pbmRleE9mKG9sZENoaWxkKTsKICAgICAgICBpZiAocG9zID09IC0xKSB0aHJvdyBFWENFUFRJT05fTk9ERV9OT1RfRk9VTkQ7CiAgICAgICAgdGhpcy5jaGlsZE5vZGVzLnNwbGljZShwb3MsIDEpOwogICAgICAgIG9sZENoaWxkLnBhcmVudE5vZGUgPSBudWxsOwogICAgICAgIGlmIChvbGRDaGlsZC5uZXh0U2libGluZykgb2xkQ2hpbGQubmV4dFNpYmxpbmcucHJldmlvdXNTaWJsaW5nID0gb2xkQ2hpbGQucHJldmlvdXNTaWJsaW5nOyBlbHNlIHRoaXMubGFzdENoaWxkID0gb2xkQ2hpbGQucHJldmlvdXNTaWJsaW5nOwogICAgICAgIGlmIChvbGRDaGlsZC5wcmV2aW91c1NpYmxpbmcpIG9sZENoaWxkLnByZXZpb3VzU2libGluZy5uZXh0U2libGluZyA9IG9sZENoaWxkLm5leHRTaWJsaW5nOyBlbHNlIHRoaXMuZmlyc3RDaGlsZCA9IG9sZENoaWxkLm5leHRTaWJsaW5nOwogICAgICAgIG9sZENoaWxkLm5leHRTaWJsaW5nID0gbnVsbDsKICAgICAgICBvbGRDaGlsZC5wcmV2aW91c1NpYmxpbmcgPSBudWxsOwogICAgICAgIGlmIChvbGRDaGlsZC5saXN0ZW4ucGFyZW50Tm9kZSkgdGhpcy5yZW1vdmVIYW5kbGVyKG9sZENoaWxkLmxpc3Rlbi5wYXJlbnROb2RlLCBvbGRDaGlsZCk7CiAgICAgICAgdXBkYXRlTm9kZUNvbnRleHRTZWxlY3Rpb24ob2xkQ2hpbGQsIG9sZENoaWxkLmNvbnRleHRTZWxlY3Rpb24sIG51bGwsIHRydWUpOwogICAgICAgIGlmIChvbGRDaGlsZC5ncm91cE5vZGUpIG9sZENoaWxkLmdyb3VwTm9kZS5yZW1vdmUob2xkQ2hpbGQpOwogICAgICAgIGlmICghdGhpcy5kYXRhU291cmNlKSB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKHsKICAgICAgICAgIGRlbGV0ZWQ6IFsgb2xkQ2hpbGQgXQogICAgICAgIH0pOwogICAgICAgIGlmIChvbGRDaGlsZC5hdXRvRGVsZWdhdGUgPT0gREVMRUdBVEUuUEFSRU5UIHx8IG9sZENoaWxkLmF1dG9EZWxlZ2F0ZSA9PT0gREVMRUdBVEUuQU5ZKSBvbGRDaGlsZC5zZXREZWxlZ2F0ZSgpOwogICAgICAgIHJldHVybiBvbGRDaGlsZDsKICAgICAgfSwKICAgICAgcmVwbGFjZUNoaWxkOiBmdW5jdGlvbihuZXdDaGlsZCwgb2xkQ2hpbGQpIHsKICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlKSB0aHJvdyBFWENFUFRJT05fREFUQVNPVVJDRV9DT05GTElDVDsKICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlQWRhcHRlcl8pIHRocm93IEVYQ0VQVElPTl9EQVRBU09VUkNFQURBUFRFUl9DT05GTElDVDsKICAgICAgICBpZiAob2xkQ2hpbGQgPT0gbnVsbCB8fCBvbGRDaGlsZC5wYXJlbnROb2RlICE9PSB0aGlzKSB0aHJvdyBFWENFUFRJT05fTk9ERV9OT1RfRk9VTkQ7CiAgICAgICAgdGhpcy5pbnNlcnRCZWZvcmUobmV3Q2hpbGQsIG9sZENoaWxkKTsKICAgICAgICByZXR1cm4gdGhpcy5yZW1vdmVDaGlsZChvbGRDaGlsZCk7CiAgICAgIH0sCiAgICAgIGNsZWFyOiBmdW5jdGlvbihhbGl2ZSkgewogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UgJiYgdGhpcy5kYXRhU291cmNlLml0ZW1Db3VudCkgdGhyb3cgRVhDRVBUSU9OX0RBVEFTT1VSQ0VfQ09ORkxJQ1Q7CiAgICAgICAgaWYgKCF0aGlzLmZpcnN0Q2hpbGQpIHJldHVybjsKICAgICAgICBpZiAoYWxpdmUpIHVwZGF0ZU5vZGVDb250ZXh0U2VsZWN0aW9uKHRoaXMsIHRoaXMuc2VsZWN0aW9uIHx8IHRoaXMuY29udGV4dFNlbGVjdGlvbiwgbnVsbCwgZmFsc2UsIHRydWUpOwogICAgICAgIHZhciBjaGlsZE5vZGVzID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgIHRoaXMuZmlyc3RDaGlsZCA9IG51bGw7CiAgICAgICAgdGhpcy5sYXN0Q2hpbGQgPSBudWxsOwogICAgICAgIHRoaXMuY2hpbGROb2RlcyA9IFtdOwogICAgICAgIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQoewogICAgICAgICAgZGVsZXRlZDogY2hpbGROb2RlcwogICAgICAgIH0pOwogICAgICAgIGZvciAodmFyIGkgPSBjaGlsZE5vZGVzLmxlbmd0aDsgaS0tID4gMDsgKSB7CiAgICAgICAgICB2YXIgY2hpbGQgPSBjaGlsZE5vZGVzW2ldOwogICAgICAgICAgaWYgKGNoaWxkLmxpc3Rlbi5wYXJlbnROb2RlKSBjaGlsZC5wYXJlbnROb2RlLnJlbW92ZUhhbmRsZXIoY2hpbGQubGlzdGVuLnBhcmVudE5vZGUsIGNoaWxkKTsKICAgICAgICAgIGNoaWxkLnBhcmVudE5vZGUgPSBudWxsOwogICAgICAgICAgY2hpbGQuZ3JvdXBOb2RlID0gbnVsbDsKICAgICAgICAgIGlmIChhbGl2ZSkgewogICAgICAgICAgICBjaGlsZC5uZXh0U2libGluZyA9IG51bGw7CiAgICAgICAgICAgIGNoaWxkLnByZXZpb3VzU2libGluZyA9IG51bGw7CiAgICAgICAgICAgIGlmIChjaGlsZC5hdXRvRGVsZWdhdGUgPT0gREVMRUdBVEUuUEFSRU5UIHx8IGNoaWxkLmF1dG9EZWxlZ2F0ZSA9PT0gREVMRUdBVEUuQU5ZKSBjaGlsZC5zZXREZWxlZ2F0ZSgpOwogICAgICAgICAgfSBlbHNlIGNoaWxkLmRlc3Ryb3koKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuZ3JvdXBpbmcpIHsKICAgICAgICAgIGZvciAodmFyIGNoaWxkTm9kZXMgPSB0aGlzLmdyb3VwaW5nLmNoaWxkTm9kZXMsIGkgPSBjaGlsZE5vZGVzLmxlbmd0aCAtIDEsIGdyb3VwOyBncm91cCA9IGNoaWxkTm9kZXNbaV07IGktLSkgZ3JvdXAuY2xlYXIoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldENoaWxkTm9kZXM6IGZ1bmN0aW9uKG5ld0NoaWxkTm9kZXMsIGtlZXBBbGl2ZSkgewogICAgICAgIGlmICghdGhpcy5kYXRhU291cmNlICYmICF0aGlzLmRhdGFTb3VyY2VBZGFwdGVyXykgdGhpcy5jbGVhcihrZWVwQWxpdmUpOwogICAgICAgIGlmIChuZXdDaGlsZE5vZGVzKSB7CiAgICAgICAgICBpZiAoImxlbmd0aCIgaW4gbmV3Q2hpbGROb2RlcyA9PSBmYWxzZSkgbmV3Q2hpbGROb2RlcyA9IFsgbmV3Q2hpbGROb2RlcyBdOwogICAgICAgICAgaWYgKG5ld0NoaWxkTm9kZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciB0bXAgPSB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkOwogICAgICAgICAgICB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkID0gJHVuZGVmOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gbmV3Q2hpbGROb2Rlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgdGhpcy5pbnNlcnRCZWZvcmUobmV3Q2hpbGROb2Rlc1tpXSk7CiAgICAgICAgICAgIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQgPSB0bXA7CiAgICAgICAgICAgIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQoewogICAgICAgICAgICAgIGluc2VydGVkOiB0aGlzLmNoaWxkTm9kZXMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXREYXRhU291cmNlOiBmdW5jdGlvbihkYXRhU291cmNlKSB7CiAgICAgICAgaWYgKCF0aGlzLmNoaWxkQ2xhc3MpIHRocm93IEVYQ0VQVElPTl9OT19DSElMRENMQVNTOwogICAgICAgIGRhdGFTb3VyY2UgPSBiYXNpcy5kYXRhLnJlc29sdmVEYXRhc2V0KHRoaXMsIHRoaXMuc2V0RGF0YVNvdXJjZSwgZGF0YVNvdXJjZSwgImRhdGFTb3VyY2VBZGFwdGVyXyIpOwogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UgIT09IGRhdGFTb3VyY2UpIHsKICAgICAgICAgIHZhciBvbGREYXRhU291cmNlID0gdGhpcy5kYXRhU291cmNlOwogICAgICAgICAgdmFyIGxpc3RlbkhhbmRsZXIgPSB0aGlzLmxpc3Rlbi5kYXRhU291cmNlOwogICAgICAgICAgaWYgKG9sZERhdGFTb3VyY2UpIHsKICAgICAgICAgICAgdGhpcy5kYXRhU291cmNlTWFwXyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IG51bGw7CiAgICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSBvbGREYXRhU291cmNlLnJlbW92ZUhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5maXJzdENoaWxkKSB7CiAgICAgICAgICAgIGlmIChvbGREYXRhU291cmNlKSBmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gdGhpcy5jaGlsZE5vZGVzW2ldOyBpKyspIHVubG9ja0RhdGFTb3VyY2VJdGVtTm9kZShjaGlsZCk7CiAgICAgICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IGRhdGFTb3VyY2U7CiAgICAgICAgICBpZiAoZGF0YVNvdXJjZSkgewogICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2VNYXBfID0ge307CiAgICAgICAgICAgIHRoaXMuc2V0Q2hpbGROb2Rlc1N0YXRlKGRhdGFTb3VyY2Uuc3RhdGUsIGRhdGFTb3VyY2Uuc3RhdGUuZGF0YSk7CiAgICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSB7CiAgICAgICAgICAgICAgZGF0YVNvdXJjZS5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICAgIGlmIChkYXRhU291cmNlLml0ZW1Db3VudCAmJiBsaXN0ZW5IYW5kbGVyLml0ZW1zQ2hhbmdlZCkgewogICAgICAgICAgICAgICAgbGlzdGVuSGFuZGxlci5pdGVtc0NoYW5nZWQuY2FsbCh0aGlzLCBkYXRhU291cmNlLCB7CiAgICAgICAgICAgICAgICAgIGluc2VydGVkOiBkYXRhU291cmNlLmdldEl0ZW1zKCkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zZXRDaGlsZE5vZGVzU3RhdGUoU1RBVEUuVU5ERUZJTkVEKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9kYXRhU291cmNlQ2hhbmdlZChvbGREYXRhU291cmNlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldEdyb3VwaW5nOiBmdW5jdGlvbihncm91cGluZywgYWxpdmUpIHsKICAgICAgICBpZiAodHlwZW9mIGdyb3VwaW5nID09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGdyb3VwaW5nID09ICJzdHJpbmciKSBncm91cGluZyA9IHsKICAgICAgICAgIHJ1bGU6IGdyb3VwaW5nCiAgICAgICAgfTsKICAgICAgICBpZiAoZ3JvdXBpbmcgaW5zdGFuY2VvZiBHcm91cGluZ05vZGUgPT0gZmFsc2UpIHsKICAgICAgICAgIGdyb3VwaW5nID0gZ3JvdXBpbmcgJiYgdHlwZW9mIGdyb3VwaW5nID09ICJvYmplY3QiID8gbmV3IHRoaXMuZ3JvdXBpbmdDbGFzcyhncm91cGluZykgOiBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5ncm91cGluZyAhPT0gZ3JvdXBpbmcpIHsKICAgICAgICAgIHZhciBvbGRHcm91cGluZyA9IHRoaXMuZ3JvdXBpbmc7CiAgICAgICAgICB2YXIgb3JkZXI7CiAgICAgICAgICBpZiAob2xkR3JvdXBpbmcpIHsKICAgICAgICAgICAgdGhpcy5ncm91cGluZyA9IG51bGw7CiAgICAgICAgICAgIGlmICghZ3JvdXBpbmcpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5maXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zb3J0aW5nICE9PSBudWxsR2V0dGVyKSBvcmRlciA9IHNvcnRDaGlsZE5vZGVzKHRoaXMpOyBlbHNlIG9yZGVyID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgICAgICAgICAgb2xkR3JvdXBpbmcubnVsbEdyb3VwLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB2YXIgZ3JvdXBzID0gb2xkR3JvdXBpbmcuY2hpbGROb2Rlcy5zbGljZSgwKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZ3JvdXBzLmxlbmd0aDsgaSsrKSBncm91cHNbaV0uY2xlYXIoKTsKICAgICAgICAgICAgICAgIGZhc3RDaGlsZE5vZGVzT3JkZXIodGhpcywgb3JkZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBvbGRHcm91cGluZy5zZXRPd25lcigpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdyb3VwaW5nKSB7CiAgICAgICAgICAgIHRoaXMuZ3JvdXBpbmcgPSBncm91cGluZzsKICAgICAgICAgICAgZ3JvdXBpbmcuc2V0T3duZXIodGhpcyk7CiAgICAgICAgICAgIGlmICh0aGlzLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5zb3J0aW5nICE9PSBudWxsR2V0dGVyKSBvcmRlciA9IHNvcnRDaGlsZE5vZGVzKHRoaXMpOyBlbHNlIG9yZGVyID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBvcmRlcltpXTsgaSsrKSBjaGlsZC5ncm91cE5vZGUgPSB0aGlzLmdyb3VwaW5nLmdldEdyb3VwTm9kZShjaGlsZCwgdHJ1ZSk7CiAgICAgICAgICAgICAgb3JkZXIgPSBmYXN0Q2hpbGROb2Rlc0dyb3VwT3JkZXIodGhpcywgb3JkZXIpOwogICAgICAgICAgICAgIGZhc3RDaGlsZE5vZGVzT3JkZXIodGhpcywgb3JkZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmVtaXRfZ3JvdXBpbmdDaGFuZ2VkKG9sZEdyb3VwaW5nKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFNvcnRpbmc6IGZ1bmN0aW9uKHNvcnRpbmcsIHNvcnRpbmdEZXNjKSB7CiAgICAgICAgc29ydGluZyA9IGdldHRlcihzb3J0aW5nKTsKICAgICAgICBzb3J0aW5nRGVzYyA9ICEhc29ydGluZ0Rlc2M7CiAgICAgICAgaWYgKHRoaXMuc29ydGluZyAhPT0gc29ydGluZyB8fCB0aGlzLnNvcnRpbmdEZXNjICE9ICEhc29ydGluZ0Rlc2MpIHsKICAgICAgICAgIHZhciBvbGRTb3J0aW5nID0gdGhpcy5zb3J0aW5nOwogICAgICAgICAgdmFyIG9sZFNvcnRpbmdEZXNjID0gdGhpcy5zb3J0aW5nRGVzYzsKICAgICAgICAgIHRoaXMuc29ydGluZyA9IHNvcnRpbmc7CiAgICAgICAgICB0aGlzLnNvcnRpbmdEZXNjID0gISFzb3J0aW5nRGVzYzsKICAgICAgICAgIGlmIChzb3J0aW5nICE9PSBudWxsR2V0dGVyICYmIHRoaXMuZmlyc3RDaGlsZCkgewogICAgICAgICAgICB2YXIgb3JkZXIgPSBbXTsKICAgICAgICAgICAgdmFyIG5vZGVzOwogICAgICAgICAgICBmb3IgKHZhciBub2RlID0gdGhpcy5maXJzdENoaWxkOyBub2RlOyBub2RlID0gbm9kZS5uZXh0U2libGluZykgbm9kZS5zb3J0aW5nVmFsdWUgPSBzb3J0aW5nKG5vZGUpIHx8IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmdyb3VwaW5nKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgZ3JvdXAgPSB0aGlzLmdyb3VwaW5nLm51bGxHcm91cDsgZ3JvdXA7IGdyb3VwID0gZ3JvdXAubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgICAgIG5vZGVzID0gZ3JvdXAubm9kZXMgPSBzb3J0Q2hpbGROb2Rlcyh7CiAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZXM6IGdyb3VwLm5vZGVzLAogICAgICAgICAgICAgICAgICBzb3J0aW5nRGVzYzogdGhpcy5zb3J0aW5nRGVzYwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBncm91cC5maXJzdCA9IG5vZGVzWzBdIHx8IG51bGw7CiAgICAgICAgICAgICAgICBncm91cC5sYXN0ID0gbm9kZXNbbm9kZXMubGVuZ3RoIC0gMV0gfHwgbnVsbDsKICAgICAgICAgICAgICAgIG9yZGVyLnB1c2guYXBwbHkob3JkZXIsIG5vZGVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgb3JkZXIgPSBzb3J0Q2hpbGROb2Rlcyh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYXN0Q2hpbGROb2Rlc09yZGVyKHRoaXMsIG9yZGVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9zb3J0aW5nQ2hhbmdlZChvbGRTb3J0aW5nLCBvbGRTb3J0aW5nRGVzYyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRNYXRjaEZ1bmN0aW9uOiBmdW5jdGlvbihtYXRjaEZ1bmN0aW9uKSB7CiAgICAgICAgaWYgKHRoaXMubWF0Y2hGdW5jdGlvbiAhPSBtYXRjaEZ1bmN0aW9uKSB7CiAgICAgICAgICB2YXIgb2xkTWF0Y2hGdW5jdGlvbiA9IHRoaXMubWF0Y2hGdW5jdGlvbjsKICAgICAgICAgIHRoaXMubWF0Y2hGdW5jdGlvbiA9IG1hdGNoRnVuY3Rpb247CiAgICAgICAgICBmb3IgKHZhciBub2RlID0gdGhpcy5sYXN0Q2hpbGQ7IG5vZGU7IG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykgbm9kZS5tYXRjaChtYXRjaEZ1bmN0aW9uKTsKICAgICAgICAgIHRoaXMuZW1pdF9tYXRjaEZ1bmN0aW9uQ2hhbmdlZChvbGRNYXRjaEZ1bmN0aW9uKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB2YXIgTm9kZSA9IENsYXNzKEFic3RyYWN0Tm9kZSwgRG9tTWl4aW4sIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLk5vZGUiLAogICAgICBlbWl0X2VuYWJsZTogY3JlYXRlRXZlbnQoImVuYWJsZSIpICYmIGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGNoaWxkID0gdGhpcy5maXJzdENoaWxkOyBjaGlsZDsgY2hpbGQgPSBjaGlsZC5uZXh0U2libGluZykgdXBkYXRlTm9kZURpc2FibGVDb250ZXh0KGNoaWxkLCBmYWxzZSk7CiAgICAgICAgZXZlbnRzLmVuYWJsZS5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBlbWl0X2Rpc2FibGU6IGNyZWF0ZUV2ZW50KCJkaXNhYmxlIikgJiYgZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgY2hpbGQgPSB0aGlzLmZpcnN0Q2hpbGQ7IGNoaWxkOyBjaGlsZCA9IGNoaWxkLm5leHRTaWJsaW5nKSB1cGRhdGVOb2RlRGlzYWJsZUNvbnRleHQoY2hpbGQsIHRydWUpOwogICAgICAgIGV2ZW50cy5kaXNhYmxlLmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGVtaXRfc2F0ZWxsaXRlQ2hhbmdlZDogZnVuY3Rpb24obmFtZSwgb2xkU2F0ZWxsaXRlKSB7CiAgICAgICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5lbWl0X3NhdGVsbGl0ZUNoYW5nZWQuY2FsbCh0aGlzLCBuYW1lLCBvbGRTYXRlbGxpdGUpOwogICAgICAgIGlmICh0aGlzLnNhdGVsbGl0ZVtuYW1lXSBpbnN0YW5jZW9mIE5vZGUpIHVwZGF0ZU5vZGVEaXNhYmxlQ29udGV4dCh0aGlzLnNhdGVsbGl0ZVtuYW1lXSwgdGhpcy5kaXNhYmxlZCB8fCB0aGlzLmNvbnRleHREaXNhYmxlZCk7CiAgICAgIH0sCiAgICAgIGVtaXRfc2VsZWN0OiBjcmVhdGVFdmVudCgic2VsZWN0IiksCiAgICAgIGVtaXRfdW5zZWxlY3Q6IGNyZWF0ZUV2ZW50KCJ1bnNlbGVjdCIpLAogICAgICBlbWl0X21hdGNoOiBjcmVhdGVFdmVudCgibWF0Y2giKSwKICAgICAgZW1pdF91bm1hdGNoOiBjcmVhdGVFdmVudCgidW5tYXRjaCIpLAogICAgICBlbWl0X21hdGNoRnVuY3Rpb25DaGFuZ2VkOiBjcmVhdGVFdmVudCgibWF0Y2hGdW5jdGlvbkNoYW5nZWQiLCAib2xkTWF0Y2hGdW5jdGlvbiIpLAogICAgICBzZWxlY3RhYmxlOiB0cnVlLAogICAgICBzZWxlY3RlZDogZmFsc2UsCiAgICAgIHNlbGVjdGlvbjogbnVsbCwKICAgICAgY29udGV4dFNlbGVjdGlvbjogbnVsbCwKICAgICAgbWF0Y2hGdW5jdGlvbjogbnVsbCwKICAgICAgbWF0Y2hlZDogdHJ1ZSwKICAgICAgZGlzYWJsZWQ6IGZhbHNlLAogICAgICBjb250ZXh0RGlzYWJsZWQ6IGZhbHNlLAogICAgICBsaXN0ZW46IHsKICAgICAgICBvd25lcjogewogICAgICAgICAgZW5hYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlTm9kZURpc2FibGVDb250ZXh0KHRoaXMsIGZhbHNlKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkaXNhYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlTm9kZURpc2FibGVDb250ZXh0KHRoaXMsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uKSB7CiAgICAgICAgICBpZiAodGhpcy5zZWxlY3Rpb24gaW5zdGFuY2VvZiBSZWFkT25seURhdGFzZXQgPT0gZmFsc2UpIHRoaXMuc2VsZWN0aW9uID0gbmV3IFNlbGVjdGlvbih0aGlzLnNlbGVjdGlvbik7CiAgICAgICAgICBpZiAodGhpcy5saXN0ZW4uc2VsZWN0aW9uKSB0aGlzLnNlbGVjdGlvbi5hZGRIYW5kbGVyKHRoaXMubGlzdGVuLnNlbGVjdGlvbiwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIEFic3RyYWN0Tm9kZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIGlmICh0aGlzLmRpc2FibGVkKSB0aGlzLmVtaXRfZGlzYWJsZSgpOwogICAgICAgIGlmICh0aGlzLnNlbGVjdGVkKSB7CiAgICAgICAgICB0aGlzLnNlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnNlbGVjdCh0cnVlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFNlbGVjdGlvbjogZnVuY3Rpb24oc2VsZWN0aW9uKSB7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uICE9PSBzZWxlY3Rpb24pIHsKICAgICAgICAgIHVwZGF0ZU5vZGVDb250ZXh0U2VsZWN0aW9uKHRoaXMsIHRoaXMuc2VsZWN0aW9uIHx8IHRoaXMuY29udGV4dFNlbGVjdGlvbiwgc2VsZWN0aW9uIHx8IHRoaXMuY29udGV4dFNlbGVjdGlvbiwgZmFsc2UsIHRydWUpOwogICAgICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uICYmIHRoaXMubGlzdGVuLnNlbGVjdGlvbikgdGhpcy5zZWxlY3Rpb24ucmVtb3ZlSGFuZGxlcih0aGlzLmxpc3Rlbi5zZWxlY3Rpb24sIHRoaXMpOwogICAgICAgICAgdGhpcy5zZWxlY3Rpb24gPSBzZWxlY3Rpb247CiAgICAgICAgICBpZiAoc2VsZWN0aW9uICYmIHRoaXMubGlzdGVuLnNlbGVjdGlvbikgc2VsZWN0aW9uLmFkZEhhbmRsZXIodGhpcy5saXN0ZW4uc2VsZWN0aW9uLCB0aGlzKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2VsZWN0OiBmdW5jdGlvbihtdWx0aXBsZSkgewogICAgICAgIHZhciBzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQ7CiAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHRoaXMuY29udGV4dFNlbGVjdGlvbjsKICAgICAgICBpZiAoc2VsZWN0aW9uKSB7CiAgICAgICAgICBpZiAoIW11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdGFibGUpIHNlbGVjdGlvbi5zZXQoWyB0aGlzIF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHNlbGVjdGVkKSBzZWxlY3Rpb24ucmVtb3ZlKFsgdGhpcyBdKTsgZWxzZSBzZWxlY3Rpb24uYWRkKFsgdGhpcyBdKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFzZWxlY3RlZCAmJiB0aGlzLnNlbGVjdGFibGUpIHsKICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgdGhpcy5lbWl0X3NlbGVjdCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3RlZCAhPSBzZWxlY3RlZDsKICAgICAgfSwKICAgICAgdW5zZWxlY3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQ7CiAgICAgICAgaWYgKHNlbGVjdGVkKSB7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gdGhpcy5jb250ZXh0U2VsZWN0aW9uOwogICAgICAgICAgaWYgKHNlbGVjdGlvbikgc2VsZWN0aW9uLnJlbW92ZShbIHRoaXMgXSk7IGVsc2UgewogICAgICAgICAgICB0aGlzLnNlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZW1pdF91bnNlbGVjdCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3RlZCAhPSBzZWxlY3RlZDsKICAgICAgfSwKICAgICAgc2V0U2VsZWN0ZWQ6IGZ1bmN0aW9uKHNlbGVjdGVkLCBtdWx0aXBsZSkgewogICAgICAgIHJldHVybiBzZWxlY3RlZCA/IHRoaXMuc2VsZWN0KG11bHRpcGxlKSA6IHRoaXMudW5zZWxlY3QoKTsKICAgICAgfSwKICAgICAgZW5hYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGlzYWJsZWQgPSB0aGlzLmRpc2FibGVkOwogICAgICAgIGlmIChkaXNhYmxlZCkgewogICAgICAgICAgdGhpcy5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgaWYgKCF0aGlzLmNvbnRleHREaXNhYmxlZCkgdGhpcy5lbWl0X2VuYWJsZSgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5kaXNhYmxlZCAhPSBkaXNhYmxlZDsKICAgICAgfSwKICAgICAgZGlzYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGRpc2FibGVkID0gdGhpcy5kaXNhYmxlZDsKICAgICAgICBpZiAoIWRpc2FibGVkKSB7CiAgICAgICAgICB0aGlzLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgIGlmICghdGhpcy5jb250ZXh0RGlzYWJsZWQpIHRoaXMuZW1pdF9kaXNhYmxlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLmRpc2FibGVkICE9IGRpc2FibGVkOwogICAgICB9LAogICAgICBzZXREaXNhYmxlZDogZnVuY3Rpb24oZGlzYWJsZWQpIHsKICAgICAgICByZXR1cm4gZGlzYWJsZWQgPyB0aGlzLmRpc2FibGUoKSA6IHRoaXMuZW5hYmxlKCk7CiAgICAgIH0sCiAgICAgIGlzRGlzYWJsZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmRpc2FibGVkIHx8IHRoaXMuY29udGV4dERpc2FibGVkOwogICAgICB9LAogICAgICBtYXRjaDogZnVuY3Rpb24oZnVuYykgewogICAgICAgIGlmICh0eXBlb2YgZnVuYyAhPSAiZnVuY3Rpb24iKSBmdW5jID0gbnVsbDsKICAgICAgICBpZiAodGhpcy51bmRlck1hdGNoXyAmJiAhZnVuYykgdGhpcy51bmRlck1hdGNoXyh0aGlzLCB0cnVlKTsKICAgICAgICB0aGlzLnVuZGVyTWF0Y2hfID0gZnVuYzsKICAgICAgICB2YXIgbWF0Y2hlZCA9ICFmdW5jIHx8IGZ1bmModGhpcyk7CiAgICAgICAgaWYgKHRoaXMubWF0Y2hlZCAhPSBtYXRjaGVkKSB7CiAgICAgICAgICB0aGlzLm1hdGNoZWQgPSBtYXRjaGVkOwogICAgICAgICAgaWYgKG1hdGNoZWQpIHRoaXMuZW1pdF9tYXRjaCgpOyBlbHNlIHRoaXMuZW1pdF91bm1hdGNoKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnVuc2VsZWN0KCk7CiAgICAgICAgdGhpcy5jb250ZXh0U2VsZWN0aW9uID0gbnVsbDsKICAgICAgICBpZiAodGhpcy5zZWxlY3Rpb24pIHRoaXMuc2V0U2VsZWN0aW9uKCk7CiAgICAgICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIEdyb3VwaW5nTm9kZSA9IENsYXNzKEFic3RyYWN0Tm9kZSwgRG9tTWl4aW4sIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkdyb3VwaW5nTm9kZSIsCiAgICAgIGVtaXRfY2hpbGROb2Rlc01vZGlmaWVkOiBmdW5jdGlvbihkZWx0YSkgewogICAgICAgIGV2ZW50cy5jaGlsZE5vZGVzTW9kaWZpZWQuY2FsbCh0aGlzLCBkZWx0YSk7CiAgICAgICAgdGhpcy5udWxsR3JvdXAubmV4dFNpYmxpbmcgPSB0aGlzLmZpcnN0Q2hpbGQ7CiAgICAgICAgdmFyIGFycmF5OwogICAgICAgIGlmIChhcnJheSA9IGRlbHRhLmluc2VydGVkKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gYXJyYXlbaSsrXTsgKSB7CiAgICAgICAgICAgIGNoaWxkLmdyb3VwSWRfID0gY2hpbGQuZGVsZWdhdGUgPyBjaGlsZC5kZWxlZ2F0ZS5iYXNpc09iamVjdElkIDogY2hpbGQuZGF0YS5pZDsKICAgICAgICAgICAgdGhpcy5tYXBfW2NoaWxkLmdyb3VwSWRfXSA9IGNoaWxkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZSAmJiB0aGlzLm51bGxHcm91cC5maXJzdCkgewogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHRoaXMub3duZXI7CiAgICAgICAgICAgIHZhciBub2RlcyA9IGFycmF5RnJvbSh0aGlzLm51bGxHcm91cC5ub2Rlcyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBub2Rlcy5sZW5ndGg7IGktLSA+IDA7ICkgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZXNbaV0sIG5vZGVzW2ldLm5leHRTaWJsaW5nKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGVtaXRfb3duZXJDaGFuZ2VkOiBmdW5jdGlvbihvbGRPd25lcikgewogICAgICAgIGlmIChvbGRPd25lciAmJiBvbGRPd25lci5ncm91cGluZyA9PT0gdGhpcykgb2xkT3duZXIuc2V0R3JvdXBpbmcobnVsbCwgdHJ1ZSk7CiAgICAgICAgaWYgKHRoaXMub3duZXIgJiYgdGhpcy5vd25lci5ncm91cGluZyAhPT0gdGhpcykgdGhpcy5vd25lci5zZXRHcm91cGluZyh0aGlzKTsKICAgICAgICBldmVudHMub3duZXJDaGFuZ2VkLmNhbGwodGhpcywgb2xkT3duZXIpOwogICAgICAgIGlmICghdGhpcy5vd25lciAmJiB0aGlzLmF1dG9EZXN0cm95V2l0aE5vT3duZXIpIHRoaXMuZGVzdHJveSgpOwogICAgICB9LAogICAgICBtYXBfOiBudWxsLAogICAgICBudWxsR3JvdXA6IG51bGwsCiAgICAgIGF1dG9EZXN0cm95V2l0aE5vT3duZXI6IHRydWUsCiAgICAgIGF1dG9EZXN0cm95RW1wdHlHcm91cHM6IHRydWUsCiAgICAgIHJ1bGU6IG51bGxHZXR0ZXIsCiAgICAgIGNoaWxkQ2xhc3M6IFBhcnRpdGlvbk5vZGUsCiAgICAgIGNoaWxkRmFjdG9yeTogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgcmV0dXJuIG5ldyB0aGlzLmNoaWxkQ2xhc3MoY29tcGxldGUoewogICAgICAgICAgYXV0b0Rlc3Ryb3lJZkVtcHR5OiB0aGlzLmRhdGFTb3VyY2UgPyBmYWxzZSA6IHRoaXMuYXV0b0Rlc3Ryb3lFbXB0eUdyb3VwcwogICAgICAgIH0sIGNvbmZpZykpOwogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLm1hcF8gPSB7fTsKICAgICAgICB0aGlzLm51bGxHcm91cCA9IG5ldyBQYXJ0aXRpb25Ob2RlOwogICAgICAgIEFic3RyYWN0Tm9kZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBnZXRHcm91cE5vZGU6IGZ1bmN0aW9uKG5vZGUsIGF1dG9jcmVhdGUpIHsKICAgICAgICB2YXIgZ3JvdXBSZWYgPSB0aGlzLnJ1bGUobm9kZSk7CiAgICAgICAgdmFyIGlzRGVsZWdhdGUgPSBncm91cFJlZiBpbnN0YW5jZW9mIERhdGFPYmplY3Q7CiAgICAgICAgdmFyIGdyb3VwID0gdGhpcy5tYXBfW2lzRGVsZWdhdGUgPyBncm91cFJlZi5iYXNpc09iamVjdElkIDogZ3JvdXBSZWZdOwogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UpIGF1dG9jcmVhdGUgPSBmYWxzZTsKICAgICAgICBpZiAoIWdyb3VwICYmIGF1dG9jcmVhdGUpIHsKICAgICAgICAgIGdyb3VwID0gdGhpcy5hcHBlbmRDaGlsZChpc0RlbGVnYXRlID8gZ3JvdXBSZWYgOiB7CiAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICBpZDogZ3JvdXBSZWYsCiAgICAgICAgICAgICAgdGl0bGU6IGdyb3VwUmVmCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ3JvdXAgfHwgdGhpcy5udWxsR3JvdXA7CiAgICAgIH0sCiAgICAgIHNldERhdGFTb3VyY2U6IGZ1bmN0aW9uKGRhdGFTb3VyY2UpIHsKICAgICAgICB2YXIgY3VyRGF0YVNvdXJjZSA9IHRoaXMuZGF0YVNvdXJjZTsKICAgICAgICBEb21NaXhpbi5zZXREYXRhU291cmNlLmNhbGwodGhpcywgZGF0YVNvdXJjZSk7CiAgICAgICAgdmFyIG93bmVyID0gdGhpcy5vd25lcjsKICAgICAgICBpZiAob3duZXIgJiYgdGhpcy5kYXRhU291cmNlICE9PSBjdXJEYXRhU291cmNlKSB7CiAgICAgICAgICB2YXIgbm9kZXMgPSBhcnJheUZyb20ob3duZXIuY2hpbGROb2Rlcyk7CiAgICAgICAgICBmb3IgKHZhciBpID0gbm9kZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIG93bmVyLmluc2VydEJlZm9yZShub2Rlc1tpXSwgbm9kZXNbaSArIDFdKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGluc2VydEJlZm9yZTogZnVuY3Rpb24obmV3Q2hpbGQsIHJlZkNoaWxkKSB7CiAgICAgICAgbmV3Q2hpbGQgPSBEb21NaXhpbi5pbnNlcnRCZWZvcmUuY2FsbCh0aGlzLCBuZXdDaGlsZCwgcmVmQ2hpbGQpOwogICAgICAgIHZhciBmaXJzdE5vZGUgPSBuZXdDaGlsZC5maXJzdDsKICAgICAgICBpZiAoZmlyc3ROb2RlKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmlyc3ROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB2YXIgbGFzdE5vZGUgPSBuZXdDaGlsZC5sYXN0OwogICAgICAgICAgdmFyIGJlZm9yZVByZXY7CiAgICAgICAgICB2YXIgYmVmb3JlTmV4dDsKICAgICAgICAgIHZhciBhZnRlclByZXY7CiAgICAgICAgICB2YXIgYWZ0ZXJOZXh0ID0gbnVsbDsKICAgICAgICAgIHZhciBjdXJzb3IgPSBuZXdDaGlsZDsKICAgICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgaWYgKGFmdGVyTmV4dCA9IGN1cnNvci5maXJzdCkgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhZnRlclByZXYgPSBhZnRlck5leHQgPyBhZnRlck5leHQucHJldmlvdXNTaWJsaW5nIDogcGFyZW50Lmxhc3RDaGlsZDsKICAgICAgICAgIGJlZm9yZVByZXYgPSBmaXJzdE5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgYmVmb3JlTmV4dCA9IGxhc3ROb2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgaWYgKGJlZm9yZU5leHQgIT09IGFmdGVyTmV4dCkgewogICAgICAgICAgICB2YXIgcGFyZW50Q2hpbGROb2RlcyA9IHBhcmVudC5jaGlsZE5vZGVzOwogICAgICAgICAgICB2YXIgbm9kZXMgPSBuZXdDaGlsZC5ub2RlczsKICAgICAgICAgICAgdmFyIG5vZGVzQ291bnQgPSBub2Rlcy5sZW5ndGg7CiAgICAgICAgICAgIGlmIChiZWZvcmVQcmV2KSBiZWZvcmVQcmV2Lm5leHRTaWJsaW5nID0gYmVmb3JlTmV4dDsKICAgICAgICAgICAgaWYgKGJlZm9yZU5leHQpIGJlZm9yZU5leHQucHJldmlvdXNTaWJsaW5nID0gYmVmb3JlUHJldjsKICAgICAgICAgICAgaWYgKGFmdGVyUHJldikgYWZ0ZXJQcmV2Lm5leHRTaWJsaW5nID0gZmlyc3ROb2RlOwogICAgICAgICAgICBpZiAoYWZ0ZXJOZXh0KSBhZnRlck5leHQucHJldmlvdXNTaWJsaW5nID0gbGFzdE5vZGU7CiAgICAgICAgICAgIGZpcnN0Tm9kZS5wcmV2aW91c1NpYmxpbmcgPSBhZnRlclByZXY7CiAgICAgICAgICAgIGxhc3ROb2RlLm5leHRTaWJsaW5nID0gYWZ0ZXJOZXh0OwogICAgICAgICAgICB2YXIgZmlyc3RQb3MgPSBwYXJlbnRDaGlsZE5vZGVzLmluZGV4T2YoZmlyc3ROb2RlKTsKICAgICAgICAgICAgdmFyIGFmdGVyTmV4dFBvcyA9IGFmdGVyTmV4dCA/IHBhcmVudENoaWxkTm9kZXMuaW5kZXhPZihhZnRlck5leHQpIDogcGFyZW50Q2hpbGROb2Rlcy5sZW5ndGg7CiAgICAgICAgICAgIGlmIChhZnRlck5leHRQb3MgPiBmaXJzdFBvcykgYWZ0ZXJOZXh0UG9zIC09IG5vZGVzQ291bnQ7CiAgICAgICAgICAgIHBhcmVudENoaWxkTm9kZXMuc3BsaWNlKGZpcnN0UG9zLCBub2Rlc0NvdW50KTsKICAgICAgICAgICAgcGFyZW50Q2hpbGROb2Rlcy5zcGxpY2UuYXBwbHkocGFyZW50Q2hpbGROb2RlcywgWyBhZnRlck5leHRQb3MsIDAgXS5jb25jYXQobm9kZXMpKTsKICAgICAgICAgICAgaWYgKCFhZnRlclByZXYgfHwgIWJlZm9yZVByZXYpIHBhcmVudC5maXJzdENoaWxkID0gcGFyZW50Q2hpbGROb2Rlc1swXTsKICAgICAgICAgICAgaWYgKCFhZnRlck5leHQgfHwgIWJlZm9yZU5leHQpIHBhcmVudC5sYXN0Q2hpbGQgPSBwYXJlbnRDaGlsZE5vZGVzW3BhcmVudENoaWxkTm9kZXMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgIGlmIChmaXJzdE5vZGUgaW5zdGFuY2VvZiBQYXJ0aXRpb25Ob2RlKSBmb3IgKHZhciBpID0gbm9kZXNDb3VudCwgaW5zZXJ0QmVmb3JlID0gYWZ0ZXJOZXh0OyBpLS0gPiAwOyApIHsKICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGVzW2ldLCBpbnNlcnRCZWZvcmUpOwogICAgICAgICAgICAgIGluc2VydEJlZm9yZSA9IG5vZGVzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgfSwKICAgICAgcmVtb3ZlQ2hpbGQ6IGZ1bmN0aW9uKG9sZENoaWxkKSB7CiAgICAgICAgaWYgKG9sZENoaWxkID0gRG9tTWl4aW4ucmVtb3ZlQ2hpbGQuY2FsbCh0aGlzLCBvbGRDaGlsZCkpIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLm1hcF9bb2xkQ2hpbGQuZ3JvdXBJZF9dOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5vZGU7IG5vZGUgPSBvbGRDaGlsZC5ub2Rlc1tpXTsgaSsrKSBub2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb2xkQ2hpbGQ7CiAgICAgIH0sCiAgICAgIGNsZWFyOiBmdW5jdGlvbihhbGl2ZSkgewogICAgICAgIHZhciBub2RlcyA9IFtdOwogICAgICAgIHZhciBnZXRHcm91cE5vZGUgPSB0aGlzLmdldEdyb3VwTm9kZTsKICAgICAgICB2YXIgbnVsbEdyb3VwID0gdGhpcy5udWxsR3JvdXA7CiAgICAgICAgdGhpcy5nZXRHcm91cE5vZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBudWxsR3JvdXA7CiAgICAgICAgfTsKICAgICAgICBmb3IgKHZhciBncm91cCA9IHRoaXMuZmlyc3RDaGlsZDsgZ3JvdXA7IGdyb3VwID0gZ3JvdXAubmV4dFNpYmxpbmcpIG5vZGVzLnB1c2guYXBwbHkobm9kZXMsIGdyb3VwLm5vZGVzKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gbm9kZXNbaV07IGkrKykgY2hpbGQucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQpOwogICAgICAgIHRoaXMuZ2V0R3JvdXBOb2RlID0gZ2V0R3JvdXBOb2RlOwogICAgICAgIERvbU1peGluLmNsZWFyLmNhbGwodGhpcywgYWxpdmUpOwogICAgICAgIHRoaXMubWFwXyA9IHt9OwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmF1dG9EZXN0cm95V2l0aE5vT3duZXIgPSBmYWxzZTsKICAgICAgICBBYnN0cmFjdE5vZGUucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLm51bGxHcm91cC5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5udWxsR3JvdXAgPSBudWxsOwogICAgICAgIHRoaXMubWFwXyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5ncm91cGluZ0NsYXNzID0gR3JvdXBpbmdOb2RlOwogICAgdmFyIENISUxETk9ERVNEQVRBU0VUX0hBTkRMRVIgPSB7CiAgICAgIGNoaWxkTm9kZXNNb2RpZmllZDogZnVuY3Rpb24oc2VuZGVyLCBkZWx0YSkgewogICAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICAgIHZhciBuZXdEZWx0YSA9IHt9OwogICAgICAgIHZhciBub2RlOwogICAgICAgIHZhciBpbnNlcnRDb3VudCA9IDA7CiAgICAgICAgdmFyIGRlbGV0ZUNvdW50ID0gMDsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBkZWx0YS5pbnNlcnRlZDsKICAgICAgICB2YXIgZGVsZXRlZCA9IGRlbHRhLmRlbGV0ZWQ7CiAgICAgICAgaWYgKGluc2VydGVkICYmIGluc2VydGVkLmxlbmd0aCkgewogICAgICAgICAgbmV3RGVsdGEuaW5zZXJ0ZWQgPSBpbnNlcnRlZDsKICAgICAgICAgIHdoaWxlIChub2RlID0gaW5zZXJ0ZWRbaW5zZXJ0Q291bnRdKSB7CiAgICAgICAgICAgIG1lbWJlck1hcFtub2RlLmJhc2lzT2JqZWN0SWRdID0gbm9kZTsKICAgICAgICAgICAgaW5zZXJ0Q291bnQrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlbGV0ZWQgJiYgZGVsZXRlZC5sZW5ndGgpIHsKICAgICAgICAgIG5ld0RlbHRhLmRlbGV0ZWQgPSBkZWxldGVkOwogICAgICAgICAgd2hpbGUgKG5vZGUgPSBkZWxldGVkW2RlbGV0ZUNvdW50XSkgewogICAgICAgICAgICBkZWxldGUgbWVtYmVyTWFwW25vZGUuYmFzaXNPYmplY3RJZF07CiAgICAgICAgICAgIGRlbGV0ZUNvdW50Kys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpbnNlcnRDb3VudCB8fCBkZWxldGVDb3VudCkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChuZXdEZWx0YSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVzdHJveSgpOwogICAgICB9CiAgICB9OwogICAgdmFyIENoaWxkTm9kZXNEYXRhc2V0ID0gQ2xhc3MoUmVhZE9ubHlEYXRhc2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5DaGlsZE5vZGVzRGF0YXNldCIsCiAgICAgIHNvdXJjZU5vZGU6IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIFJlYWRPbmx5RGF0YXNldC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBzb3VyY2VOb2RlID0gdGhpcy5zb3VyY2VOb2RlOwogICAgICAgIGNoaWxkTm9kZXNEYXRhc2V0TWFwW3NvdXJjZU5vZGUuYmFzaXNPYmplY3RJZF0gPSB0aGlzOwogICAgICAgIGlmIChzb3VyY2VOb2RlLmZpcnN0Q2hpbGQpIENISUxETk9ERVNEQVRBU0VUX0hBTkRMRVIuY2hpbGROb2Rlc01vZGlmaWVkLmNhbGwodGhpcywgc291cmNlTm9kZSwgewogICAgICAgICAgaW5zZXJ0ZWQ6IHNvdXJjZU5vZGUuY2hpbGROb2RlcwogICAgICAgIH0pOwogICAgICAgIHNvdXJjZU5vZGUuYWRkSGFuZGxlcihDSElMRE5PREVTREFUQVNFVF9IQU5ETEVSLCB0aGlzKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zb3VyY2VOb2RlLnJlbW92ZUhhbmRsZXIoQ0hJTEROT0RFU0RBVEFTRVRfSEFORExFUiwgdGhpcyk7CiAgICAgICAgZGVsZXRlIGNoaWxkTm9kZXNEYXRhc2V0TWFwW3RoaXMuc291cmNlTm9kZS5iYXNpc09iamVjdElkXTsKICAgICAgICBSZWFkT25seURhdGFzZXQucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgU2VsZWN0aW9uID0gQ2xhc3MoRGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU2VsZWN0aW9uIiwKICAgICAgbXVsdGlwbGU6IGZhbHNlLAogICAgICBlbWl0X2l0ZW1zQ2hhbmdlZDogZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICBEYXRhc2V0LnByb3RvdHlwZS5lbWl0X2l0ZW1zQ2hhbmdlZC5jYWxsKHRoaXMsIGRlbHRhKTsKICAgICAgICBpZiAoZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBub2RlOyBub2RlID0gZGVsdGEuaW5zZXJ0ZWRbaV07IGkrKykgewogICAgICAgICAgICBpZiAoIW5vZGUuc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICBub2RlLnNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICBub2RlLmVtaXRfc2VsZWN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhLmRlbGV0ZWQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBub2RlOyBub2RlID0gZGVsdGEuZGVsZXRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIGlmIChub2RlLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgbm9kZS5zZWxlY3RlZCA9IGZhbHNlOwogICAgICAgICAgICAgIG5vZGUuZW1pdF91bnNlbGVjdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBhZGQ6IGZ1bmN0aW9uKG5vZGVzKSB7CiAgICAgICAgaWYgKCF0aGlzLm11bHRpcGxlKSB7CiAgICAgICAgICBpZiAodGhpcy5pdGVtQ291bnQpIHJldHVybiB0aGlzLnNldChub2Rlcyk7IGVsc2Ugbm9kZXMgPSBbIG5vZGVzWzBdIF07CiAgICAgICAgfQogICAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBub2RlOyBub2RlID0gbm9kZXNbaV07IGkrKykgewogICAgICAgICAgaWYgKG5vZGUuY29udGV4dFNlbGVjdGlvbiA9PSB0aGlzICYmIG5vZGUuc2VsZWN0YWJsZSkgaXRlbXMucHVzaChub2RlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIERhdGFzZXQucHJvdG90eXBlLmFkZC5jYWxsKHRoaXMsIGl0ZW1zKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbihub2RlcykgewogICAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBub2RlOyBub2RlID0gbm9kZXNbaV07IGkrKykgewogICAgICAgICAgaWYgKG5vZGUuY29udGV4dFNlbGVjdGlvbiA9PSB0aGlzICYmIG5vZGUuc2VsZWN0YWJsZSkgaXRlbXMucHVzaChub2RlKTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLm11bHRpcGxlKSBpdGVtcy5zcGxpY2UoMSk7CiAgICAgICAgcmV0dXJuIERhdGFzZXQucHJvdG90eXBlLnNldC5jYWxsKHRoaXMsIGl0ZW1zKTsKICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgREVMRUdBVEU6IERFTEVHQVRFLAogICAgICBBYnN0cmFjdE5vZGU6IEFic3RyYWN0Tm9kZSwKICAgICAgTm9kZTogTm9kZSwKICAgICAgR3JvdXBpbmdOb2RlOiBHcm91cGluZ05vZGUsCiAgICAgIFBhcnRpdGlvbk5vZGU6IFBhcnRpdGlvbk5vZGUsCiAgICAgIENoaWxkTm9kZXNEYXRhc2V0OiBDaGlsZE5vZGVzRGF0YXNldCwKICAgICAgU2VsZWN0aW9uOiBTZWxlY3Rpb24sCiAgICAgIG51bGxTZWxlY3Rpb246IG5ldyBSZWFkT25seURhdGFzZXQKICAgIH07CiAgfSwKICAiNi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8yLmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgY2xlYW5lciA9IGJhc2lzLmNsZWFuZXI7CiAgICB2YXIgcGF0aCA9IGJhc2lzLnBhdGg7CiAgICB2YXIgYXJyYXlTZWFyY2ggPSBiYXNpcy5hcnJheS5zZWFyY2g7CiAgICB2YXIgYXJyYXlBZGQgPSBiYXNpcy5hcnJheS5hZGQ7CiAgICB2YXIgYXJyYXlSZW1vdmUgPSBiYXNpcy5hcnJheS5yZW1vdmU7CiAgICB2YXIgdGVtcGxhdGVMaXN0ID0gW107CiAgICB2YXIgdG1wbEZpbGVzTWFwID0ge307CiAgICB2YXIgREVDTEFSQVRJT05fVkVSU0lPTiA9IDI7CiAgICB2YXIgVFlQRV9FTEVNRU5UID0gMTsKICAgIHZhciBUWVBFX0FUVFJJQlVURSA9IDI7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEVfQ0xBU1MgPSA0OwogICAgdmFyIFRZUEVfQVRUUklCVVRFX1NUWUxFID0gNTsKICAgIHZhciBUWVBFX0FUVFJJQlVURV9FVkVOVCA9IDY7CiAgICB2YXIgVFlQRV9URVhUID0gMzsKICAgIHZhciBUWVBFX0NPTU1FTlQgPSA4OwogICAgdmFyIFRPS0VOX1RZUEUgPSAwOwogICAgdmFyIFRPS0VOX0JJTkRJTkdTID0gMTsKICAgIHZhciBUT0tFTl9SRUZTID0gMjsKICAgIHZhciBBVFRSX05BTUUgPSAzOwogICAgdmFyIEFUVFJfVkFMVUUgPSA0OwogICAgdmFyIEFUVFJfRVZFTlRfUlggPSAvXmV2ZW50LSguKykkLzsKICAgIHZhciBBVFRSX05BTUVfQllfVFlQRSA9IHsKICAgICAgNDogImNsYXNzIiwKICAgICAgNTogInN0eWxlIgogICAgfTsKICAgIHZhciBBVFRSX1RZUEVfQllfTkFNRSA9IHsKICAgICAgImNsYXNzIjogVFlQRV9BVFRSSUJVVEVfQ0xBU1MsCiAgICAgIHN0eWxlOiBUWVBFX0FUVFJJQlVURV9TVFlMRQogICAgfTsKICAgIHZhciBBVFRSX1ZBTFVFX0lOREVYID0gewogICAgICAyOiBBVFRSX1ZBTFVFLAogICAgICA0OiBBVFRSX1ZBTFVFIC0gMSwKICAgICAgNTogQVRUUl9WQUxVRSAtIDEsCiAgICAgIDY6IDIKICAgIH07CiAgICB2YXIgRUxFTUVOVF9OQU1FID0gMzsKICAgIHZhciBFTEVNRU5UX0FUVFJTID0gNDsKICAgIHZhciBFTEVNRU5UX0NISUxEUyA9IDU7CiAgICB2YXIgVEVYVF9WQUxVRSA9IDM7CiAgICB2YXIgQ09NTUVOVF9WQUxVRSA9IDM7CiAgICB2YXIgU1lOVEFYX0VSUk9SID0gIkludmFsaWQgb3IgdW5zdXBwb3J0ZWQgc3ludGF4IjsKICAgIHZhciBURVhUID0gLygoPzoufFtcclxuXSkqPykoXHsoPzpsMTBuOihbYS16QS1aX11bYS16QS1aMC05X1wtXSooPzpcLlthLXpBLVpfXVthLXpBLVowLTlfXC1dKikqKD86XC5ce1thLXpBLVpfXVthLXpBLVowLTlfXC1dKlx9KT8pXH0pP3w8KFwvfCEtLShccypceyk/KT98JCkvZzsKICAgIHZhciBUQUdfTkFNRSA9IC8oW2Etel9dW2EtejAtOVwtX10qKSg6fFx7fFxzKihcLz8+KT8pL2lnOwogICAgdmFyIEFUVFJJQlVURV9OQU1FX09SX0VORCA9IC8oW2Etel9dW2EtejAtOV9cLV0qKSg6fFx7fD18XHMqKXwoXC8/PikvaWc7CiAgICB2YXIgQ09NTUVOVCA9IC8oLnxbXHJcbl0pKj8tLT4vZzsKICAgIHZhciBDTE9TRV9UQUcgPSAvKFthLXpfXVthLXowLTlfXC1dKig/OjpbYS16X11bYS16MC05X1wtXSopPyk+L2lnOwogICAgdmFyIFJFRkVSRU5DRSA9IC8oW2Etel9dW2EtejAtOV9dKikoXHx8XH1ccyopL2lnOwogICAgdmFyIEFUVFJJQlVURV9WQUxVRSA9IC8iKCg/OihcXCIpfFteIl0pKj8pIlxzKi9nOwogICAgdmFyIEJSRUFLX1RBR19QQVJTRSA9IC9eL2c7CiAgICB2YXIgU0lOR0xFVE9OX1RBRyA9IC9eKGFyZWF8YmFzZXxicnxjb2x8Y29tbWFuZHxlbWJlZHxocnxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtfHNvdXJjZSkkL2k7CiAgICB2YXIgVEFHX0lHTk9SRV9DT05URU5UID0gewogICAgICB0ZXh0OiAvKCg/Oi58W1xyXG5dKSo/KSg/OjxcL2I6dGV4dD58JCkvZywKICAgICAgc3R5bGU6IC8oKD86LnxbXHJcbl0pKj8pKD86PFwvYjpzdHlsZT58JCkvZwogICAgfTsKICAgIHZhciBxdW90ZVVuZXNjYXBlID0gL1xcIi9nOwogICAgdmFyIHRva2VuaXplID0gZnVuY3Rpb24oc291cmNlKSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgdmFyIHRhZ1N0YWNrID0gW107CiAgICAgIHZhciBsYXN0VGFnID0gewogICAgICAgIGNoaWxkczogcmVzdWx0CiAgICAgIH07CiAgICAgIHZhciBzb3VyY2VUZXh0OwogICAgICB2YXIgdG9rZW47CiAgICAgIHZhciBidWZmZXJQb3M7CiAgICAgIHZhciBzdGFydFBvczsKICAgICAgdmFyIHBhcnNlVGFnID0gZmFsc2U7CiAgICAgIHZhciB0ZXh0U3RhdGVFbmRQb3MgPSAwOwogICAgICB2YXIgdGV4dEVuZFBvczsKICAgICAgdmFyIHN0YXRlID0gVEVYVDsKICAgICAgdmFyIHBvcyA9IDA7CiAgICAgIHZhciBtOwogICAgICBzb3VyY2UgPSBzb3VyY2UudHJpbSgpOwogICAgICByZXN1bHQud2FybnMgPSBbXTsKICAgICAgd2hpbGUgKHBvcyA8IHNvdXJjZS5sZW5ndGggfHwgc3RhdGUgIT0gVEVYVCkgewogICAgICAgIHN0YXRlLmxhc3RJbmRleCA9IHBvczsKICAgICAgICBzdGFydFBvcyA9IHBvczsKICAgICAgICBtID0gc3RhdGUuZXhlYyhzb3VyY2UpOwogICAgICAgIGlmICghbSB8fCBtLmluZGV4ICE9PSBwb3MpIHsKICAgICAgICAgIGlmIChzdGF0ZSA9PSBSRUZFUkVOQ0UgJiYgdG9rZW4gJiYgdG9rZW4udHlwZSA9PSBUWVBFX0NPTU1FTlQpIHsKICAgICAgICAgICAgc3RhdGUgPSBDT01NRU5UOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXJzZVRhZykgbGFzdFRhZyA9IHRhZ1N0YWNrLnBvcCgpOwogICAgICAgICAgaWYgKHRva2VuKSBsYXN0VGFnLmNoaWxkcy5wb3AoKTsKICAgICAgICAgIGlmICh0b2tlbiA9IGxhc3RUYWcuY2hpbGRzLnBvcCgpKSB7CiAgICAgICAgICAgIGlmICh0b2tlbi50eXBlID09IFRZUEVfVEVYVCAmJiAhdG9rZW4ucmVmcykgdGV4dFN0YXRlRW5kUG9zIC09ICJsZW4iIGluIHRva2VuID8gdG9rZW4ubGVuIDogdG9rZW4udmFsdWUubGVuZ3RoOyBlbHNlIGxhc3RUYWcuY2hpbGRzLnB1c2godG9rZW4pOwogICAgICAgICAgfQogICAgICAgICAgcGFyc2VUYWcgPSBmYWxzZTsKICAgICAgICAgIHN0YXRlID0gVEVYVDsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBwb3MgPSBzdGF0ZS5sYXN0SW5kZXg7CiAgICAgICAgc3dpdGNoIChzdGF0ZSkgewogICAgICAgICAgY2FzZSBURVhUOgogICAgICAgICAgICB0ZXh0RW5kUG9zID0gc3RhcnRQb3MgKyBtWzFdLmxlbmd0aDsKICAgICAgICAgICAgaWYgKHRleHRTdGF0ZUVuZFBvcyAhPSB0ZXh0RW5kUG9zKSB7CiAgICAgICAgICAgICAgc291cmNlVGV4dCA9IHRleHRTdGF0ZUVuZFBvcyA9PSBzdGFydFBvcyA/IG1bMV0gOiBzb3VyY2Uuc3Vic3RyaW5nKHRleHRTdGF0ZUVuZFBvcywgdGV4dEVuZFBvcyk7CiAgICAgICAgICAgICAgdG9rZW4gPSBzb3VyY2VUZXh0LnJlcGxhY2UoL1xzKihcclxuP3xcblxyPylccyovZywgIiIpOwogICAgICAgICAgICAgIGlmICh0b2tlbikgbGFzdFRhZy5jaGlsZHMucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX1RFWFQsCiAgICAgICAgICAgICAgICBsZW46IHNvdXJjZVRleHQubGVuZ3RoLAogICAgICAgICAgICAgICAgdmFsdWU6IHRva2VuCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGV4dFN0YXRlRW5kUG9zID0gdGV4dEVuZFBvczsKICAgICAgICAgICAgaWYgKG1bM10pIHsKICAgICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfVEVYVCwKICAgICAgICAgICAgICAgIHJlZnM6IFsgImwxMG46IiArIG1bM10gXSwKICAgICAgICAgICAgICAgIHZhbHVlOiAie2wxMG46IiArIG1bM10gKyAifSIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtWzJdID09ICJ7IikgewogICAgICAgICAgICAgIGJ1ZmZlclBvcyA9IHBvcyAtIDE7CiAgICAgICAgICAgICAgbGFzdFRhZy5jaGlsZHMucHVzaCh0b2tlbiA9IHsKICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfVEVYVAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHN0YXRlID0gUkVGRVJFTkNFOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1bNF0pIHsKICAgICAgICAgICAgICBpZiAobVs0XSA9PSAiLyIpIHsKICAgICAgICAgICAgICAgIHRva2VuID0gbnVsbDsKICAgICAgICAgICAgICAgIHN0YXRlID0gQ0xPU0VfVEFHOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHRva2VuID0gewogICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0NPTU1FTlQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG1bNV0pIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyUG9zID0gcG9zIC0gbVs1XS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIHN0YXRlID0gUkVGRVJFTkNFOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyUG9zID0gcG9zOwogICAgICAgICAgICAgICAgICBzdGF0ZSA9IENPTU1FTlQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG1bMl0pIHsKICAgICAgICAgICAgICBwYXJzZVRhZyA9IHRydWU7CiAgICAgICAgICAgICAgdGFnU3RhY2sucHVzaChsYXN0VGFnKTsKICAgICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHRva2VuID0gewogICAgICAgICAgICAgICAgdHlwZTogVFlQRV9FTEVNRU5ULAogICAgICAgICAgICAgICAgYXR0cnM6IFtdLAogICAgICAgICAgICAgICAgY2hpbGRzOiBbXQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGxhc3RUYWcgPSB0b2tlbjsKICAgICAgICAgICAgICBzdGF0ZSA9IFRBR19OQU1FOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDTE9TRV9UQUc6CiAgICAgICAgICAgIGlmIChtWzFdICE9PSAobGFzdFRhZy5wcmVmaXggPyBsYXN0VGFnLnByZWZpeCArICI6IiA6ICIiKSArIGxhc3RUYWcubmFtZSkgewogICAgICAgICAgICAgIGxhc3RUYWcuY2hpbGRzLnB1c2goewogICAgICAgICAgICAgICAgdHlwZTogVFlQRV9URVhULAogICAgICAgICAgICAgICAgdmFsdWU6ICI8LyIgKyBtWzBdCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBsYXN0VGFnID0gdGFnU3RhY2sucG9wKCk7CiAgICAgICAgICAgIHN0YXRlID0gVEVYVDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFRBR19OQU1FOgogICAgICAgICAgY2FzZSBBVFRSSUJVVEVfTkFNRV9PUl9FTkQ6CiAgICAgICAgICAgIGlmIChtWzJdID09ICI6IikgewogICAgICAgICAgICAgIGlmICh0b2tlbi5wcmVmaXgpIHN0YXRlID0gQlJFQUtfVEFHX1BBUlNFOyBlbHNlIHRva2VuLnByZWZpeCA9IG1bMV07CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1bMV0pIHsKICAgICAgICAgICAgICB0b2tlbi5uYW1lID0gbVsxXTsKICAgICAgICAgICAgICBpZiAodG9rZW4udHlwZSA9PSBUWVBFX0FUVFJJQlVURSkgbGFzdFRhZy5hdHRycy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobVsyXSA9PSAieyIpIHsKICAgICAgICAgICAgICBpZiAodG9rZW4udHlwZSA9PSBUWVBFX0VMRU1FTlQpIHN0YXRlID0gUkVGRVJFTkNFOyBlbHNlIHN0YXRlID0gQlJFQUtfVEFHX1BBUlNFOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtWzNdKSB7CiAgICAgICAgICAgICAgcGFyc2VUYWcgPSBmYWxzZTsKICAgICAgICAgICAgICBpZiAobVszXSA9PSAiLz4iIHx8ICFsYXN0VGFnLnByZWZpeCAmJiBTSU5HTEVUT05fVEFHLnRlc3QobGFzdFRhZy5uYW1lKSkgewogICAgICAgICAgICAgICAgaWYgKG1bM10gIT0gIi8+IikgcmVzdWx0Lndhcm5zLnB1c2goIlRhZyA8IiArIGxhc3RUYWcubmFtZSArICI+IGRvZXNuJ3QgY2xvc2VkIGV4cGxpY2l0ICh1c2UgYC8+YCBhcyB0YWcgZW5kaW5nKSIpOwogICAgICAgICAgICAgICAgbGFzdFRhZyA9IHRhZ1N0YWNrLnBvcCgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdFRhZy5wcmVmaXggPT0gImIiICYmIGxhc3RUYWcubmFtZSBpbiBUQUdfSUdOT1JFX0NPTlRFTlQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUgPSBUQUdfSUdOT1JFX0NPTlRFTlRbbGFzdFRhZy5uYW1lXTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN0YXRlID0gVEVYVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobVsyXSA9PSAiPSIpIHsKICAgICAgICAgICAgICBzdGF0ZSA9IEFUVFJJQlVURV9WQUxVRTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB0b2tlbiA9IHsKICAgICAgICAgICAgICB0eXBlOiBUWVBFX0FUVFJJQlVURQogICAgICAgICAgICB9OwogICAgICAgICAgICBzdGF0ZSA9IEFUVFJJQlVURV9OQU1FX09SX0VORDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIENPTU1FTlQ6CiAgICAgICAgICAgIHRva2VuLnZhbHVlID0gc291cmNlLnN1YnN0cmluZyhidWZmZXJQb3MsIHBvcyAtIDMpOwogICAgICAgICAgICBzdGF0ZSA9IFRFWFQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBSRUZFUkVOQ0U6CiAgICAgICAgICAgIGlmICh0b2tlbi5yZWZzKSB0b2tlbi5yZWZzLnB1c2gobVsxXSk7IGVsc2UgdG9rZW4ucmVmcyA9IFsgbVsxXSBdOwogICAgICAgICAgICBpZiAobVsyXSAhPSAifCIpIHsKICAgICAgICAgICAgICBpZiAodG9rZW4udHlwZSA9PSBUWVBFX1RFWFQpIHsKICAgICAgICAgICAgICAgIHBvcyAtPSBtWzJdLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgICB0b2tlbi52YWx1ZSA9IHNvdXJjZS5zdWJzdHJpbmcoYnVmZmVyUG9zLCBwb3MpOwogICAgICAgICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodG9rZW4udHlwZSA9PSBUWVBFX0NPTU1FTlQpIHsKICAgICAgICAgICAgICAgIHN0YXRlID0gQ09NTUVOVDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRva2VuLnR5cGUgPT0gVFlQRV9BVFRSSUJVVEUgJiYgc291cmNlW3Bvc10gPT0gIj0iKSB7CiAgICAgICAgICAgICAgICBwb3MrKzsKICAgICAgICAgICAgICAgIHN0YXRlID0gQVRUUklCVVRFX1ZBTFVFOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0b2tlbiA9IHsKICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9BVFRSSUJVVEUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBzdGF0ZSA9IEFUVFJJQlVURV9OQU1FX09SX0VORDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIEFUVFJJQlVURV9WQUxVRToKICAgICAgICAgICAgdG9rZW4udmFsdWUgPSBtWzFdLnJlcGxhY2UocXVvdGVVbmVzY2FwZSwgJyInKTsKICAgICAgICAgICAgdG9rZW4gPSB7CiAgICAgICAgICAgICAgdHlwZTogVFlQRV9BVFRSSUJVVEUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgc3RhdGUgPSBBVFRSSUJVVEVfTkFNRV9PUl9FTkQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBUQUdfSUdOT1JFX0NPTlRFTlQudGV4dDoKICAgICAgICAgIGNhc2UgVEFHX0lHTk9SRV9DT05URU5ULnN0eWxlOgogICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHsKICAgICAgICAgICAgICB0eXBlOiBUWVBFX1RFWFQsCiAgICAgICAgICAgICAgdmFsdWU6IG1bMV0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhc3RUYWcgPSB0YWdTdGFjay5wb3AoKTsKICAgICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93ICJQYXJzZXIgYnVnIjsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YXRlID09IFRFWFQpIHRleHRTdGF0ZUVuZFBvcyA9IHBvczsKICAgICAgfQogICAgICBpZiAodGV4dFN0YXRlRW5kUG9zICE9IHBvcykgbGFzdFRhZy5jaGlsZHMucHVzaCh7CiAgICAgICAgdHlwZTogVFlQRV9URVhULAogICAgICAgIHZhbHVlOiBzb3VyY2Uuc3Vic3RyaW5nKHRleHRTdGF0ZUVuZFBvcywgcG9zKQogICAgICB9KTsKICAgICAgaWYgKGxhc3RUYWcubmFtZSkgcmVzdWx0Lndhcm5zLnB1c2goIk5vIGNsb3NlIHRhZyBmb3IgPCIgKyBsYXN0VGFnLm5hbWUgKyAiPiIpOwogICAgICBpZiAoIXJlc3VsdC53YXJucy5sZW5ndGgpIGRlbGV0ZSByZXN1bHQud2FybnM7CiAgICAgIHJlc3VsdC50ZW1wbGF0ZVRva2VucyA9IHRydWU7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgdmFyIHRva2VuVGVtcGxhdGUgPSB7fTsKICAgIHZhciBMMTBuUHJveHlUb2tlbiA9IGJhc2lzLlRva2VuLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkwxMG5Qcm94eVRva2VuIiwKICAgICAgdG9rZW46IG51bGwsCiAgICAgIHVybDogIiIsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgdGhpcy51cmwgPSB0b2tlbi5kaWN0aW9uYXJ5LnJlc291cmNlLnVybCArICI6IiArIHRva2VuLm5hbWU7CiAgICAgICAgdGhpcy50b2tlbiA9IHRva2VuOwogICAgICAgIHRoaXMuc2V0KCk7CiAgICAgICAgdG9rZW4uYXR0YWNoKHRoaXMuc2V0LCB0aGlzKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYmFzaXMuVG9rZW4ucHJvdG90eXBlLnNldC5jYWxsKHRoaXMsIHRoaXMudG9rZW4udHlwZSA9PSAibWFya3VwIiA/IHByb2Nlc3NNYXJrdXAodGhpcy50b2tlbi52YWx1ZSwgdGhpcy50b2tlbi5uYW1lICsgIkAiICsgdGhpcy50b2tlbi5kaWN0aW9uYXJ5LnJlc291cmNlLnVybCkgOiAiIik7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGJhc2lzLlRva2VuLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy50b2tlbiA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gcHJvY2Vzc01hcmt1cCh2YWx1ZSwgaWQpIHsKICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz0iYmFzaXNqcy1tYXJrdXAiIGRhdGEtYmFzaXNqcy1sMTBuPSInICsgaWQgKyAnIj4nICsgU3RyaW5nKHZhbHVlKSArICI8L3NwYW4+IjsKICAgIH0KICAgIGZ1bmN0aW9uIGdldEwxMG5UZW1wbGF0ZSh0b2tlbikgewogICAgICBpZiAodHlwZW9mIHRva2VuID09ICJzdHJpbmciKSB0b2tlbiA9IGJhc2lzLmwxMG4udG9rZW4odG9rZW4pOwogICAgICBpZiAoIXRva2VuKSByZXR1cm4gbnVsbDsKICAgICAgdmFyIGlkID0gdG9rZW4uYmFzaXNPYmplY3RJZDsKICAgICAgdmFyIHRlbXBsYXRlID0gdG9rZW5UZW1wbGF0ZVtpZF07CiAgICAgIGlmICghdGVtcGxhdGUpIHRlbXBsYXRlID0gdG9rZW5UZW1wbGF0ZVtpZF0gPSBuZXcgVGVtcGxhdGUobmV3IEwxMG5Qcm94eVRva2VuKHRva2VuKSk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KICAgIGZ1bmN0aW9uIGdlbklzb2xhdGVNYXJrZXIoKSB7CiAgICAgIHJldHVybiAiaSIgKyBiYXNpcy5nZW5VSUQoKSArICJfXyI7CiAgICB9CiAgICBmdW5jdGlvbiBpc29sYXRlQ3NzKGNzcywgcHJlZml4KSB7CiAgICAgIGZ1bmN0aW9uIGFkZE1hdGNoKHByZWZpeCkgewogICAgICAgIGlmIChpID4gbGFzdE1hdGNoUG9zKSB7CiAgICAgICAgICByZXN1bHQucHVzaCgocHJlZml4IHx8ICIiKSArIGNzcy5zdWJzdHJpbmcobGFzdE1hdGNoUG9zLCBpKSk7CiAgICAgICAgICBsYXN0TWF0Y2hQb3MgPSBpOwogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIHZhciBzeW0gPSBjc3Muc3BsaXQoIiIpOwogICAgICB2YXIgbGVuID0gc3ltLmxlbmd0aDsKICAgICAgdmFyIGxhc3RNYXRjaFBvcyA9IDA7CiAgICAgIHZhciBibG9ja1Njb3BlID0gZmFsc2U7CiAgICAgIHZhciBzdHJTeW07CiAgICAgIGlmICghcHJlZml4KSBwcmVmaXggPSBnZW5Jc29sYXRlTWFya2VyKCk7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBzd2l0Y2ggKHN5bVtpXSkgewogICAgICAgICAgY2FzZSAiJyI6CiAgICAgICAgICBjYXNlICciJzoKICAgICAgICAgICAgc3RyU3ltID0gc3ltW2ldOwogICAgICAgICAgICB3aGlsZSAoKytpIDwgbGVuKSB7CiAgICAgICAgICAgICAgaWYgKHN5bVtpXSA9PSAiXFwiKSBpKys7IGVsc2UgaWYgKHN5bVtpXSA9PSBzdHJTeW0pIHsKICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIi8iOgogICAgICAgICAgICBpZiAoc3ltW2kgKyAxXSA9PSAiKiIpIHsKICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgd2hpbGUgKCsraSA8IGxlbikgaWYgKHN5bVtpXSA9PSAiKiIgJiYgc3ltW2kgKyAxXSA9PSAiLyIpIHsKICAgICAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgInsiOgogICAgICAgICAgICBibG9ja1Njb3BlID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJ9IjoKICAgICAgICAgICAgYmxvY2tTY29wZSA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIi4iOgogICAgICAgICAgICBpZiAoIWJsb2NrU2NvcGUpIHsKICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgYWRkTWF0Y2goKTsKICAgICAgICAgICAgICB3aGlsZSAoKytpIDwgbGVuKSBpZiAoIS9bYS16MC05XC1cX10vLnRlc3Qoc3ltW2ldKSkgewogICAgICAgICAgICAgICAgYWRkTWF0Y2gocHJlZml4KTsKICAgICAgICAgICAgICAgIGkgLT0gMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgYWRkTWF0Y2goKTsKICAgICAgcmV0dXJuIHJlc3VsdC5qb2luKCIiKTsKICAgIH0KICAgIHZhciBtYWtlRGVjbGFyYXRpb24gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIElERU5UID0gL15bYS16X11bYS16MC05X1wtXSokL2k7CiAgICAgIHZhciBDTEFTU19BVFRSX1BBUlRTID0gLyhcUyspL2c7CiAgICAgIHZhciBDTEFTU19BVFRSX0JJTkRJTkcgPSAvXigoPzpbYS16X11bYS16MC05X1wtXSopPyg/OjooPzpbYS16X11bYS16MC05X1wtXSopPyk/KVx7KChhbmltOik/W2Etel9dW2EtejAtOV9cLV0qKVx9JC9pOwogICAgICB2YXIgU1RZTEVfQVRUUl9QQVJUUyA9IC9ccypbXjpdKz9ccyo6KD86XCguKj9cKXwiLio/InwnLio/J3xbXjtdKz8pKyg/Ojt8JCkvZ2k7CiAgICAgIHZhciBTVFlMRV9QUk9QRVJUWSA9IC9ccyooW146XSs/KVxzKjooKD86XCguKj9cKXwiLio/InwnLio/J3xbXjtdKz8pKyk7PyQvaTsKICAgICAgdmFyIFNUWUxFX0FUVFJfQklORElORyA9IC9ceyhbYS16X11bYS16MC05X10qKVx9L2k7CiAgICAgIHZhciBBVFRSX0JJTkRJTkcgPSAvXHsoW2Etel9dW2EtejAtOV9dKnxsMTBuOlthLXpfXVthLXowLTlfXSooPzpcLlthLXpfXVthLXowLTlfXSopKig/OlwuXHtbYS16X11bYS16MC05X10qXH0pPylcfS9pOwogICAgICB2YXIgTkFNRURfQ0hBUkFDVEVSX1JFRiA9IC8mKFthLXpdK3wjWzAtOV0rfCN4WzAtOWEtZl17MSw0fSk7Py9naTsKICAgICAgdmFyIHRva2VuTWFwID0gYmFzaXMuTk9ERV9FTlYgPyBfX25vZGVqc1JlcXVpcmUoIi4vdGVtcGxhdGUvaHRtbGVudGl0eS5qc29uIikgOiB7fTsKICAgICAgdmFyIHRva2VuRWxlbWVudCA9ICFiYXNpcy5OT0RFX0VOViA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpIDogbnVsbDsKICAgICAgdmFyIGluY2x1ZGVTdGFjayA9IFtdOwogICAgICB2YXIgc3R5bGVOYW1lc3BhY2VJc29sYXRlID0ge307CiAgICAgIGZ1bmN0aW9uIG5hbWUodG9rZW4pIHsKICAgICAgICByZXR1cm4gKHRva2VuLnByZWZpeCA/IHRva2VuLnByZWZpeCArICI6IiA6ICIiKSArIHRva2VuLm5hbWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbmFtZWRDaGFyUmVwbGFjZShtLCB0b2tlbikgewogICAgICAgIGlmICghdG9rZW5NYXBbdG9rZW5dKSB7CiAgICAgICAgICBpZiAodG9rZW4uY2hhckF0KDApID09ICIjIikgewogICAgICAgICAgICB0b2tlbk1hcFt0b2tlbl0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHRva2VuLmNoYXJBdCgxKSA9PSAieCIgfHwgdG9rZW4uY2hhckF0KDEpID09ICJYIiA/IHBhcnNlSW50KHRva2VuLnN1YnN0cigyKSwgMTYpIDogdG9rZW4uc3Vic3RyKDEpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0b2tlbkVsZW1lbnQpIHsKICAgICAgICAgICAgICB0b2tlbkVsZW1lbnQuaW5uZXJIVE1MID0gbTsKICAgICAgICAgICAgICB0b2tlbk1hcFt0b2tlbl0gPSB0b2tlbkVsZW1lbnQuZmlyc3RDaGlsZCA/IHRva2VuRWxlbWVudC5maXJzdENoaWxkLm5vZGVWYWx1ZSA6IG07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuTWFwW3Rva2VuXSB8fCBtOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHVudG9rZW4odmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUucmVwbGFjZShOQU1FRF9DSEFSQUNURVJfUkVGLCBuYW1lZENoYXJSZXBsYWNlKTsKICAgICAgfQogICAgICBmdW5jdGlvbiByZWZMaXN0KHRva2VuKSB7CiAgICAgICAgdmFyIGFycmF5ID0gdG9rZW4ucmVmczsKICAgICAgICBpZiAoIWFycmF5IHx8ICFhcnJheS5sZW5ndGgpIHJldHVybiAwOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfQogICAgICBmdW5jdGlvbiBidWlsZEF0dHJFeHByZXNzaW9uKHBhcnRzKSB7CiAgICAgICAgdmFyIGJpbmROYW1lOwogICAgICAgIHZhciBuYW1lcyA9IFtdOwogICAgICAgIHZhciBleHByZXNzaW9uID0gW107CiAgICAgICAgdmFyIG1hcCA9IHt9OwogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcGFydHMubGVuZ3RoOyBqKyspIGlmIChqICUgMikgewogICAgICAgICAgYmluZE5hbWUgPSBwYXJ0c1tqXTsKICAgICAgICAgIGlmICghbWFwW2JpbmROYW1lXSkgewogICAgICAgICAgICBtYXBbYmluZE5hbWVdID0gbmFtZXMubGVuZ3RoOwogICAgICAgICAgICBuYW1lcy5wdXNoKGJpbmROYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIGV4cHJlc3Npb24ucHVzaChtYXBbYmluZE5hbWVdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHBhcnRzW2pdKSBleHByZXNzaW9uLnB1c2godW50b2tlbihwYXJ0c1tqXSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gWyBuYW1lcywgZXhwcmVzc2lvbiBdOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHByb2Nlc3NBdHRyKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgdmFyIGJpbmRpbmdzID0gMDsKICAgICAgICB2YXIgcGFydHM7CiAgICAgICAgdmFyIG07CiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgICAgIGlmIChwYXJ0cyA9IHZhbHVlLm1hdGNoKENMQVNTX0FUVFJfUEFSVFMpKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBbXTsKICAgICAgICAgICAgICAgIGJpbmRpbmdzID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgcGFydDsgcGFydCA9IHBhcnRzW2pdOyBqKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKG0gPSBwYXJ0Lm1hdGNoKENMQVNTX0FUVFJfQklORElORykpIGJpbmRpbmdzLnB1c2goWyBtWzFdIHx8ICIiLCBtWzJdIF0pOyBlbHNlIG5ld1ZhbHVlLnB1c2gocGFydCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YWx1ZSA9IG5ld1ZhbHVlLmpvaW4oIiAiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBbXTsKICAgICAgICAgICAgICBiaW5kaW5ncyA9IFtdOwogICAgICAgICAgICAgIGlmIChwYXJ0cyA9IHZhbHVlLm1hdGNoKFNUWUxFX0FUVFJfUEFSVFMpKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgcGFydDsgcGFydCA9IHBhcnRzW2pdOyBqKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIG0gPSBwYXJ0Lm1hdGNoKFNUWUxFX1BST1BFUlRZKTsKICAgICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IG1bMV07CiAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG1bMl0udHJpbSgpOwogICAgICAgICAgICAgICAgICB2YXIgdmFsdWVQYXJ0cyA9IHZhbHVlLnNwbGl0KFNUWUxFX0FUVFJfQklORElORyk7CiAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZVBhcnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXhwciA9IGJ1aWxkQXR0ckV4cHJlc3Npb24odmFsdWVQYXJ0cyk7CiAgICAgICAgICAgICAgICAgICAgZXhwci5wdXNoKHByb3BlcnR5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MucHVzaChleHByKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHByb3BzLnB1c2gocHJvcGVydHlOYW1lICsgIjogIiArIHVudG9rZW4odmFsdWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKC9cUy8udGVzdCh2YWx1ZSkpIGJhc2lzLmRldi53YXJuKCJCYWQgdmFsdWUgZm9yIHN0eWxlIGF0dHJpYnV0ZSAodmFsdWUgaWdub3JlZCk6IiwgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YWx1ZSA9IHByb3BzLmpvaW4oIjsgIik7CiAgICAgICAgICAgICAgaWYgKHZhbHVlKSB2YWx1ZSArPSAiOyI7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcGFydHMgPSB2YWx1ZS5zcGxpdChBVFRSX0JJTkRJTkcpOwogICAgICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSBiaW5kaW5ncyA9IGJ1aWxkQXR0ckV4cHJlc3Npb24ocGFydHMpOyBlbHNlIHZhbHVlID0gdW50b2tlbih2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChiaW5kaW5ncyAmJiAhYmluZGluZ3MubGVuZ3RoKSBiaW5kaW5ncyA9IDA7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGJpbmRpbmc6IGJpbmRpbmdzLAogICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgdHlwZTogQVRUUl9UWVBFX0JZX05BTUVbbmFtZV0gfHwgMgogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYXR0cnModG9rZW4sIGRlY2xUb2tlbiwgb3B0aW1pemVTaXplKSB7CiAgICAgICAgdmFyIGF0dHJzID0gdG9rZW4uYXR0cnM7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciBzdHlsZUF0dHI7CiAgICAgICAgdmFyIGRpc3BsYXk7CiAgICAgICAgdmFyIG07CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGF0dHI7IGF0dHIgPSBhdHRyc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAoYXR0ci5wcmVmaXggPT0gImIiKSB7CiAgICAgICAgICAgIHN3aXRjaCAoYXR0ci5uYW1lKSB7CiAgICAgICAgICAgICAgY2FzZSAicmVmIjoKICAgICAgICAgICAgICAgIHZhciByZWZzID0gKGF0dHIudmFsdWUgfHwgIiIpLnRyaW0oKS5zcGxpdCgvXHMrLyk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJlZnMubGVuZ3RoOyBqKyspIGFkZFRva2VuUmVmKGRlY2xUb2tlbiwgcmVmc1tqXSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzaG93IjoKICAgICAgICAgICAgICBjYXNlICJoaWRlIjoKICAgICAgICAgICAgICAgIGRpc3BsYXkgPSBhdHRyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobSA9IGF0dHIubmFtZS5tYXRjaChBVFRSX0VWRU5UX1JYKSkgewogICAgICAgICAgICByZXN1bHQucHVzaChtWzFdID09IGF0dHIudmFsdWUgPyBbIFRZUEVfQVRUUklCVVRFX0VWRU5ULCBtWzFdIF0gOiBbIFRZUEVfQVRUUklCVVRFX0VWRU5ULCBtWzFdLCBhdHRyLnZhbHVlIF0pOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJzZWQgPSBwcm9jZXNzQXR0cihhdHRyLm5hbWUsIGF0dHIudmFsdWUpOwogICAgICAgICAgdmFyIGl0ZW0gPSBbIHBhcnNlZC50eXBlLCBwYXJzZWQuYmluZGluZywgcmVmTGlzdChhdHRyKSBdOwogICAgICAgICAgaWYgKHBhcnNlZC50eXBlID09IDIpIGl0ZW0ucHVzaChuYW1lKGF0dHIpKTsKICAgICAgICAgIGlmIChwYXJzZWQudmFsdWUgJiYgKCFvcHRpbWl6ZVNpemUgfHwgIXBhcnNlZC5iaW5kaW5nIHx8IHBhcnNlZC50eXBlICE9IDIpKSBpdGVtLnB1c2gocGFyc2VkLnZhbHVlKTsKICAgICAgICAgIGlmIChwYXJzZWQudHlwZSA9PSBUWVBFX0FUVFJJQlVURV9TVFlMRSkgc3R5bGVBdHRyID0gaXRlbTsKICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pOwogICAgICAgIH0KICAgICAgICBpZiAoZGlzcGxheSkgewogICAgICAgICAgaWYgKCFzdHlsZUF0dHIpIHsKICAgICAgICAgICAgc3R5bGVBdHRyID0gWyBUWVBFX0FUVFJJQlVURV9TVFlMRSwgMCwgMCBdOwogICAgICAgICAgICByZXN1bHQucHVzaChzdHlsZUF0dHIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFzdHlsZUF0dHJbMV0pIHN0eWxlQXR0clsxXSA9IFtdOwogICAgICAgICAgdmFyIGRpc3BsYXlFeHByID0gYnVpbGRBdHRyRXhwcmVzc2lvbigoZGlzcGxheS52YWx1ZSB8fCBkaXNwbGF5Lm5hbWUpLnNwbGl0KEFUVFJfQklORElORykpOwogICAgICAgICAgaWYgKGRpc3BsYXlFeHByWzBdLmxlbmd0aCAtIGRpc3BsYXlFeHByWzFdLmxlbmd0aCkgewogICAgICAgICAgICBzdHlsZUF0dHJbM10gPSAoc3R5bGVBdHRyWzNdID8gc3R5bGVBdHRyWzNdICsgIjsgIiA6ICIiKSArIChkaXNwbGF5Lm5hbWUgPT0gInNob3ciIF4gZGlzcGxheS52YWx1ZSA9PT0gIiIgPyAiIiA6ICJkaXNwbGF5OiBub25lIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZGlzcGxheS5uYW1lID09ICJzaG93Iikgc3R5bGVBdHRyWzNdID0gKHN0eWxlQXR0clszXSA/IHN0eWxlQXR0clszXSArICI7ICIgOiAiIikgKyAiZGlzcGxheTogbm9uZSI7CiAgICAgICAgICAgIHN0eWxlQXR0clsxXS5wdXNoKGRpc3BsYXlFeHByLmNvbmNhdCgiZGlzcGxheSIsIGRpc3BsYXkubmFtZSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA/IHJlc3VsdCA6IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYWRkVG9rZW5SZWYodG9rZW4sIHJlZk5hbWUpIHsKICAgICAgICBpZiAoIXRva2VuW1RPS0VOX1JFRlNdKSB0b2tlbltUT0tFTl9SRUZTXSA9IFtdOwogICAgICAgIGFycmF5QWRkKHRva2VuW1RPS0VOX1JFRlNdLCByZWZOYW1lKTsKICAgICAgICBpZiAocmVmTmFtZSAhPSAiZWxlbWVudCIpIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IHRva2VuW1RPS0VOX1JFRlNdLmxlbmd0aCA9PSAxID8gcmVmTmFtZSA6IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVtb3ZlVG9rZW5SZWYodG9rZW4sIHJlZk5hbWUpIHsKICAgICAgICB2YXIgaWR4ID0gdG9rZW5bVE9LRU5fUkVGU10uaW5kZXhPZihyZWZOYW1lKTsKICAgICAgICBpZiAoaWR4ICE9IC0xKSB7CiAgICAgICAgICB2YXIgaW5kZXhCaW5kaW5nID0gdG9rZW5bVE9LRU5fQklORElOR1NdICYmIHR5cGVvZiB0b2tlbltUT0tFTl9CSU5ESU5HU10gPT0gIm51bWJlciI7CiAgICAgICAgICB0b2tlbltUT0tFTl9SRUZTXS5zcGxpY2UoaWR4LCAxKTsKICAgICAgICAgIGlmIChpbmRleEJpbmRpbmcpIGlmIChpZHggPT0gdG9rZW5bVE9LRU5fQklORElOR1NdIC0gMSkgdG9rZW5bVE9LRU5fQklORElOR1NdID0gcmVmTmFtZTsKICAgICAgICAgIGlmICghdG9rZW5bVE9LRU5fUkVGU10ubGVuZ3RoKSB0b2tlbltUT0tFTl9SRUZTXSA9IDA7IGVsc2UgewogICAgICAgICAgICBpZiAoaW5kZXhCaW5kaW5nKSB0b2tlbltUT0tFTl9CSU5ESU5HU10gLT0gaWR4IDwgdG9rZW5bVE9LRU5fQklORElOR1NdIC0gMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdG9rZW5BdHRycyh0b2tlbikgewogICAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgICBpZiAodG9rZW4uYXR0cnMpIGZvciAodmFyIGkgPSAwLCBhdHRyOyBhdHRyID0gdG9rZW4uYXR0cnNbaV07IGkrKykgcmVzdWx0W25hbWUoYXR0cildID0gYXR0ci52YWx1ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFkZFVuaXF1ZShhcnJheSwgaXRlbXMpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrKSBhcnJheUFkZChhcnJheSwgaXRlbXNbaV0pOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFkZFN0eWxlcyhhcnJheSwgaXRlbXMsIHByZWZpeCkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gaXRlbXNbaV07IGkrKykgaWYgKGl0ZW1bMV0gIT09IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSkgaXRlbVsxXSA9IHByZWZpeCArIGl0ZW1bMV07CiAgICAgICAgYXJyYXkudW5zaGlmdC5hcHBseShhcnJheSwgaXRlbXMpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFkZFN0eWxlKHRlbXBsYXRlLCB0b2tlbiwgc3JjLCBpc29sYXRlUHJlZml4KSB7CiAgICAgICAgdmFyIHVybDsKICAgICAgICBpZiAoc3JjKSB7CiAgICAgICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3Qoc3JjKSkgYmFzaXMuZGV2Lndhcm4oIkJhZCB1c2FnZTogPGI6IiArIHRva2VuLm5hbWUgKyAnIHNyYz0iJyArIHNyYyArICciLz4uXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLicpOwogICAgICAgICAgdXJsID0gcGF0aC5yZXNvbHZlKHRlbXBsYXRlLmJhc2VVUkkgKyBzcmMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgdGV4dCA9IHRva2VuLmNoaWxkc1swXTsKICAgICAgICAgIHVybCA9IGJhc2lzLnJlc291cmNlLnZpcnR1YWwoImNzcyIsIHRleHQgPyB0ZXh0LnZhbHVlIDogIiIsIHRlbXBsYXRlLnNvdXJjZVVybCkudXJsOwogICAgICAgIH0KICAgICAgICB0ZW1wbGF0ZS5yZXNvdXJjZXMucHVzaChbIHVybCwgaXNvbGF0ZVByZWZpeCBdKTsKICAgICAgICByZXR1cm4gdXJsOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHByb2Nlc3ModG9rZW5zLCB0ZW1wbGF0ZSwgb3B0aW9ucywgY29udGV4dCkgewogICAgICAgIGZ1bmN0aW9uIG1vZGlmeUF0dHIodG9rZW4sIG5hbWUsIGFjdGlvbikgewogICAgICAgICAgdmFyIGF0dHJzID0gdG9rZW5BdHRycyh0b2tlbik7CiAgICAgICAgICBpZiAobmFtZSkgYXR0cnMubmFtZSA9IG5hbWU7CiAgICAgICAgICBpZiAoIWF0dHJzLm5hbWUpIHsKICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiSW5zdHJ1Y3Rpb24gPGI6IiArIHRva2VuLm5hbWUgKyAiPiBoYXMgbm8gYXR0cmlidXRlIG5hbWUiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFJREVOVC50ZXN0KGF0dHJzLm5hbWUpKSB7CiAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIkJhZCBhdHRyaWJ1dGUgbmFtZSBgIiArIGF0dHJzLm5hbWUgKyAiYCIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5jbHVkZWRUb2tlbiA9IHRva2VuUmVmTWFwW2F0dHJzLnJlZiB8fCAiZWxlbWVudCJdOwogICAgICAgICAgaWYgKGluY2x1ZGVkVG9rZW4pIHsKICAgICAgICAgICAgaWYgKGluY2x1ZGVkVG9rZW4udG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9FTEVNRU5UKSB7CiAgICAgICAgICAgICAgdmFyIGl0QXR0cnMgPSBpbmNsdWRlZFRva2VuLnRva2VuOwogICAgICAgICAgICAgIHZhciBpc0V2ZW50ID0gYXR0cnMubmFtZS5tYXRjaChBVFRSX0VWRU5UX1JYKTsKICAgICAgICAgICAgICB2YXIgaXRUeXBlID0gaXNFdmVudCA/IFRZUEVfQVRUUklCVVRFX0VWRU5UIDogQVRUUl9UWVBFX0JZX05BTUVbYXR0cnMubmFtZV0gfHwgVFlQRV9BVFRSSUJVVEU7CiAgICAgICAgICAgICAgdmFyIHZhbHVlSWR4ID0gQVRUUl9WQUxVRV9JTkRFWFtpdFR5cGVdIHx8IEFUVFJfVkFMVUU7CiAgICAgICAgICAgICAgdmFyIGl0QXR0clRva2VuID0gaXRBdHRycyAmJiBhcnJheVNlYXJjaChpdEF0dHJzLCBhdHRycy5uYW1lLCBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgICAgICAgaWYgKHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfQVRUUklCVVRFX0VWRU5UKSByZXR1cm4gImV2ZW50LSIgKyB0b2tlblsxXTsKICAgICAgICAgICAgICAgIHJldHVybiBBVFRSX05BTUVfQllfVFlQRVt0b2tlbltUT0tFTl9UWVBFXV0gfHwgdG9rZW5bQVRUUl9OQU1FXTsKICAgICAgICAgICAgICB9LCBFTEVNRU5UX0FUVFJTKTsKICAgICAgICAgICAgICBpZiAoIWl0QXR0clRva2VuICYmIGFjdGlvbiAhPSAicmVtb3ZlIikgewogICAgICAgICAgICAgICAgaWYgKGlzRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgaXRBdHRyVG9rZW4gPSBbIGl0VHlwZSwgaXNFdmVudFsxXSBdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaXRBdHRyVG9rZW4gPSBbIGl0VHlwZSwgMCwgMCwgaXRUeXBlID09IFRZUEVfQVRUUklCVVRFID8gYXR0cnMubmFtZSA6ICIiIF07CiAgICAgICAgICAgICAgICAgIGlmIChpdFR5cGUgPT0gVFlQRV9BVFRSSUJVVEUpIGl0QXR0clRva2VuLnB1c2goIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFpdEF0dHJzKSB7CiAgICAgICAgICAgICAgICAgIGl0QXR0cnMgPSBbXTsKICAgICAgICAgICAgICAgICAgaW5jbHVkZWRUb2tlbi50b2tlbi5wdXNoKGl0QXR0cnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaXRBdHRycy5wdXNoKGl0QXR0clRva2VuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNsYXNzT3JTdHlsZSA9IGF0dHJzLm5hbWUgPT0gImNsYXNzIiB8fCBhdHRycy5uYW1lID09ICJzdHlsZSI7CiAgICAgICAgICAgICAgc3dpdGNoIChhY3Rpb24pIHsKICAgICAgICAgICAgICAgIGNhc2UgInNldCI6CiAgICAgICAgICAgICAgICAgIGlmIChpdEF0dHJUb2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX0FUVFJJQlVURV9FVkVOVCkgewogICAgICAgICAgICAgICAgICAgIGlmIChhdHRycy52YWx1ZSA9PSBpc0V2ZW50WzFdKSBpdEF0dHJUb2tlbi5sZW5ndGggPSAyOyBlbHNlIGl0QXR0clRva2VuW3ZhbHVlSWR4XSA9IGF0dHJzLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgcGFyc2VkID0gcHJvY2Vzc0F0dHIoYXR0cnMubmFtZSwgYXR0cnMudmFsdWUpOwogICAgICAgICAgICAgICAgICBpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU10gPSBwYXJzZWQuYmluZGluZzsKICAgICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLm9wdGltaXplU2l6ZSB8fCAhaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdIHx8IGNsYXNzT3JTdHlsZSkgaXRBdHRyVG9rZW5bdmFsdWVJZHhdID0gcGFyc2VkLnZhbHVlIHx8ICIiOyBlbHNlIGl0QXR0clRva2VuLmxlbmd0aCA9IHZhbHVlSWR4OwogICAgICAgICAgICAgICAgICBpZiAoY2xhc3NPclN0eWxlKSBpZiAoIWl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXSAmJiAhaXRBdHRyVG9rZW5bdmFsdWVJZHhdKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUoaXRBdHRycywgaXRBdHRyVG9rZW4pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImFwcGVuZCI6CiAgICAgICAgICAgICAgICAgIHZhciBwYXJzZWQgPSBwcm9jZXNzQXR0cihhdHRycy5uYW1lLCBhdHRycy52YWx1ZSk7CiAgICAgICAgICAgICAgICAgIGlmICghaXNFdmVudCkgewogICAgICAgICAgICAgICAgICAgIGlmIChwYXJzZWQuYmluZGluZykgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJCaW5kaW5ncyA9IGl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHRyQmluZGluZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChhdHRycy5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic3R5bGUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZEJpbmRpbmdNYXAgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBvbGRCaW5kaW5nOyBvbGRCaW5kaW5nID0gYXR0ckJpbmRpbmdzW2ldOyBpKyspIG9sZEJpbmRpbmdNYXBbb2xkQmluZGluZ1syXV0gPSBpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5ld0JpbmRpbmc7IG5ld0JpbmRpbmcgPSBwYXJzZWQuYmluZGluZ1tpXTsgaSsrKSBpZiAobmV3QmluZGluZ1syXSBpbiBvbGRCaW5kaW5nTWFwKSBhdHRyQmluZGluZ3Nbb2xkQmluZGluZ01hcFtuZXdCaW5kaW5nWzJdXV0gPSBuZXdCaW5kaW5nOyBlbHNlIGF0dHJCaW5kaW5ncy5wdXNoKG5ld0JpbmRpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ckJpbmRpbmdzLnB1c2guYXBwbHkoYXR0ckJpbmRpbmdzLCBwYXJzZWQuYmluZGluZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VkLmJpbmRpbmdbMF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5QWRkKHRoaXMsIG5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgYXR0ckJpbmRpbmdzWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyc2VkLmJpbmRpbmdbMV0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VkLmJpbmRpbmdbMV1baV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gIm51bWJlciIpIHZhbHVlID0gYXR0ckJpbmRpbmdzWzBdLmluZGV4T2YocGFyc2VkLmJpbmRpbmdbMF1bdmFsdWVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ckJpbmRpbmdzWzFdLnB1c2godmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU10gPSBwYXJzZWQuYmluZGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjbGFzc09yU3R5bGUpIGl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXVsxXS51bnNoaWZ0KGl0QXR0clRva2VuW3ZhbHVlSWR4XSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghY2xhc3NPclN0eWxlICYmIGl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXSkgaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdWzFdLnB1c2goYXR0cnMudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAocGFyc2VkLnZhbHVlKSBpdEF0dHJUb2tlblt2YWx1ZUlkeF0gPSAoaXRBdHRyVG9rZW5bdmFsdWVJZHhdIHx8ICIiKSArIChpdEF0dHJUb2tlblt2YWx1ZUlkeF0gJiYgKGlzRXZlbnQgfHwgY2xhc3NPclN0eWxlKSA/ICIgIiA6ICIiKSArIHBhcnNlZC52YWx1ZTsKICAgICAgICAgICAgICAgICAgaWYgKGNsYXNzT3JTdHlsZSkgaWYgKCFpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU10gJiYgIWl0QXR0clRva2VuW3ZhbHVlSWR4XSkgewogICAgICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKGl0QXR0cnMsIGl0QXR0clRva2VuKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJyZW1vdmUiOgogICAgICAgICAgICAgICAgICBpZiAoaXRBdHRyVG9rZW4pIGFycmF5UmVtb3ZlKGl0QXR0cnMsIGl0QXR0clRva2VuKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIkF0dHJpYnV0ZSBtb2RpZmljYXRvciBpcyBub3QgcmVmZXJlbmNlIHRvIGVsZW1lbnQgdG9rZW4gKHJlZmVyZW5jZSBuYW1lOiAiICsgKGF0dHJzLnJlZiB8fCAiZWxlbWVudCIpICsgIikiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIHRva2VuLCBpdGVtOyB0b2tlbiA9IHRva2Vuc1tpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgcmVmcyA9IHJlZkxpc3QodG9rZW4pOwogICAgICAgICAgdmFyIGJpbmRpbmdzID0gcmVmcyAmJiByZWZzLmxlbmd0aCA9PSAxID8gcmVmc1swXSA6IDA7CiAgICAgICAgICBzd2l0Y2ggKHRva2VuLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSBUWVBFX0VMRU1FTlQ6CiAgICAgICAgICAgICAgaWYgKHRva2VuLnByZWZpeCA9PSAiYiIpIHsKICAgICAgICAgICAgICAgIHZhciBlbEF0dHJzID0gdG9rZW5BdHRycyh0b2tlbik7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHRva2VuLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgY2FzZSAic3R5bGUiOgogICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZU5hbWVzcGFjZSA9IGVsQXR0cnMubmFtZXNwYWNlIHx8IGVsQXR0cnMubnM7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0eWxlSXNvbGF0ZSA9IHN0eWxlTmFtZXNwYWNlID8gc3R5bGVOYW1lc3BhY2VJc29sYXRlIDogY29udGV4dCAmJiBjb250ZXh0Lmlzb2xhdGUgfHwgIiI7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNyYyA9IGFkZFN0eWxlKHRlbXBsYXRlLCB0b2tlbiwgZWxBdHRycy5zcmMsIHN0eWxlSXNvbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlTmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3JjIGluIHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSA9PSBmYWxzZSkgc3R5bGVOYW1lc3BhY2VJc29sYXRlW3NyY10gPSBnZW5Jc29sYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5zdHlsZU5TUHJlZml4W3N0eWxlTmFtZXNwYWNlXSA9IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZVtzcmNdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAiaXNvbGF0ZSI6CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0ZW1wbGF0ZS5pc29sYXRlKSB0ZW1wbGF0ZS5pc29sYXRlID0gZWxBdHRycy5wcmVmaXggfHwgb3B0aW9ucy5pc29sYXRlIHx8IGdlbklzb2xhdGVNYXJrZXIoKTsgZWxzZSBiYXNpcy5kZXYud2FybigiPGI6aXNvbGF0ZT4gaXMgc2V0IGFscmVhZHkgdG8gYCIgKyB0ZW1wbGF0ZS5pc29sYXRlICsgImAiKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAibDEwbiI6CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlLmwxMG5SZXNvbHZlZCkgdGVtcGxhdGUud2FybnMucHVzaCgiPGI6bDEwbj4gbXVzdCBiZSBkZWNsYXJlZCBiZWZvcmUgYW55IGBsMTBuOmAgdG9rZW4gKGluc3RydWN0aW9uIGlnbm9yZWQpIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsQXR0cnMuc3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QoZWxBdHRycy5zcmMpKSBiYXNpcy5kZXYud2FybigiQmFkIHVzYWdlOiA8YjoiICsgdG9rZW4ubmFtZSArICcgc3JjPSInICsgZWxBdHRycy5zcmMgKyAnIi8+LlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4nKTsKICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLmRpY3RVUkkgPSBwYXRoLnJlc29sdmUodGVtcGxhdGUuYmFzZVVSSSwgZWxBdHRycy5zcmMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAiZGVmaW5lIjoKICAgICAgICAgICAgICAgICAgICBpZiAoIm5hbWUiIGluIGVsQXR0cnMgJiYgIXRlbXBsYXRlLmRlZmluZXNbZWxBdHRycy5uYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChlbEF0dHJzLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiYm9vbCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUuZGVmaW5lc1tlbEF0dHJzLm5hbWVdID0gWyBlbEF0dHJzWyJkZWZhdWx0Il0gPT0gInRydWUiID8gMSA6IDAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZW51bSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IGVsQXR0cnMudmFsdWVzID8gZWxBdHRycy52YWx1ZXMudHJpbSgpLnNwbGl0KCIgIikgOiBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5kZWZpbmVzW2VsQXR0cnMubmFtZV0gPSBbIHZhbHVlcy5pbmRleE9mKGVsQXR0cnNbImRlZmF1bHQiXSkgKyAxLCB2YWx1ZXMgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS53YXJucy5wdXNoKCJCYWQgZGVmaW5lIHR5cGUgYCIgKyBlbEF0dHJzLnR5cGUgKyAiYCBmb3IgIiArIGVsQXR0cnMubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlICJ0ZXh0IjoKICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IHRva2VuLmNoaWxkc1swXTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnNbaS0tXSA9IGJhc2lzLm9iamVjdC5leHRlbmQodGV4dCwgewogICAgICAgICAgICAgICAgICAgICAgcmVmczogKGVsQXR0cnMucmVmIHx8ICIiKS50cmltKCkuc3BsaXQoL1xzKy8pLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICJub3RyaW0iIGluIGVsQXR0cnMgPyB0ZXh0LnZhbHVlIDogdGV4dC52YWx1ZS5yZXBsYWNlKC9eXHMqW1xyXG5dK3xbXHJcbl1ccyokL2csICIiKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlICJpbmNsdWRlIjoKICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVTcmMgPSBlbEF0dHJzLnNyYzsKICAgICAgICAgICAgICAgICAgICBpZiAodGVtcGxhdGVTcmMpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBpc1RlbXBsYXRlUmVmID0gL14jXGQrJC8udGVzdCh0ZW1wbGF0ZVNyYyk7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNEb2N1bWVudElkUmVmID0gL15pZDovLnRlc3QodGVtcGxhdGVTcmMpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IGlzVGVtcGxhdGVSZWYgPyB0ZW1wbGF0ZVNyYy5zdWJzdHIoMSkgOiB0ZW1wbGF0ZVNyYzsKICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1RlbXBsYXRlUmVmKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlID0gdGVtcGxhdGVMaXN0W3VybF07CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRG9jdW1lbnRJZFJlZikgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSA9IHJlc29sdmVTb3VyY2VCeURvY3VtZW50SWQodXJsLnN1YnN0cigzKSk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKC9eW2EtejAtOVwuXSskL2kudGVzdCh1cmwpICYmICEvXC50bXBsJC8udGVzdCh1cmwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlID0gZ2V0U291cmNlQnlQYXRoKHVybCk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QodXJsKSkgYmFzaXMuZGV2Lndhcm4oJ0JhZCB1c2FnZTogPGI6aW5jbHVkZSBzcmM9IicgKyB1cmwgKyAnIi8+LlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2UgPSBiYXNpcy5yZXNvdXJjZShwYXRoLnJlc29sdmUodGVtcGxhdGUuYmFzZVVSSSArIHVybCkpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNvdXJjZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS53YXJucy5wdXNoKCc8YjppbmNsdWRlIHNyYz0iJyArIHRlbXBsYXRlU3JjICsgJyI+IGlzIG5vdCByZXNvbHZlZCwgaW5zdHJ1Y3Rpb24gaWdub3JlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybignPGI6aW5jbHVkZSBzcmM9IicgKyB0ZW1wbGF0ZVNyYyArICciPiBpcyBub3QgcmVzb2x2ZWQsIGluc3RydWN0aW9uIGlnbm9yZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZVN0YWNrLmluZGV4T2YocmVzb3VyY2UpID09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpc29sYXRlUHJlZml4ID0gImlzb2xhdGUiIGluIGVsQXR0cnMgPyBlbEF0dHJzLmlzb2xhdGUgfHwgZ2VuSXNvbGF0ZU1hcmtlcigpIDogIiI7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZWNsOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRG9jdW1lbnRJZFJlZikgYXJyYXlBZGQodGVtcGxhdGUuZGVwcywgcmVzb3VyY2UpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNUZW1wbGF0ZVJlZikgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNvdXJjZS5zb3VyY2UuYmluZGluZ0JyaWRnZSkgYXJyYXlBZGQodGVtcGxhdGUuZGVwcywgcmVzb3VyY2Uuc291cmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWNsID0gZ2V0RGVjbEZyb21Tb3VyY2UocmVzb3VyY2Uuc291cmNlLCByZXNvdXJjZS5iYXNlVVJJLCB0cnVlLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWNsID0gZ2V0RGVjbEZyb21Tb3VyY2UocmVzb3VyY2UsIHJlc291cmNlLnVybCA/IHBhdGguZGlybmFtZShyZXNvdXJjZS51cmwpICsgIi8iIDogIiIsIHRydWUsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWNsLnJlc291cmNlcyAmJiAibm8tc3R5bGUiIGluIGVsQXR0cnMgPT0gZmFsc2UpIGFkZFN0eWxlcyh0ZW1wbGF0ZS5yZXNvdXJjZXMsIGRlY2wucmVzb3VyY2VzLCBpc29sYXRlUHJlZml4KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlY2wuZGVwcykgYWRkVW5pcXVlKHRlbXBsYXRlLmRlcHMsIGRlY2wuZGVwcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWNsLmwxMG4pIGFkZFVuaXF1ZSh0ZW1wbGF0ZS5sMTBuLCBkZWNsLmwxMG4pOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5SZWZNYXAgPSBub3JtYWxpemVSZWZzKGRlY2wudG9rZW5zKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluc3RydWN0aW9ucyA9ICh0b2tlbi5jaGlsZHMgfHwgW10pLnNsaWNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZU5TUHJlZml4TWFwID0gYmFzaXMub2JqZWN0LnNsaWNlKGRlY2wuc3R5bGVOU1ByZWZpeCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbEF0dHJzWyJjbGFzcyJdKSBpbnN0cnVjdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9FTEVNRU5ULAogICAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeDogImIiLAogICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJhcHBlbmQtY2xhc3MiLAogICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzOiBbIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfQVRUUklCVVRFLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogInZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBlbEF0dHJzWyJjbGFzcyJdCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBdCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxBdHRycy5pZCkgaW5zdHJ1Y3Rpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfRUxFTUVOVCwKICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVmaXg6ICJiIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAic2V0LWF0dHIiLAogICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzOiBbIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfQVRUUklCVVRFLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogIm5hbWUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICJpZCIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0FUVFJJQlVURSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJ2YWx1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZWxBdHRycy5pZAogICAgICAgICAgICAgICAgICAgICAgICAgIH0gXQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsQXR0cnMucmVmKSBpZiAodG9rZW5SZWZNYXAuZWxlbWVudCkgZWxBdHRycy5yZWYudHJpbSgpLnNwbGl0KC9ccysvKS5tYXAoZnVuY3Rpb24ocmVmTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGFkZFRva2VuUmVmKHRva2VuUmVmTWFwLmVsZW1lbnQudG9rZW4sIHJlZk5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGNoaWxkOyBjaGlsZCA9IGluc3RydWN0aW9uc1tqXTsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLnR5cGUgPT0gVFlQRV9FTEVNRU5UICYmIGNoaWxkLnByZWZpeCA9PSAiYiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoY2hpbGQubmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkQXR0cnMgPSB0b2tlbkF0dHJzKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVOYW1lc3BhY2UgPSBjaGlsZEF0dHJzLm5hbWVzcGFjZSB8fCBjaGlsZEF0dHJzLm5zOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZUlzb2xhdGUgPSBzdHlsZU5hbWVzcGFjZSA/IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSA6IGlzb2xhdGVQcmVmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNyYyA9IGFkZFN0eWxlKHRlbXBsYXRlLCBjaGlsZCwgY2hpbGRBdHRycy5zcmMsIHN0eWxlSXNvbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlTmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3JjIGluIHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSA9PSBmYWxzZSkgc3R5bGVOYW1lc3BhY2VJc29sYXRlW3NyY10gPSBnZW5Jc29sYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZU5TUHJlZml4TWFwW3N0eWxlTmFtZXNwYWNlXSA9IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZVtzcmNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVwbGFjZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImJlZm9yZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImFmdGVyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVwbGFjZU9yUmVtb3ZlID0gY2hpbGQubmFtZSA9PSAicmVwbGFjZSIgfHwgY2hpbGQubmFtZSA9PSAicmVtb3ZlIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRBdHRycyA9IHRva2VuQXR0cnMoY2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWYgPSAicmVmIiBpbiBjaGlsZEF0dHJzIHx8ICFyZXBsYWNlT3JSZW1vdmUgPyBjaGlsZEF0dHJzLnJlZiA6ICJlbGVtZW50IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5SZWYgPSByZWYgJiYgdG9rZW5SZWZNYXBbcmVmXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW5SZWYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwb3MgPSB0b2tlblJlZi5vd25lci5pbmRleE9mKHRva2VuUmVmLnRva2VuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3MgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbIHBvcyArIChjaGlsZC5uYW1lID09ICJhZnRlciIpLCByZXBsYWNlT3JSZW1vdmUgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLm5hbWUgIT0gInJlbW92ZSIpIGFyZ3MgPSBhcmdzLmNvbmNhdChwcm9jZXNzKGNoaWxkLmNoaWxkcywgdGVtcGxhdGUsIG9wdGlvbnMpIHx8IFtdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5SZWYub3duZXIuc3BsaWNlLmFwcGx5KHRva2VuUmVmLm93bmVyLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInByZXBlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhcHBlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZEF0dHJzID0gdG9rZW5BdHRycyhjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZiA9ICJyZWYiIGluIGNoaWxkQXR0cnMgPyBjaGlsZEF0dHJzLnJlZiA6ICJlbGVtZW50IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5SZWYgPSByZWYgJiYgdG9rZW5SZWZNYXBbcmVmXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlblJlZiAmJiB0b2tlblJlZi50b2tlbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW4gJiYgdG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9FTEVNRU5UKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRzID0gcHJvY2VzcyhjaGlsZC5jaGlsZHMsIHRlbXBsYXRlLCBvcHRpb25zKSB8fCBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5uYW1lID09ICJwcmVwZW5kIikgdG9rZW4uc3BsaWNlLmFwcGx5KHRva2VuLCBbIEVMRU1FTlRfQVRUUlMsIDAgXS5jb25jYXQoY2hpbGRzKSk7IGVsc2UgdG9rZW4ucHVzaC5hcHBseSh0b2tlbiwgY2hpbGRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImF0dHIiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJzZXQtYXR0ciI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5QXR0cihjaGlsZCwgZmFsc2UsICJzZXQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiYXBwZW5kLWF0dHIiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUF0dHIoY2hpbGQsIGZhbHNlLCAiYXBwZW5kIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZS1hdHRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZnlBdHRyKGNoaWxkLCBmYWxzZSwgInJlbW92ZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJjbGFzcyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImFwcGVuZC1jbGFzcyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5QXR0cihjaGlsZCwgImNsYXNzIiwgImFwcGVuZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJzZXQtY2xhc3MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUF0dHIoY2hpbGQsICJjbGFzcyIsICJzZXQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVtb3ZlLWNsYXNzIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZnlBdHRyKGNoaWxkLCAiY2xhc3MiLCAicmVtb3ZlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImFkZC1yZWYiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZEF0dHJzID0gdG9rZW5BdHRycyhjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZiA9ICJyZWYiIGluIGNoaWxkQXR0cnMgPyBjaGlsZEF0dHJzLnJlZiA6ICJlbGVtZW50IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5SZWYgPSByZWYgJiYgdG9rZW5SZWZNYXBbcmVmXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlblJlZiAmJiB0b2tlblJlZi50b2tlbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW4gJiYgY2hpbGRBdHRycy5uYW1lKSBhZGRUb2tlblJlZih0b2tlbiwgY2hpbGRBdHRycy5uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVtb3ZlLXJlZiI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkQXR0cnMgPSB0b2tlbkF0dHJzKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVmID0gInJlZiIgaW4gY2hpbGRBdHRycyA/IGNoaWxkQXR0cnMucmVmIDogImVsZW1lbnQiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b2tlblJlZiA9IHJlZiAmJiB0b2tlblJlZk1hcFtyZWZdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRva2VuUmVmICYmIHRva2VuUmVmLnRva2VuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b2tlbikgcmVtb3ZlVG9rZW5SZWYodG9rZW4sIGNoaWxkQXR0cnMubmFtZSB8fCBjaGlsZEF0dHJzLnJlZik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiVW5rbm93biBpbnN0cnVjdGlvbiB0YWcgPGI6IiArIGNoaWxkLm5hbWUgKyAiPiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBkZWNsLnRva2Vucy5wdXNoLmFwcGx5KGRlY2wudG9rZW5zLCBwcm9jZXNzKFsgY2hpbGQgXSwgdGVtcGxhdGUsIG9wdGlvbnMpIHx8IFtdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW5SZWZNYXAuZWxlbWVudCkgcmVtb3ZlVG9rZW5SZWYodG9rZW5SZWZNYXAuZWxlbWVudC50b2tlbiwgImVsZW1lbnQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmFzaXMub2JqZWN0LmNvbXBsZXRlKHRlbXBsYXRlLnN0eWxlTlNQcmVmaXgsIHN0eWxlTlNQcmVmaXhNYXApOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNvbGF0ZVByZWZpeCkgaXNvbGF0ZVRva2VucyhkZWNsLnRva2VucywgaXNvbGF0ZVByZWZpeCk7IGVsc2UgaWYgKGRlY2wuaXNvbGF0ZSAmJiAhdGVtcGxhdGUuaXNvbGF0ZSkgdGVtcGxhdGUuaXNvbGF0ZSA9IG9wdGlvbnMuaXNvbGF0ZSB8fCBnZW5Jc29sYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoLmFwcGx5KHJlc3VsdCwgZGVjbC50b2tlbnMpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YWNrID0gaW5jbHVkZVN0YWNrLnNsaWNlKGluY2x1ZGVTdGFjay5pbmRleE9mKHJlc291cmNlKSB8fCAwKS5jb25jYXQocmVzb3VyY2UpLm1hcChmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzIGluc3RhbmNlb2YgVGVtcGxhdGUpIHJlcyA9IHJlcy5zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcyBpbnN0YW5jZW9mIEwxMG5Qcm94eVRva2VuKSByZXR1cm4gIntsMTBuOiIgKyByZXMudG9rZW4ubmFtZSArICJAIiArIHJlcy50b2tlbi5kaWN0aW9uYXJ5LnJlc291cmNlLnVybCArICJ9IjsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnVybCB8fCAiW2lubGluZSB0ZW1wbGF0ZV0iOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiUmVjdXJzaW9uOiAiLCBzdGFjay5qb2luKCIgLT4gIikpOwogICAgICAgICAgICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybigiUmVjdXJzaW9uIGluIHRlbXBsYXRlOiAiLCBzdGFjay5qb2luKCIgLT4gIikpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpdGVtID0gWyAxLCBiaW5kaW5ncywgcmVmcywgbmFtZSh0b2tlbikgXTsKICAgICAgICAgICAgICBpdGVtLnB1c2guYXBwbHkoaXRlbSwgYXR0cnModG9rZW4sIGl0ZW0sIG9wdGlvbnMub3B0aW1pemVTaXplKSB8fCBbXSk7CiAgICAgICAgICAgICAgaXRlbS5wdXNoLmFwcGx5KGl0ZW0sIHByb2Nlc3ModG9rZW4uY2hpbGRzLCB0ZW1wbGF0ZSwgb3B0aW9ucykgfHwgW10pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRZUEVfVEVYVDoKICAgICAgICAgICAgICBpZiAocmVmcyAmJiByZWZzLmxlbmd0aCA9PSAyICYmIGFycmF5U2VhcmNoKHJlZnMsICJlbGVtZW50IikpIGJpbmRpbmdzID0gcmVmc1srIXJlZnMubGFzdFNlYXJjaEluZGV4XTsKICAgICAgICAgICAgICBpZiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgICAgIHZhciBsMTBuQmluZGluZyA9IGFic2wxMG4oYmluZGluZ3MsIHRlbXBsYXRlLmRpY3RVUkkpOwogICAgICAgICAgICAgICAgdmFyIHBhcnRzID0gbDEwbkJpbmRpbmcuc3BsaXQoL1s6QFx7XS8pOwogICAgICAgICAgICAgICAgaWYgKHBhcnRzWzBdID09ICJsMTBuIiAmJiBwYXJ0cy5sZW5ndGggPT0gMykgewogICAgICAgICAgICAgICAgICBpZiAoIXBhcnRzWzJdKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUocmVmcywgYmluZGluZ3MpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWZzLmxlbmd0aCA9PSAwKSByZWZzID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IDA7CiAgICAgICAgICAgICAgICAgICAgdG9rZW4udmFsdWUgPSB0b2tlbi52YWx1ZS5yZXBsYWNlKC9cfSQvLCAiQHVuZGVmaW5lZH0iKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbDEwbklkID0gcGFydHMuc2xpY2UoMSkuam9pbigiQCIpOwogICAgICAgICAgICAgICAgICAgIHZhciBsMTBuVG9rZW4gPSBiYXNpcy5sMTBuLnRva2VuKGwxMG5JZCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGwxMG5UZW1wbGF0ZSA9IGdldEwxMG5UZW1wbGF0ZShsMTBuVG9rZW4pOwogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLmwxMG5SZXNvbHZlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGwxMG5UZW1wbGF0ZSAmJiBsMTBuVG9rZW4udHlwZSA9PSAibWFya3VwIikgewogICAgICAgICAgICAgICAgICAgICAgdG9rZW5zW2ktLV0gPSB0b2tlbml6ZSgnPGI6aW5jbHVkZSBzcmM9IiMnICsgbDEwblRlbXBsYXRlLnRlbXBsYXRlSWQgKyAnIi8+JylbMF07CiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgYXJyYXlBZGQodGVtcGxhdGUubDEwbiwgbDEwbklkKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpdGVtID0gWyAzLCBiaW5kaW5ncywgcmVmcyBdOwogICAgICAgICAgICAgIGlmICghcmVmcyB8fCB0b2tlbi52YWx1ZSAhPSAieyIgKyByZWZzLmpvaW4oInwiKSArICJ9IikgaXRlbS5wdXNoKHVudG9rZW4odG9rZW4udmFsdWUpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX0NPTU1FTlQ6CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMub3B0aW1pemVTaXplICYmICFiaW5kaW5ncyAmJiAhcmVmcykgY29udGludWU7CiAgICAgICAgICAgICAgaXRlbSA9IFsgOCwgYmluZGluZ3MsIHJlZnMgXTsKICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMub3B0aW1pemVTaXplKSBpZiAoIXJlZnMgfHwgdG9rZW4udmFsdWUgIT0gInsiICsgcmVmcy5qb2luKCJ8IikgKyAifSIpIGl0ZW0ucHVzaCh1bnRva2VuKHRva2VuLnZhbHVlKSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoaXRlbVtpdGVtLmxlbmd0aCAtIDFdID09PSAwKSBpdGVtLnBvcCgpOwogICAgICAgICAgcmVzdWx0LnB1c2goaXRlbSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQubGVuZ3RoID8gcmVzdWx0IDogMDsKICAgICAgfQogICAgICBmdW5jdGlvbiBhYnNsMTBuKHZhbHVlLCBkaWN0VVJJKSB7CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPSAic3RyaW5nIikgcmV0dXJuIHZhbHVlOwogICAgICAgIHZhciBwYXJ0cyA9IHZhbHVlLnNwbGl0KCI6Iik7CiAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA9PSAyICYmIHBhcnRzWzBdID09ICJsMTBuIiAmJiBwYXJ0c1sxXS5pbmRleE9mKCJAIikgPT0gLTEpIHBhcnRzWzFdID0gcGFydHNbMV0gKyAiQCIgKyBkaWN0VVJJOwogICAgICAgIHJldHVybiBwYXJ0cy5qb2luKCI6Iik7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbm9ybWFsaXplUmVmcyh0b2tlbnMsIGRpY3RVUkksIG1hcCwgc3RJZHgpIHsKICAgICAgICBpZiAoIW1hcCkgbWFwID0ge307CiAgICAgICAgZm9yICh2YXIgaSA9IHN0SWR4IHx8IDAsIHRva2VuOyB0b2tlbiA9IHRva2Vuc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9BVFRSSUJVVEVfRVZFTlQpIGNvbnRpbnVlOwogICAgICAgICAgdmFyIHJlZnMgPSB0b2tlbltUT0tFTl9SRUZTXTsKICAgICAgICAgIGlmIChyZWZzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGogPSByZWZzLmxlbmd0aCAtIDEsIHJlZk5hbWU7IHJlZk5hbWUgPSByZWZzW2pdOyBqLS0pIHsKICAgICAgICAgICAgICBpZiAocmVmTmFtZS5pbmRleE9mKCI6IikgIT0gLTEpIHsKICAgICAgICAgICAgICAgIHJlbW92ZVRva2VuUmVmKHRva2VuLCByZWZOYW1lKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobWFwW3JlZk5hbWVdKSByZW1vdmVUb2tlblJlZihtYXBbcmVmTmFtZV0udG9rZW4sIHJlZk5hbWUpOwogICAgICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9CSU5ESU5HU10gPT0gcmVmTmFtZSkgdG9rZW5bVE9LRU5fQklORElOR1NdID0gaiArIDE7CiAgICAgICAgICAgICAgbWFwW3JlZk5hbWVdID0gewogICAgICAgICAgICAgICAgb3duZXI6IHRva2VucywKICAgICAgICAgICAgICAgIHRva2VuOiB0b2tlbgogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodG9rZW5bVE9LRU5fVFlQRV0pIHsKICAgICAgICAgICAgY2FzZSBUWVBFX1RFWFQ6CiAgICAgICAgICAgICAgdG9rZW5bVE9LRU5fQklORElOR1NdID0gYWJzbDEwbih0b2tlbltUT0tFTl9CSU5ESU5HU10sIGRpY3RVUkkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRZUEVfQVRUUklCVVRFOgogICAgICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9CSU5ESU5HU10pIHsKICAgICAgICAgICAgICAgIHZhciBhcnJheSA9IHRva2VuW1RPS0VOX0JJTkRJTkdTXVswXTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXJyYXkubGVuZ3RoOyBqKyspIGFycmF5W2pdID0gYWJzbDEwbihhcnJheVtqXSwgZGljdFVSSSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRZUEVfRUxFTUVOVDoKICAgICAgICAgICAgICBub3JtYWxpemVSZWZzKHRva2VuLCBkaWN0VVJJLCBtYXAsIEVMRU1FTlRfQVRUUlMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWFwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFwcGx5RGVmaW5lcyh0b2tlbnMsIHRlbXBsYXRlLCBvcHRpb25zLCBzdElkeCkgewogICAgICAgIHZhciB1bnByZWRpY3RhYmxlID0gMDsKICAgICAgICBmb3IgKHZhciBpID0gc3RJZHggfHwgMCwgdG9rZW47IHRva2VuID0gdG9rZW5zW2ldOyBpKyspIHsKICAgICAgICAgIHZhciB0b2tlblR5cGUgPSB0b2tlbltUT0tFTl9UWVBFXTsKICAgICAgICAgIGlmICh0b2tlblR5cGUgPT0gVFlQRV9FTEVNRU5UKSB1bnByZWRpY3RhYmxlICs9IGFwcGx5RGVmaW5lcyh0b2tlbiwgdGVtcGxhdGUsIG9wdGlvbnMsIEVMRU1FTlRfQVRUUlMpOwogICAgICAgICAgaWYgKHRva2VuVHlwZSA9PSBUWVBFX0FUVFJJQlVURV9DTEFTUyB8fCB0b2tlblR5cGUgPT0gVFlQRV9BVFRSSUJVVEUgJiYgdG9rZW5bQVRUUl9OQU1FXSA9PSAiY2xhc3MiKSB7CiAgICAgICAgICAgIHZhciBiaW5kaW5ncyA9IHRva2VuW1RPS0VOX0JJTkRJTkdTXTsKICAgICAgICAgICAgdmFyIHZhbHVlSWR4ID0gQVRUUl9WQUxVRV9JTkRFWFt0b2tlblR5cGVdOwogICAgICAgICAgICBpZiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgICB2YXIgbmV3QXR0clZhbHVlID0gKHRva2VuW3ZhbHVlSWR4XSB8fCAiIikudHJpbSgpLnNwbGl0KCIgIik7CiAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIGJpbmQ7IGJpbmQgPSBiaW5kaW5nc1trXTsgaysrKSB7CiAgICAgICAgICAgICAgICBpZiAoYmluZC5sZW5ndGggPiAyKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIHZhciBiaW5kTmFtZSA9IGJpbmRbMV0uc3BsaXQoIjoiKS5wb3AoKTsKICAgICAgICAgICAgICAgIHZhciBiaW5kRGVmID0gdGVtcGxhdGUuZGVmaW5lc1tiaW5kTmFtZV07CiAgICAgICAgICAgICAgICBpZiAoYmluZERlZikgewogICAgICAgICAgICAgICAgICBiaW5kLnB1c2guYXBwbHkoYmluZCwgYmluZERlZik7CiAgICAgICAgICAgICAgICAgIGJpbmREZWYudXNlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGlmIChiaW5kRGVmWzBdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmREZWYubGVuZ3RoID09IDEpIGFycmF5QWRkKG5ld0F0dHJWYWx1ZSwgYmluZFswXSArIGJpbmROYW1lKTsgZWxzZSBhcnJheUFkZChuZXdBdHRyVmFsdWUsIGJpbmRbMF0gKyBiaW5kRGVmWzFdW2JpbmREZWZbMF0gLSAxXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIlVucHJlZGljdGFibGUgdmFsdWUgYCIgKyBiaW5kTmFtZSArICJgIGluIGNsYXNzIGJpbmRpbmc6ICIgKyBiaW5kWzBdICsgInsiICsgYmluZFsxXSArICJ9Iik7CiAgICAgICAgICAgICAgICAgIHVucHJlZGljdGFibGUrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdG9rZW5bdmFsdWVJZHhdID0gbmV3QXR0clZhbHVlLmpvaW4oIiAiKTsKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5vcHRpbWl6ZVNpemUgJiYgIXRva2VuW3ZhbHVlSWR4XSkgdG9rZW4ubGVuZ3RoID0gdmFsdWVJZHg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVucHJlZGljdGFibGU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNvbGF0ZVRva2Vucyh0b2tlbnMsIGlzb2xhdGUsIHRlbXBsYXRlLCBzdElkeCkgewogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NOYW1lKG5hbWUpIHsKICAgICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoIjoiKTsKICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPT0gMSkgcmV0dXJuIGlzb2xhdGUgKyBwYXJ0c1swXTsKICAgICAgICAgIGlmICghdGVtcGxhdGUpIHJldHVybiBuYW1lOwogICAgICAgICAgaWYgKCFwYXJ0c1swXSkgcmV0dXJuIHBhcnRzWzFdOwogICAgICAgICAgaWYgKHBhcnRzWzBdIGluIHRlbXBsYXRlLnN0eWxlTlNQcmVmaXggPT0gZmFsc2UpIHsKICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiTmFtZXNwYWNlIGAiICsgcGFydHNbMF0gKyAiYCBpcyBub3QgZGVmaW5lZCBpbiB0ZW1wbGF0ZSwgbm8gcHJlZml4IGFkZGVkIik7CiAgICAgICAgICAgIHJldHVybiBuYW1lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRlbXBsYXRlLnN0eWxlTlNQcmVmaXhbcGFydHNbMF1dICsgcGFydHNbMV07CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSBzdElkeCB8fCAwLCB0b2tlbjsgdG9rZW4gPSB0b2tlbnNbaV07IGkrKykgewogICAgICAgICAgdmFyIHRva2VuVHlwZSA9IHRva2VuW1RPS0VOX1RZUEVdOwogICAgICAgICAgaWYgKHRva2VuVHlwZSA9PSBUWVBFX0VMRU1FTlQpIGlzb2xhdGVUb2tlbnModG9rZW4sIGlzb2xhdGUsIHRlbXBsYXRlLCBFTEVNRU5UX0FUVFJTKTsKICAgICAgICAgIGlmICh0b2tlblR5cGUgPT0gVFlQRV9BVFRSSUJVVEVfQ0xBU1MgfHwgdG9rZW5UeXBlID09IFRZUEVfQVRUUklCVVRFICYmIHRva2VuW0FUVFJfTkFNRV0gPT0gImNsYXNzIikgewogICAgICAgICAgICB2YXIgYmluZGluZ3MgPSB0b2tlbltUT0tFTl9CSU5ESU5HU107CiAgICAgICAgICAgIHZhciB2YWx1ZUluZGV4ID0gQVRUUl9WQUxVRV9JTkRFWFt0b2tlblR5cGVdOwogICAgICAgICAgICBpZiAodG9rZW5bdmFsdWVJbmRleF0pIHRva2VuW3ZhbHVlSW5kZXhdID0gdG9rZW5bdmFsdWVJbmRleF0uc3BsaXQoL1xzKy8pLm1hcChwcm9jZXNzTmFtZSkuam9pbigiICIpOwogICAgICAgICAgICBpZiAoYmluZGluZ3MpIGZvciAodmFyIGsgPSAwLCBiaW5kOyBiaW5kID0gYmluZGluZ3Nba107IGsrKykgYmluZFswXSA9IHByb2Nlc3NOYW1lKGJpbmRbMF0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24gbWFrZURlY2xhcmF0aW9uKHNvdXJjZSwgYmFzZVVSSSwgb3B0aW9ucywgc291cmNlVXJsLCBzb3VyY2VPcmlnaW4pIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICB2YXIgd2FybnMgPSBbXTsKICAgICAgICB2YXIgc291cmNlXzsKICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgc291cmNlVXJsOiBzb3VyY2VVcmwsCiAgICAgICAgICBiYXNlVVJJOiBiYXNlVVJJIHx8ICIiLAogICAgICAgICAgdG9rZW5zOiBudWxsLAogICAgICAgICAgcmVzb3VyY2VzOiBbXSwKICAgICAgICAgIHN0eWxlTlNQcmVmaXg6IHt9LAogICAgICAgICAgZGVwczogW10sCiAgICAgICAgICBsMTBuOiBbXSwKICAgICAgICAgIGRlZmluZXM6IHt9LAogICAgICAgICAgdW5wcmVkaWN0YWJsZTogdHJ1ZSwKICAgICAgICAgIHdhcm5zOiB3YXJucywKICAgICAgICAgIGlzb2xhdGU6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICByZXN1bHQuZGljdFVSSSA9IHNvdXJjZVVybCA/IGJhc2lzLnBhdGgucmVzb2x2ZShzb3VyY2VVcmwpIDogYmFzZVVSSSB8fCAiIjsKICAgICAgICBpZiAocmVzdWx0LmRpY3RVUkkpIHsKICAgICAgICAgIHZhciBleHRuYW1lID0gYmFzaXMucGF0aC5leHRuYW1lKHJlc3VsdC5kaWN0VVJJKTsKICAgICAgICAgIGlmIChleHRuYW1lICYmIGV4dG5hbWUgIT0gIi5sMTBuIikgcmVzdWx0LmRpY3RVUkkgPSByZXN1bHQuZGljdFVSSS5zdWJzdHIoMCwgcmVzdWx0LmRpY3RVUkkubGVuZ3RoIC0gZXh0bmFtZS5sZW5ndGgpICsgIi5sMTBuIjsKICAgICAgICB9CiAgICAgICAgaWYgKCFzb3VyY2UudGVtcGxhdGVUb2tlbnMpIHsKICAgICAgICAgIHNvdXJjZV8gPSBzb3VyY2U7CiAgICAgICAgICBzb3VyY2UgPSB0b2tlbml6ZShTdHJpbmcoc291cmNlKSk7CiAgICAgICAgfQogICAgICAgIGlmIChzb3VyY2Uud2FybnMpIHdhcm5zLnB1c2guYXBwbHkod2FybnMsIHNvdXJjZS53YXJucyk7CiAgICAgICAgaW5jbHVkZVN0YWNrLnB1c2goc291cmNlT3JpZ2luICE9PSB0cnVlICYmIHNvdXJjZU9yaWdpbiB8fCB7fSk7CiAgICAgICAgcmVzdWx0LnRva2VucyA9IHByb2Nlc3Moc291cmNlLCByZXN1bHQsIG9wdGlvbnMpOwogICAgICAgIGluY2x1ZGVTdGFjay5wb3AoKTsKICAgICAgICBpZiAoIXJlc3VsdC50b2tlbnMpIHJlc3VsdC50b2tlbnMgPSBbIFsgMywgMCwgMCwgIiIgXSBdOwogICAgICAgIGlmIChzb3VyY2VfKSByZXN1bHQudG9rZW5zLnNvdXJjZV8gPSBzb3VyY2VfOwogICAgICAgIGFkZFRva2VuUmVmKHJlc3VsdC50b2tlbnNbMF0sICJlbGVtZW50Iik7CiAgICAgICAgbm9ybWFsaXplUmVmcyhyZXN1bHQudG9rZW5zLCByZXN1bHQuZGljdFVSSSk7CiAgICAgICAgcmVzdWx0LnVucHJlZGljdGFibGUgPSAhIWFwcGx5RGVmaW5lcyhyZXN1bHQudG9rZW5zLCByZXN1bHQsIG9wdGlvbnMpOwogICAgICAgIGlmICgvXlteYS16XS9pLnRlc3QocmVzdWx0Lmlzb2xhdGUpKSBiYXNpcy5kZXYuZXJyb3IoImJhc2lzLnRlbXBsYXRlOiBpc29sYXRpb24gcHJlZml4IGAiICsgcmVzdWx0Lmlzb2xhdGUgKyAiYCBzaG91bGQgbm90IHN0YXJ0cyB3aXRoIHN5bWJvbCBvdGhlciB0aGFuIGxldHRlciwgb3RoZXJ3aXNlIGl0IGxlYWRzIHRvIGluY29ycmVjdCBjc3MgY2xhc3MgbmFtZXMgYW5kIGJyb2tlbiBzdHlsZXMiKTsKICAgICAgICBpZiAoaW5jbHVkZVN0YWNrLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICBpc29sYXRlVG9rZW5zKHJlc3VsdC50b2tlbnMsIHJlc3VsdC5pc29sYXRlIHx8ICIiLCByZXN1bHQpOwogICAgICAgICAgaWYgKHJlc3VsdC5pc29sYXRlKSBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IHJlc3VsdC5yZXNvdXJjZXNbaV07IGkrKykgaWYgKGl0ZW1bMV0gIT09IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSkgaXRlbVsxXSA9IHJlc3VsdC5pc29sYXRlICsgaXRlbVsxXTsKICAgICAgICAgIHJlc3VsdC5yZXNvdXJjZXMgPSByZXN1bHQucmVzb3VyY2VzLmZpbHRlcihmdW5jdGlvbihpdGVtLCBpZHgsIGFycmF5KSB7CiAgICAgICAgICAgIHJldHVybiAhYmFzaXMuYXJyYXkuc2VhcmNoKGFycmF5LCBTdHJpbmcoaXRlbSksIFN0cmluZywgaWR4ICsgMSk7CiAgICAgICAgICB9KS5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICB2YXIgdXJsID0gaXRlbVswXTsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSBpdGVtWzFdOwogICAgICAgICAgICBpZiAoaXNvbGF0ZSA9PT0gc3R5bGVOYW1lc3BhY2VJc29sYXRlKSBpc29sYXRlID0gc3R5bGVOYW1lc3BhY2VJc29sYXRlW3VybF07CiAgICAgICAgICAgIGlmICghaXNvbGF0ZSkgcmV0dXJuIHVybDsKICAgICAgICAgICAgdmFyIHJlc291cmNlID0gYmFzaXMucmVzb3VyY2UudmlydHVhbCgiY3NzIiwgIiIpLnJlYWR5KGZ1bmN0aW9uKGNzc1Jlc291cmNlKSB7CiAgICAgICAgICAgICAgc291cmNlUmVzb3VyY2UoKTsKICAgICAgICAgICAgICBiYXNpcy5vYmplY3QuZXh0ZW5kKGNzc1Jlc291cmNlLCB7CiAgICAgICAgICAgICAgICB1cmw6IHVybCArICI/aXNvbGF0ZS1wcmVmaXg9IiArIGlzb2xhdGUsCiAgICAgICAgICAgICAgICBiYXNlVVJJOiBiYXNpcy5wYXRoLmRpcm5hbWUodXJsKSArICIvIgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIHNvdXJjZVJlc291cmNlID0gYmFzaXMucmVzb3VyY2UodXJsKS5yZWFkeShmdW5jdGlvbihjc3NSZXNvdXJjZSkgewogICAgICAgICAgICAgIHZhciBjc3NUZXh0ID0gaXNvbGF0ZUNzcyhjc3NSZXNvdXJjZS5jc3NUZXh0IHx8ICIiLCBpc29sYXRlKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGJ0b2EgPT0gImZ1bmN0aW9uIikgY3NzVGV4dCArPSAiXG4vKiMgc291cmNlTWFwcGluZ1VSTD1kYXRhOmFwcGxpY2F0aW9uL2pzb247YmFzZTY0LCIgKyBidG9hKCd7InZlcnNpb24iOjMsInNvdXJjZXMiOlsiJyArIGJhc2lzLnBhdGgub3JpZ2luICsgdXJsICsgJyJdLCcgKyAnIm1hcHBpbmdzIjoiQUFBQScgKyBiYXNpcy5zdHJpbmcucmVwZWF0KCI7QUFDQSIsIGNzc1RleHQuc3BsaXQoIlxuIikubGVuZ3RoKSArICcifScpICsgIiAqLyI7CiAgICAgICAgICAgICAgcmVzb3VyY2UudXBkYXRlKGNzc1RleHQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHJlc291cmNlLnVybDsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBrZXkgaW4gcmVzdWx0LmRlZmluZXMpIGlmICghcmVzdWx0LmRlZmluZXNba2V5XS51c2VkKSB3YXJucy5wdXNoKCJVbnVzZWQgZGVmaW5lIGZvciAiICsga2V5KTsKICAgICAgICBkZWxldGUgcmVzdWx0LmRlZmluZXM7CiAgICAgICAgZGVsZXRlIHJlc3VsdC5sMTBuUmVzb2x2ZWQ7CiAgICAgICAgaWYgKCF3YXJucy5sZW5ndGgpIHJlc3VsdC53YXJucyA9IGZhbHNlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9KCk7CiAgICBmdW5jdGlvbiBzdGFydFVzZVJlc291cmNlKHVyaSkgewogICAgICB2YXIgcmVzb3VyY2UgPSBiYXNpcy5yZXNvdXJjZSh1cmkpLmZldGNoKCk7CiAgICAgIGlmICh0eXBlb2YgcmVzb3VyY2Uuc3RhcnRVc2UgPT0gImZ1bmN0aW9uIikgcmVzb3VyY2Uuc3RhcnRVc2UoKTsKICAgIH0KICAgIGZ1bmN0aW9uIHN0b3BVc2VSZXNvdXJjZSh1cmkpIHsKICAgICAgdmFyIHJlc291cmNlID0gYmFzaXMucmVzb3VyY2UodXJpKS5mZXRjaCgpOwogICAgICBpZiAodHlwZW9mIHJlc291cmNlLnN0b3BVc2UgPT0gImZ1bmN0aW9uIikgcmVzb3VyY2Uuc3RvcFVzZSgpOwogICAgfQogICAgZnVuY3Rpb24gdGVtcGxhdGVTb3VyY2VVcGRhdGUoKSB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3lCdWlsZGVyKSBidWlsZFRlbXBsYXRlLmNhbGwodGhpcyk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhdHRhY2g7IGF0dGFjaCA9IHRoaXMuYXR0YWNoZXNfW2ldOyBpKyspIGF0dGFjaC5oYW5kbGVyLmNhbGwoYXR0YWNoLmNvbnRleHQpOwogICAgfQogICAgZnVuY3Rpb24gY2xvbmVEZWNsKGFycmF5KSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgaWYgKGFycmF5LnNvdXJjZV8pIHJlc3VsdC5zb3VyY2VfID0gYXJyYXkuc291cmNlXzsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgcmVzdWx0LnB1c2goQXJyYXkuaXNBcnJheShhcnJheVtpXSkgPyBjbG9uZURlY2woYXJyYXlbaV0pIDogYXJyYXlbaV0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gZ2V0RGVjbEZyb21Tb3VyY2Uoc291cmNlLCBiYXNlVVJJLCBjbG9uZSwgb3B0aW9ucykgewogICAgICB2YXIgcmVzdWx0ID0gc291cmNlOwogICAgICB2YXIgc291cmNlVXJsOwogICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgYmFzZVVSSSA9ICJiYXNlVVJJIiBpbiBzb3VyY2UgPyBzb3VyY2UuYmFzZVVSSSA6IGJhc2VVUkk7CiAgICAgICAgc291cmNlVXJsID0gInVybCIgaW4gc291cmNlID8gc291cmNlLnVybCA6IHNvdXJjZVVybDsKICAgICAgICByZXN1bHQgPSByZXN1bHQoKTsKICAgICAgfQogICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgYmFzaXMuVG9rZW4pIHsKICAgICAgICBiYXNlVVJJID0gImJhc2VVUkkiIGluIHNvdXJjZSA/IHNvdXJjZS5iYXNlVVJJIDogYmFzZVVSSTsKICAgICAgICBzb3VyY2VVcmwgPSAidXJsIiBpbiBzb3VyY2UgPyBzb3VyY2UudXJsIDogc291cmNlVXJsOwogICAgICAgIHJlc3VsdCA9IHJlc3VsdC5nZXQoKTsKICAgICAgfQogICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7CiAgICAgICAgaWYgKGNsb25lKSByZXN1bHQgPSBjbG9uZURlY2wocmVzdWx0KTsKICAgICAgICByZXN1bHQgPSB7CiAgICAgICAgICB0b2tlbnM6IHJlc3VsdAogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgIT0gIm9iamVjdCIgfHwgIUFycmF5LmlzQXJyYXkocmVzdWx0LnRva2VucykpIHJlc3VsdCA9IFN0cmluZyhyZXN1bHQpOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgcmVzdWx0ID09ICJzdHJpbmciKSByZXN1bHQgPSBtYWtlRGVjbGFyYXRpb24ocmVzdWx0LCBiYXNlVVJJLCBvcHRpb25zLCBzb3VyY2VVcmwsIHNvdXJjZSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBmdW5jdGlvbiBsMTBuSGFuZGxlcih2YWx1ZSkgewogICAgICBpZiAodGhpcy50eXBlICE9ICJtYXJrdXAiICYmIHRoaXMudG9rZW4udHlwZSA9PSAibWFya3VwIikgewogICAgICAgIGJ1aWxkVGVtcGxhdGUuY2FsbCh0aGlzLnRlbXBsYXRlKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gYnVpbGRUZW1wbGF0ZSgpIHsKICAgICAgdmFyIGRlY2wgPSBnZXREZWNsRnJvbVNvdXJjZSh0aGlzLnNvdXJjZSwgdGhpcy5iYXNlVVJJLCBmYWxzZSwgewogICAgICAgIGlzb2xhdGU6IHRoaXMuZ2V0SXNvbGF0ZVByZWZpeCgpCiAgICAgIH0pOwogICAgICB2YXIgZGVzdHJveUJ1aWxkZXIgPSB0aGlzLmRlc3Ryb3lCdWlsZGVyOwogICAgICB2YXIgZnVuY3MgPSB0aGlzLmJ1aWxkZXIoZGVjbC50b2tlbnMsIHRoaXMpOwogICAgICB2YXIgZGVwcyA9IHRoaXMuZGVwc187CiAgICAgIHZhciBsMTBuID0gdGhpcy5sMTBuXzsKICAgICAgaWYgKGRlcHMpIHsKICAgICAgICB0aGlzLmRlcHNfID0gbnVsbDsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZGVwOyBkZXAgPSBkZXBzW2ldOyBpKyspIGRlcC5iaW5kaW5nQnJpZGdlLmRldGFjaChkZXAsIGJ1aWxkVGVtcGxhdGUsIHRoaXMpOwogICAgICB9CiAgICAgIGlmIChsMTBuKSBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGwxMG5baV07IGkrKykgaXRlbS50b2tlbi5iaW5kaW5nQnJpZGdlLmRldGFjaChpdGVtLnRva2VuLCBsMTBuSGFuZGxlciwgaXRlbSk7CiAgICAgIGlmIChkZWNsLmRlcHMgJiYgZGVjbC5kZXBzLmxlbmd0aCkgewogICAgICAgIGRlcHMgPSBkZWNsLmRlcHM7CiAgICAgICAgdGhpcy5kZXBzXyA9IGRlcHM7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGRlcDsgZGVwID0gZGVwc1tpXTsgaSsrKSBkZXAuYmluZGluZ0JyaWRnZS5hdHRhY2goZGVwLCBidWlsZFRlbXBsYXRlLCB0aGlzKTsKICAgICAgfQogICAgICBpZiAoZGVjbC5sMTBuKSB7CiAgICAgICAgbDEwbiA9IGRlY2wubDEwbjsKICAgICAgICB0aGlzLmwxMG5fID0ge307CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGtleTsga2V5ID0gbDEwbltpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgbDEwblRva2VuID0gYmFzaXMubDEwbi50b2tlbihrZXkpOwogICAgICAgICAgbDEwblRva2VuLmJpbmRpbmdCcmlkZ2UuYXR0YWNoKGwxMG5Ub2tlbiwgbDEwbkhhbmRsZXIsIHRoaXMubDEwbl9ba2V5XSA9IHsKICAgICAgICAgICAgdGVtcGxhdGU6IHRoaXMsCiAgICAgICAgICAgIHRva2VuOiBsMTBuVG9rZW4sCiAgICAgICAgICAgIHR5cGU6IGwxMG5Ub2tlbi50eXBlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5jcmVhdGVJbnN0YW5jZSA9IGZ1bmNzLmNyZWF0ZUluc3RhbmNlOwogICAgICB0aGlzLmNsZWFySW5zdGFuY2UgPSBmdW5jcy5kZXN0cm95SW5zdGFuY2U7CiAgICAgIHRoaXMuZ2V0QmluZGluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBuYW1lczogZnVuY3Mua2V5cwogICAgICAgIH07CiAgICAgIH07CiAgICAgIHRoaXMuZGVzdHJveUJ1aWxkZXIgPSBmdW5jcy5kZXN0cm95OwogICAgICB0aGlzLmluc3RhbmNlc18gPSBmdW5jcy5pbnN0YW5jZXNfOwogICAgICB0aGlzLmRlY2xfID0gZGVjbDsKICAgICAgdmFyIGRlY2xSZXNvdXJjZXMgPSBkZWNsLnJlc291cmNlcyAmJiBkZWNsLnJlc291cmNlcy5sZW5ndGggPiAwID8gZGVjbC5yZXNvdXJjZXMgOiBudWxsOwogICAgICBpZiAoZGVjbFJlc291cmNlcykgZm9yICh2YXIgaSA9IDAsIHJlczsgcmVzID0gZGVjbFJlc291cmNlc1tpXTsgaSsrKSBzdGFydFVzZVJlc291cmNlKHJlcyk7CiAgICAgIGlmICh0aGlzLnJlc291cmNlcykgZm9yICh2YXIgaSA9IDAsIHJlczsgcmVzID0gdGhpcy5yZXNvdXJjZXNbaV07IGkrKykgc3RvcFVzZVJlc291cmNlKHJlcyk7CiAgICAgIHRoaXMucmVzb3VyY2VzID0gZGVjbFJlc291cmNlczsKICAgICAgaWYgKGRlc3Ryb3lCdWlsZGVyKSBkZXN0cm95QnVpbGRlcih0cnVlKTsKICAgIH0KICAgIHZhciBzb3VyY2VCeURvY3VtZW50SWRSZXNvbHZlcnMgPSB7fTsKICAgIGZ1bmN0aW9uIGdldFRlbXBsYXRlQnlEb2N1bWVudElkKGlkKSB7CiAgICAgIHZhciByZXNvbHZlciA9IHJlc29sdmVTb3VyY2VCeURvY3VtZW50SWQoaWQpOwogICAgICBpZiAocmVzb2x2ZXIudGVtcGxhdGUpIHJldHVybiByZXNvbHZlci50ZW1wbGF0ZTsKICAgICAgdmFyIGhvc3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgIHZhciBzb3VyY2UgPSAiIjsKICAgICAgaWYgKGhvc3QgJiYgaG9zdC50YWdOYW1lID09ICJTQ1JJUFQiICYmIGhvc3QudHlwZSA9PSAidGV4dC9iYXNpcy10ZW1wbGF0ZSIpIHNvdXJjZSA9IGhvc3QudGV4dENvbnRlbnQgfHwgaG9zdC50ZXh0OyBlbHNlIGlmICghaG9zdCkgYmFzaXMuZGV2Lndhcm4oIlRlbXBsYXRlIHNjcmlwdCBlbGVtZW50IHdpdGggaWQgYCIgKyBpZCArICJgIG5vdCBmb3VuZCIpOyBlbHNlIGJhc2lzLmRldi53YXJuKCdUZW1wbGF0ZSBzaG91bGQgYmUgZGVjbGFyZWQgaW4gPHNjcmlwdCB0eXBlPSJ0ZXh0L2Jhc2lzLXRlbXBsYXRlIj4gZWxlbWVudCAoaWQgYCcgKyBzb3VyY2VJZCArICJgKSIpOwogICAgICByZXR1cm4gcmVzb2x2ZXIudGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUoc291cmNlKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlc29sdmVTb3VyY2VCeURvY3VtZW50SWQoc291cmNlSWQpIHsKICAgICAgdmFyIHJlc29sdmVyID0gc291cmNlQnlEb2N1bWVudElkUmVzb2x2ZXJzW3NvdXJjZUlkXTsKICAgICAgaWYgKCFyZXNvbHZlcikgewogICAgICAgIHJlc29sdmVyID0gc291cmNlQnlEb2N1bWVudElkUmVzb2x2ZXJzW3NvdXJjZUlkXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGdldFRlbXBsYXRlQnlEb2N1bWVudElkKHNvdXJjZUlkKS5zb3VyY2U7CiAgICAgICAgfTsKICAgICAgICByZXNvbHZlci5pZCA9IHNvdXJjZUlkOwogICAgICAgIHJlc29sdmVyLnVybCA9ICc8c2NyaXB0IGlkPSInICsgc291cmNlSWQgKyAnIi8+JzsKICAgICAgfQogICAgICByZXR1cm4gcmVzb2x2ZXI7CiAgICB9CiAgICB2YXIgVGVtcGxhdGUgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UZW1wbGF0ZSIsCiAgICAgIF9fZXh0ZW5kX186IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgVGVtcGxhdGUpIHJldHVybiB2YWx1ZTsKICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBUZW1wbGF0ZVN3aXRjaENvbmZpZykgcmV0dXJuIG5ldyBUZW1wbGF0ZVN3aXRjaGVyKHZhbHVlKTsKICAgICAgICByZXR1cm4gbmV3IFRlbXBsYXRlKHZhbHVlKTsKICAgICAgfSwKICAgICAgc291cmNlOiAiIiwKICAgICAgYmFzZVVSSTogIiIsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIGlmICh0ZW1wbGF0ZUxpc3QubGVuZ3RoID09IDQwOTYpIHRocm93ICJUb28gbWFueSB0ZW1wbGF0ZXMgKG1heGltdW0gNDA5NikiOwogICAgICAgIHRoaXMuYXR0YWNoZXNfID0gW107CiAgICAgICAgdGhpcy5zZXRTb3VyY2Uoc291cmNlIHx8ICIiKTsKICAgICAgICB0aGlzLnRlbXBsYXRlSWQgPSB0ZW1wbGF0ZUxpc3QucHVzaCh0aGlzKSAtIDE7CiAgICAgIH0sCiAgICAgIGJpbmRpbmdCcmlkZ2U6IHsKICAgICAgICBhdHRhY2g6IGZ1bmN0aW9uKHRlbXBsYXRlLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGlzdGVuZXI7IGxpc3RlbmVyID0gdGVtcGxhdGUuYXR0YWNoZXNfW2ldOyBpKyspIGlmIChsaXN0ZW5lci5oYW5kbGVyID09IGhhbmRsZXIgJiYgbGlzdGVuZXIuY29udGV4dCA9PSBjb250ZXh0KSByZXR1cm47CiAgICAgICAgICB0ZW1wbGF0ZS5hdHRhY2hlc18ucHVzaCh7CiAgICAgICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgZGV0YWNoOiBmdW5jdGlvbih0ZW1wbGF0ZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxpc3RlbmVyOyBsaXN0ZW5lciA9IHRlbXBsYXRlLmF0dGFjaGVzX1tpXTsgaSsrKSBpZiAobGlzdGVuZXIuaGFuZGxlciA9PSBoYW5kbGVyICYmIGxpc3RlbmVyLmNvbnRleHQgPT0gY29udGV4dCkgewogICAgICAgICAgICB0ZW1wbGF0ZS5hdHRhY2hlc18uc3BsaWNlKGksIDEpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkge30KICAgICAgfSwKICAgICAgY3JlYXRlSW5zdGFuY2U6IGZ1bmN0aW9uKG9iamVjdCwgYWN0aW9uQ2FsbGJhY2ssIHVwZGF0ZUNhbGxiYWNrLCBiaW5kaW5ncywgYmluZGluZ0ludGVyZmFjZSkgewogICAgICAgIGJ1aWxkVGVtcGxhdGUuY2FsbCh0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVJbnN0YW5jZShvYmplY3QsIGFjdGlvbkNhbGxiYWNrLCB1cGRhdGVDYWxsYmFjaywgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpOwogICAgICB9LAogICAgICBjbGVhckluc3RhbmNlOiBmdW5jdGlvbih0bXBsKSB7fSwKICAgICAgZ2V0SXNvbGF0ZVByZWZpeDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICJpIiArIHRoaXMudGVtcGxhdGVJZCArICJfXyI7CiAgICAgIH0sCiAgICAgIGdldEJpbmRpbmc6IGZ1bmN0aW9uKGJpbmRpbmdzKSB7CiAgICAgICAgYnVpbGRUZW1wbGF0ZS5jYWxsKHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLmdldEJpbmRpbmcoYmluZGluZ3MpOwogICAgICB9LAogICAgICBzZXRTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIHZhciBvbGRTb3VyY2UgPSB0aGlzLnNvdXJjZTsKICAgICAgICBpZiAob2xkU291cmNlICE9IHNvdXJjZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2UgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdmFyIG0gPSBzb3VyY2UubWF0Y2goL14oW2Etel0rKTovKTsKICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICB2YXIgcHJlZml4ID0gbVsxXTsKICAgICAgICAgICAgICBzb3VyY2UgPSBzb3VyY2Uuc3Vic3RyKG1bMF0ubGVuZ3RoKTsKICAgICAgICAgICAgICBzd2l0Y2ggKHByZWZpeCkgewogICAgICAgICAgICAgICAgY2FzZSAiZmlsZSI6CiAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGJhc2lzLnJlc291cmNlKHNvdXJjZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiaWQiOgogICAgICAgICAgICAgICAgICBzb3VyY2UgPSByZXNvbHZlU291cmNlQnlEb2N1bWVudElkKHNvdXJjZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidG9rZW5zIjoKICAgICAgICAgICAgICAgICAgc291cmNlID0gYmFzaXMuc3RyaW5nLnRvT2JqZWN0KHNvdXJjZSk7CiAgICAgICAgICAgICAgICAgIHNvdXJjZS5pc0RlY2wgPSB0cnVlOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInJhdyI6CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAicGF0aCI6CiAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGdldFNvdXJjZUJ5UGF0aChzb3VyY2UpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuVGVtcGxhdGUuc2V0U291cmNlOiBVbmtub3duIHByZWZpeCAiICsgcHJlZml4ICsgIiBmb3IgdGVtcGxhdGUgc291cmNlIHdhcyBpbmdub3JlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbGRTb3VyY2UgJiYgb2xkU291cmNlLmJpbmRpbmdCcmlkZ2UpIHsKICAgICAgICAgICAgdmFyIHRtcGxMaXN0ID0gb2xkU291cmNlLnVybCAmJiB0bXBsRmlsZXNNYXBbb2xkU291cmNlLnVybF07CiAgICAgICAgICAgIGlmICh0bXBsTGlzdCkgewogICAgICAgICAgICAgIGFycmF5UmVtb3ZlKHRtcGxMaXN0LCB0aGlzKTsKICAgICAgICAgICAgICBpZiAoIXRtcGxMaXN0Lmxlbmd0aCkgZGVsZXRlIHRtcGxGaWxlc01hcFtvbGRTb3VyY2UudXJsXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJhc2VVUkkgPSAiIjsKICAgICAgICAgICAgdGhpcy5zb3VyY2UuYmluZGluZ0JyaWRnZS5kZXRhY2gob2xkU291cmNlLCB0ZW1wbGF0ZVNvdXJjZVVwZGF0ZSwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc291cmNlICYmIHNvdXJjZS5iaW5kaW5nQnJpZGdlKSB7CiAgICAgICAgICAgIGlmIChzb3VyY2UudXJsKSB7CiAgICAgICAgICAgICAgdGhpcy5iYXNlVVJJID0gcGF0aC5kaXJuYW1lKHNvdXJjZS51cmwpICsgIi8iOwogICAgICAgICAgICAgIGlmICghdG1wbEZpbGVzTWFwW3NvdXJjZS51cmxdKSB0bXBsRmlsZXNNYXBbc291cmNlLnVybF0gPSBbXTsKICAgICAgICAgICAgICBhcnJheUFkZCh0bXBsRmlsZXNNYXBbc291cmNlLnVybF0sIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNvdXJjZS5iaW5kaW5nQnJpZGdlLmF0dGFjaChzb3VyY2UsIHRlbXBsYXRlU291cmNlVXBkYXRlLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc291cmNlID0gc291cmNlOwogICAgICAgICAgdGVtcGxhdGVTb3VyY2VVcGRhdGUuY2FsbCh0aGlzKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmRlc3Ryb3lCdWlsZGVyKSB0aGlzLmRlc3Ryb3lCdWlsZGVyKCk7CiAgICAgICAgdGhpcy5hdHRhY2hlc18gPSBudWxsOwogICAgICAgIHRoaXMuY3JlYXRlSW5zdGFuY2UgPSBudWxsOwogICAgICAgIHRoaXMuZ2V0QmluZGluZyA9IG51bGw7CiAgICAgICAgdGhpcy5yZXNvdXJjZXMgPSBudWxsOwogICAgICAgIHRoaXMuc291cmNlID0gbnVsbDsKICAgICAgICB0aGlzLmluc3RhbmNlc18gPSBudWxsOwogICAgICAgIHRoaXMuZGVjbF8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUZW1wbGF0ZVN3aXRjaENvbmZpZyA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICBiYXNpcy5vYmplY3QuZXh0ZW5kKHRoaXMsIGNvbmZpZyk7CiAgICB9OwogICAgdmFyIFRlbXBsYXRlU3dpdGNoZXIgPSBiYXNpcy5DbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UZW1wbGF0ZVN3aXRjaGVyIiwKICAgICAgcnVsZVJldF86IG51bGwsCiAgICAgIHRlbXBsYXRlc186IG51bGwsCiAgICAgIHRlbXBsYXRlQ2xhc3M6IFRlbXBsYXRlLAogICAgICBydWxlRXZlbnRzOiBudWxsLAogICAgICBydWxlOiBTdHJpbmcsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgIHRoaXMucnVsZVJldF8gPSBbXTsKICAgICAgICB0aGlzLnRlbXBsYXRlc18gPSBbXTsKICAgICAgICB0aGlzLnJ1bGUgPSBjb25maWcucnVsZTsKICAgICAgICB2YXIgZXZlbnRzID0gY29uZmlnLmV2ZW50czsKICAgICAgICBpZiAoZXZlbnRzICYmIGV2ZW50cy5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMucnVsZUV2ZW50cyA9IHt9OwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50TmFtZTsgZXZlbnROYW1lID0gZXZlbnRzW2ldOyBpKyspIHRoaXMucnVsZUV2ZW50c1tldmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgY2xlYW5lci5hZGQodGhpcyk7CiAgICAgIH0sCiAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHZhciByZXQgPSB0aGlzLnJ1bGUob2JqZWN0KTsKICAgICAgICB2YXIgaWR4ID0gdGhpcy5ydWxlUmV0Xy5pbmRleE9mKHJldCk7CiAgICAgICAgaWYgKGlkeCA9PSAtMSkgewogICAgICAgICAgdGhpcy5ydWxlUmV0Xy5wdXNoKHJldCk7CiAgICAgICAgICBpZHggPSB0aGlzLnRlbXBsYXRlc18ucHVzaChuZXcgdGhpcy50ZW1wbGF0ZUNsYXNzKHJldCkpIC0gMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMudGVtcGxhdGVzX1tpZHhdOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJ1bGUgPSBudWxsOwogICAgICAgIHRoaXMudGVtcGxhdGVzXyA9IG51bGw7CiAgICAgICAgdGhpcy5ydWxlUmV0XyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gc3dpdGNoZXIoZXZlbnRzLCBydWxlKSB7CiAgICAgIHZhciBhcmdzID0gYmFzaXMuYXJyYXkoYXJndW1lbnRzKTsKICAgICAgdmFyIHJ1bGUgPSBhcmdzLnBvcCgpOwogICAgICByZXR1cm4gbmV3IFRlbXBsYXRlU3dpdGNoQ29uZmlnKHsKICAgICAgICBydWxlOiBydWxlLAogICAgICAgIGV2ZW50czogYXJncy5qb2luKCIgIikudHJpbSgpLnNwbGl0KC9ccysvKQogICAgICB9KTsKICAgIH0KICAgIHZhciBUaGVtZSA9IENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlRoZW1lIiwKICAgICAgZ2V0OiBnZXRTb3VyY2VCeVBhdGgKICAgIH0pOwogICAgdmFyIFNvdXJjZVdyYXBwZXIgPSBDbGFzcyhiYXNpcy5Ub2tlbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU291cmNlV3JhcHBlciIsCiAgICAgIHBhdGg6ICIiLAogICAgICB1cmw6ICIiLAogICAgICBiYXNlVVJJOiAiIiwKICAgICAgaW5pdDogZnVuY3Rpb24odmFsdWUsIHBhdGgpIHsKICAgICAgICB0aGlzLnBhdGggPSBwYXRoOwogICAgICAgIGJhc2lzLlRva2VuLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcywgIiIpOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnZhbHVlICYmIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZSA/IHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZS5nZXQodGhpcy52YWx1ZSkgOiB0aGlzLnZhbHVlOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjb250ZW50ID0gZ2V0VGhlbWVTb3VyY2UoY3VycmVudFRoZW1lTmFtZSwgdGhpcy5wYXRoKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSAhPSBjb250ZW50KSB7CiAgICAgICAgICBpZiAodGhpcy52YWx1ZSAmJiB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UpIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZS5kZXRhY2godGhpcy52YWx1ZSwgU291cmNlV3JhcHBlci5wcm90b3R5cGUuYXBwbHksIHRoaXMpOwogICAgICAgICAgdGhpcy52YWx1ZSA9IGNvbnRlbnQ7CiAgICAgICAgICB0aGlzLnVybCA9IGNvbnRlbnQgJiYgY29udGVudC51cmwgfHwgIiI7CiAgICAgICAgICB0aGlzLmJhc2VVUkkgPSAodHlwZW9mIGNvbnRlbnQgPT0gIm9iamVjdCIgfHwgdHlwZW9mIGNvbnRlbnQgPT0gImZ1bmN0aW9uIikgJiYgImJhc2VVUkkiIGluIGNvbnRlbnQgPyBjb250ZW50LmJhc2VVUkkgOiBwYXRoLmRpcm5hbWUodGhpcy51cmwpICsgIi8iOwogICAgICAgICAgaWYgKHRoaXMudmFsdWUgJiYgdGhpcy52YWx1ZS5iaW5kaW5nQnJpZGdlKSB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UuYXR0YWNoKHRoaXMudmFsdWUsIFNvdXJjZVdyYXBwZXIucHJvdG90eXBlLmFwcGx5LCB0aGlzKTsKICAgICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudXJsID0gbnVsbDsKICAgICAgICB0aGlzLmJhc2VVUkkgPSBudWxsOwogICAgICAgIGlmICh0aGlzLnZhbHVlICYmIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZSkgdGhpcy52YWx1ZS5iaW5kaW5nQnJpZGdlLmRldGFjaCh0aGlzLnZhbHVlLCB0aGlzLmFwcGx5LCB0aGlzKTsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIGdldFNvdXJjZUJ5UGF0aCgpIHsKICAgICAgdmFyIHBhdGggPSBiYXNpcy5hcnJheShhcmd1bWVudHMpLmpvaW4oIi4iKTsKICAgICAgdmFyIHNvdXJjZSA9IHNvdXJjZUJ5UGF0aFtwYXRoXTsKICAgICAgaWYgKCFzb3VyY2UpIHsKICAgICAgICBzb3VyY2UgPSBuZXcgU291cmNlV3JhcHBlcigiIiwgcGF0aCk7CiAgICAgICAgc291cmNlQnlQYXRoW3BhdGhdID0gc291cmNlOwogICAgICB9CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9CiAgICBmdW5jdGlvbiBub3JtYWxpemUobGlzdCkgewogICAgICB2YXIgdXNlZCA9IHt9OwogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgaWYgKCF1c2VkW2xpc3RbaV1dKSB7CiAgICAgICAgdXNlZFtsaXN0W2ldXSA9IHRydWU7CiAgICAgICAgcmVzdWx0LnB1c2gobGlzdFtpXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIGV4dGVuZEZhbGxiYWNrKHRoZW1lTmFtZSwgbGlzdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIHJlc3VsdC5zb3VyY2UgPSBub3JtYWxpemUobGlzdCkuam9pbigiLyIpOwogICAgICB2YXIgdXNlZCA9IHsKICAgICAgICBiYXNlOiB0cnVlCiAgICAgIH07CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBuYW1lID0gbGlzdFtpXSB8fCAiYmFzZSI7CiAgICAgICAgaWYgKG5hbWUgPT0gdGhlbWVOYW1lIHx8IHVzZWRbbmFtZV0pIGNvbnRpbnVlOwogICAgICAgIHZhciB0aGVtZSA9IGdldFRoZW1lKG5hbWUpOwogICAgICAgIHVzZWRbbmFtZV0gPSB0cnVlOwogICAgICAgIHJlc3VsdC5wdXNoKG5hbWUpOwogICAgICAgIGxpc3Quc3BsaWNlLmFwcGx5KGxpc3QsIFsgaSArIDEsIDAgXS5jb25jYXQodGhlbWVzW25hbWVdLmZhbGxiYWNrKSk7CiAgICAgIH0KICAgICAgcmVzdWx0LnVuc2hpZnQodGhlbWVOYW1lKTsKICAgICAgaWYgKHRoZW1lTmFtZSAhPSAiYmFzZSIpIHJlc3VsdC5wdXNoKCJiYXNlIik7CiAgICAgIHJlc3VsdC52YWx1ZSA9IHJlc3VsdC5qb2luKCIvIik7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRUaGVtZVNvdXJjZShuYW1lLCBwYXRoKSB7CiAgICAgIHZhciBzb3VyY2VMaXN0ID0gdGhlbWVzW25hbWVdLnNvdXJjZXNMaXN0OwogICAgICBmb3IgKHZhciBpID0gMCwgbWFwOyBtYXAgPSBzb3VyY2VMaXN0W2ldOyBpKyspIGlmIChtYXAuaGFzT3duUHJvcGVydHkocGF0aCkpIHJldHVybiBtYXBbcGF0aF07CiAgICAgIHJldHVybiAiIjsKICAgIH0KICAgIGZ1bmN0aW9uIHRoZW1lSGFzRWZmZWN0KHRoZW1lTmFtZSkgewogICAgICByZXR1cm4gdGhlbWVzW2N1cnJlbnRUaGVtZU5hbWVdLmZhbGxiYWNrLmluZGV4T2YodGhlbWVOYW1lKSAhPSAtMTsKICAgIH0KICAgIGZ1bmN0aW9uIHN5bmNDdXJyZW50VGhlbWVQYXRoKHBhdGgpIHsKICAgICAgZ2V0U291cmNlQnlQYXRoKHBhdGgpLnNldCgpOwogICAgfQogICAgZnVuY3Rpb24gc3luY0N1cnJlbnRUaGVtZShjaGFuZ2VkKSB7CiAgICAgIGJhc2lzLmRldi5sb2coInJlLWFwcGx5IHRlbXBsYXRlcyIpOwogICAgICBmb3IgKHZhciBwYXRoIGluIHNvdXJjZUJ5UGF0aCkgc3luY0N1cnJlbnRUaGVtZVBhdGgocGF0aCk7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRUaGVtZShuYW1lKSB7CiAgICAgIGlmICghbmFtZSkgbmFtZSA9ICJiYXNlIjsKICAgICAgaWYgKHRoZW1lc1tuYW1lXSkgcmV0dXJuIHRoZW1lc1tuYW1lXS50aGVtZTsKICAgICAgaWYgKCEvXihbYS16MC05XF9cLV0rKSQvLnRlc3QobmFtZSkpIHRocm93ICJCYWQgbmFtZSBmb3IgdGhlbWUgLSAiICsgbmFtZTsKICAgICAgdmFyIHNvdXJjZXMgPSB7fTsKICAgICAgdmFyIHNvdXJjZUxpc3QgPSBbIHNvdXJjZXMgXTsKICAgICAgdmFyIHRoZW1lSW50ZXJmYWNlID0gbmV3IFRoZW1lOwogICAgICB0aGVtZXNbbmFtZV0gPSB7CiAgICAgICAgdGhlbWU6IHRoZW1lSW50ZXJmYWNlLAogICAgICAgIHNvdXJjZXM6IHNvdXJjZXMsCiAgICAgICAgc291cmNlc0xpc3Q6IHNvdXJjZUxpc3QsCiAgICAgICAgZmFsbGJhY2s6IFtdCiAgICAgIH07CiAgICAgIHZhciBhZGRTb3VyY2UgPSBmdW5jdGlvbihwYXRoLCBzb3VyY2UpIHsKICAgICAgICBpZiAocGF0aCBpbiBzb3VyY2VzID09IGZhbHNlKSB7CiAgICAgICAgICBzb3VyY2VzW3BhdGhdID0gc291cmNlOwogICAgICAgICAgaWYgKHRoZW1lSGFzRWZmZWN0KG5hbWUpKSBzeW5jQ3VycmVudFRoZW1lUGF0aChwYXRoKTsKICAgICAgICB9IGVsc2UgYmFzaXMuZGV2Lndhcm4oIlRlbXBsYXRlIHBhdGggYCIgKyBwYXRoICsgImAgaXMgYWxyZWFkeSBkZWZpbmVkIGZvciB0aGVtZSBgIiArIG5hbWUgKyAiYCAoZGVmaW5pdGlvbiBpZ25vcmVkKS4iKTsKICAgICAgICByZXR1cm4gZ2V0U291cmNlQnlQYXRoKHBhdGgpOwogICAgICB9OwogICAgICBiYXNpcy5vYmplY3QuZXh0ZW5kKHRoZW1lSW50ZXJmYWNlLCB7CiAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICBmYWxsYmFjazogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICh0aGVtZUludGVyZmFjZSAhPT0gYmFzZVRoZW1lICYmIGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBuZXdGYWxsYmFjayA9IHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCIvIikgOiBbXTsKICAgICAgICAgICAgdmFyIGNoYW5nZWQgPSB7fTsKICAgICAgICAgICAgbmV3RmFsbGJhY2sgPSBleHRlbmRGYWxsYmFjayhuYW1lLCBuZXdGYWxsYmFjayk7CiAgICAgICAgICAgIGlmICh0aGVtZXNbbmFtZV0uZmFsbGJhY2suc291cmNlICE9IG5ld0ZhbGxiYWNrLnNvdXJjZSkgewogICAgICAgICAgICAgIHRoZW1lc1tuYW1lXS5mYWxsYmFjay5zb3VyY2UgPSBuZXdGYWxsYmFjay5zb3VyY2U7CiAgICAgICAgICAgICAgYmFzaXMuZGV2LmxvZygiZmFsbGJhY2sgY2hhbmdlZCIpOwogICAgICAgICAgICAgIGZvciAodmFyIHRoZW1lTmFtZSBpbiB0aGVtZXMpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJGYWxsYmFjayA9IHRoZW1lc1t0aGVtZU5hbWVdLmZhbGxiYWNrOwogICAgICAgICAgICAgICAgdmFyIG5ld0ZhbGxiYWNrID0gZXh0ZW5kRmFsbGJhY2sodGhlbWVOYW1lLCAoY3VyRmFsbGJhY2suc291cmNlIHx8ICIiKS5zcGxpdCgiLyIpKTsKICAgICAgICAgICAgICAgIGlmIChuZXdGYWxsYmFjay52YWx1ZSAhPSBjdXJGYWxsYmFjay52YWx1ZSkgewogICAgICAgICAgICAgICAgICBjaGFuZ2VkW3RoZW1lTmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICB0aGVtZXNbdGhlbWVOYW1lXS5mYWxsYmFjayA9IG5ld0ZhbGxiYWNrOwogICAgICAgICAgICAgICAgICB2YXIgc291cmNlTGlzdCA9IHRoZW1lc1t0aGVtZU5hbWVdLnNvdXJjZXNMaXN0OwogICAgICAgICAgICAgICAgICBzb3VyY2VMaXN0Lmxlbmd0aCA9IG5ld0ZhbGxiYWNrLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3VyY2VMaXN0Lmxlbmd0aDsgaSsrKSBzb3VyY2VMaXN0W2ldID0gdGhlbWVzW25ld0ZhbGxiYWNrW2ldXS5zb3VyY2VzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3VycmVudEZhbGxiYWNrID0gdGhlbWVzW2N1cnJlbnRUaGVtZU5hbWVdLmZhbGxiYWNrOwogICAgICAgICAgICBmb3IgKHZhciB0aGVtZU5hbWUgaW4gY2hhbmdlZCkgewogICAgICAgICAgICAgIGlmICh0aGVtZUhhc0VmZmVjdCh0aGVtZU5hbWUpKSB7CiAgICAgICAgICAgICAgICBzeW5jQ3VycmVudFRoZW1lKCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByZXN1bHQgPSB0aGVtZXNbbmFtZV0uZmFsbGJhY2suc2xpY2UoMSk7CiAgICAgICAgICByZXN1bHQuc291cmNlID0gdGhlbWVzW25hbWVdLmZhbGxiYWNrLnNvdXJjZTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKICAgICAgICBkZWZpbmU6IGZ1bmN0aW9uKHdoYXQsIHdoZXJld2l0aCkgewogICAgICAgICAgaWYgKHR5cGVvZiB3aGF0ID09ICJmdW5jdGlvbiIpIHdoYXQgPSB3aGF0KCk7CiAgICAgICAgICBpZiAodHlwZW9mIHdoYXQgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB3aGVyZXdpdGggPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gd2hhdDsKICAgICAgICAgICAgICB2YXIgZGljdGlvbmFyeSA9IHdoZXJld2l0aDsKICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGRpY3Rpb25hcnkpIGlmIChkaWN0aW9uYXJ5Lmhhc093blByb3BlcnR5KGtleSkpIHJlc3VsdFtrZXldID0gYWRkU291cmNlKG5hbWVzcGFjZSArICIuIiArIGtleSwgZGljdGlvbmFyeVtrZXldKTsKICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRTb3VyY2VCeVBhdGgod2hhdCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBhZGRTb3VyY2Uod2hhdCwgd2hlcmV3aXRoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygd2hhdCA9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHZhciBkaWN0aW9uYXJ5ID0gd2hhdDsKICAgICAgICAgICAgICBmb3IgKHZhciBwYXRoIGluIGRpY3Rpb25hcnkpIGlmIChkaWN0aW9uYXJ5Lmhhc093blByb3BlcnR5KHBhdGgpKSBhZGRTb3VyY2UocGF0aCwgZGljdGlvbmFyeVtwYXRoXSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRoZW1lSW50ZXJmYWNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJXcm9uZyBmaXJzdCBhcmd1bWVudCBmb3IgYmFzaXMudGVtcGxhdGUuVGhlbWUjZGVmaW5lIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFwcGx5OiBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChuYW1lICE9IGN1cnJlbnRUaGVtZU5hbWUpIHsKICAgICAgICAgICAgY3VycmVudFRoZW1lTmFtZSA9IG5hbWU7CiAgICAgICAgICAgIHN5bmNDdXJyZW50VGhlbWUoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGhhbmRsZXI7IGhhbmRsZXIgPSB0aGVtZUNoYW5nZUhhbmRsZXJzW2ldOyBpKyspIGhhbmRsZXIuZm4uY2FsbChoYW5kbGVyLmNvbnRleHQsIG5hbWUpOwogICAgICAgICAgICBiYXNpcy5kZXYuaW5mbygiVGVtcGxhdGUgdGhlbWUgc3dpdGNoZWQgdG8gYCIgKyBuYW1lICsgImAiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGVtZUludGVyZmFjZTsKICAgICAgICB9LAogICAgICAgIGdldFNvdXJjZTogZnVuY3Rpb24ocGF0aCwgd2l0aEZhbGxiYWNrKSB7CiAgICAgICAgICByZXR1cm4gd2l0aEZhbGxiYWNrID8gZ2V0VGhlbWVTb3VyY2UobmFtZSwgcGF0aCkgOiBzb3VyY2VzW3BhdGhdOwogICAgICAgIH0sCiAgICAgICAgZHJvcDogZnVuY3Rpb24ocGF0aCkgewogICAgICAgICAgaWYgKHNvdXJjZXMuaGFzT3duUHJvcGVydHkocGF0aCkpIHsKICAgICAgICAgICAgZGVsZXRlIHNvdXJjZXNbcGF0aF07CiAgICAgICAgICAgIGlmICh0aGVtZUhhc0VmZmVjdChuYW1lKSkgc3luY0N1cnJlbnRUaGVtZVBhdGgocGF0aCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhlbWVzW25hbWVdLmZhbGxiYWNrID0gZXh0ZW5kRmFsbGJhY2sobmFtZSwgW10pOwogICAgICBzb3VyY2VMaXN0LnB1c2godGhlbWVzLmJhc2Uuc291cmNlcyk7CiAgICAgIHJldHVybiB0aGVtZUludGVyZmFjZTsKICAgIH0KICAgIHZhciB0aGVtZXMgPSB7fTsKICAgIHZhciBzb3VyY2VCeVBhdGggPSB7fTsKICAgIHZhciBiYXNlVGhlbWUgPSBnZXRUaGVtZSgpOwogICAgdmFyIGN1cnJlbnRUaGVtZU5hbWUgPSAiYmFzZSI7CiAgICB2YXIgdGhlbWVDaGFuZ2VIYW5kbGVycyA9IFtdOwogICAgZnVuY3Rpb24gb25UaGVtZUNoYW5nZShmbiwgY29udGV4dCwgZmlyZSkgewogICAgICB0aGVtZUNoYW5nZUhhbmRsZXJzLnB1c2goewogICAgICAgIGZuOiBmbiwKICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgIH0pOwogICAgICBpZiAoZmlyZSkgZm4uY2FsbChjb250ZXh0LCBjdXJyZW50VGhlbWVOYW1lKTsKICAgIH0KICAgIGNsZWFuZXIuYWRkKHsKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgcGF0aCBpbiBzb3VyY2VCeVBhdGgpIHNvdXJjZUJ5UGF0aFtwYXRoXS5kZXN0cm95KCk7CiAgICAgICAgdGhlbWVzID0gbnVsbDsKICAgICAgICBzb3VyY2VCeVBhdGggPSBudWxsOwogICAgICAgIGZvciAodmFyIGkgPSAwLCB0ZW1wbGF0ZTsgdGVtcGxhdGUgPSB0ZW1wbGF0ZUxpc3RbaV07IGkrKykgdGVtcGxhdGUuZGVzdHJveSgpOwogICAgICAgIHRlbXBsYXRlTGlzdCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIERFQ0xBUkFUSU9OX1ZFUlNJT046IERFQ0xBUkFUSU9OX1ZFUlNJT04sCiAgICAgIFRZUEVfRUxFTUVOVDogVFlQRV9FTEVNRU5ULAogICAgICBUWVBFX0FUVFJJQlVURTogVFlQRV9BVFRSSUJVVEUsCiAgICAgIFRZUEVfQVRUUklCVVRFX0NMQVNTOiBUWVBFX0FUVFJJQlVURV9DTEFTUywKICAgICAgVFlQRV9BVFRSSUJVVEVfU1RZTEU6IFRZUEVfQVRUUklCVVRFX1NUWUxFLAogICAgICBUWVBFX0FUVFJJQlVURV9FVkVOVDogVFlQRV9BVFRSSUJVVEVfRVZFTlQsCiAgICAgIFRZUEVfVEVYVDogVFlQRV9URVhULAogICAgICBUWVBFX0NPTU1FTlQ6IFRZUEVfQ09NTUVOVCwKICAgICAgVE9LRU5fVFlQRTogVE9LRU5fVFlQRSwKICAgICAgVE9LRU5fQklORElOR1M6IFRPS0VOX0JJTkRJTkdTLAogICAgICBUT0tFTl9SRUZTOiBUT0tFTl9SRUZTLAogICAgICBBVFRSX05BTUU6IEFUVFJfTkFNRSwKICAgICAgQVRUUl9WQUxVRTogQVRUUl9WQUxVRSwKICAgICAgQVRUUl9OQU1FX0JZX1RZUEU6IEFUVFJfTkFNRV9CWV9UWVBFLAogICAgICBFTEVNRU5UX05BTUU6IEVMRU1FTlRfTkFNRSwKICAgICAgRUxFTUVOVF9BVFRSUzogRUxFTUVOVF9BVFRSUywKICAgICAgRUxFTUVOVF9DSElMRFM6IEVMRU1FTlRfQ0hJTERTLAogICAgICBURVhUX1ZBTFVFOiBURVhUX1ZBTFVFLAogICAgICBDT01NRU5UX1ZBTFVFOiBDT01NRU5UX1ZBTFVFLAogICAgICBMMTBuUHJveHlUb2tlbjogTDEwblByb3h5VG9rZW4sCiAgICAgIFRlbXBsYXRlU3dpdGNoQ29uZmlnOiBUZW1wbGF0ZVN3aXRjaENvbmZpZywKICAgICAgVGVtcGxhdGVTd2l0Y2hlcjogVGVtcGxhdGVTd2l0Y2hlciwKICAgICAgVGVtcGxhdGU6IFRlbXBsYXRlLAogICAgICBTb3VyY2VXcmFwcGVyOiBTb3VyY2VXcmFwcGVyLAogICAgICBzd2l0Y2hlcjogc3dpdGNoZXIsCiAgICAgIHRva2VuaXplOiB0b2tlbml6ZSwKICAgICAgaXNvbGF0ZUNzczogaXNvbGF0ZUNzcywKICAgICAgZ2V0RGVjbEZyb21Tb3VyY2U6IGdldERlY2xGcm9tU291cmNlLAogICAgICBtYWtlRGVjbGFyYXRpb246IG1ha2VEZWNsYXJhdGlvbiwKICAgICAgZ2V0TDEwblRlbXBsYXRlOiBnZXRMMTBuVGVtcGxhdGUsCiAgICAgIFRoZW1lOiBUaGVtZSwKICAgICAgdGhlbWU6IGdldFRoZW1lLAogICAgICBnZXRUaGVtZUxpc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBiYXNpcy5vYmplY3Qua2V5cyh0aGVtZXMpOwogICAgICB9LAogICAgICBjdXJyZW50VGhlbWU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGVtZXNbY3VycmVudFRoZW1lTmFtZV0udGhlbWU7CiAgICAgIH0sCiAgICAgIHNldFRoZW1lOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgcmV0dXJuIGdldFRoZW1lKG5hbWUpLmFwcGx5KCk7CiAgICAgIH0sCiAgICAgIG9uVGhlbWVDaGFuZ2U6IG9uVGhlbWVDaGFuZ2UsCiAgICAgIGRlZmluZTogYmFzZVRoZW1lLmRlZmluZSwKICAgICAgZ2V0OiBnZXRTb3VyY2VCeVBhdGgsCiAgICAgIGdldFBhdGhMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYmFzaXMub2JqZWN0LmtleXMoc291cmNlQnlQYXRoKTsKICAgICAgfQogICAgfTsKICB9LAogICI3LmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzguanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMi5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi82LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzkuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgZG9tRXZlbnQgPSBiYXNpcy5kb20uZXZlbnQ7CiAgICB2YXIgYXJyYXlGcm9tID0gYmFzaXMuYXJyYXkuZnJvbTsKICAgIHZhciBjYW1lbGl6ZSA9IGJhc2lzLnN0cmluZy5jYW1lbGl6ZTsKICAgIHZhciBsMTBuVG9rZW4gPSBiYXNpcy5sMTBuLnRva2VuOwogICAgdmFyIGdldEZ1bmN0aW9ucyA9IGJhc2lzLnRlbXBsYXRlLmh0bWxmZ2VuLmdldEZ1bmN0aW9uczsKICAgIHZhciBUZW1wbGF0ZVN3aXRjaENvbmZpZyA9IGJhc2lzLnRlbXBsYXRlLlRlbXBsYXRlU3dpdGNoQ29uZmlnOwogICAgdmFyIFRlbXBsYXRlU3dpdGNoZXIgPSBiYXNpcy50ZW1wbGF0ZS5UZW1wbGF0ZVN3aXRjaGVyOwogICAgdmFyIFRlbXBsYXRlID0gYmFzaXMudGVtcGxhdGUuVGVtcGxhdGU7CiAgICB2YXIgVFlQRV9FTEVNRU5UID0gYmFzaXMudGVtcGxhdGUuVFlQRV9FTEVNRU5UOwogICAgdmFyIFRZUEVfQVRUUklCVVRFID0gYmFzaXMudGVtcGxhdGUuVFlQRV9BVFRSSUJVVEU7CiAgICB2YXIgVFlQRV9URVhUID0gYmFzaXMudGVtcGxhdGUuVFlQRV9URVhUOwogICAgdmFyIFRZUEVfQ09NTUVOVCA9IGJhc2lzLnRlbXBsYXRlLlRZUEVfQ09NTUVOVDsKICAgIHZhciBUT0tFTl9UWVBFID0gYmFzaXMudGVtcGxhdGUuVE9LRU5fVFlQRTsKICAgIHZhciBUT0tFTl9CSU5ESU5HUyA9IGJhc2lzLnRlbXBsYXRlLlRPS0VOX0JJTkRJTkdTOwogICAgdmFyIFRPS0VOX1JFRlMgPSBiYXNpcy50ZW1wbGF0ZS5UT0tFTl9SRUZTOwogICAgdmFyIEFUVFJfTkFNRSA9IGJhc2lzLnRlbXBsYXRlLkFUVFJfTkFNRTsKICAgIHZhciBBVFRSX1ZBTFVFID0gYmFzaXMudGVtcGxhdGUuQVRUUl9WQUxVRTsKICAgIHZhciBBVFRSX05BTUVfQllfVFlQRSA9IGJhc2lzLnRlbXBsYXRlLkFUVFJfTkFNRV9CWV9UWVBFOwogICAgdmFyIEVMRU1FTlRfTkFNRSA9IGJhc2lzLnRlbXBsYXRlLkVMRU1FTlRfTkFNRTsKICAgIHZhciBURVhUX1ZBTFVFID0gYmFzaXMudGVtcGxhdGUuVEVYVF9WQUxVRTsKICAgIHZhciBDT01NRU5UX1ZBTFVFID0gYmFzaXMudGVtcGxhdGUuQ09NTUVOVF9WQUxVRTsKICAgIHZhciBldmVudEF0dHIgPSAvXmV2ZW50LSguKykrLzsKICAgIHZhciBiYXNpc1RlbXBsYXRlSWRNYXJrZXIgPSAiYmFzaXNUZW1wbGF0ZUlkXyIgKyBiYXNpcy5nZW5VSUQoKTsKICAgIHZhciB0bXBsRXZlbnRMaXN0ZW5lcnMgPSB7fTsKICAgIHZhciB0ZW1wbGF0ZXMgPSB7fTsKICAgIHZhciBuYW1lc3BhY2VVUkkgPSB7CiAgICAgIHN2ZzogImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICAgfTsKICAgIHZhciBhZnRlckV2ZW50QWN0aW9uID0ge307CiAgICB2YXIgaW5zaWRlRWxlbWVudEV2ZW50ID0ge307CiAgICB2YXIgTU9VU0VfRU5URVJfTEVBVkVfU1VQUE9SVCA9ICJvbm1vdXNlZW50ZXIiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICAgIHZhciBDQVBUVVJFX0ZBTExCQUNLID0gIWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgJiYgIl9fYmFzaXNUZW1wbGF0ZSIgKyBwYXJzZUludCgxZTkgKiBNYXRoLnJhbmRvbSgpKTsKICAgIGlmIChDQVBUVVJFX0ZBTExCQUNLKSBnbG9iYWxbQ0FQVFVSRV9GQUxMQkFDS10gPSBmdW5jdGlvbihldmVudE5hbWUsIGV2ZW50KSB7CiAgICAgIGRvbUV2ZW50LmZpcmVFdmVudChkb2N1bWVudCwgZXZlbnROYW1lKTsKICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSB0cnVlOwogICAgICB2YXIgbGlzdGVuZXIgPSB0bXBsRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXTsKICAgICAgaWYgKGxpc3RlbmVyKSBsaXN0ZW5lcihuZXcgZG9tRXZlbnQuRXZlbnQoZXZlbnQpKTsKICAgIH07CiAgICB2YXIgQ0xPTkVfTk9STUFMSVpBVElPTl9URVhUX0JVRyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCJhIikpOwogICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCJhIikpOwogICAgICByZXR1cm4gZWxlbWVudC5jbG9uZU5vZGUodHJ1ZSkuY2hpbGROb2Rlcy5sZW5ndGggPT0gMTsKICAgIH0oKTsKICAgIHZhciBTRVRfQ0xBU1NfQVRUUklCVVRFX0JVRyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgiY2xhc3MiLCAiYSIpOwogICAgICByZXR1cm4gIWVsZW1lbnQuY2xhc3NOYW1lOwogICAgfSgpOwogICAgdmFyIFNFVF9TVFlMRV9BVFRSSUJVVEVfQlVHID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJwb3NpdGlvbjphYnNvbHV0ZSIpOwogICAgICByZXR1cm4gZWxlbWVudC5zdHlsZS5wb3NpdGlvbiAhPSAiYWJzb2x1dGUiOwogICAgfSgpOwogICAgdmFyIElTX1NFVF9TVFlMRV9TQUZFID0gISFmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlLmNvbG9yID0gIngiOwogICAgICB9IGNhdGNoIChlKSB7fQogICAgfSgpOwogICAgaWYgKHR5cGVvZiBOb2RlICE9ICJ1bmRlZmluZWQiICYmICFOb2RlLnByb3RvdHlwZS5jb250YWlucykgTm9kZS5wcm90b3R5cGUuY29udGFpbnMgPSBmdW5jdGlvbihjaGlsZCkgewogICAgICByZXR1cm4gISEodGhpcy5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihjaGlsZCkgJiAxNik7CiAgICB9OwogICAgdmFyIGwxMG5UZW1wbGF0ZXMgPSB7fTsKICAgIGZ1bmN0aW9uIGdldEwxMG5UZW1wbGF0ZSh0b2tlbikgewogICAgICB2YXIgdGVtcGxhdGUgPSBiYXNpcy50ZW1wbGF0ZS5nZXRMMTBuVGVtcGxhdGUodG9rZW4pOwogICAgICB2YXIgaWQgPSB0ZW1wbGF0ZS50ZW1wbGF0ZUlkOwogICAgICB2YXIgaHRtbFRlbXBsYXRlID0gbDEwblRlbXBsYXRlc1tpZF07CiAgICAgIGlmICghaHRtbFRlbXBsYXRlKSBodG1sVGVtcGxhdGUgPSBsMTBuVGVtcGxhdGVzW2lkXSA9IG5ldyBIdG1sVGVtcGxhdGUodGVtcGxhdGUuc291cmNlKTsKICAgICAgcmV0dXJuIGh0bWxUZW1wbGF0ZTsKICAgIH0KICAgIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50SGFuZGxlcihhdHRyTmFtZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBpZiAoZXZlbnQudHlwZSA9PSAiY2xpY2siICYmIGV2ZW50LndoaWNoID09IDMpIHJldHVybjsKICAgICAgICB2YXIgYnViYmxlID0gaW5zaWRlRWxlbWVudEV2ZW50W2V2ZW50LnR5cGVdIHx8IGV2ZW50LnR5cGUgIT0gIm1vdXNlZW50ZXIiICYmIGV2ZW50LnR5cGUgIT0gIm1vdXNlbGVhdmUiOwogICAgICAgIHZhciBhdHRyQ3Vyc29yID0gZXZlbnQuc2VuZGVyOwogICAgICAgIHZhciBhdHRyOwogICAgICAgIHdoaWxlIChhdHRyQ3Vyc29yKSB7CiAgICAgICAgICBhdHRyID0gYXR0ckN1cnNvci5nZXRBdHRyaWJ1dGUgJiYgYXR0ckN1cnNvci5nZXRBdHRyaWJ1dGUoYXR0ck5hbWUpOwogICAgICAgICAgaWYgKCFidWJibGUgfHwgdHlwZW9mIGF0dHIgPT0gInN0cmluZyIpIGJyZWFrOwogICAgICAgICAgYXR0ckN1cnNvciA9IGF0dHJDdXJzb3IucGFyZW50Tm9kZTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBhdHRyID09ICJzdHJpbmciKSB7CiAgICAgICAgICB2YXIgY3Vyc29yID0gYXR0ckN1cnNvcjsKICAgICAgICAgIHZhciBhY3Rpb25UYXJnZXQgPSBjdXJzb3I7CiAgICAgICAgICB2YXIgcmVmSWQ7CiAgICAgICAgICB2YXIgdG1wbFJlZjsKICAgICAgICAgIGlmIChpbnNpZGVFbGVtZW50RXZlbnRbZXZlbnQudHlwZV0pIHsKICAgICAgICAgICAgdmFyIHJlbFRhcmdldCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICAgIGlmIChyZWxUYXJnZXQgJiYgKGN1cnNvciA9PT0gcmVsVGFyZ2V0IHx8IGN1cnNvci5jb250YWlucyhyZWxUYXJnZXQpKSkgY3Vyc29yID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICAgICAgcmVmSWQgPSBjdXJzb3JbYmFzaXNUZW1wbGF0ZUlkTWFya2VyXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiByZWZJZCA9PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGlmICh0bXBsUmVmID0gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCkpIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnNvciA9IGN1cnNvci5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRtcGxSZWYgJiYgdG1wbFJlZi5hY3Rpb24pIHsKICAgICAgICAgICAgdmFyIGFjdGlvbnMgPSBhdHRyLnRyaW0oKS5zcGxpdCgvXHMrLyk7CiAgICAgICAgICAgIGV2ZW50LmFjdGlvblRhcmdldCA9IGFjdGlvblRhcmdldDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGFjdGlvbk5hbWU7IGFjdGlvbk5hbWUgPSBhY3Rpb25zW2krK107ICkgc3dpdGNoIChhY3Rpb25OYW1lKSB7CiAgICAgICAgICAgICAgY2FzZSAicHJldmVudC1kZWZhdWx0IjoKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzdG9wLXByb3BhZ2F0aW9uIjoKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRtcGxSZWYuYWN0aW9uLmNhbGwodG1wbFJlZi5jb250ZXh0LCBhY3Rpb25OYW1lLCBldmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGV2ZW50LnR5cGUgaW4gYWZ0ZXJFdmVudEFjdGlvbikgYWZ0ZXJFdmVudEFjdGlvbltldmVudC50eXBlXShldmVudCwgYXR0ckN1cnNvcik7CiAgICAgIH07CiAgICB9CiAgICB2YXIgYnVpbGRIdG1sID0gZnVuY3Rpb24odG9rZW5zLCBwYXJlbnQpIHsKICAgICAgZnVuY3Rpb24gZW11bGF0ZUV2ZW50KG9yaWdFdmVudE5hbWUsIGVtdWxFdmVudE5hbWUpIHsKICAgICAgICByZWdFdmVudEhhbmRsZXIoZW11bEV2ZW50TmFtZSk7CiAgICAgICAgaW5zaWRlRWxlbWVudEV2ZW50W29yaWdFdmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICBhZnRlckV2ZW50QWN0aW9uW2VtdWxFdmVudE5hbWVdID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIGV2ZW50ID0gbmV3IGRvbUV2ZW50LkV2ZW50KGV2ZW50KTsKICAgICAgICAgIGV2ZW50LnR5cGUgPSBvcmlnRXZlbnROYW1lOwogICAgICAgICAgdG1wbEV2ZW50TGlzdGVuZXJzW29yaWdFdmVudE5hbWVdKGV2ZW50KTsKICAgICAgICB9OwogICAgICAgIGFmdGVyRXZlbnRBY3Rpb25bb3JpZ0V2ZW50TmFtZV0gPSBmdW5jdGlvbihldmVudCwgY3Vyc29yKSB7CiAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IgJiYgY3Vyc29yLnBhcmVudE5vZGU7CiAgICAgICAgICBpZiAoY3Vyc29yKSB7CiAgICAgICAgICAgIGV2ZW50ID0gbmV3IGRvbUV2ZW50LkV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgZXZlbnQudHlwZSA9IG9yaWdFdmVudE5hbWU7CiAgICAgICAgICAgIGV2ZW50LnNlbmRlciA9IGN1cnNvcjsKICAgICAgICAgICAgdG1wbEV2ZW50TGlzdGVuZXJzW29yaWdFdmVudE5hbWVdKGV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlZ0V2ZW50SGFuZGxlcihldmVudE5hbWUpIHsKICAgICAgICBpZiAoIXRtcGxFdmVudExpc3RlbmVyc1tldmVudE5hbWVdKSB7CiAgICAgICAgICB0bXBsRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXSA9IGNyZWF0ZUV2ZW50SGFuZGxlcigiZXZlbnQtIiArIGV2ZW50TmFtZSk7CiAgICAgICAgICBpZiAoIUNBUFRVUkVfRkFMTEJBQ0spIHsKICAgICAgICAgICAgaWYgKCFNT1VTRV9FTlRFUl9MRUFWRV9TVVBQT1JUICYmIGV2ZW50TmFtZSA9PSAibW91c2VlbnRlciIpIHJldHVybiBlbXVsYXRlRXZlbnQoZXZlbnROYW1lLCAibW91c2VvdmVyIik7CiAgICAgICAgICAgIGlmICghTU9VU0VfRU5URVJfTEVBVkVfU1VQUE9SVCAmJiBldmVudE5hbWUgPT0gIm1vdXNlbGVhdmUiKSByZXR1cm4gZW11bGF0ZUV2ZW50KGV2ZW50TmFtZSwgIm1vdXNlb3V0Iik7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBuYW1lcyA9IGRvbUV2ZW50LmJyb3dzZXJFdmVudHMoZXZlbnROYW1lKSwgYnJvd3NlckV2ZW50TmFtZTsgYnJvd3NlckV2ZW50TmFtZSA9IG5hbWVzW2ldOyBpKyspIGRvbUV2ZW50LmFkZEdsb2JhbEhhbmRsZXIoYnJvd3NlckV2ZW50TmFtZSwgdG1wbEV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzZXRFdmVudEF0dHJpYnV0ZShldmVudE5hbWUsIGFjdGlvbnMpIHsKICAgICAgICByZWdFdmVudEhhbmRsZXIoZXZlbnROYW1lKTsKICAgICAgICBpZiAoQ0FQVFVSRV9GQUxMQkFDSykgcmVzdWx0LnNldEF0dHJpYnV0ZSgib24iICsgZXZlbnROYW1lLCBDQVBUVVJFX0ZBTExCQUNLICsgJygiJyArIGV2ZW50TmFtZSArICciLGV2ZW50KScpOwogICAgICAgIHJlc3VsdC5zZXRBdHRyaWJ1dGUoImV2ZW50LSIgKyBldmVudE5hbWUsIGFjdGlvbnMpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSkgewogICAgICAgIGlmIChTRVRfQ0xBU1NfQVRUUklCVVRFX0JVRyAmJiBuYW1lID09ICJjbGFzcyIpIG5hbWUgPSAiY2xhc3NOYW1lIjsKICAgICAgICBpZiAoU0VUX1NUWUxFX0FUVFJJQlVURV9CVUcgJiYgbmFtZSA9PSAic3R5bGUiKSByZXR1cm4gcmVzdWx0LnN0eWxlLmNzc1RleHQgPSB2YWx1ZTsKICAgICAgICByZXN1bHQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gcGFyZW50IHx8IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgZm9yICh2YXIgaSA9IHBhcmVudCA/IDQgOiAwLCB0b2tlbjsgdG9rZW4gPSB0b2tlbnNbaV07IGkrKykgewogICAgICAgIHN3aXRjaCAodG9rZW5bVE9LRU5fVFlQRV0pIHsKICAgICAgICAgIGNhc2UgVFlQRV9FTEVNRU5UOgogICAgICAgICAgICB2YXIgdGFnTmFtZSA9IHRva2VuW0VMRU1FTlRfTkFNRV07CiAgICAgICAgICAgIHZhciBwYXJ0cyA9IHRhZ05hbWUuc3BsaXQoLzovKTsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBwYXJ0cy5sZW5ndGggPiAxID8gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZVVSSVtwYXJ0c1swXV0sIHRhZ05hbWUpIDogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTsKICAgICAgICAgICAgYnVpbGRIdG1sKHRva2VuLCBlbGVtZW50KTsKICAgICAgICAgICAgcmVzdWx0LmFwcGVuZENoaWxkKGVsZW1lbnQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgVFlQRV9BVFRSSUJVVEU6CiAgICAgICAgICAgIHZhciBhdHRyTmFtZSA9IHRva2VuW0FUVFJfTkFNRV07CiAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSB0b2tlbltBVFRSX1ZBTFVFXTsKICAgICAgICAgICAgdmFyIGV2ZW50TmFtZSA9IGF0dHJOYW1lLnJlcGxhY2UoL15ldmVudC0vLCAiIik7CiAgICAgICAgICAgIGlmIChldmVudE5hbWUgIT0gYXR0ck5hbWUpIHsKICAgICAgICAgICAgICBzZXRFdmVudEF0dHJpYnV0ZShldmVudE5hbWUsIGF0dHJWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKGF0dHJOYW1lICE9ICJjbGFzcyIgJiYgYXR0ck5hbWUgIT0gInN0eWxlIiA/ICF0b2tlbltUT0tFTl9CSU5ESU5HU10gOiBhdHRyVmFsdWUpIHNldEF0dHJpYnV0ZShhdHRyTmFtZSwgYXR0clZhbHVlIHx8ICIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgdmFyIGF0dHJWYWx1ZSA9IHRva2VuW0FUVFJfVkFMVUUgLSAxXTsKICAgICAgICAgICAgaWYgKGF0dHJWYWx1ZSkgc2V0QXR0cmlidXRlKEFUVFJfTkFNRV9CWV9UWVBFW3Rva2VuW1RPS0VOX1RZUEVdXSwgYXR0clZhbHVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgIHNldEV2ZW50QXR0cmlidXRlKHRva2VuWzFdLCB0b2tlblsyXSB8fCB0b2tlblsxXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBUWVBFX0NPTU1FTlQ6CiAgICAgICAgICAgIHJlc3VsdC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVDb21tZW50KHRva2VuW0NPTU1FTlRfVkFMVUVdIHx8ICh0b2tlbltUT0tFTl9SRUZTXSA/ICJ7IiArIHRva2VuW1RPS0VOX1JFRlNdLmpvaW4oInwiKSArICJ9IiA6ICIiKSkpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgVFlQRV9URVhUOgogICAgICAgICAgICBpZiAoQ0xPTkVfTk9STUFMSVpBVElPTl9URVhUX0JVRyAmJiBpICYmIHRva2Vuc1tpIC0gMV1bVE9LRU5fVFlQRV0gPT0gVFlQRV9URVhUKSByZXN1bHQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikpOwogICAgICAgICAgICByZXN1bHQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodG9rZW5bVEVYVF9WQUxVRV0gfHwgKHRva2VuW1RPS0VOX1JFRlNdID8gInsiICsgdG9rZW5bVE9LRU5fUkVGU10uam9pbigifCIpICsgIn0iIDogIiIpIHx8ICh0b2tlbltUT0tFTl9CSU5ESU5HU10gPyAieyIgKyB0b2tlbltUT0tFTl9CSU5ESU5HU10gKyAifSIgOiAiIikpKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghcGFyZW50ICYmIHRva2Vucy5sZW5ndGggPT0gMSkgcmVzdWx0ID0gcmVzdWx0LmZpcnN0Q2hpbGQ7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgZnVuY3Rpb24gcmVzb2x2ZVRlbXBsYXRlQnlJZChyZWZJZCkgewogICAgICB2YXIgdGVtcGxhdGVJZCA9IHJlZklkICYgNDA5NTsKICAgICAgdmFyIG9iamVjdCA9IHRlbXBsYXRlc1t0ZW1wbGF0ZUlkXTsKICAgICAgcmV0dXJuIG9iamVjdCAmJiBvYmplY3QudGVtcGxhdGU7CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlSW5zdGFuY2VCeUlkKHJlZklkKSB7CiAgICAgIHZhciB0ZW1wbGF0ZUlkID0gcmVmSWQgJiA0MDk1OwogICAgICB2YXIgaW5zdGFuY2VJZCA9IHJlZklkID4+IDEyOwogICAgICB2YXIgb2JqZWN0ID0gdGVtcGxhdGVzW3RlbXBsYXRlSWRdOwogICAgICByZXR1cm4gb2JqZWN0ICYmIG9iamVjdC5pbnN0YW5jZXNbaW5zdGFuY2VJZF07CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlT2JqZWN0QnlJZChyZWZJZCkgewogICAgICB2YXIgdGVtcGxhdGVSZWYgPSByZXNvbHZlSW5zdGFuY2VCeUlkKHJlZklkKTsKICAgICAgcmV0dXJuIHRlbXBsYXRlUmVmICYmIHRlbXBsYXRlUmVmLmNvbnRleHQ7CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlVG1wbEJ5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlUmVmID0gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZVJlZiAmJiB0ZW1wbGF0ZVJlZi50bXBsOwogICAgfQogICAgZnVuY3Rpb24gZ2V0RGVidWdJbmZvQnlJZChyZWZJZCkgewogICAgICB2YXIgdGVtcGxhdGVSZWYgPSByZXNvbHZlSW5zdGFuY2VCeUlkKHJlZklkKTsKICAgICAgcmV0dXJuIHRlbXBsYXRlUmVmICYmIHRlbXBsYXRlUmVmLmRlYnVnICYmIHRlbXBsYXRlUmVmLmRlYnVnKCk7CiAgICB9CiAgICB2YXIgYnVpbGRlciA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgV0hJVEVTUEFDRSA9IC9ccysvOwogICAgICB2YXIgVzNDX0RPTV9OT0RFX1NVUFBPUlRFRCA9IHR5cGVvZiBOb2RlID09ICJmdW5jdGlvbiIgJiYgZG9jdW1lbnQgaW5zdGFuY2VvZiBOb2RlOwogICAgICB2YXIgQ0xBU1NMSVNUX1NVUFBPUlRFRCA9IGdsb2JhbC5ET01Ub2tlbkxpc3QgJiYgZG9jdW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsYXNzTGlzdCBpbnN0YW5jZW9mIGdsb2JhbC5ET01Ub2tlbkxpc3Q7CiAgICAgIHZhciBiaW5kX25vZGUgPSBXM0NfRE9NX05PREVfU1VQUE9SVEVEID8gZnVuY3Rpb24oZG9tUmVmLCBvbGROb2RlLCBuZXdWYWx1ZSkgewogICAgICAgIHZhciBuZXdOb2RlID0gbmV3VmFsdWUgJiYgbmV3VmFsdWUgaW5zdGFuY2VvZiBOb2RlID8gbmV3VmFsdWUgOiBkb21SZWY7CiAgICAgICAgaWYgKG5ld05vZGUgIT09IG9sZE5vZGUpIG9sZE5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgb2xkTm9kZSk7CiAgICAgICAgcmV0dXJuIG5ld05vZGU7CiAgICAgIH0gOiBmdW5jdGlvbihkb21SZWYsIG9sZE5vZGUsIG5ld1ZhbHVlKSB7CiAgICAgICAgdmFyIG5ld05vZGUgPSBuZXdWYWx1ZSAmJiB0eXBlb2YgbmV3VmFsdWUgPT0gIm9iamVjdCIgPyBuZXdWYWx1ZSA6IGRvbVJlZjsKICAgICAgICBpZiAobmV3Tm9kZSAhPT0gb2xkTm9kZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgb2xkTm9kZS5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChuZXdOb2RlLCBvbGROb2RlKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgbmV3Tm9kZSA9IGRvbVJlZjsKICAgICAgICAgICAgaWYgKG9sZE5vZGUgIT09IG5ld05vZGUpIG9sZE5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgb2xkTm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdOb2RlOwogICAgICB9OwogICAgICB2YXIgYmluZF9lbGVtZW50ID0gZnVuY3Rpb24oZG9tUmVmLCBvbGROb2RlLCBuZXdWYWx1ZSkgewogICAgICAgIHZhciBuZXdOb2RlID0gYmluZF9ub2RlKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpOwogICAgICAgIGlmIChuZXdOb2RlID09PSBkb21SZWYgJiYgdHlwZW9mIG5ld1ZhbHVlID09ICJzdHJpbmciKSBkb21SZWYuaW5uZXJIVE1MID0gbmV3VmFsdWU7CiAgICAgICAgcmV0dXJuIG5ld05vZGU7CiAgICAgIH07CiAgICAgIHZhciBiaW5kX2NvbW1lbnQgPSBiaW5kX25vZGU7CiAgICAgIHZhciBiaW5kX3RleHROb2RlID0gZnVuY3Rpb24oZG9tUmVmLCBvbGROb2RlLCBuZXdWYWx1ZSkgewogICAgICAgIHZhciBuZXdOb2RlID0gYmluZF9ub2RlKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpOwogICAgICAgIGlmIChuZXdOb2RlID09PSBkb21SZWYpIGRvbVJlZi5ub2RlVmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICByZXR1cm4gbmV3Tm9kZTsKICAgICAgfTsKICAgICAgdmFyIGJpbmRfYXR0ckNsYXNzID0gQ0xBU1NMSVNUX1NVUFBPUlRFRCA/IGZ1bmN0aW9uKGRvbVJlZiwgb2xkQ2xhc3MsIG5ld1ZhbHVlLCBwcmVmaXgsIGFuaW0pIHsKICAgICAgICB2YXIgbmV3Q2xhc3MgPSBuZXdWYWx1ZSA/IHByZWZpeCArIG5ld1ZhbHVlIDogIiI7CiAgICAgICAgaWYgKG5ld0NsYXNzICE9IG9sZENsYXNzKSB7CiAgICAgICAgICBpZiAob2xkQ2xhc3MpIGRvbVJlZi5jbGFzc0xpc3QucmVtb3ZlKG9sZENsYXNzKTsKICAgICAgICAgIGlmIChuZXdDbGFzcykgewogICAgICAgICAgICBkb21SZWYuY2xhc3NMaXN0LmFkZChuZXdDbGFzcyk7CiAgICAgICAgICAgIGlmIChhbmltKSB7CiAgICAgICAgICAgICAgZG9tUmVmLmNsYXNzTGlzdC5hZGQobmV3Q2xhc3MgKyAiLWFuaW0iKTsKICAgICAgICAgICAgICBiYXNpcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGRvbVJlZi5jbGFzc0xpc3QucmVtb3ZlKG5ld0NsYXNzICsgIi1hbmltIik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld0NsYXNzOwogICAgICB9IDogZnVuY3Rpb24oZG9tUmVmLCBvbGRDbGFzcywgbmV3VmFsdWUsIHByZWZpeCwgYW5pbSkgewogICAgICAgIHZhciBuZXdDbGFzcyA9IG5ld1ZhbHVlID8gcHJlZml4ICsgbmV3VmFsdWUgOiAiIjsKICAgICAgICBpZiAobmV3Q2xhc3MgIT0gb2xkQ2xhc3MpIHsKICAgICAgICAgIHZhciBjbGFzc05hbWUgPSBkb21SZWYuY2xhc3NOYW1lOwogICAgICAgICAgdmFyIGNsYXNzTmFtZUlzT2JqZWN0ID0gdHlwZW9mIGNsYXNzTmFtZSAhPSAic3RyaW5nIjsKICAgICAgICAgIHZhciBjbGFzc0xpc3Q7CiAgICAgICAgICBpZiAoY2xhc3NOYW1lSXNPYmplY3QpIGNsYXNzTmFtZSA9IGNsYXNzTmFtZS5iYXNlVmFsOwogICAgICAgICAgY2xhc3NMaXN0ID0gY2xhc3NOYW1lLnNwbGl0KFdISVRFU1BBQ0UpOwogICAgICAgICAgaWYgKG9sZENsYXNzKSBiYXNpcy5hcnJheS5yZW1vdmUoY2xhc3NMaXN0LCBvbGRDbGFzcyk7CiAgICAgICAgICBpZiAobmV3Q2xhc3MpIHsKICAgICAgICAgICAgY2xhc3NMaXN0LnB1c2gobmV3Q2xhc3MpOwogICAgICAgICAgICBpZiAoYW5pbSkgewogICAgICAgICAgICAgIGJhc2lzLmFycmF5LmFkZChjbGFzc0xpc3QsIG5ld0NsYXNzICsgIi1hbmltIik7CiAgICAgICAgICAgICAgYmFzaXMubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xhc3NMaXN0ID0gKGNsYXNzTmFtZUlzT2JqZWN0ID8gZG9tUmVmLmNsYXNzTmFtZS5iYXNlVmFsIDogZG9tUmVmLmNsYXNzTmFtZSkuc3BsaXQoV0hJVEVTUEFDRSk7CiAgICAgICAgICAgICAgICBiYXNpcy5hcnJheS5yZW1vdmUoY2xhc3NMaXN0LCBuZXdDbGFzcyArICItYW5pbSIpOwogICAgICAgICAgICAgICAgaWYgKGNsYXNzTmFtZUlzT2JqZWN0KSBkb21SZWYuY2xhc3NOYW1lLmJhc2VWYWwgPSBjbGFzc0xpc3Quam9pbigiICIpOyBlbHNlIGRvbVJlZi5jbGFzc05hbWUgPSBjbGFzc0xpc3Quam9pbigiICIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2xhc3NOYW1lSXNPYmplY3QpIGRvbVJlZi5jbGFzc05hbWUuYmFzZVZhbCA9IGNsYXNzTGlzdC5qb2luKCIgIik7IGVsc2UgZG9tUmVmLmNsYXNzTmFtZSA9IGNsYXNzTGlzdC5qb2luKCIgIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdDbGFzczsKICAgICAgfTsKICAgICAgdmFyIGJpbmRfYXR0clN0eWxlID0gSVNfU0VUX1NUWUxFX1NBRkUgPyBmdW5jdGlvbihkb21SZWYsIHByb3BlcnR5TmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7CiAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBuZXdWYWx1ZSkgZG9tUmVmLnN0eWxlW2NhbWVsaXplKHByb3BlcnR5TmFtZSldID0gbmV3VmFsdWU7CiAgICAgICAgcmV0dXJuIG5ld1ZhbHVlOwogICAgICB9IDogZnVuY3Rpb24oZG9tUmVmLCBwcm9wZXJ0eU5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkgewogICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGRvbVJlZi5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eU5hbWUpXSA9IG5ld1ZhbHVlOwogICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld1ZhbHVlOwogICAgICB9OwogICAgICB2YXIgYmluZF9hdHRyID0gZnVuY3Rpb24oZG9tUmVmLCBhdHRyTmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7CiAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBuZXdWYWx1ZSkgewogICAgICAgICAgaWYgKG5ld1ZhbHVlKSBkb21SZWYuc2V0QXR0cmlidXRlKGF0dHJOYW1lLCBuZXdWYWx1ZSk7IGVsc2UgZG9tUmVmLnJlbW92ZUF0dHJpYnV0ZShhdHRyTmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdWYWx1ZTsKICAgICAgfTsKICAgICAgZnVuY3Rpb24gdXBkYXRlQXR0YWNoKCkgewogICAgICAgIHRoaXMuc2V0KHRoaXMubmFtZSwgdGhpcy52YWx1ZSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVzb2x2ZVZhbHVlKGJpbmRpbmdOYW1lLCB2YWx1ZSwgQXR0YWNoZXMpIHsKICAgICAgICB2YXIgYnJpZGdlID0gdmFsdWUgJiYgdmFsdWUuYmluZGluZ0JyaWRnZTsKICAgICAgICB2YXIgb2xkQXR0YWNoID0gdGhpcy5hdHRhY2hlcyAmJiB0aGlzLmF0dGFjaGVzW2JpbmRpbmdOYW1lXTsKICAgICAgICB2YXIgdG1wbCA9IG51bGw7CiAgICAgICAgaWYgKGJyaWRnZSB8fCBvbGRBdHRhY2gpIHsKICAgICAgICAgIGlmIChicmlkZ2UpIHsKICAgICAgICAgICAgaWYgKCFvbGRBdHRhY2ggfHwgdmFsdWUgIT09IG9sZEF0dGFjaC52YWx1ZSkgewogICAgICAgICAgICAgIGlmIChvbGRBdHRhY2gpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRBdHRhY2gudG1wbCkgewogICAgICAgICAgICAgICAgICBvbGRBdHRhY2gudG1wbC5lbGVtZW50LnRvU3RyaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgICAgZ2V0TDEwblRlbXBsYXRlKG9sZEF0dGFjaC52YWx1ZSkuY2xlYXJJbnN0YW5jZShvbGRBdHRhY2gudG1wbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvbGRBdHRhY2gudmFsdWUuYmluZGluZ0JyaWRnZS5kZXRhY2gob2xkQXR0YWNoLnZhbHVlLCB1cGRhdGVBdHRhY2gsIG9sZEF0dGFjaCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2YWx1ZS50eXBlID09ICJtYXJrdXAiICYmIHZhbHVlIGluc3RhbmNlb2YgYmFzaXMubDEwbi5Ub2tlbikgewogICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gZ2V0TDEwblRlbXBsYXRlKHZhbHVlKTsKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdGhpcy5jb250ZXh0OwogICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdzID0gdGhpcy5iaW5kaW5nczsKICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nSW50ZXJmYWNlID0gdGhpcy5iaW5kaW5nSW50ZXJmYWNlOwogICAgICAgICAgICAgICAgdG1wbCA9IHRlbXBsYXRlLmNyZWF0ZUluc3RhbmNlKGNvbnRleHQsIG51bGwsIGZ1bmN0aW9uIG9uUmVidWlsZCgpIHsKICAgICAgICAgICAgICAgICAgdG1wbCA9IG5ld0F0dGFjaC50bXBsID0gdGVtcGxhdGUuY3JlYXRlSW5zdGFuY2UoY29udGV4dCwgbnVsbCwgb25SZWJ1aWxkLCBiaW5kaW5ncywgYmluZGluZ0ludGVyZmFjZSk7CiAgICAgICAgICAgICAgICAgIHRtcGwuZWxlbWVudC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS52YWx1ZTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgdXBkYXRlQXR0YWNoLmNhbGwobmV3QXR0YWNoKTsKICAgICAgICAgICAgICAgIH0sIGJpbmRpbmdzLCBiaW5kaW5nSW50ZXJmYWNlKTsKICAgICAgICAgICAgICAgIHRtcGwuZWxlbWVudC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUudmFsdWU7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIXRoaXMuYXR0YWNoZXMpIHRoaXMuYXR0YWNoZXMgPSBuZXcgQXR0YWNoZXM7CiAgICAgICAgICAgICAgdmFyIG5ld0F0dGFjaCA9IHRoaXMuYXR0YWNoZXNbYmluZGluZ05hbWVdID0gewogICAgICAgICAgICAgICAgbmFtZTogYmluZGluZ05hbWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgICB0bXBsOiB0bXBsLAogICAgICAgICAgICAgICAgc2V0OiB0aGlzLnRtcGwuc2V0CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBicmlkZ2UuYXR0YWNoKHZhbHVlLCB1cGRhdGVBdHRhY2gsIG5ld0F0dGFjaCk7CiAgICAgICAgICAgIH0gZWxzZSB0bXBsID0gdmFsdWUgJiYgdmFsdWUudHlwZSA9PSAibWFya3VwIiA/IG9sZEF0dGFjaC50bXBsIDogbnVsbDsKICAgICAgICAgICAgaWYgKHRtcGwpIHJldHVybiB0bXBsLmVsZW1lbnQ7CiAgICAgICAgICAgIHZhbHVlID0gYnJpZGdlLmdldCh2YWx1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAob2xkQXR0YWNoKSB7CiAgICAgICAgICAgICAgaWYgKG9sZEF0dGFjaC50bXBsKSB7CiAgICAgICAgICAgICAgICBvbGRBdHRhY2gudG1wbC5lbGVtZW50LnRvU3RyaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIGdldEwxMG5UZW1wbGF0ZShvbGRBdHRhY2gudmFsdWUpLmNsZWFySW5zdGFuY2Uob2xkQXR0YWNoLnRtcGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBvbGRBdHRhY2gudmFsdWUuYmluZGluZ0JyaWRnZS5kZXRhY2gob2xkQXR0YWNoLnZhbHVlLCB1cGRhdGVBdHRhY2gsIG9sZEF0dGFjaCk7CiAgICAgICAgICAgICAgdGhpcy5hdHRhY2hlc1tiaW5kaW5nTmFtZV0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjcmVhdGVCaW5kaW5nVXBkYXRlcihuYW1lcywgZ2V0dGVycykgewogICAgICAgIHZhciBuYW1lMSA9IG5hbWVzWzBdOwogICAgICAgIHZhciBuYW1lMiA9IG5hbWVzWzFdOwogICAgICAgIHZhciBnZXR0ZXIxID0gZ2V0dGVyc1tuYW1lMV07CiAgICAgICAgdmFyIGdldHRlcjIgPSBnZXR0ZXJzW25hbWUyXTsKICAgICAgICBzd2l0Y2ggKG5hbWVzLmxlbmd0aCkgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYmluZGluZ1VwZGF0ZXIxKG9iamVjdCkgewogICAgICAgICAgICAgIHRoaXMobmFtZTEsIGdldHRlcjEob2JqZWN0KSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBiaW5kaW5nVXBkYXRlcjIob2JqZWN0KSB7CiAgICAgICAgICAgICAgdGhpcyhuYW1lMSwgZ2V0dGVyMShvYmplY3QpKTsKICAgICAgICAgICAgICB0aGlzKG5hbWUyLCBnZXR0ZXIyKG9iamVjdCkpOwogICAgICAgICAgICB9OwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdmFyIGdldHRlcnNfID0gbmFtZXMubWFwKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0dGVyc1tuYW1lXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBiaW5kaW5nVXBkYXRlck4ob2JqZWN0KSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuYW1lcy5sZW5ndGg7IGkrKykgdGhpcyhuYW1lc1tpXSwgZ2V0dGVyc19baV0ob2JqZWN0KSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIG1ha2VIYW5kbGVyKGV2ZW50cywgZ2V0dGVycykgewogICAgICAgIGZvciAodmFyIG5hbWUgaW4gZXZlbnRzKSBldmVudHNbbmFtZV0gPSBjcmVhdGVCaW5kaW5nVXBkYXRlcihldmVudHNbbmFtZV0sIGdldHRlcnMpOwogICAgICAgIHJldHVybiBuYW1lID8gZXZlbnRzIDogbnVsbDsKICAgICAgfQogICAgICBmdW5jdGlvbiBjcmVhdGVCaW5kaW5nRnVuY3Rpb24oa2V5cykgewogICAgICAgIHZhciBiaW5kaW5nQ2FjaGUgPSB7fTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gZ2V0QmluZGluZyhiaW5kaW5ncywgb2JqLCBzZXQsIGJpbmRpbmdJbnRlcmZhY2UpIHsKICAgICAgICAgIGlmICghYmluZGluZ3MpIHJldHVybiB7fTsKICAgICAgICAgIHZhciBjYWNoZUlkID0gImJpbmRpbmdJZCIgaW4gYmluZGluZ3MgPyBiaW5kaW5ncy5iaW5kaW5nSWQgOiBudWxsOwogICAgICAgICAgaWYgKCFjYWNoZUlkKSBiYXNpcy5kZXYud2FybigiYmFzaXMudGVtcGxhdGUuVGVtcGxhdGUuZ2V0QmluZGluZzogYmluZGluZ3MgaGFzIG5vIGJpbmRpbmdJZCBwcm9wZXJ0eSwgY2FjaGUgaXMgbm90IHVzZWQiKTsKICAgICAgICAgIHZhciByZXN1bHQgPSBiaW5kaW5nQ2FjaGVbY2FjaGVJZF07CiAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgdmFyIGdldHRlcnMgPSB7fTsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgYmluZGluZ05hbWU7IGJpbmRpbmdOYW1lID0ga2V5c1tpXTsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBiaW5kaW5nc1tiaW5kaW5nTmFtZV07CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IGJpbmRpbmcgJiYgYmluZGluZy5nZXR0ZXI7CiAgICAgICAgICAgICAgaWYgKGdldHRlcikgewogICAgICAgICAgICAgICAgZ2V0dGVyc1tiaW5kaW5nTmFtZV0gPSBnZXR0ZXI7CiAgICAgICAgICAgICAgICBuYW1lcy5wdXNoKGJpbmRpbmdOYW1lKTsKICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nLmV2ZW50cykgewogICAgICAgICAgICAgICAgICB2YXIgZXZlbnRMaXN0ID0gU3RyaW5nKGJpbmRpbmcuZXZlbnRzKS50cmltKCkuc3BsaXQoL1xzK3xccyosXHMqLyk7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBldmVudE5hbWU7IGV2ZW50TmFtZSA9IGV2ZW50TGlzdFtqXTsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50c1tldmVudE5hbWVdKSBldmVudHNbZXZlbnROYW1lXS5wdXNoKGJpbmRpbmdOYW1lKTsgZWxzZSBldmVudHNbZXZlbnROYW1lXSA9IFsgYmluZGluZ05hbWUgXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHQgPSB7CiAgICAgICAgICAgICAgbmFtZXM6IG5hbWVzLAogICAgICAgICAgICAgIHN5bmM6IGNyZWF0ZUJpbmRpbmdVcGRhdGVyKG5hbWVzLCBnZXR0ZXJzKSwKICAgICAgICAgICAgICBoYW5kbGVyOiBtYWtlSGFuZGxlcihldmVudHMsIGdldHRlcnMpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChjYWNoZUlkKSBiaW5kaW5nQ2FjaGVbY2FjaGVJZF0gPSByZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2JqICYmIHNldCkgcmVzdWx0LnN5bmMuY2FsbChzZXQsIG9iaik7CiAgICAgICAgICBpZiAoIWJpbmRpbmdJbnRlcmZhY2UpIHJldHVybjsKICAgICAgICAgIGlmIChyZXN1bHQuaGFuZGxlcikgYmluZGluZ0ludGVyZmFjZS5hdHRhY2gob2JqLCByZXN1bHQuaGFuZGxlciwgc2V0KTsKICAgICAgICAgIHJldHVybiByZXN1bHQuaGFuZGxlcjsKICAgICAgICB9OwogICAgICB9CiAgICAgIHZhciB0b29scyA9IHsKICAgICAgICBiaW5kX3RleHROb2RlOiBiaW5kX3RleHROb2RlLAogICAgICAgIGJpbmRfbm9kZTogYmluZF9ub2RlLAogICAgICAgIGJpbmRfZWxlbWVudDogYmluZF9lbGVtZW50LAogICAgICAgIGJpbmRfY29tbWVudDogYmluZF9jb21tZW50LAogICAgICAgIGJpbmRfYXR0cjogYmluZF9hdHRyLAogICAgICAgIGJpbmRfYXR0ckNsYXNzOiBiaW5kX2F0dHJDbGFzcywKICAgICAgICBiaW5kX2F0dHJTdHlsZTogYmluZF9hdHRyU3R5bGUsCiAgICAgICAgcmVzb2x2ZTogcmVzb2x2ZVZhbHVlLAogICAgICAgIGwxMG5Ub2tlbjogbDEwblRva2VuLAogICAgICAgIGNyZWF0ZUJpbmRpbmdGdW5jdGlvbjogY3JlYXRlQmluZGluZ0Z1bmN0aW9uCiAgICAgIH07CiAgICAgIHJldHVybiBmdW5jdGlvbih0b2tlbnMpIHsKICAgICAgICB2YXIgZm4gPSBnZXRGdW5jdGlvbnModG9rZW5zLCB0cnVlLCB0aGlzLnNvdXJjZS51cmwsIHRva2Vucy5zb3VyY2VfLCAhQ0xPTkVfTk9STUFMSVpBVElPTl9URVhUX0JVRywgYmFzaXNUZW1wbGF0ZUlkTWFya2VyKTsKICAgICAgICB2YXIgY3JlYXRlSW5zdGFuY2U7CiAgICAgICAgdmFyIGluc3RhbmNlcyA9IHt9OwogICAgICAgIHZhciBsMTBuTWFwID0ge307CiAgICAgICAgdmFyIGwxMG5MaW5rcyA9IFtdOwogICAgICAgIHZhciBzZWVkID0gMDsKICAgICAgICB2YXIgcHJvdG8gPSBidWlsZEh0bWwodG9rZW5zKTsKICAgICAgICB2YXIgaWQgPSB0aGlzLnRlbXBsYXRlSWQ7CiAgICAgICAgdGVtcGxhdGVzW2lkXSA9IHsKICAgICAgICAgIHRlbXBsYXRlOiB0aGlzLAogICAgICAgICAgaW5zdGFuY2VzOiBpbnN0YW5jZXMKICAgICAgICB9OwogICAgICAgIGlmIChmbi5jcmVhdGVMMTBuU3luYykgewogICAgICAgICAgdmFyIGwxMG5Qcm90b1N5bmMgPSBmbi5jcmVhdGVMMTBuU3luYyhwcm90bywgbDEwbk1hcCwgYmluZF9hdHRyLCBDTE9ORV9OT1JNQUxJWkFUSU9OX1RFWFRfQlVHKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGZuLmwxMG5LZXlzW2ldOyBpKyspIGwxMG5Qcm90b1N5bmMoa2V5LCBsMTBuVG9rZW4oa2V5KS52YWx1ZSk7CiAgICAgICAgICBpZiAoZm4ubDEwbktleXMpIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGZuLmwxMG5LZXlzW2ldOyBpKyspIHsKICAgICAgICAgICAgdmFyIGxpbmsgPSB7CiAgICAgICAgICAgICAgcGF0aDoga2V5LAogICAgICAgICAgICAgIHRva2VuOiBsMTBuVG9rZW4oa2V5KSwKICAgICAgICAgICAgICBoYW5kbGVyOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgbDEwblByb3RvU3luYyh0aGlzLnBhdGgsIHZhbHVlKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBpbnN0YW5jZXMpIGluc3RhbmNlc1trZXldLnRtcGwuc2V0KHRoaXMucGF0aCwgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgbGluay50b2tlbi5hdHRhY2gobGluay5oYW5kbGVyLCBsaW5rKTsKICAgICAgICAgICAgbDEwbkxpbmtzLnB1c2gobGluayk7CiAgICAgICAgICAgIGxpbmsgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjcmVhdGVJbnN0YW5jZSA9IGZuLmNyZWF0ZUluc3RhbmNlKGlkLCBpbnN0YW5jZXMsIHByb3RvLCB0b29scywgbDEwbk1hcCwgQ0xPTkVfTk9STUFMSVpBVElPTl9URVhUX0JVRyk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNyZWF0ZUluc3RhbmNlOiBmdW5jdGlvbihvYmosIG9uQWN0aW9uLCBvblJlYnVpbGQsIGJpbmRpbmdzLCBiaW5kaW5nSW50ZXJmYWNlKSB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZUlkID0gc2VlZCsrOwogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjcmVhdGVJbnN0YW5jZShpbnN0YW5jZUlkLCBvYmosIG9uQWN0aW9uLCBvblJlYnVpbGQsIGJpbmRpbmdzLCBiaW5kaW5nSW50ZXJmYWNlKTsKICAgICAgICAgICAgaW5zdGFuY2VzW2luc3RhbmNlSWRdID0gaW5zdGFuY2U7CiAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZS50bXBsOwogICAgICAgICAgfSwKICAgICAgICAgIGRlc3Ryb3lJbnN0YW5jZTogZnVuY3Rpb24odG1wbCkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2VJZCA9IHRtcGwudGVtcGxhdGVJZF87CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGluc3RhbmNlc1tpbnN0YW5jZUlkXTsKICAgICAgICAgICAgaWYgKGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLmhhbmRsZXIpIGluc3RhbmNlLmJpbmRpbmdJbnRlcmZhY2UuZGV0YWNoKGluc3RhbmNlLmNvbnRleHQsIGluc3RhbmNlLmhhbmRsZXIsIGluc3RhbmNlLnRtcGwuc2V0KTsKICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2UuYXR0YWNoZXMpIHJlc29sdmVWYWx1ZS5jYWxsKGluc3RhbmNlLCBrZXksIG51bGwpOwogICAgICAgICAgICAgIGRlbGV0ZSBpbnN0YW5jZXNbaW5zdGFuY2VJZF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBrZXlzOiBmbi5rZXlzLAogICAgICAgICAgaW5zdGFuY2VzXzogaW5zdGFuY2VzLAogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24ocmVidWlsZCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGluazsgbGluayA9IGwxMG5MaW5rc1tpXTsgaSsrKSBsaW5rLnRva2VuLmRldGFjaChsaW5rLmhhbmRsZXIsIGxpbmspOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gaW5zdGFuY2VzW2tleV07CiAgICAgICAgICAgICAgaWYgKHJlYnVpbGQgJiYgaW5zdGFuY2UucmVidWlsZCkgaW5zdGFuY2UucmVidWlsZC5jYWxsKGluc3RhbmNlLmNvbnRleHQpOwogICAgICAgICAgICAgIGlmICghcmVidWlsZCB8fCBrZXkgaW4gaW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UuaGFuZGxlcikgaW5zdGFuY2UuYmluZGluZ0ludGVyZmFjZS5kZXRhY2goaW5zdGFuY2UuY29udGV4dCwgaW5zdGFuY2UuaGFuZGxlciwgaW5zdGFuY2UudG1wbC5zZXQpOwogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGluc3RhbmNlLmF0dGFjaGVzKSByZXNvbHZlVmFsdWUuY2FsbChrZXksIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGVtcGxhdGVzW2lkXSAmJiB0ZW1wbGF0ZXNbaWRdLmluc3RhbmNlcyA9PT0gaW5zdGFuY2VzKSBkZWxldGUgdGVtcGxhdGVzW2lkXTsKICAgICAgICAgICAgZm4gPSBudWxsOwogICAgICAgICAgICBwcm90byA9IG51bGw7CiAgICAgICAgICAgIGwxMG5NYXAgPSBudWxsOwogICAgICAgICAgICBsMTBuTGlua3MgPSBudWxsOwogICAgICAgICAgICBsMTBuUHJvdG9TeW5jID0gbnVsbDsKICAgICAgICAgICAgaW5zdGFuY2VzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9OwogICAgfSgpOwogICAgdmFyIEh0bWxUZW1wbGF0ZSA9IFRlbXBsYXRlLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlRlbXBsYXRlIiwKICAgICAgX19leHRlbmRfXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBIdG1sVGVtcGxhdGUpIHJldHVybiB2YWx1ZTsKICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBUZW1wbGF0ZVN3aXRjaENvbmZpZykgcmV0dXJuIG5ldyBIdG1sVGVtcGxhdGVTd2l0Y2hlcih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIG5ldyBIdG1sVGVtcGxhdGUodmFsdWUpOwogICAgICB9LAogICAgICBidWlsZGVyOiBidWlsZGVyCiAgICB9KTsKICAgIHZhciBIdG1sVGVtcGxhdGVTd2l0Y2hlciA9IFRlbXBsYXRlU3dpdGNoZXIuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVGVtcGxhdGVTd2l0Y2hlciIsCiAgICAgIHRlbXBsYXRlQ2xhc3M6IEh0bWxUZW1wbGF0ZQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgbWFya2VyOiBiYXNpc1RlbXBsYXRlSWRNYXJrZXIsCiAgICAgIFRlbXBsYXRlOiBIdG1sVGVtcGxhdGUsCiAgICAgIFRlbXBsYXRlU3dpdGNoZXI6IEh0bWxUZW1wbGF0ZVN3aXRjaGVyCiAgICB9OwogICAgYmFzaXMudGVtcGxhdGUuZXh0ZW5kKHsKICAgICAgZ2V0RGVidWdJbmZvQnlJZDogZ2V0RGVidWdJbmZvQnlJZCwKICAgICAgYnVpbGRIdG1sOiBidWlsZEh0bWwsCiAgICAgIHJlc29sdmVUZW1wbGF0ZUJ5SWQ6IHJlc29sdmVUZW1wbGF0ZUJ5SWQsCiAgICAgIHJlc29sdmVPYmplY3RCeUlkOiByZXNvbHZlT2JqZWN0QnlJZCwKICAgICAgcmVzb2x2ZVRtcGxCeUlkOiByZXNvbHZlVG1wbEJ5SWQKICAgIH0pOwogIH0sCiAgIjguanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgJG51bGwgPSBiYXNpcy5mbi4kbnVsbDsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheS5mcm9tOwogICAgdmFyIFczQ1NVUFBPUlQgPSAhIWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXI7CiAgICB2YXIgRVZFTlRfSE9MREVSID0gIl9fYmFzaXNFdmVudHMiOwogICAgdmFyIEtFWSA9IHsKICAgICAgQkFDS1NQQUNFOiA4LAogICAgICBUQUI6IDksCiAgICAgIENUUkxfRU5URVI6IDEwLAogICAgICBFTlRFUjogMTMsCiAgICAgIFNISUZUOiAxNiwKICAgICAgQ1RSTDogMTcsCiAgICAgIEFMVDogMTgsCiAgICAgIEVTQzogMjcsCiAgICAgIEVTQ0FQRTogMjcsCiAgICAgIFNQQUNFOiAzMiwKICAgICAgUEFHRVVQOiAzMywKICAgICAgUEFHRURPV046IDM0LAogICAgICBFTkQ6IDM1LAogICAgICBIT01FOiAzNiwKICAgICAgTEVGVDogMzcsCiAgICAgIFVQOiAzOCwKICAgICAgUklHSFQ6IDM5LAogICAgICBET1dOOiA0MCwKICAgICAgSU5TRVJUOiA0NSwKICAgICAgREVMRVRFOiA0NiwKICAgICAgRjE6IDExMiwKICAgICAgRjI6IDExMywKICAgICAgRjM6IDExNCwKICAgICAgRjQ6IDExNSwKICAgICAgRjU6IDExNiwKICAgICAgRjY6IDExNywKICAgICAgRjc6IDExOCwKICAgICAgRjg6IDExOSwKICAgICAgRjk6IDEyMCwKICAgICAgRjEwOiAxMjEsCiAgICAgIEYxMTogMTIyLAogICAgICBGMTI6IDEyMwogICAgfTsKICAgIHZhciBNT1VTRV9MRUZUID0gewogICAgICBWQUxVRTogMSwKICAgICAgQklUOiAxCiAgICB9OwogICAgdmFyIE1PVVNFX01JRERMRSA9IHsKICAgICAgVkFMVUU6IDIsCiAgICAgIEJJVDogNAogICAgfTsKICAgIHZhciBNT1VTRV9SSUdIVCA9IHsKICAgICAgVkFMVUU6IDMsCiAgICAgIEJJVDogMgogICAgfTsKICAgIHZhciBCUk9XU0VSX0VWRU5UUyA9IHsKICAgICAgbW91c2V3aGVlbDogWyAibW91c2V3aGVlbCIsICJET01Nb3VzZVNjcm9sbCIgXQogICAgfTsKICAgIGZ1bmN0aW9uIGJyb3dzZXJFdmVudHMoZXZlbnROYW1lKSB7CiAgICAgIHJldHVybiBCUk9XU0VSX0VWRU5UU1tldmVudE5hbWVdIHx8IFsgZXZlbnROYW1lIF07CiAgICB9CiAgICB2YXIgRXZlbnQgPSBiYXNpcy5DbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5FdmVudCIsCiAgICAgIEtFWTogS0VZLAogICAgICBpbml0OiBmdW5jdGlvbihldmVudCkgewogICAgICAgIGV2ZW50ID0gd3JhcChldmVudCk7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBldmVudCkgaWYgKG5hbWUgIT0gInJldHVyblZhbHVlIiAmJiBuYW1lICE9ICJrZXlMb2NhdGlvbiIgJiYgbmFtZSAhPSAibGF5ZXJYIiAmJiBuYW1lICE9ICJsYXllclkiKSBpZiAodHlwZW9mIGV2ZW50W25hbWVdICE9ICJmdW5jdGlvbiIgJiYgbmFtZSBpbiB0aGlzID09IGZhbHNlKSB0aGlzW25hbWVdID0gZXZlbnRbbmFtZV07CiAgICAgICAgdmFyIHRhcmdldCA9IHNlbmRlcihldmVudCk7CiAgICAgICAgYmFzaXMub2JqZWN0LmV4dGVuZCh0aGlzLCB7CiAgICAgICAgICBldmVudF86IGV2ZW50LAogICAgICAgICAgc2VuZGVyOiB0YXJnZXQsCiAgICAgICAgICB0YXJnZXQ6IHRhcmdldCwKICAgICAgICAgIGtleToga2V5KGV2ZW50KSwKICAgICAgICAgIGNoYXJDb2RlOiBjaGFyQ29kZShldmVudCksCiAgICAgICAgICBtb3VzZUxlZnQ6IG1vdXNlQnV0dG9uKGV2ZW50LCBNT1VTRV9MRUZUKSwKICAgICAgICAgIG1vdXNlTWlkZGxlOiBtb3VzZUJ1dHRvbihldmVudCwgTU9VU0VfTUlERExFKSwKICAgICAgICAgIG1vdXNlUmlnaHQ6IG1vdXNlQnV0dG9uKGV2ZW50LCBNT1VTRV9SSUdIVCksCiAgICAgICAgICBtb3VzZVg6IG1vdXNlWChldmVudCksCiAgICAgICAgICBtb3VzZVk6IG1vdXNlWShldmVudCksCiAgICAgICAgICB3aGVlbERlbHRhOiB3aGVlbERlbHRhKGV2ZW50KQogICAgICAgIH0pOwogICAgICB9LAogICAgICBzdG9wQnViYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICBjYW5jZWxCdWJibGUodGhpcy5ldmVudF8pOwogICAgICB9LAogICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgIGNhbmNlbEJ1YmJsZSh0aGlzLmV2ZW50Xyk7CiAgICAgIH0sCiAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICBjYW5jZWxEZWZhdWx0KHRoaXMuZXZlbnRfKTsKICAgICAgfSwKICAgICAgZGllOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnN0b3BCdWJibGUoKTsKICAgICAgICB0aGlzLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gd3JhcChldmVudCkgewogICAgICByZXR1cm4gZXZlbnQgaW5zdGFuY2VvZiBFdmVudCA/IGV2ZW50LmV2ZW50XyA6IGV2ZW50IHx8IGdsb2JhbC5ldmVudDsKICAgIH0KICAgIGZ1bmN0aW9uIGdldE5vZGUocmVmKSB7CiAgICAgIHJldHVybiB0eXBlb2YgcmVmID09ICJzdHJpbmciID8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocmVmKSA6IHJlZjsKICAgIH0KICAgIGZ1bmN0aW9uIHNlbmRlcihldmVudCkgewogICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0IHx8IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgIHJldHVybiB0YXJnZXQubm9kZVR5cGUgPT0gMyA/IHRhcmdldC5wYXJlbnROb2RlIDogdGFyZ2V0OwogICAgfQogICAgZnVuY3Rpb24gY2FuY2VsQnViYmxlKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyBlbHNlIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiBjYW5jZWxEZWZhdWx0KGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkgZXZlbnQucHJldmVudERlZmF1bHQoKTsgZWxzZSBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24ga2lsbChldmVudCwgbm9kZSkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgaWYgKG5vZGUpIGFkZEhhbmRsZXIobm9kZSwgZXZlbnQsIGtpbGwpOyBlbHNlIHsKICAgICAgICBjYW5jZWxEZWZhdWx0KGV2ZW50KTsKICAgICAgICBjYW5jZWxCdWJibGUoZXZlbnQpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBrZXkoZXZlbnQpIHsKICAgICAgcmV0dXJuIGV2ZW50LmtleUNvZGUgfHwgZXZlbnQud2hpY2ggfHwgMDsKICAgIH0KICAgIGZ1bmN0aW9uIGNoYXJDb2RlKGV2ZW50KSB7CiAgICAgIHJldHVybiBldmVudC5jaGFyQ29kZSB8fCBldmVudC5rZXlDb2RlIHx8IDA7CiAgICB9CiAgICBmdW5jdGlvbiBtb3VzZUJ1dHRvbihldmVudCwgYnV0dG9uKSB7CiAgICAgIGlmICh0eXBlb2YgZXZlbnQud2hpY2ggPT0gIm51bWJlciIpIHJldHVybiBldmVudC53aGljaCA9PSBidXR0b24uVkFMVUU7IGVsc2UgcmV0dXJuICEhKGV2ZW50LmJ1dHRvbiAmIGJ1dHRvbi5CSVQpOwogICAgfQogICAgZnVuY3Rpb24gbW91c2VYKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5jaGFuZ2VkVG91Y2hlcykgcmV0dXJuIGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYOyBlbHNlIGlmICgicGFnZVgiIGluIGV2ZW50KSByZXR1cm4gZXZlbnQucGFnZVg7IGVsc2UgcmV0dXJuICJjbGllbnRYIiBpbiBldmVudCA/IGV2ZW50LmNsaWVudFggKyAoZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIgPyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCA6IGRvY3VtZW50LmJvZHkuc2Nyb2xsTGVmdCkgOiAwOwogICAgfQogICAgZnVuY3Rpb24gbW91c2VZKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5jaGFuZ2VkVG91Y2hlcykgcmV0dXJuIGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VZOyBlbHNlIGlmICgicGFnZVkiIGluIGV2ZW50KSByZXR1cm4gZXZlbnQucGFnZVk7IGVsc2UgcmV0dXJuICJjbGllbnRZIiBpbiBldmVudCA/IGV2ZW50LmNsaWVudFkgKyAoZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIgPyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wIDogZG9jdW1lbnQuYm9keS5zY3JvbGxUb3ApIDogMDsKICAgIH0KICAgIGZ1bmN0aW9uIHdoZWVsRGVsdGEoZXZlbnQpIHsKICAgICAgdmFyIGRlbHRhID0gMDsKICAgICAgaWYgKCJ3aGVlbERlbHRhIiBpbiBldmVudCkgZGVsdGEgPSBldmVudC53aGVlbERlbHRhOyBlbHNlIGlmIChldmVudC50eXBlID09ICJET01Nb3VzZVNjcm9sbCIpIGRlbHRhID0gLWV2ZW50LmRldGFpbDsKICAgICAgcmV0dXJuIGRlbHRhICYmIGRlbHRhIC8gTWF0aC5hYnMoZGVsdGEpOwogICAgfQogICAgdmFyIGdsb2JhbEhhbmRsZXJzID0ge307CiAgICB2YXIgY2FwdHVyZUhhbmRsZXJzID0ge307CiAgICB2YXIgbm9DYXB0dXJlU2NoZW1lID0gIVczQ1NVUFBPUlQ7CiAgICBmdW5jdGlvbiBvYnNlcnZlR2xvYmFsRXZlbnRzKGV2ZW50KSB7CiAgICAgIHZhciBoYW5kbGVycyA9IGFycmF5RnJvbShnbG9iYWxIYW5kbGVyc1tldmVudC50eXBlXSk7CiAgICAgIHZhciBjYXB0dXJlSGFuZGxlciA9IGNhcHR1cmVIYW5kbGVyc1tldmVudC50eXBlXTsKICAgICAgdmFyIHdyYXBwZWRFdmVudCA9IG5ldyBFdmVudChldmVudCk7CiAgICAgIGlmIChjYXB0dXJlSGFuZGxlcikgewogICAgICAgIGNhcHR1cmVIYW5kbGVyLmhhbmRsZXIuY2FsbChjYXB0dXJlSGFuZGxlci50aGlzT2JqZWN0LCB3cmFwcGVkRXZlbnQpOwogICAgICAgIGtpbGwoZXZlbnQpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICBmb3IgKHZhciBpID0gaGFuZGxlcnMubGVuZ3RoOyBpLS0gPiAwOyApIHsKICAgICAgICAgIHZhciBoYW5kbGVyT2JqZWN0ID0gaGFuZGxlcnNbaV07CiAgICAgICAgICBoYW5kbGVyT2JqZWN0LmhhbmRsZXIuY2FsbChoYW5kbGVyT2JqZWN0LnRoaXNPYmplY3QsIHdyYXBwZWRFdmVudCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBjYXB0dXJlRXZlbnQoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIGlmIChjYXB0dXJlSGFuZGxlcnNbZXZlbnRUeXBlXSkgcmVsZWFzZUV2ZW50KGV2ZW50VHlwZSk7CiAgICAgIGFkZEdsb2JhbEhhbmRsZXIoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KTsKICAgICAgY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV0gPSB7CiAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICB0aGlzT2JqZWN0OiB0aGlzT2JqZWN0CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiByZWxlYXNlRXZlbnQoZXZlbnRUeXBlKSB7CiAgICAgIHZhciBoYW5kbGVyT2JqZWN0ID0gY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIGlmIChoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgcmVtb3ZlR2xvYmFsSGFuZGxlcihldmVudFR5cGUsIGhhbmRsZXJPYmplY3QuaGFuZGxlciwgaGFuZGxlck9iamVjdC50aGlzT2JqZWN0KTsKICAgICAgICBkZWxldGUgY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGFkZEdsb2JhbEhhbmRsZXIoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIHZhciBoYW5kbGVycyA9IGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIGlmIChoYW5kbGVycykgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gaGFuZGxlcnNbaV07IGkrKykgaWYgKGl0ZW0uaGFuZGxlciA9PT0gaGFuZGxlciAmJiBpdGVtLnRoaXNPYmplY3QgPT09IHRoaXNPYmplY3QpIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAobm9DYXB0dXJlU2NoZW1lKSBhZGRIYW5kbGVyKGRvY3VtZW50LCBldmVudFR5cGUsICRudWxsKTsgZWxzZSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgb2JzZXJ2ZUdsb2JhbEV2ZW50cywgdHJ1ZSk7CiAgICAgICAgaGFuZGxlcnMgPSBnbG9iYWxIYW5kbGVyc1tldmVudFR5cGVdID0gW107CiAgICAgIH0KICAgICAgaGFuZGxlcnMucHVzaCh7CiAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICB0aGlzT2JqZWN0OiB0aGlzT2JqZWN0CiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlR2xvYmFsSGFuZGxlcihldmVudFR5cGUsIGhhbmRsZXIsIHRoaXNPYmplY3QpIHsKICAgICAgdmFyIGhhbmRsZXJzID0gZ2xvYmFsSGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgaWYgKGhhbmRsZXJzKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBoYW5kbGVyc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAoaXRlbS5oYW5kbGVyID09PSBoYW5kbGVyICYmIGl0ZW0udGhpc09iamVjdCA9PT0gdGhpc09iamVjdCkgewogICAgICAgICAgICBoYW5kbGVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIGlmICghaGFuZGxlcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZGVsZXRlIGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgICAgICAgICAgaWYgKG5vQ2FwdHVyZVNjaGVtZSkgcmVtb3ZlSGFuZGxlcihkb2N1bWVudCwgZXZlbnRUeXBlLCAkbnVsbCk7IGVsc2UgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIG9ic2VydmVHbG9iYWxFdmVudHMsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGFkZEhhbmRsZXIobm9kZSwgZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIG5vZGUgPSBnZXROb2RlKG5vZGUpOwogICAgICBpZiAoIW5vZGUpIHRocm93ICJiYXNpcy5ldmVudC5hZGRIYW5kbGVyOiBjYW4ndCBhdHRhY2ggZXZlbnQgbGlzdGVuZXIgdG8gdW5kZWZpbmVkIjsKICAgICAgaWYgKHR5cGVvZiBoYW5kbGVyICE9ICJmdW5jdGlvbiIpIHRocm93ICJiYXNpcy5ldmVudC5hZGRIYW5kbGVyOiBoYW5kbGVyIGlzIG5vdCBhIGZ1bmN0aW9uIjsKICAgICAgaWYgKCFub2RlW0VWRU5UX0hPTERFUl0pIG5vZGVbRVZFTlRfSE9MREVSXSA9IHt9OwogICAgICB2YXIgaGFuZGxlck9iamVjdCA9IHsKICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgIHRoaXNPYmplY3Q6IHRoaXNPYmplY3QKICAgICAgfTsKICAgICAgdmFyIGhhbmRsZXJzID0gbm9kZVtFVkVOVF9IT0xERVJdOwogICAgICB2YXIgZXZlbnRUeXBlSGFuZGxlcnMgPSBoYW5kbGVyc1tldmVudFR5cGVdOwogICAgICBpZiAoIWV2ZW50VHlwZUhhbmRsZXJzKSB7CiAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMgPSBoYW5kbGVyc1tldmVudFR5cGVdID0gWyBoYW5kbGVyT2JqZWN0IF07CiAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMuZmlyZUV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIGV2ZW50ID0gd3JhcChldmVudCk7CiAgICAgICAgICBpZiAobm9DYXB0dXJlU2NoZW1lICYmIGV2ZW50ICYmIGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV0pIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBldmVudC5yZXR1cm5WYWx1ZSA9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIG9ic2VydmVHbG9iYWxFdmVudHMoZXZlbnQpOwogICAgICAgICAgICAgIGlmIChldmVudC5jYW5jZWxCdWJibGUgPT09IHRydWUpIHJldHVybjsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50LnJldHVyblZhbHVlID09ICJ1bmRlZmluZWQiKSBldmVudC5yZXR1cm5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwLCB3cmFwcGVkRXZlbnQgPSBuZXcgRXZlbnQoZXZlbnQpLCBpdGVtOyBpdGVtID0gZXZlbnRUeXBlSGFuZGxlcnNbaSsrXTsgKSBpdGVtLmhhbmRsZXIuY2FsbChpdGVtLnRoaXNPYmplY3QsIHdyYXBwZWRFdmVudCk7CiAgICAgICAgfTsKICAgICAgICBpZiAoVzNDU1VQUE9SVCkgbm9kZS5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgZXZlbnRUeXBlSGFuZGxlcnMuZmlyZUV2ZW50LCBmYWxzZSk7IGVsc2Ugbm9kZS5hdHRhY2hFdmVudCgib24iICsgZXZlbnRUeXBlLCBldmVudFR5cGVIYW5kbGVycy5maXJlRXZlbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gZXZlbnRUeXBlSGFuZGxlcnNbaV07IGkrKykgaWYgKGl0ZW0uaGFuZGxlciA9PT0gaGFuZGxlciAmJiBpdGVtLnRoaXNPYmplY3QgPT09IHRoaXNPYmplY3QpIHJldHVybjsKICAgICAgICBldmVudFR5cGVIYW5kbGVycy5wdXNoKGhhbmRsZXJPYmplY3QpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGRIYW5kbGVycyhub2RlLCBoYW5kbGVycywgdGhpc09iamVjdCkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgZm9yICh2YXIgZXZlbnRUeXBlIGluIGhhbmRsZXJzKSBhZGRIYW5kbGVyKG5vZGUsIGV2ZW50VHlwZSwgaGFuZGxlcnNbZXZlbnRUeXBlXSwgdGhpc09iamVjdCk7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVIYW5kbGVyKG5vZGUsIGV2ZW50VHlwZSwgaGFuZGxlciwgdGhpc09iamVjdCkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgdmFyIGhhbmRsZXJzID0gbm9kZVtFVkVOVF9IT0xERVJdOwogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICB2YXIgZXZlbnRUeXBlSGFuZGxlcnMgPSBoYW5kbGVyc1tldmVudFR5cGVdOwogICAgICAgIGlmIChldmVudFR5cGVIYW5kbGVycykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBldmVudFR5cGVIYW5kbGVyc1tpXTsgaSsrKSB7CiAgICAgICAgICAgIGlmIChpdGVtLmhhbmRsZXIgPT09IGhhbmRsZXIgJiYgaXRlbS50aGlzT2JqZWN0ID09PSB0aGlzT2JqZWN0KSB7CiAgICAgICAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgIGlmICghZXZlbnRUeXBlSGFuZGxlcnMubGVuZ3RoKSBjbGVhckhhbmRsZXJzKG5vZGUsIGV2ZW50VHlwZSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBjbGVhckhhbmRsZXJzKG5vZGUsIGV2ZW50VHlwZSkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgdmFyIGhhbmRsZXJzID0gbm9kZVtFVkVOVF9IT0xERVJdOwogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICBpZiAodHlwZW9mIGV2ZW50VHlwZSAhPSAic3RyaW5nIikgewogICAgICAgICAgZm9yIChldmVudFR5cGUgaW4gaGFuZGxlcnMpIGNsZWFySGFuZGxlcnMobm9kZSwgZXZlbnRUeXBlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGV2ZW50VHlwZUhhbmRsZXJzID0gaGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgICAgIGlmIChldmVudFR5cGVIYW5kbGVycykgewogICAgICAgICAgICBpZiAobm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKSBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBldmVudFR5cGVIYW5kbGVycy5maXJlRXZlbnQsIGZhbHNlKTsgZWxzZSBub2RlLmRldGFjaEV2ZW50KCJvbiIgKyBldmVudFR5cGUsIGV2ZW50VHlwZUhhbmRsZXJzLmZpcmVFdmVudCk7CiAgICAgICAgICAgIGRlbGV0ZSBoYW5kbGVyc1tldmVudFR5cGVdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZmlyZUV2ZW50KG5vZGUsIGV2ZW50VHlwZSwgZXZlbnQpIHsKICAgICAgbm9kZSA9IGdldE5vZGUobm9kZSk7CiAgICAgIHZhciBoYW5kbGVycyA9IG5vZGVbRVZFTlRfSE9MREVSXTsKICAgICAgaWYgKGhhbmRsZXJzICYmIGhhbmRsZXJzW2V2ZW50VHlwZV0pIGhhbmRsZXJzW2V2ZW50VHlwZV0uZmlyZUV2ZW50KGV2ZW50KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9uVW5sb2FkKGhhbmRsZXIsIHRoaXNPYmplY3QpIHsKICAgICAgYWRkSGFuZGxlcihnbG9iYWwsICJ1bmxvYWQiLCBoYW5kbGVyLCB0aGlzT2JqZWN0KTsKICAgIH0KICAgIHZhciB0YWdOYW1lRXZlbnRNYXAgPSB7fTsKICAgIGZ1bmN0aW9uIGdldEV2ZW50SW5mbyhldmVudE5hbWUsIHRhZ05hbWUpIHsKICAgICAgaWYgKCF0YWdOYW1lKSB0YWdOYW1lID0gImRpdiI7CiAgICAgIHZhciBpZCA9IHRhZ05hbWUgKyAiLSIgKyBldmVudE5hbWU7CiAgICAgIGlmICh0YWdOYW1lRXZlbnRNYXBbaWRdKSByZXR1cm4gdGFnTmFtZUV2ZW50TWFwW2lkXTsgZWxzZSB7CiAgICAgICAgdmFyIHN1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgIHZhciBidWJibGUgPSBmYWxzZTsKICAgICAgICBpZiAoIVczQ1NVUFBPUlQpIHsKICAgICAgICAgIHZhciBvbmV2ZW50ID0gIm9uIiArIGV2ZW50TmFtZTsKICAgICAgICAgIHZhciBob3N0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gaG9zdC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpKTsKICAgICAgICAgIGhvc3Rbb25ldmVudF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgYnViYmxlID0gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0YXJnZXQuZmlyZUV2ZW50KG9uZXZlbnQpOwogICAgICAgICAgICBzdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRhZ05hbWVFdmVudE1hcFtpZF0gPSB7CiAgICAgICAgICBzdXBwb3J0ZWQ6IHN1cHBvcnRlZCwKICAgICAgICAgIGJ1YmJsZTogYnViYmxlCiAgICAgICAgfTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gd3JhcEV2ZW50RnVuY3Rpb24oZm4pIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50LCBhcmcpIHsKICAgICAgICByZXR1cm4gZm4od3JhcChldmVudCksIGFyZyk7CiAgICAgIH07CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgVzNDU1VQUE9SVDogVzNDU1VQUE9SVCwKICAgICAgYnJvd3NlckV2ZW50czogYnJvd3NlckV2ZW50cywKICAgICAgZ2V0RXZlbnRJbmZvOiBnZXRFdmVudEluZm8sCiAgICAgIEtFWTogS0VZLAogICAgICBNT1VTRV9MRUZUOiBNT1VTRV9MRUZULAogICAgICBNT1VTRV9SSUdIVDogTU9VU0VfUklHSFQsCiAgICAgIE1PVVNFX01JRERMRTogTU9VU0VfTUlERExFLAogICAgICBFdmVudDogRXZlbnQsCiAgICAgIHNlbmRlcjogd3JhcEV2ZW50RnVuY3Rpb24oc2VuZGVyKSwKICAgICAgY2FuY2VsQnViYmxlOiB3cmFwRXZlbnRGdW5jdGlvbihjYW5jZWxCdWJibGUpLAogICAgICBjYW5jZWxEZWZhdWx0OiB3cmFwRXZlbnRGdW5jdGlvbihjYW5jZWxEZWZhdWx0KSwKICAgICAga2lsbDogd3JhcEV2ZW50RnVuY3Rpb24oa2lsbCksCiAgICAgIGtleTogd3JhcEV2ZW50RnVuY3Rpb24oa2V5KSwKICAgICAgY2hhckNvZGU6IHdyYXBFdmVudEZ1bmN0aW9uKGNoYXJDb2RlKSwKICAgICAgbW91c2VCdXR0b246IHdyYXBFdmVudEZ1bmN0aW9uKG1vdXNlQnV0dG9uKSwKICAgICAgbW91c2VYOiB3cmFwRXZlbnRGdW5jdGlvbihtb3VzZVgpLAogICAgICBtb3VzZVk6IHdyYXBFdmVudEZ1bmN0aW9uKG1vdXNlWSksCiAgICAgIHdoZWVsRGVsdGE6IHdyYXBFdmVudEZ1bmN0aW9uKHdoZWVsRGVsdGEpLAogICAgICBhZGRHbG9iYWxIYW5kbGVyOiBhZGRHbG9iYWxIYW5kbGVyLAogICAgICByZW1vdmVHbG9iYWxIYW5kbGVyOiByZW1vdmVHbG9iYWxIYW5kbGVyLAogICAgICBjYXB0dXJlRXZlbnQ6IGNhcHR1cmVFdmVudCwKICAgICAgcmVsZWFzZUV2ZW50OiByZWxlYXNlRXZlbnQsCiAgICAgIGFkZEhhbmRsZXI6IGFkZEhhbmRsZXIsCiAgICAgIGFkZEhhbmRsZXJzOiBhZGRIYW5kbGVycywKICAgICAgcmVtb3ZlSGFuZGxlcjogcmVtb3ZlSGFuZGxlciwKICAgICAgY2xlYXJIYW5kbGVyczogY2xlYXJIYW5kbGVycywKICAgICAgZmlyZUV2ZW50OiBmaXJlRXZlbnQsCiAgICAgIG9uVW5sb2FkOiBvblVubG9hZCwKICAgICAgd3JhcDogd3JhcAogICAgfTsKICB9LAogICI5LmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzYuanMiKTsKICAgIHZhciBUWVBFX0VMRU1FTlQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0VMRU1FTlQ7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEUgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0FUVFJJQlVURTsKICAgIHZhciBUWVBFX1RFWFQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX1RFWFQ7CiAgICB2YXIgVFlQRV9DT01NRU5UID0gYmFzaXMudGVtcGxhdGUuVFlQRV9DT01NRU5UOwogICAgdmFyIFRPS0VOX1RZUEUgPSBiYXNpcy50ZW1wbGF0ZS5UT0tFTl9UWVBFOwogICAgdmFyIFRPS0VOX0JJTkRJTkdTID0gYmFzaXMudGVtcGxhdGUuVE9LRU5fQklORElOR1M7CiAgICB2YXIgVE9LRU5fUkVGUyA9IGJhc2lzLnRlbXBsYXRlLlRPS0VOX1JFRlM7CiAgICB2YXIgQVRUUl9OQU1FID0gYmFzaXMudGVtcGxhdGUuQVRUUl9OQU1FOwogICAgdmFyIEFUVFJfTkFNRV9CWV9UWVBFID0gYmFzaXMudGVtcGxhdGUuQVRUUl9OQU1FX0JZX1RZUEU7CiAgICB2YXIgRUxFTUVOVF9OQU1FID0gYmFzaXMudGVtcGxhdGUuRUxFTUVOVF9OQU1FOwogICAgdmFyIEVMRU1FTlRfQVRUUlMgPSBiYXNpcy50ZW1wbGF0ZS5FTEVNRU5UX0FUVFJTOwogICAgdmFyIEVMRU1FTlRfQ0hJTERTID0gYmFzaXMudGVtcGxhdGUuRUxFTUVOVF9DSElMRFM7CiAgICB2YXIgVEVYVF9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLlRFWFRfVkFMVUU7CiAgICB2YXIgQ09NTUVOVF9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLkNPTU1FTlRfVkFMVUU7CiAgICB2YXIgdG1wbEZ1bmN0aW9ucyA9IHt9OwogICAgdmFyIGlubGluZVNlZWQgPSAxOwogICAgdmFyIGJ1aWxkUGF0aGVzID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBQQVRIX1JFRl9OQU1FID0gImFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVoiLnNwbGl0KCIiKTsKICAgICAgdmFyIHBhdGhMaXN0OwogICAgICB2YXIgcmVmTGlzdDsKICAgICAgdmFyIGJpbmRpbmdMaXN0OwogICAgICB2YXIgbWFya2VkRWxlbWVudExpc3Q7CiAgICAgIHZhciByb290UGF0aDsKICAgICAgdmFyIGF0dHJFeHBySWQ7CiAgICAgIGZ1bmN0aW9uIHB1dFJlZnMocmVmcywgcGF0aElkeCkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCByZWZOYW1lOyByZWZOYW1lID0gcmVmc1tpXTsgaSsrKSBpZiAocmVmTmFtZS5pbmRleE9mKCI6IikgPT0gLTEpIHJlZkxpc3QucHVzaChyZWZOYW1lICsgIjoiICsgcGF0aElkeCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcHV0UGF0aChwYXRoKSB7CiAgICAgICAgdmFyIGxlbiA9IHBhdGhMaXN0Lmxlbmd0aDsKICAgICAgICB2YXIgcGF0aFJlZiA9IFBBVEhfUkVGX05BTUVbbGVuXSB8fCAiciIgKyBsZW47CiAgICAgICAgcGF0aExpc3QucHVzaChwYXRoUmVmICsgIj0iICsgcGF0aCk7CiAgICAgICAgcmV0dXJuIHBhdGhSZWY7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcHV0QmluZGluZyhiaW5kaW5nKSB7CiAgICAgICAgYmluZGluZ0xpc3QucHVzaChiaW5kaW5nKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwcm9jZXNzVG9rZW5zKHRva2VucywgcGF0aCwgbm9UZXh0QnVnLCB0ZW1wbGF0ZU1hcmtlcikgewogICAgICAgIHZhciBsb2NhbFBhdGg7CiAgICAgICAgdmFyIHJlZnM7CiAgICAgICAgdmFyIG15UmVmOwogICAgICAgIHZhciBleHBsaWNpdFJlZjsKICAgICAgICB2YXIgYmluZGluZ3M7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNwID0gMCwgY2xvc2VUZXh0ID0gMCwgdG9rZW47IHRva2VuID0gdG9rZW5zW2ldOyBpKyssIGNwKyssIGV4cGxpY2l0UmVmID0gZmFsc2UpIHsKICAgICAgICAgIGlmICghaSkgbG9jYWxQYXRoID0gcGF0aCArICIuZmlyc3RDaGlsZCI7IGVsc2UgewogICAgICAgICAgICBpZiAoIXRva2Vuc1tpICsgMV0pIGxvY2FsUGF0aCA9IHBhdGggKyAiLmxhc3RDaGlsZCI7IGVsc2UgewogICAgICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9UWVBFXSA9PSB0b2tlbnNbaSAtIDFdW1RPS0VOX1RZUEVdICYmIHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfVEVYVCkgY2xvc2VUZXh0Kys7CiAgICAgICAgICAgICAgbG9jYWxQYXRoID0gcGF0aCArICIuY2hpbGROb2Rlc1siICsgKG5vVGV4dEJ1ZyA/IGNwIDogY3AgKyAoY2xvc2VUZXh0ID8gIiArICIgKyBjbG9zZVRleHQgKyAiICogVEVYVF9CVUciIDogIiIpKSArICJdIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlZnMgPSB0b2tlbltUT0tFTl9SRUZTXSkgewogICAgICAgICAgICBleHBsaWNpdFJlZiA9IHRydWU7CiAgICAgICAgICAgIGxvY2FsUGF0aCA9IHB1dFBhdGgobG9jYWxQYXRoKTsKICAgICAgICAgICAgcHV0UmVmcyhyZWZzLCBsb2NhbFBhdGgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRva2VuW1RPS0VOX0JJTkRJTkdTXSkgewogICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fQklORElOR1NdICYmIHR5cGVvZiB0b2tlbltUT0tFTl9CSU5ESU5HU10gPT0gIm51bWJlciIpIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IHRva2VuW1RPS0VOX1JFRlNdW3Rva2VuW1RPS0VOX0JJTkRJTkdTXSAtIDFdOwogICAgICAgICAgICBpZiAoIWV4cGxpY2l0UmVmKSB7CiAgICAgICAgICAgICAgZXhwbGljaXRSZWYgPSB0cnVlOwogICAgICAgICAgICAgIGxvY2FsUGF0aCA9IHB1dFBhdGgobG9jYWxQYXRoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwdXRCaW5kaW5nKFsgdG9rZW5bVE9LRU5fVFlQRV0sIGxvY2FsUGF0aCwgdG9rZW5bVE9LRU5fQklORElOR1NdIF0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfRUxFTUVOVCkgewogICAgICAgICAgICBteVJlZiA9IC0xOwogICAgICAgICAgICBpZiAocGF0aCA9PSByb290UGF0aCkgbWFya2VkRWxlbWVudExpc3QucHVzaChsb2NhbFBhdGggKyAiLiIgKyB0ZW1wbGF0ZU1hcmtlcik7CiAgICAgICAgICAgIGlmICghZXhwbGljaXRSZWYpIHsKICAgICAgICAgICAgICBsb2NhbFBhdGggPSBwdXRQYXRoKGxvY2FsUGF0aCk7CiAgICAgICAgICAgICAgbXlSZWYgPSBwYXRoTGlzdC5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGF0dHJzID0gW107CiAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBqID0gRUxFTUVOVF9BVFRSUywgdDsgdCA9IHRva2VuW2pdOyBqKyspIGlmICh0W1RPS0VOX1RZUEVdID09IFRZUEVfRUxFTUVOVCB8fCB0W1RPS0VOX1RZUEVdID09IFRZUEVfVEVYVCB8fCB0W1RPS0VOX1RZUEVdID09IFRZUEVfQ09NTUVOVCkgY2hpbGRyZW4ucHVzaCh0KTsgZWxzZSBhdHRycy5wdXNoKHQpOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgYXR0cjsgYXR0ciA9IGF0dHJzW2pdOyBqKyspIHsKICAgICAgICAgICAgICBpZiAoYXR0cltUT0tFTl9UWVBFXSA9PSA2KSBjb250aW51ZTsKICAgICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSBBVFRSX05BTUVfQllfVFlQRVthdHRyW1RPS0VOX1RZUEVdXSB8fCBhdHRyW0FUVFJfTkFNRV07CiAgICAgICAgICAgICAgaWYgKHJlZnMgPSBhdHRyW1RPS0VOX1JFRlNdKSB7CiAgICAgICAgICAgICAgICBleHBsaWNpdFJlZiA9IHRydWU7CiAgICAgICAgICAgICAgICBwdXRSZWZzKHJlZnMsIHB1dFBhdGgobG9jYWxQYXRoICsgJy5nZXRBdHRyaWJ1dGVOb2RlKCInICsgYXR0ck5hbWUgKyAnIiknKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChiaW5kaW5ncyA9IGF0dHJbVE9LRU5fQklORElOR1NdKSB7CiAgICAgICAgICAgICAgICBleHBsaWNpdFJlZiA9IHRydWU7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgImNsYXNzIjoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMCwgYmluZGluZzsgYmluZGluZyA9IGJpbmRpbmdzW2tdOyBrKyspIHB1dEJpbmRpbmcoWyAyLCBsb2NhbFBhdGgsIGJpbmRpbmdbMV0sIGF0dHJOYW1lLCBiaW5kaW5nWzBdIF0uY29uY2F0KGJpbmRpbmcuc2xpY2UoMikpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAic3R5bGUiOgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBwcm9wZXJ0eTsgcHJvcGVydHkgPSBiaW5kaW5nc1trXTsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgICBhdHRyRXhwcklkKys7CiAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBtID0gMCwgYmluZE5hbWU7IGJpbmROYW1lID0gcHJvcGVydHlbMF1bbV07IG0rKykgcHV0QmluZGluZyhbIDIsIGxvY2FsUGF0aCwgYmluZE5hbWUsIGF0dHJOYW1lLCBwcm9wZXJ0eVswXSwgcHJvcGVydHlbMV0sIHByb3BlcnR5WzJdLCBwcm9wZXJ0eVszXSwgYXR0ckV4cHJJZCBdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgYXR0ckV4cHJJZCsrOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBiaW5kTmFtZTsgYmluZE5hbWUgPSBiaW5kaW5nc1swXVtrXTsgaysrKSBwdXRCaW5kaW5nKFsgMiwgbG9jYWxQYXRoLCBiaW5kTmFtZSwgYXR0ck5hbWUsIGJpbmRpbmdzWzBdLCBiaW5kaW5nc1sxXSwgdG9rZW5bRUxFTUVOVF9OQU1FXSwgYXR0ckV4cHJJZCBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCkgcHJvY2Vzc1Rva2VucyhjaGlsZHJlbiwgbG9jYWxQYXRoLCBub1RleHRCdWcpOwogICAgICAgICAgICBpZiAoIWV4cGxpY2l0UmVmICYmIG15UmVmID09IHBhdGhMaXN0Lmxlbmd0aCkgcGF0aExpc3QucG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbih0b2tlbnMsIHBhdGgsIG5vVGV4dEJ1ZywgdGVtcGxhdGVNYXJrZXIpIHsKICAgICAgICBwYXRoTGlzdCA9IFtdOwogICAgICAgIHJlZkxpc3QgPSBbXTsKICAgICAgICBiaW5kaW5nTGlzdCA9IFtdOwogICAgICAgIG1hcmtlZEVsZW1lbnRMaXN0ID0gW107CiAgICAgICAgcm9vdFBhdGggPSBwYXRoIHx8ICJfIjsKICAgICAgICBhdHRyRXhwcklkID0gMDsKICAgICAgICBwcm9jZXNzVG9rZW5zKHRva2Vucywgcm9vdFBhdGgsIG5vVGV4dEJ1ZywgdGVtcGxhdGVNYXJrZXIpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwYXRoOiBwYXRoTGlzdCwKICAgICAgICAgIHJlZjogcmVmTGlzdCwKICAgICAgICAgIGJpbmRpbmc6IGJpbmRpbmdMaXN0LAogICAgICAgICAgbWFya2VkRWxlbWVudExpc3Q6IG1hcmtlZEVsZW1lbnRMaXN0CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0oKTsKICAgIHZhciBidWlsZEJpbmRpbmdzID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBMMTBOX0JJTkRJTkcgPSAvXC5ceyhbYS16QS1aX11bYS16QS1aMC05X1wtXSopXH0vOwogICAgICB2YXIgU1BFQ0lBTF9BVFRSX01BUCA9IHsKICAgICAgICBkaXNhYmxlZDogIioiLAogICAgICAgIGNoZWNrZWQ6IFsgImlucHV0IiBdLAogICAgICAgIGluZGV0ZXJtaW5hdGU6IFsgImlucHV0IiBdLAogICAgICAgIHZhbHVlOiBbICJpbnB1dCIsICJ0ZXh0YXJlYSIsICJzZWxlY3QiIF0sCiAgICAgICAgbWlubGVuZ3RoOiBbICJpbnB1dCIgXSwKICAgICAgICBtYXhsZW5ndGg6IFsgImlucHV0IiBdLAogICAgICAgIHJlYWRvbmx5OiBbICJpbnB1dCIgXSwKICAgICAgICBzZWxlY3RlZDogWyAib3B0aW9uIiBdLAogICAgICAgIG11bHRpcGxlOiBbICJzZWxlY3QiIF0KICAgICAgfTsKICAgICAgdmFyIFNQRUNJQUxfQVRUUl9TSU5HTEUgPSB7CiAgICAgICAgZGlzYWJsZWQ6IHRydWUsCiAgICAgICAgY2hlY2tlZDogdHJ1ZSwKICAgICAgICBzZWxlY3RlZDogdHJ1ZSwKICAgICAgICByZWFkb25seTogdHJ1ZSwKICAgICAgICBtdWx0aXBsZTogdHJ1ZSwKICAgICAgICBpbmRldGVybWluYXRlOiB0cnVlCiAgICAgIH07CiAgICAgIHZhciBiaW5kRnVuY3Rpb25zID0gewogICAgICAgIDE6ICJiaW5kX2VsZW1lbnQiLAogICAgICAgIDM6ICJiaW5kX3RleHROb2RlIiwKICAgICAgICA4OiAiYmluZF9jb21tZW50IgogICAgICB9OwogICAgICBmdW5jdGlvbiBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsIHNwZWNpYWwsIGwxMG4pIHsKICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IFtdOwogICAgICAgIHZhciBzeW1ib2xzID0gYmluZGluZ1s1XTsKICAgICAgICB2YXIgZGljdGlvbmFyeSA9IGJpbmRpbmdbNF07CiAgICAgICAgdmFyIGV4cHJWYXI7CiAgICAgICAgdmFyIGNvbG9uUG9zOwogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc3ltYm9scy5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKHR5cGVvZiBzeW1ib2xzW2pdID09ICJzdHJpbmciKSBleHByZXNzaW9uLnB1c2goJyInICsgc3ltYm9sc1tqXS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJyk7IGVsc2UgewogICAgICAgICAgICBleHByVmFyID0gZGljdGlvbmFyeVtzeW1ib2xzW2pdXTsKICAgICAgICAgICAgY29sb25Qb3MgPSBleHByVmFyLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgaWYgKGNvbG9uUG9zID09IC0xKSB7CiAgICAgICAgICAgICAgZXhwcmVzc2lvbi5wdXNoKHNwZWNpYWwgPT0gImwxMG4iID8gJyJ7JyArIGV4cHJWYXIgKyAnfSInIDogc3BlY2lhbCA9PSAiYm9vbCIgPyAiKF9fIiArIGV4cHJWYXIgKyAnfHwiIiknIDogIl9fIiArIGV4cHJWYXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBiaW5kaW5nTmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGwxMG5QYXRoID0gZXhwclZhci5zdWJzdHIoY29sb25Qb3MgKyAxKS5yZXBsYWNlKEwxME5fQklORElORywgZnVuY3Rpb24obSwgbmFtZSkgewogICAgICAgICAgICAgICAgYmluZGluZ05hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmIChiaW5kaW5nTmFtZSkgZXhwcmVzc2lvbi5wdXNoKGwxMG5bZXhwclZhci5zdWJzdHIoY29sb25Qb3MgKyAxKV0pOyBlbHNlIGV4cHJlc3Npb24ucHVzaCgnX19sMTBuWyInICsgbDEwblBhdGggKyAnIl0nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZXhwcmVzc2lvbi5sZW5ndGggPT0gMSkgZXhwcmVzc2lvbi5wdXNoKCciIicpOwogICAgICAgIHJldHVybiBleHByZXNzaW9uLmpvaW4oIisiKTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oYmluZGluZ3MpIHsKICAgICAgICBmdW5jdGlvbiBwdXRCaW5kQ29kZSh0eXBlKSB7CiAgICAgICAgICB0b29sc1VzZWRbdHlwZV0gPSB0cnVlOwogICAgICAgICAgYmluZENvZGUucHVzaChiaW5kVmFyICsgIj0iICsgdHlwZSArICIoIiArIGJhc2lzLmFycmF5KGFyZ3VtZW50cywgMSkgKyAiKTsiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGJpbmRNYXAgPSB7fTsKICAgICAgICB2YXIgYmluZENvZGU7CiAgICAgICAgdmFyIGJpbmRWYXI7CiAgICAgICAgdmFyIHZhckxpc3QgPSBbXTsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIHZhck5hbWU7CiAgICAgICAgdmFyIGwxMG5NYXA7CiAgICAgICAgdmFyIGwxMG5Db21wdXRlID0gW107CiAgICAgICAgdmFyIGwxMG5CaW5kaW5ncyA9IHt9OwogICAgICAgIHZhciBsMTBuQmluZFNlZWQgPSAxOwogICAgICAgIHZhciBzcGVjaWFsQXR0cjsKICAgICAgICB2YXIgYXR0ckV4cHJJZDsKICAgICAgICB2YXIgYXR0ckV4cHJNYXAgPSB7fTsKICAgICAgICB2YXIgZGVidWdMaXN0ID0gW107CiAgICAgICAgdmFyIHRvb2xzVXNlZCA9IHsKICAgICAgICAgIHJlc29sdmU6IHRydWUKICAgICAgICB9OwogICAgICAgIGZvciAodmFyIGkgPSAwLCBiaW5kaW5nOyBiaW5kaW5nID0gYmluZGluZ3NbaV07IGkrKykgewogICAgICAgICAgdmFyIGJpbmRUeXBlID0gYmluZGluZ1swXTsKICAgICAgICAgIHZhciBkb21SZWYgPSBiaW5kaW5nWzFdOwogICAgICAgICAgdmFyIGJpbmROYW1lID0gYmluZGluZ1syXTsKICAgICAgICAgIGlmIChbICJnZXQiLCAic2V0IiwgInRlbXBsYXRlSWRfIiBdLmluZGV4T2YoYmluZE5hbWUpICE9IC0xKSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiaW5kaW5nIG5hbWUgYCIgKyBiaW5kTmFtZSArICJgIGlzIHByb2hpYml0ZWQsIGJpbmRpbmcgaWdub3JlZCIpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lUGFydCA9IGJpbmROYW1lLnNwbGl0KCI6Iik7CiAgICAgICAgICB2YXIgYW5pbSA9IG5hbWVQYXJ0WzBdID09ICJhbmltIjsKICAgICAgICAgIGlmIChhbmltKSBiaW5kTmFtZSA9IG5hbWVQYXJ0WzFdOwogICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2JpbmROYW1lXTsKICAgICAgICAgIGJpbmRWYXIgPSAiXyIgKyBpOwogICAgICAgICAgdmFyTmFtZSA9ICJfXyIgKyBiaW5kTmFtZTsKICAgICAgICAgIGlmIChuYW1lUGFydFswXSA9PSAibDEwbiIgJiYgbmFtZVBhcnRbMV0pIHsKICAgICAgICAgICAgdmFyIGwxMG5GdWxsUGF0aCA9IG5hbWVQYXJ0WzFdOwogICAgICAgICAgICB2YXIgbDEwbkJpbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgbDEwbk5hbWUgPSBsMTBuRnVsbFBhdGgucmVwbGFjZShMMTBOX0JJTkRJTkcsIGZ1bmN0aW9uKG0sIG5hbWUpIHsKICAgICAgICAgICAgICBsMTBuQmluZGluZyA9IG5hbWU7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKGwxMG5CaW5kaW5nKSB7CiAgICAgICAgICAgICAgaWYgKGwxMG5GdWxsUGF0aCBpbiBsMTBuQmluZGluZ3MgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHZhck5hbWUgPSAiJGwxMG5fIiArIGwxMG5CaW5kU2VlZCsrOwogICAgICAgICAgICAgICAgbDEwbkJpbmRpbmdzW2wxMG5GdWxsUGF0aF0gPSB2YXJOYW1lOwogICAgICAgICAgICAgICAgbDEwbkNvbXB1dGUucHVzaCgnc2V0KCInICsgdmFyTmFtZSArICciLCcgKyB2YXJOYW1lICsgIikiKTsKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaCh2YXJOYW1lICsgJz10b29scy5sMTBuVG9rZW4oIicgKyBsMTBuTmFtZSArICciKS5jb21wdXRlVG9rZW4oKScpOwogICAgICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2wxMG5CaW5kaW5nXTsKICAgICAgICAgICAgICAgIGlmICghYmluZENvZGUpIHsKICAgICAgICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2wxMG5CaW5kaW5nXSA9IFtdOwogICAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goIl9fIiArIGwxMG5CaW5kaW5nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJpbmRDb2RlLnB1c2godmFyTmFtZSArICIuc2V0KF9fIiArIGwxMG5CaW5kaW5nICsgIik7Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJpbmROYW1lID0gbDEwbkJpbmRpbmdzW2wxMG5GdWxsUGF0aF07CiAgICAgICAgICAgICAgYmluZFZhciA9ICJfIiArIGk7CiAgICAgICAgICAgICAgdmFyTmFtZSA9ICJfXyIgKyBiaW5kTmFtZTsKICAgICAgICAgICAgICBiaW5kQ29kZSA9IGJpbmRNYXBbYmluZE5hbWVdOwogICAgICAgICAgICAgIGlmICghYmluZENvZGUpIHsKICAgICAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtiaW5kTmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaCh2YXJOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGJpbmRUeXBlID09IFRZUEVfVEVYVCkgewogICAgICAgICAgICAgICAgZGVidWdMaXN0LnB1c2goInsiICsgWyAnYmluZGluZzoiJyArIGJpbmROYW1lICsgJyInLCAiZG9tOiIgKyBkb21SZWYsICJ2YWw6IiArIGJpbmRWYXIsICdhdHRhY2htZW50Omluc3RhbmNlLmF0dGFjaGVzJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdLnZhbHVlJyBdICsgIn0iKTsKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgIj0iICsgZG9tUmVmKTsKICAgICAgICAgICAgICAgIHB1dEJpbmRDb2RlKGJpbmRGdW5jdGlvbnNbYmluZFR5cGVdLCBkb21SZWYsIGJpbmRWYXIsICJ2YWx1ZSIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhdHRyTmFtZSA9ICciJyArIGJpbmRpbmdbQVRUUl9OQU1FXSArICciJzsKICAgICAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBsMTBuRnVsbFBhdGggKyAnIicsICJkb206IiArIGRvbVJlZiwgImF0dHI6IiArIGF0dHJOYW1lLCAidmFsOiIgKyBiaW5kVmFyLCAnYXR0YWNobWVudDppbnN0YW5jZS5hdHRhY2hlcyYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXSYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXS52YWx1ZScgXSArICJ9Iik7CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhcik7CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZSgiYmluZF9hdHRyIiwgZG9tUmVmLCBhdHRyTmFtZSwgYmluZFZhciwgYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCBmYWxzZSwgbDEwbkJpbmRpbmdzKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghbDEwbk1hcCkgbDEwbk1hcCA9IHt9OwogICAgICAgICAgICBpZiAoIWJpbmRNYXBbbDEwbk5hbWVdKSB7CiAgICAgICAgICAgICAgYmluZE1hcFtsMTBuTmFtZV0gPSBbXTsKICAgICAgICAgICAgICBsMTBuTWFwW2wxMG5OYW1lXSA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtsMTBuTmFtZV07CiAgICAgICAgICAgIGJpbmRDb2RlLmwxMG4gPSB0cnVlOwogICAgICAgICAgICBpZiAoYmluZFR5cGUgPT0gVFlQRV9URVhUKSB7CiAgICAgICAgICAgICAgZGVidWdMaXN0LnB1c2goInsiICsgWyAnYmluZGluZzoiJyArIGwxMG5GdWxsUGF0aCArICciJywgImRvbToiICsgZG9tUmVmLCAndmFsOl9fbDEwblsiJyArIGwxMG5OYW1lICsgJyJdJywgJ2F0dGFjaG1lbnQ6bDEwblRva2VuKCInICsgbDEwbk5hbWUgKyAnIiknIF0gKyAifSIpOwogICAgICAgICAgICAgIHRvb2xzVXNlZC5sMTBuVG9rZW4gPSB0cnVlOwogICAgICAgICAgICAgIGwxMG5NYXBbbDEwbk5hbWVdLnB1c2goZG9tUmVmICsgIi5ub2RlVmFsdWU9dmFsdWU7Iik7CiAgICAgICAgICAgICAgYmluZENvZGUucHVzaChkb21SZWYgKyAnLm5vZGVWYWx1ZT1fX2wxMG5bIicgKyBsMTBuTmFtZSArICciXScgKyAobDEwbkJpbmRpbmcgPyAiW19fIiArIGwxMG5CaW5kaW5nICsgIl0iIDogIiIpICsgIjsiKTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsMTBuTWFwW2wxMG5OYW1lXS5wdXNoKCJiaW5kX2F0dHIoIiArIFsgZG9tUmVmLCAnIicgKyBiaW5kaW5nW0FUVFJfTkFNRV0gKyAnIicsICJOYU4iLCBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsICJsMTBuIiwgbDEwbkJpbmRpbmdzKSBdICsgIik7Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghYmluZENvZGUpIHsKICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2JpbmROYW1lXSA9IFtdOwogICAgICAgICAgICB2YXJMaXN0LnB1c2godmFyTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYmluZFR5cGUgIT0gVFlQRV9BVFRSSUJVVEUpIHsKICAgICAgICAgICAgZGVidWdMaXN0LnB1c2goInsiICsgWyAnYmluZGluZzoiJyArIGJpbmROYW1lICsgJyInLCAiZG9tOiIgKyBkb21SZWYsICJ2YWw6IiArIChiaW5kQ29kZS5ub2RlQmluZCA/IHZhck5hbWUgOiBiaW5kVmFyKSwgInVwZGF0ZXM6JCQiICsgYmluZE5hbWUsICdhdHRhY2htZW50Omluc3RhbmNlLmF0dGFjaGVzJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdLnZhbHVlJyBdICsgIn0iKTsKICAgICAgICAgICAgaWYgKCFiaW5kQ29kZS5ub2RlQmluZCkgewogICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgIj0iICsgZG9tUmVmKTsKICAgICAgICAgICAgICBwdXRCaW5kQ29kZShiaW5kRnVuY3Rpb25zW2JpbmRUeXBlXSwgZG9tUmVmLCBiaW5kVmFyLCAidmFsdWUiKTsKICAgICAgICAgICAgICBiaW5kQ29kZS5ub2RlQmluZCA9IGJpbmRWYXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3dpdGNoIChiaW5kVHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSBUWVBFX0VMRU1FTlQ6CiAgICAgICAgICAgICAgICAgIHB1dEJpbmRDb2RlKGJpbmRGdW5jdGlvbnNbYmluZFR5cGVdLCBkb21SZWYsIGRvbVJlZiwgInZhbHVlIT09bnVsbD9TdHJpbmcodmFsdWUpOm51bGwiKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFRZUEVfVEVYVDoKICAgICAgICAgICAgICAgICAgYmluZENvZGUucHVzaChkb21SZWYgKyAiLm5vZGVWYWx1ZT12YWx1ZTsiKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSBiaW5kaW5nW0FUVFJfTkFNRV07CiAgICAgICAgICAgIHN3aXRjaCAoYXR0ck5hbWUpIHsKICAgICAgICAgICAgICBjYXNlICJjbGFzcyI6CiAgICAgICAgICAgICAgICB2YXIgZGVmYXVsdEV4cHIgPSAiIjsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZUV4cHIgPSAidmFsdWUiOwogICAgICAgICAgICAgICAgdmFyIHByZWZpeCA9IGJpbmRpbmdbNF07CiAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0xlbmd0aCA9IGJpbmRpbmcubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPj0gNikgewogICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ0xlbmd0aCA9PSA2IHx8IHR5cGVvZiBiaW5kaW5nWzZdID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPT0gNikgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gJ3ZhbHVlPyInICsgYmluZE5hbWUgKyAnIjoiIic7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ1s1XSkgZGVmYXVsdEV4cHIgPSBwcmVmaXggKyBiaW5kTmFtZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcHJlZml4ID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZUV4cHIgPSAndmFsdWU/IicgKyBiaW5kaW5nWzZdICsgJyI6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gYmluZGluZ1s2XTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFiaW5kaW5nWzZdLmxlbmd0aCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPT0gNykgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gYmluZGluZ1s2XS5tYXAoZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAndmFsdWU9PSInICsgdmFsICsgJyInOwogICAgICAgICAgICAgICAgICAgICAgfSkuam9pbigifHwiKSArICc/dmFsdWU6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gcHJlZml4ICsgYmluZGluZ1s2XVtiaW5kaW5nWzVdIC0gMV07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHByZWZpeCA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gYmluZGluZ1s2XS5tYXAoZnVuY3Rpb24odmFsLCBpZHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd2YWx1ZT09IicgKyB2YWwgKyAnIj8iJyArIHRoaXNbaWR4XSArICciJzsKICAgICAgICAgICAgICAgICAgICAgIH0sIGJpbmRpbmdbN10pLmpvaW4oIjoiKSArICc6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gYmluZGluZ1s3XVtiaW5kaW5nWzVdIC0gMV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWx1ZUV4cHIgPSAndHlwZW9mIHZhbHVlPT0ic3RyaW5nInx8dHlwZW9mIHZhbHVlPT0ibnVtYmVyIj92YWx1ZToodmFsdWU/IicgKyBiaW5kTmFtZSArICciOiIiKSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhciArICc9IicgKyBkZWZhdWx0RXhwciArICciJyk7CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZSgiYmluZF9hdHRyQ2xhc3MiLCBkb21SZWYsIGJpbmRWYXIsIHZhbHVlRXhwciwgJyInICsgcHJlZml4ICsgJyInLCBhbmltKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICAgIHZhciBleHByID0gYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCBmYWxzZSwgbDEwbkJpbmRpbmdzKTsKICAgICAgICAgICAgICAgIGF0dHJFeHBySWQgPSBiaW5kaW5nWzhdOwogICAgICAgICAgICAgICAgaWYgKCFhdHRyRXhwck1hcFthdHRyRXhwcklkXSkgewogICAgICAgICAgICAgICAgICBhdHRyRXhwck1hcFthdHRyRXhwcklkXSA9IGJpbmRWYXI7CiAgICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgIj0iICsgKGJpbmRpbmdbN10gPT0gImhpZGUiID8gJyIiJyA6ICcibm9uZSInKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYmluZGluZ1s3XSkgZXhwciA9IGV4cHIucmVwbGFjZSgvXCsiIiQvLCAiIikgKyAoYmluZGluZ1s3XSA9PSAiaGlkZSIgPyAnPyJub25lIjoiIicgOiAnPyIiOiJub25lIicpOwogICAgICAgICAgICAgICAgYmluZFZhciA9IGF0dHJFeHByTWFwW2F0dHJFeHBySWRdOwogICAgICAgICAgICAgICAgcHV0QmluZENvZGUoImJpbmRfYXR0clN0eWxlIiwgZG9tUmVmLCAnIicgKyBiaW5kaW5nWzZdICsgJyInLCBiaW5kVmFyLCBleHByKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBzcGVjaWFsQXR0ciA9IFNQRUNJQUxfQVRUUl9NQVBbYXR0ck5hbWVdOwogICAgICAgICAgICAgICAgYXR0ckV4cHJJZCA9IGJpbmRpbmdbN107CiAgICAgICAgICAgICAgICBpZiAoIWF0dHJFeHByTWFwW2F0dHJFeHBySWRdKSB7CiAgICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgIj0iICsgYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCAibDEwbiIsIGwxMG5CaW5kaW5ncykpOwogICAgICAgICAgICAgICAgICBhdHRyRXhwck1hcFthdHRyRXhwcklkXSA9IGJpbmRWYXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBiaW5kVmFyID0gYXR0ckV4cHJNYXBbYXR0ckV4cHJJZF07CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZSgiYmluZF9hdHRyIiwgZG9tUmVmLCAnIicgKyBhdHRyTmFtZSArICciJywgYmluZFZhciwgc3BlY2lhbEF0dHIgJiYgU1BFQ0lBTF9BVFRSX1NJTkdMRVthdHRyTmFtZV0gPyBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsICJib29sIiwgbDEwbkJpbmRpbmdzKSArICc/IicgKyBhdHRyTmFtZSArICciOiIiJyA6IGJ1aWxkQXR0ckV4cHJlc3Npb24oYmluZGluZywgZmFsc2UsIGwxMG5CaW5kaW5ncykpOwogICAgICAgICAgICAgICAgaWYgKHNwZWNpYWxBdHRyICYmIChzcGVjaWFsQXR0ciA9PSAiKiIgfHwgc3BlY2lhbEF0dHIuaW5kZXhPZihiaW5kaW5nWzZdLnRvTG93ZXJDYXNlKCkpICE9IC0xKSkgYmluZENvZGUucHVzaCgiaWYoIiArIGRvbVJlZiArICIuIiArIGF0dHJOYW1lICsgIiE9IiArIGJpbmRWYXIgKyAiKSIgKyBkb21SZWYgKyAiLiIgKyBhdHRyTmFtZSArICI9IiArIChTUEVDSUFMX0FUVFJfU0lOR0xFW2F0dHJOYW1lXSA/ICIhISIgKyBiaW5kVmFyIDogYmluZFZhcikgKyAiOyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBiaW5kTmFtZSArICciJywgImRvbToiICsgZG9tUmVmLCAnYXR0cjoiJyArIGF0dHJOYW1lICsgJyInLCAidmFsOiIgKyBiaW5kVmFyLCAnYXR0YWNobWVudDppbnN0YW5jZS5hdHRhY2hlcyYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXSYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXS52YWx1ZScgXSArICJ9Iik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wdXNoKCI7ZnVuY3Rpb24gc2V0KGJpbmROYW1lLHZhbHVlKXsiICsgJ2lmKHR5cGVvZiBiaW5kTmFtZSE9InN0cmluZyIpJyk7CiAgICAgICAgZm9yICh2YXIgYmluZE5hbWUgaW4gYmluZE1hcCkgaWYgKGJpbmRNYXBbYmluZE5hbWVdLm5vZGVCaW5kKSB7CiAgICAgICAgICByZXN1bHQucHVzaCgiaWYoYmluZE5hbWU9PT0iICsgYmluZE1hcFtiaW5kTmFtZV0ubm9kZUJpbmQgKyAiKSIgKyAnYmluZE5hbWU9IicgKyBiaW5kTmFtZSArICciOycgKyAiZWxzZSAiKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnB1c2goInJldHVybjsiKTsKICAgICAgICByZXN1bHQucHVzaCgidmFsdWU9cmVzb2x2ZS5jYWxsKGluc3RhbmNlLGJpbmROYW1lLHZhbHVlLEF0dGFjaGVzKTsiICsgInN3aXRjaChiaW5kTmFtZSl7Iik7CiAgICAgICAgZm9yICh2YXIgYmluZE5hbWUgaW4gYmluZE1hcCkgewogICAgICAgICAgaWYgKGJpbmROYW1lLmluZGV4T2YoIkAiKSA9PSAtMSkgdmFyTGlzdC5wdXNoKCIkJCIgKyBiaW5kTmFtZSArICI9MCIpOwogICAgICAgICAgcmVzdWx0LnB1c2goJ2Nhc2UiJyArIGJpbmROYW1lICsgJyI6JyArIChiaW5kTWFwW2JpbmROYW1lXS5sMTBuID8gYmluZE1hcFtiaW5kTmFtZV0uam9pbigiIikgOiAiaWYoX18iICsgYmluZE5hbWUgKyAiIT09dmFsdWUpIiArICJ7IiArICIkJCIgKyBiaW5kTmFtZSArICIrKzsiICsgIl9fIiArIGJpbmROYW1lICsgIj12YWx1ZTsiICsgYmluZE1hcFtiaW5kTmFtZV0uam9pbigiIikgKyAifSIpICsgImJyZWFrOyIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucHVzaCgifX0iKTsKICAgICAgICB2YXIgdG9vbHNWYXJMaXN0ID0gW107CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRvb2xzVXNlZCkgdG9vbHNWYXJMaXN0LnB1c2goa2V5ICsgIj10b29scy4iICsga2V5KTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZGVidWdMaXN0OiBkZWJ1Z0xpc3QsCiAgICAgICAgICBrZXlzOiBiYXNpcy5vYmplY3Qua2V5cyhiaW5kTWFwKS5maWx0ZXIoZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBrZXkuaW5kZXhPZigiQCIpID09IC0xOwogICAgICAgICAgfSksCiAgICAgICAgICB0b29sczogdG9vbHNWYXJMaXN0LAogICAgICAgICAgdmFyczogdmFyTGlzdCwKICAgICAgICAgIHNldDogcmVzdWx0LmpvaW4oIiIpLAogICAgICAgICAgbDEwbjogbDEwbk1hcCwKICAgICAgICAgIGwxMG5Db21wdXRlOiBsMTBuQ29tcHV0ZQogICAgICAgIH07CiAgICAgIH07CiAgICB9KCk7CiAgICBmdW5jdGlvbiBjb21waWxlRnVuY3Rpb24oYXJncywgYm9keSkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oYXJncywgYm9keSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBiYXNpcy5kZXYuZXJyb3IoIkNhbid0IGJ1aWxkIHRlbXBsYXRlIGZ1bmN0aW9uOiAiICsgZSArICJcbiIsICJmdW5jdGlvbigiICsgYXJncyArICIpe1xuIiArIGJvZHkgKyAiXG59Iik7CiAgICAgIH0KICAgIH0KICAgIHZhciBnZXRGdW5jdGlvbnMgPSBmdW5jdGlvbih0b2tlbnMsIGRlYnVnLCB1cmksIHNvdXJjZSwgbm9UZXh0QnVnLCB0ZW1wbGF0ZU1hcmtlcikgewogICAgICB2YXIgZm4gPSB0bXBsRnVuY3Rpb25zW3VyaSAmJiBiYXNpcy5wYXRoLnJlbGF0aXZlKHVyaSldOwogICAgICBpZiAoZm4pIHJldHVybiBmbjsKICAgICAgdmFyIHBhdGhzID0gYnVpbGRQYXRoZXModG9rZW5zLCAiXyIsIG5vVGV4dEJ1ZywgdGVtcGxhdGVNYXJrZXIpOwogICAgICB2YXIgYmluZGluZ3MgPSBidWlsZEJpbmRpbmdzKHBhdGhzLmJpbmRpbmcpOwogICAgICB2YXIgb2JqZWN0UmVmcyA9IHBhdGhzLm1hcmtlZEVsZW1lbnRMaXN0LmpvaW4oIj0iKTsKICAgICAgdmFyIGNyZWF0ZUluc3RhbmNlOwogICAgICB2YXIgZm5Cb2R5OwogICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgIGtleXM6IGJpbmRpbmdzLmtleXMsCiAgICAgICAgbDEwbktleXM6IGJhc2lzLm9iamVjdC5rZXlzKGJpbmRpbmdzLmwxMG4pCiAgICAgIH07CiAgICAgIGlmICh0b2tlbnMubGVuZ3RoID09IDEpIHBhdGhzLnBhdGhbMF0gPSAiYT1fIjsKICAgICAgaWYgKCF1cmkpIHVyaSA9IGJhc2lzLnBhdGguYmFzZVVSSSArICJpbmxpbmVfdGVtcGxhdGUiICsgaW5saW5lU2VlZCsrICsgIi50bXBsIjsKICAgICAgaWYgKGJpbmRpbmdzLmwxMG4pIHsKICAgICAgICB2YXIgY29kZSA9IFtdOwogICAgICAgIGZvciAodmFyIGtleSBpbiBiaW5kaW5ncy5sMTBuKSBjb2RlLnB1c2goJ2Nhc2UiJyArIGtleSArICciOicgKyAnaWYodmFsdWU9PW51bGwpdmFsdWU9InsnICsga2V5ICsgJ30iOycgKyAiX19sMTBuW3Rva2VuXT12YWx1ZTsiICsgYmluZGluZ3MubDEwbltrZXldLmpvaW4oIiIpICsgImJyZWFrOyIpOwogICAgICAgIHJlc3VsdC5jcmVhdGVMMTBuU3luYyA9IGNvbXBpbGVGdW5jdGlvbihbICJfIiwgIl9fbDEwbiIsICJiaW5kX2F0dHIiLCAiVEVYVF9CVUciIF0sIChzb3VyY2UgPyAiXG4vLyAiICsgc291cmNlLnNwbGl0KC9cclxuP3xcblxyPy8pLmpvaW4oIlxuLy8gIikgKyAiXG5cbiIgOiAiIikgKyAidmFyICIgKyBwYXRocy5wYXRoICsgIjsiICsgInJldHVybiBmdW5jdGlvbih0b2tlbiwgdmFsdWUpeyIgKyAic3dpdGNoKHRva2VuKXsiICsgY29kZS5qb2luKCIiKSArICJ9IiArICJ9IiArICJcblxuLy8jIHNvdXJjZVVSTD0iICsgYmFzaXMucGF0aC5vcmlnaW4gKyB1cmkgKyAiX2wxMG4iKTsKICAgICAgfQogICAgICByZXN1bHQuY3JlYXRlSW5zdGFuY2UgPSBjb21waWxlRnVuY3Rpb24oWyAidGlkIiwgIm1hcCIsICJwcm90byIsICJ0b29scyIsICJfX2wxMG4iLCAiVEVYVF9CVUciIF0sIChzb3VyY2UgPyAiXG4vLyAiICsgc291cmNlLnNwbGl0KC9cclxuP3xcblxyPy8pLmpvaW4oIlxuLy8gIikgKyAiXG5cbiIgOiAiIikgKyAidmFyIGdldEJpbmRpbmdzPXRvb2xzLmNyZWF0ZUJpbmRpbmdGdW5jdGlvbihbIiArIGJpbmRpbmdzLmtleXMubWFwKGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiAnIicgKyBrZXkgKyAnIic7CiAgICAgIH0pICsgIl0pLCIgKyAoYmluZGluZ3MudG9vbHMubGVuZ3RoID8gYmluZGluZ3MudG9vbHMgKyAiLCIgOiAiIikgKyAiQXR0YWNoZXM9ZnVuY3Rpb24oKXt9OyIgKyAiQXR0YWNoZXMucHJvdG90eXBlPXsiICsgYmluZGluZ3Mua2V5cy5tYXAoZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIGtleSArICI6bnVsbCI7CiAgICAgIH0pICsgIn07IiArICJyZXR1cm4gZnVuY3Rpb24gY3JlYXRlSW5zdGFuY2VfKGlkLG9iaixvbkFjdGlvbixvblJlYnVpbGQsYmluZGluZ3MsYmluZGluZ0ludGVyZmFjZSl7IiArICJ2YXIgXz1wcm90by5jbG9uZU5vZGUodHJ1ZSksIiArIHBhdGhzLnBhdGguY29uY2F0KGJpbmRpbmdzLnZhcnMpICsgIiwiICsgImluc3RhbmNlPXsiICsgImNvbnRleHQ6b2JqLCIgKyAiYWN0aW9uOm9uQWN0aW9uLCIgKyAicmVidWlsZDpvblJlYnVpbGQsIiArIChkZWJ1ZyA/ICJkZWJ1ZzpmdW5jdGlvbiBkZWJ1Zygpe3JldHVyblsiICsgYmluZGluZ3MuZGVidWdMaXN0ICsgIl19LCIgOiAiIikgKyAiaGFuZGxlcjpudWxsLCIgKyAiYmluZGluZ3M6YmluZGluZ3MsIiArICJiaW5kaW5nSW50ZXJmYWNlOmJpbmRpbmdJbnRlcmZhY2UsIiArICJhdHRhY2hlczpudWxsLCIgKyAidG1wbDp7IiArIFsgcGF0aHMucmVmLCAidGVtcGxhdGVJZF86aWQiLCAic2V0OnNldCIgXSArICJ9IiArICJ9IiArIChvYmplY3RSZWZzID8gIjtpZihvYmp8fG9uQWN0aW9uKSIgKyBvYmplY3RSZWZzICsgIj0oaWQ8PDEyKXx0aWQiIDogIiIpICsgYmluZGluZ3Muc2V0ICsgIjtpZihiaW5kaW5ncylpbnN0YW5jZS5oYW5kbGVyPWdldEJpbmRpbmdzKGJpbmRpbmdzLG9iaixzZXQsYmluZGluZ0ludGVyZmFjZSkiICsgIjsiICsgYmluZGluZ3MubDEwbkNvbXB1dGUgKyAiO3JldHVybiBpbnN0YW5jZSIgKyAifSIgKyAiXG5cbi8vIyBzb3VyY2VVUkw9IiArIGJhc2lzLnBhdGgub3JpZ2luICsgdXJpKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZ2V0RnVuY3Rpb25zOiBnZXRGdW5jdGlvbnMKICAgIH07CiAgfSwKICAiYS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzguanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vYi5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi9jLmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogICAgdmFyIGNsZWFuZXIgPSBiYXNpcy5jbGVhbmVyOwogICAgdmFyIEV2ZW50ID0gYmFzaXMuZG9tLmV2ZW50OwogICAgdmFyIGFkZEdsb2JhbEhhbmRsZXIgPSBFdmVudC5hZGRHbG9iYWxIYW5kbGVyOwogICAgdmFyIHJlbW92ZUdsb2JhbEhhbmRsZXIgPSBFdmVudC5yZW1vdmVHbG9iYWxIYW5kbGVyOwogICAgdmFyIEVtaXR0ZXIgPSBiYXNpcy5ldmVudC5FbWl0dGVyOwogICAgdmFyIGNyZWF0ZUV2ZW50ID0gYmFzaXMuZXZlbnQuY3JlYXRlOwogICAgdmFyIGdldENvbXB1dGVkU3R5bGUgPSBiYXNpcy5kb20uY29tcHV0ZWRTdHlsZS5nZXQ7CiAgICB2YXIgZ2V0T2Zmc2V0UGFyZW50ID0gYmFzaXMubGF5b3V0LmdldE9mZnNldFBhcmVudDsKICAgIHZhciBnZXRCb3VuZGluZ1JlY3QgPSBiYXNpcy5sYXlvdXQuZ2V0Qm91bmRpbmdSZWN0OwogICAgdmFyIGdldFZpZXdwb3J0UmVjdCA9IGJhc2lzLmxheW91dC5nZXRWaWV3cG9ydFJlY3Q7CiAgICB2YXIgU0VMRUNUU1RBUlRfU1VQUE9SVEVEID0gRXZlbnQuZ2V0RXZlbnRJbmZvKCJzZWxlY3RzdGFydCIpLnN1cHBvcnRlZDsKICAgIHZhciBkcmFnZ2luZzsKICAgIHZhciBkcmFnRWxlbWVudDsKICAgIHZhciBkcmFnRGF0YTsKICAgIGZ1bmN0aW9uIHJlc29sdmVFbGVtZW50KHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh2YWx1ZSkgOiB2YWx1ZTsKICAgIH0KICAgIGZ1bmN0aW9uIHN0YXJ0RHJhZyhldmVudCkgewogICAgICBpZiAoZHJhZ0VsZW1lbnQgfHwgdGhpcy5pZ25vcmVUYXJnZXQoZXZlbnQuc2VuZGVyLCBldmVudCkpIHJldHVybjsKICAgICAgdmFyIHZpZXdwb3J0ID0gZ2V0Vmlld3BvcnRSZWN0KGV2ZW50LnNlbmRlcik7CiAgICAgIGlmIChldmVudC5tb3VzZVggPCB2aWV3cG9ydC5sZWZ0IHx8IGV2ZW50Lm1vdXNlWCA+IHZpZXdwb3J0LnJpZ2h0IHx8IGV2ZW50Lm1vdXNlWSA8IHZpZXdwb3J0LnRvcCB8fCBldmVudC5tb3VzZVkgPiB2aWV3cG9ydC5ib3R0b20pIHJldHVybjsKICAgICAgZHJhZ0VsZW1lbnQgPSB0aGlzOwogICAgICBkcmFnRGF0YSA9IHsKICAgICAgICBpbml0WDogZXZlbnQubW91c2VYLAogICAgICAgIGluaXRZOiBldmVudC5tb3VzZVksCiAgICAgICAgZGVsdGFYOiAwLAogICAgICAgIG1pbkRlbHRhWDogLUluZmluaXR5LAogICAgICAgIG1heERlbHRhWDogSW5maW5pdHksCiAgICAgICAgZGVsdGFZOiAwLAogICAgICAgIG1pbkRlbHRhWTogLUluZmluaXR5LAogICAgICAgIG1heERlbHRhWTogSW5maW5pdHkKICAgICAgfTsKICAgICAgYWRkR2xvYmFsSGFuZGxlcigibW91c2Vtb3ZlIiwgb25EcmFnKTsKICAgICAgYWRkR2xvYmFsSGFuZGxlcigibW91c2V1cCIsIHN0b3BEcmFnKTsKICAgICAgYWRkR2xvYmFsSGFuZGxlcigibW91c2Vkb3duIiwgc3RvcERyYWcpOwogICAgICBpZiAoU0VMRUNUU1RBUlRfU1VQUE9SVEVEKSBhZGRHbG9iYWxIYW5kbGVyKCJzZWxlY3RzdGFydCIsIEV2ZW50LmtpbGwpOwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB0aGlzLnByZXBhcmVEcmFnKGRyYWdEYXRhLCBldmVudCk7CiAgICB9CiAgICBmdW5jdGlvbiBvbkRyYWcoZXZlbnQpIHsKICAgICAgdmFyIGRlbHRhWCA9IGV2ZW50Lm1vdXNlWCAtIGRyYWdEYXRhLmluaXRYOwogICAgICB2YXIgZGVsdGFZID0gZXZlbnQubW91c2VZIC0gZHJhZ0RhdGEuaW5pdFk7CiAgICAgIGlmICghZHJhZ2dpbmcpIHsKICAgICAgICBpZiAoIWRyYWdFbGVtZW50LnN0YXJ0UnVsZShkZWx0YVgsIGRlbHRhWSkpIHJldHVybjsKICAgICAgICBkcmFnZ2luZyA9IHRydWU7CiAgICAgICAgZHJhZ0VsZW1lbnQuZW1pdF9zdGFydChkcmFnRGF0YSwgZXZlbnQpOwogICAgICB9CiAgICAgIGlmIChkcmFnRWxlbWVudC5heGlzWCkgZHJhZ0RhdGEuZGVsdGFYID0gZHJhZ0VsZW1lbnQuYXhpc1hwcm94eShiYXNpcy5udW1iZXIuZml0KGRlbHRhWCwgZHJhZ0RhdGEubWluRGVsdGFYLCBkcmFnRGF0YS5tYXhEZWx0YVgpKTsKICAgICAgaWYgKGRyYWdFbGVtZW50LmF4aXNZKSBkcmFnRGF0YS5kZWx0YVkgPSBkcmFnRWxlbWVudC5heGlzWXByb3h5KGJhc2lzLm51bWJlci5maXQoZGVsdGFZLCBkcmFnRGF0YS5taW5EZWx0YVksIGRyYWdEYXRhLm1heERlbHRhWSkpOwogICAgICBkcmFnRWxlbWVudC5lbWl0X2RyYWcoZHJhZ0RhdGEsIGV2ZW50KTsKICAgIH0KICAgIGZ1bmN0aW9uIHN0b3BEcmFnKGV2ZW50KSB7CiAgICAgIHJlbW92ZUdsb2JhbEhhbmRsZXIoIm1vdXNlbW92ZSIsIG9uRHJhZyk7CiAgICAgIHJlbW92ZUdsb2JhbEhhbmRsZXIoIm1vdXNldXAiLCBzdG9wRHJhZyk7CiAgICAgIHJlbW92ZUdsb2JhbEhhbmRsZXIoIm1vdXNlZG93biIsIHN0b3BEcmFnKTsKICAgICAgaWYgKFNFTEVDVFNUQVJUX1NVUFBPUlRFRCkgcmVtb3ZlR2xvYmFsSGFuZGxlcigic2VsZWN0c3RhcnQiLCBFdmVudC5raWxsKTsKICAgICAgdmFyIGVsZW1lbnQgPSBkcmFnRWxlbWVudDsKICAgICAgdmFyIGRhdGEgPSBkcmFnRGF0YTsKICAgICAgZHJhZ0VsZW1lbnQgPSBudWxsOwogICAgICBkcmFnRGF0YSA9IG51bGw7CiAgICAgIGlmIChkcmFnZ2luZykgewogICAgICAgIGRyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgZWxlbWVudC5lbWl0X292ZXIoZGF0YSwgZXZlbnQpOwogICAgICB9CiAgICAgIGV2ZW50LmRpZSgpOwogICAgfQogICAgdmFyIERyYWdEcm9wRWxlbWVudCA9IEVtaXR0ZXIuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRHJhZ0Ryb3BFbGVtZW50IiwKICAgICAgZWxlbWVudDogbnVsbCwKICAgICAgdHJpZ2dlcjogbnVsbCwKICAgICAgYmFzZUVsZW1lbnQ6IG51bGwsCiAgICAgIGF4aXNYOiB0cnVlLAogICAgICBheGlzWTogdHJ1ZSwKICAgICAgYXhpc1hwcm94eTogYmFzaXMuZm4uJHNlbGYsCiAgICAgIGF4aXNZcHJveHk6IGJhc2lzLmZuLiRzZWxmLAogICAgICBwcmVwYXJlRHJhZzogYmFzaXMuZm4uJHVuZGVmLAogICAgICBzdGFydFJ1bGU6IGJhc2lzLmZuLiR0cnVlLAogICAgICBpZ25vcmVUYXJnZXQ6IGZ1bmN0aW9uKHRhcmdldCwgZXZlbnQpIHsKICAgICAgICByZXR1cm4gL14oSU5QVVR8VEVYVEFSRUF8U0VMRUNUfEJVVFRPTikkLy50ZXN0KHRhcmdldC50YWdOYW1lKTsKICAgICAgfSwKICAgICAgZW1pdF9zdGFydDogY3JlYXRlRXZlbnQoInN0YXJ0IiksCiAgICAgIGVtaXRfZHJhZzogY3JlYXRlRXZlbnQoImRyYWciKSwKICAgICAgZW1pdF9vdmVyOiBjcmVhdGVFdmVudCgib3ZlciIpLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CiAgICAgICAgdmFyIHRyaWdnZXIgPSB0aGlzLnRyaWdnZXI7CiAgICAgICAgdGhpcy5lbGVtZW50ID0gbnVsbDsKICAgICAgICB0aGlzLnRyaWdnZXIgPSBudWxsOwogICAgICAgIHRoaXMuc2V0RWxlbWVudChlbGVtZW50LCB0cmlnZ2VyKTsKICAgICAgICB0aGlzLnNldEJhc2UodGhpcy5iYXNlRWxlbWVudCk7CiAgICAgICAgY2xlYW5lci5hZGQodGhpcyk7CiAgICAgIH0sCiAgICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHRyaWdnZXIpIHsKICAgICAgICB0aGlzLmVsZW1lbnQgPSByZXNvbHZlRWxlbWVudChlbGVtZW50KTsKICAgICAgICB0cmlnZ2VyID0gcmVzb2x2ZUVsZW1lbnQodHJpZ2dlcikgfHwgdGhpcy5lbGVtZW50OwogICAgICAgIGlmICh0aGlzLnRyaWdnZXIgIT09IHRyaWdnZXIpIHsKICAgICAgICAgIGlmICh0aGlzLnRyaWdnZXIpIEV2ZW50LnJlbW92ZUhhbmRsZXIodGhpcy50cmlnZ2VyLCAibW91c2Vkb3duIiwgc3RhcnREcmFnLCB0aGlzKTsKICAgICAgICAgIHRoaXMudHJpZ2dlciA9IHRyaWdnZXI7CiAgICAgICAgICBpZiAodGhpcy50cmlnZ2VyKSBFdmVudC5hZGRIYW5kbGVyKHRoaXMudHJpZ2dlciwgIm1vdXNlZG93biIsIHN0YXJ0RHJhZywgdGhpcyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRCYXNlOiBmdW5jdGlvbihiYXNlRWxlbWVudCkgewogICAgICAgIHRoaXMuYmFzZUVsZW1lbnQgPSByZXNvbHZlRWxlbWVudChiYXNlRWxlbWVudCk7CiAgICAgIH0sCiAgICAgIGdldEJhc2U6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmJhc2VFbGVtZW50IHx8IChkb2N1bWVudC5jb21wYXRNb2RlID09ICJDU1MxQ29tcGF0IiA/IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCA6IGRvY3VtZW50LmJvZHkpOwogICAgICB9LAogICAgICBpc0RyYWdnaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZHJhZ0VsZW1lbnQgPT09IHRoaXM7CiAgICAgIH0sCiAgICAgIHN0YXJ0OiBmdW5jdGlvbihldmVudCkgewogICAgICAgIGlmICghdGhpcy5pc0RyYWdnaW5nKCkpIHN0YXJ0RHJhZy5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgfSwKICAgICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuaXNEcmFnZ2luZygpKSBzdG9wRHJhZygpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICBjbGVhbmVyLnJlbW92ZSh0aGlzKTsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KCk7CiAgICAgICAgdGhpcy5zZXRCYXNlKCk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIERlbHRhV3JpdGVyID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRGVsdGFXcml0ZXIiLAogICAgICBwcm9wZXJ0eTogbnVsbCwKICAgICAgaW52ZXJ0OiBmYWxzZSwKICAgICAgZm9ybWF0OiBiYXNpcy5mbi4kc2VsZiwKICAgICAgaW5pdDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIGlmICh0eXBlb2YgdGhpcy5wcm9wZXJ0eSA9PSAiZnVuY3Rpb24iKSB0aGlzLnByb3BlcnR5ID0gdGhpcy5wcm9wZXJ0eShlbGVtZW50KTsKICAgICAgICBpZiAodHlwZW9mIHRoaXMuaW52ZXJ0ID09ICJmdW5jdGlvbiIpIHRoaXMuaW52ZXJ0ID0gdGhpcy5pbnZlcnQodGhpcy5wcm9wZXJ0eSk7CiAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMucmVhZChlbGVtZW50KTsKICAgICAgfSwKICAgICAgcmVhZDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnRbdGhpcy5wcm9wZXJ0eV07CiAgICAgIH0sCiAgICAgIHdyaXRlOiBmdW5jdGlvbihlbGVtZW50LCBmb3JtYXR0ZWRWYWx1ZSkgewogICAgICAgIGVsZW1lbnRbdGhpcy5wcm9wZXJ0eV0gPSBmb3JtYXR0ZWRWYWx1ZTsKICAgICAgfSwKICAgICAgYXBwbHlEZWx0YTogZnVuY3Rpb24oZWxlbWVudCwgZGVsdGEpIHsKICAgICAgICBpZiAodGhpcy5pbnZlcnQpIGRlbHRhID0gLWRlbHRhOwogICAgICAgIHRoaXMud3JpdGUoZWxlbWVudCwgdGhpcy5mb3JtYXQodGhpcy52YWx1ZSArIGRlbHRhLCBkZWx0YSkpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBTdHlsZURlbHRhV3JpdGVyID0gRGVsdGFXcml0ZXIuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU3R5bGVEZWx0YVdyaXRlciIsCiAgICAgIGZvcm1hdDogZnVuY3Rpb24odmFsdWUsIGRlbHRhKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlICsgInB4IjsKICAgICAgfSwKICAgICAgcmVhZDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHJldHVybiBwYXJzZUZsb2F0KGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgdGhpcy5wcm9wZXJ0eSkpIHx8IDA7CiAgICAgIH0sCiAgICAgIHdyaXRlOiBmdW5jdGlvbihlbGVtZW50LCBmb3JtYXR0ZWRWYWx1ZSkgewogICAgICAgIGVsZW1lbnQuc3R5bGVbdGhpcy5wcm9wZXJ0eV0gPSBmb3JtYXR0ZWRWYWx1ZTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgU3R5bGVQb3NpdGlvblggPSBTdHlsZURlbHRhV3JpdGVyLnN1YmNsYXNzKHsKICAgICAgcHJvcGVydHk6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICByZXR1cm4gZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCAibGVmdCIpID09ICJhdXRvIiAmJiBnZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQsICJyaWdodCIpICE9ICJhdXRvIiA/ICJyaWdodCIgOiAibGVmdCI7CiAgICAgIH0sCiAgICAgIGludmVydDogZnVuY3Rpb24ocHJvcGVydHkpIHsKICAgICAgICByZXR1cm4gcHJvcGVydHkgPT0gInJpZ2h0IjsKICAgICAgfQogICAgfSk7CiAgICB2YXIgU3R5bGVQb3NpdGlvblkgPSBTdHlsZURlbHRhV3JpdGVyLnN1YmNsYXNzKHsKICAgICAgcHJvcGVydHk6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICByZXR1cm4gZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCAidG9wIikgPT0gImF1dG8iICYmIGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgImJvdHRvbSIpICE9ICJhdXRvIiA/ICJib3R0b20iIDogInRvcCI7CiAgICAgIH0sCiAgICAgIGludmVydDogZnVuY3Rpb24ocHJvcGVydHkpIHsKICAgICAgICByZXR1cm4gcHJvcGVydHkgPT0gImJvdHRvbSI7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIE1vdmVhYmxlRWxlbWVudCA9IERyYWdEcm9wRWxlbWVudC5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Nb3ZlYWJsZUVsZW1lbnQiLAogICAgICBmaXhUb3A6IHRydWUsCiAgICAgIGZpeFJpZ2h0OiB0cnVlLAogICAgICBmaXhCb3R0b206IHRydWUsCiAgICAgIGZpeExlZnQ6IHRydWUsCiAgICAgIGF4aXNYOiBTdHlsZVBvc2l0aW9uWCwKICAgICAgYXhpc1k6IFN0eWxlUG9zaXRpb25ZLAogICAgICBlbWl0X3N0YXJ0OiBmdW5jdGlvbihkcmFnRGF0YSwgZXZlbnQpIHsKICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgdmFyIHZpZXdwb3J0ID0gZ2V0Vmlld3BvcnRSZWN0KHRoaXMuZ2V0QmFzZSgpKTsKICAgICAgICAgIHZhciBib3ggPSBnZXRCb3VuZGluZ1JlY3QoZWxlbWVudCk7CiAgICAgICAgICBkcmFnRGF0YS5lbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgIGlmICh0aGlzLmF4aXNYKSB7CiAgICAgICAgICAgIGRyYWdEYXRhLmF4aXNYID0gbmV3IHRoaXMuYXhpc1goZWxlbWVudCk7CiAgICAgICAgICAgIGlmICh0aGlzLmZpeExlZnQpIGRyYWdEYXRhLm1pbkRlbHRhWCA9IHZpZXdwb3J0LmxlZnQgLSBib3gubGVmdDsKICAgICAgICAgICAgaWYgKHRoaXMuZml4UmlnaHQpIGRyYWdEYXRhLm1heERlbHRhWCA9IHZpZXdwb3J0LnJpZ2h0IC0gYm94LnJpZ2h0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuYXhpc1kpIHsKICAgICAgICAgICAgZHJhZ0RhdGEuYXhpc1kgPSBuZXcgdGhpcy5heGlzWShlbGVtZW50KTsKICAgICAgICAgICAgaWYgKHRoaXMuZml4VG9wKSBkcmFnRGF0YS5taW5EZWx0YVkgPSB2aWV3cG9ydC50b3AgLSBib3gudG9wOwogICAgICAgICAgICBpZiAodGhpcy5maXhCb3R0b20pIGRyYWdEYXRhLm1heERlbHRhWSA9IHZpZXdwb3J0LmJvdHRvbSAtIGJveC5ib3R0b207CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIERyYWdEcm9wRWxlbWVudC5wcm90b3R5cGUuZW1pdF9zdGFydC5jYWxsKHRoaXMsIGRyYWdEYXRhLCBldmVudCk7CiAgICAgIH0sCiAgICAgIGVtaXRfZHJhZzogZnVuY3Rpb24oZHJhZ0RhdGEsIGV2ZW50KSB7CiAgICAgICAgaWYgKCFkcmFnRGF0YS5lbGVtZW50KSByZXR1cm47CiAgICAgICAgaWYgKGRyYWdEYXRhLmF4aXNYKSBkcmFnRGF0YS5heGlzWC5hcHBseURlbHRhKGRyYWdEYXRhLmVsZW1lbnQsIGRyYWdEYXRhLmRlbHRhWCk7CiAgICAgICAgaWYgKGRyYWdEYXRhLmF4aXNZKSBkcmFnRGF0YS5heGlzWS5hcHBseURlbHRhKGRyYWdEYXRhLmVsZW1lbnQsIGRyYWdEYXRhLmRlbHRhWSk7CiAgICAgICAgRHJhZ0Ryb3BFbGVtZW50LnByb3RvdHlwZS5lbWl0X2RyYWcuY2FsbCh0aGlzLCBkcmFnRGF0YSwgZXZlbnQpOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBEcmFnRHJvcEVsZW1lbnQ6IERyYWdEcm9wRWxlbWVudCwKICAgICAgTW92ZWFibGVFbGVtZW50OiBNb3ZlYWJsZUVsZW1lbnQsCiAgICAgIERlbHRhV3JpdGVyOiBEZWx0YVdyaXRlciwKICAgICAgU3R5bGVEZWx0YVdyaXRlcjogU3R5bGVEZWx0YVdyaXRlcgogICAgfTsKICB9LAogICJiLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgY29tcHV0ZWRTdHlsZTsKICAgIGlmICgiZ2V0Q29tcHV0ZWRTdHlsZSIgaW4gZ2xvYmFsKSB7CiAgICAgIHZhciBHRVRDT01QVVRFRFNUWUxFX0JVR0dZID0gewogICAgICAgIHRvcDogdHJ1ZSwKICAgICAgICBib3R0b206IHRydWUsCiAgICAgICAgbGVmdDogdHJ1ZSwKICAgICAgICByaWdodDogdHJ1ZSwKICAgICAgICBoZWlnaHQ6IHRydWUsCiAgICAgICAgd2lkdGg6IHRydWUKICAgICAgfTsKICAgICAgdmFyIHRlc3RGb3JCdWdneVByb3BlcnRpZXMgPSBiYXNpcy5mbi5ydW5PbmNlKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB0ZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIHRlc3RFbGVtZW50LnNldEF0dHJpYnV0ZSgic3R5bGUiLCAicG9zaXRpb246YWJzb2x1dGU7dG9wOmF1dG8haW1wb3J0YW50Iik7CiAgICAgICAgYmFzaXMuZG9jLmJvZHkuYWRkKHRlc3RFbGVtZW50KTsKICAgICAgICBpZiAoZ2xvYmFsLmdldENvbXB1dGVkU3R5bGUodGVzdEVsZW1lbnQpLnRvcCA9PSAiYXV0byIpIEdFVENPTVBVVEVEU1RZTEVfQlVHR1kgPSB7fTsKICAgICAgICBiYXNpcy5kb2MucmVtb3ZlKHRlc3RFbGVtZW50KTsKICAgICAgfSk7CiAgICAgIGNvbXB1dGVkU3R5bGUgPSBmdW5jdGlvbihlbGVtZW50LCBzdHlsZVByb3ApIHsKICAgICAgICB2YXIgc3R5bGUgPSBnbG9iYWwuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50KTsKICAgICAgICB2YXIgcmVzOwogICAgICAgIGlmIChzdHlsZSkgewogICAgICAgICAgaWYgKHN0eWxlUHJvcCBpbiBHRVRDT01QVVRFRFNUWUxFX0JVR0dZKSB0ZXN0Rm9yQnVnZ3lQcm9wZXJ0aWVzKCk7CiAgICAgICAgICBpZiAoR0VUQ09NUFVURURTVFlMRV9CVUdHWVtzdHlsZVByb3BdICYmIHN0eWxlLnBvc2l0aW9uICE9ICJzdGF0aWMiKSB7CiAgICAgICAgICAgIHZhciBkaXNwbGF5ID0gZWxlbWVudC5zdHlsZS5kaXNwbGF5OwogICAgICAgICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICAgIHJlcyA9IHN0eWxlLmdldFByb3BlcnR5VmFsdWUoc3R5bGVQcm9wKTsKICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlcyA9IHN0eWxlLmdldFByb3BlcnR5VmFsdWUoc3R5bGVQcm9wKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXM7CiAgICAgICAgfQogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgdmFyIFZBTFVFX1VOSVQgPSAvXi0/KFxkKlwuKT9cZCsoW2Etel0rfCUpPyQvaTsKICAgICAgdmFyIElTX1BJWEVMID0gL1xkcHgkL2k7CiAgICAgIHZhciBnZXRQaXhlbFZhbHVlID0gZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgICAgICBpZiAoSVNfUElYRUwudGVzdCh2YWx1ZSkpIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApICsgInB4IjsKICAgICAgICB2YXIgc3R5bGUgPSBlbGVtZW50LnN0eWxlOwogICAgICAgIHZhciBydW50aW1lU3R5bGUgPSBlbGVtZW50LnJ1bnRpbWVTdHlsZTsKICAgICAgICB2YXIgbGVmdCA9IHN0eWxlLmxlZnQ7CiAgICAgICAgdmFyIHJ1bnRpbWVMZWZ0ID0gcnVudGltZVN0eWxlLmxlZnQ7CiAgICAgICAgcnVudGltZVN0eWxlLmxlZnQgPSBlbGVtZW50LmN1cnJlbnRTdHlsZS5sZWZ0OwogICAgICAgIHN0eWxlLmxlZnQgPSB2YWx1ZSB8fCAwOwogICAgICAgIHZhbHVlID0gc3R5bGUucGl4ZWxMZWZ0OwogICAgICAgIHN0eWxlLmxlZnQgPSBsZWZ0OwogICAgICAgIHJ1bnRpbWVTdHlsZS5sZWZ0ID0gcnVudGltZUxlZnQ7CiAgICAgICAgcmV0dXJuIHZhbHVlICsgInB4IjsKICAgICAgfTsKICAgICAgY29tcHV0ZWRTdHlsZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHN0eWxlUHJvcCkgewogICAgICAgIHZhciBzdHlsZSA9IGVsZW1lbnQuY3VycmVudFN0eWxlOwogICAgICAgIGlmIChzdHlsZSkgewogICAgICAgICAgdmFyIHZhbHVlID0gc3R5bGVbc3R5bGVQcm9wID09ICJmbG9hdCIgPyAic3R5bGVGbG9hdCIgOiBiYXNpcy5zdHJpbmcuY2FtZWxpemUoc3R5bGVQcm9wKV07CiAgICAgICAgICB2YXIgdW5pdCA9ICh2YWx1ZSB8fCAiIikubWF0Y2goVkFMVUVfVU5JVCk7CiAgICAgICAgICBpZiAodW5pdCAmJiB1bml0WzJdICYmIHVuaXRbMl0gIT0gInB4IikgdmFsdWUgPSBnZXRQaXhlbFZhbHVlKGVsZW1lbnQsIHZhbHVlKTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZ2V0OiBjb21wdXRlZFN0eWxlCiAgICB9OwogIH0sCiAgImMuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vYi5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBkb2N1bWVudCA9IGdsb2JhbC5kb2N1bWVudDsKICAgIHZhciBkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICB2YXIgY29tcHV0ZWRTdHlsZSA9IGJhc2lzLmRvbS5jb21wdXRlZFN0eWxlLmdldDsKICAgIGZ1bmN0aW9uIGdldE9mZnNldFBhcmVudChub2RlKSB7CiAgICAgIHZhciBvZmZzZXRQYXJlbnQgPSBub2RlLm9mZnNldFBhcmVudCB8fCBkb2N1bWVudEVsZW1lbnQ7CiAgICAgIHdoaWxlIChvZmZzZXRQYXJlbnQgJiYgb2Zmc2V0UGFyZW50ICE9PSBkb2N1bWVudEVsZW1lbnQgJiYgY29tcHV0ZWRTdHlsZShvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09ICJzdGF0aWMiKSBvZmZzZXRQYXJlbnQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICByZXR1cm4gb2Zmc2V0UGFyZW50IHx8IGRvY3VtZW50RWxlbWVudDsKICAgIH0KICAgIGZ1bmN0aW9uIGdldE9mZnNldChlbGVtZW50KSB7CiAgICAgIHZhciB0b3AgPSAwOwogICAgICB2YXIgbGVmdCA9IDA7CiAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KSB7CiAgICAgICAgdmFyIHJlbFJlY3QgPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIGxlZnQgPSAtcmVsUmVjdC5sZWZ0OwogICAgICAgIHRvcCA9IC1yZWxSZWN0LnRvcDsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIpIHsKICAgICAgICAgIHRvcCA9IGdsb2JhbC5wYWdlWU9mZnNldCB8fCBkb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wOwogICAgICAgICAgbGVmdCA9IGdsb2JhbC5wYWdlWE9mZnNldCB8fCBkb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGJvZHkgPSBkb2N1bWVudC5ib2R5OwogICAgICAgICAgaWYgKGVsZW1lbnQgIT09IGJvZHkpIHsKICAgICAgICAgICAgdG9wID0gYm9keS5zY3JvbGxUb3AgLSBib2R5LmNsaWVudFRvcDsKICAgICAgICAgICAgbGVmdCA9IGJvZHkuc2Nyb2xsTGVmdCAtIGJvZHkuY2xpZW50TGVmdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICB4OiBsZWZ0LAogICAgICAgIHk6IHRvcAogICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gZ2V0VG9wTGVmdFBvaW50KGVsZW1lbnQsIHJlbEVsZW1lbnQpIHsKICAgICAgdmFyIGxlZnQgPSAwOwogICAgICB2YXIgdG9wID0gMDsKICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QpIHsKICAgICAgICB2YXIgYm94ID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICB2YXIgb2Zmc2V0ID0gZ2V0T2Zmc2V0KHJlbEVsZW1lbnQpOwogICAgICAgIHRvcCA9IGJveC50b3AgKyBvZmZzZXQueTsKICAgICAgICBsZWZ0ID0gYm94LmxlZnQgKyBvZmZzZXQueDsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHRvcDogdG9wLAogICAgICAgIGxlZnQ6IGxlZnQKICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldEJvdW5kaW5nUmVjdChlbGVtZW50LCByZWxFbGVtZW50KSB7CiAgICAgIHZhciB0b3AgPSAwOwogICAgICB2YXIgbGVmdCA9IDA7CiAgICAgIHZhciByaWdodCA9IDA7CiAgICAgIHZhciBib3R0b20gPSAwOwogICAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCkgewogICAgICAgIHZhciByZWN0ID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICB2YXIgb2Zmc2V0ID0gZ2V0T2Zmc2V0KHJlbEVsZW1lbnQpOwogICAgICAgIHRvcCA9IHJlY3QudG9wICsgb2Zmc2V0Lnk7CiAgICAgICAgbGVmdCA9IHJlY3QubGVmdCArIG9mZnNldC54OwogICAgICAgIHJpZ2h0ID0gcmVjdC5yaWdodCArIG9mZnNldC54OwogICAgICAgIGJvdHRvbSA9IHJlY3QuYm90dG9tICsgb2Zmc2V0Lnk7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICB0b3A6IHRvcCwKICAgICAgICBsZWZ0OiBsZWZ0LAogICAgICAgIHJpZ2h0OiByaWdodCwKICAgICAgICBib3R0b206IGJvdHRvbSwKICAgICAgICB3aWR0aDogcmlnaHQgLSBsZWZ0LAogICAgICAgIGhlaWdodDogYm90dG9tIC0gdG9wCiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBnZXRWaWV3cG9ydFJlY3QoZWxlbWVudCwgcmVsRWxlbWVudCkgewogICAgICB2YXIgcG9pbnQgPSBnZXRUb3BMZWZ0UG9pbnQoZWxlbWVudCwgcmVsRWxlbWVudCk7CiAgICAgIHZhciB0b3AgPSBwb2ludC50b3AgKyBlbGVtZW50LmNsaWVudFRvcDsKICAgICAgdmFyIGxlZnQgPSBwb2ludC5sZWZ0ICsgZWxlbWVudC5jbGllbnRMZWZ0OwogICAgICB2YXIgd2lkdGggPSBlbGVtZW50LmNsaWVudFdpZHRoOwogICAgICB2YXIgaGVpZ2h0ID0gZWxlbWVudC5jbGllbnRIZWlnaHQ7CiAgICAgIHJldHVybiB7CiAgICAgICAgdG9wOiB0b3AsCiAgICAgICAgbGVmdDogbGVmdCwKICAgICAgICBib3R0b206IHRvcCArIGhlaWdodCwKICAgICAgICByaWdodDogbGVmdCArIHdpZHRoLAogICAgICAgIHdpZHRoOiB3aWR0aCwKICAgICAgICBoZWlnaHQ6IGhlaWdodAogICAgICB9OwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGdldE9mZnNldFBhcmVudDogZ2V0T2Zmc2V0UGFyZW50LAogICAgICBnZXRUb3BMZWZ0UG9pbnQ6IGdldFRvcExlZnRQb2ludCwKICAgICAgZ2V0Qm91bmRpbmdSZWN0OiBnZXRCb3VuZGluZ1JlY3QsCiAgICAgIGdldFZpZXdwb3J0UmVjdDogZ2V0Vmlld3BvcnRSZWN0CiAgICB9OwogIH0sCiAgIjEuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMi5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzUuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNi5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi83LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgY3JlYXRlRXZlbnQgPSBiYXNpcy5ldmVudC5jcmVhdGU7CiAgICB2YXIgSHRtbFRlbXBsYXRlID0gYmFzaXMudGVtcGxhdGUuaHRtbC5UZW1wbGF0ZTsKICAgIHZhciBodG1sVGVtcGxhdGVJZE1hcmtlciA9IGJhc2lzLnRlbXBsYXRlLmh0bWwubWFya2VyOwogICAgdmFyIFRlbXBsYXRlU3dpdGNoZXIgPSBiYXNpcy50ZW1wbGF0ZS5UZW1wbGF0ZVN3aXRjaGVyOwogICAgdmFyIERXTm9kZSA9IGJhc2lzLmRvbS53cmFwcGVyLk5vZGU7CiAgICB2YXIgRFdQYXJ0aXRpb25Ob2RlID0gYmFzaXMuZG9tLndyYXBwZXIuUGFydGl0aW9uTm9kZTsKICAgIHZhciBEV0dyb3VwaW5nTm9kZSA9IGJhc2lzLmRvbS53cmFwcGVyLkdyb3VwaW5nTm9kZTsKICAgIHZhciBpbnN0YW5jZXMgPSB7fTsKICAgIHZhciBub3RpZmllciA9IG5ldyBiYXNpcy5Ub2tlbjsKICAgIHZhciBiaW5kaW5nU2VlZCA9IDE7CiAgICB2YXIgdW5rbm93bkV2ZW50QmluZGluZ0NoZWNrID0ge307CiAgICBmdW5jdGlvbiBleHRlbmRCaW5kaW5nKGJpbmRpbmcsIGV4dGVuc2lvbikgewogICAgICBiaW5kaW5nLmJpbmRpbmdJZCA9IGJpbmRpbmdTZWVkKys7CiAgICAgIGZvciAodmFyIGtleSBpbiBleHRlbnNpb24pIHsKICAgICAgICB2YXIgZGVmID0gbnVsbDsKICAgICAgICB2YXIgdmFsdWUgPSBleHRlbnNpb25ba2V5XTsKICAgICAgICBpZiAoTm9kZSAmJiB2YWx1ZSBpbnN0YW5jZW9mIE5vZGUgfHwgYmFzaXMucmVzb3VyY2UuaXNSZXNvdXJjZSh2YWx1ZSkpIHsKICAgICAgICAgIGRlZiA9IHsKICAgICAgICAgICAgZXZlbnRzOiAic2F0ZWxsaXRlQ2hhbmdlZCIsCiAgICAgICAgICAgIGdldHRlcjogZnVuY3Rpb24oa2V5LCBzYXRlbGxpdGUpIHsKICAgICAgICAgICAgICB2YXIgcmVzb3VyY2UgPSB0eXBlb2Ygc2F0ZWxsaXRlID09ICJmdW5jdGlvbiIgPyBzYXRlbGxpdGUgOiBudWxsOwogICAgICAgICAgICAgIHZhciBpbml0ID0gZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgaW5pdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHJlc291cmNlKSB7CiAgICAgICAgICAgICAgICAgIHNhdGVsbGl0ZSA9IHJlc291cmNlKCk7CiAgICAgICAgICAgICAgICAgIGlmIChzYXRlbGxpdGUgaW5zdGFuY2VvZiBOb2RlID09IGZhbHNlKSByZXR1cm47CiAgICAgICAgICAgICAgICAgIHJlc291cmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUuc2V0U2F0ZWxsaXRlKGtleSwgc2F0ZWxsaXRlKTsKICAgICAgICAgICAgICAgIGlmIChub2RlLnNhdGVsbGl0ZVtrZXldICE9PSBzYXRlbGxpdGUpIGJhc2lzLmRldi53YXJuKCJiYXNpcy51aS5iaW5kaW5nOiBpbXBsaWNpdCBzYXRlbGxpdGUgYCIgKyBrZXkgKyAiYCBhdHRhY2ggdG8gb3duZXIgZmFpbGVkIik7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgaWYgKGluaXQpIGluaXQobm9kZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb3VyY2UgfHwgKG5vZGUuc2F0ZWxsaXRlW2tleV0gPyBub2RlLnNhdGVsbGl0ZVtrZXldLmVsZW1lbnQgOiBudWxsKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KGtleSwgdmFsdWUpCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIikgdmFsdWUgPSBCSU5ESU5HX1BSRVNFVC5wcm9jZXNzKGtleSwgdmFsdWUpOyBlbHNlIGlmICh2YWx1ZS5iaW5kaW5nQnJpZGdlKSB2YWx1ZSA9IGJhc2lzLmZuLiRjb25zdCh2YWx1ZSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICBkZWYgPSB7CiAgICAgICAgICAgICAgICBnZXR0ZXI6IHR5cGVvZiB2YWx1ZSA9PSAiZnVuY3Rpb24iID8gdmFsdWUgOiBiYXNpcy5nZXR0ZXIodmFsdWUpCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgIGRlZiA9IHsKICAgICAgICAgICAgICAgIGV2ZW50czogdmFsdWVbMF0sCiAgICAgICAgICAgICAgICBnZXR0ZXI6IGJhc2lzLmdldHRlcih2YWx1ZVsxXSkKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlZiA9IHsKICAgICAgICAgICAgICAgIGV2ZW50czogdmFsdWUuZXZlbnRzLAogICAgICAgICAgICAgICAgZ2V0dGVyOiBiYXNpcy5nZXR0ZXIodmFsdWUuZ2V0dGVyKQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYmluZGluZ1trZXldID0gZGVmOwogICAgICB9CiAgICB9CiAgICB2YXIgQklORElOR19QUkVTRVQgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHByZXNldHMgPSB7fTsKICAgICAgdmFyIHByZWZpeFJlZ0V4cCA9IC9eKFthLXpfXVthLXowLTlfXSopOiguKikvaTsKICAgICAgcmV0dXJuIHsKICAgICAgICBhZGQ6IGZ1bmN0aW9uKHByZWZpeCwgZnVuYykgewogICAgICAgICAgaWYgKCFwcmVzZXRzW3ByZWZpeF0pIHsKICAgICAgICAgICAgcHJlc2V0c1twcmVmaXhdID0gZnVuYzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJQcmVzZXQgYCIgKyBwcmVmaXggKyAiYCBhbHJlYWR5IGV4aXN0cywgbmV3IGRlZmluaXRpb24gaWdub3JlZCIpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcHJvY2VzczogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgdmFyIHByZXNldDsKICAgICAgICAgIHZhciBtID0gdmFsdWUubWF0Y2gocHJlZml4UmVnRXhwKTsKICAgICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgIHByZXNldCA9IHByZXNldHNbbVsxXV07CiAgICAgICAgICAgIHZhbHVlID0gbVsyXSB8fCBrZXk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcHJlc2V0ID8gcHJlc2V0KHZhbHVlKSA6IHZhbHVlOwogICAgICAgIH0KICAgICAgfTsKICAgIH0oKTsKICAgIEJJTkRJTkdfUFJFU0VULmFkZCgiZGF0YSIsIGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBldmVudHM6ICJ1cGRhdGUiLAogICAgICAgIGdldHRlcjogImRhdGEuIiArIHBhdGgKICAgICAgfTsKICAgIH0pOwogICAgQklORElOR19QUkVTRVQuYWRkKCJzYXRlbGxpdGUiLCBmdW5jdGlvbihzYXRlbGxpdGVOYW1lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZXZlbnRzOiAic2F0ZWxsaXRlQ2hhbmdlZCIsCiAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5zYXRlbGxpdGVbc2F0ZWxsaXRlTmFtZV0gPyBub2RlLnNhdGVsbGl0ZVtzYXRlbGxpdGVOYW1lXS5lbGVtZW50IDogbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKICAgIHZhciBURU1QTEFURV9CSU5ESU5HID0gQ2xhc3MuY3VzdG9tRXh0ZW5kUHJvcGVydHkoewogICAgICBzdGF0ZTogewogICAgICAgIGV2ZW50czogInN0YXRlQ2hhbmdlZCIsCiAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nKG5vZGUuc3RhdGUpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hpbGROb2Rlc1N0YXRlOiB7CiAgICAgICAgZXZlbnRzOiAiY2hpbGROb2Rlc1N0YXRlQ2hhbmdlZCIsCiAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nKG5vZGUuY2hpbGROb2Rlc1N0YXRlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNoaWxkQ291bnQ6IHsKICAgICAgICBldmVudHM6ICJjaGlsZE5vZGVzTW9kaWZpZWQiLAogICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUuY2hpbGROb2RlcyA/IG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggOiAwOwogICAgICAgIH0KICAgICAgfSwKICAgICAgaGFzQ2hpbGRyZW46IHsKICAgICAgICBldmVudHM6ICJjaGlsZE5vZGVzTW9kaWZpZWQiLAogICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuICEhbm9kZS5maXJzdENoaWxkOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZW1wdHk6IHsKICAgICAgICBldmVudHM6ICJjaGlsZE5vZGVzTW9kaWZpZWQiLAogICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuICFub2RlLmZpcnN0Q2hpbGQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LCBleHRlbmRCaW5kaW5nKTsKICAgIHZhciBCSU5ESU5HX1RFTVBMQVRFX0lOVEVSRkFDRSA9IHsKICAgICAgYXR0YWNoOiBmdW5jdGlvbihvYmplY3QsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICBvYmplY3QuYWRkSGFuZGxlcihoYW5kbGVyLCBjb250ZXh0KTsKICAgICAgfSwKICAgICAgZGV0YWNoOiBmdW5jdGlvbihvYmplY3QsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICBvYmplY3QucmVtb3ZlSGFuZGxlcihoYW5kbGVyLCBjb250ZXh0KTsKICAgICAgfQogICAgfTsKICAgIHZhciBURU1QTEFURV9BQ1RJT04gPSBDbGFzcy5leHRlbnNpYmxlUHJvcGVydHkoewogICAgICBzZWxlY3Q6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgaWYgKHRoaXMuaXNEaXNhYmxlZCgpKSByZXR1cm47CiAgICAgICAgaWYgKHRoaXMuY29udGV4dFNlbGVjdGlvbiAmJiB0aGlzLmNvbnRleHRTZWxlY3Rpb24ubXVsdGlwbGUpIHRoaXMuc2VsZWN0KGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSk7IGVsc2UgdGhpcy5zZWxlY3QoKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgVEVNUExBVEVfU1dJVENIRVJfSEFORExFUiA9IHsKICAgICAgIioiOiBmdW5jdGlvbihldmVudCkgewogICAgICAgIHZhciBzd2l0Y2hlciA9IHRoaXMudGVtcGxhdGVTd2l0Y2hlcl87CiAgICAgICAgaWYgKHN3aXRjaGVyICYmIHN3aXRjaGVyLnJ1bGVFdmVudHMgJiYgc3dpdGNoZXIucnVsZUV2ZW50c1tldmVudC50eXBlXSkgdGhpcy5zZXRUZW1wbGF0ZShzd2l0Y2hlci5yZXNvbHZlKHRoaXMpKTsKICAgICAgfQogICAgfTsKICAgIHZhciBURU1QTEFURSA9IG5ldyBIdG1sVGVtcGxhdGUoIjxkaXYvPiIpOwogICAgdmFyIGZyYWdtZW50cyA9IFtdOwogICAgZnVuY3Rpb24gZ2V0RG9jdW1lbnRGcmFnbWVudCgpIHsKICAgICAgcmV0dXJuIGZyYWdtZW50cy5wb3AoKSB8fCBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICB9CiAgICBmdW5jdGlvbiByZWluc2VydFBhcnRpdGlvbk5vZGVzKHBhcnRpdGlvbikgewogICAgICB2YXIgbm9kZXMgPSBwYXJ0aXRpb24ubm9kZXM7CiAgICAgIGlmIChub2RlcykgZm9yICh2YXIgaSA9IG5vZGVzLmxlbmd0aCAtIDEsIGNoaWxkOyBjaGlsZCA9IG5vZGVzW2ldOyBpLS0pIGNoaWxkLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkLCBjaGlsZC5uZXh0U2libGluZyk7CiAgICB9CiAgICB2YXIgZm9jdXNUaW1lcjsKICAgIHZhciBUZW1wbGF0ZU1peGluID0gZnVuY3Rpb24oc3VwZXJfKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdGVtcGxhdGU6IFRFTVBMQVRFLAogICAgICAgIGVtaXRfdGVtcGxhdGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgidGVtcGxhdGVDaGFuZ2VkIiksCiAgICAgICAgdGVtcGxhdGVTd2l0Y2hlcl86IG51bGwsCiAgICAgICAgYmluZGluZzogVEVNUExBVEVfQklORElORywKICAgICAgICBhY3Rpb246IFRFTVBMQVRFX0FDVElPTiwKICAgICAgICB0bXBsOiBudWxsLAogICAgICAgIGVsZW1lbnQ6IG51bGwsCiAgICAgICAgY2hpbGROb2Rlc0VsZW1lbnQ6IG51bGwsCiAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLmVsZW1lbnQgPSB0aGlzLmNoaWxkTm9kZXNFbGVtZW50ID0gZ2V0RG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgICAgc3VwZXJfLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB9LAogICAgICAgIHBvc3RJbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHN1cGVyXy5wb3N0SW5pdC5jYWxsKHRoaXMpOwogICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy50ZW1wbGF0ZTsKICAgICAgICAgIGlmICh0ZW1wbGF0ZSkgewogICAgICAgICAgICB2YXIgbm9kZURvY3VtZW50RnJhZ21lbnQgPSB0aGlzLmVsZW1lbnQ7CiAgICAgICAgICAgIHZhciBiaW5kaW5nSWQgPSB0aGlzLmNvbnN0cnVjdG9yLmJhc2lzQ2xhc3NJZF8gKyAiXyIgKyB0aGlzLmJpbmRpbmcuYmluZGluZ0lkOwogICAgICAgICAgICBpZiAoYmluZGluZ0lkIGluIHVua25vd25FdmVudEJpbmRpbmdDaGVjayA9PSBmYWxzZSkgewogICAgICAgICAgICAgIHVua25vd25FdmVudEJpbmRpbmdDaGVja1tiaW5kaW5nSWRdID0gdHJ1ZTsKICAgICAgICAgICAgICBmb3IgKHZhciBiaW5kTmFtZSBpbiB0aGlzLmJpbmRpbmcpIHsKICAgICAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmJpbmRpbmdbYmluZE5hbWVdICYmIHRoaXMuYmluZGluZ1tiaW5kTmFtZV0uZXZlbnRzOwogICAgICAgICAgICAgICAgaWYgKGV2ZW50cykgewogICAgICAgICAgICAgICAgICBldmVudHMgPSBTdHJpbmcoZXZlbnRzKS50cmltKCkuc3BsaXQoL1xzK3xccyosXHMqLyk7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudE5hbWU7IGV2ZW50TmFtZSA9IGV2ZW50c1tpXTsgaSsrKSBpZiAoImVtaXRfIiArIGV2ZW50TmFtZSBpbiB0aGlzID09IGZhbHNlKSBiYXNpcy5kZXYud2FybigiYmFzaXMudWk6IGJpbmRpbmcgYCIgKyBiaW5kTmFtZSArICJgIGhhcyB1bmtub3duIGV2ZW50IGAiICsgZXZlbnROYW1lICsgImAgZm9yICIgKyB0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLnNldFRlbXBsYXRlKHRlbXBsYXRlKTsKICAgICAgICAgICAgZnJhZ21lbnRzLnB1c2gobm9kZURvY3VtZW50RnJhZ21lbnQpOwogICAgICAgICAgICBpZiAodGhpcy5jb250YWluZXIpIHsKICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh0aGlzLmVsZW1lbnQpOwogICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2VzW3RoaXMuYmFzaXNPYmplY3RJZF0gPSB0aGlzOwogICAgICAgICAgbm90aWZpZXIuc2V0KHsKICAgICAgICAgICAgYWN0aW9uOiAiY3JlYXRlIiwKICAgICAgICAgICAgaW5zdGFuY2U6IHRoaXMKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgdGVtcGxhdGVTeW5jOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBvbGRFbGVtZW50ID0gdGhpcy5lbGVtZW50OwogICAgICAgICAgdmFyIG9sZFRtcGwgPSB0aGlzLnRtcGw7CiAgICAgICAgICB2YXIgdG1wbCA9IHRoaXMudGVtcGxhdGUuY3JlYXRlSW5zdGFuY2UodGhpcywgdGhpcy50ZW1wbGF0ZUFjdGlvbiwgdGhpcy50ZW1wbGF0ZVN5bmMsIHRoaXMuYmluZGluZywgQklORElOR19URU1QTEFURV9JTlRFUkZBQ0UpOwogICAgICAgICAgdmFyIG5vQ2hpbGROb2Rlc0VsZW1lbnQ7CiAgICAgICAgICBpZiAodG1wbC5jaGlsZE5vZGVzSGVyZSkgewogICAgICAgICAgICB0bXBsLmNoaWxkTm9kZXNFbGVtZW50ID0gdG1wbC5jaGlsZE5vZGVzSGVyZS5wYXJlbnROb2RlOwogICAgICAgICAgICB0bXBsLmNoaWxkTm9kZXNFbGVtZW50Lmluc2VydFBvaW50ID0gdG1wbC5jaGlsZE5vZGVzSGVyZTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMudG1wbCA9IHRtcGw7CiAgICAgICAgICB0aGlzLmVsZW1lbnQgPSB0bXBsLmVsZW1lbnQ7CiAgICAgICAgICB0aGlzLmNoaWxkTm9kZXNFbGVtZW50ID0gdG1wbC5jaGlsZE5vZGVzRWxlbWVudCB8fCB0bXBsLmVsZW1lbnQ7CiAgICAgICAgICBub0NoaWxkTm9kZXNFbGVtZW50ID0gdGhpcy5jaGlsZE5vZGVzRWxlbWVudC5ub2RlVHlwZSAhPSAxOwogICAgICAgICAgaWYgKG5vQ2hpbGROb2Rlc0VsZW1lbnQpIHRoaXMuY2hpbGROb2Rlc0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgICBpZiAobm9DaGlsZE5vZGVzRWxlbWVudCkgdGhpcy5ub0NoaWxkTm9kZXNFbGVtZW50XyA9IHRydWU7IGVsc2UgZGVsZXRlIHRoaXMubm9DaGlsZE5vZGVzRWxlbWVudF87CiAgICAgICAgICBpZiAodGhpcy5ncm91cGluZykgewogICAgICAgICAgICB0aGlzLmdyb3VwaW5nLnN5bmNEb21SZWZzKCk7CiAgICAgICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgICAgICB3aGlsZSAoY3Vyc29yLmdyb3VwaW5nKSBjdXJzb3IgPSBjdXJzb3IuZ3JvdXBpbmc7CiAgICAgICAgICAgIHZhciB0b3BHcm91cGluZyA9IGN1cnNvcjsKICAgICAgICAgICAgZm9yICh2YXIgZ3JvdXBOb2RlID0gdG9wR3JvdXBpbmcubGFzdENoaWxkOyBncm91cE5vZGU7IGdyb3VwTm9kZSA9IGdyb3VwTm9kZS5wcmV2aW91c1NpYmxpbmcpIHsKICAgICAgICAgICAgICBpZiAoZ3JvdXBOb2RlIGluc3RhbmNlb2YgUGFydGl0aW9uTm9kZSkgdG9wR3JvdXBpbmcuaW5zZXJ0QmVmb3JlKGdyb3VwTm9kZSwgZ3JvdXBOb2RlLm5leHRTaWJsaW5nKTsgZWxzZSByZWluc2VydFBhcnRpdGlvbk5vZGVzKGdyb3VwTm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVpbnNlcnRQYXJ0aXRpb25Ob2Rlcyh0b3BHcm91cGluZy5udWxsR3JvdXApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgY2hpbGQgPSB0aGlzLmxhc3RDaGlsZDsgY2hpbGQ7IGNoaWxkID0gY2hpbGQucHJldmlvdXNTaWJsaW5nKSB0aGlzLmluc2VydEJlZm9yZShjaGlsZCwgY2hpbGQubmV4dFNpYmxpbmcpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBQYXJ0aXRpb25Ob2RlKSByZWluc2VydFBhcnRpdGlvbk5vZGVzKHRoaXMpOwogICAgICAgICAgaWYgKG9sZEVsZW1lbnQgJiYgb2xkRWxlbWVudCAhPT0gdGhpcy5lbGVtZW50ICYmIG9sZEVsZW1lbnQubm9kZVR5cGUgIT0gMTEpIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBvbGRFbGVtZW50ICYmIG9sZEVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5vd25lciAmJiB0aGlzLm93bmVyLnRtcGwpIHRoaXMub3duZXIudG1wbC5zZXQob2xkRWxlbWVudCwgdGhpcy5lbGVtZW50KTsKICAgICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50LnBhcmVudE5vZGUgIT09IHBhcmVudE5vZGUpIHBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMuZWxlbWVudCwgb2xkRWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbGRUbXBsKSB0aGlzLmVtaXRfdGVtcGxhdGVDaGFuZ2VkKCk7CiAgICAgICAgfSwKICAgICAgICBzZXRUZW1wbGF0ZTogZnVuY3Rpb24odGVtcGxhdGUpIHsKICAgICAgICAgIHZhciBjdXJTd2l0Y2hlciA9IHRoaXMudGVtcGxhdGVTd2l0Y2hlcl87CiAgICAgICAgICB2YXIgc3dpdGNoZXI7CiAgICAgICAgICBpZiAodGVtcGxhdGUgaW5zdGFuY2VvZiBUZW1wbGF0ZVN3aXRjaGVyKSB7CiAgICAgICAgICAgIHN3aXRjaGVyID0gdGVtcGxhdGU7CiAgICAgICAgICAgIHRlbXBsYXRlID0gc3dpdGNoZXIucmVzb2x2ZSh0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0ZW1wbGF0ZSBpbnN0YW5jZW9mIEh0bWxUZW1wbGF0ZSA9PSBmYWxzZSkgdGVtcGxhdGUgPSBudWxsOwogICAgICAgICAgaWYgKCF0ZW1wbGF0ZSkgewogICAgICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMudWkuTm9kZSNzZXRUZW1wbGF0ZTogc2V0IG51bGwgdG8gdGVtcGxhdGUgcG9zc2libGUgb25seSBvbiBub2RlIGRlc3Ryb3kiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHN3aXRjaGVyKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGVTd2l0Y2hlcl8gPSBzd2l0Y2hlcjsKICAgICAgICAgICAgaWYgKCFjdXJTd2l0Y2hlcikgdGhpcy5hZGRIYW5kbGVyKFRFTVBMQVRFX1NXSVRDSEVSX0hBTkRMRVIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1clN3aXRjaGVyICYmIGN1clN3aXRjaGVyLnJlc29sdmUodGhpcykgIT09IHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGVTd2l0Y2hlcl8gPSBudWxsOwogICAgICAgICAgICB0aGlzLnJlbW92ZUhhbmRsZXIoVEVNUExBVEVfU1dJVENIRVJfSEFORExFUiwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgb2xkVG1wbCA9IHRoaXMudG1wbDsKICAgICAgICAgIHZhciBvbGRUZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGU7CiAgICAgICAgICBpZiAob2xkVGVtcGxhdGUgIT09IHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZVN5bmMoKTsKICAgICAgICAgICAgaWYgKG9sZFRlbXBsYXRlKSBvbGRUZW1wbGF0ZS5jbGVhckluc3RhbmNlKG9sZFRtcGwpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdXBkYXRlQmluZDogZnVuY3Rpb24oYmluZE5hbWUpIHsKICAgICAgICAgIHZhciBiaW5kaW5nID0gdGhpcy5iaW5kaW5nW2JpbmROYW1lXTsKICAgICAgICAgIHZhciBnZXR0ZXIgPSBiaW5kaW5nICYmIGJpbmRpbmcuZ2V0dGVyOwogICAgICAgICAgaWYgKGdldHRlciAmJiB0aGlzLnRtcGwpIHRoaXMudG1wbC5zZXQoYmluZE5hbWUsIGdldHRlcih0aGlzKSk7CiAgICAgICAgfSwKICAgICAgICB0ZW1wbGF0ZUFjdGlvbjogZnVuY3Rpb24oYWN0aW9uTmFtZSwgZXZlbnQpIHsKICAgICAgICAgIHZhciBhY3Rpb24gPSB0aGlzLmFjdGlvblthY3Rpb25OYW1lXTsKICAgICAgICAgIGlmIChhY3Rpb24pIGFjdGlvbi5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgICAgIGlmICghYWN0aW9uKSBiYXNpcy5kZXYud2FybigidGVtcGxhdGUgY2FsbCBgIiArIGFjdGlvbk5hbWUgKyAiYCBhY3Rpb24sIGJ1dCBpdCBpc24ndCBkZWZpbmVkIGluIGFjdGlvbiBsaXN0Iik7CiAgICAgICAgfSwKICAgICAgICBmb2N1czogZnVuY3Rpb24oc2VsZWN0KSB7CiAgICAgICAgICB2YXIgZm9jdXNFbGVtZW50ID0gdGhpcy50bXBsID8gdGhpcy50bXBsLmZvY3VzIHx8IHRoaXMuZWxlbWVudCA6IG51bGw7CiAgICAgICAgICBpZiAoZm9jdXNFbGVtZW50KSB7CiAgICAgICAgICAgIGlmIChmb2N1c1RpbWVyKSBmb2N1c1RpbWVyID0gYmFzaXMuY2xlYXJJbW1lZGlhdGUoZm9jdXNUaW1lcik7CiAgICAgICAgICAgIGZvY3VzVGltZXIgPSBiYXNpcy5zZXRJbW1lZGlhdGUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZvY3VzRWxlbWVudC5mb2N1cygpOwogICAgICAgICAgICAgICAgaWYgKHNlbGVjdCkgZm9jdXNFbGVtZW50LnNlbGVjdCgpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYmx1cjogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZm9jdXNFbGVtZW50ID0gdGhpcy50bXBsID8gdGhpcy50bXBsLmZvY3VzIHx8IHRoaXMuZWxlbWVudCA6IG51bGw7CiAgICAgICAgICBpZiAoZm9jdXNFbGVtZW50KSB0cnkgewogICAgICAgICAgICBmb2N1c0VsZW1lbnQuYmx1cigpOwogICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICB9LAogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgZGVsZXRlIGluc3RhbmNlc1t0aGlzLmJhc2lzT2JqZWN0SWRdOwogICAgICAgICAgbm90aWZpZXIuc2V0KHsKICAgICAgICAgICAgYWN0aW9uOiAiZGVzdHJveSIsCiAgICAgICAgICAgIGluc3RhbmNlOiB0aGlzCiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGU7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKICAgICAgICAgIGlmICh0aGlzLnRlbXBsYXRlU3dpdGNoZXJfKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGVTd2l0Y2hlcl8gPSBudWxsOwogICAgICAgICAgICB0aGlzLnJlbW92ZUhhbmRsZXIoVEVNUExBVEVfU1dJVENIRVJfSEFORExFUiwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICB0ZW1wbGF0ZS5jbGVhckluc3RhbmNlKHRoaXMudG1wbCk7CiAgICAgICAgICBzdXBlcl8uZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgICAgdGhpcy50bXBsID0gbnVsbDsKICAgICAgICAgIHRoaXMuZWxlbWVudCA9IG51bGw7CiAgICAgICAgICB0aGlzLmNoaWxkTm9kZXNFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gZWxlbWVudCAmJiBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICBpZiAocGFyZW50Tm9kZSAmJiBwYXJlbnROb2RlLm5vZGVUeXBlID09IDEpIHBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgfQogICAgICB9OwogICAgfTsKICAgIHZhciBDb250YWluZXJUZW1wbGF0ZU1peGluID0gZnVuY3Rpb24oc3VwZXJfKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgaW5zZXJ0QmVmb3JlOiBmdW5jdGlvbihuZXdDaGlsZCwgcmVmQ2hpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLm5vQ2hpbGROb2Rlc0VsZW1lbnRfKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vQ2hpbGROb2Rlc0VsZW1lbnRfOwogICAgICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMudWk6IFRlbXBsYXRlIGhhcyBubyBjaGlsZE5vZGVzRWxlbWVudCBjb250YWluZXIsIGJ1dCBpbnNlcnRCZWZvcmUgbWV0aG9kIGNhbGxlZDsgcHJvYmFibHkgaXQncyBhIGJ1ZyIpOwogICAgICAgICAgfQogICAgICAgICAgbmV3Q2hpbGQgPSBzdXBlcl8uaW5zZXJ0QmVmb3JlLmNhbGwodGhpcywgbmV3Q2hpbGQsIHJlZkNoaWxkKTsKICAgICAgICAgIHZhciB0YXJnZXQgPSBuZXdDaGlsZC5ncm91cE5vZGUgfHwgdGhpczsKICAgICAgICAgIHZhciBjb250YWluZXIgPSB0YXJnZXQuY2hpbGROb2Rlc0VsZW1lbnQgfHwgdGhpcy5jaGlsZE5vZGVzRWxlbWVudDsKICAgICAgICAgIHZhciBuZXh0U2libGluZyA9IG5ld0NoaWxkLm5leHRTaWJsaW5nOwogICAgICAgICAgdmFyIGluc2VydFBvaW50ID0gbmV4dFNpYmxpbmcgJiYgbmV4dFNpYmxpbmcuZWxlbWVudC5wYXJlbnROb2RlID09IGNvbnRhaW5lciA/IG5leHRTaWJsaW5nLmVsZW1lbnQgOiBudWxsOwogICAgICAgICAgdmFyIGNoaWxkRWxlbWVudCA9IG5ld0NoaWxkLmVsZW1lbnQ7CiAgICAgICAgICB2YXIgcmVmTm9kZSA9IGluc2VydFBvaW50IHx8IGNvbnRhaW5lci5pbnNlcnRQb2ludCB8fCBudWxsOwogICAgICAgICAgaWYgKGNoaWxkRWxlbWVudC5wYXJlbnROb2RlICE9PSBjb250YWluZXIgfHwgY2hpbGRFbGVtZW50Lm5leHRTaWJsaW5nICE9PSByZWZOb2RlKSBjb250YWluZXIuaW5zZXJ0QmVmb3JlKGNoaWxkRWxlbWVudCwgcmVmTm9kZSk7CiAgICAgICAgICByZXR1cm4gbmV3Q2hpbGQ7CiAgICAgICAgfSwKICAgICAgICByZW1vdmVDaGlsZDogZnVuY3Rpb24ob2xkQ2hpbGQpIHsKICAgICAgICAgIHN1cGVyXy5yZW1vdmVDaGlsZC5jYWxsKHRoaXMsIG9sZENoaWxkKTsKICAgICAgICAgIHZhciBlbGVtZW50ID0gb2xkQ2hpbGQuZWxlbWVudDsKICAgICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICBpZiAocGFyZW50KSBwYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgICByZXR1cm4gb2xkQ2hpbGQ7CiAgICAgICAgfSwKICAgICAgICBjbGVhcjogZnVuY3Rpb24oYWxpdmUpIHsKICAgICAgICAgIGlmIChhbGl2ZSkgewogICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMuZmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IG5vZGUuZWxlbWVudDsKICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICAgIGlmIChwYXJlbnQpIHBhcmVudC5yZW1vdmVDaGlsZChlbGVtZW50KTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3VwZXJfLmNsZWFyLmNhbGwodGhpcywgYWxpdmUpOwogICAgICAgIH0sCiAgICAgICAgc2V0Q2hpbGROb2RlczogZnVuY3Rpb24oY2hpbGROb2Rlcywga2VlcEFsaXZlKSB7CiAgICAgICAgICBpZiAodGhpcy5ub0NoaWxkTm9kZXNFbGVtZW50XykgewogICAgICAgICAgICBkZWxldGUgdGhpcy5ub0NoaWxkTm9kZXNFbGVtZW50XzsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLnVpOiBUZW1wbGF0ZSBoYXMgbm8gY2hpbGROb2Rlc0VsZW1lbnQgY29udGFpbmVyLCBidXQgc2V0Q2hpbGROb2RlcyBtZXRob2QgY2FsbGVkOyBwcm9iYWJseSBpdCdzIGEgYnVnIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZG9tRnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcy5ncm91cGluZyB8fCB0aGlzOwogICAgICAgICAgdmFyIGNvbnRhaW5lciA9IHRhcmdldC5jaGlsZE5vZGVzRWxlbWVudDsKICAgICAgICAgIHRhcmdldC5jaGlsZE5vZGVzRWxlbWVudCA9IGRvbUZyYWdtZW50OwogICAgICAgICAgc3VwZXJfLnNldENoaWxkTm9kZXMuY2FsbCh0aGlzLCBjaGlsZE5vZGVzLCBrZWVwQWxpdmUpOwogICAgICAgICAgY29udGFpbmVyLmluc2VydEJlZm9yZShkb21GcmFnbWVudCwgY29udGFpbmVyLmluc2VydFBvaW50IHx8IG51bGwpOwogICAgICAgICAgdGFyZ2V0LmNoaWxkTm9kZXNFbGVtZW50ID0gY29udGFpbmVyOwogICAgICAgIH0KICAgICAgfTsKICAgIH07CiAgICB2YXIgUGFydGl0aW9uTm9kZSA9IENsYXNzKERXUGFydGl0aW9uTm9kZSwgVGVtcGxhdGVNaXhpbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuUGFydGl0aW9uTm9kZSIsCiAgICAgIGJpbmRpbmc6IHsKICAgICAgICB0aXRsZTogImRhdGE6IgogICAgICB9CiAgICB9KTsKICAgIHZhciBHcm91cGluZ05vZGUgPSBDbGFzcyhEV0dyb3VwaW5nTm9kZSwgQ29udGFpbmVyVGVtcGxhdGVNaXhpbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuR3JvdXBpbmdOb2RlIiwKICAgICAgY2hpbGRDbGFzczogUGFydGl0aW9uTm9kZSwKICAgICAgZ3JvdXBpbmdDbGFzczogQ2xhc3MuU0VMRiwKICAgICAgZWxlbWVudDogbnVsbCwKICAgICAgY2hpbGROb2Rlc0VsZW1lbnQ6IG51bGwsCiAgICAgIGVtaXRfb3duZXJDaGFuZ2VkOiBmdW5jdGlvbihvbGRPd25lcikgewogICAgICAgIHRoaXMuc3luY0RvbVJlZnMoKTsKICAgICAgICBEV0dyb3VwaW5nTm9kZS5wcm90b3R5cGUuZW1pdF9vd25lckNoYW5nZWQuY2FsbCh0aGlzLCBvbGRPd25lcik7CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZWxlbWVudCA9IHRoaXMuY2hpbGROb2Rlc0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgRFdHcm91cGluZ05vZGUucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICBpbnN0YW5jZXNbdGhpcy5iYXNpc09iamVjdElkXSA9IHRoaXM7CiAgICAgICAgbm90aWZpZXIuc2V0KHsKICAgICAgICAgIGFjdGlvbjogImNyZWF0ZSIsCiAgICAgICAgICBpbnN0YW5jZTogdGhpcwogICAgICAgIH0pOwogICAgICB9LAogICAgICBzeW5jRG9tUmVmczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgdmFyIG93bmVyID0gdGhpcy5vd25lcjsKICAgICAgICB2YXIgZWxlbWVudCA9IG51bGw7CiAgICAgICAgaWYgKG93bmVyKSBlbGVtZW50ID0gb3duZXIudG1wbCAmJiBvd25lci50bXBsLmdyb3Vwc0VsZW1lbnQgfHwgb3duZXIuY2hpbGROb2Rlc0VsZW1lbnQ7CiAgICAgICAgZG8gewogICAgICAgICAgY3Vyc29yLmVsZW1lbnQgPSBjdXJzb3IuY2hpbGROb2Rlc0VsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIH0gd2hpbGUgKGN1cnNvciA9IGN1cnNvci5ncm91cGluZyk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGRlbGV0ZSBpbnN0YW5jZXNbdGhpcy5iYXNpc09iamVjdElkXTsKICAgICAgICBub3RpZmllci5zZXQoewogICAgICAgICAgYWN0aW9uOiAiZGVzdHJveSIsCiAgICAgICAgICBpbnN0YW5jZTogdGhpcwogICAgICAgIH0pOwogICAgICAgIERXR3JvdXBpbmdOb2RlLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5lbGVtZW50ID0gbnVsbDsKICAgICAgICB0aGlzLmNoaWxkTm9kZXNFbGVtZW50ID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgTm9kZSA9IENsYXNzKERXTm9kZSwgVGVtcGxhdGVNaXhpbiwgQ29udGFpbmVyVGVtcGxhdGVNaXhpbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTm9kZSIsCiAgICAgIGJpbmRpbmc6IHsKICAgICAgICBzZWxlY3RlZDogewogICAgICAgICAgZXZlbnRzOiAic2VsZWN0IHVuc2VsZWN0IiwKICAgICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZS5zZWxlY3RlZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHVuc2VsZWN0ZWQ6IHsKICAgICAgICAgIGV2ZW50czogInNlbGVjdCB1bnNlbGVjdCIsCiAgICAgICAgICBnZXR0ZXI6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuICFub2RlLnNlbGVjdGVkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZGlzYWJsZWQ6IHsKICAgICAgICAgIGV2ZW50czogImRpc2FibGUgZW5hYmxlIiwKICAgICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZS5pc0Rpc2FibGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBlbmFibGVkOiB7CiAgICAgICAgICBldmVudHM6ICJkaXNhYmxlIGVuYWJsZSIsCiAgICAgICAgICBnZXR0ZXI6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuICFub2RlLmlzRGlzYWJsZWQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNoaWxkQ2xhc3M6IENsYXNzLlNFTEYsCiAgICAgIGNoaWxkRmFjdG9yeTogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgcmV0dXJuIG5ldyB0aGlzLmNoaWxkQ2xhc3MoY29uZmlnKTsKICAgICAgfSwKICAgICAgZ3JvdXBpbmdDbGFzczogR3JvdXBpbmdOb2RlCiAgICB9KTsKICAgIHZhciBTaGFkb3dOb2RlTGlzdCA9IE5vZGUuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU2hhZG93Tm9kZUxpc3QiLAogICAgICBlbWl0X293bmVyQ2hhbmdlZDogZnVuY3Rpb24ob2xkT3duZXIpIHsKICAgICAgICBOb2RlLnByb3RvdHlwZS5lbWl0X293bmVyQ2hhbmdlZC5jYWxsKHRoaXMsIG9sZE93bmVyKTsKICAgICAgICB0aGlzLnNldERhdGFTb3VyY2UodGhpcy5vd25lciAmJiB0aGlzLm93bmVyLmdldENoaWxkTm9kZXNEYXRhc2V0KCkpOwogICAgICB9LAogICAgICBnZXRDaGlsZE5vZGVzRWxlbWVudDogZnVuY3Rpb24ob3duZXIpIHsKICAgICAgICByZXR1cm4gb3duZXIuY2hpbGROb2Rlc0VsZW1lbnQ7CiAgICAgIH0sCiAgICAgIGxpc3RlbjogewogICAgICAgIG93bmVyOiB7CiAgICAgICAgICB0ZW1wbGF0ZUNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmNoaWxkTm9kZXMuZm9yRWFjaChmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQoY2hpbGQuZWxlbWVudCk7CiAgICAgICAgICAgIH0sIHRoaXMuZ2V0Q2hpbGROb2Rlc0VsZW1lbnQodGhpcy5vd25lcikgfHwgdGhpcy5vd25lci5lbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNoaWxkQ2xhc3M6IHsKICAgICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU2hhZG93Tm9kZSIsCiAgICAgICAgZ2V0RWxlbWVudDogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUuZWxlbWVudDsKICAgICAgICB9LAogICAgICAgIHRlbXBsYXRlU3luYzogZnVuY3Rpb24oKSB7CiAgICAgICAgICBOb2RlLnByb3RvdHlwZS50ZW1wbGF0ZVN5bmMuY2FsbCh0aGlzKTsKICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gdGhpcy5nZXRFbGVtZW50KHRoaXMuZGVsZWdhdGUpOwogICAgICAgICAgaWYgKG5ld0VsZW1lbnQpIHsKICAgICAgICAgICAgbmV3RWxlbWVudFtodG1sVGVtcGxhdGVJZE1hcmtlcl0gPSB0aGlzLmRlbGVnYXRlLmVsZW1lbnRbaHRtbFRlbXBsYXRlSWRNYXJrZXJdOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQgPSBuZXdFbGVtZW50OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbGlzdGVuOiB7CiAgICAgICAgICBkZWxlZ2F0ZTogewogICAgICAgICAgICB0ZW1wbGF0ZUNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBvbGRFbGVtZW50ID0gdGhpcy5lbGVtZW50OwogICAgICAgICAgICAgIHZhciBvbGRFbGVtZW50UGFyZW50ID0gb2xkRWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gdGhpcy5nZXRFbGVtZW50KHRoaXMuZGVsZWdhdGUpOwogICAgICAgICAgICAgIGlmIChuZXdFbGVtZW50KSBuZXdFbGVtZW50W2h0bWxUZW1wbGF0ZUlkTWFya2VyXSA9IHRoaXMuZGVsZWdhdGUuZWxlbWVudFtodG1sVGVtcGxhdGVJZE1hcmtlcl07CiAgICAgICAgICAgICAgdGhpcy5lbGVtZW50ID0gbmV3RWxlbWVudCB8fCB0aGlzLnRtcGwuZWxlbWVudDsKICAgICAgICAgICAgICBpZiAob2xkRWxlbWVudFBhcmVudCkgb2xkRWxlbWVudFBhcmVudC5yZXBsYWNlQ2hpbGQodGhpcy5lbGVtZW50LCBvbGRFbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZGVidWdfbm90aWZpZXI6IG5vdGlmaWVyLAogICAgICBkZWJ1Z19nZXRJbnN0YW5jZXM6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBiYXNpcy5vYmplY3QudmFsdWVzKGluc3RhbmNlcyk7CiAgICAgIH0sCiAgICAgIEJJTkRJTkdfUFJFU0VUOiBCSU5ESU5HX1BSRVNFVCwKICAgICAgTm9kZTogTm9kZSwKICAgICAgUGFydGl0aW9uTm9kZTogUGFydGl0aW9uTm9kZSwKICAgICAgR3JvdXBpbmdOb2RlOiBHcm91cGluZ05vZGUsCiAgICAgIFNoYWRvd05vZGVMaXN0OiBTaGFkb3dOb2RlTGlzdCwKICAgICAgU2hhZG93Tm9kZTogU2hhZG93Tm9kZUxpc3QucHJvdG90eXBlLmNoaWxkQ2xhc3MKICAgIH07CiAgfSwKICAiZS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyOwogICAgdmFyIGNsZWFuZXIgPSBiYXNpcy5jbGVhbmVyOwogICAgdmFyIEVtaXR0ZXIgPSBiYXNpcy5ldmVudC5FbWl0dGVyOwogICAgdmFyIEFic3RyYWN0RGF0YSA9IGJhc2lzLmRhdGEuQWJzdHJhY3REYXRhOwogICAgdmFyIFZhbHVlID0gYmFzaXMuZGF0YS5WYWx1ZTsKICAgIHZhciBTVEFURSA9IGJhc2lzLmRhdGEuU1RBVEU7CiAgICB2YXIgUHJvcGVydHkgPSBWYWx1ZS5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Qcm9wZXJ0eSIsCiAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogZmFsc2UsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKGluaXRWYWx1ZSwgaGFuZGxlciwgcHJveHkpIHsKICAgICAgICB0aGlzLnZhbHVlID0gaW5pdFZhbHVlOwogICAgICAgIHRoaXMuaGFuZGxlciA9IGhhbmRsZXI7CiAgICAgICAgdGhpcy5wcm94eSA9IHByb3h5OwogICAgICAgIFZhbHVlLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIE9CSkVDVFNFVF9TVEFURV9QUklPUklUWSA9IFNUQVRFLnByaW9yaXR5OwogICAgdmFyIE9CSkVDVFNFVF9IQU5ETEVSID0gewogICAgICBzdGF0ZUNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZmlyZShmYWxzZSwgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIHVwZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5maXJlKHRydWUpOwogICAgICB9LAogICAgICBjaGFuZ2U6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZmlyZSh0cnVlKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgdGhpcy5yZW1vdmUob2JqZWN0KTsKICAgICAgfQogICAgfTsKICAgIHZhciBPYmplY3RTZXQgPSBWYWx1ZS5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5PYmplY3RTZXQiLAogICAgICBvYmplY3RzOiBudWxsLAogICAgICB2YWx1ZTogMCwKICAgICAgdmFsdWVDaGFuZ2VkXzogZmFsc2UsCiAgICAgIGNhbGN1bGF0ZVZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy52YWx1ZSArIDE7CiAgICAgIH0sCiAgICAgIGNhbGN1bGF0ZU9uSW5pdDogZmFsc2UsCiAgICAgIHN0YXRlUHJpb3JpdHk6IE9CSkVDVFNFVF9TVEFURV9QUklPUklUWSwKICAgICAgc3RhdGVDaGFuZ2VkXzogdHJ1ZSwKICAgICAgdGltZXJfOiBmYWxzZSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgVmFsdWUucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB2YXIgb2JqZWN0cyA9IHRoaXMub2JqZWN0czsKICAgICAgICB0aGlzLm9iamVjdHMgPSBbXTsKICAgICAgICBpZiAob2JqZWN0cyAmJiBBcnJheS5pc0FycmF5KG9iamVjdHMpKSB7CiAgICAgICAgICB0aGlzLmxvY2soKTsKICAgICAgICAgIHRoaXMuYWRkLmFwcGx5KHRoaXMsIG9iamVjdHMpOwogICAgICAgICAgdGhpcy51bmxvY2soKTsKICAgICAgICB9CiAgICAgICAgdGhpcy52YWx1ZUNoYW5nZWRfID0gdGhpcy5zdGF0ZUNoYW5nZWRfID0gISF0aGlzLmNhbGN1bGF0ZU9uSW5pdDsKICAgICAgICB0aGlzLnVwZGF0ZSgpOwogICAgICB9LAogICAgICBhZGQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIHZhciBvYmplY3QgPSBhcmd1bWVudHNbaV07CiAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgQWJzdHJhY3REYXRhKSB7CiAgICAgICAgICAgIGlmIChiYXNpcy5hcnJheS5hZGQodGhpcy5vYmplY3RzLCBvYmplY3QpKSBvYmplY3QuYWRkSGFuZGxlcihPQkpFQ1RTRVRfSEFORExFUiwgdGhpcyk7CiAgICAgICAgICB9IGVsc2UgdGhyb3cgdGhpcy5jb25zdHJ1Y3Rvci5jbGFzc05hbWUgKyAiI2FkZDogSW5zdGFuY2Ugb2YgQWJzdHJhY3REYXRhIHJlcXVpcmVkIjsKICAgICAgICB9CiAgICAgICAgdGhpcy5maXJlKHRydWUsIHRydWUpOwogICAgICB9LAogICAgICByZW1vdmU6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIGlmIChiYXNpcy5hcnJheS5yZW1vdmUodGhpcy5vYmplY3RzLCBvYmplY3QpKSBvYmplY3QucmVtb3ZlSGFuZGxlcihPQkpFQ1RTRVRfSEFORExFUiwgdGhpcyk7CiAgICAgICAgdGhpcy5maXJlKHRydWUsIHRydWUpOwogICAgICB9LAogICAgICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIG9iamVjdDsgb2JqZWN0ID0gdGhpcy5vYmplY3RzW2ldOyBpKyspIG9iamVjdC5yZW1vdmVIYW5kbGVyKE9CSkVDVFNFVF9IQU5ETEVSLCB0aGlzKTsKICAgICAgICB0aGlzLm9iamVjdHMubGVuZ3RoID0gMDsKICAgICAgICB0aGlzLmZpcmUodHJ1ZSwgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIGZpcmU6IGZ1bmN0aW9uKHZhbHVlQ2hhbmdlZCwgc3RhdGVDaGFuZ2VkKSB7CiAgICAgICAgaWYgKCF0aGlzLmxvY2tlZCkgewogICAgICAgICAgdGhpcy52YWx1ZUNoYW5nZWRfID0gdGhpcy52YWx1ZUNoYW5nZWRfIHx8ICEhdmFsdWVDaGFuZ2VkOwogICAgICAgICAgdGhpcy5zdGF0ZUNoYW5nZWRfID0gdGhpcy5zdGF0ZUNoYW5nZWRfIHx8ICEhc3RhdGVDaGFuZ2VkOwogICAgICAgICAgaWYgKCF0aGlzLnRpbWVyXyAmJiAodGhpcy52YWx1ZUNoYW5nZWRfIHx8IHRoaXMuc3RhdGVDaGFuZ2VkXykpIHRoaXMudGltZXJfID0gYmFzaXMuc2V0SW1tZWRpYXRlKHRoaXMudXBkYXRlLmJpbmQodGhpcykpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgbG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5sb2NrZWQgPSB0cnVlOwogICAgICB9LAogICAgICB1bmxvY2s6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubG9ja2VkID0gZmFsc2U7CiAgICAgIH0sCiAgICAgIHVwZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHZhbHVlQ2hhbmdlZCA9IHRoaXMudmFsdWVDaGFuZ2VkXzsKICAgICAgICB2YXIgc3RhdGVDaGFuZ2VkID0gdGhpcy5zdGF0ZUNoYW5nZWRfOwogICAgICAgIHRoaXMudmFsdWVDaGFuZ2VkXyA9IGZhbHNlOwogICAgICAgIHRoaXMuc3RhdGVDaGFuZ2VkXyA9IGZhbHNlOwogICAgICAgIHRoaXMudGltZXJfID0gYmFzaXMuY2xlYXJJbW1lZGlhdGUodGhpcy50aW1lcl8pOwogICAgICAgIGlmICghY2xlYW5lci5nbG9iYWxEZXN0cm95KSB7CiAgICAgICAgICBpZiAodmFsdWVDaGFuZ2VkKSB0aGlzLnNldCh0aGlzLmNhbGN1bGF0ZVZhbHVlKCkpOwogICAgICAgICAgaWYgKHN0YXRlQ2hhbmdlZCkgewogICAgICAgICAgICB2YXIgbGVuID0gdGhpcy5vYmplY3RzLmxlbmd0aDsKICAgICAgICAgICAgaWYgKCFsZW4pIHRoaXMuc2V0U3RhdGUoU1RBVEUuVU5ERUZJTkVEKTsgZWxzZSB7CiAgICAgICAgICAgICAgdmFyIG1heFdlaWdodCA9IC0yOwogICAgICAgICAgICAgIHZhciBjdXJPYmplY3Q7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgdmFyIG9iamVjdCA9IHRoaXMub2JqZWN0c1tpXTsKICAgICAgICAgICAgICAgIHZhciB3ZWlnaHQgPSB0aGlzLnN0YXRlUHJpb3JpdHkuaW5kZXhPZihTdHJpbmcob2JqZWN0LnN0YXRlKSk7CiAgICAgICAgICAgICAgICBpZiAod2VpZ2h0ID4gbWF4V2VpZ2h0KSB7CiAgICAgICAgICAgICAgICAgIGN1ck9iamVjdCA9IG9iamVjdDsKICAgICAgICAgICAgICAgICAgbWF4V2VpZ2h0ID0gd2VpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY3VyT2JqZWN0KSB0aGlzLnNldFN0YXRlKGN1ck9iamVjdC5zdGF0ZSwgY3VyT2JqZWN0LnN0YXRlLmRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmxvY2soKTsKICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgaWYgKHRoaXMudGltZXJfKSBiYXNpcy5jbGVhckltbWVkaWF0ZSh0aGlzLnRpbWVyXyk7CiAgICAgICAgVmFsdWUucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgRXhwcmVzc2lvbiA9IFByb3BlcnR5LnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkV4cHJlc3Npb24iLAogICAgICBpbml0OiBmdW5jdGlvbihhcmdzLCBjYWxjKSB7CiAgICAgICAgVmFsdWUucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB2YXIgYXJncyA9IGJhc2lzLmFycmF5KGFyZ3VtZW50cyk7CiAgICAgICAgdmFyIGNhbGMgPSBhcmdzLnBvcCgpOwogICAgICAgIGlmICh0eXBlb2YgY2FsYyAhPSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2Fybih0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSArICI6IGxhc3QgYXJndW1lbnQgb2YgY29uc3RydWN0b3IgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgICAgICBjYWxjID0gYmFzaXMuZm4uJHVuZGVmOwogICAgICAgIH0KICAgICAgICBpZiAoYXJncy5sZW5ndGggPT0gMSkgewogICAgICAgICAgYXJnc1swXS5saW5rKHRoaXMsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuc2V0KGNhbGMuY2FsbCh0aGlzLCB2YWx1ZSkpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChhcmdzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgIHZhciBjaGFuZ2VXYXRjaGVyID0gbmV3IE9iamVjdFNldCh7CiAgICAgICAgICAgIG9iamVjdHM6IGFyZ3MsCiAgICAgICAgICAgIGNhbGN1bGF0ZU9uSW5pdDogdHJ1ZSwKICAgICAgICAgICAgY2FsY3VsYXRlVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBjYWxjLmFwcGx5KHRoaXMsIGFyZ3MubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICAgIHJldHVybiBpdGVtLnZhbHVlOwogICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBjaGFuZ2VXYXRjaGVyLmxpbmsodGhpcywgdGhpcy5zZXQpOwogICAgICAgICAgdGhpcy5hZGRIYW5kbGVyKHsKICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCFjbGVhbmVyLmdsb2JhbERlc3Ryb3kpIGNoYW5nZVdhdGNoZXIuZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFByb3BlcnR5OiBQcm9wZXJ0eSwKICAgICAgT2JqZWN0U2V0OiBPYmplY3RTZXQsCiAgICAgIEV4cHJlc3Npb246IEV4cHJlc3Npb24KICAgIH07CiAgfSwKICAiZi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2QuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZS5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBDbGFzcyA9IGJhc2lzLkNsYXNzOwogICAgdmFyIERhdGFPYmplY3QgPSBiYXNpcy5kYXRhLk9iamVjdDsKICAgIHZhciBLZXlPYmplY3RNYXAgPSBiYXNpcy5kYXRhLktleU9iamVjdE1hcDsKICAgIHZhciBSZWFkT25seURhdGFzZXQgPSBiYXNpcy5kYXRhLlJlYWRPbmx5RGF0YXNldDsKICAgIHZhciBEYXRhc2V0V3JhcHBlciA9IGJhc2lzLmRhdGEuRGF0YXNldFdyYXBwZXI7CiAgICB2YXIgVmFsdWUgPSBiYXNpcy5kYXRhLlZhbHVlOwogICAgdmFyIE1hcEZpbHRlciA9IGJhc2lzLmRhdGEuZGF0YXNldC5NYXBGaWx0ZXI7CiAgICBmdW5jdGlvbiBiaW5hcnlTZWFyY2hQb3MoYXJyYXksIHZhbHVlKSB7CiAgICAgIGlmICghYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgdmFyIHBvczsKICAgICAgdmFyIGNtcFZhbHVlOwogICAgICB2YXIgbCA9IDA7CiAgICAgIHZhciByID0gYXJyYXkubGVuZ3RoIC0gMTsKICAgICAgZG8gewogICAgICAgIHBvcyA9IGwgKyByID4+IDE7CiAgICAgICAgY21wVmFsdWUgPSBhcnJheVtwb3NdIHx8IDA7CiAgICAgICAgaWYgKHZhbHVlIDwgY21wVmFsdWUpIHIgPSBwb3MgLSAxOyBlbHNlIGlmICh2YWx1ZSA+IGNtcFZhbHVlKSBsID0gcG9zICsgMTsgZWxzZSByZXR1cm4gdmFsdWUgPT0gY21wVmFsdWUgPyBwb3MgOiAwOwogICAgICB9IHdoaWxlIChsIDw9IHIpOwogICAgICByZXR1cm4gcG9zICsgKGNtcFZhbHVlIDwgdmFsdWUpOwogICAgfQogICAgdmFyIEluZGV4ID0gQ2xhc3MoVmFsdWUsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkluZGV4IiwKICAgICAgYXV0b0Rlc3Ryb3k6IHRydWUsCiAgICAgIGluZGV4Q2FjaGVfOiBudWxsLAogICAgICB2YWx1ZUdldHRlcjogYmFzaXMuZm4uJG51bGwsCiAgICAgIHVwZGF0ZUV2ZW50czoge30sCiAgICAgIHZhbHVlOiAwLAogICAgICBzZXROdWxsT25FbWl0dGVyRGVzdHJveTogZmFsc2UsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaW5kZXhDYWNoZV8gPSB7fTsKICAgICAgICBWYWx1ZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBhZGRfOiBmdW5jdGlvbih2YWx1ZSkge30sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7fSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7fSwKICAgICAgbm9ybWFsaXplOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBOdW1iZXIodmFsdWUpIHx8IDA7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIFZhbHVlLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5pbmRleENhY2hlXyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFN1bSA9IENsYXNzKEluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TdW0iLAogICAgICBhZGRfOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgKz0gdmFsdWU7CiAgICAgIH0sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy52YWx1ZSAtPSB2YWx1ZTsKICAgICAgfSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXQodGhpcy52YWx1ZSAtIG9sZFZhbHVlICsgbmV3VmFsdWUpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBDb3VudCA9IENsYXNzKEluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Db3VudCIsCiAgICAgIHZhbHVlR2V0dGVyOiBiYXNpcy5mbi4kdHJ1ZSwKICAgICAgYWRkXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnZhbHVlICs9IHZhbHVlOwogICAgICB9LAogICAgICByZW1vdmVfOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgLT0gdmFsdWU7CiAgICAgIH0sCiAgICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gISF2YWx1ZTsKICAgICAgfSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXQodGhpcy52YWx1ZSAtICEhb2xkVmFsdWUgKyAhIW5ld1ZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgQXZnID0gQ2xhc3MoSW5kZXgsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkF2ZyIsCiAgICAgIHN1bV86IDAsCiAgICAgIGNvdW50XzogMCwKICAgICAgYWRkXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnN1bV8gKz0gdmFsdWU7CiAgICAgICAgdGhpcy5jb3VudF8gKz0gMTsKICAgICAgICB0aGlzLnZhbHVlID0gdGhpcy5zdW1fIC8gdGhpcy5jb3VudF87CiAgICAgIH0sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5zdW1fIC09IHZhbHVlOwogICAgICAgIHRoaXMuY291bnRfIC09IDE7CiAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMuY291bnRfID8gdGhpcy5zdW1fIC8gdGhpcy5jb3VudF8gOiAwOwogICAgICB9LAogICAgICB1cGRhdGVfOiBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICB0aGlzLnN1bV8gKz0gbmV3VmFsdWUgLSBvbGRWYWx1ZTsKICAgICAgICB0aGlzLnNldCh0aGlzLnN1bV8gLyB0aGlzLmNvdW50Xyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFZlY3RvckluZGV4ID0gQ2xhc3MoSW5kZXgsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlZlY3RvckluZGV4IiwKICAgICAgdmVjdG9yR2V0dGVyOiBiYXNpcy5mbi4kbnVsbCwKICAgICAgdmVjdG9yXzogbnVsbCwKICAgICAgdmFsdWU6IHVuZGVmaW5lZCwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy52ZWN0b3JfID0gW107CiAgICAgICAgSW5kZXgucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgYWRkXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgIHRoaXMudmVjdG9yXy5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKHRoaXMudmVjdG9yXywgdmFsdWUpLCAwLCB2YWx1ZSk7CiAgICAgICAgICB0aGlzLnZhbHVlID0gdGhpcy52ZWN0b3JHZXR0ZXIodGhpcy52ZWN0b3JfKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICB0aGlzLnZlY3Rvcl8uc3BsaWNlKGJpbmFyeVNlYXJjaFBvcyh0aGlzLnZlY3Rvcl8sIHZhbHVlKSwgMSk7CiAgICAgICAgICB0aGlzLnZhbHVlID0gdGhpcy52ZWN0b3JHZXR0ZXIodGhpcy52ZWN0b3JfKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHVwZGF0ZV86IGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbnVsbCkgdGhpcy52ZWN0b3JfLnNwbGljZShiaW5hcnlTZWFyY2hQb3ModGhpcy52ZWN0b3JfLCBvbGRWYWx1ZSksIDEpOwogICAgICAgIGlmIChuZXdWYWx1ZSAhPT0gbnVsbCkgdGhpcy52ZWN0b3JfLnNwbGljZShiaW5hcnlTZWFyY2hQb3ModGhpcy52ZWN0b3JfLCBuZXdWYWx1ZSksIDAsIG5ld1ZhbHVlKTsKICAgICAgICB0aGlzLnNldCh0aGlzLnZlY3RvckdldHRlcih0aGlzLnZlY3Rvcl8pKTsKICAgICAgfSwKICAgICAgbm9ybWFsaXplOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIgfHwgdHlwZW9mIHZhbHVlID09ICJudW1iZXIiID8gdmFsdWUgOiBudWxsOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBJbmRleC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMudmVjdG9yXyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIE1pbiA9IENsYXNzKFZlY3RvckluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5NaW4iLAogICAgICB2ZWN0b3JHZXR0ZXI6IGZ1bmN0aW9uKHZlY3RvcikgewogICAgICAgIHJldHVybiB2ZWN0b3JbMF07CiAgICAgIH0KICAgIH0pOwogICAgdmFyIE1heCA9IENsYXNzKFZlY3RvckluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5NYXgiLAogICAgICB2ZWN0b3JHZXR0ZXI6IGZ1bmN0aW9uKHZlY3RvcikgewogICAgICAgIHJldHVybiB2ZWN0b3JbdmVjdG9yLmxlbmd0aCAtIDFdOwogICAgICB9CiAgICB9KTsKICAgIHZhciBEaXN0aW5jdCA9IENsYXNzKEluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5EaXN0aW5jdCIsCiAgICAgIG1hcF86IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubWFwXyA9IHt9OwogICAgICAgIEluZGV4LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGFkZF86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKCF0aGlzLm1hcF8uaGFzT3duUHJvcGVydHkodmFsdWUpKSB0aGlzLm1hcF9bdmFsdWVdID0gMDsKICAgICAgICBpZiAoKyt0aGlzLm1hcF9bdmFsdWVdID09IDEpIHRoaXMudmFsdWUgKz0gMTsKICAgICAgfSwKICAgICAgcmVtb3ZlXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAoLS10aGlzLm1hcF9bdmFsdWVdID09IDApIHRoaXMudmFsdWUgLT0gMTsKICAgICAgfSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdmFyIGRlbHRhID0gMDsKICAgICAgICBpZiAoIXRoaXMubWFwXy5oYXNPd25Qcm9wZXJ0eShuZXdWYWx1ZSkpIHRoaXMubWFwX1tuZXdWYWx1ZV0gPSAwOwogICAgICAgIGlmICgrK3RoaXMubWFwX1tuZXdWYWx1ZV0gPT0gMSkgZGVsdGEgKz0gMTsKICAgICAgICBpZiAoLS10aGlzLm1hcF9bb2xkVmFsdWVdID09IDApIGRlbHRhIC09IDE7CiAgICAgICAgaWYgKGRlbHRhKSB0aGlzLnNldCh0aGlzLnZhbHVlICsgZGVsdGEpOwogICAgICB9LAogICAgICBub3JtYWxpemU6IFN0cmluZywKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgSW5kZXgucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLm1hcF8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBpbmRleENvbnN0cnVjdG9yc18gPSB7fTsKICAgIHZhciBEQVRBU0VUX0lOREVYX0hBTkRMRVIgPSB7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHJlbW92ZURhdGFzZXRJbmRleCh0aGlzLCBvYmplY3QpOwogICAgICB9CiAgICB9OwogICAgZnVuY3Rpb24gSW5kZXhDb25zdHJ1Y3RvcigpIHt9CiAgICBmdW5jdGlvbiBnZXRJbmRleENvbnN0cnVjdG9yKEJhc2VDbGFzcywgZ2V0dGVyLCBldmVudHMpIHsKICAgICAgaWYgKCFDbGFzcy5pc0NsYXNzKEJhc2VDbGFzcykgfHwgIUJhc2VDbGFzcy5pc1N1YmNsYXNzT2YoSW5kZXgpKSB0aHJvdyAiV3JvbmcgY2xhc3MgZm9yIGluZGV4IGNvbnN0cnVjdG9yIjsKICAgICAgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyKGdldHRlcik7CiAgICAgIGV2ZW50cyA9IGV2ZW50cyB8fCAidXBkYXRlIjsKICAgICAgaWYgKHR5cGVvZiBldmVudHMgIT0gInN0cmluZyIpIHRocm93ICJFdmVudHMgbXVzdCBiZSBhIGV2ZW50IG5hbWVzIHNwYWNlIHNlcGFyYXRlZCBzdHJpbmciOwogICAgICBldmVudHMgPSBldmVudHMudHJpbSgpLnNwbGl0KCIgIikuc29ydCgpOwogICAgICB2YXIgaW5kZXhJZCA9IFsgQmFzZUNsYXNzLmJhc2lzQ2xhc3NJZF8sIGdldHRlcltiYXNpcy5nZXR0ZXIuSURdLCBldmVudHMgXS5qb2luKCJfIik7CiAgICAgIHZhciBpbmRleENvbnN0cnVjdG9yID0gaW5kZXhDb25zdHJ1Y3RvcnNfW2luZGV4SWRdOwogICAgICBpZiAoaW5kZXhDb25zdHJ1Y3RvcikgcmV0dXJuIGluZGV4Q29uc3RydWN0b3Iub3duZXI7CiAgICAgIHZhciBldmVudHNfID0ge307CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgaSsrKSBldmVudHNfW2V2ZW50c1tpXV0gPSB0cnVlOwogICAgICBpbmRleENvbnN0cnVjdG9yID0gbmV3IEluZGV4Q29uc3RydWN0b3I7CiAgICAgIGluZGV4Q29uc3RydWN0b3JzX1tpbmRleElkXSA9IHsKICAgICAgICBvd25lcjogaW5kZXhDb25zdHJ1Y3RvciwKICAgICAgICBpbmRleENsYXNzOiBCYXNlQ2xhc3Muc3ViY2xhc3MoewogICAgICAgICAgaW5kZXhJZDogaW5kZXhJZCwKICAgICAgICAgIHVwZGF0ZUV2ZW50czogZXZlbnRzXywKICAgICAgICAgIHZhbHVlR2V0dGVyOiBnZXR0ZXIKICAgICAgICB9KQogICAgICB9OwogICAgICBpbmRleENvbnN0cnVjdG9yLmluZGV4SWQgPSBpbmRleElkOwogICAgICByZXR1cm4gaW5kZXhDb25zdHJ1Y3RvcjsKICAgIH0KICAgIHZhciBjcmVhdGVJbmRleENvbnN0cnVjdG9yID0gZnVuY3Rpb24oSW5kZXhDbGFzcywgZGVmR2V0dGVyKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihldmVudHMsIGdldHRlcikgewogICAgICAgIHZhciBkYXRhc2V0OwogICAgICAgIGlmIChldmVudHMgaW5zdGFuY2VvZiBSZWFkT25seURhdGFzZXQgfHwgZXZlbnRzIGluc3RhbmNlb2YgRGF0YXNldFdyYXBwZXIpIHsKICAgICAgICAgIGRhdGFzZXQgPSBldmVudHM7CiAgICAgICAgICBldmVudHMgPSBnZXR0ZXI7CiAgICAgICAgICBnZXR0ZXIgPSBhcmd1bWVudHNbMl07CiAgICAgICAgfQogICAgICAgIGlmICghZ2V0dGVyKSB7CiAgICAgICAgICBnZXR0ZXIgPSBldmVudHM7CiAgICAgICAgICBldmVudHMgPSAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIGluZGV4Q29uc3RydWN0b3IgPSBnZXRJbmRleENvbnN0cnVjdG9yKEluZGV4Q2xhc3MsIGdldHRlciB8fCBkZWZHZXR0ZXIsIGV2ZW50cyk7CiAgICAgICAgaWYgKGRhdGFzZXQpIHJldHVybiBnZXREYXRhc2V0SW5kZXgoZGF0YXNldCwgaW5kZXhDb25zdHJ1Y3Rvcik7IGVsc2UgcmV0dXJuIGluZGV4Q29uc3RydWN0b3I7CiAgICAgIH07CiAgICB9OwogICAgdmFyIGNvdW50ID0gY3JlYXRlSW5kZXhDb25zdHJ1Y3RvcihDb3VudCwgYmFzaXMuZm4uJHRydWUpOwogICAgdmFyIHN1bSA9IGNyZWF0ZUluZGV4Q29uc3RydWN0b3IoU3VtKTsKICAgIHZhciBhdmcgPSBjcmVhdGVJbmRleENvbnN0cnVjdG9yKEF2Zyk7CiAgICB2YXIgbWluID0gY3JlYXRlSW5kZXhDb25zdHJ1Y3RvcihNaW4pOwogICAgdmFyIG1heCA9IGNyZWF0ZUluZGV4Q29uc3RydWN0b3IoTWF4KTsKICAgIHZhciBkaXN0aW5jdCA9IGNyZWF0ZUluZGV4Q29uc3RydWN0b3IoRGlzdGluY3QpOwogICAgZnVuY3Rpb24gYXBwbHlJbmRleERlbHRhKGluZGV4LCBpbnNlcnRlZCwgZGVsZXRlZCkgewogICAgICB2YXIgaW5kZXhDYWNoZSA9IGluZGV4LmluZGV4Q2FjaGVfOwogICAgICB2YXIgb2JqZWN0SWQ7CiAgICAgIGluZGV4LmxvY2soKTsKICAgICAgaWYgKGluc2VydGVkKSBmb3IgKHZhciBpID0gMCwgb2JqZWN0OyBvYmplY3QgPSBpbnNlcnRlZFtpKytdOyApIHsKICAgICAgICB2YXIgbmV3VmFsdWUgPSBpbmRleC5ub3JtYWxpemUoaW5kZXgudmFsdWVHZXR0ZXIob2JqZWN0KSk7CiAgICAgICAgaW5kZXhDYWNoZVtvYmplY3QuYmFzaXNPYmplY3RJZF0gPSBuZXdWYWx1ZTsKICAgICAgICBpbmRleC5hZGRfKG5ld1ZhbHVlKTsKICAgICAgfQogICAgICBpZiAoZGVsZXRlZCkgZm9yICh2YXIgaSA9IDAsIG9iamVjdDsgb2JqZWN0ID0gZGVsZXRlZFtpKytdOyApIHsKICAgICAgICBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgIGluZGV4LnJlbW92ZV8oaW5kZXhDYWNoZVtvYmplY3RJZF0pOwogICAgICAgIGRlbGV0ZSBpbmRleENhY2hlW29iamVjdElkXTsKICAgICAgfQogICAgICBpbmRleC51bmxvY2soKTsKICAgIH0KICAgIHZhciBJVEVNX0lOREVYX0hBTkRMRVIgPSB7CiAgICAgICIqIjogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICB2YXIgb2xkVmFsdWU7CiAgICAgICAgdmFyIG5ld1ZhbHVlOwogICAgICAgIHZhciBpbmRleDsKICAgICAgICB2YXIgZXZlbnRUeXBlID0gZXZlbnQudHlwZTsKICAgICAgICB2YXIgb2JqZWN0ID0gZXZlbnQuc2VuZGVyOwogICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgIHZhciBpbmRleGVzID0gZGF0YXNldEluZGV4ZXNbdGhpcy5iYXNpc09iamVjdElkXTsKICAgICAgICBmb3IgKHZhciBpbmRleElkIGluIGluZGV4ZXMpIHsKICAgICAgICAgIGluZGV4ID0gaW5kZXhlc1tpbmRleElkXTsKICAgICAgICAgIGlmIChpbmRleC51cGRhdGVFdmVudHNbZXZlbnRUeXBlXSkgewogICAgICAgICAgICBvbGRWYWx1ZSA9IGluZGV4LmluZGV4Q2FjaGVfW29iamVjdElkXTsKICAgICAgICAgICAgbmV3VmFsdWUgPSBpbmRleC5ub3JtYWxpemUoaW5kZXgudmFsdWVHZXR0ZXIob2JqZWN0KSk7CiAgICAgICAgICAgIGlmIChuZXdWYWx1ZSAhPT0gb2xkVmFsdWUpIHsKICAgICAgICAgICAgICBpbmRleC51cGRhdGVfKG5ld1ZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgaW5kZXguaW5kZXhDYWNoZV9bb2JqZWN0SWRdID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB2YXIgREFUQVNFVF9XSVRIX0lOREVYX0hBTkRMRVIgPSB7CiAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24ob2JqZWN0LCBkZWx0YSkgewogICAgICAgIHZhciBhcnJheTsKICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5pbnNlcnRlZCkgZm9yICh2YXIgaSA9IGFycmF5Lmxlbmd0aDsgaS0tID4gMDsgKSBhcnJheVtpXS5hZGRIYW5kbGVyKElURU1fSU5ERVhfSEFORExFUiwgdGhpcyk7CiAgICAgICAgaWYgKGFycmF5ID0gZGVsdGEuZGVsZXRlZCkgZm9yICh2YXIgaSA9IGFycmF5Lmxlbmd0aDsgaS0tID4gMDsgKSBhcnJheVtpXS5yZW1vdmVIYW5kbGVyKElURU1fSU5ERVhfSEFORExFUiwgdGhpcyk7CiAgICAgICAgdmFyIGluZGV4ZXMgPSBkYXRhc2V0SW5kZXhlc1t0aGlzLmJhc2lzT2JqZWN0SWRdOwogICAgICAgIGZvciAodmFyIGluZGV4SWQgaW4gaW5kZXhlcykgYXBwbHlJbmRleERlbHRhKGluZGV4ZXNbaW5kZXhJZF0sIGRlbHRhLmluc2VydGVkLCBkZWx0YS5kZWxldGVkKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGluZGV4ZXMgPSBkYXRhc2V0SW5kZXhlc1t0aGlzLmJhc2lzT2JqZWN0SWRdOwogICAgICAgIGZvciAodmFyIGluZGV4SWQgaW4gaW5kZXhlcykgcmVtb3ZlRGF0YXNldEluZGV4KHRoaXMsIGluZGV4ZXNbaW5kZXhJZF0pOwogICAgICB9CiAgICB9OwogICAgdmFyIGRhdGFzZXRJbmRleGVzID0ge307CiAgICBmdW5jdGlvbiBnZXREYXRhc2V0SW5kZXgoZGF0YXNldCwgaW5kZXhDb25zdHJ1Y3RvcikgewogICAgICBpZiAoaW5kZXhDb25zdHJ1Y3RvciBpbnN0YW5jZW9mIEluZGV4Q29uc3RydWN0b3IgPT0gZmFsc2UpIHRocm93ICJpbmRleENvbnN0cnVjdG9yIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgSW5kZXhDb25zdHJ1Y3RvciI7CiAgICAgIHZhciBkYXRhc2V0SWQgPSBkYXRhc2V0LmJhc2lzT2JqZWN0SWQ7CiAgICAgIHZhciBpbmRleGVzID0gZGF0YXNldEluZGV4ZXNbZGF0YXNldElkXTsKICAgICAgaWYgKCFpbmRleGVzKSB7CiAgICAgICAgaW5kZXhlcyA9IGRhdGFzZXRJbmRleGVzW2RhdGFzZXRJZF0gPSB7fTsKICAgICAgICBkYXRhc2V0LmFkZEhhbmRsZXIoREFUQVNFVF9XSVRIX0lOREVYX0hBTkRMRVIpOwogICAgICAgIERBVEFTRVRfV0lUSF9JTkRFWF9IQU5ETEVSLml0ZW1zQ2hhbmdlZC5jYWxsKGRhdGFzZXQsIGRhdGFzZXQsIHsKICAgICAgICAgIGluc2VydGVkOiBkYXRhc2V0LmdldEl0ZW1zKCkKICAgICAgICB9KTsKICAgICAgfQogICAgICB2YXIgaW5kZXhJZCA9IGluZGV4Q29uc3RydWN0b3IuaW5kZXhJZDsKICAgICAgdmFyIGluZGV4ID0gaW5kZXhlc1tpbmRleElkXTsKICAgICAgaWYgKCFpbmRleCkgewogICAgICAgIGluZGV4Q29uc3RydWN0b3IgPSBpbmRleENvbnN0cnVjdG9yc19baW5kZXhJZF07CiAgICAgICAgaWYgKCFpbmRleENvbnN0cnVjdG9yKSB0aHJvdyAiV3JvbmcgaW5kZXggY29uc3RydWN0b3IiOwogICAgICAgIGluZGV4ID0gbmV3IGluZGV4Q29uc3RydWN0b3IuaW5kZXhDbGFzczsKICAgICAgICBpbmRleC5hZGRIYW5kbGVyKERBVEFTRVRfSU5ERVhfSEFORExFUiwgZGF0YXNldCk7CiAgICAgICAgaW5kZXhlc1tpbmRleElkXSA9IGluZGV4OwogICAgICAgIGFwcGx5SW5kZXhEZWx0YShpbmRleCwgZGF0YXNldC5nZXRJdGVtcygpKTsKICAgICAgfQogICAgICByZXR1cm4gaW5kZXg7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVEYXRhc2V0SW5kZXgoZGF0YXNldCwgaW5kZXgpIHsKICAgICAgdmFyIGluZGV4ZXMgPSBkYXRhc2V0SW5kZXhlc1tkYXRhc2V0LmJhc2lzT2JqZWN0SWRdOwogICAgICBpZiAoaW5kZXhlcyAmJiBpbmRleGVzW2luZGV4LmluZGV4SWRdKSB7CiAgICAgICAgZGVsZXRlIGluZGV4ZXNbaW5kZXguaW5kZXhJZF07CiAgICAgICAgaW5kZXgucmVtb3ZlSGFuZGxlcihEQVRBU0VUX0lOREVYX0hBTkRMRVIsIGRhdGFzZXQpOwogICAgICAgIGZvciAodmFyIGtleSBpbiBpbmRleGVzKSByZXR1cm47CiAgICAgICAgZGF0YXNldC5yZW1vdmVIYW5kbGVyKERBVEFTRVRfV0lUSF9JTkRFWF9IQU5ETEVSKTsKICAgICAgICBEQVRBU0VUX1dJVEhfSU5ERVhfSEFORExFUi5pdGVtc0NoYW5nZWQuY2FsbChkYXRhc2V0LCBkYXRhc2V0LCB7CiAgICAgICAgICBkZWxldGVkOiBkYXRhc2V0LmdldEl0ZW1zKCkKICAgICAgICB9KTsKICAgICAgICBkZWxldGUgZGF0YXNldEluZGV4ZXNbZGF0YXNldC5iYXNpc09iamVjdElkXTsKICAgICAgfQogICAgfQogICAgdmFyIENhbGNJbmRleFByZXNldCA9IENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkNhbGNJbmRleFByZXNldCIsCiAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogdHJ1ZSwKICAgICAgaW5kZXhlczoge30sCiAgICAgIGNhbGM6IGJhc2lzLmZuLiRudWxsCiAgICB9KTsKICAgIHZhciBjYWxjSW5kZXhQcmVzZXRTZWVkID0gMTsKICAgIGZ1bmN0aW9uIGdldFVuaXF1ZUNhbGNJbmRleElkKCkgewogICAgICByZXR1cm4gImNhbGMtaW5kZXgtcHJlc2V0LSIgKyBiYXNpcy5udW1iZXIubGVhZChjYWxjSW5kZXhQcmVzZXRTZWVkKyssIDgpOwogICAgfQogICAgZnVuY3Rpb24gcGVyY2VudE9mUmFuZ2UoZXZlbnRzLCBnZXR0ZXIpIHsKICAgICAgdmFyIG1pbkluZGV4ID0gIm1pbl8iICsgZ2V0VW5pcXVlQ2FsY0luZGV4SWQoKTsKICAgICAgdmFyIG1heEluZGV4ID0gIm1heF8iICsgZ2V0VW5pcXVlQ2FsY0luZGV4SWQoKTsKICAgICAgdmFyIGluZGV4ZXMgPSB7fTsKICAgICAgaW5kZXhlc1ttaW5JbmRleF0gPSBtaW4oZXZlbnRzLCBnZXR0ZXIpOwogICAgICBpbmRleGVzW21heEluZGV4XSA9IG1heChldmVudHMsIGdldHRlcik7CiAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIgfHwgZXZlbnRzKTsKICAgICAgdmFyIGNhbGMgPSBmdW5jdGlvbihkYXRhLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIChnZXR0ZXIob2JqZWN0KSAtIGluZGV4W21pbkluZGV4XSkgLyAoaW5kZXhbbWF4SW5kZXhdIC0gaW5kZXhbbWluSW5kZXhdKTsKICAgICAgfTsKICAgICAgcmV0dXJuIGNhbGMucHJlc2V0ID0gbmV3IENhbGNJbmRleFByZXNldCh7CiAgICAgICAgaW5kZXhlczogaW5kZXhlcywKICAgICAgICBjYWxjOiBjYWxjCiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gcGVyY2VudE9mTWF4KGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgIHZhciBtYXhJbmRleCA9ICJtYXhfIiArIGdldFVuaXF1ZUNhbGNJbmRleElkKCk7CiAgICAgIHZhciBpbmRleGVzID0ge307CiAgICAgIGluZGV4ZXNbbWF4SW5kZXhdID0gbWF4KGV2ZW50cywgZ2V0dGVyKTsKICAgICAgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyKGdldHRlciB8fCBldmVudHMpOwogICAgICB2YXIgY2FsYyA9IGZ1bmN0aW9uKGRhdGEsIGluZGV4LCBvYmplY3QpIHsKICAgICAgICByZXR1cm4gZ2V0dGVyKG9iamVjdCkgLyBpbmRleFttYXhJbmRleF07CiAgICAgIH07CiAgICAgIHJldHVybiBjYWxjLnByZXNldCA9IG5ldyBDYWxjSW5kZXhQcmVzZXQoewogICAgICAgIGluZGV4ZXM6IGluZGV4ZXMsCiAgICAgICAgY2FsYzogY2FsYwogICAgICB9KTsKICAgIH0KICAgIGZ1bmN0aW9uIHBlcmNlbnRPZlN1bShnZXR0ZXIsIGV2ZW50cykgewogICAgICB2YXIgc3VtSW5kZXggPSAic3VtXyIgKyBnZXRVbmlxdWVDYWxjSW5kZXhJZCgpOwogICAgICB2YXIgaW5kZXhlcyA9IHt9OwogICAgICBpbmRleGVzW3N1bUluZGV4XSA9IHN1bShldmVudHMsIGdldHRlcik7CiAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIgfHwgZXZlbnRzKTsKICAgICAgdmFyIGNhbGMgPSBmdW5jdGlvbihkYXRhLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGdldHRlcihvYmplY3QpIC8gaW5kZXhbc3VtSW5kZXhdOwogICAgICB9OwogICAgICByZXR1cm4gY2FsYy5wcmVzZXQgPSBuZXcgQ2FsY0luZGV4UHJlc2V0KHsKICAgICAgICBpbmRleGVzOiBpbmRleGVzLAogICAgICAgIGNhbGM6IGNhbGMKICAgICAgfSk7CiAgICB9CiAgICB2YXIgSW5kZXhNYXAgPSBDbGFzcyhNYXBGaWx0ZXIsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkluZGV4TWFwIiwKICAgICAgY2FsY3M6IG51bGwsCiAgICAgIGluZGV4ZXM6IG51bGwsCiAgICAgIGluZGV4ZXNfOiBudWxsLAogICAgICBpbmRleGVzQmluZF86IG51bGwsCiAgICAgIHRpbWVyXzogdW5kZWZpbmVkLAogICAgICBpbmRleFVwZGF0ZWQ6IG51bGwsCiAgICAgIGluZGV4VmFsdWVzOiBudWxsLAogICAgICBtZW1iZXJTb3VyY2VNYXA6IG51bGwsCiAgICAgIGtleU1hcDogbnVsbCwKICAgICAgbWFwOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLmdldChpdGVtLCB0cnVlKTsKICAgICAgfSwKICAgICAgYWRkTWVtYmVyUmVmOiBmdW5jdGlvbihtZW1iZXIsIHNvdXJjZU9iamVjdCkgewogICAgICAgIHRoaXMubWVtYmVyU291cmNlTWFwW21lbWJlci5iYXNpc09iamVjdElkXSA9IHNvdXJjZU9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgIGlmICh0aGlzLmxpc3Rlbi5tZW1iZXIpIG1lbWJlci5hZGRIYW5kbGVyKHRoaXMubGlzdGVuLm1lbWJlciwgdGhpcyk7CiAgICAgICAgdGhpcy5zb3VyY2VNYXBfW3NvdXJjZU9iamVjdC5iYXNpc09iamVjdElkXS51cGRhdGVkID0gdHJ1ZTsKICAgICAgICBpZiAobWVtYmVyLnN1YnNjcmliZXJDb3VudCA+IDApIHRoaXMuY2FsY01lbWJlcihtZW1iZXIpOwogICAgICB9LAogICAgICByZW1vdmVNZW1iZXJSZWY6IGZ1bmN0aW9uKG1lbWJlciwgc291cmNlT2JqZWN0KSB7CiAgICAgICAgZGVsZXRlIHRoaXMubWVtYmVyU291cmNlTWFwW21lbWJlci5iYXNpc09iamVjdElkXTsKICAgICAgICBpZiAodGhpcy5saXN0ZW4ubWVtYmVyKSBtZW1iZXIucmVtb3ZlSGFuZGxlcih0aGlzLmxpc3Rlbi5tZW1iZXIsIHRoaXMpOwogICAgICB9LAogICAgICBlbWl0X3NvdXJjZUNoYW5nZWQ6IGZ1bmN0aW9uKG9sZFNvdXJjZSkgewogICAgICAgIE1hcEZpbHRlci5wcm90b3R5cGUuZW1pdF9zb3VyY2VDaGFuZ2VkLmNhbGwodGhpcywgb2xkU291cmNlKTsKICAgICAgICBmb3IgKHZhciBpbmRleE5hbWUgaW4gdGhpcy5pbmRleGVzXykgewogICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleGVzX1tpbmRleE5hbWVdOwogICAgICAgICAgaWYgKG9sZFNvdXJjZSkgewogICAgICAgICAgICB0aGlzLnJlbW92ZUluZGV4KGluZGV4TmFtZSk7CiAgICAgICAgICAgIHJlbW92ZURhdGFzZXRJbmRleChvbGRTb3VyY2UsIHRoaXMuaW5kZXhlc1tpbmRleE5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLnNvdXJjZSkgdGhpcy5hZGRJbmRleChpbmRleE5hbWUsIGdldERhdGFzZXRJbmRleCh0aGlzLnNvdXJjZSwgaW5kZXgpKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGxpc3RlbjogewogICAgICAgIGluZGV4OiB7CiAgICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uKHNlbmRlcikgewogICAgICAgICAgICB2YXIgaW5kZXhNYXAgPSB0aGlzLmluZGV4TWFwOwogICAgICAgICAgICBpbmRleE1hcC5pbmRleFZhbHVlc1t0aGlzLmtleV0gPSBzZW5kZXIudmFsdWU7CiAgICAgICAgICAgIGluZGV4TWFwLmluZGV4VXBkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIGluZGV4TWFwLnJlY2FsY1JlcXVlc3QoKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG1lbWJlcjogewogICAgICAgICAgc3Vic2NyaWJlcnNDaGFuZ2VkOiBmdW5jdGlvbihvYmplY3QsIGRlbHRhKSB7CiAgICAgICAgICAgIGlmIChvYmplY3Quc3Vic2NyaWJlckNvdW50ID4gMCkgdGhpcy5jYWxjTWVtYmVyKG9iamVjdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBydWxlRXZlbnRzOiBiYXNpcy5kYXRhLmRhdGFzZXQuY3JlYXRlUnVsZUV2ZW50cyhmdW5jdGlvbihzZW5kZXIsIGRlbHRhKSB7CiAgICAgICAgTWFwRmlsdGVyLnByb3RvdHlwZS5ydWxlRXZlbnRzLnVwZGF0ZS5jYWxsKHRoaXMsIHNlbmRlciwgZGVsdGEpOwogICAgICAgIHRoaXMuc291cmNlTWFwX1tzZW5kZXIuYmFzaXNPYmplY3RJZF0udXBkYXRlZCA9IHRydWU7CiAgICAgICAgdGhpcy5yZWNhbGNSZXF1ZXN0KCk7CiAgICAgIH0sICJ1cGRhdGUiKSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZWNhbGMgPSB0aGlzLnJlY2FsYy5iaW5kKHRoaXMpOwogICAgICAgIHRoaXMuaW5kZXhVcGRhdGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5pbmRleGVzQmluZF8gPSB7fTsKICAgICAgICB0aGlzLm1lbWJlclNvdXJjZU1hcCA9IHt9OwogICAgICAgIHZhciBpbmRleGVzID0gdGhpcy5pbmRleGVzOwogICAgICAgIHRoaXMuaW5kZXhlcyA9IHt9OwogICAgICAgIHRoaXMuaW5kZXhlc18gPSB7fTsKICAgICAgICB0aGlzLmluZGV4VmFsdWVzID0ge307CiAgICAgICAgdmFyIGNhbGNzID0gdGhpcy5jYWxjczsKICAgICAgICB0aGlzLmNhbGNzID0ge307CiAgICAgICAgaWYgKCF0aGlzLmtleU1hcCB8fCB0aGlzLmtleU1hcCBpbnN0YW5jZW9mIEtleU9iamVjdE1hcCA9PSBmYWxzZSkgdGhpcy5rZXlNYXAgPSBuZXcgS2V5T2JqZWN0TWFwKGJhc2lzLm9iamVjdC5jb21wbGV0ZSh7CiAgICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uKGtleSwgY29uZmlnKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgdGhpcy5pdGVtQ2xhc3MoY29uZmlnKTsKICAgICAgICAgIH0KICAgICAgICB9LCB0aGlzLmtleU1hcCkpOwogICAgICAgIE1hcEZpbHRlci5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIGJhc2lzLm9iamVjdC5pdGVyYXRlKGluZGV4ZXMsIHRoaXMuYWRkSW5kZXgsIHRoaXMpOwogICAgICAgIGJhc2lzLm9iamVjdC5pdGVyYXRlKGNhbGNzLCB0aGlzLmFkZENhbGMsIHRoaXMpOwogICAgICB9LAogICAgICBhZGRJbmRleDogZnVuY3Rpb24oa2V5LCBpbmRleCkgewogICAgICAgIGlmICghdGhpcy5pbmRleGVzW2tleV0pIHsKICAgICAgICAgIGlmIChpbmRleCBpbnN0YW5jZW9mIEluZGV4Q29uc3RydWN0b3IpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmluZGV4ZXNfW2tleV0pIHsKICAgICAgICAgICAgICB0aGlzLmluZGV4ZXNfW2tleV0gPSBpbmRleDsKICAgICAgICAgICAgICBpbmRleCA9IHRoaXMuc291cmNlID8gZ2V0RGF0YXNldEluZGV4KHRoaXMuc291cmNlLCBpbmRleCkgOiBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJJbmRleCBgIiArIGtleSArICJgIGFscmVhZHkgZXhpc3RzIik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5kZXggaW5zdGFuY2VvZiBJbmRleCkgewogICAgICAgICAgICB0aGlzLmluZGV4VmFsdWVzW2tleV0gPSBpbmRleC52YWx1ZTsKICAgICAgICAgICAgdGhpcy5pbmRleGVzW2tleV0gPSBpbmRleDsKICAgICAgICAgICAgdGhpcy5pbmRleGVzQmluZF9ba2V5XSA9IHsKICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICBpbmRleE1hcDogdGhpcwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLmluZGV4OwogICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgewogICAgICAgICAgICAgIGluZGV4LmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcy5pbmRleGVzQmluZF9ba2V5XSk7CiAgICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIuY2hhbmdlKSBsaXN0ZW5IYW5kbGVyLmNoYW5nZS5jYWxsKHRoaXMuaW5kZXhlc0JpbmRfW2tleV0sIGluZGV4LCBpbmRleC52YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJJbmRleCBzaG91bGQgYmUgaW5zdGFuY2Ugb2YgYGJhc2lzLmRhdGEuaW5kZXguSW5kZXhgIik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJJbmRleCBgIiArIGtleSArICJgIGFscmVhZHkgZXhpc3RzIik7CiAgICAgICAgfQogICAgICB9LAogICAgICByZW1vdmVJbmRleDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKHRoaXMuaW5kZXhlc19ba2V5XSB8fCB0aGlzLmluZGV4ZXNba2V5XSkgewogICAgICAgICAgaWYgKHRoaXMuaW5kZXhlc1trZXldICYmIHRoaXMubGlzdGVuLmluZGV4KSB0aGlzLmluZGV4ZXNba2V5XS5yZW1vdmVIYW5kbGVyKHRoaXMubGlzdGVuLmluZGV4LCB0aGlzLmluZGV4ZXNCaW5kX1trZXldKTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmluZGV4VmFsdWVzW2tleV07CiAgICAgICAgICBkZWxldGUgdGhpcy5pbmRleGVzQmluZF9ba2V5XTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmluZGV4ZXNba2V5XTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmluZGV4ZXNfW2tleV07CiAgICAgICAgfQogICAgICB9LAogICAgICBhZGRDYWxjOiBmdW5jdGlvbihuYW1lLCBjYWxjQ2ZnKSB7CiAgICAgICAgaWYgKGNhbGNDZmcgaW5zdGFuY2VvZiBDYWxjSW5kZXhQcmVzZXQpIHsKICAgICAgICAgIHRoaXMuY2FsY3NbbmFtZV0gPSBjYWxjQ2ZnLmNhbGM7CiAgICAgICAgICBmb3IgKHZhciBpbmRleE5hbWUgaW4gY2FsY0NmZy5pbmRleGVzKSB0aGlzLmFkZEluZGV4KGluZGV4TmFtZSwgY2FsY0NmZy5pbmRleGVzW2luZGV4TmFtZV0pOwogICAgICAgIH0gZWxzZSB0aGlzLmNhbGNzW25hbWVdID0gY2FsY0NmZzsKICAgICAgICB0aGlzLnJlY2FsY1JlcXVlc3QoKTsKICAgICAgfSwKICAgICAgcmVtb3ZlQ2FsYzogZnVuY3Rpb24obmFtZSkgewogICAgICAgIHZhciBjYWxjQ2ZnID0gdGhpcy5jYWxjc1tuYW1lXTsKICAgICAgICBpZiAoY2FsY0NmZyAmJiBjYWxjQ2ZnLnByZXNldCBpbnN0YW5jZW9mIENhbGNJbmRleFByZXNldCkgewogICAgICAgICAgdmFyIGluZGV4ZXMgPSBjYWxjQ2ZnLnByZXNldC5pbmRleGVzOwogICAgICAgICAgZm9yICh2YXIgaW5kZXhOYW1lIGluIGluZGV4ZXMpIHRoaXMucmVtb3ZlSW5kZXgoaW5kZXhOYW1lLCBpbmRleGVzW2luZGV4TmFtZV0pOwogICAgICAgIH0KICAgICAgICBkZWxldGUgdGhpcy5jYWxjc1tuYW1lXTsKICAgICAgfSwKICAgICAgbG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaW5kZXhJZCBpbiB0aGlzLmluZGV4ZXMpIHRoaXMuaW5kZXhlc1tpbmRleElkXS5sb2NrKCk7CiAgICAgIH0sCiAgICAgIHVubG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaW5kZXhJZCBpbiB0aGlzLmluZGV4ZXMpIHRoaXMuaW5kZXhlc1tpbmRleElkXS51bmxvY2soKTsKICAgICAgfSwKICAgICAgcmVjYWxjUmVxdWVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLnRpbWVyXykgdGhpcy50aW1lcl8gPSBiYXNpcy5zZXRJbW1lZGlhdGUodGhpcy5yZWNhbGMpOwogICAgICB9LAogICAgICByZWNhbGM6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGlkeCBpbiB0aGlzLml0ZW1zXykgdGhpcy5jYWxjTWVtYmVyKHRoaXMuaXRlbXNfW2lkeF0pOwogICAgICAgIHRoaXMuaW5kZXhVcGRhdGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy50aW1lcl8gPSBiYXNpcy5jbGVhckltbWVkaWF0ZSh0aGlzLnRpbWVyXyk7CiAgICAgIH0sCiAgICAgIGNhbGNNZW1iZXI6IGZ1bmN0aW9uKG1lbWJlcikgewogICAgICAgIHZhciBzb3VyY2VPYmplY3QgPSB0aGlzLnNvdXJjZU1hcF9bdGhpcy5tZW1iZXJTb3VyY2VNYXBbbWVtYmVyLmJhc2lzT2JqZWN0SWRdXTsKICAgICAgICBpZiAobWVtYmVyLnN1YnNjcmliZXJDb3VudCAmJiAoc291cmNlT2JqZWN0LnVwZGF0ZWQgfHwgdGhpcy5pbmRleFVwZGF0ZWQpKSB7CiAgICAgICAgICBzb3VyY2VPYmplY3QudXBkYXRlZCA9IGZhbHNlOwogICAgICAgICAgdmFyIGRhdGEgPSB7fTsKICAgICAgICAgIHZhciBuZXdWYWx1ZTsKICAgICAgICAgIHZhciBvbGRWYWx1ZTsKICAgICAgICAgIHZhciB1cGRhdGU7CiAgICAgICAgICBmb3IgKHZhciBjYWxjTmFtZSBpbiB0aGlzLmNhbGNzKSB7CiAgICAgICAgICAgIG5ld1ZhbHVlID0gdGhpcy5jYWxjc1tjYWxjTmFtZV0oc291cmNlT2JqZWN0LnNvdXJjZU9iamVjdC5kYXRhLCB0aGlzLmluZGV4VmFsdWVzLCBzb3VyY2VPYmplY3Quc291cmNlT2JqZWN0KTsKICAgICAgICAgICAgb2xkVmFsdWUgPSBtZW1iZXIuZGF0YVtjYWxjTmFtZV07CiAgICAgICAgICAgIGlmIChtZW1iZXIuZGF0YVtjYWxjTmFtZV0gIT09IG5ld1ZhbHVlICYmICh0eXBlb2YgbmV3VmFsdWUgIT0gIm51bWJlciIgfHwgdHlwZW9mIG9sZFZhbHVlICE9ICJudW1iZXIiIHx8ICFpc05hTihuZXdWYWx1ZSkgfHwgIWlzTmFOKG9sZFZhbHVlKSkpIHsKICAgICAgICAgICAgICBkYXRhW2NhbGNOYW1lXSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgIHVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh1cGRhdGUpIG1lbWJlci51cGRhdGUoZGF0YSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBnZXRNZW1iZXI6IGZ1bmN0aW9uKHNvdXJjZU9iamVjdCkgewogICAgICAgIHJldHVybiB0aGlzLmtleU1hcC5nZXQoc291cmNlT2JqZWN0LCB0cnVlKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5rZXlNYXAuZGVzdHJveSgpOwogICAgICAgIHRoaXMua2V5TWFwID0gbnVsbDsKICAgICAgICBmb3IgKHZhciBpbmRleE5hbWUgaW4gdGhpcy5pbmRleGVzKSB0aGlzLnJlbW92ZUluZGV4KGluZGV4TmFtZSk7CiAgICAgICAgTWFwRmlsdGVyLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy50aW1lcl8gPSBiYXNpcy5jbGVhckltbWVkaWF0ZSh0aGlzLnRpbWVyXyk7CiAgICAgICAgdGhpcy5jYWxjcyA9IG51bGw7CiAgICAgICAgdGhpcy5pbmRleGVzID0gbnVsbDsKICAgICAgICB0aGlzLmluZGV4ZXNfID0gbnVsbDsKICAgICAgICB0aGlzLmluZGV4VmFsdWVzID0gbnVsbDsKICAgICAgICB0aGlzLm1lbWJlclNvdXJjZU1hcCA9IG51bGw7CiAgICAgICAgdGhpcy5pbmRleGVzQmluZF8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBJbmRleENvbnN0cnVjdG9yOiBJbmRleENvbnN0cnVjdG9yLAogICAgICBjcmVhdGVJbmRleENvbnN0cnVjdG9yOiBjcmVhdGVJbmRleENvbnN0cnVjdG9yLAogICAgICBnZXREYXRhc2V0SW5kZXg6IGdldERhdGFzZXRJbmRleCwKICAgICAgcmVtb3ZlRGF0YXNldEluZGV4OiByZW1vdmVEYXRhc2V0SW5kZXgsCiAgICAgIEluZGV4OiBJbmRleCwKICAgICAgQ291bnQ6IENvdW50LAogICAgICBTdW06IFN1bSwKICAgICAgQXZnOiBBdmcsCiAgICAgIFZlY3RvckluZGV4OiBWZWN0b3JJbmRleCwKICAgICAgTWluOiBNaW4sCiAgICAgIE1heDogTWF4LAogICAgICBEaXN0aW5jdDogRGlzdGluY3QsCiAgICAgIGNvdW50OiBjb3VudCwKICAgICAgc3VtOiBzdW0sCiAgICAgIGF2ZzogYXZnLAogICAgICBtYXg6IG1heCwKICAgICAgbWluOiBtaW4sCiAgICAgIGRpc3RpbmN0OiBkaXN0aW5jdCwKICAgICAgQ2FsY0luZGV4UHJlc2V0OiBDYWxjSW5kZXhQcmVzZXQsCiAgICAgIHBlcmNlbnRPZlJhbmdlOiBwZXJjZW50T2ZSYW5nZSwKICAgICAgcGVyY2VudE9mTWF4OiBwZXJjZW50T2ZNYXgsCiAgICAgIHBlcmNlbnRPZlN1bTogcGVyY2VudE9mU3VtLAogICAgICBJbmRleE1hcDogSW5kZXhNYXAKICAgIH07CiAgfSwKICAiZy5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIERhdGFPYmplY3QgPSBiYXNpcy5kYXRhLk9iamVjdDsKICAgIGZ1bmN0aW9uIGdlbmVyYXRlR2V0RGF0YShuYW1lTWFwKSB7CiAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oImRhdGEiLCAicmV0dXJuIHsiICsgYmFzaXMub2JqZWN0Lml0ZXJhdGUobmFtZU1hcCwgZnVuY3Rpb24ob3duTmFtZSwgc291cmNlTmFtZSkgewogICAgICAgIG93bk5hbWUgPSBvd25OYW1lLnJlcGxhY2UoLyIvZywgJ1xcIicpOwogICAgICAgIHNvdXJjZU5hbWUgPSBzb3VyY2VOYW1lLnJlcGxhY2UoLyIvZywgJ1xcIicpOwogICAgICAgIHJldHVybiAnIicgKyBvd25OYW1lICsgJyI6IGRhdGFbIicgKyBzb3VyY2VOYW1lICsgJyJdJzsKICAgICAgfSkgKyAifSIpOwogICAgfQogICAgdmFyIE1FUkdFX1NPVVJDRV9IQU5ETEVSID0gewogICAgICB1cGRhdGU6IGZ1bmN0aW9uKHNlbmRlciwgc2VuZGVyRGVsdGEpIHsKICAgICAgICB2YXIgZmllbGRzID0gdGhpcy5ob3N0LmZpZWxkczsKICAgICAgICB2YXIgZGF0YSA9IHt9OwogICAgICAgIGlmICh0aGlzLm5hbWUgPT0gZmllbGRzLmRlZmF1bHRTb3VyY2UpIHsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzZW5kZXJEZWx0YSkgaWYgKGtleSBpbiBmaWVsZHMuZmllbGRTb3VyY2UgPT0gZmFsc2UpIGRhdGFba2V5XSA9IHNlbmRlci5kYXRhW2tleV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzZW5kZXJEZWx0YSkgewogICAgICAgICAgICB2YXIgbWVyZ2VLZXkgPSBmaWVsZHMuZnJvbU5hbWVzW3RoaXMubmFtZV1ba2V5XTsKICAgICAgICAgICAgaWYgKG1lcmdlS2V5ICYmIHRoaXMuaG9zdC5maWVsZHMuZmllbGRTb3VyY2VbbWVyZ2VLZXldID09IHRoaXMubmFtZSkgZGF0YVttZXJnZUtleV0gPSBzZW5kZXIuZGF0YVtrZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgcmV0dXJuIHRoaXMuaG9zdC51cGRhdGUoZGF0YSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaG9zdC5zZXRTb3VyY2UodGhpcy5uYW1lLCBudWxsKTsKICAgICAgfQogICAgfTsKICAgIHZhciBmaWVsZHNFeHRlbmQgPSBmdW5jdGlvbihmaWVsZHMpIHsKICAgICAgdmFyIHNvdXJjZXMgPSB7fTsKICAgICAgdmFyIHRvTmFtZXMgPSB7fTsKICAgICAgdmFyIGZyb21OYW1lcyA9IHt9OwogICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgIGRlZmF1bHRTb3VyY2U6IGZhbHNlLAogICAgICAgIGZpZWxkU291cmNlOiB7fSwKICAgICAgICB0b05hbWVzOiB0b05hbWVzLAogICAgICAgIGZyb21OYW1lczogZnJvbU5hbWVzLAogICAgICAgIHNvdXJjZXM6IHNvdXJjZXMsCiAgICAgICAgX19leHRlbmRfXzogZmllbGRzRXh0ZW5kCiAgICAgIH07CiAgICAgIGlmIChmaWVsZHNbIioiXSkgcmVzdWx0LmRlZmF1bHRTb3VyY2UgPSBmaWVsZHNbIioiXTsKICAgICAgZm9yICh2YXIgZmllbGQgaW4gZmllbGRzKSB7CiAgICAgICAgdmFyIGRlZiA9IGZpZWxkc1tmaWVsZF0uc3BsaXQoIjoiKTsKICAgICAgICB2YXIgc291cmNlTmFtZSA9IGRlZi5zaGlmdCgpOwogICAgICAgIHZhciBzb3VyY2VGaWVsZCA9IGRlZi5sZW5ndGggPyBkZWYuam9pbigiOiIpIDogZmllbGQ7CiAgICAgICAgaWYgKHNvdXJjZU5hbWUgPT0gcmVzdWx0LmRlZmF1bHRTb3VyY2UpIHsKICAgICAgICAgIGlmIChmaWVsZCAhPSAiKiIpIGJhc2lzLmRldi53YXJuKCJiYXNpcy5kYXRhLm9iamVjdC5NZXJnZTogc291cmNlIGAiICsgc291cmNlTmFtZSArICJgIGhhcyBhbHJlYWR5IGRlZmluZWQgZm9yIGFueSBmaWVsZCAoc3RhciBydWxlKSwgZGVmaW5pdGlvbiB0aGlzIHNvdXJjZSBmb3IgYCIgKyBmaWVsZCArICJgIGZpZWxkIGlzIHN1cGVyZmx1b3VzIChpZ25vcmVkKS4iKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAoc291cmNlTmFtZSA9PSAiLSIgJiYgc291cmNlRmllbGQgIT0gZmllbGQpIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5kYXRhLm9iamVjdC5NZXJnZTogY3VzdG9tIGZpZWxkIG5hbWUgY2FuJ3QgYmUgdXNlZCBmb3Igb3duIHByb3BlcnRpZXMsIGRlZmluaXRpb24gYCIgKyBmaWVsZCArICc6ICInICsgZmllbGRzW2ZpZWxkXSArICciYCBpZ25vcmVkLicpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmICghdG9OYW1lc1tzb3VyY2VOYW1lXSkgewogICAgICAgICAgdG9OYW1lc1tzb3VyY2VOYW1lXSA9IHt9OwogICAgICAgICAgZnJvbU5hbWVzW3NvdXJjZU5hbWVdID0ge307CiAgICAgICAgfQogICAgICAgIHRvTmFtZXNbc291cmNlTmFtZV1bZmllbGRdID0gc291cmNlRmllbGQ7CiAgICAgICAgZnJvbU5hbWVzW3NvdXJjZU5hbWVdW3NvdXJjZUZpZWxkXSA9IGZpZWxkOwogICAgICAgIHJlc3VsdC5maWVsZFNvdXJjZVtmaWVsZF0gPSBzb3VyY2VOYW1lOwogICAgICB9CiAgICAgIGZvciAodmFyIHNvdXJjZU5hbWUgaW4gdG9OYW1lcykgc291cmNlc1tzb3VyY2VOYW1lXSA9IGdlbmVyYXRlR2V0RGF0YSh0b05hbWVzW3NvdXJjZU5hbWVdKTsKICAgICAgaWYgKHJlc3VsdC5kZWZhdWx0U291cmNlKSBzb3VyY2VzW3Jlc3VsdC5kZWZhdWx0U291cmNlXSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB2YXIgcmVzID0ge307CiAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIGlmIChrZXkgaW4gcmVzdWx0LmZpZWxkU291cmNlID09IGZhbHNlKSByZXNba2V5XSA9IGRhdGFba2V5XTsKICAgICAgICByZXR1cm4gcmVzOwogICAgICB9OwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIHZhciBNZXJnZSA9IERhdGFPYmplY3Quc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTWVyZ2UiLAogICAgICBlbWl0X3NvdXJjZUNoYW5nZWQ6IGJhc2lzLmV2ZW50LmNyZWF0ZSgic291cmNlQ2hhbmdlZCIsICJuYW1lIiwgIm9sZFNvdXJjZSIpLAogICAgICBmaWVsZHM6IGZpZWxkc0V4dGVuZCh7CiAgICAgICAgIioiOiAiLSIKICAgICAgfSksCiAgICAgIHNvdXJjZXM6IG51bGwsCiAgICAgIHNvdXJjZXNDb250ZXh0XzogbnVsbCwKICAgICAgZGVsdGFfOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTsKICAgICAgICB2YXIgc291cmNlcyA9IHRoaXMuc291cmNlczsKICAgICAgICBpZiAodGhpcy5kZWxlZ2F0ZSkgYmFzaXMuZGV2Lndhcm4odGhpcy5jb25zdHJ1Y3Rvci5jbGFzc05hbWUgKyAiIGNhbid0IGhhcyBhIGRlbGVnYXRlIik7CiAgICAgICAgdGhpcy5kYXRhID0ge307CiAgICAgICAgdGhpcy5kZWxlZ2F0ZSA9IG51bGw7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IHRoaXMuZmllbGRzLmZpZWxkU291cmNlW2tleV0gfHwgdGhpcy5maWVsZHMuZGVmYXVsdFNvdXJjZTsKICAgICAgICAgIGlmIChuYW1lID09ICItIikgdGhpcy5kYXRhW2tleV0gPSBkYXRhW2tleV07CiAgICAgICAgfQogICAgICAgIHRoaXMuc291cmNlcyA9IHt9OwogICAgICAgIHRoaXMuc291cmNlc0NvbnRleHRfID0ge307CiAgICAgICAgaWYgKHNvdXJjZXMpIHRoaXMuc2V0U291cmNlcyhzb3VyY2VzKTsKICAgICAgfSwKICAgICAgdXBkYXRlOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgaWYgKHRoaXMuZGVsdGFfKSB7CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgICB2YXIgc291cmNlTmFtZSA9IHRoaXMuZmllbGRzLmZpZWxkU291cmNlW2tleV0gfHwgdGhpcy5maWVsZHMuZGVmYXVsdFNvdXJjZTsKICAgICAgICAgICAgaWYgKCFzb3VyY2VOYW1lKSB7CiAgICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlVua25vd24gc291cmNlIGZvciBmaWVsZCBgIiArIGtleSArICJgIik7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNvdXJjZUtleSA9IHNvdXJjZU5hbWUgIT0gdGhpcy5maWVsZHMuZGVmYXVsdFNvdXJjZSA/IHRoaXMuZmllbGRzLnRvTmFtZXNbc291cmNlTmFtZV1ba2V5XSA6IGtleTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5zb3VyY2VzW3NvdXJjZU5hbWVdLmRhdGFbc291cmNlS2V5XTsKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLmRhdGFba2V5XSkgewogICAgICAgICAgICAgIGlmIChrZXkgaW4gdGhpcy5kZWx0YV8gPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGVsdGFfW2tleV0gPSB0aGlzLmRhdGFba2V5XTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVsdGFfW2tleV0gPT09IHZhbHVlKSBkZWxldGUgdGhpcy5kZWx0YV9ba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5kYXRhW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgc291cmNlRGVsdGE7CiAgICAgICAgdmFyIGRlbHRhID0ge307CiAgICAgICAgdGhpcy5kZWx0YV8gPSBkZWx0YTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgdmFyIHNvdXJjZU5hbWUgPSB0aGlzLmZpZWxkcy5maWVsZFNvdXJjZVtrZXldIHx8IHRoaXMuZmllbGRzLmRlZmF1bHRTb3VyY2U7CiAgICAgICAgICBpZiAoIXNvdXJjZU5hbWUpIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlVua25vd24gc291cmNlIGZvciBmaWVsZCBgIiArIGtleSArICJgIik7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZU5hbWUgPT0gIi0iKSB7CiAgICAgICAgICAgIGRlbHRhW2tleV0gPSB0aGlzLmRhdGFba2V5XTsKICAgICAgICAgICAgdGhpcy5kYXRhW2tleV0gPSBkYXRhW2tleV07CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuc291cmNlc1tzb3VyY2VOYW1lXSkgewogICAgICAgICAgICB2YXIgc291cmNlS2V5ID0gc291cmNlTmFtZSAhPSB0aGlzLmZpZWxkcy5kZWZhdWx0U291cmNlID8gdGhpcy5maWVsZHMudG9OYW1lc1tzb3VyY2VOYW1lXVtrZXldIDoga2V5OwogICAgICAgICAgICBpZiAodGhpcy5zb3VyY2VzW3NvdXJjZU5hbWVdLmRhdGFbc291cmNlS2V5XSAhPT0gZGF0YVtrZXldKSB7CiAgICAgICAgICAgICAgaWYgKCFzb3VyY2VEZWx0YSkgc291cmNlRGVsdGEgPSB7fTsKICAgICAgICAgICAgICBpZiAoc291cmNlTmFtZSBpbiBzb3VyY2VEZWx0YSA9PSBmYWxzZSkgc291cmNlRGVsdGFbc291cmNlTmFtZV0gPSB7fTsKICAgICAgICAgICAgICBzb3VyY2VEZWx0YVtzb3VyY2VOYW1lXVtzb3VyY2VLZXldID0gZGF0YVtrZXldOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICh0aGlzLmRhdGFba2V5XSAhPT0gZGF0YVtrZXldKSB7CiAgICAgICAgICAgICAgICBkZWx0YVtrZXldID0gdGhpcy5kYXRhW2tleV07CiAgICAgICAgICAgICAgICB0aGlzLmRhdGFba2V5XSA9IGRhdGFba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHNvdXJjZURlbHRhKSBmb3IgKHZhciBzb3VyY2VOYW1lIGluIHNvdXJjZURlbHRhKSB0aGlzLnNvdXJjZXNbc291cmNlTmFtZV0udXBkYXRlKHNvdXJjZURlbHRhW3NvdXJjZU5hbWVdKTsKICAgICAgICB0aGlzLmRlbHRhXyA9IG51bGw7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGRlbHRhKSB7CiAgICAgICAgICB0aGlzLmVtaXRfdXBkYXRlKGRlbHRhKTsKICAgICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAogICAgICBzZXREZWxlZ2F0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIi5NZXJnZSBjYW4ndCBoYXMgYSBkZWxlZ2F0ZSIpOwogICAgICB9LAogICAgICBzZXRTb3VyY2U6IGZ1bmN0aW9uKG5hbWUsIHNvdXJjZSkgewogICAgICAgIHZhciBvbGRTb3VyY2UgPSB0aGlzLnNvdXJjZXNbbmFtZV07CiAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5maWVsZHMuc291cmNlcyA9PSBmYWxzZSkgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmRhdGEub2JqZWN0Lk1lcmdlI3NldFNvdXJjZTogY2FuJ3Qgc2V0IHNvdXJjZSB3aXRoIG5hbWUgYCIgKyBuYW1lICsgImAgYXMgbm90IHNwZWNpZmllZCBieSBmaWVsZHMgY29uZmlndXJhdGlvbiIpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAobmFtZSA9PSAiLSIpIHJldHVybjsKICAgICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgRGF0YU9iamVjdCA9PSBmYWxzZSkgc291cmNlID0gbnVsbDsKICAgICAgICBpZiAob2xkU291cmNlICE9PSBzb3VyY2UpIHsKICAgICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW5bInNvdXJjZToiICsgbmFtZV07CiAgICAgICAgICBpZiAob2xkU291cmNlKSB7CiAgICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSBvbGRTb3VyY2UucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgb2xkU291cmNlLnJlbW92ZUhhbmRsZXIoTUVSR0VfU09VUkNFX0hBTkRMRVIsIHRoaXMuc291cmNlc0NvbnRleHRfW25hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc291cmNlc1tuYW1lXSA9IHNvdXJjZTsKICAgICAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5zb3VyY2VzQ29udGV4dF8gPT0gZmFsc2UpIHRoaXMuc291cmNlc0NvbnRleHRfW25hbWVdID0gewogICAgICAgICAgICAgIGhvc3Q6IHRoaXMsCiAgICAgICAgICAgICAgbmFtZTogbmFtZQogICAgICAgICAgICB9OwogICAgICAgICAgICBzb3VyY2UuYWRkSGFuZGxlcihNRVJHRV9TT1VSQ0VfSEFORExFUiwgdGhpcy5zb3VyY2VzQ29udGV4dF9bbmFtZV0pOwogICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgc291cmNlLmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlKHRoaXMuZmllbGRzLnNvdXJjZXNbbmFtZV0oc291cmNlLmRhdGEpKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9zb3VyY2VDaGFuZ2VkKG5hbWUsIG9sZFNvdXJjZSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRTb3VyY2VzOiBmdW5jdGlvbihzb3VyY2VzKSB7CiAgICAgICAgaWYgKCFzb3VyY2VzKSBzb3VyY2VzID0ge307CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiB0aGlzLmZpZWxkcy5zb3VyY2VzKSB0aGlzLnNldFNvdXJjZShuYW1lLCBzb3VyY2VzW25hbWVdKTsKICAgICAgICBmb3IgKHZhciBuYW1lIGluIHNvdXJjZXMpIGlmIChuYW1lIGluIHRoaXMuZmllbGRzLnNvdXJjZXMgPT0gZmFsc2UpIGJhc2lzLmRldi53YXJuKCJiYXNpcy5kYXRhLm9iamVjdC5NZXJnZSNzZXRTb3VyY2U6IGNhbid0IHNldCBzb3VyY2Ugd2l0aCBuYW1lIGAiICsgbmFtZSArICJgIGFzIG5vdCBzcGVjaWZpZWQgYnkgZmllbGRzIGNvbmZpZ3VyYXRpb24iKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXRTb3VyY2VzKCk7CiAgICAgICAgdGhpcy5zb3VyY2VzID0gbnVsbDsKICAgICAgICB0aGlzLnNvdXJjZXNDb250ZXh0XyA9IG51bGw7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBNZXJnZTogTWVyZ2UKICAgIH07CiAgfSwKICAiaC5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZC5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBDbGFzcyA9IGJhc2lzLkNsYXNzOwogICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgIHZhciBrZXlzID0gYmFzaXMub2JqZWN0LmtleXM7CiAgICB2YXIgZXh0ZW5kID0gYmFzaXMub2JqZWN0LmV4dGVuZDsKICAgIHZhciBjb21wbGV0ZSA9IGJhc2lzLm9iamVjdC5jb21wbGV0ZTsKICAgIHZhciAkc2VsZiA9IGJhc2lzLmZuLiRzZWxmOwogICAgdmFyIGdldHRlciA9IGJhc2lzLmdldHRlcjsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheS5mcm9tOwogICAgdmFyIEVtaXR0ZXIgPSBiYXNpcy5ldmVudC5FbWl0dGVyOwogICAgdmFyIGNyZWF0ZUV2ZW50ID0gYmFzaXMuZXZlbnQuY3JlYXRlOwogICAgdmFyIERhdGFPYmplY3QgPSBiYXNpcy5kYXRhLk9iamVjdDsKICAgIHZhciBTbG90ID0gYmFzaXMuZGF0YS5TbG90OwogICAgdmFyIERhdGFzZXQgPSBiYXNpcy5kYXRhLkRhdGFzZXQ7CiAgICB2YXIgRmlsdGVyID0gYmFzaXMuZGF0YS5kYXRhc2V0LkZpbHRlcjsKICAgIHZhciBTcGxpdCA9IGJhc2lzLmRhdGEuZGF0YXNldC5TcGxpdDsKICAgIHZhciBOVUxMX0lORk8gPSB7fTsKICAgIHZhciBlbnRpdHlUeXBlcyA9IFtdOwogICAgdmFyIGlzS2V5VHlwZSA9IHsKICAgICAgc3RyaW5nOiB0cnVlLAogICAgICBudW1iZXI6IHRydWUKICAgIH07CiAgICB2YXIgTnVtZXJpY0lkID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIGlzTmFOKHZhbHVlKSA/IG51bGwgOiBOdW1iZXIodmFsdWUpOwogICAgfTsKICAgIHZhciBOdW1iZXJJZCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBpc05hTih2YWx1ZSkgPyBudWxsIDogTnVtYmVyKHZhbHVlKTsKICAgIH07CiAgICB2YXIgSW50SWQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gaXNOYU4odmFsdWUpID8gbnVsbCA6IHBhcnNlSW50KHZhbHVlLCAxMCk7CiAgICB9OwogICAgdmFyIFN0cmluZ0lkID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgPyBudWxsIDogU3RyaW5nKHZhbHVlKTsKICAgIH07CiAgICB2YXIgdW50aXRsZWROYW1lcyA9IHt9OwogICAgZnVuY3Rpb24gZ2V0VW50aXRsZWROYW1lKG5hbWUpIHsKICAgICAgdW50aXRsZWROYW1lc1tuYW1lXSA9IHVudGl0bGVkTmFtZXNbbmFtZV0gfHwgMDsKICAgICAgcmV0dXJuIG5hbWUgKyB1bnRpdGxlZE5hbWVzW25hbWVdKys7CiAgICB9CiAgICB2YXIgbmFtZWRUeXBlcyA9IHt9OwogICAgdmFyIG5hbWVkSW5kZXhlcyA9IHt9OwogICAgdmFyIGRlZmVycmVkVHlwZURlZiA9IHt9OwogICAgdmFyIFRZUEVfREVGSU5JVElPTl9QTEFDRUhPTERFUiA9IGZ1bmN0aW9uIFRZUEVfREVGSU5JVElPTl9QTEFDRUhPTERFUigpIHt9OwogICAgZnVuY3Rpb24gcmVzb2x2ZVR5cGUodHlwZU5hbWUsIHR5cGUpIHsKICAgICAgdmFyIGxpc3QgPSBkZWZlcnJlZFR5cGVEZWZbdHlwZU5hbWVdOwogICAgICBpZiAobGlzdCkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBkZWY7IGRlZiA9IGxpc3RbaV07IGkrKykgewogICAgICAgICAgdmFyIHR5cGVIb3N0ID0gZGVmWzBdOwogICAgICAgICAgdmFyIGZpZWxkTmFtZSA9IGRlZlsxXTsKICAgICAgICAgIHR5cGVIb3N0W2ZpZWxkTmFtZV0gPSB0eXBlOwogICAgICAgIH0KICAgICAgICBkZWxldGUgZGVmZXJyZWRUeXBlRGVmW3R5cGVOYW1lXTsKICAgICAgfQogICAgICBuYW1lZFR5cGVzW3R5cGVOYW1lXSA9IHR5cGU7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRUeXBlQnlOYW1lKHR5cGVOYW1lLCB0eXBlSG9zdCwgZmllbGQpIHsKICAgICAgaWYgKG5hbWVkVHlwZXNbdHlwZU5hbWVdKSByZXR1cm4gbmFtZWRUeXBlc1t0eXBlTmFtZV07CiAgICAgIHZhciBsaXN0ID0gZGVmZXJyZWRUeXBlRGVmW3R5cGVOYW1lXTsKICAgICAgaWYgKCFsaXN0KSBsaXN0ID0gZGVmZXJyZWRUeXBlRGVmW3R5cGVOYW1lXSA9IFtdOwogICAgICBsaXN0LnB1c2goWyB0eXBlSG9zdCwgZmllbGQgXSk7CiAgICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICB2YXIgVHlwZSA9IG5hbWVkVHlwZXNbdHlwZU5hbWVdOwogICAgICAgIGlmIChUeXBlKSByZXR1cm4gVHlwZSh2YWx1ZSwgb2xkVmFsdWUpOwogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiB0eXBlIGAiICsgdHlwZU5hbWUgKyAiYCBpcyBub3QgZGVmaW5lZCBmb3IgIiArIGZpZWxkICsgIiwgYnV0IGZ1bmN0aW9uIGNhbGxlZCIpOwogICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gdmFsaWRhdGVTY2hlbWUoKSB7CiAgICAgIGZvciAodmFyIHR5cGVOYW1lIGluIGRlZmVycmVkVHlwZURlZikgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogdHlwZSBgIiArIHR5cGVOYW1lICsgImAgaXMgbm90IGRlZmluZWQsIGJ1dCB1c2VkIGJ5ICIgKyBkZWZlcnJlZFR5cGVEZWZbdHlwZU5hbWVdLmxlbmd0aCArICIgdHlwZShzKSIpOwogICAgfQogICAgdmFyIHdhcm5Qcm9wZXJ0eUFjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIGlmIChPYmplY3QuZGVmaW5lUHJvcGVydHkpIHsKICAgICAgICAgIHZhciBvYmogPSB7fTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosICJ4IiwgewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChvYmoueCkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0LCBuYW1lLCB2YWx1ZSwgd2FybmluZykgewogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmplY3QsIG5hbWUsIHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKHdhcm5pbmcpOwogICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkge307CiAgICB9KCk7CiAgICB2YXIgSW5kZXggPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5JbmRleCIsCiAgICAgIGl0ZW1zOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbihmbikgewogICAgICAgIHRoaXMuaXRlbXMgPSB7fTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbih2YWx1ZSwgY2hlY2tUeXBlKSB7CiAgICAgICAgdmFyIGl0ZW0gPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMuaXRlbXMsIHZhbHVlKSAmJiB0aGlzLml0ZW1zW3ZhbHVlXTsKICAgICAgICBpZiAoaXRlbSAmJiAoIWNoZWNrVHlwZSB8fCBpdGVtLmVudGl0eVR5cGUgPT09IGNoZWNrVHlwZSkpIHJldHVybiBpdGVtOwogICAgICB9LAogICAgICBhZGQ6IGZ1bmN0aW9uKHZhbHVlLCBuZXdJdGVtKSB7CiAgICAgICAgaWYgKG5ld0l0ZW0pIHsKICAgICAgICAgIHZhciBjdXJJdGVtID0gdGhpcy5nZXQodmFsdWUpOwogICAgICAgICAgaWYgKCFjdXJJdGVtKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXNbdmFsdWVdID0gbmV3SXRlbTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VySXRlbSAhPT0gbmV3SXRlbSkgdGhyb3cgImJhc2lzLmVudGl0eTogVmFsdWUgYCIgKyB2YWx1ZSArICJgIGZvciBpbmRleCBpcyBhbHJlYWR5IG9jY3VwaWVkIjsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlbW92ZTogZnVuY3Rpb24odmFsdWUsIGl0ZW0pIHsKICAgICAgICBpZiAodGhpcy5pdGVtc1t2YWx1ZV0gPT09IGl0ZW0pIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLml0ZW1zW3ZhbHVlXTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5pdGVtcyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gQ2FsY3VsYXRlRmllbGQoKSB7CiAgICAgIHZhciBuYW1lcyA9IGFycmF5RnJvbShhcmd1bWVudHMpOwogICAgICB2YXIgY2FsY0ZuID0gbmFtZXMucG9wKCk7CiAgICAgIHZhciBmb28gPSBuYW1lc1swXTsKICAgICAgdmFyIGJhciA9IG5hbWVzWzFdOwogICAgICB2YXIgYmF6ID0gbmFtZXNbMl07CiAgICAgIHZhciByZXN1bHQ7CiAgICAgIGlmICh0eXBlb2YgY2FsY0ZuICE9ICJmdW5jdGlvbiIpIHRocm93ICJMYXN0IGFyZ3VtZW50IGZvciBjYWxjdWxhdGUgZmllbGQgY29uc3RydWN0b3IgbXVzdCBiZSBhIGZ1bmN0aW9uIjsKICAgICAgc3dpdGNoIChuYW1lcy5sZW5ndGgpIHsKICAgICAgICBjYXNlIDA6CiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGNhbGNGbigpOwogICAgICAgICAgfTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMToKICAgICAgICAgIHJlc3VsdCA9IGZ1bmN0aW9uKGRlbHRhLCBkYXRhLCBvbGRWYWx1ZSkgewogICAgICAgICAgICBpZiAoZm9vIGluIGRlbHRhKSByZXR1cm4gY2FsY0ZuKGRhdGFbZm9vXSk7CiAgICAgICAgICAgIHJldHVybiBvbGRWYWx1ZTsKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDI6CiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbihkZWx0YSwgZGF0YSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgaWYgKGZvbyBpbiBkZWx0YSB8fCBiYXIgaW4gZGVsdGEpIHJldHVybiBjYWxjRm4oZGF0YVtmb29dLCBkYXRhW2Jhcl0pOwogICAgICAgICAgICByZXR1cm4gb2xkVmFsdWU7CiAgICAgICAgICB9OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgcmVzdWx0ID0gZnVuY3Rpb24oZGVsdGEsIGRhdGEsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgIGlmIChmb28gaW4gZGVsdGEgfHwgYmFyIGluIGRlbHRhIHx8IGJheiBpbiBkZWx0YSkgcmV0dXJuIGNhbGNGbihkYXRhW2Zvb10sIGRhdGFbYmFyXSwgZGF0YVtiYXpdKTsKICAgICAgICAgICAgcmV0dXJuIG9sZFZhbHVlOwogICAgICAgICAgfTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbihkZWx0YSwgZGF0YSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgdmFyIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5hbWU7IG5hbWUgPSBuYW1lc1tpXTsgaSsrKSB7CiAgICAgICAgICAgICAgY2hhbmdlZCA9IGNoYW5nZWQgfHwgbmFtZSBpbiBkZWx0YTsKICAgICAgICAgICAgICBhcmdzLnB1c2goZGF0YVtuYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoYW5nZWQpIHJldHVybiBjYWxjRm4uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICAgIHJldHVybiBvbGRWYWx1ZTsKICAgICAgICAgIH07CiAgICAgIH0KICAgICAgcmVzdWx0ID0gRnVuY3Rpb24oImNhbGNGbiIsICJuYW1lcyIsICJyZXR1cm4gIiArIHJlc3VsdC50b1N0cmluZygpLnJlcGxhY2UoLyhmb298YmFyfGJheikvZywgZnVuY3Rpb24obSwgdykgewogICAgICAgIHJldHVybiAnIicgKyBuYW1lc1t3ID09ICJmb28iID8gMCA6IHcgPT0gImJhciIgPyAxIDogMl0gKyAnIic7CiAgICAgIH0pLnJlcGxhY2UoL1xbXCIoW14iXSspXCJcXS9nLCAiLiQxIikpKGNhbGNGbiwgbmFtZXMpOwogICAgICByZXN1bHQuYXJncyA9IG5hbWVzOwogICAgICByZXN1bHQuY2FsYyA9IHJlc3VsdDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIENvbmNhdFN0cmluZ0ZpZWxkKG5hbWUpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgcmV0dXJuIGZ1bmN0aW9uKGRlbHRhLCBkYXRhLCBvbGRWYWx1ZSkgewogICAgICAgIGlmIChuYW1lIGluIGRlbHRhKSByZXR1cm4gZGF0YVtuYW1lXSAhPSBudWxsID8gU3RyaW5nKGRhdGFbbmFtZV0pIDogbnVsbDsKICAgICAgICByZXR1cm4gb2xkVmFsdWU7CiAgICAgIH07CiAgICAgIHJldHVybiBDYWxjdWxhdGVGaWVsZC5hcHBseShudWxsLCBhcnJheUZyb20oYXJndW1lbnRzKS5jb25jYXQoZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IGFyZ3VtZW50cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGFyZ3VtZW50c1tpXSA9PSBudWxsKSByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmpvaW4uY2FsbChhcmd1bWVudHMsICItIik7CiAgICAgIH0pKTsKICAgIH0KICAgIHZhciBFTlRJVFlTRVRfV1JBUF9NRVRIT0QgPSBmdW5jdGlvbihzdXBlckNsYXNzLCBtZXRob2QpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICByZXR1cm4gc3VwZXJDbGFzcy5wcm90b3R5cGVbbWV0aG9kXS5jYWxsKHRoaXMsIGRhdGEgJiYgZGF0YS5tYXAodGhpcy53cmFwcGVyKSk7CiAgICAgIH07CiAgICB9OwogICAgdmFyIEVOVElUWVNFVF9JTklUX01FVEhPRCA9IGZ1bmN0aW9uKHN1cGVyQ2xhc3MsIG5hbWUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy5uYW1lKSB0aGlzLm5hbWUgPSBnZXRVbnRpdGxlZE5hbWUobmFtZSk7CiAgICAgICAgc3VwZXJDbGFzcy5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9OwogICAgfTsKICAgIHZhciBFTlRJVFlTRVRfU1lOQ19NRVRIT0QgPSBmdW5jdGlvbihzdXBlckNsYXNzKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgdmFyIGRlc3Ryb3lJdGVtcyA9IGJhc2lzLm9iamVjdC5zbGljZSh0aGlzLml0ZW1zXyk7CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIGRlbGV0ZWQgPSBbXTsKICAgICAgICBpZiAoZGF0YSkgewogICAgICAgICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUodHJ1ZSk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGVudGl0eSA9IHRoaXMud3JhcHBlcihkYXRhW2ldKTsKICAgICAgICAgICAgaWYgKGVudGl0eSkgZGVzdHJveUl0ZW1zW2VudGl0eS5iYXNpc09iamVjdElkXSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUoZmFsc2UpOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5pdGVtc18pIGlmIChrZXkgaW4gZGVzdHJveUl0ZW1zID09IGZhbHNlKSBpbnNlcnRlZC5wdXNoKHRoaXMuaXRlbXNfW2tleV0pOwogICAgICAgIGZvciAodmFyIGtleSBpbiBkZXN0cm95SXRlbXMpIGlmIChkZXN0cm95SXRlbXNba2V5XSkgZGVsZXRlZC5wdXNoKGRlc3Ryb3lJdGVtc1trZXldKTsKICAgICAgICBpZiAoZGVsZXRlZC5sZW5ndGggJiYgdGhpcy53cmFwcGVyLmFsbCkgdGhpcy53cmFwcGVyLmFsbC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICBkZWxldGVkOiBkZWxldGVkCiAgICAgICAgfSk7CiAgICAgICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUodHJ1ZSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGVkLmxlbmd0aDsgaSsrKSBkZWxldGVkW2ldLmRlc3Ryb3koKTsKICAgICAgICBEYXRhc2V0LnNldEFjY3VtdWxhdGVTdGF0ZShmYWxzZSk7CiAgICAgICAgcmV0dXJuIGluc2VydGVkLmxlbmd0aCA/IGluc2VydGVkIDogbnVsbDsKICAgICAgfTsKICAgIH07CiAgICB2YXIgRW50aXR5U2V0ID0gQ2xhc3MoRGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRW50aXR5U2V0IiwKICAgICAgbmFtZTogbnVsbCwKICAgICAgd3JhcHBlcjogJHNlbGYsCiAgICAgIGluaXQ6IEVOVElUWVNFVF9JTklUX01FVEhPRChEYXRhc2V0LCAiRW50aXR5U2V0IiksCiAgICAgIHN5bmM6IEVOVElUWVNFVF9TWU5DX01FVEhPRChEYXRhc2V0KSwKICAgICAgc2V0OiBFTlRJVFlTRVRfV1JBUF9NRVRIT0QoRGF0YXNldCwgInNldCIpLAogICAgICBhZGQ6IEVOVElUWVNFVF9XUkFQX01FVEhPRChEYXRhc2V0LCAiYWRkIiksCiAgICAgIHJlbW92ZTogRU5USVRZU0VUX1dSQVBfTUVUSE9EKERhdGFzZXQsICJyZW1vdmUiKSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgRGF0YXNldC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMud3JhcHBlciA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFJlYWRPbmx5RW50aXR5U2V0ID0gQ2xhc3MoRW50aXR5U2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5SZWFkT25seUVudGl0eVNldCIsCiAgICAgIHNldDogYmFzaXMuZm4uJGZhbHNlLAogICAgICBhZGQ6IGJhc2lzLmZuLiRmYWxzZSwKICAgICAgcmVtb3ZlOiBiYXNpcy5mbi4kZmFsc2UsCiAgICAgIGNsZWFyOiBiYXNpcy5mbi4kZmFsc2UKICAgIH0pOwogICAgdmFyIEVudGl0eUNvbGxlY3Rpb24gPSBDbGFzcyhGaWx0ZXIsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkVudGl0eUNvbGxlY3Rpb24iLAogICAgICBuYW1lOiBudWxsLAogICAgICBpbml0OiBFTlRJVFlTRVRfSU5JVF9NRVRIT0QoRmlsdGVyLCAiRW50aXR5Q29sbGVjdGlvbiIpLAogICAgICBzeW5jOiBFTlRJVFlTRVRfU1lOQ19NRVRIT0QoRmlsdGVyKQogICAgfSk7CiAgICB2YXIgRW50aXR5R3JvdXBpbmcgPSBDbGFzcyhTcGxpdCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRW50aXR5R3JvdXBpbmciLAogICAgICBuYW1lOiBudWxsLAogICAgICBzdWJzZXRDbGFzczogUmVhZE9ubHlFbnRpdHlTZXQsCiAgICAgIGluaXQ6IEVOVElUWVNFVF9JTklUX01FVEhPRChTcGxpdCwgIkVudGl0eUdyb3VwaW5nIiksCiAgICAgIHN5bmM6IEVOVElUWVNFVF9TWU5DX01FVEhPRChTcGxpdCksCiAgICAgIGdldFN1YnNldDogZnVuY3Rpb24ob2JqZWN0LCBhdXRvY3JlYXRlKSB7CiAgICAgICAgdmFyIGdyb3VwID0gU3BsaXQucHJvdG90eXBlLmdldFN1YnNldC5jYWxsKHRoaXMsIG9iamVjdCwgYXV0b2NyZWF0ZSk7CiAgICAgICAgaWYgKGdyb3VwICYmIGdyb3VwLmRhdGFzZXQpIGdyb3VwLmRhdGFzZXQud3JhcHBlciA9IHRoaXMud3JhcHBlcjsKICAgICAgICByZXR1cm4gZ3JvdXA7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIEVudGl0eVNldFdyYXBwZXIgPSBmdW5jdGlvbih3cmFwcGVyLCBuYW1lKSB7CiAgICAgIGlmICh0aGlzIGluc3RhbmNlb2YgRW50aXR5U2V0V3JhcHBlcikgewogICAgICAgIGlmICghd3JhcHBlcikgd3JhcHBlciA9ICRzZWxmOwogICAgICAgIGlmICghbmFtZSB8fCBuYW1lZFR5cGVzW25hbWVdKSB7CiAgICAgICAgICBpZiAobmFtZWRUeXBlc1tuYW1lXSkgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogRHVwbGljYXRlIGVudGl0eSBzZXQgdHlwZSBuYW1lIGAiICsgdGhpcy5uYW1lICsgImAsIG5hbWUgaWdub3JlZCIpOwogICAgICAgICAgbmFtZSA9IGdldFVudGl0bGVkTmFtZSgiVW50aXRsZWRFbnRpdHlTZXRUeXBlIik7CiAgICAgICAgfQogICAgICAgIHZhciBlbnRpdHlTZXRUeXBlID0gbmV3IEVudGl0eVNldENvbnN0cnVjdG9yKHsKICAgICAgICAgIGVudGl0eVNldENsYXNzOiB7CiAgICAgICAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5FbnRpdHlTZXQoIiArICh0eXBlb2Ygd3JhcHBlciA9PSAic3RyaW5nIiA/IHdyYXBwZXIgOiAod3JhcHBlci50eXBlIHx8IHdyYXBwZXIpLm5hbWUgfHwgIlVua25vd25UeXBlIikgKyAiKSIsCiAgICAgICAgICAgIG5hbWU6ICJTZXQgb2YgeyIgKyAodHlwZW9mIHdyYXBwZXIgPT0gInN0cmluZyIgPyB3cmFwcGVyIDogKHdyYXBwZXIudHlwZSB8fCB3cmFwcGVyKS5uYW1lIHx8ICJVbmtub3duVHlwZSIpICsgIn0iLAogICAgICAgICAgICB3cmFwcGVyOiB3cmFwcGVyCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIEVudGl0eVNldENsYXNzID0gZW50aXR5U2V0VHlwZS5lbnRpdHlTZXRDbGFzczsKICAgICAgICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24oZGF0YSwgZW50aXR5U2V0KSB7CiAgICAgICAgICBpZiAoZGF0YSAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChlbnRpdHlTZXQgaW5zdGFuY2VvZiBFbnRpdHlTZXQgPT0gZmFsc2UpIGVudGl0eVNldCA9IGVudGl0eVNldFR5cGUuY3JlYXRlRW50aXR5U2V0KCk7CiAgICAgICAgICAgIGVudGl0eVNldC5zZXQoZGF0YSBpbnN0YW5jZW9mIERhdGFzZXQgPyBkYXRhLmdldEl0ZW1zKCkgOiBhcnJheUZyb20oZGF0YSkpOwogICAgICAgICAgICByZXR1cm4gZW50aXR5U2V0OwogICAgICAgICAgfSBlbHNlIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgaWYgKHR5cGVvZiB3cmFwcGVyID09ICJzdHJpbmciKSBFbnRpdHlTZXRDbGFzcy5wcm90b3R5cGUud3JhcHBlciA9IGdldFR5cGVCeU5hbWUod3JhcHBlciwgRW50aXR5U2V0Q2xhc3MucHJvdG90eXBlLCAid3JhcHBlciIpOwogICAgICAgIHJlc29sdmVUeXBlKG5hbWUsIHJlc3VsdCk7CiAgICAgICAgZXh0ZW5kKHJlc3VsdCwgewogICAgICAgICAgdHlwZTogZW50aXR5U2V0VHlwZSwKICAgICAgICAgIHR5cGVOYW1lOiBuYW1lLAogICAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbmFtZSArICIoKSI7CiAgICAgICAgICB9LAogICAgICAgICAgcmVhZGVyOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7CiAgICAgICAgICAgICAgdmFyIHdyYXBwZXIgPSBFbnRpdHlTZXRDbGFzcy5wcm90b3R5cGUud3JhcHBlcjsKICAgICAgICAgICAgICByZXR1cm4gZGF0YS5tYXAod3JhcHBlci5yZWFkZXIgfHwgd3JhcHBlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9LAogICAgICAgICAgZXh0ZW5kQ2xhc3M6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgICAgICBFbnRpdHlTZXRDbGFzcy5leHRlbmQuY2FsbChFbnRpdHlTZXRDbGFzcywgc291cmNlKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0sCiAgICAgICAgICBleHRlbmRSZWFkZXI6IGZ1bmN0aW9uKGV4dFJlYWRlcikgewogICAgICAgICAgICB2YXIgcmVhZGVyID0gcmVzdWx0LnJlYWRlcjsKICAgICAgICAgICAgcmVzdWx0LnJlYWRlciA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkgZXh0UmVhZGVyKGRhdGEpOwogICAgICAgICAgICAgIHJldHVybiByZWFkZXIoZGF0YSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9LAogICAgICAgICAgZW50aXR5U2V0VHlwZTogZW50aXR5U2V0VHlwZSwKICAgICAgICAgIGV4dGVuZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5lbnRpdHk6IEVudGl0eVNldFR5cGUuZXh0ZW5kKCkgaXMgZGVwcmVjYXRlZCwgdXNlIEVudGl0eVNldFR5cGUuZXh0ZW5kQ2xhc3MoKSBpbnN0ZWFkLiIpOwogICAgICAgICAgICByZXR1cm4gRW50aXR5U2V0Q2xhc3MuZXh0ZW5kLmFwcGx5KEVudGl0eVNldENsYXNzLCBhcmd1bWVudHMpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHdhcm5Qcm9wZXJ0eUFjY2VzcyhyZXN1bHQsICJlbnRpdHlTZXRUeXBlIiwgZW50aXR5U2V0VHlwZSwgImJhc2lzLmVudGl0eTogRW50aXR5U2V0VHlwZS5lbnRpdHlTZXRUeXBlIGlzIGRlcHJlY2F0ZWQsIHVzZSBFbnRpdHlTZXRUeXBlLnR5cGUgaW5zdGVhZC4iKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9OwogICAgRW50aXR5U2V0V3JhcHBlci5jbGFzc05hbWUgPSBuYW1lc3BhY2UgKyAiLkVudGl0eVNldFdyYXBwZXIiOwogICAgdmFyIEVudGl0eVNldENvbnN0cnVjdG9yID0gQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRW50aXR5U2V0Q29uc3RydWN0b3IiLAogICAgICBlbnRpdHlTZXRDbGFzczogRW50aXR5U2V0LAogICAgICBleHRlbmRDb25zdHJ1Y3Rvcl86IHRydWUsCiAgICAgIGNyZWF0ZUVudGl0eVNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyB0aGlzLmVudGl0eVNldENsYXNzOwogICAgICB9CiAgICB9KTsKICAgIHZhciBFbnRpdHlUeXBlV3JhcHBlciA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIEVudGl0eVR5cGVXcmFwcGVyKSB7CiAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICBpZiAoY29uZmlnLnNpbmdsZXRvbikgcmVzdWx0ID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgdmFyIGVudGl0eSA9IGVudGl0eVR5cGUuZ2V0KCk7CiAgICAgICAgICBpZiAoZW50aXR5KSB7CiAgICAgICAgICAgIGlmIChkYXRhKSBlbnRpdHkudXBkYXRlKGRhdGEpOwogICAgICAgICAgfSBlbHNlIGVudGl0eSA9IG5ldyBFbnRpdHlDbGFzcyhkYXRhIHx8IHt9KTsKICAgICAgICAgIHJldHVybiBlbnRpdHk7CiAgICAgICAgfTsgZWxzZSByZXN1bHQgPSBmdW5jdGlvbihkYXRhLCBlbnRpdHkpIHsKICAgICAgICAgIGlmIChkYXRhICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCFlbnRpdHkgfHwgZW50aXR5LmVudGl0eVR5cGUgIT09IGVudGl0eVR5cGUpIGVudGl0eSA9IG51bGw7CiAgICAgICAgICAgIGlmIChkYXRhID09PSBlbnRpdHkgfHwgZGF0YS5lbnRpdHlUeXBlID09PSBlbnRpdHlUeXBlKSByZXR1cm4gZGF0YTsKICAgICAgICAgICAgdmFyIGlkVmFsdWU7CiAgICAgICAgICAgIHZhciBpZEZpZWxkID0gZW50aXR5VHlwZS5pZEZpZWxkOwogICAgICAgICAgICBpZiAoaXNLZXlUeXBlW3R5cGVvZiBkYXRhXSkgewogICAgICAgICAgICAgIGlmICghaWRGaWVsZCkgewogICAgICAgICAgICAgICAgaWYgKGVudGl0eVR5cGUuY29tcG9zaXRlS2V5KSBiYXNpcy5kZXYud2FybigiYmFzaXMuZW50aXR5OiBFbnRpdHkgdHlwZSBgIiArIGVudGl0eVR5cGUubmFtZSArICJgIHdyYXBwZXIgd2FzIGludm9rZWQgd2l0aCAiICsgdHlwZW9mIGRhdGEgKyAiIHZhbHVlIGFzIGluZGV4LCBidXQgZW50aXR5IHR5cGUgaW5kZXggaXMgY29tcG9zaXRlIGFuZCBjb25zaXN0cyBvZiBbIiArIGtleXMoZW50aXR5VHlwZS5pZEZpZWxkcykuam9pbigiLCAiKSArICJdIGZpZWxkcyIpOyBlbHNlIGJhc2lzLmRldi53YXJuKCJiYXNpcy5lbnRpdHk6IEVudGl0eSB0eXBlIGAiICsgZW50aXR5VHlwZS5uYW1lICsgImAgd3JhcHBlciB3YXMgaW52b2tlZCB3aXRoICIgKyB0eXBlb2YgZGF0YSArICIgdmFsdWUgYXMgaW5kZXgsIGJ1dCBlbnRpdHkgdHlwZSBoYXMgbm8gaW5kZXgiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGVudGl0eSA9IGVudGl0eVR5cGUuaW5kZXguZ2V0KGRhdGEsIGVudGl0eVR5cGUpKSByZXR1cm4gZW50aXR5OwogICAgICAgICAgICAgIGlkVmFsdWUgPSBkYXRhOwogICAgICAgICAgICAgIGRhdGEgPSB7fTsKICAgICAgICAgICAgICBkYXRhW2lkRmllbGRdID0gaWRWYWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoZW50aXR5VHlwZS5jb21wb3NpdGVLZXkpIGlkVmFsdWUgPSBlbnRpdHlUeXBlLmNvbXBvc2l0ZUtleShkYXRhLCBkYXRhKTsKICAgICAgICAgICAgICBpZiAoaWRWYWx1ZSAhPSBudWxsKSBlbnRpdHkgPSBlbnRpdHlUeXBlLmluZGV4LmdldChpZFZhbHVlLCBlbnRpdHlUeXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZW50aXR5ICYmIGVudGl0eS5lbnRpdHlUeXBlID09PSBlbnRpdHlUeXBlKSBlbnRpdHkudXBkYXRlKGRhdGEpOyBlbHNlIGVudGl0eSA9IG5ldyBFbnRpdHlDbGFzcyhkYXRhKTsKICAgICAgICAgICAgcmV0dXJuIGVudGl0eTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBlbnRpdHlUeXBlID0gbmV3IEVudGl0eVR5cGVDb25zdHJ1Y3Rvcihjb25maWcgfHwge30sIHJlc3VsdCk7CiAgICAgICAgdmFyIEVudGl0eUNsYXNzID0gZW50aXR5VHlwZS5lbnRpdHlDbGFzczsKICAgICAgICB2YXIgbmFtZSA9IGVudGl0eVR5cGUubmFtZTsKICAgICAgICByZXNvbHZlVHlwZShuYW1lLCByZXN1bHQpOwogICAgICAgIGV4dGVuZChyZXN1bHQsIHsKICAgICAgICAgIGFsbDogZW50aXR5VHlwZS5hbGwsCiAgICAgICAgICB0eXBlOiBlbnRpdHlUeXBlLAogICAgICAgICAgdHlwZU5hbWU6IG5hbWUsCiAgICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBuYW1lICsgIigpIjsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgcmV0dXJuIGVudGl0eVR5cGUuZ2V0KGRhdGEpOwogICAgICAgICAgfSwKICAgICAgICAgIGdldFNsb3Q6IGZ1bmN0aW9uKGlkLCBkZWZhdWx0cykgewogICAgICAgICAgICByZXR1cm4gZW50aXR5VHlwZS5nZXRTbG90KGlkLCBkZWZhdWx0cyk7CiAgICAgICAgICB9LAogICAgICAgICAgcmVhZGVyOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgIHJldHVybiBlbnRpdHlUeXBlLnJlYWRlcihkYXRhKTsKICAgICAgICAgIH0sCiAgICAgICAgICBleHRlbmRDbGFzczogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgICAgIEVudGl0eUNsYXNzLmV4dGVuZC5jYWxsKEVudGl0eUNsYXNzLCBzb3VyY2UpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgfSwKICAgICAgICAgIGV4dGVuZFJlYWRlcjogZnVuY3Rpb24oZXh0UmVhZGVyKSB7CiAgICAgICAgICAgIHZhciByZWFkZXIgPSByZXN1bHQucmVhZGVyOwogICAgICAgICAgICByZXN1bHQucmVhZGVyID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgIGlmIChkYXRhICYmIHR5cGVvZiBkYXRhID09ICJvYmplY3QiKSBleHRSZWFkZXIoZGF0YSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRlcihkYXRhKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0sCiAgICAgICAgICBlbnRpdHlUeXBlOiBlbnRpdHlUeXBlLAogICAgICAgICAgZXh0ZW5kOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmVudGl0eTogRW50aXR5VHlwZS5leHRlbmQoKSBpcyBkZXByZWNhdGVkLCB1c2UgRW50aXR5VHlwZS5leHRlbmRDbGFzcygpIGluc3RlYWQuIik7CiAgICAgICAgICAgIHJldHVybiBFbnRpdHlDbGFzcy5leHRlbmQuYXBwbHkoRW50aXR5Q2xhc3MsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgd2FyblByb3BlcnR5QWNjZXNzKHJlc3VsdCwgImVudGl0eVR5cGUiLCBlbnRpdHlUeXBlLCAiYmFzaXMuZW50aXR5OiBFbnRpdHlUeXBlLmVudGl0eVR5cGUgaXMgZGVwcmVjYXRlZCwgdXNlIEVudGl0eVR5cGUudHlwZSBpbnN0ZWFkLiIpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgIH07CiAgICBFbnRpdHlUeXBlV3JhcHBlci5jbGFzc05hbWUgPSBuYW1lc3BhY2UgKyAiLkVudGl0eVR5cGVXcmFwcGVyIjsKICAgIHZhciBmaWVsZERlc3Ryb3lIYW5kbGVycyA9IHt9OwogICAgdmFyIGRhdGFCdWlsZGVyRmFjdG9yeSA9IHt9OwogICAgdmFyIGNhbGNGaWVsZFdyYXBwZXIgPSBmdW5jdGlvbih2YWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4oIkNhbGN1bGF0ZSBmaWVsZHMgYXJlIHJlYWRvbmx5Iik7CiAgICAgIHJldHVybiBvbGRWYWx1ZTsKICAgIH07CiAgICBmdW5jdGlvbiBnZXREYXRhQnVpbGRlcihkZWZhdWx0cywgZmllbGRzKSB7CiAgICAgIHZhciBhcmdzID0gWyAiaGFzIiBdOwogICAgICB2YXIgdmFsdWVzID0gWyBoYXNPd25Qcm9wZXJ0eSBdOwogICAgICB2YXIgb2JqID0gW107CiAgICAgIGZvciAodmFyIGtleSBpbiBkZWZhdWx0cykgaWYgKGhhc093blByb3BlcnR5LmNhbGwoZGVmYXVsdHMsIGtleSkpIHsKICAgICAgICB2YXIgbmFtZSA9ICJ2IiArIG9iai5sZW5ndGg7CiAgICAgICAgdmFyIGZuYW1lID0gImYiICsgb2JqLmxlbmd0aDsKICAgICAgICB2YXIgdmFsdWUgPSBkZWZhdWx0c1trZXldOwogICAgICAgIGFyZ3MucHVzaChuYW1lLCBmbmFtZSk7CiAgICAgICAgdmFsdWVzLnB1c2godmFsdWUsIGZpZWxkc1trZXldKTsKICAgICAgICBvYmoucHVzaCgnIicgKyBrZXkgKyAnIjonICsgJ2hhcy5jYWxsKGRhdGEsIicgKyBrZXkgKyAnIiknICsgIj8iICsgZm5hbWUgKyAnKGRhdGFbIicgKyBrZXkgKyAnIl0sJyArIG5hbWUgKyAiKSIgKyAiOiIgKyBuYW1lICsgKHR5cGVvZiB2YWx1ZSA9PSAiZnVuY3Rpb24iID8gIihkYXRhKSIgOiAiIikpOwogICAgICB9CiAgICAgIHZhciBjb2RlID0gb2JqLnNvcnQoKS5qb2luKCIsIik7CiAgICAgIHZhciBmbiA9IGRhdGFCdWlsZGVyRmFjdG9yeVtjb2RlXTsKICAgICAgaWYgKCFmbikgZm4gPSBkYXRhQnVpbGRlckZhY3RvcnlbY29kZV0gPSBuZXcgRnVuY3Rpb24oYXJncywgInJldHVybiBmdW5jdGlvbihkYXRhKXsiICsgInJldHVybiB7IiArIGNvZGUgKyAifTsiICsgIn07Iik7CiAgICAgIHJldHVybiBmbi5hcHBseShudWxsLCB2YWx1ZXMpOwogICAgfQogICAgZnVuY3Rpb24gYXJyYXlGaWVsZChuZXdBcnJheSwgb2xkQXJyYXkpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG5ld0FycmF5KSkgcmV0dXJuIG51bGw7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShvbGRBcnJheSkgfHwgbmV3QXJyYXkubGVuZ3RoICE9IG9sZEFycmF5Lmxlbmd0aCkgcmV0dXJuIG5ld0FycmF5IHx8IG51bGw7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3QXJyYXkubGVuZ3RoOyBpKyspIGlmIChuZXdBcnJheVtpXSAhPT0gb2xkQXJyYXlbaV0pIHJldHVybiBuZXdBcnJheTsKICAgICAgcmV0dXJuIG9sZEFycmF5OwogICAgfQogICAgdmFyIGZyb21JU09TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gZmFzdERhdGVQYXJzZSh5LCBtLCBkLCBoLCBpLCBzLCBtcykgewogICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoeSwgbSAtIDEsIGQsIGggfHwgMCwgMCwgcyB8fCAwLCBtcyA/IG1zLnN1YnN0cigwLCAzKSA6IDApOwogICAgICAgIGRhdGUuc2V0TWludXRlcygoaSB8fCAwKSAtIHR6IC0gZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpKTsKICAgICAgICByZXR1cm4gZGF0ZTsKICAgICAgfQogICAgICB2YXIgdHo7CiAgICAgIHJldHVybiBmdW5jdGlvbihpc29EYXRlU3RyaW5nKSB7CiAgICAgICAgdHogPSAwOwogICAgICAgIHJldHVybiBmYXN0RGF0ZVBhcnNlLmFwcGx5KG51bGwsIFN0cmluZyhpc29EYXRlU3RyaW5nIHx8ICIiKS5yZXBsYWNlKHJlSXNvVGltZXpvbmVEZXNpZ25hdG9yLCBmdW5jdGlvbihtLCBwcmUsIGgsIGkpIHsKICAgICAgICAgIHR6ID0gaSA/IGggKiA2MCArIGkgKiAxIDogaCAqIDE7CiAgICAgICAgICByZXR1cm4gcHJlOwogICAgICAgIH0pLnNwbGl0KHJlSXNvU3RyaW5nU3BsaXQpKTsKICAgICAgfTsKICAgIH0oKTsKICAgIGZ1bmN0aW9uIGRhdGVGaWVsZCh2YWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIikgcmV0dXJuIGZyb21JU09TdHJpbmcodmFsdWUpOwogICAgICBpZiAodHlwZW9mIHZhbHVlID09ICJudW1iZXIiKSByZXR1cm4gbmV3IERhdGUodmFsdWUpOwogICAgICBpZiAodmFsdWUgPT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5jb25zdHJ1Y3RvciA9PT0gRGF0ZSkgcmV0dXJuIHZhbHVlOwogICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMuZW50aXR5OiBCYWQgdmFsdWUgZm9yIERhdGUgZmllbGQsIHZhbHVlIGlnbm9yZWQiKTsKICAgICAgcmV0dXJuIG9sZFZhbHVlOwogICAgfQogICAgZnVuY3Rpb24gYWRkRmllbGQoZW50aXR5VHlwZSwgbmFtZSwgY29uZmlnKSB7CiAgICAgIGVudGl0eVR5cGUuYWxpYXNlc1tuYW1lXSA9IG5hbWU7CiAgICAgIGlmICh0eXBlb2YgY29uZmlnID09ICJzdHJpbmciIHx8IEFycmF5LmlzQXJyYXkoY29uZmlnKSB8fCB0eXBlb2YgY29uZmlnID09ICJmdW5jdGlvbiIgJiYgY29uZmlnLmNhbGMgIT09IGNvbmZpZykgewogICAgICAgIGNvbmZpZyA9IHsKICAgICAgICAgIHR5cGU6IGNvbmZpZwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uZmlnID0gY29uZmlnID8gYmFzaXMub2JqZWN0LnNsaWNlKGNvbmZpZykgOiB7fTsKICAgICAgfQogICAgICBpZiAoInR5cGUiIGluIGNvbmZpZykgewogICAgICAgIGlmICh0eXBlb2YgY29uZmlnLnR5cGUgPT0gInN0cmluZyIpIGNvbmZpZy50eXBlID0gZ2V0VHlwZUJ5TmFtZShjb25maWcudHlwZSwgZW50aXR5VHlwZS5maWVsZHMsIG5hbWUpOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbmZpZy50eXBlKSkgewogICAgICAgICAgdmFyIHZhbHVlcyA9IGNvbmZpZy50eXBlLnNsaWNlKCk7CiAgICAgICAgICBpZiAoIXZhbHVlcy5sZW5ndGgpIGJhc2lzLmRldi53YXJuKCJFbXB0eSBhcnJheSBzZXQgYXMgdHlwZSBkZWZpbml0aW9uIGZvciAiICsgZW50aXR5VHlwZS5uYW1lICsgIiNmaWVsZC4iICsgbmFtZSArICIsIGlzIGl0IGEgYnVnPyIpOwogICAgICAgICAgaWYgKHZhbHVlcy5sZW5ndGggPT0gMSkgewogICAgICAgICAgICBjb25maWcudHlwZSA9IGJhc2lzLmZuLiRjb25zdCh2YWx1ZXNbMF0pOwogICAgICAgICAgICBjb25maWcuZGVmVmFsdWUgPSB2YWx1ZXNbMF07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWcudHlwZSA9IGZ1bmN0aW9uKHZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgIHZhciBleGlzdHMgPSB2YWx1ZXMuaW5kZXhPZih2YWx1ZSkgIT0gLTE7CiAgICAgICAgICAgICAgaWYgKCFleGlzdHMpIGJhc2lzLmRldi53YXJuKCJTZXQgdmFsdWUgdGhhdCBub3QgaW4gbGlzdCBmb3IgIiArIGVudGl0eVR5cGUubmFtZSArICIjZmllbGQuIiArIG5hbWUgKyAiIChuZXcgdmFsdWUgaWdub3JlZCkuXG5WYXJpYW50czoiLCB2YWx1ZXMsICJcbklnbm9yZWQgdmFsdWU6IiwgdmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBleGlzdHMgPyB2YWx1ZSA6IG9sZFZhbHVlOwogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25maWcuZGVmVmFsdWUgPSB2YWx1ZXMuaW5kZXhPZihjb25maWcuZGVmVmFsdWUpICE9IC0xID8gY29uZmlnLmRlZlZhbHVlIDogdmFsdWVzWzBdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoY29uZmlnLnR5cGUgPT09IEFycmF5KSBjb25maWcudHlwZSA9IGFycmF5RmllbGQ7CiAgICAgICAgaWYgKGNvbmZpZy50eXBlID09PSBEYXRlKSBjb25maWcudHlwZSA9IGRhdGVGaWVsZDsKICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy50eXBlICE9ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJFbnRpdHlUeXBlICIgKyBlbnRpdHlUeXBlLm5hbWUgKyAiOiBGaWVsZCB3cmFwcGVyIGZvciBgIiArIG5hbWUgKyAiYCBmaWVsZCBpcyBub3QgYSBmdW5jdGlvbi4gRmllbGQgd3JhcHBlciBoYXMgYmVlbiBpZ25vcmVkLiBXcmFwcGVyOiAiLCBjb25maWcudHlwZSk7CiAgICAgICAgICBjb25maWcudHlwZSA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciB3cmFwcGVyID0gY29uZmlnLnR5cGUgfHwgJHNlbGY7CiAgICAgIGlmIChjb25maWcuaWQgfHwgY29uZmlnLmluZGV4IHx8IFsgTnVtZXJpY0lkLCBOdW1iZXJJZCwgSW50SWQsIFN0cmluZ0lkIF0uaW5kZXhPZih3cmFwcGVyKSAhPSAtMSkgZW50aXR5VHlwZS5pZEZpZWxkc1tuYW1lXSA9IGNvbmZpZzsKICAgICAgaWYgKGNvbmZpZy5jYWxjKSB7CiAgICAgICAgYWRkQ2FsY0ZpZWxkKGVudGl0eVR5cGUsIG5hbWUsIGNvbmZpZy5jYWxjKTsKICAgICAgICBlbnRpdHlUeXBlLmZpZWxkc1tuYW1lXSA9IGNhbGNGaWVsZFdyYXBwZXI7CiAgICAgIH0gZWxzZSBlbnRpdHlUeXBlLmZpZWxkc1tuYW1lXSA9IHdyYXBwZXI7CiAgICAgIGVudGl0eVR5cGUuZGVmYXVsdHNbbmFtZV0gPSAiZGVmVmFsdWUiIGluIGNvbmZpZyA/IGNvbmZpZy5kZWZWYWx1ZSA6IHdyYXBwZXIoKTsKICAgICAgaWYgKCFmaWVsZERlc3Ryb3lIYW5kbGVyc1tuYW1lXSkgZmllbGREZXN0cm95SGFuZGxlcnNbbmFtZV0gPSB7CiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLnNldChuYW1lLCBudWxsKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBhZGRGaWVsZEFsaWFzKGVudGl0eVR5cGUsIGFsaWFzLCBuYW1lKSB7CiAgICAgIGlmIChuYW1lIGluIGVudGl0eVR5cGUuZmllbGRzID09IGZhbHNlKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oIkNhbid0IGFkZCBhbGlhcyBgIiArIGFsaWFzICsgImAgZm9yIG5vbi1leGlzdHMgZmllbGQgYCIgKyBuYW1lICsgImAiKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGFsaWFzIGluIGVudGl0eVR5cGUuYWxpYXNlcykgewogICAgICAgIGJhc2lzLmRldi53YXJuKCJBbGlhcyBgIiArIGFsaWFzICsgImAgYWxyZWFkeSBleGlzdHMiKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgZW50aXR5VHlwZS5hbGlhc2VzW2FsaWFzXSA9IG5hbWU7CiAgICB9CiAgICBmdW5jdGlvbiBhZGRDYWxjRmllbGQoZW50aXR5VHlwZSwgbmFtZSwgd3JhcHBlcikgewogICAgICBpZiAoIWVudGl0eVR5cGUuY2FsY3MpIGVudGl0eVR5cGUuY2FsY3MgPSBbXTsKICAgICAgdmFyIGNhbGNzID0gZW50aXR5VHlwZS5jYWxjczsKICAgICAgdmFyIGRlcHMgPSBlbnRpdHlUeXBlLmRlcHM7CiAgICAgIHZhciBjYWxjQXJncyA9IHdyYXBwZXIuYXJncyB8fCBbXTsKICAgICAgdmFyIGNhbGNDb25maWcgPSB7CiAgICAgICAgYXJnczogY2FsY0FyZ3MsCiAgICAgICAgd3JhcHBlcjogd3JhcHBlcgogICAgICB9OwogICAgICB2YXIgYmVmb3JlID0gZW50aXR5VHlwZS5jYWxjcy5sZW5ndGg7CiAgICAgIHZhciBhZnRlciA9IDA7CiAgICAgIGlmIChjYWxjQXJncykgZm9yICh2YXIgaSA9IDAsIGNhbGM7IGNhbGMgPSBjYWxjc1tpXTsgaSsrKSBpZiAoY2FsY0FyZ3MuaW5kZXhPZihjYWxjLmtleSkgIT0gLTEpIGFmdGVyID0gaSArIDE7CiAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgY2FsY0NvbmZpZy5rZXkgPSBuYW1lOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjYWxjOyBjYWxjID0gY2FsY3NbaV07IGkrKykgaWYgKGNhbGMuYXJncy5pbmRleE9mKG5hbWUpICE9IC0xKSB7CiAgICAgICAgICBiZWZvcmUgPSBpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGlmIChhZnRlciA+IGJlZm9yZSkgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIkNhbid0IGFkZCBjYWxjdWxhdGUgZmllbGQgYCIgKyBuYW1lICsgImAsIGJlY2F1c2UgcmVjdXJzaW9uIik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGRlcHNbbmFtZV0gPSBjYWxjQXJncy5yZWR1Y2UoZnVuY3Rpb24ocmVzLCByZWYpIHsKICAgICAgICAgIHZhciBpdGVtcyA9IGRlcHNbcmVmXSB8fCBbIHJlZiBdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykgYmFzaXMuYXJyYXkuYWRkKHJlcywgaXRlbXNbaV0pOwogICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICB9LCBbXSk7CiAgICAgICAgZm9yICh2YXIgcmVmIGluIGRlcHMpIHsKICAgICAgICAgIHZhciBpZHggPSBkZXBzW3JlZl0uaW5kZXhPZihuYW1lKTsKICAgICAgICAgIGlmIChpZHggIT0gLTEpIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuYXBwbHkoZGVwc1tyZWZdLCBbIGlkeCwgMSBdLmNvbmNhdChkZXBzW25hbWVdKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGJlZm9yZSA9IGFmdGVyOwogICAgICB9CiAgICAgIGNhbGNzLnNwbGljZShNYXRoLm1pbihiZWZvcmUsIGFmdGVyKSwgMCwgY2FsY0NvbmZpZyk7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRGaWVsZEdldHRlcihuYW1lKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihyZWFsKSB7CiAgICAgICAgaWYgKHJlYWwgJiYgdGhpcy5tb2RpZmllZCAmJiBuYW1lIGluIHRoaXMubW9kaWZpZWQpIHJldHVybiB0aGlzLm1vZGlmaWVkW25hbWVdOwogICAgICAgIHJldHVybiB0aGlzLmRhdGFbbmFtZV07CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBnZXRGaWVsZFNldHRlcihuYW1lKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSwgcm9sbGJhY2spIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXQobmFtZSwgdmFsdWUsIHJvbGxiYWNrKTsKICAgICAgfTsKICAgIH0KICAgIHZhciBFbnRpdHlUeXBlQ29uc3RydWN0b3IgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5FbnRpdHlUeXBlIiwKICAgICAgd3JhcHBlcjogbnVsbCwKICAgICAgYWxsOiBudWxsLAogICAgICBmaWVsZHM6IG51bGwsCiAgICAgIGlkRmllbGQ6IG51bGwsCiAgICAgIGlkRmllbGRzOiBudWxsLAogICAgICBkZWZhdWx0czogbnVsbCwKICAgICAgYWxpYXNlczogbnVsbCwKICAgICAgc2xvdHM6IG51bGwsCiAgICAgIHNpbmdsZXRvbjogZmFsc2UsCiAgICAgIGluZGV4OiBudWxsLAogICAgICBpbmRleGVzOiBudWxsLAogICAgICBlbnRpdHlDbGFzczogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24oY29uZmlnLCB3cmFwcGVyKSB7CiAgICAgICAgdGhpcy5uYW1lID0gY29uZmlnLm5hbWU7CiAgICAgICAgaWYgKCF0aGlzLm5hbWUgfHwgbmFtZWRUeXBlc1t0aGlzLm5hbWVdKSB7CiAgICAgICAgICBpZiAobmFtZWRUeXBlc1t0aGlzLm5hbWVdKSBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiBEdXBsaWNhdGUgdHlwZSBuYW1lIGAiICsgdGhpcy5uYW1lICsgImAsIG5hbWUgaWdub3JlZCIpOwogICAgICAgICAgdGhpcy5uYW1lID0gZ2V0VW50aXRsZWROYW1lKCJVbnRpdGxlZEVudGl0eVR5cGUiKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5maWVsZHMgPSB7fTsKICAgICAgICB0aGlzLmRlcHMgPSB7fTsKICAgICAgICB0aGlzLmlkRmllbGRzID0ge307CiAgICAgICAgdGhpcy5kZWZhdWx0cyA9IHt9OwogICAgICAgIHRoaXMuYWxpYXNlcyA9IHt9OwogICAgICAgIHRoaXMuc2xvdHMgPSB7fTsKICAgICAgICB2YXIgaW5kZXggPSBjb25maWcuaW5kZXg7CiAgICAgICAgaWYgKGluZGV4KSB7CiAgICAgICAgICBpZiAoaW5kZXggaW5zdGFuY2VvZiBJbmRleCkgdGhpcy5pbmRleCA9IGluZGV4OyBlbHNlIGJhc2lzLmRldi53YXJuKCJpbmRleCBtdXN0IGJlIGluc3RhbmNlb2YgYmFzaXMuZW50aXR5LkluZGV4Iik7CiAgICAgICAgfQogICAgICAgIHRoaXMud3JhcHBlciA9IHdyYXBwZXI7CiAgICAgICAgaWYgKCJhbGwiIGluIGNvbmZpZyA9PSBmYWxzZSB8fCBjb25maWcuYWxsIHx8IGNvbmZpZy5zaW5nbGV0b24pIHRoaXMuYWxsID0gbmV3IFJlYWRPbmx5RW50aXR5U2V0KGJhc2lzLm9iamVjdC5jb21wbGV0ZSh7CiAgICAgICAgICB3cmFwcGVyOiB3cmFwcGVyCiAgICAgICAgfSwgY29uZmlnLmFsbCkpOwogICAgICAgIHRoaXMuc2luZ2xldG9uID0gISFjb25maWcuc2luZ2xldG9uOwogICAgICAgIGlmICh0aGlzLnNpbmdsZXRvbikgewogICAgICAgICAgdmFyIHNpbmdsZXRvbkluc3RhbmNlOwogICAgICAgICAgdGhpcy5nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHNpbmdsZXRvbkluc3RhbmNlOwogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMuYWxsLmFkZEhhbmRsZXIoewogICAgICAgICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKHNlbmRlciwgZGVsdGEpIHsKICAgICAgICAgICAgICBzaW5nbGV0b25JbnN0YW5jZSA9IGRlbHRhLmluc2VydGVkID8gZGVsdGEuaW5zZXJ0ZWRbMF0gOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIga2V5IGluIGNvbmZpZy5maWVsZHMpIGFkZEZpZWxkKHRoaXMsIGtleSwgY29uZmlnLmZpZWxkc1trZXldKTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gY29uZmlnLmFsaWFzZXMpIGFkZEZpZWxkQWxpYXModGhpcywga2V5LCBjb25maWcuYWxpYXNlc1trZXldKTsKICAgICAgICBpZiAoY29uZmlnLmNvbnN0cmFpbnMpIGNvbmZpZy5jb25zdHJhaW5zLmZvckVhY2goZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgYWRkQ2FsY0ZpZWxkKHRoaXMsIG51bGwsIGl0ZW0pOwogICAgICAgIH0sIHRoaXMpOwogICAgICAgIHZhciBpZEZpZWxkcyA9IGtleXModGhpcy5pZEZpZWxkcyk7CiAgICAgICAgdmFyIGluZGV4ZXMgPSB7fTsKICAgICAgICBpZiAoaWRGaWVsZHMubGVuZ3RoKSB7CiAgICAgICAgICBmb3IgKHZhciBmaWVsZCBpbiB0aGlzLmlkRmllbGRzKSB7CiAgICAgICAgICAgIHZhciBmaWVsZENmZyA9IHRoaXMuaWRGaWVsZHNbZmllbGRdOwogICAgICAgICAgICB2YXIgaW5kZXggPSBmaWVsZENmZy5pbmRleDsKICAgICAgICAgICAgdmFyIGluZGV4RGVzY3JpcHRvcjsKICAgICAgICAgICAgaWYgKCFpbmRleCB8fCBpbmRleCBpbnN0YW5jZW9mIEluZGV4ID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgaWYgKGluZGV4IGluIG5hbWVkSW5kZXhlcyA9PSBmYWxzZSkgbmFtZWRJbmRleGVzW2luZGV4XSA9IG5ldyBJbmRleDsKICAgICAgICAgICAgICAgIGluZGV4ID0gbmFtZWRJbmRleGVzW2luZGV4XTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmluZGV4KSB0aGlzLmluZGV4ID0gbmV3IEluZGV4OwogICAgICAgICAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpbmRleERlc2NyaXB0b3IgPSBpbmRleGVzW2luZGV4LmJhc2lzT2JqZWN0SWRdOwogICAgICAgICAgICBpZiAoIWluZGV4RGVzY3JpcHRvcikgaW5kZXhEZXNjcmlwdG9yID0gaW5kZXhlc1tpbmRleC5iYXNpc09iamVjdElkXSA9IHsKICAgICAgICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgICAgICAgZmllbGRzOiBbXQogICAgICAgICAgICB9OwogICAgICAgICAgICBpbmRleERlc2NyaXB0b3IuZmllbGRzLnB1c2goZmllbGQpOwogICAgICAgICAgICB0aGlzLmlkRmllbGRzW2ZpZWxkXSA9IGluZGV4RGVzY3JpcHRvcjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLmluZGV4ICYmIHRoaXMuaW5kZXguYmFzaXNPYmplY3RJZCBpbiBpbmRleGVzID09IGZhbHNlKSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5lbnRpdHk6IGVudGl0eSBpbmRleCBpcyBub3QgdXNlZCBmb3IgYW55IGZpZWxkLCBpbmRleCBpZ25vcmVkIik7CiAgICAgICAgICAgIHRoaXMuaW5kZXggPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaWQgaW4gaW5kZXhlcykgewogICAgICAgICAgICB2YXIgaW5kZXhEZXNjcmlwdG9yID0gaW5kZXhlc1tpZF07CiAgICAgICAgICAgIGluZGV4RGVzY3JpcHRvci5wcm9wZXJ0eSA9ICJfX2lkX18iICsgaWQ7CiAgICAgICAgICAgIGluZGV4RGVzY3JpcHRvci5jb21wb3NpdGVLZXkgPSBDb25jYXRTdHJpbmdGaWVsZC5hcHBseShudWxsLCBpbmRleERlc2NyaXB0b3IuZmllbGRzKTsKICAgICAgICAgICAgaWYgKGluZGV4RGVzY3JpcHRvci5maWVsZHMubGVuZ3RoID09IDEpIGluZGV4RGVzY3JpcHRvci5pZEZpZWxkID0gaW5kZXhEZXNjcmlwdG9yLmZpZWxkc1swXTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbmRleGVzS2V5cyA9IGtleXMoaW5kZXhlcyk7CiAgICAgICAgICB2YXIgcHJpbWFyeUluZGV4ID0gaW5kZXhlc1t0aGlzLmluZGV4ID8gdGhpcy5pbmRleC5iYXNpc09iamVjdElkIDogaW5kZXhlc0tleXNbMF1dOwogICAgICAgICAgdGhpcy5pbmRleCA9IHByaW1hcnlJbmRleC5pbmRleDsKICAgICAgICAgIHRoaXMuaWRGaWVsZCA9IHByaW1hcnlJbmRleC5pZEZpZWxkOwogICAgICAgICAgdGhpcy5jb21wb3NpdGVLZXkgPSBwcmltYXJ5SW5kZXguY29tcG9zaXRlS2V5OwogICAgICAgICAgdGhpcy5pZFByb3BlcnR5ID0gcHJpbWFyeUluZGV4LnByb3BlcnR5OwogICAgICAgICAgdGhpcy5pbmRleGVzID0gaW5kZXhlczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHRoaXMuaW5kZXgpIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmVudGl0eTogZW50aXR5IGhhcyBubyBhbnkgaWQgZmllbGQsIGluZGV4IGlnbm9yZWQiKTsKICAgICAgICAgICAgdGhpcy5pbmRleCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpbml0RGVsdGEgPSB7fTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5kZWZhdWx0cykgaW5pdERlbHRhW2tleV0gPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5lbnRpdHlDbGFzcyA9IGNyZWF0ZUVudGl0eUNsYXNzKHRoaXMsIHRoaXMuYWxsLCB0aGlzLmZpZWxkcywgdGhpcy5zbG90cyk7CiAgICAgICAgdGhpcy5lbnRpdHlDbGFzcy5leHRlbmQoewogICAgICAgICAgZW50aXR5VHlwZTogdGhpcywKICAgICAgICAgIHR5cGU6IHdyYXBwZXIsCiAgICAgICAgICB0eXBlTmFtZTogdGhpcy5uYW1lLAogICAgICAgICAgc3RhdGU6IGNvbmZpZy5zdGF0ZSB8fCB0aGlzLmVudGl0eUNsYXNzLnByb3RvdHlwZS5zdGF0ZSwKICAgICAgICAgIGdlbmVyYXRlRGF0YTogZ2V0RGF0YUJ1aWxkZXIodGhpcy5kZWZhdWx0cywgdGhpcy5maWVsZHMpLAogICAgICAgICAgaW5pdERlbHRhOiBpbml0RGVsdGEKICAgICAgICB9KTsKICAgICAgICBmb3IgKHZhciBuYW1lIGluIHRoaXMuZmllbGRzKSB7CiAgICAgICAgICB0aGlzLmVudGl0eUNsYXNzLnByb3RvdHlwZVsiZ2V0XyIgKyBuYW1lXSA9IGdldEZpZWxkR2V0dGVyKG5hbWUpOwogICAgICAgICAgaWYgKHRoaXMuZmllbGRzW25hbWVdICE9PSBjYWxjRmllbGRXcmFwcGVyKSB0aGlzLmVudGl0eUNsYXNzLnByb3RvdHlwZVsic2V0XyIgKyBuYW1lXSA9IGdldEZpZWxkU2V0dGVyKG5hbWUpOwogICAgICAgIH0KICAgICAgICBlbnRpdHlUeXBlcy5wdXNoKHRoaXMpOwogICAgICB9LAogICAgICByZWFkZXI6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgICAgaWYgKGlzS2V5VHlwZVt0eXBlb2YgZGF0YV0pIHJldHVybiB0aGlzLmlkRmllbGQgPyBkYXRhIDogbnVsbDsKICAgICAgICBpZiAoIWRhdGEgfHwgZGF0YSA9PSBudWxsKSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgdmFyIGZpZWxkS2V5ID0gdGhpcy5hbGlhc2VzW2tleV07CiAgICAgICAgICBpZiAoZmllbGRLZXkpIHsKICAgICAgICAgICAgdmFyIHJlYWRlciA9IHRoaXMuZmllbGRzW2ZpZWxkS2V5XS5yZWFkZXI7CiAgICAgICAgICAgIHJlc3VsdFtmaWVsZEtleV0gPSByZWFkZXIgPyByZWFkZXIoZGF0YVtrZXldKSA6IGRhdGFba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbihlbnRpdHlPckRhdGEpIHsKICAgICAgICB2YXIgaWQgPSB0aGlzLmdldElkKGVudGl0eU9yRGF0YSk7CiAgICAgICAgaWYgKHRoaXMuaW5kZXggJiYgaWQgIT0gbnVsbCkgcmV0dXJuIHRoaXMuaW5kZXguZ2V0KGlkLCB0aGlzKTsKICAgICAgfSwKICAgICAgZ2V0SWQ6IGZ1bmN0aW9uKGVudGl0eU9yRGF0YSkgewogICAgICAgIGlmICh0aGlzLmNvbXBvc2l0ZUtleSAmJiBlbnRpdHlPckRhdGEgIT0gbnVsbCkgewogICAgICAgICAgaWYgKGlzS2V5VHlwZVt0eXBlb2YgZW50aXR5T3JEYXRhXSkgcmV0dXJuIGVudGl0eU9yRGF0YTsKICAgICAgICAgIGlmIChlbnRpdHlPckRhdGEgJiYgZW50aXR5T3JEYXRhLmVudGl0eVR5cGUgPT09IHRoaXMpIHJldHVybiBlbnRpdHlPckRhdGFbdGhpcy5pZFByb3BlcnR5XTsKICAgICAgICAgIGlmIChlbnRpdHlPckRhdGEgaW5zdGFuY2VvZiBEYXRhT2JqZWN0KSBlbnRpdHlPckRhdGEgPSBlbnRpdHlPckRhdGEuZGF0YTsKICAgICAgICAgIGlmICh0aGlzLmNvbXBvc2l0ZUtleSkgcmV0dXJuIHRoaXMuY29tcG9zaXRlS2V5KGVudGl0eU9yRGF0YSwgZW50aXR5T3JEYXRhKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldFNsb3Q6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB2YXIgaWQgPSB0aGlzLmdldElkKGRhdGEpOwogICAgICAgIGlmIChpZCAhPSBudWxsKSB7CiAgICAgICAgICB2YXIgc2xvdCA9IGhhc093blByb3BlcnR5LmNhbGwodGhpcy5zbG90cywgaWQpICYmIHRoaXMuc2xvdHNbaWRdOwogICAgICAgICAgaWYgKCFzbG90KSB7CiAgICAgICAgICAgIGlmIChpc0tleVR5cGVbdHlwZW9mIGRhdGFdKSB7CiAgICAgICAgICAgICAgdmFyIHRtcCA9IHt9OwogICAgICAgICAgICAgIGlmICh0aGlzLmlkRmllbGQpIHRtcFt0aGlzLmlkRmllbGRdID0gZGF0YTsKICAgICAgICAgICAgICBkYXRhID0gdG1wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNsb3QgPSB0aGlzLnNsb3RzW2lkXSA9IG5ldyBTbG90KHsKICAgICAgICAgICAgICBkZWxlZ2F0ZTogdGhpcy5nZXQoaWQpIHx8IG51bGwsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzbG90OwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBlbnRpdHlXYXJuKGVudGl0eSwgbWVzc2FnZSkgewogICAgICBiYXNpcy5kZXYud2FybigiW2Jhc2lzLmVudGl0eSAiICsgZW50aXR5LmVudGl0eVR5cGUubmFtZSArICIjIiArIGVudGl0eS5iYXNpc09iamVjdElkICsgIl0gIiArIG1lc3NhZ2UsIGVudGl0eSk7CiAgICB9CiAgICB2YXIgQmFzZUVudGl0eSA9IENsYXNzKERhdGFPYmplY3QsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkJhc2VFbnRpdHkiLAogICAgICB0YXJnZXQ6IHRydWUsCiAgICAgIHNldERlbGVnYXRlOiBmdW5jdGlvbigpIHt9LAogICAgICBleHRlbmRDb25zdHJ1Y3Rvcl86IGZhbHNlLAogICAgICBmaWVsZEhhbmRsZXJzXzogbnVsbCwKICAgICAgbW9kaWZpZWQ6IG51bGwsCiAgICAgIGVtaXRfcm9sbGJhY2tVcGRhdGU6IGNyZWF0ZUV2ZW50KCJyb2xsYmFja1VwZGF0ZSIpCiAgICB9KTsKICAgIHZhciBjcmVhdGVFbnRpdHlDbGFzcyA9IGZ1bmN0aW9uKGVudGl0eVR5cGUsIGFsbCwgZmllbGRzLCBzbG90cykgewogICAgICBmdW5jdGlvbiBjYWxjKGVudGl0eSwgZGVsdGEsIHJvbGxiYWNrRGVsdGEpIHsKICAgICAgICB2YXIgY2FsY3MgPSBlbnRpdHlUeXBlLmNhbGNzOwogICAgICAgIHZhciBkYXRhID0gZW50aXR5LmRhdGE7CiAgICAgICAgdmFyIHVwZGF0ZWQgPSBmYWxzZTsKICAgICAgICB0cnkgewogICAgICAgICAgaWYgKGNhbGNzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjYWxjOyBjYWxjID0gY2FsY3NbaV07IGkrKykgewogICAgICAgICAgICAgIHZhciBrZXkgPSBjYWxjLmtleTsKICAgICAgICAgICAgICB2YXIgb2xkVmFsdWUgPSBkYXRhW2tleV07CiAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gY2FsYy53cmFwcGVyKGRlbHRhLCBkYXRhLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgaWYgKGtleSAmJiBuZXdWYWx1ZSAhPT0gb2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgIGRlbHRhW2tleV0gPSBvbGRWYWx1ZTsKICAgICAgICAgICAgICAgIGRhdGFba2V5XSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgICAgdXBkYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpZCBpbiBlbnRpdHlUeXBlLmluZGV4ZXMpIHsKICAgICAgICAgICAgdmFyIGluZGV4RGVzY3JpcHRvciA9IGVudGl0eVR5cGUuaW5kZXhlc1tpZF07CiAgICAgICAgICAgIHZhciBjdXJJZCA9IGVudGl0eVtpbmRleERlc2NyaXB0b3IucHJvcGVydHldOwogICAgICAgICAgICB2YXIgbmV3SWQgPSBjdXJJZDsKICAgICAgICAgICAgaWYgKGluZGV4RGVzY3JpcHRvci5jb21wb3NpdGVLZXkpIG5ld0lkID0gaW5kZXhEZXNjcmlwdG9yLmNvbXBvc2l0ZUtleShkZWx0YSwgZGF0YSwgY3VySWQpOwogICAgICAgICAgICBpZiAobmV3SWQgIT09IGN1cklkKSB7CiAgICAgICAgICAgICAgdXBkYXRlSW5kZXgoaW5kZXhEZXNjcmlwdG9yLmluZGV4LCBlbnRpdHksIGN1cklkLCBuZXdJZCk7CiAgICAgICAgICAgICAgZW50aXR5W2luZGV4RGVzY3JpcHRvci5wcm9wZXJ0eV0gPSBuZXdJZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgZW50aXR5V2FybihlbnRpdHksICIocm9sbGJhY2sgY2hhbmdlcykgRXhjZXB0aW9uIG9uIGZpZWxkIGNhbGNzOiAiICsgKGUgJiYgZS5tZXNzYWdlIHx8IGUpKTsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkZWx0YSkgZW50aXR5LmRhdGFba2V5XSA9IGRlbHRhW2tleV07CiAgICAgICAgICBpZiAocm9sbGJhY2tEZWx0YSAmJiAhZW50aXR5Lm1vZGlmaWVkKSBlbnRpdHkubW9kaWZpZWQgPSByb2xsYmFja0RlbHRhOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiB1cGRhdGVJbmRleChpbmRleCwgZW50aXR5LCBjdXJWYWx1ZSwgbmV3VmFsdWUpIHsKICAgICAgICBpZiAobmV3VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgaW5kZXguYWRkKG5ld1ZhbHVlLCBlbnRpdHkpOwogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoc2xvdHMsIG5ld1ZhbHVlKSkgc2xvdHNbbmV3VmFsdWVdLnNldERlbGVnYXRlKGVudGl0eSk7CiAgICAgICAgfQogICAgICAgIGlmIChjdXJWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICBpbmRleC5yZW1vdmUoY3VyVmFsdWUsIGVudGl0eSk7CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzbG90cywgY3VyVmFsdWUpKSBzbG90c1tjdXJWYWx1ZV0uc2V0RGVsZWdhdGUoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIENsYXNzKEJhc2VFbnRpdHksIHsKICAgICAgICBjbGFzc05hbWU6IGVudGl0eVR5cGUubmFtZSwKICAgICAgICBpbml0OiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICB0aGlzLmRlbGVnYXRlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZGF0YSA9IHRoaXMuZ2VuZXJhdGVEYXRhKGRhdGEpOwogICAgICAgICAgQmFzZUVudGl0eS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIGlmIChrZXkgaW4gZmllbGRzID09IGZhbHNlKSBlbnRpdHlXYXJuKHRoaXMsICdGaWVsZCAiJyArIGtleSArICciIGlzIG5vdCBkZWZpbmVkLCB2YWx1ZSBoYXMgYmVlbiBpZ25vcmVkLicpOwogICAgICAgICAgdmFyIHZhbHVlOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuZGF0YSkgewogICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZGF0YVtrZXldOwogICAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUgIT09IHRoaXMgJiYgdmFsdWUgaW5zdGFuY2VvZiBFbWl0dGVyKSB7CiAgICAgICAgICAgICAgdmFsdWUuYWRkSGFuZGxlcihmaWVsZERlc3Ryb3lIYW5kbGVyc1trZXldLCB0aGlzKTsKICAgICAgICAgICAgICBpZiAoIXRoaXMuZmllbGRIYW5kbGVyc18pIHRoaXMuZmllbGRIYW5kbGVyc18gPSB7fTsKICAgICAgICAgICAgICB0aGlzLmZpZWxkSGFuZGxlcnNfW2tleV0gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjYWxjKHRoaXMsIHRoaXMuaW5pdERlbHRhKTsKICAgICAgICAgIGlmIChhbGwpIGFsbC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgIGluc2VydGVkOiBbIHRoaXMgXQogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gIltvYmplY3QgIiArIHRoaXMuY29uc3RydWN0b3IuY2xhc3NOYW1lICsgIigiICsgdGhpcy5lbnRpdHlUeXBlLm5hbWUgKyAiKV0iOwogICAgICAgIH0sCiAgICAgICAgZ2V0SWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHRoaXNbZW50aXR5VHlwZS5pZFByb3BlcnR5XTsKICAgICAgICB9LAogICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCByZWFsKSB7CiAgICAgICAgICBpZiAocmVhbCAmJiB0aGlzLm1vZGlmaWVkICYmIGtleSBpbiB0aGlzLm1vZGlmaWVkKSByZXR1cm4gdGhpcy5tb2RpZmllZFtrZXldOwogICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YVtrZXldOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlLCByb2xsYmFjaywgc2lsZW50XykgewogICAgICAgICAgdmFyIHZhbHVlV3JhcHBlciA9IGZpZWxkc1trZXldOwogICAgICAgICAgaWYgKCF2YWx1ZVdyYXBwZXIpIHsKICAgICAgICAgICAgZW50aXR5V2Fybih0aGlzLCAnRmllbGQgIicgKyBrZXkgKyAnIiBpcyBub3QgZGVmaW5lZCwgdmFsdWUgaGFzIGJlZW4gaWdub3JlZC4nKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICAgIHZhciByb2xsYmFja0RhdGEgPSB0aGlzLm1vZGlmaWVkOwogICAgICAgICAgaWYgKHZhbHVlV3JhcHBlciA9PT0gYXJyYXlGaWVsZCAmJiByb2xsYmFja0RhdGEgJiYga2V5IGluIHJvbGxiYWNrRGF0YSkgdmFsdWUgPSBhcnJheUZpZWxkKHZhbHVlLCByb2xsYmFja0RhdGFba2V5XSk7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSB2YWx1ZVdyYXBwZXIodmFsdWUsIHRoaXMuZGF0YVtrZXldKTsKICAgICAgICAgIHZhciBjdXJWYWx1ZSA9IHRoaXMuZGF0YVtrZXldOwogICAgICAgICAgdmFyIHZhbHVlQ2hhbmdlZCA9IG5ld1ZhbHVlICE9PSBjdXJWYWx1ZSAmJiAoIW5ld1ZhbHVlIHx8ICFjdXJWYWx1ZSB8fCBuZXdWYWx1ZS5jb25zdHJ1Y3RvciAhPT0gRGF0ZSB8fCBjdXJWYWx1ZS5jb25zdHJ1Y3RvciAhPT0gRGF0ZSB8fCArbmV3VmFsdWUgIT09ICtjdXJWYWx1ZSk7CiAgICAgICAgICBpZiAodmFsdWVDaGFuZ2VkKSB1cGRhdGVGaWVsZCA6IHsKICAgICAgICAgICAgcmVzdWx0ID0ge307CiAgICAgICAgICAgIGlmICghZW50aXR5VHlwZS5pZEZpZWxkc1trZXldKSB7CiAgICAgICAgICAgICAgaWYgKHJvbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBpZiAoIXJvbGxiYWNrRGF0YSkgdGhpcy5tb2RpZmllZCA9IHJvbGxiYWNrRGF0YSA9IHt9OwogICAgICAgICAgICAgICAgaWYgKGtleSBpbiByb2xsYmFja0RhdGEgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdC5yb2xsYmFjayA9IHsKICAgICAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHJvbGxiYWNrRGF0YVtrZXldID0gY3VyVmFsdWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAocm9sbGJhY2tEYXRhW2tleV0gPT09IG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJvbGxiYWNrID0gewogICAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbmV3VmFsdWUKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSByb2xsYmFja0RhdGFba2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWtleXMocm9sbGJhY2tEYXRhKS5sZW5ndGgpIHRoaXMubW9kaWZpZWQgPSBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChyb2xsYmFja0RhdGEgJiYga2V5IGluIHJvbGxiYWNrRGF0YSkgewogICAgICAgICAgICAgICAgICBpZiAocm9sbGJhY2tEYXRhW2tleV0gIT09IG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJvbGxiYWNrID0gewogICAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcm9sbGJhY2tEYXRhW2tleV0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHJvbGxiYWNrRGF0YVtrZXldID0gbmV3VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgdXBkYXRlRmllbGQ7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZGF0YVtrZXldID0gbmV3VmFsdWU7CiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkSGFuZGxlcnNfICYmIHRoaXMuZmllbGRIYW5kbGVyc19ba2V5XSkgewogICAgICAgICAgICAgIGN1clZhbHVlLnJlbW92ZUhhbmRsZXIoZmllbGREZXN0cm95SGFuZGxlcnNba2V5XSwgdGhpcyk7CiAgICAgICAgICAgICAgdGhpcy5maWVsZEhhbmRsZXJzX1trZXldID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld1ZhbHVlICYmIG5ld1ZhbHVlICE9PSB0aGlzICYmIG5ld1ZhbHVlIGluc3RhbmNlb2YgRW1pdHRlcikgewogICAgICAgICAgICAgIG5ld1ZhbHVlLmFkZEhhbmRsZXIoZmllbGREZXN0cm95SGFuZGxlcnNba2V5XSwgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKCF0aGlzLmZpZWxkSGFuZGxlcnNfKSB0aGlzLmZpZWxkSGFuZGxlcnNfID0ge307CiAgICAgICAgICAgICAgdGhpcy5maWVsZEhhbmRsZXJzX1trZXldID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHQua2V5ID0ga2V5OwogICAgICAgICAgICByZXN1bHQudmFsdWUgPSBjdXJWYWx1ZTsKICAgICAgICAgICAgcmVzdWx0LmRlbHRhID0ge307CiAgICAgICAgICAgIHJlc3VsdC5kZWx0YVtrZXldID0gY3VyVmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoIXJvbGxiYWNrICYmIHJvbGxiYWNrRGF0YSAmJiBrZXkgaW4gcm9sbGJhY2tEYXRhKSB7CiAgICAgICAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgICAgICAgcm9sbGJhY2s6IHsKICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgIHZhbHVlOiByb2xsYmFja0RhdGFba2V5XQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZGVsZXRlIHJvbGxiYWNrRGF0YVtrZXldOwogICAgICAgICAgICAgIGlmICgha2V5cyhyb2xsYmFja0RhdGEpLmxlbmd0aCkgdGhpcy5tb2RpZmllZCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghc2lsZW50XyAmJiByZXN1bHQpIHsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IHJlc3VsdC5rZXk7CiAgICAgICAgICAgIHZhciBkZWx0YSA9IHJlc3VsdC5kZWx0YSB8fCB7fTsKICAgICAgICAgICAgdmFyIHJvbGxiYWNrRGVsdGE7CiAgICAgICAgICAgIGlmIChyZXN1bHQucm9sbGJhY2spIHsKICAgICAgICAgICAgICByb2xsYmFja0RlbHRhID0ge307CiAgICAgICAgICAgICAgcm9sbGJhY2tEZWx0YVtyZXN1bHQucm9sbGJhY2sua2V5XSA9IHJlc3VsdC5yb2xsYmFjay52YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2FsYyh0aGlzLCBkZWx0YSwgcm9sbGJhY2tEZWx0YSkpIHVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGlmICh1cGRhdGUpIHsKICAgICAgICAgICAgICB0aGlzLmVtaXRfdXBkYXRlKGRlbHRhKTsKICAgICAgICAgICAgICByZXN1bHQuZGVsdGEgPSBkZWx0YTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocm9sbGJhY2tEZWx0YSkgdGhpcy5lbWl0X3JvbGxiYWNrVXBkYXRlKHJvbGxiYWNrRGVsdGEpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdCB8fCBmYWxzZTsKICAgICAgICB9LAogICAgICAgIHVwZGF0ZTogZnVuY3Rpb24oZGF0YSwgcm9sbGJhY2spIHsKICAgICAgICAgIHZhciB1cGRhdGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBkZWx0YSA9IHt9OwogICAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgICAgdmFyIHJvbGxiYWNrRGVsdGE7CiAgICAgICAgICAgIHZhciBzZXRSZXN1bHQ7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgICAgICAgaWYgKHNldFJlc3VsdCA9IHRoaXMuc2V0KGtleSwgZGF0YVtrZXldLCByb2xsYmFjaywgdHJ1ZSkpIHsKICAgICAgICAgICAgICAgIGlmIChzZXRSZXN1bHQua2V5KSB7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGRlbHRhW3NldFJlc3VsdC5rZXldID0gc2V0UmVzdWx0LnZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNldFJlc3VsdC5yb2xsYmFjaykgewogICAgICAgICAgICAgICAgICBpZiAoIXJvbGxiYWNrRGVsdGEpIHJvbGxiYWNrRGVsdGEgPSB7fTsKICAgICAgICAgICAgICAgICAgcm9sbGJhY2tEZWx0YVtzZXRSZXN1bHQucm9sbGJhY2sua2V5XSA9IHNldFJlc3VsdC5yb2xsYmFjay52YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNhbGModGhpcywgZGVsdGEsIHJvbGxiYWNrRGVsdGEpKSB1cGRhdGUgPSB0cnVlOwogICAgICAgICAgICBpZiAodXBkYXRlKSB0aGlzLmVtaXRfdXBkYXRlKGRlbHRhKTsKICAgICAgICAgICAgaWYgKHJvbGxiYWNrRGVsdGEpIHRoaXMuZW1pdF9yb2xsYmFja1VwZGF0ZShyb2xsYmFja0RlbHRhKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGUgPyBkZWx0YSA6IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgZ2VuZXJhdGVEYXRhOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICB9LAogICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMudXBkYXRlKHRoaXMuZ2VuZXJhdGVEYXRhKHt9KSk7CiAgICAgICAgfSwKICAgICAgICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IHt9OwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuZGF0YSkgZGF0YVtrZXldID0gdW5kZWZpbmVkOwogICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgY29tbWl0OiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICB2YXIgcm9sbGJhY2tEYXRhID0gdGhpcy5tb2RpZmllZDsKICAgICAgICAgIHRoaXMubW9kaWZpZWQgPSBudWxsOwogICAgICAgICAgaWYgKGRhdGEpIHRoaXMudXBkYXRlKGRhdGEpOwogICAgICAgICAgaWYgKHJvbGxiYWNrRGF0YSkgdGhpcy5lbWl0X3JvbGxiYWNrVXBkYXRlKHJvbGxiYWNrRGF0YSk7CiAgICAgICAgfSwKICAgICAgICByb2xsYmFjazogZnVuY3Rpb24oa2V5cykgewogICAgICAgICAgdmFyIHJvbGxiYWNrRGF0YSA9IHRoaXMubW9kaWZpZWQ7CiAgICAgICAgICBpZiAocm9sbGJhY2tEYXRhICYmIGtleXMpIHsKICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGtleXMpKSBrZXlzID0gWyBrZXlzIF07CiAgICAgICAgICAgIHJvbGxiYWNrRGF0YSA9IGJhc2lzLm9iamVjdC5zbGljZShyb2xsYmFja0RhdGEsIGtleXMucmVkdWNlKGZ1bmN0aW9uKHJlcywgaXRlbSkgewogICAgICAgICAgICAgIHJldHVybiByZXMuY29uY2F0KGVudGl0eVR5cGUuZGVwc1tpdGVtXSB8fCBpdGVtKTsKICAgICAgICAgICAgfSwgW10pKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMudXBkYXRlKHJvbGxiYWNrRGF0YSwgdHJ1ZSk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICh0aGlzLmZpZWxkSGFuZGxlcnNfKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmZpZWxkSGFuZGxlcnNfKSBpZiAodGhpcy5maWVsZEhhbmRsZXJzX1trZXldKSB0aGlzLmRhdGFba2V5XS5yZW1vdmVIYW5kbGVyKGZpZWxkRGVzdHJveUhhbmRsZXJzW2tleV0sIHRoaXMpOwogICAgICAgICAgICB0aGlzLmZpZWxkSGFuZGxlcnNfID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGtleSBpbiBlbnRpdHlUeXBlLmluZGV4ZXMpIHsKICAgICAgICAgICAgdmFyIGluZGV4RGVzY3JpcHRvciA9IGVudGl0eVR5cGUuaW5kZXhlc1trZXldOwogICAgICAgICAgICB2YXIgaWQgPSB0aGlzW2luZGV4RGVzY3JpcHRvci5wcm9wZXJ0eV07CiAgICAgICAgICAgIGlmIChpZCAhPSBudWxsKSB1cGRhdGVJbmRleChpbmRleERlc2NyaXB0b3IuaW5kZXgsIHRoaXMsIGlkLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhbGwgJiYgYWxsLmhhcyh0aGlzKSkgYWxsLmVtaXRfaXRlbXNDaGFuZ2VkKHsKICAgICAgICAgICAgZGVsZXRlZDogWyB0aGlzIF0KICAgICAgICAgIH0pOwogICAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgICAgdGhpcy5kYXRhID0gTlVMTF9JTkZPOwogICAgICAgICAgdGhpcy5tb2RpZmllZCA9IG51bGw7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CiAgICBmdW5jdGlvbiBpc0VudGl0eSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgJiYgdmFsdWUgaW5zdGFuY2VvZiBCYXNlRW50aXR5OwogICAgfQogICAgZnVuY3Rpb24gY3JlYXRlVHlwZShjb25maWdPck5hbWUsIGZpZWxkcykgewogICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIGNyZWF0ZVR5cGUpIGJhc2lzLmRldi53YXJuKCJgbmV3YCBvcGVyYXRvciB3YXMgdXNlZCB3aXRoIGJhc2lzLmVudGl0eS5jcmVhdGVUeXBlLCBpdCdzIGEgbWlzdGFrZSIpOwogICAgICB2YXIgY29uZmlnID0gY29uZmlnT3JOYW1lIHx8IHt9OwogICAgICBpZiAodHlwZW9mIGNvbmZpZ09yTmFtZSA9PSAic3RyaW5nIikgewogICAgICAgIGNvbmZpZyA9IHsKICAgICAgICAgIG5hbWU6IGNvbmZpZywKICAgICAgICAgIGZpZWxkczogZmllbGRzIHx8IHt9CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZmllbGRzKSBjb25maWcgPSBiYXNpcy5vYmplY3QubWVyZ2UoY29uZmlnLCB7CiAgICAgICAgICBmaWVsZHM6IGZpZWxkcwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgRW50aXR5VHlwZVdyYXBwZXIoY29uZmlnKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNyZWF0ZVNldFR5cGUobmFtZU9yV3JhcHBlciwgd3JhcHBlcikgewogICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIGNyZWF0ZVNldFR5cGUpIGJhc2lzLmRldi53YXJuKCJgbmV3YCBvcGVyYXRvciB3YXMgdXNlZCB3aXRoIGJhc2lzLmVudGl0eS5jcmVhdGVTZXRUeXBlLCBpdCdzIGEgbWlzdGFrZSIpOwogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBuZXcgRW50aXR5U2V0V3JhcHBlcih3cmFwcGVyLCBuYW1lT3JXcmFwcGVyKSA6IG5ldyBFbnRpdHlTZXRXcmFwcGVyKG5hbWVPcldyYXBwZXIpOwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGlzRW50aXR5OiBpc0VudGl0eSwKICAgICAgY3JlYXRlVHlwZTogY3JlYXRlVHlwZSwKICAgICAgY3JlYXRlU2V0VHlwZTogY3JlYXRlU2V0VHlwZSwKICAgICAgdmFsaWRhdGU6IHZhbGlkYXRlU2NoZW1lLAogICAgICBnZXRUeXBlQnlOYW1lOiBmdW5jdGlvbih0eXBlTmFtZSkgewogICAgICAgIHJldHVybiBuYW1lZFR5cGVzW3R5cGVOYW1lXTsKICAgICAgfSwKICAgICAgZ2V0SW5kZXhCeU5hbWU6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICByZXR1cm4gbmFtZWRJbmRleGVzW25hbWVdOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKHR5cGVOYW1lLCB2YWx1ZSkgewogICAgICAgIHZhciBUeXBlID0gbmFtZWRUeXBlc1t0eXBlTmFtZV07CiAgICAgICAgaWYgKFR5cGUpIHJldHVybiBUeXBlLmdldCh2YWx1ZSk7CiAgICAgIH0sCiAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKHR5cGVOYW1lLCB2YWx1ZSkgewogICAgICAgIHZhciBUeXBlID0gbmFtZWRUeXBlc1t0eXBlTmFtZV07CiAgICAgICAgaWYgKFR5cGUpIHJldHVybiBUeXBlKHZhbHVlKTsKICAgICAgfSwKICAgICAgZ2V0QnlJbmRleDogZnVuY3Rpb24oaW5kZXhOYW1lLCBpZCkgewogICAgICAgIGlmIChpbmRleE5hbWUgaW4gbmFtZWRJbmRleGVzKSByZXR1cm4gbmFtZWRJbmRleGVzW2luZGV4TmFtZV0uZ2V0KGlkKTsgZWxzZSBiYXNpcy5kZXYud2FybigiYmFzaXMuZW50aXR5OiBpbmRleCB3aXRoIG5hbWUgYCIgKyBpbmRleE5hbWUgKyAiYCBkb2Vzbid0IGV4aXN0cyIpOwogICAgICB9LAogICAgICBOdW1lcmljSWQ6IE51bWVyaWNJZCwKICAgICAgTnVtYmVySWQ6IE51bWJlcklkLAogICAgICBJbnRJZDogSW50SWQsCiAgICAgIFN0cmluZ0lkOiBTdHJpbmdJZCwKICAgICAgSW5kZXg6IEluZGV4LAogICAgICBDYWxjdWxhdGVGaWVsZDogQ2FsY3VsYXRlRmllbGQsCiAgICAgIENvbmNhdFN0cmluZ0ZpZWxkOiBDb25jYXRTdHJpbmdGaWVsZCwKICAgICAgY2FsYzogQ2FsY3VsYXRlRmllbGQsCiAgICAgIEVudGl0eVR5cGU6IEVudGl0eVR5cGVXcmFwcGVyLAogICAgICBFbnRpdHk6IGNyZWF0ZUVudGl0eUNsYXNzLAogICAgICBCYXNlRW50aXR5OiBCYXNlRW50aXR5LAogICAgICBFbnRpdHlTZXRUeXBlOiBFbnRpdHlTZXRXcmFwcGVyLAogICAgICBFbnRpdHlTZXQ6IEVudGl0eVNldCwKICAgICAgUmVhZE9ubHlFbnRpdHlTZXQ6IFJlYWRPbmx5RW50aXR5U2V0LAogICAgICBDb2xsZWN0aW9uOiBFbnRpdHlDb2xsZWN0aW9uLAogICAgICBHcm91cGluZzogRW50aXR5R3JvdXBpbmcKICAgIH07CiAgfSwKICAiaS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi9qLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgZXNjYXBlVmFsdWUgPSBnbG9iYWwuZW5jb2RlVVJJQ29tcG9uZW50OwogICAgdmFyIGV4dGVuZCA9IGJhc2lzLm9iamVjdC5leHRlbmQ7CiAgICB2YXIgb2JqZWN0U2xpY2UgPSBiYXNpcy5vYmplY3Quc2xpY2U7CiAgICB2YXIgb2JqZWN0TWVyZ2UgPSBiYXNpcy5vYmplY3QubWVyZ2U7CiAgICB2YXIgY3JlYXRlVHJhbnNwb3J0RXZlbnQgPSBiYXNpcy5uZXQuY3JlYXRlVHJhbnNwb3J0RXZlbnQ7CiAgICB2YXIgY3JlYXRlUmVxdWVzdEV2ZW50ID0gYmFzaXMubmV0LmNyZWF0ZVJlcXVlc3RFdmVudDsKICAgIHZhciBBYnN0cmFjdFJlcXVlc3QgPSBiYXNpcy5uZXQuQWJzdHJhY3RSZXF1ZXN0OwogICAgdmFyIEFic3RyYWN0VHJhbnNwb3J0ID0gYmFzaXMubmV0LkFic3RyYWN0VHJhbnNwb3J0OwogICAgdmFyIFNUQVRFID0gYmFzaXMuZGF0YS5TVEFURTsKICAgIHZhciBTVEFURV9VTlNFTlQgPSAwOwogICAgdmFyIFNUQVRFX09QRU5FRCA9IDE7CiAgICB2YXIgU1RBVEVfTE9BRElORyA9IDM7CiAgICB2YXIgU1RBVEVfRE9ORSA9IDQ7CiAgICB2YXIgY2FsbGJhY2tEYXRhID0ge307CiAgICBmdW5jdGlvbiBnZXRDYWxsYmFjaygpIHsKICAgICAgdmFyIG5hbWUgPSAiYmFzaXNqc0pzb25wQ2FsbGJhY2siICsgcGFyc2VJbnQoTWF0aC5yYW5kb20oKSAqIDFlMTEpOwogICAgICBnbG9iYWxbbmFtZV0gPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgY2FsbGJhY2tEYXRhW25hbWVdID0gZGF0YTsKICAgICAgfTsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CiAgICBmdW5jdGlvbiBmZXRjaENhbGxiYWNrRGF0YShuYW1lKSB7CiAgICAgIHZhciBkYXRhID0gY2FsbGJhY2tEYXRhW25hbWVdOwogICAgICBkZWxldGUgY2FsbGJhY2tEYXRhW25hbWVdOwogICAgICByZXR1cm4gZGF0YTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlbGVhc2VDYWxsYmFjayhuYW1lKSB7CiAgICAgIGRlbGV0ZSBjYWxsYmFja0RhdGFbbmFtZV07CiAgICAgIGRlbGV0ZSBnbG9iYWxbbmFtZV07CiAgICB9CiAgICBmdW5jdGlvbiByZWFkeVN0YXRlQ2hhbmdlSGFuZGxlcihyZWFkeVN0YXRlLCBhYm9ydCkgewogICAgICB2YXIgbmV3U3RhdGU7CiAgICAgIHZhciBuZXdTdGF0ZURhdGE7CiAgICAgIHZhciBlcnJvciA9IGZhbHNlOwogICAgICBpZiAodHlwZW9mIHJlYWR5U3RhdGUgIT0gIm51bWJlciIpIHsKICAgICAgICBpZiAoIXJlYWR5U3RhdGUgfHwgdGhpcy5zY3JpcHQgIT09IHJlYWR5U3RhdGUudGFyZ2V0KSByZXR1cm47CiAgICAgICAgZXJyb3IgPSByZWFkeVN0YXRlICYmIHJlYWR5U3RhdGUudHlwZSA9PSAiZXJyb3IiOwogICAgICAgIHJlYWR5U3RhdGUgPSBlcnJvciB8fCAhdGhpcy5zY3JpcHQucmVhZHlTdGF0ZSB8fCAvbG9hZGVkfGNvbXBsZXRlLy50ZXN0KHRoaXMuc2NyaXB0LnJlYWR5U3RhdGUpID8gU1RBVEVfRE9ORSA6IFNUQVRFX0xPQURJTkc7CiAgICAgIH0KICAgICAgaWYgKHJlYWR5U3RhdGUgPT0gdGhpcy5wcmV2UmVhZHlTdGF0ZV8pIHJldHVybjsKICAgICAgdGhpcy5wcmV2UmVhZHlTdGF0ZV8gPSByZWFkeVN0YXRlOwogICAgICB0aGlzLmVtaXRfcmVhZHlTdGF0ZUNoYW5nZWQocmVhZHlTdGF0ZSk7CiAgICAgIGlmIChyZWFkeVN0YXRlID09IFNUQVRFX0RPTkUpIHsKICAgICAgICB0aGlzLmNsZWFyVGltZW91dCgpOwogICAgICAgIHRoaXMuc2NyaXB0Lm9ubG9hZCA9IHRoaXMuc2NyaXB0Lm9uZXJyb3IgPSB0aGlzLnNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwogICAgICAgIGlmICh0aGlzLnNjcmlwdC5wYXJlbnROb2RlKSB0aGlzLnNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMuc2NyaXB0KTsKICAgICAgICB0aGlzLnNjcmlwdCA9IG51bGw7CiAgICAgICAgaWYgKGFib3J0KSB7CiAgICAgICAgICB0aGlzLmVtaXRfYWJvcnQoKTsKICAgICAgICAgIG5ld1N0YXRlID0gdGhpcy5zdGF0ZU9uQWJvcnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMucHJvY2Vzc1Jlc3BvbnNlKCk7CiAgICAgICAgICBpZiAodGhpcy5pc1N1Y2Nlc3NmdWwoKSAmJiAhZXJyb3IpIHsKICAgICAgICAgICAgbmV3U3RhdGUgPSBTVEFURS5SRUFEWTsKICAgICAgICAgICAgdGhpcy5lbWl0X3N1Y2Nlc3ModGhpcy5nZXRSZXNwb25zZURhdGEoKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdTdGF0ZSA9IFNUQVRFLkVSUk9SOwogICAgICAgICAgICBuZXdTdGF0ZURhdGEgPSB0aGlzLmdldFJlc3BvbnNlRXJyb3IoKTsKICAgICAgICAgICAgdGhpcy5lbWl0X2ZhaWx1cmUobmV3U3RhdGVEYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5lbWl0X2NvbXBsZXRlKHRoaXMpOwogICAgICAgIHZhciBjYWxsYmFjayA9IHRoaXMuY2FsbGJhY2s7CiAgICAgICAgaWYgKGFib3J0KSB7CiAgICAgICAgICBzZXRUaW1lb3V0KGdsb2JhbFtjYWxsYmFja10gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmVsZWFzZUNhbGxiYWNrKGNhbGxiYWNrKTsKICAgICAgICAgIH0sIDUgKiA2MCAqIDFlMyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlbGVhc2VDYWxsYmFjayhjYWxsYmFjayk7CiAgICAgICAgfQogICAgICB9IGVsc2UgbmV3U3RhdGUgPSBTVEFURS5QUk9DRVNTSU5HOwogICAgICB0aGlzLnNldFN0YXRlKG5ld1N0YXRlLCBuZXdTdGF0ZURhdGEpOwogICAgfQogICAgdmFyIFJlcXVlc3QgPSBBYnN0cmFjdFJlcXVlc3Quc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuUmVxdWVzdCIsCiAgICAgIHRpbWVvdXQ6IDNlNCwKICAgICAgdGltZXJfOiBudWxsLAogICAgICBlbWl0X3JlYWR5U3RhdGVDaGFuZ2VkOiBjcmVhdGVSZXF1ZXN0RXZlbnQoInJlYWR5U3RhdGVDaGFuZ2VkIiksCiAgICAgIGlzSWRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICF0aGlzLnNjcmlwdDsKICAgICAgfSwKICAgICAgaXNTdWNjZXNzZnVsOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhLnN0YXR1cyA9PSAyMDA7CiAgICAgIH0sCiAgICAgIHByb2Nlc3NSZXNwb25zZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuY2FsbGJhY2sgaW4gY2FsbGJhY2tEYXRhKSB0aGlzLnVwZGF0ZSh7CiAgICAgICAgICBjb250ZW50VHlwZTogImFwcGxpY2F0aW9uL2phdmFzY3JpcHQiLAogICAgICAgICAgZGF0YTogZmV0Y2hDYWxsYmFja0RhdGEodGhpcy5jYWxsYmFjayksCiAgICAgICAgICBzdGF0dXM6IDIwMAogICAgICAgIH0pOwogICAgICB9LAogICAgICBnZXRSZXNwb25zZURhdGE6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmRhdGEuZGF0YTsKICAgICAgfSwKICAgICAgZ2V0UmVzcG9uc2VFcnJvcjogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNvZGU6ICJFUlJPUiIsCiAgICAgICAgICBtc2c6ICJFUlJPUiIKICAgICAgICB9OwogICAgICB9LAogICAgICBwcmVwYXJlOiBiYXNpcy5mbi4kdHJ1ZSwKICAgICAgcHJlcGFyZVJlcXVlc3REYXRhOiBmdW5jdGlvbihyZXF1ZXN0RGF0YSkgewogICAgICAgIHZhciBwYXJhbXMgPSBbXTsKICAgICAgICB2YXIgdXJsID0gcmVxdWVzdERhdGEudXJsOwogICAgICAgIHJlcXVlc3REYXRhID0gb2JqZWN0U2xpY2UocmVxdWVzdERhdGEpOwogICAgICAgIHRoaXMuY2FsbGJhY2sgPSBnZXRDYWxsYmFjaygpOwogICAgICAgIGZvciAodmFyIGtleSBpbiByZXF1ZXN0RGF0YS5wYXJhbXMpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHJlcXVlc3REYXRhLnBhcmFtc1trZXldOwogICAgICAgICAgaWYgKHZhbHVlID09IG51bGwgfHwgdmFsdWUudG9TdHJpbmcoKSA9PSBudWxsKSBjb250aW51ZTsKICAgICAgICAgIHBhcmFtcy5wdXNoKGVzY2FwZVZhbHVlKGtleSkgKyAiPSIgKyBlc2NhcGVWYWx1ZSh2YWx1ZS50b1N0cmluZygpKSk7CiAgICAgICAgfQogICAgICAgIHBhcmFtcy5wdXNoKGVzY2FwZVZhbHVlKHJlcXVlc3REYXRhLmNhbGxiYWNrUGFyYW0pICsgIj0iICsgZXNjYXBlVmFsdWUodGhpcy5jYWxsYmFjaykpOwogICAgICAgIHBhcmFtcyA9IHBhcmFtcy5qb2luKCImIik7CiAgICAgICAgaWYgKHJlcXVlc3REYXRhLnJvdXRlclBhcmFtcykgdXJsID0gdXJsLnJlcGxhY2UoLzooW2EtelxfXC1dW2EtejAtOVxfXC1dKykvZ2ksIGZ1bmN0aW9uKG0sIGtleSkgewogICAgICAgICAgaWYgKGtleSBpbiByZXF1ZXN0RGF0YS5yb3V0ZXJQYXJhbXMpIHJldHVybiByZXF1ZXN0RGF0YS5yb3V0ZXJQYXJhbXNba2V5XTsgZWxzZSByZXR1cm4gbTsKICAgICAgICB9KTsKICAgICAgICBpZiAocGFyYW1zKSB1cmwgKz0gKHVybC5pbmRleE9mKCI/IikgPT0gLTEgPyAiPyIgOiAiJiIpICsgcGFyYW1zOwogICAgICAgIHJlcXVlc3REYXRhLnJlcXVlc3RVcmwgPSB1cmw7CiAgICAgICAgcmV0dXJuIHJlcXVlc3REYXRhOwogICAgICB9LAogICAgICBkb1JlcXVlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2VuZCh0aGlzLnByZXBhcmVSZXF1ZXN0RGF0YSh0aGlzLnJlcXVlc3REYXRhKSk7CiAgICAgIH0sCiAgICAgIHNlbmQ6IGZ1bmN0aW9uKHJlcXVlc3REYXRhKSB7CiAgICAgICAgaWYgKCFkb2N1bWVudCkgdGhyb3cgIkpTT05QIGlzIG5vdCBzdXBwb3J0ZWQgZm9yIGN1cnJlbnQgZW52aXJvbm1lbnQiOwogICAgICAgIHZhciBoZWFkID0gZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5nZXRFbGVtZW50QnlOYW1lKCJoZWFkIilbMF0gfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICB0aGlzLnVwZGF0ZSh7CiAgICAgICAgICBkYXRhOiB1bmRlZmluZWQsCiAgICAgICAgICBzdGF0dXM6ICIiLAogICAgICAgICAgZXJyb3I6ICIiCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5zY3JpcHQgPSBzY3JpcHQ7CiAgICAgICAgc2NyaXB0LmFzeW5jID0gdHJ1ZTsKICAgICAgICBzY3JpcHQuc3JjID0gcmVxdWVzdERhdGEucmVxdWVzdFVybDsKICAgICAgICBzY3JpcHQuY2hhcnNldCA9IHJlcXVlc3REYXRhLmVuY29kaW5nOwogICAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25lcnJvciA9IHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByZWFkeVN0YXRlQ2hhbmdlSGFuZGxlci5iaW5kKHRoaXMpOwogICAgICAgIHRoaXMucHJldlJlYWR5U3RhdGVfID0gLTE7CiAgICAgICAgdGhpcy5lbWl0X3N0YXJ0KCk7CiAgICAgICAgcmVhZHlTdGF0ZUNoYW5nZUhhbmRsZXIuY2FsbCh0aGlzLCBTVEFURV9VTlNFTlQpOwogICAgICAgIHRoaXMuc2V0VGltZW91dCh0aGlzLnRpbWVvdXQpOwogICAgICAgIGhlYWQuYXBwZW5kQ2hpbGQodGhpcy5zY3JpcHQpOwogICAgICB9LAogICAgICByZXBlYXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnJlcXVlc3REYXRhKSB7CiAgICAgICAgICB0aGlzLmFib3J0KCk7CiAgICAgICAgICB0aGlzLmRvUmVxdWVzdCgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYWJvcnQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy5pc0lkbGUoKSkgewogICAgICAgICAgdGhpcy5jbGVhclRpbWVvdXQoKTsKICAgICAgICAgIHJlYWR5U3RhdGVDaGFuZ2VIYW5kbGVyLmNhbGwodGhpcywgU1RBVEVfRE9ORSwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRUaW1lb3V0OiBmdW5jdGlvbih0aW1lb3V0KSB7CiAgICAgICAgdGhpcy50aW1lcl8gPSBzZXRUaW1lb3V0KHRoaXMudGltZW91dEFib3J0LmJpbmQodGhpcyksIHRpbWVvdXQpOwogICAgICB9LAogICAgICBjbGVhclRpbWVvdXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnRpbWVyXykgdGhpcy50aW1lcl8gPSBjbGVhclRpbWVvdXQodGhpcy50aW1lcl8pOwogICAgICB9LAogICAgICB0aW1lb3V0QWJvcnQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudXBkYXRlKHsKICAgICAgICAgIGVycm9yOiB7CiAgICAgICAgICAgIGNvZGU6ICJUSU1FT1VUX0VSUk9SIiwKICAgICAgICAgICAgbWVzc2FnZTogIlRpbWVvdXQgZXJyb3IiCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5lbWl0X3RpbWVvdXQodGhpcyk7CiAgICAgICAgdGhpcy5hYm9ydCgpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmFib3J0KCk7CiAgICAgICAgQWJzdHJhY3RSZXF1ZXN0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFRyYW5zcG9ydCA9IEFic3RyYWN0VHJhbnNwb3J0LnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlRyYW5zcG9ydCIsCiAgICAgIHJlcXVlc3RDbGFzczogUmVxdWVzdCwKICAgICAgZW1pdF9yZWFkeVN0YXRlQ2hhbmdlZDogY3JlYXRlUmVxdWVzdEV2ZW50KCJyZWFkeVN0YXRlQ2hhbmdlZCIpLAogICAgICBlbmNvZGluZzogbnVsbCwKICAgICAgcGFyYW1zOiBudWxsLAogICAgICBjYWxsYmFja1BhcmFtOiAiY2FsbGJhY2siLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdFRyYW5zcG9ydC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMucGFyYW1zID0gb2JqZWN0U2xpY2UodGhpcy5wYXJhbXMpOwogICAgICB9LAogICAgICBzZXRQYXJhbTogZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgICB0aGlzLnBhcmFtc1tuYW1lXSA9IHZhbHVlOwogICAgICB9LAogICAgICBzZXRQYXJhbXM6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgIHRoaXMuY2xlYXJQYXJhbXMoKTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gcGFyYW1zKSB0aGlzLnNldFBhcmFtKGtleSwgcGFyYW1zW2tleV0pOwogICAgICB9LAogICAgICByZW1vdmVQYXJhbTogZnVuY3Rpb24obmFtZSkgewogICAgICAgIGRlbGV0ZSB0aGlzLnBhcmFtc1tuYW1lXTsKICAgICAgfSwKICAgICAgY2xlYXJQYXJhbXM6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnBhcmFtcykgZGVsZXRlIHRoaXMucGFyYW1zW2tleV07CiAgICAgIH0sCiAgICAgIHByZXBhcmVSZXF1ZXN0RGF0YTogZnVuY3Rpb24ocmVxdWVzdERhdGEpIHsKICAgICAgICB2YXIgdXJsID0gcmVxdWVzdERhdGEudXJsIHx8IHRoaXMudXJsOwogICAgICAgIGlmICghdXJsKSB0aHJvdyBuZXcgRXJyb3IoIlVSTCBpcyBub3QgZGVmaW5lZCIpOwogICAgICAgIGV4dGVuZChyZXF1ZXN0RGF0YSwgewogICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICBlbmNvZGluZzogcmVxdWVzdERhdGEuZW5jb2RpbmcgfHwgdGhpcy5lbmNvZGluZywKICAgICAgICAgIHBhcmFtczogb2JqZWN0TWVyZ2UodGhpcy5wYXJhbXMsIHJlcXVlc3REYXRhLnBhcmFtcyksCiAgICAgICAgICByb3V0ZXJQYXJhbXM6IHJlcXVlc3REYXRhLnJvdXRlclBhcmFtcywKICAgICAgICAgIGNhbGxiYWNrUGFyYW06IHJlcXVlc3REYXRhLmNhbGxiYWNrUGFyYW0gfHwgdGhpcy5jYWxsYmFja1BhcmFtLAogICAgICAgICAgaW5mbHVlbmNlOiByZXF1ZXN0RGF0YS5pbmZsdWVuY2UKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVxdWVzdERhdGE7CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFJlcXVlc3Q6IFJlcXVlc3QsCiAgICAgIFRyYW5zcG9ydDogVHJhbnNwb3J0LAogICAgICByZXF1ZXN0OiBmdW5jdGlvbihjb25maWcsIHN1Y2Nlc3NDYWxsYmFjaywgZmFpbHVyZUNhbGxiYWNrKSB7CiAgICAgICAgaWYgKHR5cGVvZiBjb25maWcgPT0gInN0cmluZyIpIGNvbmZpZyA9IHsKICAgICAgICAgIHVybDogY29uZmlnCiAgICAgICAgfTsKICAgICAgICB2YXIgdHJhbnNwb3J0ID0gbmV3IFRyYW5zcG9ydChjb25maWcpOwogICAgICAgIHRyYW5zcG9ydC5hZGRIYW5kbGVyKHsKICAgICAgICAgIHN1Y2Nlc3M6IHN1Y2Nlc3NDYWxsYmFjayAmJiBmdW5jdGlvbihzZW5kZXIsIHJlcSwgZGF0YSkgewogICAgICAgICAgICBzdWNjZXNzQ2FsbGJhY2soZGF0YSk7CiAgICAgICAgICB9LAogICAgICAgICAgZmFpbHVyZTogZmFpbHVyZUNhbGxiYWNrICYmIGZ1bmN0aW9uKHNlbmRlciwgcmVxLCBlcnJvcikgewogICAgICAgICAgICBmYWlsdXJlQ2FsbGJhY2soZXJyb3IpOwogICAgICAgICAgfSwKICAgICAgICAgIGNvbXBsZXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgYmFzaXMubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdHJhbnNwb3J0LmRlc3Ryb3koKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdHJhbnNwb3J0LnJlcXVlc3QoKTsKICAgICAgfQogICAgfTsKICB9LAogICJqLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzMuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNC5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBleHRlbmQgPSBiYXNpcy5vYmplY3QuZXh0ZW5kOwogICAgdmFyIGFycmF5RnJvbSA9IGJhc2lzLmFycmF5LmZyb207CiAgICB2YXIgb2JqZWN0U2xpY2UgPSBiYXNpcy5vYmplY3Quc2xpY2U7CiAgICB2YXIgb2JqZWN0TWVyZ2UgPSBiYXNpcy5vYmplY3QubWVyZ2U7CiAgICB2YXIgY3JlYXRlRXZlbnQgPSBiYXNpcy5ldmVudC5jcmVhdGU7CiAgICB2YXIgU1RBVEUgPSBiYXNpcy5kYXRhLlNUQVRFOwogICAgdmFyIERhdGFPYmplY3QgPSBiYXNpcy5kYXRhLk9iamVjdDsKICAgIHZhciBFbWl0dGVyID0gYmFzaXMuZXZlbnQuRW1pdHRlcjsKICAgIGZ1bmN0aW9uIGNyZWF0ZVRyYW5zcG9ydEV2ZW50KGV2ZW50TmFtZSkgewogICAgICB2YXIgZXZlbnQgPSBjcmVhdGVFdmVudChldmVudE5hbWUpOwogICAgICByZXR1cm4gZnVuY3Rpb24gdHJhbnNwb3J0RXZlbnQoKSB7CiAgICAgICAgZXZlbnQuYXBwbHkodHJhbnNwb3J0RGlzcGF0Y2hlciwgYXJndW1lbnRzKTsKICAgICAgICBpZiAodGhpcy5zZXJ2aWNlKSBldmVudC5hcHBseSh0aGlzLnNlcnZpY2UsIGFyZ3VtZW50cyk7CiAgICAgICAgZXZlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGNyZWF0ZVJlcXVlc3RFdmVudChldmVudE5hbWUpIHsKICAgICAgdmFyIGV2ZW50ID0gY3JlYXRlRXZlbnQoZXZlbnROYW1lKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIHJlcXVlc3RFdmVudCgpIHsKICAgICAgICB2YXIgYXJncyA9IFsgdGhpcyBdLmNvbmNhdChhcnJheUZyb20oYXJndW1lbnRzKSk7CiAgICAgICAgZXZlbnQuYXBwbHkodHJhbnNwb3J0RGlzcGF0Y2hlciwgYXJncyk7CiAgICAgICAgaWYgKHRoaXMudHJhbnNwb3J0KSB0aGlzLnRyYW5zcG9ydFsiZW1pdF8iICsgZXZlbnROYW1lXS5hcHBseSh0aGlzLnRyYW5zcG9ydCwgYXJncyk7CiAgICAgICAgZXZlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAgIHZhciBpbnByb2dyZXNzVHJhbnNwb3J0cyA9IFtdOwogICAgdmFyIHRyYW5zcG9ydERpc3BhdGNoZXIgPSBuZXcgRW1pdHRlcih7CiAgICAgIGFib3J0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gYXJyYXlGcm9tKGlucHJvZ3Jlc3NUcmFuc3BvcnRzKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykgcmVzdWx0W2ldLmFib3J0KCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwKICAgICAgaGFuZGxlcjogewogICAgICAgIHN0YXJ0OiBmdW5jdGlvbihyZXF1ZXN0KSB7CiAgICAgICAgICBiYXNpcy5hcnJheS5hZGQoaW5wcm9ncmVzc1RyYW5zcG9ydHMsIHJlcXVlc3QudHJhbnNwb3J0KTsKICAgICAgICB9LAogICAgICAgIGNvbXBsZXRlOiBmdW5jdGlvbihyZXF1ZXN0KSB7CiAgICAgICAgICBiYXNpcy5hcnJheS5yZW1vdmUoaW5wcm9ncmVzc1RyYW5zcG9ydHMsIHJlcXVlc3QudHJhbnNwb3J0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmFyIEFic3RyYWN0UmVxdWVzdCA9IERhdGFPYmplY3Quc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQWJzdHJhY3RSZXF1ZXN0IiwKICAgICAgaW5mbHVlbmNlOiBudWxsLAogICAgICBpbml0RGF0YTogbnVsbCwKICAgICAgcmVxdWVzdERhdGE6IG51bGwsCiAgICAgIHRyYW5zcG9ydDogbnVsbCwKICAgICAgc3RhdGVPbkFib3J0OiBTVEFURS5VTkRFRklORUQsCiAgICAgIGVtaXRfc3RhcnQ6IGNyZWF0ZVJlcXVlc3RFdmVudCgic3RhcnQiKSwKICAgICAgZW1pdF90aW1lb3V0OiBjcmVhdGVSZXF1ZXN0RXZlbnQoInRpbWVvdXQiKSwKICAgICAgZW1pdF9hYm9ydDogY3JlYXRlUmVxdWVzdEV2ZW50KCJhYm9ydCIpLAogICAgICBlbWl0X3N1Y2Nlc3M6IGNyZWF0ZVJlcXVlc3RFdmVudCgic3VjY2VzcyIpLAogICAgICBlbWl0X2ZhaWx1cmU6IGNyZWF0ZVJlcXVlc3RFdmVudCgiZmFpbHVyZSIpLAogICAgICBlbWl0X2NvbXBsZXRlOiBjcmVhdGVSZXF1ZXN0RXZlbnQoImNvbXBsZXRlIiksCiAgICAgIGVtaXRfc3RhdGVDaGFuZ2VkOiBmdW5jdGlvbihvbGRTdGF0ZSkgewogICAgICAgIERhdGFPYmplY3QucHJvdG90eXBlLmVtaXRfc3RhdGVDaGFuZ2VkLmNhbGwodGhpcywgb2xkU3RhdGUpOwogICAgICAgIGlmICh0aGlzLmluZmx1ZW5jZSkgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmluZmx1ZW5jZS5sZW5ndGg7IGkrKykgdGhpcy5pbmZsdWVuY2VbaV0uc2V0U3RhdGUodGhpcy5zdGF0ZSwgdGhpcy5zdGF0ZS5kYXRhKTsKICAgICAgfSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuaW5mbHVlbmNlID0gW107CiAgICAgIH0sCiAgICAgIHNldEluZmx1ZW5jZTogZnVuY3Rpb24oaW5mbHVlbmNlKSB7CiAgICAgICAgdGhpcy5pbmZsdWVuY2UgPSBhcnJheUZyb20oaW5mbHVlbmNlKTsKICAgICAgfSwKICAgICAgY2xlYXJJbmZsdWVuY2U6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaW5mbHVlbmNlID0gbnVsbDsKICAgICAgfSwKICAgICAgZG9SZXF1ZXN0OiBiYXNpcy5mbi4kdW5kZWYsCiAgICAgIGdldFJlc3BvbnNlRGF0YTogYmFzaXMuZm4uJHVuZGVmLAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5pbml0RGF0YSA9IG51bGw7CiAgICAgICAgdGhpcy5yZXF1ZXN0RGF0YSA9IG51bGw7CiAgICAgICAgdGhpcy5jbGVhckluZmx1ZW5jZSgpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUUkFOU1BPUlRfUkVRVUVTVF9IQU5ETEVSID0gewogICAgICBzdGFydDogZnVuY3Rpb24oc2VuZGVyLCByZXF1ZXN0KSB7CiAgICAgICAgYmFzaXMuYXJyYXkuYWRkKHRoaXMuaW5wcm9ncmVzc1JlcXVlc3RzLCByZXF1ZXN0KTsKICAgICAgfSwKICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKHNlbmRlciwgcmVxdWVzdCkgewogICAgICAgIGJhc2lzLmFycmF5LnJlbW92ZSh0aGlzLmlucHJvZ3Jlc3NSZXF1ZXN0cywgcmVxdWVzdCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgVFJBTlNQT1JUX1BPT0xfTElNSVRfSEFORExFUiA9IHsKICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBuZXh0UmVxdWVzdCA9IHRoaXMucmVxdWVzdFF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgaWYgKG5leHRSZXF1ZXN0KSB7CiAgICAgICAgICBiYXNpcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgbmV4dFJlcXVlc3QuZG9SZXF1ZXN0KCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB2YXIgQWJzdHJhY3RUcmFuc3BvcnQgPSBFbWl0dGVyLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkFic3RyYWN0VHJhbnNwb3J0IiwKICAgICAgcmVxdWVzdENsYXNzOiBBYnN0cmFjdFJlcXVlc3QsCiAgICAgIHJlcXVlc3RzOiBudWxsLAogICAgICBwb29sTGltaXQ6IG51bGwsCiAgICAgIHBvb2xIYXNoR2V0dGVyOiBiYXNpcy5mbi4kdHJ1ZSwKICAgICAgZW1pdF9zdGFydDogY3JlYXRlVHJhbnNwb3J0RXZlbnQoInN0YXJ0IiksCiAgICAgIGVtaXRfdGltZW91dDogY3JlYXRlVHJhbnNwb3J0RXZlbnQoInRpbWVvdXQiKSwKICAgICAgZW1pdF9hYm9ydDogY3JlYXRlVHJhbnNwb3J0RXZlbnQoImFib3J0IiksCiAgICAgIGVtaXRfc3VjY2VzczogY3JlYXRlVHJhbnNwb3J0RXZlbnQoInN1Y2Nlc3MiKSwKICAgICAgZW1pdF9mYWlsdXJlOiBjcmVhdGVUcmFuc3BvcnRFdmVudCgiZmFpbHVyZSIpLAogICAgICBlbWl0X2NvbXBsZXRlOiBjcmVhdGVUcmFuc3BvcnRFdmVudCgiY29tcGxldGUiKSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0cyA9IHt9OwogICAgICAgIHRoaXMucmVxdWVzdFF1ZXVlID0gW107CiAgICAgICAgdGhpcy5pbnByb2dyZXNzUmVxdWVzdHMgPSBbXTsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5hZGRIYW5kbGVyKFRSQU5TUE9SVF9SRVFVRVNUX0hBTkRMRVIsIHRoaXMpOwogICAgICAgIGlmICh0aGlzLnBvb2xMaW1pdCkgdGhpcy5hZGRIYW5kbGVyKFRSQU5TUE9SVF9QT09MX0xJTUlUX0hBTkRMRVIsIHRoaXMpOwogICAgICB9LAogICAgICBnZXRSZXF1ZXN0QnlIYXNoOiBmdW5jdGlvbihyZXF1ZXN0SGFzaElkKSB7CiAgICAgICAgdmFyIHJlcXVlc3QgPSB0aGlzLnJlcXVlc3RzW3JlcXVlc3RIYXNoSWRdOwogICAgICAgIGlmICghcmVxdWVzdCkgewogICAgICAgICAgZm9yICh2YXIgaWQgaW4gdGhpcy5yZXF1ZXN0cykgaWYgKHRoaXMucmVxdWVzdHNbaWRdLmlzSWRsZSgpICYmIHRoaXMucmVxdWVzdFF1ZXVlLmluZGV4T2YodGhpcy5yZXF1ZXN0c1tpZF0pID09IC0xKSB7CiAgICAgICAgICAgIHJlcXVlc3QgPSB0aGlzLnJlcXVlc3RzW2lkXTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMucmVxdWVzdHNbaWRdOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghcmVxdWVzdCkgcmVxdWVzdCA9IG5ldyB0aGlzLnJlcXVlc3RDbGFzcyh7CiAgICAgICAgICAgIHRyYW5zcG9ydDogdGhpcwogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLnJlcXVlc3RzW3JlcXVlc3RIYXNoSWRdID0gcmVxdWVzdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlcXVlc3Q7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IGJhc2lzLmZuLiR0cnVlLAogICAgICBwcmVwYXJlUmVxdWVzdERhdGE6IGJhc2lzLmZuLiRzZWxmLAogICAgICByZXF1ZXN0OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICBpZiAoIXRoaXMucHJlcGFyZSgpKSByZXR1cm47CiAgICAgICAgdmFyIHJlcXVlc3REYXRhID0gb2JqZWN0U2xpY2UoY29uZmlnKTsKICAgICAgICB2YXIgcmVxdWVzdEhhc2hJZCA9IHRoaXMucG9vbEhhc2hHZXR0ZXIodGhpcy5wcmVwYXJlUmVxdWVzdERhdGEocmVxdWVzdERhdGEpKTsKICAgICAgICB2YXIgcmVxdWVzdCA9IHRoaXMuZ2V0UmVxdWVzdEJ5SGFzaChyZXF1ZXN0SGFzaElkLCB0cnVlKTsKICAgICAgICBpZiAocmVxdWVzdC5pbml0RGF0YSkgcmVxdWVzdC5hYm9ydCgpOwogICAgICAgIHJlcXVlc3QuaW5pdERhdGEgPSByZXF1ZXN0RGF0YTsKICAgICAgICByZXF1ZXN0LnJlcXVlc3REYXRhID0gcmVxdWVzdERhdGE7CiAgICAgICAgcmVxdWVzdC5zZXRJbmZsdWVuY2UocmVxdWVzdERhdGEuaW5mbHVlbmNlIHx8IHRoaXMuaW5mbHVlbmNlKTsKICAgICAgICBpZiAodGhpcy5wb29sTGltaXQgJiYgdGhpcy5pbnByb2dyZXNzUmVxdWVzdHMubGVuZ3RoID49IHRoaXMucG9vbExpbWl0KSB7CiAgICAgICAgICB0aGlzLnJlcXVlc3RRdWV1ZS5wdXNoKHJlcXVlc3QpOwogICAgICAgICAgcmVxdWVzdC5zZXRTdGF0ZShTVEFURS5QUk9DRVNTSU5HKTsKICAgICAgICB9IGVsc2UgcmVxdWVzdC5kb1JlcXVlc3QoKTsKICAgICAgICByZXR1cm4gcmVxdWVzdDsKICAgICAgfSwKICAgICAgYWJvcnQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCByZXF1ZXN0OyByZXF1ZXN0ID0gdGhpcy5pbnByb2dyZXNzUmVxdWVzdHNbaV07IGkrKykgcmVxdWVzdC5hYm9ydCgpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCByZXF1ZXN0OyByZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0UXVldWVbaV07IGkrKykgcmVxdWVzdC5zZXRTdGF0ZShTVEFURS5FUlJPUik7CiAgICAgICAgdGhpcy5pbnByb2dyZXNzUmVxdWVzdHMgPSBbXTsKICAgICAgICB0aGlzLnJlcXVlc3RRdWV1ZSA9IFtdOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuc3RvcHBlZCkgewogICAgICAgICAgdGhpcy5zdG9wcGVkUmVxdWVzdHMgPSB0aGlzLmlucHJvZ3Jlc3NSZXF1ZXN0cy5jb25jYXQodGhpcy5yZXF1ZXN0UXVldWUpOwogICAgICAgICAgdGhpcy5hYm9ydCgpOwogICAgICAgICAgdGhpcy5zdG9wcGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlc3VtZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuc3RvcHBlZFJlcXVlc3RzKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgcmVxdWVzdDsgcmVxdWVzdCA9IHRoaXMuc3RvcHBlZFJlcXVlc3RzW2ldOyBpKyspIHJlcXVlc3QudHJhbnNwb3J0LnJlcXVlc3QocmVxdWVzdC5pbml0RGF0YSk7CiAgICAgICAgICB0aGlzLnN0b3BwZWRSZXF1ZXN0cyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RvcHBlZCA9IGZhbHNlOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBpIGluIHRoaXMucmVxdWVzdHMpIHRoaXMucmVxdWVzdHNbaV0uZGVzdHJveSgpOwogICAgICAgIHRoaXMucmVxdWVzdHMgPSB7fTsKICAgICAgICB0aGlzLmlucHJvZ3Jlc3NSZXF1ZXN0cyA9IG51bGw7CiAgICAgICAgdGhpcy5yZXF1ZXN0UXVldWUgPSBudWxsOwogICAgICAgIHRoaXMuc3RvcHBlZFJlcXVlc3RzID0gbnVsbDsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGNyZWF0ZVRyYW5zcG9ydEV2ZW50OiBjcmVhdGVUcmFuc3BvcnRFdmVudCwKICAgICAgY3JlYXRlUmVxdWVzdEV2ZW50OiBjcmVhdGVSZXF1ZXN0RXZlbnQsCiAgICAgIHRyYW5zcG9ydERpc3BhdGNoZXI6IHRyYW5zcG9ydERpc3BhdGNoZXIsCiAgICAgIEFic3RyYWN0UmVxdWVzdDogQWJzdHJhY3RSZXF1ZXN0LAogICAgICBBYnN0cmFjdFRyYW5zcG9ydDogQWJzdHJhY3RUcmFuc3BvcnQKICAgIH07CiAgfSwKICAiay5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2wuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vbi5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBjcmVhdGVFdmVudCA9IGJhc2lzLmV2ZW50LmNyZWF0ZTsKICAgIHZhciBjcmVhdGVBY3Rpb24gPSBiYXNpcy5uZXQuYWN0aW9uLmNyZWF0ZTsKICAgIHZhciBFbWl0dGVyID0gYmFzaXMuZXZlbnQuRW1pdHRlcjsKICAgIHZhciBBamF4VHJhbnNwb3J0ID0gYmFzaXMubmV0LmFqYXguVHJhbnNwb3J0OwogICAgdmFyIFNFUlZJQ0VfSEFORExFUiA9IHsKICAgICAgc3RhcnQ6IGZ1bmN0aW9uKHNlcnZpY2UsIHJlcXVlc3QpIHsKICAgICAgICBiYXNpcy5hcnJheS5hZGQodGhpcy5pbnByb2dyZXNzVHJhbnNwb3J0cywgcmVxdWVzdC50cmFuc3BvcnQpOwogICAgICB9LAogICAgICBjb21wbGV0ZTogZnVuY3Rpb24oc2VydmljZSwgcmVxdWVzdCkgewogICAgICAgIGJhc2lzLmFycmF5LnJlbW92ZSh0aGlzLmlucHJvZ3Jlc3NUcmFuc3BvcnRzLCByZXF1ZXN0LnRyYW5zcG9ydCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgU2VydmljZSA9IEVtaXR0ZXIuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU2VydmljZSIsCiAgICAgIGlucHJvZ3Jlc3NUcmFuc3BvcnRzOiBudWxsLAogICAgICB0cmFuc3BvcnRDbGFzczogQWpheFRyYW5zcG9ydCwKICAgICAgZW1pdF9zZXNzaW9uT3BlbjogY3JlYXRlRXZlbnQoInNlc3Npb25PcGVuIiksCiAgICAgIGVtaXRfc2Vzc2lvbkNsb3NlOiBjcmVhdGVFdmVudCgic2Vzc2lvbkNsb3NlIiksCiAgICAgIGVtaXRfc2Vzc2lvbkZyZWV6ZTogY3JlYXRlRXZlbnQoInNlc3Npb25GcmVlemUiKSwKICAgICAgZW1pdF9zZXNzaW9uVW5mcmVlemU6IGNyZWF0ZUV2ZW50KCJzZXNzaW9uVW5mcmVlemUiKSwKICAgICAgaXNTZWN1cmU6IGZhbHNlLAogICAgICBwcmVwYXJlOiBiYXNpcy5mbi4kdHJ1ZSwKICAgICAgc2lnbmF0dXJlOiBiYXNpcy5mbi4kdW5kZWYsCiAgICAgIGlzU2Vzc2lvbkV4cGlyZWRFcnJvcjogYmFzaXMuZm4uJGZhbHNlLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5yZXF1ZXN0Q2xhc3MpIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuU2VydmljZSNyZXF1ZXN0Q2xhc3MgaXMgbm90IHN1cHBvcnRlZDsgc2V0IHJlcXVlc3RDbGFzcyB2aWEgdHJhbnNwb3J0Q2xhc3MiKTsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5pbnByb2dyZXNzVHJhbnNwb3J0cyA9IFtdOwogICAgICAgIHZhciBUcmFuc3BvcnRDbGFzcyA9IHRoaXMudHJhbnNwb3J0Q2xhc3M7CiAgICAgICAgdGhpcy50cmFuc3BvcnRDbGFzcyA9IFRyYW5zcG9ydENsYXNzLnN1YmNsYXNzKHsKICAgICAgICAgIHNlcnZpY2U6IHRoaXMsCiAgICAgICAgICBuZWVkU2lnbmF0dXJlOiB0aGlzLmlzU2VjdXJlLAogICAgICAgICAgZW1pdF9mYWlsdXJlOiBmdW5jdGlvbihyZXF1ZXN0LCBlcnJvcikgewogICAgICAgICAgICBUcmFuc3BvcnRDbGFzcy5wcm90b3R5cGUuZW1pdF9mYWlsdXJlLmNhbGwodGhpcywgcmVxdWVzdCwgZXJyb3IpOwogICAgICAgICAgICBpZiAodGhpcy5uZWVkU2lnbmF0dXJlICYmIHRoaXMuc2VydmljZS5pc1Nlc3Npb25FeHBpcmVkRXJyb3IocmVxdWVzdCkpIHsKICAgICAgICAgICAgICB0aGlzLnNlcnZpY2UuZnJlZXplKCk7CiAgICAgICAgICAgICAgdGhpcy5zZXJ2aWNlLnN0b3BwZWRUcmFuc3BvcnRzLnB1c2godGhpcyk7CiAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICByZXF1ZXN0OiBmdW5jdGlvbihyZXF1ZXN0RGF0YSkgewogICAgICAgICAgICBpZiAoIXRoaXMuc2VydmljZS5wcmVwYXJlKHRoaXMsIHJlcXVlc3REYXRhKSkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5uZWVkU2lnbmF0dXJlICYmICF0aGlzLnNlcnZpY2Uuc2lnbih0aGlzKSkgcmV0dXJuOwogICAgICAgICAgICByZXR1cm4gVHJhbnNwb3J0Q2xhc3MucHJvdG90eXBlLnJlcXVlc3QuY2FsbCh0aGlzLCByZXF1ZXN0RGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5hZGRIYW5kbGVyKFNFUlZJQ0VfSEFORExFUik7CiAgICAgIH0sCiAgICAgIHNpZ246IGZ1bmN0aW9uKHRyYW5zcG9ydCkgewogICAgICAgIGlmICh0aGlzLnNlc3Npb25LZXkpIHsKICAgICAgICAgIHRoaXMuc2lnbmF0dXJlKHRyYW5zcG9ydCwgdGhpcy5zZXNzaW9uRGF0YSk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlJlcXVlc3QgaWdub3JlZC4gU2VydmljZSBoYXZlIG5vIHNlc3Npb24ga2V5Iik7CiAgICAgICAgfQogICAgICB9LAogICAgICBvcGVuU2Vzc2lvbjogZnVuY3Rpb24oc2Vzc2lvbktleSwgc2Vzc2lvbkRhdGEpIHsKICAgICAgICB0aGlzLnNlc3Npb25LZXkgPSBzZXNzaW9uS2V5OwogICAgICAgIHRoaXMuc2Vzc2lvbkRhdGEgPSBzZXNzaW9uRGF0YTsKICAgICAgICB0aGlzLnVuZnJlZXplKCk7CiAgICAgICAgdGhpcy5lbWl0X3Nlc3Npb25PcGVuKCk7CiAgICAgIH0sCiAgICAgIGNsb3NlU2Vzc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5mcmVlemUoKTsKICAgICAgICB0aGlzLmVtaXRfc2Vzc2lvbkNsb3NlKCk7CiAgICAgIH0sCiAgICAgIGZyZWV6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLnNlc3Npb25LZXkpIHJldHVybjsKICAgICAgICB0aGlzLnNlc3Npb25LZXkgPSBudWxsOwogICAgICAgIHRoaXMuc2Vzc2lvbkRhdGEgPSBudWxsOwogICAgICAgIHRoaXMuc3RvcHBlZFRyYW5zcG9ydHMgPSB0aGlzLmlucHJvZ3Jlc3NUcmFuc3BvcnRzLmZpbHRlcihmdW5jdGlvbih0cmFuc3BvcnQpIHsKICAgICAgICAgIHJldHVybiB0cmFuc3BvcnQubmVlZFNpZ25hdHVyZTsKICAgICAgICB9KTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgdHJhbnNwb3J0OyB0cmFuc3BvcnQgPSB0aGlzLmlucHJvZ3Jlc3NUcmFuc3BvcnRzW2ldOyBpKyspIHRyYW5zcG9ydC5zdG9wKCk7CiAgICAgICAgdGhpcy5lbWl0X3Nlc3Npb25GcmVlemUoKTsKICAgICAgfSwKICAgICAgdW5mcmVlemU6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnN0b3BwZWRUcmFuc3BvcnRzKSBmb3IgKHZhciBpID0gMCwgdHJhbnNwb3J0OyB0cmFuc3BvcnQgPSB0aGlzLnN0b3BwZWRUcmFuc3BvcnRzW2ldOyBpKyspIHRyYW5zcG9ydC5yZXN1bWUoKTsKICAgICAgICB0aGlzLmVtaXRfc2Vzc2lvblVuZnJlZXplKCk7CiAgICAgIH0sCiAgICAgIGNyZWF0ZVRyYW5zcG9ydDogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgcmV0dXJuIG5ldyB0aGlzLnRyYW5zcG9ydENsYXNzKGNvbmZpZyk7CiAgICAgIH0sCiAgICAgIGNyZWF0ZUFjdGlvbjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZUFjdGlvbihiYXNpcy5vYmplY3QuY29tcGxldGUoewogICAgICAgICAgc2VydmljZTogdGhpcwogICAgICAgIH0sIGNvbmZpZykpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmlucHJvZ3Jlc3NUcmFuc3BvcnRzID0gbnVsbDsKICAgICAgICB0aGlzLnN0b3BwZWRUcmFuc3BvcnRzID0gbnVsbDsKICAgICAgICB0aGlzLnNlc3Npb25LZXkgPSBudWxsOwogICAgICAgIHRoaXMuc2Vzc2lvbkRhdGEgPSBudWxsOwogICAgICAgIEVtaXR0ZXIucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgU2VydmljZTogU2VydmljZQogICAgfTsKICB9LAogICJsLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuL20uanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vai5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIHVhID0gYmFzaXMudWE7CiAgICB2YXIgZXNjYXBlVmFsdWUgPSBnbG9iYWwuZW5jb2RlVVJJQ29tcG9uZW50OwogICAgdmFyIEZvcm1EYXRhID0gZ2xvYmFsLkZvcm1EYXRhOwogICAgdmFyIGV4dGVuZCA9IGJhc2lzLm9iamVjdC5leHRlbmQ7CiAgICB2YXIgb2JqZWN0U2xpY2UgPSBiYXNpcy5vYmplY3Quc2xpY2U7CiAgICB2YXIgb2JqZWN0TWVyZ2UgPSBiYXNpcy5vYmplY3QubWVyZ2U7CiAgICB2YXIgY3JlYXRlVHJhbnNwb3J0RXZlbnQgPSBiYXNpcy5uZXQuY3JlYXRlVHJhbnNwb3J0RXZlbnQ7CiAgICB2YXIgY3JlYXRlUmVxdWVzdEV2ZW50ID0gYmFzaXMubmV0LmNyZWF0ZVJlcXVlc3RFdmVudDsKICAgIHZhciBBYnN0cmFjdFJlcXVlc3QgPSBiYXNpcy5uZXQuQWJzdHJhY3RSZXF1ZXN0OwogICAgdmFyIEFic3RyYWN0VHJhbnNwb3J0ID0gYmFzaXMubmV0LkFic3RyYWN0VHJhbnNwb3J0OwogICAgdmFyIFNUQVRFX1VOU0VOVCA9IDA7CiAgICB2YXIgU1RBVEVfT1BFTkVEID0gMTsKICAgIHZhciBTVEFURV9IRUFERVJTX1JFQ0VJVkVEID0gMjsKICAgIHZhciBTVEFURV9MT0FESU5HID0gMzsKICAgIHZhciBTVEFURV9ET05FID0gNDsKICAgIHZhciBTVEFURSA9IGJhc2lzLmRhdGEuU1RBVEU7CiAgICB2YXIgTUVUSE9EUyA9ICJIRUFEIEdFVCBQT1NUIFBVVCBQQVRDSCBERUxFVEUgVFJBQ0UgTElOSyBVTkxJTksgQ09OTkVDVCIuc3BsaXQoIiAiKTsKICAgIHZhciBJU19QT1NUX1JFR0VYUCA9IC9QT1NUL2k7CiAgICB2YXIgSVNfTUVUSE9EX1dJVEhfQk9EWSA9IC9eKFBPU1R8UFVUfFBBVENIfExJTkt8VU5MSU5LKSQvaTsKICAgIHZhciBYSFJTdXBwb3J0ID0gIm5hdGl2ZSI7CiAgICB2YXIgY3JlYXRlWG1sSHR0cFJlcXVlc3QgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCJYTUxIdHRwUmVxdWVzdCIgaW4gZ2xvYmFsKSByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdDsKICAgICAgfTsKICAgICAgdmFyIEFjdGl2ZVhPYmplY3QgPSBnbG9iYWwuQWN0aXZlWE9iamVjdDsKICAgICAgaWYgKEFjdGl2ZVhPYmplY3QpIHsKICAgICAgICB2YXIgcHJvZ0lEID0gWyAiTVNYTUwyLlhNTEhUVFAuNi4wIiwgIk1TWE1MMi5YTUxIVFRQLjMuMCIsICJNU1hNTDIuWE1MSFRUUCIsICJNaWNyb3NvZnQuWE1MSFRUUCIgXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgWEhSU3VwcG9ydCA9IHByb2dJRFtpXTsgaSsrKSB0cnkgewogICAgICAgICAgaWYgKG5ldyBBY3RpdmVYT2JqZWN0KFhIUlN1cHBvcnQpKSByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdChYSFJTdXBwb3J0KTsKICAgICAgICAgIH07CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgfQogICAgICB0aHJvdyBuZXcgRXJyb3IoWEhSU3VwcG9ydCA9ICJYTUxIdHRwUmVxdWVzdCBpcyBub3Qgc3VwcG9ydGVkISIpOwogICAgfSgpOwogICAgZnVuY3Rpb24gc2V0UmVxdWVzdEhlYWRlcnMoeGhyLCByZXF1ZXN0RGF0YSkgewogICAgICB2YXIgaGVhZGVycyA9IHt9OwogICAgICBpZiAoSVNfTUVUSE9EX1dJVEhfQk9EWS50ZXN0KHJlcXVlc3REYXRhLm1ldGhvZCkpIHsKICAgICAgICBpZiAoIUZvcm1EYXRhIHx8IHJlcXVlc3REYXRhLnBvc3RCb2R5IGluc3RhbmNlb2YgRm9ybURhdGEgPT0gZmFsc2UpIGhlYWRlcnNbIkNvbnRlbnQtVHlwZSJdID0gcmVxdWVzdERhdGEuY29udGVudFR5cGUgKyAocmVxdWVzdERhdGEuZW5jb2RpbmcgPyAiO2NoYXJzZXQ9IiArIHJlcXVlc3REYXRhLmVuY29kaW5nIDogIiIpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh1YS50ZXN0KCJpZSIpKSB7CiAgICAgICAgICBoZWFkZXJzWyJJZi1Nb2RpZmllZC1TaW5jZSJdID0gIlRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UIjsKICAgICAgICB9CiAgICAgIH0KICAgICAgYmFzaXMub2JqZWN0Lml0ZXJhdGUoZXh0ZW5kKGhlYWRlcnMsIHJlcXVlc3REYXRhLmhlYWRlcnMpLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwgJiYgdHlwZW9mIHZhbHVlICE9ICJmdW5jdGlvbiIpIHRoaXMuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgfSwgeGhyKTsKICAgIH0KICAgIGZ1bmN0aW9uIHNldFJlc3BvbnNlVHlwZSh4aHIsIHJlcXVlc3REYXRhKSB7CiAgICAgIGlmIChyZXF1ZXN0RGF0YS5yZXNwb25zZVR5cGUgJiYgcmVxdWVzdERhdGEuYXN5bmNocm9ub3VzICYmICJyZXNwb25zZVR5cGUiIGluIHhocikgdHJ5IHsKICAgICAgICB4aHIucmVzcG9uc2VUeXBlID0gcmVxdWVzdERhdGEucmVzcG9uc2VUeXBlOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oIkNhbid0IHNldCByZXNwb3NlVHlwZSBgIiArIHJlcXVlc3REYXRhLnJlc3BvbnNlVHlwZSArICJgIHRvIFhNTEh0dHBSZXF1ZXN0IiwgcmVxdWVzdERhdGEpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBzYWZlSnNvblBhcnNlKGNvbnRlbnQsIHVybCkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBiYXNpcy5qc29uLnBhcnNlKGNvbnRlbnQpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLm5ldC5hamF4OiBDYW4ndCBwYXJzZSBKU09OIGZyb20gIiArIHVybCwgewogICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICBjb250ZW50OiBjb250ZW50CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHJlYWR5U3RhdGVDaGFuZ2VIYW5kbGVyKHJlYWR5U3RhdGUpIHsKICAgICAgdmFyIHhociA9IHRoaXMueGhyOwogICAgICB2YXIgbmV3U3RhdGU7CiAgICAgIHZhciBuZXdTdGF0ZURhdGE7CiAgICAgIHZhciBhYm9ydGVkOwogICAgICB0aGlzLnNlbmREZWxheVRpbWVyXyA9IGNsZWFyVGltZW91dCh0aGlzLnNlbmREZWxheVRpbWVyXyk7CiAgICAgIGlmICgheGhyKSByZXR1cm47CiAgICAgIGlmICh0eXBlb2YgcmVhZHlTdGF0ZSAhPSAibnVtYmVyIikgcmVhZHlTdGF0ZSA9IHhoci5yZWFkeVN0YXRlOwogICAgICBpZiAocmVhZHlTdGF0ZSA9PSB0aGlzLnByZXZSZWFkeVN0YXRlXykgcmV0dXJuOwogICAgICB0aGlzLnByZXZSZWFkeVN0YXRlXyA9IHJlYWR5U3RhdGU7CiAgICAgIGlmICh0aGlzLmRlYnVnKSBiYXNpcy5kZXYubG9nKCJTdGF0ZTogKCIgKyByZWFkeVN0YXRlICsgIikgIiArIFsgIlVOU0VOVCIsICJPUEVORUQiLCAiSEVBREVSU19SRUNFSVZFRCIsICJMT0FESU5HIiwgIkRPTkUiIF1bcmVhZHlTdGF0ZV0pOwogICAgICB0aGlzLmVtaXRfcmVhZHlTdGF0ZUNoYW5nZWQocmVhZHlTdGF0ZSk7CiAgICAgIGlmIChyZWFkeVN0YXRlID09IFNUQVRFX0RPTkUpIHsKICAgICAgICB0aGlzLmNsZWFyVGltZW91dCgpOwogICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBiYXNpcy5mbi4kdW5kZWY7CiAgICAgICAgYWJvcnRlZCA9IHhoci5zdGF0dXMgPT0gMDsKICAgICAgICBpZiAoIWFib3J0ZWQgJiYgIXhoci5yZXNwb25zZVR5cGUpIGFib3J0ZWQgPSB0eXBlb2YgeGhyLnJlc3BvbnNlVGV4dCA9PSAidW5rbm93biIgfHwgIXhoci5yZXNwb25zZVRleHQgJiYgIXhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKTsKICAgICAgICBpZiAoYWJvcnRlZCkgewogICAgICAgICAgdGhpcy5lbWl0X2Fib3J0KCk7CiAgICAgICAgICBuZXdTdGF0ZSA9IHRoaXMuc3RhdGVPbkFib3J0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnByb2Nlc3NSZXNwb25zZSgpOwogICAgICAgICAgaWYgKHRoaXMuaXNTdWNjZXNzZnVsKCkpIHsKICAgICAgICAgICAgbmV3U3RhdGUgPSBTVEFURS5SRUFEWTsKICAgICAgICAgICAgdGhpcy5lbWl0X3N1Y2Nlc3ModGhpcy5nZXRSZXNwb25zZURhdGEoKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdTdGF0ZSA9IFNUQVRFLkVSUk9SOwogICAgICAgICAgICBuZXdTdGF0ZURhdGEgPSB0aGlzLmdldFJlc3BvbnNlRXJyb3IoKTsKICAgICAgICAgICAgaWYgKCFuZXdTdGF0ZURhdGEgJiYgdGhpcy5kYXRhLmVycm9yKSB7CiAgICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlJlcXVlc3QjZ2V0UmVzcG9uc2VFcnJvciBzaG91bGQgbm90IHVwZGF0ZSByZXF1ZXN0IGRhdGEsIGJ1dCByZXR1cm5zIGVycm9yIGRhdGEuIFBsZWFzZSwgZml4IHlvdXIgbWV0aG9kIGltcGxlbWVudGF0aW9uLCBhcyBkYXRhIHVwZGF0aW5nIGlzIGRlcHJlY2F0ZWQgYmVoYXZpb3VyLiIpOwogICAgICAgICAgICAgIG5ld1N0YXRlRGF0YSA9IHRoaXMuZGF0YS5lcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVtaXRfZmFpbHVyZShuZXdTdGF0ZURhdGEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmVtaXRfY29tcGxldGUodGhpcyk7CiAgICAgIH0gZWxzZSBuZXdTdGF0ZSA9IFNUQVRFLlBST0NFU1NJTkc7CiAgICAgIHRoaXMuc2V0U3RhdGUobmV3U3RhdGUsIG5ld1N0YXRlRGF0YSk7CiAgICB9CiAgICB2YXIgUmVxdWVzdCA9IEFic3RyYWN0UmVxdWVzdC5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5SZXF1ZXN0IiwKICAgICAgcmVxdWVzdFN0YXJ0VGltZTogMCwKICAgICAgdGltZW91dDogM2U0LAogICAgICB0aW1lcl86IG51bGwsCiAgICAgIHNlbmREZWxheTogbnVsbCwKICAgICAgc2VuZERlbGF5VGltZXJfOiBudWxsLAogICAgICBsYXN0UmVxdWVzdFVybF86IG51bGwsCiAgICAgIGRlYnVnOiBmYWxzZSwKICAgICAgZW1pdF9yZWFkeVN0YXRlQ2hhbmdlZDogY3JlYXRlUmVxdWVzdEV2ZW50KCJyZWFkeVN0YXRlQ2hhbmdlZCIpLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdFJlcXVlc3QucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLnhociA9IGNyZWF0ZVhtbEh0dHBSZXF1ZXN0KCk7CiAgICAgIH0sCiAgICAgIGlzSWRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueGhyLnJlYWR5U3RhdGUgPT0gU1RBVEVfRE9ORSB8fCB0aGlzLnhoci5yZWFkeVN0YXRlID09IFNUQVRFX1VOU0VOVDsKICAgICAgfSwKICAgICAgaXNTdWNjZXNzZnVsOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc3RhdHVzID0gdGhpcy54aHIuc3RhdHVzOwogICAgICAgIHJldHVybiBzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCB8fCBzdGF0dXMgPT0gMzA0OwogICAgICB9LAogICAgICBwcm9jZXNzUmVzcG9uc2U6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudXBkYXRlKHsKICAgICAgICAgIGNvbnRlbnRUeXBlOiB0aGlzLnhoci5nZXRSZXNwb25zZUhlYWRlcigiY29udGVudC10eXBlIiksCiAgICAgICAgICBzdGF0dXM6IHRoaXMueGhyLnN0YXR1cwogICAgICAgIH0pOwogICAgICB9LAogICAgICBnZXRSZXNwb25zZURhdGE6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4aHIgPSB0aGlzLnhocjsKICAgICAgICBpZiAoIXhoci5yZXNwb25zZVR5cGUpIGlmICh0aGlzLnJlc3BvbnNlVHlwZSA9PSAianNvbiIgfHwgL15hcHBsaWNhdGlvblwvanNvbi9pLnRlc3QodGhpcy5kYXRhLmNvbnRlbnRUeXBlKSkgcmV0dXJuIHNhZmVKc29uUGFyc2UoeGhyLnJlc3BvbnNlVGV4dCwgdGhpcy5sYXN0UmVxdWVzdFVybF8pOwogICAgICAgIGlmICgicmVzcG9uc2UiIGluIHhocikgcmV0dXJuIHhoci5yZXNwb25zZTsKICAgICAgICByZXR1cm4geGhyLnJlc3BvbnNlVGV4dDsKICAgICAgfSwKICAgICAgcHJvY2Vzc0Vycm9yUmVzcG9uc2U6IGZ1bmN0aW9uKCkgewogICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuUmVxdWVzdCNwcm9jZXNzRXJyb3JSZXNwb25zZSBpcyBkZXByZWNhdGVkIG5vdywgdXNlIFJlcXVlc3QjZ2V0UmVzcG9uc2VFcnJvciBpbnN0ZWFkIik7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UmVzcG9uc2VFcnJvcigpOwogICAgICB9LAogICAgICBnZXRSZXNwb25zZUVycm9yOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgY29kZTogIlNFUlZFUl9FUlJPUiIsCiAgICAgICAgICBtc2c6ICF0aGlzLnJlc3BvbnNlVHlwZSA/IHRoaXMueGhyLnJlc3BvbnNlVGV4dCA6IHRoaXMueGhyLnJlc3BvbnNlIHx8IHRoaXMueGhyLnN0YXR1c1RleHQgfHwgIkVycm9yIgogICAgICAgIH07CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IGJhc2lzLmZuLiR0cnVlLAogICAgICBwcmVwYXJlUmVxdWVzdERhdGE6IGZ1bmN0aW9uKHJlcXVlc3REYXRhKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IFtdOwogICAgICAgIHZhciB1cmwgPSByZXF1ZXN0RGF0YS51cmw7CiAgICAgICAgcmVxdWVzdERhdGEgPSBvYmplY3RTbGljZShyZXF1ZXN0RGF0YSk7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHJlcXVlc3REYXRhLnBhcmFtcykgewogICAgICAgICAgdmFyIHZhbHVlID0gcmVxdWVzdERhdGEucGFyYW1zW2tleV07CiAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCB8fCB2YWx1ZS50b1N0cmluZygpID09IG51bGwpIGNvbnRpbnVlOwogICAgICAgICAgcGFyYW1zLnB1c2goZXNjYXBlVmFsdWUoa2V5KSArICI9IiArIGVzY2FwZVZhbHVlKHZhbHVlLnRvU3RyaW5nKCkpKTsKICAgICAgICB9CiAgICAgICAgcGFyYW1zID0gcGFyYW1zLmpvaW4oIiYiKTsKICAgICAgICBpZiAoIXJlcXVlc3REYXRhLnBvc3RCb2R5ICYmIElTX01FVEhPRF9XSVRIX0JPRFkudGVzdChyZXF1ZXN0RGF0YS5tZXRob2QpKSB7CiAgICAgICAgICByZXF1ZXN0RGF0YS5wb3N0Qm9keSA9IHBhcmFtcyB8fCAiIjsKICAgICAgICAgIHBhcmFtcyA9ICIiOwogICAgICAgIH0KICAgICAgICBpZiAocmVxdWVzdERhdGEucm91dGVyUGFyYW1zKSB1cmwgPSB1cmwucmVwbGFjZSgvOihbYS16XF9cLV1bYS16MC05XF9cLV0rKS9naSwgZnVuY3Rpb24obSwga2V5KSB7CiAgICAgICAgICBpZiAoa2V5IGluIHJlcXVlc3REYXRhLnJvdXRlclBhcmFtcykgcmV0dXJuIHJlcXVlc3REYXRhLnJvdXRlclBhcmFtc1trZXldOyBlbHNlIHJldHVybiBtOwogICAgICAgIH0pOwogICAgICAgIGlmIChwYXJhbXMpIHVybCArPSAodXJsLmluZGV4T2YoIj8iKSA9PSAtMSA/ICI/IiA6ICImIikgKyBwYXJhbXM7CiAgICAgICAgcmVxdWVzdERhdGEucmVxdWVzdFVybCA9IHVybDsKICAgICAgICByZXR1cm4gcmVxdWVzdERhdGE7CiAgICAgIH0sCiAgICAgIGRvUmVxdWVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZW5kKHRoaXMucHJlcGFyZVJlcXVlc3REYXRhKHRoaXMucmVxdWVzdERhdGEpKTsKICAgICAgfSwKICAgICAgc2VuZDogZnVuY3Rpb24ocmVxdWVzdERhdGEpIHsKICAgICAgICB0aGlzLnVwZGF0ZSh7CiAgICAgICAgICBjb250ZW50VHlwZTogIiIsCiAgICAgICAgICBzdGF0dXM6ICIiCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHVhLnRlc3QoImdlY2tvMS44LjEtIikgJiYgcmVxdWVzdERhdGEuYXN5bmNocm9ub3VzKSB0aGlzLnhociA9IGNyZWF0ZVhtbEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgdGhpcy5lbWl0X3N0YXJ0KCk7CiAgICAgICAgdmFyIHhociA9IHRoaXMueGhyOwogICAgICAgIHRoaXMucHJldlJlYWR5U3RhdGVfID0gLTE7CiAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHJlYWR5U3RhdGVDaGFuZ2VIYW5kbGVyLmJpbmQodGhpcyk7CiAgICAgICAgaWYgKCFyZXF1ZXN0RGF0YS5hc3luY2hyb25vdXMpIHJlYWR5U3RhdGVDaGFuZ2VIYW5kbGVyLmNhbGwodGhpcywgU1RBVEVfVU5TRU5UKTsKICAgICAgICB4aHIub3BlbihyZXF1ZXN0RGF0YS5tZXRob2QsIHJlcXVlc3REYXRhLnJlcXVlc3RVcmwsIHJlcXVlc3REYXRhLmFzeW5jaHJvbm91cyk7CiAgICAgICAgdGhpcy5sYXN0UmVxdWVzdFVybF8gPSByZXF1ZXN0RGF0YS5yZXF1ZXN0VXJsOwogICAgICAgIHNldFJlc3BvbnNlVHlwZSh4aHIsIHJlcXVlc3REYXRhKTsKICAgICAgICB0aGlzLnJlc3BvbnNlVHlwZSA9IHJlcXVlc3REYXRhLnJlc3BvbnNlVHlwZSB8fCAiIjsKICAgICAgICBzZXRSZXF1ZXN0SGVhZGVycyh4aHIsIHJlcXVlc3REYXRhKTsKICAgICAgICB0aGlzLnNldFRpbWVvdXQodGhpcy50aW1lb3V0KTsKICAgICAgICB2YXIgcG9zdEJvZHkgPSByZXF1ZXN0RGF0YS5wb3N0Qm9keTsKICAgICAgICBpZiAoSVNfTUVUSE9EX1dJVEhfQk9EWS50ZXN0KHJlcXVlc3REYXRhLm1ldGhvZCkgJiYgdWEudGVzdCgiaWU5LSIpKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHBvc3RCb2R5ID09ICJvYmplY3QiICYmIHR5cGVvZiBwb3N0Qm9keS5kb2N1bWVudEVsZW1lbnQgIT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHBvc3RCb2R5LnhtbCA9PSAic3RyaW5nIikgcG9zdEJvZHkgPSBwb3N0Qm9keS54bWw7IGVsc2UgaWYgKHR5cGVvZiBwb3N0Qm9keSA9PSAic3RyaW5nIikgcG9zdEJvZHkgPSBwb3N0Qm9keS5yZXBsYWNlKC9cci9nLCAiIik7IGVsc2UgaWYgKHBvc3RCb2R5ID09IG51bGwgfHwgcG9zdEJvZHkgPT0gIiIpIHBvc3RCb2R5ID0gIltObyBkYXRhXSI7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnNlbmREZWxheSkgewogICAgICAgICAgaWYgKHRoaXMuc2VuZERlbGF5VGltZXJfKSB0aGlzLnNlbmREZWxheVRpbWVyXyA9IGNsZWFyVGltZW91dCh0aGlzLnNlbmREZWxheVRpbWVyXyk7CiAgICAgICAgICB0aGlzLnNlbmREZWxheVRpbWVyXyA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuc2VuZERlbGF5VGltZXJfID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRoaXMueGhyID09PSB4aHIgJiYgeGhyLnJlYWR5U3RhdGUgPT0gU1RBVEVfT1BFTkVEKSB4aHIuc2VuZChwb3N0Qm9keSk7CiAgICAgICAgICB9LmJpbmQodGhpcyksIHRoaXMuc2VuZERlbGF5KTsKICAgICAgICB9IGVsc2UgeGhyLnNlbmQocG9zdEJvZHkpOwogICAgICAgIGlmICh0aGlzLmRlYnVnKSBiYXNpcy5kZXYubG9nKCJSZXF1ZXN0IG92ZXIsIHdhaXRpbmcgZm9yIHJlc3BvbnNlIik7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0sCiAgICAgIHJlcGVhdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMucmVxdWVzdERhdGEpIHsKICAgICAgICAgIHRoaXMuYWJvcnQoKTsKICAgICAgICAgIHRoaXMuZG9SZXF1ZXN0KCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBhYm9ydDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLmlzSWRsZSgpKSB7CiAgICAgICAgICB0aGlzLmNsZWFyVGltZW91dCgpOwogICAgICAgICAgdGhpcy54aHIuYWJvcnQoKTsKICAgICAgICAgIGlmICh0aGlzLnhoci5yZWFkeVN0YXRlICE9IFNUQVRFX0RPTkUgJiYgdGhpcy54aHIucmVhZHlTdGF0ZSAhPSBTVEFURV9VTlNFTlQpIHJlYWR5U3RhdGVDaGFuZ2VIYW5kbGVyLmNhbGwodGhpcywgU1RBVEVfRE9ORSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRUaW1lb3V0OiBmdW5jdGlvbih0aW1lb3V0KSB7CiAgICAgICAgaWYgKCF0aGlzLnhoci5hc3luY2hyb25vdXMpIHJldHVybjsKICAgICAgICBpZiAoIm9udGltZW91dCIgaW4gdGhpcy54aHIpIHsKICAgICAgICAgIHRoaXMueGhyLnRpbWVvdXQgPSB0aW1lb3V0OwogICAgICAgICAgdGhpcy54aHIub250aW1lb3V0ID0gdGhpcy50aW1lb3V0QWJvcnQuYmluZCh0aGlzKTsKICAgICAgICB9IGVsc2UgdGhpcy50aW1lcl8gPSBzZXRUaW1lb3V0KHRoaXMudGltZW91dEFib3J0LmJpbmQodGhpcyksIHRpbWVvdXQpOwogICAgICB9LAogICAgICBjbGVhclRpbWVvdXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnRpbWVyXykgdGhpcy50aW1lcl8gPSBjbGVhclRpbWVvdXQodGhpcy50aW1lcl8pOwogICAgICB9LAogICAgICB0aW1lb3V0QWJvcnQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudXBkYXRlKHsKICAgICAgICAgIGVycm9yOiB7CiAgICAgICAgICAgIGNvZGU6ICJUSU1FT1VUX0VSUk9SIiwKICAgICAgICAgICAgbWVzc2FnZTogIlRpbWVvdXQgZXJyb3IiCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5lbWl0X3RpbWVvdXQodGhpcyk7CiAgICAgICAgdGhpcy5hYm9ydCgpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmFib3J0KCk7CiAgICAgICAgdGhpcy54aHIgPSBudWxsOwogICAgICAgIEFic3RyYWN0UmVxdWVzdC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUcmFuc3BvcnQgPSBBYnN0cmFjdFRyYW5zcG9ydC5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UcmFuc3BvcnQiLAogICAgICByZXF1ZXN0Q2xhc3M6IFJlcXVlc3QsCiAgICAgIGVtaXRfcmVhZHlTdGF0ZUNoYW5nZWQ6IGNyZWF0ZVRyYW5zcG9ydEV2ZW50KCJyZWFkeVN0YXRlQ2hhbmdlZCIpLAogICAgICBhc3luY2hyb25vdXM6IHRydWUsCiAgICAgIG1ldGhvZDogIkdFVCIsCiAgICAgIGNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIiwKICAgICAgZW5jb2Rpbmc6IG51bGwsCiAgICAgIHJlcXVlc3RIZWFkZXJzOiBiYXNpcy5DbGFzcy5leHRlbnNpYmxlUHJvcGVydHkoKSwKICAgICAgcmVzcG9uc2VUeXBlOiAiIiwKICAgICAgcGFyYW1zOiBudWxsLAogICAgICByb3V0ZXJQYXJhbXM6IG51bGwsCiAgICAgIHVybDogIiIsCiAgICAgIHBvc3RCb2R5OiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdFRyYW5zcG9ydC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMucGFyYW1zID0gb2JqZWN0U2xpY2UodGhpcy5wYXJhbXMpOwogICAgICAgIHRoaXMucm91dGVyUGFyYW1zID0gb2JqZWN0U2xpY2UodGhpcy5yb3V0ZXJQYXJhbXMpOwogICAgICB9LAogICAgICBzZXRQYXJhbTogZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgICB0aGlzLnBhcmFtc1tuYW1lXSA9IHZhbHVlOwogICAgICB9LAogICAgICBzZXRQYXJhbXM6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgIHRoaXMuY2xlYXJQYXJhbXMoKTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gcGFyYW1zKSB0aGlzLnNldFBhcmFtKGtleSwgcGFyYW1zW2tleV0pOwogICAgICB9LAogICAgICByZW1vdmVQYXJhbTogZnVuY3Rpb24obmFtZSkgewogICAgICAgIGRlbGV0ZSB0aGlzLnBhcmFtc1tuYW1lXTsKICAgICAgfSwKICAgICAgY2xlYXJQYXJhbXM6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnBhcmFtcykgZGVsZXRlIHRoaXMucGFyYW1zW2tleV07CiAgICAgIH0sCiAgICAgIHByZXBhcmVSZXF1ZXN0RGF0YTogZnVuY3Rpb24ocmVxdWVzdERhdGEpIHsKICAgICAgICBpZiAoIXJlcXVlc3REYXRhLnVybCAmJiAhdGhpcy51cmwpIHRocm93IG5ldyBFcnJvcigiVVJMIGlzIG5vdCBkZWZpbmVkIik7CiAgICAgICAgZXh0ZW5kKHJlcXVlc3REYXRhLCB7CiAgICAgICAgICBoZWFkZXJzOiBvYmplY3RNZXJnZSh0aGlzLnJlcXVlc3RIZWFkZXJzLCByZXF1ZXN0RGF0YS5oZWFkZXJzKSwKICAgICAgICAgIHBhcmFtczogb2JqZWN0TWVyZ2UodGhpcy5wYXJhbXMsIHJlcXVlc3REYXRhLnBhcmFtcyksCiAgICAgICAgICByb3V0ZXJQYXJhbXM6IG9iamVjdE1lcmdlKHRoaXMucm91dGVyUGFyYW1zLCByZXF1ZXN0RGF0YS5yb3V0ZXJQYXJhbXMpCiAgICAgICAgfSk7CiAgICAgICAgYmFzaXMub2JqZWN0LmNvbXBsZXRlKHJlcXVlc3REYXRhLCB7CiAgICAgICAgICBhc3luY2hyb25vdXM6IHRoaXMuYXN5bmNocm9ub3VzLAogICAgICAgICAgdXJsOiB0aGlzLnVybCwKICAgICAgICAgIG1ldGhvZDogdGhpcy5tZXRob2QsCiAgICAgICAgICBjb250ZW50VHlwZTogdGhpcy5jb250ZW50VHlwZSwKICAgICAgICAgIGVuY29kaW5nOiB0aGlzLmVuY29kaW5nLAogICAgICAgICAgcG9zdEJvZHk6IHRoaXMucG9zdEJvZHksCiAgICAgICAgICByZXNwb25zZVR5cGU6IHRoaXMucmVzcG9uc2VUeXBlCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlcXVlc3REYXRhOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBSZXF1ZXN0OiBSZXF1ZXN0LAogICAgICBUcmFuc3BvcnQ6IFRyYW5zcG9ydCwKICAgICAgcmVxdWVzdDogZnVuY3Rpb24oY29uZmlnLCBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaykgewogICAgICAgIGlmICh0eXBlb2YgY29uZmlnID09ICJzdHJpbmciKSBjb25maWcgPSB7CiAgICAgICAgICB1cmw6IGNvbmZpZywKICAgICAgICAgIGFzeW5jaHJvbm91czogISEoc3VjY2Vzc0NhbGxiYWNrIHx8IGZhaWx1cmVDYWxsYmFjaykKICAgICAgICB9OwogICAgICAgIHZhciB0cmFuc3BvcnQgPSBuZXcgVHJhbnNwb3J0KGNvbmZpZyk7CiAgICAgICAgdHJhbnNwb3J0LmFkZEhhbmRsZXIoewogICAgICAgICAgc3VjY2Vzczogc3VjY2Vzc0NhbGxiYWNrICYmIGZ1bmN0aW9uKHNlbmRlciwgcmVxLCBkYXRhKSB7CiAgICAgICAgICAgIHN1Y2Nlc3NDYWxsYmFjayhkYXRhKTsKICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmYWlsdXJlQ2FsbGJhY2sgJiYgZnVuY3Rpb24oc2VuZGVyLCByZXEsIGVycm9yKSB7CiAgICAgICAgICAgIGZhaWx1cmVDYWxsYmFjayhlcnJvcik7CiAgICAgICAgICB9LAogICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBiYXNpcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0cmFuc3BvcnQuZGVzdHJveSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgcmVxID0gdHJhbnNwb3J0LnJlcXVlc3QoKTsKICAgICAgICBpZiAoIXJlcS5yZXF1ZXN0RGF0YS5hc3luY2hyb25vdXMpIHJldHVybiByZXEuZ2V0UmVzcG9uc2VEYXRhKCk7CiAgICAgIH0KICAgIH07CiAgfSwKICAibS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBkb2N1bWVudCA9IGdsb2JhbC5kb2N1bWVudDsKICAgIHZhciB1c2VyQWdlbnQgPSBnbG9iYWwubmF2aWdhdG9yICYmIGdsb2JhbC5uYXZpZ2F0b3IudXNlckFnZW50IHx8ICIiOwogICAgdmFyIG9wZXJhID0gZ2xvYmFsLm9wZXJhOwogICAgdmFyIHZlcnNpb25zID0ge307CiAgICB2YXIgYW5zd2VycyA9IHt9OwogICAgdmFyIGJyb3dzZXJOYW1lID0gInVua25vd24iOwogICAgdmFyIGJyb3dzZXJQcmV0dHlOYW1lID0gInVua25vd24iOwogICAgdmFyIGJyb3dzZXJOYW1lcyA9IHsKICAgICAgTVNJRTogWyAiSW50ZXJuZXQgRXhwbG9yZXIiLCAibXNpZSIsICJpZSIgXSwKICAgICAgR2Vja286IFsgIkdlY2tvIiwgImdlY2tvIiBdLAogICAgICBTYWZhcmk6IFsgIlNhZmFyaSIsICJzYWZhcmkiIF0sCiAgICAgICJpUGhvbmUgT1MiOiBbICJpUGhvbmUiLCAiaXBob25lIiBdLAogICAgICBBZG9iZUFpcjogWyAiQWRvYmVBaXIiLCAiYWlyIiBdLAogICAgICBBcHBsZVdlYktpdDogWyAiV2ViS2l0IiBdLAogICAgICBDaHJvbWU6IFsgIkNocm9tZSIsICJjaHJvbWUiIF0sCiAgICAgIEZpcmVGb3g6IFsgIkZpcmVGb3giLCAiZmlyZWZveCIsICJmZiIgXSwKICAgICAgSWNld2Vhc2VsOiBbICJGaXJlRm94IiwgImZpcmVmb3giLCAiZmYiIF0sCiAgICAgIFNoaXJldG9rbzogWyAiRmlyZUZveCIsICJmaXJlZm94IiwgImZmIiBdLAogICAgICBPcGVyYTogWyAiT3BlcmEiLCAib3BlcmEiIF0KICAgIH07CiAgICBmb3IgKHZhciBuYW1lIGluIGJyb3dzZXJOYW1lcykgewogICAgICBpZiAobmFtZSA9PSAiTVNJRSIgJiYgb3BlcmEpIGNvbnRpbnVlOwogICAgICBpZiAobmFtZSA9PSAiU2FmYXJpIiAmJiAvY2hyb21lL2kudGVzdCh1c2VyQWdlbnQpKSBjb250aW51ZTsKICAgICAgaWYgKG5hbWUgPT0gIkFwcGxlV2ViS2l0IiAmJiAvaXBob25lL2kudGVzdCh1c2VyQWdlbnQpKSBjb250aW51ZTsKICAgICAgaWYgKHVzZXJBZ2VudC5tYXRjaChuZXcgUmVnRXhwKG5hbWUgKyAiLiIgKyAiKFxcZCsoXFwuXFxkKykqKSIsICJpIikpKSB7CiAgICAgICAgdmFyIG5hbWVzID0gYnJvd3Nlck5hbWVzW25hbWVdOwogICAgICAgIHZhciB2ZXJzaW9uID0gb3BlcmEgJiYgdHlwZW9mIG9wZXJhLnZlcnNpb24gPT0gImZ1bmN0aW9uIiA/IG9wZXJhLnZlcnNpb24oKSA6IFJlZ0V4cC4kMTsKICAgICAgICB2YXIgdmVyTnVtYmVyID0gdmVyc2lvblRvSW50KHZlcnNpb24pOwogICAgICAgIGJyb3dzZXJOYW1lID0gbmFtZXNbMF0gKyB2ZXJOdW1iZXI7CiAgICAgICAgYnJvd3NlclByZXR0eU5hbWUgPSBuYW1lc1swXSArICIgIiArIHZlcnNpb247CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBuYW1lcy5sZW5ndGg7IGorKykgdmVyc2lvbnNbbmFtZXNbal0udG9Mb3dlckNhc2UoKV0gPSB2ZXJOdW1iZXI7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHZlcnNpb25Ub0ludCh2ZXJzaW9uKSB7CiAgICAgIHZhciBiYXNlID0gMWU2OwogICAgICB2YXIgcGFydCA9IFN0cmluZyh2ZXJzaW9uKS5zcGxpdCgiLiIpOwogICAgICBmb3IgKHZhciBpID0gMCwgcmVzdWx0ID0gMDsgaSA8IDQgJiYgaSA8IHBhcnQubGVuZ3RoOyBpKyssIGJhc2UgLz0gMTAwKSByZXN1bHQgKz0gcGFydFtpXSAqIGJhc2U7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBmdW5jdGlvbiB0ZXN0QnJvd3Nlcihicm93c2VyTmFtZSkgewogICAgICB2YXIgZm9yVGVzdCA9IGJyb3dzZXJOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmIChmb3JUZXN0IGluIGFuc3dlcnMpIHJldHVybiBhbnN3ZXJzW2ZvclRlc3RdOwogICAgICB2YXIgbSA9IGZvclRlc3QubWF0Y2goL14oW2Etel0rKSgoW1xkXC5dKykoWystPV0/KSk/JC9pKTsKICAgICAgaWYgKG0pIHsKICAgICAgICBhbnN3ZXJzW2ZvclRlc3RdID0gZmFsc2U7CiAgICAgICAgdmFyIG5hbWUgPSBtWzFdLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgdmFyIHZlcnNpb24gPSB2ZXJzaW9uVG9JbnQobVszXSk7CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IG1bNF0gfHwgIj0iOwogICAgICAgIHZhciBjbXBWZXJzaW9uID0gdmVyc2lvbnNbbmFtZV07CiAgICAgICAgaWYgKGNtcFZlcnNpb24pIHJldHVybiBhbnN3ZXJzW2ZvclRlc3RdID0gIXZlcnNpb24gfHwgb3BlcmF0aW9uID09ICI9IiAmJiBjbXBWZXJzaW9uID09IHZlcnNpb24gfHwgb3BlcmF0aW9uID09ICIrIiAmJiBjbXBWZXJzaW9uID49IHZlcnNpb24gfHwgb3BlcmF0aW9uID09ICItIiAmJiBjbXBWZXJzaW9uIDwgdmVyc2lvbjsKICAgICAgfSBlbHNlIHsKICAgICAgICBiYXNpcy5kZXYud2FybigiQmFkIGJyb3dzZXIgdmVyc2lvbiBkZXNjcmlwdGlvbiBpbiBCcm93c2VyLnRlc3QoKSBmdW5jdGlvbjogIiArIGZvclRlc3QpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHZhciBjb29raWVzID0gewogICAgICBzZXQ6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCBleHBpcmUsIHBhdGgsIGRvbWFpbikgewogICAgICAgIGRvY3VtZW50LmNvb2tpZSA9IG5hbWUgKyAiPSIgKyAodmFsdWUgPT0gbnVsbCA/ICIiIDogZXNjYXBlKHZhbHVlKSkgKyAiO3BhdGg9IiArIChwYXRoIHx8IChsb2NhdGlvbi5wYXRobmFtZS5pbmRleE9mKCIvIikgPT0gMCA/ICIiIDogIi8iKSArIGxvY2F0aW9uLnBhdGhuYW1lKSArIChleHBpcmUgPyAiO2V4cGlyZXM9IiArIChuZXcgRGF0ZShEYXRlLm5vdygpICsgZXhwaXJlICogMWUzKSkudG9HTVRTdHJpbmcoKSA6ICIiKSArIChkb21haW4gPyAiO2RvbWFpbj0iICsgZG9tYWluIDogIiIpOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICB2YXIgbSA9IGRvY3VtZW50LmNvb2tpZS5tYXRjaChuZXcgUmVnRXhwKCIoXnw7KVxccyoiICsgbmFtZSArICJcXHMqPVxccyooLio/KVxccyooO3wkKSIpKTsKICAgICAgICByZXR1cm4gbSAmJiB1bmVzY2FwZShtWzJdKTsKICAgICAgfSwKICAgICAgcmVtb3ZlOiBmdW5jdGlvbihuYW1lLCBwYXRoLCBkb21haW4pIHsKICAgICAgICBkb2N1bWVudC5jb29raWUgPSBuYW1lICsgIj07ZXhwaXJlcz0iICsgKG5ldyBEYXRlKDApKS50b0dNVFN0cmluZygpICsgIjtwYXRoPSIgKyAocGF0aCB8fCAobG9jYXRpb24ucGF0aG5hbWUuaW5kZXhPZigiLyIpID09IDAgPyAiIiA6ICIvIikgKyBsb2NhdGlvbi5wYXRobmFtZSkgKyAoZG9tYWluID8gIjtkb21haW49IiArIGRvbWFpbiA6ICIiKTsKICAgICAgfQogICAgfTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBwcmV0dHlOYW1lOiBicm93c2VyUHJldHR5TmFtZSwKICAgICAgaXM6IHRlc3RCcm93c2VyLAogICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYmFzaXMuYXJyYXkoYXJndW1lbnRzKS5zb21lKHRlc3RCcm93c2VyKTsKICAgICAgfSwKICAgICAgY29va2llczogY29va2llcwogICAgfTsKICB9LAogICJuLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vbC5qcyIpOwogICAgdmFyIFNUQVRFX1VOREVGSU5FRCA9IGJhc2lzLmRhdGEuU1RBVEUuVU5ERUZJTkVEOwogICAgdmFyIFNUQVRFX1JFQURZID0gYmFzaXMuZGF0YS5TVEFURS5SRUFEWTsKICAgIHZhciBTVEFURV9QUk9DRVNTSU5HID0gYmFzaXMuZGF0YS5TVEFURS5QUk9DRVNTSU5HOwogICAgdmFyIFNUQVRFX0VSUk9SID0gYmFzaXMuZGF0YS5TVEFURS5FUlJPUjsKICAgIHZhciBub3RoaW5nVG9EbyA9IGZ1bmN0aW9uKCkge307CiAgICB2YXIgQ0FMTEJBQ0tfSEFORExFUiA9IHsKICAgICAgc3RhcnQ6IGZ1bmN0aW9uKHRyYW5zcG9ydCwgcmVxdWVzdCkgewogICAgICAgIHZhciBvcmlnaW4gPSByZXF1ZXN0LnJlcXVlc3REYXRhLm9yaWdpbjsKICAgICAgICB0aGlzLnN0YXJ0LmNhbGwocmVxdWVzdC5yZXF1ZXN0RGF0YS5vcmlnaW4pOwogICAgICAgIGlmIChvcmlnaW4uc3RhdGUgIT0gU1RBVEVfUFJPQ0VTU0lORykgb3JpZ2luLnNldFN0YXRlKFNUQVRFX1BST0NFU1NJTkcpOwogICAgICB9LAogICAgICBzdWNjZXNzOiBmdW5jdGlvbih0cmFuc3BvcnQsIHJlcXVlc3QsIGRhdGEpIHsKICAgICAgICB2YXIgb3JpZ2luID0gcmVxdWVzdC5yZXF1ZXN0RGF0YS5vcmlnaW47CiAgICAgICAgdGhpcy5zdWNjZXNzLmNhbGwob3JpZ2luLCBkYXRhKTsKICAgICAgICBpZiAob3JpZ2luLnN0YXRlID09IFNUQVRFX1BST0NFU1NJTkcpIG9yaWdpbi5zZXRTdGF0ZShTVEFURV9SRUFEWSk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uKHRyYW5zcG9ydCwgcmVxdWVzdCwgZXJyb3IpIHsKICAgICAgICB2YXIgb3JpZ2luID0gcmVxdWVzdC5yZXF1ZXN0RGF0YS5vcmlnaW47CiAgICAgICAgdGhpcy5mYWlsdXJlLmNhbGwob3JpZ2luLCBlcnJvcik7CiAgICAgICAgaWYgKG9yaWdpbi5zdGF0ZSA9PSBTVEFURV9QUk9DRVNTSU5HKSBvcmlnaW4uc2V0U3RhdGUoU1RBVEVfRVJST1IsIGVycm9yKTsKICAgICAgfSwKICAgICAgYWJvcnQ6IGZ1bmN0aW9uKHRyYW5zcG9ydCwgcmVxdWVzdCkgewogICAgICAgIHZhciBvcmlnaW4gPSByZXF1ZXN0LnJlcXVlc3REYXRhLm9yaWdpbjsKICAgICAgICB0aGlzLmFib3J0LmNhbGwob3JpZ2luKTsKICAgICAgICBpZiAob3JpZ2luLnN0YXRlID09IFNUQVRFX1BST0NFU1NJTkcpIG9yaWdpbi5zZXRTdGF0ZShTVEFURV9VTkRFRklORUQpOwogICAgICB9LAogICAgICBjb21wbGV0ZTogZnVuY3Rpb24odHJhbnNwb3J0LCByZXF1ZXN0KSB7CiAgICAgICAgdGhpcy5jb21wbGV0ZS5jYWxsKHJlcXVlc3QucmVxdWVzdERhdGEub3JpZ2luKTsKICAgICAgfQogICAgfTsKICAgIHZhciBERUZBVUxUX0NBTExCQUNLID0gewogICAgICBzdGFydDogbm90aGluZ1RvRG8sCiAgICAgIHN1Y2Nlc3M6IG5vdGhpbmdUb0RvLAogICAgICBmYWlsdXJlOiBub3RoaW5nVG9EbywKICAgICAgYWJvcnQ6IG5vdGhpbmdUb0RvLAogICAgICBjb21wbGV0ZTogbm90aGluZ1RvRG8KICAgIH07CiAgICBmdW5jdGlvbiByZXNvbHZlVHJhbnNwb3J0KGNvbmZpZykgewogICAgICBpZiAoY29uZmlnLnRyYW5zcG9ydCkgcmV0dXJuIGNvbmZpZy50cmFuc3BvcnQ7CiAgICAgIGlmIChjb25maWcuc2VydmljZSkgcmV0dXJuIGNvbmZpZy5zZXJ2aWNlLmNyZWF0ZVRyYW5zcG9ydChjb25maWcpOwogICAgICBpZiAoY29uZmlnLmNyZWF0ZVRyYW5zcG9ydCkgcmV0dXJuIGNvbmZpZy5jcmVhdGVUcmFuc3BvcnQoY29uZmlnKTsKICAgICAgcmV0dXJuIG5ldyBiYXNpcy5uZXQuYWpheC5UcmFuc3BvcnQoY29uZmlnKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNyZWF0ZUFjdGlvbihjb25maWcpIHsKICAgICAgY29uZmlnID0gYmFzaXMub2JqZWN0LmV4dGVuZCh7CiAgICAgICAgcHJlcGFyZTogbm90aGluZ1RvRG8sCiAgICAgICAgcmVxdWVzdDogbm90aGluZ1RvRG8KICAgICAgfSwgY29uZmlnKTsKICAgICAgdmFyIGZuID0gYmFzaXMub2JqZWN0LnNwbGljZShjb25maWcsIFsgInByZXBhcmUiLCAicmVxdWVzdCIgXSk7CiAgICAgIHZhciBjYWxsYmFjayA9IGJhc2lzLm9iamVjdC5tZXJnZShERUZBVUxUX0NBTExCQUNLLCBiYXNpcy5vYmplY3Quc3BsaWNlKGNvbmZpZywgWyAic3RhcnQiLCAic3VjY2VzcyIsICJmYWlsdXJlIiwgImFib3J0IiwgImNvbXBsZXRlIiBdKSk7CiAgICAgIHZhciBnZXRUcmFuc3BvcnQgPSBiYXNpcy5mbi5sYXp5SW5pdChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgdHJhbnNwb3J0ID0gcmVzb2x2ZVRyYW5zcG9ydChjb25maWcpOwogICAgICAgIHRyYW5zcG9ydC5hZGRIYW5kbGVyKENBTExCQUNLX0hBTkRMRVIsIGNhbGxiYWNrKTsKICAgICAgICByZXR1cm4gdHJhbnNwb3J0OwogICAgICB9KTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIGFjdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPSBTVEFURV9QUk9DRVNTSU5HKSB7CiAgICAgICAgICBmbi5wcmVwYXJlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICB0aGlzLnJlcXVlc3QgPSBnZXRUcmFuc3BvcnQoKS5yZXF1ZXN0KGJhc2lzLm9iamVjdC5jb21wbGV0ZSh7CiAgICAgICAgICAgIG9yaWdpbjogdGhpcwogICAgICAgICAgfSwgZm4ucmVxdWVzdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKHRoaXMgKyAiIGhhcyBub3QgcmVhZHkgc3RhdGUuIE9wZXJhdGlvbiBhYm9ydGVkIik7CiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGNyZWF0ZTogY3JlYXRlQWN0aW9uCiAgICB9OwogIH0sCiAgIm8uanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vOC5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBucyA9IGJhc2lzLm5hbWVzcGFjZShTdHJpbmcobmFtZXNwYWNlKSk7CiAgICB2YXIgbG9jYXRpb24gPSBnbG9iYWwubG9jYXRpb247CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgZG9jTW9kZSA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgIHZhciBldmVudFN1cHBvcnQgPSAib25oYXNoY2hhbmdlIiBpbiBnbG9iYWwgJiYgKGRvY01vZGUgPT09IHVuZGVmaW5lZCB8fCBkb2NNb2RlID4gNyk7CiAgICB2YXIgQ0hFQ0tfSU5URVJWQUwgPSA1MDsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheS5mcm9tOwogICAgdmFyIHJvdXRlcyA9IHt9OwogICAgdmFyIG1hdGNoZWQgPSB7fTsKICAgIHZhciBzdGFydGVkID0gZmFsc2U7CiAgICB2YXIgY3VycmVudFBhdGg7CiAgICB2YXIgdGltZXI7CiAgICBmdW5jdGlvbiBwYXRoVG9SZWdFeHAocm91dGUpIHsKICAgICAgdmFyIHZhbHVlID0gU3RyaW5nKHJvdXRlIHx8ICIiKTsKICAgICAgZnVuY3Rpb24gZmluZFdvcmQob2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLnN1YnN0cihvZmZzZXQpLm1hdGNoKC9eXHcrLyk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2Uob2Zmc2V0LCBzdG9wQ2hhcikgewogICAgICAgIHZhciByZXN1bHQgPSAiIjsKICAgICAgICB2YXIgcmVzOwogICAgICAgIGZvciAodmFyIGkgPSBvZmZzZXQ7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGMgPSB2YWx1ZS5jaGFyQXQoaSk7CiAgICAgICAgICBzd2l0Y2ggKGMpIHsKICAgICAgICAgICAgY2FzZSBzdG9wQ2hhcjoKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcmVzdWx0OiByZXN1bHQsCiAgICAgICAgICAgICAgICBvZmZzZXQ6IGkKICAgICAgICAgICAgICB9OwogICAgICAgICAgICBjYXNlICJcXCI6CiAgICAgICAgICAgICAgcmVzdWx0ICs9ICJcXCIgKyB2YWx1ZS5jaGFyQXQoKytpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAifCI6CiAgICAgICAgICAgICAgcmVzdWx0ICs9IHN0b3BDaGFyICE9ICIpIiA/ICJcXHwiIDogInwiOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICIoIjoKICAgICAgICAgICAgICBpZiAocmVzID0gcGFyc2UoaSArIDEsICIpIikpIHsKICAgICAgICAgICAgICAgIGkgPSByZXMub2Zmc2V0OwogICAgICAgICAgICAgICAgcmVzdWx0ICs9ICIoPzoiICsgcmVzLnJlc3VsdCArICIpPyI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdCArPSAiXFwoIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIjoiOgogICAgICAgICAgICAgIGlmIChyZXMgPSBmaW5kV29yZChpICsgMSkpIHsKICAgICAgICAgICAgICAgIGkgKz0gcmVzWzBdLmxlbmd0aDsKICAgICAgICAgICAgICAgIHJlc3VsdCArPSAiKFteL10rKSI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdCArPSAiOiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICIqIjoKICAgICAgICAgICAgICBpZiAocmVzID0gZmluZFdvcmQoaSArIDEpKSB7CiAgICAgICAgICAgICAgICBpICs9IHJlc1swXS5sZW5ndGg7CiAgICAgICAgICAgICAgICByZXN1bHQgKz0gIiguKj8pIjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzdWx0ICs9ICJcXCoiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXN1bHQgKz0gYmFzaXMuc3RyaW5nLmZvclJlZ0V4cChjKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0b3BDaGFyID8gbnVsbCA6IHJlc3VsdDsKICAgICAgfQogICAgICByZXR1cm4gbmV3IFJlZ0V4cCgiXiIgKyBwYXJzZSgwKSArICIkIiwgImkiKTsKICAgIH0KICAgIGZ1bmN0aW9uIHN0YXJ0V2F0Y2goKSB7CiAgICAgIGlmIChldmVudFN1cHBvcnQpIGJhc2lzLmRvbS5ldmVudC5hZGRIYW5kbGVyKGdsb2JhbCwgImhhc2hjaGFuZ2UiLCBjaGVja1VybCk7IGVsc2UgdGltZXIgPSBzZXRJbnRlcnZhbChjaGVja1VybCwgQ0hFQ0tfSU5URVJWQUwpOwogICAgfQogICAgZnVuY3Rpb24gc3RvcFdhdGNoKCkgewogICAgICBpZiAoZXZlbnRTdXBwb3J0KSBiYXNpcy5kb20uZXZlbnQucmVtb3ZlSGFuZGxlcihnbG9iYWwsICJoYXNoY2hhbmdlIiwgY2hlY2tVcmwpOyBlbHNlIGNsZWFySW50ZXJ2YWwodGltZXIpOwogICAgfQogICAgZnVuY3Rpb24gc3RhcnQoKSB7CiAgICAgIGlmICghc3RhcnRlZCkgewogICAgICAgIHN0YXJ0V2F0Y2goKTsKICAgICAgICBzdGFydGVkID0gdHJ1ZTsKICAgICAgICBpZiAobnMuZGVidWcpIGJhc2lzLmRldi5sb2cobmFtZXNwYWNlICsgIiBzdGFydGVkIik7CiAgICAgICAgY2hlY2tVcmwoKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gc3RvcCgpIHsKICAgICAgaWYgKHN0YXJ0ZWQpIHsKICAgICAgICBzdG9wV2F0Y2goKTsKICAgICAgICBzdGFydGVkID0gZmFsc2U7CiAgICAgICAgaWYgKG5zLmRlYnVnKSBiYXNpcy5kZXYubG9nKG5hbWVzcGFjZSArICIgc3RvcHBlZCIpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBjaGVja1VybCgpIHsKICAgICAgdmFyIG5ld1BhdGggPSBsb2NhdGlvbi5oYXNoLnN1YnN0cigxKSB8fCAiIjsKICAgICAgaWYgKG5ld1BhdGggIT0gY3VycmVudFBhdGgpIHsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICAgIHZhciBsb2cgPSBbXTsKICAgICAgICBjdXJyZW50UGF0aCA9IG5ld1BhdGg7CiAgICAgICAgZm9yICh2YXIgcGF0aCBpbiByb3V0ZXMpIHsKICAgICAgICAgIHZhciByb3V0ZSA9IHJvdXRlc1twYXRoXTsKICAgICAgICAgIHZhciBtYXRjaCA9IG5ld1BhdGgubWF0Y2gocm91dGUucmVnZXhwKTsKICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICBpZiAoIW1hdGNoZWRbcGF0aF0pIGluc2VydGVkLnB1c2gocm91dGUpOwogICAgICAgICAgICBtYXRjaGVkW3BhdGhdID0gbWF0Y2g7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobWF0Y2hlZFtwYXRoXSkgewogICAgICAgICAgICAgIGRlbGV0ZWQucHVzaChyb3V0ZSk7CiAgICAgICAgICAgICAgZGVsZXRlIG1hdGNoZWRbcGF0aF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIHJvdXRlOyByb3V0ZSA9IGRlbGV0ZWRbaV07IGkrKykgewogICAgICAgICAgdmFyIGNhbGxiYWNrcyA9IGFycmF5RnJvbShyb3V0ZS5jYWxsYmFja3MpOwogICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGl0ZW07IGl0ZW0gPSBjYWxsYmFja3Nbal07IGorKykgaWYgKGl0ZW0uY2FsbGJhY2subGVhdmUpIHsKICAgICAgICAgICAgaXRlbS5jYWxsYmFjay5sZWF2ZS5jYWxsKGl0ZW0uY29udGV4dCk7CiAgICAgICAgICAgIGxvZy5wdXNoKCJcbiIsIHsKICAgICAgICAgICAgICB0eXBlOiAibGVhdmUiLAogICAgICAgICAgICAgIHBhdGg6IHJvdXRlLnNvdXJjZSwKICAgICAgICAgICAgICBjYjogaXRlbSwKICAgICAgICAgICAgICByb3V0ZTogcm91dGUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwLCByb3V0ZTsgcm91dGUgPSBpbnNlcnRlZFtpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gYXJyYXlGcm9tKHJvdXRlLmNhbGxiYWNrcyk7CiAgICAgICAgICBmb3IgKHZhciBqID0gMCwgaXRlbTsgaXRlbSA9IGNhbGxiYWNrc1tqXTsgaisrKSBpZiAoaXRlbS5jYWxsYmFjay5lbnRlcikgewogICAgICAgICAgICBpdGVtLmNhbGxiYWNrLmVudGVyLmNhbGwoaXRlbS5jb250ZXh0KTsKICAgICAgICAgICAgbG9nLnB1c2goIlxuIiwgewogICAgICAgICAgICAgIHR5cGU6ICJlbnRlciIsCiAgICAgICAgICAgICAgcGF0aDogcm91dGUuc291cmNlLAogICAgICAgICAgICAgIGNiOiBpdGVtLAogICAgICAgICAgICAgIHJvdXRlOiByb3V0ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgcGF0aCBpbiBtYXRjaGVkKSB7CiAgICAgICAgICB2YXIgcm91dGUgPSByb3V0ZXNbcGF0aF07CiAgICAgICAgICB2YXIgYXJncyA9IGFycmF5RnJvbShtYXRjaGVkW3BhdGhdLCAxKTsKICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBhcnJheUZyb20ocm91dGUuY2FsbGJhY2tzKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gY2FsbGJhY2tzW2ldOyBpKyspIGlmIChpdGVtLmNhbGxiYWNrLm1hdGNoKSB7CiAgICAgICAgICAgIGl0ZW0uY2FsbGJhY2subWF0Y2guYXBwbHkoaXRlbS5jb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgbG9nLnB1c2goIlxuIiwgewogICAgICAgICAgICAgIHR5cGU6ICJtYXRjaCIsCiAgICAgICAgICAgICAgcGF0aDogcm91dGUuc291cmNlLAogICAgICAgICAgICAgIGNiOiBpdGVtLAogICAgICAgICAgICAgIHJvdXRlOiByb3V0ZSwKICAgICAgICAgICAgICBhcmdzOiBhcmdzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobnMuZGVidWcpIGJhc2lzLmRldi5pbmZvLmFwcGx5KGJhc2lzLmRldiwgWyBuYW1lc3BhY2UgKyAnOiBoYXNoIGNoYW5nZWQgdG8gIicgKyBuZXdQYXRoICsgJyInIF0uY29uY2F0KGxvZy5sZW5ndGggPyBsb2cgOiAiPG5vIG1hdGNoZXM+IikpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGQocGF0aCwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgdmFyIHJvdXRlID0gcm91dGVzW3BhdGhdOwogICAgICB2YXIgY29uZmlnOwogICAgICBpZiAoIXJvdXRlKSB7CiAgICAgICAgcm91dGUgPSByb3V0ZXNbcGF0aF0gPSB7CiAgICAgICAgICBzb3VyY2U6IHBhdGgsCiAgICAgICAgICBjYWxsYmFja3M6IFtdLAogICAgICAgICAgcmVnZXhwOiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwocGF0aCkgIT0gIltvYmplY3QgUmVnRXhwXSIgPyBwYXRoVG9SZWdFeHAocGF0aCkgOiBwYXRoCiAgICAgICAgfTsKICAgICAgICBpZiAodHlwZW9mIGN1cnJlbnRQYXRoID09ICJzdHJpbmciKSB7CiAgICAgICAgICB2YXIgbWF0Y2ggPSBjdXJyZW50UGF0aC5tYXRjaChyb3V0ZS5yZWdleHApOwogICAgICAgICAgaWYgKG1hdGNoKSBtYXRjaGVkW3BhdGhdID0gbWF0Y2g7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbmZpZyA9IHsKICAgICAgICBjYl86IGNhbGxiYWNrLAogICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgY2FsbGJhY2s6IHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iID8gY2FsbGJhY2sgfHwge30gOiB7CiAgICAgICAgICBtYXRjaDogY2FsbGJhY2sKICAgICAgICB9CiAgICAgIH07CiAgICAgIHJvdXRlLmNhbGxiYWNrcy5wdXNoKGNvbmZpZyk7CiAgICAgIGlmIChwYXRoIGluIG1hdGNoZWQpIHsKICAgICAgICBpZiAoY29uZmlnLmNhbGxiYWNrLmVudGVyKSBjb25maWcuY2FsbGJhY2suZW50ZXIuY2FsbChjb250ZXh0KTsKICAgICAgICBpZiAoY29uZmlnLmNhbGxiYWNrLm1hdGNoKSBjb25maWcuY2FsbGJhY2subWF0Y2guYXBwbHkoY29udGV4dCwgYXJyYXlGcm9tKG1hdGNoZWRbcGF0aF0sIDEpKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlKHBhdGgsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciByb3V0ZSA9IHJvdXRlc1twYXRoXTsKICAgICAgaWYgKHJvdXRlKSB7CiAgICAgICAgdmFyIGlkeCA9IC0xOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjYjsgY2IgPSByb3V0ZS5jYWxsYmFja3NbaV07IGkrKykgaWYgKGNiLmNiXyA9PT0gY2FsbGJhY2sgJiYgY2IuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgICAgcm91dGUuY2FsbGJhY2tzLnNwbGljZShpLCAxKTsKICAgICAgICAgIGlmICghcm91dGUuY2FsbGJhY2tzLmxlbmd0aCkgewogICAgICAgICAgICBkZWxldGUgcm91dGVzW3BhdGhdOwogICAgICAgICAgICBkZWxldGUgbWF0Y2hlZFtwYXRoXTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gbmF2aWdhdGUocGF0aCwgcmVwbGFjZSkgewogICAgICBpZiAocmVwbGFjZSkgbG9jYXRpb24ucmVwbGFjZShsb2NhdGlvbi5wYXRobmFtZSArICIjIiArIHBhdGgpOyBlbHNlIGxvY2F0aW9uLmhhc2ggPSBwYXRoOwogICAgICBpZiAoc3RhcnRlZCkgY2hlY2tVcmwoKTsKICAgIH0KICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBkZWJ1ZzogZmFsc2UsCiAgICAgIGFkZDogYWRkLAogICAgICByZW1vdmU6IHJlbW92ZSwKICAgICAgc3RvcDogc3RvcCwKICAgICAgc3RhcnQ6IHN0YXJ0LAogICAgICBjaGVja1VybDogY2hlY2tVcmwsCiAgICAgIG5hdmlnYXRlOiBuYXZpZ2F0ZQogICAgfTsKICB9LAogICJwLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQgfHwgewogICAgICB0aXRsZTogInVua25vd24iCiAgICB9OwogICAgdmFyIGFwcFRpdGxlID0gZG9jdW1lbnQudGl0bGU7CiAgICB2YXIgYXBwSW5pdCA9IGJhc2lzLmZuLiR1bmRlZjsKICAgIHZhciBhcHBJbmplY3RQb2ludDsKICAgIHZhciBhcHBFbDsKICAgIGZ1bmN0aW9uIHVwZGF0ZVRpdGxlKHZhbHVlKSB7CiAgICAgIGRvY3VtZW50LnRpdGxlID0gdmFsdWU7CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlTm9kZShyZWYpIHsKICAgICAgcmV0dXJuIHR5cGVvZiByZWYgPT0gInN0cmluZyIgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChyZWYpIDogcmVmOwogICAgfQogICAgZnVuY3Rpb24gcmVwbGFjZU5vZGUob2xkQ2hpbGQsIG5ld0NoaWxkKSB7CiAgICAgIG9sZENoaWxkLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld0NoaWxkLCBvbGRDaGlsZCk7CiAgICB9CiAgICB2YXIgY3JlYXRlQXBwID0gYmFzaXMuZm4ubGF6eUluaXQoZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgIHZhciByZWFkeUhhbmRsZXJzID0gW107CiAgICAgIHZhciBpbml0ZWQgPSBmYWxzZTsKICAgICAgdmFyIGFwcCA9IHsKICAgICAgICBpbml0ZWQ6IGZhbHNlLAogICAgICAgIHNldFRpdGxlOiBmdW5jdGlvbih0aXRsZSkgewogICAgICAgICAgaWYgKHRpdGxlICE9IGFwcFRpdGxlKSB7CiAgICAgICAgICAgIGlmIChhcHBUaXRsZSBpbnN0YW5jZW9mIGJhc2lzLlRva2VuKSBhcHBUaXRsZS5kZXRhY2godXBkYXRlVGl0bGUpOwogICAgICAgICAgICBpZiAodGl0bGUgaW5zdGFuY2VvZiBiYXNpcy5Ub2tlbikgewogICAgICAgICAgICAgIHRpdGxlLmF0dGFjaCh1cGRhdGVUaXRsZSk7CiAgICAgICAgICAgICAgdXBkYXRlVGl0bGUodGl0bGUuZ2V0KCkpOwogICAgICAgICAgICB9IGVsc2UgdXBkYXRlVGl0bGUodGl0bGUpOwogICAgICAgICAgICBhcHBUaXRsZSA9IHRpdGxlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc2V0RWxlbWVudDogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgIHZhciBuZXdBcHBFbCA9IHJlc29sdmVOb2RlKGVsKTsKICAgICAgICAgIGlmIChhcHBFbCA9PSBuZXdBcHBFbCkgcmV0dXJuOwogICAgICAgICAgaWYgKGFwcEVsKSB7CiAgICAgICAgICAgIHJlcGxhY2VOb2RlKGFwcEVsLCBuZXdBcHBFbCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gZWxzZSBhcHBFbCA9IG5ld0FwcEVsOwogICAgICAgICAgaWYgKCFhcHBJbmplY3RQb2ludCkgYXBwSW5qZWN0UG9pbnQgPSB7CiAgICAgICAgICAgIHR5cGU6ICJhcHBlbmQiLAogICAgICAgICAgICBub2RlOiBkb2N1bWVudC5ib2R5CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIG5vZGUgPSByZXNvbHZlTm9kZShhcHBJbmplY3RQb2ludC5ub2RlKTsKICAgICAgICAgIGlmICghbm9kZSkgcmV0dXJuOwogICAgICAgICAgaWYgKGFwcEluamVjdFBvaW50LnR5cGUgPT0gImFwcGVuZCIpIG5vZGUuYXBwZW5kQ2hpbGQoYXBwRWwpOyBlbHNlIHJlcGxhY2VOb2RlKG5vZGUsIGFwcEVsKTsKICAgICAgICB9LAogICAgICAgIHJlYWR5OiBmdW5jdGlvbihmbiwgY29udGV4dCkgewogICAgICAgICAgaWYgKGluaXRlZCkgZm4uY2FsbChjb250ZXh0LCBhcHApOyBlbHNlIHJlYWR5SGFuZGxlcnMucHVzaCh7CiAgICAgICAgICAgIGZuOiBmbiwKICAgICAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwogICAgICBmb3IgKHZhciBrZXkgaW4gY29uZmlnKSB7CiAgICAgICAgdmFyIHZhbHVlID0gY29uZmlnW2tleV07CiAgICAgICAgc3dpdGNoIChrZXkpIHsKICAgICAgICAgIGNhc2UgInRpdGxlIjoKICAgICAgICAgICAgYXBwLnNldFRpdGxlKHZhbHVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJjb250YWluZXIiOgogICAgICAgICAgICBhcHBJbmplY3RQb2ludCA9IHsKICAgICAgICAgICAgICB0eXBlOiAiYXBwZW5kIiwKICAgICAgICAgICAgICBub2RlOiB2YWx1ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgInJlcGxhY2UiOgogICAgICAgICAgICBhcHBJbmplY3RQb2ludCA9IHsKICAgICAgICAgICAgICB0eXBlOiAicmVwbGFjZSIsCiAgICAgICAgICAgICAgbm9kZTogdmFsdWUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJlbGVtZW50IjoKICAgICAgICAgICAgYXBwRWwgPSB2YWx1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJpbml0IjoKICAgICAgICAgICAgYXBwSW5pdCA9IHR5cGVvZiB2YWx1ZSA9PSAiZnVuY3Rpb24iID8gdmFsdWUgOiBhcHBJbml0OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJVbmtub3duIGNvbmZpZyBwcm9wZXJ0eSBgIiArIGtleSArICJgIGZvciBhcHAsIHZhbHVlOiIsIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYmFzaXMucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGluc2VydEVsID0gYXBwRWw7CiAgICAgICAgdmFyIGluaXRSZXN1bHQgPSBhcHBJbml0LmNhbGwoYXBwKTsKICAgICAgICBpZiAoaW5pdFJlc3VsdCkgewogICAgICAgICAgaWYgKGluaXRSZXN1bHQuZWxlbWVudCkgaW5zZXJ0RWwgPSBpbml0UmVzdWx0LmVsZW1lbnQ7IGVsc2UgaW5zZXJ0RWwgPSBpbml0UmVzdWx0OwogICAgICAgIH0KICAgICAgICBhcHBFbCA9IG51bGw7CiAgICAgICAgYXBwLnNldEVsZW1lbnQoaW5zZXJ0RWwpOwogICAgICAgIGluaXRlZCA9IHRydWU7CiAgICAgICAgYXBwLmluaXRlZCA9IHRydWU7CiAgICAgICAgdmFyIGhhbmRsZXI7CiAgICAgICAgd2hpbGUgKGhhbmRsZXIgPSByZWFkeUhhbmRsZXJzLnNoaWZ0KCkpIGhhbmRsZXIuZm4uY2FsbChoYW5kbGVyLmNvbnRleHQsIGFwcCk7CiAgICAgIH0pOwogICAgICByZXR1cm4gYXBwOwogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgY3JlYXRlOiBjcmVhdGVBcHAKICAgIH07CiAgfQp9OwoKKGZ1bmN0aW9uIGNyZWF0ZUJhc2lzSW5zdGFuY2UoZ2xvYmFsLCBfX2Jhc2lzRmlsZW5hbWUsIF9fY29uZmlnKSB7CiAgInVzZSBzdHJpY3QiOwogIHZhciBWRVJTSU9OID0gIjEuMy4zIjsKICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKICBmdW5jdGlvbiBnZW5VSUQobGVuKSB7CiAgICBmdW5jdGlvbiBiYXNlMzYodmFsKSB7CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbCkudG9TdHJpbmcoMzYpOwogICAgfQogICAgdmFyIHJlc3VsdCA9IGJhc2UzNigxMCArIDI1ICogTWF0aC5yYW5kb20oKSk7CiAgICBpZiAoIWxlbikgbGVuID0gMTY7CiAgICB3aGlsZSAocmVzdWx0Lmxlbmd0aCA8IGxlbikgcmVzdWx0ICs9IGJhc2UzNihuZXcgRGF0ZSAqIE1hdGgucmFuZG9tKCkpOwogICAgcmV0dXJuIHJlc3VsdC5zdWJzdHIoMCwgbGVuKTsKICB9CiAgZnVuY3Rpb24gZXh0ZW5kKGRlc3QsIHNvdXJjZSkgewogICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkgZGVzdFtrZXldID0gc291cmNlW2tleV07CiAgICByZXR1cm4gZGVzdDsKICB9CiAgZnVuY3Rpb24gY29tcGxldGUoZGVzdCwgc291cmNlKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gc291cmNlKSBpZiAoa2V5IGluIGRlc3QgPT0gZmFsc2UpIGRlc3Rba2V5XSA9IHNvdXJjZVtrZXldOwogICAgcmV0dXJuIGRlc3Q7CiAgfQogIGZ1bmN0aW9uIGtleXMob2JqZWN0KSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSByZXN1bHQucHVzaChrZXkpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gdmFsdWVzKG9iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgcmVzdWx0LnB1c2gob2JqZWN0W2tleV0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gc2xpY2Uoc291cmNlLCBrZXlzKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBpZiAoIWtleXMpIHJldHVybiBleHRlbmQocmVzdWx0LCBzb3VyY2UpOwogICAgZm9yICh2YXIgaSA9IDAsIGtleTsga2V5ID0ga2V5c1tpKytdOyApIGlmIChrZXkgaW4gc291cmNlKSByZXN1bHRba2V5XSA9IHNvdXJjZVtrZXldOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gc3BsaWNlKHNvdXJjZSwga2V5cykgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgaWYgKCFrZXlzKSByZXR1cm4gZXh0ZW5kKHJlc3VsdCwgc291cmNlKTsKICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGtleXNbaSsrXTsgKSBpZiAoa2V5IGluIHNvdXJjZSkgewogICAgICByZXN1bHRba2V5XSA9IHNvdXJjZVtrZXldOwogICAgICBkZWxldGUgc291cmNlW2tleV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBtZXJnZSgpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSBleHRlbmQocmVzdWx0LCBhcmd1bWVudHNbaV0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gaXRlcmF0ZShvYmplY3QsIGNhbGxiYWNrLCB0aGlzT2JqZWN0KSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSByZXN1bHQucHVzaChjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIGtleSwgb2JqZWN0W2tleV0pKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uICR1bmRlZmluZWQodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PSB1bmRlZmluZWQ7CiAgfQogIGZ1bmN0aW9uICRkZWZpbmVkKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgIT0gdW5kZWZpbmVkOwogIH0KICBmdW5jdGlvbiAkaXNOdWxsKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB2YWx1ZSA9PSB1bmRlZmluZWQ7CiAgfQogIGZ1bmN0aW9uICRpc05vdE51bGwodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSAhPSBudWxsICYmIHZhbHVlICE9IHVuZGVmaW5lZDsKICB9CiAgZnVuY3Rpb24gJGlzU2FtZSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09PSB0aGlzOwogIH0KICBmdW5jdGlvbiAkaXNOb3RTYW1lKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgIT09IHRoaXM7CiAgfQogIGZ1bmN0aW9uICRzZWxmKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGZ1bmN0aW9uICRjb25zdCh2YWx1ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwogIH0KICBmdW5jdGlvbiAkZmFsc2UoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uICR0cnVlKCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGZ1bmN0aW9uICRudWxsKCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGZ1bmN0aW9uICR1bmRlZigpIHt9CiAgdmFyIGdldHRlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIElEID0gImJhc2lzR2V0dGVySWQiICsgZ2VuVUlEKCkgKyAiXyI7CiAgICB2YXIgbW9kaWZpY2F0b3JTZWVkID0gMTsKICAgIHZhciBzaW1wbGVQYXRoID0gL15bYS16JF9dW2EteiRfMC05XSooXC5bYS16JF9dW2EteiRfMC05XSopKiQvaTsKICAgIHZhciBnZXR0ZXJNYXAgPSBbXTsKICAgIHZhciBwYXRoQ2FjaGUgPSB7fTsKICAgIHZhciBtb2RDYWNoZSA9IHt9OwogICAgZnVuY3Rpb24gYnVpbGRGdW5jdGlvbihwYXRoKSB7CiAgICAgIGlmIChzaW1wbGVQYXRoLnRlc3QocGF0aCkpIHsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCIuIik7CiAgICAgICAgdmFyIGZvbyA9IHBhcnRzWzBdOwogICAgICAgIHZhciBiYXIgPSBwYXJ0c1sxXTsKICAgICAgICB2YXIgYmF6ID0gcGFydHNbMl07CiAgICAgICAgdmFyIGZuOwogICAgICAgIHN3aXRjaCAocGFydHMubGVuZ3RoKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGZuID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdCAhPSBudWxsID8gb2JqZWN0W2Zvb10gOiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dW2Jhcl0gOiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dW2Jhcl1bYmF6XSA6IG9iamVjdDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIGlmIChvYmplY3QgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgb2JqZWN0ID0gb2JqZWN0W2Zvb11bYmFyXVtiYXpdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDMsIGtleTsga2V5ID0gcGFydHNbaV07IGkrKykgb2JqZWN0ID0gb2JqZWN0W2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZuID0gRnVuY3Rpb24oInBhcnRzIiwgInJldHVybiAiICsgZm4udG9TdHJpbmcoKS5yZXBsYWNlKC8oZm9vfGJhcnxiYXopL2csIGZ1bmN0aW9uKG0sIHcpIHsKICAgICAgICAgIHJldHVybiAnIicgKyBwYXJ0c1t3ID09ICJmb28iID8gMCA6IHcgPT0gImJhciIgPyAxIDogMl0gKyAnIic7CiAgICAgICAgfSkucmVwbGFjZSgvXFtcIihbXiJdKylcIlxdL2csICIuJDEiKSkocGFydHMpOwogICAgICAgIHJldHVybiBmbjsKICAgICAgfQogICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCJvYmplY3QiLCAicmV0dXJuIG9iamVjdCAhPSBudWxsID8gb2JqZWN0LiIgKyBwYXRoICsgIiA6IG9iamVjdCIpOwogICAgfQogICAgdmFyIGdldHRlckZuID0gZnVuY3Rpb24ocGF0aCwgbW9kaWZpY2F0b3IpIHsKICAgICAgdmFyIGZ1bmM7CiAgICAgIHZhciByZXN1bHQ7CiAgICAgIHZhciBnZXR0ZXJJZDsKICAgICAgaWYgKCFwYXRoIHx8IHBhdGggPT09IG51bGxHZXR0ZXIpIHJldHVybiBudWxsR2V0dGVyOwogICAgICBpZiAodHlwZW9mIHBhdGggPT0gImZ1bmN0aW9uIikgewogICAgICAgIGdldHRlcklkID0gcGF0aFtJRF07CiAgICAgICAgaWYgKGdldHRlcklkKSB7CiAgICAgICAgICBmdW5jID0gZ2V0dGVyTWFwW01hdGguYWJzKGdldHRlcklkKSAtIDFdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmdW5jID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBwYXRoKG9iamVjdCk7CiAgICAgICAgICB9OwogICAgICAgICAgZnVuYy5iYXNlID0gcGF0aDsKICAgICAgICAgIGZ1bmMuX19leHRlbmRfXyA9IGdldHRlcjsKICAgICAgICAgIGdldHRlcklkID0gZ2V0dGVyTWFwLnB1c2goZnVuYyk7CiAgICAgICAgICBwYXRoW0lEXSA9IC1nZXR0ZXJJZDsKICAgICAgICAgIGZ1bmNbSURdID0gZ2V0dGVySWQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZ1bmMgPSBwYXRoQ2FjaGVbcGF0aF07CiAgICAgICAgaWYgKGZ1bmMpIHsKICAgICAgICAgIGdldHRlcklkID0gZnVuY1tJRF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZ1bmMgPSBidWlsZEZ1bmN0aW9uKHBhdGgpOwogICAgICAgICAgZnVuYy5iYXNlID0gcGF0aDsKICAgICAgICAgIGZ1bmMuX19leHRlbmRfXyA9IGdldHRlcjsKICAgICAgICAgIGdldHRlcklkID0gZ2V0dGVyTWFwLnB1c2goZnVuYyk7CiAgICAgICAgICBmdW5jW0lEXSA9IGdldHRlcklkOwogICAgICAgICAgcGF0aENhY2hlW3BhdGhdID0gZnVuYzsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIG1vZFR5cGUgPSBtb2RpZmljYXRvciAhPSBudWxsICYmIHR5cGVvZiBtb2RpZmljYXRvcjsKICAgICAgaWYgKCFtb2RUeXBlKSByZXR1cm4gZnVuYzsKICAgICAgdmFyIG1vZExpc3QgPSBtb2RDYWNoZVtnZXR0ZXJJZF07CiAgICAgIHZhciBtb2RJZDsKICAgICAgaWYgKG1vZFR5cGUgPT0gInN0cmluZyIpIG1vZElkID0gbW9kVHlwZSArIG1vZGlmaWNhdG9yOyBlbHNlIGlmIChtb2RUeXBlID09ICJmdW5jdGlvbiIpIG1vZElkID0gbW9kaWZpY2F0b3IuYmFzaXNNb2RJZF87IGVsc2UgaWYgKG1vZFR5cGUgIT0gIm9iamVjdCIpIHsKICAgICAgICBjb25zb2xlTWV0aG9kcy53YXJuKCJiYXNpcy5nZXR0ZXI6IHdyb25nIG1vZGlmaWNhdG9yIHR5cGUsIG1vZGlmaWNhdG9yIG5vdCB1c2VkLCBwYXRoOiAiLCBwYXRoLCAiLCBtb2RpZmljYXRvcjoiLCBtb2RpZmljYXRvcik7CiAgICAgICAgcmV0dXJuIGZ1bmM7CiAgICAgIH0KICAgICAgaWYgKG1vZElkICYmIG1vZExpc3QgJiYgbW9kTGlzdFttb2RJZF0pIHJldHVybiBtb2RMaXN0W21vZElkXTsKICAgICAgaWYgKHR5cGVvZiBmdW5jLmJhc2UgPT0gImZ1bmN0aW9uIikgZnVuYyA9IGZ1bmMuYmFzZTsKICAgICAgc3dpdGNoIChtb2RUeXBlKSB7CiAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgIHJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nRnVuY3Rpb25zLmZvcm1hdChtb2RpZmljYXRvciwgZnVuYyhvYmplY3QpKTsKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICBpZiAoIW1vZElkKSB7CiAgICAgICAgICAgIG1vZElkID0gbW9kVHlwZSArIG1vZGlmaWNhdG9yU2VlZCsrOwogICAgICAgICAgICBtb2RpZmljYXRvci5iYXNpc01vZElkXyA9IG1vZElkOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBtb2RpZmljYXRvcihmdW5jKG9iamVjdCkpOwogICAgICAgICAgfTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgcmV0dXJuIG1vZGlmaWNhdG9yW2Z1bmMob2JqZWN0KV07CiAgICAgICAgICB9OwogICAgICB9CiAgICAgIHJlc3VsdC5iYXNlID0gZnVuYy5iYXNlIHx8IGZ1bmM7CiAgICAgIHJlc3VsdC5fX2V4dGVuZF9fID0gZ2V0dGVyOwogICAgICBpZiAobW9kSWQpIHsKICAgICAgICBpZiAoIW1vZExpc3QpIHsKICAgICAgICAgIG1vZExpc3QgPSB7fTsKICAgICAgICAgIG1vZENhY2hlW2dldHRlcklkXSA9IG1vZExpc3Q7CiAgICAgICAgfQogICAgICAgIG1vZExpc3RbbW9kSWRdID0gcmVzdWx0OwogICAgICAgIHJlc3VsdC5tb2QgPSBtb2RpZmljYXRvcjsKICAgICAgICByZXN1bHRbSURdID0gZ2V0dGVyTWFwLnB1c2gocmVzdWx0KTsKICAgICAgfSBlbHNlIHt9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgZ2V0dGVyRm4uSUQgPSBJRDsKICAgIHJldHVybiBnZXR0ZXJGbjsKICB9KCk7CiAgdmFyIG51bGxHZXR0ZXIgPSBleHRlbmQoZnVuY3Rpb24oKSB7fSwgewogICAgX19leHRlbmRfXzogZ2V0dGVyCiAgfSk7CiAgZnVuY3Rpb24gd3JhcHBlcihrZXkpIHsKICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KICBmdW5jdGlvbiBsYXp5SW5pdChpbml0LCB0aGlzT2JqZWN0KSB7CiAgICB2YXIgaW5pdGVkID0gMDsKICAgIHZhciBzZWxmOwogICAgdmFyIGRhdGE7CiAgICByZXR1cm4gc2VsZiA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIShpbml0ZWQrKykpIHsKICAgICAgICBzZWxmLmluaXRlZCA9IHRydWU7CiAgICAgICAgc2VsZi5kYXRhID0gZGF0YSA9IGluaXQuYXBwbHkodGhpc09iamVjdCB8fCB0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PSAidW5kZWZpbmVkIikgY29uc29sZU1ldGhvZHMud2FybigibGF6eUluaXQgZnVuY3Rpb24gcmV0dXJucyBub3RoaW5nOlxuIiArIGluaXQpOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhOwogICAgfTsKICB9CiAgZnVuY3Rpb24gbGF6eUluaXRBbmRSdW4oaW5pdCwgcnVuLCB0aGlzT2JqZWN0KSB7CiAgICB2YXIgaW5pdGVkID0gMDsKICAgIHZhciBzZWxmOwogICAgdmFyIGRhdGE7CiAgICByZXR1cm4gc2VsZiA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIShpbml0ZWQrKykpIHsKICAgICAgICBzZWxmLmluaXRlZCA9IHRydWU7CiAgICAgICAgc2VsZi5kYXRhID0gZGF0YSA9IGluaXQuY2FsbCh0aGlzT2JqZWN0IHx8IHRoaXMpOwogICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PSAidW5kZWZpbmVkIikgY29uc29sZU1ldGhvZHMud2FybigibGF6eUluaXRBbmRSdW4gZnVuY3Rpb24gcmV0dXJucyBub3RoaW5nOlxuIiArIGluaXQpOwogICAgICB9CiAgICAgIHJ1bi5hcHBseShkYXRhLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gZGF0YTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHJ1bk9uY2UocnVuLCB0aGlzT2JqZWN0KSB7CiAgICB2YXIgZmlyZWQgPSAwOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoIShmaXJlZCsrKSkgcmV0dXJuIHJ1bi5hcHBseSh0aGlzT2JqZWN0IHx8IHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogIH0KICB2YXIgY29uc29sZU1ldGhvZHMgPSBmdW5jdGlvbigpIHsKICAgIHZhciBtZXRob2RzID0gewogICAgICBsb2c6ICR1bmRlZiwKICAgICAgaW5mbzogJHVuZGVmLAogICAgICB3YXJuOiAkdW5kZWYsCiAgICAgIGVycm9yOiAkdW5kZWYKICAgIH07CiAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT0gInVuZGVmaW5lZCIpIGl0ZXJhdGUobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICBtZXRob2RzW21ldGhvZE5hbWVdID0gImJpbmQiIGluIEZ1bmN0aW9uLnByb3RvdHlwZSAmJiB0eXBlb2YgY29uc29sZVttZXRob2ROYW1lXSA9PSAiZnVuY3Rpb24iID8gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQuY2FsbChjb25zb2xlW21ldGhvZE5hbWVdLCBjb25zb2xlKSA6IGZ1bmN0aW9uKCkgewogICAgICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGVbbWV0aG9kTmFtZV0sIGNvbnNvbGUsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9KTsKICAgIHJldHVybiBtZXRob2RzOwogIH0oKTsKICB2YXIgc2V0SW1tZWRpYXRlID0gZ2xvYmFsLnNldEltbWVkaWF0ZSB8fCBnbG9iYWwubXNTZXRJbW1lZGlhdGU7CiAgdmFyIGNsZWFySW1tZWRpYXRlID0gZ2xvYmFsLmNsZWFySW1tZWRpYXRlIHx8IGdsb2JhbC5tc1NldEltbWVkaWF0ZTsKICBpZiAoc2V0SW1tZWRpYXRlKSBzZXRJbW1lZGlhdGUgPSBzZXRJbW1lZGlhdGUuYmluZChnbG9iYWwpOwogIGlmIChjbGVhckltbWVkaWF0ZSkgY2xlYXJJbW1lZGlhdGUgPSBjbGVhckltbWVkaWF0ZS5iaW5kKGdsb2JhbCk7CiAgaWYgKCFzZXRJbW1lZGlhdGUpIChmdW5jdGlvbigpIHsKICAgIHZhciBNRVNTQUdFX05BTUUgPSAiYmFzaXNqcy5zZXRJbW1lZGlhdGUiOwogICAgdmFyIHJ1blRhc2sgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRhc2tCeUlkID0ge307CiAgICAgIHZhciB0YXNrSWQgPSAxOwogICAgICBzZXRJbW1lZGlhdGUgPSBmdW5jdGlvbihmbikgewogICAgICAgIGlmICh0eXBlb2YgZm4gIT0gImZ1bmN0aW9uIikgewogICAgICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMuc2V0SW1tZWRpYXRlKCkgYW5kIGJhc2lzLm5leHRUaWNrKCkgYWNjZXB0IGZ1bmN0aW9ucyBvbmx5IChjYWxsIGlnbm9yZWQpIik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRhc2tCeUlkWysrdGFza0lkXSA9IHsKICAgICAgICAgIGZuOiBmbiwKICAgICAgICAgIGFyZ3M6IGFycmF5RnJvbShhcmd1bWVudHMsIDEpCiAgICAgICAgfTsKICAgICAgICBhZGRUb1F1ZXVlKHRhc2tJZCk7CiAgICAgICAgcmV0dXJuIHRhc2tJZDsKICAgICAgfTsKICAgICAgY2xlYXJJbW1lZGlhdGUgPSBmdW5jdGlvbihpZCkgewogICAgICAgIGRlbGV0ZSB0YXNrQnlJZFtpZF07CiAgICAgIH07CiAgICAgIHJldHVybiBmdW5jdGlvbihpZCkgewogICAgICAgIHZhciB0YXNrID0gdGFza0J5SWRbaWRdOwogICAgICAgIGlmICh0YXNrKSB7CiAgICAgICAgICBkZWxldGUgdGFza0J5SWRbaWRdOwogICAgICAgICAgcmV0dXJuIHRhc2suZm4uYXBwbHkodW5kZWZpbmVkLCB0YXNrLmFyZ3MpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0oKTsKICAgIHZhciBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKSB7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgcnVuVGFzayh0YXNrSWQpOwogICAgICB9LCAwKTsKICAgIH07CiAgICBpZiAoZ2xvYmFsLnByb2Nlc3MgJiYgdHlwZW9mIHByb2Nlc3MubmV4dFRpY2sgPT0gImZ1bmN0aW9uIikgewogICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKSB7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgIHJ1blRhc2sodGFza0lkKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChnbG9iYWwuTWVzc2FnZUNoYW5uZWwpIHsKICAgICAgICB2YXIgY2hhbm5lbCA9IG5ldyBnbG9iYWwuTWVzc2FnZUNoYW5uZWw7CiAgICAgICAgY2hhbm5lbC5wb3J0MS5vbm1lc3NhZ2UgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgdmFyIHRhc2tJZCA9IGV2ZW50LmRhdGE7CiAgICAgICAgICBydW5UYXNrKHRhc2tJZCk7CiAgICAgICAgfTsKICAgICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKSB7CiAgICAgICAgICBjaGFubmVsLnBvcnQyLnBvc3RNZXNzYWdlKHRhc2tJZCk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcG9zdE1lc3NhZ2VTdXBwb3J0ZWQgPSBnbG9iYWwucG9zdE1lc3NhZ2UgJiYgIWdsb2JhbC5pbXBvcnRTY3JpcHRzOwogICAgICAgIGlmIChwb3N0TWVzc2FnZVN1cHBvcnRlZCkgewogICAgICAgICAgdmFyIG9sZE9uTWVzc2FnZSA9IGdsb2JhbC5vbm1lc3NhZ2U7CiAgICAgICAgICBnbG9iYWwub25tZXNzYWdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBvc3RNZXNzYWdlU3VwcG9ydGVkID0gZmFsc2U7CiAgICAgICAgICB9OwogICAgICAgICAgZ2xvYmFsLnBvc3RNZXNzYWdlKCIiLCAiKiIpOwogICAgICAgICAgZ2xvYmFsLm9ubWVzc2FnZSA9IG9sZE9uTWVzc2FnZTsKICAgICAgICB9CiAgICAgICAgaWYgKHBvc3RNZXNzYWdlU3VwcG9ydGVkKSB7CiAgICAgICAgICB2YXIgc2V0SW1tZWRpYXRlSGFuZGxlciA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudCAmJiBldmVudC5zb3VyY2UgPT0gZ2xvYmFsKSB7CiAgICAgICAgICAgICAgdmFyIHRhc2tJZCA9IFN0cmluZyhldmVudC5kYXRhKS5zcGxpdChNRVNTQUdFX05BTUUpWzFdOwogICAgICAgICAgICAgIGlmICh0YXNrSWQpIHJ1blRhc2sodGFza0lkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIGlmIChnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcikgZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBzZXRJbW1lZGlhdGVIYW5kbGVyLCB0cnVlKTsgZWxzZSBnbG9iYWwuYXR0YWNoRXZlbnQoIm9ubWVzc2FnZSIsIHNldEltbWVkaWF0ZUhhbmRsZXIpOwogICAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCkgewogICAgICAgICAgICBnbG9iYWwucG9zdE1lc3NhZ2UoTUVTU0FHRV9OQU1FICsgdGFza0lkLCAiKiIpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGNyZWF0ZVNjcmlwdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGRvY3VtZW50ICYmICJvbnJlYWR5c3RhdGVjaGFuZ2UiIGluIGNyZWF0ZVNjcmlwdCgpKSB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0QWRkVG9RdWV1ZSA9IGFkZFRvUXVldWU7CiAgICAgICAgICAgIGFkZFRvUXVldWUgPSBmdW5jdGlvbiBiZWZvcmVIZWFkUmVhZHkodGFza0lkKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudEludGVyZmFjZSAhPSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgYWRkVG9RdWV1ZSA9IGRlZmF1bHRBZGRUb1F1ZXVlOwogICAgICAgICAgICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5yZWFkeShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCkgewogICAgICAgICAgICAgICAgICAgIHZhciBzY3JpcHRFbCA9IGNyZWF0ZVNjcmlwdCgpOwogICAgICAgICAgICAgICAgICAgIHNjcmlwdEVsLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgc2NyaXB0RWwub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50SW50ZXJmYWNlLnJlbW92ZShzY3JpcHRFbCk7CiAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRFbCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBydW5UYXNrKHRhc2tJZCk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudEludGVyZmFjZS5oZWFkLmFkZChzY3JpcHRFbCk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGFkZFRvUXVldWUgPT09IGJlZm9yZUhlYWRSZWFkeSkgZGVmYXVsdEFkZFRvUXVldWUodGFza0lkKTsgZWxzZSBhZGRUb1F1ZXVlKHRhc2tJZCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSkoKTsKICB2YXIgTk9ERV9FTlYgPSB0eXBlb2YgcHJvY2VzcyA9PSAib2JqZWN0IiAmJiB0b1N0cmluZy5jYWxsKHByb2Nlc3MpID09ICJbb2JqZWN0IHByb2Nlc3NdIjsKICB2YXIgcGF0aFV0aWxzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgQUJTT0xVVEVfUlggPSAvXihbXlwvXSs6fFwvKS87CiAgICB2YXIgUFJPVE9DT0xfUlggPSAvXlthLXpBLVowLTlcLV0rOlwvPy87CiAgICB2YXIgT1JJR0lOX1JYID0gL14oPzpbYS16QS1aMC05XC1dKzopP1wvXC9bXlwvXStcLz8vOwogICAgdmFyIFNFQVJDSF9IQVNIX1JYID0gL1tcPyNdLiokLzsKICAgIHZhciBiYXNlVVJJOwogICAgdmFyIG9yaWdpbjsKICAgIHZhciB1dGlsczsKICAgIGlmIChOT0RFX0VOVikgewogICAgICB2YXIgcGF0aCA9IChwcm9jZXNzLmJhc2lzanNCYXNlVVJJIHx8IHJlcXVpcmUoInBhdGgiKS5yZXNvbHZlKCIuIikpLnJlcGxhY2UoL1xcL2csICIvIik7CiAgICAgIGJhc2VVUkkgPSBwYXRoLnJlcGxhY2UoL15bXlwvXSovLCAiIik7CiAgICAgIG9yaWdpbiA9IHBhdGgucmVwbGFjZSgvXC8uKi8sICIiKTsKICAgIH0gZWxzZSB7CiAgICAgIGJhc2VVUkkgPSBsb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSskLywgIiIpOwogICAgICBvcmlnaW4gPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0OwogICAgfQogICAgdXRpbHMgPSB7CiAgICAgIGJhc2VVUkk6IGJhc2VVUkksCiAgICAgIG9yaWdpbjogb3JpZ2luLAogICAgICBub3JtYWxpemU6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICBwYXRoID0gKHBhdGggfHwgIiIpLnJlcGxhY2UoUFJPVE9DT0xfUlgsICIvIikucmVwbGFjZShPUklHSU5fUlgsICIvIikucmVwbGFjZShTRUFSQ0hfSEFTSF9SWCwgIiIpOwogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCIvIik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHBhcnRzW2ldID09ICIuLiIpIHsKICAgICAgICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPiAxIHx8IHJlc3VsdFswXSkgcmVzdWx0LnBvcCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKChwYXJ0c1tpXSB8fCAhaSkgJiYgcGFydHNbaV0gIT0gIi4iKSByZXN1bHQucHVzaChwYXJ0c1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQuam9pbigiLyIpIHx8IChwYXRoWzBdID09PSAiLyIgPyAiLyIgOiAiIik7CiAgICAgIH0sCiAgICAgIGRpcm5hbWU6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gdXRpbHMubm9ybWFsaXplKHBhdGgpOwogICAgICAgIHJldHVybiByZXN1bHQucmVwbGFjZSgvXC8oW15cL10qKSR8XlteXC9dKyQvLCAiIikgfHwgKHJlc3VsdFswXSA9PSAiLyIgPyAiLyIgOiAiLiIpOwogICAgICB9LAogICAgICBleHRuYW1lOiBmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgdmFyIGV4dCA9IHV0aWxzLm5vcm1hbGl6ZShwYXRoKS5tYXRjaCgvW15cL10oXC5bXlwvXC5dKikkLyk7CiAgICAgICAgcmV0dXJuIGV4dCA/IGV4dFsxXSA6ICIiOwogICAgICB9LAogICAgICBiYXNlbmFtZTogZnVuY3Rpb24ocGF0aCwgZXh0KSB7CiAgICAgICAgdmFyIGZpbGVuYW1lID0gdXRpbHMubm9ybWFsaXplKHBhdGgpLm1hdGNoKC9bXlxcXC9dKiQvKTsKICAgICAgICBmaWxlbmFtZSA9IGZpbGVuYW1lID8gZmlsZW5hbWVbMF0gOiAiIjsKICAgICAgICBpZiAoZXh0ID09IHV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpKSBmaWxlbmFtZSA9IGZpbGVuYW1lLnN1YnN0cmluZygwLCBmaWxlbmFtZS5sZW5ndGggLSBleHQubGVuZ3RoKTsKICAgICAgICByZXR1cm4gZmlsZW5hbWU7CiAgICAgIH0sCiAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKGZyb20sIHRvKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBhcnJheUZyb20oYXJndW1lbnRzKS5yZXZlcnNlKCk7CiAgICAgICAgdmFyIHBhdGggPSBbXTsKICAgICAgICB2YXIgYWJzb2x1dGVGb3VuZCA9IGZhbHNlOwogICAgICAgIGZvciAodmFyIGkgPSAwOyAhYWJzb2x1dGVGb3VuZCAmJiBpIDwgYXJncy5sZW5ndGg7IGkrKykgaWYgKHR5cGVvZiBhcmdzW2ldID09ICJzdHJpbmciKSB7CiAgICAgICAgICBwYXRoLnVuc2hpZnQoYXJnc1tpXSk7CiAgICAgICAgICBhYnNvbHV0ZUZvdW5kID0gQUJTT0xVVEVfUlgudGVzdChhcmdzW2ldKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFhYnNvbHV0ZUZvdW5kKSBwYXRoLnVuc2hpZnQoYmFzZVVSSSA9PSAiLyIgPyAiIiA6IGJhc2VVUkkpOwogICAgICAgIHJldHVybiB1dGlscy5ub3JtYWxpemUocGF0aC5qb2luKCIvIikpOwogICAgICB9LAogICAgICByZWxhdGl2ZTogZnVuY3Rpb24oZnJvbSwgdG8pIHsKICAgICAgICBpZiAodHlwZW9mIHRvICE9ICJzdHJpbmciKSB7CiAgICAgICAgICB0byA9IGZyb207CiAgICAgICAgICBmcm9tID0gYmFzZVVSSTsKICAgICAgICB9CiAgICAgICAgZnJvbSA9IHV0aWxzLm5vcm1hbGl6ZShmcm9tKTsKICAgICAgICB0byA9IHV0aWxzLm5vcm1hbGl6ZSh0byk7CiAgICAgICAgaWYgKGZyb21bMF0gPT0gIi8iICYmIHRvWzBdICE9ICIvIikgcmV0dXJuIGZyb207CiAgICAgICAgaWYgKHRvWzBdID09ICIvIiAmJiBmcm9tWzBdICE9ICIvIikgcmV0dXJuIHRvOwogICAgICAgIHZhciBiYXNlID0gZnJvbS5yZXBsYWNlKC9eXC8kLywgIiIpLnNwbGl0KC9cLy8pOwogICAgICAgIHZhciBwYXRoID0gdG8ucmVwbGFjZSgvXlwvJC8sICIiKS5zcGxpdCgvXC8vKTsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIGkgPSAwOwogICAgICAgIHdoaWxlIChwYXRoW2ldID09IGJhc2VbaV0gJiYgdHlwZW9mIGJhc2VbaV0gPT0gInN0cmluZyIpIGkrKzsKICAgICAgICBmb3IgKHZhciBqID0gYmFzZS5sZW5ndGggLSBpOyBqID4gMDsgai0tKSByZXN1bHQucHVzaCgiLi4iKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNvbmNhdChwYXRoLnNsaWNlKGkpLmZpbHRlcihCb29sZWFuKSkuam9pbigiLyIpOwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIHV0aWxzOwogIH0oKTsKICB2YXIgYmFzaXNGaWxlbmFtZSA9IF9fYmFzaXNGaWxlbmFtZSB8fCAiIjsKICB2YXIgY29uZmlnID0gX19jb25maWcgfHwgewogICAgbm9Db25mbGljdDogdHJ1ZSwKICAgIG1vZHVsZXM6IHt9LAogICAgYXV0b2xvYWQ6IFsgIi4vMC5qcyIgXQogIH07CiAgZnVuY3Rpb24gZmV0Y2hDb25maWcoKSB7CiAgICB2YXIgY29uZmlnID0gX19jb25maWc7CiAgICBpZiAoIWNvbmZpZykgewogICAgICBpZiAoTk9ERV9FTlYpIHsKICAgICAgICBiYXNpc0ZpbGVuYW1lID0gX19maWxlbmFtZS5yZXBsYWNlKC9cXC9nLCAiLyIpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBzY3JpcHRzID0gZG9jdW1lbnQuc2NyaXB0czsKICAgICAgICBmb3IgKHZhciBpID0gMCwgc2NyaXB0RWw7IHNjcmlwdEVsID0gc2NyaXB0c1tpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgY29uZmlnQXR0clZhbHVlID0gc2NyaXB0RWwuaGFzQXR0cmlidXRlKCJiYXNpcy1jb25maWciKSA/IHNjcmlwdEVsLmdldEF0dHJpYnV0ZSgiYmFzaXMtY29uZmlnIikgOiBzY3JpcHRFbC5nZXRBdHRyaWJ1dGUoImRhdGEtYmFzaXMtY29uZmlnIik7CiAgICAgICAgICBzY3JpcHRFbC5yZW1vdmVBdHRyaWJ1dGUoImJhc2lzLWNvbmZpZyIpOwogICAgICAgICAgc2NyaXB0RWwucmVtb3ZlQXR0cmlidXRlKCJkYXRhLWJhc2lzLWNvbmZpZyIpOwogICAgICAgICAgaWYgKGNvbmZpZ0F0dHJWYWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBiYXNpc0ZpbGVuYW1lID0gcGF0aFV0aWxzLm5vcm1hbGl6ZShzY3JpcHRFbC5zcmMpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbmZpZyA9IEZ1bmN0aW9uKCJyZXR1cm57IiArIGNvbmZpZ0F0dHJWYWx1ZSArICJ9IikoKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIGNvbnNvbGVNZXRob2RzLmVycm9yKCJiYXNpcy1jb25maWc6IGJhc2lzLmpzIGNvbmZpZyBwYXJzZSBmYXVsdDogIiArIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHByb2Nlc3NDb25maWcoY29uZmlnKTsKICB9CiAgZnVuY3Rpb24gcHJvY2Vzc0NvbmZpZyhjb25maWcsIHZlcmJvc2UpIHsKICAgIGNvbmZpZyA9IHNsaWNlKGNvbmZpZyk7CiAgICBpZiAoImV4dFByb3RvIiBpbiBjb25maWcpIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLWNvbmZpZzogYGV4dFByb3RvYCBvcHRpb24gaW4gYmFzaXMtY29uZmlnIGlzIG5vdCBzdXBwb3J0IGFueW1vcmUiKTsKICAgIGlmICgicGF0aCIgaW4gY29uZmlnKSBjb25zb2xlTWV0aG9kcy53YXJuKCJiYXNpcy1jb25maWc6IGBwYXRoYCBvcHRpb24gaW4gYmFzaXMtY29uZmlnIGlzIGRlcHJlY2F0ZWQsIHVzZSBgbW9kdWxlc2AgaW5zdGVhZCIpOwogICAgdmFyIGF1dG9sb2FkID0gW107CiAgICB2YXIgbW9kdWxlcyA9IG1lcmdlKGNvbmZpZy5wYXRoLCBjb25maWcubW9kdWxlcywgewogICAgICBiYXNpczogYmFzaXNGaWxlbmFtZQogICAgfSk7CiAgICBjb25maWcubW9kdWxlcyA9IHt9OwogICAgaWYgKGNvbmZpZy5hdXRvbG9hZCkgewogICAgICB2YXIgbSA9IFN0cmluZyhjb25maWcuYXV0b2xvYWQpLm1hdGNoKC9eKCg/OlteXC9dKlwvKSopKFthLXokX11bYS16MC05JF9dKikoKD86XC5bYS16JF9dW2EtejAtOSRfXSopKikkL2kpOwogICAgICBpZiAobSkgewogICAgICAgIG1vZHVsZXNbbVsyXV0gPSB7CiAgICAgICAgICBhdXRvbG9hZDogdHJ1ZSwKICAgICAgICAgIGZpbGVuYW1lOiBtWzFdICsgbVsyXSArIChtWzNdIHx8ICIuanMiKQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMtY29uZmlnOiB3cm9uZyBgYXV0b2xvYWRgIHZhbHVlIChzZXR0aW5nIGlnbm9yZWQpOiAiICsgY29uZmlnLmF1dG9sb2FkKTsKICAgICAgfQogICAgICBkZWxldGUgY29uZmlnLmF1dG9sb2FkOwogICAgfQogICAgZm9yICh2YXIgbmFtZSBpbiBtb2R1bGVzKSB7CiAgICAgIHZhciBtb2R1bGUgPSBtb2R1bGVzW25hbWVdOwogICAgICBpZiAodHlwZW9mIG1vZHVsZSA9PSAic3RyaW5nIikgbW9kdWxlID0gewogICAgICAgIGZpbGVuYW1lOiBtb2R1bGUucmVwbGFjZSgvXC8kLywgIi8iICsgbmFtZSArICIuanMiKQogICAgICB9OwogICAgICB2YXIgZmlsZW5hbWUgPSBtb2R1bGUuZmlsZW5hbWU7CiAgICAgIHZhciBwYXRoID0gbW9kdWxlLnBhdGg7CiAgICAgIGlmIChmaWxlbmFtZSAmJiAhcGF0aCkgewogICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZmlsZW5hbWUpOwogICAgICAgIHBhdGggPSBmaWxlbmFtZS5zdWJzdHIoMCwgZmlsZW5hbWUubGVuZ3RoIC0gcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpLmxlbmd0aCk7CiAgICAgICAgZmlsZW5hbWUgPSAiLi4vIiArIHBhdGhVdGlscy5iYXNlbmFtZShmaWxlbmFtZSk7CiAgICAgIH0KICAgICAgcGF0aCA9IHBhdGhVdGlscy5yZXNvbHZlKHBhdGgpOwogICAgICBpZiAoIWZpbGVuYW1lICYmIHBhdGgpIHsKICAgICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5iYXNlbmFtZShwYXRoKTsKICAgICAgICBwYXRoID0gcGF0aFV0aWxzLmRpcm5hbWUocGF0aCk7CiAgICAgIH0KICAgICAgaWYgKCFwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkpIGZpbGVuYW1lICs9ICIuanMiOwogICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKHBhdGgsIGZpbGVuYW1lKTsKICAgICAgY29uZmlnLm1vZHVsZXNbbmFtZV0gPSB7CiAgICAgICAgcGF0aDogcGF0aCwKICAgICAgICBmaWxlbmFtZTogZmlsZW5hbWUKICAgICAgfTsKICAgICAgaWYgKG1vZHVsZS5hdXRvbG9hZCkgewogICAgICAgIGNvbmZpZy5hdXRvbG9hZCA9IGF1dG9sb2FkOwogICAgICAgIGF1dG9sb2FkLnB1c2gobmFtZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjb25maWc7CiAgfQogIHZhciBDbGFzcyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGluc3RhbmNlU2VlZCA9IHsKICAgICAgaWQ6IDEKICAgIH07CiAgICB2YXIgY2xhc3NTZWVkID0gMTsKICAgIHZhciBjbGFzc2VzID0gW107CiAgICB2YXIgU0VMRiA9IHt9OwogICAgZnVuY3Rpb24gaXNDbGFzcyhvYmplY3QpIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT0gImZ1bmN0aW9uIiAmJiAhIW9iamVjdC5iYXNpc0NsYXNzSWRfOwogICAgfQogICAgZnVuY3Rpb24gaXNTdWJjbGFzc09mKHN1cGVyQ2xhc3MpIHsKICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgIHdoaWxlIChjdXJzb3IgJiYgY3Vyc29yICE9PSBzdXBlckNsYXNzKSBjdXJzb3IgPSBjdXJzb3Iuc3VwZXJDbGFzc187CiAgICAgIHJldHVybiBjdXJzb3IgPT09IHN1cGVyQ2xhc3M7CiAgICB9CiAgICBmdW5jdGlvbiBkZXZWZXJib3NlTmFtZShuYW1lLCBhcmdzLCBmbikgewogICAgICByZXR1cm4gKG5ldyBGdW5jdGlvbihrZXlzKGFyZ3MpLCAncmV0dXJuIHsiJyArIG5hbWUgKyAnIjogJyArIGZuICsgJ1xufVsiJyArIG5hbWUgKyAnIl0nKSkuYXBwbHkobnVsbCwgdmFsdWVzKGFyZ3MpKTsKICAgIH0KICAgIHZhciBUT1NUUklOR19CVUcgPSBmdW5jdGlvbigpIHsKICAgICAgZm9yICh2YXIga2V5IGluIHsKICAgICAgICB0b1N0cmluZzogMQogICAgICB9KSByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSgpOwogICAgZnVuY3Rpb24gY3JlYXRlQ2xhc3MoU3VwZXJDbGFzcywgZXh0ZW5zaW9ucykgewogICAgICB2YXIgY2xhc3NJZCA9IGNsYXNzU2VlZCsrOwogICAgICBpZiAodHlwZW9mIFN1cGVyQ2xhc3MgIT0gImZ1bmN0aW9uIikgU3VwZXJDbGFzcyA9IEJhc2VDbGFzczsKICAgICAgdmFyIGNsYXNzTmFtZSA9ICIiOwogICAgICBmb3IgKHZhciBpID0gMSwgZXh0ZW5zaW9uOyBleHRlbnNpb24gPSBhcmd1bWVudHNbaV07IGkrKykgaWYgKHR5cGVvZiBleHRlbnNpb24gIT0gImZ1bmN0aW9uIiAmJiBleHRlbnNpb24uY2xhc3NOYW1lKSBjbGFzc05hbWUgPSBleHRlbnNpb24uY2xhc3NOYW1lOwogICAgICBpZiAoIWNsYXNzTmFtZSkgY2xhc3NOYW1lID0gU3VwZXJDbGFzcy5jbGFzc05hbWUgKyAiLl9DbGFzcyIgKyBjbGFzc0lkOwogICAgICB2YXIgTmV3Q2xhc3NQcm90byA9IGZ1bmN0aW9uKCkge307CiAgICAgIE5ld0NsYXNzUHJvdG8gPSBkZXZWZXJib3NlTmFtZShjbGFzc05hbWUsIHt9LCBOZXdDbGFzc1Byb3RvKTsKICAgICAgTmV3Q2xhc3NQcm90by5wcm90b3R5cGUgPSBTdXBlckNsYXNzLnByb3RvdHlwZTsKICAgICAgdmFyIG5ld1Byb3RvID0gbmV3IE5ld0NsYXNzUHJvdG87CiAgICAgIHZhciBuZXdDbGFzc1Byb3BzID0gewogICAgICAgIGNsYXNzTmFtZTogY2xhc3NOYW1lLAogICAgICAgIGJhc2lzQ2xhc3NJZF86IGNsYXNzSWQsCiAgICAgICAgc3VwZXJDbGFzc186IFN1cGVyQ2xhc3MsCiAgICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiAhIVN1cGVyQ2xhc3MuZXh0ZW5kQ29uc3RydWN0b3JfLAogICAgICAgIGlzU3ViY2xhc3NPZjogaXNTdWJjbGFzc09mLAogICAgICAgIHN1YmNsYXNzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVDbGFzcy5hcHBseShudWxsLCBbIG5ld0NsYXNzIF0uY29uY2F0KGFycmF5RnJvbShhcmd1bWVudHMpKSk7CiAgICAgICAgfSwKICAgICAgICBleHRlbmQ6IGV4dGVuZENsYXNzLAogICAgICAgIF9fZXh0ZW5kX186IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUgIT09IFNFTEYgJiYgKHR5cGVvZiB2YWx1ZSA9PSAib2JqZWN0IiB8fCB0eXBlb2YgdmFsdWUgPT0gImZ1bmN0aW9uIiAmJiAhaXNDbGFzcyh2YWx1ZSkpKSByZXR1cm4gQmFzZUNsYXNzLmNyZWF0ZS5jYWxsKG51bGwsIG5ld0NsYXNzLCB2YWx1ZSk7IGVsc2UgcmV0dXJuIHZhbHVlOwogICAgICAgIH0sCiAgICAgICAgcHJvdG90eXBlOiBuZXdQcm90bwogICAgICB9OwogICAgICBmb3IgKHZhciBpID0gMSwgZXh0ZW5zaW9uOyBleHRlbnNpb24gPSBhcmd1bWVudHNbaV07IGkrKykgbmV3Q2xhc3NQcm9wcy5leHRlbmQoZXh0ZW5zaW9uKTsKICAgICAgaWYgKG5ld1Byb3RvLmluaXQgIT09IEJhc2VDbGFzcy5wcm90b3R5cGUuaW5pdCAmJiAhL15mdW5jdGlvblteKF0qXChcKS8udGVzdChuZXdQcm90by5pbml0KSAmJiBuZXdDbGFzc1Byb3BzLmV4dGVuZENvbnN0cnVjdG9yXykgY29uc29sZU1ldGhvZHMud2FybigicHJvYmFibHkgd3JvbmcgZXh0ZW5kQ29uc3RydWN0b3JfIHZhbHVlIGZvciAiICsgbmV3Q2xhc3NQcm9wcy5jbGFzc05hbWUpOwogICAgICB2YXIgbmV3Q2xhc3MgPSBuZXdDbGFzc1Byb3BzLmV4dGVuZENvbnN0cnVjdG9yXyA/IGZ1bmN0aW9uKGV4dGVuZCkgewogICAgICAgIHRoaXMuYmFzaXNPYmplY3RJZCA9IGluc3RhbmNlU2VlZC5pZCsrOwogICAgICAgIHZhciBwcm9wOwogICAgICAgIGZvciAodmFyIGtleSBpbiBleHRlbmQpIHsKICAgICAgICAgIHByb3AgPSB0aGlzW2tleV07CiAgICAgICAgICB0aGlzW2tleV0gPSBwcm9wICYmIHByb3AuX19leHRlbmRfXyA/IHByb3AuX19leHRlbmRfXyhleHRlbmRba2V5XSkgOiBleHRlbmRba2V5XTsKICAgICAgICB9CiAgICAgICAgdGhpcy5pbml0KCk7CiAgICAgICAgdGhpcy5wb3N0SW5pdCgpOwogICAgICB9IDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5iYXNpc09iamVjdElkID0gaW5zdGFuY2VTZWVkLmlkKys7CiAgICAgICAgdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgdGhpcy5wb3N0SW5pdCgpOwogICAgICB9OwogICAgICBuZXdDbGFzcyA9IGRldlZlcmJvc2VOYW1lKGNsYXNzTmFtZSwgewogICAgICAgIGluc3RhbmNlU2VlZDogaW5zdGFuY2VTZWVkCiAgICAgIH0sIG5ld0NsYXNzKTsKICAgICAgbmV3UHJvdG8uY29uc3RydWN0b3IgPSBuZXdDbGFzczsKICAgICAgZm9yICh2YXIga2V5IGluIG5ld1Byb3RvKSBpZiAobmV3UHJvdG9ba2V5XSA9PT0gU0VMRikgbmV3UHJvdG9ba2V5XSA9IG5ld0NsYXNzOwogICAgICBleHRlbmQobmV3Q2xhc3MsIG5ld0NsYXNzUHJvcHMpOwogICAgICBjbGFzc2VzLnB1c2gobmV3Q2xhc3MpOwogICAgICByZXR1cm4gbmV3Q2xhc3M7CiAgICB9CiAgICBmdW5jdGlvbiBleHRlbmRDbGFzcyhzb3VyY2UpIHsKICAgICAgdmFyIHByb3RvID0gdGhpcy5wcm90b3R5cGU7CiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJmdW5jdGlvbiIgJiYgIWlzQ2xhc3Moc291cmNlKSkgc291cmNlID0gc291cmNlKHRoaXMuc3VwZXJDbGFzc18ucHJvdG90eXBlLCBzbGljZShwcm90bykpOwogICAgICBpZiAoc291cmNlLnByb3RvdHlwZSkgc291cmNlID0gc291cmNlLnByb3RvdHlwZTsKICAgICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkgewogICAgICAgIHZhciB2YWx1ZSA9IHNvdXJjZVtrZXldOwogICAgICAgIHZhciBwcm90b1ZhbHVlID0gcHJvdG9ba2V5XTsKICAgICAgICBpZiAoa2V5ID09ICJjbGFzc05hbWUiIHx8IGtleSA9PSAiZXh0ZW5kQ29uc3RydWN0b3JfIikgdGhpc1trZXldID0gdmFsdWU7IGVsc2UgewogICAgICAgICAgaWYgKHByb3RvVmFsdWUgJiYgcHJvdG9WYWx1ZS5fX2V4dGVuZF9fKSBwcm90b1trZXldID0gcHJvdG9WYWx1ZS5fX2V4dGVuZF9fKHZhbHVlKTsgZWxzZSB7CiAgICAgICAgICAgIHByb3RvW2tleV0gPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKFRPU1RSSU5HX0JVRyAmJiBzb3VyY2Vba2V5ID0gInRvU3RyaW5nIl0gIT09IHRvU3RyaW5nKSBwcm90b1trZXldID0gc291cmNlW2tleV07CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgdmFyIEJhc2VDbGFzcyA9IGV4dGVuZChjcmVhdGVDbGFzcywgewogICAgICBjbGFzc05hbWU6ICJiYXNpcy5DbGFzcyIsCiAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogZmFsc2UsCiAgICAgIHByb3RvdHlwZTogewogICAgICAgIGJhc2lzT2JqZWN0SWQ6IDAsCiAgICAgICAgY29uc3RydWN0b3I6IG51bGwsCiAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7fSwKICAgICAgICBwb3N0SW5pdDogZnVuY3Rpb24oKSB7fSwKICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gIltvYmplY3QgIiArICh0aGlzLmNvbnN0cnVjdG9yIHx8IHRoaXMpLmNsYXNzTmFtZSArICJdIjsKICAgICAgICB9LAogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiB0aGlzKSBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCBwcm9wKSkgdGhpc1twcm9wXSA9IG51bGw7CiAgICAgICAgICB0aGlzLmRlc3Ryb3kgPSAkdW5kZWY7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHZhciBjdXN0b21FeHRlbmRQcm9wZXJ0eSA9IGZ1bmN0aW9uKGV4dGVuc2lvbiwgZm4sIGRldk5hbWUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbihleHRlbnNpb24pIHsKICAgICAgICAgIGlmICghZXh0ZW5zaW9uKSByZXR1cm4gZXh0ZW5zaW9uOwogICAgICAgICAgaWYgKGV4dGVuc2lvbiAmJiBleHRlbnNpb24uX19leHRlbmRfXykgcmV0dXJuIGV4dGVuc2lvbjsKICAgICAgICAgIHZhciBCYXNlID0gZnVuY3Rpb24oKSB7fTsKICAgICAgICAgIEJhc2UgPSBkZXZWZXJib3NlTmFtZShkZXZOYW1lIHx8ICJjdXN0b21FeHRlbmRQcm9wZXJ0eSIsIHt9LCBCYXNlKTsKICAgICAgICAgIEJhc2UucHJvdG90eXBlID0gdGhpczsKICAgICAgICAgIHZhciByZXN1bHQgPSBuZXcgQmFzZTsKICAgICAgICAgIGZuKHJlc3VsdCwgZXh0ZW5zaW9uKTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICB9Ll9fZXh0ZW5kX18oZXh0ZW5zaW9uIHx8IHt9KTsKICAgIH07CiAgICB2YXIgZXh0ZW5zaWJsZVByb3BlcnR5ID0gZnVuY3Rpb24oZXh0ZW5zaW9uKSB7CiAgICAgIHJldHVybiBjdXN0b21FeHRlbmRQcm9wZXJ0eShleHRlbnNpb24sIGV4dGVuZCwgImV4dGVuc2libGVQcm9wZXJ0eSIpOwogICAgfTsKICAgIHZhciBuZXN0ZWRFeHRlbmRQcm9wZXJ0eSA9IGZ1bmN0aW9uKGV4dGVuc2lvbikgewogICAgICByZXR1cm4gY3VzdG9tRXh0ZW5kUHJvcGVydHkoZXh0ZW5zaW9uLCBmdW5jdGlvbihyZXN1bHQsIGV4dGVuc2lvbikgewogICAgICAgIGZvciAodmFyIGtleSBpbiBleHRlbnNpb24pIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHJlc3VsdFtrZXldOwogICAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZSAmJiB2YWx1ZS5fX2V4dGVuZF9fID8gdmFsdWUuX19leHRlbmRfXyhleHRlbnNpb25ba2V5XSkgOiBleHRlbnNpYmxlUHJvcGVydHkoZXh0ZW5zaW9uW2tleV0pOwogICAgICAgIH0KICAgICAgfSwgIm5lc3RlZEV4dGVuZFByb3BlcnR5Iik7CiAgICB9OwogICAgdmFyIG9uZUZ1bmN0aW9uUHJvcGVydHkgPSBmdW5jdGlvbihmbiwga2V5cykgewogICAgICB2YXIgY3JlYXRlID0gZnVuY3Rpb24oa2V5cykgewogICAgICAgIHZhciByZXN1bHQgPSB7CiAgICAgICAgICBfX2V4dGVuZF9fOiBjcmVhdGUKICAgICAgICB9OwogICAgICAgIGlmIChrZXlzKSB7CiAgICAgICAgICBpZiAoa2V5cy5fX2V4dGVuZF9fKSByZXR1cm4ga2V5czsKICAgICAgICAgIHZhciBDbHMgPSBkZXZWZXJib3NlTmFtZSgib25lRnVuY3Rpb25Qcm9wZXJ0eSIsIHt9LCBmdW5jdGlvbigpIHt9KTsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDbHM7CiAgICAgICAgICByZXN1bHQuX19leHRlbmRfXyA9IGNyZWF0ZTsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBrZXlzKSBpZiAoa2V5c1trZXldKSByZXN1bHRba2V5XSA9IGZuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICByZXR1cm4gY3JlYXRlKGtleXMgfHwge30pOwogICAgfTsKICAgIHJldHVybiBleHRlbmQoQmFzZUNsYXNzLCB7CiAgICAgIGFsbF86IGNsYXNzZXMsCiAgICAgIFNFTEY6IFNFTEYsCiAgICAgIGNyZWF0ZTogY3JlYXRlQ2xhc3MsCiAgICAgIGlzQ2xhc3M6IGlzQ2xhc3MsCiAgICAgIGN1c3RvbUV4dGVuZFByb3BlcnR5OiBjdXN0b21FeHRlbmRQcm9wZXJ0eSwKICAgICAgZXh0ZW5zaWJsZVByb3BlcnR5OiBleHRlbnNpYmxlUHJvcGVydHksCiAgICAgIG5lc3RlZEV4dGVuZFByb3BlcnR5OiBuZXN0ZWRFeHRlbmRQcm9wZXJ0eSwKICAgICAgb25lRnVuY3Rpb25Qcm9wZXJ0eTogb25lRnVuY3Rpb25Qcm9wZXJ0eQogICAgfSk7CiAgfSgpOwogIHZhciBUb2tlbiA9IENsYXNzKG51bGwsIHsKICAgIGNsYXNzTmFtZTogImJhc2lzLlRva2VuIiwKICAgIHZhbHVlOiBudWxsLAogICAgaGFuZGxlcjogbnVsbCwKICAgIGRlZmVycmVkVG9rZW46IG51bGwsCiAgICBiaW5kaW5nQnJpZGdlOiB7CiAgICAgIGF0dGFjaDogZnVuY3Rpb24oaG9zdCwgZm4sIGNvbnRleHQpIHsKICAgICAgICBob3N0LmF0dGFjaChmbiwgY29udGV4dCk7CiAgICAgIH0sCiAgICAgIGRldGFjaDogZnVuY3Rpb24oaG9zdCwgZm4sIGNvbnRleHQpIHsKICAgICAgICBob3N0LmRldGFjaChmbiwgY29udGV4dCk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oaG9zdCkgewogICAgICAgIHJldHVybiBob3N0LmdldCgpOwogICAgICB9CiAgICB9LAogICAgaW5pdDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgfSwKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgfQogICAgfSwKICAgIGF0dGFjaDogZnVuY3Rpb24oZm4sIGNvbnRleHQpIHsKICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgaWYgKGN1cnNvci5mbiA9PT0gZm4gJiYgY3Vyc29yLmNvbnRleHQgPT09IGNvbnRleHQpIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLlRva2VuI2F0dGFjaDogZHVwbGljYXRlIGZuICYgY29udGV4dCBwYWlyIik7CiAgICAgIHRoaXMuaGFuZGxlciA9IHsKICAgICAgICBmbjogZm4sCiAgICAgICAgY29udGV4dDogY29udGV4dCwKICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIKICAgICAgfTsKICAgIH0sCiAgICBkZXRhY2g6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB2YXIgcHJldjsKICAgICAgd2hpbGUgKHByZXYgPSBjdXJzb3IsIGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKSBpZiAoY3Vyc29yLmZuID09PSBmbiAmJiBjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgIGN1cnNvci5mbiA9ICR1bmRlZjsKICAgICAgICBwcmV2LmhhbmRsZXIgPSBjdXJzb3IuaGFuZGxlcjsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMuVG9rZW4jZGV0YWNoOiBmbiAmIGNvbnRleHQgcGFpciBub3QgZm91bmQsIG5vdGhpbmcgd2FzIHJlbW92ZWQiKTsKICAgIH0sCiAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2YWx1ZSA9IHRoaXMuZ2V0KCk7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpIGN1cnNvci5mbi5jYWxsKGN1cnNvci5jb250ZXh0LCB2YWx1ZSk7CiAgICB9LAogICAgZGVmZXJyZWQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdG9rZW4gPSB0aGlzLmRlZmVycmVkVG9rZW47CiAgICAgIGlmICghdG9rZW4pIHsKICAgICAgICB0b2tlbiA9IHRoaXMuZGVmZXJyZWRUb2tlbiA9IG5ldyBEZWZlcnJlZFRva2VuKHRoaXMudmFsdWUpOwogICAgICAgIHRoaXMuYXR0YWNoKHRva2VuLnNldCwgdG9rZW4pOwogICAgICB9CiAgICAgIHJldHVybiB0b2tlbjsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuZGVmZXJyZWRUb2tlbikgewogICAgICAgIHRoaXMuZGVmZXJyZWRUb2tlbi5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5kZWZlcnJlZFRva2VuID0gbnVsbDsKICAgICAgfQogICAgICB0aGlzLmhhbmRsZXIgPSBudWxsOwogICAgICB0aGlzLnZhbHVlID0gbnVsbDsKICAgICAgdGhpcy5hdHRhY2ggPSAkdW5kZWY7CiAgICAgIHRoaXMuZGV0YWNoID0gJHVuZGVmOwogICAgfQogIH0pOwogIHZhciBhd2FpdFRvQXBwbHkgPSBmdW5jdGlvbigpIHsKICAgIHZhciB0b2tlbnMgPSB7fTsKICAgIHZhciB0aW1lcjsKICAgIGZ1bmN0aW9uIGFwcGx5VG9rZW5zKCkgewogICAgICB2YXIgbGlzdCA9IHRva2VuczsKICAgICAgdG9rZW5zID0ge307CiAgICAgIHRpbWVyID0gbnVsbDsKICAgICAgZm9yICh2YXIga2V5IGluIGxpc3QpIGxpc3Rba2V5XS5hcHBseSgpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgIGlmICh0b2tlbi5iYXNpc09iamVjdElkIGluIHRva2VucykgcmV0dXJuOwogICAgICB0b2tlbnNbdG9rZW4uYmFzaXNPYmplY3RJZF0gPSB0b2tlbjsKICAgICAgaWYgKCF0aW1lcikgc2V0SW1tZWRpYXRlKGFwcGx5VG9rZW5zKTsKICAgIH07CiAgfSgpOwogIHZhciBEZWZlcnJlZFRva2VuID0gVG9rZW4uc3ViY2xhc3MoewogICAgY2xhc3NOYW1lOiAiYmFzaXMuRGVmZXJyZWRUb2tlbiIsCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICBhd2FpdFRvQXBwbHkodGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICBkZWZlcnJlZDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0pOwogIHZhciByZXNvdXJjZXMgPSB7fTsKICB2YXIgcmVzb3VyY2VDb250ZW50Q2FjaGUgPSB7fTsKICB2YXIgcmVzb3VyY2VQYXRjaCA9IHt9OwogIHZhciB2aXJ0dWFsUmVzb3VyY2VTZWVkID0gMTsKICB2YXIgcmVzb3VyY2VSZXNvbHZpbmdTdGFjayA9IFtdOwogIHZhciByZXF1aXJlczsKICAoZnVuY3Rpb24oKSB7CiAgICB2YXIgbWFwID0gdHlwZW9mIF9fcmVzb3VyY2VzX18gIT0gInVuZGVmaW5lZCIgPyBfX3Jlc291cmNlc19fIDogbnVsbDsKICAgIGlmIChtYXApIHsKICAgICAgZm9yICh2YXIga2V5IGluIG1hcCkgcmVzb3VyY2VDb250ZW50Q2FjaGVbcGF0aFV0aWxzLnJlc29sdmUoa2V5KV0gPSBtYXBba2V5XTsKICAgIH0KICB9KSgpOwogIGZ1bmN0aW9uIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKSB7CiAgICB2YXIgcGF0Y2hlcyA9IHJlc291cmNlUGF0Y2hbcmVzb3VyY2UudXJsXTsKICAgIGlmIChwYXRjaGVzKSBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc29sZU1ldGhvZHMuaW5mbygiQXBwbHkgcGF0Y2ggZm9yICIgKyByZXNvdXJjZS51cmwpOwogICAgICBwYXRjaGVzW2ldKHJlc291cmNlLmdldCgpLCByZXNvdXJjZS51cmwpOwogICAgfQogIH0KICB2YXIgZ2V0UmVzb3VyY2VDb250ZW50ID0gZnVuY3Rpb24odXJsLCBpZ25vcmVDYWNoZSkgewogICAgaWYgKGlnbm9yZUNhY2hlIHx8ICFyZXNvdXJjZUNvbnRlbnRDYWNoZS5oYXNPd25Qcm9wZXJ0eSh1cmwpKSB7CiAgICAgIHZhciByZXNvdXJjZUNvbnRlbnQgPSAiIjsKICAgICAgaWYgKCFOT0RFX0VOVikgewogICAgICAgIHZhciByZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3Q7CiAgICAgICAgcmVxLm9wZW4oIkdFVCIsIHVybCwgZmFsc2UpOwogICAgICAgIHJlcS5zZXRSZXF1ZXN0SGVhZGVyKCJJZi1Nb2RpZmllZC1TaW5jZSIsIChuZXcgRGF0ZSgwKSkudG9HTVRTdHJpbmcoKSk7CiAgICAgICAgcmVxLnNldFJlcXVlc3RIZWFkZXIoIlgtQmFzaXMtUmVzb3VyY2UiLCAxKTsKICAgICAgICByZXEuc2VuZCgiIik7CiAgICAgICAgaWYgKHJlcS5zdGF0dXMgPj0gMjAwICYmIHJlcS5zdGF0dXMgPCA0MDApIHJlc291cmNlQ29udGVudCA9IHJlcS5yZXNwb25zZVRleHQ7IGVsc2UgewogICAgICAgICAgY29uc29sZU1ldGhvZHMuZXJyb3IoImJhc2lzLnJlc291cmNlOiBVbmFibGUgdG8gbG9hZCAiICsgdXJsICsgIiAoc3RhdHVzIGNvZGUgIiArIHJlcS5zdGF0dXMgKyAiKSIpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0cnkgewogICAgICAgICAgcmVzb3VyY2VDb250ZW50ID0gcHJvY2Vzcy5iYXNpc2pzUmVhZEZpbGUgPyBwcm9jZXNzLmJhc2lzanNSZWFkRmlsZSh1cmwpIDogcmVxdWlyZSgiZnMiKS5yZWFkRmlsZVN5bmModXJsLCAidXRmLTgiKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25zb2xlTWV0aG9kcy5lcnJvcigiYmFzaXMucmVzb3VyY2U6IFVuYWJsZSB0byBsb2FkICIgKyB1cmwsIGUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXNvdXJjZUNvbnRlbnRDYWNoZVt1cmxdID0gcmVzb3VyY2VDb250ZW50OwogICAgfQogICAgcmV0dXJuIHJlc291cmNlQ29udGVudENhY2hlW3VybF07CiAgfTsKICB2YXIgY3JlYXRlUmVzb3VyY2UgPSBmdW5jdGlvbihyZXNvdXJjZVVybCwgY29udGVudCkgewogICAgdmFyIGNvbnRlbnRUeXBlID0gcGF0aFV0aWxzLmV4dG5hbWUocmVzb3VyY2VVcmwpOwogICAgdmFyIGNvbnRlbnRXcmFwcGVyID0gZ2V0UmVzb3VyY2UuZXh0ZW5zaW9uc1tjb250ZW50VHlwZV07CiAgICB2YXIgaXNWaXJ0dWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDE7CiAgICB2YXIgcmVzb2x2ZWQgPSBmYWxzZTsKICAgIHZhciB3cmFwcGVkID0gZmFsc2U7CiAgICB2YXIgd3JhcHBlZENvbnRlbnQ7CiAgICBpZiAoaXNWaXJ0dWFsKSByZXNvdXJjZVVybCArPSAiI3ZpcnR1YWwiOwogICAgdmFyIHJlc291cmNlID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChyZXNvbHZlZCkgcmV0dXJuIGNvbnRlbnQ7CiAgICAgIHZhciB1cmxDb250ZW50ID0gaXNWaXJ0dWFsID8gY29udGVudCA6IGdldFJlc291cmNlQ29udGVudChyZXNvdXJjZVVybCk7CiAgICAgIHZhciBpZHggPSByZXNvdXJjZVJlc29sdmluZ1N0YWNrLmluZGV4T2YocmVzb3VyY2VVcmwpOwogICAgICBpZiAoaWR4ICE9IC0xKSBjb25zb2xlTWV0aG9kcy53YXJuKCJiYXNpcy5yZXNvdXJjZSByZWN1cnNpb246IiwgcmVzb3VyY2VSZXNvbHZpbmdTdGFjay5zbGljZShpZHgpLmNvbmNhdChyZXNvdXJjZVVybCkubWFwKHBhdGhVdGlscy5yZWxhdGl2ZSwgcGF0aFV0aWxzKS5qb2luKCIgLT4gIikpOwogICAgICByZXNvdXJjZVJlc29sdmluZ1N0YWNrLnB1c2gocmVzb3VyY2VVcmwpOwogICAgICBpZiAoY29udGVudFdyYXBwZXIpIHsKICAgICAgICBpZiAoIXdyYXBwZWQpIHsKICAgICAgICAgIHdyYXBwZWQgPSB0cnVlOwogICAgICAgICAgY29udGVudCA9IGNvbnRlbnRXcmFwcGVyKHVybENvbnRlbnQsIHJlc291cmNlVXJsKTsKICAgICAgICAgIHdyYXBwZWRDb250ZW50ID0gdXJsQ29udGVudDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29udGVudCA9IHVybENvbnRlbnQ7CiAgICAgIH0KICAgICAgcmVzb2x2ZWQgPSB0cnVlOwogICAgICBhcHBseVJlc291cmNlUGF0Y2hlcyhyZXNvdXJjZSk7CiAgICAgIHJlc291cmNlLmFwcGx5KCk7CiAgICAgIHJlc291cmNlUmVzb2x2aW5nU3RhY2sucG9wKCk7CiAgICAgIHJldHVybiBjb250ZW50OwogICAgfTsKICAgIGV4dGVuZChyZXNvdXJjZSwgZXh0ZW5kKG5ldyBUb2tlbiwgewogICAgICB1cmw6IHJlc291cmNlVXJsLAogICAgICB0eXBlOiBjb250ZW50VHlwZSwKICAgICAgdmlydHVhbDogaXNWaXJ0dWFsLAogICAgICBmZXRjaDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHJlc291cmNlKCk7CiAgICAgIH0sCiAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gIltiYXNpcy5yZXNvdXJjZSAiICsgcmVzb3VyY2VVcmwgKyAiXSI7CiAgICAgIH0sCiAgICAgIGlzUmVzb2x2ZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgICAgfSwKICAgICAgaGFzQ2hhbmdlczogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGNvbnRlbnRXcmFwcGVyID8gcmVzb3VyY2VDb250ZW50Q2FjaGVbcmVzb3VyY2VVcmxdICE9PSB3cmFwcGVkQ29udGVudCA6IGZhbHNlOwogICAgICB9LAogICAgICB1cGRhdGU6IGZ1bmN0aW9uKG5ld0NvbnRlbnQpIHsKICAgICAgICBpZiAoIXJlc29sdmVkIHx8IGlzVmlydHVhbCB8fCBuZXdDb250ZW50ICE9IHJlc291cmNlQ29udGVudENhY2hlW3Jlc291cmNlVXJsXSkgewogICAgICAgICAgaWYgKCFpc1ZpcnR1YWwpIHJlc291cmNlQ29udGVudENhY2hlW3Jlc291cmNlVXJsXSA9IG5ld0NvbnRlbnQ7CiAgICAgICAgICBpZiAoY29udGVudFdyYXBwZXIpIHsKICAgICAgICAgICAgaWYgKCF3cmFwcGVkICYmIGlzVmlydHVhbCkgY29udGVudCA9IG5ld0NvbnRlbnQ7CiAgICAgICAgICAgIGlmICh3cmFwcGVkICYmICFjb250ZW50V3JhcHBlci5wZXJtYW5lbnQpIHsKICAgICAgICAgICAgICBjb250ZW50ID0gY29udGVudFdyYXBwZXIobmV3Q29udGVudCwgcmVzb3VyY2VVcmwsIGNvbnRlbnQpOwogICAgICAgICAgICAgIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKTsKICAgICAgICAgICAgICByZXNvdXJjZS5hcHBseSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250ZW50ID0gbmV3Q29udGVudDsKICAgICAgICAgICAgcmVzb2x2ZWQgPSB0cnVlOwogICAgICAgICAgICBhcHBseVJlc291cmNlUGF0Y2hlcyhyZXNvdXJjZSk7CiAgICAgICAgICAgIHJlc291cmNlLmFwcGx5KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICByZWxvYWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChpc1ZpcnR1YWwpIHJldHVybjsKICAgICAgICB2YXIgb2xkQ29udGVudCA9IHJlc291cmNlQ29udGVudENhY2hlW3Jlc291cmNlVXJsXTsKICAgICAgICB2YXIgbmV3Q29udGVudCA9IGdldFJlc291cmNlQ29udGVudChyZXNvdXJjZVVybCwgdHJ1ZSk7CiAgICAgICAgaWYgKG5ld0NvbnRlbnQgIT0gb2xkQ29udGVudCkgewogICAgICAgICAgcmVzb2x2ZWQgPSBmYWxzZTsKICAgICAgICAgIHJlc291cmNlLnVwZGF0ZShuZXdDb250ZW50KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgaWYgKGlzVmlydHVhbCkgaWYgKHNvdXJjZSkgcmV0dXJuIGNvbnRlbnRXcmFwcGVyID8gd3JhcHBlZENvbnRlbnQgOiBjb250ZW50OwogICAgICAgIHJldHVybiBzb3VyY2UgPyBnZXRSZXNvdXJjZUNvbnRlbnQocmVzb3VyY2VVcmwpIDogcmVzb3VyY2UoKTsKICAgICAgfSwKICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKHJlc29sdmVkKSB7CiAgICAgICAgICBmbi5jYWxsKGNvbnRleHQsIHJlc291cmNlKCkpOwogICAgICAgICAgaWYgKGNvbnRlbnRXcmFwcGVyICYmIGNvbnRlbnRXcmFwcGVyLnBlcm1hbmVudCkgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXNvdXJjZS5hdHRhY2goZm4sIGNvbnRleHQpOwogICAgICAgIHJldHVybiByZXNvdXJjZTsKICAgICAgfQogICAgfSkpOwogICAgcmVzb3VyY2VzW3Jlc291cmNlVXJsXSA9IHJlc291cmNlOwogICAgcmV0dXJuIHJlc291cmNlOwogIH07CiAgdmFyIGdldFJlc291cmNlID0gZnVuY3Rpb24ocmVzb3VyY2VVcmwpIHsKICAgIHZhciByZXNvdXJjZSA9IHJlc291cmNlc1tyZXNvdXJjZVVybF07CiAgICBpZiAocmVzb3VyY2UpIHJldHVybiByZXNvdXJjZTsKICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChyZXNvdXJjZVVybCkpIGNvbnNvbGVNZXRob2RzLndhcm4oIkJhZCB1c2FnZTogYmFzaXMucmVzb3VyY2UoJyIgKyByZXNvdXJjZVVybCArICInKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuIik7CiAgICByZXNvdXJjZVVybCA9IHBhdGhVdGlscy5yZXNvbHZlKHJlc291cmNlVXJsKTsKICAgIHJlc291cmNlID0gcmVzb3VyY2VzW3Jlc291cmNlVXJsXTsKICAgIHJldHVybiByZXNvdXJjZSB8fCBjcmVhdGVSZXNvdXJjZShyZXNvdXJjZVVybCk7CiAgfTsKICBleHRlbmQoZ2V0UmVzb3VyY2UsIHsKICAgIGlzUmVzb3VyY2U6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSA/IHJlc291cmNlc1t2YWx1ZS51cmxdID09PSB2YWx1ZSA6IGZhbHNlOwogICAgfSwKICAgIGlzUmVzb2x2ZWQ6IGZ1bmN0aW9uKHJlc291cmNlVXJsKSB7CiAgICAgIHZhciByZXNvdXJjZSA9IGdldFJlc291cmNlLmdldChyZXNvdXJjZVVybCk7CiAgICAgIHJldHVybiByZXNvdXJjZSA/IHJlc291cmNlLmlzUmVzb2x2ZWQoKSA6IGZhbHNlOwogICAgfSwKICAgIGV4aXN0czogZnVuY3Rpb24ocmVzb3VyY2VVcmwpIHsKICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHJlc291cmNlVXJsKSkgY29uc29sZU1ldGhvZHMud2FybigiQmFkIHVzYWdlOiBiYXNpcy5yZXNvdXJjZS5leGlzdHMoJyIgKyByZXNvdXJjZVVybCArICInKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuIik7CiAgICAgIHJldHVybiByZXNvdXJjZXMuaGFzT3duUHJvcGVydHkocGF0aFV0aWxzLnJlc29sdmUocmVzb3VyY2VVcmwpKTsKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uKHJlc291cmNlVXJsKSB7CiAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChyZXNvdXJjZVVybCkpIGNvbnNvbGVNZXRob2RzLndhcm4oIkJhZCB1c2FnZTogYmFzaXMucmVzb3VyY2UuZ2V0KCciICsgcmVzb3VyY2VVcmwgKyAiJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLiIpOwogICAgICByZXNvdXJjZVVybCA9IHBhdGhVdGlscy5yZXNvbHZlKHJlc291cmNlVXJsKTsKICAgICAgaWYgKCFnZXRSZXNvdXJjZS5leGlzdHMocmVzb3VyY2VVcmwpKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIGdldFJlc291cmNlKHJlc291cmNlVXJsKTsKICAgIH0sCiAgICBnZXRGaWxlczogZnVuY3Rpb24oY2FjaGUpIHsKICAgICAgcmV0dXJuIGtleXMoY2FjaGUgPyByZXNvdXJjZUNvbnRlbnRDYWNoZSA6IHJlc291cmNlcykubWFwKHBhdGhVdGlscy5yZWxhdGl2ZSk7CiAgICB9LAogICAgdmlydHVhbDogZnVuY3Rpb24odHlwZSwgY29udGVudCwgb3duZXJVcmwpIHsKICAgICAgcmV0dXJuIGNyZWF0ZVJlc291cmNlKChvd25lclVybCA/IG93bmVyVXJsICsgIjoiIDogcGF0aFV0aWxzLm5vcm1hbGl6ZShwYXRoVXRpbHMuYmFzZVVSSSA9PSAiLyIgPyAiIiA6IHBhdGhVdGlscy5iYXNlVVJJKSArICIvIikgKyAidmlydHVhbC1yZXNvdXJjZSIgKyB2aXJ0dWFsUmVzb3VyY2VTZWVkKysgKyAiLiIgKyB0eXBlLCBjb250ZW50KTsKICAgIH0sCiAgICBleHRlbnNpb25zOiB7CiAgICAgICIuanMiOiBleHRlbmQoZnVuY3Rpb24oY29udGVudCwgZmlsZW5hbWUpIHsKICAgICAgICB2YXIgbmFtZXNwYWNlID0gZmlsZW5hbWUybmFtZXNwYWNlW2ZpbGVuYW1lXTsKICAgICAgICBpZiAoIW5hbWVzcGFjZSkgewogICAgICAgICAgdmFyIGltcGxpY2l0TmFtZXNwYWNlID0gdHJ1ZTsKICAgICAgICAgIHZhciByZXNvbHZlZEZpbGVuYW1lID0gcGF0aFV0aWxzLmRpcm5hbWUoZmlsZW5hbWUpICsgIi8iICsgcGF0aFV0aWxzLmJhc2VuYW1lKGZpbGVuYW1lLCBwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkpOwogICAgICAgICAgZm9yICh2YXIgbnMgaW4gbnNSb290UGF0aCkgewogICAgICAgICAgICB2YXIgcGF0aCA9IG5zUm9vdFBhdGhbbnNdICsgbnMgKyAiLyI7CiAgICAgICAgICAgIGlmIChyZXNvbHZlZEZpbGVuYW1lLnN1YnN0cigwLCBwYXRoLmxlbmd0aCkgPT0gcGF0aCkgewogICAgICAgICAgICAgIGltcGxpY2l0TmFtZXNwYWNlID0gZmFsc2U7CiAgICAgICAgICAgICAgcmVzb2x2ZWRGaWxlbmFtZSA9IHJlc29sdmVkRmlsZW5hbWUuc3Vic3RyKG5zUm9vdFBhdGhbbnNdLmxlbmd0aCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5hbWVzcGFjZSA9IHJlc29sdmVkRmlsZW5hbWUucmVwbGFjZSgvXC4vZywgIl8iKS5yZXBsYWNlKC9eXC8vZywgIiIpLnJlcGxhY2UoL1wvL2csICIuIik7CiAgICAgICAgICBpZiAoaW1wbGljaXROYW1lc3BhY2UpIG5hbWVzcGFjZSA9ICJpbXBsaWNpdC4iICsgbmFtZXNwYWNlOwogICAgICAgIH0KICAgICAgICBpZiAocmVxdWlyZXMpIGFycmF5RnVuY3Rpb25zLmFkZChyZXF1aXJlcywgbmFtZXNwYWNlKTsKICAgICAgICBpZiAoIW5hbWVzcGFjZXNbbmFtZXNwYWNlXSkgewogICAgICAgICAgdmFyIG5zID0gZ2V0TmFtZXNwYWNlKG5hbWVzcGFjZSk7CiAgICAgICAgICB2YXIgc2F2ZWRSZXF1aXJlcyA9IHJlcXVpcmVzOwogICAgICAgICAgcmVxdWlyZXMgPSBbXTsKICAgICAgICAgIG5zLmV4cG9ydHMgPSBydW5TY3JpcHRJbkNvbnRleHQoewogICAgICAgICAgICBwYXRoOiBucy5wYXRoLAogICAgICAgICAgICBleHBvcnRzOiBucy5leHBvcnRzCiAgICAgICAgICB9LCBmaWxlbmFtZSwgY29udGVudCkuZXhwb3J0czsKICAgICAgICAgIGlmIChucy5leHBvcnRzICYmIG5zLmV4cG9ydHMuY29uc3RydWN0b3IgPT09IE9iamVjdCkgY29tcGxldGUobnMsIG5zLmV4cG9ydHMpOwogICAgICAgICAgbnMuZmlsZW5hbWVfID0gZmlsZW5hbWU7CiAgICAgICAgICBucy5zb3VyY2VfID0gY29udGVudDsKICAgICAgICAgIG5zLnJlcXVpcmVzXyA9IHJlcXVpcmVzOwogICAgICAgICAgcmVxdWlyZXMgPSBzYXZlZFJlcXVpcmVzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmFtZXNwYWNlc1tuYW1lc3BhY2VdLmV4cG9ydHM7CiAgICAgIH0sIHsKICAgICAgICBwZXJtYW5lbnQ6IHRydWUKICAgICAgfSksCiAgICAgICIuY3NzIjogZnVuY3Rpb24oY29udGVudCwgdXJsLCBjc3NSZXNvdXJjZSkgewogICAgICAgIGlmICghY3NzUmVzb3VyY2UpIGNzc1Jlc291cmNlID0gbmV3IENzc1Jlc291cmNlKHVybCk7CiAgICAgICAgY3NzUmVzb3VyY2UudXBkYXRlQ3NzVGV4dChjb250ZW50KTsKICAgICAgICByZXR1cm4gY3NzUmVzb3VyY2U7CiAgICAgIH0sCiAgICAgICIuanNvbiI6IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCkgewogICAgICAgIGlmICh0eXBlb2YgY29udGVudCA9PSAib2JqZWN0IikgcmV0dXJuIGNvbnRlbnQ7CiAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICB0cnkgewogICAgICAgICAgY29udGVudCA9IFN0cmluZyhjb250ZW50KTsKICAgICAgICAgIHJlc3VsdCA9IGJhc2lzLmpzb24ucGFyc2UoY29udGVudCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMucmVzb3VyY2U6IENhbid0IHBhcnNlIEpTT04gZnJvbSAiICsgdXJsLCB7CiAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICBjb250ZW50OiBjb250ZW50CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdCB8fCBudWxsOwogICAgICB9CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gY29tcGlsZUZ1bmN0aW9uKHNvdXJjZVVSTCwgYXJncywgYm9keSkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbihhcmdzLCBib2R5ICsgIlxuXG4vLyMgc291cmNlVVJMPSIgKyBwYXRoVXRpbHMub3JpZ2luICsgc291cmNlVVJMKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaWYgKGRvY3VtZW50ICYmICJsaW5lIiBpbiBlID09IGZhbHNlICYmICJhZGRFdmVudExpc3RlbmVyIiBpbiBnbG9iYWwpIHsKICAgICAgICBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBmdW5jdGlvbiBvbmVycm9yKGV2ZW50KSB7CiAgICAgICAgICBpZiAoZXZlbnQuZmlsZW5hbWUgPT0gcGF0aFV0aWxzLm9yaWdpbiArIHNvdXJjZVVSTCkgewogICAgICAgICAgICBnbG9iYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBvbmVycm9yKTsKICAgICAgICAgICAgY29uc29sZU1ldGhvZHMuZXJyb3IoIkNvbXBpbGF0aW9uIGVycm9yIGF0ICIgKyBldmVudC5maWxlbmFtZSArICI6IiArIGV2ZW50LmxpbmVubyArICI6ICIgKyBlKTsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LnNyYyA9IHNvdXJjZVVSTDsKICAgICAgICBzY3JpcHQuYXN5bmMgPSBmYWxzZTsKICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICAgICAgZG9jdW1lbnQuaGVhZC5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICB9CiAgICAgIGNvbnNvbGVNZXRob2RzLmVycm9yKCJDb21waWxhdGlvbiBlcnJvciBhdCAiICsgc291cmNlVVJMICsgKCJsaW5lIiBpbiBlID8gIjoiICsgKGUubGluZSAtIDEpIDogIiIpICsgIjogIiArIGUpOwogICAgfQogIH0KICB2YXIgcnVuU2NyaXB0SW5Db250ZXh0ID0gZnVuY3Rpb24oY29udGV4dCwgc291cmNlVVJMLCBzb3VyY2VDb2RlKSB7CiAgICB2YXIgYmFzZVVSTCA9IHBhdGhVdGlscy5kaXJuYW1lKHNvdXJjZVVSTCkgKyAiLyI7CiAgICB2YXIgY29tcGlsZWRTb3VyY2VDb2RlID0gc291cmNlQ29kZTsKICAgIGlmICghY29udGV4dC5leHBvcnRzKSBjb250ZXh0LmV4cG9ydHMgPSB7fTsKICAgIGlmICh0eXBlb2YgY29tcGlsZWRTb3VyY2VDb2RlICE9ICJmdW5jdGlvbiIpIGNvbXBpbGVkU291cmNlQ29kZSA9IGNvbXBpbGVGdW5jdGlvbihzb3VyY2VVUkwsIFsgImV4cG9ydHMiLCAibW9kdWxlIiwgImJhc2lzIiwgImdsb2JhbCIsICJfX2ZpbGVuYW1lIiwgIl9fZGlybmFtZSIsICJyZXNvdXJjZSIsICJyZXF1aXJlIiBdLCAnInVzZSBzdHJpY3QiO1xuJyArIHNvdXJjZUNvZGUpOwogICAgaWYgKHR5cGVvZiBjb21waWxlZFNvdXJjZUNvZGUgPT0gImZ1bmN0aW9uIikgY29tcGlsZWRTb3VyY2VDb2RlLmNhbGwoY29udGV4dC5leHBvcnRzLCBjb250ZXh0LmV4cG9ydHMsIGNvbnRleHQsIGJhc2lzLCBnbG9iYWwsIHNvdXJjZVVSTCwgYmFzZVVSTCwgZnVuY3Rpb24ocmVsYXRpdmVQYXRoKSB7CiAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChyZWxhdGl2ZVBhdGgpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IHJlc291cmNlKCciICsgcmVsYXRpdmVQYXRoICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgICAgcmV0dXJuIGdldFJlc291cmNlKHBhdGhVdGlscy5yZXNvbHZlKGJhc2VVUkwsIHJlbGF0aXZlUGF0aCkpOwogICAgfSwgZnVuY3Rpb24ocmVsYXRpdmVQYXRoLCBiYXNlKSB7CiAgICAgIHJldHVybiByZXF1aXJlTmFtZXNwYWNlKHJlbGF0aXZlUGF0aCwgYmFzZSB8fCBiYXNlVVJMKTsKICAgIH0pOwogICAgcmV0dXJuIGNvbnRleHQ7CiAgfTsKICB2YXIgbmFtZXNwYWNlcyA9IHt9OwogIHZhciBuYW1lc3BhY2UyZmlsZW5hbWUgPSB7fTsKICB2YXIgZmlsZW5hbWUybmFtZXNwYWNlID0ge307CiAgdmFyIG5zUm9vdFBhdGggPSB7fTsKICBpdGVyYXRlKGNvbmZpZy5tb2R1bGVzLCBmdW5jdGlvbihuYW1lLCBtb2R1bGUpIHsKICAgIG5zUm9vdFBhdGhbbmFtZV0gPSBtb2R1bGUucGF0aCArICIvIjsKICAgIG5hbWVzcGFjZTJmaWxlbmFtZVtuYW1lXSA9IG1vZHVsZS5maWxlbmFtZTsKICAgIGZpbGVuYW1lMm5hbWVzcGFjZVttb2R1bGUuZmlsZW5hbWVdID0gbmFtZTsKICB9KTsKICAoZnVuY3Rpb24obWFwKSB7CiAgICB2YXIgbWFwID0gdHlwZW9mIF9fbmFtZXNwYWNlX21hcF9fICE9ICJ1bmRlZmluZWQiID8gX19uYW1lc3BhY2VfbWFwX18gOiBudWxsOwogICAgaWYgKG1hcCkgewogICAgICBmb3IgKHZhciBrZXkgaW4gbWFwKSB7CiAgICAgICAgdmFyIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoa2V5KTsKICAgICAgICB2YXIgbmFtZXNwYWNlID0gbWFwW2tleV07CiAgICAgICAgZmlsZW5hbWUybmFtZXNwYWNlW2ZpbGVuYW1lXSA9IG5hbWVzcGFjZTsKICAgICAgICBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZXNwYWNlXSA9IGZpbGVuYW1lOwogICAgICB9CiAgICB9CiAgfSkoKTsKICB2YXIgTmFtZXNwYWNlID0gQ2xhc3MobnVsbCwgewogICAgY2xhc3NOYW1lOiAiYmFzaXMuTmFtZXNwYWNlIiwKICAgIGluaXQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgdGhpcy5leHBvcnRzID0gewogICAgICAgIHBhdGg6IHRoaXMubmFtZQogICAgICB9OwogICAgfSwKICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICJbYmFzaXMubmFtZXNwYWNlICIgKyB0aGlzLnBhdGggKyAiXSI7CiAgICB9LAogICAgZXh0ZW5kOiBmdW5jdGlvbihuYW1lcykgewogICAgICBleHRlbmQodGhpcy5leHBvcnRzLCBuYW1lcyk7CiAgICAgIHJldHVybiBjb21wbGV0ZSh0aGlzLCBuYW1lcyk7CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gcmVzb2x2ZU5TRmlsZW5hbWUobmFtZXNwYWNlKSB7CiAgICBpZiAobmFtZXNwYWNlIGluIG5hbWVzcGFjZTJmaWxlbmFtZSA9PSBmYWxzZSkgewogICAgICB2YXIgcGFydHMgPSBuYW1lc3BhY2Uuc3BsaXQoIi4iKTsKICAgICAgdmFyIG5hbWVzcGFjZVJvb3QgPSBwYXJ0cy5zaGlmdCgpOwogICAgICB2YXIgZmlsZW5hbWUgPSBwYXJ0cy5qb2luKCIvIikgKyAiLmpzIjsKICAgICAgaWYgKG5hbWVzcGFjZVJvb3QgaW4gbnNSb290UGF0aCA9PSBmYWxzZSkgbnNSb290UGF0aFtuYW1lc3BhY2VSb290XSA9IHBhdGhVdGlscy5iYXNlVVJJICsgbmFtZXNwYWNlUm9vdCArICIvIjsKICAgICAgaWYgKG5hbWVzcGFjZVJvb3QgPT0gbmFtZXNwYWNlKSBmaWxlbmFtZSA9IG5zUm9vdFBhdGhbbmFtZXNwYWNlUm9vdF0ucmVwbGFjZSgvXC8kLywgIiIpICsgIi5qcyI7IGVsc2UgZmlsZW5hbWUgPSBuc1Jvb3RQYXRoW25hbWVzcGFjZVJvb3RdICsgZmlsZW5hbWU7CiAgICAgIG5hbWVzcGFjZTJmaWxlbmFtZVtuYW1lc3BhY2VdID0gZmlsZW5hbWU7CiAgICAgIGZpbGVuYW1lMm5hbWVzcGFjZVtmaWxlbmFtZV0gPSBuYW1lc3BhY2U7CiAgICB9CiAgICByZXR1cm4gbmFtZXNwYWNlMmZpbGVuYW1lW25hbWVzcGFjZV07CiAgfQogIGZ1bmN0aW9uIGdldFJvb3ROYW1lc3BhY2UobmFtZSkgewogICAgdmFyIG5hbWVzcGFjZSA9IG5hbWVzcGFjZXNbbmFtZV07CiAgICBpZiAoIW5hbWVzcGFjZSkgewogICAgICBuYW1lc3BhY2UgPSBuYW1lc3BhY2VzW25hbWVdID0gbmV3IE5hbWVzcGFjZShuYW1lKTsKICAgICAgbmFtZXNwYWNlLm5hbWVzcGFjZXNfID0ge307CiAgICAgIG5hbWVzcGFjZS5uYW1lc3BhY2VzX1tuYW1lXSA9IG5hbWVzcGFjZTsKICAgICAgaWYgKCFjb25maWcubm9Db25mbGljdCkgZ2xvYmFsW25hbWVdID0gbmFtZXNwYWNlOwogICAgfQogICAgaWYgKG5hbWUgPT0gImxpYnJhcnkiICYmICFsaWJyYXJ5KSBsaWJyYXJ5ID0gbmFtZXNwYWNlc1tuYW1lXTsKICAgIHJldHVybiBuYW1lc3BhY2U7CiAgfQogIGZ1bmN0aW9uIGdldE5hbWVzcGFjZShwYXRoKSB7CiAgICBwYXRoID0gcGF0aC5zcGxpdCgiLiIpOwogICAgdmFyIHJvb3ROcyA9IGdldFJvb3ROYW1lc3BhY2UocGF0aFswXSk7CiAgICB2YXIgY3Vyc29yID0gcm9vdE5zOwogICAgZm9yICh2YXIgaSA9IDEsIG5hbWU7IG5hbWUgPSBwYXRoW2ldOyBpKyspIHsKICAgICAgaWYgKCFjdXJzb3JbbmFtZV0pIHsKICAgICAgICB2YXIgbnNwYXRoID0gcGF0aC5zbGljZSgwLCBpICsgMSkuam9pbigiLiIpOwogICAgICAgIGN1cnNvcltuYW1lXSA9IG5ldyBOYW1lc3BhY2UobnNwYXRoKTsKICAgICAgICByb290TnMubmFtZXNwYWNlc19bbnNwYXRoXSA9IGN1cnNvcltuYW1lXTsKICAgICAgfQogICAgICBjdXJzb3IgPSBjdXJzb3JbbmFtZV07CiAgICB9CiAgICBuYW1lc3BhY2VzW3BhdGguam9pbigiLiIpXSA9IGN1cnNvcjsKICAgIHJldHVybiBjdXJzb3I7CiAgfQogIHZhciByZXF1aXJlTmFtZXNwYWNlID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoTk9ERV9FTlYpIHsKICAgICAgdmFyIG1vZHVsZVByb3RvID0gbW9kdWxlLmNvbnN0cnVjdG9yLnByb3RvdHlwZTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZpbGVuYW1lLCBkaXJuYW1lKSB7CiAgICAgICAgaWYgKCEvW15hLXowLTlfXC5dL2kudGVzdChmaWxlbmFtZSkgfHwgcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpID09ICIuanMiKSB7CiAgICAgICAgICB2YXIgX2NvbXBpbGUgPSBtb2R1bGVQcm90by5fY29tcGlsZTsKICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBnZXROYW1lc3BhY2UoZmlsZW5hbWUpOwogICAgICAgICAgbW9kdWxlUHJvdG8uX2NvbXBpbGUgPSBmdW5jdGlvbihjb250ZW50LCBmaWxlbmFtZSkgewogICAgICAgICAgICB0aGlzLmJhc2lzID0gYmFzaXM7CiAgICAgICAgICAgIGNvbnRlbnQgPSAidmFyIF9fbm9kZWpzUmVxdWlyZSA9IHJlcXVpcmU7XG4iICsgInZhciBiYXNpcyA9IG1vZHVsZS5iYXNpcztcbiIgKyAndmFyIHJlc291cmNlID0gZnVuY3Rpb24oZmlsZW5hbWUpeyByZXR1cm4gYmFzaXMucmVzb3VyY2UoX19kaXJuYW1lICsgIi8iICsgZmlsZW5hbWUpIH07XG4nICsgInZhciByZXF1aXJlID0gZnVuY3Rpb24oZmlsZW5hbWUsIGJhc2VVUkkpeyByZXR1cm4gYmFzaXMucmVxdWlyZShmaWxlbmFtZSwgYmFzZVVSSSB8fCBfX2Rpcm5hbWUpIH07XG4iICsgY29udGVudDsKICAgICAgICAgICAgX2NvbXBpbGUuY2FsbChleHRlbmQodGhpcywgbmFtZXNwYWNlKSwgY29udGVudCwgZmlsZW5hbWUpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBleHBvcnRzID0gcmVxdWlyZShfX2Rpcm5hbWUgKyAiLyIgKyBmaWxlbmFtZS5yZXBsYWNlKC9cLi9nLCAiLyIpKTsKICAgICAgICAgIG5hbWVzcGFjZS5leHBvcnRzID0gZXhwb3J0czsKICAgICAgICAgIGlmIChleHBvcnRzICYmIGV4cG9ydHMuY29uc3RydWN0b3IgPT09IE9iamVjdCkgY29tcGxldGUobmFtZXNwYWNlLCBleHBvcnRzKTsKICAgICAgICAgIG1vZHVsZVByb3RvLl9jb21waWxlID0gX2NvbXBpbGU7CiAgICAgICAgICByZXR1cm4gZXhwb3J0czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZmlsZW5hbWUgPSBwYXRoVXRpbHMucmVzb2x2ZShkaXJuYW1lLCBmaWxlbmFtZSk7CiAgICAgICAgICByZXR1cm4gcmVxdWlyZShmaWxlbmFtZSk7CiAgICAgICAgfQogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZpbGVuYW1lLCBkaXJuYW1lKSB7CiAgICAgICAgaWYgKCEvW15hLXowLTlfXC5dL2kudGVzdChmaWxlbmFtZSkgJiYgcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpICE9ICIuanMiKSB7CiAgICAgICAgICBmaWxlbmFtZSA9IHJlc29sdmVOU0ZpbGVuYW1lKGZpbGVuYW1lKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KGZpbGVuYW1lKSkgY29uc29sZU1ldGhvZHMud2FybigiQmFkIHVzYWdlOiByZXF1aXJlKCciICsgZmlsZW5hbWUgKyAiJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLiIpOwogICAgICAgICAgZmlsZW5hbWUgPSBwYXRoVXRpbHMucmVzb2x2ZShkaXJuYW1lLCBmaWxlbmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXRSZXNvdXJjZShmaWxlbmFtZSkuZmV0Y2goKTsKICAgICAgfTsKICAgIH0KICB9KCk7CiAgZnVuY3Rpb24gcGF0Y2goZmlsZW5hbWUsIHBhdGNoRm4pIHsKICAgIGlmICghL1teYS16MC05X1wuXS9pLnRlc3QoZmlsZW5hbWUpICYmIHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSAhPSAiLmpzIikgewogICAgICBmaWxlbmFtZSA9IHJlc29sdmVOU0ZpbGVuYW1lKGZpbGVuYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChmaWxlbmFtZSkpIGNvbnNvbGVNZXRob2RzLndhcm4oIkJhZCB1c2FnZTogYmFzaXMucGF0Y2goJyIgKyBmaWxlbmFtZSArICInKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuIik7CiAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZmlsZW5hbWUpOwogICAgfQogICAgaWYgKCFyZXNvdXJjZVBhdGNoW2ZpbGVuYW1lXSkgcmVzb3VyY2VQYXRjaFtmaWxlbmFtZV0gPSBbIHBhdGNoRm4gXTsgZWxzZSByZXNvdXJjZVBhdGNoW2ZpbGVuYW1lXS5wdXNoKHBhdGNoRm4pOwogICAgdmFyIHJlc291cmNlID0gZ2V0UmVzb3VyY2UuZ2V0KGZpbGVuYW1lKTsKICAgIGlmIChyZXNvdXJjZSAmJiByZXNvdXJjZS5pc1Jlc29sdmVkKCkpIHBhdGNoRm4ocmVzb3VyY2UuZ2V0KCksIHJlc291cmNlLnVybCk7CiAgfQogIGNvbXBsZXRlKEZ1bmN0aW9uLnByb3RvdHlwZSwgewogICAgYmluZDogZnVuY3Rpb24odGhpc09iamVjdCkgewogICAgICB2YXIgZm4gPSB0aGlzOwogICAgICB2YXIgcGFyYW1zID0gYXJyYXlGcm9tKGFyZ3VtZW50cywgMSk7CiAgICAgIHJldHVybiBwYXJhbXMubGVuZ3RoID8gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXNPYmplY3QsIHBhcmFtcy5jb25jYXQuYXBwbHkocGFyYW1zLCBhcmd1bWVudHMpKTsKICAgICAgfSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzT2JqZWN0LCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogIH0pOwogIGNvbXBsZXRlKEFycmF5LCB7CiAgICBpc0FycmF5OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICJbb2JqZWN0IEFycmF5XSI7CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gYXJyYXlGcm9tKG9iamVjdCwgb2Zmc2V0KSB7CiAgICBpZiAob2JqZWN0ICE9IG51bGwpIHsKICAgICAgdmFyIGxlbiA9IG9iamVjdC5sZW5ndGg7CiAgICAgIGlmICh0eXBlb2YgbGVuID09ICJ1bmRlZmluZWQiIHx8IHRvU3RyaW5nLmNhbGwob2JqZWN0KSA9PSAiW29iamVjdCBGdW5jdGlvbl0iKSByZXR1cm4gWyBvYmplY3QgXTsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDA7CiAgICAgIGlmIChsZW4gLSBvZmZzZXQgPiAwKSB7CiAgICAgICAgZm9yICh2YXIgcmVzdWx0ID0gW10sIGsgPSAwLCBpID0gb2Zmc2V0OyBpIDwgbGVuOyApIHJlc3VsdFtrKytdID0gb2JqZWN0W2krK107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIFtdOwogIH0KICBmdW5jdGlvbiBjcmVhdGVBcnJheShsZW5ndGgsIGZpbGxWYWx1ZSwgdGhpc09iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgdmFyIGlzRnVuYyA9IHR5cGVvZiBmaWxsVmFsdWUgPT0gImZ1bmN0aW9uIjsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHJlc3VsdFtpXSA9IGlzRnVuYyA/IGZpbGxWYWx1ZS5jYWxsKHRoaXNPYmplY3QsIGksIHJlc3VsdCkgOiBmaWxsVmFsdWU7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBjb21wbGV0ZShBcnJheS5wcm90b3R5cGUsIHsKICAgIGluZGV4T2Y6IGZ1bmN0aW9uKHNlYXJjaEVsZW1lbnQsIG9mZnNldCkgewogICAgICBvZmZzZXQgPSBwYXJzZUludChvZmZzZXQsIDEwKSB8fCAwOwogICAgICBpZiAob2Zmc2V0IDwgMCkgcmV0dXJuIC0xOwogICAgICBmb3IgKDsgb2Zmc2V0IDwgdGhpcy5sZW5ndGg7IG9mZnNldCsrKSBpZiAodGhpc1tvZmZzZXRdID09PSBzZWFyY2hFbGVtZW50KSByZXR1cm4gb2Zmc2V0OwogICAgICByZXR1cm4gLTE7CiAgICB9LAogICAgbGFzdEluZGV4T2Y6IGZ1bmN0aW9uKHNlYXJjaEVsZW1lbnQsIG9mZnNldCkgewogICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGg7CiAgICAgIG9mZnNldCA9IHBhcnNlSW50KG9mZnNldCwgMTApOwogICAgICBpZiAoaXNOYU4ob2Zmc2V0KSB8fCBvZmZzZXQgPj0gbGVuKSBvZmZzZXQgPSBsZW4gLSAxOyBlbHNlIG9mZnNldCA9IChvZmZzZXQgKyBsZW4pICUgbGVuOwogICAgICBmb3IgKDsgb2Zmc2V0ID49IDA7IG9mZnNldC0tKSBpZiAodGhpc1tvZmZzZXRdID09PSBzZWFyY2hFbGVtZW50KSByZXR1cm4gb2Zmc2V0OwogICAgICByZXR1cm4gLTE7CiAgICB9LAogICAgZm9yRWFjaDogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIGlmIChpIGluIHRoaXMpIGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcyk7CiAgICB9LAogICAgZXZlcnk6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSBpZiAoaSBpbiB0aGlzICYmICFjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIHNvbWU6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSBpZiAoaSBpbiB0aGlzICYmIGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiB0cnVlOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbihjYWxsYmFjaywgdGhpc09iamVjdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSBpZiAoaSBpbiB0aGlzICYmIGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcykpIHJlc3VsdC5wdXNoKHRoaXNbaV0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKICAgIG1hcDogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgaWYgKGkgaW4gdGhpcykgcmVzdWx0W2ldID0gY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCiAgICByZWR1Y2U6IGZ1bmN0aW9uKGNhbGxiYWNrLCBpbml0aWFsVmFsdWUpIHsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICB2YXIgYXJnc0xlbiA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICAgIGlmIChsZW4gPT0gMCAmJiBhcmdzTGVuID09IDEpIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICAgIHZhciByZXN1bHQ7CiAgICAgIHZhciBpbml0ZWQgPSAwOwogICAgICBpZiAoYXJnc0xlbiA+IDEpIHsKICAgICAgICByZXN1bHQgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgaW5pdGVkID0gMTsKICAgICAgfQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSBpZiAoaSBpbiB0aGlzKSBpZiAoaW5pdGVkKyspIHJlc3VsdCA9IGNhbGxiYWNrLmNhbGwobnVsbCwgcmVzdWx0LCB0aGlzW2ldLCBpLCB0aGlzKTsgZWxzZSByZXN1bHQgPSB0aGlzW2ldOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH0pOwogIHZhciBhcnJheUZ1bmN0aW9ucyA9IHsKICAgIGZyb206IGFycmF5RnJvbSwKICAgIGNyZWF0ZTogY3JlYXRlQXJyYXksCiAgICBmbGF0dGVuOiBmdW5jdGlvbih0aGlzXykgewogICAgICByZXR1cm4gdGhpc18uY29uY2F0LmFwcGx5KFtdLCB0aGlzXyk7CiAgICB9LAogICAgcmVwZWF0OiBmdW5jdGlvbih0aGlzXywgY291bnQpIHsKICAgICAgcmV0dXJuIGFycmF5RnVuY3Rpb25zLmZsYXR0ZW4oY3JlYXRlQXJyYXkocGFyc2VJbnQoY291bnQsIDEwKSB8fCAwLCB0aGlzXykpOwogICAgfSwKICAgIHNlYXJjaDogZnVuY3Rpb24odGhpc18sIHZhbHVlLCBnZXR0ZXJfLCBvZmZzZXQpIHsKICAgICAgdGhpc18ubGFzdFNlYXJjaEluZGV4ID0gLTE7CiAgICAgIGdldHRlcl8gPSBnZXR0ZXIoZ2V0dGVyXyB8fCAkc2VsZik7CiAgICAgIGZvciAodmFyIGluZGV4ID0gcGFyc2VJbnQob2Zmc2V0LCAxMCkgfHwgMCwgbGVuID0gdGhpc18ubGVuZ3RoOyBpbmRleCA8IGxlbjsgaW5kZXgrKykgaWYgKGdldHRlcl8odGhpc19baW5kZXhdKSA9PT0gdmFsdWUpIHJldHVybiB0aGlzX1t0aGlzXy5sYXN0U2VhcmNoSW5kZXggPSBpbmRleF07CiAgICB9LAogICAgbGFzdFNlYXJjaDogZnVuY3Rpb24odGhpc18sIHZhbHVlLCBnZXR0ZXJfLCBvZmZzZXQpIHsKICAgICAgdGhpc18ubGFzdFNlYXJjaEluZGV4ID0gLTE7CiAgICAgIGdldHRlcl8gPSBnZXR0ZXIoZ2V0dGVyXyB8fCAkc2VsZik7CiAgICAgIHZhciBsZW4gPSB0aGlzXy5sZW5ndGg7CiAgICAgIHZhciBpbmRleCA9IGlzTmFOKG9mZnNldCkgfHwgb2Zmc2V0ID09IG51bGwgPyBsZW4gOiBwYXJzZUludChvZmZzZXQsIDEwKTsKICAgICAgZm9yICh2YXIgaSA9IGluZGV4ID4gbGVuID8gbGVuIDogaW5kZXg7IGktLSA+IDA7ICkgaWYgKGdldHRlcl8odGhpc19baV0pID09PSB2YWx1ZSkgcmV0dXJuIHRoaXNfW3RoaXNfLmxhc3RTZWFyY2hJbmRleCA9IGldOwogICAgfSwKICAgIGFkZDogZnVuY3Rpb24odGhpc18sIHZhbHVlKSB7CiAgICAgIHJldHVybiB0aGlzXy5pbmRleE9mKHZhbHVlKSA9PSAtMSAmJiAhIXRoaXNfLnB1c2godmFsdWUpOwogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24odGhpc18sIHZhbHVlKSB7CiAgICAgIHZhciBpbmRleCA9IHRoaXNfLmluZGV4T2YodmFsdWUpOwogICAgICByZXR1cm4gaW5kZXggIT0gLTEgJiYgISF0aGlzXy5zcGxpY2UoaW5kZXgsIDEpOwogICAgfSwKICAgIGhhczogZnVuY3Rpb24odGhpc18sIHZhbHVlKSB7CiAgICAgIHJldHVybiB0aGlzXy5pbmRleE9mKHZhbHVlKSAhPSAtMTsKICAgIH0sCiAgICBzb3J0QXNPYmplY3Q6IGZ1bmN0aW9uKCkgewogICAgICBjb25zb2xlTWV0aG9kcy53YXJuKCJiYXNpcy5hcnJheS5zb3J0QXNPYmplY3QgaXMgZGVwcmVjYXRlZCwgdXNlIGJhc2lzLmFycmF5LnNvcnQgaW5zdGVhZCIpOwogICAgICByZXR1cm4gYXJyYXlGdW5jdGlvbnMuc29ydC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIHNvcnQ6IGZ1bmN0aW9uKHRoaXNfLCBnZXR0ZXJfLCBjb21wYXJhdG9yLCBkZXNjKSB7CiAgICAgIGdldHRlcl8gPSBnZXR0ZXIoZ2V0dGVyXyk7CiAgICAgIGRlc2MgPSBkZXNjID8gLTEgOiAxOwogICAgICByZXR1cm4gdGhpc18ubWFwKGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGk6IGluZGV4LAogICAgICAgICAgdjogZ2V0dGVyXyhpdGVtKQogICAgICAgIH07CiAgICAgIH0pLnNvcnQoY29tcGFyYXRvciB8fCBmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgcmV0dXJuIGRlc2MgKiAoYS52ID4gYi52IHx8IC0oYS52IDwgYi52KSB8fCAoYS5pID4gYi5pID8gMSA6IC0xKSk7CiAgICAgIH0pLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgcmV0dXJuIHRoaXNbaXRlbS5pXTsKICAgICAgfSwgdGhpc18pOwogICAgfQogIH07CiAgaWYgKCFbIDEsIDIgXS5zcGxpY2UoMSkubGVuZ3RoKSB7CiAgICB2YXIgbmF0aXZlQXJyYXlTcGxpY2UgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlOwogICAgQXJyYXkucHJvdG90eXBlLnNwbGljZSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgcGFyYW1zID0gYXJyYXlGcm9tKGFyZ3VtZW50cyk7CiAgICAgIGlmIChwYXJhbXMubGVuZ3RoIDwgMikgcGFyYW1zWzFdID0gdGhpcy5sZW5ndGg7CiAgICAgIHJldHVybiBuYXRpdmVBcnJheVNwbGljZS5hcHBseSh0aGlzLCBwYXJhbXMpOwogICAgfTsKICB9CiAgdmFyIEVTQ0FQRV9GT1JfUkVHRVhQID0gLyhbXC9cXFwoXClcW1xdXD9ce1x9XHxcKlwrXC1cLlxeXCRdKS9nOwogIHZhciBGT1JNQVRfUkVHRVhQID0gL1x7KFthLXpcZF9dKykoPzo6KFtcLjBdKShcZCspfDooXD8pKT9cfS9naTsKICBjb21wbGV0ZShTdHJpbmcsIHsKICAgIHRvTG93ZXJDYXNlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50b0xvd2VyQ2FzZSgpOwogICAgfSwKICAgIHRvVXBwZXJDYXNlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50b1VwcGVyQ2FzZSgpOwogICAgfSwKICAgIHRyaW06IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRyaW0oKTsKICAgIH0sCiAgICB0cmltTGVmdDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudHJpbUxlZnQoKTsKICAgIH0sCiAgICB0cmltUmlnaHQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRyaW1SaWdodCgpOwogICAgfQogIH0pOwogIGNvbXBsZXRlKFN0cmluZy5wcm90b3R5cGUsIHsKICAgIHRyaW1MZWZ0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzKy8sICIiKTsKICAgIH0sCiAgICB0cmltUmlnaHQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5yZXBsYWNlKC9ccyskLywgIiIpOwogICAgfSwKICAgIHRyaW06IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy50cmltTGVmdCgpLnRyaW1SaWdodCgpOwogICAgfQogIH0pOwogIHZhciBzdHJpbmdGdW5jdGlvbnMgPSB7CiAgICB0b09iamVjdDogZnVuY3Rpb24odGhpc18sIHJldGhyb3cpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gKG5ldyBGdW5jdGlvbigicmV0dXJuIDAsIiArIHRoaXNfKSkoKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChyZXRocm93KSB0aHJvdyBlOwogICAgICB9CiAgICB9LAogICAgcmVwZWF0OiBmdW5jdGlvbih0aGlzXywgY291bnQpIHsKICAgICAgcmV0dXJuIChuZXcgQXJyYXkocGFyc2VJbnQoY291bnQsIDEwKSArIDEgfHwgMCkpLmpvaW4odGhpc18pOwogICAgfSwKICAgIHF3OiBmdW5jdGlvbih0aGlzXykgewogICAgICB2YXIgdHJpbW1lZCA9IHRoaXNfLnRyaW0oKTsKICAgICAgcmV0dXJuIHRyaW1tZWQgPyB0cmltbWVkLnNwbGl0KC9ccysvKSA6IFtdOwogICAgfSwKICAgIGZvclJlZ0V4cDogZnVuY3Rpb24odGhpc18pIHsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoRVNDQVBFX0ZPUl9SRUdFWFAsICJcXCQxIik7CiAgICB9LAogICAgZm9ybWF0OiBmdW5jdGlvbih0aGlzXywgZmlyc3QpIHsKICAgICAgdmFyIGRhdGEgPSBhcnJheUZyb20oYXJndW1lbnRzLCAxKTsKICAgICAgaWYgKHR5cGVvZiBmaXJzdCA9PSAib2JqZWN0IikgZXh0ZW5kKGRhdGEsIGZpcnN0KTsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoRk9STUFUX1JFR0VYUCwgZnVuY3Rpb24obSwga2V5LCBudW1Gb3JtYXQsIG51bSwgbm9OdWxsKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga2V5IGluIGRhdGEgPyBkYXRhW2tleV0gOiBub051bGwgPyAiIiA6IG07CiAgICAgICAgaWYgKG51bUZvcm1hdCAmJiAhaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICB2YWx1ZSA9IE51bWJlcih2YWx1ZSk7CiAgICAgICAgICByZXR1cm4gbnVtRm9ybWF0ID09ICIuIiA/IHZhbHVlLnRvRml4ZWQobnVtKSA6IG51bWJlckZ1bmN0aW9ucy5sZWFkKHZhbHVlLCBudW0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0pOwogICAgfSwKICAgIGNhcGl0YWxpemU6IGZ1bmN0aW9uKHRoaXNfKSB7CiAgICAgIHJldHVybiB0aGlzXy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHRoaXNfLnN1YnN0cigxKS50b0xvd2VyQ2FzZSgpOwogICAgfSwKICAgIGNhbWVsaXplOiBmdW5jdGlvbih0aGlzXykgewogICAgICByZXR1cm4gdGhpc18ucmVwbGFjZSgvLSguKS9nLCBmdW5jdGlvbihtLCBjaHIpIHsKICAgICAgICByZXR1cm4gY2hyLnRvVXBwZXJDYXNlKCk7CiAgICAgIH0pOwogICAgfSwKICAgIGRhc2hlcml6ZTogZnVuY3Rpb24odGhpc18pIHsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKG0pIHsKICAgICAgICByZXR1cm4gIi0iICsgbS50b0xvd2VyQ2FzZSgpOwogICAgICB9KTsKICAgIH0sCiAgICBpc0VtcHR5OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCBTdHJpbmcodmFsdWUpID09ICIiOwogICAgfSwKICAgIGlzTm90RW1wdHk6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAhPSBudWxsICYmIFN0cmluZyh2YWx1ZSkgIT0gIiI7CiAgICB9CiAgfTsKICBpZiAoInx8fCIuc3BsaXQoL1x8LykubGVuZ3RoICsgInx8fCIuc3BsaXQoLyhcfCkvKS5sZW5ndGggIT0gMTEpIHsKICAgIHZhciBuYXRpdmVTdHJpbmdTcGxpdCA9IFN0cmluZy5wcm90b3R5cGUuc3BsaXQ7CiAgICBTdHJpbmcucHJvdG90eXBlLnNwbGl0ID0gZnVuY3Rpb24ocGF0dGVybiwgY291bnQpIHsKICAgICAgaWYgKCFwYXR0ZXJuIHx8IHBhdHRlcm4gaW5zdGFuY2VvZiBSZWdFeHAgPT0gZmFsc2UgfHwgcGF0dGVybi5zb3VyY2UgPT0gIiIpIHJldHVybiBuYXRpdmVTdHJpbmdTcGxpdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIHZhciBwb3MgPSAwOwogICAgICB2YXIgbWF0Y2g7CiAgICAgIGlmICghcGF0dGVybi5nbG9iYWwpIHBhdHRlcm4gPSBuZXcgUmVnRXhwKHBhdHRlcm4uc291cmNlLCAvXC8oW21pXSopJC8uZXhlYyhwYXR0ZXJuKVsxXSArICJnIik7CiAgICAgIHdoaWxlIChtYXRjaCA9IHBhdHRlcm4uZXhlYyh0aGlzKSkgewogICAgICAgIG1hdGNoWzBdID0gdGhpcy5zdWJzdHJpbmcocG9zLCBtYXRjaC5pbmRleCk7CiAgICAgICAgcmVzdWx0LnB1c2guYXBwbHkocmVzdWx0LCBtYXRjaCk7CiAgICAgICAgcG9zID0gcGF0dGVybi5sYXN0SW5kZXg7CiAgICAgIH0KICAgICAgcmVzdWx0LnB1c2godGhpcy5zdWJzdHIocG9zKSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KICBpZiAoIjEyIi5zdWJzdHIoLTEpICE9ICIyIikgewogICAgdmFyIG5hdGl2ZVN0cmluZ1N1YnN0ciA9IFN0cmluZy5wcm90b3R5cGUuc3Vic3RyOwogICAgU3RyaW5nLnByb3RvdHlwZS5zdWJzdHIgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgIHJldHVybiBuYXRpdmVTdHJpbmdTdWJzdHIuY2FsbCh0aGlzLCBzdGFydCA8IDAgPyBNYXRoLm1heCgwLCB0aGlzLmxlbmd0aCArIHN0YXJ0KSA6IHN0YXJ0LCBlbmQpOwogICAgfTsKICB9CiAgdmFyIG51bWJlckZ1bmN0aW9ucyA9IHsKICAgIGZpdDogZnVuY3Rpb24odGhpc18sIG1pbiwgbWF4KSB7CiAgICAgIGlmICghaXNOYU4obWluKSAmJiB0aGlzXyA8IG1pbikgcmV0dXJuIE51bWJlcihtaW4pOwogICAgICBpZiAoIWlzTmFOKG1heCkgJiYgdGhpc18gPiBtYXgpIHJldHVybiBOdW1iZXIobWF4KTsKICAgICAgcmV0dXJuIHRoaXNfOwogICAgfSwKICAgIGxlYWQ6IGZ1bmN0aW9uKHRoaXNfLCBsZW4sIGxlYWRDaGFyKSB7CiAgICAgIHJldHVybiBTdHJpbmcodGhpc18pLnJlcGxhY2UoL1xkKy8sIGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgIHJldHVybiAobGVuIC09IG51bWJlci5sZW5ndGggLSAxKSA+IDEgPyAobmV3IEFycmF5KGxlbikpLmpvaW4obGVhZENoYXIgfHwgMCkgKyBudW1iZXIgOiBudW1iZXI7CiAgICAgIH0pOwogICAgfSwKICAgIGdyb3VwOiBmdW5jdGlvbih0aGlzXywgbGVuLCBzcGxpdHRlcikgewogICAgICByZXR1cm4gU3RyaW5nKHRoaXNfKS5yZXBsYWNlKC9cZCsvLCBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICByZXR1cm4gbnVtYmVyLnJlcGxhY2UoL1xkL2csIGZ1bmN0aW9uKG0sIHBvcykgewogICAgICAgICAgcmV0dXJuICFwb3MgKyAobnVtYmVyLmxlbmd0aCAtIHBvcykgJSAobGVuIHx8IDMpID8gbSA6IChzcGxpdHRlciB8fCAiICIpICsgbTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAogICAgZm9ybWF0OiBmdW5jdGlvbih0aGlzXywgcHJlYywgZ3MsIHByZWZpeCwgcG9zdGZpeCwgY29tbWEpIHsKICAgICAgdmFyIHJlcyA9IHRoaXNfLnRvRml4ZWQocHJlYyk7CiAgICAgIGlmIChncyB8fCBjb21tYSkgcmVzID0gcmVzLnJlcGxhY2UoLyhcZCspKFwuPykvLCBmdW5jdGlvbihtLCBudW1iZXIsIGMpIHsKICAgICAgICByZXR1cm4gKGdzID8gYmFzaXMubnVtYmVyLmdyb3VwKE51bWJlcihudW1iZXIpLCAzLCBncykgOiBudW1iZXIpICsgKGMgPyBjb21tYSB8fCBjIDogIiIpOwogICAgICB9KTsKICAgICAgaWYgKHByZWZpeCkgcmVzID0gcmVzLnJlcGxhY2UoL14tPy8sICIkJiIgKyAocHJlZml4IHx8ICIiKSk7CiAgICAgIHJldHVybiByZXMgKyAocG9zdGZpeCB8fCAiIik7CiAgICB9CiAgfTsKICBjb21wbGV0ZShEYXRlLCB7CiAgICBub3c6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gTnVtYmVyKG5ldyBEYXRlKTsKICAgIH0KICB9KTsKICB2YXIgcmVhZHkgPSBmdW5jdGlvbigpIHsKICAgIGZ1bmN0aW9uIGlzUmVhZHkoKSB7CiAgICAgIHJldHVybiBkb2N1bWVudC5yZWFkeVN0YXRlID09ICJjb21wbGV0ZSIgJiYgISFkb2N1bWVudC5ib2R5OwogICAgfQogICAgdmFyIGZpcmVkID0gIWRvY3VtZW50IHx8IGlzUmVhZHkoKTsKICAgIHZhciBkZWZlcnJlZEhhbmRsZXI7CiAgICBmdW5jdGlvbiBydW5SZWFkeUhhbmRsZXIoaGFuZGxlcikgewogICAgICBoYW5kbGVyLmNhbGxiYWNrLmNhbGwoaGFuZGxlci5jb250ZXh0KTsKICAgIH0KICAgIGZ1bmN0aW9uIGZpcmVIYW5kbGVycygpIHsKICAgICAgaWYgKGlzUmVhZHkoKSkgaWYgKCEoZmlyZWQrKykpIHdoaWxlIChkZWZlcnJlZEhhbmRsZXIpIHsKICAgICAgICBydW5SZWFkeUhhbmRsZXIoZGVmZXJyZWRIYW5kbGVyKTsKICAgICAgICBkZWZlcnJlZEhhbmRsZXIgPSBkZWZlcnJlZEhhbmRsZXIubmV4dDsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZG9TY3JvbGxDaGVjaygpIHsKICAgICAgdHJ5IHsKICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwoImxlZnQiKTsKICAgICAgICBmaXJlSGFuZGxlcnMoKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHNldFRpbWVvdXQoZG9TY3JvbGxDaGVjaywgMSk7CiAgICAgIH0KICAgIH0KICAgIGlmICghZmlyZWQpIHsKICAgICAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgZmlyZUhhbmRsZXJzLCBmYWxzZSk7CiAgICAgICAgZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBmaXJlSGFuZGxlcnMsIGZhbHNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgZmlyZUhhbmRsZXJzKTsKICAgICAgICBnbG9iYWwuYXR0YWNoRXZlbnQoIm9ubG9hZCIsIGZpcmVIYW5kbGVycyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICghZ2xvYmFsLmZyYW1lRWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwpIGRvU2Nyb2xsQ2hlY2soKTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZnVuY3Rpb24oY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFmaXJlZCkgewogICAgICAgIGRlZmVycmVkSGFuZGxlciA9IHsKICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjaywKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICBuZXh0OiBkZWZlcnJlZEhhbmRsZXIKICAgICAgICB9OwogICAgICB9IGVsc2UgcnVuUmVhZHlIYW5kbGVyKHsKICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICB9KTsKICAgIH07CiAgfSgpOwogIHZhciBkb2N1bWVudEludGVyZmFjZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHRpbWVyOwogICAgdmFyIHJlZmVyZW5jZSA9IHt9OwogICAgdmFyIGNhbGxiYWNrcyA9IHsKICAgICAgaGVhZDogW10sCiAgICAgIGJvZHk6IFtdCiAgICB9OwogICAgZnVuY3Rpb24gZ2V0UGFyZW50KG5hbWUpIHsKICAgICAgaWYgKGRvY3VtZW50ICYmICFyZWZlcmVuY2VbbmFtZV0pIHsKICAgICAgICByZWZlcmVuY2VbbmFtZV0gPSBkb2N1bWVudFtuYW1lXSB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShuYW1lKVswXTsKICAgICAgICBpZiAocmVmZXJlbmNlW25hbWVdKSB7CiAgICAgICAgICB2YXIgaXRlbXMgPSBjYWxsYmFja3NbbmFtZV07CiAgICAgICAgICBkZWxldGUgY2FsbGJhY2tzW25hbWVdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNiOyBjYiA9IGl0ZW1zW2ldOyBpKyspIGNiWzBdLmNhbGwoY2JbMV0sIHJlZmVyZW5jZVtuYW1lXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZWZlcmVuY2VbbmFtZV07CiAgICB9CiAgICBmdW5jdGlvbiBhZGQoKSB7CiAgICAgIHZhciBuYW1lID0gdGhpc1swXTsKICAgICAgdmFyIG5vZGUgPSB0aGlzWzFdOwogICAgICB2YXIgcmVmID0gdGhpc1syXTsKICAgICAgcmVtb3ZlKG5vZGUpOwogICAgICB2YXIgcGFyZW50ID0gZ2V0UGFyZW50KG5hbWUpOwogICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgaWYgKHJlZiA9PT0gdHJ1ZSkgcmVmID0gcGFyZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgaWYgKCFyZWYgfHwgcmVmLnBhcmVudE5vZGUgIT09IHBhcmVudCkgcmVmID0gbnVsbDsKICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHJlZik7CiAgICAgIH0gZWxzZSBjYWxsYmFja3NbbmFtZV0ucHVzaChbIGFkZCwgWyBuYW1lLCBub2RlLCByZWYgXSBdKTsKICAgIH0KICAgIGZ1bmN0aW9uIGRvY1JlYWR5KG5hbWUsIGZuLCBjb250ZXh0KSB7CiAgICAgIGlmIChjYWxsYmFja3NbbmFtZV0pIGNhbGxiYWNrc1tuYW1lXS5wdXNoKFsgZm4sIGNvbnRleHQgXSk7IGVsc2UgZm4uY2FsbChjb250ZXh0LCByZWZlcmVuY2VbbmFtZV0pOwogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlKG5vZGUpIHsKICAgICAgZm9yICh2YXIga2V5IGluIGNhbGxiYWNrcykgewogICAgICAgIHZhciBlbnRyeSA9IGFycmF5RnVuY3Rpb25zLnNlYXJjaChjYWxsYmFja3Nba2V5XSwgbm9kZSwgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgcmV0dXJuIGl0ZW1bMV0gJiYgaXRlbVsxXVsxXTsKICAgICAgICB9KTsKICAgICAgICBpZiAoZW50cnkpIGFycmF5RnVuY3Rpb25zLnJlbW92ZShjYWxsYmFja3Nba2V5XSwgZW50cnkpOwogICAgICB9CiAgICAgIGlmIChub2RlICYmIG5vZGUucGFyZW50Tm9kZSAmJiBub2RlLnBhcmVudE5vZGUubm9kZVR5cGUgPT0gMSkgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgfQogICAgZnVuY3Rpb24gY2hlY2tQYXJlbnRzKCkgewogICAgICBpZiAodGltZXIgJiYgZ2V0UGFyZW50KCJoZWFkIikgJiYgZ2V0UGFyZW50KCJib2R5IikpIHRpbWVyID0gY2xlYXJJbnRlcnZhbCh0aW1lcik7CiAgICB9CiAgICBpZiAoZG9jdW1lbnQgJiYgKCFnZXRQYXJlbnQoImhlYWQiKSB8fCAhZ2V0UGFyZW50KCJib2R5IikpKSB7CiAgICAgIHRpbWVyID0gc2V0SW50ZXJ2YWwoY2hlY2tQYXJlbnRzLCA1KTsKICAgICAgcmVhZHkoY2hlY2tQYXJlbnRzKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGhlYWQ6IHsKICAgICAgICByZWFkeTogZnVuY3Rpb24oZm4sIGNvbnRleHQpIHsKICAgICAgICAgIGRvY1JlYWR5KCJoZWFkIiwgZm4sIGNvbnRleHQpOwogICAgICAgIH0sCiAgICAgICAgYWRkOiBmdW5jdGlvbihub2RlLCByZWYpIHsKICAgICAgICAgIGFkZC5jYWxsKFsgImhlYWQiLCBub2RlLCByZWYgXSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBib2R5OiB7CiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgICAgICBkb2NSZWFkeSgiYm9keSIsIGZuLCBjb250ZXh0KTsKICAgICAgICB9LAogICAgICAgIGFkZDogZnVuY3Rpb24obm9kZSwgcmVmKSB7CiAgICAgICAgICBhZGQuY2FsbChbICJib2R5Iiwgbm9kZSwgcmVmIF0pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcmVtb3ZlOiByZW1vdmUKICAgIH07CiAgfSgpOwogIHZhciBjbGVhbmVyID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgb2JqZWN0cyA9IFtdOwogICAgZnVuY3Rpb24gZGVzdHJveShsb2cpIHsKICAgICAgdmFyIGxvZ0Rlc3Ryb3kgPSBsb2cgJiYgdHlwZW9mIGxvZyA9PSAiYm9vbGVhbiI7CiAgICAgIHJlc3VsdC5nbG9iYWxEZXN0cm95ID0gdHJ1ZTsKICAgICAgcmVzdWx0LmFkZCA9ICR1bmRlZjsKICAgICAgcmVzdWx0LnJlbW92ZSA9ICR1bmRlZjsKICAgICAgdmFyIG9iamVjdDsKICAgICAgd2hpbGUgKG9iamVjdCA9IG9iamVjdHMucG9wKCkpIHsKICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5kZXN0cm95ID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChsb2dEZXN0cm95KSBjb25zb2xlTWV0aG9kcy5sb2coImRlc3Ryb3kiLCAiWyIgKyBTdHJpbmcob2JqZWN0LmNsYXNzTmFtZSkgKyAiXSIsIG9iamVjdCk7CiAgICAgICAgICAgIG9iamVjdC5kZXN0cm95KCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGVNZXRob2RzLndhcm4oU3RyaW5nKG9iamVjdCksIGUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIG9iamVjdCkgb2JqZWN0W3Byb3BdID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgICAgb2JqZWN0cy5sZW5ndGggPSAwOwogICAgfQogICAgaWYgKCJhdHRhY2hFdmVudCIgaW4gZ2xvYmFsKSBnbG9iYWwuYXR0YWNoRXZlbnQoIm9udW5sb2FkIiwgZGVzdHJveSk7IGVsc2UgaWYgKCJhZGRFdmVudExpc3RlbmVyIiBpbiBnbG9iYWwpIGdsb2JhbC5hZGRFdmVudExpc3RlbmVyKCJ1bmxvYWQiLCBkZXN0cm95LCBmYWxzZSk7IGVsc2UgcmV0dXJuIHsKICAgICAgYWRkOiAkdW5kZWYsCiAgICAgIHJlbW92ZTogJHVuZGVmCiAgICB9OwogICAgdmFyIHJlc3VsdCA9IHsKICAgICAgYWRkOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICBpZiAob2JqZWN0ICE9IG51bGwpIG9iamVjdHMucHVzaChvYmplY3QpOwogICAgICB9LAogICAgICByZW1vdmU6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIGFycmF5RnVuY3Rpb25zLnJlbW92ZShvYmplY3RzLCBvYmplY3QpOwogICAgICB9CiAgICB9OwogICAgcmVzdWx0LmRlc3Ryb3lfID0gZGVzdHJveTsKICAgIHJlc3VsdC5vYmplY3RzXyA9IG9iamVjdHM7CiAgICByZXR1cm4gcmVzdWx0OwogIH0oKTsKICB2YXIgQ3NzUmVzb3VyY2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBTVFlMRV9BUFBFTkRfQlVHR1kgPSBmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0eWxlIikuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIiIpKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9KCk7CiAgICB2YXIgYmFzZUVsID0gZG9jdW1lbnQgJiYgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYmFzZSIpOwogICAgZnVuY3Rpb24gc2V0QmFzZShiYXNlVVJJKSB7CiAgICAgIGJhc2VFbC5zZXRBdHRyaWJ1dGUoImhyZWYiLCBiYXNlVVJJKTsKICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5hZGQoYmFzZUVsLCB0cnVlKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlc3RvcmVCYXNlKCkgewogICAgICBiYXNlRWwuc2V0QXR0cmlidXRlKCJocmVmIiwgbG9jYXRpb24uaHJlZik7CiAgICAgIGRvY3VtZW50SW50ZXJmYWNlLnJlbW92ZShiYXNlRWwpOwogICAgfQogICAgZnVuY3Rpb24gaW5qZWN0U3R5bGVUb0hlYWQoKSB7CiAgICAgIHNldEJhc2UodGhpcy5iYXNlVVJJKTsKICAgICAgaWYgKCF0aGlzLmVsZW1lbnQpIHsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgIGlmICghU1RZTEVfQVBQRU5EX0JVR0dZKSB0aGlzLmVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIiIpKTsKICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKCJzcmMiLCB0aGlzLnVybCk7CiAgICAgIH0KICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5hZGQodGhpcy5lbGVtZW50KTsKICAgICAgdGhpcy5zeW5jQ3NzVGV4dCgpOwogICAgICByZXN0b3JlQmFzZSgpOwogICAgfQogICAgcmV0dXJuIENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiAiYmFzaXMuQ3NzUmVzb3VyY2UiLAogICAgICBpblVzZTogMCwKICAgICAgdXJsOiAiIiwKICAgICAgYmFzZVVSSTogIiIsCiAgICAgIGNzc1RleHQ6IHVuZGVmaW5lZCwKICAgICAgZWxlbWVudDogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24odXJsKSB7CiAgICAgICAgdGhpcy51cmwgPSB1cmw7CiAgICAgICAgdGhpcy5iYXNlVVJJID0gcGF0aFV0aWxzLmRpcm5hbWUodXJsKSArICIvIjsKICAgICAgfSwKICAgICAgdXBkYXRlQ3NzVGV4dDogZnVuY3Rpb24oY3NzVGV4dCkgewogICAgICAgIGlmICh0aGlzLmNzc1RleHQgIT0gY3NzVGV4dCkgewogICAgICAgICAgdGhpcy5jc3NUZXh0ID0gY3NzVGV4dDsKICAgICAgICAgIGlmICh0aGlzLmluVXNlICYmIHRoaXMuZWxlbWVudCkgewogICAgICAgICAgICBzZXRCYXNlKHRoaXMuYmFzZVVSSSk7CiAgICAgICAgICAgIHRoaXMuc3luY0Nzc1RleHQoKTsKICAgICAgICAgICAgcmVzdG9yZUJhc2UoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIHN5bmNDc3NUZXh0OiBTVFlMRV9BUFBFTkRfQlVHR1kgPyBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmVsZW1lbnQuc3R5bGVTaGVldC5jc3NUZXh0ID0gdGhpcy5jc3NUZXh0OwogICAgICB9IDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGNzc1RleHQgPSB0aGlzLmNzc1RleHQ7CiAgICAgICAgY3NzVGV4dCArPSAiXG4vKiMgc291cmNlVVJMPSIgKyBwYXRoVXRpbHMub3JpZ2luICsgdGhpcy51cmwgKyAiICovIjsKICAgICAgICB0aGlzLmVsZW1lbnQuZmlyc3RDaGlsZC5ub2RlVmFsdWUgPSBjc3NUZXh0OwogICAgICB9LAogICAgICBzdGFydFVzZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLmluVXNlKSBkb2N1bWVudEludGVyZmFjZS5oZWFkLnJlYWR5KGluamVjdFN0eWxlVG9IZWFkLCB0aGlzKTsKICAgICAgICB0aGlzLmluVXNlICs9IDE7CiAgICAgIH0sCiAgICAgIHN0b3BVc2U6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmluVXNlKSB7CiAgICAgICAgICB0aGlzLmluVXNlIC09IDE7CiAgICAgICAgICBpZiAoIXRoaXMuaW5Vc2UgJiYgdGhpcy5lbGVtZW50KSBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUodGhpcy5lbGVtZW50KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmVsZW1lbnQpIGRvY3VtZW50SW50ZXJmYWNlLnJlbW92ZSh0aGlzLmVsZW1lbnQpOwogICAgICAgIHRoaXMuZWxlbWVudCA9IG51bGw7CiAgICAgICAgdGhpcy5jc3NUZXh0ID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgfSgpOwogIHZhciBiYXNpcyA9IGdldE5hbWVzcGFjZSgiYmFzaXMiKS5leHRlbmQoewogICAgZmlsZW5hbWVfOiBiYXNpc0ZpbGVuYW1lLAogICAgcHJvY2Vzc0NvbmZpZzogcHJvY2Vzc0NvbmZpZywKICAgIHZlcnNpb246IFZFUlNJT04sCiAgICBOT0RFX0VOVjogTk9ERV9FTlYsCiAgICBjb25maWc6IGNvbmZpZywKICAgIGNyZWF0ZVNhbmRib3g6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICByZXR1cm4gY3JlYXRlQmFzaXNJbnN0YW5jZShnbG9iYWwsIGJhc2lzRmlsZW5hbWUsIGNvbXBsZXRlKHsKICAgICAgICBub0NvbmZsaWN0OiB0cnVlCiAgICAgIH0sIGNvbmZpZykpOwogICAgfSwKICAgIHJlc29sdmVOU0ZpbGVuYW1lOiByZXNvbHZlTlNGaWxlbmFtZSwKICAgIHBhdGNoOiBwYXRjaCwKICAgIG5hbWVzcGFjZTogZ2V0TmFtZXNwYWNlLAogICAgcmVxdWlyZTogcmVxdWlyZU5hbWVzcGFjZSwKICAgIHJlc291cmNlOiBnZXRSZXNvdXJjZSwKICAgIGFzc2V0OiBmdW5jdGlvbih1cmwpIHsKICAgICAgcmV0dXJuIHVybDsKICAgIH0sCiAgICBzZXRJbW1lZGlhdGU6IHNldEltbWVkaWF0ZSwKICAgIGNsZWFySW1tZWRpYXRlOiBjbGVhckltbWVkaWF0ZSwKICAgIG5leHRUaWNrOiBmdW5jdGlvbigpIHsKICAgICAgc2V0SW1tZWRpYXRlLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgQ2xhc3M6IENsYXNzLAogICAgVG9rZW46IFRva2VuLAogICAgRGVmZXJyZWRUb2tlbjogRGVmZXJyZWRUb2tlbiwKICAgIGdlblVJRDogZ2VuVUlELAogICAgZ2V0dGVyOiBnZXR0ZXIsCiAgICByZWFkeTogcmVhZHksCiAgICBjbGVhbmVyOiBjbGVhbmVyLAogICAgY29uc29sZTogY29uc29sZU1ldGhvZHMsCiAgICBwYXRoOiBwYXRoVXRpbHMsCiAgICBkb2M6IGRvY3VtZW50SW50ZXJmYWNlLAogICAgb2JqZWN0OiB7CiAgICAgIGV4dGVuZDogZXh0ZW5kLAogICAgICBjb21wbGV0ZTogY29tcGxldGUsCiAgICAgIGtleXM6IGtleXMsCiAgICAgIHZhbHVlczogdmFsdWVzLAogICAgICBzbGljZTogc2xpY2UsCiAgICAgIHNwbGljZTogc3BsaWNlLAogICAgICBtZXJnZTogbWVyZ2UsCiAgICAgIGl0ZXJhdGU6IGl0ZXJhdGUKICAgIH0sCiAgICBmbjogewogICAgICAkdW5kZWZpbmVkOiAkdW5kZWZpbmVkLAogICAgICAkZGVmaW5lZDogJGRlZmluZWQsCiAgICAgICRpc051bGw6ICRpc051bGwsCiAgICAgICRpc05vdE51bGw6ICRpc05vdE51bGwsCiAgICAgICRpc1NhbWU6ICRpc1NhbWUsCiAgICAgICRpc05vdFNhbWU6ICRpc05vdFNhbWUsCiAgICAgICRzZWxmOiAkc2VsZiwKICAgICAgJGNvbnN0OiAkY29uc3QsCiAgICAgICRmYWxzZTogJGZhbHNlLAogICAgICAkdHJ1ZTogJHRydWUsCiAgICAgICRudWxsOiAkbnVsbCwKICAgICAgJHVuZGVmOiAkdW5kZWYsCiAgICAgIGdldHRlcjogZ2V0dGVyLAogICAgICBudWxsR2V0dGVyOiBudWxsR2V0dGVyLAogICAgICB3cmFwcGVyOiB3cmFwcGVyLAogICAgICBsYXp5SW5pdDogbGF6eUluaXQsCiAgICAgIGxhenlJbml0QW5kUnVuOiBsYXp5SW5pdEFuZFJ1biwKICAgICAgcnVuT25jZTogcnVuT25jZQogICAgfSwKICAgIGFycmF5OiBleHRlbmQoYXJyYXlGcm9tLCBhcnJheUZ1bmN0aW9ucyksCiAgICBzdHJpbmc6IHN0cmluZ0Z1bmN0aW9ucywKICAgIG51bWJlcjogbnVtYmVyRnVuY3Rpb25zLAogICAgYm9vbDogewogICAgICBpbnZlcnQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuICF2YWx1ZTsKICAgICAgfQogICAgfSwKICAgIGpzb246IHsKICAgICAgcGFyc2U6IHR5cGVvZiBKU09OICE9ICJ1bmRlZmluZWQiID8gSlNPTi5wYXJzZSA6IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHJldHVybiBzdHJpbmdGdW5jdGlvbnMudG9PYmplY3Qoc3RyLCB0cnVlKTsKICAgICAgfQogICAgfQogIH0pOwogIGdldE5hbWVzcGFjZSgiYmFzaXMuZGV2IikuZXh0ZW5kKGNvbnNvbGVNZXRob2RzKTsKICBpZiAoY29uZmlnLmF1dG9sb2FkKSBjb25maWcuYXV0b2xvYWQuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICByZXF1aXJlTmFtZXNwYWNlKG5hbWUpOwogIH0pOwogIHJldHVybiBiYXNpczsKfSkodGhpcyk7Cn0pLmNhbGwodGhpcyk7",
                "body": "Ly8gcmVzb3VyY2VzICgyNik6Ci8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9kYXRhL2RhdGFzZXQuanMgLT4gZC5qcwovLyAgW2Z1bmN0aW9uXSBsaWJyYXJ5LmpzIC0+IDAuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL2wxMG4uanMgLT4gMi5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvZXZlbnQuanMgLT4gMy5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvZGF0YS5qcyAtPiA0LmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9kb20vd3JhcHBlci5qcyAtPiA1LmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy90ZW1wbGF0ZS5qcyAtPiA2LmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy90ZW1wbGF0ZS9odG1sLmpzIC0+IDcuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL2RvbS9ldmVudC5qcyAtPiA4LmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy90ZW1wbGF0ZS9odG1sZmdlbi5qcyAtPiA5LmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9kcmFnZHJvcC5qcyAtPiBhLmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9kb20vY29tcHV0ZWRTdHlsZS5qcyAtPiBiLmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9sYXlvdXQuanMgLT4gYy5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvdWkuanMgLT4gMS5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvZGF0YS92YWx1ZS5qcyAtPiBlLmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9kYXRhL2luZGV4LmpzIC0+IGYuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL2RhdGEvb2JqZWN0LmpzIC0+IGcuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL2VudGl0eS5qcyAtPiBoLmpzCi8vICBbZnVuY3Rpb25dIC4uLy4uL3NyYy9iYXNpcy9uZXQvanNvbnAuanMgLT4gaS5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvbmV0LmpzIC0+IGouanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL25ldC9zZXJ2aWNlLmpzIC0+IGsuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL25ldC9hamF4LmpzIC0+IGwuanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL3VhLmpzIC0+IG0uanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL25ldC9hY3Rpb24uanMgLT4gbi5qcwovLyAgW2Z1bmN0aW9uXSAuLi8uLi9zcmMvYmFzaXMvcm91dGVyLmpzIC0+IG8uanMKLy8gIFtmdW5jdGlvbl0gLi4vLi4vc3JjL2Jhc2lzL2FwcC5qcyAtPiBwLmpzCi8vCi8vIGZpbGVsaXN0ICgxKTogCi8vICAgbGlicmFyeS5qcwooZnVuY3Rpb24oKXsKInVzZSBzdHJpY3QiOwoKdmFyIF9fbmFtZXNwYWNlX21hcF9fID0geyIwLmpzIjoibGlicmFyeSIsIjEuanMiOiJiYXNpcy51aSIsIjIuanMiOiJiYXNpcy5sMTBuIiwiMy5qcyI6ImJhc2lzLmV2ZW50IiwiNC5qcyI6ImJhc2lzLmRhdGEiLCI1LmpzIjoiYmFzaXMuZG9tLndyYXBwZXIiLCI2LmpzIjoiYmFzaXMudGVtcGxhdGUiLCI3LmpzIjoiYmFzaXMudGVtcGxhdGUuaHRtbCIsIjguanMiOiJiYXNpcy5kb20uZXZlbnQiLCI5LmpzIjoiYmFzaXMudGVtcGxhdGUuaHRtbGZnZW4iLCJhLmpzIjoiYmFzaXMuZHJhZ2Ryb3AiLCJiLmpzIjoiYmFzaXMuZG9tLmNvbXB1dGVkU3R5bGUiLCJjLmpzIjoiYmFzaXMubGF5b3V0IiwiZC5qcyI6ImJhc2lzLmRhdGEuZGF0YXNldCIsImUuanMiOiJiYXNpcy5kYXRhLnZhbHVlIiwiZi5qcyI6ImJhc2lzLmRhdGEuaW5kZXgiLCJnLmpzIjoiYmFzaXMuZGF0YS5vYmplY3QiLCJoLmpzIjoiYmFzaXMuZW50aXR5IiwiaS5qcyI6ImJhc2lzLm5ldC5qc29ucCIsImouanMiOiJiYXNpcy5uZXQiLCJrLmpzIjoiYmFzaXMubmV0LnNlcnZpY2UiLCJsLmpzIjoiYmFzaXMubmV0LmFqYXgiLCJtLmpzIjoiYmFzaXMudWEiLCJuLmpzIjoiYmFzaXMubmV0LmFjdGlvbiIsIm8uanMiOiJiYXNpcy5yb3V0ZXIiLCJwLmpzIjoiYmFzaXMuYXBwIn07CnZhciBsaWJyYXJ5OwoKdmFyIF9fcmVzb3VyY2VzX18gPSB7CiAgImQuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMy5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgb25lRnVuY3Rpb25Qcm9wZXJ0eSA9IENsYXNzLm9uZUZ1bmN0aW9uUHJvcGVydHk7CiAgICB2YXIgZXh0ZW5kID0gYmFzaXMub2JqZWN0LmV4dGVuZDsKICAgIHZhciB2YWx1ZXMgPSBiYXNpcy5vYmplY3QudmFsdWVzOwogICAgdmFyIGdldHRlciA9IGJhc2lzLmdldHRlcjsKICAgIHZhciAkc2VsZiA9IGJhc2lzLmZuLiRzZWxmOwogICAgdmFyICR0cnVlID0gYmFzaXMuZm4uJHRydWU7CiAgICB2YXIgJGZhbHNlID0gYmFzaXMuZm4uJGZhbHNlOwogICAgdmFyICR1bmRlZiA9IGJhc2lzLmZuLiR1bmRlZjsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheS5mcm9tOwogICAgdmFyIGNyZWF0ZUV2ZW50ID0gYmFzaXMuZXZlbnQuY3JlYXRlOwogICAgdmFyIFNVQlNDUklQVElPTiA9IGJhc2lzLmRhdGEuU1VCU0NSSVBUSU9OOwogICAgdmFyIERhdGFPYmplY3QgPSBiYXNpcy5kYXRhLk9iamVjdDsKICAgIHZhciBLZXlPYmplY3RNYXAgPSBiYXNpcy5kYXRhLktleU9iamVjdE1hcDsKICAgIHZhciBSZWFkT25seURhdGFzZXQgPSBiYXNpcy5kYXRhLlJlYWRPbmx5RGF0YXNldDsKICAgIHZhciBEYXRhc2V0ID0gYmFzaXMuZGF0YS5EYXRhc2V0OwogICAgdmFyIERhdGFzZXRXcmFwcGVyID0gYmFzaXMuZGF0YS5EYXRhc2V0V3JhcHBlcjsKICAgIHZhciBzZXRBY2N1bXVsYXRlU3RhdGUgPSBEYXRhc2V0LnNldEFjY3VtdWxhdGVTdGF0ZTsKICAgIFNVQlNDUklQVElPTi5hZGQoIlNPVVJDRSIsIHsKICAgICAgc291cmNlQ2hhbmdlZDogZnVuY3Rpb24ob2JqZWN0LCBvbGRTb3VyY2UpIHsKICAgICAgICBpZiAob2xkU291cmNlKSBTVUJTQ1JJUFRJT04udW5saW5rKCJzb3VyY2UiLCBvYmplY3QsIG9sZFNvdXJjZSk7CiAgICAgICAgaWYgKG9iamVjdC5zb3VyY2UpIFNVQlNDUklQVElPTi5saW5rKCJzb3VyY2UiLCBvYmplY3QsIG9iamVjdC5zb3VyY2UpOwogICAgICB9LAogICAgICBzb3VyY2VzQ2hhbmdlZDogZnVuY3Rpb24ob2JqZWN0LCBkZWx0YSkgewogICAgICAgIHZhciBhcnJheTsKICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5pbnNlcnRlZCkgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBhcnJheVtpXTsgaSsrKSBTVUJTQ1JJUFRJT04ubGluaygic291cmNlIiwgb2JqZWN0LCBhcnJheVtpXSk7CiAgICAgICAgaWYgKGFycmF5ID0gZGVsdGEuZGVsZXRlZCkgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBhcnJheVtpXTsgaSsrKSBTVUJTQ1JJUFRJT04udW5saW5rKCJzb3VyY2UiLCBvYmplY3QsIGFycmF5W2ldKTsKICAgICAgfQogICAgfSwgZnVuY3Rpb24oYWN0aW9uLCBvYmplY3QpIHsKICAgICAgdmFyIHNvdXJjZXMgPSBvYmplY3Quc291cmNlcyB8fCAob2JqZWN0LnNvdXJjZSA/IFsgb2JqZWN0LnNvdXJjZSBdIDogW10pOwogICAgICBmb3IgKHZhciBpID0gMCwgc291cmNlOyBzb3VyY2UgPSBzb3VyY2VzW2krK107ICkgYWN0aW9uKCJzb3VyY2UiLCBvYmplY3QsIHNvdXJjZSk7CiAgICB9KTsKICAgIFNVQlNDUklQVElPTi5hZGRQcm9wZXJ0eSgibWludWVuZCIpOwogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJzdWJ0cmFoZW5kIik7CiAgICBmdW5jdGlvbiBnZXREZWx0YShpbnNlcnRlZCwgZGVsZXRlZCkgewogICAgICB2YXIgZGVsdGEgPSB7fTsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgaWYgKGluc2VydGVkICYmIGluc2VydGVkLmxlbmd0aCkgcmVzdWx0ID0gZGVsdGEuaW5zZXJ0ZWQgPSBpbnNlcnRlZDsKICAgICAgaWYgKGRlbGV0ZWQgJiYgZGVsZXRlZC5sZW5ndGgpIHJlc3VsdCA9IGRlbHRhLmRlbGV0ZWQgPSBkZWxldGVkOwogICAgICBpZiAocmVzdWx0KSByZXR1cm4gZGVsdGE7CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVSdWxlRXZlbnRzKGZuLCBldmVudHMpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIGNyZWF0ZVJ1bGVFdmVudHNFeHRlbmQoZXZlbnRzKSB7CiAgICAgICAgaWYgKCFldmVudHMpIHJldHVybiBudWxsOwogICAgICAgIGlmIChldmVudHMuX19leHRlbmRfXykgcmV0dXJuIGV2ZW50czsKICAgICAgICBpZiAodHlwZW9mIGV2ZW50cyAhPSAic3RyaW5nIiAmJiAhQXJyYXkuaXNBcnJheShldmVudHMpKSBldmVudHMgPSBudWxsOwogICAgICAgIHJldHVybiBleHRlbmQoYmFzaXMuZXZlbnQuY3JlYXRlSGFuZGxlcihldmVudHMsIGZuKSwgewogICAgICAgICAgX19leHRlbmRfXzogY3JlYXRlUnVsZUV2ZW50c0V4dGVuZAogICAgICAgIH0pOwogICAgICB9KGV2ZW50cyk7CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVLZXlNYXAoY29uZmlnLCBrZXlHZXR0ZXIsIEl0ZW1DbGFzcywgU3Vic2V0Q2xhc3MpIHsKICAgICAgcmV0dXJuIG5ldyBLZXlPYmplY3RNYXAoZXh0ZW5kKHsKICAgICAgICBrZXlHZXR0ZXI6IGtleUdldHRlciwKICAgICAgICBpdGVtQ2xhc3M6IEl0ZW1DbGFzcywKICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uKGtleSwgb2JqZWN0KSB7CiAgICAgICAgICB2YXIgZGF0YXNldFdyYXBwZXIgPSBLZXlPYmplY3RNYXAucHJvdG90eXBlLmNyZWF0ZS5jYWxsKHRoaXMsIGtleSwgb2JqZWN0KTsKICAgICAgICAgIGRhdGFzZXRXcmFwcGVyLnJ1bGVWYWx1ZSA9IGtleTsKICAgICAgICAgIGRhdGFzZXRXcmFwcGVyLnNldERhdGFzZXQobmV3IFN1YnNldENsYXNzKHsKICAgICAgICAgICAgcnVsZVZhbHVlOiBrZXkKICAgICAgICAgIH0pKTsKICAgICAgICAgIHJldHVybiBkYXRhc2V0V3JhcHBlcjsKICAgICAgICB9CiAgICAgIH0sIGNvbmZpZykpOwogICAgfQogICAgdmFyIE1FUkdFX0RBVEFTRVRfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihzb3VyY2UsIGRlbHRhKSB7CiAgICAgICAgdmFyIG1lbWJlck1hcCA9IHRoaXMubWVtYmVyc187CiAgICAgICAgdmFyIHVwZGF0ZWQgPSB7fTsKICAgICAgICB2YXIgb2JqZWN0OwogICAgICAgIHZhciBvYmplY3RJZDsKICAgICAgICBpZiAoZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBvYmplY3QgPSBkZWx0YS5pbnNlcnRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIG9iamVjdElkID0gb2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgIGlmIChtZW1iZXJNYXBbb2JqZWN0SWRdKSB7CiAgICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXS5jb3VudCsrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG1lbWJlck1hcFtvYmplY3RJZF0gPSB7CiAgICAgICAgICAgICAgICBjb3VudDogMSwKICAgICAgICAgICAgICAgIG9iamVjdDogb2JqZWN0CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVkW29iamVjdElkXSA9IG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWx0YS5kZWxldGVkKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgb2JqZWN0ID0gZGVsdGEuZGVsZXRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIG9iamVjdElkID0gb2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgIHVwZGF0ZWRbb2JqZWN0SWRdID0gbWVtYmVyTWFwW29iamVjdElkXTsKICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXS5jb3VudC0tOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmFwcGx5UnVsZSh1cGRhdGVkKTsKICAgICAgfQogICAgfTsKICAgIHZhciBNZXJnZSA9IENsYXNzKFJlYWRPbmx5RGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTWVyZ2UiLAogICAgICBzdWJzY3JpYmVUbzogU1VCU0NSSVBUSU9OLlNPVVJDRSwKICAgICAgZW1pdF9zb3VyY2VzQ2hhbmdlZDogY3JlYXRlRXZlbnQoInNvdXJjZXNDaGFuZ2VkIiwgImRlbHRhIiksCiAgICAgIHNvdXJjZXM6IG51bGwsCiAgICAgIHNvdXJjZVZhbHVlc186IG51bGwsCiAgICAgIHNvdXJjZXNNYXBfOiBudWxsLAogICAgICBzb3VyY2VEZWx0YV86IG51bGwsCiAgICAgIHJ1bGU6IGZ1bmN0aW9uKGNvdW50LCBzb3VyY2VDb3VudCkgewogICAgICAgIHJldHVybiBjb3VudCA+IDA7CiAgICAgIH0sCiAgICAgIGVtaXRfcnVsZUNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJydWxlQ2hhbmdlZCIsICJvbGRSdWxlIiksCiAgICAgIGxpc3RlbjogewogICAgICAgIHNvdXJjZTogTUVSR0VfREFUQVNFVF9IQU5ETEVSLAogICAgICAgIHNvdXJjZVZhbHVlOiB7CiAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbihzZW5kZXIpIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmVTb3VyY2Uoc2VuZGVyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIFJlYWRPbmx5RGF0YXNldC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBzb3VyY2VzID0gdGhpcy5zb3VyY2VzOwogICAgICAgIHRoaXMuc291cmNlcyA9IFtdOwogICAgICAgIHRoaXMuc291cmNlc01hcF8gPSB7fTsKICAgICAgICB0aGlzLnNvdXJjZVZhbHVlc18gPSBbXTsKICAgICAgICBpZiAoc291cmNlcykgdGhpcy5zZXRTb3VyY2VzKHNvdXJjZXMpOwogICAgICB9LAogICAgICBzZXRSdWxlOiBmdW5jdGlvbihydWxlKSB7CiAgICAgICAgcnVsZSA9IGdldHRlcihydWxlIHx8IE1lcmdlLlVOSU9OKTsKICAgICAgICBpZiAodGhpcy5ydWxlICE9PSBydWxlKSB7CiAgICAgICAgICB2YXIgb2xkUnVsZSA9IHRoaXMucnVsZTsKICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICB0aGlzLmVtaXRfcnVsZUNoYW5nZWQob2xkUnVsZSk7CiAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFwcGx5UnVsZTogZnVuY3Rpb24oc2NvcGUpIHsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgcnVsZSA9IHRoaXMucnVsZTsKICAgICAgICB2YXIgc291cmNlQ291bnQgPSB0aGlzLnNvdXJjZXMubGVuZ3RoOwogICAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIG1lbWJlckNvdW50ZXI7CiAgICAgICAgdmFyIGlzTWVtYmVyOwogICAgICAgIHZhciBkZWx0YTsKICAgICAgICBpZiAoIXNjb3BlKSBzY29wZSA9IG1lbWJlck1hcDsKICAgICAgICBmb3IgKHZhciBvYmplY3RJZCBpbiBzY29wZSkgewogICAgICAgICAgbWVtYmVyQ291bnRlciA9IG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICBpc01lbWJlciA9IHNvdXJjZUNvdW50ICYmIG1lbWJlckNvdW50ZXIuY291bnQgJiYgcnVsZShtZW1iZXJDb3VudGVyLmNvdW50LCBzb3VyY2VDb3VudCk7CiAgICAgICAgICBpZiAoaXNNZW1iZXIgIT0gb2JqZWN0SWQgaW4gdGhpcy5pdGVtc18pIHsKICAgICAgICAgICAgaWYgKGlzTWVtYmVyKSBpbnNlcnRlZC5wdXNoKG1lbWJlckNvdW50ZXIub2JqZWN0KTsgZWxzZSBkZWxldGVkLnB1c2gobWVtYmVyQ291bnRlci5vYmplY3QpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1lbWJlckNvdW50ZXIuY291bnQgPT0gMCkgZGVsZXRlIG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgfQogICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICB9LAogICAgICBhZGREYXRhc2V0XzogZnVuY3Rpb24oZGF0YXNldCkgewogICAgICAgIHRoaXMuc291cmNlcy5wdXNoKGRhdGFzZXQpOwogICAgICAgIGlmICh0aGlzLmxpc3Rlbi5zb3VyY2UpIGRhdGFzZXQuYWRkSGFuZGxlcih0aGlzLmxpc3Rlbi5zb3VyY2UsIHRoaXMpOwogICAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICAgIGZvciAodmFyIG9iamVjdElkIGluIGRhdGFzZXQuaXRlbXNfKSB7CiAgICAgICAgICBpZiAobWVtYmVyTWFwW29iamVjdElkXSkgewogICAgICAgICAgICBtZW1iZXJNYXBbb2JqZWN0SWRdLmNvdW50Kys7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtZW1iZXJNYXBbb2JqZWN0SWRdID0gewogICAgICAgICAgICAgIGNvdW50OiAxLAogICAgICAgICAgICAgIG9iamVjdDogZGF0YXNldC5pdGVtc19bb2JqZWN0SWRdCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9LAogICAgICByZW1vdmVEYXRhc2V0XzogZnVuY3Rpb24oZGF0YXNldCkgewogICAgICAgIGJhc2lzLmFycmF5LnJlbW92ZSh0aGlzLnNvdXJjZXMsIGRhdGFzZXQpOwogICAgICAgIGlmICh0aGlzLmxpc3Rlbi5zb3VyY2UpIGRhdGFzZXQucmVtb3ZlSGFuZGxlcih0aGlzLmxpc3Rlbi5zb3VyY2UsIHRoaXMpOwogICAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICAgIGZvciAodmFyIG9iamVjdElkIGluIGRhdGFzZXQuaXRlbXNfKSBtZW1iZXJNYXBbb2JqZWN0SWRdLmNvdW50LS07CiAgICAgIH0sCiAgICAgIHVwZGF0ZURhdGFzZXRfOiBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICB2YXIgbWVyZ2UgPSB0aGlzLm93bmVyOwogICAgICAgIHZhciBzb3VyY2VzTWFwXyA9IG1lcmdlLnNvdXJjZXNNYXBfOwogICAgICAgIHZhciBkYXRhc2V0ID0gYmFzaXMuZGF0YS5yZXNvbHZlRGF0YXNldCh0aGlzLCBtZXJnZS51cGRhdGVEYXRhc2V0Xywgc291cmNlLCAiYWRhcHRlciIpOwogICAgICAgIHZhciBpbnNlcnRlZDsKICAgICAgICB2YXIgZGVsZXRlZDsKICAgICAgICB2YXIgZGVsdGE7CiAgICAgICAgaWYgKHRoaXMuZGF0YXNldCA9PT0gZGF0YXNldCkgcmV0dXJuOwogICAgICAgIGlmIChkYXRhc2V0KSB7CiAgICAgICAgICB2YXIgY291bnQgPSAoc291cmNlc01hcF9bZGF0YXNldC5iYXNpc09iamVjdElkXSB8fCAwKSArIDE7CiAgICAgICAgICBzb3VyY2VzTWFwX1tkYXRhc2V0LmJhc2lzT2JqZWN0SWRdID0gY291bnQ7CiAgICAgICAgICBpZiAoY291bnQgPT0gMSkgewogICAgICAgICAgICBtZXJnZS5hZGREYXRhc2V0XyhkYXRhc2V0KTsKICAgICAgICAgICAgaW5zZXJ0ZWQgPSBbIGRhdGFzZXQgXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuZGF0YXNldCkgewogICAgICAgICAgdmFyIGNvdW50ID0gKHNvdXJjZXNNYXBfW3RoaXMuZGF0YXNldC5iYXNpc09iamVjdElkXSB8fCAwKSAtIDE7CiAgICAgICAgICBzb3VyY2VzTWFwX1t0aGlzLmRhdGFzZXQuYmFzaXNPYmplY3RJZF0gPSBjb3VudDsKICAgICAgICAgIGlmIChjb3VudCA9PSAwKSB7CiAgICAgICAgICAgIG1lcmdlLnJlbW92ZURhdGFzZXRfKHRoaXMuZGF0YXNldCk7CiAgICAgICAgICAgIGRlbGV0ZWQgPSBbIHRoaXMuZGF0YXNldCBdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmRhdGFzZXQgPSBkYXRhc2V0OwogICAgICAgIG1lcmdlLmFwcGx5UnVsZSgpOwogICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgewogICAgICAgICAgdmFyIHNldFNvdXJjZXNUcmFuc2FjdGlvbiA9IG1lcmdlLnNvdXJjZURlbHRhXzsKICAgICAgICAgIGlmIChzZXRTb3VyY2VzVHJhbnNhY3Rpb24pIHsKICAgICAgICAgICAgaWYgKGRlbHRhLmluc2VydGVkKSBkZWx0YS5pbnNlcnRlZC5mb3JFYWNoKGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgICAgICAgIGlmICghYmFzaXMuYXJyYXkucmVtb3ZlKHRoaXMuZGVsZXRlZCwgc291cmNlKSkgYmFzaXMuYXJyYXkuYWRkKHRoaXMuaW5zZXJ0ZWQsIHNvdXJjZSk7CiAgICAgICAgICAgIH0sIHNldFNvdXJjZXNUcmFuc2FjdGlvbik7CiAgICAgICAgICAgIGlmIChkZWx0YS5kZWxldGVkKSBkZWx0YS5kZWxldGVkLmZvckVhY2goZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgICAgICAgaWYgKCFiYXNpcy5hcnJheS5yZW1vdmUodGhpcy5pbnNlcnRlZCwgc291cmNlKSkgYmFzaXMuYXJyYXkuYWRkKHRoaXMuZGVsZXRlZCwgc291cmNlKTsKICAgICAgICAgICAgfSwgc2V0U291cmNlc1RyYW5zYWN0aW9uKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1lcmdlLmVtaXRfc291cmNlc0NoYW5nZWQoZGVsdGEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIGdldFNvdXJjZVZhbHVlczogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc291cmNlVmFsdWVzXy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgcmV0dXJuIGl0ZW0uc291cmNlOwogICAgICAgIH0pOwogICAgICB9LAogICAgICBhZGRTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIGlmICghc291cmNlIHx8IHR5cGVvZiBzb3VyY2UgIT0gIm9iamVjdCIgJiYgdHlwZW9mIHNvdXJjZSAhPSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2Fybih0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSArICIuYWRkU291cmNlOiB2YWx1ZSBzaG91bGQgYmUgYSBkYXRhc2V0IGluc3RhbmNlIG9yIHRvIGJlIGFibGUgdG8gcmVzb2x2ZSBpbiBkYXRhc2V0Iik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmhhc1NvdXJjZShzb3VyY2UpKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2Fybih0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSArICIuYWRkU291cmNlOiB2YWx1ZSBpcyBhbHJlYWR5IGluIHNvdXJjZSBsaXN0Iik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBzb3VyY2VJbmZvID0gewogICAgICAgICAgb3duZXI6IHRoaXMsCiAgICAgICAgICBzb3VyY2U6IHNvdXJjZSwKICAgICAgICAgIGFkYXB0ZXI6IG51bGwsCiAgICAgICAgICBkYXRhc2V0OiBudWxsCiAgICAgICAgfTsKICAgICAgICB0aGlzLnNvdXJjZVZhbHVlc18ucHVzaChzb3VyY2VJbmZvKTsKICAgICAgICB0aGlzLnVwZGF0ZURhdGFzZXRfLmNhbGwoc291cmNlSW5mbywgc291cmNlKTsKICAgICAgICBpZiAodGhpcy5saXN0ZW4uc291cmNlVmFsdWUgJiYgc291cmNlIGluc3RhbmNlb2YgYmFzaXMuZXZlbnQuRW1pdHRlcikgc291cmNlLmFkZEhhbmRsZXIodGhpcy5saXN0ZW4uc291cmNlVmFsdWUsIHRoaXMpOwogICAgICB9LAogICAgICByZW1vdmVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBzb3VyY2VJbmZvOyBzb3VyY2VJbmZvID0gdGhpcy5zb3VyY2VWYWx1ZXNfW2ldOyBpKyspIGlmIChzb3VyY2VJbmZvLnNvdXJjZSA9PT0gc291cmNlKSB7CiAgICAgICAgICBpZiAodGhpcy5saXN0ZW4uc291cmNlVmFsdWUgJiYgc291cmNlIGluc3RhbmNlb2YgYmFzaXMuZXZlbnQuRW1pdHRlcikgc291cmNlLnJlbW92ZUhhbmRsZXIodGhpcy5saXN0ZW4uc291cmNlVmFsdWUsIHRoaXMpOwogICAgICAgICAgdGhpcy51cGRhdGVEYXRhc2V0Xy5jYWxsKHNvdXJjZUluZm8sIG51bGwpOwogICAgICAgICAgdGhpcy5zb3VyY2VWYWx1ZXNfLnNwbGljZShpLCAxKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgYmFzaXMuZGV2Lndhcm4odGhpcy5jb25zdHJ1Y3Rvci5jbGFzc05hbWUgKyAiLnJlbW92ZVNvdXJjZTogc291cmNlIHZhbHVlIGlzbid0IGZvdW5kIGluIHNvdXJjZSBsaXN0Iik7CiAgICAgIH0sCiAgICAgIGhhc1NvdXJjZTogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIHNvdXJjZUluZm87IHNvdXJjZUluZm8gPSB0aGlzLnNvdXJjZVZhbHVlc19baV07IGkrKykgaWYgKHNvdXJjZUluZm8uc291cmNlID09PSBzb3VyY2UpIHJldHVybiB0cnVlOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgc2V0U291cmNlczogZnVuY3Rpb24oc291cmNlcykgewogICAgICAgIHZhciBleGlzdHMgPSB0aGlzLnNvdXJjZVZhbHVlc18ubWFwKGZ1bmN0aW9uKHNvdXJjZUluZm8pIHsKICAgICAgICAgIHJldHVybiBzb3VyY2VJbmZvLnNvdXJjZTsKICAgICAgICB9KTsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICAgIHZhciBkZWx0YTsKICAgICAgICBpZiAoIXNvdXJjZXMpIHNvdXJjZXMgPSBbXTsKICAgICAgICB0aGlzLnNvdXJjZURlbHRhXyA9IHsKICAgICAgICAgIGluc2VydGVkOiBpbnNlcnRlZCwKICAgICAgICAgIGRlbGV0ZWQ6IGRlbGV0ZWQKICAgICAgICB9OwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc291cmNlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIHNvdXJjZSA9IHNvdXJjZXNbaV07CiAgICAgICAgICBpZiAoIWJhc2lzLmFycmF5LnJlbW92ZShleGlzdHMsIHNvdXJjZSkpIHRoaXMuYWRkU291cmNlKHNvdXJjZSk7CiAgICAgICAgfQogICAgICAgIGV4aXN0cy5mb3JFYWNoKHRoaXMucmVtb3ZlU291cmNlLCB0aGlzKTsKICAgICAgICB0aGlzLnNvdXJjZURlbHRhXyA9IG51bGw7CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfc291cmNlc0NoYW5nZWQoZGVsdGEpOwogICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXRTb3VyY2VzKCk7CiAgICAgICAgUmVhZE9ubHlEYXRhc2V0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5zb3VyY2VWYWx1ZXNfID0gbnVsbDsKICAgICAgICB0aGlzLnNvdXJjZXNNYXBfID0gbnVsbDsKICAgICAgICB0aGlzLnNvdXJjZURlbHRhXyA9IG51bGw7CiAgICAgICAgdGhpcy5zb3VyY2VzID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICBNZXJnZS5VTklPTiA9IE1lcmdlLnByb3RvdHlwZS5ydWxlOwogICAgTWVyZ2UuSU5URVJTRUNUSU9OID0gZnVuY3Rpb24oY291bnQsIHNvdXJjZUNvdW50KSB7CiAgICAgIHJldHVybiBjb3VudCA9PSBzb3VyY2VDb3VudDsKICAgIH07CiAgICBNZXJnZS5ESUZGRVJFTkNFID0gZnVuY3Rpb24oY291bnQsIHNvdXJjZUNvdW50KSB7CiAgICAgIHJldHVybiBjb3VudCA9PSAxOwogICAgfTsKICAgIE1lcmdlLk1PUkVfVEhBTl9PTkVfSU5DTFVERSA9IGZ1bmN0aW9uKGNvdW50LCBzb3VyY2VDb3VudCkgewogICAgICByZXR1cm4gc291cmNlQ291bnQgPT0gMSB8fCBjb3VudCA+IDE7CiAgICB9OwogICAgTWVyZ2UuQVRfTEVBU1RfT05FX0VYQ0xVREUgPSBmdW5jdGlvbihjb3VudCwgc291cmNlQ291bnQpIHsKICAgICAgcmV0dXJuIHNvdXJjZUNvdW50ID09IDEgfHwgY291bnQgPCBzb3VyY2VDb3VudDsKICAgIH07CiAgICB2YXIgZGF0YXNldEFic2VudEZpbHRlciA9IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuICF0aGlzLmhhcyhpdGVtKTsKICAgIH07CiAgICB2YXIgU1VCVFJBQ1REQVRBU0VUX01JTlVFTkRfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihkYXRhc2V0LCBkZWx0YSkgewogICAgICAgIGlmICghdGhpcy5zdWJ0cmFoZW5kKSByZXR1cm47CiAgICAgICAgdmFyIG5ld0RlbHRhID0gZ2V0RGVsdGEoZGVsdGEuaW5zZXJ0ZWQgJiYgZGVsdGEuaW5zZXJ0ZWQuZmlsdGVyKGRhdGFzZXRBYnNlbnRGaWx0ZXIsIHRoaXMuc3VidHJhaGVuZCksIGRlbHRhLmRlbGV0ZWQgJiYgZGVsdGEuZGVsZXRlZC5maWx0ZXIodGhpcy5oYXMsIHRoaXMpKTsKICAgICAgICBpZiAobmV3RGVsdGEpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQobmV3RGVsdGEpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMubWludWVuZEFkYXB0ZXJfKSB0aGlzLnNldE1pbnVlbmQobnVsbCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgU1VCVFJBQ1REQVRBU0VUX1NVQlRSQUhFTkRfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihkYXRhc2V0LCBkZWx0YSkgewogICAgICAgIGlmICghdGhpcy5taW51ZW5kKSByZXR1cm47CiAgICAgICAgdmFyIG5ld0RlbHRhID0gZ2V0RGVsdGEoZGVsdGEuZGVsZXRlZCAmJiBkZWx0YS5kZWxldGVkLmZpbHRlcih0aGlzLm1pbnVlbmQuaGFzLCB0aGlzLm1pbnVlbmQpLCBkZWx0YS5pbnNlcnRlZCAmJiBkZWx0YS5pbnNlcnRlZC5maWx0ZXIodGhpcy5oYXMsIHRoaXMpKTsKICAgICAgICBpZiAobmV3RGVsdGEpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQobmV3RGVsdGEpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuc3VidHJhaGVuZEFkYXB0ZXJfKSB0aGlzLnNldFN1YnRyYWhlbmQobnVsbCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgU3VidHJhY3QgPSBDbGFzcyhSZWFkT25seURhdGFzZXQsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlN1YnRyYWN0IiwKICAgICAgc3Vic2NyaWJlVG86IFNVQlNDUklQVElPTi5NSU5VRU5EICsgU1VCU0NSSVBUSU9OLlNVQlRSQUhFTkQsCiAgICAgIG1pbnVlbmQ6IG51bGwsCiAgICAgIG1pbnVlbmRBZGFwdGVyXzogbnVsbCwKICAgICAgZW1pdF9taW51ZW5kQ2hhbmdlZDogY3JlYXRlRXZlbnQoIm1pbnVlbmRDaGFuZ2VkIiwgIm9sZE1pbnVlbmQiKSwKICAgICAgc3VidHJhaGVuZDogbnVsbCwKICAgICAgc3VidHJhaGVuZEFkYXB0ZXJfOiBudWxsLAogICAgICBlbWl0X3N1YnRyYWhlbmRDaGFuZ2VkOiBjcmVhdGVFdmVudCgic3VidHJhaGVuZENoYW5nZWQiLCAib2xkU3VidHJhaGVuZCIpLAogICAgICBsaXN0ZW46IHsKICAgICAgICBtaW51ZW5kOiBTVUJUUkFDVERBVEFTRVRfTUlOVUVORF9IQU5ETEVSLAogICAgICAgIHN1YnRyYWhlbmQ6IFNVQlRSQUNUREFUQVNFVF9TVUJUUkFIRU5EX0hBTkRMRVIKICAgICAgfSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgUmVhZE9ubHlEYXRhc2V0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIG1pbnVlbmQgPSB0aGlzLm1pbnVlbmQ7CiAgICAgICAgdmFyIHN1YnRyYWhlbmQgPSB0aGlzLnN1YnRyYWhlbmQ7CiAgICAgICAgdGhpcy5taW51ZW5kID0gbnVsbDsKICAgICAgICB0aGlzLnN1YnRyYWhlbmQgPSBudWxsOwogICAgICAgIGlmIChtaW51ZW5kIHx8IHN1YnRyYWhlbmQpIHRoaXMuc2V0T3BlcmFuZHMobWludWVuZCwgc3VidHJhaGVuZCk7CiAgICAgIH0sCiAgICAgIHNldE9wZXJhbmRzOiBmdW5jdGlvbihtaW51ZW5kLCBzdWJ0cmFoZW5kKSB7CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIHZhciBvcGVyYW5kc0NoYW5nZWQgPSBmYWxzZTsKICAgICAgICBtaW51ZW5kID0gYmFzaXMuZGF0YS5yZXNvbHZlRGF0YXNldCh0aGlzLCB0aGlzLnNldE1pbnVlbmQsIG1pbnVlbmQsICJtaW51ZW5kQWRhcHRlcl8iKTsKICAgICAgICBzdWJ0cmFoZW5kID0gYmFzaXMuZGF0YS5yZXNvbHZlRGF0YXNldCh0aGlzLCB0aGlzLnNldFN1YnRyYWhlbmQsIHN1YnRyYWhlbmQsICJzdWJ0cmFoZW5kQWRhcHRlcl8iKTsKICAgICAgICB2YXIgb2xkTWludWVuZCA9IHRoaXMubWludWVuZDsKICAgICAgICB2YXIgb2xkU3VidHJhaGVuZCA9IHRoaXMuc3VidHJhaGVuZDsKICAgICAgICBpZiAob2xkTWludWVuZCAhPT0gbWludWVuZCkgewogICAgICAgICAgb3BlcmFuZHNDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgIHRoaXMubWludWVuZCA9IG1pbnVlbmQ7CiAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLm1pbnVlbmQ7CiAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgewogICAgICAgICAgICBpZiAob2xkTWludWVuZCkgb2xkTWludWVuZC5yZW1vdmVIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICBpZiAobWludWVuZCkgbWludWVuZC5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lbWl0X21pbnVlbmRDaGFuZ2VkKG9sZE1pbnVlbmQpOwogICAgICAgIH0KICAgICAgICBpZiAob2xkU3VidHJhaGVuZCAhPT0gc3VidHJhaGVuZCkgewogICAgICAgICAgb3BlcmFuZHNDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgIHRoaXMuc3VidHJhaGVuZCA9IHN1YnRyYWhlbmQ7CiAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLnN1YnRyYWhlbmQ7CiAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgewogICAgICAgICAgICBpZiAob2xkU3VidHJhaGVuZCkgb2xkU3VidHJhaGVuZC5yZW1vdmVIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICBpZiAoc3VidHJhaGVuZCkgc3VidHJhaGVuZC5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lbWl0X3N1YnRyYWhlbmRDaGFuZ2VkKG9sZFN1YnRyYWhlbmQpOwogICAgICAgIH0KICAgICAgICBpZiAoIW9wZXJhbmRzQ2hhbmdlZCkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmICghbWludWVuZCB8fCAhc3VidHJhaGVuZCkgewogICAgICAgICAgaWYgKHRoaXMuaXRlbUNvdW50KSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhID0gewogICAgICAgICAgICBkZWxldGVkOiB0aGlzLmdldEl0ZW1zKCkKICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5pdGVtc18pIGlmICghbWludWVuZC5pdGVtc19ba2V5XSB8fCBzdWJ0cmFoZW5kLml0ZW1zX1trZXldKSBkZWxldGVkLnB1c2godGhpcy5pdGVtc19ba2V5XSk7CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gbWludWVuZC5pdGVtc18pIGlmICghdGhpcy5pdGVtc19ba2V5XSAmJiAhc3VidHJhaGVuZC5pdGVtc19ba2V5XSkgaW5zZXJ0ZWQucHVzaChtaW51ZW5kLml0ZW1zX1trZXldKTsKICAgICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgfSwKICAgICAgc2V0TWludWVuZDogZnVuY3Rpb24obWludWVuZCkgewogICAgICAgIHJldHVybiB0aGlzLnNldE9wZXJhbmRzKG1pbnVlbmQsIHRoaXMuc3VidHJhaGVuZEFkYXB0ZXJfID8gdGhpcy5zdWJ0cmFoZW5kQWRhcHRlcl8uc291cmNlIDogdGhpcy5zdWJ0cmFoZW5kKTsKICAgICAgfSwKICAgICAgc2V0U3VidHJhaGVuZDogZnVuY3Rpb24oc3VidHJhaGVuZCkgewogICAgICAgIHJldHVybiB0aGlzLnNldE9wZXJhbmRzKHRoaXMubWludWVuZEFkYXB0ZXJfID8gdGhpcy5taW51ZW5kQWRhcHRlcl8uc291cmNlIDogdGhpcy5taW51ZW5kLCBzdWJ0cmFoZW5kKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXRPcGVyYW5kcygpOwogICAgICAgIFJlYWRPbmx5RGF0YXNldC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBTb3VyY2VEYXRhc2V0ID0gQ2xhc3MoUmVhZE9ubHlEYXRhc2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Tb3VyY2VEYXRhc2V0IiwKICAgICAgc3Vic2NyaWJlVG86IFNVQlNDUklQVElPTi5TT1VSQ0UsCiAgICAgIHNvdXJjZTogbnVsbCwKICAgICAgZW1pdF9zb3VyY2VDaGFuZ2VkOiBjcmVhdGVFdmVudCgic291cmNlQ2hhbmdlZCIsICJvbGRTb3VyY2UiKSwKICAgICAgc291cmNlQWRhcHRlcl86IG51bGwsCiAgICAgIHNvdXJjZU1hcF86IG51bGwsCiAgICAgIGxpc3RlbjogewogICAgICAgIHNvdXJjZTogewogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5zb3VyY2VBZGFwdGVyXykgdGhpcy5zZXRTb3VyY2UoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc291cmNlTWFwXyA9IHt9OwogICAgICAgIFJlYWRPbmx5RGF0YXNldC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBzb3VyY2UgPSB0aGlzLnNvdXJjZTsKICAgICAgICBpZiAoc291cmNlKSB7CiAgICAgICAgICB0aGlzLnNvdXJjZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnNldFNvdXJjZShzb3VyY2UpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0U291cmNlOiBmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgICBzb3VyY2UgPSBiYXNpcy5kYXRhLnJlc29sdmVEYXRhc2V0KHRoaXMsIHRoaXMuc2V0U291cmNlLCBzb3VyY2UsICJzb3VyY2VBZGFwdGVyXyIpOwogICAgICAgIGlmICh0aGlzLnNvdXJjZSAhPT0gc291cmNlKSB7CiAgICAgICAgICB2YXIgb2xkU291cmNlID0gdGhpcy5zb3VyY2U7CiAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLnNvdXJjZTsKICAgICAgICAgIHRoaXMuc291cmNlID0gc291cmNlOwogICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgICAgdmFyIGl0ZW1zQ2hhbmdlZEhhbmRsZXIgPSBsaXN0ZW5IYW5kbGVyLml0ZW1zQ2hhbmdlZDsKICAgICAgICAgICAgc2V0QWNjdW11bGF0ZVN0YXRlKHRydWUpOwogICAgICAgICAgICBpZiAob2xkU291cmNlKSB7CiAgICAgICAgICAgICAgb2xkU291cmNlLnJlbW92ZUhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKGl0ZW1zQ2hhbmdlZEhhbmRsZXIpIGl0ZW1zQ2hhbmdlZEhhbmRsZXIuY2FsbCh0aGlzLCBvbGRTb3VyY2UsIHsKICAgICAgICAgICAgICAgIGRlbGV0ZWQ6IG9sZFNvdXJjZS5nZXRJdGVtcygpCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgICAgICAgIHNvdXJjZS5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICAgIGlmIChpdGVtc0NoYW5nZWRIYW5kbGVyKSBpdGVtc0NoYW5nZWRIYW5kbGVyLmNhbGwodGhpcywgc291cmNlLCB7CiAgICAgICAgICAgICAgICBpbnNlcnRlZDogc291cmNlLmdldEl0ZW1zKCkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRBY2N1bXVsYXRlU3RhdGUoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5lbWl0X3NvdXJjZUNoYW5nZWQob2xkU291cmNlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2V0U291cmNlKCk7CiAgICAgICAgUmVhZE9ubHlEYXRhc2V0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5zb3VyY2VNYXBfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgTUFQRklMVEVSX1NPVVJDRU9CSkVDVF9VUERBVEUgPSBmdW5jdGlvbihzb3VyY2VPYmplY3QpIHsKICAgICAgdmFyIG5ld01lbWJlciA9IHRoaXMubWFwID8gdGhpcy5tYXAoc291cmNlT2JqZWN0KSA6IG9iamVjdDsKICAgICAgaWYgKG5ld01lbWJlciBpbnN0YW5jZW9mIERhdGFPYmplY3QgPT0gZmFsc2UgfHwgdGhpcy5maWx0ZXIobmV3TWVtYmVyKSkgbmV3TWVtYmVyID0gbnVsbDsKICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwX1tzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgIHZhciBjdXJNZW1iZXIgPSBzb3VyY2VNYXAubWVtYmVyOwogICAgICBpZiAoY3VyTWVtYmVyICE9PSBuZXdNZW1iZXIpIHsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgZGVsdGE7CiAgICAgICAgdmFyIGluc2VydGVkOwogICAgICAgIHZhciBkZWxldGVkOwogICAgICAgIHNvdXJjZU1hcC5tZW1iZXIgPSBuZXdNZW1iZXI7CiAgICAgICAgaWYgKGN1ck1lbWJlcikgewogICAgICAgICAgdmFyIGN1ck1lbWJlcklkID0gY3VyTWVtYmVyLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICBpZiAodGhpcy5yZW1vdmVNZW1iZXJSZWYpIHRoaXMucmVtb3ZlTWVtYmVyUmVmKGN1ck1lbWJlciwgc291cmNlT2JqZWN0KTsKICAgICAgICAgIGlmICgtLW1lbWJlck1hcFtjdXJNZW1iZXJJZF0gPT0gMCkgewogICAgICAgICAgICBkZWxldGUgbWVtYmVyTWFwW2N1ck1lbWJlcklkXTsKICAgICAgICAgICAgZGVsZXRlZCA9IFsgY3VyTWVtYmVyIF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChuZXdNZW1iZXIpIHsKICAgICAgICAgIHZhciBuZXdNZW1iZXJJZCA9IG5ld01lbWJlci5iYXNpc09iamVjdElkOwogICAgICAgICAgaWYgKHRoaXMuYWRkTWVtYmVyUmVmKSB0aGlzLmFkZE1lbWJlclJlZihuZXdNZW1iZXIsIHNvdXJjZU9iamVjdCk7CiAgICAgICAgICBpZiAobWVtYmVyTWFwW25ld01lbWJlcklkXSkgewogICAgICAgICAgICBtZW1iZXJNYXBbbmV3TWVtYmVySWRdKys7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtZW1iZXJNYXBbbmV3TWVtYmVySWRdID0gMTsKICAgICAgICAgICAgaW5zZXJ0ZWQgPSBbIG5ld01lbWJlciBdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsdGEgPSBnZXREZWx0YShpbnNlcnRlZCwgZGVsZXRlZCkpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEpOwogICAgICB9CiAgICB9OwogICAgdmFyIE1BUEZJTFRFUl9TT1VSQ0VfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihzb3VyY2UsIGRlbHRhKSB7CiAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwXzsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICAgIHZhciBzb3VyY2VPYmplY3Q7CiAgICAgICAgdmFyIHNvdXJjZU9iamVjdElkOwogICAgICAgIHZhciBtZW1iZXI7CiAgICAgICAgdmFyIHVwZGF0ZUhhbmRsZXIgPSB0aGlzLnJ1bGVFdmVudHM7CiAgICAgICAgc2V0QWNjdW11bGF0ZVN0YXRlKHRydWUpOwogICAgICAgIGlmIChkZWx0YS5pbnNlcnRlZCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNvdXJjZU9iamVjdCA9IGRlbHRhLmluc2VydGVkW2ldOyBpKyspIHsKICAgICAgICAgICAgbWVtYmVyID0gdGhpcy5tYXAgPyB0aGlzLm1hcChzb3VyY2VPYmplY3QpIDogc291cmNlT2JqZWN0OwogICAgICAgICAgICBpZiAobWVtYmVyIGluc3RhbmNlb2YgRGF0YU9iamVjdCA9PSBmYWxzZSB8fCB0aGlzLmZpbHRlcihtZW1iZXIpKSBtZW1iZXIgPSBudWxsOwogICAgICAgICAgICBpZiAodXBkYXRlSGFuZGxlcikgc291cmNlT2JqZWN0LmFkZEhhbmRsZXIodXBkYXRlSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgIHNvdXJjZU1hcFtzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZF0gPSB7CiAgICAgICAgICAgICAgc291cmNlT2JqZWN0OiBzb3VyY2VPYmplY3QsCiAgICAgICAgICAgICAgbWVtYmVyOiBtZW1iZXIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKG1lbWJlcikgewogICAgICAgICAgICAgIHZhciBtZW1iZXJJZCA9IG1lbWJlci5iYXNpc09iamVjdElkOwogICAgICAgICAgICAgIGlmIChtZW1iZXJNYXBbbWVtYmVySWRdKSB7CiAgICAgICAgICAgICAgICBtZW1iZXJNYXBbbWVtYmVySWRdKys7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1lbWJlck1hcFttZW1iZXJJZF0gPSAxOwogICAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChtZW1iZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodGhpcy5hZGRNZW1iZXJSZWYpIHRoaXMuYWRkTWVtYmVyUmVmKG1lbWJlciwgc291cmNlT2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsdGEuZGVsZXRlZCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNvdXJjZU9iamVjdCA9IGRlbHRhLmRlbGV0ZWRbaV07IGkrKykgewogICAgICAgICAgICBzb3VyY2VPYmplY3RJZCA9IHNvdXJjZU9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgICBtZW1iZXIgPSBzb3VyY2VNYXBbc291cmNlT2JqZWN0SWRdLm1lbWJlcjsKICAgICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5yZW1vdmVIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICBkZWxldGUgc291cmNlTWFwW3NvdXJjZU9iamVjdElkXTsKICAgICAgICAgICAgaWYgKG1lbWJlcikgewogICAgICAgICAgICAgIHZhciBtZW1iZXJJZCA9IG1lbWJlci5iYXNpc09iamVjdElkOwogICAgICAgICAgICAgIGlmICgtLW1lbWJlck1hcFttZW1iZXJJZF0gPT0gMCkgewogICAgICAgICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFttZW1iZXJJZF07CiAgICAgICAgICAgICAgICBkZWxldGVkLnB1c2gobWVtYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHRoaXMucmVtb3ZlTWVtYmVyUmVmKSB0aGlzLnJlbW92ZU1lbWJlclJlZihtZW1iZXIsIHNvdXJjZU9iamVjdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2V0QWNjdW11bGF0ZVN0YXRlKGZhbHNlKTsKICAgICAgICBpZiAoZGVsdGEgPSBnZXREZWx0YShpbnNlcnRlZCwgZGVsZXRlZCkpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEpOwogICAgICB9CiAgICB9OwogICAgdmFyIE1hcEZpbHRlciA9IENsYXNzKFNvdXJjZURhdGFzZXQsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLk1hcEZpbHRlciIsCiAgICAgIG1hcDogJHNlbGYsCiAgICAgIGZpbHRlcjogJGZhbHNlLAogICAgICBydWxlOiBnZXR0ZXIoJHRydWUpLAogICAgICBlbWl0X3J1bGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgicnVsZUNoYW5nZWQiLCAib2xkUnVsZSIpLAogICAgICBydWxlRXZlbnRzOiBjcmVhdGVSdWxlRXZlbnRzKE1BUEZJTFRFUl9TT1VSQ0VPQkpFQ1RfVVBEQVRFLCAidXBkYXRlIiksCiAgICAgIGFkZE1lbWJlclJlZjogbnVsbCwKICAgICAgcmVtb3ZlTWVtYmVyUmVmOiBudWxsLAogICAgICBsaXN0ZW46IHsKICAgICAgICBzb3VyY2U6IE1BUEZJTFRFUl9TT1VSQ0VfSEFORExFUgogICAgICB9LAogICAgICBzZXRNYXA6IGZ1bmN0aW9uKG1hcCkgewogICAgICAgIGlmICh0eXBlb2YgbWFwICE9ICJmdW5jdGlvbiIpIG1hcCA9ICRzZWxmOwogICAgICAgIGlmICh0aGlzLm1hcCAhPT0gbWFwKSB7CiAgICAgICAgICB0aGlzLm1hcCA9IG1hcDsKICAgICAgICAgIHJldHVybiB0aGlzLmFwcGx5UnVsZSgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0RmlsdGVyOiBmdW5jdGlvbihmaWx0ZXIpIHsKICAgICAgICBpZiAodHlwZW9mIGZpbHRlciAhPSAiZnVuY3Rpb24iKSBmaWx0ZXIgPSAkZmFsc2U7CiAgICAgICAgaWYgKHRoaXMuZmlsdGVyICE9PSBmaWx0ZXIpIHsKICAgICAgICAgIHRoaXMuZmlsdGVyID0gZmlsdGVyOwogICAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRSdWxlOiBmdW5jdGlvbihydWxlKSB7CiAgICAgICAgcnVsZSA9IGdldHRlcihydWxlIHx8ICR0cnVlKTsKICAgICAgICBpZiAodGhpcy5ydWxlICE9PSBydWxlKSB7CiAgICAgICAgICB2YXIgb2xkUnVsZSA9IHRoaXMucnVsZTsKICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICB0aGlzLmVtaXRfcnVsZUNoYW5nZWQob2xkUnVsZSk7CiAgICAgICAgICByZXR1cm4gdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFwcGx5UnVsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwXzsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgY3VyTWVtYmVyOwogICAgICAgIHZhciBuZXdNZW1iZXI7CiAgICAgICAgdmFyIGN1ck1lbWJlcklkOwogICAgICAgIHZhciBuZXdNZW1iZXJJZDsKICAgICAgICB2YXIgc291cmNlT2JqZWN0OwogICAgICAgIHZhciBzb3VyY2VPYmplY3RJbmZvOwogICAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGZvciAodmFyIHNvdXJjZU9iamVjdElkIGluIHNvdXJjZU1hcCkgewogICAgICAgICAgc291cmNlT2JqZWN0SW5mbyA9IHNvdXJjZU1hcFtzb3VyY2VPYmplY3RJZF07CiAgICAgICAgICBzb3VyY2VPYmplY3QgPSBzb3VyY2VPYmplY3RJbmZvLnNvdXJjZU9iamVjdDsKICAgICAgICAgIGN1ck1lbWJlciA9IHNvdXJjZU9iamVjdEluZm8ubWVtYmVyOwogICAgICAgICAgbmV3TWVtYmVyID0gdGhpcy5tYXAgPyB0aGlzLm1hcChzb3VyY2VPYmplY3QpIDogc291cmNlT2JqZWN0OwogICAgICAgICAgaWYgKG5ld01lbWJlciBpbnN0YW5jZW9mIERhdGFPYmplY3QgPT0gZmFsc2UgfHwgdGhpcy5maWx0ZXIobmV3TWVtYmVyKSkgbmV3TWVtYmVyID0gbnVsbDsKICAgICAgICAgIGlmIChjdXJNZW1iZXIgIT0gbmV3TWVtYmVyKSB7CiAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8ubWVtYmVyID0gbmV3TWVtYmVyOwogICAgICAgICAgICBpZiAoY3VyTWVtYmVyKSB7CiAgICAgICAgICAgICAgY3VyTWVtYmVySWQgPSBjdXJNZW1iZXIuYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgICBpZiAodGhpcy5yZW1vdmVNZW1iZXJSZWYpIHRoaXMucmVtb3ZlTWVtYmVyUmVmKGN1ck1lbWJlciwgc291cmNlT2JqZWN0KTsKICAgICAgICAgICAgICBtZW1iZXJNYXBbY3VyTWVtYmVySWRdLS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld01lbWJlcikgewogICAgICAgICAgICAgIG5ld01lbWJlcklkID0gbmV3TWVtYmVyLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgaWYgKHRoaXMuYWRkTWVtYmVyUmVmKSB0aGlzLmFkZE1lbWJlclJlZihuZXdNZW1iZXIsIHNvdXJjZU9iamVjdCk7CiAgICAgICAgICAgICAgaWYgKG5ld01lbWJlcklkIGluIG1lbWJlck1hcCkgewogICAgICAgICAgICAgICAgbWVtYmVyTWFwW25ld01lbWJlcklkXSsrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtZW1iZXJNYXBbbmV3TWVtYmVySWRdID0gMTsKICAgICAgICAgICAgICAgIGluc2VydGVkLnB1c2gobmV3TWVtYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChjdXJNZW1iZXJJZCBpbiB0aGlzLml0ZW1zXykgaWYgKG1lbWJlck1hcFtjdXJNZW1iZXJJZF0gPT0gMCkgewogICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFtjdXJNZW1iZXJJZF07CiAgICAgICAgICBkZWxldGVkLnB1c2godGhpcy5pdGVtc19bY3VyTWVtYmVySWRdKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhKTsKICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIEZpbHRlciA9IENsYXNzKE1hcEZpbHRlciwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRmlsdGVyIiwKICAgICAgZmlsdGVyOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gIXRoaXMucnVsZShvYmplY3QpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBTcGxpdCA9IENsYXNzKE1hcEZpbHRlciwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU3BsaXQiLAogICAgICBzdWJzZXRDbGFzczogUmVhZE9ubHlEYXRhc2V0LAogICAgICBzdWJzZXRXcmFwcGVyQ2xhc3M6IERhdGFzZXRXcmFwcGVyLAogICAgICBrZXlNYXA6IG51bGwsCiAgICAgIG1hcDogZnVuY3Rpb24oc291cmNlT2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLnJlc29sdmUoc291cmNlT2JqZWN0KTsKICAgICAgfSwKICAgICAgcnVsZTogZ2V0dGVyKCR1bmRlZiksCiAgICAgIHNldFJ1bGU6IGZ1bmN0aW9uKHJ1bGUpIHsKICAgICAgICBydWxlID0gZ2V0dGVyKHJ1bGUgfHwgJHVuZGVmKTsKICAgICAgICBpZiAodGhpcy5ydWxlICE9PSBydWxlKSB7CiAgICAgICAgICB2YXIgb2xkUnVsZSA9IHRoaXMucnVsZTsKICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICB0aGlzLmtleU1hcC5rZXlHZXR0ZXIgPSBydWxlOwogICAgICAgICAgdGhpcy5lbWl0X3J1bGVDaGFuZ2VkKG9sZFJ1bGUpOwogICAgICAgICAgcmV0dXJuIHRoaXMuYXBwbHlSdWxlKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBhZGRNZW1iZXJSZWY6IGZ1bmN0aW9uKHdyYXBwZXIsIHNvdXJjZU9iamVjdCkgewogICAgICAgIHdyYXBwZXIuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICBpbnNlcnRlZDogWyBzb3VyY2VPYmplY3QgXQogICAgICAgIH0pOwogICAgICB9LAogICAgICByZW1vdmVNZW1iZXJSZWY6IGZ1bmN0aW9uKHdyYXBwZXIsIHNvdXJjZU9iamVjdCkgewogICAgICAgIHdyYXBwZXIuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICBkZWxldGVkOiBbIHNvdXJjZU9iamVjdCBdCiAgICAgICAgfSk7CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy5rZXlNYXAgfHwgdGhpcy5rZXlNYXAgaW5zdGFuY2VvZiBLZXlPYmplY3RNYXAgPT0gZmFsc2UpIHRoaXMua2V5TWFwID0gY3JlYXRlS2V5TWFwKHRoaXMua2V5TWFwLCB0aGlzLnJ1bGUsIHRoaXMuc3Vic2V0V3JhcHBlckNsYXNzLCB0aGlzLnN1YnNldENsYXNzKTsKICAgICAgICBNYXBGaWx0ZXIucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgZ2V0U3Vic2V0OiBmdW5jdGlvbihkYXRhLCBhdXRvY3JlYXRlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLmdldChkYXRhLCBhdXRvY3JlYXRlKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgTWFwRmlsdGVyLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5rZXlNYXAuZGVzdHJveSgpOwogICAgICAgIHRoaXMua2V5TWFwID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBiaW5hcnlTZWFyY2hQb3MoYXJyYXksIG1hcCkgewogICAgICBpZiAoIWFycmF5Lmxlbmd0aCkgcmV0dXJuIDA7CiAgICAgIHZhciB2YWx1ZSA9IG1hcC52YWx1ZTsKICAgICAgdmFyIGlkID0gbWFwLm9iamVjdC5iYXNpc09iamVjdElkOwogICAgICB2YXIgY21wVmFsdWU7CiAgICAgIHZhciBjbXBJZDsKICAgICAgdmFyIHBvczsKICAgICAgdmFyIGl0ZW07CiAgICAgIHZhciBsID0gMDsKICAgICAgdmFyIHIgPSBhcnJheS5sZW5ndGggLSAxOwogICAgICBkbyB7CiAgICAgICAgcG9zID0gbCArIHIgPj4gMTsKICAgICAgICBpdGVtID0gYXJyYXlbcG9zXTsKICAgICAgICBjbXBWYWx1ZSA9IGl0ZW0udmFsdWU7CiAgICAgICAgaWYgKHZhbHVlIDwgY21wVmFsdWUpIHIgPSBwb3MgLSAxOyBlbHNlIGlmICh2YWx1ZSA+IGNtcFZhbHVlKSBsID0gcG9zICsgMTsgZWxzZSB7CiAgICAgICAgICBjbXBJZCA9IGl0ZW0ub2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICBpZiAoaWQgPCBjbXBJZCkgciA9IHBvcyAtIDE7IGVsc2UgaWYgKGlkID4gY21wSWQpIGwgPSBwb3MgKyAxOyBlbHNlIHJldHVybiBwb3M7CiAgICAgICAgfQogICAgICB9IHdoaWxlIChsIDw9IHIpOwogICAgICByZXR1cm4gcG9zICsgKGNtcFZhbHVlID09IHZhbHVlID8gY21wSWQgPCBpZCA6IGNtcFZhbHVlIDwgdmFsdWUpOwogICAgfQogICAgdmFyIFNMSUNFX1NPVVJDRU9CSkVDVF9VUERBVEUgPSBmdW5jdGlvbihzb3VyY2VPYmplY3QpIHsKICAgICAgdmFyIHNvdXJjZU9iamVjdEluZm8gPSB0aGlzLnNvdXJjZU1hcF9bc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdOwogICAgICB2YXIgbmV3VmFsdWUgPSB0aGlzLnJ1bGUoc291cmNlT2JqZWN0KTsKICAgICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleF87CiAgICAgIGlmIChuZXdWYWx1ZSAhPT0gc291cmNlT2JqZWN0SW5mby52YWx1ZSkgewogICAgICAgIHZhciBwb3MgPSBiaW5hcnlTZWFyY2hQb3MoaW5kZXgsIHNvdXJjZU9iamVjdEluZm8pOwogICAgICAgIHZhciBwcmV2ID0gaW5kZXhbcG9zIC0gMV07CiAgICAgICAgdmFyIG5leHQgPSBpbmRleFtwb3MgKyAxXTsKICAgICAgICBzb3VyY2VPYmplY3RJbmZvLnZhbHVlID0gbmV3VmFsdWU7CiAgICAgICAgaWYgKHByZXYgJiYgKHByZXYudmFsdWUgPiBuZXdWYWx1ZSB8fCBwcmV2LnZhbHVlID09IG5ld1ZhbHVlICYmIHByZXYub2JqZWN0LmJhc2lzT2JqZWN0SWQgPiBzb3VyY2VPYmplY3RJbmZvLm9iamVjdC5iYXNpc09iamVjdElkKSB8fCBuZXh0ICYmIChuZXh0LnZhbHVlIDwgbmV3VmFsdWUgfHwgbmV4dC52YWx1ZSA9PSBuZXdWYWx1ZSAmJiBuZXh0Lm9iamVjdC5iYXNpc09iamVjdElkIDwgc291cmNlT2JqZWN0SW5mby5vYmplY3QuYmFzaXNPYmplY3RJZCkpIHsKICAgICAgICAgIGluZGV4LnNwbGljZShwb3MsIDEpOwogICAgICAgICAgaW5kZXguc3BsaWNlKGJpbmFyeVNlYXJjaFBvcyhpbmRleCwgc291cmNlT2JqZWN0SW5mbyksIDAsIHNvdXJjZU9iamVjdEluZm8pOwogICAgICAgICAgdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBmdW5jdGlvbiBzbGljZUluZGV4U29ydChhLCBiKSB7CiAgICAgIHJldHVybiArKGEudmFsdWUgPiBiLnZhbHVlKSB8fCAtKGEudmFsdWUgPCBiLnZhbHVlKSB8fCBhLm9iamVjdC5iYXNpc09iamVjdElkIC0gYi5vYmplY3QuYmFzaXNPYmplY3RJZDsKICAgIH0KICAgIHZhciBTTElDRV9TT1VSQ0VfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihzb3VyY2UsIGRlbHRhKSB7CiAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwXzsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmluZGV4XzsKICAgICAgICB2YXIgdXBkYXRlSGFuZGxlciA9IHRoaXMucnVsZUV2ZW50czsKICAgICAgICB2YXIgZHJvcEluZGV4ID0gZmFsc2U7CiAgICAgICAgdmFyIGJ1aWxkSW5kZXggPSBmYWxzZTsKICAgICAgICB2YXIgc291cmNlT2JqZWN0SW5mbzsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBkZWx0YS5pbnNlcnRlZDsKICAgICAgICB2YXIgZGVsZXRlZCA9IGRlbHRhLmRlbGV0ZWQ7CiAgICAgICAgaWYgKGRlbGV0ZWQpIHsKICAgICAgICAgIGlmIChkZWxldGVkLmxlbmd0aCA+IGluZGV4Lmxlbmd0aCAtIGRlbGV0ZWQubGVuZ3RoKSB7CiAgICAgICAgICAgIGRyb3BJbmRleCA9IHRydWU7CiAgICAgICAgICAgIGJ1aWxkSW5kZXggPSBkZWxldGVkLmxlbmd0aCAhPSBpbmRleC5sZW5ndGg7CiAgICAgICAgICAgIGluZGV4Lmxlbmd0aCA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgc291cmNlT2JqZWN0OyBzb3VyY2VPYmplY3QgPSBkZWxldGVkW2ldOyBpKyspIHsKICAgICAgICAgICAgaWYgKCFkcm9wSW5kZXgpIHsKICAgICAgICAgICAgICBzb3VyY2VPYmplY3RJbmZvID0gc291cmNlTWFwW3NvdXJjZU9iamVjdC5iYXNpc09iamVjdElkXTsKICAgICAgICAgICAgICBpbmRleC5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKGluZGV4LCBzb3VyY2VPYmplY3RJbmZvKSwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIHNvdXJjZU1hcFtzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgICAgICAgIGlmICh1cGRhdGVIYW5kbGVyKSBzb3VyY2VPYmplY3QucmVtb3ZlSGFuZGxlcih1cGRhdGVIYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChidWlsZEluZGV4KSBmb3IgKHZhciBrZXkgaW4gc291cmNlTWFwKSB7CiAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8gPSBzb3VyY2VNYXBba2V5XTsKICAgICAgICAgICAgaW5kZXguc3BsaWNlKGJpbmFyeVNlYXJjaFBvcyhpbmRleCwgc291cmNlT2JqZWN0SW5mbyksIDAsIHNvdXJjZU9iamVjdEluZm8pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaW5zZXJ0ZWQpIHsKICAgICAgICAgIGJ1aWxkSW5kZXggPSAhaW5kZXgubGVuZ3RoOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHNvdXJjZU9iamVjdDsgc291cmNlT2JqZWN0ID0gaW5zZXJ0ZWRbaV07IGkrKykgewogICAgICAgICAgICBzb3VyY2VPYmplY3RJbmZvID0gewogICAgICAgICAgICAgIG9iamVjdDogc291cmNlT2JqZWN0LAogICAgICAgICAgICAgIHZhbHVlOiB0aGlzLnJ1bGUoc291cmNlT2JqZWN0KQogICAgICAgICAgICB9OwogICAgICAgICAgICBzb3VyY2VNYXBbc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdID0gc291cmNlT2JqZWN0SW5mbzsKICAgICAgICAgICAgaWYgKCFidWlsZEluZGV4KSBpbmRleC5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKGluZGV4LCBzb3VyY2VPYmplY3RJbmZvKSwgMCwgc291cmNlT2JqZWN0SW5mbyk7IGVsc2UgaW5kZXgucHVzaChzb3VyY2VPYmplY3RJbmZvKTsKICAgICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5hZGRIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGJ1aWxkSW5kZXgpIGluZGV4LnNvcnQoc2xpY2VJbmRleFNvcnQpOwogICAgICAgIH0KICAgICAgICB0aGlzLmFwcGx5UnVsZSgpOwogICAgICB9CiAgICB9OwogICAgdmFyIFNsaWNlID0gQ2xhc3MoU291cmNlRGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU2xpY2UiLAogICAgICBydWxlOiBnZXR0ZXIoJHRydWUpLAogICAgICBlbWl0X3J1bGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgicnVsZUNoYW5nZWQiLCAib2xkUnVsZSIsICJvbGRPcmRlckRlc2MiKSwKICAgICAgcnVsZUV2ZW50czogY3JlYXRlUnVsZUV2ZW50cyhTTElDRV9TT1VSQ0VPQkpFQ1RfVVBEQVRFLCAidXBkYXRlIiksCiAgICAgIGluZGV4XzogbnVsbCwKICAgICAgb3JkZXJEZXNjOiBmYWxzZSwKICAgICAgb2Zmc2V0OiAwLAogICAgICBsaW1pdDogMTAsCiAgICAgIGxpc3RlbjogewogICAgICAgIHNvdXJjZTogU0xJQ0VfU09VUkNFX0hBTkRMRVIKICAgICAgfSwKICAgICAgZW1pdF9yYW5nZUNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJyYW5nZUNoYW5nZWQiLCAib2xkT2Zmc2V0IiwgIm9sZExpbWl0IiksCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaW5kZXhfID0gW107CiAgICAgICAgU291cmNlRGF0YXNldC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBzZXRSYW5nZTogZnVuY3Rpb24ob2Zmc2V0LCBsaW1pdCkgewogICAgICAgIHZhciBvbGRPZmZzZXQgPSB0aGlzLm9mZnNldDsKICAgICAgICB2YXIgb2xkTGltaXQgPSB0aGlzLmxpbWl0OwogICAgICAgIHZhciBkZWx0YSA9IGZhbHNlOwogICAgICAgIGlmIChvbGRPZmZzZXQgIT0gb2Zmc2V0IHx8IG9sZExpbWl0ICE9IGxpbWl0KSB7CiAgICAgICAgICB0aGlzLm9mZnNldCA9IG9mZnNldDsKICAgICAgICAgIHRoaXMubGltaXQgPSBsaW1pdDsKICAgICAgICAgIGRlbHRhID0gdGhpcy5hcHBseVJ1bGUoKTsKICAgICAgICAgIHRoaXMuZW1pdF9yYW5nZUNoYW5nZWQob2xkT2Zmc2V0LCBvbGRMaW1pdCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgfSwKICAgICAgc2V0T2Zmc2V0OiBmdW5jdGlvbihvZmZzZXQpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRSYW5nZShvZmZzZXQsIHRoaXMubGltaXQpOwogICAgICB9LAogICAgICBzZXRMaW1pdDogZnVuY3Rpb24obGltaXQpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRSYW5nZSh0aGlzLm9mZnNldCwgbGltaXQpOwogICAgICB9LAogICAgICBzZXRSdWxlOiBmdW5jdGlvbihydWxlLCBvcmRlckRlc2MpIHsKICAgICAgICBydWxlID0gZ2V0dGVyKHJ1bGUgfHwgJHRydWUpOwogICAgICAgIG9yZGVyRGVzYyA9ICEhb3JkZXJEZXNjOwogICAgICAgIGlmICh0aGlzLnJ1bGUgIT0gcnVsZSB8fCB0aGlzLm9yZGVyRGVzYyAhPSBvcmRlckRlc2MpIHsKICAgICAgICAgIHZhciBvbGRSdWxlID0gdGhpcy5ydWxlOwogICAgICAgICAgdmFyIG9sZE9yZGVyRGVzYyA9IHRoaXMub3JkZXJEZXNjOwogICAgICAgICAgaWYgKHRoaXMucnVsZSAhPSBydWxlKSB7CiAgICAgICAgICAgIHZhciBpbmRleCA9IHRoaXMuaW5kZXhfOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluZGV4Lmxlbmd0aDsgaSsrKSBpbmRleFtpXS52YWx1ZSA9IHJ1bGUoaW5kZXhbaV0ub2JqZWN0KTsKICAgICAgICAgICAgaW5kZXguc29ydChzbGljZUluZGV4U29ydCk7CiAgICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLm9yZGVyRGVzYyA9IG9yZGVyRGVzYzsKICAgICAgICAgIHRoaXMucnVsZSA9IHJ1bGU7CiAgICAgICAgICB0aGlzLmVtaXRfcnVsZUNoYW5nZWQob2xkUnVsZSwgb2xkT3JkZXJEZXNjKTsKICAgICAgICAgIHJldHVybiB0aGlzLmFwcGx5UnVsZSgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYXBwbHlSdWxlOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc3RhcnQgPSB0aGlzLm9mZnNldDsKICAgICAgICB2YXIgZW5kID0gc3RhcnQgKyB0aGlzLmxpbWl0OwogICAgICAgIGlmICh0aGlzLm9yZGVyRGVzYykgewogICAgICAgICAgc3RhcnQgPSB0aGlzLmluZGV4Xy5sZW5ndGggLSBlbmQ7CiAgICAgICAgICBlbmQgPSBzdGFydCArIHRoaXMubGltaXQ7CiAgICAgICAgfQogICAgICAgIHZhciBjdXJTZXQgPSBiYXNpcy5vYmplY3Quc2xpY2UodGhpcy5tZW1iZXJzXyk7CiAgICAgICAgdmFyIG5ld1NldCA9IHRoaXMuaW5kZXhfLnNsaWNlKE1hdGgubWF4KDAsIHN0YXJ0KSwgTWF0aC5tYXgoMCwgZW5kKSk7CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gbmV3U2V0W2ldOyBpKyspIHsKICAgICAgICAgIHZhciBvYmplY3RJZCA9IGl0ZW0ub2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICBpZiAoY3VyU2V0W29iamVjdElkXSkgZGVsZXRlIGN1clNldFtvYmplY3RJZF07IGVsc2UgewogICAgICAgICAgICBpbnNlcnRlZC5wdXNoKGl0ZW0ub2JqZWN0KTsKICAgICAgICAgICAgdGhpcy5tZW1iZXJzX1tvYmplY3RJZF0gPSBpdGVtLm9iamVjdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgb2JqZWN0SWQgaW4gY3VyU2V0KSBkZWxldGUgdGhpcy5tZW1iZXJzX1tvYmplY3RJZF07CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIHZhbHVlcyhjdXJTZXQpKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBTb3VyY2VEYXRhc2V0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5pbmRleF8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBDTE9VRF9TT1VSQ0VPQkpFQ1RfVVBEQVRFID0gZnVuY3Rpb24oc291cmNlT2JqZWN0KSB7CiAgICAgIHZhciBzb3VyY2VNYXAgPSB0aGlzLnNvdXJjZU1hcF87CiAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICB2YXIgc291cmNlT2JqZWN0SWQgPSBzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgdmFyIG9sZExpc3QgPSBzb3VyY2VNYXBbc291cmNlT2JqZWN0SWRdLmxpc3Q7CiAgICAgIHZhciBuZXdMaXN0ID0gc291cmNlTWFwW3NvdXJjZU9iamVjdElkXS5saXN0ID0ge307CiAgICAgIHZhciBsaXN0ID0gdGhpcy5ydWxlKHNvdXJjZU9iamVjdCk7CiAgICAgIHZhciBkZWx0YTsKICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgIHZhciBzdWJzZXQ7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGxpc3QpKSBmb3IgKHZhciBqID0gMDsgaiA8IGxpc3QubGVuZ3RoOyBqKyspIHsKICAgICAgICBzdWJzZXQgPSB0aGlzLmtleU1hcC5nZXQobGlzdFtqXSwgdHJ1ZSk7CiAgICAgICAgaWYgKHN1YnNldCAmJiAhc3Vic2V0Lmhhcyhzb3VyY2VPYmplY3QpKSB7CiAgICAgICAgICBzdWJzZXRJZCA9IHN1YnNldC5iYXNpc09iamVjdElkOwogICAgICAgICAgbmV3TGlzdFtzdWJzZXRJZF0gPSBzdWJzZXQ7CiAgICAgICAgICBpZiAoIW9sZExpc3Rbc3Vic2V0SWRdKSB7CiAgICAgICAgICAgIHN1YnNldC5kYXRhc2V0LmVtaXRfaXRlbXNDaGFuZ2VkKHsKICAgICAgICAgICAgICBpbnNlcnRlZDogWyBzb3VyY2VPYmplY3QgXQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKCFtZW1iZXJNYXBbc3Vic2V0SWRdKSB7CiAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChzdWJzZXQpOwogICAgICAgICAgICAgIG1lbWJlck1hcFtzdWJzZXRJZF0gPSAxOwogICAgICAgICAgICB9IGVsc2UgbWVtYmVyTWFwW3N1YnNldElkXSsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKHZhciBzdWJzZXRJZCBpbiBvbGRMaXN0KSBpZiAoIW5ld0xpc3Rbc3Vic2V0SWRdKSB7CiAgICAgICAgdmFyIHN1YnNldCA9IG9sZExpc3Rbc3Vic2V0SWRdOwogICAgICAgIHN1YnNldC5kYXRhc2V0LmVtaXRfaXRlbXNDaGFuZ2VkKHsKICAgICAgICAgIGRlbGV0ZWQ6IFsgc291cmNlT2JqZWN0IF0KICAgICAgICB9KTsKICAgICAgICBpZiAoIS0tbWVtYmVyTWFwW3N1YnNldElkXSkgewogICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFtzdWJzZXRJZF07CiAgICAgICAgICBkZWxldGVkLnB1c2goc3Vic2V0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEoaW5zZXJ0ZWQsIGRlbGV0ZWQpKSB0aGlzLmVtaXRfaXRlbXNDaGFuZ2VkKGRlbHRhKTsKICAgIH07CiAgICB2YXIgQ0xPVURfU09VUkNFX0hBTkRMRVIgPSB7CiAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24oZGF0YXNldCwgZGVsdGEpIHsKICAgICAgICB2YXIgc291cmNlTWFwID0gdGhpcy5zb3VyY2VNYXBfOwogICAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICAgIHZhciB1cGRhdGVIYW5kbGVyID0gdGhpcy5ydWxlRXZlbnRzOwogICAgICAgIHZhciBhcnJheTsKICAgICAgICB2YXIgc3Vic2V0OwogICAgICAgIHZhciBzdWJzZXRJZDsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICAgIHNldEFjY3VtdWxhdGVTdGF0ZSh0cnVlKTsKICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5pbnNlcnRlZCkgZm9yICh2YXIgaSA9IDAsIHNvdXJjZU9iamVjdDsgc291cmNlT2JqZWN0ID0gYXJyYXlbaV07IGkrKykgewogICAgICAgICAgdmFyIGxpc3QgPSB0aGlzLnJ1bGUoc291cmNlT2JqZWN0KTsKICAgICAgICAgIHZhciBzb3VyY2VPYmplY3RJbmZvID0gewogICAgICAgICAgICBvYmplY3Q6IHNvdXJjZU9iamVjdCwKICAgICAgICAgICAgbGlzdDoge30KICAgICAgICAgIH07CiAgICAgICAgICBzb3VyY2VNYXBbc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdID0gc291cmNlT2JqZWN0SW5mbzsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGxpc3QpKSBmb3IgKHZhciBqID0gMCwgZHVwRmlsdGVyID0ge307IGogPCBsaXN0Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgIHN1YnNldCA9IHRoaXMua2V5TWFwLmdldChsaXN0W2pdLCB0cnVlKTsKICAgICAgICAgICAgaWYgKHN1YnNldCAmJiAhZHVwRmlsdGVyW3N1YnNldC5iYXNpc09iamVjdElkXSkgewogICAgICAgICAgICAgIHN1YnNldElkID0gc3Vic2V0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgZHVwRmlsdGVyW3N1YnNldElkXSA9IHRydWU7CiAgICAgICAgICAgICAgc291cmNlT2JqZWN0SW5mby5saXN0W3N1YnNldElkXSA9IHN1YnNldDsKICAgICAgICAgICAgICBzdWJzZXQuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgICAgICBpbnNlcnRlZDogWyBzb3VyY2VPYmplY3QgXQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICghbWVtYmVyTWFwW3N1YnNldElkXSkgewogICAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChzdWJzZXQpOwogICAgICAgICAgICAgICAgbWVtYmVyTWFwW3N1YnNldElkXSA9IDE7CiAgICAgICAgICAgICAgfSBlbHNlIG1lbWJlck1hcFtzdWJzZXRJZF0rKzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5hZGRIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5kZWxldGVkKSBmb3IgKHZhciBpID0gMCwgc291cmNlT2JqZWN0OyBzb3VyY2VPYmplY3QgPSBhcnJheVtpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgc291cmNlT2JqZWN0SWQgPSBzb3VyY2VPYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgIHZhciBsaXN0ID0gc291cmNlTWFwW3NvdXJjZU9iamVjdElkXS5saXN0OwogICAgICAgICAgZGVsZXRlIHNvdXJjZU1hcFtzb3VyY2VPYmplY3RJZF07CiAgICAgICAgICBmb3IgKHZhciBzdWJzZXRJZCBpbiBsaXN0KSB7CiAgICAgICAgICAgIHN1YnNldCA9IGxpc3Rbc3Vic2V0SWRdOwogICAgICAgICAgICBzdWJzZXQuZGF0YXNldC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgICAgZGVsZXRlZDogWyBzb3VyY2VPYmplY3QgXQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKCEtLW1lbWJlck1hcFtzdWJzZXRJZF0pIHsKICAgICAgICAgICAgICBkZWxldGUgbWVtYmVyTWFwW3N1YnNldElkXTsKICAgICAgICAgICAgICBkZWxldGVkLnB1c2goc3Vic2V0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHVwZGF0ZUhhbmRsZXIpIHNvdXJjZU9iamVjdC5yZW1vdmVIYW5kbGVyKHVwZGF0ZUhhbmRsZXIsIHRoaXMpOwogICAgICAgIH0KICAgICAgICBzZXRBY2N1bXVsYXRlU3RhdGUoZmFsc2UpOwogICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgQ2xvdWQgPSBDbGFzcyhTb3VyY2VEYXRhc2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5DbG91ZCIsCiAgICAgIHN1YnNldENsYXNzOiBSZWFkT25seURhdGFzZXQsCiAgICAgIHN1YnNldFdyYXBwZXJDbGFzczogRGF0YXNldFdyYXBwZXIsCiAgICAgIHJ1bGU6IGdldHRlcigkdW5kZWYpLAogICAgICBydWxlRXZlbnRzOiBjcmVhdGVSdWxlRXZlbnRzKENMT1VEX1NPVVJDRU9CSkVDVF9VUERBVEUsICJ1cGRhdGUiKSwKICAgICAga2V5TWFwOiBudWxsLAogICAgICBtYXA6ICRzZWxmLAogICAgICBsaXN0ZW46IHsKICAgICAgICBzb3VyY2U6IENMT1VEX1NPVVJDRV9IQU5ETEVSCiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy5rZXlNYXAgfHwgdGhpcy5rZXlNYXAgaW5zdGFuY2VvZiBLZXlPYmplY3RNYXAgPT0gZmFsc2UpIHRoaXMua2V5TWFwID0gY3JlYXRlS2V5TWFwKHRoaXMua2V5TWFwLCB0aGlzLnJ1bGUsIHRoaXMuc3Vic2V0V3JhcHBlckNsYXNzLCB0aGlzLnN1YnNldENsYXNzKTsKICAgICAgICBTb3VyY2VEYXRhc2V0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGdldFN1YnNldDogZnVuY3Rpb24oZGF0YSwgYXV0b2NyZWF0ZSkgewogICAgICAgIHJldHVybiB0aGlzLmtleU1hcC5nZXQoZGF0YSwgYXV0b2NyZWF0ZSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIFNvdXJjZURhdGFzZXQucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmtleU1hcC5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5rZXlNYXAgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBFWFRSQUNUX1NPVVJDRU9CSkVDVF9VUERBVEUgPSBmdW5jdGlvbihzb3VyY2VPYmplY3QpIHsKICAgICAgdmFyIHNvdXJjZU9iamVjdEluZm8gPSB0aGlzLnNvdXJjZU1hcF9bc291cmNlT2JqZWN0LmJhc2lzT2JqZWN0SWRdOwogICAgICB2YXIgbmV3VmFsdWUgPSB0aGlzLnJ1bGUoc291cmNlT2JqZWN0KSB8fCBudWxsOwogICAgICB2YXIgb2xkVmFsdWUgPSBzb3VyY2VPYmplY3RJbmZvLnZhbHVlOwogICAgICB2YXIgaW5zZXJ0ZWQ7CiAgICAgIHZhciBkZWxldGVkOwogICAgICB2YXIgZGVsdGE7CiAgICAgIGlmIChuZXdWYWx1ZSA9PT0gb2xkVmFsdWUpIHJldHVybjsKICAgICAgaWYgKG5ld1ZhbHVlIGluc3RhbmNlb2YgRGF0YU9iamVjdCB8fCBuZXdWYWx1ZSBpbnN0YW5jZW9mIFJlYWRPbmx5RGF0YXNldCkgaW5zZXJ0ZWQgPSBhZGRUb0V4dHJhY3QodGhpcywgbmV3VmFsdWUsIHNvdXJjZU9iamVjdCk7CiAgICAgIGlmIChvbGRWYWx1ZSkgZGVsZXRlZCA9IHJlbW92ZUZyb21FeHRyYWN0KHRoaXMsIG9sZFZhbHVlLCBzb3VyY2VPYmplY3QpOwogICAgICBzb3VyY2VPYmplY3RJbmZvLnZhbHVlID0gbmV3VmFsdWU7CiAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICB9OwogICAgdmFyIEVYVFJBQ1RfREFUQVNFVF9JVEVNU0NIQU5HRUQgPSBmdW5jdGlvbihkYXRhc2V0LCBkZWx0YSkgewogICAgICB2YXIgaW5zZXJ0ZWQgPSBkZWx0YS5pbnNlcnRlZDsKICAgICAgdmFyIGRlbGV0ZWQgPSBkZWx0YS5kZWxldGVkOwogICAgICB2YXIgZGVsdGE7CiAgICAgIGlmIChpbnNlcnRlZCkgaW5zZXJ0ZWQgPSBhZGRUb0V4dHJhY3QodGhpcywgaW5zZXJ0ZWQsIGRhdGFzZXQpOwogICAgICBpZiAoZGVsZXRlZCkgZGVsZXRlZCA9IHJlbW92ZUZyb21FeHRyYWN0KHRoaXMsIGRlbGV0ZWQsIGRhdGFzZXQpOwogICAgICBpZiAoZGVsdGEgPSBnZXREZWx0YShpbnNlcnRlZCwgZGVsZXRlZCkpIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEpOwogICAgfTsKICAgIHZhciBFWFRSQUNUX0RBVEFTRVRfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBFWFRSQUNUX0RBVEFTRVRfSVRFTVNDSEFOR0VELAogICAgICBkZXN0cm95OiBmdW5jdGlvbihkYXRhc2V0KSB7CiAgICAgICAgdmFyIHNvdXJjZU1hcCA9IHRoaXMuc291cmNlTWFwXzsKICAgICAgICBmb3IgKHZhciBjdXJzb3IgPSBzb3VyY2VNYXBbZGF0YXNldC5iYXNpc09iamVjdElkXTsgY3Vyc29yID0gY3Vyc29yLnJlZjsgKSBzb3VyY2VNYXBbY3Vyc29yLm9iamVjdC5iYXNpc09iamVjdElkXS52YWx1ZSA9IG51bGw7CiAgICAgICAgZGVsZXRlIHNvdXJjZU1hcFtkYXRhc2V0LmJhc2lzT2JqZWN0SWRdOwogICAgICB9CiAgICB9OwogICAgZnVuY3Rpb24gaGFzRXh0cmFjdFNvdXJjZVJlZihleHRyYWN0LCBvYmplY3QsIG1hcmtlcikgewogICAgICB2YXIgc291cmNlT2JqZWN0SW5mbyA9IGV4dHJhY3Quc291cmNlTWFwX1tvYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgIGlmIChzb3VyY2VPYmplY3RJbmZvICYmIHNvdXJjZU9iamVjdEluZm8udmlzaXRlZCAhPT0gbWFya2VyKSB7CiAgICAgICAgZm9yICh2YXIgY3Vyc29yID0gc291cmNlT2JqZWN0SW5mbzsgY3Vyc29yID0gY3Vyc29yLnJlZjsgKSBpZiAoY3Vyc29yLm9iamVjdCA9PT0gZXh0cmFjdC5zb3VyY2UpIHJldHVybiB0cnVlOwogICAgICAgIHNvdXJjZU9iamVjdEluZm8udmlzaXRlZCA9IG1hcmtlcjsKICAgICAgICBmb3IgKHZhciBjdXJzb3IgPSBzb3VyY2VPYmplY3RJbmZvOyBjdXJzb3IgPSBjdXJzb3IucmVmOyApIGlmIChoYXNFeHRyYWN0U291cmNlUmVmKGV4dHJhY3QsIGN1cnNvci5vYmplY3QsIG1hcmtlciB8fCB7fSkpIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGRUb0V4dHJhY3QoZXh0cmFjdCwgaXRlbXMsIHJlZikgewogICAgICB2YXIgc291cmNlTWFwID0gZXh0cmFjdC5zb3VyY2VNYXBfOwogICAgICB2YXIgbWVtYmVycyA9IGV4dHJhY3QubWVtYmVyc187CiAgICAgIHZhciBxdWV1ZSA9IGFycmF5RnJvbShpdGVtcyk7CiAgICAgIHZhciBpbnNlcnRlZCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGl0ZW0gPSBxdWV1ZVtpXTsKICAgICAgICB2YXIgc291cmNlT2JqZWN0SWQgPSBpdGVtLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgaWYgKCFzb3VyY2VPYmplY3RJZCkgewogICAgICAgICAgcmVmID0gaXRlbS5yZWY7CiAgICAgICAgICBpdGVtID0gaXRlbS5vYmplY3Q7CiAgICAgICAgICBzb3VyY2VPYmplY3RJZCA9IGl0ZW0uYmFzaXNPYmplY3RJZDsKICAgICAgICB9CiAgICAgICAgdmFyIHNvdXJjZU9iamVjdEluZm8gPSBzb3VyY2VNYXBbc291cmNlT2JqZWN0SWRdOwogICAgICAgIGlmIChzb3VyY2VPYmplY3RJbmZvKSB7CiAgICAgICAgICBzb3VyY2VPYmplY3RJbmZvLnJlZiA9IHsKICAgICAgICAgICAgb2JqZWN0OiByZWYsCiAgICAgICAgICAgIHJlZjogc291cmNlT2JqZWN0SW5mby5yZWYKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8gPSBzb3VyY2VNYXBbc291cmNlT2JqZWN0SWRdID0gewogICAgICAgICAgICBzb3VyY2U6IGl0ZW0sCiAgICAgICAgICAgIHJlZjogewogICAgICAgICAgICAgIG9iamVjdDogcmVmLAogICAgICAgICAgICAgIHJlZjogbnVsbAogICAgICAgICAgICB9LAogICAgICAgICAgICB2aXNpdGVkOiBudWxsLAogICAgICAgICAgICB2YWx1ZTogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgRGF0YU9iamVjdCkgewogICAgICAgICAgICB2YXIgdmFsdWUgPSBleHRyYWN0LnJ1bGUoaXRlbSkgfHwgbnVsbDsKICAgICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0YU9iamVjdCB8fCB2YWx1ZSBpbnN0YW5jZW9mIFJlYWRPbmx5RGF0YXNldCkgewogICAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8udmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgICBxdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIG9iamVjdDogdmFsdWUsCiAgICAgICAgICAgICAgICByZWY6IGl0ZW0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtZW1iZXJzW3NvdXJjZU9iamVjdElkXSA9IHNvdXJjZU9iamVjdEluZm87CiAgICAgICAgICAgIGluc2VydGVkLnB1c2goaXRlbSk7CiAgICAgICAgICAgIGlmIChleHRyYWN0LnJ1bGVFdmVudHMpIGl0ZW0uYWRkSGFuZGxlcihleHRyYWN0LnJ1bGVFdmVudHMsIGV4dHJhY3QpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaXRlbS5hZGRIYW5kbGVyKEVYVFJBQ1RfREFUQVNFVF9IQU5ETEVSLCBleHRyYWN0KTsKICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGRhdGFzZXRJdGVtcyA9IGl0ZW0uZ2V0SXRlbXMoKTsgaiA8IGRhdGFzZXRJdGVtcy5sZW5ndGg7IGorKykgcXVldWUucHVzaCh7CiAgICAgICAgICAgICAgb2JqZWN0OiBkYXRhc2V0SXRlbXNbal0sCiAgICAgICAgICAgICAgcmVmOiBpdGVtCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gaW5zZXJ0ZWQ7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVGcm9tRXh0cmFjdChleHRyYWN0LCBpdGVtcywgcmVmKSB7CiAgICAgIHZhciBzb3VyY2VNYXAgPSBleHRyYWN0LnNvdXJjZU1hcF87CiAgICAgIHZhciBtZW1iZXJzID0gZXh0cmFjdC5tZW1iZXJzXzsKICAgICAgdmFyIHF1ZXVlID0gYXJyYXlGcm9tKGl0ZW1zKTsKICAgICAgdmFyIGRlbGV0ZWQgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBpdGVtID0gcXVldWVbaV07CiAgICAgICAgdmFyIHNvdXJjZU9iamVjdElkID0gaXRlbS5iYXNpc09iamVjdElkOwogICAgICAgIGlmICghc291cmNlT2JqZWN0SWQpIHsKICAgICAgICAgIHJlZiA9IGl0ZW0ucmVmOwogICAgICAgICAgaXRlbSA9IGl0ZW0ub2JqZWN0OwogICAgICAgICAgc291cmNlT2JqZWN0SWQgPSBpdGVtLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgfQogICAgICAgIHZhciBzb3VyY2VPYmplY3RJbmZvID0gc291cmNlTWFwW3NvdXJjZU9iamVjdElkXTsKICAgICAgICB2YXIgc291cmNlT2JqZWN0VmFsdWUgPSBzb3VyY2VPYmplY3RJbmZvLnZhbHVlOwogICAgICAgIGZvciAodmFyIGN1cnNvciA9IHNvdXJjZU9iamVjdEluZm8sIHByZXZDdXJzb3IgPSBzb3VyY2VPYmplY3RJbmZvOyBjdXJzb3IgPSBjdXJzb3IucmVmOyApIHsKICAgICAgICAgIGlmIChjdXJzb3Iub2JqZWN0ID09PSByZWYpIHsKICAgICAgICAgICAgcHJldkN1cnNvci5yZWYgPSBjdXJzb3IucmVmOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHByZXZDdXJzb3IgPSBjdXJzb3I7CiAgICAgICAgfQogICAgICAgIGlmICghc291cmNlT2JqZWN0SW5mby5yZWYpIHsKICAgICAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgRGF0YU9iamVjdCkgewogICAgICAgICAgICBkZWxldGUgbWVtYmVyc1tzb3VyY2VPYmplY3RJZF07CiAgICAgICAgICAgIGRlbGV0ZWQucHVzaChpdGVtKTsKICAgICAgICAgICAgaWYgKGV4dHJhY3QucnVsZUV2ZW50cykgaXRlbS5yZW1vdmVIYW5kbGVyKGV4dHJhY3QucnVsZUV2ZW50cywgZXh0cmFjdCk7CiAgICAgICAgICAgIGlmIChzb3VyY2VPYmplY3RWYWx1ZSkgcXVldWUucHVzaCh7CiAgICAgICAgICAgICAgb2JqZWN0OiBzb3VyY2VPYmplY3RWYWx1ZSwKICAgICAgICAgICAgICByZWY6IGl0ZW0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpdGVtLnJlbW92ZUhhbmRsZXIoRVhUUkFDVF9EQVRBU0VUX0hBTkRMRVIsIGV4dHJhY3QpOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgZGF0YXNldEl0ZW1zID0gaXRlbS5nZXRJdGVtcygpOyBqIDwgZGF0YXNldEl0ZW1zLmxlbmd0aDsgaisrKSBxdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBvYmplY3Q6IGRhdGFzZXRJdGVtc1tqXSwKICAgICAgICAgICAgICByZWY6IGl0ZW0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgc291cmNlTWFwW3NvdXJjZU9iamVjdElkXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHNvdXJjZU9iamVjdFZhbHVlICYmICFoYXNFeHRyYWN0U291cmNlUmVmKGV4dHJhY3QsIGl0ZW0pKSB7CiAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8udmFsdWUgPSBudWxsOwogICAgICAgICAgICBxdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBvYmplY3Q6IHNvdXJjZU9iamVjdFZhbHVlLAogICAgICAgICAgICAgIHJlZjogaXRlbQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGRlbGV0ZWQ7CiAgICB9CiAgICB2YXIgRXh0cmFjdCA9IFNvdXJjZURhdGFzZXQuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRXh0cmFjdCIsCiAgICAgIHJ1bGU6IGdldHRlcigkdW5kZWYpLAogICAgICBlbWl0X3J1bGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgicnVsZUNoYW5nZWQiLCAib2xkUnVsZSIpLAogICAgICBydWxlRXZlbnRzOiBjcmVhdGVSdWxlRXZlbnRzKEVYVFJBQ1RfU09VUkNFT0JKRUNUX1VQREFURSwgInVwZGF0ZSIpLAogICAgICBsaXN0ZW46IHsKICAgICAgICBzb3VyY2U6IHsKICAgICAgICAgIGl0ZW1zQ2hhbmdlZDogRVhUUkFDVF9EQVRBU0VUX0lURU1TQ0hBTkdFRAogICAgICAgIH0KICAgICAgfSwKICAgICAgc2V0UnVsZTogZnVuY3Rpb24ocnVsZSkgewogICAgICAgIHJ1bGUgPSBnZXR0ZXIocnVsZSB8fCAkdW5kZWYpOwogICAgICAgIGlmICh0aGlzLnJ1bGUgIT09IHJ1bGUpIHsKICAgICAgICAgIHZhciBvbGRSdWxlID0gdGhpcy5ydWxlOwogICAgICAgICAgdGhpcy5ydWxlID0gcnVsZTsKICAgICAgICAgIHRoaXMuZW1pdF9ydWxlQ2hhbmdlZChvbGRSdWxlKTsKICAgICAgICAgIHJldHVybiB0aGlzLmFwcGx5UnVsZSgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYXBwbHlSdWxlOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgaW5zZXJ0ZWRNYXAgPSB7fTsKICAgICAgICB2YXIgZGVsZXRlZE1hcCA9IHt9OwogICAgICAgIHZhciBhcnJheTsKICAgICAgICB2YXIgZGVsdGE7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuc291cmNlTWFwXykgewogICAgICAgICAgdmFyIHNvdXJjZU9iamVjdEluZm8gPSB0aGlzLnNvdXJjZU1hcF9ba2V5XTsKICAgICAgICAgIHZhciBzb3VyY2VPYmplY3QgPSBzb3VyY2VPYmplY3RJbmZvLnNvdXJjZTsKICAgICAgICAgIGlmIChzb3VyY2VPYmplY3QgaW5zdGFuY2VvZiBEYXRhT2JqZWN0KSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHRoaXMucnVsZShzb3VyY2VPYmplY3QpIHx8IG51bGw7CiAgICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IHNvdXJjZU9iamVjdEluZm8udmFsdWU7CiAgICAgICAgICAgIGlmIChuZXdWYWx1ZSA9PT0gb2xkVmFsdWUpIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAobmV3VmFsdWUgaW5zdGFuY2VvZiBEYXRhT2JqZWN0IHx8IG5ld1ZhbHVlIGluc3RhbmNlb2YgUmVhZE9ubHlEYXRhc2V0KSB7CiAgICAgICAgICAgICAgdmFyIGluc2VydGVkID0gYWRkVG9FeHRyYWN0KHRoaXMsIG5ld1ZhbHVlLCBzb3VyY2VPYmplY3QpOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5zZXJ0ZWQubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBpdGVtID0gaW5zZXJ0ZWRbaV07CiAgICAgICAgICAgICAgICB2YXIgaWQgPSBpdGVtLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgICBpZiAoZGVsZXRlZE1hcFtpZF0pIGRlbGV0ZSBkZWxldGVkTWFwW2lkXTsgZWxzZSBpbnNlcnRlZE1hcFtpZF0gPSBpdGVtOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkVmFsdWUpIHsKICAgICAgICAgICAgICB2YXIgZGVsZXRlZCA9IHJlbW92ZUZyb21FeHRyYWN0KHRoaXMsIG9sZFZhbHVlLCBzb3VyY2VPYmplY3QpOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVsZXRlZC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSBkZWxldGVkW2ldOwogICAgICAgICAgICAgICAgdmFyIGlkID0gaXRlbS5iYXNpc09iamVjdElkOwogICAgICAgICAgICAgICAgaWYgKGluc2VydGVkTWFwW2lkXSkgZGVsZXRlIGluc2VydGVkTWFwW2lkXTsgZWxzZSBkZWxldGVkTWFwW2lkXSA9IGl0ZW07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNvdXJjZU9iamVjdEluZm8udmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhID0gZ2V0RGVsdGEodmFsdWVzKGluc2VydGVkTWFwKSwgdmFsdWVzKGRlbGV0ZWRNYXApKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBnZXREZWx0YTogZ2V0RGVsdGEsCiAgICAgIGNyZWF0ZVJ1bGVFdmVudHM6IGNyZWF0ZVJ1bGVFdmVudHMsCiAgICAgIE1lcmdlOiBNZXJnZSwKICAgICAgU3VidHJhY3Q6IFN1YnRyYWN0LAogICAgICBTb3VyY2VEYXRhc2V0OiBTb3VyY2VEYXRhc2V0LAogICAgICBNYXBGaWx0ZXI6IE1hcEZpbHRlciwKICAgICAgRmlsdGVyOiBGaWx0ZXIsCiAgICAgIFNwbGl0OiBTcGxpdCwKICAgICAgRXh0cmFjdDogRXh0cmFjdCwKICAgICAgU2xpY2U6IFNsaWNlLAogICAgICBDbG91ZDogQ2xvdWQKICAgIH07CiAgfSwKICAiMC5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8xLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2EuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZC5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi9lLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2YuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZy5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi9oLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2kuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vay5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi9uLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL28uanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vcC5qcyIpOwogICAgZ2xvYmFsWyJiYXNpcyJdID0gYmFzaXM7CiAgfSwKICAiMi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgRW1pdHRlciA9IGJhc2lzLmV2ZW50LkVtaXR0ZXI7CiAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgYmFzaXMucmVzb3VyY2UuZXh0ZW5zaW9uc1siLmwxMG4iXSA9IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCkgewogICAgICByZXR1cm4gcmVzb2x2ZURpY3Rpb25hcnkodXJsKS51cGRhdGUoYmFzaXMucmVzb3VyY2UuZXh0ZW5zaW9uc1siLmpzb24iXShjb250ZW50LCB1cmwpKTsKICAgIH07CiAgICBmdW5jdGlvbiBvd25LZXlzKG9iamVjdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIHZhciB0b2tlbkluZGV4ID0gW107CiAgICB2YXIgdG9rZW5Db21wdXRlRm4gPSB7fTsKICAgIHZhciB0b2tlbkNvbXB1dGVzID0ge307CiAgICB2YXIgdXBkYXRlVG9rZW4gPSBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuc2V0OwogICAgdmFyIENvbXB1dGVUb2tlbiA9IENsYXNzKGJhc2lzLlRva2VuLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Db21wdXRlVG9rZW4iLAogICAgICBpbml0OiBmdW5jdGlvbih2YWx1ZSwgdG9rZW4pIHsKICAgICAgICB0b2tlbi5jb21wdXRlVG9rZW5zW3RoaXMuYmFzaXNPYmplY3RJZF0gPSB0aGlzOwogICAgICAgIHRoaXMudG9rZW4gPSB0b2tlbjsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIga2V5ID0gdGhpcy50b2tlbi50eXBlID09ICJwbHVyYWwiID8gY3VsdHVyZXNbY3VycmVudEN1bHR1cmVdLnBsdXJhbCh0aGlzLnZhbHVlKSA6IHRoaXMudmFsdWU7CiAgICAgICAgcmV0dXJuIHRoaXMudG9rZW4uZGljdGlvbmFyeS5nZXRWYWx1ZSh0aGlzLnRva2VuLm5hbWUgKyAiLiIgKyBrZXkpOwogICAgICB9LAogICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KCk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGRlbGV0ZSB0aGlzLnRva2VuLmNvbXB1dGVUb2tlbnNbdGhpcy5iYXNpc09iamVjdElkXTsKICAgICAgICB0aGlzLnRva2VuID0gbnVsbDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUb2tlbiA9IENsYXNzKGJhc2lzLlRva2VuLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Ub2tlbiIsCiAgICAgIGluZGV4OiBOYU4sCiAgICAgIGRpY3Rpb25hcnk6IG51bGwsCiAgICAgIG5hbWU6ICIiLAogICAgICB0eXBlOiAiZGVmYXVsdCIsCiAgICAgIGNvbXB1dGVUb2tlbnM6IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKGRpY3Rpb25hcnksIHRva2VuTmFtZSwgdHlwZSwgdmFsdWUpIHsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICB0aGlzLmluZGV4ID0gdG9rZW5JbmRleC5wdXNoKHRoaXMpIC0gMTsKICAgICAgICB0aGlzLm5hbWUgPSB0b2tlbk5hbWU7CiAgICAgICAgdGhpcy5kaWN0aW9uYXJ5ID0gZGljdGlvbmFyeTsKICAgICAgICB0aGlzLmNvbXB1dGVUb2tlbnMgPSB7fTsKICAgICAgICBpZiAodHlwZSkgdGhpcy5zZXRUeXBlKHR5cGUpOyBlbHNlIHRoaXMuYXBwbHkoKTsKICAgICAgfSwKICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCgpOwogICAgICB9LAogICAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuY29tcHV0ZVRva2VucykgdGhpcy5jb21wdXRlVG9rZW5zW2tleV0uYXBwbHkoKTsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuYXBwbHkuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMubDEwbjogVmFsdWUgZm9yIGwxMG4gdG9rZW4gY2FuJ3QgYmUgc2V0IGRpcmVjdGx5LCBidXQgdGhyb3VnaCBkaWN0aW9uYXJ5IHVwZGF0ZSBvbmx5Iik7CiAgICAgIH0sCiAgICAgIHNldFR5cGU6IGZ1bmN0aW9uKHR5cGUpIHsKICAgICAgICBpZiAodHlwZSAhPSAicGx1cmFsIiAmJiAoIWJhc2lzLmwxMG4uZW5hYmxlTWFya3VwIHx8IHR5cGUgIT0gIm1hcmt1cCIpKSB0eXBlID0gImRlZmF1bHQiOwogICAgICAgIGlmICh0aGlzLnR5cGUgIT0gdHlwZSkgewogICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewogICAgICAgICAgZ2V0dGVyID0gZXZlbnRzOwogICAgICAgICAgZXZlbnRzID0gIiI7CiAgICAgICAgfQogICAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIpOwogICAgICAgIGV2ZW50cyA9IFN0cmluZyhldmVudHMpLnRyaW0oKS5zcGxpdCgvXHMrfFxzKixccyovKS5zb3J0KCk7CiAgICAgICAgdmFyIHRva2VuSWQgPSB0aGlzLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgdmFyIGVudW1JZCA9IGV2ZW50cy5jb25jYXQodG9rZW5JZCwgZ2V0dGVyW2Jhc2lzLmdldHRlci5JRF0pLmpvaW4oIl8iKTsKICAgICAgICBpZiAodG9rZW5Db21wdXRlRm5bZW51bUlkXSkgcmV0dXJuIHRva2VuQ29tcHV0ZUZuW2VudW1JZF07CiAgICAgICAgdmFyIHRva2VuID0gdGhpczsKICAgICAgICB2YXIgb2JqZWN0VG9rZW5NYXAgPSB7fTsKICAgICAgICB2YXIgdXBkYXRlVmFsdWUgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgIHVwZGF0ZVRva2VuLmNhbGwodGhpcywgZ2V0dGVyKG9iamVjdCkpOwogICAgICAgIH07CiAgICAgICAgdmFyIGhhbmRsZXIgPSB7CiAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgZGVsZXRlIG9iamVjdFRva2VuTWFwW29iamVjdC5iYXNpc09iamVjdElkXTsKICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZXZlbnROYW1lOyBldmVudE5hbWUgPSBldmVudHNbaV07IGkrKykgaWYgKGV2ZW50TmFtZSAhPSAiZGVzdHJveSIpIGhhbmRsZXJbZXZlbnROYW1lXSA9IHVwZGF0ZVZhbHVlOwogICAgICAgIHJldHVybiB0b2tlbkNvbXB1dGVGbltlbnVtSWRdID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgRW1pdHRlciA9PSBmYWxzZSkgdGhyb3cgImJhc2lzLmwxMG4uVG9rZW4jY29tcHV0ZTogb2JqZWN0IG11c3QgYmUgYW4gaW5zdGFuY2VvZiBFbWl0dGVyIjsKICAgICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgICAgdmFyIGNvbXB1dGVUb2tlbiA9IG9iamVjdFRva2VuTWFwW29iamVjdElkXTsKICAgICAgICAgIGlmICghY29tcHV0ZVRva2VuKSB7CiAgICAgICAgICAgIGNvbXB1dGVUb2tlbiA9IG9iamVjdFRva2VuTWFwW29iamVjdElkXSA9IG5ldyBDb21wdXRlVG9rZW4oZ2V0dGVyKG9iamVjdCksIHRva2VuKTsKICAgICAgICAgICAgb2JqZWN0LmFkZEhhbmRsZXIoaGFuZGxlciwgY29tcHV0ZVRva2VuKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb21wdXRlVG9rZW47CiAgICAgICAgfTsKICAgICAgfSwKICAgICAgY29tcHV0ZVRva2VuOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBuZXcgQ29tcHV0ZVRva2VuKHZhbHVlLCB0aGlzKTsKICAgICAgfSwKICAgICAgdG9rZW46IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICBpZiAodGhpcy50eXBlID09ICJwbHVyYWwiKSBuYW1lID0gY3VsdHVyZXNbY3VycmVudEN1bHR1cmVdLnBsdXJhbChuYW1lKTsKICAgICAgICBpZiAodGhpcy5kaWN0aW9uYXJ5KSByZXR1cm4gdGhpcy5kaWN0aW9uYXJ5LnRva2VuKHRoaXMubmFtZSArICIuIiArIG5hbWUpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5jb21wdXRlVG9rZW5zKSB0aGlzLmNvbXB1dGVUb2tlbnNba2V5XS5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5jb21wdXRlVG9rZW5zID0gbnVsbDsKICAgICAgICB0aGlzLnZhbHVlID0gbnVsbDsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIHJlc29sdmVUb2tlbihwYXRoKSB7CiAgICAgIGlmIChwYXRoLmNoYXJBdCgwKSA9PSAiIyIpIHsKICAgICAgICByZXR1cm4gdG9rZW5JbmRleFtwYXJzZUludChwYXRoLnN1YnN0cigxKSwgMzYpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLm1hdGNoKC9eKC4rPylAKC4rKSQvKTsKICAgICAgICBpZiAocGFydHMpIHJldHVybiByZXNvbHZlRGljdGlvbmFyeShiYXNpcy5wYXRoLnJlc29sdmUocGFydHNbMl0pKS50b2tlbihwYXJ0c1sxXSk7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmwxMG4udG9rZW4gYWNjZXB0cyB0b2tlbiByZWZlcmVuY2VzIGluIGZvcm1hdCBgdG9rZW4ucGF0aEBwYXRoL3RvL2RpY3QubDEwbmAgb25seSIpOwogICAgICB9CiAgICB9CiAgICB2YXIgZGljdGlvbmFyaWVzID0gW107CiAgICB2YXIgZGljdGlvbmFyeUJ5VXJsID0ge307CiAgICB2YXIgY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyID0gbmV3IGJhc2lzLlRva2VuOwogICAgZnVuY3Rpb24gd2Fsa1Rva2VucyhkaWN0aW9uYXJ5LCBjdWx0dXJlLCB0b2tlbnMsIHBhdGgpIHsKICAgICAgdmFyIGN1bHR1cmVWYWx1ZXMgPSBkaWN0aW9uYXJ5LmN1bHR1cmVWYWx1ZXNbY3VsdHVyZV07CiAgICAgIHBhdGggPSBwYXRoID8gcGF0aCArICIuIiA6ICIiOwogICAgICBmb3IgKHZhciBuYW1lIGluIHRva2VucykgaWYgKGhhc093blByb3BlcnR5LmNhbGwodG9rZW5zLCBuYW1lKSkgewogICAgICAgIHZhciB0b2tlbk5hbWUgPSBwYXRoICsgbmFtZTsKICAgICAgICB2YXIgdG9rZW5WYWx1ZSA9IHRva2Vuc1tuYW1lXTsKICAgICAgICBjdWx0dXJlVmFsdWVzW3Rva2VuTmFtZV0gPSB0b2tlblZhbHVlOwogICAgICAgIGlmICh0b2tlblZhbHVlICYmICh0eXBlb2YgdG9rZW5WYWx1ZSA9PSAib2JqZWN0IiB8fCBBcnJheS5pc0FycmF5KHRva2VuVmFsdWUpKSkgd2Fsa1Rva2VucyhkaWN0aW9uYXJ5LCBjdWx0dXJlLCB0b2tlblZhbHVlLCB0b2tlbk5hbWUpOwogICAgICB9CiAgICB9CiAgICB2YXIgRGljdGlvbmFyeSA9IENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkRpY3Rpb25hcnkiLAogICAgICB0b2tlbnM6IG51bGwsCiAgICAgIHR5cGVzOiBudWxsLAogICAgICBjdWx0dXJlVmFsdWVzOiBudWxsLAogICAgICBpbmRleDogTmFOLAogICAgICByZXNvdXJjZTogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24oY29udGVudCkgewogICAgICAgIHRoaXMudG9rZW5zID0ge307CiAgICAgICAgdGhpcy50eXBlcyA9IHt9OwogICAgICAgIHRoaXMuY3VsdHVyZVZhbHVlcyA9IHt9OwogICAgICAgIHRoaXMuaW5kZXggPSBkaWN0aW9uYXJpZXMucHVzaCh0aGlzKSAtIDE7CiAgICAgICAgaWYgKGJhc2lzLnJlc291cmNlLmlzUmVzb3VyY2UoY29udGVudCkpIHsKICAgICAgICAgIHZhciByZXNvdXJjZSA9IGNvbnRlbnQ7CiAgICAgICAgICB0aGlzLnJlc291cmNlID0gcmVzb3VyY2U7CiAgICAgICAgICBpZiAoIWRpY3Rpb25hcnlCeVVybFtyZXNvdXJjZS51cmxdKSB7CiAgICAgICAgICAgIGRpY3Rpb25hcnlCeVVybFtyZXNvdXJjZS51cmxdID0gdGhpczsKICAgICAgICAgICAgY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyLnNldChyZXNvdXJjZS51cmwpOwogICAgICAgICAgfQogICAgICAgICAgcmVzb3VyY2UuZmV0Y2goKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlVzZSBvYmplY3QgYXMgY29udGVudCBvZiBkaWN0aW9uYXJ5IGlzIGV4cGVyaW1lbnRhbCBhbmQgbm90IHByb2R1Y3Rpb24tcmVhZHkiKTsKICAgICAgICAgIHRoaXMudXBkYXRlKGNvbnRlbnQgfHwge30pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgdXBkYXRlOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgaWYgKCFkYXRhKSBkYXRhID0ge307CiAgICAgICAgdGhpcy5jdWx0dXJlVmFsdWVzID0ge307CiAgICAgICAgZm9yICh2YXIgY3VsdHVyZSBpbiBkYXRhKSBpZiAoIS9eX3xfJC8udGVzdChjdWx0dXJlKSkgewogICAgICAgICAgdGhpcy5jdWx0dXJlVmFsdWVzW2N1bHR1cmVdID0ge307CiAgICAgICAgICB3YWxrVG9rZW5zKHRoaXMsIGN1bHR1cmUsIGRhdGFbY3VsdHVyZV0pOwogICAgICAgIH0KICAgICAgICB0aGlzLnR5cGVzID0gZGF0YS5fbWV0YSAmJiBkYXRhLl9tZXRhLnR5cGUgfHwge307CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMudG9rZW5zKSB0aGlzLnRva2Vuc1trZXldLnNldFR5cGUodGhpcy50eXBlc1trZXldKTsKICAgICAgICB0aGlzLnN5bmNWYWx1ZXMoKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgc3luY1ZhbHVlczogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgdG9rZW5OYW1lIGluIHRoaXMudG9rZW5zKSB1cGRhdGVUb2tlbi5jYWxsKHRoaXMudG9rZW5zW3Rva2VuTmFtZV0sIHRoaXMuZ2V0VmFsdWUodG9rZW5OYW1lKSk7CiAgICAgIH0sCiAgICAgIGdldFZhbHVlOiBmdW5jdGlvbih0b2tlbk5hbWUpIHsKICAgICAgICB2YXIgZmFsbGJhY2sgPSBjdWx0dXJlRmFsbGJhY2tbY3VycmVudEN1bHR1cmVdIHx8IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjdWx0dXJlTmFtZTsgY3VsdHVyZU5hbWUgPSBmYWxsYmFja1tpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgY3VsdHVyZVZhbHVlcyA9IHRoaXMuY3VsdHVyZVZhbHVlc1tjdWx0dXJlTmFtZV07CiAgICAgICAgICBpZiAoY3VsdHVyZVZhbHVlcyAmJiB0b2tlbk5hbWUgaW4gY3VsdHVyZVZhbHVlcykgcmV0dXJuIGN1bHR1cmVWYWx1ZXNbdG9rZW5OYW1lXTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldEN1bHR1cmVWYWx1ZTogZnVuY3Rpb24oY3VsdHVyZSwgdG9rZW5OYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VsdHVyZVZhbHVlc1tjdWx0dXJlXSAmJiB0aGlzLmN1bHR1cmVWYWx1ZXNbY3VsdHVyZV1bdG9rZW5OYW1lXTsKICAgICAgfSwKICAgICAgdG9rZW46IGZ1bmN0aW9uKHRva2VuTmFtZSkgewogICAgICAgIHZhciB0b2tlbiA9IHRoaXMudG9rZW5zW3Rva2VuTmFtZV07CiAgICAgICAgaWYgKCF0b2tlbikgewogICAgICAgICAgdG9rZW4gPSB0aGlzLnRva2Vuc1t0b2tlbk5hbWVdID0gbmV3IFRva2VuKHRoaXMsIHRva2VuTmFtZSwgdGhpcy50eXBlc1t0b2tlbk5hbWVdLCB0aGlzLmdldFZhbHVlKHRva2VuTmFtZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudG9rZW5zID0gbnVsbDsKICAgICAgICB0aGlzLmN1bHR1cmVWYWx1ZXMgPSBudWxsOwogICAgICAgIGJhc2lzLmFycmF5LnJlbW92ZShkaWN0aW9uYXJpZXMsIHRoaXMpOwogICAgICAgIGlmICh0aGlzLnJlc291cmNlKSB7CiAgICAgICAgICBkZWxldGUgZGljdGlvbmFyeUJ5VXJsW3RoaXMucmVzb3VyY2UudXJsXTsKICAgICAgICAgIHRoaXMucmVzb3VyY2UgPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlRGljdGlvbmFyeShzb3VyY2UpIHsKICAgICAgdmFyIGRpY3Rpb25hcnk7CiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJzdHJpbmciKSB7CiAgICAgICAgdmFyIGxvY2F0aW9uID0gc291cmNlOwogICAgICAgIHZhciBleHRuYW1lID0gYmFzaXMucGF0aC5leHRuYW1lKGxvY2F0aW9uKTsKICAgICAgICBpZiAoZXh0bmFtZSAhPSAiLmwxMG4iKSBsb2NhdGlvbiA9IGJhc2lzLnBhdGguZGlybmFtZShsb2NhdGlvbikgKyAiLyIgKyBiYXNpcy5wYXRoLmJhc2VuYW1lKGxvY2F0aW9uLCBleHRuYW1lKSArICIubDEwbiI7CiAgICAgICAgc291cmNlID0gYmFzaXMucmVzb3VyY2UobG9jYXRpb24pOwogICAgICB9CiAgICAgIGlmIChiYXNpcy5yZXNvdXJjZS5pc1Jlc291cmNlKHNvdXJjZSkpIGRpY3Rpb25hcnkgPSBkaWN0aW9uYXJ5QnlVcmxbc291cmNlLnVybF07CiAgICAgIHJldHVybiBkaWN0aW9uYXJ5IHx8IG5ldyBEaWN0aW9uYXJ5KHNvdXJjZSk7CiAgICB9CiAgICBmdW5jdGlvbiBnZXREaWN0aW9uYXJpZXMoKSB7CiAgICAgIHJldHVybiBkaWN0aW9uYXJpZXMuc2xpY2UoMCk7CiAgICB9CiAgICB2YXIgY3VsdHVyZUxpc3QgPSBbXTsKICAgIHZhciBjdXJyZW50Q3VsdHVyZSA9IG51bGw7CiAgICB2YXIgY3VsdHVyZXMgPSB7fTsKICAgIHZhciBjdWx0dXJlRmFsbGJhY2sgPSB7fTsKICAgIHZhciBwbHVyYWxGb3Jtc01hcCA9IHt9OwogICAgdmFyIHBsdXJhbEZvcm1zID0gWyBbIDEsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIDA7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxIHx8IG4gJSAxMCA9PSAxID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxID8gMCA6IDE7CiAgICB9IF0sIFsgMiwgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwIHx8IG4gPT0gMSA/IDAgOiAxOwogICAgfSBdLCBbIDIsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMCAhPSAxIHx8IG4gJSAxMDAgPT0gMTEgPyAxIDogMDsKICAgIH0gXSwgWyAzLCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiAlIDEwID49IDIgJiYgbiAlIDEwIDw9IDQgJiYgKG4gJSAxMDAgPCAxMCB8fCBuICUgMTAwID49IDIwKSA/IDEgOiAyOwogICAgfSBdLCBbIDMsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMCA9PSAxICYmIG4gJSAxMDAgIT0gMTEgPyAwIDogbiAhPSAwID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSA/IDAgOiBuICUgMTAgPj0gMiAmJiAobiAlIDEwMCA8IDEwIHx8IG4gJSAxMDAgPj0gMjApID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiAlIDEwID09IDEgJiYgbiAlIDEwMCAhPSAxMSA/IDAgOiBuICUgMTAgPj0gMiAmJiBuICUgMTAgPD0gNCAmJiAobiAlIDEwMCA8IDEwIHx8IG4gJSAxMDAgPj0gMjApID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAwID8gMCA6IG4gPT0gMSA/IDEgOiAyOwogICAgfSBdLCBbIDMsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDAgfHwgbiAlIDEwMCA+IDAgJiYgbiAlIDEwMCA8IDIwID8gMSA6IDI7CiAgICB9IF0sIFsgMywgZnVuY3Rpb24obikgewogICAgICByZXR1cm4gbiA9PSAxID8gMCA6IG4gJSAxMCA+PSAyICYmIG4gJSAxMCA8PSA0ICYmIChuICUgMTAwIDwgMTAgfHwgbiAlIDEwMCA+PSAyMCkgPyAxIDogMjsKICAgIH0gXSwgWyAzLCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA+PSAyICYmIG4gPD0gNCA/IDEgOiAyOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDIgPyAxIDogbiAhPSA4ICYmIG4gIT0gMTEgPyAyIDogMzsKICAgIH0gXSwgWyA0LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA9PSAyID8gMSA6IG4gPT0gMyA/IDIgOiAzOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gJSAxMDAgPT0gMSA/IDEgOiBuICUgMTAwID09IDIgPyAyIDogbiAlIDEwMCA9PSAzIHx8IG4gJSAxMDAgPT0gNCA/IDMgOiAwOwogICAgfSBdLCBbIDQsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMSA/IDAgOiBuID09IDAgfHwgbiAlIDEwMCA+IDEgJiYgbiAlIDEwMCA8IDExID8gMSA6IG4gJSAxMDAgPiAxMCAmJiBuICUgMTAwIDwgMjAgPyAyIDogMzsKICAgIH0gXSwgWyA0LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgfHwgbiA9PSAxMSA/IDAgOiBuID09IDIgfHwgbiA9PSAxMiA/IDEgOiBuID4gMiAmJiBuIDwgMjAgPyAyIDogMzsKICAgIH0gXSwgWyA1LCBmdW5jdGlvbihuKSB7CiAgICAgIHJldHVybiBuID09IDEgPyAwIDogbiA9PSAyID8gMSA6IG4gPCA3ID8gMiA6IG4gPCAxMSA/IDMgOiA0OwogICAgfSBdLCBbIDYsIGZ1bmN0aW9uKG4pIHsKICAgICAgcmV0dXJuIG4gPT0gMCA/IDAgOiBuID09IDEgPyAxIDogbiA9PSAyID8gMiA6IG4gJSAxMDAgPj0gMyAmJiBuICUgMTAwIDw9IDEwID8gMyA6IG4gJSAxMDAgPj0gMTEgPyA0IDogNTsKICAgIH0gXSBdOwogICAgWyAiYXkgYm8gY2dnIGR6IGZhIGlkIGphIGpibyBrYSBrayBrbSBrbyBreSBsbyBtcyBteSBzYWggc3UgdGggdHQgdWcgdmkgd28gemgiLCAibWsiLCAianYiLCAiYWYgYW4gYXN0IGF6IGJnIGJuIGJyeCBjYSBkYSBkZSBkb2kgZWwgZW4gZW8gZXMgZXMtQVIgZXQgZXUgZmYgZmkgZm8gZnVyIGZ5IGdsIGd1IGhhIGhlIGhpIGhuZSBodSBoeSBpYSBpdCBrbiBrdSBsYiBtYWkgbWwgbW4gbW5pIG1yIG5haCBuYXAgbmIgbmUgbmwgbm4gbm8gbnNvIG9yIHBhIHBhcCBwbXMgcHMgcHQgcm0gcncgc2F0IHNjbyBzZCBzZSBzaSBzbyBzb24gc3Egc3Ygc3cgdGEgdGUgdGsgdXIgeW8iLCAiYWNoIGFrIGFtIGFybiBiciBmaWwgZnIgZ3VuIGxuIG1mZSBtZyBtaSBvYyBwdC1CUiB0ZyB0aSB0ciB1eiB3YSB6aCIsICJpcyIsICJjc2IiLCAibHYiLCAibHQiLCAiYmUgYnMgaHIgcnUgc3IgdWsiLCAibW5rIiwgInJvIiwgInBsIiwgImNzIHNrIiwgImN5IiwgImt3IiwgInNsIiwgIm10IiwgImdkIiwgImdhIiwgImFyIiBdLmZvckVhY2goZnVuY3Rpb24obGFuZ3MsIGlkeCkgewogICAgICBsYW5ncy5zcGxpdCgiICIpLmZvckVhY2goZnVuY3Rpb24obGFuZykgewogICAgICAgIHBsdXJhbEZvcm1zTWFwW2xhbmddID0gdGhpczsKICAgICAgfSwgcGx1cmFsRm9ybXNbaWR4XSk7CiAgICB9KTsKICAgIHZhciBDdWx0dXJlID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQ3VsdHVyZSIsCiAgICAgIG5hbWU6ICIiLAogICAgICBwbHVyYWxGb3JtOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbihuYW1lLCBwbHVyYWxGb3JtKSB7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICBpZiAoIWN1bHR1cmVzW25hbWVdKSBjdWx0dXJlc1tuYW1lXSA9IHRoaXM7CiAgICAgICAgdGhpcy5wbHVyYWxGb3JtID0gcGx1cmFsRm9ybSB8fCBwbHVyYWxGb3Jtc01hcFtuYW1lXSB8fCBwbHVyYWxGb3Jtc01hcFtuYW1lLnNwbGl0KCItIilbMF1dIHx8IHBsdXJhbEZvcm1zWzBdOwogICAgICB9LAogICAgICBwbHVyYWw6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIE51bWJlcih0aGlzLnBsdXJhbEZvcm1bMV0oTWF0aC5hYnMocGFyc2VJbnQodmFsdWUsIDEwKSkpKTsKICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiByZXNvbHZlQ3VsdHVyZShuYW1lLCBwbHVyYWxGb3JtKSB7CiAgICAgIGlmIChuYW1lICYmICFjdWx0dXJlc1tuYW1lXSkgY3VsdHVyZXNbbmFtZV0gPSBuZXcgQ3VsdHVyZShuYW1lLCBwbHVyYWxGb3JtKTsKICAgICAgcmV0dXJuIGN1bHR1cmVzW25hbWUgfHwgY3VycmVudEN1bHR1cmVdOwogICAgfQogICAgYmFzaXMub2JqZWN0LmV4dGVuZChyZXNvbHZlQ3VsdHVyZSwgbmV3IGJhc2lzLlRva2VuKTsKICAgIHJlc29sdmVDdWx0dXJlLnNldCA9IHNldEN1bHR1cmU7CiAgICBmdW5jdGlvbiBnZXRDdWx0dXJlKCkgewogICAgICByZXR1cm4gY3VycmVudEN1bHR1cmU7CiAgICB9CiAgICBmdW5jdGlvbiBzZXRDdWx0dXJlKGN1bHR1cmUpIHsKICAgICAgaWYgKCFjdWx0dXJlKSByZXR1cm47CiAgICAgIGlmIChjdXJyZW50Q3VsdHVyZSAhPSBjdWx0dXJlKSB7CiAgICAgICAgaWYgKGN1bHR1cmVMaXN0LmluZGV4T2YoY3VsdHVyZSkgPT0gLTEpIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5sMTBuLnNldEN1bHR1cmU6IGN1bHR1cmUgYCIgKyBjdWx0dXJlICsgImAgbm90IGluIHRoZSBsaXN0LCB0aGUgY3VsdHVyZSBpc24ndCBjaGFuZ2VkIik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRDdWx0dXJlID0gY3VsdHVyZTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZGljdGlvbmFyeTsgZGljdGlvbmFyeSA9IGRpY3Rpb25hcmllc1tpXTsgaSsrKSBkaWN0aW9uYXJ5LnN5bmNWYWx1ZXMoKTsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuc2V0LmNhbGwocmVzb2x2ZUN1bHR1cmUsIGN1bHR1cmUpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXRDdWx0dXJlTGlzdCgpIHsKICAgICAgcmV0dXJuIGN1bHR1cmVMaXN0LnNsaWNlKDApOwogICAgfQogICAgZnVuY3Rpb24gc2V0Q3VsdHVyZUxpc3QobGlzdCkgewogICAgICBpZiAodHlwZW9mIGxpc3QgPT0gInN0cmluZyIpIGxpc3QgPSBsaXN0LnRyaW0oKS5zcGxpdCgiICIpOwogICAgICBpZiAoIWxpc3QubGVuZ3RoKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmwxMG4uc2V0Q3VsdHVyZUxpc3Q6IGN1bHR1cmUgbGlzdCBjYW4ndCBiZSBlbXB0eSwgdGhlIGN1bHR1cmUgbGlzdCBpc24ndCBjaGFuZ2VkIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBjdWx0dXJlcyA9IHt9OwogICAgICB2YXIgY3VsdHVyZVJvdzsKICAgICAgdmFyIGJhc2VDdWx0dXJlOwogICAgICBjdWx0dXJlRmFsbGJhY2sgPSB7fTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGN1bHR1cmUsIGN1bHR1cmVOYW1lOyBjdWx0dXJlID0gbGlzdFtpXTsgaSsrKSB7CiAgICAgICAgY3VsdHVyZVJvdyA9IGN1bHR1cmUuc3BsaXQoIi8iKTsKICAgICAgICBpZiAoY3VsdHVyZVJvdy5sZW5ndGggPiAyKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMubDEwbi5zZXRDdWx0dXJlTGlzdDogb25seSBvbmUgZmFsbGJhY2sgY3VsdHVyZSBjYW4gYmUgc2V0IGZvciBjZXJ0YWluIGN1bHR1cmUsIHRyeSB0byBzZXQgYCIgKyBjdWx0dXJlICsgImA7IG90aGVyIGN1bHR1cmVzIGV4Y2VwdCBmaXJzdCBvbmUgd2FzIGlnbm9yZWQiKTsKICAgICAgICAgIGN1bHR1cmVSb3cgPSBjdWx0dXJlUm93LnNsaWNlKDAsIDIpOwogICAgICAgIH0KICAgICAgICBjdWx0dXJlTmFtZSA9IGN1bHR1cmVSb3dbMF07CiAgICAgICAgaWYgKCFiYXNlQ3VsdHVyZSkgYmFzZUN1bHR1cmUgPSBjdWx0dXJlTmFtZTsKICAgICAgICBjdWx0dXJlc1tjdWx0dXJlTmFtZV0gPSByZXNvbHZlQ3VsdHVyZShjdWx0dXJlTmFtZSk7CiAgICAgICAgY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXSA9IGN1bHR1cmVSb3c7CiAgICAgIH0KICAgICAgZm9yICh2YXIgY3VsdHVyZU5hbWUgaW4gY3VsdHVyZUZhbGxiYWNrKSB7CiAgICAgICAgY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXSA9IGJhc2lzLmFycmF5LmZsYXR0ZW4oY3VsdHVyZUZhbGxiYWNrW2N1bHR1cmVOYW1lXS5tYXAoZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcmV0dXJuIGN1bHR1cmVGYWxsYmFja1tuYW1lXTsKICAgICAgICB9KSkuY29uY2F0KGJhc2VDdWx0dXJlKS5maWx0ZXIoZnVuY3Rpb24oaXRlbSwgaWR4LCBhcnJheSkgewogICAgICAgICAgcmV0dXJuICFpZHggfHwgYXJyYXkubGFzdEluZGV4T2YoaXRlbSwgaWR4IC0gMSkgPT0gLTE7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY3VsdHVyZUxpc3QgPSBiYXNpcy5vYmplY3Qua2V5cyhjdWx0dXJlcyk7CiAgICAgIGlmIChjdXJyZW50Q3VsdHVyZSBpbiBjdWx0dXJlcyA9PSBmYWxzZSkgc2V0Q3VsdHVyZShiYXNlQ3VsdHVyZSk7CiAgICB9CiAgICBmdW5jdGlvbiBvbkN1bHR1cmVDaGFuZ2UoZm4sIGNvbnRleHQsIGZpcmUpIHsKICAgICAgcmVzb2x2ZUN1bHR1cmUuYXR0YWNoKGZuLCBjb250ZXh0KTsKICAgICAgaWYgKGZpcmUpIGZuLmNhbGwoY29udGV4dCwgY3VycmVudEN1bHR1cmUpOwogICAgfQogICAgc2V0Q3VsdHVyZUxpc3QoImVuLVVTIik7CiAgICBzZXRDdWx0dXJlKCJlbi1VUyIpOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIENvbXB1dGVUb2tlbjogQ29tcHV0ZVRva2VuLAogICAgICBUb2tlbjogVG9rZW4sCiAgICAgIHRva2VuOiByZXNvbHZlVG9rZW4sCiAgICAgIERpY3Rpb25hcnk6IERpY3Rpb25hcnksCiAgICAgIGRpY3Rpb25hcnk6IHJlc29sdmVEaWN0aW9uYXJ5LAogICAgICBnZXREaWN0aW9uYXJpZXM6IGdldERpY3Rpb25hcmllcywKICAgICAgYWRkQ3JlYXRlRGljdGlvbmFyeUhhbmRsZXI6IGNyZWF0ZURpY3Rpb25hcnlOb3RpZmllci5hdHRhY2guYmluZChjcmVhdGVEaWN0aW9uYXJ5Tm90aWZpZXIpLAogICAgICByZW1vdmVDcmVhdGVEaWN0aW9uYXJ5SGFuZGxlcjogY3JlYXRlRGljdGlvbmFyeU5vdGlmaWVyLmRldGFjaC5iaW5kKGNyZWF0ZURpY3Rpb25hcnlOb3RpZmllciksCiAgICAgIEN1bHR1cmU6IEN1bHR1cmUsCiAgICAgIGN1bHR1cmU6IHJlc29sdmVDdWx0dXJlLAogICAgICBnZXRDdWx0dXJlOiBnZXRDdWx0dXJlLAogICAgICBzZXRDdWx0dXJlOiBzZXRDdWx0dXJlLAogICAgICBnZXRDdWx0dXJlTGlzdDogZ2V0Q3VsdHVyZUxpc3QsCiAgICAgIHNldEN1bHR1cmVMaXN0OiBzZXRDdWx0dXJlTGlzdCwKICAgICAgcGx1cmFsRm9ybXM6IHBsdXJhbEZvcm1zLAogICAgICBvbkN1bHR1cmVDaGFuZ2U6IG9uQ3VsdHVyZUNoYW5nZQogICAgfTsKICB9LAogICIzLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgZXh0ZW5kID0gYmFzaXMub2JqZWN0LmV4dGVuZDsKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIHZhciBOVUxMX0hBTkRMRVIgPSB7fTsKICAgIHZhciBldmVudHMgPSB7fTsKICAgIHZhciB3YXJuT25EZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgIGJhc2lzLmRldi53YXJuKCJPYmplY3QgaGFkIGJlZW4gZGVzdHJveWVkIGJlZm9yZS4gRGVzdHJveSBtZXRob2QgbXVzdCBub3QgYmUgY2FsbGVkIG1vcmUgdGhhbiBvbmNlLiIpOwogICAgfTsKICAgIGZ1bmN0aW9uIGNyZWF0ZURpc3BhdGNoZXIoZXZlbnROYW1lKSB7CiAgICAgIHZhciBldmVudEZ1bmN0aW9uID0gZXZlbnRzW2V2ZW50TmFtZV07CiAgICAgIGlmICghZXZlbnRGdW5jdGlvbikgewogICAgICAgIGV2ZW50RnVuY3Rpb24gPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgICAgdmFyIGFyZ3M7CiAgICAgICAgICB2YXIgZm47CiAgICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpIHsKICAgICAgICAgICAgZm4gPSBjdXJzb3IuY2FsbGJhY2tzW2V2ZW50TmFtZV07CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICghYXJncykgewogICAgICAgICAgICAgICAgYXJncyA9IFsgdGhpcyBdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbi5hcHBseShjdXJzb3IuY29udGV4dCB8fCB0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbiA9IGN1cnNvci5jYWxsYmFja3NbIioiXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKCFhcmdzKSB7CiAgICAgICAgICAgICAgICBhcmdzID0gWyB0aGlzIF07CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgYXJncy5wdXNoKGFyZ3VtZW50c1tpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuLmNhbGwoY3Vyc29yLmNvbnRleHQgfHwgdGhpcywgewogICAgICAgICAgICAgICAgc2VuZGVyOiB0aGlzLAogICAgICAgICAgICAgICAgdHlwZTogZXZlbnROYW1lLAogICAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5kZWJ1Z19lbWl0KSB7CiAgICAgICAgICAgIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIGFyZ3MucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgICAgICB0aGlzLmRlYnVnX2VtaXQoewogICAgICAgICAgICAgIHNlbmRlcjogdGhpcywKICAgICAgICAgICAgICB0eXBlOiBldmVudE5hbWUsCiAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGV2ZW50RnVuY3Rpb24gPSAobmV3IEZ1bmN0aW9uKCJzbGljZSIsICdyZXR1cm4geyInICsgbmFtZXNwYWNlICsgIi5ldmVudHMuIiArIGV2ZW50TmFtZSArICciOlxuXG4gICAgICAnICsgImZ1bmN0aW9uKCIgKyBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuam9pbigiLCAiKSArICIpeyIgKyBldmVudEZ1bmN0aW9uLnRvU3RyaW5nKCkucmVwbGFjZSgvXGJldmVudE5hbWVcYi9nLCAnIicgKyBldmVudE5hbWUgKyAnIicpLnJlcGxhY2UoL15mdW5jdGlvblteKF0qXChcKVtee10qXHt8XH0kL2csICIiKSArICJ9IiArICdcblxufVsiJyArIG5hbWVzcGFjZSArICIuZXZlbnRzLiIgKyBldmVudE5hbWUgKyAnIl07JykpKHNsaWNlKTsKICAgICAgICBldmVudHNbZXZlbnROYW1lXSA9IGV2ZW50RnVuY3Rpb247CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50RnVuY3Rpb247CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVIYW5kbGVyKGV2ZW50cywgZXZlbnRDYWxsYmFjaykgewogICAgICB2YXIgaGFuZGxlciA9IHsKICAgICAgICBldmVudHM6IFtdCiAgICAgIH07CiAgICAgIGlmIChldmVudHMpIHsKICAgICAgICBldmVudHMgPSBTdHJpbmcoZXZlbnRzKS50cmltKCkuc3BsaXQoL1xzK3xccyosXHMqLykuc29ydCgpOwogICAgICAgIGhhbmRsZXIgPSB7CiAgICAgICAgICBldmVudHM6IGV2ZW50cwogICAgICAgIH07CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50TmFtZTsgZXZlbnROYW1lID0gZXZlbnRzW2ldOyBpKyspIGlmIChldmVudE5hbWUgIT0gImRlc3Ryb3kiKSBoYW5kbGVyW2V2ZW50TmFtZV0gPSBldmVudENhbGxiYWNrOwogICAgICB9CiAgICAgIHJldHVybiBoYW5kbGVyOwogICAgfQogICAgdmFyIEVtaXR0ZXIgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5FbWl0dGVyIiwKICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiB0cnVlLAogICAgICBoYW5kbGVyOiBudWxsLAogICAgICBlbWl0X2Rlc3Ryb3k6IGNyZWF0ZURpc3BhdGNoZXIoImRlc3Ryb3kiKSwKICAgICAgbGlzdGVuOiBDbGFzcy5uZXN0ZWRFeHRlbmRQcm9wZXJ0eSgpLAogICAgICBkZWJ1Z19oYW5kbGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgcmVzdWx0LnB1c2goWyBjdXJzb3IuY2FsbGJhY2tzLCBjdXJzb3IuY29udGV4dCBdKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9LAogICAgICBkZWJ1Z19lbWl0OiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5oYW5kbGVyICYmICF0aGlzLmhhbmRsZXIuY2FsbGJhY2tzKSB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFja3M6IHRoaXMuaGFuZGxlciwKICAgICAgICAgIGNvbnRleHQ6IHRoaXMsCiAgICAgICAgICBoYW5kbGVyOiBudWxsCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgYWRkSGFuZGxlcjogZnVuY3Rpb24oY2FsbGJhY2tzLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKCFjYWxsYmFja3MpIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuRW1pdHRlciNhZGRIYW5kbGVyOiBjYWxsYmFja3MgaXMgbm90IGFuIG9iamVjdCAoIiwgY2FsbGJhY2tzLCAiKSIpOwogICAgICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IHRoaXM7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKSB7CiAgICAgICAgICBpZiAoY3Vyc29yLmNhbGxiYWNrcyA9PT0gY2FsbGJhY2tzICYmIGN1cnNvci5jb250ZXh0ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuRW1pdHRlciNhZGRIYW5kbGVyOiBhZGQgZHVwbGljYXRlIGV2ZW50IGNhbGxiYWNrcyIsIGNhbGxiYWNrcywgInRvIEVtaXR0ZXIgaW5zdGFuY2U6IiwgdGhpcyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmhhbmRsZXIgPSB7CiAgICAgICAgICBjYWxsYmFja3M6IGNhbGxiYWNrcywKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIKICAgICAgICB9OwogICAgICB9LAogICAgICByZW1vdmVIYW5kbGVyOiBmdW5jdGlvbihjYWxsYmFja3MsIGNvbnRleHQpIHsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB2YXIgcHJldjsKICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzOwogICAgICAgIHdoaWxlIChwcmV2ID0gY3Vyc29yLCBjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgaWYgKGN1cnNvci5jYWxsYmFja3MgPT09IGNhbGxiYWNrcyAmJiBjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgICAgY3Vyc29yLmNhbGxiYWNrcyA9IE5VTExfSEFORExFUjsKICAgICAgICAgIHByZXYuaGFuZGxlciA9IGN1cnNvci5oYW5kbGVyOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiLkVtaXR0ZXIjcmVtb3ZlSGFuZGxlcjogbm8gaGFuZGxlciByZW1vdmVkIik7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVzdHJveSA9IHdhcm5PbkRlc3Ryb3k7CiAgICAgICAgdGhpcy5lbWl0X2Rlc3Ryb3koKTsKICAgICAgICB0aGlzLmhhbmRsZXIgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBjcmVhdGU6IGNyZWF0ZURpc3BhdGNoZXIsCiAgICAgIGNyZWF0ZUhhbmRsZXI6IGNyZWF0ZUhhbmRsZXIsCiAgICAgIGV2ZW50czogZXZlbnRzLAogICAgICBFbWl0dGVyOiBFbWl0dGVyCiAgICB9OwogIH0sCiAgIjQuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMy5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBDbGFzcyA9IGJhc2lzLkNsYXNzOwogICAgdmFyIHNsaWNlQXJyYXkgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgICB2YXIgdmFsdWVzID0gYmFzaXMub2JqZWN0LnZhbHVlczsKICAgIHZhciAkc2VsZiA9IGJhc2lzLmZuLiRzZWxmOwogICAgdmFyIEVtaXR0ZXIgPSBiYXNpcy5ldmVudC5FbWl0dGVyOwogICAgdmFyIGNyZWF0ZUV2ZW50ID0gYmFzaXMuZXZlbnQuY3JlYXRlOwogICAgdmFyIGV2ZW50cyA9IGJhc2lzLmV2ZW50LmV2ZW50czsKICAgIHZhciBOVUxMX09CSkVDVCA9IHt9OwogICAgdmFyIEVNUFRZX0FSUkFZID0gW107CiAgICB2YXIgU1RBVEVfRVhJU1RTID0ge307CiAgICB2YXIgU1RBVEUgPSB7CiAgICAgIHByaW9yaXR5OiBbXSwKICAgICAgdmFsdWVzOiB7fSwKICAgICAgYWRkOiBmdW5jdGlvbihzdGF0ZSwgb3JkZXIpIHsKICAgICAgICB2YXIgbmFtZSA9IHN0YXRlOwogICAgICAgIHZhciB2YWx1ZSA9IHN0YXRlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgU1RBVEVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICBTVEFURV9FWElTVFNbdmFsdWVdID0gbmFtZTsKICAgICAgICB0aGlzLnZhbHVlc1t2YWx1ZV0gPSBuYW1lOwogICAgICAgIGlmIChvcmRlcikgb3JkZXIgPSB0aGlzLnByaW9yaXR5LmluZGV4T2Yob3JkZXIpOyBlbHNlIG9yZGVyID0gLTE7CiAgICAgICAgaWYgKG9yZGVyID09IC0xKSB0aGlzLnByaW9yaXR5LnB1c2godmFsdWUpOyBlbHNlIHRoaXMucHJpb3JpdHkuc3BsaWNlKG9yZGVyLCAwLCB2YWx1ZSk7CiAgICAgIH0sCiAgICAgIGdldExpc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB2YWx1ZXMoU1RBVEVfRVhJU1RTKTsKICAgICAgfQogICAgfTsKICAgIFNUQVRFLmFkZCgiUkVBRFkiKTsKICAgIFNUQVRFLmFkZCgiREVQUkVDQVRFRCIpOwogICAgU1RBVEUuYWRkKCJVTkRFRklORUQiKTsKICAgIFNUQVRFLmFkZCgiRVJST1IiKTsKICAgIFNUQVRFLmFkZCgiUFJPQ0VTU0lORyIpOwogICAgdmFyIHN1YnNjcmlwdGlvbkNvbmZpZyA9IHt9OwogICAgdmFyIHN1YnNjcmlwdGlvblNlZWQgPSAxOwogICAgdmFyIFNVQlNDUklQVElPTiA9IHsKICAgICAgTk9ORTogMCwKICAgICAgQUxMOiAwLAogICAgICBsaW5rOiBmdW5jdGlvbih0eXBlLCBmcm9tLCB0bykgewogICAgICAgIHZhciBzdWJzY3JpYmVySWQgPSB0eXBlICsgZnJvbS5iYXNpc09iamVjdElkOwogICAgICAgIHZhciBzdWJzY3JpYmVycyA9IHRvLnN1YnNjcmliZXJzXzsKICAgICAgICBpZiAoIXN1YnNjcmliZXJzKSBzdWJzY3JpYmVycyA9IHRvLnN1YnNjcmliZXJzXyA9IHt9OwogICAgICAgIGlmICghc3Vic2NyaWJlcnNbc3Vic2NyaWJlcklkXSkgewogICAgICAgICAgc3Vic2NyaWJlcnNbc3Vic2NyaWJlcklkXSA9IGZyb207CiAgICAgICAgICB2YXIgY291bnQgPSB0by5zdWJzY3JpYmVyQ291bnQgKz0gMTsKICAgICAgICAgIGlmIChjb3VudCA9PSAxKSB0by5lbWl0X3N1YnNjcmliZXJzQ2hhbmdlZCgrMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJBdHRlbXB0IHRvIGFkZCBkdXBsaWNhdGUgc3Vic2NyaXB0aW9uIik7CiAgICAgICAgfQogICAgICB9LAogICAgICB1bmxpbms6IGZ1bmN0aW9uKHR5cGUsIGZyb20sIHRvKSB7CiAgICAgICAgdmFyIHN1YnNjcmliZXJJZCA9IHR5cGUgKyBmcm9tLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgdmFyIHN1YnNjcmliZXJzID0gdG8uc3Vic2NyaWJlcnNfOwogICAgICAgIGlmIChzdWJzY3JpYmVycyAmJiBzdWJzY3JpYmVyc1tzdWJzY3JpYmVySWRdKSB7CiAgICAgICAgICBkZWxldGUgc3Vic2NyaWJlcnNbc3Vic2NyaWJlcklkXTsKICAgICAgICAgIHZhciBjb3VudCA9IHRvLnN1YnNjcmliZXJDb3VudCAtPSAxOwogICAgICAgICAgaWYgKGNvdW50ID09IDApIHsKICAgICAgICAgICAgdG8uZW1pdF9zdWJzY3JpYmVyc0NoYW5nZWQoLTEpOwogICAgICAgICAgICB0by5zdWJzY3JpYmVyc18gPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiVHJ5aW5nIHJlbW92ZSBub24tZXhpc3RzIHN1YnNjcmlwdGlvbiIpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYWRkOiBmdW5jdGlvbihuYW1lLCBoYW5kbGVyLCBhY3Rpb24pIHsKICAgICAgICBzdWJzY3JpcHRpb25Db25maWdbc3Vic2NyaXB0aW9uU2VlZF0gPSB7CiAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgICAgYWN0aW9uOiBhY3Rpb24KICAgICAgICB9OwogICAgICAgIFNVQlNDUklQVElPTltuYW1lXSA9IHN1YnNjcmlwdGlvblNlZWQ7CiAgICAgICAgU1VCU0NSSVBUSU9OLkFMTCB8PSBzdWJzY3JpcHRpb25TZWVkOwogICAgICAgIHN1YnNjcmlwdGlvblNlZWQgPDw9IDE7CiAgICAgIH0sCiAgICAgIGFkZFByb3BlcnR5OiBmdW5jdGlvbihwcm9wZXJ0eU5hbWUsIGV2ZW50TmFtZSkgewogICAgICAgIHZhciBoYW5kbGVyID0ge307CiAgICAgICAgaGFuZGxlcltldmVudE5hbWUgfHwgcHJvcGVydHlOYW1lICsgIkNoYW5nZWQiXSA9IGZ1bmN0aW9uKG9iamVjdCwgb2xkVmFsdWUpIHsKICAgICAgICAgIGlmIChvbGRWYWx1ZSBpbnN0YW5jZW9mIEFic3RyYWN0RGF0YSkgU1VCU0NSSVBUSU9OLnVubGluayhwcm9wZXJ0eU5hbWUsIG9iamVjdCwgb2xkVmFsdWUpOwogICAgICAgICAgaWYgKG9iamVjdFtwcm9wZXJ0eU5hbWVdIGluc3RhbmNlb2YgQWJzdHJhY3REYXRhKSBTVUJTQ1JJUFRJT04ubGluayhwcm9wZXJ0eU5hbWUsIG9iamVjdCwgb2JqZWN0W3Byb3BlcnR5TmFtZV0pOwogICAgICAgIH07CiAgICAgICAgdGhpcy5hZGQocHJvcGVydHlOYW1lLnRvVXBwZXJDYXNlKCksIGhhbmRsZXIsIGZ1bmN0aW9uKGZuLCBvYmplY3QpIHsKICAgICAgICAgIGlmIChvYmplY3RbcHJvcGVydHlOYW1lXSkgZm4ocHJvcGVydHlOYW1lLCBvYmplY3QsIG9iamVjdFtwcm9wZXJ0eU5hbWVdKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICAgIHZhciBtYXNrQ29uZmlnID0ge307CiAgICBmdW5jdGlvbiBtaXhGdW5jdGlvbnMoZm5BLCBmbkIpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIGZuQS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIGZuQi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gZ2V0TWFza0NvbmZpZyhtYXNrKSB7CiAgICAgIHZhciBjb25maWcgPSBtYXNrQ29uZmlnW21hc2tdOwogICAgICBpZiAoIWNvbmZpZykgewogICAgICAgIHZhciBhY3Rpb25zID0gW107CiAgICAgICAgdmFyIGhhbmRsZXIgPSB7fTsKICAgICAgICB2YXIgaWR4ID0gMTsKICAgICAgICBjb25maWcgPSBtYXNrQ29uZmlnW21hc2tdID0gewogICAgICAgICAgYWN0aW9uczogYWN0aW9ucywKICAgICAgICAgIGhhbmRsZXI6IGhhbmRsZXIKICAgICAgICB9OwogICAgICAgIHdoaWxlIChtYXNrKSB7CiAgICAgICAgICBpZiAobWFzayAmIDEpIHsKICAgICAgICAgICAgdmFyIGNmZyA9IHN1YnNjcmlwdGlvbkNvbmZpZ1tpZHhdOwogICAgICAgICAgICBhY3Rpb25zLnB1c2goY2ZnLmFjdGlvbik7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBjZmcuaGFuZGxlcikgaGFuZGxlcltrZXldID0gaGFuZGxlcltrZXldID8gbWl4RnVuY3Rpb25zKGhhbmRsZXJba2V5XSwgY2ZnLmhhbmRsZXJba2V5XSkgOiBjZmcuaGFuZGxlcltrZXldOwogICAgICAgICAgfQogICAgICAgICAgaWR4IDw8PSAxOwogICAgICAgICAgbWFzayA+Pj0gMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbmZpZzsKICAgIH0KICAgIGZ1bmN0aW9uIGFkZFN1YihvYmplY3QsIG1hc2spIHsKICAgICAgdmFyIGNvbmZpZyA9IGdldE1hc2tDb25maWcobWFzayk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhY3Rpb247IGFjdGlvbiA9IGNvbmZpZy5hY3Rpb25zW2ldOyBpKyspIGFjdGlvbihTVUJTQ1JJUFRJT04ubGluaywgb2JqZWN0KTsKICAgICAgb2JqZWN0LmFkZEhhbmRsZXIoY29uZmlnLmhhbmRsZXIpOwogICAgfQogICAgZnVuY3Rpb24gcmVtU3ViKG9iamVjdCwgbWFzaykgewogICAgICB2YXIgY29uZmlnID0gZ2V0TWFza0NvbmZpZyhtYXNrKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGFjdGlvbjsgYWN0aW9uID0gY29uZmlnLmFjdGlvbnNbaSsrXTsgKSBhY3Rpb24oU1VCU0NSSVBUSU9OLnVubGluaywgb2JqZWN0KTsKICAgICAgb2JqZWN0LnJlbW92ZUhhbmRsZXIoY29uZmlnLmhhbmRsZXIpOwogICAgfQogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJkZWxlZ2F0ZSIpOwogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJ0YXJnZXQiKTsKICAgIFNVQlNDUklQVElPTi5hZGRQcm9wZXJ0eSgiZGF0YXNldCIpOwogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJ2YWx1ZSIsICJjaGFuZ2UiKTsKICAgIHZhciBBYnN0cmFjdERhdGEgPSBDbGFzcyhFbWl0dGVyLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5BYnN0cmFjdERhdGEiLAogICAgICBzdGF0ZTogU1RBVEUuVU5ERUZJTkVELAogICAgICBlbWl0X3N0YXRlQ2hhbmdlZDogY3JlYXRlRXZlbnQoInN0YXRlQ2hhbmdlZCIsICJvbGRTdGF0ZSIpLAogICAgICBhY3RpdmU6IGZhbHNlLAogICAgICBlbWl0X2FjdGl2ZUNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJhY3RpdmVDaGFuZ2VkIiksCiAgICAgIHN1YnNjcmliZVRvOiBTVUJTQ1JJUFRJT04uTk9ORSwKICAgICAgc3Vic2NyaWJlckNvdW50OiAwLAogICAgICBzdWJzY3JpYmVyc186IG51bGwsCiAgICAgIGVtaXRfc3Vic2NyaWJlcnNDaGFuZ2VkOiBjcmVhdGVFdmVudCgic3Vic2NyaWJlcnNDaGFuZ2VkIiwgImRlbHRhIiksCiAgICAgIHN5bmNFdmVudHM6IENsYXNzLm9uZUZ1bmN0aW9uUHJvcGVydHkoZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuaXNTeW5jUmVxdWlyZWQoKSkgdGhpcy5zeW5jQWN0aW9uKCk7CiAgICAgIH0sIHsKICAgICAgICBzdGF0ZUNoYW5nZWQ6IHRydWUsCiAgICAgICAgc3Vic2NyaWJlcnNDaGFuZ2VkOiB0cnVlCiAgICAgIH0pLAogICAgICBzeW5jQWN0aW9uOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlKSB0aGlzLmFkZEhhbmRsZXIoZ2V0TWFza0NvbmZpZyh0aGlzLnN1YnNjcmliZVRvKS5oYW5kbGVyKTsKICAgICAgICB2YXIgc3luY0FjdGlvbiA9IHRoaXMuc3luY0FjdGlvbjsKICAgICAgICBpZiAoc3luY0FjdGlvbikgewogICAgICAgICAgdGhpcy5zeW5jQWN0aW9uID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2V0U3luY0FjdGlvbihzeW5jQWN0aW9uKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFN0YXRlOiBmdW5jdGlvbihzdGF0ZSwgZGF0YSkgewogICAgICAgIHZhciBzdGF0ZUNvZGUgPSBTdHJpbmcoc3RhdGUpOwogICAgICAgIGlmICghU1RBVEVfRVhJU1RTW3N0YXRlQ29kZV0pIHRocm93IG5ldyBFcnJvcigiV3Jvbmcgc3RhdGUgdmFsdWUiKTsKICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPSBzdGF0ZUNvZGUgfHwgdGhpcy5zdGF0ZS5kYXRhICE9IGRhdGEpIHsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IHRoaXMuc3RhdGU7CiAgICAgICAgICB0aGlzLnN0YXRlID0gT2JqZWN0KHN0YXRlQ29kZSk7CiAgICAgICAgICB0aGlzLnN0YXRlLmRhdGEgPSBkYXRhOwogICAgICAgICAgdGhpcy5lbWl0X3N0YXRlQ2hhbmdlZChvbGRTdGF0ZSk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAogICAgICBkZXByZWNhdGU6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnN0YXRlICE9IFNUQVRFLlBST0NFU1NJTkcpIHRoaXMuc2V0U3RhdGUoU1RBVEUuREVQUkVDQVRFRCk7CiAgICAgIH0sCiAgICAgIHNldEFjdGl2ZTogZnVuY3Rpb24oaXNBY3RpdmUpIHsKICAgICAgICBpc0FjdGl2ZSA9ICEhaXNBY3RpdmU7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlICE9IGlzQWN0aXZlKSB7CiAgICAgICAgICB0aGlzLmFjdGl2ZSA9IGlzQWN0aXZlOwogICAgICAgICAgdGhpcy5lbWl0X2FjdGl2ZUNoYW5nZWQoKTsKICAgICAgICAgIGlmIChpc0FjdGl2ZSkgYWRkU3ViKHRoaXMsIHRoaXMuc3Vic2NyaWJlVG8pOyBlbHNlIHJlbVN1Yih0aGlzLCB0aGlzLnN1YnNjcmliZVRvKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0sCiAgICAgIHNldFN1YnNjcmlwdGlvbjogZnVuY3Rpb24oc3Vic2NyaXB0aW9uVHlwZSkgewogICAgICAgIHZhciBjdXJTdWJzY3JpcHRpb25UeXBlID0gdGhpcy5zdWJzY3JpYmVUbzsKICAgICAgICB2YXIgbmV3U3Vic2NyaXB0aW9uVHlwZSA9IHN1YnNjcmlwdGlvblR5cGUgJiBTVUJTQ1JJUFRJT04uQUxMOwogICAgICAgIHZhciBkZWx0YSA9IGN1clN1YnNjcmlwdGlvblR5cGUgXiBuZXdTdWJzY3JpcHRpb25UeXBlOwogICAgICAgIGlmIChkZWx0YSkgewogICAgICAgICAgdGhpcy5zdWJzY3JpYmVUbyA9IG5ld1N1YnNjcmlwdGlvblR5cGU7CiAgICAgICAgICBpZiAodGhpcy5hY3RpdmUpIHsKICAgICAgICAgICAgdmFyIGN1ckNvbmZpZyA9IGdldE1hc2tDb25maWcoY3VyU3Vic2NyaXB0aW9uVHlwZSk7CiAgICAgICAgICAgIHZhciBuZXdDb25maWcgPSBnZXRNYXNrQ29uZmlnKG5ld1N1YnNjcmlwdGlvblR5cGUpOwogICAgICAgICAgICB0aGlzLnJlbW92ZUhhbmRsZXIoY3VyQ29uZmlnLmhhbmRsZXIpOwogICAgICAgICAgICB0aGlzLmFkZEhhbmRsZXIobmV3Q29uZmlnLmhhbmRsZXIpOwogICAgICAgICAgICB2YXIgaWR4ID0gMTsKICAgICAgICAgICAgd2hpbGUgKGRlbHRhKSB7CiAgICAgICAgICAgICAgaWYgKGRlbHRhICYgMSkgewogICAgICAgICAgICAgICAgdmFyIGNmZyA9IHN1YnNjcmlwdGlvbkNvbmZpZ1tpZHhdOwogICAgICAgICAgICAgICAgaWYgKGN1clN1YnNjcmlwdGlvblR5cGUgJiBpZHgpIGNmZy5hY3Rpb24oU1VCU0NSSVBUSU9OLnVubGluaywgdGhpcyk7IGVsc2UgY2ZnLmFjdGlvbihTVUJTQ1JJUFRJT04ubGluaywgdGhpcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlkeCA8PD0gMTsKICAgICAgICAgICAgICBkZWx0YSA+Pj0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgaXNTeW5jUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnN1YnNjcmliZXJDb3VudCA+IDAgJiYgKHRoaXMuc3RhdGUgPT0gU1RBVEUuVU5ERUZJTkVEIHx8IHRoaXMuc3RhdGUgPT0gU1RBVEUuREVQUkVDQVRFRCk7CiAgICAgIH0sCiAgICAgIHNldFN5bmNBY3Rpb246IGZ1bmN0aW9uKHN5bmNBY3Rpb24pIHsKICAgICAgICB2YXIgb2xkQWN0aW9uID0gdGhpcy5zeW5jQWN0aW9uOwogICAgICAgIGlmICh0eXBlb2Ygc3luY0FjdGlvbiAhPSAiZnVuY3Rpb24iKSBzeW5jQWN0aW9uID0gbnVsbDsKICAgICAgICB0aGlzLnN5bmNBY3Rpb24gPSBzeW5jQWN0aW9uOwogICAgICAgIGlmIChzeW5jQWN0aW9uKSB7CiAgICAgICAgICBpZiAoIW9sZEFjdGlvbikgdGhpcy5hZGRIYW5kbGVyKHRoaXMuc3luY0V2ZW50cyk7CiAgICAgICAgICBpZiAodGhpcy5pc1N5bmNSZXF1aXJlZCgpKSB0aGlzLnN5bmNBY3Rpb24oKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKG9sZEFjdGlvbikgdGhpcy5yZW1vdmVIYW5kbGVyKHRoaXMuc3luY0V2ZW50cyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgaWYgKHRoaXMuYWN0aXZlKSB7CiAgICAgICAgICB2YXIgY29uZmlnID0gZ2V0TWFza0NvbmZpZyh0aGlzLnN1YnNjcmliZVRvKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBhY3Rpb247IGFjdGlvbiA9IGNvbmZpZy5hY3Rpb25zW2ldOyBpKyspIGFjdGlvbihTVUJTQ1JJUFRJT04udW5saW5rLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zdGF0ZSA9IFNUQVRFLlVOREVGSU5FRDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgR0VUVEVSX0lEID0gYmFzaXMuZ2V0dGVyLklEOwogICAgdmFyIFZBTFVFX0VNTUlURVJfSEFORExFUiA9IHsKICAgICAgZGVzdHJveTogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgdGhpcy52YWx1ZS51bmxpbmsob2JqZWN0LCB0aGlzLmZuKTsKICAgICAgfQogICAgfTsKICAgIHZhciBWQUxVRV9FTU1JVEVSX0RFU1RST1lfSEFORExFUiA9IHsKICAgICAgZGVzdHJveTogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgdGhpcy5zZXQobnVsbCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgY29tcHV0ZUZ1bmN0aW9ucyA9IHt9OwogICAgdmFyIHZhbHVlU2V0dGVycyA9IHt9OwogICAgdmFyIHZhbHVlU3luY1Rva2VuID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy5zZXQodGhpcy5mbih2YWx1ZSkpOwogICAgfTsKICAgIHZhciBWYWx1ZSA9IENsYXNzKEFic3RyYWN0RGF0YSwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVmFsdWUiLAogICAgICBzdWJzY3JpYmVUbzogU1VCU0NSSVBUSU9OLlZBTFVFLAogICAgICBlbWl0X2NoYW5nZTogY3JlYXRlRXZlbnQoImNoYW5nZSIsICJvbGRWYWx1ZSIpICYmIGZ1bmN0aW9uKG9sZFZhbHVlKSB7CiAgICAgICAgZXZlbnRzLmNoYW5nZS5jYWxsKHRoaXMsIG9sZFZhbHVlKTsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmxpbmtzXykgY3Vyc29yLmZuLmNhbGwoY3Vyc29yLmNvbnRleHQsIHRoaXMudmFsdWUsIG9sZFZhbHVlKTsKICAgICAgfSwKICAgICAgdmFsdWU6IG51bGwsCiAgICAgIGluaXRWYWx1ZTogbnVsbCwKICAgICAgcHJveHk6IG51bGwsCiAgICAgIGxvY2tlZDogMCwKICAgICAgbG9ja2VkVmFsdWVfOiBudWxsLAogICAgICBsaW5rc186IG51bGwsCiAgICAgIHNldE51bGxPbkVtaXR0ZXJEZXN0cm95OiB0cnVlLAogICAgICBiaW5kaW5nQnJpZGdlOiB7CiAgICAgICAgYXR0YWNoOiBmdW5jdGlvbihob3N0LCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgaG9zdC5saW5rKGNvbnRleHQsIGNhbGxiYWNrLCB0cnVlKTsKICAgICAgICB9LAogICAgICAgIGRldGFjaDogZnVuY3Rpb24oaG9zdCwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgICAgIGhvc3QudW5saW5rKGNvbnRleHQsIGNhbGxiYWNrKTsKICAgICAgICB9LAogICAgICAgIGdldDogZnVuY3Rpb24oaG9zdCkgewogICAgICAgICAgcmV0dXJuIGhvc3QudmFsdWU7CiAgICAgICAgfQogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICBpZiAodGhpcy5wcm94eSkgdGhpcy52YWx1ZSA9IHRoaXMucHJveHkodGhpcy52YWx1ZSk7CiAgICAgICAgaWYgKHRoaXMuc2V0TnVsbE9uRW1pdHRlckRlc3Ryb3kgJiYgdGhpcy52YWx1ZSBpbnN0YW5jZW9mIEVtaXR0ZXIpIHRoaXMudmFsdWUuYWRkSGFuZGxlcihWQUxVRV9FTU1JVEVSX0RFU1RST1lfSEFORExFUiwgdGhpcyk7CiAgICAgICAgdGhpcy5pbml0VmFsdWUgPSB0aGlzLnZhbHVlOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIG9sZFZhbHVlID0gdGhpcy52YWx1ZTsKICAgICAgICB2YXIgbmV3VmFsdWUgPSB0aGlzLnByb3h5ID8gdGhpcy5wcm94eSh2YWx1ZSkgOiB2YWx1ZTsKICAgICAgICB2YXIgY2hhbmdlZCA9IG5ld1ZhbHVlICE9PSBvbGRWYWx1ZTsKICAgICAgICBpZiAoY2hhbmdlZCkgewogICAgICAgICAgaWYgKHRoaXMuc2V0TnVsbE9uRW1pdHRlckRlc3Ryb3kpIHsKICAgICAgICAgICAgaWYgKG9sZFZhbHVlIGluc3RhbmNlb2YgRW1pdHRlcikgb2xkVmFsdWUucmVtb3ZlSGFuZGxlcihWQUxVRV9FTU1JVEVSX0RFU1RST1lfSEFORExFUiwgdGhpcyk7CiAgICAgICAgICAgIGlmIChuZXdWYWx1ZSBpbnN0YW5jZW9mIEVtaXR0ZXIpIG5ld1ZhbHVlLmFkZEhhbmRsZXIoVkFMVUVfRU1NSVRFUl9ERVNUUk9ZX0hBTkRMRVIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy52YWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgaWYgKCF0aGlzLmxvY2tlZCkgdGhpcy5lbWl0X2NoYW5nZShvbGRWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjaGFuZ2VkOwogICAgICB9LAogICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXQodGhpcy5pbml0VmFsdWUpOwogICAgICB9LAogICAgICBpc0xvY2tlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9ja2VkID4gMDsKICAgICAgfSwKICAgICAgbG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5sb2NrZWQrKzsKICAgICAgICBpZiAodGhpcy5sb2NrZWQgPT0gMSkgdGhpcy5sb2NrZWRWYWx1ZV8gPSB0aGlzLnZhbHVlOwogICAgICB9LAogICAgICB1bmxvY2s6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmxvY2tlZCkgewogICAgICAgICAgdGhpcy5sb2NrZWQtLTsKICAgICAgICAgIGlmICghdGhpcy5sb2NrZWQpIHsKICAgICAgICAgICAgdmFyIGxvY2tlZFZhbHVlID0gdGhpcy5sb2NrZWRWYWx1ZV87CiAgICAgICAgICAgIHRoaXMubG9ja2VkVmFsdWVfID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IGxvY2tlZFZhbHVlKSB0aGlzLmVtaXRfY2hhbmdlKGxvY2tlZFZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNvbXB1dGU6IGZ1bmN0aW9uKGV2ZW50cywgZm4pIHsKICAgICAgICBpZiAoIWZuKSB7CiAgICAgICAgICBmbiA9IGV2ZW50czsKICAgICAgICAgIGV2ZW50cyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICghZm4pIGZuID0gJHNlbGY7CiAgICAgICAgdmFyIGhvc3RWYWx1ZSA9IHRoaXM7CiAgICAgICAgdmFyIGhhbmRsZXIgPSBiYXNpcy5ldmVudC5jcmVhdGVIYW5kbGVyKGV2ZW50cywgZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICB0aGlzLnNldChmbihvYmplY3QsIGhvc3RWYWx1ZS52YWx1ZSkpOwogICAgICAgIH0pOwogICAgICAgIHZhciBmbklkID0gZm5bR0VUVEVSX0lEXSB8fCBTdHJpbmcoZm4pOwogICAgICAgIHZhciBnZXRDb21wdXRlVG9rZW5JZCA9IGhhbmRsZXIuZXZlbnRzLmNvbmNhdChmbklkLCB0aGlzLmJhc2lzT2JqZWN0SWQpLmpvaW4oIl8iKTsKICAgICAgICB2YXIgZ2V0Q29tcHV0ZVRva2VuID0gY29tcHV0ZUZ1bmN0aW9uc1tnZXRDb21wdXRlVG9rZW5JZF07CiAgICAgICAgaWYgKCFnZXRDb21wdXRlVG9rZW4pIHsKICAgICAgICAgIHZhciB0b2tlbk1hcCA9IHt9OwogICAgICAgICAgaGFuZGxlci5kZXN0cm95ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIGRlbGV0ZSB0b2tlbk1hcFtvYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgICAgICAgIHRoaXMuZGVzdHJveSgpOwogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMuYWRkSGFuZGxlcih7CiAgICAgICAgICAgIGNoYW5nZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHRva2VuTWFwKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFpciA9IHRva2VuTWFwW2tleV07CiAgICAgICAgICAgICAgICBwYWlyLnRva2VuLnNldChmbihwYWlyLm9iamVjdCwgdGhpcy52YWx1ZSkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHRva2VuTWFwKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFpciA9IHRva2VuTWFwW2tleV07CiAgICAgICAgICAgICAgICBwYWlyLm9iamVjdC5yZW1vdmVIYW5kbGVyKGhhbmRsZXIsIHBhaXIudG9rZW4pOwogICAgICAgICAgICAgICAgcGFpci50b2tlbi5kZXN0cm95KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRva2VuTWFwID0gbnVsbDsKICAgICAgICAgICAgICBob3N0VmFsdWUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGdldENvbXB1dGVUb2tlbiA9IGNvbXB1dGVGdW5jdGlvbnNbZ2V0Q29tcHV0ZVRva2VuSWRdID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiBiYXNpcy5ldmVudC5FbWl0dGVyID09IGZhbHNlKSBiYXNpcy5kZXYud2FybigiYmFzaXMuZGF0YS5WYWx1ZSNjb21wdXRlOiBvYmplY3Qgc2hvdWxkIGJlIGFuIGluc3RhbmNlb2YgYmFzaXMuZXZlbnQuRW1pdHRlciIpOwogICAgICAgICAgICB2YXIgb2JqZWN0SWQgPSBvYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgdmFyIHBhaXIgPSB0b2tlbk1hcFtvYmplY3RJZF07CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGZuKG9iamVjdCwgaG9zdFZhbHVlLnZhbHVlKTsKICAgICAgICAgICAgaWYgKCFwYWlyKSB7CiAgICAgICAgICAgICAgdmFyIHRva2VuID0gbmV3IGJhc2lzLlRva2VuKHZhbHVlKTsKICAgICAgICAgICAgICBvYmplY3QuYWRkSGFuZGxlcihoYW5kbGVyLCB0b2tlbik7CiAgICAgICAgICAgICAgcGFpciA9IHRva2VuTWFwW29iamVjdElkXSA9IHsKICAgICAgICAgICAgICAgIHRva2VuOiB0b2tlbiwKICAgICAgICAgICAgICAgIG9iamVjdDogb2JqZWN0CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwYWlyLnRva2VuLnNldCh2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhaXIudG9rZW47CiAgICAgICAgICB9OwogICAgICAgICAgZ2V0Q29tcHV0ZVRva2VuLmRlZmVycmVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcHV0ZVRva2VuKG9iamVjdCkuZGVmZXJyZWQoKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXRDb21wdXRlVG9rZW47CiAgICAgIH0sCiAgICAgIGFzOiBmdW5jdGlvbihmbiwgZGVmZXJyZWQpIHsKICAgICAgICBpZiAoIWZuKSBmbiA9ICRzZWxmOwogICAgICAgIGlmICh0aGlzLmxpbmtzXykgewogICAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgICB2YXIgZm5JZCA9IGZuW0dFVFRFUl9JRF0gfHwgU3RyaW5nKGZuKTsKICAgICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IubGlua3NfKSB7CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0gY3Vyc29yLmNvbnRleHQ7CiAgICAgICAgICAgIGlmIChjb250ZXh0IGluc3RhbmNlb2YgYmFzaXMuVG9rZW4gJiYgKGNvbnRleHQuZm5bR0VUVEVSX0lEXSB8fCBTdHJpbmcoY29udGV4dC5mbikpID09IGZuSWQpIHJldHVybiBkZWZlcnJlZCA/IGNvbnRleHQuZGVmZXJyZWQoKSA6IGNvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB0b2tlbiA9IG5ldyBiYXNpcy5Ub2tlbjsKICAgICAgICB0b2tlbi5mbiA9IGZuOwogICAgICAgIHRoaXMubGluayh0b2tlbiwgdmFsdWVTeW5jVG9rZW4pOwogICAgICAgIHJldHVybiBkZWZlcnJlZCA/IHRva2VuLmRlZmVycmVkKCkgOiB0b2tlbjsKICAgICAgfSwKICAgICAgZGVmZXJyZWQ6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYXMoZm4sIHRydWUpOwogICAgICB9LAogICAgICBsaW5rOiBmdW5jdGlvbihjb250ZXh0LCBmbiwgbm9BcHBseSkgewogICAgICAgIGlmICh0eXBlb2YgZm4gIT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdmFyIHByb3BlcnR5ID0gU3RyaW5nKGZuKTsKICAgICAgICAgIGZuID0gdmFsdWVTZXR0ZXJzW3Byb3BlcnR5XTsKICAgICAgICAgIGlmICghZm4pIGZuID0gdmFsdWVTZXR0ZXJzW3Byb3BlcnR5XSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXNbcHJvcGVydHldID0gdmFsdWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmxpbmtzXykgaWYgKGN1cnNvci5jb250ZXh0ID09PSBjb250ZXh0ICYmIGN1cnNvci5mbiA9PT0gZm4pIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKHRoaXMuY29uc3RydWN0b3IuY2xhc3NOYW1lICsgIiNhdHRhY2g6IER1cGxpY2F0ZSBsaW5rIHBhaXIgY29udGV4dC1mbiIpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHRoaXMubGlua3NfID0gewogICAgICAgICAgdmFsdWU6IHRoaXMsCiAgICAgICAgICBjb250ZXh0OiBjb250ZXh0LAogICAgICAgICAgZm46IGZuLAogICAgICAgICAgbGlua3NfOiB0aGlzLmxpbmtzXwogICAgICAgIH07CiAgICAgICAgaWYgKGNvbnRleHQgaW5zdGFuY2VvZiBFbWl0dGVyKSBjb250ZXh0LmFkZEhhbmRsZXIoVkFMVUVfRU1NSVRFUl9IQU5ETEVSLCB0aGlzLmxpbmtzXyk7CiAgICAgICAgaWYgKCFub0FwcGx5KSBmbi5jYWxsKGNvbnRleHQsIHRoaXMudmFsdWUpOwogICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICB9LAogICAgICB1bmxpbms6IGZ1bmN0aW9uKGNvbnRleHQsIGZuKSB7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgdmFyIHByZXY7CiAgICAgICAgd2hpbGUgKHByZXYgPSBjdXJzb3IsIGN1cnNvciA9IGN1cnNvci5saW5rc18pIGlmIChjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCAmJiAoIWZuIHx8IGN1cnNvci5mbiA9PT0gZm4pKSB7CiAgICAgICAgICBjdXJzb3IuZm4gPSBiYXNpcy5mbi4kdW5kZWY7CiAgICAgICAgICBwcmV2LmxpbmtzXyA9IGN1cnNvci5saW5rc187CiAgICAgICAgICBpZiAoY3Vyc29yLmNvbnRleHQgaW5zdGFuY2VvZiBFbWl0dGVyKSBjdXJzb3IuY29udGV4dC5yZW1vdmVIYW5kbGVyKFZBTFVFX0VNTUlURVJfSEFORExFUiwgY3Vyc29yKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIEFic3RyYWN0RGF0YS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIGlmICh0aGlzLnNldE51bGxPbkVtaXR0ZXJEZXN0cm95ICYmIHRoaXMudmFsdWUgaW5zdGFuY2VvZiBFbWl0dGVyKSB0aGlzLnZhbHVlLnJlbW92ZUhhbmRsZXIoVkFMVUVfRU1NSVRFUl9ERVNUUk9ZX0hBTkRMRVIsIHRoaXMpOwogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IubGlua3NfKSBpZiAoY3Vyc29yLmNvbnRleHQgaW5zdGFuY2VvZiBFbWl0dGVyKSBjdXJzb3IuY29udGV4dC5yZW1vdmVIYW5kbGVyKFZBTFVFX0VNTUlURVJfSEFORExFUiwgY3Vyc29yKTsKICAgICAgICB0aGlzLnByb3h5ID0gbnVsbDsKICAgICAgICB0aGlzLmluaXRWYWx1ZSA9IG51bGw7CiAgICAgICAgdGhpcy52YWx1ZSA9IG51bGw7CiAgICAgICAgdGhpcy5sb2NrZWRWYWx1ZV8gPSBudWxsOwogICAgICAgIHRoaXMubGlua3NfID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgdmFsdWVGcm9tTWFwID0ge307CiAgICB2YXIgdmFsdWVGcm9tU2V0UHJveHkgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgVmFsdWUucHJvdG90eXBlLnNldC5jYWxsKHRoaXMsIG9iamVjdCk7CiAgICB9OwogICAgVmFsdWUuZnJvbSA9IGZ1bmN0aW9uKG9iaiwgZXZlbnRzLCBnZXR0ZXIpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgaWYgKCFvYmopIHJldHVybiBudWxsOwogICAgICBpZiAob2JqIGluc3RhbmNlb2YgRW1pdHRlcikgewogICAgICAgIGlmICghZ2V0dGVyKSB7CiAgICAgICAgICBnZXR0ZXIgPSBldmVudHM7CiAgICAgICAgICBldmVudHMgPSBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAoIWdldHRlcikgZ2V0dGVyID0gJHNlbGY7CiAgICAgICAgdmFyIGhhbmRsZXIgPSBiYXNpcy5ldmVudC5jcmVhdGVIYW5kbGVyKGV2ZW50cywgdmFsdWVGcm9tU2V0UHJveHkpOwogICAgICAgIHZhciBnZXR0ZXJJZCA9IGdldHRlcltHRVRURVJfSURdIHx8IFN0cmluZyhnZXR0ZXIpOwogICAgICAgIHZhciBpZCA9IGhhbmRsZXIuZXZlbnRzLmNvbmNhdChnZXR0ZXJJZCwgb2JqLmJhc2lzT2JqZWN0SWQpLmpvaW4oIl8iKTsKICAgICAgICByZXN1bHQgPSB2YWx1ZUZyb21NYXBbaWRdOwogICAgICAgIGlmICghcmVzdWx0KSB7CiAgICAgICAgICByZXN1bHQgPSB2YWx1ZUZyb21NYXBbaWRdID0gbmV3IFZhbHVlKHsKICAgICAgICAgICAgdmFsdWU6IG9iaiwKICAgICAgICAgICAgcHJveHk6IGJhc2lzLmdldHRlcihnZXR0ZXIpLAogICAgICAgICAgICBzZXQ6IGJhc2lzLmZuLiR1bmRlZiwKICAgICAgICAgICAgaGFuZGxlcjogewogICAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFsdWVGcm9tTWFwW2lkXSA9IG51bGw7CiAgICAgICAgICAgICAgICBvYmoucmVtb3ZlSGFuZGxlcihoYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgaGFuZGxlci5kZXN0cm95ID0gZnVuY3Rpb24oc2VuZGVyKSB7CiAgICAgICAgICAgIHZhbHVlRnJvbU1hcFtpZF0gPSBudWxsOwogICAgICAgICAgICB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgIH07CiAgICAgICAgICBvYmouYWRkSGFuZGxlcihoYW5kbGVyLCByZXN1bHQpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgIHZhciBpZCA9IG9iai5iYXNpc09iamVjdElkOwogICAgICAgIHZhciBiaW5kaW5nQnJpZGdlID0gb2JqLmJpbmRpbmdCcmlkZ2U7CiAgICAgICAgaWYgKGlkICYmIGJpbmRpbmdCcmlkZ2UpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlRnJvbU1hcFtpZF07CiAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICByZXN1bHQgPSB2YWx1ZUZyb21NYXBbaWRdID0gbmV3IFZhbHVlKHsKICAgICAgICAgICAgICB2YWx1ZTogYmluZGluZ0JyaWRnZS5nZXQob2JqKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYmluZGluZ0JyaWRnZS5hdHRhY2gob2JqLCByZXN1bHQuc2V0LCByZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIXJlc3VsdCkgdGhyb3cgIkJhZCBvYmplY3QgdHlwZSI7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgVmFsdWUuZmFjdG9yeSA9IGZ1bmN0aW9uKGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gVmFsdWUuZnJvbShvYmplY3QsIGV2ZW50cywgZ2V0dGVyKTsKICAgICAgfTsKICAgIH07CiAgICB2YXIgSU5JVF9EQVRBID0ge307CiAgICBmdW5jdGlvbiBpc0Nvbm5lY3RlZChhLCBiKSB7CiAgICAgIHdoaWxlIChiICYmIGIgIT09IGEgJiYgYiAhPT0gYi5kZWxlZ2F0ZSkgYiA9IGIuZGVsZWdhdGU7CiAgICAgIHJldHVybiBiID09PSBhOwogICAgfQogICAgZnVuY3Rpb24gYXBwbHlEZWxlZ2F0ZUNoYW5nZXMob2JqZWN0LCBvbGRSb290LCBvbGRUYXJnZXQpIHsKICAgICAgdmFyIGRlbGVnYXRlID0gb2JqZWN0LmRlbGVnYXRlOwogICAgICBpZiAoZGVsZWdhdGUpIHsKICAgICAgICBvYmplY3Qucm9vdCA9IGRlbGVnYXRlLnJvb3Q7CiAgICAgICAgb2JqZWN0LnRhcmdldCA9IGRlbGVnYXRlLnRhcmdldDsKICAgICAgICBvYmplY3QuZGF0YSA9IGRlbGVnYXRlLmRhdGE7CiAgICAgICAgb2JqZWN0LnN0YXRlID0gZGVsZWdhdGUuc3RhdGU7CiAgICAgIH0KICAgICAgaWYgKG9iamVjdC5yb290ICE9PSBvbGRSb290KSB7CiAgICAgICAgdmFyIHJvb3RMaXN0ZW5IYW5kbGVyID0gb2JqZWN0Lmxpc3Rlbi5yb290OwogICAgICAgIGlmIChyb290TGlzdGVuSGFuZGxlcikgewogICAgICAgICAgaWYgKG9sZFJvb3QgJiYgb2xkUm9vdCAhPT0gb2JqZWN0KSBvbGRSb290LnJlbW92ZUhhbmRsZXIocm9vdExpc3RlbkhhbmRsZXIsIG9iamVjdCk7CiAgICAgICAgICBpZiAob2JqZWN0LnJvb3QgJiYgb2JqZWN0LnJvb3QgIT09IG9iamVjdCkgb2JqZWN0LnJvb3QuYWRkSGFuZGxlcihyb290TGlzdGVuSGFuZGxlciwgb2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgb2JqZWN0LmVtaXRfcm9vdENoYW5nZWQob2xkUm9vdCk7CiAgICAgIH0KICAgICAgaWYgKG9iamVjdC50YXJnZXQgIT09IG9sZFRhcmdldCkgewogICAgICAgIHZhciB0YXJnZXRMaXN0ZW5IYW5kbGVyID0gb2JqZWN0Lmxpc3Rlbi50YXJnZXQ7CiAgICAgICAgaWYgKHRhcmdldExpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgIGlmIChvbGRUYXJnZXQgJiYgb2xkVGFyZ2V0ICE9PSBvYmplY3QpIG9sZFRhcmdldC5yZW1vdmVIYW5kbGVyKHRhcmdldExpc3RlbkhhbmRsZXIsIG9iamVjdCk7CiAgICAgICAgICBpZiAob2JqZWN0LnRhcmdldCAmJiBvYmplY3QudGFyZ2V0ICE9PSBvYmplY3QpIG9iamVjdC50YXJnZXQuYWRkSGFuZGxlcih0YXJnZXRMaXN0ZW5IYW5kbGVyLCBvYmplY3QpOwogICAgICAgIH0KICAgICAgICBvYmplY3QuZW1pdF90YXJnZXRDaGFuZ2VkKG9sZFRhcmdldCk7CiAgICAgIH0KICAgICAgdmFyIGN1cnNvciA9IG9iamVjdC5kZWxlZ2F0ZXNfOwogICAgICB3aGlsZSAoY3Vyc29yKSB7CiAgICAgICAgaWYgKGN1cnNvci5kZWxlZ2F0ZSkgYXBwbHlEZWxlZ2F0ZUNoYW5nZXMoY3Vyc29yLmRlbGVnYXRlLCBvbGRSb290LCBvbGRUYXJnZXQpOwogICAgICAgIGN1cnNvciA9IGN1cnNvci5uZXh0OwogICAgICB9CiAgICB9CiAgICB2YXIgRGF0YU9iamVjdCA9IENsYXNzKEFic3RyYWN0RGF0YSwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuT2JqZWN0IiwKICAgICAgc3Vic2NyaWJlVG86IFNVQlNDUklQVElPTi5ERUxFR0FURSArIFNVQlNDUklQVElPTi5UQVJHRVQsCiAgICAgIGRhdGE6IG51bGwsCiAgICAgIGVtaXRfdXBkYXRlOiBjcmVhdGVFdmVudCgidXBkYXRlIiwgImRlbHRhIikgJiYgZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICB2YXIgY3Vyc29yID0gdGhpcy5kZWxlZ2F0ZXNfOwogICAgICAgIGV2ZW50cy51cGRhdGUuY2FsbCh0aGlzLCBkZWx0YSk7CiAgICAgICAgd2hpbGUgKGN1cnNvcikgewogICAgICAgICAgaWYgKGN1cnNvci5kZWxlZ2F0ZSkgY3Vyc29yLmRlbGVnYXRlLmVtaXRfdXBkYXRlKGRlbHRhKTsKICAgICAgICAgIGN1cnNvciA9IGN1cnNvci5uZXh0OwogICAgICAgIH0KICAgICAgfSwKICAgICAgZW1pdF9zdGF0ZUNoYW5nZWQ6IGZ1bmN0aW9uKG9sZFN0YXRlKSB7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXMuZGVsZWdhdGVzXzsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLmVtaXRfc3RhdGVDaGFuZ2VkLmNhbGwodGhpcywgb2xkU3RhdGUpOwogICAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICAgIGlmIChjdXJzb3IuZGVsZWdhdGUpIHsKICAgICAgICAgICAgY3Vyc29yLmRlbGVnYXRlLnN0YXRlID0gdGhpcy5zdGF0ZTsKICAgICAgICAgICAgY3Vyc29yLmRlbGVnYXRlLmVtaXRfc3RhdGVDaGFuZ2VkKG9sZFN0YXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnNvciA9IGN1cnNvci5uZXh0OwogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVsZWdhdGU6IG51bGwsCiAgICAgIGRlbGVnYXRlQWRhcHRlcl86IG51bGwsCiAgICAgIGRlbGVnYXRlc186IG51bGwsCiAgICAgIGRlYnVnX2RlbGVnYXRlczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXMuZGVsZWdhdGVzXzsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgd2hpbGUgKGN1cnNvcikgewogICAgICAgICAgcmVzdWx0LnB1c2goY3Vyc29yLmRlbGVnYXRlKTsKICAgICAgICAgIGN1cnNvciA9IGN1cnNvci5uZXh0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9LAogICAgICBlbWl0X2RlbGVnYXRlQ2hhbmdlZDogY3JlYXRlRXZlbnQoImRlbGVnYXRlQ2hhbmdlZCIsICJvbGREZWxlZ2F0ZSIpLAogICAgICB0YXJnZXQ6IG51bGwsCiAgICAgIGVtaXRfdGFyZ2V0Q2hhbmdlZDogY3JlYXRlRXZlbnQoInRhcmdldENoYW5nZWQiLCAib2xkVGFyZ2V0IiksCiAgICAgIHJvb3Q6IG51bGwsCiAgICAgIGVtaXRfcm9vdENoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJyb290Q2hhbmdlZCIsICJvbGRSb290IiksCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucm9vdCA9IHRoaXM7CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIGRlbGVnYXRlID0gdGhpcy5kZWxlZ2F0ZTsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTsKICAgICAgICBpZiAoZGVsZWdhdGUpIHsKICAgICAgICAgIHRoaXMuZGVsZWdhdGUgPSBudWxsOwogICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgdGhpcy5kYXRhID0gSU5JVF9EQVRBOwogICAgICAgICAgdGhpcy5zZXREZWxlZ2F0ZShkZWxlZ2F0ZSk7CiAgICAgICAgICBpZiAodGhpcy5kYXRhID09PSBJTklUX0RBVEEpIHRoaXMuZGF0YSA9IGRhdGEgfHwge307CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICghZGF0YSkgdGhpcy5kYXRhID0ge307CiAgICAgICAgICBpZiAodGhpcy50YXJnZXQgIT09IG51bGwpIHRoaXMudGFyZ2V0ID0gdGhpczsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFN5bmNBY3Rpb246IGZ1bmN0aW9uKHN5bmNBY3Rpb24pIHsKICAgICAgICBpZiAoc3luY0FjdGlvbiAmJiB0aGlzLmRlbGVnYXRlKSBiYXNpcy5kZXYud2Fybih0aGlzLmNvbnN0cnVjdG9yLnN5bmNBY3Rpb24gKyAiIGluc3RhbmNlIGhhcyBhIGRlbGVnYXRlIGFuZCBzeW5jQWN0aW9uIC0gaXQgbWF5IHByb2R1Y2UgY29uZmxpY3Mgd2l0aCBkYXRhICYgc3RhdGUiKTsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLnNldFN5bmNBY3Rpb24uY2FsbCh0aGlzLCBzeW5jQWN0aW9uKTsKICAgICAgfSwKICAgICAgc2V0RGVsZWdhdGU6IGZ1bmN0aW9uKG5ld0RlbGVnYXRlKSB7CiAgICAgICAgbmV3RGVsZWdhdGUgPSByZXNvbHZlT2JqZWN0KHRoaXMsIHRoaXMuc2V0RGVsZWdhdGUsIG5ld0RlbGVnYXRlLCAiZGVsZWdhdGVBZGFwdGVyXyIpOwogICAgICAgIGlmIChuZXdEZWxlZ2F0ZSAmJiBuZXdEZWxlZ2F0ZSBpbnN0YW5jZW9mIERhdGFPYmplY3QpIHsKICAgICAgICAgIGlmIChuZXdEZWxlZ2F0ZS5kZWxlZ2F0ZSAmJiBpc0Nvbm5lY3RlZCh0aGlzLCBuZXdEZWxlZ2F0ZSkpIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIk5ldyBkZWxlZ2F0ZSBoYXMgYWxyZWFkeSBjb25uZWN0ZWQgdG8gb2JqZWN0LiBEZWxlZ2F0ZSBhc3NpZ25tZW50IGhhcyBiZWVuIGlnbm9yZWQuIiwgdGhpcywgbmV3RGVsZWdhdGUpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG5ld0RlbGVnYXRlID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuZGVsZWdhdGUgIT09IG5ld0RlbGVnYXRlKSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSB0aGlzLnN0YXRlOwogICAgICAgICAgdmFyIG9sZERhdGEgPSB0aGlzLmRhdGE7CiAgICAgICAgICB2YXIgb2xkRGVsZWdhdGUgPSB0aGlzLmRlbGVnYXRlOwogICAgICAgICAgdmFyIG9sZFRhcmdldCA9IHRoaXMudGFyZ2V0OwogICAgICAgICAgdmFyIG9sZFJvb3QgPSB0aGlzLnJvb3Q7CiAgICAgICAgICB2YXIgZGVsZWdhdGVMaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4uZGVsZWdhdGU7CiAgICAgICAgICB2YXIgZGF0YUNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgIHZhciBkZWx0YTsKICAgICAgICAgIGlmIChvbGREZWxlZ2F0ZSkgewogICAgICAgICAgICBpZiAoZGVsZWdhdGVMaXN0ZW5IYW5kbGVyKSBvbGREZWxlZ2F0ZS5yZW1vdmVIYW5kbGVyKGRlbGVnYXRlTGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgIHZhciBjdXJzb3IgPSBvbGREZWxlZ2F0ZS5kZWxlZ2F0ZXNfOwogICAgICAgICAgICB2YXIgcHJldiA9IG9sZERlbGVnYXRlOwogICAgICAgICAgICB3aGlsZSAoY3Vyc29yKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnNvci5kZWxlZ2F0ZSA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgY3Vyc29yLmRlbGVnYXRlID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChwcmV2ID09PSBvbGREZWxlZ2F0ZSkgb2xkRGVsZWdhdGUuZGVsZWdhdGVzXyA9IGN1cnNvci5uZXh0OyBlbHNlIHByZXYubmV4dCA9IGN1cnNvci5uZXh0OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXYgPSBjdXJzb3I7CiAgICAgICAgICAgICAgY3Vyc29yID0gY3Vyc29yLm5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXdEZWxlZ2F0ZSkgewogICAgICAgICAgICB0aGlzLmRlbGVnYXRlID0gbmV3RGVsZWdhdGU7CiAgICAgICAgICAgIGlmIChkZWxlZ2F0ZUxpc3RlbkhhbmRsZXIpIG5ld0RlbGVnYXRlLmFkZEhhbmRsZXIoZGVsZWdhdGVMaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgbmV3RGVsZWdhdGUuZGVsZWdhdGVzXyA9IHsKICAgICAgICAgICAgICBkZWxlZ2F0ZTogdGhpcywKICAgICAgICAgICAgICBuZXh0OiBuZXdEZWxlZ2F0ZS5kZWxlZ2F0ZXNfCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh0aGlzLmRhdGEgIT09IElOSVRfREFUQSkgewogICAgICAgICAgICAgIGRlbHRhID0ge307CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG5ld0RlbGVnYXRlLmRhdGEpIGlmIChrZXkgaW4gb2xkRGF0YSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGRhdGFDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGRlbHRhW2tleV0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvbGREYXRhKSBpZiAob2xkRGF0YVtrZXldICE9PSBuZXdEZWxlZ2F0ZS5kYXRhW2tleV0pIHsKICAgICAgICAgICAgICAgIGRhdGFDaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGRlbHRhW2tleV0gPSBvbGREYXRhW2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmRlbGVnYXRlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICAgICAgICB0aGlzLnJvb3QgPSB0aGlzOwogICAgICAgICAgICB0aGlzLmRhdGEgPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIG9sZERhdGEpIHRoaXMuZGF0YVtrZXldID0gb2xkRGF0YVtrZXldOwogICAgICAgICAgfQogICAgICAgICAgYXBwbHlEZWxlZ2F0ZUNoYW5nZXModGhpcywgb2xkUm9vdCwgb2xkVGFyZ2V0KTsKICAgICAgICAgIGlmIChkYXRhQ2hhbmdlZCkgdGhpcy5lbWl0X3VwZGF0ZShkZWx0YSk7CiAgICAgICAgICBpZiAoZGVsdGEgJiYgb2xkU3RhdGUgIT09IHRoaXMuc3RhdGUgJiYgKFN0cmluZyhvbGRTdGF0ZSkgIT0gdGhpcy5zdGF0ZSB8fCBvbGRTdGF0ZS5kYXRhICE9PSB0aGlzLnN0YXRlLmRhdGEpKSB0aGlzLmVtaXRfc3RhdGVDaGFuZ2VkKG9sZFN0YXRlKTsKICAgICAgICAgIHRoaXMuZW1pdF9kZWxlZ2F0ZUNoYW5nZWQob2xkRGVsZWdhdGUpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgc2V0U3RhdGU6IGZ1bmN0aW9uKHN0YXRlLCBkYXRhKSB7CiAgICAgICAgaWYgKHRoaXMuZGVsZWdhdGUpIHJldHVybiB0aGlzLnJvb3Quc2V0U3RhdGUoc3RhdGUsIGRhdGEpOyBlbHNlIHJldHVybiBBYnN0cmFjdERhdGEucHJvdG90eXBlLnNldFN0YXRlLmNhbGwodGhpcywgc3RhdGUsIGRhdGEpOwogICAgICB9LAogICAgICB1cGRhdGU6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICBpZiAodGhpcy5kZWxlZ2F0ZSkgcmV0dXJuIHRoaXMucm9vdC51cGRhdGUoZGF0YSk7CiAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgIHZhciBkZWx0YSA9IHt9OwogICAgICAgICAgdmFyIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gZGF0YSkgaWYgKHRoaXMuZGF0YVtwcm9wXSAhPT0gZGF0YVtwcm9wXSkgewogICAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTsKICAgICAgICAgICAgZGVsdGFbcHJvcF0gPSB0aGlzLmRhdGFbcHJvcF07CiAgICAgICAgICAgIHRoaXMuZGF0YVtwcm9wXSA9IGRhdGFbcHJvcF07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2hhbmdlZCkgewogICAgICAgICAgICB0aGlzLmVtaXRfdXBkYXRlKGRlbHRhKTsKICAgICAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIEFic3RyYWN0RGF0YS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHZhciBjdXJzb3IgPSB0aGlzLmRlbGVnYXRlc187CiAgICAgICAgdGhpcy5kZWxlZ2F0ZXNfID0gbnVsbDsKICAgICAgICB3aGlsZSAoY3Vyc29yKSB7CiAgICAgICAgICBjdXJzb3IuZGVsZWdhdGUuc2V0RGVsZWdhdGUoKTsKICAgICAgICAgIGN1cnNvciA9IGN1cnNvci5uZXh0OwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5kZWxlZ2F0ZSkgdGhpcy5zZXREZWxlZ2F0ZSgpOwogICAgICAgIHRoaXMuZGF0YSA9IE5VTExfT0JKRUNUOwogICAgICAgIHRoaXMucm9vdCA9IG51bGw7CiAgICAgICAgdGhpcy50YXJnZXQgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBTbG90ID0gQ2xhc3MoRGF0YU9iamVjdCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU2xvdCIKICAgIH0pOwogICAgdmFyIEtFWU9CSkVDVE1BUF9NRU1CRVJfSEFORExFUiA9IHsKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgZGVsZXRlIHRoaXMubWFwW3RoaXMuaWRdOwogICAgICB9CiAgICB9OwogICAgdmFyIEtleU9iamVjdE1hcCA9IENsYXNzKEFic3RyYWN0RGF0YSwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuS2V5T2JqZWN0TWFwIiwKICAgICAgaXRlbUNsYXNzOiBEYXRhT2JqZWN0LAogICAgICBrZXlHZXR0ZXI6ICRzZWxmLAogICAgICBhdXRvRGVzdHJveU1lbWJlcnM6IHRydWUsCiAgICAgIG1hcF86IG51bGwsCiAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogdHJ1ZSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5tYXBfID0ge307CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCh0aGlzLmtleUdldHRlcihvYmplY3QpLCBvYmplY3QpOwogICAgICB9LAogICAgICBjcmVhdGU6IGZ1bmN0aW9uKGtleSwgb2JqZWN0KSB7CiAgICAgICAgdmFyIGl0ZW1Db25maWc7CiAgICAgICAgaWYgKGtleSBpbnN0YW5jZW9mIERhdGFPYmplY3QpIGl0ZW1Db25maWcgPSB7CiAgICAgICAgICBkZWxlZ2F0ZToga2V5CiAgICAgICAgfTsgZWxzZSBpdGVtQ29uZmlnID0gewogICAgICAgICAgZGF0YTogewogICAgICAgICAgICBpZDoga2V5LAogICAgICAgICAgICB0aXRsZToga2V5CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gbmV3IHRoaXMuaXRlbUNsYXNzKGl0ZW1Db25maWcpOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgYXV0b2NyZWF0ZSkgewogICAgICAgIHZhciBpdGVtSWQgPSBrZXkgaW5zdGFuY2VvZiBEYXRhT2JqZWN0ID8ga2V5LmJhc2lzT2JqZWN0SWQgOiBrZXk7CiAgICAgICAgdmFyIGl0ZW1JbmZvID0gdGhpcy5tYXBfW2l0ZW1JZF07CiAgICAgICAgaWYgKCFpdGVtSW5mbyAmJiBhdXRvY3JlYXRlKSB7CiAgICAgICAgICBpdGVtSW5mbyA9IHRoaXMubWFwX1tpdGVtSWRdID0gewogICAgICAgICAgICBtYXA6IHRoaXMubWFwXywKICAgICAgICAgICAgaWQ6IGl0ZW1JZCwKICAgICAgICAgICAgaXRlbTogdGhpcy5jcmVhdGUoa2V5LCBhdXRvY3JlYXRlKQogICAgICAgICAgfTsKICAgICAgICAgIGl0ZW1JbmZvLml0ZW0uYWRkSGFuZGxlcihLRVlPQkpFQ1RNQVBfTUVNQkVSX0hBTkRMRVIsIGl0ZW1JbmZvKTsKICAgICAgICB9CiAgICAgICAgaWYgKGl0ZW1JbmZvKSByZXR1cm4gaXRlbUluZm8uaXRlbTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIG1hcCA9IHRoaXMubWFwXzsKICAgICAgICB0aGlzLm1hcF8gPSBudWxsOwogICAgICAgIGZvciAodmFyIGl0ZW1JZCBpbiBtYXApIHsKICAgICAgICAgIHZhciBpdGVtSW5mbyA9IG1hcFtpdGVtSWRdOwogICAgICAgICAgaWYgKHRoaXMuYXV0b0Rlc3Ryb3lNZW1iZXJzKSBpdGVtSW5mby5pdGVtLmRlc3Ryb3koKTsgZWxzZSBpdGVtSW5mby5pdGVtLnJlbW92ZUhhbmRsZXIoS0VZT0JKRUNUTUFQX01FTUJFUl9IQU5ETEVSLCBpdGVtSW5mbyk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSB7CiAgICAgIHZhciBkZWx0YSA9IHt9OwogICAgICB2YXIgcmVzdWx0OwogICAgICBpZiAoaW5zZXJ0ZWQgJiYgaW5zZXJ0ZWQubGVuZ3RoKSByZXN1bHQgPSBkZWx0YS5pbnNlcnRlZCA9IGluc2VydGVkOwogICAgICBpZiAoZGVsZXRlZCAmJiBkZWxldGVkLmxlbmd0aCkgcmVzdWx0ID0gZGVsdGEuZGVsZXRlZCA9IGRlbGV0ZWQ7CiAgICAgIGlmIChyZXN1bHQpIHJldHVybiBkZWx0YTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldERhdGFzZXREZWx0YShhLCBiKSB7CiAgICAgIGlmICghYSB8fCAhYS5pdGVtQ291bnQpIHsKICAgICAgICBpZiAoYiAmJiBiLml0ZW1Db3VudCkgcmV0dXJuIHsKICAgICAgICAgIGluc2VydGVkOiBiLmdldEl0ZW1zKCkKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghYiB8fCAhYi5pdGVtQ291bnQpIHsKICAgICAgICAgIGlmIChhLml0ZW1Db3VudCkgcmV0dXJuIHsKICAgICAgICAgICAgZGVsZXRlZDogYS5nZXRJdGVtcygpCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gYS5pdGVtc18pIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBhLml0ZW1zX1trZXldOwogICAgICAgICAgICBpZiAoaXRlbS5iYXNpc09iamVjdElkIGluIGIuaXRlbXNfID09IGZhbHNlKSBkZWxldGVkLnB1c2goaXRlbSk7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gYi5pdGVtc18pIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBiLml0ZW1zX1trZXldOwogICAgICAgICAgICBpZiAoaXRlbS5iYXNpc09iamVjdElkIGluIGEuaXRlbXNfID09IGZhbHNlKSBpbnNlcnRlZC5wdXNoKGl0ZW0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHZhciBEYXRhc2V0V3JhcHBlciA9IENsYXNzKERhdGFPYmplY3QsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkRhdGFzZXRXcmFwcGVyIiwKICAgICAgc3Vic2NyaWJlVG86IERhdGFPYmplY3QucHJvdG90eXBlLnN1YnNjcmliZVRvICsgU1VCU0NSSVBUSU9OLkRBVEFTRVQsCiAgICAgIGxpc3RlbjogewogICAgICAgIGRhdGFzZXQ6IHsKICAgICAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24oZGF0YXNldCwgZGVsdGEpIHsKICAgICAgICAgICAgdGhpcy5pdGVtQ291bnQgPSBkYXRhc2V0Lml0ZW1Db3VudDsKICAgICAgICAgICAgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuc2V0RGF0YXNldCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgZGF0YXNldDogbnVsbCwKICAgICAgZGF0YXNldEFkYXB0ZXJfOiBudWxsLAogICAgICBlbWl0X2RhdGFzZXRDaGFuZ2VkOiBjcmVhdGVFdmVudCgiZGF0YXNldENoYW5nZWQiLCAib2xkRGF0YXNldCIpLAogICAgICBlbWl0X2l0ZW1zQ2hhbmdlZDogY3JlYXRlRXZlbnQoIml0ZW1zQ2hhbmdlZCIsICJkZWx0YSIpLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIGRhdGFzZXQgPSB0aGlzLmRhdGFzZXQ7CiAgICAgICAgaWYgKGRhdGFzZXQpIHsKICAgICAgICAgIHRoaXMuZGF0YXNldCA9IG51bGw7CiAgICAgICAgICB0aGlzLnNldERhdGFzZXQoZGF0YXNldCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXREYXRhc2V0OiBmdW5jdGlvbihkYXRhc2V0KSB7CiAgICAgICAgZGF0YXNldCA9IHJlc29sdmVEYXRhc2V0KHRoaXMsIHRoaXMuc2V0RGF0YXNldCwgZGF0YXNldCwgImRhdGFzZXRBZGFwdGVyXyIpOwogICAgICAgIGlmICh0aGlzLmRhdGFzZXQgIT09IGRhdGFzZXQpIHsKICAgICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4uZGF0YXNldDsKICAgICAgICAgIHZhciBvbGREYXRhc2V0ID0gdGhpcy5kYXRhc2V0OwogICAgICAgICAgdmFyIGRlbHRhOwogICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIHsKICAgICAgICAgICAgaWYgKG9sZERhdGFzZXQpIG9sZERhdGFzZXQucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgaWYgKGRhdGFzZXQpIGRhdGFzZXQuYWRkSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuaXRlbUNvdW50ID0gZGF0YXNldCA/IGRhdGFzZXQuaXRlbUNvdW50IDogMDsKICAgICAgICAgIGlmIChkZWx0YSA9IGdldERhdGFzZXREZWx0YShvbGREYXRhc2V0LCBkYXRhc2V0KSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgICB0aGlzLmRhdGFzZXQgPSBkYXRhc2V0OwogICAgICAgICAgdGhpcy5lbWl0X2RhdGFzZXRDaGFuZ2VkKG9sZERhdGFzZXQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgaGFzOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0ID8gdGhpcy5kYXRhc2V0LmhhcyhvYmplY3QpIDogbnVsbDsKICAgICAgfSwKICAgICAgZ2V0SXRlbXM6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmRhdGFzZXQgPyB0aGlzLmRhdGFzZXQuZ2V0SXRlbXMoKSA6IFtdOwogICAgICB9LAogICAgICBwaWNrOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0ID8gdGhpcy5kYXRhc2V0LnBpY2soKSA6IG51bGw7CiAgICAgIH0sCiAgICAgIHRvcDogZnVuY3Rpb24oY291bnQpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhc2V0ID8gdGhpcy5kYXRhc2V0LnRvcChjb3VudCkgOiBbXTsKICAgICAgfSwKICAgICAgZm9yRWFjaDogZnVuY3Rpb24oZm4pIHsKICAgICAgICBpZiAodGhpcy5kYXRhc2V0KSByZXR1cm4gdGhpcy5kYXRhc2V0LmZvckVhY2goZm4pOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5kYXRhc2V0IHx8IHRoaXMuZGF0YXNldEFkYXB0ZXJfKSB0aGlzLnNldERhdGFzZXQoKTsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFJlYWRPbmx5RGF0YXNldCA9IENsYXNzKEFic3RyYWN0RGF0YSwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuUmVhZE9ubHlEYXRhc2V0IiwKICAgICAgaXRlbUNvdW50OiAwLAogICAgICBpdGVtc186IG51bGwsCiAgICAgIG1lbWJlcnNfOiBudWxsLAogICAgICBjYWNoZV86IG51bGwsCiAgICAgIGVtaXRfaXRlbXNDaGFuZ2VkOiBjcmVhdGVFdmVudCgiaXRlbXNDaGFuZ2VkIiwgImRlbHRhIikgJiYgZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICB2YXIgaXRlbXM7CiAgICAgICAgdmFyIGluc2VydENvdW50ID0gMDsKICAgICAgICB2YXIgZGVsZXRlQ291bnQgPSAwOwogICAgICAgIHZhciBvYmplY3Q7CiAgICAgICAgaWYgKGl0ZW1zID0gZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIHdoaWxlIChvYmplY3QgPSBpdGVtc1tpbnNlcnRDb3VudF0pIHsKICAgICAgICAgICAgdGhpcy5pdGVtc19bb2JqZWN0LmJhc2lzT2JqZWN0SWRdID0gb2JqZWN0OwogICAgICAgICAgICBpbnNlcnRDb3VudCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXRlbXMgPSBkZWx0YS5kZWxldGVkKSB7CiAgICAgICAgICB3aGlsZSAob2JqZWN0ID0gaXRlbXNbZGVsZXRlQ291bnRdKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLml0ZW1zX1tvYmplY3QuYmFzaXNPYmplY3RJZF07CiAgICAgICAgICAgIGRlbGV0ZUNvdW50Kys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuaXRlbUNvdW50ICs9IGluc2VydENvdW50IC0gZGVsZXRlQ291bnQ7CiAgICAgICAgdGhpcy5jYWNoZV8gPSBpbnNlcnRDb3VudCA9PSB0aGlzLml0ZW1Db3VudCA/IGRlbHRhLmluc2VydGVkIDogbnVsbDsKICAgICAgICBldmVudHMuaXRlbXNDaGFuZ2VkLmNhbGwodGhpcywgZGVsdGEpOwogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdERhdGEucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLm1lbWJlcnNfID0ge307CiAgICAgICAgdGhpcy5pdGVtc18gPSB7fTsKICAgICAgfSwKICAgICAgaGFzOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICByZXR1cm4gISEob2JqZWN0ICYmIHRoaXMuaXRlbXNfW29iamVjdC5iYXNpc09iamVjdElkXSk7CiAgICAgIH0sCiAgICAgIGdldEl0ZW1zOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuY2FjaGVfKSB0aGlzLmNhY2hlXyA9IHZhbHVlcyh0aGlzLml0ZW1zXyk7CiAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGVfOwogICAgICB9LAogICAgICBnZXRWYWx1ZXM6IGZ1bmN0aW9uKGdldHRlcikgewogICAgICAgIHJldHVybiB0aGlzLmdldEl0ZW1zKCkubWFwKGJhc2lzLmdldHRlcihnZXR0ZXIgfHwgJHNlbGYpKTsKICAgICAgfSwKICAgICAgcGljazogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgb2JqZWN0SWQgaW4gdGhpcy5pdGVtc18pIHJldHVybiB0aGlzLml0ZW1zX1tvYmplY3RJZF07CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0sCiAgICAgIHRvcDogZnVuY3Rpb24oY291bnQpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgaWYgKGNvdW50KSBmb3IgKHZhciBvYmplY3RJZCBpbiB0aGlzLml0ZW1zXykgaWYgKHJlc3VsdC5wdXNoKHRoaXMuaXRlbXNfW29iamVjdElkXSkgPj0gY291bnQpIGJyZWFrOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0sCiAgICAgIGZvckVhY2g6IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgdmFyIGl0ZW1zID0gdGhpcy5nZXRJdGVtcygpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIGZuKGl0ZW1zW2ldKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgQWJzdHJhY3REYXRhLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5jYWNoZV8gPSBFTVBUWV9BUlJBWTsKICAgICAgICB0aGlzLml0ZW1Db3VudCA9IDA7CiAgICAgICAgdGhpcy5tZW1iZXJzXyA9IG51bGw7CiAgICAgICAgdGhpcy5pdGVtc18gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBEYXRhc2V0ID0gQ2xhc3MoUmVhZE9ubHlEYXRhc2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5EYXRhc2V0IiwKICAgICAgbGlzdGVuOiB7CiAgICAgICAgaXRlbTogewogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlKFsgb2JqZWN0IF0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgUmVhZE9ubHlEYXRhc2V0LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIGl0ZW1zID0gdGhpcy5pdGVtczsKICAgICAgICBpZiAoaXRlbXMpIHsKICAgICAgICAgIHRoaXMuaXRlbXMgPSBudWxsOwogICAgICAgICAgdGhpcy5zZXQoaXRlbXMpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYWRkOiBmdW5jdGlvbihpdGVtcykgewogICAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4uaXRlbTsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICB2YXIgZGVsdGE7CiAgICAgICAgaWYgKGl0ZW1zICYmICFBcnJheS5pc0FycmF5KGl0ZW1zKSkgaXRlbXMgPSBbIGl0ZW1zIF07CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIG9iamVjdCA9IGl0ZW1zW2ldOwogICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mIERhdGFPYmplY3QpIHsKICAgICAgICAgICAgdmFyIG9iamVjdElkID0gb2JqZWN0LmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgIGlmICghbWVtYmVyTWFwW29iamVjdElkXSkgewogICAgICAgICAgICAgIG1lbWJlck1hcFtvYmplY3RJZF0gPSBvYmplY3Q7CiAgICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIG9iamVjdC5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICAgIGluc2VydGVkLnB1c2gob2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIldyb25nIGRhdGEgdHlwZTogdmFsdWUgc2hvdWxkIGJlIGFuIGluc3RhbmNlIG9mIGJhc2lzLmRhdGEuT2JqZWN0Iik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpbnNlcnRlZC5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEgPSB7CiAgICAgICAgICAgIGluc2VydGVkOiBpbnNlcnRlZAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgfSwKICAgICAgcmVtb3ZlOiBmdW5jdGlvbihpdGVtcykgewogICAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4uaXRlbTsKICAgICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICAgIHZhciBkZWx0YTsKICAgICAgICBpZiAoaXRlbXMgJiYgIUFycmF5LmlzQXJyYXkoaXRlbXMpKSBpdGVtcyA9IFsgaXRlbXMgXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgb2JqZWN0ID0gaXRlbXNbaV07CiAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgRGF0YU9iamVjdCkgewogICAgICAgICAgICB2YXIgb2JqZWN0SWQgPSBvYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgaWYgKG1lbWJlck1hcFtvYmplY3RJZF0pIHsKICAgICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgb2JqZWN0LnJlbW92ZUhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgICAgZGVsZXRlIG1lbWJlck1hcFtvYmplY3RJZF07CiAgICAgICAgICAgICAgZGVsZXRlZC5wdXNoKG9iamVjdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJXcm9uZyBkYXRhIHR5cGU6IHZhbHVlIHNob3VsZCBiZSBhbiBpbnN0YW5jZSBvZiBiYXNpcy5kYXRhLk9iamVjdCIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZGVsZXRlZC5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEgPSB7CiAgICAgICAgICAgIGRlbGV0ZWQ6IGRlbGV0ZWQKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24oaXRlbXMpIHsKICAgICAgICBpZiAoIXRoaXMuaXRlbUNvdW50KSByZXR1cm4gdGhpcy5hZGQoaXRlbXMpOwogICAgICAgIGlmICghaXRlbXMgfHwgIWl0ZW1zLmxlbmd0aCkgcmV0dXJuIHRoaXMuY2xlYXIoKTsKICAgICAgICB2YXIgbWVtYmVyTWFwID0gdGhpcy5tZW1iZXJzXzsKICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLml0ZW07CiAgICAgICAgdmFyIGV4aXN0cyA9IHt9OwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIG9iamVjdDsKICAgICAgICB2YXIgb2JqZWN0SWQ7CiAgICAgICAgdmFyIGRlbHRhOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIG9iamVjdCA9IGl0ZW1zW2ldOwogICAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mIERhdGFPYmplY3QpIHsKICAgICAgICAgICAgb2JqZWN0SWQgPSBvYmplY3QuYmFzaXNPYmplY3RJZDsKICAgICAgICAgICAgZXhpc3RzW29iamVjdElkXSA9IG9iamVjdDsKICAgICAgICAgICAgaWYgKCFtZW1iZXJNYXBbb2JqZWN0SWRdKSB7CiAgICAgICAgICAgICAgbWVtYmVyTWFwW29iamVjdElkXSA9IG9iamVjdDsKICAgICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgb2JqZWN0LmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgICAgaW5zZXJ0ZWQucHVzaChvYmplY3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBiYXNpcy5kZXYud2FybigiV3JvbmcgZGF0YSB0eXBlOiB2YWx1ZSBzaG91bGQgYmUgYW4gaW5zdGFuY2Ugb2YgYmFzaXMuZGF0YS5PYmplY3QiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgb2JqZWN0SWQgaW4gbWVtYmVyTWFwKSB7CiAgICAgICAgICBpZiAoIWV4aXN0c1tvYmplY3RJZF0pIHsKICAgICAgICAgICAgb2JqZWN0ID0gbWVtYmVyTWFwW29iamVjdElkXTsKICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIpIG9iamVjdC5yZW1vdmVIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICBkZWxldGUgbWVtYmVyTWFwW29iamVjdElkXTsKICAgICAgICAgICAgZGVsZXRlZC5wdXNoKG9iamVjdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkZWx0YSA9IGdldERlbHRhKGluc2VydGVkLCBkZWxldGVkKSkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChkZWx0YSk7CiAgICAgICAgcmV0dXJuIGRlbHRhOwogICAgICB9LAogICAgICBzeW5jOiBmdW5jdGlvbihpdGVtcykgewogICAgICAgIHZhciBkZWx0YSA9IHRoaXMuc2V0KGl0ZW1zKSB8fCB7fTsKICAgICAgICB2YXIgZGVsZXRlZCA9IGRlbHRhLmRlbGV0ZWQ7CiAgICAgICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUodHJ1ZSk7CiAgICAgICAgaWYgKGRlbGV0ZWQpIGZvciAodmFyIGkgPSAwLCBvYmplY3Q7IG9iamVjdCA9IGRlbGV0ZWRbaV07IGkrKykgb2JqZWN0LmRlc3Ryb3koKTsKICAgICAgICBEYXRhc2V0LnNldEFjY3VtdWxhdGVTdGF0ZShmYWxzZSk7CiAgICAgICAgcmV0dXJuIGRlbHRhLmluc2VydGVkOwogICAgICB9LAogICAgICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGRlbGV0ZWQgPSB0aGlzLmdldEl0ZW1zKCk7CiAgICAgICAgdmFyIGxpc3RlbkhhbmRsZXIgPSB0aGlzLmxpc3Rlbi5pdGVtOwogICAgICAgIHZhciBkZWx0YTsKICAgICAgICBpZiAoZGVsZXRlZC5sZW5ndGgpIHsKICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSBmb3IgKHZhciBpID0gMDsgaSA8IGRlbGV0ZWQubGVuZ3RoOyBpKyspIGRlbGV0ZWRbaV0ucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgIHRoaXMuZW1pdF9pdGVtc0NoYW5nZWQoZGVsdGEgPSB7CiAgICAgICAgICAgIGRlbGV0ZWQ6IGRlbGV0ZWQKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5tZW1iZXJzXyA9IHt9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZGVsdGE7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICBSZWFkT25seURhdGFzZXQucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgUmVzb2x2ZUFkYXB0ZXIgPSBmdW5jdGlvbihjb250ZXh0LCBmbiwgc291cmNlLCBoYW5kbGVyKSB7CiAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgIHRoaXMuZm4gPSBmbjsKICAgICAgdGhpcy5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRoaXMuaGFuZGxlciA9IGhhbmRsZXI7CiAgICB9OwogICAgUmVzb2x2ZUFkYXB0ZXIucHJvdG90eXBlID0gewogICAgICBjb250ZXh0OiBudWxsLAogICAgICBmbjogbnVsbCwKICAgICAgc291cmNlOiBudWxsLAogICAgICBoYW5kbGVyOiBudWxsLAogICAgICBuZXh0OiBudWxsLAogICAgICBhdHRhY2g6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc291cmNlLmFkZEhhbmRsZXIodGhpcy5oYW5kbGVyLCB0aGlzKTsKICAgICAgfSwKICAgICAgZGV0YWNoOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNvdXJjZS5yZW1vdmVIYW5kbGVyKHRoaXMuaGFuZGxlciwgdGhpcyk7CiAgICAgIH0sCiAgICAgIHByb3h5OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmZuLmNhbGwodGhpcy5jb250ZXh0LCB0aGlzLnNvdXJjZSk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgQkJSZXNvbHZlQWRhcHRlciA9IGZ1bmN0aW9uKCkgewogICAgICBSZXNvbHZlQWRhcHRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKICAgIEJCUmVzb2x2ZUFkYXB0ZXIucHJvdG90eXBlID0gbmV3IFJlc29sdmVBZGFwdGVyOwogICAgQkJSZXNvbHZlQWRhcHRlci5wcm90b3R5cGUuYXR0YWNoID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuc291cmNlLmJpbmRpbmdCcmlkZ2UuYXR0YWNoKHRoaXMuc291cmNlLCB0aGlzLmhhbmRsZXIsIHRoaXMpOwogICAgfTsKICAgIEJCUmVzb2x2ZUFkYXB0ZXIucHJvdG90eXBlLmRldGFjaCA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnNvdXJjZS5iaW5kaW5nQnJpZGdlLmRldGFjaCh0aGlzLnNvdXJjZSwgdGhpcy5oYW5kbGVyLCB0aGlzKTsKICAgIH07CiAgICB2YXIgVE9LRU5fQURBUFRFUl9IQU5ETEVSID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuZm4uY2FsbCh0aGlzLmNvbnRleHQsIHRoaXMuc291cmNlKTsKICAgIH07CiAgICB2YXIgREFUQVNFVFdSQVBQRVJfQURBUFRFUl9IQU5ETEVSID0gewogICAgICBkYXRhc2V0Q2hhbmdlZDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5mbi5jYWxsKHRoaXMuY29udGV4dCwgdGhpcy5zb3VyY2UpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmZuLmNhbGwodGhpcy5jb250ZXh0LCBudWxsKTsKICAgICAgfQogICAgfTsKICAgIHZhciBWQUxVRV9BREFQVEVSX0hBTkRMRVIgPSB7CiAgICAgIGNoYW5nZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5mbi5jYWxsKHRoaXMuY29udGV4dCwgdGhpcy5zb3VyY2UpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmZuLmNhbGwodGhpcy5jb250ZXh0LCBudWxsKTsKICAgICAgfQogICAgfTsKICAgIGZ1bmN0aW9uIHJlc29sdmVEYXRhc2V0KGNvbnRleHQsIGZuLCBzb3VyY2UsIHByb3BlcnR5KSB7CiAgICAgIHZhciBvbGRBZGFwdGVyID0gY29udGV4dFtwcm9wZXJ0eV0gfHwgbnVsbDsKICAgICAgdmFyIG5ld0FkYXB0ZXIgPSBudWxsOwogICAgICBpZiAodHlwZW9mIHNvdXJjZSA9PSAiZnVuY3Rpb24iKSBzb3VyY2UgPSBzb3VyY2UuY2FsbChjb250ZXh0LCBjb250ZXh0KTsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBEYXRhc2V0V3JhcHBlcikgewogICAgICAgICAgbmV3QWRhcHRlciA9IG5ldyBSZXNvbHZlQWRhcHRlcihjb250ZXh0LCBmbiwgc291cmNlLCBEQVRBU0VUV1JBUFBFUl9BREFQVEVSX0hBTkRMRVIpOwogICAgICAgICAgc291cmNlID0gc291cmNlLmRhdGFzZXQ7CiAgICAgICAgfSBlbHNlIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBWYWx1ZSkgewogICAgICAgICAgbmV3QWRhcHRlciA9IG5ldyBSZXNvbHZlQWRhcHRlcihjb250ZXh0LCBmbiwgc291cmNlLCBWQUxVRV9BREFQVEVSX0hBTkRMRVIpOwogICAgICAgICAgc291cmNlID0gcmVzb2x2ZURhdGFzZXQobmV3QWRhcHRlciwgbmV3QWRhcHRlci5wcm94eSwgc291cmNlLnZhbHVlLCAibmV4dCIpOwogICAgICAgIH0gZWxzZSBpZiAoc291cmNlLmJpbmRpbmdCcmlkZ2UpIHsKICAgICAgICAgIG5ld0FkYXB0ZXIgPSBuZXcgQkJSZXNvbHZlQWRhcHRlcihjb250ZXh0LCBmbiwgc291cmNlLCBUT0tFTl9BREFQVEVSX0hBTkRMRVIpOwogICAgICAgICAgc291cmNlID0gcmVzb2x2ZURhdGFzZXQobmV3QWRhcHRlciwgbmV3QWRhcHRlci5wcm94eSwgc291cmNlLnZhbHVlLCAibmV4dCIpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgUmVhZE9ubHlEYXRhc2V0ID09IGZhbHNlKSBzb3VyY2UgPSBudWxsOwogICAgICBpZiAocHJvcGVydHkgJiYgb2xkQWRhcHRlciAhPT0gbmV3QWRhcHRlcikgewogICAgICAgIGlmIChvbGRBZGFwdGVyKSB7CiAgICAgICAgICBvbGRBZGFwdGVyLmRldGFjaCgpOwogICAgICAgICAgaWYgKG9sZEFkYXB0ZXIubmV4dCkgcmVzb2x2ZURhdGFzZXQob2xkQWRhcHRlciwgbnVsbCwgbnVsbCwgIm5leHQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKG5ld0FkYXB0ZXIpIG5ld0FkYXB0ZXIuYXR0YWNoKCk7CiAgICAgICAgY29udGV4dFtwcm9wZXJ0eV0gPSBuZXdBZGFwdGVyOwogICAgICB9CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlT2JqZWN0KGNvbnRleHQsIGZuLCBzb3VyY2UsIHByb3BlcnR5KSB7CiAgICAgIHZhciBvbGRBZGFwdGVyID0gY29udGV4dFtwcm9wZXJ0eV0gfHwgbnVsbDsKICAgICAgdmFyIG5ld0FkYXB0ZXIgPSBudWxsOwogICAgICBpZiAodHlwZW9mIHNvdXJjZSA9PSAiZnVuY3Rpb24iKSBzb3VyY2UgPSBzb3VyY2UuY2FsbChjb250ZXh0LCBjb250ZXh0KTsKICAgICAgaWYgKHNvdXJjZSkgewogICAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBWYWx1ZSkgewogICAgICAgICAgbmV3QWRhcHRlciA9IG5ldyBSZXNvbHZlQWRhcHRlcihjb250ZXh0LCBmbiwgc291cmNlLCBWQUxVRV9BREFQVEVSX0hBTkRMRVIpOwogICAgICAgICAgc291cmNlID0gcmVzb2x2ZU9iamVjdChuZXdBZGFwdGVyLCBuZXdBZGFwdGVyLnByb3h5LCBzb3VyY2UudmFsdWUsICJuZXh0Iik7CiAgICAgICAgfSBlbHNlIGlmIChzb3VyY2UuYmluZGluZ0JyaWRnZSkgewogICAgICAgICAgbmV3QWRhcHRlciA9IG5ldyBCQlJlc29sdmVBZGFwdGVyKGNvbnRleHQsIGZuLCBzb3VyY2UsIFRPS0VOX0FEQVBURVJfSEFORExFUik7CiAgICAgICAgICBzb3VyY2UgPSByZXNvbHZlT2JqZWN0KG5ld0FkYXB0ZXIsIG5ld0FkYXB0ZXIucHJveHksIHNvdXJjZS52YWx1ZSwgIm5leHQiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHNvdXJjZSBpbnN0YW5jZW9mIERhdGFPYmplY3QgPT0gZmFsc2UpIHNvdXJjZSA9IG51bGw7CiAgICAgIGlmIChwcm9wZXJ0eSAmJiBvbGRBZGFwdGVyICE9PSBuZXdBZGFwdGVyKSB7CiAgICAgICAgaWYgKG9sZEFkYXB0ZXIpIHsKICAgICAgICAgIG9sZEFkYXB0ZXIuZGV0YWNoKCk7CiAgICAgICAgICBpZiAob2xkQWRhcHRlci5uZXh0KSByZXNvbHZlT2JqZWN0KG9sZEFkYXB0ZXIsIG51bGwsIG51bGwsICJuZXh0Iik7CiAgICAgICAgfQogICAgICAgIGlmIChuZXdBZGFwdGVyKSBuZXdBZGFwdGVyLmF0dGFjaCgpOwogICAgICAgIGNvbnRleHRbcHJvcGVydHldID0gbmV3QWRhcHRlcjsKICAgICAgfQogICAgICByZXR1cm4gc291cmNlOwogICAgfQogICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHByb3RvID0gUmVhZE9ubHlEYXRhc2V0LnByb3RvdHlwZTsKICAgICAgdmFyIGV2ZW50Q2FjaGUgPSB7fTsKICAgICAgdmFyIHNldFN0YXRlQ291bnQgPSAwOwogICAgICB2YXIgdXJnZW50VGltZXI7CiAgICAgIHZhciByZWFsRXZlbnQ7CiAgICAgIGZ1bmN0aW9uIGZsdXNoQ2FjaGUoY2FjaGUpIHsKICAgICAgICB2YXIgZGF0YXNldCA9IGNhY2hlLmRhdGFzZXQ7CiAgICAgICAgcmVhbEV2ZW50LmNhbGwoZGF0YXNldCwgY2FjaGUpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGZsdXNoQWxsRGF0YXNldCgpIHsKICAgICAgICB2YXIgZXZlbnRDYWNoZUNvcHkgPSBldmVudENhY2hlOwogICAgICAgIGV2ZW50Q2FjaGUgPSB7fTsKICAgICAgICBmb3IgKHZhciBkYXRhc2V0SWQgaW4gZXZlbnRDYWNoZUNvcHkpIHsKICAgICAgICAgIHZhciBlbnRyeSA9IGV2ZW50Q2FjaGVDb3B5W2RhdGFzZXRJZF07CiAgICAgICAgICBpZiAoZW50cnkpIGZsdXNoQ2FjaGUoZW50cnkpOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzdG9yZURhdGFzZXREZWx0YShkZWx0YSkgewogICAgICAgIHZhciBkYXRhc2V0ID0gdGhpczsKICAgICAgICB2YXIgZGF0YXNldElkID0gZGF0YXNldC5iYXNpc09iamVjdElkOwogICAgICAgIHZhciBpbnNlcnRlZCA9IGRlbHRhLmluc2VydGVkOwogICAgICAgIHZhciBkZWxldGVkID0gZGVsdGEuZGVsZXRlZDsKICAgICAgICB2YXIgY2FjaGUgPSBldmVudENhY2hlW2RhdGFzZXRJZF07CiAgICAgICAgaWYgKGluc2VydGVkICYmIGRlbGV0ZWQgfHwgY2FjaGUgJiYgY2FjaGUubWl4ZWQpIHsKICAgICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgICBldmVudENhY2hlW2RhdGFzZXRJZF0gPSBudWxsOwogICAgICAgICAgICBmbHVzaENhY2hlKGNhY2hlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlYWxFdmVudC5jYWxsKGRhdGFzZXQsIGRlbHRhKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKGNhY2hlKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGluc2VydGVkID8gImluc2VydGVkIiA6ICJkZWxldGVkIjsKICAgICAgICAgIHZhciBhcnJheSA9IGNhY2hlW21vZGVdOwogICAgICAgICAgaWYgKCFhcnJheSkgewogICAgICAgICAgICB2YXIgaW5DYWNoZU1vZGUgPSBpbnNlcnRlZCA/ICJkZWxldGVkIiA6ICJpbnNlcnRlZCI7CiAgICAgICAgICAgIHZhciBpbkNhY2hlID0gY2FjaGVbaW5DYWNoZU1vZGVdOwogICAgICAgICAgICB2YXIgaW5DYWNoZU1hcCA9IHt9OwogICAgICAgICAgICB2YXIgZGVsdGFJdGVtcyA9IGluc2VydGVkIHx8IGRlbGV0ZWQ7CiAgICAgICAgICAgIHZhciBuZXdJbkNhY2hlSXRlbXMgPSBbXTsKICAgICAgICAgICAgdmFyIGluQ2FjaGVSZW1vdmVzID0gMDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbkNhY2hlLmxlbmd0aDsgaSsrKSBpbkNhY2hlTWFwW2luQ2FjaGVbaV0uYmFzaXNPYmplY3RJZF0gPSBpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlbHRhSXRlbXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgaWQgPSBkZWx0YUl0ZW1zW2ldLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgaWYgKGlkIGluIGluQ2FjaGVNYXAgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIG5ld0luQ2FjaGVJdGVtcy5wdXNoKGRlbHRhSXRlbXNbaV0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWluQ2FjaGVSZW1vdmVzKSBpbkNhY2hlID0gc2xpY2VBcnJheS5jYWxsKGluQ2FjaGUpOwogICAgICAgICAgICAgICAgaW5DYWNoZVJlbW92ZXMrKzsKICAgICAgICAgICAgICAgIGluQ2FjaGVbaW5DYWNoZU1hcFtpZF1dID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluQ2FjaGVSZW1vdmVzKSB7CiAgICAgICAgICAgICAgaWYgKGluQ2FjaGVSZW1vdmVzIDwgaW5DYWNoZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGluQ2FjaGUgPSBpbkNhY2hlLmZpbHRlcihCb29sZWFuKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaW5DYWNoZSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhY2hlW2luQ2FjaGVNb2RlXSA9IGluQ2FjaGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFuZXdJbkNhY2hlSXRlbXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgbmV3SW5DYWNoZUl0ZW1zID0gbnVsbDsKICAgICAgICAgICAgICBpZiAoIWluQ2FjaGUpIGV2ZW50Q2FjaGVbZGF0YXNldElkXSA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2FjaGVbbW9kZV0gPSBuZXdJbkNhY2hlSXRlbXM7CiAgICAgICAgICAgICAgaWYgKGluQ2FjaGUpIGNhY2hlLm1peGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGFycmF5LnB1c2guYXBwbHkoYXJyYXksIGluc2VydGVkIHx8IGRlbGV0ZWQpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBldmVudENhY2hlW2RhdGFzZXRJZF0gPSB7CiAgICAgICAgICBpbnNlcnRlZDogaW5zZXJ0ZWQsCiAgICAgICAgICBkZWxldGVkOiBkZWxldGVkLAogICAgICAgICAgZGF0YXNldDogZGF0YXNldCwKICAgICAgICAgIG1peGVkOiBmYWxzZQogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdXJnZW50Rmx1c2goKSB7CiAgICAgICAgdXJnZW50VGltZXIgPSBudWxsOwogICAgICAgIGlmIChzZXRTdGF0ZUNvdW50KSB7CiAgICAgICAgICBiYXNpcy5kZXYud2FybigiKGRlYnVnKSBVcmdlbnQgZmx1c2ggZGF0YXNldCBjaGFuZ2VzIik7CiAgICAgICAgICBzZXRTdGF0ZUNvdW50ID0gMDsKICAgICAgICAgIHNldEFjY3VtdWxhdGVTdGF0ZU9mZigpOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzZXRBY2N1bXVsYXRlU3RhdGVPZmYoKSB7CiAgICAgICAgcHJvdG8uZW1pdF9pdGVtc0NoYW5nZWQgPSByZWFsRXZlbnQ7CiAgICAgICAgZmx1c2hBbGxEYXRhc2V0KCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKHN0YXRlKSB7CiAgICAgICAgaWYgKHN0YXRlKSB7CiAgICAgICAgICBpZiAoc2V0U3RhdGVDb3VudCA9PSAwKSB7CiAgICAgICAgICAgIHJlYWxFdmVudCA9IHByb3RvLmVtaXRfaXRlbXNDaGFuZ2VkOwogICAgICAgICAgICBwcm90by5lbWl0X2l0ZW1zQ2hhbmdlZCA9IHN0b3JlRGF0YXNldERlbHRhOwogICAgICAgICAgICBpZiAoIXVyZ2VudFRpbWVyKSB1cmdlbnRUaW1lciA9IGJhc2lzLnNldEltbWVkaWF0ZSh1cmdlbnRGbHVzaCk7CiAgICAgICAgICB9CiAgICAgICAgICBzZXRTdGF0ZUNvdW50Kys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNldFN0YXRlQ291bnQgLT0gc2V0U3RhdGVDb3VudCA+IDA7CiAgICAgICAgICBpZiAoc2V0U3RhdGVDb3VudCA9PSAwKSBzZXRBY2N1bXVsYXRlU3RhdGVPZmYoKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9KCk7CiAgICBmdW5jdGlvbiB3cmFwRGF0YShkYXRhKSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSByZXR1cm4gZGF0YS5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBkYXRhOiBpdGVtCiAgICAgICAgfTsKICAgICAgfSk7IGVsc2UgcmV0dXJuIHsKICAgICAgICBkYXRhOiBkYXRhCiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiB3cmFwT2JqZWN0KGRhdGEpIHsKICAgICAgaWYgKCFkYXRhIHx8IGRhdGEuY29uc3RydWN0b3IgIT09IE9iamVjdCkgZGF0YSA9IHsKICAgICAgICB2YWx1ZTogZGF0YQogICAgICB9OwogICAgICByZXR1cm4gbmV3IERhdGFPYmplY3QoewogICAgICAgIGRhdGE6IGRhdGEKICAgICAgfSk7CiAgICB9CiAgICBmdW5jdGlvbiB3cmFwKHZhbHVlLCByZXRPYmplY3QpIHsKICAgICAgdmFyIHdyYXBwZXIgPSByZXRPYmplY3QgPyB3cmFwT2JqZWN0IDogd3JhcERhdGE7CiAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHZhbHVlLm1hcCh3cmFwcGVyKSA6IHdyYXBwZXIodmFsdWUpOwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFNUQVRFOiBTVEFURSwKICAgICAgU1VCU0NSSVBUSU9OOiBTVUJTQ1JJUFRJT04sCiAgICAgIEFic3RyYWN0RGF0YTogQWJzdHJhY3REYXRhLAogICAgICBWYWx1ZTogVmFsdWUsCiAgICAgIE9iamVjdDogRGF0YU9iamVjdCwKICAgICAgU2xvdDogU2xvdCwKICAgICAgS2V5T2JqZWN0TWFwOiBLZXlPYmplY3RNYXAsCiAgICAgIFJlYWRPbmx5RGF0YXNldDogUmVhZE9ubHlEYXRhc2V0LAogICAgICBEYXRhc2V0OiBEYXRhc2V0LAogICAgICBEYXRhc2V0V3JhcHBlcjogRGF0YXNldFdyYXBwZXIsCiAgICAgIGlzQ29ubmVjdGVkOiBpc0Nvbm5lY3RlZCwKICAgICAgZ2V0RGF0YXNldERlbHRhOiBnZXREYXRhc2V0RGVsdGEsCiAgICAgIFJlc29sdmVBZGFwdGVyOiBSZXNvbHZlQWRhcHRlciwKICAgICAgcmVzb2x2ZURhdGFzZXQ6IHJlc29sdmVEYXRhc2V0LAogICAgICByZXNvbHZlT2JqZWN0OiByZXNvbHZlT2JqZWN0LAogICAgICB3cmFwRGF0YTogd3JhcERhdGEsCiAgICAgIHdyYXBPYmplY3Q6IHdyYXBPYmplY3QsCiAgICAgIHdyYXA6IHdyYXAKICAgIH07CiAgfSwKICAiNS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgQ2xhc3MgPSBiYXNpcy5DbGFzczsKICAgIHZhciBjb21wbGV0ZSA9IGJhc2lzLm9iamVjdC5jb21wbGV0ZTsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheTsKICAgIHZhciBhcnJheVJlbW92ZSA9IGJhc2lzLmFycmF5LnJlbW92ZTsKICAgIHZhciAkdW5kZWYgPSBiYXNpcy5mbi4kdW5kZWY7CiAgICB2YXIgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyOwogICAgdmFyIG51bGxHZXR0ZXIgPSBiYXNpcy5mbi5udWxsR2V0dGVyOwogICAgdmFyIG9uZUZ1bmN0aW9uUHJvcGVydHkgPSBDbGFzcy5vbmVGdW5jdGlvblByb3BlcnR5OwogICAgdmFyIGNyZWF0ZUV2ZW50ID0gYmFzaXMuZXZlbnQuY3JlYXRlOwogICAgdmFyIGV2ZW50cyA9IGJhc2lzLmV2ZW50LmV2ZW50czsKICAgIHZhciBTVUJTQ1JJUFRJT04gPSBiYXNpcy5kYXRhLlNVQlNDUklQVElPTjsKICAgIHZhciBTVEFURSA9IGJhc2lzLmRhdGEuU1RBVEU7CiAgICB2YXIgQWJzdHJhY3REYXRhID0gYmFzaXMuZGF0YS5BYnN0cmFjdERhdGE7CiAgICB2YXIgRGF0YU9iamVjdCA9IGJhc2lzLmRhdGEuT2JqZWN0OwogICAgdmFyIFJlYWRPbmx5RGF0YXNldCA9IGJhc2lzLmRhdGEuUmVhZE9ubHlEYXRhc2V0OwogICAgdmFyIERhdGFzZXQgPSBiYXNpcy5kYXRhLkRhdGFzZXQ7CiAgICB2YXIgRGF0YXNldFdyYXBwZXIgPSBiYXNpcy5kYXRhLkRhdGFzZXRXcmFwcGVyOwogICAgdmFyIEVYQ0VQVElPTl9DQU5UX0lOU0VSVCA9IG5hbWVzcGFjZSArICI6IE5vZGUgY2FuJ3QgYmUgaW5zZXJ0ZWQgYXQgc3BlY2lmaWVkIHBvaW50IGluIGhpZXJhcmNoeSI7CiAgICB2YXIgRVhDRVBUSU9OX05PREVfTk9UX0ZPVU5EID0gbmFtZXNwYWNlICsgIjogTm9kZSB3YXMgbm90IGZvdW5kIjsKICAgIHZhciBFWENFUFRJT05fQkFEX0NISUxEX0NMQVNTID0gbmFtZXNwYWNlICsgIjogQ2hpbGQgbm9kZSBoYXMgd3JvbmcgY2xhc3MiOwogICAgdmFyIEVYQ0VQVElPTl9OVUxMX0NISUxEID0gbmFtZXNwYWNlICsgIjogQ2hpbGQgbm9kZSBpcyBudWxsIjsKICAgIHZhciBFWENFUFRJT05fREFUQVNPVVJDRV9DT05GTElDVCA9IG5hbWVzcGFjZSArICI6IE9wZXJhdGlvbiBpcyBub3QgYWxsb3dlZCBiZWNhdXNlIG5vZGUgaXMgdW5kZXIgZGF0YVNvdXJjZSBjb250cm9sIjsKICAgIHZhciBFWENFUFRJT05fREFUQVNPVVJDRUFEQVBURVJfQ09ORkxJQ1QgPSBuYW1lc3BhY2UgKyAiOiBPcGVyYXRpb24gaXMgbm90IGFsbG93ZWQgYmVjYXVzZSBub2RlIGlzIHVuZGVyIGRhdGFTb3VyY2UgYWRhcHRlciBjb250cm9sIjsKICAgIHZhciBFWENFUFRJT05fUEFSRU5UTk9ERV9PV05FUl9DT05GTElDVCA9IG5hbWVzcGFjZSArICI6IE5vZGUgY2FuJ3QgaGFzIG93bmVyIGFuZCBwYXJlbnROb2RlIjsKICAgIHZhciBFWENFUFRJT05fTk9fQ0hJTERDTEFTUyA9IG5hbWVzcGFjZSArICI6IE5vZGUgY2FuJ3QgaGFzIGNoaWxkcmVuIGFuZCBkYXRhU291cmNlIGFzIGNoaWxkQ2xhc3MgaXNuJ3Qgc3BlY2lmaWVkIjsKICAgIHZhciBERUxFR0FURSA9IHsKICAgICAgQU5ZOiB0cnVlLAogICAgICBOT05FOiBmYWxzZSwKICAgICAgUEFSRU5UOiAicGFyZW50IiwKICAgICAgT1dORVI6ICJvd25lciIKICAgIH07CiAgICB2YXIgY2hpbGROb2Rlc0RhdGFzZXRNYXAgPSB7fTsKICAgIGZ1bmN0aW9uIHdhcm5PbkRhdGFTb3VyY2VJdGVtTm9kZURlc3RveSgpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogbm9kZSBjYW4ndCBiZSBkZXN0cm95ZWQgYXMgcmVwcmVzZW50aW5nIGRhdGFTb3VyY2UgaXRlbSwgZGVzdHJveSBkZWxlZ2F0ZSBpdGVtIG9yIHJlbW92ZSBpdCBmcm9tIGRhdGFTb3VyY2UgZmlyc3QiKTsKICAgIH0KICAgIGZ1bmN0aW9uIHdhcm5PbkF1dG9TYXRlbGxpdGVPd25lckNoYW5nZSgpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogc2F0ZWxsaXRlIGNhbid0IGNoYW5nZSBvd25lciBhcyBpdCBhdXRvLXNhdGVsbGl0ZSIpOwogICAgfQogICAgZnVuY3Rpb24gd2Fybk9uQXV0b1NhdGVsbGl0ZURlc3RveSgpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogc2F0ZWxsaXRlIGNhbid0IGJlIGRlc3Ryb3llZCBhcyBpdCBhdXRvLWNyZWF0ZSBzYXRlbGxpdGUsIGFuZCBjb3VsZCBiZSBkZXN0cm95ZWQgb24gb3duZXIgZGVzdHJveSIpOwogICAgfQogICAgZnVuY3Rpb24gbG9ja0RhdGFTb3VyY2VJdGVtTm9kZShub2RlKSB7CiAgICAgIG5vZGUuc2V0RGVsZWdhdGUgPSBiYXNpcy5mbi4kdW5kZWY7CiAgICAgIG5vZGUuZGVzdHJveSA9IHdhcm5PbkRhdGFTb3VyY2VJdGVtTm9kZURlc3RveTsKICAgIH0KICAgIGZ1bmN0aW9uIHVubG9ja0RhdGFTb3VyY2VJdGVtTm9kZShub2RlKSB7CiAgICAgIHZhciBwcm90byA9IG5vZGUuY29uc3RydWN0b3IucHJvdG90eXBlOwogICAgICBub2RlLnNldERlbGVnYXRlID0gcHJvdG8uc2V0RGVsZWdhdGU7CiAgICAgIG5vZGUuZGVzdHJveSA9IHByb3RvLmRlc3Ryb3k7CiAgICB9CiAgICBmdW5jdGlvbiBzb3J0aW5nU2VhcmNoKG5vZGUpIHsKICAgICAgcmV0dXJuIG5vZGUuc29ydGluZ1ZhbHVlIHx8IDA7CiAgICB9CiAgICBmdW5jdGlvbiBzb3J0QXNjKGEsIGIpIHsKICAgICAgYSA9IGEuc29ydGluZ1ZhbHVlIHx8IDA7CiAgICAgIGIgPSBiLnNvcnRpbmdWYWx1ZSB8fCAwOwogICAgICByZXR1cm4gKyhhID4gYikgfHwgLShhIDwgYik7CiAgICB9CiAgICBmdW5jdGlvbiBzb3J0RGVzYyhhLCBiKSB7CiAgICAgIGEgPSBhLnNvcnRpbmdWYWx1ZSB8fCAwOwogICAgICBiID0gYi5zb3J0aW5nVmFsdWUgfHwgMDsKICAgICAgcmV0dXJuIC0oYSA+IGIpIHx8ICsoYSA8IGIpOwogICAgfQogICAgZnVuY3Rpb24gc29ydENoaWxkTm9kZXMob2JqKSB7CiAgICAgIHJldHVybiBvYmouY2hpbGROb2Rlcy5zb3J0KG9iai5zb3J0aW5nRGVzYyA/IHNvcnREZXNjIDogc29ydEFzYyk7CiAgICB9CiAgICBmdW5jdGlvbiBiaW5hcnlTZWFyY2hQb3MoYXJyYXksIHZhbHVlLCBnZXR0ZXJfLCBkZXNjKSB7CiAgICAgIGlmICghYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgZGVzYyA9ICEhZGVzYzsKICAgICAgdmFyIHBvczsKICAgICAgdmFyIGNvbXBhcmVWYWx1ZTsKICAgICAgdmFyIGwgPSAwOwogICAgICB2YXIgciA9IGFycmF5Lmxlbmd0aCAtIDE7CiAgICAgIGRvIHsKICAgICAgICBwb3MgPSBsICsgciA+PiAxOwogICAgICAgIGNvbXBhcmVWYWx1ZSA9IGdldHRlcl8oYXJyYXlbcG9zXSk7CiAgICAgICAgaWYgKGRlc2MgPyB2YWx1ZSA+IGNvbXBhcmVWYWx1ZSA6IHZhbHVlIDwgY29tcGFyZVZhbHVlKSByID0gcG9zIC0gMTsgZWxzZSBpZiAoZGVzYyA/IHZhbHVlIDwgY29tcGFyZVZhbHVlIDogdmFsdWUgPiBjb21wYXJlVmFsdWUpIGwgPSBwb3MgKyAxOyBlbHNlIHJldHVybiB2YWx1ZSA9PSBjb21wYXJlVmFsdWUgPyBwb3MgOiAwOwogICAgICB9IHdoaWxlIChsIDw9IHIpOwogICAgICByZXR1cm4gcG9zICsgKGNvbXBhcmVWYWx1ZSA8IHZhbHVlIF4gZGVzYyk7CiAgICB9CiAgICBmdW5jdGlvbiB1cGRhdGVOb2RlQ29udGV4dFNlbGVjdGlvbihyb290LCBvbGRTZWxlY3Rpb24sIG5ld1NlbGVjdGlvbiwgcm9vdFVwZGF0ZSwgaWdub3JlUm9vdFNlbGVjdGlvbikgewogICAgICBpZiAob2xkU2VsZWN0aW9uID09PSBuZXdTZWxlY3Rpb24pIHJldHVybjsKICAgICAgdmFyIG5leHROb2RlOwogICAgICB2YXIgY3Vyc29yID0gcm9vdDsKICAgICAgdmFyIHNlbGVjdGVkID0gW107CiAgICAgIGlmIChyb290VXBkYXRlKSB7CiAgICAgICAgcm9vdC5jb250ZXh0U2VsZWN0aW9uID0gbmV3U2VsZWN0aW9uOwogICAgICAgIGlmIChyb290LnNlbGVjdGVkKSBzZWxlY3RlZC5wdXNoKHJvb3QpOwogICAgICB9CiAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICBuZXh0Tm9kZSA9ICFjdXJzb3Iuc2VsZWN0aW9uIHx8IGlnbm9yZVJvb3RTZWxlY3Rpb24gJiYgY3Vyc29yID09PSByb290ID8gY3Vyc29yLmZpcnN0Q2hpbGQgOiBudWxsOwogICAgICAgIGlmIChuZXh0Tm9kZSAmJiBuZXh0Tm9kZS5jb250ZXh0U2VsZWN0aW9uICE9PSBvbGRTZWxlY3Rpb24pIHRocm93ICJUcnkgY2hhbmdlIHdyb25nIGNvbnRleHQgc2VsZWN0aW9uIjsKICAgICAgICB3aGlsZSAoIW5leHROb2RlKSB7CiAgICAgICAgICBpZiAoY3Vyc29yID09PSByb290KSB7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZC5sZW5ndGgpIHsKICAgICAgICAgICAgICBpZiAob2xkU2VsZWN0aW9uKSBvbGRTZWxlY3Rpb24ucmVtb3ZlKHNlbGVjdGVkKTsKICAgICAgICAgICAgICBpZiAobmV3U2VsZWN0aW9uKSBuZXdTZWxlY3Rpb24uYWRkKHNlbGVjdGVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBuZXh0Tm9kZSA9IGN1cnNvci5uZXh0U2libGluZzsKICAgICAgICAgIGlmICghbmV4dE5vZGUpIGN1cnNvciA9IGN1cnNvci5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICBjdXJzb3IgPSBuZXh0Tm9kZTsKICAgICAgICBpZiAoY3Vyc29yLnNlbGVjdGVkKSBzZWxlY3RlZC5wdXNoKGN1cnNvcik7CiAgICAgICAgY3Vyc29yLmNvbnRleHRTZWxlY3Rpb24gPSBuZXdTZWxlY3Rpb247CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHVwZGF0ZU5vZGVEaXNhYmxlQ29udGV4dChub2RlLCBkaXNhYmxlZCkgewogICAgICBpZiAobm9kZS5jb250ZXh0RGlzYWJsZWQgIT0gZGlzYWJsZWQpIHsKICAgICAgICBub2RlLmNvbnRleHREaXNhYmxlZCA9IGRpc2FibGVkOwogICAgICAgIGlmIChub2RlLmRpc2FibGVkKSByZXR1cm47CiAgICAgICAgaWYgKGRpc2FibGVkKSBub2RlLmVtaXRfZGlzYWJsZSgpOyBlbHNlIG5vZGUuZW1pdF9lbmFibGUoKTsKICAgICAgfQogICAgfQogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJvd25lciIpOwogICAgU1VCU0NSSVBUSU9OLmFkZFByb3BlcnR5KCJkYXRhU291cmNlIik7CiAgICBmdW5jdGlvbiBwcm9jZXNzU2F0ZWxsaXRlQ29uZmlnKHZhbHVlKSB7CiAgICAgIGlmICghdmFsdWUpIHJldHVybiBudWxsOwogICAgICBpZiAodmFsdWUuaXNTYXRlbGxpdGVDb25maWcpIHJldHVybiB2YWx1ZTsKICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQWJzdHJhY3ROb2RlKSByZXR1cm4gdmFsdWU7CiAgICAgIGlmIChDbGFzcy5pc0NsYXNzKHZhbHVlKSkgdmFsdWUgPSB7CiAgICAgICAgaW5zdGFuY2VPZjogdmFsdWUKICAgICAgfTsKICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLmNvbnN0cnVjdG9yID09PSBPYmplY3QpIHsKICAgICAgICB2YXIgaGFuZGxlclJlcXVpcmVkID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbmZpZyA9IHsKICAgICAgICAgIGlzU2F0ZWxsaXRlQ29uZmlnOiB0cnVlCiAgICAgICAgfTsKICAgICAgICB2YXIgaW5zdGFuY2VDbGFzczsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgICBjYXNlICJpbnN0YW5jZSI6CiAgICAgICAgICAgIGlmICh2YWx1ZVtrZXldIGluc3RhbmNlb2YgQWJzdHJhY3ROb2RlKSBjb25maWdba2V5XSA9IHZhbHVlW2tleV07IGVsc2UgewogICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICI6IGBpbnN0YW5jZWAgdmFsdWUgaW4gc2F0ZWxsaXRlIGNvbmZpZyBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIGJhc2lzLmRvbS53cmFwcGVyLkFic3RyYWN0Tm9kZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiaW5zdGFuY2VPZiI6CiAgICAgICAgICAgIGlmIChDbGFzcy5pc0NsYXNzKHZhbHVlW2tleV0pICYmIHZhbHVlW2tleV0uaXNTdWJjbGFzc09mKEFic3RyYWN0Tm9kZSkpIGluc3RhbmNlQ2xhc3MgPSB2YWx1ZVtrZXldOyBlbHNlIHsKICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiBgaW5zdGFuY2VPZmAgdmFsdWUgaW4gc2F0ZWxsaXRlIGNvbmZpZyBtdXN0IGJlIGEgc3ViY2xhc3Mgb2YgYmFzaXMuZG9tLndyYXBwZXIuQWJzdHJhY3ROb2RlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJleGlzdHNJZiI6CiAgICAgICAgICBjYXNlICJkZWxlZ2F0ZSI6CiAgICAgICAgICBjYXNlICJkYXRhU291cmNlIjoKICAgICAgICAgICAgaGFuZGxlclJlcXVpcmVkID0gdHJ1ZTsKICAgICAgICAgICAgY29uZmlnW2tleV0gPSBnZXR0ZXIodmFsdWVba2V5XSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiY29uZmlnIjoKICAgICAgICAgICAgY29uZmlnW2tleV0gPSB2YWx1ZVtrZXldOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKCFjb25maWcuaW5zdGFuY2UpIGNvbmZpZy5pbnN0YW5jZU9mID0gaW5zdGFuY2VDbGFzcyB8fCBBYnN0cmFjdE5vZGU7IGVsc2UgewogICAgICAgICAgaWYgKGluc3RhbmNlQ2xhc3MpIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICI6IGBpbnN0YW5jZU9mYCBjYW4ndCBiZSBzZXQgd2l0aCBgaW5zdGFuY2VgIHZhbHVlIGluIHNhdGVsbGl0ZSBjb25maWcsIHZhbHVlIGlnbm9yZWQiKTsKICAgICAgICB9CiAgICAgICAgaWYgKGhhbmRsZXJSZXF1aXJlZCkgewogICAgICAgICAgdmFyIGV2ZW50cyA9ICJldmVudHMiIGluIHZhbHVlID8gdmFsdWUuZXZlbnRzIDogInVwZGF0ZSI7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShldmVudHMpKSBldmVudHMgPSBldmVudHMuam9pbigiICIpOwogICAgICAgICAgaWYgKHR5cGVvZiBldmVudHMgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSB7fTsKICAgICAgICAgICAgZXZlbnRzID0gZXZlbnRzLnNwbGl0KC9ccysvKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50TmFtZTsgZXZlbnROYW1lID0gZXZlbnRzW2ldOyBpKyspIHsKICAgICAgICAgICAgICBoYW5kbGVyW2V2ZW50TmFtZV0gPSBTQVRFTExJVEVfVVBEQVRFOwogICAgICAgICAgICAgIGNvbmZpZy5oYW5kbGVyID0gaGFuZGxlcjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gY29uZmlnOwogICAgICB9CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgZnVuY3Rpb24gYXBwbHlTYXRlbGxpdGVzKG5vZGUsIHNhdGVsbGl0ZXMpIHsKICAgICAgZm9yICh2YXIgbmFtZSBpbiBzYXRlbGxpdGVzKSBpZiAoc2F0ZWxsaXRlc1tuYW1lXSAmJiB0eXBlb2Ygc2F0ZWxsaXRlc1tuYW1lXSA9PSAib2JqZWN0Iikgbm9kZS5zZXRTYXRlbGxpdGUobmFtZSwgc2F0ZWxsaXRlc1tuYW1lXSk7CiAgICB9CiAgICB2YXIgTlVMTF9TQVRFTExJVEUgPSBDbGFzcy5jdXN0b21FeHRlbmRQcm9wZXJ0eSh7fSwgZnVuY3Rpb24ocmVzdWx0LCBleHRlbmQpIHsKICAgICAgZm9yICh2YXIgbmFtZSBpbiBleHRlbmQpIHJlc3VsdFtuYW1lXSA9IHByb2Nlc3NTYXRlbGxpdGVDb25maWcoZXh0ZW5kW25hbWVdKTsKICAgIH0pOwogICAgdmFyIFNBVEVMTElURV9VUERBVEUgPSBmdW5jdGlvbihvd25lcikgewogICAgICB2YXIgbmFtZSA9IHRoaXMubmFtZTsKICAgICAgdmFyIGNvbmZpZyA9IHRoaXMuY29uZmlnOwogICAgICB2YXIgZXhpc3RzID0gIWNvbmZpZy5leGlzdHNJZiB8fCBjb25maWcuZXhpc3RzSWYob3duZXIpOwogICAgICB2YXIgc2F0ZWxsaXRlID0gb3duZXIuc2F0ZWxsaXRlW25hbWVdOwogICAgICBpZiAoZXhpc3RzKSB7CiAgICAgICAgaWYgKHNhdGVsbGl0ZSkgewogICAgICAgICAgaWYgKGNvbmZpZy5kZWxlZ2F0ZSkgc2F0ZWxsaXRlLnNldERlbGVnYXRlKGNvbmZpZy5kZWxlZ2F0ZShvd25lcikpOwogICAgICAgICAgaWYgKGNvbmZpZy5kYXRhU291cmNlKSBzYXRlbGxpdGUuc2V0RGF0YVNvdXJjZShjb25maWcuZGF0YVNvdXJjZShvd25lcikpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzYXRlbGxpdGUgPSBjb25maWcuaW5zdGFuY2U7CiAgICAgICAgICBpZiAoIXNhdGVsbGl0ZSkgewogICAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlcjsKICAgICAgICAgICAgdmFyIHNhdGVsbGl0ZUNvbmZpZyA9ICh0eXBlb2YgY29uZmlnLmNvbmZpZyA9PSAiZnVuY3Rpb24iID8gY29uZmlnLmNvbmZpZyhvd25lcikgOiBjb25maWcuY29uZmlnKSB8fCB7fTsKICAgICAgICAgICAgc2F0ZWxsaXRlQ29uZmlnLm93bmVyID0gb3duZXI7CiAgICAgICAgICAgIGlmIChjb25maWcuZGVsZWdhdGUpIHsKICAgICAgICAgICAgICBzYXRlbGxpdGVDb25maWcuYXV0b0RlbGVnYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgc2F0ZWxsaXRlQ29uZmlnLmRlbGVnYXRlID0gY29uZmlnLmRlbGVnYXRlKG93bmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29uZmlnLmRhdGFTb3VyY2UpIHNhdGVsbGl0ZUNvbmZpZy5kYXRhU291cmNlID0gY29uZmlnLmRhdGFTb3VyY2Uob3duZXIpOwogICAgICAgICAgICBzYXRlbGxpdGUgPSBuZXcgY29uZmlnLmluc3RhbmNlT2Yoc2F0ZWxsaXRlQ29uZmlnKTsKICAgICAgICAgICAgc2F0ZWxsaXRlLmRlc3Ryb3kgPSB3YXJuT25BdXRvU2F0ZWxsaXRlRGVzdG95OwogICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlciA9IG93bmVyLmxpc3Rlbi5zYXRlbGxpdGUpIHNhdGVsbGl0ZS5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIG93bmVyKTsKICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIgPSBvd25lci5saXN0ZW5bInNhdGVsbGl0ZToiICsgbmFtZV0pIHNhdGVsbGl0ZS5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIG93bmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjb25maWcuZGVsZWdhdGUpIHNhdGVsbGl0ZS5zZXREZWxlZ2F0ZShjb25maWcuZGVsZWdhdGUob3duZXIpKTsKICAgICAgICAgICAgaWYgKGNvbmZpZy5kYXRhU291cmNlKSBzYXRlbGxpdGUuc2V0RGF0YVNvdXJjZShjb25maWcuZGF0YVNvdXJjZShvd25lcikpOwogICAgICAgICAgfQogICAgICAgICAgb3duZXIuc2F0ZWxsaXRlLl9fYXV0b19fW25hbWVdLmluc3RhbmNlID0gc2F0ZWxsaXRlOwogICAgICAgICAgb3duZXIuc2V0U2F0ZWxsaXRlKG5hbWUsIHNhdGVsbGl0ZSwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChzYXRlbGxpdGUpIHsKICAgICAgICAgIGlmIChjb25maWcuaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKGNvbmZpZy5kZWxlZ2F0ZSkgc2F0ZWxsaXRlLnNldERlbGVnYXRlKCk7CiAgICAgICAgICAgIGlmIChjb25maWcuZGF0YVNvdXJjZSkgc2F0ZWxsaXRlLnNldERhdGFTb3VyY2UoKTsKICAgICAgICAgIH0KICAgICAgICAgIG93bmVyLnNhdGVsbGl0ZS5fX2F1dG9fX1tuYW1lXS5pbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBvd25lci5zZXRTYXRlbGxpdGUobmFtZSwgbnVsbCwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgdmFyIEFVVE9fU0FURUxMSVRFX0lOU1RBTkNFX0hBTkRMRVIgPSB7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMub3duZXIuc2V0U2F0ZWxsaXRlKHRoaXMubmFtZSwgbnVsbCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgQWJzdHJhY3ROb2RlID0gQ2xhc3MoRGF0YU9iamVjdCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQWJzdHJhY3ROb2RlIiwKICAgICAgc3Vic2NyaWJlVG86IERhdGFPYmplY3QucHJvdG90eXBlLnN1YnNjcmliZVRvICsgU1VCU0NSSVBUSU9OLkRBVEFTT1VSQ0UsCiAgICAgIGlzU3luY1JlcXVpcmVkOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdGF0ZSA9PSBTVEFURS5VTkRFRklORUQgfHwgdGhpcy5zdGF0ZSA9PSBTVEFURS5ERVBSRUNBVEVEOwogICAgICB9LAogICAgICBzeW5jRXZlbnRzOiB7CiAgICAgICAgYWN0aXZlQ2hhbmdlZDogZmFsc2UKICAgICAgfSwKICAgICAgZW1pdF91cGRhdGU6IGZ1bmN0aW9uKGRlbHRhKSB7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuZW1pdF91cGRhdGUuY2FsbCh0aGlzLCBkZWx0YSk7CiAgICAgICAgdmFyIHBhcmVudE5vZGUgPSB0aGlzLnBhcmVudE5vZGU7CiAgICAgICAgaWYgKHBhcmVudE5vZGUpIHsKICAgICAgICAgIGlmIChwYXJlbnROb2RlLm1hdGNoRnVuY3Rpb24pIHRoaXMubWF0Y2gocGFyZW50Tm9kZS5tYXRjaEZ1bmN0aW9uKTsKICAgICAgICAgIHBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXMsIHRoaXMubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgbGlzdGVuOiB7CiAgICAgICAgb3duZXI6IHsKICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIXRoaXMub3duZXJTYXRlbGxpdGVOYW1lKSB0aGlzLnNldE93bmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBhdXRvRGVsZWdhdGU6IERFTEVHQVRFLk5PTkUsCiAgICAgIG5hbWU6IG51bGwsCiAgICAgIGNoaWxkTm9kZXM6IG51bGwsCiAgICAgIGVtaXRfY2hpbGROb2Rlc01vZGlmaWVkOiBjcmVhdGVFdmVudCgiY2hpbGROb2Rlc01vZGlmaWVkIiwgImRlbHRhIikgJiYgZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICBldmVudHMuY2hpbGROb2Rlc01vZGlmaWVkLmNhbGwodGhpcywgZGVsdGEpOwogICAgICAgIHZhciBsaXN0ZW4gPSB0aGlzLmxpc3Rlbi5jaGlsZE5vZGU7CiAgICAgICAgdmFyIGFycmF5OwogICAgICAgIGlmIChsaXN0ZW4pIHsKICAgICAgICAgIGlmIChhcnJheSA9IGRlbHRhLmluc2VydGVkKSBmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gYXJyYXlbaV07IGkrKykgY2hpbGQuYWRkSGFuZGxlcihsaXN0ZW4sIHRoaXMpOwogICAgICAgICAgaWYgKGFycmF5ID0gZGVsdGEuZGVsZXRlZCkgZm9yICh2YXIgaSA9IDAsIGNoaWxkOyBjaGlsZCA9IGFycmF5W2ldOyBpKyspIGNoaWxkLnJlbW92ZUhhbmRsZXIobGlzdGVuLCB0aGlzKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNoaWxkTm9kZXNTdGF0ZTogU1RBVEUuVU5ERUZJTkVELAogICAgICBlbWl0X2NoaWxkTm9kZXNTdGF0ZUNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJjaGlsZE5vZGVzU3RhdGVDaGFuZ2VkIiwgIm9sZFN0YXRlIiksCiAgICAgIGNoaWxkQ2xhc3M6IEFic3RyYWN0Tm9kZSwKICAgICAgZGF0YVNvdXJjZTogbnVsbCwKICAgICAgZW1pdF9kYXRhU291cmNlQ2hhbmdlZDogY3JlYXRlRXZlbnQoImRhdGFTb3VyY2VDaGFuZ2VkIiwgIm9sZERhdGFTb3VyY2UiKSwKICAgICAgZGF0YVNvdXJjZUFkYXB0ZXJfOiBudWxsLAogICAgICBkYXRhU291cmNlTWFwXzogbnVsbCwKICAgICAgZGVzdHJveURhdGFTb3VyY2VNZW1iZXI6IHRydWUsCiAgICAgIHBhcmVudE5vZGU6IG51bGwsCiAgICAgIG5leHRTaWJsaW5nOiBudWxsLAogICAgICBwcmV2aW91c1NpYmxpbmc6IG51bGwsCiAgICAgIGZpcnN0Q2hpbGQ6IG51bGwsCiAgICAgIGxhc3RDaGlsZDogbnVsbCwKICAgICAgc29ydGluZzogbnVsbEdldHRlciwKICAgICAgc29ydGluZ0Rlc2M6IGZhbHNlLAogICAgICBlbWl0X3NvcnRpbmdDaGFuZ2VkOiBjcmVhdGVFdmVudCgic29ydGluZ0NoYW5nZWQiLCAib2xkU29ydGluZyIsICJvbGRTb3J0aW5nRGVzYyIpLAogICAgICBncm91cGluZ0NsYXNzOiBudWxsLAogICAgICBncm91cGluZzogbnVsbCwKICAgICAgZW1pdF9ncm91cGluZ0NoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJncm91cGluZ0NoYW5nZWQiLCAib2xkR3JvdXBpbmciKSwKICAgICAgZ3JvdXBOb2RlOiBudWxsLAogICAgICBncm91cElkOiBOYU4sCiAgICAgIHNhdGVsbGl0ZTogTlVMTF9TQVRFTExJVEUsCiAgICAgIG93bmVyU2F0ZWxsaXRlTmFtZTogbnVsbCwKICAgICAgZW1pdF9zYXRlbGxpdGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgic2F0ZWxsaXRlQ2hhbmdlZCIsICJuYW1lIiwgIm9sZFNhdGVsbGl0ZSIpLAogICAgICBvd25lcjogbnVsbCwKICAgICAgZW1pdF9vd25lckNoYW5nZWQ6IGNyZWF0ZUV2ZW50KCJvd25lckNoYW5nZWQiLCAib2xkT3duZXIiKSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBjaGlsZE5vZGVzID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgIHZhciBkYXRhU291cmNlID0gdGhpcy5kYXRhU291cmNlOwogICAgICAgIGlmIChjaGlsZE5vZGVzKSB0aGlzLmNoaWxkTm9kZXMgPSBudWxsOwogICAgICAgIGlmIChkYXRhU291cmNlKSB0aGlzLmRhdGFTb3VyY2UgPSBudWxsOwogICAgICAgIHZhciBncm91cGluZyA9IHRoaXMuZ3JvdXBpbmc7CiAgICAgICAgaWYgKGdyb3VwaW5nKSB7CiAgICAgICAgICB0aGlzLmdyb3VwaW5nID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2V0R3JvdXBpbmcoZ3JvdXBpbmcpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5jaGlsZENsYXNzKSB7CiAgICAgICAgICB0aGlzLmNoaWxkTm9kZXMgPSBbXTsKICAgICAgICAgIGlmIChkYXRhU291cmNlKSB7CiAgICAgICAgICAgIHRoaXMuc2V0RGF0YVNvdXJjZShkYXRhU291cmNlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjaGlsZE5vZGVzKSB0aGlzLnNldENoaWxkTm9kZXMoY2hpbGROb2Rlcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBzYXRlbGxpdGVzID0gdGhpcy5zYXRlbGxpdGU7CiAgICAgICAgaWYgKHNhdGVsbGl0ZXMgIT09IE5VTExfU0FURUxMSVRFKSB7CiAgICAgICAgICB0aGlzLnNhdGVsbGl0ZSA9IE5VTExfU0FURUxMSVRFOwogICAgICAgICAgYXBwbHlTYXRlbGxpdGVzKHRoaXMsIHNhdGVsbGl0ZXMpOwogICAgICAgIH0KICAgICAgICB2YXIgb3duZXIgPSB0aGlzLm93bmVyOwogICAgICAgIGlmIChvd25lcikgewogICAgICAgICAgdGhpcy5vd25lciA9IG51bGw7CiAgICAgICAgICB0aGlzLnNldE93bmVyKG93bmVyKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldENoaWxkTm9kZXNTdGF0ZTogZnVuY3Rpb24oc3RhdGUsIGRhdGEpIHsKICAgICAgICB2YXIgc3RhdGVDb2RlID0gU3RyaW5nKHN0YXRlKTsKICAgICAgICB2YXIgb2xkU3RhdGUgPSB0aGlzLmNoaWxkTm9kZXNTdGF0ZTsKICAgICAgICBpZiAoIVNUQVRFLnZhbHVlc1tzdGF0ZUNvZGVdKSB0aHJvdyBuZXcgRXJyb3IoIldyb25nIHN0YXRlIHZhbHVlIik7CiAgICAgICAgaWYgKG9sZFN0YXRlICE9IHN0YXRlQ29kZSB8fCBvbGRTdGF0ZS5kYXRhICE9IGRhdGEpIHsKICAgICAgICAgIHRoaXMuY2hpbGROb2Rlc1N0YXRlID0gT2JqZWN0KHN0YXRlQ29kZSk7CiAgICAgICAgICB0aGlzLmNoaWxkTm9kZXNTdGF0ZS5kYXRhID0gZGF0YTsKICAgICAgICAgIHRoaXMuZW1pdF9jaGlsZE5vZGVzU3RhdGVDaGFuZ2VkKG9sZFN0YXRlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGFwcGVuZENoaWxkOiBmdW5jdGlvbihuZXdDaGlsZCkge30sCiAgICAgIGluc2VydEJlZm9yZTogZnVuY3Rpb24obmV3Q2hpbGQsIHJlZkNoaWxkKSB7fSwKICAgICAgcmVtb3ZlQ2hpbGQ6IGZ1bmN0aW9uKG9sZENoaWxkKSB7fSwKICAgICAgcmVwbGFjZUNoaWxkOiBmdW5jdGlvbihuZXdDaGlsZCwgb2xkQ2hpbGQpIHt9LAogICAgICBjbGVhcjogZnVuY3Rpb24oYWxpdmUpIHt9LAogICAgICBzZXRDaGlsZE5vZGVzOiBmdW5jdGlvbihub2Rlcykge30sCiAgICAgIHNldEdyb3VwaW5nOiBmdW5jdGlvbihncm91cGluZywgYWxpdmUpIHt9LAogICAgICBzZXRTb3J0aW5nOiBmdW5jdGlvbihzb3J0aW5nLCBkZXNjKSB7fSwKICAgICAgc2V0RGF0YVNvdXJjZTogZnVuY3Rpb24oZGF0YVNvdXJjZSkge30sCiAgICAgIHNldE93bmVyOiBmdW5jdGlvbihvd25lcikgewogICAgICAgIGlmICghb3duZXIgfHwgb3duZXIgaW5zdGFuY2VvZiBBYnN0cmFjdE5vZGUgPT0gZmFsc2UpIG93bmVyID0gbnVsbDsKICAgICAgICBpZiAob3duZXIgJiYgdGhpcy5wYXJlbnROb2RlKSB0aHJvdyBFWENFUFRJT05fUEFSRU5UTk9ERV9PV05FUl9DT05GTElDVDsKICAgICAgICB2YXIgb2xkT3duZXIgPSB0aGlzLm93bmVyOwogICAgICAgIGlmIChvbGRPd25lciAhPT0gb3duZXIpIHsKICAgICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW4ub3duZXI7CiAgICAgICAgICBpZiAob2xkT3duZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMub3duZXJTYXRlbGxpdGVOYW1lICYmIG9sZE93bmVyLnNhdGVsbGl0ZS5fX2F1dG9fXyAmJiB0aGlzLm93bmVyU2F0ZWxsaXRlTmFtZSBpbiBvbGRPd25lci5zYXRlbGxpdGUuX19hdXRvX18pIHsKICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiBhdXRvLXNhdGVsbGl0ZSBjYW4ndCBjaGFuZ2UgaXQncyBvd25lciIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgb2xkT3duZXIucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgaWYgKHRoaXMub3duZXJTYXRlbGxpdGVOYW1lKSB7CiAgICAgICAgICAgICAgdGhpcy5vd25lciA9IG51bGw7CiAgICAgICAgICAgICAgb2xkT3duZXIuc2V0U2F0ZWxsaXRlKHRoaXMub3duZXJTYXRlbGxpdGVOYW1lLCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG93bmVyICYmIGxpc3RlbkhhbmRsZXIpIG93bmVyLmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICB0aGlzLm93bmVyID0gb3duZXI7CiAgICAgICAgICB0aGlzLmVtaXRfb3duZXJDaGFuZ2VkKG9sZE93bmVyKTsKICAgICAgICAgIGlmICh0aGlzLmF1dG9EZWxlZ2F0ZSA9PSBERUxFR0FURS5PV05FUiB8fCB0aGlzLmF1dG9EZWxlZ2F0ZSA9PT0gREVMRUdBVEUuQU5ZKSB0aGlzLnNldERlbGVnYXRlKG93bmVyKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFNhdGVsbGl0ZTogZnVuY3Rpb24obmFtZSwgc2F0ZWxsaXRlLCBhdXRvU2V0KSB7CiAgICAgICAgdmFyIG9sZFNhdGVsbGl0ZSA9IHRoaXMuc2F0ZWxsaXRlW25hbWVdIHx8IG51bGw7CiAgICAgICAgdmFyIGF1dG8gPSB0aGlzLnNhdGVsbGl0ZS5fX2F1dG9fXzsKICAgICAgICB2YXIgYXV0b0NvbmZpZyA9IGF1dG8gJiYgYXV0b1tuYW1lXTsKICAgICAgICB2YXIgcHJlc2VydmVBdXRvID0gYXV0b1NldCAmJiBhdXRvQ29uZmlnOwogICAgICAgIGlmIChwcmVzZXJ2ZUF1dG8pIHsKICAgICAgICAgIHNhdGVsbGl0ZSA9IGF1dG9Db25maWcuaW5zdGFuY2U7CiAgICAgICAgICBpZiAoYXV0b0NvbmZpZy5jb25maWcuaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKHNhdGVsbGl0ZSkgZGVsZXRlIGF1dG9Db25maWcuY29uZmlnLmluc3RhbmNlLnNldE93bmVyOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzYXRlbGxpdGUgPSBwcm9jZXNzU2F0ZWxsaXRlQ29uZmlnKHNhdGVsbGl0ZSk7CiAgICAgICAgICBpZiAoc2F0ZWxsaXRlICYmIHNhdGVsbGl0ZS5vd25lciAmJiBhdXRvICYmIHNhdGVsbGl0ZS5vd25lclNhdGVsbGl0ZU5hbWUgJiYgYXV0b1tzYXRlbGxpdGUub3duZXJTYXRlbGxpdGVOYW1lXSkgewogICAgICAgICAgICBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiBhdXRvLWNyZWF0ZSBzYXRlbGxpdGUgY2FuJ3QgY2hhbmdlIG5hbWUgaW5zaWRlIG93bmVyIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhdXRvQ29uZmlnKSB7CiAgICAgICAgICAgIGRlbGV0ZSBhdXRvW25hbWVdOwogICAgICAgICAgICBpZiAoYXV0b0NvbmZpZy5jb25maWcuaW5zdGFuY2UpIGF1dG9Db25maWcuY29uZmlnLmluc3RhbmNlLnJlbW92ZUhhbmRsZXIoQVVUT19TQVRFTExJVEVfSU5TVEFOQ0VfSEFORExFUiwgYXV0b0NvbmZpZyk7CiAgICAgICAgICAgIGlmIChhdXRvQ29uZmlnLmNvbmZpZy5oYW5kbGVyKSB0aGlzLnJlbW92ZUhhbmRsZXIoYXV0b0NvbmZpZy5jb25maWcuaGFuZGxlciwgYXV0b0NvbmZpZyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChvbGRTYXRlbGxpdGUgIT09IHNhdGVsbGl0ZSkgewogICAgICAgICAgdmFyIHNhdGVsbGl0ZUxpc3RlbiA9IHRoaXMubGlzdGVuLnNhdGVsbGl0ZTsKICAgICAgICAgIHZhciBzYXRlbGxpdGVQZXJzb25hbExpc3RlbiA9IHRoaXMubGlzdGVuWyJzYXRlbGxpdGU6IiArIG5hbWVdOwogICAgICAgICAgdmFyIGRlc3Ryb3lTYXRlbGxpdGU7CiAgICAgICAgICBpZiAob2xkU2F0ZWxsaXRlKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnNhdGVsbGl0ZVtuYW1lXTsKICAgICAgICAgICAgb2xkU2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZSA9IG51bGw7CiAgICAgICAgICAgIGlmIChhdXRvQ29uZmlnICYmIG9sZFNhdGVsbGl0ZS5kZXN0cm95ID09PSB3YXJuT25BdXRvU2F0ZWxsaXRlRGVzdG95KSB7CiAgICAgICAgICAgICAgZGVzdHJveVNhdGVsbGl0ZSA9IG9sZFNhdGVsbGl0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlTGlzdGVuKSBvbGRTYXRlbGxpdGUucmVtb3ZlSGFuZGxlcihzYXRlbGxpdGVMaXN0ZW4sIHRoaXMpOwogICAgICAgICAgICAgIGlmIChzYXRlbGxpdGVQZXJzb25hbExpc3Rlbikgb2xkU2F0ZWxsaXRlLnJlbW92ZUhhbmRsZXIoc2F0ZWxsaXRlUGVyc29uYWxMaXN0ZW4sIHRoaXMpOwogICAgICAgICAgICAgIG9sZFNhdGVsbGl0ZS5zZXRPd25lcihudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJlc2VydmVBdXRvICYmICFzYXRlbGxpdGUgJiYgYXV0b0NvbmZpZy5jb25maWcuaW5zdGFuY2UpIGF1dG9Db25maWcuY29uZmlnLmluc3RhbmNlLnNldE93bmVyID0gd2Fybk9uQXV0b1NhdGVsbGl0ZU93bmVyQ2hhbmdlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNhdGVsbGl0ZSkgewogICAgICAgICAgICBpZiAoc2F0ZWxsaXRlIGluc3RhbmNlb2YgQWJzdHJhY3ROb2RlID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgdmFyIGF1dG9Db25maWcgPSB7CiAgICAgICAgICAgICAgICBvd25lcjogdGhpcywKICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICBjb25maWc6IHNhdGVsbGl0ZSwKICAgICAgICAgICAgICAgIGluc3RhbmNlOiBudWxsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlLmhhbmRsZXIpIHRoaXMuYWRkSGFuZGxlcihzYXRlbGxpdGUuaGFuZGxlciwgYXV0b0NvbmZpZyk7CiAgICAgICAgICAgICAgaWYgKHNhdGVsbGl0ZS5pbnN0YW5jZSkgewogICAgICAgICAgICAgICAgc2F0ZWxsaXRlLmluc3RhbmNlLmFkZEhhbmRsZXIoQVVUT19TQVRFTExJVEVfSU5TVEFOQ0VfSEFORExFUiwgYXV0b0NvbmZpZyk7CiAgICAgICAgICAgICAgICBzYXRlbGxpdGUuaW5zdGFuY2Uuc2V0T3duZXIgPSB3YXJuT25BdXRvU2F0ZWxsaXRlT3duZXJDaGFuZ2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghYXV0bykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2F0ZWxsaXRlID09PSBOVUxMX1NBVEVMTElURSkgdGhpcy5zYXRlbGxpdGUgPSB7fTsKICAgICAgICAgICAgICAgIGF1dG8gPSB0aGlzLnNhdGVsbGl0ZS5fX2F1dG9fXyA9IHt9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhdXRvW25hbWVdID0gYXV0b0NvbmZpZzsKICAgICAgICAgICAgICBTQVRFTExJVEVfVVBEQVRFLmNhbGwoYXV0b0NvbmZpZywgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKCFhdXRvQ29uZmlnLmluc3RhbmNlICYmIG9sZFNhdGVsbGl0ZSkgdGhpcy5lbWl0X3NhdGVsbGl0ZUNoYW5nZWQobmFtZSwgb2xkU2F0ZWxsaXRlKTsKICAgICAgICAgICAgICBpZiAoZGVzdHJveVNhdGVsbGl0ZSkgewogICAgICAgICAgICAgICAgZGVsZXRlIGRlc3Ryb3lTYXRlbGxpdGUuZGVzdHJveTsKICAgICAgICAgICAgICAgIGRlc3Ryb3lTYXRlbGxpdGUuZGVzdHJveSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNhdGVsbGl0ZS5vd25lciAhPT0gdGhpcykgewogICAgICAgICAgICAgIGlmIChhdXRvQ29uZmlnICYmIGF1dG9Db25maWcuY29uZmlnLmRlbGVnYXRlKSB7CiAgICAgICAgICAgICAgICB2YXIgYXV0b0RlbGVnYXRlID0gc2F0ZWxsaXRlLmF1dG9EZWxlZ2F0ZTsKICAgICAgICAgICAgICAgIHNhdGVsbGl0ZS5hdXRvRGVsZWdhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHNhdGVsbGl0ZS5zZXRPd25lcih0aGlzKTsKICAgICAgICAgICAgICAgIHNhdGVsbGl0ZS5hdXRvRGVsZWdhdGUgPSBhdXRvRGVsZWdhdGU7CiAgICAgICAgICAgICAgfSBlbHNlIHNhdGVsbGl0ZS5zZXRPd25lcih0aGlzKTsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlLm93bmVyICE9PSB0aGlzKSByZXR1cm47CiAgICAgICAgICAgICAgaWYgKHNhdGVsbGl0ZUxpc3Rlbikgc2F0ZWxsaXRlLmFkZEhhbmRsZXIoc2F0ZWxsaXRlTGlzdGVuLCB0aGlzKTsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlUGVyc29uYWxMaXN0ZW4pIHNhdGVsbGl0ZS5hZGRIYW5kbGVyKHNhdGVsbGl0ZVBlcnNvbmFsTGlzdGVuLCB0aGlzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoc2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZSkgewogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuc2F0ZWxsaXRlW3NhdGVsbGl0ZS5vd25lclNhdGVsbGl0ZU5hbWVdOwogICAgICAgICAgICAgICAgdGhpcy5lbWl0X3NhdGVsbGl0ZUNoYW5nZWQoc2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZSwgc2F0ZWxsaXRlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc2F0ZWxsaXRlID09IE5VTExfU0FURUxMSVRFKSB0aGlzLnNhdGVsbGl0ZSA9IHt9OwogICAgICAgICAgICB0aGlzLnNhdGVsbGl0ZVtuYW1lXSA9IHNhdGVsbGl0ZTsKICAgICAgICAgICAgc2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmVtaXRfc2F0ZWxsaXRlQ2hhbmdlZChuYW1lLCBvbGRTYXRlbGxpdGUpOwogICAgICAgICAgaWYgKGRlc3Ryb3lTYXRlbGxpdGUpIHsKICAgICAgICAgICAgZGVsZXRlIGRlc3Ryb3lTYXRlbGxpdGUuZGVzdHJveTsKICAgICAgICAgICAgZGVzdHJveVNhdGVsbGl0ZS5kZXN0cm95KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBnZXRDaGlsZE5vZGVzRGF0YXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGNoaWxkTm9kZXNEYXRhc2V0TWFwW3RoaXMuYmFzaXNPYmplY3RJZF0gfHwgbmV3IENoaWxkTm9kZXNEYXRhc2V0KHsKICAgICAgICAgIHNvdXJjZU5vZGU6IHRoaXMKICAgICAgICB9KTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UgfHwgdGhpcy5kYXRhU291cmNlQWRhcHRlcl8pIHsKICAgICAgICAgIHRoaXMuc2V0RGF0YVNvdXJjZSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodGhpcy5maXJzdENoaWxkKSB0aGlzLmNsZWFyKCk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnBhcmVudE5vZGUpIHRoaXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzKTsKICAgICAgICBpZiAodGhpcy5ncm91cGluZykgewogICAgICAgICAgdGhpcy5ncm91cGluZy5zZXRPd25lcigpOwogICAgICAgICAgdGhpcy5ncm91cGluZyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLm93bmVyKSB0aGlzLnNldE93bmVyKCk7CiAgICAgICAgdmFyIHNhdGVsbGl0ZXMgPSB0aGlzLnNhdGVsbGl0ZTsKICAgICAgICBpZiAoc2F0ZWxsaXRlcyAhPT0gTlVMTF9TQVRFTExJVEUpIHsKICAgICAgICAgIHZhciBhdXRvID0gc2F0ZWxsaXRlcy5fX2F1dG9fXzsKICAgICAgICAgIGRlbGV0ZSBzYXRlbGxpdGVzLl9fYXV0b19fOwogICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBhdXRvKSBpZiAoYXV0b1tuYW1lXS5jb25maWcuaW5zdGFuY2UgJiYgIWF1dG9bbmFtZV0uaW5zdGFuY2UpIGF1dG9bbmFtZV0uY29uZmlnLmluc3RhbmNlLmRlc3Ryb3koKTsKICAgICAgICAgIGZvciAodmFyIG5hbWUgaW4gc2F0ZWxsaXRlcykgewogICAgICAgICAgICB2YXIgc2F0ZWxsaXRlID0gc2F0ZWxsaXRlc1tuYW1lXTsKICAgICAgICAgICAgc2F0ZWxsaXRlLm93bmVyID0gbnVsbDsKICAgICAgICAgICAgc2F0ZWxsaXRlLm93bmVyU2F0ZWxsaXRlTmFtZSA9IG51bGw7CiAgICAgICAgICAgIGlmIChzYXRlbGxpdGUuZGVzdHJveSA9PT0gd2Fybk9uQXV0b1NhdGVsbGl0ZURlc3RveSkgZGVsZXRlIHNhdGVsbGl0ZS5kZXN0cm95OwogICAgICAgICAgICBzYXRlbGxpdGUuZGVzdHJveSgpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5zYXRlbGxpdGUgPSBudWxsOwogICAgICAgIH0KICAgICAgICB0aGlzLmNoaWxkTm9kZXMgPSBudWxsOwogICAgICAgIHRoaXMucGFyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgdGhpcy5wcmV2aW91c1NpYmxpbmcgPSBudWxsOwogICAgICAgIHRoaXMubmV4dFNpYmxpbmcgPSBudWxsOwogICAgICAgIHRoaXMuZmlyc3RDaGlsZCA9IG51bGw7CiAgICAgICAgdGhpcy5sYXN0Q2hpbGQgPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBQYXJ0aXRpb25Ob2RlID0gQ2xhc3MoQWJzdHJhY3ROb2RlLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5QYXJ0aXRpb25Ob2RlIiwKICAgICAgYXV0b0Rlc3Ryb3lJZkVtcHR5OiBmYWxzZSwKICAgICAgbm9kZXM6IG51bGwsCiAgICAgIGZpcnN0OiBudWxsLAogICAgICBsYXN0OiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLm5vZGVzID0gW107CiAgICAgICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGluc2VydDogZnVuY3Rpb24obmV3Tm9kZSwgcmVmTm9kZSkgewogICAgICAgIHZhciBub2RlcyA9IHRoaXMubm9kZXM7CiAgICAgICAgdmFyIHBvcyA9IHJlZk5vZGUgPyBub2Rlcy5pbmRleE9mKHJlZk5vZGUpIDogLTE7CiAgICAgICAgaWYgKHBvcyA9PSAtMSkgewogICAgICAgICAgbm9kZXMucHVzaChuZXdOb2RlKTsKICAgICAgICAgIHRoaXMubGFzdCA9IG5ld05vZGU7CiAgICAgICAgfSBlbHNlIG5vZGVzLnNwbGljZShwb3MsIDAsIG5ld05vZGUpOwogICAgICAgIHRoaXMuZmlyc3QgPSBub2Rlc1swXTsKICAgICAgICBuZXdOb2RlLmdyb3VwTm9kZSA9IHRoaXM7CiAgICAgICAgdGhpcy5lbWl0X2NoaWxkTm9kZXNNb2RpZmllZCh7CiAgICAgICAgICBpbnNlcnRlZDogWyBuZXdOb2RlIF0KICAgICAgICB9KTsKICAgICAgfSwKICAgICAgcmVtb3ZlOiBmdW5jdGlvbihvbGROb2RlKSB7CiAgICAgICAgdmFyIG5vZGVzID0gdGhpcy5ub2RlczsKICAgICAgICBpZiAoYXJyYXlSZW1vdmUobm9kZXMsIG9sZE5vZGUpKSB7CiAgICAgICAgICB0aGlzLmZpcnN0ID0gbm9kZXNbMF0gfHwgbnVsbDsKICAgICAgICAgIHRoaXMubGFzdCA9IG5vZGVzW25vZGVzLmxlbmd0aCAtIDFdIHx8IG51bGw7CiAgICAgICAgICBvbGROb2RlLmdyb3VwTm9kZSA9IG51bGw7CiAgICAgICAgICB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKHsKICAgICAgICAgICAgZGVsZXRlZDogWyBvbGROb2RlIF0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuZmlyc3QgJiYgdGhpcy5hdXRvRGVzdHJveUlmRW1wdHkpIHRoaXMuZGVzdHJveSgpOwogICAgICB9LAogICAgICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLmZpcnN0KSByZXR1cm47CiAgICAgICAgdmFyIG5vZGVzID0gdGhpcy5ub2RlczsKICAgICAgICBmb3IgKHZhciBpID0gbm9kZXMubGVuZ3RoOyBpLS0gPiAwOyApIG5vZGVzW2ldLmdyb3VwTm9kZSA9IG51bGw7CiAgICAgICAgdGhpcy5ub2RlcyA9IFtdOwogICAgICAgIHRoaXMuZmlyc3QgPSBudWxsOwogICAgICAgIHRoaXMubGFzdCA9IG51bGw7CiAgICAgICAgdGhpcy5lbWl0X2NoaWxkTm9kZXNNb2RpZmllZCh7CiAgICAgICAgICBkZWxldGVkOiBub2RlcwogICAgICAgIH0pOwogICAgICAgIGlmICh0aGlzLmF1dG9EZXN0cm95SWZFbXB0eSkgdGhpcy5kZXN0cm95KCk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIEFic3RyYWN0Tm9kZS5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMubm9kZXMgPSBudWxsOwogICAgICAgIHRoaXMuZmlyc3QgPSBudWxsOwogICAgICAgIHRoaXMubGFzdCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIERPTU1JWElOX0RBVEFTT1VSQ0VfSEFORExFUiA9IHsKICAgICAgaXRlbXNDaGFuZ2VkOiBmdW5jdGlvbihkYXRhU291cmNlLCBkZWx0YSkgewogICAgICAgIHZhciBuZXdEZWx0YSA9IHt9OwogICAgICAgIHZhciBkZWxldGVkID0gW107CiAgICAgICAgaWYgKGRlbHRhLmRlbGV0ZWQpIHsKICAgICAgICAgIG5ld0RlbHRhLmRlbGV0ZWQgPSBkZWxldGVkOwogICAgICAgICAgaWYgKHRoaXMuY2hpbGROb2Rlcy5sZW5ndGggPT0gZGVsdGEuZGVsZXRlZC5sZW5ndGgpIHsKICAgICAgICAgICAgZGVsZXRlZCA9IGFycmF5RnJvbSh0aGlzLmNoaWxkTm9kZXMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gZGVsZXRlZFtpXTsgaSsrKSB1bmxvY2tEYXRhU291cmNlSXRlbU5vZGUoY2hpbGQpOwogICAgICAgICAgICB2YXIgdG1wID0gdGhpcy5kYXRhU291cmNlOwogICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2UgPSBudWxsOwogICAgICAgICAgICB0aGlzLmNsZWFyKHRydWUpOwogICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2UgPSB0bXA7CiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZU1hcF8gPSB7fTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gZGVsdGEuZGVsZXRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGRlbGVnYXRlSWQgPSBpdGVtLmJhc2lzT2JqZWN0SWQ7CiAgICAgICAgICAgICAgdmFyIG9sZENoaWxkID0gdGhpcy5kYXRhU291cmNlTWFwX1tkZWxlZ2F0ZUlkXTsKICAgICAgICAgICAgICB1bmxvY2tEYXRhU291cmNlSXRlbU5vZGUob2xkQ2hpbGQpOwogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmRhdGFTb3VyY2VNYXBfW2RlbGVnYXRlSWRdOwogICAgICAgICAgICAgIHRoaXMucmVtb3ZlQ2hpbGQob2xkQ2hpbGQpOwogICAgICAgICAgICAgIGRlbGV0ZWQucHVzaChvbGRDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhLmluc2VydGVkKSB7CiAgICAgICAgICBuZXdEZWx0YS5pbnNlcnRlZCA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBkZWx0YS5pbnNlcnRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZUNoaWxkQnlGYWN0b3J5KHRoaXMsIHsKICAgICAgICAgICAgICBkZWxlZ2F0ZTogaXRlbQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgbG9ja0RhdGFTb3VyY2VJdGVtTm9kZShuZXdDaGlsZCk7CiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZU1hcF9baXRlbS5iYXNpc09iamVjdElkXSA9IG5ld0NoaWxkOwogICAgICAgICAgICBuZXdEZWx0YS5pbnNlcnRlZC5wdXNoKG5ld0NoaWxkKTsKICAgICAgICAgICAgaWYgKHRoaXMuZmlyc3RDaGlsZCkgdGhpcy5pbnNlcnRCZWZvcmUobmV3Q2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIXRoaXMuZmlyc3RDaGlsZCkgdGhpcy5zZXRDaGlsZE5vZGVzKG5ld0RlbHRhLmluc2VydGVkKTsgZWxzZSB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKG5ld0RlbHRhKTsKICAgICAgICBpZiAodGhpcy5kZXN0cm95RGF0YVNvdXJjZU1lbWJlciAmJiBkZWxldGVkLmxlbmd0aCkgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBkZWxldGVkW2ldOyBpKyspIGl0ZW0uZGVzdHJveSgpOwogICAgICB9LAogICAgICBzdGF0ZUNoYW5nZWQ6IGZ1bmN0aW9uKGRhdGFTb3VyY2UpIHsKICAgICAgICB0aGlzLnNldENoaWxkTm9kZXNTdGF0ZShkYXRhU291cmNlLnN0YXRlLCBkYXRhU291cmNlLnN0YXRlLmRhdGEpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbihkYXRhU291cmNlKSB7CiAgICAgICAgaWYgKCF0aGlzLmRhdGFTb3VyY2VBZGFwdGVyXykgdGhpcy5zZXREYXRhU291cmNlKCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgTUlYSU5fREFUQVNPVVJDRV9XUkFQUEVSX0hBTkRMRVIgPSB7CiAgICAgIGRhdGFzZXRDaGFuZ2VkOiBmdW5jdGlvbih3cmFwcGVyKSB7CiAgICAgICAgdGhpcy5zZXREYXRhU291cmNlKHdyYXBwZXIpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnNldERhdGFTb3VyY2UoKTsKICAgICAgfQogICAgfTsKICAgIGZ1bmN0aW9uIGZhc3RDaGlsZE5vZGVzT3JkZXIobm9kZSwgb3JkZXIpIHsKICAgICAgdmFyIGxhc3RJbmRleCA9IG9yZGVyLmxlbmd0aCAtIDE7CiAgICAgIG5vZGUuY2hpbGROb2RlcyA9IG9yZGVyOwogICAgICBub2RlLmZpcnN0Q2hpbGQgPSBvcmRlclswXSB8fCBudWxsOwogICAgICBub2RlLmxhc3RDaGlsZCA9IG9yZGVyW2xhc3RJbmRleF0gfHwgbnVsbDsKICAgICAgZm9yICh2YXIgb3JkZXJOb2RlLCBpID0gbGFzdEluZGV4OyBvcmRlck5vZGUgPSBvcmRlcltpXTsgaS0tKSB7CiAgICAgICAgb3JkZXJOb2RlLm5leHRTaWJsaW5nID0gb3JkZXJbaSArIDFdIHx8IG51bGw7CiAgICAgICAgb3JkZXJOb2RlLnByZXZpb3VzU2libGluZyA9IG9yZGVyW2kgLSAxXSB8fCBudWxsOwogICAgICAgIG5vZGUuaW5zZXJ0QmVmb3JlKG9yZGVyTm9kZSwgb3JkZXJOb2RlLm5leHRTaWJsaW5nKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZmFzdENoaWxkTm9kZXNHcm91cE9yZGVyKG5vZGUsIG9yZGVyKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBvcmRlcltpXTsgaSsrKSBjaGlsZC5ncm91cE5vZGUubm9kZXMucHVzaChjaGlsZCk7CiAgICAgIG9yZGVyLmxlbmd0aCA9IDA7CiAgICAgIGZvciAodmFyIGdyb3VwID0gbm9kZS5ncm91cGluZy5udWxsR3JvdXA7IGdyb3VwOyBncm91cCA9IGdyb3VwLm5leHRTaWJsaW5nKSB7CiAgICAgICAgdmFyIG5vZGVzID0gZ3JvdXAubm9kZXM7CiAgICAgICAgZ3JvdXAuZmlyc3QgPSBub2Rlc1swXSB8fCBudWxsOwogICAgICAgIGdyb3VwLmxhc3QgPSBub2Rlc1tub2Rlcy5sZW5ndGggLSAxXSB8fCBudWxsOwogICAgICAgIG9yZGVyLnB1c2guYXBwbHkob3JkZXIsIG5vZGVzKTsKICAgICAgICBncm91cC5lbWl0X2NoaWxkTm9kZXNNb2RpZmllZCh7CiAgICAgICAgICBpbnNlcnRlZDogbm9kZXMKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gb3JkZXI7CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVDaGlsZEJ5RmFjdG9yeShub2RlLCBjb25maWcpIHsKICAgICAgdmFyIGNoaWxkOwogICAgICBpZiAodHlwZW9mIG5vZGUuY2hpbGRGYWN0b3J5ID09ICJmdW5jdGlvbiIpIHsKICAgICAgICBjaGlsZCA9IG5vZGUuY2hpbGRGYWN0b3J5KGNvbmZpZyk7CiAgICAgICAgaWYgKGNoaWxkIGluc3RhbmNlb2Ygbm9kZS5jaGlsZENsYXNzKSByZXR1cm4gY2hpbGQ7CiAgICAgIH0KICAgICAgaWYgKCFjaGlsZCkgdGhyb3cgRVhDRVBUSU9OX05VTExfQ0hJTEQ7CiAgICAgIGJhc2lzLmRldi53YXJuKEVYQ0VQVElPTl9CQURfQ0hJTERfQ0xBU1MgKyAiIChleHBlY3RlZCAiICsgKG5vZGUuY2hpbGRDbGFzcyAmJiBub2RlLmNoaWxkQ2xhc3MuY2xhc3NOYW1lKSArICIgYnV0ICIgKyAoY2hpbGQgJiYgY2hpbGQuY29uc3RydWN0b3IgJiYgY2hpbGQuY29uc3RydWN0b3IuY2xhc3NOYW1lKSArICIpIik7CiAgICAgIHRocm93IEVYQ0VQVElPTl9CQURfQ0hJTERfQ0xBU1M7CiAgICB9CiAgICB2YXIgRG9tTWl4aW4gPSB7CiAgICAgIGNoaWxkQ2xhc3M6IEFic3RyYWN0Tm9kZSwKICAgICAgY2hpbGRGYWN0b3J5OiBudWxsLAogICAgICBsaXN0ZW46IHsKICAgICAgICBkYXRhU291cmNlOiBET01NSVhJTl9EQVRBU09VUkNFX0hBTkRMRVIKICAgICAgfSwKICAgICAgZ2V0Q2hpbGQ6IGZ1bmN0aW9uKHZhbHVlLCBnZXR0ZXIpIHsKICAgICAgICByZXR1cm4gYmFzaXMuYXJyYXkuc2VhcmNoKHRoaXMuY2hpbGROb2RlcywgdmFsdWUsIGdldHRlcik7CiAgICAgIH0sCiAgICAgIGdldENoaWxkQnlOYW1lOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q2hpbGQobmFtZSwgIm5hbWUiKTsKICAgICAgfSwKICAgICAgYXBwZW5kQ2hpbGQ6IGZ1bmN0aW9uKG5ld0NoaWxkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5zZXJ0QmVmb3JlKG5ld0NoaWxkKTsKICAgICAgfSwKICAgICAgaW5zZXJ0QmVmb3JlOiBmdW5jdGlvbihuZXdDaGlsZCwgcmVmQ2hpbGQpIHsKICAgICAgICBpZiAoIXRoaXMuY2hpbGRDbGFzcykgdGhyb3cgRVhDRVBUSU9OX05PX0NISUxEQ0xBU1M7CiAgICAgICAgaWYgKG5ld0NoaWxkLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgIGlmIChjdXJzb3IgPT09IG5ld0NoaWxkKSB0aHJvdyBFWENFUFRJT05fQ0FOVF9JTlNFUlQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0NoaWxkQ2xhc3NJbnN0YW5jZSA9IG5ld0NoaWxkICYmIG5ld0NoaWxkIGluc3RhbmNlb2YgdGhpcy5jaGlsZENsYXNzOwogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UpIHsKICAgICAgICAgIGlmICghaXNDaGlsZENsYXNzSW5zdGFuY2UgfHwgIW5ld0NoaWxkLmRlbGVnYXRlIHx8IHRoaXMuZGF0YVNvdXJjZU1hcF9bbmV3Q2hpbGQuZGVsZWdhdGUuYmFzaXNPYmplY3RJZF0gIT09IG5ld0NoaWxkKSB0aHJvdyBFWENFUFRJT05fREFUQVNPVVJDRV9DT05GTElDVDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZUFkYXB0ZXJfKSB0aHJvdyBFWENFUFRJT05fREFUQVNPVVJDRUFEQVBURVJfQ09ORkxJQ1Q7CiAgICAgICAgfQogICAgICAgIGlmICghaXNDaGlsZENsYXNzSW5zdGFuY2UpIG5ld0NoaWxkID0gY3JlYXRlQ2hpbGRCeUZhY3RvcnkodGhpcywgbmV3Q2hpbGQgaW5zdGFuY2VvZiBEYXRhT2JqZWN0ID8gewogICAgICAgICAgZGVsZWdhdGU6IG5ld0NoaWxkCiAgICAgICAgfSA6IG5ld0NoaWxkKTsKICAgICAgICBpZiAobmV3Q2hpbGQub3duZXIpIHRocm93IEVYQ0VQVElPTl9QQVJFTlROT0RFX09XTkVSX0NPTkZMSUNUOwogICAgICAgIHZhciBpc0luc2lkZSA9IG5ld0NoaWxkLnBhcmVudE5vZGUgPT09IHRoaXM7CiAgICAgICAgdmFyIGNoaWxkTm9kZXMgPSB0aGlzLmNoaWxkTm9kZXM7CiAgICAgICAgdmFyIGdyb3VwaW5nID0gdGhpcy5ncm91cGluZzsKICAgICAgICB2YXIgZ3JvdXBOb2RlczsKICAgICAgICB2YXIgY3VycmVudE5ld0NoaWxkR3JvdXAgPSBuZXdDaGlsZC5ncm91cE5vZGU7CiAgICAgICAgdmFyIGdyb3VwID0gbnVsbDsKICAgICAgICB2YXIgc29ydGluZyA9IHRoaXMuc29ydGluZzsKICAgICAgICB2YXIgc29ydGluZ0Rlc2M7CiAgICAgICAgdmFyIGNvcnJlY3RTb3J0UG9zID0gZmFsc2U7CiAgICAgICAgdmFyIG5ld0NoaWxkVmFsdWU7CiAgICAgICAgdmFyIHBvcyA9IC0xOwogICAgICAgIHZhciBuZXh0U2libGluZzsKICAgICAgICB2YXIgcHJldlNpYmxpbmc7CiAgICAgICAgaWYgKGlzSW5zaWRlKSB7CiAgICAgICAgICBuZXh0U2libGluZyA9IG5ld0NoaWxkLm5leHRTaWJsaW5nOwogICAgICAgICAgcHJldlNpYmxpbmcgPSBuZXdDaGlsZC5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgfQogICAgICAgIGlmIChzb3J0aW5nICE9PSBudWxsR2V0dGVyKSB7CiAgICAgICAgICByZWZDaGlsZCA9IG51bGw7CiAgICAgICAgICBzb3J0aW5nRGVzYyA9IHRoaXMuc29ydGluZ0Rlc2M7CiAgICAgICAgICBuZXdDaGlsZFZhbHVlID0gc29ydGluZyhuZXdDaGlsZCkgfHwgMDsKICAgICAgICAgIGlmIChpc0luc2lkZSkgewogICAgICAgICAgICBpZiAobmV3Q2hpbGRWYWx1ZSA9PT0gbmV3Q2hpbGQuc29ydGluZ1ZhbHVlKSB7CiAgICAgICAgICAgICAgY29ycmVjdFNvcnRQb3MgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICgoIW5leHRTaWJsaW5nIHx8IChzb3J0aW5nRGVzYyA/IG5leHRTaWJsaW5nLnNvcnRpbmdWYWx1ZSA8PSBuZXdDaGlsZFZhbHVlIDogbmV4dFNpYmxpbmcuc29ydGluZ1ZhbHVlID49IG5ld0NoaWxkVmFsdWUpKSAmJiAoIXByZXZTaWJsaW5nIHx8IChzb3J0aW5nRGVzYyA/IHByZXZTaWJsaW5nLnNvcnRpbmdWYWx1ZSA+PSBuZXdDaGlsZFZhbHVlIDogcHJldlNpYmxpbmcuc29ydGluZ1ZhbHVlIDw9IG5ld0NoaWxkVmFsdWUpKSkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGQuc29ydGluZ1ZhbHVlID0gbmV3Q2hpbGRWYWx1ZTsKICAgICAgICAgICAgICAgIGNvcnJlY3RTb3J0UG9zID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGdyb3VwaW5nKSB7CiAgICAgICAgICB2YXIgY3Vyc29yOwogICAgICAgICAgZ3JvdXAgPSBncm91cGluZy5nZXRHcm91cE5vZGUobmV3Q2hpbGQsIHRydWUpOwogICAgICAgICAgZ3JvdXBOb2RlcyA9IGdyb3VwLm5vZGVzOwogICAgICAgICAgaWYgKGN1cnJlbnROZXdDaGlsZEdyb3VwID09PSBncm91cCkgaWYgKGNvcnJlY3RTb3J0UG9zIHx8IHNvcnRpbmcgPT09IG51bGxHZXR0ZXIgJiYgbmV4dFNpYmxpbmcgPT09IHJlZkNoaWxkKSByZXR1cm4gbmV3Q2hpbGQ7CiAgICAgICAgICBpZiAoc29ydGluZyAhPT0gbnVsbEdldHRlcikgewogICAgICAgICAgICBpZiAoY3VycmVudE5ld0NoaWxkR3JvdXAgPT09IGdyb3VwICYmIGNvcnJlY3RTb3J0UG9zKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRTaWJsaW5nICYmIG5leHRTaWJsaW5nLmdyb3VwTm9kZSA9PT0gZ3JvdXApIHBvcyA9IGdyb3VwTm9kZXMuaW5kZXhPZihuZXh0U2libGluZyk7IGVsc2UgcG9zID0gZ3JvdXBOb2Rlcy5sZW5ndGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcG9zID0gYmluYXJ5U2VhcmNoUG9zKGdyb3VwTm9kZXMsIG5ld0NoaWxkVmFsdWUsIHNvcnRpbmdTZWFyY2gsIHNvcnRpbmdEZXNjKTsKICAgICAgICAgICAgICBuZXdDaGlsZC5zb3J0aW5nVmFsdWUgPSBuZXdDaGlsZFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAocmVmQ2hpbGQgJiYgcmVmQ2hpbGQuZ3JvdXBOb2RlID09PSBncm91cCkgcG9zID0gZ3JvdXBOb2Rlcy5pbmRleE9mKHJlZkNoaWxkKTsgZWxzZSBwb3MgPSBncm91cE5vZGVzLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwb3MgPCBncm91cE5vZGVzLmxlbmd0aCkgewogICAgICAgICAgICByZWZDaGlsZCA9IGdyb3VwTm9kZXNbcG9zXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChncm91cC5sYXN0KSB7CiAgICAgICAgICAgICAgcmVmQ2hpbGQgPSBncm91cC5sYXN0Lm5leHRTaWJsaW5nOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGN1cnNvciA9IGdyb3VwOwogICAgICAgICAgICAgIHJlZkNoaWxkID0gbnVsbDsKICAgICAgICAgICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLm5leHRTaWJsaW5nKSBpZiAocmVmQ2hpbGQgPSBjdXJzb3IuZmlyc3QpIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmV3Q2hpbGQgPT09IHJlZkNoaWxkIHx8IGlzSW5zaWRlICYmIG5leHRTaWJsaW5nID09PSByZWZDaGlsZCkgewogICAgICAgICAgICBpZiAoY3VycmVudE5ld0NoaWxkR3JvdXAgIT09IGdyb3VwKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnROZXdDaGlsZEdyb3VwKSBjdXJyZW50TmV3Q2hpbGRHcm91cC5yZW1vdmUobmV3Q2hpbGQpOwogICAgICAgICAgICAgIGdyb3VwLmluc2VydChuZXdDaGlsZCwgcmVmQ2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHBvcyA9IC0xOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoc29ydGluZyAhPT0gbnVsbEdldHRlcikgewogICAgICAgICAgICBpZiAoY29ycmVjdFNvcnRQb3MpIHJldHVybiBuZXdDaGlsZDsKICAgICAgICAgICAgcG9zID0gYmluYXJ5U2VhcmNoUG9zKGNoaWxkTm9kZXMsIG5ld0NoaWxkVmFsdWUsIHNvcnRpbmdTZWFyY2gsIHNvcnRpbmdEZXNjKTsKICAgICAgICAgICAgcmVmQ2hpbGQgPSBjaGlsZE5vZGVzW3Bvc107CiAgICAgICAgICAgIG5ld0NoaWxkLnNvcnRpbmdWYWx1ZSA9IG5ld0NoaWxkVmFsdWU7CiAgICAgICAgICAgIGlmIChuZXdDaGlsZCA9PT0gcmVmQ2hpbGQgfHwgaXNJbnNpZGUgJiYgbmV4dFNpYmxpbmcgPT09IHJlZkNoaWxkKSByZXR1cm4gbmV3Q2hpbGQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAocmVmQ2hpbGQgJiYgcmVmQ2hpbGQucGFyZW50Tm9kZSAhPT0gdGhpcykgdGhyb3cgRVhDRVBUSU9OX05PREVfTk9UX0ZPVU5EOwogICAgICAgICAgICBpZiAoaXNJbnNpZGUpIHsKICAgICAgICAgICAgICBpZiAobmV4dFNpYmxpbmcgPT09IHJlZkNoaWxkKSByZXR1cm4gbmV3Q2hpbGQ7CiAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkID09PSByZWZDaGlsZCkgdGhyb3cgRVhDRVBUSU9OX0NBTlRfSU5TRVJUOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpc0luc2lkZSkgewogICAgICAgICAgaWYgKG5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgIG5leHRTaWJsaW5nLnByZXZpb3VzU2libGluZyA9IHByZXZTaWJsaW5nOwogICAgICAgICAgICBuZXdDaGlsZC5uZXh0U2libGluZyA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgdGhpcy5sYXN0Q2hpbGQgPSBwcmV2U2libGluZzsKICAgICAgICAgIGlmIChwcmV2U2libGluZykgewogICAgICAgICAgICBwcmV2U2libGluZy5uZXh0U2libGluZyA9IG5leHRTaWJsaW5nOwogICAgICAgICAgICBuZXdDaGlsZC5wcmV2aW91c1NpYmxpbmcgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHRoaXMuZmlyc3RDaGlsZCA9IG5leHRTaWJsaW5nOwogICAgICAgICAgaWYgKHBvcyA9PSAtMSkgYXJyYXlSZW1vdmUoY2hpbGROb2RlcywgbmV3Q2hpbGQpOyBlbHNlIHsKICAgICAgICAgICAgdmFyIG9sZFBvcyA9IGNoaWxkTm9kZXMuaW5kZXhPZihuZXdDaGlsZCk7CiAgICAgICAgICAgIGNoaWxkTm9kZXMuc3BsaWNlKG9sZFBvcywgMSk7CiAgICAgICAgICAgIHBvcyAtPSBvbGRQb3MgPCBwb3M7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudE5ld0NoaWxkR3JvdXApIHsKICAgICAgICAgICAgY3VycmVudE5ld0NoaWxkR3JvdXAucmVtb3ZlKG5ld0NoaWxkKTsKICAgICAgICAgICAgY3VycmVudE5ld0NoaWxkR3JvdXAgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAobmV3Q2hpbGQucGFyZW50Tm9kZSkgbmV3Q2hpbGQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuZXdDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGlmIChjdXJyZW50TmV3Q2hpbGRHcm91cCAhPSBncm91cCkgZ3JvdXAuaW5zZXJ0KG5ld0NoaWxkLCByZWZDaGlsZCk7CiAgICAgICAgaWYgKHJlZkNoaWxkKSB7CiAgICAgICAgICBpZiAocG9zID09IC0xKSBwb3MgPSBjaGlsZE5vZGVzLmluZGV4T2YocmVmQ2hpbGQpOwogICAgICAgICAgaWYgKHBvcyA9PSAtMSkgdGhyb3cgRVhDRVBUSU9OX05PREVfTk9UX0ZPVU5EOwogICAgICAgICAgbmV3Q2hpbGQubmV4dFNpYmxpbmcgPSByZWZDaGlsZDsKICAgICAgICAgIGNoaWxkTm9kZXMuc3BsaWNlKHBvcywgMCwgbmV3Q2hpbGQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwb3MgPSBjaGlsZE5vZGVzLmxlbmd0aDsKICAgICAgICAgIGNoaWxkTm9kZXMucHVzaChuZXdDaGlsZCk7CiAgICAgICAgICByZWZDaGlsZCA9IHsKICAgICAgICAgICAgcHJldmlvdXNTaWJsaW5nOiB0aGlzLmxhc3RDaGlsZAogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMubGFzdENoaWxkID0gbmV3Q2hpbGQ7CiAgICAgICAgfQogICAgICAgIG5ld0NoaWxkLnBhcmVudE5vZGUgPSB0aGlzOwogICAgICAgIG5ld0NoaWxkLnByZXZpb3VzU2libGluZyA9IHJlZkNoaWxkLnByZXZpb3VzU2libGluZzsKICAgICAgICBpZiAocG9zID09IDApIHRoaXMuZmlyc3RDaGlsZCA9IG5ld0NoaWxkOyBlbHNlIHJlZkNoaWxkLnByZXZpb3VzU2libGluZy5uZXh0U2libGluZyA9IG5ld0NoaWxkOwogICAgICAgIHJlZkNoaWxkLnByZXZpb3VzU2libGluZyA9IG5ld0NoaWxkOwogICAgICAgIGlmICghaXNJbnNpZGUpIHsKICAgICAgICAgIHVwZGF0ZU5vZGVDb250ZXh0U2VsZWN0aW9uKG5ld0NoaWxkLCBuZXdDaGlsZC5jb250ZXh0U2VsZWN0aW9uLCB0aGlzLnNlbGVjdGlvbiB8fCB0aGlzLmNvbnRleHRTZWxlY3Rpb24sIHRydWUpOwogICAgICAgICAgdXBkYXRlTm9kZURpc2FibGVDb250ZXh0KG5ld0NoaWxkLCB0aGlzLmRpc2FibGVkIHx8IHRoaXMuY29udGV4dERpc2FibGVkKTsKICAgICAgICAgIGlmICgobmV3Q2hpbGQudW5kZXJNYXRjaF8gfHwgdGhpcy5tYXRjaEZ1bmN0aW9uKSAmJiBuZXdDaGlsZC5tYXRjaCkgbmV3Q2hpbGQubWF0Y2godGhpcy5tYXRjaEZ1bmN0aW9uKTsKICAgICAgICAgIGlmIChuZXdDaGlsZC5hdXRvRGVsZWdhdGUgPT0gREVMRUdBVEUuUEFSRU5UIHx8IG5ld0NoaWxkLmF1dG9EZWxlZ2F0ZSA9PT0gREVMRUdBVEUuQU5ZKSBuZXdDaGlsZC5zZXREZWxlZ2F0ZSh0aGlzKTsKICAgICAgICAgIGlmICghdGhpcy5kYXRhU291cmNlKSB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKHsKICAgICAgICAgICAgaW5zZXJ0ZWQ6IFsgbmV3Q2hpbGQgXQogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAobmV3Q2hpbGQubGlzdGVuLnBhcmVudE5vZGUpIHRoaXMuYWRkSGFuZGxlcihuZXdDaGlsZC5saXN0ZW4ucGFyZW50Tm9kZSwgbmV3Q2hpbGQpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3Q2hpbGQ7CiAgICAgIH0sCiAgICAgIHJlbW92ZUNoaWxkOiBmdW5jdGlvbihvbGRDaGlsZCkgewogICAgICAgIGlmICghb2xkQ2hpbGQgfHwgb2xkQ2hpbGQucGFyZW50Tm9kZSAhPT0gdGhpcykgdGhyb3cgRVhDRVBUSU9OX05PREVfTk9UX0ZPVU5EOwogICAgICAgIGlmIChvbGRDaGlsZCBpbnN0YW5jZW9mIHRoaXMuY2hpbGRDbGFzcyA9PSBmYWxzZSkgdGhyb3cgRVhDRVBUSU9OX0JBRF9DSElMRF9DTEFTUzsKICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlKSB7CiAgICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlLmhhcyhvbGRDaGlsZC5kZWxlZ2F0ZSkpIHRocm93IEVYQ0VQVElPTl9EQVRBU09VUkNFX0NPTkZMSUNUOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlQWRhcHRlcl8pIHRocm93IEVYQ0VQVElPTl9EQVRBU09VUkNFQURBUFRFUl9DT05GTElDVDsKICAgICAgICB9CiAgICAgICAgdmFyIHBvcyA9IHRoaXMuY2hpbGROb2Rlcy5pbmRleE9mKG9sZENoaWxkKTsKICAgICAgICBpZiAocG9zID09IC0xKSB0aHJvdyBFWENFUFRJT05fTk9ERV9OT1RfRk9VTkQ7CiAgICAgICAgdGhpcy5jaGlsZE5vZGVzLnNwbGljZShwb3MsIDEpOwogICAgICAgIG9sZENoaWxkLnBhcmVudE5vZGUgPSBudWxsOwogICAgICAgIGlmIChvbGRDaGlsZC5uZXh0U2libGluZykgb2xkQ2hpbGQubmV4dFNpYmxpbmcucHJldmlvdXNTaWJsaW5nID0gb2xkQ2hpbGQucHJldmlvdXNTaWJsaW5nOyBlbHNlIHRoaXMubGFzdENoaWxkID0gb2xkQ2hpbGQucHJldmlvdXNTaWJsaW5nOwogICAgICAgIGlmIChvbGRDaGlsZC5wcmV2aW91c1NpYmxpbmcpIG9sZENoaWxkLnByZXZpb3VzU2libGluZy5uZXh0U2libGluZyA9IG9sZENoaWxkLm5leHRTaWJsaW5nOyBlbHNlIHRoaXMuZmlyc3RDaGlsZCA9IG9sZENoaWxkLm5leHRTaWJsaW5nOwogICAgICAgIG9sZENoaWxkLm5leHRTaWJsaW5nID0gbnVsbDsKICAgICAgICBvbGRDaGlsZC5wcmV2aW91c1NpYmxpbmcgPSBudWxsOwogICAgICAgIGlmIChvbGRDaGlsZC5saXN0ZW4ucGFyZW50Tm9kZSkgdGhpcy5yZW1vdmVIYW5kbGVyKG9sZENoaWxkLmxpc3Rlbi5wYXJlbnROb2RlLCBvbGRDaGlsZCk7CiAgICAgICAgdXBkYXRlTm9kZUNvbnRleHRTZWxlY3Rpb24ob2xkQ2hpbGQsIG9sZENoaWxkLmNvbnRleHRTZWxlY3Rpb24sIG51bGwsIHRydWUpOwogICAgICAgIGlmIChvbGRDaGlsZC5ncm91cE5vZGUpIG9sZENoaWxkLmdyb3VwTm9kZS5yZW1vdmUob2xkQ2hpbGQpOwogICAgICAgIGlmICghdGhpcy5kYXRhU291cmNlKSB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkKHsKICAgICAgICAgIGRlbGV0ZWQ6IFsgb2xkQ2hpbGQgXQogICAgICAgIH0pOwogICAgICAgIGlmIChvbGRDaGlsZC5hdXRvRGVsZWdhdGUgPT0gREVMRUdBVEUuUEFSRU5UIHx8IG9sZENoaWxkLmF1dG9EZWxlZ2F0ZSA9PT0gREVMRUdBVEUuQU5ZKSBvbGRDaGlsZC5zZXREZWxlZ2F0ZSgpOwogICAgICAgIHJldHVybiBvbGRDaGlsZDsKICAgICAgfSwKICAgICAgcmVwbGFjZUNoaWxkOiBmdW5jdGlvbihuZXdDaGlsZCwgb2xkQ2hpbGQpIHsKICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlKSB0aHJvdyBFWENFUFRJT05fREFUQVNPVVJDRV9DT05GTElDVDsKICAgICAgICBpZiAodGhpcy5kYXRhU291cmNlQWRhcHRlcl8pIHRocm93IEVYQ0VQVElPTl9EQVRBU09VUkNFQURBUFRFUl9DT05GTElDVDsKICAgICAgICBpZiAob2xkQ2hpbGQgPT0gbnVsbCB8fCBvbGRDaGlsZC5wYXJlbnROb2RlICE9PSB0aGlzKSB0aHJvdyBFWENFUFRJT05fTk9ERV9OT1RfRk9VTkQ7CiAgICAgICAgdGhpcy5pbnNlcnRCZWZvcmUobmV3Q2hpbGQsIG9sZENoaWxkKTsKICAgICAgICByZXR1cm4gdGhpcy5yZW1vdmVDaGlsZChvbGRDaGlsZCk7CiAgICAgIH0sCiAgICAgIGNsZWFyOiBmdW5jdGlvbihhbGl2ZSkgewogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UgJiYgdGhpcy5kYXRhU291cmNlLml0ZW1Db3VudCkgdGhyb3cgRVhDRVBUSU9OX0RBVEFTT1VSQ0VfQ09ORkxJQ1Q7CiAgICAgICAgaWYgKCF0aGlzLmZpcnN0Q2hpbGQpIHJldHVybjsKICAgICAgICBpZiAoYWxpdmUpIHVwZGF0ZU5vZGVDb250ZXh0U2VsZWN0aW9uKHRoaXMsIHRoaXMuc2VsZWN0aW9uIHx8IHRoaXMuY29udGV4dFNlbGVjdGlvbiwgbnVsbCwgZmFsc2UsIHRydWUpOwogICAgICAgIHZhciBjaGlsZE5vZGVzID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgIHRoaXMuZmlyc3RDaGlsZCA9IG51bGw7CiAgICAgICAgdGhpcy5sYXN0Q2hpbGQgPSBudWxsOwogICAgICAgIHRoaXMuY2hpbGROb2RlcyA9IFtdOwogICAgICAgIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQoewogICAgICAgICAgZGVsZXRlZDogY2hpbGROb2RlcwogICAgICAgIH0pOwogICAgICAgIGZvciAodmFyIGkgPSBjaGlsZE5vZGVzLmxlbmd0aDsgaS0tID4gMDsgKSB7CiAgICAgICAgICB2YXIgY2hpbGQgPSBjaGlsZE5vZGVzW2ldOwogICAgICAgICAgaWYgKGNoaWxkLmxpc3Rlbi5wYXJlbnROb2RlKSBjaGlsZC5wYXJlbnROb2RlLnJlbW92ZUhhbmRsZXIoY2hpbGQubGlzdGVuLnBhcmVudE5vZGUsIGNoaWxkKTsKICAgICAgICAgIGNoaWxkLnBhcmVudE5vZGUgPSBudWxsOwogICAgICAgICAgY2hpbGQuZ3JvdXBOb2RlID0gbnVsbDsKICAgICAgICAgIGlmIChhbGl2ZSkgewogICAgICAgICAgICBjaGlsZC5uZXh0U2libGluZyA9IG51bGw7CiAgICAgICAgICAgIGNoaWxkLnByZXZpb3VzU2libGluZyA9IG51bGw7CiAgICAgICAgICAgIGlmIChjaGlsZC5hdXRvRGVsZWdhdGUgPT0gREVMRUdBVEUuUEFSRU5UIHx8IGNoaWxkLmF1dG9EZWxlZ2F0ZSA9PT0gREVMRUdBVEUuQU5ZKSBjaGlsZC5zZXREZWxlZ2F0ZSgpOwogICAgICAgICAgfSBlbHNlIGNoaWxkLmRlc3Ryb3koKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuZ3JvdXBpbmcpIHsKICAgICAgICAgIGZvciAodmFyIGNoaWxkTm9kZXMgPSB0aGlzLmdyb3VwaW5nLmNoaWxkTm9kZXMsIGkgPSBjaGlsZE5vZGVzLmxlbmd0aCAtIDEsIGdyb3VwOyBncm91cCA9IGNoaWxkTm9kZXNbaV07IGktLSkgZ3JvdXAuY2xlYXIoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldENoaWxkTm9kZXM6IGZ1bmN0aW9uKG5ld0NoaWxkTm9kZXMsIGtlZXBBbGl2ZSkgewogICAgICAgIGlmICghdGhpcy5kYXRhU291cmNlICYmICF0aGlzLmRhdGFTb3VyY2VBZGFwdGVyXykgdGhpcy5jbGVhcihrZWVwQWxpdmUpOwogICAgICAgIGlmIChuZXdDaGlsZE5vZGVzKSB7CiAgICAgICAgICBpZiAoImxlbmd0aCIgaW4gbmV3Q2hpbGROb2RlcyA9PSBmYWxzZSkgbmV3Q2hpbGROb2RlcyA9IFsgbmV3Q2hpbGROb2RlcyBdOwogICAgICAgICAgaWYgKG5ld0NoaWxkTm9kZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciB0bXAgPSB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkOwogICAgICAgICAgICB0aGlzLmVtaXRfY2hpbGROb2Rlc01vZGlmaWVkID0gJHVuZGVmOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gbmV3Q2hpbGROb2Rlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgdGhpcy5pbnNlcnRCZWZvcmUobmV3Q2hpbGROb2Rlc1tpXSk7CiAgICAgICAgICAgIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQgPSB0bXA7CiAgICAgICAgICAgIHRoaXMuZW1pdF9jaGlsZE5vZGVzTW9kaWZpZWQoewogICAgICAgICAgICAgIGluc2VydGVkOiB0aGlzLmNoaWxkTm9kZXMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXREYXRhU291cmNlOiBmdW5jdGlvbihkYXRhU291cmNlKSB7CiAgICAgICAgaWYgKCF0aGlzLmNoaWxkQ2xhc3MpIHRocm93IEVYQ0VQVElPTl9OT19DSElMRENMQVNTOwogICAgICAgIGRhdGFTb3VyY2UgPSBiYXNpcy5kYXRhLnJlc29sdmVEYXRhc2V0KHRoaXMsIHRoaXMuc2V0RGF0YVNvdXJjZSwgZGF0YVNvdXJjZSwgImRhdGFTb3VyY2VBZGFwdGVyXyIpOwogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UgIT09IGRhdGFTb3VyY2UpIHsKICAgICAgICAgIHZhciBvbGREYXRhU291cmNlID0gdGhpcy5kYXRhU291cmNlOwogICAgICAgICAgdmFyIGxpc3RlbkhhbmRsZXIgPSB0aGlzLmxpc3Rlbi5kYXRhU291cmNlOwogICAgICAgICAgaWYgKG9sZERhdGFTb3VyY2UpIHsKICAgICAgICAgICAgdGhpcy5kYXRhU291cmNlTWFwXyA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IG51bGw7CiAgICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSBvbGREYXRhU291cmNlLnJlbW92ZUhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5maXJzdENoaWxkKSB7CiAgICAgICAgICAgIGlmIChvbGREYXRhU291cmNlKSBmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gdGhpcy5jaGlsZE5vZGVzW2ldOyBpKyspIHVubG9ja0RhdGFTb3VyY2VJdGVtTm9kZShjaGlsZCk7CiAgICAgICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IGRhdGFTb3VyY2U7CiAgICAgICAgICBpZiAoZGF0YVNvdXJjZSkgewogICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2VNYXBfID0ge307CiAgICAgICAgICAgIHRoaXMuc2V0Q2hpbGROb2Rlc1N0YXRlKGRhdGFTb3VyY2Uuc3RhdGUsIGRhdGFTb3VyY2Uuc3RhdGUuZGF0YSk7CiAgICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSB7CiAgICAgICAgICAgICAgZGF0YVNvdXJjZS5hZGRIYW5kbGVyKGxpc3RlbkhhbmRsZXIsIHRoaXMpOwogICAgICAgICAgICAgIGlmIChkYXRhU291cmNlLml0ZW1Db3VudCAmJiBsaXN0ZW5IYW5kbGVyLml0ZW1zQ2hhbmdlZCkgewogICAgICAgICAgICAgICAgbGlzdGVuSGFuZGxlci5pdGVtc0NoYW5nZWQuY2FsbCh0aGlzLCBkYXRhU291cmNlLCB7CiAgICAgICAgICAgICAgICAgIGluc2VydGVkOiBkYXRhU291cmNlLmdldEl0ZW1zKCkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zZXRDaGlsZE5vZGVzU3RhdGUoU1RBVEUuVU5ERUZJTkVEKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9kYXRhU291cmNlQ2hhbmdlZChvbGREYXRhU291cmNlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldEdyb3VwaW5nOiBmdW5jdGlvbihncm91cGluZywgYWxpdmUpIHsKICAgICAgICBpZiAodHlwZW9mIGdyb3VwaW5nID09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGdyb3VwaW5nID09ICJzdHJpbmciKSBncm91cGluZyA9IHsKICAgICAgICAgIHJ1bGU6IGdyb3VwaW5nCiAgICAgICAgfTsKICAgICAgICBpZiAoZ3JvdXBpbmcgaW5zdGFuY2VvZiBHcm91cGluZ05vZGUgPT0gZmFsc2UpIHsKICAgICAgICAgIGdyb3VwaW5nID0gZ3JvdXBpbmcgJiYgdHlwZW9mIGdyb3VwaW5nID09ICJvYmplY3QiID8gbmV3IHRoaXMuZ3JvdXBpbmdDbGFzcyhncm91cGluZykgOiBudWxsOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5ncm91cGluZyAhPT0gZ3JvdXBpbmcpIHsKICAgICAgICAgIHZhciBvbGRHcm91cGluZyA9IHRoaXMuZ3JvdXBpbmc7CiAgICAgICAgICB2YXIgb3JkZXI7CiAgICAgICAgICBpZiAob2xkR3JvdXBpbmcpIHsKICAgICAgICAgICAgdGhpcy5ncm91cGluZyA9IG51bGw7CiAgICAgICAgICAgIGlmICghZ3JvdXBpbmcpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5maXJzdENoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zb3J0aW5nICE9PSBudWxsR2V0dGVyKSBvcmRlciA9IHNvcnRDaGlsZE5vZGVzKHRoaXMpOyBlbHNlIG9yZGVyID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgICAgICAgICAgb2xkR3JvdXBpbmcubnVsbEdyb3VwLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB2YXIgZ3JvdXBzID0gb2xkR3JvdXBpbmcuY2hpbGROb2Rlcy5zbGljZSgwKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZ3JvdXBzLmxlbmd0aDsgaSsrKSBncm91cHNbaV0uY2xlYXIoKTsKICAgICAgICAgICAgICAgIGZhc3RDaGlsZE5vZGVzT3JkZXIodGhpcywgb3JkZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBvbGRHcm91cGluZy5zZXRPd25lcigpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdyb3VwaW5nKSB7CiAgICAgICAgICAgIHRoaXMuZ3JvdXBpbmcgPSBncm91cGluZzsKICAgICAgICAgICAgZ3JvdXBpbmcuc2V0T3duZXIodGhpcyk7CiAgICAgICAgICAgIGlmICh0aGlzLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5zb3J0aW5nICE9PSBudWxsR2V0dGVyKSBvcmRlciA9IHNvcnRDaGlsZE5vZGVzKHRoaXMpOyBlbHNlIG9yZGVyID0gdGhpcy5jaGlsZE5vZGVzOwogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjaGlsZDsgY2hpbGQgPSBvcmRlcltpXTsgaSsrKSBjaGlsZC5ncm91cE5vZGUgPSB0aGlzLmdyb3VwaW5nLmdldEdyb3VwTm9kZShjaGlsZCwgdHJ1ZSk7CiAgICAgICAgICAgICAgb3JkZXIgPSBmYXN0Q2hpbGROb2Rlc0dyb3VwT3JkZXIodGhpcywgb3JkZXIpOwogICAgICAgICAgICAgIGZhc3RDaGlsZE5vZGVzT3JkZXIodGhpcywgb3JkZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmVtaXRfZ3JvdXBpbmdDaGFuZ2VkKG9sZEdyb3VwaW5nKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFNvcnRpbmc6IGZ1bmN0aW9uKHNvcnRpbmcsIHNvcnRpbmdEZXNjKSB7CiAgICAgICAgc29ydGluZyA9IGdldHRlcihzb3J0aW5nKTsKICAgICAgICBzb3J0aW5nRGVzYyA9ICEhc29ydGluZ0Rlc2M7CiAgICAgICAgaWYgKHRoaXMuc29ydGluZyAhPT0gc29ydGluZyB8fCB0aGlzLnNvcnRpbmdEZXNjICE9ICEhc29ydGluZ0Rlc2MpIHsKICAgICAgICAgIHZhciBvbGRTb3J0aW5nID0gdGhpcy5zb3J0aW5nOwogICAgICAgICAgdmFyIG9sZFNvcnRpbmdEZXNjID0gdGhpcy5zb3J0aW5nRGVzYzsKICAgICAgICAgIHRoaXMuc29ydGluZyA9IHNvcnRpbmc7CiAgICAgICAgICB0aGlzLnNvcnRpbmdEZXNjID0gISFzb3J0aW5nRGVzYzsKICAgICAgICAgIGlmIChzb3J0aW5nICE9PSBudWxsR2V0dGVyICYmIHRoaXMuZmlyc3RDaGlsZCkgewogICAgICAgICAgICB2YXIgb3JkZXIgPSBbXTsKICAgICAgICAgICAgdmFyIG5vZGVzOwogICAgICAgICAgICBmb3IgKHZhciBub2RlID0gdGhpcy5maXJzdENoaWxkOyBub2RlOyBub2RlID0gbm9kZS5uZXh0U2libGluZykgbm9kZS5zb3J0aW5nVmFsdWUgPSBzb3J0aW5nKG5vZGUpIHx8IDA7CiAgICAgICAgICAgIGlmICh0aGlzLmdyb3VwaW5nKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgZ3JvdXAgPSB0aGlzLmdyb3VwaW5nLm51bGxHcm91cDsgZ3JvdXA7IGdyb3VwID0gZ3JvdXAubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgICAgIG5vZGVzID0gZ3JvdXAubm9kZXMgPSBzb3J0Q2hpbGROb2Rlcyh7CiAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZXM6IGdyb3VwLm5vZGVzLAogICAgICAgICAgICAgICAgICBzb3J0aW5nRGVzYzogdGhpcy5zb3J0aW5nRGVzYwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBncm91cC5maXJzdCA9IG5vZGVzWzBdIHx8IG51bGw7CiAgICAgICAgICAgICAgICBncm91cC5sYXN0ID0gbm9kZXNbbm9kZXMubGVuZ3RoIC0gMV0gfHwgbnVsbDsKICAgICAgICAgICAgICAgIG9yZGVyLnB1c2guYXBwbHkob3JkZXIsIG5vZGVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgb3JkZXIgPSBzb3J0Q2hpbGROb2Rlcyh0aGlzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYXN0Q2hpbGROb2Rlc09yZGVyKHRoaXMsIG9yZGVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9zb3J0aW5nQ2hhbmdlZChvbGRTb3J0aW5nLCBvbGRTb3J0aW5nRGVzYyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRNYXRjaEZ1bmN0aW9uOiBmdW5jdGlvbihtYXRjaEZ1bmN0aW9uKSB7CiAgICAgICAgaWYgKHRoaXMubWF0Y2hGdW5jdGlvbiAhPSBtYXRjaEZ1bmN0aW9uKSB7CiAgICAgICAgICB2YXIgb2xkTWF0Y2hGdW5jdGlvbiA9IHRoaXMubWF0Y2hGdW5jdGlvbjsKICAgICAgICAgIHRoaXMubWF0Y2hGdW5jdGlvbiA9IG1hdGNoRnVuY3Rpb247CiAgICAgICAgICBmb3IgKHZhciBub2RlID0gdGhpcy5sYXN0Q2hpbGQ7IG5vZGU7IG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykgbm9kZS5tYXRjaChtYXRjaEZ1bmN0aW9uKTsKICAgICAgICAgIHRoaXMuZW1pdF9tYXRjaEZ1bmN0aW9uQ2hhbmdlZChvbGRNYXRjaEZ1bmN0aW9uKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB2YXIgTm9kZSA9IENsYXNzKEFic3RyYWN0Tm9kZSwgRG9tTWl4aW4sIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLk5vZGUiLAogICAgICBlbWl0X2VuYWJsZTogY3JlYXRlRXZlbnQoImVuYWJsZSIpICYmIGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGNoaWxkID0gdGhpcy5maXJzdENoaWxkOyBjaGlsZDsgY2hpbGQgPSBjaGlsZC5uZXh0U2libGluZykgdXBkYXRlTm9kZURpc2FibGVDb250ZXh0KGNoaWxkLCBmYWxzZSk7CiAgICAgICAgZXZlbnRzLmVuYWJsZS5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBlbWl0X2Rpc2FibGU6IGNyZWF0ZUV2ZW50KCJkaXNhYmxlIikgJiYgZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgY2hpbGQgPSB0aGlzLmZpcnN0Q2hpbGQ7IGNoaWxkOyBjaGlsZCA9IGNoaWxkLm5leHRTaWJsaW5nKSB1cGRhdGVOb2RlRGlzYWJsZUNvbnRleHQoY2hpbGQsIHRydWUpOwogICAgICAgIGV2ZW50cy5kaXNhYmxlLmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGVtaXRfc2F0ZWxsaXRlQ2hhbmdlZDogZnVuY3Rpb24obmFtZSwgb2xkU2F0ZWxsaXRlKSB7CiAgICAgICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5lbWl0X3NhdGVsbGl0ZUNoYW5nZWQuY2FsbCh0aGlzLCBuYW1lLCBvbGRTYXRlbGxpdGUpOwogICAgICAgIGlmICh0aGlzLnNhdGVsbGl0ZVtuYW1lXSBpbnN0YW5jZW9mIE5vZGUpIHVwZGF0ZU5vZGVEaXNhYmxlQ29udGV4dCh0aGlzLnNhdGVsbGl0ZVtuYW1lXSwgdGhpcy5kaXNhYmxlZCB8fCB0aGlzLmNvbnRleHREaXNhYmxlZCk7CiAgICAgIH0sCiAgICAgIGVtaXRfc2VsZWN0OiBjcmVhdGVFdmVudCgic2VsZWN0IiksCiAgICAgIGVtaXRfdW5zZWxlY3Q6IGNyZWF0ZUV2ZW50KCJ1bnNlbGVjdCIpLAogICAgICBlbWl0X21hdGNoOiBjcmVhdGVFdmVudCgibWF0Y2giKSwKICAgICAgZW1pdF91bm1hdGNoOiBjcmVhdGVFdmVudCgidW5tYXRjaCIpLAogICAgICBlbWl0X21hdGNoRnVuY3Rpb25DaGFuZ2VkOiBjcmVhdGVFdmVudCgibWF0Y2hGdW5jdGlvbkNoYW5nZWQiLCAib2xkTWF0Y2hGdW5jdGlvbiIpLAogICAgICBzZWxlY3RhYmxlOiB0cnVlLAogICAgICBzZWxlY3RlZDogZmFsc2UsCiAgICAgIHNlbGVjdGlvbjogbnVsbCwKICAgICAgY29udGV4dFNlbGVjdGlvbjogbnVsbCwKICAgICAgbWF0Y2hGdW5jdGlvbjogbnVsbCwKICAgICAgbWF0Y2hlZDogdHJ1ZSwKICAgICAgZGlzYWJsZWQ6IGZhbHNlLAogICAgICBjb250ZXh0RGlzYWJsZWQ6IGZhbHNlLAogICAgICBsaXN0ZW46IHsKICAgICAgICBvd25lcjogewogICAgICAgICAgZW5hYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlTm9kZURpc2FibGVDb250ZXh0KHRoaXMsIGZhbHNlKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkaXNhYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdXBkYXRlTm9kZURpc2FibGVDb250ZXh0KHRoaXMsIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uKSB7CiAgICAgICAgICBpZiAodGhpcy5zZWxlY3Rpb24gaW5zdGFuY2VvZiBSZWFkT25seURhdGFzZXQgPT0gZmFsc2UpIHRoaXMuc2VsZWN0aW9uID0gbmV3IFNlbGVjdGlvbih0aGlzLnNlbGVjdGlvbik7CiAgICAgICAgICBpZiAodGhpcy5saXN0ZW4uc2VsZWN0aW9uKSB0aGlzLnNlbGVjdGlvbi5hZGRIYW5kbGVyKHRoaXMubGlzdGVuLnNlbGVjdGlvbiwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIEFic3RyYWN0Tm9kZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIGlmICh0aGlzLmRpc2FibGVkKSB0aGlzLmVtaXRfZGlzYWJsZSgpOwogICAgICAgIGlmICh0aGlzLnNlbGVjdGVkKSB7CiAgICAgICAgICB0aGlzLnNlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnNlbGVjdCh0cnVlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldFNlbGVjdGlvbjogZnVuY3Rpb24oc2VsZWN0aW9uKSB7CiAgICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uICE9PSBzZWxlY3Rpb24pIHsKICAgICAgICAgIHVwZGF0ZU5vZGVDb250ZXh0U2VsZWN0aW9uKHRoaXMsIHRoaXMuc2VsZWN0aW9uIHx8IHRoaXMuY29udGV4dFNlbGVjdGlvbiwgc2VsZWN0aW9uIHx8IHRoaXMuY29udGV4dFNlbGVjdGlvbiwgZmFsc2UsIHRydWUpOwogICAgICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uICYmIHRoaXMubGlzdGVuLnNlbGVjdGlvbikgdGhpcy5zZWxlY3Rpb24ucmVtb3ZlSGFuZGxlcih0aGlzLmxpc3Rlbi5zZWxlY3Rpb24sIHRoaXMpOwogICAgICAgICAgdGhpcy5zZWxlY3Rpb24gPSBzZWxlY3Rpb247CiAgICAgICAgICBpZiAoc2VsZWN0aW9uICYmIHRoaXMubGlzdGVuLnNlbGVjdGlvbikgc2VsZWN0aW9uLmFkZEhhbmRsZXIodGhpcy5saXN0ZW4uc2VsZWN0aW9uLCB0aGlzKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2VsZWN0OiBmdW5jdGlvbihtdWx0aXBsZSkgewogICAgICAgIHZhciBzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQ7CiAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHRoaXMuY29udGV4dFNlbGVjdGlvbjsKICAgICAgICBpZiAoc2VsZWN0aW9uKSB7CiAgICAgICAgICBpZiAoIW11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdGFibGUpIHNlbGVjdGlvbi5zZXQoWyB0aGlzIF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHNlbGVjdGVkKSBzZWxlY3Rpb24ucmVtb3ZlKFsgdGhpcyBdKTsgZWxzZSBzZWxlY3Rpb24uYWRkKFsgdGhpcyBdKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFzZWxlY3RlZCAmJiB0aGlzLnNlbGVjdGFibGUpIHsKICAgICAgICAgIHRoaXMuc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgdGhpcy5lbWl0X3NlbGVjdCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3RlZCAhPSBzZWxlY3RlZDsKICAgICAgfSwKICAgICAgdW5zZWxlY3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQ7CiAgICAgICAgaWYgKHNlbGVjdGVkKSB7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gdGhpcy5jb250ZXh0U2VsZWN0aW9uOwogICAgICAgICAgaWYgKHNlbGVjdGlvbikgc2VsZWN0aW9uLnJlbW92ZShbIHRoaXMgXSk7IGVsc2UgewogICAgICAgICAgICB0aGlzLnNlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZW1pdF91bnNlbGVjdCgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5zZWxlY3RlZCAhPSBzZWxlY3RlZDsKICAgICAgfSwKICAgICAgc2V0U2VsZWN0ZWQ6IGZ1bmN0aW9uKHNlbGVjdGVkLCBtdWx0aXBsZSkgewogICAgICAgIHJldHVybiBzZWxlY3RlZCA/IHRoaXMuc2VsZWN0KG11bHRpcGxlKSA6IHRoaXMudW5zZWxlY3QoKTsKICAgICAgfSwKICAgICAgZW5hYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGlzYWJsZWQgPSB0aGlzLmRpc2FibGVkOwogICAgICAgIGlmIChkaXNhYmxlZCkgewogICAgICAgICAgdGhpcy5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgaWYgKCF0aGlzLmNvbnRleHREaXNhYmxlZCkgdGhpcy5lbWl0X2VuYWJsZSgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5kaXNhYmxlZCAhPSBkaXNhYmxlZDsKICAgICAgfSwKICAgICAgZGlzYWJsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGRpc2FibGVkID0gdGhpcy5kaXNhYmxlZDsKICAgICAgICBpZiAoIWRpc2FibGVkKSB7CiAgICAgICAgICB0aGlzLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgIGlmICghdGhpcy5jb250ZXh0RGlzYWJsZWQpIHRoaXMuZW1pdF9kaXNhYmxlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLmRpc2FibGVkICE9IGRpc2FibGVkOwogICAgICB9LAogICAgICBzZXREaXNhYmxlZDogZnVuY3Rpb24oZGlzYWJsZWQpIHsKICAgICAgICByZXR1cm4gZGlzYWJsZWQgPyB0aGlzLmRpc2FibGUoKSA6IHRoaXMuZW5hYmxlKCk7CiAgICAgIH0sCiAgICAgIGlzRGlzYWJsZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmRpc2FibGVkIHx8IHRoaXMuY29udGV4dERpc2FibGVkOwogICAgICB9LAogICAgICBtYXRjaDogZnVuY3Rpb24oZnVuYykgewogICAgICAgIGlmICh0eXBlb2YgZnVuYyAhPSAiZnVuY3Rpb24iKSBmdW5jID0gbnVsbDsKICAgICAgICBpZiAodGhpcy51bmRlck1hdGNoXyAmJiAhZnVuYykgdGhpcy51bmRlck1hdGNoXyh0aGlzLCB0cnVlKTsKICAgICAgICB0aGlzLnVuZGVyTWF0Y2hfID0gZnVuYzsKICAgICAgICB2YXIgbWF0Y2hlZCA9ICFmdW5jIHx8IGZ1bmModGhpcyk7CiAgICAgICAgaWYgKHRoaXMubWF0Y2hlZCAhPSBtYXRjaGVkKSB7CiAgICAgICAgICB0aGlzLm1hdGNoZWQgPSBtYXRjaGVkOwogICAgICAgICAgaWYgKG1hdGNoZWQpIHRoaXMuZW1pdF9tYXRjaCgpOyBlbHNlIHRoaXMuZW1pdF91bm1hdGNoKCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnVuc2VsZWN0KCk7CiAgICAgICAgdGhpcy5jb250ZXh0U2VsZWN0aW9uID0gbnVsbDsKICAgICAgICBpZiAodGhpcy5zZWxlY3Rpb24pIHRoaXMuc2V0U2VsZWN0aW9uKCk7CiAgICAgICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIEdyb3VwaW5nTm9kZSA9IENsYXNzKEFic3RyYWN0Tm9kZSwgRG9tTWl4aW4sIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkdyb3VwaW5nTm9kZSIsCiAgICAgIGVtaXRfY2hpbGROb2Rlc01vZGlmaWVkOiBmdW5jdGlvbihkZWx0YSkgewogICAgICAgIGV2ZW50cy5jaGlsZE5vZGVzTW9kaWZpZWQuY2FsbCh0aGlzLCBkZWx0YSk7CiAgICAgICAgdGhpcy5udWxsR3JvdXAubmV4dFNpYmxpbmcgPSB0aGlzLmZpcnN0Q2hpbGQ7CiAgICAgICAgdmFyIGFycmF5OwogICAgICAgIGlmIChhcnJheSA9IGRlbHRhLmluc2VydGVkKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gYXJyYXlbaSsrXTsgKSB7CiAgICAgICAgICAgIGNoaWxkLmdyb3VwSWRfID0gY2hpbGQuZGVsZWdhdGUgPyBjaGlsZC5kZWxlZ2F0ZS5iYXNpc09iamVjdElkIDogY2hpbGQuZGF0YS5pZDsKICAgICAgICAgICAgdGhpcy5tYXBfW2NoaWxkLmdyb3VwSWRfXSA9IGNoaWxkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuZGF0YVNvdXJjZSAmJiB0aGlzLm51bGxHcm91cC5maXJzdCkgewogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHRoaXMub3duZXI7CiAgICAgICAgICAgIHZhciBub2RlcyA9IGFycmF5RnJvbSh0aGlzLm51bGxHcm91cC5ub2Rlcyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBub2Rlcy5sZW5ndGg7IGktLSA+IDA7ICkgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZXNbaV0sIG5vZGVzW2ldLm5leHRTaWJsaW5nKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGVtaXRfb3duZXJDaGFuZ2VkOiBmdW5jdGlvbihvbGRPd25lcikgewogICAgICAgIGlmIChvbGRPd25lciAmJiBvbGRPd25lci5ncm91cGluZyA9PT0gdGhpcykgb2xkT3duZXIuc2V0R3JvdXBpbmcobnVsbCwgdHJ1ZSk7CiAgICAgICAgaWYgKHRoaXMub3duZXIgJiYgdGhpcy5vd25lci5ncm91cGluZyAhPT0gdGhpcykgdGhpcy5vd25lci5zZXRHcm91cGluZyh0aGlzKTsKICAgICAgICBldmVudHMub3duZXJDaGFuZ2VkLmNhbGwodGhpcywgb2xkT3duZXIpOwogICAgICAgIGlmICghdGhpcy5vd25lciAmJiB0aGlzLmF1dG9EZXN0cm95V2l0aE5vT3duZXIpIHRoaXMuZGVzdHJveSgpOwogICAgICB9LAogICAgICBtYXBfOiBudWxsLAogICAgICBudWxsR3JvdXA6IG51bGwsCiAgICAgIGF1dG9EZXN0cm95V2l0aE5vT3duZXI6IHRydWUsCiAgICAgIGF1dG9EZXN0cm95RW1wdHlHcm91cHM6IHRydWUsCiAgICAgIHJ1bGU6IG51bGxHZXR0ZXIsCiAgICAgIGNoaWxkQ2xhc3M6IFBhcnRpdGlvbk5vZGUsCiAgICAgIGNoaWxkRmFjdG9yeTogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgcmV0dXJuIG5ldyB0aGlzLmNoaWxkQ2xhc3MoY29tcGxldGUoewogICAgICAgICAgYXV0b0Rlc3Ryb3lJZkVtcHR5OiB0aGlzLmRhdGFTb3VyY2UgPyBmYWxzZSA6IHRoaXMuYXV0b0Rlc3Ryb3lFbXB0eUdyb3VwcwogICAgICAgIH0sIGNvbmZpZykpOwogICAgICB9LAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLm1hcF8gPSB7fTsKICAgICAgICB0aGlzLm51bGxHcm91cCA9IG5ldyBQYXJ0aXRpb25Ob2RlOwogICAgICAgIEFic3RyYWN0Tm9kZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBnZXRHcm91cE5vZGU6IGZ1bmN0aW9uKG5vZGUsIGF1dG9jcmVhdGUpIHsKICAgICAgICB2YXIgZ3JvdXBSZWYgPSB0aGlzLnJ1bGUobm9kZSk7CiAgICAgICAgdmFyIGlzRGVsZWdhdGUgPSBncm91cFJlZiBpbnN0YW5jZW9mIERhdGFPYmplY3Q7CiAgICAgICAgdmFyIGdyb3VwID0gdGhpcy5tYXBfW2lzRGVsZWdhdGUgPyBncm91cFJlZi5iYXNpc09iamVjdElkIDogZ3JvdXBSZWZdOwogICAgICAgIGlmICh0aGlzLmRhdGFTb3VyY2UpIGF1dG9jcmVhdGUgPSBmYWxzZTsKICAgICAgICBpZiAoIWdyb3VwICYmIGF1dG9jcmVhdGUpIHsKICAgICAgICAgIGdyb3VwID0gdGhpcy5hcHBlbmRDaGlsZChpc0RlbGVnYXRlID8gZ3JvdXBSZWYgOiB7CiAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICBpZDogZ3JvdXBSZWYsCiAgICAgICAgICAgICAgdGl0bGU6IGdyb3VwUmVmCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ3JvdXAgfHwgdGhpcy5udWxsR3JvdXA7CiAgICAgIH0sCiAgICAgIHNldERhdGFTb3VyY2U6IGZ1bmN0aW9uKGRhdGFTb3VyY2UpIHsKICAgICAgICB2YXIgY3VyRGF0YVNvdXJjZSA9IHRoaXMuZGF0YVNvdXJjZTsKICAgICAgICBEb21NaXhpbi5zZXREYXRhU291cmNlLmNhbGwodGhpcywgZGF0YVNvdXJjZSk7CiAgICAgICAgdmFyIG93bmVyID0gdGhpcy5vd25lcjsKICAgICAgICBpZiAob3duZXIgJiYgdGhpcy5kYXRhU291cmNlICE9PSBjdXJEYXRhU291cmNlKSB7CiAgICAgICAgICB2YXIgbm9kZXMgPSBhcnJheUZyb20ob3duZXIuY2hpbGROb2Rlcyk7CiAgICAgICAgICBmb3IgKHZhciBpID0gbm9kZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIG93bmVyLmluc2VydEJlZm9yZShub2Rlc1tpXSwgbm9kZXNbaSArIDFdKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGluc2VydEJlZm9yZTogZnVuY3Rpb24obmV3Q2hpbGQsIHJlZkNoaWxkKSB7CiAgICAgICAgbmV3Q2hpbGQgPSBEb21NaXhpbi5pbnNlcnRCZWZvcmUuY2FsbCh0aGlzLCBuZXdDaGlsZCwgcmVmQ2hpbGQpOwogICAgICAgIHZhciBmaXJzdE5vZGUgPSBuZXdDaGlsZC5maXJzdDsKICAgICAgICBpZiAoZmlyc3ROb2RlKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmlyc3ROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB2YXIgbGFzdE5vZGUgPSBuZXdDaGlsZC5sYXN0OwogICAgICAgICAgdmFyIGJlZm9yZVByZXY7CiAgICAgICAgICB2YXIgYmVmb3JlTmV4dDsKICAgICAgICAgIHZhciBhZnRlclByZXY7CiAgICAgICAgICB2YXIgYWZ0ZXJOZXh0ID0gbnVsbDsKICAgICAgICAgIHZhciBjdXJzb3IgPSBuZXdDaGlsZDsKICAgICAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgaWYgKGFmdGVyTmV4dCA9IGN1cnNvci5maXJzdCkgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhZnRlclByZXYgPSBhZnRlck5leHQgPyBhZnRlck5leHQucHJldmlvdXNTaWJsaW5nIDogcGFyZW50Lmxhc3RDaGlsZDsKICAgICAgICAgIGJlZm9yZVByZXYgPSBmaXJzdE5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgYmVmb3JlTmV4dCA9IGxhc3ROb2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgaWYgKGJlZm9yZU5leHQgIT09IGFmdGVyTmV4dCkgewogICAgICAgICAgICB2YXIgcGFyZW50Q2hpbGROb2RlcyA9IHBhcmVudC5jaGlsZE5vZGVzOwogICAgICAgICAgICB2YXIgbm9kZXMgPSBuZXdDaGlsZC5ub2RlczsKICAgICAgICAgICAgdmFyIG5vZGVzQ291bnQgPSBub2Rlcy5sZW5ndGg7CiAgICAgICAgICAgIGlmIChiZWZvcmVQcmV2KSBiZWZvcmVQcmV2Lm5leHRTaWJsaW5nID0gYmVmb3JlTmV4dDsKICAgICAgICAgICAgaWYgKGJlZm9yZU5leHQpIGJlZm9yZU5leHQucHJldmlvdXNTaWJsaW5nID0gYmVmb3JlUHJldjsKICAgICAgICAgICAgaWYgKGFmdGVyUHJldikgYWZ0ZXJQcmV2Lm5leHRTaWJsaW5nID0gZmlyc3ROb2RlOwogICAgICAgICAgICBpZiAoYWZ0ZXJOZXh0KSBhZnRlck5leHQucHJldmlvdXNTaWJsaW5nID0gbGFzdE5vZGU7CiAgICAgICAgICAgIGZpcnN0Tm9kZS5wcmV2aW91c1NpYmxpbmcgPSBhZnRlclByZXY7CiAgICAgICAgICAgIGxhc3ROb2RlLm5leHRTaWJsaW5nID0gYWZ0ZXJOZXh0OwogICAgICAgICAgICB2YXIgZmlyc3RQb3MgPSBwYXJlbnRDaGlsZE5vZGVzLmluZGV4T2YoZmlyc3ROb2RlKTsKICAgICAgICAgICAgdmFyIGFmdGVyTmV4dFBvcyA9IGFmdGVyTmV4dCA/IHBhcmVudENoaWxkTm9kZXMuaW5kZXhPZihhZnRlck5leHQpIDogcGFyZW50Q2hpbGROb2Rlcy5sZW5ndGg7CiAgICAgICAgICAgIGlmIChhZnRlck5leHRQb3MgPiBmaXJzdFBvcykgYWZ0ZXJOZXh0UG9zIC09IG5vZGVzQ291bnQ7CiAgICAgICAgICAgIHBhcmVudENoaWxkTm9kZXMuc3BsaWNlKGZpcnN0UG9zLCBub2Rlc0NvdW50KTsKICAgICAgICAgICAgcGFyZW50Q2hpbGROb2Rlcy5zcGxpY2UuYXBwbHkocGFyZW50Q2hpbGROb2RlcywgWyBhZnRlck5leHRQb3MsIDAgXS5jb25jYXQobm9kZXMpKTsKICAgICAgICAgICAgaWYgKCFhZnRlclByZXYgfHwgIWJlZm9yZVByZXYpIHBhcmVudC5maXJzdENoaWxkID0gcGFyZW50Q2hpbGROb2Rlc1swXTsKICAgICAgICAgICAgaWYgKCFhZnRlck5leHQgfHwgIWJlZm9yZU5leHQpIHBhcmVudC5sYXN0Q2hpbGQgPSBwYXJlbnRDaGlsZE5vZGVzW3BhcmVudENoaWxkTm9kZXMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgIGlmIChmaXJzdE5vZGUgaW5zdGFuY2VvZiBQYXJ0aXRpb25Ob2RlKSBmb3IgKHZhciBpID0gbm9kZXNDb3VudCwgaW5zZXJ0QmVmb3JlID0gYWZ0ZXJOZXh0OyBpLS0gPiAwOyApIHsKICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGVzW2ldLCBpbnNlcnRCZWZvcmUpOwogICAgICAgICAgICAgIGluc2VydEJlZm9yZSA9IG5vZGVzW2ldOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdDaGlsZDsKICAgICAgfSwKICAgICAgcmVtb3ZlQ2hpbGQ6IGZ1bmN0aW9uKG9sZENoaWxkKSB7CiAgICAgICAgaWYgKG9sZENoaWxkID0gRG9tTWl4aW4ucmVtb3ZlQ2hpbGQuY2FsbCh0aGlzLCBvbGRDaGlsZCkpIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLm1hcF9bb2xkQ2hpbGQuZ3JvdXBJZF9dOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5vZGU7IG5vZGUgPSBvbGRDaGlsZC5ub2Rlc1tpXTsgaSsrKSBub2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb2xkQ2hpbGQ7CiAgICAgIH0sCiAgICAgIGNsZWFyOiBmdW5jdGlvbihhbGl2ZSkgewogICAgICAgIHZhciBub2RlcyA9IFtdOwogICAgICAgIHZhciBnZXRHcm91cE5vZGUgPSB0aGlzLmdldEdyb3VwTm9kZTsKICAgICAgICB2YXIgbnVsbEdyb3VwID0gdGhpcy5udWxsR3JvdXA7CiAgICAgICAgdGhpcy5nZXRHcm91cE5vZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBudWxsR3JvdXA7CiAgICAgICAgfTsKICAgICAgICBmb3IgKHZhciBncm91cCA9IHRoaXMuZmlyc3RDaGlsZDsgZ3JvdXA7IGdyb3VwID0gZ3JvdXAubmV4dFNpYmxpbmcpIG5vZGVzLnB1c2guYXBwbHkobm9kZXMsIGdyb3VwLm5vZGVzKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgY2hpbGQ7IGNoaWxkID0gbm9kZXNbaV07IGkrKykgY2hpbGQucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQpOwogICAgICAgIHRoaXMuZ2V0R3JvdXBOb2RlID0gZ2V0R3JvdXBOb2RlOwogICAgICAgIERvbU1peGluLmNsZWFyLmNhbGwodGhpcywgYWxpdmUpOwogICAgICAgIHRoaXMubWFwXyA9IHt9OwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmF1dG9EZXN0cm95V2l0aE5vT3duZXIgPSBmYWxzZTsKICAgICAgICBBYnN0cmFjdE5vZGUucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLm51bGxHcm91cC5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5udWxsR3JvdXAgPSBudWxsOwogICAgICAgIHRoaXMubWFwXyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgQWJzdHJhY3ROb2RlLnByb3RvdHlwZS5ncm91cGluZ0NsYXNzID0gR3JvdXBpbmdOb2RlOwogICAgdmFyIENISUxETk9ERVNEQVRBU0VUX0hBTkRMRVIgPSB7CiAgICAgIGNoaWxkTm9kZXNNb2RpZmllZDogZnVuY3Rpb24oc2VuZGVyLCBkZWx0YSkgewogICAgICAgIHZhciBtZW1iZXJNYXAgPSB0aGlzLm1lbWJlcnNfOwogICAgICAgIHZhciBuZXdEZWx0YSA9IHt9OwogICAgICAgIHZhciBub2RlOwogICAgICAgIHZhciBpbnNlcnRDb3VudCA9IDA7CiAgICAgICAgdmFyIGRlbGV0ZUNvdW50ID0gMDsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBkZWx0YS5pbnNlcnRlZDsKICAgICAgICB2YXIgZGVsZXRlZCA9IGRlbHRhLmRlbGV0ZWQ7CiAgICAgICAgaWYgKGluc2VydGVkICYmIGluc2VydGVkLmxlbmd0aCkgewogICAgICAgICAgbmV3RGVsdGEuaW5zZXJ0ZWQgPSBpbnNlcnRlZDsKICAgICAgICAgIHdoaWxlIChub2RlID0gaW5zZXJ0ZWRbaW5zZXJ0Q291bnRdKSB7CiAgICAgICAgICAgIG1lbWJlck1hcFtub2RlLmJhc2lzT2JqZWN0SWRdID0gbm9kZTsKICAgICAgICAgICAgaW5zZXJ0Q291bnQrKzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlbGV0ZWQgJiYgZGVsZXRlZC5sZW5ndGgpIHsKICAgICAgICAgIG5ld0RlbHRhLmRlbGV0ZWQgPSBkZWxldGVkOwogICAgICAgICAgd2hpbGUgKG5vZGUgPSBkZWxldGVkW2RlbGV0ZUNvdW50XSkgewogICAgICAgICAgICBkZWxldGUgbWVtYmVyTWFwW25vZGUuYmFzaXNPYmplY3RJZF07CiAgICAgICAgICAgIGRlbGV0ZUNvdW50Kys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpbnNlcnRDb3VudCB8fCBkZWxldGVDb3VudCkgdGhpcy5lbWl0X2l0ZW1zQ2hhbmdlZChuZXdEZWx0YSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVzdHJveSgpOwogICAgICB9CiAgICB9OwogICAgdmFyIENoaWxkTm9kZXNEYXRhc2V0ID0gQ2xhc3MoUmVhZE9ubHlEYXRhc2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5DaGlsZE5vZGVzRGF0YXNldCIsCiAgICAgIHNvdXJjZU5vZGU6IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIFJlYWRPbmx5RGF0YXNldC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHZhciBzb3VyY2VOb2RlID0gdGhpcy5zb3VyY2VOb2RlOwogICAgICAgIGNoaWxkTm9kZXNEYXRhc2V0TWFwW3NvdXJjZU5vZGUuYmFzaXNPYmplY3RJZF0gPSB0aGlzOwogICAgICAgIGlmIChzb3VyY2VOb2RlLmZpcnN0Q2hpbGQpIENISUxETk9ERVNEQVRBU0VUX0hBTkRMRVIuY2hpbGROb2Rlc01vZGlmaWVkLmNhbGwodGhpcywgc291cmNlTm9kZSwgewogICAgICAgICAgaW5zZXJ0ZWQ6IHNvdXJjZU5vZGUuY2hpbGROb2RlcwogICAgICAgIH0pOwogICAgICAgIHNvdXJjZU5vZGUuYWRkSGFuZGxlcihDSElMRE5PREVTREFUQVNFVF9IQU5ETEVSLCB0aGlzKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zb3VyY2VOb2RlLnJlbW92ZUhhbmRsZXIoQ0hJTEROT0RFU0RBVEFTRVRfSEFORExFUiwgdGhpcyk7CiAgICAgICAgZGVsZXRlIGNoaWxkTm9kZXNEYXRhc2V0TWFwW3RoaXMuc291cmNlTm9kZS5iYXNpc09iamVjdElkXTsKICAgICAgICBSZWFkT25seURhdGFzZXQucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgU2VsZWN0aW9uID0gQ2xhc3MoRGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU2VsZWN0aW9uIiwKICAgICAgbXVsdGlwbGU6IGZhbHNlLAogICAgICBlbWl0X2l0ZW1zQ2hhbmdlZDogZnVuY3Rpb24oZGVsdGEpIHsKICAgICAgICBEYXRhc2V0LnByb3RvdHlwZS5lbWl0X2l0ZW1zQ2hhbmdlZC5jYWxsKHRoaXMsIGRlbHRhKTsKICAgICAgICBpZiAoZGVsdGEuaW5zZXJ0ZWQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBub2RlOyBub2RlID0gZGVsdGEuaW5zZXJ0ZWRbaV07IGkrKykgewogICAgICAgICAgICBpZiAoIW5vZGUuc2VsZWN0ZWQpIHsKICAgICAgICAgICAgICBub2RlLnNlbGVjdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICBub2RlLmVtaXRfc2VsZWN0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGRlbHRhLmRlbGV0ZWQpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBub2RlOyBub2RlID0gZGVsdGEuZGVsZXRlZFtpXTsgaSsrKSB7CiAgICAgICAgICAgIGlmIChub2RlLnNlbGVjdGVkKSB7CiAgICAgICAgICAgICAgbm9kZS5zZWxlY3RlZCA9IGZhbHNlOwogICAgICAgICAgICAgIG5vZGUuZW1pdF91bnNlbGVjdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBhZGQ6IGZ1bmN0aW9uKG5vZGVzKSB7CiAgICAgICAgaWYgKCF0aGlzLm11bHRpcGxlKSB7CiAgICAgICAgICBpZiAodGhpcy5pdGVtQ291bnQpIHJldHVybiB0aGlzLnNldChub2Rlcyk7IGVsc2Ugbm9kZXMgPSBbIG5vZGVzWzBdIF07CiAgICAgICAgfQogICAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBub2RlOyBub2RlID0gbm9kZXNbaV07IGkrKykgewogICAgICAgICAgaWYgKG5vZGUuY29udGV4dFNlbGVjdGlvbiA9PSB0aGlzICYmIG5vZGUuc2VsZWN0YWJsZSkgaXRlbXMucHVzaChub2RlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIERhdGFzZXQucHJvdG90eXBlLmFkZC5jYWxsKHRoaXMsIGl0ZW1zKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbihub2RlcykgewogICAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBub2RlOyBub2RlID0gbm9kZXNbaV07IGkrKykgewogICAgICAgICAgaWYgKG5vZGUuY29udGV4dFNlbGVjdGlvbiA9PSB0aGlzICYmIG5vZGUuc2VsZWN0YWJsZSkgaXRlbXMucHVzaChub2RlKTsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLm11bHRpcGxlKSBpdGVtcy5zcGxpY2UoMSk7CiAgICAgICAgcmV0dXJuIERhdGFzZXQucHJvdG90eXBlLnNldC5jYWxsKHRoaXMsIGl0ZW1zKTsKICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgREVMRUdBVEU6IERFTEVHQVRFLAogICAgICBBYnN0cmFjdE5vZGU6IEFic3RyYWN0Tm9kZSwKICAgICAgTm9kZTogTm9kZSwKICAgICAgR3JvdXBpbmdOb2RlOiBHcm91cGluZ05vZGUsCiAgICAgIFBhcnRpdGlvbk5vZGU6IFBhcnRpdGlvbk5vZGUsCiAgICAgIENoaWxkTm9kZXNEYXRhc2V0OiBDaGlsZE5vZGVzRGF0YXNldCwKICAgICAgU2VsZWN0aW9uOiBTZWxlY3Rpb24sCiAgICAgIG51bGxTZWxlY3Rpb246IG5ldyBSZWFkT25seURhdGFzZXQKICAgIH07CiAgfSwKICAiNi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8yLmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgY2xlYW5lciA9IGJhc2lzLmNsZWFuZXI7CiAgICB2YXIgcGF0aCA9IGJhc2lzLnBhdGg7CiAgICB2YXIgYXJyYXlTZWFyY2ggPSBiYXNpcy5hcnJheS5zZWFyY2g7CiAgICB2YXIgYXJyYXlBZGQgPSBiYXNpcy5hcnJheS5hZGQ7CiAgICB2YXIgYXJyYXlSZW1vdmUgPSBiYXNpcy5hcnJheS5yZW1vdmU7CiAgICB2YXIgdGVtcGxhdGVMaXN0ID0gW107CiAgICB2YXIgdG1wbEZpbGVzTWFwID0ge307CiAgICB2YXIgREVDTEFSQVRJT05fVkVSU0lPTiA9IDI7CiAgICB2YXIgVFlQRV9FTEVNRU5UID0gMTsKICAgIHZhciBUWVBFX0FUVFJJQlVURSA9IDI7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEVfQ0xBU1MgPSA0OwogICAgdmFyIFRZUEVfQVRUUklCVVRFX1NUWUxFID0gNTsKICAgIHZhciBUWVBFX0FUVFJJQlVURV9FVkVOVCA9IDY7CiAgICB2YXIgVFlQRV9URVhUID0gMzsKICAgIHZhciBUWVBFX0NPTU1FTlQgPSA4OwogICAgdmFyIFRPS0VOX1RZUEUgPSAwOwogICAgdmFyIFRPS0VOX0JJTkRJTkdTID0gMTsKICAgIHZhciBUT0tFTl9SRUZTID0gMjsKICAgIHZhciBBVFRSX05BTUUgPSAzOwogICAgdmFyIEFUVFJfVkFMVUUgPSA0OwogICAgdmFyIEFUVFJfRVZFTlRfUlggPSAvXmV2ZW50LSguKykkLzsKICAgIHZhciBBVFRSX05BTUVfQllfVFlQRSA9IHsKICAgICAgNDogImNsYXNzIiwKICAgICAgNTogInN0eWxlIgogICAgfTsKICAgIHZhciBBVFRSX1RZUEVfQllfTkFNRSA9IHsKICAgICAgImNsYXNzIjogVFlQRV9BVFRSSUJVVEVfQ0xBU1MsCiAgICAgIHN0eWxlOiBUWVBFX0FUVFJJQlVURV9TVFlMRQogICAgfTsKICAgIHZhciBBVFRSX1ZBTFVFX0lOREVYID0gewogICAgICAyOiBBVFRSX1ZBTFVFLAogICAgICA0OiBBVFRSX1ZBTFVFIC0gMSwKICAgICAgNTogQVRUUl9WQUxVRSAtIDEsCiAgICAgIDY6IDIKICAgIH07CiAgICB2YXIgRUxFTUVOVF9OQU1FID0gMzsKICAgIHZhciBFTEVNRU5UX0FUVFJTID0gNDsKICAgIHZhciBFTEVNRU5UX0NISUxEUyA9IDU7CiAgICB2YXIgVEVYVF9WQUxVRSA9IDM7CiAgICB2YXIgQ09NTUVOVF9WQUxVRSA9IDM7CiAgICB2YXIgU1lOVEFYX0VSUk9SID0gIkludmFsaWQgb3IgdW5zdXBwb3J0ZWQgc3ludGF4IjsKICAgIHZhciBURVhUID0gLygoPzoufFtcclxuXSkqPykoXHsoPzpsMTBuOihbYS16QS1aX11bYS16QS1aMC05X1wtXSooPzpcLlthLXpBLVpfXVthLXpBLVowLTlfXC1dKikqKD86XC5ce1thLXpBLVpfXVthLXpBLVowLTlfXC1dKlx9KT8pXH0pP3w8KFwvfCEtLShccypceyk/KT98JCkvZzsKICAgIHZhciBUQUdfTkFNRSA9IC8oW2Etel9dW2EtejAtOVwtX10qKSg6fFx7fFxzKihcLz8+KT8pL2lnOwogICAgdmFyIEFUVFJJQlVURV9OQU1FX09SX0VORCA9IC8oW2Etel9dW2EtejAtOV9cLV0qKSg6fFx7fD18XHMqKXwoXC8/PikvaWc7CiAgICB2YXIgQ09NTUVOVCA9IC8oLnxbXHJcbl0pKj8tLT4vZzsKICAgIHZhciBDTE9TRV9UQUcgPSAvKFthLXpfXVthLXowLTlfXC1dKig/OjpbYS16X11bYS16MC05X1wtXSopPyk+L2lnOwogICAgdmFyIFJFRkVSRU5DRSA9IC8oW2Etel9dW2EtejAtOV9dKikoXHx8XH1ccyopL2lnOwogICAgdmFyIEFUVFJJQlVURV9WQUxVRSA9IC8iKCg/OihcXCIpfFteIl0pKj8pIlxzKi9nOwogICAgdmFyIEJSRUFLX1RBR19QQVJTRSA9IC9eL2c7CiAgICB2YXIgU0lOR0xFVE9OX1RBRyA9IC9eKGFyZWF8YmFzZXxicnxjb2x8Y29tbWFuZHxlbWJlZHxocnxpbWd8aW5wdXR8bGlua3xtZXRhfHBhcmFtfHNvdXJjZSkkL2k7CiAgICB2YXIgVEFHX0lHTk9SRV9DT05URU5UID0gewogICAgICB0ZXh0OiAvKCg/Oi58W1xyXG5dKSo/KSg/OjxcL2I6dGV4dD58JCkvZywKICAgICAgc3R5bGU6IC8oKD86LnxbXHJcbl0pKj8pKD86PFwvYjpzdHlsZT58JCkvZwogICAgfTsKICAgIHZhciBxdW90ZVVuZXNjYXBlID0gL1xcIi9nOwogICAgdmFyIHRva2VuaXplID0gZnVuY3Rpb24oc291cmNlKSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgdmFyIHRhZ1N0YWNrID0gW107CiAgICAgIHZhciBsYXN0VGFnID0gewogICAgICAgIGNoaWxkczogcmVzdWx0CiAgICAgIH07CiAgICAgIHZhciBzb3VyY2VUZXh0OwogICAgICB2YXIgdG9rZW47CiAgICAgIHZhciBidWZmZXJQb3M7CiAgICAgIHZhciBzdGFydFBvczsKICAgICAgdmFyIHBhcnNlVGFnID0gZmFsc2U7CiAgICAgIHZhciB0ZXh0U3RhdGVFbmRQb3MgPSAwOwogICAgICB2YXIgdGV4dEVuZFBvczsKICAgICAgdmFyIHN0YXRlID0gVEVYVDsKICAgICAgdmFyIHBvcyA9IDA7CiAgICAgIHZhciBtOwogICAgICBzb3VyY2UgPSBzb3VyY2UudHJpbSgpOwogICAgICByZXN1bHQud2FybnMgPSBbXTsKICAgICAgd2hpbGUgKHBvcyA8IHNvdXJjZS5sZW5ndGggfHwgc3RhdGUgIT0gVEVYVCkgewogICAgICAgIHN0YXRlLmxhc3RJbmRleCA9IHBvczsKICAgICAgICBzdGFydFBvcyA9IHBvczsKICAgICAgICBtID0gc3RhdGUuZXhlYyhzb3VyY2UpOwogICAgICAgIGlmICghbSB8fCBtLmluZGV4ICE9PSBwb3MpIHsKICAgICAgICAgIGlmIChzdGF0ZSA9PSBSRUZFUkVOQ0UgJiYgdG9rZW4gJiYgdG9rZW4udHlwZSA9PSBUWVBFX0NPTU1FTlQpIHsKICAgICAgICAgICAgc3RhdGUgPSBDT01NRU5UOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXJzZVRhZykgbGFzdFRhZyA9IHRhZ1N0YWNrLnBvcCgpOwogICAgICAgICAgaWYgKHRva2VuKSBsYXN0VGFnLmNoaWxkcy5wb3AoKTsKICAgICAgICAgIGlmICh0b2tlbiA9IGxhc3RUYWcuY2hpbGRzLnBvcCgpKSB7CiAgICAgICAgICAgIGlmICh0b2tlbi50eXBlID09IFRZUEVfVEVYVCAmJiAhdG9rZW4ucmVmcykgdGV4dFN0YXRlRW5kUG9zIC09ICJsZW4iIGluIHRva2VuID8gdG9rZW4ubGVuIDogdG9rZW4udmFsdWUubGVuZ3RoOyBlbHNlIGxhc3RUYWcuY2hpbGRzLnB1c2godG9rZW4pOwogICAgICAgICAgfQogICAgICAgICAgcGFyc2VUYWcgPSBmYWxzZTsKICAgICAgICAgIHN0YXRlID0gVEVYVDsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBwb3MgPSBzdGF0ZS5sYXN0SW5kZXg7CiAgICAgICAgc3dpdGNoIChzdGF0ZSkgewogICAgICAgICAgY2FzZSBURVhUOgogICAgICAgICAgICB0ZXh0RW5kUG9zID0gc3RhcnRQb3MgKyBtWzFdLmxlbmd0aDsKICAgICAgICAgICAgaWYgKHRleHRTdGF0ZUVuZFBvcyAhPSB0ZXh0RW5kUG9zKSB7CiAgICAgICAgICAgICAgc291cmNlVGV4dCA9IHRleHRTdGF0ZUVuZFBvcyA9PSBzdGFydFBvcyA/IG1bMV0gOiBzb3VyY2Uuc3Vic3RyaW5nKHRleHRTdGF0ZUVuZFBvcywgdGV4dEVuZFBvcyk7CiAgICAgICAgICAgICAgdG9rZW4gPSBzb3VyY2VUZXh0LnJlcGxhY2UoL1xzKihcclxuP3xcblxyPylccyovZywgIiIpOwogICAgICAgICAgICAgIGlmICh0b2tlbikgbGFzdFRhZy5jaGlsZHMucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX1RFWFQsCiAgICAgICAgICAgICAgICBsZW46IHNvdXJjZVRleHQubGVuZ3RoLAogICAgICAgICAgICAgICAgdmFsdWU6IHRva2VuCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGV4dFN0YXRlRW5kUG9zID0gdGV4dEVuZFBvczsKICAgICAgICAgICAgaWYgKG1bM10pIHsKICAgICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfVEVYVCwKICAgICAgICAgICAgICAgIHJlZnM6IFsgImwxMG46IiArIG1bM10gXSwKICAgICAgICAgICAgICAgIHZhbHVlOiAie2wxMG46IiArIG1bM10gKyAifSIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtWzJdID09ICJ7IikgewogICAgICAgICAgICAgIGJ1ZmZlclBvcyA9IHBvcyAtIDE7CiAgICAgICAgICAgICAgbGFzdFRhZy5jaGlsZHMucHVzaCh0b2tlbiA9IHsKICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfVEVYVAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHN0YXRlID0gUkVGRVJFTkNFOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1bNF0pIHsKICAgICAgICAgICAgICBpZiAobVs0XSA9PSAiLyIpIHsKICAgICAgICAgICAgICAgIHRva2VuID0gbnVsbDsKICAgICAgICAgICAgICAgIHN0YXRlID0gQ0xPU0VfVEFHOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHRva2VuID0gewogICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0NPTU1FTlQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKG1bNV0pIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyUG9zID0gcG9zIC0gbVs1XS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIHN0YXRlID0gUkVGRVJFTkNFOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgYnVmZmVyUG9zID0gcG9zOwogICAgICAgICAgICAgICAgICBzdGF0ZSA9IENPTU1FTlQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG1bMl0pIHsKICAgICAgICAgICAgICBwYXJzZVRhZyA9IHRydWU7CiAgICAgICAgICAgICAgdGFnU3RhY2sucHVzaChsYXN0VGFnKTsKICAgICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHRva2VuID0gewogICAgICAgICAgICAgICAgdHlwZTogVFlQRV9FTEVNRU5ULAogICAgICAgICAgICAgICAgYXR0cnM6IFtdLAogICAgICAgICAgICAgICAgY2hpbGRzOiBbXQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGxhc3RUYWcgPSB0b2tlbjsKICAgICAgICAgICAgICBzdGF0ZSA9IFRBR19OQU1FOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBDTE9TRV9UQUc6CiAgICAgICAgICAgIGlmIChtWzFdICE9PSAobGFzdFRhZy5wcmVmaXggPyBsYXN0VGFnLnByZWZpeCArICI6IiA6ICIiKSArIGxhc3RUYWcubmFtZSkgewogICAgICAgICAgICAgIGxhc3RUYWcuY2hpbGRzLnB1c2goewogICAgICAgICAgICAgICAgdHlwZTogVFlQRV9URVhULAogICAgICAgICAgICAgICAgdmFsdWU6ICI8LyIgKyBtWzBdCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBsYXN0VGFnID0gdGFnU3RhY2sucG9wKCk7CiAgICAgICAgICAgIHN0YXRlID0gVEVYVDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIFRBR19OQU1FOgogICAgICAgICAgY2FzZSBBVFRSSUJVVEVfTkFNRV9PUl9FTkQ6CiAgICAgICAgICAgIGlmIChtWzJdID09ICI6IikgewogICAgICAgICAgICAgIGlmICh0b2tlbi5wcmVmaXgpIHN0YXRlID0gQlJFQUtfVEFHX1BBUlNFOyBlbHNlIHRva2VuLnByZWZpeCA9IG1bMV07CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1bMV0pIHsKICAgICAgICAgICAgICB0b2tlbi5uYW1lID0gbVsxXTsKICAgICAgICAgICAgICBpZiAodG9rZW4udHlwZSA9PSBUWVBFX0FUVFJJQlVURSkgbGFzdFRhZy5hdHRycy5wdXNoKHRva2VuKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobVsyXSA9PSAieyIpIHsKICAgICAgICAgICAgICBpZiAodG9rZW4udHlwZSA9PSBUWVBFX0VMRU1FTlQpIHN0YXRlID0gUkVGRVJFTkNFOyBlbHNlIHN0YXRlID0gQlJFQUtfVEFHX1BBUlNFOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChtWzNdKSB7CiAgICAgICAgICAgICAgcGFyc2VUYWcgPSBmYWxzZTsKICAgICAgICAgICAgICBpZiAobVszXSA9PSAiLz4iIHx8ICFsYXN0VGFnLnByZWZpeCAmJiBTSU5HTEVUT05fVEFHLnRlc3QobGFzdFRhZy5uYW1lKSkgewogICAgICAgICAgICAgICAgaWYgKG1bM10gIT0gIi8+IikgcmVzdWx0Lndhcm5zLnB1c2goIlRhZyA8IiArIGxhc3RUYWcubmFtZSArICI+IGRvZXNuJ3QgY2xvc2VkIGV4cGxpY2l0ICh1c2UgYC8+YCBhcyB0YWcgZW5kaW5nKSIpOwogICAgICAgICAgICAgICAgbGFzdFRhZyA9IHRhZ1N0YWNrLnBvcCgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAobGFzdFRhZy5wcmVmaXggPT0gImIiICYmIGxhc3RUYWcubmFtZSBpbiBUQUdfSUdOT1JFX0NPTlRFTlQpIHsKICAgICAgICAgICAgICAgICAgc3RhdGUgPSBUQUdfSUdOT1JFX0NPTlRFTlRbbGFzdFRhZy5uYW1lXTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN0YXRlID0gVEVYVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobVsyXSA9PSAiPSIpIHsKICAgICAgICAgICAgICBzdGF0ZSA9IEFUVFJJQlVURV9WQUxVRTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB0b2tlbiA9IHsKICAgICAgICAgICAgICB0eXBlOiBUWVBFX0FUVFJJQlVURQogICAgICAgICAgICB9OwogICAgICAgICAgICBzdGF0ZSA9IEFUVFJJQlVURV9OQU1FX09SX0VORDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIENPTU1FTlQ6CiAgICAgICAgICAgIHRva2VuLnZhbHVlID0gc291cmNlLnN1YnN0cmluZyhidWZmZXJQb3MsIHBvcyAtIDMpOwogICAgICAgICAgICBzdGF0ZSA9IFRFWFQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBSRUZFUkVOQ0U6CiAgICAgICAgICAgIGlmICh0b2tlbi5yZWZzKSB0b2tlbi5yZWZzLnB1c2gobVsxXSk7IGVsc2UgdG9rZW4ucmVmcyA9IFsgbVsxXSBdOwogICAgICAgICAgICBpZiAobVsyXSAhPSAifCIpIHsKICAgICAgICAgICAgICBpZiAodG9rZW4udHlwZSA9PSBUWVBFX1RFWFQpIHsKICAgICAgICAgICAgICAgIHBvcyAtPSBtWzJdLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgICB0b2tlbi52YWx1ZSA9IHNvdXJjZS5zdWJzdHJpbmcoYnVmZmVyUG9zLCBwb3MpOwogICAgICAgICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodG9rZW4udHlwZSA9PSBUWVBFX0NPTU1FTlQpIHsKICAgICAgICAgICAgICAgIHN0YXRlID0gQ09NTUVOVDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRva2VuLnR5cGUgPT0gVFlQRV9BVFRSSUJVVEUgJiYgc291cmNlW3Bvc10gPT0gIj0iKSB7CiAgICAgICAgICAgICAgICBwb3MrKzsKICAgICAgICAgICAgICAgIHN0YXRlID0gQVRUUklCVVRFX1ZBTFVFOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0b2tlbiA9IHsKICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9BVFRSSUJVVEUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBzdGF0ZSA9IEFUVFJJQlVURV9OQU1FX09SX0VORDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIEFUVFJJQlVURV9WQUxVRToKICAgICAgICAgICAgdG9rZW4udmFsdWUgPSBtWzFdLnJlcGxhY2UocXVvdGVVbmVzY2FwZSwgJyInKTsKICAgICAgICAgICAgdG9rZW4gPSB7CiAgICAgICAgICAgICAgdHlwZTogVFlQRV9BVFRSSUJVVEUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgc3RhdGUgPSBBVFRSSUJVVEVfTkFNRV9PUl9FTkQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBUQUdfSUdOT1JFX0NPTlRFTlQudGV4dDoKICAgICAgICAgIGNhc2UgVEFHX0lHTk9SRV9DT05URU5ULnN0eWxlOgogICAgICAgICAgICBsYXN0VGFnLmNoaWxkcy5wdXNoKHsKICAgICAgICAgICAgICB0eXBlOiBUWVBFX1RFWFQsCiAgICAgICAgICAgICAgdmFsdWU6IG1bMV0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGxhc3RUYWcgPSB0YWdTdGFjay5wb3AoKTsKICAgICAgICAgICAgc3RhdGUgPSBURVhUOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHRocm93ICJQYXJzZXIgYnVnIjsKICAgICAgICB9CiAgICAgICAgaWYgKHN0YXRlID09IFRFWFQpIHRleHRTdGF0ZUVuZFBvcyA9IHBvczsKICAgICAgfQogICAgICBpZiAodGV4dFN0YXRlRW5kUG9zICE9IHBvcykgbGFzdFRhZy5jaGlsZHMucHVzaCh7CiAgICAgICAgdHlwZTogVFlQRV9URVhULAogICAgICAgIHZhbHVlOiBzb3VyY2Uuc3Vic3RyaW5nKHRleHRTdGF0ZUVuZFBvcywgcG9zKQogICAgICB9KTsKICAgICAgaWYgKGxhc3RUYWcubmFtZSkgcmVzdWx0Lndhcm5zLnB1c2goIk5vIGNsb3NlIHRhZyBmb3IgPCIgKyBsYXN0VGFnLm5hbWUgKyAiPiIpOwogICAgICBpZiAoIXJlc3VsdC53YXJucy5sZW5ndGgpIGRlbGV0ZSByZXN1bHQud2FybnM7CiAgICAgIHJlc3VsdC50ZW1wbGF0ZVRva2VucyA9IHRydWU7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgdmFyIHRva2VuVGVtcGxhdGUgPSB7fTsKICAgIHZhciBMMTBuUHJveHlUb2tlbiA9IGJhc2lzLlRva2VuLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkwxMG5Qcm94eVRva2VuIiwKICAgICAgdG9rZW46IG51bGwsCiAgICAgIHVybDogIiIsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgICAgdGhpcy51cmwgPSB0b2tlbi5kaWN0aW9uYXJ5LnJlc291cmNlLnVybCArICI6IiArIHRva2VuLm5hbWU7CiAgICAgICAgdGhpcy50b2tlbiA9IHRva2VuOwogICAgICAgIHRoaXMuc2V0KCk7CiAgICAgICAgdG9rZW4uYXR0YWNoKHRoaXMuc2V0LCB0aGlzKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYmFzaXMuVG9rZW4ucHJvdG90eXBlLnNldC5jYWxsKHRoaXMsIHRoaXMudG9rZW4udHlwZSA9PSAibWFya3VwIiA/IHByb2Nlc3NNYXJrdXAodGhpcy50b2tlbi52YWx1ZSwgdGhpcy50b2tlbi5uYW1lICsgIkAiICsgdGhpcy50b2tlbi5kaWN0aW9uYXJ5LnJlc291cmNlLnVybCkgOiAiIik7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGJhc2lzLlRva2VuLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy50b2tlbiA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gcHJvY2Vzc01hcmt1cCh2YWx1ZSwgaWQpIHsKICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz0iYmFzaXNqcy1tYXJrdXAiIGRhdGEtYmFzaXNqcy1sMTBuPSInICsgaWQgKyAnIj4nICsgU3RyaW5nKHZhbHVlKSArICI8L3NwYW4+IjsKICAgIH0KICAgIGZ1bmN0aW9uIGdldEwxMG5UZW1wbGF0ZSh0b2tlbikgewogICAgICBpZiAodHlwZW9mIHRva2VuID09ICJzdHJpbmciKSB0b2tlbiA9IGJhc2lzLmwxMG4udG9rZW4odG9rZW4pOwogICAgICBpZiAoIXRva2VuKSByZXR1cm4gbnVsbDsKICAgICAgdmFyIGlkID0gdG9rZW4uYmFzaXNPYmplY3RJZDsKICAgICAgdmFyIHRlbXBsYXRlID0gdG9rZW5UZW1wbGF0ZVtpZF07CiAgICAgIGlmICghdGVtcGxhdGUpIHRlbXBsYXRlID0gdG9rZW5UZW1wbGF0ZVtpZF0gPSBuZXcgVGVtcGxhdGUobmV3IEwxMG5Qcm94eVRva2VuKHRva2VuKSk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KICAgIGZ1bmN0aW9uIGdlbklzb2xhdGVNYXJrZXIoKSB7CiAgICAgIHJldHVybiAiaSIgKyBiYXNpcy5nZW5VSUQoKSArICJfXyI7CiAgICB9CiAgICBmdW5jdGlvbiBpc29sYXRlQ3NzKGNzcywgcHJlZml4KSB7CiAgICAgIGZ1bmN0aW9uIGFkZE1hdGNoKHByZWZpeCkgewogICAgICAgIGlmIChpID4gbGFzdE1hdGNoUG9zKSB7CiAgICAgICAgICByZXN1bHQucHVzaCgocHJlZml4IHx8ICIiKSArIGNzcy5zdWJzdHJpbmcobGFzdE1hdGNoUG9zLCBpKSk7CiAgICAgICAgICBsYXN0TWF0Y2hQb3MgPSBpOwogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIHZhciBzeW0gPSBjc3Muc3BsaXQoIiIpOwogICAgICB2YXIgbGVuID0gc3ltLmxlbmd0aDsKICAgICAgdmFyIGxhc3RNYXRjaFBvcyA9IDA7CiAgICAgIHZhciBibG9ja1Njb3BlID0gZmFsc2U7CiAgICAgIHZhciBzdHJTeW07CiAgICAgIGlmICghcHJlZml4KSBwcmVmaXggPSBnZW5Jc29sYXRlTWFya2VyKCk7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBzd2l0Y2ggKHN5bVtpXSkgewogICAgICAgICAgY2FzZSAiJyI6CiAgICAgICAgICBjYXNlICciJzoKICAgICAgICAgICAgc3RyU3ltID0gc3ltW2ldOwogICAgICAgICAgICB3aGlsZSAoKytpIDwgbGVuKSB7CiAgICAgICAgICAgICAgaWYgKHN5bVtpXSA9PSAiXFwiKSBpKys7IGVsc2UgaWYgKHN5bVtpXSA9PSBzdHJTeW0pIHsKICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIi8iOgogICAgICAgICAgICBpZiAoc3ltW2kgKyAxXSA9PSAiKiIpIHsKICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgd2hpbGUgKCsraSA8IGxlbikgaWYgKHN5bVtpXSA9PSAiKiIgJiYgc3ltW2kgKyAxXSA9PSAiLyIpIHsKICAgICAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgInsiOgogICAgICAgICAgICBibG9ja1Njb3BlID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJ9IjoKICAgICAgICAgICAgYmxvY2tTY29wZSA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIi4iOgogICAgICAgICAgICBpZiAoIWJsb2NrU2NvcGUpIHsKICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgYWRkTWF0Y2goKTsKICAgICAgICAgICAgICB3aGlsZSAoKytpIDwgbGVuKSBpZiAoIS9bYS16MC05XC1cX10vLnRlc3Qoc3ltW2ldKSkgewogICAgICAgICAgICAgICAgYWRkTWF0Y2gocHJlZml4KTsKICAgICAgICAgICAgICAgIGkgLT0gMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgYWRkTWF0Y2goKTsKICAgICAgcmV0dXJuIHJlc3VsdC5qb2luKCIiKTsKICAgIH0KICAgIHZhciBtYWtlRGVjbGFyYXRpb24gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIElERU5UID0gL15bYS16X11bYS16MC05X1wtXSokL2k7CiAgICAgIHZhciBDTEFTU19BVFRSX1BBUlRTID0gLyhcUyspL2c7CiAgICAgIHZhciBDTEFTU19BVFRSX0JJTkRJTkcgPSAvXigoPzpbYS16X11bYS16MC05X1wtXSopPyg/OjooPzpbYS16X11bYS16MC05X1wtXSopPyk/KVx7KChhbmltOik/W2Etel9dW2EtejAtOV9cLV0qKVx9JC9pOwogICAgICB2YXIgU1RZTEVfQVRUUl9QQVJUUyA9IC9ccypbXjpdKz9ccyo6KD86XCguKj9cKXwiLio/InwnLio/J3xbXjtdKz8pKyg/Ojt8JCkvZ2k7CiAgICAgIHZhciBTVFlMRV9QUk9QRVJUWSA9IC9ccyooW146XSs/KVxzKjooKD86XCguKj9cKXwiLio/InwnLio/J3xbXjtdKz8pKyk7PyQvaTsKICAgICAgdmFyIFNUWUxFX0FUVFJfQklORElORyA9IC9ceyhbYS16X11bYS16MC05X10qKVx9L2k7CiAgICAgIHZhciBBVFRSX0JJTkRJTkcgPSAvXHsoW2Etel9dW2EtejAtOV9dKnxsMTBuOlthLXpfXVthLXowLTlfXSooPzpcLlthLXpfXVthLXowLTlfXSopKig/OlwuXHtbYS16X11bYS16MC05X10qXH0pPylcfS9pOwogICAgICB2YXIgTkFNRURfQ0hBUkFDVEVSX1JFRiA9IC8mKFthLXpdK3wjWzAtOV0rfCN4WzAtOWEtZl17MSw0fSk7Py9naTsKICAgICAgdmFyIHRva2VuTWFwID0gYmFzaXMuTk9ERV9FTlYgPyBfX25vZGVqc1JlcXVpcmUoIi4vdGVtcGxhdGUvaHRtbGVudGl0eS5qc29uIikgOiB7fTsKICAgICAgdmFyIHRva2VuRWxlbWVudCA9ICFiYXNpcy5OT0RFX0VOViA/IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpIDogbnVsbDsKICAgICAgdmFyIGluY2x1ZGVTdGFjayA9IFtdOwogICAgICB2YXIgc3R5bGVOYW1lc3BhY2VJc29sYXRlID0ge307CiAgICAgIGZ1bmN0aW9uIG5hbWUodG9rZW4pIHsKICAgICAgICByZXR1cm4gKHRva2VuLnByZWZpeCA/IHRva2VuLnByZWZpeCArICI6IiA6ICIiKSArIHRva2VuLm5hbWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbmFtZWRDaGFyUmVwbGFjZShtLCB0b2tlbikgewogICAgICAgIGlmICghdG9rZW5NYXBbdG9rZW5dKSB7CiAgICAgICAgICBpZiAodG9rZW4uY2hhckF0KDApID09ICIjIikgewogICAgICAgICAgICB0b2tlbk1hcFt0b2tlbl0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKHRva2VuLmNoYXJBdCgxKSA9PSAieCIgfHwgdG9rZW4uY2hhckF0KDEpID09ICJYIiA/IHBhcnNlSW50KHRva2VuLnN1YnN0cigyKSwgMTYpIDogdG9rZW4uc3Vic3RyKDEpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0b2tlbkVsZW1lbnQpIHsKICAgICAgICAgICAgICB0b2tlbkVsZW1lbnQuaW5uZXJIVE1MID0gbTsKICAgICAgICAgICAgICB0b2tlbk1hcFt0b2tlbl0gPSB0b2tlbkVsZW1lbnQuZmlyc3RDaGlsZCA/IHRva2VuRWxlbWVudC5maXJzdENoaWxkLm5vZGVWYWx1ZSA6IG07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuTWFwW3Rva2VuXSB8fCBtOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHVudG9rZW4odmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUucmVwbGFjZShOQU1FRF9DSEFSQUNURVJfUkVGLCBuYW1lZENoYXJSZXBsYWNlKTsKICAgICAgfQogICAgICBmdW5jdGlvbiByZWZMaXN0KHRva2VuKSB7CiAgICAgICAgdmFyIGFycmF5ID0gdG9rZW4ucmVmczsKICAgICAgICBpZiAoIWFycmF5IHx8ICFhcnJheS5sZW5ndGgpIHJldHVybiAwOwogICAgICAgIHJldHVybiBhcnJheTsKICAgICAgfQogICAgICBmdW5jdGlvbiBidWlsZEF0dHJFeHByZXNzaW9uKHBhcnRzKSB7CiAgICAgICAgdmFyIGJpbmROYW1lOwogICAgICAgIHZhciBuYW1lcyA9IFtdOwogICAgICAgIHZhciBleHByZXNzaW9uID0gW107CiAgICAgICAgdmFyIG1hcCA9IHt9OwogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcGFydHMubGVuZ3RoOyBqKyspIGlmIChqICUgMikgewogICAgICAgICAgYmluZE5hbWUgPSBwYXJ0c1tqXTsKICAgICAgICAgIGlmICghbWFwW2JpbmROYW1lXSkgewogICAgICAgICAgICBtYXBbYmluZE5hbWVdID0gbmFtZXMubGVuZ3RoOwogICAgICAgICAgICBuYW1lcy5wdXNoKGJpbmROYW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIGV4cHJlc3Npb24ucHVzaChtYXBbYmluZE5hbWVdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHBhcnRzW2pdKSBleHByZXNzaW9uLnB1c2godW50b2tlbihwYXJ0c1tqXSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gWyBuYW1lcywgZXhwcmVzc2lvbiBdOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHByb2Nlc3NBdHRyKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgdmFyIGJpbmRpbmdzID0gMDsKICAgICAgICB2YXIgcGFydHM7CiAgICAgICAgdmFyIG07CiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgICAgIGlmIChwYXJ0cyA9IHZhbHVlLm1hdGNoKENMQVNTX0FUVFJfUEFSVFMpKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBbXTsKICAgICAgICAgICAgICAgIGJpbmRpbmdzID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgcGFydDsgcGFydCA9IHBhcnRzW2pdOyBqKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKG0gPSBwYXJ0Lm1hdGNoKENMQVNTX0FUVFJfQklORElORykpIGJpbmRpbmdzLnB1c2goWyBtWzFdIHx8ICIiLCBtWzJdIF0pOyBlbHNlIG5ld1ZhbHVlLnB1c2gocGFydCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YWx1ZSA9IG5ld1ZhbHVlLmpvaW4oIiAiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBbXTsKICAgICAgICAgICAgICBiaW5kaW5ncyA9IFtdOwogICAgICAgICAgICAgIGlmIChwYXJ0cyA9IHZhbHVlLm1hdGNoKFNUWUxFX0FUVFJfUEFSVFMpKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgcGFydDsgcGFydCA9IHBhcnRzW2pdOyBqKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIG0gPSBwYXJ0Lm1hdGNoKFNUWUxFX1BST1BFUlRZKTsKICAgICAgICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IG1bMV07CiAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG1bMl0udHJpbSgpOwogICAgICAgICAgICAgICAgICB2YXIgdmFsdWVQYXJ0cyA9IHZhbHVlLnNwbGl0KFNUWUxFX0FUVFJfQklORElORyk7CiAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZVBhcnRzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXhwciA9IGJ1aWxkQXR0ckV4cHJlc3Npb24odmFsdWVQYXJ0cyk7CiAgICAgICAgICAgICAgICAgICAgZXhwci5wdXNoKHByb3BlcnR5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgYmluZGluZ3MucHVzaChleHByKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHByb3BzLnB1c2gocHJvcGVydHlOYW1lICsgIjogIiArIHVudG9rZW4odmFsdWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKC9cUy8udGVzdCh2YWx1ZSkpIGJhc2lzLmRldi53YXJuKCJCYWQgdmFsdWUgZm9yIHN0eWxlIGF0dHJpYnV0ZSAodmFsdWUgaWdub3JlZCk6IiwgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YWx1ZSA9IHByb3BzLmpvaW4oIjsgIik7CiAgICAgICAgICAgICAgaWYgKHZhbHVlKSB2YWx1ZSArPSAiOyI7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcGFydHMgPSB2YWx1ZS5zcGxpdChBVFRSX0JJTkRJTkcpOwogICAgICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPiAxKSBiaW5kaW5ncyA9IGJ1aWxkQXR0ckV4cHJlc3Npb24ocGFydHMpOyBlbHNlIHZhbHVlID0gdW50b2tlbih2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChiaW5kaW5ncyAmJiAhYmluZGluZ3MubGVuZ3RoKSBiaW5kaW5ncyA9IDA7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGJpbmRpbmc6IGJpbmRpbmdzLAogICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgdHlwZTogQVRUUl9UWVBFX0JZX05BTUVbbmFtZV0gfHwgMgogICAgICAgIH07CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYXR0cnModG9rZW4sIGRlY2xUb2tlbiwgb3B0aW1pemVTaXplKSB7CiAgICAgICAgdmFyIGF0dHJzID0gdG9rZW4uYXR0cnM7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciBzdHlsZUF0dHI7CiAgICAgICAgdmFyIGRpc3BsYXk7CiAgICAgICAgdmFyIG07CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGF0dHI7IGF0dHIgPSBhdHRyc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAoYXR0ci5wcmVmaXggPT0gImIiKSB7CiAgICAgICAgICAgIHN3aXRjaCAoYXR0ci5uYW1lKSB7CiAgICAgICAgICAgICAgY2FzZSAicmVmIjoKICAgICAgICAgICAgICAgIHZhciByZWZzID0gKGF0dHIudmFsdWUgfHwgIiIpLnRyaW0oKS5zcGxpdCgvXHMrLyk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJlZnMubGVuZ3RoOyBqKyspIGFkZFRva2VuUmVmKGRlY2xUb2tlbiwgcmVmc1tqXSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzaG93IjoKICAgICAgICAgICAgICBjYXNlICJoaWRlIjoKICAgICAgICAgICAgICAgIGRpc3BsYXkgPSBhdHRyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobSA9IGF0dHIubmFtZS5tYXRjaChBVFRSX0VWRU5UX1JYKSkgewogICAgICAgICAgICByZXN1bHQucHVzaChtWzFdID09IGF0dHIudmFsdWUgPyBbIFRZUEVfQVRUUklCVVRFX0VWRU5ULCBtWzFdIF0gOiBbIFRZUEVfQVRUUklCVVRFX0VWRU5ULCBtWzFdLCBhdHRyLnZhbHVlIF0pOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwYXJzZWQgPSBwcm9jZXNzQXR0cihhdHRyLm5hbWUsIGF0dHIudmFsdWUpOwogICAgICAgICAgdmFyIGl0ZW0gPSBbIHBhcnNlZC50eXBlLCBwYXJzZWQuYmluZGluZywgcmVmTGlzdChhdHRyKSBdOwogICAgICAgICAgaWYgKHBhcnNlZC50eXBlID09IDIpIGl0ZW0ucHVzaChuYW1lKGF0dHIpKTsKICAgICAgICAgIGlmIChwYXJzZWQudmFsdWUgJiYgKCFvcHRpbWl6ZVNpemUgfHwgIXBhcnNlZC5iaW5kaW5nIHx8IHBhcnNlZC50eXBlICE9IDIpKSBpdGVtLnB1c2gocGFyc2VkLnZhbHVlKTsKICAgICAgICAgIGlmIChwYXJzZWQudHlwZSA9PSBUWVBFX0FUVFJJQlVURV9TVFlMRSkgc3R5bGVBdHRyID0gaXRlbTsKICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pOwogICAgICAgIH0KICAgICAgICBpZiAoZGlzcGxheSkgewogICAgICAgICAgaWYgKCFzdHlsZUF0dHIpIHsKICAgICAgICAgICAgc3R5bGVBdHRyID0gWyBUWVBFX0FUVFJJQlVURV9TVFlMRSwgMCwgMCBdOwogICAgICAgICAgICByZXN1bHQucHVzaChzdHlsZUF0dHIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFzdHlsZUF0dHJbMV0pIHN0eWxlQXR0clsxXSA9IFtdOwogICAgICAgICAgdmFyIGRpc3BsYXlFeHByID0gYnVpbGRBdHRyRXhwcmVzc2lvbigoZGlzcGxheS52YWx1ZSB8fCBkaXNwbGF5Lm5hbWUpLnNwbGl0KEFUVFJfQklORElORykpOwogICAgICAgICAgaWYgKGRpc3BsYXlFeHByWzBdLmxlbmd0aCAtIGRpc3BsYXlFeHByWzFdLmxlbmd0aCkgewogICAgICAgICAgICBzdHlsZUF0dHJbM10gPSAoc3R5bGVBdHRyWzNdID8gc3R5bGVBdHRyWzNdICsgIjsgIiA6ICIiKSArIChkaXNwbGF5Lm5hbWUgPT0gInNob3ciIF4gZGlzcGxheS52YWx1ZSA9PT0gIiIgPyAiIiA6ICJkaXNwbGF5OiBub25lIik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZGlzcGxheS5uYW1lID09ICJzaG93Iikgc3R5bGVBdHRyWzNdID0gKHN0eWxlQXR0clszXSA/IHN0eWxlQXR0clszXSArICI7ICIgOiAiIikgKyAiZGlzcGxheTogbm9uZSI7CiAgICAgICAgICAgIHN0eWxlQXR0clsxXS5wdXNoKGRpc3BsYXlFeHByLmNvbmNhdCgiZGlzcGxheSIsIGRpc3BsYXkubmFtZSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aCA/IHJlc3VsdCA6IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gYWRkVG9rZW5SZWYodG9rZW4sIHJlZk5hbWUpIHsKICAgICAgICBpZiAoIXRva2VuW1RPS0VOX1JFRlNdKSB0b2tlbltUT0tFTl9SRUZTXSA9IFtdOwogICAgICAgIGFycmF5QWRkKHRva2VuW1RPS0VOX1JFRlNdLCByZWZOYW1lKTsKICAgICAgICBpZiAocmVmTmFtZSAhPSAiZWxlbWVudCIpIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IHRva2VuW1RPS0VOX1JFRlNdLmxlbmd0aCA9PSAxID8gcmVmTmFtZSA6IDA7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVtb3ZlVG9rZW5SZWYodG9rZW4sIHJlZk5hbWUpIHsKICAgICAgICB2YXIgaWR4ID0gdG9rZW5bVE9LRU5fUkVGU10uaW5kZXhPZihyZWZOYW1lKTsKICAgICAgICBpZiAoaWR4ICE9IC0xKSB7CiAgICAgICAgICB2YXIgaW5kZXhCaW5kaW5nID0gdG9rZW5bVE9LRU5fQklORElOR1NdICYmIHR5cGVvZiB0b2tlbltUT0tFTl9CSU5ESU5HU10gPT0gIm51bWJlciI7CiAgICAgICAgICB0b2tlbltUT0tFTl9SRUZTXS5zcGxpY2UoaWR4LCAxKTsKICAgICAgICAgIGlmIChpbmRleEJpbmRpbmcpIGlmIChpZHggPT0gdG9rZW5bVE9LRU5fQklORElOR1NdIC0gMSkgdG9rZW5bVE9LRU5fQklORElOR1NdID0gcmVmTmFtZTsKICAgICAgICAgIGlmICghdG9rZW5bVE9LRU5fUkVGU10ubGVuZ3RoKSB0b2tlbltUT0tFTl9SRUZTXSA9IDA7IGVsc2UgewogICAgICAgICAgICBpZiAoaW5kZXhCaW5kaW5nKSB0b2tlbltUT0tFTl9CSU5ESU5HU10gLT0gaWR4IDwgdG9rZW5bVE9LRU5fQklORElOR1NdIC0gMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdG9rZW5BdHRycyh0b2tlbikgewogICAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgICBpZiAodG9rZW4uYXR0cnMpIGZvciAodmFyIGkgPSAwLCBhdHRyOyBhdHRyID0gdG9rZW4uYXR0cnNbaV07IGkrKykgcmVzdWx0W25hbWUoYXR0cildID0gYXR0ci52YWx1ZTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFkZFVuaXF1ZShhcnJheSwgaXRlbXMpIHsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrKSBhcnJheUFkZChhcnJheSwgaXRlbXNbaV0pOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFkZFN0eWxlcyhhcnJheSwgaXRlbXMsIHByZWZpeCkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gaXRlbXNbaV07IGkrKykgaWYgKGl0ZW1bMV0gIT09IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSkgaXRlbVsxXSA9IHByZWZpeCArIGl0ZW1bMV07CiAgICAgICAgYXJyYXkudW5zaGlmdC5hcHBseShhcnJheSwgaXRlbXMpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFkZFN0eWxlKHRlbXBsYXRlLCB0b2tlbiwgc3JjLCBpc29sYXRlUHJlZml4KSB7CiAgICAgICAgdmFyIHVybDsKICAgICAgICBpZiAoc3JjKSB7CiAgICAgICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3Qoc3JjKSkgYmFzaXMuZGV2Lndhcm4oIkJhZCB1c2FnZTogPGI6IiArIHRva2VuLm5hbWUgKyAnIHNyYz0iJyArIHNyYyArICciLz4uXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLicpOwogICAgICAgICAgdXJsID0gcGF0aC5yZXNvbHZlKHRlbXBsYXRlLmJhc2VVUkkgKyBzcmMpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgdGV4dCA9IHRva2VuLmNoaWxkc1swXTsKICAgICAgICAgIHVybCA9IGJhc2lzLnJlc291cmNlLnZpcnR1YWwoImNzcyIsIHRleHQgPyB0ZXh0LnZhbHVlIDogIiIsIHRlbXBsYXRlLnNvdXJjZVVybCkudXJsOwogICAgICAgIH0KICAgICAgICB0ZW1wbGF0ZS5yZXNvdXJjZXMucHVzaChbIHVybCwgaXNvbGF0ZVByZWZpeCBdKTsKICAgICAgICByZXR1cm4gdXJsOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHByb2Nlc3ModG9rZW5zLCB0ZW1wbGF0ZSwgb3B0aW9ucywgY29udGV4dCkgewogICAgICAgIGZ1bmN0aW9uIG1vZGlmeUF0dHIodG9rZW4sIG5hbWUsIGFjdGlvbikgewogICAgICAgICAgdmFyIGF0dHJzID0gdG9rZW5BdHRycyh0b2tlbik7CiAgICAgICAgICBpZiAobmFtZSkgYXR0cnMubmFtZSA9IG5hbWU7CiAgICAgICAgICBpZiAoIWF0dHJzLm5hbWUpIHsKICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiSW5zdHJ1Y3Rpb24gPGI6IiArIHRva2VuLm5hbWUgKyAiPiBoYXMgbm8gYXR0cmlidXRlIG5hbWUiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFJREVOVC50ZXN0KGF0dHJzLm5hbWUpKSB7CiAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIkJhZCBhdHRyaWJ1dGUgbmFtZSBgIiArIGF0dHJzLm5hbWUgKyAiYCIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5jbHVkZWRUb2tlbiA9IHRva2VuUmVmTWFwW2F0dHJzLnJlZiB8fCAiZWxlbWVudCJdOwogICAgICAgICAgaWYgKGluY2x1ZGVkVG9rZW4pIHsKICAgICAgICAgICAgaWYgKGluY2x1ZGVkVG9rZW4udG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9FTEVNRU5UKSB7CiAgICAgICAgICAgICAgdmFyIGl0QXR0cnMgPSBpbmNsdWRlZFRva2VuLnRva2VuOwogICAgICAgICAgICAgIHZhciBpc0V2ZW50ID0gYXR0cnMubmFtZS5tYXRjaChBVFRSX0VWRU5UX1JYKTsKICAgICAgICAgICAgICB2YXIgaXRUeXBlID0gaXNFdmVudCA/IFRZUEVfQVRUUklCVVRFX0VWRU5UIDogQVRUUl9UWVBFX0JZX05BTUVbYXR0cnMubmFtZV0gfHwgVFlQRV9BVFRSSUJVVEU7CiAgICAgICAgICAgICAgdmFyIHZhbHVlSWR4ID0gQVRUUl9WQUxVRV9JTkRFWFtpdFR5cGVdIHx8IEFUVFJfVkFMVUU7CiAgICAgICAgICAgICAgdmFyIGl0QXR0clRva2VuID0gaXRBdHRycyAmJiBhcnJheVNlYXJjaChpdEF0dHJzLCBhdHRycy5uYW1lLCBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgICAgICAgaWYgKHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfQVRUUklCVVRFX0VWRU5UKSByZXR1cm4gImV2ZW50LSIgKyB0b2tlblsxXTsKICAgICAgICAgICAgICAgIHJldHVybiBBVFRSX05BTUVfQllfVFlQRVt0b2tlbltUT0tFTl9UWVBFXV0gfHwgdG9rZW5bQVRUUl9OQU1FXTsKICAgICAgICAgICAgICB9LCBFTEVNRU5UX0FUVFJTKTsKICAgICAgICAgICAgICBpZiAoIWl0QXR0clRva2VuICYmIGFjdGlvbiAhPSAicmVtb3ZlIikgewogICAgICAgICAgICAgICAgaWYgKGlzRXZlbnQpIHsKICAgICAgICAgICAgICAgICAgaXRBdHRyVG9rZW4gPSBbIGl0VHlwZSwgaXNFdmVudFsxXSBdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgaXRBdHRyVG9rZW4gPSBbIGl0VHlwZSwgMCwgMCwgaXRUeXBlID09IFRZUEVfQVRUUklCVVRFID8gYXR0cnMubmFtZSA6ICIiIF07CiAgICAgICAgICAgICAgICAgIGlmIChpdFR5cGUgPT0gVFlQRV9BVFRSSUJVVEUpIGl0QXR0clRva2VuLnB1c2goIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFpdEF0dHJzKSB7CiAgICAgICAgICAgICAgICAgIGl0QXR0cnMgPSBbXTsKICAgICAgICAgICAgICAgICAgaW5jbHVkZWRUb2tlbi50b2tlbi5wdXNoKGl0QXR0cnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaXRBdHRycy5wdXNoKGl0QXR0clRva2VuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNsYXNzT3JTdHlsZSA9IGF0dHJzLm5hbWUgPT0gImNsYXNzIiB8fCBhdHRycy5uYW1lID09ICJzdHlsZSI7CiAgICAgICAgICAgICAgc3dpdGNoIChhY3Rpb24pIHsKICAgICAgICAgICAgICAgIGNhc2UgInNldCI6CiAgICAgICAgICAgICAgICAgIGlmIChpdEF0dHJUb2tlbltUT0tFTl9UWVBFXSA9PSBUWVBFX0FUVFJJQlVURV9FVkVOVCkgewogICAgICAgICAgICAgICAgICAgIGlmIChhdHRycy52YWx1ZSA9PSBpc0V2ZW50WzFdKSBpdEF0dHJUb2tlbi5sZW5ndGggPSAyOyBlbHNlIGl0QXR0clRva2VuW3ZhbHVlSWR4XSA9IGF0dHJzLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgcGFyc2VkID0gcHJvY2Vzc0F0dHIoYXR0cnMubmFtZSwgYXR0cnMudmFsdWUpOwogICAgICAgICAgICAgICAgICBpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU10gPSBwYXJzZWQuYmluZGluZzsKICAgICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLm9wdGltaXplU2l6ZSB8fCAhaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdIHx8IGNsYXNzT3JTdHlsZSkgaXRBdHRyVG9rZW5bdmFsdWVJZHhdID0gcGFyc2VkLnZhbHVlIHx8ICIiOyBlbHNlIGl0QXR0clRva2VuLmxlbmd0aCA9IHZhbHVlSWR4OwogICAgICAgICAgICAgICAgICBpZiAoY2xhc3NPclN0eWxlKSBpZiAoIWl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXSAmJiAhaXRBdHRyVG9rZW5bdmFsdWVJZHhdKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUoaXRBdHRycywgaXRBdHRyVG9rZW4pOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImFwcGVuZCI6CiAgICAgICAgICAgICAgICAgIHZhciBwYXJzZWQgPSBwcm9jZXNzQXR0cihhdHRycy5uYW1lLCBhdHRycy52YWx1ZSk7CiAgICAgICAgICAgICAgICAgIGlmICghaXNFdmVudCkgewogICAgICAgICAgICAgICAgICAgIGlmIChwYXJzZWQuYmluZGluZykgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJCaW5kaW5ncyA9IGl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHRyQmluZGluZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChhdHRycy5uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAic3R5bGUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZEJpbmRpbmdNYXAgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBvbGRCaW5kaW5nOyBvbGRCaW5kaW5nID0gYXR0ckJpbmRpbmdzW2ldOyBpKyspIG9sZEJpbmRpbmdNYXBbb2xkQmluZGluZ1syXV0gPSBpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5ld0JpbmRpbmc7IG5ld0JpbmRpbmcgPSBwYXJzZWQuYmluZGluZ1tpXTsgaSsrKSBpZiAobmV3QmluZGluZ1syXSBpbiBvbGRCaW5kaW5nTWFwKSBhdHRyQmluZGluZ3Nbb2xkQmluZGluZ01hcFtuZXdCaW5kaW5nWzJdXV0gPSBuZXdCaW5kaW5nOyBlbHNlIGF0dHJCaW5kaW5ncy5wdXNoKG5ld0JpbmRpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiY2xhc3MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ckJpbmRpbmdzLnB1c2guYXBwbHkoYXR0ckJpbmRpbmdzLCBwYXJzZWQuYmluZGluZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VkLmJpbmRpbmdbMF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5QWRkKHRoaXMsIG5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgYXR0ckJpbmRpbmdzWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyc2VkLmJpbmRpbmdbMV0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gcGFyc2VkLmJpbmRpbmdbMV1baV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gIm51bWJlciIpIHZhbHVlID0gYXR0ckJpbmRpbmdzWzBdLmluZGV4T2YocGFyc2VkLmJpbmRpbmdbMF1bdmFsdWVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ckJpbmRpbmdzWzFdLnB1c2godmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU10gPSBwYXJzZWQuYmluZGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjbGFzc09yU3R5bGUpIGl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXVsxXS51bnNoaWZ0KGl0QXR0clRva2VuW3ZhbHVlSWR4XSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghY2xhc3NPclN0eWxlICYmIGl0QXR0clRva2VuW1RPS0VOX0JJTkRJTkdTXSkgaXRBdHRyVG9rZW5bVE9LRU5fQklORElOR1NdWzFdLnB1c2goYXR0cnMudmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAocGFyc2VkLnZhbHVlKSBpdEF0dHJUb2tlblt2YWx1ZUlkeF0gPSAoaXRBdHRyVG9rZW5bdmFsdWVJZHhdIHx8ICIiKSArIChpdEF0dHJUb2tlblt2YWx1ZUlkeF0gJiYgKGlzRXZlbnQgfHwgY2xhc3NPclN0eWxlKSA/ICIgIiA6ICIiKSArIHBhcnNlZC52YWx1ZTsKICAgICAgICAgICAgICAgICAgaWYgKGNsYXNzT3JTdHlsZSkgaWYgKCFpdEF0dHJUb2tlbltUT0tFTl9CSU5ESU5HU10gJiYgIWl0QXR0clRva2VuW3ZhbHVlSWR4XSkgewogICAgICAgICAgICAgICAgICAgIGFycmF5UmVtb3ZlKGl0QXR0cnMsIGl0QXR0clRva2VuKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJyZW1vdmUiOgogICAgICAgICAgICAgICAgICBpZiAoaXRBdHRyVG9rZW4pIGFycmF5UmVtb3ZlKGl0QXR0cnMsIGl0QXR0clRva2VuKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIkF0dHJpYnV0ZSBtb2RpZmljYXRvciBpcyBub3QgcmVmZXJlbmNlIHRvIGVsZW1lbnQgdG9rZW4gKHJlZmVyZW5jZSBuYW1lOiAiICsgKGF0dHJzLnJlZiB8fCAiZWxlbWVudCIpICsgIikiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIHRva2VuLCBpdGVtOyB0b2tlbiA9IHRva2Vuc1tpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgcmVmcyA9IHJlZkxpc3QodG9rZW4pOwogICAgICAgICAgdmFyIGJpbmRpbmdzID0gcmVmcyAmJiByZWZzLmxlbmd0aCA9PSAxID8gcmVmc1swXSA6IDA7CiAgICAgICAgICBzd2l0Y2ggKHRva2VuLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSBUWVBFX0VMRU1FTlQ6CiAgICAgICAgICAgICAgaWYgKHRva2VuLnByZWZpeCA9PSAiYiIpIHsKICAgICAgICAgICAgICAgIHZhciBlbEF0dHJzID0gdG9rZW5BdHRycyh0b2tlbik7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHRva2VuLm5hbWUpIHsKICAgICAgICAgICAgICAgICAgY2FzZSAic3R5bGUiOgogICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZU5hbWVzcGFjZSA9IGVsQXR0cnMubmFtZXNwYWNlIHx8IGVsQXR0cnMubnM7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0eWxlSXNvbGF0ZSA9IHN0eWxlTmFtZXNwYWNlID8gc3R5bGVOYW1lc3BhY2VJc29sYXRlIDogY29udGV4dCAmJiBjb250ZXh0Lmlzb2xhdGUgfHwgIiI7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNyYyA9IGFkZFN0eWxlKHRlbXBsYXRlLCB0b2tlbiwgZWxBdHRycy5zcmMsIHN0eWxlSXNvbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlTmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3JjIGluIHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSA9PSBmYWxzZSkgc3R5bGVOYW1lc3BhY2VJc29sYXRlW3NyY10gPSBnZW5Jc29sYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5zdHlsZU5TUHJlZml4W3N0eWxlTmFtZXNwYWNlXSA9IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZVtzcmNdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAiaXNvbGF0ZSI6CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0ZW1wbGF0ZS5pc29sYXRlKSB0ZW1wbGF0ZS5pc29sYXRlID0gZWxBdHRycy5wcmVmaXggfHwgb3B0aW9ucy5pc29sYXRlIHx8IGdlbklzb2xhdGVNYXJrZXIoKTsgZWxzZSBiYXNpcy5kZXYud2FybigiPGI6aXNvbGF0ZT4gaXMgc2V0IGFscmVhZHkgdG8gYCIgKyB0ZW1wbGF0ZS5pc29sYXRlICsgImAiKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAibDEwbiI6CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlbXBsYXRlLmwxMG5SZXNvbHZlZCkgdGVtcGxhdGUud2FybnMucHVzaCgiPGI6bDEwbj4gbXVzdCBiZSBkZWNsYXJlZCBiZWZvcmUgYW55IGBsMTBuOmAgdG9rZW4gKGluc3RydWN0aW9uIGlnbm9yZWQpIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVsQXR0cnMuc3JjKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QoZWxBdHRycy5zcmMpKSBiYXNpcy5kZXYud2FybigiQmFkIHVzYWdlOiA8YjoiICsgdG9rZW4ubmFtZSArICcgc3JjPSInICsgZWxBdHRycy5zcmMgKyAnIi8+LlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4nKTsKICAgICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLmRpY3RVUkkgPSBwYXRoLnJlc29sdmUodGVtcGxhdGUuYmFzZVVSSSwgZWxBdHRycy5zcmMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAiZGVmaW5lIjoKICAgICAgICAgICAgICAgICAgICBpZiAoIm5hbWUiIGluIGVsQXR0cnMgJiYgIXRlbXBsYXRlLmRlZmluZXNbZWxBdHRycy5uYW1lXSkgewogICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChlbEF0dHJzLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiYm9vbCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUuZGVmaW5lc1tlbEF0dHJzLm5hbWVdID0gWyBlbEF0dHJzWyJkZWZhdWx0Il0gPT0gInRydWUiID8gMSA6IDAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZW51bSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IGVsQXR0cnMudmFsdWVzID8gZWxBdHRycy52YWx1ZXMudHJpbSgpLnNwbGl0KCIgIikgOiBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS5kZWZpbmVzW2VsQXR0cnMubmFtZV0gPSBbIHZhbHVlcy5pbmRleE9mKGVsQXR0cnNbImRlZmF1bHQiXSkgKyAxLCB2YWx1ZXMgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS53YXJucy5wdXNoKCJCYWQgZGVmaW5lIHR5cGUgYCIgKyBlbEF0dHJzLnR5cGUgKyAiYCBmb3IgIiArIGVsQXR0cnMubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlICJ0ZXh0IjoKICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IHRva2VuLmNoaWxkc1swXTsKICAgICAgICAgICAgICAgICAgICB0b2tlbnNbaS0tXSA9IGJhc2lzLm9iamVjdC5leHRlbmQodGV4dCwgewogICAgICAgICAgICAgICAgICAgICAgcmVmczogKGVsQXR0cnMucmVmIHx8ICIiKS50cmltKCkuc3BsaXQoL1xzKy8pLAogICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICJub3RyaW0iIGluIGVsQXR0cnMgPyB0ZXh0LnZhbHVlIDogdGV4dC52YWx1ZS5yZXBsYWNlKC9eXHMqW1xyXG5dK3xbXHJcbl1ccyokL2csICIiKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlICJpbmNsdWRlIjoKICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGVTcmMgPSBlbEF0dHJzLnNyYzsKICAgICAgICAgICAgICAgICAgICBpZiAodGVtcGxhdGVTcmMpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBpc1RlbXBsYXRlUmVmID0gL14jXGQrJC8udGVzdCh0ZW1wbGF0ZVNyYyk7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNEb2N1bWVudElkUmVmID0gL15pZDovLnRlc3QodGVtcGxhdGVTcmMpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IGlzVGVtcGxhdGVSZWYgPyB0ZW1wbGF0ZVNyYy5zdWJzdHIoMSkgOiB0ZW1wbGF0ZVNyYzsKICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpc1RlbXBsYXRlUmVmKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlID0gdGVtcGxhdGVMaXN0W3VybF07CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzRG9jdW1lbnRJZFJlZikgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvdXJjZSA9IHJlc29sdmVTb3VyY2VCeURvY3VtZW50SWQodXJsLnN1YnN0cigzKSk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKC9eW2EtejAtOVwuXSskL2kudGVzdCh1cmwpICYmICEvXC50bXBsJC8udGVzdCh1cmwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc291cmNlID0gZ2V0U291cmNlQnlQYXRoKHVybCk7CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QodXJsKSkgYmFzaXMuZGV2Lndhcm4oJ0JhZCB1c2FnZTogPGI6aW5jbHVkZSBzcmM9IicgKyB1cmwgKyAnIi8+LlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2UgPSBiYXNpcy5yZXNvdXJjZShwYXRoLnJlc29sdmUodGVtcGxhdGUuYmFzZVVSSSArIHVybCkpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXNvdXJjZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZS53YXJucy5wdXNoKCc8YjppbmNsdWRlIHNyYz0iJyArIHRlbXBsYXRlU3JjICsgJyI+IGlzIG5vdCByZXNvbHZlZCwgaW5zdHJ1Y3Rpb24gaWdub3JlZCcpOwogICAgICAgICAgICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybignPGI6aW5jbHVkZSBzcmM9IicgKyB0ZW1wbGF0ZVNyYyArICciPiBpcyBub3QgcmVzb2x2ZWQsIGluc3RydWN0aW9uIGlnbm9yZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZVN0YWNrLmluZGV4T2YocmVzb3VyY2UpID09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpc29sYXRlUHJlZml4ID0gImlzb2xhdGUiIGluIGVsQXR0cnMgPyBlbEF0dHJzLmlzb2xhdGUgfHwgZ2VuSXNvbGF0ZU1hcmtlcigpIDogIiI7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZWNsOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRG9jdW1lbnRJZFJlZikgYXJyYXlBZGQodGVtcGxhdGUuZGVwcywgcmVzb3VyY2UpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNUZW1wbGF0ZVJlZikgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNvdXJjZS5zb3VyY2UuYmluZGluZ0JyaWRnZSkgYXJyYXlBZGQodGVtcGxhdGUuZGVwcywgcmVzb3VyY2Uuc291cmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWNsID0gZ2V0RGVjbEZyb21Tb3VyY2UocmVzb3VyY2Uuc291cmNlLCByZXNvdXJjZS5iYXNlVVJJLCB0cnVlLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBkZWNsID0gZ2V0RGVjbEZyb21Tb3VyY2UocmVzb3VyY2UsIHJlc291cmNlLnVybCA/IHBhdGguZGlybmFtZShyZXNvdXJjZS51cmwpICsgIi8iIDogIiIsIHRydWUsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWNsLnJlc291cmNlcyAmJiAibm8tc3R5bGUiIGluIGVsQXR0cnMgPT0gZmFsc2UpIGFkZFN0eWxlcyh0ZW1wbGF0ZS5yZXNvdXJjZXMsIGRlY2wucmVzb3VyY2VzLCBpc29sYXRlUHJlZml4KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlY2wuZGVwcykgYWRkVW5pcXVlKHRlbXBsYXRlLmRlcHMsIGRlY2wuZGVwcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkZWNsLmwxMG4pIGFkZFVuaXF1ZSh0ZW1wbGF0ZS5sMTBuLCBkZWNsLmwxMG4pOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5SZWZNYXAgPSBub3JtYWxpemVSZWZzKGRlY2wudG9rZW5zKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluc3RydWN0aW9ucyA9ICh0b2tlbi5jaGlsZHMgfHwgW10pLnNsaWNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZU5TUHJlZml4TWFwID0gYmFzaXMub2JqZWN0LnNsaWNlKGRlY2wuc3R5bGVOU1ByZWZpeCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbEF0dHJzWyJjbGFzcyJdKSBpbnN0cnVjdGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogVFlQRV9FTEVNRU5ULAogICAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeDogImIiLAogICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJhcHBlbmQtY2xhc3MiLAogICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzOiBbIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfQVRUUklCVVRFLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogInZhbHVlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBlbEF0dHJzWyJjbGFzcyJdCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBdCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxBdHRycy5pZCkgaW5zdHJ1Y3Rpb25zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfRUxFTUVOVCwKICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVmaXg6ICJiIiwKICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAic2V0LWF0dHIiLAogICAgICAgICAgICAgICAgICAgICAgICAgIGF0dHJzOiBbIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFRZUEVfQVRUUklCVVRFLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogIm5hbWUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICJpZCIKICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBUWVBFX0FUVFJJQlVURSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJ2YWx1ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZWxBdHRycy5pZAogICAgICAgICAgICAgICAgICAgICAgICAgIH0gXQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsQXR0cnMucmVmKSBpZiAodG9rZW5SZWZNYXAuZWxlbWVudCkgZWxBdHRycy5yZWYudHJpbSgpLnNwbGl0KC9ccysvKS5tYXAoZnVuY3Rpb24ocmVmTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIGFkZFRva2VuUmVmKHRva2VuUmVmTWFwLmVsZW1lbnQudG9rZW4sIHJlZk5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGNoaWxkOyBjaGlsZCA9IGluc3RydWN0aW9uc1tqXTsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLnR5cGUgPT0gVFlQRV9FTEVNRU5UICYmIGNoaWxkLnByZWZpeCA9PSAiYiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoY2hpbGQubmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJzdHlsZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkQXR0cnMgPSB0b2tlbkF0dHJzKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVOYW1lc3BhY2UgPSBjaGlsZEF0dHJzLm5hbWVzcGFjZSB8fCBjaGlsZEF0dHJzLm5zOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZUlzb2xhdGUgPSBzdHlsZU5hbWVzcGFjZSA/IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSA6IGlzb2xhdGVQcmVmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNyYyA9IGFkZFN0eWxlKHRlbXBsYXRlLCBjaGlsZCwgY2hpbGRBdHRycy5zcmMsIHN0eWxlSXNvbGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlTmFtZXNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3JjIGluIHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSA9PSBmYWxzZSkgc3R5bGVOYW1lc3BhY2VJc29sYXRlW3NyY10gPSBnZW5Jc29sYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZU5TUHJlZml4TWFwW3N0eWxlTmFtZXNwYWNlXSA9IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZVtzcmNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVwbGFjZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImJlZm9yZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImFmdGVyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVwbGFjZU9yUmVtb3ZlID0gY2hpbGQubmFtZSA9PSAicmVwbGFjZSIgfHwgY2hpbGQubmFtZSA9PSAicmVtb3ZlIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRBdHRycyA9IHRva2VuQXR0cnMoY2hpbGQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWYgPSAicmVmIiBpbiBjaGlsZEF0dHJzIHx8ICFyZXBsYWNlT3JSZW1vdmUgPyBjaGlsZEF0dHJzLnJlZiA6ICJlbGVtZW50IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5SZWYgPSByZWYgJiYgdG9rZW5SZWZNYXBbcmVmXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW5SZWYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwb3MgPSB0b2tlblJlZi5vd25lci5pbmRleE9mKHRva2VuUmVmLnRva2VuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwb3MgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZ3MgPSBbIHBvcyArIChjaGlsZC5uYW1lID09ICJhZnRlciIpLCByZXBsYWNlT3JSZW1vdmUgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLm5hbWUgIT0gInJlbW92ZSIpIGFyZ3MgPSBhcmdzLmNvbmNhdChwcm9jZXNzKGNoaWxkLmNoaWxkcywgdGVtcGxhdGUsIG9wdGlvbnMpIHx8IFtdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9rZW5SZWYub3duZXIuc3BsaWNlLmFwcGx5KHRva2VuUmVmLm93bmVyLCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInByZXBlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJhcHBlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZEF0dHJzID0gdG9rZW5BdHRycyhjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZiA9ICJyZWYiIGluIGNoaWxkQXR0cnMgPyBjaGlsZEF0dHJzLnJlZiA6ICJlbGVtZW50IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5SZWYgPSByZWYgJiYgdG9rZW5SZWZNYXBbcmVmXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlblJlZiAmJiB0b2tlblJlZi50b2tlbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW4gJiYgdG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9FTEVNRU5UKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGRzID0gcHJvY2VzcyhjaGlsZC5jaGlsZHMsIHRlbXBsYXRlLCBvcHRpb25zKSB8fCBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5uYW1lID09ICJwcmVwZW5kIikgdG9rZW4uc3BsaWNlLmFwcGx5KHRva2VuLCBbIEVMRU1FTlRfQVRUUlMsIDAgXS5jb25jYXQoY2hpbGRzKSk7IGVsc2UgdG9rZW4ucHVzaC5hcHBseSh0b2tlbiwgY2hpbGRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImF0dHIiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJzZXQtYXR0ciI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5QXR0cihjaGlsZCwgZmFsc2UsICJzZXQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiYXBwZW5kLWF0dHIiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUF0dHIoY2hpbGQsIGZhbHNlLCAiYXBwZW5kIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInJlbW92ZS1hdHRyIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZnlBdHRyKGNoaWxkLCBmYWxzZSwgInJlbW92ZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJjbGFzcyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImFwcGVuZC1jbGFzcyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZ5QXR0cihjaGlsZCwgImNsYXNzIiwgImFwcGVuZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJzZXQtY2xhc3MiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmeUF0dHIoY2hpbGQsICJjbGFzcyIsICJzZXQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVtb3ZlLWNsYXNzIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZnlBdHRyKGNoaWxkLCAiY2xhc3MiLCAicmVtb3ZlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgImFkZC1yZWYiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZEF0dHJzID0gdG9rZW5BdHRycyhjaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZiA9ICJyZWYiIGluIGNoaWxkQXR0cnMgPyBjaGlsZEF0dHJzLnJlZiA6ICJlbGVtZW50IjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW5SZWYgPSByZWYgJiYgdG9rZW5SZWZNYXBbcmVmXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9rZW4gPSB0b2tlblJlZiAmJiB0b2tlblJlZi50b2tlbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW4gJiYgY2hpbGRBdHRycy5uYW1lKSBhZGRUb2tlblJlZih0b2tlbiwgY2hpbGRBdHRycy5uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVtb3ZlLXJlZiI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkQXR0cnMgPSB0b2tlbkF0dHJzKGNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVmID0gInJlZiIgaW4gY2hpbGRBdHRycyA/IGNoaWxkQXR0cnMucmVmIDogImVsZW1lbnQiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b2tlblJlZiA9IHJlZiAmJiB0b2tlblJlZk1hcFtyZWZdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b2tlbiA9IHRva2VuUmVmICYmIHRva2VuUmVmLnRva2VuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b2tlbikgcmVtb3ZlVG9rZW5SZWYodG9rZW4sIGNoaWxkQXR0cnMubmFtZSB8fCBjaGlsZEF0dHJzLnJlZik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiVW5rbm93biBpbnN0cnVjdGlvbiB0YWcgPGI6IiArIGNoaWxkLm5hbWUgKyAiPiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBkZWNsLnRva2Vucy5wdXNoLmFwcGx5KGRlY2wudG9rZW5zLCBwcm9jZXNzKFsgY2hpbGQgXSwgdGVtcGxhdGUsIG9wdGlvbnMpIHx8IFtdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9rZW5SZWZNYXAuZWxlbWVudCkgcmVtb3ZlVG9rZW5SZWYodG9rZW5SZWZNYXAuZWxlbWVudC50b2tlbiwgImVsZW1lbnQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgYmFzaXMub2JqZWN0LmNvbXBsZXRlKHRlbXBsYXRlLnN0eWxlTlNQcmVmaXgsIHN0eWxlTlNQcmVmaXhNYXApOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNvbGF0ZVByZWZpeCkgaXNvbGF0ZVRva2VucyhkZWNsLnRva2VucywgaXNvbGF0ZVByZWZpeCk7IGVsc2UgaWYgKGRlY2wuaXNvbGF0ZSAmJiAhdGVtcGxhdGUuaXNvbGF0ZSkgdGVtcGxhdGUuaXNvbGF0ZSA9IG9wdGlvbnMuaXNvbGF0ZSB8fCBnZW5Jc29sYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoLmFwcGx5KHJlc3VsdCwgZGVjbC50b2tlbnMpOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YWNrID0gaW5jbHVkZVN0YWNrLnNsaWNlKGluY2x1ZGVTdGFjay5pbmRleE9mKHJlc291cmNlKSB8fCAwKS5jb25jYXQocmVzb3VyY2UpLm1hcChmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzIGluc3RhbmNlb2YgVGVtcGxhdGUpIHJlcyA9IHJlcy5zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlcyBpbnN0YW5jZW9mIEwxMG5Qcm94eVRva2VuKSByZXR1cm4gIntsMTBuOiIgKyByZXMudG9rZW4ubmFtZSArICJAIiArIHJlcy50b2tlbi5kaWN0aW9uYXJ5LnJlc291cmNlLnVybCArICJ9IjsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnVybCB8fCAiW2lubGluZSB0ZW1wbGF0ZV0iOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiUmVjdXJzaW9uOiAiLCBzdGFjay5qb2luKCIgLT4gIikpOwogICAgICAgICAgICAgICAgICAgICAgICBiYXNpcy5kZXYud2FybigiUmVjdXJzaW9uIGluIHRlbXBsYXRlOiAiLCBzdGFjay5qb2luKCIgLT4gIikpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpdGVtID0gWyAxLCBiaW5kaW5ncywgcmVmcywgbmFtZSh0b2tlbikgXTsKICAgICAgICAgICAgICBpdGVtLnB1c2guYXBwbHkoaXRlbSwgYXR0cnModG9rZW4sIGl0ZW0sIG9wdGlvbnMub3B0aW1pemVTaXplKSB8fCBbXSk7CiAgICAgICAgICAgICAgaXRlbS5wdXNoLmFwcGx5KGl0ZW0sIHByb2Nlc3ModG9rZW4uY2hpbGRzLCB0ZW1wbGF0ZSwgb3B0aW9ucykgfHwgW10pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRZUEVfVEVYVDoKICAgICAgICAgICAgICBpZiAocmVmcyAmJiByZWZzLmxlbmd0aCA9PSAyICYmIGFycmF5U2VhcmNoKHJlZnMsICJlbGVtZW50IikpIGJpbmRpbmdzID0gcmVmc1srIXJlZnMubGFzdFNlYXJjaEluZGV4XTsKICAgICAgICAgICAgICBpZiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgICAgIHZhciBsMTBuQmluZGluZyA9IGFic2wxMG4oYmluZGluZ3MsIHRlbXBsYXRlLmRpY3RVUkkpOwogICAgICAgICAgICAgICAgdmFyIHBhcnRzID0gbDEwbkJpbmRpbmcuc3BsaXQoL1s6QFx7XS8pOwogICAgICAgICAgICAgICAgaWYgKHBhcnRzWzBdID09ICJsMTBuIiAmJiBwYXJ0cy5sZW5ndGggPT0gMykgewogICAgICAgICAgICAgICAgICBpZiAoIXBhcnRzWzJdKSB7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlSZW1vdmUocmVmcywgYmluZGluZ3MpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWZzLmxlbmd0aCA9PSAwKSByZWZzID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBiaW5kaW5ncyA9IDA7CiAgICAgICAgICAgICAgICAgICAgdG9rZW4udmFsdWUgPSB0b2tlbi52YWx1ZS5yZXBsYWNlKC9cfSQvLCAiQHVuZGVmaW5lZH0iKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbDEwbklkID0gcGFydHMuc2xpY2UoMSkuam9pbigiQCIpOwogICAgICAgICAgICAgICAgICAgIHZhciBsMTBuVG9rZW4gPSBiYXNpcy5sMTBuLnRva2VuKGwxMG5JZCk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGwxMG5UZW1wbGF0ZSA9IGdldEwxMG5UZW1wbGF0ZShsMTBuVG9rZW4pOwogICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLmwxMG5SZXNvbHZlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGwxMG5UZW1wbGF0ZSAmJiBsMTBuVG9rZW4udHlwZSA9PSAibWFya3VwIikgewogICAgICAgICAgICAgICAgICAgICAgdG9rZW5zW2ktLV0gPSB0b2tlbml6ZSgnPGI6aW5jbHVkZSBzcmM9IiMnICsgbDEwblRlbXBsYXRlLnRlbXBsYXRlSWQgKyAnIi8+JylbMF07CiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgYXJyYXlBZGQodGVtcGxhdGUubDEwbiwgbDEwbklkKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpdGVtID0gWyAzLCBiaW5kaW5ncywgcmVmcyBdOwogICAgICAgICAgICAgIGlmICghcmVmcyB8fCB0b2tlbi52YWx1ZSAhPSAieyIgKyByZWZzLmpvaW4oInwiKSArICJ9IikgaXRlbS5wdXNoKHVudG9rZW4odG9rZW4udmFsdWUpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUWVBFX0NPTU1FTlQ6CiAgICAgICAgICAgICAgaWYgKG9wdGlvbnMub3B0aW1pemVTaXplICYmICFiaW5kaW5ncyAmJiAhcmVmcykgY29udGludWU7CiAgICAgICAgICAgICAgaXRlbSA9IFsgOCwgYmluZGluZ3MsIHJlZnMgXTsKICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMub3B0aW1pemVTaXplKSBpZiAoIXJlZnMgfHwgdG9rZW4udmFsdWUgIT0gInsiICsgcmVmcy5qb2luKCJ8IikgKyAifSIpIGl0ZW0ucHVzaCh1bnRva2VuKHRva2VuLnZhbHVlKSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoaXRlbVtpdGVtLmxlbmd0aCAtIDFdID09PSAwKSBpdGVtLnBvcCgpOwogICAgICAgICAgcmVzdWx0LnB1c2goaXRlbSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQubGVuZ3RoID8gcmVzdWx0IDogMDsKICAgICAgfQogICAgICBmdW5jdGlvbiBhYnNsMTBuKHZhbHVlLCBkaWN0VVJJKSB7CiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPSAic3RyaW5nIikgcmV0dXJuIHZhbHVlOwogICAgICAgIHZhciBwYXJ0cyA9IHZhbHVlLnNwbGl0KCI6Iik7CiAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA9PSAyICYmIHBhcnRzWzBdID09ICJsMTBuIiAmJiBwYXJ0c1sxXS5pbmRleE9mKCJAIikgPT0gLTEpIHBhcnRzWzFdID0gcGFydHNbMV0gKyAiQCIgKyBkaWN0VVJJOwogICAgICAgIHJldHVybiBwYXJ0cy5qb2luKCI6Iik7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbm9ybWFsaXplUmVmcyh0b2tlbnMsIGRpY3RVUkksIG1hcCwgc3RJZHgpIHsKICAgICAgICBpZiAoIW1hcCkgbWFwID0ge307CiAgICAgICAgZm9yICh2YXIgaSA9IHN0SWR4IHx8IDAsIHRva2VuOyB0b2tlbiA9IHRva2Vuc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fVFlQRV0gPT0gVFlQRV9BVFRSSUJVVEVfRVZFTlQpIGNvbnRpbnVlOwogICAgICAgICAgdmFyIHJlZnMgPSB0b2tlbltUT0tFTl9SRUZTXTsKICAgICAgICAgIGlmIChyZWZzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGogPSByZWZzLmxlbmd0aCAtIDEsIHJlZk5hbWU7IHJlZk5hbWUgPSByZWZzW2pdOyBqLS0pIHsKICAgICAgICAgICAgICBpZiAocmVmTmFtZS5pbmRleE9mKCI6IikgIT0gLTEpIHsKICAgICAgICAgICAgICAgIHJlbW92ZVRva2VuUmVmKHRva2VuLCByZWZOYW1lKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobWFwW3JlZk5hbWVdKSByZW1vdmVUb2tlblJlZihtYXBbcmVmTmFtZV0udG9rZW4sIHJlZk5hbWUpOwogICAgICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9CSU5ESU5HU10gPT0gcmVmTmFtZSkgdG9rZW5bVE9LRU5fQklORElOR1NdID0gaiArIDE7CiAgICAgICAgICAgICAgbWFwW3JlZk5hbWVdID0gewogICAgICAgICAgICAgICAgb3duZXI6IHRva2VucywKICAgICAgICAgICAgICAgIHRva2VuOiB0b2tlbgogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodG9rZW5bVE9LRU5fVFlQRV0pIHsKICAgICAgICAgICAgY2FzZSBUWVBFX1RFWFQ6CiAgICAgICAgICAgICAgdG9rZW5bVE9LRU5fQklORElOR1NdID0gYWJzbDEwbih0b2tlbltUT0tFTl9CSU5ESU5HU10sIGRpY3RVUkkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRZUEVfQVRUUklCVVRFOgogICAgICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9CSU5ESU5HU10pIHsKICAgICAgICAgICAgICAgIHZhciBhcnJheSA9IHRva2VuW1RPS0VOX0JJTkRJTkdTXVswXTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYXJyYXkubGVuZ3RoOyBqKyspIGFycmF5W2pdID0gYWJzbDEwbihhcnJheVtqXSwgZGljdFVSSSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRZUEVfRUxFTUVOVDoKICAgICAgICAgICAgICBub3JtYWxpemVSZWZzKHRva2VuLCBkaWN0VVJJLCBtYXAsIEVMRU1FTlRfQVRUUlMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWFwOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGFwcGx5RGVmaW5lcyh0b2tlbnMsIHRlbXBsYXRlLCBvcHRpb25zLCBzdElkeCkgewogICAgICAgIHZhciB1bnByZWRpY3RhYmxlID0gMDsKICAgICAgICBmb3IgKHZhciBpID0gc3RJZHggfHwgMCwgdG9rZW47IHRva2VuID0gdG9rZW5zW2ldOyBpKyspIHsKICAgICAgICAgIHZhciB0b2tlblR5cGUgPSB0b2tlbltUT0tFTl9UWVBFXTsKICAgICAgICAgIGlmICh0b2tlblR5cGUgPT0gVFlQRV9FTEVNRU5UKSB1bnByZWRpY3RhYmxlICs9IGFwcGx5RGVmaW5lcyh0b2tlbiwgdGVtcGxhdGUsIG9wdGlvbnMsIEVMRU1FTlRfQVRUUlMpOwogICAgICAgICAgaWYgKHRva2VuVHlwZSA9PSBUWVBFX0FUVFJJQlVURV9DTEFTUyB8fCB0b2tlblR5cGUgPT0gVFlQRV9BVFRSSUJVVEUgJiYgdG9rZW5bQVRUUl9OQU1FXSA9PSAiY2xhc3MiKSB7CiAgICAgICAgICAgIHZhciBiaW5kaW5ncyA9IHRva2VuW1RPS0VOX0JJTkRJTkdTXTsKICAgICAgICAgICAgdmFyIHZhbHVlSWR4ID0gQVRUUl9WQUxVRV9JTkRFWFt0b2tlblR5cGVdOwogICAgICAgICAgICBpZiAoYmluZGluZ3MpIHsKICAgICAgICAgICAgICB2YXIgbmV3QXR0clZhbHVlID0gKHRva2VuW3ZhbHVlSWR4XSB8fCAiIikudHJpbSgpLnNwbGl0KCIgIik7CiAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDAsIGJpbmQ7IGJpbmQgPSBiaW5kaW5nc1trXTsgaysrKSB7CiAgICAgICAgICAgICAgICBpZiAoYmluZC5sZW5ndGggPiAyKSBjb250aW51ZTsKICAgICAgICAgICAgICAgIHZhciBiaW5kTmFtZSA9IGJpbmRbMV0uc3BsaXQoIjoiKS5wb3AoKTsKICAgICAgICAgICAgICAgIHZhciBiaW5kRGVmID0gdGVtcGxhdGUuZGVmaW5lc1tiaW5kTmFtZV07CiAgICAgICAgICAgICAgICBpZiAoYmluZERlZikgewogICAgICAgICAgICAgICAgICBiaW5kLnB1c2guYXBwbHkoYmluZCwgYmluZERlZik7CiAgICAgICAgICAgICAgICAgIGJpbmREZWYudXNlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGlmIChiaW5kRGVmWzBdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmREZWYubGVuZ3RoID09IDEpIGFycmF5QWRkKG5ld0F0dHJWYWx1ZSwgYmluZFswXSArIGJpbmROYW1lKTsgZWxzZSBhcnJheUFkZChuZXdBdHRyVmFsdWUsIGJpbmRbMF0gKyBiaW5kRGVmWzFdW2JpbmREZWZbMF0gLSAxXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRlbXBsYXRlLndhcm5zLnB1c2goIlVucHJlZGljdGFibGUgdmFsdWUgYCIgKyBiaW5kTmFtZSArICJgIGluIGNsYXNzIGJpbmRpbmc6ICIgKyBiaW5kWzBdICsgInsiICsgYmluZFsxXSArICJ9Iik7CiAgICAgICAgICAgICAgICAgIHVucHJlZGljdGFibGUrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdG9rZW5bdmFsdWVJZHhdID0gbmV3QXR0clZhbHVlLmpvaW4oIiAiKTsKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5vcHRpbWl6ZVNpemUgJiYgIXRva2VuW3ZhbHVlSWR4XSkgdG9rZW4ubGVuZ3RoID0gdmFsdWVJZHg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVucHJlZGljdGFibGU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gaXNvbGF0ZVRva2Vucyh0b2tlbnMsIGlzb2xhdGUsIHRlbXBsYXRlLCBzdElkeCkgewogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NOYW1lKG5hbWUpIHsKICAgICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoIjoiKTsKICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPT0gMSkgcmV0dXJuIGlzb2xhdGUgKyBwYXJ0c1swXTsKICAgICAgICAgIGlmICghdGVtcGxhdGUpIHJldHVybiBuYW1lOwogICAgICAgICAgaWYgKCFwYXJ0c1swXSkgcmV0dXJuIHBhcnRzWzFdOwogICAgICAgICAgaWYgKHBhcnRzWzBdIGluIHRlbXBsYXRlLnN0eWxlTlNQcmVmaXggPT0gZmFsc2UpIHsKICAgICAgICAgICAgdGVtcGxhdGUud2FybnMucHVzaCgiTmFtZXNwYWNlIGAiICsgcGFydHNbMF0gKyAiYCBpcyBub3QgZGVmaW5lZCBpbiB0ZW1wbGF0ZSwgbm8gcHJlZml4IGFkZGVkIik7CiAgICAgICAgICAgIHJldHVybiBuYW1lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRlbXBsYXRlLnN0eWxlTlNQcmVmaXhbcGFydHNbMF1dICsgcGFydHNbMV07CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSBzdElkeCB8fCAwLCB0b2tlbjsgdG9rZW4gPSB0b2tlbnNbaV07IGkrKykgewogICAgICAgICAgdmFyIHRva2VuVHlwZSA9IHRva2VuW1RPS0VOX1RZUEVdOwogICAgICAgICAgaWYgKHRva2VuVHlwZSA9PSBUWVBFX0VMRU1FTlQpIGlzb2xhdGVUb2tlbnModG9rZW4sIGlzb2xhdGUsIHRlbXBsYXRlLCBFTEVNRU5UX0FUVFJTKTsKICAgICAgICAgIGlmICh0b2tlblR5cGUgPT0gVFlQRV9BVFRSSUJVVEVfQ0xBU1MgfHwgdG9rZW5UeXBlID09IFRZUEVfQVRUUklCVVRFICYmIHRva2VuW0FUVFJfTkFNRV0gPT0gImNsYXNzIikgewogICAgICAgICAgICB2YXIgYmluZGluZ3MgPSB0b2tlbltUT0tFTl9CSU5ESU5HU107CiAgICAgICAgICAgIHZhciB2YWx1ZUluZGV4ID0gQVRUUl9WQUxVRV9JTkRFWFt0b2tlblR5cGVdOwogICAgICAgICAgICBpZiAodG9rZW5bdmFsdWVJbmRleF0pIHRva2VuW3ZhbHVlSW5kZXhdID0gdG9rZW5bdmFsdWVJbmRleF0uc3BsaXQoL1xzKy8pLm1hcChwcm9jZXNzTmFtZSkuam9pbigiICIpOwogICAgICAgICAgICBpZiAoYmluZGluZ3MpIGZvciAodmFyIGsgPSAwLCBiaW5kOyBiaW5kID0gYmluZGluZ3Nba107IGsrKykgYmluZFswXSA9IHByb2Nlc3NOYW1lKGJpbmRbMF0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24gbWFrZURlY2xhcmF0aW9uKHNvdXJjZSwgYmFzZVVSSSwgb3B0aW9ucywgc291cmNlVXJsLCBzb3VyY2VPcmlnaW4pIHsKICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgICB2YXIgd2FybnMgPSBbXTsKICAgICAgICB2YXIgc291cmNlXzsKICAgICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgICAgc291cmNlVXJsOiBzb3VyY2VVcmwsCiAgICAgICAgICBiYXNlVVJJOiBiYXNlVVJJIHx8ICIiLAogICAgICAgICAgdG9rZW5zOiBudWxsLAogICAgICAgICAgcmVzb3VyY2VzOiBbXSwKICAgICAgICAgIHN0eWxlTlNQcmVmaXg6IHt9LAogICAgICAgICAgZGVwczogW10sCiAgICAgICAgICBsMTBuOiBbXSwKICAgICAgICAgIGRlZmluZXM6IHt9LAogICAgICAgICAgdW5wcmVkaWN0YWJsZTogdHJ1ZSwKICAgICAgICAgIHdhcm5zOiB3YXJucywKICAgICAgICAgIGlzb2xhdGU6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICByZXN1bHQuZGljdFVSSSA9IHNvdXJjZVVybCA/IGJhc2lzLnBhdGgucmVzb2x2ZShzb3VyY2VVcmwpIDogYmFzZVVSSSB8fCAiIjsKICAgICAgICBpZiAocmVzdWx0LmRpY3RVUkkpIHsKICAgICAgICAgIHZhciBleHRuYW1lID0gYmFzaXMucGF0aC5leHRuYW1lKHJlc3VsdC5kaWN0VVJJKTsKICAgICAgICAgIGlmIChleHRuYW1lICYmIGV4dG5hbWUgIT0gIi5sMTBuIikgcmVzdWx0LmRpY3RVUkkgPSByZXN1bHQuZGljdFVSSS5zdWJzdHIoMCwgcmVzdWx0LmRpY3RVUkkubGVuZ3RoIC0gZXh0bmFtZS5sZW5ndGgpICsgIi5sMTBuIjsKICAgICAgICB9CiAgICAgICAgaWYgKCFzb3VyY2UudGVtcGxhdGVUb2tlbnMpIHsKICAgICAgICAgIHNvdXJjZV8gPSBzb3VyY2U7CiAgICAgICAgICBzb3VyY2UgPSB0b2tlbml6ZShTdHJpbmcoc291cmNlKSk7CiAgICAgICAgfQogICAgICAgIGlmIChzb3VyY2Uud2FybnMpIHdhcm5zLnB1c2guYXBwbHkod2FybnMsIHNvdXJjZS53YXJucyk7CiAgICAgICAgaW5jbHVkZVN0YWNrLnB1c2goc291cmNlT3JpZ2luICE9PSB0cnVlICYmIHNvdXJjZU9yaWdpbiB8fCB7fSk7CiAgICAgICAgcmVzdWx0LnRva2VucyA9IHByb2Nlc3Moc291cmNlLCByZXN1bHQsIG9wdGlvbnMpOwogICAgICAgIGluY2x1ZGVTdGFjay5wb3AoKTsKICAgICAgICBpZiAoIXJlc3VsdC50b2tlbnMpIHJlc3VsdC50b2tlbnMgPSBbIFsgMywgMCwgMCwgIiIgXSBdOwogICAgICAgIGlmIChzb3VyY2VfKSByZXN1bHQudG9rZW5zLnNvdXJjZV8gPSBzb3VyY2VfOwogICAgICAgIGFkZFRva2VuUmVmKHJlc3VsdC50b2tlbnNbMF0sICJlbGVtZW50Iik7CiAgICAgICAgbm9ybWFsaXplUmVmcyhyZXN1bHQudG9rZW5zLCByZXN1bHQuZGljdFVSSSk7CiAgICAgICAgcmVzdWx0LnVucHJlZGljdGFibGUgPSAhIWFwcGx5RGVmaW5lcyhyZXN1bHQudG9rZW5zLCByZXN1bHQsIG9wdGlvbnMpOwogICAgICAgIGlmICgvXlteYS16XS9pLnRlc3QocmVzdWx0Lmlzb2xhdGUpKSBiYXNpcy5kZXYuZXJyb3IoImJhc2lzLnRlbXBsYXRlOiBpc29sYXRpb24gcHJlZml4IGAiICsgcmVzdWx0Lmlzb2xhdGUgKyAiYCBzaG91bGQgbm90IHN0YXJ0cyB3aXRoIHN5bWJvbCBvdGhlciB0aGFuIGxldHRlciwgb3RoZXJ3aXNlIGl0IGxlYWRzIHRvIGluY29ycmVjdCBjc3MgY2xhc3MgbmFtZXMgYW5kIGJyb2tlbiBzdHlsZXMiKTsKICAgICAgICBpZiAoaW5jbHVkZVN0YWNrLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICBpc29sYXRlVG9rZW5zKHJlc3VsdC50b2tlbnMsIHJlc3VsdC5pc29sYXRlIHx8ICIiLCByZXN1bHQpOwogICAgICAgICAgaWYgKHJlc3VsdC5pc29sYXRlKSBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IHJlc3VsdC5yZXNvdXJjZXNbaV07IGkrKykgaWYgKGl0ZW1bMV0gIT09IHN0eWxlTmFtZXNwYWNlSXNvbGF0ZSkgaXRlbVsxXSA9IHJlc3VsdC5pc29sYXRlICsgaXRlbVsxXTsKICAgICAgICAgIHJlc3VsdC5yZXNvdXJjZXMgPSByZXN1bHQucmVzb3VyY2VzLmZpbHRlcihmdW5jdGlvbihpdGVtLCBpZHgsIGFycmF5KSB7CiAgICAgICAgICAgIHJldHVybiAhYmFzaXMuYXJyYXkuc2VhcmNoKGFycmF5LCBTdHJpbmcoaXRlbSksIFN0cmluZywgaWR4ICsgMSk7CiAgICAgICAgICB9KS5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICB2YXIgdXJsID0gaXRlbVswXTsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSBpdGVtWzFdOwogICAgICAgICAgICBpZiAoaXNvbGF0ZSA9PT0gc3R5bGVOYW1lc3BhY2VJc29sYXRlKSBpc29sYXRlID0gc3R5bGVOYW1lc3BhY2VJc29sYXRlW3VybF07CiAgICAgICAgICAgIGlmICghaXNvbGF0ZSkgcmV0dXJuIHVybDsKICAgICAgICAgICAgdmFyIHJlc291cmNlID0gYmFzaXMucmVzb3VyY2UudmlydHVhbCgiY3NzIiwgIiIpLnJlYWR5KGZ1bmN0aW9uKGNzc1Jlc291cmNlKSB7CiAgICAgICAgICAgICAgc291cmNlUmVzb3VyY2UoKTsKICAgICAgICAgICAgICBiYXNpcy5vYmplY3QuZXh0ZW5kKGNzc1Jlc291cmNlLCB7CiAgICAgICAgICAgICAgICB1cmw6IHVybCArICI/aXNvbGF0ZS1wcmVmaXg9IiArIGlzb2xhdGUsCiAgICAgICAgICAgICAgICBiYXNlVVJJOiBiYXNpcy5wYXRoLmRpcm5hbWUodXJsKSArICIvIgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIHNvdXJjZVJlc291cmNlID0gYmFzaXMucmVzb3VyY2UodXJsKS5yZWFkeShmdW5jdGlvbihjc3NSZXNvdXJjZSkgewogICAgICAgICAgICAgIHZhciBjc3NUZXh0ID0gaXNvbGF0ZUNzcyhjc3NSZXNvdXJjZS5jc3NUZXh0IHx8ICIiLCBpc29sYXRlKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGJ0b2EgPT0gImZ1bmN0aW9uIikgY3NzVGV4dCArPSAiXG4vKiMgc291cmNlTWFwcGluZ1VSTD1kYXRhOmFwcGxpY2F0aW9uL2pzb247YmFzZTY0LCIgKyBidG9hKCd7InZlcnNpb24iOjMsInNvdXJjZXMiOlsiJyArIGJhc2lzLnBhdGgub3JpZ2luICsgdXJsICsgJyJdLCcgKyAnIm1hcHBpbmdzIjoiQUFBQScgKyBiYXNpcy5zdHJpbmcucmVwZWF0KCI7QUFDQSIsIGNzc1RleHQuc3BsaXQoIlxuIikubGVuZ3RoKSArICcifScpICsgIiAqLyI7CiAgICAgICAgICAgICAgcmVzb3VyY2UudXBkYXRlKGNzc1RleHQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHJlc291cmNlLnVybDsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBrZXkgaW4gcmVzdWx0LmRlZmluZXMpIGlmICghcmVzdWx0LmRlZmluZXNba2V5XS51c2VkKSB3YXJucy5wdXNoKCJVbnVzZWQgZGVmaW5lIGZvciAiICsga2V5KTsKICAgICAgICBkZWxldGUgcmVzdWx0LmRlZmluZXM7CiAgICAgICAgZGVsZXRlIHJlc3VsdC5sMTBuUmVzb2x2ZWQ7CiAgICAgICAgaWYgKCF3YXJucy5sZW5ndGgpIHJlc3VsdC53YXJucyA9IGZhbHNlOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9KCk7CiAgICBmdW5jdGlvbiBzdGFydFVzZVJlc291cmNlKHVyaSkgewogICAgICB2YXIgcmVzb3VyY2UgPSBiYXNpcy5yZXNvdXJjZSh1cmkpLmZldGNoKCk7CiAgICAgIGlmICh0eXBlb2YgcmVzb3VyY2Uuc3RhcnRVc2UgPT0gImZ1bmN0aW9uIikgcmVzb3VyY2Uuc3RhcnRVc2UoKTsKICAgIH0KICAgIGZ1bmN0aW9uIHN0b3BVc2VSZXNvdXJjZSh1cmkpIHsKICAgICAgdmFyIHJlc291cmNlID0gYmFzaXMucmVzb3VyY2UodXJpKS5mZXRjaCgpOwogICAgICBpZiAodHlwZW9mIHJlc291cmNlLnN0b3BVc2UgPT0gImZ1bmN0aW9uIikgcmVzb3VyY2Uuc3RvcFVzZSgpOwogICAgfQogICAgZnVuY3Rpb24gdGVtcGxhdGVTb3VyY2VVcGRhdGUoKSB7CiAgICAgIGlmICh0aGlzLmRlc3Ryb3lCdWlsZGVyKSBidWlsZFRlbXBsYXRlLmNhbGwodGhpcyk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBhdHRhY2g7IGF0dGFjaCA9IHRoaXMuYXR0YWNoZXNfW2ldOyBpKyspIGF0dGFjaC5oYW5kbGVyLmNhbGwoYXR0YWNoLmNvbnRleHQpOwogICAgfQogICAgZnVuY3Rpb24gY2xvbmVEZWNsKGFycmF5KSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgaWYgKGFycmF5LnNvdXJjZV8pIHJlc3VsdC5zb3VyY2VfID0gYXJyYXkuc291cmNlXzsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgcmVzdWx0LnB1c2goQXJyYXkuaXNBcnJheShhcnJheVtpXSkgPyBjbG9uZURlY2woYXJyYXlbaV0pIDogYXJyYXlbaV0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gZ2V0RGVjbEZyb21Tb3VyY2Uoc291cmNlLCBiYXNlVVJJLCBjbG9uZSwgb3B0aW9ucykgewogICAgICB2YXIgcmVzdWx0ID0gc291cmNlOwogICAgICB2YXIgc291cmNlVXJsOwogICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgYmFzZVVSSSA9ICJiYXNlVVJJIiBpbiBzb3VyY2UgPyBzb3VyY2UuYmFzZVVSSSA6IGJhc2VVUkk7CiAgICAgICAgc291cmNlVXJsID0gInVybCIgaW4gc291cmNlID8gc291cmNlLnVybCA6IHNvdXJjZVVybDsKICAgICAgICByZXN1bHQgPSByZXN1bHQoKTsKICAgICAgfQogICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgYmFzaXMuVG9rZW4pIHsKICAgICAgICBiYXNlVVJJID0gImJhc2VVUkkiIGluIHNvdXJjZSA/IHNvdXJjZS5iYXNlVVJJIDogYmFzZVVSSTsKICAgICAgICBzb3VyY2VVcmwgPSAidXJsIiBpbiBzb3VyY2UgPyBzb3VyY2UudXJsIDogc291cmNlVXJsOwogICAgICAgIHJlc3VsdCA9IHJlc3VsdC5nZXQoKTsKICAgICAgfQogICAgICBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7CiAgICAgICAgaWYgKGNsb25lKSByZXN1bHQgPSBjbG9uZURlY2wocmVzdWx0KTsKICAgICAgICByZXN1bHQgPSB7CiAgICAgICAgICB0b2tlbnM6IHJlc3VsdAogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgIT0gIm9iamVjdCIgfHwgIUFycmF5LmlzQXJyYXkocmVzdWx0LnRva2VucykpIHJlc3VsdCA9IFN0cmluZyhyZXN1bHQpOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgcmVzdWx0ID09ICJzdHJpbmciKSByZXN1bHQgPSBtYWtlRGVjbGFyYXRpb24ocmVzdWx0LCBiYXNlVVJJLCBvcHRpb25zLCBzb3VyY2VVcmwsIHNvdXJjZSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBmdW5jdGlvbiBsMTBuSGFuZGxlcih2YWx1ZSkgewogICAgICBpZiAodGhpcy50eXBlICE9ICJtYXJrdXAiICYmIHRoaXMudG9rZW4udHlwZSA9PSAibWFya3VwIikgewogICAgICAgIGJ1aWxkVGVtcGxhdGUuY2FsbCh0aGlzLnRlbXBsYXRlKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gYnVpbGRUZW1wbGF0ZSgpIHsKICAgICAgdmFyIGRlY2wgPSBnZXREZWNsRnJvbVNvdXJjZSh0aGlzLnNvdXJjZSwgdGhpcy5iYXNlVVJJLCBmYWxzZSwgewogICAgICAgIGlzb2xhdGU6IHRoaXMuZ2V0SXNvbGF0ZVByZWZpeCgpCiAgICAgIH0pOwogICAgICB2YXIgZGVzdHJveUJ1aWxkZXIgPSB0aGlzLmRlc3Ryb3lCdWlsZGVyOwogICAgICB2YXIgZnVuY3MgPSB0aGlzLmJ1aWxkZXIoZGVjbC50b2tlbnMsIHRoaXMpOwogICAgICB2YXIgZGVwcyA9IHRoaXMuZGVwc187CiAgICAgIHZhciBsMTBuID0gdGhpcy5sMTBuXzsKICAgICAgaWYgKGRlcHMpIHsKICAgICAgICB0aGlzLmRlcHNfID0gbnVsbDsKICAgICAgICBmb3IgKHZhciBpID0gMCwgZGVwOyBkZXAgPSBkZXBzW2ldOyBpKyspIGRlcC5iaW5kaW5nQnJpZGdlLmRldGFjaChkZXAsIGJ1aWxkVGVtcGxhdGUsIHRoaXMpOwogICAgICB9CiAgICAgIGlmIChsMTBuKSBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IGwxMG5baV07IGkrKykgaXRlbS50b2tlbi5iaW5kaW5nQnJpZGdlLmRldGFjaChpdGVtLnRva2VuLCBsMTBuSGFuZGxlciwgaXRlbSk7CiAgICAgIGlmIChkZWNsLmRlcHMgJiYgZGVjbC5kZXBzLmxlbmd0aCkgewogICAgICAgIGRlcHMgPSBkZWNsLmRlcHM7CiAgICAgICAgdGhpcy5kZXBzXyA9IGRlcHM7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGRlcDsgZGVwID0gZGVwc1tpXTsgaSsrKSBkZXAuYmluZGluZ0JyaWRnZS5hdHRhY2goZGVwLCBidWlsZFRlbXBsYXRlLCB0aGlzKTsKICAgICAgfQogICAgICBpZiAoZGVjbC5sMTBuKSB7CiAgICAgICAgbDEwbiA9IGRlY2wubDEwbjsKICAgICAgICB0aGlzLmwxMG5fID0ge307CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGtleTsga2V5ID0gbDEwbltpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgbDEwblRva2VuID0gYmFzaXMubDEwbi50b2tlbihrZXkpOwogICAgICAgICAgbDEwblRva2VuLmJpbmRpbmdCcmlkZ2UuYXR0YWNoKGwxMG5Ub2tlbiwgbDEwbkhhbmRsZXIsIHRoaXMubDEwbl9ba2V5XSA9IHsKICAgICAgICAgICAgdGVtcGxhdGU6IHRoaXMsCiAgICAgICAgICAgIHRva2VuOiBsMTBuVG9rZW4sCiAgICAgICAgICAgIHR5cGU6IGwxMG5Ub2tlbi50eXBlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5jcmVhdGVJbnN0YW5jZSA9IGZ1bmNzLmNyZWF0ZUluc3RhbmNlOwogICAgICB0aGlzLmNsZWFySW5zdGFuY2UgPSBmdW5jcy5kZXN0cm95SW5zdGFuY2U7CiAgICAgIHRoaXMuZ2V0QmluZGluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBuYW1lczogZnVuY3Mua2V5cwogICAgICAgIH07CiAgICAgIH07CiAgICAgIHRoaXMuZGVzdHJveUJ1aWxkZXIgPSBmdW5jcy5kZXN0cm95OwogICAgICB0aGlzLmluc3RhbmNlc18gPSBmdW5jcy5pbnN0YW5jZXNfOwogICAgICB0aGlzLmRlY2xfID0gZGVjbDsKICAgICAgdmFyIGRlY2xSZXNvdXJjZXMgPSBkZWNsLnJlc291cmNlcyAmJiBkZWNsLnJlc291cmNlcy5sZW5ndGggPiAwID8gZGVjbC5yZXNvdXJjZXMgOiBudWxsOwogICAgICBpZiAoZGVjbFJlc291cmNlcykgZm9yICh2YXIgaSA9IDAsIHJlczsgcmVzID0gZGVjbFJlc291cmNlc1tpXTsgaSsrKSBzdGFydFVzZVJlc291cmNlKHJlcyk7CiAgICAgIGlmICh0aGlzLnJlc291cmNlcykgZm9yICh2YXIgaSA9IDAsIHJlczsgcmVzID0gdGhpcy5yZXNvdXJjZXNbaV07IGkrKykgc3RvcFVzZVJlc291cmNlKHJlcyk7CiAgICAgIHRoaXMucmVzb3VyY2VzID0gZGVjbFJlc291cmNlczsKICAgICAgaWYgKGRlc3Ryb3lCdWlsZGVyKSBkZXN0cm95QnVpbGRlcih0cnVlKTsKICAgIH0KICAgIHZhciBzb3VyY2VCeURvY3VtZW50SWRSZXNvbHZlcnMgPSB7fTsKICAgIGZ1bmN0aW9uIGdldFRlbXBsYXRlQnlEb2N1bWVudElkKGlkKSB7CiAgICAgIHZhciByZXNvbHZlciA9IHJlc29sdmVTb3VyY2VCeURvY3VtZW50SWQoaWQpOwogICAgICBpZiAocmVzb2x2ZXIudGVtcGxhdGUpIHJldHVybiByZXNvbHZlci50ZW1wbGF0ZTsKICAgICAgdmFyIGhvc3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICAgIHZhciBzb3VyY2UgPSAiIjsKICAgICAgaWYgKGhvc3QgJiYgaG9zdC50YWdOYW1lID09ICJTQ1JJUFQiICYmIGhvc3QudHlwZSA9PSAidGV4dC9iYXNpcy10ZW1wbGF0ZSIpIHNvdXJjZSA9IGhvc3QudGV4dENvbnRlbnQgfHwgaG9zdC50ZXh0OyBlbHNlIGlmICghaG9zdCkgYmFzaXMuZGV2Lndhcm4oIlRlbXBsYXRlIHNjcmlwdCBlbGVtZW50IHdpdGggaWQgYCIgKyBpZCArICJgIG5vdCBmb3VuZCIpOyBlbHNlIGJhc2lzLmRldi53YXJuKCdUZW1wbGF0ZSBzaG91bGQgYmUgZGVjbGFyZWQgaW4gPHNjcmlwdCB0eXBlPSJ0ZXh0L2Jhc2lzLXRlbXBsYXRlIj4gZWxlbWVudCAoaWQgYCcgKyBzb3VyY2VJZCArICJgKSIpOwogICAgICByZXR1cm4gcmVzb2x2ZXIudGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUoc291cmNlKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlc29sdmVTb3VyY2VCeURvY3VtZW50SWQoc291cmNlSWQpIHsKICAgICAgdmFyIHJlc29sdmVyID0gc291cmNlQnlEb2N1bWVudElkUmVzb2x2ZXJzW3NvdXJjZUlkXTsKICAgICAgaWYgKCFyZXNvbHZlcikgewogICAgICAgIHJlc29sdmVyID0gc291cmNlQnlEb2N1bWVudElkUmVzb2x2ZXJzW3NvdXJjZUlkXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIGdldFRlbXBsYXRlQnlEb2N1bWVudElkKHNvdXJjZUlkKS5zb3VyY2U7CiAgICAgICAgfTsKICAgICAgICByZXNvbHZlci5pZCA9IHNvdXJjZUlkOwogICAgICAgIHJlc29sdmVyLnVybCA9ICc8c2NyaXB0IGlkPSInICsgc291cmNlSWQgKyAnIi8+JzsKICAgICAgfQogICAgICByZXR1cm4gcmVzb2x2ZXI7CiAgICB9CiAgICB2YXIgVGVtcGxhdGUgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UZW1wbGF0ZSIsCiAgICAgIF9fZXh0ZW5kX186IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgVGVtcGxhdGUpIHJldHVybiB2YWx1ZTsKICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBUZW1wbGF0ZVN3aXRjaENvbmZpZykgcmV0dXJuIG5ldyBUZW1wbGF0ZVN3aXRjaGVyKHZhbHVlKTsKICAgICAgICByZXR1cm4gbmV3IFRlbXBsYXRlKHZhbHVlKTsKICAgICAgfSwKICAgICAgc291cmNlOiAiIiwKICAgICAgYmFzZVVSSTogIiIsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIGlmICh0ZW1wbGF0ZUxpc3QubGVuZ3RoID09IDQwOTYpIHRocm93ICJUb28gbWFueSB0ZW1wbGF0ZXMgKG1heGltdW0gNDA5NikiOwogICAgICAgIHRoaXMuYXR0YWNoZXNfID0gW107CiAgICAgICAgdGhpcy5zZXRTb3VyY2Uoc291cmNlIHx8ICIiKTsKICAgICAgICB0aGlzLnRlbXBsYXRlSWQgPSB0ZW1wbGF0ZUxpc3QucHVzaCh0aGlzKSAtIDE7CiAgICAgIH0sCiAgICAgIGJpbmRpbmdCcmlkZ2U6IHsKICAgICAgICBhdHRhY2g6IGZ1bmN0aW9uKHRlbXBsYXRlLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGlzdGVuZXI7IGxpc3RlbmVyID0gdGVtcGxhdGUuYXR0YWNoZXNfW2ldOyBpKyspIGlmIChsaXN0ZW5lci5oYW5kbGVyID09IGhhbmRsZXIgJiYgbGlzdGVuZXIuY29udGV4dCA9PSBjb250ZXh0KSByZXR1cm47CiAgICAgICAgICB0ZW1wbGF0ZS5hdHRhY2hlc18ucHVzaCh7CiAgICAgICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgZGV0YWNoOiBmdW5jdGlvbih0ZW1wbGF0ZSwgaGFuZGxlciwgY29udGV4dCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxpc3RlbmVyOyBsaXN0ZW5lciA9IHRlbXBsYXRlLmF0dGFjaGVzX1tpXTsgaSsrKSBpZiAobGlzdGVuZXIuaGFuZGxlciA9PSBoYW5kbGVyICYmIGxpc3RlbmVyLmNvbnRleHQgPT0gY29udGV4dCkgewogICAgICAgICAgICB0ZW1wbGF0ZS5hdHRhY2hlc18uc3BsaWNlKGksIDEpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkge30KICAgICAgfSwKICAgICAgY3JlYXRlSW5zdGFuY2U6IGZ1bmN0aW9uKG9iamVjdCwgYWN0aW9uQ2FsbGJhY2ssIHVwZGF0ZUNhbGxiYWNrLCBiaW5kaW5ncywgYmluZGluZ0ludGVyZmFjZSkgewogICAgICAgIGJ1aWxkVGVtcGxhdGUuY2FsbCh0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVJbnN0YW5jZShvYmplY3QsIGFjdGlvbkNhbGxiYWNrLCB1cGRhdGVDYWxsYmFjaywgYmluZGluZ3MsIGJpbmRpbmdJbnRlcmZhY2UpOwogICAgICB9LAogICAgICBjbGVhckluc3RhbmNlOiBmdW5jdGlvbih0bXBsKSB7fSwKICAgICAgZ2V0SXNvbGF0ZVByZWZpeDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICJpIiArIHRoaXMudGVtcGxhdGVJZCArICJfXyI7CiAgICAgIH0sCiAgICAgIGdldEJpbmRpbmc6IGZ1bmN0aW9uKGJpbmRpbmdzKSB7CiAgICAgICAgYnVpbGRUZW1wbGF0ZS5jYWxsKHRoaXMpOwogICAgICAgIHJldHVybiB0aGlzLmdldEJpbmRpbmcoYmluZGluZ3MpOwogICAgICB9LAogICAgICBzZXRTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgIHZhciBvbGRTb3VyY2UgPSB0aGlzLnNvdXJjZTsKICAgICAgICBpZiAob2xkU291cmNlICE9IHNvdXJjZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2UgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdmFyIG0gPSBzb3VyY2UubWF0Y2goL14oW2Etel0rKTovKTsKICAgICAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgICB2YXIgcHJlZml4ID0gbVsxXTsKICAgICAgICAgICAgICBzb3VyY2UgPSBzb3VyY2Uuc3Vic3RyKG1bMF0ubGVuZ3RoKTsKICAgICAgICAgICAgICBzd2l0Y2ggKHByZWZpeCkgewogICAgICAgICAgICAgICAgY2FzZSAiZmlsZSI6CiAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGJhc2lzLnJlc291cmNlKHNvdXJjZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiaWQiOgogICAgICAgICAgICAgICAgICBzb3VyY2UgPSByZXNvbHZlU291cmNlQnlEb2N1bWVudElkKHNvdXJjZSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidG9rZW5zIjoKICAgICAgICAgICAgICAgICAgc291cmNlID0gYmFzaXMuc3RyaW5nLnRvT2JqZWN0KHNvdXJjZSk7CiAgICAgICAgICAgICAgICAgIHNvdXJjZS5pc0RlY2wgPSB0cnVlOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInJhdyI6CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAicGF0aCI6CiAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGdldFNvdXJjZUJ5UGF0aChzb3VyY2UpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuVGVtcGxhdGUuc2V0U291cmNlOiBVbmtub3duIHByZWZpeCAiICsgcHJlZml4ICsgIiBmb3IgdGVtcGxhdGUgc291cmNlIHdhcyBpbmdub3JlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbGRTb3VyY2UgJiYgb2xkU291cmNlLmJpbmRpbmdCcmlkZ2UpIHsKICAgICAgICAgICAgdmFyIHRtcGxMaXN0ID0gb2xkU291cmNlLnVybCAmJiB0bXBsRmlsZXNNYXBbb2xkU291cmNlLnVybF07CiAgICAgICAgICAgIGlmICh0bXBsTGlzdCkgewogICAgICAgICAgICAgIGFycmF5UmVtb3ZlKHRtcGxMaXN0LCB0aGlzKTsKICAgICAgICAgICAgICBpZiAoIXRtcGxMaXN0Lmxlbmd0aCkgZGVsZXRlIHRtcGxGaWxlc01hcFtvbGRTb3VyY2UudXJsXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmJhc2VVUkkgPSAiIjsKICAgICAgICAgICAgdGhpcy5zb3VyY2UuYmluZGluZ0JyaWRnZS5kZXRhY2gob2xkU291cmNlLCB0ZW1wbGF0ZVNvdXJjZVVwZGF0ZSwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc291cmNlICYmIHNvdXJjZS5iaW5kaW5nQnJpZGdlKSB7CiAgICAgICAgICAgIGlmIChzb3VyY2UudXJsKSB7CiAgICAgICAgICAgICAgdGhpcy5iYXNlVVJJID0gcGF0aC5kaXJuYW1lKHNvdXJjZS51cmwpICsgIi8iOwogICAgICAgICAgICAgIGlmICghdG1wbEZpbGVzTWFwW3NvdXJjZS51cmxdKSB0bXBsRmlsZXNNYXBbc291cmNlLnVybF0gPSBbXTsKICAgICAgICAgICAgICBhcnJheUFkZCh0bXBsRmlsZXNNYXBbc291cmNlLnVybF0sIHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNvdXJjZS5iaW5kaW5nQnJpZGdlLmF0dGFjaChzb3VyY2UsIHRlbXBsYXRlU291cmNlVXBkYXRlLCB0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc291cmNlID0gc291cmNlOwogICAgICAgICAgdGVtcGxhdGVTb3VyY2VVcGRhdGUuY2FsbCh0aGlzKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmRlc3Ryb3lCdWlsZGVyKSB0aGlzLmRlc3Ryb3lCdWlsZGVyKCk7CiAgICAgICAgdGhpcy5hdHRhY2hlc18gPSBudWxsOwogICAgICAgIHRoaXMuY3JlYXRlSW5zdGFuY2UgPSBudWxsOwogICAgICAgIHRoaXMuZ2V0QmluZGluZyA9IG51bGw7CiAgICAgICAgdGhpcy5yZXNvdXJjZXMgPSBudWxsOwogICAgICAgIHRoaXMuc291cmNlID0gbnVsbDsKICAgICAgICB0aGlzLmluc3RhbmNlc18gPSBudWxsOwogICAgICAgIHRoaXMuZGVjbF8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUZW1wbGF0ZVN3aXRjaENvbmZpZyA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICBiYXNpcy5vYmplY3QuZXh0ZW5kKHRoaXMsIGNvbmZpZyk7CiAgICB9OwogICAgdmFyIFRlbXBsYXRlU3dpdGNoZXIgPSBiYXNpcy5DbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UZW1wbGF0ZVN3aXRjaGVyIiwKICAgICAgcnVsZVJldF86IG51bGwsCiAgICAgIHRlbXBsYXRlc186IG51bGwsCiAgICAgIHRlbXBsYXRlQ2xhc3M6IFRlbXBsYXRlLAogICAgICBydWxlRXZlbnRzOiBudWxsLAogICAgICBydWxlOiBTdHJpbmcsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICAgIHRoaXMucnVsZVJldF8gPSBbXTsKICAgICAgICB0aGlzLnRlbXBsYXRlc18gPSBbXTsKICAgICAgICB0aGlzLnJ1bGUgPSBjb25maWcucnVsZTsKICAgICAgICB2YXIgZXZlbnRzID0gY29uZmlnLmV2ZW50czsKICAgICAgICBpZiAoZXZlbnRzICYmIGV2ZW50cy5sZW5ndGgpIHsKICAgICAgICAgIHRoaXMucnVsZUV2ZW50cyA9IHt9OwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50TmFtZTsgZXZlbnROYW1lID0gZXZlbnRzW2ldOyBpKyspIHRoaXMucnVsZUV2ZW50c1tldmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgY2xlYW5lci5hZGQodGhpcyk7CiAgICAgIH0sCiAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHZhciByZXQgPSB0aGlzLnJ1bGUob2JqZWN0KTsKICAgICAgICB2YXIgaWR4ID0gdGhpcy5ydWxlUmV0Xy5pbmRleE9mKHJldCk7CiAgICAgICAgaWYgKGlkeCA9PSAtMSkgewogICAgICAgICAgdGhpcy5ydWxlUmV0Xy5wdXNoKHJldCk7CiAgICAgICAgICBpZHggPSB0aGlzLnRlbXBsYXRlc18ucHVzaChuZXcgdGhpcy50ZW1wbGF0ZUNsYXNzKHJldCkpIC0gMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMudGVtcGxhdGVzX1tpZHhdOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJ1bGUgPSBudWxsOwogICAgICAgIHRoaXMudGVtcGxhdGVzXyA9IG51bGw7CiAgICAgICAgdGhpcy5ydWxlUmV0XyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gc3dpdGNoZXIoZXZlbnRzLCBydWxlKSB7CiAgICAgIHZhciBhcmdzID0gYmFzaXMuYXJyYXkoYXJndW1lbnRzKTsKICAgICAgdmFyIHJ1bGUgPSBhcmdzLnBvcCgpOwogICAgICByZXR1cm4gbmV3IFRlbXBsYXRlU3dpdGNoQ29uZmlnKHsKICAgICAgICBydWxlOiBydWxlLAogICAgICAgIGV2ZW50czogYXJncy5qb2luKCIgIikudHJpbSgpLnNwbGl0KC9ccysvKQogICAgICB9KTsKICAgIH0KICAgIHZhciBUaGVtZSA9IENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlRoZW1lIiwKICAgICAgZ2V0OiBnZXRTb3VyY2VCeVBhdGgKICAgIH0pOwogICAgdmFyIFNvdXJjZVdyYXBwZXIgPSBDbGFzcyhiYXNpcy5Ub2tlbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU291cmNlV3JhcHBlciIsCiAgICAgIHBhdGg6ICIiLAogICAgICB1cmw6ICIiLAogICAgICBiYXNlVVJJOiAiIiwKICAgICAgaW5pdDogZnVuY3Rpb24odmFsdWUsIHBhdGgpIHsKICAgICAgICB0aGlzLnBhdGggPSBwYXRoOwogICAgICAgIGJhc2lzLlRva2VuLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcywgIiIpOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnZhbHVlICYmIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZSA/IHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZS5nZXQodGhpcy52YWx1ZSkgOiB0aGlzLnZhbHVlOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjb250ZW50ID0gZ2V0VGhlbWVTb3VyY2UoY3VycmVudFRoZW1lTmFtZSwgdGhpcy5wYXRoKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSAhPSBjb250ZW50KSB7CiAgICAgICAgICBpZiAodGhpcy52YWx1ZSAmJiB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UpIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZS5kZXRhY2godGhpcy52YWx1ZSwgU291cmNlV3JhcHBlci5wcm90b3R5cGUuYXBwbHksIHRoaXMpOwogICAgICAgICAgdGhpcy52YWx1ZSA9IGNvbnRlbnQ7CiAgICAgICAgICB0aGlzLnVybCA9IGNvbnRlbnQgJiYgY29udGVudC51cmwgfHwgIiI7CiAgICAgICAgICB0aGlzLmJhc2VVUkkgPSAodHlwZW9mIGNvbnRlbnQgPT0gIm9iamVjdCIgfHwgdHlwZW9mIGNvbnRlbnQgPT0gImZ1bmN0aW9uIikgJiYgImJhc2VVUkkiIGluIGNvbnRlbnQgPyBjb250ZW50LmJhc2VVUkkgOiBwYXRoLmRpcm5hbWUodGhpcy51cmwpICsgIi8iOwogICAgICAgICAgaWYgKHRoaXMudmFsdWUgJiYgdGhpcy52YWx1ZS5iaW5kaW5nQnJpZGdlKSB0aGlzLnZhbHVlLmJpbmRpbmdCcmlkZ2UuYXR0YWNoKHRoaXMudmFsdWUsIFNvdXJjZVdyYXBwZXIucHJvdG90eXBlLmFwcGx5LCB0aGlzKTsKICAgICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudXJsID0gbnVsbDsKICAgICAgICB0aGlzLmJhc2VVUkkgPSBudWxsOwogICAgICAgIGlmICh0aGlzLnZhbHVlICYmIHRoaXMudmFsdWUuYmluZGluZ0JyaWRnZSkgdGhpcy52YWx1ZS5iaW5kaW5nQnJpZGdlLmRldGFjaCh0aGlzLnZhbHVlLCB0aGlzLmFwcGx5LCB0aGlzKTsKICAgICAgICBiYXNpcy5Ub2tlbi5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIGdldFNvdXJjZUJ5UGF0aCgpIHsKICAgICAgdmFyIHBhdGggPSBiYXNpcy5hcnJheShhcmd1bWVudHMpLmpvaW4oIi4iKTsKICAgICAgdmFyIHNvdXJjZSA9IHNvdXJjZUJ5UGF0aFtwYXRoXTsKICAgICAgaWYgKCFzb3VyY2UpIHsKICAgICAgICBzb3VyY2UgPSBuZXcgU291cmNlV3JhcHBlcigiIiwgcGF0aCk7CiAgICAgICAgc291cmNlQnlQYXRoW3BhdGhdID0gc291cmNlOwogICAgICB9CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9CiAgICBmdW5jdGlvbiBub3JtYWxpemUobGlzdCkgewogICAgICB2YXIgdXNlZCA9IHt9OwogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgaWYgKCF1c2VkW2xpc3RbaV1dKSB7CiAgICAgICAgdXNlZFtsaXN0W2ldXSA9IHRydWU7CiAgICAgICAgcmVzdWx0LnB1c2gobGlzdFtpXSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIGV4dGVuZEZhbGxiYWNrKHRoZW1lTmFtZSwgbGlzdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIHJlc3VsdC5zb3VyY2UgPSBub3JtYWxpemUobGlzdCkuam9pbigiLyIpOwogICAgICB2YXIgdXNlZCA9IHsKICAgICAgICBiYXNlOiB0cnVlCiAgICAgIH07CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBuYW1lID0gbGlzdFtpXSB8fCAiYmFzZSI7CiAgICAgICAgaWYgKG5hbWUgPT0gdGhlbWVOYW1lIHx8IHVzZWRbbmFtZV0pIGNvbnRpbnVlOwogICAgICAgIHZhciB0aGVtZSA9IGdldFRoZW1lKG5hbWUpOwogICAgICAgIHVzZWRbbmFtZV0gPSB0cnVlOwogICAgICAgIHJlc3VsdC5wdXNoKG5hbWUpOwogICAgICAgIGxpc3Quc3BsaWNlLmFwcGx5KGxpc3QsIFsgaSArIDEsIDAgXS5jb25jYXQodGhlbWVzW25hbWVdLmZhbGxiYWNrKSk7CiAgICAgIH0KICAgICAgcmVzdWx0LnVuc2hpZnQodGhlbWVOYW1lKTsKICAgICAgaWYgKHRoZW1lTmFtZSAhPSAiYmFzZSIpIHJlc3VsdC5wdXNoKCJiYXNlIik7CiAgICAgIHJlc3VsdC52YWx1ZSA9IHJlc3VsdC5qb2luKCIvIik7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRUaGVtZVNvdXJjZShuYW1lLCBwYXRoKSB7CiAgICAgIHZhciBzb3VyY2VMaXN0ID0gdGhlbWVzW25hbWVdLnNvdXJjZXNMaXN0OwogICAgICBmb3IgKHZhciBpID0gMCwgbWFwOyBtYXAgPSBzb3VyY2VMaXN0W2ldOyBpKyspIGlmIChtYXAuaGFzT3duUHJvcGVydHkocGF0aCkpIHJldHVybiBtYXBbcGF0aF07CiAgICAgIHJldHVybiAiIjsKICAgIH0KICAgIGZ1bmN0aW9uIHRoZW1lSGFzRWZmZWN0KHRoZW1lTmFtZSkgewogICAgICByZXR1cm4gdGhlbWVzW2N1cnJlbnRUaGVtZU5hbWVdLmZhbGxiYWNrLmluZGV4T2YodGhlbWVOYW1lKSAhPSAtMTsKICAgIH0KICAgIGZ1bmN0aW9uIHN5bmNDdXJyZW50VGhlbWVQYXRoKHBhdGgpIHsKICAgICAgZ2V0U291cmNlQnlQYXRoKHBhdGgpLnNldCgpOwogICAgfQogICAgZnVuY3Rpb24gc3luY0N1cnJlbnRUaGVtZShjaGFuZ2VkKSB7CiAgICAgIGJhc2lzLmRldi5sb2coInJlLWFwcGx5IHRlbXBsYXRlcyIpOwogICAgICBmb3IgKHZhciBwYXRoIGluIHNvdXJjZUJ5UGF0aCkgc3luY0N1cnJlbnRUaGVtZVBhdGgocGF0aCk7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRUaGVtZShuYW1lKSB7CiAgICAgIGlmICghbmFtZSkgbmFtZSA9ICJiYXNlIjsKICAgICAgaWYgKHRoZW1lc1tuYW1lXSkgcmV0dXJuIHRoZW1lc1tuYW1lXS50aGVtZTsKICAgICAgaWYgKCEvXihbYS16MC05XF9cLV0rKSQvLnRlc3QobmFtZSkpIHRocm93ICJCYWQgbmFtZSBmb3IgdGhlbWUgLSAiICsgbmFtZTsKICAgICAgdmFyIHNvdXJjZXMgPSB7fTsKICAgICAgdmFyIHNvdXJjZUxpc3QgPSBbIHNvdXJjZXMgXTsKICAgICAgdmFyIHRoZW1lSW50ZXJmYWNlID0gbmV3IFRoZW1lOwogICAgICB0aGVtZXNbbmFtZV0gPSB7CiAgICAgICAgdGhlbWU6IHRoZW1lSW50ZXJmYWNlLAogICAgICAgIHNvdXJjZXM6IHNvdXJjZXMsCiAgICAgICAgc291cmNlc0xpc3Q6IHNvdXJjZUxpc3QsCiAgICAgICAgZmFsbGJhY2s6IFtdCiAgICAgIH07CiAgICAgIHZhciBhZGRTb3VyY2UgPSBmdW5jdGlvbihwYXRoLCBzb3VyY2UpIHsKICAgICAgICBpZiAocGF0aCBpbiBzb3VyY2VzID09IGZhbHNlKSB7CiAgICAgICAgICBzb3VyY2VzW3BhdGhdID0gc291cmNlOwogICAgICAgICAgaWYgKHRoZW1lSGFzRWZmZWN0KG5hbWUpKSBzeW5jQ3VycmVudFRoZW1lUGF0aChwYXRoKTsKICAgICAgICB9IGVsc2UgYmFzaXMuZGV2Lndhcm4oIlRlbXBsYXRlIHBhdGggYCIgKyBwYXRoICsgImAgaXMgYWxyZWFkeSBkZWZpbmVkIGZvciB0aGVtZSBgIiArIG5hbWUgKyAiYCAoZGVmaW5pdGlvbiBpZ25vcmVkKS4iKTsKICAgICAgICByZXR1cm4gZ2V0U291cmNlQnlQYXRoKHBhdGgpOwogICAgICB9OwogICAgICBiYXNpcy5vYmplY3QuZXh0ZW5kKHRoZW1lSW50ZXJmYWNlLCB7CiAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICBmYWxsYmFjazogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICh0aGVtZUludGVyZmFjZSAhPT0gYmFzZVRoZW1lICYmIGFyZ3VtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBuZXdGYWxsYmFjayA9IHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIiA/IHZhbHVlLnNwbGl0KCIvIikgOiBbXTsKICAgICAgICAgICAgdmFyIGNoYW5nZWQgPSB7fTsKICAgICAgICAgICAgbmV3RmFsbGJhY2sgPSBleHRlbmRGYWxsYmFjayhuYW1lLCBuZXdGYWxsYmFjayk7CiAgICAgICAgICAgIGlmICh0aGVtZXNbbmFtZV0uZmFsbGJhY2suc291cmNlICE9IG5ld0ZhbGxiYWNrLnNvdXJjZSkgewogICAgICAgICAgICAgIHRoZW1lc1tuYW1lXS5mYWxsYmFjay5zb3VyY2UgPSBuZXdGYWxsYmFjay5zb3VyY2U7CiAgICAgICAgICAgICAgYmFzaXMuZGV2LmxvZygiZmFsbGJhY2sgY2hhbmdlZCIpOwogICAgICAgICAgICAgIGZvciAodmFyIHRoZW1lTmFtZSBpbiB0aGVtZXMpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJGYWxsYmFjayA9IHRoZW1lc1t0aGVtZU5hbWVdLmZhbGxiYWNrOwogICAgICAgICAgICAgICAgdmFyIG5ld0ZhbGxiYWNrID0gZXh0ZW5kRmFsbGJhY2sodGhlbWVOYW1lLCAoY3VyRmFsbGJhY2suc291cmNlIHx8ICIiKS5zcGxpdCgiLyIpKTsKICAgICAgICAgICAgICAgIGlmIChuZXdGYWxsYmFjay52YWx1ZSAhPSBjdXJGYWxsYmFjay52YWx1ZSkgewogICAgICAgICAgICAgICAgICBjaGFuZ2VkW3RoZW1lTmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICB0aGVtZXNbdGhlbWVOYW1lXS5mYWxsYmFjayA9IG5ld0ZhbGxiYWNrOwogICAgICAgICAgICAgICAgICB2YXIgc291cmNlTGlzdCA9IHRoZW1lc1t0aGVtZU5hbWVdLnNvdXJjZXNMaXN0OwogICAgICAgICAgICAgICAgICBzb3VyY2VMaXN0Lmxlbmd0aCA9IG5ld0ZhbGxiYWNrLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3VyY2VMaXN0Lmxlbmd0aDsgaSsrKSBzb3VyY2VMaXN0W2ldID0gdGhlbWVzW25ld0ZhbGxiYWNrW2ldXS5zb3VyY2VzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3VycmVudEZhbGxiYWNrID0gdGhlbWVzW2N1cnJlbnRUaGVtZU5hbWVdLmZhbGxiYWNrOwogICAgICAgICAgICBmb3IgKHZhciB0aGVtZU5hbWUgaW4gY2hhbmdlZCkgewogICAgICAgICAgICAgIGlmICh0aGVtZUhhc0VmZmVjdCh0aGVtZU5hbWUpKSB7CiAgICAgICAgICAgICAgICBzeW5jQ3VycmVudFRoZW1lKCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByZXN1bHQgPSB0aGVtZXNbbmFtZV0uZmFsbGJhY2suc2xpY2UoMSk7CiAgICAgICAgICByZXN1bHQuc291cmNlID0gdGhlbWVzW25hbWVdLmZhbGxiYWNrLnNvdXJjZTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSwKICAgICAgICBkZWZpbmU6IGZ1bmN0aW9uKHdoYXQsIHdoZXJld2l0aCkgewogICAgICAgICAgaWYgKHR5cGVvZiB3aGF0ID09ICJmdW5jdGlvbiIpIHdoYXQgPSB3aGF0KCk7CiAgICAgICAgICBpZiAodHlwZW9mIHdoYXQgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB3aGVyZXdpdGggPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gd2hhdDsKICAgICAgICAgICAgICB2YXIgZGljdGlvbmFyeSA9IHdoZXJld2l0aDsKICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGRpY3Rpb25hcnkpIGlmIChkaWN0aW9uYXJ5Lmhhc093blByb3BlcnR5KGtleSkpIHJlc3VsdFtrZXldID0gYWRkU291cmNlKG5hbWVzcGFjZSArICIuIiArIGtleSwgZGljdGlvbmFyeVtrZXldKTsKICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRTb3VyY2VCeVBhdGgod2hhdCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBhZGRTb3VyY2Uod2hhdCwgd2hlcmV3aXRoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygd2hhdCA9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHZhciBkaWN0aW9uYXJ5ID0gd2hhdDsKICAgICAgICAgICAgICBmb3IgKHZhciBwYXRoIGluIGRpY3Rpb25hcnkpIGlmIChkaWN0aW9uYXJ5Lmhhc093blByb3BlcnR5KHBhdGgpKSBhZGRTb3VyY2UocGF0aCwgZGljdGlvbmFyeVtwYXRoXSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRoZW1lSW50ZXJmYWNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJXcm9uZyBmaXJzdCBhcmd1bWVudCBmb3IgYmFzaXMudGVtcGxhdGUuVGhlbWUjZGVmaW5lIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFwcGx5OiBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChuYW1lICE9IGN1cnJlbnRUaGVtZU5hbWUpIHsKICAgICAgICAgICAgY3VycmVudFRoZW1lTmFtZSA9IG5hbWU7CiAgICAgICAgICAgIHN5bmNDdXJyZW50VGhlbWUoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGhhbmRsZXI7IGhhbmRsZXIgPSB0aGVtZUNoYW5nZUhhbmRsZXJzW2ldOyBpKyspIGhhbmRsZXIuZm4uY2FsbChoYW5kbGVyLmNvbnRleHQsIG5hbWUpOwogICAgICAgICAgICBiYXNpcy5kZXYuaW5mbygiVGVtcGxhdGUgdGhlbWUgc3dpdGNoZWQgdG8gYCIgKyBuYW1lICsgImAiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGVtZUludGVyZmFjZTsKICAgICAgICB9LAogICAgICAgIGdldFNvdXJjZTogZnVuY3Rpb24ocGF0aCwgd2l0aEZhbGxiYWNrKSB7CiAgICAgICAgICByZXR1cm4gd2l0aEZhbGxiYWNrID8gZ2V0VGhlbWVTb3VyY2UobmFtZSwgcGF0aCkgOiBzb3VyY2VzW3BhdGhdOwogICAgICAgIH0sCiAgICAgICAgZHJvcDogZnVuY3Rpb24ocGF0aCkgewogICAgICAgICAgaWYgKHNvdXJjZXMuaGFzT3duUHJvcGVydHkocGF0aCkpIHsKICAgICAgICAgICAgZGVsZXRlIHNvdXJjZXNbcGF0aF07CiAgICAgICAgICAgIGlmICh0aGVtZUhhc0VmZmVjdChuYW1lKSkgc3luY0N1cnJlbnRUaGVtZVBhdGgocGF0aCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdGhlbWVzW25hbWVdLmZhbGxiYWNrID0gZXh0ZW5kRmFsbGJhY2sobmFtZSwgW10pOwogICAgICBzb3VyY2VMaXN0LnB1c2godGhlbWVzLmJhc2Uuc291cmNlcyk7CiAgICAgIHJldHVybiB0aGVtZUludGVyZmFjZTsKICAgIH0KICAgIHZhciB0aGVtZXMgPSB7fTsKICAgIHZhciBzb3VyY2VCeVBhdGggPSB7fTsKICAgIHZhciBiYXNlVGhlbWUgPSBnZXRUaGVtZSgpOwogICAgdmFyIGN1cnJlbnRUaGVtZU5hbWUgPSAiYmFzZSI7CiAgICB2YXIgdGhlbWVDaGFuZ2VIYW5kbGVycyA9IFtdOwogICAgZnVuY3Rpb24gb25UaGVtZUNoYW5nZShmbiwgY29udGV4dCwgZmlyZSkgewogICAgICB0aGVtZUNoYW5nZUhhbmRsZXJzLnB1c2goewogICAgICAgIGZuOiBmbiwKICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgIH0pOwogICAgICBpZiAoZmlyZSkgZm4uY2FsbChjb250ZXh0LCBjdXJyZW50VGhlbWVOYW1lKTsKICAgIH0KICAgIGNsZWFuZXIuYWRkKHsKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgcGF0aCBpbiBzb3VyY2VCeVBhdGgpIHNvdXJjZUJ5UGF0aFtwYXRoXS5kZXN0cm95KCk7CiAgICAgICAgdGhlbWVzID0gbnVsbDsKICAgICAgICBzb3VyY2VCeVBhdGggPSBudWxsOwogICAgICAgIGZvciAodmFyIGkgPSAwLCB0ZW1wbGF0ZTsgdGVtcGxhdGUgPSB0ZW1wbGF0ZUxpc3RbaV07IGkrKykgdGVtcGxhdGUuZGVzdHJveSgpOwogICAgICAgIHRlbXBsYXRlTGlzdCA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIERFQ0xBUkFUSU9OX1ZFUlNJT046IERFQ0xBUkFUSU9OX1ZFUlNJT04sCiAgICAgIFRZUEVfRUxFTUVOVDogVFlQRV9FTEVNRU5ULAogICAgICBUWVBFX0FUVFJJQlVURTogVFlQRV9BVFRSSUJVVEUsCiAgICAgIFRZUEVfQVRUUklCVVRFX0NMQVNTOiBUWVBFX0FUVFJJQlVURV9DTEFTUywKICAgICAgVFlQRV9BVFRSSUJVVEVfU1RZTEU6IFRZUEVfQVRUUklCVVRFX1NUWUxFLAogICAgICBUWVBFX0FUVFJJQlVURV9FVkVOVDogVFlQRV9BVFRSSUJVVEVfRVZFTlQsCiAgICAgIFRZUEVfVEVYVDogVFlQRV9URVhULAogICAgICBUWVBFX0NPTU1FTlQ6IFRZUEVfQ09NTUVOVCwKICAgICAgVE9LRU5fVFlQRTogVE9LRU5fVFlQRSwKICAgICAgVE9LRU5fQklORElOR1M6IFRPS0VOX0JJTkRJTkdTLAogICAgICBUT0tFTl9SRUZTOiBUT0tFTl9SRUZTLAogICAgICBBVFRSX05BTUU6IEFUVFJfTkFNRSwKICAgICAgQVRUUl9WQUxVRTogQVRUUl9WQUxVRSwKICAgICAgQVRUUl9OQU1FX0JZX1RZUEU6IEFUVFJfTkFNRV9CWV9UWVBFLAogICAgICBFTEVNRU5UX05BTUU6IEVMRU1FTlRfTkFNRSwKICAgICAgRUxFTUVOVF9BVFRSUzogRUxFTUVOVF9BVFRSUywKICAgICAgRUxFTUVOVF9DSElMRFM6IEVMRU1FTlRfQ0hJTERTLAogICAgICBURVhUX1ZBTFVFOiBURVhUX1ZBTFVFLAogICAgICBDT01NRU5UX1ZBTFVFOiBDT01NRU5UX1ZBTFVFLAogICAgICBMMTBuUHJveHlUb2tlbjogTDEwblByb3h5VG9rZW4sCiAgICAgIFRlbXBsYXRlU3dpdGNoQ29uZmlnOiBUZW1wbGF0ZVN3aXRjaENvbmZpZywKICAgICAgVGVtcGxhdGVTd2l0Y2hlcjogVGVtcGxhdGVTd2l0Y2hlciwKICAgICAgVGVtcGxhdGU6IFRlbXBsYXRlLAogICAgICBTb3VyY2VXcmFwcGVyOiBTb3VyY2VXcmFwcGVyLAogICAgICBzd2l0Y2hlcjogc3dpdGNoZXIsCiAgICAgIHRva2VuaXplOiB0b2tlbml6ZSwKICAgICAgaXNvbGF0ZUNzczogaXNvbGF0ZUNzcywKICAgICAgZ2V0RGVjbEZyb21Tb3VyY2U6IGdldERlY2xGcm9tU291cmNlLAogICAgICBtYWtlRGVjbGFyYXRpb246IG1ha2VEZWNsYXJhdGlvbiwKICAgICAgZ2V0TDEwblRlbXBsYXRlOiBnZXRMMTBuVGVtcGxhdGUsCiAgICAgIFRoZW1lOiBUaGVtZSwKICAgICAgdGhlbWU6IGdldFRoZW1lLAogICAgICBnZXRUaGVtZUxpc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBiYXNpcy5vYmplY3Qua2V5cyh0aGVtZXMpOwogICAgICB9LAogICAgICBjdXJyZW50VGhlbWU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGVtZXNbY3VycmVudFRoZW1lTmFtZV0udGhlbWU7CiAgICAgIH0sCiAgICAgIHNldFRoZW1lOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgcmV0dXJuIGdldFRoZW1lKG5hbWUpLmFwcGx5KCk7CiAgICAgIH0sCiAgICAgIG9uVGhlbWVDaGFuZ2U6IG9uVGhlbWVDaGFuZ2UsCiAgICAgIGRlZmluZTogYmFzZVRoZW1lLmRlZmluZSwKICAgICAgZ2V0OiBnZXRTb3VyY2VCeVBhdGgsCiAgICAgIGdldFBhdGhMaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYmFzaXMub2JqZWN0LmtleXMoc291cmNlQnlQYXRoKTsKICAgICAgfQogICAgfTsKICB9LAogICI3LmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzguanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMi5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi82LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzkuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgZG9tRXZlbnQgPSBiYXNpcy5kb20uZXZlbnQ7CiAgICB2YXIgYXJyYXlGcm9tID0gYmFzaXMuYXJyYXkuZnJvbTsKICAgIHZhciBjYW1lbGl6ZSA9IGJhc2lzLnN0cmluZy5jYW1lbGl6ZTsKICAgIHZhciBsMTBuVG9rZW4gPSBiYXNpcy5sMTBuLnRva2VuOwogICAgdmFyIGdldEZ1bmN0aW9ucyA9IGJhc2lzLnRlbXBsYXRlLmh0bWxmZ2VuLmdldEZ1bmN0aW9uczsKICAgIHZhciBUZW1wbGF0ZVN3aXRjaENvbmZpZyA9IGJhc2lzLnRlbXBsYXRlLlRlbXBsYXRlU3dpdGNoQ29uZmlnOwogICAgdmFyIFRlbXBsYXRlU3dpdGNoZXIgPSBiYXNpcy50ZW1wbGF0ZS5UZW1wbGF0ZVN3aXRjaGVyOwogICAgdmFyIFRlbXBsYXRlID0gYmFzaXMudGVtcGxhdGUuVGVtcGxhdGU7CiAgICB2YXIgVFlQRV9FTEVNRU5UID0gYmFzaXMudGVtcGxhdGUuVFlQRV9FTEVNRU5UOwogICAgdmFyIFRZUEVfQVRUUklCVVRFID0gYmFzaXMudGVtcGxhdGUuVFlQRV9BVFRSSUJVVEU7CiAgICB2YXIgVFlQRV9URVhUID0gYmFzaXMudGVtcGxhdGUuVFlQRV9URVhUOwogICAgdmFyIFRZUEVfQ09NTUVOVCA9IGJhc2lzLnRlbXBsYXRlLlRZUEVfQ09NTUVOVDsKICAgIHZhciBUT0tFTl9UWVBFID0gYmFzaXMudGVtcGxhdGUuVE9LRU5fVFlQRTsKICAgIHZhciBUT0tFTl9CSU5ESU5HUyA9IGJhc2lzLnRlbXBsYXRlLlRPS0VOX0JJTkRJTkdTOwogICAgdmFyIFRPS0VOX1JFRlMgPSBiYXNpcy50ZW1wbGF0ZS5UT0tFTl9SRUZTOwogICAgdmFyIEFUVFJfTkFNRSA9IGJhc2lzLnRlbXBsYXRlLkFUVFJfTkFNRTsKICAgIHZhciBBVFRSX1ZBTFVFID0gYmFzaXMudGVtcGxhdGUuQVRUUl9WQUxVRTsKICAgIHZhciBBVFRSX05BTUVfQllfVFlQRSA9IGJhc2lzLnRlbXBsYXRlLkFUVFJfTkFNRV9CWV9UWVBFOwogICAgdmFyIEVMRU1FTlRfTkFNRSA9IGJhc2lzLnRlbXBsYXRlLkVMRU1FTlRfTkFNRTsKICAgIHZhciBURVhUX1ZBTFVFID0gYmFzaXMudGVtcGxhdGUuVEVYVF9WQUxVRTsKICAgIHZhciBDT01NRU5UX1ZBTFVFID0gYmFzaXMudGVtcGxhdGUuQ09NTUVOVF9WQUxVRTsKICAgIHZhciBldmVudEF0dHIgPSAvXmV2ZW50LSguKykrLzsKICAgIHZhciBiYXNpc1RlbXBsYXRlSWRNYXJrZXIgPSAiYmFzaXNUZW1wbGF0ZUlkXyIgKyBiYXNpcy5nZW5VSUQoKTsKICAgIHZhciB0bXBsRXZlbnRMaXN0ZW5lcnMgPSB7fTsKICAgIHZhciB0ZW1wbGF0ZXMgPSB7fTsKICAgIHZhciBuYW1lc3BhY2VVUkkgPSB7CiAgICAgIHN2ZzogImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICAgfTsKICAgIHZhciBhZnRlckV2ZW50QWN0aW9uID0ge307CiAgICB2YXIgaW5zaWRlRWxlbWVudEV2ZW50ID0ge307CiAgICB2YXIgTU9VU0VfRU5URVJfTEVBVkVfU1VQUE9SVCA9ICJvbm1vdXNlZW50ZXIiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICAgIHZhciBDQVBUVVJFX0ZBTExCQUNLID0gIWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIgJiYgIl9fYmFzaXNUZW1wbGF0ZSIgKyBwYXJzZUludCgxZTkgKiBNYXRoLnJhbmRvbSgpKTsKICAgIGlmIChDQVBUVVJFX0ZBTExCQUNLKSBnbG9iYWxbQ0FQVFVSRV9GQUxMQkFDS10gPSBmdW5jdGlvbihldmVudE5hbWUsIGV2ZW50KSB7CiAgICAgIGRvbUV2ZW50LmZpcmVFdmVudChkb2N1bWVudCwgZXZlbnROYW1lKTsKICAgICAgZXZlbnQucmV0dXJuVmFsdWUgPSB0cnVlOwogICAgICB2YXIgbGlzdGVuZXIgPSB0bXBsRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXTsKICAgICAgaWYgKGxpc3RlbmVyKSBsaXN0ZW5lcihuZXcgZG9tRXZlbnQuRXZlbnQoZXZlbnQpKTsKICAgIH07CiAgICB2YXIgQ0xPTkVfTk9STUFMSVpBVElPTl9URVhUX0JVRyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCJhIikpOwogICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCJhIikpOwogICAgICByZXR1cm4gZWxlbWVudC5jbG9uZU5vZGUodHJ1ZSkuY2hpbGROb2Rlcy5sZW5ndGggPT0gMTsKICAgIH0oKTsKICAgIHZhciBTRVRfQ0xBU1NfQVRUUklCVVRFX0JVRyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgiY2xhc3MiLCAiYSIpOwogICAgICByZXR1cm4gIWVsZW1lbnQuY2xhc3NOYW1lOwogICAgfSgpOwogICAgdmFyIFNFVF9TVFlMRV9BVFRSSUJVVEVfQlVHID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJwb3NpdGlvbjphYnNvbHV0ZSIpOwogICAgICByZXR1cm4gZWxlbWVudC5zdHlsZS5wb3NpdGlvbiAhPSAiYWJzb2x1dGUiOwogICAgfSgpOwogICAgdmFyIElTX1NFVF9TVFlMRV9TQUZFID0gISFmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlLmNvbG9yID0gIngiOwogICAgICB9IGNhdGNoIChlKSB7fQogICAgfSgpOwogICAgaWYgKHR5cGVvZiBOb2RlICE9ICJ1bmRlZmluZWQiICYmICFOb2RlLnByb3RvdHlwZS5jb250YWlucykgTm9kZS5wcm90b3R5cGUuY29udGFpbnMgPSBmdW5jdGlvbihjaGlsZCkgewogICAgICByZXR1cm4gISEodGhpcy5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihjaGlsZCkgJiAxNik7CiAgICB9OwogICAgdmFyIGwxMG5UZW1wbGF0ZXMgPSB7fTsKICAgIGZ1bmN0aW9uIGdldEwxMG5UZW1wbGF0ZSh0b2tlbikgewogICAgICB2YXIgdGVtcGxhdGUgPSBiYXNpcy50ZW1wbGF0ZS5nZXRMMTBuVGVtcGxhdGUodG9rZW4pOwogICAgICB2YXIgaWQgPSB0ZW1wbGF0ZS50ZW1wbGF0ZUlkOwogICAgICB2YXIgaHRtbFRlbXBsYXRlID0gbDEwblRlbXBsYXRlc1tpZF07CiAgICAgIGlmICghaHRtbFRlbXBsYXRlKSBodG1sVGVtcGxhdGUgPSBsMTBuVGVtcGxhdGVzW2lkXSA9IG5ldyBIdG1sVGVtcGxhdGUodGVtcGxhdGUuc291cmNlKTsKICAgICAgcmV0dXJuIGh0bWxUZW1wbGF0ZTsKICAgIH0KICAgIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50SGFuZGxlcihhdHRyTmFtZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICBpZiAoZXZlbnQudHlwZSA9PSAiY2xpY2siICYmIGV2ZW50LndoaWNoID09IDMpIHJldHVybjsKICAgICAgICB2YXIgYnViYmxlID0gaW5zaWRlRWxlbWVudEV2ZW50W2V2ZW50LnR5cGVdIHx8IGV2ZW50LnR5cGUgIT0gIm1vdXNlZW50ZXIiICYmIGV2ZW50LnR5cGUgIT0gIm1vdXNlbGVhdmUiOwogICAgICAgIHZhciBhdHRyQ3Vyc29yID0gZXZlbnQuc2VuZGVyOwogICAgICAgIHZhciBhdHRyOwogICAgICAgIHdoaWxlIChhdHRyQ3Vyc29yKSB7CiAgICAgICAgICBhdHRyID0gYXR0ckN1cnNvci5nZXRBdHRyaWJ1dGUgJiYgYXR0ckN1cnNvci5nZXRBdHRyaWJ1dGUoYXR0ck5hbWUpOwogICAgICAgICAgaWYgKCFidWJibGUgfHwgdHlwZW9mIGF0dHIgPT0gInN0cmluZyIpIGJyZWFrOwogICAgICAgICAgYXR0ckN1cnNvciA9IGF0dHJDdXJzb3IucGFyZW50Tm9kZTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBhdHRyID09ICJzdHJpbmciKSB7CiAgICAgICAgICB2YXIgY3Vyc29yID0gYXR0ckN1cnNvcjsKICAgICAgICAgIHZhciBhY3Rpb25UYXJnZXQgPSBjdXJzb3I7CiAgICAgICAgICB2YXIgcmVmSWQ7CiAgICAgICAgICB2YXIgdG1wbFJlZjsKICAgICAgICAgIGlmIChpbnNpZGVFbGVtZW50RXZlbnRbZXZlbnQudHlwZV0pIHsKICAgICAgICAgICAgdmFyIHJlbFRhcmdldCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICAgIGlmIChyZWxUYXJnZXQgJiYgKGN1cnNvciA9PT0gcmVsVGFyZ2V0IHx8IGN1cnNvci5jb250YWlucyhyZWxUYXJnZXQpKSkgY3Vyc29yID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChjdXJzb3IpIHsKICAgICAgICAgICAgcmVmSWQgPSBjdXJzb3JbYmFzaXNUZW1wbGF0ZUlkTWFya2VyXTsKICAgICAgICAgICAgaWYgKHR5cGVvZiByZWZJZCA9PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGlmICh0bXBsUmVmID0gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCkpIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnNvciA9IGN1cnNvci5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRtcGxSZWYgJiYgdG1wbFJlZi5hY3Rpb24pIHsKICAgICAgICAgICAgdmFyIGFjdGlvbnMgPSBhdHRyLnRyaW0oKS5zcGxpdCgvXHMrLyk7CiAgICAgICAgICAgIGV2ZW50LmFjdGlvblRhcmdldCA9IGFjdGlvblRhcmdldDsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGFjdGlvbk5hbWU7IGFjdGlvbk5hbWUgPSBhY3Rpb25zW2krK107ICkgc3dpdGNoIChhY3Rpb25OYW1lKSB7CiAgICAgICAgICAgICAgY2FzZSAicHJldmVudC1kZWZhdWx0IjoKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlICJzdG9wLXByb3BhZ2F0aW9uIjoKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRtcGxSZWYuYWN0aW9uLmNhbGwodG1wbFJlZi5jb250ZXh0LCBhY3Rpb25OYW1lLCBldmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGV2ZW50LnR5cGUgaW4gYWZ0ZXJFdmVudEFjdGlvbikgYWZ0ZXJFdmVudEFjdGlvbltldmVudC50eXBlXShldmVudCwgYXR0ckN1cnNvcik7CiAgICAgIH07CiAgICB9CiAgICB2YXIgYnVpbGRIdG1sID0gZnVuY3Rpb24odG9rZW5zLCBwYXJlbnQpIHsKICAgICAgZnVuY3Rpb24gZW11bGF0ZUV2ZW50KG9yaWdFdmVudE5hbWUsIGVtdWxFdmVudE5hbWUpIHsKICAgICAgICByZWdFdmVudEhhbmRsZXIoZW11bEV2ZW50TmFtZSk7CiAgICAgICAgaW5zaWRlRWxlbWVudEV2ZW50W29yaWdFdmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICBhZnRlckV2ZW50QWN0aW9uW2VtdWxFdmVudE5hbWVdID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIGV2ZW50ID0gbmV3IGRvbUV2ZW50LkV2ZW50KGV2ZW50KTsKICAgICAgICAgIGV2ZW50LnR5cGUgPSBvcmlnRXZlbnROYW1lOwogICAgICAgICAgdG1wbEV2ZW50TGlzdGVuZXJzW29yaWdFdmVudE5hbWVdKGV2ZW50KTsKICAgICAgICB9OwogICAgICAgIGFmdGVyRXZlbnRBY3Rpb25bb3JpZ0V2ZW50TmFtZV0gPSBmdW5jdGlvbihldmVudCwgY3Vyc29yKSB7CiAgICAgICAgICBjdXJzb3IgPSBjdXJzb3IgJiYgY3Vyc29yLnBhcmVudE5vZGU7CiAgICAgICAgICBpZiAoY3Vyc29yKSB7CiAgICAgICAgICAgIGV2ZW50ID0gbmV3IGRvbUV2ZW50LkV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgZXZlbnQudHlwZSA9IG9yaWdFdmVudE5hbWU7CiAgICAgICAgICAgIGV2ZW50LnNlbmRlciA9IGN1cnNvcjsKICAgICAgICAgICAgdG1wbEV2ZW50TGlzdGVuZXJzW29yaWdFdmVudE5hbWVdKGV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlZ0V2ZW50SGFuZGxlcihldmVudE5hbWUpIHsKICAgICAgICBpZiAoIXRtcGxFdmVudExpc3RlbmVyc1tldmVudE5hbWVdKSB7CiAgICAgICAgICB0bXBsRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXSA9IGNyZWF0ZUV2ZW50SGFuZGxlcigiZXZlbnQtIiArIGV2ZW50TmFtZSk7CiAgICAgICAgICBpZiAoIUNBUFRVUkVfRkFMTEJBQ0spIHsKICAgICAgICAgICAgaWYgKCFNT1VTRV9FTlRFUl9MRUFWRV9TVVBQT1JUICYmIGV2ZW50TmFtZSA9PSAibW91c2VlbnRlciIpIHJldHVybiBlbXVsYXRlRXZlbnQoZXZlbnROYW1lLCAibW91c2VvdmVyIik7CiAgICAgICAgICAgIGlmICghTU9VU0VfRU5URVJfTEVBVkVfU1VQUE9SVCAmJiBldmVudE5hbWUgPT0gIm1vdXNlbGVhdmUiKSByZXR1cm4gZW11bGF0ZUV2ZW50KGV2ZW50TmFtZSwgIm1vdXNlb3V0Iik7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBuYW1lcyA9IGRvbUV2ZW50LmJyb3dzZXJFdmVudHMoZXZlbnROYW1lKSwgYnJvd3NlckV2ZW50TmFtZTsgYnJvd3NlckV2ZW50TmFtZSA9IG5hbWVzW2ldOyBpKyspIGRvbUV2ZW50LmFkZEdsb2JhbEhhbmRsZXIoYnJvd3NlckV2ZW50TmFtZSwgdG1wbEV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBzZXRFdmVudEF0dHJpYnV0ZShldmVudE5hbWUsIGFjdGlvbnMpIHsKICAgICAgICByZWdFdmVudEhhbmRsZXIoZXZlbnROYW1lKTsKICAgICAgICBpZiAoQ0FQVFVSRV9GQUxMQkFDSykgcmVzdWx0LnNldEF0dHJpYnV0ZSgib24iICsgZXZlbnROYW1lLCBDQVBUVVJFX0ZBTExCQUNLICsgJygiJyArIGV2ZW50TmFtZSArICciLGV2ZW50KScpOwogICAgICAgIHJlc3VsdC5zZXRBdHRyaWJ1dGUoImV2ZW50LSIgKyBldmVudE5hbWUsIGFjdGlvbnMpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSkgewogICAgICAgIGlmIChTRVRfQ0xBU1NfQVRUUklCVVRFX0JVRyAmJiBuYW1lID09ICJjbGFzcyIpIG5hbWUgPSAiY2xhc3NOYW1lIjsKICAgICAgICBpZiAoU0VUX1NUWUxFX0FUVFJJQlVURV9CVUcgJiYgbmFtZSA9PSAic3R5bGUiKSByZXR1cm4gcmVzdWx0LnN0eWxlLmNzc1RleHQgPSB2YWx1ZTsKICAgICAgICByZXN1bHQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTsKICAgICAgfQogICAgICB2YXIgcmVzdWx0ID0gcGFyZW50IHx8IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgZm9yICh2YXIgaSA9IHBhcmVudCA/IDQgOiAwLCB0b2tlbjsgdG9rZW4gPSB0b2tlbnNbaV07IGkrKykgewogICAgICAgIHN3aXRjaCAodG9rZW5bVE9LRU5fVFlQRV0pIHsKICAgICAgICAgIGNhc2UgVFlQRV9FTEVNRU5UOgogICAgICAgICAgICB2YXIgdGFnTmFtZSA9IHRva2VuW0VMRU1FTlRfTkFNRV07CiAgICAgICAgICAgIHZhciBwYXJ0cyA9IHRhZ05hbWUuc3BsaXQoLzovKTsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBwYXJ0cy5sZW5ndGggPiAxID8gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZVVSSVtwYXJ0c1swXV0sIHRhZ05hbWUpIDogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWdOYW1lKTsKICAgICAgICAgICAgYnVpbGRIdG1sKHRva2VuLCBlbGVtZW50KTsKICAgICAgICAgICAgcmVzdWx0LmFwcGVuZENoaWxkKGVsZW1lbnQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgVFlQRV9BVFRSSUJVVEU6CiAgICAgICAgICAgIHZhciBhdHRyTmFtZSA9IHRva2VuW0FUVFJfTkFNRV07CiAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSB0b2tlbltBVFRSX1ZBTFVFXTsKICAgICAgICAgICAgdmFyIGV2ZW50TmFtZSA9IGF0dHJOYW1lLnJlcGxhY2UoL15ldmVudC0vLCAiIik7CiAgICAgICAgICAgIGlmIChldmVudE5hbWUgIT0gYXR0ck5hbWUpIHsKICAgICAgICAgICAgICBzZXRFdmVudEF0dHJpYnV0ZShldmVudE5hbWUsIGF0dHJWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKGF0dHJOYW1lICE9ICJjbGFzcyIgJiYgYXR0ck5hbWUgIT0gInN0eWxlIiA/ICF0b2tlbltUT0tFTl9CSU5ESU5HU10gOiBhdHRyVmFsdWUpIHNldEF0dHJpYnV0ZShhdHRyTmFtZSwgYXR0clZhbHVlIHx8ICIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgdmFyIGF0dHJWYWx1ZSA9IHRva2VuW0FUVFJfVkFMVUUgLSAxXTsKICAgICAgICAgICAgaWYgKGF0dHJWYWx1ZSkgc2V0QXR0cmlidXRlKEFUVFJfTkFNRV9CWV9UWVBFW3Rva2VuW1RPS0VOX1RZUEVdXSwgYXR0clZhbHVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDY6CiAgICAgICAgICAgIHNldEV2ZW50QXR0cmlidXRlKHRva2VuWzFdLCB0b2tlblsyXSB8fCB0b2tlblsxXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSBUWVBFX0NPTU1FTlQ6CiAgICAgICAgICAgIHJlc3VsdC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVDb21tZW50KHRva2VuW0NPTU1FTlRfVkFMVUVdIHx8ICh0b2tlbltUT0tFTl9SRUZTXSA/ICJ7IiArIHRva2VuW1RPS0VOX1JFRlNdLmpvaW4oInwiKSArICJ9IiA6ICIiKSkpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgVFlQRV9URVhUOgogICAgICAgICAgICBpZiAoQ0xPTkVfTk9STUFMSVpBVElPTl9URVhUX0JVRyAmJiBpICYmIHRva2Vuc1tpIC0gMV1bVE9LRU5fVFlQRV0gPT0gVFlQRV9URVhUKSByZXN1bHQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikpOwogICAgICAgICAgICByZXN1bHQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodG9rZW5bVEVYVF9WQUxVRV0gfHwgKHRva2VuW1RPS0VOX1JFRlNdID8gInsiICsgdG9rZW5bVE9LRU5fUkVGU10uam9pbigifCIpICsgIn0iIDogIiIpIHx8ICh0b2tlbltUT0tFTl9CSU5ESU5HU10gPyAieyIgKyB0b2tlbltUT0tFTl9CSU5ESU5HU10gKyAifSIgOiAiIikpKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICghcGFyZW50ICYmIHRva2Vucy5sZW5ndGggPT0gMSkgcmVzdWx0ID0gcmVzdWx0LmZpcnN0Q2hpbGQ7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgZnVuY3Rpb24gcmVzb2x2ZVRlbXBsYXRlQnlJZChyZWZJZCkgewogICAgICB2YXIgdGVtcGxhdGVJZCA9IHJlZklkICYgNDA5NTsKICAgICAgdmFyIG9iamVjdCA9IHRlbXBsYXRlc1t0ZW1wbGF0ZUlkXTsKICAgICAgcmV0dXJuIG9iamVjdCAmJiBvYmplY3QudGVtcGxhdGU7CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlSW5zdGFuY2VCeUlkKHJlZklkKSB7CiAgICAgIHZhciB0ZW1wbGF0ZUlkID0gcmVmSWQgJiA0MDk1OwogICAgICB2YXIgaW5zdGFuY2VJZCA9IHJlZklkID4+IDEyOwogICAgICB2YXIgb2JqZWN0ID0gdGVtcGxhdGVzW3RlbXBsYXRlSWRdOwogICAgICByZXR1cm4gb2JqZWN0ICYmIG9iamVjdC5pbnN0YW5jZXNbaW5zdGFuY2VJZF07CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlT2JqZWN0QnlJZChyZWZJZCkgewogICAgICB2YXIgdGVtcGxhdGVSZWYgPSByZXNvbHZlSW5zdGFuY2VCeUlkKHJlZklkKTsKICAgICAgcmV0dXJuIHRlbXBsYXRlUmVmICYmIHRlbXBsYXRlUmVmLmNvbnRleHQ7CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlVG1wbEJ5SWQocmVmSWQpIHsKICAgICAgdmFyIHRlbXBsYXRlUmVmID0gcmVzb2x2ZUluc3RhbmNlQnlJZChyZWZJZCk7CiAgICAgIHJldHVybiB0ZW1wbGF0ZVJlZiAmJiB0ZW1wbGF0ZVJlZi50bXBsOwogICAgfQogICAgZnVuY3Rpb24gZ2V0RGVidWdJbmZvQnlJZChyZWZJZCkgewogICAgICB2YXIgdGVtcGxhdGVSZWYgPSByZXNvbHZlSW5zdGFuY2VCeUlkKHJlZklkKTsKICAgICAgcmV0dXJuIHRlbXBsYXRlUmVmICYmIHRlbXBsYXRlUmVmLmRlYnVnICYmIHRlbXBsYXRlUmVmLmRlYnVnKCk7CiAgICB9CiAgICB2YXIgYnVpbGRlciA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgV0hJVEVTUEFDRSA9IC9ccysvOwogICAgICB2YXIgVzNDX0RPTV9OT0RFX1NVUFBPUlRFRCA9IHR5cGVvZiBOb2RlID09ICJmdW5jdGlvbiIgJiYgZG9jdW1lbnQgaW5zdGFuY2VvZiBOb2RlOwogICAgICB2YXIgQ0xBU1NMSVNUX1NVUFBPUlRFRCA9IGdsb2JhbC5ET01Ub2tlbkxpc3QgJiYgZG9jdW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsYXNzTGlzdCBpbnN0YW5jZW9mIGdsb2JhbC5ET01Ub2tlbkxpc3Q7CiAgICAgIHZhciBiaW5kX25vZGUgPSBXM0NfRE9NX05PREVfU1VQUE9SVEVEID8gZnVuY3Rpb24oZG9tUmVmLCBvbGROb2RlLCBuZXdWYWx1ZSkgewogICAgICAgIHZhciBuZXdOb2RlID0gbmV3VmFsdWUgJiYgbmV3VmFsdWUgaW5zdGFuY2VvZiBOb2RlID8gbmV3VmFsdWUgOiBkb21SZWY7CiAgICAgICAgaWYgKG5ld05vZGUgIT09IG9sZE5vZGUpIG9sZE5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgb2xkTm9kZSk7CiAgICAgICAgcmV0dXJuIG5ld05vZGU7CiAgICAgIH0gOiBmdW5jdGlvbihkb21SZWYsIG9sZE5vZGUsIG5ld1ZhbHVlKSB7CiAgICAgICAgdmFyIG5ld05vZGUgPSBuZXdWYWx1ZSAmJiB0eXBlb2YgbmV3VmFsdWUgPT0gIm9iamVjdCIgPyBuZXdWYWx1ZSA6IGRvbVJlZjsKICAgICAgICBpZiAobmV3Tm9kZSAhPT0gb2xkTm9kZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgb2xkTm9kZS5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChuZXdOb2RlLCBvbGROb2RlKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgbmV3Tm9kZSA9IGRvbVJlZjsKICAgICAgICAgICAgaWYgKG9sZE5vZGUgIT09IG5ld05vZGUpIG9sZE5vZGUucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQobmV3Tm9kZSwgb2xkTm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdOb2RlOwogICAgICB9OwogICAgICB2YXIgYmluZF9lbGVtZW50ID0gZnVuY3Rpb24oZG9tUmVmLCBvbGROb2RlLCBuZXdWYWx1ZSkgewogICAgICAgIHZhciBuZXdOb2RlID0gYmluZF9ub2RlKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpOwogICAgICAgIGlmIChuZXdOb2RlID09PSBkb21SZWYgJiYgdHlwZW9mIG5ld1ZhbHVlID09ICJzdHJpbmciKSBkb21SZWYuaW5uZXJIVE1MID0gbmV3VmFsdWU7CiAgICAgICAgcmV0dXJuIG5ld05vZGU7CiAgICAgIH07CiAgICAgIHZhciBiaW5kX2NvbW1lbnQgPSBiaW5kX25vZGU7CiAgICAgIHZhciBiaW5kX3RleHROb2RlID0gZnVuY3Rpb24oZG9tUmVmLCBvbGROb2RlLCBuZXdWYWx1ZSkgewogICAgICAgIHZhciBuZXdOb2RlID0gYmluZF9ub2RlKGRvbVJlZiwgb2xkTm9kZSwgbmV3VmFsdWUpOwogICAgICAgIGlmIChuZXdOb2RlID09PSBkb21SZWYpIGRvbVJlZi5ub2RlVmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICByZXR1cm4gbmV3Tm9kZTsKICAgICAgfTsKICAgICAgdmFyIGJpbmRfYXR0ckNsYXNzID0gQ0xBU1NMSVNUX1NVUFBPUlRFRCA/IGZ1bmN0aW9uKGRvbVJlZiwgb2xkQ2xhc3MsIG5ld1ZhbHVlLCBwcmVmaXgsIGFuaW0pIHsKICAgICAgICB2YXIgbmV3Q2xhc3MgPSBuZXdWYWx1ZSA/IHByZWZpeCArIG5ld1ZhbHVlIDogIiI7CiAgICAgICAgaWYgKG5ld0NsYXNzICE9IG9sZENsYXNzKSB7CiAgICAgICAgICBpZiAob2xkQ2xhc3MpIGRvbVJlZi5jbGFzc0xpc3QucmVtb3ZlKG9sZENsYXNzKTsKICAgICAgICAgIGlmIChuZXdDbGFzcykgewogICAgICAgICAgICBkb21SZWYuY2xhc3NMaXN0LmFkZChuZXdDbGFzcyk7CiAgICAgICAgICAgIGlmIChhbmltKSB7CiAgICAgICAgICAgICAgZG9tUmVmLmNsYXNzTGlzdC5hZGQobmV3Q2xhc3MgKyAiLWFuaW0iKTsKICAgICAgICAgICAgICBiYXNpcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGRvbVJlZi5jbGFzc0xpc3QucmVtb3ZlKG5ld0NsYXNzICsgIi1hbmltIik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld0NsYXNzOwogICAgICB9IDogZnVuY3Rpb24oZG9tUmVmLCBvbGRDbGFzcywgbmV3VmFsdWUsIHByZWZpeCwgYW5pbSkgewogICAgICAgIHZhciBuZXdDbGFzcyA9IG5ld1ZhbHVlID8gcHJlZml4ICsgbmV3VmFsdWUgOiAiIjsKICAgICAgICBpZiAobmV3Q2xhc3MgIT0gb2xkQ2xhc3MpIHsKICAgICAgICAgIHZhciBjbGFzc05hbWUgPSBkb21SZWYuY2xhc3NOYW1lOwogICAgICAgICAgdmFyIGNsYXNzTmFtZUlzT2JqZWN0ID0gdHlwZW9mIGNsYXNzTmFtZSAhPSAic3RyaW5nIjsKICAgICAgICAgIHZhciBjbGFzc0xpc3Q7CiAgICAgICAgICBpZiAoY2xhc3NOYW1lSXNPYmplY3QpIGNsYXNzTmFtZSA9IGNsYXNzTmFtZS5iYXNlVmFsOwogICAgICAgICAgY2xhc3NMaXN0ID0gY2xhc3NOYW1lLnNwbGl0KFdISVRFU1BBQ0UpOwogICAgICAgICAgaWYgKG9sZENsYXNzKSBiYXNpcy5hcnJheS5yZW1vdmUoY2xhc3NMaXN0LCBvbGRDbGFzcyk7CiAgICAgICAgICBpZiAobmV3Q2xhc3MpIHsKICAgICAgICAgICAgY2xhc3NMaXN0LnB1c2gobmV3Q2xhc3MpOwogICAgICAgICAgICBpZiAoYW5pbSkgewogICAgICAgICAgICAgIGJhc2lzLmFycmF5LmFkZChjbGFzc0xpc3QsIG5ld0NsYXNzICsgIi1hbmltIik7CiAgICAgICAgICAgICAgYmFzaXMubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xhc3NMaXN0ID0gKGNsYXNzTmFtZUlzT2JqZWN0ID8gZG9tUmVmLmNsYXNzTmFtZS5iYXNlVmFsIDogZG9tUmVmLmNsYXNzTmFtZSkuc3BsaXQoV0hJVEVTUEFDRSk7CiAgICAgICAgICAgICAgICBiYXNpcy5hcnJheS5yZW1vdmUoY2xhc3NMaXN0LCBuZXdDbGFzcyArICItYW5pbSIpOwogICAgICAgICAgICAgICAgaWYgKGNsYXNzTmFtZUlzT2JqZWN0KSBkb21SZWYuY2xhc3NOYW1lLmJhc2VWYWwgPSBjbGFzc0xpc3Quam9pbigiICIpOyBlbHNlIGRvbVJlZi5jbGFzc05hbWUgPSBjbGFzc0xpc3Quam9pbigiICIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2xhc3NOYW1lSXNPYmplY3QpIGRvbVJlZi5jbGFzc05hbWUuYmFzZVZhbCA9IGNsYXNzTGlzdC5qb2luKCIgIik7IGVsc2UgZG9tUmVmLmNsYXNzTmFtZSA9IGNsYXNzTGlzdC5qb2luKCIgIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdDbGFzczsKICAgICAgfTsKICAgICAgdmFyIGJpbmRfYXR0clN0eWxlID0gSVNfU0VUX1NUWUxFX1NBRkUgPyBmdW5jdGlvbihkb21SZWYsIHByb3BlcnR5TmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7CiAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBuZXdWYWx1ZSkgZG9tUmVmLnN0eWxlW2NhbWVsaXplKHByb3BlcnR5TmFtZSldID0gbmV3VmFsdWU7CiAgICAgICAgcmV0dXJuIG5ld1ZhbHVlOwogICAgICB9IDogZnVuY3Rpb24oZG9tUmVmLCBwcm9wZXJ0eU5hbWUsIG9sZFZhbHVlLCBuZXdWYWx1ZSkgewogICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGRvbVJlZi5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eU5hbWUpXSA9IG5ld1ZhbHVlOwogICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld1ZhbHVlOwogICAgICB9OwogICAgICB2YXIgYmluZF9hdHRyID0gZnVuY3Rpb24oZG9tUmVmLCBhdHRyTmFtZSwgb2xkVmFsdWUsIG5ld1ZhbHVlKSB7CiAgICAgICAgaWYgKG9sZFZhbHVlICE9PSBuZXdWYWx1ZSkgewogICAgICAgICAgaWYgKG5ld1ZhbHVlKSBkb21SZWYuc2V0QXR0cmlidXRlKGF0dHJOYW1lLCBuZXdWYWx1ZSk7IGVsc2UgZG9tUmVmLnJlbW92ZUF0dHJpYnV0ZShhdHRyTmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdWYWx1ZTsKICAgICAgfTsKICAgICAgZnVuY3Rpb24gdXBkYXRlQXR0YWNoKCkgewogICAgICAgIHRoaXMuc2V0KHRoaXMubmFtZSwgdGhpcy52YWx1ZSk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcmVzb2x2ZVZhbHVlKGJpbmRpbmdOYW1lLCB2YWx1ZSwgQXR0YWNoZXMpIHsKICAgICAgICB2YXIgYnJpZGdlID0gdmFsdWUgJiYgdmFsdWUuYmluZGluZ0JyaWRnZTsKICAgICAgICB2YXIgb2xkQXR0YWNoID0gdGhpcy5hdHRhY2hlcyAmJiB0aGlzLmF0dGFjaGVzW2JpbmRpbmdOYW1lXTsKICAgICAgICB2YXIgdG1wbCA9IG51bGw7CiAgICAgICAgaWYgKGJyaWRnZSB8fCBvbGRBdHRhY2gpIHsKICAgICAgICAgIGlmIChicmlkZ2UpIHsKICAgICAgICAgICAgaWYgKCFvbGRBdHRhY2ggfHwgdmFsdWUgIT09IG9sZEF0dGFjaC52YWx1ZSkgewogICAgICAgICAgICAgIGlmIChvbGRBdHRhY2gpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRBdHRhY2gudG1wbCkgewogICAgICAgICAgICAgICAgICBvbGRBdHRhY2gudG1wbC5lbGVtZW50LnRvU3RyaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgICAgZ2V0TDEwblRlbXBsYXRlKG9sZEF0dGFjaC52YWx1ZSkuY2xlYXJJbnN0YW5jZShvbGRBdHRhY2gudG1wbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvbGRBdHRhY2gudmFsdWUuYmluZGluZ0JyaWRnZS5kZXRhY2gob2xkQXR0YWNoLnZhbHVlLCB1cGRhdGVBdHRhY2gsIG9sZEF0dGFjaCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh2YWx1ZS50eXBlID09ICJtYXJrdXAiICYmIHZhbHVlIGluc3RhbmNlb2YgYmFzaXMubDEwbi5Ub2tlbikgewogICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gZ2V0TDEwblRlbXBsYXRlKHZhbHVlKTsKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdGhpcy5jb250ZXh0OwogICAgICAgICAgICAgICAgdmFyIGJpbmRpbmdzID0gdGhpcy5iaW5kaW5nczsKICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nSW50ZXJmYWNlID0gdGhpcy5iaW5kaW5nSW50ZXJmYWNlOwogICAgICAgICAgICAgICAgdG1wbCA9IHRlbXBsYXRlLmNyZWF0ZUluc3RhbmNlKGNvbnRleHQsIG51bGwsIGZ1bmN0aW9uIG9uUmVidWlsZCgpIHsKICAgICAgICAgICAgICAgICAgdG1wbCA9IG5ld0F0dGFjaC50bXBsID0gdGVtcGxhdGUuY3JlYXRlSW5zdGFuY2UoY29udGV4dCwgbnVsbCwgb25SZWJ1aWxkLCBiaW5kaW5ncywgYmluZGluZ0ludGVyZmFjZSk7CiAgICAgICAgICAgICAgICAgIHRtcGwuZWxlbWVudC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS52YWx1ZTsKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgdXBkYXRlQXR0YWNoLmNhbGwobmV3QXR0YWNoKTsKICAgICAgICAgICAgICAgIH0sIGJpbmRpbmdzLCBiaW5kaW5nSW50ZXJmYWNlKTsKICAgICAgICAgICAgICAgIHRtcGwuZWxlbWVudC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUudmFsdWU7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIXRoaXMuYXR0YWNoZXMpIHRoaXMuYXR0YWNoZXMgPSBuZXcgQXR0YWNoZXM7CiAgICAgICAgICAgICAgdmFyIG5ld0F0dGFjaCA9IHRoaXMuYXR0YWNoZXNbYmluZGluZ05hbWVdID0gewogICAgICAgICAgICAgICAgbmFtZTogYmluZGluZ05hbWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgICB0bXBsOiB0bXBsLAogICAgICAgICAgICAgICAgc2V0OiB0aGlzLnRtcGwuc2V0CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBicmlkZ2UuYXR0YWNoKHZhbHVlLCB1cGRhdGVBdHRhY2gsIG5ld0F0dGFjaCk7CiAgICAgICAgICAgIH0gZWxzZSB0bXBsID0gdmFsdWUgJiYgdmFsdWUudHlwZSA9PSAibWFya3VwIiA/IG9sZEF0dGFjaC50bXBsIDogbnVsbDsKICAgICAgICAgICAgaWYgKHRtcGwpIHJldHVybiB0bXBsLmVsZW1lbnQ7CiAgICAgICAgICAgIHZhbHVlID0gYnJpZGdlLmdldCh2YWx1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAob2xkQXR0YWNoKSB7CiAgICAgICAgICAgICAgaWYgKG9sZEF0dGFjaC50bXBsKSB7CiAgICAgICAgICAgICAgICBvbGRBdHRhY2gudG1wbC5lbGVtZW50LnRvU3RyaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIGdldEwxMG5UZW1wbGF0ZShvbGRBdHRhY2gudmFsdWUpLmNsZWFySW5zdGFuY2Uob2xkQXR0YWNoLnRtcGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBvbGRBdHRhY2gudmFsdWUuYmluZGluZ0JyaWRnZS5kZXRhY2gob2xkQXR0YWNoLnZhbHVlLCB1cGRhdGVBdHRhY2gsIG9sZEF0dGFjaCk7CiAgICAgICAgICAgICAgdGhpcy5hdHRhY2hlc1tiaW5kaW5nTmFtZV0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjcmVhdGVCaW5kaW5nVXBkYXRlcihuYW1lcywgZ2V0dGVycykgewogICAgICAgIHZhciBuYW1lMSA9IG5hbWVzWzBdOwogICAgICAgIHZhciBuYW1lMiA9IG5hbWVzWzFdOwogICAgICAgIHZhciBnZXR0ZXIxID0gZ2V0dGVyc1tuYW1lMV07CiAgICAgICAgdmFyIGdldHRlcjIgPSBnZXR0ZXJzW25hbWUyXTsKICAgICAgICBzd2l0Y2ggKG5hbWVzLmxlbmd0aCkgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gYmluZGluZ1VwZGF0ZXIxKG9iamVjdCkgewogICAgICAgICAgICAgIHRoaXMobmFtZTEsIGdldHRlcjEob2JqZWN0KSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBiaW5kaW5nVXBkYXRlcjIob2JqZWN0KSB7CiAgICAgICAgICAgICAgdGhpcyhuYW1lMSwgZ2V0dGVyMShvYmplY3QpKTsKICAgICAgICAgICAgICB0aGlzKG5hbWUyLCBnZXR0ZXIyKG9iamVjdCkpOwogICAgICAgICAgICB9OwogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdmFyIGdldHRlcnNfID0gbmFtZXMubWFwKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0dGVyc1tuYW1lXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBiaW5kaW5nVXBkYXRlck4ob2JqZWN0KSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuYW1lcy5sZW5ndGg7IGkrKykgdGhpcyhuYW1lc1tpXSwgZ2V0dGVyc19baV0ob2JqZWN0KSk7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIG1ha2VIYW5kbGVyKGV2ZW50cywgZ2V0dGVycykgewogICAgICAgIGZvciAodmFyIG5hbWUgaW4gZXZlbnRzKSBldmVudHNbbmFtZV0gPSBjcmVhdGVCaW5kaW5nVXBkYXRlcihldmVudHNbbmFtZV0sIGdldHRlcnMpOwogICAgICAgIHJldHVybiBuYW1lID8gZXZlbnRzIDogbnVsbDsKICAgICAgfQogICAgICBmdW5jdGlvbiBjcmVhdGVCaW5kaW5nRnVuY3Rpb24oa2V5cykgewogICAgICAgIHZhciBiaW5kaW5nQ2FjaGUgPSB7fTsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gZ2V0QmluZGluZyhiaW5kaW5ncywgb2JqLCBzZXQsIGJpbmRpbmdJbnRlcmZhY2UpIHsKICAgICAgICAgIGlmICghYmluZGluZ3MpIHJldHVybiB7fTsKICAgICAgICAgIHZhciBjYWNoZUlkID0gImJpbmRpbmdJZCIgaW4gYmluZGluZ3MgPyBiaW5kaW5ncy5iaW5kaW5nSWQgOiBudWxsOwogICAgICAgICAgaWYgKCFjYWNoZUlkKSBiYXNpcy5kZXYud2FybigiYmFzaXMudGVtcGxhdGUuVGVtcGxhdGUuZ2V0QmluZGluZzogYmluZGluZ3MgaGFzIG5vIGJpbmRpbmdJZCBwcm9wZXJ0eSwgY2FjaGUgaXMgbm90IHVzZWQiKTsKICAgICAgICAgIHZhciByZXN1bHQgPSBiaW5kaW5nQ2FjaGVbY2FjaGVJZF07CiAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgdmFyIGdldHRlcnMgPSB7fTsKICAgICAgICAgICAgdmFyIGV2ZW50cyA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgYmluZGluZ05hbWU7IGJpbmRpbmdOYW1lID0ga2V5c1tpXTsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBiaW5kaW5nc1tiaW5kaW5nTmFtZV07CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IGJpbmRpbmcgJiYgYmluZGluZy5nZXR0ZXI7CiAgICAgICAgICAgICAgaWYgKGdldHRlcikgewogICAgICAgICAgICAgICAgZ2V0dGVyc1tiaW5kaW5nTmFtZV0gPSBnZXR0ZXI7CiAgICAgICAgICAgICAgICBuYW1lcy5wdXNoKGJpbmRpbmdOYW1lKTsKICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nLmV2ZW50cykgewogICAgICAgICAgICAgICAgICB2YXIgZXZlbnRMaXN0ID0gU3RyaW5nKGJpbmRpbmcuZXZlbnRzKS50cmltKCkuc3BsaXQoL1xzK3xccyosXHMqLyk7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBldmVudE5hbWU7IGV2ZW50TmFtZSA9IGV2ZW50TGlzdFtqXTsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50c1tldmVudE5hbWVdKSBldmVudHNbZXZlbnROYW1lXS5wdXNoKGJpbmRpbmdOYW1lKTsgZWxzZSBldmVudHNbZXZlbnROYW1lXSA9IFsgYmluZGluZ05hbWUgXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHQgPSB7CiAgICAgICAgICAgICAgbmFtZXM6IG5hbWVzLAogICAgICAgICAgICAgIHN5bmM6IGNyZWF0ZUJpbmRpbmdVcGRhdGVyKG5hbWVzLCBnZXR0ZXJzKSwKICAgICAgICAgICAgICBoYW5kbGVyOiBtYWtlSGFuZGxlcihldmVudHMsIGdldHRlcnMpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChjYWNoZUlkKSBiaW5kaW5nQ2FjaGVbY2FjaGVJZF0gPSByZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAob2JqICYmIHNldCkgcmVzdWx0LnN5bmMuY2FsbChzZXQsIG9iaik7CiAgICAgICAgICBpZiAoIWJpbmRpbmdJbnRlcmZhY2UpIHJldHVybjsKICAgICAgICAgIGlmIChyZXN1bHQuaGFuZGxlcikgYmluZGluZ0ludGVyZmFjZS5hdHRhY2gob2JqLCByZXN1bHQuaGFuZGxlciwgc2V0KTsKICAgICAgICAgIHJldHVybiByZXN1bHQuaGFuZGxlcjsKICAgICAgICB9OwogICAgICB9CiAgICAgIHZhciB0b29scyA9IHsKICAgICAgICBiaW5kX3RleHROb2RlOiBiaW5kX3RleHROb2RlLAogICAgICAgIGJpbmRfbm9kZTogYmluZF9ub2RlLAogICAgICAgIGJpbmRfZWxlbWVudDogYmluZF9lbGVtZW50LAogICAgICAgIGJpbmRfY29tbWVudDogYmluZF9jb21tZW50LAogICAgICAgIGJpbmRfYXR0cjogYmluZF9hdHRyLAogICAgICAgIGJpbmRfYXR0ckNsYXNzOiBiaW5kX2F0dHJDbGFzcywKICAgICAgICBiaW5kX2F0dHJTdHlsZTogYmluZF9hdHRyU3R5bGUsCiAgICAgICAgcmVzb2x2ZTogcmVzb2x2ZVZhbHVlLAogICAgICAgIGwxMG5Ub2tlbjogbDEwblRva2VuLAogICAgICAgIGNyZWF0ZUJpbmRpbmdGdW5jdGlvbjogY3JlYXRlQmluZGluZ0Z1bmN0aW9uCiAgICAgIH07CiAgICAgIHJldHVybiBmdW5jdGlvbih0b2tlbnMpIHsKICAgICAgICB2YXIgZm4gPSBnZXRGdW5jdGlvbnModG9rZW5zLCB0cnVlLCB0aGlzLnNvdXJjZS51cmwsIHRva2Vucy5zb3VyY2VfLCAhQ0xPTkVfTk9STUFMSVpBVElPTl9URVhUX0JVRywgYmFzaXNUZW1wbGF0ZUlkTWFya2VyKTsKICAgICAgICB2YXIgY3JlYXRlSW5zdGFuY2U7CiAgICAgICAgdmFyIGluc3RhbmNlcyA9IHt9OwogICAgICAgIHZhciBsMTBuTWFwID0ge307CiAgICAgICAgdmFyIGwxMG5MaW5rcyA9IFtdOwogICAgICAgIHZhciBzZWVkID0gMDsKICAgICAgICB2YXIgcHJvdG8gPSBidWlsZEh0bWwodG9rZW5zKTsKICAgICAgICB2YXIgaWQgPSB0aGlzLnRlbXBsYXRlSWQ7CiAgICAgICAgdGVtcGxhdGVzW2lkXSA9IHsKICAgICAgICAgIHRlbXBsYXRlOiB0aGlzLAogICAgICAgICAgaW5zdGFuY2VzOiBpbnN0YW5jZXMKICAgICAgICB9OwogICAgICAgIGlmIChmbi5jcmVhdGVMMTBuU3luYykgewogICAgICAgICAgdmFyIGwxMG5Qcm90b1N5bmMgPSBmbi5jcmVhdGVMMTBuU3luYyhwcm90bywgbDEwbk1hcCwgYmluZF9hdHRyLCBDTE9ORV9OT1JNQUxJWkFUSU9OX1RFWFRfQlVHKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGZuLmwxMG5LZXlzW2ldOyBpKyspIGwxMG5Qcm90b1N5bmMoa2V5LCBsMTBuVG9rZW4oa2V5KS52YWx1ZSk7CiAgICAgICAgICBpZiAoZm4ubDEwbktleXMpIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGZuLmwxMG5LZXlzW2ldOyBpKyspIHsKICAgICAgICAgICAgdmFyIGxpbmsgPSB7CiAgICAgICAgICAgICAgcGF0aDoga2V5LAogICAgICAgICAgICAgIHRva2VuOiBsMTBuVG9rZW4oa2V5KSwKICAgICAgICAgICAgICBoYW5kbGVyOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgbDEwblByb3RvU3luYyh0aGlzLnBhdGgsIHZhbHVlKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBpbnN0YW5jZXMpIGluc3RhbmNlc1trZXldLnRtcGwuc2V0KHRoaXMucGF0aCwgdmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgbGluay50b2tlbi5hdHRhY2gobGluay5oYW5kbGVyLCBsaW5rKTsKICAgICAgICAgICAgbDEwbkxpbmtzLnB1c2gobGluayk7CiAgICAgICAgICAgIGxpbmsgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjcmVhdGVJbnN0YW5jZSA9IGZuLmNyZWF0ZUluc3RhbmNlKGlkLCBpbnN0YW5jZXMsIHByb3RvLCB0b29scywgbDEwbk1hcCwgQ0xPTkVfTk9STUFMSVpBVElPTl9URVhUX0JVRyk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNyZWF0ZUluc3RhbmNlOiBmdW5jdGlvbihvYmosIG9uQWN0aW9uLCBvblJlYnVpbGQsIGJpbmRpbmdzLCBiaW5kaW5nSW50ZXJmYWNlKSB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZUlkID0gc2VlZCsrOwogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjcmVhdGVJbnN0YW5jZShpbnN0YW5jZUlkLCBvYmosIG9uQWN0aW9uLCBvblJlYnVpbGQsIGJpbmRpbmdzLCBiaW5kaW5nSW50ZXJmYWNlKTsKICAgICAgICAgICAgaW5zdGFuY2VzW2luc3RhbmNlSWRdID0gaW5zdGFuY2U7CiAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZS50bXBsOwogICAgICAgICAgfSwKICAgICAgICAgIGRlc3Ryb3lJbnN0YW5jZTogZnVuY3Rpb24odG1wbCkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2VJZCA9IHRtcGwudGVtcGxhdGVJZF87CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGluc3RhbmNlc1tpbnN0YW5jZUlkXTsKICAgICAgICAgICAgaWYgKGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLmhhbmRsZXIpIGluc3RhbmNlLmJpbmRpbmdJbnRlcmZhY2UuZGV0YWNoKGluc3RhbmNlLmNvbnRleHQsIGluc3RhbmNlLmhhbmRsZXIsIGluc3RhbmNlLnRtcGwuc2V0KTsKICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2UuYXR0YWNoZXMpIHJlc29sdmVWYWx1ZS5jYWxsKGluc3RhbmNlLCBrZXksIG51bGwpOwogICAgICAgICAgICAgIGRlbGV0ZSBpbnN0YW5jZXNbaW5zdGFuY2VJZF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBrZXlzOiBmbi5rZXlzLAogICAgICAgICAgaW5zdGFuY2VzXzogaW5zdGFuY2VzLAogICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24ocmVidWlsZCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGluazsgbGluayA9IGwxMG5MaW5rc1tpXTsgaSsrKSBsaW5rLnRva2VuLmRldGFjaChsaW5rLmhhbmRsZXIsIGxpbmspOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gaW5zdGFuY2VzW2tleV07CiAgICAgICAgICAgICAgaWYgKHJlYnVpbGQgJiYgaW5zdGFuY2UucmVidWlsZCkgaW5zdGFuY2UucmVidWlsZC5jYWxsKGluc3RhbmNlLmNvbnRleHQpOwogICAgICAgICAgICAgIGlmICghcmVidWlsZCB8fCBrZXkgaW4gaW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UuaGFuZGxlcikgaW5zdGFuY2UuYmluZGluZ0ludGVyZmFjZS5kZXRhY2goaW5zdGFuY2UuY29udGV4dCwgaW5zdGFuY2UuaGFuZGxlciwgaW5zdGFuY2UudG1wbC5zZXQpOwogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGluc3RhbmNlLmF0dGFjaGVzKSByZXNvbHZlVmFsdWUuY2FsbChrZXksIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGVtcGxhdGVzW2lkXSAmJiB0ZW1wbGF0ZXNbaWRdLmluc3RhbmNlcyA9PT0gaW5zdGFuY2VzKSBkZWxldGUgdGVtcGxhdGVzW2lkXTsKICAgICAgICAgICAgZm4gPSBudWxsOwogICAgICAgICAgICBwcm90byA9IG51bGw7CiAgICAgICAgICAgIGwxMG5NYXAgPSBudWxsOwogICAgICAgICAgICBsMTBuTGlua3MgPSBudWxsOwogICAgICAgICAgICBsMTBuUHJvdG9TeW5jID0gbnVsbDsKICAgICAgICAgICAgaW5zdGFuY2VzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9OwogICAgfSgpOwogICAgdmFyIEh0bWxUZW1wbGF0ZSA9IFRlbXBsYXRlLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlRlbXBsYXRlIiwKICAgICAgX19leHRlbmRfXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBIdG1sVGVtcGxhdGUpIHJldHVybiB2YWx1ZTsKICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBUZW1wbGF0ZVN3aXRjaENvbmZpZykgcmV0dXJuIG5ldyBIdG1sVGVtcGxhdGVTd2l0Y2hlcih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIG5ldyBIdG1sVGVtcGxhdGUodmFsdWUpOwogICAgICB9LAogICAgICBidWlsZGVyOiBidWlsZGVyCiAgICB9KTsKICAgIHZhciBIdG1sVGVtcGxhdGVTd2l0Y2hlciA9IFRlbXBsYXRlU3dpdGNoZXIuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuVGVtcGxhdGVTd2l0Y2hlciIsCiAgICAgIHRlbXBsYXRlQ2xhc3M6IEh0bWxUZW1wbGF0ZQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgbWFya2VyOiBiYXNpc1RlbXBsYXRlSWRNYXJrZXIsCiAgICAgIFRlbXBsYXRlOiBIdG1sVGVtcGxhdGUsCiAgICAgIFRlbXBsYXRlU3dpdGNoZXI6IEh0bWxUZW1wbGF0ZVN3aXRjaGVyCiAgICB9OwogICAgYmFzaXMudGVtcGxhdGUuZXh0ZW5kKHsKICAgICAgZ2V0RGVidWdJbmZvQnlJZDogZ2V0RGVidWdJbmZvQnlJZCwKICAgICAgYnVpbGRIdG1sOiBidWlsZEh0bWwsCiAgICAgIHJlc29sdmVUZW1wbGF0ZUJ5SWQ6IHJlc29sdmVUZW1wbGF0ZUJ5SWQsCiAgICAgIHJlc29sdmVPYmplY3RCeUlkOiByZXNvbHZlT2JqZWN0QnlJZCwKICAgICAgcmVzb2x2ZVRtcGxCeUlkOiByZXNvbHZlVG1wbEJ5SWQKICAgIH0pOwogIH0sCiAgIjguanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgJG51bGwgPSBiYXNpcy5mbi4kbnVsbDsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheS5mcm9tOwogICAgdmFyIFczQ1NVUFBPUlQgPSAhIWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXI7CiAgICB2YXIgRVZFTlRfSE9MREVSID0gIl9fYmFzaXNFdmVudHMiOwogICAgdmFyIEtFWSA9IHsKICAgICAgQkFDS1NQQUNFOiA4LAogICAgICBUQUI6IDksCiAgICAgIENUUkxfRU5URVI6IDEwLAogICAgICBFTlRFUjogMTMsCiAgICAgIFNISUZUOiAxNiwKICAgICAgQ1RSTDogMTcsCiAgICAgIEFMVDogMTgsCiAgICAgIEVTQzogMjcsCiAgICAgIEVTQ0FQRTogMjcsCiAgICAgIFNQQUNFOiAzMiwKICAgICAgUEFHRVVQOiAzMywKICAgICAgUEFHRURPV046IDM0LAogICAgICBFTkQ6IDM1LAogICAgICBIT01FOiAzNiwKICAgICAgTEVGVDogMzcsCiAgICAgIFVQOiAzOCwKICAgICAgUklHSFQ6IDM5LAogICAgICBET1dOOiA0MCwKICAgICAgSU5TRVJUOiA0NSwKICAgICAgREVMRVRFOiA0NiwKICAgICAgRjE6IDExMiwKICAgICAgRjI6IDExMywKICAgICAgRjM6IDExNCwKICAgICAgRjQ6IDExNSwKICAgICAgRjU6IDExNiwKICAgICAgRjY6IDExNywKICAgICAgRjc6IDExOCwKICAgICAgRjg6IDExOSwKICAgICAgRjk6IDEyMCwKICAgICAgRjEwOiAxMjEsCiAgICAgIEYxMTogMTIyLAogICAgICBGMTI6IDEyMwogICAgfTsKICAgIHZhciBNT1VTRV9MRUZUID0gewogICAgICBWQUxVRTogMSwKICAgICAgQklUOiAxCiAgICB9OwogICAgdmFyIE1PVVNFX01JRERMRSA9IHsKICAgICAgVkFMVUU6IDIsCiAgICAgIEJJVDogNAogICAgfTsKICAgIHZhciBNT1VTRV9SSUdIVCA9IHsKICAgICAgVkFMVUU6IDMsCiAgICAgIEJJVDogMgogICAgfTsKICAgIHZhciBCUk9XU0VSX0VWRU5UUyA9IHsKICAgICAgbW91c2V3aGVlbDogWyAibW91c2V3aGVlbCIsICJET01Nb3VzZVNjcm9sbCIgXQogICAgfTsKICAgIGZ1bmN0aW9uIGJyb3dzZXJFdmVudHMoZXZlbnROYW1lKSB7CiAgICAgIHJldHVybiBCUk9XU0VSX0VWRU5UU1tldmVudE5hbWVdIHx8IFsgZXZlbnROYW1lIF07CiAgICB9CiAgICB2YXIgRXZlbnQgPSBiYXNpcy5DbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5FdmVudCIsCiAgICAgIEtFWTogS0VZLAogICAgICBpbml0OiBmdW5jdGlvbihldmVudCkgewogICAgICAgIGV2ZW50ID0gd3JhcChldmVudCk7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBldmVudCkgaWYgKG5hbWUgIT0gInJldHVyblZhbHVlIiAmJiBuYW1lICE9ICJrZXlMb2NhdGlvbiIgJiYgbmFtZSAhPSAibGF5ZXJYIiAmJiBuYW1lICE9ICJsYXllclkiKSBpZiAodHlwZW9mIGV2ZW50W25hbWVdICE9ICJmdW5jdGlvbiIgJiYgbmFtZSBpbiB0aGlzID09IGZhbHNlKSB0aGlzW25hbWVdID0gZXZlbnRbbmFtZV07CiAgICAgICAgdmFyIHRhcmdldCA9IHNlbmRlcihldmVudCk7CiAgICAgICAgYmFzaXMub2JqZWN0LmV4dGVuZCh0aGlzLCB7CiAgICAgICAgICBldmVudF86IGV2ZW50LAogICAgICAgICAgc2VuZGVyOiB0YXJnZXQsCiAgICAgICAgICB0YXJnZXQ6IHRhcmdldCwKICAgICAgICAgIGtleToga2V5KGV2ZW50KSwKICAgICAgICAgIGNoYXJDb2RlOiBjaGFyQ29kZShldmVudCksCiAgICAgICAgICBtb3VzZUxlZnQ6IG1vdXNlQnV0dG9uKGV2ZW50LCBNT1VTRV9MRUZUKSwKICAgICAgICAgIG1vdXNlTWlkZGxlOiBtb3VzZUJ1dHRvbihldmVudCwgTU9VU0VfTUlERExFKSwKICAgICAgICAgIG1vdXNlUmlnaHQ6IG1vdXNlQnV0dG9uKGV2ZW50LCBNT1VTRV9SSUdIVCksCiAgICAgICAgICBtb3VzZVg6IG1vdXNlWChldmVudCksCiAgICAgICAgICBtb3VzZVk6IG1vdXNlWShldmVudCksCiAgICAgICAgICB3aGVlbERlbHRhOiB3aGVlbERlbHRhKGV2ZW50KQogICAgICAgIH0pOwogICAgICB9LAogICAgICBzdG9wQnViYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICBjYW5jZWxCdWJibGUodGhpcy5ldmVudF8pOwogICAgICB9LAogICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgIGNhbmNlbEJ1YmJsZSh0aGlzLmV2ZW50Xyk7CiAgICAgIH0sCiAgICAgIHByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpIHsKICAgICAgICBjYW5jZWxEZWZhdWx0KHRoaXMuZXZlbnRfKTsKICAgICAgfSwKICAgICAgZGllOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnN0b3BCdWJibGUoKTsKICAgICAgICB0aGlzLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gd3JhcChldmVudCkgewogICAgICByZXR1cm4gZXZlbnQgaW5zdGFuY2VvZiBFdmVudCA/IGV2ZW50LmV2ZW50XyA6IGV2ZW50IHx8IGdsb2JhbC5ldmVudDsKICAgIH0KICAgIGZ1bmN0aW9uIGdldE5vZGUocmVmKSB7CiAgICAgIHJldHVybiB0eXBlb2YgcmVmID09ICJzdHJpbmciID8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocmVmKSA6IHJlZjsKICAgIH0KICAgIGZ1bmN0aW9uIHNlbmRlcihldmVudCkgewogICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0IHx8IGV2ZW50LnNyY0VsZW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgIHJldHVybiB0YXJnZXQubm9kZVR5cGUgPT0gMyA/IHRhcmdldC5wYXJlbnROb2RlIDogdGFyZ2V0OwogICAgfQogICAgZnVuY3Rpb24gY2FuY2VsQnViYmxlKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOyBlbHNlIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiBjYW5jZWxEZWZhdWx0KGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkgZXZlbnQucHJldmVudERlZmF1bHQoKTsgZWxzZSBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24ga2lsbChldmVudCwgbm9kZSkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgaWYgKG5vZGUpIGFkZEhhbmRsZXIobm9kZSwgZXZlbnQsIGtpbGwpOyBlbHNlIHsKICAgICAgICBjYW5jZWxEZWZhdWx0KGV2ZW50KTsKICAgICAgICBjYW5jZWxCdWJibGUoZXZlbnQpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBrZXkoZXZlbnQpIHsKICAgICAgcmV0dXJuIGV2ZW50LmtleUNvZGUgfHwgZXZlbnQud2hpY2ggfHwgMDsKICAgIH0KICAgIGZ1bmN0aW9uIGNoYXJDb2RlKGV2ZW50KSB7CiAgICAgIHJldHVybiBldmVudC5jaGFyQ29kZSB8fCBldmVudC5rZXlDb2RlIHx8IDA7CiAgICB9CiAgICBmdW5jdGlvbiBtb3VzZUJ1dHRvbihldmVudCwgYnV0dG9uKSB7CiAgICAgIGlmICh0eXBlb2YgZXZlbnQud2hpY2ggPT0gIm51bWJlciIpIHJldHVybiBldmVudC53aGljaCA9PSBidXR0b24uVkFMVUU7IGVsc2UgcmV0dXJuICEhKGV2ZW50LmJ1dHRvbiAmIGJ1dHRvbi5CSVQpOwogICAgfQogICAgZnVuY3Rpb24gbW91c2VYKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5jaGFuZ2VkVG91Y2hlcykgcmV0dXJuIGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYOyBlbHNlIGlmICgicGFnZVgiIGluIGV2ZW50KSByZXR1cm4gZXZlbnQucGFnZVg7IGVsc2UgcmV0dXJuICJjbGllbnRYIiBpbiBldmVudCA/IGV2ZW50LmNsaWVudFggKyAoZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIgPyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCA6IGRvY3VtZW50LmJvZHkuc2Nyb2xsTGVmdCkgOiAwOwogICAgfQogICAgZnVuY3Rpb24gbW91c2VZKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5jaGFuZ2VkVG91Y2hlcykgcmV0dXJuIGV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VZOyBlbHNlIGlmICgicGFnZVkiIGluIGV2ZW50KSByZXR1cm4gZXZlbnQucGFnZVk7IGVsc2UgcmV0dXJuICJjbGllbnRZIiBpbiBldmVudCA/IGV2ZW50LmNsaWVudFkgKyAoZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIgPyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wIDogZG9jdW1lbnQuYm9keS5zY3JvbGxUb3ApIDogMDsKICAgIH0KICAgIGZ1bmN0aW9uIHdoZWVsRGVsdGEoZXZlbnQpIHsKICAgICAgdmFyIGRlbHRhID0gMDsKICAgICAgaWYgKCJ3aGVlbERlbHRhIiBpbiBldmVudCkgZGVsdGEgPSBldmVudC53aGVlbERlbHRhOyBlbHNlIGlmIChldmVudC50eXBlID09ICJET01Nb3VzZVNjcm9sbCIpIGRlbHRhID0gLWV2ZW50LmRldGFpbDsKICAgICAgcmV0dXJuIGRlbHRhICYmIGRlbHRhIC8gTWF0aC5hYnMoZGVsdGEpOwogICAgfQogICAgdmFyIGdsb2JhbEhhbmRsZXJzID0ge307CiAgICB2YXIgY2FwdHVyZUhhbmRsZXJzID0ge307CiAgICB2YXIgbm9DYXB0dXJlU2NoZW1lID0gIVczQ1NVUFBPUlQ7CiAgICBmdW5jdGlvbiBvYnNlcnZlR2xvYmFsRXZlbnRzKGV2ZW50KSB7CiAgICAgIHZhciBoYW5kbGVycyA9IGFycmF5RnJvbShnbG9iYWxIYW5kbGVyc1tldmVudC50eXBlXSk7CiAgICAgIHZhciBjYXB0dXJlSGFuZGxlciA9IGNhcHR1cmVIYW5kbGVyc1tldmVudC50eXBlXTsKICAgICAgdmFyIHdyYXBwZWRFdmVudCA9IG5ldyBFdmVudChldmVudCk7CiAgICAgIGlmIChjYXB0dXJlSGFuZGxlcikgewogICAgICAgIGNhcHR1cmVIYW5kbGVyLmhhbmRsZXIuY2FsbChjYXB0dXJlSGFuZGxlci50aGlzT2JqZWN0LCB3cmFwcGVkRXZlbnQpOwogICAgICAgIGtpbGwoZXZlbnQpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICBmb3IgKHZhciBpID0gaGFuZGxlcnMubGVuZ3RoOyBpLS0gPiAwOyApIHsKICAgICAgICAgIHZhciBoYW5kbGVyT2JqZWN0ID0gaGFuZGxlcnNbaV07CiAgICAgICAgICBoYW5kbGVyT2JqZWN0LmhhbmRsZXIuY2FsbChoYW5kbGVyT2JqZWN0LnRoaXNPYmplY3QsIHdyYXBwZWRFdmVudCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBjYXB0dXJlRXZlbnQoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIGlmIChjYXB0dXJlSGFuZGxlcnNbZXZlbnRUeXBlXSkgcmVsZWFzZUV2ZW50KGV2ZW50VHlwZSk7CiAgICAgIGFkZEdsb2JhbEhhbmRsZXIoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KTsKICAgICAgY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV0gPSB7CiAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICB0aGlzT2JqZWN0OiB0aGlzT2JqZWN0CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiByZWxlYXNlRXZlbnQoZXZlbnRUeXBlKSB7CiAgICAgIHZhciBoYW5kbGVyT2JqZWN0ID0gY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIGlmIChoYW5kbGVyT2JqZWN0KSB7CiAgICAgICAgcmVtb3ZlR2xvYmFsSGFuZGxlcihldmVudFR5cGUsIGhhbmRsZXJPYmplY3QuaGFuZGxlciwgaGFuZGxlck9iamVjdC50aGlzT2JqZWN0KTsKICAgICAgICBkZWxldGUgY2FwdHVyZUhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGFkZEdsb2JhbEhhbmRsZXIoZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIHZhciBoYW5kbGVycyA9IGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgIGlmIChoYW5kbGVycykgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gaGFuZGxlcnNbaV07IGkrKykgaWYgKGl0ZW0uaGFuZGxlciA9PT0gaGFuZGxlciAmJiBpdGVtLnRoaXNPYmplY3QgPT09IHRoaXNPYmplY3QpIHJldHVybjsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAobm9DYXB0dXJlU2NoZW1lKSBhZGRIYW5kbGVyKGRvY3VtZW50LCBldmVudFR5cGUsICRudWxsKTsgZWxzZSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgb2JzZXJ2ZUdsb2JhbEV2ZW50cywgdHJ1ZSk7CiAgICAgICAgaGFuZGxlcnMgPSBnbG9iYWxIYW5kbGVyc1tldmVudFR5cGVdID0gW107CiAgICAgIH0KICAgICAgaGFuZGxlcnMucHVzaCh7CiAgICAgICAgaGFuZGxlcjogaGFuZGxlciwKICAgICAgICB0aGlzT2JqZWN0OiB0aGlzT2JqZWN0CiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlR2xvYmFsSGFuZGxlcihldmVudFR5cGUsIGhhbmRsZXIsIHRoaXNPYmplY3QpIHsKICAgICAgdmFyIGhhbmRsZXJzID0gZ2xvYmFsSGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgaWYgKGhhbmRsZXJzKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBoYW5kbGVyc1tpXTsgaSsrKSB7CiAgICAgICAgICBpZiAoaXRlbS5oYW5kbGVyID09PSBoYW5kbGVyICYmIGl0ZW0udGhpc09iamVjdCA9PT0gdGhpc09iamVjdCkgewogICAgICAgICAgICBoYW5kbGVycy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIGlmICghaGFuZGxlcnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZGVsZXRlIGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV07CiAgICAgICAgICAgICAgaWYgKG5vQ2FwdHVyZVNjaGVtZSkgcmVtb3ZlSGFuZGxlcihkb2N1bWVudCwgZXZlbnRUeXBlLCAkbnVsbCk7IGVsc2UgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIG9ic2VydmVHbG9iYWxFdmVudHMsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGFkZEhhbmRsZXIobm9kZSwgZXZlbnRUeXBlLCBoYW5kbGVyLCB0aGlzT2JqZWN0KSB7CiAgICAgIG5vZGUgPSBnZXROb2RlKG5vZGUpOwogICAgICBpZiAoIW5vZGUpIHRocm93ICJiYXNpcy5ldmVudC5hZGRIYW5kbGVyOiBjYW4ndCBhdHRhY2ggZXZlbnQgbGlzdGVuZXIgdG8gdW5kZWZpbmVkIjsKICAgICAgaWYgKHR5cGVvZiBoYW5kbGVyICE9ICJmdW5jdGlvbiIpIHRocm93ICJiYXNpcy5ldmVudC5hZGRIYW5kbGVyOiBoYW5kbGVyIGlzIG5vdCBhIGZ1bmN0aW9uIjsKICAgICAgaWYgKCFub2RlW0VWRU5UX0hPTERFUl0pIG5vZGVbRVZFTlRfSE9MREVSXSA9IHt9OwogICAgICB2YXIgaGFuZGxlck9iamVjdCA9IHsKICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgIHRoaXNPYmplY3Q6IHRoaXNPYmplY3QKICAgICAgfTsKICAgICAgdmFyIGhhbmRsZXJzID0gbm9kZVtFVkVOVF9IT0xERVJdOwogICAgICB2YXIgZXZlbnRUeXBlSGFuZGxlcnMgPSBoYW5kbGVyc1tldmVudFR5cGVdOwogICAgICBpZiAoIWV2ZW50VHlwZUhhbmRsZXJzKSB7CiAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMgPSBoYW5kbGVyc1tldmVudFR5cGVdID0gWyBoYW5kbGVyT2JqZWN0IF07CiAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMuZmlyZUV2ZW50ID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgIGV2ZW50ID0gd3JhcChldmVudCk7CiAgICAgICAgICBpZiAobm9DYXB0dXJlU2NoZW1lICYmIGV2ZW50ICYmIGdsb2JhbEhhbmRsZXJzW2V2ZW50VHlwZV0pIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBldmVudC5yZXR1cm5WYWx1ZSA9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIG9ic2VydmVHbG9iYWxFdmVudHMoZXZlbnQpOwogICAgICAgICAgICAgIGlmIChldmVudC5jYW5jZWxCdWJibGUgPT09IHRydWUpIHJldHVybjsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50LnJldHVyblZhbHVlID09ICJ1bmRlZmluZWQiKSBldmVudC5yZXR1cm5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwLCB3cmFwcGVkRXZlbnQgPSBuZXcgRXZlbnQoZXZlbnQpLCBpdGVtOyBpdGVtID0gZXZlbnRUeXBlSGFuZGxlcnNbaSsrXTsgKSBpdGVtLmhhbmRsZXIuY2FsbChpdGVtLnRoaXNPYmplY3QsIHdyYXBwZWRFdmVudCk7CiAgICAgICAgfTsKICAgICAgICBpZiAoVzNDU1VQUE9SVCkgbm9kZS5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgZXZlbnRUeXBlSGFuZGxlcnMuZmlyZUV2ZW50LCBmYWxzZSk7IGVsc2Ugbm9kZS5hdHRhY2hFdmVudCgib24iICsgZXZlbnRUeXBlLCBldmVudFR5cGVIYW5kbGVycy5maXJlRXZlbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gZXZlbnRUeXBlSGFuZGxlcnNbaV07IGkrKykgaWYgKGl0ZW0uaGFuZGxlciA9PT0gaGFuZGxlciAmJiBpdGVtLnRoaXNPYmplY3QgPT09IHRoaXNPYmplY3QpIHJldHVybjsKICAgICAgICBldmVudFR5cGVIYW5kbGVycy5wdXNoKGhhbmRsZXJPYmplY3QpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGRIYW5kbGVycyhub2RlLCBoYW5kbGVycywgdGhpc09iamVjdCkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgZm9yICh2YXIgZXZlbnRUeXBlIGluIGhhbmRsZXJzKSBhZGRIYW5kbGVyKG5vZGUsIGV2ZW50VHlwZSwgaGFuZGxlcnNbZXZlbnRUeXBlXSwgdGhpc09iamVjdCk7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVIYW5kbGVyKG5vZGUsIGV2ZW50VHlwZSwgaGFuZGxlciwgdGhpc09iamVjdCkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgdmFyIGhhbmRsZXJzID0gbm9kZVtFVkVOVF9IT0xERVJdOwogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICB2YXIgZXZlbnRUeXBlSGFuZGxlcnMgPSBoYW5kbGVyc1tldmVudFR5cGVdOwogICAgICAgIGlmIChldmVudFR5cGVIYW5kbGVycykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBldmVudFR5cGVIYW5kbGVyc1tpXTsgaSsrKSB7CiAgICAgICAgICAgIGlmIChpdGVtLmhhbmRsZXIgPT09IGhhbmRsZXIgJiYgaXRlbS50aGlzT2JqZWN0ID09PSB0aGlzT2JqZWN0KSB7CiAgICAgICAgICAgICAgZXZlbnRUeXBlSGFuZGxlcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgIGlmICghZXZlbnRUeXBlSGFuZGxlcnMubGVuZ3RoKSBjbGVhckhhbmRsZXJzKG5vZGUsIGV2ZW50VHlwZSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBjbGVhckhhbmRsZXJzKG5vZGUsIGV2ZW50VHlwZSkgewogICAgICBub2RlID0gZ2V0Tm9kZShub2RlKTsKICAgICAgdmFyIGhhbmRsZXJzID0gbm9kZVtFVkVOVF9IT0xERVJdOwogICAgICBpZiAoaGFuZGxlcnMpIHsKICAgICAgICBpZiAodHlwZW9mIGV2ZW50VHlwZSAhPSAic3RyaW5nIikgewogICAgICAgICAgZm9yIChldmVudFR5cGUgaW4gaGFuZGxlcnMpIGNsZWFySGFuZGxlcnMobm9kZSwgZXZlbnRUeXBlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGV2ZW50VHlwZUhhbmRsZXJzID0gaGFuZGxlcnNbZXZlbnRUeXBlXTsKICAgICAgICAgIGlmIChldmVudFR5cGVIYW5kbGVycykgewogICAgICAgICAgICBpZiAobm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKSBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBldmVudFR5cGVIYW5kbGVycy5maXJlRXZlbnQsIGZhbHNlKTsgZWxzZSBub2RlLmRldGFjaEV2ZW50KCJvbiIgKyBldmVudFR5cGUsIGV2ZW50VHlwZUhhbmRsZXJzLmZpcmVFdmVudCk7CiAgICAgICAgICAgIGRlbGV0ZSBoYW5kbGVyc1tldmVudFR5cGVdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZmlyZUV2ZW50KG5vZGUsIGV2ZW50VHlwZSwgZXZlbnQpIHsKICAgICAgbm9kZSA9IGdldE5vZGUobm9kZSk7CiAgICAgIHZhciBoYW5kbGVycyA9IG5vZGVbRVZFTlRfSE9MREVSXTsKICAgICAgaWYgKGhhbmRsZXJzICYmIGhhbmRsZXJzW2V2ZW50VHlwZV0pIGhhbmRsZXJzW2V2ZW50VHlwZV0uZmlyZUV2ZW50KGV2ZW50KTsKICAgIH0KICAgIGZ1bmN0aW9uIG9uVW5sb2FkKGhhbmRsZXIsIHRoaXNPYmplY3QpIHsKICAgICAgYWRkSGFuZGxlcihnbG9iYWwsICJ1bmxvYWQiLCBoYW5kbGVyLCB0aGlzT2JqZWN0KTsKICAgIH0KICAgIHZhciB0YWdOYW1lRXZlbnRNYXAgPSB7fTsKICAgIGZ1bmN0aW9uIGdldEV2ZW50SW5mbyhldmVudE5hbWUsIHRhZ05hbWUpIHsKICAgICAgaWYgKCF0YWdOYW1lKSB0YWdOYW1lID0gImRpdiI7CiAgICAgIHZhciBpZCA9IHRhZ05hbWUgKyAiLSIgKyBldmVudE5hbWU7CiAgICAgIGlmICh0YWdOYW1lRXZlbnRNYXBbaWRdKSByZXR1cm4gdGFnTmFtZUV2ZW50TWFwW2lkXTsgZWxzZSB7CiAgICAgICAgdmFyIHN1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgIHZhciBidWJibGUgPSBmYWxzZTsKICAgICAgICBpZiAoIVczQ1NVUFBPUlQpIHsKICAgICAgICAgIHZhciBvbmV2ZW50ID0gIm9uIiArIGV2ZW50TmFtZTsKICAgICAgICAgIHZhciBob3N0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gaG9zdC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpKTsKICAgICAgICAgIGhvc3Rbb25ldmVudF0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgYnViYmxlID0gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB0YXJnZXQuZmlyZUV2ZW50KG9uZXZlbnQpOwogICAgICAgICAgICBzdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRhZ05hbWVFdmVudE1hcFtpZF0gPSB7CiAgICAgICAgICBzdXBwb3J0ZWQ6IHN1cHBvcnRlZCwKICAgICAgICAgIGJ1YmJsZTogYnViYmxlCiAgICAgICAgfTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gd3JhcEV2ZW50RnVuY3Rpb24oZm4pIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50LCBhcmcpIHsKICAgICAgICByZXR1cm4gZm4od3JhcChldmVudCksIGFyZyk7CiAgICAgIH07CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgVzNDU1VQUE9SVDogVzNDU1VQUE9SVCwKICAgICAgYnJvd3NlckV2ZW50czogYnJvd3NlckV2ZW50cywKICAgICAgZ2V0RXZlbnRJbmZvOiBnZXRFdmVudEluZm8sCiAgICAgIEtFWTogS0VZLAogICAgICBNT1VTRV9MRUZUOiBNT1VTRV9MRUZULAogICAgICBNT1VTRV9SSUdIVDogTU9VU0VfUklHSFQsCiAgICAgIE1PVVNFX01JRERMRTogTU9VU0VfTUlERExFLAogICAgICBFdmVudDogRXZlbnQsCiAgICAgIHNlbmRlcjogd3JhcEV2ZW50RnVuY3Rpb24oc2VuZGVyKSwKICAgICAgY2FuY2VsQnViYmxlOiB3cmFwRXZlbnRGdW5jdGlvbihjYW5jZWxCdWJibGUpLAogICAgICBjYW5jZWxEZWZhdWx0OiB3cmFwRXZlbnRGdW5jdGlvbihjYW5jZWxEZWZhdWx0KSwKICAgICAga2lsbDogd3JhcEV2ZW50RnVuY3Rpb24oa2lsbCksCiAgICAgIGtleTogd3JhcEV2ZW50RnVuY3Rpb24oa2V5KSwKICAgICAgY2hhckNvZGU6IHdyYXBFdmVudEZ1bmN0aW9uKGNoYXJDb2RlKSwKICAgICAgbW91c2VCdXR0b246IHdyYXBFdmVudEZ1bmN0aW9uKG1vdXNlQnV0dG9uKSwKICAgICAgbW91c2VYOiB3cmFwRXZlbnRGdW5jdGlvbihtb3VzZVgpLAogICAgICBtb3VzZVk6IHdyYXBFdmVudEZ1bmN0aW9uKG1vdXNlWSksCiAgICAgIHdoZWVsRGVsdGE6IHdyYXBFdmVudEZ1bmN0aW9uKHdoZWVsRGVsdGEpLAogICAgICBhZGRHbG9iYWxIYW5kbGVyOiBhZGRHbG9iYWxIYW5kbGVyLAogICAgICByZW1vdmVHbG9iYWxIYW5kbGVyOiByZW1vdmVHbG9iYWxIYW5kbGVyLAogICAgICBjYXB0dXJlRXZlbnQ6IGNhcHR1cmVFdmVudCwKICAgICAgcmVsZWFzZUV2ZW50OiByZWxlYXNlRXZlbnQsCiAgICAgIGFkZEhhbmRsZXI6IGFkZEhhbmRsZXIsCiAgICAgIGFkZEhhbmRsZXJzOiBhZGRIYW5kbGVycywKICAgICAgcmVtb3ZlSGFuZGxlcjogcmVtb3ZlSGFuZGxlciwKICAgICAgY2xlYXJIYW5kbGVyczogY2xlYXJIYW5kbGVycywKICAgICAgZmlyZUV2ZW50OiBmaXJlRXZlbnQsCiAgICAgIG9uVW5sb2FkOiBvblVubG9hZCwKICAgICAgd3JhcDogd3JhcAogICAgfTsKICB9LAogICI5LmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzYuanMiKTsKICAgIHZhciBUWVBFX0VMRU1FTlQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0VMRU1FTlQ7CiAgICB2YXIgVFlQRV9BVFRSSUJVVEUgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX0FUVFJJQlVURTsKICAgIHZhciBUWVBFX1RFWFQgPSBiYXNpcy50ZW1wbGF0ZS5UWVBFX1RFWFQ7CiAgICB2YXIgVFlQRV9DT01NRU5UID0gYmFzaXMudGVtcGxhdGUuVFlQRV9DT01NRU5UOwogICAgdmFyIFRPS0VOX1RZUEUgPSBiYXNpcy50ZW1wbGF0ZS5UT0tFTl9UWVBFOwogICAgdmFyIFRPS0VOX0JJTkRJTkdTID0gYmFzaXMudGVtcGxhdGUuVE9LRU5fQklORElOR1M7CiAgICB2YXIgVE9LRU5fUkVGUyA9IGJhc2lzLnRlbXBsYXRlLlRPS0VOX1JFRlM7CiAgICB2YXIgQVRUUl9OQU1FID0gYmFzaXMudGVtcGxhdGUuQVRUUl9OQU1FOwogICAgdmFyIEFUVFJfTkFNRV9CWV9UWVBFID0gYmFzaXMudGVtcGxhdGUuQVRUUl9OQU1FX0JZX1RZUEU7CiAgICB2YXIgRUxFTUVOVF9OQU1FID0gYmFzaXMudGVtcGxhdGUuRUxFTUVOVF9OQU1FOwogICAgdmFyIEVMRU1FTlRfQVRUUlMgPSBiYXNpcy50ZW1wbGF0ZS5FTEVNRU5UX0FUVFJTOwogICAgdmFyIEVMRU1FTlRfQ0hJTERTID0gYmFzaXMudGVtcGxhdGUuRUxFTUVOVF9DSElMRFM7CiAgICB2YXIgVEVYVF9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLlRFWFRfVkFMVUU7CiAgICB2YXIgQ09NTUVOVF9WQUxVRSA9IGJhc2lzLnRlbXBsYXRlLkNPTU1FTlRfVkFMVUU7CiAgICB2YXIgdG1wbEZ1bmN0aW9ucyA9IHt9OwogICAgdmFyIGlubGluZVNlZWQgPSAxOwogICAgdmFyIGJ1aWxkUGF0aGVzID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBQQVRIX1JFRl9OQU1FID0gImFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVoiLnNwbGl0KCIiKTsKICAgICAgdmFyIHBhdGhMaXN0OwogICAgICB2YXIgcmVmTGlzdDsKICAgICAgdmFyIGJpbmRpbmdMaXN0OwogICAgICB2YXIgbWFya2VkRWxlbWVudExpc3Q7CiAgICAgIHZhciByb290UGF0aDsKICAgICAgdmFyIGF0dHJFeHBySWQ7CiAgICAgIGZ1bmN0aW9uIHB1dFJlZnMocmVmcywgcGF0aElkeCkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCByZWZOYW1lOyByZWZOYW1lID0gcmVmc1tpXTsgaSsrKSBpZiAocmVmTmFtZS5pbmRleE9mKCI6IikgPT0gLTEpIHJlZkxpc3QucHVzaChyZWZOYW1lICsgIjoiICsgcGF0aElkeCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcHV0UGF0aChwYXRoKSB7CiAgICAgICAgdmFyIGxlbiA9IHBhdGhMaXN0Lmxlbmd0aDsKICAgICAgICB2YXIgcGF0aFJlZiA9IFBBVEhfUkVGX05BTUVbbGVuXSB8fCAiciIgKyBsZW47CiAgICAgICAgcGF0aExpc3QucHVzaChwYXRoUmVmICsgIj0iICsgcGF0aCk7CiAgICAgICAgcmV0dXJuIHBhdGhSZWY7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcHV0QmluZGluZyhiaW5kaW5nKSB7CiAgICAgICAgYmluZGluZ0xpc3QucHVzaChiaW5kaW5nKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBwcm9jZXNzVG9rZW5zKHRva2VucywgcGF0aCwgbm9UZXh0QnVnLCB0ZW1wbGF0ZU1hcmtlcikgewogICAgICAgIHZhciBsb2NhbFBhdGg7CiAgICAgICAgdmFyIHJlZnM7CiAgICAgICAgdmFyIG15UmVmOwogICAgICAgIHZhciBleHBsaWNpdFJlZjsKICAgICAgICB2YXIgYmluZGluZ3M7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNwID0gMCwgY2xvc2VUZXh0ID0gMCwgdG9rZW47IHRva2VuID0gdG9rZW5zW2ldOyBpKyssIGNwKyssIGV4cGxpY2l0UmVmID0gZmFsc2UpIHsKICAgICAgICAgIGlmICghaSkgbG9jYWxQYXRoID0gcGF0aCArICIuZmlyc3RDaGlsZCI7IGVsc2UgewogICAgICAgICAgICBpZiAoIXRva2Vuc1tpICsgMV0pIGxvY2FsUGF0aCA9IHBhdGggKyAiLmxhc3RDaGlsZCI7IGVsc2UgewogICAgICAgICAgICAgIGlmICh0b2tlbltUT0tFTl9UWVBFXSA9PSB0b2tlbnNbaSAtIDFdW1RPS0VOX1RZUEVdICYmIHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfVEVYVCkgY2xvc2VUZXh0Kys7CiAgICAgICAgICAgICAgbG9jYWxQYXRoID0gcGF0aCArICIuY2hpbGROb2Rlc1siICsgKG5vVGV4dEJ1ZyA/IGNwIDogY3AgKyAoY2xvc2VUZXh0ID8gIiArICIgKyBjbG9zZVRleHQgKyAiICogVEVYVF9CVUciIDogIiIpKSArICJdIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlZnMgPSB0b2tlbltUT0tFTl9SRUZTXSkgewogICAgICAgICAgICBleHBsaWNpdFJlZiA9IHRydWU7CiAgICAgICAgICAgIGxvY2FsUGF0aCA9IHB1dFBhdGgobG9jYWxQYXRoKTsKICAgICAgICAgICAgcHV0UmVmcyhyZWZzLCBsb2NhbFBhdGgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRva2VuW1RPS0VOX0JJTkRJTkdTXSkgewogICAgICAgICAgICBpZiAodG9rZW5bVE9LRU5fQklORElOR1NdICYmIHR5cGVvZiB0b2tlbltUT0tFTl9CSU5ESU5HU10gPT0gIm51bWJlciIpIHRva2VuW1RPS0VOX0JJTkRJTkdTXSA9IHRva2VuW1RPS0VOX1JFRlNdW3Rva2VuW1RPS0VOX0JJTkRJTkdTXSAtIDFdOwogICAgICAgICAgICBpZiAoIWV4cGxpY2l0UmVmKSB7CiAgICAgICAgICAgICAgZXhwbGljaXRSZWYgPSB0cnVlOwogICAgICAgICAgICAgIGxvY2FsUGF0aCA9IHB1dFBhdGgobG9jYWxQYXRoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwdXRCaW5kaW5nKFsgdG9rZW5bVE9LRU5fVFlQRV0sIGxvY2FsUGF0aCwgdG9rZW5bVE9LRU5fQklORElOR1NdIF0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRva2VuW1RPS0VOX1RZUEVdID09IFRZUEVfRUxFTUVOVCkgewogICAgICAgICAgICBteVJlZiA9IC0xOwogICAgICAgICAgICBpZiAocGF0aCA9PSByb290UGF0aCkgbWFya2VkRWxlbWVudExpc3QucHVzaChsb2NhbFBhdGggKyAiLiIgKyB0ZW1wbGF0ZU1hcmtlcik7CiAgICAgICAgICAgIGlmICghZXhwbGljaXRSZWYpIHsKICAgICAgICAgICAgICBsb2NhbFBhdGggPSBwdXRQYXRoKGxvY2FsUGF0aCk7CiAgICAgICAgICAgICAgbXlSZWYgPSBwYXRoTGlzdC5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGF0dHJzID0gW107CiAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBqID0gRUxFTUVOVF9BVFRSUywgdDsgdCA9IHRva2VuW2pdOyBqKyspIGlmICh0W1RPS0VOX1RZUEVdID09IFRZUEVfRUxFTUVOVCB8fCB0W1RPS0VOX1RZUEVdID09IFRZUEVfVEVYVCB8fCB0W1RPS0VOX1RZUEVdID09IFRZUEVfQ09NTUVOVCkgY2hpbGRyZW4ucHVzaCh0KTsgZWxzZSBhdHRycy5wdXNoKHQpOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMCwgYXR0cjsgYXR0ciA9IGF0dHJzW2pdOyBqKyspIHsKICAgICAgICAgICAgICBpZiAoYXR0cltUT0tFTl9UWVBFXSA9PSA2KSBjb250aW51ZTsKICAgICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSBBVFRSX05BTUVfQllfVFlQRVthdHRyW1RPS0VOX1RZUEVdXSB8fCBhdHRyW0FUVFJfTkFNRV07CiAgICAgICAgICAgICAgaWYgKHJlZnMgPSBhdHRyW1RPS0VOX1JFRlNdKSB7CiAgICAgICAgICAgICAgICBleHBsaWNpdFJlZiA9IHRydWU7CiAgICAgICAgICAgICAgICBwdXRSZWZzKHJlZnMsIHB1dFBhdGgobG9jYWxQYXRoICsgJy5nZXRBdHRyaWJ1dGVOb2RlKCInICsgYXR0ck5hbWUgKyAnIiknKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChiaW5kaW5ncyA9IGF0dHJbVE9LRU5fQklORElOR1NdKSB7CiAgICAgICAgICAgICAgICBleHBsaWNpdFJlZiA9IHRydWU7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGF0dHJOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgImNsYXNzIjoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMCwgYmluZGluZzsgYmluZGluZyA9IGJpbmRpbmdzW2tdOyBrKyspIHB1dEJpbmRpbmcoWyAyLCBsb2NhbFBhdGgsIGJpbmRpbmdbMV0sIGF0dHJOYW1lLCBiaW5kaW5nWzBdIF0uY29uY2F0KGJpbmRpbmcuc2xpY2UoMikpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAic3R5bGUiOgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBwcm9wZXJ0eTsgcHJvcGVydHkgPSBiaW5kaW5nc1trXTsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgICBhdHRyRXhwcklkKys7CiAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBtID0gMCwgYmluZE5hbWU7IGJpbmROYW1lID0gcHJvcGVydHlbMF1bbV07IG0rKykgcHV0QmluZGluZyhbIDIsIGxvY2FsUGF0aCwgYmluZE5hbWUsIGF0dHJOYW1lLCBwcm9wZXJ0eVswXSwgcHJvcGVydHlbMV0sIHByb3BlcnR5WzJdLCBwcm9wZXJ0eVszXSwgYXR0ckV4cHJJZCBdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgYXR0ckV4cHJJZCsrOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwLCBiaW5kTmFtZTsgYmluZE5hbWUgPSBiaW5kaW5nc1swXVtrXTsgaysrKSBwdXRCaW5kaW5nKFsgMiwgbG9jYWxQYXRoLCBiaW5kTmFtZSwgYXR0ck5hbWUsIGJpbmRpbmdzWzBdLCBiaW5kaW5nc1sxXSwgdG9rZW5bRUxFTUVOVF9OQU1FXSwgYXR0ckV4cHJJZCBdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoaWxkcmVuLmxlbmd0aCkgcHJvY2Vzc1Rva2VucyhjaGlsZHJlbiwgbG9jYWxQYXRoLCBub1RleHRCdWcpOwogICAgICAgICAgICBpZiAoIWV4cGxpY2l0UmVmICYmIG15UmVmID09IHBhdGhMaXN0Lmxlbmd0aCkgcGF0aExpc3QucG9wKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbih0b2tlbnMsIHBhdGgsIG5vVGV4dEJ1ZywgdGVtcGxhdGVNYXJrZXIpIHsKICAgICAgICBwYXRoTGlzdCA9IFtdOwogICAgICAgIHJlZkxpc3QgPSBbXTsKICAgICAgICBiaW5kaW5nTGlzdCA9IFtdOwogICAgICAgIG1hcmtlZEVsZW1lbnRMaXN0ID0gW107CiAgICAgICAgcm9vdFBhdGggPSBwYXRoIHx8ICJfIjsKICAgICAgICBhdHRyRXhwcklkID0gMDsKICAgICAgICBwcm9jZXNzVG9rZW5zKHRva2Vucywgcm9vdFBhdGgsIG5vVGV4dEJ1ZywgdGVtcGxhdGVNYXJrZXIpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwYXRoOiBwYXRoTGlzdCwKICAgICAgICAgIHJlZjogcmVmTGlzdCwKICAgICAgICAgIGJpbmRpbmc6IGJpbmRpbmdMaXN0LAogICAgICAgICAgbWFya2VkRWxlbWVudExpc3Q6IG1hcmtlZEVsZW1lbnRMaXN0CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0oKTsKICAgIHZhciBidWlsZEJpbmRpbmdzID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBMMTBOX0JJTkRJTkcgPSAvXC5ceyhbYS16QS1aX11bYS16QS1aMC05X1wtXSopXH0vOwogICAgICB2YXIgU1BFQ0lBTF9BVFRSX01BUCA9IHsKICAgICAgICBkaXNhYmxlZDogIioiLAogICAgICAgIGNoZWNrZWQ6IFsgImlucHV0IiBdLAogICAgICAgIGluZGV0ZXJtaW5hdGU6IFsgImlucHV0IiBdLAogICAgICAgIHZhbHVlOiBbICJpbnB1dCIsICJ0ZXh0YXJlYSIsICJzZWxlY3QiIF0sCiAgICAgICAgbWlubGVuZ3RoOiBbICJpbnB1dCIgXSwKICAgICAgICBtYXhsZW5ndGg6IFsgImlucHV0IiBdLAogICAgICAgIHJlYWRvbmx5OiBbICJpbnB1dCIgXSwKICAgICAgICBzZWxlY3RlZDogWyAib3B0aW9uIiBdLAogICAgICAgIG11bHRpcGxlOiBbICJzZWxlY3QiIF0KICAgICAgfTsKICAgICAgdmFyIFNQRUNJQUxfQVRUUl9TSU5HTEUgPSB7CiAgICAgICAgZGlzYWJsZWQ6IHRydWUsCiAgICAgICAgY2hlY2tlZDogdHJ1ZSwKICAgICAgICBzZWxlY3RlZDogdHJ1ZSwKICAgICAgICByZWFkb25seTogdHJ1ZSwKICAgICAgICBtdWx0aXBsZTogdHJ1ZSwKICAgICAgICBpbmRldGVybWluYXRlOiB0cnVlCiAgICAgIH07CiAgICAgIHZhciBiaW5kRnVuY3Rpb25zID0gewogICAgICAgIDE6ICJiaW5kX2VsZW1lbnQiLAogICAgICAgIDM6ICJiaW5kX3RleHROb2RlIiwKICAgICAgICA4OiAiYmluZF9jb21tZW50IgogICAgICB9OwogICAgICBmdW5jdGlvbiBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsIHNwZWNpYWwsIGwxMG4pIHsKICAgICAgICB2YXIgZXhwcmVzc2lvbiA9IFtdOwogICAgICAgIHZhciBzeW1ib2xzID0gYmluZGluZ1s1XTsKICAgICAgICB2YXIgZGljdGlvbmFyeSA9IGJpbmRpbmdbNF07CiAgICAgICAgdmFyIGV4cHJWYXI7CiAgICAgICAgdmFyIGNvbG9uUG9zOwogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc3ltYm9scy5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKHR5cGVvZiBzeW1ib2xzW2pdID09ICJzdHJpbmciKSBleHByZXNzaW9uLnB1c2goJyInICsgc3ltYm9sc1tqXS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJyk7IGVsc2UgewogICAgICAgICAgICBleHByVmFyID0gZGljdGlvbmFyeVtzeW1ib2xzW2pdXTsKICAgICAgICAgICAgY29sb25Qb3MgPSBleHByVmFyLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgaWYgKGNvbG9uUG9zID09IC0xKSB7CiAgICAgICAgICAgICAgZXhwcmVzc2lvbi5wdXNoKHNwZWNpYWwgPT0gImwxMG4iID8gJyJ7JyArIGV4cHJWYXIgKyAnfSInIDogc3BlY2lhbCA9PSAiYm9vbCIgPyAiKF9fIiArIGV4cHJWYXIgKyAnfHwiIiknIDogIl9fIiArIGV4cHJWYXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBiaW5kaW5nTmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGwxMG5QYXRoID0gZXhwclZhci5zdWJzdHIoY29sb25Qb3MgKyAxKS5yZXBsYWNlKEwxME5fQklORElORywgZnVuY3Rpb24obSwgbmFtZSkgewogICAgICAgICAgICAgICAgYmluZGluZ05hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmIChiaW5kaW5nTmFtZSkgZXhwcmVzc2lvbi5wdXNoKGwxMG5bZXhwclZhci5zdWJzdHIoY29sb25Qb3MgKyAxKV0pOyBlbHNlIGV4cHJlc3Npb24ucHVzaCgnX19sMTBuWyInICsgbDEwblBhdGggKyAnIl0nKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZXhwcmVzc2lvbi5sZW5ndGggPT0gMSkgZXhwcmVzc2lvbi5wdXNoKCciIicpOwogICAgICAgIHJldHVybiBleHByZXNzaW9uLmpvaW4oIisiKTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oYmluZGluZ3MpIHsKICAgICAgICBmdW5jdGlvbiBwdXRCaW5kQ29kZSh0eXBlKSB7CiAgICAgICAgICB0b29sc1VzZWRbdHlwZV0gPSB0cnVlOwogICAgICAgICAgYmluZENvZGUucHVzaChiaW5kVmFyICsgIj0iICsgdHlwZSArICIoIiArIGJhc2lzLmFycmF5KGFyZ3VtZW50cywgMSkgKyAiKTsiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGJpbmRNYXAgPSB7fTsKICAgICAgICB2YXIgYmluZENvZGU7CiAgICAgICAgdmFyIGJpbmRWYXI7CiAgICAgICAgdmFyIHZhckxpc3QgPSBbXTsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIHZhck5hbWU7CiAgICAgICAgdmFyIGwxMG5NYXA7CiAgICAgICAgdmFyIGwxMG5Db21wdXRlID0gW107CiAgICAgICAgdmFyIGwxMG5CaW5kaW5ncyA9IHt9OwogICAgICAgIHZhciBsMTBuQmluZFNlZWQgPSAxOwogICAgICAgIHZhciBzcGVjaWFsQXR0cjsKICAgICAgICB2YXIgYXR0ckV4cHJJZDsKICAgICAgICB2YXIgYXR0ckV4cHJNYXAgPSB7fTsKICAgICAgICB2YXIgZGVidWdMaXN0ID0gW107CiAgICAgICAgdmFyIHRvb2xzVXNlZCA9IHsKICAgICAgICAgIHJlc29sdmU6IHRydWUKICAgICAgICB9OwogICAgICAgIGZvciAodmFyIGkgPSAwLCBiaW5kaW5nOyBiaW5kaW5nID0gYmluZGluZ3NbaV07IGkrKykgewogICAgICAgICAgdmFyIGJpbmRUeXBlID0gYmluZGluZ1swXTsKICAgICAgICAgIHZhciBkb21SZWYgPSBiaW5kaW5nWzFdOwogICAgICAgICAgdmFyIGJpbmROYW1lID0gYmluZGluZ1syXTsKICAgICAgICAgIGlmIChbICJnZXQiLCAic2V0IiwgInRlbXBsYXRlSWRfIiBdLmluZGV4T2YoYmluZE5hbWUpICE9IC0xKSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiaW5kaW5nIG5hbWUgYCIgKyBiaW5kTmFtZSArICJgIGlzIHByb2hpYml0ZWQsIGJpbmRpbmcgaWdub3JlZCIpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lUGFydCA9IGJpbmROYW1lLnNwbGl0KCI6Iik7CiAgICAgICAgICB2YXIgYW5pbSA9IG5hbWVQYXJ0WzBdID09ICJhbmltIjsKICAgICAgICAgIGlmIChhbmltKSBiaW5kTmFtZSA9IG5hbWVQYXJ0WzFdOwogICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2JpbmROYW1lXTsKICAgICAgICAgIGJpbmRWYXIgPSAiXyIgKyBpOwogICAgICAgICAgdmFyTmFtZSA9ICJfXyIgKyBiaW5kTmFtZTsKICAgICAgICAgIGlmIChuYW1lUGFydFswXSA9PSAibDEwbiIgJiYgbmFtZVBhcnRbMV0pIHsKICAgICAgICAgICAgdmFyIGwxMG5GdWxsUGF0aCA9IG5hbWVQYXJ0WzFdOwogICAgICAgICAgICB2YXIgbDEwbkJpbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgbDEwbk5hbWUgPSBsMTBuRnVsbFBhdGgucmVwbGFjZShMMTBOX0JJTkRJTkcsIGZ1bmN0aW9uKG0sIG5hbWUpIHsKICAgICAgICAgICAgICBsMTBuQmluZGluZyA9IG5hbWU7CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKGwxMG5CaW5kaW5nKSB7CiAgICAgICAgICAgICAgaWYgKGwxMG5GdWxsUGF0aCBpbiBsMTBuQmluZGluZ3MgPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHZhck5hbWUgPSAiJGwxMG5fIiArIGwxMG5CaW5kU2VlZCsrOwogICAgICAgICAgICAgICAgbDEwbkJpbmRpbmdzW2wxMG5GdWxsUGF0aF0gPSB2YXJOYW1lOwogICAgICAgICAgICAgICAgbDEwbkNvbXB1dGUucHVzaCgnc2V0KCInICsgdmFyTmFtZSArICciLCcgKyB2YXJOYW1lICsgIikiKTsKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaCh2YXJOYW1lICsgJz10b29scy5sMTBuVG9rZW4oIicgKyBsMTBuTmFtZSArICciKS5jb21wdXRlVG9rZW4oKScpOwogICAgICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2wxMG5CaW5kaW5nXTsKICAgICAgICAgICAgICAgIGlmICghYmluZENvZGUpIHsKICAgICAgICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2wxMG5CaW5kaW5nXSA9IFtdOwogICAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goIl9fIiArIGwxMG5CaW5kaW5nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJpbmRDb2RlLnB1c2godmFyTmFtZSArICIuc2V0KF9fIiArIGwxMG5CaW5kaW5nICsgIik7Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJpbmROYW1lID0gbDEwbkJpbmRpbmdzW2wxMG5GdWxsUGF0aF07CiAgICAgICAgICAgICAgYmluZFZhciA9ICJfIiArIGk7CiAgICAgICAgICAgICAgdmFyTmFtZSA9ICJfXyIgKyBiaW5kTmFtZTsKICAgICAgICAgICAgICBiaW5kQ29kZSA9IGJpbmRNYXBbYmluZE5hbWVdOwogICAgICAgICAgICAgIGlmICghYmluZENvZGUpIHsKICAgICAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtiaW5kTmFtZV0gPSBbXTsKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaCh2YXJOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGJpbmRUeXBlID09IFRZUEVfVEVYVCkgewogICAgICAgICAgICAgICAgZGVidWdMaXN0LnB1c2goInsiICsgWyAnYmluZGluZzoiJyArIGJpbmROYW1lICsgJyInLCAiZG9tOiIgKyBkb21SZWYsICJ2YWw6IiArIGJpbmRWYXIsICdhdHRhY2htZW50Omluc3RhbmNlLmF0dGFjaGVzJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdLnZhbHVlJyBdICsgIn0iKTsKICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgIj0iICsgZG9tUmVmKTsKICAgICAgICAgICAgICAgIHB1dEJpbmRDb2RlKGJpbmRGdW5jdGlvbnNbYmluZFR5cGVdLCBkb21SZWYsIGJpbmRWYXIsICJ2YWx1ZSIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhdHRyTmFtZSA9ICciJyArIGJpbmRpbmdbQVRUUl9OQU1FXSArICciJzsKICAgICAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBsMTBuRnVsbFBhdGggKyAnIicsICJkb206IiArIGRvbVJlZiwgImF0dHI6IiArIGF0dHJOYW1lLCAidmFsOiIgKyBiaW5kVmFyLCAnYXR0YWNobWVudDppbnN0YW5jZS5hdHRhY2hlcyYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXSYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXS52YWx1ZScgXSArICJ9Iik7CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhcik7CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZSgiYmluZF9hdHRyIiwgZG9tUmVmLCBhdHRyTmFtZSwgYmluZFZhciwgYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCBmYWxzZSwgbDEwbkJpbmRpbmdzKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghbDEwbk1hcCkgbDEwbk1hcCA9IHt9OwogICAgICAgICAgICBpZiAoIWJpbmRNYXBbbDEwbk5hbWVdKSB7CiAgICAgICAgICAgICAgYmluZE1hcFtsMTBuTmFtZV0gPSBbXTsKICAgICAgICAgICAgICBsMTBuTWFwW2wxMG5OYW1lXSA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJpbmRDb2RlID0gYmluZE1hcFtsMTBuTmFtZV07CiAgICAgICAgICAgIGJpbmRDb2RlLmwxMG4gPSB0cnVlOwogICAgICAgICAgICBpZiAoYmluZFR5cGUgPT0gVFlQRV9URVhUKSB7CiAgICAgICAgICAgICAgZGVidWdMaXN0LnB1c2goInsiICsgWyAnYmluZGluZzoiJyArIGwxMG5GdWxsUGF0aCArICciJywgImRvbToiICsgZG9tUmVmLCAndmFsOl9fbDEwblsiJyArIGwxMG5OYW1lICsgJyJdJywgJ2F0dGFjaG1lbnQ6bDEwblRva2VuKCInICsgbDEwbk5hbWUgKyAnIiknIF0gKyAifSIpOwogICAgICAgICAgICAgIHRvb2xzVXNlZC5sMTBuVG9rZW4gPSB0cnVlOwogICAgICAgICAgICAgIGwxMG5NYXBbbDEwbk5hbWVdLnB1c2goZG9tUmVmICsgIi5ub2RlVmFsdWU9dmFsdWU7Iik7CiAgICAgICAgICAgICAgYmluZENvZGUucHVzaChkb21SZWYgKyAnLm5vZGVWYWx1ZT1fX2wxMG5bIicgKyBsMTBuTmFtZSArICciXScgKyAobDEwbkJpbmRpbmcgPyAiW19fIiArIGwxMG5CaW5kaW5nICsgIl0iIDogIiIpICsgIjsiKTsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsMTBuTWFwW2wxMG5OYW1lXS5wdXNoKCJiaW5kX2F0dHIoIiArIFsgZG9tUmVmLCAnIicgKyBiaW5kaW5nW0FUVFJfTkFNRV0gKyAnIicsICJOYU4iLCBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsICJsMTBuIiwgbDEwbkJpbmRpbmdzKSBdICsgIik7Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghYmluZENvZGUpIHsKICAgICAgICAgICAgYmluZENvZGUgPSBiaW5kTWFwW2JpbmROYW1lXSA9IFtdOwogICAgICAgICAgICB2YXJMaXN0LnB1c2godmFyTmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYmluZFR5cGUgIT0gVFlQRV9BVFRSSUJVVEUpIHsKICAgICAgICAgICAgZGVidWdMaXN0LnB1c2goInsiICsgWyAnYmluZGluZzoiJyArIGJpbmROYW1lICsgJyInLCAiZG9tOiIgKyBkb21SZWYsICJ2YWw6IiArIChiaW5kQ29kZS5ub2RlQmluZCA/IHZhck5hbWUgOiBiaW5kVmFyKSwgInVwZGF0ZXM6JCQiICsgYmluZE5hbWUsICdhdHRhY2htZW50Omluc3RhbmNlLmF0dGFjaGVzJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdJiZpbnN0YW5jZS5hdHRhY2hlc1siJyArIGJpbmROYW1lICsgJyJdLnZhbHVlJyBdICsgIn0iKTsKICAgICAgICAgICAgaWYgKCFiaW5kQ29kZS5ub2RlQmluZCkgewogICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgIj0iICsgZG9tUmVmKTsKICAgICAgICAgICAgICBwdXRCaW5kQ29kZShiaW5kRnVuY3Rpb25zW2JpbmRUeXBlXSwgZG9tUmVmLCBiaW5kVmFyLCAidmFsdWUiKTsKICAgICAgICAgICAgICBiaW5kQ29kZS5ub2RlQmluZCA9IGJpbmRWYXI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3dpdGNoIChiaW5kVHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSBUWVBFX0VMRU1FTlQ6CiAgICAgICAgICAgICAgICAgIHB1dEJpbmRDb2RlKGJpbmRGdW5jdGlvbnNbYmluZFR5cGVdLCBkb21SZWYsIGRvbVJlZiwgInZhbHVlIT09bnVsbD9TdHJpbmcodmFsdWUpOm51bGwiKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFRZUEVfVEVYVDoKICAgICAgICAgICAgICAgICAgYmluZENvZGUucHVzaChkb21SZWYgKyAiLm5vZGVWYWx1ZT12YWx1ZTsiKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSBiaW5kaW5nW0FUVFJfTkFNRV07CiAgICAgICAgICAgIHN3aXRjaCAoYXR0ck5hbWUpIHsKICAgICAgICAgICAgICBjYXNlICJjbGFzcyI6CiAgICAgICAgICAgICAgICB2YXIgZGVmYXVsdEV4cHIgPSAiIjsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZUV4cHIgPSAidmFsdWUiOwogICAgICAgICAgICAgICAgdmFyIHByZWZpeCA9IGJpbmRpbmdbNF07CiAgICAgICAgICAgICAgICB2YXIgYmluZGluZ0xlbmd0aCA9IGJpbmRpbmcubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPj0gNikgewogICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ0xlbmd0aCA9PSA2IHx8IHR5cGVvZiBiaW5kaW5nWzZdID09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPT0gNikgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gJ3ZhbHVlPyInICsgYmluZE5hbWUgKyAnIjoiIic7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYmluZGluZ1s1XSkgZGVmYXVsdEV4cHIgPSBwcmVmaXggKyBiaW5kTmFtZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcHJlZml4ID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZUV4cHIgPSAndmFsdWU/IicgKyBiaW5kaW5nWzZdICsgJyI6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gYmluZGluZ1s2XTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFiaW5kaW5nWzZdLmxlbmd0aCkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdMZW5ndGggPT0gNykgewogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gYmluZGluZ1s2XS5tYXAoZnVuY3Rpb24odmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAndmFsdWU9PSInICsgdmFsICsgJyInOwogICAgICAgICAgICAgICAgICAgICAgfSkuam9pbigifHwiKSArICc/dmFsdWU6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gcHJlZml4ICsgYmluZGluZ1s2XVtiaW5kaW5nWzVdIC0gMV07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHByZWZpeCA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgdmFsdWVFeHByID0gYmluZGluZ1s2XS5tYXAoZnVuY3Rpb24odmFsLCBpZHgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd2YWx1ZT09IicgKyB2YWwgKyAnIj8iJyArIHRoaXNbaWR4XSArICciJzsKICAgICAgICAgICAgICAgICAgICAgIH0sIGJpbmRpbmdbN10pLmpvaW4oIjoiKSArICc6IiInOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmdbNV0pIGRlZmF1bHRFeHByID0gYmluZGluZ1s3XVtiaW5kaW5nWzVdIC0gMV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWx1ZUV4cHIgPSAndHlwZW9mIHZhbHVlPT0ic3RyaW5nInx8dHlwZW9mIHZhbHVlPT0ibnVtYmVyIj92YWx1ZToodmFsdWU/IicgKyBiaW5kTmFtZSArICciOiIiKSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXJMaXN0LnB1c2goYmluZFZhciArICc9IicgKyBkZWZhdWx0RXhwciArICciJyk7CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZSgiYmluZF9hdHRyQ2xhc3MiLCBkb21SZWYsIGJpbmRWYXIsIHZhbHVlRXhwciwgJyInICsgcHJlZml4ICsgJyInLCBhbmltKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgInN0eWxlIjoKICAgICAgICAgICAgICAgIHZhciBleHByID0gYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCBmYWxzZSwgbDEwbkJpbmRpbmdzKTsKICAgICAgICAgICAgICAgIGF0dHJFeHBySWQgPSBiaW5kaW5nWzhdOwogICAgICAgICAgICAgICAgaWYgKCFhdHRyRXhwck1hcFthdHRyRXhwcklkXSkgewogICAgICAgICAgICAgICAgICBhdHRyRXhwck1hcFthdHRyRXhwcklkXSA9IGJpbmRWYXI7CiAgICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgIj0iICsgKGJpbmRpbmdbN10gPT0gImhpZGUiID8gJyIiJyA6ICcibm9uZSInKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYmluZGluZ1s3XSkgZXhwciA9IGV4cHIucmVwbGFjZSgvXCsiIiQvLCAiIikgKyAoYmluZGluZ1s3XSA9PSAiaGlkZSIgPyAnPyJub25lIjoiIicgOiAnPyIiOiJub25lIicpOwogICAgICAgICAgICAgICAgYmluZFZhciA9IGF0dHJFeHByTWFwW2F0dHJFeHBySWRdOwogICAgICAgICAgICAgICAgcHV0QmluZENvZGUoImJpbmRfYXR0clN0eWxlIiwgZG9tUmVmLCAnIicgKyBiaW5kaW5nWzZdICsgJyInLCBiaW5kVmFyLCBleHByKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBzcGVjaWFsQXR0ciA9IFNQRUNJQUxfQVRUUl9NQVBbYXR0ck5hbWVdOwogICAgICAgICAgICAgICAgYXR0ckV4cHJJZCA9IGJpbmRpbmdbN107CiAgICAgICAgICAgICAgICBpZiAoIWF0dHJFeHByTWFwW2F0dHJFeHBySWRdKSB7CiAgICAgICAgICAgICAgICAgIHZhckxpc3QucHVzaChiaW5kVmFyICsgIj0iICsgYnVpbGRBdHRyRXhwcmVzc2lvbihiaW5kaW5nLCAibDEwbiIsIGwxMG5CaW5kaW5ncykpOwogICAgICAgICAgICAgICAgICBhdHRyRXhwck1hcFthdHRyRXhwcklkXSA9IGJpbmRWYXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBiaW5kVmFyID0gYXR0ckV4cHJNYXBbYXR0ckV4cHJJZF07CiAgICAgICAgICAgICAgICBwdXRCaW5kQ29kZSgiYmluZF9hdHRyIiwgZG9tUmVmLCAnIicgKyBhdHRyTmFtZSArICciJywgYmluZFZhciwgc3BlY2lhbEF0dHIgJiYgU1BFQ0lBTF9BVFRSX1NJTkdMRVthdHRyTmFtZV0gPyBidWlsZEF0dHJFeHByZXNzaW9uKGJpbmRpbmcsICJib29sIiwgbDEwbkJpbmRpbmdzKSArICc/IicgKyBhdHRyTmFtZSArICciOiIiJyA6IGJ1aWxkQXR0ckV4cHJlc3Npb24oYmluZGluZywgZmFsc2UsIGwxMG5CaW5kaW5ncykpOwogICAgICAgICAgICAgICAgaWYgKHNwZWNpYWxBdHRyICYmIChzcGVjaWFsQXR0ciA9PSAiKiIgfHwgc3BlY2lhbEF0dHIuaW5kZXhPZihiaW5kaW5nWzZdLnRvTG93ZXJDYXNlKCkpICE9IC0xKSkgYmluZENvZGUucHVzaCgiaWYoIiArIGRvbVJlZiArICIuIiArIGF0dHJOYW1lICsgIiE9IiArIGJpbmRWYXIgKyAiKSIgKyBkb21SZWYgKyAiLiIgKyBhdHRyTmFtZSArICI9IiArIChTUEVDSUFMX0FUVFJfU0lOR0xFW2F0dHJOYW1lXSA/ICIhISIgKyBiaW5kVmFyIDogYmluZFZhcikgKyAiOyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlYnVnTGlzdC5wdXNoKCJ7IiArIFsgJ2JpbmRpbmc6IicgKyBiaW5kTmFtZSArICciJywgImRvbToiICsgZG9tUmVmLCAnYXR0cjoiJyArIGF0dHJOYW1lICsgJyInLCAidmFsOiIgKyBiaW5kVmFyLCAnYXR0YWNobWVudDppbnN0YW5jZS5hdHRhY2hlcyYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXSYmaW5zdGFuY2UuYXR0YWNoZXNbIicgKyBiaW5kTmFtZSArICciXS52YWx1ZScgXSArICJ9Iik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdC5wdXNoKCI7ZnVuY3Rpb24gc2V0KGJpbmROYW1lLHZhbHVlKXsiICsgJ2lmKHR5cGVvZiBiaW5kTmFtZSE9InN0cmluZyIpJyk7CiAgICAgICAgZm9yICh2YXIgYmluZE5hbWUgaW4gYmluZE1hcCkgaWYgKGJpbmRNYXBbYmluZE5hbWVdLm5vZGVCaW5kKSB7CiAgICAgICAgICByZXN1bHQucHVzaCgiaWYoYmluZE5hbWU9PT0iICsgYmluZE1hcFtiaW5kTmFtZV0ubm9kZUJpbmQgKyAiKSIgKyAnYmluZE5hbWU9IicgKyBiaW5kTmFtZSArICciOycgKyAiZWxzZSAiKTsKICAgICAgICB9CiAgICAgICAgcmVzdWx0LnB1c2goInJldHVybjsiKTsKICAgICAgICByZXN1bHQucHVzaCgidmFsdWU9cmVzb2x2ZS5jYWxsKGluc3RhbmNlLGJpbmROYW1lLHZhbHVlLEF0dGFjaGVzKTsiICsgInN3aXRjaChiaW5kTmFtZSl7Iik7CiAgICAgICAgZm9yICh2YXIgYmluZE5hbWUgaW4gYmluZE1hcCkgewogICAgICAgICAgaWYgKGJpbmROYW1lLmluZGV4T2YoIkAiKSA9PSAtMSkgdmFyTGlzdC5wdXNoKCIkJCIgKyBiaW5kTmFtZSArICI9MCIpOwogICAgICAgICAgcmVzdWx0LnB1c2goJ2Nhc2UiJyArIGJpbmROYW1lICsgJyI6JyArIChiaW5kTWFwW2JpbmROYW1lXS5sMTBuID8gYmluZE1hcFtiaW5kTmFtZV0uam9pbigiIikgOiAiaWYoX18iICsgYmluZE5hbWUgKyAiIT09dmFsdWUpIiArICJ7IiArICIkJCIgKyBiaW5kTmFtZSArICIrKzsiICsgIl9fIiArIGJpbmROYW1lICsgIj12YWx1ZTsiICsgYmluZE1hcFtiaW5kTmFtZV0uam9pbigiIikgKyAifSIpICsgImJyZWFrOyIpOwogICAgICAgIH0KICAgICAgICByZXN1bHQucHVzaCgifX0iKTsKICAgICAgICB2YXIgdG9vbHNWYXJMaXN0ID0gW107CiAgICAgICAgZm9yICh2YXIga2V5IGluIHRvb2xzVXNlZCkgdG9vbHNWYXJMaXN0LnB1c2goa2V5ICsgIj10b29scy4iICsga2V5KTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZGVidWdMaXN0OiBkZWJ1Z0xpc3QsCiAgICAgICAgICBrZXlzOiBiYXNpcy5vYmplY3Qua2V5cyhiaW5kTWFwKS5maWx0ZXIoZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHJldHVybiBrZXkuaW5kZXhPZigiQCIpID09IC0xOwogICAgICAgICAgfSksCiAgICAgICAgICB0b29sczogdG9vbHNWYXJMaXN0LAogICAgICAgICAgdmFyczogdmFyTGlzdCwKICAgICAgICAgIHNldDogcmVzdWx0LmpvaW4oIiIpLAogICAgICAgICAgbDEwbjogbDEwbk1hcCwKICAgICAgICAgIGwxMG5Db21wdXRlOiBsMTBuQ29tcHV0ZQogICAgICAgIH07CiAgICAgIH07CiAgICB9KCk7CiAgICBmdW5jdGlvbiBjb21waWxlRnVuY3Rpb24oYXJncywgYm9keSkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oYXJncywgYm9keSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBiYXNpcy5kZXYuZXJyb3IoIkNhbid0IGJ1aWxkIHRlbXBsYXRlIGZ1bmN0aW9uOiAiICsgZSArICJcbiIsICJmdW5jdGlvbigiICsgYXJncyArICIpe1xuIiArIGJvZHkgKyAiXG59Iik7CiAgICAgIH0KICAgIH0KICAgIHZhciBnZXRGdW5jdGlvbnMgPSBmdW5jdGlvbih0b2tlbnMsIGRlYnVnLCB1cmksIHNvdXJjZSwgbm9UZXh0QnVnLCB0ZW1wbGF0ZU1hcmtlcikgewogICAgICB2YXIgZm4gPSB0bXBsRnVuY3Rpb25zW3VyaSAmJiBiYXNpcy5wYXRoLnJlbGF0aXZlKHVyaSldOwogICAgICBpZiAoZm4pIHJldHVybiBmbjsKICAgICAgdmFyIHBhdGhzID0gYnVpbGRQYXRoZXModG9rZW5zLCAiXyIsIG5vVGV4dEJ1ZywgdGVtcGxhdGVNYXJrZXIpOwogICAgICB2YXIgYmluZGluZ3MgPSBidWlsZEJpbmRpbmdzKHBhdGhzLmJpbmRpbmcpOwogICAgICB2YXIgb2JqZWN0UmVmcyA9IHBhdGhzLm1hcmtlZEVsZW1lbnRMaXN0LmpvaW4oIj0iKTsKICAgICAgdmFyIGNyZWF0ZUluc3RhbmNlOwogICAgICB2YXIgZm5Cb2R5OwogICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgIGtleXM6IGJpbmRpbmdzLmtleXMsCiAgICAgICAgbDEwbktleXM6IGJhc2lzLm9iamVjdC5rZXlzKGJpbmRpbmdzLmwxMG4pCiAgICAgIH07CiAgICAgIGlmICh0b2tlbnMubGVuZ3RoID09IDEpIHBhdGhzLnBhdGhbMF0gPSAiYT1fIjsKICAgICAgaWYgKCF1cmkpIHVyaSA9IGJhc2lzLnBhdGguYmFzZVVSSSArICJpbmxpbmVfdGVtcGxhdGUiICsgaW5saW5lU2VlZCsrICsgIi50bXBsIjsKICAgICAgaWYgKGJpbmRpbmdzLmwxMG4pIHsKICAgICAgICB2YXIgY29kZSA9IFtdOwogICAgICAgIGZvciAodmFyIGtleSBpbiBiaW5kaW5ncy5sMTBuKSBjb2RlLnB1c2goJ2Nhc2UiJyArIGtleSArICciOicgKyAnaWYodmFsdWU9PW51bGwpdmFsdWU9InsnICsga2V5ICsgJ30iOycgKyAiX19sMTBuW3Rva2VuXT12YWx1ZTsiICsgYmluZGluZ3MubDEwbltrZXldLmpvaW4oIiIpICsgImJyZWFrOyIpOwogICAgICAgIHJlc3VsdC5jcmVhdGVMMTBuU3luYyA9IGNvbXBpbGVGdW5jdGlvbihbICJfIiwgIl9fbDEwbiIsICJiaW5kX2F0dHIiLCAiVEVYVF9CVUciIF0sIChzb3VyY2UgPyAiXG4vLyAiICsgc291cmNlLnNwbGl0KC9cclxuP3xcblxyPy8pLmpvaW4oIlxuLy8gIikgKyAiXG5cbiIgOiAiIikgKyAidmFyICIgKyBwYXRocy5wYXRoICsgIjsiICsgInJldHVybiBmdW5jdGlvbih0b2tlbiwgdmFsdWUpeyIgKyAic3dpdGNoKHRva2VuKXsiICsgY29kZS5qb2luKCIiKSArICJ9IiArICJ9IiArICJcblxuLy8jIHNvdXJjZVVSTD0iICsgYmFzaXMucGF0aC5vcmlnaW4gKyB1cmkgKyAiX2wxMG4iKTsKICAgICAgfQogICAgICByZXN1bHQuY3JlYXRlSW5zdGFuY2UgPSBjb21waWxlRnVuY3Rpb24oWyAidGlkIiwgIm1hcCIsICJwcm90byIsICJ0b29scyIsICJfX2wxMG4iLCAiVEVYVF9CVUciIF0sIChzb3VyY2UgPyAiXG4vLyAiICsgc291cmNlLnNwbGl0KC9cclxuP3xcblxyPy8pLmpvaW4oIlxuLy8gIikgKyAiXG5cbiIgOiAiIikgKyAidmFyIGdldEJpbmRpbmdzPXRvb2xzLmNyZWF0ZUJpbmRpbmdGdW5jdGlvbihbIiArIGJpbmRpbmdzLmtleXMubWFwKGZ1bmN0aW9uKGtleSkgewogICAgICAgIHJldHVybiAnIicgKyBrZXkgKyAnIic7CiAgICAgIH0pICsgIl0pLCIgKyAoYmluZGluZ3MudG9vbHMubGVuZ3RoID8gYmluZGluZ3MudG9vbHMgKyAiLCIgOiAiIikgKyAiQXR0YWNoZXM9ZnVuY3Rpb24oKXt9OyIgKyAiQXR0YWNoZXMucHJvdG90eXBlPXsiICsgYmluZGluZ3Mua2V5cy5tYXAoZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIGtleSArICI6bnVsbCI7CiAgICAgIH0pICsgIn07IiArICJyZXR1cm4gZnVuY3Rpb24gY3JlYXRlSW5zdGFuY2VfKGlkLG9iaixvbkFjdGlvbixvblJlYnVpbGQsYmluZGluZ3MsYmluZGluZ0ludGVyZmFjZSl7IiArICJ2YXIgXz1wcm90by5jbG9uZU5vZGUodHJ1ZSksIiArIHBhdGhzLnBhdGguY29uY2F0KGJpbmRpbmdzLnZhcnMpICsgIiwiICsgImluc3RhbmNlPXsiICsgImNvbnRleHQ6b2JqLCIgKyAiYWN0aW9uOm9uQWN0aW9uLCIgKyAicmVidWlsZDpvblJlYnVpbGQsIiArIChkZWJ1ZyA/ICJkZWJ1ZzpmdW5jdGlvbiBkZWJ1Zygpe3JldHVyblsiICsgYmluZGluZ3MuZGVidWdMaXN0ICsgIl19LCIgOiAiIikgKyAiaGFuZGxlcjpudWxsLCIgKyAiYmluZGluZ3M6YmluZGluZ3MsIiArICJiaW5kaW5nSW50ZXJmYWNlOmJpbmRpbmdJbnRlcmZhY2UsIiArICJhdHRhY2hlczpudWxsLCIgKyAidG1wbDp7IiArIFsgcGF0aHMucmVmLCAidGVtcGxhdGVJZF86aWQiLCAic2V0OnNldCIgXSArICJ9IiArICJ9IiArIChvYmplY3RSZWZzID8gIjtpZihvYmp8fG9uQWN0aW9uKSIgKyBvYmplY3RSZWZzICsgIj0oaWQ8PDEyKXx0aWQiIDogIiIpICsgYmluZGluZ3Muc2V0ICsgIjtpZihiaW5kaW5ncylpbnN0YW5jZS5oYW5kbGVyPWdldEJpbmRpbmdzKGJpbmRpbmdzLG9iaixzZXQsYmluZGluZ0ludGVyZmFjZSkiICsgIjsiICsgYmluZGluZ3MubDEwbkNvbXB1dGUgKyAiO3JldHVybiBpbnN0YW5jZSIgKyAifSIgKyAiXG5cbi8vIyBzb3VyY2VVUkw9IiArIGJhc2lzLnBhdGgub3JpZ2luICsgdXJpKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZ2V0RnVuY3Rpb25zOiBnZXRGdW5jdGlvbnMKICAgIH07CiAgfSwKICAiYS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzguanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vYi5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi9jLmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogICAgdmFyIGNsZWFuZXIgPSBiYXNpcy5jbGVhbmVyOwogICAgdmFyIEV2ZW50ID0gYmFzaXMuZG9tLmV2ZW50OwogICAgdmFyIGFkZEdsb2JhbEhhbmRsZXIgPSBFdmVudC5hZGRHbG9iYWxIYW5kbGVyOwogICAgdmFyIHJlbW92ZUdsb2JhbEhhbmRsZXIgPSBFdmVudC5yZW1vdmVHbG9iYWxIYW5kbGVyOwogICAgdmFyIEVtaXR0ZXIgPSBiYXNpcy5ldmVudC5FbWl0dGVyOwogICAgdmFyIGNyZWF0ZUV2ZW50ID0gYmFzaXMuZXZlbnQuY3JlYXRlOwogICAgdmFyIGdldENvbXB1dGVkU3R5bGUgPSBiYXNpcy5kb20uY29tcHV0ZWRTdHlsZS5nZXQ7CiAgICB2YXIgZ2V0T2Zmc2V0UGFyZW50ID0gYmFzaXMubGF5b3V0LmdldE9mZnNldFBhcmVudDsKICAgIHZhciBnZXRCb3VuZGluZ1JlY3QgPSBiYXNpcy5sYXlvdXQuZ2V0Qm91bmRpbmdSZWN0OwogICAgdmFyIGdldFZpZXdwb3J0UmVjdCA9IGJhc2lzLmxheW91dC5nZXRWaWV3cG9ydFJlY3Q7CiAgICB2YXIgU0VMRUNUU1RBUlRfU1VQUE9SVEVEID0gRXZlbnQuZ2V0RXZlbnRJbmZvKCJzZWxlY3RzdGFydCIpLnN1cHBvcnRlZDsKICAgIHZhciBkcmFnZ2luZzsKICAgIHZhciBkcmFnRWxlbWVudDsKICAgIHZhciBkcmFnRGF0YTsKICAgIGZ1bmN0aW9uIHJlc29sdmVFbGVtZW50KHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh2YWx1ZSkgOiB2YWx1ZTsKICAgIH0KICAgIGZ1bmN0aW9uIHN0YXJ0RHJhZyhldmVudCkgewogICAgICBpZiAoZHJhZ0VsZW1lbnQgfHwgdGhpcy5pZ25vcmVUYXJnZXQoZXZlbnQuc2VuZGVyLCBldmVudCkpIHJldHVybjsKICAgICAgdmFyIHZpZXdwb3J0ID0gZ2V0Vmlld3BvcnRSZWN0KGV2ZW50LnNlbmRlcik7CiAgICAgIGlmIChldmVudC5tb3VzZVggPCB2aWV3cG9ydC5sZWZ0IHx8IGV2ZW50Lm1vdXNlWCA+IHZpZXdwb3J0LnJpZ2h0IHx8IGV2ZW50Lm1vdXNlWSA8IHZpZXdwb3J0LnRvcCB8fCBldmVudC5tb3VzZVkgPiB2aWV3cG9ydC5ib3R0b20pIHJldHVybjsKICAgICAgZHJhZ0VsZW1lbnQgPSB0aGlzOwogICAgICBkcmFnRGF0YSA9IHsKICAgICAgICBpbml0WDogZXZlbnQubW91c2VYLAogICAgICAgIGluaXRZOiBldmVudC5tb3VzZVksCiAgICAgICAgZGVsdGFYOiAwLAogICAgICAgIG1pbkRlbHRhWDogLUluZmluaXR5LAogICAgICAgIG1heERlbHRhWDogSW5maW5pdHksCiAgICAgICAgZGVsdGFZOiAwLAogICAgICAgIG1pbkRlbHRhWTogLUluZmluaXR5LAogICAgICAgIG1heERlbHRhWTogSW5maW5pdHkKICAgICAgfTsKICAgICAgYWRkR2xvYmFsSGFuZGxlcigibW91c2Vtb3ZlIiwgb25EcmFnKTsKICAgICAgYWRkR2xvYmFsSGFuZGxlcigibW91c2V1cCIsIHN0b3BEcmFnKTsKICAgICAgYWRkR2xvYmFsSGFuZGxlcigibW91c2Vkb3duIiwgc3RvcERyYWcpOwogICAgICBpZiAoU0VMRUNUU1RBUlRfU1VQUE9SVEVEKSBhZGRHbG9iYWxIYW5kbGVyKCJzZWxlY3RzdGFydCIsIEV2ZW50LmtpbGwpOwogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB0aGlzLnByZXBhcmVEcmFnKGRyYWdEYXRhLCBldmVudCk7CiAgICB9CiAgICBmdW5jdGlvbiBvbkRyYWcoZXZlbnQpIHsKICAgICAgdmFyIGRlbHRhWCA9IGV2ZW50Lm1vdXNlWCAtIGRyYWdEYXRhLmluaXRYOwogICAgICB2YXIgZGVsdGFZID0gZXZlbnQubW91c2VZIC0gZHJhZ0RhdGEuaW5pdFk7CiAgICAgIGlmICghZHJhZ2dpbmcpIHsKICAgICAgICBpZiAoIWRyYWdFbGVtZW50LnN0YXJ0UnVsZShkZWx0YVgsIGRlbHRhWSkpIHJldHVybjsKICAgICAgICBkcmFnZ2luZyA9IHRydWU7CiAgICAgICAgZHJhZ0VsZW1lbnQuZW1pdF9zdGFydChkcmFnRGF0YSwgZXZlbnQpOwogICAgICB9CiAgICAgIGlmIChkcmFnRWxlbWVudC5heGlzWCkgZHJhZ0RhdGEuZGVsdGFYID0gZHJhZ0VsZW1lbnQuYXhpc1hwcm94eShiYXNpcy5udW1iZXIuZml0KGRlbHRhWCwgZHJhZ0RhdGEubWluRGVsdGFYLCBkcmFnRGF0YS5tYXhEZWx0YVgpKTsKICAgICAgaWYgKGRyYWdFbGVtZW50LmF4aXNZKSBkcmFnRGF0YS5kZWx0YVkgPSBkcmFnRWxlbWVudC5heGlzWXByb3h5KGJhc2lzLm51bWJlci5maXQoZGVsdGFZLCBkcmFnRGF0YS5taW5EZWx0YVksIGRyYWdEYXRhLm1heERlbHRhWSkpOwogICAgICBkcmFnRWxlbWVudC5lbWl0X2RyYWcoZHJhZ0RhdGEsIGV2ZW50KTsKICAgIH0KICAgIGZ1bmN0aW9uIHN0b3BEcmFnKGV2ZW50KSB7CiAgICAgIHJlbW92ZUdsb2JhbEhhbmRsZXIoIm1vdXNlbW92ZSIsIG9uRHJhZyk7CiAgICAgIHJlbW92ZUdsb2JhbEhhbmRsZXIoIm1vdXNldXAiLCBzdG9wRHJhZyk7CiAgICAgIHJlbW92ZUdsb2JhbEhhbmRsZXIoIm1vdXNlZG93biIsIHN0b3BEcmFnKTsKICAgICAgaWYgKFNFTEVDVFNUQVJUX1NVUFBPUlRFRCkgcmVtb3ZlR2xvYmFsSGFuZGxlcigic2VsZWN0c3RhcnQiLCBFdmVudC5raWxsKTsKICAgICAgdmFyIGVsZW1lbnQgPSBkcmFnRWxlbWVudDsKICAgICAgdmFyIGRhdGEgPSBkcmFnRGF0YTsKICAgICAgZHJhZ0VsZW1lbnQgPSBudWxsOwogICAgICBkcmFnRGF0YSA9IG51bGw7CiAgICAgIGlmIChkcmFnZ2luZykgewogICAgICAgIGRyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgZWxlbWVudC5lbWl0X292ZXIoZGF0YSwgZXZlbnQpOwogICAgICB9CiAgICAgIGV2ZW50LmRpZSgpOwogICAgfQogICAgdmFyIERyYWdEcm9wRWxlbWVudCA9IEVtaXR0ZXIuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRHJhZ0Ryb3BFbGVtZW50IiwKICAgICAgZWxlbWVudDogbnVsbCwKICAgICAgdHJpZ2dlcjogbnVsbCwKICAgICAgYmFzZUVsZW1lbnQ6IG51bGwsCiAgICAgIGF4aXNYOiB0cnVlLAogICAgICBheGlzWTogdHJ1ZSwKICAgICAgYXhpc1hwcm94eTogYmFzaXMuZm4uJHNlbGYsCiAgICAgIGF4aXNZcHJveHk6IGJhc2lzLmZuLiRzZWxmLAogICAgICBwcmVwYXJlRHJhZzogYmFzaXMuZm4uJHVuZGVmLAogICAgICBzdGFydFJ1bGU6IGJhc2lzLmZuLiR0cnVlLAogICAgICBpZ25vcmVUYXJnZXQ6IGZ1bmN0aW9uKHRhcmdldCwgZXZlbnQpIHsKICAgICAgICByZXR1cm4gL14oSU5QVVR8VEVYVEFSRUF8U0VMRUNUfEJVVFRPTikkLy50ZXN0KHRhcmdldC50YWdOYW1lKTsKICAgICAgfSwKICAgICAgZW1pdF9zdGFydDogY3JlYXRlRXZlbnQoInN0YXJ0IiksCiAgICAgIGVtaXRfZHJhZzogY3JlYXRlRXZlbnQoImRyYWciKSwKICAgICAgZW1pdF9vdmVyOiBjcmVhdGVFdmVudCgib3ZlciIpLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CiAgICAgICAgdmFyIHRyaWdnZXIgPSB0aGlzLnRyaWdnZXI7CiAgICAgICAgdGhpcy5lbGVtZW50ID0gbnVsbDsKICAgICAgICB0aGlzLnRyaWdnZXIgPSBudWxsOwogICAgICAgIHRoaXMuc2V0RWxlbWVudChlbGVtZW50LCB0cmlnZ2VyKTsKICAgICAgICB0aGlzLnNldEJhc2UodGhpcy5iYXNlRWxlbWVudCk7CiAgICAgICAgY2xlYW5lci5hZGQodGhpcyk7CiAgICAgIH0sCiAgICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHRyaWdnZXIpIHsKICAgICAgICB0aGlzLmVsZW1lbnQgPSByZXNvbHZlRWxlbWVudChlbGVtZW50KTsKICAgICAgICB0cmlnZ2VyID0gcmVzb2x2ZUVsZW1lbnQodHJpZ2dlcikgfHwgdGhpcy5lbGVtZW50OwogICAgICAgIGlmICh0aGlzLnRyaWdnZXIgIT09IHRyaWdnZXIpIHsKICAgICAgICAgIGlmICh0aGlzLnRyaWdnZXIpIEV2ZW50LnJlbW92ZUhhbmRsZXIodGhpcy50cmlnZ2VyLCAibW91c2Vkb3duIiwgc3RhcnREcmFnLCB0aGlzKTsKICAgICAgICAgIHRoaXMudHJpZ2dlciA9IHRyaWdnZXI7CiAgICAgICAgICBpZiAodGhpcy50cmlnZ2VyKSBFdmVudC5hZGRIYW5kbGVyKHRoaXMudHJpZ2dlciwgIm1vdXNlZG93biIsIHN0YXJ0RHJhZywgdGhpcyk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRCYXNlOiBmdW5jdGlvbihiYXNlRWxlbWVudCkgewogICAgICAgIHRoaXMuYmFzZUVsZW1lbnQgPSByZXNvbHZlRWxlbWVudChiYXNlRWxlbWVudCk7CiAgICAgIH0sCiAgICAgIGdldEJhc2U6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmJhc2VFbGVtZW50IHx8IChkb2N1bWVudC5jb21wYXRNb2RlID09ICJDU1MxQ29tcGF0IiA/IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCA6IGRvY3VtZW50LmJvZHkpOwogICAgICB9LAogICAgICBpc0RyYWdnaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZHJhZ0VsZW1lbnQgPT09IHRoaXM7CiAgICAgIH0sCiAgICAgIHN0YXJ0OiBmdW5jdGlvbihldmVudCkgewogICAgICAgIGlmICghdGhpcy5pc0RyYWdnaW5nKCkpIHN0YXJ0RHJhZy5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgfSwKICAgICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuaXNEcmFnZ2luZygpKSBzdG9wRHJhZygpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICBjbGVhbmVyLnJlbW92ZSh0aGlzKTsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KCk7CiAgICAgICAgdGhpcy5zZXRCYXNlKCk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIERlbHRhV3JpdGVyID0gYmFzaXMuQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRGVsdGFXcml0ZXIiLAogICAgICBwcm9wZXJ0eTogbnVsbCwKICAgICAgaW52ZXJ0OiBmYWxzZSwKICAgICAgZm9ybWF0OiBiYXNpcy5mbi4kc2VsZiwKICAgICAgaW5pdDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIGlmICh0eXBlb2YgdGhpcy5wcm9wZXJ0eSA9PSAiZnVuY3Rpb24iKSB0aGlzLnByb3BlcnR5ID0gdGhpcy5wcm9wZXJ0eShlbGVtZW50KTsKICAgICAgICBpZiAodHlwZW9mIHRoaXMuaW52ZXJ0ID09ICJmdW5jdGlvbiIpIHRoaXMuaW52ZXJ0ID0gdGhpcy5pbnZlcnQodGhpcy5wcm9wZXJ0eSk7CiAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMucmVhZChlbGVtZW50KTsKICAgICAgfSwKICAgICAgcmVhZDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGVsZW1lbnRbdGhpcy5wcm9wZXJ0eV07CiAgICAgIH0sCiAgICAgIHdyaXRlOiBmdW5jdGlvbihlbGVtZW50LCBmb3JtYXR0ZWRWYWx1ZSkgewogICAgICAgIGVsZW1lbnRbdGhpcy5wcm9wZXJ0eV0gPSBmb3JtYXR0ZWRWYWx1ZTsKICAgICAgfSwKICAgICAgYXBwbHlEZWx0YTogZnVuY3Rpb24oZWxlbWVudCwgZGVsdGEpIHsKICAgICAgICBpZiAodGhpcy5pbnZlcnQpIGRlbHRhID0gLWRlbHRhOwogICAgICAgIHRoaXMud3JpdGUoZWxlbWVudCwgdGhpcy5mb3JtYXQodGhpcy52YWx1ZSArIGRlbHRhLCBkZWx0YSkpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBTdHlsZURlbHRhV3JpdGVyID0gRGVsdGFXcml0ZXIuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU3R5bGVEZWx0YVdyaXRlciIsCiAgICAgIGZvcm1hdDogZnVuY3Rpb24odmFsdWUsIGRlbHRhKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlICsgInB4IjsKICAgICAgfSwKICAgICAgcmVhZDogZnVuY3Rpb24oZWxlbWVudCkgewogICAgICAgIHJldHVybiBwYXJzZUZsb2F0KGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgdGhpcy5wcm9wZXJ0eSkpIHx8IDA7CiAgICAgIH0sCiAgICAgIHdyaXRlOiBmdW5jdGlvbihlbGVtZW50LCBmb3JtYXR0ZWRWYWx1ZSkgewogICAgICAgIGVsZW1lbnQuc3R5bGVbdGhpcy5wcm9wZXJ0eV0gPSBmb3JtYXR0ZWRWYWx1ZTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgU3R5bGVQb3NpdGlvblggPSBTdHlsZURlbHRhV3JpdGVyLnN1YmNsYXNzKHsKICAgICAgcHJvcGVydHk6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICByZXR1cm4gZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCAibGVmdCIpID09ICJhdXRvIiAmJiBnZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQsICJyaWdodCIpICE9ICJhdXRvIiA/ICJyaWdodCIgOiAibGVmdCI7CiAgICAgIH0sCiAgICAgIGludmVydDogZnVuY3Rpb24ocHJvcGVydHkpIHsKICAgICAgICByZXR1cm4gcHJvcGVydHkgPT0gInJpZ2h0IjsKICAgICAgfQogICAgfSk7CiAgICB2YXIgU3R5bGVQb3NpdGlvblkgPSBTdHlsZURlbHRhV3JpdGVyLnN1YmNsYXNzKHsKICAgICAgcHJvcGVydHk6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICByZXR1cm4gZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCAidG9wIikgPT0gImF1dG8iICYmIGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgImJvdHRvbSIpICE9ICJhdXRvIiA/ICJib3R0b20iIDogInRvcCI7CiAgICAgIH0sCiAgICAgIGludmVydDogZnVuY3Rpb24ocHJvcGVydHkpIHsKICAgICAgICByZXR1cm4gcHJvcGVydHkgPT0gImJvdHRvbSI7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIE1vdmVhYmxlRWxlbWVudCA9IERyYWdEcm9wRWxlbWVudC5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Nb3ZlYWJsZUVsZW1lbnQiLAogICAgICBmaXhUb3A6IHRydWUsCiAgICAgIGZpeFJpZ2h0OiB0cnVlLAogICAgICBmaXhCb3R0b206IHRydWUsCiAgICAgIGZpeExlZnQ6IHRydWUsCiAgICAgIGF4aXNYOiBTdHlsZVBvc2l0aW9uWCwKICAgICAgYXhpc1k6IFN0eWxlUG9zaXRpb25ZLAogICAgICBlbWl0X3N0YXJ0OiBmdW5jdGlvbihkcmFnRGF0YSwgZXZlbnQpIHsKICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgdmFyIHZpZXdwb3J0ID0gZ2V0Vmlld3BvcnRSZWN0KHRoaXMuZ2V0QmFzZSgpKTsKICAgICAgICAgIHZhciBib3ggPSBnZXRCb3VuZGluZ1JlY3QoZWxlbWVudCk7CiAgICAgICAgICBkcmFnRGF0YS5lbGVtZW50ID0gZWxlbWVudDsKICAgICAgICAgIGlmICh0aGlzLmF4aXNYKSB7CiAgICAgICAgICAgIGRyYWdEYXRhLmF4aXNYID0gbmV3IHRoaXMuYXhpc1goZWxlbWVudCk7CiAgICAgICAgICAgIGlmICh0aGlzLmZpeExlZnQpIGRyYWdEYXRhLm1pbkRlbHRhWCA9IHZpZXdwb3J0LmxlZnQgLSBib3gubGVmdDsKICAgICAgICAgICAgaWYgKHRoaXMuZml4UmlnaHQpIGRyYWdEYXRhLm1heERlbHRhWCA9IHZpZXdwb3J0LnJpZ2h0IC0gYm94LnJpZ2h0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuYXhpc1kpIHsKICAgICAgICAgICAgZHJhZ0RhdGEuYXhpc1kgPSBuZXcgdGhpcy5heGlzWShlbGVtZW50KTsKICAgICAgICAgICAgaWYgKHRoaXMuZml4VG9wKSBkcmFnRGF0YS5taW5EZWx0YVkgPSB2aWV3cG9ydC50b3AgLSBib3gudG9wOwogICAgICAgICAgICBpZiAodGhpcy5maXhCb3R0b20pIGRyYWdEYXRhLm1heERlbHRhWSA9IHZpZXdwb3J0LmJvdHRvbSAtIGJveC5ib3R0b207CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIERyYWdEcm9wRWxlbWVudC5wcm90b3R5cGUuZW1pdF9zdGFydC5jYWxsKHRoaXMsIGRyYWdEYXRhLCBldmVudCk7CiAgICAgIH0sCiAgICAgIGVtaXRfZHJhZzogZnVuY3Rpb24oZHJhZ0RhdGEsIGV2ZW50KSB7CiAgICAgICAgaWYgKCFkcmFnRGF0YS5lbGVtZW50KSByZXR1cm47CiAgICAgICAgaWYgKGRyYWdEYXRhLmF4aXNYKSBkcmFnRGF0YS5heGlzWC5hcHBseURlbHRhKGRyYWdEYXRhLmVsZW1lbnQsIGRyYWdEYXRhLmRlbHRhWCk7CiAgICAgICAgaWYgKGRyYWdEYXRhLmF4aXNZKSBkcmFnRGF0YS5heGlzWS5hcHBseURlbHRhKGRyYWdEYXRhLmVsZW1lbnQsIGRyYWdEYXRhLmRlbHRhWSk7CiAgICAgICAgRHJhZ0Ryb3BFbGVtZW50LnByb3RvdHlwZS5lbWl0X2RyYWcuY2FsbCh0aGlzLCBkcmFnRGF0YSwgZXZlbnQpOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBEcmFnRHJvcEVsZW1lbnQ6IERyYWdEcm9wRWxlbWVudCwKICAgICAgTW92ZWFibGVFbGVtZW50OiBNb3ZlYWJsZUVsZW1lbnQsCiAgICAgIERlbHRhV3JpdGVyOiBEZWx0YVdyaXRlciwKICAgICAgU3R5bGVEZWx0YVdyaXRlcjogU3R5bGVEZWx0YVdyaXRlcgogICAgfTsKICB9LAogICJiLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgY29tcHV0ZWRTdHlsZTsKICAgIGlmICgiZ2V0Q29tcHV0ZWRTdHlsZSIgaW4gZ2xvYmFsKSB7CiAgICAgIHZhciBHRVRDT01QVVRFRFNUWUxFX0JVR0dZID0gewogICAgICAgIHRvcDogdHJ1ZSwKICAgICAgICBib3R0b206IHRydWUsCiAgICAgICAgbGVmdDogdHJ1ZSwKICAgICAgICByaWdodDogdHJ1ZSwKICAgICAgICBoZWlnaHQ6IHRydWUsCiAgICAgICAgd2lkdGg6IHRydWUKICAgICAgfTsKICAgICAgdmFyIHRlc3RGb3JCdWdneVByb3BlcnRpZXMgPSBiYXNpcy5mbi5ydW5PbmNlKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB0ZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIHRlc3RFbGVtZW50LnNldEF0dHJpYnV0ZSgic3R5bGUiLCAicG9zaXRpb246YWJzb2x1dGU7dG9wOmF1dG8haW1wb3J0YW50Iik7CiAgICAgICAgYmFzaXMuZG9jLmJvZHkuYWRkKHRlc3RFbGVtZW50KTsKICAgICAgICBpZiAoZ2xvYmFsLmdldENvbXB1dGVkU3R5bGUodGVzdEVsZW1lbnQpLnRvcCA9PSAiYXV0byIpIEdFVENPTVBVVEVEU1RZTEVfQlVHR1kgPSB7fTsKICAgICAgICBiYXNpcy5kb2MucmVtb3ZlKHRlc3RFbGVtZW50KTsKICAgICAgfSk7CiAgICAgIGNvbXB1dGVkU3R5bGUgPSBmdW5jdGlvbihlbGVtZW50LCBzdHlsZVByb3ApIHsKICAgICAgICB2YXIgc3R5bGUgPSBnbG9iYWwuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50KTsKICAgICAgICB2YXIgcmVzOwogICAgICAgIGlmIChzdHlsZSkgewogICAgICAgICAgaWYgKHN0eWxlUHJvcCBpbiBHRVRDT01QVVRFRFNUWUxFX0JVR0dZKSB0ZXN0Rm9yQnVnZ3lQcm9wZXJ0aWVzKCk7CiAgICAgICAgICBpZiAoR0VUQ09NUFVURURTVFlMRV9CVUdHWVtzdHlsZVByb3BdICYmIHN0eWxlLnBvc2l0aW9uICE9ICJzdGF0aWMiKSB7CiAgICAgICAgICAgIHZhciBkaXNwbGF5ID0gZWxlbWVudC5zdHlsZS5kaXNwbGF5OwogICAgICAgICAgICBlbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICAgIHJlcyA9IHN0eWxlLmdldFByb3BlcnR5VmFsdWUoc3R5bGVQcm9wKTsKICAgICAgICAgICAgZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlcyA9IHN0eWxlLmdldFByb3BlcnR5VmFsdWUoc3R5bGVQcm9wKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXM7CiAgICAgICAgfQogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgdmFyIFZBTFVFX1VOSVQgPSAvXi0/KFxkKlwuKT9cZCsoW2Etel0rfCUpPyQvaTsKICAgICAgdmFyIElTX1BJWEVMID0gL1xkcHgkL2k7CiAgICAgIHZhciBnZXRQaXhlbFZhbHVlID0gZnVuY3Rpb24oZWxlbWVudCwgdmFsdWUpIHsKICAgICAgICBpZiAoSVNfUElYRUwudGVzdCh2YWx1ZSkpIHJldHVybiBwYXJzZUludCh2YWx1ZSwgMTApICsgInB4IjsKICAgICAgICB2YXIgc3R5bGUgPSBlbGVtZW50LnN0eWxlOwogICAgICAgIHZhciBydW50aW1lU3R5bGUgPSBlbGVtZW50LnJ1bnRpbWVTdHlsZTsKICAgICAgICB2YXIgbGVmdCA9IHN0eWxlLmxlZnQ7CiAgICAgICAgdmFyIHJ1bnRpbWVMZWZ0ID0gcnVudGltZVN0eWxlLmxlZnQ7CiAgICAgICAgcnVudGltZVN0eWxlLmxlZnQgPSBlbGVtZW50LmN1cnJlbnRTdHlsZS5sZWZ0OwogICAgICAgIHN0eWxlLmxlZnQgPSB2YWx1ZSB8fCAwOwogICAgICAgIHZhbHVlID0gc3R5bGUucGl4ZWxMZWZ0OwogICAgICAgIHN0eWxlLmxlZnQgPSBsZWZ0OwogICAgICAgIHJ1bnRpbWVTdHlsZS5sZWZ0ID0gcnVudGltZUxlZnQ7CiAgICAgICAgcmV0dXJuIHZhbHVlICsgInB4IjsKICAgICAgfTsKICAgICAgY29tcHV0ZWRTdHlsZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHN0eWxlUHJvcCkgewogICAgICAgIHZhciBzdHlsZSA9IGVsZW1lbnQuY3VycmVudFN0eWxlOwogICAgICAgIGlmIChzdHlsZSkgewogICAgICAgICAgdmFyIHZhbHVlID0gc3R5bGVbc3R5bGVQcm9wID09ICJmbG9hdCIgPyAic3R5bGVGbG9hdCIgOiBiYXNpcy5zdHJpbmcuY2FtZWxpemUoc3R5bGVQcm9wKV07CiAgICAgICAgICB2YXIgdW5pdCA9ICh2YWx1ZSB8fCAiIikubWF0Y2goVkFMVUVfVU5JVCk7CiAgICAgICAgICBpZiAodW5pdCAmJiB1bml0WzJdICYmIHVuaXRbMl0gIT0gInB4IikgdmFsdWUgPSBnZXRQaXhlbFZhbHVlKGVsZW1lbnQsIHZhbHVlKTsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZ2V0OiBjb21wdXRlZFN0eWxlCiAgICB9OwogIH0sCiAgImMuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vYi5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBkb2N1bWVudCA9IGdsb2JhbC5kb2N1bWVudDsKICAgIHZhciBkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICB2YXIgY29tcHV0ZWRTdHlsZSA9IGJhc2lzLmRvbS5jb21wdXRlZFN0eWxlLmdldDsKICAgIGZ1bmN0aW9uIGdldE9mZnNldFBhcmVudChub2RlKSB7CiAgICAgIHZhciBvZmZzZXRQYXJlbnQgPSBub2RlLm9mZnNldFBhcmVudCB8fCBkb2N1bWVudEVsZW1lbnQ7CiAgICAgIHdoaWxlIChvZmZzZXRQYXJlbnQgJiYgb2Zmc2V0UGFyZW50ICE9PSBkb2N1bWVudEVsZW1lbnQgJiYgY29tcHV0ZWRTdHlsZShvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09ICJzdGF0aWMiKSBvZmZzZXRQYXJlbnQgPSBvZmZzZXRQYXJlbnQub2Zmc2V0UGFyZW50OwogICAgICByZXR1cm4gb2Zmc2V0UGFyZW50IHx8IGRvY3VtZW50RWxlbWVudDsKICAgIH0KICAgIGZ1bmN0aW9uIGdldE9mZnNldChlbGVtZW50KSB7CiAgICAgIHZhciB0b3AgPSAwOwogICAgICB2YXIgbGVmdCA9IDA7CiAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KSB7CiAgICAgICAgdmFyIHJlbFJlY3QgPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIGxlZnQgPSAtcmVsUmVjdC5sZWZ0OwogICAgICAgIHRvcCA9IC1yZWxSZWN0LnRvcDsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZG9jdW1lbnQuY29tcGF0TW9kZSA9PSAiQ1NTMUNvbXBhdCIpIHsKICAgICAgICAgIHRvcCA9IGdsb2JhbC5wYWdlWU9mZnNldCB8fCBkb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wOwogICAgICAgICAgbGVmdCA9IGdsb2JhbC5wYWdlWE9mZnNldCB8fCBkb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGJvZHkgPSBkb2N1bWVudC5ib2R5OwogICAgICAgICAgaWYgKGVsZW1lbnQgIT09IGJvZHkpIHsKICAgICAgICAgICAgdG9wID0gYm9keS5zY3JvbGxUb3AgLSBib2R5LmNsaWVudFRvcDsKICAgICAgICAgICAgbGVmdCA9IGJvZHkuc2Nyb2xsTGVmdCAtIGJvZHkuY2xpZW50TGVmdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICB4OiBsZWZ0LAogICAgICAgIHk6IHRvcAogICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gZ2V0VG9wTGVmdFBvaW50KGVsZW1lbnQsIHJlbEVsZW1lbnQpIHsKICAgICAgdmFyIGxlZnQgPSAwOwogICAgICB2YXIgdG9wID0gMDsKICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QpIHsKICAgICAgICB2YXIgYm94ID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICB2YXIgb2Zmc2V0ID0gZ2V0T2Zmc2V0KHJlbEVsZW1lbnQpOwogICAgICAgIHRvcCA9IGJveC50b3AgKyBvZmZzZXQueTsKICAgICAgICBsZWZ0ID0gYm94LmxlZnQgKyBvZmZzZXQueDsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHRvcDogdG9wLAogICAgICAgIGxlZnQ6IGxlZnQKICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldEJvdW5kaW5nUmVjdChlbGVtZW50LCByZWxFbGVtZW50KSB7CiAgICAgIHZhciB0b3AgPSAwOwogICAgICB2YXIgbGVmdCA9IDA7CiAgICAgIHZhciByaWdodCA9IDA7CiAgICAgIHZhciBib3R0b20gPSAwOwogICAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCkgewogICAgICAgIHZhciByZWN0ID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICB2YXIgb2Zmc2V0ID0gZ2V0T2Zmc2V0KHJlbEVsZW1lbnQpOwogICAgICAgIHRvcCA9IHJlY3QudG9wICsgb2Zmc2V0Lnk7CiAgICAgICAgbGVmdCA9IHJlY3QubGVmdCArIG9mZnNldC54OwogICAgICAgIHJpZ2h0ID0gcmVjdC5yaWdodCArIG9mZnNldC54OwogICAgICAgIGJvdHRvbSA9IHJlY3QuYm90dG9tICsgb2Zmc2V0Lnk7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICB0b3A6IHRvcCwKICAgICAgICBsZWZ0OiBsZWZ0LAogICAgICAgIHJpZ2h0OiByaWdodCwKICAgICAgICBib3R0b206IGJvdHRvbSwKICAgICAgICB3aWR0aDogcmlnaHQgLSBsZWZ0LAogICAgICAgIGhlaWdodDogYm90dG9tIC0gdG9wCiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBnZXRWaWV3cG9ydFJlY3QoZWxlbWVudCwgcmVsRWxlbWVudCkgewogICAgICB2YXIgcG9pbnQgPSBnZXRUb3BMZWZ0UG9pbnQoZWxlbWVudCwgcmVsRWxlbWVudCk7CiAgICAgIHZhciB0b3AgPSBwb2ludC50b3AgKyBlbGVtZW50LmNsaWVudFRvcDsKICAgICAgdmFyIGxlZnQgPSBwb2ludC5sZWZ0ICsgZWxlbWVudC5jbGllbnRMZWZ0OwogICAgICB2YXIgd2lkdGggPSBlbGVtZW50LmNsaWVudFdpZHRoOwogICAgICB2YXIgaGVpZ2h0ID0gZWxlbWVudC5jbGllbnRIZWlnaHQ7CiAgICAgIHJldHVybiB7CiAgICAgICAgdG9wOiB0b3AsCiAgICAgICAgbGVmdDogbGVmdCwKICAgICAgICBib3R0b206IHRvcCArIGhlaWdodCwKICAgICAgICByaWdodDogbGVmdCArIHdpZHRoLAogICAgICAgIHdpZHRoOiB3aWR0aCwKICAgICAgICBoZWlnaHQ6IGhlaWdodAogICAgICB9OwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGdldE9mZnNldFBhcmVudDogZ2V0T2Zmc2V0UGFyZW50LAogICAgICBnZXRUb3BMZWZ0UG9pbnQ6IGdldFRvcExlZnRQb2ludCwKICAgICAgZ2V0Qm91bmRpbmdSZWN0OiBnZXRCb3VuZGluZ1JlY3QsCiAgICAgIGdldFZpZXdwb3J0UmVjdDogZ2V0Vmlld3BvcnRSZWN0CiAgICB9OwogIH0sCiAgIjEuanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vMi5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzUuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNi5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi83LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIGRvY3VtZW50ID0gZ2xvYmFsLmRvY3VtZW50OwogICAgdmFyIENsYXNzID0gYmFzaXMuQ2xhc3M7CiAgICB2YXIgY3JlYXRlRXZlbnQgPSBiYXNpcy5ldmVudC5jcmVhdGU7CiAgICB2YXIgSHRtbFRlbXBsYXRlID0gYmFzaXMudGVtcGxhdGUuaHRtbC5UZW1wbGF0ZTsKICAgIHZhciBodG1sVGVtcGxhdGVJZE1hcmtlciA9IGJhc2lzLnRlbXBsYXRlLmh0bWwubWFya2VyOwogICAgdmFyIFRlbXBsYXRlU3dpdGNoZXIgPSBiYXNpcy50ZW1wbGF0ZS5UZW1wbGF0ZVN3aXRjaGVyOwogICAgdmFyIERXTm9kZSA9IGJhc2lzLmRvbS53cmFwcGVyLk5vZGU7CiAgICB2YXIgRFdQYXJ0aXRpb25Ob2RlID0gYmFzaXMuZG9tLndyYXBwZXIuUGFydGl0aW9uTm9kZTsKICAgIHZhciBEV0dyb3VwaW5nTm9kZSA9IGJhc2lzLmRvbS53cmFwcGVyLkdyb3VwaW5nTm9kZTsKICAgIHZhciBpbnN0YW5jZXMgPSB7fTsKICAgIHZhciBub3RpZmllciA9IG5ldyBiYXNpcy5Ub2tlbjsKICAgIHZhciBiaW5kaW5nU2VlZCA9IDE7CiAgICB2YXIgdW5rbm93bkV2ZW50QmluZGluZ0NoZWNrID0ge307CiAgICBmdW5jdGlvbiBleHRlbmRCaW5kaW5nKGJpbmRpbmcsIGV4dGVuc2lvbikgewogICAgICBiaW5kaW5nLmJpbmRpbmdJZCA9IGJpbmRpbmdTZWVkKys7CiAgICAgIGZvciAodmFyIGtleSBpbiBleHRlbnNpb24pIHsKICAgICAgICB2YXIgZGVmID0gbnVsbDsKICAgICAgICB2YXIgdmFsdWUgPSBleHRlbnNpb25ba2V5XTsKICAgICAgICBpZiAoTm9kZSAmJiB2YWx1ZSBpbnN0YW5jZW9mIE5vZGUgfHwgYmFzaXMucmVzb3VyY2UuaXNSZXNvdXJjZSh2YWx1ZSkpIHsKICAgICAgICAgIGRlZiA9IHsKICAgICAgICAgICAgZXZlbnRzOiAic2F0ZWxsaXRlQ2hhbmdlZCIsCiAgICAgICAgICAgIGdldHRlcjogZnVuY3Rpb24oa2V5LCBzYXRlbGxpdGUpIHsKICAgICAgICAgICAgICB2YXIgcmVzb3VyY2UgPSB0eXBlb2Ygc2F0ZWxsaXRlID09ICJmdW5jdGlvbiIgPyBzYXRlbGxpdGUgOiBudWxsOwogICAgICAgICAgICAgIHZhciBpbml0ID0gZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgaW5pdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHJlc291cmNlKSB7CiAgICAgICAgICAgICAgICAgIHNhdGVsbGl0ZSA9IHJlc291cmNlKCk7CiAgICAgICAgICAgICAgICAgIGlmIChzYXRlbGxpdGUgaW5zdGFuY2VvZiBOb2RlID09IGZhbHNlKSByZXR1cm47CiAgICAgICAgICAgICAgICAgIHJlc291cmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUuc2V0U2F0ZWxsaXRlKGtleSwgc2F0ZWxsaXRlKTsKICAgICAgICAgICAgICAgIGlmIChub2RlLnNhdGVsbGl0ZVtrZXldICE9PSBzYXRlbGxpdGUpIGJhc2lzLmRldi53YXJuKCJiYXNpcy51aS5iaW5kaW5nOiBpbXBsaWNpdCBzYXRlbGxpdGUgYCIgKyBrZXkgKyAiYCBhdHRhY2ggdG8gb3duZXIgZmFpbGVkIik7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICAgICAgaWYgKGluaXQpIGluaXQobm9kZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzb3VyY2UgfHwgKG5vZGUuc2F0ZWxsaXRlW2tleV0gPyBub2RlLnNhdGVsbGl0ZVtrZXldLmVsZW1lbnQgOiBudWxsKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KGtleSwgdmFsdWUpCiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIikgdmFsdWUgPSBCSU5ESU5HX1BSRVNFVC5wcm9jZXNzKGtleSwgdmFsdWUpOyBlbHNlIGlmICh2YWx1ZS5iaW5kaW5nQnJpZGdlKSB2YWx1ZSA9IGJhc2lzLmZuLiRjb25zdCh2YWx1ZSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICBkZWYgPSB7CiAgICAgICAgICAgICAgICBnZXR0ZXI6IHR5cGVvZiB2YWx1ZSA9PSAiZnVuY3Rpb24iID8gdmFsdWUgOiBiYXNpcy5nZXR0ZXIodmFsdWUpCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgIGRlZiA9IHsKICAgICAgICAgICAgICAgIGV2ZW50czogdmFsdWVbMF0sCiAgICAgICAgICAgICAgICBnZXR0ZXI6IGJhc2lzLmdldHRlcih2YWx1ZVsxXSkKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlZiA9IHsKICAgICAgICAgICAgICAgIGV2ZW50czogdmFsdWUuZXZlbnRzLAogICAgICAgICAgICAgICAgZ2V0dGVyOiBiYXNpcy5nZXR0ZXIodmFsdWUuZ2V0dGVyKQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYmluZGluZ1trZXldID0gZGVmOwogICAgICB9CiAgICB9CiAgICB2YXIgQklORElOR19QUkVTRVQgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHByZXNldHMgPSB7fTsKICAgICAgdmFyIHByZWZpeFJlZ0V4cCA9IC9eKFthLXpfXVthLXowLTlfXSopOiguKikvaTsKICAgICAgcmV0dXJuIHsKICAgICAgICBhZGQ6IGZ1bmN0aW9uKHByZWZpeCwgZnVuYykgewogICAgICAgICAgaWYgKCFwcmVzZXRzW3ByZWZpeF0pIHsKICAgICAgICAgICAgcHJlc2V0c1twcmVmaXhdID0gZnVuYzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJQcmVzZXQgYCIgKyBwcmVmaXggKyAiYCBhbHJlYWR5IGV4aXN0cywgbmV3IGRlZmluaXRpb24gaWdub3JlZCIpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcHJvY2VzczogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgdmFyIHByZXNldDsKICAgICAgICAgIHZhciBtID0gdmFsdWUubWF0Y2gocHJlZml4UmVnRXhwKTsKICAgICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgIHByZXNldCA9IHByZXNldHNbbVsxXV07CiAgICAgICAgICAgIHZhbHVlID0gbVsyXSB8fCBrZXk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcHJlc2V0ID8gcHJlc2V0KHZhbHVlKSA6IHZhbHVlOwogICAgICAgIH0KICAgICAgfTsKICAgIH0oKTsKICAgIEJJTkRJTkdfUFJFU0VULmFkZCgiZGF0YSIsIGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBldmVudHM6ICJ1cGRhdGUiLAogICAgICAgIGdldHRlcjogImRhdGEuIiArIHBhdGgKICAgICAgfTsKICAgIH0pOwogICAgQklORElOR19QUkVTRVQuYWRkKCJzYXRlbGxpdGUiLCBmdW5jdGlvbihzYXRlbGxpdGVOYW1lKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZXZlbnRzOiAic2F0ZWxsaXRlQ2hhbmdlZCIsCiAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZS5zYXRlbGxpdGVbc2F0ZWxsaXRlTmFtZV0gPyBub2RlLnNhdGVsbGl0ZVtzYXRlbGxpdGVOYW1lXS5lbGVtZW50IDogbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICB9KTsKICAgIHZhciBURU1QTEFURV9CSU5ESU5HID0gQ2xhc3MuY3VzdG9tRXh0ZW5kUHJvcGVydHkoewogICAgICBzdGF0ZTogewogICAgICAgIGV2ZW50czogInN0YXRlQ2hhbmdlZCIsCiAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nKG5vZGUuc3RhdGUpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgY2hpbGROb2Rlc1N0YXRlOiB7CiAgICAgICAgZXZlbnRzOiAiY2hpbGROb2Rlc1N0YXRlQ2hhbmdlZCIsCiAgICAgICAgZ2V0dGVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgICAgICByZXR1cm4gU3RyaW5nKG5vZGUuY2hpbGROb2Rlc1N0YXRlKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNoaWxkQ291bnQ6IHsKICAgICAgICBldmVudHM6ICJjaGlsZE5vZGVzTW9kaWZpZWQiLAogICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUuY2hpbGROb2RlcyA/IG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggOiAwOwogICAgICAgIH0KICAgICAgfSwKICAgICAgaGFzQ2hpbGRyZW46IHsKICAgICAgICBldmVudHM6ICJjaGlsZE5vZGVzTW9kaWZpZWQiLAogICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuICEhbm9kZS5maXJzdENoaWxkOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZW1wdHk6IHsKICAgICAgICBldmVudHM6ICJjaGlsZE5vZGVzTW9kaWZpZWQiLAogICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuICFub2RlLmZpcnN0Q2hpbGQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LCBleHRlbmRCaW5kaW5nKTsKICAgIHZhciBCSU5ESU5HX1RFTVBMQVRFX0lOVEVSRkFDRSA9IHsKICAgICAgYXR0YWNoOiBmdW5jdGlvbihvYmplY3QsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICBvYmplY3QuYWRkSGFuZGxlcihoYW5kbGVyLCBjb250ZXh0KTsKICAgICAgfSwKICAgICAgZGV0YWNoOiBmdW5jdGlvbihvYmplY3QsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICBvYmplY3QucmVtb3ZlSGFuZGxlcihoYW5kbGVyLCBjb250ZXh0KTsKICAgICAgfQogICAgfTsKICAgIHZhciBURU1QTEFURV9BQ1RJT04gPSBDbGFzcy5leHRlbnNpYmxlUHJvcGVydHkoewogICAgICBzZWxlY3Q6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgaWYgKHRoaXMuaXNEaXNhYmxlZCgpKSByZXR1cm47CiAgICAgICAgaWYgKHRoaXMuY29udGV4dFNlbGVjdGlvbiAmJiB0aGlzLmNvbnRleHRTZWxlY3Rpb24ubXVsdGlwbGUpIHRoaXMuc2VsZWN0KGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQubWV0YUtleSk7IGVsc2UgdGhpcy5zZWxlY3QoKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgVEVNUExBVEVfU1dJVENIRVJfSEFORExFUiA9IHsKICAgICAgIioiOiBmdW5jdGlvbihldmVudCkgewogICAgICAgIHZhciBzd2l0Y2hlciA9IHRoaXMudGVtcGxhdGVTd2l0Y2hlcl87CiAgICAgICAgaWYgKHN3aXRjaGVyICYmIHN3aXRjaGVyLnJ1bGVFdmVudHMgJiYgc3dpdGNoZXIucnVsZUV2ZW50c1tldmVudC50eXBlXSkgdGhpcy5zZXRUZW1wbGF0ZShzd2l0Y2hlci5yZXNvbHZlKHRoaXMpKTsKICAgICAgfQogICAgfTsKICAgIHZhciBURU1QTEFURSA9IG5ldyBIdG1sVGVtcGxhdGUoIjxkaXYvPiIpOwogICAgdmFyIGZyYWdtZW50cyA9IFtdOwogICAgZnVuY3Rpb24gZ2V0RG9jdW1lbnRGcmFnbWVudCgpIHsKICAgICAgcmV0dXJuIGZyYWdtZW50cy5wb3AoKSB8fCBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICB9CiAgICBmdW5jdGlvbiByZWluc2VydFBhcnRpdGlvbk5vZGVzKHBhcnRpdGlvbikgewogICAgICB2YXIgbm9kZXMgPSBwYXJ0aXRpb24ubm9kZXM7CiAgICAgIGlmIChub2RlcykgZm9yICh2YXIgaSA9IG5vZGVzLmxlbmd0aCAtIDEsIGNoaWxkOyBjaGlsZCA9IG5vZGVzW2ldOyBpLS0pIGNoaWxkLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkLCBjaGlsZC5uZXh0U2libGluZyk7CiAgICB9CiAgICB2YXIgZm9jdXNUaW1lcjsKICAgIHZhciBUZW1wbGF0ZU1peGluID0gZnVuY3Rpb24oc3VwZXJfKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdGVtcGxhdGU6IFRFTVBMQVRFLAogICAgICAgIGVtaXRfdGVtcGxhdGVDaGFuZ2VkOiBjcmVhdGVFdmVudCgidGVtcGxhdGVDaGFuZ2VkIiksCiAgICAgICAgdGVtcGxhdGVTd2l0Y2hlcl86IG51bGwsCiAgICAgICAgYmluZGluZzogVEVNUExBVEVfQklORElORywKICAgICAgICBhY3Rpb246IFRFTVBMQVRFX0FDVElPTiwKICAgICAgICB0bXBsOiBudWxsLAogICAgICAgIGVsZW1lbnQ6IG51bGwsCiAgICAgICAgY2hpbGROb2Rlc0VsZW1lbnQ6IG51bGwsCiAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLmVsZW1lbnQgPSB0aGlzLmNoaWxkTm9kZXNFbGVtZW50ID0gZ2V0RG9jdW1lbnRGcmFnbWVudCgpOwogICAgICAgICAgc3VwZXJfLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB9LAogICAgICAgIHBvc3RJbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHN1cGVyXy5wb3N0SW5pdC5jYWxsKHRoaXMpOwogICAgICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy50ZW1wbGF0ZTsKICAgICAgICAgIGlmICh0ZW1wbGF0ZSkgewogICAgICAgICAgICB2YXIgbm9kZURvY3VtZW50RnJhZ21lbnQgPSB0aGlzLmVsZW1lbnQ7CiAgICAgICAgICAgIHZhciBiaW5kaW5nSWQgPSB0aGlzLmNvbnN0cnVjdG9yLmJhc2lzQ2xhc3NJZF8gKyAiXyIgKyB0aGlzLmJpbmRpbmcuYmluZGluZ0lkOwogICAgICAgICAgICBpZiAoYmluZGluZ0lkIGluIHVua25vd25FdmVudEJpbmRpbmdDaGVjayA9PSBmYWxzZSkgewogICAgICAgICAgICAgIHVua25vd25FdmVudEJpbmRpbmdDaGVja1tiaW5kaW5nSWRdID0gdHJ1ZTsKICAgICAgICAgICAgICBmb3IgKHZhciBiaW5kTmFtZSBpbiB0aGlzLmJpbmRpbmcpIHsKICAgICAgICAgICAgICAgIHZhciBldmVudHMgPSB0aGlzLmJpbmRpbmdbYmluZE5hbWVdICYmIHRoaXMuYmluZGluZ1tiaW5kTmFtZV0uZXZlbnRzOwogICAgICAgICAgICAgICAgaWYgKGV2ZW50cykgewogICAgICAgICAgICAgICAgICBldmVudHMgPSBTdHJpbmcoZXZlbnRzKS50cmltKCkuc3BsaXQoL1xzK3xccyosXHMqLyk7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudE5hbWU7IGV2ZW50TmFtZSA9IGV2ZW50c1tpXTsgaSsrKSBpZiAoImVtaXRfIiArIGV2ZW50TmFtZSBpbiB0aGlzID09IGZhbHNlKSBiYXNpcy5kZXYud2FybigiYmFzaXMudWk6IGJpbmRpbmcgYCIgKyBiaW5kTmFtZSArICJgIGhhcyB1bmtub3duIGV2ZW50IGAiICsgZXZlbnROYW1lICsgImAgZm9yICIgKyB0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLnNldFRlbXBsYXRlKHRlbXBsYXRlKTsKICAgICAgICAgICAgZnJhZ21lbnRzLnB1c2gobm9kZURvY3VtZW50RnJhZ21lbnQpOwogICAgICAgICAgICBpZiAodGhpcy5jb250YWluZXIpIHsKICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh0aGlzLmVsZW1lbnQpOwogICAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2VzW3RoaXMuYmFzaXNPYmplY3RJZF0gPSB0aGlzOwogICAgICAgICAgbm90aWZpZXIuc2V0KHsKICAgICAgICAgICAgYWN0aW9uOiAiY3JlYXRlIiwKICAgICAgICAgICAgaW5zdGFuY2U6IHRoaXMKICAgICAgICAgIH0pOwogICAgICAgIH0sCiAgICAgICAgdGVtcGxhdGVTeW5jOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBvbGRFbGVtZW50ID0gdGhpcy5lbGVtZW50OwogICAgICAgICAgdmFyIG9sZFRtcGwgPSB0aGlzLnRtcGw7CiAgICAgICAgICB2YXIgdG1wbCA9IHRoaXMudGVtcGxhdGUuY3JlYXRlSW5zdGFuY2UodGhpcywgdGhpcy50ZW1wbGF0ZUFjdGlvbiwgdGhpcy50ZW1wbGF0ZVN5bmMsIHRoaXMuYmluZGluZywgQklORElOR19URU1QTEFURV9JTlRFUkZBQ0UpOwogICAgICAgICAgdmFyIG5vQ2hpbGROb2Rlc0VsZW1lbnQ7CiAgICAgICAgICBpZiAodG1wbC5jaGlsZE5vZGVzSGVyZSkgewogICAgICAgICAgICB0bXBsLmNoaWxkTm9kZXNFbGVtZW50ID0gdG1wbC5jaGlsZE5vZGVzSGVyZS5wYXJlbnROb2RlOwogICAgICAgICAgICB0bXBsLmNoaWxkTm9kZXNFbGVtZW50Lmluc2VydFBvaW50ID0gdG1wbC5jaGlsZE5vZGVzSGVyZTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMudG1wbCA9IHRtcGw7CiAgICAgICAgICB0aGlzLmVsZW1lbnQgPSB0bXBsLmVsZW1lbnQ7CiAgICAgICAgICB0aGlzLmNoaWxkTm9kZXNFbGVtZW50ID0gdG1wbC5jaGlsZE5vZGVzRWxlbWVudCB8fCB0bXBsLmVsZW1lbnQ7CiAgICAgICAgICBub0NoaWxkTm9kZXNFbGVtZW50ID0gdGhpcy5jaGlsZE5vZGVzRWxlbWVudC5ub2RlVHlwZSAhPSAxOwogICAgICAgICAgaWYgKG5vQ2hpbGROb2Rlc0VsZW1lbnQpIHRoaXMuY2hpbGROb2Rlc0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgICBpZiAobm9DaGlsZE5vZGVzRWxlbWVudCkgdGhpcy5ub0NoaWxkTm9kZXNFbGVtZW50XyA9IHRydWU7IGVsc2UgZGVsZXRlIHRoaXMubm9DaGlsZE5vZGVzRWxlbWVudF87CiAgICAgICAgICBpZiAodGhpcy5ncm91cGluZykgewogICAgICAgICAgICB0aGlzLmdyb3VwaW5nLnN5bmNEb21SZWZzKCk7CiAgICAgICAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAgICAgICB3aGlsZSAoY3Vyc29yLmdyb3VwaW5nKSBjdXJzb3IgPSBjdXJzb3IuZ3JvdXBpbmc7CiAgICAgICAgICAgIHZhciB0b3BHcm91cGluZyA9IGN1cnNvcjsKICAgICAgICAgICAgZm9yICh2YXIgZ3JvdXBOb2RlID0gdG9wR3JvdXBpbmcubGFzdENoaWxkOyBncm91cE5vZGU7IGdyb3VwTm9kZSA9IGdyb3VwTm9kZS5wcmV2aW91c1NpYmxpbmcpIHsKICAgICAgICAgICAgICBpZiAoZ3JvdXBOb2RlIGluc3RhbmNlb2YgUGFydGl0aW9uTm9kZSkgdG9wR3JvdXBpbmcuaW5zZXJ0QmVmb3JlKGdyb3VwTm9kZSwgZ3JvdXBOb2RlLm5leHRTaWJsaW5nKTsgZWxzZSByZWluc2VydFBhcnRpdGlvbk5vZGVzKGdyb3VwTm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVpbnNlcnRQYXJ0aXRpb25Ob2Rlcyh0b3BHcm91cGluZy5udWxsR3JvdXApOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgY2hpbGQgPSB0aGlzLmxhc3RDaGlsZDsgY2hpbGQ7IGNoaWxkID0gY2hpbGQucHJldmlvdXNTaWJsaW5nKSB0aGlzLmluc2VydEJlZm9yZShjaGlsZCwgY2hpbGQubmV4dFNpYmxpbmcpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBQYXJ0aXRpb25Ob2RlKSByZWluc2VydFBhcnRpdGlvbk5vZGVzKHRoaXMpOwogICAgICAgICAgaWYgKG9sZEVsZW1lbnQgJiYgb2xkRWxlbWVudCAhPT0gdGhpcy5lbGVtZW50ICYmIG9sZEVsZW1lbnQubm9kZVR5cGUgIT0gMTEpIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBvbGRFbGVtZW50ICYmIG9sZEVsZW1lbnQucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICBpZiAodGhpcy5vd25lciAmJiB0aGlzLm93bmVyLnRtcGwpIHRoaXMub3duZXIudG1wbC5zZXQob2xkRWxlbWVudCwgdGhpcy5lbGVtZW50KTsKICAgICAgICAgICAgICBpZiAodGhpcy5lbGVtZW50LnBhcmVudE5vZGUgIT09IHBhcmVudE5vZGUpIHBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMuZWxlbWVudCwgb2xkRWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbGRUbXBsKSB0aGlzLmVtaXRfdGVtcGxhdGVDaGFuZ2VkKCk7CiAgICAgICAgfSwKICAgICAgICBzZXRUZW1wbGF0ZTogZnVuY3Rpb24odGVtcGxhdGUpIHsKICAgICAgICAgIHZhciBjdXJTd2l0Y2hlciA9IHRoaXMudGVtcGxhdGVTd2l0Y2hlcl87CiAgICAgICAgICB2YXIgc3dpdGNoZXI7CiAgICAgICAgICBpZiAodGVtcGxhdGUgaW5zdGFuY2VvZiBUZW1wbGF0ZVN3aXRjaGVyKSB7CiAgICAgICAgICAgIHN3aXRjaGVyID0gdGVtcGxhdGU7CiAgICAgICAgICAgIHRlbXBsYXRlID0gc3dpdGNoZXIucmVzb2x2ZSh0aGlzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0ZW1wbGF0ZSBpbnN0YW5jZW9mIEh0bWxUZW1wbGF0ZSA9PSBmYWxzZSkgdGVtcGxhdGUgPSBudWxsOwogICAgICAgICAgaWYgKCF0ZW1wbGF0ZSkgewogICAgICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMudWkuTm9kZSNzZXRUZW1wbGF0ZTogc2V0IG51bGwgdG8gdGVtcGxhdGUgcG9zc2libGUgb25seSBvbiBub2RlIGRlc3Ryb3kiKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHN3aXRjaGVyKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGVTd2l0Y2hlcl8gPSBzd2l0Y2hlcjsKICAgICAgICAgICAgaWYgKCFjdXJTd2l0Y2hlcikgdGhpcy5hZGRIYW5kbGVyKFRFTVBMQVRFX1NXSVRDSEVSX0hBTkRMRVIsIHRoaXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1clN3aXRjaGVyICYmIGN1clN3aXRjaGVyLnJlc29sdmUodGhpcykgIT09IHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGVTd2l0Y2hlcl8gPSBudWxsOwogICAgICAgICAgICB0aGlzLnJlbW92ZUhhbmRsZXIoVEVNUExBVEVfU1dJVENIRVJfSEFORExFUiwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgb2xkVG1wbCA9IHRoaXMudG1wbDsKICAgICAgICAgIHZhciBvbGRUZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGU7CiAgICAgICAgICBpZiAob2xkVGVtcGxhdGUgIT09IHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZVN5bmMoKTsKICAgICAgICAgICAgaWYgKG9sZFRlbXBsYXRlKSBvbGRUZW1wbGF0ZS5jbGVhckluc3RhbmNlKG9sZFRtcGwpOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgdXBkYXRlQmluZDogZnVuY3Rpb24oYmluZE5hbWUpIHsKICAgICAgICAgIHZhciBiaW5kaW5nID0gdGhpcy5iaW5kaW5nW2JpbmROYW1lXTsKICAgICAgICAgIHZhciBnZXR0ZXIgPSBiaW5kaW5nICYmIGJpbmRpbmcuZ2V0dGVyOwogICAgICAgICAgaWYgKGdldHRlciAmJiB0aGlzLnRtcGwpIHRoaXMudG1wbC5zZXQoYmluZE5hbWUsIGdldHRlcih0aGlzKSk7CiAgICAgICAgfSwKICAgICAgICB0ZW1wbGF0ZUFjdGlvbjogZnVuY3Rpb24oYWN0aW9uTmFtZSwgZXZlbnQpIHsKICAgICAgICAgIHZhciBhY3Rpb24gPSB0aGlzLmFjdGlvblthY3Rpb25OYW1lXTsKICAgICAgICAgIGlmIChhY3Rpb24pIGFjdGlvbi5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgICAgIGlmICghYWN0aW9uKSBiYXNpcy5kZXYud2FybigidGVtcGxhdGUgY2FsbCBgIiArIGFjdGlvbk5hbWUgKyAiYCBhY3Rpb24sIGJ1dCBpdCBpc24ndCBkZWZpbmVkIGluIGFjdGlvbiBsaXN0Iik7CiAgICAgICAgfSwKICAgICAgICBmb2N1czogZnVuY3Rpb24oc2VsZWN0KSB7CiAgICAgICAgICB2YXIgZm9jdXNFbGVtZW50ID0gdGhpcy50bXBsID8gdGhpcy50bXBsLmZvY3VzIHx8IHRoaXMuZWxlbWVudCA6IG51bGw7CiAgICAgICAgICBpZiAoZm9jdXNFbGVtZW50KSB7CiAgICAgICAgICAgIGlmIChmb2N1c1RpbWVyKSBmb2N1c1RpbWVyID0gYmFzaXMuY2xlYXJJbW1lZGlhdGUoZm9jdXNUaW1lcik7CiAgICAgICAgICAgIGZvY3VzVGltZXIgPSBiYXNpcy5zZXRJbW1lZGlhdGUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZvY3VzRWxlbWVudC5mb2N1cygpOwogICAgICAgICAgICAgICAgaWYgKHNlbGVjdCkgZm9jdXNFbGVtZW50LnNlbGVjdCgpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgYmx1cjogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZm9jdXNFbGVtZW50ID0gdGhpcy50bXBsID8gdGhpcy50bXBsLmZvY3VzIHx8IHRoaXMuZWxlbWVudCA6IG51bGw7CiAgICAgICAgICBpZiAoZm9jdXNFbGVtZW50KSB0cnkgewogICAgICAgICAgICBmb2N1c0VsZW1lbnQuYmx1cigpOwogICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICB9LAogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgZGVsZXRlIGluc3RhbmNlc1t0aGlzLmJhc2lzT2JqZWN0SWRdOwogICAgICAgICAgbm90aWZpZXIuc2V0KHsKICAgICAgICAgICAgYWN0aW9uOiAiZGVzdHJveSIsCiAgICAgICAgICAgIGluc3RhbmNlOiB0aGlzCiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGU7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKICAgICAgICAgIGlmICh0aGlzLnRlbXBsYXRlU3dpdGNoZXJfKSB7CiAgICAgICAgICAgIHRoaXMudGVtcGxhdGVTd2l0Y2hlcl8gPSBudWxsOwogICAgICAgICAgICB0aGlzLnJlbW92ZUhhbmRsZXIoVEVNUExBVEVfU1dJVENIRVJfSEFORExFUiwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgICB0ZW1wbGF0ZS5jbGVhckluc3RhbmNlKHRoaXMudG1wbCk7CiAgICAgICAgICBzdXBlcl8uZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgICAgdGhpcy50bXBsID0gbnVsbDsKICAgICAgICAgIHRoaXMuZWxlbWVudCA9IG51bGw7CiAgICAgICAgICB0aGlzLmNoaWxkTm9kZXNFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gZWxlbWVudCAmJiBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICBpZiAocGFyZW50Tm9kZSAmJiBwYXJlbnROb2RlLm5vZGVUeXBlID09IDEpIHBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgfQogICAgICB9OwogICAgfTsKICAgIHZhciBDb250YWluZXJUZW1wbGF0ZU1peGluID0gZnVuY3Rpb24oc3VwZXJfKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgaW5zZXJ0QmVmb3JlOiBmdW5jdGlvbihuZXdDaGlsZCwgcmVmQ2hpbGQpIHsKICAgICAgICAgIGlmICh0aGlzLm5vQ2hpbGROb2Rlc0VsZW1lbnRfKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm5vQ2hpbGROb2Rlc0VsZW1lbnRfOwogICAgICAgICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMudWk6IFRlbXBsYXRlIGhhcyBubyBjaGlsZE5vZGVzRWxlbWVudCBjb250YWluZXIsIGJ1dCBpbnNlcnRCZWZvcmUgbWV0aG9kIGNhbGxlZDsgcHJvYmFibHkgaXQncyBhIGJ1ZyIpOwogICAgICAgICAgfQogICAgICAgICAgbmV3Q2hpbGQgPSBzdXBlcl8uaW5zZXJ0QmVmb3JlLmNhbGwodGhpcywgbmV3Q2hpbGQsIHJlZkNoaWxkKTsKICAgICAgICAgIHZhciB0YXJnZXQgPSBuZXdDaGlsZC5ncm91cE5vZGUgfHwgdGhpczsKICAgICAgICAgIHZhciBjb250YWluZXIgPSB0YXJnZXQuY2hpbGROb2Rlc0VsZW1lbnQgfHwgdGhpcy5jaGlsZE5vZGVzRWxlbWVudDsKICAgICAgICAgIHZhciBuZXh0U2libGluZyA9IG5ld0NoaWxkLm5leHRTaWJsaW5nOwogICAgICAgICAgdmFyIGluc2VydFBvaW50ID0gbmV4dFNpYmxpbmcgJiYgbmV4dFNpYmxpbmcuZWxlbWVudC5wYXJlbnROb2RlID09IGNvbnRhaW5lciA/IG5leHRTaWJsaW5nLmVsZW1lbnQgOiBudWxsOwogICAgICAgICAgdmFyIGNoaWxkRWxlbWVudCA9IG5ld0NoaWxkLmVsZW1lbnQ7CiAgICAgICAgICB2YXIgcmVmTm9kZSA9IGluc2VydFBvaW50IHx8IGNvbnRhaW5lci5pbnNlcnRQb2ludCB8fCBudWxsOwogICAgICAgICAgaWYgKGNoaWxkRWxlbWVudC5wYXJlbnROb2RlICE9PSBjb250YWluZXIgfHwgY2hpbGRFbGVtZW50Lm5leHRTaWJsaW5nICE9PSByZWZOb2RlKSBjb250YWluZXIuaW5zZXJ0QmVmb3JlKGNoaWxkRWxlbWVudCwgcmVmTm9kZSk7CiAgICAgICAgICByZXR1cm4gbmV3Q2hpbGQ7CiAgICAgICAgfSwKICAgICAgICByZW1vdmVDaGlsZDogZnVuY3Rpb24ob2xkQ2hpbGQpIHsKICAgICAgICAgIHN1cGVyXy5yZW1vdmVDaGlsZC5jYWxsKHRoaXMsIG9sZENoaWxkKTsKICAgICAgICAgIHZhciBlbGVtZW50ID0gb2xkQ2hpbGQuZWxlbWVudDsKICAgICAgICAgIHZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CiAgICAgICAgICBpZiAocGFyZW50KSBwYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgICByZXR1cm4gb2xkQ2hpbGQ7CiAgICAgICAgfSwKICAgICAgICBjbGVhcjogZnVuY3Rpb24oYWxpdmUpIHsKICAgICAgICAgIGlmIChhbGl2ZSkgewogICAgICAgICAgICB2YXIgbm9kZSA9IHRoaXMuZmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IG5vZGUuZWxlbWVudDsKICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICAgIGlmIChwYXJlbnQpIHBhcmVudC5yZW1vdmVDaGlsZChlbGVtZW50KTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3VwZXJfLmNsZWFyLmNhbGwodGhpcywgYWxpdmUpOwogICAgICAgIH0sCiAgICAgICAgc2V0Q2hpbGROb2RlczogZnVuY3Rpb24oY2hpbGROb2Rlcywga2VlcEFsaXZlKSB7CiAgICAgICAgICBpZiAodGhpcy5ub0NoaWxkTm9kZXNFbGVtZW50XykgewogICAgICAgICAgICBkZWxldGUgdGhpcy5ub0NoaWxkTm9kZXNFbGVtZW50XzsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLnVpOiBUZW1wbGF0ZSBoYXMgbm8gY2hpbGROb2Rlc0VsZW1lbnQgY29udGFpbmVyLCBidXQgc2V0Q2hpbGROb2RlcyBtZXRob2QgY2FsbGVkOyBwcm9iYWJseSBpdCdzIGEgYnVnIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZG9tRnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcy5ncm91cGluZyB8fCB0aGlzOwogICAgICAgICAgdmFyIGNvbnRhaW5lciA9IHRhcmdldC5jaGlsZE5vZGVzRWxlbWVudDsKICAgICAgICAgIHRhcmdldC5jaGlsZE5vZGVzRWxlbWVudCA9IGRvbUZyYWdtZW50OwogICAgICAgICAgc3VwZXJfLnNldENoaWxkTm9kZXMuY2FsbCh0aGlzLCBjaGlsZE5vZGVzLCBrZWVwQWxpdmUpOwogICAgICAgICAgY29udGFpbmVyLmluc2VydEJlZm9yZShkb21GcmFnbWVudCwgY29udGFpbmVyLmluc2VydFBvaW50IHx8IG51bGwpOwogICAgICAgICAgdGFyZ2V0LmNoaWxkTm9kZXNFbGVtZW50ID0gY29udGFpbmVyOwogICAgICAgIH0KICAgICAgfTsKICAgIH07CiAgICB2YXIgUGFydGl0aW9uTm9kZSA9IENsYXNzKERXUGFydGl0aW9uTm9kZSwgVGVtcGxhdGVNaXhpbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuUGFydGl0aW9uTm9kZSIsCiAgICAgIGJpbmRpbmc6IHsKICAgICAgICB0aXRsZTogImRhdGE6IgogICAgICB9CiAgICB9KTsKICAgIHZhciBHcm91cGluZ05vZGUgPSBDbGFzcyhEV0dyb3VwaW5nTm9kZSwgQ29udGFpbmVyVGVtcGxhdGVNaXhpbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuR3JvdXBpbmdOb2RlIiwKICAgICAgY2hpbGRDbGFzczogUGFydGl0aW9uTm9kZSwKICAgICAgZ3JvdXBpbmdDbGFzczogQ2xhc3MuU0VMRiwKICAgICAgZWxlbWVudDogbnVsbCwKICAgICAgY2hpbGROb2Rlc0VsZW1lbnQ6IG51bGwsCiAgICAgIGVtaXRfb3duZXJDaGFuZ2VkOiBmdW5jdGlvbihvbGRPd25lcikgewogICAgICAgIHRoaXMuc3luY0RvbVJlZnMoKTsKICAgICAgICBEV0dyb3VwaW5nTm9kZS5wcm90b3R5cGUuZW1pdF9vd25lckNoYW5nZWQuY2FsbCh0aGlzLCBvbGRPd25lcik7CiAgICAgIH0sCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZWxlbWVudCA9IHRoaXMuY2hpbGROb2Rlc0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgICAgRFdHcm91cGluZ05vZGUucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICBpbnN0YW5jZXNbdGhpcy5iYXNpc09iamVjdElkXSA9IHRoaXM7CiAgICAgICAgbm90aWZpZXIuc2V0KHsKICAgICAgICAgIGFjdGlvbjogImNyZWF0ZSIsCiAgICAgICAgICBpbnN0YW5jZTogdGhpcwogICAgICAgIH0pOwogICAgICB9LAogICAgICBzeW5jRG9tUmVmczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgICAgdmFyIG93bmVyID0gdGhpcy5vd25lcjsKICAgICAgICB2YXIgZWxlbWVudCA9IG51bGw7CiAgICAgICAgaWYgKG93bmVyKSBlbGVtZW50ID0gb3duZXIudG1wbCAmJiBvd25lci50bXBsLmdyb3Vwc0VsZW1lbnQgfHwgb3duZXIuY2hpbGROb2Rlc0VsZW1lbnQ7CiAgICAgICAgZG8gewogICAgICAgICAgY3Vyc29yLmVsZW1lbnQgPSBjdXJzb3IuY2hpbGROb2Rlc0VsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIH0gd2hpbGUgKGN1cnNvciA9IGN1cnNvci5ncm91cGluZyk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGRlbGV0ZSBpbnN0YW5jZXNbdGhpcy5iYXNpc09iamVjdElkXTsKICAgICAgICBub3RpZmllci5zZXQoewogICAgICAgICAgYWN0aW9uOiAiZGVzdHJveSIsCiAgICAgICAgICBpbnN0YW5jZTogdGhpcwogICAgICAgIH0pOwogICAgICAgIERXR3JvdXBpbmdOb2RlLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5lbGVtZW50ID0gbnVsbDsKICAgICAgICB0aGlzLmNoaWxkTm9kZXNFbGVtZW50ID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgICB2YXIgTm9kZSA9IENsYXNzKERXTm9kZSwgVGVtcGxhdGVNaXhpbiwgQ29udGFpbmVyVGVtcGxhdGVNaXhpbiwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTm9kZSIsCiAgICAgIGJpbmRpbmc6IHsKICAgICAgICBzZWxlY3RlZDogewogICAgICAgICAgZXZlbnRzOiAic2VsZWN0IHVuc2VsZWN0IiwKICAgICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZS5zZWxlY3RlZDsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIHVuc2VsZWN0ZWQ6IHsKICAgICAgICAgIGV2ZW50czogInNlbGVjdCB1bnNlbGVjdCIsCiAgICAgICAgICBnZXR0ZXI6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuICFub2RlLnNlbGVjdGVkOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZGlzYWJsZWQ6IHsKICAgICAgICAgIGV2ZW50czogImRpc2FibGUgZW5hYmxlIiwKICAgICAgICAgIGdldHRlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZS5pc0Rpc2FibGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBlbmFibGVkOiB7CiAgICAgICAgICBldmVudHM6ICJkaXNhYmxlIGVuYWJsZSIsCiAgICAgICAgICBnZXR0ZXI6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuICFub2RlLmlzRGlzYWJsZWQoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNoaWxkQ2xhc3M6IENsYXNzLlNFTEYsCiAgICAgIGNoaWxkRmFjdG9yeTogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgcmV0dXJuIG5ldyB0aGlzLmNoaWxkQ2xhc3MoY29uZmlnKTsKICAgICAgfSwKICAgICAgZ3JvdXBpbmdDbGFzczogR3JvdXBpbmdOb2RlCiAgICB9KTsKICAgIHZhciBTaGFkb3dOb2RlTGlzdCA9IE5vZGUuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU2hhZG93Tm9kZUxpc3QiLAogICAgICBlbWl0X293bmVyQ2hhbmdlZDogZnVuY3Rpb24ob2xkT3duZXIpIHsKICAgICAgICBOb2RlLnByb3RvdHlwZS5lbWl0X293bmVyQ2hhbmdlZC5jYWxsKHRoaXMsIG9sZE93bmVyKTsKICAgICAgICB0aGlzLnNldERhdGFTb3VyY2UodGhpcy5vd25lciAmJiB0aGlzLm93bmVyLmdldENoaWxkTm9kZXNEYXRhc2V0KCkpOwogICAgICB9LAogICAgICBnZXRDaGlsZE5vZGVzRWxlbWVudDogZnVuY3Rpb24ob3duZXIpIHsKICAgICAgICByZXR1cm4gb3duZXIuY2hpbGROb2Rlc0VsZW1lbnQ7CiAgICAgIH0sCiAgICAgIGxpc3RlbjogewogICAgICAgIG93bmVyOiB7CiAgICAgICAgICB0ZW1wbGF0ZUNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLmNoaWxkTm9kZXMuZm9yRWFjaChmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQoY2hpbGQuZWxlbWVudCk7CiAgICAgICAgICAgIH0sIHRoaXMuZ2V0Q2hpbGROb2Rlc0VsZW1lbnQodGhpcy5vd25lcikgfHwgdGhpcy5vd25lci5lbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIGNoaWxkQ2xhc3M6IHsKICAgICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU2hhZG93Tm9kZSIsCiAgICAgICAgZ2V0RWxlbWVudDogZnVuY3Rpb24obm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUuZWxlbWVudDsKICAgICAgICB9LAogICAgICAgIHRlbXBsYXRlU3luYzogZnVuY3Rpb24oKSB7CiAgICAgICAgICBOb2RlLnByb3RvdHlwZS50ZW1wbGF0ZVN5bmMuY2FsbCh0aGlzKTsKICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gdGhpcy5nZXRFbGVtZW50KHRoaXMuZGVsZWdhdGUpOwogICAgICAgICAgaWYgKG5ld0VsZW1lbnQpIHsKICAgICAgICAgICAgbmV3RWxlbWVudFtodG1sVGVtcGxhdGVJZE1hcmtlcl0gPSB0aGlzLmRlbGVnYXRlLmVsZW1lbnRbaHRtbFRlbXBsYXRlSWRNYXJrZXJdOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQgPSBuZXdFbGVtZW50OwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbGlzdGVuOiB7CiAgICAgICAgICBkZWxlZ2F0ZTogewogICAgICAgICAgICB0ZW1wbGF0ZUNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBvbGRFbGVtZW50ID0gdGhpcy5lbGVtZW50OwogICAgICAgICAgICAgIHZhciBvbGRFbGVtZW50UGFyZW50ID0gb2xkRWxlbWVudC5wYXJlbnROb2RlOwogICAgICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gdGhpcy5nZXRFbGVtZW50KHRoaXMuZGVsZWdhdGUpOwogICAgICAgICAgICAgIGlmIChuZXdFbGVtZW50KSBuZXdFbGVtZW50W2h0bWxUZW1wbGF0ZUlkTWFya2VyXSA9IHRoaXMuZGVsZWdhdGUuZWxlbWVudFtodG1sVGVtcGxhdGVJZE1hcmtlcl07CiAgICAgICAgICAgICAgdGhpcy5lbGVtZW50ID0gbmV3RWxlbWVudCB8fCB0aGlzLnRtcGwuZWxlbWVudDsKICAgICAgICAgICAgICBpZiAob2xkRWxlbWVudFBhcmVudCkgb2xkRWxlbWVudFBhcmVudC5yZXBsYWNlQ2hpbGQodGhpcy5lbGVtZW50LCBvbGRFbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgZGVidWdfbm90aWZpZXI6IG5vdGlmaWVyLAogICAgICBkZWJ1Z19nZXRJbnN0YW5jZXM6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBiYXNpcy5vYmplY3QudmFsdWVzKGluc3RhbmNlcyk7CiAgICAgIH0sCiAgICAgIEJJTkRJTkdfUFJFU0VUOiBCSU5ESU5HX1BSRVNFVCwKICAgICAgTm9kZTogTm9kZSwKICAgICAgUGFydGl0aW9uTm9kZTogUGFydGl0aW9uTm9kZSwKICAgICAgR3JvdXBpbmdOb2RlOiBHcm91cGluZ05vZGUsCiAgICAgIFNoYWRvd05vZGVMaXN0OiBTaGFkb3dOb2RlTGlzdCwKICAgICAgU2hhZG93Tm9kZTogU2hhZG93Tm9kZUxpc3QucHJvdG90eXBlLmNoaWxkQ2xhc3MKICAgIH07CiAgfSwKICAiZS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyOwogICAgdmFyIGNsZWFuZXIgPSBiYXNpcy5jbGVhbmVyOwogICAgdmFyIEVtaXR0ZXIgPSBiYXNpcy5ldmVudC5FbWl0dGVyOwogICAgdmFyIEFic3RyYWN0RGF0YSA9IGJhc2lzLmRhdGEuQWJzdHJhY3REYXRhOwogICAgdmFyIFZhbHVlID0gYmFzaXMuZGF0YS5WYWx1ZTsKICAgIHZhciBTVEFURSA9IGJhc2lzLmRhdGEuU1RBVEU7CiAgICB2YXIgUHJvcGVydHkgPSBWYWx1ZS5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Qcm9wZXJ0eSIsCiAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogZmFsc2UsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKGluaXRWYWx1ZSwgaGFuZGxlciwgcHJveHkpIHsKICAgICAgICB0aGlzLnZhbHVlID0gaW5pdFZhbHVlOwogICAgICAgIHRoaXMuaGFuZGxlciA9IGhhbmRsZXI7CiAgICAgICAgdGhpcy5wcm94eSA9IHByb3h5OwogICAgICAgIFZhbHVlLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIE9CSkVDVFNFVF9TVEFURV9QUklPUklUWSA9IFNUQVRFLnByaW9yaXR5OwogICAgdmFyIE9CSkVDVFNFVF9IQU5ETEVSID0gewogICAgICBzdGF0ZUNoYW5nZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZmlyZShmYWxzZSwgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIHVwZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5maXJlKHRydWUpOwogICAgICB9LAogICAgICBjaGFuZ2U6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZmlyZSh0cnVlKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgdGhpcy5yZW1vdmUob2JqZWN0KTsKICAgICAgfQogICAgfTsKICAgIHZhciBPYmplY3RTZXQgPSBWYWx1ZS5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5PYmplY3RTZXQiLAogICAgICBvYmplY3RzOiBudWxsLAogICAgICB2YWx1ZTogMCwKICAgICAgdmFsdWVDaGFuZ2VkXzogZmFsc2UsCiAgICAgIGNhbGN1bGF0ZVZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy52YWx1ZSArIDE7CiAgICAgIH0sCiAgICAgIGNhbGN1bGF0ZU9uSW5pdDogZmFsc2UsCiAgICAgIHN0YXRlUHJpb3JpdHk6IE9CSkVDVFNFVF9TVEFURV9QUklPUklUWSwKICAgICAgc3RhdGVDaGFuZ2VkXzogdHJ1ZSwKICAgICAgdGltZXJfOiBmYWxzZSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgVmFsdWUucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB2YXIgb2JqZWN0cyA9IHRoaXMub2JqZWN0czsKICAgICAgICB0aGlzLm9iamVjdHMgPSBbXTsKICAgICAgICBpZiAob2JqZWN0cyAmJiBBcnJheS5pc0FycmF5KG9iamVjdHMpKSB7CiAgICAgICAgICB0aGlzLmxvY2soKTsKICAgICAgICAgIHRoaXMuYWRkLmFwcGx5KHRoaXMsIG9iamVjdHMpOwogICAgICAgICAgdGhpcy51bmxvY2soKTsKICAgICAgICB9CiAgICAgICAgdGhpcy52YWx1ZUNoYW5nZWRfID0gdGhpcy5zdGF0ZUNoYW5nZWRfID0gISF0aGlzLmNhbGN1bGF0ZU9uSW5pdDsKICAgICAgICB0aGlzLnVwZGF0ZSgpOwogICAgICB9LAogICAgICBhZGQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIHZhciBvYmplY3QgPSBhcmd1bWVudHNbaV07CiAgICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgQWJzdHJhY3REYXRhKSB7CiAgICAgICAgICAgIGlmIChiYXNpcy5hcnJheS5hZGQodGhpcy5vYmplY3RzLCBvYmplY3QpKSBvYmplY3QuYWRkSGFuZGxlcihPQkpFQ1RTRVRfSEFORExFUiwgdGhpcyk7CiAgICAgICAgICB9IGVsc2UgdGhyb3cgdGhpcy5jb25zdHJ1Y3Rvci5jbGFzc05hbWUgKyAiI2FkZDogSW5zdGFuY2Ugb2YgQWJzdHJhY3REYXRhIHJlcXVpcmVkIjsKICAgICAgICB9CiAgICAgICAgdGhpcy5maXJlKHRydWUsIHRydWUpOwogICAgICB9LAogICAgICByZW1vdmU6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIGlmIChiYXNpcy5hcnJheS5yZW1vdmUodGhpcy5vYmplY3RzLCBvYmplY3QpKSBvYmplY3QucmVtb3ZlSGFuZGxlcihPQkpFQ1RTRVRfSEFORExFUiwgdGhpcyk7CiAgICAgICAgdGhpcy5maXJlKHRydWUsIHRydWUpOwogICAgICB9LAogICAgICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIG9iamVjdDsgb2JqZWN0ID0gdGhpcy5vYmplY3RzW2ldOyBpKyspIG9iamVjdC5yZW1vdmVIYW5kbGVyKE9CSkVDVFNFVF9IQU5ETEVSLCB0aGlzKTsKICAgICAgICB0aGlzLm9iamVjdHMubGVuZ3RoID0gMDsKICAgICAgICB0aGlzLmZpcmUodHJ1ZSwgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIGZpcmU6IGZ1bmN0aW9uKHZhbHVlQ2hhbmdlZCwgc3RhdGVDaGFuZ2VkKSB7CiAgICAgICAgaWYgKCF0aGlzLmxvY2tlZCkgewogICAgICAgICAgdGhpcy52YWx1ZUNoYW5nZWRfID0gdGhpcy52YWx1ZUNoYW5nZWRfIHx8ICEhdmFsdWVDaGFuZ2VkOwogICAgICAgICAgdGhpcy5zdGF0ZUNoYW5nZWRfID0gdGhpcy5zdGF0ZUNoYW5nZWRfIHx8ICEhc3RhdGVDaGFuZ2VkOwogICAgICAgICAgaWYgKCF0aGlzLnRpbWVyXyAmJiAodGhpcy52YWx1ZUNoYW5nZWRfIHx8IHRoaXMuc3RhdGVDaGFuZ2VkXykpIHRoaXMudGltZXJfID0gYmFzaXMuc2V0SW1tZWRpYXRlKHRoaXMudXBkYXRlLmJpbmQodGhpcykpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgbG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5sb2NrZWQgPSB0cnVlOwogICAgICB9LAogICAgICB1bmxvY2s6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubG9ja2VkID0gZmFsc2U7CiAgICAgIH0sCiAgICAgIHVwZGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHZhbHVlQ2hhbmdlZCA9IHRoaXMudmFsdWVDaGFuZ2VkXzsKICAgICAgICB2YXIgc3RhdGVDaGFuZ2VkID0gdGhpcy5zdGF0ZUNoYW5nZWRfOwogICAgICAgIHRoaXMudmFsdWVDaGFuZ2VkXyA9IGZhbHNlOwogICAgICAgIHRoaXMuc3RhdGVDaGFuZ2VkXyA9IGZhbHNlOwogICAgICAgIHRoaXMudGltZXJfID0gYmFzaXMuY2xlYXJJbW1lZGlhdGUodGhpcy50aW1lcl8pOwogICAgICAgIGlmICghY2xlYW5lci5nbG9iYWxEZXN0cm95KSB7CiAgICAgICAgICBpZiAodmFsdWVDaGFuZ2VkKSB0aGlzLnNldCh0aGlzLmNhbGN1bGF0ZVZhbHVlKCkpOwogICAgICAgICAgaWYgKHN0YXRlQ2hhbmdlZCkgewogICAgICAgICAgICB2YXIgbGVuID0gdGhpcy5vYmplY3RzLmxlbmd0aDsKICAgICAgICAgICAgaWYgKCFsZW4pIHRoaXMuc2V0U3RhdGUoU1RBVEUuVU5ERUZJTkVEKTsgZWxzZSB7CiAgICAgICAgICAgICAgdmFyIG1heFdlaWdodCA9IC0yOwogICAgICAgICAgICAgIHZhciBjdXJPYmplY3Q7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgdmFyIG9iamVjdCA9IHRoaXMub2JqZWN0c1tpXTsKICAgICAgICAgICAgICAgIHZhciB3ZWlnaHQgPSB0aGlzLnN0YXRlUHJpb3JpdHkuaW5kZXhPZihTdHJpbmcob2JqZWN0LnN0YXRlKSk7CiAgICAgICAgICAgICAgICBpZiAod2VpZ2h0ID4gbWF4V2VpZ2h0KSB7CiAgICAgICAgICAgICAgICAgIGN1ck9iamVjdCA9IG9iamVjdDsKICAgICAgICAgICAgICAgICAgbWF4V2VpZ2h0ID0gd2VpZ2h0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY3VyT2JqZWN0KSB0aGlzLnNldFN0YXRlKGN1ck9iamVjdC5zdGF0ZSwgY3VyT2JqZWN0LnN0YXRlLmRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmxvY2soKTsKICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgaWYgKHRoaXMudGltZXJfKSBiYXNpcy5jbGVhckltbWVkaWF0ZSh0aGlzLnRpbWVyXyk7CiAgICAgICAgVmFsdWUucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgRXhwcmVzc2lvbiA9IFByb3BlcnR5LnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkV4cHJlc3Npb24iLAogICAgICBpbml0OiBmdW5jdGlvbihhcmdzLCBjYWxjKSB7CiAgICAgICAgVmFsdWUucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB2YXIgYXJncyA9IGJhc2lzLmFycmF5KGFyZ3VtZW50cyk7CiAgICAgICAgdmFyIGNhbGMgPSBhcmdzLnBvcCgpOwogICAgICAgIGlmICh0eXBlb2YgY2FsYyAhPSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBiYXNpcy5kZXYud2Fybih0aGlzLmNvbnN0cnVjdG9yLmNsYXNzTmFtZSArICI6IGxhc3QgYXJndW1lbnQgb2YgY29uc3RydWN0b3IgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgICAgICBjYWxjID0gYmFzaXMuZm4uJHVuZGVmOwogICAgICAgIH0KICAgICAgICBpZiAoYXJncy5sZW5ndGggPT0gMSkgewogICAgICAgICAgYXJnc1swXS5saW5rKHRoaXMsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuc2V0KGNhbGMuY2FsbCh0aGlzLCB2YWx1ZSkpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChhcmdzLmxlbmd0aCA+IDEpIHsKICAgICAgICAgIHZhciBjaGFuZ2VXYXRjaGVyID0gbmV3IE9iamVjdFNldCh7CiAgICAgICAgICAgIG9iamVjdHM6IGFyZ3MsCiAgICAgICAgICAgIGNhbGN1bGF0ZU9uSW5pdDogdHJ1ZSwKICAgICAgICAgICAgY2FsY3VsYXRlVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBjYWxjLmFwcGx5KHRoaXMsIGFyZ3MubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICAgIHJldHVybiBpdGVtLnZhbHVlOwogICAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBjaGFuZ2VXYXRjaGVyLmxpbmsodGhpcywgdGhpcy5zZXQpOwogICAgICAgICAgdGhpcy5hZGRIYW5kbGVyKHsKICAgICAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCFjbGVhbmVyLmdsb2JhbERlc3Ryb3kpIGNoYW5nZVdhdGNoZXIuZGVzdHJveSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFByb3BlcnR5OiBQcm9wZXJ0eSwKICAgICAgT2JqZWN0U2V0OiBPYmplY3RTZXQsCiAgICAgIEV4cHJlc3Npb246IEV4cHJlc3Npb24KICAgIH07CiAgfSwKICAiZi5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2QuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZS5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBDbGFzcyA9IGJhc2lzLkNsYXNzOwogICAgdmFyIERhdGFPYmplY3QgPSBiYXNpcy5kYXRhLk9iamVjdDsKICAgIHZhciBLZXlPYmplY3RNYXAgPSBiYXNpcy5kYXRhLktleU9iamVjdE1hcDsKICAgIHZhciBSZWFkT25seURhdGFzZXQgPSBiYXNpcy5kYXRhLlJlYWRPbmx5RGF0YXNldDsKICAgIHZhciBEYXRhc2V0V3JhcHBlciA9IGJhc2lzLmRhdGEuRGF0YXNldFdyYXBwZXI7CiAgICB2YXIgVmFsdWUgPSBiYXNpcy5kYXRhLlZhbHVlOwogICAgdmFyIE1hcEZpbHRlciA9IGJhc2lzLmRhdGEuZGF0YXNldC5NYXBGaWx0ZXI7CiAgICBmdW5jdGlvbiBiaW5hcnlTZWFyY2hQb3MoYXJyYXksIHZhbHVlKSB7CiAgICAgIGlmICghYXJyYXkubGVuZ3RoKSByZXR1cm4gMDsKICAgICAgdmFyIHBvczsKICAgICAgdmFyIGNtcFZhbHVlOwogICAgICB2YXIgbCA9IDA7CiAgICAgIHZhciByID0gYXJyYXkubGVuZ3RoIC0gMTsKICAgICAgZG8gewogICAgICAgIHBvcyA9IGwgKyByID4+IDE7CiAgICAgICAgY21wVmFsdWUgPSBhcnJheVtwb3NdIHx8IDA7CiAgICAgICAgaWYgKHZhbHVlIDwgY21wVmFsdWUpIHIgPSBwb3MgLSAxOyBlbHNlIGlmICh2YWx1ZSA+IGNtcFZhbHVlKSBsID0gcG9zICsgMTsgZWxzZSByZXR1cm4gdmFsdWUgPT0gY21wVmFsdWUgPyBwb3MgOiAwOwogICAgICB9IHdoaWxlIChsIDw9IHIpOwogICAgICByZXR1cm4gcG9zICsgKGNtcFZhbHVlIDwgdmFsdWUpOwogICAgfQogICAgdmFyIEluZGV4ID0gQ2xhc3MoVmFsdWUsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkluZGV4IiwKICAgICAgYXV0b0Rlc3Ryb3k6IHRydWUsCiAgICAgIGluZGV4Q2FjaGVfOiBudWxsLAogICAgICB2YWx1ZUdldHRlcjogYmFzaXMuZm4uJG51bGwsCiAgICAgIHVwZGF0ZUV2ZW50czoge30sCiAgICAgIHZhbHVlOiAwLAogICAgICBzZXROdWxsT25FbWl0dGVyRGVzdHJveTogZmFsc2UsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaW5kZXhDYWNoZV8gPSB7fTsKICAgICAgICBWYWx1ZS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9LAogICAgICBhZGRfOiBmdW5jdGlvbih2YWx1ZSkge30sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7fSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7fSwKICAgICAgbm9ybWFsaXplOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiBOdW1iZXIodmFsdWUpIHx8IDA7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIFZhbHVlLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5pbmRleENhY2hlXyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFN1bSA9IENsYXNzKEluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5TdW0iLAogICAgICBhZGRfOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgKz0gdmFsdWU7CiAgICAgIH0sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy52YWx1ZSAtPSB2YWx1ZTsKICAgICAgfSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXQodGhpcy52YWx1ZSAtIG9sZFZhbHVlICsgbmV3VmFsdWUpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBDb3VudCA9IENsYXNzKEluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5Db3VudCIsCiAgICAgIHZhbHVlR2V0dGVyOiBiYXNpcy5mbi4kdHJ1ZSwKICAgICAgYWRkXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnZhbHVlICs9IHZhbHVlOwogICAgICB9LAogICAgICByZW1vdmVfOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgLT0gdmFsdWU7CiAgICAgIH0sCiAgICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXR1cm4gISF2YWx1ZTsKICAgICAgfSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXQodGhpcy52YWx1ZSAtICEhb2xkVmFsdWUgKyAhIW5ld1ZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgQXZnID0gQ2xhc3MoSW5kZXgsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkF2ZyIsCiAgICAgIHN1bV86IDAsCiAgICAgIGNvdW50XzogMCwKICAgICAgYWRkXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnN1bV8gKz0gdmFsdWU7CiAgICAgICAgdGhpcy5jb3VudF8gKz0gMTsKICAgICAgICB0aGlzLnZhbHVlID0gdGhpcy5zdW1fIC8gdGhpcy5jb3VudF87CiAgICAgIH0sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5zdW1fIC09IHZhbHVlOwogICAgICAgIHRoaXMuY291bnRfIC09IDE7CiAgICAgICAgdGhpcy52YWx1ZSA9IHRoaXMuY291bnRfID8gdGhpcy5zdW1fIC8gdGhpcy5jb3VudF8gOiAwOwogICAgICB9LAogICAgICB1cGRhdGVfOiBmdW5jdGlvbihuZXdWYWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICB0aGlzLnN1bV8gKz0gbmV3VmFsdWUgLSBvbGRWYWx1ZTsKICAgICAgICB0aGlzLnNldCh0aGlzLnN1bV8gLyB0aGlzLmNvdW50Xyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFZlY3RvckluZGV4ID0gQ2xhc3MoSW5kZXgsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlZlY3RvckluZGV4IiwKICAgICAgdmVjdG9yR2V0dGVyOiBiYXNpcy5mbi4kbnVsbCwKICAgICAgdmVjdG9yXzogbnVsbCwKICAgICAgdmFsdWU6IHVuZGVmaW5lZCwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy52ZWN0b3JfID0gW107CiAgICAgICAgSW5kZXgucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgfSwKICAgICAgYWRkXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgIHRoaXMudmVjdG9yXy5zcGxpY2UoYmluYXJ5U2VhcmNoUG9zKHRoaXMudmVjdG9yXywgdmFsdWUpLCAwLCB2YWx1ZSk7CiAgICAgICAgICB0aGlzLnZhbHVlID0gdGhpcy52ZWN0b3JHZXR0ZXIodGhpcy52ZWN0b3JfKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlbW92ZV86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICB0aGlzLnZlY3Rvcl8uc3BsaWNlKGJpbmFyeVNlYXJjaFBvcyh0aGlzLnZlY3Rvcl8sIHZhbHVlKSwgMSk7CiAgICAgICAgICB0aGlzLnZhbHVlID0gdGhpcy52ZWN0b3JHZXR0ZXIodGhpcy52ZWN0b3JfKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHVwZGF0ZV86IGZ1bmN0aW9uKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgIGlmIChvbGRWYWx1ZSAhPT0gbnVsbCkgdGhpcy52ZWN0b3JfLnNwbGljZShiaW5hcnlTZWFyY2hQb3ModGhpcy52ZWN0b3JfLCBvbGRWYWx1ZSksIDEpOwogICAgICAgIGlmIChuZXdWYWx1ZSAhPT0gbnVsbCkgdGhpcy52ZWN0b3JfLnNwbGljZShiaW5hcnlTZWFyY2hQb3ModGhpcy52ZWN0b3JfLCBuZXdWYWx1ZSksIDAsIG5ld1ZhbHVlKTsKICAgICAgICB0aGlzLnNldCh0aGlzLnZlY3RvckdldHRlcih0aGlzLnZlY3Rvcl8pKTsKICAgICAgfSwKICAgICAgbm9ybWFsaXplOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIgfHwgdHlwZW9mIHZhbHVlID09ICJudW1iZXIiID8gdmFsdWUgOiBudWxsOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBJbmRleC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMudmVjdG9yXyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIE1pbiA9IENsYXNzKFZlY3RvckluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5NaW4iLAogICAgICB2ZWN0b3JHZXR0ZXI6IGZ1bmN0aW9uKHZlY3RvcikgewogICAgICAgIHJldHVybiB2ZWN0b3JbMF07CiAgICAgIH0KICAgIH0pOwogICAgdmFyIE1heCA9IENsYXNzKFZlY3RvckluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5NYXgiLAogICAgICB2ZWN0b3JHZXR0ZXI6IGZ1bmN0aW9uKHZlY3RvcikgewogICAgICAgIHJldHVybiB2ZWN0b3JbdmVjdG9yLmxlbmd0aCAtIDFdOwogICAgICB9CiAgICB9KTsKICAgIHZhciBEaXN0aW5jdCA9IENsYXNzKEluZGV4LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5EaXN0aW5jdCIsCiAgICAgIG1hcF86IG51bGwsCiAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMubWFwXyA9IHt9OwogICAgICAgIEluZGV4LnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgIH0sCiAgICAgIGFkZF86IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgaWYgKCF0aGlzLm1hcF8uaGFzT3duUHJvcGVydHkodmFsdWUpKSB0aGlzLm1hcF9bdmFsdWVdID0gMDsKICAgICAgICBpZiAoKyt0aGlzLm1hcF9bdmFsdWVdID09IDEpIHRoaXMudmFsdWUgKz0gMTsKICAgICAgfSwKICAgICAgcmVtb3ZlXzogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICBpZiAoLS10aGlzLm1hcF9bdmFsdWVdID09IDApIHRoaXMudmFsdWUgLT0gMTsKICAgICAgfSwKICAgICAgdXBkYXRlXzogZnVuY3Rpb24obmV3VmFsdWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdmFyIGRlbHRhID0gMDsKICAgICAgICBpZiAoIXRoaXMubWFwXy5oYXNPd25Qcm9wZXJ0eShuZXdWYWx1ZSkpIHRoaXMubWFwX1tuZXdWYWx1ZV0gPSAwOwogICAgICAgIGlmICgrK3RoaXMubWFwX1tuZXdWYWx1ZV0gPT0gMSkgZGVsdGEgKz0gMTsKICAgICAgICBpZiAoLS10aGlzLm1hcF9bb2xkVmFsdWVdID09IDApIGRlbHRhIC09IDE7CiAgICAgICAgaWYgKGRlbHRhKSB0aGlzLnNldCh0aGlzLnZhbHVlICsgZGVsdGEpOwogICAgICB9LAogICAgICBub3JtYWxpemU6IFN0cmluZywKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgSW5kZXgucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLm1hcF8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHZhciBpbmRleENvbnN0cnVjdG9yc18gPSB7fTsKICAgIHZhciBEQVRBU0VUX0lOREVYX0hBTkRMRVIgPSB7CiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHJlbW92ZURhdGFzZXRJbmRleCh0aGlzLCBvYmplY3QpOwogICAgICB9CiAgICB9OwogICAgZnVuY3Rpb24gSW5kZXhDb25zdHJ1Y3RvcigpIHt9CiAgICBmdW5jdGlvbiBnZXRJbmRleENvbnN0cnVjdG9yKEJhc2VDbGFzcywgZ2V0dGVyLCBldmVudHMpIHsKICAgICAgaWYgKCFDbGFzcy5pc0NsYXNzKEJhc2VDbGFzcykgfHwgIUJhc2VDbGFzcy5pc1N1YmNsYXNzT2YoSW5kZXgpKSB0aHJvdyAiV3JvbmcgY2xhc3MgZm9yIGluZGV4IGNvbnN0cnVjdG9yIjsKICAgICAgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyKGdldHRlcik7CiAgICAgIGV2ZW50cyA9IGV2ZW50cyB8fCAidXBkYXRlIjsKICAgICAgaWYgKHR5cGVvZiBldmVudHMgIT0gInN0cmluZyIpIHRocm93ICJFdmVudHMgbXVzdCBiZSBhIGV2ZW50IG5hbWVzIHNwYWNlIHNlcGFyYXRlZCBzdHJpbmciOwogICAgICBldmVudHMgPSBldmVudHMudHJpbSgpLnNwbGl0KCIgIikuc29ydCgpOwogICAgICB2YXIgaW5kZXhJZCA9IFsgQmFzZUNsYXNzLmJhc2lzQ2xhc3NJZF8sIGdldHRlcltiYXNpcy5nZXR0ZXIuSURdLCBldmVudHMgXS5qb2luKCJfIik7CiAgICAgIHZhciBpbmRleENvbnN0cnVjdG9yID0gaW5kZXhDb25zdHJ1Y3RvcnNfW2luZGV4SWRdOwogICAgICBpZiAoaW5kZXhDb25zdHJ1Y3RvcikgcmV0dXJuIGluZGV4Q29uc3RydWN0b3Iub3duZXI7CiAgICAgIHZhciBldmVudHNfID0ge307CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgaSsrKSBldmVudHNfW2V2ZW50c1tpXV0gPSB0cnVlOwogICAgICBpbmRleENvbnN0cnVjdG9yID0gbmV3IEluZGV4Q29uc3RydWN0b3I7CiAgICAgIGluZGV4Q29uc3RydWN0b3JzX1tpbmRleElkXSA9IHsKICAgICAgICBvd25lcjogaW5kZXhDb25zdHJ1Y3RvciwKICAgICAgICBpbmRleENsYXNzOiBCYXNlQ2xhc3Muc3ViY2xhc3MoewogICAgICAgICAgaW5kZXhJZDogaW5kZXhJZCwKICAgICAgICAgIHVwZGF0ZUV2ZW50czogZXZlbnRzXywKICAgICAgICAgIHZhbHVlR2V0dGVyOiBnZXR0ZXIKICAgICAgICB9KQogICAgICB9OwogICAgICBpbmRleENvbnN0cnVjdG9yLmluZGV4SWQgPSBpbmRleElkOwogICAgICByZXR1cm4gaW5kZXhDb25zdHJ1Y3RvcjsKICAgIH0KICAgIHZhciBjcmVhdGVJbmRleENvbnN0cnVjdG9yID0gZnVuY3Rpb24oSW5kZXhDbGFzcywgZGVmR2V0dGVyKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihldmVudHMsIGdldHRlcikgewogICAgICAgIHZhciBkYXRhc2V0OwogICAgICAgIGlmIChldmVudHMgaW5zdGFuY2VvZiBSZWFkT25seURhdGFzZXQgfHwgZXZlbnRzIGluc3RhbmNlb2YgRGF0YXNldFdyYXBwZXIpIHsKICAgICAgICAgIGRhdGFzZXQgPSBldmVudHM7CiAgICAgICAgICBldmVudHMgPSBnZXR0ZXI7CiAgICAgICAgICBnZXR0ZXIgPSBhcmd1bWVudHNbMl07CiAgICAgICAgfQogICAgICAgIGlmICghZ2V0dGVyKSB7CiAgICAgICAgICBnZXR0ZXIgPSBldmVudHM7CiAgICAgICAgICBldmVudHMgPSAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIGluZGV4Q29uc3RydWN0b3IgPSBnZXRJbmRleENvbnN0cnVjdG9yKEluZGV4Q2xhc3MsIGdldHRlciB8fCBkZWZHZXR0ZXIsIGV2ZW50cyk7CiAgICAgICAgaWYgKGRhdGFzZXQpIHJldHVybiBnZXREYXRhc2V0SW5kZXgoZGF0YXNldCwgaW5kZXhDb25zdHJ1Y3Rvcik7IGVsc2UgcmV0dXJuIGluZGV4Q29uc3RydWN0b3I7CiAgICAgIH07CiAgICB9OwogICAgdmFyIGNvdW50ID0gY3JlYXRlSW5kZXhDb25zdHJ1Y3RvcihDb3VudCwgYmFzaXMuZm4uJHRydWUpOwogICAgdmFyIHN1bSA9IGNyZWF0ZUluZGV4Q29uc3RydWN0b3IoU3VtKTsKICAgIHZhciBhdmcgPSBjcmVhdGVJbmRleENvbnN0cnVjdG9yKEF2Zyk7CiAgICB2YXIgbWluID0gY3JlYXRlSW5kZXhDb25zdHJ1Y3RvcihNaW4pOwogICAgdmFyIG1heCA9IGNyZWF0ZUluZGV4Q29uc3RydWN0b3IoTWF4KTsKICAgIHZhciBkaXN0aW5jdCA9IGNyZWF0ZUluZGV4Q29uc3RydWN0b3IoRGlzdGluY3QpOwogICAgZnVuY3Rpb24gYXBwbHlJbmRleERlbHRhKGluZGV4LCBpbnNlcnRlZCwgZGVsZXRlZCkgewogICAgICB2YXIgaW5kZXhDYWNoZSA9IGluZGV4LmluZGV4Q2FjaGVfOwogICAgICB2YXIgb2JqZWN0SWQ7CiAgICAgIGluZGV4LmxvY2soKTsKICAgICAgaWYgKGluc2VydGVkKSBmb3IgKHZhciBpID0gMCwgb2JqZWN0OyBvYmplY3QgPSBpbnNlcnRlZFtpKytdOyApIHsKICAgICAgICB2YXIgbmV3VmFsdWUgPSBpbmRleC5ub3JtYWxpemUoaW5kZXgudmFsdWVHZXR0ZXIob2JqZWN0KSk7CiAgICAgICAgaW5kZXhDYWNoZVtvYmplY3QuYmFzaXNPYmplY3RJZF0gPSBuZXdWYWx1ZTsKICAgICAgICBpbmRleC5hZGRfKG5ld1ZhbHVlKTsKICAgICAgfQogICAgICBpZiAoZGVsZXRlZCkgZm9yICh2YXIgaSA9IDAsIG9iamVjdDsgb2JqZWN0ID0gZGVsZXRlZFtpKytdOyApIHsKICAgICAgICBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgIGluZGV4LnJlbW92ZV8oaW5kZXhDYWNoZVtvYmplY3RJZF0pOwogICAgICAgIGRlbGV0ZSBpbmRleENhY2hlW29iamVjdElkXTsKICAgICAgfQogICAgICBpbmRleC51bmxvY2soKTsKICAgIH0KICAgIHZhciBJVEVNX0lOREVYX0hBTkRMRVIgPSB7CiAgICAgICIqIjogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICB2YXIgb2xkVmFsdWU7CiAgICAgICAgdmFyIG5ld1ZhbHVlOwogICAgICAgIHZhciBpbmRleDsKICAgICAgICB2YXIgZXZlbnRUeXBlID0gZXZlbnQudHlwZTsKICAgICAgICB2YXIgb2JqZWN0ID0gZXZlbnQuc2VuZGVyOwogICAgICAgIHZhciBvYmplY3RJZCA9IG9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgIHZhciBpbmRleGVzID0gZGF0YXNldEluZGV4ZXNbdGhpcy5iYXNpc09iamVjdElkXTsKICAgICAgICBmb3IgKHZhciBpbmRleElkIGluIGluZGV4ZXMpIHsKICAgICAgICAgIGluZGV4ID0gaW5kZXhlc1tpbmRleElkXTsKICAgICAgICAgIGlmIChpbmRleC51cGRhdGVFdmVudHNbZXZlbnRUeXBlXSkgewogICAgICAgICAgICBvbGRWYWx1ZSA9IGluZGV4LmluZGV4Q2FjaGVfW29iamVjdElkXTsKICAgICAgICAgICAgbmV3VmFsdWUgPSBpbmRleC5ub3JtYWxpemUoaW5kZXgudmFsdWVHZXR0ZXIob2JqZWN0KSk7CiAgICAgICAgICAgIGlmIChuZXdWYWx1ZSAhPT0gb2xkVmFsdWUpIHsKICAgICAgICAgICAgICBpbmRleC51cGRhdGVfKG5ld1ZhbHVlLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgaW5kZXguaW5kZXhDYWNoZV9bb2JqZWN0SWRdID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB2YXIgREFUQVNFVF9XSVRIX0lOREVYX0hBTkRMRVIgPSB7CiAgICAgIGl0ZW1zQ2hhbmdlZDogZnVuY3Rpb24ob2JqZWN0LCBkZWx0YSkgewogICAgICAgIHZhciBhcnJheTsKICAgICAgICBpZiAoYXJyYXkgPSBkZWx0YS5pbnNlcnRlZCkgZm9yICh2YXIgaSA9IGFycmF5Lmxlbmd0aDsgaS0tID4gMDsgKSBhcnJheVtpXS5hZGRIYW5kbGVyKElURU1fSU5ERVhfSEFORExFUiwgdGhpcyk7CiAgICAgICAgaWYgKGFycmF5ID0gZGVsdGEuZGVsZXRlZCkgZm9yICh2YXIgaSA9IGFycmF5Lmxlbmd0aDsgaS0tID4gMDsgKSBhcnJheVtpXS5yZW1vdmVIYW5kbGVyKElURU1fSU5ERVhfSEFORExFUiwgdGhpcyk7CiAgICAgICAgdmFyIGluZGV4ZXMgPSBkYXRhc2V0SW5kZXhlc1t0aGlzLmJhc2lzT2JqZWN0SWRdOwogICAgICAgIGZvciAodmFyIGluZGV4SWQgaW4gaW5kZXhlcykgYXBwbHlJbmRleERlbHRhKGluZGV4ZXNbaW5kZXhJZF0sIGRlbHRhLmluc2VydGVkLCBkZWx0YS5kZWxldGVkKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGluZGV4ZXMgPSBkYXRhc2V0SW5kZXhlc1t0aGlzLmJhc2lzT2JqZWN0SWRdOwogICAgICAgIGZvciAodmFyIGluZGV4SWQgaW4gaW5kZXhlcykgcmVtb3ZlRGF0YXNldEluZGV4KHRoaXMsIGluZGV4ZXNbaW5kZXhJZF0pOwogICAgICB9CiAgICB9OwogICAgdmFyIGRhdGFzZXRJbmRleGVzID0ge307CiAgICBmdW5jdGlvbiBnZXREYXRhc2V0SW5kZXgoZGF0YXNldCwgaW5kZXhDb25zdHJ1Y3RvcikgewogICAgICBpZiAoaW5kZXhDb25zdHJ1Y3RvciBpbnN0YW5jZW9mIEluZGV4Q29uc3RydWN0b3IgPT0gZmFsc2UpIHRocm93ICJpbmRleENvbnN0cnVjdG9yIG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgSW5kZXhDb25zdHJ1Y3RvciI7CiAgICAgIHZhciBkYXRhc2V0SWQgPSBkYXRhc2V0LmJhc2lzT2JqZWN0SWQ7CiAgICAgIHZhciBpbmRleGVzID0gZGF0YXNldEluZGV4ZXNbZGF0YXNldElkXTsKICAgICAgaWYgKCFpbmRleGVzKSB7CiAgICAgICAgaW5kZXhlcyA9IGRhdGFzZXRJbmRleGVzW2RhdGFzZXRJZF0gPSB7fTsKICAgICAgICBkYXRhc2V0LmFkZEhhbmRsZXIoREFUQVNFVF9XSVRIX0lOREVYX0hBTkRMRVIpOwogICAgICAgIERBVEFTRVRfV0lUSF9JTkRFWF9IQU5ETEVSLml0ZW1zQ2hhbmdlZC5jYWxsKGRhdGFzZXQsIGRhdGFzZXQsIHsKICAgICAgICAgIGluc2VydGVkOiBkYXRhc2V0LmdldEl0ZW1zKCkKICAgICAgICB9KTsKICAgICAgfQogICAgICB2YXIgaW5kZXhJZCA9IGluZGV4Q29uc3RydWN0b3IuaW5kZXhJZDsKICAgICAgdmFyIGluZGV4ID0gaW5kZXhlc1tpbmRleElkXTsKICAgICAgaWYgKCFpbmRleCkgewogICAgICAgIGluZGV4Q29uc3RydWN0b3IgPSBpbmRleENvbnN0cnVjdG9yc19baW5kZXhJZF07CiAgICAgICAgaWYgKCFpbmRleENvbnN0cnVjdG9yKSB0aHJvdyAiV3JvbmcgaW5kZXggY29uc3RydWN0b3IiOwogICAgICAgIGluZGV4ID0gbmV3IGluZGV4Q29uc3RydWN0b3IuaW5kZXhDbGFzczsKICAgICAgICBpbmRleC5hZGRIYW5kbGVyKERBVEFTRVRfSU5ERVhfSEFORExFUiwgZGF0YXNldCk7CiAgICAgICAgaW5kZXhlc1tpbmRleElkXSA9IGluZGV4OwogICAgICAgIGFwcGx5SW5kZXhEZWx0YShpbmRleCwgZGF0YXNldC5nZXRJdGVtcygpKTsKICAgICAgfQogICAgICByZXR1cm4gaW5kZXg7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVEYXRhc2V0SW5kZXgoZGF0YXNldCwgaW5kZXgpIHsKICAgICAgdmFyIGluZGV4ZXMgPSBkYXRhc2V0SW5kZXhlc1tkYXRhc2V0LmJhc2lzT2JqZWN0SWRdOwogICAgICBpZiAoaW5kZXhlcyAmJiBpbmRleGVzW2luZGV4LmluZGV4SWRdKSB7CiAgICAgICAgZGVsZXRlIGluZGV4ZXNbaW5kZXguaW5kZXhJZF07CiAgICAgICAgaW5kZXgucmVtb3ZlSGFuZGxlcihEQVRBU0VUX0lOREVYX0hBTkRMRVIsIGRhdGFzZXQpOwogICAgICAgIGZvciAodmFyIGtleSBpbiBpbmRleGVzKSByZXR1cm47CiAgICAgICAgZGF0YXNldC5yZW1vdmVIYW5kbGVyKERBVEFTRVRfV0lUSF9JTkRFWF9IQU5ETEVSKTsKICAgICAgICBEQVRBU0VUX1dJVEhfSU5ERVhfSEFORExFUi5pdGVtc0NoYW5nZWQuY2FsbChkYXRhc2V0LCBkYXRhc2V0LCB7CiAgICAgICAgICBkZWxldGVkOiBkYXRhc2V0LmdldEl0ZW1zKCkKICAgICAgICB9KTsKICAgICAgICBkZWxldGUgZGF0YXNldEluZGV4ZXNbZGF0YXNldC5iYXNpc09iamVjdElkXTsKICAgICAgfQogICAgfQogICAgdmFyIENhbGNJbmRleFByZXNldCA9IENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkNhbGNJbmRleFByZXNldCIsCiAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogdHJ1ZSwKICAgICAgaW5kZXhlczoge30sCiAgICAgIGNhbGM6IGJhc2lzLmZuLiRudWxsCiAgICB9KTsKICAgIHZhciBjYWxjSW5kZXhQcmVzZXRTZWVkID0gMTsKICAgIGZ1bmN0aW9uIGdldFVuaXF1ZUNhbGNJbmRleElkKCkgewogICAgICByZXR1cm4gImNhbGMtaW5kZXgtcHJlc2V0LSIgKyBiYXNpcy5udW1iZXIubGVhZChjYWxjSW5kZXhQcmVzZXRTZWVkKyssIDgpOwogICAgfQogICAgZnVuY3Rpb24gcGVyY2VudE9mUmFuZ2UoZXZlbnRzLCBnZXR0ZXIpIHsKICAgICAgdmFyIG1pbkluZGV4ID0gIm1pbl8iICsgZ2V0VW5pcXVlQ2FsY0luZGV4SWQoKTsKICAgICAgdmFyIG1heEluZGV4ID0gIm1heF8iICsgZ2V0VW5pcXVlQ2FsY0luZGV4SWQoKTsKICAgICAgdmFyIGluZGV4ZXMgPSB7fTsKICAgICAgaW5kZXhlc1ttaW5JbmRleF0gPSBtaW4oZXZlbnRzLCBnZXR0ZXIpOwogICAgICBpbmRleGVzW21heEluZGV4XSA9IG1heChldmVudHMsIGdldHRlcik7CiAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIgfHwgZXZlbnRzKTsKICAgICAgdmFyIGNhbGMgPSBmdW5jdGlvbihkYXRhLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIChnZXR0ZXIob2JqZWN0KSAtIGluZGV4W21pbkluZGV4XSkgLyAoaW5kZXhbbWF4SW5kZXhdIC0gaW5kZXhbbWluSW5kZXhdKTsKICAgICAgfTsKICAgICAgcmV0dXJuIGNhbGMucHJlc2V0ID0gbmV3IENhbGNJbmRleFByZXNldCh7CiAgICAgICAgaW5kZXhlczogaW5kZXhlcywKICAgICAgICBjYWxjOiBjYWxjCiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gcGVyY2VudE9mTWF4KGV2ZW50cywgZ2V0dGVyKSB7CiAgICAgIHZhciBtYXhJbmRleCA9ICJtYXhfIiArIGdldFVuaXF1ZUNhbGNJbmRleElkKCk7CiAgICAgIHZhciBpbmRleGVzID0ge307CiAgICAgIGluZGV4ZXNbbWF4SW5kZXhdID0gbWF4KGV2ZW50cywgZ2V0dGVyKTsKICAgICAgZ2V0dGVyID0gYmFzaXMuZ2V0dGVyKGdldHRlciB8fCBldmVudHMpOwogICAgICB2YXIgY2FsYyA9IGZ1bmN0aW9uKGRhdGEsIGluZGV4LCBvYmplY3QpIHsKICAgICAgICByZXR1cm4gZ2V0dGVyKG9iamVjdCkgLyBpbmRleFttYXhJbmRleF07CiAgICAgIH07CiAgICAgIHJldHVybiBjYWxjLnByZXNldCA9IG5ldyBDYWxjSW5kZXhQcmVzZXQoewogICAgICAgIGluZGV4ZXM6IGluZGV4ZXMsCiAgICAgICAgY2FsYzogY2FsYwogICAgICB9KTsKICAgIH0KICAgIGZ1bmN0aW9uIHBlcmNlbnRPZlN1bShnZXR0ZXIsIGV2ZW50cykgewogICAgICB2YXIgc3VtSW5kZXggPSAic3VtXyIgKyBnZXRVbmlxdWVDYWxjSW5kZXhJZCgpOwogICAgICB2YXIgaW5kZXhlcyA9IHt9OwogICAgICBpbmRleGVzW3N1bUluZGV4XSA9IHN1bShldmVudHMsIGdldHRlcik7CiAgICAgIGdldHRlciA9IGJhc2lzLmdldHRlcihnZXR0ZXIgfHwgZXZlbnRzKTsKICAgICAgdmFyIGNhbGMgPSBmdW5jdGlvbihkYXRhLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGdldHRlcihvYmplY3QpIC8gaW5kZXhbc3VtSW5kZXhdOwogICAgICB9OwogICAgICByZXR1cm4gY2FsYy5wcmVzZXQgPSBuZXcgQ2FsY0luZGV4UHJlc2V0KHsKICAgICAgICBpbmRleGVzOiBpbmRleGVzLAogICAgICAgIGNhbGM6IGNhbGMKICAgICAgfSk7CiAgICB9CiAgICB2YXIgSW5kZXhNYXAgPSBDbGFzcyhNYXBGaWx0ZXIsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkluZGV4TWFwIiwKICAgICAgY2FsY3M6IG51bGwsCiAgICAgIGluZGV4ZXM6IG51bGwsCiAgICAgIGluZGV4ZXNfOiBudWxsLAogICAgICBpbmRleGVzQmluZF86IG51bGwsCiAgICAgIHRpbWVyXzogdW5kZWZpbmVkLAogICAgICBpbmRleFVwZGF0ZWQ6IG51bGwsCiAgICAgIGluZGV4VmFsdWVzOiBudWxsLAogICAgICBtZW1iZXJTb3VyY2VNYXA6IG51bGwsCiAgICAgIGtleU1hcDogbnVsbCwKICAgICAgbWFwOiBmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgcmV0dXJuIHRoaXMua2V5TWFwLmdldChpdGVtLCB0cnVlKTsKICAgICAgfSwKICAgICAgYWRkTWVtYmVyUmVmOiBmdW5jdGlvbihtZW1iZXIsIHNvdXJjZU9iamVjdCkgewogICAgICAgIHRoaXMubWVtYmVyU291cmNlTWFwW21lbWJlci5iYXNpc09iamVjdElkXSA9IHNvdXJjZU9iamVjdC5iYXNpc09iamVjdElkOwogICAgICAgIGlmICh0aGlzLmxpc3Rlbi5tZW1iZXIpIG1lbWJlci5hZGRIYW5kbGVyKHRoaXMubGlzdGVuLm1lbWJlciwgdGhpcyk7CiAgICAgICAgdGhpcy5zb3VyY2VNYXBfW3NvdXJjZU9iamVjdC5iYXNpc09iamVjdElkXS51cGRhdGVkID0gdHJ1ZTsKICAgICAgICBpZiAobWVtYmVyLnN1YnNjcmliZXJDb3VudCA+IDApIHRoaXMuY2FsY01lbWJlcihtZW1iZXIpOwogICAgICB9LAogICAgICByZW1vdmVNZW1iZXJSZWY6IGZ1bmN0aW9uKG1lbWJlciwgc291cmNlT2JqZWN0KSB7CiAgICAgICAgZGVsZXRlIHRoaXMubWVtYmVyU291cmNlTWFwW21lbWJlci5iYXNpc09iamVjdElkXTsKICAgICAgICBpZiAodGhpcy5saXN0ZW4ubWVtYmVyKSBtZW1iZXIucmVtb3ZlSGFuZGxlcih0aGlzLmxpc3Rlbi5tZW1iZXIsIHRoaXMpOwogICAgICB9LAogICAgICBlbWl0X3NvdXJjZUNoYW5nZWQ6IGZ1bmN0aW9uKG9sZFNvdXJjZSkgewogICAgICAgIE1hcEZpbHRlci5wcm90b3R5cGUuZW1pdF9zb3VyY2VDaGFuZ2VkLmNhbGwodGhpcywgb2xkU291cmNlKTsKICAgICAgICBmb3IgKHZhciBpbmRleE5hbWUgaW4gdGhpcy5pbmRleGVzXykgewogICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleGVzX1tpbmRleE5hbWVdOwogICAgICAgICAgaWYgKG9sZFNvdXJjZSkgewogICAgICAgICAgICB0aGlzLnJlbW92ZUluZGV4KGluZGV4TmFtZSk7CiAgICAgICAgICAgIHJlbW92ZURhdGFzZXRJbmRleChvbGRTb3VyY2UsIHRoaXMuaW5kZXhlc1tpbmRleE5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLnNvdXJjZSkgdGhpcy5hZGRJbmRleChpbmRleE5hbWUsIGdldERhdGFzZXRJbmRleCh0aGlzLnNvdXJjZSwgaW5kZXgpKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGxpc3RlbjogewogICAgICAgIGluZGV4OiB7CiAgICAgICAgICBjaGFuZ2U6IGZ1bmN0aW9uKHNlbmRlcikgewogICAgICAgICAgICB2YXIgaW5kZXhNYXAgPSB0aGlzLmluZGV4TWFwOwogICAgICAgICAgICBpbmRleE1hcC5pbmRleFZhbHVlc1t0aGlzLmtleV0gPSBzZW5kZXIudmFsdWU7CiAgICAgICAgICAgIGluZGV4TWFwLmluZGV4VXBkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIGluZGV4TWFwLnJlY2FsY1JlcXVlc3QoKTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIG1lbWJlcjogewogICAgICAgICAgc3Vic2NyaWJlcnNDaGFuZ2VkOiBmdW5jdGlvbihvYmplY3QsIGRlbHRhKSB7CiAgICAgICAgICAgIGlmIChvYmplY3Quc3Vic2NyaWJlckNvdW50ID4gMCkgdGhpcy5jYWxjTWVtYmVyKG9iamVjdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBydWxlRXZlbnRzOiBiYXNpcy5kYXRhLmRhdGFzZXQuY3JlYXRlUnVsZUV2ZW50cyhmdW5jdGlvbihzZW5kZXIsIGRlbHRhKSB7CiAgICAgICAgTWFwRmlsdGVyLnByb3RvdHlwZS5ydWxlRXZlbnRzLnVwZGF0ZS5jYWxsKHRoaXMsIHNlbmRlciwgZGVsdGEpOwogICAgICAgIHRoaXMuc291cmNlTWFwX1tzZW5kZXIuYmFzaXNPYmplY3RJZF0udXBkYXRlZCA9IHRydWU7CiAgICAgICAgdGhpcy5yZWNhbGNSZXF1ZXN0KCk7CiAgICAgIH0sICJ1cGRhdGUiKSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZWNhbGMgPSB0aGlzLnJlY2FsYy5iaW5kKHRoaXMpOwogICAgICAgIHRoaXMuaW5kZXhVcGRhdGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5pbmRleGVzQmluZF8gPSB7fTsKICAgICAgICB0aGlzLm1lbWJlclNvdXJjZU1hcCA9IHt9OwogICAgICAgIHZhciBpbmRleGVzID0gdGhpcy5pbmRleGVzOwogICAgICAgIHRoaXMuaW5kZXhlcyA9IHt9OwogICAgICAgIHRoaXMuaW5kZXhlc18gPSB7fTsKICAgICAgICB0aGlzLmluZGV4VmFsdWVzID0ge307CiAgICAgICAgdmFyIGNhbGNzID0gdGhpcy5jYWxjczsKICAgICAgICB0aGlzLmNhbGNzID0ge307CiAgICAgICAgaWYgKCF0aGlzLmtleU1hcCB8fCB0aGlzLmtleU1hcCBpbnN0YW5jZW9mIEtleU9iamVjdE1hcCA9PSBmYWxzZSkgdGhpcy5rZXlNYXAgPSBuZXcgS2V5T2JqZWN0TWFwKGJhc2lzLm9iamVjdC5jb21wbGV0ZSh7CiAgICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uKGtleSwgY29uZmlnKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgdGhpcy5pdGVtQ2xhc3MoY29uZmlnKTsKICAgICAgICAgIH0KICAgICAgICB9LCB0aGlzLmtleU1hcCkpOwogICAgICAgIE1hcEZpbHRlci5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIGJhc2lzLm9iamVjdC5pdGVyYXRlKGluZGV4ZXMsIHRoaXMuYWRkSW5kZXgsIHRoaXMpOwogICAgICAgIGJhc2lzLm9iamVjdC5pdGVyYXRlKGNhbGNzLCB0aGlzLmFkZENhbGMsIHRoaXMpOwogICAgICB9LAogICAgICBhZGRJbmRleDogZnVuY3Rpb24oa2V5LCBpbmRleCkgewogICAgICAgIGlmICghdGhpcy5pbmRleGVzW2tleV0pIHsKICAgICAgICAgIGlmIChpbmRleCBpbnN0YW5jZW9mIEluZGV4Q29uc3RydWN0b3IpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmluZGV4ZXNfW2tleV0pIHsKICAgICAgICAgICAgICB0aGlzLmluZGV4ZXNfW2tleV0gPSBpbmRleDsKICAgICAgICAgICAgICBpbmRleCA9IHRoaXMuc291cmNlID8gZ2V0RGF0YXNldEluZGV4KHRoaXMuc291cmNlLCBpbmRleCkgOiBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJJbmRleCBgIiArIGtleSArICJgIGFscmVhZHkgZXhpc3RzIik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5kZXggaW5zdGFuY2VvZiBJbmRleCkgewogICAgICAgICAgICB0aGlzLmluZGV4VmFsdWVzW2tleV0gPSBpbmRleC52YWx1ZTsKICAgICAgICAgICAgdGhpcy5pbmRleGVzW2tleV0gPSBpbmRleDsKICAgICAgICAgICAgdGhpcy5pbmRleGVzQmluZF9ba2V5XSA9IHsKICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICBpbmRleE1hcDogdGhpcwogICAgICAgICAgICB9OwogICAgICAgICAgICB2YXIgbGlzdGVuSGFuZGxlciA9IHRoaXMubGlzdGVuLmluZGV4OwogICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgewogICAgICAgICAgICAgIGluZGV4LmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcy5pbmRleGVzQmluZF9ba2V5XSk7CiAgICAgICAgICAgICAgaWYgKGxpc3RlbkhhbmRsZXIuY2hhbmdlKSBsaXN0ZW5IYW5kbGVyLmNoYW5nZS5jYWxsKHRoaXMuaW5kZXhlc0JpbmRfW2tleV0sIGluZGV4LCBpbmRleC52YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJJbmRleCBzaG91bGQgYmUgaW5zdGFuY2Ugb2YgYGJhc2lzLmRhdGEuaW5kZXguSW5kZXhgIik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJJbmRleCBgIiArIGtleSArICJgIGFscmVhZHkgZXhpc3RzIik7CiAgICAgICAgfQogICAgICB9LAogICAgICByZW1vdmVJbmRleDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgaWYgKHRoaXMuaW5kZXhlc19ba2V5XSB8fCB0aGlzLmluZGV4ZXNba2V5XSkgewogICAgICAgICAgaWYgKHRoaXMuaW5kZXhlc1trZXldICYmIHRoaXMubGlzdGVuLmluZGV4KSB0aGlzLmluZGV4ZXNba2V5XS5yZW1vdmVIYW5kbGVyKHRoaXMubGlzdGVuLmluZGV4LCB0aGlzLmluZGV4ZXNCaW5kX1trZXldKTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmluZGV4VmFsdWVzW2tleV07CiAgICAgICAgICBkZWxldGUgdGhpcy5pbmRleGVzQmluZF9ba2V5XTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmluZGV4ZXNba2V5XTsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmluZGV4ZXNfW2tleV07CiAgICAgICAgfQogICAgICB9LAogICAgICBhZGRDYWxjOiBmdW5jdGlvbihuYW1lLCBjYWxjQ2ZnKSB7CiAgICAgICAgaWYgKGNhbGNDZmcgaW5zdGFuY2VvZiBDYWxjSW5kZXhQcmVzZXQpIHsKICAgICAgICAgIHRoaXMuY2FsY3NbbmFtZV0gPSBjYWxjQ2ZnLmNhbGM7CiAgICAgICAgICBmb3IgKHZhciBpbmRleE5hbWUgaW4gY2FsY0NmZy5pbmRleGVzKSB0aGlzLmFkZEluZGV4KGluZGV4TmFtZSwgY2FsY0NmZy5pbmRleGVzW2luZGV4TmFtZV0pOwogICAgICAgIH0gZWxzZSB0aGlzLmNhbGNzW25hbWVdID0gY2FsY0NmZzsKICAgICAgICB0aGlzLnJlY2FsY1JlcXVlc3QoKTsKICAgICAgfSwKICAgICAgcmVtb3ZlQ2FsYzogZnVuY3Rpb24obmFtZSkgewogICAgICAgIHZhciBjYWxjQ2ZnID0gdGhpcy5jYWxjc1tuYW1lXTsKICAgICAgICBpZiAoY2FsY0NmZyAmJiBjYWxjQ2ZnLnByZXNldCBpbnN0YW5jZW9mIENhbGNJbmRleFByZXNldCkgewogICAgICAgICAgdmFyIGluZGV4ZXMgPSBjYWxjQ2ZnLnByZXNldC5pbmRleGVzOwogICAgICAgICAgZm9yICh2YXIgaW5kZXhOYW1lIGluIGluZGV4ZXMpIHRoaXMucmVtb3ZlSW5kZXgoaW5kZXhOYW1lLCBpbmRleGVzW2luZGV4TmFtZV0pOwogICAgICAgIH0KICAgICAgICBkZWxldGUgdGhpcy5jYWxjc1tuYW1lXTsKICAgICAgfSwKICAgICAgbG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaW5kZXhJZCBpbiB0aGlzLmluZGV4ZXMpIHRoaXMuaW5kZXhlc1tpbmRleElkXS5sb2NrKCk7CiAgICAgIH0sCiAgICAgIHVubG9jazogZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaW5kZXhJZCBpbiB0aGlzLmluZGV4ZXMpIHRoaXMuaW5kZXhlc1tpbmRleElkXS51bmxvY2soKTsKICAgICAgfSwKICAgICAgcmVjYWxjUmVxdWVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLnRpbWVyXykgdGhpcy50aW1lcl8gPSBiYXNpcy5zZXRJbW1lZGlhdGUodGhpcy5yZWNhbGMpOwogICAgICB9LAogICAgICByZWNhbGM6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGlkeCBpbiB0aGlzLml0ZW1zXykgdGhpcy5jYWxjTWVtYmVyKHRoaXMuaXRlbXNfW2lkeF0pOwogICAgICAgIHRoaXMuaW5kZXhVcGRhdGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy50aW1lcl8gPSBiYXNpcy5jbGVhckltbWVkaWF0ZSh0aGlzLnRpbWVyXyk7CiAgICAgIH0sCiAgICAgIGNhbGNNZW1iZXI6IGZ1bmN0aW9uKG1lbWJlcikgewogICAgICAgIHZhciBzb3VyY2VPYmplY3QgPSB0aGlzLnNvdXJjZU1hcF9bdGhpcy5tZW1iZXJTb3VyY2VNYXBbbWVtYmVyLmJhc2lzT2JqZWN0SWRdXTsKICAgICAgICBpZiAobWVtYmVyLnN1YnNjcmliZXJDb3VudCAmJiAoc291cmNlT2JqZWN0LnVwZGF0ZWQgfHwgdGhpcy5pbmRleFVwZGF0ZWQpKSB7CiAgICAgICAgICBzb3VyY2VPYmplY3QudXBkYXRlZCA9IGZhbHNlOwogICAgICAgICAgdmFyIGRhdGEgPSB7fTsKICAgICAgICAgIHZhciBuZXdWYWx1ZTsKICAgICAgICAgIHZhciBvbGRWYWx1ZTsKICAgICAgICAgIHZhciB1cGRhdGU7CiAgICAgICAgICBmb3IgKHZhciBjYWxjTmFtZSBpbiB0aGlzLmNhbGNzKSB7CiAgICAgICAgICAgIG5ld1ZhbHVlID0gdGhpcy5jYWxjc1tjYWxjTmFtZV0oc291cmNlT2JqZWN0LnNvdXJjZU9iamVjdC5kYXRhLCB0aGlzLmluZGV4VmFsdWVzLCBzb3VyY2VPYmplY3Quc291cmNlT2JqZWN0KTsKICAgICAgICAgICAgb2xkVmFsdWUgPSBtZW1iZXIuZGF0YVtjYWxjTmFtZV07CiAgICAgICAgICAgIGlmIChtZW1iZXIuZGF0YVtjYWxjTmFtZV0gIT09IG5ld1ZhbHVlICYmICh0eXBlb2YgbmV3VmFsdWUgIT0gIm51bWJlciIgfHwgdHlwZW9mIG9sZFZhbHVlICE9ICJudW1iZXIiIHx8ICFpc05hTihuZXdWYWx1ZSkgfHwgIWlzTmFOKG9sZFZhbHVlKSkpIHsKICAgICAgICAgICAgICBkYXRhW2NhbGNOYW1lXSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgIHVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh1cGRhdGUpIG1lbWJlci51cGRhdGUoZGF0YSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBnZXRNZW1iZXI6IGZ1bmN0aW9uKHNvdXJjZU9iamVjdCkgewogICAgICAgIHJldHVybiB0aGlzLmtleU1hcC5nZXQoc291cmNlT2JqZWN0LCB0cnVlKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5rZXlNYXAuZGVzdHJveSgpOwogICAgICAgIHRoaXMua2V5TWFwID0gbnVsbDsKICAgICAgICBmb3IgKHZhciBpbmRleE5hbWUgaW4gdGhpcy5pbmRleGVzKSB0aGlzLnJlbW92ZUluZGV4KGluZGV4TmFtZSk7CiAgICAgICAgTWFwRmlsdGVyLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy50aW1lcl8gPSBiYXNpcy5jbGVhckltbWVkaWF0ZSh0aGlzLnRpbWVyXyk7CiAgICAgICAgdGhpcy5jYWxjcyA9IG51bGw7CiAgICAgICAgdGhpcy5pbmRleGVzID0gbnVsbDsKICAgICAgICB0aGlzLmluZGV4ZXNfID0gbnVsbDsKICAgICAgICB0aGlzLmluZGV4VmFsdWVzID0gbnVsbDsKICAgICAgICB0aGlzLm1lbWJlclNvdXJjZU1hcCA9IG51bGw7CiAgICAgICAgdGhpcy5pbmRleGVzQmluZF8gPSBudWxsOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBJbmRleENvbnN0cnVjdG9yOiBJbmRleENvbnN0cnVjdG9yLAogICAgICBjcmVhdGVJbmRleENvbnN0cnVjdG9yOiBjcmVhdGVJbmRleENvbnN0cnVjdG9yLAogICAgICBnZXREYXRhc2V0SW5kZXg6IGdldERhdGFzZXRJbmRleCwKICAgICAgcmVtb3ZlRGF0YXNldEluZGV4OiByZW1vdmVEYXRhc2V0SW5kZXgsCiAgICAgIEluZGV4OiBJbmRleCwKICAgICAgQ291bnQ6IENvdW50LAogICAgICBTdW06IFN1bSwKICAgICAgQXZnOiBBdmcsCiAgICAgIFZlY3RvckluZGV4OiBWZWN0b3JJbmRleCwKICAgICAgTWluOiBNaW4sCiAgICAgIE1heDogTWF4LAogICAgICBEaXN0aW5jdDogRGlzdGluY3QsCiAgICAgIGNvdW50OiBjb3VudCwKICAgICAgc3VtOiBzdW0sCiAgICAgIGF2ZzogYXZnLAogICAgICBtYXg6IG1heCwKICAgICAgbWluOiBtaW4sCiAgICAgIGRpc3RpbmN0OiBkaXN0aW5jdCwKICAgICAgQ2FsY0luZGV4UHJlc2V0OiBDYWxjSW5kZXhQcmVzZXQsCiAgICAgIHBlcmNlbnRPZlJhbmdlOiBwZXJjZW50T2ZSYW5nZSwKICAgICAgcGVyY2VudE9mTWF4OiBwZXJjZW50T2ZNYXgsCiAgICAgIHBlcmNlbnRPZlN1bTogcGVyY2VudE9mU3VtLAogICAgICBJbmRleE1hcDogSW5kZXhNYXAKICAgIH07CiAgfSwKICAiZy5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIERhdGFPYmplY3QgPSBiYXNpcy5kYXRhLk9iamVjdDsKICAgIGZ1bmN0aW9uIGdlbmVyYXRlR2V0RGF0YShuYW1lTWFwKSB7CiAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oImRhdGEiLCAicmV0dXJuIHsiICsgYmFzaXMub2JqZWN0Lml0ZXJhdGUobmFtZU1hcCwgZnVuY3Rpb24ob3duTmFtZSwgc291cmNlTmFtZSkgewogICAgICAgIG93bk5hbWUgPSBvd25OYW1lLnJlcGxhY2UoLyIvZywgJ1xcIicpOwogICAgICAgIHNvdXJjZU5hbWUgPSBzb3VyY2VOYW1lLnJlcGxhY2UoLyIvZywgJ1xcIicpOwogICAgICAgIHJldHVybiAnIicgKyBvd25OYW1lICsgJyI6IGRhdGFbIicgKyBzb3VyY2VOYW1lICsgJyJdJzsKICAgICAgfSkgKyAifSIpOwogICAgfQogICAgdmFyIE1FUkdFX1NPVVJDRV9IQU5ETEVSID0gewogICAgICB1cGRhdGU6IGZ1bmN0aW9uKHNlbmRlciwgc2VuZGVyRGVsdGEpIHsKICAgICAgICB2YXIgZmllbGRzID0gdGhpcy5ob3N0LmZpZWxkczsKICAgICAgICB2YXIgZGF0YSA9IHt9OwogICAgICAgIGlmICh0aGlzLm5hbWUgPT0gZmllbGRzLmRlZmF1bHRTb3VyY2UpIHsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzZW5kZXJEZWx0YSkgaWYgKGtleSBpbiBmaWVsZHMuZmllbGRTb3VyY2UgPT0gZmFsc2UpIGRhdGFba2V5XSA9IHNlbmRlci5kYXRhW2tleV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBzZW5kZXJEZWx0YSkgewogICAgICAgICAgICB2YXIgbWVyZ2VLZXkgPSBmaWVsZHMuZnJvbU5hbWVzW3RoaXMubmFtZV1ba2V5XTsKICAgICAgICAgICAgaWYgKG1lcmdlS2V5ICYmIHRoaXMuaG9zdC5maWVsZHMuZmllbGRTb3VyY2VbbWVyZ2VLZXldID09IHRoaXMubmFtZSkgZGF0YVttZXJnZUtleV0gPSBzZW5kZXIuZGF0YVtrZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgcmV0dXJuIHRoaXMuaG9zdC51cGRhdGUoZGF0YSk7CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaG9zdC5zZXRTb3VyY2UodGhpcy5uYW1lLCBudWxsKTsKICAgICAgfQogICAgfTsKICAgIHZhciBmaWVsZHNFeHRlbmQgPSBmdW5jdGlvbihmaWVsZHMpIHsKICAgICAgdmFyIHNvdXJjZXMgPSB7fTsKICAgICAgdmFyIHRvTmFtZXMgPSB7fTsKICAgICAgdmFyIGZyb21OYW1lcyA9IHt9OwogICAgICB2YXIgcmVzdWx0ID0gewogICAgICAgIGRlZmF1bHRTb3VyY2U6IGZhbHNlLAogICAgICAgIGZpZWxkU291cmNlOiB7fSwKICAgICAgICB0b05hbWVzOiB0b05hbWVzLAogICAgICAgIGZyb21OYW1lczogZnJvbU5hbWVzLAogICAgICAgIHNvdXJjZXM6IHNvdXJjZXMsCiAgICAgICAgX19leHRlbmRfXzogZmllbGRzRXh0ZW5kCiAgICAgIH07CiAgICAgIGlmIChmaWVsZHNbIioiXSkgcmVzdWx0LmRlZmF1bHRTb3VyY2UgPSBmaWVsZHNbIioiXTsKICAgICAgZm9yICh2YXIgZmllbGQgaW4gZmllbGRzKSB7CiAgICAgICAgdmFyIGRlZiA9IGZpZWxkc1tmaWVsZF0uc3BsaXQoIjoiKTsKICAgICAgICB2YXIgc291cmNlTmFtZSA9IGRlZi5zaGlmdCgpOwogICAgICAgIHZhciBzb3VyY2VGaWVsZCA9IGRlZi5sZW5ndGggPyBkZWYuam9pbigiOiIpIDogZmllbGQ7CiAgICAgICAgaWYgKHNvdXJjZU5hbWUgPT0gcmVzdWx0LmRlZmF1bHRTb3VyY2UpIHsKICAgICAgICAgIGlmIChmaWVsZCAhPSAiKiIpIGJhc2lzLmRldi53YXJuKCJiYXNpcy5kYXRhLm9iamVjdC5NZXJnZTogc291cmNlIGAiICsgc291cmNlTmFtZSArICJgIGhhcyBhbHJlYWR5IGRlZmluZWQgZm9yIGFueSBmaWVsZCAoc3RhciBydWxlKSwgZGVmaW5pdGlvbiB0aGlzIHNvdXJjZSBmb3IgYCIgKyBmaWVsZCArICJgIGZpZWxkIGlzIHN1cGVyZmx1b3VzIChpZ25vcmVkKS4iKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBpZiAoc291cmNlTmFtZSA9PSAiLSIgJiYgc291cmNlRmllbGQgIT0gZmllbGQpIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5kYXRhLm9iamVjdC5NZXJnZTogY3VzdG9tIGZpZWxkIG5hbWUgY2FuJ3QgYmUgdXNlZCBmb3Igb3duIHByb3BlcnRpZXMsIGRlZmluaXRpb24gYCIgKyBmaWVsZCArICc6ICInICsgZmllbGRzW2ZpZWxkXSArICciYCBpZ25vcmVkLicpOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmICghdG9OYW1lc1tzb3VyY2VOYW1lXSkgewogICAgICAgICAgdG9OYW1lc1tzb3VyY2VOYW1lXSA9IHt9OwogICAgICAgICAgZnJvbU5hbWVzW3NvdXJjZU5hbWVdID0ge307CiAgICAgICAgfQogICAgICAgIHRvTmFtZXNbc291cmNlTmFtZV1bZmllbGRdID0gc291cmNlRmllbGQ7CiAgICAgICAgZnJvbU5hbWVzW3NvdXJjZU5hbWVdW3NvdXJjZUZpZWxkXSA9IGZpZWxkOwogICAgICAgIHJlc3VsdC5maWVsZFNvdXJjZVtmaWVsZF0gPSBzb3VyY2VOYW1lOwogICAgICB9CiAgICAgIGZvciAodmFyIHNvdXJjZU5hbWUgaW4gdG9OYW1lcykgc291cmNlc1tzb3VyY2VOYW1lXSA9IGdlbmVyYXRlR2V0RGF0YSh0b05hbWVzW3NvdXJjZU5hbWVdKTsKICAgICAgaWYgKHJlc3VsdC5kZWZhdWx0U291cmNlKSBzb3VyY2VzW3Jlc3VsdC5kZWZhdWx0U291cmNlXSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB2YXIgcmVzID0ge307CiAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIGlmIChrZXkgaW4gcmVzdWx0LmZpZWxkU291cmNlID09IGZhbHNlKSByZXNba2V5XSA9IGRhdGFba2V5XTsKICAgICAgICByZXR1cm4gcmVzOwogICAgICB9OwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICAgIHZhciBNZXJnZSA9IERhdGFPYmplY3Quc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuTWVyZ2UiLAogICAgICBlbWl0X3NvdXJjZUNoYW5nZWQ6IGJhc2lzLmV2ZW50LmNyZWF0ZSgic291cmNlQ2hhbmdlZCIsICJuYW1lIiwgIm9sZFNvdXJjZSIpLAogICAgICBmaWVsZHM6IGZpZWxkc0V4dGVuZCh7CiAgICAgICAgIioiOiAiLSIKICAgICAgfSksCiAgICAgIHNvdXJjZXM6IG51bGwsCiAgICAgIHNvdXJjZXNDb250ZXh0XzogbnVsbCwKICAgICAgZGVsdGFfOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTsKICAgICAgICB2YXIgc291cmNlcyA9IHRoaXMuc291cmNlczsKICAgICAgICBpZiAodGhpcy5kZWxlZ2F0ZSkgYmFzaXMuZGV2Lndhcm4odGhpcy5jb25zdHJ1Y3Rvci5jbGFzc05hbWUgKyAiIGNhbid0IGhhcyBhIGRlbGVnYXRlIik7CiAgICAgICAgdGhpcy5kYXRhID0ge307CiAgICAgICAgdGhpcy5kZWxlZ2F0ZSA9IG51bGw7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IHRoaXMuZmllbGRzLmZpZWxkU291cmNlW2tleV0gfHwgdGhpcy5maWVsZHMuZGVmYXVsdFNvdXJjZTsKICAgICAgICAgIGlmIChuYW1lID09ICItIikgdGhpcy5kYXRhW2tleV0gPSBkYXRhW2tleV07CiAgICAgICAgfQogICAgICAgIHRoaXMuc291cmNlcyA9IHt9OwogICAgICAgIHRoaXMuc291cmNlc0NvbnRleHRfID0ge307CiAgICAgICAgaWYgKHNvdXJjZXMpIHRoaXMuc2V0U291cmNlcyhzb3VyY2VzKTsKICAgICAgfSwKICAgICAgdXBkYXRlOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgaWYgKHRoaXMuZGVsdGFfKSB7CiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgICB2YXIgc291cmNlTmFtZSA9IHRoaXMuZmllbGRzLmZpZWxkU291cmNlW2tleV0gfHwgdGhpcy5maWVsZHMuZGVmYXVsdFNvdXJjZTsKICAgICAgICAgICAgaWYgKCFzb3VyY2VOYW1lKSB7CiAgICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlVua25vd24gc291cmNlIGZvciBmaWVsZCBgIiArIGtleSArICJgIik7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNvdXJjZUtleSA9IHNvdXJjZU5hbWUgIT0gdGhpcy5maWVsZHMuZGVmYXVsdFNvdXJjZSA/IHRoaXMuZmllbGRzLnRvTmFtZXNbc291cmNlTmFtZV1ba2V5XSA6IGtleTsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5zb3VyY2VzW3NvdXJjZU5hbWVdLmRhdGFbc291cmNlS2V5XTsKICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLmRhdGFba2V5XSkgewogICAgICAgICAgICAgIGlmIChrZXkgaW4gdGhpcy5kZWx0YV8gPT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGVsdGFfW2tleV0gPSB0aGlzLmRhdGFba2V5XTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZGVsdGFfW2tleV0gPT09IHZhbHVlKSBkZWxldGUgdGhpcy5kZWx0YV9ba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5kYXRhW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgc291cmNlRGVsdGE7CiAgICAgICAgdmFyIGRlbHRhID0ge307CiAgICAgICAgdGhpcy5kZWx0YV8gPSBkZWx0YTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgdmFyIHNvdXJjZU5hbWUgPSB0aGlzLmZpZWxkcy5maWVsZFNvdXJjZVtrZXldIHx8IHRoaXMuZmllbGRzLmRlZmF1bHRTb3VyY2U7CiAgICAgICAgICBpZiAoIXNvdXJjZU5hbWUpIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlVua25vd24gc291cmNlIGZvciBmaWVsZCBgIiArIGtleSArICJgIik7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZU5hbWUgPT0gIi0iKSB7CiAgICAgICAgICAgIGRlbHRhW2tleV0gPSB0aGlzLmRhdGFba2V5XTsKICAgICAgICAgICAgdGhpcy5kYXRhW2tleV0gPSBkYXRhW2tleV07CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMuc291cmNlc1tzb3VyY2VOYW1lXSkgewogICAgICAgICAgICB2YXIgc291cmNlS2V5ID0gc291cmNlTmFtZSAhPSB0aGlzLmZpZWxkcy5kZWZhdWx0U291cmNlID8gdGhpcy5maWVsZHMudG9OYW1lc1tzb3VyY2VOYW1lXVtrZXldIDoga2V5OwogICAgICAgICAgICBpZiAodGhpcy5zb3VyY2VzW3NvdXJjZU5hbWVdLmRhdGFbc291cmNlS2V5XSAhPT0gZGF0YVtrZXldKSB7CiAgICAgICAgICAgICAgaWYgKCFzb3VyY2VEZWx0YSkgc291cmNlRGVsdGEgPSB7fTsKICAgICAgICAgICAgICBpZiAoc291cmNlTmFtZSBpbiBzb3VyY2VEZWx0YSA9PSBmYWxzZSkgc291cmNlRGVsdGFbc291cmNlTmFtZV0gPSB7fTsKICAgICAgICAgICAgICBzb3VyY2VEZWx0YVtzb3VyY2VOYW1lXVtzb3VyY2VLZXldID0gZGF0YVtrZXldOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICh0aGlzLmRhdGFba2V5XSAhPT0gZGF0YVtrZXldKSB7CiAgICAgICAgICAgICAgICBkZWx0YVtrZXldID0gdGhpcy5kYXRhW2tleV07CiAgICAgICAgICAgICAgICB0aGlzLmRhdGFba2V5XSA9IGRhdGFba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHNvdXJjZURlbHRhKSBmb3IgKHZhciBzb3VyY2VOYW1lIGluIHNvdXJjZURlbHRhKSB0aGlzLnNvdXJjZXNbc291cmNlTmFtZV0udXBkYXRlKHNvdXJjZURlbHRhW3NvdXJjZU5hbWVdKTsKICAgICAgICB0aGlzLmRlbHRhXyA9IG51bGw7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGRlbHRhKSB7CiAgICAgICAgICB0aGlzLmVtaXRfdXBkYXRlKGRlbHRhKTsKICAgICAgICAgIHJldHVybiBkZWx0YTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9LAogICAgICBzZXREZWxlZ2F0ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIi5NZXJnZSBjYW4ndCBoYXMgYSBkZWxlZ2F0ZSIpOwogICAgICB9LAogICAgICBzZXRTb3VyY2U6IGZ1bmN0aW9uKG5hbWUsIHNvdXJjZSkgewogICAgICAgIHZhciBvbGRTb3VyY2UgPSB0aGlzLnNvdXJjZXNbbmFtZV07CiAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5maWVsZHMuc291cmNlcyA9PSBmYWxzZSkgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmRhdGEub2JqZWN0Lk1lcmdlI3NldFNvdXJjZTogY2FuJ3Qgc2V0IHNvdXJjZSB3aXRoIG5hbWUgYCIgKyBuYW1lICsgImAgYXMgbm90IHNwZWNpZmllZCBieSBmaWVsZHMgY29uZmlndXJhdGlvbiIpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAobmFtZSA9PSAiLSIpIHJldHVybjsKICAgICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgRGF0YU9iamVjdCA9PSBmYWxzZSkgc291cmNlID0gbnVsbDsKICAgICAgICBpZiAob2xkU291cmNlICE9PSBzb3VyY2UpIHsKICAgICAgICAgIHZhciBsaXN0ZW5IYW5kbGVyID0gdGhpcy5saXN0ZW5bInNvdXJjZToiICsgbmFtZV07CiAgICAgICAgICBpZiAob2xkU291cmNlKSB7CiAgICAgICAgICAgIGlmIChsaXN0ZW5IYW5kbGVyKSBvbGRTb3VyY2UucmVtb3ZlSGFuZGxlcihsaXN0ZW5IYW5kbGVyLCB0aGlzKTsKICAgICAgICAgICAgb2xkU291cmNlLnJlbW92ZUhhbmRsZXIoTUVSR0VfU09VUkNFX0hBTkRMRVIsIHRoaXMuc291cmNlc0NvbnRleHRfW25hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc291cmNlc1tuYW1lXSA9IHNvdXJjZTsKICAgICAgICAgIGlmIChzb3VyY2UpIHsKICAgICAgICAgICAgaWYgKG5hbWUgaW4gdGhpcy5zb3VyY2VzQ29udGV4dF8gPT0gZmFsc2UpIHRoaXMuc291cmNlc0NvbnRleHRfW25hbWVdID0gewogICAgICAgICAgICAgIGhvc3Q6IHRoaXMsCiAgICAgICAgICAgICAgbmFtZTogbmFtZQogICAgICAgICAgICB9OwogICAgICAgICAgICBzb3VyY2UuYWRkSGFuZGxlcihNRVJHRV9TT1VSQ0VfSEFORExFUiwgdGhpcy5zb3VyY2VzQ29udGV4dF9bbmFtZV0pOwogICAgICAgICAgICBpZiAobGlzdGVuSGFuZGxlcikgc291cmNlLmFkZEhhbmRsZXIobGlzdGVuSGFuZGxlciwgdGhpcyk7CiAgICAgICAgICAgIHRoaXMudXBkYXRlKHRoaXMuZmllbGRzLnNvdXJjZXNbbmFtZV0oc291cmNlLmRhdGEpKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuZW1pdF9zb3VyY2VDaGFuZ2VkKG5hbWUsIG9sZFNvdXJjZSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRTb3VyY2VzOiBmdW5jdGlvbihzb3VyY2VzKSB7CiAgICAgICAgaWYgKCFzb3VyY2VzKSBzb3VyY2VzID0ge307CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiB0aGlzLmZpZWxkcy5zb3VyY2VzKSB0aGlzLnNldFNvdXJjZShuYW1lLCBzb3VyY2VzW25hbWVdKTsKICAgICAgICBmb3IgKHZhciBuYW1lIGluIHNvdXJjZXMpIGlmIChuYW1lIGluIHRoaXMuZmllbGRzLnNvdXJjZXMgPT0gZmFsc2UpIGJhc2lzLmRldi53YXJuKCJiYXNpcy5kYXRhLm9iamVjdC5NZXJnZSNzZXRTb3VyY2U6IGNhbid0IHNldCBzb3VyY2Ugd2l0aCBuYW1lIGAiICsgbmFtZSArICJgIGFzIG5vdCBzcGVjaWZpZWQgYnkgZmllbGRzIGNvbmZpZ3VyYXRpb24iKTsKICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXRTb3VyY2VzKCk7CiAgICAgICAgdGhpcy5zb3VyY2VzID0gbnVsbDsKICAgICAgICB0aGlzLnNvdXJjZXNDb250ZXh0XyA9IG51bGw7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBNZXJnZTogTWVyZ2UKICAgIH07CiAgfSwKICAiaC5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vZC5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBDbGFzcyA9IGJhc2lzLkNsYXNzOwogICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgIHZhciBrZXlzID0gYmFzaXMub2JqZWN0LmtleXM7CiAgICB2YXIgZXh0ZW5kID0gYmFzaXMub2JqZWN0LmV4dGVuZDsKICAgIHZhciBjb21wbGV0ZSA9IGJhc2lzLm9iamVjdC5jb21wbGV0ZTsKICAgIHZhciAkc2VsZiA9IGJhc2lzLmZuLiRzZWxmOwogICAgdmFyIGdldHRlciA9IGJhc2lzLmdldHRlcjsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheS5mcm9tOwogICAgdmFyIEVtaXR0ZXIgPSBiYXNpcy5ldmVudC5FbWl0dGVyOwogICAgdmFyIGNyZWF0ZUV2ZW50ID0gYmFzaXMuZXZlbnQuY3JlYXRlOwogICAgdmFyIERhdGFPYmplY3QgPSBiYXNpcy5kYXRhLk9iamVjdDsKICAgIHZhciBTbG90ID0gYmFzaXMuZGF0YS5TbG90OwogICAgdmFyIERhdGFzZXQgPSBiYXNpcy5kYXRhLkRhdGFzZXQ7CiAgICB2YXIgRmlsdGVyID0gYmFzaXMuZGF0YS5kYXRhc2V0LkZpbHRlcjsKICAgIHZhciBTcGxpdCA9IGJhc2lzLmRhdGEuZGF0YXNldC5TcGxpdDsKICAgIHZhciBOVUxMX0lORk8gPSB7fTsKICAgIHZhciBlbnRpdHlUeXBlcyA9IFtdOwogICAgdmFyIGlzS2V5VHlwZSA9IHsKICAgICAgc3RyaW5nOiB0cnVlLAogICAgICBudW1iZXI6IHRydWUKICAgIH07CiAgICB2YXIgTnVtZXJpY0lkID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIGlzTmFOKHZhbHVlKSA/IG51bGwgOiBOdW1iZXIodmFsdWUpOwogICAgfTsKICAgIHZhciBOdW1iZXJJZCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBpc05hTih2YWx1ZSkgPyBudWxsIDogTnVtYmVyKHZhbHVlKTsKICAgIH07CiAgICB2YXIgSW50SWQgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gaXNOYU4odmFsdWUpID8gbnVsbCA6IHBhcnNlSW50KHZhbHVlLCAxMCk7CiAgICB9OwogICAgdmFyIFN0cmluZ0lkID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgPyBudWxsIDogU3RyaW5nKHZhbHVlKTsKICAgIH07CiAgICB2YXIgdW50aXRsZWROYW1lcyA9IHt9OwogICAgZnVuY3Rpb24gZ2V0VW50aXRsZWROYW1lKG5hbWUpIHsKICAgICAgdW50aXRsZWROYW1lc1tuYW1lXSA9IHVudGl0bGVkTmFtZXNbbmFtZV0gfHwgMDsKICAgICAgcmV0dXJuIG5hbWUgKyB1bnRpdGxlZE5hbWVzW25hbWVdKys7CiAgICB9CiAgICB2YXIgbmFtZWRUeXBlcyA9IHt9OwogICAgdmFyIG5hbWVkSW5kZXhlcyA9IHt9OwogICAgdmFyIGRlZmVycmVkVHlwZURlZiA9IHt9OwogICAgdmFyIFRZUEVfREVGSU5JVElPTl9QTEFDRUhPTERFUiA9IGZ1bmN0aW9uIFRZUEVfREVGSU5JVElPTl9QTEFDRUhPTERFUigpIHt9OwogICAgZnVuY3Rpb24gcmVzb2x2ZVR5cGUodHlwZU5hbWUsIHR5cGUpIHsKICAgICAgdmFyIGxpc3QgPSBkZWZlcnJlZFR5cGVEZWZbdHlwZU5hbWVdOwogICAgICBpZiAobGlzdCkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBkZWY7IGRlZiA9IGxpc3RbaV07IGkrKykgewogICAgICAgICAgdmFyIHR5cGVIb3N0ID0gZGVmWzBdOwogICAgICAgICAgdmFyIGZpZWxkTmFtZSA9IGRlZlsxXTsKICAgICAgICAgIHR5cGVIb3N0W2ZpZWxkTmFtZV0gPSB0eXBlOwogICAgICAgIH0KICAgICAgICBkZWxldGUgZGVmZXJyZWRUeXBlRGVmW3R5cGVOYW1lXTsKICAgICAgfQogICAgICBuYW1lZFR5cGVzW3R5cGVOYW1lXSA9IHR5cGU7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRUeXBlQnlOYW1lKHR5cGVOYW1lLCB0eXBlSG9zdCwgZmllbGQpIHsKICAgICAgaWYgKG5hbWVkVHlwZXNbdHlwZU5hbWVdKSByZXR1cm4gbmFtZWRUeXBlc1t0eXBlTmFtZV07CiAgICAgIHZhciBsaXN0ID0gZGVmZXJyZWRUeXBlRGVmW3R5cGVOYW1lXTsKICAgICAgaWYgKCFsaXN0KSBsaXN0ID0gZGVmZXJyZWRUeXBlRGVmW3R5cGVOYW1lXSA9IFtdOwogICAgICBsaXN0LnB1c2goWyB0eXBlSG9zdCwgZmllbGQgXSk7CiAgICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgICB2YXIgVHlwZSA9IG5hbWVkVHlwZXNbdHlwZU5hbWVdOwogICAgICAgIGlmIChUeXBlKSByZXR1cm4gVHlwZSh2YWx1ZSwgb2xkVmFsdWUpOwogICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoKSBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiB0eXBlIGAiICsgdHlwZU5hbWUgKyAiYCBpcyBub3QgZGVmaW5lZCBmb3IgIiArIGZpZWxkICsgIiwgYnV0IGZ1bmN0aW9uIGNhbGxlZCIpOwogICAgICB9OwogICAgfQogICAgZnVuY3Rpb24gdmFsaWRhdGVTY2hlbWUoKSB7CiAgICAgIGZvciAodmFyIHR5cGVOYW1lIGluIGRlZmVycmVkVHlwZURlZikgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogdHlwZSBgIiArIHR5cGVOYW1lICsgImAgaXMgbm90IGRlZmluZWQsIGJ1dCB1c2VkIGJ5ICIgKyBkZWZlcnJlZFR5cGVEZWZbdHlwZU5hbWVdLmxlbmd0aCArICIgdHlwZShzKSIpOwogICAgfQogICAgdmFyIHdhcm5Qcm9wZXJ0eUFjY2VzcyA9IGZ1bmN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIGlmIChPYmplY3QuZGVmaW5lUHJvcGVydHkpIHsKICAgICAgICAgIHZhciBvYmogPSB7fTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosICJ4IiwgewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChvYmoueCkgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0LCBuYW1lLCB2YWx1ZSwgd2FybmluZykgewogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmplY3QsIG5hbWUsIHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKHdhcm5pbmcpOwogICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgICB2YWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkge307CiAgICB9KCk7CiAgICB2YXIgSW5kZXggPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5JbmRleCIsCiAgICAgIGl0ZW1zOiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbihmbikgewogICAgICAgIHRoaXMuaXRlbXMgPSB7fTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbih2YWx1ZSwgY2hlY2tUeXBlKSB7CiAgICAgICAgdmFyIGl0ZW0gPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMuaXRlbXMsIHZhbHVlKSAmJiB0aGlzLml0ZW1zW3ZhbHVlXTsKICAgICAgICBpZiAoaXRlbSAmJiAoIWNoZWNrVHlwZSB8fCBpdGVtLmVudGl0eVR5cGUgPT09IGNoZWNrVHlwZSkpIHJldHVybiBpdGVtOwogICAgICB9LAogICAgICBhZGQ6IGZ1bmN0aW9uKHZhbHVlLCBuZXdJdGVtKSB7CiAgICAgICAgaWYgKG5ld0l0ZW0pIHsKICAgICAgICAgIHZhciBjdXJJdGVtID0gdGhpcy5nZXQodmFsdWUpOwogICAgICAgICAgaWYgKCFjdXJJdGVtKSB7CiAgICAgICAgICAgIHRoaXMuaXRlbXNbdmFsdWVdID0gbmV3SXRlbTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VySXRlbSAhPT0gbmV3SXRlbSkgdGhyb3cgImJhc2lzLmVudGl0eTogVmFsdWUgYCIgKyB2YWx1ZSArICJgIGZvciBpbmRleCBpcyBhbHJlYWR5IG9jY3VwaWVkIjsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlbW92ZTogZnVuY3Rpb24odmFsdWUsIGl0ZW0pIHsKICAgICAgICBpZiAodGhpcy5pdGVtc1t2YWx1ZV0gPT09IGl0ZW0pIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLml0ZW1zW3ZhbHVlXTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5pdGVtcyA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gQ2FsY3VsYXRlRmllbGQoKSB7CiAgICAgIHZhciBuYW1lcyA9IGFycmF5RnJvbShhcmd1bWVudHMpOwogICAgICB2YXIgY2FsY0ZuID0gbmFtZXMucG9wKCk7CiAgICAgIHZhciBmb28gPSBuYW1lc1swXTsKICAgICAgdmFyIGJhciA9IG5hbWVzWzFdOwogICAgICB2YXIgYmF6ID0gbmFtZXNbMl07CiAgICAgIHZhciByZXN1bHQ7CiAgICAgIGlmICh0eXBlb2YgY2FsY0ZuICE9ICJmdW5jdGlvbiIpIHRocm93ICJMYXN0IGFyZ3VtZW50IGZvciBjYWxjdWxhdGUgZmllbGQgY29uc3RydWN0b3IgbXVzdCBiZSBhIGZ1bmN0aW9uIjsKICAgICAgc3dpdGNoIChuYW1lcy5sZW5ndGgpIHsKICAgICAgICBjYXNlIDA6CiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGNhbGNGbigpOwogICAgICAgICAgfTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMToKICAgICAgICAgIHJlc3VsdCA9IGZ1bmN0aW9uKGRlbHRhLCBkYXRhLCBvbGRWYWx1ZSkgewogICAgICAgICAgICBpZiAoZm9vIGluIGRlbHRhKSByZXR1cm4gY2FsY0ZuKGRhdGFbZm9vXSk7CiAgICAgICAgICAgIHJldHVybiBvbGRWYWx1ZTsKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDI6CiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbihkZWx0YSwgZGF0YSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgaWYgKGZvbyBpbiBkZWx0YSB8fCBiYXIgaW4gZGVsdGEpIHJldHVybiBjYWxjRm4oZGF0YVtmb29dLCBkYXRhW2Jhcl0pOwogICAgICAgICAgICByZXR1cm4gb2xkVmFsdWU7CiAgICAgICAgICB9OwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgcmVzdWx0ID0gZnVuY3Rpb24oZGVsdGEsIGRhdGEsIG9sZFZhbHVlKSB7CiAgICAgICAgICAgIGlmIChmb28gaW4gZGVsdGEgfHwgYmFyIGluIGRlbHRhIHx8IGJheiBpbiBkZWx0YSkgcmV0dXJuIGNhbGNGbihkYXRhW2Zvb10sIGRhdGFbYmFyXSwgZGF0YVtiYXpdKTsKICAgICAgICAgICAgcmV0dXJuIG9sZFZhbHVlOwogICAgICAgICAgfTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbihkZWx0YSwgZGF0YSwgb2xkVmFsdWUpIHsKICAgICAgICAgICAgdmFyIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgICAgICAgdmFyIGFyZ3MgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIG5hbWU7IG5hbWUgPSBuYW1lc1tpXTsgaSsrKSB7CiAgICAgICAgICAgICAgY2hhbmdlZCA9IGNoYW5nZWQgfHwgbmFtZSBpbiBkZWx0YTsKICAgICAgICAgICAgICBhcmdzLnB1c2goZGF0YVtuYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoYW5nZWQpIHJldHVybiBjYWxjRm4uYXBwbHkobnVsbCwgYXJncyk7CiAgICAgICAgICAgIHJldHVybiBvbGRWYWx1ZTsKICAgICAgICAgIH07CiAgICAgIH0KICAgICAgcmVzdWx0ID0gRnVuY3Rpb24oImNhbGNGbiIsICJuYW1lcyIsICJyZXR1cm4gIiArIHJlc3VsdC50b1N0cmluZygpLnJlcGxhY2UoLyhmb298YmFyfGJheikvZywgZnVuY3Rpb24obSwgdykgewogICAgICAgIHJldHVybiAnIicgKyBuYW1lc1t3ID09ICJmb28iID8gMCA6IHcgPT0gImJhciIgPyAxIDogMl0gKyAnIic7CiAgICAgIH0pLnJlcGxhY2UoL1xbXCIoW14iXSspXCJcXS9nLCAiLiQxIikpKGNhbGNGbiwgbmFtZXMpOwogICAgICByZXN1bHQuYXJncyA9IG5hbWVzOwogICAgICByZXN1bHQuY2FsYyA9IHJlc3VsdDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGZ1bmN0aW9uIENvbmNhdFN0cmluZ0ZpZWxkKG5hbWUpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgcmV0dXJuIGZ1bmN0aW9uKGRlbHRhLCBkYXRhLCBvbGRWYWx1ZSkgewogICAgICAgIGlmIChuYW1lIGluIGRlbHRhKSByZXR1cm4gZGF0YVtuYW1lXSAhPSBudWxsID8gU3RyaW5nKGRhdGFbbmFtZV0pIDogbnVsbDsKICAgICAgICByZXR1cm4gb2xkVmFsdWU7CiAgICAgIH07CiAgICAgIHJldHVybiBDYWxjdWxhdGVGaWVsZC5hcHBseShudWxsLCBhcnJheUZyb20oYXJndW1lbnRzKS5jb25jYXQoZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IGFyZ3VtZW50cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGFyZ3VtZW50c1tpXSA9PSBudWxsKSByZXR1cm4gbnVsbDsKICAgICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmpvaW4uY2FsbChhcmd1bWVudHMsICItIik7CiAgICAgIH0pKTsKICAgIH0KICAgIHZhciBFTlRJVFlTRVRfV1JBUF9NRVRIT0QgPSBmdW5jdGlvbihzdXBlckNsYXNzLCBtZXRob2QpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICByZXR1cm4gc3VwZXJDbGFzcy5wcm90b3R5cGVbbWV0aG9kXS5jYWxsKHRoaXMsIGRhdGEgJiYgZGF0YS5tYXAodGhpcy53cmFwcGVyKSk7CiAgICAgIH07CiAgICB9OwogICAgdmFyIEVOVElUWVNFVF9JTklUX01FVEhPRCA9IGZ1bmN0aW9uKHN1cGVyQ2xhc3MsIG5hbWUpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy5uYW1lKSB0aGlzLm5hbWUgPSBnZXRVbnRpdGxlZE5hbWUobmFtZSk7CiAgICAgICAgc3VwZXJDbGFzcy5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICB9OwogICAgfTsKICAgIHZhciBFTlRJVFlTRVRfU1lOQ19NRVRIT0QgPSBmdW5jdGlvbihzdXBlckNsYXNzKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgdmFyIGRlc3Ryb3lJdGVtcyA9IGJhc2lzLm9iamVjdC5zbGljZSh0aGlzLml0ZW1zXyk7CiAgICAgICAgdmFyIGluc2VydGVkID0gW107CiAgICAgICAgdmFyIGRlbGV0ZWQgPSBbXTsKICAgICAgICBpZiAoZGF0YSkgewogICAgICAgICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUodHJ1ZSk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGVudGl0eSA9IHRoaXMud3JhcHBlcihkYXRhW2ldKTsKICAgICAgICAgICAgaWYgKGVudGl0eSkgZGVzdHJveUl0ZW1zW2VudGl0eS5iYXNpc09iamVjdElkXSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUoZmFsc2UpOwogICAgICAgIH0KICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5pdGVtc18pIGlmIChrZXkgaW4gZGVzdHJveUl0ZW1zID09IGZhbHNlKSBpbnNlcnRlZC5wdXNoKHRoaXMuaXRlbXNfW2tleV0pOwogICAgICAgIGZvciAodmFyIGtleSBpbiBkZXN0cm95SXRlbXMpIGlmIChkZXN0cm95SXRlbXNba2V5XSkgZGVsZXRlZC5wdXNoKGRlc3Ryb3lJdGVtc1trZXldKTsKICAgICAgICBpZiAoZGVsZXRlZC5sZW5ndGggJiYgdGhpcy53cmFwcGVyLmFsbCkgdGhpcy53cmFwcGVyLmFsbC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICBkZWxldGVkOiBkZWxldGVkCiAgICAgICAgfSk7CiAgICAgICAgRGF0YXNldC5zZXRBY2N1bXVsYXRlU3RhdGUodHJ1ZSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGVkLmxlbmd0aDsgaSsrKSBkZWxldGVkW2ldLmRlc3Ryb3koKTsKICAgICAgICBEYXRhc2V0LnNldEFjY3VtdWxhdGVTdGF0ZShmYWxzZSk7CiAgICAgICAgcmV0dXJuIGluc2VydGVkLmxlbmd0aCA/IGluc2VydGVkIDogbnVsbDsKICAgICAgfTsKICAgIH07CiAgICB2YXIgRW50aXR5U2V0ID0gQ2xhc3MoRGF0YXNldCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRW50aXR5U2V0IiwKICAgICAgbmFtZTogbnVsbCwKICAgICAgd3JhcHBlcjogJHNlbGYsCiAgICAgIGluaXQ6IEVOVElUWVNFVF9JTklUX01FVEhPRChEYXRhc2V0LCAiRW50aXR5U2V0IiksCiAgICAgIHN5bmM6IEVOVElUWVNFVF9TWU5DX01FVEhPRChEYXRhc2V0KSwKICAgICAgc2V0OiBFTlRJVFlTRVRfV1JBUF9NRVRIT0QoRGF0YXNldCwgInNldCIpLAogICAgICBhZGQ6IEVOVElUWVNFVF9XUkFQX01FVEhPRChEYXRhc2V0LCAiYWRkIiksCiAgICAgIHJlbW92ZTogRU5USVRZU0VUX1dSQVBfTUVUSE9EKERhdGFzZXQsICJyZW1vdmUiKSwKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgRGF0YXNldC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMud3JhcHBlciA9IG51bGw7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFJlYWRPbmx5RW50aXR5U2V0ID0gQ2xhc3MoRW50aXR5U2V0LCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5SZWFkT25seUVudGl0eVNldCIsCiAgICAgIHNldDogYmFzaXMuZm4uJGZhbHNlLAogICAgICBhZGQ6IGJhc2lzLmZuLiRmYWxzZSwKICAgICAgcmVtb3ZlOiBiYXNpcy5mbi4kZmFsc2UsCiAgICAgIGNsZWFyOiBiYXNpcy5mbi4kZmFsc2UKICAgIH0pOwogICAgdmFyIEVudGl0eUNvbGxlY3Rpb24gPSBDbGFzcyhGaWx0ZXIsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkVudGl0eUNvbGxlY3Rpb24iLAogICAgICBuYW1lOiBudWxsLAogICAgICBpbml0OiBFTlRJVFlTRVRfSU5JVF9NRVRIT0QoRmlsdGVyLCAiRW50aXR5Q29sbGVjdGlvbiIpLAogICAgICBzeW5jOiBFTlRJVFlTRVRfU1lOQ19NRVRIT0QoRmlsdGVyKQogICAgfSk7CiAgICB2YXIgRW50aXR5R3JvdXBpbmcgPSBDbGFzcyhTcGxpdCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRW50aXR5R3JvdXBpbmciLAogICAgICBuYW1lOiBudWxsLAogICAgICBzdWJzZXRDbGFzczogUmVhZE9ubHlFbnRpdHlTZXQsCiAgICAgIGluaXQ6IEVOVElUWVNFVF9JTklUX01FVEhPRChTcGxpdCwgIkVudGl0eUdyb3VwaW5nIiksCiAgICAgIHN5bmM6IEVOVElUWVNFVF9TWU5DX01FVEhPRChTcGxpdCksCiAgICAgIGdldFN1YnNldDogZnVuY3Rpb24ob2JqZWN0LCBhdXRvY3JlYXRlKSB7CiAgICAgICAgdmFyIGdyb3VwID0gU3BsaXQucHJvdG90eXBlLmdldFN1YnNldC5jYWxsKHRoaXMsIG9iamVjdCwgYXV0b2NyZWF0ZSk7CiAgICAgICAgaWYgKGdyb3VwICYmIGdyb3VwLmRhdGFzZXQpIGdyb3VwLmRhdGFzZXQud3JhcHBlciA9IHRoaXMud3JhcHBlcjsKICAgICAgICByZXR1cm4gZ3JvdXA7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIEVudGl0eVNldFdyYXBwZXIgPSBmdW5jdGlvbih3cmFwcGVyLCBuYW1lKSB7CiAgICAgIGlmICh0aGlzIGluc3RhbmNlb2YgRW50aXR5U2V0V3JhcHBlcikgewogICAgICAgIGlmICghd3JhcHBlcikgd3JhcHBlciA9ICRzZWxmOwogICAgICAgIGlmICghbmFtZSB8fCBuYW1lZFR5cGVzW25hbWVdKSB7CiAgICAgICAgICBpZiAobmFtZWRUeXBlc1tuYW1lXSkgYmFzaXMuZGV2Lndhcm4obmFtZXNwYWNlICsgIjogRHVwbGljYXRlIGVudGl0eSBzZXQgdHlwZSBuYW1lIGAiICsgdGhpcy5uYW1lICsgImAsIG5hbWUgaWdub3JlZCIpOwogICAgICAgICAgbmFtZSA9IGdldFVudGl0bGVkTmFtZSgiVW50aXRsZWRFbnRpdHlTZXRUeXBlIik7CiAgICAgICAgfQogICAgICAgIHZhciBlbnRpdHlTZXRUeXBlID0gbmV3IEVudGl0eVNldENvbnN0cnVjdG9yKHsKICAgICAgICAgIGVudGl0eVNldENsYXNzOiB7CiAgICAgICAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5FbnRpdHlTZXQoIiArICh0eXBlb2Ygd3JhcHBlciA9PSAic3RyaW5nIiA/IHdyYXBwZXIgOiAod3JhcHBlci50eXBlIHx8IHdyYXBwZXIpLm5hbWUgfHwgIlVua25vd25UeXBlIikgKyAiKSIsCiAgICAgICAgICAgIG5hbWU6ICJTZXQgb2YgeyIgKyAodHlwZW9mIHdyYXBwZXIgPT0gInN0cmluZyIgPyB3cmFwcGVyIDogKHdyYXBwZXIudHlwZSB8fCB3cmFwcGVyKS5uYW1lIHx8ICJVbmtub3duVHlwZSIpICsgIn0iLAogICAgICAgICAgICB3cmFwcGVyOiB3cmFwcGVyCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIEVudGl0eVNldENsYXNzID0gZW50aXR5U2V0VHlwZS5lbnRpdHlTZXRDbGFzczsKICAgICAgICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24oZGF0YSwgZW50aXR5U2V0KSB7CiAgICAgICAgICBpZiAoZGF0YSAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChlbnRpdHlTZXQgaW5zdGFuY2VvZiBFbnRpdHlTZXQgPT0gZmFsc2UpIGVudGl0eVNldCA9IGVudGl0eVNldFR5cGUuY3JlYXRlRW50aXR5U2V0KCk7CiAgICAgICAgICAgIGVudGl0eVNldC5zZXQoZGF0YSBpbnN0YW5jZW9mIERhdGFzZXQgPyBkYXRhLmdldEl0ZW1zKCkgOiBhcnJheUZyb20oZGF0YSkpOwogICAgICAgICAgICByZXR1cm4gZW50aXR5U2V0OwogICAgICAgICAgfSBlbHNlIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgaWYgKHR5cGVvZiB3cmFwcGVyID09ICJzdHJpbmciKSBFbnRpdHlTZXRDbGFzcy5wcm90b3R5cGUud3JhcHBlciA9IGdldFR5cGVCeU5hbWUod3JhcHBlciwgRW50aXR5U2V0Q2xhc3MucHJvdG90eXBlLCAid3JhcHBlciIpOwogICAgICAgIHJlc29sdmVUeXBlKG5hbWUsIHJlc3VsdCk7CiAgICAgICAgZXh0ZW5kKHJlc3VsdCwgewogICAgICAgICAgdHlwZTogZW50aXR5U2V0VHlwZSwKICAgICAgICAgIHR5cGVOYW1lOiBuYW1lLAogICAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbmFtZSArICIoKSI7CiAgICAgICAgICB9LAogICAgICAgICAgcmVhZGVyOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7CiAgICAgICAgICAgICAgdmFyIHdyYXBwZXIgPSBFbnRpdHlTZXRDbGFzcy5wcm90b3R5cGUud3JhcHBlcjsKICAgICAgICAgICAgICByZXR1cm4gZGF0YS5tYXAod3JhcHBlci5yZWFkZXIgfHwgd3JhcHBlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9LAogICAgICAgICAgZXh0ZW5kQ2xhc3M6IGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICAgICAgICBFbnRpdHlTZXRDbGFzcy5leHRlbmQuY2FsbChFbnRpdHlTZXRDbGFzcywgc291cmNlKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0sCiAgICAgICAgICBleHRlbmRSZWFkZXI6IGZ1bmN0aW9uKGV4dFJlYWRlcikgewogICAgICAgICAgICB2YXIgcmVhZGVyID0gcmVzdWx0LnJlYWRlcjsKICAgICAgICAgICAgcmVzdWx0LnJlYWRlciA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkgZXh0UmVhZGVyKGRhdGEpOwogICAgICAgICAgICAgIHJldHVybiByZWFkZXIoZGF0YSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9LAogICAgICAgICAgZW50aXR5U2V0VHlwZTogZW50aXR5U2V0VHlwZSwKICAgICAgICAgIGV4dGVuZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5lbnRpdHk6IEVudGl0eVNldFR5cGUuZXh0ZW5kKCkgaXMgZGVwcmVjYXRlZCwgdXNlIEVudGl0eVNldFR5cGUuZXh0ZW5kQ2xhc3MoKSBpbnN0ZWFkLiIpOwogICAgICAgICAgICByZXR1cm4gRW50aXR5U2V0Q2xhc3MuZXh0ZW5kLmFwcGx5KEVudGl0eVNldENsYXNzLCBhcmd1bWVudHMpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHdhcm5Qcm9wZXJ0eUFjY2VzcyhyZXN1bHQsICJlbnRpdHlTZXRUeXBlIiwgZW50aXR5U2V0VHlwZSwgImJhc2lzLmVudGl0eTogRW50aXR5U2V0VHlwZS5lbnRpdHlTZXRUeXBlIGlzIGRlcHJlY2F0ZWQsIHVzZSBFbnRpdHlTZXRUeXBlLnR5cGUgaW5zdGVhZC4iKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICB9OwogICAgRW50aXR5U2V0V3JhcHBlci5jbGFzc05hbWUgPSBuYW1lc3BhY2UgKyAiLkVudGl0eVNldFdyYXBwZXIiOwogICAgdmFyIEVudGl0eVNldENvbnN0cnVjdG9yID0gQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuRW50aXR5U2V0Q29uc3RydWN0b3IiLAogICAgICBlbnRpdHlTZXRDbGFzczogRW50aXR5U2V0LAogICAgICBleHRlbmRDb25zdHJ1Y3Rvcl86IHRydWUsCiAgICAgIGNyZWF0ZUVudGl0eVNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyB0aGlzLmVudGl0eVNldENsYXNzOwogICAgICB9CiAgICB9KTsKICAgIHZhciBFbnRpdHlUeXBlV3JhcHBlciA9IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIEVudGl0eVR5cGVXcmFwcGVyKSB7CiAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICBpZiAoY29uZmlnLnNpbmdsZXRvbikgcmVzdWx0ID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgdmFyIGVudGl0eSA9IGVudGl0eVR5cGUuZ2V0KCk7CiAgICAgICAgICBpZiAoZW50aXR5KSB7CiAgICAgICAgICAgIGlmIChkYXRhKSBlbnRpdHkudXBkYXRlKGRhdGEpOwogICAgICAgICAgfSBlbHNlIGVudGl0eSA9IG5ldyBFbnRpdHlDbGFzcyhkYXRhIHx8IHt9KTsKICAgICAgICAgIHJldHVybiBlbnRpdHk7CiAgICAgICAgfTsgZWxzZSByZXN1bHQgPSBmdW5jdGlvbihkYXRhLCBlbnRpdHkpIHsKICAgICAgICAgIGlmIChkYXRhICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKCFlbnRpdHkgfHwgZW50aXR5LmVudGl0eVR5cGUgIT09IGVudGl0eVR5cGUpIGVudGl0eSA9IG51bGw7CiAgICAgICAgICAgIGlmIChkYXRhID09PSBlbnRpdHkgfHwgZGF0YS5lbnRpdHlUeXBlID09PSBlbnRpdHlUeXBlKSByZXR1cm4gZGF0YTsKICAgICAgICAgICAgdmFyIGlkVmFsdWU7CiAgICAgICAgICAgIHZhciBpZEZpZWxkID0gZW50aXR5VHlwZS5pZEZpZWxkOwogICAgICAgICAgICBpZiAoaXNLZXlUeXBlW3R5cGVvZiBkYXRhXSkgewogICAgICAgICAgICAgIGlmICghaWRGaWVsZCkgewogICAgICAgICAgICAgICAgaWYgKGVudGl0eVR5cGUuY29tcG9zaXRlS2V5KSBiYXNpcy5kZXYud2FybigiYmFzaXMuZW50aXR5OiBFbnRpdHkgdHlwZSBgIiArIGVudGl0eVR5cGUubmFtZSArICJgIHdyYXBwZXIgd2FzIGludm9rZWQgd2l0aCAiICsgdHlwZW9mIGRhdGEgKyAiIHZhbHVlIGFzIGluZGV4LCBidXQgZW50aXR5IHR5cGUgaW5kZXggaXMgY29tcG9zaXRlIGFuZCBjb25zaXN0cyBvZiBbIiArIGtleXMoZW50aXR5VHlwZS5pZEZpZWxkcykuam9pbigiLCAiKSArICJdIGZpZWxkcyIpOyBlbHNlIGJhc2lzLmRldi53YXJuKCJiYXNpcy5lbnRpdHk6IEVudGl0eSB0eXBlIGAiICsgZW50aXR5VHlwZS5uYW1lICsgImAgd3JhcHBlciB3YXMgaW52b2tlZCB3aXRoICIgKyB0eXBlb2YgZGF0YSArICIgdmFsdWUgYXMgaW5kZXgsIGJ1dCBlbnRpdHkgdHlwZSBoYXMgbm8gaW5kZXgiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGVudGl0eSA9IGVudGl0eVR5cGUuaW5kZXguZ2V0KGRhdGEsIGVudGl0eVR5cGUpKSByZXR1cm4gZW50aXR5OwogICAgICAgICAgICAgIGlkVmFsdWUgPSBkYXRhOwogICAgICAgICAgICAgIGRhdGEgPSB7fTsKICAgICAgICAgICAgICBkYXRhW2lkRmllbGRdID0gaWRWYWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoZW50aXR5VHlwZS5jb21wb3NpdGVLZXkpIGlkVmFsdWUgPSBlbnRpdHlUeXBlLmNvbXBvc2l0ZUtleShkYXRhLCBkYXRhKTsKICAgICAgICAgICAgICBpZiAoaWRWYWx1ZSAhPSBudWxsKSBlbnRpdHkgPSBlbnRpdHlUeXBlLmluZGV4LmdldChpZFZhbHVlLCBlbnRpdHlUeXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZW50aXR5ICYmIGVudGl0eS5lbnRpdHlUeXBlID09PSBlbnRpdHlUeXBlKSBlbnRpdHkudXBkYXRlKGRhdGEpOyBlbHNlIGVudGl0eSA9IG5ldyBFbnRpdHlDbGFzcyhkYXRhKTsKICAgICAgICAgICAgcmV0dXJuIGVudGl0eTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBlbnRpdHlUeXBlID0gbmV3IEVudGl0eVR5cGVDb25zdHJ1Y3Rvcihjb25maWcgfHwge30sIHJlc3VsdCk7CiAgICAgICAgdmFyIEVudGl0eUNsYXNzID0gZW50aXR5VHlwZS5lbnRpdHlDbGFzczsKICAgICAgICB2YXIgbmFtZSA9IGVudGl0eVR5cGUubmFtZTsKICAgICAgICByZXNvbHZlVHlwZShuYW1lLCByZXN1bHQpOwogICAgICAgIGV4dGVuZChyZXN1bHQsIHsKICAgICAgICAgIGFsbDogZW50aXR5VHlwZS5hbGwsCiAgICAgICAgICB0eXBlOiBlbnRpdHlUeXBlLAogICAgICAgICAgdHlwZU5hbWU6IG5hbWUsCiAgICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBuYW1lICsgIigpIjsKICAgICAgICAgIH0sCiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgcmV0dXJuIGVudGl0eVR5cGUuZ2V0KGRhdGEpOwogICAgICAgICAgfSwKICAgICAgICAgIGdldFNsb3Q6IGZ1bmN0aW9uKGlkLCBkZWZhdWx0cykgewogICAgICAgICAgICByZXR1cm4gZW50aXR5VHlwZS5nZXRTbG90KGlkLCBkZWZhdWx0cyk7CiAgICAgICAgICB9LAogICAgICAgICAgcmVhZGVyOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgIHJldHVybiBlbnRpdHlUeXBlLnJlYWRlcihkYXRhKTsKICAgICAgICAgIH0sCiAgICAgICAgICBleHRlbmRDbGFzczogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgICAgIEVudGl0eUNsYXNzLmV4dGVuZC5jYWxsKEVudGl0eUNsYXNzLCBzb3VyY2UpOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgfSwKICAgICAgICAgIGV4dGVuZFJlYWRlcjogZnVuY3Rpb24oZXh0UmVhZGVyKSB7CiAgICAgICAgICAgIHZhciByZWFkZXIgPSByZXN1bHQucmVhZGVyOwogICAgICAgICAgICByZXN1bHQucmVhZGVyID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgIGlmIChkYXRhICYmIHR5cGVvZiBkYXRhID09ICJvYmplY3QiKSBleHRSZWFkZXIoZGF0YSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRlcihkYXRhKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0sCiAgICAgICAgICBlbnRpdHlUeXBlOiBlbnRpdHlUeXBlLAogICAgICAgICAgZXh0ZW5kOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmVudGl0eTogRW50aXR5VHlwZS5leHRlbmQoKSBpcyBkZXByZWNhdGVkLCB1c2UgRW50aXR5VHlwZS5leHRlbmRDbGFzcygpIGluc3RlYWQuIik7CiAgICAgICAgICAgIHJldHVybiBFbnRpdHlDbGFzcy5leHRlbmQuYXBwbHkoRW50aXR5Q2xhc3MsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgd2FyblByb3BlcnR5QWNjZXNzKHJlc3VsdCwgImVudGl0eVR5cGUiLCBlbnRpdHlUeXBlLCAiYmFzaXMuZW50aXR5OiBFbnRpdHlUeXBlLmVudGl0eVR5cGUgaXMgZGVwcmVjYXRlZCwgdXNlIEVudGl0eVR5cGUudHlwZSBpbnN0ZWFkLiIpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgIH07CiAgICBFbnRpdHlUeXBlV3JhcHBlci5jbGFzc05hbWUgPSBuYW1lc3BhY2UgKyAiLkVudGl0eVR5cGVXcmFwcGVyIjsKICAgIHZhciBmaWVsZERlc3Ryb3lIYW5kbGVycyA9IHt9OwogICAgdmFyIGRhdGFCdWlsZGVyRmFjdG9yeSA9IHt9OwogICAgdmFyIGNhbGNGaWVsZFdyYXBwZXIgPSBmdW5jdGlvbih2YWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgYmFzaXMuZGV2Lndhcm4oIkNhbGN1bGF0ZSBmaWVsZHMgYXJlIHJlYWRvbmx5Iik7CiAgICAgIHJldHVybiBvbGRWYWx1ZTsKICAgIH07CiAgICBmdW5jdGlvbiBnZXREYXRhQnVpbGRlcihkZWZhdWx0cywgZmllbGRzKSB7CiAgICAgIHZhciBhcmdzID0gWyAiaGFzIiBdOwogICAgICB2YXIgdmFsdWVzID0gWyBoYXNPd25Qcm9wZXJ0eSBdOwogICAgICB2YXIgb2JqID0gW107CiAgICAgIGZvciAodmFyIGtleSBpbiBkZWZhdWx0cykgaWYgKGhhc093blByb3BlcnR5LmNhbGwoZGVmYXVsdHMsIGtleSkpIHsKICAgICAgICB2YXIgbmFtZSA9ICJ2IiArIG9iai5sZW5ndGg7CiAgICAgICAgdmFyIGZuYW1lID0gImYiICsgb2JqLmxlbmd0aDsKICAgICAgICB2YXIgdmFsdWUgPSBkZWZhdWx0c1trZXldOwogICAgICAgIGFyZ3MucHVzaChuYW1lLCBmbmFtZSk7CiAgICAgICAgdmFsdWVzLnB1c2godmFsdWUsIGZpZWxkc1trZXldKTsKICAgICAgICBvYmoucHVzaCgnIicgKyBrZXkgKyAnIjonICsgJ2hhcy5jYWxsKGRhdGEsIicgKyBrZXkgKyAnIiknICsgIj8iICsgZm5hbWUgKyAnKGRhdGFbIicgKyBrZXkgKyAnIl0sJyArIG5hbWUgKyAiKSIgKyAiOiIgKyBuYW1lICsgKHR5cGVvZiB2YWx1ZSA9PSAiZnVuY3Rpb24iID8gIihkYXRhKSIgOiAiIikpOwogICAgICB9CiAgICAgIHZhciBjb2RlID0gb2JqLnNvcnQoKS5qb2luKCIsIik7CiAgICAgIHZhciBmbiA9IGRhdGFCdWlsZGVyRmFjdG9yeVtjb2RlXTsKICAgICAgaWYgKCFmbikgZm4gPSBkYXRhQnVpbGRlckZhY3RvcnlbY29kZV0gPSBuZXcgRnVuY3Rpb24oYXJncywgInJldHVybiBmdW5jdGlvbihkYXRhKXsiICsgInJldHVybiB7IiArIGNvZGUgKyAifTsiICsgIn07Iik7CiAgICAgIHJldHVybiBmbi5hcHBseShudWxsLCB2YWx1ZXMpOwogICAgfQogICAgZnVuY3Rpb24gYXJyYXlGaWVsZChuZXdBcnJheSwgb2xkQXJyYXkpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG5ld0FycmF5KSkgcmV0dXJuIG51bGw7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShvbGRBcnJheSkgfHwgbmV3QXJyYXkubGVuZ3RoICE9IG9sZEFycmF5Lmxlbmd0aCkgcmV0dXJuIG5ld0FycmF5IHx8IG51bGw7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3QXJyYXkubGVuZ3RoOyBpKyspIGlmIChuZXdBcnJheVtpXSAhPT0gb2xkQXJyYXlbaV0pIHJldHVybiBuZXdBcnJheTsKICAgICAgcmV0dXJuIG9sZEFycmF5OwogICAgfQogICAgdmFyIGZyb21JU09TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gZmFzdERhdGVQYXJzZSh5LCBtLCBkLCBoLCBpLCBzLCBtcykgewogICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoeSwgbSAtIDEsIGQsIGggfHwgMCwgMCwgcyB8fCAwLCBtcyA/IG1zLnN1YnN0cigwLCAzKSA6IDApOwogICAgICAgIGRhdGUuc2V0TWludXRlcygoaSB8fCAwKSAtIHR6IC0gZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpKTsKICAgICAgICByZXR1cm4gZGF0ZTsKICAgICAgfQogICAgICB2YXIgdHo7CiAgICAgIHJldHVybiBmdW5jdGlvbihpc29EYXRlU3RyaW5nKSB7CiAgICAgICAgdHogPSAwOwogICAgICAgIHJldHVybiBmYXN0RGF0ZVBhcnNlLmFwcGx5KG51bGwsIFN0cmluZyhpc29EYXRlU3RyaW5nIHx8ICIiKS5yZXBsYWNlKHJlSXNvVGltZXpvbmVEZXNpZ25hdG9yLCBmdW5jdGlvbihtLCBwcmUsIGgsIGkpIHsKICAgICAgICAgIHR6ID0gaSA/IGggKiA2MCArIGkgKiAxIDogaCAqIDE7CiAgICAgICAgICByZXR1cm4gcHJlOwogICAgICAgIH0pLnNwbGl0KHJlSXNvU3RyaW5nU3BsaXQpKTsKICAgICAgfTsKICAgIH0oKTsKICAgIGZ1bmN0aW9uIGRhdGVGaWVsZCh2YWx1ZSwgb2xkVmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIikgcmV0dXJuIGZyb21JU09TdHJpbmcodmFsdWUpOwogICAgICBpZiAodHlwZW9mIHZhbHVlID09ICJudW1iZXIiKSByZXR1cm4gbmV3IERhdGUodmFsdWUpOwogICAgICBpZiAodmFsdWUgPT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS5jb25zdHJ1Y3RvciA9PT0gRGF0ZSkgcmV0dXJuIHZhbHVlOwogICAgICBiYXNpcy5kZXYud2FybigiYmFzaXMuZW50aXR5OiBCYWQgdmFsdWUgZm9yIERhdGUgZmllbGQsIHZhbHVlIGlnbm9yZWQiKTsKICAgICAgcmV0dXJuIG9sZFZhbHVlOwogICAgfQogICAgZnVuY3Rpb24gYWRkRmllbGQoZW50aXR5VHlwZSwgbmFtZSwgY29uZmlnKSB7CiAgICAgIGVudGl0eVR5cGUuYWxpYXNlc1tuYW1lXSA9IG5hbWU7CiAgICAgIGlmICh0eXBlb2YgY29uZmlnID09ICJzdHJpbmciIHx8IEFycmF5LmlzQXJyYXkoY29uZmlnKSB8fCB0eXBlb2YgY29uZmlnID09ICJmdW5jdGlvbiIgJiYgY29uZmlnLmNhbGMgIT09IGNvbmZpZykgewogICAgICAgIGNvbmZpZyA9IHsKICAgICAgICAgIHR5cGU6IGNvbmZpZwogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uZmlnID0gY29uZmlnID8gYmFzaXMub2JqZWN0LnNsaWNlKGNvbmZpZykgOiB7fTsKICAgICAgfQogICAgICBpZiAoInR5cGUiIGluIGNvbmZpZykgewogICAgICAgIGlmICh0eXBlb2YgY29uZmlnLnR5cGUgPT0gInN0cmluZyIpIGNvbmZpZy50eXBlID0gZ2V0VHlwZUJ5TmFtZShjb25maWcudHlwZSwgZW50aXR5VHlwZS5maWVsZHMsIG5hbWUpOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbmZpZy50eXBlKSkgewogICAgICAgICAgdmFyIHZhbHVlcyA9IGNvbmZpZy50eXBlLnNsaWNlKCk7CiAgICAgICAgICBpZiAoIXZhbHVlcy5sZW5ndGgpIGJhc2lzLmRldi53YXJuKCJFbXB0eSBhcnJheSBzZXQgYXMgdHlwZSBkZWZpbml0aW9uIGZvciAiICsgZW50aXR5VHlwZS5uYW1lICsgIiNmaWVsZC4iICsgbmFtZSArICIsIGlzIGl0IGEgYnVnPyIpOwogICAgICAgICAgaWYgKHZhbHVlcy5sZW5ndGggPT0gMSkgewogICAgICAgICAgICBjb25maWcudHlwZSA9IGJhc2lzLmZuLiRjb25zdCh2YWx1ZXNbMF0pOwogICAgICAgICAgICBjb25maWcuZGVmVmFsdWUgPSB2YWx1ZXNbMF07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25maWcudHlwZSA9IGZ1bmN0aW9uKHZhbHVlLCBvbGRWYWx1ZSkgewogICAgICAgICAgICAgIHZhciBleGlzdHMgPSB2YWx1ZXMuaW5kZXhPZih2YWx1ZSkgIT0gLTE7CiAgICAgICAgICAgICAgaWYgKCFleGlzdHMpIGJhc2lzLmRldi53YXJuKCJTZXQgdmFsdWUgdGhhdCBub3QgaW4gbGlzdCBmb3IgIiArIGVudGl0eVR5cGUubmFtZSArICIjZmllbGQuIiArIG5hbWUgKyAiIChuZXcgdmFsdWUgaWdub3JlZCkuXG5WYXJpYW50czoiLCB2YWx1ZXMsICJcbklnbm9yZWQgdmFsdWU6IiwgdmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBleGlzdHMgPyB2YWx1ZSA6IG9sZFZhbHVlOwogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25maWcuZGVmVmFsdWUgPSB2YWx1ZXMuaW5kZXhPZihjb25maWcuZGVmVmFsdWUpICE9IC0xID8gY29uZmlnLmRlZlZhbHVlIDogdmFsdWVzWzBdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoY29uZmlnLnR5cGUgPT09IEFycmF5KSBjb25maWcudHlwZSA9IGFycmF5RmllbGQ7CiAgICAgICAgaWYgKGNvbmZpZy50eXBlID09PSBEYXRlKSBjb25maWcudHlwZSA9IGRhdGVGaWVsZDsKICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy50eXBlICE9ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJFbnRpdHlUeXBlICIgKyBlbnRpdHlUeXBlLm5hbWUgKyAiOiBGaWVsZCB3cmFwcGVyIGZvciBgIiArIG5hbWUgKyAiYCBmaWVsZCBpcyBub3QgYSBmdW5jdGlvbi4gRmllbGQgd3JhcHBlciBoYXMgYmVlbiBpZ25vcmVkLiBXcmFwcGVyOiAiLCBjb25maWcudHlwZSk7CiAgICAgICAgICBjb25maWcudHlwZSA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciB3cmFwcGVyID0gY29uZmlnLnR5cGUgfHwgJHNlbGY7CiAgICAgIGlmIChjb25maWcuaWQgfHwgY29uZmlnLmluZGV4IHx8IFsgTnVtZXJpY0lkLCBOdW1iZXJJZCwgSW50SWQsIFN0cmluZ0lkIF0uaW5kZXhPZih3cmFwcGVyKSAhPSAtMSkgZW50aXR5VHlwZS5pZEZpZWxkc1tuYW1lXSA9IGNvbmZpZzsKICAgICAgaWYgKGNvbmZpZy5jYWxjKSB7CiAgICAgICAgYWRkQ2FsY0ZpZWxkKGVudGl0eVR5cGUsIG5hbWUsIGNvbmZpZy5jYWxjKTsKICAgICAgICBlbnRpdHlUeXBlLmZpZWxkc1tuYW1lXSA9IGNhbGNGaWVsZFdyYXBwZXI7CiAgICAgIH0gZWxzZSBlbnRpdHlUeXBlLmZpZWxkc1tuYW1lXSA9IHdyYXBwZXI7CiAgICAgIGVudGl0eVR5cGUuZGVmYXVsdHNbbmFtZV0gPSAiZGVmVmFsdWUiIGluIGNvbmZpZyA/IGNvbmZpZy5kZWZWYWx1ZSA6IHdyYXBwZXIoKTsKICAgICAgaWYgKCFmaWVsZERlc3Ryb3lIYW5kbGVyc1tuYW1lXSkgZmllbGREZXN0cm95SGFuZGxlcnNbbmFtZV0gPSB7CiAgICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLnNldChuYW1lLCBudWxsKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBhZGRGaWVsZEFsaWFzKGVudGl0eVR5cGUsIGFsaWFzLCBuYW1lKSB7CiAgICAgIGlmIChuYW1lIGluIGVudGl0eVR5cGUuZmllbGRzID09IGZhbHNlKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oIkNhbid0IGFkZCBhbGlhcyBgIiArIGFsaWFzICsgImAgZm9yIG5vbi1leGlzdHMgZmllbGQgYCIgKyBuYW1lICsgImAiKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKGFsaWFzIGluIGVudGl0eVR5cGUuYWxpYXNlcykgewogICAgICAgIGJhc2lzLmRldi53YXJuKCJBbGlhcyBgIiArIGFsaWFzICsgImAgYWxyZWFkeSBleGlzdHMiKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgZW50aXR5VHlwZS5hbGlhc2VzW2FsaWFzXSA9IG5hbWU7CiAgICB9CiAgICBmdW5jdGlvbiBhZGRDYWxjRmllbGQoZW50aXR5VHlwZSwgbmFtZSwgd3JhcHBlcikgewogICAgICBpZiAoIWVudGl0eVR5cGUuY2FsY3MpIGVudGl0eVR5cGUuY2FsY3MgPSBbXTsKICAgICAgdmFyIGNhbGNzID0gZW50aXR5VHlwZS5jYWxjczsKICAgICAgdmFyIGRlcHMgPSBlbnRpdHlUeXBlLmRlcHM7CiAgICAgIHZhciBjYWxjQXJncyA9IHdyYXBwZXIuYXJncyB8fCBbXTsKICAgICAgdmFyIGNhbGNDb25maWcgPSB7CiAgICAgICAgYXJnczogY2FsY0FyZ3MsCiAgICAgICAgd3JhcHBlcjogd3JhcHBlcgogICAgICB9OwogICAgICB2YXIgYmVmb3JlID0gZW50aXR5VHlwZS5jYWxjcy5sZW5ndGg7CiAgICAgIHZhciBhZnRlciA9IDA7CiAgICAgIGlmIChjYWxjQXJncykgZm9yICh2YXIgaSA9IDAsIGNhbGM7IGNhbGMgPSBjYWxjc1tpXTsgaSsrKSBpZiAoY2FsY0FyZ3MuaW5kZXhPZihjYWxjLmtleSkgIT0gLTEpIGFmdGVyID0gaSArIDE7CiAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgY2FsY0NvbmZpZy5rZXkgPSBuYW1lOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjYWxjOyBjYWxjID0gY2FsY3NbaV07IGkrKykgaWYgKGNhbGMuYXJncy5pbmRleE9mKG5hbWUpICE9IC0xKSB7CiAgICAgICAgICBiZWZvcmUgPSBpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGlmIChhZnRlciA+IGJlZm9yZSkgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIkNhbid0IGFkZCBjYWxjdWxhdGUgZmllbGQgYCIgKyBuYW1lICsgImAsIGJlY2F1c2UgcmVjdXJzaW9uIik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGRlcHNbbmFtZV0gPSBjYWxjQXJncy5yZWR1Y2UoZnVuY3Rpb24ocmVzLCByZWYpIHsKICAgICAgICAgIHZhciBpdGVtcyA9IGRlcHNbcmVmXSB8fCBbIHJlZiBdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykgYmFzaXMuYXJyYXkuYWRkKHJlcywgaXRlbXNbaV0pOwogICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICB9LCBbXSk7CiAgICAgICAgZm9yICh2YXIgcmVmIGluIGRlcHMpIHsKICAgICAgICAgIHZhciBpZHggPSBkZXBzW3JlZl0uaW5kZXhPZihuYW1lKTsKICAgICAgICAgIGlmIChpZHggIT0gLTEpIEFycmF5LnByb3RvdHlwZS5zcGxpY2UuYXBwbHkoZGVwc1tyZWZdLCBbIGlkeCwgMSBdLmNvbmNhdChkZXBzW25hbWVdKSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGJlZm9yZSA9IGFmdGVyOwogICAgICB9CiAgICAgIGNhbGNzLnNwbGljZShNYXRoLm1pbihiZWZvcmUsIGFmdGVyKSwgMCwgY2FsY0NvbmZpZyk7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRGaWVsZEdldHRlcihuYW1lKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihyZWFsKSB7CiAgICAgICAgaWYgKHJlYWwgJiYgdGhpcy5tb2RpZmllZCAmJiBuYW1lIGluIHRoaXMubW9kaWZpZWQpIHJldHVybiB0aGlzLm1vZGlmaWVkW25hbWVdOwogICAgICAgIHJldHVybiB0aGlzLmRhdGFbbmFtZV07CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBnZXRGaWVsZFNldHRlcihuYW1lKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSwgcm9sbGJhY2spIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXQobmFtZSwgdmFsdWUsIHJvbGxiYWNrKTsKICAgICAgfTsKICAgIH0KICAgIHZhciBFbnRpdHlUeXBlQ29uc3RydWN0b3IgPSBDbGFzcyhudWxsLCB7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5FbnRpdHlUeXBlIiwKICAgICAgd3JhcHBlcjogbnVsbCwKICAgICAgYWxsOiBudWxsLAogICAgICBmaWVsZHM6IG51bGwsCiAgICAgIGlkRmllbGQ6IG51bGwsCiAgICAgIGlkRmllbGRzOiBudWxsLAogICAgICBkZWZhdWx0czogbnVsbCwKICAgICAgYWxpYXNlczogbnVsbCwKICAgICAgc2xvdHM6IG51bGwsCiAgICAgIHNpbmdsZXRvbjogZmFsc2UsCiAgICAgIGluZGV4OiBudWxsLAogICAgICBpbmRleGVzOiBudWxsLAogICAgICBlbnRpdHlDbGFzczogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24oY29uZmlnLCB3cmFwcGVyKSB7CiAgICAgICAgdGhpcy5uYW1lID0gY29uZmlnLm5hbWU7CiAgICAgICAgaWYgKCF0aGlzLm5hbWUgfHwgbmFtZWRUeXBlc1t0aGlzLm5hbWVdKSB7CiAgICAgICAgICBpZiAobmFtZWRUeXBlc1t0aGlzLm5hbWVdKSBiYXNpcy5kZXYud2FybihuYW1lc3BhY2UgKyAiOiBEdXBsaWNhdGUgdHlwZSBuYW1lIGAiICsgdGhpcy5uYW1lICsgImAsIG5hbWUgaWdub3JlZCIpOwogICAgICAgICAgdGhpcy5uYW1lID0gZ2V0VW50aXRsZWROYW1lKCJVbnRpdGxlZEVudGl0eVR5cGUiKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5maWVsZHMgPSB7fTsKICAgICAgICB0aGlzLmRlcHMgPSB7fTsKICAgICAgICB0aGlzLmlkRmllbGRzID0ge307CiAgICAgICAgdGhpcy5kZWZhdWx0cyA9IHt9OwogICAgICAgIHRoaXMuYWxpYXNlcyA9IHt9OwogICAgICAgIHRoaXMuc2xvdHMgPSB7fTsKICAgICAgICB2YXIgaW5kZXggPSBjb25maWcuaW5kZXg7CiAgICAgICAgaWYgKGluZGV4KSB7CiAgICAgICAgICBpZiAoaW5kZXggaW5zdGFuY2VvZiBJbmRleCkgdGhpcy5pbmRleCA9IGluZGV4OyBlbHNlIGJhc2lzLmRldi53YXJuKCJpbmRleCBtdXN0IGJlIGluc3RhbmNlb2YgYmFzaXMuZW50aXR5LkluZGV4Iik7CiAgICAgICAgfQogICAgICAgIHRoaXMud3JhcHBlciA9IHdyYXBwZXI7CiAgICAgICAgaWYgKCJhbGwiIGluIGNvbmZpZyA9PSBmYWxzZSB8fCBjb25maWcuYWxsIHx8IGNvbmZpZy5zaW5nbGV0b24pIHRoaXMuYWxsID0gbmV3IFJlYWRPbmx5RW50aXR5U2V0KGJhc2lzLm9iamVjdC5jb21wbGV0ZSh7CiAgICAgICAgICB3cmFwcGVyOiB3cmFwcGVyCiAgICAgICAgfSwgY29uZmlnLmFsbCkpOwogICAgICAgIHRoaXMuc2luZ2xldG9uID0gISFjb25maWcuc2luZ2xldG9uOwogICAgICAgIGlmICh0aGlzLnNpbmdsZXRvbikgewogICAgICAgICAgdmFyIHNpbmdsZXRvbkluc3RhbmNlOwogICAgICAgICAgdGhpcy5nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHNpbmdsZXRvbkluc3RhbmNlOwogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMuYWxsLmFkZEhhbmRsZXIoewogICAgICAgICAgICBpdGVtc0NoYW5nZWQ6IGZ1bmN0aW9uKHNlbmRlciwgZGVsdGEpIHsKICAgICAgICAgICAgICBzaW5nbGV0b25JbnN0YW5jZSA9IGRlbHRhLmluc2VydGVkID8gZGVsdGEuaW5zZXJ0ZWRbMF0gOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9LCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIga2V5IGluIGNvbmZpZy5maWVsZHMpIGFkZEZpZWxkKHRoaXMsIGtleSwgY29uZmlnLmZpZWxkc1trZXldKTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gY29uZmlnLmFsaWFzZXMpIGFkZEZpZWxkQWxpYXModGhpcywga2V5LCBjb25maWcuYWxpYXNlc1trZXldKTsKICAgICAgICBpZiAoY29uZmlnLmNvbnN0cmFpbnMpIGNvbmZpZy5jb25zdHJhaW5zLmZvckVhY2goZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgYWRkQ2FsY0ZpZWxkKHRoaXMsIG51bGwsIGl0ZW0pOwogICAgICAgIH0sIHRoaXMpOwogICAgICAgIHZhciBpZEZpZWxkcyA9IGtleXModGhpcy5pZEZpZWxkcyk7CiAgICAgICAgdmFyIGluZGV4ZXMgPSB7fTsKICAgICAgICBpZiAoaWRGaWVsZHMubGVuZ3RoKSB7CiAgICAgICAgICBmb3IgKHZhciBmaWVsZCBpbiB0aGlzLmlkRmllbGRzKSB7CiAgICAgICAgICAgIHZhciBmaWVsZENmZyA9IHRoaXMuaWRGaWVsZHNbZmllbGRdOwogICAgICAgICAgICB2YXIgaW5kZXggPSBmaWVsZENmZy5pbmRleDsKICAgICAgICAgICAgdmFyIGluZGV4RGVzY3JpcHRvcjsKICAgICAgICAgICAgaWYgKCFpbmRleCB8fCBpbmRleCBpbnN0YW5jZW9mIEluZGV4ID09IGZhbHNlKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgaWYgKGluZGV4IGluIG5hbWVkSW5kZXhlcyA9PSBmYWxzZSkgbmFtZWRJbmRleGVzW2luZGV4XSA9IG5ldyBJbmRleDsKICAgICAgICAgICAgICAgIGluZGV4ID0gbmFtZWRJbmRleGVzW2luZGV4XTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmluZGV4KSB0aGlzLmluZGV4ID0gbmV3IEluZGV4OwogICAgICAgICAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpbmRleERlc2NyaXB0b3IgPSBpbmRleGVzW2luZGV4LmJhc2lzT2JqZWN0SWRdOwogICAgICAgICAgICBpZiAoIWluZGV4RGVzY3JpcHRvcikgaW5kZXhEZXNjcmlwdG9yID0gaW5kZXhlc1tpbmRleC5iYXNpc09iamVjdElkXSA9IHsKICAgICAgICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgICAgICAgZmllbGRzOiBbXQogICAgICAgICAgICB9OwogICAgICAgICAgICBpbmRleERlc2NyaXB0b3IuZmllbGRzLnB1c2goZmllbGQpOwogICAgICAgICAgICB0aGlzLmlkRmllbGRzW2ZpZWxkXSA9IGluZGV4RGVzY3JpcHRvcjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLmluZGV4ICYmIHRoaXMuaW5kZXguYmFzaXNPYmplY3RJZCBpbiBpbmRleGVzID09IGZhbHNlKSB7CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJiYXNpcy5lbnRpdHk6IGVudGl0eSBpbmRleCBpcyBub3QgdXNlZCBmb3IgYW55IGZpZWxkLCBpbmRleCBpZ25vcmVkIik7CiAgICAgICAgICAgIHRoaXMuaW5kZXggPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZm9yICh2YXIgaWQgaW4gaW5kZXhlcykgewogICAgICAgICAgICB2YXIgaW5kZXhEZXNjcmlwdG9yID0gaW5kZXhlc1tpZF07CiAgICAgICAgICAgIGluZGV4RGVzY3JpcHRvci5wcm9wZXJ0eSA9ICJfX2lkX18iICsgaWQ7CiAgICAgICAgICAgIGluZGV4RGVzY3JpcHRvci5jb21wb3NpdGVLZXkgPSBDb25jYXRTdHJpbmdGaWVsZC5hcHBseShudWxsLCBpbmRleERlc2NyaXB0b3IuZmllbGRzKTsKICAgICAgICAgICAgaWYgKGluZGV4RGVzY3JpcHRvci5maWVsZHMubGVuZ3RoID09IDEpIGluZGV4RGVzY3JpcHRvci5pZEZpZWxkID0gaW5kZXhEZXNjcmlwdG9yLmZpZWxkc1swXTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbmRleGVzS2V5cyA9IGtleXMoaW5kZXhlcyk7CiAgICAgICAgICB2YXIgcHJpbWFyeUluZGV4ID0gaW5kZXhlc1t0aGlzLmluZGV4ID8gdGhpcy5pbmRleC5iYXNpc09iamVjdElkIDogaW5kZXhlc0tleXNbMF1dOwogICAgICAgICAgdGhpcy5pbmRleCA9IHByaW1hcnlJbmRleC5pbmRleDsKICAgICAgICAgIHRoaXMuaWRGaWVsZCA9IHByaW1hcnlJbmRleC5pZEZpZWxkOwogICAgICAgICAgdGhpcy5jb21wb3NpdGVLZXkgPSBwcmltYXJ5SW5kZXguY29tcG9zaXRlS2V5OwogICAgICAgICAgdGhpcy5pZFByb3BlcnR5ID0gcHJpbWFyeUluZGV4LnByb3BlcnR5OwogICAgICAgICAgdGhpcy5pbmRleGVzID0gaW5kZXhlczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHRoaXMuaW5kZXgpIHsKICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLmVudGl0eTogZW50aXR5IGhhcyBubyBhbnkgaWQgZmllbGQsIGluZGV4IGlnbm9yZWQiKTsKICAgICAgICAgICAgdGhpcy5pbmRleCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpbml0RGVsdGEgPSB7fTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5kZWZhdWx0cykgaW5pdERlbHRhW2tleV0gPSB1bmRlZmluZWQ7CiAgICAgICAgdGhpcy5lbnRpdHlDbGFzcyA9IGNyZWF0ZUVudGl0eUNsYXNzKHRoaXMsIHRoaXMuYWxsLCB0aGlzLmZpZWxkcywgdGhpcy5zbG90cyk7CiAgICAgICAgdGhpcy5lbnRpdHlDbGFzcy5leHRlbmQoewogICAgICAgICAgZW50aXR5VHlwZTogdGhpcywKICAgICAgICAgIHR5cGU6IHdyYXBwZXIsCiAgICAgICAgICB0eXBlTmFtZTogdGhpcy5uYW1lLAogICAgICAgICAgc3RhdGU6IGNvbmZpZy5zdGF0ZSB8fCB0aGlzLmVudGl0eUNsYXNzLnByb3RvdHlwZS5zdGF0ZSwKICAgICAgICAgIGdlbmVyYXRlRGF0YTogZ2V0RGF0YUJ1aWxkZXIodGhpcy5kZWZhdWx0cywgdGhpcy5maWVsZHMpLAogICAgICAgICAgaW5pdERlbHRhOiBpbml0RGVsdGEKICAgICAgICB9KTsKICAgICAgICBmb3IgKHZhciBuYW1lIGluIHRoaXMuZmllbGRzKSB7CiAgICAgICAgICB0aGlzLmVudGl0eUNsYXNzLnByb3RvdHlwZVsiZ2V0XyIgKyBuYW1lXSA9IGdldEZpZWxkR2V0dGVyKG5hbWUpOwogICAgICAgICAgaWYgKHRoaXMuZmllbGRzW25hbWVdICE9PSBjYWxjRmllbGRXcmFwcGVyKSB0aGlzLmVudGl0eUNsYXNzLnByb3RvdHlwZVsic2V0XyIgKyBuYW1lXSA9IGdldEZpZWxkU2V0dGVyKG5hbWUpOwogICAgICAgIH0KICAgICAgICBlbnRpdHlUeXBlcy5wdXNoKHRoaXMpOwogICAgICB9LAogICAgICByZWFkZXI6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgICAgaWYgKGlzS2V5VHlwZVt0eXBlb2YgZGF0YV0pIHJldHVybiB0aGlzLmlkRmllbGQgPyBkYXRhIDogbnVsbDsKICAgICAgICBpZiAoIWRhdGEgfHwgZGF0YSA9PSBudWxsKSByZXR1cm4gbnVsbDsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgdmFyIGZpZWxkS2V5ID0gdGhpcy5hbGlhc2VzW2tleV07CiAgICAgICAgICBpZiAoZmllbGRLZXkpIHsKICAgICAgICAgICAgdmFyIHJlYWRlciA9IHRoaXMuZmllbGRzW2ZpZWxkS2V5XS5yZWFkZXI7CiAgICAgICAgICAgIHJlc3VsdFtmaWVsZEtleV0gPSByZWFkZXIgPyByZWFkZXIoZGF0YVtrZXldKSA6IGRhdGFba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbihlbnRpdHlPckRhdGEpIHsKICAgICAgICB2YXIgaWQgPSB0aGlzLmdldElkKGVudGl0eU9yRGF0YSk7CiAgICAgICAgaWYgKHRoaXMuaW5kZXggJiYgaWQgIT0gbnVsbCkgcmV0dXJuIHRoaXMuaW5kZXguZ2V0KGlkLCB0aGlzKTsKICAgICAgfSwKICAgICAgZ2V0SWQ6IGZ1bmN0aW9uKGVudGl0eU9yRGF0YSkgewogICAgICAgIGlmICh0aGlzLmNvbXBvc2l0ZUtleSAmJiBlbnRpdHlPckRhdGEgIT0gbnVsbCkgewogICAgICAgICAgaWYgKGlzS2V5VHlwZVt0eXBlb2YgZW50aXR5T3JEYXRhXSkgcmV0dXJuIGVudGl0eU9yRGF0YTsKICAgICAgICAgIGlmIChlbnRpdHlPckRhdGEgJiYgZW50aXR5T3JEYXRhLmVudGl0eVR5cGUgPT09IHRoaXMpIHJldHVybiBlbnRpdHlPckRhdGFbdGhpcy5pZFByb3BlcnR5XTsKICAgICAgICAgIGlmIChlbnRpdHlPckRhdGEgaW5zdGFuY2VvZiBEYXRhT2JqZWN0KSBlbnRpdHlPckRhdGEgPSBlbnRpdHlPckRhdGEuZGF0YTsKICAgICAgICAgIGlmICh0aGlzLmNvbXBvc2l0ZUtleSkgcmV0dXJuIHRoaXMuY29tcG9zaXRlS2V5KGVudGl0eU9yRGF0YSwgZW50aXR5T3JEYXRhKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldFNsb3Q6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB2YXIgaWQgPSB0aGlzLmdldElkKGRhdGEpOwogICAgICAgIGlmIChpZCAhPSBudWxsKSB7CiAgICAgICAgICB2YXIgc2xvdCA9IGhhc093blByb3BlcnR5LmNhbGwodGhpcy5zbG90cywgaWQpICYmIHRoaXMuc2xvdHNbaWRdOwogICAgICAgICAgaWYgKCFzbG90KSB7CiAgICAgICAgICAgIGlmIChpc0tleVR5cGVbdHlwZW9mIGRhdGFdKSB7CiAgICAgICAgICAgICAgdmFyIHRtcCA9IHt9OwogICAgICAgICAgICAgIGlmICh0aGlzLmlkRmllbGQpIHRtcFt0aGlzLmlkRmllbGRdID0gZGF0YTsKICAgICAgICAgICAgICBkYXRhID0gdG1wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNsb3QgPSB0aGlzLnNsb3RzW2lkXSA9IG5ldyBTbG90KHsKICAgICAgICAgICAgICBkZWxlZ2F0ZTogdGhpcy5nZXQoaWQpIHx8IG51bGwsCiAgICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzbG90OwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICBmdW5jdGlvbiBlbnRpdHlXYXJuKGVudGl0eSwgbWVzc2FnZSkgewogICAgICBiYXNpcy5kZXYud2FybigiW2Jhc2lzLmVudGl0eSAiICsgZW50aXR5LmVudGl0eVR5cGUubmFtZSArICIjIiArIGVudGl0eS5iYXNpc09iamVjdElkICsgIl0gIiArIG1lc3NhZ2UsIGVudGl0eSk7CiAgICB9CiAgICB2YXIgQmFzZUVudGl0eSA9IENsYXNzKERhdGFPYmplY3QsIHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkJhc2VFbnRpdHkiLAogICAgICB0YXJnZXQ6IHRydWUsCiAgICAgIHNldERlbGVnYXRlOiBmdW5jdGlvbigpIHt9LAogICAgICBleHRlbmRDb25zdHJ1Y3Rvcl86IGZhbHNlLAogICAgICBmaWVsZEhhbmRsZXJzXzogbnVsbCwKICAgICAgbW9kaWZpZWQ6IG51bGwsCiAgICAgIGVtaXRfcm9sbGJhY2tVcGRhdGU6IGNyZWF0ZUV2ZW50KCJyb2xsYmFja1VwZGF0ZSIpCiAgICB9KTsKICAgIHZhciBjcmVhdGVFbnRpdHlDbGFzcyA9IGZ1bmN0aW9uKGVudGl0eVR5cGUsIGFsbCwgZmllbGRzLCBzbG90cykgewogICAgICBmdW5jdGlvbiBjYWxjKGVudGl0eSwgZGVsdGEsIHJvbGxiYWNrRGVsdGEpIHsKICAgICAgICB2YXIgY2FsY3MgPSBlbnRpdHlUeXBlLmNhbGNzOwogICAgICAgIHZhciBkYXRhID0gZW50aXR5LmRhdGE7CiAgICAgICAgdmFyIHVwZGF0ZWQgPSBmYWxzZTsKICAgICAgICB0cnkgewogICAgICAgICAgaWYgKGNhbGNzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBjYWxjOyBjYWxjID0gY2FsY3NbaV07IGkrKykgewogICAgICAgICAgICAgIHZhciBrZXkgPSBjYWxjLmtleTsKICAgICAgICAgICAgICB2YXIgb2xkVmFsdWUgPSBkYXRhW2tleV07CiAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gY2FsYy53cmFwcGVyKGRlbHRhLCBkYXRhLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgaWYgKGtleSAmJiBuZXdWYWx1ZSAhPT0gb2xkVmFsdWUpIHsKICAgICAgICAgICAgICAgIGRlbHRhW2tleV0gPSBvbGRWYWx1ZTsKICAgICAgICAgICAgICAgIGRhdGFba2V5XSA9IG5ld1ZhbHVlOwogICAgICAgICAgICAgICAgdXBkYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpZCBpbiBlbnRpdHlUeXBlLmluZGV4ZXMpIHsKICAgICAgICAgICAgdmFyIGluZGV4RGVzY3JpcHRvciA9IGVudGl0eVR5cGUuaW5kZXhlc1tpZF07CiAgICAgICAgICAgIHZhciBjdXJJZCA9IGVudGl0eVtpbmRleERlc2NyaXB0b3IucHJvcGVydHldOwogICAgICAgICAgICB2YXIgbmV3SWQgPSBjdXJJZDsKICAgICAgICAgICAgaWYgKGluZGV4RGVzY3JpcHRvci5jb21wb3NpdGVLZXkpIG5ld0lkID0gaW5kZXhEZXNjcmlwdG9yLmNvbXBvc2l0ZUtleShkZWx0YSwgZGF0YSwgY3VySWQpOwogICAgICAgICAgICBpZiAobmV3SWQgIT09IGN1cklkKSB7CiAgICAgICAgICAgICAgdXBkYXRlSW5kZXgoaW5kZXhEZXNjcmlwdG9yLmluZGV4LCBlbnRpdHksIGN1cklkLCBuZXdJZCk7CiAgICAgICAgICAgICAgZW50aXR5W2luZGV4RGVzY3JpcHRvci5wcm9wZXJ0eV0gPSBuZXdJZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgZW50aXR5V2FybihlbnRpdHksICIocm9sbGJhY2sgY2hhbmdlcykgRXhjZXB0aW9uIG9uIGZpZWxkIGNhbGNzOiAiICsgKGUgJiYgZS5tZXNzYWdlIHx8IGUpKTsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkZWx0YSkgZW50aXR5LmRhdGFba2V5XSA9IGRlbHRhW2tleV07CiAgICAgICAgICBpZiAocm9sbGJhY2tEZWx0YSAmJiAhZW50aXR5Lm1vZGlmaWVkKSBlbnRpdHkubW9kaWZpZWQgPSByb2xsYmFja0RlbHRhOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiB1cGRhdGVJbmRleChpbmRleCwgZW50aXR5LCBjdXJWYWx1ZSwgbmV3VmFsdWUpIHsKICAgICAgICBpZiAobmV3VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgaW5kZXguYWRkKG5ld1ZhbHVlLCBlbnRpdHkpOwogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoc2xvdHMsIG5ld1ZhbHVlKSkgc2xvdHNbbmV3VmFsdWVdLnNldERlbGVnYXRlKGVudGl0eSk7CiAgICAgICAgfQogICAgICAgIGlmIChjdXJWYWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICBpbmRleC5yZW1vdmUoY3VyVmFsdWUsIGVudGl0eSk7CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzbG90cywgY3VyVmFsdWUpKSBzbG90c1tjdXJWYWx1ZV0uc2V0RGVsZWdhdGUoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIENsYXNzKEJhc2VFbnRpdHksIHsKICAgICAgICBjbGFzc05hbWU6IGVudGl0eVR5cGUubmFtZSwKICAgICAgICBpbml0OiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICB0aGlzLmRlbGVnYXRlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZGF0YSA9IHRoaXMuZ2VuZXJhdGVEYXRhKGRhdGEpOwogICAgICAgICAgQmFzZUVudGl0eS5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGEpIGlmIChrZXkgaW4gZmllbGRzID09IGZhbHNlKSBlbnRpdHlXYXJuKHRoaXMsICdGaWVsZCAiJyArIGtleSArICciIGlzIG5vdCBkZWZpbmVkLCB2YWx1ZSBoYXMgYmVlbiBpZ25vcmVkLicpOwogICAgICAgICAgdmFyIHZhbHVlOwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuZGF0YSkgewogICAgICAgICAgICB2YWx1ZSA9IHRoaXMuZGF0YVtrZXldOwogICAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUgIT09IHRoaXMgJiYgdmFsdWUgaW5zdGFuY2VvZiBFbWl0dGVyKSB7CiAgICAgICAgICAgICAgdmFsdWUuYWRkSGFuZGxlcihmaWVsZERlc3Ryb3lIYW5kbGVyc1trZXldLCB0aGlzKTsKICAgICAgICAgICAgICBpZiAoIXRoaXMuZmllbGRIYW5kbGVyc18pIHRoaXMuZmllbGRIYW5kbGVyc18gPSB7fTsKICAgICAgICAgICAgICB0aGlzLmZpZWxkSGFuZGxlcnNfW2tleV0gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjYWxjKHRoaXMsIHRoaXMuaW5pdERlbHRhKTsKICAgICAgICAgIGlmIChhbGwpIGFsbC5lbWl0X2l0ZW1zQ2hhbmdlZCh7CiAgICAgICAgICAgIGluc2VydGVkOiBbIHRoaXMgXQogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gIltvYmplY3QgIiArIHRoaXMuY29uc3RydWN0b3IuY2xhc3NOYW1lICsgIigiICsgdGhpcy5lbnRpdHlUeXBlLm5hbWUgKyAiKV0iOwogICAgICAgIH0sCiAgICAgICAgZ2V0SWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIHRoaXNbZW50aXR5VHlwZS5pZFByb3BlcnR5XTsKICAgICAgICB9LAogICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCByZWFsKSB7CiAgICAgICAgICBpZiAocmVhbCAmJiB0aGlzLm1vZGlmaWVkICYmIGtleSBpbiB0aGlzLm1vZGlmaWVkKSByZXR1cm4gdGhpcy5tb2RpZmllZFtrZXldOwogICAgICAgICAgcmV0dXJuIHRoaXMuZGF0YVtrZXldOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlLCByb2xsYmFjaywgc2lsZW50XykgewogICAgICAgICAgdmFyIHZhbHVlV3JhcHBlciA9IGZpZWxkc1trZXldOwogICAgICAgICAgaWYgKCF2YWx1ZVdyYXBwZXIpIHsKICAgICAgICAgICAgZW50aXR5V2Fybih0aGlzLCAnRmllbGQgIicgKyBrZXkgKyAnIiBpcyBub3QgZGVmaW5lZCwgdmFsdWUgaGFzIGJlZW4gaWdub3JlZC4nKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICAgIHZhciByb2xsYmFja0RhdGEgPSB0aGlzLm1vZGlmaWVkOwogICAgICAgICAgaWYgKHZhbHVlV3JhcHBlciA9PT0gYXJyYXlGaWVsZCAmJiByb2xsYmFja0RhdGEgJiYga2V5IGluIHJvbGxiYWNrRGF0YSkgdmFsdWUgPSBhcnJheUZpZWxkKHZhbHVlLCByb2xsYmFja0RhdGFba2V5XSk7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSB2YWx1ZVdyYXBwZXIodmFsdWUsIHRoaXMuZGF0YVtrZXldKTsKICAgICAgICAgIHZhciBjdXJWYWx1ZSA9IHRoaXMuZGF0YVtrZXldOwogICAgICAgICAgdmFyIHZhbHVlQ2hhbmdlZCA9IG5ld1ZhbHVlICE9PSBjdXJWYWx1ZSAmJiAoIW5ld1ZhbHVlIHx8ICFjdXJWYWx1ZSB8fCBuZXdWYWx1ZS5jb25zdHJ1Y3RvciAhPT0gRGF0ZSB8fCBjdXJWYWx1ZS5jb25zdHJ1Y3RvciAhPT0gRGF0ZSB8fCArbmV3VmFsdWUgIT09ICtjdXJWYWx1ZSk7CiAgICAgICAgICBpZiAodmFsdWVDaGFuZ2VkKSB1cGRhdGVGaWVsZCA6IHsKICAgICAgICAgICAgcmVzdWx0ID0ge307CiAgICAgICAgICAgIGlmICghZW50aXR5VHlwZS5pZEZpZWxkc1trZXldKSB7CiAgICAgICAgICAgICAgaWYgKHJvbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBpZiAoIXJvbGxiYWNrRGF0YSkgdGhpcy5tb2RpZmllZCA9IHJvbGxiYWNrRGF0YSA9IHt9OwogICAgICAgICAgICAgICAgaWYgKGtleSBpbiByb2xsYmFja0RhdGEgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdC5yb2xsYmFjayA9IHsKICAgICAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHJvbGxiYWNrRGF0YVtrZXldID0gY3VyVmFsdWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAocm9sbGJhY2tEYXRhW2tleV0gPT09IG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJvbGxiYWNrID0gewogICAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbmV3VmFsdWUKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSByb2xsYmFja0RhdGFba2V5XTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWtleXMocm9sbGJhY2tEYXRhKS5sZW5ndGgpIHRoaXMubW9kaWZpZWQgPSBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChyb2xsYmFja0RhdGEgJiYga2V5IGluIHJvbGxiYWNrRGF0YSkgewogICAgICAgICAgICAgICAgICBpZiAocm9sbGJhY2tEYXRhW2tleV0gIT09IG5ld1ZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnJvbGxiYWNrID0gewogICAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcm9sbGJhY2tEYXRhW2tleV0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIHJvbGxiYWNrRGF0YVtrZXldID0gbmV3VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgdXBkYXRlRmllbGQ7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZGF0YVtrZXldID0gbmV3VmFsdWU7CiAgICAgICAgICAgIGlmICh0aGlzLmZpZWxkSGFuZGxlcnNfICYmIHRoaXMuZmllbGRIYW5kbGVyc19ba2V5XSkgewogICAgICAgICAgICAgIGN1clZhbHVlLnJlbW92ZUhhbmRsZXIoZmllbGREZXN0cm95SGFuZGxlcnNba2V5XSwgdGhpcyk7CiAgICAgICAgICAgICAgdGhpcy5maWVsZEhhbmRsZXJzX1trZXldID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld1ZhbHVlICYmIG5ld1ZhbHVlICE9PSB0aGlzICYmIG5ld1ZhbHVlIGluc3RhbmNlb2YgRW1pdHRlcikgewogICAgICAgICAgICAgIG5ld1ZhbHVlLmFkZEhhbmRsZXIoZmllbGREZXN0cm95SGFuZGxlcnNba2V5XSwgdGhpcyk7CiAgICAgICAgICAgICAgaWYgKCF0aGlzLmZpZWxkSGFuZGxlcnNfKSB0aGlzLmZpZWxkSGFuZGxlcnNfID0ge307CiAgICAgICAgICAgICAgdGhpcy5maWVsZEhhbmRsZXJzX1trZXldID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHQua2V5ID0ga2V5OwogICAgICAgICAgICByZXN1bHQudmFsdWUgPSBjdXJWYWx1ZTsKICAgICAgICAgICAgcmVzdWx0LmRlbHRhID0ge307CiAgICAgICAgICAgIHJlc3VsdC5kZWx0YVtrZXldID0gY3VyVmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoIXJvbGxiYWNrICYmIHJvbGxiYWNrRGF0YSAmJiBrZXkgaW4gcm9sbGJhY2tEYXRhKSB7CiAgICAgICAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgICAgICAgcm9sbGJhY2s6IHsKICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgIHZhbHVlOiByb2xsYmFja0RhdGFba2V5XQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgZGVsZXRlIHJvbGxiYWNrRGF0YVtrZXldOwogICAgICAgICAgICAgIGlmICgha2V5cyhyb2xsYmFja0RhdGEpLmxlbmd0aCkgdGhpcy5tb2RpZmllZCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghc2lsZW50XyAmJiByZXN1bHQpIHsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IHJlc3VsdC5rZXk7CiAgICAgICAgICAgIHZhciBkZWx0YSA9IHJlc3VsdC5kZWx0YSB8fCB7fTsKICAgICAgICAgICAgdmFyIHJvbGxiYWNrRGVsdGE7CiAgICAgICAgICAgIGlmIChyZXN1bHQucm9sbGJhY2spIHsKICAgICAgICAgICAgICByb2xsYmFja0RlbHRhID0ge307CiAgICAgICAgICAgICAgcm9sbGJhY2tEZWx0YVtyZXN1bHQucm9sbGJhY2sua2V5XSA9IHJlc3VsdC5yb2xsYmFjay52YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2FsYyh0aGlzLCBkZWx0YSwgcm9sbGJhY2tEZWx0YSkpIHVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGlmICh1cGRhdGUpIHsKICAgICAgICAgICAgICB0aGlzLmVtaXRfdXBkYXRlKGRlbHRhKTsKICAgICAgICAgICAgICByZXN1bHQuZGVsdGEgPSBkZWx0YTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocm9sbGJhY2tEZWx0YSkgdGhpcy5lbWl0X3JvbGxiYWNrVXBkYXRlKHJvbGxiYWNrRGVsdGEpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdCB8fCBmYWxzZTsKICAgICAgICB9LAogICAgICAgIHVwZGF0ZTogZnVuY3Rpb24oZGF0YSwgcm9sbGJhY2spIHsKICAgICAgICAgIHZhciB1cGRhdGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBkZWx0YSA9IHt9OwogICAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgICAgdmFyIHJvbGxiYWNrRGVsdGE7CiAgICAgICAgICAgIHZhciBzZXRSZXN1bHQ7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkYXRhKSB7CiAgICAgICAgICAgICAgaWYgKHNldFJlc3VsdCA9IHRoaXMuc2V0KGtleSwgZGF0YVtrZXldLCByb2xsYmFjaywgdHJ1ZSkpIHsKICAgICAgICAgICAgICAgIGlmIChzZXRSZXN1bHQua2V5KSB7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGRlbHRhW3NldFJlc3VsdC5rZXldID0gc2V0UmVzdWx0LnZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHNldFJlc3VsdC5yb2xsYmFjaykgewogICAgICAgICAgICAgICAgICBpZiAoIXJvbGxiYWNrRGVsdGEpIHJvbGxiYWNrRGVsdGEgPSB7fTsKICAgICAgICAgICAgICAgICAgcm9sbGJhY2tEZWx0YVtzZXRSZXN1bHQucm9sbGJhY2sua2V5XSA9IHNldFJlc3VsdC5yb2xsYmFjay52YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNhbGModGhpcywgZGVsdGEsIHJvbGxiYWNrRGVsdGEpKSB1cGRhdGUgPSB0cnVlOwogICAgICAgICAgICBpZiAodXBkYXRlKSB0aGlzLmVtaXRfdXBkYXRlKGRlbHRhKTsKICAgICAgICAgICAgaWYgKHJvbGxiYWNrRGVsdGEpIHRoaXMuZW1pdF9yb2xsYmFja1VwZGF0ZShyb2xsYmFja0RlbHRhKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGUgPyBkZWx0YSA6IGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgZ2VuZXJhdGVEYXRhOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB7fTsKICAgICAgICB9LAogICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMudXBkYXRlKHRoaXMuZ2VuZXJhdGVEYXRhKHt9KSk7CiAgICAgICAgfSwKICAgICAgICBjbGVhcjogZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgZGF0YSA9IHt9OwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuZGF0YSkgZGF0YVtrZXldID0gdW5kZWZpbmVkOwogICAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlKGRhdGEpOwogICAgICAgIH0sCiAgICAgICAgY29tbWl0OiBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICB2YXIgcm9sbGJhY2tEYXRhID0gdGhpcy5tb2RpZmllZDsKICAgICAgICAgIHRoaXMubW9kaWZpZWQgPSBudWxsOwogICAgICAgICAgaWYgKGRhdGEpIHRoaXMudXBkYXRlKGRhdGEpOwogICAgICAgICAgaWYgKHJvbGxiYWNrRGF0YSkgdGhpcy5lbWl0X3JvbGxiYWNrVXBkYXRlKHJvbGxiYWNrRGF0YSk7CiAgICAgICAgfSwKICAgICAgICByb2xsYmFjazogZnVuY3Rpb24oa2V5cykgewogICAgICAgICAgdmFyIHJvbGxiYWNrRGF0YSA9IHRoaXMubW9kaWZpZWQ7CiAgICAgICAgICBpZiAocm9sbGJhY2tEYXRhICYmIGtleXMpIHsKICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGtleXMpKSBrZXlzID0gWyBrZXlzIF07CiAgICAgICAgICAgIHJvbGxiYWNrRGF0YSA9IGJhc2lzLm9iamVjdC5zbGljZShyb2xsYmFja0RhdGEsIGtleXMucmVkdWNlKGZ1bmN0aW9uKHJlcywgaXRlbSkgewogICAgICAgICAgICAgIHJldHVybiByZXMuY29uY2F0KGVudGl0eVR5cGUuZGVwc1tpdGVtXSB8fCBpdGVtKTsKICAgICAgICAgICAgfSwgW10pKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMudXBkYXRlKHJvbGxiYWNrRGF0YSwgdHJ1ZSk7CiAgICAgICAgfSwKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmICh0aGlzLmZpZWxkSGFuZGxlcnNfKSB7CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmZpZWxkSGFuZGxlcnNfKSBpZiAodGhpcy5maWVsZEhhbmRsZXJzX1trZXldKSB0aGlzLmRhdGFba2V5XS5yZW1vdmVIYW5kbGVyKGZpZWxkRGVzdHJveUhhbmRsZXJzW2tleV0sIHRoaXMpOwogICAgICAgICAgICB0aGlzLmZpZWxkSGFuZGxlcnNfID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGtleSBpbiBlbnRpdHlUeXBlLmluZGV4ZXMpIHsKICAgICAgICAgICAgdmFyIGluZGV4RGVzY3JpcHRvciA9IGVudGl0eVR5cGUuaW5kZXhlc1trZXldOwogICAgICAgICAgICB2YXIgaWQgPSB0aGlzW2luZGV4RGVzY3JpcHRvci5wcm9wZXJ0eV07CiAgICAgICAgICAgIGlmIChpZCAhPSBudWxsKSB1cGRhdGVJbmRleChpbmRleERlc2NyaXB0b3IuaW5kZXgsIHRoaXMsIGlkLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhbGwgJiYgYWxsLmhhcyh0aGlzKSkgYWxsLmVtaXRfaXRlbXNDaGFuZ2VkKHsKICAgICAgICAgICAgZGVsZXRlZDogWyB0aGlzIF0KICAgICAgICAgIH0pOwogICAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICAgICAgdGhpcy5kYXRhID0gTlVMTF9JTkZPOwogICAgICAgICAgdGhpcy5tb2RpZmllZCA9IG51bGw7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CiAgICBmdW5jdGlvbiBpc0VudGl0eSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgJiYgdmFsdWUgaW5zdGFuY2VvZiBCYXNlRW50aXR5OwogICAgfQogICAgZnVuY3Rpb24gY3JlYXRlVHlwZShjb25maWdPck5hbWUsIGZpZWxkcykgewogICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIGNyZWF0ZVR5cGUpIGJhc2lzLmRldi53YXJuKCJgbmV3YCBvcGVyYXRvciB3YXMgdXNlZCB3aXRoIGJhc2lzLmVudGl0eS5jcmVhdGVUeXBlLCBpdCdzIGEgbWlzdGFrZSIpOwogICAgICB2YXIgY29uZmlnID0gY29uZmlnT3JOYW1lIHx8IHt9OwogICAgICBpZiAodHlwZW9mIGNvbmZpZ09yTmFtZSA9PSAic3RyaW5nIikgewogICAgICAgIGNvbmZpZyA9IHsKICAgICAgICAgIG5hbWU6IGNvbmZpZywKICAgICAgICAgIGZpZWxkczogZmllbGRzIHx8IHt9CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZmllbGRzKSBjb25maWcgPSBiYXNpcy5vYmplY3QubWVyZ2UoY29uZmlnLCB7CiAgICAgICAgICBmaWVsZHM6IGZpZWxkcwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgRW50aXR5VHlwZVdyYXBwZXIoY29uZmlnKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNyZWF0ZVNldFR5cGUobmFtZU9yV3JhcHBlciwgd3JhcHBlcikgewogICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIGNyZWF0ZVNldFR5cGUpIGJhc2lzLmRldi53YXJuKCJgbmV3YCBvcGVyYXRvciB3YXMgdXNlZCB3aXRoIGJhc2lzLmVudGl0eS5jcmVhdGVTZXRUeXBlLCBpdCdzIGEgbWlzdGFrZSIpOwogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBuZXcgRW50aXR5U2V0V3JhcHBlcih3cmFwcGVyLCBuYW1lT3JXcmFwcGVyKSA6IG5ldyBFbnRpdHlTZXRXcmFwcGVyKG5hbWVPcldyYXBwZXIpOwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGlzRW50aXR5OiBpc0VudGl0eSwKICAgICAgY3JlYXRlVHlwZTogY3JlYXRlVHlwZSwKICAgICAgY3JlYXRlU2V0VHlwZTogY3JlYXRlU2V0VHlwZSwKICAgICAgdmFsaWRhdGU6IHZhbGlkYXRlU2NoZW1lLAogICAgICBnZXRUeXBlQnlOYW1lOiBmdW5jdGlvbih0eXBlTmFtZSkgewogICAgICAgIHJldHVybiBuYW1lZFR5cGVzW3R5cGVOYW1lXTsKICAgICAgfSwKICAgICAgZ2V0SW5kZXhCeU5hbWU6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICByZXR1cm4gbmFtZWRJbmRleGVzW25hbWVdOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKHR5cGVOYW1lLCB2YWx1ZSkgewogICAgICAgIHZhciBUeXBlID0gbmFtZWRUeXBlc1t0eXBlTmFtZV07CiAgICAgICAgaWYgKFR5cGUpIHJldHVybiBUeXBlLmdldCh2YWx1ZSk7CiAgICAgIH0sCiAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKHR5cGVOYW1lLCB2YWx1ZSkgewogICAgICAgIHZhciBUeXBlID0gbmFtZWRUeXBlc1t0eXBlTmFtZV07CiAgICAgICAgaWYgKFR5cGUpIHJldHVybiBUeXBlKHZhbHVlKTsKICAgICAgfSwKICAgICAgZ2V0QnlJbmRleDogZnVuY3Rpb24oaW5kZXhOYW1lLCBpZCkgewogICAgICAgIGlmIChpbmRleE5hbWUgaW4gbmFtZWRJbmRleGVzKSByZXR1cm4gbmFtZWRJbmRleGVzW2luZGV4TmFtZV0uZ2V0KGlkKTsgZWxzZSBiYXNpcy5kZXYud2FybigiYmFzaXMuZW50aXR5OiBpbmRleCB3aXRoIG5hbWUgYCIgKyBpbmRleE5hbWUgKyAiYCBkb2Vzbid0IGV4aXN0cyIpOwogICAgICB9LAogICAgICBOdW1lcmljSWQ6IE51bWVyaWNJZCwKICAgICAgTnVtYmVySWQ6IE51bWJlcklkLAogICAgICBJbnRJZDogSW50SWQsCiAgICAgIFN0cmluZ0lkOiBTdHJpbmdJZCwKICAgICAgSW5kZXg6IEluZGV4LAogICAgICBDYWxjdWxhdGVGaWVsZDogQ2FsY3VsYXRlRmllbGQsCiAgICAgIENvbmNhdFN0cmluZ0ZpZWxkOiBDb25jYXRTdHJpbmdGaWVsZCwKICAgICAgY2FsYzogQ2FsY3VsYXRlRmllbGQsCiAgICAgIEVudGl0eVR5cGU6IEVudGl0eVR5cGVXcmFwcGVyLAogICAgICBFbnRpdHk6IGNyZWF0ZUVudGl0eUNsYXNzLAogICAgICBCYXNlRW50aXR5OiBCYXNlRW50aXR5LAogICAgICBFbnRpdHlTZXRUeXBlOiBFbnRpdHlTZXRXcmFwcGVyLAogICAgICBFbnRpdHlTZXQ6IEVudGl0eVNldCwKICAgICAgUmVhZE9ubHlFbnRpdHlTZXQ6IFJlYWRPbmx5RW50aXR5U2V0LAogICAgICBDb2xsZWN0aW9uOiBFbnRpdHlDb2xsZWN0aW9uLAogICAgICBHcm91cGluZzogRW50aXR5R3JvdXBpbmcKICAgIH07CiAgfSwKICAiaS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi9qLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLnBhdGg7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgZXNjYXBlVmFsdWUgPSBnbG9iYWwuZW5jb2RlVVJJQ29tcG9uZW50OwogICAgdmFyIGV4dGVuZCA9IGJhc2lzLm9iamVjdC5leHRlbmQ7CiAgICB2YXIgb2JqZWN0U2xpY2UgPSBiYXNpcy5vYmplY3Quc2xpY2U7CiAgICB2YXIgb2JqZWN0TWVyZ2UgPSBiYXNpcy5vYmplY3QubWVyZ2U7CiAgICB2YXIgY3JlYXRlVHJhbnNwb3J0RXZlbnQgPSBiYXNpcy5uZXQuY3JlYXRlVHJhbnNwb3J0RXZlbnQ7CiAgICB2YXIgY3JlYXRlUmVxdWVzdEV2ZW50ID0gYmFzaXMubmV0LmNyZWF0ZVJlcXVlc3RFdmVudDsKICAgIHZhciBBYnN0cmFjdFJlcXVlc3QgPSBiYXNpcy5uZXQuQWJzdHJhY3RSZXF1ZXN0OwogICAgdmFyIEFic3RyYWN0VHJhbnNwb3J0ID0gYmFzaXMubmV0LkFic3RyYWN0VHJhbnNwb3J0OwogICAgdmFyIFNUQVRFID0gYmFzaXMuZGF0YS5TVEFURTsKICAgIHZhciBTVEFURV9VTlNFTlQgPSAwOwogICAgdmFyIFNUQVRFX09QRU5FRCA9IDE7CiAgICB2YXIgU1RBVEVfTE9BRElORyA9IDM7CiAgICB2YXIgU1RBVEVfRE9ORSA9IDQ7CiAgICB2YXIgY2FsbGJhY2tEYXRhID0ge307CiAgICBmdW5jdGlvbiBnZXRDYWxsYmFjaygpIHsKICAgICAgdmFyIG5hbWUgPSAiYmFzaXNqc0pzb25wQ2FsbGJhY2siICsgcGFyc2VJbnQoTWF0aC5yYW5kb20oKSAqIDFlMTEpOwogICAgICBnbG9iYWxbbmFtZV0gPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgY2FsbGJhY2tEYXRhW25hbWVdID0gZGF0YTsKICAgICAgfTsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CiAgICBmdW5jdGlvbiBmZXRjaENhbGxiYWNrRGF0YShuYW1lKSB7CiAgICAgIHZhciBkYXRhID0gY2FsbGJhY2tEYXRhW25hbWVdOwogICAgICBkZWxldGUgY2FsbGJhY2tEYXRhW25hbWVdOwogICAgICByZXR1cm4gZGF0YTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlbGVhc2VDYWxsYmFjayhuYW1lKSB7CiAgICAgIGRlbGV0ZSBjYWxsYmFja0RhdGFbbmFtZV07CiAgICAgIGRlbGV0ZSBnbG9iYWxbbmFtZV07CiAgICB9CiAgICBmdW5jdGlvbiByZWFkeVN0YXRlQ2hhbmdlSGFuZGxlcihyZWFkeVN0YXRlLCBhYm9ydCkgewogICAgICB2YXIgbmV3U3RhdGU7CiAgICAgIHZhciBuZXdTdGF0ZURhdGE7CiAgICAgIHZhciBlcnJvciA9IGZhbHNlOwogICAgICBpZiAodHlwZW9mIHJlYWR5U3RhdGUgIT0gIm51bWJlciIpIHsKICAgICAgICBpZiAoIXJlYWR5U3RhdGUgfHwgdGhpcy5zY3JpcHQgIT09IHJlYWR5U3RhdGUudGFyZ2V0KSByZXR1cm47CiAgICAgICAgZXJyb3IgPSByZWFkeVN0YXRlICYmIHJlYWR5U3RhdGUudHlwZSA9PSAiZXJyb3IiOwogICAgICAgIHJlYWR5U3RhdGUgPSBlcnJvciB8fCAhdGhpcy5zY3JpcHQucmVhZHlTdGF0ZSB8fCAvbG9hZGVkfGNvbXBsZXRlLy50ZXN0KHRoaXMuc2NyaXB0LnJlYWR5U3RhdGUpID8gU1RBVEVfRE9ORSA6IFNUQVRFX0xPQURJTkc7CiAgICAgIH0KICAgICAgaWYgKHJlYWR5U3RhdGUgPT0gdGhpcy5wcmV2UmVhZHlTdGF0ZV8pIHJldHVybjsKICAgICAgdGhpcy5wcmV2UmVhZHlTdGF0ZV8gPSByZWFkeVN0YXRlOwogICAgICB0aGlzLmVtaXRfcmVhZHlTdGF0ZUNoYW5nZWQocmVhZHlTdGF0ZSk7CiAgICAgIGlmIChyZWFkeVN0YXRlID09IFNUQVRFX0RPTkUpIHsKICAgICAgICB0aGlzLmNsZWFyVGltZW91dCgpOwogICAgICAgIHRoaXMuc2NyaXB0Lm9ubG9hZCA9IHRoaXMuc2NyaXB0Lm9uZXJyb3IgPSB0aGlzLnNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwogICAgICAgIGlmICh0aGlzLnNjcmlwdC5wYXJlbnROb2RlKSB0aGlzLnNjcmlwdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMuc2NyaXB0KTsKICAgICAgICB0aGlzLnNjcmlwdCA9IG51bGw7CiAgICAgICAgaWYgKGFib3J0KSB7CiAgICAgICAgICB0aGlzLmVtaXRfYWJvcnQoKTsKICAgICAgICAgIG5ld1N0YXRlID0gdGhpcy5zdGF0ZU9uQWJvcnQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMucHJvY2Vzc1Jlc3BvbnNlKCk7CiAgICAgICAgICBpZiAodGhpcy5pc1N1Y2Nlc3NmdWwoKSAmJiAhZXJyb3IpIHsKICAgICAgICAgICAgbmV3U3RhdGUgPSBTVEFURS5SRUFEWTsKICAgICAgICAgICAgdGhpcy5lbWl0X3N1Y2Nlc3ModGhpcy5nZXRSZXNwb25zZURhdGEoKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdTdGF0ZSA9IFNUQVRFLkVSUk9SOwogICAgICAgICAgICBuZXdTdGF0ZURhdGEgPSB0aGlzLmdldFJlc3BvbnNlRXJyb3IoKTsKICAgICAgICAgICAgdGhpcy5lbWl0X2ZhaWx1cmUobmV3U3RhdGVEYXRhKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGhpcy5lbWl0X2NvbXBsZXRlKHRoaXMpOwogICAgICAgIHZhciBjYWxsYmFjayA9IHRoaXMuY2FsbGJhY2s7CiAgICAgICAgaWYgKGFib3J0KSB7CiAgICAgICAgICBzZXRUaW1lb3V0KGdsb2JhbFtjYWxsYmFja10gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmVsZWFzZUNhbGxiYWNrKGNhbGxiYWNrKTsKICAgICAgICAgIH0sIDUgKiA2MCAqIDFlMyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlbGVhc2VDYWxsYmFjayhjYWxsYmFjayk7CiAgICAgICAgfQogICAgICB9IGVsc2UgbmV3U3RhdGUgPSBTVEFURS5QUk9DRVNTSU5HOwogICAgICB0aGlzLnNldFN0YXRlKG5ld1N0YXRlLCBuZXdTdGF0ZURhdGEpOwogICAgfQogICAgdmFyIFJlcXVlc3QgPSBBYnN0cmFjdFJlcXVlc3Quc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuUmVxdWVzdCIsCiAgICAgIHRpbWVvdXQ6IDNlNCwKICAgICAgdGltZXJfOiBudWxsLAogICAgICBlbWl0X3JlYWR5U3RhdGVDaGFuZ2VkOiBjcmVhdGVSZXF1ZXN0RXZlbnQoInJlYWR5U3RhdGVDaGFuZ2VkIiksCiAgICAgIGlzSWRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICF0aGlzLnNjcmlwdDsKICAgICAgfSwKICAgICAgaXNTdWNjZXNzZnVsOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5kYXRhLnN0YXR1cyA9PSAyMDA7CiAgICAgIH0sCiAgICAgIHByb2Nlc3NSZXNwb25zZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuY2FsbGJhY2sgaW4gY2FsbGJhY2tEYXRhKSB0aGlzLnVwZGF0ZSh7CiAgICAgICAgICBjb250ZW50VHlwZTogImFwcGxpY2F0aW9uL2phdmFzY3JpcHQiLAogICAgICAgICAgZGF0YTogZmV0Y2hDYWxsYmFja0RhdGEodGhpcy5jYWxsYmFjayksCiAgICAgICAgICBzdGF0dXM6IDIwMAogICAgICAgIH0pOwogICAgICB9LAogICAgICBnZXRSZXNwb25zZURhdGE6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmRhdGEuZGF0YTsKICAgICAgfSwKICAgICAgZ2V0UmVzcG9uc2VFcnJvcjogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGNvZGU6ICJFUlJPUiIsCiAgICAgICAgICBtc2c6ICJFUlJPUiIKICAgICAgICB9OwogICAgICB9LAogICAgICBwcmVwYXJlOiBiYXNpcy5mbi4kdHJ1ZSwKICAgICAgcHJlcGFyZVJlcXVlc3REYXRhOiBmdW5jdGlvbihyZXF1ZXN0RGF0YSkgewogICAgICAgIHZhciBwYXJhbXMgPSBbXTsKICAgICAgICB2YXIgdXJsID0gcmVxdWVzdERhdGEudXJsOwogICAgICAgIHJlcXVlc3REYXRhID0gb2JqZWN0U2xpY2UocmVxdWVzdERhdGEpOwogICAgICAgIHRoaXMuY2FsbGJhY2sgPSBnZXRDYWxsYmFjaygpOwogICAgICAgIGZvciAodmFyIGtleSBpbiByZXF1ZXN0RGF0YS5wYXJhbXMpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHJlcXVlc3REYXRhLnBhcmFtc1trZXldOwogICAgICAgICAgaWYgKHZhbHVlID09IG51bGwgfHwgdmFsdWUudG9TdHJpbmcoKSA9PSBudWxsKSBjb250aW51ZTsKICAgICAgICAgIHBhcmFtcy5wdXNoKGVzY2FwZVZhbHVlKGtleSkgKyAiPSIgKyBlc2NhcGVWYWx1ZSh2YWx1ZS50b1N0cmluZygpKSk7CiAgICAgICAgfQogICAgICAgIHBhcmFtcy5wdXNoKGVzY2FwZVZhbHVlKHJlcXVlc3REYXRhLmNhbGxiYWNrUGFyYW0pICsgIj0iICsgZXNjYXBlVmFsdWUodGhpcy5jYWxsYmFjaykpOwogICAgICAgIHBhcmFtcyA9IHBhcmFtcy5qb2luKCImIik7CiAgICAgICAgaWYgKHJlcXVlc3REYXRhLnJvdXRlclBhcmFtcykgdXJsID0gdXJsLnJlcGxhY2UoLzooW2EtelxfXC1dW2EtejAtOVxfXC1dKykvZ2ksIGZ1bmN0aW9uKG0sIGtleSkgewogICAgICAgICAgaWYgKGtleSBpbiByZXF1ZXN0RGF0YS5yb3V0ZXJQYXJhbXMpIHJldHVybiByZXF1ZXN0RGF0YS5yb3V0ZXJQYXJhbXNba2V5XTsgZWxzZSByZXR1cm4gbTsKICAgICAgICB9KTsKICAgICAgICBpZiAocGFyYW1zKSB1cmwgKz0gKHVybC5pbmRleE9mKCI/IikgPT0gLTEgPyAiPyIgOiAiJiIpICsgcGFyYW1zOwogICAgICAgIHJlcXVlc3REYXRhLnJlcXVlc3RVcmwgPSB1cmw7CiAgICAgICAgcmV0dXJuIHJlcXVlc3REYXRhOwogICAgICB9LAogICAgICBkb1JlcXVlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuc2VuZCh0aGlzLnByZXBhcmVSZXF1ZXN0RGF0YSh0aGlzLnJlcXVlc3REYXRhKSk7CiAgICAgIH0sCiAgICAgIHNlbmQ6IGZ1bmN0aW9uKHJlcXVlc3REYXRhKSB7CiAgICAgICAgaWYgKCFkb2N1bWVudCkgdGhyb3cgIkpTT05QIGlzIG5vdCBzdXBwb3J0ZWQgZm9yIGN1cnJlbnQgZW52aXJvbm1lbnQiOwogICAgICAgIHZhciBoZWFkID0gZG9jdW1lbnQuaGVhZCB8fCBkb2N1bWVudC5nZXRFbGVtZW50QnlOYW1lKCJoZWFkIilbMF0gfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICB0aGlzLnVwZGF0ZSh7CiAgICAgICAgICBkYXRhOiB1bmRlZmluZWQsCiAgICAgICAgICBzdGF0dXM6ICIiLAogICAgICAgICAgZXJyb3I6ICIiCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5zY3JpcHQgPSBzY3JpcHQ7CiAgICAgICAgc2NyaXB0LmFzeW5jID0gdHJ1ZTsKICAgICAgICBzY3JpcHQuc3JjID0gcmVxdWVzdERhdGEucmVxdWVzdFVybDsKICAgICAgICBzY3JpcHQuY2hhcnNldCA9IHJlcXVlc3REYXRhLmVuY29kaW5nOwogICAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25lcnJvciA9IHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSByZWFkeVN0YXRlQ2hhbmdlSGFuZGxlci5iaW5kKHRoaXMpOwogICAgICAgIHRoaXMucHJldlJlYWR5U3RhdGVfID0gLTE7CiAgICAgICAgdGhpcy5lbWl0X3N0YXJ0KCk7CiAgICAgICAgcmVhZHlTdGF0ZUNoYW5nZUhhbmRsZXIuY2FsbCh0aGlzLCBTVEFURV9VTlNFTlQpOwogICAgICAgIHRoaXMuc2V0VGltZW91dCh0aGlzLnRpbWVvdXQpOwogICAgICAgIGhlYWQuYXBwZW5kQ2hpbGQodGhpcy5zY3JpcHQpOwogICAgICB9LAogICAgICByZXBlYXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnJlcXVlc3REYXRhKSB7CiAgICAgICAgICB0aGlzLmFib3J0KCk7CiAgICAgICAgICB0aGlzLmRvUmVxdWVzdCgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYWJvcnQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghdGhpcy5pc0lkbGUoKSkgewogICAgICAgICAgdGhpcy5jbGVhclRpbWVvdXQoKTsKICAgICAgICAgIHJlYWR5U3RhdGVDaGFuZ2VIYW5kbGVyLmNhbGwodGhpcywgU1RBVEVfRE9ORSwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRUaW1lb3V0OiBmdW5jdGlvbih0aW1lb3V0KSB7CiAgICAgICAgdGhpcy50aW1lcl8gPSBzZXRUaW1lb3V0KHRoaXMudGltZW91dEFib3J0LmJpbmQodGhpcyksIHRpbWVvdXQpOwogICAgICB9LAogICAgICBjbGVhclRpbWVvdXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnRpbWVyXykgdGhpcy50aW1lcl8gPSBjbGVhclRpbWVvdXQodGhpcy50aW1lcl8pOwogICAgICB9LAogICAgICB0aW1lb3V0QWJvcnQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudXBkYXRlKHsKICAgICAgICAgIGVycm9yOiB7CiAgICAgICAgICAgIGNvZGU6ICJUSU1FT1VUX0VSUk9SIiwKICAgICAgICAgICAgbWVzc2FnZTogIlRpbWVvdXQgZXJyb3IiCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5lbWl0X3RpbWVvdXQodGhpcyk7CiAgICAgICAgdGhpcy5hYm9ydCgpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmFib3J0KCk7CiAgICAgICAgQWJzdHJhY3RSZXF1ZXN0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIFRyYW5zcG9ydCA9IEFic3RyYWN0VHJhbnNwb3J0LnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLlRyYW5zcG9ydCIsCiAgICAgIHJlcXVlc3RDbGFzczogUmVxdWVzdCwKICAgICAgZW1pdF9yZWFkeVN0YXRlQ2hhbmdlZDogY3JlYXRlUmVxdWVzdEV2ZW50KCJyZWFkeVN0YXRlQ2hhbmdlZCIpLAogICAgICBlbmNvZGluZzogbnVsbCwKICAgICAgcGFyYW1zOiBudWxsLAogICAgICBjYWxsYmFja1BhcmFtOiAiY2FsbGJhY2siLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdFRyYW5zcG9ydC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMucGFyYW1zID0gb2JqZWN0U2xpY2UodGhpcy5wYXJhbXMpOwogICAgICB9LAogICAgICBzZXRQYXJhbTogZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgICB0aGlzLnBhcmFtc1tuYW1lXSA9IHZhbHVlOwogICAgICB9LAogICAgICBzZXRQYXJhbXM6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgIHRoaXMuY2xlYXJQYXJhbXMoKTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gcGFyYW1zKSB0aGlzLnNldFBhcmFtKGtleSwgcGFyYW1zW2tleV0pOwogICAgICB9LAogICAgICByZW1vdmVQYXJhbTogZnVuY3Rpb24obmFtZSkgewogICAgICAgIGRlbGV0ZSB0aGlzLnBhcmFtc1tuYW1lXTsKICAgICAgfSwKICAgICAgY2xlYXJQYXJhbXM6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnBhcmFtcykgZGVsZXRlIHRoaXMucGFyYW1zW2tleV07CiAgICAgIH0sCiAgICAgIHByZXBhcmVSZXF1ZXN0RGF0YTogZnVuY3Rpb24ocmVxdWVzdERhdGEpIHsKICAgICAgICB2YXIgdXJsID0gcmVxdWVzdERhdGEudXJsIHx8IHRoaXMudXJsOwogICAgICAgIGlmICghdXJsKSB0aHJvdyBuZXcgRXJyb3IoIlVSTCBpcyBub3QgZGVmaW5lZCIpOwogICAgICAgIGV4dGVuZChyZXF1ZXN0RGF0YSwgewogICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICBlbmNvZGluZzogcmVxdWVzdERhdGEuZW5jb2RpbmcgfHwgdGhpcy5lbmNvZGluZywKICAgICAgICAgIHBhcmFtczogb2JqZWN0TWVyZ2UodGhpcy5wYXJhbXMsIHJlcXVlc3REYXRhLnBhcmFtcyksCiAgICAgICAgICByb3V0ZXJQYXJhbXM6IHJlcXVlc3REYXRhLnJvdXRlclBhcmFtcywKICAgICAgICAgIGNhbGxiYWNrUGFyYW06IHJlcXVlc3REYXRhLmNhbGxiYWNrUGFyYW0gfHwgdGhpcy5jYWxsYmFja1BhcmFtLAogICAgICAgICAgaW5mbHVlbmNlOiByZXF1ZXN0RGF0YS5pbmZsdWVuY2UKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVxdWVzdERhdGE7CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIFJlcXVlc3Q6IFJlcXVlc3QsCiAgICAgIFRyYW5zcG9ydDogVHJhbnNwb3J0LAogICAgICByZXF1ZXN0OiBmdW5jdGlvbihjb25maWcsIHN1Y2Nlc3NDYWxsYmFjaywgZmFpbHVyZUNhbGxiYWNrKSB7CiAgICAgICAgaWYgKHR5cGVvZiBjb25maWcgPT0gInN0cmluZyIpIGNvbmZpZyA9IHsKICAgICAgICAgIHVybDogY29uZmlnCiAgICAgICAgfTsKICAgICAgICB2YXIgdHJhbnNwb3J0ID0gbmV3IFRyYW5zcG9ydChjb25maWcpOwogICAgICAgIHRyYW5zcG9ydC5hZGRIYW5kbGVyKHsKICAgICAgICAgIHN1Y2Nlc3M6IHN1Y2Nlc3NDYWxsYmFjayAmJiBmdW5jdGlvbihzZW5kZXIsIHJlcSwgZGF0YSkgewogICAgICAgICAgICBzdWNjZXNzQ2FsbGJhY2soZGF0YSk7CiAgICAgICAgICB9LAogICAgICAgICAgZmFpbHVyZTogZmFpbHVyZUNhbGxiYWNrICYmIGZ1bmN0aW9uKHNlbmRlciwgcmVxLCBlcnJvcikgewogICAgICAgICAgICBmYWlsdXJlQ2FsbGJhY2soZXJyb3IpOwogICAgICAgICAgfSwKICAgICAgICAgIGNvbXBsZXRlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgYmFzaXMubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdHJhbnNwb3J0LmRlc3Ryb3koKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdHJhbnNwb3J0LnJlcXVlc3QoKTsKICAgICAgfQogICAgfTsKICB9LAogICJqLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzMuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vNC5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBleHRlbmQgPSBiYXNpcy5vYmplY3QuZXh0ZW5kOwogICAgdmFyIGFycmF5RnJvbSA9IGJhc2lzLmFycmF5LmZyb207CiAgICB2YXIgb2JqZWN0U2xpY2UgPSBiYXNpcy5vYmplY3Quc2xpY2U7CiAgICB2YXIgb2JqZWN0TWVyZ2UgPSBiYXNpcy5vYmplY3QubWVyZ2U7CiAgICB2YXIgY3JlYXRlRXZlbnQgPSBiYXNpcy5ldmVudC5jcmVhdGU7CiAgICB2YXIgU1RBVEUgPSBiYXNpcy5kYXRhLlNUQVRFOwogICAgdmFyIERhdGFPYmplY3QgPSBiYXNpcy5kYXRhLk9iamVjdDsKICAgIHZhciBFbWl0dGVyID0gYmFzaXMuZXZlbnQuRW1pdHRlcjsKICAgIGZ1bmN0aW9uIGNyZWF0ZVRyYW5zcG9ydEV2ZW50KGV2ZW50TmFtZSkgewogICAgICB2YXIgZXZlbnQgPSBjcmVhdGVFdmVudChldmVudE5hbWUpOwogICAgICByZXR1cm4gZnVuY3Rpb24gdHJhbnNwb3J0RXZlbnQoKSB7CiAgICAgICAgZXZlbnQuYXBwbHkodHJhbnNwb3J0RGlzcGF0Y2hlciwgYXJndW1lbnRzKTsKICAgICAgICBpZiAodGhpcy5zZXJ2aWNlKSBldmVudC5hcHBseSh0aGlzLnNlcnZpY2UsIGFyZ3VtZW50cyk7CiAgICAgICAgZXZlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIGNyZWF0ZVJlcXVlc3RFdmVudChldmVudE5hbWUpIHsKICAgICAgdmFyIGV2ZW50ID0gY3JlYXRlRXZlbnQoZXZlbnROYW1lKTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIHJlcXVlc3RFdmVudCgpIHsKICAgICAgICB2YXIgYXJncyA9IFsgdGhpcyBdLmNvbmNhdChhcnJheUZyb20oYXJndW1lbnRzKSk7CiAgICAgICAgZXZlbnQuYXBwbHkodHJhbnNwb3J0RGlzcGF0Y2hlciwgYXJncyk7CiAgICAgICAgaWYgKHRoaXMudHJhbnNwb3J0KSB0aGlzLnRyYW5zcG9ydFsiZW1pdF8iICsgZXZlbnROYW1lXS5hcHBseSh0aGlzLnRyYW5zcG9ydCwgYXJncyk7CiAgICAgICAgZXZlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICAgIHZhciBpbnByb2dyZXNzVHJhbnNwb3J0cyA9IFtdOwogICAgdmFyIHRyYW5zcG9ydERpc3BhdGNoZXIgPSBuZXcgRW1pdHRlcih7CiAgICAgIGFib3J0OiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gYXJyYXlGcm9tKGlucHJvZ3Jlc3NUcmFuc3BvcnRzKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykgcmVzdWx0W2ldLmFib3J0KCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSwKICAgICAgaGFuZGxlcjogewogICAgICAgIHN0YXJ0OiBmdW5jdGlvbihyZXF1ZXN0KSB7CiAgICAgICAgICBiYXNpcy5hcnJheS5hZGQoaW5wcm9ncmVzc1RyYW5zcG9ydHMsIHJlcXVlc3QudHJhbnNwb3J0KTsKICAgICAgICB9LAogICAgICAgIGNvbXBsZXRlOiBmdW5jdGlvbihyZXF1ZXN0KSB7CiAgICAgICAgICBiYXNpcy5hcnJheS5yZW1vdmUoaW5wcm9ncmVzc1RyYW5zcG9ydHMsIHJlcXVlc3QudHJhbnNwb3J0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmFyIEFic3RyYWN0UmVxdWVzdCA9IERhdGFPYmplY3Quc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuQWJzdHJhY3RSZXF1ZXN0IiwKICAgICAgaW5mbHVlbmNlOiBudWxsLAogICAgICBpbml0RGF0YTogbnVsbCwKICAgICAgcmVxdWVzdERhdGE6IG51bGwsCiAgICAgIHRyYW5zcG9ydDogbnVsbCwKICAgICAgc3RhdGVPbkFib3J0OiBTVEFURS5VTkRFRklORUQsCiAgICAgIGVtaXRfc3RhcnQ6IGNyZWF0ZVJlcXVlc3RFdmVudCgic3RhcnQiKSwKICAgICAgZW1pdF90aW1lb3V0OiBjcmVhdGVSZXF1ZXN0RXZlbnQoInRpbWVvdXQiKSwKICAgICAgZW1pdF9hYm9ydDogY3JlYXRlUmVxdWVzdEV2ZW50KCJhYm9ydCIpLAogICAgICBlbWl0X3N1Y2Nlc3M6IGNyZWF0ZVJlcXVlc3RFdmVudCgic3VjY2VzcyIpLAogICAgICBlbWl0X2ZhaWx1cmU6IGNyZWF0ZVJlcXVlc3RFdmVudCgiZmFpbHVyZSIpLAogICAgICBlbWl0X2NvbXBsZXRlOiBjcmVhdGVSZXF1ZXN0RXZlbnQoImNvbXBsZXRlIiksCiAgICAgIGVtaXRfc3RhdGVDaGFuZ2VkOiBmdW5jdGlvbihvbGRTdGF0ZSkgewogICAgICAgIERhdGFPYmplY3QucHJvdG90eXBlLmVtaXRfc3RhdGVDaGFuZ2VkLmNhbGwodGhpcywgb2xkU3RhdGUpOwogICAgICAgIGlmICh0aGlzLmluZmx1ZW5jZSkgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmluZmx1ZW5jZS5sZW5ndGg7IGkrKykgdGhpcy5pbmZsdWVuY2VbaV0uc2V0U3RhdGUodGhpcy5zdGF0ZSwgdGhpcy5zdGF0ZS5kYXRhKTsKICAgICAgfSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgRGF0YU9iamVjdC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMuaW5mbHVlbmNlID0gW107CiAgICAgIH0sCiAgICAgIHNldEluZmx1ZW5jZTogZnVuY3Rpb24oaW5mbHVlbmNlKSB7CiAgICAgICAgdGhpcy5pbmZsdWVuY2UgPSBhcnJheUZyb20oaW5mbHVlbmNlKTsKICAgICAgfSwKICAgICAgY2xlYXJJbmZsdWVuY2U6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaW5mbHVlbmNlID0gbnVsbDsKICAgICAgfSwKICAgICAgZG9SZXF1ZXN0OiBiYXNpcy5mbi4kdW5kZWYsCiAgICAgIGdldFJlc3BvbnNlRGF0YTogYmFzaXMuZm4uJHVuZGVmLAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBEYXRhT2JqZWN0LnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5pbml0RGF0YSA9IG51bGw7CiAgICAgICAgdGhpcy5yZXF1ZXN0RGF0YSA9IG51bGw7CiAgICAgICAgdGhpcy5jbGVhckluZmx1ZW5jZSgpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUUkFOU1BPUlRfUkVRVUVTVF9IQU5ETEVSID0gewogICAgICBzdGFydDogZnVuY3Rpb24oc2VuZGVyLCByZXF1ZXN0KSB7CiAgICAgICAgYmFzaXMuYXJyYXkuYWRkKHRoaXMuaW5wcm9ncmVzc1JlcXVlc3RzLCByZXF1ZXN0KTsKICAgICAgfSwKICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKHNlbmRlciwgcmVxdWVzdCkgewogICAgICAgIGJhc2lzLmFycmF5LnJlbW92ZSh0aGlzLmlucHJvZ3Jlc3NSZXF1ZXN0cywgcmVxdWVzdCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgVFJBTlNQT1JUX1BPT0xfTElNSVRfSEFORExFUiA9IHsKICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBuZXh0UmVxdWVzdCA9IHRoaXMucmVxdWVzdFF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgaWYgKG5leHRSZXF1ZXN0KSB7CiAgICAgICAgICBiYXNpcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgbmV4dFJlcXVlc3QuZG9SZXF1ZXN0KCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICB2YXIgQWJzdHJhY3RUcmFuc3BvcnQgPSBFbWl0dGVyLnN1YmNsYXNzKHsKICAgICAgY2xhc3NOYW1lOiBuYW1lc3BhY2UgKyAiLkFic3RyYWN0VHJhbnNwb3J0IiwKICAgICAgcmVxdWVzdENsYXNzOiBBYnN0cmFjdFJlcXVlc3QsCiAgICAgIHJlcXVlc3RzOiBudWxsLAogICAgICBwb29sTGltaXQ6IG51bGwsCiAgICAgIHBvb2xIYXNoR2V0dGVyOiBiYXNpcy5mbi4kdHJ1ZSwKICAgICAgZW1pdF9zdGFydDogY3JlYXRlVHJhbnNwb3J0RXZlbnQoInN0YXJ0IiksCiAgICAgIGVtaXRfdGltZW91dDogY3JlYXRlVHJhbnNwb3J0RXZlbnQoInRpbWVvdXQiKSwKICAgICAgZW1pdF9hYm9ydDogY3JlYXRlVHJhbnNwb3J0RXZlbnQoImFib3J0IiksCiAgICAgIGVtaXRfc3VjY2VzczogY3JlYXRlVHJhbnNwb3J0RXZlbnQoInN1Y2Nlc3MiKSwKICAgICAgZW1pdF9mYWlsdXJlOiBjcmVhdGVUcmFuc3BvcnRFdmVudCgiZmFpbHVyZSIpLAogICAgICBlbWl0X2NvbXBsZXRlOiBjcmVhdGVUcmFuc3BvcnRFdmVudCgiY29tcGxldGUiKSwKICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0cyA9IHt9OwogICAgICAgIHRoaXMucmVxdWVzdFF1ZXVlID0gW107CiAgICAgICAgdGhpcy5pbnByb2dyZXNzUmVxdWVzdHMgPSBbXTsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5hZGRIYW5kbGVyKFRSQU5TUE9SVF9SRVFVRVNUX0hBTkRMRVIsIHRoaXMpOwogICAgICAgIGlmICh0aGlzLnBvb2xMaW1pdCkgdGhpcy5hZGRIYW5kbGVyKFRSQU5TUE9SVF9QT09MX0xJTUlUX0hBTkRMRVIsIHRoaXMpOwogICAgICB9LAogICAgICBnZXRSZXF1ZXN0QnlIYXNoOiBmdW5jdGlvbihyZXF1ZXN0SGFzaElkKSB7CiAgICAgICAgdmFyIHJlcXVlc3QgPSB0aGlzLnJlcXVlc3RzW3JlcXVlc3RIYXNoSWRdOwogICAgICAgIGlmICghcmVxdWVzdCkgewogICAgICAgICAgZm9yICh2YXIgaWQgaW4gdGhpcy5yZXF1ZXN0cykgaWYgKHRoaXMucmVxdWVzdHNbaWRdLmlzSWRsZSgpICYmIHRoaXMucmVxdWVzdFF1ZXVlLmluZGV4T2YodGhpcy5yZXF1ZXN0c1tpZF0pID09IC0xKSB7CiAgICAgICAgICAgIHJlcXVlc3QgPSB0aGlzLnJlcXVlc3RzW2lkXTsKICAgICAgICAgICAgZGVsZXRlIHRoaXMucmVxdWVzdHNbaWRdOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghcmVxdWVzdCkgcmVxdWVzdCA9IG5ldyB0aGlzLnJlcXVlc3RDbGFzcyh7CiAgICAgICAgICAgIHRyYW5zcG9ydDogdGhpcwogICAgICAgICAgfSk7CiAgICAgICAgICB0aGlzLnJlcXVlc3RzW3JlcXVlc3RIYXNoSWRdID0gcmVxdWVzdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlcXVlc3Q7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IGJhc2lzLmZuLiR0cnVlLAogICAgICBwcmVwYXJlUmVxdWVzdERhdGE6IGJhc2lzLmZuLiRzZWxmLAogICAgICByZXF1ZXN0OiBmdW5jdGlvbihjb25maWcpIHsKICAgICAgICBpZiAoIXRoaXMucHJlcGFyZSgpKSByZXR1cm47CiAgICAgICAgdmFyIHJlcXVlc3REYXRhID0gb2JqZWN0U2xpY2UoY29uZmlnKTsKICAgICAgICB2YXIgcmVxdWVzdEhhc2hJZCA9IHRoaXMucG9vbEhhc2hHZXR0ZXIodGhpcy5wcmVwYXJlUmVxdWVzdERhdGEocmVxdWVzdERhdGEpKTsKICAgICAgICB2YXIgcmVxdWVzdCA9IHRoaXMuZ2V0UmVxdWVzdEJ5SGFzaChyZXF1ZXN0SGFzaElkLCB0cnVlKTsKICAgICAgICBpZiAocmVxdWVzdC5pbml0RGF0YSkgcmVxdWVzdC5hYm9ydCgpOwogICAgICAgIHJlcXVlc3QuaW5pdERhdGEgPSByZXF1ZXN0RGF0YTsKICAgICAgICByZXF1ZXN0LnJlcXVlc3REYXRhID0gcmVxdWVzdERhdGE7CiAgICAgICAgcmVxdWVzdC5zZXRJbmZsdWVuY2UocmVxdWVzdERhdGEuaW5mbHVlbmNlIHx8IHRoaXMuaW5mbHVlbmNlKTsKICAgICAgICBpZiAodGhpcy5wb29sTGltaXQgJiYgdGhpcy5pbnByb2dyZXNzUmVxdWVzdHMubGVuZ3RoID49IHRoaXMucG9vbExpbWl0KSB7CiAgICAgICAgICB0aGlzLnJlcXVlc3RRdWV1ZS5wdXNoKHJlcXVlc3QpOwogICAgICAgICAgcmVxdWVzdC5zZXRTdGF0ZShTVEFURS5QUk9DRVNTSU5HKTsKICAgICAgICB9IGVsc2UgcmVxdWVzdC5kb1JlcXVlc3QoKTsKICAgICAgICByZXR1cm4gcmVxdWVzdDsKICAgICAgfSwKICAgICAgYWJvcnQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCByZXF1ZXN0OyByZXF1ZXN0ID0gdGhpcy5pbnByb2dyZXNzUmVxdWVzdHNbaV07IGkrKykgcmVxdWVzdC5hYm9ydCgpOwogICAgICAgIGZvciAodmFyIGkgPSAwLCByZXF1ZXN0OyByZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0UXVldWVbaV07IGkrKykgcmVxdWVzdC5zZXRTdGF0ZShTVEFURS5FUlJPUik7CiAgICAgICAgdGhpcy5pbnByb2dyZXNzUmVxdWVzdHMgPSBbXTsKICAgICAgICB0aGlzLnJlcXVlc3RRdWV1ZSA9IFtdOwogICAgICB9LAogICAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuc3RvcHBlZCkgewogICAgICAgICAgdGhpcy5zdG9wcGVkUmVxdWVzdHMgPSB0aGlzLmlucHJvZ3Jlc3NSZXF1ZXN0cy5jb25jYXQodGhpcy5yZXF1ZXN0UXVldWUpOwogICAgICAgICAgdGhpcy5hYm9ydCgpOwogICAgICAgICAgdGhpcy5zdG9wcGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlc3VtZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuc3RvcHBlZFJlcXVlc3RzKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgcmVxdWVzdDsgcmVxdWVzdCA9IHRoaXMuc3RvcHBlZFJlcXVlc3RzW2ldOyBpKyspIHJlcXVlc3QudHJhbnNwb3J0LnJlcXVlc3QocmVxdWVzdC5pbml0RGF0YSk7CiAgICAgICAgICB0aGlzLnN0b3BwZWRSZXF1ZXN0cyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RvcHBlZCA9IGZhbHNlOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICBmb3IgKHZhciBpIGluIHRoaXMucmVxdWVzdHMpIHRoaXMucmVxdWVzdHNbaV0uZGVzdHJveSgpOwogICAgICAgIHRoaXMucmVxdWVzdHMgPSB7fTsKICAgICAgICB0aGlzLmlucHJvZ3Jlc3NSZXF1ZXN0cyA9IG51bGw7CiAgICAgICAgdGhpcy5yZXF1ZXN0UXVldWUgPSBudWxsOwogICAgICAgIHRoaXMuc3RvcHBlZFJlcXVlc3RzID0gbnVsbDsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5kZXN0cm95LmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0pOwogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGNyZWF0ZVRyYW5zcG9ydEV2ZW50OiBjcmVhdGVUcmFuc3BvcnRFdmVudCwKICAgICAgY3JlYXRlUmVxdWVzdEV2ZW50OiBjcmVhdGVSZXF1ZXN0RXZlbnQsCiAgICAgIHRyYW5zcG9ydERpc3BhdGNoZXI6IHRyYW5zcG9ydERpc3BhdGNoZXIsCiAgICAgIEFic3RyYWN0UmVxdWVzdDogQWJzdHJhY3RSZXF1ZXN0LAogICAgICBBYnN0cmFjdFRyYW5zcG9ydDogQWJzdHJhY3RUcmFuc3BvcnQKICAgIH07CiAgfSwKICAiay5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgYmFzaXMucmVxdWlyZSgiLi8zLmpzIik7CiAgICBiYXNpcy5yZXF1aXJlKCIuL2wuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vbi5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBjcmVhdGVFdmVudCA9IGJhc2lzLmV2ZW50LmNyZWF0ZTsKICAgIHZhciBjcmVhdGVBY3Rpb24gPSBiYXNpcy5uZXQuYWN0aW9uLmNyZWF0ZTsKICAgIHZhciBFbWl0dGVyID0gYmFzaXMuZXZlbnQuRW1pdHRlcjsKICAgIHZhciBBamF4VHJhbnNwb3J0ID0gYmFzaXMubmV0LmFqYXguVHJhbnNwb3J0OwogICAgdmFyIFNFUlZJQ0VfSEFORExFUiA9IHsKICAgICAgc3RhcnQ6IGZ1bmN0aW9uKHNlcnZpY2UsIHJlcXVlc3QpIHsKICAgICAgICBiYXNpcy5hcnJheS5hZGQodGhpcy5pbnByb2dyZXNzVHJhbnNwb3J0cywgcmVxdWVzdC50cmFuc3BvcnQpOwogICAgICB9LAogICAgICBjb21wbGV0ZTogZnVuY3Rpb24oc2VydmljZSwgcmVxdWVzdCkgewogICAgICAgIGJhc2lzLmFycmF5LnJlbW92ZSh0aGlzLmlucHJvZ3Jlc3NUcmFuc3BvcnRzLCByZXF1ZXN0LnRyYW5zcG9ydCk7CiAgICAgIH0KICAgIH07CiAgICB2YXIgU2VydmljZSA9IEVtaXR0ZXIuc3ViY2xhc3MoewogICAgICBjbGFzc05hbWU6IG5hbWVzcGFjZSArICIuU2VydmljZSIsCiAgICAgIGlucHJvZ3Jlc3NUcmFuc3BvcnRzOiBudWxsLAogICAgICB0cmFuc3BvcnRDbGFzczogQWpheFRyYW5zcG9ydCwKICAgICAgZW1pdF9zZXNzaW9uT3BlbjogY3JlYXRlRXZlbnQoInNlc3Npb25PcGVuIiksCiAgICAgIGVtaXRfc2Vzc2lvbkNsb3NlOiBjcmVhdGVFdmVudCgic2Vzc2lvbkNsb3NlIiksCiAgICAgIGVtaXRfc2Vzc2lvbkZyZWV6ZTogY3JlYXRlRXZlbnQoInNlc3Npb25GcmVlemUiKSwKICAgICAgZW1pdF9zZXNzaW9uVW5mcmVlemU6IGNyZWF0ZUV2ZW50KCJzZXNzaW9uVW5mcmVlemUiKSwKICAgICAgaXNTZWN1cmU6IGZhbHNlLAogICAgICBwcmVwYXJlOiBiYXNpcy5mbi4kdHJ1ZSwKICAgICAgc2lnbmF0dXJlOiBiYXNpcy5mbi4kdW5kZWYsCiAgICAgIGlzU2Vzc2lvbkV4cGlyZWRFcnJvcjogYmFzaXMuZm4uJGZhbHNlLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5yZXF1ZXN0Q2xhc3MpIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuU2VydmljZSNyZXF1ZXN0Q2xhc3MgaXMgbm90IHN1cHBvcnRlZDsgc2V0IHJlcXVlc3RDbGFzcyB2aWEgdHJhbnNwb3J0Q2xhc3MiKTsKICAgICAgICBFbWl0dGVyLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcyk7CiAgICAgICAgdGhpcy5pbnByb2dyZXNzVHJhbnNwb3J0cyA9IFtdOwogICAgICAgIHZhciBUcmFuc3BvcnRDbGFzcyA9IHRoaXMudHJhbnNwb3J0Q2xhc3M7CiAgICAgICAgdGhpcy50cmFuc3BvcnRDbGFzcyA9IFRyYW5zcG9ydENsYXNzLnN1YmNsYXNzKHsKICAgICAgICAgIHNlcnZpY2U6IHRoaXMsCiAgICAgICAgICBuZWVkU2lnbmF0dXJlOiB0aGlzLmlzU2VjdXJlLAogICAgICAgICAgZW1pdF9mYWlsdXJlOiBmdW5jdGlvbihyZXF1ZXN0LCBlcnJvcikgewogICAgICAgICAgICBUcmFuc3BvcnRDbGFzcy5wcm90b3R5cGUuZW1pdF9mYWlsdXJlLmNhbGwodGhpcywgcmVxdWVzdCwgZXJyb3IpOwogICAgICAgICAgICBpZiAodGhpcy5uZWVkU2lnbmF0dXJlICYmIHRoaXMuc2VydmljZS5pc1Nlc3Npb25FeHBpcmVkRXJyb3IocmVxdWVzdCkpIHsKICAgICAgICAgICAgICB0aGlzLnNlcnZpY2UuZnJlZXplKCk7CiAgICAgICAgICAgICAgdGhpcy5zZXJ2aWNlLnN0b3BwZWRUcmFuc3BvcnRzLnB1c2godGhpcyk7CiAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICByZXF1ZXN0OiBmdW5jdGlvbihyZXF1ZXN0RGF0YSkgewogICAgICAgICAgICBpZiAoIXRoaXMuc2VydmljZS5wcmVwYXJlKHRoaXMsIHJlcXVlc3REYXRhKSkgcmV0dXJuOwogICAgICAgICAgICBpZiAodGhpcy5uZWVkU2lnbmF0dXJlICYmICF0aGlzLnNlcnZpY2Uuc2lnbih0aGlzKSkgcmV0dXJuOwogICAgICAgICAgICByZXR1cm4gVHJhbnNwb3J0Q2xhc3MucHJvdG90eXBlLnJlcXVlc3QuY2FsbCh0aGlzLCByZXF1ZXN0RGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5hZGRIYW5kbGVyKFNFUlZJQ0VfSEFORExFUik7CiAgICAgIH0sCiAgICAgIHNpZ246IGZ1bmN0aW9uKHRyYW5zcG9ydCkgewogICAgICAgIGlmICh0aGlzLnNlc3Npb25LZXkpIHsKICAgICAgICAgIHRoaXMuc2lnbmF0dXJlKHRyYW5zcG9ydCwgdGhpcy5zZXNzaW9uRGF0YSk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlJlcXVlc3QgaWdub3JlZC4gU2VydmljZSBoYXZlIG5vIHNlc3Npb24ga2V5Iik7CiAgICAgICAgfQogICAgICB9LAogICAgICBvcGVuU2Vzc2lvbjogZnVuY3Rpb24oc2Vzc2lvbktleSwgc2Vzc2lvbkRhdGEpIHsKICAgICAgICB0aGlzLnNlc3Npb25LZXkgPSBzZXNzaW9uS2V5OwogICAgICAgIHRoaXMuc2Vzc2lvbkRhdGEgPSBzZXNzaW9uRGF0YTsKICAgICAgICB0aGlzLnVuZnJlZXplKCk7CiAgICAgICAgdGhpcy5lbWl0X3Nlc3Npb25PcGVuKCk7CiAgICAgIH0sCiAgICAgIGNsb3NlU2Vzc2lvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5mcmVlemUoKTsKICAgICAgICB0aGlzLmVtaXRfc2Vzc2lvbkNsb3NlKCk7CiAgICAgIH0sCiAgICAgIGZyZWV6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLnNlc3Npb25LZXkpIHJldHVybjsKICAgICAgICB0aGlzLnNlc3Npb25LZXkgPSBudWxsOwogICAgICAgIHRoaXMuc2Vzc2lvbkRhdGEgPSBudWxsOwogICAgICAgIHRoaXMuc3RvcHBlZFRyYW5zcG9ydHMgPSB0aGlzLmlucHJvZ3Jlc3NUcmFuc3BvcnRzLmZpbHRlcihmdW5jdGlvbih0cmFuc3BvcnQpIHsKICAgICAgICAgIHJldHVybiB0cmFuc3BvcnQubmVlZFNpZ25hdHVyZTsKICAgICAgICB9KTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgdHJhbnNwb3J0OyB0cmFuc3BvcnQgPSB0aGlzLmlucHJvZ3Jlc3NUcmFuc3BvcnRzW2ldOyBpKyspIHRyYW5zcG9ydC5zdG9wKCk7CiAgICAgICAgdGhpcy5lbWl0X3Nlc3Npb25GcmVlemUoKTsKICAgICAgfSwKICAgICAgdW5mcmVlemU6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnN0b3BwZWRUcmFuc3BvcnRzKSBmb3IgKHZhciBpID0gMCwgdHJhbnNwb3J0OyB0cmFuc3BvcnQgPSB0aGlzLnN0b3BwZWRUcmFuc3BvcnRzW2ldOyBpKyspIHRyYW5zcG9ydC5yZXN1bWUoKTsKICAgICAgICB0aGlzLmVtaXRfc2Vzc2lvblVuZnJlZXplKCk7CiAgICAgIH0sCiAgICAgIGNyZWF0ZVRyYW5zcG9ydDogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgcmV0dXJuIG5ldyB0aGlzLnRyYW5zcG9ydENsYXNzKGNvbmZpZyk7CiAgICAgIH0sCiAgICAgIGNyZWF0ZUFjdGlvbjogZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZUFjdGlvbihiYXNpcy5vYmplY3QuY29tcGxldGUoewogICAgICAgICAgc2VydmljZTogdGhpcwogICAgICAgIH0sIGNvbmZpZykpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmlucHJvZ3Jlc3NUcmFuc3BvcnRzID0gbnVsbDsKICAgICAgICB0aGlzLnN0b3BwZWRUcmFuc3BvcnRzID0gbnVsbDsKICAgICAgICB0aGlzLnNlc3Npb25LZXkgPSBudWxsOwogICAgICAgIHRoaXMuc2Vzc2lvbkRhdGEgPSBudWxsOwogICAgICAgIEVtaXR0ZXIucHJvdG90eXBlLmRlc3Ryb3kuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgU2VydmljZTogU2VydmljZQogICAgfTsKICB9LAogICJsLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuL20uanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vai5qcyIpOwogICAgYmFzaXMucmVxdWlyZSgiLi80LmpzIik7CiAgICB2YXIgbmFtZXNwYWNlID0gdGhpcy5wYXRoOwogICAgdmFyIHVhID0gYmFzaXMudWE7CiAgICB2YXIgZXNjYXBlVmFsdWUgPSBnbG9iYWwuZW5jb2RlVVJJQ29tcG9uZW50OwogICAgdmFyIEZvcm1EYXRhID0gZ2xvYmFsLkZvcm1EYXRhOwogICAgdmFyIGV4dGVuZCA9IGJhc2lzLm9iamVjdC5leHRlbmQ7CiAgICB2YXIgb2JqZWN0U2xpY2UgPSBiYXNpcy5vYmplY3Quc2xpY2U7CiAgICB2YXIgb2JqZWN0TWVyZ2UgPSBiYXNpcy5vYmplY3QubWVyZ2U7CiAgICB2YXIgY3JlYXRlVHJhbnNwb3J0RXZlbnQgPSBiYXNpcy5uZXQuY3JlYXRlVHJhbnNwb3J0RXZlbnQ7CiAgICB2YXIgY3JlYXRlUmVxdWVzdEV2ZW50ID0gYmFzaXMubmV0LmNyZWF0ZVJlcXVlc3RFdmVudDsKICAgIHZhciBBYnN0cmFjdFJlcXVlc3QgPSBiYXNpcy5uZXQuQWJzdHJhY3RSZXF1ZXN0OwogICAgdmFyIEFic3RyYWN0VHJhbnNwb3J0ID0gYmFzaXMubmV0LkFic3RyYWN0VHJhbnNwb3J0OwogICAgdmFyIFNUQVRFX1VOU0VOVCA9IDA7CiAgICB2YXIgU1RBVEVfT1BFTkVEID0gMTsKICAgIHZhciBTVEFURV9IRUFERVJTX1JFQ0VJVkVEID0gMjsKICAgIHZhciBTVEFURV9MT0FESU5HID0gMzsKICAgIHZhciBTVEFURV9ET05FID0gNDsKICAgIHZhciBTVEFURSA9IGJhc2lzLmRhdGEuU1RBVEU7CiAgICB2YXIgTUVUSE9EUyA9ICJIRUFEIEdFVCBQT1NUIFBVVCBQQVRDSCBERUxFVEUgVFJBQ0UgTElOSyBVTkxJTksgQ09OTkVDVCIuc3BsaXQoIiAiKTsKICAgIHZhciBJU19QT1NUX1JFR0VYUCA9IC9QT1NUL2k7CiAgICB2YXIgSVNfTUVUSE9EX1dJVEhfQk9EWSA9IC9eKFBPU1R8UFVUfFBBVENIfExJTkt8VU5MSU5LKSQvaTsKICAgIHZhciBYSFJTdXBwb3J0ID0gIm5hdGl2ZSI7CiAgICB2YXIgY3JlYXRlWG1sSHR0cFJlcXVlc3QgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCJYTUxIdHRwUmVxdWVzdCIgaW4gZ2xvYmFsKSByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdDsKICAgICAgfTsKICAgICAgdmFyIEFjdGl2ZVhPYmplY3QgPSBnbG9iYWwuQWN0aXZlWE9iamVjdDsKICAgICAgaWYgKEFjdGl2ZVhPYmplY3QpIHsKICAgICAgICB2YXIgcHJvZ0lEID0gWyAiTVNYTUwyLlhNTEhUVFAuNi4wIiwgIk1TWE1MMi5YTUxIVFRQLjMuMCIsICJNU1hNTDIuWE1MSFRUUCIsICJNaWNyb3NvZnQuWE1MSFRUUCIgXTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgWEhSU3VwcG9ydCA9IHByb2dJRFtpXTsgaSsrKSB0cnkgewogICAgICAgICAgaWYgKG5ldyBBY3RpdmVYT2JqZWN0KFhIUlN1cHBvcnQpKSByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdChYSFJTdXBwb3J0KTsKICAgICAgICAgIH07CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgfQogICAgICB0aHJvdyBuZXcgRXJyb3IoWEhSU3VwcG9ydCA9ICJYTUxIdHRwUmVxdWVzdCBpcyBub3Qgc3VwcG9ydGVkISIpOwogICAgfSgpOwogICAgZnVuY3Rpb24gc2V0UmVxdWVzdEhlYWRlcnMoeGhyLCByZXF1ZXN0RGF0YSkgewogICAgICB2YXIgaGVhZGVycyA9IHt9OwogICAgICBpZiAoSVNfTUVUSE9EX1dJVEhfQk9EWS50ZXN0KHJlcXVlc3REYXRhLm1ldGhvZCkpIHsKICAgICAgICBpZiAoIUZvcm1EYXRhIHx8IHJlcXVlc3REYXRhLnBvc3RCb2R5IGluc3RhbmNlb2YgRm9ybURhdGEgPT0gZmFsc2UpIGhlYWRlcnNbIkNvbnRlbnQtVHlwZSJdID0gcmVxdWVzdERhdGEuY29udGVudFR5cGUgKyAocmVxdWVzdERhdGEuZW5jb2RpbmcgPyAiO2NoYXJzZXQ9IiArIHJlcXVlc3REYXRhLmVuY29kaW5nIDogIiIpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh1YS50ZXN0KCJpZSIpKSB7CiAgICAgICAgICBoZWFkZXJzWyJJZi1Nb2RpZmllZC1TaW5jZSJdID0gIlRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UIjsKICAgICAgICB9CiAgICAgIH0KICAgICAgYmFzaXMub2JqZWN0Lml0ZXJhdGUoZXh0ZW5kKGhlYWRlcnMsIHJlcXVlc3REYXRhLmhlYWRlcnMpLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwgJiYgdHlwZW9mIHZhbHVlICE9ICJmdW5jdGlvbiIpIHRoaXMuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKICAgICAgfSwgeGhyKTsKICAgIH0KICAgIGZ1bmN0aW9uIHNldFJlc3BvbnNlVHlwZSh4aHIsIHJlcXVlc3REYXRhKSB7CiAgICAgIGlmIChyZXF1ZXN0RGF0YS5yZXNwb25zZVR5cGUgJiYgcmVxdWVzdERhdGEuYXN5bmNocm9ub3VzICYmICJyZXNwb25zZVR5cGUiIGluIHhocikgdHJ5IHsKICAgICAgICB4aHIucmVzcG9uc2VUeXBlID0gcmVxdWVzdERhdGEucmVzcG9uc2VUeXBlOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oIkNhbid0IHNldCByZXNwb3NlVHlwZSBgIiArIHJlcXVlc3REYXRhLnJlc3BvbnNlVHlwZSArICJgIHRvIFhNTEh0dHBSZXF1ZXN0IiwgcmVxdWVzdERhdGEpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBzYWZlSnNvblBhcnNlKGNvbnRlbnQsIHVybCkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiBiYXNpcy5qc29uLnBhcnNlKGNvbnRlbnQpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgYmFzaXMuZGV2Lndhcm4oImJhc2lzLm5ldC5hamF4OiBDYW4ndCBwYXJzZSBKU09OIGZyb20gIiArIHVybCwgewogICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICBjb250ZW50OiBjb250ZW50CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHJlYWR5U3RhdGVDaGFuZ2VIYW5kbGVyKHJlYWR5U3RhdGUpIHsKICAgICAgdmFyIHhociA9IHRoaXMueGhyOwogICAgICB2YXIgbmV3U3RhdGU7CiAgICAgIHZhciBuZXdTdGF0ZURhdGE7CiAgICAgIHZhciBhYm9ydGVkOwogICAgICB0aGlzLnNlbmREZWxheVRpbWVyXyA9IGNsZWFyVGltZW91dCh0aGlzLnNlbmREZWxheVRpbWVyXyk7CiAgICAgIGlmICgheGhyKSByZXR1cm47CiAgICAgIGlmICh0eXBlb2YgcmVhZHlTdGF0ZSAhPSAibnVtYmVyIikgcmVhZHlTdGF0ZSA9IHhoci5yZWFkeVN0YXRlOwogICAgICBpZiAocmVhZHlTdGF0ZSA9PSB0aGlzLnByZXZSZWFkeVN0YXRlXykgcmV0dXJuOwogICAgICB0aGlzLnByZXZSZWFkeVN0YXRlXyA9IHJlYWR5U3RhdGU7CiAgICAgIGlmICh0aGlzLmRlYnVnKSBiYXNpcy5kZXYubG9nKCJTdGF0ZTogKCIgKyByZWFkeVN0YXRlICsgIikgIiArIFsgIlVOU0VOVCIsICJPUEVORUQiLCAiSEVBREVSU19SRUNFSVZFRCIsICJMT0FESU5HIiwgIkRPTkUiIF1bcmVhZHlTdGF0ZV0pOwogICAgICB0aGlzLmVtaXRfcmVhZHlTdGF0ZUNoYW5nZWQocmVhZHlTdGF0ZSk7CiAgICAgIGlmIChyZWFkeVN0YXRlID09IFNUQVRFX0RPTkUpIHsKICAgICAgICB0aGlzLmNsZWFyVGltZW91dCgpOwogICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBiYXNpcy5mbi4kdW5kZWY7CiAgICAgICAgYWJvcnRlZCA9IHhoci5zdGF0dXMgPT0gMDsKICAgICAgICBpZiAoIWFib3J0ZWQgJiYgIXhoci5yZXNwb25zZVR5cGUpIGFib3J0ZWQgPSB0eXBlb2YgeGhyLnJlc3BvbnNlVGV4dCA9PSAidW5rbm93biIgfHwgIXhoci5yZXNwb25zZVRleHQgJiYgIXhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKTsKICAgICAgICBpZiAoYWJvcnRlZCkgewogICAgICAgICAgdGhpcy5lbWl0X2Fib3J0KCk7CiAgICAgICAgICBuZXdTdGF0ZSA9IHRoaXMuc3RhdGVPbkFib3J0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLnByb2Nlc3NSZXNwb25zZSgpOwogICAgICAgICAgaWYgKHRoaXMuaXNTdWNjZXNzZnVsKCkpIHsKICAgICAgICAgICAgbmV3U3RhdGUgPSBTVEFURS5SRUFEWTsKICAgICAgICAgICAgdGhpcy5lbWl0X3N1Y2Nlc3ModGhpcy5nZXRSZXNwb25zZURhdGEoKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdTdGF0ZSA9IFNUQVRFLkVSUk9SOwogICAgICAgICAgICBuZXdTdGF0ZURhdGEgPSB0aGlzLmdldFJlc3BvbnNlRXJyb3IoKTsKICAgICAgICAgICAgaWYgKCFuZXdTdGF0ZURhdGEgJiYgdGhpcy5kYXRhLmVycm9yKSB7CiAgICAgICAgICAgICAgYmFzaXMuZGV2Lndhcm4oIlJlcXVlc3QjZ2V0UmVzcG9uc2VFcnJvciBzaG91bGQgbm90IHVwZGF0ZSByZXF1ZXN0IGRhdGEsIGJ1dCByZXR1cm5zIGVycm9yIGRhdGEuIFBsZWFzZSwgZml4IHlvdXIgbWV0aG9kIGltcGxlbWVudGF0aW9uLCBhcyBkYXRhIHVwZGF0aW5nIGlzIGRlcHJlY2F0ZWQgYmVoYXZpb3VyLiIpOwogICAgICAgICAgICAgIG5ld1N0YXRlRGF0YSA9IHRoaXMuZGF0YS5lcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVtaXRfZmFpbHVyZShuZXdTdGF0ZURhdGEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLmVtaXRfY29tcGxldGUodGhpcyk7CiAgICAgIH0gZWxzZSBuZXdTdGF0ZSA9IFNUQVRFLlBST0NFU1NJTkc7CiAgICAgIHRoaXMuc2V0U3RhdGUobmV3U3RhdGUsIG5ld1N0YXRlRGF0YSk7CiAgICB9CiAgICB2YXIgUmVxdWVzdCA9IEFic3RyYWN0UmVxdWVzdC5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5SZXF1ZXN0IiwKICAgICAgcmVxdWVzdFN0YXJ0VGltZTogMCwKICAgICAgdGltZW91dDogM2U0LAogICAgICB0aW1lcl86IG51bGwsCiAgICAgIHNlbmREZWxheTogbnVsbCwKICAgICAgc2VuZERlbGF5VGltZXJfOiBudWxsLAogICAgICBsYXN0UmVxdWVzdFVybF86IG51bGwsCiAgICAgIGRlYnVnOiBmYWxzZSwKICAgICAgZW1pdF9yZWFkeVN0YXRlQ2hhbmdlZDogY3JlYXRlUmVxdWVzdEV2ZW50KCJyZWFkeVN0YXRlQ2hhbmdlZCIpLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdFJlcXVlc3QucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLnhociA9IGNyZWF0ZVhtbEh0dHBSZXF1ZXN0KCk7CiAgICAgIH0sCiAgICAgIGlzSWRsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueGhyLnJlYWR5U3RhdGUgPT0gU1RBVEVfRE9ORSB8fCB0aGlzLnhoci5yZWFkeVN0YXRlID09IFNUQVRFX1VOU0VOVDsKICAgICAgfSwKICAgICAgaXNTdWNjZXNzZnVsOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc3RhdHVzID0gdGhpcy54aHIuc3RhdHVzOwogICAgICAgIHJldHVybiBzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCB8fCBzdGF0dXMgPT0gMzA0OwogICAgICB9LAogICAgICBwcm9jZXNzUmVzcG9uc2U6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudXBkYXRlKHsKICAgICAgICAgIGNvbnRlbnRUeXBlOiB0aGlzLnhoci5nZXRSZXNwb25zZUhlYWRlcigiY29udGVudC10eXBlIiksCiAgICAgICAgICBzdGF0dXM6IHRoaXMueGhyLnN0YXR1cwogICAgICAgIH0pOwogICAgICB9LAogICAgICBnZXRSZXNwb25zZURhdGE6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4aHIgPSB0aGlzLnhocjsKICAgICAgICBpZiAoIXhoci5yZXNwb25zZVR5cGUpIGlmICh0aGlzLnJlc3BvbnNlVHlwZSA9PSAianNvbiIgfHwgL15hcHBsaWNhdGlvblwvanNvbi9pLnRlc3QodGhpcy5kYXRhLmNvbnRlbnRUeXBlKSkgcmV0dXJuIHNhZmVKc29uUGFyc2UoeGhyLnJlc3BvbnNlVGV4dCwgdGhpcy5sYXN0UmVxdWVzdFVybF8pOwogICAgICAgIGlmICgicmVzcG9uc2UiIGluIHhocikgcmV0dXJuIHhoci5yZXNwb25zZTsKICAgICAgICByZXR1cm4geGhyLnJlc3BvbnNlVGV4dDsKICAgICAgfSwKICAgICAgcHJvY2Vzc0Vycm9yUmVzcG9uc2U6IGZ1bmN0aW9uKCkgewogICAgICAgIGJhc2lzLmRldi53YXJuKG5hbWVzcGFjZSArICIuUmVxdWVzdCNwcm9jZXNzRXJyb3JSZXNwb25zZSBpcyBkZXByZWNhdGVkIG5vdywgdXNlIFJlcXVlc3QjZ2V0UmVzcG9uc2VFcnJvciBpbnN0ZWFkIik7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UmVzcG9uc2VFcnJvcigpOwogICAgICB9LAogICAgICBnZXRSZXNwb25zZUVycm9yOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgY29kZTogIlNFUlZFUl9FUlJPUiIsCiAgICAgICAgICBtc2c6ICF0aGlzLnJlc3BvbnNlVHlwZSA/IHRoaXMueGhyLnJlc3BvbnNlVGV4dCA6IHRoaXMueGhyLnJlc3BvbnNlIHx8IHRoaXMueGhyLnN0YXR1c1RleHQgfHwgIkVycm9yIgogICAgICAgIH07CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IGJhc2lzLmZuLiR0cnVlLAogICAgICBwcmVwYXJlUmVxdWVzdERhdGE6IGZ1bmN0aW9uKHJlcXVlc3REYXRhKSB7CiAgICAgICAgdmFyIHBhcmFtcyA9IFtdOwogICAgICAgIHZhciB1cmwgPSByZXF1ZXN0RGF0YS51cmw7CiAgICAgICAgcmVxdWVzdERhdGEgPSBvYmplY3RTbGljZShyZXF1ZXN0RGF0YSk7CiAgICAgICAgZm9yICh2YXIga2V5IGluIHJlcXVlc3REYXRhLnBhcmFtcykgewogICAgICAgICAgdmFyIHZhbHVlID0gcmVxdWVzdERhdGEucGFyYW1zW2tleV07CiAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCB8fCB2YWx1ZS50b1N0cmluZygpID09IG51bGwpIGNvbnRpbnVlOwogICAgICAgICAgcGFyYW1zLnB1c2goZXNjYXBlVmFsdWUoa2V5KSArICI9IiArIGVzY2FwZVZhbHVlKHZhbHVlLnRvU3RyaW5nKCkpKTsKICAgICAgICB9CiAgICAgICAgcGFyYW1zID0gcGFyYW1zLmpvaW4oIiYiKTsKICAgICAgICBpZiAoIXJlcXVlc3REYXRhLnBvc3RCb2R5ICYmIElTX01FVEhPRF9XSVRIX0JPRFkudGVzdChyZXF1ZXN0RGF0YS5tZXRob2QpKSB7CiAgICAgICAgICByZXF1ZXN0RGF0YS5wb3N0Qm9keSA9IHBhcmFtcyB8fCAiIjsKICAgICAgICAgIHBhcmFtcyA9ICIiOwogICAgICAgIH0KICAgICAgICBpZiAocmVxdWVzdERhdGEucm91dGVyUGFyYW1zKSB1cmwgPSB1cmwucmVwbGFjZSgvOihbYS16XF9cLV1bYS16MC05XF9cLV0rKS9naSwgZnVuY3Rpb24obSwga2V5KSB7CiAgICAgICAgICBpZiAoa2V5IGluIHJlcXVlc3REYXRhLnJvdXRlclBhcmFtcykgcmV0dXJuIHJlcXVlc3REYXRhLnJvdXRlclBhcmFtc1trZXldOyBlbHNlIHJldHVybiBtOwogICAgICAgIH0pOwogICAgICAgIGlmIChwYXJhbXMpIHVybCArPSAodXJsLmluZGV4T2YoIj8iKSA9PSAtMSA/ICI/IiA6ICImIikgKyBwYXJhbXM7CiAgICAgICAgcmVxdWVzdERhdGEucmVxdWVzdFVybCA9IHVybDsKICAgICAgICByZXR1cm4gcmVxdWVzdERhdGE7CiAgICAgIH0sCiAgICAgIGRvUmVxdWVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZW5kKHRoaXMucHJlcGFyZVJlcXVlc3REYXRhKHRoaXMucmVxdWVzdERhdGEpKTsKICAgICAgfSwKICAgICAgc2VuZDogZnVuY3Rpb24ocmVxdWVzdERhdGEpIHsKICAgICAgICB0aGlzLnVwZGF0ZSh7CiAgICAgICAgICBjb250ZW50VHlwZTogIiIsCiAgICAgICAgICBzdGF0dXM6ICIiCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHVhLnRlc3QoImdlY2tvMS44LjEtIikgJiYgcmVxdWVzdERhdGEuYXN5bmNocm9ub3VzKSB0aGlzLnhociA9IGNyZWF0ZVhtbEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgdGhpcy5lbWl0X3N0YXJ0KCk7CiAgICAgICAgdmFyIHhociA9IHRoaXMueGhyOwogICAgICAgIHRoaXMucHJldlJlYWR5U3RhdGVfID0gLTE7CiAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHJlYWR5U3RhdGVDaGFuZ2VIYW5kbGVyLmJpbmQodGhpcyk7CiAgICAgICAgaWYgKCFyZXF1ZXN0RGF0YS5hc3luY2hyb25vdXMpIHJlYWR5U3RhdGVDaGFuZ2VIYW5kbGVyLmNhbGwodGhpcywgU1RBVEVfVU5TRU5UKTsKICAgICAgICB4aHIub3BlbihyZXF1ZXN0RGF0YS5tZXRob2QsIHJlcXVlc3REYXRhLnJlcXVlc3RVcmwsIHJlcXVlc3REYXRhLmFzeW5jaHJvbm91cyk7CiAgICAgICAgdGhpcy5sYXN0UmVxdWVzdFVybF8gPSByZXF1ZXN0RGF0YS5yZXF1ZXN0VXJsOwogICAgICAgIHNldFJlc3BvbnNlVHlwZSh4aHIsIHJlcXVlc3REYXRhKTsKICAgICAgICB0aGlzLnJlc3BvbnNlVHlwZSA9IHJlcXVlc3REYXRhLnJlc3BvbnNlVHlwZSB8fCAiIjsKICAgICAgICBzZXRSZXF1ZXN0SGVhZGVycyh4aHIsIHJlcXVlc3REYXRhKTsKICAgICAgICB0aGlzLnNldFRpbWVvdXQodGhpcy50aW1lb3V0KTsKICAgICAgICB2YXIgcG9zdEJvZHkgPSByZXF1ZXN0RGF0YS5wb3N0Qm9keTsKICAgICAgICBpZiAoSVNfTUVUSE9EX1dJVEhfQk9EWS50ZXN0KHJlcXVlc3REYXRhLm1ldGhvZCkgJiYgdWEudGVzdCgiaWU5LSIpKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHBvc3RCb2R5ID09ICJvYmplY3QiICYmIHR5cGVvZiBwb3N0Qm9keS5kb2N1bWVudEVsZW1lbnQgIT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHBvc3RCb2R5LnhtbCA9PSAic3RyaW5nIikgcG9zdEJvZHkgPSBwb3N0Qm9keS54bWw7IGVsc2UgaWYgKHR5cGVvZiBwb3N0Qm9keSA9PSAic3RyaW5nIikgcG9zdEJvZHkgPSBwb3N0Qm9keS5yZXBsYWNlKC9cci9nLCAiIik7IGVsc2UgaWYgKHBvc3RCb2R5ID09IG51bGwgfHwgcG9zdEJvZHkgPT0gIiIpIHBvc3RCb2R5ID0gIltObyBkYXRhXSI7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLnNlbmREZWxheSkgewogICAgICAgICAgaWYgKHRoaXMuc2VuZERlbGF5VGltZXJfKSB0aGlzLnNlbmREZWxheVRpbWVyXyA9IGNsZWFyVGltZW91dCh0aGlzLnNlbmREZWxheVRpbWVyXyk7CiAgICAgICAgICB0aGlzLnNlbmREZWxheVRpbWVyXyA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuc2VuZERlbGF5VGltZXJfID0gbnVsbDsKICAgICAgICAgICAgaWYgKHRoaXMueGhyID09PSB4aHIgJiYgeGhyLnJlYWR5U3RhdGUgPT0gU1RBVEVfT1BFTkVEKSB4aHIuc2VuZChwb3N0Qm9keSk7CiAgICAgICAgICB9LmJpbmQodGhpcyksIHRoaXMuc2VuZERlbGF5KTsKICAgICAgICB9IGVsc2UgeGhyLnNlbmQocG9zdEJvZHkpOwogICAgICAgIGlmICh0aGlzLmRlYnVnKSBiYXNpcy5kZXYubG9nKCJSZXF1ZXN0IG92ZXIsIHdhaXRpbmcgZm9yIHJlc3BvbnNlIik7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0sCiAgICAgIHJlcGVhdDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMucmVxdWVzdERhdGEpIHsKICAgICAgICAgIHRoaXMuYWJvcnQoKTsKICAgICAgICAgIHRoaXMuZG9SZXF1ZXN0KCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBhYm9ydDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLmlzSWRsZSgpKSB7CiAgICAgICAgICB0aGlzLmNsZWFyVGltZW91dCgpOwogICAgICAgICAgdGhpcy54aHIuYWJvcnQoKTsKICAgICAgICAgIGlmICh0aGlzLnhoci5yZWFkeVN0YXRlICE9IFNUQVRFX0RPTkUgJiYgdGhpcy54aHIucmVhZHlTdGF0ZSAhPSBTVEFURV9VTlNFTlQpIHJlYWR5U3RhdGVDaGFuZ2VIYW5kbGVyLmNhbGwodGhpcywgU1RBVEVfRE9ORSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXRUaW1lb3V0OiBmdW5jdGlvbih0aW1lb3V0KSB7CiAgICAgICAgaWYgKCF0aGlzLnhoci5hc3luY2hyb25vdXMpIHJldHVybjsKICAgICAgICBpZiAoIm9udGltZW91dCIgaW4gdGhpcy54aHIpIHsKICAgICAgICAgIHRoaXMueGhyLnRpbWVvdXQgPSB0aW1lb3V0OwogICAgICAgICAgdGhpcy54aHIub250aW1lb3V0ID0gdGhpcy50aW1lb3V0QWJvcnQuYmluZCh0aGlzKTsKICAgICAgICB9IGVsc2UgdGhpcy50aW1lcl8gPSBzZXRUaW1lb3V0KHRoaXMudGltZW91dEFib3J0LmJpbmQodGhpcyksIHRpbWVvdXQpOwogICAgICB9LAogICAgICBjbGVhclRpbWVvdXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLnRpbWVyXykgdGhpcy50aW1lcl8gPSBjbGVhclRpbWVvdXQodGhpcy50aW1lcl8pOwogICAgICB9LAogICAgICB0aW1lb3V0QWJvcnQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMudXBkYXRlKHsKICAgICAgICAgIGVycm9yOiB7CiAgICAgICAgICAgIGNvZGU6ICJUSU1FT1VUX0VSUk9SIiwKICAgICAgICAgICAgbWVzc2FnZTogIlRpbWVvdXQgZXJyb3IiCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5lbWl0X3RpbWVvdXQodGhpcyk7CiAgICAgICAgdGhpcy5hYm9ydCgpOwogICAgICB9LAogICAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmFib3J0KCk7CiAgICAgICAgdGhpcy54aHIgPSBudWxsOwogICAgICAgIEFic3RyYWN0UmVxdWVzdC5wcm90b3R5cGUuZGVzdHJveS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9KTsKICAgIHZhciBUcmFuc3BvcnQgPSBBYnN0cmFjdFRyYW5zcG9ydC5zdWJjbGFzcyh7CiAgICAgIGNsYXNzTmFtZTogbmFtZXNwYWNlICsgIi5UcmFuc3BvcnQiLAogICAgICByZXF1ZXN0Q2xhc3M6IFJlcXVlc3QsCiAgICAgIGVtaXRfcmVhZHlTdGF0ZUNoYW5nZWQ6IGNyZWF0ZVRyYW5zcG9ydEV2ZW50KCJyZWFkeVN0YXRlQ2hhbmdlZCIpLAogICAgICBhc3luY2hyb25vdXM6IHRydWUsCiAgICAgIG1ldGhvZDogIkdFVCIsCiAgICAgIGNvbnRlbnRUeXBlOiAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIiwKICAgICAgZW5jb2Rpbmc6IG51bGwsCiAgICAgIHJlcXVlc3RIZWFkZXJzOiBiYXNpcy5DbGFzcy5leHRlbnNpYmxlUHJvcGVydHkoKSwKICAgICAgcmVzcG9uc2VUeXBlOiAiIiwKICAgICAgcGFyYW1zOiBudWxsLAogICAgICByb3V0ZXJQYXJhbXM6IG51bGwsCiAgICAgIHVybDogIiIsCiAgICAgIHBvc3RCb2R5OiBudWxsLAogICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICBBYnN0cmFjdFRyYW5zcG9ydC5wcm90b3R5cGUuaW5pdC5jYWxsKHRoaXMpOwogICAgICAgIHRoaXMucGFyYW1zID0gb2JqZWN0U2xpY2UodGhpcy5wYXJhbXMpOwogICAgICAgIHRoaXMucm91dGVyUGFyYW1zID0gb2JqZWN0U2xpY2UodGhpcy5yb3V0ZXJQYXJhbXMpOwogICAgICB9LAogICAgICBzZXRQYXJhbTogZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgICB0aGlzLnBhcmFtc1tuYW1lXSA9IHZhbHVlOwogICAgICB9LAogICAgICBzZXRQYXJhbXM6IGZ1bmN0aW9uKHBhcmFtcykgewogICAgICAgIHRoaXMuY2xlYXJQYXJhbXMoKTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gcGFyYW1zKSB0aGlzLnNldFBhcmFtKGtleSwgcGFyYW1zW2tleV0pOwogICAgICB9LAogICAgICByZW1vdmVQYXJhbTogZnVuY3Rpb24obmFtZSkgewogICAgICAgIGRlbGV0ZSB0aGlzLnBhcmFtc1tuYW1lXTsKICAgICAgfSwKICAgICAgY2xlYXJQYXJhbXM6IGZ1bmN0aW9uKCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnBhcmFtcykgZGVsZXRlIHRoaXMucGFyYW1zW2tleV07CiAgICAgIH0sCiAgICAgIHByZXBhcmVSZXF1ZXN0RGF0YTogZnVuY3Rpb24ocmVxdWVzdERhdGEpIHsKICAgICAgICBpZiAoIXJlcXVlc3REYXRhLnVybCAmJiAhdGhpcy51cmwpIHRocm93IG5ldyBFcnJvcigiVVJMIGlzIG5vdCBkZWZpbmVkIik7CiAgICAgICAgZXh0ZW5kKHJlcXVlc3REYXRhLCB7CiAgICAgICAgICBoZWFkZXJzOiBvYmplY3RNZXJnZSh0aGlzLnJlcXVlc3RIZWFkZXJzLCByZXF1ZXN0RGF0YS5oZWFkZXJzKSwKICAgICAgICAgIHBhcmFtczogb2JqZWN0TWVyZ2UodGhpcy5wYXJhbXMsIHJlcXVlc3REYXRhLnBhcmFtcyksCiAgICAgICAgICByb3V0ZXJQYXJhbXM6IG9iamVjdE1lcmdlKHRoaXMucm91dGVyUGFyYW1zLCByZXF1ZXN0RGF0YS5yb3V0ZXJQYXJhbXMpCiAgICAgICAgfSk7CiAgICAgICAgYmFzaXMub2JqZWN0LmNvbXBsZXRlKHJlcXVlc3REYXRhLCB7CiAgICAgICAgICBhc3luY2hyb25vdXM6IHRoaXMuYXN5bmNocm9ub3VzLAogICAgICAgICAgdXJsOiB0aGlzLnVybCwKICAgICAgICAgIG1ldGhvZDogdGhpcy5tZXRob2QsCiAgICAgICAgICBjb250ZW50VHlwZTogdGhpcy5jb250ZW50VHlwZSwKICAgICAgICAgIGVuY29kaW5nOiB0aGlzLmVuY29kaW5nLAogICAgICAgICAgcG9zdEJvZHk6IHRoaXMucG9zdEJvZHksCiAgICAgICAgICByZXNwb25zZVR5cGU6IHRoaXMucmVzcG9uc2VUeXBlCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlcXVlc3REYXRhOwogICAgICB9CiAgICB9KTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBSZXF1ZXN0OiBSZXF1ZXN0LAogICAgICBUcmFuc3BvcnQ6IFRyYW5zcG9ydCwKICAgICAgcmVxdWVzdDogZnVuY3Rpb24oY29uZmlnLCBzdWNjZXNzQ2FsbGJhY2ssIGZhaWx1cmVDYWxsYmFjaykgewogICAgICAgIGlmICh0eXBlb2YgY29uZmlnID09ICJzdHJpbmciKSBjb25maWcgPSB7CiAgICAgICAgICB1cmw6IGNvbmZpZywKICAgICAgICAgIGFzeW5jaHJvbm91czogISEoc3VjY2Vzc0NhbGxiYWNrIHx8IGZhaWx1cmVDYWxsYmFjaykKICAgICAgICB9OwogICAgICAgIHZhciB0cmFuc3BvcnQgPSBuZXcgVHJhbnNwb3J0KGNvbmZpZyk7CiAgICAgICAgdHJhbnNwb3J0LmFkZEhhbmRsZXIoewogICAgICAgICAgc3VjY2Vzczogc3VjY2Vzc0NhbGxiYWNrICYmIGZ1bmN0aW9uKHNlbmRlciwgcmVxLCBkYXRhKSB7CiAgICAgICAgICAgIHN1Y2Nlc3NDYWxsYmFjayhkYXRhKTsKICAgICAgICAgIH0sCiAgICAgICAgICBmYWlsdXJlOiBmYWlsdXJlQ2FsbGJhY2sgJiYgZnVuY3Rpb24oc2VuZGVyLCByZXEsIGVycm9yKSB7CiAgICAgICAgICAgIGZhaWx1cmVDYWxsYmFjayhlcnJvcik7CiAgICAgICAgICB9LAogICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBiYXNpcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0cmFuc3BvcnQuZGVzdHJveSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgcmVxID0gdHJhbnNwb3J0LnJlcXVlc3QoKTsKICAgICAgICBpZiAoIXJlcS5yZXF1ZXN0RGF0YS5hc3luY2hyb25vdXMpIHJldHVybiByZXEuZ2V0UmVzcG9uc2VEYXRhKCk7CiAgICAgIH0KICAgIH07CiAgfSwKICAibS5qcyI6IGZ1bmN0aW9uKGV4cG9ydHMsIG1vZHVsZSwgYmFzaXMsIGdsb2JhbCwgX19maWxlbmFtZSwgX19kaXJuYW1lLCByZXF1aXJlLCByZXNvdXJjZSkgewogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBkb2N1bWVudCA9IGdsb2JhbC5kb2N1bWVudDsKICAgIHZhciB1c2VyQWdlbnQgPSBnbG9iYWwubmF2aWdhdG9yICYmIGdsb2JhbC5uYXZpZ2F0b3IudXNlckFnZW50IHx8ICIiOwogICAgdmFyIG9wZXJhID0gZ2xvYmFsLm9wZXJhOwogICAgdmFyIHZlcnNpb25zID0ge307CiAgICB2YXIgYW5zd2VycyA9IHt9OwogICAgdmFyIGJyb3dzZXJOYW1lID0gInVua25vd24iOwogICAgdmFyIGJyb3dzZXJQcmV0dHlOYW1lID0gInVua25vd24iOwogICAgdmFyIGJyb3dzZXJOYW1lcyA9IHsKICAgICAgTVNJRTogWyAiSW50ZXJuZXQgRXhwbG9yZXIiLCAibXNpZSIsICJpZSIgXSwKICAgICAgR2Vja286IFsgIkdlY2tvIiwgImdlY2tvIiBdLAogICAgICBTYWZhcmk6IFsgIlNhZmFyaSIsICJzYWZhcmkiIF0sCiAgICAgICJpUGhvbmUgT1MiOiBbICJpUGhvbmUiLCAiaXBob25lIiBdLAogICAgICBBZG9iZUFpcjogWyAiQWRvYmVBaXIiLCAiYWlyIiBdLAogICAgICBBcHBsZVdlYktpdDogWyAiV2ViS2l0IiBdLAogICAgICBDaHJvbWU6IFsgIkNocm9tZSIsICJjaHJvbWUiIF0sCiAgICAgIEZpcmVGb3g6IFsgIkZpcmVGb3giLCAiZmlyZWZveCIsICJmZiIgXSwKICAgICAgSWNld2Vhc2VsOiBbICJGaXJlRm94IiwgImZpcmVmb3giLCAiZmYiIF0sCiAgICAgIFNoaXJldG9rbzogWyAiRmlyZUZveCIsICJmaXJlZm94IiwgImZmIiBdLAogICAgICBPcGVyYTogWyAiT3BlcmEiLCAib3BlcmEiIF0KICAgIH07CiAgICBmb3IgKHZhciBuYW1lIGluIGJyb3dzZXJOYW1lcykgewogICAgICBpZiAobmFtZSA9PSAiTVNJRSIgJiYgb3BlcmEpIGNvbnRpbnVlOwogICAgICBpZiAobmFtZSA9PSAiU2FmYXJpIiAmJiAvY2hyb21lL2kudGVzdCh1c2VyQWdlbnQpKSBjb250aW51ZTsKICAgICAgaWYgKG5hbWUgPT0gIkFwcGxlV2ViS2l0IiAmJiAvaXBob25lL2kudGVzdCh1c2VyQWdlbnQpKSBjb250aW51ZTsKICAgICAgaWYgKHVzZXJBZ2VudC5tYXRjaChuZXcgUmVnRXhwKG5hbWUgKyAiLiIgKyAiKFxcZCsoXFwuXFxkKykqKSIsICJpIikpKSB7CiAgICAgICAgdmFyIG5hbWVzID0gYnJvd3Nlck5hbWVzW25hbWVdOwogICAgICAgIHZhciB2ZXJzaW9uID0gb3BlcmEgJiYgdHlwZW9mIG9wZXJhLnZlcnNpb24gPT0gImZ1bmN0aW9uIiA/IG9wZXJhLnZlcnNpb24oKSA6IFJlZ0V4cC4kMTsKICAgICAgICB2YXIgdmVyTnVtYmVyID0gdmVyc2lvblRvSW50KHZlcnNpb24pOwogICAgICAgIGJyb3dzZXJOYW1lID0gbmFtZXNbMF0gKyB2ZXJOdW1iZXI7CiAgICAgICAgYnJvd3NlclByZXR0eU5hbWUgPSBuYW1lc1swXSArICIgIiArIHZlcnNpb247CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBuYW1lcy5sZW5ndGg7IGorKykgdmVyc2lvbnNbbmFtZXNbal0udG9Mb3dlckNhc2UoKV0gPSB2ZXJOdW1iZXI7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHZlcnNpb25Ub0ludCh2ZXJzaW9uKSB7CiAgICAgIHZhciBiYXNlID0gMWU2OwogICAgICB2YXIgcGFydCA9IFN0cmluZyh2ZXJzaW9uKS5zcGxpdCgiLiIpOwogICAgICBmb3IgKHZhciBpID0gMCwgcmVzdWx0ID0gMDsgaSA8IDQgJiYgaSA8IHBhcnQubGVuZ3RoOyBpKyssIGJhc2UgLz0gMTAwKSByZXN1bHQgKz0gcGFydFtpXSAqIGJhc2U7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBmdW5jdGlvbiB0ZXN0QnJvd3Nlcihicm93c2VyTmFtZSkgewogICAgICB2YXIgZm9yVGVzdCA9IGJyb3dzZXJOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgIGlmIChmb3JUZXN0IGluIGFuc3dlcnMpIHJldHVybiBhbnN3ZXJzW2ZvclRlc3RdOwogICAgICB2YXIgbSA9IGZvclRlc3QubWF0Y2goL14oW2Etel0rKSgoW1xkXC5dKykoWystPV0/KSk/JC9pKTsKICAgICAgaWYgKG0pIHsKICAgICAgICBhbnN3ZXJzW2ZvclRlc3RdID0gZmFsc2U7CiAgICAgICAgdmFyIG5hbWUgPSBtWzFdLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgdmFyIHZlcnNpb24gPSB2ZXJzaW9uVG9JbnQobVszXSk7CiAgICAgICAgdmFyIG9wZXJhdGlvbiA9IG1bNF0gfHwgIj0iOwogICAgICAgIHZhciBjbXBWZXJzaW9uID0gdmVyc2lvbnNbbmFtZV07CiAgICAgICAgaWYgKGNtcFZlcnNpb24pIHJldHVybiBhbnN3ZXJzW2ZvclRlc3RdID0gIXZlcnNpb24gfHwgb3BlcmF0aW9uID09ICI9IiAmJiBjbXBWZXJzaW9uID09IHZlcnNpb24gfHwgb3BlcmF0aW9uID09ICIrIiAmJiBjbXBWZXJzaW9uID49IHZlcnNpb24gfHwgb3BlcmF0aW9uID09ICItIiAmJiBjbXBWZXJzaW9uIDwgdmVyc2lvbjsKICAgICAgfSBlbHNlIHsKICAgICAgICBiYXNpcy5kZXYud2FybigiQmFkIGJyb3dzZXIgdmVyc2lvbiBkZXNjcmlwdGlvbiBpbiBCcm93c2VyLnRlc3QoKSBmdW5jdGlvbjogIiArIGZvclRlc3QpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHZhciBjb29raWVzID0gewogICAgICBzZXQ6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlLCBleHBpcmUsIHBhdGgsIGRvbWFpbikgewogICAgICAgIGRvY3VtZW50LmNvb2tpZSA9IG5hbWUgKyAiPSIgKyAodmFsdWUgPT0gbnVsbCA/ICIiIDogZXNjYXBlKHZhbHVlKSkgKyAiO3BhdGg9IiArIChwYXRoIHx8IChsb2NhdGlvbi5wYXRobmFtZS5pbmRleE9mKCIvIikgPT0gMCA/ICIiIDogIi8iKSArIGxvY2F0aW9uLnBhdGhuYW1lKSArIChleHBpcmUgPyAiO2V4cGlyZXM9IiArIChuZXcgRGF0ZShEYXRlLm5vdygpICsgZXhwaXJlICogMWUzKSkudG9HTVRTdHJpbmcoKSA6ICIiKSArIChkb21haW4gPyAiO2RvbWFpbj0iICsgZG9tYWluIDogIiIpOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICB2YXIgbSA9IGRvY3VtZW50LmNvb2tpZS5tYXRjaChuZXcgUmVnRXhwKCIoXnw7KVxccyoiICsgbmFtZSArICJcXHMqPVxccyooLio/KVxccyooO3wkKSIpKTsKICAgICAgICByZXR1cm4gbSAmJiB1bmVzY2FwZShtWzJdKTsKICAgICAgfSwKICAgICAgcmVtb3ZlOiBmdW5jdGlvbihuYW1lLCBwYXRoLCBkb21haW4pIHsKICAgICAgICBkb2N1bWVudC5jb29raWUgPSBuYW1lICsgIj07ZXhwaXJlcz0iICsgKG5ldyBEYXRlKDApKS50b0dNVFN0cmluZygpICsgIjtwYXRoPSIgKyAocGF0aCB8fCAobG9jYXRpb24ucGF0aG5hbWUuaW5kZXhPZigiLyIpID09IDAgPyAiIiA6ICIvIikgKyBsb2NhdGlvbi5wYXRobmFtZSkgKyAoZG9tYWluID8gIjtkb21haW49IiArIGRvbWFpbiA6ICIiKTsKICAgICAgfQogICAgfTsKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBwcmV0dHlOYW1lOiBicm93c2VyUHJldHR5TmFtZSwKICAgICAgaXM6IHRlc3RCcm93c2VyLAogICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYmFzaXMuYXJyYXkoYXJndW1lbnRzKS5zb21lKHRlc3RCcm93c2VyKTsKICAgICAgfSwKICAgICAgY29va2llczogY29va2llcwogICAgfTsKICB9LAogICJuLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICBiYXNpcy5yZXF1aXJlKCIuLzQuanMiKTsKICAgIGJhc2lzLnJlcXVpcmUoIi4vbC5qcyIpOwogICAgdmFyIFNUQVRFX1VOREVGSU5FRCA9IGJhc2lzLmRhdGEuU1RBVEUuVU5ERUZJTkVEOwogICAgdmFyIFNUQVRFX1JFQURZID0gYmFzaXMuZGF0YS5TVEFURS5SRUFEWTsKICAgIHZhciBTVEFURV9QUk9DRVNTSU5HID0gYmFzaXMuZGF0YS5TVEFURS5QUk9DRVNTSU5HOwogICAgdmFyIFNUQVRFX0VSUk9SID0gYmFzaXMuZGF0YS5TVEFURS5FUlJPUjsKICAgIHZhciBub3RoaW5nVG9EbyA9IGZ1bmN0aW9uKCkge307CiAgICB2YXIgQ0FMTEJBQ0tfSEFORExFUiA9IHsKICAgICAgc3RhcnQ6IGZ1bmN0aW9uKHRyYW5zcG9ydCwgcmVxdWVzdCkgewogICAgICAgIHZhciBvcmlnaW4gPSByZXF1ZXN0LnJlcXVlc3REYXRhLm9yaWdpbjsKICAgICAgICB0aGlzLnN0YXJ0LmNhbGwocmVxdWVzdC5yZXF1ZXN0RGF0YS5vcmlnaW4pOwogICAgICAgIGlmIChvcmlnaW4uc3RhdGUgIT0gU1RBVEVfUFJPQ0VTU0lORykgb3JpZ2luLnNldFN0YXRlKFNUQVRFX1BST0NFU1NJTkcpOwogICAgICB9LAogICAgICBzdWNjZXNzOiBmdW5jdGlvbih0cmFuc3BvcnQsIHJlcXVlc3QsIGRhdGEpIHsKICAgICAgICB2YXIgb3JpZ2luID0gcmVxdWVzdC5yZXF1ZXN0RGF0YS5vcmlnaW47CiAgICAgICAgdGhpcy5zdWNjZXNzLmNhbGwob3JpZ2luLCBkYXRhKTsKICAgICAgICBpZiAob3JpZ2luLnN0YXRlID09IFNUQVRFX1BST0NFU1NJTkcpIG9yaWdpbi5zZXRTdGF0ZShTVEFURV9SRUFEWSk7CiAgICAgIH0sCiAgICAgIGZhaWx1cmU6IGZ1bmN0aW9uKHRyYW5zcG9ydCwgcmVxdWVzdCwgZXJyb3IpIHsKICAgICAgICB2YXIgb3JpZ2luID0gcmVxdWVzdC5yZXF1ZXN0RGF0YS5vcmlnaW47CiAgICAgICAgdGhpcy5mYWlsdXJlLmNhbGwob3JpZ2luLCBlcnJvcik7CiAgICAgICAgaWYgKG9yaWdpbi5zdGF0ZSA9PSBTVEFURV9QUk9DRVNTSU5HKSBvcmlnaW4uc2V0U3RhdGUoU1RBVEVfRVJST1IsIGVycm9yKTsKICAgICAgfSwKICAgICAgYWJvcnQ6IGZ1bmN0aW9uKHRyYW5zcG9ydCwgcmVxdWVzdCkgewogICAgICAgIHZhciBvcmlnaW4gPSByZXF1ZXN0LnJlcXVlc3REYXRhLm9yaWdpbjsKICAgICAgICB0aGlzLmFib3J0LmNhbGwob3JpZ2luKTsKICAgICAgICBpZiAob3JpZ2luLnN0YXRlID09IFNUQVRFX1BST0NFU1NJTkcpIG9yaWdpbi5zZXRTdGF0ZShTVEFURV9VTkRFRklORUQpOwogICAgICB9LAogICAgICBjb21wbGV0ZTogZnVuY3Rpb24odHJhbnNwb3J0LCByZXF1ZXN0KSB7CiAgICAgICAgdGhpcy5jb21wbGV0ZS5jYWxsKHJlcXVlc3QucmVxdWVzdERhdGEub3JpZ2luKTsKICAgICAgfQogICAgfTsKICAgIHZhciBERUZBVUxUX0NBTExCQUNLID0gewogICAgICBzdGFydDogbm90aGluZ1RvRG8sCiAgICAgIHN1Y2Nlc3M6IG5vdGhpbmdUb0RvLAogICAgICBmYWlsdXJlOiBub3RoaW5nVG9EbywKICAgICAgYWJvcnQ6IG5vdGhpbmdUb0RvLAogICAgICBjb21wbGV0ZTogbm90aGluZ1RvRG8KICAgIH07CiAgICBmdW5jdGlvbiByZXNvbHZlVHJhbnNwb3J0KGNvbmZpZykgewogICAgICBpZiAoY29uZmlnLnRyYW5zcG9ydCkgcmV0dXJuIGNvbmZpZy50cmFuc3BvcnQ7CiAgICAgIGlmIChjb25maWcuc2VydmljZSkgcmV0dXJuIGNvbmZpZy5zZXJ2aWNlLmNyZWF0ZVRyYW5zcG9ydChjb25maWcpOwogICAgICBpZiAoY29uZmlnLmNyZWF0ZVRyYW5zcG9ydCkgcmV0dXJuIGNvbmZpZy5jcmVhdGVUcmFuc3BvcnQoY29uZmlnKTsKICAgICAgcmV0dXJuIG5ldyBiYXNpcy5uZXQuYWpheC5UcmFuc3BvcnQoY29uZmlnKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNyZWF0ZUFjdGlvbihjb25maWcpIHsKICAgICAgY29uZmlnID0gYmFzaXMub2JqZWN0LmV4dGVuZCh7CiAgICAgICAgcHJlcGFyZTogbm90aGluZ1RvRG8sCiAgICAgICAgcmVxdWVzdDogbm90aGluZ1RvRG8KICAgICAgfSwgY29uZmlnKTsKICAgICAgdmFyIGZuID0gYmFzaXMub2JqZWN0LnNwbGljZShjb25maWcsIFsgInByZXBhcmUiLCAicmVxdWVzdCIgXSk7CiAgICAgIHZhciBjYWxsYmFjayA9IGJhc2lzLm9iamVjdC5tZXJnZShERUZBVUxUX0NBTExCQUNLLCBiYXNpcy5vYmplY3Quc3BsaWNlKGNvbmZpZywgWyAic3RhcnQiLCAic3VjY2VzcyIsICJmYWlsdXJlIiwgImFib3J0IiwgImNvbXBsZXRlIiBdKSk7CiAgICAgIHZhciBnZXRUcmFuc3BvcnQgPSBiYXNpcy5mbi5sYXp5SW5pdChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgdHJhbnNwb3J0ID0gcmVzb2x2ZVRyYW5zcG9ydChjb25maWcpOwogICAgICAgIHRyYW5zcG9ydC5hZGRIYW5kbGVyKENBTExCQUNLX0hBTkRMRVIsIGNhbGxiYWNrKTsKICAgICAgICByZXR1cm4gdHJhbnNwb3J0OwogICAgICB9KTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIGFjdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPSBTVEFURV9QUk9DRVNTSU5HKSB7CiAgICAgICAgICBmbi5wcmVwYXJlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICB0aGlzLnJlcXVlc3QgPSBnZXRUcmFuc3BvcnQoKS5yZXF1ZXN0KGJhc2lzLm9iamVjdC5jb21wbGV0ZSh7CiAgICAgICAgICAgIG9yaWdpbjogdGhpcwogICAgICAgICAgfSwgZm4ucmVxdWVzdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2lzLmRldi53YXJuKHRoaXMgKyAiIGhhcyBub3QgcmVhZHkgc3RhdGUuIE9wZXJhdGlvbiBhYm9ydGVkIik7CiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIGNyZWF0ZTogY3JlYXRlQWN0aW9uCiAgICB9OwogIH0sCiAgIm8uanMiOiBmdW5jdGlvbihleHBvcnRzLCBtb2R1bGUsIGJhc2lzLCBnbG9iYWwsIF9fZmlsZW5hbWUsIF9fZGlybmFtZSwgcmVxdWlyZSwgcmVzb3VyY2UpIHsKICAgIGJhc2lzLnJlcXVpcmUoIi4vOC5qcyIpOwogICAgdmFyIG5hbWVzcGFjZSA9IHRoaXMucGF0aDsKICAgIHZhciBucyA9IGJhc2lzLm5hbWVzcGFjZShTdHJpbmcobmFtZXNwYWNlKSk7CiAgICB2YXIgbG9jYXRpb24gPSBnbG9iYWwubG9jYXRpb247CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgICB2YXIgZG9jTW9kZSA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgIHZhciBldmVudFN1cHBvcnQgPSAib25oYXNoY2hhbmdlIiBpbiBnbG9iYWwgJiYgKGRvY01vZGUgPT09IHVuZGVmaW5lZCB8fCBkb2NNb2RlID4gNyk7CiAgICB2YXIgQ0hFQ0tfSU5URVJWQUwgPSA1MDsKICAgIHZhciBhcnJheUZyb20gPSBiYXNpcy5hcnJheS5mcm9tOwogICAgdmFyIHJvdXRlcyA9IHt9OwogICAgdmFyIG1hdGNoZWQgPSB7fTsKICAgIHZhciBzdGFydGVkID0gZmFsc2U7CiAgICB2YXIgY3VycmVudFBhdGg7CiAgICB2YXIgdGltZXI7CiAgICBmdW5jdGlvbiBwYXRoVG9SZWdFeHAocm91dGUpIHsKICAgICAgdmFyIHZhbHVlID0gU3RyaW5nKHJvdXRlIHx8ICIiKTsKICAgICAgZnVuY3Rpb24gZmluZFdvcmQob2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLnN1YnN0cihvZmZzZXQpLm1hdGNoKC9eXHcrLyk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcGFyc2Uob2Zmc2V0LCBzdG9wQ2hhcikgewogICAgICAgIHZhciByZXN1bHQgPSAiIjsKICAgICAgICB2YXIgcmVzOwogICAgICAgIGZvciAodmFyIGkgPSBvZmZzZXQ7IGkgPCB2YWx1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIGMgPSB2YWx1ZS5jaGFyQXQoaSk7CiAgICAgICAgICBzd2l0Y2ggKGMpIHsKICAgICAgICAgICAgY2FzZSBzdG9wQ2hhcjoKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcmVzdWx0OiByZXN1bHQsCiAgICAgICAgICAgICAgICBvZmZzZXQ6IGkKICAgICAgICAgICAgICB9OwogICAgICAgICAgICBjYXNlICJcXCI6CiAgICAgICAgICAgICAgcmVzdWx0ICs9ICJcXCIgKyB2YWx1ZS5jaGFyQXQoKytpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAifCI6CiAgICAgICAgICAgICAgcmVzdWx0ICs9IHN0b3BDaGFyICE9ICIpIiA/ICJcXHwiIDogInwiOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICIoIjoKICAgICAgICAgICAgICBpZiAocmVzID0gcGFyc2UoaSArIDEsICIpIikpIHsKICAgICAgICAgICAgICAgIGkgPSByZXMub2Zmc2V0OwogICAgICAgICAgICAgICAgcmVzdWx0ICs9ICIoPzoiICsgcmVzLnJlc3VsdCArICIpPyI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdCArPSAiXFwoIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIjoiOgogICAgICAgICAgICAgIGlmIChyZXMgPSBmaW5kV29yZChpICsgMSkpIHsKICAgICAgICAgICAgICAgIGkgKz0gcmVzWzBdLmxlbmd0aDsKICAgICAgICAgICAgICAgIHJlc3VsdCArPSAiKFteL10rKSI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc3VsdCArPSAiOiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICIqIjoKICAgICAgICAgICAgICBpZiAocmVzID0gZmluZFdvcmQoaSArIDEpKSB7CiAgICAgICAgICAgICAgICBpICs9IHJlc1swXS5sZW5ndGg7CiAgICAgICAgICAgICAgICByZXN1bHQgKz0gIiguKj8pIjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzdWx0ICs9ICJcXCoiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXN1bHQgKz0gYmFzaXMuc3RyaW5nLmZvclJlZ0V4cChjKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0b3BDaGFyID8gbnVsbCA6IHJlc3VsdDsKICAgICAgfQogICAgICByZXR1cm4gbmV3IFJlZ0V4cCgiXiIgKyBwYXJzZSgwKSArICIkIiwgImkiKTsKICAgIH0KICAgIGZ1bmN0aW9uIHN0YXJ0V2F0Y2goKSB7CiAgICAgIGlmIChldmVudFN1cHBvcnQpIGJhc2lzLmRvbS5ldmVudC5hZGRIYW5kbGVyKGdsb2JhbCwgImhhc2hjaGFuZ2UiLCBjaGVja1VybCk7IGVsc2UgdGltZXIgPSBzZXRJbnRlcnZhbChjaGVja1VybCwgQ0hFQ0tfSU5URVJWQUwpOwogICAgfQogICAgZnVuY3Rpb24gc3RvcFdhdGNoKCkgewogICAgICBpZiAoZXZlbnRTdXBwb3J0KSBiYXNpcy5kb20uZXZlbnQucmVtb3ZlSGFuZGxlcihnbG9iYWwsICJoYXNoY2hhbmdlIiwgY2hlY2tVcmwpOyBlbHNlIGNsZWFySW50ZXJ2YWwodGltZXIpOwogICAgfQogICAgZnVuY3Rpb24gc3RhcnQoKSB7CiAgICAgIGlmICghc3RhcnRlZCkgewogICAgICAgIHN0YXJ0V2F0Y2goKTsKICAgICAgICBzdGFydGVkID0gdHJ1ZTsKICAgICAgICBpZiAobnMuZGVidWcpIGJhc2lzLmRldi5sb2cobmFtZXNwYWNlICsgIiBzdGFydGVkIik7CiAgICAgICAgY2hlY2tVcmwoKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gc3RvcCgpIHsKICAgICAgaWYgKHN0YXJ0ZWQpIHsKICAgICAgICBzdG9wV2F0Y2goKTsKICAgICAgICBzdGFydGVkID0gZmFsc2U7CiAgICAgICAgaWYgKG5zLmRlYnVnKSBiYXNpcy5kZXYubG9nKG5hbWVzcGFjZSArICIgc3RvcHBlZCIpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBjaGVja1VybCgpIHsKICAgICAgdmFyIG5ld1BhdGggPSBsb2NhdGlvbi5oYXNoLnN1YnN0cigxKSB8fCAiIjsKICAgICAgaWYgKG5ld1BhdGggIT0gY3VycmVudFBhdGgpIHsKICAgICAgICB2YXIgaW5zZXJ0ZWQgPSBbXTsKICAgICAgICB2YXIgZGVsZXRlZCA9IFtdOwogICAgICAgIHZhciBsb2cgPSBbXTsKICAgICAgICBjdXJyZW50UGF0aCA9IG5ld1BhdGg7CiAgICAgICAgZm9yICh2YXIgcGF0aCBpbiByb3V0ZXMpIHsKICAgICAgICAgIHZhciByb3V0ZSA9IHJvdXRlc1twYXRoXTsKICAgICAgICAgIHZhciBtYXRjaCA9IG5ld1BhdGgubWF0Y2gocm91dGUucmVnZXhwKTsKICAgICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICBpZiAoIW1hdGNoZWRbcGF0aF0pIGluc2VydGVkLnB1c2gocm91dGUpOwogICAgICAgICAgICBtYXRjaGVkW3BhdGhdID0gbWF0Y2g7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobWF0Y2hlZFtwYXRoXSkgewogICAgICAgICAgICAgIGRlbGV0ZWQucHVzaChyb3V0ZSk7CiAgICAgICAgICAgICAgZGVsZXRlIG1hdGNoZWRbcGF0aF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIHJvdXRlOyByb3V0ZSA9IGRlbGV0ZWRbaV07IGkrKykgewogICAgICAgICAgdmFyIGNhbGxiYWNrcyA9IGFycmF5RnJvbShyb3V0ZS5jYWxsYmFja3MpOwogICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGl0ZW07IGl0ZW0gPSBjYWxsYmFja3Nbal07IGorKykgaWYgKGl0ZW0uY2FsbGJhY2subGVhdmUpIHsKICAgICAgICAgICAgaXRlbS5jYWxsYmFjay5sZWF2ZS5jYWxsKGl0ZW0uY29udGV4dCk7CiAgICAgICAgICAgIGxvZy5wdXNoKCJcbiIsIHsKICAgICAgICAgICAgICB0eXBlOiAibGVhdmUiLAogICAgICAgICAgICAgIHBhdGg6IHJvdXRlLnNvdXJjZSwKICAgICAgICAgICAgICBjYjogaXRlbSwKICAgICAgICAgICAgICByb3V0ZTogcm91dGUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAodmFyIGkgPSAwLCByb3V0ZTsgcm91dGUgPSBpbnNlcnRlZFtpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gYXJyYXlGcm9tKHJvdXRlLmNhbGxiYWNrcyk7CiAgICAgICAgICBmb3IgKHZhciBqID0gMCwgaXRlbTsgaXRlbSA9IGNhbGxiYWNrc1tqXTsgaisrKSBpZiAoaXRlbS5jYWxsYmFjay5lbnRlcikgewogICAgICAgICAgICBpdGVtLmNhbGxiYWNrLmVudGVyLmNhbGwoaXRlbS5jb250ZXh0KTsKICAgICAgICAgICAgbG9nLnB1c2goIlxuIiwgewogICAgICAgICAgICAgIHR5cGU6ICJlbnRlciIsCiAgICAgICAgICAgICAgcGF0aDogcm91dGUuc291cmNlLAogICAgICAgICAgICAgIGNiOiBpdGVtLAogICAgICAgICAgICAgIHJvdXRlOiByb3V0ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgcGF0aCBpbiBtYXRjaGVkKSB7CiAgICAgICAgICB2YXIgcm91dGUgPSByb3V0ZXNbcGF0aF07CiAgICAgICAgICB2YXIgYXJncyA9IGFycmF5RnJvbShtYXRjaGVkW3BhdGhdLCAxKTsKICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBhcnJheUZyb20ocm91dGUuY2FsbGJhY2tzKTsKICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gY2FsbGJhY2tzW2ldOyBpKyspIGlmIChpdGVtLmNhbGxiYWNrLm1hdGNoKSB7CiAgICAgICAgICAgIGl0ZW0uY2FsbGJhY2subWF0Y2guYXBwbHkoaXRlbS5jb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgbG9nLnB1c2goIlxuIiwgewogICAgICAgICAgICAgIHR5cGU6ICJtYXRjaCIsCiAgICAgICAgICAgICAgcGF0aDogcm91dGUuc291cmNlLAogICAgICAgICAgICAgIGNiOiBpdGVtLAogICAgICAgICAgICAgIHJvdXRlOiByb3V0ZSwKICAgICAgICAgICAgICBhcmdzOiBhcmdzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobnMuZGVidWcpIGJhc2lzLmRldi5pbmZvLmFwcGx5KGJhc2lzLmRldiwgWyBuYW1lc3BhY2UgKyAnOiBoYXNoIGNoYW5nZWQgdG8gIicgKyBuZXdQYXRoICsgJyInIF0uY29uY2F0KGxvZy5sZW5ndGggPyBsb2cgOiAiPG5vIG1hdGNoZXM+IikpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBhZGQocGF0aCwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgdmFyIHJvdXRlID0gcm91dGVzW3BhdGhdOwogICAgICB2YXIgY29uZmlnOwogICAgICBpZiAoIXJvdXRlKSB7CiAgICAgICAgcm91dGUgPSByb3V0ZXNbcGF0aF0gPSB7CiAgICAgICAgICBzb3VyY2U6IHBhdGgsCiAgICAgICAgICBjYWxsYmFja3M6IFtdLAogICAgICAgICAgcmVnZXhwOiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwocGF0aCkgIT0gIltvYmplY3QgUmVnRXhwXSIgPyBwYXRoVG9SZWdFeHAocGF0aCkgOiBwYXRoCiAgICAgICAgfTsKICAgICAgICBpZiAodHlwZW9mIGN1cnJlbnRQYXRoID09ICJzdHJpbmciKSB7CiAgICAgICAgICB2YXIgbWF0Y2ggPSBjdXJyZW50UGF0aC5tYXRjaChyb3V0ZS5yZWdleHApOwogICAgICAgICAgaWYgKG1hdGNoKSBtYXRjaGVkW3BhdGhdID0gbWF0Y2g7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbmZpZyA9IHsKICAgICAgICBjYl86IGNhbGxiYWNrLAogICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgY2FsbGJhY2s6IHR5cGVvZiBjYWxsYmFjayAhPSAiZnVuY3Rpb24iID8gY2FsbGJhY2sgfHwge30gOiB7CiAgICAgICAgICBtYXRjaDogY2FsbGJhY2sKICAgICAgICB9CiAgICAgIH07CiAgICAgIHJvdXRlLmNhbGxiYWNrcy5wdXNoKGNvbmZpZyk7CiAgICAgIGlmIChwYXRoIGluIG1hdGNoZWQpIHsKICAgICAgICBpZiAoY29uZmlnLmNhbGxiYWNrLmVudGVyKSBjb25maWcuY2FsbGJhY2suZW50ZXIuY2FsbChjb250ZXh0KTsKICAgICAgICBpZiAoY29uZmlnLmNhbGxiYWNrLm1hdGNoKSBjb25maWcuY2FsbGJhY2subWF0Y2guYXBwbHkoY29udGV4dCwgYXJyYXlGcm9tKG1hdGNoZWRbcGF0aF0sIDEpKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlKHBhdGgsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciByb3V0ZSA9IHJvdXRlc1twYXRoXTsKICAgICAgaWYgKHJvdXRlKSB7CiAgICAgICAgdmFyIGlkeCA9IC0xOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBjYjsgY2IgPSByb3V0ZS5jYWxsYmFja3NbaV07IGkrKykgaWYgKGNiLmNiXyA9PT0gY2FsbGJhY2sgJiYgY2IuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgICAgcm91dGUuY2FsbGJhY2tzLnNwbGljZShpLCAxKTsKICAgICAgICAgIGlmICghcm91dGUuY2FsbGJhY2tzLmxlbmd0aCkgewogICAgICAgICAgICBkZWxldGUgcm91dGVzW3BhdGhdOwogICAgICAgICAgICBkZWxldGUgbWF0Y2hlZFtwYXRoXTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gbmF2aWdhdGUocGF0aCwgcmVwbGFjZSkgewogICAgICBpZiAocmVwbGFjZSkgbG9jYXRpb24ucmVwbGFjZShsb2NhdGlvbi5wYXRobmFtZSArICIjIiArIHBhdGgpOyBlbHNlIGxvY2F0aW9uLmhhc2ggPSBwYXRoOwogICAgICBpZiAoc3RhcnRlZCkgY2hlY2tVcmwoKTsKICAgIH0KICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICBkZWJ1ZzogZmFsc2UsCiAgICAgIGFkZDogYWRkLAogICAgICByZW1vdmU6IHJlbW92ZSwKICAgICAgc3RvcDogc3RvcCwKICAgICAgc3RhcnQ6IHN0YXJ0LAogICAgICBjaGVja1VybDogY2hlY2tVcmwsCiAgICAgIG5hdmlnYXRlOiBuYXZpZ2F0ZQogICAgfTsKICB9LAogICJwLmpzIjogZnVuY3Rpb24oZXhwb3J0cywgbW9kdWxlLCBiYXNpcywgZ2xvYmFsLCBfX2ZpbGVuYW1lLCBfX2Rpcm5hbWUsIHJlcXVpcmUsIHJlc291cmNlKSB7CiAgICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQgfHwgewogICAgICB0aXRsZTogInVua25vd24iCiAgICB9OwogICAgdmFyIGFwcFRpdGxlID0gZG9jdW1lbnQudGl0bGU7CiAgICB2YXIgYXBwSW5pdCA9IGJhc2lzLmZuLiR1bmRlZjsKICAgIHZhciBhcHBJbmplY3RQb2ludDsKICAgIHZhciBhcHBFbDsKICAgIGZ1bmN0aW9uIHVwZGF0ZVRpdGxlKHZhbHVlKSB7CiAgICAgIGRvY3VtZW50LnRpdGxlID0gdmFsdWU7CiAgICB9CiAgICBmdW5jdGlvbiByZXNvbHZlTm9kZShyZWYpIHsKICAgICAgcmV0dXJuIHR5cGVvZiByZWYgPT0gInN0cmluZyIgPyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChyZWYpIDogcmVmOwogICAgfQogICAgZnVuY3Rpb24gcmVwbGFjZU5vZGUob2xkQ2hpbGQsIG5ld0NoaWxkKSB7CiAgICAgIG9sZENoaWxkLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKG5ld0NoaWxkLCBvbGRDaGlsZCk7CiAgICB9CiAgICB2YXIgY3JlYXRlQXBwID0gYmFzaXMuZm4ubGF6eUluaXQoZnVuY3Rpb24oY29uZmlnKSB7CiAgICAgIHZhciByZWFkeUhhbmRsZXJzID0gW107CiAgICAgIHZhciBpbml0ZWQgPSBmYWxzZTsKICAgICAgdmFyIGFwcCA9IHsKICAgICAgICBpbml0ZWQ6IGZhbHNlLAogICAgICAgIHNldFRpdGxlOiBmdW5jdGlvbih0aXRsZSkgewogICAgICAgICAgaWYgKHRpdGxlICE9IGFwcFRpdGxlKSB7CiAgICAgICAgICAgIGlmIChhcHBUaXRsZSBpbnN0YW5jZW9mIGJhc2lzLlRva2VuKSBhcHBUaXRsZS5kZXRhY2godXBkYXRlVGl0bGUpOwogICAgICAgICAgICBpZiAodGl0bGUgaW5zdGFuY2VvZiBiYXNpcy5Ub2tlbikgewogICAgICAgICAgICAgIHRpdGxlLmF0dGFjaCh1cGRhdGVUaXRsZSk7CiAgICAgICAgICAgICAgdXBkYXRlVGl0bGUodGl0bGUuZ2V0KCkpOwogICAgICAgICAgICB9IGVsc2UgdXBkYXRlVGl0bGUodGl0bGUpOwogICAgICAgICAgICBhcHBUaXRsZSA9IHRpdGxlOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgc2V0RWxlbWVudDogZnVuY3Rpb24oZWwpIHsKICAgICAgICAgIHZhciBuZXdBcHBFbCA9IHJlc29sdmVOb2RlKGVsKTsKICAgICAgICAgIGlmIChhcHBFbCA9PSBuZXdBcHBFbCkgcmV0dXJuOwogICAgICAgICAgaWYgKGFwcEVsKSB7CiAgICAgICAgICAgIHJlcGxhY2VOb2RlKGFwcEVsLCBuZXdBcHBFbCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gZWxzZSBhcHBFbCA9IG5ld0FwcEVsOwogICAgICAgICAgaWYgKCFhcHBJbmplY3RQb2ludCkgYXBwSW5qZWN0UG9pbnQgPSB7CiAgICAgICAgICAgIHR5cGU6ICJhcHBlbmQiLAogICAgICAgICAgICBub2RlOiBkb2N1bWVudC5ib2R5CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIG5vZGUgPSByZXNvbHZlTm9kZShhcHBJbmplY3RQb2ludC5ub2RlKTsKICAgICAgICAgIGlmICghbm9kZSkgcmV0dXJuOwogICAgICAgICAgaWYgKGFwcEluamVjdFBvaW50LnR5cGUgPT0gImFwcGVuZCIpIG5vZGUuYXBwZW5kQ2hpbGQoYXBwRWwpOyBlbHNlIHJlcGxhY2VOb2RlKG5vZGUsIGFwcEVsKTsKICAgICAgICB9LAogICAgICAgIHJlYWR5OiBmdW5jdGlvbihmbiwgY29udGV4dCkgewogICAgICAgICAgaWYgKGluaXRlZCkgZm4uY2FsbChjb250ZXh0LCBhcHApOyBlbHNlIHJlYWR5SGFuZGxlcnMucHVzaCh7CiAgICAgICAgICAgIGZuOiBmbiwKICAgICAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9OwogICAgICBmb3IgKHZhciBrZXkgaW4gY29uZmlnKSB7CiAgICAgICAgdmFyIHZhbHVlID0gY29uZmlnW2tleV07CiAgICAgICAgc3dpdGNoIChrZXkpIHsKICAgICAgICAgIGNhc2UgInRpdGxlIjoKICAgICAgICAgICAgYXBwLnNldFRpdGxlKHZhbHVlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJjb250YWluZXIiOgogICAgICAgICAgICBhcHBJbmplY3RQb2ludCA9IHsKICAgICAgICAgICAgICB0eXBlOiAiYXBwZW5kIiwKICAgICAgICAgICAgICBub2RlOiB2YWx1ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgInJlcGxhY2UiOgogICAgICAgICAgICBhcHBJbmplY3RQb2ludCA9IHsKICAgICAgICAgICAgICB0eXBlOiAicmVwbGFjZSIsCiAgICAgICAgICAgICAgbm9kZTogdmFsdWUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJlbGVtZW50IjoKICAgICAgICAgICAgYXBwRWwgPSB2YWx1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJpbml0IjoKICAgICAgICAgICAgYXBwSW5pdCA9IHR5cGVvZiB2YWx1ZSA9PSAiZnVuY3Rpb24iID8gdmFsdWUgOiBhcHBJbml0OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGJhc2lzLmRldi53YXJuKCJVbmtub3duIGNvbmZpZyBwcm9wZXJ0eSBgIiArIGtleSArICJgIGZvciBhcHAsIHZhbHVlOiIsIHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYmFzaXMucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGluc2VydEVsID0gYXBwRWw7CiAgICAgICAgdmFyIGluaXRSZXN1bHQgPSBhcHBJbml0LmNhbGwoYXBwKTsKICAgICAgICBpZiAoaW5pdFJlc3VsdCkgewogICAgICAgICAgaWYgKGluaXRSZXN1bHQuZWxlbWVudCkgaW5zZXJ0RWwgPSBpbml0UmVzdWx0LmVsZW1lbnQ7IGVsc2UgaW5zZXJ0RWwgPSBpbml0UmVzdWx0OwogICAgICAgIH0KICAgICAgICBhcHBFbCA9IG51bGw7CiAgICAgICAgYXBwLnNldEVsZW1lbnQoaW5zZXJ0RWwpOwogICAgICAgIGluaXRlZCA9IHRydWU7CiAgICAgICAgYXBwLmluaXRlZCA9IHRydWU7CiAgICAgICAgdmFyIGhhbmRsZXI7CiAgICAgICAgd2hpbGUgKGhhbmRsZXIgPSByZWFkeUhhbmRsZXJzLnNoaWZ0KCkpIGhhbmRsZXIuZm4uY2FsbChoYW5kbGVyLmNvbnRleHQsIGFwcCk7CiAgICAgIH0pOwogICAgICByZXR1cm4gYXBwOwogICAgfSk7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHsKICAgICAgY3JlYXRlOiBjcmVhdGVBcHAKICAgIH07CiAgfQp9OwoKKGZ1bmN0aW9uIGNyZWF0ZUJhc2lzSW5zdGFuY2UoZ2xvYmFsLCBfX2Jhc2lzRmlsZW5hbWUsIF9fY29uZmlnKSB7CiAgInVzZSBzdHJpY3QiOwogIHZhciBWRVJTSU9OID0gIjEuMy4zIjsKICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKICBmdW5jdGlvbiBnZW5VSUQobGVuKSB7CiAgICBmdW5jdGlvbiBiYXNlMzYodmFsKSB7CiAgICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbCkudG9TdHJpbmcoMzYpOwogICAgfQogICAgdmFyIHJlc3VsdCA9IGJhc2UzNigxMCArIDI1ICogTWF0aC5yYW5kb20oKSk7CiAgICBpZiAoIWxlbikgbGVuID0gMTY7CiAgICB3aGlsZSAocmVzdWx0Lmxlbmd0aCA8IGxlbikgcmVzdWx0ICs9IGJhc2UzNihuZXcgRGF0ZSAqIE1hdGgucmFuZG9tKCkpOwogICAgcmV0dXJuIHJlc3VsdC5zdWJzdHIoMCwgbGVuKTsKICB9CiAgZnVuY3Rpb24gZXh0ZW5kKGRlc3QsIHNvdXJjZSkgewogICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkgZGVzdFtrZXldID0gc291cmNlW2tleV07CiAgICByZXR1cm4gZGVzdDsKICB9CiAgZnVuY3Rpb24gY29tcGxldGUoZGVzdCwgc291cmNlKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gc291cmNlKSBpZiAoa2V5IGluIGRlc3QgPT0gZmFsc2UpIGRlc3Rba2V5XSA9IHNvdXJjZVtrZXldOwogICAgcmV0dXJuIGRlc3Q7CiAgfQogIGZ1bmN0aW9uIGtleXMob2JqZWN0KSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSByZXN1bHQucHVzaChrZXkpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gdmFsdWVzKG9iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkgcmVzdWx0LnB1c2gob2JqZWN0W2tleV0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gc2xpY2Uoc291cmNlLCBrZXlzKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICBpZiAoIWtleXMpIHJldHVybiBleHRlbmQocmVzdWx0LCBzb3VyY2UpOwogICAgZm9yICh2YXIgaSA9IDAsIGtleTsga2V5ID0ga2V5c1tpKytdOyApIGlmIChrZXkgaW4gc291cmNlKSByZXN1bHRba2V5XSA9IHNvdXJjZVtrZXldOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gc3BsaWNlKHNvdXJjZSwga2V5cykgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgaWYgKCFrZXlzKSByZXR1cm4gZXh0ZW5kKHJlc3VsdCwgc291cmNlKTsKICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGtleXNbaSsrXTsgKSBpZiAoa2V5IGluIHNvdXJjZSkgewogICAgICByZXN1bHRba2V5XSA9IHNvdXJjZVtrZXldOwogICAgICBkZWxldGUgc291cmNlW2tleV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBtZXJnZSgpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSBleHRlbmQocmVzdWx0LCBhcmd1bWVudHNbaV0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgZnVuY3Rpb24gaXRlcmF0ZShvYmplY3QsIGNhbGxiYWNrLCB0aGlzT2JqZWN0KSB7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSByZXN1bHQucHVzaChjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIGtleSwgb2JqZWN0W2tleV0pKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGZ1bmN0aW9uICR1bmRlZmluZWQodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA9PSB1bmRlZmluZWQ7CiAgfQogIGZ1bmN0aW9uICRkZWZpbmVkKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgIT0gdW5kZWZpbmVkOwogIH0KICBmdW5jdGlvbiAkaXNOdWxsKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB2YWx1ZSA9PSB1bmRlZmluZWQ7CiAgfQogIGZ1bmN0aW9uICRpc05vdE51bGwodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSAhPSBudWxsICYmIHZhbHVlICE9IHVuZGVmaW5lZDsKICB9CiAgZnVuY3Rpb24gJGlzU2FtZSh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlID09PSB0aGlzOwogIH0KICBmdW5jdGlvbiAkaXNOb3RTYW1lKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUgIT09IHRoaXM7CiAgfQogIGZ1bmN0aW9uICRzZWxmKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGZ1bmN0aW9uICRjb25zdCh2YWx1ZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwogIH0KICBmdW5jdGlvbiAkZmFsc2UoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGZ1bmN0aW9uICR0cnVlKCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGZ1bmN0aW9uICRudWxsKCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGZ1bmN0aW9uICR1bmRlZigpIHt9CiAgdmFyIGdldHRlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIElEID0gImJhc2lzR2V0dGVySWQiICsgZ2VuVUlEKCkgKyAiXyI7CiAgICB2YXIgbW9kaWZpY2F0b3JTZWVkID0gMTsKICAgIHZhciBzaW1wbGVQYXRoID0gL15bYS16JF9dW2EteiRfMC05XSooXC5bYS16JF9dW2EteiRfMC05XSopKiQvaTsKICAgIHZhciBnZXR0ZXJNYXAgPSBbXTsKICAgIHZhciBwYXRoQ2FjaGUgPSB7fTsKICAgIHZhciBtb2RDYWNoZSA9IHt9OwogICAgZnVuY3Rpb24gYnVpbGRGdW5jdGlvbihwYXRoKSB7CiAgICAgIGlmIChzaW1wbGVQYXRoLnRlc3QocGF0aCkpIHsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCIuIik7CiAgICAgICAgdmFyIGZvbyA9IHBhcnRzWzBdOwogICAgICAgIHZhciBiYXIgPSBwYXJ0c1sxXTsKICAgICAgICB2YXIgYmF6ID0gcGFydHNbMl07CiAgICAgICAgdmFyIGZuOwogICAgICAgIHN3aXRjaCAocGFydHMubGVuZ3RoKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGZuID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdCAhPSBudWxsID8gb2JqZWN0W2Zvb10gOiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dW2Jhcl0gOiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dW2Jhcl1bYmF6XSA6IG9iamVjdDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICAgIGlmIChvYmplY3QgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgb2JqZWN0ID0gb2JqZWN0W2Zvb11bYmFyXVtiYXpdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDMsIGtleTsga2V5ID0gcGFydHNbaV07IGkrKykgb2JqZWN0ID0gb2JqZWN0W2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZuID0gRnVuY3Rpb24oInBhcnRzIiwgInJldHVybiAiICsgZm4udG9TdHJpbmcoKS5yZXBsYWNlKC8oZm9vfGJhcnxiYXopL2csIGZ1bmN0aW9uKG0sIHcpIHsKICAgICAgICAgIHJldHVybiAnIicgKyBwYXJ0c1t3ID09ICJmb28iID8gMCA6IHcgPT0gImJhciIgPyAxIDogMl0gKyAnIic7CiAgICAgICAgfSkucmVwbGFjZSgvXFtcIihbXiJdKylcIlxdL2csICIuJDEiKSkocGFydHMpOwogICAgICAgIHJldHVybiBmbjsKICAgICAgfQogICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCJvYmplY3QiLCAicmV0dXJuIG9iamVjdCAhPSBudWxsID8gb2JqZWN0LiIgKyBwYXRoICsgIiA6IG9iamVjdCIpOwogICAgfQogICAgdmFyIGdldHRlckZuID0gZnVuY3Rpb24ocGF0aCwgbW9kaWZpY2F0b3IpIHsKICAgICAgdmFyIGZ1bmM7CiAgICAgIHZhciByZXN1bHQ7CiAgICAgIHZhciBnZXR0ZXJJZDsKICAgICAgaWYgKCFwYXRoIHx8IHBhdGggPT09IG51bGxHZXR0ZXIpIHJldHVybiBudWxsR2V0dGVyOwogICAgICBpZiAodHlwZW9mIHBhdGggPT0gImZ1bmN0aW9uIikgewogICAgICAgIGdldHRlcklkID0gcGF0aFtJRF07CiAgICAgICAgaWYgKGdldHRlcklkKSB7CiAgICAgICAgICBmdW5jID0gZ2V0dGVyTWFwW01hdGguYWJzKGdldHRlcklkKSAtIDFdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmdW5jID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBwYXRoKG9iamVjdCk7CiAgICAgICAgICB9OwogICAgICAgICAgZnVuYy5iYXNlID0gcGF0aDsKICAgICAgICAgIGZ1bmMuX19leHRlbmRfXyA9IGdldHRlcjsKICAgICAgICAgIGdldHRlcklkID0gZ2V0dGVyTWFwLnB1c2goZnVuYyk7CiAgICAgICAgICBwYXRoW0lEXSA9IC1nZXR0ZXJJZDsKICAgICAgICAgIGZ1bmNbSURdID0gZ2V0dGVySWQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZ1bmMgPSBwYXRoQ2FjaGVbcGF0aF07CiAgICAgICAgaWYgKGZ1bmMpIHsKICAgICAgICAgIGdldHRlcklkID0gZnVuY1tJRF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZ1bmMgPSBidWlsZEZ1bmN0aW9uKHBhdGgpOwogICAgICAgICAgZnVuYy5iYXNlID0gcGF0aDsKICAgICAgICAgIGZ1bmMuX19leHRlbmRfXyA9IGdldHRlcjsKICAgICAgICAgIGdldHRlcklkID0gZ2V0dGVyTWFwLnB1c2goZnVuYyk7CiAgICAgICAgICBmdW5jW0lEXSA9IGdldHRlcklkOwogICAgICAgICAgcGF0aENhY2hlW3BhdGhdID0gZnVuYzsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIG1vZFR5cGUgPSBtb2RpZmljYXRvciAhPSBudWxsICYmIHR5cGVvZiBtb2RpZmljYXRvcjsKICAgICAgaWYgKCFtb2RUeXBlKSByZXR1cm4gZnVuYzsKICAgICAgdmFyIG1vZExpc3QgPSBtb2RDYWNoZVtnZXR0ZXJJZF07CiAgICAgIHZhciBtb2RJZDsKICAgICAgaWYgKG1vZFR5cGUgPT0gInN0cmluZyIpIG1vZElkID0gbW9kVHlwZSArIG1vZGlmaWNhdG9yOyBlbHNlIGlmIChtb2RUeXBlID09ICJmdW5jdGlvbiIpIG1vZElkID0gbW9kaWZpY2F0b3IuYmFzaXNNb2RJZF87IGVsc2UgaWYgKG1vZFR5cGUgIT0gIm9iamVjdCIpIHsKICAgICAgICBjb25zb2xlTWV0aG9kcy53YXJuKCJiYXNpcy5nZXR0ZXI6IHdyb25nIG1vZGlmaWNhdG9yIHR5cGUsIG1vZGlmaWNhdG9yIG5vdCB1c2VkLCBwYXRoOiAiLCBwYXRoLCAiLCBtb2RpZmljYXRvcjoiLCBtb2RpZmljYXRvcik7CiAgICAgICAgcmV0dXJuIGZ1bmM7CiAgICAgIH0KICAgICAgaWYgKG1vZElkICYmIG1vZExpc3QgJiYgbW9kTGlzdFttb2RJZF0pIHJldHVybiBtb2RMaXN0W21vZElkXTsKICAgICAgaWYgKHR5cGVvZiBmdW5jLmJhc2UgPT0gImZ1bmN0aW9uIikgZnVuYyA9IGZ1bmMuYmFzZTsKICAgICAgc3dpdGNoIChtb2RUeXBlKSB7CiAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgIHJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nRnVuY3Rpb25zLmZvcm1hdChtb2RpZmljYXRvciwgZnVuYyhvYmplY3QpKTsKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICBpZiAoIW1vZElkKSB7CiAgICAgICAgICAgIG1vZElkID0gbW9kVHlwZSArIG1vZGlmaWNhdG9yU2VlZCsrOwogICAgICAgICAgICBtb2RpZmljYXRvci5iYXNpc01vZElkXyA9IG1vZElkOwogICAgICAgICAgfQogICAgICAgICAgcmVzdWx0ID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICAgIHJldHVybiBtb2RpZmljYXRvcihmdW5jKG9iamVjdCkpOwogICAgICAgICAgfTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICAgICAgcmV0dXJuIG1vZGlmaWNhdG9yW2Z1bmMob2JqZWN0KV07CiAgICAgICAgICB9OwogICAgICB9CiAgICAgIHJlc3VsdC5iYXNlID0gZnVuYy5iYXNlIHx8IGZ1bmM7CiAgICAgIHJlc3VsdC5fX2V4dGVuZF9fID0gZ2V0dGVyOwogICAgICBpZiAobW9kSWQpIHsKICAgICAgICBpZiAoIW1vZExpc3QpIHsKICAgICAgICAgIG1vZExpc3QgPSB7fTsKICAgICAgICAgIG1vZENhY2hlW2dldHRlcklkXSA9IG1vZExpc3Q7CiAgICAgICAgfQogICAgICAgIG1vZExpc3RbbW9kSWRdID0gcmVzdWx0OwogICAgICAgIHJlc3VsdC5tb2QgPSBtb2RpZmljYXRvcjsKICAgICAgICByZXN1bHRbSURdID0gZ2V0dGVyTWFwLnB1c2gocmVzdWx0KTsKICAgICAgfSBlbHNlIHt9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogICAgZ2V0dGVyRm4uSUQgPSBJRDsKICAgIHJldHVybiBnZXR0ZXJGbjsKICB9KCk7CiAgdmFyIG51bGxHZXR0ZXIgPSBleHRlbmQoZnVuY3Rpb24oKSB7fSwgewogICAgX19leHRlbmRfXzogZ2V0dGVyCiAgfSk7CiAgZnVuY3Rpb24gd3JhcHBlcihrZXkpIHsKICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KICBmdW5jdGlvbiBsYXp5SW5pdChpbml0LCB0aGlzT2JqZWN0KSB7CiAgICB2YXIgaW5pdGVkID0gMDsKICAgIHZhciBzZWxmOwogICAgdmFyIGRhdGE7CiAgICByZXR1cm4gc2VsZiA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIShpbml0ZWQrKykpIHsKICAgICAgICBzZWxmLmluaXRlZCA9IHRydWU7CiAgICAgICAgc2VsZi5kYXRhID0gZGF0YSA9IGluaXQuYXBwbHkodGhpc09iamVjdCB8fCB0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PSAidW5kZWZpbmVkIikgY29uc29sZU1ldGhvZHMud2FybigibGF6eUluaXQgZnVuY3Rpb24gcmV0dXJucyBub3RoaW5nOlxuIiArIGluaXQpOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhOwogICAgfTsKICB9CiAgZnVuY3Rpb24gbGF6eUluaXRBbmRSdW4oaW5pdCwgcnVuLCB0aGlzT2JqZWN0KSB7CiAgICB2YXIgaW5pdGVkID0gMDsKICAgIHZhciBzZWxmOwogICAgdmFyIGRhdGE7CiAgICByZXR1cm4gc2VsZiA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIShpbml0ZWQrKykpIHsKICAgICAgICBzZWxmLmluaXRlZCA9IHRydWU7CiAgICAgICAgc2VsZi5kYXRhID0gZGF0YSA9IGluaXQuY2FsbCh0aGlzT2JqZWN0IHx8IHRoaXMpOwogICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PSAidW5kZWZpbmVkIikgY29uc29sZU1ldGhvZHMud2FybigibGF6eUluaXRBbmRSdW4gZnVuY3Rpb24gcmV0dXJucyBub3RoaW5nOlxuIiArIGluaXQpOwogICAgICB9CiAgICAgIHJ1bi5hcHBseShkYXRhLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gZGF0YTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHJ1bk9uY2UocnVuLCB0aGlzT2JqZWN0KSB7CiAgICB2YXIgZmlyZWQgPSAwOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoIShmaXJlZCsrKSkgcmV0dXJuIHJ1bi5hcHBseSh0aGlzT2JqZWN0IHx8IHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogIH0KICB2YXIgY29uc29sZU1ldGhvZHMgPSBmdW5jdGlvbigpIHsKICAgIHZhciBtZXRob2RzID0gewogICAgICBsb2c6ICR1bmRlZiwKICAgICAgaW5mbzogJHVuZGVmLAogICAgICB3YXJuOiAkdW5kZWYsCiAgICAgIGVycm9yOiAkdW5kZWYKICAgIH07CiAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT0gInVuZGVmaW5lZCIpIGl0ZXJhdGUobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICBtZXRob2RzW21ldGhvZE5hbWVdID0gImJpbmQiIGluIEZ1bmN0aW9uLnByb3RvdHlwZSAmJiB0eXBlb2YgY29uc29sZVttZXRob2ROYW1lXSA9PSAiZnVuY3Rpb24iID8gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQuY2FsbChjb25zb2xlW21ldGhvZE5hbWVdLCBjb25zb2xlKSA6IGZ1bmN0aW9uKCkgewogICAgICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGVbbWV0aG9kTmFtZV0sIGNvbnNvbGUsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9KTsKICAgIHJldHVybiBtZXRob2RzOwogIH0oKTsKICB2YXIgc2V0SW1tZWRpYXRlID0gZ2xvYmFsLnNldEltbWVkaWF0ZSB8fCBnbG9iYWwubXNTZXRJbW1lZGlhdGU7CiAgdmFyIGNsZWFySW1tZWRpYXRlID0gZ2xvYmFsLmNsZWFySW1tZWRpYXRlIHx8IGdsb2JhbC5tc1NldEltbWVkaWF0ZTsKICBpZiAoc2V0SW1tZWRpYXRlKSBzZXRJbW1lZGlhdGUgPSBzZXRJbW1lZGlhdGUuYmluZChnbG9iYWwpOwogIGlmIChjbGVhckltbWVkaWF0ZSkgY2xlYXJJbW1lZGlhdGUgPSBjbGVhckltbWVkaWF0ZS5iaW5kKGdsb2JhbCk7CiAgaWYgKCFzZXRJbW1lZGlhdGUpIChmdW5jdGlvbigpIHsKICAgIHZhciBNRVNTQUdFX05BTUUgPSAiYmFzaXNqcy5zZXRJbW1lZGlhdGUiOwogICAgdmFyIHJ1blRhc2sgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRhc2tCeUlkID0ge307CiAgICAgIHZhciB0YXNrSWQgPSAxOwogICAgICBzZXRJbW1lZGlhdGUgPSBmdW5jdGlvbihmbikgewogICAgICAgIGlmICh0eXBlb2YgZm4gIT0gImZ1bmN0aW9uIikgewogICAgICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMuc2V0SW1tZWRpYXRlKCkgYW5kIGJhc2lzLm5leHRUaWNrKCkgYWNjZXB0IGZ1bmN0aW9ucyBvbmx5IChjYWxsIGlnbm9yZWQpIik7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRhc2tCeUlkWysrdGFza0lkXSA9IHsKICAgICAgICAgIGZuOiBmbiwKICAgICAgICAgIGFyZ3M6IGFycmF5RnJvbShhcmd1bWVudHMsIDEpCiAgICAgICAgfTsKICAgICAgICBhZGRUb1F1ZXVlKHRhc2tJZCk7CiAgICAgICAgcmV0dXJuIHRhc2tJZDsKICAgICAgfTsKICAgICAgY2xlYXJJbW1lZGlhdGUgPSBmdW5jdGlvbihpZCkgewogICAgICAgIGRlbGV0ZSB0YXNrQnlJZFtpZF07CiAgICAgIH07CiAgICAgIHJldHVybiBmdW5jdGlvbihpZCkgewogICAgICAgIHZhciB0YXNrID0gdGFza0J5SWRbaWRdOwogICAgICAgIGlmICh0YXNrKSB7CiAgICAgICAgICBkZWxldGUgdGFza0J5SWRbaWRdOwogICAgICAgICAgcmV0dXJuIHRhc2suZm4uYXBwbHkodW5kZWZpbmVkLCB0YXNrLmFyZ3MpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0oKTsKICAgIHZhciBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKSB7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgcnVuVGFzayh0YXNrSWQpOwogICAgICB9LCAwKTsKICAgIH07CiAgICBpZiAoZ2xvYmFsLnByb2Nlc3MgJiYgdHlwZW9mIHByb2Nlc3MubmV4dFRpY2sgPT0gImZ1bmN0aW9uIikgewogICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKSB7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICAgIHJ1blRhc2sodGFza0lkKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChnbG9iYWwuTWVzc2FnZUNoYW5uZWwpIHsKICAgICAgICB2YXIgY2hhbm5lbCA9IG5ldyBnbG9iYWwuTWVzc2FnZUNoYW5uZWw7CiAgICAgICAgY2hhbm5lbC5wb3J0MS5vbm1lc3NhZ2UgPSBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgdmFyIHRhc2tJZCA9IGV2ZW50LmRhdGE7CiAgICAgICAgICBydW5UYXNrKHRhc2tJZCk7CiAgICAgICAgfTsKICAgICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKSB7CiAgICAgICAgICBjaGFubmVsLnBvcnQyLnBvc3RNZXNzYWdlKHRhc2tJZCk7CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcG9zdE1lc3NhZ2VTdXBwb3J0ZWQgPSBnbG9iYWwucG9zdE1lc3NhZ2UgJiYgIWdsb2JhbC5pbXBvcnRTY3JpcHRzOwogICAgICAgIGlmIChwb3N0TWVzc2FnZVN1cHBvcnRlZCkgewogICAgICAgICAgdmFyIG9sZE9uTWVzc2FnZSA9IGdsb2JhbC5vbm1lc3NhZ2U7CiAgICAgICAgICBnbG9iYWwub25tZXNzYWdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBvc3RNZXNzYWdlU3VwcG9ydGVkID0gZmFsc2U7CiAgICAgICAgICB9OwogICAgICAgICAgZ2xvYmFsLnBvc3RNZXNzYWdlKCIiLCAiKiIpOwogICAgICAgICAgZ2xvYmFsLm9ubWVzc2FnZSA9IG9sZE9uTWVzc2FnZTsKICAgICAgICB9CiAgICAgICAgaWYgKHBvc3RNZXNzYWdlU3VwcG9ydGVkKSB7CiAgICAgICAgICB2YXIgc2V0SW1tZWRpYXRlSGFuZGxlciA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudCAmJiBldmVudC5zb3VyY2UgPT0gZ2xvYmFsKSB7CiAgICAgICAgICAgICAgdmFyIHRhc2tJZCA9IFN0cmluZyhldmVudC5kYXRhKS5zcGxpdChNRVNTQUdFX05BTUUpWzFdOwogICAgICAgICAgICAgIGlmICh0YXNrSWQpIHJ1blRhc2sodGFza0lkKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIGlmIChnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcikgZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBzZXRJbW1lZGlhdGVIYW5kbGVyLCB0cnVlKTsgZWxzZSBnbG9iYWwuYXR0YWNoRXZlbnQoIm9ubWVzc2FnZSIsIHNldEltbWVkaWF0ZUhhbmRsZXIpOwogICAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCkgewogICAgICAgICAgICBnbG9iYWwucG9zdE1lc3NhZ2UoTUVTU0FHRV9OQU1FICsgdGFza0lkLCAiKiIpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGNyZWF0ZVNjcmlwdCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGRvY3VtZW50ICYmICJvbnJlYWR5c3RhdGVjaGFuZ2UiIGluIGNyZWF0ZVNjcmlwdCgpKSB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0QWRkVG9RdWV1ZSA9IGFkZFRvUXVldWU7CiAgICAgICAgICAgIGFkZFRvUXVldWUgPSBmdW5jdGlvbiBiZWZvcmVIZWFkUmVhZHkodGFza0lkKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudEludGVyZmFjZSAhPSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgYWRkVG9RdWV1ZSA9IGRlZmF1bHRBZGRUb1F1ZXVlOwogICAgICAgICAgICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5yZWFkeShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCkgewogICAgICAgICAgICAgICAgICAgIHZhciBzY3JpcHRFbCA9IGNyZWF0ZVNjcmlwdCgpOwogICAgICAgICAgICAgICAgICAgIHNjcmlwdEVsLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgc2NyaXB0RWwub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50SW50ZXJmYWNlLnJlbW92ZShzY3JpcHRFbCk7CiAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRFbCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBydW5UYXNrKHRhc2tJZCk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudEludGVyZmFjZS5oZWFkLmFkZChzY3JpcHRFbCk7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGFkZFRvUXVldWUgPT09IGJlZm9yZUhlYWRSZWFkeSkgZGVmYXVsdEFkZFRvUXVldWUodGFza0lkKTsgZWxzZSBhZGRUb1F1ZXVlKHRhc2tJZCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSkoKTsKICB2YXIgTk9ERV9FTlYgPSB0eXBlb2YgcHJvY2VzcyA9PSAib2JqZWN0IiAmJiB0b1N0cmluZy5jYWxsKHByb2Nlc3MpID09ICJbb2JqZWN0IHByb2Nlc3NdIjsKICB2YXIgcGF0aFV0aWxzID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgQUJTT0xVVEVfUlggPSAvXihbXlwvXSs6fFwvKS87CiAgICB2YXIgUFJPVE9DT0xfUlggPSAvXlthLXpBLVowLTlcLV0rOlwvPy87CiAgICB2YXIgT1JJR0lOX1JYID0gL14oPzpbYS16QS1aMC05XC1dKzopP1wvXC9bXlwvXStcLz8vOwogICAgdmFyIFNFQVJDSF9IQVNIX1JYID0gL1tcPyNdLiokLzsKICAgIHZhciBiYXNlVVJJOwogICAgdmFyIG9yaWdpbjsKICAgIHZhciB1dGlsczsKICAgIGlmIChOT0RFX0VOVikgewogICAgICB2YXIgcGF0aCA9IChwcm9jZXNzLmJhc2lzanNCYXNlVVJJIHx8IHJlcXVpcmUoInBhdGgiKS5yZXNvbHZlKCIuIikpLnJlcGxhY2UoL1xcL2csICIvIik7CiAgICAgIGJhc2VVUkkgPSBwYXRoLnJlcGxhY2UoL15bXlwvXSovLCAiIik7CiAgICAgIG9yaWdpbiA9IHBhdGgucmVwbGFjZSgvXC8uKi8sICIiKTsKICAgIH0gZWxzZSB7CiAgICAgIGJhc2VVUkkgPSBsb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSskLywgIiIpOwogICAgICBvcmlnaW4gPSBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIgKyBsb2NhdGlvbi5ob3N0OwogICAgfQogICAgdXRpbHMgPSB7CiAgICAgIGJhc2VVUkk6IGJhc2VVUkksCiAgICAgIG9yaWdpbjogb3JpZ2luLAogICAgICBub3JtYWxpemU6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICBwYXRoID0gKHBhdGggfHwgIiIpLnJlcGxhY2UoUFJPVE9DT0xfUlgsICIvIikucmVwbGFjZShPUklHSU5fUlgsICIvIikucmVwbGFjZShTRUFSQ0hfSEFTSF9SWCwgIiIpOwogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCIvIik7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHBhcnRzW2ldID09ICIuLiIpIHsKICAgICAgICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPiAxIHx8IHJlc3VsdFswXSkgcmVzdWx0LnBvcCgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKChwYXJ0c1tpXSB8fCAhaSkgJiYgcGFydHNbaV0gIT0gIi4iKSByZXN1bHQucHVzaChwYXJ0c1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQuam9pbigiLyIpIHx8IChwYXRoWzBdID09PSAiLyIgPyAiLyIgOiAiIik7CiAgICAgIH0sCiAgICAgIGRpcm5hbWU6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gdXRpbHMubm9ybWFsaXplKHBhdGgpOwogICAgICAgIHJldHVybiByZXN1bHQucmVwbGFjZSgvXC8oW15cL10qKSR8XlteXC9dKyQvLCAiIikgfHwgKHJlc3VsdFswXSA9PSAiLyIgPyAiLyIgOiAiLiIpOwogICAgICB9LAogICAgICBleHRuYW1lOiBmdW5jdGlvbihwYXRoKSB7CiAgICAgICAgdmFyIGV4dCA9IHV0aWxzLm5vcm1hbGl6ZShwYXRoKS5tYXRjaCgvW15cL10oXC5bXlwvXC5dKikkLyk7CiAgICAgICAgcmV0dXJuIGV4dCA/IGV4dFsxXSA6ICIiOwogICAgICB9LAogICAgICBiYXNlbmFtZTogZnVuY3Rpb24ocGF0aCwgZXh0KSB7CiAgICAgICAgdmFyIGZpbGVuYW1lID0gdXRpbHMubm9ybWFsaXplKHBhdGgpLm1hdGNoKC9bXlxcXC9dKiQvKTsKICAgICAgICBmaWxlbmFtZSA9IGZpbGVuYW1lID8gZmlsZW5hbWVbMF0gOiAiIjsKICAgICAgICBpZiAoZXh0ID09IHV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpKSBmaWxlbmFtZSA9IGZpbGVuYW1lLnN1YnN0cmluZygwLCBmaWxlbmFtZS5sZW5ndGggLSBleHQubGVuZ3RoKTsKICAgICAgICByZXR1cm4gZmlsZW5hbWU7CiAgICAgIH0sCiAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKGZyb20sIHRvKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBhcnJheUZyb20oYXJndW1lbnRzKS5yZXZlcnNlKCk7CiAgICAgICAgdmFyIHBhdGggPSBbXTsKICAgICAgICB2YXIgYWJzb2x1dGVGb3VuZCA9IGZhbHNlOwogICAgICAgIGZvciAodmFyIGkgPSAwOyAhYWJzb2x1dGVGb3VuZCAmJiBpIDwgYXJncy5sZW5ndGg7IGkrKykgaWYgKHR5cGVvZiBhcmdzW2ldID09ICJzdHJpbmciKSB7CiAgICAgICAgICBwYXRoLnVuc2hpZnQoYXJnc1tpXSk7CiAgICAgICAgICBhYnNvbHV0ZUZvdW5kID0gQUJTT0xVVEVfUlgudGVzdChhcmdzW2ldKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFhYnNvbHV0ZUZvdW5kKSBwYXRoLnVuc2hpZnQoYmFzZVVSSSA9PSAiLyIgPyAiIiA6IGJhc2VVUkkpOwogICAgICAgIHJldHVybiB1dGlscy5ub3JtYWxpemUocGF0aC5qb2luKCIvIikpOwogICAgICB9LAogICAgICByZWxhdGl2ZTogZnVuY3Rpb24oZnJvbSwgdG8pIHsKICAgICAgICBpZiAodHlwZW9mIHRvICE9ICJzdHJpbmciKSB7CiAgICAgICAgICB0byA9IGZyb207CiAgICAgICAgICBmcm9tID0gYmFzZVVSSTsKICAgICAgICB9CiAgICAgICAgZnJvbSA9IHV0aWxzLm5vcm1hbGl6ZShmcm9tKTsKICAgICAgICB0byA9IHV0aWxzLm5vcm1hbGl6ZSh0byk7CiAgICAgICAgaWYgKGZyb21bMF0gPT0gIi8iICYmIHRvWzBdICE9ICIvIikgcmV0dXJuIGZyb207CiAgICAgICAgaWYgKHRvWzBdID09ICIvIiAmJiBmcm9tWzBdICE9ICIvIikgcmV0dXJuIHRvOwogICAgICAgIHZhciBiYXNlID0gZnJvbS5yZXBsYWNlKC9eXC8kLywgIiIpLnNwbGl0KC9cLy8pOwogICAgICAgIHZhciBwYXRoID0gdG8ucmVwbGFjZSgvXlwvJC8sICIiKS5zcGxpdCgvXC8vKTsKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIGkgPSAwOwogICAgICAgIHdoaWxlIChwYXRoW2ldID09IGJhc2VbaV0gJiYgdHlwZW9mIGJhc2VbaV0gPT0gInN0cmluZyIpIGkrKzsKICAgICAgICBmb3IgKHZhciBqID0gYmFzZS5sZW5ndGggLSBpOyBqID4gMDsgai0tKSByZXN1bHQucHVzaCgiLi4iKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNvbmNhdChwYXRoLnNsaWNlKGkpLmZpbHRlcihCb29sZWFuKSkuam9pbigiLyIpOwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIHV0aWxzOwogIH0oKTsKICB2YXIgYmFzaXNGaWxlbmFtZSA9IF9fYmFzaXNGaWxlbmFtZSB8fCAiIjsKICB2YXIgY29uZmlnID0gX19jb25maWcgfHwgewogICAgbm9Db25mbGljdDogdHJ1ZSwKICAgIG1vZHVsZXM6IHt9LAogICAgYXV0b2xvYWQ6IFsgIi4vMC5qcyIgXQogIH07CiAgZnVuY3Rpb24gZmV0Y2hDb25maWcoKSB7CiAgICB2YXIgY29uZmlnID0gX19jb25maWc7CiAgICBpZiAoIWNvbmZpZykgewogICAgICBpZiAoTk9ERV9FTlYpIHsKICAgICAgICBiYXNpc0ZpbGVuYW1lID0gX19maWxlbmFtZS5yZXBsYWNlKC9cXC9nLCAiLyIpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBzY3JpcHRzID0gZG9jdW1lbnQuc2NyaXB0czsKICAgICAgICBmb3IgKHZhciBpID0gMCwgc2NyaXB0RWw7IHNjcmlwdEVsID0gc2NyaXB0c1tpXTsgaSsrKSB7CiAgICAgICAgICB2YXIgY29uZmlnQXR0clZhbHVlID0gc2NyaXB0RWwuaGFzQXR0cmlidXRlKCJiYXNpcy1jb25maWciKSA/IHNjcmlwdEVsLmdldEF0dHJpYnV0ZSgiYmFzaXMtY29uZmlnIikgOiBzY3JpcHRFbC5nZXRBdHRyaWJ1dGUoImRhdGEtYmFzaXMtY29uZmlnIik7CiAgICAgICAgICBzY3JpcHRFbC5yZW1vdmVBdHRyaWJ1dGUoImJhc2lzLWNvbmZpZyIpOwogICAgICAgICAgc2NyaXB0RWwucmVtb3ZlQXR0cmlidXRlKCJkYXRhLWJhc2lzLWNvbmZpZyIpOwogICAgICAgICAgaWYgKGNvbmZpZ0F0dHJWYWx1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBiYXNpc0ZpbGVuYW1lID0gcGF0aFV0aWxzLm5vcm1hbGl6ZShzY3JpcHRFbC5zcmMpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbmZpZyA9IEZ1bmN0aW9uKCJyZXR1cm57IiArIGNvbmZpZ0F0dHJWYWx1ZSArICJ9IikoKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIGNvbnNvbGVNZXRob2RzLmVycm9yKCJiYXNpcy1jb25maWc6IGJhc2lzLmpzIGNvbmZpZyBwYXJzZSBmYXVsdDogIiArIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIHByb2Nlc3NDb25maWcoY29uZmlnKTsKICB9CiAgZnVuY3Rpb24gcHJvY2Vzc0NvbmZpZyhjb25maWcsIHZlcmJvc2UpIHsKICAgIGNvbmZpZyA9IHNsaWNlKGNvbmZpZyk7CiAgICBpZiAoImV4dFByb3RvIiBpbiBjb25maWcpIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLWNvbmZpZzogYGV4dFByb3RvYCBvcHRpb24gaW4gYmFzaXMtY29uZmlnIGlzIG5vdCBzdXBwb3J0IGFueW1vcmUiKTsKICAgIGlmICgicGF0aCIgaW4gY29uZmlnKSBjb25zb2xlTWV0aG9kcy53YXJuKCJiYXNpcy1jb25maWc6IGBwYXRoYCBvcHRpb24gaW4gYmFzaXMtY29uZmlnIGlzIGRlcHJlY2F0ZWQsIHVzZSBgbW9kdWxlc2AgaW5zdGVhZCIpOwogICAgdmFyIGF1dG9sb2FkID0gW107CiAgICB2YXIgbW9kdWxlcyA9IG1lcmdlKGNvbmZpZy5wYXRoLCBjb25maWcubW9kdWxlcywgewogICAgICBiYXNpczogYmFzaXNGaWxlbmFtZQogICAgfSk7CiAgICBjb25maWcubW9kdWxlcyA9IHt9OwogICAgaWYgKGNvbmZpZy5hdXRvbG9hZCkgewogICAgICB2YXIgbSA9IFN0cmluZyhjb25maWcuYXV0b2xvYWQpLm1hdGNoKC9eKCg/OlteXC9dKlwvKSopKFthLXokX11bYS16MC05JF9dKikoKD86XC5bYS16JF9dW2EtejAtOSRfXSopKikkL2kpOwogICAgICBpZiAobSkgewogICAgICAgIG1vZHVsZXNbbVsyXV0gPSB7CiAgICAgICAgICBhdXRvbG9hZDogdHJ1ZSwKICAgICAgICAgIGZpbGVuYW1lOiBtWzFdICsgbVsyXSArIChtWzNdIHx8ICIuanMiKQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMtY29uZmlnOiB3cm9uZyBgYXV0b2xvYWRgIHZhbHVlIChzZXR0aW5nIGlnbm9yZWQpOiAiICsgY29uZmlnLmF1dG9sb2FkKTsKICAgICAgfQogICAgICBkZWxldGUgY29uZmlnLmF1dG9sb2FkOwogICAgfQogICAgZm9yICh2YXIgbmFtZSBpbiBtb2R1bGVzKSB7CiAgICAgIHZhciBtb2R1bGUgPSBtb2R1bGVzW25hbWVdOwogICAgICBpZiAodHlwZW9mIG1vZHVsZSA9PSAic3RyaW5nIikgbW9kdWxlID0gewogICAgICAgIGZpbGVuYW1lOiBtb2R1bGUucmVwbGFjZSgvXC8kLywgIi8iICsgbmFtZSArICIuanMiKQogICAgICB9OwogICAgICB2YXIgZmlsZW5hbWUgPSBtb2R1bGUuZmlsZW5hbWU7CiAgICAgIHZhciBwYXRoID0gbW9kdWxlLnBhdGg7CiAgICAgIGlmIChmaWxlbmFtZSAmJiAhcGF0aCkgewogICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZmlsZW5hbWUpOwogICAgICAgIHBhdGggPSBmaWxlbmFtZS5zdWJzdHIoMCwgZmlsZW5hbWUubGVuZ3RoIC0gcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpLmxlbmd0aCk7CiAgICAgICAgZmlsZW5hbWUgPSAiLi4vIiArIHBhdGhVdGlscy5iYXNlbmFtZShmaWxlbmFtZSk7CiAgICAgIH0KICAgICAgcGF0aCA9IHBhdGhVdGlscy5yZXNvbHZlKHBhdGgpOwogICAgICBpZiAoIWZpbGVuYW1lICYmIHBhdGgpIHsKICAgICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5iYXNlbmFtZShwYXRoKTsKICAgICAgICBwYXRoID0gcGF0aFV0aWxzLmRpcm5hbWUocGF0aCk7CiAgICAgIH0KICAgICAgaWYgKCFwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkpIGZpbGVuYW1lICs9ICIuanMiOwogICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKHBhdGgsIGZpbGVuYW1lKTsKICAgICAgY29uZmlnLm1vZHVsZXNbbmFtZV0gPSB7CiAgICAgICAgcGF0aDogcGF0aCwKICAgICAgICBmaWxlbmFtZTogZmlsZW5hbWUKICAgICAgfTsKICAgICAgaWYgKG1vZHVsZS5hdXRvbG9hZCkgewogICAgICAgIGNvbmZpZy5hdXRvbG9hZCA9IGF1dG9sb2FkOwogICAgICAgIGF1dG9sb2FkLnB1c2gobmFtZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBjb25maWc7CiAgfQogIHZhciBDbGFzcyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGluc3RhbmNlU2VlZCA9IHsKICAgICAgaWQ6IDEKICAgIH07CiAgICB2YXIgY2xhc3NTZWVkID0gMTsKICAgIHZhciBjbGFzc2VzID0gW107CiAgICB2YXIgU0VMRiA9IHt9OwogICAgZnVuY3Rpb24gaXNDbGFzcyhvYmplY3QpIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT0gImZ1bmN0aW9uIiAmJiAhIW9iamVjdC5iYXNpc0NsYXNzSWRfOwogICAgfQogICAgZnVuY3Rpb24gaXNTdWJjbGFzc09mKHN1cGVyQ2xhc3MpIHsKICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgIHdoaWxlIChjdXJzb3IgJiYgY3Vyc29yICE9PSBzdXBlckNsYXNzKSBjdXJzb3IgPSBjdXJzb3Iuc3VwZXJDbGFzc187CiAgICAgIHJldHVybiBjdXJzb3IgPT09IHN1cGVyQ2xhc3M7CiAgICB9CiAgICBmdW5jdGlvbiBkZXZWZXJib3NlTmFtZShuYW1lLCBhcmdzLCBmbikgewogICAgICByZXR1cm4gKG5ldyBGdW5jdGlvbihrZXlzKGFyZ3MpLCAncmV0dXJuIHsiJyArIG5hbWUgKyAnIjogJyArIGZuICsgJ1xufVsiJyArIG5hbWUgKyAnIl0nKSkuYXBwbHkobnVsbCwgdmFsdWVzKGFyZ3MpKTsKICAgIH0KICAgIHZhciBUT1NUUklOR19CVUcgPSBmdW5jdGlvbigpIHsKICAgICAgZm9yICh2YXIga2V5IGluIHsKICAgICAgICB0b1N0cmluZzogMQogICAgICB9KSByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSgpOwogICAgZnVuY3Rpb24gY3JlYXRlQ2xhc3MoU3VwZXJDbGFzcywgZXh0ZW5zaW9ucykgewogICAgICB2YXIgY2xhc3NJZCA9IGNsYXNzU2VlZCsrOwogICAgICBpZiAodHlwZW9mIFN1cGVyQ2xhc3MgIT0gImZ1bmN0aW9uIikgU3VwZXJDbGFzcyA9IEJhc2VDbGFzczsKICAgICAgdmFyIGNsYXNzTmFtZSA9ICIiOwogICAgICBmb3IgKHZhciBpID0gMSwgZXh0ZW5zaW9uOyBleHRlbnNpb24gPSBhcmd1bWVudHNbaV07IGkrKykgaWYgKHR5cGVvZiBleHRlbnNpb24gIT0gImZ1bmN0aW9uIiAmJiBleHRlbnNpb24uY2xhc3NOYW1lKSBjbGFzc05hbWUgPSBleHRlbnNpb24uY2xhc3NOYW1lOwogICAgICBpZiAoIWNsYXNzTmFtZSkgY2xhc3NOYW1lID0gU3VwZXJDbGFzcy5jbGFzc05hbWUgKyAiLl9DbGFzcyIgKyBjbGFzc0lkOwogICAgICB2YXIgTmV3Q2xhc3NQcm90byA9IGZ1bmN0aW9uKCkge307CiAgICAgIE5ld0NsYXNzUHJvdG8gPSBkZXZWZXJib3NlTmFtZShjbGFzc05hbWUsIHt9LCBOZXdDbGFzc1Byb3RvKTsKICAgICAgTmV3Q2xhc3NQcm90by5wcm90b3R5cGUgPSBTdXBlckNsYXNzLnByb3RvdHlwZTsKICAgICAgdmFyIG5ld1Byb3RvID0gbmV3IE5ld0NsYXNzUHJvdG87CiAgICAgIHZhciBuZXdDbGFzc1Byb3BzID0gewogICAgICAgIGNsYXNzTmFtZTogY2xhc3NOYW1lLAogICAgICAgIGJhc2lzQ2xhc3NJZF86IGNsYXNzSWQsCiAgICAgICAgc3VwZXJDbGFzc186IFN1cGVyQ2xhc3MsCiAgICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiAhIVN1cGVyQ2xhc3MuZXh0ZW5kQ29uc3RydWN0b3JfLAogICAgICAgIGlzU3ViY2xhc3NPZjogaXNTdWJjbGFzc09mLAogICAgICAgIHN1YmNsYXNzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVDbGFzcy5hcHBseShudWxsLCBbIG5ld0NsYXNzIF0uY29uY2F0KGFycmF5RnJvbShhcmd1bWVudHMpKSk7CiAgICAgICAgfSwKICAgICAgICBleHRlbmQ6IGV4dGVuZENsYXNzLAogICAgICAgIF9fZXh0ZW5kX186IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUgIT09IFNFTEYgJiYgKHR5cGVvZiB2YWx1ZSA9PSAib2JqZWN0IiB8fCB0eXBlb2YgdmFsdWUgPT0gImZ1bmN0aW9uIiAmJiAhaXNDbGFzcyh2YWx1ZSkpKSByZXR1cm4gQmFzZUNsYXNzLmNyZWF0ZS5jYWxsKG51bGwsIG5ld0NsYXNzLCB2YWx1ZSk7IGVsc2UgcmV0dXJuIHZhbHVlOwogICAgICAgIH0sCiAgICAgICAgcHJvdG90eXBlOiBuZXdQcm90bwogICAgICB9OwogICAgICBmb3IgKHZhciBpID0gMSwgZXh0ZW5zaW9uOyBleHRlbnNpb24gPSBhcmd1bWVudHNbaV07IGkrKykgbmV3Q2xhc3NQcm9wcy5leHRlbmQoZXh0ZW5zaW9uKTsKICAgICAgaWYgKG5ld1Byb3RvLmluaXQgIT09IEJhc2VDbGFzcy5wcm90b3R5cGUuaW5pdCAmJiAhL15mdW5jdGlvblteKF0qXChcKS8udGVzdChuZXdQcm90by5pbml0KSAmJiBuZXdDbGFzc1Byb3BzLmV4dGVuZENvbnN0cnVjdG9yXykgY29uc29sZU1ldGhvZHMud2FybigicHJvYmFibHkgd3JvbmcgZXh0ZW5kQ29uc3RydWN0b3JfIHZhbHVlIGZvciAiICsgbmV3Q2xhc3NQcm9wcy5jbGFzc05hbWUpOwogICAgICB2YXIgbmV3Q2xhc3MgPSBuZXdDbGFzc1Byb3BzLmV4dGVuZENvbnN0cnVjdG9yXyA/IGZ1bmN0aW9uKGV4dGVuZCkgewogICAgICAgIHRoaXMuYmFzaXNPYmplY3RJZCA9IGluc3RhbmNlU2VlZC5pZCsrOwogICAgICAgIHZhciBwcm9wOwogICAgICAgIGZvciAodmFyIGtleSBpbiBleHRlbmQpIHsKICAgICAgICAgIHByb3AgPSB0aGlzW2tleV07CiAgICAgICAgICB0aGlzW2tleV0gPSBwcm9wICYmIHByb3AuX19leHRlbmRfXyA/IHByb3AuX19leHRlbmRfXyhleHRlbmRba2V5XSkgOiBleHRlbmRba2V5XTsKICAgICAgICB9CiAgICAgICAgdGhpcy5pbml0KCk7CiAgICAgICAgdGhpcy5wb3N0SW5pdCgpOwogICAgICB9IDogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5iYXNpc09iamVjdElkID0gaW5zdGFuY2VTZWVkLmlkKys7CiAgICAgICAgdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgdGhpcy5wb3N0SW5pdCgpOwogICAgICB9OwogICAgICBuZXdDbGFzcyA9IGRldlZlcmJvc2VOYW1lKGNsYXNzTmFtZSwgewogICAgICAgIGluc3RhbmNlU2VlZDogaW5zdGFuY2VTZWVkCiAgICAgIH0sIG5ld0NsYXNzKTsKICAgICAgbmV3UHJvdG8uY29uc3RydWN0b3IgPSBuZXdDbGFzczsKICAgICAgZm9yICh2YXIga2V5IGluIG5ld1Byb3RvKSBpZiAobmV3UHJvdG9ba2V5XSA9PT0gU0VMRikgbmV3UHJvdG9ba2V5XSA9IG5ld0NsYXNzOwogICAgICBleHRlbmQobmV3Q2xhc3MsIG5ld0NsYXNzUHJvcHMpOwogICAgICBjbGFzc2VzLnB1c2gobmV3Q2xhc3MpOwogICAgICByZXR1cm4gbmV3Q2xhc3M7CiAgICB9CiAgICBmdW5jdGlvbiBleHRlbmRDbGFzcyhzb3VyY2UpIHsKICAgICAgdmFyIHByb3RvID0gdGhpcy5wcm90b3R5cGU7CiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICJmdW5jdGlvbiIgJiYgIWlzQ2xhc3Moc291cmNlKSkgc291cmNlID0gc291cmNlKHRoaXMuc3VwZXJDbGFzc18ucHJvdG90eXBlLCBzbGljZShwcm90bykpOwogICAgICBpZiAoc291cmNlLnByb3RvdHlwZSkgc291cmNlID0gc291cmNlLnByb3RvdHlwZTsKICAgICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkgewogICAgICAgIHZhciB2YWx1ZSA9IHNvdXJjZVtrZXldOwogICAgICAgIHZhciBwcm90b1ZhbHVlID0gcHJvdG9ba2V5XTsKICAgICAgICBpZiAoa2V5ID09ICJjbGFzc05hbWUiIHx8IGtleSA9PSAiZXh0ZW5kQ29uc3RydWN0b3JfIikgdGhpc1trZXldID0gdmFsdWU7IGVsc2UgewogICAgICAgICAgaWYgKHByb3RvVmFsdWUgJiYgcHJvdG9WYWx1ZS5fX2V4dGVuZF9fKSBwcm90b1trZXldID0gcHJvdG9WYWx1ZS5fX2V4dGVuZF9fKHZhbHVlKTsgZWxzZSB7CiAgICAgICAgICAgIHByb3RvW2tleV0gPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKFRPU1RSSU5HX0JVRyAmJiBzb3VyY2Vba2V5ID0gInRvU3RyaW5nIl0gIT09IHRvU3RyaW5nKSBwcm90b1trZXldID0gc291cmNlW2tleV07CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgdmFyIEJhc2VDbGFzcyA9IGV4dGVuZChjcmVhdGVDbGFzcywgewogICAgICBjbGFzc05hbWU6ICJiYXNpcy5DbGFzcyIsCiAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogZmFsc2UsCiAgICAgIHByb3RvdHlwZTogewogICAgICAgIGJhc2lzT2JqZWN0SWQ6IDAsCiAgICAgICAgY29uc3RydWN0b3I6IG51bGwsCiAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7fSwKICAgICAgICBwb3N0SW5pdDogZnVuY3Rpb24oKSB7fSwKICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICByZXR1cm4gIltvYmplY3QgIiArICh0aGlzLmNvbnN0cnVjdG9yIHx8IHRoaXMpLmNsYXNzTmFtZSArICJdIjsKICAgICAgICB9LAogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiB0aGlzKSBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCBwcm9wKSkgdGhpc1twcm9wXSA9IG51bGw7CiAgICAgICAgICB0aGlzLmRlc3Ryb3kgPSAkdW5kZWY7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHZhciBjdXN0b21FeHRlbmRQcm9wZXJ0eSA9IGZ1bmN0aW9uKGV4dGVuc2lvbiwgZm4sIGRldk5hbWUpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbihleHRlbnNpb24pIHsKICAgICAgICAgIGlmICghZXh0ZW5zaW9uKSByZXR1cm4gZXh0ZW5zaW9uOwogICAgICAgICAgaWYgKGV4dGVuc2lvbiAmJiBleHRlbnNpb24uX19leHRlbmRfXykgcmV0dXJuIGV4dGVuc2lvbjsKICAgICAgICAgIHZhciBCYXNlID0gZnVuY3Rpb24oKSB7fTsKICAgICAgICAgIEJhc2UgPSBkZXZWZXJib3NlTmFtZShkZXZOYW1lIHx8ICJjdXN0b21FeHRlbmRQcm9wZXJ0eSIsIHt9LCBCYXNlKTsKICAgICAgICAgIEJhc2UucHJvdG90eXBlID0gdGhpczsKICAgICAgICAgIHZhciByZXN1bHQgPSBuZXcgQmFzZTsKICAgICAgICAgIGZuKHJlc3VsdCwgZXh0ZW5zaW9uKTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICB9Ll9fZXh0ZW5kX18oZXh0ZW5zaW9uIHx8IHt9KTsKICAgIH07CiAgICB2YXIgZXh0ZW5zaWJsZVByb3BlcnR5ID0gZnVuY3Rpb24oZXh0ZW5zaW9uKSB7CiAgICAgIHJldHVybiBjdXN0b21FeHRlbmRQcm9wZXJ0eShleHRlbnNpb24sIGV4dGVuZCwgImV4dGVuc2libGVQcm9wZXJ0eSIpOwogICAgfTsKICAgIHZhciBuZXN0ZWRFeHRlbmRQcm9wZXJ0eSA9IGZ1bmN0aW9uKGV4dGVuc2lvbikgewogICAgICByZXR1cm4gY3VzdG9tRXh0ZW5kUHJvcGVydHkoZXh0ZW5zaW9uLCBmdW5jdGlvbihyZXN1bHQsIGV4dGVuc2lvbikgewogICAgICAgIGZvciAodmFyIGtleSBpbiBleHRlbnNpb24pIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHJlc3VsdFtrZXldOwogICAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZSAmJiB2YWx1ZS5fX2V4dGVuZF9fID8gdmFsdWUuX19leHRlbmRfXyhleHRlbnNpb25ba2V5XSkgOiBleHRlbnNpYmxlUHJvcGVydHkoZXh0ZW5zaW9uW2tleV0pOwogICAgICAgIH0KICAgICAgfSwgIm5lc3RlZEV4dGVuZFByb3BlcnR5Iik7CiAgICB9OwogICAgdmFyIG9uZUZ1bmN0aW9uUHJvcGVydHkgPSBmdW5jdGlvbihmbiwga2V5cykgewogICAgICB2YXIgY3JlYXRlID0gZnVuY3Rpb24oa2V5cykgewogICAgICAgIHZhciByZXN1bHQgPSB7CiAgICAgICAgICBfX2V4dGVuZF9fOiBjcmVhdGUKICAgICAgICB9OwogICAgICAgIGlmIChrZXlzKSB7CiAgICAgICAgICBpZiAoa2V5cy5fX2V4dGVuZF9fKSByZXR1cm4ga2V5czsKICAgICAgICAgIHZhciBDbHMgPSBkZXZWZXJib3NlTmFtZSgib25lRnVuY3Rpb25Qcm9wZXJ0eSIsIHt9LCBmdW5jdGlvbigpIHt9KTsKICAgICAgICAgIHJlc3VsdCA9IG5ldyBDbHM7CiAgICAgICAgICByZXN1bHQuX19leHRlbmRfXyA9IGNyZWF0ZTsKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBrZXlzKSBpZiAoa2V5c1trZXldKSByZXN1bHRba2V5XSA9IGZuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICByZXR1cm4gY3JlYXRlKGtleXMgfHwge30pOwogICAgfTsKICAgIHJldHVybiBleHRlbmQoQmFzZUNsYXNzLCB7CiAgICAgIGFsbF86IGNsYXNzZXMsCiAgICAgIFNFTEY6IFNFTEYsCiAgICAgIGNyZWF0ZTogY3JlYXRlQ2xhc3MsCiAgICAgIGlzQ2xhc3M6IGlzQ2xhc3MsCiAgICAgIGN1c3RvbUV4dGVuZFByb3BlcnR5OiBjdXN0b21FeHRlbmRQcm9wZXJ0eSwKICAgICAgZXh0ZW5zaWJsZVByb3BlcnR5OiBleHRlbnNpYmxlUHJvcGVydHksCiAgICAgIG5lc3RlZEV4dGVuZFByb3BlcnR5OiBuZXN0ZWRFeHRlbmRQcm9wZXJ0eSwKICAgICAgb25lRnVuY3Rpb25Qcm9wZXJ0eTogb25lRnVuY3Rpb25Qcm9wZXJ0eQogICAgfSk7CiAgfSgpOwogIHZhciBUb2tlbiA9IENsYXNzKG51bGwsIHsKICAgIGNsYXNzTmFtZTogImJhc2lzLlRva2VuIiwKICAgIHZhbHVlOiBudWxsLAogICAgaGFuZGxlcjogbnVsbCwKICAgIGRlZmVycmVkVG9rZW46IG51bGwsCiAgICBiaW5kaW5nQnJpZGdlOiB7CiAgICAgIGF0dGFjaDogZnVuY3Rpb24oaG9zdCwgZm4sIGNvbnRleHQpIHsKICAgICAgICBob3N0LmF0dGFjaChmbiwgY29udGV4dCk7CiAgICAgIH0sCiAgICAgIGRldGFjaDogZnVuY3Rpb24oaG9zdCwgZm4sIGNvbnRleHQpIHsKICAgICAgICBob3N0LmRldGFjaChmbiwgY29udGV4dCk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oaG9zdCkgewogICAgICAgIHJldHVybiBob3N0LmdldCgpOwogICAgICB9CiAgICB9LAogICAgaW5pdDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgfSwKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgfQogICAgfSwKICAgIGF0dGFjaDogZnVuY3Rpb24oZm4sIGNvbnRleHQpIHsKICAgICAgdmFyIGN1cnNvciA9IHRoaXM7CiAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikgaWYgKGN1cnNvci5mbiA9PT0gZm4gJiYgY3Vyc29yLmNvbnRleHQgPT09IGNvbnRleHQpIGNvbnNvbGVNZXRob2RzLndhcm4oImJhc2lzLlRva2VuI2F0dGFjaDogZHVwbGljYXRlIGZuICYgY29udGV4dCBwYWlyIik7CiAgICAgIHRoaXMuaGFuZGxlciA9IHsKICAgICAgICBmbjogZm4sCiAgICAgICAgY29udGV4dDogY29udGV4dCwKICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIKICAgICAgfTsKICAgIH0sCiAgICBkZXRhY2g6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB2YXIgcHJldjsKICAgICAgd2hpbGUgKHByZXYgPSBjdXJzb3IsIGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKSBpZiAoY3Vyc29yLmZuID09PSBmbiAmJiBjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgIGN1cnNvci5mbiA9ICR1bmRlZjsKICAgICAgICBwcmV2LmhhbmRsZXIgPSBjdXJzb3IuaGFuZGxlcjsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMuVG9rZW4jZGV0YWNoOiBmbiAmIGNvbnRleHQgcGFpciBub3QgZm91bmQsIG5vdGhpbmcgd2FzIHJlbW92ZWQiKTsKICAgIH0sCiAgICBhcHBseTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB2YWx1ZSA9IHRoaXMuZ2V0KCk7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpIGN1cnNvci5mbi5jYWxsKGN1cnNvci5jb250ZXh0LCB2YWx1ZSk7CiAgICB9LAogICAgZGVmZXJyZWQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdG9rZW4gPSB0aGlzLmRlZmVycmVkVG9rZW47CiAgICAgIGlmICghdG9rZW4pIHsKICAgICAgICB0b2tlbiA9IHRoaXMuZGVmZXJyZWRUb2tlbiA9IG5ldyBEZWZlcnJlZFRva2VuKHRoaXMudmFsdWUpOwogICAgICAgIHRoaXMuYXR0YWNoKHRva2VuLnNldCwgdG9rZW4pOwogICAgICB9CiAgICAgIHJldHVybiB0b2tlbjsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuZGVmZXJyZWRUb2tlbikgewogICAgICAgIHRoaXMuZGVmZXJyZWRUb2tlbi5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5kZWZlcnJlZFRva2VuID0gbnVsbDsKICAgICAgfQogICAgICB0aGlzLmhhbmRsZXIgPSBudWxsOwogICAgICB0aGlzLnZhbHVlID0gbnVsbDsKICAgICAgdGhpcy5hdHRhY2ggPSAkdW5kZWY7CiAgICAgIHRoaXMuZGV0YWNoID0gJHVuZGVmOwogICAgfQogIH0pOwogIHZhciBhd2FpdFRvQXBwbHkgPSBmdW5jdGlvbigpIHsKICAgIHZhciB0b2tlbnMgPSB7fTsKICAgIHZhciB0aW1lcjsKICAgIGZ1bmN0aW9uIGFwcGx5VG9rZW5zKCkgewogICAgICB2YXIgbGlzdCA9IHRva2VuczsKICAgICAgdG9rZW5zID0ge307CiAgICAgIHRpbWVyID0gbnVsbDsKICAgICAgZm9yICh2YXIga2V5IGluIGxpc3QpIGxpc3Rba2V5XS5hcHBseSgpOwogICAgfQogICAgcmV0dXJuIGZ1bmN0aW9uKHRva2VuKSB7CiAgICAgIGlmICh0b2tlbi5iYXNpc09iamVjdElkIGluIHRva2VucykgcmV0dXJuOwogICAgICB0b2tlbnNbdG9rZW4uYmFzaXNPYmplY3RJZF0gPSB0b2tlbjsKICAgICAgaWYgKCF0aW1lcikgc2V0SW1tZWRpYXRlKGFwcGx5VG9rZW5zKTsKICAgIH07CiAgfSgpOwogIHZhciBEZWZlcnJlZFRva2VuID0gVG9rZW4uc3ViY2xhc3MoewogICAgY2xhc3NOYW1lOiAiYmFzaXMuRGVmZXJyZWRUb2tlbiIsCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICBhd2FpdFRvQXBwbHkodGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICBkZWZlcnJlZDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0pOwogIHZhciByZXNvdXJjZXMgPSB7fTsKICB2YXIgcmVzb3VyY2VDb250ZW50Q2FjaGUgPSB7fTsKICB2YXIgcmVzb3VyY2VQYXRjaCA9IHt9OwogIHZhciB2aXJ0dWFsUmVzb3VyY2VTZWVkID0gMTsKICB2YXIgcmVzb3VyY2VSZXNvbHZpbmdTdGFjayA9IFtdOwogIHZhciByZXF1aXJlczsKICAoZnVuY3Rpb24oKSB7CiAgICB2YXIgbWFwID0gdHlwZW9mIF9fcmVzb3VyY2VzX18gIT0gInVuZGVmaW5lZCIgPyBfX3Jlc291cmNlc19fIDogbnVsbDsKICAgIGlmIChtYXApIHsKICAgICAgZm9yICh2YXIga2V5IGluIG1hcCkgcmVzb3VyY2VDb250ZW50Q2FjaGVbcGF0aFV0aWxzLnJlc29sdmUoa2V5KV0gPSBtYXBba2V5XTsKICAgIH0KICB9KSgpOwogIGZ1bmN0aW9uIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKSB7CiAgICB2YXIgcGF0Y2hlcyA9IHJlc291cmNlUGF0Y2hbcmVzb3VyY2UudXJsXTsKICAgIGlmIChwYXRjaGVzKSBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc29sZU1ldGhvZHMuaW5mbygiQXBwbHkgcGF0Y2ggZm9yICIgKyByZXNvdXJjZS51cmwpOwogICAgICBwYXRjaGVzW2ldKHJlc291cmNlLmdldCgpLCByZXNvdXJjZS51cmwpOwogICAgfQogIH0KICB2YXIgZ2V0UmVzb3VyY2VDb250ZW50ID0gZnVuY3Rpb24odXJsLCBpZ25vcmVDYWNoZSkgewogICAgaWYgKGlnbm9yZUNhY2hlIHx8ICFyZXNvdXJjZUNvbnRlbnRDYWNoZS5oYXNPd25Qcm9wZXJ0eSh1cmwpKSB7CiAgICAgIHZhciByZXNvdXJjZUNvbnRlbnQgPSAiIjsKICAgICAgaWYgKCFOT0RFX0VOVikgewogICAgICAgIHZhciByZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3Q7CiAgICAgICAgcmVxLm9wZW4oIkdFVCIsIHVybCwgZmFsc2UpOwogICAgICAgIHJlcS5zZXRSZXF1ZXN0SGVhZGVyKCJJZi1Nb2RpZmllZC1TaW5jZSIsIChuZXcgRGF0ZSgwKSkudG9HTVRTdHJpbmcoKSk7CiAgICAgICAgcmVxLnNldFJlcXVlc3RIZWFkZXIoIlgtQmFzaXMtUmVzb3VyY2UiLCAxKTsKICAgICAgICByZXEuc2VuZCgiIik7CiAgICAgICAgaWYgKHJlcS5zdGF0dXMgPj0gMjAwICYmIHJlcS5zdGF0dXMgPCA0MDApIHJlc291cmNlQ29udGVudCA9IHJlcS5yZXNwb25zZVRleHQ7IGVsc2UgewogICAgICAgICAgY29uc29sZU1ldGhvZHMuZXJyb3IoImJhc2lzLnJlc291cmNlOiBVbmFibGUgdG8gbG9hZCAiICsgdXJsICsgIiAoc3RhdHVzIGNvZGUgIiArIHJlcS5zdGF0dXMgKyAiKSIpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0cnkgewogICAgICAgICAgcmVzb3VyY2VDb250ZW50ID0gcHJvY2Vzcy5iYXNpc2pzUmVhZEZpbGUgPyBwcm9jZXNzLmJhc2lzanNSZWFkRmlsZSh1cmwpIDogcmVxdWlyZSgiZnMiKS5yZWFkRmlsZVN5bmModXJsLCAidXRmLTgiKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25zb2xlTWV0aG9kcy5lcnJvcigiYmFzaXMucmVzb3VyY2U6IFVuYWJsZSB0byBsb2FkICIgKyB1cmwsIGUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXNvdXJjZUNvbnRlbnRDYWNoZVt1cmxdID0gcmVzb3VyY2VDb250ZW50OwogICAgfQogICAgcmV0dXJuIHJlc291cmNlQ29udGVudENhY2hlW3VybF07CiAgfTsKICB2YXIgY3JlYXRlUmVzb3VyY2UgPSBmdW5jdGlvbihyZXNvdXJjZVVybCwgY29udGVudCkgewogICAgdmFyIGNvbnRlbnRUeXBlID0gcGF0aFV0aWxzLmV4dG5hbWUocmVzb3VyY2VVcmwpOwogICAgdmFyIGNvbnRlbnRXcmFwcGVyID0gZ2V0UmVzb3VyY2UuZXh0ZW5zaW9uc1tjb250ZW50VHlwZV07CiAgICB2YXIgaXNWaXJ0dWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDE7CiAgICB2YXIgcmVzb2x2ZWQgPSBmYWxzZTsKICAgIHZhciB3cmFwcGVkID0gZmFsc2U7CiAgICB2YXIgd3JhcHBlZENvbnRlbnQ7CiAgICBpZiAoaXNWaXJ0dWFsKSByZXNvdXJjZVVybCArPSAiI3ZpcnR1YWwiOwogICAgdmFyIHJlc291cmNlID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChyZXNvbHZlZCkgcmV0dXJuIGNvbnRlbnQ7CiAgICAgIHZhciB1cmxDb250ZW50ID0gaXNWaXJ0dWFsID8gY29udGVudCA6IGdldFJlc291cmNlQ29udGVudChyZXNvdXJjZVVybCk7CiAgICAgIHZhciBpZHggPSByZXNvdXJjZVJlc29sdmluZ1N0YWNrLmluZGV4T2YocmVzb3VyY2VVcmwpOwogICAgICBpZiAoaWR4ICE9IC0xKSBjb25zb2xlTWV0aG9kcy53YXJuKCJiYXNpcy5yZXNvdXJjZSByZWN1cnNpb246IiwgcmVzb3VyY2VSZXNvbHZpbmdTdGFjay5zbGljZShpZHgpLmNvbmNhdChyZXNvdXJjZVVybCkubWFwKHBhdGhVdGlscy5yZWxhdGl2ZSwgcGF0aFV0aWxzKS5qb2luKCIgLT4gIikpOwogICAgICByZXNvdXJjZVJlc29sdmluZ1N0YWNrLnB1c2gocmVzb3VyY2VVcmwpOwogICAgICBpZiAoY29udGVudFdyYXBwZXIpIHsKICAgICAgICBpZiAoIXdyYXBwZWQpIHsKICAgICAgICAgIHdyYXBwZWQgPSB0cnVlOwogICAgICAgICAgY29udGVudCA9IGNvbnRlbnRXcmFwcGVyKHVybENvbnRlbnQsIHJlc291cmNlVXJsKTsKICAgICAgICAgIHdyYXBwZWRDb250ZW50ID0gdXJsQ29udGVudDsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29udGVudCA9IHVybENvbnRlbnQ7CiAgICAgIH0KICAgICAgcmVzb2x2ZWQgPSB0cnVlOwogICAgICBhcHBseVJlc291cmNlUGF0Y2hlcyhyZXNvdXJjZSk7CiAgICAgIHJlc291cmNlLmFwcGx5KCk7CiAgICAgIHJlc291cmNlUmVzb2x2aW5nU3RhY2sucG9wKCk7CiAgICAgIHJldHVybiBjb250ZW50OwogICAgfTsKICAgIGV4dGVuZChyZXNvdXJjZSwgZXh0ZW5kKG5ldyBUb2tlbiwgewogICAgICB1cmw6IHJlc291cmNlVXJsLAogICAgICB0eXBlOiBjb250ZW50VHlwZSwKICAgICAgdmlydHVhbDogaXNWaXJ0dWFsLAogICAgICBmZXRjaDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHJlc291cmNlKCk7CiAgICAgIH0sCiAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gIltiYXNpcy5yZXNvdXJjZSAiICsgcmVzb3VyY2VVcmwgKyAiXSI7CiAgICAgIH0sCiAgICAgIGlzUmVzb2x2ZWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgICAgfSwKICAgICAgaGFzQ2hhbmdlczogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGNvbnRlbnRXcmFwcGVyID8gcmVzb3VyY2VDb250ZW50Q2FjaGVbcmVzb3VyY2VVcmxdICE9PSB3cmFwcGVkQ29udGVudCA6IGZhbHNlOwogICAgICB9LAogICAgICB1cGRhdGU6IGZ1bmN0aW9uKG5ld0NvbnRlbnQpIHsKICAgICAgICBpZiAoIXJlc29sdmVkIHx8IGlzVmlydHVhbCB8fCBuZXdDb250ZW50ICE9IHJlc291cmNlQ29udGVudENhY2hlW3Jlc291cmNlVXJsXSkgewogICAgICAgICAgaWYgKCFpc1ZpcnR1YWwpIHJlc291cmNlQ29udGVudENhY2hlW3Jlc291cmNlVXJsXSA9IG5ld0NvbnRlbnQ7CiAgICAgICAgICBpZiAoY29udGVudFdyYXBwZXIpIHsKICAgICAgICAgICAgaWYgKCF3cmFwcGVkICYmIGlzVmlydHVhbCkgY29udGVudCA9IG5ld0NvbnRlbnQ7CiAgICAgICAgICAgIGlmICh3cmFwcGVkICYmICFjb250ZW50V3JhcHBlci5wZXJtYW5lbnQpIHsKICAgICAgICAgICAgICBjb250ZW50ID0gY29udGVudFdyYXBwZXIobmV3Q29udGVudCwgcmVzb3VyY2VVcmwsIGNvbnRlbnQpOwogICAgICAgICAgICAgIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKTsKICAgICAgICAgICAgICByZXNvdXJjZS5hcHBseSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250ZW50ID0gbmV3Q29udGVudDsKICAgICAgICAgICAgcmVzb2x2ZWQgPSB0cnVlOwogICAgICAgICAgICBhcHBseVJlc291cmNlUGF0Y2hlcyhyZXNvdXJjZSk7CiAgICAgICAgICAgIHJlc291cmNlLmFwcGx5KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICByZWxvYWQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChpc1ZpcnR1YWwpIHJldHVybjsKICAgICAgICB2YXIgb2xkQ29udGVudCA9IHJlc291cmNlQ29udGVudENhY2hlW3Jlc291cmNlVXJsXTsKICAgICAgICB2YXIgbmV3Q29udGVudCA9IGdldFJlc291cmNlQ29udGVudChyZXNvdXJjZVVybCwgdHJ1ZSk7CiAgICAgICAgaWYgKG5ld0NvbnRlbnQgIT0gb2xkQ29udGVudCkgewogICAgICAgICAgcmVzb2x2ZWQgPSBmYWxzZTsKICAgICAgICAgIHJlc291cmNlLnVwZGF0ZShuZXdDb250ZW50KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oc291cmNlKSB7CiAgICAgICAgaWYgKGlzVmlydHVhbCkgaWYgKHNvdXJjZSkgcmV0dXJuIGNvbnRlbnRXcmFwcGVyID8gd3JhcHBlZENvbnRlbnQgOiBjb250ZW50OwogICAgICAgIHJldHVybiBzb3VyY2UgPyBnZXRSZXNvdXJjZUNvbnRlbnQocmVzb3VyY2VVcmwpIDogcmVzb3VyY2UoKTsKICAgICAgfSwKICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKHJlc29sdmVkKSB7CiAgICAgICAgICBmbi5jYWxsKGNvbnRleHQsIHJlc291cmNlKCkpOwogICAgICAgICAgaWYgKGNvbnRlbnRXcmFwcGVyICYmIGNvbnRlbnRXcmFwcGVyLnBlcm1hbmVudCkgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXNvdXJjZS5hdHRhY2goZm4sIGNvbnRleHQpOwogICAgICAgIHJldHVybiByZXNvdXJjZTsKICAgICAgfQogICAgfSkpOwogICAgcmVzb3VyY2VzW3Jlc291cmNlVXJsXSA9IHJlc291cmNlOwogICAgcmV0dXJuIHJlc291cmNlOwogIH07CiAgdmFyIGdldFJlc291cmNlID0gZnVuY3Rpb24ocmVzb3VyY2VVcmwpIHsKICAgIHZhciByZXNvdXJjZSA9IHJlc291cmNlc1tyZXNvdXJjZVVybF07CiAgICBpZiAocmVzb3VyY2UpIHJldHVybiByZXNvdXJjZTsKICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChyZXNvdXJjZVVybCkpIGNvbnNvbGVNZXRob2RzLndhcm4oIkJhZCB1c2FnZTogYmFzaXMucmVzb3VyY2UoJyIgKyByZXNvdXJjZVVybCArICInKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuIik7CiAgICByZXNvdXJjZVVybCA9IHBhdGhVdGlscy5yZXNvbHZlKHJlc291cmNlVXJsKTsKICAgIHJlc291cmNlID0gcmVzb3VyY2VzW3Jlc291cmNlVXJsXTsKICAgIHJldHVybiByZXNvdXJjZSB8fCBjcmVhdGVSZXNvdXJjZShyZXNvdXJjZVVybCk7CiAgfTsKICBleHRlbmQoZ2V0UmVzb3VyY2UsIHsKICAgIGlzUmVzb3VyY2U6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSA/IHJlc291cmNlc1t2YWx1ZS51cmxdID09PSB2YWx1ZSA6IGZhbHNlOwogICAgfSwKICAgIGlzUmVzb2x2ZWQ6IGZ1bmN0aW9uKHJlc291cmNlVXJsKSB7CiAgICAgIHZhciByZXNvdXJjZSA9IGdldFJlc291cmNlLmdldChyZXNvdXJjZVVybCk7CiAgICAgIHJldHVybiByZXNvdXJjZSA/IHJlc291cmNlLmlzUmVzb2x2ZWQoKSA6IGZhbHNlOwogICAgfSwKICAgIGV4aXN0czogZnVuY3Rpb24ocmVzb3VyY2VVcmwpIHsKICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHJlc291cmNlVXJsKSkgY29uc29sZU1ldGhvZHMud2FybigiQmFkIHVzYWdlOiBiYXNpcy5yZXNvdXJjZS5leGlzdHMoJyIgKyByZXNvdXJjZVVybCArICInKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuIik7CiAgICAgIHJldHVybiByZXNvdXJjZXMuaGFzT3duUHJvcGVydHkocGF0aFV0aWxzLnJlc29sdmUocmVzb3VyY2VVcmwpKTsKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uKHJlc291cmNlVXJsKSB7CiAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChyZXNvdXJjZVVybCkpIGNvbnNvbGVNZXRob2RzLndhcm4oIkJhZCB1c2FnZTogYmFzaXMucmVzb3VyY2UuZ2V0KCciICsgcmVzb3VyY2VVcmwgKyAiJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLiIpOwogICAgICByZXNvdXJjZVVybCA9IHBhdGhVdGlscy5yZXNvbHZlKHJlc291cmNlVXJsKTsKICAgICAgaWYgKCFnZXRSZXNvdXJjZS5leGlzdHMocmVzb3VyY2VVcmwpKSByZXR1cm4gbnVsbDsKICAgICAgcmV0dXJuIGdldFJlc291cmNlKHJlc291cmNlVXJsKTsKICAgIH0sCiAgICBnZXRGaWxlczogZnVuY3Rpb24oY2FjaGUpIHsKICAgICAgcmV0dXJuIGtleXMoY2FjaGUgPyByZXNvdXJjZUNvbnRlbnRDYWNoZSA6IHJlc291cmNlcykubWFwKHBhdGhVdGlscy5yZWxhdGl2ZSk7CiAgICB9LAogICAgdmlydHVhbDogZnVuY3Rpb24odHlwZSwgY29udGVudCwgb3duZXJVcmwpIHsKICAgICAgcmV0dXJuIGNyZWF0ZVJlc291cmNlKChvd25lclVybCA/IG93bmVyVXJsICsgIjoiIDogcGF0aFV0aWxzLm5vcm1hbGl6ZShwYXRoVXRpbHMuYmFzZVVSSSA9PSAiLyIgPyAiIiA6IHBhdGhVdGlscy5iYXNlVVJJKSArICIvIikgKyAidmlydHVhbC1yZXNvdXJjZSIgKyB2aXJ0dWFsUmVzb3VyY2VTZWVkKysgKyAiLiIgKyB0eXBlLCBjb250ZW50KTsKICAgIH0sCiAgICBleHRlbnNpb25zOiB7CiAgICAgICIuanMiOiBleHRlbmQoZnVuY3Rpb24oY29udGVudCwgZmlsZW5hbWUpIHsKICAgICAgICB2YXIgbmFtZXNwYWNlID0gZmlsZW5hbWUybmFtZXNwYWNlW2ZpbGVuYW1lXTsKICAgICAgICBpZiAoIW5hbWVzcGFjZSkgewogICAgICAgICAgdmFyIGltcGxpY2l0TmFtZXNwYWNlID0gdHJ1ZTsKICAgICAgICAgIHZhciByZXNvbHZlZEZpbGVuYW1lID0gcGF0aFV0aWxzLmRpcm5hbWUoZmlsZW5hbWUpICsgIi8iICsgcGF0aFV0aWxzLmJhc2VuYW1lKGZpbGVuYW1lLCBwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkpOwogICAgICAgICAgZm9yICh2YXIgbnMgaW4gbnNSb290UGF0aCkgewogICAgICAgICAgICB2YXIgcGF0aCA9IG5zUm9vdFBhdGhbbnNdICsgbnMgKyAiLyI7CiAgICAgICAgICAgIGlmIChyZXNvbHZlZEZpbGVuYW1lLnN1YnN0cigwLCBwYXRoLmxlbmd0aCkgPT0gcGF0aCkgewogICAgICAgICAgICAgIGltcGxpY2l0TmFtZXNwYWNlID0gZmFsc2U7CiAgICAgICAgICAgICAgcmVzb2x2ZWRGaWxlbmFtZSA9IHJlc29sdmVkRmlsZW5hbWUuc3Vic3RyKG5zUm9vdFBhdGhbbnNdLmxlbmd0aCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5hbWVzcGFjZSA9IHJlc29sdmVkRmlsZW5hbWUucmVwbGFjZSgvXC4vZywgIl8iKS5yZXBsYWNlKC9eXC8vZywgIiIpLnJlcGxhY2UoL1wvL2csICIuIik7CiAgICAgICAgICBpZiAoaW1wbGljaXROYW1lc3BhY2UpIG5hbWVzcGFjZSA9ICJpbXBsaWNpdC4iICsgbmFtZXNwYWNlOwogICAgICAgIH0KICAgICAgICBpZiAocmVxdWlyZXMpIGFycmF5RnVuY3Rpb25zLmFkZChyZXF1aXJlcywgbmFtZXNwYWNlKTsKICAgICAgICBpZiAoIW5hbWVzcGFjZXNbbmFtZXNwYWNlXSkgewogICAgICAgICAgdmFyIG5zID0gZ2V0TmFtZXNwYWNlKG5hbWVzcGFjZSk7CiAgICAgICAgICB2YXIgc2F2ZWRSZXF1aXJlcyA9IHJlcXVpcmVzOwogICAgICAgICAgcmVxdWlyZXMgPSBbXTsKICAgICAgICAgIG5zLmV4cG9ydHMgPSBydW5TY3JpcHRJbkNvbnRleHQoewogICAgICAgICAgICBwYXRoOiBucy5wYXRoLAogICAgICAgICAgICBleHBvcnRzOiBucy5leHBvcnRzCiAgICAgICAgICB9LCBmaWxlbmFtZSwgY29udGVudCkuZXhwb3J0czsKICAgICAgICAgIGlmIChucy5leHBvcnRzICYmIG5zLmV4cG9ydHMuY29uc3RydWN0b3IgPT09IE9iamVjdCkgY29tcGxldGUobnMsIG5zLmV4cG9ydHMpOwogICAgICAgICAgbnMuZmlsZW5hbWVfID0gZmlsZW5hbWU7CiAgICAgICAgICBucy5zb3VyY2VfID0gY29udGVudDsKICAgICAgICAgIG5zLnJlcXVpcmVzXyA9IHJlcXVpcmVzOwogICAgICAgICAgcmVxdWlyZXMgPSBzYXZlZFJlcXVpcmVzOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmFtZXNwYWNlc1tuYW1lc3BhY2VdLmV4cG9ydHM7CiAgICAgIH0sIHsKICAgICAgICBwZXJtYW5lbnQ6IHRydWUKICAgICAgfSksCiAgICAgICIuY3NzIjogZnVuY3Rpb24oY29udGVudCwgdXJsLCBjc3NSZXNvdXJjZSkgewogICAgICAgIGlmICghY3NzUmVzb3VyY2UpIGNzc1Jlc291cmNlID0gbmV3IENzc1Jlc291cmNlKHVybCk7CiAgICAgICAgY3NzUmVzb3VyY2UudXBkYXRlQ3NzVGV4dChjb250ZW50KTsKICAgICAgICByZXR1cm4gY3NzUmVzb3VyY2U7CiAgICAgIH0sCiAgICAgICIuanNvbiI6IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCkgewogICAgICAgIGlmICh0eXBlb2YgY29udGVudCA9PSAib2JqZWN0IikgcmV0dXJuIGNvbnRlbnQ7CiAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICB0cnkgewogICAgICAgICAgY29udGVudCA9IFN0cmluZyhjb250ZW50KTsKICAgICAgICAgIHJlc3VsdCA9IGJhc2lzLmpzb24ucGFyc2UoY29udGVudCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29uc29sZU1ldGhvZHMud2FybigiYmFzaXMucmVzb3VyY2U6IENhbid0IHBhcnNlIEpTT04gZnJvbSAiICsgdXJsLCB7CiAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICBjb250ZW50OiBjb250ZW50CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdCB8fCBudWxsOwogICAgICB9CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gY29tcGlsZUZ1bmN0aW9uKHNvdXJjZVVSTCwgYXJncywgYm9keSkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbihhcmdzLCBib2R5ICsgIlxuXG4vLyMgc291cmNlVVJMPSIgKyBwYXRoVXRpbHMub3JpZ2luICsgc291cmNlVVJMKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaWYgKGRvY3VtZW50ICYmICJsaW5lIiBpbiBlID09IGZhbHNlICYmICJhZGRFdmVudExpc3RlbmVyIiBpbiBnbG9iYWwpIHsKICAgICAgICBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBmdW5jdGlvbiBvbmVycm9yKGV2ZW50KSB7CiAgICAgICAgICBpZiAoZXZlbnQuZmlsZW5hbWUgPT0gcGF0aFV0aWxzLm9yaWdpbiArIHNvdXJjZVVSTCkgewogICAgICAgICAgICBnbG9iYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBvbmVycm9yKTsKICAgICAgICAgICAgY29uc29sZU1ldGhvZHMuZXJyb3IoIkNvbXBpbGF0aW9uIGVycm9yIGF0ICIgKyBldmVudC5maWxlbmFtZSArICI6IiArIGV2ZW50LmxpbmVubyArICI6ICIgKyBlKTsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LnNyYyA9IHNvdXJjZVVSTDsKICAgICAgICBzY3JpcHQuYXN5bmMgPSBmYWxzZTsKICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICAgICAgZG9jdW1lbnQuaGVhZC5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICB9CiAgICAgIGNvbnNvbGVNZXRob2RzLmVycm9yKCJDb21waWxhdGlvbiBlcnJvciBhdCAiICsgc291cmNlVVJMICsgKCJsaW5lIiBpbiBlID8gIjoiICsgKGUubGluZSAtIDEpIDogIiIpICsgIjogIiArIGUpOwogICAgfQogIH0KICB2YXIgcnVuU2NyaXB0SW5Db250ZXh0ID0gZnVuY3Rpb24oY29udGV4dCwgc291cmNlVVJMLCBzb3VyY2VDb2RlKSB7CiAgICB2YXIgYmFzZVVSTCA9IHBhdGhVdGlscy5kaXJuYW1lKHNvdXJjZVVSTCkgKyAiLyI7CiAgICB2YXIgY29tcGlsZWRTb3VyY2VDb2RlID0gc291cmNlQ29kZTsKICAgIGlmICghY29udGV4dC5leHBvcnRzKSBjb250ZXh0LmV4cG9ydHMgPSB7fTsKICAgIGlmICh0eXBlb2YgY29tcGlsZWRTb3VyY2VDb2RlICE9ICJmdW5jdGlvbiIpIGNvbXBpbGVkU291cmNlQ29kZSA9IGNvbXBpbGVGdW5jdGlvbihzb3VyY2VVUkwsIFsgImV4cG9ydHMiLCAibW9kdWxlIiwgImJhc2lzIiwgImdsb2JhbCIsICJfX2ZpbGVuYW1lIiwgIl9fZGlybmFtZSIsICJyZXNvdXJjZSIsICJyZXF1aXJlIiBdLCAnInVzZSBzdHJpY3QiO1xuJyArIHNvdXJjZUNvZGUpOwogICAgaWYgKHR5cGVvZiBjb21waWxlZFNvdXJjZUNvZGUgPT0gImZ1bmN0aW9uIikgY29tcGlsZWRTb3VyY2VDb2RlLmNhbGwoY29udGV4dC5leHBvcnRzLCBjb250ZXh0LmV4cG9ydHMsIGNvbnRleHQsIGJhc2lzLCBnbG9iYWwsIHNvdXJjZVVSTCwgYmFzZVVSTCwgZnVuY3Rpb24ocmVsYXRpdmVQYXRoKSB7CiAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChyZWxhdGl2ZVBhdGgpKSBjb25zb2xlTWV0aG9kcy53YXJuKCJCYWQgdXNhZ2U6IHJlc291cmNlKCciICsgcmVsYXRpdmVQYXRoICsgIicpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4iKTsKICAgICAgcmV0dXJuIGdldFJlc291cmNlKHBhdGhVdGlscy5yZXNvbHZlKGJhc2VVUkwsIHJlbGF0aXZlUGF0aCkpOwogICAgfSwgZnVuY3Rpb24ocmVsYXRpdmVQYXRoLCBiYXNlKSB7CiAgICAgIHJldHVybiByZXF1aXJlTmFtZXNwYWNlKHJlbGF0aXZlUGF0aCwgYmFzZSB8fCBiYXNlVVJMKTsKICAgIH0pOwogICAgcmV0dXJuIGNvbnRleHQ7CiAgfTsKICB2YXIgbmFtZXNwYWNlcyA9IHt9OwogIHZhciBuYW1lc3BhY2UyZmlsZW5hbWUgPSB7fTsKICB2YXIgZmlsZW5hbWUybmFtZXNwYWNlID0ge307CiAgdmFyIG5zUm9vdFBhdGggPSB7fTsKICBpdGVyYXRlKGNvbmZpZy5tb2R1bGVzLCBmdW5jdGlvbihuYW1lLCBtb2R1bGUpIHsKICAgIG5zUm9vdFBhdGhbbmFtZV0gPSBtb2R1bGUucGF0aCArICIvIjsKICAgIG5hbWVzcGFjZTJmaWxlbmFtZVtuYW1lXSA9IG1vZHVsZS5maWxlbmFtZTsKICAgIGZpbGVuYW1lMm5hbWVzcGFjZVttb2R1bGUuZmlsZW5hbWVdID0gbmFtZTsKICB9KTsKICAoZnVuY3Rpb24obWFwKSB7CiAgICB2YXIgbWFwID0gdHlwZW9mIF9fbmFtZXNwYWNlX21hcF9fICE9ICJ1bmRlZmluZWQiID8gX19uYW1lc3BhY2VfbWFwX18gOiBudWxsOwogICAgaWYgKG1hcCkgewogICAgICBmb3IgKHZhciBrZXkgaW4gbWFwKSB7CiAgICAgICAgdmFyIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoa2V5KTsKICAgICAgICB2YXIgbmFtZXNwYWNlID0gbWFwW2tleV07CiAgICAgICAgZmlsZW5hbWUybmFtZXNwYWNlW2ZpbGVuYW1lXSA9IG5hbWVzcGFjZTsKICAgICAgICBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZXNwYWNlXSA9IGZpbGVuYW1lOwogICAgICB9CiAgICB9CiAgfSkoKTsKICB2YXIgTmFtZXNwYWNlID0gQ2xhc3MobnVsbCwgewogICAgY2xhc3NOYW1lOiAiYmFzaXMuTmFtZXNwYWNlIiwKICAgIGluaXQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgdGhpcy5leHBvcnRzID0gewogICAgICAgIHBhdGg6IHRoaXMubmFtZQogICAgICB9OwogICAgfSwKICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICJbYmFzaXMubmFtZXNwYWNlICIgKyB0aGlzLnBhdGggKyAiXSI7CiAgICB9LAogICAgZXh0ZW5kOiBmdW5jdGlvbihuYW1lcykgewogICAgICBleHRlbmQodGhpcy5leHBvcnRzLCBuYW1lcyk7CiAgICAgIHJldHVybiBjb21wbGV0ZSh0aGlzLCBuYW1lcyk7CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gcmVzb2x2ZU5TRmlsZW5hbWUobmFtZXNwYWNlKSB7CiAgICBpZiAobmFtZXNwYWNlIGluIG5hbWVzcGFjZTJmaWxlbmFtZSA9PSBmYWxzZSkgewogICAgICB2YXIgcGFydHMgPSBuYW1lc3BhY2Uuc3BsaXQoIi4iKTsKICAgICAgdmFyIG5hbWVzcGFjZVJvb3QgPSBwYXJ0cy5zaGlmdCgpOwogICAgICB2YXIgZmlsZW5hbWUgPSBwYXJ0cy5qb2luKCIvIikgKyAiLmpzIjsKICAgICAgaWYgKG5hbWVzcGFjZVJvb3QgaW4gbnNSb290UGF0aCA9PSBmYWxzZSkgbnNSb290UGF0aFtuYW1lc3BhY2VSb290XSA9IHBhdGhVdGlscy5iYXNlVVJJICsgbmFtZXNwYWNlUm9vdCArICIvIjsKICAgICAgaWYgKG5hbWVzcGFjZVJvb3QgPT0gbmFtZXNwYWNlKSBmaWxlbmFtZSA9IG5zUm9vdFBhdGhbbmFtZXNwYWNlUm9vdF0ucmVwbGFjZSgvXC8kLywgIiIpICsgIi5qcyI7IGVsc2UgZmlsZW5hbWUgPSBuc1Jvb3RQYXRoW25hbWVzcGFjZVJvb3RdICsgZmlsZW5hbWU7CiAgICAgIG5hbWVzcGFjZTJmaWxlbmFtZVtuYW1lc3BhY2VdID0gZmlsZW5hbWU7CiAgICAgIGZpbGVuYW1lMm5hbWVzcGFjZVtmaWxlbmFtZV0gPSBuYW1lc3BhY2U7CiAgICB9CiAgICByZXR1cm4gbmFtZXNwYWNlMmZpbGVuYW1lW25hbWVzcGFjZV07CiAgfQogIGZ1bmN0aW9uIGdldFJvb3ROYW1lc3BhY2UobmFtZSkgewogICAgdmFyIG5hbWVzcGFjZSA9IG5hbWVzcGFjZXNbbmFtZV07CiAgICBpZiAoIW5hbWVzcGFjZSkgewogICAgICBuYW1lc3BhY2UgPSBuYW1lc3BhY2VzW25hbWVdID0gbmV3IE5hbWVzcGFjZShuYW1lKTsKICAgICAgbmFtZXNwYWNlLm5hbWVzcGFjZXNfID0ge307CiAgICAgIG5hbWVzcGFjZS5uYW1lc3BhY2VzX1tuYW1lXSA9IG5hbWVzcGFjZTsKICAgICAgaWYgKCFjb25maWcubm9Db25mbGljdCkgZ2xvYmFsW25hbWVdID0gbmFtZXNwYWNlOwogICAgfQogICAgaWYgKG5hbWUgPT0gImxpYnJhcnkiICYmICFsaWJyYXJ5KSBsaWJyYXJ5ID0gbmFtZXNwYWNlc1tuYW1lXTsKICAgIHJldHVybiBuYW1lc3BhY2U7CiAgfQogIGZ1bmN0aW9uIGdldE5hbWVzcGFjZShwYXRoKSB7CiAgICBwYXRoID0gcGF0aC5zcGxpdCgiLiIpOwogICAgdmFyIHJvb3ROcyA9IGdldFJvb3ROYW1lc3BhY2UocGF0aFswXSk7CiAgICB2YXIgY3Vyc29yID0gcm9vdE5zOwogICAgZm9yICh2YXIgaSA9IDEsIG5hbWU7IG5hbWUgPSBwYXRoW2ldOyBpKyspIHsKICAgICAgaWYgKCFjdXJzb3JbbmFtZV0pIHsKICAgICAgICB2YXIgbnNwYXRoID0gcGF0aC5zbGljZSgwLCBpICsgMSkuam9pbigiLiIpOwogICAgICAgIGN1cnNvcltuYW1lXSA9IG5ldyBOYW1lc3BhY2UobnNwYXRoKTsKICAgICAgICByb290TnMubmFtZXNwYWNlc19bbnNwYXRoXSA9IGN1cnNvcltuYW1lXTsKICAgICAgfQogICAgICBjdXJzb3IgPSBjdXJzb3JbbmFtZV07CiAgICB9CiAgICBuYW1lc3BhY2VzW3BhdGguam9pbigiLiIpXSA9IGN1cnNvcjsKICAgIHJldHVybiBjdXJzb3I7CiAgfQogIHZhciByZXF1aXJlTmFtZXNwYWNlID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoTk9ERV9FTlYpIHsKICAgICAgdmFyIG1vZHVsZVByb3RvID0gbW9kdWxlLmNvbnN0cnVjdG9yLnByb3RvdHlwZTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZpbGVuYW1lLCBkaXJuYW1lKSB7CiAgICAgICAgaWYgKCEvW15hLXowLTlfXC5dL2kudGVzdChmaWxlbmFtZSkgfHwgcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpID09ICIuanMiKSB7CiAgICAgICAgICB2YXIgX2NvbXBpbGUgPSBtb2R1bGVQcm90by5fY29tcGlsZTsKICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBnZXROYW1lc3BhY2UoZmlsZW5hbWUpOwogICAgICAgICAgbW9kdWxlUHJvdG8uX2NvbXBpbGUgPSBmdW5jdGlvbihjb250ZW50LCBmaWxlbmFtZSkgewogICAgICAgICAgICB0aGlzLmJhc2lzID0gYmFzaXM7CiAgICAgICAgICAgIGNvbnRlbnQgPSAidmFyIF9fbm9kZWpzUmVxdWlyZSA9IHJlcXVpcmU7XG4iICsgInZhciBiYXNpcyA9IG1vZHVsZS5iYXNpcztcbiIgKyAndmFyIHJlc291cmNlID0gZnVuY3Rpb24oZmlsZW5hbWUpeyByZXR1cm4gYmFzaXMucmVzb3VyY2UoX19kaXJuYW1lICsgIi8iICsgZmlsZW5hbWUpIH07XG4nICsgInZhciByZXF1aXJlID0gZnVuY3Rpb24oZmlsZW5hbWUsIGJhc2VVUkkpeyByZXR1cm4gYmFzaXMucmVxdWlyZShmaWxlbmFtZSwgYmFzZVVSSSB8fCBfX2Rpcm5hbWUpIH07XG4iICsgY29udGVudDsKICAgICAgICAgICAgX2NvbXBpbGUuY2FsbChleHRlbmQodGhpcywgbmFtZXNwYWNlKSwgY29udGVudCwgZmlsZW5hbWUpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBleHBvcnRzID0gcmVxdWlyZShfX2Rpcm5hbWUgKyAiLyIgKyBmaWxlbmFtZS5yZXBsYWNlKC9cLi9nLCAiLyIpKTsKICAgICAgICAgIG5hbWVzcGFjZS5leHBvcnRzID0gZXhwb3J0czsKICAgICAgICAgIGlmIChleHBvcnRzICYmIGV4cG9ydHMuY29uc3RydWN0b3IgPT09IE9iamVjdCkgY29tcGxldGUobmFtZXNwYWNlLCBleHBvcnRzKTsKICAgICAgICAgIG1vZHVsZVByb3RvLl9jb21waWxlID0gX2NvbXBpbGU7CiAgICAgICAgICByZXR1cm4gZXhwb3J0czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZmlsZW5hbWUgPSBwYXRoVXRpbHMucmVzb2x2ZShkaXJuYW1lLCBmaWxlbmFtZSk7CiAgICAgICAgICByZXR1cm4gcmVxdWlyZShmaWxlbmFtZSk7CiAgICAgICAgfQogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZpbGVuYW1lLCBkaXJuYW1lKSB7CiAgICAgICAgaWYgKCEvW15hLXowLTlfXC5dL2kudGVzdChmaWxlbmFtZSkgJiYgcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpICE9ICIuanMiKSB7CiAgICAgICAgICBmaWxlbmFtZSA9IHJlc29sdmVOU0ZpbGVuYW1lKGZpbGVuYW1lKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KGZpbGVuYW1lKSkgY29uc29sZU1ldGhvZHMud2FybigiQmFkIHVzYWdlOiByZXF1aXJlKCciICsgZmlsZW5hbWUgKyAiJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLiIpOwogICAgICAgICAgZmlsZW5hbWUgPSBwYXRoVXRpbHMucmVzb2x2ZShkaXJuYW1lLCBmaWxlbmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnZXRSZXNvdXJjZShmaWxlbmFtZSkuZmV0Y2goKTsKICAgICAgfTsKICAgIH0KICB9KCk7CiAgZnVuY3Rpb24gcGF0Y2goZmlsZW5hbWUsIHBhdGNoRm4pIHsKICAgIGlmICghL1teYS16MC05X1wuXS9pLnRlc3QoZmlsZW5hbWUpICYmIHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSAhPSAiLmpzIikgewogICAgICBmaWxlbmFtZSA9IHJlc29sdmVOU0ZpbGVuYW1lKGZpbGVuYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChmaWxlbmFtZSkpIGNvbnNvbGVNZXRob2RzLndhcm4oIkJhZCB1c2FnZTogYmFzaXMucGF0Y2goJyIgKyBmaWxlbmFtZSArICInKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuIik7CiAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZmlsZW5hbWUpOwogICAgfQogICAgaWYgKCFyZXNvdXJjZVBhdGNoW2ZpbGVuYW1lXSkgcmVzb3VyY2VQYXRjaFtmaWxlbmFtZV0gPSBbIHBhdGNoRm4gXTsgZWxzZSByZXNvdXJjZVBhdGNoW2ZpbGVuYW1lXS5wdXNoKHBhdGNoRm4pOwogICAgdmFyIHJlc291cmNlID0gZ2V0UmVzb3VyY2UuZ2V0KGZpbGVuYW1lKTsKICAgIGlmIChyZXNvdXJjZSAmJiByZXNvdXJjZS5pc1Jlc29sdmVkKCkpIHBhdGNoRm4ocmVzb3VyY2UuZ2V0KCksIHJlc291cmNlLnVybCk7CiAgfQogIGNvbXBsZXRlKEZ1bmN0aW9uLnByb3RvdHlwZSwgewogICAgYmluZDogZnVuY3Rpb24odGhpc09iamVjdCkgewogICAgICB2YXIgZm4gPSB0aGlzOwogICAgICB2YXIgcGFyYW1zID0gYXJyYXlGcm9tKGFyZ3VtZW50cywgMSk7CiAgICAgIHJldHVybiBwYXJhbXMubGVuZ3RoID8gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXNPYmplY3QsIHBhcmFtcy5jb25jYXQuYXBwbHkocGFyYW1zLCBhcmd1bWVudHMpKTsKICAgICAgfSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzT2JqZWN0LCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQogIH0pOwogIGNvbXBsZXRlKEFycmF5LCB7CiAgICBpc0FycmF5OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICJbb2JqZWN0IEFycmF5XSI7CiAgICB9CiAgfSk7CiAgZnVuY3Rpb24gYXJyYXlGcm9tKG9iamVjdCwgb2Zmc2V0KSB7CiAgICBpZiAob2JqZWN0ICE9IG51bGwpIHsKICAgICAgdmFyIGxlbiA9IG9iamVjdC5sZW5ndGg7CiAgICAgIGlmICh0eXBlb2YgbGVuID09ICJ1bmRlZmluZWQiIHx8IHRvU3RyaW5nLmNhbGwob2JqZWN0KSA9PSAiW29iamVjdCBGdW5jdGlvbl0iKSByZXR1cm4gWyBvYmplY3QgXTsKICAgICAgaWYgKCFvZmZzZXQpIG9mZnNldCA9IDA7CiAgICAgIGlmIChsZW4gLSBvZmZzZXQgPiAwKSB7CiAgICAgICAgZm9yICh2YXIgcmVzdWx0ID0gW10sIGsgPSAwLCBpID0gb2Zmc2V0OyBpIDwgbGVuOyApIHJlc3VsdFtrKytdID0gb2JqZWN0W2krK107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIFtdOwogIH0KICBmdW5jdGlvbiBjcmVhdGVBcnJheShsZW5ndGgsIGZpbGxWYWx1ZSwgdGhpc09iamVjdCkgewogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgdmFyIGlzRnVuYyA9IHR5cGVvZiBmaWxsVmFsdWUgPT0gImZ1bmN0aW9uIjsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHJlc3VsdFtpXSA9IGlzRnVuYyA/IGZpbGxWYWx1ZS5jYWxsKHRoaXNPYmplY3QsIGksIHJlc3VsdCkgOiBmaWxsVmFsdWU7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBjb21wbGV0ZShBcnJheS5wcm90b3R5cGUsIHsKICAgIGluZGV4T2Y6IGZ1bmN0aW9uKHNlYXJjaEVsZW1lbnQsIG9mZnNldCkgewogICAgICBvZmZzZXQgPSBwYXJzZUludChvZmZzZXQsIDEwKSB8fCAwOwogICAgICBpZiAob2Zmc2V0IDwgMCkgcmV0dXJuIC0xOwogICAgICBmb3IgKDsgb2Zmc2V0IDwgdGhpcy5sZW5ndGg7IG9mZnNldCsrKSBpZiAodGhpc1tvZmZzZXRdID09PSBzZWFyY2hFbGVtZW50KSByZXR1cm4gb2Zmc2V0OwogICAgICByZXR1cm4gLTE7CiAgICB9LAogICAgbGFzdEluZGV4T2Y6IGZ1bmN0aW9uKHNlYXJjaEVsZW1lbnQsIG9mZnNldCkgewogICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGg7CiAgICAgIG9mZnNldCA9IHBhcnNlSW50KG9mZnNldCwgMTApOwogICAgICBpZiAoaXNOYU4ob2Zmc2V0KSB8fCBvZmZzZXQgPj0gbGVuKSBvZmZzZXQgPSBsZW4gLSAxOyBlbHNlIG9mZnNldCA9IChvZmZzZXQgKyBsZW4pICUgbGVuOwogICAgICBmb3IgKDsgb2Zmc2V0ID49IDA7IG9mZnNldC0tKSBpZiAodGhpc1tvZmZzZXRdID09PSBzZWFyY2hFbGVtZW50KSByZXR1cm4gb2Zmc2V0OwogICAgICByZXR1cm4gLTE7CiAgICB9LAogICAgZm9yRWFjaDogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIGlmIChpIGluIHRoaXMpIGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcyk7CiAgICB9LAogICAgZXZlcnk6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSBpZiAoaSBpbiB0aGlzICYmICFjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIHNvbWU6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSBpZiAoaSBpbiB0aGlzICYmIGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiB0cnVlOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbihjYWxsYmFjaywgdGhpc09iamVjdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSBpZiAoaSBpbiB0aGlzICYmIGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcykpIHJlc3VsdC5wdXNoKHRoaXNbaV0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKICAgIG1hcDogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgaWYgKGkgaW4gdGhpcykgcmVzdWx0W2ldID0gY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCiAgICByZWR1Y2U6IGZ1bmN0aW9uKGNhbGxiYWNrLCBpbml0aWFsVmFsdWUpIHsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICB2YXIgYXJnc0xlbiA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICAgIGlmIChsZW4gPT0gMCAmJiBhcmdzTGVuID09IDEpIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICAgIHZhciByZXN1bHQ7CiAgICAgIHZhciBpbml0ZWQgPSAwOwogICAgICBpZiAoYXJnc0xlbiA+IDEpIHsKICAgICAgICByZXN1bHQgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgaW5pdGVkID0gMTsKICAgICAgfQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSBpZiAoaSBpbiB0aGlzKSBpZiAoaW5pdGVkKyspIHJlc3VsdCA9IGNhbGxiYWNrLmNhbGwobnVsbCwgcmVzdWx0LCB0aGlzW2ldLCBpLCB0aGlzKTsgZWxzZSByZXN1bHQgPSB0aGlzW2ldOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogIH0pOwogIHZhciBhcnJheUZ1bmN0aW9ucyA9IHsKICAgIGZyb206IGFycmF5RnJvbSwKICAgIGNyZWF0ZTogY3JlYXRlQXJyYXksCiAgICBmbGF0dGVuOiBmdW5jdGlvbih0aGlzXykgewogICAgICByZXR1cm4gdGhpc18uY29uY2F0LmFwcGx5KFtdLCB0aGlzXyk7CiAgICB9LAogICAgcmVwZWF0OiBmdW5jdGlvbih0aGlzXywgY291bnQpIHsKICAgICAgcmV0dXJuIGFycmF5RnVuY3Rpb25zLmZsYXR0ZW4oY3JlYXRlQXJyYXkocGFyc2VJbnQoY291bnQsIDEwKSB8fCAwLCB0aGlzXykpOwogICAgfSwKICAgIHNlYXJjaDogZnVuY3Rpb24odGhpc18sIHZhbHVlLCBnZXR0ZXJfLCBvZmZzZXQpIHsKICAgICAgdGhpc18ubGFzdFNlYXJjaEluZGV4ID0gLTE7CiAgICAgIGdldHRlcl8gPSBnZXR0ZXIoZ2V0dGVyXyB8fCAkc2VsZik7CiAgICAgIGZvciAodmFyIGluZGV4ID0gcGFyc2VJbnQob2Zmc2V0LCAxMCkgfHwgMCwgbGVuID0gdGhpc18ubGVuZ3RoOyBpbmRleCA8IGxlbjsgaW5kZXgrKykgaWYgKGdldHRlcl8odGhpc19baW5kZXhdKSA9PT0gdmFsdWUpIHJldHVybiB0aGlzX1t0aGlzXy5sYXN0U2VhcmNoSW5kZXggPSBpbmRleF07CiAgICB9LAogICAgbGFzdFNlYXJjaDogZnVuY3Rpb24odGhpc18sIHZhbHVlLCBnZXR0ZXJfLCBvZmZzZXQpIHsKICAgICAgdGhpc18ubGFzdFNlYXJjaEluZGV4ID0gLTE7CiAgICAgIGdldHRlcl8gPSBnZXR0ZXIoZ2V0dGVyXyB8fCAkc2VsZik7CiAgICAgIHZhciBsZW4gPSB0aGlzXy5sZW5ndGg7CiAgICAgIHZhciBpbmRleCA9IGlzTmFOKG9mZnNldCkgfHwgb2Zmc2V0ID09IG51bGwgPyBsZW4gOiBwYXJzZUludChvZmZzZXQsIDEwKTsKICAgICAgZm9yICh2YXIgaSA9IGluZGV4ID4gbGVuID8gbGVuIDogaW5kZXg7IGktLSA+IDA7ICkgaWYgKGdldHRlcl8odGhpc19baV0pID09PSB2YWx1ZSkgcmV0dXJuIHRoaXNfW3RoaXNfLmxhc3RTZWFyY2hJbmRleCA9IGldOwogICAgfSwKICAgIGFkZDogZnVuY3Rpb24odGhpc18sIHZhbHVlKSB7CiAgICAgIHJldHVybiB0aGlzXy5pbmRleE9mKHZhbHVlKSA9PSAtMSAmJiAhIXRoaXNfLnB1c2godmFsdWUpOwogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24odGhpc18sIHZhbHVlKSB7CiAgICAgIHZhciBpbmRleCA9IHRoaXNfLmluZGV4T2YodmFsdWUpOwogICAgICByZXR1cm4gaW5kZXggIT0gLTEgJiYgISF0aGlzXy5zcGxpY2UoaW5kZXgsIDEpOwogICAgfSwKICAgIGhhczogZnVuY3Rpb24odGhpc18sIHZhbHVlKSB7CiAgICAgIHJldHVybiB0aGlzXy5pbmRleE9mKHZhbHVlKSAhPSAtMTsKICAgIH0sCiAgICBzb3J0QXNPYmplY3Q6IGZ1bmN0aW9uKCkgewogICAgICBjb25zb2xlTWV0aG9kcy53YXJuKCJiYXNpcy5hcnJheS5zb3J0QXNPYmplY3QgaXMgZGVwcmVjYXRlZCwgdXNlIGJhc2lzLmFycmF5LnNvcnQgaW5zdGVhZCIpOwogICAgICByZXR1cm4gYXJyYXlGdW5jdGlvbnMuc29ydC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIHNvcnQ6IGZ1bmN0aW9uKHRoaXNfLCBnZXR0ZXJfLCBjb21wYXJhdG9yLCBkZXNjKSB7CiAgICAgIGdldHRlcl8gPSBnZXR0ZXIoZ2V0dGVyXyk7CiAgICAgIGRlc2MgPSBkZXNjID8gLTEgOiAxOwogICAgICByZXR1cm4gdGhpc18ubWFwKGZ1bmN0aW9uKGl0ZW0sIGluZGV4KSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGk6IGluZGV4LAogICAgICAgICAgdjogZ2V0dGVyXyhpdGVtKQogICAgICAgIH07CiAgICAgIH0pLnNvcnQoY29tcGFyYXRvciB8fCBmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgcmV0dXJuIGRlc2MgKiAoYS52ID4gYi52IHx8IC0oYS52IDwgYi52KSB8fCAoYS5pID4gYi5pID8gMSA6IC0xKSk7CiAgICAgIH0pLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgcmV0dXJuIHRoaXNbaXRlbS5pXTsKICAgICAgfSwgdGhpc18pOwogICAgfQogIH07CiAgaWYgKCFbIDEsIDIgXS5zcGxpY2UoMSkubGVuZ3RoKSB7CiAgICB2YXIgbmF0aXZlQXJyYXlTcGxpY2UgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlOwogICAgQXJyYXkucHJvdG90eXBlLnNwbGljZSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgcGFyYW1zID0gYXJyYXlGcm9tKGFyZ3VtZW50cyk7CiAgICAgIGlmIChwYXJhbXMubGVuZ3RoIDwgMikgcGFyYW1zWzFdID0gdGhpcy5sZW5ndGg7CiAgICAgIHJldHVybiBuYXRpdmVBcnJheVNwbGljZS5hcHBseSh0aGlzLCBwYXJhbXMpOwogICAgfTsKICB9CiAgdmFyIEVTQ0FQRV9GT1JfUkVHRVhQID0gLyhbXC9cXFwoXClcW1xdXD9ce1x9XHxcKlwrXC1cLlxeXCRdKS9nOwogIHZhciBGT1JNQVRfUkVHRVhQID0gL1x7KFthLXpcZF9dKykoPzo6KFtcLjBdKShcZCspfDooXD8pKT9cfS9naTsKICBjb21wbGV0ZShTdHJpbmcsIHsKICAgIHRvTG93ZXJDYXNlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50b0xvd2VyQ2FzZSgpOwogICAgfSwKICAgIHRvVXBwZXJDYXNlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50b1VwcGVyQ2FzZSgpOwogICAgfSwKICAgIHRyaW06IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRyaW0oKTsKICAgIH0sCiAgICB0cmltTGVmdDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudHJpbUxlZnQoKTsKICAgIH0sCiAgICB0cmltUmlnaHQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRyaW1SaWdodCgpOwogICAgfQogIH0pOwogIGNvbXBsZXRlKFN0cmluZy5wcm90b3R5cGUsIHsKICAgIHRyaW1MZWZ0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzKy8sICIiKTsKICAgIH0sCiAgICB0cmltUmlnaHQ6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5yZXBsYWNlKC9ccyskLywgIiIpOwogICAgfSwKICAgIHRyaW06IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy50cmltTGVmdCgpLnRyaW1SaWdodCgpOwogICAgfQogIH0pOwogIHZhciBzdHJpbmdGdW5jdGlvbnMgPSB7CiAgICB0b09iamVjdDogZnVuY3Rpb24odGhpc18sIHJldGhyb3cpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gKG5ldyBGdW5jdGlvbigicmV0dXJuIDAsIiArIHRoaXNfKSkoKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChyZXRocm93KSB0aHJvdyBlOwogICAgICB9CiAgICB9LAogICAgcmVwZWF0OiBmdW5jdGlvbih0aGlzXywgY291bnQpIHsKICAgICAgcmV0dXJuIChuZXcgQXJyYXkocGFyc2VJbnQoY291bnQsIDEwKSArIDEgfHwgMCkpLmpvaW4odGhpc18pOwogICAgfSwKICAgIHF3OiBmdW5jdGlvbih0aGlzXykgewogICAgICB2YXIgdHJpbW1lZCA9IHRoaXNfLnRyaW0oKTsKICAgICAgcmV0dXJuIHRyaW1tZWQgPyB0cmltbWVkLnNwbGl0KC9ccysvKSA6IFtdOwogICAgfSwKICAgIGZvclJlZ0V4cDogZnVuY3Rpb24odGhpc18pIHsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoRVNDQVBFX0ZPUl9SRUdFWFAsICJcXCQxIik7CiAgICB9LAogICAgZm9ybWF0OiBmdW5jdGlvbih0aGlzXywgZmlyc3QpIHsKICAgICAgdmFyIGRhdGEgPSBhcnJheUZyb20oYXJndW1lbnRzLCAxKTsKICAgICAgaWYgKHR5cGVvZiBmaXJzdCA9PSAib2JqZWN0IikgZXh0ZW5kKGRhdGEsIGZpcnN0KTsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoRk9STUFUX1JFR0VYUCwgZnVuY3Rpb24obSwga2V5LCBudW1Gb3JtYXQsIG51bSwgbm9OdWxsKSB7CiAgICAgICAgdmFyIHZhbHVlID0ga2V5IGluIGRhdGEgPyBkYXRhW2tleV0gOiBub051bGwgPyAiIiA6IG07CiAgICAgICAgaWYgKG51bUZvcm1hdCAmJiAhaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICB2YWx1ZSA9IE51bWJlcih2YWx1ZSk7CiAgICAgICAgICByZXR1cm4gbnVtRm9ybWF0ID09ICIuIiA/IHZhbHVlLnRvRml4ZWQobnVtKSA6IG51bWJlckZ1bmN0aW9ucy5sZWFkKHZhbHVlLCBudW0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0pOwogICAgfSwKICAgIGNhcGl0YWxpemU6IGZ1bmN0aW9uKHRoaXNfKSB7CiAgICAgIHJldHVybiB0aGlzXy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHRoaXNfLnN1YnN0cigxKS50b0xvd2VyQ2FzZSgpOwogICAgfSwKICAgIGNhbWVsaXplOiBmdW5jdGlvbih0aGlzXykgewogICAgICByZXR1cm4gdGhpc18ucmVwbGFjZSgvLSguKS9nLCBmdW5jdGlvbihtLCBjaHIpIHsKICAgICAgICByZXR1cm4gY2hyLnRvVXBwZXJDYXNlKCk7CiAgICAgIH0pOwogICAgfSwKICAgIGRhc2hlcml6ZTogZnVuY3Rpb24odGhpc18pIHsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKG0pIHsKICAgICAgICByZXR1cm4gIi0iICsgbS50b0xvd2VyQ2FzZSgpOwogICAgICB9KTsKICAgIH0sCiAgICBpc0VtcHR5OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCBTdHJpbmcodmFsdWUpID09ICIiOwogICAgfSwKICAgIGlzTm90RW1wdHk6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAhPSBudWxsICYmIFN0cmluZyh2YWx1ZSkgIT0gIiI7CiAgICB9CiAgfTsKICBpZiAoInx8fCIuc3BsaXQoL1x8LykubGVuZ3RoICsgInx8fCIuc3BsaXQoLyhcfCkvKS5sZW5ndGggIT0gMTEpIHsKICAgIHZhciBuYXRpdmVTdHJpbmdTcGxpdCA9IFN0cmluZy5wcm90b3R5cGUuc3BsaXQ7CiAgICBTdHJpbmcucHJvdG90eXBlLnNwbGl0ID0gZnVuY3Rpb24ocGF0dGVybiwgY291bnQpIHsKICAgICAgaWYgKCFwYXR0ZXJuIHx8IHBhdHRlcm4gaW5zdGFuY2VvZiBSZWdFeHAgPT0gZmFsc2UgfHwgcGF0dGVybi5zb3VyY2UgPT0gIiIpIHJldHVybiBuYXRpdmVTdHJpbmdTcGxpdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIHZhciBwb3MgPSAwOwogICAgICB2YXIgbWF0Y2g7CiAgICAgIGlmICghcGF0dGVybi5nbG9iYWwpIHBhdHRlcm4gPSBuZXcgUmVnRXhwKHBhdHRlcm4uc291cmNlLCAvXC8oW21pXSopJC8uZXhlYyhwYXR0ZXJuKVsxXSArICJnIik7CiAgICAgIHdoaWxlIChtYXRjaCA9IHBhdHRlcm4uZXhlYyh0aGlzKSkgewogICAgICAgIG1hdGNoWzBdID0gdGhpcy5zdWJzdHJpbmcocG9zLCBtYXRjaC5pbmRleCk7CiAgICAgICAgcmVzdWx0LnB1c2guYXBwbHkocmVzdWx0LCBtYXRjaCk7CiAgICAgICAgcG9zID0gcGF0dGVybi5sYXN0SW5kZXg7CiAgICAgIH0KICAgICAgcmVzdWx0LnB1c2godGhpcy5zdWJzdHIocG9zKSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KICBpZiAoIjEyIi5zdWJzdHIoLTEpICE9ICIyIikgewogICAgdmFyIG5hdGl2ZVN0cmluZ1N1YnN0ciA9IFN0cmluZy5wcm90b3R5cGUuc3Vic3RyOwogICAgU3RyaW5nLnByb3RvdHlwZS5zdWJzdHIgPSBmdW5jdGlvbihzdGFydCwgZW5kKSB7CiAgICAgIHJldHVybiBuYXRpdmVTdHJpbmdTdWJzdHIuY2FsbCh0aGlzLCBzdGFydCA8IDAgPyBNYXRoLm1heCgwLCB0aGlzLmxlbmd0aCArIHN0YXJ0KSA6IHN0YXJ0LCBlbmQpOwogICAgfTsKICB9CiAgdmFyIG51bWJlckZ1bmN0aW9ucyA9IHsKICAgIGZpdDogZnVuY3Rpb24odGhpc18sIG1pbiwgbWF4KSB7CiAgICAgIGlmICghaXNOYU4obWluKSAmJiB0aGlzXyA8IG1pbikgcmV0dXJuIE51bWJlcihtaW4pOwogICAgICBpZiAoIWlzTmFOKG1heCkgJiYgdGhpc18gPiBtYXgpIHJldHVybiBOdW1iZXIobWF4KTsKICAgICAgcmV0dXJuIHRoaXNfOwogICAgfSwKICAgIGxlYWQ6IGZ1bmN0aW9uKHRoaXNfLCBsZW4sIGxlYWRDaGFyKSB7CiAgICAgIHJldHVybiBTdHJpbmcodGhpc18pLnJlcGxhY2UoL1xkKy8sIGZ1bmN0aW9uKG51bWJlcikgewogICAgICAgIHJldHVybiAobGVuIC09IG51bWJlci5sZW5ndGggLSAxKSA+IDEgPyAobmV3IEFycmF5KGxlbikpLmpvaW4obGVhZENoYXIgfHwgMCkgKyBudW1iZXIgOiBudW1iZXI7CiAgICAgIH0pOwogICAgfSwKICAgIGdyb3VwOiBmdW5jdGlvbih0aGlzXywgbGVuLCBzcGxpdHRlcikgewogICAgICByZXR1cm4gU3RyaW5nKHRoaXNfKS5yZXBsYWNlKC9cZCsvLCBmdW5jdGlvbihudW1iZXIpIHsKICAgICAgICByZXR1cm4gbnVtYmVyLnJlcGxhY2UoL1xkL2csIGZ1bmN0aW9uKG0sIHBvcykgewogICAgICAgICAgcmV0dXJuICFwb3MgKyAobnVtYmVyLmxlbmd0aCAtIHBvcykgJSAobGVuIHx8IDMpID8gbSA6IChzcGxpdHRlciB8fCAiICIpICsgbTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAogICAgZm9ybWF0OiBmdW5jdGlvbih0aGlzXywgcHJlYywgZ3MsIHByZWZpeCwgcG9zdGZpeCwgY29tbWEpIHsKICAgICAgdmFyIHJlcyA9IHRoaXNfLnRvRml4ZWQocHJlYyk7CiAgICAgIGlmIChncyB8fCBjb21tYSkgcmVzID0gcmVzLnJlcGxhY2UoLyhcZCspKFwuPykvLCBmdW5jdGlvbihtLCBudW1iZXIsIGMpIHsKICAgICAgICByZXR1cm4gKGdzID8gYmFzaXMubnVtYmVyLmdyb3VwKE51bWJlcihudW1iZXIpLCAzLCBncykgOiBudW1iZXIpICsgKGMgPyBjb21tYSB8fCBjIDogIiIpOwogICAgICB9KTsKICAgICAgaWYgKHByZWZpeCkgcmVzID0gcmVzLnJlcGxhY2UoL14tPy8sICIkJiIgKyAocHJlZml4IHx8ICIiKSk7CiAgICAgIHJldHVybiByZXMgKyAocG9zdGZpeCB8fCAiIik7CiAgICB9CiAgfTsKICBjb21wbGV0ZShEYXRlLCB7CiAgICBub3c6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gTnVtYmVyKG5ldyBEYXRlKTsKICAgIH0KICB9KTsKICB2YXIgcmVhZHkgPSBmdW5jdGlvbigpIHsKICAgIGZ1bmN0aW9uIGlzUmVhZHkoKSB7CiAgICAgIHJldHVybiBkb2N1bWVudC5yZWFkeVN0YXRlID09ICJjb21wbGV0ZSIgJiYgISFkb2N1bWVudC5ib2R5OwogICAgfQogICAgdmFyIGZpcmVkID0gIWRvY3VtZW50IHx8IGlzUmVhZHkoKTsKICAgIHZhciBkZWZlcnJlZEhhbmRsZXI7CiAgICBmdW5jdGlvbiBydW5SZWFkeUhhbmRsZXIoaGFuZGxlcikgewogICAgICBoYW5kbGVyLmNhbGxiYWNrLmNhbGwoaGFuZGxlci5jb250ZXh0KTsKICAgIH0KICAgIGZ1bmN0aW9uIGZpcmVIYW5kbGVycygpIHsKICAgICAgaWYgKGlzUmVhZHkoKSkgaWYgKCEoZmlyZWQrKykpIHdoaWxlIChkZWZlcnJlZEhhbmRsZXIpIHsKICAgICAgICBydW5SZWFkeUhhbmRsZXIoZGVmZXJyZWRIYW5kbGVyKTsKICAgICAgICBkZWZlcnJlZEhhbmRsZXIgPSBkZWZlcnJlZEhhbmRsZXIubmV4dDsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZG9TY3JvbGxDaGVjaygpIHsKICAgICAgdHJ5IHsKICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwoImxlZnQiKTsKICAgICAgICBmaXJlSGFuZGxlcnMoKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHNldFRpbWVvdXQoZG9TY3JvbGxDaGVjaywgMSk7CiAgICAgIH0KICAgIH0KICAgIGlmICghZmlyZWQpIHsKICAgICAgaWYgKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgZmlyZUhhbmRsZXJzLCBmYWxzZSk7CiAgICAgICAgZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBmaXJlSGFuZGxlcnMsIGZhbHNlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgZmlyZUhhbmRsZXJzKTsKICAgICAgICBnbG9iYWwuYXR0YWNoRXZlbnQoIm9ubG9hZCIsIGZpcmVIYW5kbGVycyk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICghZ2xvYmFsLmZyYW1lRWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwpIGRvU2Nyb2xsQ2hlY2soKTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICB9CiAgICB9CiAgICByZXR1cm4gZnVuY3Rpb24oY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFmaXJlZCkgewogICAgICAgIGRlZmVycmVkSGFuZGxlciA9IHsKICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjaywKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICBuZXh0OiBkZWZlcnJlZEhhbmRsZXIKICAgICAgICB9OwogICAgICB9IGVsc2UgcnVuUmVhZHlIYW5kbGVyKHsKICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICB9KTsKICAgIH07CiAgfSgpOwogIHZhciBkb2N1bWVudEludGVyZmFjZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHRpbWVyOwogICAgdmFyIHJlZmVyZW5jZSA9IHt9OwogICAgdmFyIGNhbGxiYWNrcyA9IHsKICAgICAgaGVhZDogW10sCiAgICAgIGJvZHk6IFtdCiAgICB9OwogICAgZnVuY3Rpb24gZ2V0UGFyZW50KG5hbWUpIHsKICAgICAgaWYgKGRvY3VtZW50ICYmICFyZWZlcmVuY2VbbmFtZV0pIHsKICAgICAgICByZWZlcmVuY2VbbmFtZV0gPSBkb2N1bWVudFtuYW1lXSB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShuYW1lKVswXTsKICAgICAgICBpZiAocmVmZXJlbmNlW25hbWVdKSB7CiAgICAgICAgICB2YXIgaXRlbXMgPSBjYWxsYmFja3NbbmFtZV07CiAgICAgICAgICBkZWxldGUgY2FsbGJhY2tzW25hbWVdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNiOyBjYiA9IGl0ZW1zW2ldOyBpKyspIGNiWzBdLmNhbGwoY2JbMV0sIHJlZmVyZW5jZVtuYW1lXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZWZlcmVuY2VbbmFtZV07CiAgICB9CiAgICBmdW5jdGlvbiBhZGQoKSB7CiAgICAgIHZhciBuYW1lID0gdGhpc1swXTsKICAgICAgdmFyIG5vZGUgPSB0aGlzWzFdOwogICAgICB2YXIgcmVmID0gdGhpc1syXTsKICAgICAgcmVtb3ZlKG5vZGUpOwogICAgICB2YXIgcGFyZW50ID0gZ2V0UGFyZW50KG5hbWUpOwogICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgaWYgKHJlZiA9PT0gdHJ1ZSkgcmVmID0gcGFyZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgaWYgKCFyZWYgfHwgcmVmLnBhcmVudE5vZGUgIT09IHBhcmVudCkgcmVmID0gbnVsbDsKICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHJlZik7CiAgICAgIH0gZWxzZSBjYWxsYmFja3NbbmFtZV0ucHVzaChbIGFkZCwgWyBuYW1lLCBub2RlLCByZWYgXSBdKTsKICAgIH0KICAgIGZ1bmN0aW9uIGRvY1JlYWR5KG5hbWUsIGZuLCBjb250ZXh0KSB7CiAgICAgIGlmIChjYWxsYmFja3NbbmFtZV0pIGNhbGxiYWNrc1tuYW1lXS5wdXNoKFsgZm4sIGNvbnRleHQgXSk7IGVsc2UgZm4uY2FsbChjb250ZXh0LCByZWZlcmVuY2VbbmFtZV0pOwogICAgfQogICAgZnVuY3Rpb24gcmVtb3ZlKG5vZGUpIHsKICAgICAgZm9yICh2YXIga2V5IGluIGNhbGxiYWNrcykgewogICAgICAgIHZhciBlbnRyeSA9IGFycmF5RnVuY3Rpb25zLnNlYXJjaChjYWxsYmFja3Nba2V5XSwgbm9kZSwgZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgcmV0dXJuIGl0ZW1bMV0gJiYgaXRlbVsxXVsxXTsKICAgICAgICB9KTsKICAgICAgICBpZiAoZW50cnkpIGFycmF5RnVuY3Rpb25zLnJlbW92ZShjYWxsYmFja3Nba2V5XSwgZW50cnkpOwogICAgICB9CiAgICAgIGlmIChub2RlICYmIG5vZGUucGFyZW50Tm9kZSAmJiBub2RlLnBhcmVudE5vZGUubm9kZVR5cGUgPT0gMSkgbm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgfQogICAgZnVuY3Rpb24gY2hlY2tQYXJlbnRzKCkgewogICAgICBpZiAodGltZXIgJiYgZ2V0UGFyZW50KCJoZWFkIikgJiYgZ2V0UGFyZW50KCJib2R5IikpIHRpbWVyID0gY2xlYXJJbnRlcnZhbCh0aW1lcik7CiAgICB9CiAgICBpZiAoZG9jdW1lbnQgJiYgKCFnZXRQYXJlbnQoImhlYWQiKSB8fCAhZ2V0UGFyZW50KCJib2R5IikpKSB7CiAgICAgIHRpbWVyID0gc2V0SW50ZXJ2YWwoY2hlY2tQYXJlbnRzLCA1KTsKICAgICAgcmVhZHkoY2hlY2tQYXJlbnRzKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIGhlYWQ6IHsKICAgICAgICByZWFkeTogZnVuY3Rpb24oZm4sIGNvbnRleHQpIHsKICAgICAgICAgIGRvY1JlYWR5KCJoZWFkIiwgZm4sIGNvbnRleHQpOwogICAgICAgIH0sCiAgICAgICAgYWRkOiBmdW5jdGlvbihub2RlLCByZWYpIHsKICAgICAgICAgIGFkZC5jYWxsKFsgImhlYWQiLCBub2RlLCByZWYgXSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBib2R5OiB7CiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICAgICAgICBkb2NSZWFkeSgiYm9keSIsIGZuLCBjb250ZXh0KTsKICAgICAgICB9LAogICAgICAgIGFkZDogZnVuY3Rpb24obm9kZSwgcmVmKSB7CiAgICAgICAgICBhZGQuY2FsbChbICJib2R5Iiwgbm9kZSwgcmVmIF0pOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcmVtb3ZlOiByZW1vdmUKICAgIH07CiAgfSgpOwogIHZhciBjbGVhbmVyID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgb2JqZWN0cyA9IFtdOwogICAgZnVuY3Rpb24gZGVzdHJveShsb2cpIHsKICAgICAgdmFyIGxvZ0Rlc3Ryb3kgPSBsb2cgJiYgdHlwZW9mIGxvZyA9PSAiYm9vbGVhbiI7CiAgICAgIHJlc3VsdC5nbG9iYWxEZXN0cm95ID0gdHJ1ZTsKICAgICAgcmVzdWx0LmFkZCA9ICR1bmRlZjsKICAgICAgcmVzdWx0LnJlbW92ZSA9ICR1bmRlZjsKICAgICAgdmFyIG9iamVjdDsKICAgICAgd2hpbGUgKG9iamVjdCA9IG9iamVjdHMucG9wKCkpIHsKICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5kZXN0cm95ID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChsb2dEZXN0cm95KSBjb25zb2xlTWV0aG9kcy5sb2coImRlc3Ryb3kiLCAiWyIgKyBTdHJpbmcob2JqZWN0LmNsYXNzTmFtZSkgKyAiXSIsIG9iamVjdCk7CiAgICAgICAgICAgIG9iamVjdC5kZXN0cm95KCk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGVNZXRob2RzLndhcm4oU3RyaW5nKG9iamVjdCksIGUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIG9iamVjdCkgb2JqZWN0W3Byb3BdID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgICAgb2JqZWN0cy5sZW5ndGggPSAwOwogICAgfQogICAgaWYgKCJhdHRhY2hFdmVudCIgaW4gZ2xvYmFsKSBnbG9iYWwuYXR0YWNoRXZlbnQoIm9udW5sb2FkIiwgZGVzdHJveSk7IGVsc2UgaWYgKCJhZGRFdmVudExpc3RlbmVyIiBpbiBnbG9iYWwpIGdsb2JhbC5hZGRFdmVudExpc3RlbmVyKCJ1bmxvYWQiLCBkZXN0cm95LCBmYWxzZSk7IGVsc2UgcmV0dXJuIHsKICAgICAgYWRkOiAkdW5kZWYsCiAgICAgIHJlbW92ZTogJHVuZGVmCiAgICB9OwogICAgdmFyIHJlc3VsdCA9IHsKICAgICAgYWRkOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgICBpZiAob2JqZWN0ICE9IG51bGwpIG9iamVjdHMucHVzaChvYmplY3QpOwogICAgICB9LAogICAgICByZW1vdmU6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIGFycmF5RnVuY3Rpb25zLnJlbW92ZShvYmplY3RzLCBvYmplY3QpOwogICAgICB9CiAgICB9OwogICAgcmVzdWx0LmRlc3Ryb3lfID0gZGVzdHJveTsKICAgIHJlc3VsdC5vYmplY3RzXyA9IG9iamVjdHM7CiAgICByZXR1cm4gcmVzdWx0OwogIH0oKTsKICB2YXIgQ3NzUmVzb3VyY2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBTVFlMRV9BUFBFTkRfQlVHR1kgPSBmdW5jdGlvbigpIHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0eWxlIikuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIiIpKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9KCk7CiAgICB2YXIgYmFzZUVsID0gZG9jdW1lbnQgJiYgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYmFzZSIpOwogICAgZnVuY3Rpb24gc2V0QmFzZShiYXNlVVJJKSB7CiAgICAgIGJhc2VFbC5zZXRBdHRyaWJ1dGUoImhyZWYiLCBiYXNlVVJJKTsKICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5hZGQoYmFzZUVsLCB0cnVlKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlc3RvcmVCYXNlKCkgewogICAgICBiYXNlRWwuc2V0QXR0cmlidXRlKCJocmVmIiwgbG9jYXRpb24uaHJlZik7CiAgICAgIGRvY3VtZW50SW50ZXJmYWNlLnJlbW92ZShiYXNlRWwpOwogICAgfQogICAgZnVuY3Rpb24gaW5qZWN0U3R5bGVUb0hlYWQoKSB7CiAgICAgIHNldEJhc2UodGhpcy5iYXNlVVJJKTsKICAgICAgaWYgKCF0aGlzLmVsZW1lbnQpIHsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgIGlmICghU1RZTEVfQVBQRU5EX0JVR0dZKSB0aGlzLmVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIiIpKTsKICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKCJzcmMiLCB0aGlzLnVybCk7CiAgICAgIH0KICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5hZGQodGhpcy5lbGVtZW50KTsKICAgICAgdGhpcy5zeW5jQ3NzVGV4dCgpOwogICAgICByZXN0b3JlQmFzZSgpOwogICAgfQogICAgcmV0dXJuIENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiAiYmFzaXMuQ3NzUmVzb3VyY2UiLAogICAgICBpblVzZTogMCwKICAgICAgdXJsOiAiIiwKICAgICAgYmFzZVVSSTogIiIsCiAgICAgIGNzc1RleHQ6IHVuZGVmaW5lZCwKICAgICAgZWxlbWVudDogbnVsbCwKICAgICAgaW5pdDogZnVuY3Rpb24odXJsKSB7CiAgICAgICAgdGhpcy51cmwgPSB1cmw7CiAgICAgICAgdGhpcy5iYXNlVVJJID0gcGF0aFV0aWxzLmRpcm5hbWUodXJsKSArICIvIjsKICAgICAgfSwKICAgICAgdXBkYXRlQ3NzVGV4dDogZnVuY3Rpb24oY3NzVGV4dCkgewogICAgICAgIGlmICh0aGlzLmNzc1RleHQgIT0gY3NzVGV4dCkgewogICAgICAgICAgdGhpcy5jc3NUZXh0ID0gY3NzVGV4dDsKICAgICAgICAgIGlmICh0aGlzLmluVXNlICYmIHRoaXMuZWxlbWVudCkgewogICAgICAgICAgICBzZXRCYXNlKHRoaXMuYmFzZVVSSSk7CiAgICAgICAgICAgIHRoaXMuc3luY0Nzc1RleHQoKTsKICAgICAgICAgICAgcmVzdG9yZUJhc2UoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIHN5bmNDc3NUZXh0OiBTVFlMRV9BUFBFTkRfQlVHR1kgPyBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmVsZW1lbnQuc3R5bGVTaGVldC5jc3NUZXh0ID0gdGhpcy5jc3NUZXh0OwogICAgICB9IDogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGNzc1RleHQgPSB0aGlzLmNzc1RleHQ7CiAgICAgICAgY3NzVGV4dCArPSAiXG4vKiMgc291cmNlVVJMPSIgKyBwYXRoVXRpbHMub3JpZ2luICsgdGhpcy51cmwgKyAiICovIjsKICAgICAgICB0aGlzLmVsZW1lbnQuZmlyc3RDaGlsZC5ub2RlVmFsdWUgPSBjc3NUZXh0OwogICAgICB9LAogICAgICBzdGFydFVzZTogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCF0aGlzLmluVXNlKSBkb2N1bWVudEludGVyZmFjZS5oZWFkLnJlYWR5KGluamVjdFN0eWxlVG9IZWFkLCB0aGlzKTsKICAgICAgICB0aGlzLmluVXNlICs9IDE7CiAgICAgIH0sCiAgICAgIHN0b3BVc2U6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmluVXNlKSB7CiAgICAgICAgICB0aGlzLmluVXNlIC09IDE7CiAgICAgICAgICBpZiAoIXRoaXMuaW5Vc2UgJiYgdGhpcy5lbGVtZW50KSBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUodGhpcy5lbGVtZW50KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmVsZW1lbnQpIGRvY3VtZW50SW50ZXJmYWNlLnJlbW92ZSh0aGlzLmVsZW1lbnQpOwogICAgICAgIHRoaXMuZWxlbWVudCA9IG51bGw7CiAgICAgICAgdGhpcy5jc3NUZXh0ID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgfSgpOwogIHZhciBiYXNpcyA9IGdldE5hbWVzcGFjZSgiYmFzaXMiKS5leHRlbmQoewogICAgZmlsZW5hbWVfOiBiYXNpc0ZpbGVuYW1lLAogICAgcHJvY2Vzc0NvbmZpZzogcHJvY2Vzc0NvbmZpZywKICAgIHZlcnNpb246IFZFUlNJT04sCiAgICBOT0RFX0VOVjogTk9ERV9FTlYsCiAgICBjb25maWc6IGNvbmZpZywKICAgIGNyZWF0ZVNhbmRib3g6IGZ1bmN0aW9uKGNvbmZpZykgewogICAgICByZXR1cm4gY3JlYXRlQmFzaXNJbnN0YW5jZShnbG9iYWwsIGJhc2lzRmlsZW5hbWUsIGNvbXBsZXRlKHsKICAgICAgICBub0NvbmZsaWN0OiB0cnVlCiAgICAgIH0sIGNvbmZpZykpOwogICAgfSwKICAgIHJlc29sdmVOU0ZpbGVuYW1lOiByZXNvbHZlTlNGaWxlbmFtZSwKICAgIHBhdGNoOiBwYXRjaCwKICAgIG5hbWVzcGFjZTogZ2V0TmFtZXNwYWNlLAogICAgcmVxdWlyZTogcmVxdWlyZU5hbWVzcGFjZSwKICAgIHJlc291cmNlOiBnZXRSZXNvdXJjZSwKICAgIGFzc2V0OiBmdW5jdGlvbih1cmwpIHsKICAgICAgcmV0dXJuIHVybDsKICAgIH0sCiAgICBzZXRJbW1lZGlhdGU6IHNldEltbWVkaWF0ZSwKICAgIGNsZWFySW1tZWRpYXRlOiBjbGVhckltbWVkaWF0ZSwKICAgIG5leHRUaWNrOiBmdW5jdGlvbigpIHsKICAgICAgc2V0SW1tZWRpYXRlLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgQ2xhc3M6IENsYXNzLAogICAgVG9rZW46IFRva2VuLAogICAgRGVmZXJyZWRUb2tlbjogRGVmZXJyZWRUb2tlbiwKICAgIGdlblVJRDogZ2VuVUlELAogICAgZ2V0dGVyOiBnZXR0ZXIsCiAgICByZWFkeTogcmVhZHksCiAgICBjbGVhbmVyOiBjbGVhbmVyLAogICAgY29uc29sZTogY29uc29sZU1ldGhvZHMsCiAgICBwYXRoOiBwYXRoVXRpbHMsCiAgICBkb2M6IGRvY3VtZW50SW50ZXJmYWNlLAogICAgb2JqZWN0OiB7CiAgICAgIGV4dGVuZDogZXh0ZW5kLAogICAgICBjb21wbGV0ZTogY29tcGxldGUsCiAgICAgIGtleXM6IGtleXMsCiAgICAgIHZhbHVlczogdmFsdWVzLAogICAgICBzbGljZTogc2xpY2UsCiAgICAgIHNwbGljZTogc3BsaWNlLAogICAgICBtZXJnZTogbWVyZ2UsCiAgICAgIGl0ZXJhdGU6IGl0ZXJhdGUKICAgIH0sCiAgICBmbjogewogICAgICAkdW5kZWZpbmVkOiAkdW5kZWZpbmVkLAogICAgICAkZGVmaW5lZDogJGRlZmluZWQsCiAgICAgICRpc051bGw6ICRpc051bGwsCiAgICAgICRpc05vdE51bGw6ICRpc05vdE51bGwsCiAgICAgICRpc1NhbWU6ICRpc1NhbWUsCiAgICAgICRpc05vdFNhbWU6ICRpc05vdFNhbWUsCiAgICAgICRzZWxmOiAkc2VsZiwKICAgICAgJGNvbnN0OiAkY29uc3QsCiAgICAgICRmYWxzZTogJGZhbHNlLAogICAgICAkdHJ1ZTogJHRydWUsCiAgICAgICRudWxsOiAkbnVsbCwKICAgICAgJHVuZGVmOiAkdW5kZWYsCiAgICAgIGdldHRlcjogZ2V0dGVyLAogICAgICBudWxsR2V0dGVyOiBudWxsR2V0dGVyLAogICAgICB3cmFwcGVyOiB3cmFwcGVyLAogICAgICBsYXp5SW5pdDogbGF6eUluaXQsCiAgICAgIGxhenlJbml0QW5kUnVuOiBsYXp5SW5pdEFuZFJ1biwKICAgICAgcnVuT25jZTogcnVuT25jZQogICAgfSwKICAgIGFycmF5OiBleHRlbmQoYXJyYXlGcm9tLCBhcnJheUZ1bmN0aW9ucyksCiAgICBzdHJpbmc6IHN0cmluZ0Z1bmN0aW9ucywKICAgIG51bWJlcjogbnVtYmVyRnVuY3Rpb25zLAogICAgYm9vbDogewogICAgICBpbnZlcnQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuICF2YWx1ZTsKICAgICAgfQogICAgfSwKICAgIGpzb246IHsKICAgICAgcGFyc2U6IHR5cGVvZiBKU09OICE9ICJ1bmRlZmluZWQiID8gSlNPTi5wYXJzZSA6IGZ1bmN0aW9uKHN0cikgewogICAgICAgIHJldHVybiBzdHJpbmdGdW5jdGlvbnMudG9PYmplY3Qoc3RyLCB0cnVlKTsKICAgICAgfQogICAgfQogIH0pOwogIGdldE5hbWVzcGFjZSgiYmFzaXMuZGV2IikuZXh0ZW5kKGNvbnNvbGVNZXRob2RzKTsKICBpZiAoY29uZmlnLmF1dG9sb2FkKSBjb25maWcuYXV0b2xvYWQuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICByZXF1aXJlTmFtZXNwYWNlKG5hbWUpOwogIH0pOwogIHJldHVybiBiYXNpczsKfSkodGhpcyk7Cn0pLmNhbGwodGhpcyk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 12:11:08 GMT",
                    "Content-Length": "513096",
                    "Date": "Thu, 06 Nov 2014 12:11:10 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}