{
    "url": "http://localhost:9999/kotnik/jso/jso.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Client-side JSON injection (DOM-based)",
    "issueType": 2098032,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based JSON injection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and incorporates this into a string that is parsed as a JSON data structure and then processed by the application. An attacker may be able to use this behavior to construct a URL which, if visited by another application user, will cause arbitrary JSON data to be processed. Depending on the purpose for which this data is used, it may be possible to subvert the application's logic, or cause unintended actions on behalf of the user.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based JSON injection vulnerabilities is not to parse as JSON any string containing data that originated from an untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from modifying the JSON structure in inappropriate ways. This may involve strict validation of specific items to ensure they do not contain any characters that may interfere with the structure of the JSON when it is parsed.",
    "issueDetail": "The application may be vulnerable to DOM-based client-side JSON injection. Data is read from <b>window.location.hash</b> and written to <b>JSON.parse()</b> via the following statements:<ul><li>request[\"restoreHash\"] = window.location.hash;</li><li>log(JSON.parse(JSON.stringify(request)));</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/kotnik/jso/jso.js",
                "path": "/kotnik/jso/jso.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9rb3RuaWsvanNvL2pzby5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTM4NjMNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDc6Mzg6NDIgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDA3OjM4OjQyIEdNVA0KDQooZnVuY3Rpb24oZXhwLCAkKSB7CgoJdmFyIAoJCWNvbmZpZyA9IHt9LAoJCWRlZmF1bHRfbGlmZXRpbWUgPSAzNjAwLAoJCW9wdGlvbnMgPSB7CgkJCSJkZWJ1ZyI6IGZhbHNlCgkJfSwKCgkJYXBpX3JlZGlyZWN0LAoJCUFwaV9kZWZhdWx0X3N0b3JhZ2UsCgkJYXBpX3N0b3JhZ2UsCgoJCWludGVybmFsU3RhdGVzID0gW107CgoJLyoKCSAqIC0tLS0tLSBTRUNUSU9OOiBVdGlsaXRpZXMKCSAqLwoKCS8qCgkgKiBSZXR1cm5zIGEgcmFuZG9tIHN0cmluZyB1c2VkIGZvciBzdGF0ZQoJICovCgl2YXIgdXVpZCA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAneHh4eHh4eHgteHh4eC00eHh4LXl4eHgteHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uKGMpIHsKCQkJdmFyIHIgPSBNYXRoLnJhbmRvbSgpKjE2fDAsIHYgPSBjID09ICd4JyA/IHIgOiAociYweDN8MHg4KTsKCQkJcmV0dXJuIHYudG9TdHJpbmcoMTYpOwoJCX0pOwoJfQoKCS8qKgoJICogQSBsb2cgd3JhcHBlciwgdGhhdCBvbmx5IGxvZ3MgaWYgbG9nZ2luZyBpcyB0dXJuZWQgb24gaW4gdGhlIGNvbmZpZwoJICogQHBhcmFtICB7c3RyaW5nfSBtc2cgTG9nIG1lc3NhZ2UKCSAqLwoJdmFyIGxvZyA9IGZ1bmN0aW9uKG1zZykgewoJCWlmICghb3B0aW9ucy5kZWJ1ZykgcmV0dXJuOwoJCWlmICghY29uc29sZSkgcmV0dXJuOwoJCWlmICghY29uc29sZS5sb2cpIHJldHVybjsKCgkJLy8gY29uc29sZS5sb2coIkxPRygpLCBBcmd1bWVudHMiLCBhcmd1bWVudHMsIG1zZykKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIHsKCQkJY29uc29sZS5sb2coYXJndW1lbnRzKTsJCgkJfSBlbHNlIHsKCQkJY29uc29sZS5sb2cobXNnKTsKCQl9CgkJCgl9CgoJLyoqCgkgKiBTZXQgdGhlIGdsb2JhbCBvcHRpb25zLgoJICovCgl2YXIgc2V0T3B0aW9ucyA9IGZ1bmN0aW9uKG9wdHMpIHsKCQlpZiAoIW9wdHMpIHJldHVybjsKCQlmb3IodmFyIGsgaW4gb3B0cykgewoJCQlpZiAob3B0cy5oYXNPd25Qcm9wZXJ0eShrKSkgewoJCQkJb3B0aW9uc1trXSA9IG9wdHNba107CgkJCX0KCQl9CgkJbG9nKCJPcHRpb25zIGlzIHNldCB0byAiLCBvcHRpb25zKTsKCX0KCgoJLyogCgkgKiBUYWtlcyBhbiBVUkwgYXMgaW5wdXQgYW5kIGEgcGFyYW1zIG9iamVjdC4KCSAqIEVhY2ggcHJvcGVydHkgaW4gdGhlIHBhcmFtcyBpcyBhZGRlZCB0byB0aGUgdXJsIGFzIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzCgkgKi8KCXZhciBlbmNvZGVVUkwgPSBmdW5jdGlvbih1cmwsIHBhcmFtcykgewoJCXZhciByZXMgPSB1cmw7CgkJdmFyIGssIGkgPSAwOwoJCXZhciBmaXJzdFNlcGFyYXRvciA9ICh1cmwuaW5kZXhPZigiPyIpID09PSAtMSkgPyAnPycgOiAnJic7CgkJZm9yKGsgaW4gcGFyYW1zKSB7CgkJCXJlcyArPSAoaSsrID09PSAwID8gZmlyc3RTZXBhcmF0b3IgOiAnJicpICsgZW5jb2RlVVJJQ29tcG9uZW50KGspICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHBhcmFtc1trXSk7CgkJfQoJCXJldHVybiByZXM7Cgl9CgkKCgkvKgoJICogUmV0dXJucyBlcG9jaCwgc2Vjb25kcyBzaW5jZSAxOTcwLgoJICogVXNlZCBmb3IgY2FsY3VsYXRpb24gb2YgZXhwaXJlIHRpbWVzLgoJICovCgl2YXIgZXBvY2ggPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gTWF0aC5yb3VuZChuZXcgRGF0ZSgpLmdldFRpbWUoKS8xMDAwLjApOwoJfQoKCgoJdmFyIHBhcnNlUXVlcnlTdHJpbmcgPSBmdW5jdGlvbiAocXMpIHsKCQl2YXIgZSwKCQkJYSA9IC9cKy9nLCAgLy8gUmVnZXggZm9yIHJlcGxhY2luZyBhZGRpdGlvbiBzeW1ib2wgd2l0aCBhIHNwYWNlCgkJCXIgPSAvKFteJjs9XSspPT8oW14mO10qKS9nLAoJCQlkID0gZnVuY3Rpb24gKHMpIHsgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChzLnJlcGxhY2UoYSwgIiAiKSk7IH0sCgkJCXEgPSBxcywKCQkJdXJsUGFyYW1zID0ge307CgoJCXdoaWxlIChlID0gci5leGVjKHEpKQoJCSAgIHVybFBhcmFtc1tkKGVbMV0pXSA9IGQoZVsyXSk7CgoJCXJldHVybiB1cmxQYXJhbXM7Cgl9CgkvKgoJICogLS0tLS0tIC8gU0VDVElPTjogVXRpbGl0aWVzCgkgKi8KCgoKCgoKCS8qIAoJICogUmVkaXJlY3RzIHRoZSB1c2VyIHRvIGEgc3BlY2lmaWMgVVJMCgkgKi8KCWFwaV9yZWRpcmVjdCA9IGZ1bmN0aW9uKHVybCkgewoJCXdpbmRvdy5sb2NhdGlvbiA9IHVybDsKCX07CgoJQXBpX2RlZmF1bHRfc3RvcmFnZSA9IGZ1bmN0aW9uKCkgewoJCWxvZygiQ29uc3RydWN0b3IiKTsKCX07CgoJLyoqCgkJc2F2ZVN0YXRlIHN0b3JlcyBhbiBvYmplY3Qgd2l0aCBhbiBJZGVudGlmaWVyLgoJCVRPRE86IEVuc3VyZSB0aGF0IGJvdGggbG9jYWxzdG9yYWdlIGFuZCBKU09OIGVuY29kaW5nIGhhcyBmYWxsYmFja3MgZm9yIGFuY2llbnQgYnJvd3NlcnMuCgkJSW4gdGhlIHN0YXRlIG9iamVjdCwgd2UgcHV0IHRoZSByZXF1ZXN0IG9iamVjdCwgcGx1cyB0aGVzZSBwYXJhbWV0ZXJzOgoJCSAgKiByZXN0b3JlSGFzaAoJCSAgKiBwcm92aWRlcklECgkJICAqIHNjb3BlcwoKCSAqLwoJQXBpX2RlZmF1bHRfc3RvcmFnZS5wcm90b3R5cGUuc2F2ZVN0YXRlID0gIGZ1bmN0aW9uIChzdGF0ZSwgb2JqKSB7CgkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oInN0YXRlLSIgKyBzdGF0ZSwgSlNPTi5zdHJpbmdpZnkob2JqKSk7Cgl9CgoKCS8qKgoJICogZ2V0U3RhZ2UoKSAgcmV0dXJucyB0aGUgc3RhdGUgb2JqZWN0LCBidXQgYWxzbyByZW1vdmVzIGl0LgoJICogQHR5cGUge09iamVjdH0KCSAqLwoJQXBpX2RlZmF1bHRfc3RvcmFnZS5wcm90b3R5cGUuZ2V0U3RhdGUgPSBmdW5jdGlvbihzdGF0ZSkgewoJCS8vIGxvZygiZ2V0U3RhdGUgKCIgKyBzdGF0ZSsgIikiKTsKCQl2YXIgb2JqID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgic3RhdGUtIiArIHN0YXRlKSk7CgkJbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oInN0YXRlLSIgKyBzdGF0ZSkKCQlyZXR1cm4gb2JqOwoJfTsKCgoJLyoKCSAqIENoZWNrcyBpZiBhIHRva2VuLCBoYXMgaW5jbHVkZXMgYSBzcGVjaWZpYyBzY29wZS4KCSAqIElmIHRva2VuIGhhcyBubyBzY29wZSBhdCBhbGwsIGZhbHNlIGlzIHJldHVybmVkLgoJICovCglBcGlfZGVmYXVsdF9zdG9yYWdlLnByb3RvdHlwZS5oYXNTY29wZSA9IGZ1bmN0aW9uKHRva2VuLCBzY29wZSkgewoJCXZhciBpOwoJCWlmICghdG9rZW4uc2NvcGVzKSByZXR1cm4gZmFsc2U7CgkJZm9yKGkgPSAwOyBpIDwgdG9rZW4uc2NvcGVzLmxlbmd0aDsgaSsrKSB7CgkJCWlmICh0b2tlbi5zY29wZXNbaV0gPT09IHNjb3BlKSByZXR1cm4gdHJ1ZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfTsKCgkvKgoJICogVGFrZXMgYW4gYXJyYXkgb2YgdG9rZW5zLCBhbmQgcmVtb3ZlcyB0aGUgb25lcyB0aGF0CgkgKiBhcmUgZXhwaXJlZCwgYW5kIHRoZSBvbmVzIHRoYXQgZG8gbm90IG1lZXQgYSBzY29wZXMgcmVxdWlyZW1lbnQuCgkgKi8KCUFwaV9kZWZhdWx0X3N0b3JhZ2UucHJvdG90eXBlLmZpbHRlclRva2VucyA9IGZ1bmN0aW9uKHRva2Vucywgc2NvcGVzKSB7CgkJdmFyIGksIGosIAoJCQlyZXN1bHQgPSBbXSwKCQkJbm93ID0gZXBvY2goKSwKCQkJdXNldGhpczsKCgkJaWYgKCFzY29wZXMpIHNjb3BlcyA9IFtdOwoKCQlmb3IoaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspIHsKCQkJdXNldGhpcyA9IHRydWU7CgoJCQkvLyBGaWx0ZXIgb3V0IGV4cGlyZWQgdG9rZW5zLiBUb2tlbnMgdGhhdCBpcyBleHBpcmVkIGluIDEgc2Vjb25kIGZyb20gbm93LgoJCQlpZiAodG9rZW5zW2ldLmV4cGlyZXMgJiYgdG9rZW5zW2ldLmV4cGlyZXMgPCAobm93KzEpKSB1c2V0aGlzID0gZmFsc2U7CgoJCQkvLyBGaWx0ZXIgb3V0IHRoaXMgdG9rZW4gaWYgbm90IGFsbCBzY29wZSByZXF1aXJlbWVudHMgYXJlIG1ldAoJCQlmb3IoaiA9IDA7IGogPCBzY29wZXMubGVuZ3RoOyBqKyspIHsKCQkJCWlmICghYXBpX3N0b3JhZ2UuaGFzU2NvcGUodG9rZW5zW2ldLCBzY29wZXNbal0pKSB1c2V0aGlzID0gZmFsc2U7CgkJCX0KCgkJCWlmICh1c2V0aGlzKSByZXN1bHQucHVzaCh0b2tlbnNbaV0pOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgoJLyoKCSAqIHNhdmVUb2tlbnMoKSBzdG9yZXMgYSBsaXN0IG9mIHRva2VucyBmb3IgYSBwcm92aWRlci4KCgkJVXN1YWxseSB0aGUgdG9rZW5zIHN0b3JlZCBhcmUgYSBwbGFpbiBBY2Nlc3MgdG9rZW4gcGx1czoKCQkgICogZXhwaXJlcyA6IHRpbWUgdGhhdCB0aGUgdG9rZW4gZXhwaXJlcwoJCSAgKiBwcm92aWRlcklEOiB0aGUgcHJvdmlkZXIgb2YgdGhlIGFjY2VzcyB0b2tlbj8KCQkgICogc2NvcGVzOiBhbiBhcnJheSB3aXRoIHRoZSBzY29wZXMgKG5vdCBzdHJpbmcpCgkgKi8KCUFwaV9kZWZhdWx0X3N0b3JhZ2UucHJvdG90eXBlLnNhdmVUb2tlbnMgPSBmdW5jdGlvbihwcm92aWRlciwgdG9rZW5zKSB7CgkJLy8gbG9nKCJTYXZlIFRva2VucyAoIiArIHByb3ZpZGVyKyAiKSIpOwoJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKCJ0b2tlbnMtIiArIHByb3ZpZGVyLCBKU09OLnN0cmluZ2lmeSh0b2tlbnMpKTsKCX07CgoJQXBpX2RlZmF1bHRfc3RvcmFnZS5wcm90b3R5cGUuZ2V0VG9rZW5zID0gZnVuY3Rpb24ocHJvdmlkZXIpIHsKCQkvLyBsb2coIkdldCBUb2tlbnMgKCIgKyBwcm92aWRlcisgIikiKTsKCQl2YXIgdG9rZW5zID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgidG9rZW5zLSIgKyBwcm92aWRlcikpOwoJCWlmICghdG9rZW5zKSB0b2tlbnMgPSBbXTsKCgkJbG9nKCJUb2tlbiByZWNlaXZlZCIsIHRva2VucykKCQlyZXR1cm4gdG9rZW5zOwoJfTsKCUFwaV9kZWZhdWx0X3N0b3JhZ2UucHJvdG90eXBlLndpcGVUb2tlbnMgPSBmdW5jdGlvbihwcm92aWRlcikgewoJCWxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJ0b2tlbnMtIiArIHByb3ZpZGVyKTsKCX07CgkvKgoJICogU2F2ZSBhIHNpbmdsZSB0b2tlbiBmb3IgYSBwcm92aWRlci4KCSAqIFRoaXMgYWxzbyBjbGVhbnMgdXAgZXhwaXJlZCB0b2tlbnMgZm9yIHRoZSBzYW1lIHByb3ZpZGVyLgoJICovCglBcGlfZGVmYXVsdF9zdG9yYWdlLnByb3RvdHlwZS5zYXZlVG9rZW4gPSBmdW5jdGlvbihwcm92aWRlciwgdG9rZW4pIHsKCQl2YXIgdG9rZW5zID0gdGhpcy5nZXRUb2tlbnMocHJvdmlkZXIpOwoJCXRva2VucyA9IGFwaV9zdG9yYWdlLmZpbHRlclRva2Vucyh0b2tlbnMpOwoJCXRva2Vucy5wdXNoKHRva2VuKTsKCQl0aGlzLnNhdmVUb2tlbnMocHJvdmlkZXIsIHRva2Vucyk7Cgl9OwoKCS8qCgkgKiBHZXQgYSB0b2tlbiBpZiBleGlzdHMgZm9yIGEgcHJvdmlkZXIgd2l0aCBhIHNldCBvZiBzY29wZXMuCgkgKiBUaGUgc2NvcGVzIHBhcmFtZXRlciBpcyBPUFRJT05BTC4KCSAqLwoJQXBpX2RlZmF1bHRfc3RvcmFnZS5wcm90b3R5cGUuZ2V0VG9rZW4gPSBmdW5jdGlvbihwcm92aWRlciwgc2NvcGVzKSB7CgkJdmFyIHRva2VucyA9IHRoaXMuZ2V0VG9rZW5zKHByb3ZpZGVyKTsKCQl0b2tlbnMgPSBhcGlfc3RvcmFnZS5maWx0ZXJUb2tlbnModG9rZW5zLCBzY29wZXMpOwoJCWlmICh0b2tlbnMubGVuZ3RoIDwgMSkgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRva2Vuc1swXTsKCX07CgoJYXBpX3N0b3JhZ2UgPSBuZXcgQXBpX2RlZmF1bHRfc3RvcmFnZSgpOwoKCgoKCgoKCgoKCS8qKgoJICogQ2hlY2sgaWYgdGhlIGhhc2ggY29udGFpbnMgYW4gYWNjZXNzIHRva2VuLiAKCSAqIEFuZCBpZiBpdCBkbywgZXh0cmFjdCB0aGUgc3RhdGUsIGNvbXBhcmUgd2l0aAoJICogY29uZmlnLCBhbmQgc3RvcmUgdGhlIGFjY2VzcyB0b2tlbiBmb3IgbGF0ZXIgdXNlLgoJICoKCSAqIFRoZSB1cmwgcGFyYW1ldGVyIGlzIG9wdGlvbmFsLiBVc2VkIHdpdGggcGhvbmVnYXAgYW5kCgkgKiBjaGlsZGJyb3dzZXIgd2hlbiB0aGUganNvIGNvbnRleHQgaXMgbm90IHJlY2VpdmluZyB0aGUgcmVzcG9uc2UsCgkgKiBpbnN0ZWFkIHRoZSByZXNwb25zZSBpcyByZWNlaXZlZCBvbiBhIGNoaWxkIGJyb3dzZXIuCgkgKi8KCWV4cC5qc29fY2hlY2tmb3J0b2tlbiA9IGZ1bmN0aW9uKHByb3ZpZGVySUQsIHVybCwgY2FsbGJhY2spIHsKCQl2YXIgCgkJCWF0b2tlbiwKCQkJaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoLAoJCQlub3cgPSBlcG9jaCgpLAoJCQlzdGF0ZSwKCQkJY287CgoJCWxvZygianNvX2NoZWNrZm9ydG9rZW4oIiArIHByb3ZpZGVySUQgKyAiKSIpOwoKCQkvLyBJZiBhIHVybCBpcyBwcm92aWRlZCAKCQlpZiAodXJsKSB7CgkJCS8vIGxvZygnSGFoLCBJIGdvdCB0aGUgdXJsIGFuZCBpdCAnICsgdXJsKTsKCQkJaWYodXJsLmluZGV4T2YoJyMnKSA9PT0gLTEpIHJldHVybjsKCQkJaCA9IHVybC5zdWJzdHJpbmcodXJsLmluZGV4T2YoJyMnKSk7CgkJCS8vIGxvZygnSGFoLCBJIGdvdCB0aGUgaGFzaCBhbmQgaXQgaXMgJyArICBoKTsKCQl9CgoJCS8qCgkJICogU3RhcnQgd2l0aCBjaGVja2luZyBpZiB0aGVyZSBpcyBhIHRva2VuIGluIHRoZSBoYXNoCgkJICovCgkJaWYgKGgubGVuZ3RoIDwgMikgcmV0dXJuOwoJCWlmIChoLmluZGV4T2YoImFjY2Vzc190b2tlbiIpID09PSAtMSkgcmV0dXJuOwoJCWggPSBoLnN1YnN0cmluZygxKTsKCQlhdG9rZW4gPSBwYXJzZVF1ZXJ5U3RyaW5nKGgpOwoKCQlpZiAoYXRva2VuLnN0YXRlKSB7CgkJCXN0YXRlID0gYXBpX3N0b3JhZ2UuZ2V0U3RhdGUoYXRva2VuLnN0YXRlKTsKCQl9IGVsc2UgewoJCQlpZiAoIXByb3ZpZGVySUQpIHt0aHJvdyAiQ291bGQgbm90IGdldCBbc3RhdGVdIGFuZCBubyBkZWZhdWx0IHByb3ZpZGVyaWQgaXMgcHJvdmlkZWQuIjt9CgkJCXN0YXRlID0ge3Byb3ZpZGVySUQ6IHByb3ZpZGVySUR9OwoJCX0KCgkJCgkJaWYgKCFzdGF0ZSkgdGhyb3cgIkNvdWxkIG5vdCByZXRyaWV2ZSBzdGF0ZSI7CgkJaWYgKCFzdGF0ZS5wcm92aWRlcklEKSB0aHJvdyAiQ291bGQgbm90IGdldCBwcm92aWRlcmlkIGZyb20gc3RhdGUiOwoJCWlmICghY29uZmlnW3N0YXRlLnByb3ZpZGVySURdKSB0aHJvdyAiQ291bGQgbm90IHJldHJpZXZlIGNvbmZpZyBmb3IgdGhpcyBwcm92aWRlci4iOwoJCWNvID0gY29uZmlnW3N0YXRlLnByb3ZpZGVySURdOwoKCQkvKioKCQkgKiBJZiBzdGF0ZSB3YXMgbm90IHByb3ZpZGVkLCBhbmQgZGVmYXVsdCBwcm92aWRlciBjb250YWlucyBhIHNjb3BlIHBhcmFtZXRlcgoJCSAqIHdlIGFzc3VtZSB0aGlzIGlzIHRoZSBvbmUgcmVxdWVzdGVkLi4uCgkJICovCgkJaWYgKCFhdG9rZW4uc3RhdGUgJiYgY28uc2NvcGUpIHsKCQkJc3RhdGUuc2NvcGVzID0gY28uc2NvcGU7CgkJCWxvZygiU2V0dGluZyBzdGF0ZTogIiwgc3RhdGUpOwoJCX0KCQlsb2coIkNoZWNraW5nIGF0b2tlbiAiLCBhdG9rZW4sICIgYW5kIGNvICIsIGNvKTsKCgkJLyoKCQkgKiBEZWNpZGUgd2hlbiB0aGlzIHRva2VuIHNob3VsZCBleHBpcmUuCgkJICogUHJpb3JpdHkgZmFsbGJhY2s6CgkJICogMS4gQWNjZXNzIHRva2VuIGV4cGlyZXNfaW4KCQkgKiAyLiBMaWZlIHRpbWUgaW4gY29uZmlnIChtYXkgYmUgZmFsc2UgPSBwZXJtYW5lbnQuLi4pCgkJICogMy4gU3BlY2lmaWMgcGVybWFuZW50IHNjb3BlLgoJCSAqIDQuIERlZmF1bHQgbGlicmFyeSBsaWZldGltZToKCQkgKi8KCQlpZiAoYXRva2VuWyJleHBpcmVzX2luIl0pIHsKCQkJYXRva2VuWyJleHBpcmVzIl0gPSBub3cgKyBwYXJzZUludChhdG9rZW5bImV4cGlyZXNfaW4iXSwgMTApOwoJCX0gZWxzZSBpZiAoY29bImRlZmF1bHRfbGlmZXRpbWUiXSA9PT0gZmFsc2UpIHsKCQkJLy8gVG9rZW4gaXMgcGVybWFuZW50LgoJCX0gZWxzZSBpZiAoY29bImRlZmF1bHRfbGlmZXRpbWUiXSkgewoJCQlhdG9rZW5bImV4cGlyZXMiXSA9IG5vdyArIGNvWyJkZWZhdWx0X2xpZmV0aW1lIl07CgkJfSBlbHNlIGlmIChjb1sicGVybWFuZW50X3Njb3BlIl0pIHsKCQkJaWYgKCFhcGlfc3RvcmFnZS5oYXNTY29wZShhdG9rZW4sIGNvWyJwZXJtYW5lbnRfc2NvcGUiXSkpIHsKCQkJCWF0b2tlblsiZXhwaXJlcyJdID0gbm93ICsgZGVmYXVsdF9saWZldGltZTsKCQkJfQoJCX0gZWxzZSB7CgkJCWF0b2tlblsiZXhwaXJlcyJdID0gbm93ICsgZGVmYXVsdF9saWZldGltZTsKCQl9CgoJCS8qCgkJICogSGFuZGxlIHNjb3BlcyBmb3IgdGhpcyB0b2tlbgoJCSAqLwoJCWlmIChhdG9rZW5bInNjb3BlIl0pIHsKCQkJYXRva2VuWyJzY29wZXMiXSA9IGF0b2tlblsic2NvcGUiXS5zcGxpdCgiICIpOwoJCX0gZWxzZSBpZiAoc3RhdGVbInNjb3BlcyJdKSB7CgkJCWF0b2tlblsic2NvcGVzIl0gPSBzdGF0ZVsic2NvcGVzIl07CgkJfQoKCgoJCWFwaV9zdG9yYWdlLnNhdmVUb2tlbihzdGF0ZS5wcm92aWRlcklELCBhdG9rZW4pOwoKCQlpZiAoc3RhdGUucmVzdG9yZUhhc2gpIHsKCQkJd2luZG93LmxvY2F0aW9uLmhhc2ggPSBzdGF0ZS5yZXN0b3JlSGFzaDsKCQl9IGVsc2UgewoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9ICcnOwoJCX0KCgoJCWxvZyhhdG9rZW4pOwoKCQlpZiAoaW50ZXJuYWxTdGF0ZXNbYXRva2VuLnN0YXRlXSAmJiB0eXBlb2YgaW50ZXJuYWxTdGF0ZXNbYXRva2VuLnN0YXRlXSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkvLyBsb2coIkludGVybmFsU3RhdGUgaXMgc2V0LCBjYWxsaW5nIGl0IG5vdyEiKTsKCQkJaW50ZXJuYWxTdGF0ZXNbYXRva2VuLnN0YXRlXSgpOwoJCQlkZWxldGUgaW50ZXJuYWxTdGF0ZXNbYXRva2VuLnN0YXRlXTsKCQl9CgoKCQlpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CgkJCWNhbGxiYWNrKCk7CgkJfQoKCQkvLyBsb2coYXRva2VuKTsKCgl9CgoJLyoKCSAqIEEgY29uZmlnIG9iamVjdCBjb250YWluczoKCSAqLwoJdmFyIGpzb19hdXRocmVxdWVzdCA9IGZ1bmN0aW9uKHByb3ZpZGVyaWQsIHNjb3BlcywgY2FsbGJhY2spIHsKCgkJdmFyIAoJCQlzdGF0ZSwKCQkJcmVxdWVzdCwKCQkJYXV0aHVybCwKCQkJY287CgoJCWlmICghY29uZmlnW3Byb3ZpZGVyaWRdKSB0aHJvdyAiQ291bGQgbm90IGZpbmQgY29uZmlndXJhdGlvbiBmb3IgcHJvdmlkZXIgIiArIHByb3ZpZGVyaWQ7CgkJY28gPSBjb25maWdbcHJvdmlkZXJpZF07CgoJCWxvZygiQWJvdXQgdG8gc2VuZCBhbiBhdXRob3JpemF0aW9uIHJlcXVlc3QgdG8gWyIgKyBwcm92aWRlcmlkICsgIl0uIENvbmZpZzoiKQoJCWxvZyhjbyk7CgoJCXN0YXRlID0gdXVpZCgpOwoJCXJlcXVlc3QgPSB7CgkJCSJyZXNwb25zZV90eXBlIjogInRva2VuIgoJCX07CgkJcmVxdWVzdC5zdGF0ZSA9IHN0YXRlOwoKCQlpZiAoY2FsbGJhY2sgJiYgdHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CgkJCWludGVybmFsU3RhdGVzW3N0YXRlXSA9IGNhbGxiYWNrOwoJCX0KCgoJCWlmIChjb1sicmVkaXJlY3RfdXJpIl0pIHsKCQkJcmVxdWVzdFsicmVkaXJlY3RfdXJpIl0gPSBjb1sicmVkaXJlY3RfdXJpIl07CgkJfQoJCWlmIChjb1siY2xpZW50X2lkIl0pIHsKCQkJcmVxdWVzdFsiY2xpZW50X2lkIl0gPSBjb1siY2xpZW50X2lkIl07CgkJfQoJCWlmIChzY29wZXMpIHsKCQkJcmVxdWVzdFsic2NvcGUiXSA9IHNjb3Blcy5qb2luKCIgIik7CgkJfQoKCQlhdXRodXJsID0gZW5jb2RlVVJMKGNvLmF1dGhvcml6YXRpb24sIHJlcXVlc3QpOwoKCQkvLyBXZSdkIGxpa2UgdG8gY2FjaGUgdGhlIGhhc2ggZm9yIG5vdCBsb29zaW5nIEFwcGxpY2F0aW9uIHN0YXRlLiAKCQkvLyBXaXRoIHRoZSBpbXBsY2lpdCBncmFudCBmbG93LCB0aGUgaGFzaCB3aWxsIGJlIHJlcGxhY2VkIHdpdGggdGhlIGFjY2VzcwoJCS8vIHRva2VuIHdoZW4gd2UgcmV0dXJuIGFmdGVyIGF1dGhvcml6YXRpb24uCgkJaWYgKHdpbmRvdy5sb2NhdGlvbi5oYXNoKSB7CgkJCXJlcXVlc3RbInJlc3RvcmVIYXNoIl0gPSB3aW5kb3cubG9jYXRpb24uaGFzaDsKCQl9CgkJcmVxdWVzdFsicHJvdmlkZXJJRCJdID0gcHJvdmlkZXJpZDsKCQlpZiAoc2NvcGVzKSB7CgkJCXJlcXVlc3RbInNjb3BlcyJdID0gc2NvcGVzOwoJCX0KCgoJCWxvZygiU2F2aW5nIHN0YXRlIFsiICsgc3RhdGUrICJdIik7CgkJbG9nKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmVxdWVzdCkpKTsKCgkJYXBpX3N0b3JhZ2Uuc2F2ZVN0YXRlKHN0YXRlLCByZXF1ZXN0KTsKCQlhcGlfcmVkaXJlY3QoYXV0aHVybCk7CgoJfTsKCglleHAuanNvX2Vuc3VyZVRva2VucyA9IGZ1bmN0aW9uIChlbnN1cmUpIHsKCQl2YXIgcHJvdmlkZXJpZCwgc2NvcGVzLCB0b2tlbjsKCQlmb3IocHJvdmlkZXJpZCBpbiBlbnN1cmUpIHsKCQkJc2NvcGVzID0gdW5kZWZpbmVkOwoJCQlpZiAoZW5zdXJlW3Byb3ZpZGVyaWRdKSBzY29wZXMgPSBlbnN1cmVbcHJvdmlkZXJpZF07CgkJCXRva2VuID0gYXBpX3N0b3JhZ2UuZ2V0VG9rZW4ocHJvdmlkZXJpZCwgc2NvcGVzKTsKCgkJCWxvZygiRW5zdXJlIHRva2VuIGZvciBwcm92aWRlciBbIiArIHByb3ZpZGVyaWQgKyAiXSAiKTsKCQkJbG9nKHRva2VuKTsKCgkJCWlmICh0b2tlbiA9PT0gbnVsbCkgewoJCQkJanNvX2F1dGhyZXF1ZXN0KHByb3ZpZGVyaWQsIHNjb3Blcyk7CgkJCX0KCQl9CgoKCQlyZXR1cm4gdHJ1ZTsKCX0KCglleHAuanNvX2ZpbmREZWZhdWx0RW50cnkgPSBmdW5jdGlvbihjKSB7CgkJdmFyIAoJCQlrLAoJCQlpID0gMDsKCgkJaWYgKCFjKSByZXR1cm47CgkJbG9nKCJjIiwgYyk7CgkJZm9yKGsgaW4gYykgewoJCQlpKys7CgkJCWlmIChjW2tdLmlzRGVmYXVsdCAmJiBjW2tdLmlzRGVmYXVsdCA9PT0gdHJ1ZSkgewoJCQkJcmV0dXJuIGs7CgkJCX0KCQl9CgkJaWYgKGkgPT09IDEpIHJldHVybiBrOwoJfTsKCglleHAuanNvX2NvbmZpZ3VyZSA9IGZ1bmN0aW9uKGMsIG9wdHMpIHsKCQljb25maWcgPSBjOwoJCXNldE9wdGlvbnMob3B0cyk7CgkJdHJ5IHsKCgkJCXZhciBkZWYgPSBleHAuanNvX2ZpbmREZWZhdWx0RW50cnkoYyk7CgkJCWxvZygianNvX2NvbmZpZ3VyZSgpIGFib3V0IHRvIGNoZWNrIGZvciB0b2tlbiBmb3IgdGhpcyBlbnRyeSIsIGRlZik7CgkJCWV4cC5qc29fY2hlY2tmb3J0b2tlbihkZWYpOwkKCgkJfSBjYXRjaChlKSB7CgkJCWxvZygiRXJyb3Igd2hlbiByZXRyaWV2aW5nIHRva2VuIGZyb20gaGFzaDogIiArIGUpOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9ICIiOwoJCX0KCQkKCX0KCglleHAuanNvX2R1bXAgPSBmdW5jdGlvbigpIHsKCQl2YXIga2V5OwoJCWZvcihrZXkgaW4gY29uZmlnKSB7CgoJCQlsb2coIj09PT09PiBQcm9jZXNzaW5nIHByb3ZpZGVyIFsiICsga2V5ICsgIl0iKTsKCQkJbG9nKCI9XSBDb25maWciKTsKCQkJbG9nKGNvbmZpZ1trZXldKTsKCQkJbG9nKCI9XSBUb2tlbnMiKQoJCQlsb2coYXBpX3N0b3JhZ2UuZ2V0VG9rZW5zKGtleSkpOwoKCQl9Cgl9CgoJZXhwLmpzb193aXBlID0gZnVuY3Rpb24oKSB7CgkJdmFyIGtleTsKCQlsb2coImpzb193aXBlKCkiKTsKCQlmb3Ioa2V5IGluIGNvbmZpZykgewoJCQlsb2coIldpcHBpbmcgdG9rZW5zIGZvciAiICsga2V5KTsKCQkJYXBpX3N0b3JhZ2Uud2lwZVRva2VucyhrZXkpOwoJCX0KCX0KCglleHAuanNvX2dldFRva2VuID0gZnVuY3Rpb24ocHJvdmlkZXJpZCwgc2NvcGVzKSB7CgkJdmFyIHRva2VuID0gYXBpX3N0b3JhZ2UuZ2V0VG9rZW4ocHJvdmlkZXJpZCwgc2NvcGVzKTsKCQlpZiAoIXRva2VuKSByZXR1cm4gbnVsbDsKCQlpZiAoIXRva2VuWyJhY2Nlc3NfdG9rZW4iXSkgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRva2VuWyJhY2Nlc3NfdG9rZW4iXTsKCX0KCgoKCWV4cC5qc29fcmVnaXN0ZXJSZWRpcmVjdEhhbmRsZXIgPSBmdW5jdGlvbihjYWxsYmFjaykgewoJCWFwaV9yZWRpcmVjdCA9IGNhbGxiYWNrOwoJfTsKCglleHAuanNvX3JlZ2lzdGVyU3RvcmFnZUhhbmRsZXIgPSBmdW5jdGlvbihvYmplY3QpIHsKCQlhcGlfc3RvcmFnZSA9IG9iamVjdDsKCX07CgoKCS8qCgkgKiBGcm9tIG5vdyBvbiwgd2Ugb25seSBwZXJmb3JtIHRhc2tzIHRoYXQgcmVxdWlyZSBqUXVlcnkuCgkgKiBMaWtlIGFkZGluZyB0aGUgJC5vYWpheCBmdW5jdGlvbi4KCSAqLwoJaWYgKHR5cGVvZiAkID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoKCSQub2FqYXggPSBmdW5jdGlvbihzZXR0aW5ncykgewoJCXZhciAKCQkJYWxsb3dpYSwKCQkJc2NvcGVzLAoJCQl0b2tlbiwKCQkJcHJvdmlkZXJpZCwKCQkJY287CgkJCgkJcHJvdmlkZXJpZCA9IHNldHRpbmdzLmpzb19wcm92aWRlcjsKCQlhbGxvd2lhID0gc2V0dGluZ3MuanNvX2FsbG93aWEgfHwgZmFsc2U7CgkJc2NvcGVzID0gc2V0dGluZ3MuanNvX3Njb3BlczsKCQl0b2tlbiA9IGFwaV9zdG9yYWdlLmdldFRva2VuKHByb3ZpZGVyaWQsIHNjb3Blcyk7CgkJY28gPSBjb25maWdbcHJvdmlkZXJpZF07CgoJCS8vIHZhciBzdWNjZXNzT3ZlcnJpZGRlbiA9IHNldHRpbmdzLnN1Y2Nlc3M7CgkJLy8gc2V0dGluZ3Muc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CgkJLy8gfQoKCQl2YXIgZXJyb3JPdmVycmlkZGVuID0gc2V0dGluZ3MuZXJyb3IgfHwgbnVsbDsKCgkJdmFyIHBlcmZvcm1BamF4ID0gZnVuY3Rpb24oKSB7CgkJCS8vIGxvZygiUGVyZm9ybSBhamF4ISIpOwoKCQkJaWYgKCF0b2tlbikgdGhyb3cgIkNvdWxkIG5vdCBwZXJmb3JtIEFKQVggY2FsbCBiZWNhdXNlIG5vIHZhbGlkIHRva2VucyB3YXMgZm91bmQuIjsJCgoJCQlpZiAoY29bInByZXNlbnR0b2tlbiJdICYmIGNvWyJwcmVzZW50dG9rZW4iXSA9PT0gInFzIikgewoJCQkJLy8gc2V0dGluZ3MudXJsICs9ICgoaC5pbmRleE9mKCI/IikgPT09IC0xKSA/ICc/JyA6ICcmJykgKyAiYWNjZXNzX3Rva2VuPSIgKyBlbmNvZGVVUklDb21wb25lbnQodG9rZW5bImFjY2Vzc190b2tlbiJdKTsKCQkJCWlmICghc2V0dGluZ3MuZGF0YSkgc2V0dGluZ3MuZGF0YSA9IHt9OwoJCQkJc2V0dGluZ3MuZGF0YVsiYWNjZXNzX3Rva2VuIl0gPSB0b2tlblsiYWNjZXNzX3Rva2VuIl07CgkJCX0gZWxzZSB7CgkJCQlpZiAoIXNldHRpbmdzLmhlYWRlcnMpIHNldHRpbmdzLmhlYWRlcnMgPSB7fTsKCQkJCXNldHRpbmdzLmhlYWRlcnNbIkF1dGhvcml6YXRpb24iXSA9ICJCZWFyZXIgIiArIHRva2VuWyJhY2Nlc3NfdG9rZW4iXTsKCQkJfQoJCQlyZXR1cm4gJC5hamF4KHNldHRpbmdzKTsKCQl9OwoKCQlzZXR0aW5ncy5lcnJvciA9IGZ1bmN0aW9uKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bikgewoJCQlsb2coJ2Vycm9yKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93biknKTsKCQkJbG9nKGpxWEhSKTsKCQkJbG9nKHRleHRTdGF0dXMpOwoJCQlsb2coZXJyb3JUaHJvd24pOwoKCQkJaWYgKGpxWEhSLnN0YXR1cyA9PT0gNDAxKSB7CgoJCQkJbG9nKCJUb2tlbiBleHBpcmVkLiBBYm91dCB0byBkZWxldGUgdGhpcyB0b2tlbiIpOwoJCQkJbG9nKHRva2VuKTsKCQkJCWFwaV9zdG9yYWdlLndpcGVUb2tlbnMocHJvdmlkZXJpZCk7CgoJCQl9CgkJCWlmIChlcnJvck92ZXJyaWRkZW4gJiYgdHlwZW9mIGVycm9yT3ZlcnJpZGRlbiA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJZXJyb3JPdmVycmlkZGVuKGpxWEhSLCB0ZXh0U3RhdHVzLCBlcnJvclRocm93bik7CgkJCX0KCQl9CgoKCQlpZiAoIXRva2VuKSB7CgkJCWlmIChhbGxvd2lhKSB7CgkJCQlsb2coIlBlcmZvcm0gYXV0aHJlcXVlc3QiKTsKCQkJCWpzb19hdXRocmVxdWVzdChwcm92aWRlcmlkLCBzY29wZXMsIGZ1bmN0aW9uKCkgewoJCQkJCXRva2VuID0gYXBpX3N0b3JhZ2UuZ2V0VG9rZW4ocHJvdmlkZXJpZCwgc2NvcGVzKTsKCQkJCQlwZXJmb3JtQWpheCgpOwoJCQkJfSk7CgkJCQlyZXR1cm47CgkJCX0gZWxzZSB7CgkJCQl0aHJvdyAiQ291bGQgbm90IHBlcmZvcm0gQUpBWCBjYWxsIGJlY2F1c2Ugbm8gdmFsaWQgdG9rZW5zIHdhcyBmb3VuZC4iOwkKCQkJfQoJCX0KCgoJCXJldHVybiBwZXJmb3JtQWpheCgpOwoJfTsKCgp9KSh3aW5kb3csIHdpbmRvdy5qUXVlcnkpOwo=",
                "body": "KGZ1bmN0aW9uKGV4cCwgJCkgewoKCXZhciAKCQljb25maWcgPSB7fSwKCQlkZWZhdWx0X2xpZmV0aW1lID0gMzYwMCwKCQlvcHRpb25zID0gewoJCQkiZGVidWciOiBmYWxzZQoJCX0sCgoJCWFwaV9yZWRpcmVjdCwKCQlBcGlfZGVmYXVsdF9zdG9yYWdlLAoJCWFwaV9zdG9yYWdlLAoKCQlpbnRlcm5hbFN0YXRlcyA9IFtdOwoKCS8qCgkgKiAtLS0tLS0gU0VDVElPTjogVXRpbGl0aWVzCgkgKi8KCgkvKgoJICogUmV0dXJucyBhIHJhbmRvbSBzdHJpbmcgdXNlZCBmb3Igc3RhdGUKCSAqLwoJdmFyIHV1aWQgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJ3h4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3h5XS9nLCBmdW5jdGlvbihjKSB7CgkJCXZhciByID0gTWF0aC5yYW5kb20oKSoxNnwwLCB2ID0gYyA9PSAneCcgPyByIDogKHImMHgzfDB4OCk7CgkJCXJldHVybiB2LnRvU3RyaW5nKDE2KTsKCQl9KTsKCX0KCgkvKioKCSAqIEEgbG9nIHdyYXBwZXIsIHRoYXQgb25seSBsb2dzIGlmIGxvZ2dpbmcgaXMgdHVybmVkIG9uIGluIHRoZSBjb25maWcKCSAqIEBwYXJhbSAge3N0cmluZ30gbXNnIExvZyBtZXNzYWdlCgkgKi8KCXZhciBsb2cgPSBmdW5jdGlvbihtc2cpIHsKCQlpZiAoIW9wdGlvbnMuZGVidWcpIHJldHVybjsKCQlpZiAoIWNvbnNvbGUpIHJldHVybjsKCQlpZiAoIWNvbnNvbGUubG9nKSByZXR1cm47CgoJCS8vIGNvbnNvbGUubG9nKCJMT0coKSwgQXJndW1lbnRzIiwgYXJndW1lbnRzLCBtc2cpCgkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CgkJCWNvbnNvbGUubG9nKGFyZ3VtZW50cyk7CQoJCX0gZWxzZSB7CgkJCWNvbnNvbGUubG9nKG1zZyk7CgkJfQoJCQoJfQoKCS8qKgoJICogU2V0IHRoZSBnbG9iYWwgb3B0aW9ucy4KCSAqLwoJdmFyIHNldE9wdGlvbnMgPSBmdW5jdGlvbihvcHRzKSB7CgkJaWYgKCFvcHRzKSByZXR1cm47CgkJZm9yKHZhciBrIGluIG9wdHMpIHsKCQkJaWYgKG9wdHMuaGFzT3duUHJvcGVydHkoaykpIHsKCQkJCW9wdGlvbnNba10gPSBvcHRzW2tdOwoJCQl9CgkJfQoJCWxvZygiT3B0aW9ucyBpcyBzZXQgdG8gIiwgb3B0aW9ucyk7Cgl9CgoKCS8qIAoJICogVGFrZXMgYW4gVVJMIGFzIGlucHV0IGFuZCBhIHBhcmFtcyBvYmplY3QuCgkgKiBFYWNoIHByb3BlcnR5IGluIHRoZSBwYXJhbXMgaXMgYWRkZWQgdG8gdGhlIHVybCBhcyBxdWVyeSBzdHJpbmcgcGFyYW1ldGVycwoJICovCgl2YXIgZW5jb2RlVVJMID0gZnVuY3Rpb24odXJsLCBwYXJhbXMpIHsKCQl2YXIgcmVzID0gdXJsOwoJCXZhciBrLCBpID0gMDsKCQl2YXIgZmlyc3RTZXBhcmF0b3IgPSAodXJsLmluZGV4T2YoIj8iKSA9PT0gLTEpID8gJz8nIDogJyYnOwoJCWZvcihrIGluIHBhcmFtcykgewoJCQlyZXMgKz0gKGkrKyA9PT0gMCA/IGZpcnN0U2VwYXJhdG9yIDogJyYnKSArIGVuY29kZVVSSUNvbXBvbmVudChrKSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudChwYXJhbXNba10pOwoJCX0KCQlyZXR1cm4gcmVzOwoJfQoJCgoJLyoKCSAqIFJldHVybnMgZXBvY2gsIHNlY29uZHMgc2luY2UgMTk3MC4KCSAqIFVzZWQgZm9yIGNhbGN1bGF0aW9uIG9mIGV4cGlyZSB0aW1lcy4KCSAqLwoJdmFyIGVwb2NoID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuIE1hdGgucm91bmQobmV3IERhdGUoKS5nZXRUaW1lKCkvMTAwMC4wKTsKCX0KCgoKCXZhciBwYXJzZVF1ZXJ5U3RyaW5nID0gZnVuY3Rpb24gKHFzKSB7CgkJdmFyIGUsCgkJCWEgPSAvXCsvZywgIC8vIFJlZ2V4IGZvciByZXBsYWNpbmcgYWRkaXRpb24gc3ltYm9sIHdpdGggYSBzcGFjZQoJCQlyID0gLyhbXiY7PV0rKT0/KFteJjtdKikvZywKCQkJZCA9IGZ1bmN0aW9uIChzKSB7IHJldHVybiBkZWNvZGVVUklDb21wb25lbnQocy5yZXBsYWNlKGEsICIgIikpOyB9LAoJCQlxID0gcXMsCgkJCXVybFBhcmFtcyA9IHt9OwoKCQl3aGlsZSAoZSA9IHIuZXhlYyhxKSkKCQkgICB1cmxQYXJhbXNbZChlWzFdKV0gPSBkKGVbMl0pOwoKCQlyZXR1cm4gdXJsUGFyYW1zOwoJfQoJLyoKCSAqIC0tLS0tLSAvIFNFQ1RJT046IFV0aWxpdGllcwoJICovCgoKCgoKCgkvKiAKCSAqIFJlZGlyZWN0cyB0aGUgdXNlciB0byBhIHNwZWNpZmljIFVSTAoJICovCglhcGlfcmVkaXJlY3QgPSBmdW5jdGlvbih1cmwpIHsKCQl3aW5kb3cubG9jYXRpb24gPSB1cmw7Cgl9OwoKCUFwaV9kZWZhdWx0X3N0b3JhZ2UgPSBmdW5jdGlvbigpIHsKCQlsb2coIkNvbnN0cnVjdG9yIik7Cgl9OwoKCS8qKgoJCXNhdmVTdGF0ZSBzdG9yZXMgYW4gb2JqZWN0IHdpdGggYW4gSWRlbnRpZmllci4KCQlUT0RPOiBFbnN1cmUgdGhhdCBib3RoIGxvY2Fsc3RvcmFnZSBhbmQgSlNPTiBlbmNvZGluZyBoYXMgZmFsbGJhY2tzIGZvciBhbmNpZW50IGJyb3dzZXJzLgoJCUluIHRoZSBzdGF0ZSBvYmplY3QsIHdlIHB1dCB0aGUgcmVxdWVzdCBvYmplY3QsIHBsdXMgdGhlc2UgcGFyYW1ldGVyczoKCQkgICogcmVzdG9yZUhhc2gKCQkgICogcHJvdmlkZXJJRAoJCSAgKiBzY29wZXMKCgkgKi8KCUFwaV9kZWZhdWx0X3N0b3JhZ2UucHJvdG90eXBlLnNhdmVTdGF0ZSA9ICBmdW5jdGlvbiAoc3RhdGUsIG9iaikgewoJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKCJzdGF0ZS0iICsgc3RhdGUsIEpTT04uc3RyaW5naWZ5KG9iaikpOwoJfQoKCgkvKioKCSAqIGdldFN0YWdlKCkgIHJldHVybnMgdGhlIHN0YXRlIG9iamVjdCwgYnV0IGFsc28gcmVtb3ZlcyBpdC4KCSAqIEB0eXBlIHtPYmplY3R9CgkgKi8KCUFwaV9kZWZhdWx0X3N0b3JhZ2UucHJvdG90eXBlLmdldFN0YXRlID0gZnVuY3Rpb24oc3RhdGUpIHsKCQkvLyBsb2coImdldFN0YXRlICgiICsgc3RhdGUrICIpIik7CgkJdmFyIG9iaiA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oInN0YXRlLSIgKyBzdGF0ZSkpOwoJCWxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJzdGF0ZS0iICsgc3RhdGUpCgkJcmV0dXJuIG9iajsKCX07CgoKCS8qCgkgKiBDaGVja3MgaWYgYSB0b2tlbiwgaGFzIGluY2x1ZGVzIGEgc3BlY2lmaWMgc2NvcGUuCgkgKiBJZiB0b2tlbiBoYXMgbm8gc2NvcGUgYXQgYWxsLCBmYWxzZSBpcyByZXR1cm5lZC4KCSAqLwoJQXBpX2RlZmF1bHRfc3RvcmFnZS5wcm90b3R5cGUuaGFzU2NvcGUgPSBmdW5jdGlvbih0b2tlbiwgc2NvcGUpIHsKCQl2YXIgaTsKCQlpZiAoIXRva2VuLnNjb3BlcykgcmV0dXJuIGZhbHNlOwoJCWZvcihpID0gMDsgaSA8IHRva2VuLnNjb3Blcy5sZW5ndGg7IGkrKykgewoJCQlpZiAodG9rZW4uc2NvcGVzW2ldID09PSBzY29wZSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX07CgoJLyoKCSAqIFRha2VzIGFuIGFycmF5IG9mIHRva2VucywgYW5kIHJlbW92ZXMgdGhlIG9uZXMgdGhhdAoJICogYXJlIGV4cGlyZWQsIGFuZCB0aGUgb25lcyB0aGF0IGRvIG5vdCBtZWV0IGEgc2NvcGVzIHJlcXVpcmVtZW50LgoJICovCglBcGlfZGVmYXVsdF9zdG9yYWdlLnByb3RvdHlwZS5maWx0ZXJUb2tlbnMgPSBmdW5jdGlvbih0b2tlbnMsIHNjb3BlcykgewoJCXZhciBpLCBqLCAKCQkJcmVzdWx0ID0gW10sCgkJCW5vdyA9IGVwb2NoKCksCgkJCXVzZXRoaXM7CgoJCWlmICghc2NvcGVzKSBzY29wZXMgPSBbXTsKCgkJZm9yKGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7CgkJCXVzZXRoaXMgPSB0cnVlOwoKCQkJLy8gRmlsdGVyIG91dCBleHBpcmVkIHRva2Vucy4gVG9rZW5zIHRoYXQgaXMgZXhwaXJlZCBpbiAxIHNlY29uZCBmcm9tIG5vdy4KCQkJaWYgKHRva2Vuc1tpXS5leHBpcmVzICYmIHRva2Vuc1tpXS5leHBpcmVzIDwgKG5vdysxKSkgdXNldGhpcyA9IGZhbHNlOwoKCQkJLy8gRmlsdGVyIG91dCB0aGlzIHRva2VuIGlmIG5vdCBhbGwgc2NvcGUgcmVxdWlyZW1lbnRzIGFyZSBtZXQKCQkJZm9yKGogPSAwOyBqIDwgc2NvcGVzLmxlbmd0aDsgaisrKSB7CgkJCQlpZiAoIWFwaV9zdG9yYWdlLmhhc1Njb3BlKHRva2Vuc1tpXSwgc2NvcGVzW2pdKSkgdXNldGhpcyA9IGZhbHNlOwoJCQl9CgoJCQlpZiAodXNldGhpcykgcmVzdWx0LnB1c2godG9rZW5zW2ldKTsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoKCS8qCgkgKiBzYXZlVG9rZW5zKCkgc3RvcmVzIGEgbGlzdCBvZiB0b2tlbnMgZm9yIGEgcHJvdmlkZXIuCgoJCVVzdWFsbHkgdGhlIHRva2VucyBzdG9yZWQgYXJlIGEgcGxhaW4gQWNjZXNzIHRva2VuIHBsdXM6CgkJICAqIGV4cGlyZXMgOiB0aW1lIHRoYXQgdGhlIHRva2VuIGV4cGlyZXMKCQkgICogcHJvdmlkZXJJRDogdGhlIHByb3ZpZGVyIG9mIHRoZSBhY2Nlc3MgdG9rZW4/CgkJICAqIHNjb3BlczogYW4gYXJyYXkgd2l0aCB0aGUgc2NvcGVzIChub3Qgc3RyaW5nKQoJICovCglBcGlfZGVmYXVsdF9zdG9yYWdlLnByb3RvdHlwZS5zYXZlVG9rZW5zID0gZnVuY3Rpb24ocHJvdmlkZXIsIHRva2VucykgewoJCS8vIGxvZygiU2F2ZSBUb2tlbnMgKCIgKyBwcm92aWRlcisgIikiKTsKCQlsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgidG9rZW5zLSIgKyBwcm92aWRlciwgSlNPTi5zdHJpbmdpZnkodG9rZW5zKSk7Cgl9OwoKCUFwaV9kZWZhdWx0X3N0b3JhZ2UucHJvdG90eXBlLmdldFRva2VucyA9IGZ1bmN0aW9uKHByb3ZpZGVyKSB7CgkJLy8gbG9nKCJHZXQgVG9rZW5zICgiICsgcHJvdmlkZXIrICIpIik7CgkJdmFyIHRva2VucyA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oInRva2Vucy0iICsgcHJvdmlkZXIpKTsKCQlpZiAoIXRva2VucykgdG9rZW5zID0gW107CgoJCWxvZygiVG9rZW4gcmVjZWl2ZWQiLCB0b2tlbnMpCgkJcmV0dXJuIHRva2VuczsKCX07CglBcGlfZGVmYXVsdF9zdG9yYWdlLnByb3RvdHlwZS53aXBlVG9rZW5zID0gZnVuY3Rpb24ocHJvdmlkZXIpIHsKCQlsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgidG9rZW5zLSIgKyBwcm92aWRlcik7Cgl9OwoJLyoKCSAqIFNhdmUgYSBzaW5nbGUgdG9rZW4gZm9yIGEgcHJvdmlkZXIuCgkgKiBUaGlzIGFsc28gY2xlYW5zIHVwIGV4cGlyZWQgdG9rZW5zIGZvciB0aGUgc2FtZSBwcm92aWRlci4KCSAqLwoJQXBpX2RlZmF1bHRfc3RvcmFnZS5wcm90b3R5cGUuc2F2ZVRva2VuID0gZnVuY3Rpb24ocHJvdmlkZXIsIHRva2VuKSB7CgkJdmFyIHRva2VucyA9IHRoaXMuZ2V0VG9rZW5zKHByb3ZpZGVyKTsKCQl0b2tlbnMgPSBhcGlfc3RvcmFnZS5maWx0ZXJUb2tlbnModG9rZW5zKTsKCQl0b2tlbnMucHVzaCh0b2tlbik7CgkJdGhpcy5zYXZlVG9rZW5zKHByb3ZpZGVyLCB0b2tlbnMpOwoJfTsKCgkvKgoJICogR2V0IGEgdG9rZW4gaWYgZXhpc3RzIGZvciBhIHByb3ZpZGVyIHdpdGggYSBzZXQgb2Ygc2NvcGVzLgoJICogVGhlIHNjb3BlcyBwYXJhbWV0ZXIgaXMgT1BUSU9OQUwuCgkgKi8KCUFwaV9kZWZhdWx0X3N0b3JhZ2UucHJvdG90eXBlLmdldFRva2VuID0gZnVuY3Rpb24ocHJvdmlkZXIsIHNjb3BlcykgewoJCXZhciB0b2tlbnMgPSB0aGlzLmdldFRva2Vucyhwcm92aWRlcik7CgkJdG9rZW5zID0gYXBpX3N0b3JhZ2UuZmlsdGVyVG9rZW5zKHRva2Vucywgc2NvcGVzKTsKCQlpZiAodG9rZW5zLmxlbmd0aCA8IDEpIHJldHVybiBudWxsOwoJCXJldHVybiB0b2tlbnNbMF07Cgl9OwoKCWFwaV9zdG9yYWdlID0gbmV3IEFwaV9kZWZhdWx0X3N0b3JhZ2UoKTsKCgoKCgoKCgoKCgkvKioKCSAqIENoZWNrIGlmIHRoZSBoYXNoIGNvbnRhaW5zIGFuIGFjY2VzcyB0b2tlbi4gCgkgKiBBbmQgaWYgaXQgZG8sIGV4dHJhY3QgdGhlIHN0YXRlLCBjb21wYXJlIHdpdGgKCSAqIGNvbmZpZywgYW5kIHN0b3JlIHRoZSBhY2Nlc3MgdG9rZW4gZm9yIGxhdGVyIHVzZS4KCSAqCgkgKiBUaGUgdXJsIHBhcmFtZXRlciBpcyBvcHRpb25hbC4gVXNlZCB3aXRoIHBob25lZ2FwIGFuZAoJICogY2hpbGRicm93c2VyIHdoZW4gdGhlIGpzbyBjb250ZXh0IGlzIG5vdCByZWNlaXZpbmcgdGhlIHJlc3BvbnNlLAoJICogaW5zdGVhZCB0aGUgcmVzcG9uc2UgaXMgcmVjZWl2ZWQgb24gYSBjaGlsZCBicm93c2VyLgoJICovCglleHAuanNvX2NoZWNrZm9ydG9rZW4gPSBmdW5jdGlvbihwcm92aWRlcklELCB1cmwsIGNhbGxiYWNrKSB7CgkJdmFyIAoJCQlhdG9rZW4sCgkJCWggPSB3aW5kb3cubG9jYXRpb24uaGFzaCwKCQkJbm93ID0gZXBvY2goKSwKCQkJc3RhdGUsCgkJCWNvOwoKCQlsb2coImpzb19jaGVja2ZvcnRva2VuKCIgKyBwcm92aWRlcklEICsgIikiKTsKCgkJLy8gSWYgYSB1cmwgaXMgcHJvdmlkZWQgCgkJaWYgKHVybCkgewoJCQkvLyBsb2coJ0hhaCwgSSBnb3QgdGhlIHVybCBhbmQgaXQgJyArIHVybCk7CgkJCWlmKHVybC5pbmRleE9mKCcjJykgPT09IC0xKSByZXR1cm47CgkJCWggPSB1cmwuc3Vic3RyaW5nKHVybC5pbmRleE9mKCcjJykpOwoJCQkvLyBsb2coJ0hhaCwgSSBnb3QgdGhlIGhhc2ggYW5kIGl0IGlzICcgKyAgaCk7CgkJfQoKCQkvKgoJCSAqIFN0YXJ0IHdpdGggY2hlY2tpbmcgaWYgdGhlcmUgaXMgYSB0b2tlbiBpbiB0aGUgaGFzaAoJCSAqLwoJCWlmIChoLmxlbmd0aCA8IDIpIHJldHVybjsKCQlpZiAoaC5pbmRleE9mKCJhY2Nlc3NfdG9rZW4iKSA9PT0gLTEpIHJldHVybjsKCQloID0gaC5zdWJzdHJpbmcoMSk7CgkJYXRva2VuID0gcGFyc2VRdWVyeVN0cmluZyhoKTsKCgkJaWYgKGF0b2tlbi5zdGF0ZSkgewoJCQlzdGF0ZSA9IGFwaV9zdG9yYWdlLmdldFN0YXRlKGF0b2tlbi5zdGF0ZSk7CgkJfSBlbHNlIHsKCQkJaWYgKCFwcm92aWRlcklEKSB7dGhyb3cgIkNvdWxkIG5vdCBnZXQgW3N0YXRlXSBhbmQgbm8gZGVmYXVsdCBwcm92aWRlcmlkIGlzIHByb3ZpZGVkLiI7fQoJCQlzdGF0ZSA9IHtwcm92aWRlcklEOiBwcm92aWRlcklEfTsKCQl9CgoJCQoJCWlmICghc3RhdGUpIHRocm93ICJDb3VsZCBub3QgcmV0cmlldmUgc3RhdGUiOwoJCWlmICghc3RhdGUucHJvdmlkZXJJRCkgdGhyb3cgIkNvdWxkIG5vdCBnZXQgcHJvdmlkZXJpZCBmcm9tIHN0YXRlIjsKCQlpZiAoIWNvbmZpZ1tzdGF0ZS5wcm92aWRlcklEXSkgdGhyb3cgIkNvdWxkIG5vdCByZXRyaWV2ZSBjb25maWcgZm9yIHRoaXMgcHJvdmlkZXIuIjsKCQljbyA9IGNvbmZpZ1tzdGF0ZS5wcm92aWRlcklEXTsKCgkJLyoqCgkJICogSWYgc3RhdGUgd2FzIG5vdCBwcm92aWRlZCwgYW5kIGRlZmF1bHQgcHJvdmlkZXIgY29udGFpbnMgYSBzY29wZSBwYXJhbWV0ZXIKCQkgKiB3ZSBhc3N1bWUgdGhpcyBpcyB0aGUgb25lIHJlcXVlc3RlZC4uLgoJCSAqLwoJCWlmICghYXRva2VuLnN0YXRlICYmIGNvLnNjb3BlKSB7CgkJCXN0YXRlLnNjb3BlcyA9IGNvLnNjb3BlOwoJCQlsb2coIlNldHRpbmcgc3RhdGU6ICIsIHN0YXRlKTsKCQl9CgkJbG9nKCJDaGVja2luZyBhdG9rZW4gIiwgYXRva2VuLCAiIGFuZCBjbyAiLCBjbyk7CgoJCS8qCgkJICogRGVjaWRlIHdoZW4gdGhpcyB0b2tlbiBzaG91bGQgZXhwaXJlLgoJCSAqIFByaW9yaXR5IGZhbGxiYWNrOgoJCSAqIDEuIEFjY2VzcyB0b2tlbiBleHBpcmVzX2luCgkJICogMi4gTGlmZSB0aW1lIGluIGNvbmZpZyAobWF5IGJlIGZhbHNlID0gcGVybWFuZW50Li4uKQoJCSAqIDMuIFNwZWNpZmljIHBlcm1hbmVudCBzY29wZS4KCQkgKiA0LiBEZWZhdWx0IGxpYnJhcnkgbGlmZXRpbWU6CgkJICovCgkJaWYgKGF0b2tlblsiZXhwaXJlc19pbiJdKSB7CgkJCWF0b2tlblsiZXhwaXJlcyJdID0gbm93ICsgcGFyc2VJbnQoYXRva2VuWyJleHBpcmVzX2luIl0sIDEwKTsKCQl9IGVsc2UgaWYgKGNvWyJkZWZhdWx0X2xpZmV0aW1lIl0gPT09IGZhbHNlKSB7CgkJCS8vIFRva2VuIGlzIHBlcm1hbmVudC4KCQl9IGVsc2UgaWYgKGNvWyJkZWZhdWx0X2xpZmV0aW1lIl0pIHsKCQkJYXRva2VuWyJleHBpcmVzIl0gPSBub3cgKyBjb1siZGVmYXVsdF9saWZldGltZSJdOwoJCX0gZWxzZSBpZiAoY29bInBlcm1hbmVudF9zY29wZSJdKSB7CgkJCWlmICghYXBpX3N0b3JhZ2UuaGFzU2NvcGUoYXRva2VuLCBjb1sicGVybWFuZW50X3Njb3BlIl0pKSB7CgkJCQlhdG9rZW5bImV4cGlyZXMiXSA9IG5vdyArIGRlZmF1bHRfbGlmZXRpbWU7CgkJCX0KCQl9IGVsc2UgewoJCQlhdG9rZW5bImV4cGlyZXMiXSA9IG5vdyArIGRlZmF1bHRfbGlmZXRpbWU7CgkJfQoKCQkvKgoJCSAqIEhhbmRsZSBzY29wZXMgZm9yIHRoaXMgdG9rZW4KCQkgKi8KCQlpZiAoYXRva2VuWyJzY29wZSJdKSB7CgkJCWF0b2tlblsic2NvcGVzIl0gPSBhdG9rZW5bInNjb3BlIl0uc3BsaXQoIiAiKTsKCQl9IGVsc2UgaWYgKHN0YXRlWyJzY29wZXMiXSkgewoJCQlhdG9rZW5bInNjb3BlcyJdID0gc3RhdGVbInNjb3BlcyJdOwoJCX0KCgoKCQlhcGlfc3RvcmFnZS5zYXZlVG9rZW4oc3RhdGUucHJvdmlkZXJJRCwgYXRva2VuKTsKCgkJaWYgKHN0YXRlLnJlc3RvcmVIYXNoKSB7CgkJCXdpbmRvdy5sb2NhdGlvbi5oYXNoID0gc3RhdGUucmVzdG9yZUhhc2g7CgkJfSBlbHNlIHsKCQkJd2luZG93LmxvY2F0aW9uLmhhc2ggPSAnJzsKCQl9CgoKCQlsb2coYXRva2VuKTsKCgkJaWYgKGludGVybmFsU3RhdGVzW2F0b2tlbi5zdGF0ZV0gJiYgdHlwZW9mIGludGVybmFsU3RhdGVzW2F0b2tlbi5zdGF0ZV0gPT09ICdmdW5jdGlvbicpIHsKCQkJLy8gbG9nKCJJbnRlcm5hbFN0YXRlIGlzIHNldCwgY2FsbGluZyBpdCBub3chIik7CgkJCWludGVybmFsU3RhdGVzW2F0b2tlbi5zdGF0ZV0oKTsKCQkJZGVsZXRlIGludGVybmFsU3RhdGVzW2F0b2tlbi5zdGF0ZV07CgkJfQoKCgkJaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgewoJCQljYWxsYmFjaygpOwoJCX0KCgkJLy8gbG9nKGF0b2tlbik7CgoJfQoKCS8qCgkgKiBBIGNvbmZpZyBvYmplY3QgY29udGFpbnM6CgkgKi8KCXZhciBqc29fYXV0aHJlcXVlc3QgPSBmdW5jdGlvbihwcm92aWRlcmlkLCBzY29wZXMsIGNhbGxiYWNrKSB7CgoJCXZhciAKCQkJc3RhdGUsCgkJCXJlcXVlc3QsCgkJCWF1dGh1cmwsCgkJCWNvOwoKCQlpZiAoIWNvbmZpZ1twcm92aWRlcmlkXSkgdGhyb3cgIkNvdWxkIG5vdCBmaW5kIGNvbmZpZ3VyYXRpb24gZm9yIHByb3ZpZGVyICIgKyBwcm92aWRlcmlkOwoJCWNvID0gY29uZmlnW3Byb3ZpZGVyaWRdOwoKCQlsb2coIkFib3V0IHRvIHNlbmQgYW4gYXV0aG9yaXphdGlvbiByZXF1ZXN0IHRvIFsiICsgcHJvdmlkZXJpZCArICJdLiBDb25maWc6IikKCQlsb2coY28pOwoKCQlzdGF0ZSA9IHV1aWQoKTsKCQlyZXF1ZXN0ID0gewoJCQkicmVzcG9uc2VfdHlwZSI6ICJ0b2tlbiIKCQl9OwoJCXJlcXVlc3Quc3RhdGUgPSBzdGF0ZTsKCgkJaWYgKGNhbGxiYWNrICYmIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgewoJCQlpbnRlcm5hbFN0YXRlc1tzdGF0ZV0gPSBjYWxsYmFjazsKCQl9CgoKCQlpZiAoY29bInJlZGlyZWN0X3VyaSJdKSB7CgkJCXJlcXVlc3RbInJlZGlyZWN0X3VyaSJdID0gY29bInJlZGlyZWN0X3VyaSJdOwoJCX0KCQlpZiAoY29bImNsaWVudF9pZCJdKSB7CgkJCXJlcXVlc3RbImNsaWVudF9pZCJdID0gY29bImNsaWVudF9pZCJdOwoJCX0KCQlpZiAoc2NvcGVzKSB7CgkJCXJlcXVlc3RbInNjb3BlIl0gPSBzY29wZXMuam9pbigiICIpOwoJCX0KCgkJYXV0aHVybCA9IGVuY29kZVVSTChjby5hdXRob3JpemF0aW9uLCByZXF1ZXN0KTsKCgkJLy8gV2UnZCBsaWtlIHRvIGNhY2hlIHRoZSBoYXNoIGZvciBub3QgbG9vc2luZyBBcHBsaWNhdGlvbiBzdGF0ZS4gCgkJLy8gV2l0aCB0aGUgaW1wbGNpaXQgZ3JhbnQgZmxvdywgdGhlIGhhc2ggd2lsbCBiZSByZXBsYWNlZCB3aXRoIHRoZSBhY2Nlc3MKCQkvLyB0b2tlbiB3aGVuIHdlIHJldHVybiBhZnRlciBhdXRob3JpemF0aW9uLgoJCWlmICh3aW5kb3cubG9jYXRpb24uaGFzaCkgewoJCQlyZXF1ZXN0WyJyZXN0b3JlSGFzaCJdID0gd2luZG93LmxvY2F0aW9uLmhhc2g7CgkJfQoJCXJlcXVlc3RbInByb3ZpZGVySUQiXSA9IHByb3ZpZGVyaWQ7CgkJaWYgKHNjb3BlcykgewoJCQlyZXF1ZXN0WyJzY29wZXMiXSA9IHNjb3BlczsKCQl9CgoKCQlsb2coIlNhdmluZyBzdGF0ZSBbIiArIHN0YXRlKyAiXSIpOwoJCWxvZyhKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJlcXVlc3QpKSk7CgoJCWFwaV9zdG9yYWdlLnNhdmVTdGF0ZShzdGF0ZSwgcmVxdWVzdCk7CgkJYXBpX3JlZGlyZWN0KGF1dGh1cmwpOwoKCX07CgoJZXhwLmpzb19lbnN1cmVUb2tlbnMgPSBmdW5jdGlvbiAoZW5zdXJlKSB7CgkJdmFyIHByb3ZpZGVyaWQsIHNjb3BlcywgdG9rZW47CgkJZm9yKHByb3ZpZGVyaWQgaW4gZW5zdXJlKSB7CgkJCXNjb3BlcyA9IHVuZGVmaW5lZDsKCQkJaWYgKGVuc3VyZVtwcm92aWRlcmlkXSkgc2NvcGVzID0gZW5zdXJlW3Byb3ZpZGVyaWRdOwoJCQl0b2tlbiA9IGFwaV9zdG9yYWdlLmdldFRva2VuKHByb3ZpZGVyaWQsIHNjb3Blcyk7CgoJCQlsb2coIkVuc3VyZSB0b2tlbiBmb3IgcHJvdmlkZXIgWyIgKyBwcm92aWRlcmlkICsgIl0gIik7CgkJCWxvZyh0b2tlbik7CgoJCQlpZiAodG9rZW4gPT09IG51bGwpIHsKCQkJCWpzb19hdXRocmVxdWVzdChwcm92aWRlcmlkLCBzY29wZXMpOwoJCQl9CgkJfQoKCgkJcmV0dXJuIHRydWU7Cgl9CgoJZXhwLmpzb19maW5kRGVmYXVsdEVudHJ5ID0gZnVuY3Rpb24oYykgewoJCXZhciAKCQkJaywKCQkJaSA9IDA7CgoJCWlmICghYykgcmV0dXJuOwoJCWxvZygiYyIsIGMpOwoJCWZvcihrIGluIGMpIHsKCQkJaSsrOwoJCQlpZiAoY1trXS5pc0RlZmF1bHQgJiYgY1trXS5pc0RlZmF1bHQgPT09IHRydWUpIHsKCQkJCXJldHVybiBrOwoJCQl9CgkJfQoJCWlmIChpID09PSAxKSByZXR1cm4gazsKCX07CgoJZXhwLmpzb19jb25maWd1cmUgPSBmdW5jdGlvbihjLCBvcHRzKSB7CgkJY29uZmlnID0gYzsKCQlzZXRPcHRpb25zKG9wdHMpOwoJCXRyeSB7CgoJCQl2YXIgZGVmID0gZXhwLmpzb19maW5kRGVmYXVsdEVudHJ5KGMpOwoJCQlsb2coImpzb19jb25maWd1cmUoKSBhYm91dCB0byBjaGVjayBmb3IgdG9rZW4gZm9yIHRoaXMgZW50cnkiLCBkZWYpOwoJCQlleHAuanNvX2NoZWNrZm9ydG9rZW4oZGVmKTsJCgoJCX0gY2F0Y2goZSkgewoJCQlsb2coIkVycm9yIHdoZW4gcmV0cmlldmluZyB0b2tlbiBmcm9tIGhhc2g6ICIgKyBlKTsKCQkJd2luZG93LmxvY2F0aW9uLmhhc2ggPSAiIjsKCQl9CgkJCgl9CgoJZXhwLmpzb19kdW1wID0gZnVuY3Rpb24oKSB7CgkJdmFyIGtleTsKCQlmb3Ioa2V5IGluIGNvbmZpZykgewoKCQkJbG9nKCI9PT09PT4gUHJvY2Vzc2luZyBwcm92aWRlciBbIiArIGtleSArICJdIik7CgkJCWxvZygiPV0gQ29uZmlnIik7CgkJCWxvZyhjb25maWdba2V5XSk7CgkJCWxvZygiPV0gVG9rZW5zIikKCQkJbG9nKGFwaV9zdG9yYWdlLmdldFRva2VucyhrZXkpKTsKCgkJfQoJfQoKCWV4cC5qc29fd2lwZSA9IGZ1bmN0aW9uKCkgewoJCXZhciBrZXk7CgkJbG9nKCJqc29fd2lwZSgpIik7CgkJZm9yKGtleSBpbiBjb25maWcpIHsKCQkJbG9nKCJXaXBwaW5nIHRva2VucyBmb3IgIiArIGtleSk7CgkJCWFwaV9zdG9yYWdlLndpcGVUb2tlbnMoa2V5KTsKCQl9Cgl9CgoJZXhwLmpzb19nZXRUb2tlbiA9IGZ1bmN0aW9uKHByb3ZpZGVyaWQsIHNjb3BlcykgewoJCXZhciB0b2tlbiA9IGFwaV9zdG9yYWdlLmdldFRva2VuKHByb3ZpZGVyaWQsIHNjb3Blcyk7CgkJaWYgKCF0b2tlbikgcmV0dXJuIG51bGw7CgkJaWYgKCF0b2tlblsiYWNjZXNzX3Rva2VuIl0pIHJldHVybiBudWxsOwoJCXJldHVybiB0b2tlblsiYWNjZXNzX3Rva2VuIl07Cgl9CgoKCglleHAuanNvX3JlZ2lzdGVyUmVkaXJlY3RIYW5kbGVyID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKCQlhcGlfcmVkaXJlY3QgPSBjYWxsYmFjazsKCX07CgoJZXhwLmpzb19yZWdpc3RlclN0b3JhZ2VIYW5kbGVyID0gZnVuY3Rpb24ob2JqZWN0KSB7CgkJYXBpX3N0b3JhZ2UgPSBvYmplY3Q7Cgl9OwoKCgkvKgoJICogRnJvbSBub3cgb24sIHdlIG9ubHkgcGVyZm9ybSB0YXNrcyB0aGF0IHJlcXVpcmUgalF1ZXJ5LgoJICogTGlrZSBhZGRpbmcgdGhlICQub2FqYXggZnVuY3Rpb24uCgkgKi8KCWlmICh0eXBlb2YgJCA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCgkkLm9hamF4ID0gZnVuY3Rpb24oc2V0dGluZ3MpIHsKCQl2YXIgCgkJCWFsbG93aWEsCgkJCXNjb3BlcywKCQkJdG9rZW4sCgkJCXByb3ZpZGVyaWQsCgkJCWNvOwoJCQoJCXByb3ZpZGVyaWQgPSBzZXR0aW5ncy5qc29fcHJvdmlkZXI7CgkJYWxsb3dpYSA9IHNldHRpbmdzLmpzb19hbGxvd2lhIHx8IGZhbHNlOwoJCXNjb3BlcyA9IHNldHRpbmdzLmpzb19zY29wZXM7CgkJdG9rZW4gPSBhcGlfc3RvcmFnZS5nZXRUb2tlbihwcm92aWRlcmlkLCBzY29wZXMpOwoJCWNvID0gY29uZmlnW3Byb3ZpZGVyaWRdOwoKCQkvLyB2YXIgc3VjY2Vzc092ZXJyaWRkZW4gPSBzZXR0aW5ncy5zdWNjZXNzOwoJCS8vIHNldHRpbmdzLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwb25zZSkgewoJCS8vIH0KCgkJdmFyIGVycm9yT3ZlcnJpZGRlbiA9IHNldHRpbmdzLmVycm9yIHx8IG51bGw7CgoJCXZhciBwZXJmb3JtQWpheCA9IGZ1bmN0aW9uKCkgewoJCQkvLyBsb2coIlBlcmZvcm0gYWpheCEiKTsKCgkJCWlmICghdG9rZW4pIHRocm93ICJDb3VsZCBub3QgcGVyZm9ybSBBSkFYIGNhbGwgYmVjYXVzZSBubyB2YWxpZCB0b2tlbnMgd2FzIGZvdW5kLiI7CQoKCQkJaWYgKGNvWyJwcmVzZW50dG9rZW4iXSAmJiBjb1sicHJlc2VudHRva2VuIl0gPT09ICJxcyIpIHsKCQkJCS8vIHNldHRpbmdzLnVybCArPSAoKGguaW5kZXhPZigiPyIpID09PSAtMSkgPyAnPycgOiAnJicpICsgImFjY2Vzc190b2tlbj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHRva2VuWyJhY2Nlc3NfdG9rZW4iXSk7CgkJCQlpZiAoIXNldHRpbmdzLmRhdGEpIHNldHRpbmdzLmRhdGEgPSB7fTsKCQkJCXNldHRpbmdzLmRhdGFbImFjY2Vzc190b2tlbiJdID0gdG9rZW5bImFjY2Vzc190b2tlbiJdOwoJCQl9IGVsc2UgewoJCQkJaWYgKCFzZXR0aW5ncy5oZWFkZXJzKSBzZXR0aW5ncy5oZWFkZXJzID0ge307CgkJCQlzZXR0aW5ncy5oZWFkZXJzWyJBdXRob3JpemF0aW9uIl0gPSAiQmVhcmVyICIgKyB0b2tlblsiYWNjZXNzX3Rva2VuIl07CgkJCX0KCQkJcmV0dXJuICQuYWpheChzZXR0aW5ncyk7CgkJfTsKCgkJc2V0dGluZ3MuZXJyb3IgPSBmdW5jdGlvbihqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pIHsKCQkJbG9nKCdlcnJvcihqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pJyk7CgkJCWxvZyhqcVhIUik7CgkJCWxvZyh0ZXh0U3RhdHVzKTsKCQkJbG9nKGVycm9yVGhyb3duKTsKCgkJCWlmIChqcVhIUi5zdGF0dXMgPT09IDQwMSkgewoKCQkJCWxvZygiVG9rZW4gZXhwaXJlZC4gQWJvdXQgdG8gZGVsZXRlIHRoaXMgdG9rZW4iKTsKCQkJCWxvZyh0b2tlbik7CgkJCQlhcGlfc3RvcmFnZS53aXBlVG9rZW5zKHByb3ZpZGVyaWQpOwoKCQkJfQoJCQlpZiAoZXJyb3JPdmVycmlkZGVuICYmIHR5cGVvZiBlcnJvck92ZXJyaWRkZW4gPT09ICdmdW5jdGlvbicpIHsKCQkJCWVycm9yT3ZlcnJpZGRlbihqcVhIUiwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24pOwoJCQl9CgkJfQoKCgkJaWYgKCF0b2tlbikgewoJCQlpZiAoYWxsb3dpYSkgewoJCQkJbG9nKCJQZXJmb3JtIGF1dGhyZXF1ZXN0Iik7CgkJCQlqc29fYXV0aHJlcXVlc3QocHJvdmlkZXJpZCwgc2NvcGVzLCBmdW5jdGlvbigpIHsKCQkJCQl0b2tlbiA9IGFwaV9zdG9yYWdlLmdldFRva2VuKHByb3ZpZGVyaWQsIHNjb3Blcyk7CgkJCQkJcGVyZm9ybUFqYXgoKTsKCQkJCX0pOwoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgewoJCQkJdGhyb3cgIkNvdWxkIG5vdCBwZXJmb3JtIEFKQVggY2FsbCBiZWNhdXNlIG5vIHZhbGlkIHRva2VucyB3YXMgZm91bmQuIjsJCgkJCX0KCQl9CgoKCQlyZXR1cm4gcGVyZm9ybUFqYXgoKTsKCX07CgoKfSkod2luZG93LCB3aW5kb3cualF1ZXJ5KTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 07:38:42 GMT",
                    "Content-Length": "13863",
                    "Date": "Fri, 07 Nov 2014 07:38:42 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}