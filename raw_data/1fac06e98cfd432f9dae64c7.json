{
    "url": "http://localhost:9999/hype/HYPE_Processing/doc/html/navtree.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>window.location.hash</b> and written to <b>$()</b> via the following statements:<ul><li>navTo(o,toroot,window.location.hash,relpath);</li><li>gotoNode(o,i,root,hash,relpath)</li><li>showNode(o, o.node, 0, hash);</li><li>showNode(o,n,index+1,hash);</li><li>selectAndHighlight(hash,n);</li><li>var link=stripPath($(location).attr('pathname'))+':'+hash.substring(1);</li><li>a=$('.item a[class$=\"'+link+'\"]');</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/hype/HYPE_Processing/doc/html/navtree.js",
                "path": "/hype/HYPE_Processing/doc/html/navtree.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9oeXBlL0hZUEVfUHJvY2Vzc2luZy9kb2MvaHRtbC9uYXZ0cmVlLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTUwMjMNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDQ6MTQ6MzIgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDA0OjE0OjI1IEdNVA0KDQp2YXIgTkFWVFJFRSA9ClsKICBbICJIWVBFX3Byb2Nlc3NpbmciLCAiaW5kZXguaHRtbCIsIFsKICAgIFsgIkRlcHJlY2F0ZWQgTGlzdCIsICJkZXByZWNhdGVkLmh0bWwiLCBudWxsIF0sCiAgICBbICJDbGFzc2VzIiwgbnVsbCwgWwogICAgICBbICJDbGFzcyBMaXN0IiwgImFubm90YXRlZC5odG1sIiwgImFubm90YXRlZCIgXSwKICAgICAgWyAiQ2xhc3MgSW5kZXgiLCAiY2xhc3Nlcy5odG1sIiwgbnVsbCBdLAogICAgICBbICJDbGFzcyBIaWVyYXJjaHkiLCAiaGllcmFyY2h5Lmh0bWwiLCAiaGllcmFyY2h5IiBdLAogICAgICBbICJDbGFzcyBNZW1iZXJzIiwgImZ1bmN0aW9ucy5odG1sIiwgWwogICAgICAgIFsgIkFsbCIsICJmdW5jdGlvbnMuaHRtbCIsIG51bGwgXSwKICAgICAgICBbICJGdW5jdGlvbnMiLCAiZnVuY3Rpb25zX2Z1bmMuaHRtbCIsIG51bGwgXSwKICAgICAgICBbICJWYXJpYWJsZXMiLCAiZnVuY3Rpb25zX3ZhcnMuaHRtbCIsIG51bGwgXQogICAgICBdIF0KICAgIF0gXQogIF0gXQpdOwoKdmFyIE5BVlRSRUVJTkRFWCA9ClsKIi5odG1sIiwKImNsYXNzaHlwZV8xXzFjb3JlXzFfMWRyYXdhYmxlXzFfMV9oX2RyYXdhYmxlLmh0bWwjYWVlZjFjMTkwZjM4MzU2MjkxMDEwN2JlOGU1ZjgwNDYxIiwKImNsYXNzaHlwZV8xXzFleHRlbmRlZF8xXzFiZWhhdmlvcl8xXzFfaF9yYW5kb21fdHJpZ2dlci5odG1sIiwKImNsYXNzaHlwZV8xXzFleHRlbmRlZF8xXzFkcmF3YWJsZV8xXzFfaF9lbGxpcHNlLmh0bWwjYWVjYTkzY2UyZjFkNzBmOTM3MGJiMjFmYWI4MTc1ZDJmIiwKImludGVyZmFjZWh5cGVfMV8xY29yZV8xXzFpbnRlcmZhY2VzXzFfMV9oX2ltYWdlX2hvbGRlci5odG1sIgpdOwoKdmFyIFNZTkNPTk1TRyA9ICdjbGljayB0byBkaXNhYmxlIHBhbmVsIHN5bmNocm9uaXNhdGlvbic7CnZhciBTWU5DT0ZGTVNHID0gJ2NsaWNrIHRvIGVuYWJsZSBwYW5lbCBzeW5jaHJvbmlzYXRpb24nOwp2YXIgbmF2VHJlZVN1YkluZGljZXMgPSBuZXcgQXJyYXkoKTsKCmZ1bmN0aW9uIGdldERhdGEodmFyTmFtZSkKewogIHZhciBpID0gdmFyTmFtZS5sYXN0SW5kZXhPZignLycpOwogIHZhciBuID0gaT49MCA/IHZhck5hbWUuc3Vic3RyaW5nKGkrMSkgOiB2YXJOYW1lOwogIHJldHVybiBldmFsKG4ucmVwbGFjZSgvXC0vZywnXycpKTsKfQoKZnVuY3Rpb24gc3RyaXBQYXRoKHVyaSkKewogIHJldHVybiB1cmkuc3Vic3RyaW5nKHVyaS5sYXN0SW5kZXhPZignLycpKzEpOwp9CgpmdW5jdGlvbiBzdHJpcFBhdGgyKHVyaSkKewogIHZhciBpID0gdXJpLmxhc3RJbmRleE9mKCcvJyk7CiAgdmFyIHMgPSB1cmkuc3Vic3RyaW5nKGkrMSk7CiAgdmFyIG0gPSB1cmkuc3Vic3RyaW5nKDAsaSsxKS5tYXRjaCgvXC9kXHdcL2Rcd1x3XC8kLyk7CiAgcmV0dXJuIG0gPyB1cmkuc3Vic3RyaW5nKGktNikgOiBzOwp9CgpmdW5jdGlvbiBsb2NhbFN0b3JhZ2VTdXBwb3J0ZWQoKQp7CiAgdHJ5IHsKICAgIHJldHVybiAnbG9jYWxTdG9yYWdlJyBpbiB3aW5kb3cgJiYgd2luZG93Wydsb2NhbFN0b3JhZ2UnXSAhPT0gbnVsbCAmJiB3aW5kb3cubG9jYWxTdG9yYWdlLmdldEl0ZW07CiAgfQogIGNhdGNoKGUpIHsKICAgIHJldHVybiBmYWxzZTsKICB9Cn0KCgpmdW5jdGlvbiBzdG9yZUxpbmsobGluaykKewogIGlmICghJCgiI25hdi1zeW5jIikuaGFzQ2xhc3MoJ3N5bmMnKSAmJiBsb2NhbFN0b3JhZ2VTdXBwb3J0ZWQoKSkgewogICAgICB3aW5kb3cubG9jYWxTdG9yYWdlLnNldEl0ZW0oJ25hdnBhdGgnLGxpbmspOwogIH0KfQoKZnVuY3Rpb24gZGVsZXRlTGluaygpCnsKICBpZiAobG9jYWxTdG9yYWdlU3VwcG9ydGVkKCkpIHsKICAgIHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnbmF2cGF0aCcsJycpOwogIH0gCn0KCmZ1bmN0aW9uIGNhY2hlZExpbmsoKQp7CiAgaWYgKGxvY2FsU3RvcmFnZVN1cHBvcnRlZCgpKSB7CiAgICByZXR1cm4gd2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKCduYXZwYXRoJyk7CiAgfSBlbHNlIHsKICAgIHJldHVybiAnJzsKICB9Cn0KCmZ1bmN0aW9uIGdldFNjcmlwdChzY3JpcHROYW1lLGZ1bmMsc2hvdykKewogIHZhciBoZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXTsgCiAgdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwogIHNjcmlwdC5pZCA9IHNjcmlwdE5hbWU7CiAgc2NyaXB0LnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0JzsKICBzY3JpcHQub25sb2FkID0gZnVuYzsgCiAgc2NyaXB0LnNyYyA9IHNjcmlwdE5hbWUrJy5qcyc7IAogIGlmICgkLmJyb3dzZXIubXNpZSAmJiAkLmJyb3dzZXIudmVyc2lvbjw9OCkgeyAKICAgIC8vIHNjcmlwdC5vbmxvYWQgZG9lcyBub3Qgd29yayB3aXRoIG9sZGVyIHZlcnNpb25zIG9mIElFCiAgICBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChzY3JpcHQucmVhZHlTdGF0ZT09J2NvbXBsZXRlJyB8fCBzY3JpcHQucmVhZHlTdGF0ZT09J2xvYWRlZCcpIHsgCiAgICAgICAgZnVuYygpOyBpZiAoc2hvdykgc2hvd1Jvb3QoKTsgCiAgICAgIH0KICAgIH0KICB9CiAgaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOyAKfQoKZnVuY3Rpb24gY3JlYXRlSW5kZW50KG8sZG9tTm9kZSxub2RlLGxldmVsKQp7CiAgdmFyIGxldmVsPS0xOwogIHZhciBuID0gbm9kZTsKICB3aGlsZSAobi5wYXJlbnROb2RlKSB7IGxldmVsKys7IG49bi5wYXJlbnROb2RlOyB9CiAgdmFyIGltZ05vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsKICBpbWdOb2RlLnN0eWxlLnBhZGRpbmdMZWZ0PSgxNipsZXZlbCkudG9TdHJpbmcoKSsncHgnOwogIGltZ05vZGUud2lkdGggID0gMTY7CiAgaW1nTm9kZS5oZWlnaHQgPSAyMjsKICBpbWdOb2RlLmJvcmRlciA9IDA7CiAgaWYgKG5vZGUuY2hpbGRyZW5EYXRhKSB7CiAgICBub2RlLnBsdXNfaW1nID0gaW1nTm9kZTsKICAgIG5vZGUuZXhwYW5kVG9nZ2xlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgbm9kZS5leHBhbmRUb2dnbGUuaHJlZiA9ICJqYXZhc2NyaXB0OnZvaWQoMCkiOwogICAgbm9kZS5leHBhbmRUb2dnbGUub25jbGljayA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAobm9kZS5leHBhbmRlZCkgewogICAgICAgICQobm9kZS5nZXRDaGlsZHJlblVMKCkpLnNsaWRlVXAoImZhc3QiKTsKICAgICAgICBub2RlLnBsdXNfaW1nLnNyYyA9IG5vZGUucmVscGF0aCsiZnR2MnBub2RlLnBuZyI7CiAgICAgICAgbm9kZS5leHBhbmRlZCA9IGZhbHNlOwogICAgICB9IGVsc2UgewogICAgICAgIGV4cGFuZE5vZGUobywgbm9kZSwgZmFsc2UsIGZhbHNlKTsKICAgICAgfQogICAgfQogICAgbm9kZS5leHBhbmRUb2dnbGUuYXBwZW5kQ2hpbGQoaW1nTm9kZSk7CiAgICBkb21Ob2RlLmFwcGVuZENoaWxkKG5vZGUuZXhwYW5kVG9nZ2xlKTsKICAgIGltZ05vZGUuc3JjID0gbm9kZS5yZWxwYXRoKyJmdHYycG5vZGUucG5nIjsKICB9IGVsc2UgewogICAgaW1nTm9kZS5zcmMgPSBub2RlLnJlbHBhdGgrImZ0djJub2RlLnBuZyI7CiAgICBkb21Ob2RlLmFwcGVuZENoaWxkKGltZ05vZGUpOwogIH0gCn0KCnZhciBhbmltYXRpb25JblByb2dyZXNzID0gZmFsc2U7CgpmdW5jdGlvbiBnb3RvQW5jaG9yKGFuY2hvcixhbmFtZSx1cGRhdGVMb2NhdGlvbikKewogIHZhciBwb3MsIGRvY0NvbnRlbnQgPSAkKCcjZG9jLWNvbnRlbnQnKTsKICBpZiAoYW5jaG9yLnBhcmVudCgpLmF0dHIoJ2NsYXNzJyk9PSdtZW1JdGVtTGVmdCcgfHwKICAgICAgYW5jaG9yLnBhcmVudCgpLmF0dHIoJ2NsYXNzJyk9PSdmaWVsZHR5cGUnIHx8CiAgICAgIGFuY2hvci5wYXJlbnQoKS5pcygnOmhlYWRlcicpKSAKICB7CiAgICBwb3MgPSBhbmNob3IucGFyZW50KCkucG9zaXRpb24oKS50b3A7CiAgfSBlbHNlIGlmIChhbmNob3IucG9zaXRpb24oKSkgewogICAgcG9zID0gYW5jaG9yLnBvc2l0aW9uKCkudG9wOwogIH0KICBpZiAocG9zKSB7CiAgICB2YXIgZGlzdCA9IE1hdGguYWJzKE1hdGgubWluKAogICAgICAgICAgICAgICBwb3MtZG9jQ29udGVudC5vZmZzZXQoKS50b3AsCiAgICAgICAgICAgICAgIGRvY0NvbnRlbnRbMF0uc2Nyb2xsSGVpZ2h0LQogICAgICAgICAgICAgICBkb2NDb250ZW50LmhlaWdodCgpLWRvY0NvbnRlbnQuc2Nyb2xsVG9wKCkpKTsKICAgIGFuaW1hdGlvbkluUHJvZ3Jlc3M9dHJ1ZTsKICAgIGRvY0NvbnRlbnQuYW5pbWF0ZSh7CiAgICAgIHNjcm9sbFRvcDogcG9zICsgZG9jQ29udGVudC5zY3JvbGxUb3AoKSAtIGRvY0NvbnRlbnQub2Zmc2V0KCkudG9wCiAgICB9LE1hdGgubWF4KDUwLE1hdGgubWluKDUwMCxkaXN0KSksZnVuY3Rpb24oKXsKICAgICAgaWYgKHVwZGF0ZUxvY2F0aW9uKSB3aW5kb3cubG9jYXRpb24uaHJlZj1hbmFtZTsKICAgICAgYW5pbWF0aW9uSW5Qcm9ncmVzcz1mYWxzZTsKICAgIH0pOwogIH0KfQoKZnVuY3Rpb24gbmV3Tm9kZShvLCBwbywgdGV4dCwgbGluaywgY2hpbGRyZW5EYXRhLCBsYXN0Tm9kZSkKewogIHZhciBub2RlID0gbmV3IE9iamVjdCgpOwogIG5vZGUuY2hpbGRyZW4gPSBBcnJheSgpOwogIG5vZGUuY2hpbGRyZW5EYXRhID0gY2hpbGRyZW5EYXRhOwogIG5vZGUuZGVwdGggPSBwby5kZXB0aCArIDE7CiAgbm9kZS5yZWxwYXRoID0gcG8ucmVscGF0aDsKICBub2RlLmlzTGFzdCA9IGxhc3ROb2RlOwoKICBub2RlLmxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsKICBwby5nZXRDaGlsZHJlblVMKCkuYXBwZW5kQ2hpbGQobm9kZS5saSk7CiAgbm9kZS5wYXJlbnROb2RlID0gcG87CgogIG5vZGUuaXRlbURpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogIG5vZGUuaXRlbURpdi5jbGFzc05hbWUgPSAiaXRlbSI7CgogIG5vZGUubGFiZWxTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogIG5vZGUubGFiZWxTcGFuLmNsYXNzTmFtZSA9ICJsYWJlbCI7CgogIGNyZWF0ZUluZGVudChvLG5vZGUuaXRlbURpdixub2RlLDApOwogIG5vZGUuaXRlbURpdi5hcHBlbmRDaGlsZChub2RlLmxhYmVsU3Bhbik7CiAgbm9kZS5saS5hcHBlbmRDaGlsZChub2RlLml0ZW1EaXYpOwoKICB2YXIgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICBub2RlLmxhYmVsU3Bhbi5hcHBlbmRDaGlsZChhKTsKICBub2RlLmxhYmVsID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dCk7CiAgbm9kZS5leHBhbmRlZCA9IGZhbHNlOwogIGEuYXBwZW5kQ2hpbGQobm9kZS5sYWJlbCk7CiAgaWYgKGxpbmspIHsKICAgIHZhciB1cmw7CiAgICBpZiAobGluay5zdWJzdHJpbmcoMCwxKT09J14nKSB7CiAgICAgIHVybCA9IGxpbmsuc3Vic3RyaW5nKDEpOwogICAgICBsaW5rID0gdXJsOwogICAgfSBlbHNlIHsKICAgICAgdXJsID0gbm9kZS5yZWxwYXRoK2xpbms7CiAgICB9CiAgICBhLmNsYXNzTmFtZSA9IHN0cmlwUGF0aChsaW5rLnJlcGxhY2UoJyMnLCc6JykpOwogICAgaWYgKGxpbmsuaW5kZXhPZignIycpIT0tMSkgewogICAgICB2YXIgYW5hbWUgPSAnIycrbGluay5zcGxpdCgnIycpWzFdOwogICAgICB2YXIgc3JjUGFnZSA9IHN0cmlwUGF0aCgkKGxvY2F0aW9uKS5hdHRyKCdwYXRobmFtZScpKTsKICAgICAgdmFyIHRhcmdldFBhZ2UgPSBzdHJpcFBhdGgobGluay5zcGxpdCgnIycpWzBdKTsKICAgICAgYS5ocmVmID0gc3JjUGFnZSE9dGFyZ2V0UGFnZSA/IHVybCA6ICJqYXZhc2NyaXB0OnZvaWQoMCkiOyAKICAgICAgYS5vbmNsaWNrID0gZnVuY3Rpb24oKXsKICAgICAgICBzdG9yZUxpbmsobGluayk7CiAgICAgICAgaWYgKCEkKGEpLnBhcmVudCgpLnBhcmVudCgpLmhhc0NsYXNzKCdzZWxlY3RlZCcpKQogICAgICAgIHsKICAgICAgICAgICQoJy5pdGVtJykucmVtb3ZlQ2xhc3MoJ3NlbGVjdGVkJyk7CiAgICAgICAgICAkKCcuaXRlbScpLnJlbW92ZUF0dHIoJ2lkJyk7CiAgICAgICAgICAkKGEpLnBhcmVudCgpLnBhcmVudCgpLmFkZENsYXNzKCdzZWxlY3RlZCcpOwogICAgICAgICAgJChhKS5wYXJlbnQoKS5wYXJlbnQoKS5hdHRyKCdpZCcsJ3NlbGVjdGVkJyk7CiAgICAgICAgfQogICAgICAgIHZhciBhbmNob3IgPSAkKGFuYW1lKTsKICAgICAgICBnb3RvQW5jaG9yKGFuY2hvcixhbmFtZSx0cnVlKTsKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIGEuaHJlZiA9IHVybDsKICAgICAgYS5vbmNsaWNrID0gZnVuY3Rpb24oKSB7IHN0b3JlTGluayhsaW5rKTsgfQogICAgfQogIH0gZWxzZSB7CiAgICBpZiAoY2hpbGRyZW5EYXRhICE9IG51bGwpIAogICAgewogICAgICBhLmNsYXNzTmFtZSA9ICJub2xpbmsiOwogICAgICBhLmhyZWYgPSAiamF2YXNjcmlwdDp2b2lkKDApIjsKICAgICAgYS5vbmNsaWNrID0gbm9kZS5leHBhbmRUb2dnbGUub25jbGljazsKICAgIH0KICB9CgogIG5vZGUuY2hpbGRyZW5VTCA9IG51bGw7CiAgbm9kZS5nZXRDaGlsZHJlblVMID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoIW5vZGUuY2hpbGRyZW5VTCkgewogICAgICBub2RlLmNoaWxkcmVuVUwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ1bCIpOwogICAgICBub2RlLmNoaWxkcmVuVUwuY2xhc3NOYW1lID0gImNoaWxkcmVuX3VsIjsKICAgICAgbm9kZS5jaGlsZHJlblVMLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgIG5vZGUubGkuYXBwZW5kQ2hpbGQobm9kZS5jaGlsZHJlblVMKTsKICAgIH0KICAgIHJldHVybiBub2RlLmNoaWxkcmVuVUw7CiAgfTsKCiAgcmV0dXJuIG5vZGU7Cn0KCmZ1bmN0aW9uIHNob3dSb290KCkKewogIHZhciBoZWFkZXJIZWlnaHQgPSAkKCIjdG9wIikuaGVpZ2h0KCk7CiAgdmFyIGZvb3RlckhlaWdodCA9ICQoIiNuYXYtcGF0aCIpLmhlaWdodCgpOwogIHZhciB3aW5kb3dIZWlnaHQgPSAkKHdpbmRvdykuaGVpZ2h0KCkgLSBoZWFkZXJIZWlnaHQgLSBmb290ZXJIZWlnaHQ7CiAgKGZ1bmN0aW9uICgpeyAvLyByZXRyeSB1bnRpbCB3ZSBjYW4gc2Nyb2xsIHRvIHRoZSBzZWxlY3RlZCBpdGVtCiAgICB0cnkgewogICAgICB2YXIgbmF2dHJlZT0kKCcjbmF2LXRyZWUnKTsKICAgICAgbmF2dHJlZS5zY3JvbGxUbygnI3NlbGVjdGVkJywwLHtvZmZzZXQ6LXdpbmRvd0hlaWdodC8yfSk7CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgc2V0VGltZW91dChhcmd1bWVudHMuY2FsbGVlLCAwKTsKICAgIH0KICB9KSgpOwp9CgpmdW5jdGlvbiBleHBhbmROb2RlKG8sIG5vZGUsIGltbSwgc2hvd1Jvb3QpCnsKICBpZiAobm9kZS5jaGlsZHJlbkRhdGEgJiYgIW5vZGUuZXhwYW5kZWQpIHsKICAgIGlmICh0eXBlb2Yobm9kZS5jaGlsZHJlbkRhdGEpPT09J3N0cmluZycpIHsKICAgICAgdmFyIHZhck5hbWUgICAgPSBub2RlLmNoaWxkcmVuRGF0YTsKICAgICAgZ2V0U2NyaXB0KG5vZGUucmVscGF0aCt2YXJOYW1lLGZ1bmN0aW9uKCl7CiAgICAgICAgbm9kZS5jaGlsZHJlbkRhdGEgPSBnZXREYXRhKHZhck5hbWUpOwogICAgICAgIGV4cGFuZE5vZGUobywgbm9kZSwgaW1tLCBzaG93Um9vdCk7CiAgICAgIH0sIHNob3dSb290KTsKICAgIH0gZWxzZSB7CiAgICAgIGlmICghbm9kZS5jaGlsZHJlblZpc2l0ZWQpIHsKICAgICAgICBnZXROb2RlKG8sIG5vZGUpOwogICAgICB9IGlmIChpbW0gfHwgKCQuYnJvd3Nlci5tc2llICYmICQuYnJvd3Nlci52ZXJzaW9uPjgpKSB7IAogICAgICAgIC8vIHNvbWVob3cgc2xpZGVEb3duIGp1bXBzIHRvIHRoZSBzdGFydCBvZiB0cmVlIGZvciBJRTkgOi0oCiAgICAgICAgJChub2RlLmdldENoaWxkcmVuVUwoKSkuc2hvdygpOwogICAgICB9IGVsc2UgewogICAgICAgICQobm9kZS5nZXRDaGlsZHJlblVMKCkpLnNsaWRlRG93bigiZmFzdCIpOwogICAgICB9CiAgICAgIGlmIChub2RlLmlzTGFzdCkgewogICAgICAgIG5vZGUucGx1c19pbWcuc3JjID0gbm9kZS5yZWxwYXRoKyJmdHYybWxhc3Rub2RlLnBuZyI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbm9kZS5wbHVzX2ltZy5zcmMgPSBub2RlLnJlbHBhdGgrImZ0djJtbm9kZS5wbmciOwogICAgICB9CiAgICAgIG5vZGUuZXhwYW5kZWQgPSB0cnVlOwogICAgfQogIH0KfQoKZnVuY3Rpb24gZ2xvd0VmZmVjdChuLGR1cmF0aW9uKQp7CiAgbi5hZGRDbGFzcygnZ2xvdycpLmRlbGF5KGR1cmF0aW9uKS5xdWV1ZShmdW5jdGlvbihuZXh0KXsKICAgICQodGhpcykucmVtb3ZlQ2xhc3MoJ2dsb3cnKTtuZXh0KCk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGhpZ2hsaWdodEFuY2hvcigpCnsKICB2YXIgYW5hbWUgPSAkKGxvY2F0aW9uKS5hdHRyKCdoYXNoJyk7CiAgdmFyIGFuY2hvciA9ICQoYW5hbWUpOwogIGlmIChhbmNob3IucGFyZW50KCkuYXR0cignY2xhc3MnKT09J21lbUl0ZW1MZWZ0Jyl7CiAgICB2YXIgcm93cyA9ICQoJy5tZW1iZXJkZWNscyB0cltjbGFzcyQ9IicrCiAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cmluZygxKSsnIl0nKTsKICAgIGdsb3dFZmZlY3Qocm93cy5jaGlsZHJlbigpLDMwMCk7IC8vIG1lbWJlciB3aXRob3V0IGRldGFpbHMKICB9IGVsc2UgaWYgKGFuY2hvci5wYXJlbnRzKCkuc2xpY2UoMikucHJvcCgndGFnTmFtZScpPT0nVFInKSB7CiAgICBnbG93RWZmZWN0KGFuY2hvci5wYXJlbnRzKCdkaXYubWVtaXRlbScpLDEwMDApOyAvLyBlbnVtIHZhbHVlCiAgfSBlbHNlIGlmIChhbmNob3IucGFyZW50KCkuYXR0cignY2xhc3MnKT09J2ZpZWxkdHlwZScpewogICAgZ2xvd0VmZmVjdChhbmNob3IucGFyZW50KCkucGFyZW50KCksMTAwMCk7IC8vIHN0cnVjdCBmaWVsZAogIH0gZWxzZSBpZiAoYW5jaG9yLnBhcmVudCgpLmlzKCI6aGVhZGVyIikpIHsKICAgIGdsb3dFZmZlY3QoYW5jaG9yLnBhcmVudCgpLDEwMDApOyAvLyBzZWN0aW9uIGhlYWRlcgogIH0gZWxzZSB7CiAgICBnbG93RWZmZWN0KGFuY2hvci5uZXh0KCksMTAwMCk7IC8vIG5vcm1hbCBtZW1iZXIKICB9CiAgZ290b0FuY2hvcihhbmNob3IsYW5hbWUsZmFsc2UpOwp9CgpmdW5jdGlvbiBzZWxlY3RBbmRIaWdobGlnaHQoaGFzaCxuKQp7CiAgdmFyIGE7CiAgaWYgKGhhc2gpIHsKICAgIHZhciBsaW5rPXN0cmlwUGF0aCgkKGxvY2F0aW9uKS5hdHRyKCdwYXRobmFtZScpKSsnOicraGFzaC5zdWJzdHJpbmcoMSk7CiAgICBhPSQoJy5pdGVtIGFbY2xhc3MkPSInK2xpbmsrJyJdJyk7CiAgfQogIGlmIChhICYmIGEubGVuZ3RoKSB7CiAgICBhLnBhcmVudCgpLnBhcmVudCgpLmFkZENsYXNzKCdzZWxlY3RlZCcpOwogICAgYS5wYXJlbnQoKS5wYXJlbnQoKS5hdHRyKCdpZCcsJ3NlbGVjdGVkJyk7CiAgICBoaWdobGlnaHRBbmNob3IoKTsKICB9IGVsc2UgaWYgKG4pIHsKICAgICQobi5pdGVtRGl2KS5hZGRDbGFzcygnc2VsZWN0ZWQnKTsKICAgICQobi5pdGVtRGl2KS5hdHRyKCdpZCcsJ3NlbGVjdGVkJyk7CiAgfQogIGlmICgkKCcjbmF2LXRyZWUtY29udGVudHMgLml0ZW06Zmlyc3QnKS5oYXNDbGFzcygnc2VsZWN0ZWQnKSkgewogICAgJCgnI25hdi1zeW5jJykuY3NzKCd0b3AnLCczMHB4Jyk7CiAgfSBlbHNlIHsKICAgICQoJyNuYXYtc3luYycpLmNzcygndG9wJywnNXB4Jyk7CiAgfQogIHNob3dSb290KCk7Cn0KCmZ1bmN0aW9uIHNob3dOb2RlKG8sIG5vZGUsIGluZGV4LCBoYXNoKQp7CiAgaWYgKG5vZGUgJiYgbm9kZS5jaGlsZHJlbkRhdGEpIHsKICAgIGlmICh0eXBlb2Yobm9kZS5jaGlsZHJlbkRhdGEpPT09J3N0cmluZycpIHsKICAgICAgdmFyIHZhck5hbWUgICAgPSBub2RlLmNoaWxkcmVuRGF0YTsKICAgICAgZ2V0U2NyaXB0KG5vZGUucmVscGF0aCt2YXJOYW1lLGZ1bmN0aW9uKCl7CiAgICAgICAgbm9kZS5jaGlsZHJlbkRhdGEgPSBnZXREYXRhKHZhck5hbWUpOwogICAgICAgIHNob3dOb2RlKG8sbm9kZSxpbmRleCxoYXNoKTsKICAgICAgfSx0cnVlKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmICghbm9kZS5jaGlsZHJlblZpc2l0ZWQpIHsKICAgICAgICBnZXROb2RlKG8sIG5vZGUpOwogICAgICB9CiAgICAgICQobm9kZS5nZXRDaGlsZHJlblVMKCkpLnNob3coKTsKICAgICAgaWYgKG5vZGUuaXNMYXN0KSB7CiAgICAgICAgbm9kZS5wbHVzX2ltZy5zcmMgPSBub2RlLnJlbHBhdGgrImZ0djJtbGFzdG5vZGUucG5nIjsKICAgICAgfSBlbHNlIHsKICAgICAgICBub2RlLnBsdXNfaW1nLnNyYyA9IG5vZGUucmVscGF0aCsiZnR2Mm1ub2RlLnBuZyI7CiAgICAgIH0KICAgICAgbm9kZS5leHBhbmRlZCA9IHRydWU7CiAgICAgIHZhciBuID0gbm9kZS5jaGlsZHJlbltvLmJyZWFkY3J1bWJzW2luZGV4XV07CiAgICAgIGlmIChpbmRleCsxPG8uYnJlYWRjcnVtYnMubGVuZ3RoKSB7CiAgICAgICAgc2hvd05vZGUobyxuLGluZGV4KzEsaGFzaCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHR5cGVvZihuLmNoaWxkcmVuRGF0YSk9PT0nc3RyaW5nJykgewogICAgICAgICAgdmFyIHZhck5hbWUgPSBuLmNoaWxkcmVuRGF0YTsKICAgICAgICAgIGdldFNjcmlwdChuLnJlbHBhdGgrdmFyTmFtZSxmdW5jdGlvbigpewogICAgICAgICAgICBuLmNoaWxkcmVuRGF0YSA9IGdldERhdGEodmFyTmFtZSk7CiAgICAgICAgICAgIG5vZGUuZXhwYW5kZWQ9ZmFsc2U7CiAgICAgICAgICAgIHNob3dOb2RlKG8sbm9kZSxpbmRleCxoYXNoKTsgLy8gcmV0cnkgd2l0aCBjaGlsZCBub2RlIGV4cGFuZGVkCiAgICAgICAgICB9LHRydWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgcm9vdEJhc2UgPSBzdHJpcFBhdGgoby50b3Jvb3QucmVwbGFjZSgvXC4uKyQvLCAnJykpOwogICAgICAgICAgaWYgKHJvb3RCYXNlPT0iaW5kZXgiIHx8IHJvb3RCYXNlPT0icGFnZXMiIHx8IHJvb3RCYXNlPT0ic2VhcmNoIikgewogICAgICAgICAgICBleHBhbmROb2RlKG8sIG4sIHRydWUsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgc2VsZWN0QW5kSGlnaGxpZ2h0KGhhc2gsbik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIHNlbGVjdEFuZEhpZ2hsaWdodChoYXNoKTsKICB9Cn0KCmZ1bmN0aW9uIGdldE5vZGUobywgcG8pCnsKICBwby5jaGlsZHJlblZpc2l0ZWQgPSB0cnVlOwogIHZhciBsID0gcG8uY2hpbGRyZW5EYXRhLmxlbmd0aC0xOwogIGZvciAodmFyIGkgaW4gcG8uY2hpbGRyZW5EYXRhKSB7CiAgICB2YXIgbm9kZURhdGEgPSBwby5jaGlsZHJlbkRhdGFbaV07CiAgICBwby5jaGlsZHJlbltpXSA9IG5ld05vZGUobywgcG8sIG5vZGVEYXRhWzBdLCBub2RlRGF0YVsxXSwgbm9kZURhdGFbMl0sCiAgICAgIGk9PWwpOwogIH0KfQoKZnVuY3Rpb24gZ290b05vZGUobyxzdWJJbmRleCxyb290LGhhc2gscmVscGF0aCkKewogIHZhciBudGkgPSBuYXZUcmVlU3ViSW5kaWNlc1tzdWJJbmRleF1bcm9vdCtoYXNoXTsKICBvLmJyZWFkY3J1bWJzID0gJC5leHRlbmQodHJ1ZSwgW10sIG50aSA/IG50aSA6IG5hdlRyZWVTdWJJbmRpY2VzW3N1YkluZGV4XVtyb290XSk7CiAgaWYgKCFvLmJyZWFkY3J1bWJzICYmIHJvb3QhPU5BVlRSRUVbMF1bMV0pIHsgLy8gZmFsbGJhY2s6IHNob3cgaW5kZXgKICAgIG5hdlRvKG8sTkFWVFJFRVswXVsxXSwiIixyZWxwYXRoKTsKICAgICQoJy5pdGVtJykucmVtb3ZlQ2xhc3MoJ3NlbGVjdGVkJyk7CiAgICAkKCcuaXRlbScpLnJlbW92ZUF0dHIoJ2lkJyk7CiAgfQogIGlmIChvLmJyZWFkY3J1bWJzKSB7CiAgICBvLmJyZWFkY3J1bWJzLnVuc2hpZnQoMCk7IC8vIGFkZCAwIGZvciByb290IG5vZGUKICAgIHNob3dOb2RlKG8sIG8ubm9kZSwgMCwgaGFzaCk7CiAgfQp9CgpmdW5jdGlvbiBuYXZUbyhvLHJvb3QsaGFzaCxyZWxwYXRoKQp7CiAgdmFyIGxpbmsgPSBjYWNoZWRMaW5rKCk7CiAgaWYgKGxpbmspIHsKICAgIHZhciBwYXJ0cyA9IGxpbmsuc3BsaXQoJyMnKTsKICAgIHJvb3QgPSBwYXJ0c1swXTsKICAgIGlmIChwYXJ0cy5sZW5ndGg+MSkgaGFzaCA9ICcjJytwYXJ0c1sxXTsKICAgIGVsc2UgaGFzaD0nJzsKICB9CiAgaWYgKGhhc2gubWF0Y2goL14jbFxkKyQvKSkgewogICAgdmFyIGFuY2hvcj0kKCdhW25hbWU9JytoYXNoLnN1YnN0cmluZygxKSsnXScpOwogICAgZ2xvd0VmZmVjdChhbmNob3IucGFyZW50KCksMTAwMCk7IC8vIGxpbmUgbnVtYmVyCiAgICBoYXNoPScnOyAvLyBzdHJpcCBsaW5lIG51bWJlciBhbmNob3JzCiAgICAvL3Jvb3Q9cm9vdC5yZXBsYWNlKC9fc291cmNlXC4vLCcuJyk7IC8vIHNvdXJjZSBsaW5rIHRvIGRvYyBsaW5rCiAgfQogIHZhciB1cmw9cm9vdCtoYXNoOwogIHZhciBpPS0xOwogIHdoaWxlIChOQVZUUkVFSU5ERVhbaSsxXTw9dXJsKSBpKys7CiAgaWYgKGk9PS0xKSB7IGk9MDsgcm9vdD1OQVZUUkVFWzBdWzFdOyB9IC8vIGZhbGxiYWNrOiBzaG93IGluZGV4CiAgaWYgKG5hdlRyZWVTdWJJbmRpY2VzW2ldKSB7CiAgICBnb3RvTm9kZShvLGkscm9vdCxoYXNoLHJlbHBhdGgpCiAgfSBlbHNlIHsKICAgIGdldFNjcmlwdChyZWxwYXRoKyduYXZ0cmVlaW5kZXgnK2ksZnVuY3Rpb24oKXsKICAgICAgbmF2VHJlZVN1YkluZGljZXNbaV0gPSBldmFsKCdOQVZUUkVFSU5ERVgnK2kpOwogICAgICBpZiAobmF2VHJlZVN1YkluZGljZXNbaV0pIHsKICAgICAgICBnb3RvTm9kZShvLGkscm9vdCxoYXNoLHJlbHBhdGgpOwogICAgICB9CiAgICB9LHRydWUpOwogIH0KfQoKZnVuY3Rpb24gc2hvd1N5bmNPZmYobixyZWxwYXRoKQp7CiAgICBuLmh0bWwoJzxpbWcgc3JjPSInK3JlbHBhdGgrJ3N5bmNfb2ZmLnBuZyIgdGl0bGU9IicrU1lOQ09GRk1TRysnIi8+Jyk7Cn0KCmZ1bmN0aW9uIHNob3dTeW5jT24obixyZWxwYXRoKQp7CiAgICBuLmh0bWwoJzxpbWcgc3JjPSInK3JlbHBhdGgrJ3N5bmNfb24ucG5nIiB0aXRsZT0iJytTWU5DT05NU0crJyIvPicpOwp9CgpmdW5jdGlvbiB0b2dnbGVTeW5jQnV0dG9uKHJlbHBhdGgpCnsKICB2YXIgbmF2U3luYyA9ICQoJyNuYXYtc3luYycpOwogIGlmIChuYXZTeW5jLmhhc0NsYXNzKCdzeW5jJykpIHsKICAgIG5hdlN5bmMucmVtb3ZlQ2xhc3MoJ3N5bmMnKTsKICAgIHNob3dTeW5jT2ZmKG5hdlN5bmMscmVscGF0aCk7CiAgICBzdG9yZUxpbmsoc3RyaXBQYXRoMigkKGxvY2F0aW9uKS5hdHRyKCdwYXRobmFtZScpKSskKGxvY2F0aW9uKS5hdHRyKCdoYXNoJykpOwogIH0gZWxzZSB7CiAgICBuYXZTeW5jLmFkZENsYXNzKCdzeW5jJyk7CiAgICBzaG93U3luY09uKG5hdlN5bmMscmVscGF0aCk7CiAgICBkZWxldGVMaW5rKCk7CiAgfQp9CgpmdW5jdGlvbiBpbml0TmF2VHJlZSh0b3Jvb3QscmVscGF0aCkKewogIHZhciBvID0gbmV3IE9iamVjdCgpOwogIG8udG9yb290ID0gdG9yb290OwogIG8ubm9kZSA9IG5ldyBPYmplY3QoKTsKICBvLm5vZGUubGkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibmF2LXRyZWUtY29udGVudHMiKTsKICBvLm5vZGUuY2hpbGRyZW5EYXRhID0gTkFWVFJFRTsKICBvLm5vZGUuY2hpbGRyZW4gPSBuZXcgQXJyYXkoKTsKICBvLm5vZGUuY2hpbGRyZW5VTCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInVsIik7CiAgby5ub2RlLmdldENoaWxkcmVuVUwgPSBmdW5jdGlvbigpIHsgcmV0dXJuIG8ubm9kZS5jaGlsZHJlblVMOyB9OwogIG8ubm9kZS5saS5hcHBlbmRDaGlsZChvLm5vZGUuY2hpbGRyZW5VTCk7CiAgby5ub2RlLmRlcHRoID0gMDsKICBvLm5vZGUucmVscGF0aCA9IHJlbHBhdGg7CiAgby5ub2RlLmV4cGFuZGVkID0gZmFsc2U7CiAgby5ub2RlLmlzTGFzdCA9IHRydWU7CiAgby5ub2RlLnBsdXNfaW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7CiAgby5ub2RlLnBsdXNfaW1nLnNyYyA9IHJlbHBhdGgrImZ0djJwbm9kZS5wbmciOwogIG8ubm9kZS5wbHVzX2ltZy53aWR0aCA9IDE2OwogIG8ubm9kZS5wbHVzX2ltZy5oZWlnaHQgPSAyMjsKCiAgaWYgKGxvY2FsU3RvcmFnZVN1cHBvcnRlZCgpKSB7CiAgICB2YXIgbmF2U3luYyA9ICQoJyNuYXYtc3luYycpOwogICAgaWYgKGNhY2hlZExpbmsoKSkgewogICAgICBzaG93U3luY09mZihuYXZTeW5jLHJlbHBhdGgpOwogICAgICBuYXZTeW5jLnJlbW92ZUNsYXNzKCdzeW5jJyk7CiAgICB9IGVsc2UgewogICAgICBzaG93U3luY09uKG5hdlN5bmMscmVscGF0aCk7CiAgICB9CiAgICBuYXZTeW5jLmNsaWNrKGZ1bmN0aW9uKCl7IHRvZ2dsZVN5bmNCdXR0b24ocmVscGF0aCk7IH0pOwogIH0KCiAgbmF2VG8obyx0b3Jvb3Qsd2luZG93LmxvY2F0aW9uLmhhc2gscmVscGF0aCk7CgogICQod2luZG93KS5iaW5kKCdoYXNoY2hhbmdlJywgZnVuY3Rpb24oKXsKICAgICBpZiAod2luZG93LmxvY2F0aW9uLmhhc2ggJiYgd2luZG93LmxvY2F0aW9uLmhhc2gubGVuZ3RoPjEpewogICAgICAgdmFyIGE7CiAgICAgICBpZiAoJChsb2NhdGlvbikuYXR0cignaGFzaCcpKXsKICAgICAgICAgdmFyIGNsc2xpbms9c3RyaXBQYXRoKCQobG9jYXRpb24pLmF0dHIoJ3BhdGhuYW1lJykpKyc6JysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQobG9jYXRpb24pLmF0dHIoJ2hhc2gnKS5zdWJzdHJpbmcoMSk7CiAgICAgICAgIGE9JCgnLml0ZW0gYVtjbGFzcyQ9IicrY2xzbGluaysnIl0nKTsKICAgICAgIH0KICAgICAgIGlmIChhPT1udWxsIHx8ICEkKGEpLnBhcmVudCgpLnBhcmVudCgpLmhhc0NsYXNzKCdzZWxlY3RlZCcpKXsKICAgICAgICAgJCgnLml0ZW0nKS5yZW1vdmVDbGFzcygnc2VsZWN0ZWQnKTsKICAgICAgICAgJCgnLml0ZW0nKS5yZW1vdmVBdHRyKCdpZCcpOwogICAgICAgfQogICAgICAgdmFyIGxpbms9c3RyaXBQYXRoMigkKGxvY2F0aW9uKS5hdHRyKCdwYXRobmFtZScpKTsKICAgICAgIG5hdlRvKG8sbGluaywkKGxvY2F0aW9uKS5hdHRyKCdoYXNoJykscmVscGF0aCk7CiAgICAgfSBlbHNlIGlmICghYW5pbWF0aW9uSW5Qcm9ncmVzcykgewogICAgICAgJCgnI2RvYy1jb250ZW50Jykuc2Nyb2xsVG9wKDApOwogICAgICAgJCgnLml0ZW0nKS5yZW1vdmVDbGFzcygnc2VsZWN0ZWQnKTsKICAgICAgICQoJy5pdGVtJykucmVtb3ZlQXR0cignaWQnKTsKICAgICAgIG5hdlRvKG8sdG9yb290LHdpbmRvdy5sb2NhdGlvbi5oYXNoLHJlbHBhdGgpOwogICAgIH0KICB9KQoKICAkKHdpbmRvdykubG9hZChzaG93Um9vdCk7Cn0KCg==",
                "body": "dmFyIE5BVlRSRUUgPQpbCiAgWyAiSFlQRV9wcm9jZXNzaW5nIiwgImluZGV4Lmh0bWwiLCBbCiAgICBbICJEZXByZWNhdGVkIExpc3QiLCAiZGVwcmVjYXRlZC5odG1sIiwgbnVsbCBdLAogICAgWyAiQ2xhc3NlcyIsIG51bGwsIFsKICAgICAgWyAiQ2xhc3MgTGlzdCIsICJhbm5vdGF0ZWQuaHRtbCIsICJhbm5vdGF0ZWQiIF0sCiAgICAgIFsgIkNsYXNzIEluZGV4IiwgImNsYXNzZXMuaHRtbCIsIG51bGwgXSwKICAgICAgWyAiQ2xhc3MgSGllcmFyY2h5IiwgImhpZXJhcmNoeS5odG1sIiwgImhpZXJhcmNoeSIgXSwKICAgICAgWyAiQ2xhc3MgTWVtYmVycyIsICJmdW5jdGlvbnMuaHRtbCIsIFsKICAgICAgICBbICJBbGwiLCAiZnVuY3Rpb25zLmh0bWwiLCBudWxsIF0sCiAgICAgICAgWyAiRnVuY3Rpb25zIiwgImZ1bmN0aW9uc19mdW5jLmh0bWwiLCBudWxsIF0sCiAgICAgICAgWyAiVmFyaWFibGVzIiwgImZ1bmN0aW9uc192YXJzLmh0bWwiLCBudWxsIF0KICAgICAgXSBdCiAgICBdIF0KICBdIF0KXTsKCnZhciBOQVZUUkVFSU5ERVggPQpbCiIuaHRtbCIsCiJjbGFzc2h5cGVfMV8xY29yZV8xXzFkcmF3YWJsZV8xXzFfaF9kcmF3YWJsZS5odG1sI2FlZWYxYzE5MGYzODM1NjI5MTAxMDdiZThlNWY4MDQ2MSIsCiJjbGFzc2h5cGVfMV8xZXh0ZW5kZWRfMV8xYmVoYXZpb3JfMV8xX2hfcmFuZG9tX3RyaWdnZXIuaHRtbCIsCiJjbGFzc2h5cGVfMV8xZXh0ZW5kZWRfMV8xZHJhd2FibGVfMV8xX2hfZWxsaXBzZS5odG1sI2FlY2E5M2NlMmYxZDcwZjkzNzBiYjIxZmFiODE3NWQyZiIsCiJpbnRlcmZhY2VoeXBlXzFfMWNvcmVfMV8xaW50ZXJmYWNlc18xXzFfaF9pbWFnZV9ob2xkZXIuaHRtbCIKXTsKCnZhciBTWU5DT05NU0cgPSAnY2xpY2sgdG8gZGlzYWJsZSBwYW5lbCBzeW5jaHJvbmlzYXRpb24nOwp2YXIgU1lOQ09GRk1TRyA9ICdjbGljayB0byBlbmFibGUgcGFuZWwgc3luY2hyb25pc2F0aW9uJzsKdmFyIG5hdlRyZWVTdWJJbmRpY2VzID0gbmV3IEFycmF5KCk7CgpmdW5jdGlvbiBnZXREYXRhKHZhck5hbWUpCnsKICB2YXIgaSA9IHZhck5hbWUubGFzdEluZGV4T2YoJy8nKTsKICB2YXIgbiA9IGk+PTAgPyB2YXJOYW1lLnN1YnN0cmluZyhpKzEpIDogdmFyTmFtZTsKICByZXR1cm4gZXZhbChuLnJlcGxhY2UoL1wtL2csJ18nKSk7Cn0KCmZ1bmN0aW9uIHN0cmlwUGF0aCh1cmkpCnsKICByZXR1cm4gdXJpLnN1YnN0cmluZyh1cmkubGFzdEluZGV4T2YoJy8nKSsxKTsKfQoKZnVuY3Rpb24gc3RyaXBQYXRoMih1cmkpCnsKICB2YXIgaSA9IHVyaS5sYXN0SW5kZXhPZignLycpOwogIHZhciBzID0gdXJpLnN1YnN0cmluZyhpKzEpOwogIHZhciBtID0gdXJpLnN1YnN0cmluZygwLGkrMSkubWF0Y2goL1wvZFx3XC9kXHdcd1wvJC8pOwogIHJldHVybiBtID8gdXJpLnN1YnN0cmluZyhpLTYpIDogczsKfQoKZnVuY3Rpb24gbG9jYWxTdG9yYWdlU3VwcG9ydGVkKCkKewogIHRyeSB7CiAgICByZXR1cm4gJ2xvY2FsU3RvcmFnZScgaW4gd2luZG93ICYmIHdpbmRvd1snbG9jYWxTdG9yYWdlJ10gIT09IG51bGwgJiYgd2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtOwogIH0KICBjYXRjaChlKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQp9CgoKZnVuY3Rpb24gc3RvcmVMaW5rKGxpbmspCnsKICBpZiAoISQoIiNuYXYtc3luYyIpLmhhc0NsYXNzKCdzeW5jJykgJiYgbG9jYWxTdG9yYWdlU3VwcG9ydGVkKCkpIHsKICAgICAgd2luZG93LmxvY2FsU3RvcmFnZS5zZXRJdGVtKCduYXZwYXRoJyxsaW5rKTsKICB9Cn0KCmZ1bmN0aW9uIGRlbGV0ZUxpbmsoKQp7CiAgaWYgKGxvY2FsU3RvcmFnZVN1cHBvcnRlZCgpKSB7CiAgICB3aW5kb3cubG9jYWxTdG9yYWdlLnNldEl0ZW0oJ25hdnBhdGgnLCcnKTsKICB9IAp9CgpmdW5jdGlvbiBjYWNoZWRMaW5rKCkKewogIGlmIChsb2NhbFN0b3JhZ2VTdXBwb3J0ZWQoKSkgewogICAgcmV0dXJuIHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbmF2cGF0aCcpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gJyc7CiAgfQp9CgpmdW5jdGlvbiBnZXRTY3JpcHQoc2NyaXB0TmFtZSxmdW5jLHNob3cpCnsKICB2YXIgaGVhZCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF07IAogIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKICBzY3JpcHQuaWQgPSBzY3JpcHROYW1lOwogIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7CiAgc2NyaXB0Lm9ubG9hZCA9IGZ1bmM7IAogIHNjcmlwdC5zcmMgPSBzY3JpcHROYW1lKycuanMnOyAKICBpZiAoJC5icm93c2VyLm1zaWUgJiYgJC5icm93c2VyLnZlcnNpb248PTgpIHsgCiAgICAvLyBzY3JpcHQub25sb2FkIGRvZXMgbm90IHdvcmsgd2l0aCBvbGRlciB2ZXJzaW9ucyBvZiBJRQogICAgc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICBpZiAoc2NyaXB0LnJlYWR5U3RhdGU9PSdjb21wbGV0ZScgfHwgc2NyaXB0LnJlYWR5U3RhdGU9PSdsb2FkZWQnKSB7IAogICAgICAgIGZ1bmMoKTsgaWYgKHNob3cpIHNob3dSb290KCk7IAogICAgICB9CiAgICB9CiAgfQogIGhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTsgCn0KCmZ1bmN0aW9uIGNyZWF0ZUluZGVudChvLGRvbU5vZGUsbm9kZSxsZXZlbCkKewogIHZhciBsZXZlbD0tMTsKICB2YXIgbiA9IG5vZGU7CiAgd2hpbGUgKG4ucGFyZW50Tm9kZSkgeyBsZXZlbCsrOyBuPW4ucGFyZW50Tm9kZTsgfQogIHZhciBpbWdOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW1nIik7CiAgaW1nTm9kZS5zdHlsZS5wYWRkaW5nTGVmdD0oMTYqbGV2ZWwpLnRvU3RyaW5nKCkrJ3B4JzsKICBpbWdOb2RlLndpZHRoICA9IDE2OwogIGltZ05vZGUuaGVpZ2h0ID0gMjI7CiAgaW1nTm9kZS5ib3JkZXIgPSAwOwogIGlmIChub2RlLmNoaWxkcmVuRGF0YSkgewogICAgbm9kZS5wbHVzX2ltZyA9IGltZ05vZGU7CiAgICBub2RlLmV4cGFuZFRvZ2dsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgIG5vZGUuZXhwYW5kVG9nZ2xlLmhyZWYgPSAiamF2YXNjcmlwdDp2b2lkKDApIjsKICAgIG5vZGUuZXhwYW5kVG9nZ2xlLm9uY2xpY2sgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKG5vZGUuZXhwYW5kZWQpIHsKICAgICAgICAkKG5vZGUuZ2V0Q2hpbGRyZW5VTCgpKS5zbGlkZVVwKCJmYXN0Iik7CiAgICAgICAgbm9kZS5wbHVzX2ltZy5zcmMgPSBub2RlLnJlbHBhdGgrImZ0djJwbm9kZS5wbmciOwogICAgICAgIG5vZGUuZXhwYW5kZWQgPSBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBleHBhbmROb2RlKG8sIG5vZGUsIGZhbHNlLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KICAgIG5vZGUuZXhwYW5kVG9nZ2xlLmFwcGVuZENoaWxkKGltZ05vZGUpOwogICAgZG9tTm9kZS5hcHBlbmRDaGlsZChub2RlLmV4cGFuZFRvZ2dsZSk7CiAgICBpbWdOb2RlLnNyYyA9IG5vZGUucmVscGF0aCsiZnR2MnBub2RlLnBuZyI7CiAgfSBlbHNlIHsKICAgIGltZ05vZGUuc3JjID0gbm9kZS5yZWxwYXRoKyJmdHYybm9kZS5wbmciOwogICAgZG9tTm9kZS5hcHBlbmRDaGlsZChpbWdOb2RlKTsKICB9IAp9Cgp2YXIgYW5pbWF0aW9uSW5Qcm9ncmVzcyA9IGZhbHNlOwoKZnVuY3Rpb24gZ290b0FuY2hvcihhbmNob3IsYW5hbWUsdXBkYXRlTG9jYXRpb24pCnsKICB2YXIgcG9zLCBkb2NDb250ZW50ID0gJCgnI2RvYy1jb250ZW50Jyk7CiAgaWYgKGFuY2hvci5wYXJlbnQoKS5hdHRyKCdjbGFzcycpPT0nbWVtSXRlbUxlZnQnIHx8CiAgICAgIGFuY2hvci5wYXJlbnQoKS5hdHRyKCdjbGFzcycpPT0nZmllbGR0eXBlJyB8fAogICAgICBhbmNob3IucGFyZW50KCkuaXMoJzpoZWFkZXInKSkgCiAgewogICAgcG9zID0gYW5jaG9yLnBhcmVudCgpLnBvc2l0aW9uKCkudG9wOwogIH0gZWxzZSBpZiAoYW5jaG9yLnBvc2l0aW9uKCkpIHsKICAgIHBvcyA9IGFuY2hvci5wb3NpdGlvbigpLnRvcDsKICB9CiAgaWYgKHBvcykgewogICAgdmFyIGRpc3QgPSBNYXRoLmFicyhNYXRoLm1pbigKICAgICAgICAgICAgICAgcG9zLWRvY0NvbnRlbnQub2Zmc2V0KCkudG9wLAogICAgICAgICAgICAgICBkb2NDb250ZW50WzBdLnNjcm9sbEhlaWdodC0KICAgICAgICAgICAgICAgZG9jQ29udGVudC5oZWlnaHQoKS1kb2NDb250ZW50LnNjcm9sbFRvcCgpKSk7CiAgICBhbmltYXRpb25JblByb2dyZXNzPXRydWU7CiAgICBkb2NDb250ZW50LmFuaW1hdGUoewogICAgICBzY3JvbGxUb3A6IHBvcyArIGRvY0NvbnRlbnQuc2Nyb2xsVG9wKCkgLSBkb2NDb250ZW50Lm9mZnNldCgpLnRvcAogICAgfSxNYXRoLm1heCg1MCxNYXRoLm1pbig1MDAsZGlzdCkpLGZ1bmN0aW9uKCl7CiAgICAgIGlmICh1cGRhdGVMb2NhdGlvbikgd2luZG93LmxvY2F0aW9uLmhyZWY9YW5hbWU7CiAgICAgIGFuaW1hdGlvbkluUHJvZ3Jlc3M9ZmFsc2U7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIG5ld05vZGUobywgcG8sIHRleHQsIGxpbmssIGNoaWxkcmVuRGF0YSwgbGFzdE5vZGUpCnsKICB2YXIgbm9kZSA9IG5ldyBPYmplY3QoKTsKICBub2RlLmNoaWxkcmVuID0gQXJyYXkoKTsKICBub2RlLmNoaWxkcmVuRGF0YSA9IGNoaWxkcmVuRGF0YTsKICBub2RlLmRlcHRoID0gcG8uZGVwdGggKyAxOwogIG5vZGUucmVscGF0aCA9IHBvLnJlbHBhdGg7CiAgbm9kZS5pc0xhc3QgPSBsYXN0Tm9kZTsKCiAgbm9kZS5saSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CiAgcG8uZ2V0Q2hpbGRyZW5VTCgpLmFwcGVuZENoaWxkKG5vZGUubGkpOwogIG5vZGUucGFyZW50Tm9kZSA9IHBvOwoKICBub2RlLml0ZW1EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICBub2RlLml0ZW1EaXYuY2xhc3NOYW1lID0gIml0ZW0iOwoKICBub2RlLmxhYmVsU3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICBub2RlLmxhYmVsU3Bhbi5jbGFzc05hbWUgPSAibGFiZWwiOwoKICBjcmVhdGVJbmRlbnQobyxub2RlLml0ZW1EaXYsbm9kZSwwKTsKICBub2RlLml0ZW1EaXYuYXBwZW5kQ2hpbGQobm9kZS5sYWJlbFNwYW4pOwogIG5vZGUubGkuYXBwZW5kQ2hpbGQobm9kZS5pdGVtRGl2KTsKCiAgdmFyIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgbm9kZS5sYWJlbFNwYW4uYXBwZW5kQ2hpbGQoYSk7CiAgbm9kZS5sYWJlbCA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpOwogIG5vZGUuZXhwYW5kZWQgPSBmYWxzZTsKICBhLmFwcGVuZENoaWxkKG5vZGUubGFiZWwpOwogIGlmIChsaW5rKSB7CiAgICB2YXIgdXJsOwogICAgaWYgKGxpbmsuc3Vic3RyaW5nKDAsMSk9PSdeJykgewogICAgICB1cmwgPSBsaW5rLnN1YnN0cmluZygxKTsKICAgICAgbGluayA9IHVybDsKICAgIH0gZWxzZSB7CiAgICAgIHVybCA9IG5vZGUucmVscGF0aCtsaW5rOwogICAgfQogICAgYS5jbGFzc05hbWUgPSBzdHJpcFBhdGgobGluay5yZXBsYWNlKCcjJywnOicpKTsKICAgIGlmIChsaW5rLmluZGV4T2YoJyMnKSE9LTEpIHsKICAgICAgdmFyIGFuYW1lID0gJyMnK2xpbmsuc3BsaXQoJyMnKVsxXTsKICAgICAgdmFyIHNyY1BhZ2UgPSBzdHJpcFBhdGgoJChsb2NhdGlvbikuYXR0cigncGF0aG5hbWUnKSk7CiAgICAgIHZhciB0YXJnZXRQYWdlID0gc3RyaXBQYXRoKGxpbmsuc3BsaXQoJyMnKVswXSk7CiAgICAgIGEuaHJlZiA9IHNyY1BhZ2UhPXRhcmdldFBhZ2UgPyB1cmwgOiAiamF2YXNjcmlwdDp2b2lkKDApIjsgCiAgICAgIGEub25jbGljayA9IGZ1bmN0aW9uKCl7CiAgICAgICAgc3RvcmVMaW5rKGxpbmspOwogICAgICAgIGlmICghJChhKS5wYXJlbnQoKS5wYXJlbnQoKS5oYXNDbGFzcygnc2VsZWN0ZWQnKSkKICAgICAgICB7CiAgICAgICAgICAkKCcuaXRlbScpLnJlbW92ZUNsYXNzKCdzZWxlY3RlZCcpOwogICAgICAgICAgJCgnLml0ZW0nKS5yZW1vdmVBdHRyKCdpZCcpOwogICAgICAgICAgJChhKS5wYXJlbnQoKS5wYXJlbnQoKS5hZGRDbGFzcygnc2VsZWN0ZWQnKTsKICAgICAgICAgICQoYSkucGFyZW50KCkucGFyZW50KCkuYXR0cignaWQnLCdzZWxlY3RlZCcpOwogICAgICAgIH0KICAgICAgICB2YXIgYW5jaG9yID0gJChhbmFtZSk7CiAgICAgICAgZ290b0FuY2hvcihhbmNob3IsYW5hbWUsdHJ1ZSk7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBhLmhyZWYgPSB1cmw7CiAgICAgIGEub25jbGljayA9IGZ1bmN0aW9uKCkgeyBzdG9yZUxpbmsobGluayk7IH0KICAgIH0KICB9IGVsc2UgewogICAgaWYgKGNoaWxkcmVuRGF0YSAhPSBudWxsKSAKICAgIHsKICAgICAgYS5jbGFzc05hbWUgPSAibm9saW5rIjsKICAgICAgYS5ocmVmID0gImphdmFzY3JpcHQ6dm9pZCgwKSI7CiAgICAgIGEub25jbGljayA9IG5vZGUuZXhwYW5kVG9nZ2xlLm9uY2xpY2s7CiAgICB9CiAgfQoKICBub2RlLmNoaWxkcmVuVUwgPSBudWxsOwogIG5vZGUuZ2V0Q2hpbGRyZW5VTCA9IGZ1bmN0aW9uKCkgewogICAgaWYgKCFub2RlLmNoaWxkcmVuVUwpIHsKICAgICAgbm9kZS5jaGlsZHJlblVMID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidWwiKTsKICAgICAgbm9kZS5jaGlsZHJlblVMLmNsYXNzTmFtZSA9ICJjaGlsZHJlbl91bCI7CiAgICAgIG5vZGUuY2hpbGRyZW5VTC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICBub2RlLmxpLmFwcGVuZENoaWxkKG5vZGUuY2hpbGRyZW5VTCk7CiAgICB9CiAgICByZXR1cm4gbm9kZS5jaGlsZHJlblVMOwogIH07CgogIHJldHVybiBub2RlOwp9CgpmdW5jdGlvbiBzaG93Um9vdCgpCnsKICB2YXIgaGVhZGVySGVpZ2h0ID0gJCgiI3RvcCIpLmhlaWdodCgpOwogIHZhciBmb290ZXJIZWlnaHQgPSAkKCIjbmF2LXBhdGgiKS5oZWlnaHQoKTsKICB2YXIgd2luZG93SGVpZ2h0ID0gJCh3aW5kb3cpLmhlaWdodCgpIC0gaGVhZGVySGVpZ2h0IC0gZm9vdGVySGVpZ2h0OwogIChmdW5jdGlvbiAoKXsgLy8gcmV0cnkgdW50aWwgd2UgY2FuIHNjcm9sbCB0byB0aGUgc2VsZWN0ZWQgaXRlbQogICAgdHJ5IHsKICAgICAgdmFyIG5hdnRyZWU9JCgnI25hdi10cmVlJyk7CiAgICAgIG5hdnRyZWUuc2Nyb2xsVG8oJyNzZWxlY3RlZCcsMCx7b2Zmc2V0Oi13aW5kb3dIZWlnaHQvMn0pOwogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHNldFRpbWVvdXQoYXJndW1lbnRzLmNhbGxlZSwgMCk7CiAgICB9CiAgfSkoKTsKfQoKZnVuY3Rpb24gZXhwYW5kTm9kZShvLCBub2RlLCBpbW0sIHNob3dSb290KQp7CiAgaWYgKG5vZGUuY2hpbGRyZW5EYXRhICYmICFub2RlLmV4cGFuZGVkKSB7CiAgICBpZiAodHlwZW9mKG5vZGUuY2hpbGRyZW5EYXRhKT09PSdzdHJpbmcnKSB7CiAgICAgIHZhciB2YXJOYW1lICAgID0gbm9kZS5jaGlsZHJlbkRhdGE7CiAgICAgIGdldFNjcmlwdChub2RlLnJlbHBhdGgrdmFyTmFtZSxmdW5jdGlvbigpewogICAgICAgIG5vZGUuY2hpbGRyZW5EYXRhID0gZ2V0RGF0YSh2YXJOYW1lKTsKICAgICAgICBleHBhbmROb2RlKG8sIG5vZGUsIGltbSwgc2hvd1Jvb3QpOwogICAgICB9LCBzaG93Um9vdCk7CiAgICB9IGVsc2UgewogICAgICBpZiAoIW5vZGUuY2hpbGRyZW5WaXNpdGVkKSB7CiAgICAgICAgZ2V0Tm9kZShvLCBub2RlKTsKICAgICAgfSBpZiAoaW1tIHx8ICgkLmJyb3dzZXIubXNpZSAmJiAkLmJyb3dzZXIudmVyc2lvbj44KSkgeyAKICAgICAgICAvLyBzb21laG93IHNsaWRlRG93biBqdW1wcyB0byB0aGUgc3RhcnQgb2YgdHJlZSBmb3IgSUU5IDotKAogICAgICAgICQobm9kZS5nZXRDaGlsZHJlblVMKCkpLnNob3coKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAkKG5vZGUuZ2V0Q2hpbGRyZW5VTCgpKS5zbGlkZURvd24oImZhc3QiKTsKICAgICAgfQogICAgICBpZiAobm9kZS5pc0xhc3QpIHsKICAgICAgICBub2RlLnBsdXNfaW1nLnNyYyA9IG5vZGUucmVscGF0aCsiZnR2Mm1sYXN0bm9kZS5wbmciOwogICAgICB9IGVsc2UgewogICAgICAgIG5vZGUucGx1c19pbWcuc3JjID0gbm9kZS5yZWxwYXRoKyJmdHYybW5vZGUucG5nIjsKICAgICAgfQogICAgICBub2RlLmV4cGFuZGVkID0gdHJ1ZTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGdsb3dFZmZlY3QobixkdXJhdGlvbikKewogIG4uYWRkQ2xhc3MoJ2dsb3cnKS5kZWxheShkdXJhdGlvbikucXVldWUoZnVuY3Rpb24obmV4dCl7CiAgICAkKHRoaXMpLnJlbW92ZUNsYXNzKCdnbG93Jyk7bmV4dCgpOwogIH0pOwp9CgpmdW5jdGlvbiBoaWdobGlnaHRBbmNob3IoKQp7CiAgdmFyIGFuYW1lID0gJChsb2NhdGlvbikuYXR0cignaGFzaCcpOwogIHZhciBhbmNob3IgPSAkKGFuYW1lKTsKICBpZiAoYW5jaG9yLnBhcmVudCgpLmF0dHIoJ2NsYXNzJyk9PSdtZW1JdGVtTGVmdCcpewogICAgdmFyIHJvd3MgPSAkKCcubWVtYmVyZGVjbHMgdHJbY2xhc3MkPSInKwogICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaGFzaC5zdWJzdHJpbmcoMSkrJyJdJyk7CiAgICBnbG93RWZmZWN0KHJvd3MuY2hpbGRyZW4oKSwzMDApOyAvLyBtZW1iZXIgd2l0aG91dCBkZXRhaWxzCiAgfSBlbHNlIGlmIChhbmNob3IucGFyZW50cygpLnNsaWNlKDIpLnByb3AoJ3RhZ05hbWUnKT09J1RSJykgewogICAgZ2xvd0VmZmVjdChhbmNob3IucGFyZW50cygnZGl2Lm1lbWl0ZW0nKSwxMDAwKTsgLy8gZW51bSB2YWx1ZQogIH0gZWxzZSBpZiAoYW5jaG9yLnBhcmVudCgpLmF0dHIoJ2NsYXNzJyk9PSdmaWVsZHR5cGUnKXsKICAgIGdsb3dFZmZlY3QoYW5jaG9yLnBhcmVudCgpLnBhcmVudCgpLDEwMDApOyAvLyBzdHJ1Y3QgZmllbGQKICB9IGVsc2UgaWYgKGFuY2hvci5wYXJlbnQoKS5pcygiOmhlYWRlciIpKSB7CiAgICBnbG93RWZmZWN0KGFuY2hvci5wYXJlbnQoKSwxMDAwKTsgLy8gc2VjdGlvbiBoZWFkZXIKICB9IGVsc2UgewogICAgZ2xvd0VmZmVjdChhbmNob3IubmV4dCgpLDEwMDApOyAvLyBub3JtYWwgbWVtYmVyCiAgfQogIGdvdG9BbmNob3IoYW5jaG9yLGFuYW1lLGZhbHNlKTsKfQoKZnVuY3Rpb24gc2VsZWN0QW5kSGlnaGxpZ2h0KGhhc2gsbikKewogIHZhciBhOwogIGlmIChoYXNoKSB7CiAgICB2YXIgbGluaz1zdHJpcFBhdGgoJChsb2NhdGlvbikuYXR0cigncGF0aG5hbWUnKSkrJzonK2hhc2guc3Vic3RyaW5nKDEpOwogICAgYT0kKCcuaXRlbSBhW2NsYXNzJD0iJytsaW5rKyciXScpOwogIH0KICBpZiAoYSAmJiBhLmxlbmd0aCkgewogICAgYS5wYXJlbnQoKS5wYXJlbnQoKS5hZGRDbGFzcygnc2VsZWN0ZWQnKTsKICAgIGEucGFyZW50KCkucGFyZW50KCkuYXR0cignaWQnLCdzZWxlY3RlZCcpOwogICAgaGlnaGxpZ2h0QW5jaG9yKCk7CiAgfSBlbHNlIGlmIChuKSB7CiAgICAkKG4uaXRlbURpdikuYWRkQ2xhc3MoJ3NlbGVjdGVkJyk7CiAgICAkKG4uaXRlbURpdikuYXR0cignaWQnLCdzZWxlY3RlZCcpOwogIH0KICBpZiAoJCgnI25hdi10cmVlLWNvbnRlbnRzIC5pdGVtOmZpcnN0JykuaGFzQ2xhc3MoJ3NlbGVjdGVkJykpIHsKICAgICQoJyNuYXYtc3luYycpLmNzcygndG9wJywnMzBweCcpOwogIH0gZWxzZSB7CiAgICAkKCcjbmF2LXN5bmMnKS5jc3MoJ3RvcCcsJzVweCcpOwogIH0KICBzaG93Um9vdCgpOwp9CgpmdW5jdGlvbiBzaG93Tm9kZShvLCBub2RlLCBpbmRleCwgaGFzaCkKewogIGlmIChub2RlICYmIG5vZGUuY2hpbGRyZW5EYXRhKSB7CiAgICBpZiAodHlwZW9mKG5vZGUuY2hpbGRyZW5EYXRhKT09PSdzdHJpbmcnKSB7CiAgICAgIHZhciB2YXJOYW1lICAgID0gbm9kZS5jaGlsZHJlbkRhdGE7CiAgICAgIGdldFNjcmlwdChub2RlLnJlbHBhdGgrdmFyTmFtZSxmdW5jdGlvbigpewogICAgICAgIG5vZGUuY2hpbGRyZW5EYXRhID0gZ2V0RGF0YSh2YXJOYW1lKTsKICAgICAgICBzaG93Tm9kZShvLG5vZGUsaW5kZXgsaGFzaCk7CiAgICAgIH0sdHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICBpZiAoIW5vZGUuY2hpbGRyZW5WaXNpdGVkKSB7CiAgICAgICAgZ2V0Tm9kZShvLCBub2RlKTsKICAgICAgfQogICAgICAkKG5vZGUuZ2V0Q2hpbGRyZW5VTCgpKS5zaG93KCk7CiAgICAgIGlmIChub2RlLmlzTGFzdCkgewogICAgICAgIG5vZGUucGx1c19pbWcuc3JjID0gbm9kZS5yZWxwYXRoKyJmdHYybWxhc3Rub2RlLnBuZyI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbm9kZS5wbHVzX2ltZy5zcmMgPSBub2RlLnJlbHBhdGgrImZ0djJtbm9kZS5wbmciOwogICAgICB9CiAgICAgIG5vZGUuZXhwYW5kZWQgPSB0cnVlOwogICAgICB2YXIgbiA9IG5vZGUuY2hpbGRyZW5bby5icmVhZGNydW1ic1tpbmRleF1dOwogICAgICBpZiAoaW5kZXgrMTxvLmJyZWFkY3J1bWJzLmxlbmd0aCkgewogICAgICAgIHNob3dOb2RlKG8sbixpbmRleCsxLGhhc2gpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICh0eXBlb2Yobi5jaGlsZHJlbkRhdGEpPT09J3N0cmluZycpIHsKICAgICAgICAgIHZhciB2YXJOYW1lID0gbi5jaGlsZHJlbkRhdGE7CiAgICAgICAgICBnZXRTY3JpcHQobi5yZWxwYXRoK3Zhck5hbWUsZnVuY3Rpb24oKXsKICAgICAgICAgICAgbi5jaGlsZHJlbkRhdGEgPSBnZXREYXRhKHZhck5hbWUpOwogICAgICAgICAgICBub2RlLmV4cGFuZGVkPWZhbHNlOwogICAgICAgICAgICBzaG93Tm9kZShvLG5vZGUsaW5kZXgsaGFzaCk7IC8vIHJldHJ5IHdpdGggY2hpbGQgbm9kZSBleHBhbmRlZAogICAgICAgICAgfSx0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHJvb3RCYXNlID0gc3RyaXBQYXRoKG8udG9yb290LnJlcGxhY2UoL1wuLiskLywgJycpKTsKICAgICAgICAgIGlmIChyb290QmFzZT09ImluZGV4IiB8fCByb290QmFzZT09InBhZ2VzIiB8fCByb290QmFzZT09InNlYXJjaCIpIHsKICAgICAgICAgICAgZXhwYW5kTm9kZShvLCBuLCB0cnVlLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICAgIHNlbGVjdEFuZEhpZ2hsaWdodChoYXNoLG4pOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBzZWxlY3RBbmRIaWdobGlnaHQoaGFzaCk7CiAgfQp9CgpmdW5jdGlvbiBnZXROb2RlKG8sIHBvKQp7CiAgcG8uY2hpbGRyZW5WaXNpdGVkID0gdHJ1ZTsKICB2YXIgbCA9IHBvLmNoaWxkcmVuRGF0YS5sZW5ndGgtMTsKICBmb3IgKHZhciBpIGluIHBvLmNoaWxkcmVuRGF0YSkgewogICAgdmFyIG5vZGVEYXRhID0gcG8uY2hpbGRyZW5EYXRhW2ldOwogICAgcG8uY2hpbGRyZW5baV0gPSBuZXdOb2RlKG8sIHBvLCBub2RlRGF0YVswXSwgbm9kZURhdGFbMV0sIG5vZGVEYXRhWzJdLAogICAgICBpPT1sKTsKICB9Cn0KCmZ1bmN0aW9uIGdvdG9Ob2RlKG8sc3ViSW5kZXgscm9vdCxoYXNoLHJlbHBhdGgpCnsKICB2YXIgbnRpID0gbmF2VHJlZVN1YkluZGljZXNbc3ViSW5kZXhdW3Jvb3QraGFzaF07CiAgby5icmVhZGNydW1icyA9ICQuZXh0ZW5kKHRydWUsIFtdLCBudGkgPyBudGkgOiBuYXZUcmVlU3ViSW5kaWNlc1tzdWJJbmRleF1bcm9vdF0pOwogIGlmICghby5icmVhZGNydW1icyAmJiByb290IT1OQVZUUkVFWzBdWzFdKSB7IC8vIGZhbGxiYWNrOiBzaG93IGluZGV4CiAgICBuYXZUbyhvLE5BVlRSRUVbMF1bMV0sIiIscmVscGF0aCk7CiAgICAkKCcuaXRlbScpLnJlbW92ZUNsYXNzKCdzZWxlY3RlZCcpOwogICAgJCgnLml0ZW0nKS5yZW1vdmVBdHRyKCdpZCcpOwogIH0KICBpZiAoby5icmVhZGNydW1icykgewogICAgby5icmVhZGNydW1icy51bnNoaWZ0KDApOyAvLyBhZGQgMCBmb3Igcm9vdCBub2RlCiAgICBzaG93Tm9kZShvLCBvLm5vZGUsIDAsIGhhc2gpOwogIH0KfQoKZnVuY3Rpb24gbmF2VG8obyxyb290LGhhc2gscmVscGF0aCkKewogIHZhciBsaW5rID0gY2FjaGVkTGluaygpOwogIGlmIChsaW5rKSB7CiAgICB2YXIgcGFydHMgPSBsaW5rLnNwbGl0KCcjJyk7CiAgICByb290ID0gcGFydHNbMF07CiAgICBpZiAocGFydHMubGVuZ3RoPjEpIGhhc2ggPSAnIycrcGFydHNbMV07CiAgICBlbHNlIGhhc2g9Jyc7CiAgfQogIGlmIChoYXNoLm1hdGNoKC9eI2xcZCskLykpIHsKICAgIHZhciBhbmNob3I9JCgnYVtuYW1lPScraGFzaC5zdWJzdHJpbmcoMSkrJ10nKTsKICAgIGdsb3dFZmZlY3QoYW5jaG9yLnBhcmVudCgpLDEwMDApOyAvLyBsaW5lIG51bWJlcgogICAgaGFzaD0nJzsgLy8gc3RyaXAgbGluZSBudW1iZXIgYW5jaG9ycwogICAgLy9yb290PXJvb3QucmVwbGFjZSgvX3NvdXJjZVwuLywnLicpOyAvLyBzb3VyY2UgbGluayB0byBkb2MgbGluawogIH0KICB2YXIgdXJsPXJvb3QraGFzaDsKICB2YXIgaT0tMTsKICB3aGlsZSAoTkFWVFJFRUlOREVYW2krMV08PXVybCkgaSsrOwogIGlmIChpPT0tMSkgeyBpPTA7IHJvb3Q9TkFWVFJFRVswXVsxXTsgfSAvLyBmYWxsYmFjazogc2hvdyBpbmRleAogIGlmIChuYXZUcmVlU3ViSW5kaWNlc1tpXSkgewogICAgZ290b05vZGUobyxpLHJvb3QsaGFzaCxyZWxwYXRoKQogIH0gZWxzZSB7CiAgICBnZXRTY3JpcHQocmVscGF0aCsnbmF2dHJlZWluZGV4JytpLGZ1bmN0aW9uKCl7CiAgICAgIG5hdlRyZWVTdWJJbmRpY2VzW2ldID0gZXZhbCgnTkFWVFJFRUlOREVYJytpKTsKICAgICAgaWYgKG5hdlRyZWVTdWJJbmRpY2VzW2ldKSB7CiAgICAgICAgZ290b05vZGUobyxpLHJvb3QsaGFzaCxyZWxwYXRoKTsKICAgICAgfQogICAgfSx0cnVlKTsKICB9Cn0KCmZ1bmN0aW9uIHNob3dTeW5jT2ZmKG4scmVscGF0aCkKewogICAgbi5odG1sKCc8aW1nIHNyYz0iJytyZWxwYXRoKydzeW5jX29mZi5wbmciIHRpdGxlPSInK1NZTkNPRkZNU0crJyIvPicpOwp9CgpmdW5jdGlvbiBzaG93U3luY09uKG4scmVscGF0aCkKewogICAgbi5odG1sKCc8aW1nIHNyYz0iJytyZWxwYXRoKydzeW5jX29uLnBuZyIgdGl0bGU9IicrU1lOQ09OTVNHKyciLz4nKTsKfQoKZnVuY3Rpb24gdG9nZ2xlU3luY0J1dHRvbihyZWxwYXRoKQp7CiAgdmFyIG5hdlN5bmMgPSAkKCcjbmF2LXN5bmMnKTsKICBpZiAobmF2U3luYy5oYXNDbGFzcygnc3luYycpKSB7CiAgICBuYXZTeW5jLnJlbW92ZUNsYXNzKCdzeW5jJyk7CiAgICBzaG93U3luY09mZihuYXZTeW5jLHJlbHBhdGgpOwogICAgc3RvcmVMaW5rKHN0cmlwUGF0aDIoJChsb2NhdGlvbikuYXR0cigncGF0aG5hbWUnKSkrJChsb2NhdGlvbikuYXR0cignaGFzaCcpKTsKICB9IGVsc2UgewogICAgbmF2U3luYy5hZGRDbGFzcygnc3luYycpOwogICAgc2hvd1N5bmNPbihuYXZTeW5jLHJlbHBhdGgpOwogICAgZGVsZXRlTGluaygpOwogIH0KfQoKZnVuY3Rpb24gaW5pdE5hdlRyZWUodG9yb290LHJlbHBhdGgpCnsKICB2YXIgbyA9IG5ldyBPYmplY3QoKTsKICBvLnRvcm9vdCA9IHRvcm9vdDsKICBvLm5vZGUgPSBuZXcgT2JqZWN0KCk7CiAgby5ub2RlLmxpID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm5hdi10cmVlLWNvbnRlbnRzIik7CiAgby5ub2RlLmNoaWxkcmVuRGF0YSA9IE5BVlRSRUU7CiAgby5ub2RlLmNoaWxkcmVuID0gbmV3IEFycmF5KCk7CiAgby5ub2RlLmNoaWxkcmVuVUwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ1bCIpOwogIG8ubm9kZS5nZXRDaGlsZHJlblVMID0gZnVuY3Rpb24oKSB7IHJldHVybiBvLm5vZGUuY2hpbGRyZW5VTDsgfTsKICBvLm5vZGUubGkuYXBwZW5kQ2hpbGQoby5ub2RlLmNoaWxkcmVuVUwpOwogIG8ubm9kZS5kZXB0aCA9IDA7CiAgby5ub2RlLnJlbHBhdGggPSByZWxwYXRoOwogIG8ubm9kZS5leHBhbmRlZCA9IGZhbHNlOwogIG8ubm9kZS5pc0xhc3QgPSB0cnVlOwogIG8ubm9kZS5wbHVzX2ltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwogIG8ubm9kZS5wbHVzX2ltZy5zcmMgPSByZWxwYXRoKyJmdHYycG5vZGUucG5nIjsKICBvLm5vZGUucGx1c19pbWcud2lkdGggPSAxNjsKICBvLm5vZGUucGx1c19pbWcuaGVpZ2h0ID0gMjI7CgogIGlmIChsb2NhbFN0b3JhZ2VTdXBwb3J0ZWQoKSkgewogICAgdmFyIG5hdlN5bmMgPSAkKCcjbmF2LXN5bmMnKTsKICAgIGlmIChjYWNoZWRMaW5rKCkpIHsKICAgICAgc2hvd1N5bmNPZmYobmF2U3luYyxyZWxwYXRoKTsKICAgICAgbmF2U3luYy5yZW1vdmVDbGFzcygnc3luYycpOwogICAgfSBlbHNlIHsKICAgICAgc2hvd1N5bmNPbihuYXZTeW5jLHJlbHBhdGgpOwogICAgfQogICAgbmF2U3luYy5jbGljayhmdW5jdGlvbigpeyB0b2dnbGVTeW5jQnV0dG9uKHJlbHBhdGgpOyB9KTsKICB9CgogIG5hdlRvKG8sdG9yb290LHdpbmRvdy5sb2NhdGlvbi5oYXNoLHJlbHBhdGgpOwoKICAkKHdpbmRvdykuYmluZCgnaGFzaGNoYW5nZScsIGZ1bmN0aW9uKCl7CiAgICAgaWYgKHdpbmRvdy5sb2NhdGlvbi5oYXNoICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoLmxlbmd0aD4xKXsKICAgICAgIHZhciBhOwogICAgICAgaWYgKCQobG9jYXRpb24pLmF0dHIoJ2hhc2gnKSl7CiAgICAgICAgIHZhciBjbHNsaW5rPXN0cmlwUGF0aCgkKGxvY2F0aW9uKS5hdHRyKCdwYXRobmFtZScpKSsnOicrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGxvY2F0aW9uKS5hdHRyKCdoYXNoJykuc3Vic3RyaW5nKDEpOwogICAgICAgICBhPSQoJy5pdGVtIGFbY2xhc3MkPSInK2Nsc2xpbmsrJyJdJyk7CiAgICAgICB9CiAgICAgICBpZiAoYT09bnVsbCB8fCAhJChhKS5wYXJlbnQoKS5wYXJlbnQoKS5oYXNDbGFzcygnc2VsZWN0ZWQnKSl7CiAgICAgICAgICQoJy5pdGVtJykucmVtb3ZlQ2xhc3MoJ3NlbGVjdGVkJyk7CiAgICAgICAgICQoJy5pdGVtJykucmVtb3ZlQXR0cignaWQnKTsKICAgICAgIH0KICAgICAgIHZhciBsaW5rPXN0cmlwUGF0aDIoJChsb2NhdGlvbikuYXR0cigncGF0aG5hbWUnKSk7CiAgICAgICBuYXZUbyhvLGxpbmssJChsb2NhdGlvbikuYXR0cignaGFzaCcpLHJlbHBhdGgpOwogICAgIH0gZWxzZSBpZiAoIWFuaW1hdGlvbkluUHJvZ3Jlc3MpIHsKICAgICAgICQoJyNkb2MtY29udGVudCcpLnNjcm9sbFRvcCgwKTsKICAgICAgICQoJy5pdGVtJykucmVtb3ZlQ2xhc3MoJ3NlbGVjdGVkJyk7CiAgICAgICAkKCcuaXRlbScpLnJlbW92ZUF0dHIoJ2lkJyk7CiAgICAgICBuYXZUbyhvLHRvcm9vdCx3aW5kb3cubG9jYXRpb24uaGFzaCxyZWxwYXRoKTsKICAgICB9CiAgfSkKCiAgJCh3aW5kb3cpLmxvYWQoc2hvd1Jvb3QpOwp9Cgo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 04:14:25 GMT",
                    "Content-Length": "15023",
                    "Date": "Fri, 07 Nov 2014 04:14:32 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}