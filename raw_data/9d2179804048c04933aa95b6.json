{
    "url": "http://localhost:9999/avoidwork/abaaso/src/utility.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location.href</b> and written to <b>the 'href' property of a DOM element</b> via the following statements:<ul><li>uri = !server ? location.href : \"\";</li><li>obj.href = uri;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/avoidwork/abaaso/src/utility.js",
                "path": "/avoidwork/abaaso/src/utility.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9hdm9pZHdvcmsvYWJhYXNvL3NyYy91dGlsaXR5LmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjY4NzgNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMDY6MDQ6MzkgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDA2OjA0OjM5IEdNVA0KDQovKiogQG5hbWVzcGFjZSB1dGlsaXR5ICovCnZhciB1dGlsaXR5ID0gewoJLy8gQ29sbGVjdGlvbiBvZiB0aW1lcnMKCXRpbWVyIDoge30sCgoJLy8gQ29sbGVjdGlvbiBvZiByZXBlYXRpbmcgZnVuY3Rpb25zCglyZXBlYXRpbmc6IHt9LAoKCS8qKgoJICogUXVlcmllcyB0aGUgRE9NIHVzaW5nIENTUyBzZWxlY3RvcnMgYW5kIHJldHVybnMgYW4gRWxlbWVudCBvciBBcnJheSBvZiBFbGVtZW50cwoJICoKCSAqIEBtZXRob2QgJAoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgQ29tbWEgZGVsaW1pdGVkIHN0cmluZyBvZiBDU1Mgc2VsZWN0b3JzCgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgICBFbGVtZW50IG9yIEFycmF5IG9mIEVsZW1lbnRzCgkgKi8KCSQgOiBmdW5jdGlvbiAoIGFyZyApIHsKCQl2YXIgcmVzdWx0OwoKCQlpZiAoICFhcmcgKSB7CgkJCXJldHVybjsKCQl9CgoJCWFyZyA9IHN0cmluZy50cmltKCBhcmcgKTsKCgkJaWYgKCBhcmcuaW5kZXhPZiggIiwiICkgPT09IC0xICkgewoJCQlyZXN1bHQgPSB1dGlsaXR5LmRvbSggYXJnICk7CgkJfQoJCWVsc2UgewoJCQlyZXN1bHQgPSBbXTsKCgkJCWFycmF5LmVhY2goIHN0cmluZy5leHBsb2RlKCBhcmcgKSwgZnVuY3Rpb24gKCBxdWVyeSApIHsKCQkJCXZhciBvYmogPSB1dGlsaXR5LmRvbSggcXVlcnkgKTsKCgkJCQlpZiAoIG9iaiBpbnN0YW5jZW9mIEFycmF5ICkgewoJCQkJCXJlc3VsdCA9IHJlc3VsdC5jb25jYXQoIG9iaiApOwoJCQkJfQoJCQkJZWxzZSBpZiAoIG9iaiApIHsKCQkJCQlyZXN1bHQucHVzaCggb2JqICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBBbGlhc2VzIG9yaWdpbiBvbnRvIG9iagoJICoKCSAqIEBtZXRob2QgYWxpYXMKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqICAgIE9iamVjdCByZWNlaXZpbmcgYWxpYXNpbmcKCSAqIEBwYXJhbSAge09iamVjdH0gb3JpZ2luIE9iamVjdCBwcm92aWRpbmcgc3RydWN0dXJlIHRvIG9iagoJICogQHJldHVybiB7T2JqZWN0fSAgICAgICAgT2JqZWN0IHJlY2VpdmluZyBhbGlhc2luZwoJICovCglhbGlhcyA6IGZ1bmN0aW9uICggb2JqLCBvcmlnaW4gKSB7CgkJdmFyIG8gPSBvYmosCgkJICAgIHMgPSBvcmlnaW47CgoJCXV0aWxpdHkuaXRlcmF0ZSggcywgZnVuY3Rpb24gKCB2LCBrICkgewoJCQl2YXIgZ2V0dGVyLCBzZXR0ZXI7CgoJCQlpZiAoICEoIHYgaW5zdGFuY2VvZiBSZWdFeHAgKSAmJiB0eXBlb2YgdiA9PT0gImZ1bmN0aW9uIiApIHsKCQkJCW9ba10gPSB2LmJpbmQoIG9ba10gKTsKCQkJfQoJCQllbHNlIGlmICggISh2IGluc3RhbmNlb2YgUmVnRXhwICkgJiYgISh2IGluc3RhbmNlb2YgQXJyYXkgKSAmJiB2IGluc3RhbmNlb2YgT2JqZWN0ICkgewoJCQkJaWYgKCBvW2tdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJb1trXSA9IHt9OwoJCQkJfQoKCQkJCXV0aWxpdHkuYWxpYXMoIG9ba10sIHNba10gKTsKCQkJfQoJCQllbHNlIHsKCQkJCWdldHRlciA9IGZ1bmN0aW9uICgpIHsKCQkJCQlyZXR1cm4gc1trXTsKCQkJCX07CgoJCQkJc2V0dGVyID0gZnVuY3Rpb24gKCBhcmcgKSB7CgkJCQkJc1trXSA9IGFyZzsKCQkJCX07CgoJCQkJdXRpbGl0eS5wcm9wZXJ0eSggbywgaywge2VudW1lcmFibGU6IHRydWUsIGdldDogZ2V0dGVyLCBzZXQ6IHNldHRlciwgdmFsdWU6IHNba119ICk7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBDbGVhcnMgZGVmZXJyZWQgJiByZXBlYXRpbmcgZnVuY3Rpb25zCgkgKgoJICogQG1ldGhvZCBjbGVhclRpbWVycwoJICogQHBhcmFtICB7U3RyaW5nfSBpZCBJRCBvZiB0aW1lciggcyApCgkgKiBAcmV0dXJuIHtVbmRlZmluZWR9IHVuZGVmaW5lZAoJICovCgljbGVhclRpbWVycyA6IGZ1bmN0aW9uICggaWQgKSB7CgkJaWYgKCBpZCA9PT0gdW5kZWZpbmVkIHx8IHN0cmluZy5pc0VtcHR5KCBpZCApICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmVycm9yLmludmFsaWRBcmd1bWVudHMgKTsKCQl9CgoJCS8vIGRlZmVycmVkCgkJaWYgKCB1dGlsaXR5LnRpbWVyW2lkXSAhPT0gdW5kZWZpbmVkICkgewoJCQljbGVhclRpbWVvdXQoIHV0aWxpdHkudGltZXJbaWRdICk7CgkJCWRlbGV0ZSB1dGlsaXR5LnRpbWVyW2lkXTsKCQl9CgoJCS8vIHJlcGVhdGluZwoJCWlmICggdXRpbGl0eS5yZXBlYXRpbmdbaWRdICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsZWFyVGltZW91dCggdXRpbGl0eS5yZXBlYXRpbmdbaWRdICk7CgkJCWRlbGV0ZSB1dGlsaXR5LnJlcGVhdGluZ1tpZF07CgkJfQoJfSwKCgkvKioKCSAqIENsb25lcyBhbiBPYmplY3QKCSAqCgkgKiBAbWV0aG9kIGNsb25lCgkgKiBAcGFyYW0ge09iamVjdH0gIG9iaiAgICAgT2JqZWN0IHRvIGNsb25lCgkgKiBAcGFyYW0ge0Jvb2xlYW59IHNoYWxsb3cgW09wdGlvbmFsXSBDcmVhdGUgYSBzaGFsbG93IGNsb25lLCB3aGljaCBkb2Vzbid0IG1haW50YWluIHByb3RvdHlwZXMsIGRlZmF1bHQgaXMgYGZhbHNlYAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgQ2xvbmUgb2Ygb2JqCgkgKi8KCWNsb25lIDogZnVuY3Rpb24gKCBvYmosIHNoYWxsb3cgKSB7CgkJdmFyIGNsb25lOwoKCQlpZiAoIHNoYWxsb3cgPT09IHRydWUgKSB7CgkJCXJldHVybiBqc29uLmRlY29kZSgganNvbi5lbmNvZGUoIG9iaiApICk7CgkJfQoJCWVsc2UgaWYgKCAhb2JqIHx8IHJlZ2V4LnByaW1pdGl2ZS50ZXN0KCB0eXBlb2Ygb2JqICkgfHwgKCBvYmogaW5zdGFuY2VvZiBSZWdFeHAgKSApIHsKCQkJcmV0dXJuIG9iajsKCQl9CgkJZWxzZSBpZiAoIG9iaiBpbnN0YW5jZW9mIEFycmF5ICkgewoJCQlyZXR1cm4gb2JqLnNsaWNlKCk7CgkJfQoJCWVsc2UgaWYgKCAhc2VydmVyICYmICFjbGllbnQuaWUgJiYgb2JqIGluc3RhbmNlb2YgRG9jdW1lbnQgKSB7CgkJCXJldHVybiB4bWwuZGVjb2RlKCB4bWwuZW5jb2RlKCBvYmogKSApOwoJCX0KCQllbHNlIGlmICggdHlwZW9mIG9iai5fX3Byb3RvX18gIT09ICJ1bmRlZmluZWQiICkgewoJCQlyZXR1cm4gdXRpbGl0eS5leHRlbmQoIG9iai5fX3Byb3RvX18sIG9iaiApOwoJCX0KCQllbHNlIGlmICggb2JqIGluc3RhbmNlb2YgT2JqZWN0ICkgewoJCQkvLyBJZiBKU09OIGVuY29kaW5nIGZhaWxzIGR1ZSB0byByZWN1cnNpb24sIHRoZSBvcmlnaW5hbCBPYmplY3QgaXMgcmV0dXJuZWQgYmVjYXVzZSBpdCdzIGFzc3VtZWQgdGhpcyBpcyBmb3IgZGVjb3JhdGlvbgoJCQljbG9uZSA9IGpzb24uZW5jb2RlKCBvYmosIHRydWUgKTsKCgkJCWlmICggY2xvbmUgIT09IHVuZGVmaW5lZCApIHsKCQkJCWNsb25lID0ganNvbi5kZWNvZGUoIGNsb25lICk7CgoJCQkJLy8gRGVjb3JhdGluZyBGdW5jdGlvbnMgdGhhdCB3b3VsZCBiZSBsb3N0IHdpdGggSlNPTiBlbmNvZGluZy9kZWNvZGluZwoJCQkJdXRpbGl0eS5pdGVyYXRlKCBvYmosIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCQlpZiAoIHR5cGVvZiB2ID09PSAiZnVuY3Rpb24iICkgewoJCQkJCQljbG9uZVtrXSA9IHY7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQljbG9uZSA9IG9iajsKCQkJfQoKCQkJcmV0dXJuIGNsb25lOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIG9iajsKCQl9Cgl9LAoKCS8qKgoJICogQ29lcmNlcyBhIFN0cmluZyB0byBhIFR5cGUKCSAqCgkgKiBAbWV0aG9kIGNvZXJjZQoJICogQHBhcmFtICB7U3RyaW5nfSB2YWx1ZSBTdHJpbmcgdG8gY29lcmNlCgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgICAgIFByaW1pdGl2ZSB2ZXJzaW9uIG9mIHRoZSBTdHJpbmcKCSAqLwoJY29lcmNlIDogZnVuY3Rpb24gKCB2YWx1ZSApIHsKCQl2YXIgdG1wOwoKCQlpZiAoIHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoJCWVsc2UgaWYgKCB2YWx1ZSA9PT0gInRydWUiICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJZWxzZSBpZiAoIHZhbHVlID09PSAiZmFsc2UiICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWVsc2UgaWYgKCB2YWx1ZSA9PT0gIm51bGwiICkgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgkJZWxzZSBpZiAoIHZhbHVlID09PSAidW5kZWZpbmVkIiApIHsKCQkJcmV0dXJuIHVuZGVmaW5lZDsKCQl9CgkJZWxzZSBpZiAoIHZhbHVlID09PSAiIiApIHsKCQkJcmV0dXJuIHZhbHVlOwoJCX0KCQllbHNlIGlmICggIWlzTmFOKCB0bXAgPSBOdW1iZXIoIHZhbHVlICkgKSApIHsKCQkJcmV0dXJuIHRtcDsKCQl9CgkJZWxzZSBpZiAoIHJlZ2V4Lmpzb25fd3JhcC50ZXN0KCB2YWx1ZSApICkgewoJCQlyZXR1cm4ganNvbi5kZWNvZGUoIHZhbHVlLCB0cnVlICkgfHwgdmFsdWU7CgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gdmFsdWU7CgkJfQoJfSwKCgkvKioKCSAqIFJlY29tcGlsZXMgYSBSZWdFeHAgYnkgcmVmZXJlbmNlCgkgKgoJICogVGhpcyBpcyBpZGVhbCB3aGVuIHlvdSBuZWVkIHRvIHJlY29tcGlsZSBhIHJlZ2V4IGZvciB1c2Ugd2l0aGluIGEgY29uZGl0aW9uYWwgc3RhdGVtZW50CgkgKgoJICogQG1ldGhvZCBjb21waWxlCgkgKiBAcGFyYW0gIHtPYmplY3R9IHJlZ2V4ICAgICBSZWdFeHAKCSAqIEBwYXJhbSAge1N0cmluZ30gcGF0dGVybiAgIFJlZ3VsYXIgZXhwcmVzc2lvbiBwYXR0ZXJuCgkgKiBAcGFyYW0gIHtTdHJpbmd9IG1vZGlmaWVycyBNb2RpZmllcnMgdG8gYXBwbHkgdG8gdGhlIHBhdHRlcm4KCSAqIEByZXR1cm4ge0Jvb2xlYW59ICAgICAgICAgIHRydWUKCSAqLwoJY29tcGlsZSA6IGZ1bmN0aW9uICggcmVnLCBwYXR0ZXJuLCBtb2RpZmllcnMgKSB7CgkJcmVnLmNvbXBpbGUoIHBhdHRlcm4sIG1vZGlmaWVycyApOwoKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGEgQ1NTIHN0eWxlc2hlZXQgaW4gdGhlIFZpZXcKCSAqCgkgKiBAbWV0aG9kIGNzcwoJICogQHBhcmFtICB7U3RyaW5nfSBjb250ZW50IENTUyB0byBwdXQgaW4gYSBzdHlsZSB0YWcKCSAqIEBwYXJhbSAge1N0cmluZ30gbWVkaWEgICBbT3B0aW9uYWxdIE1lZGlhcyB0aGUgc3R5bGVzaGVldCBhcHBsaWVzIHRvCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgICAgRWxlbWVudCBjcmVhdGVkIG9yIHVuZGVmaW5lZAoJICovCgljc3MgOiBmdW5jdGlvbiAoIGNvbnRlbnQsIG1lZGlhICkgewoJCXZhciBzcywgY3NzOwoKCQlzcyA9IGVsZW1lbnQuY3JlYXRlKCAic3R5bGUiLCB7dHlwZTogInRleHQvY3NzIiwgbWVkaWE6IG1lZGlhIHx8ICJwcmludCwgc2NyZWVuIn0sIHV0aWxpdHkuJCggImhlYWQiIClbMF0gKTsKCgkJaWYgKCBzcy5zdHlsZVNoZWV0ICkgewoJCQlzcy5zdHlsZVNoZWV0LmNzc1RleHQgPSBjb250ZW50OwoJCX0KCQllbHNlIHsKCQkJY3NzID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIGNvbnRlbnQgKTsKCQkJc3MuYXBwZW5kQ2hpbGQoIGNzcyApOwoJCX0KCgkJcmV0dXJuIHNzOwoJfSwKCgkvKioKCSAqIERlYm91bmNlcyBhIGZ1bmN0aW9uCgkgKgoJICogQG1ldGhvZCBkZWJvdW5jZQoJICogQHBhcmFtICB7RnVuY3Rpb259IGZuICAgIEZ1bmN0aW9uIHRvIGV4ZWN1dGUKCSAqIEBwYXJhbSAge051bWJlcn0gICBtcyAgICBUaW1lIHRvIHdhaXQgdG8gZXhlY3V0ZSBpbiBtaWxsaXNlY29uZHMsIGRlZmF1bHQgaXMgMTAwMAoJICogQHBhcmFtICB7TWl4ZWR9ICAgIHNjb3BlIGB0aGlzYCBjb250ZXh0IGR1cmluZyBleGVjdXRpb24sIGRlZmF1bHQgaXMgYGdsb2JhbGAKCSAqIEByZXR1cm4ge1VuZGVmaW5lZH0gICAgICB1bmRlZmluZWQKCSAqLwoJZGVib3VuY2UgOiBmdW5jdGlvbiAoIGZuLCBtcywgc2NvcGUgKSB7CgkJbXMgICAgPSBtcyAgICB8fCAxMDAwOwoJCXNjb3BlID0gc2NvcGUgfHwgZ2xvYmFsOwoKCQlyZXR1cm4gZnVuY3Rpb24gZGVib3VuY2VkICgpIHsKCQkJc2V0VGltZW91dCggZnVuY3Rpb24gKCkgewoJCQkJZm4uYXBwbHkoIHNjb3BlLCBhcmd1bWVudHMgKTsKCQkJfSwgbXMpOwoJCX07Cgl9LAoKCS8qKgoJICogQWxsb3dzIGRlZXAgc2V0dGluZyBvZiBwcm9wZXJ0aWVzIHdpdGhvdXQga25vd2luZwoJICogaWYgdGhlIHN0cnVjdHVyZSBpcyB2YWxpZAoJICoKCSAqIEBtZXRob2QgZGVmaW5lCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZ3MgIERvdCBkZWxpbWl0ZWQgc3RyaW5nIG9mIHRoZSBzdHJ1Y3R1cmUKCSAqIEBwYXJhbSAge01peGVkfSAgdmFsdWUgVmFsdWUgdG8gc2V0CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiAgIE9iamVjdCByZWNlaXZpbmcgdmFsdWUKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgT2JqZWN0IHJlY2VpdmluZyB2YWx1ZQoJICovCglkZWZpbmUgOiBmdW5jdGlvbiAoIGFyZ3MsIHZhbHVlLCBvYmogKSB7CgkJYXJncyAgICA9IGFyZ3Muc3BsaXQoICIuIiApOwoJCXZhciBwICAgPSBvYmosCgkJICAgIG50aCA9IGFyZ3MubGVuZ3RoOwoKCQlpZiAoIG9iaiA9PT0gdW5kZWZpbmVkICkgewoJCQlvYmogPSB0aGlzOwoJCX0KCgkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQl2YWx1ZSA9IG51bGw7CgkJfQoKCQlhcnJheS5lYWNoKCBhcmdzLCBmdW5jdGlvbiAoIGksIGlkeCApIHsKCQkJdmFyIG51bSA9IGlkeCArIDEgPCBudGggJiYgIWlzTmFOKCBudW1iZXIucGFyc2UoIGFyZ3NbaWR4ICsgMV0sIDEwICkgKSwKCQkJICAgIHZhbCA9IHZhbHVlOwoKCQkJaWYgKCAhaXNOYU4oIG51bWJlci5wYXJzZSggaSwgMTAgKSApICkgIHsKCQkJCWkgPSBudW1iZXIucGFyc2UoIGksIDEwICk7CgkJCX0KCQkJCgkJCS8vIENyZWF0aW5nIG9yIGNhc3RpbmcKCQkJaWYgKCBwW2ldID09PSB1bmRlZmluZWQgKSB7CgkJCQlwW2ldID0gbnVtID8gW10gOiB7fTsKCQkJfQoJCQllbHNlIGlmICggcFtpXSBpbnN0YW5jZW9mIE9iamVjdCAmJiBudW0gKSB7CgkJCQlwW2ldID0gYXJyYXkuY2FzdCggcFtpXSApOwoJCQl9CgkJCWVsc2UgaWYgKCBwW2ldIGluc3RhbmNlb2YgT2JqZWN0ICkgewoJCQkJLy8gRG8gbm90aGluZwoJCQl9CgkJCWVsc2UgaWYgKCBwW2ldIGluc3RhbmNlb2YgQXJyYXkgJiYgIW51bSApIHsKCQkJCXBbaV0gPSBhcnJheS50b09iamVjdCggcFtpXSApOwoJCQl9CgkJCWVsc2UgewoJCQkJcFtpXSA9IHt9OwoJCQl9CgoJCQkvLyBTZXR0aW5nIHJlZmVyZW5jZSBvciB2YWx1ZQoJCQlpZHggKyAxID09PSBudGggPyBwW2ldID0gdmFsIDogcCA9IHBbaV07CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogRGVmZXJzIHRoZSBleGVjdXRpb24gb2YgRnVuY3Rpb24gYnkgYXQgbGVhc3QgdGhlIHN1cHBsaWVkIG1pbGxpc2Vjb25kcwoJICogVGltaW5nIG1heSB2YXJ5IHVuZGVyICJoZWF2eSBsb2FkIiByZWxhdGl2ZSB0byB0aGUgQ1BVICYgY2xpZW50IEphdmFTY3JpcHQgZW5naW5lCgkgKgoJICogQG1ldGhvZCBkZWZlcgoJICogQHBhcmFtICB7RnVuY3Rpb259IGZuICAgICBGdW5jdGlvbiB0byBkZWZlciBleGVjdXRpb24gb2YKCSAqIEBwYXJhbSAge051bWJlcn0gICBtcyAgICAgTWlsbGlzZWNvbmRzIHRvIGRlZmVyIGV4ZWN1dGlvbgoJICogQHBhcmFtICB7TnVtYmVyfSAgIGlkICAgICBbT3B0aW9uYWxdIElEIG9mIHRoZSBkZWZlcnJlZCBmdW5jdGlvbgoJICogQHBhcmFtICB7Qm9vbGVhbn0gIHJlcGVhdCBbT3B0aW9uYWxdIERlc2NyaWJlcyB0aGUgZXhlY3V0aW9uLCBkZWZhdWx0IGlzIGBmYWxzZWAKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgICAgICAgSUQgb2YgdGhlIHRpbWVyCgkgKi8KCWRlZmVyIDogZnVuY3Rpb24gKCBmbiwgbXMsIGlkLCByZXBlYXQgKSB7CgkJdmFyIG9wOwoKCQltcyAgICAgPSBtcyB8fCAwOwoJCXJlcGVhdCA9ICggcmVwZWF0ID09PSB0cnVlICk7CgoJCWlmICggaWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdXRpbGl0eS5jbGVhclRpbWVycyggaWQgKTsKCQl9CgkJZWxzZSB7CgkJCWlkID0gdXRpbGl0eS51dWlkKCB0cnVlICk7CgkJfQoKCQlvcCA9IGZ1bmN0aW9uICgpIHsKCQkJdXRpbGl0eS5jbGVhclRpbWVycyggaWQgKTsKCQkJZm4oKTsKCQl9OwoKCQl1dGlsaXR5W3JlcGVhdCA/ICJyZXBlYXRpbmciIDogInRpbWVyIl1baWRdID0gc2V0VGltZW91dCggb3AsIG1zICk7CgoJCXJldHVybiBpZDsKCX0sCgoJLyoqCgkgKiBRdWVyaWVzIERPTSB3aXRoIGZhc3Rlc3QgbWV0aG9kCgkgKgoJICogQG1ldGhvZCBkb20KCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnIERPTSBxdWVyeQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgdW5kZWZpbmVkLCBFbGVtZW50LCBvciBBcnJheSBvZiBFbGVtZW50cwoJICovCglkb20gOiBmdW5jdGlvbiAoIGFyZyApIHsKCQl2YXIgcmVzdWx0OwoKCQlpZiAoICFyZWdleC5zZWxlY3Rvcl9jb21wbGV4LnRlc3QoIGFyZyApICkgewoJCQlpZiAoIHJlZ2V4Lmhhc2gudGVzdCggYXJnICkgKSB7CgkJCQlyZXN1bHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggYXJnLnJlcGxhY2UoIHJlZ2V4Lmhhc2gsICIiICkgKSB8fCB1bmRlZmluZWQ7CgkJCX0KCQkJZWxzZSBpZiAoIHJlZ2V4LmtsYXNzLnRlc3QoIGFyZyApICkgewoJCQkJcmVzdWx0ID0gYXJyYXkuY2FzdCggZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSggYXJnLnJlcGxhY2UoIHJlZ2V4LmtsYXNzLCAiIiApICkgKTsKCQkJfQoJCQllbHNlIGlmICggcmVnZXgud29yZC50ZXN0KCBhcmcgKSApIHsKCQkJCXJlc3VsdCA9IGFycmF5LmNhc3QoIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCBhcmcgKSApOwoJCQl9CgkJCWVsc2UgewoJCQkJcmVzdWx0ID0gYXJyYXkuY2FzdCggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCggYXJnICkgKTsKCQkJfQoJCX0KCQllbHNlIHsKCQkJcmVzdWx0ID0gYXJyYXkuY2FzdCggZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCggYXJnICkgKTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogRW5jb2RlcyBhIFVVSUQgdG8gYSBET00gZnJpZW5kbHkgSUQKCSAqCgkgKiBAbWV0aG9kIGRvbUlkCgkgKiBAcGFyYW0gIHtTdHJpbmd9IFVVSUQKCSAqIEByZXR1cm4ge1N0cmluZ30gRE9NIGZyaWVuZGx5IElECgkgKi8KCWRvbUlkIDogZnVuY3Rpb24gKCBhcmcgKSB7CgkJcmV0dXJuICJhIiArIGFyZy5yZXBsYWNlKCAvLS9nLCAiIiApLnNsaWNlKCAxICk7Cgl9LAoKCS8qKgoJICogRXJyb3IgaGFuZGxpbmcsIHdpdGggaGlzdG9yeSBpbiAubG9nCgkgKgoJICogQG1ldGhvZCBlcnJvcgoJICogQHBhcmFtICB7TWl4ZWR9ICAgZSAgICAgICBFcnJvciBvYmplY3Qgb3IgbWVzc2FnZSB0byBkaXNwbGF5CgkgKiBAcGFyYW0gIHtBcnJheX0gICBhcmdzICAgIEFycmF5IG9mIGFyZ3VtZW50cyBmcm9tIHRoZSBjYWxsc3RhY2sKCSAqIEBwYXJhbSAge01peGVkfSAgIHNjb3BlICAgRW50aXR5IHRoYXQgd2FzICJ0aGlzIgoJICogQHBhcmFtICB7Qm9vbGVhbn0gd2FybmluZyBbT3B0aW9uYWxdIFdpbGwgZGlzcGxheSBhcyBjb25zb2xlIHdhcm5pbmcgaWYgdHJ1ZQoJICogQHJldHVybiB7VW5kZWZpbmVkfSAgICAgICB1bmRlZmluZWQKCSAqLwoJZXJyb3IgOiBmdW5jdGlvbiAoIGUsIGFyZ3MsIHNjb3BlLCB3YXJuaW5nICkgewoJCXdhcm5pbmcgPSAoIHdhcm5pbmcgPT09IHRydWUgKTsKCQl2YXIgbyAgID0gewoJCQkiYXJndW1lbnRzIiA6IGFyZ3MgIT09IHVuZGVmaW5lZCA/IGFycmF5LmNhc3QoIGFyZ3MgKSA6IFtdLAoJCQltZXNzYWdlICAgICA6IGUubWVzc2FnZSB8fCBlLAoJCQludW1iZXIgICAgICA6IGUubnVtYmVyICE9PSB1bmRlZmluZWQgPyAoIGUubnVtYmVyICYgMHhGRkZGICkgOiB1bmRlZmluZWQsCgkJCXNjb3BlICAgICAgIDogc2NvcGUsCgkJCXN0YWNrICAgICAgIDogZS5zdGFjayAgIHx8IHVuZGVmaW5lZCwKCQkJdGltZXN0YW1wICAgOiBuZXcgRGF0ZSgpLnRvVVRDU3RyaW5nKCksCgkJCXR5cGUgICAgICAgIDogZS50eXBlICAgIHx8ICJUeXBlRXJyb3IiCgkJfTsKCgkJdXRpbGl0eS5sb2coICggby5zdGFjayB8fCBvLm1lc3NhZ2UgfHwgbyApLCAhd2FybmluZyA/ICJlcnJvciIgOiAid2FybiIgKTsKCQl1dGlsaXR5LmVycm9yLmxvZy5wdXNoKCBvICk7CgkJb2JzZXJ2ZXIuZmlyZSggYWJhYXNvLCAiZXJyb3IiLCBvICk7CgoJCXJldHVybiB1bmRlZmluZWQ7Cgl9LAoKCS8qKgoJICogQ3JlYXRlcyBhICJjbGFzcyIgZXh0ZW5kaW5nIE9iamVjdCwgd2l0aCBvcHRpb25hbCBkZWNvcmF0aW9uCgkgKgoJICogQG1ldGhvZCBleHRlbmQKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqIE9iamVjdCB0byBleHRlbmQKCSAqIEBwYXJhbSAge09iamVjdH0gYXJnIFtPcHRpb25hbF0gT2JqZWN0IGZvciBkZWNvcmF0aW9uCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBEZWNvcmF0ZWQgb2JqCgkgKi8KCWV4dGVuZCA6IGZ1bmN0aW9uICgpIHsKCQlpZiAoIHR5cGVvZiBPYmplY3QuY3JlYXRlID09PSAiZnVuY3Rpb24iICkgewoJCQlyZXR1cm4gZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQkJCXZhciBvOwoKCQkJCWlmICggb2JqID09PSB1bmRlZmluZWQgKSB7CgkJCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5lcnJvci5pbnZhbGlkQXJndW1lbnRzICk7CgkJCQl9CgoJCQkJbyA9IE9iamVjdC5jcmVhdGUoIG9iaiApOwoKCQkJCWlmICggYXJnIGluc3RhbmNlb2YgT2JqZWN0ICkgewoJCQkJCXV0aWxpdHkubWVyZ2UoIG8sIGFyZyApOwoJCQkJfQoKCQkJCXJldHVybiBvOwoJCQl9OwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJCQlmdW5jdGlvbiBFeHRlbmRlZCAoKSB7fQoKCQkJCXZhciBvOwoKCQkJCWlmICggb2JqID09PSB1bmRlZmluZWQgKSB7CgkJCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5lcnJvci5pbnZhbGlkQXJndW1lbnRzICk7CgkJCQl9CgoJCQkJRXh0ZW5kZWQucHJvdG90eXBlID0gb2JqOwoKCQkJCW8gPSBuZXcgRXh0ZW5kZWQoKTsKCgkJCQlpZiAoIGFyZyBpbnN0YW5jZW9mIE9iamVjdCApIHsKCQkJCQl1dGlsaXR5Lm1lcmdlKCBvLCBhcmcgKTsKCQkJCX0KCgkJCQlyZXR1cm4gbzsKCQkJfTsKCQl9Cgl9KCksCgoJLyoqCgkgKiBGaWJvbmFjY2kgY2FsY3VsYXRvcgoJICoKCSAqIEBtZXRob2QgZmliCgkgKiBAcGFyYW0gIHtOdW1iZXJ9ICBpIE51bWJlciB0byBjYWxjdWxhdGUKCSAqIEBwYXJhbSAge0Jvb2xlYW59IHIgUmVjdXJzaXZlIGlmIGB0cnVlYAoJICogQHJldHVybiB7TnVtYmVyfSAgICBDYWxjdWxhdGVkIG51bWJlcgoJICovCglmaWIgOiBmdW5jdGlvbiAoIGksIHIgKSB7CgkJaWYgKCByID09PSB0cnVlICkgewoJCQlyZXR1cm4gaSA+IDEgPyB1dGlsaXR5LmZpYiggaSAtIDEsIHIgKSArIHV0aWxpdHkuZmliKCBpIC0gMiwgciApIDogaTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiBhcnJheS5sYXN0KCBhcnJheS5maWIoIGkgKSApOwoJCX0KCX0sCgoJLyoqCgkgKiBHZW5lcmF0ZXMgYW4gSUQgdmFsdWUKCSAqCgkgKiBAbWV0aG9kIGdlbklkCgkgKiBAcGFyYW0gIHtNaXhlZH0gICBvYmogW09wdGlvbmFsXSBPYmplY3QgdG8gcmVjZWl2ZSBpZAoJICogQHBhcmFtICB7Qm9vbGVhbn0gZG9tIFtPcHRpb25hbF0gVmVyaWZ5IHRoZSBJRCBpcyB1bmlxdWUgaW4gdGhlIERPTSwgZGVmYXVsdCBpcyBmYWxzZQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgIE9iamVjdCBvciBpZAoJICovCglnZW5JZCA6IGZ1bmN0aW9uICggb2JqLCBkb20gKSB7CgkJZG9tID0gKCBkb20gPT09IHRydWUgKTsKCQl2YXIgaWQ7CgoJCWlmICggb2JqICE9PSB1bmRlZmluZWQgJiYgKCAoIG9iai5pZCAhPT0gdW5kZWZpbmVkICYmIG9iai5pZCAhPT0gIiIgKSB8fCAoIG9iaiBpbnN0YW5jZW9mIEFycmF5ICkgfHwgKCBvYmogaW5zdGFuY2VvZiBTdHJpbmcgfHwgdHlwZW9mIG9iaiA9PT0gInN0cmluZyIgKSApICkgewoJCQlyZXR1cm4gb2JqOwoJCX0KCgkJaWYgKCBkb20gKSB7CgkJCWRvIHsKCQkJCWlkID0gdXRpbGl0eS5kb21JZCggdXRpbGl0eS51dWlkKCB0cnVlKSApOwoJCQl9CgkJCXdoaWxlICggdXRpbGl0eS4kKCAiIyIgKyBpZCApICE9PSB1bmRlZmluZWQgKTsKCQl9CgkJZWxzZSB7CgkJCWlkID0gdXRpbGl0eS5kb21JZCggdXRpbGl0eS51dWlkKCB0cnVlKSApOwoJCX0KCgkJaWYgKCB0eXBlb2Ygb2JqID09PSAib2JqZWN0IiApIHsKCQkJb2JqLmlkID0gaWQ7CgoJCQlyZXR1cm4gb2JqOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIGlkOwoJCX0KCX0sCgoJLyoqCgkgKiBHZXR0ZXIgLyBzZXR0ZXIgZm9yIHRoZSBoYXNoYmFuZwoJICoKCSAqIEBtZXRob2QgaGFzaAoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgUm91dGUgdG8gc2V0CgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICBDdXJyZW50IHJvdXRlCgkgKi8KCWhhc2ggOiBmdW5jdGlvbiAoIGFyZyApIHsKCQlpZiAoIGFyZyAhPT0gdW5kZWZpbmVkICkgewoJCQlkb2N1bWVudC5sb2NhdGlvbi5oYXNoID0gYXJnOwoJCX0KCgkJcmV0dXJuIGRvY3VtZW50LmxvY2F0aW9uLmhhc2g7Cgl9LAoKCS8qKgoJICogQ29udmVydHMgUkdCIHRvIEhFWAoJICoKCSAqIEBtZXRob2QgaGV4CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGNvbG9yIFJHQiBhcyBgcmdiKDI1NSwgMjU1LCAyNTUpYCBvciBgMjU1LCAyNTUsIDI1NWAKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgICAgQ29sb3IgYXMgSEVYCgkgKi8KCWhleCA6IGZ1bmN0aW9uICggY29sb3IgKSB7CgkJdmFyIGRpZ2l0cywgcmVkLCBncmVlbiwgYmx1ZSwgcmVzdWx0LCBpLCBudGg7CgoJCWlmICggY29sb3IuY2hhckF0KCAwICkgPT09ICIjIiApIHsKCQkgICAgcmVzdWx0ID0gY29sb3I7CgkJfQoJCWVsc2UgewoJCQlkaWdpdHMgPSBzdHJpbmcuZXhwbG9kZSggY29sb3IucmVwbGFjZSggLy4qXCh8XCkvZywgIiIgKSApOwoJCQlyZWQgICAgPSBudW1iZXIucGFyc2UoIGRpZ2l0c1swXSB8fCAwICk7CgkJCWdyZWVuICA9IG51bWJlci5wYXJzZSggZGlnaXRzWzFdIHx8IDAgKTsKCQkJYmx1ZSAgID0gbnVtYmVyLnBhcnNlKCBkaWdpdHNbMl0gfHwgMCApOwoJCQlyZXN1bHQgPSAoIGJsdWUgfCAoIGdyZWVuIDw8IDggKSB8ICggcmVkIDw8IDE2ICkgKS50b1N0cmluZyggMTYgKTsKCgkJCWlmICggcmVzdWx0Lmxlbmd0aCA8IDYgKSB7CgkJCQludGggPSBudW1iZXIuZGlmZiggcmVzdWx0Lmxlbmd0aCwgNiApOwoJCQkJaSAgID0gLTE7CgoJCQkJd2hpbGUgKCArK2kgPCBudGggKSB7CgkJCQkJcmVzdWx0ID0gIjAiICsgcmVzdWx0OwoJCQkJfQoJCQl9CgoJCQlyZXN1bHQgPSAiIyIgKyByZXN1bHQ7CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIEl0ZXJhdGVzIGFuIE9iamVjdCBhbmQgZXhlY3V0ZXMgYSBmdW5jdGlvbiBhZ2FpbnN0IHRoZSBwcm9wZXJ0aWVzCgkgKgoJICogSXRlcmF0aW9uIGNhbiBiZSBzdG9wcGVkIGJ5IHJldHVybmluZyBmYWxzZSBmcm9tIGZuCgkgKgoJICogQG1ldGhvZCBpdGVyYXRlCgkgKiBAcGFyYW0gIHtPYmplY3R9ICAgb2JqIE9iamVjdCB0byBpdGVyYXRlCgkgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZm4gIEZ1bmN0aW9uIHRvIGV4ZWN1dGUgYWdhaW5zdCBwcm9wZXJ0aWVzCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgIE9iamVjdAoJICovCglpdGVyYXRlIDogZnVuY3Rpb24gKCkgewoJCWlmICggdHlwZW9mIE9iamVjdC5rZXlzID09PSAiZnVuY3Rpb24iICkgewoJCQlyZXR1cm4gZnVuY3Rpb24gKCBvYmosIGZuICkgewoJCQkJaWYgKCB0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIgKSB7CgkJCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5lcnJvci5pbnZhbGlkQXJndW1lbnRzICk7CgkJCQl9CgoJCQkJYXJyYXkuZWFjaCggT2JqZWN0LmtleXMoIG9iaiApLCBmdW5jdGlvbiAoIGkgKSB7CgkJCQkJcmV0dXJuIGZuLmNhbGwoIG9iaiwgb2JqW2ldLCBpICk7CgkJCQl9KTsKCgkJCQlyZXR1cm4gb2JqOwoJCQl9OwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIGZ1bmN0aW9uICggb2JqLCBmbiApIHsKCQkJCXZhciBpLCByZXN1bHQ7CgoJCQkJaWYgKCB0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIgKSB7CgkJCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5lcnJvci5pbnZhbGlkQXJndW1lbnRzICk7CgkJCQl9CgoJCQkJZm9yICggaSBpbiBvYmogKSB7CgkJCQkJaWYgKCBoYXMuY2FsbCggb2JqLCBpICkgKSB7CgkJCQkJCXJlc3VsdCA9IGZuLmNhbGwoIG9iaiwgb2JqW2ldLCBpICk7CgoJCQkJCQlpZiAoIHJlc3VsdCA9PT0gZmFsc2UgKSB7CgkJCQkJCQlicmVhazsKCQkJCQkJfQoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoKCQkJCXJldHVybiBvYmo7CgkJCX07CgkJfQoJfSgpLAoKCS8qKgoJICogUmVuZGVycyBhIGxvYWRpbmcgaWNvbiBpbiBhIHRhcmdldCBlbGVtZW50LAoJICogd2l0aCBhIGNsYXNzIG9mICJsb2FkaW5nIgoJICoKCSAqIEBtZXRob2QgbG9hZGluZwoJICogQHBhcmFtICB7TWl4ZWR9IG9iaiBFbGVtZW50CgkgKiBAcmV0dXJuIHtNaXhlZH0gICAgIEVsZW1lbnQKCSAqLwoJbG9hZGluZyA6IGZ1bmN0aW9uICggb2JqICkgewoJCXZhciBsID0gYWJhYXNvLmxvYWRpbmc7CgoJCWlmICggbC51cmwgPT09IG51bGwgfHwgb2JqID09PSB1bmRlZmluZWQgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuZXJyb3IuaW52YWxpZEFyZ3VtZW50cyApOwoJCX0KCgkJLy8gU2V0dGluZyBsb2FkaW5nIGltYWdlCgkJaWYgKCBsLmltYWdlID09PSB1bmRlZmluZWQgKSB7CgkJCWwuaW1hZ2UgICAgID0gbmV3IEltYWdlKCk7CgkJCWwuaW1hZ2Uuc3JjID0gbC51cmw7CgkJfQoKCQkvLyBDbGVhcmluZyB0YXJnZXQgZWxlbWVudAoJCWVsZW1lbnQuY2xlYXIoIG9iaiApOwoKCQkvLyBDcmVhdGluZyBsb2FkaW5nIGltYWdlIGluIHRhcmdldCBlbGVtZW50CgkJZWxlbWVudC5jcmVhdGUoICJpbWciLCB7YWx0OiBsYWJlbC5jb21tb24ubG9hZGluZywgc3JjOiBsLmltYWdlLnNyY30sIGVsZW1lbnQuY3JlYXRlKCAiZGl2IiwgeyJjbGFzcyI6ICJsb2FkaW5nIn0sIG9iaiApICk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogV3JpdGVzIGFyZ3VtZW50IHRvIHRoZSBjb25zb2xlCgkgKgoJICogQG1ldGhvZCBsb2cKCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnICAgIFN0cmluZyB0byB3cml0ZSB0byB0aGUgY29uc29sZQoJICogQHBhcmFtICB7U3RyaW5nfSB0YXJnZXQgW09wdGlvbmFsXSBUYXJnZXQgY29uc29sZSwgZGVmYXVsdCBpcyAibG9nIgoJICogQHJldHVybiB7VW5kZWZpbmVkfSAgICAgdW5kZWZpbmVkCgkgKi8KCWxvZyA6IGZ1bmN0aW9uICggYXJnLCB0YXJnZXQgKSB7CgkJdmFyIHRzLCBtc2c7CgoJCWlmICggdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICkgewoJCQl0cyAgPSB0eXBlb2YgYXJnICE9PSAib2JqZWN0IjsKCQkJbXNnID0gdHMgPyAiWyIgKyBuZXcgRGF0ZSgpLnRvTG9jYWxlVGltZVN0cmluZygpICsgIl0gIiArIGFyZyA6IGFyZzsKCQkJY29uc29sZVt0YXJnZXQgfHwgImxvZyJdKCBtc2cgKTsKCQl9Cgl9LAoKCS8qKgoJICogTWVyZ2VzIG9iaiB3aXRoIGFyZwoJICoKCSAqIEBtZXRob2QgbWVyZ2UKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqIE9iamVjdCB0byBkZWNvcmF0ZQoJICogQHBhcmFtICB7T2JqZWN0fSBhcmcgRGVjb3JhdGlvbgoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRGVjb3JhdGVkIE9iamVjdAoJICovCgltZXJnZSA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJdXRpbGl0eS5pdGVyYXRlKCBhcmcsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJaWYgKCAoIG9ialtrXSBpbnN0YW5jZW9mIEFycmF5ICkgJiYgKCB2IGluc3RhbmNlb2YgQXJyYXkgKSApIHsKCQkJCWFycmF5Lm1lcmdlKCBvYmpba10sIHYgKTsKCQkJfQoJCQllbHNlIGlmICggKCBvYmpba10gaW5zdGFuY2VvZiBPYmplY3QgKSAmJiAoIHYgaW5zdGFuY2VvZiBPYmplY3QgKSApIHsKCQkJCXV0aWxpdHkuaXRlcmF0ZSggdiwgZnVuY3Rpb24gKCB4LCB5ICkgewoJCQkJCW9ialtrXVt5XSA9IHV0aWxpdHkuY2xvbmUoIHggKTsKCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJb2JqW2tdID0gdXRpbGl0eS5jbG9uZSggdiApOwoJCQl9CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9LAoJCgkvKioKCSAqIFJlZ2lzdGVycyBhIG1vZHVsZSBvbiBhYmFhc28KCSAqCgkgKiBAbWV0aG9kIG1vZHVsZQoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgTW9kdWxlIG5hbWUKCSAqIEBwYXJhbSAge09iamVjdH0gb2JqIE1vZHVsZSBzdHJ1Y3R1cmUKCSAqIEByZXR1cm4ge09iamVjdH0gICAgIE1vZHVsZSByZWdpc3RlcmVkCgkgKi8KCW1vZHVsZSA6IGZ1bmN0aW9uICggYXJnLCBvYmogKSB7CgkJaWYgKCAkW2FyZ10gIT09IHVuZGVmaW5lZCB8fCAhb2JqIGluc3RhbmNlb2YgT2JqZWN0ICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmVycm9yLmludmFsaWRBcmd1bWVudHMgKTsKCQl9CgkJCgkJJFthcmddID0gb2JqOwoKCQlyZXR1cm4gJFthcmddOwoJfSwKCgkvKioKCSAqIFJldHVybnMgT2JqZWN0LCBvciByZWZlcmVuY2UgdG8gRWxlbWVudAoJICoKCSAqIEBtZXRob2Qgb2JqZWN0CgkgKiBAcHJpdmF0ZQoJICogQHBhcmFtICB7TWl4ZWR9IG9iaiBFbnRpdHkgb3IgJCBxdWVyeQoJICogQHJldHVybiB7TWl4ZWR9ICAgICBFbnRpdHkKCSAqLwoJb2JqZWN0IDogZnVuY3Rpb24gKCBvYmogKSB7CgkJcmV0dXJuIHR5cGVvZiBvYmogPT09ICJvYmplY3QiID8gb2JqIDogKCBvYmouY2hhckF0ICYmIG9iai5jaGFyQXQoIDAgKSA9PT0gIiMiID8gdXRpbGl0eS4kKCBvYmogKSA6IG9iaiApOwoJfSwKCgkvKioKCSAqIFBhcnNlcyBhIFVSSSBpbnRvIGFuIE9iamVjdAoJICoKCSAqIEBtZXRob2QgcGFyc2UKCSAqIEBwYXJhbSAge1N0cmluZ30gdXJpIFVSSSB0byBwYXJzZQoJICogQHJldHVybiB7T2JqZWN0fSAgICAgUGFyc2VkIFVSSQoJICovCglwYXJzZSA6IGZ1bmN0aW9uICggdXJpICkgewoJCXZhciBvYmogICAgPSB7fSwKCQkgICAgcGFyc2VkID0ge307CgoJCWlmICggdXJpID09PSB1bmRlZmluZWQgKSB7CgkJCXVyaSA9ICFzZXJ2ZXIgPyBsb2NhdGlvbi5ocmVmIDogIiI7CgkJfQoKCQlpZiAoICFzZXJ2ZXIgKSB7CgkJCW9iaiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOwoJCQlvYmouaHJlZiA9IHVyaTsKCQl9CgkJZWxzZSB7CgkJCW9iaiA9IHVybC5wYXJzZSggdXJpICk7CgkJfQoKCQlpZiAoIHNlcnZlciApIHsKCQkJdXRpbGl0eS5pdGVyYXRlKCBvYmosIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCWlmICggdiA9PT0gbnVsbCApIHsKCQkJCQlvYmpba10gPSB1bmRlZmluZWQ7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcGFyc2VkID0gewoJCQlhdXRoICAgICA6IHNlcnZlciA/IG51bGwgOiByZWdleC5hdXRoLmV4ZWMoIHVyaSApLAoJCQlwcm90b2NvbCA6IG9iai5wcm90b2NvbCB8fCAiaHR0cDoiLAoJCQlob3N0bmFtZSA6IG9iai5ob3N0bmFtZSB8fCAibG9jYWxob3N0IiwKCQkJcG9ydCAgICAgOiBvYmoucG9ydCA/IG51bWJlci5wYXJzZSggb2JqLnBvcnQsIDEwICkgOiAiIiwKCQkJcGF0aG5hbWUgOiBvYmoucGF0aG5hbWUsCgkJCXNlYXJjaCAgIDogb2JqLnNlYXJjaCAgIHx8ICIiLAoJCQloYXNoICAgICA6IG9iai5oYXNoICAgICB8fCAiIiwKCQkJaG9zdCAgICAgOiBvYmouaG9zdCAgICAgfHwgImxvY2FsaG9zdCIKCQl9OwoKCQkvLyAnY2F1c2UgSUUgaXMgLi4uIElFOyByZXF1aXJlZCBmb3IgZGF0YS5iYXRjaCgpCgkJaWYgKCBjbGllbnQuaWUgKSB7CgkJCWlmICggcGFyc2VkLnByb3RvY29sID09PSAiOiIgKSB7CgkJCQlwYXJzZWQucHJvdG9jb2wgPSBsb2NhdGlvbi5wcm90b2NvbDsKCQkJfQoKCQkJaWYgKCBzdHJpbmcuaXNFbXB0eSggcGFyc2VkLmhvc3RuYW1lICkgKSB7CgkJCQlwYXJzZWQuaG9zdG5hbWUgPSBsb2NhdGlvbi5ob3N0bmFtZTsKCQkJfQoKCQkJaWYgKCBzdHJpbmcuaXNFbXB0eSggcGFyc2VkLmhvc3QgKSApIHsKCQkJCXBhcnNlZC5ob3N0ID0gbG9jYXRpb24uaG9zdDsKCQkJfQoKCQkJaWYgKCBwYXJzZWQucGF0aG5hbWUuY2hhckF0KCAwICkgIT09ICIvIiApIHsKCQkJCXBhcnNlZC5wYXRobmFtZSA9ICIvIiArIHBhcnNlZC5wYXRobmFtZTsKCQkJfQoJCX0KCgkJcGFyc2VkLmF1dGggID0gb2JqLmF1dGggfHwgKCBwYXJzZWQuYXV0aCA9PT0gbnVsbCA/ICIiIDogcGFyc2VkLmF1dGhbMV0gKTsKCQlwYXJzZWQuaHJlZiAgPSBvYmouaHJlZiB8fCAoIHBhcnNlZC5wcm90b2NvbCArICIvLyIgKyAoIHN0cmluZy5pc0VtcHR5KCBwYXJzZWQuYXV0aCApID8gIiIgOiBwYXJzZWQuYXV0aCArICJAIiApICsgcGFyc2VkLmhvc3QgKyBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICsgcGFyc2VkLmhhc2ggKTsKCQlwYXJzZWQucGF0aCAgPSBvYmoucGF0aCB8fCBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoOwoJCXBhcnNlZC5xdWVyeSA9IHV0aWxpdHkucXVlcnlTdHJpbmcoIG51bGwsIHBhcnNlZC5zZWFyY2ggKTsKCgkJcmV0dXJuIHBhcnNlZDsKCX0sCgoJLyoqCgkgKiBTZXRzIGEgcHJvcGVydHkgb24gYW4gT2JqZWN0LCBpZiBkZWZpbmVQcm9wZXJ0eSBjYW5ub3QgYmUgdXNlZCB0aGUgdmFsdWUgd2lsbCBiZSBzZXQgY2xhc3NpY2FsbHkKCSAqCgkgKiBAbWV0aG9kIHByb3BlcnR5CgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiAgICAgICAgT2JqZWN0IHRvIGRlY29yYXRlCgkgKiBAcGFyYW0gIHtTdHJpbmd9IHByb3AgICAgICAgTmFtZSBvZiBwcm9wZXJ0eSB0byBzZXQKCSAqIEBwYXJhbSAge09iamVjdH0gZGVzY3JpcHRvciBEZXNjcmlwdG9yIG9mIHRoZSBwcm9wZXJ0eQoJICogQHJldHVybiB7T2JqZWN0fSAgICAgICAgICAgIE9iamVjdCByZWNlaXZpbmcgdGhlIHByb3BlcnR5CgkgKi8KCXByb3BlcnR5IDogZnVuY3Rpb24gKCkgewoJCWlmICggKCBzZXJ2ZXIgfHwgKCAhY2xpZW50LmllIHx8IGNsaWVudC52ZXJzaW9uID4gOCApICkgJiYgdHlwZW9mIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSA9PT0gImZ1bmN0aW9uIiApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uICggb2JqLCBwcm9wLCBkZXNjcmlwdG9yICkgewoJCQkJaWYgKCAhKCBkZXNjcmlwdG9yIGluc3RhbmNlb2YgT2JqZWN0ICkgKSB7CgkJCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5lcnJvci5pbnZhbGlkQXJndW1lbnRzICk7CgkJCQl9CgoJCQkJaWYgKCBkZXNjcmlwdG9yLnZhbHVlICE9PSB1bmRlZmluZWQgJiYgZGVzY3JpcHRvci5nZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlkZWxldGUgZGVzY3JpcHRvci52YWx1ZTsKCQkJCX0KCgkJCQlPYmplY3QuZGVmaW5lUHJvcGVydHkoIG9iaiwgcHJvcCwgZGVzY3JpcHRvciApOwoJCQl9OwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIGZ1bmN0aW9uICggb2JqLCBwcm9wLCBkZXNjcmlwdG9yICkgewoJCQkJaWYgKCAhKCBkZXNjcmlwdG9yIGluc3RhbmNlb2YgT2JqZWN0ICkgKSB7CgkJCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5lcnJvci5pbnZhbGlkQXJndW1lbnRzICk7CgkJCQl9CgoJCQkJb2JqW3Byb3BdID0gZGVzY3JpcHRvci52YWx1ZTsKCgkJCQlyZXR1cm4gb2JqOwoJCQl9OwoJCX0KCX0sCgoJLyoqCgkgKiBTZXRzIG1ldGhvZHMgb24gYSBwcm90b3R5cGUgb2JqZWN0CgkgKgoJICogQWxsb3dzIGhvb2tzIHRvIGJlIG92ZXJ3cml0dGVuCgkgKgoJICogQG1ldGhvZCBwcm90bwoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogIE9iamVjdCByZWNlaXZpbmcgcHJvdG90eXBlIGV4dGVuc2lvbgoJICogQHBhcmFtICB7U3RyaW5nfSB0eXBlIElkZW50aWZpZXIgb2Ygb2JqLCBkZXRlcm1pbmVzIHdoYXQgQXJyYXlzIHRvIGFwcGx5CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgb2JqIG9yIHVuZGVmaW5lZAoJICovCglwcm90byA6IGZ1bmN0aW9uICggb2JqLCB0eXBlICkgewoJCXZhciB0YXJnZXQgPSBvYmoucHJvdG90eXBlIHx8IG9iajsKCgkJdXRpbGl0eS5pdGVyYXRlKCBwcm90b3R5cGVzW3R5cGVdLCBmdW5jdGlvbiAoIHYsIGsgKSB7CgkJCWlmICggIXRhcmdldFtrXSApIHsKCQkJCXV0aWxpdHkucHJvcGVydHkoIHRhcmdldCwgaywge3ZhbHVlOiB2LCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlfSApOwoJCQl9CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogUGFyc2VzIGEgcXVlcnkgc3RyaW5nICYgY29lcmNlcyB2YWx1ZXMKCSAqCgkgKiBAbWV0aG9kIHF1ZXJ5U3RyaW5nCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyAgICAgW09wdGlvbmFsXSBLZXkgdG8gZmluZCBpbiB0aGUgcXVlcnlzdHJpbmcKCSAqIEBwYXJhbSAge1N0cmluZ30gcXN0cmluZyBbT3B0aW9uYWxdIFF1ZXJ5IHN0cmluZyB0byBwYXJzZQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgICAgIFZhbHVlIG9yIE9iamVjdCBvZiBrZXk6dmFsdWUgcGFpcnMKCSAqLwoJcXVlcnlTdHJpbmcgOiBmdW5jdGlvbiAoIGFyZywgcXN0cmluZyApIHsKCQl2YXIgb2JqICAgID0ge30sCgkJICAgIHJlc3VsdCA9IHFzdHJpbmcgIT09IHVuZGVmaW5lZCA/ICggcXN0cmluZy5pbmRleE9mKCAiPyIgKSA+IC0xID8gcXN0cmluZy5yZXBsYWNlKCAvLipcPy8sICIiICkgOiBudWxsKSA6ICggc2VydmVyIHx8IHN0cmluZy5pc0VtcHR5KCBsb2NhdGlvbi5zZWFyY2ggKSA/IG51bGwgOiBsb2NhdGlvbi5zZWFyY2gucmVwbGFjZSggIj8iLCAiIiApICk7CgoJCWlmICggcmVzdWx0ICE9PSBudWxsICYmICFzdHJpbmcuaXNFbXB0eSggcmVzdWx0ICkgKSB7CgkJCXJlc3VsdCA9IHJlc3VsdC5zcGxpdCggIiYiICk7CgkJCWFycmF5LmVhY2goIHJlc3VsdCwgZnVuY3Rpb24gKHByb3AgKSB7CgkJCQl2YXIgaXRlbSA9IHByb3Auc3BsaXQoICI9IiApOwoKCQkJCWlmICggc3RyaW5nLmlzRW1wdHkoIGl0ZW1bMF0gKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKCBpdGVtWzFdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJaXRlbVsxXSA9ICIiOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJaXRlbVsxXSA9IHV0aWxpdHkuY29lcmNlKCBkZWNvZGVVUklDb21wb25lbnQoIGl0ZW1bMV0gKSApOwoJCQkJfQoKCQkJCWlmICggb2JqW2l0ZW1bMF1dID09PSB1bmRlZmluZWQgKSB7CgkJCQkJb2JqW2l0ZW1bMF1dID0gaXRlbVsxXTsKCQkJCX0KCQkJCWVsc2UgaWYgKCAhKG9ialtpdGVtWzBdXSBpbnN0YW5jZW9mIEFycmF5KSApIHsKCQkJCQlvYmpbaXRlbVswXV0gPSBbb2JqW2l0ZW1bMF1dXTsKCQkJCQlvYmpbaXRlbVswXV0ucHVzaCggaXRlbVsxXSApOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJb2JqW2l0ZW1bMF1dLnB1c2goIGl0ZW1bMV0gKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlpZiAoIGFyZyAhPT0gbnVsbCAmJiBhcmcgIT09IHVuZGVmaW5lZCApIHsKCQkJb2JqID0gb2JqW2FyZ107CgkJfQoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFJldHVybnMgYW4gQXJyYXkgb2YgcGFyYW1ldGVycyBvZiBhIEZ1bmN0aW9uCgkgKgoJICogQG1ldGhvZCByZWZsZWN0CgkgKiBAcGFyYW0gIHtGdW5jdGlvbn0gYXJnIEZ1bmN0aW9uIHRvIHJlZmxlY3QKCSAqIEByZXR1cm4ge0FycmF5fSAgICAgICAgQXJyYXkgb2YgcGFyYW1ldGVycwoJICovCglyZWZsZWN0IDogZnVuY3Rpb24gKCBhcmcgKSB7CgkJaWYgKCBhcmcgPT09IHVuZGVmaW5lZCApIHsKCQkJYXJnID0gdGhpcyB8fCB1dGlsaXR5LiQ7CgkJfQoKCQlhcmcgPSBhcmcudG9TdHJpbmcoKS5tYXRjaCggcmVnZXgucmVmbGVjdCApWzFdOwoKCQlyZXR1cm4gc3RyaW5nLmV4cGxvZGUoIGFyZyApOwoJfSwKCgkvKioKCSAqIENyZWF0ZXMgYSByZWN1cnNpdmUgZnVuY3Rpb24KCSAqCgkgKiBSZXR1cm4gZmFsc2UgZnJvbSB0aGUgZnVuY3Rpb24gdG8gaGFsdCByZWN1cnNpb24KCSAqCgkgKiBAbWV0aG9kIHJlcGVhdAoJICogQHBhcmFtICB7RnVuY3Rpb259IGZuICBGdW5jdGlvbiB0byBleGVjdXRlIHJlcGVhdGVkbHkKCSAqIEBwYXJhbSAge051bWJlcn0gICBtcyAgTWlsbGlzZWNvbmRzIHRvIHN0YWdnZXIgdGhlIGV4ZWN1dGlvbgoJICogQHBhcmFtICB7U3RyaW5nfSAgIGlkICBbT3B0aW9uYWxdIFRpbWVvdXQgSUQKCSAqIEBwYXJhbSAge0Jvb2xlYW59ICBub3cgRXhlY3V0ZXMgYGZuYCBhbmQgdGhlbiBzZXR1cCByZXBldGl0aW9uLCBkZWZhdWx0IGlzIGB0cnVlYAoJICogQHJldHVybiB7U3RyaW5nfSAgICAgICBUaW1lb3V0IElECgkgKi8KCXJlcGVhdCA6IGZ1bmN0aW9uICggZm4sIG1zLCBpZCwgbm93ICkgewoJCW1zICA9IG1zIHx8IDEwOwoJCWlkICA9IGlkIHx8IHV0aWxpdHkudXVpZCggdHJ1ZSApOwoJCW5vdyA9ICggbm93ICE9PSBmYWxzZSApOwoKCQkvLyBDb3VsZCBiZSB2YWxpZCB0byByZXR1cm4gZmFsc2UgZnJvbSBpbml0aWFsIGV4ZWN1dGlvbgoJCWlmICggbm93ICYmIGZuKCkgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBDcmVhdGluZyByZXBlYXRpbmcgZXhlY3V0aW9uCgkJdXRpbGl0eS5kZWZlciggZnVuY3Rpb24gKCkgewoJCQl2YXIgcmVjdXJzaXZlID0gZnVuY3Rpb24gKCBmbiwgbXMsIGlkICkgewoJCQkJdmFyIHJlY3Vyc2l2ZSA9IHRoaXM7CgoJCQkJaWYgKCBmbigpICE9PSBmYWxzZSApIHsKCQkJCQl1dGlsaXR5LnJlcGVhdGluZ1tpZF0gPSBzZXRUaW1lb3V0KCBmdW5jdGlvbiAoKSB7CgkJCQkJCXJlY3Vyc2l2ZS5jYWxsKCByZWN1cnNpdmUsIGZuLCBtcywgaWQgKTsKCQkJCQl9LCBtcyApOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJZGVsZXRlIHV0aWxpdHkucmVwZWF0aW5nW2lkXTsKCQkJCX0KCQkJfTsKCgkJCXJlY3Vyc2l2ZS5jYWxsKCByZWN1cnNpdmUsIGZuLCBtcywgaWQgKTsKCQl9LCBtcywgaWQsIHRydWUgKTsKCgkJcmV0dXJuIGlkOwoJfSwKCgkvKioKCSAqIFN0b3BzIGFuIEV2ZW50IGZyb20gYnViYmxpbmcKCSAqCgkgKiBAbWV0aG9kIHN0b3AKCSAqIEBwYXJhbSAge09iamVjdH0gZSBFdmVudAoJICogQHJldHVybiB7T2JqZWN0fSAgIEV2ZW50CgkgKi8KCXN0b3AgOiBmdW5jdGlvbiAoIGUgKSB7CgkJaWYgKCBlLmNhbmNlbEJ1YmJsZSAhPT0gdW5kZWZpbmVkICkgewoJCQllLmNhbmNlbEJ1YmJsZSA9IHRydWU7CgkJfQoKCQlpZiAoIHR5cGVvZiBlLnByZXZlbnREZWZhdWx0ID09PSAiZnVuY3Rpb24iICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoKCQlpZiAoIHR5cGVvZiBlLnN0b3BQcm9wYWdhdGlvbiA9PT0gImZ1bmN0aW9uIiApIHsKCQkJZS5zdG9wUHJvcGFnYXRpb24oKTsKCQl9CgoJCS8vIEFzc3VtZWQgdG8gYWx3YXlzIGJlIHZhbGlkLCBldmVuIGlmIGl0J3Mgbm90IGRlY29yYXRlZCBvbiBgZWAgKCBJJ20gbG9va2luZyBhdCB5b3UgSUU4ICkKCQllLnJldHVyblZhbHVlID0gZmFsc2U7CgoJCXJldHVybiBlOwoJfSwKCgkvKioKCSAqIFJldHVybnMgdGhlIEV2ZW50IHRhcmdldAoJICoKCSAqIEBtZXRob2QgdGFyZ2V0CgkgKiBAcGFyYW0gIHtPYmplY3R9IGUgRXZlbnQKCSAqIEByZXR1cm4ge09iamVjdH0gICBFdmVudCB0YXJnZXQKCSAqLwoJdGFyZ2V0IDogZnVuY3Rpb24gKCBlICkgewoJCXJldHVybiBlLnRhcmdldCB8fCBlLnNyY0VsZW1lbnQ7Cgl9LAoKCS8qKgoJICogVHJhbnNmb3JtcyBKU09OIHRvIEhUTUwgYW5kIGFwcGVuZHMgdG8gQm9keSBvciB0YXJnZXQgRWxlbWVudAoJICoKCSAqIEBtZXRob2QgdHBsCgkgKiBAcGFyYW0gIHtPYmplY3R9IGRhdGEgICBKU09OIE9iamVjdCBkZXNjcmliaW5nIEhUTUwKCSAqIEBwYXJhbSAge01peGVkfSAgdGFyZ2V0IFtPcHRpb25hbF0gVGFyZ2V0IEVsZW1lbnQgb3IgRWxlbWVudC5pZCB0byByZWNlaXZlIHRoZSBIVE1MCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgICBOZXcgRWxlbWVudCBjcmVhdGVkIGZyb20gdGhlIHRlbXBsYXRlCgkgKi8KCXRwbCA6IGZ1bmN0aW9uICggYXJnLCB0YXJnZXQgKSB7CgkJdmFyIGZyYWc7CgoJCWlmICggdHlwZW9mIGFyZyAhPT0gIm9iamVjdCIgfHwgKCEocmVnZXgub2JqZWN0X3VuZGVmaW5lZC50ZXN0KCB0eXBlb2YgdGFyZ2V0ICkgKSAmJiAoIHRhcmdldCA9IHRhcmdldC5jaGFyQXQoIDAgKSA9PT0gIiMiID8gdXRpbGl0eS4kKCB0YXJnZXQgKSA6IHV0aWxpdHkuJCggdGFyZ2V0IClbMF0gKSA9PT0gdW5kZWZpbmVkICkgKSB7CgkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuZXJyb3IuaW52YWxpZEFyZ3VtZW50cyApOwoJCX0KCgkJaWYgKCB0YXJnZXQgPT09IHVuZGVmaW5lZCApIHsKCQkJdGFyZ2V0ID0gdXRpbGl0eS4kKCAiYm9keSIgKVswXTsKCQl9CgoJCWZyYWcgID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlpZiAoIGFyZyBpbnN0YW5jZW9mIEFycmF5ICkgewoJCQlhcnJheS5lYWNoKCBhcmcsIGZ1bmN0aW9uICggaSApIHsKCQkJCWVsZW1lbnQuaHRtbCggZWxlbWVudC5jcmVhdGUoIGFycmF5LmNhc3QoIGksIHRydWUgKVswXSwgZnJhZyApLCBhcnJheS5jYXN0KGkpWzBdICk7CgkJCX0pOwoJCX0KCQllbHNlIHsKCQkJdXRpbGl0eS5pdGVyYXRlKCBhcmcsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJCWlmICggdHlwZW9mIHYgPT09ICJzdHJpbmciICkgewoJCQkJCWVsZW1lbnQuaHRtbCggZWxlbWVudC5jcmVhdGUoIGssIHVuZGVmaW5lZCwgZnJhZyApLCB2ICk7CgkJCQl9CgkJCQllbHNlIGlmICggKCB2IGluc3RhbmNlb2YgQXJyYXkgKSB8fCAoIHYgaW5zdGFuY2VvZiBPYmplY3QgKSApIHsKCQkJCQl1dGlsaXR5LnRwbCggdiwgZWxlbWVudC5jcmVhdGUoIGssIHVuZGVmaW5lZCwgZnJhZyApICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJdGFyZ2V0LmFwcGVuZENoaWxkKCBmcmFnICk7CgoJCXJldHVybiBhcnJheS5sYXN0KCB0YXJnZXQuY2hpbGROb2RlcyApOwoJfSwKCgkvKioKCSAqIEdlbmVyYXRlcyBhIHZlcnNpb24gNCBVVUlECgkgKgoJICogQG1ldGhvZCB1dWlkCgkgKiBAcGFyYW0gIHtCb29sZWFufSBzYWZlIFtPcHRpb25hbF0gU3RyaXBzIC0gZnJvbSBVVUlECgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgIFVVSUQKCSAqLwoJdXVpZCA6IGZ1bmN0aW9uICggc2FmZSApIHsKCQl2YXIgcyA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICggKCAoIDEgKyBNYXRoLnJhbmRvbSgpICkgKiAweDEwMDAwICkgfCAwICkudG9TdHJpbmcoIDE2ICkuc3Vic3RyaW5nKCAxICk7IH0sCgkJICAgIHIgPSBbOCwgOSwgImEiLCAiYiJdLAoJCSAgICBvOwoKCQlvID0gKCBzKCkgKyBzKCkgKyAiLSIgKyBzKCkgKyAiLTQiICsgcygpLnN1YnN0ciggMCwgMyApICsgIi0iICsgcltNYXRoLmZsb29yKCBNYXRoLnJhbmRvbSgpICogNCApXSArIHMoKS5zdWJzdHIoIDAsIDMgKSArICItIiArIHMoKSArIHMoKSArIHMoKSApOwoKCQlpZiAoIHNhZmUgPT09IHRydWUgKSB7CgkJCW8gPSBvLnJlcGxhY2UoIC8tL2csICIiICk7CgkJfQoKCQlyZXR1cm4gbzsKCX0sCgoJLyoqCgkgKiBXYWxrcyBhIHN0cnVjdHVyZSBhbmQgcmV0dXJucyBhcmcKCSAqCgkgKiBAbWV0aG9kICB3YWxrCgkgKiBAcGFyYW0gIHtNaXhlZH0gIG9iaiAgT2JqZWN0IG9yIEFycmF5CgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyAgU3RyaW5nIGRlc2NyaWJpbmcgdGhlIHByb3BlcnR5IHRvIHJldHVybgoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgIGFyZwoJICovCgl3YWxrIDogZnVuY3Rpb24gKCBvYmosIGFyZyApIHsKCQlhcnJheS5lYWNoKCBhcmcucmVwbGFjZSggL1xdJC8sICIiICkucmVwbGFjZSggL1xdL2csICIuIiApLnJlcGxhY2UoIC9cLlwuL2csICIuIiApLnNwbGl0KCAvXC58XFsvICksIGZ1bmN0aW9uICggaSApIHsKCQkJb2JqID0gb2JqW2ldOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIEFjY2VwdHMgRGVmZXJyZWRzIG9yIFByb21pc2VzIGFzIGFyZ3VtZW50cyBvciBhbiBBcnJheQoJICoKCSAqIEBtZXRob2Qgd2hlbgoJICogQHJldHVybiB7T2JqZWN0fSBEZWZlcnJlZAoJICovCgl3aGVuIDogZnVuY3Rpb24gKCkgewoJCXZhciBpICAgICA9IDAsCgkJICAgIGRlZmVyID0gZGVmZXJyZWQoKSwKCQkgICAgYXJncyAgPSBhcnJheS5jYXN0KCBhcmd1bWVudHMgKSwKCQkgICAgbnRoOwoKCQkvLyBEaWQgd2UgcmVjZWl2ZSBhbiBBcnJheT8gaWYgc28gaXQgb3ZlcnJpZGVzIGFueSBvdGhlciBhcmd1bWVudHMKCQlpZiAoIGFyZ3NbMF0gaW5zdGFuY2VvZiBBcnJheSApIHsKCQkJYXJncyA9IGFyZ3NbMF07CgkJfQoKCQkvLyBIb3cgbWFueSBpbnN0YW5jZXMgdG8gb2JzZXJ2ZT8KCQludGggPSBhcmdzLmxlbmd0aDsKCgkJLy8gTm9uZSwgZW5kIG9uIG5leHQgdGljawoJCWlmICggbnRoID09PSAwICkgewoJCQlkZWZlci5yZXNvbHZlKCBudWxsICk7CgkJfQoJCS8vIFNldHVwIGFuZCB3YWl0CgkJZWxzZSB7CgkJCWFycmF5LmVhY2goIGFyZ3MsIGZ1bmN0aW9uICggcCApIHsKCQkJCXAudGhlbiggZnVuY3Rpb24gKCkgewoJCQkJCWlmICggKytpID09PSBudGggJiYgIWRlZmVyLmlzUmVzb2x2ZWQoKSkgewoJCQkJCQlpZiAoIGFyZ3MubGVuZ3RoID4gMSApIHsKCQkJCQkJCWRlZmVyLnJlc29sdmUoIGFyZ3MubWFwKCBmdW5jdGlvbiAoIG9iaiApIHsKCQkJCQkJCQlyZXR1cm4gb2JqLnZhbHVlIHx8IG9iai5wcm9taXNlLnZhbHVlOwoJCQkJCQkJfSkpOwoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJZGVmZXIucmVzb2x2ZSggYXJnc1swXS52YWx1ZSB8fCBhcmdzWzBdLnByb21pc2UudmFsdWUgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0sIGZ1bmN0aW9uICgpIHsKCQkJCQlpZiAoICFkZWZlci5pc1Jlc29sdmVkKCkgKSB7CgkJCQkJCWlmICggYXJncy5sZW5ndGggPiAxICkgewoJCQkJCQkJZGVmZXIucmVqZWN0KCBhcmdzLm1hcCggZnVuY3Rpb24gKCBvYmogKSB7CgkJCQkJCQkJcmV0dXJuIG9iai52YWx1ZSB8fCBvYmoucHJvbWlzZS52YWx1ZTsKCQkJCQkJCX0pKTsKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCWRlZmVyLnJlamVjdCggYXJnc1swXS52YWx1ZSB8fCBhcmdzWzBdLnByb21pc2UudmFsdWUgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pOwoJCQl9KTsKCQl9CgoJCXJldHVybiBkZWZlcjsKCX0KfTsK",
                "body": "LyoqIEBuYW1lc3BhY2UgdXRpbGl0eSAqLwp2YXIgdXRpbGl0eSA9IHsKCS8vIENvbGxlY3Rpb24gb2YgdGltZXJzCgl0aW1lciA6IHt9LAoKCS8vIENvbGxlY3Rpb24gb2YgcmVwZWF0aW5nIGZ1bmN0aW9ucwoJcmVwZWF0aW5nOiB7fSwKCgkvKioKCSAqIFF1ZXJpZXMgdGhlIERPTSB1c2luZyBDU1Mgc2VsZWN0b3JzIGFuZCByZXR1cm5zIGFuIEVsZW1lbnQgb3IgQXJyYXkgb2YgRWxlbWVudHMKCSAqCgkgKiBAbWV0aG9kICQKCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnIENvbW1hIGRlbGltaXRlZCBzdHJpbmcgb2YgQ1NTIHNlbGVjdG9ycwoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgRWxlbWVudCBvciBBcnJheSBvZiBFbGVtZW50cwoJICovCgkkIDogZnVuY3Rpb24gKCBhcmcgKSB7CgkJdmFyIHJlc3VsdDsKCgkJaWYgKCAhYXJnICkgewoJCQlyZXR1cm47CgkJfQoKCQlhcmcgPSBzdHJpbmcudHJpbSggYXJnICk7CgoJCWlmICggYXJnLmluZGV4T2YoICIsIiApID09PSAtMSApIHsKCQkJcmVzdWx0ID0gdXRpbGl0eS5kb20oIGFyZyApOwoJCX0KCQllbHNlIHsKCQkJcmVzdWx0ID0gW107CgoJCQlhcnJheS5lYWNoKCBzdHJpbmcuZXhwbG9kZSggYXJnICksIGZ1bmN0aW9uICggcXVlcnkgKSB7CgkJCQl2YXIgb2JqID0gdXRpbGl0eS5kb20oIHF1ZXJ5ICk7CgoJCQkJaWYgKCBvYmogaW5zdGFuY2VvZiBBcnJheSApIHsKCQkJCQlyZXN1bHQgPSByZXN1bHQuY29uY2F0KCBvYmogKTsKCQkJCX0KCQkJCWVsc2UgaWYgKCBvYmogKSB7CgkJCQkJcmVzdWx0LnB1c2goIG9iaiApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCS8qKgoJICogQWxpYXNlcyBvcmlnaW4gb250byBvYmoKCSAqCgkgKiBAbWV0aG9kIGFsaWFzCgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiAgICBPYmplY3QgcmVjZWl2aW5nIGFsaWFzaW5nCgkgKiBAcGFyYW0gIHtPYmplY3R9IG9yaWdpbiBPYmplY3QgcHJvdmlkaW5nIHN0cnVjdHVyZSB0byBvYmoKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgIE9iamVjdCByZWNlaXZpbmcgYWxpYXNpbmcKCSAqLwoJYWxpYXMgOiBmdW5jdGlvbiAoIG9iaiwgb3JpZ2luICkgewoJCXZhciBvID0gb2JqLAoJCSAgICBzID0gb3JpZ2luOwoKCQl1dGlsaXR5Lml0ZXJhdGUoIHMsIGZ1bmN0aW9uICggdiwgayApIHsKCQkJdmFyIGdldHRlciwgc2V0dGVyOwoKCQkJaWYgKCAhKCB2IGluc3RhbmNlb2YgUmVnRXhwICkgJiYgdHlwZW9mIHYgPT09ICJmdW5jdGlvbiIgKSB7CgkJCQlvW2tdID0gdi5iaW5kKCBvW2tdICk7CgkJCX0KCQkJZWxzZSBpZiAoICEodiBpbnN0YW5jZW9mIFJlZ0V4cCApICYmICEodiBpbnN0YW5jZW9mIEFycmF5ICkgJiYgdiBpbnN0YW5jZW9mIE9iamVjdCApIHsKCQkJCWlmICggb1trXSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW9ba10gPSB7fTsKCQkJCX0KCgkJCQl1dGlsaXR5LmFsaWFzKCBvW2tdLCBzW2tdICk7CgkJCX0KCQkJZWxzZSB7CgkJCQlnZXR0ZXIgPSBmdW5jdGlvbiAoKSB7CgkJCQkJcmV0dXJuIHNba107CgkJCQl9OwoKCQkJCXNldHRlciA9IGZ1bmN0aW9uICggYXJnICkgewoJCQkJCXNba10gPSBhcmc7CgkJCQl9OwoKCQkJCXV0aWxpdHkucHJvcGVydHkoIG8sIGssIHtlbnVtZXJhYmxlOiB0cnVlLCBnZXQ6IGdldHRlciwgc2V0OiBzZXR0ZXIsIHZhbHVlOiBzW2tdfSApOwoJCQl9CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9LAoKCS8qKgoJICogQ2xlYXJzIGRlZmVycmVkICYgcmVwZWF0aW5nIGZ1bmN0aW9ucwoJICoKCSAqIEBtZXRob2QgY2xlYXJUaW1lcnMKCSAqIEBwYXJhbSAge1N0cmluZ30gaWQgSUQgb2YgdGltZXIoIHMgKQoJICogQHJldHVybiB7VW5kZWZpbmVkfSB1bmRlZmluZWQKCSAqLwoJY2xlYXJUaW1lcnMgOiBmdW5jdGlvbiAoIGlkICkgewoJCWlmICggaWQgPT09IHVuZGVmaW5lZCB8fCBzdHJpbmcuaXNFbXB0eSggaWQgKSApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5lcnJvci5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoKCQkvLyBkZWZlcnJlZAoJCWlmICggdXRpbGl0eS50aW1lcltpZF0gIT09IHVuZGVmaW5lZCApIHsKCQkJY2xlYXJUaW1lb3V0KCB1dGlsaXR5LnRpbWVyW2lkXSApOwoJCQlkZWxldGUgdXRpbGl0eS50aW1lcltpZF07CgkJfQoKCQkvLyByZXBlYXRpbmcKCQlpZiAoIHV0aWxpdHkucmVwZWF0aW5nW2lkXSAhPT0gdW5kZWZpbmVkICkgewoJCQljbGVhclRpbWVvdXQoIHV0aWxpdHkucmVwZWF0aW5nW2lkXSApOwoJCQlkZWxldGUgdXRpbGl0eS5yZXBlYXRpbmdbaWRdOwoJCX0KCX0sCgoJLyoqCgkgKiBDbG9uZXMgYW4gT2JqZWN0CgkgKgoJICogQG1ldGhvZCBjbG9uZQoJICogQHBhcmFtIHtPYmplY3R9ICBvYmogICAgIE9iamVjdCB0byBjbG9uZQoJICogQHBhcmFtIHtCb29sZWFufSBzaGFsbG93IFtPcHRpb25hbF0gQ3JlYXRlIGEgc2hhbGxvdyBjbG9uZSwgd2hpY2ggZG9lc24ndCBtYWludGFpbiBwcm90b3R5cGVzLCBkZWZhdWx0IGlzIGBmYWxzZWAKCSAqIEByZXR1cm4ge09iamVjdH0gICAgIENsb25lIG9mIG9iagoJICovCgljbG9uZSA6IGZ1bmN0aW9uICggb2JqLCBzaGFsbG93ICkgewoJCXZhciBjbG9uZTsKCgkJaWYgKCBzaGFsbG93ID09PSB0cnVlICkgewoJCQlyZXR1cm4ganNvbi5kZWNvZGUoIGpzb24uZW5jb2RlKCBvYmogKSApOwoJCX0KCQllbHNlIGlmICggIW9iaiB8fCByZWdleC5wcmltaXRpdmUudGVzdCggdHlwZW9mIG9iaiApIHx8ICggb2JqIGluc3RhbmNlb2YgUmVnRXhwICkgKSB7CgkJCXJldHVybiBvYmo7CgkJfQoJCWVsc2UgaWYgKCBvYmogaW5zdGFuY2VvZiBBcnJheSApIHsKCQkJcmV0dXJuIG9iai5zbGljZSgpOwoJCX0KCQllbHNlIGlmICggIXNlcnZlciAmJiAhY2xpZW50LmllICYmIG9iaiBpbnN0YW5jZW9mIERvY3VtZW50ICkgewoJCQlyZXR1cm4geG1sLmRlY29kZSggeG1sLmVuY29kZSggb2JqICkgKTsKCQl9CgkJZWxzZSBpZiAoIHR5cGVvZiBvYmouX19wcm90b19fICE9PSAidW5kZWZpbmVkIiApIHsKCQkJcmV0dXJuIHV0aWxpdHkuZXh0ZW5kKCBvYmouX19wcm90b19fLCBvYmogKTsKCQl9CgkJZWxzZSBpZiAoIG9iaiBpbnN0YW5jZW9mIE9iamVjdCApIHsKCQkJLy8gSWYgSlNPTiBlbmNvZGluZyBmYWlscyBkdWUgdG8gcmVjdXJzaW9uLCB0aGUgb3JpZ2luYWwgT2JqZWN0IGlzIHJldHVybmVkIGJlY2F1c2UgaXQncyBhc3N1bWVkIHRoaXMgaXMgZm9yIGRlY29yYXRpb24KCQkJY2xvbmUgPSBqc29uLmVuY29kZSggb2JqLCB0cnVlICk7CgoJCQlpZiAoIGNsb25lICE9PSB1bmRlZmluZWQgKSB7CgkJCQljbG9uZSA9IGpzb24uZGVjb2RlKCBjbG9uZSApOwoKCQkJCS8vIERlY29yYXRpbmcgRnVuY3Rpb25zIHRoYXQgd291bGQgYmUgbG9zdCB3aXRoIEpTT04gZW5jb2RpbmcvZGVjb2RpbmcKCQkJCXV0aWxpdHkuaXRlcmF0ZSggb2JqLCBmdW5jdGlvbiAoIHYsIGsgKSB7CgkJCQkJaWYgKCB0eXBlb2YgdiA9PT0gImZ1bmN0aW9uIiApIHsKCQkJCQkJY2xvbmVba10gPSB2OwoJCQkJCX0KCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJY2xvbmUgPSBvYmo7CgkJCX0KCgkJCXJldHVybiBjbG9uZTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiBvYmo7CgkJfQoJfSwKCgkvKioKCSAqIENvZXJjZXMgYSBTdHJpbmcgdG8gYSBUeXBlCgkgKgoJICogQG1ldGhvZCBjb2VyY2UKCSAqIEBwYXJhbSAge1N0cmluZ30gdmFsdWUgU3RyaW5nIHRvIGNvZXJjZQoJICogQHJldHVybiB7TWl4ZWR9ICAgICAgICBQcmltaXRpdmUgdmVyc2lvbiBvZiB0aGUgU3RyaW5nCgkgKi8KCWNvZXJjZSA6IGZ1bmN0aW9uICggdmFsdWUgKSB7CgkJdmFyIHRtcDsKCgkJaWYgKCB2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdW5kZWZpbmVkOwoJCX0KCQllbHNlIGlmICggdmFsdWUgPT09ICJ0cnVlIiApIHsKCQkJcmV0dXJuIHRydWU7CgkJfQoJCWVsc2UgaWYgKCB2YWx1ZSA9PT0gImZhbHNlIiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQllbHNlIGlmICggdmFsdWUgPT09ICJudWxsIiApIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoJCWVsc2UgaWYgKCB2YWx1ZSA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCXJldHVybiB1bmRlZmluZWQ7CgkJfQoJCWVsc2UgaWYgKCB2YWx1ZSA9PT0gIiIgKSB7CgkJCXJldHVybiB2YWx1ZTsKCQl9CgkJZWxzZSBpZiAoICFpc05hTiggdG1wID0gTnVtYmVyKCB2YWx1ZSApICkgKSB7CgkJCXJldHVybiB0bXA7CgkJfQoJCWVsc2UgaWYgKCByZWdleC5qc29uX3dyYXAudGVzdCggdmFsdWUgKSApIHsKCQkJcmV0dXJuIGpzb24uZGVjb2RlKCB2YWx1ZSwgdHJ1ZSApIHx8IHZhbHVlOwoJCX0KCQllbHNlIHsKCQkJcmV0dXJuIHZhbHVlOwoJCX0KCX0sCgoJLyoqCgkgKiBSZWNvbXBpbGVzIGEgUmVnRXhwIGJ5IHJlZmVyZW5jZQoJICoKCSAqIFRoaXMgaXMgaWRlYWwgd2hlbiB5b3UgbmVlZCB0byByZWNvbXBpbGUgYSByZWdleCBmb3IgdXNlIHdpdGhpbiBhIGNvbmRpdGlvbmFsIHN0YXRlbWVudAoJICoKCSAqIEBtZXRob2QgY29tcGlsZQoJICogQHBhcmFtICB7T2JqZWN0fSByZWdleCAgICAgUmVnRXhwCgkgKiBAcGFyYW0gIHtTdHJpbmd9IHBhdHRlcm4gICBSZWd1bGFyIGV4cHJlc3Npb24gcGF0dGVybgoJICogQHBhcmFtICB7U3RyaW5nfSBtb2RpZmllcnMgTW9kaWZpZXJzIHRvIGFwcGx5IHRvIHRoZSBwYXR0ZXJuCgkgKiBAcmV0dXJuIHtCb29sZWFufSAgICAgICAgICB0cnVlCgkgKi8KCWNvbXBpbGUgOiBmdW5jdGlvbiAoIHJlZywgcGF0dGVybiwgbW9kaWZpZXJzICkgewoJCXJlZy5jb21waWxlKCBwYXR0ZXJuLCBtb2RpZmllcnMgKTsKCgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qKgoJICogQ3JlYXRlcyBhIENTUyBzdHlsZXNoZWV0IGluIHRoZSBWaWV3CgkgKgoJICogQG1ldGhvZCBjc3MKCSAqIEBwYXJhbSAge1N0cmluZ30gY29udGVudCBDU1MgdG8gcHV0IGluIGEgc3R5bGUgdGFnCgkgKiBAcGFyYW0gIHtTdHJpbmd9IG1lZGlhICAgW09wdGlvbmFsXSBNZWRpYXMgdGhlIHN0eWxlc2hlZXQgYXBwbGllcyB0bwoJICogQHJldHVybiB7T2JqZWN0fSAgICAgICAgIEVsZW1lbnQgY3JlYXRlZCBvciB1bmRlZmluZWQKCSAqLwoJY3NzIDogZnVuY3Rpb24gKCBjb250ZW50LCBtZWRpYSApIHsKCQl2YXIgc3MsIGNzczsKCgkJc3MgPSBlbGVtZW50LmNyZWF0ZSggInN0eWxlIiwge3R5cGU6ICJ0ZXh0L2NzcyIsIG1lZGlhOiBtZWRpYSB8fCAicHJpbnQsIHNjcmVlbiJ9LCB1dGlsaXR5LiQoICJoZWFkIiApWzBdICk7CgoJCWlmICggc3Muc3R5bGVTaGVldCApIHsKCQkJc3Muc3R5bGVTaGVldC5jc3NUZXh0ID0gY29udGVudDsKCQl9CgkJZWxzZSB7CgkJCWNzcyA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBjb250ZW50ICk7CgkJCXNzLmFwcGVuZENoaWxkKCBjc3MgKTsKCQl9CgoJCXJldHVybiBzczsKCX0sCgoJLyoqCgkgKiBEZWJvdW5jZXMgYSBmdW5jdGlvbgoJICoKCSAqIEBtZXRob2QgZGVib3VuY2UKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiAgICBGdW5jdGlvbiB0byBleGVjdXRlCgkgKiBAcGFyYW0gIHtOdW1iZXJ9ICAgbXMgICAgVGltZSB0byB3YWl0IHRvIGV4ZWN1dGUgaW4gbWlsbGlzZWNvbmRzLCBkZWZhdWx0IGlzIDEwMDAKCSAqIEBwYXJhbSAge01peGVkfSAgICBzY29wZSBgdGhpc2AgY29udGV4dCBkdXJpbmcgZXhlY3V0aW9uLCBkZWZhdWx0IGlzIGBnbG9iYWxgCgkgKiBAcmV0dXJuIHtVbmRlZmluZWR9ICAgICAgdW5kZWZpbmVkCgkgKi8KCWRlYm91bmNlIDogZnVuY3Rpb24gKCBmbiwgbXMsIHNjb3BlICkgewoJCW1zICAgID0gbXMgICAgfHwgMTAwMDsKCQlzY29wZSA9IHNjb3BlIHx8IGdsb2JhbDsKCgkJcmV0dXJuIGZ1bmN0aW9uIGRlYm91bmNlZCAoKSB7CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uICgpIHsKCQkJCWZuLmFwcGx5KCBzY29wZSwgYXJndW1lbnRzICk7CgkJCX0sIG1zKTsKCQl9OwoJfSwKCgkvKioKCSAqIEFsbG93cyBkZWVwIHNldHRpbmcgb2YgcHJvcGVydGllcyB3aXRob3V0IGtub3dpbmcKCSAqIGlmIHRoZSBzdHJ1Y3R1cmUgaXMgdmFsaWQKCSAqCgkgKiBAbWV0aG9kIGRlZmluZQoJICogQHBhcmFtICB7U3RyaW5nfSBhcmdzICBEb3QgZGVsaW1pdGVkIHN0cmluZyBvZiB0aGUgc3RydWN0dXJlCgkgKiBAcGFyYW0gIHtNaXhlZH0gIHZhbHVlIFZhbHVlIHRvIHNldAoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogICBPYmplY3QgcmVjZWl2aW5nIHZhbHVlCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICAgIE9iamVjdCByZWNlaXZpbmcgdmFsdWUKCSAqLwoJZGVmaW5lIDogZnVuY3Rpb24gKCBhcmdzLCB2YWx1ZSwgb2JqICkgewoJCWFyZ3MgICAgPSBhcmdzLnNwbGl0KCAiLiIgKTsKCQl2YXIgcCAgID0gb2JqLAoJCSAgICBudGggPSBhcmdzLmxlbmd0aDsKCgkJaWYgKCBvYmogPT09IHVuZGVmaW5lZCApIHsKCQkJb2JqID0gdGhpczsKCQl9CgoJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJdmFsdWUgPSBudWxsOwoJCX0KCgkJYXJyYXkuZWFjaCggYXJncywgZnVuY3Rpb24gKCBpLCBpZHggKSB7CgkJCXZhciBudW0gPSBpZHggKyAxIDwgbnRoICYmICFpc05hTiggbnVtYmVyLnBhcnNlKCBhcmdzW2lkeCArIDFdLCAxMCApICksCgkJCSAgICB2YWwgPSB2YWx1ZTsKCgkJCWlmICggIWlzTmFOKCBudW1iZXIucGFyc2UoIGksIDEwICkgKSApICB7CgkJCQlpID0gbnVtYmVyLnBhcnNlKCBpLCAxMCApOwoJCQl9CgkJCQoJCQkvLyBDcmVhdGluZyBvciBjYXN0aW5nCgkJCWlmICggcFtpXSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcFtpXSA9IG51bSA/IFtdIDoge307CgkJCX0KCQkJZWxzZSBpZiAoIHBbaV0gaW5zdGFuY2VvZiBPYmplY3QgJiYgbnVtICkgewoJCQkJcFtpXSA9IGFycmF5LmNhc3QoIHBbaV0gKTsKCQkJfQoJCQllbHNlIGlmICggcFtpXSBpbnN0YW5jZW9mIE9iamVjdCApIHsKCQkJCS8vIERvIG5vdGhpbmcKCQkJfQoJCQllbHNlIGlmICggcFtpXSBpbnN0YW5jZW9mIEFycmF5ICYmICFudW0gKSB7CgkJCQlwW2ldID0gYXJyYXkudG9PYmplY3QoIHBbaV0gKTsKCQkJfQoJCQllbHNlIHsKCQkJCXBbaV0gPSB7fTsKCQkJfQoKCQkJLy8gU2V0dGluZyByZWZlcmVuY2Ugb3IgdmFsdWUKCQkJaWR4ICsgMSA9PT0gbnRoID8gcFtpXSA9IHZhbCA6IHAgPSBwW2ldOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIERlZmVycyB0aGUgZXhlY3V0aW9uIG9mIEZ1bmN0aW9uIGJ5IGF0IGxlYXN0IHRoZSBzdXBwbGllZCBtaWxsaXNlY29uZHMKCSAqIFRpbWluZyBtYXkgdmFyeSB1bmRlciAiaGVhdnkgbG9hZCIgcmVsYXRpdmUgdG8gdGhlIENQVSAmIGNsaWVudCBKYXZhU2NyaXB0IGVuZ2luZQoJICoKCSAqIEBtZXRob2QgZGVmZXIKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiAgICAgRnVuY3Rpb24gdG8gZGVmZXIgZXhlY3V0aW9uIG9mCgkgKiBAcGFyYW0gIHtOdW1iZXJ9ICAgbXMgICAgIE1pbGxpc2Vjb25kcyB0byBkZWZlciBleGVjdXRpb24KCSAqIEBwYXJhbSAge051bWJlcn0gICBpZCAgICAgW09wdGlvbmFsXSBJRCBvZiB0aGUgZGVmZXJyZWQgZnVuY3Rpb24KCSAqIEBwYXJhbSAge0Jvb2xlYW59ICByZXBlYXQgW09wdGlvbmFsXSBEZXNjcmliZXMgdGhlIGV4ZWN1dGlvbiwgZGVmYXVsdCBpcyBgZmFsc2VgCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgICAgIElEIG9mIHRoZSB0aW1lcgoJICovCglkZWZlciA6IGZ1bmN0aW9uICggZm4sIG1zLCBpZCwgcmVwZWF0ICkgewoJCXZhciBvcDsKCgkJbXMgICAgID0gbXMgfHwgMDsKCQlyZXBlYXQgPSAoIHJlcGVhdCA9PT0gdHJ1ZSApOwoKCQlpZiAoIGlkICE9PSB1bmRlZmluZWQgKSB7CgkJCXV0aWxpdHkuY2xlYXJUaW1lcnMoIGlkICk7CgkJfQoJCWVsc2UgewoJCQlpZCA9IHV0aWxpdHkudXVpZCggdHJ1ZSApOwoJCX0KCgkJb3AgPSBmdW5jdGlvbiAoKSB7CgkJCXV0aWxpdHkuY2xlYXJUaW1lcnMoIGlkICk7CgkJCWZuKCk7CgkJfTsKCgkJdXRpbGl0eVtyZXBlYXQgPyAicmVwZWF0aW5nIiA6ICJ0aW1lciJdW2lkXSA9IHNldFRpbWVvdXQoIG9wLCBtcyApOwoKCQlyZXR1cm4gaWQ7Cgl9LAoKCS8qKgoJICogUXVlcmllcyBET00gd2l0aCBmYXN0ZXN0IG1ldGhvZAoJICoKCSAqIEBtZXRob2QgZG9tCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyBET00gcXVlcnkKCSAqIEByZXR1cm4ge01peGVkfSAgICAgIHVuZGVmaW5lZCwgRWxlbWVudCwgb3IgQXJyYXkgb2YgRWxlbWVudHMKCSAqLwoJZG9tIDogZnVuY3Rpb24gKCBhcmcgKSB7CgkJdmFyIHJlc3VsdDsKCgkJaWYgKCAhcmVnZXguc2VsZWN0b3JfY29tcGxleC50ZXN0KCBhcmcgKSApIHsKCQkJaWYgKCByZWdleC5oYXNoLnRlc3QoIGFyZyApICkgewoJCQkJcmVzdWx0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIGFyZy5yZXBsYWNlKCByZWdleC5oYXNoLCAiIiApICkgfHwgdW5kZWZpbmVkOwoJCQl9CgkJCWVsc2UgaWYgKCByZWdleC5rbGFzcy50ZXN0KCBhcmcgKSApIHsKCQkJCXJlc3VsdCA9IGFycmF5LmNhc3QoIGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoIGFyZy5yZXBsYWNlKCByZWdleC5rbGFzcywgIiIgKSApICk7CgkJCX0KCQkJZWxzZSBpZiAoIHJlZ2V4LndvcmQudGVzdCggYXJnICkgKSB7CgkJCQlyZXN1bHQgPSBhcnJheS5jYXN0KCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSggYXJnICkgKTsKCQkJfQoJCQllbHNlIHsKCQkJCXJlc3VsdCA9IGFycmF5LmNhc3QoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIGFyZyApICk7CgkJCX0KCQl9CgkJZWxzZSB7CgkJCXJlc3VsdCA9IGFycmF5LmNhc3QoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIGFyZyApICk7CgkJfQoKCQlyZXR1cm4gcmVzdWx0OwoJfSwKCgkvKioKCSAqIEVuY29kZXMgYSBVVUlEIHRvIGEgRE9NIGZyaWVuZGx5IElECgkgKgoJICogQG1ldGhvZCBkb21JZAoJICogQHBhcmFtICB7U3RyaW5nfSBVVUlECgkgKiBAcmV0dXJuIHtTdHJpbmd9IERPTSBmcmllbmRseSBJRAoJICovCglkb21JZCA6IGZ1bmN0aW9uICggYXJnICkgewoJCXJldHVybiAiYSIgKyBhcmcucmVwbGFjZSggLy0vZywgIiIgKS5zbGljZSggMSApOwoJfSwKCgkvKioKCSAqIEVycm9yIGhhbmRsaW5nLCB3aXRoIGhpc3RvcnkgaW4gLmxvZwoJICoKCSAqIEBtZXRob2QgZXJyb3IKCSAqIEBwYXJhbSAge01peGVkfSAgIGUgICAgICAgRXJyb3Igb2JqZWN0IG9yIG1lc3NhZ2UgdG8gZGlzcGxheQoJICogQHBhcmFtICB7QXJyYXl9ICAgYXJncyAgICBBcnJheSBvZiBhcmd1bWVudHMgZnJvbSB0aGUgY2FsbHN0YWNrCgkgKiBAcGFyYW0gIHtNaXhlZH0gICBzY29wZSAgIEVudGl0eSB0aGF0IHdhcyAidGhpcyIKCSAqIEBwYXJhbSAge0Jvb2xlYW59IHdhcm5pbmcgW09wdGlvbmFsXSBXaWxsIGRpc3BsYXkgYXMgY29uc29sZSB3YXJuaW5nIGlmIHRydWUKCSAqIEByZXR1cm4ge1VuZGVmaW5lZH0gICAgICAgdW5kZWZpbmVkCgkgKi8KCWVycm9yIDogZnVuY3Rpb24gKCBlLCBhcmdzLCBzY29wZSwgd2FybmluZyApIHsKCQl3YXJuaW5nID0gKCB3YXJuaW5nID09PSB0cnVlICk7CgkJdmFyIG8gICA9IHsKCQkJImFyZ3VtZW50cyIgOiBhcmdzICE9PSB1bmRlZmluZWQgPyBhcnJheS5jYXN0KCBhcmdzICkgOiBbXSwKCQkJbWVzc2FnZSAgICAgOiBlLm1lc3NhZ2UgfHwgZSwKCQkJbnVtYmVyICAgICAgOiBlLm51bWJlciAhPT0gdW5kZWZpbmVkID8gKCBlLm51bWJlciAmIDB4RkZGRiApIDogdW5kZWZpbmVkLAoJCQlzY29wZSAgICAgICA6IHNjb3BlLAoJCQlzdGFjayAgICAgICA6IGUuc3RhY2sgICB8fCB1bmRlZmluZWQsCgkJCXRpbWVzdGFtcCAgIDogbmV3IERhdGUoKS50b1VUQ1N0cmluZygpLAoJCQl0eXBlICAgICAgICA6IGUudHlwZSAgICB8fCAiVHlwZUVycm9yIgoJCX07CgoJCXV0aWxpdHkubG9nKCAoIG8uc3RhY2sgfHwgby5tZXNzYWdlIHx8IG8gKSwgIXdhcm5pbmcgPyAiZXJyb3IiIDogIndhcm4iICk7CgkJdXRpbGl0eS5lcnJvci5sb2cucHVzaCggbyApOwoJCW9ic2VydmVyLmZpcmUoIGFiYWFzbywgImVycm9yIiwgbyApOwoKCQlyZXR1cm4gdW5kZWZpbmVkOwoJfSwKCgkvKioKCSAqIENyZWF0ZXMgYSAiY2xhc3MiIGV4dGVuZGluZyBPYmplY3QsIHdpdGggb3B0aW9uYWwgZGVjb3JhdGlvbgoJICoKCSAqIEBtZXRob2QgZXh0ZW5kCgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiBPYmplY3QgdG8gZXh0ZW5kCgkgKiBAcGFyYW0gIHtPYmplY3R9IGFyZyBbT3B0aW9uYWxdIE9iamVjdCBmb3IgZGVjb3JhdGlvbgoJICogQHJldHVybiB7T2JqZWN0fSAgICAgRGVjb3JhdGVkIG9iagoJICovCglleHRlbmQgOiBmdW5jdGlvbiAoKSB7CgkJaWYgKCB0eXBlb2YgT2JqZWN0LmNyZWF0ZSA9PT0gImZ1bmN0aW9uIiApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJCQl2YXIgbzsKCgkJCQlpZiAoIG9iaiA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuZXJyb3IuaW52YWxpZEFyZ3VtZW50cyApOwoJCQkJfQoKCQkJCW8gPSBPYmplY3QuY3JlYXRlKCBvYmogKTsKCgkJCQlpZiAoIGFyZyBpbnN0YW5jZW9mIE9iamVjdCApIHsKCQkJCQl1dGlsaXR5Lm1lcmdlKCBvLCBhcmcgKTsKCQkJCX0KCgkJCQlyZXR1cm4gbzsKCQkJfTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCQkJZnVuY3Rpb24gRXh0ZW5kZWQgKCkge30KCgkJCQl2YXIgbzsKCgkJCQlpZiAoIG9iaiA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuZXJyb3IuaW52YWxpZEFyZ3VtZW50cyApOwoJCQkJfQoKCQkJCUV4dGVuZGVkLnByb3RvdHlwZSA9IG9iajsKCgkJCQlvID0gbmV3IEV4dGVuZGVkKCk7CgoJCQkJaWYgKCBhcmcgaW5zdGFuY2VvZiBPYmplY3QgKSB7CgkJCQkJdXRpbGl0eS5tZXJnZSggbywgYXJnICk7CgkJCQl9CgoJCQkJcmV0dXJuIG87CgkJCX07CgkJfQoJfSgpLAoKCS8qKgoJICogRmlib25hY2NpIGNhbGN1bGF0b3IKCSAqCgkgKiBAbWV0aG9kIGZpYgoJICogQHBhcmFtICB7TnVtYmVyfSAgaSBOdW1iZXIgdG8gY2FsY3VsYXRlCgkgKiBAcGFyYW0gIHtCb29sZWFufSByIFJlY3Vyc2l2ZSBpZiBgdHJ1ZWAKCSAqIEByZXR1cm4ge051bWJlcn0gICAgQ2FsY3VsYXRlZCBudW1iZXIKCSAqLwoJZmliIDogZnVuY3Rpb24gKCBpLCByICkgewoJCWlmICggciA9PT0gdHJ1ZSApIHsKCQkJcmV0dXJuIGkgPiAxID8gdXRpbGl0eS5maWIoIGkgLSAxLCByICkgKyB1dGlsaXR5LmZpYiggaSAtIDIsIHIgKSA6IGk7CgkJfQoJCWVsc2UgewoJCQlyZXR1cm4gYXJyYXkubGFzdCggYXJyYXkuZmliKCBpICkgKTsKCQl9Cgl9LAoKCS8qKgoJICogR2VuZXJhdGVzIGFuIElEIHZhbHVlCgkgKgoJICogQG1ldGhvZCBnZW5JZAoJICogQHBhcmFtICB7TWl4ZWR9ICAgb2JqIFtPcHRpb25hbF0gT2JqZWN0IHRvIHJlY2VpdmUgaWQKCSAqIEBwYXJhbSAge0Jvb2xlYW59IGRvbSBbT3B0aW9uYWxdIFZlcmlmeSB0aGUgSUQgaXMgdW5pcXVlIGluIHRoZSBET00sIGRlZmF1bHQgaXMgZmFsc2UKCSAqIEByZXR1cm4ge01peGVkfSAgICAgICBPYmplY3Qgb3IgaWQKCSAqLwoJZ2VuSWQgOiBmdW5jdGlvbiAoIG9iaiwgZG9tICkgewoJCWRvbSA9ICggZG9tID09PSB0cnVlICk7CgkJdmFyIGlkOwoKCQlpZiAoIG9iaiAhPT0gdW5kZWZpbmVkICYmICggKCBvYmouaWQgIT09IHVuZGVmaW5lZCAmJiBvYmouaWQgIT09ICIiICkgfHwgKCBvYmogaW5zdGFuY2VvZiBBcnJheSApIHx8ICggb2JqIGluc3RhbmNlb2YgU3RyaW5nIHx8IHR5cGVvZiBvYmogPT09ICJzdHJpbmciICkgKSApIHsKCQkJcmV0dXJuIG9iajsKCQl9CgoJCWlmICggZG9tICkgewoJCQlkbyB7CgkJCQlpZCA9IHV0aWxpdHkuZG9tSWQoIHV0aWxpdHkudXVpZCggdHJ1ZSkgKTsKCQkJfQoJCQl3aGlsZSAoIHV0aWxpdHkuJCggIiMiICsgaWQgKSAhPT0gdW5kZWZpbmVkICk7CgkJfQoJCWVsc2UgewoJCQlpZCA9IHV0aWxpdHkuZG9tSWQoIHV0aWxpdHkudXVpZCggdHJ1ZSkgKTsKCQl9CgoJCWlmICggdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgKSB7CgkJCW9iai5pZCA9IGlkOwoKCQkJcmV0dXJuIG9iajsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiBpZDsKCQl9Cgl9LAoKCS8qKgoJICogR2V0dGVyIC8gc2V0dGVyIGZvciB0aGUgaGFzaGJhbmcKCSAqCgkgKiBAbWV0aG9kIGhhc2gKCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnIFJvdXRlIHRvIHNldAoJICogQHJldHVybiB7U3RyaW5nfSAgICAgQ3VycmVudCByb3V0ZQoJICovCgloYXNoIDogZnVuY3Rpb24gKCBhcmcgKSB7CgkJaWYgKCBhcmcgIT09IHVuZGVmaW5lZCApIHsKCQkJZG9jdW1lbnQubG9jYXRpb24uaGFzaCA9IGFyZzsKCQl9CgoJCXJldHVybiBkb2N1bWVudC5sb2NhdGlvbi5oYXNoOwoJfSwKCgkvKioKCSAqIENvbnZlcnRzIFJHQiB0byBIRVgKCSAqCgkgKiBAbWV0aG9kIGhleAoJICogQHBhcmFtICB7U3RyaW5nfSBjb2xvciBSR0IgYXMgYHJnYigyNTUsIDI1NSwgMjU1KWAgb3IgYDI1NSwgMjU1LCAyNTVgCgkgKiBAcmV0dXJuIHtTdHJpbmd9ICAgICAgIENvbG9yIGFzIEhFWAoJICovCgloZXggOiBmdW5jdGlvbiAoIGNvbG9yICkgewoJCXZhciBkaWdpdHMsIHJlZCwgZ3JlZW4sIGJsdWUsIHJlc3VsdCwgaSwgbnRoOwoKCQlpZiAoIGNvbG9yLmNoYXJBdCggMCApID09PSAiIyIgKSB7CgkJICAgIHJlc3VsdCA9IGNvbG9yOwoJCX0KCQllbHNlIHsKCQkJZGlnaXRzID0gc3RyaW5nLmV4cGxvZGUoIGNvbG9yLnJlcGxhY2UoIC8uKlwofFwpL2csICIiICkgKTsKCQkJcmVkICAgID0gbnVtYmVyLnBhcnNlKCBkaWdpdHNbMF0gfHwgMCApOwoJCQlncmVlbiAgPSBudW1iZXIucGFyc2UoIGRpZ2l0c1sxXSB8fCAwICk7CgkJCWJsdWUgICA9IG51bWJlci5wYXJzZSggZGlnaXRzWzJdIHx8IDAgKTsKCQkJcmVzdWx0ID0gKCBibHVlIHwgKCBncmVlbiA8PCA4ICkgfCAoIHJlZCA8PCAxNiApICkudG9TdHJpbmcoIDE2ICk7CgoJCQlpZiAoIHJlc3VsdC5sZW5ndGggPCA2ICkgewoJCQkJbnRoID0gbnVtYmVyLmRpZmYoIHJlc3VsdC5sZW5ndGgsIDYgKTsKCQkJCWkgICA9IC0xOwoKCQkJCXdoaWxlICggKytpIDwgbnRoICkgewoJCQkJCXJlc3VsdCA9ICIwIiArIHJlc3VsdDsKCQkJCX0KCQkJfQoKCQkJcmVzdWx0ID0gIiMiICsgcmVzdWx0OwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJLyoqCgkgKiBJdGVyYXRlcyBhbiBPYmplY3QgYW5kIGV4ZWN1dGVzIGEgZnVuY3Rpb24gYWdhaW5zdCB0aGUgcHJvcGVydGllcwoJICoKCSAqIEl0ZXJhdGlvbiBjYW4gYmUgc3RvcHBlZCBieSByZXR1cm5pbmcgZmFsc2UgZnJvbSBmbgoJICoKCSAqIEBtZXRob2QgaXRlcmF0ZQoJICogQHBhcmFtICB7T2JqZWN0fSAgIG9iaiBPYmplY3QgdG8gaXRlcmF0ZQoJICogQHBhcmFtICB7RnVuY3Rpb259IGZuICBGdW5jdGlvbiB0byBleGVjdXRlIGFnYWluc3QgcHJvcGVydGllcwoJICogQHJldHVybiB7T2JqZWN0fSAgICAgICBPYmplY3QKCSAqLwoJaXRlcmF0ZSA6IGZ1bmN0aW9uICgpIHsKCQlpZiAoIHR5cGVvZiBPYmplY3Qua2V5cyA9PT0gImZ1bmN0aW9uIiApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uICggb2JqLCBmbiApIHsKCQkJCWlmICggdHlwZW9mIGZuICE9PSAiZnVuY3Rpb24iICkgewoJCQkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuZXJyb3IuaW52YWxpZEFyZ3VtZW50cyApOwoJCQkJfQoKCQkJCWFycmF5LmVhY2goIE9iamVjdC5rZXlzKCBvYmogKSwgZnVuY3Rpb24gKCBpICkgewoJCQkJCXJldHVybiBmbi5jYWxsKCBvYmosIG9ialtpXSwgaSApOwoJCQkJfSk7CgoJCQkJcmV0dXJuIG9iajsKCQkJfTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiBmdW5jdGlvbiAoIG9iaiwgZm4gKSB7CgkJCQl2YXIgaSwgcmVzdWx0OwoKCQkJCWlmICggdHlwZW9mIGZuICE9PSAiZnVuY3Rpb24iICkgewoJCQkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuZXJyb3IuaW52YWxpZEFyZ3VtZW50cyApOwoJCQkJfQoKCQkJCWZvciAoIGkgaW4gb2JqICkgewoJCQkJCWlmICggaGFzLmNhbGwoIG9iaiwgaSApICkgewoJCQkJCQlyZXN1bHQgPSBmbi5jYWxsKCBvYmosIG9ialtpXSwgaSApOwoKCQkJCQkJaWYgKCByZXN1bHQgPT09IGZhbHNlICkgewoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQkJZWxzZSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gb2JqOwoJCQl9OwoJCX0KCX0oKSwKCgkvKioKCSAqIFJlbmRlcnMgYSBsb2FkaW5nIGljb24gaW4gYSB0YXJnZXQgZWxlbWVudCwKCSAqIHdpdGggYSBjbGFzcyBvZiAibG9hZGluZyIKCSAqCgkgKiBAbWV0aG9kIGxvYWRpbmcKCSAqIEBwYXJhbSAge01peGVkfSBvYmogRWxlbWVudAoJICogQHJldHVybiB7TWl4ZWR9ICAgICBFbGVtZW50CgkgKi8KCWxvYWRpbmcgOiBmdW5jdGlvbiAoIG9iaiApIHsKCQl2YXIgbCA9IGFiYWFzby5sb2FkaW5nOwoKCQlpZiAoIGwudXJsID09PSBudWxsIHx8IG9iaiA9PT0gdW5kZWZpbmVkICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmVycm9yLmludmFsaWRBcmd1bWVudHMgKTsKCQl9CgoJCS8vIFNldHRpbmcgbG9hZGluZyBpbWFnZQoJCWlmICggbC5pbWFnZSA9PT0gdW5kZWZpbmVkICkgewoJCQlsLmltYWdlICAgICA9IG5ldyBJbWFnZSgpOwoJCQlsLmltYWdlLnNyYyA9IGwudXJsOwoJCX0KCgkJLy8gQ2xlYXJpbmcgdGFyZ2V0IGVsZW1lbnQKCQllbGVtZW50LmNsZWFyKCBvYmogKTsKCgkJLy8gQ3JlYXRpbmcgbG9hZGluZyBpbWFnZSBpbiB0YXJnZXQgZWxlbWVudAoJCWVsZW1lbnQuY3JlYXRlKCAiaW1nIiwge2FsdDogbGFiZWwuY29tbW9uLmxvYWRpbmcsIHNyYzogbC5pbWFnZS5zcmN9LCBlbGVtZW50LmNyZWF0ZSggImRpdiIsIHsiY2xhc3MiOiAibG9hZGluZyJ9LCBvYmogKSApOwoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFdyaXRlcyBhcmd1bWVudCB0byB0aGUgY29uc29sZQoJICoKCSAqIEBtZXRob2QgbG9nCgkgKiBAcGFyYW0gIHtTdHJpbmd9IGFyZyAgICBTdHJpbmcgdG8gd3JpdGUgdG8gdGhlIGNvbnNvbGUKCSAqIEBwYXJhbSAge1N0cmluZ30gdGFyZ2V0IFtPcHRpb25hbF0gVGFyZ2V0IGNvbnNvbGUsIGRlZmF1bHQgaXMgImxvZyIKCSAqIEByZXR1cm4ge1VuZGVmaW5lZH0gICAgIHVuZGVmaW5lZAoJICovCglsb2cgOiBmdW5jdGlvbiAoIGFyZywgdGFyZ2V0ICkgewoJCXZhciB0cywgbXNnOwoKCQlpZiAoIHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiApIHsKCQkJdHMgID0gdHlwZW9mIGFyZyAhPT0gIm9iamVjdCI7CgkJCW1zZyA9IHRzID8gIlsiICsgbmV3IERhdGUoKS50b0xvY2FsZVRpbWVTdHJpbmcoKSArICJdICIgKyBhcmcgOiBhcmc7CgkJCWNvbnNvbGVbdGFyZ2V0IHx8ICJsb2ciXSggbXNnICk7CgkJfQoJfSwKCgkvKioKCSAqIE1lcmdlcyBvYmogd2l0aCBhcmcKCSAqCgkgKiBAbWV0aG9kIG1lcmdlCgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiBPYmplY3QgdG8gZGVjb3JhdGUKCSAqIEBwYXJhbSAge09iamVjdH0gYXJnIERlY29yYXRpb24KCSAqIEByZXR1cm4ge09iamVjdH0gICAgIERlY29yYXRlZCBPYmplY3QKCSAqLwoJbWVyZ2UgOiBmdW5jdGlvbiAoIG9iaiwgYXJnICkgewoJCXV0aWxpdHkuaXRlcmF0ZSggYXJnLCBmdW5jdGlvbiAoIHYsIGsgKSB7CgkJCWlmICggKCBvYmpba10gaW5zdGFuY2VvZiBBcnJheSApICYmICggdiBpbnN0YW5jZW9mIEFycmF5ICkgKSB7CgkJCQlhcnJheS5tZXJnZSggb2JqW2tdLCB2ICk7CgkJCX0KCQkJZWxzZSBpZiAoICggb2JqW2tdIGluc3RhbmNlb2YgT2JqZWN0ICkgJiYgKCB2IGluc3RhbmNlb2YgT2JqZWN0ICkgKSB7CgkJCQl1dGlsaXR5Lml0ZXJhdGUoIHYsIGZ1bmN0aW9uICggeCwgeSApIHsKCQkJCQlvYmpba11beV0gPSB1dGlsaXR5LmNsb25lKCB4ICk7CgkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCW9ialtrXSA9IHV0aWxpdHkuY2xvbmUoIHYgKTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfSwKCQoJLyoqCgkgKiBSZWdpc3RlcnMgYSBtb2R1bGUgb24gYWJhYXNvCgkgKgoJICogQG1ldGhvZCBtb2R1bGUKCSAqIEBwYXJhbSAge1N0cmluZ30gYXJnIE1vZHVsZSBuYW1lCgkgKiBAcGFyYW0gIHtPYmplY3R9IG9iaiBNb2R1bGUgc3RydWN0dXJlCgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgICBNb2R1bGUgcmVnaXN0ZXJlZAoJICovCgltb2R1bGUgOiBmdW5jdGlvbiAoIGFyZywgb2JqICkgewoJCWlmICggJFthcmddICE9PSB1bmRlZmluZWQgfHwgIW9iaiBpbnN0YW5jZW9mIE9iamVjdCApIHsKCQkJdGhyb3cgbmV3IEVycm9yKCBsYWJlbC5lcnJvci5pbnZhbGlkQXJndW1lbnRzICk7CgkJfQoJCQoJCSRbYXJnXSA9IG9iajsKCgkJcmV0dXJuICRbYXJnXTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIE9iamVjdCwgb3IgcmVmZXJlbmNlIHRvIEVsZW1lbnQKCSAqCgkgKiBAbWV0aG9kIG9iamVjdAoJICogQHByaXZhdGUKCSAqIEBwYXJhbSAge01peGVkfSBvYmogRW50aXR5IG9yICQgcXVlcnkKCSAqIEByZXR1cm4ge01peGVkfSAgICAgRW50aXR5CgkgKi8KCW9iamVjdCA6IGZ1bmN0aW9uICggb2JqICkgewoJCXJldHVybiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IiA/IG9iaiA6ICggb2JqLmNoYXJBdCAmJiBvYmouY2hhckF0KCAwICkgPT09ICIjIiA/IHV0aWxpdHkuJCggb2JqICkgOiBvYmogKTsKCX0sCgoJLyoqCgkgKiBQYXJzZXMgYSBVUkkgaW50byBhbiBPYmplY3QKCSAqCgkgKiBAbWV0aG9kIHBhcnNlCgkgKiBAcGFyYW0gIHtTdHJpbmd9IHVyaSBVUkkgdG8gcGFyc2UKCSAqIEByZXR1cm4ge09iamVjdH0gICAgIFBhcnNlZCBVUkkKCSAqLwoJcGFyc2UgOiBmdW5jdGlvbiAoIHVyaSApIHsKCQl2YXIgb2JqICAgID0ge30sCgkJICAgIHBhcnNlZCA9IHt9OwoKCQlpZiAoIHVyaSA9PT0gdW5kZWZpbmVkICkgewoJCQl1cmkgPSAhc2VydmVyID8gbG9jYXRpb24uaHJlZiA6ICIiOwoJCX0KCgkJaWYgKCAhc2VydmVyICkgewoJCQlvYmogPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKTsKCQkJb2JqLmhyZWYgPSB1cmk7CgkJfQoJCWVsc2UgewoJCQlvYmogPSB1cmwucGFyc2UoIHVyaSApOwoJCX0KCgkJaWYgKCBzZXJ2ZXIgKSB7CgkJCXV0aWxpdHkuaXRlcmF0ZSggb2JqLCBmdW5jdGlvbiAoIHYsIGsgKSB7CgkJCQlpZiAoIHYgPT09IG51bGwgKSB7CgkJCQkJb2JqW2tdID0gdW5kZWZpbmVkOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXBhcnNlZCA9IHsKCQkJYXV0aCAgICAgOiBzZXJ2ZXIgPyBudWxsIDogcmVnZXguYXV0aC5leGVjKCB1cmkgKSwKCQkJcHJvdG9jb2wgOiBvYmoucHJvdG9jb2wgfHwgImh0dHA6IiwKCQkJaG9zdG5hbWUgOiBvYmouaG9zdG5hbWUgfHwgImxvY2FsaG9zdCIsCgkJCXBvcnQgICAgIDogb2JqLnBvcnQgPyBudW1iZXIucGFyc2UoIG9iai5wb3J0LCAxMCApIDogIiIsCgkJCXBhdGhuYW1lIDogb2JqLnBhdGhuYW1lLAoJCQlzZWFyY2ggICA6IG9iai5zZWFyY2ggICB8fCAiIiwKCQkJaGFzaCAgICAgOiBvYmouaGFzaCAgICAgfHwgIiIsCgkJCWhvc3QgICAgIDogb2JqLmhvc3QgICAgIHx8ICJsb2NhbGhvc3QiCgkJfTsKCgkJLy8gJ2NhdXNlIElFIGlzIC4uLiBJRTsgcmVxdWlyZWQgZm9yIGRhdGEuYmF0Y2goKQoJCWlmICggY2xpZW50LmllICkgewoJCQlpZiAoIHBhcnNlZC5wcm90b2NvbCA9PT0gIjoiICkgewoJCQkJcGFyc2VkLnByb3RvY29sID0gbG9jYXRpb24ucHJvdG9jb2w7CgkJCX0KCgkJCWlmICggc3RyaW5nLmlzRW1wdHkoIHBhcnNlZC5ob3N0bmFtZSApICkgewoJCQkJcGFyc2VkLmhvc3RuYW1lID0gbG9jYXRpb24uaG9zdG5hbWU7CgkJCX0KCgkJCWlmICggc3RyaW5nLmlzRW1wdHkoIHBhcnNlZC5ob3N0ICkgKSB7CgkJCQlwYXJzZWQuaG9zdCA9IGxvY2F0aW9uLmhvc3Q7CgkJCX0KCgkJCWlmICggcGFyc2VkLnBhdGhuYW1lLmNoYXJBdCggMCApICE9PSAiLyIgKSB7CgkJCQlwYXJzZWQucGF0aG5hbWUgPSAiLyIgKyBwYXJzZWQucGF0aG5hbWU7CgkJCX0KCQl9CgoJCXBhcnNlZC5hdXRoICA9IG9iai5hdXRoIHx8ICggcGFyc2VkLmF1dGggPT09IG51bGwgPyAiIiA6IHBhcnNlZC5hdXRoWzFdICk7CgkJcGFyc2VkLmhyZWYgID0gb2JqLmhyZWYgfHwgKCBwYXJzZWQucHJvdG9jb2wgKyAiLy8iICsgKCBzdHJpbmcuaXNFbXB0eSggcGFyc2VkLmF1dGggKSA/ICIiIDogcGFyc2VkLmF1dGggKyAiQCIgKSArIHBhcnNlZC5ob3N0ICsgcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaCArIHBhcnNlZC5oYXNoICk7CgkJcGFyc2VkLnBhdGggID0gb2JqLnBhdGggfHwgcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQlwYXJzZWQucXVlcnkgPSB1dGlsaXR5LnF1ZXJ5U3RyaW5nKCBudWxsLCBwYXJzZWQuc2VhcmNoICk7CgoJCXJldHVybiBwYXJzZWQ7Cgl9LAoKCS8qKgoJICogU2V0cyBhIHByb3BlcnR5IG9uIGFuIE9iamVjdCwgaWYgZGVmaW5lUHJvcGVydHkgY2Fubm90IGJlIHVzZWQgdGhlIHZhbHVlIHdpbGwgYmUgc2V0IGNsYXNzaWNhbGx5CgkgKgoJICogQG1ldGhvZCBwcm9wZXJ0eQoJICogQHBhcmFtICB7T2JqZWN0fSBvYmogICAgICAgIE9iamVjdCB0byBkZWNvcmF0ZQoJICogQHBhcmFtICB7U3RyaW5nfSBwcm9wICAgICAgIE5hbWUgb2YgcHJvcGVydHkgdG8gc2V0CgkgKiBAcGFyYW0gIHtPYmplY3R9IGRlc2NyaXB0b3IgRGVzY3JpcHRvciBvZiB0aGUgcHJvcGVydHkKCSAqIEByZXR1cm4ge09iamVjdH0gICAgICAgICAgICBPYmplY3QgcmVjZWl2aW5nIHRoZSBwcm9wZXJ0eQoJICovCglwcm9wZXJ0eSA6IGZ1bmN0aW9uICgpIHsKCQlpZiAoICggc2VydmVyIHx8ICggIWNsaWVudC5pZSB8fCBjbGllbnQudmVyc2lvbiA+IDggKSApICYmIHR5cGVvZiBPYmplY3QuZGVmaW5lUHJvcGVydHkgPT09ICJmdW5jdGlvbiIgKSB7CgkJCXJldHVybiBmdW5jdGlvbiAoIG9iaiwgcHJvcCwgZGVzY3JpcHRvciApIHsKCQkJCWlmICggISggZGVzY3JpcHRvciBpbnN0YW5jZW9mIE9iamVjdCApICkgewoJCQkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuZXJyb3IuaW52YWxpZEFyZ3VtZW50cyApOwoJCQkJfQoKCQkJCWlmICggZGVzY3JpcHRvci52YWx1ZSAhPT0gdW5kZWZpbmVkICYmIGRlc2NyaXB0b3IuZ2V0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJZGVsZXRlIGRlc2NyaXB0b3IudmFsdWU7CgkJCQl9CgoJCQkJT2JqZWN0LmRlZmluZVByb3BlcnR5KCBvYmosIHByb3AsIGRlc2NyaXB0b3IgKTsKCQkJfTsKCQl9CgkJZWxzZSB7CgkJCXJldHVybiBmdW5jdGlvbiAoIG9iaiwgcHJvcCwgZGVzY3JpcHRvciApIHsKCQkJCWlmICggISggZGVzY3JpcHRvciBpbnN0YW5jZW9mIE9iamVjdCApICkgewoJCQkJCXRocm93IG5ldyBFcnJvciggbGFiZWwuZXJyb3IuaW52YWxpZEFyZ3VtZW50cyApOwoJCQkJfQoKCQkJCW9ialtwcm9wXSA9IGRlc2NyaXB0b3IudmFsdWU7CgoJCQkJcmV0dXJuIG9iajsKCQkJfTsKCQl9Cgl9LAoKCS8qKgoJICogU2V0cyBtZXRob2RzIG9uIGEgcHJvdG90eXBlIG9iamVjdAoJICoKCSAqIEFsbG93cyBob29rcyB0byBiZSBvdmVyd3JpdHRlbgoJICoKCSAqIEBtZXRob2QgcHJvdG8KCSAqIEBwYXJhbSAge09iamVjdH0gb2JqICBPYmplY3QgcmVjZWl2aW5nIHByb3RvdHlwZSBleHRlbnNpb24KCSAqIEBwYXJhbSAge1N0cmluZ30gdHlwZSBJZGVudGlmaWVyIG9mIG9iaiwgZGV0ZXJtaW5lcyB3aGF0IEFycmF5cyB0byBhcHBseQoJICogQHJldHVybiB7T2JqZWN0fSAgICAgIG9iaiBvciB1bmRlZmluZWQKCSAqLwoJcHJvdG8gOiBmdW5jdGlvbiAoIG9iaiwgdHlwZSApIHsKCQl2YXIgdGFyZ2V0ID0gb2JqLnByb3RvdHlwZSB8fCBvYmo7CgoJCXV0aWxpdHkuaXRlcmF0ZSggcHJvdG90eXBlc1t0eXBlXSwgZnVuY3Rpb24gKCB2LCBrICkgewoJCQlpZiAoICF0YXJnZXRba10gKSB7CgkJCQl1dGlsaXR5LnByb3BlcnR5KCB0YXJnZXQsIGssIHt2YWx1ZTogdiwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZX0gKTsKCQkJfQoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfSwKCgkvKioKCSAqIFBhcnNlcyBhIHF1ZXJ5IHN0cmluZyAmIGNvZXJjZXMgdmFsdWVzCgkgKgoJICogQG1ldGhvZCBxdWVyeVN0cmluZwoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgICAgIFtPcHRpb25hbF0gS2V5IHRvIGZpbmQgaW4gdGhlIHF1ZXJ5c3RyaW5nCgkgKiBAcGFyYW0gIHtTdHJpbmd9IHFzdHJpbmcgW09wdGlvbmFsXSBRdWVyeSBzdHJpbmcgdG8gcGFyc2UKCSAqIEByZXR1cm4ge01peGVkfSAgICAgICAgICBWYWx1ZSBvciBPYmplY3Qgb2Yga2V5OnZhbHVlIHBhaXJzCgkgKi8KCXF1ZXJ5U3RyaW5nIDogZnVuY3Rpb24gKCBhcmcsIHFzdHJpbmcgKSB7CgkJdmFyIG9iaiAgICA9IHt9LAoJCSAgICByZXN1bHQgPSBxc3RyaW5nICE9PSB1bmRlZmluZWQgPyAoIHFzdHJpbmcuaW5kZXhPZiggIj8iICkgPiAtMSA/IHFzdHJpbmcucmVwbGFjZSggLy4qXD8vLCAiIiApIDogbnVsbCkgOiAoIHNlcnZlciB8fCBzdHJpbmcuaXNFbXB0eSggbG9jYXRpb24uc2VhcmNoICkgPyBudWxsIDogbG9jYXRpb24uc2VhcmNoLnJlcGxhY2UoICI/IiwgIiIgKSApOwoKCQlpZiAoIHJlc3VsdCAhPT0gbnVsbCAmJiAhc3RyaW5nLmlzRW1wdHkoIHJlc3VsdCApICkgewoJCQlyZXN1bHQgPSByZXN1bHQuc3BsaXQoICImIiApOwoJCQlhcnJheS5lYWNoKCByZXN1bHQsIGZ1bmN0aW9uIChwcm9wICkgewoJCQkJdmFyIGl0ZW0gPSBwcm9wLnNwbGl0KCAiPSIgKTsKCgkJCQlpZiAoIHN0cmluZy5pc0VtcHR5KCBpdGVtWzBdICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggaXRlbVsxXSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCWl0ZW1bMV0gPSAiIjsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWl0ZW1bMV0gPSB1dGlsaXR5LmNvZXJjZSggZGVjb2RlVVJJQ29tcG9uZW50KCBpdGVtWzFdICkgKTsKCQkJCX0KCgkJCQlpZiAoIG9ialtpdGVtWzBdXSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW9ialtpdGVtWzBdXSA9IGl0ZW1bMV07CgkJCQl9CgkJCQllbHNlIGlmICggIShvYmpbaXRlbVswXV0gaW5zdGFuY2VvZiBBcnJheSkgKSB7CgkJCQkJb2JqW2l0ZW1bMF1dID0gW29ialtpdGVtWzBdXV07CgkJCQkJb2JqW2l0ZW1bMF1dLnB1c2goIGl0ZW1bMV0gKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCW9ialtpdGVtWzBdXS5wdXNoKCBpdGVtWzFdICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJaWYgKCBhcmcgIT09IG51bGwgJiYgYXJnICE9PSB1bmRlZmluZWQgKSB7CgkJCW9iaiA9IG9ialthcmddOwoJCX0KCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIGFuIEFycmF5IG9mIHBhcmFtZXRlcnMgb2YgYSBGdW5jdGlvbgoJICoKCSAqIEBtZXRob2QgcmVmbGVjdAoJICogQHBhcmFtICB7RnVuY3Rpb259IGFyZyBGdW5jdGlvbiB0byByZWZsZWN0CgkgKiBAcmV0dXJuIHtBcnJheX0gICAgICAgIEFycmF5IG9mIHBhcmFtZXRlcnMKCSAqLwoJcmVmbGVjdCA6IGZ1bmN0aW9uICggYXJnICkgewoJCWlmICggYXJnID09PSB1bmRlZmluZWQgKSB7CgkJCWFyZyA9IHRoaXMgfHwgdXRpbGl0eS4kOwoJCX0KCgkJYXJnID0gYXJnLnRvU3RyaW5nKCkubWF0Y2goIHJlZ2V4LnJlZmxlY3QgKVsxXTsKCgkJcmV0dXJuIHN0cmluZy5leHBsb2RlKCBhcmcgKTsKCX0sCgoJLyoqCgkgKiBDcmVhdGVzIGEgcmVjdXJzaXZlIGZ1bmN0aW9uCgkgKgoJICogUmV0dXJuIGZhbHNlIGZyb20gdGhlIGZ1bmN0aW9uIHRvIGhhbHQgcmVjdXJzaW9uCgkgKgoJICogQG1ldGhvZCByZXBlYXQKCSAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmbiAgRnVuY3Rpb24gdG8gZXhlY3V0ZSByZXBlYXRlZGx5CgkgKiBAcGFyYW0gIHtOdW1iZXJ9ICAgbXMgIE1pbGxpc2Vjb25kcyB0byBzdGFnZ2VyIHRoZSBleGVjdXRpb24KCSAqIEBwYXJhbSAge1N0cmluZ30gICBpZCAgW09wdGlvbmFsXSBUaW1lb3V0IElECgkgKiBAcGFyYW0gIHtCb29sZWFufSAgbm93IEV4ZWN1dGVzIGBmbmAgYW5kIHRoZW4gc2V0dXAgcmVwZXRpdGlvbiwgZGVmYXVsdCBpcyBgdHJ1ZWAKCSAqIEByZXR1cm4ge1N0cmluZ30gICAgICAgVGltZW91dCBJRAoJICovCglyZXBlYXQgOiBmdW5jdGlvbiAoIGZuLCBtcywgaWQsIG5vdyApIHsKCQltcyAgPSBtcyB8fCAxMDsKCQlpZCAgPSBpZCB8fCB1dGlsaXR5LnV1aWQoIHRydWUgKTsKCQlub3cgPSAoIG5vdyAhPT0gZmFsc2UgKTsKCgkJLy8gQ291bGQgYmUgdmFsaWQgdG8gcmV0dXJuIGZhbHNlIGZyb20gaW5pdGlhbCBleGVjdXRpb24KCQlpZiAoIG5vdyAmJiBmbigpID09PSBmYWxzZSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ3JlYXRpbmcgcmVwZWF0aW5nIGV4ZWN1dGlvbgoJCXV0aWxpdHkuZGVmZXIoIGZ1bmN0aW9uICgpIHsKCQkJdmFyIHJlY3Vyc2l2ZSA9IGZ1bmN0aW9uICggZm4sIG1zLCBpZCApIHsKCQkJCXZhciByZWN1cnNpdmUgPSB0aGlzOwoKCQkJCWlmICggZm4oKSAhPT0gZmFsc2UgKSB7CgkJCQkJdXRpbGl0eS5yZXBlYXRpbmdbaWRdID0gc2V0VGltZW91dCggZnVuY3Rpb24gKCkgewoJCQkJCQlyZWN1cnNpdmUuY2FsbCggcmVjdXJzaXZlLCBmbiwgbXMsIGlkICk7CgkJCQkJfSwgbXMgKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCWRlbGV0ZSB1dGlsaXR5LnJlcGVhdGluZ1tpZF07CgkJCQl9CgkJCX07CgoJCQlyZWN1cnNpdmUuY2FsbCggcmVjdXJzaXZlLCBmbiwgbXMsIGlkICk7CgkJfSwgbXMsIGlkLCB0cnVlICk7CgoJCXJldHVybiBpZDsKCX0sCgoJLyoqCgkgKiBTdG9wcyBhbiBFdmVudCBmcm9tIGJ1YmJsaW5nCgkgKgoJICogQG1ldGhvZCBzdG9wCgkgKiBAcGFyYW0gIHtPYmplY3R9IGUgRXZlbnQKCSAqIEByZXR1cm4ge09iamVjdH0gICBFdmVudAoJICovCglzdG9wIDogZnVuY3Rpb24gKCBlICkgewoJCWlmICggZS5jYW5jZWxCdWJibGUgIT09IHVuZGVmaW5lZCApIHsKCQkJZS5jYW5jZWxCdWJibGUgPSB0cnVlOwoJCX0KCgkJaWYgKCB0eXBlb2YgZS5wcmV2ZW50RGVmYXVsdCA9PT0gImZ1bmN0aW9uIiApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCgkJaWYgKCB0eXBlb2YgZS5zdG9wUHJvcGFnYXRpb24gPT09ICJmdW5jdGlvbiIgKSB7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoKCQkvLyBBc3N1bWVkIHRvIGFsd2F5cyBiZSB2YWxpZCwgZXZlbiBpZiBpdCdzIG5vdCBkZWNvcmF0ZWQgb24gYGVgICggSSdtIGxvb2tpbmcgYXQgeW91IElFOCApCgkJZS5yZXR1cm5WYWx1ZSA9IGZhbHNlOwoKCQlyZXR1cm4gZTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIHRoZSBFdmVudCB0YXJnZXQKCSAqCgkgKiBAbWV0aG9kIHRhcmdldAoJICogQHBhcmFtICB7T2JqZWN0fSBlIEV2ZW50CgkgKiBAcmV0dXJuIHtPYmplY3R9ICAgRXZlbnQgdGFyZ2V0CgkgKi8KCXRhcmdldCA6IGZ1bmN0aW9uICggZSApIHsKCQlyZXR1cm4gZS50YXJnZXQgfHwgZS5zcmNFbGVtZW50OwoJfSwKCgkvKioKCSAqIFRyYW5zZm9ybXMgSlNPTiB0byBIVE1MIGFuZCBhcHBlbmRzIHRvIEJvZHkgb3IgdGFyZ2V0IEVsZW1lbnQKCSAqCgkgKiBAbWV0aG9kIHRwbAoJICogQHBhcmFtICB7T2JqZWN0fSBkYXRhICAgSlNPTiBPYmplY3QgZGVzY3JpYmluZyBIVE1MCgkgKiBAcGFyYW0gIHtNaXhlZH0gIHRhcmdldCBbT3B0aW9uYWxdIFRhcmdldCBFbGVtZW50IG9yIEVsZW1lbnQuaWQgdG8gcmVjZWl2ZSB0aGUgSFRNTAoJICogQHJldHVybiB7T2JqZWN0fSAgICAgICAgTmV3IEVsZW1lbnQgY3JlYXRlZCBmcm9tIHRoZSB0ZW1wbGF0ZQoJICovCgl0cGwgOiBmdW5jdGlvbiAoIGFyZywgdGFyZ2V0ICkgewoJCXZhciBmcmFnOwoKCQlpZiAoIHR5cGVvZiBhcmcgIT09ICJvYmplY3QiIHx8ICghKHJlZ2V4Lm9iamVjdF91bmRlZmluZWQudGVzdCggdHlwZW9mIHRhcmdldCApICkgJiYgKCB0YXJnZXQgPSB0YXJnZXQuY2hhckF0KCAwICkgPT09ICIjIiA/IHV0aWxpdHkuJCggdGFyZ2V0ICkgOiB1dGlsaXR5LiQoIHRhcmdldCApWzBdICkgPT09IHVuZGVmaW5lZCApICkgewoJCQl0aHJvdyBuZXcgRXJyb3IoIGxhYmVsLmVycm9yLmludmFsaWRBcmd1bWVudHMgKTsKCQl9CgoJCWlmICggdGFyZ2V0ID09PSB1bmRlZmluZWQgKSB7CgkJCXRhcmdldCA9IHV0aWxpdHkuJCggImJvZHkiIClbMF07CgkJfQoKCQlmcmFnICA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKCgkJaWYgKCBhcmcgaW5zdGFuY2VvZiBBcnJheSApIHsKCQkJYXJyYXkuZWFjaCggYXJnLCBmdW5jdGlvbiAoIGkgKSB7CgkJCQllbGVtZW50Lmh0bWwoIGVsZW1lbnQuY3JlYXRlKCBhcnJheS5jYXN0KCBpLCB0cnVlIClbMF0sIGZyYWcgKSwgYXJyYXkuY2FzdChpKVswXSApOwoJCQl9KTsKCQl9CgkJZWxzZSB7CgkJCXV0aWxpdHkuaXRlcmF0ZSggYXJnLCBmdW5jdGlvbiAoIHYsIGsgKSB7CgkJCQlpZiAoIHR5cGVvZiB2ID09PSAic3RyaW5nIiApIHsKCQkJCQllbGVtZW50Lmh0bWwoIGVsZW1lbnQuY3JlYXRlKCBrLCB1bmRlZmluZWQsIGZyYWcgKSwgdiApOwoJCQkJfQoJCQkJZWxzZSBpZiAoICggdiBpbnN0YW5jZW9mIEFycmF5ICkgfHwgKCB2IGluc3RhbmNlb2YgT2JqZWN0ICkgKSB7CgkJCQkJdXRpbGl0eS50cGwoIHYsIGVsZW1lbnQuY3JlYXRlKCBrLCB1bmRlZmluZWQsIGZyYWcgKSApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXRhcmdldC5hcHBlbmRDaGlsZCggZnJhZyApOwoKCQlyZXR1cm4gYXJyYXkubGFzdCggdGFyZ2V0LmNoaWxkTm9kZXMgKTsKCX0sCgoJLyoqCgkgKiBHZW5lcmF0ZXMgYSB2ZXJzaW9uIDQgVVVJRAoJICoKCSAqIEBtZXRob2QgdXVpZAoJICogQHBhcmFtICB7Qm9vbGVhbn0gc2FmZSBbT3B0aW9uYWxdIFN0cmlwcyAtIGZyb20gVVVJRAoJICogQHJldHVybiB7U3RyaW5nfSAgICAgICBVVUlECgkgKi8KCXV1aWQgOiBmdW5jdGlvbiAoIHNhZmUgKSB7CgkJdmFyIHMgPSBmdW5jdGlvbiAoKSB7IHJldHVybiAoICggKCAxICsgTWF0aC5yYW5kb20oKSApICogMHgxMDAwMCApIHwgMCApLnRvU3RyaW5nKCAxNiApLnN1YnN0cmluZyggMSApOyB9LAoJCSAgICByID0gWzgsIDksICJhIiwgImIiXSwKCQkgICAgbzsKCgkJbyA9ICggcygpICsgcygpICsgIi0iICsgcygpICsgIi00IiArIHMoKS5zdWJzdHIoIDAsIDMgKSArICItIiArIHJbTWF0aC5mbG9vciggTWF0aC5yYW5kb20oKSAqIDQgKV0gKyBzKCkuc3Vic3RyKCAwLCAzICkgKyAiLSIgKyBzKCkgKyBzKCkgKyBzKCkgKTsKCgkJaWYgKCBzYWZlID09PSB0cnVlICkgewoJCQlvID0gby5yZXBsYWNlKCAvLS9nLCAiIiApOwoJCX0KCgkJcmV0dXJuIG87Cgl9LAoKCS8qKgoJICogV2Fsa3MgYSBzdHJ1Y3R1cmUgYW5kIHJldHVybnMgYXJnCgkgKgoJICogQG1ldGhvZCAgd2FsawoJICogQHBhcmFtICB7TWl4ZWR9ICBvYmogIE9iamVjdCBvciBBcnJheQoJICogQHBhcmFtICB7U3RyaW5nfSBhcmcgIFN0cmluZyBkZXNjcmliaW5nIHRoZSBwcm9wZXJ0eSB0byByZXR1cm4KCSAqIEByZXR1cm4ge01peGVkfSAgICAgICBhcmcKCSAqLwoJd2FsayA6IGZ1bmN0aW9uICggb2JqLCBhcmcgKSB7CgkJYXJyYXkuZWFjaCggYXJnLnJlcGxhY2UoIC9cXSQvLCAiIiApLnJlcGxhY2UoIC9cXS9nLCAiLiIgKS5yZXBsYWNlKCAvXC5cLi9nLCAiLiIgKS5zcGxpdCggL1wufFxbLyApLCBmdW5jdGlvbiAoIGkgKSB7CgkJCW9iaiA9IG9ialtpXTsKCQl9KTsKCgkJcmV0dXJuIG9iajsKCX0sCgoJLyoqCgkgKiBBY2NlcHRzIERlZmVycmVkcyBvciBQcm9taXNlcyBhcyBhcmd1bWVudHMgb3IgYW4gQXJyYXkKCSAqCgkgKiBAbWV0aG9kIHdoZW4KCSAqIEByZXR1cm4ge09iamVjdH0gRGVmZXJyZWQKCSAqLwoJd2hlbiA6IGZ1bmN0aW9uICgpIHsKCQl2YXIgaSAgICAgPSAwLAoJCSAgICBkZWZlciA9IGRlZmVycmVkKCksCgkJICAgIGFyZ3MgID0gYXJyYXkuY2FzdCggYXJndW1lbnRzICksCgkJICAgIG50aDsKCgkJLy8gRGlkIHdlIHJlY2VpdmUgYW4gQXJyYXk/IGlmIHNvIGl0IG92ZXJyaWRlcyBhbnkgb3RoZXIgYXJndW1lbnRzCgkJaWYgKCBhcmdzWzBdIGluc3RhbmNlb2YgQXJyYXkgKSB7CgkJCWFyZ3MgPSBhcmdzWzBdOwoJCX0KCgkJLy8gSG93IG1hbnkgaW5zdGFuY2VzIHRvIG9ic2VydmU/CgkJbnRoID0gYXJncy5sZW5ndGg7CgoJCS8vIE5vbmUsIGVuZCBvbiBuZXh0IHRpY2sKCQlpZiAoIG50aCA9PT0gMCApIHsKCQkJZGVmZXIucmVzb2x2ZSggbnVsbCApOwoJCX0KCQkvLyBTZXR1cCBhbmQgd2FpdAoJCWVsc2UgewoJCQlhcnJheS5lYWNoKCBhcmdzLCBmdW5jdGlvbiAoIHAgKSB7CgkJCQlwLnRoZW4oIGZ1bmN0aW9uICgpIHsKCQkJCQlpZiAoICsraSA9PT0gbnRoICYmICFkZWZlci5pc1Jlc29sdmVkKCkpIHsKCQkJCQkJaWYgKCBhcmdzLmxlbmd0aCA+IDEgKSB7CgkJCQkJCQlkZWZlci5yZXNvbHZlKCBhcmdzLm1hcCggZnVuY3Rpb24gKCBvYmogKSB7CgkJCQkJCQkJcmV0dXJuIG9iai52YWx1ZSB8fCBvYmoucHJvbWlzZS52YWx1ZTsKCQkJCQkJCX0pKTsKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCWRlZmVyLnJlc29sdmUoIGFyZ3NbMF0udmFsdWUgfHwgYXJnc1swXS5wcm9taXNlLnZhbHVlICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9LCBmdW5jdGlvbiAoKSB7CgkJCQkJaWYgKCAhZGVmZXIuaXNSZXNvbHZlZCgpICkgewoJCQkJCQlpZiAoIGFyZ3MubGVuZ3RoID4gMSApIHsKCQkJCQkJCWRlZmVyLnJlamVjdCggYXJncy5tYXAoIGZ1bmN0aW9uICggb2JqICkgewoJCQkJCQkJCXJldHVybiBvYmoudmFsdWUgfHwgb2JqLnByb21pc2UudmFsdWU7CgkJCQkJCQl9KSk7CgkJCQkJCX0KCQkJCQkJZWxzZSB7CgkJCQkJCQlkZWZlci5yZWplY3QoIGFyZ3NbMF0udmFsdWUgfHwgYXJnc1swXS5wcm9taXNlLnZhbHVlICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9KTsKCQkJfSk7CgkJfQoKCQlyZXR1cm4gZGVmZXI7Cgl9Cn07Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 06:04:39 GMT",
                    "Content-Length": "26878",
                    "Date": "Thu, 06 Nov 2014 06:04:39 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}