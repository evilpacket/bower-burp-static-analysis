{
    "url": "http://localhost:9999/yjx3097890/jquery-mobile-dist/demos/js/jquery.mobile.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location.pathname</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>base[ 0 ].href = href || location.pathname;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/yjx3097890/jquery-mobile-dist/demos/js/jquery.mobile.js",
                "path": "/yjx3097890/jquery-mobile-dist/demos/js/jquery.mobile.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC95angzMDk3ODkwL2pxdWVyeS1tb2JpbGUtZGlzdC9kZW1vcy9qcy9qcXVlcnkubW9iaWxlLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDQ2MTMwDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA2OjQ5OjI2IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwNjo0OToyNSBHTVQNCg0KLyohCiogalF1ZXJ5IE1vYmlsZSAxLjUuMC1wcmUKKiBHaXQgSEVBRCBoYXNoOiAzOWNiMjBmZTI2OTY5OTQxMzI5MzQ3ZTJmNDFhMjIyZjk0YzYzMTM4IDw+IERhdGU6IFRodSBTZXAgNCAyMDE0IDAxOjQxOjM2IFVUQwoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMCwgMjAxNCBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXJjb250cmlidXRvcnMKKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCgoKKGZ1bmN0aW9uICggcm9vdCwgZG9jLCBmYWN0b3J5ICkgewoJaWYgKCB0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgKSB7CgkJLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgoJCWRlZmluZSggWyAianF1ZXJ5IiBdLCBmdW5jdGlvbiAoICQgKSB7CgkJCWZhY3RvcnkoICQsIHJvb3QsIGRvYyApOwoJCQlyZXR1cm4gJC5tb2JpbGU7CgkJfSk7Cgl9IGVsc2UgewoJCS8vIEJyb3dzZXIgZ2xvYmFscwoJCWZhY3RvcnkoIHJvb3QualF1ZXJ5LCByb290LCBkb2MgKTsKCX0KfSggdGhpcywgZG9jdW1lbnQsIGZ1bmN0aW9uICggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7CihmdW5jdGlvbiggJCApIHsKCSQubW9iaWxlID0ge307Cn0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJLy8gVmVyc2lvbiBvZiB0aGUgalF1ZXJ5IE1vYmlsZSBGcmFtZXdvcmsKCQl2ZXJzaW9uOiAiMS41LjAtcHJlIiwKCgkJLy8gRGVwcmVjYXRlZCBhbmQgbm8gbG9uZ2VyIHVzZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCWhpZGVVcmxCYXI6IHRydWUsCgoJCS8vIEtlZXBuYXRpdmUgU2VsZWN0b3IKCQlrZWVwTmF0aXZlOiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJmb2N1cyIgZm9ybSBlbGVtZW50IHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlmb2N1c0NsYXNzOiAidWktZm9jdXMiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogImZhZGUiLAoKCQkvLyBTZXQgbWF4aW11bSB3aW5kb3cgd2lkdGggZm9yIHRyYW5zaXRpb25zIHRvIGFwcGx5IC0gJ2ZhbHNlJyBmb3Igbm8gbGltaXQKCQltYXhUcmFuc2l0aW9uV2lkdGg6IGZhbHNlLAoKCQkvLyBNaW5pbXVtIHNjcm9sbCBkaXN0YW5jZSB0aGF0IHdpbGwgYmUgcmVtZW1iZXJlZCB3aGVuIHJldHVybmluZyB0byBhIHBhZ2UKCQkvLyBEZXByZWNhdGVkIHJlbW92ZSBpbiAxLjUKCQltaW5TY3JvbGxCYWNrOiAwLAoKCQkvLyBTZXQgZGVmYXVsdCBkaWFsb2cgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjogInBvcCIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vIEZvciBlcnJvciBtZXNzYWdlcywgd2hpY2ggdGhlbWUgZG9lcyB0aGUgYm94IHVzZT8KCQlwYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lOiAiYSIsCgoJCS8vIHJlcGxhY2UgY2FsbHMgdG8gd2luZG93Lmhpc3RvcnkuYmFjayB3aXRoIHBob25lZ2FwcyBuYXZpZ2F0aW9uIGhlbHBlcgoJCS8vIHdoZXJlIGl0IGlzIHByb3ZpZGVkIG9uIHRoZSB3aW5kb3cgb2JqZWN0CgkJcGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZDogZmFsc2UsCgoJCS8vYXV0b21hdGljYWxseSBpbml0aWFsaXplIHRoZSBET00gd2hlbiBpdCdzIHJlYWR5CgkJYXV0b0luaXRpYWxpemVQYWdlOiB0cnVlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQkvLyBhbGxvd3MgdXNlcnMgdG8gb3B0IGluIHRvIGlnbm9yaW5nIGNvbnRlbnQgYnkgbWFya2luZyBhIHBhcmVudCBlbGVtZW50IGFzCgkJLy8gZGF0YS1pZ25vcmVkCgkJaWdub3JlQ29udGVudEVuYWJsZWQ6IGZhbHNlLAoKCQlidXR0b25NYXJrdXA6IHsKCQkJaG92ZXJEZWxheTogMjAwCgkJfSwKCgkJLy8gZGlzYWJsZSB0aGUgYWx0ZXJhdGlvbiBvZiB0aGUgZHluYW1pYyBiYXNlIHRhZyBvciBsaW5rcyBpbiB0aGUgY2FzZQoJCS8vIHRoYXQgYSBkeW5hbWljIGJhc2UgdGFnIGlzbid0IHN1cHBvcnRlZAoJCWR5bmFtaWNCYXNlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gZGVmYXVsdCB0aGUgcHJvcGVydHkgdG8gcmVtb3ZlIGRlcGVuZGVuY3kgb24gYXNzaWdubWVudCBpbiBpbml0IG1vZHVsZQoJCXBhZ2VDb250YWluZXI6ICQoKSwKCgkJLy9lbmFibGUgY3Jvc3MtZG9tYWluIHBhZ2Ugc3VwcG9ydAoJCWFsbG93Q3Jvc3NEb21haW5QYWdlczogZmFsc2UsCgoJCWRpYWxvZ0hhc2hLZXk6ICImdWktc3RhdGU9ZGlhbG9nIgoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIgbnNOb3JtYWxpemVEaWN0ID0ge30sCgkJb2xkRmluZCA9ICQuZmluZCwKCQlyYnJhY2UgPSAvKD86XHtbXHNcU10qXH18XFtbXHNcU10qXF0pJC8sCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJLy8gTmFtZXNwYWNlIHVzZWQgZnJhbWV3b3JrLXdpZGUgZm9yIGRhdGEtYXR0cnMuIERlZmF1bHQgaXMgbm8gbmFtZXNwYWNlCgoJCW5zOiAiIiwKCgkJLy8gUmV0cmlldmUgYW4gYXR0cmlidXRlIGZyb20gYW4gZWxlbWVudCBhbmQgcGVyZm9ybSBzb21lIG1hc3NhZ2luZyBvZiB0aGUgdmFsdWUKCgkJZ2V0QXR0cmlidXRlOiBmdW5jdGlvbiggZWxlbWVudCwga2V5ICkgewoJCQl2YXIgZGF0YTsKCgkJCWVsZW1lbnQgPSBlbGVtZW50LmpxdWVyeSA/IGVsZW1lbnRbMF0gOiBlbGVtZW50OwoKCQkJaWYgKCBlbGVtZW50ICYmIGVsZW1lbnQuZ2V0QXR0cmlidXRlICkgewoJCQkJZGF0YSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBrZXkgKTsKCQkJfQoKCQkJLy8gQ29waWVkIGZyb20gY29yZSdzIHNyYy9kYXRhLmpzOmRhdGFBdHRyKCkKCQkJLy8gQ29udmVydCBmcm9tIGEgc3RyaW5nIHRvIGEgcHJvcGVyIGRhdGEgdHlwZQoJCQl0cnkgewoJCQkJZGF0YSA9IGRhdGEgPT09ICJ0cnVlIiA/IHRydWUgOgoJCQkJCWRhdGEgPT09ICJmYWxzZSIgPyBmYWxzZSA6CgkJCQkJZGF0YSA9PT0gIm51bGwiID8gbnVsbCA6CgkJCQkJLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcKCQkJCQkrZGF0YSArICIiID09PSBkYXRhID8gK2RhdGEgOgoJCQkJCXJicmFjZS50ZXN0KCBkYXRhICkgPyBKU09OLnBhcnNlKCBkYXRhICkgOgoJCQkJCWRhdGE7CgkJCX0gY2F0Y2goIGVyciApIHt9CgoJCQlyZXR1cm4gZGF0YTsKCQl9LAoKCQkvLyBFeHBvc2Ugb3VyIGNhY2hlIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgoJCW5zTm9ybWFsaXplRGljdDogbnNOb3JtYWxpemVEaWN0LAoKCQkvLyBUYWtlIGEgZGF0YSBhdHRyaWJ1dGUgcHJvcGVydHksIHByZXBlbmQgdGhlIG5hbWVzcGFjZQoJCS8vIGFuZCB0aGVuIGNhbWVsIGNhc2UgdGhlIGF0dHJpYnV0ZSBzdHJpbmcuIEFkZCB0aGUgcmVzdWx0CgkJLy8gdG8gb3VyIG5zTm9ybWFsaXplRGljdCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIHRoaXMgYWdhaW4uCgkJbnNOb3JtYWxpemU6IGZ1bmN0aW9uKCBwcm9wICkgewoJCQlyZXR1cm4gbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gfHwKCQkJCSggbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gPSAkLmNhbWVsQ2FzZSggJC5tb2JpbGUubnMgKyBwcm9wICkgKTsKCQl9LAoKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IGphdmFzY3JpcHQgcGFnZSBlbGVtZW50IHRvIGdhdGhlciBzZXR0aW5ncyBkYXRhIGpzcGVyZiB0ZXN0CgkJLy8gaHR0cDovL2pzcGVyZi5jb20vc2luZ2xlLWNvbXBsZXgtc2VsZWN0b3ItdnMtbWFueS1jb21wbGV4LXNlbGVjdG9ycy9lZGl0CgkJLy8gcG9zc2libHkgbmFpdmUsIGJ1dCBpdCBzaG93cyB0aGF0IHRoZSBwYXJzaW5nIG92ZXJoZWFkIGZvciAqanVzdCogdGhlIHBhZ2Ugc2VsZWN0b3IgdnMKCQkvLyB0aGUgcGFnZSBhbmQgZGlhbG9nIHNlbGVjdG9yIGlzIG5lZ2xpZ2FibGUuIFRoaXMgY291bGQgcHJvYmFibHkgYmUgc3BlZWQgdXAgYnkKCQkvLyBkb2luZyBhIHNpbWlsYXIgcGFyZW50IG5vZGUgdHJhdmVyc2FsIHRvIHRoZSBvbmUgZm91bmQgaW4gdGhlIGluaGVyaXRlZCB0aGVtZSBjb2RlIGFib3ZlCgkJY2xvc2VzdFBhZ2VEYXRhOiBmdW5jdGlvbiggJHRhcmdldCApIHsKCQkJcmV0dXJuICR0YXJnZXQKCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkJLmRhdGEoICJtb2JpbGUtcGFnZSIgKTsKCQl9CgoJfSk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCWlmICggcHJvcCApIHsKCQkJCXByb3AgPSAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApOwoJCQl9CgoJCQkvLyB1bmRlZmluZWQgaXMgcGVybWl0dGVkIGFzIGFuIGV4cGxpY2l0IGlucHV0IGZvciB0aGUgc2Vjb25kIHBhcmFtCgkJCS8vIGluIHRoaXMgY2FzZSBpdCByZXR1cm5zIHRoZSB2YWx1ZSBhbmQgZG9lcyBub3Qgc2V0IGl0IHRvIHVuZGVmaW5lZAoJCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPCAyIHx8IHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AgKTsKCQkJfSBlbHNlIHsKCQkJCXJlc3VsdCA9IHRoaXMuZGF0YSggcHJvcCwgdmFsdWUgKTsKCQkJfQoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmpxbURhdGEgPSBmdW5jdGlvbiggZWxlbSwgcHJvcCwgdmFsdWUgKSB7CgkJdmFyIHJlc3VsdDsKCQlpZiAoIHR5cGVvZiBwcm9wICE9PSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gJC5kYXRhKCBlbGVtLCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuZm4uanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBwcm9wICkgewoJCXJldHVybiB0aGlzLnJlbW92ZURhdGEoICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AgKSB7CgkJcmV0dXJuICQucmVtb3ZlRGF0YSggZWxlbSwgJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJaWYgKCBzZWxlY3Rvci5pbmRleE9mKCAiOmpxbURhdGEiICkgPiAtMSApIHsKCQkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCQl9CgoJCXJldHVybiBvbGRGaW5kLmNhbGwoIHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICk7Cgl9OwoKCSQuZXh0ZW5kKCAkLmZpbmQsIG9sZEZpbmQgKTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qIQogKiBqUXVlcnkgVUkgQ29yZSBjMGFiNzEwNTZiOTM2NjI3ZThhNzgyMWYwM2MwNDRhZWM2MjgwYTQwCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vY2F0ZWdvcnkvdWktY29yZS8KICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJcnVuaXF1ZUlkID0gL151aS1pZC1cZCskLzsKCi8vICQudWkgbWlnaHQgZXhpc3QgZnJvbSBjb21wb25lbnRzIHdpdGggbm8gZGVwZW5kZW5jaWVzLCBlLmcuLCAkLnVpLnBvc2l0aW9uCiQudWkgPSAkLnVpIHx8IHt9OwoKJC5leHRlbmQoICQudWksIHsKCXZlcnNpb246ICJjMGFiNzEwNTZiOTM2NjI3ZThhNzgyMWYwM2MwNDRhZWM2MjgwYTQwIiwKCglrZXlDb2RlOiB7CgkJQkFDS1NQQUNFOiA4LAoJCUNPTU1BOiAxODgsCgkJREVMRVRFOiA0NiwKCQlET1dOOiA0MCwKCQlFTkQ6IDM1LAoJCUVOVEVSOiAxMywKCQlFU0NBUEU6IDI3LAoJCUhPTUU6IDM2LAoJCUxFRlQ6IDM3LAoJCVBBR0VfRE9XTjogMzQsCgkJUEFHRV9VUDogMzMsCgkJUEVSSU9EOiAxOTAsCgkJUklHSFQ6IDM5LAoJCVNQQUNFOiAzMiwKCQlUQUI6IDksCgkJVVA6IDM4Cgl9Cn0pOwoKLy8gcGx1Z2lucwokLmZuLmV4dGVuZCh7Cglmb2N1czogKGZ1bmN0aW9uKCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggZGVsYXksIGZuICkgewoJCQlyZXR1cm4gdHlwZW9mIGRlbGF5ID09PSAibnVtYmVyIiA/CgkJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJdmFyIGVsZW0gPSB0aGlzOwoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCSQoIGVsZW0gKS5mb2N1cygpOwoJCQkJCQlpZiAoIGZuICkgewoJCQkJCQkJZm4uY2FsbCggZWxlbSApOwoJCQkJCQl9CgkJCQkJfSwgZGVsYXkgKTsKCQkJCX0pIDoKCQkJCW9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCX07Cgl9KSggJC5mbi5mb2N1cyApLAoKCXNjcm9sbFBhcmVudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNjcm9sbFBhcmVudDsKCQlpZiAoKCQudWkuaWUgJiYgKC8oc3RhdGljfHJlbGF0aXZlKS8pLnRlc3QodGhpcy5jc3MoInBvc2l0aW9uIikpKSB8fCAoL2Fic29sdXRlLykudGVzdCh0aGlzLmNzcygicG9zaXRpb24iKSkpIHsKCQkJc2Nyb2xsUGFyZW50ID0gdGhpcy5wYXJlbnRzKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICgvKHJlbGF0aXZlfGFic29sdXRlfGZpeGVkKS8pLnRlc3QoJC5jc3ModGhpcywicG9zaXRpb24iKSkgJiYgKC8oYXV0b3xzY3JvbGwpLykudGVzdCgkLmNzcyh0aGlzLCJvdmVyZmxvdyIpKyQuY3NzKHRoaXMsIm92ZXJmbG93LXkiKSskLmNzcyh0aGlzLCJvdmVyZmxvdy14IikpOwoJCQl9KS5lcSgwKTsKCQl9IGVsc2UgewoJCQlzY3JvbGxQYXJlbnQgPSB0aGlzLnBhcmVudHMoKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKC8oYXV0b3xzY3JvbGwpLykudGVzdCgkLmNzcyh0aGlzLCJvdmVyZmxvdyIpKyQuY3NzKHRoaXMsIm92ZXJmbG93LXkiKSskLmNzcyh0aGlzLCJvdmVyZmxvdy14IikpOwoJCQl9KS5lcSgwKTsKCQl9CgoJCXJldHVybiAoIC9maXhlZC8gKS50ZXN0KCB0aGlzLmNzcyggInBvc2l0aW9uIikgKSB8fCAhc2Nyb2xsUGFyZW50Lmxlbmd0aCA/ICQoIHRoaXNbIDAgXS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50ICkgOiBzY3JvbGxQYXJlbnQ7Cgl9LAoKCXVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoICF0aGlzLmlkICkgewoJCQkJdGhpcy5pZCA9ICJ1aS1pZC0iICsgKCsrdXVpZCk7CgkJCX0KCQl9KTsKCX0sCgoJcmVtb3ZlVW5pcXVlSWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggcnVuaXF1ZUlkLnRlc3QoIHRoaXMuaWQgKSApIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmVBdHRyKCAiaWQiICk7CgkJCX0KCQl9KTsKCX0KfSk7CgovLyBzZWxlY3RvcnMKZnVuY3Rpb24gZm9jdXNhYmxlKCBlbGVtZW50LCBpc1RhYkluZGV4Tm90TmFOICkgewoJdmFyIG1hcCwgbWFwTmFtZSwgaW1nLAoJCW5vZGVOYW1lID0gZWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJaWYgKCAiYXJlYSIgPT09IG5vZGVOYW1lICkgewoJCW1hcCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQltYXBOYW1lID0gbWFwLm5hbWU7CgkJaWYgKCAhZWxlbWVudC5ocmVmIHx8ICFtYXBOYW1lIHx8IG1hcC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAibWFwIiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpbWcgPSAkKCAiaW1nW3VzZW1hcD0jIiArIG1hcE5hbWUgKyAiXSIgKVswXTsKCQlyZXR1cm4gISFpbWcgJiYgdmlzaWJsZSggaW1nICk7Cgl9CglyZXR1cm4gKCAvaW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbnxvYmplY3QvLnRlc3QoIG5vZGVOYW1lICkgPwoJCSFlbGVtZW50LmRpc2FibGVkIDoKCQkiYSIgPT09IG5vZGVOYW1lID8KCQkJZWxlbWVudC5ocmVmIHx8IGlzVGFiSW5kZXhOb3ROYU4gOgoJCQlpc1RhYkluZGV4Tm90TmFOKSAmJgoJCS8vIHRoZSBlbGVtZW50IGFuZCBhbGwgb2YgaXRzIGFuY2VzdG9ycyBtdXN0IGJlIHZpc2libGUKCQl2aXNpYmxlKCBlbGVtZW50ICk7Cn0KCmZ1bmN0aW9uIHZpc2libGUoIGVsZW1lbnQgKSB7CglyZXR1cm4gJC5leHByLmZpbHRlcnMudmlzaWJsZSggZWxlbWVudCApICYmCgkJISQoIGVsZW1lbnQgKS5wYXJlbnRzKCkuYWRkQmFjaygpLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQuY3NzKCB0aGlzLCAidmlzaWJpbGl0eSIgKSA9PT0gImhpZGRlbiI7CgkJfSkubGVuZ3RoOwp9CgokLmV4dGVuZCggJC5leHByWyAiOiIgXSwgewoJZGF0YTogJC5leHByLmNyZWF0ZVBzZXVkbyA/CgkJJC5leHByLmNyZWF0ZVBzZXVkbyhmdW5jdGlvbiggZGF0YU5hbWUgKSB7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiAhISQuZGF0YSggZWxlbSwgZGF0YU5hbWUgKTsKCQkJfTsKCQl9KSA6CgkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQlmdW5jdGlvbiggZWxlbSwgaSwgbWF0Y2ggKSB7CgkJCXJldHVybiAhISQuZGF0YSggZWxlbSwgbWF0Y2hbIDMgXSApOwoJCX0sCgoJZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQlyZXR1cm4gZm9jdXNhYmxlKCBlbGVtZW50LCAhaXNOYU4oICQuYXR0ciggZWxlbWVudCwgInRhYmluZGV4IiApICkgKTsKCX0sCgoJdGFiYmFibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXZhciB0YWJJbmRleCA9ICQuYXR0ciggZWxlbWVudCwgInRhYmluZGV4IiApLAoJCQlpc1RhYkluZGV4TmFOID0gaXNOYU4oIHRhYkluZGV4ICk7CgkJcmV0dXJuICggaXNUYWJJbmRleE5hTiB8fCB0YWJJbmRleCA+PSAwICkgJiYgZm9jdXNhYmxlKCBlbGVtZW50LCAhaXNUYWJJbmRleE5hTiApOwoJfQp9KTsKCi8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CmlmICggISQoICI8YT4iICkub3V0ZXJXaWR0aCggMSApLmpxdWVyeSApIHsKCSQuZWFjaCggWyAiV2lkdGgiLCAiSGVpZ2h0IiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCQl2YXIgc2lkZSA9IG5hbWUgPT09ICJXaWR0aCIgPyBbICJMZWZ0IiwgIlJpZ2h0IiBdIDogWyAiVG9wIiwgIkJvdHRvbSIgXSwKCQkJdHlwZSA9IG5hbWUudG9Mb3dlckNhc2UoKSwKCQkJb3JpZyA9IHsKCQkJCWlubmVyV2lkdGg6ICQuZm4uaW5uZXJXaWR0aCwKCQkJCWlubmVySGVpZ2h0OiAkLmZuLmlubmVySGVpZ2h0LAoJCQkJb3V0ZXJXaWR0aDogJC5mbi5vdXRlcldpZHRoLAoJCQkJb3V0ZXJIZWlnaHQ6ICQuZm4ub3V0ZXJIZWlnaHQKCQkJfTsKCgkJZnVuY3Rpb24gcmVkdWNlKCBlbGVtLCBzaXplLCBib3JkZXIsIG1hcmdpbiApIHsKCQkJJC5lYWNoKCBzaWRlLCBmdW5jdGlvbigpIHsKCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJwYWRkaW5nIiArIHRoaXMgKSApIHx8IDA7CgkJCQlpZiAoIGJvcmRlciApIHsKCQkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAiYm9yZGVyIiArIHRoaXMgKyAiV2lkdGgiICkgKSB8fCAwOwoJCQkJfQoJCQkJaWYgKCBtYXJnaW4gKSB7CgkJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgIm1hcmdpbiIgKyB0aGlzICkgKSB8fCAwOwoJCQkJfQoJCQl9KTsKCQkJcmV0dXJuIHNpemU7CgkJfQoKCQkkLmZuWyAiaW5uZXIiICsgbmFtZSBdID0gZnVuY3Rpb24oIHNpemUgKSB7CgkJCWlmICggc2l6ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIG9yaWdbICJpbm5lciIgKyBuYW1lIF0uY2FsbCggdGhpcyApOwoJCQl9CgoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmNzcyggdHlwZSwgcmVkdWNlKCB0aGlzLCBzaXplICkgKyAicHgiICk7CgkJCX0pOwoJCX07CgoJCSQuZm5bICJvdXRlciIgKyBuYW1lXSA9IGZ1bmN0aW9uKCBzaXplLCBtYXJnaW4gKSB7CgkJCWlmICggdHlwZW9mIHNpemUgIT09ICJudW1iZXIiICkgewoJCQkJcmV0dXJuIG9yaWdbICJvdXRlciIgKyBuYW1lIF0uY2FsbCggdGhpcywgc2l6ZSApOwoJCQl9CgoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcykuY3NzKCB0eXBlLCByZWR1Y2UoIHRoaXMsIHNpemUsIHRydWUsIG1hcmdpbiApICsgInB4IiApOwoJCQl9KTsKCQl9OwoJfSk7Cn0KCi8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CmlmICggISQuZm4uYWRkQmFjayApIHsKCSQuZm4uYWRkQmFjayA9IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5hZGQoIHNlbGVjdG9yID09IG51bGwgPwoJCQl0aGlzLnByZXZPYmplY3QgOiB0aGlzLnByZXZPYmplY3QuZmlsdGVyKCBzZWxlY3RvciApCgkJKTsKCX07Cn0KCi8vIHN1cHBvcnQ6IGpRdWVyeSAxLjYuMSwgMS42LjIgKGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMpCmlmICggJCggIjxhPiIgKS5kYXRhKCAiYS1iIiwgImEiICkucmVtb3ZlRGF0YSggImEtYiIgKS5kYXRhKCAiYS1iIiApICkgewoJJC5mbi5yZW1vdmVEYXRhID0gKGZ1bmN0aW9uKCByZW1vdmVEYXRhICkgewoJCXJldHVybiBmdW5jdGlvbigga2V5ICkgewoJCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCQlyZXR1cm4gcmVtb3ZlRGF0YS5jYWxsKCB0aGlzLCAkLmNhbWVsQ2FzZSgga2V5ICkgKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiByZW1vdmVEYXRhLmNhbGwoIHRoaXMgKTsKCQkJfQoJCX07Cgl9KSggJC5mbi5yZW1vdmVEYXRhICk7Cn0KCgoKCgovLyBkZXByZWNhdGVkCiQudWkuaWUgPSAhIS9tc2llIFtcdy5dKy8uZXhlYyggbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpICk7CgokLnN1cHBvcnQuc2VsZWN0c3RhcnQgPSAib25zZWxlY3RzdGFydCIgaW4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKJC5mbi5leHRlbmQoewoJZGlzYWJsZVNlbGVjdGlvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuYmluZCggKCAkLnN1cHBvcnQuc2VsZWN0c3RhcnQgPyAic2VsZWN0c3RhcnQiIDogIm1vdXNlZG93biIgKSArCgkJCSIudWktZGlzYWJsZVNlbGVjdGlvbiIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0pOwoJfSwKCgllbmFibGVTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnVuYmluZCggIi51aS1kaXNhYmxlU2VsZWN0aW9uIiApOwoJfSwKCgl6SW5kZXg6IGZ1bmN0aW9uKCB6SW5kZXggKSB7CgkJaWYgKCB6SW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRoaXMuY3NzKCAiekluZGV4IiwgekluZGV4ICk7CgkJfQoKCQlpZiAoIHRoaXMubGVuZ3RoICkgewoJCQl2YXIgZWxlbSA9ICQoIHRoaXNbIDAgXSApLCBwb3NpdGlvbiwgdmFsdWU7CgkJCXdoaWxlICggZWxlbS5sZW5ndGggJiYgZWxlbVsgMCBdICE9PSBkb2N1bWVudCApIHsKCQkJCS8vIElnbm9yZSB6LWluZGV4IGlmIHBvc2l0aW9uIGlzIHNldCB0byBhIHZhbHVlIHdoZXJlIHotaW5kZXggaXMgaWdub3JlZCBieSB0aGUgYnJvd3NlcgoJCQkJLy8gVGhpcyBtYWtlcyBiZWhhdmlvciBvZiB0aGlzIGZ1bmN0aW9uIGNvbnNpc3RlbnQgYWNyb3NzIGJyb3dzZXJzCgkJCQkvLyBXZWJLaXQgYWx3YXlzIHJldHVybnMgYXV0byBpZiB0aGUgZWxlbWVudCBpcyBwb3NpdGlvbmVkCgkJCQlwb3NpdGlvbiA9IGVsZW0uY3NzKCAicG9zaXRpb24iICk7CgkJCQlpZiAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAicmVsYXRpdmUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgewoJCQkJCS8vIElFIHJldHVybnMgMCB3aGVuIHpJbmRleCBpcyBub3Qgc3BlY2lmaWVkCgkJCQkJLy8gb3RoZXIgYnJvd3NlcnMgcmV0dXJuIGEgc3RyaW5nCgkJCQkJLy8gd2UgaWdub3JlIHRoZSBjYXNlIG9mIG5lc3RlZCBlbGVtZW50cyB3aXRoIGFuIGV4cGxpY2l0IHZhbHVlIG9mIDAKCQkJCQkvLyA8ZGl2IHN0eWxlPSJ6LWluZGV4OiAtMTA7Ij48ZGl2IHN0eWxlPSJ6LWluZGV4OiAwOyI+PC9kaXY+PC9kaXY+CgkJCQkJdmFsdWUgPSBwYXJzZUludCggZWxlbS5jc3MoICJ6SW5kZXgiICksIDEwICk7CgkJCQkJaWYgKCAhaXNOYU4oIHZhbHVlICkgJiYgdmFsdWUgIT09IDAgKSB7CgkJCQkJCXJldHVybiB2YWx1ZTsKCQkJCQl9CgkJCQl9CgkJCQllbGVtID0gZWxlbS5wYXJlbnQoKTsKCQkJfQoJCX0KCgkJcmV0dXJuIDA7Cgl9Cn0pOwoKLy8gJC51aS5wbHVnaW4gaXMgZGVwcmVjYXRlZC4gVXNlICQud2lkZ2V0KCkgZXh0ZW5zaW9ucyBpbnN0ZWFkLgokLnVpLnBsdWdpbiA9IHsKCWFkZDogZnVuY3Rpb24oIG1vZHVsZSwgb3B0aW9uLCBzZXQgKSB7CgkJdmFyIGksCgkJCXByb3RvID0gJC51aVsgbW9kdWxlIF0ucHJvdG90eXBlOwoJCWZvciAoIGkgaW4gc2V0ICkgewoJCQlwcm90by5wbHVnaW5zWyBpIF0gPSBwcm90by5wbHVnaW5zWyBpIF0gfHwgW107CgkJCXByb3RvLnBsdWdpbnNbIGkgXS5wdXNoKCBbIG9wdGlvbiwgc2V0WyBpIF0gXSApOwoJCX0KCX0sCgljYWxsOiBmdW5jdGlvbiggaW5zdGFuY2UsIG5hbWUsIGFyZ3MsIGFsbG93RGlzY29ubmVjdGVkICkgewoJCXZhciBpLAoJCQlzZXQgPSBpbnN0YW5jZS5wbHVnaW5zWyBuYW1lIF07CgoJCWlmICggIXNldCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCAhYWxsb3dEaXNjb25uZWN0ZWQgJiYgKCAhaW5zdGFuY2UuZWxlbWVudFsgMCBdLnBhcmVudE5vZGUgfHwgaW5zdGFuY2UuZWxlbWVudFsgMCBdLnBhcmVudE5vZGUubm9kZVR5cGUgPT09IDExICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCWZvciAoIGkgPSAwOyBpIDwgc2V0Lmxlbmd0aDsgaSsrICkgewoJCQlpZiAoIGluc3RhbmNlLm9wdGlvbnNbIHNldFsgaSBdWyAwIF0gXSApIHsKCQkJCXNldFsgaSBdWyAxIF0uYXBwbHkoIGluc3RhbmNlLmVsZW1lbnQsIGFyZ3MgKTsKCQkJfQoJCX0KCX0KfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJLy8gU3VidHJhY3QgdGhlIGhlaWdodCBvZiBleHRlcm5hbCB0b29sYmFycyBmcm9tIHRoZSBwYWdlIGhlaWdodCwgaWYgdGhlIHBhZ2UgZG9lcyBub3QgaGF2ZQoJLy8gaW50ZXJuYWwgdG9vbGJhcnMgb2YgdGhlIHNhbWUgdHlwZQoJdmFyIGNvbXBlbnNhdGVUb29sYmFycyA9IGZ1bmN0aW9uKCBwYWdlLCBkZXNpcmVkSGVpZ2h0ICkgewoJCXZhciBwYWdlUGFyZW50ID0gcGFnZS5wYXJlbnQoKSwKCQkJdG9vbGJhcnNBZmZlY3RpbmdIZWlnaHQgPSBbXSwKCQkJZXh0ZXJuYWxIZWFkZXJzID0gcGFnZVBhcmVudC5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLAoJCQlpbnRlcm5hbEhlYWRlcnMgPSBwYWdlLmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICksCgkJCWV4dGVybmFsRm9vdGVycyA9IHBhZ2VQYXJlbnQuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKSwKCQkJaW50ZXJuYWxGb290ZXJzID0gcGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApOwoKCQkvLyBJZiB3ZSBoYXZlIG5vIGludGVybmFsIGhlYWRlcnMsIGJ1dCB3ZSBkbyBoYXZlIGV4dGVybmFsIGhlYWRlcnMsIHRoZW4gdGhlaXIgaGVpZ2h0CgkJLy8gcmVkdWNlcyB0aGUgcGFnZSBoZWlnaHQKCQlpZiAoIGludGVybmFsSGVhZGVycy5sZW5ndGggPT09IDAgJiYgZXh0ZXJuYWxIZWFkZXJzLmxlbmd0aCA+IDAgKSB7CgkJCXRvb2xiYXJzQWZmZWN0aW5nSGVpZ2h0ID0gdG9vbGJhcnNBZmZlY3RpbmdIZWlnaHQuY29uY2F0KCBleHRlcm5hbEhlYWRlcnMudG9BcnJheSgpICk7CgkJfQoKCQkvLyBJZiB3ZSBoYXZlIG5vIGludGVybmFsIGZvb3RlcnMsIGJ1dCB3ZSBkbyBoYXZlIGV4dGVybmFsIGZvb3RlcnMsIHRoZW4gdGhlaXIgaGVpZ2h0CgkJLy8gcmVkdWNlcyB0aGUgcGFnZSBoZWlnaHQKCQlpZiAoIGludGVybmFsRm9vdGVycy5sZW5ndGggPT09IDAgJiYgZXh0ZXJuYWxGb290ZXJzLmxlbmd0aCA+IDAgKSB7CgkJCXRvb2xiYXJzQWZmZWN0aW5nSGVpZ2h0ID0gdG9vbGJhcnNBZmZlY3RpbmdIZWlnaHQuY29uY2F0KCBleHRlcm5hbEZvb3RlcnMudG9BcnJheSgpICk7CgkJfQoKCQkkLmVhY2goIHRvb2xiYXJzQWZmZWN0aW5nSGVpZ2h0LCBmdW5jdGlvbiggaW5kZXgsIHZhbHVlICkgewoJCQlkZXNpcmVkSGVpZ2h0IC09ICQoIHZhbHVlICkub3V0ZXJIZWlnaHQoKTsKCQl9KTsKCgkJLy8gSGVpZ2h0IG11c3QgYmUgYXQgbGVhc3QgemVybwoJCXJldHVybiBNYXRoLm1heCggMCwgZGVzaXJlZEhlaWdodCApOwoJfTsKCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCQkvLyBkZWZpbmUgdGhlIHdpbmRvdyBhbmQgdGhlIGRvY3VtZW50IG9iamVjdHMKCQl3aW5kb3c6ICQoIHdpbmRvdyApLAoJCWRvY3VtZW50OiAkKCBkb2N1bWVudCApLAoKCQkvLyBUT0RPOiBSZW1vdmUgYW5kIHVzZSAkLnVpLmtleUNvZGUgZGlyZWN0bHkKCQlrZXlDb2RlOiAkLnVpLmtleUNvZGUsCgoJCS8vIFBsYWNlIHRvIHN0b3JlIHZhcmlvdXMgd2lkZ2V0IGV4dGVuc2lvbnMKCQliZWhhdmlvcnM6IHt9LAoKCQkvLyBTY3JvbGwgcGFnZSB2ZXJ0aWNhbGx5OiBzY3JvbGwgdG8gMCB0byBoaWRlIGlPUyBhZGRyZXNzIGJhciwgb3IgcGFzcyBhIFkgdmFsdWUKCQlzaWxlbnRTY3JvbGw6IGZ1bmN0aW9uKCB5cG9zICkgewoJCQlpZiAoICQudHlwZSggeXBvcyApICE9PSAibnVtYmVyIiApIHsKCQkJCXlwb3MgPSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCQkJfQoKCQkJLy8gcHJldmVudCBzY3JvbGxzdGFydCBhbmQgc2Nyb2xsc3RvcCBldmVudHMKCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHlwb3MgKTsKCQkJCSQubW9iaWxlLmRvY3VtZW50LnRyaWdnZXIoICJzaWxlbnRzY3JvbGwiLCB7IHg6IDAsIHk6IHlwb3MgfSk7CgkJCX0sIDIwICk7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQl9LCAxNTAgKTsKCQl9LAoKCQlnZXRDbG9zZXN0QmFzZVVybDogZnVuY3Rpb24oIGVsZSApCXsKCQkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYWdlIGFuZCBleHRyYWN0IG91dCBpdHMgdXJsLgoJCQl2YXIgdXJsID0gJCggZWxlICkuY2xvc2VzdCggIi51aS1wYWdlIiApLmpxbURhdGEoICJ1cmwiICksCgkJCQliYXNlID0gJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCgkJCWlmICggISQubW9iaWxlLmR5bmFtaWNCYXNlRW5hYmxlZCB8fCAhdXJsIHx8ICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggdXJsICkgKSB7CgkJCQl1cmwgPSBiYXNlOwoJCQl9CgoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgYmFzZSApOwoJCX0sCgkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzOiBmdW5jdGlvbiggZm9yY2VSZW1vdmFsICkgewoJCQlpZiAoICEhJC5tb2JpbGUuYWN0aXZlQ2xpY2tlZExpbmsgJiYKCQkJCSggISQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rLmNsb3Nlc3QoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLmxlbmd0aCB8fAoJCQkJCWZvcmNlUmVtb3ZhbCApICkgewoKCQkJCSQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJCSQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbDsKCQl9LAoKCQkvLyBERVBSRUNBVEVEIGluIDEuNAoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcyBvbiBpdC4gTm90ZSB0aGF0CgkJLy8gd2UgYXJlIG5vdCB1c2luZyAkLmZuLmNsb3Nlc3QoKSBvbiBwdXJwb3NlIGhlcmUgYmVjYXVzZSB0aGlzCgkJLy8gbWV0aG9kIGdldHMgY2FsbGVkIHF1aXRlIGEgYml0IGFuZCB3ZSBuZWVkIGl0IHRvIGJlIGFzIGZhc3QKCQkvLyBhcyBwb3NzaWJsZS4KCQlnZXRJbmhlcml0ZWRUaGVtZTogZnVuY3Rpb24oIGVsLCBkZWZhdWx0VGhlbWUgKSB7CgkJCXZhciBlID0gZWxbIDAgXSwKCQkJCWx0ciA9ICIiLAoJCQkJcmUgPSAvdWktKGJhcnxib2R5fG92ZXJsYXkpLShbYS16XSlcYi8sCgkJCQljLCBtOwoJCQl3aGlsZSAoIGUgKSB7CgkJCQljID0gZS5jbGFzc05hbWUgfHwgIiI7CgkJCQlpZiAoIGMgJiYgKCBtID0gcmUuZXhlYyggYyApICkgJiYgKCBsdHIgPSBtWyAyIF0gKSApIHsKCQkJCQkvLyBXZSBmb3VuZCBhIHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3MKCQkJCQkvLyBvbiBpdCBzbyBiYWlsIGZyb20gdGhpcyBsb29wLgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCX0KCQkJLy8gUmV0dXJuIHRoZSB0aGVtZSBsZXR0ZXIgd2UgZm91bmQsIGlmIG5vbmUsIHJldHVybiB0aGUKCQkJLy8gc3BlY2lmaWVkIGRlZmF1bHQuCgkJCXJldHVybiBsdHIgfHwgZGVmYXVsdFRoZW1lIHx8ICJhIjsKCQl9LAoKCQllbmhhbmNlYWJsZTogZnVuY3Rpb24oIGVsZW1lbnRzICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggZWxlbWVudHMsICJlbmhhbmNlIiApOwoJCX0sCgoJCWhpamFja2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50cyApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoIGVsZW1lbnRzLCAiYWpheCIgKTsKCQl9LAoKCQloYXZlUGFyZW50czogZnVuY3Rpb24oIGVsZW1lbnRzLCBhdHRyICkgewoJCQlpZiAoICEkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCApIHsKCQkJCXJldHVybiBlbGVtZW50czsKCQkJfQoKCQkJdmFyIGNvdW50ID0gZWxlbWVudHMubGVuZ3RoLAoJCQkJJG5ld1NldCA9ICQoKSwKCQkJCWUsICRlbGVtZW50LCBleGNsdWRlZCwKCQkJCWksIGM7CgoJCQlmb3IgKCBpID0gMDsgaSA8IGNvdW50OyBpKysgKSB7CgkJCQkkZWxlbWVudCA9IGVsZW1lbnRzLmVxKCBpICk7CgkJCQlleGNsdWRlZCA9IGZhbHNlOwoJCQkJZSA9IGVsZW1lbnRzWyBpIF07CgoJCQkJd2hpbGUgKCBlICkgewoJCQkJCWMgPSBlLmdldEF0dHJpYnV0ZSA/IGUuZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBhdHRyICkgOiAiIjsKCgkJCQkJaWYgKCBjID09PSAiZmFsc2UiICkgewoJCQkJCQlleGNsdWRlZCA9IHRydWU7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCgkJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJCX0KCgkJCQlpZiAoICFleGNsdWRlZCApIHsKCQkJCQkkbmV3U2V0ID0gJG5ld1NldC5hZGQoICRlbGVtZW50ICk7CgkJCQl9CgkJCX0KCgkJCXJldHVybiAkbmV3U2V0OwoJCX0sCgoJCWdldFNjcmVlbkhlaWdodDogZnVuY3Rpb24oKSB7CgkJCS8vIE5hdGl2ZSBpbm5lckhlaWdodCByZXR1cm5zIG1vcmUgYWNjdXJhdGUgdmFsdWUgZm9yIHRoaXMgYWNyb3NzIHBsYXRmb3JtcywKCQkJLy8galF1ZXJ5IHZlcnNpb24gaXMgaGVyZSBhcyBhIG5vcm1hbGl6ZWQgZmFsbGJhY2sgZm9yIHBsYXRmb3JtcyBsaWtlIFN5bWJpYW4KCQkJcmV0dXJuIHdpbmRvdy5pbm5lckhlaWdodCB8fCAkLm1vYmlsZS53aW5kb3cuaGVpZ2h0KCk7CgkJfSwKCgkJLy9zaW1wbHkgc2V0IHRoZSBhY3RpdmUgcGFnZSdzIG1pbmltdW0gaGVpZ2h0IHRvIHNjcmVlbiBoZWlnaHQsIGRlcGVuZGluZyBvbiBvcmllbnRhdGlvbgoJCXJlc2V0QWN0aXZlUGFnZUhlaWdodDogZnVuY3Rpb24oIGhlaWdodCApIHsKCQkJdmFyIHBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJCXBhZ2VIZWlnaHQgPSBwYWdlLmhlaWdodCgpLAoJCQkJcGFnZU91dGVySGVpZ2h0ID0gcGFnZS5vdXRlckhlaWdodCggdHJ1ZSApOwoKCQkJaGVpZ2h0ID0gY29tcGVuc2F0ZVRvb2xiYXJzKCBwYWdlLAoJCQkJKCB0eXBlb2YgaGVpZ2h0ID09PSAibnVtYmVyIiApID8gaGVpZ2h0IDogJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCkgKTsKCgkJCS8vIFJlbW92ZSBhbnkgcHJldmlvdXMgbWluLWhlaWdodCBzZXR0aW5nCgkJCXBhZ2UuY3NzKCAibWluLWhlaWdodCIsICIiICk7CgoJCQkvLyBTZXQgdGhlIG1pbmltdW0gaGVpZ2h0IG9ubHkgaWYgdGhlIGhlaWdodCBhcyBkZXRlcm1pbmVkIGJ5IENTUyBpcyBpbnN1ZmZpY2llbnQKCQkJaWYgKCBwYWdlLmhlaWdodCgpIDwgaGVpZ2h0ICkgewoJCQkJcGFnZS5jc3MoICJtaW4taGVpZ2h0IiwgaGVpZ2h0IC0gKCBwYWdlT3V0ZXJIZWlnaHQgLSBwYWdlSGVpZ2h0ICkgKTsKCQkJfQoJCX0sCgoJCWxvYWRpbmc6IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCBjYWxsIHRvIHRoaXMgZnVuY3Rpb24sIGluc3RhbnRpYXRlIGEgbG9hZGVyIHdpZGdldAoJCQl2YXIgbG9hZGVyID0gdGhpcy5sb2FkaW5nLl93aWRnZXQgfHwgJCggJC5tb2JpbGUubG9hZGVyLnByb3RvdHlwZS5kZWZhdWx0SHRtbCApLmxvYWRlcigpLAoKCQkJCS8vIENhbGwgdGhlIGFwcHJvcHJpYXRlIG1ldGhvZCBvbiB0aGUgbG9hZGVyCgkJCQlyZXR1cm5WYWx1ZSA9IGxvYWRlci5sb2FkZXIuYXBwbHkoIGxvYWRlciwgYXJndW1lbnRzICk7CgoJCQkvLyBNYWtlIHN1cmUgdGhlIGxvYWRlciBpcyByZXRhaW5lZCBmb3IgZnV0dXJlIGNhbGxzIHRvIHRoaXMgZnVuY3Rpb24uCgkJCXRoaXMubG9hZGluZy5fd2lkZ2V0ID0gbG9hZGVyOwoKCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCX0KCX0pOwoKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtLCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKSwKCQkJZGVwZW5kZW50cyA9ICRlbGVtLmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKTsKCgkJJGVsZW0uanFtRGF0YSggImRlcGVuZGVudHMiLCAkKCBkZXBlbmRlbnRzICkuYWRkKCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJLy8gcGx1Z2lucwoJJC5mbi5leHRlbmQoewoJCXJlbW92ZVdpdGhEZXBlbmRlbnRzOiBmdW5jdGlvbigpIHsKCQkJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyggdGhpcyApOwoJCX0sCgoJCS8vIEVuaGFuY2UgY2hpbGQgZWxlbWVudHMKCQllbmhhbmNlV2l0aGluOiBmdW5jdGlvbigpIHsKCQkJdmFyIGluZGV4LAoJCQkJd2lkZ2V0RWxlbWVudHMgPSB7fSwKCQkJCWtlZXBOYXRpdmUgPSAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSwKCQkJCXRoYXQgPSB0aGlzOwoKCQkJLy8gQWRkIG5vIGpzIGNsYXNzIHRvIGVsZW1lbnRzCgkJCWlmICggJC5tb2JpbGUubm9qcyApIHsKCQkJCSQubW9iaWxlLm5vanMoIHRoaXMgKTsKCQkJfQoKCQkJLy8gQmluZCBsaW5rcyBmb3IgYWpheCBuYXYKCQkJaWYgKCAkLm1vYmlsZS5saW5rcyApIHsKCQkJCSQubW9iaWxlLmxpbmtzKCB0aGlzICk7CgkJCX0KCgkJCS8vIERlZ3JhZGUgaW5wdXRzIGZvciBzdHlsZWluZwoJCQlpZiAoICQubW9iaWxlLmRlZ3JhZGVJbnB1dHNXaXRoaW4gKSB7CgkJCQkkLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluKCB0aGlzICk7CgkJCX0KCgkJCS8vIFJ1biBidXR0b25tYXJrdXAKCQkJaWYgKCAkLmZuLmJ1dHRvbk1hcmt1cCApIHsKCQkJCXRoaXMuZmluZCggJC5mbi5idXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkubm90KCBrZWVwTmF0aXZlICkKCQkJCS5qcW1FbmhhbmNlYWJsZSgpLmJ1dHRvbk1hcmt1cCgpOwoJCQl9CgoJCQkvLyBBZGQgY2xhc3NlcyBmb3IgZmllbGRDb250YWluCgkJCWlmICggJC5mbi5maWVsZGNvbnRhaW4gKSB7CgkJCQl0aGlzLmZpbmQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIgKS5ub3QoIGtlZXBOYXRpdmUgKQoJCQkJLmpxbUVuaGFuY2VhYmxlKCkuZmllbGRjb250YWluKCk7CgkJCX0KCgkJCS8vIEVuaGFuY2Ugd2lkZ2V0cwoJCQkkLmVhY2goICQubW9iaWxlLndpZGdldHMsIGZ1bmN0aW9uKCBuYW1lLCBjb25zdHJ1Y3RvciApIHsKCgkJCQkvLyBJZiBpbml0U2VsZWN0b3Igbm90IGZhbHNlIGZpbmQgZWxlbWVudHMKCQkJCWlmICggY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yICkgewoKCQkJCQkvLyBGaWx0ZXIgZWxlbWVudHMgdGhhdCBzaG91bGQgbm90IGJlIGVuaGFuY2VkIGJhc2VkIG9uIHBhcmVudHMKCQkJCQl2YXIgZWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhhdC5maW5kKCBjb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgKSApOwoKCQkJCQkvLyBJZiBhbnkgbWF0Y2hpbmcgZWxlbWVudHMgcmVtYWluIGZpbHRlciBvbmVzIHdpdGgga2VlcE5hdGl2ZVNlbGVjdG9yCgkJCQkJaWYgKCBlbGVtZW50cy5sZW5ndGggPiAwICkgewoKCQkJCQkJLy8gJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yIGlzIGRlcHJlY2F0ZWQgdGhpcyBpcyBqdXN0IGZvciBiYWNrY29tcGF0CgkJCQkJCS8vIFN3aXRjaCB0byAkLm1vYmlsZS5rZWVwTmF0aXZlIGluIDEuNSB3aGljaCBpcyBqdXN0IGEgdmFsdWUgbm90IGEgZnVuY3Rpb24KCQkJCQkJZWxlbWVudHMgPSBlbGVtZW50cy5ub3QoIGtlZXBOYXRpdmUgKTsKCQkJCQl9CgoJCQkJCS8vIEVuaGFuY2Ugd2hhdGV2ZXIgaXMgbGVmdAoJCQkJCWlmICggZWxlbWVudHMubGVuZ3RoID4gMCApIHsKCQkJCQkJd2lkZ2V0RWxlbWVudHNbIGNvbnN0cnVjdG9yLnByb3RvdHlwZS53aWRnZXROYW1lIF0gPSBlbGVtZW50czsKCQkJCQl9CgkJCQl9CgkJCX0pOwoKCQkJZm9yICggaW5kZXggaW4gd2lkZ2V0RWxlbWVudHMgKSB7CgkJCQl3aWRnZXRFbGVtZW50c1sgaW5kZXggXVsgaW5kZXggXSgpOwoJCQl9CgoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlhZGREZXBlbmRlbnRzOiBmdW5jdGlvbiggbmV3RGVwZW5kZW50cyApIHsKCQkJJC5hZGREZXBlbmRlbnRzKCB0aGlzLCBuZXdEZXBlbmRlbnRzICk7CgkJfSwKCgkJLy8gbm90ZSB0aGF0IHRoaXMgaGVscGVyIGRvZXNuJ3QgYXR0ZW1wdCB0byBoYW5kbGUgdGhlIGNhbGxiYWNrCgkJLy8gb3Igc2V0dGluZyBvZiBhbiBodG1sIGVsZW1lbnQncyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkJLy8gdG8gcmV0dXJuIHRoZSBodG1sIGVuY29kZWQgdmVyc2lvbiBvZiB0aGUgdGV4dCBpbiBhbGwgY2FzZXMuICh0aHVzIHRoZSBuYW1lKQoJCWdldEVuY29kZWRUZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQoICI8YT4iICkudGV4dCggdGhpcy50ZXh0KCkgKS5odG1sKCk7CgkJfSwKCgkJLy8gZmx1ZW50IGhlbHBlciBmdW5jdGlvbiBmb3IgdGhlIG1vYmlsZSBuYW1lc3BhY2VkIGVxdWl2YWxlbnQKCQlqcW1FbmhhbmNlYWJsZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhpcyApOwoJCX0sCgoJCWpxbUhpamFja2FibGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuaGlqYWNrYWJsZSggdGhpcyApOwoJCX0KCX0pOwoKCSQucmVtb3ZlV2l0aERlcGVuZGVudHMgPSBmdW5jdGlvbiggbmF0aXZlRWxlbWVudCApIHsKCQl2YXIgZWxlbWVudCA9ICQoIG5hdGl2ZUVsZW1lbnQgKTsKCgkJKCBlbGVtZW50LmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKSApLnJlbW92ZSgpOwoJCWVsZW1lbnQucmVtb3ZlKCk7Cgl9OwoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5hdGl2ZUVsZW1lbnQsIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCBuYXRpdmVFbGVtZW50ICksCgkJCWRlcGVuZGVudHMgPSBlbGVtZW50LmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKTsKCgkJZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIsICQoIGRlcGVuZGVudHMgKS5hZGQoIG5ld0RlcGVuZGVudHMgKSApOwoJfTsKCgkkLmZpbmQubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBzZXQgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgc2V0ICk7Cgl9OwoKCSQuZmluZC5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggbm9kZSwgZXhwciApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBbIG5vZGUgXSApLmxlbmd0aCA+IDA7Cgl9OwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IGMwYWI3MTA1NmI5MzY2MjdlOGE3ODIxZjAzYzA0NGFlYzYyODBhNDAKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9qUXVlcnkud2lkZ2V0LwogKi8KKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdXVpZCA9IDAsCglzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKCV9jbGVhbkRhdGEgPSAkLmNsZWFuRGF0YTsKJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7Cglmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQl0cnkgewoJCQkkKCBlbGVtICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvODIzNQoJCX0gY2F0Y2goIGUgKSB7fQoJfQoJX2NsZWFuRGF0YSggZWxlbXMgKTsKfTsKCiQud2lkZ2V0ID0gZnVuY3Rpb24oIG5hbWUsIGJhc2UsIHByb3RvdHlwZSApIHsKCXZhciBmdWxsTmFtZSwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgY29uc3RydWN0b3IsIGJhc2VQcm90b3R5cGUsCgkJLy8gcHJveGllZFByb3RvdHlwZSBhbGxvd3MgdGhlIHByb3ZpZGVkIHByb3RvdHlwZSB0byByZW1haW4gdW5tb2RpZmllZAoJCS8vIHNvIHRoYXQgaXQgY2FuIGJlIHVzZWQgYXMgYSBtaXhpbiBmb3IgbXVsdGlwbGUgd2lkZ2V0cyAoIzg4NzYpCgkJcHJveGllZFByb3RvdHlwZSA9IHt9LAoJCW5hbWVzcGFjZSA9IG5hbWUuc3BsaXQoICIuIiApWyAwIF07CgoJbmFtZSA9IG5hbWUuc3BsaXQoICIuIiApWyAxIF07CglmdWxsTmFtZSA9IG5hbWVzcGFjZSArICItIiArIG5hbWU7CgoJaWYgKCAhcHJvdG90eXBlICkgewoJCXByb3RvdHlwZSA9IGJhc2U7CgkJYmFzZSA9ICQuV2lkZ2V0OwoJfQoKCS8vIGNyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZS50b0xvd2VyQ2FzZSgpIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CglleGlzdGluZ0NvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXTsKCWNvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCAibmV3IiBrZXl3b3JkCgkJaWYgKCAhdGhpcy5fY3JlYXRlV2lkZ2V0ICkgewoJCQlyZXR1cm4gbmV3IGNvbnN0cnVjdG9yKCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCQkvLyBtdXN0IHVzZSAibmV3IiBrZXl3b3JkICh0aGUgY29kZSBhYm92ZSBhbHdheXMgcGFzc2VzIGFyZ3MpCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9Cgl9OwoJLy8gZXh0ZW5kIHdpdGggdGhlIGV4aXN0aW5nIGNvbnN0cnVjdG9yIHRvIGNhcnJ5IG92ZXIgYW55IHN0YXRpYyBwcm9wZXJ0aWVzCgkkLmV4dGVuZCggY29uc3RydWN0b3IsIGV4aXN0aW5nQ29uc3RydWN0b3IsIHsKCQl2ZXJzaW9uOiBwcm90b3R5cGUudmVyc2lvbiwKCQkvLyBjb3B5IHRoZSBvYmplY3QgdXNlZCB0byBjcmVhdGUgdGhlIHByb3RvdHlwZSBpbiBjYXNlIHdlIG5lZWQgdG8KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyCgkJX3Byb3RvOiAkLmV4dGVuZCgge30sIHByb3RvdHlwZSApLAoJCS8vIHRyYWNrIHdpZGdldHMgdGhhdCBpbmhlcml0IGZyb20gdGhpcyB3aWRnZXQgaW4gY2FzZSB0aGlzIHdpZGdldCBpcwoJCS8vIHJlZGVmaW5lZCBhZnRlciBhIHdpZGdldCBpbmhlcml0cyBmcm9tIGl0CgkJX2NoaWxkQ29uc3RydWN0b3JzOiBbXQoJfSk7CgoJYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkLmVhY2goIHByb3RvdHlwZSwgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCWlmICggISQuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcHJveGllZFByb3RvdHlwZVsgcHJvcCBdID0gdmFsdWU7CgkJCXJldHVybjsKCQl9CgkJcHJveGllZFByb3RvdHlwZVsgcHJvcCBdID0gKGZ1bmN0aW9uKCkgewoJCQl2YXIgX3N1cGVyID0gZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJfSwKCQkJCV9zdXBlckFwcGx5ID0gZnVuY3Rpb24oIGFyZ3MgKSB7CgkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3MgKTsKCQkJCX07CgkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCXZhciBfX3N1cGVyID0gdGhpcy5fc3VwZXIsCgkJCQkJX19zdXBlckFwcGx5ID0gdGhpcy5fc3VwZXJBcHBseSwKCQkJCQlyZXR1cm5WYWx1ZTsKCgkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsKCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfc3VwZXJBcHBseTsKCgkJCQlyZXR1cm5WYWx1ZSA9IHZhbHVlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJCQl0aGlzLl9zdXBlciA9IF9fc3VwZXI7CgkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX19zdXBlckFwcGx5OwoKCQkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQkJfTsKCQl9KSgpOwoJfSk7Cgljb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAkLndpZGdldC5leHRlbmQoIGJhc2VQcm90b3R5cGUsIHsKCQkvLyBUT0RPOiByZW1vdmUgc3VwcG9ydCBmb3Igd2lkZ2V0RXZlbnRQcmVmaXgKCQkvLyBhbHdheXMgdXNlIHRoZSBuYW1lICsgYSBjb2xvbiBhcyB0aGUgcHJlZml4LCBlLmcuLCBkcmFnZ2FibGU6c3RhcnQKCQkvLyBkb24ndCBwcmVmaXggZm9yIHdpZGdldHMgdGhhdCBhcmVuJ3QgRE9NLWJhc2VkCgkJd2lkZ2V0RXZlbnRQcmVmaXg6IGV4aXN0aW5nQ29uc3RydWN0b3IgPyAoYmFzZVByb3RvdHlwZS53aWRnZXRFdmVudFByZWZpeCB8fCBuYW1lKSA6IG5hbWUKCX0sIHByb3hpZWRQcm90b3R5cGUsIHsKCQljb25zdHJ1Y3RvcjogY29uc3RydWN0b3IsCgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRGdWxsTmFtZTogZnVsbE5hbWUKCX0pOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIHJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLCBjaGlsZC5fcHJvdG8gKTsKCQl9KTsKCQkvLyByZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7CgoJcmV0dXJuIGNvbnN0cnVjdG9yOwp9OwoKJC53aWRnZXQuZXh0ZW5kID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCXZhciBpbnB1dCA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCWlucHV0SW5kZXggPSAwLAoJCWlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLAoJCWtleSwKCQl2YWx1ZTsKCWZvciAoIDsgaW5wdXRJbmRleCA8IGlucHV0TGVuZ3RoOyBpbnB1dEluZGV4KysgKSB7CgkJZm9yICgga2V5IGluIGlucHV0WyBpbnB1dEluZGV4IF0gKSB7CgkJCXZhbHVlID0gaW5wdXRbIGlucHV0SW5kZXggXVsga2V5IF07CgkJCWlmICggaW5wdXRbIGlucHV0SW5kZXggXS5oYXNPd25Qcm9wZXJ0eSgga2V5ICkgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCS8vIENsb25lIG9iamVjdHMKCQkJCWlmICggJC5pc1BsYWluT2JqZWN0KCB2YWx1ZSApICkgewoJCQkJCXRhcmdldFsga2V5IF0gPSAkLmlzUGxhaW5PYmplY3QoIHRhcmdldFsga2V5IF0gKSA/CgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHRhcmdldFsga2V5IF0sIHZhbHVlICkgOgoJCQkJCQkvLyBEb24ndCBleHRlbmQgc3RyaW5ncywgYXJyYXlzLCBldGMuIHdpdGggb2JqZWN0cwoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB2YWx1ZSApOwoJCQkJLy8gQ29weSBldmVyeXRoaW5nIGVsc2UgYnkgcmVmZXJlbmNlCgkJCQl9IGVsc2UgewoJCQkJCXRhcmdldFsga2V5IF0gPSB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCX0KCXJldHVybiB0YXJnZXQ7Cn07CgokLndpZGdldC5icmlkZ2UgPSBmdW5jdGlvbiggbmFtZSwgb2JqZWN0ICkgewoJdmFyIGZ1bGxOYW1lID0gb2JqZWN0LnByb3RvdHlwZS53aWRnZXRGdWxsTmFtZSB8fCBuYW1lOwoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlzTWV0aG9kQ2FsbCA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiwKCQkJYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCQlyZXR1cm5WYWx1ZSA9IHRoaXM7CgoJCS8vIGFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCW9wdGlvbnMgPSAhaXNNZXRob2RDYWxsICYmIGFyZ3MubGVuZ3RoID8KCQkJJC53aWRnZXQuZXh0ZW5kLmFwcGx5KCBudWxsLCBbIG9wdGlvbnMgXS5jb25jYXQoYXJncykgKSA6CgkJCW9wdGlvbnM7CgoJCWlmICggaXNNZXRob2RDYWxsICkgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgbWV0aG9kVmFsdWUsCgkJCQkJaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7CgkJCQlpZiAoIG9wdGlvbnMgPT09ICJpbnN0YW5jZSIgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBpbnN0YW5jZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKyAiIHByaW9yIHRvIGluaXRpYWxpemF0aW9uOyAiICsKCQkJCQkJImF0dGVtcHRlZCB0byBjYWxsIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyIgKTsKCQkJCX0KCQkJCWlmICggISQuaXNGdW5jdGlvbiggaW5zdGFuY2Vbb3B0aW9uc10gKSB8fCBvcHRpb25zLmNoYXJBdCggMCApID09PSAiXyIgKSB7CgkJCQkJcmV0dXJuICQuZXJyb3IoICJubyBzdWNoIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyBmb3IgIiArIG5hbWUgKyAiIHdpZGdldCBpbnN0YW5jZSIgKTsKCQkJCX0KCQkJCW1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCQkJCWlmICggbWV0aG9kVmFsdWUgIT09IGluc3RhbmNlICYmIG1ldGhvZFZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZSAmJiBtZXRob2RWYWx1ZS5qcXVlcnkgPwoJCQkJCQlyZXR1cm5WYWx1ZS5wdXNoU3RhY2soIG1ldGhvZFZhbHVlLmdldCgpICkgOgoJCQkJCQltZXRob2RWYWx1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICkuX2luaXQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSwgbmV3IG9iamVjdCggb3B0aW9ucywgdGhpcyApICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfTsKfTsKCiQuV2lkZ2V0ID0gZnVuY3Rpb24oIC8qIG9wdGlvbnMsIGVsZW1lbnQgKi8gKSB7fTsKJC5XaWRnZXQuX2NoaWxkQ29uc3RydWN0b3JzID0gW107CgokLldpZGdldC5wcm90b3R5cGUgPSB7Cgl3aWRnZXROYW1lOiAid2lkZ2V0IiwKCXdpZGdldEV2ZW50UHJlZml4OiAiIiwKCWRlZmF1bHRFbGVtZW50OiAiPGRpdj4iLAoJb3B0aW9uczogewoJCWRpc2FibGVkOiBmYWxzZSwKCgkJLy8gY2FsbGJhY2tzCgkJY3JlYXRlOiBudWxsCgl9LAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJZWxlbWVudCA9ICQoIGVsZW1lbnQgfHwgdGhpcy5kZWZhdWx0RWxlbWVudCB8fCB0aGlzIClbIDAgXTsKCQl0aGlzLmVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJdGhpcy51dWlkID0gdXVpZCsrOwoJCXRoaXMuZXZlbnROYW1lc3BhY2UgPSAiLiIgKyB0aGlzLndpZGdldE5hbWUgKyB0aGlzLnV1aWQ7CgkJdGhpcy5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwKCQkJdGhpcy5vcHRpb25zLAoJCQl0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksCgkJCW9wdGlvbnMgKTsKCgkJdGhpcy5iaW5kaW5ncyA9ICQoKTsKCQl0aGlzLmhvdmVyYWJsZSA9ICQoKTsKCQl0aGlzLmZvY3VzYWJsZSA9ICQoKTsKCgkJaWYgKCBlbGVtZW50ICE9PSB0aGlzICkgewoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0RnVsbE5hbWUsIHRoaXMgKTsKCQkJdGhpcy5fb24oIHRydWUsIHRoaXMuZWxlbWVudCwgewoJCQkJcmVtb3ZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBldmVudC50YXJnZXQgPT09IGVsZW1lbnQgKSB7CgkJCQkJCXRoaXMuZGVzdHJveSgpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJCXRoaXMuZG9jdW1lbnQgPSAkKCBlbGVtZW50LnN0eWxlID8KCQkJCS8vIGVsZW1lbnQgd2l0aGluIHRoZSBkb2N1bWVudAoJCQkJZWxlbWVudC5vd25lckRvY3VtZW50IDoKCQkJCS8vIGVsZW1lbnQgaXMgd2luZG93IG9yIGRvY3VtZW50CgkJCQllbGVtZW50LmRvY3VtZW50IHx8IGVsZW1lbnQgKTsKCQkJdGhpcy53aW5kb3cgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmRlZmF1bHRWaWV3IHx8IHRoaXMuZG9jdW1lbnRbMF0ucGFyZW50V2luZG93ICk7CgkJfQoKCQl0aGlzLl9jcmVhdGUoKTsKCQl0aGlzLl90cmlnZ2VyKCAiY3JlYXRlIiwgbnVsbCwgdGhpcy5fZ2V0Q3JlYXRlRXZlbnREYXRhKCkgKTsKCQl0aGlzLl9pbml0KCk7Cgl9LAoJX2dldENyZWF0ZU9wdGlvbnM6ICQubm9vcCwKCV9nZXRDcmVhdGVFdmVudERhdGE6ICQubm9vcCwKCV9jcmVhdGU6ICQubm9vcCwKCV9pbml0OiAkLm5vb3AsCgoJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZGVzdHJveSgpOwoJCS8vIHdlIGNhbiBwcm9iYWJseSByZW1vdmUgdGhlIHVuYmluZCBjYWxscyBpbiAyLjAKCQkvLyBhbGwgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGdvIHRocm91Z2ggdGhpcy5fb24oKQoJCXRoaXMuZWxlbWVudAoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKQoJCQkvLyBzdXBwb3J0OiBqcXVlcnkgPDEuNi4zCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMKCQkJLnJlbW92ZURhdGEoICQuY2FtZWxDYXNlKCB0aGlzLndpZGdldEZ1bGxOYW1lICkgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7CgoJCS8vIGNsZWFuIHVwIGV2ZW50cyBhbmQgc3RhdGVzCgkJdGhpcy5iaW5kaW5ncy51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKTsKCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7Cgl9LAoJX2Rlc3Ryb3k6ICQubm9vcCwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXksCgkJCXBhcnRzLAoJCQljdXJPcHRpb24sCgkJCWk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIGhhbmRsZSBuZXN0ZWQga2V5cywgZS5nLiwgImZvby5iYXIiID0+IHsgZm9vOiB7IGJhcjogX19fIH0gfQoJCQlvcHRpb25zID0ge307CgkJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIgKTsKCQkJa2V5ID0gcGFydHMuc2hpZnQoKTsKCQkJaWYgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQljdXJPcHRpb24gPSBvcHRpb25zWyBrZXkgXSA9ICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9uc1sga2V5IF0gKTsKCQkJCWZvciAoIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrICkgewoJCQkJCWN1ck9wdGlvblsgcGFydHNbIGkgXSBdID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gfHwge307CgkJCQkJY3VyT3B0aW9uID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF07CgkJCQl9CgkJCQlrZXkgPSBwYXJ0cy5wb3AoKTsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gY3VyT3B0aW9uWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IGN1ck9wdGlvblsga2V5IF07CgkJCQl9CgkJCQljdXJPcHRpb25bIGtleSBdID0gdmFsdWU7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQkJfQoJCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGtleTsKCgkJZm9yICgga2V5IGluIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3NldE9wdGlvbigga2V5LCBvcHRpb25zWyBrZXkgXSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnRvZ2dsZUNsYXNzKCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCIsICEhdmFsdWUgKTsKCQkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb25zKHsgZGlzYWJsZWQ6IGZhbHNlIH0pOwoJfSwKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb25zKHsgZGlzYWJsZWQ6IHRydWUgfSk7Cgl9LAoKCV9vbjogZnVuY3Rpb24oIHN1cHByZXNzRGlzYWJsZWRDaGVjaywgZWxlbWVudCwgaGFuZGxlcnMgKSB7CgkJdmFyIGRlbGVnYXRlRWxlbWVudCwKCQkJaW5zdGFuY2UgPSB0aGlzOwoKCQkvLyBubyBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgZmxhZywgc2h1ZmZsZSBhcmd1bWVudHMKCQlpZiAoIHR5cGVvZiBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgIT09ICJib29sZWFuIiApIHsKCQkJaGFuZGxlcnMgPSBlbGVtZW50OwoJCQllbGVtZW50ID0gc3VwcHJlc3NEaXNhYmxlZENoZWNrOwoJCQlzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgPSBmYWxzZTsKCQl9CgoJCS8vIG5vIGVsZW1lbnQgYXJndW1lbnQsIHNodWZmbGUgYW5kIHVzZSB0aGlzLmVsZW1lbnQKCQlpZiAoICFoYW5kbGVycyApIHsKCQkJaGFuZGxlcnMgPSBlbGVtZW50OwoJCQllbGVtZW50ID0gdGhpcy5lbGVtZW50OwoJCQlkZWxlZ2F0ZUVsZW1lbnQgPSB0aGlzLndpZGdldCgpOwoJCX0gZWxzZSB7CgkJCS8vIGFjY2VwdCBzZWxlY3RvcnMsIERPTSBlbGVtZW50cwoJCQllbGVtZW50ID0gZGVsZWdhdGVFbGVtZW50ID0gJCggZWxlbWVudCApOwoJCQl0aGlzLmJpbmRpbmdzID0gdGhpcy5iaW5kaW5ncy5hZGQoIGVsZW1lbnQgKTsKCQl9CgoJCSQuZWFjaCggaGFuZGxlcnMsIGZ1bmN0aW9uKCBldmVudCwgaGFuZGxlciApIHsKCQkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQkJLy8gYWxsb3cgd2lkZ2V0cyB0byBjdXN0b21pemUgdGhlIGRpc2FibGVkIGhhbmRsaW5nCgkJCQkvLyAtIGRpc2FibGVkIGFzIGFuIGFycmF5IGluc3RlYWQgb2YgYm9vbGVhbgoJCQkJLy8gLSBkaXNhYmxlZCBjbGFzcyBhcyBtZXRob2QgZm9yIGRpc2FibGluZyBpbmRpdmlkdWFsIHBhcnRzCgkJCQlpZiAoICFzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgJiYKCQkJCQkJKCBpbnN0YW5jZS5vcHRpb25zLmRpc2FibGVkID09PSB0cnVlIHx8CgkJCQkJCQkkKCB0aGlzICkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQkJfQoKCQkJLy8gY29weSB0aGUgZ3VpZCBzbyBkaXJlY3QgdW5iaW5kaW5nIHdvcmtzCgkJCWlmICggdHlwZW9mIGhhbmRsZXIgIT09ICJzdHJpbmciICkgewoJCQkJaGFuZGxlclByb3h5Lmd1aWQgPSBoYW5kbGVyLmd1aWQgPQoJCQkJCWhhbmRsZXIuZ3VpZCB8fCBoYW5kbGVyUHJveHkuZ3VpZCB8fCAkLmd1aWQrKzsKCQkJfQoKCQkJdmFyIG1hdGNoID0gZXZlbnQubWF0Y2goIC9eKFx3KylccyooLiopJC8gKSwKCQkJCWV2ZW50TmFtZSA9IG1hdGNoWzFdICsgaW5zdGFuY2UuZXZlbnROYW1lc3BhY2UsCgkJCQlzZWxlY3RvciA9IG1hdGNoWzJdOwoJCQlpZiAoIHNlbGVjdG9yICkgewoJCQkJZGVsZWdhdGVFbGVtZW50LmRlbGVnYXRlKCBzZWxlY3RvciwgZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsKCQkJfSBlbHNlIHsKCQkJCWVsZW1lbnQuYmluZCggZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsKCQkJfQoJCX0pOwoJfSwKCglfb2ZmOiBmdW5jdGlvbiggZWxlbWVudCwgZXZlbnROYW1lICkgewoJCWV2ZW50TmFtZSA9IChldmVudE5hbWUgfHwgIiIpLnNwbGl0KCAiICIgKS5qb2luKCB0aGlzLmV2ZW50TmFtZXNwYWNlICsgIiAiICkgKyB0aGlzLmV2ZW50TmFtZXNwYWNlOwoJCWVsZW1lbnQudW5iaW5kKCBldmVudE5hbWUgKS51bmRlbGVnYXRlKCBldmVudE5hbWUgKTsKCX0sCgoJX2RlbGF5OiBmdW5jdGlvbiggaGFuZGxlciwgZGVsYXkgKSB7CgkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQl9CgkJdmFyIGluc3RhbmNlID0gdGhpczsKCQlyZXR1cm4gc2V0VGltZW91dCggaGFuZGxlclByb3h5LCBkZWxheSB8fCAwICk7Cgl9LAoKCV9ob3ZlcmFibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXRoaXMuaG92ZXJhYmxlID0gdGhpcy5ob3ZlcmFibGUuYWRkKCBlbGVtZW50ICk7CgkJdGhpcy5fb24oIGVsZW1lbnQsIHsKCQkJbW91c2VlbnRlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLmFkZENsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0sCgkJCW1vdXNlbGVhdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV9mb2N1c2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXRoaXMuZm9jdXNhYmxlID0gdGhpcy5mb2N1c2FibGUuYWRkKCBlbGVtZW50ICk7CgkJdGhpcy5fb24oIGVsZW1lbnQsIHsKCQkJZm9jdXNpbjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLmFkZENsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0sCgkJCWZvY3Vzb3V0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfQoJCX0pOwoJfSwKCglfdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGV2ZW50LCBkYXRhICkgewoJCXZhciBwcm9wLCBvcmlnLAoJCQljYWxsYmFjayA9IHRoaXMub3B0aW9uc1sgdHlwZSBdOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCQlldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CgkJZXZlbnQudHlwZSA9ICggdHlwZSA9PT0gdGhpcy53aWRnZXRFdmVudFByZWZpeCA/CgkJCXR5cGUgOgoJCQl0aGlzLndpZGdldEV2ZW50UHJlZml4ICsgdHlwZSApLnRvTG93ZXJDYXNlKCk7CgkJLy8gdGhlIG9yaWdpbmFsIGV2ZW50IG1heSBjb21lIGZyb20gYW55IGVsZW1lbnQKCQkvLyBzbyB3ZSBuZWVkIHRvIHJlc2V0IHRoZSB0YXJnZXQgb24gdGhlIG5ldyBldmVudAoJCWV2ZW50LnRhcmdldCA9IHRoaXMuZWxlbWVudFsgMCBdOwoKCQkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkJb3JpZyA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7CgkJaWYgKCBvcmlnICkgewoJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCQlpZiAoICEoIHByb3AgaW4gZXZlbnQgKSApIHsKCQkJCQlldmVudFsgcHJvcCBdID0gb3JpZ1sgcHJvcCBdOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggZXZlbnQsIGRhdGEgKTsKCQlyZXR1cm4gISggJC5pc0Z1bmN0aW9uKCBjYWxsYmFjayApICYmCgkJCWNhbGxiYWNrLmFwcGx5KCB0aGlzLmVsZW1lbnRbMF0sIFsgZXZlbnQgXS5jb25jYXQoIGRhdGEgKSApID09PSBmYWxzZSB8fAoJCQlldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApOwoJfQp9OwoKJC5lYWNoKCB7IHNob3c6ICJmYWRlSW4iLCBoaWRlOiAiZmFkZU91dCIgfSwgZnVuY3Rpb24oIG1ldGhvZCwgZGVmYXVsdEVmZmVjdCApIHsKCSQuV2lkZ2V0LnByb3RvdHlwZVsgIl8iICsgbWV0aG9kIF0gPSBmdW5jdGlvbiggZWxlbWVudCwgb3B0aW9ucywgY2FsbGJhY2sgKSB7CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgKSB7CgkJCW9wdGlvbnMgPSB7IGVmZmVjdDogb3B0aW9ucyB9OwoJCX0KCQl2YXIgaGFzT3B0aW9ucywKCQkJZWZmZWN0TmFtZSA9ICFvcHRpb25zID8KCQkJCW1ldGhvZCA6CgkJCQlvcHRpb25zID09PSB0cnVlIHx8IHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiA/CgkJCQkJZGVmYXVsdEVmZmVjdCA6CgkJCQkJb3B0aW9ucy5lZmZlY3QgfHwgZGVmYXVsdEVmZmVjdDsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiApIHsKCQkJb3B0aW9ucyA9IHsgZHVyYXRpb246IG9wdGlvbnMgfTsKCQl9CgkJaGFzT3B0aW9ucyA9ICEkLmlzRW1wdHlPYmplY3QoIG9wdGlvbnMgKTsKCQlvcHRpb25zLmNvbXBsZXRlID0gY2FsbGJhY2s7CgkJaWYgKCBvcHRpb25zLmRlbGF5ICkgewoJCQllbGVtZW50LmRlbGF5KCBvcHRpb25zLmRlbGF5ICk7CgkJfQoJCWlmICggaGFzT3B0aW9ucyAmJiAkLmVmZmVjdHMgJiYgJC5lZmZlY3RzLmVmZmVjdFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBtZXRob2QgXSggb3B0aW9ucyApOwoJCX0gZWxzZSBpZiAoIGVmZmVjdE5hbWUgIT09IG1ldGhvZCAmJiBlbGVtZW50WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIGVmZmVjdE5hbWUgXSggb3B0aW9ucy5kdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcsIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudC5xdWV1ZShmdW5jdGlvbiggbmV4dCApIHsKCQkJCSQoIHRoaXMgKVsgbWV0aG9kIF0oKTsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCggZWxlbWVudFsgMCBdICk7CgkJCQl9CgkJCQluZXh0KCk7CgkJCX0pOwoJCX0KCX07Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcmNhcGl0YWxzID0gL1tBLVpdL2csCglyZXBsYWNlRnVuY3Rpb24gPSBmdW5jdGlvbiggYyApIHsKCQlyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwoJfTsKCiQuZXh0ZW5kKCAkLldpZGdldC5wcm90b3R5cGUsIHsKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9uLCB2YWx1ZSwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudFsgMCBdLAoJCQlvcHRpb25zID0ge307CgoJCS8vCgkJaWYgKCAhJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBlbGVtLCAiZGVmYXVsdHMiICkgKSB7CgkJCWZvciAoIG9wdGlvbiBpbiB0aGlzLm9wdGlvbnMgKSB7CgkJCQl2YWx1ZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggZWxlbSwgb3B0aW9uLnJlcGxhY2UoIHJjYXBpdGFscywgcmVwbGFjZUZ1bmN0aW9uICkgKTsKCgkJCQlpZiAoIHZhbHVlICE9IG51bGwgKSB7CgkJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIG9wdGlvbnM7Cgl9Cn0pOwoKLy9UT0RPOiBSZW1vdmUgaW4gMS41IGZvciBiYWNrY29tcGF0IG9ubHkKJC5tb2JpbGUud2lkZ2V0ID0gJC5XaWRnZXQ7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoJLy8gVE9ETyBtb3ZlIGxvYWRlciBjbGFzcyBkb3duIGludG8gdGhlIHdpZGdldCBzZXR0aW5ncwoJdmFyIGxvYWRlckNsYXNzID0gInVpLWxvYWRlciIsICRodG1sID0gJCggImh0bWwiICk7CgoJJC53aWRnZXQoICJtb2JpbGUubG9hZGVyIiwgewoJCS8vIE5PVEUgaWYgdGhlIGdsb2JhbCBjb25maWcgc2V0dGluZ3MgYXJlIGRlZmluZWQgdGhleSB3aWxsIG92ZXJyaWRlIHRoZXNlCgkJLy8gICAgICBvcHRpb25zCgkJb3B0aW9uczogewoJCQkvLyB0aGUgdGhlbWUgZm9yIHRoZSBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhlbWU6ICJhIiwKCgkJCS8vIHdoZXRoZXIgdGhlIHRleHQgaW4gdGhlIGxvYWRpbmcgbWVzc2FnZSBpcyBzaG93bgoJCQl0ZXh0VmlzaWJsZTogZmFsc2UsCgoJCQkvLyBjdXN0b20gaHRtbCBmb3IgdGhlIGlubmVyIGNvbnRlbnQgb2YgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQlodG1sOiAiIiwKCgkJCS8vIHRoZSB0ZXh0IHRvIGJlIGRpc3BsYXllZCB3aGVuIHRoZSBwb3B1cCBpcyBzaG93bgoJCQl0ZXh0OiAibG9hZGluZyIKCQl9LAoKCQlkZWZhdWx0SHRtbDogIjxkaXYgY2xhc3M9JyIgKyBsb2FkZXJDbGFzcyArICInPiIgKwoJCQkiPHNwYW4gY2xhc3M9J3VpLWljb24tbG9hZGluZyc+PC9zcGFuPiIgKwoJCQkiPGgxPjwvaDE+IiArCgkJCSI8L2Rpdj4iLAoKCQkvLyBGb3Igbm9uLWZpeGVkIHN1cHBvcnRpbiBicm93c2Vycy4gUG9zaXRpb24gYXQgeSBjZW50ZXIgKGlmIHNjcm9sbFRvcCBzdXBwb3J0ZWQpLCBhYm92ZSB0aGUgYWN0aXZlQnRuIChpZiBkZWZpbmVkKSwgb3IganVzdCAxMDBweCBmcm9tIHRvcAoJCWZha2VGaXhMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5maXJzdCgpOwoKCQkJdGhpcy5lbGVtZW50CgkJCQkuY3NzKHsKCQkJCQl0b3A6ICQuc3VwcG9ydC5zY3JvbGxUb3AgJiYgdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCkgKyB0aGlzLndpbmRvdy5oZWlnaHQoKSAvIDIgfHwKCQkJCQkJYWN0aXZlQnRuLmxlbmd0aCAmJiBhY3RpdmVCdG4ub2Zmc2V0KCkudG9wIHx8IDEwMAoJCQkJfSk7CgkJfSwKCgkJLy8gY2hlY2sgcG9zaXRpb24gb2YgbG9hZGVyIHRvIHNlZSBpZiBpdCBhcHBlYXJzIHRvIGJlICJmaXhlZCIgdG8gY2VudGVyCgkJLy8gaWYgbm90LCB1c2UgYWJzIHBvc2l0aW9uaW5nCgkJY2hlY2tMb2FkZXJQb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJCXZhciBvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCksCgkJCQlzY3JvbGxUb3AgPSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJaWYgKCBvZmZzZXQudG9wIDwgc2Nyb2xsVG9wIHx8ICggb2Zmc2V0LnRvcCAtIHNjcm9sbFRvcCApID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCQl0aGlzLmZha2VGaXhMb2FkZXIoKTsKCQkJCXRoaXMud2luZG93CgkJCQkJLnVuYmluZCggInNjcm9sbCIsIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiApCgkJCQkJLmJpbmQoICJzY3JvbGwiLCAkLnByb3h5KCB0aGlzLmZha2VGaXhMb2FkZXIsIHRoaXMgKSApOwoJCQl9CgkJfSwKCgkJcmVzZXRIdG1sOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50Lmh0bWwoICQoIHRoaXMuZGVmYXVsdEh0bWwgKS5odG1sKCkgKTsKCQl9LAoKCQkvLyBUdXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4gVGhlbWUgZG91YmxlcyBhcyBhbiBvYmplY3QgYXJndW1lbnQKCQkvLyB3aXRoIHRoZSBmb2xsb3dpbmcgc2hhcGU6IHsgdGhlbWU6ICcnLCB0ZXh0OiAnJywgaHRtbDogJycsIHRleHRWaXNpYmxlOiAnJyB9CgkJLy8gTk9URSB0aGF0IHRoZSAkLm1vYmlsZS5sb2FkaW5nKiBzZXR0aW5ncyBhbmQgcGFyYW1zIHBhc3QgdGhlIGZpcnN0IGFyZSBkZXByZWNhdGVkCgkJLy8gVE9ETyBzd2VldCBqZXN1cyB3ZSBuZWVkIHRvIGJyZWFrIHNvbWUgb2YgdGhpcyBvdXQKCQlzaG93OiBmdW5jdGlvbiggdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICkgewoJCQl2YXIgdGV4dFZpc2libGUsIG1lc3NhZ2UsIGxvYWRTZXR0aW5nczsKCgkJCXRoaXMucmVzZXRIdG1sKCk7CgoJCQkvLyB1c2UgdGhlIHByb3RvdHlwZSBvcHRpb25zIHNvIHRoYXQgcGVvcGxlIGNhbiBzZXQgdGhlbSBnbG9iYWxseSBhdAoJCQkvLyBtb2JpbGUgaW5pdC4gQ29uc2lzdGVuY3ksIGl0J3Mgd2hhdCdzIGZvciBkaW5uZXIKCQkJaWYgKCAkLnR5cGUoIHRoZW1lICkgPT09ICJvYmplY3QiICkgewoJCQkJbG9hZFNldHRpbmdzID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIHRoZW1lICk7CgoJCQkJdGhlbWUgPSBsb2FkU2V0dGluZ3MudGhlbWU7CgkJCX0gZWxzZSB7CgkJCQlsb2FkU2V0dGluZ3MgPSB0aGlzLm9wdGlvbnM7CgoJCQkJLy8gaGVyZSB3ZSBwcmVmZXIgdGhlIHRoZW1lIHZhbHVlIHBhc3NlZCBhcyBhIHN0cmluZyBhcmd1bWVudCwgdGhlbgoJCQkJLy8gd2UgcHJlZmVyIHRoZSBnbG9iYWwgb3B0aW9uIGJlY2F1c2Ugd2UgY2FuJ3QgdXNlIHVuZGVmaW5lZCBkZWZhdWx0CgkJCQkvLyBwcm90b3R5cGUgb3B0aW9ucywgdGhlbiB0aGUgcHJvdG90eXBlIG9wdGlvbgoJCQkJdGhlbWUgPSB0aGVtZSB8fCBsb2FkU2V0dGluZ3MudGhlbWU7CgkJCX0KCgkJCS8vIHNldCB0aGUgbWVzc2FnZSB0ZXh0LCBwcmVmZXIgdGhlIHBhcmFtLCB0aGVuIHRoZSBzZXR0aW5ncyBvYmplY3QKCQkJLy8gdGhlbiBsb2FkaW5nIG1lc3NhZ2UKCQkJbWVzc2FnZSA9IG1zZ1RleHQgfHwgKCBsb2FkU2V0dGluZ3MudGV4dCA9PT0gZmFsc2UgPyAiIiA6IGxvYWRTZXR0aW5ncy50ZXh0ICk7CgoJCQkvLyBwcmVwYXJlIHRoZSBkb20KCQkJJGh0bWwuYWRkQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJdGV4dFZpc2libGUgPSBsb2FkU2V0dGluZ3MudGV4dFZpc2libGU7CgoJCQkvLyBhZGQgdGhlIHByb3BlciBjc3MgZ2l2ZW4gdGhlIG9wdGlvbnMgKHRoZW1lLCB0ZXh0LCBldGMpCgkJCS8vIEZvcmNlIHRleHQgdmlzaWJpbGl0eSBpZiB0aGUgc2Vjb25kIGFyZ3VtZW50IHdhcyBzdXBwbGllZCwgb3IKCQkJLy8gaWYgdGhlIHRleHQgd2FzIGV4cGxpY2l0bHkgc2V0IGluIHRoZSBvYmplY3QgYXJncwoJCQl0aGlzLmVsZW1lbnQuYXR0cigiY2xhc3MiLCBsb2FkZXJDbGFzcyArCgkJCQkiIHVpLWNvcm5lci1hbGwgdWktYm9keS0iICsgdGhlbWUgKwoJCQkJIiB1aS1sb2FkZXItIiArICggdGV4dFZpc2libGUgfHwgbXNnVGV4dCB8fCB0aGVtZS50ZXh0ID8gInZlcmJvc2UiIDogImRlZmF1bHQiICkgKwoJCQkJKCBsb2FkU2V0dGluZ3MudGV4dG9ubHkgfHwgdGV4dG9ubHkgPyAiIHVpLWxvYWRlci10ZXh0b25seSIgOiAiIiApICk7CgoJCQkvLyBUT0RPIHZlcmlmeSB0aGF0IGpxdWVyeS5mbi5odG1sIGlzIG9rIHRvIHVzZSBpbiBib3RoIGNhc2VzIGhlcmUKCQkJLy8gICAgICB0aGlzIG1pZ2h0IGJlIG92ZXJseSBkZWZlbnNpdmUgaW4gcHJldmVudGluZyB1bmtub3dpbmcgeHNzCgkJCS8vIGlmIHRoZSBodG1sIGF0dHJpYnV0ZSBpcyBkZWZpbmVkIG9uIHRoZSBsb2FkaW5nIHNldHRpbmdzLCB1c2UgdGhhdAoJCQkvLyBvdGhlcndpc2UgdXNlIHRoZSBmYWxsYmFja3MgZnJvbSBhYm92ZQoJCQlpZiAoIGxvYWRTZXR0aW5ncy5odG1sICkgewoJCQkJdGhpcy5lbGVtZW50Lmh0bWwoIGxvYWRTZXR0aW5ncy5odG1sICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggImgxIiApLnRleHQoIG1lc3NhZ2UgKTsKCQkJfQoKCQkJLy8gYXR0YWNoIHRoZSBsb2FkZXIgdG8gdGhlIERPTQoJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCS8vIGNoZWNrIHRoYXQgdGhlIGxvYWRlciBpcyB2aXNpYmxlCgkJCXRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbigpOwoKCQkJLy8gb24gc2Nyb2xsIGNoZWNrIHRoZSBsb2FkZXIgcG9zaXRpb24KCQkJdGhpcy53aW5kb3cuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiwgdGhpcyApICk7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oKSB7CgkJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLnRleHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJfQoKCQkJJC5tb2JpbGUud2luZG93LnVuYmluZCggInNjcm9sbCIsIHRoaXMuZmFrZUZpeExvYWRlciApOwoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICk7CgkJfQoJfSk7Cgp9KShqUXVlcnksIHRoaXMpOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8qISBtYXRjaE1lZGlhKCkgcG9seWZpbGwgLSBUZXN0IGEgQ1NTIG1lZGlhIHR5cGUvcXVlcnkgaW4gSlMuIEF1dGhvcnMgJiBjb3B5cmlnaHQgKGMpIDIwMTI6IFNjb3R0IEplaGwsIFBhdWwgSXJpc2gsIE5pY2hvbGFzIFpha2FzLiBEdWFsIE1JVC9CU0QgbGljZW5zZSAqLwoJd2luZG93Lm1hdGNoTWVkaWEgPSB3aW5kb3cubWF0Y2hNZWRpYSB8fCAoZnVuY3Rpb24oIGRvYywgdW5kZWZpbmVkICkgewoKCQl2YXIgYm9vbCwKCQkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCgkJCXJlZk5vZGUgPSBkb2NFbGVtLmZpcnN0RWxlbWVudENoaWxkIHx8IGRvY0VsZW0uZmlyc3RDaGlsZCwKCQkJLy8gZmFrZUJvZHkgcmVxdWlyZWQgZm9yIDxGRjQgd2hlbiBleGVjdXRlZCBpbiA8aGVhZD4KCQkJZmFrZUJvZHkgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvZHkiICksCgkJCWRpdiA9IGRvYy5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQlkaXYuaWQgPSAibXEtdGVzdC0xIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTEwMGVtIjsKCQlmYWtlQm9keS5zdHlsZS5iYWNrZ3JvdW5kID0gIm5vbmUiOwoJCWZha2VCb2R5LmFwcGVuZENoaWxkKGRpdik7CgoJCXJldHVybiBmdW5jdGlvbihxKXsKCgkJCWRpdi5pbm5lckhUTUwgPSAiJnNoeTs8c3R5bGUgbWVkaWE9XCIiICsgcSArICJcIj4gI21xLXRlc3QtMSB7IHdpZHRoOiA0MnB4OyB9PC9zdHlsZT4iOwoKCQkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGZha2VCb2R5LCByZWZOb2RlICk7CgkJCWJvb2wgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQyOwoJCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBmYWtlQm9keSApOwoKCQkJcmV0dXJuIHsKCQkJCW1hdGNoZXM6IGJvb2wsCgkJCQltZWRpYTogcQoJCQl9OwoKCQl9OwoKCX0oIGRvY3VtZW50ICkpOwoKCS8vICQubW9iaWxlLm1lZGlhIHVzZXMgbWF0Y2hNZWRpYSB0byByZXR1cm4gYSBib29sZWFuLgoJJC5tb2JpbGUubWVkaWEgPSBmdW5jdGlvbiggcSApIHsKCQlyZXR1cm4gd2luZG93Lm1hdGNoTWVkaWEoIHEgKS5tYXRjaGVzOwoJfTsKCn0pKGpRdWVyeSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZS5zdXBwb3J0ID0gJC5tb2JpbGUuc3VwcG9ydCB8fCB7fTsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCBzdXBwb3J0ICk7CgkJJC5leHRlbmQoICQubW9iaWxlLnN1cHBvcnQsIHN1cHBvcnQgKTsKCX0oIGpRdWVyeSApKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkJCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93CgkJfSk7Cgl9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKSwKCQl2OwoKCWZvciAoIHYgaW4gcHJvcHMgKSB7CgkJaWYgKCBmYkNTU1sgcHJvcHNbIHYgXSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KfQoKdmFyIGZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5wcmVwZW5kVG8oICJodG1sIiApLAoJZmJDU1MgPSBmYWtlQm9keVsgMCBdLnN0eWxlLAoJdmVuZG9ycyA9IFsgIldlYmtpdCIsICJNb3oiLCAiTyIgXSwKCXdlYm9zID0gInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93LCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBzY3JvbGxUb3AKCW9wZXJhbWluaSA9IHdpbmRvdy5vcGVyYW1pbmkgJiYgKHt9KS50b1N0cmluZy5jYWxsKCB3aW5kb3cub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iLAoJYmIgPSB3aW5kb3cuYmxhY2tiZXJyeSAmJiAhcHJvcEV4aXN0cyggIi13ZWJraXQtdHJhbnNmb3JtIiApLCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBib3ggc2hhZG93LCBhcyBpdCdzIGZpbGxlZCBvcGFxdWUgb24gQkIgNSBhbmQgbG93ZXIKCW5va2lhTFRFN18zOwoKLy8gaW5saW5lIFNWRyBzdXBwb3J0IHRlc3QKZnVuY3Rpb24gaW5saW5lU1ZHKCkgewoJLy8gVGhhbmtzIE1vZGVybml6ciAmIEVyaWsgRGFobHN0cm9tCgl2YXIgdyA9IHdpbmRvdywKCQlzdmcgPSAhIXcuZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TICYmICEhdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIsICJzdmciICkuY3JlYXRlU1ZHUmVjdCAmJiAhKCB3Lm9wZXJhICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkNocm9tZSIgKSA9PT0gLTEgKSwKCQlzdXBwb3J0ID0gZnVuY3Rpb24oIGRhdGEgKSB7CgkJCWlmICggISggZGF0YSAmJiBzdmcgKSApIHsKCQkJCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbm9zdmciICk7CgkJCX0KCQl9LAoJCWltZyA9IG5ldyB3LkltYWdlKCk7CgoJaW1nLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKCQlzdXBwb3J0KCBmYWxzZSApOwoJfTsKCWltZy5vbmxvYWQgPSBmdW5jdGlvbigpIHsKCQlzdXBwb3J0KCBpbWcud2lkdGggPT09IDEgJiYgaW1nLmhlaWdodCA9PT0gMSApOwoJfTsKCWltZy5zcmMgPSAiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUFBQUFBQVAvLy95d0FBQUFBQVFBQkFBQUNBVXdBT3c9PSI7Cn0KCmZ1bmN0aW9uIHRyYW5zZm9ybTNkVGVzdCgpIHsKCXZhciBtcVByb3AgPSAidHJhbnNmb3JtLTNkIiwKCQkvLyBCZWNhdXNlIHRoZSBgdHJhbnNsYXRlM2RgIHRlc3QgYmVsb3cgdGhyb3dzIGZhbHNlIHBvc2l0aXZlcyBpbiBBbmRyb2lkOgoJCXJldCA9ICQubW9iaWxlLm1lZGlhKCAiKC0iICsgdmVuZG9ycy5qb2luKCAiLSIgKyBtcVByb3AgKyAiKSwoLSIgKSArICItIiArIG1xUHJvcCArICIpLCgiICsgbXFQcm9wICsgIikiICksCgkJZWwsIHRyYW5zZm9ybXMsIHQ7CgoJaWYgKCByZXQgKSB7CgkJcmV0dXJuICEhcmV0OwoJfQoKCWVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCXRyYW5zZm9ybXMgPSB7CgkJLy8gV2XigJlyZSBvbWl0dGluZyBPcGVyYSBmb3IgdGhlIHRpbWUgYmVpbmc7IE1TIHVzZXMgdW5wcmVmaXhlZC4KCQkiTW96VHJhbnNmb3JtIjogIi1tb3otdHJhbnNmb3JtIiwKCQkidHJhbnNmb3JtIjogInRyYW5zZm9ybSIKCX07CgoJZmFrZUJvZHkuYXBwZW5kKCBlbCApOwoKCWZvciAoIHQgaW4gdHJhbnNmb3JtcyApIHsKCQlpZiAoIGVsLnN0eWxlWyB0IF0gIT09IHVuZGVmaW5lZCApIHsKCQkJZWwuc3R5bGVbIHQgXSA9ICJ0cmFuc2xhdGUzZCggMTAwcHgsIDFweCwgMXB4ICkiOwoJCQlyZXQgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZWwgKS5nZXRQcm9wZXJ0eVZhbHVlKCB0cmFuc2Zvcm1zWyB0IF0gKTsKCQl9Cgl9CglyZXR1cm4gKCAhIXJldCAmJiByZXQgIT09ICJub25lIiApOwp9CgovLyBUZXN0IGZvciBkeW5hbWljLXVwZGF0aW5nIGJhc2UgdGFnIHN1cHBvcnQgKCBhbGxvd3MgdXMgdG8gYXZvaWQgaHJlZixzcmMgYXR0ciByZXdyaXRpbmcgKQpmdW5jdGlvbiBiYXNlVGFnVGVzdCgpIHsKCXZhciBmYXV4QmFzZSA9IGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSArICJ1aS1kaXIvIiwKCQliYXNlID0gJCggImhlYWQgYmFzZSIgKSwKCQlmYXV4RWxlID0gbnVsbCwKCQlocmVmID0gIiIsCgkJbGluaywgcmViYXNlOwoKCWlmICggIWJhc2UubGVuZ3RoICkgewoJCWJhc2UgPSBmYXV4RWxlID0gJCggIjxiYXNlPiIsIHsgImhyZWYiOiBmYXV4QmFzZSB9KS5hcHBlbmRUbyggImhlYWQiICk7Cgl9IGVsc2UgewoJCWhyZWYgPSBiYXNlLmF0dHIoICJocmVmIiApOwoJfQoKCWxpbmsgPSAkKCAiPGEgaHJlZj0ndGVzdHVybCcgLz4iICkucHJlcGVuZFRvKCBmYWtlQm9keSApOwoJcmViYXNlID0gbGlua1sgMCBdLmhyZWY7CgliYXNlWyAwIF0uaHJlZiA9IGhyZWYgfHwgbG9jYXRpb24ucGF0aG5hbWU7CgoJaWYgKCBmYXV4RWxlICkgewoJCWZhdXhFbGUucmVtb3ZlKCk7Cgl9CglyZXR1cm4gcmViYXNlLmluZGV4T2YoIGZhdXhCYXNlICkgPT09IDA7Cn0KCi8vIFRoYW5rcyBNb2Rlcm5penIKZnVuY3Rpb24gY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSB7Cgl2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJ4IiApLAoJCWRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlnZXRDb21wdXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUsCgkJc3VwcG9ydHM7CgoJaWYgKCAhKCAicG9pbnRlckV2ZW50cyIgaW4gZWxlbWVudC5zdHlsZSApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAiYXV0byI7CgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAieCI7Cglkb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoIGVsZW1lbnQgKTsKCXN1cHBvcnRzID0gZ2V0Q29tcHV0ZWRTdHlsZSAmJgoJZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbWVudCwgIiIgKS5wb2ludGVyRXZlbnRzID09PSAiYXV0byI7Cglkb2N1bWVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoIGVsZW1lbnQgKTsKCXJldHVybiAhIXN1cHBvcnRzOwp9CgpmdW5jdGlvbiBib3VuZGluZ1JlY3QoKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCXJldHVybiB0eXBlb2YgZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gInVuZGVmaW5lZCI7Cn0KCi8vIG5vbi1VQS1iYXNlZCBJRSB2ZXJzaW9uIGNoZWNrIGJ5IEphbWVzIFBhZG9sc2V5LCBtb2RpZmllZCBieSBqZGFsdG9uIC0gZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzUyNzY4MwovLyBhbGxvd3MgZm9yIGluY2x1c2lvbiBvZiBJRSA2KywgaW5jbHVkaW5nIFdpbmRvd3MgTW9iaWxlIDcKJC5leHRlbmQoICQubW9iaWxlLCB7IGJyb3dzZXI6IHt9IH0gKTsKJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSA9IChmdW5jdGlvbigpIHsKCXZhciB2ID0gMywKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCWEgPSBkaXYuYWxsIHx8IFtdOwoKCWRvIHsKCQlkaXYuaW5uZXJIVE1MID0gIjwhLS1baWYgZ3QgSUUgIiArICggKyt2ICkgKyAiXT48YnI+PCFbZW5kaWZdLS0+IjsKCX0gd2hpbGUoIGFbMF0gKTsKCglyZXR1cm4gdiA+IDQgPyB2IDogIXY7Cn0pKCk7CgpmdW5jdGlvbiBmaXhlZFBvc2l0aW9uKCkgewoJdmFyIHcgPSB3aW5kb3csCgkJdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLAoJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJZmZtYXRjaCA9IHVhLm1hdGNoKCAvRmVubmVjXC8oWzAtOV0rKS8gKSwKCQlmZnZlcnNpb24gPSAhIWZmbWF0Y2ggJiYgZmZtYXRjaFsgMSBdLAoJCW9wZXJhbW1vYmlsZW1hdGNoID0gdWEubWF0Y2goIC9PcGVyYSBNb2JpXC8oWzAtOV0rKS8gKSwKCQlvbXZlcnNpb24gPSAhIW9wZXJhbW1vYmlsZW1hdGNoICYmIG9wZXJhbW1vYmlsZW1hdGNoWyAxIF07CgoJaWYgKAoJCS8vIGlPUyA0LjMgYW5kIG9sZGVyIDogUGxhdGZvcm0gaXMgaVBob25lL1BhZC9Ub3VjaCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzNCAoaW9zNSkKCQkoICggcGxhdGZvcm0uaW5kZXhPZiggImlQaG9uZSIgKSA+IC0xIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUGFkIiApID4gLTEgIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUG9kIiApID4gLTEgKSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkgfHwKCQkvLyBPcGVyYSBNaW5pCgkJKCB3Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHcub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iICkgfHwKCQkoIG9wZXJhbW1vYmlsZW1hdGNoICYmIG9tdmVyc2lvbiA8IDc0NTggKQl8fAoJCS8vQW5kcm9pZCBsdGUgMi4xOiBQbGF0Zm9ybSBpcyBBbmRyb2lkIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTMzIChBbmRyb2lkIDIuMikKCQkoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzMyApIHx8CgkJLy8gRmlyZWZveCBNb2JpbGUgYmVmb3JlIDYuMCAtCgkJKCBmZnZlcnNpb24gJiYgZmZ2ZXJzaW9uIDwgNiApIHx8CgkJLy8gV2ViT1MgbGVzcyB0aGFuIDMKCQkoICJwYWxtR2V0UmVzb3VyY2UiIGluIHdpbmRvdyAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkJfHwKCQkvLyBNZWVHbwoJCSggdWEuaW5kZXhPZiggIk1lZUdvIiApID4gLTEgJiYgdWEuaW5kZXhPZiggIk5va2lhQnJvd3Nlci84LjUuMCIgKSA+IC0xICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCXJldHVybiB0cnVlOwp9CgokLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkvLyBOb3RlLCBDaHJvbWUgZm9yIGlPUyBoYXMgYW4gZXh0cmVtZWx5IHF1aXJreSBpbXBsZW1lbnRhdGlvbiBvZiBwb3BzdGF0ZS4KCS8vIFdlJ3ZlIGNob3NlbiB0byB0YWtlIHRoZSBzaG9ydGVzdCBwYXRoIHRvIGEgYnVnIGZpeCBoZXJlIGZvciBpc3N1ZSAjNTQyNgoJLy8gU2VlIHRoZSBmb2xsb3dpbmcgbGluayBmb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlZ2V4IGNob3NlbgoJLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vY2hyb21lL21vYmlsZS9kb2NzL3VzZXItYWdlbnQjY2hyb21lX2Zvcl9pb3NfdXNlci1hZ2VudAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCS8vIFdoZW4gcnVubmluZyBpbnNpZGUgYSBGRiBpZnJhbWUsIGNhbGxpbmcgcmVwbGFjZVN0YXRlIGNhdXNlcyBhbiBlcnJvcgoJCSEoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJGaXJlZm94IiApID49IDAgJiYgd2luZG93LnRvcCAhPT0gd2luZG93ICkgJiYKCQkoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnNlYXJjaCgvQ3JpT1MvKSA9PT0gLTEgKSwKCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJYm94U2hhZG93OiAhIXByb3BFeGlzdHMoICJib3hTaGFkb3ciICkgJiYgIWJiLAoJZml4ZWRQb3NpdGlvbjogZml4ZWRQb3NpdGlvbigpLAoJc2Nyb2xsVG9wOiAoInBhZ2VYT2Zmc2V0IiBpbiB3aW5kb3cgfHwKCQkic2Nyb2xsVG9wIiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgfHwKCQkic2Nyb2xsVG9wIiBpbiBmYWtlQm9keVsgMCBdKSAmJiAhd2Vib3MgJiYgIW9wZXJhbWluaSwKCglkeW5hbWljQmFzZVRhZzogYmFzZVRhZ1Rlc3QoKSwKCWNzc1BvaW50ZXJFdmVudHM6IGNzc1BvaW50ZXJFdmVudHNUZXN0KCksCglib3VuZGluZ1JlY3Q6IGJvdW5kaW5nUmVjdCgpLAoJaW5saW5lU1ZHOiBpbmxpbmVTVkcKfSk7CgpmYWtlQm9keS5yZW1vdmUoKTsKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKbm9raWFMVEU3XzMgPSAoZnVuY3Rpb24oKSB7CgoJdmFyIHVhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7CgoJLy9UaGUgZm9sbG93aW5nIGlzIGFuIGF0dGVtcHQgdG8gbWF0Y2ggTm9raWEgYnJvd3NlcnMgdGhhdCBhcmUgcnVubmluZyBTeW1iaWFuL3M2MCwgd2l0aCB3ZWJraXQsIHZlcnNpb24gNy4zIG9yIG9sZGVyCglyZXR1cm4gdWEuaW5kZXhPZiggIk5va2lhIiApID4gLTEgJiYKCQkJKCB1YS5pbmRleE9mKCAiU3ltYmlhbi8zIiApID4gLTEgfHwgdWEuaW5kZXhPZiggIlNlcmllczYwLzUiICkgPiAtMSApICYmCgkJCXVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICYmCgkJCXVhLm1hdGNoKCAvKEJyb3dzZXJOR3xOb2tpYUJyb3dzZXIpXC83XC5bMC0zXS8gKTsKfSkoKTsKCi8vIFN1cHBvcnQgY29uZGl0aW9ucyB0aGF0IG11c3QgYmUgbWV0IGluIG9yZGVyIHRvIHByb2NlZWQKLy8gZGVmYXVsdCBlbmhhbmNlZCBxdWFsaWZpY2F0aW9ucyBhcmUgbWVkaWEgcXVlcnkgc3VwcG9ydCBPUiBJRSA3KwoKJC5tb2JpbGUuZ3JhZGVBID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gKCAoICQuc3VwcG9ydC5tZWRpYXF1ZXJ5ICYmICQuc3VwcG9ydC5jc3NQc2V1ZG9FbGVtZW50ICkgfHwgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFID49IDggKSAmJiAoICQuc3VwcG9ydC5ib3VuZGluZ1JlY3QgfHwgJC5mbi5qcXVlcnkubWF0Y2goLzFcLlswLTcrXVwuWzAtOStdPy8pICE9PSBudWxsICk7Cn07CgokLm1vYmlsZS5hamF4QmxhY2tsaXN0ID0KCQkJLy8gQmxhY2tCZXJyeSBicm93c2VycywgcHJlLXdlYmtpdAoJCQl3aW5kb3cuYmxhY2tiZXJyeSAmJiAhd2luZG93LldlYktpdFBvaW50IHx8CgkJCS8vIE9wZXJhIE1pbmkKCQkJb3BlcmFtaW5pIHx8CgkJCS8vIFN5bWJpYW4gd2Via2l0cyBwcmUgNy4zCgkJCW5va2lhTFRFN18zOwoKLy8gTGFzdGx5LCB0aGlzIHdvcmthcm91bmQgaXMgdGhlIG9ubHkgd2F5IHdlJ3ZlIGZvdW5kIHNvIGZhciB0byBnZXQgcHJlIDcuMyBTeW1iaWFuIHdlYmtpdCBkZXZpY2VzCi8vIHRvIHJlbmRlciB0aGUgc3R5bGVzaGVldHMgd2hlbiB0aGV5J3JlIHJlZmVyZW5jZWQgYmVmb3JlIHRoaXMgc2NyaXB0LCBhcyB3ZSdkIHJlY29tbWVuZCBkb2luZy4KLy8gVGhpcyBzaW1wbHkgcmVhcHBlbmRzIHRoZSBDU1MgaW4gcGxhY2UsIHdoaWNoIGZvciBzb21lIHJlYXNvbiBtYWtlcyBpdCBhcHBseQppZiAoIG5va2lhTFRFN18zICkgewoJJChmdW5jdGlvbigpIHsKCQkkKCAiaGVhZCBsaW5rW3JlbD0nc3R5bGVzaGVldCddIiApLmF0dHIoICJyZWwiLCAiYWx0ZXJuYXRlIHN0eWxlc2hlZXQiICkuYXR0ciggInJlbCIsICJzdHlsZXNoZWV0IiApOwoJfSk7Cn0KCi8vIEZvciBydWxpbmcgb3V0IHNoYWRvd3MgdmlhIGNzcwppZiAoICEkLnN1cHBvcnQuYm94U2hhZG93ICkgewoJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1ub2JveHNoYWRvdyIgKTsKfQoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3csIHNlbGYsCgkJZHVtbXlGblRvSW5pdE5hdmlnYXRlID0gZnVuY3Rpb24oKSB7CgkJfTsKCgkkLmV2ZW50LnNwZWNpYWwuYmVmb3JlbmF2aWdhdGUgPSB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkkd2luLm9uKCAibmF2aWdhdGUiLCBkdW1teUZuVG9Jbml0TmF2aWdhdGUgKTsKCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCSR3aW4ub2ZmKCAibmF2aWdhdGUiLCBkdW1teUZuVG9Jbml0TmF2aWdhdGUgKTsKCQl9Cgl9OwoKCSQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZSA9IHNlbGYgPSB7CgkJYm91bmQ6IGZhbHNlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQlvcmlnaW5hbEV2ZW50TmFtZTogdW5kZWZpbmVkLAoKCQkvLyBJZiBwdXNoc3RhdGUgc3VwcG9ydCBpcyBwcmVzZW50IGFuZCBwdXNoIHN0YXRlIHN1cHBvcnQgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIHRydWUgb24gdGhlIG1vYmlsZSBuYW1lc3BhY2UuCgkJaXNQdXNoU3RhdGVFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQuc3VwcG9ydC5wdXNoU3RhdGUgJiYKCQkJCSQubW9iaWxlLnB1c2hTdGF0ZUVuYWJsZWQgPT09IHRydWUgJiYKCQkJCXRoaXMuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpOwoJCX0sCgoJCS8vICEhIGFzc3VtZXMgbW9iaWxlIG5hbWVzcGFjZSBpcyBwcmVzZW50CgkJaXNIYXNoQ2hhbmdlRW5hYmxlZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCA9PT0gdHJ1ZTsKCQl9LAoKCQkvLyBUT0RPIGEgbG90IG9mIGR1cGxpY2F0aW9uIGJldHdlZW4gcG9wc3RhdGUgYW5kIGhhc2hjaGFuZ2UKCQlwb3BzdGF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApLAoJCQkJc3RhdGUgPSBldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlIHx8IHt9OwoKCQkJYmVmb3JlTmF2aWdhdGUub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiAoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIGV2ZW50Lmhpc3RvcnlTdGF0ZSApIHsKCQkJCSQuZXh0ZW5kKHN0YXRlLCBldmVudC5oaXN0b3J5U3RhdGUpOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhlIG9yaWdpbmFsIGV2ZW50IGlzIHRyYWNrZWQgZm9yIHRoZSBlbmQKCQkJLy8gdXNlciB0byBpbnNwZWN0IGluY2FzZSB0aGV5IHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwKCQkJbmV3RXZlbnQub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoKCQkJLy8gTk9URSB3ZSBsZXQgdGhlIGN1cnJlbnQgc3RhY2sgdW53aW5kIGJlY2F1c2UgYW55IGFzc2lnbm1lbnQgdG8KCQkJLy8gICAgICBsb2NhdGlvbi5oYXNoIHdpbGwgc3RvcCB0aGUgd29ybGQgYW5kIHJ1biB0aGlzIGV2ZW50IGhhbmRsZXIuIEJ5CgkJCS8vICAgICAgZG9pbmcgdGhpcyB3ZSBjcmVhdGUgYSBzaW1pbGFyIGJlaGF2aW9yIHRvIGhhc2hjaGFuZ2Ugb24gaGFzaAoJCQkvLyAgICAgIGFzc2lnbm1lbnQKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCQlzdGF0ZTogc3RhdGUKCQkJCX0pOwoJCQl9LCAwKTsKCQl9LAoKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgLyosIGRhdGEgKi8gKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICk7CgoJCQliZWZvcmVOYXZpZ2F0ZS5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmICggYmVmb3JlTmF2aWdhdGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgb3JpZ2luYWwgZXZlbnQgaXMgdHJhY2tlZCBmb3IgdGhlIGVuZAoJCQkvLyB1c2VyIHRvIGluc3BlY3QgaW5jYXNlIHRoZXkgd2FudCB0byBkbyBzb21ldGhpbmcgc3BlY2lhbAoJCQluZXdFdmVudC5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgoJCQkvLyBUcmlnZ2VyIHRoZSBoYXNoY2hhbmdlIHdpdGggc3RhdGUgcHJvdmlkZWQgYnkgdGhlIHVzZXIKCQkJLy8gdGhhdCBhbHRlcmVkIHRoZSBoYXNoCgkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCS8vIFVzZXJzIHRoYXQgd2FudCB0byBmdWxseSBub3JtYWxpemUgdGhlIHR3byBldmVudHMKCQkJCS8vIHdpbGwgbmVlZCB0byBkbyBoaXN0b3J5IG1hbmFnZW1lbnQgZG93biB0aGUgc3RhY2sgYW5kCgkJCQkvLyBhZGQgdGhlIHN0YXRlIHRvIHRoZSBldmVudCBiZWZvcmUgdGhpcyBiaW5kaW5nIGlzIGZpcmVkCgkJCQkvLyBUT0RPIGNvbnNpZGVyIGFsbG93aW5nIGZvciB0aGUgZXhwbGljaXQgYWRkaXRpb24gb2YgY2FsbGJhY2tzCgkJCQkvLyAgICAgIHRvIGJlIGZpcmVkIGJlZm9yZSB0aGlzIHZhbHVlIGlzIHNldCB0byBhdm9pZCBldmVudCB0aW1pbmcgaXNzdWVzCgkJCQlzdGF0ZTogZXZlbnQuaGFzaGNoYW5nZVN0YXRlIHx8IHt9CgkJCX0pOwoJCX0sCgoJCS8vIFRPRE8gV2UgcmVhbGx5IG9ubHkgd2FudCB0byBzZXQgdGhpcyB1cCBvbmNlCgkJLy8gICAgICBidXQgSSdtIG5vdCBjbGVhciBpZiB0aGVyZSdzIGEgYmV0ZXIgd2F5IHRvIGFjaGlldmUKCQkvLyAgICAgIHRoaXMgd2l0aCB0aGUgalF1ZXJ5IHNwZWNpYWwgZXZlbnQgc3RydWN0dXJlCgkJc2V0dXA6IGZ1bmN0aW9uKCAvKiBkYXRhLCBuYW1lc3BhY2VzICovICkgewoJCQlpZiAoIHNlbGYuYm91bmQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXNlbGYuYm91bmQgPSB0cnVlOwoKCQkJaWYgKCBzZWxmLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJwb3BzdGF0ZSI7CgkJCQkkd2luLmJpbmQoICJwb3BzdGF0ZS5uYXZpZ2F0ZSIsIHNlbGYucG9wc3RhdGUgKTsKCQkJfSBlbHNlIGlmICggc2VsZi5pc0hhc2hDaGFuZ2VFbmFibGVkKCkgKSB7CgkJCQlzZWxmLm9yaWdpbmFsRXZlbnROYW1lID0gImhhc2hjaGFuZ2UiOwoJCQkJJHdpbi5iaW5kKCAiaGFzaGNoYW5nZS5uYXZpZ2F0ZSIsIHNlbGYuaGFzaGNoYW5nZSApOwoJCQl9CgkJfQoJfTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgcGF0aCwgJGJhc2UsIGRpYWxvZ0hhc2hLZXkgPSAiJnVpLXN0YXRlPWRpYWxvZyI7CgoJCSQubW9iaWxlLnBhdGggPSBwYXRoID0gewoJCQl1aVN0YXRlS2V5OiAiJnVpLXN0YXRlIiwKCgkJCS8vIFRoaXMgc2NhcnkgbG9va2luZyByZWd1bGFyIGV4cHJlc3Npb24gcGFyc2VzIGFuIGFic29sdXRlIFVSTCBvciBpdHMgcmVsYXRpdmUKCQkJLy8gdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGFuZCBoYXNoKSwgaW50byB0aGUgdmFyaW91cwoJCQkvLyBjb21wb25lbnRzIChwcm90b2NvbCwgaG9zdCwgcGF0aCwgcXVlcnksIGZyYWdtZW50LCBldGMgdGhhdCBtYWtlIHVwIHRoZQoJCQkvLyBVUkwgYXMgd2VsbCBhcyBzb21lIG90aGVyIGNvbW1vbmx5IHVzZWQgc3ViLXBhcnRzLiBXaGVuIHVzZWQgd2l0aCBSZWdFeHAuZXhlYygpCgkJCS8vIG9yIFN0cmluZy5tYXRjaCwgaXQgcGFyc2VzIHRoZSBVUkwgaW50byBhIHJlc3VsdHMgYXJyYXkgdGhhdCBsb29rcyBsaWtlIHRoaXM6CgkJCS8vCgkJCS8vICAgICBbMF06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZCNtc2ctY29udGVudAoJCQkvLyAgICAgWzFdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgIFsyXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94CgkJCS8vICAgICBbM106IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs0XTogaHR0cDoKCQkJLy8gICAgIFs1XTogLy8KCQkJLy8gICAgIFs2XTogamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbN106IGpibGFzOnBhc3N3b3JkCgkJCS8vICAgICBbOF06IGpibGFzCgkJCS8vICAgICBbOV06IHBhc3N3b3JkCgkJCS8vICAgIFsxMF06IG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICBbMTFdOiBteWNvbXBhbnkuY29tCgkJCS8vICAgIFsxMl06IDgwODAKCQkJLy8gICAgWzEzXTogL21haWwvaW5ib3gKCQkJLy8gICAgWzE0XTogL21haWwvCgkJCS8vICAgIFsxNV06IGluYm94CgkJCS8vICAgIFsxNl06ID9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICBbMTddOiAjbXNnLWNvbnRlbnQKCQkJLy8KCQkJdXJsUGFyc2VSRTogL15ccyooKCgoW146XC8jXD9dKzopPyg/OihcL1wvKSgoPzooKFteOkBcLyNcP10rKSg/Olw6KFteOkBcLyNcP10rKSk/KUApPygoW146XC8jXD9cXVxbXSt8XFtbXlwvXF1AIz9dK1xdKSg/Olw6KFswLTldKykpPykpPyk/KT8oKFwvPyg/OlteXC9cPyNdK1wvKykqKShbXlw/I10qKSkpPyhcP1teI10rKT8pKCMuKik/LywKCgkJCS8vIEFic3RyYWN0aW9uIHRvIGFkZHJlc3MgeHNzIChJc3N1ZSAjNDc4NykgYnkgcmVtb3ZpbmcgdGhlIGF1dGhvcml0eSBpbgoJCQkvLyBicm93c2VycyB0aGF0IGF1dG8tZGVjb2RlIGl0LiBBbGwgcmVmZXJlbmNlcyB0byBsb2NhdGlvbi5ocmVmIHNob3VsZCBiZQoJCQkvLyByZXBsYWNlZCB3aXRoIGEgY2FsbCB0byB0aGlzIG1ldGhvZCBzbyB0aGF0IGl0IGNhbiBiZSBkZWFsdCB3aXRoIHByb3Blcmx5IGhlcmUKCQkJZ2V0TG9jYXRpb246IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgcGFyc2VkVXJsID0gdGhpcy5wYXJzZVVybCggdXJsIHx8IGxvY2F0aW9uLmhyZWYgKSwKCQkJCQl1cmkgPSB1cmwgPyBwYXJzZWRVcmwgOiBsb2NhdGlvbiwKCgkJCQkJLy8gTWFrZSBzdXJlIHRvIHBhcnNlIHRoZSB1cmwgb3IgdGhlIGxvY2F0aW9uIG9iamVjdCBmb3IgdGhlIGhhc2ggYmVjYXVzZSB1c2luZwoJCQkJCS8vIGxvY2F0aW9uLmhhc2ggaXMgYXV0b2RlY29kZWQgaW4gZmlyZWZveCwgdGhlIHJlc3Qgb2YgdGhlIHVybCBzaG91bGQgYmUgZnJvbQoJCQkJCS8vIHRoZSBvYmplY3QgKGxvY2F0aW9uIHVubGVzcyB3ZSdyZSB0ZXN0aW5nKSB0byBhdm9pZCB0aGUgaW5jbHVzaW9uIG9mIHRoZQoJCQkJCS8vIGF1dGhvcml0eQoJCQkJCWhhc2ggPSBwYXJzZWRVcmwuaGFzaDsKCgkJCQkvLyBtaW1pYyB0aGUgYnJvd3NlciB3aXRoIGFuIGVtcHR5IHN0cmluZyB3aGVuIHRoZSBoYXNoIGlzIGVtcHR5CgkJCQloYXNoID0gaGFzaCA9PT0gIiMiID8gIiIgOiBoYXNoOwoKCQkJCXJldHVybiB1cmkucHJvdG9jb2wgKwoJCQkJCXBhcnNlZFVybC5kb3VibGVTbGFzaCArCgkJCQkJdXJpLmhvc3QgKwoKCQkJCQkvLyBUaGUgcGF0aG5hbWUgbXVzdCBzdGFydCB3aXRoIGEgc2xhc2ggaWYgdGhlcmUncyBhIHByb3RvY29sLCBiZWNhdXNlIHlvdQoJCQkJCS8vIGNhbid0IGhhdmUgYSBwcm90b2NvbCBmb2xsb3dlZCBieSBhIHJlbGF0aXZlIHBhdGguIEFsc28sIGl0J3MgaW1wb3NzaWJsZSB0bwoJCQkJCS8vIGNhbGN1bGF0ZSBhYnNvbHV0ZSBVUkxzIGZyb20gcmVsYXRpdmUgb25lcyBpZiB0aGUgYWJzb2x1dGUgb25lIGRvZXNuJ3QgaGF2ZQoJCQkJCS8vIGEgbGVhZGluZyAiLyIuCgkJCQkJKCAoIHVyaS5wcm90b2NvbCAhPT0gIiIgJiYgdXJpLnBhdGhuYW1lLnN1YnN0cmluZyggMCwgMSApICE9PSAiLyIgKSA/CgkJCQkJCSIvIiA6ICIiICkgKwoJCQkJCXVyaS5wYXRobmFtZSArCgkJCQkJdXJpLnNlYXJjaCArCgkJCQkJaGFzaDsKCQkJfSwKCgkJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQkJZ2V0RG9jdW1lbnRVcmw6IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQkJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgcGF0aC5kb2N1bWVudFVybCApIDogcGF0aC5kb2N1bWVudFVybC5ocmVmOwoJCQl9LAoKCQkJcGFyc2VMb2NhdGlvbjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5wYXJzZVVybCggdGhpcy5nZXRMb2NhdGlvbigpICk7CgkJCX0sCgoJCQkvL1BhcnNlIGEgVVJMIGludG8gYSBzdHJ1Y3R1cmUgdGhhdCBhbGxvd3MgZWFzeSBhY2Nlc3MgdG8KCQkJLy9hbGwgb2YgdGhlIFVSTCBjb21wb25lbnRzIGJ5IG5hbWUuCgkJCXBhcnNlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gSWYgd2UncmUgcGFzc2VkIGFuIG9iamVjdCwgd2UnbGwgYXNzdW1lIHRoYXQgaXQgaXMKCQkJCS8vIGEgcGFyc2VkIHVybCBvYmplY3QgYW5kIGp1c3QgcmV0dXJuIGl0IGJhY2sgdG8gdGhlIGNhbGxlci4KCQkJCWlmICggJC50eXBlKCB1cmwgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQkJcmV0dXJuIHVybDsKCQkJCX0KCgkJCQl2YXIgbWF0Y2hlcyA9IHBhdGgudXJsUGFyc2VSRS5leGVjKCB1cmwgfHwgIiIgKSB8fCBbXTsKCgkJCQkJLy8gQ3JlYXRlIGFuIG9iamVjdCB0aGF0IGFsbG93cyB0aGUgY2FsbGVyIHRvIGFjY2VzcyB0aGUgc3ViLW1hdGNoZXMKCQkJCQkvLyBieSBuYW1lLiBOb3RlIHRoYXQgSUUgcmV0dXJucyBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiB1bmRlZmluZWQsCgkJCQkJLy8gbGlrZSBhbGwgb3RoZXIgYnJvd3NlcnMgZG8sIHNvIHdlIG5vcm1hbGl6ZSBldmVyeXRoaW5nIHNvIGl0cyBjb25zaXN0ZW50CgkJCQkJLy8gbm8gbWF0dGVyIHdoYXQgYnJvd3NlciB3ZSdyZSBydW5uaW5nIG9uLgoJCQkJCXJldHVybiB7CgkJCQkJCWhyZWY6ICAgICAgICAgbWF0Y2hlc1sgIDAgXSB8fCAiIiwKCQkJCQkJaHJlZk5vSGFzaDogICBtYXRjaGVzWyAgMSBdIHx8ICIiLAoJCQkJCQlocmVmTm9TZWFyY2g6IG1hdGNoZXNbICAyIF0gfHwgIiIsCgkJCQkJCWRvbWFpbjogICAgICAgbWF0Y2hlc1sgIDMgXSB8fCAiIiwKCQkJCQkJcHJvdG9jb2w6ICAgICBtYXRjaGVzWyAgNCBdIHx8ICIiLAoJCQkJCQlkb3VibGVTbGFzaDogIG1hdGNoZXNbICA1IF0gfHwgIiIsCgkJCQkJCWF1dGhvcml0eTogICAgbWF0Y2hlc1sgIDYgXSB8fCAiIiwKCQkJCQkJdXNlcm5hbWU6ICAgICBtYXRjaGVzWyAgOCBdIHx8ICIiLAoJCQkJCQlwYXNzd29yZDogICAgIG1hdGNoZXNbICA5IF0gfHwgIiIsCgkJCQkJCWhvc3Q6ICAgICAgICAgbWF0Y2hlc1sgMTAgXSB8fCAiIiwKCQkJCQkJaG9zdG5hbWU6ICAgICBtYXRjaGVzWyAxMSBdIHx8ICIiLAoJCQkJCQlwb3J0OiAgICAgICAgIG1hdGNoZXNbIDEyIF0gfHwgIiIsCgkJCQkJCXBhdGhuYW1lOiAgICAgbWF0Y2hlc1sgMTMgXSB8fCAiIiwKCQkJCQkJZGlyZWN0b3J5OiAgICBtYXRjaGVzWyAxNCBdIHx8ICIiLAoJCQkJCQlmaWxlbmFtZTogICAgIG1hdGNoZXNbIDE1IF0gfHwgIiIsCgkJCQkJCXNlYXJjaDogICAgICAgbWF0Y2hlc1sgMTYgXSB8fCAiIiwKCQkJCQkJaGFzaDogICAgICAgICBtYXRjaGVzWyAxNyBdIHx8ICIiCgkJCQkJfTsKCQkJfSwKCgkJCS8vVHVybiByZWxQYXRoIGludG8gYW4gYXNib2x1dGUgcGF0aC4gYWJzUGF0aCBpcwoJCQkvL2FuIG9wdGlvbmFsIGFic29sdXRlIHBhdGggd2hpY2ggZGVzY3JpYmVzIHdoYXQKCQkJLy9yZWxQYXRoIGlzIHJlbGF0aXZlIHRvLgoJCQltYWtlUGF0aEFic29sdXRlOiBmdW5jdGlvbiggcmVsUGF0aCwgYWJzUGF0aCApIHsKCQkJCXZhciBhYnNTdGFjaywKCQkJCQlyZWxTdGFjaywKCQkJCQlpLCBkOwoKCQkJCWlmICggcmVsUGF0aCAmJiByZWxQYXRoLmNoYXJBdCggMCApID09PSAiLyIgKSB7CgkJCQkJcmV0dXJuIHJlbFBhdGg7CgkJCQl9CgoJCQkJcmVsUGF0aCA9IHJlbFBhdGggfHwgIiI7CgkJCQlhYnNQYXRoID0gYWJzUGF0aCA/IGFic1BhdGgucmVwbGFjZSggL15cL3woXC9bXlwvXSp8W15cL10rKSQvZywgIiIgKSA6ICIiOwoKCQkJCWFic1N0YWNrID0gYWJzUGF0aCA/IGFic1BhdGguc3BsaXQoICIvIiApIDogW107CgkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoKCQkJCWZvciAoIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJZCA9IHJlbFN0YWNrWyBpIF07CgkJCQkJc3dpdGNoICggZCApIHsKCQkJCQkJY2FzZSAiLiI6CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAiLi4iOgoJCQkJCQkJaWYgKCBhYnNTdGFjay5sZW5ndGggKSB7CgkJCQkJCQkJYWJzU3RhY2sucG9wKCk7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsKCQkJCQkJZGVmYXVsdDoKCQkJCQkJCWFic1N0YWNrLnB1c2goIGQgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAiLyIgKyBhYnNTdGFjay5qb2luKCAiLyIgKTsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGlmIGJvdGggdXJscyBoYXZlIHRoZSBzYW1lIGRvbWFpbi4KCQkJaXNTYW1lRG9tYWluOiBmdW5jdGlvbiggYWJzVXJsMSwgYWJzVXJsMiApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCBhYnNVcmwxICkuZG9tYWluLnRvTG93ZXJDYXNlKCkgPT09CgkJCQkJcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbi50b0xvd2VyQ2FzZSgpOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFueSByZWxhdGl2ZSB2YXJpYW50LgoJCQlpc1JlbGF0aXZlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gQWxsIHJlbGF0aXZlIFVybCB2YXJpYW50cyBoYXZlIG9uZSB0aGluZyBpbiBjb21tb24sIG5vIHByb3RvY29sLgoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sID09PSAiIjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbiBhYnNvbHV0ZSB1cmwuCgkJCWlzQWJzb2x1dGVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgIT09ICIiOwoJCQl9LAoKCQkJLy9UdXJuIHRoZSBzcGVjaWZpZWQgcmVhbHRpdmUgVVJMIGludG8gYW4gYWJzb2x1dGUgb25lLiBUaGlzIGZ1bmN0aW9uCgkJCS8vY2FuIGhhbmRsZSBhbGwgcmVsYXRpdmUgdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGZyYWdtZW50KS4KCQkJbWFrZVVybEFic29sdXRlOiBmdW5jdGlvbiggcmVsVXJsLCBhYnNVcmwgKSB7CgkJCQlpZiAoICFwYXRoLmlzUmVsYXRpdmVVcmwoIHJlbFVybCApICkgewoJCQkJCXJldHVybiByZWxVcmw7CgkJCQl9CgoJCQkJaWYgKCBhYnNVcmwgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlhYnNVcmwgPSB0aGlzLmRvY3VtZW50QmFzZTsKCQkJCX0KCgkJCQl2YXIgcmVsT2JqID0gcGF0aC5wYXJzZVVybCggcmVsVXJsICksCgkJCQkJYWJzT2JqID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICksCgkJCQkJcHJvdG9jb2wgPSByZWxPYmoucHJvdG9jb2wgfHwgYWJzT2JqLnByb3RvY29sLAoJCQkJCWRvdWJsZVNsYXNoID0gcmVsT2JqLnByb3RvY29sID8gcmVsT2JqLmRvdWJsZVNsYXNoIDogKCByZWxPYmouZG91YmxlU2xhc2ggfHwgYWJzT2JqLmRvdWJsZVNsYXNoICksCgkJCQkJYXV0aG9yaXR5ID0gcmVsT2JqLmF1dGhvcml0eSB8fCBhYnNPYmouYXV0aG9yaXR5LAoJCQkJCWhhc1BhdGggPSByZWxPYmoucGF0aG5hbWUgIT09ICIiLAoJCQkJCXBhdGhuYW1lID0gcGF0aC5tYWtlUGF0aEFic29sdXRlKCByZWxPYmoucGF0aG5hbWUgfHwgYWJzT2JqLmZpbGVuYW1lLCBhYnNPYmoucGF0aG5hbWUgKSwKCQkJCQlzZWFyY2ggPSByZWxPYmouc2VhcmNoIHx8ICggIWhhc1BhdGggJiYgYWJzT2JqLnNlYXJjaCApIHx8ICIiLAoJCQkJCWhhc2ggPSByZWxPYmouaGFzaDsKCgkJCQlyZXR1cm4gcHJvdG9jb2wgKyBkb3VibGVTbGFzaCArIGF1dGhvcml0eSArIHBhdGhuYW1lICsgc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCS8vQWRkIHNlYXJjaCAoYWthIHF1ZXJ5KSBwYXJhbXMgdG8gdGhlIHNwZWNpZmllZCB1cmwuCgkJCWFkZFNlYXJjaFBhcmFtczogZnVuY3Rpb24oIHVybCwgcGFyYW1zICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwID0gKCB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApID8gJC5wYXJhbSggcGFyYW1zICkgOiBwYXJhbXMsCgkJCQkJcyA9IHUuc2VhcmNoIHx8ICI/IjsKCQkJCXJldHVybiB1LmhyZWZOb1NlYXJjaCArIHMgKyAoIHMuY2hhckF0KCBzLmxlbmd0aCAtIDEgKSAhPT0gIj8iID8gIiYiIDogIiIgKSArIHAgKyAoIHUuaGFzaCB8fCAiIiApOwoJCQl9LAoKCQkJY29udmVydFVybFRvRGF0YVVybDogZnVuY3Rpb24oIGFic1VybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICk7CgkJCQlpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIHUgKSApIHsKCQkJCQkvLyBGb3IgZW1iZWRkZWQgcGFnZXMsIHJlbW92ZSB0aGUgZGlhbG9nIGhhc2gga2V5IGFzIGluIGdldEZpbGVQYXRoKCksCgkJCQkJLy8gYW5kIHJlbW92ZSBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoCgkJCQkJCS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdCgkJCQkJCS5yZXBsYWNlKCAvXiMvLCAiIiApCgkJCQkJCS5yZXBsYWNlKCAvXD8uKiQvLCAiIiApOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1NhbWVEb21haW4oIHUsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSB7CgkJCQkJcmV0dXJuIHUuaHJlZk5vSGFzaC5yZXBsYWNlKCB0aGlzLmRvY3VtZW50QmFzZS5kb21haW4sICIiICkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJCX0KCgkJCQlyZXR1cm4gd2luZG93LmRlY29kZVVSSUNvbXBvbmVudChhYnNVcmwpOwoJCQl9LAoKCQkJLy9nZXQgcGF0aCBmcm9tIGN1cnJlbnQgaGFzaCwgb3IgZnJvbSBhIGZpbGUgcGF0aAoJCQlnZXQ6IGZ1bmN0aW9uKCBuZXdQYXRoICkgewoJCQkJaWYgKCBuZXdQYXRoID09PSB1bmRlZmluZWQgKSB7CgkJCQkJbmV3UGF0aCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCQl9CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIG5ld1BhdGggKS5yZXBsYWNlKCAvW15cL10qXC5bXlwvKl0rJC8sICIiICk7CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKTsKCQkJfSwKCgkJCS8vanVzdCByZXR1cm4gdGhlIHVybCB3aXRob3V0IGFuIGluaXRpYWwgIwoJCQlzdHJpcEhhc2g6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9eIy8sICIiICk7CgkJCX0sCgoJCQlzdHJpcFF1ZXJ5UGFyYW1zOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXD8uKiQvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJaXNIYXNoVmFsaWQ6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuICggL14jW14jXSskLyApLnRlc3QoIGhhc2ggKTsKCQkJfSwKCgkJCS8vY2hlY2sgd2hldGhlciBhIHVybCBpcyByZWZlcmVuY2luZyB0aGUgc2FtZSBkb21haW4sIG9yIGFuIGV4dGVybmFsIGRvbWFpbiBvciBkaWZmZXJlbnQgcHJvdG9jb2wKCQkJLy9jb3VsZCBiZSBtYWlsdG8sIGV0YwoJCQlpc0V4dGVybmFsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQlyZXR1cm4gISEoIHUucHJvdG9jb2wgJiYKCQkJCQkoIHUuZG9tYWluLnRvTG93ZXJDYXNlKCkgIT09IHRoaXMuZG9jdW1lbnRVcmwuZG9tYWluLnRvTG93ZXJDYXNlKCkgKSApOwoJCQl9LAoKCQkJaGFzUHJvdG9jb2w6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXig6P1x3KzopLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJaXNFbWJlZGRlZFBhZ2U6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoKCQkJCS8vaWYgdGhlIHBhdGggaXMgYWJzb2x1dGUsIHRoZW4gd2UgbmVlZCB0byBjb21wYXJlIHRoZSB1cmwgYWdhaW5zdAoJCQkJLy9ib3RoIHRoZSB0aGlzLmRvY3VtZW50VXJsIGFuZCB0aGUgZG9jdW1lbnRCYXNlLiBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMKCQkJCS8vaXMgdGhhdCBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gZXh0ZXJuYWwgZG9jdW1lbnRzIHdpbGwgcmVmZXIgdG8gdGhlCgkJCQkvL2FwcGxpY2F0aW9uIGRvY3VtZW50LCB3aGVyZWFzIGxpbmtzIGVtYmVkZGVkIHdpdGhpbiB0aGUgYXBwbGljYXRpb24KCQkJCS8vZG9jdW1lbnQgd2lsbCBiZSByZXNvbHZlZCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBiYXNlLgoJCQkJaWYgKCB1LnByb3RvY29sICE9PSAiIiApIHsKCQkJCQlyZXR1cm4gKCAhdGhpcy5pc1BhdGgodS5oYXNoKSAmJiB1Lmhhc2ggJiYgKCB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSApICk7CgkJCQl9CgkJCQlyZXR1cm4gKCAvXiMvICkudGVzdCggdS5ocmVmICk7CgkJCX0sCgoJCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIHJlc29sdXRpb25VcmwgKSB7CgkJCQl2YXIgaHJlZiwgY2xlYW5lZFVybCwgc2VhcmNoLCBzdGF0ZUluZGV4LCBkb2NVcmwsCgkJCQkJaXNQYXRoID0gdGhpcy5pc1BhdGgoIHVybCApLAoJCQkJCXVyaSA9IHRoaXMucGFyc2VVcmwoIHVybCApLAoJCQkJCXByZXNlcnZlZEhhc2ggPSB1cmkuaGFzaCwKCQkJCQl1aVN0YXRlID0gIiI7CgoJCQkJLy8gcHJvZHVjZSBhIHVybCBhZ2FpbnN0IHdoaWNoIHdlIGNhbiByZXNvbHZlIHRoZSBwcm92aWRlZCBwYXRoCgkJCQlpZiAoICFyZXNvbHV0aW9uVXJsICkgewoJCQkJCWlmICggaXNQYXRoICkgewoJCQkJCQlyZXNvbHV0aW9uVXJsID0gcGF0aC5nZXRMb2NhdGlvbigpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWRvY1VybCA9IHBhdGguZ2V0RG9jdW1lbnRVcmwoIHRydWUgKTsKCQkJCQkJaWYgKCBwYXRoLmlzUGF0aCggZG9jVXJsLmhhc2ggKSApIHsKCQkJCQkJCXJlc29sdXRpb25VcmwgPSBwYXRoLnNxdWFzaCggZG9jVXJsLmhyZWYgKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJlc29sdXRpb25VcmwgPSBkb2NVcmwuaHJlZjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQkvLyBJZiB0aGUgdXJsIGlzIGFueXRoaW5nIGJ1dCBhIHNpbXBsZSBzdHJpbmcsIHJlbW92ZSBhbnkgcHJlY2VkaW5nIGhhc2gKCQkJCS8vIGVnICNmb28vYmFyIC0+IGZvby9iYXIKCQkJCS8vICAgICNmb28gLT4gI2ZvbwoJCQkJY2xlYW5lZFVybCA9IGlzUGF0aCA/IHBhdGguc3RyaXBIYXNoKCB1cmwgKSA6IHVybDsKCgkJCQkvLyBJZiB0aGUgdXJsIGlzIGEgZnVsbCB1cmwgd2l0aCBhIGhhc2ggY2hlY2sgaWYgdGhlIHBhcnNlZCBoYXNoIGlzIGEgcGF0aAoJCQkJLy8gaWYgaXQgaXMsIHN0cmlwIHRoZSAjLCBhbmQgdXNlIGl0IG90aGVyd2lzZSBjb250aW51ZSB3aXRob3V0IGNoYW5nZQoJCQkJY2xlYW5lZFVybCA9IHBhdGguaXNQYXRoKCB1cmkuaGFzaCApID8gcGF0aC5zdHJpcEhhc2goIHVyaS5oYXNoICkgOiBjbGVhbmVkVXJsOwoKCQkJCS8vIFNwbGl0IHRoZSBVSSBTdGF0ZSBrZXlzIG9mZiB0aGUgaHJlZgoJCQkJc3RhdGVJbmRleCA9IGNsZWFuZWRVcmwuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICk7CgoJCQkJLy8gc3RvcmUgdGhlIHVpIHN0YXRlIGtleXMgZm9yIHVzZQoJCQkJaWYgKCBzdGF0ZUluZGV4ID4gLTEgKSB7CgkJCQkJdWlTdGF0ZSA9IGNsZWFuZWRVcmwuc2xpY2UoIHN0YXRlSW5kZXggKTsKCQkJCQljbGVhbmVkVXJsID0gY2xlYW5lZFVybC5zbGljZSggMCwgc3RhdGVJbmRleCApOwoJCQkJfQoKCQkJCS8vIG1ha2UgdGhlIGNsZWFuZWRVcmwgYWJzb2x1dGUgcmVsYXRpdmUgdG8gdGhlIHJlc29sdXRpb24gdXJsCgkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGNsZWFuZWRVcmwsIHJlc29sdXRpb25VcmwgKTsKCgkJCQkvLyBncmFiIHRoZSBzZWFyY2ggZnJvbSB0aGUgcmVzb2x2ZWQgdXJsIHNpbmNlIHBhcnNpbmcgZnJvbQoJCQkJLy8gdGhlIHBhc3NlZCB1cmwgbWF5IG5vdCB5aWVsZCB0aGUgY29ycmVjdCByZXN1bHQKCQkJCXNlYXJjaCA9IHRoaXMucGFyc2VVcmwoIGhyZWYgKS5zZWFyY2g7CgoJCQkJLy8gVE9ETyBhbGwgdGhpcyBjcmFwIGlzIHRlcnJpYmxlLCBjbGVhbiBpdCB1cAoJCQkJaWYgKCBpc1BhdGggKSB7CgkJCQkJLy8gcmVqZWN0IHRoZSBoYXNoIGlmIGl0J3MgYSBwYXRoIG9yIGl0J3MganVzdCBhIGRpYWxvZyBrZXkKCQkJCQlpZiAoIHBhdGguaXNQYXRoKCBwcmVzZXJ2ZWRIYXNoICkgfHwgcHJlc2VydmVkSGFzaC5yZXBsYWNlKCIjIiwgIiIpLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAwKSB7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIjsKCQkJCQl9CgoJCQkJCS8vIEFwcGVuZCB0aGUgVUkgU3RhdGUga2V5cyB3aGVyZSBpdCBleGlzdHMgYW5kIGl0J3MgYmVlbiByZW1vdmVkCgkJCQkJLy8gZnJvbSB0aGUgdXJsCgkJCQkJaWYgKCB1aVN0YXRlICYmIHByZXNlcnZlZEhhc2guaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IC0xKSB7CgkJCQkJCXByZXNlcnZlZEhhc2ggKz0gdWlTdGF0ZTsKCQkJCQl9CgoJCQkJCS8vIG1ha2Ugc3VyZSB0aGF0IHBvdW5kIGlzIG9uIHRoZSBmcm9udCBvZiB0aGUgaGFzaAoJCQkJCWlmICggcHJlc2VydmVkSGFzaC5pbmRleE9mKCAiIyIgKSA9PT0gLTEgJiYgcHJlc2VydmVkSGFzaCAhPT0gIiIgKSB7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIyIgKyBwcmVzZXJ2ZWRIYXNoOwoJCQkJCX0KCgkJCQkJLy8gcmVjb25zdHJ1Y3QgZWFjaCBvZiB0aGUgcGllY2VzIHdpdGggdGhlIG5ldyBzZWFyY2ggc3RyaW5nIGFuZCBoYXNoCgkJCQkJaHJlZiA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCQlocmVmID0gaHJlZi5wcm90b2NvbCArIGhyZWYuZG91YmxlU2xhc2ggKyBocmVmLmhvc3QgKyBocmVmLnBhdGhuYW1lICsgc2VhcmNoICsKCQkJCQkJcHJlc2VydmVkSGFzaDsKCQkJCX0gZWxzZSB7CgkJCQkJaHJlZiArPSBocmVmLmluZGV4T2YoICIjIiApID4gLTEgPyB1aVN0YXRlIDogIiMiICsgdWlTdGF0ZTsKCQkJCX0KCgkJCQlyZXR1cm4gaHJlZjsKCQkJfSwKCgkJCWlzUHJlc2VydmFibGVIYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMDsKCQkJfSwKCgkJCS8vIEVzY2FwZSB3ZWlyZCBjaGFyYWN0ZXJzIGluIHRoZSBoYXNoIGlmIGl0IGlzIHRvIGJlIHVzZWQgYXMgYSBzZWxlY3RvcgoJCQloYXNoVG9TZWxlY3RvcjogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQl2YXIgaGFzSGFzaCA9ICggaGFzaC5zdWJzdHJpbmcoIDAsIDEgKSA9PT0gIiMiICk7CgkJCQlpZiAoIGhhc0hhc2ggKSB7CgkJCQkJaGFzaCA9IGhhc2guc3Vic3RyaW5nKCAxICk7CgkJCQl9CgkJCQlyZXR1cm4gKCBoYXNIYXNoID8gIiMiIDogIiIgKSArIGhhc2gucmVwbGFjZSggLyhbISIjJCUmJygpKissLi86Ozw9Pj9AW1xdXmB7fH1+XSkvZywgIlxcJDEiICk7CgkJCX0sCgoJCQkvLyByZXR1cm4gdGhlIHN1YnN0cmluZyBvZiBhIGZpbGVwYXRoIGJlZm9yZSB0aGUgc3ViLXBhZ2Uga2V5LCBmb3IgbWFraW5nCgkJCS8vIGEgc2VydmVyIHJlcXVlc3QKCQkJZ2V0RmlsZVBhdGg6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJdmFyIHNwbGl0a2V5ID0gIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleTsKCQkJCXJldHVybiBwYXRoICYmIHBhdGguc3BsaXQoIHNwbGl0a2V5IClbMF0uc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJfSwKCgkJCS8vIGNoZWNrIGlmIHRoZSBzcGVjaWZpZWQgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgbWFpbgoJCQkvLyBhcHBsaWNhdGlvbiBkb2N1bWVudC4KCQkJaXNGaXJzdFBhZ2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBXZSBvbmx5IGRlYWwgd2l0aCBhYnNvbHV0ZSBwYXRocy4KCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgdGhpcy5kb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudFVybC5ocmVmTm9IYXNoIHx8CgkJCQkJCSggdGhpcy5kb2N1bWVudEJhc2VEaWZmZXJzICYmCgkJCQkJCQl1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSwKCgkJCQkJLy8gR2V0IHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQkJZnAgPSAkLm1vYmlsZS5maXJzdFBhZ2UsCgoJCQkJCS8vIEdldCB0aGUgaWQgb2YgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudCBpZiBpdCBoYXMgb25lLgoJCQkJCWZwSWQgPSBmcCAmJiBmcFswXSA/IGZwWzBdLmlkIDogdW5kZWZpbmVkOwoKCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJLy8gaXQgZWl0aGVyIGhhcyBubyBoYXNoIHZhbHVlLCBvciB0aGUgaGFzaCBpcyBleGFjdGx5IGVxdWFsIHRvIHRoZSBpZAoJCQkJLy8gb2YgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCXJldHVybiBzYW1lUGF0aCAmJgoJCQkJCSggIXUuaGFzaCB8fAoJCQkJCQl1Lmhhc2ggPT09ICIjIiB8fAoJCQkJCQkoIGZwSWQgJiYgdS5oYXNoLnJlcGxhY2UoIC9eIy8sICIiICkgPT09IGZwSWQgKSApOwoJCQl9LAoKCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdwoJCQkvLyBjcm9zcy1kb21haW4gWEhSIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkCgkJCS8vIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0bwoJCQkvLyAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIKCQkJLy8gaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlIGFsbG93Q3Jvc3NEb21haW5QYWdlcwoJCQkvLyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcyByZXF1ZXN0cyB0byBnbwoJCQkvLyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCWlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0OiBmdW5jdGlvbiggZG9jVXJsLCByZXFVcmwgKSB7CgkJCQlyZXR1cm4gJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzICYmCgkJCQkJKGRvY1VybC5wcm90b2NvbCA9PT0gImZpbGU6IiB8fCBkb2NVcmwucHJvdG9jb2wgPT09ICJjb250ZW50OiIpICYmCgkJCQkJcmVxVXJsLnNlYXJjaCggL15odHRwcz86LyApICE9PSAtMTsKCQkJfQoJCX07CgoJCXBhdGguZG9jdW1lbnRVcmwgPSBwYXRoLnBhcnNlTG9jYXRpb24oKTsKCgkJJGJhc2UgPSAkKCAiaGVhZCIgKS5maW5kKCAiYmFzZSIgKTsKCgkJcGF0aC5kb2N1bWVudEJhc2UgPSAkYmFzZS5sZW5ndGggPwoJCQlwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGJhc2UuYXR0ciggImhyZWYiICksIHBhdGguZG9jdW1lbnRVcmwuaHJlZiApICkgOgoJCQlwYXRoLmRvY3VtZW50VXJsOwoKCQlwYXRoLmRvY3VtZW50QmFzZURpZmZlcnMgPSAocGF0aC5kb2N1bWVudFVybC5ocmVmTm9IYXNoICE9PSBwYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoKTsKCgkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkJcGF0aC5nZXREb2N1bWVudEJhc2UgPSBmdW5jdGlvbiggYXNQYXJzZWRPYmplY3QgKSB7CgkJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgcGF0aC5kb2N1bWVudEJhc2UgKSA6IHBhdGguZG9jdW1lbnRCYXNlLmhyZWY7CgkJfTsKCgkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSBpbiAxLjUuMAoJCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoKCQkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJCQlnZXREb2N1bWVudFVybDogcGF0aC5nZXREb2N1bWVudFVybCwKCgkJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJCQlnZXREb2N1bWVudEJhc2U6IHBhdGguZ2V0RG9jdW1lbnRCYXNlCgkJfSk7Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLm1vYmlsZS5IaXN0b3J5ID0gZnVuY3Rpb24oIHN0YWNrLCBpbmRleCApIHsKCQl0aGlzLnN0YWNrID0gc3RhY2sgfHwgW107CgkJdGhpcy5hY3RpdmVJbmRleCA9IGluZGV4IHx8IDA7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLkhpc3RvcnkucHJvdG90eXBlLCB7CgkJZ2V0QWN0aXZlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggXTsKCQl9LAoKCQlnZXRMYXN0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMucHJldmlvdXNJbmRleCBdOwoJCX0sCgoJCWdldE5leHQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5hY3RpdmVJbmRleCArIDEgXTsKCQl9LAoKCQlnZXRQcmV2OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggLSAxIF07CgkJfSwKCgkJLy8gYWRkTmV3IGlzIHVzZWQgd2hlbmV2ZXIgYSBuZXcgcGFnZSBpcyBhZGRlZAoJCWFkZDogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJZGF0YSA9IGRhdGEgfHwge307CgoJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCWlmICggdGhpcy5nZXROZXh0KCkgKSB7CgkJCQl0aGlzLmNsZWFyRm9yd2FyZCgpOwoJCQl9CgoJCQkvLyBpZiB0aGUgaGFzaCBpcyBpbmNsdWRlZCBpbiB0aGUgZGF0YSBtYWtlIHN1cmUgdGhlIHNoYXBlCgkJCS8vIGlzIGNvbnNpc3RlbnQgZm9yIGNvbXBhcmlzb24KCQkJaWYgKCBkYXRhLmhhc2ggJiYgZGF0YS5oYXNoLmluZGV4T2YoICIjIiApID09PSAtMSkgewoJCQkJZGF0YS5oYXNoID0gIiMiICsgZGF0YS5oYXNoOwoJCQl9CgoJCQlkYXRhLnVybCA9IHVybDsKCQkJdGhpcy5zdGFjay5wdXNoKCBkYXRhICk7CgkJCXRoaXMuYWN0aXZlSW5kZXggPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7CgkJfSwKCgkJLy93aXBlIHVybHMgYWhlYWQgb2YgYWN0aXZlIGluZGV4CgkJY2xlYXJGb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zdGFjayA9IHRoaXMuc3RhY2suc2xpY2UoIDAsIHRoaXMuYWN0aXZlSW5kZXggKyAxICk7CgkJfSwKCgkJZmluZDogZnVuY3Rpb24oIHVybCwgc3RhY2ssIGVhcmx5UmV0dXJuICkgewoJCQlzdGFjayA9IHN0YWNrIHx8IHRoaXMuc3RhY2s7CgoJCQl2YXIgZW50cnksIGksIGxlbmd0aCA9IHN0YWNrLmxlbmd0aCwgaW5kZXg7CgoJCQlmb3IgKCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJZW50cnkgPSBzdGFja1tpXTsKCgkJCQlpZiAoIGRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkudXJsKSB8fAoJCQkJCWRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkuaGFzaCkgKSB7CgkJCQkJaW5kZXggPSBpOwoKCQkJCQlpZiAoIGVhcmx5UmV0dXJuICkgewoJCQkJCQlyZXR1cm4gaW5kZXg7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gaW5kZXg7CgkJfSwKCgkJX2ZpbmRCeUlkOiBmdW5jdGlvbiggaWQgKSB7CgkJCXZhciBzdGFja0luZGV4LAoJCQkJc3RhY2tMZW5ndGggPSB0aGlzLnN0YWNrLmxlbmd0aDsKCgkJCWZvciAoIHN0YWNrSW5kZXggPSAwIDsgc3RhY2tJbmRleCA8IHN0YWNrTGVuZ3RoIDsgc3RhY2tJbmRleCsrICkgewoJCQkJaWYgKCB0aGlzLnN0YWNrWyBzdGFja0luZGV4IF0uaWQgPT09IGlkICkgewoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gKCBzdGFja0luZGV4IDwgc3RhY2tMZW5ndGggPyBzdGFja0luZGV4IDogdW5kZWZpbmVkICk7CgkJfSwKCgkJY2xvc2VzdDogZnVuY3Rpb24oIHVybCwgaWQgKSB7CgkJCXZhciBjbG9zZXN0ID0gKCBpZCA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogdGhpcy5fZmluZEJ5SWQoIGlkICkgKSwKCQkJCWEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gRmlyc3QsIHdlIGNoZWNrIHdoZXRoZXIgd2UndmUgZm91bmQgYW4gZW50cnkgYnkgaWQuIElmIHNvLCB3ZSdyZSBkb25lLgoJCQlpZiAoIGNsb3Nlc3QgIT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBjbG9zZXN0OwoJCQl9CgoJCQkvLyBGYWlsaW5nIHRoYXQgdGFrZSB0aGUgc2xpY2Ugb2YgdGhlIGhpc3Rvcnkgc3RhY2sgYmVmb3JlIHRoZSBjdXJyZW50IGluZGV4IGFuZCBzZWFyY2gKCQkJLy8gZm9yIGEgdXJsIG1hdGNoLiBJZiBvbmUgaXMgZm91bmQsIHdlJ2xsIGF2b2lkIGF2b2lkIGxvb2tpbmcgdGhyb3VnaCBmb3J3YXJkIGhpc3RvcnkKCQkJLy8gTk9URSB0aGUgcHJlZmVyZW5jZSBmb3IgYmFja3dhcmQgaGlzdG9yeSBtb3ZlbWVudCBpcyBkcml2ZW4gYnkgdGhlIGZhY3QgdGhhdAoJCQkvLyAgICAgIG1vc3QgbW9iaWxlIGJyb3dzZXJzIG9ubHkgaGF2ZSBhIGRlZGljYXRlZCBiYWNrIGJ1dHRvbiwgYW5kIHVzZXJzIHJhcmVseSB1c2UKCQkJLy8gICAgICB0aGUgZm9yd2FyZCBidXR0b24gaW4gZGVza3RvcCBicm93c2VyIGFueWhvdwoJCQljbG9zZXN0ID0gdGhpcy5maW5kKCB1cmwsIHRoaXMuc3RhY2suc2xpY2UoMCwgYSkgKTsKCgkJCS8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGluIGJhY2t3YXJkIGhpc3RvcnkgY2hlY2sgZm9yd2FyZC4gVGhlIGB0cnVlYAoJCQkvLyB2YWx1ZSBwYXNzZWQgYXMgdGhlIHRoaXJkIHBhcmFtZXRlciBjYXVzZXMgdGhlIGZpbmQgbWV0aG9kIHRvIGJyZWFrCgkJCS8vIG9uIHRoZSBmaXJzdCBtYXRjaCBpbiB0aGUgZm9yd2FyZCBoaXN0b3J5IHNsaWNlLiBUaGUgc3RhcnRpbmcgaW5kZXgKCQkJLy8gb2YgdGhlIHNsaWNlIG11c3QgdGhlbiBiZSBhZGRlZCB0byB0aGUgcmVzdWx0IHRvIGdldCB0aGUgZWxlbWVudCBpbmRleAoJCQkvLyBpbiB0aGUgb3JpZ2luYWwgaGlzdG9yeSBzdGFjayA6KCA6KAoJCQkvLwoJCQkvLyBUT0RPIHRoaXMgaXMgaHlwZXIgY29uZnVzaW5nIGFuZCBzaG91bGQgYmUgY2xlYW5lZCB1cCAodWdoIHNvIGJhZCkKCQkJaWYgKCBjbG9zZXN0ID09PSB1bmRlZmluZWQgKSB7CgkJCQljbG9zZXN0ID0gdGhpcy5maW5kKCB1cmwsIHRoaXMuc3RhY2suc2xpY2UoYSksIHRydWUgKTsKCQkJCWNsb3Nlc3QgPSBjbG9zZXN0ID09PSB1bmRlZmluZWQgPyBjbG9zZXN0IDogY2xvc2VzdCArIGE7CgkJCX0KCgkJCXJldHVybiBjbG9zZXN0OwoJCX0sCgoJCWRpcmVjdDogZnVuY3Rpb24oIG9wdHMgKSB7CgkJCXZhciBuZXdBY3RpdmVJbmRleCA9IHRoaXMuY2xvc2VzdCggb3B0cy51cmwsIG9wdHMuaWQgKSwgYSA9IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkvLyBzYXZlIG5ldyBwYWdlIGluZGV4LCBudWxsIGNoZWNrIHRvIHByZXZlbnQgZmFsc2V5IDAgcmVzdWx0CgkJCS8vIHJlY29yZCB0aGUgcHJldmlvdXMgaW5kZXggZm9yIHJlZmVyZW5jZQoJCQlpZiAoIG5ld0FjdGl2ZUluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXg7CgkJCQl0aGlzLnByZXZpb3VzSW5kZXggPSBhOwoJCQl9CgoJCQkvLyBpbnZva2UgY2FsbGJhY2tzIHdoZXJlIGFwcHJvcHJpYXRlCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBhbHNvIGNvbnZvbHV0ZWQgYW5kIGNvbmZ1c2luZwoJCQlpZiAoIG5ld0FjdGl2ZUluZGV4IDwgYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuYmFjayB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgImJhY2siICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID4gYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuZm9yd2FyZCB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgImZvcndhcmQiICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID09PSB1bmRlZmluZWQgJiYgb3B0cy5taXNzaW5nICkgewoJCQkJb3B0cy5taXNzaW5nKCB0aGlzLmdldEFjdGl2ZSgpICk7CgkJCX0KCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBwYXRoID0gJC5tb2JpbGUucGF0aCwKCQlpbml0aWFsSHJlZiA9IGxvY2F0aW9uLmhyZWY7CgoJJC5tb2JpbGUuTmF2aWdhdG9yID0gZnVuY3Rpb24oIGhpc3RvcnkgKSB7CgkJdGhpcy5oaXN0b3J5ID0gaGlzdG9yeTsKCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gdHJ1ZTsKCgkJJC5tb2JpbGUud2luZG93LmJpbmQoewoJCQkicG9wc3RhdGUuaGlzdG9yeSI6ICQucHJveHkoIHRoaXMucG9wc3RhdGUsIHRoaXMgKSwKCQkJImhhc2hjaGFuZ2UuaGlzdG9yeSI6ICQucHJveHkoIHRoaXMuaGFzaGNoYW5nZSwgdGhpcyApCgkJfSk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLk5hdmlnYXRvci5wcm90b3R5cGUsIHsKCQloaXN0b3J5RW50cnlJZDogMCwKCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCXZhciBzdGF0ZSwgaHJlZiwgaGFzaCA9IHBhdGguaXNQYXRoKHVybCkgPyBwYXRoLnN0cmlwSGFzaCh1cmwpIDogdXJsOwoKCQkJaHJlZiA9IHBhdGguc3F1YXNoKCB1cmwgKTsKCgkJCS8vIG1ha2Ugc3VyZSB0byBwcm92aWRlIHRoaXMgaW5mb3JtYXRpb24gd2hlbiBpdCBpc24ndCBleHBsaWNpdGx5IHNldCBpbiB0aGUKCQkJLy8gZGF0YSBvYmplY3QgdGhhdCB3YXMgcGFzc2VkIHRvIHRoZSBzcXVhc2ggbWV0aG9kCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJaWQ6ICsrdGhpcy5oaXN0b3J5RW50cnlJZCwKCQkJCWhhc2g6IGhhc2gsCgkJCQl1cmw6IGhyZWYKCQkJfSwgZGF0YSk7CgoJCQkvLyByZXBsYWNlIHRoZSBjdXJyZW50IHVybCB3aXRoIHRoZSBuZXcgaHJlZiBhbmQgc3RvcmUgdGhlIHN0YXRlCgkJCS8vIE5vdGUgdGhhdCBpbiBzb21lIGNhc2VzIHdlIG1pZ2h0IGJlIHJlcGxhY2luZyBhbiB1cmwgd2l0aCB0aGUKCQkJLy8gc2FtZSB1cmwuIFdlIGRvIHRoaXMgYW55d2F5cyBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQKCQkJLy8gYWxsIG9mIG91ciBoaXN0b3J5IGVudHJpZXMgaGF2ZSBhIHN0YXRlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGgKCQkJLy8gdGhlbS4gVGhpcyBhbGxvd3MgdXMgdG8gd29yayBhcm91bmQgdGhlIGNhc2Ugd2hlcmUgJC5tb2JpbGUuYmFjaygpCgkJCS8vIGlzIGNhbGxlZCB0byB0cmFuc2l0aW9uIGZyb20gYW4gZXh0ZXJuYWwgcGFnZSB0byBhbiBlbWJlZGRlZCBwYWdlLgoJCQkvLyBJbiB0aGF0IHBhcnRpY3VsYXIgY2FzZSwgYSBoYXNoY2hhbmdlIGV2ZW50IGlzICpOT1QqIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4KCQkJLy8gRW5zdXJpbmcgZWFjaCBoaXN0b3J5IGVudHJ5IGhhcyBhIHN0YXRlIG9iamVjdCBtZWFucyB0aGF0IG9uUG9wU3RhdGUoKQoJCQkvLyB3aWxsIGFsd2F5cyB0cmlnZ2VyIG91ciBoYXNoY2hhbmdlIGNhbGxiYWNrIGV2ZW4gd2hlbiBhIGhhc2hjaGFuZ2UgZXZlbnQKCQkJLy8gaXMgbm90IGZpcmVkLgoJCQl3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHN0YXRlLCBzdGF0ZS50aXRsZSB8fCBkb2N1bWVudC50aXRsZSwgaHJlZiApOwoKCQkJcmV0dXJuIHN0YXRlOwoJCX0sCgoJCWhhc2g6IGZ1bmN0aW9uKCB1cmwsIGhyZWYgKSB7CgkJCXZhciBwYXJzZWQsIGxvYywgaGFzaCwgcmVzb2x2ZWQ7CgoJCQkvLyBHcmFiIHRoZSBoYXNoIGZvciByZWNvcmRpbmcuIElmIHRoZSBwYXNzZWQgdXJsIGlzIGEgcGF0aAoJCQkvLyB3ZSB1c2VkIHRoZSBwYXJzZWQgdmVyc2lvbiBvZiB0aGUgc3F1YXNoZWQgdXJsIHRvIHJlY29uc3RydWN0LAoJCQkvLyBvdGhlcndpc2Ugd2UgYXNzdW1lIGl0J3MgYSBoYXNoIGFuZCBzdG9yZSBpdCBkaXJlY3RseQoJCQlwYXJzZWQgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCQkJbG9jID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCQlpZiAoIGxvYy5wYXRobmFtZSArIGxvYy5zZWFyY2ggPT09IHBhcnNlZC5wYXRobmFtZSArIHBhcnNlZC5zZWFyY2ggKSB7CgkJCQkvLyBJZiB0aGUgcGF0aG5hbWUgYW5kIHNlYXJjaCBvZiB0aGUgcGFzc2VkIHVybCBpcyBpZGVudGljYWwgdG8gdGhlIGN1cnJlbnQgbG9jCgkJCQkvLyB0aGVuIHdlIG11c3QgdXNlIHRoZSBoYXNoLiBPdGhlcndpc2UgdGhlcmUgd2lsbCBiZSBubyBldmVudAoJCQkJLy8gZWcsIHVybCA9ICIvZm9vL2Jhcj9iYXojYmFuZyIsIGxvY2F0aW9uLmhyZWYgPSAiaHR0cDovL2V4YW1wbGUuY29tL2Zvby9iYXI/YmF6IgoJCQkJaGFzaCA9IHBhcnNlZC5oYXNoID8gcGFyc2VkLmhhc2ggOiBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoOwoJCQl9IGVsc2UgaWYgKCBwYXRoLmlzUGF0aCh1cmwpICkgewoJCQkJcmVzb2x2ZWQgPSBwYXRoLnBhcnNlVXJsKCBocmVmICk7CgkJCQkvLyBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgsIG1ha2UgaXQgZG9tYWluIHJlbGF0aXZlIGFuZCByZW1vdmUgYW55IHRyYWlsaW5nIGhhc2gKCQkJCWhhc2ggPSByZXNvbHZlZC5wYXRobmFtZSArIHJlc29sdmVkLnNlYXJjaCArIChwYXRoLmlzUHJlc2VydmFibGVIYXNoKCByZXNvbHZlZC5oYXNoICk/IHJlc29sdmVkLmhhc2gucmVwbGFjZSggIiMiLCAiIiApIDogIiIpOwoJCQl9IGVsc2UgewoJCQkJaGFzaCA9IHVybDsKCQkJfQoKCQkJcmV0dXJuIGhhc2g7CgkJfSwKCgkJLy8gVE9ETyByZWNvbnNpZGVyIG5hbWUKCQlnbzogZnVuY3Rpb24oIHVybCwgZGF0YSwgbm9FdmVudHMgKSB7CgkJCXZhciBzdGF0ZSwgaHJlZiwgaGFzaCwgcG9wc3RhdGVFdmVudCwKCQkJCWlzUG9wU3RhdGVFdmVudCA9ICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKTsKCgkJCS8vIEdldCB0aGUgdXJsIGFzIGl0IHdvdWxkIGxvb2sgc3F1YXNoZWQgb24gdG8gdGhlIGN1cnJlbnQgcmVzb2x1dGlvbiB1cmwKCQkJaHJlZiA9IHBhdGguc3F1YXNoKCB1cmwgKTsKCgkJCS8vIHNvcnQgb3V0IHdoYXQgdGhlIGhhc2ggc291bGQgYmUgZnJvbSB0aGUgdXJsCgkJCWhhc2ggPSB0aGlzLmhhc2goIHVybCwgaHJlZiApOwoKCQkJLy8gSGVyZSB3ZSBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggY2hhbmdlIG9yIHBvcHN0YXRlIGV2ZW50IGZyb20gZG9pbmcgYW55CgkJCS8vIGhpc3RvcnkgbWFuYWdlbWVudC4gSW4gdGhlIGNhc2Ugb2YgaGFzaGNoYW5nZSB3ZSBkb24ndCBzd2FsbG93IGl0CgkJCS8vIGlmIHRoZXJlIHdpbGwgYmUgbm8gaGFzaGNoYW5nZSBmaXJlZCAoc2luY2UgdGhhdCB3b24ndCByZXNldCB0aGUgdmFsdWUpCgkJCS8vIGFuZCB3aWxsIHN3YWxsb3cgdGhlIGZvbGxvd2luZyBoYXNoY2hhbmdlCgkJCWlmICggbm9FdmVudHMgJiYgaGFzaCAhPT0gcGF0aC5zdHJpcEhhc2gocGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCkgKSB7CgkJCQl0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSA9IG5vRXZlbnRzOwoJCQl9CgoJCQkvLyBJTVBPUlRBTlQgaW4gdGhlIGNhc2Ugd2hlcmUgcG9wc3RhdGUgaXMgc3VwcG9ydGVkIHRoZSBldmVudCB3aWxsIGJlIHRyaWdnZXJlZAoJCQkvLyAgICAgIGRpcmVjdGx5LCBzdG9wcGluZyBmdXJ0aGVyIGV4ZWN1dGlvbiAtIGllLCBpbnRlcnVwdGluZyB0aGUgZmxvdyBvZiB0aGlzCgkJCS8vICAgICAgbWV0aG9kIGNhbGwgdG8gZmlyZSBiaW5kaW5ncyBhdCB0aGlzIGV4cHJlc3Npb24uIEJlbG93IHRoZSBuYXZpZ2F0ZSBtZXRob2QKCQkJLy8gICAgICB0aGVyZSBpcyBhIGJpbmRpbmcgdG8gY2F0Y2ggdGhpcyBldmVudCBhbmQgc3RvcCBpdHMgcHJvcGFnYXRpb24uCgkJCS8vCgkJCS8vICAgICAgV2UgdGhlbiB0cmlnZ2VyIGEgbmV3IHBvcHN0YXRlIGV2ZW50IG9uIHRoZSB3aW5kb3cgd2l0aCBhIG51bGwgc3RhdGUKCQkJLy8gICAgICBzbyB0aGF0IHRoZSBuYXZpZ2F0ZSBldmVudHMgY2FuIGNvbmNsdWRlIHRoZWlyIHdvcmsgcHJvcGVybHkKCQkJLy8KCQkJLy8gaWYgdGhlIHVybCBpcyBhIHBhdGggd2Ugd2FudCB0byBwcmVzZXJ2ZSB0aGUgcXVlcnkgcGFyYW1zIHRoYXQgYXJlIGF2YWlsYWJsZSBvbgoJCQkvLyB0aGUgY3VycmVudCB1cmwuCgkJCXRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSA9IHRydWU7CgkJCXdpbmRvdy5sb2NhdGlvbi5oYXNoID0gaGFzaDsKCgkJCS8vIElmIHBvcHN0YXRlIGlzIGVuYWJsZWQgYW5kIHRoZSBicm93c2VyIHRyaWdnZXJzIGBwb3BzdGF0ZWAgZXZlbnRzIHdoZW4gdGhlIGhhc2gKCQkJLy8gaXMgc2V0ICh0aGlzIG9mdGVuIGhhcHBlbnMgaW1tZWRpYXRlbHkgaW4gYnJvd3NlcnMgbGlrZSBDaHJvbWUpLCB0aGVuIHRoZQoJCQkvLyB0aGlzIGZsYWcgd2lsbCBiZSBzZXQgdG8gZmFsc2UgYWxyZWFkeS4gSWYgaXQncyBhIGJyb3dzZXIgdGhhdCBkb2VzIG5vdCB0cmlnZ2VyCgkJCS8vIGEgYHBvcHN0YXRlYCBvbiBoYXNoIGFzc2lnbmVtZW50IG9yIGByZXBsYWNlU3RhdGVgIHRoZW4gd2UgbmVlZCBhdm9pZCB0aGUgYnJhbmNoCgkJCS8vIHRoYXQgc3dhbGxvd3MgdGhlIGV2ZW50IGNyZWF0ZWQgYnkgdGhlIHBvcHN0YXRlIGdlbmVyYXRlZCBieSB0aGUgaGFzaCBhc3NpZ25tZW50CgkJCS8vIEF0IHRoZSB0aW1lIG9mIHRoaXMgd3JpdGluZyB0aGlzIGhhcHBlbnMgd2l0aCBPcGVyYSAxMiBhbmQgc29tZSB2ZXJzaW9uIG9mIElFCgkJCXRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSA9IGZhbHNlOwoKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQl1cmw6IGhyZWYsCgkJCQloYXNoOiBoYXNoLAoJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlCgkJCX0sIGRhdGEpOwoKCQkJaWYgKCBpc1BvcFN0YXRlRXZlbnQgKSB7CgkJCQlwb3BzdGF0ZUV2ZW50ID0gbmV3ICQuRXZlbnQoICJwb3BzdGF0ZSIgKTsKCQkJCXBvcHN0YXRlRXZlbnQub3JpZ2luYWxFdmVudCA9IHsKCQkJCQl0eXBlOiAicG9wc3RhdGUiLAoJCQkJCXN0YXRlOiBudWxsCgkJCQl9OwoKCQkJCXN0YXRlLmlkID0gKCB0aGlzLnNxdWFzaCggdXJsLCBzdGF0ZSApIHx8IHt9ICkuaWQ7CgoJCQkJLy8gVHJpZ2dlciBhIG5ldyBmYXV4IHBvcHN0YXRlIGV2ZW50IHRvIHJlcGxhY2UgdGhlIG9uZSB0aGF0IHdlCgkJCQkvLyBjYXVnaHQgdGhhdCB3YXMgdHJpZ2dlcmVkIGJ5IHRoZSBoYXNoIHNldHRpbmcgYWJvdmUuCgkJCQlpZiAoICFub0V2ZW50cyApIHsKCQkJCQl0aGlzLmlnbm9yZVBvcFN0YXRlID0gdHJ1ZTsKCQkJCQkkLm1vYmlsZS53aW5kb3cudHJpZ2dlciggcG9wc3RhdGVFdmVudCApOwoJCQkJfQoJCQl9CgoJCQkvLyByZWNvcmQgdGhlIGhpc3RvcnkgZW50cnkgc28gdGhhdCB0aGUgaW5mb3JtYXRpb24gY2FuIGJlIGluY2x1ZGVkCgkJCS8vIGluIGhhc2hjaGFuZ2UgZXZlbnQgZHJpdmVuIG5hdmlnYXRlIGV2ZW50cyBpbiBhIHNpbWlsYXIgZmFzaGlvbiB0bwoJCQkvLyB0aGUgc3RhdGUgdGhhdCdzIHByb3ZpZGVkIGJ5IHBvcHN0YXRlCgkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCQl9LAoKCQkvLyBUaGlzIGJpbmRpbmcgaXMgaW50ZW5kZWQgdG8gY2F0Y2ggdGhlIHBvcHN0YXRlIGV2ZW50cyB0aGF0IGFyZSBmaXJlZAoJCS8vIHdoZW4gZXhlY3V0aW9uIG9mIHRoZSBgJC5uYXZpZ2F0ZWAgbWV0aG9kIHN0b3BzIGF0IHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gdXJsOwoJCS8vIGFuZCBjb21wbGV0ZWx5IHByZXZlbnQgdGhlbSBmcm9tIHByb3BhZ2F0aW5nLiBUaGUgcG9wc3RhdGUgZXZlbnQgd2lsbCB0aGVuIGJlCgkJLy8gcmV0cmlnZ2VyZWQgYWZ0ZXIgZXhlY3V0aW9uIHJlc3VtZXMKCQkvLwoJCS8vIFRPRE8gZ3JhYiB0aGUgb3JpZ2luYWwgZXZlbnQgaGVyZSBhbmQgdXNlIGl0IGZvciB0aGUgc3ludGhldGljIGV2ZW50IGluIHRoZQoJCS8vICAgICAgc2Vjb25kIGhhbGYgb2YgdGhlIG5hdmlnYXRlIGV4ZWN1dGlvbiB0aGF0IHdpbGwgZm9sbG93IHRoaXMgYmluZGluZwoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoYXNoLCBzdGF0ZTsKCgkJCS8vIFBhcnRseSB0byBzdXBwb3J0IG91ciB0ZXN0IHN1aXRlIHdoaWNoIG1hbnVhbGx5IGFsdGVycyB0aGUgc3VwcG9ydAoJCQkvLyB2YWx1ZSB0byB0ZXN0IGhhc2hjaGFuZ2UuIFBhcnRseSB0byBwcmV2ZW50IGFsbCBhcm91bmQgd2VpcmRuZXNzCgkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgcG9wc3RhdGUgdHJpZ2dlcmVkIGJ5IHRoZSBhY3R1YWwgYWx0ZXJhdGlvbiBvZiB0aGUgaGFzaAoJCQkvLyBwcmV2ZW50IGl0IGNvbXBsZXRlbHkuIEhpc3RvcnkgaXMgdHJhY2tlZCBtYW51YWxseQoJCQlpZiAoIHRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSApIHsKCQkJCXRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSA9IGZhbHNlOwoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIGlmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBhZnRlciB0aGUgYHJlcGxhY2VTdGF0ZWAgY2FsbCBpbiB0aGUgZ28KCQkJLy8gbWV0aG9kLCB0aGVuIHNpbXBseSBpZ25vcmUgaXQuIFRoZSBoaXN0b3J5IGVudHJ5IGhhcyBhbHJlYWR5IGJlZW4gY2FwdHVyZWQKCQkJaWYgKCB0aGlzLmlnbm9yZVBvcFN0YXRlICkgewoJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IGZhbHNlOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiB0aGVyZSBpcyBubyBzdGF0ZSwgYW5kIHRoZSBoaXN0b3J5IHN0YWNrIGxlbmd0aCBpcyBvbmUgd2VyZQoJCQkvLyBwcm9iYWJseSBnZXR0aW5nIHRoZSBwYWdlIGxvYWQgcG9wc3RhdGUgZmlyZWQgYnkgYnJvd3NlcnMgbGlrZSBjaHJvbWUKCQkJLy8gYXZvaWQgaXQgYW5kIHNldCB0aGUgb25lIHRpbWUgZmxhZyB0byBmYWxzZS4KCQkJLy8gVE9ETzogRG8gd2UgcmVhbGx5IG5lZWQgYWxsIHRoZXNlIGNvbmRpdGlvbnM/IENvbXBhcmluZyBsb2NhdGlvbiBocmVmcwoJCQkvLyBzaG91bGQgYmUgc3VmZmljaWVudC4KCQkJaWYgKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJgoJCQkJdGhpcy5oaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMSAmJgoJCQkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSApIHsKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSBmYWxzZTsKCgkJCQlpZiAoIGxvY2F0aW9uLmhyZWYgPT09IGluaXRpYWxIcmVmICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBhY2NvdW50IGZvciBkaXJlY3QgbWFuaXB1bGF0aW9uIG9mIHRoZSBoYXNoLiBUaGF0IGlzLCB3ZSB3aWxsIHJlY2VpdmUgYSBwb3BzdGF0ZQoJCQkvLyB3aGVuIHRoZSBoYXNoIGlzIGNoYW5nZWQgYnkgYXNzaWdubWVudCwgYW5kIGl0IHdvbid0IGhhdmUgYSBzdGF0ZSBhc3NvY2lhdGVkLiBXZQoJCQkvLyB0aGVuIG5lZWQgdG8gc3F1YXNoIHRoZSBoYXNoLiBTZWUgYmVsb3cgZm9yIGhhbmRsaW5nIG9mIGhhc2ggYXNzaWdubWVudCB0aGF0CgkJCS8vIG1hdGNoZXMgYW4gZXhpc3RpbmcgaGlzdG9yeSBlbnRyeQoJCQkvLyBUT0RPIGl0IG1pZ2h0IGJlIGJldHRlciB0byBvbmx5IGFkZCB0byB0aGUgaGlzdG9yeSBzdGFjawoJCQkvLyAgICAgIHdoZW4gdGhlIGhhc2ggaXMgYWRqYWNlbnQgdG8gdGhlIGFjdGl2ZSBoaXN0b3J5IGVudHJ5CgkJCWhhc2ggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQlpZiAoICFldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlICYmIGhhc2ggKSB7CgkJCQkvLyBzcXVhc2ggdGhlIGhhc2ggdGhhdCdzIGJlZW4gYXNzaWduZWQgb24gdGhlIFVSTCB3aXRoIHJlcGxhY2VTdGF0ZQoJCQkJLy8gYWxzbyBncmFiIHRoZSByZXN1bHRpbmcgc3RhdGUgb2JqZWN0IGZvciBzdG9yYWdlCgkJCQlzdGF0ZSA9IHRoaXMuc3F1YXNoKCBoYXNoICk7CgoJCQkJLy8gcmVjb3JkIHRoZSBuZXcgaGFzaCBhcyBhbiBhZGRpdGlvbmFsIGhpc3RvcnkgZW50cnkKCQkJCS8vIHRvIG1hdGNoIHRoZSBicm93c2VyJ3MgdHJlYXRtZW50IG9mIGhhc2ggYXNzaWdubWVudAoJCQkJdGhpcy5oaXN0b3J5LmFkZCggc3RhdGUudXJsLCBzdGF0ZSApOwoKCQkJCS8vIHBhc3MgdGhlIG5ld2x5IGNyZWF0ZWQgc3RhdGUgaW5mb3JtYXRpb24KCQkJCS8vIGFsb25nIHdpdGggdGhlIGV2ZW50CgkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSBzdGF0ZTsKCgkJCQkvLyBkbyBub3QgYWx0ZXIgaGlzdG9yeSwgd2UndmUgYWRkZWQgYSBuZXcgaGlzdG9yeSBlbnRyeQoJCQkJLy8gc28gd2Uga25vdyB3aGVyZSB3ZSBhcmUKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgYWxsIGVsc2UgZmFpbHMgdGhpcyBpcyBhIHBvcHN0YXRlIHRoYXQgY29tZXMgZnJvbSB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbnMKCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgc3RhdGUgb2Ygb3VyIGhpc3Rvcnkgc3RhY2sgcHJvcGVybHksIGFuZCByZWNvcmQgdGhlIGRpcmVjdGlvbmFsaXR5CgkJCXRoaXMuaGlzdG9yeS5kaXJlY3QoewoJCQkJaWQ6ICggZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSB8fCB7fSApLmlkLAoJCQkJdXJsOiAoZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSB8fCB7fSkudXJsIHx8IGhhc2gsCgoJCQkJLy8gV2hlbiB0aGUgdXJsIGlzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIGhpc3RvcnkgaW5jbHVkZSB0aGUgZW50cnkKCQkJCS8vIGFzIGRhdGEgb24gdGhlIGV2ZW50IG9iamVjdCBmb3IgbWVyZ2luZyBhcyBkYXRhIGluIHRoZSBuYXZpZ2F0ZSBldmVudAoJCQkJcHJlc2VudDogZnVuY3Rpb24oIGhpc3RvcnlFbnRyeSwgZGlyZWN0aW9uICkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRvIHBhc3MgZG93biBhcyB0aGUgbmF2aWdhdGUgZXZlbnQgZGF0YQoJCQkJCWV2ZW50Lmhpc3RvcnlTdGF0ZSA9ICQuZXh0ZW5kKHt9LCBoaXN0b3J5RW50cnkpOwoJCQkJCWV2ZW50Lmhpc3RvcnlTdGF0ZS5kaXJlY3Rpb24gPSBkaXJlY3Rpb247CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIE5PVEUgbXVzdCBiaW5kIGJlZm9yZSBgbmF2aWdhdGVgIHNwZWNpYWwgZXZlbnQgaGFzaGNoYW5nZSBiaW5kaW5nIG90aGVyd2lzZSB0aGUKCQkvLyAgICAgIG5hdmlnYXRpb24gZGF0YSB3b24ndCBiZSBhdHRhY2hlZCB0byB0aGUgaGFzaGNoYW5nZSBldmVudCBpbiB0aW1lIGZvciB0aG9zZQoJCS8vICAgICAgYmluZGluZ3MgdG8gYXR0YWNoIGl0IHRvIHRoZSBgbmF2aWdhdGVgIHNwZWNpYWwgZXZlbnQKCQkvLyBUT0RPIGFkZCBhIGNoZWNrIGhlcmUgdGhhdCBgaGFzaGNoYW5nZS5uYXZpZ2F0ZWAgaXMgYm91bmQgYWxyZWFkeSBvdGhlcndpc2UgaXQncwoJCS8vICAgICAgYnJva2VuIChleGNlcHRpb24/KQoJCWhhc2hjaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGhpc3RvcnksIGhhc2g7CgoJCQkvLyBJZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBleHBsaWNpdGx5IGRpc2FibGVkIG9yIHB1c2hzdGF0ZSBpcyBzdXBwb3J0ZWQKCQkJLy8gYXZvaWQgbWFraW5nIHVzZSBvZiB0aGUgaGFzaGNoYW5nZSBoYW5kbGVyLgoJCQlpZiAoISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc0hhc2hDaGFuZ2VFbmFibGVkKCkgfHwKCQkJCSQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gT24gb2NjYXNpb24gZXhwbGljaXRseSB3YW50IHRvIHByZXZlbnQgdGhlIG5leHQgaGFzaCBmcm9tIHByb3BvZ2F0aW5nIGJlY2F1c2Ugd2Ugb25seQoJCQkvLyB3aXRoIHRvIGFsdGVyIHRoZSB1cmwgdG8gcmVwcmVzZW50IHRoZSBuZXcgc3RhdGUgZG8gc28gaGVyZQoJCQlpZiAoIHRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQloaXN0b3J5ID0gdGhpcy5oaXN0b3J5OwoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCgkJCS8vIElmIHRoaXMgaXMgYSBoYXNoY2hhbmdlIGNhdXNlZCBieSB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbgoJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSBzdGF0ZSBvZiBvdXIgaGlzdG9yeSBzdGFjayBwcm9wZXJseQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogaGFzaCwKCgkJCQkvLyBXaGVuIHRoZSB1cmwgaXMgZWl0aGVyIGZvcndhcmQgb3IgYmFja3dhcmQgaW4gaGlzdG9yeSBpbmNsdWRlIHRoZSBlbnRyeQoJCQkJLy8gYXMgZGF0YSBvbiB0aGUgZXZlbnQgb2JqZWN0IGZvciBtZXJnaW5nIGFzIGRhdGEgaW4gdGhlIG5hdmlnYXRlIGV2ZW50CgkJCQlwcmVzZW50OiBmdW5jdGlvbiggaGlzdG9yeUVudHJ5LCBkaXJlY3Rpb24gKSB7CgkJCQkJLy8gbWFrZSBzdXJlIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdG8gcGFzcyBkb3duIGFzIHRoZSBuYXZpZ2F0ZSBldmVudCBkYXRhCgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlID0gJC5leHRlbmQoe30sIGhpc3RvcnlFbnRyeSk7CgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjsKCQkJCX0sCgoJCQkJLy8gV2hlbiB3ZSBkb24ndCBmaW5kIGEgaGFzaCBpbiBvdXIgaGlzdG9yeSBjbGVhcmx5IHdlJ3JlIGFpbWluZyB0byBnbyB0aGVyZQoJCQkJLy8gcmVjb3JkIHRoZSBlbnRyeSBhcyBuZXcgZm9yIGZ1dHVyZSB0cmF2ZXJzYWwKCQkJCS8vCgkJCQkvLyBOT1RFIGl0J3Mgbm90IGVudGlyZWx5IGNsZWFyIHRoYXQgdGhpcyBpcyB0aGUgcmlnaHQgdGhpbmcgdG8gZG8gZ2l2ZW4gdGhhdCB3ZQoJCQkJLy8gICAgICBjYW4ndCBrbm93IHRoZSB1c2VycyBpbnRlbnRpb24uIEl0IG1pZ2h0IGJlIGJldHRlciB0byBleHBsaWNpdGx5IF9ub3RfCgkJCQkvLyAgICAgIHN1cHBvcnQgbG9jYXRpb24uaGFzaCBhc3NpZ25tZW50IGluIHByZWZlcmVuY2UgdG8gJC5uYXZpZ2F0ZSBjYWxscwoJCQkJLy8gVE9ETyBmaXJzdCBhcmcgdG8gYWRkIHNob3VsZCBiZSB0aGUgaHJlZiwgYnV0IGl0IGNhdXNlcyBpc3N1ZXMgaW4gaWRlbnRpZnlpbmcKCQkJCS8vICAgICAgZW1iZWRlZCBwYWdlcwoJCQkJbWlzc2luZzogZnVuY3Rpb24oKSB7CgkJCQkJaGlzdG9yeS5hZGQoIGhhc2gsIHsKCQkJCQkJaGFzaDogaGFzaCwKCQkJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJLy8gVE9ETyBjb25zaWRlciBxdWV1ZWluZyBuYXZpZ2F0aW9uIGFjdGl2aXR5IHVudGlsIHByZXZpb3VzIGFjdGl2aXRpZXMgaGF2ZSBjb21wbGV0ZWQKCS8vICAgICAgc28gdGhhdCBlbmQgdXNlcnMgZG9uJ3QgaGF2ZSB0byB0aGluayBhYm91dCBpdC4gUHVudGluZyBmb3Igbm93CgkvLyBUT0RPICEhIG1vdmUgdGhlIGV2ZW50IGJpbmRpbmdzIGludG8gY2FsbGJhY2tzIG9uIHRoZSBuYXZpZ2F0ZSBldmVudAoJJC5tb2JpbGUubmF2aWdhdGUgPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IuZ28oIHVybCwgZGF0YSwgbm9FdmVudHMgKTsKCX07CgoJLy8gZXhwb3NlIHRoZSBoaXN0b3J5IG9uIHRoZSBuYXZpZ2F0ZSBtZXRob2QgaW4gYW50aWNpcGF0aW9uIG9mIGZ1bGwgaW50ZWdyYXRpb24gd2l0aAoJLy8gZXhpc3RpbmcgbmF2aWdhdGlvbiBmdW5jdGlvbmFsdHkgdGhhdCBpcyB0aWdodGx5IGNvdXBsZWQgdG8gdGhlIGhpc3RvcnkgaW5mb3JtYXRpb24KCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkgPSBuZXcgJC5tb2JpbGUuSGlzdG9yeSgpOwoKCS8vIGluc3RhbnRpYXRlIGFuIGluc3RhbmNlIG9mIHRoZSBuYXZpZ2F0b3IgZm9yIHVzZSB3aXRoaW4gdGhlICQubmF2aWdhdGUgbWV0aG9kCgkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IgPSBuZXcgJC5tb2JpbGUuTmF2aWdhdG9yKCAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ICk7CgoJdmFyIGxvYyA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpOwoJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIGxvYy5ocmVmLCB7aGFzaDogbG9jLmhhc2h9ICk7Cn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBwcm9wcyA9IHsKCQkJImFuaW1hdGlvbiI6IHt9LAoJCQkidHJhbnNpdGlvbiI6IHt9CgkJfSwKCQl0ZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApLAoJCXZlbmRvclByZWZpeGVzID0gWyAiIiwgIndlYmtpdC0iLCAibW96LSIsICJvLSIgXTsKCgkkLmVhY2goIFsgImFuaW1hdGlvbiIsICJ0cmFuc2l0aW9uIiBdLCBmdW5jdGlvbiggaSwgdGVzdCApIHsKCgkJLy8gR2V0IGNvcnJlY3QgbmFtZSBmb3IgdGVzdAoJCXZhciB0ZXN0TmFtZSA9ICggaSA9PT0gMCApID8gdGVzdCArICItIiArICJuYW1lIiA6IHRlc3Q7CgoJCSQuZWFjaCggdmVuZG9yUHJlZml4ZXMsIGZ1bmN0aW9uKCBqLCBwcmVmaXggKSB7CgkJCWlmICggdGVzdEVsZW1lbnQuc3R5bGVbICQuY2FtZWxDYXNlKCBwcmVmaXggKyB0ZXN0TmFtZSApIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCSBwcm9wc1sgdGVzdCBdWyAicHJlZml4IiBdID0gcHJlZml4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7CgoJCS8vIFNldCBldmVudCBhbmQgZHVyYXRpb24gbmFtZXMgZm9yIGxhdGVyIHVzZQoJCXByb3BzWyB0ZXN0IF1bICJkdXJhdGlvbiIgXSA9CgkJCSQuY2FtZWxDYXNlKCBwcm9wc1sgdGVzdCBdWyAicHJlZml4IiBdICsgdGVzdCArICItIiArICJkdXJhdGlvbiIgKTsKCQlwcm9wc1sgdGVzdCBdWyAiZXZlbnQiIF0gPQoJCQkkLmNhbWVsQ2FzZSggcHJvcHNbIHRlc3QgXVsgInByZWZpeCIgXSArIHRlc3QgKyAiLSIgKyAiZW5kIiApOwoKCQkvLyBBbGwgbG93ZXIgY2FzZSBpZiBub3QgYSB2ZW5kb3IgcHJvcAoJCWlmICggcHJvcHNbIHRlc3QgXVsgInByZWZpeCIgXSA9PT0gIiIgKSB7CgkJCXByb3BzWyB0ZXN0IF1bICJldmVudCIgXSA9IHByb3BzWyB0ZXN0IF1bICJldmVudCIgXS50b0xvd2VyQ2FzZSgpOwoJCX0KCX0pOwoKCS8vIElmIGEgdmFsaWQgcHJlZml4IHdhcyBmb3VuZCB0aGVuIHRoZSBpdCBpcyBzdXBwb3J0ZWQgYnkgdGhlIGJyb3dzZXIKCSQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyA9ICggcHJvcHNbICJ0cmFuc2l0aW9uIiBdWyAicHJlZml4IiBdICE9PSB1bmRlZmluZWQgKTsKCSQuc3VwcG9ydC5jc3NBbmltYXRpb25zID0gKCBwcm9wc1sgImFuaW1hdGlvbiIgXVsgInByZWZpeCIgXSAhPT0gdW5kZWZpbmVkICk7CgoJLy8gUmVtb3ZlIHRoZSB0ZXN0RWxlbWVudAoJJCggdGVzdEVsZW1lbnQgKS5yZW1vdmUoKTsKCgkvLyBBbmltYXRpb24gY29tcGxldGUgY2FsbGJhY2sKCSQuZm4uYW5pbWF0aW9uQ29tcGxldGUgPSBmdW5jdGlvbiggY2FsbGJhY2ssIHR5cGUsIGZhbGxiYWNrVGltZSApIHsKCQl2YXIgdGltZXIsIGR1cmF0aW9uLAoJCQl0aGF0ID0gdGhpcywKCQkJZXZlbnRCaW5kaW5nID0gZnVuY3Rpb24oKSB7CgoJCQkJLy8gQ2xlYXIgdGhlIHRpbWVyIHNvIHdlIGRvbid0IGNhbGwgY2FsbGJhY2sgdHdpY2UKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCWNhbGxiYWNrLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfSwKCQkJYW5pbWF0aW9uVHlwZSA9ICggIXR5cGUgfHwgdHlwZSA9PT0gImFuaW1hdGlvbiIgKSA/ICJhbmltYXRpb24iIDogInRyYW5zaXRpb24iOwoKCQkvLyBNYWtlIHN1cmUgc2VsZWN0ZWQgdHlwZSBpcyBzdXBwb3J0ZWQgYnkgYnJvd3NlcgoJCWlmICggKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgJiYgYW5pbWF0aW9uVHlwZSA9PT0gInRyYW5zaXRpb24iICkgfHwKCQkJKCAkLnN1cHBvcnQuY3NzQW5pbWF0aW9ucyAmJiBhbmltYXRpb25UeXBlID09PSAiYW5pbWF0aW9uIiApICkgewoKCQkJLy8gSWYgYSBmYWxsYmFjayB0aW1lIHdhcyBub3QgcGFzc2VkIHNldCBvbmUKCQkJaWYgKCBmYWxsYmFja1RpbWUgPT09IHVuZGVmaW5lZCApIHsKCgkJCQkvLyBNYWtlIHN1cmUgdGhlIHdhcyBub3QgYm91bmQgdG8gZG9jdW1lbnQgYmVmb3JlIGNoZWNraW5nIC5jc3MKCQkJCWlmICggJCggdGhpcyApLmNvbnRleHQgIT09IGRvY3VtZW50ICkgewoKCQkJCQkvLyBQYXJzZSB0aGUgZHVycmF0aW9uIHNpbmNlIGl0cyBpbiBzZWNvbmQgbXVsdGlwbGUgYnkgMTAwMCBmb3IgbWlsbGlzZWNvbmRzCgkJCQkJLy8gTXVsdGlwbHkgYnkgMyB0byBtYWtlIHN1cmUgd2UgZ2l2ZSB0aGUgYW5pbWF0aW9uIHBsZW50eSBvZiB0aW1lLgoJCQkJCWR1cmF0aW9uID0gcGFyc2VGbG9hdCgKCQkJCQkJJCggdGhpcyApLmNzcyggcHJvcHNbIGFuaW1hdGlvblR5cGUgXS5kdXJhdGlvbiApCgkJCQkJKSAqIDMwMDA7CgkJCQl9CgoJCQkJLy8gSWYgd2UgY291bGQgbm90IHJlYWQgYSBkdXJhdGlvbiB1c2UgdGhlIGRlZmF1bHQKCQkJCWlmICggZHVyYXRpb24gPT09IDAgfHwgZHVyYXRpb24gPT09IHVuZGVmaW5lZCB8fCBpc05hTiggZHVyYXRpb24gKSApIHsKCQkJCQlkdXJhdGlvbiA9ICQuZm4uYW5pbWF0aW9uQ29tcGxldGUuZGVmYXVsdER1cmF0aW9uOwoJCQkJfQoJCQl9CgoJCQkvLyBTZXRzIHVwIHRoZSBmYWxsYmFjayBpZiBldmVudCBuZXZlciBjb21lcwoJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJJCggdGhhdCApLm9mZiggcHJvcHNbIGFuaW1hdGlvblR5cGUgXS5ldmVudCwgZXZlbnRCaW5kaW5nICk7CgkJCQljYWxsYmFjay5hcHBseSggdGhhdCApOwoJCQl9LCBkdXJhdGlvbiApOwoKCQkJLy8gQmluZCB0aGUgZXZlbnQKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoIHByb3BzWyBhbmltYXRpb25UeXBlIF0uZXZlbnQsIGV2ZW50QmluZGluZyApOwoJCX0gZWxzZSB7CgoJCQkvLyBDU1MgYW5pbWF0aW9uIC8gdHJhbnNpdGlvbnMgbm90IHN1cHBvcnRlZAoJCQkvLyBEZWZlciBleGVjdXRpb24gZm9yIGNvbnNpc3RlbmN5IGJldHdlZW4gd2Via2l0L25vbiB3ZWJraXQKCQkJc2V0VGltZW91dCggJC5wcm94eSggY2FsbGJhY2ssIHRoaXMgKSwgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy8gQWxsb3cgZGVmYXVsdCBjYWxsYmFjayB0byBiZSBjb25maWd1cmVkIG9uIG1vYmlsZUluaXQKCSQuZm4uYW5pbWF0aW9uQ29tcGxldGUuZGVmYXVsdER1cmF0aW9uID0gMTAwMDsKfSkoIGpRdWVyeSApOwoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCW1vdXNlSG9va1Byb3BzID0gJC5ldmVudC5tb3VzZUhvb2tzID8gJC5ldmVudC5tb3VzZUhvb2tzLnByb3BzIDogW10sCgltb3VzZUV2ZW50UHJvcHMgPSAkLmV2ZW50LnByb3BzLmNvbmNhdCggbW91c2VIb29rUHJvcHMgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMCwgdGhyZXNob2xkLAoJaTsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgaiwgbGVuOwoKCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgoJb2UgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJcHJvcHMgPSAkLmV2ZW50LnByb3BzOwoKCS8vIGFkZHJlc3NlcyBzZXBhcmF0aW9uIG9mICQuZXZlbnQucHJvcHMgaW4gdG8gJC5ldmVudC5tb3VzZUhvb2sucHJvcHMgYW5kIElzc3VlIDMyODAKCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzI4MAoJaWYgKCB0LnNlYXJjaCggL14obW91c2V8Y2xpY2spLyApID4gLTEgKSB7CgkJcHJvcHMgPSBtb3VzZUV2ZW50UHJvcHM7Cgl9CgoJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCglpZiAoIG9lICkgewoJCWZvciAoIGkgPSBwcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gcHJvcHNbIC0taSBdOwoJCQlldmVudFsgcHJvcCBdID0gb2VbIHByb3AgXTsKCQl9Cgl9CgoJLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIG1vdXNlIGFuZCBjbGljayB2aXJ0dWFsIGV2ZW50cyBhcmUgZ2VuZXJhdGVkCgkvLyB3aXRob3V0IGEgLndoaWNoIG9uZSBpcyBkZWZpbmVkCglpZiAoIHQuc2VhcmNoKC9tb3VzZShkb3dufHVwKXxjbGljay8pID4gLTEgJiYgIWV2ZW50LndoaWNoICkgewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoIGN0ICYmIGN0Lmxlbmd0aCApID8gY3RbIDAgXSA6IHVuZGVmaW5lZCApOwoKCQlpZiAoIHRvdWNoICkgewoJCQlmb3IgKCBqID0gMCwgbGVuID0gdG91Y2hFdmVudFByb3BzLmxlbmd0aDsgaiA8IGxlbjsgaisrKSB7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQlyZXNldFRpbWVySUQgPSAwOwoJCWVuYWJsZU1vdXNlQmluZGluZ3MoKTsKCX0sICQudm1vdXNlLnJlc2V0VGltZXJEdXJhdGlvbiApOwp9CgpmdW5jdGlvbiBjbGVhclJlc2V0VGltZXIoKSB7CglpZiAoIHJlc2V0VGltZXJJRCApIHsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICksCgkJdmU7CgoJaWYgKCAhYmxvY2tNb3VzZVRyaWdnZXJzICYmICggIWxhc3RUb3VjaElEIHx8IGxhc3RUb3VjaElEICE9PSB0b3VjaElEICkgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidiIgKyBldmVudC50eXBlLCBldmVudCApOwoJCWlmICggdmUgKSB7CgkJCWlmICggdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCWlmICggdmUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJCWlmICggdmUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KCBldmVudCApIHsKCgl2YXIgdG91Y2hlcyA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXMsCgkJdGFyZ2V0LCBmbGFncywgdDsKCglpZiAoIHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPT09IDEgKSB7CgoJCXRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIHRhcmdldCApOwoKCQlpZiAoIGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nICkgewoKCQkJbGFzdFRvdWNoSUQgPSBuZXh0VG91Y2hJRCsrOwoJCQkkLmRhdGEoIHRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUsIGxhc3RUb3VjaElEICk7CgoJCQljbGVhclJlc2V0VGltZXIoKTsKCgkJCWRpc2FibGVNb3VzZUJpbmRpbmdzKCk7CgkJCWRpZFNjcm9sbCA9IGZhbHNlOwoKCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXTsKCQkJc3RhcnRYID0gdC5wYWdlWDsKCQkJc3RhcnRZID0gdC5wYWdlWTsKCgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdmVyIiwgZXZlbnQsIGZsYWdzICk7CgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vkb3duIiwgZXZlbnQsIGZsYWdzICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVTY3JvbGwoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApICk7Cgl9CgoJZGlkU2Nyb2xsID0gdHJ1ZTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdLAoJCWRpZENhbmNlbCA9IGRpZFNjcm9sbCwKCQltb3ZlVGhyZXNob2xkID0gJC52bW91c2UubW92ZURpc3RhbmNlVGhyZXNob2xkLAoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICk7CgoJCWRpZFNjcm9sbCA9IGRpZFNjcm9sbCB8fAoJCQkoIE1hdGguYWJzKCB0LnBhZ2VYIC0gc3RhcnRYICkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyggdC5wYWdlWSAtIHN0YXJ0WSApID4gbW92ZVRocmVzaG9sZCApOwoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdmUsIHQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbigvKiBkYXRhLCBuYW1lc3BhY2UgKi8pIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKC8qIGRhdGEsIG5hbWVzcGFjZSAqLykgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGhlc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciAkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJCXN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCgkvLyBzZXR1cCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCwgYnViYmxlICkgewoJCXZhciBvcmlnaW5hbFR5cGUgPSBldmVudC50eXBlOwoJCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgkJaWYgKCBidWJibGUgKSB7CgkJCSQuZXZlbnQudHJpZ2dlciggZXZlbnQsIHVuZGVmaW5lZCwgb2JqICk7CgkJfSBlbHNlIHsKCQkJJC5ldmVudC5kaXNwYXRjaC5jYWxsKCBvYmosIGV2ZW50ICk7CgkJfQoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCXNjcm9sbGluZywKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJCX0KCgkJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCQl9LCA1MCApOwoJCQl9KTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLnVuYmluZCggc2Nyb2xsRXZlbnQgKTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyB0YXBob2xkCgkkLmV2ZW50LnNwZWNpYWwudGFwID0gewoJCXRhcGhvbGRUaHJlc2hvbGQ6IDc1MCwKCQllbWl0VGFwT25UYXBob2xkOiB0cnVlLAoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlpc1RhcGhvbGQgPSBmYWxzZTsKCgkJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaXNUYXBob2xkID0gZmFsc2U7CgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCAhaXNUYXBob2xkICYmIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9IGVsc2UgaWYgKCBpc1RhcGhvbGQgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKQoJCQkJCS5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICk7CgkJCQkkZG9jdW1lbnQuYmluZCggInZtb3VzZWNhbmNlbCIsIGNsZWFyVGFwSGFuZGxlcnMgKTsKCgkJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC50YXAuZW1pdFRhcE9uVGFwaG9sZCApIHsKCQkJCQkJaXNUYXBob2xkID0gdHJ1ZTsKCQkJCQl9CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwaG9sZCIsICQuRXZlbnQoICJ0YXBob2xkIiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQgfSApICk7CgkJCQl9LCAkLmV2ZW50LnNwZWNpYWwudGFwLnRhcGhvbGRUaHJlc2hvbGQgKTsKCQkJfSk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS51bmJpbmQoICJ2bW91c2Vkb3duIiApLnVuYmluZCggInZjbGljayIgKS51bmJpbmQoICJ2bW91c2V1cCIgKTsKCQkJJGRvY3VtZW50LnVuYmluZCggInZtb3VzZWNhbmNlbCIgKTsKCQl9Cgl9OwoKCS8vIEFsc28gaGFuZGxlcyBzd2lwZWxlZnQsIHN3aXBlcmlnaHQKCSQuZXZlbnQuc3BlY2lhbC5zd2lwZSA9IHsKCgkJLy8gTW9yZSB0aGFuIHRoaXMgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQsIGFuZCB3ZSB3aWxsIHN1cHByZXNzIHNjcm9sbGluZy4KCQlzY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkOiAzMCwKCgkJLy8gTW9yZSB0aW1lIHRoYW4gdGhpcywgYW5kIGl0IGlzbid0IGEgc3dpcGUuCgkJZHVyYXRpb25UaHJlc2hvbGQ6IDEwMDAsCgoJCS8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwKCgkJLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgkJdmVydGljYWxEaXN0YW5jZVRocmVzaG9sZDogMzAsCgoJCWdldExvY2F0aW9uOiBmdW5jdGlvbiAoIGV2ZW50ICkgewoJCQl2YXIgd2luUGFnZVggPSB3aW5kb3cucGFnZVhPZmZzZXQsCgkJCQl3aW5QYWdlWSA9IHdpbmRvdy5wYWdlWU9mZnNldCwKCQkJCXggPSBldmVudC5jbGllbnRYLAoJCQkJeSA9IGV2ZW50LmNsaWVudFk7CgoJCQlpZiAoIGV2ZW50LnBhZ2VZID09PSAwICYmIE1hdGguZmxvb3IoIHkgKSA+IE1hdGguZmxvb3IoIGV2ZW50LnBhZ2VZICkgfHwKCQkJCWV2ZW50LnBhZ2VYID09PSAwICYmIE1hdGguZmxvb3IoIHggKSA+IE1hdGguZmxvb3IoIGV2ZW50LnBhZ2VYICkgKSB7CgoJCQkJLy8gaU9TNCBjbGllbnRYL2NsaWVudFkgaGF2ZSB0aGUgdmFsdWUgdGhhdCBzaG91bGQgaGF2ZSBiZWVuCgkJCQkvLyBpbiBwYWdlWC9wYWdlWS4gV2hpbGUgcGFnZVgvcGFnZS8gaGF2ZSB0aGUgdmFsdWUgMAoJCQkJeCA9IHggLSB3aW5QYWdlWDsKCQkJCXkgPSB5IC0gd2luUGFnZVk7CgkJCX0gZWxzZSBpZiAoIHkgPCAoIGV2ZW50LnBhZ2VZIC0gd2luUGFnZVkpIHx8IHggPCAoIGV2ZW50LnBhZ2VYIC0gd2luUGFnZVggKSApIHsKCgkJCQkvLyBTb21lIEFuZHJvaWQgYnJvd3NlcnMgaGF2ZSB0b3RhbGx5IGJvZ3VzIHZhbHVlcyBmb3IgY2xpZW50WC9ZCgkJCQkvLyB3aGVuIHNjcm9sbGluZy96b29taW5nIGEgcGFnZS4gRGV0ZWN0YWJsZSBzaW5jZSBjbGllbnRYL2NsaWVudFkKCQkJCS8vIHNob3VsZCBuZXZlciBiZSBzbWFsbGVyIHRoYW4gcGFnZVgvcGFnZVkgbWludXMgcGFnZSBzY3JvbGwKCQkJCXggPSBldmVudC5wYWdlWCAtIHdpblBhZ2VYOwoJCQkJeSA9IGV2ZW50LnBhZ2VZIC0gd2luUGFnZVk7CgkJCX0KCgkJCXJldHVybiB7CgkJCQl4OiB4LAoJCQkJeTogeQoJCQl9OwoJCX0sCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50LAoJCQkJbG9jYXRpb24gPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZ2V0TG9jYXRpb24oIGRhdGEgKTsKCQkJcmV0dXJuIHsKCQkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCQljb29yZHM6IFsgbG9jYXRpb24ueCwgbG9jYXRpb24ueSBdLAoJCQkJCQlvcmlnaW46ICQoIGV2ZW50LnRhcmdldCApCgkJCQkJfTsKCQl9LAoKCQlzdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50LAoJCQkJbG9jYXRpb24gPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZ2V0TG9jYXRpb24oIGRhdGEgKTsKCQkJcmV0dXJuIHsKCQkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCQljb29yZHM6IFsgbG9jYXRpb24ueCwgbG9jYXRpb24ueSBdCgkJCQkJfTsKCQl9LAoKCQloYW5kbGVTd2lwZTogZnVuY3Rpb24oIHN0YXJ0LCBzdG9wLCB0aGlzT2JqZWN0LCBvcmlnVGFyZ2V0ICkgewoJCQlpZiAoIHN0b3AudGltZSAtIHN0YXJ0LnRpbWUgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZHVyYXRpb25UaHJlc2hvbGQgJiYKCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQgJiYKCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDEgXSAtIHN0b3AuY29vcmRzWyAxIF0gKSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS52ZXJ0aWNhbERpc3RhbmNlVGhyZXNob2xkICkgewoJCQkJdmFyIGRpcmVjdGlvbiA9IHN0YXJ0LmNvb3Jkc1swXSA+IHN0b3AuY29vcmRzWyAwIF0gPyAic3dpcGVsZWZ0IiA6ICJzd2lwZXJpZ2h0IjsKCgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJzd2lwZSIsICQuRXZlbnQoICJzd2lwZSIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0LCBzd2lwZXN0YXJ0OiBzdGFydCwgc3dpcGVzdG9wOiBzdG9wIH0pLCB0cnVlICk7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIGRpcmVjdGlvbiwkLkV2ZW50KCBkaXJlY3Rpb24sIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0LCBzd2lwZXN0YXJ0OiBzdGFydCwgc3dpcGVzdG9wOiBzdG9wIH0gKSwgdHJ1ZSApOwoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoKCQl9LAoKCQkvLyBUaGlzIHNlcnZlcyBhcyBhIGZsYWcgdG8gZW5zdXJlIHRoYXQgYXQgbW9zdCBvbmUgc3dpcGUgZXZlbnQgZXZlbnQgaXMKCQkvLyBpbiB3b3JrIGF0IGFueSBnaXZlbiB0aW1lCgkJZXZlbnRJblByb2dyZXNzOiBmYWxzZSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgZXZlbnRzLAoJCQkJdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCWNvbnRleHQgPSB7fTsKCgkJCS8vIFJldHJpZXZlIHRoZSBldmVudHMgZGF0YSBmb3IgdGhpcyBlbGVtZW50IGFuZCBhZGQgdGhlIHN3aXBlIGNvbnRleHQKCQkJZXZlbnRzID0gJC5kYXRhKCB0aGlzLCAibW9iaWxlLWV2ZW50cyIgKTsKCQkJaWYgKCAhZXZlbnRzICkgewoJCQkJZXZlbnRzID0geyBsZW5ndGg6IDAgfTsKCQkJCSQuZGF0YSggdGhpcywgIm1vYmlsZS1ldmVudHMiLCBldmVudHMgKTsKCQkJfQoJCQlldmVudHMubGVuZ3RoKys7CgkJCWV2ZW50cy5zd2lwZSA9IGNvbnRleHQ7CgoJCQljb250ZXh0LnN0YXJ0ID0gZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCS8vIEJhaWwgaWYgd2UncmUgYWxyZWFkeSB3b3JraW5nIG9uIGEgc3dpcGUgZXZlbnQKCQkJCWlmICggJC5ldmVudC5zcGVjaWFsLnN3aXBlLmV2ZW50SW5Qcm9ncmVzcyApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZXZlbnRJblByb2dyZXNzID0gdHJ1ZTsKCgkJCQl2YXIgc3RvcCwKCQkJCQlzdGFydCA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zdGFydCggZXZlbnQgKSwKCQkJCQlvcmlnVGFyZ2V0ID0gZXZlbnQudGFyZ2V0LAoJCQkJCWVtaXR0ZWQgPSBmYWxzZTsKCgkJCQljb250ZXh0Lm1vdmUgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCAhc3RhcnQgfHwgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCXN0b3AgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RvcCggZXZlbnQgKTsKCQkJCQlpZiAoICFlbWl0dGVkICkgewoJCQkJCQllbWl0dGVkID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhhbmRsZVN3aXBlKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApOwoJCQkJCQlpZiAoIGVtaXR0ZWQgKSB7CgoJCQkJCQkJLy8gUmVzZXQgdGhlIGNvbnRleHQgdG8gbWFrZSB3YXkgZm9yIHRoZSBuZXh0IHN3aXBlIGV2ZW50CgkJCQkJCQkkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZXZlbnRJblByb2dyZXNzID0gZmFsc2U7CgkJCQkJCX0KCQkJCQl9CgkJCQkJLy8gcHJldmVudCBzY3JvbGxpbmcKCQkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0KCQkJCX07CgoJCQkJY29udGV4dC5zdG9wID0gZnVuY3Rpb24oKSB7CgkJCQkJCWVtaXR0ZWQgPSB0cnVlOwoKCQkJCQkJLy8gUmVzZXQgdGhlIGNvbnRleHQgdG8gbWFrZSB3YXkgZm9yIHRoZSBuZXh0IHN3aXBlIGV2ZW50CgkJCQkJCSQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ldmVudEluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJCQkJJGRvY3VtZW50Lm9mZiggdG91Y2hNb3ZlRXZlbnQsIGNvbnRleHQubW92ZSApOwoJCQkJCQljb250ZXh0Lm1vdmUgPSBudWxsOwoJCQkJfTsKCgkJCQkkZG9jdW1lbnQub24oIHRvdWNoTW92ZUV2ZW50LCBjb250ZXh0Lm1vdmUgKQoJCQkJCS5vbmUoIHRvdWNoU3RvcEV2ZW50LCBjb250ZXh0LnN0b3AgKTsKCQkJfTsKCQkJJHRoaXMub24oIHRvdWNoU3RhcnRFdmVudCwgY29udGV4dC5zdGFydCApOwoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJdmFyIGV2ZW50cywgY29udGV4dDsKCgkJCWV2ZW50cyA9ICQuZGF0YSggdGhpcywgIm1vYmlsZS1ldmVudHMiICk7CgkJCWlmICggZXZlbnRzICkgewoJCQkJY29udGV4dCA9IGV2ZW50cy5zd2lwZTsKCQkJCWRlbGV0ZSBldmVudHMuc3dpcGU7CgkJCQlldmVudHMubGVuZ3RoLS07CgkJCQlpZiAoIGV2ZW50cy5sZW5ndGggPT09IDAgKSB7CgkJCQkJJC5yZW1vdmVEYXRhKCB0aGlzLCAibW9iaWxlLWV2ZW50cyIgKTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBjb250ZXh0ICkgewoJCQkJaWYgKCBjb250ZXh0LnN0YXJ0ICkgewoJCQkJCSQoIHRoaXMgKS5vZmYoIHRvdWNoU3RhcnRFdmVudCwgY29udGV4dC5zdGFydCApOwoJCQkJfQoJCQkJaWYgKCBjb250ZXh0Lm1vdmUgKSB7CgkJCQkJJGRvY3VtZW50Lm9mZiggdG91Y2hNb3ZlRXZlbnQsIGNvbnRleHQubW92ZSApOwoJCQkJfQoJCQkJaWYgKCBjb250ZXh0LnN0b3AgKSB7CgkJCQkJJGRvY3VtZW50Lm9mZiggdG91Y2hTdG9wRXZlbnQsIGNvbnRleHQuc3RvcCApOwoJCQkJfQoJCQl9CgkJfQoJfTsKCSQuZWFjaCh7CgkJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCQl0YXBob2xkOiAidGFwIiwKCQlzd2lwZWxlZnQ6ICJzd2lwZS5sZWZ0IiwKCQlzd2lwZXJpZ2h0OiAic3dpcGUucmlnaHQiCgl9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCQkkLmV2ZW50LnNwZWNpYWxbIGV2ZW50IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoIHNvdXJjZUV2ZW50ICk7CgkJCX0KCQl9OwoJfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoKCS8vIHRocm90dGxlZCByZXNpemUgZXZlbnQKCShmdW5jdGlvbiggJCApIHsKCQkkLmV2ZW50LnNwZWNpYWwudGhyb3R0bGVkcmVzaXplID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLnVuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfQoJCX07CgoJCXZhciB0aHJvdHRsZSA9IDI1MCwKCQkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQkJY3VyciA9ICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsKCQkJCWRpZmYgPSBjdXJyIC0gbGFzdENhbGw7CgoJCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCQlsYXN0Q2FsbCA9IGN1cnI7CgkJCQkJJCggdGhpcyApLnRyaWdnZXIoICJ0aHJvdHRsZWRyZXNpemUiICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJaWYgKCBoZWxkQ2FsbCApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBoZWxkQ2FsbCApOwoJCQkJCX0KCgkJCQkJLy8gUHJvbWlzZSBhIGhlbGQgY2FsbCB3aWxsIHN0aWxsIGV4ZWN1dGUKCQkJCQloZWxkQ2FsbCA9IHNldFRpbWVvdXQoIGhhbmRsZXIsIHRocm90dGxlIC0gZGlmZiApOwoJCQkJfQoJCQl9LAoJCQlsYXN0Q2FsbCA9IDAsCgkJCWhlbGRDYWxsLAoJCQljdXJyLAoJCQlkaWZmOwoJfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJdmFyIHdpbiA9ICQoIHdpbmRvdyApLAoJCWV2ZW50X25hbWUgPSAib3JpZW50YXRpb25jaGFuZ2UiLAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfSwKCQl3dywgd2gsIGxhbmRzY2FwZV90aHJlc2hvbGQ7CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgd2luLndpZHRoKCk7CgkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgd2luLmhlaWdodCgpOwoJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgkJLy8gTm93IGNoZWNrIHRvIHNlZSBpZiB0aGUgY3VycmVudCB3aW5kb3cub3JpZW50YXRpb24gaXMgMCBvciAxODAuCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCgkJLy8gSWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgbGFuZHNjYXBlLCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgMCBvciAxODAsICpPUioKCQkvLyBpZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBwb3J0cmFpdCwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDkwIG9yIC05MCwgd2UKCQkvLyBuZWVkIHRvIGZsaXAgb3VyIHBvcnRyYWl0X21hcCB2YWx1ZXMgYmVjYXVzZSBsYW5kc2NhcGUgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gZm9yCgkJLy8gdGhpcyBkZXZpY2UvYnJvd3Nlci4KCQlpZiAoICggaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgfHwgKCAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgIWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApICkgewoJCQlwb3J0cmFpdF9tYXAgPSB7ICItOTAiOiB0cnVlLCAiOTAiOiB0cnVlIH07CgkJfQoJfQoKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSA9ICQuZXh0ZW5kKCB7fSwgJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLCB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdCBqUXVlcnkKCQkJLy8gd2lsbCBiaW5kIHRvIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdAoJCQkvLyBqUXVlcnkgd2lsbCB1bmJpbmQgdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCB1bmJpbmQgdGhlCgkJCS8vIHJlc2l6ZSBldmVudCBoYW5kbGVyLgoJCQl3aW4udW5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJYWRkOiBmdW5jdGlvbiggaGFuZGxlT2JqICkgewoJCQkvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBib3VuZCBldmVudCBoYW5kbGVyLgoJCQl2YXIgb2xkX2hhbmRsZXIgPSBoYW5kbGVPYmouaGFuZGxlcjsKCgkJCWhhbmRsZU9iai5oYW5kbGVyID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJLy8gTW9kaWZ5IGV2ZW50IG9iamVjdCwgYWRkaW5nIHRoZSAub3JpZW50YXRpb24gcHJvcGVydHkuCgkJCQlldmVudC5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQkJCS8vIENhbGwgdGhlIG9yaWdpbmFsbHktYm91bmQgZXZlbnQgaGFuZGxlciBhbmQgcmV0dXJuIGl0cyByZXN1bHQuCgkJCQlyZXR1cm4gb2xkX2hhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9OwoJCX0KCX0pOwoKCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGlzIGhhbmRsZXIgd2lsbCBiZSBib3VuZCB0bwoJLy8gdGhlIHdpbmRvdyByZXNpemUgZXZlbnQgdG8gc2ltdWxhdGUgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJZnVuY3Rpb24gaGFuZGxlcigpIHsKCQkvLyBHZXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24uCgkJdmFyIG9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCWlmICggb3JpZW50YXRpb24gIT09IGxhc3Rfb3JpZW50YXRpb24gKSB7CgkJCS8vIFRoZSBvcmllbnRhdGlvbiBoYXMgY2hhbmdlZCwgc28gdHJpZ2dlciB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBvcmllbnRhdGlvbjsKCQkJd2luLnRyaWdnZXIoIGV2ZW50X25hbWUgKTsKCQl9Cgl9CgoJLy8gR2V0IHRoZSBjdXJyZW50IHBhZ2Ugb3JpZW50YXRpb24uIFRoaXMgbWV0aG9kIGlzIGV4cG9zZWQgcHVibGljbHksIHNob3VsZCBpdAoJLy8gYmUgbmVlZGVkLCBhcyBqUXVlcnkuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbigpCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24gPSBmdW5jdGlvbigpIHsKCQl2YXIgaXNQb3J0cmFpdCA9IHRydWUsIGVsZW0gPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgoJCS8vIHByZWZlciB3aW5kb3cgb3JpZW50YXRpb24gdG8gdGhlIGNhbGN1bGF0aW9uIGJhc2VkIG9uIHNjcmVlbnNpemUgYXMKCQkvLyB0aGUgYWN0dWFsIHNjcmVlbiByZXNpemUgdGFrZXMgcGxhY2UgYmVmb3JlIG9yIGFmdGVyIHRoZSBvcmllbnRhdGlvbiBjaGFuZ2UgZXZlbnQKCQkvLyBoYXMgYmVlbiBmaXJlZCBkZXBlbmRpbmcgb24gaW1wbGVtZW50YXRpb24gKGVnIGFuZHJvaWQgMi4zIGlzIGJlZm9yZSwgaXBob25lIGFmdGVyKS4KCQkvLyBNb3JlIHRlc3RpbmcgaXMgcmVxdWlyZWQgdG8gZGV0ZXJtaW5lIGlmIGEgbW9yZSByZWxpYWJsZSBtZXRob2Qgb2YgZGV0ZXJtaW5pbmcgdGhlIG5ldyBzY3JlZW5zaXplCgkJLy8gaXMgcG9zc2libGUgd2hlbiBvcmllbnRhdGlvbmNoYW5nZSBpcyBmaXJlZC4gKGVnLCB1c2UgbWVkaWEgcXVlcmllcyArIGVsZW1lbnQgKyBvcGFjaXR5KQoJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoJCQkvLyBpZiB0aGUgd2luZG93IG9yaWVudGF0aW9uIHJlZ2lzdGVycyBhcyAwIG9yIDE4MCBkZWdyZWVzIHJlcG9ydAoJCQkvLyBwb3J0cmFpdCwgb3RoZXJ3aXNlIGxhbmRzY2FwZQoJCQlpc1BvcnRyYWl0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCQl9IGVsc2UgewoJCQlpc1BvcnRyYWl0ID0gZWxlbSAmJiBlbGVtLmNsaWVudFdpZHRoIC8gZWxlbS5jbGllbnRIZWlnaHQgPCAxLjE7CgkJfQoKCQlyZXR1cm4gaXNQb3J0cmFpdCA/ICJwb3J0cmFpdCIgOiAibGFuZHNjYXBlIjsKCX07CgoJJC5mblsgZXZlbnRfbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCXJldHVybiBmbiA/IHRoaXMuYmluZCggZXZlbnRfbmFtZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggZXZlbnRfbmFtZSApOwoJfTsKCgkvLyBqUXVlcnkgPCAxLjgKCWlmICggJC5hdHRyRm4gKSB7CgkJJC5hdHRyRm5bIGV2ZW50X25hbWUgXSA9IHRydWU7Cgl9Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvLyBleGlzdGluZyBiYXNlIHRhZz8KCXZhciBiYXNlRWxlbWVudCA9ICQoICJoZWFkIiApLmNoaWxkcmVuKCAiYmFzZSIgKSwKCgkvLyBiYXNlIGVsZW1lbnQgbWFuYWdlbWVudCwgZGVmaW5lZCBkZXBlbmRpbmcgb24gZHluYW1pYyBiYXNlIHRhZyBzdXBwb3J0CgkvLyBUT0RPIG1vdmUgdG8gZXh0ZXJuYWwgd2lkZ2V0CgliYXNlID0gewoKCQkvLyBkZWZpbmUgYmFzZSBlbGVtZW50LCBmb3IgdXNlIGluIHJvdXRpbmcgYXNzZXQgdXJscyB0aGF0IGFyZSByZWZlcmVuY2VkCgkJLy8gaW4gQWpheC1yZXF1ZXN0ZWQgbWFya3VwCgkJZWxlbWVudDogKCBiYXNlRWxlbWVudC5sZW5ndGggPyBiYXNlRWxlbWVudCA6CgkJCSQoICI8YmFzZT4iLCB7IGhyZWY6ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggfSApLnByZXBlbmRUbyggJCggImhlYWQiICkgKSApLAoKCQlsaW5rU2VsZWN0b3I6ICJbc3JjXSwgbGlua1tocmVmXSwgYVtyZWw9J2V4dGVybmFsJ10sIDpqcW1EYXRhKGFqYXg9J2ZhbHNlJyksIGFbdGFyZ2V0XSIsCgoJCS8vIHNldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCXNldDogZnVuY3Rpb24oIGhyZWYgKSB7CgoJCQkvLyB3ZSBzaG91bGQgZG8gbm90aGluZyBpZiB0aGUgdXNlciB3YW50cyB0byBtYW5hZ2UgdGhlaXIgdXJsIGJhc2UKCQkJLy8gbWFudWFsbHkKCQkJaWYgKCAhJC5tb2JpbGUuZHluYW1pY0Jhc2VFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyB3ZSBzaG91bGQgdXNlIHRoZSBiYXNlIHRhZyBpZiB3ZSBjYW4gbWFuaXB1bGF0ZSBpdCBkeW5hbWljYWxseQoJCQlpZiAoICQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyApIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsCgkJCQkJJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlICkgKTsKCQkJfQoJCX0sCgoJCXJld3JpdGU6IGZ1bmN0aW9uKCBocmVmLCBwYWdlICkgewoJCQl2YXIgbmV3UGF0aCA9ICQubW9iaWxlLnBhdGguZ2V0KCBocmVmICk7CgoJCQlwYWdlLmZpbmQoIGJhc2UubGlua1NlbGVjdG9yICkuZWFjaChmdW5jdGlvbiggaSwgbGluayApIHsKCQkJCXZhciB0aGlzQXR0ciA9ICQoIGxpbmsgKS5pcyggIltocmVmXSIgKSA/ICJocmVmIiA6CgkJCQkJJCggbGluayApLmlzKCAiW3NyY10iICkgPyAic3JjIiA6ICJhY3Rpb24iLAoJCQkJdGhlTG9jYXRpb24gPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKSwKCQkJCXRoaXNVcmwgPSAkKCBsaW5rICkuYXR0ciggdGhpc0F0dHIgKTsKCgkJCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gZml4IHRoaXMgc28gdGhhdCBpdCByZW1vdmVzIHRoZSBkb2N1bWVudAoJCQkJLy8gICAgICAgICAgICBiYXNlIFVSTCwgYW5kIHRoZW4gcHJlcGVuZHMgd2l0aCB0aGUgbmV3IHBhZ2UgVVJMLgoJCQkJLy8gaWYgZnVsbCBwYXRoIGV4aXN0cyBhbmQgaXMgc2FtZSwgY2hvcCBpdCAtIGhlbHBzIElFIG91dAoJCQkJdGhpc1VybCA9IHRoaXNVcmwucmVwbGFjZSggdGhlTG9jYXRpb24ucHJvdG9jb2wgKyB0aGVMb2NhdGlvbi5kb3VibGVTbGFzaCArCgkJCQkJdGhlTG9jYXRpb24uaG9zdCArIHRoZUxvY2F0aW9uLnBhdGhuYW1lLCAiIiApOwoKCQkJCWlmICggIS9eKFx3Kzp8I3xcLykvLnRlc3QoIHRoaXNVcmwgKSApIHsKCQkJCQkkKCBsaW5rICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIHNldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCXJlc2V0OiBmdW5jdGlvbigvKiBocmVmICovKSB7CgkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb1NlYXJjaCApOwoJCX0KCX07CgoJJC5tb2JpbGUuYmFzZSA9IGJhc2U7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CiQubW9iaWxlLndpZGdldHMgPSB7fTsKCnZhciBvcmlnaW5hbFdpZGdldCA9ICQud2lkZ2V0LAoKCS8vIFJlY29yZCB0aGUgb3JpZ2luYWwsIG5vbi1tb2JpbGVpbml0LW1vZGlmaWVkIHZlcnNpb24gb2YgJC5tb2JpbGUua2VlcE5hdGl2ZQoJLy8gc28gd2UgY2FuIGxhdGVyIGRldGVybWluZSB3aGV0aGVyIHNvbWVvbmUgaGFzIG1vZGlmaWVkICQubW9iaWxlLmtlZXBOYXRpdmUKCWtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9ICQubW9iaWxlLmtlZXBOYXRpdmU7CgokLndpZGdldCA9IChmdW5jdGlvbiggb3JpZyApIHsKCXJldHVybiBmdW5jdGlvbigpIHsKCQl2YXIgY29uc3RydWN0b3IgPSBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJbmFtZSA9IGNvbnN0cnVjdG9yLnByb3RvdHlwZS53aWRnZXROYW1lOwoKCQljb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgPSAoICggY29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciAhPT0gdW5kZWZpbmVkICkgPwoJCQljb25zdHJ1Y3Rvci5wcm90b3R5cGUuaW5pdFNlbGVjdG9yIDogIjpqcW1EYXRhKHJvbGU9JyIgKyBuYW1lICsgIicpIiApOwoKCQkkLm1vYmlsZS53aWRnZXRzWyBuYW1lIF0gPSBjb25zdHJ1Y3RvcjsKCgkJcmV0dXJuIGNvbnN0cnVjdG9yOwoJfTsKfSkoICQud2lkZ2V0ICk7CgovLyBNYWtlIHN1cmUgJC53aWRnZXQgc3RpbGwgaGFzIGJyaWRnZSBhbmQgZXh0ZW5kIG1ldGhvZHMKJC5leHRlbmQoICQud2lkZ2V0LCBvcmlnaW5hbFdpZGdldCApOwoKLy8gRm9yIGJhY2tjb21wYXQgcmVtb3ZlIGluIDEuNQokLm1vYmlsZS5kb2N1bWVudC5vbiggImNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCSQoIGV2ZW50LnRhcmdldCApLmVuaGFuY2VXaXRoaW4oKTsKfSk7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYSIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICQubW9iaWxlLmtlZXBOYXRpdmUsCgoJCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQljb250ZW50VGhlbWU6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCS8vIERFUFJFQ0FURUQgZm9yID4gMS40CgkvLyBUT0RPIHJlbW92ZSBhdCAxLjUKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fY3JlYXRlV2lkZ2V0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl90cmlnZ2VyKCAiaW5pdCIgKTsKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJLy8gSWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY3JlYXRlIiApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LCB7CgkJCXBhZ2ViZWZvcmVoaWRlOiAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IgoJCX0pOwoKCQl0aGlzLmVsZW1lbnQuZW5oYW5jZVdpdGhpbigpOwoJCS8vIERpYWxvZyB3aWRnZXQgaXMgZGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIHRoaXMgaW4gMS41CgkJaWYgKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMuZWxlbWVudFswXSwgInJvbGUiICkgPT09ICJkaWFsb2ciICYmICQubW9iaWxlLmRpYWxvZyApIHsKCQkJdGhpcy5lbGVtZW50LmRpYWxvZygpOwoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uICgpIHsKCQl2YXIgYXR0clByZWZpeCA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXM7CgoJCWlmICggdGhpcy5vcHRpb25zLnJvbGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHRoaXMub3B0aW9ucy5yb2xlICk7CgkJfQoKCQl0aGlzLmVsZW1lbnQKCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCS5hZGRDbGFzcyggInVpLXBhZ2UgdWktcGFnZS10aGVtZS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgoJCS8vIE1hbmlwdWxhdGlvbiBvZiBjb250ZW50IG9zIERlcHJlY2F0ZWQgYXMgb2YgMS40IHJlbW92ZSBpbiAxLjUKCQl0aGlzLmVsZW1lbnQuZmluZCggIlsiICsgYXR0clByZWZpeCArICJyb2xlPSdjb250ZW50J10iICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCXRoZW1lID0gdGhpcy5nZXRBdHRyaWJ1dGUoIGF0dHJQcmVmaXggKyAidGhlbWUiICkgfHwgdW5kZWZpbmVkOwoJCQkJc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSA9IHRoZW1lIHx8IHNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgfHwgKCBzZWxmLm9wdGlvbnMuZGlhbG9nICYmIHNlbGYub3B0aW9ucy50aGVtZSApIHx8ICggc2VsZi5lbGVtZW50LmpxbURhdGEoInJvbGUiKSA9PT0gImRpYWxvZyIgJiYgIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1jb250ZW50IiApOwoJCQkJaWYgKCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lICkgewoJCQkJCSR0aGlzLmFkZENsYXNzKCAidWktYm9keS0iICsgKCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lICkgKTsKCQkJCX0KCQkJCS8vIEFkZCBBUklBIHJvbGUKCQkJCSR0aGlzLmF0dHIoICJyb2xlIiwgIm1haW4iICkuYWRkQ2xhc3MoICJ1aS1jb250ZW50IiApOwoJCX0pOwoJfSwKCgliaW5kUmVtb3ZlOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJdmFyIHBhZ2UgPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIHdoZW4gZG9tIGNhY2hpbmcgaXMgbm90IGVuYWJsZWQgb3IgdGhlIHBhZ2UgaXMgZW1iZWRkZWQgYmluZCB0byByZW1vdmUgdGhlIHBhZ2Ugb24gaGlkZQoJCWlmICggIXBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLm9wdGlvbnMuZG9tQ2FjaGUgJiYKCQkJcGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSApIHsKCgkJCS8vIFRPRE8gdXNlIF9vbiAtIHRoYXQgaXMsIHNvcnQgb3V0IHdoeSBpdCBkb2Vzbid0IHdvcmsgaW4gdGhpcyBjYXNlCgkJCXBhZ2UuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIsIGNhbGxiYWNrIHx8IGZ1bmN0aW9uKCBlLCBkYXRhICkgewoKCQkJCS8vY2hlY2sgaWYgdGhpcyBpcyBhIHNhbWUgcGFnZSB0cmFuc2l0aW9uIGFuZCBpZiBzbyBkb24ndCByZW1vdmUgdGhlIHBhZ2UKCQkJCWlmKCAhZGF0YS5zYW1lUGFnZSApewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG8gKSB7CgkJaWYgKCBvLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLXBhZ2UtdGhlbWUtIiArIHRoaXMub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCAidWktcGFnZS10aGVtZS0iICsgby50aGVtZSApOwoJCX0KCgkJaWYgKCBvLmNvbnRlbnRUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArICI9J2NvbnRlbnQnXSIgKS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy5jb250ZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oLyogZSAqLykgewoJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJfSwKCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiOm1vYmlsZS1wYWdlY29udGFpbmVyIiApLnBhZ2Vjb250YWluZXIoeyAidGhlbWUiOiAibm9uZSIgfSk7Cgl9LAoJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKSB7CgkJdGhpcy5lbGVtZW50LnBhcmVudCgpLnBhZ2Vjb250YWluZXIoIHsgInRoZW1lIjogdGhlbWUgfHwgdGhpcy5vcHRpb25zLnRoZW1lIH0gKTsKCX0sCgkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlID0gJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgfHwgIiIgKSwKCQkJZ2xvYmFsVmFsdWUgPSAkLnRyaW0oICQubW9iaWxlLmtlZXBOYXRpdmUgKSwKCQkJb3B0aW9uVmFsdWUgPSAkLnRyaW0oIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSwKCgkJCS8vIENoZWNrIGlmICQubW9iaWxlLmtlZXBOYXRpdmUgaGFzIGNoYW5nZWQgZnJvbSB0aGUgZmFjdG9yeSBkZWZhdWx0CgkJCW5ld0RlZmF1bHQgPSAoIGtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9PT0gZ2xvYmFsVmFsdWUgPwoJCQkJIiIgOiBnbG9iYWxWYWx1ZSApLAoKCQkJLy8gSWYgJC5tb2JpbGUua2VlcE5hdGl2ZSBoYXMgbm90IGNoYW5nZWQsIHVzZSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0CgkJCW9sZERlZmF1bHQgPSAoIG5ld0RlZmF1bHQgPT09ICIiID8gb3B0aW9uVmFsdWUgOiAiIiApOwoKCQkvLyBDb25jYXRlbmF0ZSBrZWVwTmF0aXZlIHNlbGVjdG9ycyBmcm9tIGFsbCBzb3VyY2VzIHdoZXJlIHRoZSB2YWx1ZSBoYXMKCQkvLyBjaGFuZ2VkIG9yLCBpZiBub3RoaW5nIGhhcyBjaGFuZ2VkLCByZXR1cm4gdGhlIGRlZmF1bHQKCQlyZXR1cm4gKCAoIGtlZXBOYXRpdmUgPyBbIGtlZXBOYXRpdmUgXSA6IFtdICkKCQkJLmNvbmNhdCggbmV3RGVmYXVsdCA/IFsgbmV3RGVmYXVsdCBdIDogW10gKQoJCQkuY29uY2F0KCBvbGREZWZhdWx0ID8gWyBvbGREZWZhdWx0IF0gOiBbXSApCgkJCS5qb2luKCAiLCAiICkgKTsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnBhZ2Vjb250YWluZXIiLCB7CgkJb3B0aW9uczogewoJCQl0aGVtZTogImEiCgkJfSwKCgkJaW5pdFNlbGVjdG9yOiBmYWxzZSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVjcmVhdGUiICk7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCQkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLAoJCQkJLy8gdGhpcyBvbmx5IHdvcmtzIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uCgkJCQkvLyBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlciB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlCgkJCQkvLyBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkJCQluYXZpZ2F0ZTogIl9kaXNhYmxlUmVjb3JkU2Nyb2xsIiwKCgkJCQkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlLCAicGFnZWNoYW5nZSIgd29uJ3QgYmUKCQkJCS8vIGZpcmVkIGluIHRoYXQgY2FzZQoJCQkJc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIgoJCQl9KTsKCgkJCS8vIFRPRE8gY29uc2lkZXIgbW92aW5nIHRoZSBuYXZpZ2F0aW9uIGhhbmRsZXIgT1VUIG9mIHdpZGdldCBpbnRvCgkJCS8vICAgICAgc29tZSBvdGhlciBvYmplY3QgYXMgZ2x1ZSBiZXR3ZWVuIHRoZSBuYXZpZ2F0ZSBldmVudCBhbmQgdGhlCgkJCS8vICAgICAgY29udGVudCB3aWRnZXQgbG9hZCBhbmQgY2hhbmdlIG1ldGhvZHMKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7IG5hdmlnYXRlOiAiX2ZpbHRlck5hdmlnYXRlRXZlbnRzIiB9KTsKCgkJCS8vIFRPRE8gbW92ZSBmcm9tIHBhZ2UqIGV2ZW50cyB0byBjb250ZW50KiBldmVudHMKCQkJdGhpcy5fb24oeyBwYWdlY2hhbmdlOiAiX2FmdGVyQ29udGVudENoYW5nZSIgfSk7CgoJCQkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkJCXRoaXMud2luZG93Lm9uZSggIm5hdmlnYXRlIiwgJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zLnRoZW1lICE9PSAibm9uZSIgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJCS5hZGRDbGFzcyggInVpLW92ZXJsYXktIiArIG9wdGlvbnMudGhlbWUgKTsKCQkJfSBlbHNlIGlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgkJCX0KCgkJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJfSwKCgkJX2Rpc2FibGVSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gZmFsc2U7CgkJfSwKCgkJX2VuYWJsZVJlY29yZFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gY29uc2lkZXIgdGhlIG5hbWUgaGVyZSwgc2luY2UgaXQncyBwdXJwb3NlIHNwZWNpZmljCgkJX2FmdGVyQ29udGVudENoYW5nZTogZnVuY3Rpb24oKSB7CgkJCS8vIG9uY2UgdGhlIHBhZ2UgaGFzIGNoYW5nZWQsIHJlLWVuYWJsZSB0aGUgc2Nyb2xsIHJlY29yZGluZwoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQKCQkJLy8gZGV0ZXJtaW5lZCBmb3IgdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJdGhpcy5fb2ZmKCB0aGlzLndpbmRvdywgInNjcm9sbHN0b3AiICk7CgoJCQkvLyBkZXRlcm1pbmUgYW5kIGJpbmQgdG8gdGhlIGN1cnJlbnQgc2NvbGwgZWxlbWVudCB3aGljaCBtYXkgYmUgdGhlCgkJCS8vIHdpbmRvdyBvciBpbiB0aGUgY2FzZSBvZiB0b3VjaCBvdmVyZmxvdyB0aGUgZWxlbWVudCB0b3VjaCBvdmVyZmxvdwoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIiB9KTsKCQl9LAoKCQlfcmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbgoJCQkvLyB0aGUgYnJvd3NlciBzY3JvbGxpbmcgdGhlIHdpbmRvdyBiYXNlZCBvbiBhIGhhc2hjaGFuZ2UKCQkJaWYgKCAhdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGFjdGl2ZSA9IHRoaXMuX2dldEFjdGl2ZUhpc3RvcnkoKSwKCQkJCWN1cnJlbnRTY3JvbGwsIG1pblNjcm9sbCwgZGVmYXVsdFNjcm9sbDsKCgkJCWlmICggYWN0aXZlICkgewoJCQkJY3VycmVudFNjcm9sbCA9IHRoaXMuX2dldFNjcm9sbCgpOwoJCQkJbWluU2Nyb2xsID0gdGhpcy5fZ2V0TWluU2Nyb2xsKCk7CgkJCQlkZWZhdWx0U2Nyb2xsID0gdGhpcy5fZ2V0RGVmYXVsdFNjcm9sbCgpOwoKCQkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlCgkJCQkvLyBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gY3VycmVudFNjcm9sbCA8IG1pblNjcm9sbCA/IGRlZmF1bHRTY3JvbGwgOiBjdXJyZW50U2Nyb2xsOwoJCQl9CgkJfSwKCgkJX2RlbGF5ZWRSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlzZXRUaW1lb3V0KCAkLnByb3h5KHRoaXMsICJfcmVjb3JkU2Nyb2xsIiksIDEwMCApOwoJCX0sCgoJCV9nZXRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgkJfSwKCgkJX2dldE1pblNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5taW5TY3JvbGxCYWNrOwoJCX0sCgoJCV9nZXREZWZhdWx0U2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCX0sCgoJCV9maWx0ZXJOYXZpZ2F0ZUV2ZW50czogZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJCXZhciB1cmw7CgoJCQlpZiAoIGUub3JpZ2luYWxFdmVudCAmJiBlLm9yaWdpbmFsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXVybCA9IGUub3JpZ2luYWxFdmVudC50eXBlLmluZGV4T2YoICJoYXNoY2hhbmdlIiApID4gLTEgPyBkYXRhLnN0YXRlLmhhc2ggOiBkYXRhLnN0YXRlLnVybDsKCgkJCWlmICggIXVybCApIHsKCQkJCXVybCA9IHRoaXMuX2dldEhhc2goKTsKCQkJfQoKCQkJaWYgKCAhdXJsIHx8IHVybCA9PT0gIiMiIHx8IHVybC5pbmRleE9mKCAiIyIgKyAkLm1vYmlsZS5wYXRoLnVpU3RhdGVLZXkgKSA9PT0gMCApIHsKCQkJCXVybCA9IGxvY2F0aW9uLmhyZWY7CgkJCX0KCgkJCXRoaXMuX2hhbmRsZU5hdmlnYXRlKCB1cmwsIGRhdGEuc3RhdGUgKTsKCQl9LAoKCQlfZ2V0SGFzaDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCX0sCgoJCS8vIFRPRE8gYWN0aXZlIHBhZ2Ugc2hvdWxkIGJlIG1hbmFnZWQgYnkgdGhlIGNvbnRhaW5lciAoaWUsIGl0IHNob3VsZCBiZSBhIHByb3BlcnR5KQoJCWdldEFjdGl2ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5hY3RpdmVQYWdlOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZpcnN0IHBhZ2Ugc2hvdWxkIGJlIGEgcHJvcGVydHkgc2V0IGR1cmluZyBfY3JlYXRlIHVzaW5nIHRoZSBsb2dpYwoJCS8vICAgICAgdGhhdCBjdXJyZW50bHkgcmVzaWRlcyBpbiBpbml0CgkJX2dldEluaXRpYWxDb250ZW50OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmZpcnN0UGFnZTsKCQl9LAoKCQkvLyBUT0RPIGVhY2ggY29udGVudCBjb250YWluZXIgc2hvdWxkIGhhdmUgYSBoaXN0b3J5IG9iamVjdAoJCV9nZXRIaXN0b3J5OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgkJfSwKCgkJX2dldEFjdGl2ZUhpc3Rvcnk6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5fZ2V0SGlzdG9yeSgpLmdldEFjdGl2ZSgpOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGRvY3VtZW50IGJhc2Ugc2hvdWxkIGJlIGRldGVybWluZWQgYXQgY3JlYXRpb24KCQlfZ2V0RG9jdW1lbnRCYXNlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlOwoJCX0sCgoJCWJhY2s6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdvKCAtMSApOwoJCX0sCgoJCWZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdvKCAxICk7CgkJfSwKCgkJZ286IGZ1bmN0aW9uKCBzdGVwcyApIHsKCgkJCS8vaWYgaGFzaGxpc3RlbmluZyBpcyBlbmFibGVkIHVzZSBuYXRpdmUgaGlzdG9yeSBtZXRob2QKCQkJaWYgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCApIHsKCQkJCXdpbmRvdy5oaXN0b3J5LmdvKCBzdGVwcyApOwoJCQl9IGVsc2UgewoKCQkJCS8vd2UgYXJlIG5vdCBsaXN0ZW5pbmcgdG8gdGhlIGhhc2ggc28gaGFuZGxlIGhpc3RvcnkgaW50ZXJuYWxseQoJCQkJdmFyIGFjdGl2ZUluZGV4ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCwKCQkJCQlpbmRleCA9IGFjdGl2ZUluZGV4ICsgcGFyc2VJbnQoIHN0ZXBzLCAxMCApLAoJCQkJCXVybCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnkuc3RhY2tbIGluZGV4IF0udXJsLAoJCQkJCWRpcmVjdGlvbiA9ICggc3RlcHMgPj0gMSApPyAiZm9yd2FyZCIgOiAiYmFjayI7CgoJCQkJLy91cGRhdGUgdGhlIGhpc3Rvcnkgb2JqZWN0CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID0gaW5kZXg7CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnByZXZpb3VzSW5kZXggPSBhY3RpdmVJbmRleDsKCgkJCQkvL2NoYW5nZSB0byB0aGUgbmV3IHBhZ2UKCQkJCXRoaXMuY2hhbmdlKCB1cmwsIHsgZGlyZWN0aW9uOiBkaXJlY3Rpb24sIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCQl9LAoKCQkvLyBUT0RPIHJlbmFtZSBfaGFuZGxlRGVzdGluYXRpb24KCQlfaGFuZGxlRGVzdGluYXRpb246IGZ1bmN0aW9uKCB0byApIHsKCQkJdmFyIGhpc3Rvcnk7CgoJCQkvLyBjbGVhbiB0aGUgaGFzaCBmb3IgY29tcGFyaXNvbiBpZiBpdCdzIGEgdXJsCgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQl0byA9ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCB0byApOwoJCQl9CgoJCQlpZiAoIHRvICkgewoJCQkJaGlzdG9yeSA9IHRoaXMuX2dldEhpc3RvcnkoKTsKCgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UKCQkJCS8vIGVsZW1lbnQgZnJvbSBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlIC8KCQkJCS8vIGFic29sdXRlIFVSTC4gSWYgJ3RvJyBpcyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QKCQkJCS8vIHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwgc2luY2UgdGhlIGhhc2hjaGFuZ2UKCQkJCS8vIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwKCQkJCS8vIHBhZ2UvZGlhbG9nLgoJCQkJLy8KCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdCBvciBwYXRoIG9iamVjdD8KCQkJCXRvID0gISQubW9iaWxlLnBhdGguaXNQYXRoKCB0byApID8gKCAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgdG8sIHRoaXMuX2dldERvY3VtZW50QmFzZSgpICkgKSA6IHRvOwoJCQl9CgkJCXJldHVybiB0byB8fCB0aGlzLl9nZXRJbml0aWFsQ29udGVudCgpOwoJCX0sCgoJCS8vIFRoZSBvcHRpb25zIGJ5IHdoaWNoIGEgZ2l2ZW4gcGFnZSB3YXMgcmVhY2hlZCBhcmUgc3RvcmVkIGluIHRoZSBoaXN0b3J5IGVudHJ5IGZvciB0aGF0CgkJLy8gcGFnZS4gV2hlbiB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCwgaGlzdG9yeSBpcyBhbHJlYWR5IGF0IHRoZSBuZXcgZW50cnkuIFNvLCB3aGVuIG1vdmluZwoJCS8vIGJhY2ssIHRoaXMgbWVhbnMgd2UgbmVlZCB0byBjb25zdWx0IHRoZSBvbGQgZW50cnkgYW5kIHJldmVyc2UgdGhlIG1lYW5pbmcgb2YgdGhlCgkJLy8gb3B0aW9ucy4gT3RoZXJ3aXNlLCBpZiB3ZSdyZSBtb3ZpbmcgZm9yd2FyZCwgd2UgbmVlZCB0byBjb25zdWx0IHRoZSBvcHRpb25zIGZvciB0aGUKCQkvLyBjdXJyZW50IGVudHJ5LgoJCV9vcHRpb25Gcm9tSGlzdG9yeTogZnVuY3Rpb24oIGRpcmVjdGlvbiwgb3B0aW9uTmFtZSwgZmFsbGJhY2tWYWx1ZSApIHsKCQkJdmFyIGhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCksCgkJCQllbnRyeSA9ICggZGlyZWN0aW9uID09PSAiYmFjayIgPyBoaXN0b3J5LmdldExhc3QoKSA6IGhpc3RvcnkuZ2V0QWN0aXZlKCkgKTsKCgkJCXJldHVybiAoICggZW50cnkgJiYgZW50cnlbIG9wdGlvbk5hbWUgXSApIHx8IGZhbGxiYWNrVmFsdWUgKTsKCQl9LAoKCQlfaGFuZGxlRGlhbG9nOiBmdW5jdGlvbiggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKSB7CgkJCXZhciB0bywgYWN0aXZlLCBhY3RpdmVDb250ZW50ID0gdGhpcy5nZXRBY3RpdmVQYWdlKCk7CgoJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQkvLyBOb3RlOiBUaGUgZGlhbG9nIHdpZGdldCBpcyBkZXByZWNhdGVkIGFzIG9mIDEuNC4wIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gMS41LjAuCgkJCS8vIFRodXMsIGFzIG9mIDEuNS4wIGFjdGl2ZUNvbnRlbnQuZGF0YSggIm1vYmlsZS1kaWFsb2ciICkgd2lsbCBhbHdheXMgZXZhbHVhdGUgdG8KCQkJLy8gZmFsc3ksIHNvIHRoZSBzZWNvbmQgY29uZGl0aW9uIGluIHRoZSBpZi1zdGF0ZW1lbnQgYmVsb3cgY2FuIGJlIHJlbW92ZWQgYWx0b2dldGhlci4KCQkJaWYgKCBhY3RpdmVDb250ZW50ICYmICFhY3RpdmVDb250ZW50LmRhdGEoICJtb2JpbGUtZGlhbG9nIiApICkgewoJCQkJLy8gZGV0ZXJtaW5lIGlmIHdlJ3JlIGhlYWRpbmcgZm9yd2FyZCBvciBiYWNrd2FyZCBhbmQgY29udGludWUKCQkJCS8vIGFjY29yZGluZ2x5IHBhc3QgdGhlIGN1cnJlbnQgZGlhbG9nCgkJCQlpZiAoIGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIgKSB7CgkJCQkJdGhpcy5iYWNrKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuZm9yd2FyZCgpOwoJCQkJfQoKCQkJCS8vIHByZXZlbnQgY2hhbmdlUGFnZSBjYWxsCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSB7CgkJCQkvLyBpZiB0aGUgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBhIGRpYWxvZyBhbmQgd2UncmUgbmF2aWdhdGluZwoJCQkJLy8gdG8gYSBkaWFsb2cgdXNlIHRoZSBkaWFsb2cgb2JqZWN0ZWQgc2F2ZWQgaW4gdGhlIHN0YWNrCgkJCQl0byA9IGRhdGEucGFnZVVybDsKCQkJCWFjdGl2ZSA9IHRoaXMuX2dldEFjdGl2ZUhpc3RvcnkoKTsKCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSByb2xlLCB0cmFuc2l0aW9uIGFuZCByZXZlcnNhbAoJCQkJLy8gYXMgbW9zdCBvZiB0aGlzIGlzIGxvc3QgYnkgdGhlIGRvbUNhY2hlIGNsZWFuaW5nCgkJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIHsKCQkJCQlyb2xlOiBhY3RpdmUucm9sZSwKCQkJCQl0cmFuc2l0aW9uOiB0aGlzLl9vcHRpb25Gcm9tSGlzdG9yeSggZGF0YS5kaXJlY3Rpb24sICJ0cmFuc2l0aW9uIiwKCQkJCQkJY2hhbmdlUGFnZU9wdGlvbnMudHJhbnNpdGlvbiApLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX0pOwoJCQl9CgoJCQlyZXR1cm4gdG87CgkJfSwKCgkJX2hhbmRsZU5hdmlnYXRlOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQkvLyBUT0RPIHN0cmlwcGluZyB0aGUgaGFzaCB0d2ljZSB3aXRoIGhhbmRsZVVybAoJCQl2YXIgdG8gPSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggdXJsICksIGhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCksCgoJCQkJLy8gdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQKCQkJCS8vIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOgoJCQkJCXRoaXMuX29wdGlvbkZyb21IaXN0b3J5KCBkYXRhLmRpcmVjdGlvbiwgInRyYW5zaXRpb24iICksCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nCgkJCQkvLyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gsIE5PVEUgdGhhdCB0aGUKCQkJCS8vIHRyYW5zaXRpb24gaXMgZGVyaXZlZCBmcm9tIHRoZSBwcmV2aW91cyBoaXN0b3J5IGVudHJ5CgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZSwKCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQl9OwoKCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhLCB7CgkJCQl0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLAoJCQkJYWxsb3dTYW1lUGFnZVRyYW5zaXRpb246IHRoaXMuX29wdGlvbkZyb21IaXN0b3J5KCBkYXRhLmRpcmVjdGlvbiwKCQkJCQkiYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24iICkKCQkJfSk7CgoJCQkvLyBUT0RPIG1vdmUgdG8gX2hhbmRsZURlc3RpbmF0aW9uID8KCQkJLy8gSWYgdGhpcyBpc24ndCB0aGUgZmlyc3QgcGFnZSwgaWYgdGhlIGN1cnJlbnQgdXJsIGlzIGEgZGlhbG9nIGhhc2gKCQkJLy8ga2V5LCBhbmQgdGhlIGluaXRpYWwgZGVzdGluYXRpb24gaXNuJ3QgZXF1YWwgdG8gdGhlIGN1cnJlbnQgdGFyZ2V0CgkJCS8vIHBhZ2UsIHVzZSB0aGUgc3BlY2lhbCBkaWFsb2cgaGFuZGxpbmcKCQkJaWYgKCBoaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCAmJgoJCQkJdG8uaW5kZXhPZiggJC5tb2JpbGUuZGlhbG9nSGFzaEtleSApID4gLTEgKSB7CgoJCQkJdG8gPSB0aGlzLl9oYW5kbGVEaWFsb2coIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhICk7CgoJCQkJaWYgKCB0byA9PT0gZmFsc2UgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQl0aGlzLl9jaGFuZ2VDb250ZW50KCB0aGlzLl9oYW5kbGVEZXN0aW5hdGlvbiggdG8gKSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQl9LAoKCQlfY2hhbmdlQ29udGVudDogZnVuY3Rpb24oIHRvLCBvcHRzICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCB0bywgb3B0cyApOwoJCX0sCgoJCV9nZXRCYXNlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmJhc2U7CgkJfSwKCgkJX2dldE5zOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm5zOwoJCX0sCgoJCV9lbmhhbmNlOiBmdW5jdGlvbiggY29udGVudCwgcm9sZSApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBzdXBwb3J0aW5nIGEgY3VzdG9tIGNhbGxiYWNrLCBhbmQgcGFzc2luZyBpbgoJCQkvLyB0aGUgc2V0dGluZ3Mgd2hpY2ggaW5jbHVkZXMgdGhlIHJvbGUKCQkJcmV0dXJuIGNvbnRlbnQucGFnZSh7IHJvbGU6IHJvbGUgfSk7CgkJfSwKCgkJX2luY2x1ZGU6IGZ1bmN0aW9uKCBwYWdlLCBzZXR0aW5ncyApIHsKCQkJLy8gYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJcGFnZS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCQkvLyB1c2UgdGhlIHBhZ2Ugd2lkZ2V0IHRvIGVuaGFuY2UKCQkJdGhpcy5fZW5oYW5jZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJLy8gcmVtb3ZlIHBhZ2Ugb24gaGlkZQoJCQlwYWdlLnBhZ2UoICJiaW5kUmVtb3ZlIiApOwoJCX0sCgoJCV9maW5kOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkvLyBUT0RPIGNvbnNpZGVyIHN1cHBvcnRpbmcgYSBjdXN0b20gY2FsbGJhY2sKCQkJdmFyIGZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKSwKCQkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKSwKCQkJCXBhZ2UsIGluaXRpYWxDb250ZW50ID0gdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCgkJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCQkvLyBOT1RFIGRvIF9ub3RfIHVzZSB0aGUgOmpxbURhdGEgcHNldWRvIHNlbGVjdG9yIGJlY2F1c2UgcGFyZW50aGVzaXMKCQkJLy8gICAgICBhcmUgYSB2YWxpZCB1cmwgY2hhciBhbmQgaXQgYnJlYWtzIG9uIHRoZSBmaXJzdCBvY2N1cmVuY2UKCQkJcGFnZSA9IHRoaXMuZWxlbWVudAoJCQkJLmNoaWxkcmVuKCAiW2RhdGEtIiArIHRoaXMuX2dldE5zKCkgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoKCQkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkJLy8gcmVmZXJlbmNlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuIElmIHNvLCBpdCBtYXkgaGF2ZSBiZWVuIGR5bmFtaWNhbGx5CgkJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYQoJCQkvLyBkYXRhLXVybCBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYgZGF0YVVybCAmJiAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIGRhdGFVcmwgKSApIHsKCQkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICQubW9iaWxlLnBhdGguaGFzaFRvU2VsZWN0b3IoIiMiICsgZGF0YVVybCkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmwiLCBkYXRhVXJsICkKCQkJCQkuanFtRGF0YSggInVybCIsIGRhdGFVcmwgKTsKCQkJfQoKCQkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgYSBwYWdlIGluIHRoZSBET00sIGNoZWNrIHRoZSBVUkwgdG8gc2VlIGlmIGl0CgkJCS8vIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgYXBwbGljYXRpb24uIEFsc28gY2hlY2sgdG8gbWFrZSBzdXJlCgkJCS8vIG91ciBjYWNoZWQtZmlyc3QtcGFnZSBpcyBhY3R1YWxseSBpbiB0aGUgRE9NLiBTb21lIHVzZXIgZGVwbG95ZWQKCQkJLy8gYXBwcyBhcmUgcHJ1bmluZyB0aGUgZmlyc3QgcGFnZSBmcm9tIHRoZSBET00gZm9yIHZhcmlvdXMgcmVhc29ucy4KCQkJLy8gV2UgY2hlY2sgZm9yIHRoaXMgY2FzZSBoZXJlIGJlY2F1c2Ugd2UgZG9uJ3Qgd2FudCBhIGZpcnN0LXBhZ2Ugd2l0aAoJCQkvLyBhbiBpZCBmYWxsaW5nIHRocm91Z2ggdG8gdGhlIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlIGVycm9yIGNhc2UuCgkJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNGaXJzdFBhZ2VVcmwoIGZpbGVVcmwgKSAmJgoJCQkJaW5pdGlhbENvbnRlbnQgJiYKCQkJCWluaXRpYWxDb250ZW50LnBhcmVudCgpLmxlbmd0aCApIHsKCQkJCXBhZ2UgPSAkKCBpbml0aWFsQ29udGVudCApOwoJCQl9CgoJCQlyZXR1cm4gcGFnZTsKCQl9LAoKCQlfZ2V0TG9hZGVyOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmxvYWRpbmcoKTsKCQl9LAoKCQlfc2hvd0xvYWRpbmc6IGZ1bmN0aW9uKCBkZWxheSwgdGhlbWUsIG1zZywgdGV4dG9ubHkgKSB7CgkJCS8vIFRoaXMgY29uZmlndXJhYmxlIHRpbWVvdXQgYWxsb3dzIGNhY2hlZCBwYWdlcyBhIGJyaWVmCgkJCS8vIGRlbGF5IHRvIGxvYWQgd2l0aG91dCBzaG93aW5nIGEgbWVzc2FnZQoJCQlpZiAoIHRoaXMuX2xvYWRNc2cgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXRoaXMuX2xvYWRNc2cgPSBzZXRUaW1lb3V0KCQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9nZXRMb2FkZXIoKS5sb2FkZXIoICJzaG93IiwgdGhlbWUsIG1zZywgdGV4dG9ubHkgKTsKCQkJCXRoaXMuX2xvYWRNc2cgPSAwOwoJCQl9LCB0aGlzKSwgZGVsYXkgKTsKCQl9LAoKCQlfaGlkZUxvYWRpbmc6IGZ1bmN0aW9uKCkgewoJCQkvLyBTdG9wIG1lc3NhZ2Ugc2hvdyB0aW1lcgoJCQljbGVhclRpbWVvdXQoIHRoaXMuX2xvYWRNc2cgKTsKCQkJdGhpcy5fbG9hZE1zZyA9IDA7CgoJCQkvLyBIaWRlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGlzLl9nZXRMb2FkZXIoKS5sb2FkZXIoICJoaWRlIiApOwoJCX0sCgoJCV9zaG93RXJyb3I6IGZ1bmN0aW9uKCkgewoJCQkvLyBtYWtlIHN1cmUgdG8gcmVtb3ZlIHRoZSBjdXJyZW50IGxvYWRpbmcgbWVzc2FnZQoJCQl0aGlzLl9oaWRlTG9hZGluZygpOwoKCQkJLy8gc2hvdyB0aGUgZXJyb3IgbWVzc2FnZQoJCQl0aGlzLl9zaG93TG9hZGluZyggMCwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZSwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2UsIHRydWUgKTsKCgkJCS8vIGhpZGUgdGhlIGVycm9yIG1lc3NhZ2UgYWZ0ZXIgYSBkZWxheQoJCQkvLyBUT0RPIGNvbmZpZ3VyYXRpb24KCQkJc2V0VGltZW91dCggJC5wcm94eSh0aGlzLCAiX2hpZGVMb2FkaW5nIiksIDE1MDAgKTsKCQl9LAoKCQlfcGFyc2U6IGZ1bmN0aW9uKCBodG1sLCBmaWxlVXJsICkgewoJCQkvLyBUT0RPIGNvbnNpZGVyIGFsbG93aW5nIGN1c3RvbWl6YXRpb24gb2YgdGhpcyBtZXRob2QuIEl0J3MgdmVyeSBKUU0gc3BlY2lmaWMKCQkJdmFyIHBhZ2UsIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKTsKCgkJCS8vd29ya2Fyb3VuZCB0byBhbGxvdyBzY3JpcHRzIHRvIGV4ZWN1dGUgd2hlbiBpbmNsdWRlZCBpbiBwYWdlIGRpdnMKCQkJYWxsLmdldCggMCApLmlubmVySFRNTCA9IGh0bWw7CgoJCQlwYWdlID0gYWxsLmZpbmQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpcnN0KCk7CgoJCQkvL2lmIHBhZ2UgZWxlbSBjb3VsZG4ndCBiZSBmb3VuZCwgY3JlYXRlIG9uZSBhbmQgaW5zZXJ0IHRoZSBib2R5IGVsZW1lbnQncyBjb250ZW50cwoJCQlpZiAoICFwYWdlLmxlbmd0aCApIHsKCQkJCXBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInJvbGU9J3BhZ2UnPiIgKwoJCQkJCSggaHRtbC5zcGxpdCggLzxcLz9ib2R5W14+XSo+L2dtaSApWzFdIHx8ICIiICkgKwoJCQkJCSI8L2Rpdj4iICk7CgkJCX0KCgkJCS8vIFRPRE8gdGFnZ2luZyBhIHBhZ2Ugd2l0aCBleHRlcm5hbCB0byBtYWtlIHN1cmUgdGhhdCBlbWJlZGRlZCBwYWdlcyBhcmVuJ3QKCQkJLy8gcmVtb3ZlZCBieSB0aGUgdmFyaW91cyBwYWdlIGhhbmRsaW5nIGNvZGUgaXMgYmFkLiBIYXZpbmcgcGFnZSBoYW5kbGluZyBjb2RlCgkJCS8vIGluIG1hbnkgcGxhY2VzIGlzIGJhZC4gU29sdXRpb25zIHBvc3QgMS4wCgkJCXBhZ2UuYXR0ciggImRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAidXJsIiwgJC5tb2JpbGUucGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKGZpbGVVcmwpICkKCQkJCS5hdHRyKCAiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJleHRlcm5hbC1wYWdlIiwgdHJ1ZSApOwoKCQkJcmV0dXJuIHBhZ2U7CgkJfSwKCgkJX3NldExvYWRlZFRpdGxlOiBmdW5jdGlvbiggcGFnZSwgaHRtbCApIHsKCQkJLy9wYWdlIHRpdGxlIHJlZ2V4cAoJCQl2YXIgbmV3UGFnZVRpdGxlID0gaHRtbC5tYXRjaCggLzx0aXRsZVtePl0qPihbXjxdKikvICkgJiYgUmVnRXhwLiQxOwoKCQkJaWYgKCBuZXdQYWdlVGl0bGUgJiYgIXBhZ2UuanFtRGF0YSgidGl0bGUiKSApIHsKCQkJCW5ld1BhZ2VUaXRsZSA9ICQoICI8ZGl2PiIgKyBuZXdQYWdlVGl0bGUgKyAiPC9kaXY+IiApLnRleHQoKTsKCQkJCXBhZ2UuanFtRGF0YSggInRpdGxlIiwgbmV3UGFnZVRpdGxlICk7CgkJCX0KCQl9LAoKCQlfaXNSZXdyaXRhYmxlQmFzZVRhZzogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgJiYgISQuc3VwcG9ydC5keW5hbWljQmFzZVRhZzsKCQl9LAoKCQlfY3JlYXRlRGF0YVVybDogZnVuY3Rpb24oIGFic29sdXRlVXJsICkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBhYnNvbHV0ZVVybCApOwoJCX0sCgoJCV9jcmVhdGVGaWxlVXJsOiBmdW5jdGlvbiggYWJzb2x1dGVVcmwgKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLmdldEZpbGVQYXRoKCBhYnNvbHV0ZVVybCApOwoJCX0sCgoJCV90cmlnZ2VyV2l0aERlcHJlY2F0ZWQ6IGZ1bmN0aW9uKCBuYW1lLCBkYXRhLCBwYWdlICkgewoJCQl2YXIgZGVwcmVjYXRlZEV2ZW50ID0gJC5FdmVudCggInBhZ2UiICsgbmFtZSApLAoJCQkJbmV3RXZlbnQgPSAkLkV2ZW50KCB0aGlzLndpZGdldE5hbWUgKyBuYW1lICk7CgoJCQkvLyBERVBSRUNBVEVECgkJCS8vIHRyaWdnZXIgdGhlIG9sZCBkZXByZWNhdGVkIGV2ZW50IG9uIHRoZSBwYWdlIGlmIGl0J3MgcHJvdmlkZWQKCQkJKCBwYWdlIHx8IHRoaXMuZWxlbWVudCApLnRyaWdnZXIoIGRlcHJlY2F0ZWRFdmVudCwgZGF0YSApOwoKCQkJLy8gdXNlIHRoZSB3aWRnZXQgdHJpZ2dlciBtZXRob2QgZm9yIHRoZSBuZXcgY29udGVudCogZXZlbnQKCQkJdGhpcy5fdHJpZ2dlciggbmFtZSwgbmV3RXZlbnQsIGRhdGEgKTsKCgkJCXJldHVybiB7CgkJCQlkZXByZWNhdGVkRXZlbnQ6IGRlcHJlY2F0ZWRFdmVudCwKCQkJCWV2ZW50OiBuZXdFdmVudAoJCQl9OwoJCX0sCgoJCS8vIFRPRE8gaXQgd291bGQgYmUgbmljZSB0byBzcGxpdCB0aGlzIHVwIG1vcmUgYnV0IGV2ZXJ5dGhpbmcgYXBwZWFycyB0byBiZSAib25lIG9mZiIKCQkvLyAgICAgIG9yIHJlcXVpcmUgb3JkZXJpbmcgc3VjaCB0aGF0IG90aGVyIGJpdHMgYXJlIHNwcmlua2xlZCBpbiBiZXR3ZWVuIHBhcnRzIHRoYXQKCQkvLyAgICAgIGNvdWxkIGJlIGFic3RyYWN0ZWQgb3V0IGFzIGEgZ3JvdXAKCQlfbG9hZFN1Y2Nlc3M6IGZ1bmN0aW9uKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKSB7CgkJCXZhciBmaWxlVXJsID0gdGhpcy5fY3JlYXRlRmlsZVVybCggYWJzVXJsICksCgkJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICk7CgoJCQlyZXR1cm4gJC5wcm94eShmdW5jdGlvbiggaHRtbCwgdGV4dFN0YXR1cywgeGhyICkgewoJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCS8vdXNlIGl0IGFzIHRoZSBuZXcgZmlsZVVybCwgYmFzZSBwYXRoLCBldGMKCQkJCXZhciBjb250ZW50LAoKCQkJCQkvLyBUT0RPIGhhbmRsZSBkaWFsb2dzIGFnYWluCgkJCQkJcGFnZUVsZW1SZWdleCA9IG5ldyBSZWdFeHAoICIoPFtePl0rXFxiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoKCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmw9W1wiJ10/KFteXCInPl0qKVtcIiddPyIgKTsKCgkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMKCQkJCS8vIGNhbiBiZSBkaXJlY3RlZCB0byB0aGUgY29ycmVjdCB1cmwuIGxvYWRpbmcgaW50byBhIHRlbXByb3JhcnkKCQkJCS8vIGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCWlmICggcGFnZUVsZW1SZWdleC50ZXN0KCBodG1sICkgJiYKCQkJCQlSZWdFeHAuJDEgJiYKCQkJCQlkYXRhVXJsUmVnZXgudGVzdCggUmVnRXhwLiQxICkgJiYKCQkJCQlSZWdFeHAuJDEgKSB7CgkJCQkJZmlsZVVybCA9ICQubW9iaWxlLnBhdGguZ2V0RmlsZVBhdGgoICQoIjxkaXY+IiArIFJlZ0V4cC4kMSArICI8L2Rpdj4iKS50ZXh0KCkgKTsKCQkJCX0KCgkJCQkvL2RvbnQgdXBkYXRlIHRoZSBiYXNlIHRhZyBpZiB3ZSBhcmUgcHJlZmV0Y2hpbmcKCQkJCWlmICggc2V0dGluZ3MucHJlZmV0Y2ggPT09IHVuZGVmaW5lZCApIHsKCQkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KCBmaWxlVXJsICk7CgkJCQl9CgoJCQkJY29udGVudCA9IHRoaXMuX3BhcnNlKCBodG1sLCBmaWxlVXJsICk7CgoJCQkJdGhpcy5fc2V0TG9hZGVkVGl0bGUoIGNvbnRlbnQsIGh0bWwgKTsKCgkJCQkvLyBBZGQgdGhlIGNvbnRlbnQgcmVmZXJlbmNlIGFuZCB4aHIgdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgoJCQkJLy8gREVQUkVDQVRFRAoJCQkJdHJpZ2dlckRhdGEucGFnZSA9IGNvbnRlbnQ7CgoJCQkJdHJpZ2dlckRhdGEuY29udGVudCA9IGNvbnRlbnQ7CgoJCQkJdHJpZ2dlckRhdGEudG9QYWdlID0gY29udGVudDsKCgkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQlpZiAoIHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImxvYWQiLCB0cmlnZ2VyRGF0YSApLmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyByZXdyaXRlIHNyYyBhbmQgaHJlZiBhdHRycyB0byB1c2UgYSBiYXNlIHVybCBpZiB0aGUgYmFzZSB0YWcgd29uJ3Qgd29yawoJCQkJaWYgKCB0aGlzLl9pc1Jld3JpdGFibGVCYXNlVGFnKCkgJiYgY29udGVudCApIHsKCQkJCQl0aGlzLl9nZXRCYXNlKCkucmV3cml0ZSggZmlsZVVybCwgY29udGVudCApOwoJCQkJfQoKCQkJCXRoaXMuX2luY2x1ZGUoIGNvbnRlbnQsIHNldHRpbmdzICk7CgoJCQkJLy8gRW5oYW5jaW5nIHRoZSBjb250ZW50IG1heSByZXN1bHQgaW4gbmV3IGRpYWxvZ3Mvc3ViIGNvbnRlbnQgYmVpbmcgaW5zZXJ0ZWQKCQkJCS8vIGludG8gdGhlIERPTS4gSWYgdGhlIG9yaWdpbmFsIGFic1VybCByZWZlcnMgdG8gYSBzdWItY29udGVudCwgdGhhdCBpcyB0aGUKCQkJCS8vIHJlYWwgY29udGVudCB3ZSBhcmUgaW50ZXJlc3RlZCBpbi4KCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCWNvbnRlbnQgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJbZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJdGhpcy5faGlkZUxvYWRpbmcoKTsKCQkJCX0KCgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIHNldHRpbmdzLCBjb250ZW50ICk7CgkJCX0sIHRoaXMpOwoJCX0sCgoJCV9sb2FkRGVmYXVsdHM6IHsKCQkJdHlwZTogImdldCIsCgkJCWRhdGE6IHVuZGVmaW5lZCwKCgkJCS8vIERFUFJFQ0FURUQKCQkJcmVsb2FkUGFnZTogZmFsc2UsCgoJCQlyZWxvYWQ6IGZhbHNlLAoKCQkJLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCQlyb2xlOiB1bmRlZmluZWQsCgoJCQlzaG93TG9hZE1zZzogZmFsc2UsCgoJCQkvLyBUaGlzIGRlbGF5IGFsbG93cyBsb2FkcyB0aGF0IHB1bGwgZnJvbSBicm93c2VyIGNhY2hlIHRvCgkJCS8vIG9jY3VyIHdpdGhvdXQgc2hvd2luZyB0aGUgbG9hZGluZyBtZXNzYWdlLgoJCQlsb2FkTXNnRGVsYXk6IDUwCgkJfSwKCgkJbG9hZDogZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkJLy8gVGhpcyBmdW5jdGlvbiB1c2VzIGRlZmVycmVkIG5vdGlmaWNhdGlvbnMgdG8gbGV0IGNhbGxlcnMKCQkJLy8ga25vdyB3aGVuIHRoZSBjb250ZW50IGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCQl2YXIgZGVmZXJyZWQgPSAoIG9wdGlvbnMgJiYgb3B0aW9ucy5kZWZlcnJlZCApIHx8ICQuRGVmZXJyZWQoKSwKCgkJCQkvLyBUaGUgZGVmYXVsdCBsb2FkIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5IHRoZSBjYWxsZXIuCgkJCQlzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5fbG9hZERlZmF1bHRzLCBvcHRpb25zICksCgoJCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgY29udGVudCBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCQljb250ZW50ID0gbnVsbCwKCgkJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIHBhc3NlZCBpbnRvIHRoZSBmdW5jdGlvbi4gVGhpcwoJCQkJLy8gdmVyc2lvbiBvZiB0aGUgVVJMIG1heSBjb250YWluIGRpYWxvZy9zdWJjb250ZW50IHBhcmFtcyBpbiBpdC4KCQkJCWFic1VybCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuX2ZpbmRCYXNlV2l0aERlZmF1bHQoKSApLAoJCQkJZmlsZVVybCwgZGF0YVVybCwgcGJsRXZlbnQsIHRyaWdnZXJEYXRhOwoKCQkJLy8gREVQUkVDQVRFRCByZWxvYWRQYWdlCgkJCXNldHRpbmdzLnJlbG9hZCA9IHNldHRpbmdzLnJlbG9hZFBhZ2U7CgoJCQkvLyBJZiB0aGUgY2FsbGVyIHByb3ZpZGVkIGRhdGEsIGFuZCB3ZSdyZSB1c2luZyAiZ2V0IiByZXF1ZXN0LAoJCQkvLyBhcHBlbmQgdGhlIGRhdGEgdG8gdGhlIFVSTC4KCQkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJnZXQiICkgewoJCQkJYWJzVXJsID0gJC5tb2JpbGUucGF0aC5hZGRTZWFyY2hQYXJhbXMoIGFic1VybCwgc2V0dGluZ3MuZGF0YSApOwoJCQkJc2V0dGluZ3MuZGF0YSA9IHVuZGVmaW5lZDsKCQkJfQoKCQkJLy8gSWYgdGhlIGNhbGxlciBpcyB1c2luZyBhICJwb3N0IiByZXF1ZXN0LCByZWxvYWQgbXVzdCBiZSB0cnVlCgkJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAicG9zdCIgKSB7CgkJCQlzZXR0aW5ncy5yZWxvYWQgPSB0cnVlOwoJCQl9CgoJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIG1pbnVzIGFueSBkaWFsb2cvc3ViY29udGVudCBwYXJhbXMuCgkJCS8vIEluIG90aGVyd29yZHMgdGhlIHJlYWwgVVJMIG9mIHRoZSBjb250ZW50IHRvIGJlIGxvYWRlZC4KCQkJZmlsZVVybCA9IHRoaXMuX2NyZWF0ZUZpbGVVcmwoIGFic1VybCApOwoKCQkJLy8gVGhlIHZlcnNpb24gb2YgdGhlIFVybCBhY3R1YWxseSBzdG9yZWQgaW4gdGhlIGRhdGEtdXJsIGF0dHJpYnV0ZSBvZgoJCQkvLyB0aGUgY29udGVudC4gRm9yIGVtYmVkZGVkIGNvbnRlbnQsIGl0IGlzIGp1c3QgdGhlIGlkIG9mIHRoZSBwYWdlLiBGb3IKCQkJLy8gY29udGVudCB3aXRoaW4gdGhlIHNhbWUgZG9tYWluIGFzIHRoZSBkb2N1bWVudCBiYXNlLCBpdCBpcyB0aGUgc2l0ZQoJCQkvLyByZWxhdGl2ZSBwYXRoLiBGb3IgY3Jvc3MtZG9tYWluIGNvbnRlbnQgKFBob25lIEdhcCBvbmx5KSB0aGUgZW50aXJlCgkJCS8vIGFic29sdXRlIFVybCBpcyB1c2VkIHRvIGxvYWQgdGhlIGNvbnRlbnQuCgkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKTsKCgkJCWNvbnRlbnQgPSB0aGlzLl9maW5kKCBhYnNVcmwgKTsKCgkJCS8vIElmIGl0IGlzbid0IGEgcmVmZXJlbmNlIHRvIHRoZSBmaXJzdCBjb250ZW50IGFuZCByZWZlcnMgdG8gbWlzc2luZwoJCQkvLyBlbWJlZGRlZCBjb250ZW50IHJlamVjdCB0aGUgZGVmZXJyZWQgYW5kIHJldHVybgoJCQlpZiAoIGNvbnRlbnQubGVuZ3RoID09PSAwICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzRW1iZWRkZWRQYWdlKGZpbGVVcmwpICYmCgkJCQkhJC5tb2JpbGUucGF0aC5pc0ZpcnN0UGFnZVVybChmaWxlVXJsKSApIHsKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlCgkJCS8vIFRPRE8gZmlndXJlIG91dCB3aHkgd2UgZG9lIHRoaXMKCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgoJCQkvLyBJZiB0aGUgY29udGVudCB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBSZXNvbHZlIHRoZSBkZWZlcnJyZWQgc28gdGhhdAoJCQkvLyB1c2VycyBjYW4gYmluZCB0byAuZG9uZSBvbiB0aGUgcHJvbWlzZQoJCQlpZiAoIGNvbnRlbnQubGVuZ3RoICYmICFzZXR0aW5ncy5yZWxvYWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlKCBjb250ZW50LCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIHNldHRpbmdzLCBjb250ZW50ICk7CgoJCQkJLy9pZiB3ZSBhcmUgcmVsb2FkaW5nIHRoZSBjb250ZW50IG1ha2Ugc3VyZSB3ZSB1cGRhdGUKCQkJCS8vIHRoZSBiYXNlIGlmIGl0cyBub3QgYSBwcmVmZXRjaAoJCQkJaWYgKCAhc2V0dGluZ3MucHJlZmV0Y2ggKSB7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCh1cmwpOwoJCQkJfQoKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCgkJCXRyaWdnZXJEYXRhID0gewoJCQkJdXJsOiB1cmwsCgkJCQlhYnNVcmw6IGFic1VybCwKCQkJCXRvUGFnZTogdXJsLAoJCQkJcHJldlBhZ2U6IG9wdGlvbnMgPyBvcHRpb25zLmZyb21QYWdlIDogdW5kZWZpbmVkLAoJCQkJZGF0YVVybDogZGF0YVVybCwKCQkJCWRlZmVycmVkOiBkZWZlcnJlZCwKCQkJCW9wdGlvbnM6IHNldHRpbmdzCgkJCX07CgoJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBjb250ZW50LgoJCQlwYmxFdmVudCA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImJlZm9yZWxvYWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCWlmICggcGJsRXZlbnQuZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQlwYmxFdmVudC5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCgkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQl0aGlzLl9zaG93TG9hZGluZyggc2V0dGluZ3MubG9hZE1zZ0RlbGF5ICk7CgkJCX0KCgkJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZS4KCQkJLy8gb25seSByZXNldCBpZiB3ZSBhcmUgbm90IHByZWZldGNoaW5nCgkJCWlmICggc2V0dGluZ3MucHJlZmV0Y2ggPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX2dldEJhc2UoKS5yZXNldCgpOwoJCQl9CgoJCQlpZiAoICEoICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyB8fAoJCQkJJC5tb2JpbGUucGF0aC5pc1NhbWVEb21haW4oJC5tb2JpbGUucGF0aC5kb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoKCQkJLy8gTG9hZCB0aGUgbmV3IGNvbnRlbnQuCgkJCSQuYWpheCh7CgkJCQl1cmw6IGZpbGVVcmwsCgkJCQl0eXBlOiBzZXR0aW5ncy50eXBlLAoJCQkJZGF0YTogc2V0dGluZ3MuZGF0YSwKCQkJCWNvbnRlbnRUeXBlOiBzZXR0aW5ncy5jb250ZW50VHlwZSwKCQkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCQlzdWNjZXNzOiB0aGlzLl9sb2FkU3VjY2VzcyggYWJzVXJsLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MsIGRlZmVycmVkICksCgkJCQllcnJvcjogdGhpcy5fbG9hZEVycm9yKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKQoJCQl9KTsKCgkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJfSwKCgkJX2xvYWRFcnJvcjogZnVuY3Rpb24oIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApIHsKCQkJcmV0dXJuICQucHJveHkoZnVuY3Rpb24oIHhociwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24gKSB7CgkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KCAkLm1vYmlsZS5wYXRoLmdldCgpICk7CgoJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkIGZhaWxlZC4KCQkJCXZhciBwbGZFdmVudCA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImxvYWRmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJLy8gdGhhdCBjYWxsZWQgcHJldmVudERlZmF1bHQoKSwgdG8gcmVzb2x2ZS9yZWplY3QgdGhlCgkJCQkvLyBkZWZlcnJlZCBvYmplY3Qgd2l0aGluIHRoZSB0cmlnZ2VyRGF0YS4KCQkJCWlmICggcGxmRXZlbnQuZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQkJcGxmRXZlbnQuZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCXRoaXMuX3Nob3dFcnJvcigpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQl9LCB0aGlzKTsKCQl9LAoKCQlfZ2V0VHJhbnNpdGlvbkhhbmRsZXI6IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHRyYW5zaXRpb24gKTsKCgkJCS8vZmluZCB0aGUgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIHRyYW5zaXRpb24uIElmIHRoZXJlCgkJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkJLy9jYWxsIHRoZSBoYW5kbGVyIGltbWVkaWF0ZWx5IHRvIGtpY2stb2ZmIHRoZSB0cmFuc2l0aW9uLgoJCQlyZXR1cm4gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIF0gfHwgJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyOwoJCX0sCgoJCS8vIFRPRE8gbW92ZSBpbnRvIHRyYW5zaXRpb24gaGFuZGxlcnM/CgkJX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzOiBmdW5jdGlvbiggdG8sIGZyb20sIHByZWZpeCApIHsKCQkJdmFyIHNhbWVQYWdlID0gZmFsc2U7CgoJCQlwcmVmaXggPSBwcmVmaXggfHwgIiI7CgoJCQkvLyBUT0RPIGRlY2lkZSBpZiB0aGVzZSBldmVudHMgc2hvdWxkIGluIGZhY3QgYmUgdHJpZ2dlcmVkIG9uIHRoZSBjb250YWluZXIKCQkJaWYgKCBmcm9tICkgewoKCQkJCS8vQ2hlY2sgaWYgdGhpcyBpcyBhIHNhbWUgcGFnZSB0cmFuc2l0aW9uIGFuZCB0ZWxsIHRoZSBoYW5kbGVyIGluIHBhZ2UKCQkJCWlmKCB0b1swXSA9PT0gZnJvbVswXSApewoJCQkJCXNhbWVQYWdlID0gdHJ1ZTsKCQkJCX0KCgkJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJCS8vIFRPRE8gZGVwcmVjYXRlIG5leHRQYWdlIGluIGZhdm9yIG9mIG5leHQKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggcHJlZml4ICsgImhpZGUiLCB7CgoJCQkJCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkJCQluZXh0UGFnZTogdG8sCgkJCQkJdG9QYWdlOiB0bywKCQkJCQlwcmV2UGFnZTogZnJvbSwKCQkJCQlzYW1lUGFnZTogc2FtZVBhZ2UKCQkJCX0sIGZyb20gKTsKCQkJfQoKCQkJLy8gVE9ETyBkZXByZWNhdGUgcHJldlBhZ2UgaW4gZmF2b3Igb2YgcHJldmlvdXMKCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCBwcmVmaXggKyAic2hvdyIsIHsKCQkJCXByZXZQYWdlOiBmcm9tIHx8ICQoICIiICksCgkJCQl0b1BhZ2U6IHRvCgkJCX0sIHRvICk7CgkJfSwKCgkJLy8gVE9ETyBtYWtlIHByaXZhdGUgb25jZSBjaGFuZ2UgaGFzIGJlZW4gZGVmaW5lZCBpbiB0aGUgd2lkZ2V0CgkJX2Nzc1RyYW5zaXRpb246IGZ1bmN0aW9uKCB0bywgZnJvbSwgb3B0aW9ucyApIHsKCQkJdmFyIHRyYW5zaXRpb24gPSBvcHRpb25zLnRyYW5zaXRpb24sCgkJCQlyZXZlcnNlID0gb3B0aW9ucy5yZXZlcnNlLAoJCQkJZGVmZXJyZWQgPSBvcHRpb25zLmRlZmVycmVkLAoJCQkJVHJhbnNpdGlvbkhhbmRsZXIsCgkJCQlwcm9taXNlOwoKCQkJdGhpcy5fdHJpZ2dlckNzc1RyYW5zaXRpb25FdmVudHMoIHRvLCBmcm9tLCAiYmVmb3JlIiApOwoKCQkJLy8gVE9ETyBwdXQgdGhpcyBpbiBhIGJpbmRpbmcgdG8gZXZlbnRzICpvdXRzaWRlKiB0aGUgd2lkZ2V0CgkJCXRoaXMuX2hpZGVMb2FkaW5nKCk7CgoJCQlUcmFuc2l0aW9uSGFuZGxlciA9IHRoaXMuX2dldFRyYW5zaXRpb25IYW5kbGVyKCB0cmFuc2l0aW9uICk7CgoJCQlwcm9taXNlID0gKCBuZXcgVHJhbnNpdGlvbkhhbmRsZXIoIHRyYW5zaXRpb24sIHJldmVyc2UsIHRvLCBmcm9tICkgKS50cmFuc2l0aW9uKCk7CgoJCQlwcm9taXNlLmRvbmUoICQucHJveHkoIGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fdHJpZ2dlckNzc1RyYW5zaXRpb25FdmVudHMoIHRvLCBmcm9tICk7CgkJCX0sIHRoaXMgKSk7CgoJCQkvLyBUT0RPIHRlbXBvcmFyeSBhY2NvbW9kYXRpb24gb2YgYXJndW1lbnQgZGVmZXJyZWQKCQkJcHJvbWlzZS5kb25lKGZ1bmN0aW9uKCkgewoJCQkJZGVmZXJyZWQucmVzb2x2ZS5hcHBseSggZGVmZXJyZWQsIGFyZ3VtZW50cyApOwoJCQl9KTsKCQl9LAoKCQlfcmVsZWFzZVRyYW5zaXRpb25Mb2NrOiBmdW5jdGlvbigpIHsKCQkJLy9yZWxlYXNlIHRyYW5zaXRpb24gbG9jayBzbyBuYXZpZ2F0aW9uIGlzIGZyZWUgYWdhaW4KCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQlpZiAoIHBhZ2VUcmFuc2l0aW9uUXVldWUubGVuZ3RoID4gMCApIHsKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UuYXBwbHkoIG51bGwsIHBhZ2VUcmFuc2l0aW9uUXVldWUucG9wKCkgKTsKCQkJfQoJCX0sCgoJCV9yZW1vdmVBY3RpdmVMaW5rQ2xhc3M6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQkJLy9jbGVhciBvdXQgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUKCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCBmb3JjZSApOwoJCX0sCgoJCV9sb2FkVXJsOiBmdW5jdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApIHsKCQkJLy8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlCgkJCS8vIHNpbXBsaWZpZWQgZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zCgkJCS8vIGZyb20gdGhlIGhhc2ggdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeQoJCQkvLyBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbSBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlCgkJCS8vIGxpZmUgY3ljbGUgU2VlIGlzc3VlICM1MDg1CgkJCXNldHRpbmdzLnRhcmdldCA9IHRvOwoJCQlzZXR0aW5ncy5kZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJCXRoaXMubG9hZCggdG8sIHNldHRpbmdzICk7CgoJCQlzZXR0aW5ncy5kZWZlcnJlZC5kb25lKCQucHJveHkoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgY29udGVudCApIHsKCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCgkJCQkvLyBzdG9yZSB0aGUgb3JpZ2luYWwgYWJzb2x1dGUgdXJsIHNvIHRoYXQgaXQgY2FuIGJlIHByb3ZpZGVkCgkJCQkvLyB0byBldmVudHMgaW4gdGhlIHRyaWdnZXJEYXRhIG9mIHRoZSBzdWJzZXF1ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJb3B0aW9ucy5hYnNVcmwgPSB0cmlnZ2VyRGF0YS5hYnNVcmw7CgoJCQkJdGhpcy50cmFuc2l0aW9uKCBjb250ZW50LCB0cmlnZ2VyRGF0YSwgb3B0aW9ucyApOwoJCQl9LCB0aGlzKSk7CgoJCQlzZXR0aW5ncy5kZWZlcnJlZC5mYWlsKCQucHJveHkoZnVuY3Rpb24oLyogdXJsLCBvcHRpb25zICovKSB7CgkJCQl0aGlzLl9yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCXRoaXMuX3JlbGVhc2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiY2hhbmdlZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCV90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZTogZnVuY3Rpb24oIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKSB7CgkJCXZhciByZXR1cm5FdmVudHM7CgoJCQl0cmlnZ2VyRGF0YS5wcmV2UGFnZSA9IHRoaXMuYWN0aXZlUGFnZTsKCQkJJC5leHRlbmQoIHRyaWdnZXJEYXRhLCB7CgkJCQl0b1BhZ2U6IHRvLAoJCQkJb3B0aW9uczogc2V0dGluZ3MKCQkJfSk7CgoJCQkvLyBOT1RFOiBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgdGFyZ2V0IGFzIHRoZSBkYXRhVXJsIHZhbHVlIHdpbGwgYmUKCQkJLy8gc2ltcGxpZmllZCBlZywgcmVtb3ZpbmcgdWktc3RhdGUsIGFuZCByZW1vdmluZyBxdWVyeSBwYXJhbXMgZnJvbQoJCQkvLyB0aGUgaGFzaCB0aGlzIGlzIHNvIHRoYXQgdXNlcnMgd2hvIHdhbnQgdG8gdXNlIHF1ZXJ5IHBhcmFtcyBoYXZlCgkJCS8vIGFjY2VzcyB0byB0aGVtIGluIHRoZSBldmVudCBiaW5kaW5ncyBmb3IgdGhlIHBhZ2UgbGlmZSBjeWNsZQoJCQkvLyBTZWUgaXNzdWUgIzUwODUKCQkJaWYgKCAkLnR5cGUodG8pID09PSAic3RyaW5nIiApIHsKCQkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBzdHJpbmcgc2ltcGx5IGNvbnZlcnQgaXQKCQkJCXRyaWdnZXJEYXRhLmFic1VybCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB0bywgdGhpcy5fZmluZEJhc2VXaXRoRGVmYXVsdCgpICk7CgkJCX0gZWxzZSB7CgkJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgalF1ZXJ5IG9iamVjdCBncmFiIHRoZSBhYnNvbHV0ZSB1cmwgc3RvcmVkCgkJCQkvLyBpbiB0aGUgbG9hZFBhZ2UgY2FsbGJhY2sgd2hlcmUgaXQgZXhpc3RzCgkJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSBzZXR0aW5ncy5hYnNVcmw7CgkJCX0KCgkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBjaGFuZ2UgdGhlIGN1cnJlbnQgcGFnZS4KCQkJcmV0dXJuRXZlbnRzID0gdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiYmVmb3JlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCgkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQlpZiAoIHJldHVybkV2ZW50cy5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSB8fAoJCQkJcmV0dXJuRXZlbnRzLmRlcHJlY2F0ZWRFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJY2hhbmdlOiBmdW5jdGlvbiggdG8sIG9wdGlvbnMgKSB7CgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggYXJndW1lbnRzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoJCQkJdHJpZ2dlckRhdGEgPSB7fTsKCgkJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJCXNldHRpbmdzLmZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UgfHwgdGhpcy5hY3RpdmVQYWdlOwoKCQkJLy8gaWYgdGhlIHBhZ2UgYmVmb3JlY2hhbmdlIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQlpZiAoICF0aGlzLl90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZSh0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvIGluCgkJCS8vIHRoZSB0cmlnZ2VyIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0byBpcwoJCQkvLyB1cGRhdGVkLiBXZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgd2hldGhlciBpdCBpcyBhIHN0cmluZywKCQkJLy8gYmVjYXVzZSBhbiBvYmplY3QgY2FuIGFsc28gYmUgcmVwbGFjZWQgYnkgYSBzdHJpbmcKCQkJdG8gPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgoJCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCQkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkJCXRoaXMuX2xvYWRVcmwoIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMudHJhbnNpdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApOwoJCQl9CgkJfSwKCgkJdHJhbnNpdGlvbjogZnVuY3Rpb24oIHRvUGFnZSwgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQl2YXIgZnJvbVBhZ2UsIHVybCwgcGFnZVVybCwgZmlsZVVybCwKCQkJCWFjdGl2ZSwgYWN0aXZlSXNJbml0aWFsUGFnZSwKCQkJCWhpc3RvcnlEaXIsIHBhZ2VUaXRsZSwgaXNEaWFsb2csCgkJCQlhbHJlYWR5VGhlcmUsIG5ld1BhZ2VUaXRsZSwKCQkJCXBhcmFtcywJY3NzVHJhbnNpdGlvbkRlZmVycmVkLAoJCQkJYmVmb3JlVHJhbnNpdGlvbjsKCgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCS8vIG1ha2Ugc3VyZSB0byBvbmx5IHF1ZXVlIHRoZSB0byBhbmQgc2V0dGluZ3MgdmFsdWVzIHNvIHRoZSBhcmd1bWVudHMKCQkJCS8vIHdvcmsgd2l0aCBhIGNhbGwgdG8gdGhlIGNoYW5nZSBtZXRob2QKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggW3RvUGFnZSwgc2V0dGluZ3NdICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIERFUFJFQ0FURUQgLSB0aGlzIGNhbGwgb25seSwgaW4gZmF2b3Igb2YgdGhlIGJlZm9yZSB0cmFuc2l0aW9uCgkJCS8vIGlmIHRoZSBwYWdlIGJlZm9yZWNoYW5nZSBkZWZhdWx0IGlzIHByZXZlbnRlZCByZXR1cm4gZWFybHkKCQkJaWYgKCAhdGhpcy5fdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2UodG9QYWdlLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl0cmlnZ2VyRGF0YS5wcmV2UGFnZSA9IHNldHRpbmdzLmZyb21QYWdlOwoJCQkvLyBpZiB0aGUgKGNvbnRlbnR8cGFnZSliZWZvcmV0cmFuc2l0aW9uIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQkvLyBOb3RlLCB3ZSBoYXZlIHRvIGNoZWNrIGZvciBib3RoIHRoZSBkZXByZWNhdGVkIGFuZCBuZXcgZXZlbnRzCgkJCWJlZm9yZVRyYW5zaXRpb24gPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJiZWZvcmV0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJaWYgKGJlZm9yZVRyYW5zaXRpb24uZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQliZWZvcmVUcmFuc2l0aW9uLmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkJLy8gc3VyZSBzZXR0aW5ncy5kYXRhVXJsIGlzIHNldCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXJsLiBUaGlzIGFsbG93cwoJCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJCWlmICggdG9QYWdlWyAwIF0gPT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICYmICFzZXR0aW5ncy5kYXRhVXJsICkgewoJCQkJc2V0dGluZ3MuZGF0YVVybCA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaDsKCQkJfQoKCQkJLy8gVGhlIGNhbGxlciBwYXNzZWQgdXMgYSByZWFsIHBhZ2UgRE9NIGVsZW1lbnQuIFVwZGF0ZSBvdXIKCQkJLy8gaW50ZXJuYWwgc3RhdGUgYW5kIHRoZW4gdHJpZ2dlciBhIHRyYW5zaXRpb24gdG8gdGhlIHBhZ2UuCgkJCWZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2U7CgkJCXVybCA9ICggc2V0dGluZ3MuZGF0YVVybCAmJiAkLm1vYmlsZS5wYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoc2V0dGluZ3MuZGF0YVVybCkgKSB8fAoJCQkJdG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgoJCQkvLyBUaGUgcGFnZVVybCB2YXIgaXMgdXN1YWxseSB0aGUgc2FtZSBhcyB1cmwsIGV4Y2VwdCB3aGVuIHVybCBpcyBvYnNjdXJlZAoJCQkvLyBhcyBhIGRpYWxvZyB1cmwuIHBhZ2VVcmwgYWx3YXlzIGNvbnRhaW5zIHRoZSBmaWxlIHBhdGgKCQkJcGFnZVVybCA9IHVybDsKCQkJZmlsZVVybCA9ICQubW9iaWxlLnBhdGguZ2V0RmlsZVBhdGgoIHVybCApOwoJCQlhY3RpdmUgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpOwoJCQlhY3RpdmVJc0luaXRpYWxQYWdlID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMDsKCQkJaGlzdG9yeURpciA9IDA7CgkJCXBhZ2VUaXRsZSA9IGRvY3VtZW50LnRpdGxlOwoJCQlpc0RpYWxvZyA9ICggc2V0dGluZ3Mucm9sZSA9PT0gImRpYWxvZyIgfHwKCQkJCXRvUGFnZS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImRpYWxvZyIgKSAmJgoJCQkJdG9QYWdlLmpxbURhdGEoICJkaWFsb2ciICkgIT09IHRydWU7CgoJCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCQkvLyBhcmUgdGhlIHNhbWUgZWxlbWVudCwgYnV0IGZvbGtzIHRoYXQgZ2VuZXJhdGUgY29udGVudAoJCQkvLyBtYW51YWxseS9keW5hbWljYWxseSBhbmQgcmV1c2UgcGFnZXMgd2FudCB0byBiZSBhYmxlIHRvIHRyYW5zaXRpb24gdG8KCQkJLy8gdGhlIHNhbWUgcGFnZS4gVG8gYWxsb3cgdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0CgkJCS8vIHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uIHRvIHRydWUsICpPUiosIHBhc3MgaXQgaW4gYXMgYW4KCQkJLy8gb3B0aW9uIHdoZW4gdGhleSBtYW51YWxseSBjYWxsIGNoYW5nZVBhZ2UoKS4gSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQKCQkJLy8gb3VyIGRlZmF1bHQgdHJhbnNpdGlvbiBhbmltYXRpb25zIGFzc3VtZSB0aGF0IHRoZSBmb3JtUGFnZSBhbmQgdG9QYWdlCgkJCS8vIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuIEl0IGlzIHVwIHRvCgkJCS8vIHRoZSBkZXZlbG9wZXIgdGhhdCB0dXJucyBvbiB0aGUgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb25hIG9wdGlvbiB0bwoJCQkvLyBlaXRoZXIgdHVybiBvZmYgdHJhbnNpdGlvbiBhbmltYXRpb25zLCBvciBtYWtlIHN1cmUgdGhhdCBhbiBhcHByb3ByaWF0ZQoJCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCQlpZiAoIGZyb21QYWdlICYmIGZyb21QYWdlWzBdID09PSB0b1BhZ2VbMF0gJiYKCQkJCSFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJ0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgoJCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUKCQkJCS8vIHVybEhpc3RvcnkgaW4gc3luYyB3aXRoIHRoZSBoYXNoIGNoYW5nZXMKCQkJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5kaXJlY3QoeyB1cmw6IHVybCB9KTsKCQkJCX0KCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYWdlIHdlIGFyZSBnaXZlbiBoYXMgYWxyZWFkeSBiZWVuIGVuaGFuY2VkLgoJCQl0b1BhZ2UucGFnZSh7IHJvbGU6IHNldHRpbmdzLnJvbGUgfSk7CgoJCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0bwoJCQkvLyBzZWUgaWYgdGhlIHBhZ2UgaXMgYWxyZWFkeSB3aXRoaW4gdGhlIHVybEhpc3Rvcnkgc3RhY2suIElmIHNvLCB3ZSdsbAoJCQkvLyBhc3N1bWUgdGhlIHVzZXIgaGl0IHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUKCQkJLy8gdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCWhpc3RvcnlEaXIgPSBzZXR0aW5ncy5kaXJlY3Rpb24gPT09ICJiYWNrIiA/IC0xIDogMTsKCQkJfQoKCQkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4KCQkJLy8gICAgICAgICAgICBJbnN0ZWFkLCB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkKCQkJLy8gICAgICAgICAgICBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZSB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMKCQkJLy8gICAgICAgICAgICBwb2ludC4KCQkJLy8gV3JhcCB0aGlzIGluIGEgdHJ5L2NhdGNoIGJsb2NrIHNpbmNlIElFOSB0aHJvdyAiVW5zcGVjaWZpZWQgZXJyb3IiIGlmCgkJCS8vIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQkJdHJ5IHsKCQkJCWlmICggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJgoJCQkJCWRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gImJvZHkiICkgewoKCQkJCQkkKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICkuYmx1cigpOwoJCQkJfSBlbHNlIHsKCQkJCQkkKCAiaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzLCBzZWxlY3Q6Zm9jdXMiICkuYmx1cigpOwoJCQkJfQoJCQl9IGNhdGNoKCBlICkge30KCgkJCS8vIFJlY29yZCB3aGV0aGVyIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3Rvcnkgd2hlcmUgYSBkaWFsb2cgdXNlZCB0byBiZSAtCgkJCS8vIGlmIHNvLCBkbyBub3QgYWRkIGEgbmV3IGhpc3RvcnkgZW50cnkgYW5kIGRvIG5vdCBjaGFuZ2UgdGhlIGhhc2ggZWl0aGVyCgkJCWFscmVhZHlUaGVyZSA9IGZhbHNlOwoKCQkJLy8gSWYgd2UncmUgZGlzcGxheWluZyB0aGUgcGFnZSBhcyBhIGRpYWxvZywgd2UgZG9uJ3Qgd2FudCB0aGUgdXJsCgkJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCQkvLyB0byBhcHBlbmQgdGhlIGRpYWxvZ0hhc2hLZXkgdG8gdGhlIHVybCBvZiB0aGUgY3VycmVudCBwYWdlLgoJCQlpZiAoIGlzRGlhbG9nICYmIGFjdGl2ZSApIHsKCQkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlCgkJCQkvLyBzaG91bGQgYmUgYW4gZW1wdHkgc3RyaW5nLiBNb3ZpbmcgdGhlIHVuZGVmaW5lZCAtPiBlbXB0eSBzdHJpbmcgYmFjawoJCQkJLy8gaW50byB1cmxIaXN0b3J5LmFkZE5ldyBzZWVtZWQgaW1wcnVkZW50IGdpdmVuIHVuZGVmaW5lZCBiZXR0ZXIKCQkJCS8vIHJlcHJlc2VudHMgdGhlIHVybCBzdGF0ZQoKCQkJCS8vIElmIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3RvcnkgdGhhdCBvbmNlIGJlbG9uZ2VkIHRvIGEgZGlhbG9nLCByZXVzZQoJCQkJLy8gdGhpcyBzdGF0ZSB3aXRob3V0IGFkZGluZyB0byB1cmxIaXN0b3J5IGFuZCB3aXRob3V0IG1vZGlmeWluZyB0aGUKCQkJCS8vIGhhc2guIEhvd2V2ZXIsIGlmIGEgZGlhbG9nIGlzIGFscmVhZHkgZGlzcGxheWVkIGF0IHRoaXMgcG9pbnQsIGFuZAoJCQkJLy8gd2UncmUgYWJvdXQgdG8gZGlzcGxheSBhbm90aGVyIGRpYWxvZywgdGhlbiB3ZSBtdXN0IGFkZCBhbm90aGVyIGhhc2gKCQkJCS8vIGFuZCBoaXN0b3J5IGVudHJ5IG9uIHRvcCBzbyB0aGF0IG9uZSBtYXkgbmF2aWdhdGUgYmFjayB0byB0aGUKCQkJCS8vIG9yaWdpbmFsIGRpYWxvZwoJCQkJaWYgKCBhY3RpdmUudXJsICYmCgkJCQkJYWN0aXZlLnVybC5pbmRleE9mKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgPiAtMSAmJgoJCQkJCXRoaXMuYWN0aXZlUGFnZSAmJgoJCQkJCSF0aGlzLmFjdGl2ZVBhZ2UuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgJiYKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApIHsKCgkJCQkJc2V0dGluZ3MuY2hhbmdlSGFzaCA9IGZhbHNlOwoJCQkJCWFscmVhZHlUaGVyZSA9IHRydWU7CgkJCQl9CgoJCQkJLy8gTm9ybWFsbHksIHdlIHRhY2sgb24gYSBkaWFsb2cgaGFzaCBrZXksIGJ1dCBpZiB0aGlzIGlzIHRoZSBsb2NhdGlvbgoJCQkJLy8gb2YgYSBzdGFsZSBkaWFsb2csIHdlIHJldXNlIHRoZSBVUkwgZnJvbSB0aGUgZW50cnkKCQkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApOwoKCQkJCS8vIGFjY291bnQgZm9yIGFic29sdXRlIHVybHMgaW5zdGVhZCBvZiBqdXN0IHJlbGF0aXZlIHVybHMgdXNlIGFzIGhhc2hlcwoJCQkJaWYgKCAhYWxyZWFkeVRoZXJlICYmIHVybC5pbmRleE9mKCIjIikgPiAtMSApIHsKCQkJCQl1cmwgKz0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJCX0gZWxzZSB7CgkJCQkJdXJsICs9ICIjIiArICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJCQl9CgkJCX0KCgkJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkJLy8gSWYgdGhpcyBpcyBhIGRlZXAtbGluayBvciBhIHJlbG9hZCAoIGFjdGl2ZSA9PT0gdW5kZWZpbmVkICkgdGhlbiBqdXN0CgkJCS8vIHVzZSBwYWdlVGl0bGUKCQkJbmV3UGFnZVRpdGxlID0gKCAhYWN0aXZlICkgPyBwYWdlVGl0bGUgOiB0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApIHx8CgkJCQl0b1BhZ2UuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maW5kKCAiLnVpLXRpdGxlIiApLnRleHQoKTsKCQkJaWYgKCAhIW5ld1BhZ2VUaXRsZSAmJiBwYWdlVGl0bGUgPT09IGRvY3VtZW50LnRpdGxlICkgewoJCQkJcGFnZVRpdGxlID0gbmV3UGFnZVRpdGxlOwoJCQl9CgkJCWlmICggIXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCQl0b1BhZ2UuanFtRGF0YSggInRpdGxlIiwgcGFnZVRpdGxlICk7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgdHJhbnNpdGlvbiBkZWZpbmVkLgoJCQlzZXR0aW5ncy50cmFuc2l0aW9uID0gc2V0dGluZ3MudHJhbnNpdGlvbiB8fAoJCQkJKCAoIGhpc3RvcnlEaXIgJiYgIWFjdGl2ZUlzSW5pdGlhbFBhZ2UgKSA/IGFjdGl2ZS50cmFuc2l0aW9uIDogdW5kZWZpbmVkICkgfHwKCQkJCSggaXNEaWFsb2cgPyAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiA6ICQubW9iaWxlLmRlZmF1bHRQYWdlVHJhbnNpdGlvbiApOwoKCQkJLy9hZGQgcGFnZSB0byBoaXN0b3J5IHN0YWNrIGlmIGl0J3Mgbm90IGJhY2sgb3IgZm9yd2FyZAoJCQlpZiAoICFoaXN0b3J5RGlyICYmIGFscmVhZHlUaGVyZSApIHsKCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCkucGFnZVVybCA9IHBhZ2VVcmw7CgkJCX0KCgkJCS8vIFNldCB0aGUgbG9jYXRpb24gaGFzaC4KCQkJaWYgKCB1cmwgJiYgIXNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoKCQkJCS8vIHJlYnVpbGRpbmcgdGhlIGhhc2ggaGVyZSBzaW5jZSB3ZSBsb29zZSBpdCBlYXJsaWVyIG9uCgkJCQkvLyBUT0RPIHByZXNlcnZlIHRoZSBvcmlnaW5hbGx5IHBhc3NlZCBpbiBwYXRoCgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggdXJsICkgJiYgdXJsLmluZGV4T2YoICIjIiApIDwgMCApIHsKCQkJCQl1cmwgPSAiIyIgKyB1cmw7CgkJCQl9CgoJCQkJLy8gVE9ETyB0aGUgcHJvcGVydHkgbmFtZXMgaGVyZSBhcmUganVzdCBzaWxseQoJCQkJcGFyYW1zID0gewoJCQkJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiwKCQkJCQl0cmFuc2l0aW9uOiBzZXR0aW5ncy50cmFuc2l0aW9uLAoJCQkJCXRpdGxlOiBwYWdlVGl0bGUsCgkJCQkJcGFnZVVybDogcGFnZVVybCwKCQkJCQlyb2xlOiBzZXR0aW5ncy5yb2xlCgkJCQl9OwoKCQkJCWlmICggc2V0dGluZ3MuY2hhbmdlSGFzaCAhPT0gZmFsc2UgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwgcGFyYW1zLCB0cnVlKTsKCQkJCX0gZWxzZSBpZiAoIHRvUGFnZVsgMCBdICE9PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFkZCggdXJsLCBwYXJhbXMgKTsKCQkJCX0KCQkJfQoKCQkJLy9zZXQgcGFnZSB0aXRsZQoJCQlkb2N1bWVudC50aXRsZSA9IHBhZ2VUaXRsZTsKCgkJCS8vc2V0ICJ0b1BhZ2UiIGFzIGFjdGl2ZVBhZ2UgZGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCQkkLm1vYmlsZS5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkJLy9uZXcgd2F5IHRvIGhhbmRsZSBhY3RpdmVQYWdlCgkJCXRoaXMuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJCS8vIElmIHdlJ3JlIG5hdmlnYXRpbmcgYmFjayBpbiB0aGUgVVJMIGhpc3RvcnksIHNldCByZXZlcnNlIGFjY29yZGluZ2x5LgoJCQlzZXR0aW5ncy5yZXZlcnNlID0gc2V0dGluZ3MucmV2ZXJzZSB8fCBoaXN0b3J5RGlyIDwgMDsKCgkJCWNzc1RyYW5zaXRpb25EZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJCXRoaXMuX2Nzc1RyYW5zaXRpb24odG9QYWdlLCBmcm9tUGFnZSwgewoJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCXJldmVyc2U6IHNldHRpbmdzLnJldmVyc2UsCgkJCQlkZWZlcnJlZDogY3NzVHJhbnNpdGlvbkRlZmVycmVkCgkJCX0pOwoKCQkJY3NzVHJhbnNpdGlvbkRlZmVycmVkLmRvbmUoJC5wcm94eShmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSwgYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQkkLm1vYmlsZS5yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoKTsKCgkJCQkvL2lmIHRoZXJlJ3MgYSBkdXBsaWNhdGVDYWNoZWRQYWdlLCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NIG5vdyB0aGF0IGl0J3MgaGlkZGVuCgkJCQlpZiAoIHNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgKSB7CgkJCQkJc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZS5yZW1vdmUoKTsKCQkJCX0KCgkJCQkvLyBkZXNwaXRlIHZpc2liaWxpdHk6IGhpZGRlbiBhZGRyZXNzZXMgaXNzdWUgIzI5NjUKCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMjk2NQoJCQkJaWYgKCAhYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0b1BhZ2UgKTsKCQkJCX0KCgkJCQl0aGlzLl9yZWxlYXNlVHJhbnNpdGlvbkxvY2soKTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggInRyYW5zaXRpb24iLCB0cmlnZ2VyRGF0YSApOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCS8vIGRldGVybWluZSB0aGUgY3VycmVudCBiYXNlIHVybAoJCV9maW5kQmFzZVdpdGhEZWZhdWx0OiBmdW5jdGlvbigpIHsKCQkJdmFyIGNsb3Nlc3RCYXNlID0gKCB0aGlzLmFjdGl2ZVBhZ2UgJiYKCQkJJC5tb2JpbGUuZ2V0Q2xvc2VzdEJhc2VVcmwoIHRoaXMuYWN0aXZlUGFnZSApICk7CgkJcmV0dXJuIGNsb3Nlc3RCYXNlIHx8ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgkJfQoJfSk7CgoJLy8gVGhlIGZvbGxvd2luZyBoYW5kbGVycyBzaG91bGQgYmUgYm91bmQgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgYmVlbiB0cmlnZ2VyZWQKCS8vIHRoZSBmb2xsb3dpbmcgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW4gdGhlIGluaXQgZmlsZQoJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkvL3RoZXNlIHZhcmlhYmxlcyBtYWtlIGFsbCBwYWdlIGNvbnRhaW5lcnMgdXNlIHRoZSBzYW1lIHF1ZXVlIGFuZCBvbmx5IG5hdmlnYXRlIG9uZSBhdCBhIHRpbWUKCS8vIHF1ZXVlIHRvIGhvbGQgc2ltdWx0YW5pb3VzIHBhZ2UgdHJhbnNpdGlvbnMKCXZhciBwYWdlVHJhbnNpdGlvblF1ZXVlID0gW10sCgoJCS8vIGluZGljYXRlcyB3aGV0aGVyIG9yIG5vdCBwYWdlIGlzIGluIHByb2Nlc3Mgb2YgdHJhbnNpdGlvbmluZwoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCQkvLyByZXNvbHZlZCBvbiBkb21yZWFkeQoJdmFyIGRvbXJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCksCgoJCS8vIHJlc29sdmVkIGFuZCBudWxsZWQgb24gd2luZG93LmxvYWQoKQoJCWxvYWREZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJLy8gZnVuY3Rpb24gdGhhdCByZXNvbHZlcyB0aGUgYWJvdmUgZGVmZXJyZWQKCQlwYWdlSXNGdWxseUxvYWRlZCA9IGZ1bmN0aW9uKCkgewoKCQkJLy8gUmVzb2x2ZSBhbmQgbnVsbCB0aGUgZGVmZXJyZWQKCQkJbG9hZERlZmVycmVkLnJlc29sdmUoKTsKCQkJbG9hZERlZmVycmVkID0gbnVsbDsKCQl9LAoKCQlkb2N1bWVudFVybCA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRVcmwsCgoJCS8vIHVzZWQgdG8gdHJhY2sgbGFzdCB2Y2xpY2tlZCBlbGVtZW50IHRvIG1ha2Ugc3VyZSBpdHMgdmFsdWUgaXMgYWRkZWQgdG8gZm9ybSBkYXRhCgkJJGxhc3RWQ2xpY2tlZCA9IG51bGw7CgoJLyogRXZlbnQgQmluZGluZ3MgLSBoYXNoY2hhbmdlLCBzdWJtaXQsIGFuZCBjbGljayAqLwoJZnVuY3Rpb24gZmluZENsb3Nlc3RMaW5rKCBlbGUgKQl7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCS8vIExvb2sgZm9yIHRoZSBjbG9zZXN0IGVsZW1lbnQgd2l0aCBhIG5vZGVOYW1lIG9mICJhIi4KCQkJLy8gTm90ZSB0aGF0IHdlIGFyZSBjaGVja2luZyBpZiB3ZSBoYXZlIGEgdmFsaWQgbm9kZU5hbWUKCQkJLy8gYmVmb3JlIGF0dGVtcHRpbmcgdG8gYWNjZXNzIGl0LiBUaGlzIGlzIGJlY2F1c2UgdGhlCgkJCS8vIG5vZGUgd2UgZ2V0IGNhbGxlZCB3aXRoIGNvdWxkIGhhdmUgb3JpZ2luYXRlZCBmcm9tIHdpdGhpbgoJCQkvLyBhbiBlbWJlZGRlZCBTVkcgZG9jdW1lbnQgd2hlcmUgc29tZSBzeW1ib2wgaW5zdGFuY2UgZWxlbWVudHMKCQkJLy8gZG9uJ3QgaGF2ZSBub2RlTmFtZSBkZWZpbmVkIG9uIHRoZW0sIG9yIHN0cmluZ3MgYXJlIG9mIHR5cGUKCQkJLy8gU1ZHQW5pbWF0ZWRTdHJpbmcuCgkJCWlmICggKCB0eXBlb2YgZWxlLm5vZGVOYW1lID09PSAic3RyaW5nIiApICYmIGVsZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiYSIgKSB7CgkJCQlicmVhazsKCQkJfQoJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIGVsZTsKCX0KCgkkLm1vYmlsZS5sb2FkUGFnZSA9IGZ1bmN0aW9uKCB1cmwsIG9wdHMgKSB7CgkJdmFyIGNvbnRhaW5lcjsKCgkJb3B0cyA9IG9wdHMgfHwge307CgkJY29udGFpbmVyID0gKCBvcHRzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkvLyBjcmVhdGUgdGhlIGRlZmVycmVkIHRoYXQgd2lsbCBiZSBzdXBwbGllZCB0byBsb2FkUGFnZSBjYWxsZXJzCgkJLy8gYW5kIHJlc29sdmVkIGJ5IHRoZSBjb250ZW50IHdpZGdldCdzIGxvYWQgbWV0aG9kCgkJb3B0cy5kZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJLy8gUHJlZmVycmluZyB0byBhbGxvdyBleGNlcHRpb25zIGZvciB1bmluaXRpYWxpemVkIG9wdHMucGFnZUNvbnRhaW5lcgoJCS8vIHdpZGdldHMgc28gd2Uga25vdyBpZiB3ZSBuZWVkIHRvIGZvcmNlIGluaXQgaGVyZSBmb3IgdXNlcnMKCQljb250YWluZXIucGFnZWNvbnRhaW5lciggImxvYWQiLCB1cmwsIG9wdHMgKTsKCgkJLy8gcHJvdmlkZSB0aGUgZGVmZXJyZWQKCQlyZXR1cm4gb3B0cy5kZWZlcnJlZC5wcm9taXNlKCk7Cgl9OwoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgoJLyogaW50ZXJuYWwgdXRpbGl0eSBmdW5jdGlvbnMgKi8KCgkvLyBOT1RFIElzc3VlICM0OTUwIEFuZHJvaWQgcGhvbmVnYXAgZG9lc24ndCBuYXZpZ2F0ZSBiYWNrIHByb3Blcmx5CgkvLyAgICAgIHdoZW4gYSBmdWxsIHBhZ2UgcmVmcmVzaCBoYXMgdGFrZW4gcGxhY2UuIEl0IGFwcGVhcnMgdGhhdCBoYXNoY2hhbmdlCgkvLyAgICAgIGFuZCByZXBsYWNlc3RhdGUgaGlzdG9yeSBhbHRlcmF0aW9ucyB3b3JrIGZpbmUgYnV0IHdlIG5lZWQgdG8gc3VwcG9ydAoJLy8gICAgICBib3RoIGZvcm1zIG9mIGhpc3RvcnkgdHJhdmVyc2FsIGluIG91ciBjb2RlIHRoYXQgdXNlcyBiYWNrd2FyZCBoaXN0b3J5CgkvLyAgICAgIG1vdmVtZW50CgkkLm1vYmlsZS5iYWNrID0gZnVuY3Rpb24oKSB7CgkJdmFyIG5hdiA9IHdpbmRvdy5uYXZpZ2F0b3I7CgoJCS8vIGlmIHRoZSBzZXR0aW5nIGlzIG9uIGFuZCB0aGUgbmF2aWdhdG9yIG9iamVjdCBpcwoJCS8vIGF2YWlsYWJsZSB1c2UgdGhlIHBob25lZ2FwIG5hdmlnYXRpb24gY2FwYWJpbGl0eQoJCWlmICggdGhpcy5waG9uZWdhcE5hdmlnYXRpb25FbmFibGVkICYmCgkJCW5hdiAmJgoJCQluYXYuYXBwICYmCgkJCW5hdi5hcHAuYmFja0hpc3RvcnkgKSB7CgkJCW5hdi5hcHAuYmFja0hpc3RvcnkoKTsKCQl9IGVsc2UgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnBhZ2Vjb250YWluZXIoICJiYWNrIiApOwoJCX0KCX07CgoJLy8gRGlyZWN0IGZvY3VzIHRvIHRoZSBwYWdlIHRpdGxlLCBvciBvdGhlcndpc2UgZmlyc3QgZm9jdXNhYmxlIGVsZW1lbnQKCSQubW9iaWxlLmZvY3VzUGFnZSA9IGZ1bmN0aW9uICggcGFnZSApIHsKCQl2YXIgYXV0b2ZvY3VzID0gcGFnZS5maW5kKCAiW2F1dG9mb2N1c10iICksCgkJCXBhZ2VUaXRsZSA9IHBhZ2UuZmluZCggIi51aS10aXRsZTplcSgwKSIgKTsKCgkJaWYgKCBhdXRvZm9jdXMubGVuZ3RoICkgewoJCQlhdXRvZm9jdXMuZm9jdXMoKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBwYWdlVGl0bGUubGVuZ3RoICkgewoJCQlwYWdlVGl0bGUuZm9jdXMoKTsKCQl9IGVsc2V7CgkJCXBhZ2UuZm9jdXMoKTsKCQl9Cgl9OwoKCS8vIE5vLW9wIGltcGxlbWVudGF0aW9uIG9mIHRyYW5zaXRpb24gZGVncmFkYXRpb24KCSQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gfHwgZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJcmV0dXJuIHRyYW5zaXRpb247Cgl9OwoKCS8vIEV4cG9zZWQgJC5tb2JpbGUgbWV0aG9kcwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UgPSBmdW5jdGlvbiggdG8sIG9wdGlvbnMgKSB7CgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5wYWdlY29udGFpbmVyKCAiY2hhbmdlIiwgdG8sIG9wdGlvbnMgKTsKCX07CgoJJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cyA9IHsKCQl0cmFuc2l0aW9uOiB1bmRlZmluZWQsCgkJcmV2ZXJzZTogZmFsc2UsCgkJY2hhbmdlSGFzaDogdHJ1ZSwKCQlmcm9tSGFzaENoYW5nZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJZHVwbGljYXRlQ2FjaGVkUGFnZTogdW5kZWZpbmVkLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlzaG93TG9hZE1zZzogdHJ1ZSwgLy9sb2FkaW5nIG1lc3NhZ2Ugc2hvd3MgYnkgZGVmYXVsdCB3aGVuIHBhZ2VzIGFyZSBiZWluZyBmZXRjaGVkIGR1cmluZyBjaGFuZ2VQYWdlCgkJZGF0YVVybDogdW5kZWZpbmVkLAoJCWZyb21QYWdlOiB1bmRlZmluZWQsCgkJYWxsb3dTYW1lUGFnZVRyYW5zaXRpb246IGZhbHNlCgl9OwoKCSQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzID0gZnVuY3Rpb24oKSB7CgkJdmFyIGdldEFqYXhGb3JtRGF0YSA9IGZ1bmN0aW9uKCAkZm9ybSwgY2FsY3VsYXRlT25seSApIHsKCQkJdmFyIHVybCwgcmV0ID0gdHJ1ZSwgZm9ybURhdGEsIHZjbGlja2VkTmFtZSwgbWV0aG9kOwoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCB8fAoJCQkJCS8vIHRlc3QgdGhhdCB0aGUgZm9ybSBpcywgaXRzZWxmLCBhamF4IGZhbHNlCgkJCQkJJGZvcm0uaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8CgkJCQkJLy8gdGVzdCB0aGF0ICQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCBhbmQKCQkJCQkvLyB0aGUgZm9ybSBvciBvbmUgb2YgaXQncyBwYXJlbnRzIGlzIGFqYXg9ZmFsc2UKCQkJCQkhJGZvcm0uanFtSGlqYWNrYWJsZSgpLmxlbmd0aCB8fAoJCQkJCSRmb3JtLmF0dHIoICJ0YXJnZXQiICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXVybCA9ICggJGxhc3RWQ2xpY2tlZCAmJiAkbGFzdFZDbGlja2VkLmF0dHIoICJmb3JtYWN0aW9uIiApICkgfHwKCQkJCSRmb3JtLmF0dHIoICJhY3Rpb24iICk7CgkJCW1ldGhvZCA9ICggJGZvcm0uYXR0ciggIm1ldGhvZCIgKSB8fCAiZ2V0IiApLnRvTG93ZXJDYXNlKCk7CgoJCQkvLyBJZiBubyBhY3Rpb24gaXMgc3BlY2lmaWVkLCBicm93c2VycyBkZWZhdWx0IHRvIHVzaW5nIHRoZQoJCQkvLyBVUkwgb2YgdGhlIGRvY3VtZW50IGNvbnRhaW5pbmcgdGhlIGZvcm0uIFNpbmNlIHdlIGR5bmFtaWNhbGx5CgkJCS8vIHB1bGwgaW4gcGFnZXMgZnJvbSBleHRlcm5hbCBkb2N1bWVudHMsIHRoZSBmb3JtIHNob3VsZCBzdWJtaXQKCQkJLy8gdG8gdGhlIFVSTCBmb3IgdGhlIHNvdXJjZSBkb2N1bWVudCBvZiB0aGUgcGFnZSBjb250YWluaW5nCgkJCS8vIHRoZSBmb3JtLgoJCQlpZiAoICF1cmwgKSB7CgkJCQkvLyBHZXQgdGhlIEBkYXRhLXVybCBmb3IgdGhlIHBhZ2UgY29udGFpbmluZyB0aGUgZm9ybS4KCQkJCXVybCA9ICQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApOwoKCQkJCS8vIE5PVEU6IElmIHRoZSBtZXRob2QgaXMgImdldCIsIHdlIG5lZWQgdG8gc3RyaXAgb2ZmIHRoZSBxdWVyeSBzdHJpbmcKCQkJCS8vIGJlY2F1c2UgaXQgd2lsbCBnZXQgcmVwbGFjZWQgd2l0aCB0aGUgbmV3IGZvcm0gZGF0YS4gU2VlIGlzc3VlICM1NzEwLgoJCQkJaWYgKCBtZXRob2QgPT09ICJnZXQiICkgewoJCQkJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VVcmwoIHVybCApLmhyZWZOb1NlYXJjaDsKCQkJCX0KCgkJCQlpZiAoIHVybCA9PT0gJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApIHsKCQkJCQkvLyBUaGUgdXJsIHdlIGdvdCBiYWNrIG1hdGNoZXMgdGhlIGRvY3VtZW50IGJhc2UsCgkJCQkJLy8gd2hpY2ggbWVhbnMgdGhlIHBhZ2UgbXVzdCBiZSBhbiBpbnRlcm5hbC9lbWJlZGRlZCBwYWdlLAoJCQkJCS8vIHNvIGRlZmF1bHQgdG8gdXNpbmcgdGhlIGFjdHVhbCBkb2N1bWVudCB1cmwgYXMgYSBicm93c2VyCgkJCQkJLy8gd291bGQuCgkJCQkJdXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vU2VhcmNoOwoJCQkJfQoJCQl9CgoJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIHVybCwgJC5tb2JpbGUuZ2V0Q2xvc2VzdEJhc2VVcmwoICRmb3JtICkgKTsKCgkJCWlmICggKCAkLm1vYmlsZS5wYXRoLmlzRXh0ZXJuYWwoIHVybCApICYmICEkLm1vYmlsZS5wYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgdXJsICkgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJaWYgKCAhY2FsY3VsYXRlT25seSApIHsKCQkJCWZvcm1EYXRhID0gJGZvcm0uc2VyaWFsaXplQXJyYXkoKTsKCgkJCQlpZiAoICRsYXN0VkNsaWNrZWQgJiYgJGxhc3RWQ2xpY2tlZFsgMCBdLmZvcm0gPT09ICRmb3JtWyAwIF0gKSB7CgkJCQkJdmNsaWNrZWROYW1lID0gJGxhc3RWQ2xpY2tlZC5hdHRyKCAibmFtZSIgKTsKCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJLy8gTWFrZSBzdXJlIHRoZSBsYXN0IGNsaWNrZWQgZWxlbWVudCBpcyBpbmNsdWRlZCBpbiB0aGUgZm9ybQoJCQkJCQkkLmVhY2goIGZvcm1EYXRhLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCQkJCWlmICggdmFsdWUubmFtZSA9PT0gdmNsaWNrZWROYW1lICkgewoJCQkJCQkJCS8vIFVuc2V0IHZjbGlja2VkTmFtZSAtIHdlJ3ZlIGZvdW5kIGl0IGluIHRoZSBzZXJpYWxpemVkIGRhdGEgYWxyZWFkeQoJCQkJCQkJCXZjbGlja2VkTmFtZSA9ICIiOwoJCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJCWlmICggdmNsaWNrZWROYW1lICkgewoJCQkJCQkJZm9ybURhdGEucHVzaCggeyBuYW1lOiB2Y2xpY2tlZE5hbWUsIHZhbHVlOiAkbGFzdFZDbGlja2VkLmF0dHIoICJ2YWx1ZSIgKSB9ICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJcmV0ID0gewoJCQkJCXVybDogdXJsLAoJCQkJCW9wdGlvbnM6IHsKCQkJCQkJdHlwZToJCW1ldGhvZCwKCQkJCQkJZGF0YToJCSQucGFyYW0oIGZvcm1EYXRhICksCgkJCQkJCXRyYW5zaXRpb246CSRmb3JtLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJCQlyZXZlcnNlOgkkZm9ybS5qcW1EYXRhKCAiZGlyZWN0aW9uIiApID09PSAicmV2ZXJzZSIsCgkJCQkJCXJlbG9hZFBhZ2U6CXRydWUKCQkJCQl9CgkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCS8vYmluZCB0byBmb3JtIHN1Ym1pdCBldmVudHMsIGhhbmRsZSB3aXRoIEFqYXgKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggImZvcm0iLCAic3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZm9ybURhdGE7CgoJCQlpZiAoICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWZvcm1EYXRhID0gZ2V0QWpheEZvcm1EYXRhKCAkKCB0aGlzICkgKTsKCQkJCWlmICggZm9ybURhdGEgKSB7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggZm9ybURhdGEudXJsLCBmb3JtRGF0YS5vcHRpb25zICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQkvL2FkZCBhY3RpdmUgc3RhdGUgb24gdmNsaWNrCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICRidG4sIGJ0bkVscywgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LCBuZWVkQ2xvc2VzdCA9IGZhbHNlOwoJCQkvLyBpZiB0aGlzIGlzbid0IGEgbGVmdCBjbGljayB3ZSBkb24ndCBjYXJlLiBJdHMgaW1wb3J0YW50IHRvIG5vdGUKCQkJLy8gdGhhdCB3aGVuIHRoZSB2aXJ0dWFsIGV2ZW50IGlzIGdlbmVyYXRlZCBpdCB3aWxsIGNyZWF0ZSB0aGUgd2hpY2ggYXR0cgoJCQlpZiAoIGV2ZW50LndoaWNoID4gMSB8fCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBSZWNvcmQgdGhhdCB0aGlzIGVsZW1lbnQgd2FzIGNsaWNrZWQsIGluIGNhc2Ugd2UgbmVlZCBpdCBmb3IgY29ycmVjdAoJCQkvLyBmb3JtIHN1Ym1pc3Npb24gZHVyaW5nIHRoZSAic3VibWl0IiBoYW5kbGVyIGFib3ZlCgkJCSRsYXN0VkNsaWNrZWQgPSAkKCB0YXJnZXQgKTsKCgkJCS8vIFRyeSB0byBmaW5kIGEgdGFyZ2V0IGVsZW1lbnQgdG8gd2hpY2ggdGhlIGFjdGl2ZSBjbGFzcyB3aWxsIGJlIGFwcGxpZWQKCQkJaWYgKCAkLmRhdGEoIHRhcmdldCwgIm1vYmlsZS1idXR0b24iICkgKSB7CgkJCQkvLyBJZiB0aGUgZm9ybSB3aWxsIG5vdCBiZSBzdWJtaXR0ZWQgdmlhIEFKQVgsIGRvIG5vdCBhZGQgYWN0aXZlIGNsYXNzCgkJCQlpZiAoICFnZXRBamF4Rm9ybURhdGEoICQoIHRhcmdldCApLmNsb3Nlc3QoICJmb3JtIiApLCB0cnVlICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJLy8gV2Ugd2lsbCBhcHBseSB0aGUgYWN0aXZlIHN0YXRlIHRvIHRoaXMgYnV0dG9uIHdpZGdldCAtIHRoZSBwYXJlbnQKCQkJCS8vIG9mIHRoZSBpbnB1dCB0aGF0IHdhcyBjbGlja2VkIHdpbGwgaGF2ZSB0aGUgYXNzb2NpYXRlZCBkYXRhCgkJCQlpZiAoIHRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJCXRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJdGFyZ2V0ID0gZmluZENsb3Nlc3RMaW5rKCB0YXJnZXQgKTsKCQkJCWlmICggISggdGFyZ2V0ICYmICQubW9iaWxlLnBhdGgucGFyc2VVcmwoIHRhcmdldC5nZXRBdHRyaWJ1dGUoICJocmVmIiApIHx8ICIjIiApLmhhc2ggIT09ICIjIiApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZQoJCQkJLy8gbGluayB3cmFwcGluZyBjYW4gYmUgYXZvaWRlZAoJCQkJaWYgKCAhJCggdGFyZ2V0ICkuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIEF2b2lkIGNhbGxpbmcgLmNsb3Nlc3QgYnkgdXNpbmcgdGhlIGRhdGEgc2V0IGR1cmluZyAuYnV0dG9uTWFya3VwKCkKCQkJLy8gTGlzdCBpdGVtcyBoYXZlIHRoZSBidXR0b24gZGF0YSBpbiB0aGUgcGFyZW50IG9mIHRoZSBlbGVtZW50IGNsaWNrZWQKCQkJaWYgKCAhIX50YXJnZXQuY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1saW5rLWluaGVyaXQiICkgKSB7CgkJCQlpZiAoIHRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LnBhcmVudE5vZGUsICJidXR0b25FbGVtZW50cyIgKTsKCQkJCX0KCQkJLy8gT3RoZXJ3aXNlLCBsb29rIGZvciB0aGUgZGF0YSBvbiB0aGUgdGFyZ2V0IGl0c2VsZgoJCQl9IGVsc2UgewoJCQkJYnRuRWxzID0gJC5kYXRhKCB0YXJnZXQsICJidXR0b25FbGVtZW50cyIgKTsKCQkJfQoJCQkvLyBJZiBmb3VuZCwgZ3JhYiB0aGUgYnV0dG9uJ3Mgb3V0ZXIgZWxlbWVudAoJCQlpZiAoIGJ0bkVscyApIHsKCQkJCXRhcmdldCA9IGJ0bkVscy5vdXRlcjsKCQkJfSBlbHNlIHsKCQkJCW5lZWRDbG9zZXN0ID0gdHJ1ZTsKCQkJfQoKCQkJJGJ0biA9ICQoIHRhcmdldCApOwoJCQkvLyBJZiB0aGUgb3V0ZXIgZWxlbWVudCB3YXNuJ3QgZm91bmQgYnkgdGhlIG91ciBoZXVyaXN0aWNzLCB1c2UgLmNsb3Nlc3QoKQoJCQlpZiAoIG5lZWRDbG9zZXN0ICkgewoJCQkJJGJ0biA9ICRidG4uY2xvc2VzdCggIi51aS1idG4iICk7CgkJCX0KCgkJCWlmICggJGJ0bi5sZW5ndGggPiAwICYmCgkJCQkhKCAkYnRuLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiIHx8CgoJCQkJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgYWZ0ZXIgMS40LjAgcmVsZWFzZQoJCQkJCS8vIG9ubHkgdWktc3RhdGUtZGlzYWJsZWQgc2hvdWxkIGJlIHByZXNlbnQgdGhlcmVhZnRlcgoJCQkJCSRidG4uaGFzQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKSApICkgKSB7CgkJCQkkLm1vYmlsZS5yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCSQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rID0gJGJ0bjsKCQkJCSQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7CgoJCS8vIGNsaWNrIHJvdXRpbmcgLSBkaXJlY3QgdG8gSFRUUCBvciBBamF4LCBhY2NvcmRpbmdseQoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkIHx8IGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbGluayA9IGZpbmRDbG9zZXN0TGluayggZXZlbnQudGFyZ2V0ICksCgkJCQkkbGluayA9ICQoIGxpbmsgKSwKCgkJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpIHsKCQkJCQl3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsgJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7IH0sIDIwMCApOwoJCQkJfSwKCQkJCWJhc2VVcmwsIGhyZWYsCgkJCQl1c2VEZWZhdWx0VXJsSGFuZGxpbmcsIGlzRXh0ZXJuYWwsCgkJCQl0cmFuc2l0aW9uLCByZXZlcnNlLCByb2xlOwoKCQkJLy8gSWYgYSBidXR0b24gd2FzIGNsaWNrZWQsIGNsZWFuIHVwIHRoZSBhY3RpdmUgY2xhc3MgYWRkZWQgYnkgdmNsaWNrIGFib3ZlCgkJCWlmICggJC5tb2JpbGUuYWN0aXZlQ2xpY2tlZExpbmsgJiYKCQkJCSQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rWyAwIF0gPT09IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJfQoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggIWxpbmsgfHwgZXZlbnQud2hpY2ggPiAxIHx8ICEkbGluay5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL2lmIHRoZXJlJ3MgYSBkYXRhLXJlbD1iYWNrIGF0dHIsIGdvIGJhY2sgaW4gaGlzdG9yeQoJCQlpZiAoICRsaW5rLmlzKCAiOmpxbURhdGEocmVsPSdiYWNrJykiICkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWJhc2VVcmwgPSAkLm1vYmlsZS5nZXRDbG9zZXN0QmFzZVVybCggJGxpbmsgKTsKCgkJCS8vZ2V0IGhyZWYsIGlmIGRlZmluZWQsIG90aGVyd2lzZSBkZWZhdWx0IHRvIGVtcHR5IGhhc2gKCQkJaHJlZiA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAkbGluay5hdHRyKCAiaHJlZiIgKSB8fCAiIyIsIGJhc2VVcmwgKTsKCgkJCS8vaWYgYWpheCBpcyBkaXNhYmxlZCwgZXhpdCBlYXJseQoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhJC5tb2JpbGUucGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gWFhYX2pibGFzOiBJZGVhbGx5IGxpbmtzIHRvIGFwcGxpY2F0aW9uIHBhZ2VzIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMKCQkJLy8gICAgICAgICAgICBhbiB1cmwgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHdpdGggYSBoYXNoIHRoYXQgaXMgZWl0aGVyCgkJCS8vICAgICAgICAgICAgdGhlIHNpdGUgcmVsYXRpdmUgcGF0aCBvciBpZCB0byB0aGUgcGFnZS4gQnV0IHNvbWUgb2YgdGhlCgkJCS8vICAgICAgICAgICAgaW50ZXJuYWwgY29kZSB0aGF0IGR5bmFtaWNhbGx5IGdlbmVyYXRlcyBzdWItcGFnZXMgZm9yIG5lc3RlZAoJCQkvLyAgICAgICAgICAgIGxpc3RzIGFuZCBzZWxlY3QgZGlhbG9ncywganVzdCB3cml0ZSBhIGhhc2ggaW4gdGhlIGxpbmsgdGhleQoJCQkvLyAgICAgICAgICAgIGNyZWF0ZS4gVGhpcyBtZWFucyB0aGUgYWN0dWFsIFVSTCBwYXRoIGlzIGJhc2VkIG9uIHdoYXRldmVyCgkJCS8vICAgICAgICAgICAgdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGJhc2UgdGFnIGlzIGF0IHRoZSB0aW1lIHRoaXMgY29kZQoJCQkvLyAgICAgICAgICAgIGlzIGNhbGxlZC4KCQkJaWYgKCBocmVmLnNlYXJjaCggIiMiICkgIT09IC0xICYmCgkJCQkhKCAkLm1vYmlsZS5wYXRoLmlzRXh0ZXJuYWwoIGhyZWYgKSAmJiAkLm1vYmlsZS5wYXRoLmlzQWJzb2x1dGVVcmwoIGhyZWYgKSApICkgewoKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoICQubW9iaWxlLnBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXVzZURlZmF1bHRVcmxIYW5kbGluZyA9ICRsaW5rLmlzKCAiW3JlbD0nZXh0ZXJuYWwnXSIgKSB8fCAkbGluay5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwgJGxpbmsuaXMoICJbdGFyZ2V0XSIgKTsKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoKCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCS8vICAgICBtb3ZlZCBpbnRvIG1vcmUgY29tcHJlaGVuc2l2ZSBpc0V4dGVybmFsTGluawoJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggJC5tb2JpbGUucGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgISQubW9iaWxlLnBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCBocmVmICkgKTsKCgkJCWlmICggaXNFeHRlcm5hbCApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vdXNlIGFqYXgKCQkJdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApOwoJCQlyZXZlcnNlID0gJGxpbmsuanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiIHx8CgkJCQkJCS8vIGRlcHJlY2F0ZWQgLSByZW1vdmUgYnkgMS4wCgkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApOwoKCQkJLy90aGlzIG1heSBuZWVkIHRvIGJlIG1vcmUgc3BlY2lmaWMgYXMgd2UgdXNlIGRhdGEtcmVsIG1vcmUKCQkJcm9sZSA9ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfHwgdW5kZWZpbmVkOwoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggaHJlZiwgeyB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCByZXZlcnNlOiByZXZlcnNlLCByb2xlOiByb2xlLCBsaW5rOiAkbGluayB9ICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vcHJlZmV0Y2ggcGFnZXMgd2hlbiBhbmNob3JzIHdpdGggZGF0YS1wcmVmZXRjaCBhcmUgZW5jb3VudGVyZWQKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93LnByZWZldGNoIiwgZnVuY3Rpb24oKSB7CgkJCXZhciB1cmxzID0gW107CgkJCSQoIHRoaXMgKS5maW5kKCAiYTpqcW1EYXRhKHByZWZldGNoKSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICRsaW5rID0gJCggdGhpcyApLAoJCQkJCXVybCA9ICRsaW5rLmF0dHIoICJocmVmIiApOwoKCQkJCWlmICggdXJsICYmICQuaW5BcnJheSggdXJsLCB1cmxzICkgPT09IC0xICkgewoJCQkJCXVybHMucHVzaCggdXJsICk7CgoJCQkJCSQubW9iaWxlLmxvYWRQYWdlKCB1cmwsIHsgcm9sZTogJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSxwcmVmZXRjaDogdHJ1ZSB9ICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoKCQkvLyBUT0RPIGVuc3VyZSB0aGF0IHRoZSBuYXZpZ2F0ZSBiaW5kaW5nIGluIHRoZSBjb250ZW50IHdpZGdldCBoYXBwZW5zIGF0IHRoZSByaWdodCB0aW1lCgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5wYWdlY29udGFpbmVyKCk7CgoJCS8vc2V0IHBhZ2UgbWluLWhlaWdodHMgdG8gYmUgZGV2aWNlIHNwZWNpZmljCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgoJCQkvLyBXZSBuZWVkIHRvIHdhaXQgZm9yIHdpbmRvdy5sb2FkIHRvIG1ha2Ugc3VyZSB0aGF0IHN0eWxlcyBoYXZlIGFscmVhZHkgYmVlbiByZW5kZXJlZCwKCQkJLy8gb3RoZXJ3aXNlIGhlaWdodHMgb2YgZXh0ZXJuYWwgdG9vbGJhcnMgd2lsbCBoYXZlIHRoZSB3cm9uZyB2YWx1ZQoJCQlpZiAoIGxvYWREZWZlcnJlZCApIHsKCQkJCWxvYWREZWZlcnJlZC5kb25lKCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCQkJfSBlbHNlIHsKCQkJCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCgpOwoJCQl9CgkJfSk7CgkJJC5tb2JpbGUud2luZG93LmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9Oy8vbmF2cmVhZHlEZWZlcnJlZCBkb25lIGNhbGxiYWNrCgoJJCggZnVuY3Rpb24oKSB7IGRvbXJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOyB9ICk7CgoJLy8gQWNjb3VudCBmb3IgdGhlIHBvc3NpYmlsaXR5IHRoYXQgdGhlIGxvYWQgZXZlbnQgaGFzIGFscmVhZHkgZmlyZWQKCWlmICggZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKCQlwYWdlSXNGdWxseUxvYWRlZCgpOwoJfSBlbHNlIHsKCQkkLm1vYmlsZS53aW5kb3cubG9hZCggcGFnZUlzRnVsbHlMb2FkZWQgKTsKCX0KCgkkLndoZW4oIGRvbXJlYWR5RGVmZXJyZWQsICQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgKS5kb25lKCBmdW5jdGlvbigpIHsgJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMoKTsgfSApOwp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCgkvLyBUT0RPIHJlbW92ZSBkaXJlY3QgcmVmZXJlbmNlcyB0byAkLm1vYmlsZSBhbmQgcHJvcGVydGllcywgd2Ugc2hvdWxkCgkvLyAgICAgIGZhdm9yIGluamVjdGlvbiB3aXRoIHBhcmFtcyB0byB0aGUgY29uc3RydWN0b3IKCSQubW9iaWxlLlRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5UcmFuc2l0aW9uLnByb3RvdHlwZSwgewoJCXRvUHJlQ2xhc3M6ICIgdWktcGFnZS1wcmUtaW4iLAoKCQlpbml0OiBmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSApIHsKCQkJJC5leHRlbmQodGhpcywgewoJCQkJbmFtZTogbmFtZSwKCQkJCXJldmVyc2U6IHJldmVyc2UsCgkJCQkkdG86ICR0bywKCQkJCSRmcm9tOiAkZnJvbSwKCQkJCWRlZmVycmVkOiBuZXcgJC5EZWZlcnJlZCgpCgkJCX0pOwoJCX0sCgoJCWNsZWFuRnJvbTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuJGZyb20KCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiBvdXQgaW4gcmV2ZXJzZSAiICsgdGhpcy5uYW1lICkKCQkJCS5oZWlnaHQoICIiICk7CgkJfSwKCgkJLy8gTk9URSBvdmVycmlkZGVuIGJ5IGNoaWxkIG9iamVjdCBwcm90b3R5cGVzLCBub29wJ2QgaGVyZSBhcyBkZWZhdWx0cwoJCWJlZm9yZURvbmVJbjogZnVuY3Rpb24oKSB7fSwKCQliZWZvcmVEb25lT3V0OiBmdW5jdGlvbigpIHt9LAoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbigpIHt9LAoKCQlkb25lSW46IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmJlZm9yZURvbmVJbigpOwoKCQkJdGhpcy4kdG8ucmVtb3ZlQ2xhc3MoICJvdXQgaW4gcmV2ZXJzZSAiICsgdGhpcy5uYW1lICkuaGVpZ2h0KCAiIiApOwoKCQkJdGhpcy50b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCQkvLyBJbiBzb21lIGJyb3dzZXJzIChpT1M1KSwgM0QgdHJhbnNpdGlvbnMgYmxvY2sgdGhlIGFiaWxpdHkgdG8gc2Nyb2xsIHRvIHRoZSBkZXNpcmVkIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0aW9uCgkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCWlmICggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpICE9PSB0aGlzLnRvU2Nyb2xsICkgewoJCQkJdGhpcy5zY3JvbGxQYWdlKCk7CgkJCX0KCQkJaWYgKCAhdGhpcy5zZXF1ZW50aWFsICkgewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApOwoJCQl9CgkJCXRoaXMuZGVmZXJyZWQucmVzb2x2ZSggdGhpcy5uYW1lLCB0aGlzLnJldmVyc2UsIHRoaXMuJHRvLCB0aGlzLiRmcm9tLCB0cnVlICk7CgkJfSwKCgkJZG9uZU91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuYmVmb3JlRG9uZU91dCgpOwoJCQl0aGlzLnN0YXJ0SW4oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKTsKCQl9LAoKCQloaWRlSW46IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQkJLy8gUHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcjogc2VlIGNvbW1lbnRzIGF0ICM0MDI0IHJlZ2FyZGluZyBpT1MKCQkJdGhpcy4kdG8uY3NzKCAiei1pbmRleCIsIC0xMCApOwoJCQljYWxsYmFjay5jYWxsKCB0aGlzICk7CgkJCXRoaXMuJHRvLmNzcyggInotaW5kZXgiLCAiIiApOwoJCX0sCgoJCXNjcm9sbFBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBCeSB1c2luZyBzY3JvbGxUbyBpbnN0ZWFkIG9mIHNpbGVudFNjcm9sbCwgd2UgY2FuIGtlZXAgdGhpbmdzIGJldHRlciBpbiBvcmRlcgoJCQkvLyBKdXN0IHRvIGJlIHByZWNhdXRpb3MsIGRpc2FibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgkJCS8vaWYgd2UgYXJlIGhpZGluZyB0aGUgdXJsIGJhciBvciB0aGUgcGFnZSB3YXMgcHJldmlvdXNseSBzY3JvbGxlZCBzY3JvbGwgdG8gaGlkZSBvciByZXR1cm4gdG8gcG9zaXRpb24KCQkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyIHx8IHRoaXMudG9TY3JvbGwgIT09ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0aGlzLnRvU2Nyb2xsICk7CgkJCX0KCgkJCS8vIHJlZW5hYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJc3RhcnRJbjogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuaGlkZUluKGZ1bmN0aW9uKCkgewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRoaXMudG9QcmVDbGFzcyApOwoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gcGFnZSBhcyBpdCBpcyBub3cgZGlzcGxheTogYmxvY2sKCQkJCWlmICggIXByZXZlbnRGb2N1cyApIHsKCQkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoIHRoaXMuJHRvICk7CgkJCQl9CgoJCQkJLy8gU2V0IHRvIHBhZ2UgaGVpZ2h0CgkJCQl0aGlzLiR0by5oZWlnaHQoIHNjcmVlbkhlaWdodCArIHRoaXMudG9TY3JvbGwgKTsKCiAgICAgICAgICAgICAgICBpZiAoICFub25lICkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsUGFnZSgpOwogICAgICAgICAgICAgICAgfQoJCQl9KTsKCgkJCXRoaXMuJHRvCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMudG9QcmVDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgaW4gIiArIHJldmVyc2VDbGFzcyApOwoKCQkJaWYgKCAhbm9uZSApIHsKCQkJCXRoaXMuJHRvLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJCXRoaXMuZG9uZUluKCk7CgkJCQl9LCB0aGlzICkpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5kb25lSW4oKTsKCQkJfQoKCQl9LAoKCQlzdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoKCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCXRoaXMuJGZyb20KCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCX0sCgoJCXRvZ2dsZVZpZXdwb3J0Q2xhc3M6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIHRoaXMubmFtZSApOwoJCX0sCgoJCXRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewoJCQkvLyBOT1RFIG1hbnkgb2YgdGhlc2UgY291bGQgYmUgY2FsY3VsYXRlZC9yZWNvcmRlZCBpbiB0aGUgY29uc3RydWN0b3IsIGl0J3MgbXkKCQkJLy8gICAgICBvcGluaW9uIHRoYXQgYmluZGluZyB0aGVtIGFzIGxhdGUgYXMgcG9zc2libGUgaGFzIHZhbHVlIHdpdGggcmVnYXJkcyB0bwoJCQkvLyAgICAgIGJldHRlciB0cmFuc2l0aW9ucyB3aXRoIGZld2VyIGJ1Z3MuIEllLCBpdCdzIG5vdCBndWFyYW50ZWVkIHRoYXQgdGhlCgkJCS8vICAgICAgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgdHJhbnNpdGlvbiB3aWxsIGJlIHJ1biBpbW1lZGlhdGVseSBhZnRlciBhcwoJCQkvLyAgICAgIGl0IGlzIHRvZGF5LiBTbyB3ZSB3YWl0IHVudGlsIHRyYW5zaXRpb24gaXMgaW52b2tlZCB0byBnYXRoZXIgdGhlIGZvbGxvd2luZwoJCQl2YXIgbm9uZSwKCQkJCXJldmVyc2VDbGFzcyA9IHRoaXMucmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJgoJCQkJCSQubW9iaWxlLndpbmRvdy53aWR0aCgpID4gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoOwoKCQkJdGhpcy50b1Njcm9sbCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCkubGFzdFNjcm9sbCB8fCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCgkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8ICEkLnN1cHBvcnQuY3NzQW5pbWF0aW9ucyB8fAoJCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlIHx8ICF0aGlzLm5hbWUgfHwgdGhpcy5uYW1lID09PSAibm9uZSIgfHwKCQkJCU1hdGgubWF4KCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCksIHRoaXMudG9TY3JvbGwgKSA+CgkJCQkJJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbigpOwoKCQkJdGhpcy50b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCQlpZiAoIHRoaXMuJGZyb20gJiYgIW5vbmUgKSB7CgkJCQl0aGlzLnN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5kb25lT3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgdHJ1ZSApOwoJCQl9CgoJCQlyZXR1cm4gdGhpcy5kZWZlcnJlZC5wcm9taXNlKCk7CgkJfQoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5TZXJpYWxUcmFuc2l0aW9uLnByb3RvdHlwZSwgJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQlzZXF1ZW50aWFsOiB0cnVlLAoKCQliZWZvcmVEb25lT3V0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLiRmcm9tICkgewoJCQkJdGhpcy5jbGVhbkZyb20oKTsKCQkJfQoJCX0sCgoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbiggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKSB7CgkJCXRoaXMuJGZyb20uYW5pbWF0aW9uQ29tcGxldGUoJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQkJfSwgdGhpcyApKTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJJC5tb2JpbGUuQ29uY3VycmVudFRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuQ29uY3VycmVudFRyYW5zaXRpb24ucHJvdG90eXBlLCAkLm1vYmlsZS5UcmFuc2l0aW9uLnByb3RvdHlwZSwgewoJCXNlcXVlbnRpYWw6IGZhbHNlLAoKCQliZWZvcmVEb25lSW46IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMuJGZyb20gKSB7CgkJCQl0aGlzLmNsZWFuRnJvbSgpOwoJCQl9CgkJfSwKCgkJYmVmb3JlU3RhcnRPdXQ6IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApIHsKCQkJdGhpcy5kb25lT3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoJCX0KCX0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCApIHsKCgkvLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKCXZhciBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSAqIDM7Cgl9OwoKCS8vdHJhbnNpdGlvbiBoYW5kbGVyIGRpY3Rpb25hcnkgZm9yIDNyZCBwYXJ0eSB0cmFuc2l0aW9ucwoJJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJCSJzZXF1ZW50aWFsIjogJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbiwKCQkic2ltdWx0YW5lb3VzIjogJC5tb2JpbGUuQ29uY3VycmVudFRyYW5zaXRpb24KCX07CgoJLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHRoZSBwdWJsaWMgZGVmYXVsdC4KCSQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zZXF1ZW50aWFsOwoKCSQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MgPSB7fTsKCgkvLyBJZiB0cmFuc2l0aW9uIGlzIGRlZmluZWQsIGNoZWNrIGlmIGNzcyAzRCB0cmFuc2Zvcm1zIGFyZSBzdXBwb3J0ZWQsIGFuZCBpZiBub3QsIGlmIGEgZmFsbGJhY2sgaXMgc3BlY2lmaWVkCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCWlmICggdHJhbnNpdGlvbiAmJiAhJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXSApIHsKCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXTsKCQl9CgoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvLyBTZXQgdGhlIGdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gdG8gZGVmYXVsdCBpZiBubyBpbXBsZW1lbnRhdGlvbiB3YXMgc2V0IGJ5IHVzZXIKCSQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHx8IGRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uOwoKfSkoIGpRdWVyeSApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbGlwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbGlwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBwb3AgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnBvcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBVc2UgdGhlIHNpbXVsdGFuZW91cyB0cmFuc2l0aW9ucyBoYW5kbGVyIGZvciBzbGlkZSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2xpZGUgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2ltdWx0YW5lb3VzOwoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWRvd24gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZG93biA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVmYWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZmFkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGV1cCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGV1cCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgdHVybiBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MudHVybiA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07Ci8vIEJhY2tjb21wYXQgcmVtb3ZlIGluIDEuNQokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzOwoKLy8gQXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCgl0YXJnZXQgPSAkKCB0YXJnZXQgKTsKCgkvLyBEZWdyYWRlIGlucHV0cyB0byBhdm9pZCBwb29ybHkgaW1wbGVtZW50ZWQgbmF0aXZlIGZ1bmN0aW9uYWxpdHkKCXRhcmdldC5maW5kKCAiaW5wdXQiICkubm90KCAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSApLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gfHwgInRleHQiLAoJCQlodG1sLCBoYXNUeXBlLCBmaW5kc3RyLCByZXBzdHI7CgoJCWlmICggJC5tb2JpbGUuZGVncmFkZUlucHV0c1sgdHlwZSBdICkgewoJCQlodG1sID0gJCggIjxkaXY+IiApLmh0bWwoIGVsZW1lbnQuY2xvbmUoKSApLmh0bWwoKTsKCQkJLy8gSW4gSUUgYnJvd3NlcnMsIHRoZSB0eXBlIHNvbWV0aW1lcyBkb2Vzbid0IGV4aXN0IGluIHRoZSBjbG9uZWQgbWFya3VwLCBzbyB3ZSByZXBsYWNlIHRoZSBjbG9zaW5nIHRhZyBpbnN0ZWFkCgkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMTsKCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LzsKCQkJcmVwc3RyID0gIiB0eXBlPVwiIiArIG9wdFR5cGUgKyAiXCIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT1cIiIgKyB0eXBlICsgIlwiIiArICggaGFzVHlwZSA/ICIiIDogIj4iICk7CgoJCQllbGVtZW50LnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS5wYWdlLCB7CglvcHRpb25zOiB7CgoJCS8vIEFjY2VwdHMgbGVmdCwgcmlnaHQgYW5kIG5vbmUKCQljbG9zZUJ0bjogImxlZnQiLAoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQljb3JuZXJzOiB0cnVlLAoJCWRpYWxvZzogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaWFsb2cgKSB7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2lubmVyOiB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKSwKCQkJCV9oZWFkZXJDbG9zZUJ1dHRvbjogbnVsbAoJCQl9KTsKCgkJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJCXRoaXMuX3NldENsb3NlQnRuKCB0aGlzLm9wdGlvbnMuY2xvc2VCdG4gKTsKCQkJfQoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nIGFuZCB3cmFwIGludGVyaW9yCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlhbG9nICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1kaWFsb2ciICkKCQkJCS53cmFwSW5uZXIoICQoICI8ZGl2Lz4iLCB7CgoJCQkJCS8vIEFSSUEgcm9sZQoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktb3ZlcmxheS1zaGFkb3ciICsKCQkJCQkJKCB0aGlzLm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApCgkJCQl9KSk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX2lubmVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsICEhb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMub3ZlcmxheVRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggJC5tb2JpbGUuYWN0aXZlUGFnZVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJCWN1cnJlbnRPcHRzLm92ZXJsYXlUaGVtZSA9IG9wdGlvbnMub3ZlcmxheVRoZW1lOwoJCQkJdGhpcy5faGFuZGxlUGFnZUJlZm9yZVNob3coKTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gY3VycmVudE9wdHMuY2xvc2VCdG47CgkJCWNsb3NlQnV0dG9uVGV4dCA9IG9wdGlvbnMuY2xvc2VCdG5UZXh0OwoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBvcHRpb25zLmNsb3NlQnRuOwoJCX0KCgkJaWYgKCBjbG9zZUJ1dHRvbkxvY2F0aW9uICkgewoJCQl0aGlzLl9zZXRDbG9zZUJ0biggY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0ICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uICgpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgJiYgdGhpcy5vcHRpb25zLmRpYWxvZyApIHsKCQkJdGhpcy5yZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kKCk7CgkJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJfQoJfSwKCglfc2V0Q2xvc2VCdG46IGZ1bmN0aW9uKCBsb2NhdGlvbiwgdGV4dCApIHsKCQl2YXIgZHN0LAoJCQlidG4gPSB0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbjsKCgkJLy8gU2FuaXRpemUgdmFsdWUKCQlsb2NhdGlvbiA9ICJsZWZ0IiA9PT0gbG9jYXRpb24gPyAibGVmdCIgOiAicmlnaHQiID09PSBsb2NhdGlvbiA/ICJyaWdodCIgOiAibm9uZSI7CgoJCWlmICggIm5vbmUiID09PSBsb2NhdGlvbiApIHsKCQkJaWYgKCBidG4gKSB7CgkJCQlidG4ucmVtb3ZlKCk7CgkJCQlidG4gPSBudWxsOwoJCQl9CgkJfSBlbHNlIGlmICggYnRuICkgewoJCQlidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIGxvY2F0aW9uICk7CgkJCWlmICggdGV4dCApIHsKCQkJCWJ0bi50ZXh0KCB0ZXh0ICk7CgkJCX0KCQl9IGVsc2UgewoJCQlkc3QgPSB0aGlzLl9pbm5lci5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmlyc3QoKTsKCQkJYnRuID0gJCggIjxhPjwvYT4iLCB7CgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJImNsYXNzIjogInVpLWJ0biB1aS1jb3JuZXItYWxsIHVpLWljb24tZGVsZXRlIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1idG4tIiArIGxvY2F0aW9uCgkJCQl9KQoJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiLCAiYmFjayIgKQoJCQkJLnRleHQoIHRleHQgfHwgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCB8fCAiIiApCgkJCQkucHJlcGVuZFRvKCBkc3QgKTsKCQl9CgoJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uID0gYnRuOwoJfQp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCB7CglvcHRpb25zOiB7CgoJCS8vIEFjY2VwdHMgbGVmdCwgcmlnaHQgYW5kIG5vbmUKCQljbG9zZUJ0bjogImxlZnQiLAoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQljb3JuZXJzOiB0cnVlCgl9LAoKCS8vIE92ZXJyaWRlIHRoZSB0aGVtZSBzZXQgYnkgdGhlIHBhZ2UgcGx1Z2luIG9uIHBhZ2VzaG93CglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gdHJ1ZTsKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkucGFnZSggInNldENvbnRhaW5lckJhY2tncm91bmQiLCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgkJfQoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gZmFsc2U7Cgl9LAoKCS8vIGNsaWNrIGFuZCBzdWJtaXQgZXZlbnRzOgoJLy8gLSBjbGlja3MgYW5kIHN1Ym1pdHMgc2hvdWxkIHVzZSB0aGUgY2xvc2luZyB0cmFuc2l0aW9uIHRoYXQgdGhlIGRpYWxvZwoJLy8gICBvcGVuZWQgd2l0aCB1bmxlc3MgYSBkYXRhLXRyYW5zaXRpb24gaXMgc3BlY2lmaWVkIG9uIHRoZSBsaW5rL2Zvcm0KCS8vIC0gaWYgdGhlIGNsaWNrIHdhcyBvbiB0aGUgY2xvc2UgYnV0dG9uLCBvciB0aGUgbGluayBoYXMgYSBkYXRhLXJlbD0iYmFjayIKCS8vICAgaXQnbGwgZ28gYmFjayBpbiBoaXN0b3J5IG5hdHVyYWxseQoJX2hhbmRsZVZDbGlja1N1Ym1pdDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBhdHRycywKCQkJJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siID8gImEiIDogImZvcm0iICk7CgoJCWlmICggJHRhcmdldC5sZW5ndGggJiYgISR0YXJnZXQuanFtRGF0YSggInRyYW5zaXRpb24iICkgKSB7CgkJCWF0dHJzID0ge307CgkJCWF0dHJzWyAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHJhbnNpdGlvbiIgXSA9CgkJCQkoICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCkgfHwge30gKVsgInRyYW5zaXRpb24iIF0gfHwKCQkJCSQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uOwoJCQlhdHRyc1sgImRhdGEtIiArICQubW9iaWxlLm5zICsgImRpcmVjdGlvbiIgXSA9ICJyZXZlcnNlIjsKCQkJJHRhcmdldC5hdHRyKCBhdHRycyApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nIGFuZCB3cmFwIGludGVyaW9yCgkJZWxlbS5hZGRDbGFzcyggInVpLWRpYWxvZyIgKQoJCQkud3JhcElubmVyKCAkKCAiPGRpdi8+IiwgewoKCQkJCS8vIEFSSUEgcm9sZQoJCQkJInJvbGUiIDogImRpYWxvZyIsCgkJCQkiY2xhc3MiIDogInVpLWRpYWxvZy1jb250YWluIHVpLW92ZXJsYXktc2hhZG93IiArCgkJCQkJKCAhIW9wdHMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApCgkJCX0pKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2lzQ2xvc2VhYmxlOiBmYWxzZSwKCQkJX2lubmVyOiBlbGVtLmNoaWxkcmVuKCksCgkJCV9oZWFkZXJDbG9zZUJ1dHRvbjogbnVsbAoJCX0pOwoKCQl0aGlzLl9vbiggZWxlbSwgewoJCQl2Y2xpY2s6ICJfaGFuZGxlVkNsaWNrU3VibWl0IiwKCQkJc3VibWl0OiAiX2hhbmRsZVZDbGlja1N1Ym1pdCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJcGFnZWJlZm9yZWhpZGU6ICJfaGFuZGxlUGFnZUJlZm9yZUhpZGUiCgkJfSk7CgoJCXRoaXMuX3NldENsb3NlQnRuKCBvcHRzLmNsb3NlQnRuICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0LAoJCQljdXJyZW50T3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faW5uZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgISFvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5vdmVybGF5VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAkLm1vYmlsZS5hY3RpdmVQYWdlWyAwIF0gPT09IHRoaXMuZWxlbWVudFsgMCBdICkgewoJCQkJY3VycmVudE9wdHMub3ZlcmxheVRoZW1lID0gb3B0aW9ucy5vdmVybGF5VGhlbWU7CgkJCQl0aGlzLl9oYW5kbGVQYWdlQmVmb3JlU2hvdygpOwoJCQl9CgkJfQoKCQlpZiAoIG9wdGlvbnMuY2xvc2VCdG5UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBjdXJyZW50T3B0cy5jbG9zZUJ0bjsKCQkJY2xvc2VCdXR0b25UZXh0ID0gb3B0aW9ucy5jbG9zZUJ0blRleHQ7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY2xvc2VCdG4gIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IG9wdGlvbnMuY2xvc2VCdG47CgkJfQoKCQlpZiAoIGNsb3NlQnV0dG9uTG9jYXRpb24gKSB7CgkJCXRoaXMuX3NldENsb3NlQnRuKCBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRDbG9zZUJ0bjogZnVuY3Rpb24oIGxvY2F0aW9uLCB0ZXh0ICkgewoJCXZhciBkc3QsCgkJCWJ0biA9IHRoaXMuX2hlYWRlckNsb3NlQnV0dG9uOwoKCQkvLyBTYW5pdGl6ZSB2YWx1ZQoJCWxvY2F0aW9uID0gImxlZnQiID09PSBsb2NhdGlvbiA/ICJsZWZ0IiA6ICJyaWdodCIgPT09IGxvY2F0aW9uID8gInJpZ2h0IiA6ICJub25lIjsKCgkJaWYgKCAibm9uZSIgPT09IGxvY2F0aW9uICkgewoJCQlpZiAoIGJ0biApIHsKCQkJCWJ0bi5yZW1vdmUoKTsKCQkJCWJ0biA9IG51bGw7CgkJCX0KCQl9IGVsc2UgaWYgKCBidG4gKSB7CgkJCWJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi0iICsgbG9jYXRpb24gKTsKCQkJaWYgKCB0ZXh0ICkgewoJCQkJYnRuLnRleHQoIHRleHQgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWRzdCA9IHRoaXMuX2lubmVyLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maXJzdCgpOwoJCQlidG4gPSAkKCAiPGE+PC9hPiIsIHsKCQkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktYnRuLSIgKyBsb2NhdGlvbgoJCQkJfSkKCQkJCS50ZXh0KCB0ZXh0IHx8IHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgfHwgIiIgKQoJCQkJLnByZXBlbmRUbyggZHN0ICk7CgkJCXRoaXMuX29uKCBidG4sIHsgY2xpY2s6ICJjbG9zZSIgfSApOwoJCX0KCgkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBoaXN0ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeTsKCgkJaWYgKCB0aGlzLl9pc0Nsb3NlYWJsZSApIHsKCQkJdGhpcy5faXNDbG9zZWFibGUgPSBmYWxzZTsKCQkJLy8gSWYgdGhlIGhhc2ggbGlzdGVuaW5nIGlzIGVuYWJsZWQgYW5kIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBwcmVjZWRpbmcgaGlzdG9yeQoJCQkvLyBlbnRyeSBpdCdzIG9rIHRvIGdvIGJhY2suIEluaXRpYWwgcGFnZXMgd2l0aCB0aGUgZGlhbG9nIGhhc2ggc3RhdGUgYXJlIGFuIGV4YW1wbGUKCQkJLy8gd2hlcmUgdGhlIHN0YWNrIGNoZWNrIGlzIG5lY2Vzc2FyeQoJCQlpZiAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmIGhpc3QuYWN0aXZlSW5kZXggPiAwICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl9IGVsc2UgewoJCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5wYWdlY29udGFpbmVyKCAiYmFjayIgKTsKCQkJfQoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBySW5pdGlhbExldHRlciA9IC8oW0EtWl0pL2csCgoJLy8gQ29uc3RydWN0IGljb25wb3MgY2xhc3MgZnJvbSBpY29ucG9zIHZhbHVlCglpY29ucG9zQ2xhc3MgPSBmdW5jdGlvbiggaWNvbnBvcyApIHsKCQlyZXR1cm4gKCAidWktYnRuLWljb24tIiArICggaWNvbnBvcyA9PT0gbnVsbCA/ICJsZWZ0IiA6IGljb25wb3MgKSApOwoJfTsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgewoJb3B0aW9uczogewoJCWVuaGFuY2VkOiBmYWxzZSwKCQlleHBhbmRDdWVUZXh0OiBudWxsLAoJCWNvbGxhcHNlQ3VlVGV4dDogbnVsbCwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogbnVsbCwKCQlleHBhbmRlZEljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IG51bGwsCgkJY29ybmVyczogbnVsbCwKCQltaW5pOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQl1aSA9IHsKCQkJCWFjY29yZGlvbjogZWxlbQoJCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JyksIiArCgkJCQkJCSI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZXNldCcpIiArCgkJCQkJCSggJC5tb2JpbGUuY29sbGFwc2libGVzZXQgPyAiLCA6bW9iaWxlLWNvbGxhcHNpYmxlc2V0IiA6CgkJCQkJCQkiIiApICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICkKCQkJfTsKCgkJdGhpcy5fdWkgPSB1aTsKCQl0aGlzLl9yZW5kZXJlZE9wdGlvbnMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXVpLmhlYWRpbmcgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICIudWktY29sbGFwc2libGUtaGVhZGluZyIgKTsKCQkJdWkuY29udGVudCA9IHVpLmhlYWRpbmcubmV4dCgpOwoJCQl1aS5hbmNob3IgPSB1aS5oZWFkaW5nLmNoaWxkcmVuKCk7CgkJCXVpLnN0YXR1cyA9IHVpLmFuY2hvci5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyIgKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9lbmhhbmNlKCBlbGVtLCB1aSApOwoJCX0KCgkJdGhpcy5fb24oIHVpLmhlYWRpbmcsIHsKCQkJInRhcCI6IGZ1bmN0aW9uKCkgewoJCQkJdWkuaGVhZGluZy5maW5kKCAiYSIgKS5maXJzdCgpLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9LAoKCQkJImNsaWNrIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoICF1aS5oZWFkaW5nLmhhc0NsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgKTsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0pOwoJfSwKCgkvLyBBZGp1c3QgdGhlIGtleXMgaW5zaWRlIG9wdGlvbnMgZm9yIGluaGVyaXRlZCB2YWx1ZXMKCV9nZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIga2V5LAoJCQlhY2NvcmRpb24gPSB0aGlzLl91aS5hY2NvcmRpb24sCgkJCWFjY29yZGlvbldpZGdldCA9IHRoaXMuX3VpLmFjY29yZGlvbldpZGdldDsKCgkJLy8gQ29weSBvcHRpb25zCgkJb3B0aW9ucyA9ICQuZXh0ZW5kKCB7fSwgb3B0aW9ucyApOwoKCQlpZiAoIGFjY29yZGlvbi5sZW5ndGggJiYgIWFjY29yZGlvbldpZGdldCApIHsKCQkJdGhpcy5fdWkuYWNjb3JkaW9uV2lkZ2V0ID0KCQkJYWNjb3JkaW9uV2lkZ2V0ID0gYWNjb3JkaW9uLmRhdGEoICJtb2JpbGUtY29sbGFwc2libGVzZXQiICk7CgkJfQoKCQlmb3IgKCBrZXkgaW4gb3B0aW9ucyApIHsKCgkJCS8vIFJldHJpZXZlIHRoZSBvcHRpb24gdmFsdWUgZmlyc3QgZnJvbSB0aGUgb3B0aW9ucyBvYmplY3QgcGFzc2VkIGluIGFuZCwgaWYKCQkJLy8gbnVsbCwgZnJvbSB0aGUgcGFyZW50IGFjY29yZGlvbiBvciwgaWYgdGhhdCdzIG51bGwgdG9vLCBvciBpZiB0aGVyZSdzIG5vCgkJCS8vIHBhcmVudCBhY2NvcmRpb24sIHRoZW4gZnJvbSB0aGUgZGVmYXVsdHMuCgkJCW9wdGlvbnNbIGtleSBdID0KCQkJCSggb3B0aW9uc1sga2V5IF0gIT0gbnVsbCApID8gb3B0aW9uc1sga2V5IF0gOgoJCQkJKCBhY2NvcmRpb25XaWRnZXQgKSA/IGFjY29yZGlvbldpZGdldC5vcHRpb25zWyBrZXkgXSA6CgkJCQlhY2NvcmRpb24ubGVuZ3RoID8gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBhY2NvcmRpb25bIDAgXSwKCQkJCQlrZXkucmVwbGFjZSggckluaXRpYWxMZXR0ZXIsICItJDEiICkudG9Mb3dlckNhc2UoKSApOgoJCQkJbnVsbDsKCgkJCWlmICggbnVsbCA9PSBvcHRpb25zWyBrZXkgXSApIHsKCQkJCW9wdGlvbnNbIGtleSBdID0gJC5tb2JpbGUuY29sbGFwc2libGUuZGVmYXVsdHNbIGtleSBdOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggcHJlZml4LCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogcHJlZml4ICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbiggZWxlbSwgdWkgKSB7CgkJdmFyIGljb25jbGFzcywKCQkJb3B0cyA9IHRoaXMuX3JlbmRlcmVkT3B0aW9ucywKCQkJY29udGVudFRoZW1lQ2xhc3MgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgb3B0cy5jb250ZW50VGhlbWUgKTsKCgkJZWxlbS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlICIgKwoJCQkoIG9wdHMuaW5zZXQgPyAidWktY29sbGFwc2libGUtaW5zZXQgIiA6ICIiICkgKwoJCQkoIG9wdHMuaW5zZXQgJiYgb3B0cy5jb3JuZXJzID8gInVpLWNvcm5lci1hbGwgIiA6ICIiICkgKwoJCQkoIGNvbnRlbnRUaGVtZUNsYXNzID8gInVpLWNvbGxhcHNpYmxlLXRoZW1lZC1jb250ZW50ICIgOiAiIiApICk7CgkJdWkub3JpZ2luYWxIZWFkaW5nID0gZWxlbS5jaGlsZHJlbiggdGhpcy5vcHRpb25zLmhlYWRpbmcgKS5maXJzdCgpLAoJCXVpLmNvbnRlbnQgPSBlbGVtCgkJCS53cmFwSW5uZXIoICI8ZGl2ICIgKwoJCQkJImNsYXNzPSd1aS1jb2xsYXBzaWJsZS1jb250ZW50ICIgKwoJCQkJY29udGVudFRoZW1lQ2xhc3MgKyAiJz48L2Rpdj4iICkKCQkJLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWNvbnRlbnQiICksCgkJdWkuaGVhZGluZyA9IHVpLm9yaWdpbmFsSGVhZGluZzsKCgkJLy8gUmVwbGFjZSBjb2xsYXBzaWJsZUhlYWRpbmcgaWYgaXQncyBhIGxlZ2VuZAoJCWlmICggdWkuaGVhZGluZy5pcyggImxlZ2VuZCIgKSApIHsKCQkJdWkuaGVhZGluZyA9ICQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnPiIrIHVpLmhlYWRpbmcuaHRtbCgpICsiPC9kaXY+IiApOwoJCQl1aS5wbGFjZWhvbGRlciA9ICQoICI8ZGl2PjwhLS0gcGxhY2Vob2xkZXIgZm9yIGxlZ2VuZCAtLT48L2Rpdj4iICkuaW5zZXJ0QmVmb3JlKCB1aS5vcmlnaW5hbEhlYWRpbmcgKTsKCQkJdWkub3JpZ2luYWxIZWFkaW5nLnJlbW92ZSgpOwoJCX0KCgkJaWNvbmNsYXNzID0gKCBvcHRzLmNvbGxhcHNlZCA/ICggb3B0cy5jb2xsYXBzZWRJY29uID8gInVpLWljb24tIiArIG9wdHMuY29sbGFwc2VkSWNvbiA6ICIiICk6CgkJCSggb3B0cy5leHBhbmRlZEljb24gPyAidWktaWNvbi0iICsgb3B0cy5leHBhbmRlZEljb24gOiAiIiApICk7CgoJCXVpLnN0YXR1cyA9ICQoICI8c3BhbiBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMnPjwvc3Bhbj4iICk7CgkJdWkuYW5jaG9yID0gdWkuaGVhZGluZwoJCQkuZGV0YWNoKCkKCQkJLy9tb2RpZnkgbWFya3VwICYgYXR0cmlidXRlcwoJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCS5hcHBlbmQoIHVpLnN0YXR1cyApCgkJCS53cmFwSW5uZXIoICI8YSBocmVmPScjJyBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy10b2dnbGUnPjwvYT4iICkKCQkJLmZpbmQoICJhIiApCgkJCQkuZmlyc3QoKQoJCQkJLmFkZENsYXNzKCAidWktYnRuICIgKwoJCQkJCSggaWNvbmNsYXNzID8gaWNvbmNsYXNzICsgIiAiIDogIiIgKSArCgkJCQkJKCBpY29uY2xhc3MgPyBpY29ucG9zQ2xhc3MoIG9wdHMuaWNvbnBvcyApICsKCQkJCQkJIiAiIDogIiIgKSArCgkJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1idG4tIiwgb3B0cy50aGVtZSApICsgIiAiICsKCQkJCQkoIG9wdHMubWluaSA/ICJ1aS1taW5pICIgOiAiIiApICk7CgoJCS8vZHJvcCBoZWFkaW5nIGluIGJlZm9yZSBjb250ZW50CgkJdWkuaGVhZGluZy5pbnNlcnRCZWZvcmUoIHVpLmNvbnRlbnQgKTsKCgkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIHRoaXMub3B0aW9ucy5jb2xsYXBzZWQgKTsKCgkJcmV0dXJuIHVpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9hcHBseU9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCXRoaXMuX3JlbmRlcmVkT3B0aW9ucyA9IHRoaXMuX2dldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJfSwKCglfYXBwbHlPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNDb2xsYXBzZWQsIG5ld1RoZW1lLCBvbGRUaGVtZSwgaGFzQ29ybmVycywgaGFzSWNvbiwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLl9yZW5kZXJlZE9wdGlvbnMsCgkJCXVpID0gdGhpcy5fdWksCgkJCWFuY2hvciA9IHVpLmFuY2hvciwKCQkJc3RhdHVzID0gdWkuc3RhdHVzLAoJCQlvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQkvLyBGaXJzdCBhbmQgZm9yZW1vc3Qgd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIGNvbGxhcHNpYmxlIGlzIGluIHRoZSBwcm9wZXIKCQkvLyBzdGF0ZSwgaW4gY2FzZSBzb21lYm9keSBkZWNpZGVkIHRvIGNoYW5nZSB0aGUgY29sbGFwc2VkIG9wdGlvbiBhdCB0aGUKCQkvLyBzYW1lIHRpbWUgYXMgYW5vdGhlciBvcHRpb24KCQlpZiAoIG9wdGlvbnMuY29sbGFwc2VkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCBvcHRpb25zLmNvbGxhcHNlZCApOwoJCX0KCgkJaXNDb2xsYXBzZWQgPSBlbGVtLmhhc0NsYXNzKCAidWktY29sbGFwc2libGUtY29sbGFwc2VkIiApOwoKCQkvLyBXZSBvbmx5IG5lZWQgdG8gYXBwbHkgdGhlIGN1ZSB0ZXh0IGZvciB0aGUgY3VycmVudCBzdGF0ZSByaWdodCBhd2F5LgoJCS8vIFRoZSBjdWUgdGV4dCBmb3IgdGhlIGFsdGVybmF0ZSBzdGF0ZSB3aWxsIGJlIHN0b3JlZCBpbiB0aGUgb3B0aW9ucwoJCS8vIGFuZCBhcHBsaWVkIHRoZSBuZXh0IHRpbWUgdGhlIGNvbGxhcHNpYmxlJ3Mgc3RhdGUgaXMgdG9nZ2xlZAoJCWlmICggaXNDb2xsYXBzZWQgKSB7CgkJCWlmICggb3B0cy5leHBhbmRDdWVUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdGF0dXMudGV4dCggb3B0cy5leHBhbmRDdWVUZXh0ICk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIG9wdHMuY29sbGFwc2VDdWVUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdGF0dXMudGV4dCggb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQkJfQoJCX0KCgkJLy8gVXBkYXRlIGljb24KCgkJLy8gSXMgaXQgc3VwcG9zZWQgdG8gaGF2ZSBhbiBpY29uPwoJCWhhc0ljb24gPQoKCQkJLy8gSWYgdGhlIGNvbGxhcHNlZEljb24gaXMgYmVpbmcgc2V0LCBjb25zdWx0IHRoYXQKCQkJKCBvcHRzLmNvbGxhcHNlZEljb24gIT09IHVuZGVmaW5lZCA/IG9wdHMuY29sbGFwc2VkSWNvbiAhPT0gZmFsc2UgOgoKCQkJCS8vIE90aGVyd2lzZSBjb25zdWx0IHRoZSBleGlzdGluZyBvcHRpb24gdmFsdWUKCQkJCWN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gIT09IGZhbHNlICk7CgoKCQkvLyBJZiBhbnkgaWNvbi1yZWxhdGVkIG9wdGlvbnMgaGF2ZSBjaGFuZ2VkLCBtYWtlIHN1cmUgdGhlIG5ldyBpY29uCgkJLy8gc3RhdGUgaXMgcmVmbGVjdGVkIGJ5IGZpcnN0IHJlbW92aW5nIGFsbCBpY29uLXJlbGF0ZWQgY2xhc3NlcwoJCS8vIHJlZmxlY3RpbmcgdGhlIGN1cnJlbnQgc3RhdGUgYW5kIHRoZW4gYWRkaW5nIGFsbCBpY29uLXJlbGF0ZWQKCQkvLyBjbGFzc2VzIGZvciB0aGUgbmV3IHN0YXRlCgkJaWYgKCAhKCBvcHRzLmljb25wb3MgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRzLmNvbGxhcHNlZEljb24gPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRzLmV4cGFuZGVkSWNvbiA9PT0gdW5kZWZpbmVkICkgKSB7CgoJCQkvLyBSZW1vdmUgYWxsIGN1cnJlbnQgaWNvbi1yZWxhdGVkIGNsYXNzZXMKCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCBbIGljb25wb3NDbGFzcyggY3VycmVudE9wdHMuaWNvbnBvcyApIF0KCQkJCS5jb25jYXQoICggY3VycmVudE9wdHMuZXhwYW5kZWRJY29uID8KCQkJCQlbICJ1aS1pY29uLSIgKyBjdXJyZW50T3B0cy5leHBhbmRlZEljb24gXSA6IFtdICkgKQoJCQkJLmNvbmNhdCggKCBjdXJyZW50T3B0cy5jb2xsYXBzZWRJY29uID8KCQkJCQlbICJ1aS1pY29uLSIgKyBjdXJyZW50T3B0cy5jb2xsYXBzZWRJY29uIF0gOiBbXSApICkKCQkJCS5qb2luKCAiICIgKSApOwoKCQkJLy8gQWRkIG5ldyBjbGFzc2VzIGlmIGFuIGljb24gaXMgc3VwcG9zZWQgdG8gYmUgcHJlc2VudAoJCQlpZiAoIGhhc0ljb24gKSB7CgkJCQlhbmNob3IuYWRkQ2xhc3MoCgkJCQkJWyBpY29ucG9zQ2xhc3MoIG9wdHMuaWNvbnBvcyAhPT0gdW5kZWZpbmVkID8KCQkJCQkJb3B0cy5pY29ucG9zIDogY3VycmVudE9wdHMuaWNvbnBvcyApIF0KCQkJCQkJLmNvbmNhdCggaXNDb2xsYXBzZWQgPwoJCQkJCQkJWyAidWktaWNvbi0iICsgKCBvcHRzLmNvbGxhcHNlZEljb24gIT09IHVuZGVmaW5lZCA/CgkJCQkJCQkJb3B0cy5jb2xsYXBzZWRJY29uIDoKCQkJCQkJCQljdXJyZW50T3B0cy5jb2xsYXBzZWRJY29uICkgXSA6CgkJCQkJCQlbICJ1aS1pY29uLSIgKyAoIG9wdHMuZXhwYW5kZWRJY29uICE9PSB1bmRlZmluZWQgPwoJCQkJCQkJCW9wdHMuZXhwYW5kZWRJY29uIDoKCQkJCQkJCQljdXJyZW50T3B0cy5leHBhbmRlZEljb24gKSBdICkKCQkJCQkJLmpvaW4oICIgIiApICk7CgkJCX0KCQl9CgoJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYnRuLSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1idG4tIiwgb3B0cy50aGVtZSApOwoJCQlhbmNob3IucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdHMuY29udGVudFRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCW9sZFRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsCgkJCQljdXJyZW50T3B0cy5jb250ZW50VGhlbWUgKTsKCQkJbmV3VGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwKCQkJCW9wdHMuY29udGVudFRoZW1lICk7CgkJCXVpLmNvbnRlbnQucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdHMuaW5zZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWluc2V0Iiwgb3B0cy5pbnNldCApOwoJCQloYXNDb3JuZXJzID0gISEoIG9wdHMuaW5zZXQgJiYgKCBvcHRzLmNvcm5lcnMgfHwgY3VycmVudE9wdHMuY29ybmVycyApICk7CgkJfQoKCQlpZiAoIG9wdHMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQloYXNDb3JuZXJzID0gISEoIG9wdHMuY29ybmVycyAmJiAoIG9wdHMuaW5zZXQgfHwgY3VycmVudE9wdHMuaW5zZXQgKSApOwoJCX0KCgkJaWYgKCBoYXNDb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0udG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgaGFzQ29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRzLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJYW5jaG9yLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdHMubWluaSApOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXRoaXMuX2FwcGx5T3B0aW9ucyggb3B0aW9ucyApOwoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJdGhpcy5fcmVuZGVyZWRPcHRpb25zID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICk7Cgl9LAoKCV9oYW5kbGVFeHBhbmRDb2xsYXBzZTogZnVuY3Rpb24oIGlzQ29sbGFwc2UgKSB7CgkJdmFyIG9wdHMgPSB0aGlzLl9yZW5kZXJlZE9wdGlvbnMsCgkJCXVpID0gdGhpcy5fdWk7CgoJCXVpLnN0YXR1cy50ZXh0KCBpc0NvbGxhcHNlID8gb3B0cy5leHBhbmRDdWVUZXh0IDogb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQl1aS5oZWFkaW5nCgkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uLCAhaXNDb2xsYXBzZSApCgoJCQkvLyBsb2dpYyBvciBjYXVzZSBzYW1lIGljb24gZm9yIGV4cGFuZGVkL2NvbGxhcHNlZCBzdGF0ZSB3b3VsZCByZW1vdmUgdGhlIHVpLWljb24tY2xhc3MKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uLCAoIGlzQ29sbGFwc2UgfHwgb3B0cy5leHBhbmRlZEljb24gPT09IG9wdHMuY29sbGFwc2VkSWNvbiApICkKCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICk7CgkJdWkuY29udGVudAoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgaXNDb2xsYXBzZSApCgkJCS50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCXRoaXMub3B0aW9ucy5jb2xsYXBzZWQgPSBpc0NvbGxhcHNlOwoJCXRoaXMuX3RyaWdnZXIoIGlzQ29sbGFwc2UgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCX0sCgoJZXhwYW5kOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggZmFsc2UgKTsKCX0sCgoJY29sbGFwc2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCB0cnVlICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdWkgPSB0aGlzLl91aSwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHVpLnBsYWNlaG9sZGVyICkgewoJCQl1aS5vcmlnaW5hbEhlYWRpbmcuaW5zZXJ0QmVmb3JlKCB1aS5wbGFjZWhvbGRlciApOwoJCQl1aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCQkJdWkuaGVhZGluZy5yZW1vdmUoKTsKCQl9IGVsc2UgewoJCQl1aS5zdGF0dXMucmVtb3ZlKCk7CgkJCXVpLmhlYWRpbmcKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmcgdWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkKCQkJCS5jaGlsZHJlbigpCgkJCQkJLmNvbnRlbnRzKCkKCQkJCQkJLnVud3JhcCgpOwoJCX0KCgkJdWkuYW5jaG9yLmNvbnRlbnRzKCkudW53cmFwKCk7CgkJdWkuY29udGVudC5jb250ZW50cygpLnVud3JhcCgpOwoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSB1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQgIiArCgkJCQkidWktY29sbGFwc2libGUtdGhlbWVkLWNvbnRlbnQgdWktY29sbGFwc2libGUtaW5zZXQgdWktY29ybmVyLWFsbCIgKTsKCX0KfSk7CgovLyBEZWZhdWx0cyB0byBiZSB1c2VkIGJ5IGFsbCBpbnN0YW5jZXMgb2YgY29sbGFwc2libGUgaWYgcGVyLWluc3RhbmNlIHZhbHVlcwovLyBhcmUgdW5zZXQgb3IgaWYgbm90aGluZyBpcyBzcGVjaWZpZWQgYnkgd2F5IG9mIGluaGVyaXRhbmNlIGZyb20gYW4gYWNjb3JkaW9uLgovLyBOb3RlIHRoYXQgdGhpcyBoYXNoIGRvZXMgbm90IGNvbnRhaW4gb3B0aW9ucyAiY29sbGFwc2VkIiBvciAiaGVhZGluZyIsCi8vIGJlY2F1c2UgdGhvc2UgYXJlIG5vdCBpbmhlcml0YWJsZS4KJC5tb2JpbGUuY29sbGFwc2libGUuZGVmYXVsdHMgPSB7CglleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJY29sbGFwc2VkSWNvbjogInBsdXMiLAoJY29udGVudFRoZW1lOiAiaW5oZXJpdCIsCglleHBhbmRlZEljb246ICJtaW51cyIsCglpY29ucG9zOiAibGVmdCIsCglpbnNldDogdHJ1ZSwKCWNvcm5lcnM6IHRydWUsCgl0aGVtZTogImluaGVyaXQiLAoJbWluaTogZmFsc2UKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHVpU2NyZWVuSGlkZGVuUmVnZXggPSAvXGJ1aS1zY3JlZW4taGlkZGVuXGIvOwpmdW5jdGlvbiBub0hpZGRlbkNsYXNzKCBlbGVtZW50cyApIHsKCXZhciBpbmRleCwKCQlsZW5ndGggPSBlbGVtZW50cy5sZW5ndGgsCgkJcmVzdWx0ID0gW107CgoJZm9yICggaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQlpZiAoICFlbGVtZW50c1sgaW5kZXggXS5jbGFzc05hbWUubWF0Y2goIHVpU2NyZWVuSGlkZGVuUmVnZXggKSApIHsKCQkJcmVzdWx0LnB1c2goIGVsZW1lbnRzWyBpbmRleCBdICk7CgkJfQoJfQoKCXJldHVybiAkKCByZXN1bHQgKTsKfQoKJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgPSB7CglfZ2V0VmlzaWJsZXM6IGZ1bmN0aW9uKCAkZWxzLCBjcmVhdGUgKSB7CgkJdmFyIHZpc2libGVzOwoKCQlpZiAoIGNyZWF0ZSApIHsKCQkJdmlzaWJsZXMgPSBub0hpZGRlbkNsYXNzKCAkZWxzICk7CgkJfSBlbHNlIHsKCQkJdmlzaWJsZXMgPSAkZWxzLmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQlpZiAoIHZpc2libGVzLmxlbmd0aCA9PT0gMCApIHsKCQkJCXZpc2libGVzID0gbm9IaWRkZW5DbGFzcyggJGVscyApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdmlzaWJsZXM7Cgl9LAoKCV9hZGRGaXJzdExhc3RDbGFzc2VzOiBmdW5jdGlvbiggJGVscywgJHZpc2libGVzLCBjcmVhdGUgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7CgkJJHZpc2libGVzLmVxKCAwICkuYWRkQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCIgKS5lbmQoKS5sYXN0KCkuYWRkQ2xhc3MoICJ1aS1sYXN0LWNoaWxkIiApOwoJCWlmICggIWNyZWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJfQoJfSwKCglfcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yID0gIjptb2JpbGUtY29sbGFwc2libGUsICIgKyAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3I7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZXNldCIsICQuZXh0ZW5kKCB7CgoJLy8gVGhlIGluaXRTZWxlY3RvciBpcyBkZXByZWNhdGVkIGFzIG9mIDEuNC4wLiBJbiAxLjUuMCB3ZSB3aWxsIHVzZQoJLy8gOmpxbURhdGEocm9sZT0nY29sbGFwc2libGVzZXQnKSB3aGljaCB3aWxsIGFsbG93IHVzIHRvIGdldCByaWQgb2YgdGhlIGxpbmUKCS8vIGJlbG93IGFsdG9nZXRoZXIsIGJlY2F1c2UgdGhlIGF1dG9pbml0IHdpbGwgZ2VuZXJhdGUgc3VjaCBhbiBpbml0U2VsZWN0b3IKCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpLDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlc2V0JykiLAoKCW9wdGlvbnM6ICQuZXh0ZW5kKCB7CgkJZW5oYW5jZWQ6IGZhbHNlCgl9LCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0cyApLAoKCV9oYW5kbGVDb2xsYXBzaWJsZUV4cGFuZDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBjbG9zZXN0Q29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApOwoKCQlpZiAoIGNsb3Nlc3RDb2xsYXBzaWJsZS5wYXJlbnQoKS5pcyggIjptb2JpbGUtY29sbGFwc2libGVzZXQsIDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApICkgewoJCQljbG9zZXN0Q29sbGFwc2libGUKCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZTpub3QoLnVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCkiICkKCQkJCS5jb2xsYXBzaWJsZSggImNvbGxhcHNlIiApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9jbGFzc2VzOiAiIgoJCX0pOwoKCQlpZiAoICFvcHRzLmVuaGFuY2VkICkgewoJCQllbGVtLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0ICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJKCBvcHRzLmNvcm5lcnMgJiYgb3B0cy5pbnNldCA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3IgKS5jb2xsYXBzaWJsZSgpOwoJCX0KCgkJdGhpcy5fb24oIGVsZW0sIHsgY29sbGFwc2libGVleHBhbmQ6ICJfaGFuZGxlQ29sbGFwc2libGVFeHBhbmQiIH0gKTsKCX0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggcHJlZml4LCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogcHJlZml4ICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCB0cnVlICk7CgoJCS8vIEJlY2F1c2UgdGhlIGNvcm5lcnMgYXJlIGhhbmRsZWQgYnkgdGhlIGNvbGxhcHNpYmxlIGl0c2VsZiBhbmQgdGhlIGRlZmF1bHQgc3RhdGUgaXMgY29sbGFwc2VkCgkJLy8gVGhhdCB3YXMgY2F1c2luZyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQxMTYKCQl0aGlzLmVsZW1lbnQKCQkJLmNoaWxkcmVuKCBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yICkKCQkJLmZpbHRlciggIjpqcW1EYXRhKGNvbGxhcHNlZD0nZmFsc2UnKSIgKQoJCQkuY29sbGFwc2libGUoICJleHBhbmQiICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgcmV0LCBoYXNDb3JuZXJzLAoJCQllbGVtID0gdGhpcy5lbGVtZW50LAoJCQl0aGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCBvcHRpb25zLnRoZW1lICk7CgoJCWlmICggdGhlbWVDbGFzcyApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIHRoaXMub3B0aW9ucy50aGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhlbWVDbGFzcyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmluc2V0ICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0aW9ucy5pbnNldCAmJiAoIG9wdGlvbnMuY29ybmVycyB8fCB0aGlzLm9wdGlvbnMuY29ybmVycyApICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQloYXNDb3JuZXJzID0gISEoIG9wdGlvbnMuY29ybmVycyAmJiAoIG9wdGlvbnMuaW5zZXQgfHwgdGhpcy5vcHRpb25zLmluc2V0ICkgKTsKCQl9CgoJCWlmICggaGFzQ29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIGhhc0Nvcm5lcnMgKTsKCQl9CgoJCXJldCA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiOm1vYmlsZS1jb2xsYXBzaWJsZSIgKS5jb2xsYXBzaWJsZSggInJlZnJlc2giICk7CgkJcmV0dXJuIHJldDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuZWxlbWVudDsKCgkJdGhpcy5fcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlcyggZWwuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKSApOwoJCWVsCgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCB1aS1jb3JuZXItYWxsICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCB0aGlzLm9wdGlvbnMudGhlbWUgKSApCgkJCS5jaGlsZHJlbiggIjptb2JpbGUtY29sbGFwc2libGUiICkKCQkJLmNvbGxhcHNpYmxlKCAiZGVzdHJveSIgKTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyIGNvbGxhcHNpYmxlc0luU2V0ID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yICk7CgoJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3IgKS5ub3QoICIudWktY29sbGFwc2libGUiICkuY29sbGFwc2libGUoKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggY29sbGFwc2libGVzSW5TZXQsIHRoaXMuX2dldFZpc2libGVzKCBjb2xsYXBzaWJsZXNJblNldCwgY3JlYXRlICksIGNyZWF0ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIERlcHJlY2F0ZWQgaW4gMS40CiQuZm4uZmllbGRjb250YWluID0gZnVuY3Rpb24oLyogb3B0aW9ucyAqLykgewoJcmV0dXJuIHRoaXMuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIiApOwp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmdyaWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCWdyaWQ6IG51bGwKCQkJfSwgb3B0aW9ucyApLAoJCQkka2lkcyA9ICR0aGlzLmNoaWxkcmVuKCksCgkJCWdyaWRDb2xzID0geyBzb2xvOjEsIGE6MiwgYjozLCBjOjQsIGQ6NSB9LAoJCQlncmlkID0gby5ncmlkLAoJCQlpdGVyYXRvciwKCQkJbGV0dGVyOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggbGV0dGVyIGluIGdyaWRDb2xzICkgewoJCQkJCQlpZiAoIGdyaWRDb2xzWyBsZXR0ZXIgXSA9PT0gJGtpZHMubGVuZ3RoICkgewoJCQkJCQkJZ3JpZCA9IGxldHRlcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJZ3JpZCA9ICJhIjsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtZHVvIiApOwoJCQkJfQoJCQl9CgkJCWl0ZXJhdG9yID0gZ3JpZENvbHNbZ3JpZF07CgoJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC0iICsgZ3JpZCApOwoKCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzEpIiApLmFkZENsYXNzKCAidWktYmxvY2stYSIgKTsKCgkJaWYgKCBpdGVyYXRvciA+IDEgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMikiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1iIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMiApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibiszKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWMiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAzICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzQpIiApLmFkZENsYXNzKCAidWktYmxvY2stZCIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDQgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1lIiApOwoJCX0KCX0pOwp9Owp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLm5hdmJhciIsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgJG5hdmJhciA9IHRoaXMuZWxlbWVudCwKCQkJJG5hdmJ0bnMgPSAkbmF2YmFyLmZpbmQoICJhLCBidXR0b24iICksCgkJCWljb25wb3MgPSAkbmF2YnRucy5maWx0ZXIoICI6anFtRGF0YShpY29uKSIgKS5sZW5ndGggPyB0aGlzLm9wdGlvbnMuaWNvbnBvcyA6IHVuZGVmaW5lZDsKCgkJJG5hdmJhci5hZGRDbGFzcyggInVpLW5hdmJhciIgKQoJCQkuYXR0ciggInJvbGUiLCAibmF2aWdhdGlvbiIgKQoJCQkuZmluZCggInVsIiApCgkJCS5qcW1FbmhhbmNlYWJsZSgpCgkJCS5ncmlkKHsgZ3JpZDogdGhpcy5vcHRpb25zLmdyaWQgfSk7CgoJCSRuYXZidG5zCgkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBpY29uID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiaWNvbiIgKSwKCQkJCQl0aGVtZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgInRoZW1lIiApLAoJCQkJCWNsYXNzZXMgPSAidWktYnRuIjsKCgkJCQlpZiAoIHRoZW1lICkgewoJCQkJCWNsYXNzZXMgKz0gIiB1aS1idG4tIiArIHRoZW1lOwoJCQkJfQoJCQkJaWYgKCBpY29uICkgewoJCQkJCWNsYXNzZXMgKz0gIiB1aS1pY29uLSIgKyBpY29uICsgIiB1aS1idG4taWNvbi0iICsgaWNvbnBvczsKCQkJCX0KCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggY2xhc3NlcyApOwoJCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggdGhpcyApOwoKCQkJaWYgKCAhKCBhY3RpdmVCdG4uaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSB8fAoKCQkJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgYWZ0ZXIgMS40LjAgcmVsZWFzZQoJCQkJLy8gb25seSB1aS1zdGF0ZS1kaXNhYmxlZCBzaG91bGQgYmUgcHJlc2VudCB0aGVyZWFmdGVyCgkJCQlhY3RpdmVCdG4uaGFzQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKSB8fAoJCQkJYWN0aXZlQnRuLmhhc0NsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApICkgKSB7CgoJCQkJJG5hdmJ0bnMucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQlhY3RpdmVCdG4uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCQkJLy8gVGhlIGNvZGUgYmVsb3cgaXMgYSB3b3JrYXJvdW5kIHRvIGZpeCAjMTE4MQoJCQkJJCggZG9jdW1lbnQgKS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWFjdGl2ZUJ0bi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0pOwoJCQl9CgkJfSk7CgoJCS8vIEJ1dHRvbnMgaW4gdGhlIG5hdmJhciB3aXRoIHVpLXN0YXRlLXBlcnNpc3QgY2xhc3Mgc2hvdWxkIHJlZ2FpbiB0aGVpciBhY3RpdmUgc3RhdGUgYmVmb3JlIHBhZ2Ugc2hvdwoJCSRuYXZiYXIuY2xvc2VzdCggIi51aS1wYWdlIiApLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkkbmF2YnRucy5maWx0ZXIoICIudWktc3RhdGUtcGVyc2lzdCIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBnZXRBdHRyID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlOwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLmV4dGVuZCggewoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3VudFRoZW1lOiBudWxsLCAvKiBEZXByZWNhdGVkIGluIDEuNCAqLwoJCWRpdmlkZXJUaGVtZTogbnVsbCwKCQlpY29uOiAiY2FyYXQtciIsCgkJc3BsaXRJY29uOiAiY2FyYXQtciIsCgkJc3BsaXRUaGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpbnNldDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSB0aGlzLAoJCQlsaXN0dmlld0NsYXNzZXMgPSAiIjsKCgkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5pbnNldCA/ICIgdWktbGlzdHZpZXctaW5zZXQiIDogIiI7CgoJCWlmICggISF0Lm9wdGlvbnMuaW5zZXQgKSB7CgkJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIjsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIjsKCQl9CgoJCS8vIGNyZWF0ZSBsaXN0dmlldyBtYXJrdXAKCQl0LmVsZW1lbnQuYWRkQ2xhc3MoICIgdWktbGlzdHZpZXciICsgbGlzdHZpZXdDbGFzc2VzICk7CgoJCXQucmVmcmVzaCggdHJ1ZSApOwoJfSwKCgkvLyBUT0RPOiBSZW1vdmUgaW4gMS41CglfZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbmV4dFByb3AsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciBkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXR1cm4gZWxlOwoJCQl9CgkJCWVsZSA9IGVsZVsgbmV4dFByb3AgXTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoJLy8gVE9ETzogUmVtb3ZlIGluIDEuNQoJX2FkZFRodW1iQ2xhc3NlczogZnVuY3Rpb24oIGNvbnRhaW5lcnMgKSB7CgkJdmFyIGksIGltZywgbGVuID0gY29udGFpbmVycy5sZW5ndGg7CgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJaW1nID0gJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggY29udGFpbmVyc1sgaSBdLmZpcnN0Q2hpbGQsICJuZXh0U2libGluZyIsICJpbWciLCAiSU1HIiApICk7CgkJCWlmICggaW1nLmxlbmd0aCApIHsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5oYXNDbGFzcyggInVpLWxpLWljb24iICkgPyAidWktbGktaGFzLWljb24iIDogInVpLWxpLWhhcy10aHVtYiIgKTsKCQkJfQoJCX0KCX0sCgoJX2dldENoaWxkcmVuQnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgcmVzdWx0cyA9IFtdLAoJCQlkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJZWxlID0gZWxlLmZpcnN0Q2hpbGQ7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZSApOwoJCQl9CgkJCWVsZSA9IGVsZS5uZXh0U2libGluZzsKCQl9CgkJcmV0dXJuICQoIHJlc3VsdHMgKTsKCX0sCgoJX2JlZm9yZUxpc3R2aWV3UmVmcmVzaDogJC5ub29wLAoJX2FmdGVyTGlzdHZpZXdSZWZyZXNoOiAkLm5vb3AsCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl2YXIgYnV0dG9uQ2xhc3MsIHBvcywgbnVtbGksIGl0ZW0sIGl0ZW1DbGFzcywgaXRlbVRoZW1lLCBpdGVtSWNvbiwgaWNvbiwgYSwKCQkJaXNEaXZpZGVyLCBzdGFydENvdW50LCBuZXdTdGFydENvdW50LCB2YWx1ZSwgbGFzdCwgc3BsaXR0aGVtZSwgc3BsaXRUaGVtZUNsYXNzLCBzcGxpdGljb24sCgkJCWFsdEJ1dHRvbkNsYXNzLCBkaXZpZGVyVGhlbWUsIGxpLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkkbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJb2wgPSAhISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSwKCQkJc3RhcnQgPSAkbGlzdC5hdHRyKCAic3RhcnQiICksCgkJCWl0ZW1DbGFzc0RpY3QgPSB7fSwKCQkJY291bnRCdWJibGVzID0gJGxpc3QuZmluZCggIi51aS1saS1jb3VudCIgKSwKCQkJY291bnRUaGVtZSA9IGdldEF0dHIoICRsaXN0WyAwIF0sICJjb3VudHRoZW1lIiApIHx8IHRoaXMub3B0aW9ucy5jb3VudFRoZW1lLAoJCQljb3VudFRoZW1lQ2xhc3MgPSBjb3VudFRoZW1lID8gInVpLWJvZHktIiArIGNvdW50VGhlbWUgOiAidWktYm9keS1pbmhlcml0IjsKCgkJaWYgKCBvLnRoZW1lICkgewoJCQkkbGlzdC5hZGRDbGFzcyggInVpLWdyb3VwLXRoZW1lLSIgKyBvLnRoZW1lICk7CgkJfQoKCQkvLyBDaGVjayBpZiBhIHN0YXJ0IGF0dHJpYnV0ZSBoYXMgYmVlbiBzZXQgd2hpbGUgdGFraW5nIGEgdmFsdWUgb2YgMCBpbnRvIGFjY291bnQKCQlpZiAoIG9sICYmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSApIHsKCQkJc3RhcnRDb3VudCA9IHBhcnNlSW50KCBzdGFydCwgMTAgKSAtIDE7CgkJCSRsaXN0LmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgc3RhcnRDb3VudCApOwoJCX0KCgkJdGhpcy5fYmVmb3JlTGlzdHZpZXdSZWZyZXNoKCk7CgoJCWxpID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoICRsaXN0WyAwIF0sICJsaSIsICJMSSIgKTsKCgkJZm9yICggcG9zID0gMCwgbnVtbGkgPSBsaS5sZW5ndGg7IHBvcyA8IG51bWxpOyBwb3MrKyApIHsKCQkJaXRlbSA9IGxpLmVxKCBwb3MgKTsKCQkJaXRlbUNsYXNzID0gIiI7CgoJCQlpZiAoIGNyZWF0ZSB8fCBpdGVtWyAwIF0uY2xhc3NOYW1lLnNlYXJjaCggL1xidWktbGktc3RhdGljXGJ8XGJ1aS1saS1kaXZpZGVyXGIvICkgPCAwICkgewoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQlpc0RpdmlkZXIgPSAoIGdldEF0dHIoIGl0ZW1bIDAgXSwgInJvbGUiICkgPT09ICJsaXN0LWRpdmlkZXIiICk7CgkJCQl2YWx1ZSA9IGl0ZW0uYXR0ciggInZhbHVlIiApOwoJCQkJaXRlbVRoZW1lID0gZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiICk7CgoJCQkJaWYgKCBhLmxlbmd0aCAmJiBhWyAwIF0uY2xhc3NOYW1lLnNlYXJjaCggL1xidWktYnRuXGIvICkgPCAwICYmICFpc0RpdmlkZXIgKSB7CgkJCQkJaXRlbUljb24gPSBnZXRBdHRyKCBpdGVtWyAwIF0sICJpY29uIiApOwoJCQkJCWljb24gPSAoIGl0ZW1JY29uID09PSBmYWxzZSApID8gZmFsc2UgOiAoIGl0ZW1JY29uIHx8IG8uaWNvbiApOwoKCQkJCQkvLyBUT0RPOiBSZW1vdmUgaW4gMS41IHRvZ2V0aGVyIHdpdGggbGlua3MuanMgKGxpbmtzLmpzIC8gLnVpLWxpbmsgZGVwcmVjYXRlZCBpbiAxLjQpCgkJCQkJYS5yZW1vdmVDbGFzcyggInVpLWxpbmsiICk7CgoJCQkJCWJ1dHRvbkNsYXNzID0gInVpLWJ0biI7CgoJCQkJCWlmICggaXRlbVRoZW1lICkgewoJCQkJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi0iICsgaXRlbVRoZW1lOwoJCQkJCX0KCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyA9ICJ1aS1saS1oYXMtYWx0IjsKCgkJCQkJCWxhc3QgPSBhLmxhc3QoKTsKCQkJCQkJc3BsaXR0aGVtZSA9IGdldEF0dHIoIGxhc3RbIDAgXSwgInRoZW1lIiApIHx8IG8uc3BsaXRUaGVtZSB8fCBnZXRBdHRyKCBpdGVtWyAwIF0sICJ0aGVtZSIsIHRydWUgKTsKCQkJCQkJc3BsaXRUaGVtZUNsYXNzID0gc3BsaXR0aGVtZSA/ICIgdWktYnRuLSIgKyBzcGxpdHRoZW1lIDogIiI7CgkJCQkJCXNwbGl0aWNvbiA9IGdldEF0dHIoIGxhc3RbIDAgXSwgImljb24iICkgfHwgZ2V0QXR0ciggaXRlbVsgMCBdLCAiaWNvbiIgKSB8fCBvLnNwbGl0SWNvbjsKCQkJCQkJYWx0QnV0dG9uQ2xhc3MgPSAidWktYnRuIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1pY29uLSIgKyBzcGxpdGljb24gKyBzcGxpdFRoZW1lQ2xhc3M7CgoJCQkJCQlsYXN0CgkJCQkJCQkuYXR0ciggInRpdGxlIiwgJC50cmltKCBsYXN0LmdldEVuY29kZWRUZXh0KCkgKSApCgkJCQkJCQkuYWRkQ2xhc3MoIGFsdEJ1dHRvbkNsYXNzICkKCQkJCQkJCS5lbXB0eSgpOwoKCQkJCQkJLy8gUmVkdWNlIHRvIHRoZSBmaXJzdCBhbmNob3IsIGJlY2F1c2Ugb25seSB0aGUgZmlyc3QgZ2V0cyB0aGUgYnV0dG9uQ2xhc3MKCQkJCQkJYSA9IGEuZmlyc3QoKTsKCQkJCQl9IGVsc2UgaWYgKCBpY29uICkgewoJCQkJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi1pY29uLXJpZ2h0IHVpLWljb24tIiArIGljb247CgkJCQkJfQoKCQkJCQkvLyBBcHBseSBidXR0b25DbGFzcyB0byB0aGUgKGZpcnN0KSBhbmNob3IKCQkJCQlhLmFkZENsYXNzKCBidXR0b25DbGFzcyApOwoJCQkJfSBlbHNlIGlmICggaXNEaXZpZGVyICkgewoJCQkJCWRpdmlkZXJUaGVtZSA9ICggZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiICkgfHwgby5kaXZpZGVyVGhlbWUgfHwgby50aGVtZSApOwoKCQkJCQlpdGVtQ2xhc3MgPSAidWktbGktZGl2aWRlciB1aS1iYXItIiArICggZGl2aWRlclRoZW1lID8gZGl2aWRlclRoZW1lIDogImluaGVyaXQiICk7CgoJCQkJCWl0ZW0uYXR0ciggInJvbGUiLCAiaGVhZGluZyIgKTsKCQkJCX0gZWxzZSBpZiAoIGEubGVuZ3RoIDw9IDAgKSB7CgkJCQkJaXRlbUNsYXNzID0gInVpLWxpLXN0YXRpYyB1aS1ib2R5LSIgKyAoIGl0ZW1UaGVtZSA/IGl0ZW1UaGVtZSA6ICJpbmhlcml0IiApOwoJCQkJfQoJCQkJaWYgKCBvbCAmJiB2YWx1ZSApIHsKCQkJCQluZXdTdGFydENvdW50ID0gcGFyc2VJbnQoIHZhbHVlICwgMTAgKSAtIDE7CgoJCQkJCWl0ZW0uY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBuZXdTdGFydENvdW50ICk7CgkJCQl9CgkJCX0KCgkJCS8vIEluc3RlYWQgb2Ygc2V0dGluZyBpdGVtIGNsYXNzIGRpcmVjdGx5IG9uIHRoZSBsaXN0IGl0ZW0KCQkJLy8gYXQgdGhpcyBwb2ludCBpbiB0aW1lLCBwdXNoIHRoZSBpdGVtIGludG8gYSBkaWN0aW9uYXJ5CgkJCS8vIHRoYXQgdGVsbHMgdXMgd2hhdCBjbGFzcyB0byBzZXQgb24gaXQgc28gd2UgY2FuIGRvIHRoaXMgYWZ0ZXIgdGhpcwoJCQkvLyBwcm9jZXNzaW5nIGxvb3AgaXMgZmluaXNoZWQuCgoJCQlpZiAoICFpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSApIHsKCQkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdID0gW107CgkJCX0KCgkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdLnB1c2goIGl0ZW1bIDAgXSApOwoJCX0KCgkJLy8gU2V0IHRoZSBhcHByb3ByaWF0ZSBsaXN0dmlldyBpdGVtIGNsYXNzZXMgb24gZWFjaCBsaXN0IGl0ZW0uCgkJLy8gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQljb3VudEJ1YmJsZXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICk7CgkJfSk7CgkJaWYgKCBjb3VudFRoZW1lQ2xhc3MgKSB7CgkJCWNvdW50QnViYmxlcy5ub3QoICJbY2xhc3MqPSd1aS1ib2R5LSddIiApLmFkZENsYXNzKCBjb3VudFRoZW1lQ2xhc3MgKTsKCQl9CgoJCS8vIERlcHJlY2F0ZWQgaW4gMS40LiBGcm9tIDEuNSB5b3UgaGF2ZSB0byBhZGQgY2xhc3MgdWktbGktaGFzLXRodW1iIG9yIHVpLWxpLWhhcy1pY29uIHRvIHRoZSBMSS4KCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoIGxpICk7CgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCBsaS5maW5kKCAiLnVpLWJ0biIgKSApOwoKCQl0aGlzLl9hZnRlckxpc3R2aWV3UmVmcmVzaCgpOwoKCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBsaSwgdGhpcy5fZ2V0VmlzaWJsZXMoIGxpLCBjcmVhdGUgKSwgY3JlYXRlICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKZnVuY3Rpb24gZGVmYXVsdEF1dG9kaXZpZGVyc1NlbGVjdG9yKCBlbHQgKSB7CgkvLyBsb29rIGZvciB0aGUgdGV4dCBpbiB0aGUgZ2l2ZW4gZWxlbWVudAoJdmFyIHRleHQgPSAkLnRyaW0oIGVsdC50ZXh0KCkgKSB8fCBudWxsOwoKCWlmICggIXRleHQgKSB7CgkJcmV0dXJuIG51bGw7Cgl9CgoJLy8gY3JlYXRlIHRoZSB0ZXh0IGZvciB0aGUgZGl2aWRlciAoZmlyc3QgdXBwZXJjYXNlZCBsZXR0ZXIpCgl0ZXh0ID0gdGV4dC5zbGljZSggMCwgMSApLnRvVXBwZXJDYXNlKCk7CgoJcmV0dXJuIHRleHQ7Cn0KCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUubGlzdHZpZXcsIHsKCW9wdGlvbnM6IHsKCQlhdXRvZGl2aWRlcnM6IGZhbHNlLAoJCWF1dG9kaXZpZGVyc1NlbGVjdG9yOiBkZWZhdWx0QXV0b2RpdmlkZXJzU2VsZWN0b3IKCX0sCgoJX2JlZm9yZUxpc3R2aWV3UmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2RpdmlkZXJzICkgewoJCQl0aGlzLl9yZXBsYWNlRGl2aWRlcnMoKTsKCQkJdGhpcy5fc3VwZXJBcHBseSggYXJndW1lbnRzICk7CgkJfQoJfSwKCglfcmVwbGFjZURpdmlkZXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgaSwgbGlzLCBsaSwgZGl2aWRlclRleHQsCgkJCWxhc3REaXZpZGVyVGV4dCA9IG51bGwsCgkJCWxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCWRpdmlkZXI7CgoJCWxpc3QuY2hpbGRyZW4oICJsaTpqcW1EYXRhKHJvbGU9J2xpc3QtZGl2aWRlcicpIiApLnJlbW92ZSgpOwoKCQlsaXMgPSBsaXN0LmNoaWxkcmVuKCAibGkiICk7CgoJCWZvciAoIGkgPSAwOyBpIDwgbGlzLmxlbmd0aCA7IGkrKyApIHsKCQkJbGkgPSBsaXNbIGkgXTsKCQkJZGl2aWRlclRleHQgPSB0aGlzLm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IoICQoIGxpICkgKTsKCgkJCWlmICggZGl2aWRlclRleHQgJiYgbGFzdERpdmlkZXJUZXh0ICE9PSBkaXZpZGVyVGV4dCApIHsKCQkJCWRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggZGl2aWRlclRleHQgKSApOwoJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgImxpc3QtZGl2aWRlciIgKTsKCQkJCWxpLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBkaXZpZGVyLCBsaSApOwoJCQl9CgoJCQlsYXN0RGl2aWRlclRleHQgPSBkaXZpZGVyVGV4dDsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcmRpdmlkZXIgPSAvKF58XHMpdWktbGktZGl2aWRlcigkfFxzKS8sCglyaGlkZGVuID0gLyhefFxzKXVpLXNjcmVlbi1oaWRkZW4oJHxccykvOwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS5saXN0dmlldywgewoJb3B0aW9uczogewoJCWhpZGVEaXZpZGVyczogZmFsc2UKCX0sCgoJX2FmdGVyTGlzdHZpZXdSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgaXRlbXMsIGlkeCwgaXRlbSwgaGlkZURpdmlkZXIgPSB0cnVlOwoKCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlkZURpdmlkZXJzICkgewoJCQlpdGVtcyA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCB0aGlzLmVsZW1lbnRbIDAgXSwgImxpIiwgIkxJIiApOwoJCQlmb3IgKCBpZHggPSBpdGVtcy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJCWl0ZW0gPSBpdGVtc1sgaWR4IF07CgkJCQlpZiAoIGl0ZW0uY2xhc3NOYW1lLm1hdGNoKCByZGl2aWRlciApICkgewoJCQkJCWlmICggaGlkZURpdmlkZXIgKSB7CgkJCQkJCWl0ZW0uY2xhc3NOYW1lID0gaXRlbS5jbGFzc05hbWUgKyAiIHVpLXNjcmVlbi1oaWRkZW4iOwoJCQkJCX0KCQkJCQloaWRlRGl2aWRlciA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCWlmICggIWl0ZW0uY2xhc3NOYW1lLm1hdGNoKCByaGlkZGVuICkgKSB7CgkJCQkJCWhpZGVEaXZpZGVyID0gZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubm9qcyA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkkKCAiOmpxbURhdGEocm9sZT0nbm9qcycpIiwgdGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1ub2pzIiApOwp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ID0gewoJX2hhbmRsZUZvcm1SZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKSwgewoJCQlyZXNldDogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9kZWxheSggIl9yZXNldCIgKTsKCQkJfQoJCX0pOwoJfQp9OwoKfSkoIGpRdWVyeSApOwoKLyoKKiAiY2hlY2tib3hyYWRpbyIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBlc2NhcGVJZCA9ICQubW9iaWxlLnBhdGguaGFzaFRvU2VsZWN0b3I7CgokLndpZGdldCggIm1vYmlsZS5jaGVja2JveHJhZGlvIiwgJC5leHRlbmQoIHsKCglpbml0U2VsZWN0b3I6ICJpbnB1dDpub3QoIDpqcW1EYXRhKHJvbGU9J2ZsaXBzd2l0Y2gnICkgKVt0eXBlPSdjaGVja2JveCddLGlucHV0W3R5cGU9J3JhZGlvJ106bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJyApKSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiAiaW5oZXJpdCIsCgoJCS8vIERlcHJlY2F0ZWQgYXMgb2YgMS41LjAKCQltaW5pOiBmYWxzZSwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCWljb25wb3M6ICJsZWZ0IgoKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWluaGVyaXRBdHRyID0gZnVuY3Rpb24oIGlucHV0LCBkYXRhQXR0ciApIHsKCQkJCXJldHVybiBpbnB1dC5qcW1EYXRhKCBkYXRhQXR0ciApIHx8CgkJCQkJaW5wdXQuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0IiApLmpxbURhdGEoIGRhdGFBdHRyICk7CgkJCX0sCgkJCWxhYmVsID0gdGhpcy5vcHRpb25zLmVuaGFuY2VkID8KCQkJCXsKCQkJCQllbGVtZW50OiB0aGlzLmVsZW1lbnQuc2libGluZ3MoICJsYWJlbCIgKSwKCQkJCQlpc1BhcmVudDogZmFsc2UKCQkJCX0gOgoJCQkJdGhpcy5fZmluZExhYmVsKCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyBpbnB1dHR5cGUgKyAiLW9mZiI7CgoJCWlmICggaW5wdXR0eXBlICE9PSAiY2hlY2tib3giICYmIGlucHV0dHlwZSAhPT0gInJhZGlvIiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0aGlzLmVsZW1lbnRbMF0uZGlzYWJsZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQlvLmljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApIHx8CgkJCWxhYmVsLmVsZW1lbnQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3MiICkgfHwgby5pY29ucG9zLAoKCQkvLyBEZXByZWNhdGVkIGFzIG9mIDEuNS4wCgkJLy8gRXN0YWJsaXNoIG9wdGlvbnMKCQlvLm1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApIHx8IG8ubWluaTsKCgkJLy8gRXhwb3NlIGZvciBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJaW5wdXQ6IGlucHV0LAoJCQlsYWJlbDogbGFiZWwuZWxlbWVudCwKCQkJbGFiZWxJc1BhcmVudDogbGFiZWwuaXNQYXJlbnQsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzCgkJfSk7CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJdGhpcy5fb24oIGxhYmVsLmVsZW1lbnQsIHsKCQkJdm1vdXNlb3ZlcjogIl9oYW5kbGVMYWJlbFZNb3VzZU92ZXIiLAoJCQl2Y2xpY2s6ICJfaGFuZGxlTGFiZWxWQ2xpY2siCgkJfSk7CgoJCXRoaXMuX29uKCBpbnB1dCwgewoJCQl2bW91c2Vkb3duOiAiX2NhY2hlVmFscyIsCgkJCXZjbGljazogIl9oYW5kbGVJbnB1dFZDbGljayIsCgkJCWZvY3VzOiAiX2hhbmRsZUlucHV0Rm9jdXMiLAoJCQlibHVyOiAiX2hhbmRsZUlucHV0Qmx1ciIKCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9maW5kTGFiZWw6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRMYWJlbCwgbGFiZWwsIGlzUGFyZW50LAoJCQlpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbGFiZWxzTGlzdCA9IGlucHV0WyAwIF0ubGFiZWxzOwoKCQlpZiggbGFiZWxzTGlzdCAmJiBsYWJlbHNMaXN0Lmxlbmd0aCA+IDAgKSB7CgkJCWxhYmVsID0gJCggbGFiZWxzTGlzdFsgMCBdICk7CgkJCWlzUGFyZW50ID0gJC5jb250YWlucyggbGFiZWxbIDAgXSwgaW5wdXRbIDAgXSApOwoJCX0gZWxzZSB7CgkJCXBhcmVudExhYmVsID0gaW5wdXQuY2xvc2VzdCggImxhYmVsIiApOwoJCQlpc1BhcmVudCA9ICggcGFyZW50TGFiZWwubGVuZ3RoID4gMCApOwoKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCWxhYmVsID0gaXNQYXJlbnQgPyBwYXJlbnRMYWJlbCA6CgkJCQkkKCB0aGlzLmRvY3VtZW50WyAwIF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJsYWJlbCIgKSApCgkJCQkJLmZpbHRlciggIltmb3I9JyIgKyBlc2NhcGVJZCggaW5wdXRbIDAgXS5pZCApICsgIiddIiApCgkJCQkJLmZpcnN0KCk7CgkJfQoKCQlyZXR1cm4gewoJCQllbGVtZW50OiBsYWJlbCwKCQkJaXNQYXJlbnQ6IGlzUGFyZW50CgkJfTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwuYWRkQ2xhc3MoICJ1aS1idG4gdWktY29ybmVyLWFsbCIpOwoKCQlpZiAoIHRoaXMubGFiZWxJc1BhcmVudCApIHsKCQkJdGhpcy5pbnB1dC5hZGQoIHRoaXMubGFiZWwgKS53cmFwQWxsKCB0aGlzLl93cmFwcGVyKCkgKTsKCQl9IGVsc2UgewoJCQkvL3RoaXMuZWxlbWVudC5yZXBsYWNlV2l0aCggdGhpcy5pbnB1dC5hZGQoIHRoaXMubGFiZWwgKS53cmFwQWxsKCB0aGlzLl93cmFwcGVyKCkgKSApOwoJCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fd3JhcHBlcigpICk7CgkJCXRoaXMuZWxlbWVudC5wYXJlbnQoKS5wcmVwZW5kKCB0aGlzLmxhYmVsICk7CgkJfQoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgoJCXRoaXMuX3NldE9wdGlvbnMoewoJCQkidGhlbWUiOiB0aGlzLm9wdGlvbnMudGhlbWUsCgkJCSJpY29ucG9zIjogdGhpcy5vcHRpb25zLmljb25wb3MsCgkJCSJ3cmFwcGVyQ2xhc3MiOiB0aGlzLm9wdGlvbnMud3JhcHBlckNsYXNzLAoKCQkJLy8gRGVwcmVjYXRlZCBhcyBvZiAxLjUuMAoJCQkibWluaSI6IHRoaXMub3B0aW9ucy5taW5pCgkJfSk7CgoJfSwKCglfd3JhcHBlcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2IGNsYXNzPSd1aS0iICsgdGhpcy5pbnB1dHR5cGUgKwoJCQkoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArICInID48L2Rpdj4iICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX2hhbmRsZUlucHV0VkNsaWNrOiBmdW5jdGlvbigpIHsKCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgdGhpcy5lbGVtZW50LmlzKCAiOmNoZWNrZWQiICkgKTsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLm5vdCggdGhpcy5lbGVtZW50ICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCXRoaXMuX3VwZGF0ZUFsbCggdHJ1ZSApOwoJfSwKCglfaGFuZGxlTGFiZWxWTW91c2VPdmVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLmxhYmVsLnBhcmVudCgpLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCX0KCX0sCgoJX2hhbmRsZUxhYmVsVkNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50OwoKCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9jYWNoZVZhbHMoKTsKCgkJaW5wdXQucHJvcCggImNoZWNrZWQiLCB0aGlzLmlucHV0dHlwZSA9PT0gInJhZGlvIiAmJiB0cnVlIHx8ICFpbnB1dC5wcm9wKCAiY2hlY2tlZCIgKSApOwoKCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCS8vIFRPRE86IGl0IHdvdWxkIGJlIG5pY2UgdG8gbGV0IHRoZSBicm93c2VyJ3MgaGFuZGxlIHRoZSBjbGlja3MgYW5kIHBhc3MgdGhlbQoJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJaW5wdXQudHJpZ2dlckhhbmRsZXIoICJjbGljayIgKTsKCgkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJLy8gb2Ygb3RoZXIgcmFkaW9zIGVuc3VyZXMgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUgaXMgYXBwbGllZCBwcm9wZXJseQoJCXRoaXMuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJdGhpcy5fdXBkYXRlQWxsKCk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfY2FjaGVWYWxzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuYXR0cigiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy8gUmV0dXJucyB0aG9zZSByYWRpbyBidXR0b25zIHRoYXQgYXJlIHN1cHBvc2VkIHRvIGJlIGluIHRoZSBzYW1lIGdyb3VwIGFzCgkvLyB0aGlzIHJhZGlvIGJ1dHRvbi4gSW4gdGhlIGNhc2Ugb2YgYSBjaGVja2JveCBvciBhIHJhZGlvIGxhY2tpbmcgYSBuYW1lCgkvLyBhdHRyaWJ1dGUsIGl0IHJldHVybnMgdGhpcy5lbGVtZW50LgoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0b3IsIGZvcm1JZCwKCQkJcmFkaW8gPSB0aGlzLmVsZW1lbnRbIDAgXSwKCQkJbmFtZSA9IHJhZGlvLm5hbWUsCgkJCWZvcm0gPSByYWRpby5mb3JtLAoJCQlkb2MgPSB0aGlzLmVsZW1lbnQucGFyZW50cygpLmxhc3QoKS5nZXQoIDAgKSwKCgkJCS8vIEEgcmFkaW8gaXMgYWx3YXlzIGEgbWVtYmVyIG9mIGl0cyBvd24gZ3JvdXAKCQkJcmFkaW9zID0gdGhpcy5lbGVtZW50OwoKCQkvLyBPbmx5IHN0YXJ0IHJ1bm5pbmcgc2VsZWN0b3JzIGlmIHRoaXMgaXMgYW4gYXR0YWNoZWQgcmFkaW8gYnV0dG9uIHdpdGggYSBuYW1lCgkJaWYgKCBuYW1lICYmIHRoaXMuaW5wdXR0eXBlID09PSAicmFkaW8iICYmIGRvYyApIHsKCQkJc2VsZWN0b3IgPSAiaW5wdXRbdHlwZT0ncmFkaW8nXVtuYW1lPSciICsgZXNjYXBlSWQoIG5hbWUgKSArICInXSI7CgoJCQkvLyBJZiB3ZSdyZSBpbnNpZGUgYSBmb3JtCgkJCWlmICggZm9ybSApIHsKCQkJCWZvcm1JZCA9IGZvcm0uZ2V0QXR0cmlidXRlKCAiaWQiICk7CgoJCQkJLy8gSWYgdGhlIGZvcm0gaGFzIGFuIElELCBjb2xsZWN0IHJhZGlvcyBzY2F0dGVyZWQgdGhyb3VnaHQgdGhlIGRvY3VtZW50IHdoaWNoCgkJCQkvLyBuZXZlcnRoZWxlc3MgYXJlIHBhcnQgb2YgdGhlIGZvcm0gYnkgd2F5IG9mIHRoZSB2YWx1ZSBvZiB0aGVpciBmb3JtIGF0dHJpYnV0ZQoJCQkJaWYgKCBmb3JtSWQgKSB7CgkJCQkJcmFkaW9zID0gJCggc2VsZWN0b3IgKyAiW2Zvcm09JyIgKyBlc2NhcGVJZCggZm9ybUlkICkgKyAiJ10iLCBkb2MgKTsKCQkJCX0KCgkJCQkvLyBBbHNvIGFkZCB0byB0aG9zZSB0aGUgcmFkaW9zIGluIHRoZSBmb3JtIGl0c2VsZgoJCQkJcmFkaW9zID0gJCggZm9ybSApLmZpbmQoIHNlbGVjdG9yICkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCgkJCQkJLy8gU29tZSByYWRpb3MgaW5zaWRlIHRoZSBmb3JtIG1heSBiZWxvbmcgdG8gc29tZSBvdGhlciBmb3JtIGJ5IHZpcnR1ZSBvZgoJCQkJCS8vIGhhdmluZyBhIGZvcm0gYXR0cmlidXRlIGRlZmluZWQgb24gdGhlbSwgc28gd2UgbXVzdCBmaWx0ZXIgdGhlbSBvdXQgaGVyZQoJCQkJCXJldHVybiAoIHRoaXMuZm9ybSA9PT0gZm9ybSApOwoJCQkJfSkuYWRkKCByYWRpb3MgKTsKCgkJCS8vIElmIHdlJ3JlIG91dHNpZGUgYSBmb3JtCgkJCX0gZWxzZSB7CgoJCQkJLy8gQ29sbGVjdCBhbGwgdGhvc2UgcmFkaW9zIHdoaWNoIGFyZSBhbHNvIG91dHNpZGUgb2YgYSBmb3JtIGFuZCBtYXRjaCBvdXIgbmFtZQoJCQkJcmFkaW9zID0gJCggc2VsZWN0b3IsIGRvYyApLmZpbHRlciggZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuICF0aGlzLmZvcm07CgkJCQl9KTsKCQkJfQoJCX0KCQlyZXR1cm4gcmFkaW9zOwoJfSwKCglfdXBkYXRlQWxsOiBmdW5jdGlvbiggY2hhbmdlVHJpZ2dlcmVkICkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJaWYgKCAoIHRoaXMuY2hlY2tlZCB8fCBzZWxmLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApICYmICFjaGFuZ2VUcmlnZ2VyZWQgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCS8vIElzIHRoZSB3aWRnZXQgc3VwcG9zZWQgdG8gZGlzcGxheSBhbiBpY29uPwoJX2hhc0ljb246IGZ1bmN0aW9uKCkgewoJCXZhciBjb250cm9sZ3JvdXAsIGNvbnRyb2xncm91cFdpZGdldCwKCQkJY29udHJvbGdyb3VwQ29uc3RydWN0b3IgPSAkLm1vYmlsZS5jb250cm9sZ3JvdXA7CgoJCS8vIElmIHRoZSBjb250cm9sZ3JvdXAgd2lkZ2V0IGlzIGRlZmluZWQgLi4uCgkJaWYgKCBjb250cm9sZ3JvdXBDb25zdHJ1Y3RvciApIHsKCQkJY29udHJvbGdyb3VwID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoCgkJCQkiOm1vYmlsZS1jb250cm9sZ3JvdXAsIiArCgkJCQljb250cm9sZ3JvdXBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuaW5pdFNlbGVjdG9yICk7CgoJCQkvLyAuLi4gYW5kIHRoZSBjaGVja2JveCBpcyBpbiBhIGNvbnRyb2xncm91cCAuLi4KCQkJaWYgKCBjb250cm9sZ3JvdXAubGVuZ3RoID4gMCApIHsKCgkJCQkvLyAuLi4gbG9vayBmb3IgYSBjb250cm9sZ3JvdXAgd2lkZ2V0IGluc3RhbmNlLCBhbmQgLi4uCgkJCQljb250cm9sZ3JvdXBXaWRnZXQgPSAkLmRhdGEoIGNvbnRyb2xncm91cFsgMCBdLCAibW9iaWxlLWNvbnRyb2xncm91cCIgKTsKCgkJCQkvLyAuLi4gaWYgZm91bmQsIGRlY2lkZSBiYXNlZCBvbiB0aGUgb3B0aW9uIHZhbHVlLCAuLi4KCQkJCXJldHVybiAoICggY29udHJvbGdyb3VwV2lkZ2V0ID8gY29udHJvbGdyb3VwV2lkZ2V0Lm9wdGlvbnMudHlwZSA6CgoJCQkJCS8vIC4uLiBvdGhlcndpc2UgZGVjaWRlIGJhc2VkIG9uIHRoZSAidHlwZSIgZGF0YSBhdHRyaWJ1dGUuCgkJCQkJY29udHJvbGdyb3VwLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlIiApICkgIT09ICJob3Jpem9udGFsIiApOwoJCQl9CgkJfQoKCQkvLyBOb3JtYWxseSwgdGhlIHdpZGdldCBkaXNwbGF5cyBhbiBpY29uLgoJCXJldHVybiB0cnVlOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgaXNDaGVja2VkID0gdGhpcy5lbGVtZW50WyAwIF0uY2hlY2tlZCwKCQkJYWN0aXZlID0gJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWljb25wb3NDbGFzcyA9ICJ1aS1idG4taWNvbi0iICsgdGhpcy5vcHRpb25zLmljb25wb3MsCgkJCWFkZENsYXNzZXMgPSBbXSwKCQkJcmVtb3ZlQ2xhc3NlcyA9IFtdOwoKCQlpZiAoIHRoaXMuX2hhc0ljb24oKSApIHsKCQkJcmVtb3ZlQ2xhc3Nlcy5wdXNoKCBhY3RpdmUgKTsKCQkJYWRkQ2xhc3Nlcy5wdXNoKCBpY29ucG9zQ2xhc3MgKTsKCQl9IGVsc2UgewoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIGljb25wb3NDbGFzcyApOwoJCQkoIGlzQ2hlY2tlZCA/IGFkZENsYXNzZXMgOiByZW1vdmVDbGFzc2VzICkucHVzaCggYWN0aXZlICk7CgkJfQoKCQlpZiAoIGlzQ2hlY2tlZCApIHsKCQkJYWRkQ2xhc3Nlcy5wdXNoKCB0aGlzLmNoZWNrZWRDbGFzcyApOwoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQl9IGVsc2UgewoJCQlhZGRDbGFzc2VzLnB1c2goIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQkJcmVtb3ZlQ2xhc3Nlcy5wdXNoKCB0aGlzLmNoZWNrZWRDbGFzcyApOwoJCX0KCgkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiwgdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIgKSApOwoKCQl0aGlzLmxhYmVsCgkJCS5hZGRDbGFzcyggYWRkQ2xhc3Nlcy5qb2luKCAiICIgKSApCgkJCS5yZW1vdmVDbGFzcyggcmVtb3ZlQ2xhc3Nlcy5qb2luKCAiICIgKSApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmxhYmVsLnBhcmVudCgpOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGxhYmVsID0gdGhpcy5sYWJlbCwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCW91dGVyID0gdGhpcy53aWRnZXQoKSwKCQkJaGFzSWNvbiA9IHRoaXMuX2hhc0ljb24oKTsKCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuaW5wdXQucHJvcCggImRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgoJCS8vIERlcHJlY2F0ZWQgYXMgb2YgMS41LjAKCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCAhIW9wdGlvbnMubWluaSApOwoJCX0KCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJbGFiZWwKCQkJCS5yZW1vdmVDbGFzcyggInVpLWJ0bi0iICsgY3VycmVudE9wdGlvbnMudGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy53cmFwcGVyQ2xhc3MgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIKCQkJCS5yZW1vdmVDbGFzcyggY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzICkKCQkJCS5hZGRDbGFzcyggb3B0aW9ucy53cmFwcGVyQ2xhc3MgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmljb25wb3MgIT09IHVuZGVmaW5lZCAmJiBoYXNJY29uICkgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggInVpLWJ0bi1pY29uLSIgKyBjdXJyZW50T3B0aW9ucy5pY29ucG9zICkuYWRkQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgb3B0aW9ucy5pY29ucG9zICk7CgkJfSBlbHNlIGlmICggIWhhc0ljb24gKSB7CgkJCWxhYmVsLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArIGN1cnJlbnRPcHRpb25zLmljb25wb3MgKTsKCQl9CgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5idXR0b24iLCB7CgoJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0nYnV0dG9uJ10sIGlucHV0W3R5cGU9J3N1Ym1pdCddLCBpbnB1dFt0eXBlPSdyZXNldCddIiwKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJaWNvbjogbnVsbCwKCQlpY29ucG9zOiAibGVmdCIsCgkJaWNvbnNoYWRvdzogZmFsc2UsIC8qIFRPRE86IERlcHJlY2F0ZWQgaW4gMS40LCByZW1vdmUgaW4gMS41LiAqLwoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWlubGluZTogbnVsbCwKCQltaW5pOiBudWxsLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCWlmICggdGhpcy5lbGVtZW50LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCX0KCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQl3cmFwcGVyOiB0aGlzLmVsZW1lbnQucGFyZW50KCkKCQl9KTsKCgkJdGhpcy5fb24oIHsKCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy53aWRnZXQoKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9LAoKCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLndpZGdldCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fYnV0dG9uKCkgKTsKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWljb25DbGFzc2VzID0gdGhpcy5fZ2V0SWNvbkNsYXNzZXMoIHRoaXMub3B0aW9ucyApOwoKCQlyZXR1cm4gJCgiPGRpdiBjbGFzcz0ndWktYnRuIHVpLWlucHV0LWJ0biIgKwoJCQkoIG9wdGlvbnMud3JhcHBlckNsYXNzID8gIiAiICsgb3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsKCQkJKCBvcHRpb25zLnRoZW1lID8gIiB1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJKCBvcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKSArCgkJCSggb3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIiApICsKCQkJKCBvcHRpb25zLmlubGluZSA/ICIgdWktYnRuLWlubGluZSIgOiAiIiApICsKCQkJKCBvcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIgKSArCgkJCSggb3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArCgkJCSggaWNvbkNsYXNzZXMgPyAoICIgIiArIGljb25DbGFzc2VzICkgOiAiIiApICsKCQkJIicgPiIgKyB0aGlzLmVsZW1lbnQudmFsKCkgKyAiPC9kaXY+IiApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLndyYXBwZXI7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50Lmluc2VydEJlZm9yZSggdGhpcy53cmFwcGVyICk7CgkJCXRoaXMud3JhcHBlci5yZW1vdmUoKTsKCX0sCgoJX2dldEljb25DbGFzc2VzOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQlyZXR1cm4gKCBvcHRpb25zLmljb24gPyAoICJ1aS1pY29uLSIgKyBvcHRpb25zLmljb24gKwoJCQkoIG9wdGlvbnMuaWNvbnNoYWRvdyA/ICIgdWktc2hhZG93LWljb24iIDogIiIgKSArIC8qIFRPRE86IERlcHJlY2F0ZWQgaW4gMS40LCByZW1vdmUgaW4gMS41LiAqLwoJCQkiIHVpLWJ0bi1pY29uLSIgKyBvcHRpb25zLmljb25wb3MgKSA6ICIiICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgb3V0ZXIgPSB0aGlzLndpZGdldCgpOwoKCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIKCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5vcHRpb25zLnRoZW1lICkKCQkJCS5hZGRDbGFzcyggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgkJaWYgKCBvcHRpb25zLnNoYWRvdyAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLXNoYWRvdyIsIG9wdGlvbnMuc2hhZG93ICk7CgkJfQoJCWlmICggb3B0aW9ucy5pbmxpbmUgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1idG4taW5saW5lIiwgb3B0aW9ucy5pbmxpbmUgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0aW9ucy5taW5pICk7CgkJfQoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgb3B0aW9ucy5kaXNhYmxlZCApOwoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiwgb3B0aW9ucy5kaXNhYmxlZCApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmljb24gIT09IHVuZGVmaW5lZCB8fAoJCQkJb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgfHwgLyogVE9ETzogRGVwcmVjYXRlZCBpbiAxLjQsIHJlbW92ZSBpbiAxLjUuICovCgkJCQlvcHRpb25zLmljb25wb3MgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIKCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fZ2V0SWNvbkNsYXNzZXMoIHRoaXMub3B0aW9ucyApICkKCQkJCS5hZGRDbGFzcyggdGhpcy5fZ2V0SWNvbkNsYXNzZXMoCgkJCQkJJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMgKSApICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBvcmlnaW5hbEVsZW1lbnQsCgkJCWlzRGlzYWJsZWQgPSB0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5pY29uICYmIHRoaXMub3B0aW9ucy5pY29ucG9zID09PSAibm90ZXh0IiAmJiB0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiApICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiwgdGhpcy5lbGVtZW50LnZhbCgpICk7CgkJfQoJCWlmICggIWNyZWF0ZSApIHsKCQkJb3JpZ2luYWxFbGVtZW50ID0gdGhpcy5lbGVtZW50LmRldGFjaCgpOwoJCQkkKCB0aGlzLndyYXBwZXIgKS50ZXh0KCB0aGlzLmVsZW1lbnQudmFsKCkgKS5hcHBlbmQoIG9yaWdpbmFsRWxlbWVudCApOwoJCX0KCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCAhPT0gaXNEaXNhYmxlZCApIHsKCQkJdGhpcy5fc2V0T3B0aW9ucyh7IGRpc2FibGVkOiBpc0Rpc2FibGVkIH0pOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQgKSB7Cgl2YXIJbWV0YSA9ICQoICJtZXRhW25hbWU9dmlld3BvcnRdIiApLAoJCWluaXRpYWxDb250ZW50ID0gbWV0YS5hdHRyKCAiY29udGVudCIgKSwKCQlkaXNhYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xLCB1c2VyLXNjYWxhYmxlPW5vIiwKCQllbmFibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEwLCB1c2VyLXNjYWxhYmxlPXllcyIsCgkJZGlzYWJsZWRJbml0aWFsbHkgPSAvKHVzZXItc2NhbGFibGVbXHNdKj1bXHNdKm5vKXwobWF4aW11bS1zY2FsZVtcc10qPVtcc10qMSlbJCxcc10vLnRlc3QoIGluaXRpYWxDb250ZW50ICk7CgoJJC5tb2JpbGUuem9vbSA9ICQuZXh0ZW5kKCB7fSwgewoJCWVuYWJsZWQ6ICFkaXNhYmxlZEluaXRpYWxseSwKCQlsb2NrZWQ6IGZhbHNlLAoJCWRpc2FibGU6IGZ1bmN0aW9uKCBsb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAhJC5tb2JpbGUuem9vbS5sb2NrZWQgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZGlzYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSBmYWxzZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gbG9jayB8fCBmYWxzZTsKCQkJfQoJCX0sCgkJZW5hYmxlOiBmdW5jdGlvbiggdW5sb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAoICEkLm1vYmlsZS56b29tLmxvY2tlZCB8fCB1bmxvY2sgPT09IHRydWUgKSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBlbmFibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gZmFsc2U7CgkJCX0KCQl9LAoJCXJlc3RvcmU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBpbml0aWFsQ29udGVudCApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCX0pOwoKfSggalF1ZXJ5ICkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCB7Cglpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSd0ZXh0J10sIiArCgkJImlucHV0W3R5cGU9J3NlYXJjaCddLCIgKwoJCSI6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSwiICsKCQkiaW5wdXRbdHlwZT0nbnVtYmVyJ10sIiArCgkJIjpqcW1EYXRhKHR5cGU9J251bWJlcicpLCIgKwoJCSJpbnB1dFt0eXBlPSdwYXNzd29yZCddLCIgKwoJCSJpbnB1dFt0eXBlPSdlbWFpbCddLCIgKwoJCSJpbnB1dFt0eXBlPSd1cmwnXSwiICsKCQkiaW5wdXRbdHlwZT0ndGVsJ10sIiArCgkJInRleHRhcmVhLCIgKwoJCSJpbnB1dFt0eXBlPSd0aW1lJ10sIiArCgkJImlucHV0W3R5cGU9J2RhdGUnXSwiICsKCQkiaW5wdXRbdHlwZT0nbW9udGgnXSwiICsKCQkiaW5wdXRbdHlwZT0nd2VlayddLCIgKwoJCSJpbnB1dFt0eXBlPSdkYXRldGltZSddLCIgKwoJCSJpbnB1dFt0eXBlPSdkYXRldGltZS1sb2NhbCddLCIgKwoJCSJpbnB1dFt0eXBlPSdjb2xvciddLCIgKwoJCSJpbnB1dDpub3QoW3R5cGVdKSwiICsKCQkiaW5wdXRbdHlwZT0nZmlsZSddIiwKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQltaW5pOiBmYWxzZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCXdyYXBwZXJDbGFzczogIiIsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJaXNTZWFyY2ggPSB0aGlzLmVsZW1lbnQuaXMoICJbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApLAoJCQlpc1RleHRhcmVhID0gdGhpcy5lbGVtZW50WyAwIF0udGFnTmFtZSA9PT0gIlRFWFRBUkVBIiwKCQkJaXNSYW5nZSA9IHRoaXMuZWxlbWVudC5pcyggIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAidHlwZT0ncmFuZ2UnXSIgKSwKCQkJaW5wdXROZWVkc1dyYXAgPSAoICh0aGlzLmVsZW1lbnQuaXMoICJpbnB1dCIgKSB8fAoJCQkJdGhpcy5lbGVtZW50LmlzKCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJ0eXBlPSdzZWFyY2gnXSIgKSApICYmCgkJCQkJIWlzUmFuZ2UgKTsKCgkJaWYgKCB0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiApICkgewoJCQlvcHRpb25zLmRpc2FibGVkID0gdHJ1ZTsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWNsYXNzZXM6IHRoaXMuX2NsYXNzZXNGcm9tT3B0aW9ucygpLAoJCQlpc1NlYXJjaDogaXNTZWFyY2gsCgkJCWlzVGV4dGFyZWE6IGlzVGV4dGFyZWEsCgkJCWlzUmFuZ2U6IGlzUmFuZ2UsCgkJCWlucHV0TmVlZHNXcmFwOiBpbnB1dE5lZWRzV3JhcAoJCX0pOwoKCQl0aGlzLl9hdXRvQ29ycmVjdCgpOwoKCQlpZiAoICFvcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggewoJCQkiZm9jdXMiOiAiX2hhbmRsZUZvY3VzIiwKCQkJImJsdXIiOiAiX2hhbmRsZUJsdXIiCgkJfSk7CgoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldE9wdGlvbnMoewoJCQkiZGlzYWJsZWQiIDogdGhpcy5lbGVtZW50LmlzKCAiOmRpc2FibGVkIiApCgkJfSk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbWVudENsYXNzZXMgPSBbXTsKCgkJaWYgKCB0aGlzLmlzVGV4dGFyZWEgKSB7CgkJCWVsZW1lbnRDbGFzc2VzLnB1c2goICJ1aS1pbnB1dC10ZXh0IiApOwoJCX0KCgkJaWYgKCB0aGlzLmlzVGV4dGFyZWEgfHwgdGhpcy5pc1JhbmdlICkgewoJCQllbGVtZW50Q2xhc3Nlcy5wdXNoKCAidWktc2hhZG93LWluc2V0IiApOwoJCX0KCgkJLy8ic2VhcmNoIiBhbmQgInRleHQiIGlucHV0IHdpZGdldHMKCQlpZiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCXRoaXMuZWxlbWVudC53cmFwKCB0aGlzLl93cmFwKCkgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50Q2xhc3NlcyA9IGVsZW1lbnRDbGFzc2VzLmNvbmNhdCggdGhpcy5jbGFzc2VzICk7CgkJfQoKCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIGVsZW1lbnRDbGFzc2VzLmpvaW4oICIgIiApICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggdGhpcy5pbnB1dE5lZWRzV3JhcCApID8gdGhpcy5lbGVtZW50LnBhcmVudCgpIDogdGhpcy5lbGVtZW50OwoJfSwKCglfY2xhc3Nlc0Zyb21PcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJY2xhc3NlcyA9IFtdOwoKCQljbGFzc2VzLnB1c2goICJ1aS1ib2R5LSIgKyAoICggb3B0aW9ucy50aGVtZSA9PT0gbnVsbCApID8gImluaGVyaXQiIDogb3B0aW9ucy50aGVtZSApICk7CgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLWNvcm5lci1hbGwiICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICkgewoJCQljbGFzc2VzLnB1c2goICJ1aS1taW5pIiApOwoJCX0KCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJCX0KCQlpZiAoIG9wdGlvbnMud3JhcHBlckNsYXNzICkgewoJCQljbGFzc2VzLnB1c2goIG9wdGlvbnMud3JhcHBlckNsYXNzICk7CgkJfQoKCQlyZXR1cm4gY2xhc3NlczsKCX0sCgoJX3dyYXA6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdiBjbGFzcz0nIiArCgkJCSggdGhpcy5pc1NlYXJjaCA/ICJ1aS1pbnB1dC1zZWFyY2ggIiA6ICJ1aS1pbnB1dC10ZXh0ICIgKSArCgkJCXRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSArICIgIiArCgkJCSJ1aS1zaGFkb3ctaW5zZXQnPjwvZGl2PiIgKTsKCX0sCgoJX2F1dG9Db3JyZWN0OiBmdW5jdGlvbigpIHsKCQkvLyBYWFg6IFRlbXBvcmFyeSB3b3JrYXJvdW5kIGZvciBpc3N1ZSA3ODUgKEFwcGxlIGJ1ZyA4OTEwNTg5KS4KCQkvLyAgICAgIFR1cm4gb2ZmIGF1dG9jb3JyZWN0IGFuZCBhdXRvY29tcGxldGUgb24gbm9uLWlPUyA1IGRldmljZXMKCQkvLyAgICAgIHNpbmNlIHRoZSBwb3B1cCB0aGV5IHVzZSBjYW4ndCBiZSBkaXNtaXNzZWQgYnkgdGhlIHVzZXIuIE5vdGUKCQkvLyAgICAgIHRoYXQgd2UgdGVzdCBmb3IgdGhlIHByZXNlbmNlIG9mIHRoZSBmZWF0dXJlIGJ5IGxvb2tpbmcgZm9yCgkJLy8gICAgICB0aGUgYXV0b2NvcnJlY3QgcHJvcGVydHkgb24gdGhlIGlucHV0IGVsZW1lbnQuIFdlIGN1cnJlbnRseQoJCS8vICAgICAgaGF2ZSBubyB0ZXN0IGZvciBpT1MgNSBvciBuZXdlciBzbyB3ZSdyZSB0ZW1wb3JhcmlseSB1c2luZwoJCS8vICAgICAgdGhlIHRvdWNoT3ZlcmZsb3cgc3VwcG9ydCBmbGFnIGZvciBqUU0gMS4wLiBZZXMsIEkgZmVlbCBkaXJ0eS4KCQkvLyAgICAgIC0gamJsYXMKCQlpZiAoIHR5cGVvZiB0aGlzLmVsZW1lbnRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmCgkJCSEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCgkJCS8vIFNldCB0aGUgYXR0cmlidXRlIGluc3RlYWQgb2YgdGhlIHByb3BlcnR5IGp1c3QgaW4gY2FzZSB0aGVyZQoJCQkvLyBpcyBjb2RlIHRoYXQgYXR0ZW1wdHMgdG8gbWFrZSBtb2RpZmljYXRpb25zIHZpYSBIVE1MLgoJCQl0aGlzLmVsZW1lbnRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvcnJlY3QiLCAib2ZmIiApOwoJCQl0aGlzLmVsZW1lbnRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCQl9Cgl9LAoKCV9oYW5kbGVCbHVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLndpZGdldCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVGb2N1czogZnVuY3Rpb24oKSB7CgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIGlucHV0IHVwb24gdGFwLCB0aGlzCgkJLy8gcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCWlmICggdGhpcy5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCX0KCQl0aGlzLndpZGdldCgpLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiAoIG9wdGlvbnMgKSB7CgkJdmFyIG91dGVyID0gdGhpcy53aWRnZXQoKTsKCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJaWYgKCAhKCBvcHRpb25zLmRpc2FibGVkID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy5taW5pID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy5jb3JuZXJzID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy50aGVtZSA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdGlvbnMud3JhcHBlckNsYXNzID09PSB1bmRlZmluZWQgKSApIHsKCgkJCW91dGVyLnJlbW92ZUNsYXNzKCB0aGlzLmNsYXNzZXMuam9pbiggIiAiICkgKTsKCQkJdGhpcy5jbGFzc2VzID0gdGhpcy5fY2xhc3Nlc0Zyb21PcHRpb25zKCk7CgkJCW91dGVyLmFkZENsYXNzKCB0aGlzLmNsYXNzZXMuam9pbiggIiAiICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLmlucHV0TmVlZHNXcmFwICkgewoJCQl0aGlzLmVsZW1lbnQudW53cmFwKCk7CgkJfQoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWlucHV0LXRleHQgIiArIHRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5leHRlbmQoIHsKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3JhbmdlJ10sIDpqcW1EYXRhKHR5cGU9J3JhbmdlJyksIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpIiwKCgl3aWRnZXRFdmVudFByZWZpeDogInNsaWRlIiwKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJdHJhY2tUaGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCWhpZ2hsaWdodDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCS8vIFRPRE86IEVhY2ggb2YgdGhlc2Ugc2hvdWxkIGhhdmUgY29tbWVudHMgZXhwbGFpbiB3aGF0IHRoZXkncmUgZm9yCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBjb250cm9sWyAwIF0sICJ0aGVtZSIgKSwKCQkJdHJhY2tUaGVtZUNsYXNzID0gdHJhY2tUaGVtZSA/ICIgdWktYmFyLSIgKyB0cmFja1RoZW1lIDogIiB1aS1iYXItaW5oZXJpdCIsCgkJCWNvcm5lckNsYXNzID0gKCB0aGlzLm9wdGlvbnMuY29ybmVycyB8fCBjb250cm9sLmpxbURhdGEoICJjb3JuZXJzIiApICkgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIsCgkJCW1pbmlDbGFzcyA9ICggdGhpcy5vcHRpb25zLm1pbmkgfHwgY29udHJvbC5qcW1EYXRhKCAibWluaSIgKSApID8gIiB1aS1taW5pIiA6ICIiLAoJCQljVHlwZSA9IGNvbnRyb2xbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQlpc1RvZ2dsZVN3aXRjaCA9ICggY1R5cGUgPT09ICJzZWxlY3QiICksCgkJCWlzUmFuZ2VzbGlkZXIgPSBjb250cm9sLnBhcmVudCgpLmlzKCAiOmpxbURhdGEocm9sZT0ncmFuZ2VzbGlkZXInKSIgKSwKCQkJc2VsZWN0Q2xhc3MgPSAoIGlzVG9nZ2xlU3dpdGNoICkgPyAidWktc2xpZGVyLXN3aXRjaCIgOiAiIiwKCQkJY29udHJvbElEID0gY29udHJvbC5hdHRyKCAiaWQiICksCgkJCSRsYWJlbCA9ICQoICJbZm9yPSciICsgY29udHJvbElEICsgIiddIiApLAoJCQlsYWJlbElEID0gJGxhYmVsLmF0dHIoICJpZCIgKSB8fCBjb250cm9sSUQgKyAiLWxhYmVsIiwKCQkJbWluID0gIWlzVG9nZ2xlU3dpdGNoID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSAgIWlzVG9nZ2xlU3dpdGNoID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkubGVuZ3RoLTEsCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgkJCWRvbUhhbmRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApLAoJCQloYW5kbGUgPSAkKCBkb21IYW5kbGUgKSwKCQkJZG9tU2xpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQkJc2xpZGVyID0gJCggZG9tU2xpZGVyICksCgkJCXZhbHVlYmcgPSB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICFpc1RvZ2dsZVN3aXRjaCA/IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQliZy5jbGFzc05hbWUgPSAidWktc2xpZGVyLWJnICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0pKCkgOiBmYWxzZSwKCQkJb3B0aW9ucywKCQkJd3JhcHBlciwKCQkJaiwgbGVuZ3RoLAoJCQlpLCBvcHRpb25zQ291bnQsIG9yaWdUYWJJbmRleCwKCQkJc2lkZSwgYWN0aXZlQ2xhc3MsIHNsaWRlckltZzsKCgkJJGxhYmVsLmF0dHIoICJpZCIsIGxhYmVsSUQgKTsKCQl0aGlzLmlzVG9nZ2xlU3dpdGNoID0gaXNUb2dnbGVTd2l0Y2g7CgoJCWRvbUhhbmRsZS5zZXRBdHRyaWJ1dGUoICJocmVmIiwgIiMiICk7CgkJZG9tU2xpZGVyLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiYXBwbGljYXRpb24iICk7CgkJZG9tU2xpZGVyLmNsYXNzTmFtZSA9IFsgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXIgdWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCAiIDogInVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQgIiwgc2VsZWN0Q2xhc3MsIHRyYWNrVGhlbWVDbGFzcywgY29ybmVyQ2xhc3MsIG1pbmlDbGFzcyBdLmpvaW4oICIiICk7CgkJZG9tSGFuZGxlLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItaGFuZGxlIjsKCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIGRvbUhhbmRsZSApOwoKCQloYW5kbGUuYXR0cih7CgkJCSJyb2xlIjogInNsaWRlciIsCgkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkiYXJpYS12YWx1ZW1heCI6IG1heCwKCQkJImFyaWEtdmFsdWVub3ciOiB0aGlzLl92YWx1ZSgpLAoJCQkiYXJpYS12YWx1ZXRleHQiOiB0aGlzLl92YWx1ZSgpLAoJCQkidGl0bGUiOiB0aGlzLl92YWx1ZSgpLAoJCQkiYXJpYS1sYWJlbGxlZGJ5IjogbGFiZWxJRAoJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCWNvbnRyb2w6IGNvbnRyb2wsCgkJCXR5cGU6IGNUeXBlLAoJCQlzdGVwOiBzdGVwLAoJCQltYXg6IG1heCwKCQkJbWluOiBtaW4sCgkJCXZhbHVlYmc6IHZhbHVlYmcsCgkJCWlzUmFuZ2VzbGlkZXI6IGlzUmFuZ2VzbGlkZXIsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCS8vIFRPRE86IHJlc3RvcmUgb3JpZ2luYWwgdGFiaW5kZXggKGlmIGFueSkgaW4gYSBkZXN0cm95IG1ldGhvZAoJCQlvcmlnVGFiSW5kZXggPSBjb250cm9sLmF0dHIoICJ0YWJpbmRleCIgKTsKCQkJaWYgKCBvcmlnVGFiSW5kZXggKSB7CgkJCQloYW5kbGUuYXR0ciggInRhYmluZGV4Iiwgb3JpZ1RhYkluZGV4ICk7CgkJCX0KCQkJY29udHJvbC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmx1cigpOwoJCQkJaGFuZGxlLmZvY3VzKCk7CgkJCX0pOwoKCQkJd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCXdyYXBwZXIuY2xhc3NOYW1lID0gInVpLXNsaWRlci1pbm5lcm9mZnNldCI7CgoJCQlmb3IgKCBqID0gMCwgbGVuZ3RoID0gZG9tU2xpZGVyLmNoaWxkTm9kZXMubGVuZ3RoOyBqIDwgbGVuZ3RoOyBqKysgKSB7CgkJCQl3cmFwcGVyLmFwcGVuZENoaWxkKCBkb21TbGlkZXIuY2hpbGROb2Rlc1tqXSApOwoJCQl9CgoJCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIHdyYXBwZXIgKTsKCgkJCS8vIHNsaWRlci53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXItaW5uZXJvZmZzZXQnPjwvZGl2PiIgKTsKCgkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJb3B0aW9ucyA9IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCgkJCWZvciAoIGkgPSAwLCBvcHRpb25zQ291bnQgPSBvcHRpb25zLmxlbmd0aDsgaSA8IG9wdGlvbnNDb3VudDsgaSsrICkgewoJCQkJc2lkZSA9ICFpID8gImIiIDogImEiOwoJCQkJYWN0aXZlQ2xhc3MgPSAhaSA/ICIiIDogIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3M7CgkJCQlzbGlkZXJJbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKTsKCgkJCQlzbGlkZXJJbWcuY2xhc3NOYW1lID0gWyAidWktc2xpZGVyLWxhYmVsIHVpLXNsaWRlci1sYWJlbC0iLCBzaWRlLCBhY3RpdmVDbGFzcyBdLmpvaW4oICIiICk7CgkJCQlzbGlkZXJJbWcuc2V0QXR0cmlidXRlKCAicm9sZSIsICJpbWciICk7CgkJCQlzbGlkZXJJbWcuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRpb25zW2ldLmlubmVySFRNTCApICk7CgkJCQkkKCBzbGlkZXJJbWcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9CgoJCQlzZWxmLl9sYWJlbHMgPSAkKCAiLnVpLXNsaWRlci1sYWJlbCIsIHNsaWRlciApOwoKCQl9CgoJCS8vIG1vbml0b3IgdGhlIGlucHV0IGZvciB1cGRhdGVkIHZhbHVlcwoJCWNvbnRyb2wuYWRkQ2xhc3MoIGlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlci1zd2l0Y2giIDogInVpLXNsaWRlci1pbnB1dCIgKTsKCgkJdGhpcy5fb24oIGNvbnRyb2wsIHsKCQkJImNoYW5nZSI6ICJfY29udHJvbENoYW5nZSIsCgkJCSJrZXl1cCI6ICJfY29udHJvbEtleXVwIiwKCQkJImJsdXIiOiAiX2NvbnRyb2xCbHVyIiwKCQkJInZtb3VzZXVwIjogIl9jb250cm9sVk1vdXNlVXAiCgkJfSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsICQucHJveHkoIHRoaXMuX3NsaWRlclZNb3VzZURvd24sIHRoaXMgKSApCgkJCS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJLy8gV2UgaGF2ZSB0byBpbnN0YW50aWF0ZSBhIG5ldyBmdW5jdGlvbiBvYmplY3QgZm9yIHRoZSB1bmJpbmQgdG8gd29yayBwcm9wZXJseQoJCS8vIHNpbmNlIHRoZSBtZXRob2QgaXRzZWxmIGlzIGRlZmluZWQgaW4gdGhlIHByb3RvdHlwZSAoY2F1c2luZyBpdCB0byB1bmJpbmQgZXZlcnl0aGluZykKCQl0aGlzLl9vbiggZG9jdW1lbnQsIHsgInZtb3VzZW1vdmUiOiAiX3ByZXZlbnREb2N1bWVudERyYWciIH0pOwoJCXRoaXMuX29uKCBzbGlkZXIuYWRkKCBkb2N1bWVudCApLCB7ICJ2bW91c2V1cCI6ICJfc2xpZGVyVk1vdXNlVXAiIH0pOwoKCQlzbGlkZXIuaW5zZXJ0QWZ0ZXIoIGNvbnRyb2wgKTsKCgkJLy8gd3JhcCBpbiBhIGRpdiBmb3Igc3R5bGluZyBwdXJwb3NlcwoJCWlmICggIWlzVG9nZ2xlU3dpdGNoICYmICFpc1Jhbmdlc2xpZGVyICkgewoJCQl3cmFwcGVyID0gdGhpcy5vcHRpb25zLm1pbmkgPyAiPGRpdiBjbGFzcz0ndWktc2xpZGVyIHVpLW1pbmknPiIgOiAiPGRpdiBjbGFzcz0ndWktc2xpZGVyJz4iOwoKCQkJY29udHJvbC5hZGQoIHNsaWRlciApLndyYXBBbGwoIHdyYXBwZXIgKTsKCQl9CgoJCS8vIGJpbmQgdGhlIGhhbmRsZSBldmVudCBjYWxsYmFja3MgYW5kIHNldCB0aGUgY29udGV4dCB0byB0aGUgd2lkZ2V0IGluc3RhbmNlCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7CgkJCSJ2bW91c2Vkb3duIjogIl9oYW5kbGVWTW91c2VEb3duIiwKCQkJImtleWRvd24iOiAiX2hhbmRsZUtleWRvd24iLAoJCQkia2V5dXAiOiAiX2hhbmRsZUtleXVwIgoJCX0pOwoKCQl0aGlzLmhhbmRsZS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUaGVtZSggb3B0aW9ucy50aGVtZSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLnRyYWNrVGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0VHJhY2tUaGVtZSggb3B0aW9ucy50cmFja1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRDb3JuZXJzKCBvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldE1pbmkoIG9wdGlvbnMubWluaSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmhpZ2hsaWdodCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRIaWdobGlnaHQoIG9wdGlvbnMuaGlnaGxpZ2h0ICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0RGlzYWJsZWQoIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2NvbnRyb2xDaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBpZiB0aGUgdXNlciBkcmFnZ2VkIHRoZSBoYW5kbGUsIHRoZSAiY2hhbmdlIiBldmVudCB3YXMgdHJpZ2dlcmVkIGZyb20gaW5zaWRlIHJlZnJlc2goKTsgZG9uJ3QgY2FsbCByZWZyZXNoKCkgYWdhaW4KCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJjb250cm9sY2hhbmdlIiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCAhdGhpcy5tb3VzZU1vdmVkICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUgKTsKCQl9Cgl9LAoKCV9jb250cm9sS2V5dXA6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7IC8vIG5lY2Vzc2FyeT8KCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUsIHRydWUgKTsKCX0sCgoJX2NvbnRyb2xCbHVyOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJfSwKCgkvLyBpdCBhcHBlYXJzIHRoZSBjbGlja2luZyB0aGUgdXAgYW5kIGRvd24gYnV0dG9ucyBpbiBjaHJvbWUgb24KCS8vIHJhbmdlL251bWJlciBpbnB1dHMgZG9lc24ndCB0cmlnZ2VyIGEgY2hhbmdlIHVudGlsIHRoZSBmaWVsZCBpcwoJLy8gYmx1cnJlZC4gSGVyZSB3ZSBjaGVjayB0aGlmIHRoZSB2YWx1ZSBoYXMgY2hhbmdlZCBhbmQgcmVmcmVzaAoJX2NvbnRyb2xWTW91c2VVcDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQl0aGlzLl9jaGVja2VkUmVmcmVzaCgpOwoJfSwKCgkvLyBOT1RFIGZvcmNlIGZvY3VzIG9uIGhhbmRsZQoJX2hhbmRsZVZNb3VzZURvd246IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJdGhpcy5oYW5kbGUuZm9jdXMoKTsKCX0sCgoJX2hhbmRsZUtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaW5kZXggPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJbiBhbGwgY2FzZXMgcHJldmVudCB0aGUgZGVmYXVsdCBhbmQgbWFyayB0aGUgaGFuZGxlIGFzIGFjdGl2ZQoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJaWYgKCAhdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJCQl0aGlzLl9rZXlTbGlkaW5nID0gdHJ1ZTsKCQkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsgLyogVE9ETzogV2UgZG9uJ3QgdXNlIHRoaXMgY2xhc3MgZm9yIHN0eWxpbmcuIERvIHdlIG5lZWQgdG8gYWRkIGl0PyAqLwoJCQkJfQoKCQkJCWJyZWFrOwoJCX0KCgkJLy8gbW92ZSB0aGUgc2xpZGVyIGFjY29yZGluZyB0byB0aGUga2V5cHJlc3MKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJCXRoaXMucmVmcmVzaCggdGhpcy5taW4gKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1heCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggKyB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQl0aGlzLnJlZnJlc2goIGluZGV4IC0gdGhpcy5zdGVwICk7CgkJCQlicmVhazsKCQl9Cgl9LCAvLyByZW1vdmUgYWN0aXZlIG1hcmsKCglfaGFuZGxlS2V5dXA6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJaWYgKCB0aGlzLl9rZXlTbGlkaW5nICkgewoJCQl0aGlzLl9rZXlTbGlkaW5nID0gZmFsc2U7CgkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOyAvKiBTZWUgY29tbWVudCBhYm92ZS4gKi8KCQl9Cgl9LAoKCV9zbGlkZXJWTW91c2VEb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgISggZXZlbnQud2hpY2ggPT09IDEgfHwgZXZlbnQud2hpY2ggPT09IDAgfHwgZXZlbnQud2hpY2ggPT09IHVuZGVmaW5lZCApICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZXN0YXJ0IiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJdGhpcy5kcmFnZ2luZyA9IHRydWU7CgkJdGhpcy51c2VyTW9kaWZpZWQgPSBmYWxzZTsKCQl0aGlzLm1vdXNlTW92ZWQgPSBmYWxzZTsKCgkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0ID0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJfQoKCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgkJdGhpcy5fdHJpZ2dlciggInN0YXJ0IiApOwoJCXJldHVybiBmYWxzZTsKCX0sCgoJX3NsaWRlclZNb3VzZVVwOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuZHJhZ2dpbmcgKSB7CgkJCXRoaXMuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJCWlmICggdGhpcy5tb3VzZU1vdmVkICkgewoJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCWlmICggdGhpcy51c2VyTW9kaWZpZWQgKSB7CgkJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ICk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzIGlzIGp1c3QgYSBjbGljaywgY2hhbmdlIHRoZSB2YWx1ZQoJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQl9CgkJCX0KCgkJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoJCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJX3ByZXZlbnREb2N1bWVudERyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJkcmFnIiwgZXZlbnQgKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlpZiAoIHRoaXMuZHJhZ2dpbmcgJiYgIXRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCgkJCQkvLyB0aGlzLm1vdXNlTW92ZWQgbXVzdCBiZSB1cGRhdGVkIGJlZm9yZSByZWZyZXNoKCkgYmVjYXVzZSBpdCB3aWxsIGJlIHVzZWQgaW4gdGhlIGNvbnRyb2wgImNoYW5nZSIgZXZlbnQKCQkJCXRoaXMubW91c2VNb3ZlZCA9IHRydWU7CgoJCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIGluIHN5bmMgd2l0aCB0aGUgbW91c2UKCQkJCQl0aGlzLmhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQl9CgoJCQkJdGhpcy5yZWZyZXNoKCBldmVudCApOwoKCQkJCS8vIG9ubHkgYWZ0ZXIgcmVmcmVzaCgpIHlvdSBjYW4gY2FsY3VsYXRlIHRoaXMudXNlck1vZGlmaWVkCgkJCQl0aGlzLnVzZXJNb2RpZmllZCA9IHRoaXMuYmVmb3JlU3RhcnQgIT09IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCglfY2hlY2tlZFJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy52YWx1ZSAhPT0gdGhpcy5fdmFsdWUoKSApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpICk7CgkJfQoJfSwKCglfdmFsdWU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4IDogcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LnZhbCgpICkgOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCBmYWxzZSwgdHJ1ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggdmFsLCBpc2Zyb21Db250cm9sLCBwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJLy8gTk9URTogd2UgZG9uJ3QgcmV0dXJuIGhlcmUgYmVjYXVzZSB3ZSB3YW50IHRvIHN1cHBvcnQgcHJvZ3JhbW1hdGljCgkJLy8gICAgICAgYWx0ZXJhdGlvbiBvZiB0aGUgaW5wdXQgdmFsdWUsIHdoaWNoIHNob3VsZCBzdGlsbCB1cGRhdGUgdGhlIHNsaWRlcgoKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXBhcmVudFRoZW1lID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLmVsZW1lbnRbIDAgXSwgInRoZW1lIiApLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdGhlbWVDbGFzcyA9ICB0aGVtZSA/ICIgdWktYnRuLSIgKyB0aGVtZSA6ICIiLAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCXRyYWNrVGhlbWVDbGFzcyA9IHRyYWNrVGhlbWUgPyAiIHVpLWJhci0iICsgdHJhY2tUaGVtZSA6ICIgdWktYmFyLWluaGVyaXQiLAoJCQljb3JuZXJDbGFzcyA9IHRoaXMub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiLAoJCQltaW5pQ2xhc3MgPSB0aGlzLm9wdGlvbnMubWluaSA/ICIgdWktbWluaSIgOiAiIiwKCQkJbGVmdCwgd2lkdGgsIGRhdGEsIHRvbCwKCQkJcHhTdGVwLCBwZXJjZW50LAoJCQljb250cm9sLCBpc0lucHV0LCBvcHRpb25FbGVtZW50cywgbWluLCBtYXgsIHN0ZXAsCgkJCW5ld3ZhbCwgdmFsTW9kU3RlcCwgYWxpZ25WYWx1ZSwgcGVyY2VudFBlclN0ZXAsCgkJCWhhbmRsZVBlcmNlbnQsIGFQZXJjZW50LCBiUGVyY2VudCwKCQkJdmFsdWVDaGFuZ2VkOwoKCQlzZWxmLnNsaWRlclswXS5jbGFzc05hbWUgPSBbIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyIHVpLXNsaWRlci1zd2l0Y2ggdWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCIgOiAidWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCIsIHRyYWNrVGhlbWVDbGFzcywgY29ybmVyQ2xhc3MsIG1pbmlDbGFzcyBdLmpvaW4oICIiICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBzZXQgdGhlIHN0b3JlZCB2YWx1ZSBmb3IgY29tcGFyaXNvbiBsYXRlcgoJCXRoaXMudmFsdWUgPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmhpZ2hsaWdodCAmJiAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiB0aGlzLnNsaWRlci5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5sZW5ndGggPT09IDAgKSB7CgkJCXRoaXMudmFsdWViZyA9IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQliZy5jbGFzc05hbWUgPSAidWktc2xpZGVyLWJnICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2VsZi5zbGlkZXIgKTsKCQkJfSkoKTsKCQl9CgkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1idG4iICsgdGhlbWVDbGFzcyArICIgdWktc2hhZG93IiApOwoKCQljb250cm9sID0gdGhpcy5lbGVtZW50OwoJCWlzSW5wdXQgPSAhdGhpcy5pc1RvZ2dsZVN3aXRjaDsKCQlvcHRpb25FbGVtZW50cyA9IGlzSW5wdXQgPyBbXSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCQltaW4gPSAgaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMDsKCQltYXggPSBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBvcHRpb25FbGVtZW50cy5sZW5ndGggLSAxOwoJCXN0ZXAgPSAoIGlzSW5wdXQgJiYgcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApID4gMCApID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApIDogMTsKCgkJaWYgKCB0eXBlb2YgdmFsID09PSAib2JqZWN0IiApIHsKCQkJZGF0YSA9IHZhbDsKCQkJLy8gYSBzbGlnaHQgdG9sZXJhbmNlIGhlbHBlZCBnZXQgdG8gdGhlIGVuZHMgb2YgdGhlIHNsaWRlcgoJCQl0b2wgPSA4OwoKCQkJbGVmdCA9IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQ7CgkJCXdpZHRoID0gdGhpcy5zbGlkZXIud2lkdGgoKTsKCQkJcHhTdGVwID0gd2lkdGgvKChtYXgtbWluKS9zdGVwKTsKCQkJaWYgKCAhdGhpcy5kcmFnZ2luZyB8fAoJCQkJCWRhdGEucGFnZVggPCBsZWZ0IC0gdG9sIHx8CgkJCQkJZGF0YS5wYWdlWCA+IGxlZnQgKyB3aWR0aCArIHRvbCApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIHB4U3RlcCA+IDEgKSB7CgkJCQlwZXJjZW50ID0gKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwOwoJCQl9IGVsc2UgewoJCQkJcGVyY2VudCA9IE1hdGgucm91bmQoICggKCBkYXRhLnBhZ2VYIC0gbGVmdCApIC8gd2lkdGggKSAqIDEwMCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9IGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLnZhbCgpIHx8IDAgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfQoJCQlwZXJjZW50ID0gKCBwYXJzZUZsb2F0KCB2YWwgKSAtIG1pbiApIC8gKCBtYXggLSBtaW4gKSAqIDEwMDsKCQl9CgoJCWlmICggaXNOYU4oIHBlcmNlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJbmV3dmFsID0gKCBwZXJjZW50IC8gMTAwICkgKiAoIG1heCAtIG1pbiApICsgbWluOwoKCQkvL2Zyb20galF1ZXJ5IFVJIHNsaWRlciwgdGhlIGZvbGxvd2luZyBzb3VyY2Ugd2lsbCByb3VuZCB0byB0aGUgbmVhcmVzdCBzdGVwCgkJdmFsTW9kU3RlcCA9ICggbmV3dmFsIC0gbWluICkgJSBzdGVwOwoJCWFsaWduVmFsdWUgPSBuZXd2YWwgLSB2YWxNb2RTdGVwOwoKCQlpZiAoIE1hdGguYWJzKCB2YWxNb2RTdGVwICkgKiAyID49IHN0ZXAgKSB7CgkJCWFsaWduVmFsdWUgKz0gKCB2YWxNb2RTdGVwID4gMCApID8gc3RlcCA6ICggLXN0ZXAgKTsKCQl9CgoJCXBlcmNlbnRQZXJTdGVwID0gMTAwLygobWF4LW1pbikvc3RlcCk7CgkJLy8gU2luY2UgSmF2YVNjcmlwdCBoYXMgcHJvYmxlbXMgd2l0aCBsYXJnZSBmbG9hdHMsIHJvdW5kCgkJLy8gdGhlIGZpbmFsIHZhbHVlIHRvIDUgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50IChzZWUgalF1ZXJ5VUk6ICM0MTI0KQoJCW5ld3ZhbCA9IHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCg1KSApOwoKCQlpZiAoIHR5cGVvZiBweFN0ZXAgPT09ICJ1bmRlZmluZWQiICkgewoJCQlweFN0ZXAgPSB3aWR0aCAvICggKG1heC1taW4pIC8gc3RlcCApOwoJCX0KCQlpZiAoIHB4U3RlcCA+IDEgJiYgaXNJbnB1dCApIHsKCQkJcGVyY2VudCA9ICggbmV3dmFsIC0gbWluICkgKiBwZXJjZW50UGVyU3RlcCAqICggMSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBwZXJjZW50IDwgMCApIHsKCQkJcGVyY2VudCA9IDA7CgkJfQoKCQlpZiAoIHBlcmNlbnQgPiAxMDAgKSB7CgkJCXBlcmNlbnQgPSAxMDA7CgkJfQoKCQlpZiAoIG5ld3ZhbCA8IG1pbiApIHsKCQkJbmV3dmFsID0gbWluOwoJCX0KCgkJaWYgKCBuZXd2YWwgPiBtYXggKSB7CgkJCW5ld3ZhbCA9IG1heDsKCQl9CgoJCXRoaXMuaGFuZGxlLmNzcyggImxlZnQiLCBwZXJjZW50ICsgIiUiICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWVub3ciLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJhcmlhLXZhbHVldGV4dCIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJ0aXRsZSIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQlpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLmNzcyggIndpZHRoIiwgcGVyY2VudCArICIlIiApOwoJCX0KCgkJLy8gZHJhZyB0aGUgbGFiZWwgd2lkdGhzCgkJaWYgKCB0aGlzLl9sYWJlbHMgKSB7CgkJCWhhbmRsZVBlcmNlbnQgPSB0aGlzLmhhbmRsZS53aWR0aCgpIC8gdGhpcy5zbGlkZXIud2lkdGgoKSAqIDEwMDsKCQkJYVBlcmNlbnQgPSBwZXJjZW50ICYmIGhhbmRsZVBlcmNlbnQgKyAoIDEwMCAtIGhhbmRsZVBlcmNlbnQgKSAqIHBlcmNlbnQgLyAxMDA7CgkJCWJQZXJjZW50ID0gcGVyY2VudCA9PT0gMTAwID8gMCA6IE1hdGgubWluKCBoYW5kbGVQZXJjZW50ICsgMTAwIC0gYVBlcmNlbnQsIDEwMCApOwoKCQkJdGhpcy5fbGFiZWxzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgYWIgPSAkKCB0aGlzICkuaGFzQ2xhc3MoICJ1aS1zbGlkZXItbGFiZWwtYSIgKTsKCQkJCSQoIHRoaXMgKS53aWR0aCggKCBhYiA/IGFQZXJjZW50IDogYlBlcmNlbnQgICkgKyAiJSIgKTsKCQkJfSk7CgkJfQoKCQlpZiAoICFwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJCXZhbHVlQ2hhbmdlZCA9IGZhbHNlOwoKCQkJLy8gdXBkYXRlIGNvbnRyb2wicyB2YWx1ZQoJCQlpZiAoIGlzSW5wdXQgKSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sLnZhbCgpICE9PSBuZXd2YWw7CgkJCQljb250cm9sLnZhbCggbmV3dmFsICk7CgkJCX0gZWxzZSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCAhPT0gbmV3dmFsOwoJCQkJY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggPSBuZXd2YWw7CgkJCX0KCQkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY2hhbmdlIiwgdmFsICkgPT09IGZhbHNlKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggIWlzZnJvbUNvbnRyb2wgJiYgdmFsdWVDaGFuZ2VkICkgewoJCQkJY29udHJvbC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCglfc2V0SGlnaGxpZ2h0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFsdWUgPSAhIXZhbHVlOwoJCWlmICggdmFsdWUgKSB7CgkJCXRoaXMub3B0aW9ucy5oaWdobGlnaHQgPSAhIXZhbHVlOwoJCQl0aGlzLnJlZnJlc2goKTsKCQl9IGVsc2UgaWYgKCB0aGlzLnZhbHVlYmcgKSB7CgkJCXRoaXMudmFsdWViZy5yZW1vdmUoKTsKCQkJdGhpcy52YWx1ZWJnID0gZmFsc2U7CgkJfQoJfSwKCglfc2V0VGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmhhbmRsZQoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1idG4tIiArIHRoaXMub3B0aW9ucy50aGVtZSApCgkJCS5hZGRDbGFzcyggInVpLWJ0bi0iICsgdmFsdWUgKTsKCgkJdmFyIGN1cnJlbnRUaGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSA/IHRoaXMub3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiwKCQkJbmV3VGhlbWUgPSB2YWx1ZSA/IHZhbHVlIDogImluaGVyaXQiOwoKCQl0aGlzLmNvbnRyb2wKCQkJLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgY3VycmVudFRoZW1lICkKCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgbmV3VGhlbWUgKTsKCX0sCgoJX3NldFRyYWNrVGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgY3VycmVudFRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSA/IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIDogImluaGVyaXQiLAoJCQluZXdUcmFja1RoZW1lID0gdmFsdWUgPyB2YWx1ZSA6ICJpbmhlcml0IjsKCgkJdGhpcy5zbGlkZXIKCQkJLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgY3VycmVudFRyYWNrVGhlbWUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBuZXdUcmFja1RoZW1lICk7Cgl9LAoKCV9zZXRNaW5pOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFsdWUgPSAhIXZhbHVlOwoJCWlmICggIXRoaXMuaXNUb2dnbGVTd2l0Y2ggJiYgIXRoaXMuaXNSYW5nZXNsaWRlciApIHsKCQkJdGhpcy5zbGlkZXIucGFyZW50KCkudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIHZhbHVlICk7CgkJfQoJCXRoaXMuc2xpZGVyLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIHZhbHVlICk7Cgl9LAoKCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5zbGlkZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCgkJaWYgKCAhdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJdGhpcy5jb250cm9sLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIHZhbHVlICk7CgkJfQoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5zbGlkZXIKCQkJLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCB2YWx1ZSApCgkJCS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgoJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiwgdmFsdWUgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcG9wdXA7CgpmdW5jdGlvbiBnZXRQb3B1cCgpIHsKCWlmICggIXBvcHVwICkgewoJCXBvcHVwID0gJCggIjxkaXY+PC9kaXY+IiwgewoJCQkiY2xhc3MiOiAidWktc2xpZGVyLXBvcHVwIHVpLXNoYWRvdyB1aS1jb3JuZXItYWxsIgoJCX0pOwoJfQoJcmV0dXJuIHBvcHVwLmNsb25lKCk7Cn0KCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLnNsaWRlciwgewoJb3B0aW9uczogewoJCXBvcHVwRW5hYmxlZDogZmFsc2UsCgkJc2hvd1ZhbHVlOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY3VycmVudFZhbHVlOiBudWxsLAoJCQlfcG9wdXA6IG51bGwsCgkJCV9wb3B1cFZpc2libGU6IGZhbHNlCgkJfSk7CgoJCXRoaXMuX3NldE9wdGlvbiggInBvcHVwRW5hYmxlZCIsIHRoaXMub3B0aW9ucy5wb3B1cEVuYWJsZWQgKTsKCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7ICJ2bW91c2Vkb3duIiA6ICJfc2hvd1BvcHVwIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMuc2xpZGVyLmFkZCggdGhpcy5kb2N1bWVudCApLCB7ICJ2bW91c2V1cCIgOiAiX2hpZGVQb3B1cCIgfSApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJLy8gcG9zaXRpb24gdGhlIHBvcHVwIGNlbnRlcmVkIDVweCBhYm92ZSB0aGUgaGFuZGxlCglfcG9zaXRpb25Qb3B1cDogZnVuY3Rpb24oKSB7CgkJdmFyIGRzdE9mZnNldCA9IHRoaXMuaGFuZGxlLm9mZnNldCgpOwoKCQl0aGlzLl9wb3B1cC5vZmZzZXQoIHsKCQkJbGVmdDogZHN0T2Zmc2V0LmxlZnQgKyAoIHRoaXMuaGFuZGxlLndpZHRoKCkgLSB0aGlzLl9wb3B1cC53aWR0aCgpICkgLyAyLAoJCQl0b3A6IGRzdE9mZnNldC50b3AgLSB0aGlzLl9wb3B1cC5vdXRlckhlaWdodCgpIC0gNQoJCX0pOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gInNob3dWYWx1ZSIgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoIHZhbHVlICYmICF0aGlzLm9wdGlvbnMubWluaSA/IHRoaXMuX3ZhbHVlKCkgOiAiIiApOwoJCX0gZWxzZSBpZiAoIGtleSA9PT0gInBvcHVwRW5hYmxlZCIgKSB7CgkJCWlmICggdmFsdWUgJiYgIXRoaXMuX3BvcHVwICkgewoJCQkJdGhpcy5fcG9wdXAgPSBnZXRQb3B1cCgpCgkJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgKCB0aGlzLm9wdGlvbnMudGhlbWUgfHwgImEiICkgKQoJCQkJCS5oaWRlKCkKCQkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLmVsZW1lbnQgKTsKCQkJfQoJCX0KCX0sCgoJLy8gc2hvdyB2YWx1ZSBvbiB0aGUgaGFuZGxlIGFuZCBpbiBwb3B1cAoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zLCBuZXdWYWx1ZTsKCgkJaWYgKCBvLnBvcHVwRW5hYmxlZCApIHsKCQkJLy8gcmVtb3ZlIHRoZSB0aXRsZSBhdHRyaWJ1dGUgZnJvbSB0aGUgaGFuZGxlICh3aGljaCBpcwoJCQkvLyByZXNwb25zaWJsZSBmb3IgdGhlIGFubm95aW5nIHRvb2x0aXApOyBOQiB3ZSBoYXZlCgkJCS8vIHRvIGRvIGl0IGhlcmUgYXMgdGhlIGpxbSBzbGlkZXIgc2V0cyBpdCBldmVyeSB0aW1lCgkJCS8vIHRoZSBzbGlkZXIncyB2YWx1ZSBjaGFuZ2VzIDooCgkJCXRoaXMuaGFuZGxlLnJlbW92ZUF0dHIoICJ0aXRsZSIgKTsKCQl9CgoJCW5ld1ZhbHVlID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIG5ld1ZhbHVlID09PSB0aGlzLl9jdXJyZW50VmFsdWUgKSB7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fY3VycmVudFZhbHVlID0gbmV3VmFsdWU7CgoJCWlmICggby5wb3B1cEVuYWJsZWQgJiYgdGhpcy5fcG9wdXAgKSB7CgkJCXRoaXMuX3Bvc2l0aW9uUG9wdXAoKTsKCQkJdGhpcy5fcG9wdXAuaHRtbCggbmV3VmFsdWUgKTsKCQl9CgoJCWlmICggby5zaG93VmFsdWUgJiYgIXRoaXMub3B0aW9ucy5taW5pICkgewoJCQl0aGlzLmhhbmRsZS5odG1sKCBuZXdWYWx1ZSApOwoJCX0KCX0sCgoJX3Nob3dQb3B1cDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMucG9wdXBFbmFibGVkICYmICF0aGlzLl9wb3B1cFZpc2libGUgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoICIiICk7CgkJCXRoaXMuX3BvcHVwLnNob3coKTsKCQkJdGhpcy5fcG9zaXRpb25Qb3B1cCgpOwoJCQl0aGlzLl9wb3B1cFZpc2libGUgPSB0cnVlOwoJCX0KCX0sCgoJX2hpZGVQb3B1cDogZnVuY3Rpb24oKSB7CgkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggby5wb3B1cEVuYWJsZWQgJiYgdGhpcy5fcG9wdXBWaXNpYmxlICkgewoJCQlpZiAoIG8uc2hvd1ZhbHVlICYmICFvLm1pbmkgKSB7CgkJCQl0aGlzLmhhbmRsZS5odG1sKCB0aGlzLl92YWx1ZSgpICk7CgkJCX0KCQkJdGhpcy5fcG9wdXAuaGlkZSgpOwoJCQl0aGlzLl9wb3B1cFZpc2libGUgPSBmYWxzZTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5mbGlwc3dpdGNoIiwgJC5leHRlbmQoewoKCW9wdGlvbnM6IHsKCQlvblRleHQ6ICJPbiIsCgkJb2ZmVGV4dDogIk9mZiIsCgkJdGhlbWU6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlKCk7CgkJCX0gZWxzZSB7CgkJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJCWZsaXBzd2l0Y2g6IHRoaXMuZWxlbWVudC5wYXJlbnQoKSwKCQkJCQlvbjogdGhpcy5lbGVtZW50LmZpbmQoICIudWktZmxpcHN3aXRjaC1vbiIgKS5lcSggMCApLAoJCQkJCW9mZjogdGhpcy5lbGVtZW50LmZpbmQoICIudWktZmxpcHN3aXRjaC1vZmYiICkuZXEoMCksCgkJCQkJdHlwZTogdGhpcy5lbGVtZW50LmdldCggMCApLnRhZ05hbWUKCQkJCX0pOwoJCQl9CgoJCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJCS8vIFRyYW5zZmVyIHRhYmluZGV4IHRvICJvbiIgZWxlbWVudCBhbmQgbWFrZSBpbnB1dCB1bmZvY3VzYWJsZQoJCQl0aGlzLl9vcmlnaW5hbFRhYkluZGV4ID0gdGhpcy5lbGVtZW50LmF0dHIoICJ0YWJpbmRleCIgKTsKCQkJaWYgKCB0aGlzLl9vcmlnaW5hbFRhYkluZGV4ICE9IG51bGwgKSB7CgkJCQl0aGlzLm9uLmF0dHIoICJ0YWJpbmRleCIsIHRoaXMuX29yaWdpbmFsVGFiSW5kZXggKTsKCQkJfQoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoJCQl0aGlzLl9vbih7CgkJCQkiZm9jdXMiIDogIl9oYW5kbGVJbnB1dEZvY3VzIgoJCQl9KTsKCgkJCWlmICggdGhpcy5lbGVtZW50LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJdGhpcy5fc2V0T3B0aW9ucyh7CgkJCQkJImRpc2FibGVkIjogdHJ1ZQoJCQkJfSk7CgkJCX0KCgkJCXRoaXMuX29uKCB0aGlzLmZsaXBzd2l0Y2gsIHsKCQkJCSJjbGljayI6ICJfdG9nZ2xlIiwKCQkJCSJzd2lwZWxlZnQiOiAiX2xlZnQiLAoJCQkJInN3aXBlcmlnaHQiOiAiX3JpZ2h0IgoJCQl9KTsKCgkJCXRoaXMuX29uKCB0aGlzLm9uLCB7CgkJCQkia2V5ZG93biI6ICJfa2V5ZG93biIKCQkJfSk7CgoJCQl0aGlzLl9vbiggewoJCQkJImNoYW5nZSI6ICJyZWZyZXNoIgoJCQl9KTsKCX0sCgoJX2hhbmRsZUlucHV0Rm9jdXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMub24uZm9jdXMoKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5mbGlwc3dpdGNoOwoJfSwKCglfbGVmdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5mbGlwc3dpdGNoLnJlbW92ZUNsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICk7CgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQl0aGlzLmVsZW1lbnQuZ2V0KCAwICkuc2VsZWN0ZWRJbmRleCA9IDA7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQl9CgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjaGFuZ2UiICk7Cgl9LAoKCV9yaWdodDogZnVuY3Rpb24oKSB7CgkJdGhpcy5mbGlwc3dpdGNoLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICk7CgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQl0aGlzLmVsZW1lbnQuZ2V0KCAwICkuc2VsZWN0ZWRJbmRleCA9IDE7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgdHJ1ZSApOwoJCX0KCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImNoYW5nZSIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBmbGlwc3dpdGNoID0gJCggIjxkaXY+IiApLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQllbGVtZW50ID0gdGhpcy5lbGVtZW50LAoJCQl0aGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoKCQkJLy8gVGhlICJvbiIgYnV0dG9uIGlzIGFuIGFuY2hvciBzbyBpdCdzIGZvY3VzYWJsZQoJCQlvbiA9ICQoICI8YT48L2E+IiwgewoJCQkJImhyZWYiOiAiIyIKCQkJfSksCgkJCW9mZiA9ICQoICI8c3Bhbj48L3NwYW4+IiApLAoJCQl0eXBlID0gZWxlbWVudC5nZXQoIDAgKS50YWdOYW1lLAoJCQlvblRleHQgPSAoIHR5cGUgPT09ICJJTlBVVCIgKSA/CgkJCQlvcHRpb25zLm9uVGV4dCA6IGVsZW1lbnQuZmluZCggIm9wdGlvbiIgKS5lcSggMSApLnRleHQoKSwKCQkJb2ZmVGV4dCA9ICggdHlwZSA9PT0gIklOUFVUIiApID8KCQkJCW9wdGlvbnMub2ZmVGV4dCA6IGVsZW1lbnQuZmluZCggIm9wdGlvbiIgKS5lcSggMCApLnRleHQoKTsKCgkJCW9uCgkJCQkuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLW9uIHVpLWJ0biB1aS1zaGFkb3cgdWktYnRuLWluaGVyaXQiICkKCQkJCS50ZXh0KCBvblRleHQgKTsKCQkJb2ZmCgkJCQkuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLW9mZiIgKQoJCQkJLnRleHQoIG9mZlRleHQgKTsKCgkJCWZsaXBzd2l0Y2gKCQkJCS5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2ggdWktc2hhZG93LWluc2V0ICIgKwoJCQkJCSJ1aS1iYXItIiArIHRoZW1lICsgIiAiICsKCQkJCQkoIG9wdGlvbnMud3JhcHBlckNsYXNzID8gb3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsgIiAiICsKCQkJCQkoICggZWxlbWVudC5pcyggIjpjaGVja2VkIiApIHx8CgkJCQkJCWVsZW1lbnQKCQkJCQkJCS5maW5kKCAib3B0aW9uIiApCgkJCQkJCQkuZXEoIDEgKQoJCQkJCQkJLmlzKCAiOnNlbGVjdGVkIiApICkgPyAidWktZmxpcHN3aXRjaC1hY3RpdmUiIDogIiIgKSArCgkJCQkJKCBlbGVtZW50LmlzKCI6ZGlzYWJsZWQiKSA/ICIgdWktc3RhdGUtZGlzYWJsZWQiOiAiIikgKwoJCQkJCSggb3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIjogIiIgKSArCgkJCQkJKCBvcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiOiAiIiApICkKCQkJCS5hcHBlbmQoIG9uLCBvZmYgKTsKCgkJCWVsZW1lbnQKCQkJCS5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtaW5wdXQiICkKCQkJCS5hZnRlciggZmxpcHN3aXRjaCApCgkJCQkuYXBwZW5kVG8oIGZsaXBzd2l0Y2ggKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJZmxpcHN3aXRjaDogZmxpcHN3aXRjaCwKCQkJb246IG9uLAoJCQlvZmY6IG9mZiwKCQkJdHlwZTogdHlwZQoJCX0pOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgZGlyZWN0aW9uLAoJCQlleGlzdGluZ0RpcmVjdGlvbiA9IHRoaXMuZmxpcHN3aXRjaC5oYXNDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApID8gIl9yaWdodCIgOiAiX2xlZnQiOwoKCQlpZiAoIHRoaXMudHlwZSA9PT0gIlNFTEVDVCIgKSB7CgkJCWRpcmVjdGlvbiA9ICggdGhpcy5lbGVtZW50LmdldCggMCApLnNlbGVjdGVkSW5kZXggPiAwICkgPyAiX3JpZ2h0IjogIl9sZWZ0IjsKCQl9IGVsc2UgewoJCQlkaXJlY3Rpb24gPSB0aGlzLmVsZW1lbnQucHJvcCggImNoZWNrZWQiICkgPyAiX3JpZ2h0IjogIl9sZWZ0IjsKCQl9CgoJCWlmICggZGlyZWN0aW9uICE9PSBleGlzdGluZ0RpcmVjdGlvbiApIHsKCQkJdGhpc1sgZGlyZWN0aW9uIF0oKTsKCQl9Cgl9LAoKCV90b2dnbGU6IGZ1bmN0aW9uKCkgewoJCXZhciBkaXJlY3Rpb24gPSB0aGlzLmZsaXBzd2l0Y2guaGFzQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgKSA/ICJfbGVmdCIgOiAiX3JpZ2h0IjsKCgkJdGhpc1sgZGlyZWN0aW9uIF0oKTsKCX0sCgoJX2tleWRvd246IGZ1bmN0aW9uKCBlICkgewoJCWlmICggZS53aGljaCA9PT0gJC5tb2JpbGUua2V5Q29kZS5MRUZUICkgewoJCQl0aGlzLl9sZWZ0KCk7CgkJfSBlbHNlIGlmICggZS53aGljaCA9PT0gJC5tb2JpbGUua2V5Q29kZS5SSUdIVCApIHsKCQkJdGhpcy5fcmlnaHQoKTsKCQl9IGVsc2UgaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFICkgewoJCQl0aGlzLl90b2dnbGUoKTsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl2YXIgY3VycmVudFRoZW1lID0gb3B0aW9ucy50aGVtZSA/IG9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQluZXdUaGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogImluaGVyaXQiOwoKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktYmFyLSIgKyBjdXJyZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMub25UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub24udGV4dCggb3B0aW9ucy5vblRleHQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm9mZlRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vZmYudGV4dCggb3B0aW9ucy5vZmZUZXh0ICk7CgkJfQoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0aW9ucy5taW5pICk7CgkJfQoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLl9vcmlnaW5hbFRhYkluZGV4ICE9IG51bGwgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAidGFiaW5kZXgiLCB0aGlzLl9vcmlnaW5hbFRhYkluZGV4ICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCQl9CgkJdGhpcy5vbi5yZW1vdmUoKTsKCQl0aGlzLm9mZi5yZW1vdmUoKTsKCQl0aGlzLmVsZW1lbnQudW53cmFwKCk7CgkJdGhpcy5mbGlwc3dpdGNoLnJlbW92ZSgpOwoJCXRoaXMucmVtb3ZlQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWlucHV0IiApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnJhbmdlc2xpZGVyIiwgJC5leHRlbmQoIHsKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJdHJhY2tUaGVtZTogbnVsbCwKCQkJY29ybmVyczogdHJ1ZSwKCQkJbWluaTogZmFsc2UsCgkJCWhpZ2hsaWdodDogdHJ1ZQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQllbENsYXNzID0gdGhpcy5vcHRpb25zLm1pbmkgPyAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgOiAidWktcmFuZ2VzbGlkZXIiLAoJCQlfaW5wdXRGaXJzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkuZmlyc3QoKSwKCQkJX2lucHV0TGFzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkubGFzdCgpLAoJCQlfbGFiZWwgPSAkZWwuZmluZCggImxhYmVsIiApLmZpcnN0KCksCgkJCV9zbGlkZXJXaWRnZXRGaXJzdCA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KCAwICksICJtb2JpbGUtc2xpZGVyIiApIHx8CgkJCQkkLmRhdGEoIF9pbnB1dEZpcnN0LnNsaWRlcigpLmdldCggMCApLCAibW9iaWxlLXNsaWRlciIgKSwKCQkJX3NsaWRlcldpZGdldExhc3QgPSAkLmRhdGEoIF9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKSB8fAoJCQkJJC5kYXRhKCBfaW5wdXRMYXN0LnNsaWRlcigpLmdldCggMCApLCAibW9iaWxlLXNsaWRlciIgKSwKCQkJX3NsaWRlckZpcnN0ID0gX3NsaWRlcldpZGdldEZpcnN0LnNsaWRlciwKCQkJX3NsaWRlckxhc3QgPSBfc2xpZGVyV2lkZ2V0TGFzdC5zbGlkZXIsCgkJCWZpcnN0SGFuZGxlID0gX3NsaWRlcldpZGdldEZpcnN0LmhhbmRsZSwKCQkJX3NsaWRlcnMgPSAkKCAiPGRpdiBjbGFzcz0ndWktcmFuZ2VzbGlkZXItc2xpZGVycycgLz4iICkuYXBwZW5kVG8oICRlbCApOwoKCQkJX2lucHV0Rmlyc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKTsKCQkJX2lucHV0TGFzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWxhc3QiICk7CgkJCSRlbC5hZGRDbGFzcyggZWxDbGFzcyApOwoKCQkJX3NsaWRlckZpcnN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlfc2xpZGVyTGFzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJX2xhYmVsLmluc2VydEJlZm9yZSggJGVsICk7CgkJCWZpcnN0SGFuZGxlLnByZXBlbmRUbyggX3NsaWRlckxhc3QgKTsKCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfaW5wdXRGaXJzdDogX2lucHV0Rmlyc3QsCgkJCQlfaW5wdXRMYXN0OiBfaW5wdXRMYXN0LAoJCQkJX3NsaWRlckZpcnN0OiBfc2xpZGVyRmlyc3QsCgkJCQlfc2xpZGVyTGFzdDogX3NsaWRlckxhc3QsCgkJCQlfbGFiZWw6IF9sYWJlbCwKCQkJCV90YXJnZXRWYWw6IG51bGwsCgkJCQlfc2xpZGVyVGFyZ2V0OiBmYWxzZSwKCQkJCV9zbGlkZXJzOiBfc2xpZGVycywKCQkJCV9wcm94eTogZmFsc2UKCQkJfSk7CgoJCQl0aGlzLnJlZnJlc2goKTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQudWktc2xpZGVyLWlucHV0IiApLCB7CgkJCQkic2xpZGViZWZvcmVzdGFydCI6ICJfc2xpZGViZWZvcmVzdGFydCIsCgkJCQkic2xpZGVzdG9wIjogIl9zbGlkZXN0b3AiLAoJCQkJInNsaWRlZHJhZyI6ICJfc2xpZGVkcmFnIiwKCQkJCSJzbGlkZWJlZm9yZWNoYW5nZSI6ICJfY2hhbmdlIiwKCQkJCSJibHVyIjogIl9jaGFuZ2UiLAoJCQkJImtleXVwIjogIl9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbih7CgkJCQkibW91c2Vkb3duIjoiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJCSJyZXNldCI6Il9oYW5kbGVSZXNldCIKCQkJfSk7CgkJCXRoaXMuX29uKCBmaXJzdEhhbmRsZSwgewoJCQkJInZtb3VzZWRvd24iOiAiX2RyYWdGaXJzdEhhbmRsZSIKCQkJfSk7CgkJfSwKCQlfaGFuZGxlUmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCS8vd2UgbXVzdCB3YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIGJlZm9yZSB1cGRhdGVpbmcgb3RoZXIgd2lzZSBzbGlkZXJzIHdpbGwgbm90IGhhdmUgdXBkYXRlZCB5ZXQKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQlzZWxmLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJfSwwKTsKCQl9LAoKCQlfZHJhZ0ZpcnN0SGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vaWYgdGhlIGZpcnN0IGhhbmRsZSBpcyBkcmFnZ2VkIHNlbmQgdGhlIGV2ZW50IHRvIHRoZSBmaXJzdCBzbGlkZXIKCQkJJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5yZWZyZXNoKCBldmVudCApOwoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5fdHJpZ2dlciggInN0YXJ0IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCgkJX3NsaWRlZHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5pcyggdGhpcy5faW5wdXRGaXJzdCApLAoJCQkJb3RoZXJTbGlkZXIgPSAoIGZpcnN0ICkgPyB0aGlzLl9pbnB1dExhc3QgOiB0aGlzLl9pbnB1dEZpcnN0OwoKCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gZmFsc2U7CgkJCS8vaWYgdGhlIGRyYWcgd2FzIGluaXRpYXRlZCBvbiBhbiBleHRyZW1lIGFuZCB0aGUgb3RoZXIgaGFuZGxlIGlzIGZvY3VzZWQgc2VuZCB0aGUgZXZlbnRzIHRvCgkJCS8vdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCWlmICggKCB0aGlzLl9wcm94eSA9PT0gImZpcnN0IiAmJiBmaXJzdCApIHx8ICggdGhpcy5fcHJveHkgPT09ICJsYXN0IiAmJiAhZmlyc3QgKSApIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5kcmFnZ2luZyA9IHRydWU7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV9zbGlkZXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKTsKCgkJCXRoaXMuX3Byb3h5ID0gZmFsc2U7CgkJCS8vdGhpcyBzdG9wcyBkcmFnZ2luZyBvZiB0aGUgaGFuZGxlIGFuZCBicmluZ3MgdGhlIGFjdGl2ZSB0cmFjayB0byB0aGUgZnJvbnQKCQkJLy90aGlzIG1ha2VzIGNsaWNrcyBvbiB0aGUgdHJhY2sgZ28gdGhlIHRoZSBsYXN0IGhhbmRsZSB1c2VkCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkudHJpZ2dlciggInZtb3VzZXVwIiApOwoJCQl0aGlzLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAxIDogIiIgKTsKCQl9LAoKCQlfc2xpZGViZWZvcmVzdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgdHJhY2sgaXMgdGhlIHRhcmdldCByZW1lbWJlciB0aGlzIGFuZCB0aGUgb3JpZ2luYWwgdmFsdWUKCQkJaWYgKCAkKCBldmVudC5vcmlnaW5hbEV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktc2xpZGVyLXRyYWNrIiApICkgewoJCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gdHJ1ZTsKCQkJCXRoaXMuX3RhcmdldFZhbCA9ICQoIGV2ZW50LnRhcmdldCApLnZhbCgpOwoJCQl9CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldFRoZW1lKCBvcHRpb25zLnRoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy50cmFja1RoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRUcmFja1RoZW1lKCBvcHRpb25zLnRyYWNrVGhlbWUgKTsKCQkJfQoKCQkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldE1pbmkoIG9wdGlvbnMubWluaSApOwoJCQl9CgoJCQlpZiAoIG9wdGlvbnMuaGlnaGxpZ2h0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRIaWdobGlnaHQoIG9wdGlvbnMuaGlnaGxpZ2h0ICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0RGlzYWJsZWQoIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQkJfQoKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkJaWYgKCB0aGlzLl9pbnB1dEZpcnN0LmlzKCAiOmRpc2FibGVkIiApIHx8IHRoaXMuX2lucHV0TGFzdC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJCX0KCgkJCSRlbC5maW5kKCAiaW5wdXQiICkuc2xpZGVyKHsKCQkJCXRoZW1lOiBvLnRoZW1lLAoJCQkJdHJhY2tUaGVtZTogby50cmFja1RoZW1lLAoJCQkJZGlzYWJsZWQ6IG8uZGlzYWJsZWQsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQltaW5pOiBvLm1pbmksCgkJCQloaWdobGlnaHQ6IG8uaGlnaGxpZ2h0CgkJCX0pLnNsaWRlciggInJlZnJlc2giICk7CgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCX0sCgoJCV9jaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCBldmVudC50eXBlID09PSAia2V5dXAiICkgewoJCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW1pbiA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCksIDEwICksCgkJCQltYXggPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dExhc3QudmFsKCksIDEwICksCgkJCQlmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICksCgkJCQl0aGlzU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dEZpcnN0IDogdGhpcy5faW5wdXRMYXN0LAoJCQkJb3RoZXJTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoJCQlpZiAoICggdGhpcy5faW5wdXRGaXJzdC52YWwoKSA+IHRoaXMuX2lucHV0TGFzdC52YWwoKSAmJiBldmVudC50eXBlID09PSAibW91c2Vkb3duIiAmJiAhJChldmVudC50YXJnZXQpLmhhc0NsYXNzKCJ1aS1zbGlkZXItaGFuZGxlIikpICkgewoJCQkJdGhpc1NsaWRlci5ibHVyKCk7CgkJCX0gZWxzZSBpZiAoIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggbWluID4gbWF4ICYmICF0aGlzLl9zbGlkZXJUYXJnZXQgKSB7CgkJCQkvL3RoaXMgcHJldmVudHMgbWluIGZyb20gYmVpbmcgZ3JlYXRlciB0aGVuIG1heAoJCQkJdGhpc1NsaWRlci52YWwoIGZpcnN0ID8gbWF4OiBtaW4gKS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQkJdGhpcy5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJfSBlbHNlIGlmICggbWluID4gbWF4ICkgewoJCQkJLy90aGlzIG1ha2VzIGl0IHNvIGNsaWNrcyBvbiB0aGUgdGFyZ2V0IG9uIGVpdGhlciBleHRyZW1lIGdvIHRvIHRoZSBjbG9zZXN0IGhhbmRsZQoJCQkJdGhpc1NsaWRlci52YWwoIHRoaXMuX3RhcmdldFZhbCApLnNsaWRlciggInJlZnJlc2giICk7CgoJCQkJLy9Zb3UgbXVzdCB3YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIHNvIGZpcnN0IHNsaWRlciBpcyB1cGRhdGVkIGJlZm9yZSB1cGRhdGluZyBzZWNvbmQKCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCW90aGVyU2xpZGVyLnZhbCggZmlyc3QgPyBtaW46IG1heCApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5mb2N1cygpOwoJCQkJCXNlbGYuX3NsaWRlckZpcnN0LmNzcyggInotaW5kZXgiLCBmaXJzdCA/ICIiIDogMSApOwoJCQkJCXNlbGYuX3RyaWdnZXIoICJub3JtYWxpemUiICk7CgkJCQl9LCAwICk7CgkJCQl0aGlzLl9wcm94eSA9ICggZmlyc3QgKSA/ICJmaXJzdCIgOiAibGFzdCI7CgkJCX0KCQkJLy9maXhlcyBpc3N1ZSB3aGVyZSB3aGVuIGJvdGggX3NsaWRlcnMgYXJlIGF0IG1pbiB0aGV5IGNhbm5vdCBiZSBhZGp1c3RlZAoJCQlpZiAoIG1pbiA9PT0gbWF4ICkgewoJCQkJJC5kYXRhKCB0aGlzU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAxICk7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAwICk7CgkJCX0gZWxzZSB7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQkJJC5kYXRhKCB0aGlzU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQl9CgoJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCgkJCWlmICggbWluID49IG1heCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV91cGRhdGVIaWdobGlnaHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWluID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5nZXQoMCkuc3R5bGUubGVmdCwgMTAgKSwKCQkJCW1heCA9IHBhcnNlSW50KCAkLmRhdGEoIHRoaXMuX2lucHV0TGFzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5nZXQoMCkuc3R5bGUubGVmdCwgMTAgKSwKCQkJCXdpZHRoID0gKG1heCAtIG1pbik7CgoJCQl0aGlzLmVsZW1lbnQuZmluZCggIi51aS1zbGlkZXItYmciICkuY3NzKHsKCQkJCSJtYXJnaW4tbGVmdCI6IG1pbiArICIlIiwKCQkJCSJ3aWR0aCI6IHdpZHRoICsgIiUiCgkJCX0pOwoJCX0sCgoJCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJ0aGVtZSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAidGhlbWUiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRUcmFja1RoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgInRyYWNrVGhlbWUiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgInRyYWNrVGhlbWUiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRNaW5pOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgIm1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgIm1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgISF2YWx1ZSApOwoJCX0sCgoJCV9zZXRIaWdobGlnaHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAiaGlnaGxpZ2h0IiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJoaWdobGlnaHQiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXREaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnByb3AoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5wcm9wKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fbGFiZWwucHJlcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgKTsKCQkJdGhpcy5faW5wdXRGaXJzdC5hZnRlciggdGhpcy5fc2xpZGVyRmlyc3QgKTsKCQkJdGhpcy5faW5wdXRMYXN0LmFmdGVyKCB0aGlzLl9zbGlkZXJMYXN0ICk7CgkJCXRoaXMuX3NsaWRlcnMucmVtb3ZlKCk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCB1aS1yYW5nZXNsaWRlci1sYXN0IiApLnNsaWRlciggImRlc3Ryb3kiICk7CgkJfQoKCX0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUudGV4dGlucHV0LCB7CgkJb3B0aW9uczogewoJCQljbGVhckJ0bjogZmFsc2UsCgkJCWNsZWFyQnRuVGV4dDogIkNsZWFyIHRleHQiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgoJCQlpZiAoIHRoaXMuaXNTZWFyY2ggKSB7CgkJCQl0aGlzLm9wdGlvbnMuY2xlYXJCdG4gPSB0cnVlOwoJCQl9CgoJCQlpZiAoICEhdGhpcy5vcHRpb25zLmNsZWFyQnRuICYmIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCQl0aGlzLl9hZGRDbGVhckJ0bigpOwoJCQl9CgkJfSwKCgkJY2xlYXJCdXR0b246IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJCggIjxhIGhyZWY9JyMnICIgKwoJCQkJImNsYXNzPSd1aS1pbnB1dC1jbGVhciB1aS1idG4gdWktaWNvbi1kZWxldGUgdWktYnRuLWljb24tbm90ZXh0IHVpLWNvcm5lci1hbGwnPiIgKwoJCQkJIjwvYT4iICkKCQkJCQkuYXR0ciggInRpdGxlIiwgdGhpcy5vcHRpb25zLmNsZWFyQnRuVGV4dCApCgkJCQkJLnRleHQoIHRoaXMub3B0aW9ucy5jbGVhckJ0blRleHQgKTsKCQl9LAoKCQlfY2xlYXJCdG5DbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLmVsZW1lbnQudmFsKCAiIiApCgkJCQkJLmZvY3VzKCkKCQkJCQkudHJpZ2dlciggImNoYW5nZSIgKTsKCgkJCXRoaXMuX2NsZWFyQnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0sCgoJCV9hZGRDbGVhckJ0bjogZnVuY3Rpb24oKSB7CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlQ2xlYXIoKTsKCQkJfQoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9jbGVhckJ0bjogdGhpcy53aWRnZXQoKS5maW5kKCJhLnVpLWlucHV0LWNsZWFyIikKCQkJfSk7CgoJCQl0aGlzLl9iaW5kQ2xlYXJFdmVudHMoKTsKCgkJCXRoaXMuX3RvZ2dsZUNsZWFyKCk7CgoJCX0sCgoJCV9lbmhhbmNlQ2xlYXI6IGZ1bmN0aW9uKCkgewoKCQkJdGhpcy5jbGVhckJ1dHRvbigpLmFwcGVuZFRvKCB0aGlzLndpZGdldCgpICk7CgkJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICJ1aS1pbnB1dC1oYXMtY2xlYXIiICk7CgoJCX0sCgoJCV9iaW5kQ2xlYXJFdmVudHM6IGZ1bmN0aW9uKCkgewoKCQkJdGhpcy5fb24oIHRoaXMuX2NsZWFyQnRuLCB7CgkJCQkiY2xpY2siOiAiX2NsZWFyQnRuQ2xpY2siCgkJCX0pOwoKCQkJdGhpcy5fb24oewoJCQkJImtleXVwIjogIl90b2dnbGVDbGVhciIsCgkJCQkiY2hhbmdlIjogIl90b2dnbGVDbGVhciIsCgkJCQkiaW5wdXQiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJmb2N1cyI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImJsdXIiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJjdXQiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJwYXN0ZSI6ICJfdG9nZ2xlQ2xlYXIiCgoJCQl9KTsKCgkJfSwKCgkJX3VuYmluZENsZWFyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fb2ZmKCB0aGlzLl9jbGVhckJ0biwgImNsaWNrIik7CgkJCXRoaXMuX29mZiggdGhpcy5lbGVtZW50LCAia2V5dXAgY2hhbmdlIGlucHV0IGZvY3VzIGJsdXIgY3V0IHBhc3RlIiApOwoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJCWlmICggb3B0aW9ucy5jbGVhckJ0biAhPT0gdW5kZWZpbmVkICYmCgkJCQkhdGhpcy5lbGVtZW50LmlzKCAidGV4dGFyZWEsIDpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICkgKSB7CgkJCQlpZiAoIG9wdGlvbnMuY2xlYXJCdG4gKSB7CgkJCQkJdGhpcy5fYWRkQ2xlYXJCdG4oKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5fZGVzdHJveUNsZWFyKCk7CgkJCQl9CgkJCX0KCgkJCWlmICggb3B0aW9ucy5jbGVhckJ0blRleHQgIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9jbGVhckJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fY2xlYXJCdG4udGV4dCggb3B0aW9ucy5jbGVhckJ0blRleHQgKQoJCQkJCS5hdHRyKCJ0aXRsZSIsIG9wdGlvbnMuY2xlYXJCdG5UZXh0KTsKCQkJfQoJCX0sCgoJCV90b2dnbGVDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2RlbGF5KCAiX3RvZ2dsZUNsZWFyQ2xhc3MiLCAwICk7CgkJfSwKCgkJX3RvZ2dsZUNsZWFyQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9jbGVhckJ0bi50b2dnbGVDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIsICF0aGlzLmVsZW1lbnQudmFsKCkgKTsKCQl9LAoKCQlfZGVzdHJveUNsZWFyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggInVpLWlucHV0LWhhcy1jbGVhciIgKTsKCQkJdGhpcy5fdW5iaW5kQ2xlYXIoKTsKCQkJdGhpcy5fY2xlYXJCdG4ucmVtb3ZlKCk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLl9kZXN0cm95Q2xlYXIoKTsKCQl9CgoJfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS50ZXh0aW5wdXQsIHsKCQlvcHRpb25zOiB7CgkJCWF1dG9ncm93OnRydWUsCgkJCWtleXVwVGltZW91dEJ1ZmZlcjogMTAwCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgoJCQlpZiAoIHRoaXMub3B0aW9ucy5hdXRvZ3JvdyAmJiB0aGlzLmlzVGV4dGFyZWEgKSB7CgkJCQl0aGlzLl9hdXRvZ3JvdygpOwoJCQl9CgkJfSwKCgkJX2F1dG9ncm93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktdGV4dGlucHV0LWF1dG9ncm93IiApOwoKCQkJdGhpcy5fb24oewoJCQkJImtleXVwIjogIl90aW1lb3V0IiwKCQkJCSJjaGFuZ2UiOiAiX3RpbWVvdXQiLAoJCQkJImlucHV0IjogIl90aW1lb3V0IiwKCQkJCSJwYXN0ZSI6ICJfdGltZW91dCIKCQkJfSk7CgoJCQkvLyBBdHRhY2ggdG8gdGhlIHZhcmlvdXMgeW91LWhhdmUtYmVjb21lLXZpc2libGUgbm90aWZpY2F0aW9ucyB0aGF0IHRoZQoJCQkvLyB2YXJpb3VzIGZyYW1ld29yayBlbGVtZW50cyBlbWl0LgoJCQkvLyBUT0RPOiBSZW1vdmUgYWxsIGJ1dCB0aGUgdXBkYXRlbGF5b3V0IGhhbmRsZXIgb25jZSAjNjQyNiBpcyBmaXhlZC4KCQkJdGhpcy5fb24oIHRydWUsIHRoaXMuZG9jdW1lbnQsIHsKCgkJCQkvLyBUT0RPOiBNb3ZlIHRvIG5vbi1kZXByZWNhdGVkIGV2ZW50CgkJCQkicGFnZXNob3ciOiAiX2hhbmRsZVNob3ciLAoJCQkJInBvcHVwYmVmb3JlcG9zaXRpb24iOiAiX2hhbmRsZVNob3ciLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlU2hvdyIsCgkJCQkicGFuZWxvcGVuIjogIl9oYW5kbGVTaG93IgoJCQl9KTsKCQl9LAoKCQkvLyBTeW5jaHJvbm91c2x5IGZpeCB0aGUgd2lkZ2V0IGhlaWdodCBpZiB0aGlzIHdpZGdldCdzIHBhcmVudHMgYXJlIHN1Y2gKCQkvLyB0aGF0IHRoZXkgc2hvdy9oaWRlIGNvbnRlbnQgYXQgcnVudGltZS4gV2Ugc3RpbGwgbmVlZCB0byBjaGVjayB3aGV0aGVyCgkJLy8gdGhlIHdpZGdldCBpcyBhY3R1YWxseSB2aXNpYmxlIGluIGNhc2UgaXQgaXMgY29udGFpbmVkIGluc2lkZSBtdWx0aXBsZQoJCS8vIHN1Y2ggY29udGFpbmVycy4gRm9yIGV4YW1wbGU6IHBhbmVsIGNvbnRhaW5zIGNvbGxhcHNpYmxlIGNvbnRhaW5zCgkJLy8gYXV0b2dyb3cgdGV4dGlucHV0LiBUaGUgcGFuZWwgbWF5IGVtaXQgInBhbmVsb3BlbiIgaW5kaWNhdGluZyB0aGF0IGl0cwoJCS8vIGNvbnRlbnQgaGFzIGJlY29tZSB2aXNpYmxlLCBidXQgdGhlIGNvbGxhcHNpYmxlIGlzIHN0aWxsIGNvbGxhcHNlZCwgc28KCQkvLyB0aGUgYXV0b2dyb3cgdGV4dGFyZWEgaXMgc3RpbGwgbm90IHZpc2libGUuCgkJX2hhbmRsZVNob3c6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAkLmNvbnRhaW5zKCBldmVudC50YXJnZXQsIHRoaXMuZWxlbWVudFsgMCBdICkgJiYKCQkJCXRoaXMuZWxlbWVudC5pcyggIjp2aXNpYmxlIiApICkgewoKCQkJCWlmICggZXZlbnQudHlwZSAhPT0gInBvcHVwYmVmb3JlcG9zaXRpb24iICkgewoJCQkJCXRoaXMuZWxlbWVudAoJCQkJCQkuYWRkQ2xhc3MoICJ1aS10ZXh0aW5wdXQtYXV0b2dyb3ctcmVzaXplIiApCgkJCQkJCS5hbmltYXRpb25Db21wbGV0ZSgKCQkJCQkJCSQucHJveHkoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLXRleHRpbnB1dC1hdXRvZ3Jvdy1yZXNpemUiICk7CgkJCQkJCQl9LCB0aGlzICksCgkJCQkJCSJ0cmFuc2l0aW9uIiApOwoJCQkJfQoJCQkJdGhpcy5fcHJlcGFyZUhlaWdodFVwZGF0ZSgpOwoJCQl9CgkJfSwKCgkJX3VuYmluZEF1dG9ncm93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktdGV4dGlucHV0LWF1dG9ncm93IiApOwoJCQl0aGlzLl9vZmYoIHRoaXMuZWxlbWVudCwgImtleXVwIGNoYW5nZSBpbnB1dCBwYXN0ZSIgKTsKCQkJdGhpcy5fb2ZmKCB0aGlzLmRvY3VtZW50LAoJCQkJInBhZ2VzaG93IHBvcHVwYmVmb3JlcG9zaXRpb24gdXBkYXRlbGF5b3V0IHBhbmVsb3BlbiIgKTsKCQl9LAoKCQlrZXl1cFRpbWVvdXQ6IG51bGwsCgoJCV9wcmVwYXJlSGVpZ2h0VXBkYXRlOiBmdW5jdGlvbiggZGVsYXkgKSB7CgkJCWlmICggdGhpcy5rZXl1cFRpbWVvdXQgKSB7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMua2V5dXBUaW1lb3V0ICk7CgkJCX0KCQkJaWYgKCBkZWxheSA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fdXBkYXRlSGVpZ2h0KCk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmtleXVwVGltZW91dCA9IHRoaXMuX2RlbGF5KCAiX3VwZGF0ZUhlaWdodCIsIGRlbGF5ICk7CgkJCX0KCQl9LAoKCQlfdGltZW91dDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3ByZXBhcmVIZWlnaHRVcGRhdGUoIHRoaXMub3B0aW9ucy5rZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQl9LAoKCQlfdXBkYXRlSGVpZ2h0OiBmdW5jdGlvbigpIHsKCQkJdmFyIHBhZGRpbmdUb3AsIHBhZGRpbmdCb3R0b20sIHBhZGRpbmdIZWlnaHQsIHNjcm9sbEhlaWdodCwgY2xpZW50SGVpZ2h0LAoJCQkJYm9yZGVyVG9wLCBib3JkZXJCb3R0b20sIGJvcmRlckhlaWdodCwgaGVpZ2h0LAoJCQkJc2Nyb2xsVG9wID0gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgkJCXRoaXMua2V5dXBUaW1lb3V0ID0gMDsKCgkJCS8vIElFOCB0ZXh0YXJlYXMgaGF2ZSB0aGUgb25wYWdlIHByb3BlcnR5IC0gb3RoZXJzIGRvIG5vdAoJCQlpZiAoICEoICJvbnBhZ2UiIGluIHRoaXMuZWxlbWVudFsgMCBdICkgKSB7CgkJCQl0aGlzLmVsZW1lbnQuY3NzKHsKCQkJCQkiaGVpZ2h0IjogMCwKCQkJCQkibWluLWhlaWdodCI6IDAsCgkJCQkJIm1heC1oZWlnaHQiOiAwCgkJCQl9KTsKCQkJfQoKCQkJc2Nyb2xsSGVpZ2h0ID0gdGhpcy5lbGVtZW50WyAwIF0uc2Nyb2xsSGVpZ2h0OwoJCQljbGllbnRIZWlnaHQgPSB0aGlzLmVsZW1lbnRbIDAgXS5jbGllbnRIZWlnaHQ7CgkJCWJvcmRlclRvcCA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJib3JkZXItdG9wLXdpZHRoIiApICk7CgkJCWJvcmRlckJvdHRvbSA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJib3JkZXItYm90dG9tLXdpZHRoIiApICk7CgkJCWJvcmRlckhlaWdodCA9IGJvcmRlclRvcCArIGJvcmRlckJvdHRvbTsKCQkJaGVpZ2h0ID0gc2Nyb2xsSGVpZ2h0ICsgYm9yZGVySGVpZ2h0ICsgMTU7CgoJCQkvLyBJc3N1ZSA2MTc5OiBQYWRkaW5nIGlzIG5vdCBpbmNsdWRlZCBpbiBzY3JvbGxIZWlnaHQgYW5kCgkJCS8vIGNsaWVudEhlaWdodCBieSBGaXJlZm94IGlmIG5vIHNjcm9sbGJhciBpcyB2aXNpYmxlLiBCZWNhdXNlCgkJCS8vIHRleHRhcmVhcyB1c2UgdGhlIGJvcmRlci1ib3ggYm94LXNpemluZyBtb2RlbCwgcGFkZGluZyBzaG91bGQgYmUKCQkJLy8gaW5jbHVkZWQgaW4gdGhlIG5ldyAoYXNzaWduZWQpIGhlaWdodC4gQmVjYXVzZSB0aGUgaGVpZ2h0IGlzIHNldAoJCQkvLyB0byAwLCBjbGllbnRIZWlnaHQgPT0gMCBpbiBGaXJlZm94LiBUaGVyZWZvcmUsIHdlIGNhbiB1c2UgdGhpcyB0bwoJCQkvLyBjaGVjayBpZiBwYWRkaW5nIG11c3QgYmUgYWRkZWQuCgkJCWlmICggY2xpZW50SGVpZ2h0ID09PSAwICkgewoJCQkJcGFkZGluZ1RvcCA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJwYWRkaW5nLXRvcCIgKSApOwoJCQkJcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApOwoJCQkJcGFkZGluZ0hlaWdodCA9IHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tOwoKCQkJCWhlaWdodCArPSBwYWRkaW5nSGVpZ2h0OwoJCQl9CgoJCQl0aGlzLmVsZW1lbnQuY3NzKHsKCQkJCSJoZWlnaHQiOiBoZWlnaHQsCgkJCQkibWluLWhlaWdodCI6ICIiLAoJCQkJIm1heC1oZWlnaHQiOiAiIgoJCQl9KTsKCgkJCXRoaXMud2luZG93LnNjcm9sbFRvcCggc2Nyb2xsVG9wICk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLmF1dG9ncm93ICYmIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJCXRoaXMuX3VwZGF0ZUhlaWdodCgpOwoJCQl9CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJCWlmICggb3B0aW9ucy5hdXRvZ3JvdyAhPT0gdW5kZWZpbmVkICYmIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJCWlmICggb3B0aW9ucy5hdXRvZ3JvdyApIHsKCQkJCQl0aGlzLl9hdXRvZ3JvdygpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl91bmJpbmRBdXRvZ3JvdygpOwoJCQkJfQoJCQl9CgkJfQoKCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLmV4dGVuZCggewoJaW5pdFNlbGVjdG9yOiAic2VsZWN0Om5vdCggOmpxbURhdGEocm9sZT0nc2xpZGVyJykpOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcpICkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpY29uOiAiY2FyYXQtZCIsCgkJaWNvbnBvczogInJpZ2h0IiwKCQlpbmxpbmU6IGZhbHNlLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQlvdmVybGF5VGhlbWU6IG51bGwsCgkJZGl2aWRlclRoZW1lOiBudWxsLAoJCWhpZGVQbGFjZWhvbGRlck1lbnVJdGVtczogdHJ1ZSwKCQljbG9zZVRleHQ6ICJDbG9zZSIsCgkJbmF0aXZlTWVudTogdHJ1ZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKCV9zZWxlY3RPcHRpb25zOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKCX0sCgoJLy8gc2V0dXAgaXRlbXMgdGhhdCBhcmUgZ2VuZXJhbGx5IG5lY2Vzc2FyeSBmb3Igc2VsZWN0IG1lbnUgZXh0ZW5zaW9uCglfcHJlRXh0ZW5zaW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5saW5lID0gdGhpcy5vcHRpb25zLmlubGluZSB8fCB0aGlzLmVsZW1lbnQuanFtRGF0YSggImlubGluZSIgKSwKCQkJbWluaSA9IHRoaXMub3B0aW9ucy5taW5pIHx8IHRoaXMuZWxlbWVudC5qcW1EYXRhKCAibWluaSIgKSwKCQkJY2xhc3NlcyA9ICIiOwoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLWxlZnQiOwoJCX0KCgkJaWYgKCAgISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gIiB1aS1idG4tcmlnaHQiOwoJCX0KCgkJaWYgKCBpbmxpbmUgKSB7CgkJCWNsYXNzZXMgKz0gIiB1aS1idG4taW5saW5lIjsKCQl9CgkJaWYgKCBtaW5pICkgewoJCQljbGFzc2VzICs9ICIgdWktbWluaSI7CgkJfQoKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0IiArIGNsYXNzZXMgKyAiJz4iICk7CgkJdGhpcy5zZWxlY3RJZCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICkgfHwgKCAic2VsZWN0LSIgKyB0aGlzLnV1aWQgKTsKCQl0aGlzLmJ1dHRvbklkID0gdGhpcy5zZWxlY3RJZCArICItYnV0dG9uIjsKCQl0aGlzLmxhYmVsID0gJCggImxhYmVsW2Zvcj0nIisgdGhpcy5zZWxlY3RJZCArIiddIiApOwoJCXRoaXMuaXNNdWx0aXBsZSA9IHRoaXMuc2VsZWN0WyAwIF0ubXVsdGlwbGU7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiLnVpLXNlbGVjdCIgKTsKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID4gMCApIHsKCQkJaWYgKCB3cmFwcGVyLmlzKCAiLnVpLWJ0bi1sZWZ0LCAudWktYnRuLXJpZ2h0IiApICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB3cmFwcGVyLmhhc0NsYXNzKCAidWktYnRuLWxlZnQiICkgPyAidWktYnRuLWxlZnQiIDogInVpLWJ0bi1yaWdodCIgKTsKCQkJfQoJCQl0aGlzLmVsZW1lbnQuaW5zZXJ0QWZ0ZXIoIHdyYXBwZXIgKTsKCQkJd3JhcHBlci5yZW1vdmUoKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJaWNvbnBvcyA9IG9wdGlvbnMuaWNvbiA/ICggb3B0aW9ucy5pY29ucG9zIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpY29ucG9zIiApICkgOiBmYWxzZSwKCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYXR0ciggImlkIiwgdGhpcy5idXR0b25JZCApCgkJCQkuYWRkQ2xhc3MoICJ1aS1idG4iICsKCQkJCQkoIG9wdGlvbnMuaWNvbiA/ICggIiB1aS1pY29uLSIgKyBvcHRpb25zLmljb24gKyAiIHVpLWJ0bi1pY29uLSIgKyBpY29ucG9zICsKCQkJCQkoIG9wdGlvbnMuaWNvbnNoYWRvdyA/ICIgdWktc2hhZG93LWljb24iIDogIiIgKSApIDoJIiIgKSArIC8qIFRPRE86IFJlbW92ZSBpbiAxLjUuICovCgkJCQkJKCBvcHRpb25zLnRoZW1lID8gIiB1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJCQkoIG9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApICsKCQkJCQkoIG9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiIgKSApOwoKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCgkJLy8gT3BlcmEgZG9lcyBub3QgcHJvcGVybHkgc3VwcG9ydCBvcGFjaXR5IG9uIHNlbGVjdCBlbGVtZW50cwoJCS8vIEluIE1pbmksIGl0IGhpZGVzIHRoZSBlbGVtZW50LCBidXQgbm90IGl0cyB0ZXh0CgkJLy8gT24gdGhlIGRlc2t0b3AsaXQgc2VlbXMgdG8gZG8gdGhlIG9wcG9zaXRlCgkJLy8gZm9yIHRoZXNlIHJlYXNvbnMsIHVzaW5nIHRoZSBuYXRpdmVNZW51IG9wdGlvbiByZXN1bHRzIGluIGEgZnVsbCBuYXRpdmUgc2VsZWN0IGluIE9wZXJhCgkJaWYgKCBvcHRpb25zLm5hdGl2ZU1lbnUgJiYgd2luZG93Lm9wZXJhICYmIHdpbmRvdy5vcGVyYS52ZXJzaW9uICkgewoJCQlidXR0b24uYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1ib2R5LWluaGVyaXQiICkKCQkJCS5oaWRlKCkKCQkJCS5hcHBlbmRUbyggYnV0dG9uLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiApKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gRXZlbnRzIG9uIG5hdGl2ZSBzZWxlY3QKCQl0aGlzLnNlbGVjdC5jaGFuZ2UoZnVuY3Rpb24oKSB7CgkJCXNlbGYucmVmcmVzaCgpOwoKCQkJaWYgKCAhIW9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJCXRoaXMuYmx1cigpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLl9vbiggdGhpcy5idXR0b24sIHsKCQkJa2V5ZG93bjogIl9oYW5kbGVLZXlkb3duIgoJCX0pOwoKCQl0aGlzLmJ1aWxkKCk7Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuc2VsZWN0CgkJCS5hcHBlbmRUbyggc2VsZi5idXR0b24gKQoJCQkuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCS8vIEFkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIHZtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoJCQl9KQoJCQkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCS8vIFJlbW92ZSBhY3RpdmUgY2xhc3Mgb24gc2Nyb2xsL3RvdWNobW92ZQoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIgdm1vdXNlb3V0IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3V0IiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KTsKCgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJc2VsZi5idXR0b24uYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYubGFiZWwuYmluZCggImNsaWNrIGZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuYnV0dG9uLmJpbmQoICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9LCAwICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkIiApOwoJfSwKCglzZWxlY3RlZEluZGljZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJcmV0dXJuIHRoaXMuc2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWxmLl9zZWxlY3RPcHRpb25zKCkuaW5kZXgoIHRoaXMgKTsKCQl9KS5nZXQoKTsKCX0sCgoJc2V0QnV0dG9uVGV4dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJdGV4dCA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCXNwYW4gPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApOwoKCQl0aGlzLmJ1dHRvbi5jaGlsZHJlbiggInNwYW4iICkubm90KCAiLnVpLWxpLWNvdW50IiApLnJlbW92ZSgpLmVuZCgpLmVuZCgpLnByZXBlbmQoIChmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxlY3RlZC5sZW5ndGggKSB7CgkJCQl0ZXh0ID0gc2VsZWN0ZWQubWFwKGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQkJfSkuZ2V0KCkuam9pbiggIiwgIiApOwoJCQl9IGVsc2UgewoJCQkJdGV4dCA9IHNlbGYucGxhY2Vob2xkZXI7CgkJCX0KCgkJCWlmICggdGV4dCApIHsKCQkJCXNwYW4udGV4dCggdGV4dCApOwoJCQl9IGVsc2UgewoKCQkJCS8vIFNldCB0aGUgY29udGVudHMgdG8gJm5ic3A7IHdoaWNoIHdlIHdyaXRlIGFzICYjMTYwOyB0byBiZSBYSFRNTCBjb21wbGlhbnQgLSBzZWUgZ2gtNjY5OQoJCQkJc3Bhbi5odG1sKCAiJiMxNjA7IiApOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4KCQkJCS5hZGRDbGFzcyggc2VsZi5zZWxlY3QuYXR0ciggImNsYXNzIiApICkKCQkJCS5hZGRDbGFzcyggc2VsZWN0ZWQuYXR0ciggImNsYXNzIiApICkKCQkJCS5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSkoKSk7Cgl9LAoKCXNldEJ1dHRvbkNvdW50OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCk7CgoJCS8vIG11bHRpcGxlIGNvdW50IGluc2lkZSBidXR0b24KCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudFsgc2VsZWN0ZWQubGVuZ3RoID4gMSA/ICJzaG93IiA6ICJoaWRlIiBdKCkudGV4dCggc2VsZWN0ZWQubGVuZ3RoICk7CgkJfQoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgewoJCXRoaXMuX2RlbGF5KCAiX3JlZnJlc2hCdXR0b24iICk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoQnV0dG9uOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCQl0aGlzLnNldEJ1dHRvbkNvdW50KCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2hCdXR0b24oKTsKCX0sCgoJLy8gb3BlbiBhbmQgY2xvc2UgcHJlc2VydmVkIGluIG5hdGl2ZSBzZWxlY3RzCgkvLyB0byBzaW1wbGlmeSB1c2VycyBjb2RlIHdoZW4gbG9vcGluZyBvdmVyIHNlbGVjdHMKCW9wZW46ICQubm9vcCwKCWNsb3NlOiAkLm5vb3AsCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saW5rcyA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcywgdGVzdHMgaW5jbHVkZWQgd2l0aCBwYWdlCgkkKCB0YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLmZpbHRlciggIjpqcW1EYXRhKHJlbD0ncG9wdXAnKVtocmVmXVtocmVmIT0nJ10iICkKCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCS8vIEFjY2Vzc2liaWxpdHkgaW5mbyBmb3IgcG9wdXBzCgkJCXZhciBlbGVtZW50ID0gdGhpcywKCQkJCWlkcmVmID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoICJocmVmIiApLnN1YnN0cmluZyggMSApOwoKCQkJaWYgKCBpZHJlZiApIHsKCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAiYXJpYS1oYXNwb3B1cCIsIHRydWUgKTsKCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAiYXJpYS1vd25zIiwgaWRyZWYgKTsKCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAiYXJpYS1leHBhbmRlZCIsIGZhbHNlICk7CgkJCX0KCQl9KQoJCS5lbmQoKQoJCS5ub3QoICIudWktYnRuLCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5hZGRDbGFzcyggInVpLWxpbmsiICk7Cgp9OwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKZnVuY3Rpb24gZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHdpbmRvd1NpemUsIHNlZ21lbnRTaXplLCBvZmZzZXQsIGRlc2lyZWQgKSB7Cgl2YXIgcmV0dXJuVmFsdWUgPSBkZXNpcmVkOwoKCWlmICggd2luZG93U2l6ZSA8IHNlZ21lbnRTaXplICkgewoJCS8vIENlbnRlciBzZWdtZW50IGlmIGl0J3MgYmlnZ2VyIHRoYW4gdGhlIHdpbmRvdwoJCXJldHVyblZhbHVlID0gb2Zmc2V0ICsgKCB3aW5kb3dTaXplIC0gc2VnbWVudFNpemUgKSAvIDI7Cgl9IGVsc2UgewoJCS8vIE90aGVyd2lzZSBjZW50ZXIgaXQgYXQgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZSB3aGlsZSBrZWVwaW5nIGl0IGNvbXBsZXRlbHkgaW5zaWRlIHRoZSB3aW5kb3cKCQlyZXR1cm5WYWx1ZSA9IE1hdGgubWluKCBNYXRoLm1heCggb2Zmc2V0LCBkZXNpcmVkIC0gc2VnbWVudFNpemUgLyAyICksIG9mZnNldCArIHdpbmRvd1NpemUgLSBzZWdtZW50U2l6ZSApOwoJfQoKCXJldHVybiByZXR1cm5WYWx1ZTsKfQoKZnVuY3Rpb24gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoZVdpbmRvdyApIHsKCXJldHVybiB7CgkJeDogdGhlV2luZG93LnNjcm9sbExlZnQoKSwKCQl5OiB0aGVXaW5kb3cuc2Nyb2xsVG9wKCksCgkJY3g6ICggdGhlV2luZG93WyAwIF0uaW5uZXJXaWR0aCB8fCB0aGVXaW5kb3cud2lkdGgoKSApLAoJCWN5OiAoIHRoZVdpbmRvd1sgMCBdLmlubmVySGVpZ2h0IHx8IHRoZVdpbmRvdy5oZWlnaHQoKSApCgl9Owp9CgokLndpZGdldCggIm1vYmlsZS5wb3B1cCIsIHsKCW9wdGlvbnM6IHsKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJdGhlbWU6IG51bGwsCgkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCXNoYWRvdzogdHJ1ZSwKCQljb3JuZXJzOiB0cnVlLAoJCXRyYW5zaXRpb246ICJub25lIiwKCQlwb3NpdGlvblRvOiAib3JpZ2luIiwKCQl0b2xlcmFuY2U6IG51bGwsCgkJY2xvc2VMaW5rU2VsZWN0b3I6ICJhOmpxbURhdGEocmVsPSdiYWNrJykiLAoJCWNsb3NlTGlua0V2ZW50czogImNsaWNrLnBvcHVwIiwKCQluYXZpZ2F0ZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIiwKCQljbG9zZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIHBhZ2ViZWZvcmVjaGFuZ2UucG9wdXAiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWVuaGFuY2VkOiBmYWxzZSwKCgkJLy8gTk9URSBXaW5kb3dzIFBob25lIDcgaGFzIGEgc2Nyb2xsIHBvc2l0aW9uIGNhY2hpbmcgaXNzdWUgdGhhdAoJCS8vICAgICAgcmVxdWlyZXMgdXMgdG8gZGlzYWJsZSBwb3B1cCBoaXN0b3J5IG1hbmFnZW1lbnQgYnkgZGVmYXVsdAoJCS8vICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80Nzg0CgkJLy8KCQkvLyBOT1RFIHRoaXMgb3B0aW9uIGlzIG1vZGlmaWVkIGluIF9jcmVhdGUhCgkJaGlzdG9yeTogISQubW9iaWxlLmJyb3dzZXIub2xkSUUKCX0sCgoJLy8gV2hlbiB0aGUgdXNlciBkZXByZXNzZXMgdGhlIG1vdXNlL2ZpbmdlciBvbiBhbiBlbGVtZW50IGluc2lkZSB0aGUgcG9wdXAgd2hpbGUgdGhlIHBvcHVwIGlzCgkvLyBvcGVuLCB3ZSBpZ25vcmUgcmVzaXplIGV2ZW50cyBmb3IgYSBzaG9ydCB3aGlsZS4gVGhpcyBwcmV2ZW50cyAjNjk2MS4KCV9oYW5kbGVEb2N1bWVudFZtb3VzZWRvd246IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiAkLmNvbnRhaW5zKCB0aGlzLl91aS5jb250YWluZXJbIDAgXSwgdGhlRXZlbnQudGFyZ2V0ICkgKSB7CgkJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoZUVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCgkJCW15SWQgPSB0aGVFbGVtZW50LmF0dHIoICJpZCIgKSwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFdlIG5lZWQgdG8gYWRqdXN0IHRoZSBoaXN0b3J5IG9wdGlvbiB0byBiZSBmYWxzZSBpZiB0aGVyZSdzIG5vIEFKQVggbmF2LgoJCS8vIFdlIGNhbid0IGRvIGl0IGluIHRoZSBvcHRpb24gZGVjbGFyYXRpb25zIGJlY2F1c2UgdGhvc2UgYXJlIHJ1biBiZWZvcmUKCQkvLyBpdCBpcyBkZXRlcm1pbmVkIHdoZXRoZXIgdGhlcmUgc2hhbGwgYmUgQUpBWCBuYXYuCgkJY3VycmVudE9wdGlvbnMuaGlzdG9yeSA9IGN1cnJlbnRPcHRpb25zLmhpc3RvcnkgJiYgJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQ7CgoJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7CgkJCSJ2bW91c2Vkb3duIjogIl9oYW5kbGVEb2N1bWVudFZtb3VzZWRvd24iCgkJfSk7CgoJCS8vIERlZmluZSBpbnN0YW5jZSB2YXJpYWJsZXMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfc2Nyb2xsVG9wOiAwLAoJCQlfcGFnZTogdGhlRWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCV91aTogbnVsbCwKCQkJX2ZhbGxiYWNrVHJhbnNpdGlvbjogIiIsCgkJCV9jdXJyZW50VHJhbnNpdGlvbjogZmFsc2UsCgkJCV9wcmVyZXF1aXNpdGVzOiBudWxsLAoJCQlfaXNPcGVuOiBmYWxzZSwKCQkJX3RvbGVyYW5jZTogbnVsbCwKCQkJX3Jlc2l6ZURhdGE6IG51bGwsCgkJCV9pZ25vcmVSZXNpemVUbzogMCwKCQkJX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzczogZmFsc2UKCQl9KTsKCgkJaWYgKCB0aGlzLl9wYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy5fcGFnZSA9ICQoICJib2R5IiApOwoJCX0KCgkJaWYgKCBjdXJyZW50T3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fdWkgPSB7CgkJCQljb250YWluZXI6IHRoZUVsZW1lbnQucGFyZW50KCksCgkJCQlzY3JlZW46IHRoZUVsZW1lbnQucGFyZW50KCkucHJldigpLAoJCQkJcGxhY2Vob2xkZXI6ICQoIHRoaXMuZG9jdW1lbnRbIDAgXS5nZXRFbGVtZW50QnlJZCggbXlJZCArICItcGxhY2Vob2xkZXIiICkgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSggdGhlRWxlbWVudCwgbXlJZCApOwoJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGN1cnJlbnRPcHRpb25zLnRyYW5zaXRpb24gKTsKCQl9CgkJdGhpcwoJCQkuX3NldFRvbGVyYW5jZSggY3VycmVudE9wdGlvbnMudG9sZXJhbmNlICkKCQkJLl91aS5mb2N1c0VsZW1lbnQgPSB0aGlzLl91aS5jb250YWluZXI7CgoJCS8vIEV2ZW50IGhhbmRsZXJzCgkJdGhpcy5fb24oIHRoaXMuX3VpLnNjcmVlbiwgeyAidmNsaWNrIjogIl9lYXRFdmVudEFuZENsb3NlIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCW9yaWVudGF0aW9uY2hhbmdlOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlIiApLAoJCQlyZXNpemU6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93UmVzaXplIiApLAoJCQlrZXl1cDogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dLZXlVcCIgKQoJCX0pOwoJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7ICJmb2N1c2luIjogIl9oYW5kbGVEb2N1bWVudEZvY3VzSW4iIH0gKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCB0aGVFbGVtZW50LCBteUlkICkgewoJCXZhciBjdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJd3JhcHBlckNsYXNzID0gY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzLAoJCQl1aSA9IHsKCQkJCXNjcmVlbjogJCggIjxkaXYgY2xhc3M9J3VpLXNjcmVlbi1oaWRkZW4gdWktcG9wdXAtc2NyZWVuICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIGN1cnJlbnRPcHRpb25zLm92ZXJsYXlUaGVtZSApICsgIic+PC9kaXY+IiApLAoJCQkJcGxhY2Vob2xkZXI6ICQoICI8ZGl2IHN0eWxlPSdkaXNwbGF5OiBub25lOyc+PCEtLSBwbGFjZWhvbGRlciAtLT48L2Rpdj4iICksCgkJCQljb250YWluZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1jb250YWluZXIgdWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiArCgkJCQkJKCB3cmFwcGVyQ2xhc3MgPyAoICIgIiArIHdyYXBwZXJDbGFzcyApIDogIiIgKSArICInPjwvZGl2PiIgKQoJCQl9LAoJCQlmcmFnbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCB1aS5zY3JlZW5bIDAgXSApOwoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCB1aS5jb250YWluZXJbIDAgXSApOwoKCQlpZiAoIG15SWQgKSB7CgkJCXVpLnNjcmVlbi5hdHRyKCAiaWQiLCBteUlkICsgIi1zY3JlZW4iICk7CgkJCXVpLmNvbnRhaW5lci5hdHRyKCAiaWQiLCBteUlkICsgIi1wb3B1cCIgKTsKCQkJdWkucGxhY2Vob2xkZXIKCQkJCS5hdHRyKCAiaWQiLCBteUlkICsgIi1wbGFjZWhvbGRlciIgKQoJCQkJLmh0bWwoICI8IS0tIHBsYWNlaG9sZGVyIGZvciAiICsgbXlJZCArICIgLS0+IiApOwoJCX0KCgkJLy8gQXBwbHkgdGhlIHByb3RvCgkJdGhpcy5fcGFnZVsgMCBdLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoJCS8vIExlYXZlIGEgcGxhY2Vob2xkZXIgd2hlcmUgdGhlIGVsZW1lbnQgdXNlZCB0byBiZQoJCXVpLnBsYWNlaG9sZGVyLmluc2VydEFmdGVyKCB0aGVFbGVtZW50ICk7CgkJdGhlRWxlbWVudAoJCQkuZGV0YWNoKCkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgY3VycmVudE9wdGlvbnMudGhlbWUgKSArICIgIiArCgkJCQkoIGN1cnJlbnRPcHRpb25zLnNoYWRvdyA/ICJ1aS1vdmVybGF5LXNoYWRvdyAiIDogIiIgKSArCgkJCQkoIGN1cnJlbnRPcHRpb25zLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSApCgkJCS5hcHBlbmRUbyggdWkuY29udGFpbmVyICk7CgoJCXJldHVybiB1aTsKCX0sCgoJX2VhdEV2ZW50QW5kQ2xvc2U6IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCXRoZUV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJLy8gTWFrZSBzdXJlIHRoZSBzY3JlZW4gY292ZXJzIHRoZSBlbnRpcmUgZG9jdW1lbnQgLSBDU1MgaXMgc29tZXRpbWVzIG5vdAoJLy8gZW5vdWdoIHRvIGFjY29tcGxpc2ggdGhpcy4KCV9yZXNpemVTY3JlZW46IGZ1bmN0aW9uKCkgewoJCXZhciBzY3JlZW4gPSB0aGlzLl91aS5zY3JlZW4sCgkJCXBvcHVwSGVpZ2h0ID0gdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICksCgkJCXNjcmVlbkhlaWdodCA9IHNjcmVlbi5yZW1vdmVBdHRyKCAic3R5bGUiICkuaGVpZ2h0KCksCgoJCQkvLyBTdWJ0cmFjdGluZyAxIGhlcmUgaXMgbmVjZXNzYXJ5IGZvciBhbiBvYnNjdXJlIEFuZHJkb2lkIDQuMCBidWcgd2hlcmUKCQkJLy8gdGhlIGJyb3dzZXIgaGFuZ3MgaWYgdGhlIHNjcmVlbiBjb3ZlcnMgdGhlIGVudGlyZSBkb2N1bWVudCA6LwoJCQlkb2N1bWVudEhlaWdodCA9IHRoaXMuZG9jdW1lbnQuaGVpZ2h0KCkgLSAxOwoKCQlpZiAoIHNjcmVlbkhlaWdodCA8IGRvY3VtZW50SGVpZ2h0ICkgewoJCQlzY3JlZW4uaGVpZ2h0KCBkb2N1bWVudEhlaWdodCApOwoJCX0gZWxzZSBpZiAoIHBvcHVwSGVpZ2h0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQlzY3JlZW4uaGVpZ2h0KCBwb3B1cEhlaWdodCApOwoJCX0KCX0sCgoJX2hhbmRsZVdpbmRvd0tleVVwOiBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gJiYgdGhlRXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FU0NBUEUgKSB7CgkJCXJldHVybiB0aGlzLl9lYXRFdmVudEFuZENsb3NlKCB0aGVFdmVudCApOwoJCX0KCX0sCgoJX2V4cGVjdFJlc2l6ZUV2ZW50OiBmdW5jdGlvbigpIHsKCQl2YXIgd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcyggdGhpcy53aW5kb3cgKTsKCgkJaWYgKCB0aGlzLl9yZXNpemVEYXRhICkgewoJCQlpZiAoIHdpbmRvd0Nvb3JkaW5hdGVzLnggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMueCAmJgoJCQkJd2luZG93Q29vcmRpbmF0ZXMueSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy55ICYmCgkJCQl3aW5kb3dDb29yZGluYXRlcy5jeCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy5jeCAmJgoJCQkJd2luZG93Q29vcmRpbmF0ZXMuY3kgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMuY3kgKSB7CgkJCQkvLyB0aW1lb3V0IG5vdCByZWZyZXNoZWQKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIHsKCQkJCS8vIGNsZWFyIGV4aXN0aW5nIHRpbWVvdXQgLSBpdCB3aWxsIGJlIHJlZnJlc2hlZCBiZWxvdwoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9yZXNpemVEYXRhLnRpbWVvdXRJZCApOwoJCQl9CgkJfQoKCQl0aGlzLl9yZXNpemVEYXRhID0gewoJCQl0aW1lb3V0SWQ6IHRoaXMuX2RlbGF5KCAiX3Jlc2l6ZVRpbWVvdXQiLCAyMDAgKSwKCQkJd2luZG93Q29vcmRpbmF0ZXM6IHdpbmRvd0Nvb3JkaW5hdGVzCgkJfTsKCgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9yZXNpemVUaW1lb3V0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJaWYgKCAhdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKSApIHsKCQkJCWlmICggdGhpcy5fdWkuY29udGFpbmVyLmhhc0NsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApICkgewoJCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLW9wZW4gdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICk7CgkJCQkJdGhpcy5yZXBvc2l0aW9uKCB7IHBvc2l0aW9uVG86ICJ3aW5kb3ciIH0gKTsKCQkJCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQkJCX0KCgkJCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJCX0KCQl9IGVsc2UgewoJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJfQoJfSwKCglfc3RvcElnbm9yaW5nUmVzaXplRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pZ25vcmVSZXNpemVUbyA9IDA7Cgl9LAoKCV9pZ25vcmVSZXNpemVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5faWdub3JlUmVzaXplVG8gKSB7CgkJCWNsZWFyVGltZW91dCggdGhpcy5faWdub3JlUmVzaXplVG8gKTsKCQl9CgkJdGhpcy5faWdub3JlUmVzaXplVG8gPSB0aGlzLl9kZWxheSggIl9zdG9wSWdub3JpbmdSZXNpemVFdmVudHMiLCAxMDAwICk7Cgl9LAoKCV9oYW5kbGVXaW5kb3dSZXNpemU6IGZ1bmN0aW9uKC8qIHRoZUV2ZW50ICovKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gJiYgdGhpcy5faWdub3JlUmVzaXplVG8gPT09IDAgKSB7CgkJCWlmICggKCB0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpIHx8IHRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyApICYmCgkJCQkhdGhpcy5fdWkuY29udGFpbmVyLmhhc0NsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApICkgewoJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtY2xvc2UgdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJCX0KCQl9Cgl9LAoKCV9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZTogZnVuY3Rpb24oLyogdGhlRXZlbnQgKi8pIHsKCQlpZiAoICF0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgJiYgdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQl0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpOwoJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSB0cnVlOwoJCX0KCX0sCgoJLy8gV2hlbiB0aGUgcG9wdXAgaXMgb3BlbiwgYXR0ZW1wdGluZyB0byBmb2N1cyBvbiBhbiBlbGVtZW50IHRoYXQgaXMgbm90IGEKCS8vIGNoaWxkIG9mIHRoZSBwb3B1cCB3aWxsIHJlZGlyZWN0IGZvY3VzIHRvIHRoZSBwb3B1cAoJX2hhbmRsZURvY3VtZW50Rm9jdXNJbjogZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCXZhciB0YXJnZXQsCgkJCXRhcmdldEVsZW1lbnQgPSB0aGVFdmVudC50YXJnZXQsCgkJCXVpID0gdGhpcy5fdWk7CgoJCWlmICggIXRoaXMuX2lzT3BlbiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0YXJnZXRFbGVtZW50ICE9PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJdGFyZ2V0ID0gJCggdGFyZ2V0RWxlbWVudCApOwoJCQlpZiAoIDAgPT09IHRhcmdldC5wYXJlbnRzKCkuZmlsdGVyKCB1aS5jb250YWluZXJbIDAgXSApLmxlbmd0aCApIHsKCQkJCSQoIHRoaXMuZG9jdW1lbnRbIDAgXS5hY3RpdmVFbGVtZW50ICkub25lKCAiZm9jdXMiLCBmdW5jdGlvbigvKiB0aGVFdmVudCAqLykgewoJCQkJCWlmICggdGFyZ2V0RWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAiYm9keSIgKSB7CgkJCQkgICAgICAgICAgICB0YXJnZXQuYmx1cigpOwoJCQkJICAgICAgICB9CgkJCQl9KTsKCQkJCXVpLmZvY3VzRWxlbWVudC5mb2N1cygpOwoJCQkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCXRoZUV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9IGVsc2UgaWYgKCB1aS5mb2N1c0VsZW1lbnRbIDAgXSA9PT0gdWkuY29udGFpbmVyWyAwIF0gKSB7CgkJCQl1aS5mb2N1c0VsZW1lbnQgPSB0YXJnZXQ7CgkJCX0KCQl9CgoJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiAoIHByZWZpeCArIHZhbHVlICkgKSA6ICggcHJlZml4ICsgImluaGVyaXQiICkgKTsKCX0sCgoJX2FwcGx5VHJhbnNpdGlvbjogZnVuY3Rpb24oIHZhbHVlICkgewoJCWlmICggdmFsdWUgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCWlmICggdmFsdWUgIT09ICJub25lIiApIHsKCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCQkJaWYgKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPT09ICJub25lIiApIHsKCQkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAiIjsKCQkJCX0KCQkJCXRoaXMuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG5ld09wdGlvbnMgKSB7CgkJdmFyIGN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQl0aGVFbGVtZW50ID0gdGhpcy5lbGVtZW50LAoJCQlzY3JlZW4gPSB0aGlzLl91aS5zY3JlZW47CgoJCWlmICggbmV3T3B0aW9ucy53cmFwcGVyQ2xhc3MgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkucmVtb3ZlQ2xhc3MoIGN1cnJlbnRPcHRpb25zLndyYXBwZXJDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIG5ld09wdGlvbnMud3JhcHBlckNsYXNzICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhlRWxlbWVudAoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgY3VycmVudE9wdGlvbnMudGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBuZXdPcHRpb25zLnRoZW1lICkgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy5vdmVybGF5VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJc2NyZWVuCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktb3ZlcmxheS0iLCBjdXJyZW50T3B0aW9ucy5vdmVybGF5VGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktb3ZlcmxheS0iLCBuZXdPcHRpb25zLm92ZXJsYXlUaGVtZSApICk7CgoJCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJCXNjcmVlbi5hZGRDbGFzcyggImluIiApOwoJCQl9CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoZUVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1vdmVybGF5LXNoYWRvdyIsIG5ld09wdGlvbnMuc2hhZG93ICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVFbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG5ld09wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnRyYW5zaXRpb24gIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAhdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIG5ld09wdGlvbnMudHJhbnNpdGlvbiApOwoJCQl9CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMudG9sZXJhbmNlICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldFRvbGVyYW5jZSggbmV3T3B0aW9ucy50b2xlcmFuY2UgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIG5ld09wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQl0aGlzLmNsb3NlKCk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9zdXBlciggbmV3T3B0aW9ucyApOwoJfSwKCglfc2V0VG9sZXJhbmNlOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIHRvbCA9IHsgdDogMzAsIHI6IDE1LCBiOiAzMCwgbDogMTUgfSwKCQkJYXI7CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJYXIgPSBTdHJpbmcoIHZhbHVlICkuc3BsaXQoICIsIiApOwoKCQkJJC5lYWNoKCBhciwgZnVuY3Rpb24oIGlkeCwgdmFsICkgeyBhclsgaWR4IF0gPSBwYXJzZUludCggdmFsLCAxMCApOyB9ICk7CgoJCQlzd2l0Y2goIGFyLmxlbmd0aCApIHsKCQkJCS8vIEFsbCB2YWx1ZXMgYXJlIHRvIGJlIHRoZSBzYW1lCgkJCQljYXNlIDE6CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJdG9sLnQgPSB0b2wuciA9IHRvbC5iID0gdG9sLmwgPSBhclsgMCBdOwoJCQkJCX0KCQkJCQlicmVhazsKCgkJCQkvLyBUaGUgZmlyc3QgdmFsdWUgZGVub3RlcyB0b3AvYm90dG9tIHRvbGVyYW5jZSwgYW5kIHRoZSBzZWNvbmQgdmFsdWUgZGVub3RlcyBsZWZ0L3JpZ2h0IHRvbGVyYW5jZQoJCQkJY2FzZSAyOgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gdG9sLmIgPSBhclsgMCBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQl0b2wubCA9IHRvbC5yID0gYXJbIDEgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJLy8gVGhlIGFycmF5IGNvbnRhaW5zIHZhbHVlcyBpbiB0aGUgb3JkZXIgdG9wLCByaWdodCwgYm90dG9tLCBsZWZ0CgkJCQljYXNlIDQ6CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJdG9sLnQgPSBhclsgMCBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQl0b2wuciA9IGFyWyAxIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMiBdICkgKSB7CgkJCQkJCXRvbC5iID0gYXJbIDIgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAzIF0gKSApIHsKCQkJCQkJdG9sLmwgPSBhclsgMyBdOwoJCQkJCX0KCQkJCQlicmVhazsKCgkJCQlkZWZhdWx0OgoJCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQl0aGlzLl90b2xlcmFuY2UgPSB0b2w7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9jbGFtcFBvcHVwV2lkdGg6IGZ1bmN0aW9uKCBpbmZvT25seSApIHsKCQl2YXIgbWVudVNpemUsCgkJCXdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoaXMud2luZG93ICksCgkJCS8vIHJlY3RhbmdsZSB3aXRoaW4gd2hpY2ggdGhlIHBvcHVwIG11c3QgZml0CgkJCXJlY3RhbmdsZSA9IHsKCQkJCXg6IHRoaXMuX3RvbGVyYW5jZS5sLAoJCQkJeTogd2luZG93Q29vcmRpbmF0ZXMueSArIHRoaXMuX3RvbGVyYW5jZS50LAoJCQkJY3g6IHdpbmRvd0Nvb3JkaW5hdGVzLmN4IC0gdGhpcy5fdG9sZXJhbmNlLmwgLSB0aGlzLl90b2xlcmFuY2UuciwKCQkJCWN5OiB3aW5kb3dDb29yZGluYXRlcy5jeSAtIHRoaXMuX3RvbGVyYW5jZS50IC0gdGhpcy5fdG9sZXJhbmNlLmIKCQkJfTsKCgkJaWYgKCAhaW5mb09ubHkgKSB7CgkJCS8vIENsYW1wIHRoZSB3aWR0aCBvZiB0aGUgbWVudSBiZWZvcmUgZ3JhYmJpbmcgaXRzIHNpemUKCQkJdGhpcy5fdWkuY29udGFpbmVyLmNzcyggIm1heC13aWR0aCIsIHJlY3RhbmdsZS5jeCApOwoJCX0KCgkJbWVudVNpemUgPSB7CgkJCWN4OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJXaWR0aCggdHJ1ZSApLAoJCQljeTogdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICkKCQl9OwoKCQlyZXR1cm4geyByYzogcmVjdGFuZ2xlLCBtZW51U2l6ZTogbWVudVNpemUgfTsKCX0sCgoJX2NhbGN1bGF0ZUZpbmFsTG9jYXRpb246IGZ1bmN0aW9uKCBkZXNpcmVkLCBjbGFtcEluZm8gKSB7CgkJdmFyIHJldHVyblZhbHVlLAoJCQlyZWN0YW5nbGUgPSBjbGFtcEluZm8ucmMsCgkJCW1lbnVTaXplID0gY2xhbXBJbmZvLm1lbnVTaXplOwoKCQkvLyBDZW50ZXIgdGhlIG1lbnUgb3ZlciB0aGUgZGVzaXJlZCBjb29yZGluYXRlcywgd2hpbGUgbm90IGdvaW5nIG91dHNpZGUKCQkvLyB0aGUgd2luZG93IHRvbGVyYW5jZXMuIFRoaXMgd2lsbCBjZW50ZXIgd3J0LiB0aGUgd2luZG93IGlmIHRoZSBwb3B1cCBpcwoJCS8vIHRvbyBsYXJnZS4KCQlyZXR1cm5WYWx1ZSA9IHsKCQkJbGVmdDogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJlY3RhbmdsZS5jeCwgbWVudVNpemUuY3gsIHJlY3RhbmdsZS54LCBkZXNpcmVkLnggKSwKCQkJdG9wOiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmVjdGFuZ2xlLmN5LCBtZW51U2l6ZS5jeSwgcmVjdGFuZ2xlLnksIGRlc2lyZWQueSApCgkJfTsKCgkJLy8gTWFrZSBzdXJlIHRoZSB0b3Agb2YgdGhlIG1lbnUgaXMgdmlzaWJsZQoJCXJldHVyblZhbHVlLnRvcCA9IE1hdGgubWF4KCAwLCByZXR1cm5WYWx1ZS50b3AgKTsKCgkJLy8gSWYgdGhlIGhlaWdodCBvZiB0aGUgbWVudSBpcyBzbWFsbGVyIHRoYW4gdGhlIGhlaWdodCBvZiB0aGUgZG9jdW1lbnQKCQkvLyBhbGlnbiB0aGUgYm90dG9tIHdpdGggdGhlIGJvdHRvbSBvZiB0aGUgZG9jdW1lbnQKCgkJcmV0dXJuVmFsdWUudG9wIC09IE1hdGgubWluKCByZXR1cm5WYWx1ZS50b3AsCgkJCU1hdGgubWF4KCAwLCByZXR1cm5WYWx1ZS50b3AgKyBtZW51U2l6ZS5jeSAtIHRoaXMuZG9jdW1lbnQuaGVpZ2h0KCkgKSApOwoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9LAoKCS8vIFRyeSBhbmQgY2VudGVyIHRoZSBvdmVybGF5IG92ZXIgdGhlIGdpdmVuIGNvb3JkaW5hdGVzCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQlyZXR1cm4gdGhpcy5fY2FsY3VsYXRlRmluYWxMb2NhdGlvbiggZGVzaXJlZCwgdGhpcy5fY2xhbXBQb3B1cFdpZHRoKCkgKTsKCX0sCgoJX2NyZWF0ZVByZXJlcXVpc2l0ZXM6IGZ1bmN0aW9uKCBzY3JlZW5QcmVyZXF1aXNpdGUsIGNvbnRhaW5lclByZXJlcXVpc2l0ZSwgd2hlbkRvbmUgKSB7CgkJdmFyIHByZXJlcXVpc2l0ZXMsCgkJCXNlbGYgPSB0aGlzOwoKCQkvLyBJdCBpcyBpbXBvcnRhbnQgdG8gbWFpbnRhaW4gYm90aCB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxdWlzaXRlcyBhbmQKCQkvLyBzZWxmLl9wcmVyZXF1aXNpdGVzLiBUaGUgbG9jYWwgdmFyaWFibGUgcmVtYWlucyBpbiB0aGUgY2xvc3VyZSBvZiB0aGUKCQkvLyBmdW5jdGlvbnMgd2hpY2ggY2FsbCB0aGUgY2FsbGJhY2tzIHBhc3NlZCBpbi4gVGhlIGNvbXBhcmlzb24gYmV0d2VlbiB0aGUKCQkvLyBsb2NhbCB2YXJpYWJsZSBhbmQgc2VsZi5fcHJlcmVxdWlzaXRlcyBpcyBuZWNlc3NhcnksIGJlY2F1c2Ugb25jZSBhCgkJLy8gZnVuY3Rpb24gaGFzIGJlZW4gcGFzc2VkIHRvIC5hbmltYXRpb25Db21wbGV0ZSgpIGl0IHdpbGwgYmUgY2FsbGVkIG5leHQKCQkvLyB0aW1lIGFuIGFuaW1hdGlvbiBjb21wbGV0ZXMsIGV2ZW4gaWYgdGhhdCdzIG5vdCB0aGUgYW5pbWF0aW9uIHdob3NlIGVuZAoJCS8vIHRoZSBmdW5jdGlvbiB3YXMgc3VwcG9zZWQgdG8gY2F0Y2ggKGZvciBleGFtcGxlLCBpZiBhbiBhYm9ydCBoYXBwZW5zCgkJLy8gZHVyaW5nIHRoZSBvcGVuaW5nIGFuaW1hdGlvbiwgdGhlIC5hbmltYXRpb25Db21wbGV0ZSBoYW5kbGVyIGlzIG5vdAoJCS8vIGNhbGxlZCBmb3IgdGhhdCBhbmltYXRpb24gYW55bW9yZSwgYnV0IHRoZSBoYW5kbGVyIHJlbWFpbnMgYXR0YWNoZWQsIHNvCgkJLy8gaXQgaXMgY2FsbGVkIHRoZSBuZXh0IHRpbWUgdGhlIHBvcHVwIGlzIG9wZW5lZCAtIG1ha2luZyBpdCBzdGFsZS4KCQkvLyBDb21wYXJpbmcgdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXVpc2l0ZXMgdG8gdGhlIHdpZGdldC1sZXZlbCB2YXJpYWJsZQoJCS8vIHNlbGYuX3ByZXJlcXVpc2l0ZXMgZW5zdXJlcyB0aGF0IGNhbGxiYWNrcyB0cmlnZ2VyZWQgYnkgYSBzdGFsZQoJCS8vIC5hbmltYXRpb25Db21wbGV0ZSB3aWxsIGJlIGlnbm9yZWQuCgoJCXByZXJlcXVpc2l0ZXMgPSB7CgkJCXNjcmVlbjogJC5EZWZlcnJlZCgpLAoJCQljb250YWluZXI6ICQuRGVmZXJyZWQoKQoJCX07CgoJCXByZXJlcXVpc2l0ZXMuc2NyZWVuLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQlzY3JlZW5QcmVyZXF1aXNpdGUoKTsKCQkJfQoJCX0pOwoKCQlwcmVyZXF1aXNpdGVzLmNvbnRhaW5lci50aGVuKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJY29udGFpbmVyUHJlcmVxdWlzaXRlKCk7CgkJCX0KCQl9KTsKCgkJJC53aGVuKCBwcmVyZXF1aXNpdGVzLnNjcmVlbiwgcHJlcmVxdWlzaXRlcy5jb250YWluZXIgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJc2VsZi5fcHJlcmVxdWlzaXRlcyA9IG51bGw7CgkJCQl3aGVuRG9uZSgpOwoJCQl9CgkJfSk7CgoJCXNlbGYuX3ByZXJlcXVpc2l0ZXMgPSBwcmVyZXF1aXNpdGVzOwoJfSwKCglfYW5pbWF0ZTogZnVuY3Rpb24oIGFyZ3MgKSB7CgkJLy8gTk9URSBiZWZvcmUgcmVtb3ZpbmcgdGhlIGRlZmF1bHQgYW5pbWF0aW9uIG9mIHRoZSBzY3JlZW4KCQkvLyAgICAgIHRoaXMgaGFkIGFuIGFuaW1hdGUgY2FsbGJhY2sgdGhhdCB3b3VsZCByZXNvbHZlIHRoZSBkZWZlcnJlZAoJCS8vICAgICAgbm93IHRoZSBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbW1lZGlhdGVseQoJCS8vIFRPRE8gcmVtb3ZlIHRoZSBkZXBlbmRlbmN5IG9uIHRoZSBzY3JlZW4gZGVmZXJyZWQKCQl0aGlzLl91aS5zY3JlZW4KCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkuYWRkQ2xhc3MoIGFyZ3Muc2NyZWVuQ2xhc3NUb0FkZCApOwoKCQlhcmdzLnByZXJlcXVpc2l0ZXMuc2NyZWVuLnJlc29sdmUoKTsKCgkJaWYgKCBhcmdzLnRyYW5zaXRpb24gJiYgYXJncy50cmFuc2l0aW9uICE9PSAibm9uZSIgKSB7CgkJCWlmICggYXJncy5hcHBseVRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGFyZ3MudHJhbnNpdGlvbiApOwoJCQl9CgkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFkZENsYXNzKCBhcmdzLmNvbnRhaW5lckNsYXNzVG9BZGQgKQoJCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoIGFyZ3MucHJlcmVxdWlzaXRlcy5jb250YWluZXIsICJyZXNvbHZlIiApICk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQlhcmdzLnByZXJlcXVpc2l0ZXMuY29udGFpbmVyLnJlc29sdmUoKTsKCX0sCgoJLy8gVGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgcGFzc2VkIGluIHdpbGwgYmUgcmV0dXJuZWQgdW50b3VjaGVkIGlmIG5vIHJlZmVyZW5jZSBlbGVtZW50IGNhbiBiZSBpZGVudGlmaWVkIHZpYQoJLy8gZGVzaXJlZFBvc2l0aW9uLnBvc2l0aW9uVG8uIE5ldmVydGhlbGVzcywgdGhpcyBmdW5jdGlvbiBlbnN1cmVzIHRoYXQgaXRzIHJldHVybiB2YWx1ZSBhbHdheXMgY29udGFpbnMgdmFsaWQKCS8vIHggYW5kIHkgY29vcmRpbmF0ZXMgYnkgc3BlY2lmeWluZyB0aGUgY2VudGVyIG1pZGRsZSBvZiB0aGUgd2luZG93IGlmIHRoZSBjb29yZGluYXRlcyBhcmUgYWJzZW50LgoJLy8gb3B0aW9uczogeyB4OiBjb29yZGluYXRlLCB5OiBjb29yZGluYXRlLCBwb3NpdGlvblRvOiBzdHJpbmc6ICJvcmlnaW4iLCAid2luZG93Iiwgb3IgalF1ZXJ5IHNlbGVjdG9yCglfZGVzaXJlZENvb3JkczogZnVuY3Rpb24oIG9wZW5PcHRpb25zICkgewoJCXZhciBvZmZzZXQsCgkJCWRzdCA9IG51bGwsCgkJCXdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoaXMud2luZG93ICksCgkJCXggPSBvcGVuT3B0aW9ucy54LAoJCQl5ID0gb3Blbk9wdGlvbnMueSwKCQkJcFRvID0gb3Blbk9wdGlvbnMucG9zaXRpb25UbzsKCgkJLy8gRXN0YWJsaXNoIHdoaWNoIGVsZW1lbnQgd2lsbCBzZXJ2ZSBhcyB0aGUgcmVmZXJlbmNlCgkJaWYgKCBwVG8gJiYgcFRvICE9PSAib3JpZ2luIiApIHsKCQkJaWYgKCBwVG8gPT09ICJ3aW5kb3ciICkgewoJCQkJeCA9IHdpbmRvd0Nvb3JkaW5hdGVzLmN4IC8gMiArIHdpbmRvd0Nvb3JkaW5hdGVzLng7CgkJCQl5ID0gd2luZG93Q29vcmRpbmF0ZXMuY3kgLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueTsKCQkJfSBlbHNlIHsKCQkJCXRyeSB7CgkJCQkJZHN0ID0gJCggcFRvICk7CgkJCQl9IGNhdGNoKCBlcnIgKSB7CgkJCQkJZHN0ID0gbnVsbDsKCQkJCX0KCQkJCWlmICggZHN0ICkgewoJCQkJCWRzdC5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCQkJCQlpZiAoIGRzdC5sZW5ndGggPT09IDAgKSB7CgkJCQkJCWRzdCA9IG51bGw7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQkvLyBJZiBhbiBlbGVtZW50IHdhcyBmb3VuZCwgY2VudGVyIG92ZXIgaXQKCQlpZiAoIGRzdCApIHsKCQkJb2Zmc2V0ID0gZHN0Lm9mZnNldCgpOwoJCQl4ID0gb2Zmc2V0LmxlZnQgKyBkc3Qub3V0ZXJXaWR0aCgpIC8gMjsKCQkJeSA9IG9mZnNldC50b3AgKyBkc3Qub3V0ZXJIZWlnaHQoKSAvIDI7CgkJfQoKCQkvLyBNYWtlIHN1cmUgeCBhbmQgeSBhcmUgdmFsaWQgbnVtYmVycyAtIGNlbnRlciBvdmVyIHRoZSB3aW5kb3cKCQlpZiAoICQudHlwZSggeCApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeCApICkgewoJCQl4ID0gd2luZG93Q29vcmRpbmF0ZXMuY3ggLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueDsKCQl9CgkJaWYgKCAkLnR5cGUoIHkgKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHkgKSApIHsKCQkJeSA9IHdpbmRvd0Nvb3JkaW5hdGVzLmN5IC8gMiArIHdpbmRvd0Nvb3JkaW5hdGVzLnk7CgkJfQoKCQlyZXR1cm4geyB4OiB4LCB5OiB5IH07Cgl9LAoKCV9yZXBvc2l0aW9uOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJLy8gV2Ugb25seSBjYXJlIGFib3V0IHBvc2l0aW9uLXJlbGF0ZWQgcGFyYW1ldGVycyBmb3IgcmVwb3NpdGlvbmluZwoJCW9wZW5PcHRpb25zID0gewoJCQl4OiBvcGVuT3B0aW9ucy54LAoJCQl5OiBvcGVuT3B0aW9ucy55LAoJCQlwb3NpdGlvblRvOiBvcGVuT3B0aW9ucy5wb3NpdGlvblRvCgkJfTsKCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlcG9zaXRpb24iLCB1bmRlZmluZWQsIG9wZW5PcHRpb25zICk7CgkJdGhpcy5fdWkuY29udGFpbmVyLm9mZnNldCggdGhpcy5fcGxhY2VtZW50Q29vcmRzKCB0aGlzLl9kZXNpcmVkQ29vcmRzKCBvcGVuT3B0aW9ucyApICkgKTsKCX0sCgoJcmVwb3NpdGlvbjogZnVuY3Rpb24oIG9wZW5PcHRpb25zICkgewoJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQl0aGlzLl9yZXBvc2l0aW9uKCBvcGVuT3B0aW9ucyApOwoJCX0KCX0sCgoJX29wZW5QcmVyZXF1aXNpdGVzQ29tcGxldGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICk7CgoJCXRoaXMuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQl0aGlzLl9pc09wZW4gPSB0cnVlOwoJCXRoaXMuX3Jlc2l6ZVNjcmVlbigpOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKS5mb2N1cygpOwoJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCWlmICggaWQgKSB7CgkJCXRoaXMuZG9jdW1lbnQuZmluZCggIlthcmlhLWhhc3BvcHVwPSd0cnVlJ11bYXJpYS1vd25zPSciICsgIGlkICsgIiddIiApLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgdHJ1ZSApOwoJCX0KCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJvcGVuIiApOwoJfSwKCglfb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIG9wZW5PcHRpb25zID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMgKSwKCQkJLy8gVE9ETyBtb3ZlIGJsYWNrbGlzdCB0byBwcml2YXRlIG1ldGhvZAoJCQlhbmRyb2lkQmxhY2tsaXN0ID0gKCBmdW5jdGlvbigpIHsKCQkJCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTlcLl0rKS8gKSwKCQkJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQkJCWFuZHJvaWRtYXRjaCA9IHVhLm1hdGNoKCAvQW5kcm9pZCAoXGQrKD86XC5cZCspKS8gKSwKCQkJCQlhbmR2ZXJzaW9uID0gISFhbmRyb2lkbWF0Y2ggJiYgYW5kcm9pZG1hdGNoWyAxIF0sCgkJCQkJY2hyb21lbWF0Y2ggPSB1YS5pbmRleE9mKCAiQ2hyb21lIiApID4gLTE7CgoJCQkJLy8gUGxhdGZvcm0gaXMgQW5kcm9pZCwgV2ViS2l0IHZlcnNpb24gaXMgZ3JlYXRlciB0aGFuIDUzNC4xMyAoIEFuZHJvaWQgMy4yLjEgKSBhbmQgbm90IENocm9tZS4KCQkJCWlmICggYW5kcm9pZG1hdGNoICE9PSBudWxsICYmIGFuZHZlcnNpb24gPT09ICI0LjAiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPiA1MzQuMTMgJiYgIWNocm9tZW1hdGNoICkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9KCkpOwoKCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJvcGVuIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJdGhpcy5fY3JlYXRlUHJlcmVxdWlzaXRlcygKCQkJJC5ub29wLAoJCQkkLm5vb3AsCgkJCSQucHJveHkoIHRoaXMsICJfb3BlblByZXJlcXVpc2l0ZXNDb21wbGV0ZSIgKSApOwoKCQl0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiA9IG9wZW5PcHRpb25zLnRyYW5zaXRpb247CgkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBvcGVuT3B0aW9ucy50cmFuc2l0aW9uICk7CgoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtdHJ1bmNhdGUiICk7CgoJCS8vIEdpdmUgYXBwbGljYXRpb25zIGEgY2hhbmNlIHRvIG1vZGlmeSB0aGUgY29udGVudHMgb2YgdGhlIGNvbnRhaW5lciBiZWZvcmUgaXQgYXBwZWFycwoJCXRoaXMuX3JlcG9zaXRpb24oIG9wZW5PcHRpb25zICk7CgoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICYmIGFuZHJvaWRCbGFja2xpc3QgKSB7CgkJCS8qIFRPRE86IFRoZSBuYXRpdmUgYnJvd3NlciBvbiBBbmRyb2lkIDQuMC5YICgiSWNlIENyZWFtIFNhbmR3aWNoIikgc3VmZmVycyBmcm9tIGFuIGlzc3VlIHdoZXJlIHRoZSBwb3B1cCBvdmVybGF5IGFwcGVhcnMgdG8gYmUgei1pbmRleGVkIGFib3ZlIHRoZSBwb3B1cCBpdHNlbGYgd2hlbiBjZXJ0YWluIG90aGVyIHN0eWxlcyBleGlzdCBvbiB0aGUgc2FtZSBwYWdlIC0tIG5hbWVseSwgYW55IGVsZW1lbnQgc2V0IHRvIGBwb3NpdGlvbjogZml4ZWRgIGFuZCBjZXJ0YWluIHR5cGVzIG9mIGlucHV0LiBUaGVzZSBpc3N1ZXMgYXJlIHJlbWluaXNjZW50IG9mIHByZXZpb3VzbHkgdW5jb3ZlcmVkIGJ1Z3MgaW4gb2xkZXIgdmVyc2lvbnMgb2YgQW5kcm9pZCdzIG5hdGl2ZSBicm93c2VyOiBodHRwczovL2dpdGh1Yi5jb20vc2NvdHRqZWhsL0RldmljZS1CdWdzL2lzc3Vlcy8zCgkJCVRoaXMgZml4IGNsb3NlcyB0aGUgZm9sbG93aW5nIGJ1Z3MgKCBJIHVzZSAiY2xvc2VzIiB3aXRoIHJlbHVjdGFuY2UsIGFuZCBzdHJlc3MgdGhhdCB0aGlzIGlzc3VlIHNob3VsZCBiZSByZXZpc2l0ZWQgYXMgc29vbiBhcyBwb3NzaWJsZSApOgoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4MTYKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODQ0CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg3NAoJCQkqLwoKCQkJLy8gVE9ETyBzb3J0IG91dCB3aHkgdGhpcy5fcGFnZSBpc24ndCB3b3JraW5nCgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoJCX0KCQl0aGlzLl9hbmltYXRlKHsKCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogb3Blbk9wdGlvbnMudHJhbnNpdGlvbiwKCQkJY2xhc3NUb1JlbW92ZTogIiIsCgkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJpbiIsCgkJCWNvbnRhaW5lckNsYXNzVG9BZGQ6ICJpbiIsCgkJCWFwcGx5VHJhbnNpdGlvbjogZmFsc2UsCgkJCXByZXJlcXVpc2l0ZXM6IHRoaXMuX3ByZXJlcXVpc2l0ZXMKCQl9KTsKCX0sCgoJX2Nsb3NlUHJlcmVxdWlzaXRlU2NyZWVuOiBmdW5jdGlvbigpIHsKCQl0aGlzLl91aS5zY3JlZW4KCQkJLnJlbW92ZUNsYXNzKCAib3V0IiApCgkJCS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7Cgl9LAoKCV9jbG9zZVByZXJlcXVpc2l0ZUNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyCgkJCS5yZW1vdmVDbGFzcyggInJldmVyc2Ugb3V0IiApCgkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKQoJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJfSwKCglfY2xvc2VQcmVyZXF1aXNpdGVzRG9uZTogZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnRhaW5lciA9IHRoaXMuX3VpLmNvbnRhaW5lciwKCQkJaWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApOwoKCQljb250YWluZXIucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoKCQkvLyByZW1vdmUgdGhlIGdsb2JhbCBtdXRleCBmb3IgcG9wdXBzCgkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdW5kZWZpbmVkOwoKCQkvLyBCbHVyIGVsZW1lbnRzIGluc2lkZSB0aGUgY29udGFpbmVyLCBpbmNsdWRpbmcgdGhlIGNvbnRhaW5lcgoJCSQoICI6Zm9jdXMiLCBjb250YWluZXJbIDAgXSApLmFkZCggY29udGFpbmVyWyAwIF0gKS5ibHVyKCk7CgoJCWlmICggaWQgKSB7CgkJCXRoaXMuZG9jdW1lbnQuZmluZCggIlthcmlhLWhhc3BvcHVwPSd0cnVlJ11bYXJpYS1vd25zPSciICsgIGlkICsgIiddIiApLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQl9CgoJCS8vIGFsZXJ0IHVzZXJzIHRoYXQgdGhlIHBvcHVwIGlzIGNsb3NlZAoJCXRoaXMuX3RyaWdnZXIoICJhZnRlcmNsb3NlIiApOwoJfSwKCglfY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoKCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsKCgkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyY2xvc2UiIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IHJldmVyc2UgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCXRoaXMuX2NyZWF0ZVByZXJlcXVpc2l0ZXMoCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXF1aXNpdGVTY3JlZW4iICksCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXF1aXNpdGVDb250YWluZXIiICksCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXF1aXNpdGVzRG9uZSIgKSApOwoKCQl0aGlzLl9hbmltYXRlKCB7CgkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRoaXMuX3VpLnNjcmVlbi5oYXNDbGFzcyggImluIiApLAoJCQl0cmFuc2l0aW9uOiAoIGltbWVkaWF0ZSA/ICJub25lIiA6ICggdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSApLAoJCQljbGFzc1RvUmVtb3ZlOiAiaW4iLAoJCQlzY3JlZW5DbGFzc1RvQWRkOiAib3V0IiwKCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogInJldmVyc2Ugb3V0IiwKCQkJYXBwbHlUcmFuc2l0aW9uOiB0cnVlLAoJCQlwcmVyZXF1aXNpdGVzOiB0aGlzLl9wcmVyZXF1aXNpdGVzCgkJfSk7Cgl9LAoKCV91bmVuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBQdXQgdGhlIGVsZW1lbnQgYmFjayB0byB3aGVyZSB0aGUgcGxhY2Vob2xkZXIgd2FzIGFuZCByZW1vdmUgdGhlICJ1aS1wb3B1cCIgY2xhc3MKCQl0aGlzLl9zZXRPcHRpb25zKCB7IHRoZW1lOiAkLm1vYmlsZS5wb3B1cC5wcm90b3R5cGUub3B0aW9ucy50aGVtZSB9ICk7CgkJdGhpcy5lbGVtZW50CgkJCS8vIENhbm5vdCBkaXJlY3RseSBpbnNlcnRBZnRlcigpIC0gd2UgbmVlZCB0byBkZXRhY2goKSBmaXJzdCwgYmVjYXVzZQoJCQkvLyBpbnNlcnRBZnRlcigpIHdpbGwgZG8gbm90aGluZyBpZiB0aGUgcGF5bG9hZCBkaXYgd2FzIG5vdCBhdHRhY2hlZAoJCQkvLyB0byB0aGUgRE9NIGF0IHRoZSB0aW1lIHRoZSB3aWRnZXQgd2FzIGNyZWF0ZWQsIGFuZCBzbyB0aGUgcGF5bG9hZAoJCQkvLyB3aWxsIHJlbWFpbiBpbnNpZGUgdGhlIGNvbnRhaW5lciBldmVuIGFmdGVyIHdlIGNhbGwgaW5zZXJ0QWZ0ZXIoKS4KCQkJLy8gSWYgdGhhdCBoYXBwZW5zIGFuZCB3ZSByZW1vdmUgdGhlIGNvbnRhaW5lciBhIGZldyBsaW5lcyBiZWxvdywgd2UKCQkJLy8gd2lsbCBjYXVzZSBhbiBpbmZpbml0ZSByZWN1cnNpb24gLSAjNTI0NAoJCQkuZGV0YWNoKCkKCQkJLmluc2VydEFmdGVyKCB0aGlzLl91aS5wbGFjZWhvbGRlciApCgkJCS5yZW1vdmVDbGFzcyggInVpLXBvcHVwIHVpLW92ZXJsYXktc2hhZG93IHVpLWNvcm5lci1hbGwgdWktYm9keS1pbmhlcml0IiApOwoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmUoKTsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlKCk7CgkJdGhpcy5fdWkucGxhY2Vob2xkZXIucmVtb3ZlKCk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9PT0gdGhpcyApIHsKCQkJdGhpcy5lbGVtZW50Lm9uZSggInBvcHVwYWZ0ZXJjbG9zZSIsICQucHJveHkoIHRoaXMsICJfdW5lbmhhbmNlIiApICk7CgkJCXRoaXMuY2xvc2UoKTsKCQl9IGVsc2UgewoJCQl0aGlzLl91bmVuaGFuY2UoKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglfY2xvc2VQb3B1cDogZnVuY3Rpb24oIHRoZUV2ZW50LCBkYXRhICkgewoJCXZhciBwYXJzZWREc3QsIHRvVXJsLAoJCQljdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJaW1tZWRpYXRlID0gZmFsc2U7CgoJCWlmICggKCB0aGVFdmVudCAmJiB0aGVFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHx8ICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gcmVzdG9yZSBsb2NhdGlvbiBvbiBzY3JlZW4KCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHRoaXMuX3Njcm9sbFRvcCApOwoKCQlpZiAoIHRoZUV2ZW50ICYmIHRoZUV2ZW50LnR5cGUgPT09ICJwYWdlYmVmb3JlY2hhbmdlIiAmJiBkYXRhICkgewoJCQkvLyBEZXRlcm1pbmUgd2hldGhlciB3ZSBuZWVkIHRvIHJhcGlkLWNsb3NlIHRoZSBwb3B1cCwgb3Igd2hldGhlciB3ZSBjYW4KCQkJLy8gdGFrZSB0aGUgdGltZSB0byBydW4gdGhlIGNsb3NpbmcgdHJhbnNpdGlvbgoJCQlpZiAoIHR5cGVvZiBkYXRhLnRvUGFnZSA9PT0gInN0cmluZyIgKSB7CgkJCQlwYXJzZWREc3QgPSBkYXRhLnRvUGFnZTsKCQkJfSBlbHNlIHsKCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCX0KCQkJcGFyc2VkRHN0ID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggcGFyc2VkRHN0ICk7CgkJCXRvVXJsID0gcGFyc2VkRHN0LnBhdGhuYW1lICsgcGFyc2VkRHN0LnNlYXJjaCArIHBhcnNlZERzdC5oYXNoOwoKCQkJaWYgKCB0aGlzLl9teVVybCAhPT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvVXJsICkgKSB7CgkJCQkvLyBHb2luZyB0byBhIGRpZmZlcmVudCBwYWdlIC0gY2xvc2UgaW1tZWRpYXRlbHkKCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCX0gZWxzZSB7CgkJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfQoKCQkvLyByZW1vdmUgbmF2IGJpbmRpbmdzCgkJdGhpcy53aW5kb3cub2ZmKCBjdXJyZW50T3B0aW9ucy5jbG9zZUV2ZW50cyApOwoJCS8vIHVuYmluZCBjbGljayBoYW5kbGVycyBhZGRlZCB3aGVuIGhpc3RvcnkgaXMgZGlzYWJsZWQKCQl0aGlzLmVsZW1lbnQudW5kZWxlZ2F0ZSggY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rU2VsZWN0b3IsIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua0V2ZW50cyApOwoKCQl0aGlzLl9jbG9zZSggaW1tZWRpYXRlICk7Cgl9LAoKCS8vIGFueSBuYXZpZ2F0aW9uIGV2ZW50IGFmdGVyIGEgcG9wdXAgaXMgb3BlbmVkIHNob3VsZCBjbG9zZSB0aGUgcG9wdXAKCS8vIE5PVEUgdGhlIHBhZ2ViZWZvcmVjaGFuZ2UgaXMgYm91bmQgdG8gY2F0Y2ggbmF2aWdhdGlvbiBldmVudHMgdGhhdCBkb24ndAoJLy8gICAgICBhbHRlciB0aGUgdXJsIChlZywgZGlhbG9ncyBmcm9tIHBvcHVwcykKCV9iaW5kQ29udGFpbmVyQ2xvc2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMud2luZG93CgkJCS5vbiggdGhpcy5vcHRpb25zLmNsb3NlRXZlbnRzLCAkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUG9wdXAiICkgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fdWkuY29udGFpbmVyOwoJfSwKCgkvLyBUT0RPIG5vIGNsZWFyIGRlbGluaWF0aW9uIG9mIHdoYXQgc2hvdWxkIGJlIGhlcmUgYW5kCgkvLyB3aGF0IHNob3VsZCBiZSBpbiBfb3Blbi4gU2VlbXMgdG8gYmUgInZpc3VhbCIgdnMgImhpc3RvcnkiIGZvciBub3cKCW9wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciB1cmwsIGhhc2hrZXksIGFjdGl2ZVBhZ2UsIGN1cnJlbnRJc0RpYWxvZywgaGFzSGFzaCwgdXJsSGlzdG9yeSwKCQkJc2VsZiA9IHRoaXMsCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQkvLyBtYWtlIHN1cmUgb3BlbiBpcyBpZGVtcG90ZW50CgkJaWYgKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgfHwgY3VycmVudE9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gc2V0IHRoZSBnbG9iYWwgcG9wdXAgbXV0ZXgKCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB0aGlzOwoJCXRoaXMuX3Njcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpOwoKCQkvLyBpZiBoaXN0b3J5IGFsdGVyYXRpb24gaXMgZGlzYWJsZWQgY2xvc2Ugb24gbmF2aWdhdGUgZXZlbnRzCgkJLy8gYW5kIGxlYXZlIHRoZSB1cmwgYXMgaXMKCQlpZiAoICEoIGN1cnJlbnRPcHRpb25zLmhpc3RvcnkgKSApIHsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCgkJCS8vIFdoZW4gaGlzdG95IGlzIGRpc2FibGVkIHdlIGhhdmUgdG8gZ3JhYiB0aGUgZGF0YS1yZWwKCQkJLy8gYmFjayBsaW5rIGNsaWNrcyBzbyB3ZSBjYW4gY2xvc2UgdGhlIHBvcHVwIGluc3RlYWQgb2YKCQkJLy8gcmVseWluZyBvbiBoaXN0b3J5IHRvIGRvIGl0IGZvciB1cwoJCQlzZWxmLmVsZW1lbnQKCQkJCS5kZWxlZ2F0ZSggY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rU2VsZWN0b3IsIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua0V2ZW50cywgZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCS8vIGNhY2hlIHNvbWUgdmFsdWVzIGZvciBtaW4vcmVhZGFiaWxpdHkKCQl1cmxIaXN0b3J5ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeTsKCQloYXNoa2V5ID0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQlhY3RpdmVQYWdlID0gJC5tb2JpbGUuYWN0aXZlUGFnZTsKCQljdXJyZW50SXNEaWFsb2cgPSAoIGFjdGl2ZVBhZ2UgPyBhY3RpdmVQYWdlLmhhc0NsYXNzKCAidWktZGlhbG9nIiApIDogZmFsc2UgKTsKCQl0aGlzLl9teVVybCA9IHVybCA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCkudXJsOwoJCWhhc0hhc2ggPSAoIHVybC5pbmRleE9mKCBoYXNoa2V5ICkgPiAtMSApICYmICFjdXJyZW50SXNEaWFsb2cgJiYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApOwoKCQlpZiAoIGhhc0hhc2ggKSB7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gaWYgdGhlIGN1cnJlbnQgdXJsIGhhcyBubyBkaWFsb2cgaGFzaCBrZXkgcHJvY2VlZCBhcyBub3JtYWwKCQkvLyBvdGhlcndpc2UsIGlmIHRoZSBwYWdlIGlzIGEgZGlhbG9nIHNpbXBseSB0YWNrIG9uIHRoZSBoYXNoIGtleQoJCWlmICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA9PT0gLTEgJiYgIWN1cnJlbnRJc0RpYWxvZyApIHsKCQkJdXJsID0gdXJsICsgKHVybC5pbmRleE9mKCAiIyIgKSA+IC0xID8gaGFzaGtleSA6ICIjIiArIGhhc2hrZXkpOwoJCX0gZWxzZSB7CgkJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2ggKyBoYXNoa2V5OwoJCX0KCgkJLy8gc3dhbGxvdyB0aGUgdGhlIGluaXRpYWwgbmF2aWdhdGlvbiBldmVudCwgYW5kIGJpbmQgZm9yIHRoZSBuZXh0CgkJdGhpcy53aW5kb3cub25lKCAiYmVmb3JlbmF2aWdhdGUiLCBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJfSk7CgoJCXRoaXMudXJsQWx0ZXJlZCA9IHRydWU7CgkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwgeyByb2xlOiAiZGlhbG9nIiB9ICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oKSB7CgkJLy8gbWFrZSBzdXJlIGNsb3NlIGlzIGlkZW1wb3RlbnQKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl0aGlzLl9zY3JvbGxUb3AgPSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlzdG9yeSAmJiB0aGlzLnVybEFsdGVyZWQgKSB7CgkJCSQubW9iaWxlLmJhY2soKTsKCQkJdGhpcy51cmxBbHRlcmVkID0gZmFsc2U7CgkJfSBlbHNlIHsKCQkJLy8gc2ltdWxhdGUgdGhlIG5hdiBiaW5kaW5ncyBoYXZpbmcgZmlyZWQKCQkJdGhpcy5fY2xvc2VQb3B1cCgpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9Cn0pOwoKLy8gVE9ETyB0aGlzIGNhbiBiZSBtb3ZlZCBpbnNpZGUgdGhlIHdpZGdldAokLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rID0gZnVuY3Rpb24oICRsaW5rICkgewoJdmFyIG9mZnNldCwKCQlwYXRoID0gJC5tb2JpbGUucGF0aCwKCgkJLy8gTk9URSBtYWtlIHN1cmUgdG8gZ2V0IG9ubHkgdGhlIGhhc2ggZnJvbSB0aGUgaHJlZiBiZWNhdXNlIGllNyAod3A3KQoJCS8vICAgICAgcmV0dXJucyB0aGUgYWJzb2x1dGUgaHJlZiBpbiB0aGlzIGNhc2UgcnVpbmluZyB0aGUgZWxlbWVudCBzZWxlY3Rpb24KCQlwb3B1cCA9ICQoIHBhdGguaGFzaFRvU2VsZWN0b3IoIHBhdGgucGFyc2VVcmwoICRsaW5rLmF0dHIoICJocmVmIiApICkuaGFzaCApICkuZmlyc3QoKTsKCglpZiAoIHBvcHVwLmxlbmd0aCA+IDAgJiYgcG9wdXAuZGF0YSggIm1vYmlsZS1wb3B1cCIgKSApIHsKCQlvZmZzZXQgPSAkbGluay5vZmZzZXQoKTsKCQlwb3B1cC5wb3B1cCggIm9wZW4iLCB7CgkJCXg6IG9mZnNldC5sZWZ0ICsgJGxpbmsub3V0ZXJXaWR0aCgpIC8gMiwKCQkJeTogb2Zmc2V0LnRvcCArICRsaW5rLm91dGVySGVpZ2h0KCkgLyAyLAoJCQl0cmFuc2l0aW9uOiAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJcG9zaXRpb25UbzogJGxpbmsuanFtRGF0YSggInBvc2l0aW9uLXRvIiApCgkJfSk7Cgl9CgoJLy9yZW1vdmUgYWZ0ZXIgZGVsYXkKCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCSRsaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJfSwgMzAwICk7Cn07CgovLyBUT0RPIG1vdmUgaW5zaWRlIF9jcmVhdGUKJC5tb2JpbGUuZG9jdW1lbnQub24oICJwYWdlYmVmb3JlY2hhbmdlIiwgZnVuY3Rpb24oIHRoZUV2ZW50LCBkYXRhICkgewoJaWYgKCBkYXRhLm9wdGlvbnMucm9sZSA9PT0gInBvcHVwIiApIHsKCQkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rKCBkYXRhLm9wdGlvbnMubGluayApOwoJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdW5mb2N1c2FibGVJdGVtU2VsZWN0b3IgPSAiLnVpLWRpc2FibGVkLC51aS1zdGF0ZS1kaXNhYmxlZCwudWktbGktZGl2aWRlciwudWktc2NyZWVuLWhpZGRlbiw6anFtRGF0YShyb2xlPSdwbGFjZWhvbGRlcicpIiwKCWdvVG9BZGphY2VudEl0ZW0gPSBmdW5jdGlvbiggaXRlbSwgdGFyZ2V0LCBkaXJlY3Rpb24gKSB7CgkJdmFyIGFkamFjZW50ID0gaXRlbVsgZGlyZWN0aW9uICsgIkFsbCIgXSgpCgkJCS5ub3QoIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICkKCQkJLmZpcnN0KCk7CgoJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJaWYgKCBhZGphY2VudC5sZW5ndGggKSB7CgkJCXRhcmdldAoJCQkJLmJsdXIoKQoJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCWFkamFjZW50LmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQl9Cgl9OwoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLnNlbGVjdG1lbnUsIHsKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBDdXN0b20gc2VsZWN0cyBjYW5ub3QgZXhpc3QgaW5zaWRlIHBvcHVwcywgc28gcmV2ZXJ0IHRoZSAibmF0aXZlTWVudSIKCQkvLyBvcHRpb24gdG8gdHJ1ZSBpZiBhIHBhcmVudCBpcyBhIHBvcHVwCgkJby5uYXRpdmVNZW51ID0gby5uYXRpdmVNZW51IHx8ICggdGhpcy5lbGVtZW50LnBhcmVudHMoICI6anFtRGF0YShyb2xlPSdwb3B1cCcpLDptb2JpbGUtcG9wdXAiICkubGVuZ3RoID4gMCApOwoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0sCgoJX2hhbmRsZVNlbGVjdEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYmx1cigpOwoJCXRoaXMuYnV0dG9uLmZvY3VzKCk7Cgl9LAoKCV9oYW5kbGVLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5fc3VwZXIoIGV2ZW50ICk7CgkJdGhpcy5faGFuZGxlQnV0dG9uVmNsaWNrS2V5ZG93biggZXZlbnQgKTsKCX0sCgoJX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmlzT3BlbiB8fCB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siIHx8CgkJCQlldmVudC5rZXlDb2RlICYmIChldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8IGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuU1BBQ0UpKSB7CgoJCQl0aGlzLl9kZWNpZGVGb3JtYXQoKTsKCQkJaWYgKCB0aGlzLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCQl0aGlzLmJ1dHRvbi5hdHRyKCAiaHJlZiIsICIjIiArIHRoaXMucG9wdXBJZCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgInBvcHVwIiApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyB0aGlzLmRpYWxvZ0lkICkuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJyZWwiLCAiZGlhbG9nIiApOwoJCQl9CgkJCXRoaXMuaXNPcGVuID0gdHJ1ZTsKCQkJLy8gRG8gbm90IHByZXZlbnQgZGVmYXVsdCwgc28gdGhlIG5hdmlnYXRpb24gbWF5IGhhdmUgYSBjaGFuY2UgdG8gYWN0dWFsbHkgb3BlbiB0aGUgY2hvc2VuIGZvcm1hdAoJCX0KCX0sCgoJX2hhbmRsZUxpc3RGb2N1czogZnVuY3Rpb24oIGUgKSB7CgkJdmFyIHBhcmFtcyA9ICggZS50eXBlID09PSAiZm9jdXNpbiIgKSA/CgkJCXsgdGFiaW5kZXg6ICIwIiwgZXZlbnQ6ICJ2bW91c2VvdmVyIiB9OgoJCQl7IHRhYmluZGV4OiAiLTEiLCBldmVudDogInZtb3VzZW91dCIgfTsKCgkJJCggZS50YXJnZXQgKQoJCQkuYXR0ciggInRhYmluZGV4IiwgcGFyYW1zLnRhYmluZGV4ICkKCQkJLnRyaWdnZXIoIHBhcmFtcy5ldmVudCApOwoJfSwKCglfaGFuZGxlTGlzdEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKTsKCgkJLy8gc3dpdGNoIGxvZ2ljIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCWNhc2UgMzg6CgkJCWdvVG9BZGphY2VudEl0ZW0oIGxpLCB0YXJnZXQsICJwcmV2IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJCS8vIGRvd24gb3IgcmlnaHQgYXJyb3cga2V5cwoJCWNhc2UgNDA6CgkJCWdvVG9BZGphY2VudEl0ZW0oIGxpLCB0YXJnZXQsICJuZXh0IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJCS8vIElmIGVudGVyIG9yIHNwYWNlIGlzIHByZXNzZWQsIHRyaWdnZXIgY2xpY2sKCQljYXNlIDEzOgoJCWNhc2UgMzI6CgkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9oYW5kbGVNZW51UGFnZUhpZGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBBZnRlciB0aGUgZGlhbG9nJ3MgZG9uZSwgd2UgbWF5IHdhbnQgdG8gdHJpZ2dlciBjaGFuZ2UgaWYgdGhlIHZhbHVlIGhhcyBhY3R1YWxseSBjaGFuZ2VkCgkJdGhpcy5fZGVsYXllZFRyaWdnZXIoKTsKCgkJLy8gVE9ETyBjZW50cmFsaXplIHBhZ2UgcmVtb3ZhbCBiaW5kaW5nIC8gaGFuZGxpbmcgaW4gdGhlIHBhZ2UgcGx1Z2luLgoJCS8vIFN1Z2dlc3Rpb24gZnJvbSBAamJsYXMgdG8gZG8gcmVmY291bnRpbmcKCQkvLwoJCS8vIFRPRE8gZXh0cmVtZWx5IGNvbmZ1c2luZyBkZXBlbmRlbmN5IG9uIHRoZSBvcGVuIG1ldGhvZCB3aGVyZSB0aGUgcGFnZWhpZGUucmVtb3ZlCgkJLy8gYmluZGluZ3MgYXJlIHN0cmlwcGVkIHRvIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gZGlzYXBwZWFyaW5nLiBUaGUgd2F5CgkJLy8gd2UncmUga2VlcGluZyBwYWdlcyBpbiB0aGUgRE9NIHJpZ2h0IG5vdyBzdWNrcwoJCS8vCgkJLy8gcmViaW5kIHRoZSBwYWdlIHJlbW92ZSB0aGF0IHdhcyB1bmJvdW5kIGluIHRoZSBvcGVuIGZ1bmN0aW9uCgkJLy8gdG8gYWxsb3cgZm9yIHRoZSBwYXJlbnQgcGFnZSByZW1vdmFsIGZyb20gYWN0aW9ucyBvdGhlciB0aGFuIHRoZSB1c2UKCQkvLyBvZiBhIGRpYWxvZyBzaXplZCBjdXN0b20gc2VsZWN0CgkJLy8KCQkvLyBkb2luZyB0aGlzIGhlcmUgcHJvdmlkZXMgZm9yIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgY3VzdG9tIHNlbGVjdCBkaWFsb2cKCQl0aGlzLnRoaXNQYWdlLnBhZ2UoICJiaW5kUmVtb3ZlIiApOwoJfSwKCglfaGFuZGxlSGVhZGVyQ2xvc2VDbGljazogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCXRoaXMuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJX2hhbmRsZUxpc3RJdGVtQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgbGlzdEl0ZW0gPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAibGkiICksCgoJCQkvLyBJbmRleCBvZiBvcHRpb24gdGFnIHRvIGJlIHNlbGVjdGVkCgkJCW9sZEluZGV4ID0gdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQluZXdJbmRleCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggbGlzdEl0ZW0sICJvcHRpb24taW5kZXgiICksCgkJCW9wdGlvbiA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkvLyBUb2dnbGUgc2VsZWN0ZWQgc3RhdHVzIG9uIHRoZSB0YWcgZm9yIG11bHRpIHNlbGVjdHMKCQlvcHRpb24uc2VsZWN0ZWQgPSB0aGlzLmlzTXVsdGlwbGUgPyAhb3B0aW9uLnNlbGVjdGVkIDogdHJ1ZTsKCgkJLy8gVG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCWxpc3RJdGVtLmZpbmQoICJhIiApCgkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jaGVja2JveC1vZmYiLCAhb3B0aW9uLnNlbGVjdGVkICk7CgkJfQoKCQkvLyBJZiBpdCdzIG5vdCBhIG11bHRpcGxlIHNlbGVjdCwgdHJpZ2dlciBjaGFuZ2UgYWZ0ZXIgaXQgaGFzIGZpbmlzaGVkIGNsb3NpbmcKCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgb2xkSW5kZXggIT09IG5ld0luZGV4ICkgewoJCQl0aGlzLl90cmlnZ2VyQ2hhbmdlID0gdHJ1ZTsKCQl9CgoJCS8vIFRyaWdnZXIgY2hhbmdlIGlmIGl0J3MgYSBtdWx0aXBsZSBzZWxlY3QKCQkvLyBIaWRlIGN1c3RvbSBzZWxlY3QgZm9yIHNpbmdsZSBzZWxlY3RzIG9ubHkgLSBvdGhlcndpc2UgZm9jdXMgY2xpY2tlZCBpdGVtCgkJLy8gV2UgbmVlZCB0byBncmFiIHRoZSBjbGlja2VkIGl0ZW0gdGhlIGhhcmQgd2F5LCBiZWNhdXNlIHRoZSBsaXN0IG1heSBoYXZlIGJlZW4gcmVidWlsdAoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLnNlbGVjdC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl0aGlzLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuZXEoIG5ld0luZGV4ICkKCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJfQoJCWVsc2UgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoKCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdElkLCBwb3B1cElkLCBkaWFsb2dJZCwgbGFiZWwsIHRoaXNQYWdlLCBpc011bHRpcGxlLCBtZW51SWQsCgkJCXRoZW1lQXR0ciwgb3ZlcmxheVRoZW1lLCBvdmVybGF5VGhlbWVBdHRyLCBkaXZpZGVyVGhlbWVBdHRyLAoJCQltZW51UGFnZSwgbGlzdGJveCwgbGlzdCwgaGVhZGVyLCBoZWFkZXJUaXRsZSwgbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlLCBoZWFkZXJDbG9zZSwKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvLm5hdGl2ZU1lbnUgKSB7CgkJCXJldHVybiB0aGlzLl9zdXBlcigpOwoJCX0KCgkJc2VsZWN0SWQgPSB0aGlzLnNlbGVjdElkOwoJCXBvcHVwSWQgPSBzZWxlY3RJZCArICItbGlzdGJveCI7CgkJZGlhbG9nSWQgPSBzZWxlY3RJZCArICItZGlhbG9nIjsKCQlsYWJlbCA9IHRoaXMubGFiZWw7CgkJdGhpc1BhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCWlzTXVsdGlwbGUgPSB0aGlzLmVsZW1lbnRbIDAgXS5tdWx0aXBsZTsKCQltZW51SWQgPSBzZWxlY3RJZCArICItbWVudSI7CgkJdGhlbWVBdHRyID0gby50aGVtZSA/ICggIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZT0nIiArIG8udGhlbWUgKyAiJyIgKSA6ICIiOwoJCW92ZXJsYXlUaGVtZSA9IG8ub3ZlcmxheVRoZW1lIHx8IG8udGhlbWUgfHwgbnVsbDsKCQlvdmVybGF5VGhlbWVBdHRyID0gb3ZlcmxheVRoZW1lID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsKCQkJIm92ZXJsYXktdGhlbWU9JyIgKyBvdmVybGF5VGhlbWUgKyAiJyIgKSA6ICIiOwoJCWRpdmlkZXJUaGVtZUF0dHIgPSAoIG8uZGl2aWRlclRoZW1lICYmIGlzTXVsdGlwbGUgKSA/ICggIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXZpZGVyLXRoZW1lPSciICsgby5kaXZpZGVyVGhlbWUgKyAiJyIgKSA6ICIiOwoJCW1lbnVQYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nZGlhbG9nJyBjbGFzcz0ndWktc2VsZWN0bWVudScgaWQ9JyIgKyBkaWFsb2dJZCArICInIiArIHRoZW1lQXR0ciArIG92ZXJsYXlUaGVtZUF0dHIgKyAiPiIgKwoJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkiPGRpdiBjbGFzcz0ndWktdGl0bGUnPjwvZGl2PiIrCgkJCSI8L2Rpdj4iKwoJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkiPC9kaXY+IiApOwoJCWxpc3Rib3ggPSAkKCAiPGRpdiIgKyB0aGVtZUF0dHIgKyBvdmVybGF5VGhlbWVBdHRyICsgIiBpZD0nIiArIHBvcHVwSWQgKwoJCQkJIicgY2xhc3M9J3VpLXNlbGVjdG1lbnUnPjwvZGl2PiIgKQoJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuc2VsZWN0ICkKCQkJLnBvcHVwKCk7CgkJbGlzdCA9ICQoICI8dWwgY2xhc3M9J3VpLXNlbGVjdG1lbnUtbGlzdCcgaWQ9JyIgKyBtZW51SWQgKyAiJyByb2xlPSdsaXN0Ym94JyBhcmlhLWxhYmVsbGVkYnk9JyIgKyB0aGlzLmJ1dHRvbklkICsgIiciICsgdGhlbWVBdHRyICsgZGl2aWRlclRoZW1lQXR0ciArICI+PC91bD4iICkuYXBwZW5kVG8oIGxpc3Rib3ggKTsKCQloZWFkZXIgPSAkKCAiPGRpdiBjbGFzcz0ndWktaGVhZGVyIHVpLWJhci0iICsgKCBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IiApICsgIic+PC9kaXY+IiApLnByZXBlbmRUbyggbGlzdGJveCApOwoJCWhlYWRlclRpdGxlID0gJCggIjxoMSBjbGFzcz0ndWktdGl0bGUnPjwvaDE+IiApLmFwcGVuZFRvKCBoZWFkZXIgKTsKCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkidGV4dCI6IG8uY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuIHVpLWNvcm5lci1hbGwgdWktYnRuLWxlZnQgdWktYnRuLWljb24tbm90ZXh0IHVpLWljb24tZGVsZXRlIgoJCQl9KS5hcHBlbmRUbyggaGVhZGVyICk7CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzZWxlY3RJZDogc2VsZWN0SWQsCgkJCW1lbnVJZDogbWVudUlkLAoJCQlwb3B1cElkOiBwb3B1cElkLAoJCQlkaWFsb2dJZDogZGlhbG9nSWQsCgkJCXRoaXNQYWdlOiB0aGlzUGFnZSwKCQkJbWVudVBhZ2U6IG1lbnVQYWdlLAoJCQlsYWJlbDogbGFiZWwsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiBvLnRoZW1lLAoJCQlsaXN0Ym94OiBsaXN0Ym94LAoJCQlsaXN0OiBsaXN0LAoJCQloZWFkZXI6IGhlYWRlciwKCQkJaGVhZGVyVGl0bGU6IGhlYWRlclRpdGxlLAoJCQloZWFkZXJDbG9zZTogaGVhZGVyQ2xvc2UsCgkJCW1lbnVQYWdlQ29udGVudDogbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlOiBtZW51UGFnZUNsb3NlLAoJCQlwbGFjZWhvbGRlcjogIiIKCQl9KTsKCgkJLy8gQ3JlYXRlIGxpc3QgZnJvbSBzZWxlY3QsIHVwZGF0ZSBzdGF0ZQoJCXRoaXMucmVmcmVzaCgpOwoKCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkICkgewoJCQkvLyBNYXAgdW5kZWZpbmVkIHRvIGZhbHNlLCBiZWNhdXNlIHRoaXMuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkCgkJCS8vIGluZGljYXRlcyB0aGF0IHdlIGhhdmUgbm90IHlldCBjaGVja2VkIHdoZXRoZXIgdGhlIHNlbGVjdCBoYXMKCQkJLy8gb3JpZ2luYWxseSBoYWQgYSB0YWJpbmRleCBhdHRyaWJ1dGUsIHdoZXJlYXMgZmFsc2UgaW5kaWNhdGVzIHRoYXQKCQkJLy8gd2UgaGF2ZSBjaGVja2VkIHRoZSBzZWxlY3QgZm9yIHN1Y2ggYW4gYXR0cmlidXRlLCBhbmQgaGF2ZSBmb3VuZAoJCQkvLyBub25lIHByZXNlbnQuCgkJCXRoaXMuX29yaWdUYWJJbmRleCA9ICggdGhpcy5zZWxlY3RbIDAgXS5nZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIgKSA9PT0gbnVsbCApID8gZmFsc2UgOiB0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiICk7CgkJfQoJCXRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCQl0aGlzLl9vbiggdGhpcy5zZWxlY3QsIHsgZm9jdXMgOiAiX2hhbmRsZVNlbGVjdEZvY3VzIiB9ICk7CgoJCS8vIEJ1dHRvbiBldmVudHMKCQl0aGlzLl9vbiggdGhpcy5idXR0b24sIHsKCQkJdmNsaWNrOiAiX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd24iCgkJfSk7CgoJCS8vIEV2ZW50cyBmb3IgbGlzdCBpdGVtcwoJCXRoaXMubGlzdC5hdHRyKCAicm9sZSIsICJsaXN0Ym94IiApOwoJCXRoaXMuX29uKCB0aGlzLmxpc3QsIHsKCQkJImZvY3VzaW4iOiAiX2hhbmRsZUxpc3RGb2N1cyIsCgkJCSJmb2N1c291dCI6ICJfaGFuZGxlTGlzdEZvY3VzIiwKCQkJImtleWRvd24iOiAiX2hhbmRsZUxpc3RLZXlkb3duIiwKCQkJImNsaWNrIGxpOm5vdCgudWktZGlzYWJsZWQsLnVpLXN0YXRlLWRpc2FibGVkLC51aS1saS1kaXZpZGVyKSI6ICJfaGFuZGxlTGlzdEl0ZW1DbGljayIKCQl9KTsKCgkJLy8gYnV0dG9uIHJlZm9jdXMgZW5zdXJlcyBwcm9wZXIgaGVpZ2h0IGNhbGN1bGF0aW9uCgkJLy8gYnkgcmVtb3ZpbmcgdGhlIGlubGluZSBzdHlsZSBhbmQgZW5zdXJpbmcgcGFnZSBpbmNsdXNpb24KCQl0aGlzLl9vbiggdGhpcy5tZW51UGFnZSwgeyBwYWdlaGlkZTogIl9oYW5kbGVNZW51UGFnZUhpZGUiIH0gKTsKCgkJLy8gRXZlbnRzIG9uIHRoZSBwb3B1cAoJCXRoaXMuX29uKCB0aGlzLmxpc3Rib3gsIHsgcG9wdXBhZnRlcmNsb3NlOiAiX3BvcHVwQ2xvc2VkIiB9ICk7CgoJCS8vIENsb3NlIGJ1dHRvbiBvbiBzbWFsbCBvdmVybGF5cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLl9vbiggdGhpcy5oZWFkZXJDbG9zZSwgeyBjbGljazogIl9oYW5kbGVIZWFkZXJDbG9zZUNsaWNrIiB9ICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX3BvcHVwQ2xvc2VkOiBmdW5jdGlvbigpIHsKCQl0aGlzLmNsb3NlKCk7CgkJdGhpcy5fZGVsYXllZFRyaWdnZXIoKTsKCX0sCgoJX2RlbGF5ZWRUcmlnZ2VyOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX3RyaWdnZXJDaGFuZ2UgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCX0KCQl0aGlzLl90cmlnZ2VyQ2hhbmdlID0gZmFsc2U7Cgl9LAoKCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoKCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJfSwKCglzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQ6bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkiICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQl2YXIgc2VsZiwgaW5kaWNlczsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBmb3JjZSApOwoJCX0KCgkJc2VsZiA9IHRoaXM7CgkJaWYgKCBmb3JjZSB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQlzZWxmLl9idWlsZExpc3QoKTsKCQl9CgoJCWluZGljZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkuZmluZCggImEiICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZW5kKCkKCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNlcyApID4gLTEgKSB7CgkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQlpdGVtLmZpbmQoICJhIiApLnJlbW92ZUNsYXNzKCAidWktY2hlY2tib3gtb2ZmIiApLmFkZENsYXNzKCAidWktY2hlY2tib3gtb24iICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJaWYgKCBpdGVtLmhhc0NsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKSApIHsKCQkJCQkJCWl0ZW0ubmV4dCgpLmZpbmQoICJhIiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJaXRlbS5maW5kKCAiYSIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSk7Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhdGhpcy5pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBzZWxmID0gdGhpczsKCgkJaWYgKCBzZWxmLm1lbnVUeXBlID09PSAicGFnZSIgKSB7CgkJCXNlbGYubWVudVBhZ2UuZGlhbG9nKCAiY2xvc2UiICk7CgkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5saXN0Ym94LnBvcHVwKCAiY2xvc2UiICk7CgkJfQoKCQlzZWxmLl9mb2N1c0J1dHRvbigpOwoJCS8vIGFsbG93IHRoZSBkaWFsb2cgdG8gYmUgY2xvc2VkIGFnYWluCgkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCX0sCgoJb3BlbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5idXR0b24uY2xpY2soKTsKCX0sCgoJX2ZvY3VzTWVudUl0ZW06IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RvciA9IHRoaXMubGlzdC5maW5kKCAiYS4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQlpZiAoIHNlbGVjdG9yLmxlbmd0aCA9PT0gMCApIHsKCQkJc2VsZWN0b3IgPSB0aGlzLmxpc3QuZmluZCggImxpOm5vdCgiICsgdW5mb2N1c2FibGVJdGVtU2VsZWN0b3IgKyAiKSBhLnVpLWJ0biIgKTsKCQl9CgkJc2VsZWN0b3IuZmlyc3QoKS5mb2N1cygpOwoJfSwKCglfZGVjaWRlRm9ybWF0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCSR3aW5kb3cgPSB0aGlzLndpbmRvdywKCQkJc2VsZkxpc3RQYXJlbnQgPSBzZWxmLmxpc3QucGFyZW50KCksCgkJCW1lbnVIZWlnaHQgPSBzZWxmTGlzdFBhcmVudC5vdXRlckhlaWdodCgpLAoJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQlidG5PZmZzZXQgPSBzZWxmLmJ1dHRvbi5vZmZzZXQoKS50b3AsCgkJCXNjcmVlbkhlaWdodCA9ICR3aW5kb3cuaGVpZ2h0KCk7CgoJCWlmICggbWVudUhlaWdodCA+IHNjcmVlbkhlaWdodCAtIDgwIHx8ICEkLnN1cHBvcnQuc2Nyb2xsVG9wICkgewoKCQkJc2VsZi5tZW51UGFnZS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApLnBhZ2UoKTsKCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQgPSBzZWxmLm1lbnVQYWdlLmZpbmQoICIudWktY29udGVudCIgKTsKCQkJc2VsZi5tZW51UGFnZUNsb3NlID0gc2VsZi5tZW51UGFnZS5maW5kKCAiLnVpLWhlYWRlciBhIiApOwoKCQkJLy8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBiZWluZyByZW1vdmVkIGZyb20gdGhlIERPTSwKCQkJLy8gb3RoZXJ3aXNlIHRoZSByZXN1bHRzIG9mIHNlbGVjdGluZyBhIGxpc3QgaXRlbSBpbiB0aGUgZGlhbG9nCgkJCS8vIGZhbGwgaW50byBhIGJsYWNrIGhvbGUKCQkJc2VsZi50aGlzUGFnZS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICk7CgoJCQkvL2ZvciBXZWJPUy9PcGVyYSBNaW5pIChzZXQgbGFzdHNjcm9sbCB1c2luZyBidXR0b24gb2Zmc2V0KQoJCQlpZiAoIHNjcm9sbFRvcCA9PT0gMCAmJiBidG5PZmZzZXQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQlzZWxmLnRoaXNQYWdlLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJJCggdGhpcyApLmpxbURhdGEoICJsYXN0U2Nyb2xsIiwgYnRuT2Zmc2V0ICk7CgkJCQl9KTsKCQkJfQoKCQkJc2VsZi5tZW51UGFnZS5vbmUoIHsKCQkJCXBhZ2VzaG93OiAkLnByb3h5KCB0aGlzLCAiX2ZvY3VzTWVudUl0ZW0iICksCgkJCQlwYWdlaGlkZTogJC5wcm94eSggdGhpcywgImNsb3NlIiApCgkJCX0pOwoKCQkJc2VsZi5tZW51VHlwZSA9ICJwYWdlIjsKCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQuYXBwZW5kKCBzZWxmLmxpc3QgKTsKCQkJc2VsZi5tZW51UGFnZQoJCQkJLmZpbmQoICJkaXYgLnVpLXRpdGxlIiApCgkJCQkJLnRleHQoIHNlbGYubGFiZWwuZ2V0RW5jb2RlZFRleHQoKSB8fCBzZWxmLnBsYWNlaG9sZGVyICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5tZW51VHlwZSA9ICJvdmVybGF5IjsKCgkJCXNlbGYubGlzdGJveC5vbmUoIHsgcG9wdXBhZnRlcm9wZW46ICQucHJveHkoIHRoaXMsICJfZm9jdXNNZW51SXRlbSIgKSB9ICk7CgkJfQoJfSwKCglfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJbmVlZFBsYWNlaG9sZGVyID0gdHJ1ZSwKCQkJZGF0YUljb24gPSAiZmFsc2UiLAoJCQkkb3B0aW9ucywgbnVtT3B0aW9ucywgc2VsZWN0LAoJCQlkYXRhUHJlZml4ID0gImRhdGEtIiArICQubW9iaWxlLm5zLAoJCQlkYXRhSW5kZXhBdHRyID0gZGF0YVByZWZpeCArICJvcHRpb24taW5kZXgiLAoJCQlkYXRhSWNvbkF0dHIgPSBkYXRhUHJlZml4ICsgImljb24iLAoJCQlkYXRhUm9sZUF0dHIgPSBkYXRhUHJlZml4ICsgInJvbGUiLAoJCQlkYXRhUGxhY2Vob2xkZXJBdHRyID0gZGF0YVByZWZpeCArICJwbGFjZWhvbGRlciIsCgkJCWZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCQlpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlLAoJCQlvcHRHcm91cCwKCQkJaSwKCQkJb3B0aW9uLCAkb3B0aW9uLCBwYXJlbnQsIHRleHQsIGFuY2hvciwgY2xhc3NlcywKCQkJb3B0TGFiZWwsIGRpdmlkZXIsIGl0ZW07CgoJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgkJJG9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCk7CgkJbnVtT3B0aW9ucyA9ICRvcHRpb25zLmxlbmd0aDsKCQlzZWxlY3QgPSB0aGlzLnNlbGVjdFsgMCBdOwoKCQlmb3IgKCBpID0gMDsgaSA8IG51bU9wdGlvbnM7aSsrLCBpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlKSB7CgkJCW9wdGlvbiA9ICRvcHRpb25zW2ldOwoJCQkkb3B0aW9uID0gJCggb3B0aW9uICk7CgoJCQkvLyBEbyBub3QgY3JlYXRlIG9wdGlvbnMgYmFzZWQgb24gdWktc2NyZWVuLWhpZGRlbiBzZWxlY3Qgb3B0aW9ucwoJCQlpZiAoICRvcHRpb24uaGFzQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCXBhcmVudCA9IG9wdGlvbi5wYXJlbnROb2RlOwoJCQljbGFzc2VzID0gW107CgoJCQkvLyBBbHRob3VnaCB1c2luZyAudGV4dCgpIGhlcmUgcmFpc2VzIHRoZSByaXNrIHRoYXQsIHdoZW4gd2UgbGF0ZXIgcGFzdGUgdGhpcyBpbnRvIHRoZQoJCQkvLyBsaXN0IGl0ZW0gd2UgZW5kIHVwIHBhc3RpbmcgcG9zc2libHkgbWFsaWNpb3VzIHRoaW5ncyBsaWtlIDxzY3JpcHQ+IHRhZ3MsIHRoYXQgcmlzawoJCQkvLyBvbmx5IGFyaXNlcyBpZiB3ZSBkbyBzb21ldGhpbmcgbGlrZSAkKCAiPGxpPjxhIGhyZWY9JyMnPiIgKyB0ZXh0ICsgIjwvYT48L2xpPiIgKS4gV2UKCQkJLy8gZG9uJ3QgZG8gdGhhdC4gV2UgZG8gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHRleHQgKSBpbnN0ZWFkLCB3aGljaCBndWFyYW50ZWVzIHRoYXQKCQkJLy8gd2hhdGV2ZXIgd2UgcGFzdGUgaW4gd2lsbCBlbmQgdXAgYXMgdGV4dCwgd2l0aCBjaGFyYWN0ZXJzIGxpa2UgPCwgPiBhbmQgJiBlc2NhcGVkLgoJCQl0ZXh0ID0gJG9wdGlvbi50ZXh0KCk7CgkJCWFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOwoJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAiaHJlZiIsICIjIiApOwoJCQlhbmNob3IuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCB0ZXh0ICkgKTsKCgkJCS8vIEFyZSB3ZSBpbnNpZGUgYW4gb3B0Z3JvdXA/CgkJCWlmICggcGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIgKSB7CgkJCQlvcHRMYWJlbCA9IHBhcmVudC5nZXRBdHRyaWJ1dGUoICJsYWJlbCIgKTsKCQkJCWlmICggb3B0TGFiZWwgIT09IG9wdEdyb3VwICkgewoJCQkJCWRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoIGRhdGFSb2xlQXR0ciwgImxpc3QtZGl2aWRlciIgKTsKCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggInJvbGUiLCAib3B0aW9uIiApOwoJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdExhYmVsICkgKTsKCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2aWRlciApOwoJCQkJCW9wdEdyb3VwID0gb3B0TGFiZWw7CgkJCQl9CgkJCX0KCgkJCWlmICggbmVlZFBsYWNlaG9sZGVyICYmICggIW9wdGlvbi5nZXRBdHRyaWJ1dGUoICJ2YWx1ZSIgKSB8fCB0ZXh0Lmxlbmd0aCA9PT0gMCB8fCAkb3B0aW9uLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSApICkgewoJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IHRydWU7CgoJCQkJLy8gSWYgd2UgaGF2ZSBpZGVudGlmaWVkIGEgcGxhY2Vob2xkZXIsIHJlY29yZCB0aGUgZmFjdCB0aGF0IGl0IHdhcwoJCQkJLy8gdXMgd2hvIGhhdmUgYWRkZWQgdGhlIHBsYWNlaG9sZGVyIHRvIHRoZSBvcHRpb24gYW5kIG1hcmsgaXQKCQkJCS8vIHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQlpZiAoIG51bGwgPT09IG9wdGlvbi5nZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIgKSApIHsKCQkJCQl0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgPSB0cnVlOwoJCQkJfQoJCQkJb3B0aW9uLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJfQoJCQkJaWYgKCBwbGFjZWhvbGRlciAhPT0gdGV4dCApIHsKCQkJCQlwbGFjZWhvbGRlciA9IHNlbGYucGxhY2Vob2xkZXIgPSB0ZXh0OwoJCQkJfQoJCQl9CgoJCQlpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImxpIiApOwoJCQlpZiAoIG9wdGlvbi5kaXNhYmxlZCApIHsKCQkJCWNsYXNzZXMucHVzaCggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCQl9CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSW5kZXhBdHRyLCBpICk7CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSWNvbkF0dHIsIGRhdGFJY29uICk7CgkJCWlmICggaXNQbGFjZWhvbGRlckl0ZW0gKSB7CgkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQl9CgkJCWl0ZW0uY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCAiICIgKTsKCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgIm9wdGlvbiIgKTsKCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggInRhYmluZGV4IiwgIi0xIiApOwoJCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJCSQoIGFuY2hvciApLmFkZENsYXNzKCAidWktYnRuIHVpLWNoZWNrYm94LW9mZiB1aS1idG4taWNvbi1yaWdodCIgKTsKCQkJfQoKCQkJaXRlbS5hcHBlbmRDaGlsZCggYW5jaG9yICk7CgkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBpdGVtICk7CgkJfQoKCQlzZWxmLmxpc3RbMF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgoJCS8vIEhpZGUgaGVhZGVyIGlmIGl0J3Mgbm90IGEgbXVsdGlzZWxlY3QgYW5kIHRoZXJlJ3Mgbm8gcGxhY2Vob2xkZXIKCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJdGhpcy5oZWFkZXIuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCX0KCgkJLy8gTm93IHBvcHVsYXRlZCwgY3JlYXRlIGxpc3R2aWV3CgkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7Cgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSA/CgkJCXRoaXMuX3N1cGVyKCkgOgoJCQkkKCAiPGE+IiwgewoJCQkJImhyZWYiOiAiIyIsCgkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkiYXJpYS1oYXNwb3B1cCI6ICJ0cnVlIiwKCgkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCX0pOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgoJCWlmICggIXRoaXMub3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQl0aGlzLmNsb3NlKCk7CgoJCQkvLyBSZXN0b3JlIHRoZSB0YWJpbmRleCBhdHRyaWJ1dGUgdG8gaXRzIG9yaWdpbmFsIHZhbHVlCgkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gZmFsc2UgKSB7CgkJCQkJdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgdGhpcy5fb3JpZ1RhYkluZGV4ICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuc2VsZWN0LnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCQkJCX0KCQkJfQoKCQkJLy8gUmVtb3ZlIHRoZSBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgaWYgd2Ugd2VyZSB0aGUgb25lcyB0byBhZGQgaXQKCQkJaWYgKCB0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgKSB7CgkJCQl0aGlzLl9zZWxlY3RPcHRpb25zKCkucmVtb3ZlQXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInBsYWNlaG9sZGVyIiApOwoJCQl9CgoJCQkvLyBSZW1vdmUgdGhlIHBvcHVwCgkJCXRoaXMubGlzdGJveC5yZW1vdmUoKTsKCgkJCS8vIFJlbW92ZSB0aGUgZGlhbG9nCgkJCXRoaXMubWVudVBhZ2UucmVtb3ZlKCk7CgkJfQoKCQkvLyBDaGFpbiB1cAoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCi8vIGJ1dHRvbk1hcmt1cCBpcyBkZXByZWNhdGVkIGFzIG9mIDEuNC4wIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gMS41LjAuCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIEdlbmVyYWwgcG9saWN5OiBEbyBub3QgYWNjZXNzIGRhdGEtKiBhdHRyaWJ1dGVzIGV4Y2VwdCBkdXJpbmcgZW5oYW5jZW1lbnQuCi8vIEluIGFsbCBvdGhlciBjYXNlcyB3ZSBkZXRlcm1pbmUgdGhlIHN0YXRlIG9mIHRoZSBidXR0b24gZXhjbHVzaXZlbHkgZnJvbSBpdHMKLy8gY2xhc3NOYW1lLiBUaGF0J3Mgd2h5IG9wdGlvbnNUb0NsYXNzZXMgZXhwZWN0cyBhIGZ1bGwgY29tcGxlbWVudCBvZiBvcHRpb25zLAovLyBhbmQgdGhlIGpRdWVyeSBwbHVnaW4gY29tcGxldGVzIHRoZSBzZXQgb2Ygb3B0aW9ucyBmcm9tIHRoZSBkZWZhdWx0IHZhbHVlcy4KCi8vIE1hcCBjbGFzc2VzIHRvIGJ1dHRvbk1hcmt1cCBib29sZWFuIG9wdGlvbnMgLSB1c2VkIGluIGNsYXNzTmFtZVRvT3B0aW9ucygpCnZhciByZXZlcnNlQm9vbE9wdGlvbk1hcCA9IHsKCQkidWktc2hhZG93IiA6ICJzaGFkb3ciLAoJCSJ1aS1jb3JuZXItYWxsIiA6ICJjb3JuZXJzIiwKCQkidWktYnRuLWlubGluZSIgOiAiaW5saW5lIiwKCQkidWktc2hhZG93LWljb24iIDogImljb25zaGFkb3ciLCAvKiBUT0RPOiBSZW1vdmUgaW4gMS41ICovCgkJInVpLW1pbmkiIDogIm1pbmkiCgl9LAoJZ2V0QXR0ckZpeGVkID0gZnVuY3Rpb24oKSB7CgkJdmFyIHJldCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCXJldHVybiAoIHJldCA9PSBudWxsID8gdW5kZWZpbmVkIDogcmV0ICk7Cgl9LAoJY2FwaXRhbExldHRlcnNSRSA9IC9bQS1aXS9nOwoKLy8gb3B0aW9uc1RvQ2xhc3NlczoKLy8gQG9wdGlvbnM6IEEgY29tcGxldGUgc2V0IG9mIG9wdGlvbnMgdG8gY29udmVydCB0byBjbGFzcyBuYW1lcy4KLy8gQGV4aXN0aW5nQ2xhc3NlczogZXh0cmEgY2xhc3NlcyB0byBhZGQgdG8gdGhlIHJlc3VsdAovLwovLyBDb252ZXJ0cyBAb3B0aW9ucyB0byBidXR0b25NYXJrdXAgY2xhc3NlcyBhbmQgcmV0dXJucyB0aGUgcmVzdWx0IGFzIGFuIGFycmF5Ci8vIHRoYXQgY2FuIGJlIGNvbnZlcnRlZCB0byBhbiBlbGVtZW50J3MgY2xhc3NOYW1lIHdpdGggLmpvaW4oICIgIiApLiBBbGwKLy8gcG9zc2libGUgb3B0aW9ucyBtdXN0IGJlIHNldCBpbnNpZGUgQG9wdGlvbnMuIFVzZSAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cwovLyB0byBnZXQgYSBjb21wbGV0ZSBzZXQgYW5kIHVzZSAkLmV4dGVuZCB0byBvdmVycmlkZSB5b3VyIGNob2ljZSBvZiBvcHRpb25zCi8vIGZyb20gdGhhdCBzZXQuCmZ1bmN0aW9uIG9wdGlvbnNUb0NsYXNzZXMoIG9wdGlvbnMsIGV4aXN0aW5nQ2xhc3NlcyApIHsKCXZhciBjbGFzc2VzID0gZXhpc3RpbmdDbGFzc2VzID8gZXhpc3RpbmdDbGFzc2VzIDogW107CgoJLy8gQWRkIGNsYXNzZXMgdG8gdGhlIGFycmF5IC0gZmlyc3QgdWktYnRuCgljbGFzc2VzLnB1c2goICJ1aS1idG4iICk7CgoJLy8gSWYgdGhlcmUgaXMgYSB0aGVtZQoJaWYgKCBvcHRpb25zLnRoZW1lICkgewoJCWNsYXNzZXMucHVzaCggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJfQoKCS8vIElmIHRoZXJlJ3MgYW4gaWNvbiwgYWRkIHRoZSBpY29uLXJlbGF0ZWQgY2xhc3NlcwoJaWYgKCBvcHRpb25zLmljb24gKSB7CgkJY2xhc3NlcyA9IGNsYXNzZXMuY29uY2F0KFsKCQkJInVpLWljb24tIiArIG9wdGlvbnMuaWNvbiwKCQkJInVpLWJ0bi1pY29uLSIgKyBvcHRpb25zLmljb25wb3MKCQldKTsKCQlpZiAoIG9wdGlvbnMuaWNvbnNoYWRvdyApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktc2hhZG93LWljb24iICk7IC8qIFRPRE86IFJlbW92ZSBpbiAxLjUgKi8KCQl9Cgl9CgoJLy8gQWRkIHRoZSBhcHByb3ByaWF0ZSBjbGFzcyBmb3IgZWFjaCBib29sZWFuIG9wdGlvbgoJaWYgKCBvcHRpb25zLmlubGluZSApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1idG4taW5saW5lIiApOwoJfQoJaWYgKCBvcHRpb25zLnNoYWRvdyApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ciICk7Cgl9CglpZiAoIG9wdGlvbnMuY29ybmVycyApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1jb3JuZXItYWxsIiApOwoJfQoJaWYgKCBvcHRpb25zLm1pbmkgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktbWluaSIgKTsKCX0KCgkvLyBDcmVhdGUgYSBzdHJpbmcgZnJvbSB0aGUgYXJyYXkgYW5kIHJldHVybiBpdAoJcmV0dXJuIGNsYXNzZXM7Cn0KCi8vIGNsYXNzTmFtZVRvT3B0aW9uczoKLy8gQGNsYXNzZXM6IEEgc3RyaW5nIGNvbnRhaW5pbmcgYSAuY2xhc3NOYW1lLXN0eWxlIHNwYWNlLXNlcGFyYXRlZCBjbGFzcyBsaXN0Ci8vCi8vIExvb3BzIG92ZXIgQGNsYXNzZXMgYW5kIGNhbGN1bGF0ZXMgYW4gb3B0aW9ucyBvYmplY3QgYmFzZWQgb24gdGhlCi8vIGJ1dHRvbk1hcmt1cC1yZWxhdGVkIGNsYXNzZXMgaXQgZmluZHMuIEl0IHJlY29yZHMgdW5yZWNvZ25pemVkIGNsYXNzZXMgaW4gYW4KLy8gYXJyYXkuCi8vCi8vIFJldHVybnM6IEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBmb2xsb3dpbmcgaXRlbXM6Ci8vCi8vICJvcHRpb25zIjogYnV0dG9uTWFya3VwIG9wdGlvbnMgZm91bmQgdG8gYmUgcHJlc2VudCBiZWNhdXNlIG9mIHRoZQovLyBwcmVzZW5jZS9hYnNlbmNlIG9mIGNvcnJlc3BvbmRpbmcgY2xhc3NlcwovLwovLyAidW5rbm93bkNsYXNzZXMiOiBhIHN0cmluZyBjb250YWluaW5nIGFsbCB0aGUgbm9uLWJ1dHRvbk1hcmt1cC1yZWxhdGVkCi8vIGNsYXNzZXMgZm91bmQgaW4gQGNsYXNzZXMKLy8KLy8gImFscmVhZHlFbmhhbmNlZCI6IEEgYm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHVpLWJ0biBjbGFzcyB3YXMgYW1vbmcKLy8gdGhvc2UgZm91bmQgdG8gYmUgcHJlc2VudApmdW5jdGlvbiBjbGFzc05hbWVUb09wdGlvbnMoIGNsYXNzZXMgKSB7Cgl2YXIgaWR4LCBtYXAsIHVua25vd25DbGFzcywKCQlhbHJlYWR5RW5oYW5jZWQgPSBmYWxzZSwKCQlub0ljb24gPSB0cnVlLAoJCW8gPSB7CgkJCWljb246ICIiLAoJCQlpbmxpbmU6IGZhbHNlLAoJCQlzaGFkb3c6IGZhbHNlLAoJCQljb3JuZXJzOiBmYWxzZSwKCQkJaWNvbnNoYWRvdzogZmFsc2UsCgkJCW1pbmk6IGZhbHNlCgkJfSwKCQl1bmtub3duQ2xhc3NlcyA9IFtdOwoKCWNsYXNzZXMgPSBjbGFzc2VzLnNwbGl0KCAiICIgKTsKCgkvLyBMb29wIG92ZXIgdGhlIGNsYXNzZXMKCWZvciAoIGlkeCA9IDAgOyBpZHggPCBjbGFzc2VzLmxlbmd0aCA7IGlkeCsrICkgewoKCQkvLyBBc3N1bWUgaXQncyBhbiB1bnJlY29nbml6ZWQgY2xhc3MKCQl1bmtub3duQ2xhc3MgPSB0cnVlOwoKCQkvLyBSZWNvZ25pemUgYm9vbGVhbiBvcHRpb25zIGZyb20gdGhlIHByZXNlbmNlIG9mIGNsYXNzZXMKCQltYXAgPSByZXZlcnNlQm9vbE9wdGlvbk1hcFsgY2xhc3Nlc1sgaWR4IF0gXTsKCQlpZiAoIG1hcCAhPT0gdW5kZWZpbmVkICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJb1sgbWFwIF0gPSB0cnVlOwoKCQkvLyBSZWNvZ25pemUgdGhlIHByZXNlbmNlIG9mIGFuIGljb24gYW5kIGVzdGFibGlzaCB0aGUgaWNvbiBwb3NpdGlvbgoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdLmluZGV4T2YoICJ1aS1idG4taWNvbi0iICkgPT09IDAgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlub0ljb24gPSBmYWxzZTsKCQkJby5pY29ucG9zID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCAxMiApOwoKCQkvLyBFc3RhYmxpc2ggd2hpY2ggaWNvbiBpcyBwcmVzZW50CgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0uaW5kZXhPZiggInVpLWljb24tIiApID09PSAwICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJby5pY29uID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCA4ICk7CgoJCS8vIEVzdGFibGlzaCB0aGUgdGhlbWUgLSB0aGlzIHJlY29nbml6ZXMgb25lLWxldHRlciB0aGVtZSBzd2F0Y2ggbmFtZXMKCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXS5pbmRleE9mKCAidWktYnRuLSIgKSA9PT0gMCAmJiBjbGFzc2VzWyBpZHggXS5sZW5ndGggPT09IDggKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvLnRoZW1lID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCA3ICk7CgoJCS8vIFJlY29nbml6ZSB0aGF0IHRoaXMgZWxlbWVudCBoYXMgYWxyZWFkeSBiZWVuIGJ1dHRvbk1hcmt1cC1lbmhhbmNlZAoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdID09PSAidWktYnRuIiApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCWFscmVhZHlFbmhhbmNlZCA9IHRydWU7CgkJfQoKCQkvLyBJZiB0aGlzIGNsYXNzIGhhcyBub3QgYmVlbiByZWNvZ25pemVkLCBhZGQgaXQgdG8gdGhlIGxpc3QKCQlpZiAoIHVua25vd25DbGFzcyApIHsKCQkJdW5rbm93bkNsYXNzZXMucHVzaCggY2xhc3Nlc1sgaWR4IF0gKTsKCQl9Cgl9CgoJLy8gSWYgYSAidWktYnRuLWljb24tKiIgaWNvbiBwb3NpdGlvbiBjbGFzcyBpcyBhYnNlbnQgdGhlcmUgY2Fubm90IGJlIGFuIGljb24KCWlmICggbm9JY29uICkgewoJCW8uaWNvbiA9ICIiOwoJfQoKCXJldHVybiB7CgkJb3B0aW9uczogbywKCQl1bmtub3duQ2xhc3NlczogdW5rbm93bkNsYXNzZXMsCgkJYWxyZWFkeUVuaGFuY2VkOiBhbHJlYWR5RW5oYW5jZWQKCX07Cn0KCmZ1bmN0aW9uIGNhbWVsQ2FzZTJIeXBoZW5hdGVkKCBjICkgewoJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKfQoKLy8gJC5mbi5idXR0b25NYXJrdXA6Ci8vIERPTTogZ2V0cy9zZXRzIC5jbGFzc05hbWUKLy8KLy8gQG9wdGlvbnM6IG9wdGlvbnMgdG8gYXBwbHkgdG8gdGhlIGVsZW1lbnRzIGluIHRoZSBqUXVlcnkgb2JqZWN0Ci8vIEBvdmVyd3JpdGVDbGFzc2VzOiBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0byBob25vdXIgZXhpc3RpbmcgY2xhc3NlcwovLwovLyBDYWxjdWxhdGVzIHRoZSBjbGFzc2VzIHRvIGFwcGx5IHRvIHRoZSBlbGVtZW50cyBpbiB0aGUgalF1ZXJ5IG9iamVjdCBiYXNlZCBvbgovLyB0aGUgb3B0aW9ucyBwYXNzZWQgaW4uIElmIEBvdmVyd3JpdGVDbGFzc2VzIGlzIHRydWUsIGl0IHNldHMgdGhlIGNsYXNzTmFtZQovLyBwcm9wZXJ0eSBvZiBlYWNoIGVsZW1lbnQgaW4gdGhlIGpRdWVyeSBvYmplY3QgdG8gdGhlIGJ1dHRvbk1hcmt1cCBjbGFzc2VzCi8vIGl0IGNhbGN1bGF0ZXMgYmFzZWQgb24gdGhlIG9wdGlvbnMgcGFzc2VkIGluLgovLwovLyBJZiB5b3Ugd2lzaCB0byBwcmVzZXJ2ZSBhbnkgY2xhc3NlcyB0aGF0IGFyZSBhbHJlYWR5IHByZXNlbnQgb24gdGhlIGVsZW1lbnRzCi8vIGluc2lkZSB0aGUgalF1ZXJ5IG9iamVjdCwgaW5jbHVkaW5nIGJ1dHRvbk1hcmt1cC1yZWxhdGVkIGNsYXNzZXMgdGhhdCB3ZXJlCi8vIGFkZGVkIGJ5IGEgcHJldmlvdXMgY2FsbCB0byAkLmZuLmJ1dHRvbk1hcmt1cCgpIG9yIGR1cmluZyBwYWdlIGVuaGFuY2VtZW50Ci8vIHRoZW4geW91IHNob3VsZCBvbWl0IEBvdmVyd3JpdGVDbGFzc2VzIG9yIHNldCBpdCB0byBmYWxzZS4KJC5mbi5idXR0b25NYXJrdXAgPSBmdW5jdGlvbiggb3B0aW9ucywgb3ZlcndyaXRlQ2xhc3NlcyApIHsKCXZhciBpZHgsIGRhdGEsIGVsLCByZXRyaWV2ZWRPcHRpb25zLCBvcHRpb25LZXksCgkJZGVmYXVsdHMgPSAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0czsKCglmb3IgKCBpZHggPSAwIDsgaWR4IDwgdGhpcy5sZW5ndGggOyBpZHgrKyApIHsKCQllbCA9IHRoaXNbIGlkeCBdOwoJCWRhdGEgPSBvdmVyd3JpdGVDbGFzc2VzID8KCgkJCS8vIEFzc3VtZSB0aGlzIGVsZW1lbnQgaXMgbm90IGVuaGFuY2VkIGFuZCBpZ25vcmUgaXRzIGNsYXNzZXMKCQkJeyBhbHJlYWR5RW5oYW5jZWQ6IGZhbHNlLCB1bmtub3duQ2xhc3NlczogW10gfSA6CgoJCQkvLyBPdGhlcndpc2UgYW5hbHl6ZSBleGlzdGluZyBjbGFzc2VzIHRvIGVzdGFibGlzaCBleGlzdGluZyBvcHRpb25zIGFuZAoJCQkvLyBjbGFzc2VzCgkJCWNsYXNzTmFtZVRvT3B0aW9ucyggZWwuY2xhc3NOYW1lICk7CgoJCXJldHJpZXZlZE9wdGlvbnMgPSAkLmV4dGVuZCgge30sCgoJCQkvLyBJZiB0aGUgZWxlbWVudCBhbHJlYWR5IGhhcyB0aGUgY2xhc3MgdWktYnRuLCB0aGVuIHdlIGFzc3VtZSB0aGF0CgkJCS8vIGl0IGhhcyBwYXNzZWQgdGhyb3VnaCBidXR0b25NYXJrdXAgYmVmb3JlIC0gb3RoZXJ3aXNlLCB0aGUgb3B0aW9ucwoJCQkvLyByZXR1cm5lZCBieSBjbGFzc05hbWVUb09wdGlvbnMgZG8gbm90IGNvcnJlY3RseSByZWZsZWN0IHRoZSBzdGF0ZSBvZgoJCQkvLyB0aGUgZWxlbWVudAoJCQkoIGRhdGEuYWxyZWFkeUVuaGFuY2VkID8gZGF0YS5vcHRpb25zIDoge30gKSwKCgkJCS8vIEZpbmFsbHksIGFwcGx5IHRoZSBvcHRpb25zIHBhc3NlZCBpbgoJCQlvcHRpb25zICk7CgoJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IGNhbGwgb24gdGhpcyBlbGVtZW50LCByZXRyaWV2ZSByZW1haW5pbmcgb3B0aW9ucwoJCS8vIGZyb20gdGhlIGRhdGEtYXR0cmlidXRlcwoJCWlmICggIWRhdGEuYWxyZWFkeUVuaGFuY2VkICkgewoJCQlmb3IgKCBvcHRpb25LZXkgaW4gZGVmYXVsdHMgKSB7CgkJCQlpZiAoIHJldHJpZXZlZE9wdGlvbnNbIG9wdGlvbktleSBdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0cmlldmVkT3B0aW9uc1sgb3B0aW9uS2V5IF0gPSBnZXRBdHRyRml4ZWQoIGVsLAoJCQkJCQlvcHRpb25LZXkucmVwbGFjZSggY2FwaXRhbExldHRlcnNSRSwgY2FtZWxDYXNlMkh5cGhlbmF0ZWQgKQoJCQkJCSk7CgkJCQl9CgkJCX0KCQl9CgoJCWVsLmNsYXNzTmFtZSA9IG9wdGlvbnNUb0NsYXNzZXMoCgoJCQkvLyBNZXJnZSBhbGwgdGhlIG9wdGlvbnMgYW5kIGFwcGx5IHRoZW0gYXMgY2xhc3NlcwoJCQkkLmV4dGVuZCgge30sCgoJCQkJLy8gVGhlIGRlZmF1bHRzIGZvcm0gdGhlIGJhc2lzCgkJCQlkZWZhdWx0cywKCgkJCQkvLyBBZGQgdGhlIGNvbXB1dGVkIG9wdGlvbnMKCQkJCXJldHJpZXZlZE9wdGlvbnMKCQkJKSwKCgkJCS8vIC4uLiBhbmQgcmUtYXBwbHkgYW55IHVucmVjb2duaXplZCBjbGFzc2VzIHRoYXQgd2VyZSBmb3VuZAoJCQlkYXRhLnVua25vd25DbGFzc2VzICkuam9pbiggIiAiICk7CgkJaWYgKCBlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJidXR0b24iICkgewoJCQllbC5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImJ1dHRvbiIgKTsKCQl9Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgovLyBidXR0b25NYXJrdXAgZGVmYXVsdHMuIFRoaXMgbXVzdCBiZSBhIGNvbXBsZXRlIHNldCwgaS5lLiwgYSB2YWx1ZSBtdXN0IGJlCi8vIGdpdmVuIGhlcmUgZm9yIGFsbCByZWNvZ25pemVkIG9wdGlvbnMKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7CglpY29uOiAiIiwKCWljb25wb3M6ICJsZWZ0IiwKCXRoZW1lOiBudWxsLAoJaW5saW5lOiBmYWxzZSwKCXNoYWRvdzogdHJ1ZSwKCWNvcm5lcnM6IHRydWUsCglpY29uc2hhZG93OiBmYWxzZSwgLyogVE9ETzogUmVtb3ZlIGluIDEuNS4gT3B0aW9uIGRlcHJlY2F0ZWQgaW4gMS40LiAqLwoJbWluaTogZmFsc2UKfTsKCiQuZXh0ZW5kKCAkLmZuLmJ1dHRvbk1hcmt1cCwgewoJaW5pdFNlbGVjdG9yOiAiYTpqcW1EYXRhKHJvbGU9J2J1dHRvbicpLCAudWktYmFyID4gYSwgLnVpLWJhciA+IDpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpID4gYSwgYnV0dG9uOm5vdCg6anFtRGF0YShyb2xlPSduYXZiYXInKSBidXR0b24pIgp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbnRyb2xncm91cCIsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJZW5oYW5jZWQ6IGZhbHNlLAoJCXRoZW1lOiBudWxsLAoJCXNoYWRvdzogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlleGNsdWRlSW52aXNpYmxlOiB0cnVlLAoJCXR5cGU6ICJ2ZXJ0aWNhbCIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFJ1biBidXR0b25tYXJrdXAKCQlpZiAoICQuZm4uYnV0dG9uTWFya3VwICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5mbi5idXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkuYnV0dG9uTWFya3VwKCk7CgkJfQoJCS8vIEVuaGFuY2UgY2hpbGQgd2lkZ2V0cwoJCSQuZWFjaCggdGhpcy5fY2hpbGRXaWRnZXRzLCAkLnByb3h5KCBmdW5jdGlvbiggbnVtYmVyLCB3aWRnZXROYW1lICkgewoJCQlpZiAoICQubW9iaWxlWyB3aWRnZXROYW1lIF0gKSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGVbIHdpZGdldE5hbWUgXS5pbml0U2VsZWN0b3IgKS5ub3QoICQubW9iaWxlLnBhZ2UucHJvdG90eXBlLmtlZXBOYXRpdmVTZWxlY3RvcigpIClbIHdpZGdldE5hbWUgXSgpOwoJCQl9CgkJfSwgdGhpcyApKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3VpOiBudWxsLAoJCQlfaW5pdGlhbFJlZnJlc2g6IHRydWUKCQl9KTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQl0aGlzLl91aSA9IHsKCQkJCWdyb3VwTGVnZW5kOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIgKS5jaGlsZHJlbigpLAoJCQkJY2hpbGRXcmFwcGVyOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgl9LAoKCV9jaGlsZFdpZGdldHM6IFsgImNoZWNrYm94cmFkaW8iLCAic2VsZWN0bWVudSIsICJidXR0b24iIF0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6ICJ1aS1ncm91cC10aGVtZS0iICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJdWkgPSB7CgkJCQlncm91cExlZ2VuZDogZWxlbS5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJCWNoaWxkV3JhcHBlcjogZWxlbQoJCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCQkJInVpLWNvbnRyb2xncm91cC0iICsKCQkJCQkJCSggb3B0cy50eXBlID09PSAiaG9yaXpvbnRhbCIgPyAiaG9yaXpvbnRhbCIgOiAidmVydGljYWwiICkgKyAiICIgKwoJCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0cy50aGVtZSApICsgIiAiICsKCQkJCQkJKCBvcHRzLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSArCgkJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKQoJCQkJCS53cmFwSW5uZXIoICI8ZGl2ICIgKwoJCQkJCQkiY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyAiICsKCQkJCQkJCSggb3B0cy5zaGFkb3cgPT09IHRydWUgPyAidWktc2hhZG93IiA6ICIiICkgKyAiJz48L2Rpdj4iICkKCQkJCQkuY2hpbGRyZW4oKQoJCQl9OwoKCQlpZiAoIHVpLmdyb3VwTGVnZW5kLmxlbmd0aCA+IDAgKSB7CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPjwvZGl2PiIgKQoJCQkJLmFwcGVuZCggdWkuZ3JvdXBMZWdlbmQgKQoJCQkJLnByZXBlbmRUbyggZWxlbSApOwoJCX0KCgkJcmV0dXJuIHVpOwoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2FsbFJlZnJlc2gsIHJldHVyblZhbHVlLAoJCQllbGVtID0gdGhpcy5lbGVtZW50OwoKCQkvLyBNdXN0IGhhdmUgb25lIG9mIGhvcml6b250YWwgb3IgdmVydGljYWwKCQlpZiAoIG9wdGlvbnMudHlwZSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwiICkKCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC0iICsgKCBvcHRpb25zLnR5cGUgPT09ICJob3Jpem9udGFsIiA/ICJob3Jpem9udGFsIiA6ICJ2ZXJ0aWNhbCIgKSApOwoJCQljYWxsUmVmcmVzaCA9IHRydWU7CgkJfQoKCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0aW9ucy50aGVtZSApICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fdWkuY2hpbGRXcmFwcGVyLnRvZ2dsZUNsYXNzKCAidWktc2hhZG93Iiwgb3B0aW9ucy5zaGFkb3cgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5leGNsdWRlSW52aXNpYmxlICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5leGNsdWRlSW52aXNpYmxlID0gb3B0aW9ucy5leGNsdWRlSW52aXNpYmxlOwoJCQljYWxsUmVmcmVzaCA9IHRydWU7CgkJfQoKCQlyZXR1cm5WYWx1ZSA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggY2FsbFJlZnJlc2ggKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfSwKCgljb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl91aS5jaGlsZFdyYXBwZXI7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmNvbnRhaW5lcigpLAoJCQllbHMgPSAkZWwuZmluZCggIi51aS1idG4iICkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICksCgkJCWNyZWF0ZSA9IHRoaXMuX2luaXRpYWxSZWZyZXNoOwoJCWlmICggJC5tb2JpbGUuY2hlY2tib3hyYWRpbyApIHsKCQkJJGVsLmZpbmQoICI6bW9iaWxlLWNoZWNrYm94cmFkaW8iICkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJfQoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGVscywKCQkJdGhpcy5vcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgPyB0aGlzLl9nZXRWaXNpYmxlcyggZWxzLCBjcmVhdGUgKSA6IGVscywKCQkJY3JlYXRlICk7CgkJdGhpcy5faW5pdGlhbFJlZnJlc2ggPSBmYWxzZTsKCX0sCgoJLy8gQ2F2ZWF0OiBJZiB0aGUgbGVnZW5kIGlzIG5vdCB0aGUgZmlyc3QgY2hpbGQgb2YgdGhlIGNvbnRyb2xncm91cCBhdCBlbmhhbmNlCgkvLyB0aW1lLCBpdCB3aWxsIGJlIGFmdGVyIF9kZXN0cm95KCkuCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHVpLCBidXR0b25zLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdWkgPSB0aGlzLl91aTsKCQlidXR0b25zID0gdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCSJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwgdWktY29ybmVyLWFsbCB1aS1taW5pICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oIG9wdHMudGhlbWUgKSApCgkJCS5maW5kKCAiLnVpLWJ0biIgKQoJCQkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICk7CgoJCXRoaXMuX3JlbW92ZUZpcnN0TGFzdENsYXNzZXMoIGJ1dHRvbnMgKTsKCgkJdWkuZ3JvdXBMZWdlbmQudW53cmFwKCk7CgkJdWkuY2hpbGRXcmFwcGVyLmNoaWxkcmVuKCkudW53cmFwKCk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgewoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdoZWFkZXInKSIsCgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCWFkZEJhY2tCdG46IGZhbHNlLAoJCQliYWNrQnRuVGhlbWU6IG51bGwsCgkJCWJhY2tCdG5UZXh0OiAiQmFjayIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIGxlZnRidG4sIHJpZ2h0YnRuLAoJCQkJcm9sZSA9ICB0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciIsCgkJCQlwYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJCXBhZ2UgPSBmYWxzZTsKCQkJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7CgkJCQkJInBhZ2VzaG93IjogInJlZnJlc2giCgkJCQl9KTsKCQkJfQoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJcm9sZTogcm9sZSwKCQkJCXBhZ2U6IHBhZ2UsCgkJCQlsZWZ0YnRuOiBsZWZ0YnRuLAoJCQkJcmlnaHRidG46IHJpZ2h0YnRuCgkJCX0pOwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApLmFkZENsYXNzKCAidWktIiArIHJvbGUgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICkgewoJCQlpZiAoIG8uYWRkQmFja0J0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fdXBkYXRlQmFja0J1dHRvbigpOwoJCQl9CgkJCWlmICggby5iYWNrQnRuVGhlbWUgIT0gbnVsbCApIHsKCQkJCXRoaXMuZWxlbWVudAoJCQkJCS5maW5kKCAiLnVpLXRvb2xiYXItYmFjay1idG4iICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1idG4gdWktYnRuLSIgKyBvLmJhY2tCdG5UaGVtZSApOwoJCQl9CgkJCWlmICggby5iYWNrQnRuVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktdG9vbGJhci1iYWNrLWJ0biAudWktYnRuLXRleHQiICkudGV4dCggby5iYWNrQnRuVGV4dCApOwoJCQl9CgkJCWlmICggby50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdmFyIGN1cnJlbnRUaGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSA/IHRoaXMub3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiwKCQkJCQluZXdUaGVtZSA9IG8udGhlbWUgPyBvLnRoZW1lIDogImluaGVyaXQiOwoKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJhci0iICsgY3VycmVudFRoZW1lICkuYWRkQ2xhc3MoICJ1aS1iYXItIiArIG5ld1RoZW1lICk7CgkJCX0KCgkJCXRoaXMuX3N1cGVyKCBvICk7CgkJfSwKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLnJvbGUgPT09ICJoZWFkZXIiICkgewoJCQkJdGhpcy5fYWRkSGVhZGVyQnV0dG9uQ2xhc3NlcygpOwoJCQl9CgkJCWlmICggIXRoaXMucGFnZSApIHsKCQkJCXRoaXMuX3NldFJlbGF0aXZlKCk7CgkJCQlpZiAoIHRoaXMucm9sZSA9PT0gImZvb3RlciIgKSB7CgkJCQkJdGhpcy5lbGVtZW50LmFwcGVuZFRvKCAiYm9keSIgKTsKCQkJCX0gZWxzZSBpZiAoIHRoaXMucm9sZSA9PT0gImhlYWRlciIgKSB7CgkJCQkJdGhpcy5fdXBkYXRlQmFja0J1dHRvbigpOwoJCQkJfQoJCQl9CgkJCXRoaXMuX2FkZEhlYWRpbmdDbGFzc2VzKCk7CgkJCXRoaXMuX2J0bk1hcmt1cCgpOwoJCX0sCgoJCS8vd2Ugb25seSB3YW50IHRoaXMgdG8gcnVuIG9uIG5vbiBmaXhlZCB0b29sYmFycyBzbyBtYWtlIGl0IGVhc3kgdG8gb3ZlcnJpZGUKCQlfc2V0UmVsYXRpdmU6IGZ1bmN0aW9uKCkgewoJCQkkKCAiW2RhdGEtIisgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSddIiApLmNzcyh7ICJwb3NpdGlvbiI6ICJyZWxhdGl2ZSIgfSk7CgkJfSwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEFzIGZyb20gMS41IGJ1dHRvbiBjbGFzc2VzIGhhdmUgdG8gYmUgcHJlc2VudCBpbiB0aGUgbWFya3VwLgoJCV9idG5NYXJrdXA6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQKCQkJCS5jaGlsZHJlbiggImEiICkKCQkJCS5maWx0ZXIoICI6bm90KFtkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdub25lJ10pIiApCgkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCAiYnV0dG9uIiApOwoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImNyZWF0ZSIgKTsKCQl9LAoJCS8vIERlcHJlY2F0ZWQgaW4gMS40LiBBcyBmcm9tIDEuNSB1aS1idG4tbGVmdC9yaWdodCBjbGFzc2VzIGhhdmUgdG8gYmUgcHJlc2VudCBpbiB0aGUgbWFya3VwLgoJCV9hZGRIZWFkZXJCdXR0b25DbGFzc2VzOiBmdW5jdGlvbigpIHsKCQkJdmFyIGhlYWRlckFuY2hvcnMgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJhLCBidXR0b24iICk7CgoJCQkvLyBEbyBub3QgbWlzdGFrZSBhIGJhY2sgYnV0dG9uIGZvciBhIGxlZnQgdG9vbGJhciBidXR0b24KCQkJdGhpcy5sZWZ0YnRuID0gaGVhZGVyQW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApICYmCgkJCQkhaGVhZGVyQW5jaG9ycy5oYXNDbGFzcyggInVpLXRvb2xiYXItYmFjay1idG4iICk7CgoJCQl0aGlzLnJpZ2h0YnRuID0gaGVhZGVyQW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCS8vIEZpbHRlciBvdXQgcmlnaHQgYnV0dG9ucyBhbmQgYmFjayBidXR0b25zCgkJCXRoaXMubGVmdGJ0biA9IHRoaXMubGVmdGJ0biB8fAoJCQkJaGVhZGVyQW5jaG9ycy5lcSggMCApCgkJCQkJLm5vdCggIi51aS1idG4tcmlnaHQsLnVpLXRvb2xiYXItYmFjay1idG4iICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1idG4tbGVmdCIgKQoJCQkJCS5sZW5ndGg7CgoJCQl0aGlzLnJpZ2h0YnRuID0gdGhpcy5yaWdodGJ0biB8fCBoZWFkZXJBbmNob3JzLmVxKCAxICkuYWRkQ2xhc3MoICJ1aS1idG4tcmlnaHQiICkubGVuZ3RoOwoJCX0sCgkJX3VwZGF0ZUJhY2tCdXR0b246IGZ1bmN0aW9uKCkgewoJCQl2YXIgYmFja0J1dHRvbiwKCQkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCQl0aGVtZSA9IG9wdGlvbnMuYmFja0J0blRoZW1lIHx8IG9wdGlvbnMudGhlbWU7CgoJCQkvLyBSZXRyaWV2ZSB0aGUgYmFjayBidXR0b24gb3IgY3JlYXRlIGEgbmV3LCBlbXB0eSBvbmUKCQkJYmFja0J1dHRvbiA9IHRoaXMuX2JhY2tCdXR0b24gPSAoIHRoaXMuX2JhY2tCdXR0b24gfHwge30gKTsKCgkJCS8vIFdlIGFkZCBhIGJhY2sgYnV0dG9uIG9ubHkgaWYgdGhlIG9wdGlvbiB0byBkbyBzbyBpcyBvbgoJCQlpZiAoIHRoaXMub3B0aW9ucy5hZGRCYWNrQnRuICYmCgoJCQkJCS8vIFRoaXMgbXVzdCBhbHNvIGJlIGEgaGVhZGVyIHRvb2xiYXIKCQkJCQl0aGlzLnJvbGUgPT09ICJoZWFkZXIiICYmCgoJCQkJCS8vIFRoZXJlIG11c3QgYmUgbXVsdGlwbGUgcGFnZXMgaW4gdGhlIERPTQoJCQkJCSQoICIudWktcGFnZSIgKS5sZW5ndGggPiAxICYmCgkJCQkJKCB0aGlzLnBhZ2UgPwoKCQkJCQkJLy8gSWYgdGhlIHRvb2xiYXIgaXMgaW50ZXJuYWwgdGhlIHBhZ2UncyBVUkwgbXVzdCBkaWZmZXIgZnJvbSB0aGUgaGFzaAoJCQkJCQkoIHRoaXMucGFnZVsgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSAhPT0KCQkJCQkJCSQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCBsb2NhdGlvbi5oYXNoICkgKSA6CgoJCQkJCQkvLyBPdGhlcndpc2UsIGlmIHRoZSB0b29sYmFyIGlzIGV4dGVybmFsIHRoZXJlIG11c3QgYmUgYXQgbGVhc3Qgb25lCgkJCQkJCS8vIGhpc3RvcnkgaXRlbSB0byB3aGljaCBvbmUgY2FuIGdvIGJhY2sKCQkJCQkJKCAkLm1vYmlsZS5uYXZpZ2F0ZSAmJiAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ICYmCgkJCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApICkgJiYKCgkJCQkJLy8gVGhlIHRvb2xiYXIgZG9lcyBub3QgaGF2ZSBhIGxlZnQgYnV0dG9uCgkJCQkJIXRoaXMubGVmdGJ0biApIHsKCgkJCQkvLyBTa2lwIGJhY2sgYnV0dG9uIGNyZWF0aW9uIGlmIG9uZSBpcyBhbHJlYWR5IHByZXNlbnQKCQkJCWlmICggIWJhY2tCdXR0b24uYXR0YWNoZWQgKSB7CgkJCQkJYmFja0J1dHRvbi5lbGVtZW50ID0gKCBiYWNrQnV0dG9uLmVsZW1lbnQgfHwKCQkJCQkJJCggIjxhIHJvbGU9J2J1dHRvbicgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApOycgIiArCgkJCQkJCQkiY2xhc3M9J3VpLWJ0biB1aS1jb3JuZXItYWxsIHVpLXNoYWRvdyB1aS1idG4tbGVmdCAiICsKCQkJCQkJCQkoIHRoZW1lID8gInVpLWJ0bi0iICsgdGhlbWUgKyAiICIgOiAiIiApICsKCQkJCQkJCQkidWktdG9vbGJhci1iYWNrLWJ0biB1aS1pY29uLWNhcmF0LWwgdWktYnRuLWljb24tbGVmdCcgIiArCgkJCQkJCQkiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsPSdiYWNrJz4iICsgb3B0aW9ucy5iYWNrQnRuVGV4dCArCgkJCQkJCQkiPC9hPiIgKSApCgkJCQkJCQkucHJlcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCQkJCQliYWNrQnV0dG9uLmF0dGFjaGVkID0gdHJ1ZTsKCQkJCX0KCgkJCS8vIElmIHdlIGFyZSBub3QgYWRkaW5nIGEgYmFjayBidXR0b24sIHRoZW4gcmVtb3ZlIHRoZSBvbmUgcHJlc2VudCwgaWYgYW55CgkJCX0gZWxzZSBpZiAoIGJhY2tCdXR0b24uZWxlbWVudCApIHsKCQkJCWJhY2tCdXR0b24uZWxlbWVudC5kZXRhY2goKTsKCQkJCWJhY2tCdXR0b24uYXR0YWNoZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJX2FkZEhlYWRpbmdDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKQoJCQkJLmFkZENsYXNzKCAidWktdGl0bGUiICkKCQkJCS8vIFJlZ2FyZGxlc3Mgb2YgaCBlbGVtZW50IG51bWJlciBpbiBzcmMsIGl0IGJlY29tZXMgaDEgZm9yIHRoZSBlbmhhbmNlZCBwYWdlCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAiaGVhZGluZyIsCgkJCQkJImFyaWEtbGV2ZWwiOiAiMSIKCQkJCX0pOwoJCX0KCX0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJJC53aWRnZXQoICJtb2JpbGUudG9vbGJhciIsICQubW9iaWxlLnRvb2xiYXIsIHsKCQlvcHRpb25zOiB7CgkJCXBvc2l0aW9uOm51bGwsCgkJCXZpc2libGVPblBhZ2VTaG93OiB0cnVlLAoJCQlkaXNhYmxlUGFnZVpvb206IHRydWUsCgkJCXRyYW5zaXRpb246ICJzbGlkZSIsIC8vY2FuIGJlIG5vbmUsIGZhZGUsIHNsaWRlIChzbGlkZSBtYXBzIHRvIHNsaWRldXAgb3Igc2xpZGVkb3duKQoJCQlmdWxsc2NyZWVuOiBmYWxzZSwKCQkJdGFwVG9nZ2xlOiB0cnVlLAoJCQl0YXBUb2dnbGVCbGFja2xpc3Q6ICJhLCBidXR0b24sIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCAudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkLCAudWktZmxpcHN3aXRjaCwgLnVpLXBvcHVwLCAudWktcGFuZWwsIC51aS1wYW5lbC1kaXNtaXNzLW9wZW4iLAoJCQloaWRlRHVyaW5nRm9jdXM6ICJpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCIsCgkJCXVwZGF0ZVBhZ2VQYWRkaW5nOiB0cnVlLAoJCQl0cmFja1BlcnNpc3RlbnRUb29sYmFyczogdHJ1ZSwKCgkJCS8vIEJyb3dzZXIgZGV0ZWN0aW9uISBXZWVlZSwgaGVyZSB3ZSBnby4uLgoJCQkvLyBVbmZvcnR1bmF0ZWx5LCBwb3NpdGlvbjpmaXhlZCBpcyBjb3N0bHksIG5vdCB0byBtZW50aW9uIHByb2JhYmx5IGltcG9zc2libGUsIHRvIGZlYXR1cmUtZGV0ZWN0IGFjY3VyYXRlbHkuCgkJCS8vIFNvbWUgdGVzdHMgZXhpc3QsIGJ1dCB0aGV5IGN1cnJlbnRseSByZXR1cm4gZmFsc2UgcmVzdWx0cyBpbiBjcml0aWNhbCBkZXZpY2VzIGFuZCBicm93c2Vycywgd2hpY2ggY291bGQgbGVhZCB0byBhIGJyb2tlbiBleHBlcmllbmNlLgoJCQkvLyBUZXN0aW5nIGZpeGVkIHBvc2l0aW9uaW5nIGlzIGFsc28gcHJldHR5IG9idHJ1c2l2ZSB0byBwYWdlIGxvYWQsIHJlcXVpcmluZyBpbmplY3RlZCBlbGVtZW50cyBhbmQgc2Nyb2xsaW5nIHRoZSB3aW5kb3cKCQkJLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBzZXJ2ZXMgdG8gcnVsZSBvdXQgc29tZSBwb3B1bGFyIGJyb3dzZXJzIHdpdGgga25vd24gZml4ZWQtcG9zaXRpb25pbmcgaXNzdWVzCgkJCS8vIFRoaXMgaXMgYSBwbHVnaW4gb3B0aW9uIGxpa2UgYW55IG90aGVyLCBzbyBmZWVsIGZyZWUgdG8gaW1wcm92ZSBvciBvdmVyd3JpdGUgaXQKCQkJc3VwcG9ydEJsYWNrbGlzdDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gISQuc3VwcG9ydC5maXhlZFBvc2l0aW9uOwoJCQl9CgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCWlmICggdGhpcy5vcHRpb25zLnBvc2l0aW9uID09PSAiZml4ZWQiICYmICF0aGlzLm9wdGlvbnMuc3VwcG9ydEJsYWNrbGlzdCgpICkgewoJCQkJdGhpcy5fbWFrZUZpeGVkKCk7CgkJCX0KCQl9LAoKCQlfbWFrZUZpeGVkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZpeGVkIiApOwoJCQl0aGlzLnVwZGF0ZVBhZ2VQYWRkaW5nKCk7CgkJCXRoaXMuX2FkZFRyYW5zaXRpb25DbGFzcygpOwoJCQl0aGlzLl9iaW5kUGFnZUV2ZW50cygpOwoJCQl0aGlzLl9iaW5kVG9nZ2xlSGFuZGxlcnMoKTsKCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG8gKSB7CgkJCWlmICggby5wb3NpdGlvbiA9PT0gImZpeGVkIiAmJiB0aGlzLm9wdGlvbnMucG9zaXRpb24gIT09ICJmaXhlZCIgKSB7CgkJCQl0aGlzLl9tYWtlRml4ZWQoKTsKCQkJfQoJCQlpZiAoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gImZpeGVkIiAmJiAhdGhpcy5vcHRpb25zLnN1cHBvcnRCbGFja2xpc3QoKSApIHsKCQkJCXZhciAkcGFnZSA9ICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAoICQoIi51aS1wYWdlLWFjdGl2ZSIpLmxlbmd0aCA+IDAgKT8gJCgiLnVpLXBhZ2UtYWN0aXZlIik6ICQoIi51aS1wYWdlIikuZXEoMCk7CgoJCQkJaWYgKCBvLmZ1bGxzY3JlZW4gIT09IHVuZGVmaW5lZCkgewoJCQkJCWlmICggby5mdWxsc2NyZWVuICkgewoJCQkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS0iKyB0aGlzLnJvbGUgKyItZnVsbHNjcmVlbiIgKTsKCQkJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0aGlzLnJvbGUgKyAiLWZ1bGxzY3JlZW4iICk7CgkJCQkJfQoJCQkJCS8vIElmIG5vdCBmdWxsc2NyZWVuLCBhZGQgY2xhc3MgdG8gcGFnZSB0byBzZXQgdG9wIG9yIGJvdHRvbSBwYWRkaW5nCgkJCQkJZWxzZSB7CgkJCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJCQkkcGFnZS5yZW1vdmVDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSArICItZnVsbHNjcmVlbiIgKS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSsgIi1maXhlZCIgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJdGhpcy5fc3VwZXIobyk7CgkJfSwKCgkJX2FkZFRyYW5zaXRpb25DbGFzczogZnVuY3Rpb24oKSB7CgkJCXZhciB0Y2xhc3MgPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCgkJCWlmICggdGNsYXNzICYmIHRjbGFzcyAhPT0gIm5vbmUiICkgewoJCQkJLy8gdXNlIGFwcHJvcHJpYXRlIHNsaWRlIGZvciBoZWFkZXIgb3IgZm9vdGVyCgkJCQlpZiAoIHRjbGFzcyA9PT0gInNsaWRlIiApIHsKCQkJCQl0Y2xhc3MgPSB0aGlzLmVsZW1lbnQuaGFzQ2xhc3MoICJ1aS1oZWFkZXIiICkgPyAic2xpZGVkb3duIiA6ICJzbGlkZXVwIjsKCQkJCX0KCgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRjbGFzcyApOwoJCQl9CgkJfSwKCgkJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk6IHRoaXMuZG9jdW1lbnQ7CgkJCS8vcGFnZSBldmVudCBiaW5kaW5ncwoJCQkvLyBGaXhlZCB0b29sYmFycyByZXF1aXJlIHBhZ2Ugem9vbSB0byBiZSBkaXNhYmxlZCwgb3RoZXJ3aXNlIHVzYWJpbGl0eSBpc3N1ZXMgY3JvcCB1cAoJCQkvLyBUaGlzIG1ldGhvZCBpcyBtZWFudCB0byBkaXNhYmxlIHpvb20gd2hpbGUgYSBmaXhlZC1wb3NpdGlvbmVkIHRvb2xiYXIgcGFnZSBpcyB2aXNpYmxlCgkJCXRoaXMuX29uKCBwYWdlICwgewoJCQkJInBhZ2ViZWZvcmVzaG93IjogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIsCgkJCQkid2Via2l0QW5pbWF0aW9uU3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJImFuaW1hdGlvbnN0YXJ0IjoiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJ1cGRhdGVsYXlvdXQiOiAiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJwYWdlc2hvdyI6ICJfaGFuZGxlUGFnZVNob3ciLAoJCQkJInBhZ2ViZWZvcmVoaWRlIjogIl9oYW5kbGVQYWdlQmVmb3JlSGlkZSIKCQkJfSk7CgkJfSwKCgkJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbiggKSB7CgkJCXZhciBvID0gdGhpcy5vcHRpb25zOwoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQkJaWYgKCAhby52aXNpYmxlT25QYWdlU2hvdyApIHsKCQkJCXRoaXMuaGlkZSggdHJ1ZSApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZUFuaW1hdGlvblN0YXJ0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMudXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLnVwZGF0ZVBhZ2VQYWRkaW5nKCAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogIi51aS1wYWdlLWFjdGl2ZSIgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlU2hvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgeyAidGhyb3R0bGVkcmVzaXplIjogInVwZGF0ZVBhZ2VQYWRkaW5nIiB9ICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCQl0aGlzRm9vdGVyLCB0aGlzSGVhZGVyLCBuZXh0Rm9vdGVyLCBuZXh0SGVhZGVyOwoKCQkJaWYgKCBvLmRpc2FibGVQYWdlWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCX0KCQkJaWYgKCBvLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb2ZmKCB0aGlzLndpbmRvdywgInRocm90dGxlZHJlc2l6ZSIgKTsKCQkJfQoKCQkJaWYgKCBvLnRyYWNrUGVyc2lzdGVudFRvb2xiYXJzICkgewoJCQkJdGhpc0Zvb3RlciA9ICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcy5wYWdlICk7CgkJCQl0aGlzSGVhZGVyID0gJCggIi51aS1oZWFkZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLnBhZ2UgKTsKCQkJCW5leHRGb290ZXIgPSB0aGlzRm9vdGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0Zvb3Rlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApIHx8ICQoKTsKCQkJCW5leHRIZWFkZXIgPSB0aGlzSGVhZGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0hlYWRlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApIHx8ICQoKTsKCgkJCQlpZiAoIG5leHRGb290ZXIubGVuZ3RoIHx8IG5leHRIZWFkZXIubGVuZ3RoICkgewoKCQkJCQluZXh0Rm9vdGVyLmFkZCggbmV4dEhlYWRlciApLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQkJCXVpLm5leHRQYWdlLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCW5leHRIZWFkZXIucHJlcGVuZFRvKCB0aGlzICk7CgkJCQkJCW5leHRGb290ZXIuYXBwZW5kVG8oIHRoaXMgKTsKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCX0sCgoJCV92aXNpYmxlOiB0cnVlLAoKCQkvLyBUaGlzIHdpbGwgc2V0IHRoZSBjb250ZW50IGVsZW1lbnQncyB0b3Agb3IgYm90dG9tIHBhZGRpbmcgZXF1YWwgdG8gdGhlIHRvb2xiYXIncyBoZWlnaHQKCQl1cGRhdGVQYWdlUGFkZGluZzogZnVuY3Rpb24oIHRiUGFnZSApIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICggdGhpcy5yb2xlID09PSJoZWFkZXIiICksCgkJCQlwb3MgPSBwYXJzZUZsb2F0KCAkZWwuY3NzKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICkgKTsKCgkJCS8vIFRoaXMgYmVoYXZpb3Igb25seSBhcHBsaWVzIHRvICJmaXhlZCIsIG5vdCAiZnVsbHNjcmVlbiIKCQkJaWYgKCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiApIHsgcmV0dXJuOyB9CgkJCS8vIHRiUGFnZSBhcmd1bWVudCBjYW4gYmUgYSBQYWdlIG9iamVjdCBvciBhbiBldmVudCwgaWYgY29taW5nIGZyb20gdGhyb3R0bGVkIHJlc2l6ZS4KCQkJdGJQYWdlID0gKCB0YlBhZ2UgJiYgdGJQYWdlLnR5cGUgPT09IHVuZGVmaW5lZCAmJiB0YlBhZ2UgKSB8fCB0aGlzLnBhZ2UgfHwgJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJdGJQYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICIudWktcGFnZS1hY3RpdmUiOwoJCQkkKCB0YlBhZ2UgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgJGVsLm91dGVySGVpZ2h0KCkgKyBwb3MgKTsKCQl9LAoKCQlfdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyICR3aW4gPSB0aGlzLndpbmRvdywKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCXNjcm9sbCA9ICR3aW4uc2Nyb2xsVG9wKCksCgkJCQllbEhlaWdodCA9ICRlbC5oZWlnaHQoKSwKCQkJCXBIZWlnaHQgPSAoICEhdGhpcy5wYWdlICk/ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuaGVpZ2h0KCk6JCgiLnVpLXBhZ2UtYWN0aXZlIikuaGVpZ2h0KCksCgkJCQl2aWV3cG9ydEhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJcmV0dXJuICFub3RyYW5zaXRpb24gJiYKCQkJCSggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gJiYgdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gIT09ICJub25lIiAmJgoJCQkJKAoJCQkJCSggdGhpcy5yb2xlID09PSAiaGVhZGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsID4gZWxIZWlnaHQgKSB8fAoJCQkJCSggdGhpcy5yb2xlID09PSAiZm9vdGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsICsgdmlld3BvcnRIZWlnaHQgPCBwSGVpZ2h0IC0gZWxIZWlnaHQgKQoJCQkJKSB8fCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbgoJCQkJKTsKCQl9LAoKCQlzaG93OiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0ICIgKyBoaWRlQ2xhc3MgKQoJCQkJCS5hZGRDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uICgpIHsKCQkJCQkJJGVsLnJlbW92ZUNsYXNzKCAiaW4iICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwucmVtb3ZlQ2xhc3MoIGhpZGVDbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSB0cnVlOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCS8vIGlmIGl0J3MgYSBzbGlkZSB0cmFuc2l0aW9uLCBvdXIgbmV3IHRyYW5zaXRpb25zIG5lZWQgdGhlIHJldmVyc2UgY2xhc3MgYXMgd2VsbCB0byBzbGlkZSBvdXR3YXJkCgkJCQlvdXRjbGFzcyA9ICJvdXQiICsgKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiA9PT0gInNsaWRlIiA/ICIgcmV2ZXJzZSIgOiAiIiApOwoKCQkJaWYgKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5hZGRDbGFzcyggb3V0Y2xhc3MgKQoJCQkJCS5yZW1vdmVDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uKCkgewoJCQkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gZmFsc2U7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQkJdGhpc1sgdGhpcy5fdmlzaWJsZSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJfSwKCgkJX2JpbmRUb2dnbGVIYW5kbGVyczogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQlkZWxheVNob3csIGRlbGF5SGlkZSwKCQkJCWlzVmlzaWJsZSA9IHRydWUsCgkJCQlwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICQoIi51aS1wYWdlIik7CgoJCQkvLyB0YXAgdG9nZ2xlCgkJCXBhZ2UKCQkJCS5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJaWYgKCBvLnRhcFRvZ2dsZSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCBvLnRhcFRvZ2dsZUJsYWNrbGlzdCApLmxlbmd0aCApIHsKCQkJCQkJc2VsZi50b2dnbGUoKTsKCQkJCQl9CgkJCQl9KQoJCQkJLmJpbmQoICJmb2N1c2luIGZvY3Vzb3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJLy90aGlzIGhpZGVzIHRoZSB0b29sYmFycyBvbiBhIGtleWJvYXJkIHBvcCB0byBnaXZlIG1vcmUgc2NyZWVuIHJvb20gYW5kIHByZXZlbnQgaW9zIGJ1ZyB3aGljaAoJCQkJCS8vcG9zaXRpb25zIGZpeGVkIHRvb2xiYXJzIGluIHRoZSBtaWRkbGUgb2YgdGhlIHNjcmVlbiBvbiBwb3AgaWYgdGhlIGlucHV0IGlzIG5lYXIgdGhlIHRvcCBvcgoJCQkJCS8vYm90dG9tIG9mIHRoZSBzY3JlZW4gYWRkcmVzc2VzIGlzc3VlcyAjNDQxMCBGb290ZXIgbmF2YmFyIG1vdmVzIHVwIHdoZW4gY2xpY2tpbmcgb24gYSB0ZXh0Ym94IGluIGFuIEFuZHJvaWQgZW52aXJvbm1lbnQKCQkJCQkvL2FuZCBpc3N1ZSAjNDExMyBIZWFkZXIgYW5kIGZvb3RlciBjaGFuZ2UgdGhlaXIgcG9zaXRpb24gYWZ0ZXIga2V5Ym9hcmQgcG9wdXAgLSBpT1MKCQkJCQkvL2FuZCBpc3N1ZSAjNDQxMCBGb290ZXIgbmF2YmFyIG1vdmVzIHVwIHdoZW4gY2xpY2tpbmcgb24gYSB0ZXh0Ym94IGluIGFuIEFuZHJvaWQgZW52aXJvbm1lbnQKCQkJCQlpZiAoIHNjcmVlbi53aWR0aCA8IDEwMjUgJiYgJCggZS50YXJnZXQgKS5pcyggby5oaWRlRHVyaW5nRm9jdXMgKSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCIgKS5sZW5ndGggKSB7CgkJCQkJCS8vRml4IGZvciBpc3N1ZSAjNDcyNCBNb3ZpbmcgdGhyb3VnaCBmb3JtIGluIE1vYmlsZSBTYWZhcmkgd2l0aCAiTmV4dCIgYW5kICJQcmV2aW91cyIgc3lzdGVtCgkJCQkJCS8vY29udHJvbHMgY2F1c2VzIGZpeGVkIHBvc2l0aW9uLCB0YXAtdG9nZ2xlIGZhbHNlIEhlYWRlciB0byByZXZlYWwgaXRzZWxmCgkJCQkJCS8vIGlzVmlzaWJsZSBpbnN0ZWFkIG9mIHNlbGYuX3Zpc2libGUgYmVjYXVzZSB0aGUgZm9jdXNpbiBhbmQgZm9jdXNvdXQgZXZlbnRzIGZpcmUgdHdpY2UgYXQgdGhlIHNhbWUgdGltZQoJCQkJCQkvLyBBbHNvIHVzZSBhIGRlbGF5IGZvciBoaWRpbmcgdGhlIHRvb2xiYXJzIGJlY2F1c2Ugb24gQW5kcm9pZCBuYXRpdmUgYnJvd3NlciBmb2N1c2luIGlzIGRpcmVjbHR5IGZvbGxvd2VkCgkJCQkJCS8vIGJ5IGEgZm9jdXNvdXQgd2hlbiBhIG5hdGl2ZSBzZWxlY3RzIG9wZW5zIGFuZCB0aGUgb3RoZXIgd2F5IGFyb3VuZCB3aGVuIGl0IGNsb3Nlcy4KCQkJCQkJaWYgKCBlLnR5cGUgPT09ICJmb2N1c291dCIgJiYgIWlzVmlzaWJsZSApIHsKCQkJCQkJCWlzVmlzaWJsZSA9IHRydWU7CgkJCQkJCQkvL3dhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYW5kIHNlZSBpZiB3ZSBoYXZlIGp1bXBlZCB0byBhbm90aGVyIGlucHV0CgkJCQkJCQljbGVhclRpbWVvdXQoIGRlbGF5SGlkZSApOwoJCQkJCQkJZGVsYXlTaG93ID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkJc2VsZi5zaG93KCk7CgkJCQkJCQl9LCAwICk7CgkJCQkJCX0gZWxzZSBpZiAoIGUudHlwZSA9PT0gImZvY3VzaW4iICYmICEhaXNWaXNpYmxlICkgewoJCQkJCQkJLy9pZiB3ZSBoYXZlIGp1bXBlZCB0byBhbm90aGVyIGlucHV0IGNsZWFyIHRoZSB0aW1lIG91dCB0byBjYW5jZWwgdGhlIHNob3cuCgkJCQkJCQljbGVhclRpbWVvdXQoIGRlbGF5U2hvdyApOwoJCQkJCQkJaXNWaXNpYmxlID0gZmFsc2U7CgkJCQkJCQlkZWxheUhpZGUgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLmhpZGUoKTsKCQkJCQkJCX0sIDAgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pOwoJCX0sCgoJCV9zZXRSZWxhdGl2ZTogZnVuY3Rpb24oKSB7CgkJCWlmKCB0aGlzLm9wdGlvbnMucG9zaXRpb24gIT09ICJmaXhlZCIgKXsKCQkJCSQoICJbZGF0YS0iKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJ10iICkuY3NzKHsgInBvc2l0aW9uIjogInJlbGF0aXZlIiB9KTsKCQkJfQoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5oYXNDbGFzcyggInVpLWhlYWRlciIgKTsKCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICIiICk7CgkJCSRlbC5yZW1vdmVDbGFzcyggInVpLWhlYWRlci1maXhlZCB1aS1mb290ZXItZml4ZWQgdWktaGVhZGVyLWZ1bGxzY3JlZW4gdWktZm9vdGVyLWZ1bGxzY3JlZW4gaW4gb3V0IGZhZGUgc2xpZGVkb3duIHNsaWRldXAgdWktZml4ZWQtaGlkZGVuIiApOwoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLnJlbW92ZUNsYXNzKCAidWktcGFnZS1oZWFkZXItZml4ZWQgdWktcGFnZS1mb290ZXItZml4ZWQgdWktcGFnZS1oZWFkZXItZnVsbHNjcmVlbiB1aS1wYWdlLWZvb3Rlci1mdWxsc2NyZWVuIiApOwoJCX0KCgl9KTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgJC5tb2JpbGUudG9vbGJhciwgewoKCQlfbWFrZUZpeGVkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJdGhpcy5fd29ya2Fyb3VuZHMoKTsKCQl9LAoKCQkvL2NoZWNrIHRoZSBicm93c2VyIGFuZCB2ZXJzaW9uIGFuZCBydW4gbmVlZGVkIHdvcmthcm91bmRzCgkJX3dvcmthcm91bmRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJb3MgPSBudWxsLAoJCQlzZWxmID0gdGhpczsKCQkJLy9zZXQgdGhlIG9zIHdlIGFyZSB3b3JraW5nIGluIGlmIGl0IGRvc2VudCBtYXRjaCBvbmUgd2l0aCB3b3JrYXJvdW5kcyByZXR1cm4KCQkJaWYgKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApIHsKCQkJCW9zID0gImlvcyI7CgkJCX0gZWxzZSBpZiAoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgKSB7CgkJCQlvcyA9ICJhbmRyb2lkIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvL2NoZWNrIG9zIHZlcnNpb24gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQlpZiAoIG9zID09PSAiaW9zIiApIHsKCQkJCS8vaU9TICB3b3JrYXJvdW5kcwoJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJfSBlbHNlIGlmICggb3MgPT09ICJhbmRyb2lkIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkgewoJCQkJLy9BbmRyb2lkIDIuMyBydW4gYWxsIEFuZHJvaWQgMi4zIHdvcmthcm91bmQKCQkJCXNlbGYuX2JpbmRTY3JvbGxXb3JrYXJvdW5kKCk7CgkJCQlzZWxmLl9iaW5kTGlzdFRodW1iV29ya2Fyb3VuZCgpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuOwoJCQl9CgkJfSwKCgkJLy9VdGlsaXR5IGNsYXNzIGZvciBjaGVja2luZyBoZWFkZXIgYW5kIGZvb3RlciBwb3NpdGlvbnMgcmVsYXRpdmUgdG8gdmlld3BvcnQKCQlfdmlld3BvcnRPZmZzZXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmhhc0NsYXNzKCAidWktaGVhZGVyIiApLAoJCQkJb2Zmc2V0ID0gTWF0aC5hYnMoICRlbC5vZmZzZXQoKS50b3AgLSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKSApOwoJCQlpZiAoICFoZWFkZXIgKSB7CgkJCQlvZmZzZXQgPSBNYXRoLnJvdW5kKCBvZmZzZXQgLSB0aGlzLndpbmRvdy5oZWlnaHQoKSArICRlbC5vdXRlckhlaWdodCgpICkgLSA2MDsKCQkJfQoJCQlyZXR1cm4gb2Zmc2V0OwoJCX0sCgoJCS8vYmluZCBldmVudHMgZm9yIF90cmlnZ2VyUmVkcmF3KCkgZnVuY3Rpb24KCQlfYmluZFNjcm9sbFdvcmthcm91bmQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCS8vYmluZCB0byBzY3JvbGxzdG9wIGFuZCBjaGVjayBpZiB0aGUgdG9vbGJhcnMgYXJlIGNvcnJlY3RseSBwb3NpdGlvbmVkCgkJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgeyBzY3JvbGxzdG9wOiBmdW5jdGlvbigpIHsKCQkJCXZhciB2aWV3cG9ydE9mZnNldCA9IHNlbGYuX3ZpZXdwb3J0T2Zmc2V0KCk7CgkJCQkvL2NoZWNrIGlmIHRoZSBoZWFkZXIgaXMgdmlzaWJsZSBhbmQgaWYgaXRzIGluIHRoZSByaWdodCBwbGFjZQoJCQkJaWYgKCB2aWV3cG9ydE9mZnNldCA+IDIgJiYgc2VsZi5fdmlzaWJsZSApIHsKCQkJCQlzZWxmLl90cmlnZ2VyUmVkcmF3KCk7CgkJCQl9CgkJCX19KTsKCQl9LAoKCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlICM0MjUwIFBlcnNpc3RlbnQgZm9vdGVyIGluc3RhYmlsaXR5IGluIHYxLjEgd2l0aCBsb25nIHNlbGVjdCBsaXN0cyBpbiBBbmRyb2lkIDIuMy4zCgkJLy9hbmQgaXNzdWUgIzM3NDggQW5kcm9pZCAyLng6IFBhZ2UgdHJhbnNpdGlvbnMgYnJva2VuIHdoZW4gZml4ZWQgdG9vbGJhcnMgdXNlZAoJCS8vdGhlIGFic29sdXRlbHkgcG9zaXRpb25lZCB0aHVtYm5haWwgaW4gYSBsaXN0IHZpZXcgY2F1c2VzIHByb2JsZW1zIHdpdGggZml4ZWQgcG9zaXRpb24gYnV0dG9ucyBhYm92ZSBpbiBhIG5hdiBiYXIKCQkvL3NldHRpbmcgdGhlIGxpJ3MgdG8gLXdlYmtpdC10cmFuc2Zvcm06dHJhbnNsYXRlM2QoMCwwLDApOyBzb2x2ZXMgdGhpcyBwcm9ibGVtIHRvIGF2b2lkZSBwb3RlbnRpYWwgaXNzdWVzIGluIG90aGVyCgkJLy9wbGF0Zm9ybXMgd2Ugc2NvcGUgdGhpcyB3aXRoIHRoZSBjbGFzcyB1aS1hbmRyb2lkLTJ4LWZpeAoJCV9iaW5kTGlzdFRodW1iV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1hbmRyb2lkLTJ4LWZpeGVkIiApOwoJCX0sCgkJLy90aGlzIGFkZHJlc3NlcyBpc3N1ZXMgIzQzMzcgRml4ZWQgaGVhZGVyIHByb2JsZW0gYWZ0ZXIgc2Nyb2xsaW5nIGNvbnRlbnQgb24gaU9TIGFuZCBBbmRyb2lkCgkJLy9hbmQgZGV2aWNlIGJ1Z3MgcHJvamVjdCBpc3N1ZSAjMSBGb3JtIGVsZW1lbnRzIGNhbiBsb3NlIGNsaWNrIGhpdCBhcmVhIGluIHBvc2l0aW9uOiBmaXhlZCBjb250YWluZXJzLgoJCS8vdGhpcyBhbHNvIGFkZHJlc3NlcyBub3Qgb24gZml4ZWQgdG9vbGJhcnMgcGFnZSBpbiBkb2NzCgkJLy9hZGRpbmcgMXB4IG9mIHBhZGRpbmcgdG8gdGhlIGJvdHRvbSB0aGVuIHJlbW92aW5nIGl0IGNhdXNlcyBhICJyZWRyYXciCgkJLy93aGljaCBwb3NpdGlvbnMgdGhlIHRvb2xiYXJzIGNvcnJlY3RseSAodGhleSB3aWxsIGFsd2F5cyBiZSB2aXN1YWxseSBjb3JyZWN0KQoJCV90cmlnZ2VyUmVkcmF3OiBmdW5jdGlvbigpIHsKCQkJdmFyIHBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCAkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiApICk7CgkJCS8vdHJpZ2dlciBwYWdlIHJlZHJhdyB0byBmaXggaW5jb3JyZWN0bHkgcG9zaXRpb25lZCBmaXhlZCBlbGVtZW50cwoJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiwgKCBwYWRkaW5nQm90dG9tICsgMSApICsgInB4IiApOwoJCQkvL2lmIHRoZSBwYWRkaW5nIGlzIHJlc2V0IHdpdGggb3V0IGEgdGltZW91dCB0aGUgcmVwb3NpdGlvbiB3aWxsIG5vdCBvY2N1cmUuCgkJCS8vdGhpcyBpcyBpbmRlcGVuZGFudCBvZiBKUU0gdGhlIGJyb3dzZXIgc2VlbXMgdG8gbmVlZCB0aGUgdGltZSB0byByZWFjdC4KCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiwgcGFkZGluZ0JvdHRvbSArICJweCIgKTsKCQkJfSwgMCApOwoJCX0sCgoJCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQkvL1JlbW92ZSB0aGUgY2xhc3Mgd2UgYWRkZWQgdG8gdGhlIHBhZ2UgcHJldmlvdXNseSBpbiBhbmRyb2lkIDIueAoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlLWFjdGl2ZSIgKS5yZW1vdmVDbGFzcyggInVpLWFuZHJvaWQtMngtZml4IiApOwoJCX0KCX0pOwoKfSkoIGpRdWVyeSApOwoKCiggZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBpZUhhY2sgPSAoICQubW9iaWxlLmJyb3dzZXIub2xkSUUgJiYgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSA8PSA4ICksCgl1aVRlbXBsYXRlID0gJCgKCQkiPGRpdiBjbGFzcz0ndWktcG9wdXAtYXJyb3ctZ3VpZGUnPjwvZGl2PiIgKwoJCSI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1hcnJvdy1jb250YWluZXIiICsgKCBpZUhhY2sgPyAiIGllIiA6ICIiICkgKyAiJz4iICsKCQkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93Jz48L2Rpdj4iICsKCQkiPC9kaXY+IgoJKTsKCmZ1bmN0aW9uIGdldEFycm93KCkgewoJdmFyIGNsb25lID0gdWlUZW1wbGF0ZS5jbG9uZSgpLAoJCWdkID0gY2xvbmUuZXEoIDAgKSwKCQljdCA9IGNsb25lLmVxKCAxICksCgkJYXIgPSBjdC5jaGlsZHJlbigpOwoKCXJldHVybiB7IGFyRWxzOiBjdC5hZGQoIGdkICksIGdkOiBnZCwgY3Q6IGN0LCBhcjogYXIgfTsKfQoKJC53aWRnZXQoICJtb2JpbGUucG9wdXAiLCAkLm1vYmlsZS5wb3B1cCwgewoJb3B0aW9uczogewoKCQlhcnJvdzogIiIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyLAoJCQlyZXQgPSB0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5hcnJvdyApIHsKCQkJdGhpcy5fdWkuYXJyb3cgPSBhciA9IHRoaXMuX2FkZEFycm93KCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfYWRkQXJyb3c6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGVtZSwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJYXIgPSBnZXRBcnJvdygpOwoKCQl0aGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvcHRzLnRoZW1lICk7CgkJYXIuYXIuYWRkQ2xhc3MoIHRoZW1lICsgKCBvcHRzLnNoYWRvdyA/ICIgdWktb3ZlcmxheS1zaGFkb3ciIDogIiIgKSApOwoJCWFyLmFyRWxzLmhpZGUoKS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCXJldHVybiBhcjsKCX0sCgoJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9LAoKCS8vIFByZXRlbmQgdG8gc2hvdyBhbiBhcnJvdyBkZXNjcmliZWQgYnkgQHAgYW5kIEBkaXIgYW5kIGNhbGN1bGF0ZSB0aGUKCS8vIGRpc3RhbmNlIGZyb20gdGhlIGRlc2lyZWQgcG9pbnQuIElmIGEgYmVzdC1kaXN0YW5jZSBpcyBwYXNzZWQgaW4sIHJldHVybgoJLy8gdGhlIG1pbmltdW0gb2YgdGhlIG9uZSBwYXNzZWQgaW4gYW5kIHRoZSBvbmUgY2FsY3VsYXRlZC4KCV90cnlBbkFycm93OiBmdW5jdGlvbiggcCwgZGlyLCBkZXNpcmVkLCBzLCBiZXN0ICkgewoJCXZhciByZXN1bHQsIHIsIGRpZmYsIGRlc2lyZWRGb3JBcnJvdyA9IHt9LCB0aXAgPSB7fTsKCgkJLy8gSWYgdGhlIGFycm93IGhhcyBubyB3aWdnbGUgcm9vbSBhbG9uZyB0aGUgZWRnZSBvZiB0aGUgcG9wdXAsIGl0IGNhbm5vdAoJCS8vIGJlIGRpc3BsYXllZCBhbG9uZyB0aGUgcmVxdWVzdGVkIGVkZ2Ugd2l0aG91dCBpdCBzdGlja2luZyBvdXQuCgkJaWYgKCBzLmFyRnVsbFsgcC5kaW1LZXkgXSA+IHMuZ3VpZGVEaW1zWyBwLmRpbUtleSBdICkgewoJCQlyZXR1cm4gYmVzdDsKCQl9CgoJCWRlc2lyZWRGb3JBcnJvd1sgcC5mc3QgXSA9IGRlc2lyZWRbIHAuZnN0IF0gKwoJCQkoIHMuYXJIYWxmWyBwLm9EaW1LZXkgXSArIHMubWVudUhhbGZbIHAub0RpbUtleSBdICkgKiBwLm9mZnNldEZhY3RvciAtCgkJCXMuY29udGVudEJveFsgcC5mc3QgXSArICggcy5jbGFtcEluZm8ubWVudVNpemVbIHAub0RpbUtleSBdIC0gcy5jb250ZW50Qm94WyBwLm9EaW1LZXkgXSApICogcC5hcnJvd09mZnNldEZhY3RvcjsKCQlkZXNpcmVkRm9yQXJyb3dbIHAuc25kIF0gPSBkZXNpcmVkWyBwLnNuZCBdOwoKCQlyZXN1bHQgPSBzLnJlc3VsdCB8fCB0aGlzLl9jYWxjdWxhdGVGaW5hbExvY2F0aW9uKCBkZXNpcmVkRm9yQXJyb3csIHMuY2xhbXBJbmZvICk7CgkJciA9IHsgeDogcmVzdWx0LmxlZnQsIHk6IHJlc3VsdC50b3AgfTsKCgkJdGlwWyBwLmZzdCBdID0gclsgcC5mc3QgXSArIHMuY29udGVudEJveFsgcC5mc3QgXSArIHAudGlwT2Zmc2V0OwoJCXRpcFsgcC5zbmQgXSA9IE1hdGgubWF4KCByZXN1bHRbIHAucHJvcCBdICsgcy5ndWlkZU9mZnNldFsgcC5wcm9wIF0gKyBzLmFySGFsZlsgcC5kaW1LZXkgXSwKCQkJTWF0aC5taW4oIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmd1aWRlT2Zmc2V0WyBwLnByb3AgXSArIHMuZ3VpZGVEaW1zWyBwLmRpbUtleSBdIC0gcy5hckhhbGZbIHAuZGltS2V5IF0sCgkJCQlkZXNpcmVkWyBwLnNuZCBdICkgKTsKCgkJZGlmZiA9IE1hdGguYWJzKCBkZXNpcmVkLnggLSB0aXAueCApICsgTWF0aC5hYnMoIGRlc2lyZWQueSAtIHRpcC55ICk7CgkJaWYgKCAhYmVzdCB8fCBkaWZmIDwgYmVzdC5kaWZmICkgewoJCQkvLyBDb252ZXJ0IHRpcCBvZmZzZXQgdG8gY29vcmRpbmF0ZXMgaW5zaWRlIHRoZSBwb3B1cAoJCQl0aXBbIHAuc25kIF0gLT0gcy5hckhhbGZbIHAuZGltS2V5IF0gKyByZXN1bHRbIHAucHJvcCBdICsgcy5jb250ZW50Qm94WyBwLnNuZCBdOwoJCQliZXN0ID0geyBkaXI6IGRpciwgZGlmZjogZGlmZiwgcmVzdWx0OiByZXN1bHQsIHBvc1Byb3A6IHAucHJvcCwgcG9zVmFsOiB0aXBbIHAuc25kIF0gfTsKCQl9CgoJCXJldHVybiBiZXN0OwoJfSwKCglfZ2V0UGxhY2VtZW50U3RhdGU6IGZ1bmN0aW9uKCBjbGFtcCApIHsKCQl2YXIgb2Zmc2V0LCBnZE9mZnNldCwKCQkJYXIgPSB0aGlzLl91aS5hcnJvdywKCQkJc3RhdGUgPSB7CgkJCQljbGFtcEluZm86IHRoaXMuX2NsYW1wUG9wdXBXaWR0aCggIWNsYW1wICksCgkJCQlhckZ1bGw6IHsgY3g6IGFyLmN0LndpZHRoKCksIGN5OiBhci5jdC5oZWlnaHQoKSB9LAoJCQkJZ3VpZGVEaW1zOiB7IGN4OiBhci5nZC53aWR0aCgpLCBjeTogYXIuZ2QuaGVpZ2h0KCkgfSwKCQkJCWd1aWRlT2Zmc2V0OiBhci5nZC5vZmZzZXQoKQoJCQl9OwoKCQlvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCk7CgoJCWFyLmdkLmNzcyggeyBsZWZ0OiAwLCB0b3A6IDAsIHJpZ2h0OiAwLCBib3R0b206IDAgfSApOwoJCWdkT2Zmc2V0ID0gYXIuZ2Qub2Zmc2V0KCk7CgkJc3RhdGUuY29udGVudEJveCA9IHsKCQkJeDogZ2RPZmZzZXQubGVmdCAtIG9mZnNldC5sZWZ0LAoJCQl5OiBnZE9mZnNldC50b3AgLSBvZmZzZXQudG9wLAoJCQljeDogYXIuZ2Qud2lkdGgoKSwKCQkJY3k6IGFyLmdkLmhlaWdodCgpCgkJfTsKCQlhci5nZC5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgoJCS8vIFRoZSBhcnJvdyBib3ggbW92ZXMgYmV0d2VlbiBndWlkZU9mZnNldCBhbmQgZ3VpZGVPZmZzZXQgKyBndWlkZURpbXMgLSBhckZ1bGwKCQlzdGF0ZS5ndWlkZU9mZnNldCA9IHsgbGVmdDogc3RhdGUuZ3VpZGVPZmZzZXQubGVmdCAtIG9mZnNldC5sZWZ0LCB0b3A6IHN0YXRlLmd1aWRlT2Zmc2V0LnRvcCAtIG9mZnNldC50b3AgfTsKCQlzdGF0ZS5hckhhbGYgPSB7IGN4OiBzdGF0ZS5hckZ1bGwuY3ggLyAyLCBjeTogc3RhdGUuYXJGdWxsLmN5IC8gMiB9OwoJCXN0YXRlLm1lbnVIYWxmID0geyBjeDogc3RhdGUuY2xhbXBJbmZvLm1lbnVTaXplLmN4IC8gMiwgY3k6IHN0YXRlLmNsYW1wSW5mby5tZW51U2l6ZS5jeSAvIDIgfTsKCgkJcmV0dXJuIHN0YXRlOwoJfSwKCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQl2YXIgc3RhdGUsIGJlc3QsIHBhcmFtcywgZWxPZmZzZXQsIGJnUmVmLAoJCQlvcHRpb25WYWx1ZSA9IHRoaXMub3B0aW9ucy5hcnJvdywKCQkJYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCAhYXIgKSB7CgkJCXJldHVybiB0aGlzLl9zdXBlciggZGVzaXJlZCApOwoJCX0KCgkJYXIuYXJFbHMuc2hvdygpOwoKCQliZ1JlZiA9IHt9OwoJCXN0YXRlID0gdGhpcy5fZ2V0UGxhY2VtZW50U3RhdGUoIHRydWUgKTsKCQlwYXJhbXMgPSB7CgkJCSJsIjogeyBmc3Q6ICJ4Iiwgc25kOiAieSIsIHByb3A6ICJ0b3AiLCBkaW1LZXk6ICJjeSIsIG9EaW1LZXk6ICJjeCIsIG9mZnNldEZhY3RvcjogMSwgdGlwT2Zmc2V0OiAgLXN0YXRlLmFySGFsZi5jeCwgYXJyb3dPZmZzZXRGYWN0b3I6IDAgfSwKCQkJInIiOiB7IGZzdDogIngiLCBzbmQ6ICJ5IiwgcHJvcDogInRvcCIsIGRpbUtleTogImN5Iiwgb0RpbUtleTogImN4Iiwgb2Zmc2V0RmFjdG9yOiAtMSwgdGlwT2Zmc2V0OiBzdGF0ZS5hckhhbGYuY3ggKyBzdGF0ZS5jb250ZW50Qm94LmN4LCBhcnJvd09mZnNldEZhY3RvcjogMSB9LAoJCQkiYiI6IHsgZnN0OiAieSIsIHNuZDogIngiLCBwcm9wOiAibGVmdCIsIGRpbUtleTogImN4Iiwgb0RpbUtleTogImN5Iiwgb2Zmc2V0RmFjdG9yOiAtMSwgdGlwT2Zmc2V0OiBzdGF0ZS5hckhhbGYuY3kgKyBzdGF0ZS5jb250ZW50Qm94LmN5LCBhcnJvd09mZnNldEZhY3RvcjogMSB9LAoJCQkidCI6IHsgZnN0OiAieSIsIHNuZDogIngiLCBwcm9wOiAibGVmdCIsIGRpbUtleTogImN4Iiwgb0RpbUtleTogImN5Iiwgb2Zmc2V0RmFjdG9yOiAxLCB0aXBPZmZzZXQ6IC1zdGF0ZS5hckhhbGYuY3ksIGFycm93T2Zmc2V0RmFjdG9yOiAwIH0KCQl9OwoKCQkvLyBUcnkgZWFjaCBzaWRlIHNwZWNpZmllZCBpbiB0aGUgb3B0aW9ucyB0byBzZWUgb24gd2hpY2ggb25lIHRoZSBhcnJvdwoJCS8vIHNob3VsZCBiZSBwbGFjZWQgc3VjaCB0aGF0IHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSB0aXAgb2YgdGhlIGFycm93IGFuZAoJCS8vIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzIGlzIHRoZSBzaG9ydGVzdC4KCQkkLmVhY2goICggb3B0aW9uVmFsdWUgPT09IHRydWUgPyAibCx0LHIsYiIgOiBvcHRpb25WYWx1ZSApLnNwbGl0KCAiLCIgKSwKCQkJJC5wcm94eSggZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQliZXN0ID0gdGhpcy5fdHJ5QW5BcnJvdyggcGFyYW1zWyB2YWx1ZSBdLCB2YWx1ZSwgZGVzaXJlZCwgc3RhdGUsIGJlc3QgKTsKCQkJfSwgdGhpcyApICk7CgoJCS8vIENvdWxkIG5vdCBwbGFjZSB0aGUgYXJyb3cgYWxvbmcgYW55IG9mIHRoZSBlZGdlcyAtIGJlaGF2ZSBhcyBpZiBzaG93aW5nCgkJLy8gdGhlIGFycm93IHdhcyB0dXJuZWQgb2ZmLgoJCWlmICggIWJlc3QgKSB7CgkJCWFyLmFyRWxzLmhpZGUoKTsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBkZXNpcmVkICk7CgkJfQoKCQkvLyBNb3ZlIHRoZSBhcnJvdyBpbnRvIHBsYWNlCgkJYXIuY3QKCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtYXJyb3ctbCB1aS1wb3B1cC1hcnJvdy10IHVpLXBvcHVwLWFycm93LXIgdWktcG9wdXAtYXJyb3ctYiIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1hcnJvdy0iICsgYmVzdC5kaXIgKQoJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApLmNzcyggYmVzdC5wb3NQcm9wLCBiZXN0LnBvc1ZhbCApCgkJCS5zaG93KCk7CgoJCS8vIERvIG5vdCBtb3ZlL3NpemUgdGhlIGJhY2tncm91bmQgZGl2IG9uIElFLCBiZWNhdXNlIHdlIHVzZSB0aGUgYXJyb3cgZGl2IGZvciBiYWNrZ3JvdW5kIGFzIHdlbGwuCgkJaWYgKCAhaWVIYWNrICkgewoJCQllbE9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsKCQkJYmdSZWZbIHBhcmFtc1sgYmVzdC5kaXIgXS5mc3QgXSA9IGFyLmN0Lm9mZnNldCgpOwoJCQliZ1JlZlsgcGFyYW1zWyBiZXN0LmRpciBdLnNuZCBdID0gewoJCQkJbGVmdDogZWxPZmZzZXQubGVmdCArIHN0YXRlLmNvbnRlbnRCb3gueCwKCQkJCXRvcDogZWxPZmZzZXQudG9wICsgc3RhdGUuY29udGVudEJveC55CgkJCX07CgkJfQoKCQlyZXR1cm4gYmVzdC5yZXN1bHQ7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0cyApIHsKCQl2YXIgbmV3VGhlbWUsCgkJCW9sZFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lLAoJCQlhciA9IHRoaXMuX3VpLmFycm93LAoJCQlyZXQgPSB0aGlzLl9zdXBlciggb3B0cyApOwoKCQlpZiAoIG9wdHMuYXJyb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAhYXIgJiYgb3B0cy5hcnJvdyApIHsKCQkJCXRoaXMuX3VpLmFycm93ID0gdGhpcy5fYWRkQXJyb3coKTsKCgkJCQkvLyBJbXBvcnRhbnQgdG8gcmV0dXJuIGhlcmUgc28gd2UgZG9uJ3Qgc2V0IHRoZSBzYW1lIG9wdGlvbnMgYWxsIG92ZXIKCQkJCS8vIGFnYWluIGJlbG93LgoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgaWYgKCBhciAmJiAhb3B0cy5hcnJvdyApIHsKCQkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCQkJdGhpcy5fdWkuYXJyb3cgPSBudWxsOwoJCQl9CgkJfQoKCQkvLyBSZWFzc2lnbiB3aXRoIHBvdGVudGlhbGx5IG5ldyBhcnJvdwoJCWFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb2xkVGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgb2xkVGhlbWUgKTsKCQkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQkJCWFyLmFyLnJlbW92ZUNsYXNzKCBvbGRUaGVtZSApLmFkZENsYXNzKCBuZXdUaGVtZSApOwoJCQl9CgoJCQlpZiAoIG9wdHMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlhci5hci50b2dnbGVDbGFzcyggInVpLW92ZXJsYXktc2hhZG93Iiwgb3B0cy5zaGFkb3cgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHJldDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBhciA9IHRoaXMuX3VpLmFycm93OwoKCQlpZiAoIGFyICkgewoJCQlhci5hckVscy5yZW1vdmUoKTsKCQl9CgoJCXJldHVybiB0aGlzLl9zdXBlcigpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhbmVsIiwgewoJb3B0aW9uczogewoJCWNsYXNzZXM6IHsKCQkJcGFuZWw6ICJ1aS1wYW5lbCIsCgkJCXBhbmVsT3BlbjogInVpLXBhbmVsLW9wZW4iLAoJCQlwYW5lbENsb3NlZDogInVpLXBhbmVsLWNsb3NlZCIsCgkJCXBhbmVsRml4ZWQ6ICJ1aS1wYW5lbC1maXhlZCIsCgkJCXBhbmVsSW5uZXI6ICJ1aS1wYW5lbC1pbm5lciIsCgkJCW1vZGFsOiAidWktcGFuZWwtZGlzbWlzcyIsCgkJCW1vZGFsT3BlbjogInVpLXBhbmVsLWRpc21pc3Mtb3BlbiIsCgkJCXBhZ2VDb250YWluZXI6ICJ1aS1wYW5lbC1wYWdlLWNvbnRhaW5lciIsCgkJCXBhZ2VXcmFwcGVyOiAidWktcGFuZWwtd3JhcHBlciIsCgkJCXBhZ2VGaXhlZFRvb2xiYXI6ICJ1aS1wYW5lbC1maXhlZC10b29sYmFyIiwKCQkJcGFnZUNvbnRlbnRQcmVmaXg6ICJ1aS1wYW5lbC1wYWdlLWNvbnRlbnQiLCAvKiBVc2VkIGZvciB3cmFwcGVyIGFuZCBmaXhlZCB0b29sYmFycyBwb3NpdGlvbiwgZGlzcGxheSBhbmQgb3BlbiBjbGFzc2VzLiAqLwoJCQlhbmltYXRlOiAidWktcGFuZWwtYW5pbWF0ZSIKCQl9LAoJCWFuaW1hdGU6IHRydWUsCgkJdGhlbWU6IG51bGwsCgkJcG9zaXRpb246ICJsZWZ0IiwKCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCQlkaXNwbGF5OiAicmV2ZWFsIiwgLy9hY2NlcHRzIHJldmVhbCwgcHVzaCwgb3ZlcmxheQoJCXN3aXBlQ2xvc2U6IHRydWUsCgkJcG9zaXRpb25GaXhlZDogZmFsc2UKCX0sCgoJX2Nsb3NlTGluazogbnVsbCwKCV9wYXJlbnRQYWdlOiBudWxsLAoJX3BhZ2U6IG51bGwsCglfbW9kYWw6IG51bGwsCglfcGFuZWxJbm5lcjogbnVsbCwKCV93cmFwcGVyOiBudWxsLAoJX2ZpeGVkVG9vbGJhcnM6IG51bGwsCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gZWwuY2xvc2VzdCggIi51aS1wYWdlLCA6anFtRGF0YShyb2xlPSdwYWdlJykiICk7CgoJCS8vIGV4cG9zZSBzb21lIHByaXZhdGUgcHJvcHMgdG8gb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9jbG9zZUxpbms6IGVsLmZpbmQoICI6anFtRGF0YShyZWw9J2Nsb3NlJykiICksCgkJCV9wYXJlbnRQYWdlOiAoIHBhcmVudFBhZ2UubGVuZ3RoID4gMCApID8gcGFyZW50UGFnZSA6IGZhbHNlLAoJCQlfb3BlbmVkUGFnZTogbnVsbCwKCQkJX3BhZ2U6IHRoaXMuX2dldFBhZ2UsCgkJCV9wYW5lbElubmVyOiB0aGlzLl9nZXRQYW5lbElubmVyKCksCgkJCV9maXhlZFRvb2xiYXJzOiB0aGlzLl9nZXRGaXhlZFRvb2xiYXJzCgkJfSk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICl7CgkJCXRoaXMuX2dldFdyYXBwZXIoKTsKCQl9CgkJdGhpcy5fYWRkUGFuZWxDbGFzc2VzKCk7CgoJCS8vIGlmIGFuaW1hdGluZywgYWRkIHRoZSBjbGFzcyB0byBkbyBzbwoJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhdGhpcy5vcHRpb25zLmFuaW1hdGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCX0KCgkJdGhpcy5fYmluZFVwZGF0ZUxheW91dCgpOwoJCXRoaXMuX2JpbmRDbG9zZUV2ZW50cygpOwoJCXRoaXMuX2JpbmRMaW5rTGlzdGVuZXJzKCk7CgkJdGhpcy5fYmluZFBhZ2VFdmVudHMoKTsKCgkJaWYgKCAhIXRoaXMub3B0aW9ucy5kaXNtaXNzaWJsZSApIHsKCQkJdGhpcy5fY3JlYXRlTW9kYWwoKTsKCQl9CgoJCXRoaXMuX2JpbmRTd2lwZUV2ZW50cygpOwoJfSwKCglfZ2V0UGFuZWxJbm5lcjogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsSW5uZXIgPSB0aGlzLmVsZW1lbnQuZmluZCggIi4iICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciApOwoKCQlpZiAoIHBhbmVsSW5uZXIubGVuZ3RoID09PSAwICkgewoJCQlwYW5lbElubmVyID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCkud3JhcEFsbCggIjxkaXYgY2xhc3M9JyIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbElubmVyICsgIicgLz4iICkucGFyZW50KCk7CgkJfQoKCQlyZXR1cm4gcGFuZWxJbm5lcjsKCX0sCgoJX2NyZWF0ZU1vZGFsOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXRhcmdldCA9IHNlbGYuX3BhcmVudFBhZ2UgPyBzZWxmLl9wYXJlbnRQYWdlLnBhcmVudCgpIDogc2VsZi5lbGVtZW50LnBhcmVudCgpOwoKCQlzZWxmLl9tb2RhbCA9ICQoICI8ZGl2IGNsYXNzPSciICsgc2VsZi5vcHRpb25zLmNsYXNzZXMubW9kYWwgKyAiJz48L2Rpdj4iICkKCQkJLm9uKCAibW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmNsb3NlKCk7CgkJCX0pCgkJCS5hcHBlbmRUbyggdGFyZ2V0ICk7Cgl9LAoKCV9nZXRQYWdlOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFnZSA9IHRoaXMuX29wZW5lZFBhZ2UgfHwgdGhpcy5fcGFyZW50UGFnZSB8fCAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCgkJcmV0dXJuIHBhZ2U7Cgl9LAoKCV9nZXRXcmFwcGVyOiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuX3BhZ2UoKS5maW5kKCAiLiIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlV3JhcHBlciApOwoJCWlmICggd3JhcHBlci5sZW5ndGggPT09IDAgKSB7CgkJCXdyYXBwZXIgPSB0aGlzLl9wYWdlKCkuY2hpbGRyZW4oICIudWktaGVhZGVyOm5vdCgudWktaGVhZGVyLWZpeGVkKSwgLnVpLWNvbnRlbnQ6bm90KC51aS1wb3B1cCksIC51aS1mb290ZXI6bm90KC51aS1mb290ZXItZml4ZWQpIiApCgkJCQkud3JhcEFsbCggIjxkaXYgY2xhc3M9JyIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlV3JhcHBlciArICInPjwvZGl2PiIgKQoJCQkJLnBhcmVudCgpOwoJCX0KCgkJdGhpcy5fd3JhcHBlciA9IHdyYXBwZXI7Cgl9LAoKCV9nZXRGaXhlZFRvb2xiYXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgZXh0Rml4ZWRUb29sYmFycyA9ICQoICJib2R5IiApLmNoaWxkcmVuKCAiLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCIgKSwKCQkJaW50Rml4ZWRUb29sYmFycyA9IHRoaXMuX3BhZ2UoKS5maW5kKCAiLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCIgKSwKCQkJZml4ZWRUb29sYmFycyA9IGV4dEZpeGVkVG9vbGJhcnMuYWRkKCBpbnRGaXhlZFRvb2xiYXJzICkuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhZ2VGaXhlZFRvb2xiYXIgKTsKCgkJcmV0dXJuIGZpeGVkVG9vbGJhcnM7Cgl9LAoKCV9nZXRQb3NEaXNwbGF5Q2xhc3NlczogZnVuY3Rpb24oIHByZWZpeCApIHsKCQlyZXR1cm4gcHJlZml4ICsgIi1wb3NpdGlvbi0iICsgdGhpcy5vcHRpb25zLnBvc2l0aW9uICsgIiAiICsgcHJlZml4ICsgIi1kaXNwbGF5LSIgKyB0aGlzLm9wdGlvbnMuZGlzcGxheTsKCX0sCgoJX2dldFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsQ2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICsKCQkJIiAiICsgdGhpcy5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICkgKwoJCQkiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbENsb3NlZCArCgkJCSIgIiArICJ1aS1ib2R5LSIgKyAoIHRoaXMub3B0aW9ucy50aGVtZSA/IHRoaXMub3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiApOwoKCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgKSB7CgkJCXBhbmVsQ2xhc3NlcyArPSAiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkOwoJCX0KCgkJcmV0dXJuIHBhbmVsQ2xhc3NlczsKCX0sCgoJX2FkZFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSApOwoJfSwKCglfaGFuZGxlQ2xvc2VDbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJfSwKCglfYmluZENsb3NlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggdGhpcy5fY2xvc2VMaW5rLCB7CgkJCSJjbGljayI6ICJfaGFuZGxlQ2xvc2VDbGljayIKCQl9KTsKCgkJdGhpcy5fb24oewoJCQkiY2xpY2sgYTpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiOiAiX2hhbmRsZUNsb3NlQ2xpY2siCgkJfSk7Cgl9LAoKCV9wb3NpdGlvblBhbmVsOiBmdW5jdGlvbiggc2Nyb2xsVG9Ub3AgKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYW5lbElubmVySGVpZ2h0ID0gc2VsZi5fcGFuZWxJbm5lci5vdXRlckhlaWdodCgpLAoJCQlleHBhbmQgPSBwYW5lbElubmVySGVpZ2h0ID4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWlmICggZXhwYW5kIHx8ICFzZWxmLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJaWYgKCBleHBhbmQgKSB7CgkJCQlzZWxmLl91bmZpeFBhbmVsKCk7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIHBhbmVsSW5uZXJIZWlnaHQgKTsKCQkJfQoJCQlpZiAoIHNjcm9sbFRvVG9wICkgewoJCQkJdGhpcy53aW5kb3dbIDAgXS5zY3JvbGxUbyggMCwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJfQoJfSwKCglfYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggJCggd2luZG93ICksIHsgInRocm90dGxlZHJlc2l6ZSI6ICJfcG9zaXRpb25QYW5lbCIgfSk7Cgl9LAoKCV91bmJpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb2ZmKCAkKCB3aW5kb3cgKSwgInRocm90dGxlZHJlc2l6ZSIgKTsKCX0sCgoJX3VuZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfYmluZFVwZGF0ZUxheW91dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLmVsZW1lbnQub24oICJ1cGRhdGVsYXlvdXQiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJfQoJCX0pOwoJfSwKCglfYmluZExpbmtMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAiYm9keSIsIHsKCQkJImNsaWNrIGEiOiAiX2hhbmRsZUNsaWNrIgoJCX0pOwoKCX0sCgoJX2hhbmRsZUNsaWNrOiBmdW5jdGlvbiggZSApIHsKCQl2YXIgbGluaywKCQkJcGFuZWxJZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICk7CgoJCWlmICggZS5jdXJyZW50VGFyZ2V0LmhyZWYuc3BsaXQoICIjIiApWyAxIF0gPT09IHBhbmVsSWQgJiYgcGFuZWxJZCAhPT0gdW5kZWZpbmVkICkgewoKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlsaW5rID0gJCggZS50YXJnZXQgKTsKCQkJaWYgKCBsaW5rLmhhc0NsYXNzKCAidWktYnRuIiApICkgewoJCQkJbGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCXRoaXMuZWxlbWVudC5vbmUoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9KTsKCQkJfQoJCQl0aGlzLnRvZ2dsZSgpOwoJCX0KCX0sCgoJX2JpbmRTd2lwZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlhcmVhID0gc2VsZi5fbW9kYWwgPyBzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl9tb2RhbCApIDogc2VsZi5lbGVtZW50OwoKCQkvLyBvbiBzd2lwZSwgY2xvc2UgdGhlIHBhbmVsCgkJaWYgKCAhIXNlbGYub3B0aW9ucy5zd2lwZUNsb3NlICkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wb3NpdGlvbiA9PT0gImxlZnQiICkgewoJCQkJYXJlYS5vbiggInN3aXBlbGVmdC5wYW5lbCIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCWFyZWEub24oICJzd2lwZXJpZ2h0LnBhbmVsIiwgZnVuY3Rpb24oLyogZSAqLykgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoJCQl9CgkJfQoJfSwKCglfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5kb2N1bWVudAoJCQkvLyBDbG9zZSB0aGUgcGFuZWwgaWYgYW5vdGhlciBwYW5lbCBvbiB0aGUgcGFnZSBvcGVucwoJCQkub24oICJwYW5lbGJlZm9yZW9wZW4iLCBmdW5jdGlvbiggZSApIHsKCQkJCWlmICggc2VsZi5fb3BlbiAmJiBlLnRhcmdldCAhPT0gc2VsZi5lbGVtZW50WyAwIF0gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KQoJCQkvLyBPbiBlc2NhcGUsIGNsb3NlPyBtaWdodCBuZWVkIHRvIGhhdmUgYSB0YXJnZXQgY2hlY2sgdG9vLi4uCgkJCS5vbiggImtleXVwLnBhbmVsIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIGUua2V5Q29kZSA9PT0gMjcgJiYgc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgkJCX0pOwoJCWlmICggIXRoaXMuX3BhcmVudFBhZ2UgJiYgdGhpcy5vcHRpb25zLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsKCQkJCSJwYWdlc2hvdyI6ICJfZ2V0V3JhcHBlciIKCQkJfSk7CgkJfQoJCS8vIENsZWFuIHVwIG9wZW4gcGFuZWxzIGFmdGVyIHBhZ2UgaGlkZQoJCWlmICggc2VsZi5fcGFyZW50UGFnZSApIHsKCQkJdGhpcy5kb2N1bWVudC5vbiggInBhZ2VoaWRlIiwgIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBzZWxmLl9vcGVuICkgewoJCQkJCXNlbGYuY2xvc2UoIHRydWUgKTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5kb2N1bWVudC5vbiggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9Cgl9LAoKCS8vIHN0YXRlIHN0b3JhZ2Ugb2Ygb3BlbiBvciBjbG9zZWQKCV9vcGVuOiBmYWxzZSwKCV9wYWdlQ29udGVudE9wZW5DbGFzc2VzOiBudWxsLAoJX21vZGFsT3BlbkNsYXNzZXM6IG51bGwsCgoJb3BlbjogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoICF0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoKCQkJCV9vcGVuUGFuZWwgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLl9vZmYoIHNlbGYuZG9jdW1lbnQgLCAicGFuZWxjbG9zZSIgKTsKCQkJCQlzZWxmLl9wYWdlKCkuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLmFkZENsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoKCQkJCQlpZiAoICFpbW1lZGlhdGUgJiYgJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCQkoIHNlbGYuX3dyYXBwZXIgfHwgc2VsZi5lbGVtZW50ICkKCQkJCQkJCS5hbmltYXRpb25Db21wbGV0ZSggY29tcGxldGUsICJ0cmFuc2l0aW9uIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldFRpbWVvdXQoIGNvbXBsZXRlLCAwICk7CgkJCQkJfQoKCQkJCQlpZiAoIG8udGhlbWUgJiYgby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UoKS5wYXJlbnQoKQoJCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItdGhlbWVkICIgKyBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItIiArIG8udGhlbWUgKTsKCQkJCQl9CgoJCQkJCXNlbGYuZWxlbWVudAoJCQkJCQkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbENsb3NlZCApCgkJCQkJCS5hZGRDbGFzcyggby5jbGFzc2VzLnBhbmVsT3BlbiApOwoKCQkJCQlzZWxmLl9wb3NpdGlvblBhbmVsKCB0cnVlICk7CgoJCQkJCXNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICk7CgoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UoKS5wYXJlbnQoKS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKTsKCQkJCQkJc2VsZi5fd3JhcHBlci5hZGRDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX21vZGFsT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLm1vZGFsICkgKyAiICIgKyBvLmNsYXNzZXMubW9kYWxPcGVuOwoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsCgkJCQkJCQkuYWRkQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKQoJCQkJCQkJLmhlaWdodCggTWF0aC5tYXgoIHNlbGYuX21vZGFsLmhlaWdodCgpLCBzZWxmLmRvY3VtZW50LmhlaWdodCgpICkgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCgkJCQkJLy8gQmFpbCBpZiB0aGUgcGFuZWwgd2FzIGNsb3NlZCBiZWZvcmUgdGhlIG9wZW5pbmcgYW5pbWF0aW9uIGhhcyBjb21wbGV0ZWQKCQkJCQlpZiAoICFzZWxmLl9vcGVuICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCX0KCgkJCQkJc2VsZi5fYmluZEZpeExpc3RlbmVyKCk7CgoJCQkJCXNlbGYuX3RyaWdnZXIoICJvcGVuIiApOwoKCQkJCQlzZWxmLl9vcGVuZWRQYWdlID0gc2VsZi5fcGFnZSgpOwoJCQkJfTsKCgkJCXNlbGYuX3RyaWdnZXIoICJiZWZvcmVvcGVuIiApOwoKCQkJaWYgKCBzZWxmLl9wYWdlKCkuanFtRGF0YSggInBhbmVsIiApID09PSAib3BlbiIgKSB7CgkJCQlzZWxmLl9vbiggc2VsZi5kb2N1bWVudCwgewoJCQkJCSJwYW5lbGNsb3NlIjogX29wZW5QYW5lbAoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlfb3BlblBhbmVsKCk7CgkJCX0KCgkJCXNlbGYuX29wZW4gPSB0cnVlOwoJCX0KCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gdGhpcy5vcHRpb25zLAoKCQkJCV9jbG9zZVBhbmVsID0gZnVuY3Rpb24oKSB7CgoJCQkJCXNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsT3BlbiApOwoKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCX0KCgkJCQkJaWYgKCAhaW1tZWRpYXRlICYmICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQkJKCBzZWxmLl93cmFwcGVyIHx8IHNlbGYuZWxlbWVudCApCgkJCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoIGNvbXBsZXRlLCAidHJhbnNpdGlvbiIgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRUaW1lb3V0KCBjb21wbGV0ZSwgMCApOwoJCQkJCX0KCgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwKCQkJCQkJCS5yZW1vdmVDbGFzcyggc2VsZi5fbW9kYWxPcGVuQ2xhc3NlcyApCgkJCQkJCQkuaGVpZ2h0KCAiIiApOwoJCQkJCX0KCQkJCX0sCgkJCQljb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggby50aGVtZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItdGhlbWVkICIgKyBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItIiArIG8udGhlbWUgKTsKCQkJCQl9CgoJCQkJCXNlbGYuZWxlbWVudC5hZGRDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICk7CgoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKTsKCQkJCQkJc2VsZi5fd3JhcHBlci5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQl9CgoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9maXhQYW5lbCgpOwoJCQkJCXNlbGYuX3VuYmluZEZpeExpc3RlbmVyKCk7CgkJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgoJCQkJCXNlbGYuX3BhZ2UoKS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgoJCQkJCXNlbGYuX3RyaWdnZXIoICJjbG9zZSIgKTsKCgkJCQkJc2VsZi5fb3BlbmVkUGFnZSA9IG51bGw7CgkJCQl9OwoKCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZWNsb3NlIiApOwoKCQkJX2Nsb3NlUGFuZWwoKTsKCgkJCXNlbGYuX29wZW4gPSBmYWxzZTsKCQl9Cgl9LAoKCXRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdGhpc1sgdGhpcy5fb3BlbiA/ICJjbG9zZSIgOiAib3BlbiIgXSgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIG90aGVyUGFuZWxzLAoJCW8gPSB0aGlzLm9wdGlvbnMsCgkJbXVsdGlwbGVQYW5lbHMgPSAoICQoICJib2R5ID4gOm1vYmlsZS1wYW5lbCIgKS5sZW5ndGggKyAkLm1vYmlsZS5hY3RpdmVQYWdlLmZpbmQoICI6bW9iaWxlLXBhbmVsIiApLmxlbmd0aCApID4gMTsKCgkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCgkJCS8vICByZW1vdmUgdGhlIHdyYXBwZXIgaWYgbm90IGluIHVzZSBieSBhbm90aGVyIHBhbmVsCgkJCW90aGVyUGFuZWxzID0gJCggImJvZHkgPiA6bW9iaWxlLXBhbmVsIiApLmFkZCggJC5tb2JpbGUuYWN0aXZlUGFnZS5maW5kKCAiOm1vYmlsZS1wYW5lbCIgKSApOwoJCQlpZiAoIG90aGVyUGFuZWxzLm5vdCggIi51aS1wYW5lbC1kaXNwbGF5LW92ZXJsYXkiICkubm90KCB0aGlzLmVsZW1lbnQgKS5sZW5ndGggPT09IDAgKSB7CgkJCQl0aGlzLl93cmFwcGVyLmNoaWxkcmVuKCkudW53cmFwKCk7CgkJCX0KCgkJCWlmICggdGhpcy5fb3BlbiApIHsKCgkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCgkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQl9CgoJCQkJdGhpcy5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoKCQkJCWlmICggby50aGVtZSApIHsKCQkJCQl0aGlzLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJfQoJCQl9CgkJfQoKCQlpZiAoICFtdWx0aXBsZVBhbmVscyApIHsKCgkJCXRoaXMuZG9jdW1lbnQub2ZmKCAicGFuZWxvcGVuIHBhbmVsY2xvc2UiICk7CgoJCX0KCgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl0aGlzLl9wYWdlKCkuanFtUmVtb3ZlRGF0YSggInBhbmVsIiApOwoJCX0KCgkJdGhpcy5fcGFuZWxJbm5lci5jaGlsZHJlbigpLnVud3JhcCgpOwoKCQl0aGlzLmVsZW1lbnQKCQkJLnJlbW92ZUNsYXNzKCBbIHRoaXMuX2dldFBhbmVsQ2xhc3NlcygpLCBvLmNsYXNzZXMucGFuZWxPcGVuLCBvLmNsYXNzZXMuYW5pbWF0ZSBdLmpvaW4oICIgIiApICkKCQkJLm9mZiggInN3aXBlbGVmdC5wYW5lbCBzd2lwZXJpZ2h0LnBhbmVsIiApCgkJCS5vZmYoICJwYW5lbGJlZm9yZW9wZW4iICkKCQkJLm9mZiggInBhbmVsaGlkZSIgKQoJCQkub2ZmKCAia2V5dXAucGFuZWwiICkKCQkJLm9mZiggInVwZGF0ZWxheW91dCIgKTsKCgkJaWYgKCB0aGlzLl9tb2RhbCApIHsKCQkJdGhpcy5fbW9kYWwucmVtb3ZlKCk7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGFibGUiLCB7CglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQl0YWJsZTogInVpLXRhYmxlIgoJCX0sCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy50YWJsZSApOwoJCX0KCgkJLy8gZXh0ZW5kIGhlcmUsIGFzc2lnbiBvbiByZWZyZXNoID4gX3NldEhlYWRlcnMKCQkkLmV4dGVuZCggdGhpcywgewoKCQkJLy8gRXhwb3NlIGhlYWRlcnMgYW5kIGFsbEhlYWRlcnMgcHJvcGVydGllcyBvbiB0aGUgd2lkZ2V0CgkJCS8vIGhlYWRlcnMgcmVmZXJlbmNlcyB0aGUgVEhzIHdpdGhpbiB0aGUgZmlyc3QgVFIgaW4gdGhlIHRhYmxlCgkJCWhlYWRlcnM6IHVuZGVmaW5lZCwKCgkJCS8vIGFsbEhlYWRlcnMgcmVmZXJlbmNlcyBoZWFkZXJzLCBwbHVzIGFsbCBUSHMgaW4gdGhlIHRoZWFkLCB3aGljaCBtYXkKCQkJLy8gaW5jbHVkZSBzZXZlcmFsIHJvd3MsIG9yIG5vdAoJCQlhbGxIZWFkZXJzOiB1bmRlZmluZWQKCQl9KTsKCgkJdGhpcy5fcmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfc2V0SGVhZGVyczogZnVuY3Rpb24oKSB7CgkJdmFyIHRycyA9IHRoaXMuZWxlbWVudC5maW5kKCAidGhlYWQgdHIiICk7CgoJCXRoaXMuaGVhZGVycyA9IHRoaXMuZWxlbWVudC5maW5kKCAidHI6ZXEoMCkiICkuY2hpbGRyZW4oKTsKCQl0aGlzLmFsbEhlYWRlcnMgPSB0aGlzLmhlYWRlcnMuYWRkKCB0cnMuY2hpbGRyZW4oKSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCk7Cgl9LAoKCXJlYnVpbGQ6ICQubm9vcCwKCglfcmVmcmVzaDogZnVuY3Rpb24oIC8qIGNyZWF0ZSAqLyApIHsKCQl2YXIgdGFibGUgPSB0aGlzLmVsZW1lbnQsCgkJCXRycyA9IHRhYmxlLmZpbmQoICJ0aGVhZCB0ciIgKTsKCgkJLy8gdXBkYXRpbmcgaGVhZGVycyBvbiByZWZyZXNoIChmaXhlcyAjNTg4MCkKCQl0aGlzLl9zZXRIZWFkZXJzKCk7CgoJCS8vIEl0ZXJhdGUgb3ZlciB0aGUgdHJzCgkJdHJzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgY29sdW1uQ291bnQgPSAwOwoKCQkJLy8gSXRlcmF0ZSBvdmVyIHRoZSBjaGlsZHJlbiBvZiB0aGUgdHIKCQkJJCggdGhpcyApLmNoaWxkcmVuKCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgc3BhbiA9IHBhcnNlSW50KCB0aGlzLmdldEF0dHJpYnV0ZSggImNvbHNwYW4iICksIDEwICksCgkJCQkJc2VsZWN0b3IgPSAiOm50aC1jaGlsZCgiICsgKCBjb2x1bW5Db3VudCArIDEgKSArICIpIiwKCQkJCQlqOwoKCQkJCXRoaXMuc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiY29sc3RhcnQiLCBjb2x1bW5Db3VudCArIDEgKTsKCgkJCQlpZiAoIHNwYW4gKSB7CgkJCQkJZm9yKCBqID0gMDsgaiA8IHNwYW4gLSAxOyBqKysgKSB7CgkJCQkJCWNvbHVtbkNvdW50Kys7CgkJCQkJCXNlbGVjdG9yICs9ICIsIDpudGgtY2hpbGQoIiArICggY29sdW1uQ291bnQgKyAxICkgKyAiKSI7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFN0b3JlICJjZWxscyIgZGF0YSBvbiBoZWFkZXIgYXMgYSByZWZlcmVuY2UgdG8gYWxsIGNlbGxzIGluIHRoZQoJCQkJLy8gc2FtZSBjb2x1bW4gYXMgdGhpcyBUSAoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIsIHRhYmxlLmZpbmQoICJ0ciIgKS5ub3QoIHRycy5lcSggMCApICkubm90KCB0aGlzICkuY2hpbGRyZW4oIHNlbGVjdG9yICkgKTsKCgkJCQljb2x1bW5Db3VudCsrOwoJCQl9KTsKCQl9KTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLnRhYmxlLCB7CglvcHRpb25zOiB7CgkJbW9kZTogImNvbHVtbnRvZ2dsZSIsCgkJY29sdW1uQnRuVGhlbWU6IG51bGwsCgkJY29sdW1uUG9wdXBUaGVtZTogbnVsbCwKCQljb2x1bW5CdG5UZXh0OiAiQ29sdW1ucy4uLiIsCgkJY2xhc3NlczogJC5leHRlbmQoICQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsIHsKCQkJcG9wdXA6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtcG9wdXAiLAoJCQljb2x1bW5CdG46ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtYnRuIiwKCQkJcHJpb3JpdHlQcmVmaXg6ICJ1aS10YWJsZS1wcmlvcml0eS0iLAoJCQljb2x1bW5Ub2dnbGVUYWJsZTogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZSIKCQl9KQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5tb2RlICE9PSAiY29sdW1udG9nZ2xlIiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX21lbnU6IG51bGwKCQl9KTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX21lbnUgPSAkKCB0aGlzLmRvY3VtZW50WyAwIF0uZ2V0RWxlbWVudEJ5SWQoIHRoaXMuX2lkKCkgKyAiLXBvcHVwIiApICkuY2hpbGRyZW4oKS5maXJzdCgpOwoJCQl0aGlzLl9hZGRUb2dnbGVzKCB0aGlzLl9tZW51LCB0cnVlICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fbWVudSA9IHRoaXMuX2VuaGFuY2VDb2xUb2dnbGUoKTsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5jb2x1bW5Ub2dnbGVUYWJsZSApOwoJCX0KCgkJdGhpcy5fc2V0dXBFdmVudHMoKTsKCgkJdGhpcy5fc2V0VG9nZ2xlU3RhdGUoKTsKCX0sCgoJX2lkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApIHx8ICggdGhpcy53aWRnZXROYW1lICsgdGhpcy51dWlkICkgKTsKCX0sCgoJX3NldHVwRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkvL05PVEU6IGlucHV0cyBhcmUgYm91bmQgaW4gYmluZFRvZ2dsZXMsCgkJLy8gc28gaXQgY2FuIGJlIGNhbGxlZCBvbiByZWZyZXNoLCB0b28KCgkJLy8gdXBkYXRlIGNvbHVtbiB0b2dnbGVzIG9uIHJlc2l6ZQoJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgewoJCQl0aHJvdHRsZWRyZXNpemU6ICJfc2V0VG9nZ2xlU3RhdGUiCgkJfSk7CgkJdGhpcy5fb24oIHRoaXMuX21lbnUsIHsKCQkJImNoYW5nZSBpbnB1dCI6ICJfbWVudUlucHV0Q2hhbmdlIgoJCX0pOwoJfSwKCglfYWRkVG9nZ2xlczogZnVuY3Rpb24oIG1lbnUsIGtlZXAgKSB7CgkJdmFyIGlucHV0cywKCQkJY2hlY2tib3hJbmRleCA9IDAsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWNvbnRhaW5lciA9IG1lbnUuY29udHJvbGdyb3VwKCAiY29udGFpbmVyIiApOwoKCQkvLyBhbGxvdyB1cGRhdGUgb2YgbWVudSBvbiByZWZyZXNoIChmaXhlcyAjNTg4MCkKCQlpZiAoIGtlZXAgKSB7CgkJCWlucHV0cyA9IG1lbnUuZmluZCggImlucHV0IiApOwoJCX0gZWxzZSB7CgkJCWNvbnRhaW5lci5lbXB0eSgpOwoJCX0KCgkJLy8gY3JlYXRlIHRoZSBoaWRlL3Nob3cgdG9nZ2xlcwoJCXRoaXMuaGVhZGVycy5ub3QoICJ0ZCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGlucHV0LCBjZWxscywKCQkJCWhlYWRlciA9ICQoIHRoaXMgKSwKCQkJCXByaW9yaXR5ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAicHJpb3JpdHkiICk7CgoJCQlpZiAoIHByaW9yaXR5ICkgewoJCQkJY2VsbHMgPSBoZWFkZXIuYWRkKCBoZWFkZXIuanFtRGF0YSggImNlbGxzIiApICk7CgkJCQljZWxscy5hZGRDbGFzcyggb3B0cy5jbGFzc2VzLnByaW9yaXR5UHJlZml4ICsgcHJpb3JpdHkgKTsKCgkJCQkvLyBNYWtlIHN1cmUgdGhlIChuZXc/KSBjaGVja2JveCBpcyBhc3NvY2lhdGVkIHdpdGggaXRzIGhlYWRlciB2aWEgLmpxbURhdGEoKSBhbmQKCQkJCS8vIHRoYXQsIHZpY2UgdmVyc2EsIHRoZSBoZWFkZXIgaXMgYWxzbyBhc3NvY2lhdGVkIHdpdGggdGhlIGNoZWNrYm94CgkJCQlpbnB1dCA9ICgga2VlcCA/IGlucHV0cy5lcSggY2hlY2tib3hJbmRleCsrICkgOgoJCQkJCSQoIjxsYWJlbD48aW5wdXQgdHlwZT0nY2hlY2tib3gnIGNoZWNrZWQgLz4iICsKCQkJCQkJKCBoZWFkZXIuY2hpbGRyZW4oICJhYmJyIiApLmZpcnN0KCkuYXR0ciggInRpdGxlIiApIHx8CgkJCQkJCQloZWFkZXIudGV4dCgpICkgKwoJCQkJCQkiPC9sYWJlbD4iICkKCQkJCQkJLmFwcGVuZFRvKCBjb250YWluZXIgKQoJCQkJCQkuY2hpbGRyZW4oIDAgKQoJCQkJCQkuY2hlY2tib3hyYWRpbyggewoJCQkJCQkJdGhlbWU6IG9wdHMuY29sdW1uUG9wdXBUaGVtZQoJCQkJCQl9KSApCgoJCQkJCQkvLyBBc3NvY2lhdGUgdGhlIGhlYWRlciB3aXRoIHRoZSBjaGVja2JveAoJCQkJCQkuanFtRGF0YSggImhlYWRlciIsIGhlYWRlciApCgkJCQkJCS5qcW1EYXRhKCAiY2VsbHMiLCBjZWxscyApOwoKCQkJCS8vIEFzc29jaWF0ZSB0aGUgY2hlY2tib3ggd2l0aCB0aGUgaGVhZGVyCgkJCQloZWFkZXIuanFtRGF0YSggImlucHV0IiwgaW5wdXQgKTsKCQkJfQoJCX0pOwoKCQkvLyBzZXQgYmluZGluZ3MgaGVyZQoJCWlmICggIWtlZXAgKSB7CgkJCW1lbnUuY29udHJvbGdyb3VwKCAicmVmcmVzaCIgKTsKCQl9Cgl9LAoKCV9tZW51SW5wdXRDaGFuZ2U6IGZ1bmN0aW9uKCBldnQgKSB7CgkJdmFyIGlucHV0ID0gJCggZXZ0LnRhcmdldCApLAoJCQljaGVja2VkID0gaW5wdXRbIDAgXS5jaGVja2VkOwoKCQlpbnB1dC5qcW1EYXRhKCAiY2VsbHMiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFibGUtY2VsbC1oaWRkZW4iLCAhY2hlY2tlZCApCgkJCS50b2dnbGVDbGFzcyggInVpLXRhYmxlLWNlbGwtdmlzaWJsZSIsIGNoZWNrZWQgKTsKCX0sCgoJX3VubG9ja0NlbGxzOiBmdW5jdGlvbiggY2VsbHMgKSB7CgkJLy8gYWxsb3cgaGlkZS9zaG93IHZpYSBDU1Mgb25seSA9IHJlbW92ZSBhbGwgdG9nZ2xlLWxvY2tzCgkJY2VsbHMucmVtb3ZlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiB1aS10YWJsZS1jZWxsLXZpc2libGUiKTsKCX0sCgoJX2VuaGFuY2VDb2xUb2dnbGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpZCAsIG1lbnVCdXR0b24sIHBvcHVwLCBtZW51LAoJCQl0YWJsZSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJbnMgPSAkLm1vYmlsZS5ucywKCQkJZnJhZ21lbnQgPSB0aGlzLmRvY3VtZW50WyAwIF0uY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlpZCA9IHRoaXMuX2lkKCkgKyAiLXBvcHVwIjsKCQltZW51QnV0dG9uID0gJCggIjxhIGhyZWY9JyMiICsgaWQgKyAiJyAiICsKCQkJImNsYXNzPSciICsgb3B0cy5jbGFzc2VzLmNvbHVtbkJ0biArICIgdWktYnRuICIgKwoJCQkidWktYnRuLSIgKyAoIG9wdHMuY29sdW1uQnRuVGhlbWUgfHwgImEiICkgKwoJCQkiIHVpLWNvcm5lci1hbGwgdWktc2hhZG93IHVpLW1pbmknICIgKwoJCQkiZGF0YS0iICsgbnMgKyAicmVsPSdwb3B1cCc+IiArIG9wdHMuY29sdW1uQnRuVGV4dCArICI8L2E+IiApOwoJCXBvcHVwID0gJCggIjxkaXYgY2xhc3M9JyIgKyBvcHRzLmNsYXNzZXMucG9wdXAgKyAiJyBpZD0nIiArIGlkICsgIic+PC9kaXY+IiApOwoJCW1lbnUgPSAkKCAiPGZpZWxkc2V0PjwvZmllbGRzZXQ+IiApLmNvbnRyb2xncm91cCgpOwoKCQkvLyBzZXQgZXh0ZW5zaW9uIGhlcmUsIHNlbmQgImZhbHNlIiB0byB0cmlnZ2VyIGJ1aWxkL3JlYnVpbGQKCQl0aGlzLl9hZGRUb2dnbGVzKCBtZW51LCBmYWxzZSApOwoKCQltZW51LmFwcGVuZFRvKCBwb3B1cCApOwoKCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggcG9wdXBbIDAgXSApOwoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBtZW51QnV0dG9uWyAwIF0gKTsKCQl0YWJsZS5iZWZvcmUoIGZyYWdtZW50ICk7CgoJCXBvcHVwLnBvcHVwKCk7CgoJCXJldHVybiBtZW51OwoJfSwKCglyZWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5tb2RlID09PSAiY29sdW1udG9nZ2xlIiApIHsKCQkJLy8gTk9URTogcmVidWlsZCBwYXNzZXMgImZhbHNlIiwgd2hpbGUgcmVmcmVzaCBwYXNzZXMgInVuZGVmaW5lZCIKCQkJLy8gYm90aCByZWZyZXNoIHRoZSB0YWJsZSwgYnV0IGluc2lkZSBhZGRUb2dnbGVzLCAhZmFsc2Ugd2lsbCBiZSB0cnVlLAoJCQkvLyBzbyBhIHJlYnVpbGQgY2FsbCBjYW4gYmUgaW5kZW50aWZpZWQKCQkJdGhpcy5fcmVmcmVzaCggZmFsc2UgKTsKCQl9Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBoZWFkZXJzLCBoaWRkZW5Db2x1bW5zLCBpbmRleDsKCgkJLy8gQ2FsbGluZyBfc3VwZXIoKSBoZXJlIHVwZGF0ZXMgdGhpcy5oZWFkZXJzCgkJdGhpcy5fc3VwZXIoIGNyZWF0ZSApOwoKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQloZWFkZXJzID0gdGhpcy5oZWFkZXJzOwoJCQloaWRkZW5Db2x1bW5zID0gW107CgoJCQkvLyBGaW5kIHRoZSBpbmRleCBvZiB0aGUgY29sdW1uIGhlYWRlciBhc3NvY2lhdGVkIHdpdGggZWFjaCBvbGQgY2hlY2tib3ggYW1vbmcgdGhlCgkJCS8vIHBvc3QtcmVmcmVzaCBoZWFkZXJzIGFuZCwgaWYgdGhlIGhlYWRlciBpcyBzdGlsbCB0aGVyZSwgbWFrZSBzdXJlIHRoZSBjb3JyZXNwb25kaW5nCgkJCS8vIGNvbHVtbiB3aWxsIGJlIGhpZGRlbiBpZiB0aGUgcHJlLXJlZnJlc2ggY2hlY2tib3ggaW5kaWNhdGVzIHRoYXQgdGhlIGNvbHVtbiBpcwoJCQkvLyBoaWRkZW4gYnkgcmVjb3JkaW5nIGl0cyBpbmRleCBpbiB0aGUgYXJyYXkgb2YgaGlkZGVuIGNvbHVtbnMuCgkJCXRoaXMuX21lbnUuZmluZCggImlucHV0IiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIGlucHV0ID0gJCggdGhpcyApLAoJCQkJCWhlYWRlciA9IGlucHV0LmpxbURhdGEoICJoZWFkZXIiICksCgkJCQkJaW5kZXggPSBoZWFkZXJzLmluZGV4KCBoZWFkZXJbIDAgXSApOwoKCQkJCWlmICggaW5kZXggPiAtMSAmJiAhaW5wdXQucHJvcCggImNoZWNrZWQiICkgKSB7CgoJCQkJCS8vIFRoZSBjb2x1bW4gaGVhZGVyIGFzc29jaWF0ZWQgd2l0aCAvdGhpcy8gY2hlY2tib3ggaXMgc3RpbGwgcHJlc2VudCBpbiB0aGUKCQkJCQkvLyBwb3N0LXJlZnJlc2ggdGFibGUgYW5kIHRoZSBjaGVja2JveCBpcyBub3QgY2hlY2tlZCwgc28gdGhlIGNvbHVtbiBhc3NvY2lhdGVkCgkJCQkJLy8gd2l0aCB0aGlzIGNvbHVtbiBoZWFkZXIgaXMgY3VycmVudGx5IGhpZGRlbi4gTGV0J3MgcmVjb3JkIHRoYXQuCgkJCQkJaGlkZGVuQ29sdW1ucy5wdXNoKCBpbmRleCApOwoJCQkJfQoJCQl9KTsKCgkJCS8vIGNvbHVtbnMgbm90IGJlaW5nIHJlcGxhY2VkIG11c3QgYmUgY2xlYXJlZCBmcm9tIGlucHV0IHRvZ2dsZS1sb2NrcwoJCQl0aGlzLl91bmxvY2tDZWxscyggdGhpcy5lbGVtZW50LmZpbmQoICIudWktdGFibGUtY2VsbC1oaWRkZW4sICIgKwoJCQkJIi51aS10YWJsZS1jZWxsLXZpc2libGUiICkgKTsKCgkJCS8vIHVwZGF0ZSBjb2x1bW50b2dnbGVzIGFuZCBjZWxscwoJCQl0aGlzLl9hZGRUb2dnbGVzKCB0aGlzLl9tZW51LCBjcmVhdGUgKTsKCgkJCS8vIEF0IHRoaXMgcG9pbnQgYWxsIGNvbHVtbnMgYXJlIHZpc2libGUsIHNvIHVuY2hlY2sgdGhlIGNoZWNrYm94ZXMgdGhhdCBjb3JyZXNwb25kIHRvCgkJCS8vIHRob3NlIGNvbHVtbnMgd2UndmUgZm91bmQgdG8gYmUgaGlkZGVuCgkJCWZvciAoIGluZGV4ID0gaGlkZGVuQ29sdW1ucy5sZW5ndGggLSAxIDsgaW5kZXggPiAtMSA7IGluZGV4LS0gKSB7CgkJCQloZWFkZXJzLmVxKCBoaWRkZW5Db2x1bW5zWyBpbmRleCBdICkuanFtRGF0YSggImlucHV0IiApCgkJCQkJLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKQoJCQkJCS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKQoJCQkJCS50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCglfc2V0VG9nZ2xlU3RhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX21lbnUuZmluZCggImlucHV0IiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgY2hlY2tib3ggPSAkKCB0aGlzICk7CgoJCQl0aGlzLmNoZWNrZWQgPSBjaGVja2JveC5qcW1EYXRhKCAiY2VsbHMiICkuZXEoIDAgKS5jc3MoICJkaXNwbGF5IiApID09PSAidGFibGUtY2VsbCI7CgkJCWNoZWNrYm94LmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJCX0pOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgJC5tb2JpbGUudGFibGUsIHsKCW9wdGlvbnM6IHsKCQltb2RlOiAicmVmbG93IiwKCQljbGFzc2VzOiAkLmV4dGVuZCggJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcywgewoJCQlyZWZsb3dUYWJsZTogInVpLXRhYmxlLXJlZmxvdyIsCgkJCWNlbGxMYWJlbHM6ICJ1aS10YWJsZS1jZWxsLWxhYmVsIgoJCX0pCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCS8vIElmIGl0J3Mgbm90IHJlZmxvdyBtb2RlLCByZXR1cm4gaGVyZS4KCQlpZiAoIHRoaXMub3B0aW9ucy5tb2RlICE9PSAicmVmbG93IiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnJlZmxvd1RhYmxlICk7CgoJCQl0aGlzLl91cGRhdGVSZWZsb3coKTsKCQl9Cgl9LAoKCXJlYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgPT09ICJyZWZsb3ciICkgewoJCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJCX0KCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5fc3VwZXIoIGNyZWF0ZSApOwoJCWlmICggIWNyZWF0ZSAmJiB0aGlzLm9wdGlvbnMubW9kZSA9PT0gInJlZmxvdyIgKSB7CgkJCXRoaXMuX3VwZGF0ZVJlZmxvdyggKTsKCQl9Cgl9LAoKCV91cGRhdGVSZWZsb3c6IGZ1bmN0aW9uKCkgewoJCXZhciB0YWJsZSA9IHRoaXMsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIGdldCBoZWFkZXJzIGluIHJldmVyc2Ugb3JkZXIgc28gdGhhdCB0b3AtbGV2ZWwgaGVhZGVycyBhcmUgYXBwZW5kZWQgbGFzdAoJCSQoIHRhYmxlLmFsbEhlYWRlcnMuZ2V0KCkucmV2ZXJzZSgpICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBjZWxscyA9ICQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICksCgkJCQljb2xzdGFydCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgImNvbHN0YXJ0IiApLAoJCQkJaGllcmFyY2h5Q2xhc3MgPSBjZWxscy5ub3QoIHRoaXMgKS5maWx0ZXIoICJ0aGVhZCB0aCIgKS5sZW5ndGggJiYgIiB1aS10YWJsZS1jZWxsLWxhYmVsLXRvcCIsCgkJCQljb250ZW50cyA9ICQoIHRoaXMgKS5jbG9uZSgpLmNvbnRlbnRzKCksCgkJCQlpdGVyYXRpb24sIGZpbHRlcjsKCgkJCQlpZiAoIGNvbnRlbnRzLmxlbmd0aCA+IDAgICkgewoKCQkJCQlpZiAoIGhpZXJhcmNoeUNsYXNzICkgewoJCQkJCQlpdGVyYXRpb24gPSBwYXJzZUludCggdGhpcy5nZXRBdHRyaWJ1dGUoICJjb2xzcGFuIiApLCAxMCApOwoJCQkJCQlmaWx0ZXIgPSAiIjsKCgkJCQkJCWlmICggaXRlcmF0aW9uICkgewoJCQkJCQkJZmlsdGVyID0gInRkOm50aC1jaGlsZCgiKyBpdGVyYXRpb24gKyJuICsgIiArICggY29sc3RhcnQgKSArIikiOwoJCQkJCQl9CgoJCQkJCQl0YWJsZS5fYWRkTGFiZWxzKCBjZWxscy5maWx0ZXIoIGZpbHRlciApLAoJCQkJCQkJb3B0cy5jbGFzc2VzLmNlbGxMYWJlbHMgKyBoaWVyYXJjaHlDbGFzcywgY29udGVudHMgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0YWJsZS5fYWRkTGFiZWxzKCBjZWxscywgb3B0cy5jbGFzc2VzLmNlbGxMYWJlbHMsIGNvbnRlbnRzICk7CgkJCQkJfQoKCQkJCX0KCQl9KTsKCX0sCgoJX2FkZExhYmVsczogZnVuY3Rpb24oIGNlbGxzLCBsYWJlbCwgY29udGVudHMgKSB7CgkJaWYgKCBjb250ZW50cy5sZW5ndGggPT09IDEgJiYgY29udGVudHNbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiYWJiciIgKSB7CgkJCWNvbnRlbnRzID0gY29udGVudHMuZXEoIDAgKS5hdHRyKCAidGl0bGUiICk7CgkJfQoJCS8vIC5ub3QgZml4ZXMgIzYwMDYKCQljZWxscwoJCQkubm90KCAiOmhhcyhiLiIgKyBsYWJlbCArICIpIiApCgkJCQkucHJlcGVuZCggJCggIjxiIGNsYXNzPSciICsgbGFiZWwgKyAiJz48L2I+IiApLmFwcGVuZCggY29udGVudHMgKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gVE9ETyByZW5hbWUgZmlsdGVyQ2FsbGJhY2svZGVwcmVjYXRlIGFuZCBkZWZhdWx0IHRvIHRoZSBpdGVtIGl0c2VsZiBhcyB0aGUgZmlyc3QgYXJndW1lbnQKdmFyIGRlZmF1bHRGaWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCBpbmRleCwgc2VhcmNoVmFsdWUgKSB7CglyZXR1cm4gKCAoICIiICsgKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJmaWx0ZXJ0ZXh0IiApIHx8ICQoIHRoaXMgKS50ZXh0KCkgKSApCgkJLnRvTG93ZXJDYXNlKCkuaW5kZXhPZiggc2VhcmNoVmFsdWUgKSA9PT0gLTEgKTsKfTsKCiQud2lkZ2V0KCAibW9iaWxlLmZpbHRlcmFibGUiLCB7CgoJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEoZmlsdGVyPSd0cnVlJykiLAoKCW9wdGlvbnM6IHsKCQlmaWx0ZXJSZXZlYWw6IGZhbHNlLAoJCWZpbHRlckNhbGxiYWNrOiBkZWZhdWx0RmlsdGVyQ2FsbGJhY2ssCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCWlucHV0OiBudWxsLAoJCWNoaWxkcmVuOiAiPiBsaSwgPiBvcHRpb24sID4gb3B0Z3JvdXAgb3B0aW9uLCA+IHRib2R5IHRyLCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktYnRuLCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktY2hlY2tib3gsID4gLnVpLWNvbnRyb2xncm91cC1jb250cm9scyA+IC51aS1yYWRpbyIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9zZWFyY2g6IG51bGwsCgkJCV90aW1lcjogMAoJCX0pOwoKCQl0aGlzLl9zZXRJbnB1dCggb3B0cy5pbnB1dCApOwoJCWlmICggIW9wdHMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2ZpbHRlckl0ZW1zKCAoICggdGhpcy5fc2VhcmNoICYmIHRoaXMuX3NlYXJjaC52YWwoKSApIHx8ICIiICkudG9Mb3dlckNhc2UoKSApOwoJCX0KCX0sCgoJX29uS2V5VXA6IGZ1bmN0aW9uKCkgewoJCXZhciB2YWwsIGxhc3R2YWwsCgkJCXNlYXJjaCA9IHRoaXMuX3NlYXJjaDsKCgkJaWYgKCBzZWFyY2ggKSB7CgkJCXZhbCA9IHNlYXJjaC52YWwoKS50b0xvd2VyQ2FzZSgpLAoJCQlsYXN0dmFsID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBzZWFyY2hbIDAgXSwgImxhc3R2YWwiICkgKyAiIjsKCgkJCWlmICggbGFzdHZhbCAmJiBsYXN0dmFsID09PSB2YWwgKSB7CgkJCQkvLyBFeGVjdXRlIHRoZSBoYW5kbGVyIG9ubHkgb25jZSBwZXIgdmFsdWUgY2hhbmdlCgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aGlzLl90aW1lciApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9CgoJCQl0aGlzLl90aW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZWZpbHRlciIsIG51bGwsIHsgaW5wdXQ6IHNlYXJjaCB9ICkgPT09IGZhbHNlICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCQlzZWFyY2hbIDAgXS5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJsYXN0dmFsIiwgdmFsICk7CgoJCQkJdGhpcy5fZmlsdGVySXRlbXMoIHZhbCApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9LCAyNTAgKTsKCQl9Cgl9LAoKCV9nZXRGaWx0ZXJhYmxlSXRlbXM6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQljaGlsZHJlbiA9IHRoaXMub3B0aW9ucy5jaGlsZHJlbiwKCQkJaXRlbXMgPSAhY2hpbGRyZW4gPyB7IGxlbmd0aDogMCB9OgoJCQkJJC5pc0Z1bmN0aW9uKCBjaGlsZHJlbiApID8gY2hpbGRyZW4oKToKCQkJCWNoaWxkcmVuLm5vZGVOYW1lID8gJCggY2hpbGRyZW4gKToKCQkJCWNoaWxkcmVuLmpxdWVyeSA/IGNoaWxkcmVuOgoJCQkJdGhpcy5lbGVtZW50LmZpbmQoIGNoaWxkcmVuICk7CgoJCWlmICggaXRlbXMubGVuZ3RoID09PSAwICkgewoJCQlpdGVtcyA9IGVsZW0uY2hpbGRyZW4oKTsKCQl9CgoJCXJldHVybiBpdGVtczsKCX0sCgoJX2ZpbHRlckl0ZW1zOiBmdW5jdGlvbiggdmFsICkgewoJCXZhciBpZHgsIGNhbGxiYWNrLCBsZW5ndGgsIGRzdCwKCQkJc2hvdyA9IFtdLAoJCQloaWRlID0gW10sCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWZpbHRlckl0ZW1zID0gdGhpcy5fZ2V0RmlsdGVyYWJsZUl0ZW1zKCk7CgoJCWlmICggdmFsICE9IG51bGwgKSB7CgkJCWNhbGxiYWNrID0gb3B0cy5maWx0ZXJDYWxsYmFjayB8fCBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgkJCWxlbmd0aCA9IGZpbHRlckl0ZW1zLmxlbmd0aDsKCgkJCS8vIFBhcnRpdGlvbiB0aGUgaXRlbXMgaW50byB0aG9zZSB0byBiZSBoaWRkZW4gYW5kIHRob3NlIHRvIGJlIHNob3duCgkJCWZvciAoIGlkeCA9IDAgOyBpZHggPCBsZW5ndGggOyBpZHgrKyApIHsKCQkJCWRzdCA9ICggY2FsbGJhY2suY2FsbCggZmlsdGVySXRlbXNbIGlkeCBdLCBpZHgsIHZhbCApICkgPyBoaWRlIDogc2hvdzsKCQkJCWRzdC5wdXNoKCBmaWx0ZXJJdGVtc1sgaWR4IF0gKTsKCQkJfQoJCX0KCgkJLy8gSWYgbm90aGluZyBpcyBoaWRkZW4sIHRoZW4gdGhlIGRlY2lzaW9uIHdoZXRoZXIgdG8gaGlkZSBvciBzaG93IHRoZSBpdGVtcwoJCS8vIGlzIGJhc2VkIG9uIHRoZSAiZmlsdGVyUmV2ZWFsIiBvcHRpb24uCgkJaWYgKCBoaWRlLmxlbmd0aCA9PT0gMCApIHsKCQkJZmlsdGVySXRlbXNbICggb3B0cy5maWx0ZXJSZXZlYWwgJiYgdmFsLmxlbmd0aCA9PT0gMCApID8KCQkJCSJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiIF0oICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCSQoIGhpZGUgKS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCSQoIHNob3cgKS5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoQ2hpbGRXaWRnZXQoKTsKCgkJdGhpcy5fdHJpZ2dlciggImZpbHRlciIsIG51bGwsIHsKCQkJaXRlbXM6IGZpbHRlckl0ZW1zCgkJfSk7Cgl9LAoKCS8vIFRoZSBEZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIF9yZWZyZXNoQ2hpbGRXaWRnZXQgYXR0ZW1wdHMgdG8gY2FsbAoJLy8gcmVmcmVzaCBvbiBjb2xsYXBzaWJsZXNldCwgY29udHJvbGdyb3VwLCBzZWxlY3RtZW51LCBvciBsaXN0dmlldwoJX3JlZnJlc2hDaGlsZFdpZGdldDogZnVuY3Rpb24oKSB7CgkJdmFyIHdpZGdldCwgaWR4LAoJCQlyZWNvZ25pemVkV2lkZ2V0cyA9IFsgImNvbGxhcHNpYmxlc2V0IiwgInNlbGVjdG1lbnUiLCAiY29udHJvbGdyb3VwIiwgImxpc3R2aWV3IiBdOwoKCQlmb3IgKCBpZHggPSByZWNvZ25pemVkV2lkZ2V0cy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJd2lkZ2V0ID0gcmVjb2duaXplZFdpZGdldHNbIGlkeCBdOwoJCQlpZiAoICQubW9iaWxlWyB3aWRnZXQgXSApIHsKCQkJCXdpZGdldCA9IHRoaXMuZWxlbWVudC5kYXRhKCAibW9iaWxlLSIgKyB3aWRnZXQgKTsKCQkJCWlmICggd2lkZ2V0ICYmICQuaXNGdW5jdGlvbiggd2lkZ2V0LnJlZnJlc2ggKSApIHsKCQkJCQl3aWRnZXQucmVmcmVzaCgpOwoJCQkJfQoJCQl9CgkJfQoJfSwKCgkvLyBUT0RPOiBXaGVuIHRoZSBpbnB1dCBpcyBub3QgaW50ZXJuYWwsIGRvIG5vdCBldmVuIHN0b3JlIGl0IGluIHRoaXMuX3NlYXJjaAoJX3NldElucHV0OiBmdW5jdGlvbiAoIHNlbGVjdG9yICkgewoJCXZhciBzZWFyY2ggPSB0aGlzLl9zZWFyY2g7CgoJCS8vIFN0b3AgYSBwZW5kaW5nIGZpbHRlciBvcGVyYXRpb24KCQlpZiAoIHRoaXMuX3RpbWVyICkgewoJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aGlzLl90aW1lciApOwoJCQl0aGlzLl90aW1lciA9IDA7CgkJfQoKCQlpZiAoIHNlYXJjaCApIHsKCQkJdGhpcy5fb2ZmKCBzZWFyY2gsICJrZXl1cCBjaGFuZ2UgaW5wdXQiICk7CgkJCXNlYXJjaCA9IG51bGw7CgkJfQoKCQlpZiAoIHNlbGVjdG9yICkgewoJCQlzZWFyY2ggPSBzZWxlY3Rvci5qcXVlcnkgPyBzZWxlY3RvcjoKCQkJCXNlbGVjdG9yLm5vZGVOYW1lID8gJCggc2VsZWN0b3IgKToKCQkJCXRoaXMuZG9jdW1lbnQuZmluZCggc2VsZWN0b3IgKTsKCgkJCXRoaXMuX29uKCBzZWFyY2gsIHsKCQkJCWtleWRvd246ICJfb25LZXlEb3duIiwKCQkJCWtleXByZXNzOiAiX29uS2V5UHJlc3MiLAoJCQkJa2V5dXA6ICJfb25LZXlVcCIsCgkJCQljaGFuZ2U6ICJfb25LZXlVcCIsCgkJCQlpbnB1dDogIl9vbktleVVwIgoJCQl9KTsKCQl9CgoJCXRoaXMuX3NlYXJjaCA9IHNlYXJjaDsKCX0sCgoJLy8gUHJldmVudCBmb3JtIHN1Ym1pc3Npb24KCV9vbktleURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5FTlRFUiApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJdGhpcy5fcHJldmVudEtleVByZXNzID0gdHJ1ZTsKCQl9Cgl9LAoKCV9vbktleVByZXNzOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9wcmV2ZW50S2V5UHJlc3MgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXRoaXMuX3ByZXZlbnRLZXlQcmVzcyA9IGZhbHNlOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZWZpbHRlciA9ICEoICggb3B0aW9ucy5maWx0ZXJSZXZlYWwgPT09IHVuZGVmaW5lZCApICYmCgkJCQkoIG9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPT09IHVuZGVmaW5lZCApICYmCgkJCQkoIG9wdGlvbnMuY2hpbGRyZW4gPT09IHVuZGVmaW5lZCApICk7CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggb3B0aW9ucy5pbnB1dCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRJbnB1dCggb3B0aW9ucy5pbnB1dCApOwoJCQlyZWZpbHRlciA9IHRydWU7CgkJfQoKCQlpZiAoIHJlZmlsdGVyICkgewoJCQl0aGlzLnJlZnJlc2goKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJaXRlbXMgPSB0aGlzLl9nZXRGaWx0ZXJhYmxlSXRlbXMoKTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlpdGVtcy50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBvcHRzLmZpbHRlclJldmVhbCApOwoJCX0gZWxzZSB7CgkJCWl0ZW1zLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMuX3RpbWVyICk7CgkJCXRoaXMuX3RpbWVyID0gMDsKCQl9CgkJdGhpcy5fZmlsdGVySXRlbXMoICggKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLnZhbCgpICkgfHwgIiIgKS50b0xvd2VyQ2FzZSgpICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBDcmVhdGUgYSBmdW5jdGlvbiB0aGF0IHdpbGwgcmVwbGFjZSB0aGUgX3NldE9wdGlvbnMgZnVuY3Rpb24gb2YgYSB3aWRnZXQsCi8vIGFuZCB3aWxsIHBhc3MgdGhlIG9wdGlvbnMgb24gdG8gdGhlIGlucHV0IG9mIHRoZSBmaWx0ZXJhYmxlLgp2YXIgcmVwbGFjZVNldE9wdGlvbnMgPSBmdW5jdGlvbiggc2VsZiwgb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCW9yaWcuY2FsbCggdGhpcywgb3B0aW9ucyApOwoJCQlzZWxmLl9zeW5jVGV4dElucHV0T3B0aW9ucyggb3B0aW9ucyApOwoJCX07Cgl9LAoJckRpdmlkZXJMaXN0SXRlbSA9IC8oXnxccyl1aS1saS1kaXZpZGVyKFxzfCQpLywKCW9yaWdEZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSAkLm1vYmlsZS5maWx0ZXJhYmxlLnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrOwoKLy8gT3ZlcnJpZGUgdGhlIGRlZmF1bHQgZmlsdGVyIGNhbGxiYWNrIHdpdGggb25lIHRoYXQgZG9lcyBub3QgaGlkZSBsaXN0IGRpdmlkZXJzCiQubW9iaWxlLmZpbHRlcmFibGUucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggaW5kZXgsIHNlYXJjaFZhbHVlICkgewoJcmV0dXJuICF0aGlzLmNsYXNzTmFtZS5tYXRjaCggckRpdmlkZXJMaXN0SXRlbSApICYmCgkJb3JpZ0RlZmF1bHRGaWx0ZXJDYWxsYmFjay5jYWxsKCB0aGlzLCBpbmRleCwgc2VhcmNoVmFsdWUgKTsKfTsKCiQud2lkZ2V0KCAibW9iaWxlLmZpbHRlcmFibGUiLCAkLm1vYmlsZS5maWx0ZXJhYmxlLCB7CglvcHRpb25zOiB7CgkJZmlsdGVyUGxhY2Vob2xkZXI6ICJGaWx0ZXIgaXRlbXMuLi4iLAoJCWZpbHRlclRoZW1lOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpZHgsIHdpZGdldE5hbWUsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCXJlY29nbml6ZWRXaWRnZXRzID0gWyAiY29sbGFwc2libGVzZXQiLCAic2VsZWN0bWVudSIsICJjb250cm9sZ3JvdXAiLCAibGlzdHZpZXciIF0sCgkJCWNyZWF0ZUhhbmRsZXJzID0ge307CgoJCXRoaXMuX3N1cGVyKCk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV93aWRnZXQ6IG51bGwKCQl9KTsKCgkJZm9yICggaWR4ID0gcmVjb2duaXplZFdpZGdldHMubGVuZ3RoIC0gMSA7IGlkeCA+IC0xIDsgaWR4LS0gKSB7CgkJCXdpZGdldE5hbWUgPSByZWNvZ25pemVkV2lkZ2V0c1sgaWR4IF07CgkJCWlmICggJC5tb2JpbGVbIHdpZGdldE5hbWUgXSApIHsKCQkJCWlmICggdGhpcy5fc2V0V2lkZ2V0KCBlbGVtLmRhdGEoICJtb2JpbGUtIiArIHdpZGdldE5hbWUgKSApICkgewoJCQkJCWJyZWFrOwoJCQkJfSBlbHNlIHsKCQkJCQljcmVhdGVIYW5kbGVyc1sgd2lkZ2V0TmFtZSArICJjcmVhdGUiIF0gPSAiX2hhbmRsZUNyZWF0ZSI7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggIXRoaXMuX3dpZGdldCApIHsKCQkJdGhpcy5fb24oIGVsZW0sIGNyZWF0ZUhhbmRsZXJzICk7CgkJfQoJfSwKCglfaGFuZGxlQ3JlYXRlOiBmdW5jdGlvbiggZXZ0ICkgewoJCXRoaXMuX3NldFdpZGdldCggdGhpcy5lbGVtZW50LmRhdGEoICJtb2JpbGUtIiArIGV2dC50eXBlLnN1YnN0cmluZyggMCwgZXZ0LnR5cGUubGVuZ3RoIC0gNiApICkgKTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQlpZiAoIHRoaXMuX3dpZGdldCAmJiB0aGlzLl93aWRnZXQud2lkZ2V0RnVsbE5hbWUgPT09ICJtb2JpbGUtbGlzdHZpZXciICYmCgkJCXR5cGUgPT09ICJiZWZvcmVmaWx0ZXIiICkgewoKCQkJLy8gQWxzbyB0cmlnZ2VyIGxpc3R2aWV3YmVmb3JlZmlsdGVyIGlmIHRoaXMgd2lkZ2V0IGlzIGFsc28gYSBsaXN0dmlldwoJCQl0aGlzLl93aWRnZXQuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCBldmVudCwgZGF0YSApOwoJCX0KCgkJLy8gUGFzc2luZyBiYWNrIHRoZSByZXNwb25zZSBlbmFibGVzIGNhbGxpbmcgcHJldmVudERlZmF1bHQoKQoJCXJldHVybiB0aGlzLl9zdXBlciggdHlwZSwgZXZlbnQsIGRhdGEgKTsKCX0sCgoJX3NldFdpZGdldDogZnVuY3Rpb24oIHdpZGdldCApIHsKCQlpZiAoICF0aGlzLl93aWRnZXQgJiYgd2lkZ2V0ICkgewoJCQl0aGlzLl93aWRnZXQgPSB3aWRnZXQ7CgkJCXRoaXMuX3dpZGdldC5fc2V0T3B0aW9ucyA9IHJlcGxhY2VTZXRPcHRpb25zKCB0aGlzLCB0aGlzLl93aWRnZXQuX3NldE9wdGlvbnMgKTsKCQl9CgoJCWlmICggISF0aGlzLl93aWRnZXQgKSB7CgkJCXRoaXMuX3N5bmNUZXh0SW5wdXRPcHRpb25zKCB0aGlzLl93aWRnZXQub3B0aW9ucyApOwoJCQlpZiAoIHRoaXMuX3dpZGdldC53aWRnZXROYW1lID09PSAibGlzdHZpZXciICkgewoJCQkJdGhpcy5fd2lkZ2V0Lm9wdGlvbnMuaGlkZURpdmlkZXJzID0gdHJ1ZTsKCQkJCXRoaXMuX3dpZGdldC5lbGVtZW50Lmxpc3R2aWV3KCAicmVmcmVzaCIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuICEhdGhpcy5fd2lkZ2V0OwoJfSwKCglfaXNTZWFyY2hJbnRlcm5hbDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggdGhpcy5fc2VhcmNoICYmIHRoaXMuX3NlYXJjaC5qcW1EYXRhKCAidWktZmlsdGVyYWJsZS0iICsgdGhpcy51dWlkICsgIi1pbnRlcm5hbCIgKSApOwoJfSwKCglfc2V0SW5wdXQ6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJdXBkYXRlUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQl0ZXh0aW5wdXRPcHRzID0ge307CgoJCWlmICggIXNlbGVjdG9yICkgewoJCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSApIHsKCgkJCQkvLyBJZ25vcmUgdGhlIGNhbGwgdG8gc2V0IGEgbmV3IGlucHV0IGlmIHRoZSBzZWxlY3RvciBnb2VzIHRvIGZhbHN5IGFuZAoJCQkJLy8gdGhlIGN1cnJlbnQgdGV4dGlucHV0IGlzIGFscmVhZHkgb2YgdGhlIGludGVybmFsbHkgZ2VuZXJhdGVkIHZhcmlldHkuCgkJCQlyZXR1cm47CgkJCX0gZWxzZSB7CgoJCQkJLy8gR2VuZXJhdGluZyBhIG5ldyB0ZXh0aW5wdXQgd2lkZ2V0LiBObyBuZWVkIHRvIHNldCB0aGUgcGxhY2Vob2xkZXIKCQkJCS8vIGZ1cnRoZXIgZG93biB0aGUgZnVuY3Rpb24uCgkJCQl1cGRhdGVQbGFjZWhvbGRlciA9IGZhbHNlOwoJCQkJc2VsZWN0b3IgPSAkKCAiPGlucHV0ICIgKwoJCQkJCSJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPSdzZWFyY2gnICIgKwoJCQkJCSJwbGFjZWhvbGRlcj0nIiArIG9wdHMuZmlsdGVyUGxhY2Vob2xkZXIgKyAiJz48L2lucHV0PiIgKQoJCQkJCS5qcW1EYXRhKCAidWktZmlsdGVyYWJsZS0iICsgdGhpcy51dWlkICsgIi1pbnRlcm5hbCIsIHRydWUgKTsKCQkJCSQoICI8Zm9ybSBjbGFzcz0ndWktZmlsdGVyYWJsZSc+PC9mb3JtPiIgKQoJCQkJCS5hcHBlbmQoIHNlbGVjdG9yICkKCQkJCQkuc3VibWl0KCBmdW5jdGlvbiggZXZ0ICkgewoJCQkJCQlldnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJc2VsZWN0b3IuYmx1cigpOwoJCQkJCX0pCgkJCQkJLmluc2VydEJlZm9yZSggdGhpcy5lbGVtZW50ICk7CgkJCQlpZiAoICQubW9iaWxlLnRleHRpbnB1dCApIHsKCQkJCQlpZiAoIHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZSAhPSBudWxsICkgewoJCQkJCQl0ZXh0aW5wdXRPcHRzWyAidGhlbWUiIF0gPSBvcHRzLmZpbHRlclRoZW1lOwoJCQkJCX0KCgkJCQkJc2VsZWN0b3IudGV4dGlucHV0KCB0ZXh0aW5wdXRPcHRzICk7CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuX3N1cGVyKCBzZWxlY3RvciApOwoKCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSAmJiB1cGRhdGVQbGFjZWhvbGRlciApIHsKCQkJdGhpcy5fc2VhcmNoLmF0dHIoICJwbGFjZWhvbGRlciIsIHRoaXMub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciApOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZXQgPSB0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkvLyBOZWVkIHRvIHNldCB0aGUgZmlsdGVyUGxhY2Vob2xkZXIgYWZ0ZXIgaGF2aW5nIGVzdGFibGlzaGVkIHRoZSBzZWFyY2ggaW5wdXQKCQlpZiAoIG9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgKSB7CgkJCQl0aGlzLl9zZWFyY2guYXR0ciggInBsYWNlaG9sZGVyIiwgb3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciApOwoJCQl9CgkJfQoKCQlpZiAoIG9wdGlvbnMuZmlsdGVyVGhlbWUgIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9zZWFyY2ggJiYgJC5tb2JpbGUudGV4dGlucHV0ICkgewoJCQl0aGlzLl9zZWFyY2gudGV4dGlucHV0KCAib3B0aW9uIiwgInRoZW1lIiwgb3B0aW9ucy5maWx0ZXJUaGVtZSApOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICkgewoJCQl0aGlzLl9zZWFyY2gucmVtb3ZlKCk7CgkJfQoJCXRoaXMuX3N1cGVyKCk7Cgl9LAoKCV9zeW5jVGV4dElucHV0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlkeCwKCQkJdGV4dGlucHV0T3B0aW9ucyA9IHt9OwoKCQkvLyBXZSBvbmx5IHN5bmMgb3B0aW9ucyBpZiB0aGUgZmlsdGVyYWJsZSdzIHRleHRpbnB1dCBpcyBvZiB0aGUgaW50ZXJuYWxseQoJCS8vIGdlbmVyYXRlZCB2YXJpZXR5LCByYXRoZXIgdGhhbiBvbmUgc3BlY2lmaWVkIGJ5IHRoZSB1c2VyLgoJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICYmICQubW9iaWxlLnRleHRpbnB1dCApIHsKCgkJCS8vIEFwcGx5IG9ubHkgdGhlIG9wdGlvbnMgdW5kZXJzdG9vZCBieSB0ZXh0aW5wdXQKCQkJZm9yICggaWR4IGluICQubW9iaWxlLnRleHRpbnB1dC5wcm90b3R5cGUub3B0aW9ucyApIHsKCQkJCWlmICggb3B0aW9uc1sgaWR4IF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCQlpZiAoIGlkeCA9PT0gInRoZW1lIiAmJiB0aGlzLm9wdGlvbnMuZmlsdGVyVGhlbWUgIT0gbnVsbCApIHsKCQkJCQkJdGV4dGlucHV0T3B0aW9uc1sgaWR4IF0gPSB0aGlzLm9wdGlvbnMuZmlsdGVyVGhlbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGV4dGlucHV0T3B0aW9uc1sgaWR4IF0gPSBvcHRpb25zWyBpZHggXTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJdGhpcy5fc2VhcmNoLnRleHRpbnB1dCggIm9wdGlvbiIsIHRleHRpbnB1dE9wdGlvbnMgKTsKCQl9Cgl9Cn0pOwoKLy8gSW5zdGFudGlhdGUgYSBmaWx0ZXJhYmxlIG9uIGEgbGlzdHZpZXcgdGhhdCBoYXMgdGhlIGRhdGEtZmlsdGVyPSJ0cnVlIiBhdHRyaWJ1dGUKLy8gVGhpcyBpcyBub3QgbmVjZXNzYXJ5IGZvciBzdGF0aWMgY29udGVudCwgYmVjYXVzZSB0aGUgYXV0by1lbmhhbmNlIHRha2VzIGNhcmUgb2YgaW5zdGFudGlhdGluZwovLyB0aGUgZmlsdGVyYWJsZSB1cG9uIGVuY291bnRlcmluZyBkYXRhLWZpbHRlcj0idHJ1ZSIuIEhvd2V2ZXIsIGJlY2F1c2Ugb2YgMS4zLnggaXQgaXMgZXhwZWN0ZWQKLy8gdGhhdCBhIGxpc3R2aWV3IHdpdGggZGF0YS1maWx0ZXI9InRydWUiIHdpbGwgYmUgZmlsdGVyYWJsZSBldmVuIGlmIHlvdSBqdXN0IGluc3RhbnRpYXRlIGEKLy8gbGlzdHZpZXcgb24gaXQuIFRoZSBleHRlbnNpb24gYmVsb3cgZW5zdXJlcyB0aGF0IHRoaXMgY29udGludWVzIHRvIGhhcHBlbiBpbiAxLjQueC4KJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS5saXN0dmlldywgewoJb3B0aW9uczogewoJCWZpbHRlcjogZmFsc2UKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5maWx0ZXIgPT09IHRydWUgJiYKCQkJCSF0aGlzLmVsZW1lbnQuZGF0YSggIm1vYmlsZS1maWx0ZXJhYmxlIiApICkgewoJCQl0aGlzLmVsZW1lbnQuZmlsdGVyYWJsZSgpOwoJCX0KCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgovKiEKICogalF1ZXJ5IFVJIFRhYnMgYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MAogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3RhYnMvCiAqCiAqIERlcGVuZHM6CiAqCWpxdWVyeS51aS5jb3JlLmpzCiAqCWpxdWVyeS51aS53aWRnZXQuanMKICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHRhYklkID0gMCwKCXJoYXNoID0gLyMuKiQvOwoKZnVuY3Rpb24gZ2V0TmV4dFRhYklkKCkgewoJcmV0dXJuICsrdGFiSWQ7Cn0KCmZ1bmN0aW9uIGlzTG9jYWwoIGFuY2hvciApIHsKCS8vIHN1cHBvcnQ6IElFNwoJLy8gSUU3IGRvZXNuJ3Qgbm9ybWFsaXplIHRoZSBocmVmIHByb3BlcnR5IHdoZW4gc2V0IHZpYSBzY3JpcHQgKCM5MzE3KQoJYW5jaG9yID0gYW5jaG9yLmNsb25lTm9kZSggZmFsc2UgKTsKCglyZXR1cm4gYW5jaG9yLmhhc2gubGVuZ3RoID4gMSAmJgoJCWRlY29kZVVSSUNvbXBvbmVudCggYW5jaG9yLmhyZWYucmVwbGFjZSggcmhhc2gsICIiICkgKSA9PT0KCQkJZGVjb2RlVVJJQ29tcG9uZW50KCBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoIHJoYXNoLCAiIiApICk7Cn0KCiQud2lkZ2V0KCAidWkudGFicyIsIHsKCXZlcnNpb246ICJjMGFiNzEwNTZiOTM2NjI3ZThhNzgyMWYwM2MwNDRhZWM2MjgwYTQwIiwKCWRlbGF5OiAzMDAsCglvcHRpb25zOiB7CgkJYWN0aXZlOiBudWxsLAoJCWNvbGxhcHNpYmxlOiBmYWxzZSwKCQlldmVudDogImNsaWNrIiwKCQloZWlnaHRTdHlsZTogImNvbnRlbnQiLAoJCWhpZGU6IG51bGwsCgkJc2hvdzogbnVsbCwKCgkJLy8gY2FsbGJhY2tzCgkJYWN0aXZhdGU6IG51bGwsCgkJYmVmb3JlQWN0aXZhdGU6IG51bGwsCgkJYmVmb3JlTG9hZDogbnVsbCwKCQlsb2FkOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgoJCXRoaXMuZWxlbWVudAoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYWxsIiApCgkJCS50b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCBvcHRpb25zLmNvbGxhcHNpYmxlICkKCQkJLy8gUHJldmVudCB1c2VycyBmcm9tIGZvY3VzaW5nIGRpc2FibGVkIHRhYnMgdmlhIGNsaWNrCgkJCS5kZWxlZ2F0ZSggIi51aS10YWJzLW5hdiA+IGxpIiwgIm1vdXNlZG93biIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICQoIHRoaXMgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9KQoJCQkvLyBzdXBwb3J0OiBJRSA8OQoJCQkvLyBQcmV2ZW50aW5nIHRoZSBkZWZhdWx0IGFjdGlvbiBpbiBtb3VzZWRvd24gZG9lc24ndCBwcmV2ZW50IElFCgkJCS8vIGZyb20gZm9jdXNpbmcgdGhlIGVsZW1lbnQsIHNvIGlmIHRoZSBhbmNob3IgZ2V0cyBmb2N1c2VkLCBibHVyLgoJCQkvLyBXZSBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IGZvY3VzaW5nIHRoZSBwcmV2aW91c2x5IGZvY3VzZWQKCQkJLy8gZWxlbWVudCBzaW5jZSBjbGlja2luZyBvbiBhIG5vbi1mb2N1c2FibGUgZWxlbWVudCBzaG91bGQgZm9jdXMKCQkJLy8gdGhlIGJvZHkgYW55d2F5LgoJCQkuZGVsZWdhdGUoICIudWktdGFicy1hbmNob3IiLCAiZm9jdXMiICsgdGhpcy5ldmVudE5hbWVzcGFjZSwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoICQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuaXMoICIudWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCQkJdGhpcy5ibHVyKCk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLl9wcm9jZXNzVGFicygpOwoJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy5faW5pdGlhbEFjdGl2ZSgpOwoKCQkvLyBUYWtlIGRpc2FibGluZyB0YWJzIHZpYSBjbGFzcyBhdHRyaWJ1dGUgZnJvbSBIVE1MCgkJLy8gaW50byBhY2NvdW50IGFuZCB1cGRhdGUgb3B0aW9uIHByb3Blcmx5LgoJCWlmICggJC5pc0FycmF5KCBvcHRpb25zLmRpc2FibGVkICkgKSB7CgkJCW9wdGlvbnMuZGlzYWJsZWQgPSAkLnVuaXF1ZSggb3B0aW9ucy5kaXNhYmxlZC5jb25jYXQoCgkJCQkkLm1hcCggdGhpcy50YWJzLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSwgZnVuY3Rpb24oIGxpICkgewoJCQkJCXJldHVybiB0aGF0LnRhYnMuaW5kZXgoIGxpICk7CgkJCQl9KQoJCQkpICkuc29ydCgpOwoJCX0KCgkJLy8gY2hlY2sgZm9yIGxlbmd0aCBhdm9pZHMgZXJyb3Igd2hlbiBpbml0aWFsaXppbmcgZW1wdHkgbGlzdAoJCWlmICggdGhpcy5vcHRpb25zLmFjdGl2ZSAhPT0gZmFsc2UgJiYgdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJdGhpcy5hY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBvcHRpb25zLmFjdGl2ZSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuYWN0aXZlID0gJCgpOwoJCX0KCgkJdGhpcy5fcmVmcmVzaCgpOwoKCQlpZiAoIHRoaXMuYWN0aXZlLmxlbmd0aCApIHsKCQkJdGhpcy5sb2FkKCBvcHRpb25zLmFjdGl2ZSApOwoJCX0KCX0sCgoJX2luaXRpYWxBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCXZhciBhY3RpdmUgPSB0aGlzLm9wdGlvbnMuYWN0aXZlLAoJCQljb2xsYXBzaWJsZSA9IHRoaXMub3B0aW9ucy5jb2xsYXBzaWJsZSwKCQkJbG9jYXRpb25IYXNoID0gbG9jYXRpb24uaGFzaC5zdWJzdHJpbmcoIDEgKTsKCgkJaWYgKCBhY3RpdmUgPT09IG51bGwgKSB7CgkJCS8vIGNoZWNrIHRoZSBmcmFnbWVudCBpZGVudGlmaWVyIGluIHRoZSBVUkwKCQkJaWYgKCBsb2NhdGlvbkhhc2ggKSB7CgkJCQl0aGlzLnRhYnMuZWFjaChmdW5jdGlvbiggaSwgdGFiICkgewoJCQkJCWlmICggJCggdGFiICkuYXR0ciggImFyaWEtY29udHJvbHMiICkgPT09IGxvY2F0aW9uSGFzaCApIHsKCQkJCQkJYWN0aXZlID0gaTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgoJCQkvLyBjaGVjayBmb3IgYSB0YWIgbWFya2VkIGFjdGl2ZSB2aWEgYSBjbGFzcwoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCQkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmZpbHRlciggIi51aS10YWJzLWFjdGl2ZSIgKSApOwoJCQl9CgoJCQkvLyBubyBhY3RpdmUgdGFiLCBzZXQgdG8gZmFsc2UKCQkJaWYgKCBhY3RpdmUgPT09IG51bGwgfHwgYWN0aXZlID09PSAtMSApIHsKCQkJCWFjdGl2ZSA9IHRoaXMudGFicy5sZW5ndGggPyAwIDogZmFsc2U7CgkJCX0KCQl9CgoJCS8vIGhhbmRsZSBudW1iZXJzOiBuZWdhdGl2ZSwgb3V0IG9mIHJhbmdlCgkJaWYgKCBhY3RpdmUgIT09IGZhbHNlICkgewoJCQlhY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMudGFicy5lcSggYWN0aXZlICkgKTsKCQkJaWYgKCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gY29sbGFwc2libGUgPyBmYWxzZSA6IDA7CgkJCX0KCQl9CgoJCS8vIGRvbid0IGFsbG93IGNvbGxhcHNpYmxlOiBmYWxzZSBhbmQgYWN0aXZlOiBmYWxzZQoJCWlmICggIWNvbGxhcHNpYmxlICYmIGFjdGl2ZSA9PT0gZmFsc2UgJiYgdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJYWN0aXZlID0gMDsKCQl9CgoJCXJldHVybiBhY3RpdmU7Cgl9LAoKCV9nZXRDcmVhdGVFdmVudERhdGE6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB7CgkJCXRhYjogdGhpcy5hY3RpdmUsCgkJCXBhbmVsOiAhdGhpcy5hY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkKCQl9OwoJfSwKCglfdGFiS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBmb2N1c2VkVGFiID0gJCggdGhpcy5kb2N1bWVudFswXS5hY3RpdmVFbGVtZW50ICkuY2xvc2VzdCggImxpIiApLAoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy50YWJzLmluZGV4KCBmb2N1c2VkVGFiICksCgkJCWdvaW5nRm9yd2FyZCA9IHRydWU7CgoJCWlmICggdGhpcy5faGFuZGxlUGFnZU5hdiggZXZlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLnVpLmtleUNvZGUuUklHSFQ6CgkJCWNhc2UgJC51aS5rZXlDb2RlLkRPV046CgkJCQlzZWxlY3RlZEluZGV4Kys7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuVVA6CgkJCWNhc2UgJC51aS5rZXlDb2RlLkxFRlQ6CgkJCQlnb2luZ0ZvcndhcmQgPSBmYWxzZTsKCQkJCXNlbGVjdGVkSW5kZXgtLTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5FTkQ6CgkJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5hbmNob3JzLmxlbmd0aCAtIDE7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuSE9NRToKCQkJCXNlbGVjdGVkSW5kZXggPSAwOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlNQQUNFOgoJCQkJLy8gQWN0aXZhdGUgb25seSwgbm8gY29sbGFwc2luZwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCApOwoJCQkJcmV0dXJuOwoJCQljYXNlICQudWkua2V5Q29kZS5FTlRFUjoKCQkJCS8vIFRvZ2dsZSAoY2FuY2VsIGRlbGF5ZWQgYWN0aXZhdGlvbiwgYWxsb3cgY29sbGFwc2luZykKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCQkJLy8gRGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBjb2xsYXBzZSBvciBhY3RpdmF0ZQoJCQkJdGhpcy5fYWN0aXZhdGUoIHNlbGVjdGVkSW5kZXggPT09IHRoaXMub3B0aW9ucy5hY3RpdmUgPyBmYWxzZSA6IHNlbGVjdGVkSW5kZXggKTsKCQkJCXJldHVybjsKCQkJZGVmYXVsdDoKCQkJCXJldHVybjsKCQl9CgoJCS8vIEZvY3VzIHRoZSBhcHByb3ByaWF0ZSB0YWIsIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5fZm9jdXNOZXh0VGFiKCBzZWxlY3RlZEluZGV4LCBnb2luZ0ZvcndhcmQgKTsKCgkJLy8gTmF2aWdhdGluZyB3aXRoIGNvbnRyb2wga2V5IHdpbGwgcHJldmVudCBhdXRvbWF0aWMgYWN0aXZhdGlvbgoJCWlmICggIWV2ZW50LmN0cmxLZXkgKSB7CgkJCS8vIFVwZGF0ZSBhcmlhLXNlbGVjdGVkIGltbWVkaWF0ZWx5IHNvIHRoYXQgQVQgdGhpbmsgdGhlIHRhYiBpcyBhbHJlYWR5IHNlbGVjdGVkLgoJCQkvLyBPdGhlcndpc2UgQVQgbWF5IGNvbmZ1c2UgdGhlIHVzZXIgYnkgc3RhdGluZyB0aGF0IHRoZXkgbmVlZCB0byBhY3RpdmF0ZSB0aGUgdGFiLAoJCQkvLyBidXQgdGhlIHRhYiB3aWxsIGFscmVhZHkgYmUgYWN0aXZhdGVkIGJ5IHRoZSB0aW1lIHRoZSBhbm5vdW5jZW1lbnQgZmluaXNoZXMuCgkJCWZvY3VzZWRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJCXRoaXMudGFicy5lcSggc2VsZWN0ZWRJbmRleCApLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgInRydWUiICk7CgoJCQl0aGlzLmFjdGl2YXRpbmcgPSB0aGlzLl9kZWxheShmdW5jdGlvbigpIHsKCQkJCXRoaXMub3B0aW9uKCAiYWN0aXZlIiwgc2VsZWN0ZWRJbmRleCApOwoJCQl9LCB0aGlzLmRlbGF5ICk7CgkJfQoJfSwKCglfcGFuZWxLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBDdHJsK3VwIG1vdmVzIGZvY3VzIHRvIHRoZSBjdXJyZW50IHRhYgoJCWlmICggZXZlbnQuY3RybEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuVVAgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXRoaXMuYWN0aXZlLmZvY3VzKCk7CgkJfQoJfSwKCgkvLyBBbHQrcGFnZSB1cC9kb3duIG1vdmVzIGZvY3VzIHRvIHRoZSBwcmV2aW91cy9uZXh0IHRhYiAoYW5kIGFjdGl2YXRlcykKCV9oYW5kbGVQYWdlTmF2OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCBldmVudC5hbHRLZXkgJiYgZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlBBR0VfVVAgKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgLSAxLCBmYWxzZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9ET1dOICkgewoJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZm9jdXNOZXh0VGFiKCB0aGlzLm9wdGlvbnMuYWN0aXZlICsgMSwgdHJ1ZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0sCgoJX2ZpbmROZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQl2YXIgbGFzdFRhYkluZGV4ID0gdGhpcy50YWJzLmxlbmd0aCAtIDE7CgoJCWZ1bmN0aW9uIGNvbnN0cmFpbigpIHsKCQkJaWYgKCBpbmRleCA+IGxhc3RUYWJJbmRleCApIHsKCQkJCWluZGV4ID0gMDsKCQkJfQoJCQlpZiAoIGluZGV4IDwgMCApIHsKCQkJCWluZGV4ID0gbGFzdFRhYkluZGV4OwoJCQl9CgkJCXJldHVybiBpbmRleDsKCQl9CgoJCXdoaWxlICggJC5pbkFycmF5KCBjb25zdHJhaW4oKSwgdGhpcy5vcHRpb25zLmRpc2FibGVkICkgIT09IC0xICkgewoJCQlpbmRleCA9IGdvaW5nRm9yd2FyZCA/IGluZGV4ICsgMSA6IGluZGV4IC0gMTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2ZvY3VzTmV4dFRhYjogZnVuY3Rpb24oIGluZGV4LCBnb2luZ0ZvcndhcmQgKSB7CgkJaW5kZXggPSB0aGlzLl9maW5kTmV4dFRhYiggaW5kZXgsIGdvaW5nRm9yd2FyZCApOwoJCXRoaXMudGFicy5lcSggaW5kZXggKS5mb2N1cygpOwoJCXJldHVybiBpbmRleDsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJhY3RpdmUiICkgewoJCQkvLyBfYWN0aXZhdGUoKSB3aWxsIGhhbmRsZSBpbnZhbGlkIHZhbHVlcyBhbmQgdXBkYXRlIHRoaXMub3B0aW9ucwoJCQl0aGlzLl9hY3RpdmF0ZSggdmFsdWUgKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCS8vIGRvbid0IHVzZSB0aGUgd2lkZ2V0IGZhY3RvcnkncyBkaXNhYmxlZCBoYW5kbGluZwoJCQl0aGlzLl9zZXR1cERpc2FibGVkKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSk7CgoJCWlmICgga2V5ID09PSAiY29sbGFwc2libGUiICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS10YWJzLWNvbGxhcHNpYmxlIiwgdmFsdWUgKTsKCQkJLy8gU2V0dGluZyBjb2xsYXBzaWJsZTogZmFsc2Ugd2hpbGUgY29sbGFwc2VkOyBvcGVuIGZpcnN0IHBhbmVsCgkJCWlmICggIXZhbHVlICYmIHRoaXMub3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlICkgewoJCQkJdGhpcy5fYWN0aXZhdGUoIDAgKTsKCQkJfQoJCX0KCgkJaWYgKCBrZXkgPT09ICJldmVudCIgKSB7CgkJCXRoaXMuX3NldHVwRXZlbnRzKCB2YWx1ZSApOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJoZWlnaHRTdHlsZSIgKSB7CgkJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHZhbHVlICk7CgkJfQoJfSwKCglfdGFiSWQ6IGZ1bmN0aW9uKCB0YWIgKSB7CgkJcmV0dXJuIHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKSB8fCAidWktdGFicy0iICsgZ2V0TmV4dFRhYklkKCk7Cgl9LAoKCV9zYW5pdGl6ZVNlbGVjdG9yOiBmdW5jdGlvbiggaGFzaCApIHsKCQlyZXR1cm4gaGFzaCA/IGhhc2gucmVwbGFjZSggL1shIiQlJicoKSorLC5cLzo7PD0+P0BcW1xdXF5ge3x9fl0vZywgIlxcJCYiICkgOiAiIjsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWxpcyA9IHRoaXMudGFibGlzdC5jaGlsZHJlbiggIjpoYXMoYVtocmVmXSkiICk7CgoJCS8vIGdldCBkaXNhYmxlZCB0YWJzIGZyb20gY2xhc3MgYXR0cmlidXRlIGZyb20gSFRNTAoJCS8vIHRoaXMgd2lsbCBnZXQgY29udmVydGVkIHRvIGEgYm9vbGVhbiBpZiBuZWVkZWQgaW4gX3JlZnJlc2goKQoJCW9wdGlvbnMuZGlzYWJsZWQgPSAkLm1hcCggbGlzLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSwgZnVuY3Rpb24oIHRhYiApIHsKCQkJcmV0dXJuIGxpcy5pbmRleCggdGFiICk7CgkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgoJCS8vIHdhcyBjb2xsYXBzZWQgb3Igbm8gdGFicwoJCWlmICggb3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlIHx8ICF0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkvLyB3YXMgYWN0aXZlLCBidXQgYWN0aXZlIHRhYiBpcyBnb25lCgkJfSBlbHNlIGlmICggdGhpcy5hY3RpdmUubGVuZ3RoICYmICEkLmNvbnRhaW5zKCB0aGlzLnRhYmxpc3RbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgewoJCQkvLyBhbGwgcmVtYWluaW5nIHRhYnMgYXJlIGRpc2FibGVkCgkJCWlmICggdGhpcy50YWJzLmxlbmd0aCA9PT0gb3B0aW9ucy5kaXNhYmxlZC5sZW5ndGggKSB7CgkJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJCS8vIGFjdGl2YXRlIHByZXZpb3VzIHRhYgoJCQl9IGVsc2UgewoJCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZpbmROZXh0VGFiKCBNYXRoLm1heCggMCwgb3B0aW9ucy5hY3RpdmUgLSAxICksIGZhbHNlICkgKTsKCQkJfQoJCS8vIHdhcyBhY3RpdmUsIGFjdGl2ZSB0YWIgc3RpbGwgZXhpc3RzCgkJfSBlbHNlIHsKCQkJLy8gbWFrZSBzdXJlIGFjdGl2ZSBpbmRleCBpcyBjb3JyZWN0CgkJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLmFjdGl2ZSApOwoJCX0KCgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggdGhpcy5vcHRpb25zLmRpc2FibGVkICk7CgkJdGhpcy5fc2V0dXBFdmVudHMoIHRoaXMub3B0aW9ucy5ldmVudCApOwoJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSApOwoKCQl0aGlzLnRhYnMubm90KCB0aGlzLmFjdGl2ZSApLmF0dHIoewoJCQkiYXJpYS1zZWxlY3RlZCI6ICJmYWxzZSIsCgkJCXRhYkluZGV4OiAtMQoJCX0pOwoJCXRoaXMucGFuZWxzLm5vdCggdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkgKQoJCQkuaGlkZSgpCgkJCS5hdHRyKHsKCQkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwKCQkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCQl9KTsKCgkJLy8gTWFrZSBzdXJlIG9uZSB0YWIgaXMgaW4gdGhlIHRhYiBvcmRlcgoJCWlmICggIXRoaXMuYWN0aXZlLmxlbmd0aCApIHsKCQkJdGhpcy50YWJzLmVxKCAwICkuYXR0ciggInRhYkluZGV4IiwgMCApOwoJCX0gZWxzZSB7CgkJCXRoaXMuYWN0aXZlCgkJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwKCQkJCQl0YWJJbmRleDogMAoJCQkJfSk7CgkJCXRoaXMuX2dldFBhbmVsRm9yVGFiKCB0aGlzLmFjdGl2ZSApCgkJCQkuc2hvdygpCgkJCQkuYXR0cih7CgkJCQkJImFyaWEtZXhwYW5kZWQiOiAidHJ1ZSIsCgkJCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCQkJfSk7CgkJfQoJfSwKCglfcHJvY2Vzc1RhYnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpczsKCgkJdGhpcy50YWJsaXN0ID0gdGhpcy5fZ2V0TGlzdCgpCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtbmF2IHVpLWhlbHBlci1yZXNldCB1aS1oZWxwZXItY2xlYXJmaXggdWktd2lkZ2V0LWhlYWRlciB1aS1jb3JuZXItYWxsIiApCgkJCS5hdHRyKCAicm9sZSIsICJ0YWJsaXN0IiApOwoKCQl0aGlzLnRhYnMgPSB0aGlzLnRhYmxpc3QuZmluZCggIj4gbGk6aGFzKGFbaHJlZl0pIiApCgkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWRlZmF1bHQgdWktY29ybmVyLXRvcCIgKQoJCQkuYXR0cih7CgkJCQlyb2xlOiAidGFiIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9KTsKCgkJdGhpcy5hbmNob3JzID0gdGhpcy50YWJzLm1hcChmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCAiYSIsIHRoaXMgKVsgMCBdOwoJCQl9KQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLWFuY2hvciIgKQoJCQkuYXR0cih7CgkJCQlyb2xlOiAicHJlc2VudGF0aW9uIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9KTsKCgkJdGhpcy5wYW5lbHMgPSAkKCk7CgoJCXRoaXMuYW5jaG9ycy5lYWNoKGZ1bmN0aW9uKCBpLCBhbmNob3IgKSB7CgkJCXZhciBzZWxlY3RvciwgcGFuZWwsIHBhbmVsSWQsCgkJCQlhbmNob3JJZCA9ICQoIGFuY2hvciApLnVuaXF1ZUlkKCkuYXR0ciggImlkIiApLAoJCQkJdGFiID0gJCggYW5jaG9yICkuY2xvc2VzdCggImxpIiApLAoJCQkJb3JpZ2luYWxBcmlhQ29udHJvbHMgPSB0YWIuYXR0ciggImFyaWEtY29udHJvbHMiICk7CgoJCQkvLyBpbmxpbmUgdGFiCgkJCWlmICggaXNMb2NhbCggYW5jaG9yICkgKSB7CgkJCQlzZWxlY3RvciA9IGFuY2hvci5oYXNoOwoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggdGhhdC5fc2FuaXRpemVTZWxlY3Rvciggc2VsZWN0b3IgKSApOwoJCQkvLyByZW1vdGUgdGFiCgkJCX0gZWxzZSB7CgkJCQlwYW5lbElkID0gdGhhdC5fdGFiSWQoIHRhYiApOwoJCQkJc2VsZWN0b3IgPSAiIyIgKyBwYW5lbElkOwoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggc2VsZWN0b3IgKTsKCQkJCWlmICggIXBhbmVsLmxlbmd0aCApIHsKCQkJCQlwYW5lbCA9IHRoYXQuX2NyZWF0ZVBhbmVsKCBwYW5lbElkICk7CgkJCQkJcGFuZWwuaW5zZXJ0QWZ0ZXIoIHRoYXQucGFuZWxzWyBpIC0gMSBdIHx8IHRoYXQudGFibGlzdCApOwoJCQkJfQoJCQkJcGFuZWwuYXR0ciggImFyaWEtbGl2ZSIsICJwb2xpdGUiICk7CgkJCX0KCgkJCWlmICggcGFuZWwubGVuZ3RoKSB7CgkJCQl0aGF0LnBhbmVscyA9IHRoYXQucGFuZWxzLmFkZCggcGFuZWwgKTsKCQkJfQoJCQlpZiAoIG9yaWdpbmFsQXJpYUNvbnRyb2xzICkgewoJCQkJdGFiLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiLCBvcmlnaW5hbEFyaWFDb250cm9scyApOwoJCQl9CgkJCXRhYi5hdHRyKHsKCQkJCSJhcmlhLWNvbnRyb2xzIjogc2VsZWN0b3Iuc3Vic3RyaW5nKCAxICksCgkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogYW5jaG9ySWQKCQkJfSk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWxhYmVsbGVkYnkiLCBhbmNob3JJZCApOwoJCX0pOwoKCQl0aGlzLnBhbmVscwoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLXBhbmVsIHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1ib3R0b20iICkKCQkJLmF0dHIoICJyb2xlIiwgInRhYnBhbmVsIiApOwoJfSwKCgkvLyBhbGxvdyBvdmVycmlkaW5nIGhvdyB0byBmaW5kIHRoZSBsaXN0IGZvciByYXJlIHVzYWdlIHNjZW5hcmlvcyAoIzc3MTUpCglfZ2V0TGlzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudC5maW5kKCAib2wsdWwiICkuZXEoIDAgKTsKCX0sCgoJX2NyZWF0ZVBhbmVsOiBmdW5jdGlvbiggaWQgKSB7CgkJcmV0dXJuICQoICI8ZGl2PiIgKQoJCQkuYXR0ciggImlkIiwgaWQgKQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLXBhbmVsIHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1ib3R0b20iICkKCQkJLmRhdGEoICJ1aS10YWJzLWRlc3Ryb3kiLCB0cnVlICk7Cgl9LAoKCV9zZXR1cERpc2FibGVkOiBmdW5jdGlvbiggZGlzYWJsZWQgKSB7CgkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCWlmICggIWRpc2FibGVkLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIGRpc2FibGVkLmxlbmd0aCA9PT0gdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCgkJLy8gZGlzYWJsZSB0YWJzCgkJZm9yICggdmFyIGkgPSAwLCBsaTsgKCBsaSA9IHRoaXMudGFic1sgaSBdICk7IGkrKyApIHsKCQkJaWYgKCBkaXNhYmxlZCA9PT0gdHJ1ZSB8fCAkLmluQXJyYXkoIGksIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJJCggbGkgKQoJCQkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApCgkJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgInRydWUiICk7CgkJCX0gZWxzZSB7CgkJCQkkKCBsaSApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICk7CgkJCX0KCQl9CgoJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IGRpc2FibGVkOwoJfSwKCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgZXZlbnRzID0ge307CgkJaWYgKCBldmVudCApIHsKCQkJJC5lYWNoKCBldmVudC5zcGxpdCgiICIpLCBmdW5jdGlvbiggaW5kZXgsIGV2ZW50TmFtZSApIHsKCQkJCWV2ZW50c1sgZXZlbnROYW1lIF0gPSAiX2V2ZW50SGFuZGxlciI7CgkJCX0pOwoJCX0KCgkJdGhpcy5fb2ZmKCB0aGlzLmFuY2hvcnMuYWRkKCB0aGlzLnRhYnMgKS5hZGQoIHRoaXMucGFuZWxzICkgKTsKCQkvLyBBbHdheXMgcHJldmVudCB0aGUgZGVmYXVsdCBhY3Rpb24sIGV2ZW4gd2hlbiBkaXNhYmxlZAoJCXRoaXMuX29uKCB0cnVlLCB0aGlzLmFuY2hvcnMsIHsKCQkJY2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9KTsKCQl0aGlzLl9vbiggdGhpcy5hbmNob3JzLCBldmVudHMgKTsKCQl0aGlzLl9vbiggdGhpcy50YWJzLCB7IGtleWRvd246ICJfdGFiS2V5ZG93biIgfSApOwoJCXRoaXMuX29uKCB0aGlzLnBhbmVscywgeyBrZXlkb3duOiAiX3BhbmVsS2V5ZG93biIgfSApOwoKCQl0aGlzLl9mb2N1c2FibGUoIHRoaXMudGFicyApOwoJCXRoaXMuX2hvdmVyYWJsZSggdGhpcy50YWJzICk7Cgl9LAoKCV9zZXR1cEhlaWdodFN0eWxlOiBmdW5jdGlvbiggaGVpZ2h0U3R5bGUgKSB7CgkJdmFyIG1heEhlaWdodCwKCQkJcGFyZW50ID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoKCQlpZiAoIGhlaWdodFN0eWxlID09PSAiZmlsbCIgKSB7CgkJCW1heEhlaWdodCA9IHBhcmVudC5oZWlnaHQoKTsKCQkJbWF4SGVpZ2h0IC09IHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpIC0gdGhpcy5lbGVtZW50LmhlaWdodCgpOwoKCQkJdGhpcy5lbGVtZW50LnNpYmxpbmdzKCAiOnZpc2libGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBlbGVtID0gJCggdGhpcyApLAoJCQkJCXBvc2l0aW9uID0gZWxlbS5jc3MoICJwb3NpdGlvbiIgKTsKCgkJCQlpZiAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCW1heEhlaWdodCAtPSBlbGVtLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0pOwoKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCkubm90KCB0aGlzLnBhbmVscyApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQltYXhIZWlnaHQgLT0gJCggdGhpcyApLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0pOwoKCQkJdGhpcy5wYW5lbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5oZWlnaHQoIE1hdGgubWF4KCAwLCBtYXhIZWlnaHQgLQoJCQkJCSQoIHRoaXMgKS5pbm5lckhlaWdodCgpICsgJCggdGhpcyApLmhlaWdodCgpICkgKTsKCQkJfSkKCQkJLmNzcyggIm92ZXJmbG93IiwgImF1dG8iICk7CgkJfSBlbHNlIGlmICggaGVpZ2h0U3R5bGUgPT09ICJhdXRvIiApIHsKCQkJbWF4SGVpZ2h0ID0gMDsKCQkJdGhpcy5wYW5lbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCA9IE1hdGgubWF4KCBtYXhIZWlnaHQsICQoIHRoaXMgKS5oZWlnaHQoICIiICkuaGVpZ2h0KCkgKTsKCQkJfSkuaGVpZ2h0KCBtYXhIZWlnaHQgKTsKCQl9Cgl9LAoKCV9ldmVudEhhbmRsZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJYWN0aXZlID0gdGhpcy5hY3RpdmUsCgkJCWFuY2hvciA9ICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKSwKCQkJdGFiID0gYW5jaG9yLmNsb3Nlc3QoICJsaSIgKSwKCQkJY2xpY2tlZElzQWN0aXZlID0gdGFiWyAwIF0gPT09IGFjdGl2ZVsgMCBdLAoJCQljb2xsYXBzaW5nID0gY2xpY2tlZElzQWN0aXZlICYmIG9wdGlvbnMuY29sbGFwc2libGUsCgkJCXRvU2hvdyA9IGNvbGxhcHNpbmcgPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCXRvSGlkZSA9ICFhY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIGFjdGl2ZSApLAoJCQlldmVudERhdGEgPSB7CgkJCQlvbGRUYWI6IGFjdGl2ZSwKCQkJCW9sZFBhbmVsOiB0b0hpZGUsCgkJCQluZXdUYWI6IGNvbGxhcHNpbmcgPyAkKCkgOiB0YWIsCgkJCQluZXdQYW5lbDogdG9TaG93CgkJCX07CgoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCWlmICggdGFiLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgfHwKCQkJCS8vIHRhYiBpcyBhbHJlYWR5IGxvYWRpbmcKCQkJCXRhYi5oYXNDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKSB8fAoJCQkJLy8gY2FuJ3Qgc3dpdGNoIGR1cm5pbmcgYW4gYW5pbWF0aW9uCgkJCQl0aGlzLnJ1bm5pbmcgfHwKCQkJCS8vIGNsaWNrIG9uIGFjdGl2ZSBoZWFkZXIsIGJ1dCBub3QgY29sbGFwc2libGUKCQkJCSggY2xpY2tlZElzQWN0aXZlICYmICFvcHRpb25zLmNvbGxhcHNpYmxlICkgfHwKCQkJCS8vIGFsbG93IGNhbmNlbGluZyBhY3RpdmF0aW9uCgkJCQkoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVBY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKSA9PT0gZmFsc2UgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJb3B0aW9ucy5hY3RpdmUgPSBjb2xsYXBzaW5nID8gZmFsc2UgOiB0aGlzLnRhYnMuaW5kZXgoIHRhYiApOwoKCQl0aGlzLmFjdGl2ZSA9IGNsaWNrZWRJc0FjdGl2ZSA/ICQoKSA6IHRhYjsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJaWYgKCAhdG9IaWRlLmxlbmd0aCAmJiAhdG9TaG93Lmxlbmd0aCApIHsKCQkJJC5lcnJvciggImpRdWVyeSBVSSBUYWJzOiBNaXNtYXRjaGluZyBmcmFnbWVudCBpZGVudGlmaWVyLiIgKTsKCQl9CgoJCWlmICggdG9TaG93Lmxlbmd0aCApIHsKCQkJdGhpcy5sb2FkKCB0aGlzLnRhYnMuaW5kZXgoIHRhYiApLCBldmVudCApOwoJCX0KCQl0aGlzLl90b2dnbGUoIGV2ZW50LCBldmVudERhdGEgKTsKCX0sCgoJLy8gaGFuZGxlcyBzaG93L2hpZGUgZm9yIHNlbGVjdGluZyB0YWJzCglfdG9nZ2xlOiBmdW5jdGlvbiggZXZlbnQsIGV2ZW50RGF0YSApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCXRvU2hvdyA9IGV2ZW50RGF0YS5uZXdQYW5lbCwKCQkJdG9IaWRlID0gZXZlbnREYXRhLm9sZFBhbmVsOwoKCQl0aGlzLnJ1bm5pbmcgPSB0cnVlOwoKCQlmdW5jdGlvbiBjb21wbGV0ZSgpIHsKCQkJdGhhdC5ydW5uaW5nID0gZmFsc2U7CgkJCXRoYXQuX3RyaWdnZXIoICJhY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKTsKCQl9CgoJCWZ1bmN0aW9uIHNob3coKSB7CgkJCWV2ZW50RGF0YS5uZXdUYWIuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoKCQkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRoYXQub3B0aW9ucy5zaG93ICkgewoJCQkJdGhhdC5fc2hvdyggdG9TaG93LCB0aGF0Lm9wdGlvbnMuc2hvdywgY29tcGxldGUgKTsKCQkJfSBlbHNlIHsKCQkJCXRvU2hvdy5zaG93KCk7CgkJCQljb21wbGV0ZSgpOwoJCQl9CgkJfQoKCQkvLyBzdGFydCBvdXQgYnkgaGlkaW5nLCB0aGVuIHNob3dpbmcsIHRoZW4gY29tcGxldGluZwoJCWlmICggdG9IaWRlLmxlbmd0aCAmJiB0aGlzLm9wdGlvbnMuaGlkZSApIHsKCQkJdGhpcy5faGlkZSggdG9IaWRlLCB0aGlzLm9wdGlvbnMuaGlkZSwgZnVuY3Rpb24oKSB7CgkJCQlldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCXNob3coKTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5jbG9zZXN0KCAibGkiICkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCXRvSGlkZS5oaWRlKCk7CgkJCXNob3coKTsKCQl9CgoJCXRvSGlkZS5hdHRyKHsKCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIKCQl9KTsKCQlldmVudERhdGEub2xkVGFiLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgImZhbHNlIiApOwoJCS8vIElmIHdlJ3JlIHN3aXRjaGluZyB0YWJzLCByZW1vdmUgdGhlIG9sZCB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIG9wZW5pbmcgZnJvbSBjb2xsYXBzZWQgc3RhdGUsIHJlbW92ZSB0aGUgcHJldmlvdXMgdGFiIGZyb20gdGhlIHRhYiBvcmRlci4KCQkvLyBJZiB3ZSdyZSBjb2xsYXBzaW5nLCB0aGVuIGtlZXAgdGhlIGNvbGxhcHNpbmcgdGFiIGluIHRoZSB0YWIgb3JkZXIuCgkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRvSGlkZS5sZW5ndGggKSB7CgkJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggInRhYkluZGV4IiwgLTEgKTsKCQl9IGVsc2UgaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoIHRoaXMgKS5hdHRyKCAidGFiSW5kZXgiICkgPT09IDA7CgkJCX0pCgkJCS5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0KCgkJdG9TaG93LmF0dHIoewoJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCX0pOwoJCWV2ZW50RGF0YS5uZXdUYWIuYXR0cih7CgkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQl0YWJJbmRleDogMAoJCX0pOwoJfSwKCglfYWN0aXZhdGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgYW5jaG9yLAoJCQlhY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBpbmRleCApOwoKCQkvLyB0cnlpbmcgdG8gYWN0aXZhdGUgdGhlIGFscmVhZHkgYWN0aXZlIHBhbmVsCgkJaWYgKCBhY3RpdmVbIDAgXSA9PT0gdGhpcy5hY3RpdmVbIDAgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gdHJ5aW5nIHRvIGNvbGxhcHNlLCBzaW11bGF0ZSBhIGNsaWNrIG9uIHRoZSBjdXJyZW50IGFjdGl2ZSBoZWFkZXIKCQlpZiAoICFhY3RpdmUubGVuZ3RoICkgewoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZTsKCQl9CgoJCWFuY2hvciA9IGFjdGl2ZS5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApWyAwIF07CgkJdGhpcy5fZXZlbnRIYW5kbGVyKHsKCQkJdGFyZ2V0OiBhbmNob3IsCgkJCWN1cnJlbnRUYXJnZXQ6IGFuY2hvciwKCQkJcHJldmVudERlZmF1bHQ6ICQubm9vcAoJCX0pOwoJfSwKCglfZmluZEFjdGl2ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXJldHVybiBpbmRleCA9PT0gZmFsc2UgPyAkKCkgOiB0aGlzLnRhYnMuZXEoIGluZGV4ICk7Cgl9LAoKCV9nZXRJbmRleDogZnVuY3Rpb24oIGluZGV4ICkgewoJCS8vIG1ldGEtZnVuY3Rpb24gdG8gZ2l2ZSB1c2VycyBvcHRpb24gdG8gcHJvdmlkZSBhIGhyZWYgc3RyaW5nIGluc3RlYWQgb2YgYSBudW1lcmljYWwgaW5kZXguCgkJaWYgKCB0eXBlb2YgaW5kZXggPT09ICJzdHJpbmciICkgewoJCQlpbmRleCA9IHRoaXMuYW5jaG9ycy5pbmRleCggdGhpcy5hbmNob3JzLmZpbHRlciggIltocmVmJD0nIiArIGluZGV4ICsgIiddIiApICk7CgkJfQoKCQlyZXR1cm4gaW5kZXg7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktdGFicyB1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWFsbCB1aS10YWJzLWNvbGxhcHNpYmxlIiApOwoKCQl0aGlzLnRhYmxpc3QKCQkJLnJlbW92ZUNsYXNzKCAidWktdGFicy1uYXYgdWktaGVscGVyLXJlc2V0IHVpLWhlbHBlci1jbGVhcmZpeCB1aS13aWRnZXQtaGVhZGVyIHVpLWNvcm5lci1hbGwiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApOwoKCQl0aGlzLmFuY2hvcnMKCQkJLnJlbW92ZUNsYXNzKCAidWktdGFicy1hbmNob3IiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApCgkJCS5yZW1vdmVBdHRyKCAidGFiSW5kZXgiICkKCQkJLnJlbW92ZVVuaXF1ZUlkKCk7CgoJCXRoaXMudGFicy5hZGQoIHRoaXMucGFuZWxzICkuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAkLmRhdGEoIHRoaXMsICJ1aS10YWJzLWRlc3Ryb3kiICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlKCk7CgkJCX0gZWxzZSB7CgkJCQkkKCB0aGlzICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kZWZhdWx0IHVpLXN0YXRlLWFjdGl2ZSB1aS1zdGF0ZS1kaXNhYmxlZCAiICsKCQkJCQkJInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSB1aS13aWRnZXQtY29udGVudCB1aS10YWJzLWFjdGl2ZSB1aS10YWJzLXBhbmVsIiApCgkJCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1saXZlIiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWJ1c3kiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtc2VsZWN0ZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtbGFiZWxsZWRieSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1oaWRkZW4iICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtZXhwYW5kZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggInJvbGUiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy50YWJzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBsaSA9ICQoIHRoaXMgKSwKCQkJCXByZXYgPSBsaS5kYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQlpZiAoIHByZXYgKSB7CgkJCQlsaQoJCQkJCS5hdHRyKCAiYXJpYS1jb250cm9scyIsIHByZXYgKQoJCQkJCS5yZW1vdmVEYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQl9IGVsc2UgewoJCQkJbGkucmVtb3ZlQXR0ciggImFyaWEtY29udHJvbHMiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5wYW5lbHMuc2hvdygpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSAhPT0gImNvbnRlbnQiICkgewoJCQl0aGlzLnBhbmVscy5jc3MoICJoZWlnaHQiLCAiIiApOwoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gZmFsc2U7CgkJfSBlbHNlIHsKCQkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsKCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWFwKCBkaXNhYmxlZCwgZnVuY3Rpb24oIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCWRpc2FibGVkID0gJC5tYXAoIHRoaXMudGFicywgZnVuY3Rpb24oIGxpLCBudW0gKSB7CgkJCQkJcmV0dXJuIG51bSAhPT0gaW5kZXggPyBudW0gOiBudWxsOwoJCQkJfSk7CgkJCX0KCQl9CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBkaXNhYmxlZCA9IHRoaXMub3B0aW9ucy5kaXNhYmxlZDsKCQlpZiAoIGRpc2FibGVkID09PSB0cnVlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gdHJ1ZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaW5BcnJheSggaW5kZXgsIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggJC5pc0FycmF5KCBkaXNhYmxlZCApICkgewoJCQkJZGlzYWJsZWQgPSAkLm1lcmdlKCBbIGluZGV4IF0sIGRpc2FibGVkICkuc29ydCgpOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSBbIGluZGV4IF07CgkJCX0KCQl9CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJbG9hZDogZnVuY3Rpb24oIGluZGV4LCBldmVudCApIHsKCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCXZhciB0aGF0ID0gdGhpcywKCQkJdGFiID0gdGhpcy50YWJzLmVxKCBpbmRleCApLAoJCQlhbmNob3IgPSB0YWIuZmluZCggIi51aS10YWJzLWFuY2hvciIgKSwKCQkJcGFuZWwgPSB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCXRhYjogdGFiLAoJCQkJcGFuZWw6IHBhbmVsCgkJCX07CgoJCS8vIG5vdCByZW1vdGUKCQlpZiAoIGlzTG9jYWwoIGFuY2hvclsgMCBdICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMueGhyID0gJC5hamF4KCB0aGlzLl9hamF4U2V0dGluZ3MoIGFuY2hvciwgZXZlbnQsIGV2ZW50RGF0YSApICk7CgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJLy8galF1ZXJ5IDwxLjggcmV0dXJucyBmYWxzZSBpZiB0aGUgcmVxdWVzdCBpcyBjYW5jZWxlZCBpbiBiZWZvcmVTZW5kLAoJCS8vIGJ1dCBhcyBvZiAxLjgsICQuYWpheCgpIGFsd2F5cyByZXR1cm5zIGEganFYSFIgb2JqZWN0LgoJCWlmICggdGhpcy54aHIgJiYgdGhpcy54aHIuc3RhdHVzVGV4dCAhPT0gImNhbmNlbGVkIiApIHsKCQkJdGFiLmFkZENsYXNzKCAidWktdGFicy1sb2FkaW5nIiApOwoJCQlwYW5lbC5hdHRyKCAiYXJpYS1idXN5IiwgInRydWUiICk7CgoJCQl0aGlzLnhocgoJCQkJLnN1Y2Nlc3MoZnVuY3Rpb24oIHJlc3BvbnNlICkgewoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQlwYW5lbC5odG1sKCByZXNwb25zZSApOwoJCQkJCQl0aGF0Ll90cmlnZ2VyKCAibG9hZCIsIGV2ZW50LCBldmVudERhdGEgKTsKCQkJCQl9LCAxICk7CgkJCQl9KQoJCQkJLmNvbXBsZXRlKGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgewoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIHN0YXR1cyA9PT0gImFib3J0IiApIHsKCQkJCQkJCXRoYXQucGFuZWxzLnN0b3AoIGZhbHNlLCB0cnVlICk7CgkJCQkJCX0KCgkJCQkJCXRhYi5yZW1vdmVDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKTsKCQkJCQkJcGFuZWwucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKTsKCgkJCQkJCWlmICgganFYSFIgPT09IHRoYXQueGhyICkgewoJCQkJCQkJZGVsZXRlIHRoYXQueGhyOwoJCQkJCQl9CgkJCQkJfSwgMSApOwoJCQkJfSk7CgkJfQoJfSwKCglfYWpheFNldHRpbmdzOiBmdW5jdGlvbiggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpczsKCQlyZXR1cm4gewoJCQl1cmw6IGFuY2hvci5hdHRyKCAiaHJlZiIgKSwKCQkJYmVmb3JlU2VuZDogZnVuY3Rpb24oIGpxWEhSLCBzZXR0aW5ncyApIHsKCQkJCXJldHVybiB0aGF0Ll90cmlnZ2VyKCAiYmVmb3JlTG9hZCIsIGV2ZW50LAoJCQkJCSQuZXh0ZW5kKCB7IGpxWEhSIDoganFYSFIsIGFqYXhTZXR0aW5nczogc2V0dGluZ3MgfSwgZXZlbnREYXRhICkgKTsKCQkJfQoJCX07Cgl9LAoKCV9nZXRQYW5lbEZvclRhYjogZnVuY3Rpb24oIHRhYiApIHsKCQl2YXIgaWQgPSAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMuX3Nhbml0aXplU2VsZWN0b3IoICIjIiArIGlkICkgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoKCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IHRydWU7CgoJLy8gVGhpcyBmaXggYWRkcmVzc2VzIGFuIGlPUyBidWcsIHNvIHJldHVybiBlYXJseSBpZiB0aGUgVUEgY2xhaW1zIGl0J3Mgc29tZXRoaW5nIGVsc2UuCgl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCXpvb20sCgkJZXZ0LCB4LCB5LCB6LCBhaWc7CglpZiAoICEoIC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiAvT1MgWzEtNV1fWzAtOV9dKiBsaWtlIE1hYyBPUyBYL2kudGVzdCggdWEgKSAmJiB1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSApICkgewoJCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IGZhbHNlOwoJCXJldHVybjsKCX0KCgl6b29tID0gJC5tb2JpbGUuem9vbTsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkICkgewoJCQkkLm1vYmlsZS53aW5kb3cKCQkJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJCQkuYmluZCggImRldmljZW1vdGlvbi5pb3NvcmllbnRhdGlvbmZpeCIsIGNoZWNrVGlsdCApOwoJCX0KCX0pOwoKfSggalF1ZXJ5LCB0aGlzICkpOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCSR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3c7CgoJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJZnVuY3Rpb24gaGlkZVJlbmRlcmluZ0NsYXNzKCkgewoJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCX0KCgkvLyB0cmlnZ2VyIG1vYmlsZWluaXQgZXZlbnQgLSB1c2VmdWwgaG9vayBmb3IgY29uZmlndXJpbmcgJC5tb2JpbGUgc2V0dGluZ3MgYmVmb3JlIHRoZXkncmUgdXNlZAoJJCggd2luZG93LmRvY3VtZW50ICkudHJpZ2dlciggIm1vYmlsZWluaXQiICk7CgoJLy8gc3VwcG9ydCBjb25kaXRpb25zCgkvLyBpZiBkZXZpY2Ugc3VwcG9ydCBjb25kaXRpb24ocykgYXJlbid0IG1ldCwgbGVhdmUgdGhpbmdzIGFzIHRoZXkgYXJlIC0+IGEgYmFzaWMsIHVzYWJsZSBleHBlcmllbmNlLAoJLy8gb3RoZXJ3aXNlLCBwcm9jZWVkIHdpdGggdGhlIGVuaGFuY2VtZW50cwoJaWYgKCAhJC5tb2JpbGUuZ3JhZGVBKCkgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMKCS8vIG9yIGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKEJCNSwgT3BlcmEgTWluaSkKCWlmICggJC5tb2JpbGUuYWpheEJsYWNrbGlzdCApIHsKCQkkLm1vYmlsZS5hamF4RW5hYmxlZCA9IGZhbHNlOwoJfQoKCS8vIEFkZCBtb2JpbGUsIGluaXRpYWwgbG9hZCAicmVuZGVyaW5nIiBjbGFzc2VzIHRvIGRvY0VsCgkkaHRtbC5hZGRDbGFzcyggInVpLW1vYmlsZSB1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoKCS8vIFRoaXMgaXMgYSBmYWxsYmFjay4gSWYgYW55dGhpbmcgZ29lcyB3cm9uZyAoSlMgZXJyb3JzLCBldGMpLCBvciBldmVudHMgZG9uJ3QgZmlyZSwKCS8vIHRoaXMgZW5zdXJlcyB0aGUgcmVuZGVyaW5nIGNsYXNzIGlzIHJlbW92ZWQgYWZ0ZXIgNSBzZWNvbmRzLCBzbyBjb250ZW50IGlzIHZpc2libGUgYW5kIGFjY2Vzc2libGUKCXNldFRpbWVvdXQoIGhpZGVSZW5kZXJpbmdDbGFzcywgNTAwMCApOwoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCQkJJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICksCgkJCQloYXNoID0gcGF0aC5zdHJpcEhhc2goIHBhdGguc3RyaXBRdWVyeVBhcmFtcyhwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoKSApLAoJCQkJdGhlTG9jYXRpb24gPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKSwKCQkJCWhhc2hQYWdlID0gaGFzaCA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBoYXNoICkgOiB1bmRlZmluZWQ7CgoJCQkvLyBpZiBubyBwYWdlcyBhcmUgZm91bmQsIGNyZWF0ZSBvbmUgd2l0aCBib2R5J3MgaW5uZXIgaHRtbAoJCQlpZiAoICEkcGFnZXMubGVuZ3RoICkgewoJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJfQoKCQkJLy8gYWRkIGRpYWxvZ3MsIHNldCBkYXRhLXVybCBhdHRycwoJCQkkcGFnZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCQkvLyB1bmxlc3MgdGhlIGRhdGEgdXJsIGlzIGFscmVhZHkgc2V0IHNldCBpdCB0byB0aGUgcGF0aG5hbWUKCQkJCWlmICggISR0aGlzWyAwIF0uZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiApICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwKCQkJCQkJdGhlTG9jYXRpb24ucGF0aG5hbWUgKyB0aGVMb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICQubW9iaWxlLmZpcnN0UGFnZQoJCQkJLnBhcmVudCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICkKCQkJCS5wYWdlY29udGFpbmVyKCk7CgoJCQkvLyBpbml0aWFsaXplIG5hdmlnYXRpb24gZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQgYW5kIHRoZSBwYWdlIGNvbnRhaW5lcgoJCQkvLyBoYXMgYmVlbiBjcmVhdGVkIGJ1dCBiZWZvcmUgdGhlIHJlc3Qgb2YgdGhlIGxpYnJhcnkgaXMgYWxlcnRlZCB0byB0aGF0IGZhY3QKCQkJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5sb2FkaW5nKCAic2hvdyIgKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCwgdGhlcmUncyBubyBoYXNoIGRlZXBsaW5rLAoJCQkvLyB0aGUgaGFzaCBpcyBub3QgdmFsaWQgKGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgIyBvciBkb2VzIG5vdCBzdGFydCB3aXRoICMpCgkJCS8vIG9yIHRoZXJlIGlzIG5vIHBhZ2Ugd2l0aCB0aGF0IGhhc2gsIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCS8vIFJlbWVtYmVyLCBob3dldmVyLCB0aGF0IHRoZSBoYXNoIGNhbiBhbHNvIGJlIGEgcGF0aCEKCQkJaWYgKCAhICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJKCAkKCBoYXNoUGFnZSApLmlzKCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApIHx8CgkJCQkJJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSB8fAoJCQkJCWhhc2ggPT09ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSApICkgewoKCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgaW5pdGlhbCBwb3BzdGF0ZSBzdGF0ZSBpZiBpdCBleGlzdHMKCQkJCS8vIHNvIHRoYXQgbmF2aWdhdGlvbiBiYWNrIHRvIHRoZSBpbml0aWFsIHBhZ2Ugd29ya3MgcHJvcGVybHkKCQkJCWlmICggJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvci5zcXVhc2goIHBhdGgucGFyc2VMb2NhdGlvbigpLmhyZWYgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIHsKCQkJCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJCQkJcmV2ZXJzZTogdHJ1ZSwKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZQoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkvLyB0cmlnZ2VyIGhhc2hjaGFuZ2Ugb3IgbmF2aWdhdGUgdG8gc3F1YXNoIGFuZCByZWNvcmQgdGhlIGNvcnJlY3QKCQkJCS8vIGhpc3RvcnkgZW50cnkgZm9yIGFuIGluaXRpYWwgaGFzaCBwYXRoCgkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQkJJHdpbmRvdy50cmlnZ2VyKCAiaGFzaGNoYW5nZSIsIFt0cnVlXSApOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBUT0RPIGZpZ3VyZSBvdXQgaG93IHRvIHNpbXBsaWZ5IHRoaXMgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5pdGlhbCBoaXN0b3J5IGVudHJ5CgkJCQkJLy8gYXQgdGhlIGJvdHRvbSBqcy9uYXZpZ2F0ZS9uYXZpZ2F0ZS5qcwoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnkuc3RhY2sgPSBbXTsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZSggJC5tb2JpbGUucGF0aC5pc1BhdGgoIGxvY2F0aW9uLmhhc2ggKSA/IGxvY2F0aW9uLmhhc2ggOiBsb2NhdGlvbi5ocmVmICk7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKCgkkKGZ1bmN0aW9uKCkgewoJCS8vUnVuIGlubGluZVNWRyBzdXBwb3J0IHRlc3QKCQkkLnN1cHBvcnQuaW5saW5lU1ZHKCk7CgoJCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJCS8vIHRoZW4gY2hlY2sgd2hhdCB0aGUgc2Nyb2xsIHRvcCBpcy4gQW5kcm9pZCB3aWxsIHJlcG9ydCAwLi4uIG90aGVycyAxCgkJLy8gbm90ZSB0aGF0IHRoaXMgaW5pdGlhbCBzY3JvbGwgd29uJ3QgaGlkZSB0aGUgYWRkcmVzcyBiYXIuIEl0J3MganVzdCBmb3IgdGhlIGNoZWNrLgoKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkIGlmIGhpZGVVcmxCYXIgaXMgdHJ1ZSB0aGlzIGlzIHRvIHRyeSBhbmQgZG8gaXQgYXMgc29vbiBhcyBwb3NzaWJsZQoJCWlmICggJC5tb2JpbGUuaGlkZVVybEJhciApIHsKCQkJd2luZG93LnNjcm9sbFRvKCAwLCAxICk7CgkJfQoKCQkvLyBpZiBkZWZhdWx0SG9tZVNjcm9sbCBoYXNuJ3QgYmVlbiBzZXQgeWV0LCBzZWUgaWYgc2Nyb2xsVG9wIGlzIDEKCQkvLyBpdCBzaG91bGQgYmUgMSBpbiBtb3N0IGJyb3dzZXJzLCBidXQgYW5kcm9pZCB0cmVhdHMgMSBhcyAwIChmb3IgaGlkaW5nIGFkZHIgYmFyKQoJCS8vIHNvIGlmIGl0J3MgMSwgdXNlIDAgZnJvbSBub3cgb24KCQkkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA9ICggISQuc3VwcG9ydC5zY3JvbGxUb3AgfHwgJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpID09PSAxICkgPyAwIDogMTsKCgkJLy9kb20tcmVhZHkgaW5pdHMKCQlpZiAoICQubW9iaWxlLmF1dG9Jbml0aWFsaXplUGFnZSApIHsKCQkJJC5tb2JpbGUuaW5pdGlhbGl6ZVBhZ2UoKTsKCQl9CgoJCS8vIHdpbmRvdyBsb2FkIGV2ZW50CgkJLy8gaGlkZSBpT1MgYnJvd3NlciBjaHJvbWUgb24gbG9hZCBpZiBoaWRlVXJsQmFyIGlzIHRydWUgdGhpcyBpcyBhcyBmYWxsIGJhY2sgaW5jYXNlIHdlIHdlcmUgdG9vIGVhcmx5IGJlZm9yZQoJCWlmICggJC5tb2JpbGUuaGlkZVVybEJhciApIHsKCQkJJHdpbmRvdy5sb2FkKCAkLm1vYmlsZS5zaWxlbnRTY3JvbGwgKTsKCQl9CgoJCWlmICggISQuc3VwcG9ydC5jc3NQb2ludGVyRXZlbnRzICkgewoJCQkvLyBJRSBhbmQgT3BlcmEgZG9uJ3Qgc3VwcG9ydCBDU1MgcG9pbnRlci1ldmVudHM6IG5vbmUgdGhhdCB3ZSB1c2UgdG8gZGlzYWJsZSBsaW5rLWJhc2VkIGJ1dHRvbnMKCQkJLy8gYnkgYWRkaW5nIHRoZSAndWktZGlzYWJsZWQnIGNsYXNzIHRvIHRoZW0uIFVzaW5nIGEgSmF2YVNjcmlwdCB3b3JrYXJvdW5kIGZvciB0aG9zZSBicm93c2VyLgoJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NTgKCgkJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgdWktZGlzYWJsZWQgYWZ0ZXIgMS40LjAgcmVsZWFzZQoJCQkvLyBvbmx5IHVpLXN0YXRlLWRpc2FibGVkIHNob3VsZCBiZSBwcmVzZW50IHRoZXJlYWZ0ZXIKCQkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktc3RhdGUtZGlzYWJsZWQsLnVpLWRpc2FibGVkIiwgInZjbGljayIsCgkJCQlmdW5jdGlvbiggZSApIHsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCX0KCQkJKTsKCQl9Cgl9KTsKfSggalF1ZXJ5LCB0aGlzICkpOwoKCn0pKTsK",
                "body": "LyohCiogalF1ZXJ5IE1vYmlsZSAxLjUuMC1wcmUKKiBHaXQgSEVBRCBoYXNoOiAzOWNiMjBmZTI2OTY5OTQxMzI5MzQ3ZTJmNDFhMjIyZjk0YzYzMTM4IDw+IERhdGU6IFRodSBTZXAgNCAyMDE0IDAxOjQxOjM2IFVUQwoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMCwgMjAxNCBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXJjb250cmlidXRvcnMKKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCgoKKGZ1bmN0aW9uICggcm9vdCwgZG9jLCBmYWN0b3J5ICkgewoJaWYgKCB0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgKSB7CgkJLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgoJCWRlZmluZSggWyAianF1ZXJ5IiBdLCBmdW5jdGlvbiAoICQgKSB7CgkJCWZhY3RvcnkoICQsIHJvb3QsIGRvYyApOwoJCQlyZXR1cm4gJC5tb2JpbGU7CgkJfSk7Cgl9IGVsc2UgewoJCS8vIEJyb3dzZXIgZ2xvYmFscwoJCWZhY3RvcnkoIHJvb3QualF1ZXJ5LCByb290LCBkb2MgKTsKCX0KfSggdGhpcywgZG9jdW1lbnQsIGZ1bmN0aW9uICggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7CihmdW5jdGlvbiggJCApIHsKCSQubW9iaWxlID0ge307Cn0oIGpRdWVyeSApKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJLy8gVmVyc2lvbiBvZiB0aGUgalF1ZXJ5IE1vYmlsZSBGcmFtZXdvcmsKCQl2ZXJzaW9uOiAiMS41LjAtcHJlIiwKCgkJLy8gRGVwcmVjYXRlZCBhbmQgbm8gbG9uZ2VyIHVzZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCWhpZGVVcmxCYXI6IHRydWUsCgoJCS8vIEtlZXBuYXRpdmUgU2VsZWN0b3IKCQlrZWVwTmF0aXZlOiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJmb2N1cyIgZm9ybSBlbGVtZW50IHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlmb2N1c0NsYXNzOiAidWktZm9jdXMiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogImZhZGUiLAoKCQkvLyBTZXQgbWF4aW11bSB3aW5kb3cgd2lkdGggZm9yIHRyYW5zaXRpb25zIHRvIGFwcGx5IC0gJ2ZhbHNlJyBmb3Igbm8gbGltaXQKCQltYXhUcmFuc2l0aW9uV2lkdGg6IGZhbHNlLAoKCQkvLyBNaW5pbXVtIHNjcm9sbCBkaXN0YW5jZSB0aGF0IHdpbGwgYmUgcmVtZW1iZXJlZCB3aGVuIHJldHVybmluZyB0byBhIHBhZ2UKCQkvLyBEZXByZWNhdGVkIHJlbW92ZSBpbiAxLjUKCQltaW5TY3JvbGxCYWNrOiAwLAoKCQkvLyBTZXQgZGVmYXVsdCBkaWFsb2cgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjogInBvcCIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vIEZvciBlcnJvciBtZXNzYWdlcywgd2hpY2ggdGhlbWUgZG9lcyB0aGUgYm94IHVzZT8KCQlwYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lOiAiYSIsCgoJCS8vIHJlcGxhY2UgY2FsbHMgdG8gd2luZG93Lmhpc3RvcnkuYmFjayB3aXRoIHBob25lZ2FwcyBuYXZpZ2F0aW9uIGhlbHBlcgoJCS8vIHdoZXJlIGl0IGlzIHByb3ZpZGVkIG9uIHRoZSB3aW5kb3cgb2JqZWN0CgkJcGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZDogZmFsc2UsCgoJCS8vYXV0b21hdGljYWxseSBpbml0aWFsaXplIHRoZSBET00gd2hlbiBpdCdzIHJlYWR5CgkJYXV0b0luaXRpYWxpemVQYWdlOiB0cnVlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQkvLyBhbGxvd3MgdXNlcnMgdG8gb3B0IGluIHRvIGlnbm9yaW5nIGNvbnRlbnQgYnkgbWFya2luZyBhIHBhcmVudCBlbGVtZW50IGFzCgkJLy8gZGF0YS1pZ25vcmVkCgkJaWdub3JlQ29udGVudEVuYWJsZWQ6IGZhbHNlLAoKCQlidXR0b25NYXJrdXA6IHsKCQkJaG92ZXJEZWxheTogMjAwCgkJfSwKCgkJLy8gZGlzYWJsZSB0aGUgYWx0ZXJhdGlvbiBvZiB0aGUgZHluYW1pYyBiYXNlIHRhZyBvciBsaW5rcyBpbiB0aGUgY2FzZQoJCS8vIHRoYXQgYSBkeW5hbWljIGJhc2UgdGFnIGlzbid0IHN1cHBvcnRlZAoJCWR5bmFtaWNCYXNlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gZGVmYXVsdCB0aGUgcHJvcGVydHkgdG8gcmVtb3ZlIGRlcGVuZGVuY3kgb24gYXNzaWdubWVudCBpbiBpbml0IG1vZHVsZQoJCXBhZ2VDb250YWluZXI6ICQoKSwKCgkJLy9lbmFibGUgY3Jvc3MtZG9tYWluIHBhZ2Ugc3VwcG9ydAoJCWFsbG93Q3Jvc3NEb21haW5QYWdlczogZmFsc2UsCgoJCWRpYWxvZ0hhc2hLZXk6ICImdWktc3RhdGU9ZGlhbG9nIgoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgl2YXIgbnNOb3JtYWxpemVEaWN0ID0ge30sCgkJb2xkRmluZCA9ICQuZmluZCwKCQlyYnJhY2UgPSAvKD86XHtbXHNcU10qXH18XFtbXHNcU10qXF0pJC8sCgkJanFtRGF0YVJFID0gLzpqcW1EYXRhXCgoW14pXSopXCkvZzsKCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJLy8gTmFtZXNwYWNlIHVzZWQgZnJhbWV3b3JrLXdpZGUgZm9yIGRhdGEtYXR0cnMuIERlZmF1bHQgaXMgbm8gbmFtZXNwYWNlCgoJCW5zOiAiIiwKCgkJLy8gUmV0cmlldmUgYW4gYXR0cmlidXRlIGZyb20gYW4gZWxlbWVudCBhbmQgcGVyZm9ybSBzb21lIG1hc3NhZ2luZyBvZiB0aGUgdmFsdWUKCgkJZ2V0QXR0cmlidXRlOiBmdW5jdGlvbiggZWxlbWVudCwga2V5ICkgewoJCQl2YXIgZGF0YTsKCgkJCWVsZW1lbnQgPSBlbGVtZW50LmpxdWVyeSA/IGVsZW1lbnRbMF0gOiBlbGVtZW50OwoKCQkJaWYgKCBlbGVtZW50ICYmIGVsZW1lbnQuZ2V0QXR0cmlidXRlICkgewoJCQkJZGF0YSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBrZXkgKTsKCQkJfQoKCQkJLy8gQ29waWVkIGZyb20gY29yZSdzIHNyYy9kYXRhLmpzOmRhdGFBdHRyKCkKCQkJLy8gQ29udmVydCBmcm9tIGEgc3RyaW5nIHRvIGEgcHJvcGVyIGRhdGEgdHlwZQoJCQl0cnkgewoJCQkJZGF0YSA9IGRhdGEgPT09ICJ0cnVlIiA/IHRydWUgOgoJCQkJCWRhdGEgPT09ICJmYWxzZSIgPyBmYWxzZSA6CgkJCQkJZGF0YSA9PT0gIm51bGwiID8gbnVsbCA6CgkJCQkJLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcKCQkJCQkrZGF0YSArICIiID09PSBkYXRhID8gK2RhdGEgOgoJCQkJCXJicmFjZS50ZXN0KCBkYXRhICkgPyBKU09OLnBhcnNlKCBkYXRhICkgOgoJCQkJCWRhdGE7CgkJCX0gY2F0Y2goIGVyciApIHt9CgoJCQlyZXR1cm4gZGF0YTsKCQl9LAoKCQkvLyBFeHBvc2Ugb3VyIGNhY2hlIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgoJCW5zTm9ybWFsaXplRGljdDogbnNOb3JtYWxpemVEaWN0LAoKCQkvLyBUYWtlIGEgZGF0YSBhdHRyaWJ1dGUgcHJvcGVydHksIHByZXBlbmQgdGhlIG5hbWVzcGFjZQoJCS8vIGFuZCB0aGVuIGNhbWVsIGNhc2UgdGhlIGF0dHJpYnV0ZSBzdHJpbmcuIEFkZCB0aGUgcmVzdWx0CgkJLy8gdG8gb3VyIG5zTm9ybWFsaXplRGljdCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIHRoaXMgYWdhaW4uCgkJbnNOb3JtYWxpemU6IGZ1bmN0aW9uKCBwcm9wICkgewoJCQlyZXR1cm4gbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gfHwKCQkJCSggbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gPSAkLmNhbWVsQ2FzZSggJC5tb2JpbGUubnMgKyBwcm9wICkgKTsKCQl9LAoKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IGphdmFzY3JpcHQgcGFnZSBlbGVtZW50IHRvIGdhdGhlciBzZXR0aW5ncyBkYXRhIGpzcGVyZiB0ZXN0CgkJLy8gaHR0cDovL2pzcGVyZi5jb20vc2luZ2xlLWNvbXBsZXgtc2VsZWN0b3ItdnMtbWFueS1jb21wbGV4LXNlbGVjdG9ycy9lZGl0CgkJLy8gcG9zc2libHkgbmFpdmUsIGJ1dCBpdCBzaG93cyB0aGF0IHRoZSBwYXJzaW5nIG92ZXJoZWFkIGZvciAqanVzdCogdGhlIHBhZ2Ugc2VsZWN0b3IgdnMKCQkvLyB0aGUgcGFnZSBhbmQgZGlhbG9nIHNlbGVjdG9yIGlzIG5lZ2xpZ2FibGUuIFRoaXMgY291bGQgcHJvYmFibHkgYmUgc3BlZWQgdXAgYnkKCQkvLyBkb2luZyBhIHNpbWlsYXIgcGFyZW50IG5vZGUgdHJhdmVyc2FsIHRvIHRoZSBvbmUgZm91bmQgaW4gdGhlIGluaGVyaXRlZCB0aGVtZSBjb2RlIGFib3ZlCgkJY2xvc2VzdFBhZ2VEYXRhOiBmdW5jdGlvbiggJHRhcmdldCApIHsKCQkJcmV0dXJuICR0YXJnZXQKCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkJLmRhdGEoICJtb2JpbGUtcGFnZSIgKTsKCQl9CgoJfSk7CgoJLy8gTW9iaWxlIHZlcnNpb24gb2YgZGF0YSBhbmQgcmVtb3ZlRGF0YSBhbmQgaGFzRGF0YSBtZXRob2RzCgkvLyBlbnN1cmVzIGFsbCBkYXRhIGlzIHNldCBhbmQgcmV0cmlldmVkIHVzaW5nIGpRdWVyeSBNb2JpbGUncyBkYXRhIG5hbWVzcGFjZQoJJC5mbi5qcW1EYXRhID0gZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCWlmICggcHJvcCApIHsKCQkJCXByb3AgPSAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApOwoJCQl9CgoJCQkvLyB1bmRlZmluZWQgaXMgcGVybWl0dGVkIGFzIGFuIGV4cGxpY2l0IGlucHV0IGZvciB0aGUgc2Vjb25kIHBhcmFtCgkJCS8vIGluIHRoaXMgY2FzZSBpdCByZXR1cm5zIHRoZSB2YWx1ZSBhbmQgZG9lcyBub3Qgc2V0IGl0IHRvIHVuZGVmaW5lZAoJCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPCAyIHx8IHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AgKTsKCQkJfSBlbHNlIHsKCQkJCXJlc3VsdCA9IHRoaXMuZGF0YSggcHJvcCwgdmFsdWUgKTsKCQkJfQoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmpxbURhdGEgPSBmdW5jdGlvbiggZWxlbSwgcHJvcCwgdmFsdWUgKSB7CgkJdmFyIHJlc3VsdDsKCQlpZiAoIHR5cGVvZiBwcm9wICE9PSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gJC5kYXRhKCBlbGVtLCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuZm4uanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBwcm9wICkgewoJCXJldHVybiB0aGlzLnJlbW92ZURhdGEoICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AgKSB7CgkJcmV0dXJuICQucmVtb3ZlRGF0YSggZWxlbSwgJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmZpbmQgPSBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJldCwgZXh0cmEgKSB7CgkJaWYgKCBzZWxlY3Rvci5pbmRleE9mKCAiOmpxbURhdGEiICkgPiAtMSApIHsKCQkJc2VsZWN0b3IgPSBzZWxlY3Rvci5yZXBsYWNlKCBqcW1EYXRhUkUsICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgIiQxXSIgKTsKCQl9CgoJCXJldHVybiBvbGRGaW5kLmNhbGwoIHRoaXMsIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICk7Cgl9OwoKCSQuZXh0ZW5kKCAkLmZpbmQsIG9sZEZpbmQgKTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qIQogKiBqUXVlcnkgVUkgQ29yZSBjMGFiNzEwNTZiOTM2NjI3ZThhNzgyMWYwM2MwNDRhZWM2MjgwYTQwCiAqIGh0dHA6Ly9qcXVlcnl1aS5jb20KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogaHR0cDovL2FwaS5qcXVlcnl1aS5jb20vY2F0ZWdvcnkvdWktY29yZS8KICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHV1aWQgPSAwLAoJcnVuaXF1ZUlkID0gL151aS1pZC1cZCskLzsKCi8vICQudWkgbWlnaHQgZXhpc3QgZnJvbSBjb21wb25lbnRzIHdpdGggbm8gZGVwZW5kZW5jaWVzLCBlLmcuLCAkLnVpLnBvc2l0aW9uCiQudWkgPSAkLnVpIHx8IHt9OwoKJC5leHRlbmQoICQudWksIHsKCXZlcnNpb246ICJjMGFiNzEwNTZiOTM2NjI3ZThhNzgyMWYwM2MwNDRhZWM2MjgwYTQwIiwKCglrZXlDb2RlOiB7CgkJQkFDS1NQQUNFOiA4LAoJCUNPTU1BOiAxODgsCgkJREVMRVRFOiA0NiwKCQlET1dOOiA0MCwKCQlFTkQ6IDM1LAoJCUVOVEVSOiAxMywKCQlFU0NBUEU6IDI3LAoJCUhPTUU6IDM2LAoJCUxFRlQ6IDM3LAoJCVBBR0VfRE9XTjogMzQsCgkJUEFHRV9VUDogMzMsCgkJUEVSSU9EOiAxOTAsCgkJUklHSFQ6IDM5LAoJCVNQQUNFOiAzMiwKCQlUQUI6IDksCgkJVVA6IDM4Cgl9Cn0pOwoKLy8gcGx1Z2lucwokLmZuLmV4dGVuZCh7Cglmb2N1czogKGZ1bmN0aW9uKCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggZGVsYXksIGZuICkgewoJCQlyZXR1cm4gdHlwZW9mIGRlbGF5ID09PSAibnVtYmVyIiA/CgkJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJdmFyIGVsZW0gPSB0aGlzOwoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCSQoIGVsZW0gKS5mb2N1cygpOwoJCQkJCQlpZiAoIGZuICkgewoJCQkJCQkJZm4uY2FsbCggZWxlbSApOwoJCQkJCQl9CgkJCQkJfSwgZGVsYXkgKTsKCQkJCX0pIDoKCQkJCW9yaWcuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCX07Cgl9KSggJC5mbi5mb2N1cyApLAoKCXNjcm9sbFBhcmVudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNjcm9sbFBhcmVudDsKCQlpZiAoKCQudWkuaWUgJiYgKC8oc3RhdGljfHJlbGF0aXZlKS8pLnRlc3QodGhpcy5jc3MoInBvc2l0aW9uIikpKSB8fCAoL2Fic29sdXRlLykudGVzdCh0aGlzLmNzcygicG9zaXRpb24iKSkpIHsKCQkJc2Nyb2xsUGFyZW50ID0gdGhpcy5wYXJlbnRzKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICgvKHJlbGF0aXZlfGFic29sdXRlfGZpeGVkKS8pLnRlc3QoJC5jc3ModGhpcywicG9zaXRpb24iKSkgJiYgKC8oYXV0b3xzY3JvbGwpLykudGVzdCgkLmNzcyh0aGlzLCJvdmVyZmxvdyIpKyQuY3NzKHRoaXMsIm92ZXJmbG93LXkiKSskLmNzcyh0aGlzLCJvdmVyZmxvdy14IikpOwoJCQl9KS5lcSgwKTsKCQl9IGVsc2UgewoJCQlzY3JvbGxQYXJlbnQgPSB0aGlzLnBhcmVudHMoKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gKC8oYXV0b3xzY3JvbGwpLykudGVzdCgkLmNzcyh0aGlzLCJvdmVyZmxvdyIpKyQuY3NzKHRoaXMsIm92ZXJmbG93LXkiKSskLmNzcyh0aGlzLCJvdmVyZmxvdy14IikpOwoJCQl9KS5lcSgwKTsKCQl9CgoJCXJldHVybiAoIC9maXhlZC8gKS50ZXN0KCB0aGlzLmNzcyggInBvc2l0aW9uIikgKSB8fCAhc2Nyb2xsUGFyZW50Lmxlbmd0aCA/ICQoIHRoaXNbIDAgXS5vd25lckRvY3VtZW50IHx8IGRvY3VtZW50ICkgOiBzY3JvbGxQYXJlbnQ7Cgl9LAoKCXVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoICF0aGlzLmlkICkgewoJCQkJdGhpcy5pZCA9ICJ1aS1pZC0iICsgKCsrdXVpZCk7CgkJCX0KCQl9KTsKCX0sCgoJcmVtb3ZlVW5pcXVlSWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggcnVuaXF1ZUlkLnRlc3QoIHRoaXMuaWQgKSApIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmVBdHRyKCAiaWQiICk7CgkJCX0KCQl9KTsKCX0KfSk7CgovLyBzZWxlY3RvcnMKZnVuY3Rpb24gZm9jdXNhYmxlKCBlbGVtZW50LCBpc1RhYkluZGV4Tm90TmFOICkgewoJdmFyIG1hcCwgbWFwTmFtZSwgaW1nLAoJCW5vZGVOYW1lID0gZWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJaWYgKCAiYXJlYSIgPT09IG5vZGVOYW1lICkgewoJCW1hcCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQltYXBOYW1lID0gbWFwLm5hbWU7CgkJaWYgKCAhZWxlbWVudC5ocmVmIHx8ICFtYXBOYW1lIHx8IG1hcC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAibWFwIiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpbWcgPSAkKCAiaW1nW3VzZW1hcD0jIiArIG1hcE5hbWUgKyAiXSIgKVswXTsKCQlyZXR1cm4gISFpbWcgJiYgdmlzaWJsZSggaW1nICk7Cgl9CglyZXR1cm4gKCAvaW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbnxvYmplY3QvLnRlc3QoIG5vZGVOYW1lICkgPwoJCSFlbGVtZW50LmRpc2FibGVkIDoKCQkiYSIgPT09IG5vZGVOYW1lID8KCQkJZWxlbWVudC5ocmVmIHx8IGlzVGFiSW5kZXhOb3ROYU4gOgoJCQlpc1RhYkluZGV4Tm90TmFOKSAmJgoJCS8vIHRoZSBlbGVtZW50IGFuZCBhbGwgb2YgaXRzIGFuY2VzdG9ycyBtdXN0IGJlIHZpc2libGUKCQl2aXNpYmxlKCBlbGVtZW50ICk7Cn0KCmZ1bmN0aW9uIHZpc2libGUoIGVsZW1lbnQgKSB7CglyZXR1cm4gJC5leHByLmZpbHRlcnMudmlzaWJsZSggZWxlbWVudCApICYmCgkJISQoIGVsZW1lbnQgKS5wYXJlbnRzKCkuYWRkQmFjaygpLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQuY3NzKCB0aGlzLCAidmlzaWJpbGl0eSIgKSA9PT0gImhpZGRlbiI7CgkJfSkubGVuZ3RoOwp9CgokLmV4dGVuZCggJC5leHByWyAiOiIgXSwgewoJZGF0YTogJC5leHByLmNyZWF0ZVBzZXVkbyA/CgkJJC5leHByLmNyZWF0ZVBzZXVkbyhmdW5jdGlvbiggZGF0YU5hbWUgKSB7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiAhISQuZGF0YSggZWxlbSwgZGF0YU5hbWUgKTsKCQkJfTsKCQl9KSA6CgkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQlmdW5jdGlvbiggZWxlbSwgaSwgbWF0Y2ggKSB7CgkJCXJldHVybiAhISQuZGF0YSggZWxlbSwgbWF0Y2hbIDMgXSApOwoJCX0sCgoJZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQlyZXR1cm4gZm9jdXNhYmxlKCBlbGVtZW50LCAhaXNOYU4oICQuYXR0ciggZWxlbWVudCwgInRhYmluZGV4IiApICkgKTsKCX0sCgoJdGFiYmFibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXZhciB0YWJJbmRleCA9ICQuYXR0ciggZWxlbWVudCwgInRhYmluZGV4IiApLAoJCQlpc1RhYkluZGV4TmFOID0gaXNOYU4oIHRhYkluZGV4ICk7CgkJcmV0dXJuICggaXNUYWJJbmRleE5hTiB8fCB0YWJJbmRleCA+PSAwICkgJiYgZm9jdXNhYmxlKCBlbGVtZW50LCAhaXNUYWJJbmRleE5hTiApOwoJfQp9KTsKCi8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CmlmICggISQoICI8YT4iICkub3V0ZXJXaWR0aCggMSApLmpxdWVyeSApIHsKCSQuZWFjaCggWyAiV2lkdGgiLCAiSGVpZ2h0IiBdLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCQl2YXIgc2lkZSA9IG5hbWUgPT09ICJXaWR0aCIgPyBbICJMZWZ0IiwgIlJpZ2h0IiBdIDogWyAiVG9wIiwgIkJvdHRvbSIgXSwKCQkJdHlwZSA9IG5hbWUudG9Mb3dlckNhc2UoKSwKCQkJb3JpZyA9IHsKCQkJCWlubmVyV2lkdGg6ICQuZm4uaW5uZXJXaWR0aCwKCQkJCWlubmVySGVpZ2h0OiAkLmZuLmlubmVySGVpZ2h0LAoJCQkJb3V0ZXJXaWR0aDogJC5mbi5vdXRlcldpZHRoLAoJCQkJb3V0ZXJIZWlnaHQ6ICQuZm4ub3V0ZXJIZWlnaHQKCQkJfTsKCgkJZnVuY3Rpb24gcmVkdWNlKCBlbGVtLCBzaXplLCBib3JkZXIsIG1hcmdpbiApIHsKCQkJJC5lYWNoKCBzaWRlLCBmdW5jdGlvbigpIHsKCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJwYWRkaW5nIiArIHRoaXMgKSApIHx8IDA7CgkJCQlpZiAoIGJvcmRlciApIHsKCQkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAiYm9yZGVyIiArIHRoaXMgKyAiV2lkdGgiICkgKSB8fCAwOwoJCQkJfQoJCQkJaWYgKCBtYXJnaW4gKSB7CgkJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgIm1hcmdpbiIgKyB0aGlzICkgKSB8fCAwOwoJCQkJfQoJCQl9KTsKCQkJcmV0dXJuIHNpemU7CgkJfQoKCQkkLmZuWyAiaW5uZXIiICsgbmFtZSBdID0gZnVuY3Rpb24oIHNpemUgKSB7CgkJCWlmICggc2l6ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIG9yaWdbICJpbm5lciIgKyBuYW1lIF0uY2FsbCggdGhpcyApOwoJCQl9CgoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmNzcyggdHlwZSwgcmVkdWNlKCB0aGlzLCBzaXplICkgKyAicHgiICk7CgkJCX0pOwoJCX07CgoJCSQuZm5bICJvdXRlciIgKyBuYW1lXSA9IGZ1bmN0aW9uKCBzaXplLCBtYXJnaW4gKSB7CgkJCWlmICggdHlwZW9mIHNpemUgIT09ICJudW1iZXIiICkgewoJCQkJcmV0dXJuIG9yaWdbICJvdXRlciIgKyBuYW1lIF0uY2FsbCggdGhpcywgc2l6ZSApOwoJCQl9CgoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcykuY3NzKCB0eXBlLCByZWR1Y2UoIHRoaXMsIHNpemUsIHRydWUsIG1hcmdpbiApICsgInB4IiApOwoJCQl9KTsKCQl9OwoJfSk7Cn0KCi8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CmlmICggISQuZm4uYWRkQmFjayApIHsKCSQuZm4uYWRkQmFjayA9IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5hZGQoIHNlbGVjdG9yID09IG51bGwgPwoJCQl0aGlzLnByZXZPYmplY3QgOiB0aGlzLnByZXZPYmplY3QuZmlsdGVyKCBzZWxlY3RvciApCgkJKTsKCX07Cn0KCi8vIHN1cHBvcnQ6IGpRdWVyeSAxLjYuMSwgMS42LjIgKGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMpCmlmICggJCggIjxhPiIgKS5kYXRhKCAiYS1iIiwgImEiICkucmVtb3ZlRGF0YSggImEtYiIgKS5kYXRhKCAiYS1iIiApICkgewoJJC5mbi5yZW1vdmVEYXRhID0gKGZ1bmN0aW9uKCByZW1vdmVEYXRhICkgewoJCXJldHVybiBmdW5jdGlvbigga2V5ICkgewoJCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCQlyZXR1cm4gcmVtb3ZlRGF0YS5jYWxsKCB0aGlzLCAkLmNhbWVsQ2FzZSgga2V5ICkgKTsKCQkJfSBlbHNlIHsKCQkJCXJldHVybiByZW1vdmVEYXRhLmNhbGwoIHRoaXMgKTsKCQkJfQoJCX07Cgl9KSggJC5mbi5yZW1vdmVEYXRhICk7Cn0KCgoKCgovLyBkZXByZWNhdGVkCiQudWkuaWUgPSAhIS9tc2llIFtcdy5dKy8uZXhlYyggbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpICk7CgokLnN1cHBvcnQuc2VsZWN0c3RhcnQgPSAib25zZWxlY3RzdGFydCIgaW4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKJC5mbi5leHRlbmQoewoJZGlzYWJsZVNlbGVjdGlvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuYmluZCggKCAkLnN1cHBvcnQuc2VsZWN0c3RhcnQgPyAic2VsZWN0c3RhcnQiIDogIm1vdXNlZG93biIgKSArCgkJCSIudWktZGlzYWJsZVNlbGVjdGlvbiIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0pOwoJfSwKCgllbmFibGVTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnVuYmluZCggIi51aS1kaXNhYmxlU2VsZWN0aW9uIiApOwoJfSwKCgl6SW5kZXg6IGZ1bmN0aW9uKCB6SW5kZXggKSB7CgkJaWYgKCB6SW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIHRoaXMuY3NzKCAiekluZGV4IiwgekluZGV4ICk7CgkJfQoKCQlpZiAoIHRoaXMubGVuZ3RoICkgewoJCQl2YXIgZWxlbSA9ICQoIHRoaXNbIDAgXSApLCBwb3NpdGlvbiwgdmFsdWU7CgkJCXdoaWxlICggZWxlbS5sZW5ndGggJiYgZWxlbVsgMCBdICE9PSBkb2N1bWVudCApIHsKCQkJCS8vIElnbm9yZSB6LWluZGV4IGlmIHBvc2l0aW9uIGlzIHNldCB0byBhIHZhbHVlIHdoZXJlIHotaW5kZXggaXMgaWdub3JlZCBieSB0aGUgYnJvd3NlcgoJCQkJLy8gVGhpcyBtYWtlcyBiZWhhdmlvciBvZiB0aGlzIGZ1bmN0aW9uIGNvbnNpc3RlbnQgYWNyb3NzIGJyb3dzZXJzCgkJCQkvLyBXZWJLaXQgYWx3YXlzIHJldHVybnMgYXV0byBpZiB0aGUgZWxlbWVudCBpcyBwb3NpdGlvbmVkCgkJCQlwb3NpdGlvbiA9IGVsZW0uY3NzKCAicG9zaXRpb24iICk7CgkJCQlpZiAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAicmVsYXRpdmUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgewoJCQkJCS8vIElFIHJldHVybnMgMCB3aGVuIHpJbmRleCBpcyBub3Qgc3BlY2lmaWVkCgkJCQkJLy8gb3RoZXIgYnJvd3NlcnMgcmV0dXJuIGEgc3RyaW5nCgkJCQkJLy8gd2UgaWdub3JlIHRoZSBjYXNlIG9mIG5lc3RlZCBlbGVtZW50cyB3aXRoIGFuIGV4cGxpY2l0IHZhbHVlIG9mIDAKCQkJCQkvLyA8ZGl2IHN0eWxlPSJ6LWluZGV4OiAtMTA7Ij48ZGl2IHN0eWxlPSJ6LWluZGV4OiAwOyI+PC9kaXY+PC9kaXY+CgkJCQkJdmFsdWUgPSBwYXJzZUludCggZWxlbS5jc3MoICJ6SW5kZXgiICksIDEwICk7CgkJCQkJaWYgKCAhaXNOYU4oIHZhbHVlICkgJiYgdmFsdWUgIT09IDAgKSB7CgkJCQkJCXJldHVybiB2YWx1ZTsKCQkJCQl9CgkJCQl9CgkJCQllbGVtID0gZWxlbS5wYXJlbnQoKTsKCQkJfQoJCX0KCgkJcmV0dXJuIDA7Cgl9Cn0pOwoKLy8gJC51aS5wbHVnaW4gaXMgZGVwcmVjYXRlZC4gVXNlICQud2lkZ2V0KCkgZXh0ZW5zaW9ucyBpbnN0ZWFkLgokLnVpLnBsdWdpbiA9IHsKCWFkZDogZnVuY3Rpb24oIG1vZHVsZSwgb3B0aW9uLCBzZXQgKSB7CgkJdmFyIGksCgkJCXByb3RvID0gJC51aVsgbW9kdWxlIF0ucHJvdG90eXBlOwoJCWZvciAoIGkgaW4gc2V0ICkgewoJCQlwcm90by5wbHVnaW5zWyBpIF0gPSBwcm90by5wbHVnaW5zWyBpIF0gfHwgW107CgkJCXByb3RvLnBsdWdpbnNbIGkgXS5wdXNoKCBbIG9wdGlvbiwgc2V0WyBpIF0gXSApOwoJCX0KCX0sCgljYWxsOiBmdW5jdGlvbiggaW5zdGFuY2UsIG5hbWUsIGFyZ3MsIGFsbG93RGlzY29ubmVjdGVkICkgewoJCXZhciBpLAoJCQlzZXQgPSBpbnN0YW5jZS5wbHVnaW5zWyBuYW1lIF07CgoJCWlmICggIXNldCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCAhYWxsb3dEaXNjb25uZWN0ZWQgJiYgKCAhaW5zdGFuY2UuZWxlbWVudFsgMCBdLnBhcmVudE5vZGUgfHwgaW5zdGFuY2UuZWxlbWVudFsgMCBdLnBhcmVudE5vZGUubm9kZVR5cGUgPT09IDExICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCWZvciAoIGkgPSAwOyBpIDwgc2V0Lmxlbmd0aDsgaSsrICkgewoJCQlpZiAoIGluc3RhbmNlLm9wdGlvbnNbIHNldFsgaSBdWyAwIF0gXSApIHsKCQkJCXNldFsgaSBdWyAxIF0uYXBwbHkoIGluc3RhbmNlLmVsZW1lbnQsIGFyZ3MgKTsKCQkJfQoJCX0KCX0KfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJLy8gU3VidHJhY3QgdGhlIGhlaWdodCBvZiBleHRlcm5hbCB0b29sYmFycyBmcm9tIHRoZSBwYWdlIGhlaWdodCwgaWYgdGhlIHBhZ2UgZG9lcyBub3QgaGF2ZQoJLy8gaW50ZXJuYWwgdG9vbGJhcnMgb2YgdGhlIHNhbWUgdHlwZQoJdmFyIGNvbXBlbnNhdGVUb29sYmFycyA9IGZ1bmN0aW9uKCBwYWdlLCBkZXNpcmVkSGVpZ2h0ICkgewoJCXZhciBwYWdlUGFyZW50ID0gcGFnZS5wYXJlbnQoKSwKCQkJdG9vbGJhcnNBZmZlY3RpbmdIZWlnaHQgPSBbXSwKCQkJZXh0ZXJuYWxIZWFkZXJzID0gcGFnZVBhcmVudC5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLAoJCQlpbnRlcm5hbEhlYWRlcnMgPSBwYWdlLmNoaWxkcmVuKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICksCgkJCWV4dGVybmFsRm9vdGVycyA9IHBhZ2VQYXJlbnQuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdmb290ZXInKSIgKSwKCQkJaW50ZXJuYWxGb290ZXJzID0gcGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApOwoKCQkvLyBJZiB3ZSBoYXZlIG5vIGludGVybmFsIGhlYWRlcnMsIGJ1dCB3ZSBkbyBoYXZlIGV4dGVybmFsIGhlYWRlcnMsIHRoZW4gdGhlaXIgaGVpZ2h0CgkJLy8gcmVkdWNlcyB0aGUgcGFnZSBoZWlnaHQKCQlpZiAoIGludGVybmFsSGVhZGVycy5sZW5ndGggPT09IDAgJiYgZXh0ZXJuYWxIZWFkZXJzLmxlbmd0aCA+IDAgKSB7CgkJCXRvb2xiYXJzQWZmZWN0aW5nSGVpZ2h0ID0gdG9vbGJhcnNBZmZlY3RpbmdIZWlnaHQuY29uY2F0KCBleHRlcm5hbEhlYWRlcnMudG9BcnJheSgpICk7CgkJfQoKCQkvLyBJZiB3ZSBoYXZlIG5vIGludGVybmFsIGZvb3RlcnMsIGJ1dCB3ZSBkbyBoYXZlIGV4dGVybmFsIGZvb3RlcnMsIHRoZW4gdGhlaXIgaGVpZ2h0CgkJLy8gcmVkdWNlcyB0aGUgcGFnZSBoZWlnaHQKCQlpZiAoIGludGVybmFsRm9vdGVycy5sZW5ndGggPT09IDAgJiYgZXh0ZXJuYWxGb290ZXJzLmxlbmd0aCA+IDAgKSB7CgkJCXRvb2xiYXJzQWZmZWN0aW5nSGVpZ2h0ID0gdG9vbGJhcnNBZmZlY3RpbmdIZWlnaHQuY29uY2F0KCBleHRlcm5hbEZvb3RlcnMudG9BcnJheSgpICk7CgkJfQoKCQkkLmVhY2goIHRvb2xiYXJzQWZmZWN0aW5nSGVpZ2h0LCBmdW5jdGlvbiggaW5kZXgsIHZhbHVlICkgewoJCQlkZXNpcmVkSGVpZ2h0IC09ICQoIHZhbHVlICkub3V0ZXJIZWlnaHQoKTsKCQl9KTsKCgkJLy8gSGVpZ2h0IG11c3QgYmUgYXQgbGVhc3QgemVybwoJCXJldHVybiBNYXRoLm1heCggMCwgZGVzaXJlZEhlaWdodCApOwoJfTsKCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCQkvLyBkZWZpbmUgdGhlIHdpbmRvdyBhbmQgdGhlIGRvY3VtZW50IG9iamVjdHMKCQl3aW5kb3c6ICQoIHdpbmRvdyApLAoJCWRvY3VtZW50OiAkKCBkb2N1bWVudCApLAoKCQkvLyBUT0RPOiBSZW1vdmUgYW5kIHVzZSAkLnVpLmtleUNvZGUgZGlyZWN0bHkKCQlrZXlDb2RlOiAkLnVpLmtleUNvZGUsCgoJCS8vIFBsYWNlIHRvIHN0b3JlIHZhcmlvdXMgd2lkZ2V0IGV4dGVuc2lvbnMKCQliZWhhdmlvcnM6IHt9LAoKCQkvLyBTY3JvbGwgcGFnZSB2ZXJ0aWNhbGx5OiBzY3JvbGwgdG8gMCB0byBoaWRlIGlPUyBhZGRyZXNzIGJhciwgb3IgcGFzcyBhIFkgdmFsdWUKCQlzaWxlbnRTY3JvbGw6IGZ1bmN0aW9uKCB5cG9zICkgewoJCQlpZiAoICQudHlwZSggeXBvcyApICE9PSAibnVtYmVyIiApIHsKCQkJCXlwb3MgPSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCQkJfQoKCQkJLy8gcHJldmVudCBzY3JvbGxzdGFydCBhbmQgc2Nyb2xsc3RvcCBldmVudHMKCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSBmYWxzZTsKCgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHlwb3MgKTsKCQkJCSQubW9iaWxlLmRvY3VtZW50LnRyaWdnZXIoICJzaWxlbnRzY3JvbGwiLCB7IHg6IDAsIHk6IHlwb3MgfSk7CgkJCX0sIDIwICk7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQl9LCAxNTAgKTsKCQl9LAoKCQlnZXRDbG9zZXN0QmFzZVVybDogZnVuY3Rpb24oIGVsZSApCXsKCQkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYWdlIGFuZCBleHRyYWN0IG91dCBpdHMgdXJsLgoJCQl2YXIgdXJsID0gJCggZWxlICkuY2xvc2VzdCggIi51aS1wYWdlIiApLmpxbURhdGEoICJ1cmwiICksCgkJCQliYXNlID0gJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCgkJCWlmICggISQubW9iaWxlLmR5bmFtaWNCYXNlRW5hYmxlZCB8fCAhdXJsIHx8ICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggdXJsICkgKSB7CgkJCQl1cmwgPSBiYXNlOwoJCQl9CgoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgYmFzZSApOwoJCX0sCgkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzOiBmdW5jdGlvbiggZm9yY2VSZW1vdmFsICkgewoJCQlpZiAoICEhJC5tb2JpbGUuYWN0aXZlQ2xpY2tlZExpbmsgJiYKCQkJCSggISQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rLmNsb3Nlc3QoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLmxlbmd0aCB8fAoJCQkJCWZvcmNlUmVtb3ZhbCApICkgewoKCQkJCSQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJCSQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbDsKCQl9LAoKCQkvLyBERVBSRUNBVEVEIGluIDEuNAoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcyBvbiBpdC4gTm90ZSB0aGF0CgkJLy8gd2UgYXJlIG5vdCB1c2luZyAkLmZuLmNsb3Nlc3QoKSBvbiBwdXJwb3NlIGhlcmUgYmVjYXVzZSB0aGlzCgkJLy8gbWV0aG9kIGdldHMgY2FsbGVkIHF1aXRlIGEgYml0IGFuZCB3ZSBuZWVkIGl0IHRvIGJlIGFzIGZhc3QKCQkvLyBhcyBwb3NzaWJsZS4KCQlnZXRJbmhlcml0ZWRUaGVtZTogZnVuY3Rpb24oIGVsLCBkZWZhdWx0VGhlbWUgKSB7CgkJCXZhciBlID0gZWxbIDAgXSwKCQkJCWx0ciA9ICIiLAoJCQkJcmUgPSAvdWktKGJhcnxib2R5fG92ZXJsYXkpLShbYS16XSlcYi8sCgkJCQljLCBtOwoJCQl3aGlsZSAoIGUgKSB7CgkJCQljID0gZS5jbGFzc05hbWUgfHwgIiI7CgkJCQlpZiAoIGMgJiYgKCBtID0gcmUuZXhlYyggYyApICkgJiYgKCBsdHIgPSBtWyAyIF0gKSApIHsKCQkJCQkvLyBXZSBmb3VuZCBhIHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3MKCQkJCQkvLyBvbiBpdCBzbyBiYWlsIGZyb20gdGhpcyBsb29wLgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCX0KCQkJLy8gUmV0dXJuIHRoZSB0aGVtZSBsZXR0ZXIgd2UgZm91bmQsIGlmIG5vbmUsIHJldHVybiB0aGUKCQkJLy8gc3BlY2lmaWVkIGRlZmF1bHQuCgkJCXJldHVybiBsdHIgfHwgZGVmYXVsdFRoZW1lIHx8ICJhIjsKCQl9LAoKCQllbmhhbmNlYWJsZTogZnVuY3Rpb24oIGVsZW1lbnRzICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggZWxlbWVudHMsICJlbmhhbmNlIiApOwoJCX0sCgoJCWhpamFja2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50cyApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoIGVsZW1lbnRzLCAiYWpheCIgKTsKCQl9LAoKCQloYXZlUGFyZW50czogZnVuY3Rpb24oIGVsZW1lbnRzLCBhdHRyICkgewoJCQlpZiAoICEkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCApIHsKCQkJCXJldHVybiBlbGVtZW50czsKCQkJfQoKCQkJdmFyIGNvdW50ID0gZWxlbWVudHMubGVuZ3RoLAoJCQkJJG5ld1NldCA9ICQoKSwKCQkJCWUsICRlbGVtZW50LCBleGNsdWRlZCwKCQkJCWksIGM7CgoJCQlmb3IgKCBpID0gMDsgaSA8IGNvdW50OyBpKysgKSB7CgkJCQkkZWxlbWVudCA9IGVsZW1lbnRzLmVxKCBpICk7CgkJCQlleGNsdWRlZCA9IGZhbHNlOwoJCQkJZSA9IGVsZW1lbnRzWyBpIF07CgoJCQkJd2hpbGUgKCBlICkgewoJCQkJCWMgPSBlLmdldEF0dHJpYnV0ZSA/IGUuZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyBhdHRyICkgOiAiIjsKCgkJCQkJaWYgKCBjID09PSAiZmFsc2UiICkgewoJCQkJCQlleGNsdWRlZCA9IHRydWU7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCgkJCQkJZSA9IGUucGFyZW50Tm9kZTsKCQkJCX0KCgkJCQlpZiAoICFleGNsdWRlZCApIHsKCQkJCQkkbmV3U2V0ID0gJG5ld1NldC5hZGQoICRlbGVtZW50ICk7CgkJCQl9CgkJCX0KCgkJCXJldHVybiAkbmV3U2V0OwoJCX0sCgoJCWdldFNjcmVlbkhlaWdodDogZnVuY3Rpb24oKSB7CgkJCS8vIE5hdGl2ZSBpbm5lckhlaWdodCByZXR1cm5zIG1vcmUgYWNjdXJhdGUgdmFsdWUgZm9yIHRoaXMgYWNyb3NzIHBsYXRmb3JtcywKCQkJLy8galF1ZXJ5IHZlcnNpb24gaXMgaGVyZSBhcyBhIG5vcm1hbGl6ZWQgZmFsbGJhY2sgZm9yIHBsYXRmb3JtcyBsaWtlIFN5bWJpYW4KCQkJcmV0dXJuIHdpbmRvdy5pbm5lckhlaWdodCB8fCAkLm1vYmlsZS53aW5kb3cuaGVpZ2h0KCk7CgkJfSwKCgkJLy9zaW1wbHkgc2V0IHRoZSBhY3RpdmUgcGFnZSdzIG1pbmltdW0gaGVpZ2h0IHRvIHNjcmVlbiBoZWlnaHQsIGRlcGVuZGluZyBvbiBvcmllbnRhdGlvbgoJCXJlc2V0QWN0aXZlUGFnZUhlaWdodDogZnVuY3Rpb24oIGhlaWdodCApIHsKCQkJdmFyIHBhZ2UgPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKSwKCQkJCXBhZ2VIZWlnaHQgPSBwYWdlLmhlaWdodCgpLAoJCQkJcGFnZU91dGVySGVpZ2h0ID0gcGFnZS5vdXRlckhlaWdodCggdHJ1ZSApOwoKCQkJaGVpZ2h0ID0gY29tcGVuc2F0ZVRvb2xiYXJzKCBwYWdlLAoJCQkJKCB0eXBlb2YgaGVpZ2h0ID09PSAibnVtYmVyIiApID8gaGVpZ2h0IDogJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCkgKTsKCgkJCS8vIFJlbW92ZSBhbnkgcHJldmlvdXMgbWluLWhlaWdodCBzZXR0aW5nCgkJCXBhZ2UuY3NzKCAibWluLWhlaWdodCIsICIiICk7CgoJCQkvLyBTZXQgdGhlIG1pbmltdW0gaGVpZ2h0IG9ubHkgaWYgdGhlIGhlaWdodCBhcyBkZXRlcm1pbmVkIGJ5IENTUyBpcyBpbnN1ZmZpY2llbnQKCQkJaWYgKCBwYWdlLmhlaWdodCgpIDwgaGVpZ2h0ICkgewoJCQkJcGFnZS5jc3MoICJtaW4taGVpZ2h0IiwgaGVpZ2h0IC0gKCBwYWdlT3V0ZXJIZWlnaHQgLSBwYWdlSGVpZ2h0ICkgKTsKCQkJfQoJCX0sCgoJCWxvYWRpbmc6IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCBjYWxsIHRvIHRoaXMgZnVuY3Rpb24sIGluc3RhbnRpYXRlIGEgbG9hZGVyIHdpZGdldAoJCQl2YXIgbG9hZGVyID0gdGhpcy5sb2FkaW5nLl93aWRnZXQgfHwgJCggJC5tb2JpbGUubG9hZGVyLnByb3RvdHlwZS5kZWZhdWx0SHRtbCApLmxvYWRlcigpLAoKCQkJCS8vIENhbGwgdGhlIGFwcHJvcHJpYXRlIG1ldGhvZCBvbiB0aGUgbG9hZGVyCgkJCQlyZXR1cm5WYWx1ZSA9IGxvYWRlci5sb2FkZXIuYXBwbHkoIGxvYWRlciwgYXJndW1lbnRzICk7CgoJCQkvLyBNYWtlIHN1cmUgdGhlIGxvYWRlciBpcyByZXRhaW5lZCBmb3IgZnV0dXJlIGNhbGxzIHRvIHRoaXMgZnVuY3Rpb24uCgkJCXRoaXMubG9hZGluZy5fd2lkZ2V0ID0gbG9hZGVyOwoKCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCX0KCX0pOwoKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtLCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciAkZWxlbSA9ICQoIGVsZW0gKSwKCQkJZGVwZW5kZW50cyA9ICRlbGVtLmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKTsKCgkJJGVsZW0uanFtRGF0YSggImRlcGVuZGVudHMiLCAkKCBkZXBlbmRlbnRzICkuYWRkKCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJLy8gcGx1Z2lucwoJJC5mbi5leHRlbmQoewoJCXJlbW92ZVdpdGhEZXBlbmRlbnRzOiBmdW5jdGlvbigpIHsKCQkJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyggdGhpcyApOwoJCX0sCgoJCS8vIEVuaGFuY2UgY2hpbGQgZWxlbWVudHMKCQllbmhhbmNlV2l0aGluOiBmdW5jdGlvbigpIHsKCQkJdmFyIGluZGV4LAoJCQkJd2lkZ2V0RWxlbWVudHMgPSB7fSwKCQkJCWtlZXBOYXRpdmUgPSAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSwKCQkJCXRoYXQgPSB0aGlzOwoKCQkJLy8gQWRkIG5vIGpzIGNsYXNzIHRvIGVsZW1lbnRzCgkJCWlmICggJC5tb2JpbGUubm9qcyApIHsKCQkJCSQubW9iaWxlLm5vanMoIHRoaXMgKTsKCQkJfQoKCQkJLy8gQmluZCBsaW5rcyBmb3IgYWpheCBuYXYKCQkJaWYgKCAkLm1vYmlsZS5saW5rcyApIHsKCQkJCSQubW9iaWxlLmxpbmtzKCB0aGlzICk7CgkJCX0KCgkJCS8vIERlZ3JhZGUgaW5wdXRzIGZvciBzdHlsZWluZwoJCQlpZiAoICQubW9iaWxlLmRlZ3JhZGVJbnB1dHNXaXRoaW4gKSB7CgkJCQkkLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluKCB0aGlzICk7CgkJCX0KCgkJCS8vIFJ1biBidXR0b25tYXJrdXAKCQkJaWYgKCAkLmZuLmJ1dHRvbk1hcmt1cCApIHsKCQkJCXRoaXMuZmluZCggJC5mbi5idXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkubm90KCBrZWVwTmF0aXZlICkKCQkJCS5qcW1FbmhhbmNlYWJsZSgpLmJ1dHRvbk1hcmt1cCgpOwoJCQl9CgoJCQkvLyBBZGQgY2xhc3NlcyBmb3IgZmllbGRDb250YWluCgkJCWlmICggJC5mbi5maWVsZGNvbnRhaW4gKSB7CgkJCQl0aGlzLmZpbmQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIgKS5ub3QoIGtlZXBOYXRpdmUgKQoJCQkJLmpxbUVuaGFuY2VhYmxlKCkuZmllbGRjb250YWluKCk7CgkJCX0KCgkJCS8vIEVuaGFuY2Ugd2lkZ2V0cwoJCQkkLmVhY2goICQubW9iaWxlLndpZGdldHMsIGZ1bmN0aW9uKCBuYW1lLCBjb25zdHJ1Y3RvciApIHsKCgkJCQkvLyBJZiBpbml0U2VsZWN0b3Igbm90IGZhbHNlIGZpbmQgZWxlbWVudHMKCQkJCWlmICggY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yICkgewoKCQkJCQkvLyBGaWx0ZXIgZWxlbWVudHMgdGhhdCBzaG91bGQgbm90IGJlIGVuaGFuY2VkIGJhc2VkIG9uIHBhcmVudHMKCQkJCQl2YXIgZWxlbWVudHMgPSAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhhdC5maW5kKCBjb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgKSApOwoKCQkJCQkvLyBJZiBhbnkgbWF0Y2hpbmcgZWxlbWVudHMgcmVtYWluIGZpbHRlciBvbmVzIHdpdGgga2VlcE5hdGl2ZVNlbGVjdG9yCgkJCQkJaWYgKCBlbGVtZW50cy5sZW5ndGggPiAwICkgewoKCQkJCQkJLy8gJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yIGlzIGRlcHJlY2F0ZWQgdGhpcyBpcyBqdXN0IGZvciBiYWNrY29tcGF0CgkJCQkJCS8vIFN3aXRjaCB0byAkLm1vYmlsZS5rZWVwTmF0aXZlIGluIDEuNSB3aGljaCBpcyBqdXN0IGEgdmFsdWUgbm90IGEgZnVuY3Rpb24KCQkJCQkJZWxlbWVudHMgPSBlbGVtZW50cy5ub3QoIGtlZXBOYXRpdmUgKTsKCQkJCQl9CgoJCQkJCS8vIEVuaGFuY2Ugd2hhdGV2ZXIgaXMgbGVmdAoJCQkJCWlmICggZWxlbWVudHMubGVuZ3RoID4gMCApIHsKCQkJCQkJd2lkZ2V0RWxlbWVudHNbIGNvbnN0cnVjdG9yLnByb3RvdHlwZS53aWRnZXROYW1lIF0gPSBlbGVtZW50czsKCQkJCQl9CgkJCQl9CgkJCX0pOwoKCQkJZm9yICggaW5kZXggaW4gd2lkZ2V0RWxlbWVudHMgKSB7CgkJCQl3aWRnZXRFbGVtZW50c1sgaW5kZXggXVsgaW5kZXggXSgpOwoJCQl9CgoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlhZGREZXBlbmRlbnRzOiBmdW5jdGlvbiggbmV3RGVwZW5kZW50cyApIHsKCQkJJC5hZGREZXBlbmRlbnRzKCB0aGlzLCBuZXdEZXBlbmRlbnRzICk7CgkJfSwKCgkJLy8gbm90ZSB0aGF0IHRoaXMgaGVscGVyIGRvZXNuJ3QgYXR0ZW1wdCB0byBoYW5kbGUgdGhlIGNhbGxiYWNrCgkJLy8gb3Igc2V0dGluZyBvZiBhbiBodG1sIGVsZW1lbnQncyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkJLy8gdG8gcmV0dXJuIHRoZSBodG1sIGVuY29kZWQgdmVyc2lvbiBvZiB0aGUgdGV4dCBpbiBhbGwgY2FzZXMuICh0aHVzIHRoZSBuYW1lKQoJCWdldEVuY29kZWRUZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQoICI8YT4iICkudGV4dCggdGhpcy50ZXh0KCkgKS5odG1sKCk7CgkJfSwKCgkJLy8gZmx1ZW50IGhlbHBlciBmdW5jdGlvbiBmb3IgdGhlIG1vYmlsZSBuYW1lc3BhY2VkIGVxdWl2YWxlbnQKCQlqcW1FbmhhbmNlYWJsZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5lbmhhbmNlYWJsZSggdGhpcyApOwoJCX0sCgoJCWpxbUhpamFja2FibGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuaGlqYWNrYWJsZSggdGhpcyApOwoJCX0KCX0pOwoKCSQucmVtb3ZlV2l0aERlcGVuZGVudHMgPSBmdW5jdGlvbiggbmF0aXZlRWxlbWVudCApIHsKCQl2YXIgZWxlbWVudCA9ICQoIG5hdGl2ZUVsZW1lbnQgKTsKCgkJKCBlbGVtZW50LmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKSApLnJlbW92ZSgpOwoJCWVsZW1lbnQucmVtb3ZlKCk7Cgl9OwoJJC5hZGREZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5hdGl2ZUVsZW1lbnQsIG5ld0RlcGVuZGVudHMgKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCBuYXRpdmVFbGVtZW50ICksCgkJCWRlcGVuZGVudHMgPSBlbGVtZW50LmpxbURhdGEoICJkZXBlbmRlbnRzIiApIHx8ICQoKTsKCgkJZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIsICQoIGRlcGVuZGVudHMgKS5hZGQoIG5ld0RlcGVuZGVudHMgKSApOwoJfTsKCgkkLmZpbmQubWF0Y2hlcyA9IGZ1bmN0aW9uKCBleHByLCBzZXQgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgc2V0ICk7Cgl9OwoKCSQuZmluZC5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiggbm9kZSwgZXhwciApIHsKCQlyZXR1cm4gJC5maW5kKCBleHByLCBudWxsLCBudWxsLCBbIG5vZGUgXSApLmxlbmd0aCA+IDA7Cgl9OwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IGMwYWI3MTA1NmI5MzY2MjdlOGE3ODIxZjAzYzA0NGFlYzYyODBhNDAKICogaHR0cDovL2pxdWVyeXVpLmNvbQogKgogKiBDb3B5cmlnaHQgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBodHRwOi8vYXBpLmpxdWVyeXVpLmNvbS9qUXVlcnkud2lkZ2V0LwogKi8KKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdXVpZCA9IDAsCglzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKCV9jbGVhbkRhdGEgPSAkLmNsZWFuRGF0YTsKJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7Cglmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQl0cnkgewoJCQkkKCBlbGVtICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvODIzNQoJCX0gY2F0Y2goIGUgKSB7fQoJfQoJX2NsZWFuRGF0YSggZWxlbXMgKTsKfTsKCiQud2lkZ2V0ID0gZnVuY3Rpb24oIG5hbWUsIGJhc2UsIHByb3RvdHlwZSApIHsKCXZhciBmdWxsTmFtZSwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgY29uc3RydWN0b3IsIGJhc2VQcm90b3R5cGUsCgkJLy8gcHJveGllZFByb3RvdHlwZSBhbGxvd3MgdGhlIHByb3ZpZGVkIHByb3RvdHlwZSB0byByZW1haW4gdW5tb2RpZmllZAoJCS8vIHNvIHRoYXQgaXQgY2FuIGJlIHVzZWQgYXMgYSBtaXhpbiBmb3IgbXVsdGlwbGUgd2lkZ2V0cyAoIzg4NzYpCgkJcHJveGllZFByb3RvdHlwZSA9IHt9LAoJCW5hbWVzcGFjZSA9IG5hbWUuc3BsaXQoICIuIiApWyAwIF07CgoJbmFtZSA9IG5hbWUuc3BsaXQoICIuIiApWyAxIF07CglmdWxsTmFtZSA9IG5hbWVzcGFjZSArICItIiArIG5hbWU7CgoJaWYgKCAhcHJvdG90eXBlICkgewoJCXByb3RvdHlwZSA9IGJhc2U7CgkJYmFzZSA9ICQuV2lkZ2V0OwoJfQoKCS8vIGNyZWF0ZSBzZWxlY3RvciBmb3IgcGx1Z2luCgkkLmV4cHJbICI6IiBdWyBmdWxsTmFtZS50b0xvd2VyQ2FzZSgpIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CglleGlzdGluZ0NvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXTsKCWNvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCAibmV3IiBrZXl3b3JkCgkJaWYgKCAhdGhpcy5fY3JlYXRlV2lkZ2V0ICkgewoJCQlyZXR1cm4gbmV3IGNvbnN0cnVjdG9yKCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCQkvLyBtdXN0IHVzZSAibmV3IiBrZXl3b3JkICh0aGUgY29kZSBhYm92ZSBhbHdheXMgcGFzc2VzIGFyZ3MpCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9Cgl9OwoJLy8gZXh0ZW5kIHdpdGggdGhlIGV4aXN0aW5nIGNvbnN0cnVjdG9yIHRvIGNhcnJ5IG92ZXIgYW55IHN0YXRpYyBwcm9wZXJ0aWVzCgkkLmV4dGVuZCggY29uc3RydWN0b3IsIGV4aXN0aW5nQ29uc3RydWN0b3IsIHsKCQl2ZXJzaW9uOiBwcm90b3R5cGUudmVyc2lvbiwKCQkvLyBjb3B5IHRoZSBvYmplY3QgdXNlZCB0byBjcmVhdGUgdGhlIHByb3RvdHlwZSBpbiBjYXNlIHdlIG5lZWQgdG8KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyCgkJX3Byb3RvOiAkLmV4dGVuZCgge30sIHByb3RvdHlwZSApLAoJCS8vIHRyYWNrIHdpZGdldHMgdGhhdCBpbmhlcml0IGZyb20gdGhpcyB3aWRnZXQgaW4gY2FzZSB0aGlzIHdpZGdldCBpcwoJCS8vIHJlZGVmaW5lZCBhZnRlciBhIHdpZGdldCBpbmhlcml0cyBmcm9tIGl0CgkJX2NoaWxkQ29uc3RydWN0b3JzOiBbXQoJfSk7CgoJYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkLmVhY2goIHByb3RvdHlwZSwgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCWlmICggISQuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcHJveGllZFByb3RvdHlwZVsgcHJvcCBdID0gdmFsdWU7CgkJCXJldHVybjsKCQl9CgkJcHJveGllZFByb3RvdHlwZVsgcHJvcCBdID0gKGZ1bmN0aW9uKCkgewoJCQl2YXIgX3N1cGVyID0gZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJfSwKCQkJCV9zdXBlckFwcGx5ID0gZnVuY3Rpb24oIGFyZ3MgKSB7CgkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3MgKTsKCQkJCX07CgkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCXZhciBfX3N1cGVyID0gdGhpcy5fc3VwZXIsCgkJCQkJX19zdXBlckFwcGx5ID0gdGhpcy5fc3VwZXJBcHBseSwKCQkJCQlyZXR1cm5WYWx1ZTsKCgkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsKCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfc3VwZXJBcHBseTsKCgkJCQlyZXR1cm5WYWx1ZSA9IHZhbHVlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJCQl0aGlzLl9zdXBlciA9IF9fc3VwZXI7CgkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX19zdXBlckFwcGx5OwoKCQkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQkJfTsKCQl9KSgpOwoJfSk7Cgljb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAkLndpZGdldC5leHRlbmQoIGJhc2VQcm90b3R5cGUsIHsKCQkvLyBUT0RPOiByZW1vdmUgc3VwcG9ydCBmb3Igd2lkZ2V0RXZlbnRQcmVmaXgKCQkvLyBhbHdheXMgdXNlIHRoZSBuYW1lICsgYSBjb2xvbiBhcyB0aGUgcHJlZml4LCBlLmcuLCBkcmFnZ2FibGU6c3RhcnQKCQkvLyBkb24ndCBwcmVmaXggZm9yIHdpZGdldHMgdGhhdCBhcmVuJ3QgRE9NLWJhc2VkCgkJd2lkZ2V0RXZlbnRQcmVmaXg6IGV4aXN0aW5nQ29uc3RydWN0b3IgPyAoYmFzZVByb3RvdHlwZS53aWRnZXRFdmVudFByZWZpeCB8fCBuYW1lKSA6IG5hbWUKCX0sIHByb3hpZWRQcm90b3R5cGUsIHsKCQljb25zdHJ1Y3RvcjogY29uc3RydWN0b3IsCgkJbmFtZXNwYWNlOiBuYW1lc3BhY2UsCgkJd2lkZ2V0TmFtZTogbmFtZSwKCQl3aWRnZXRGdWxsTmFtZTogZnVsbE5hbWUKCX0pOwoKCS8vIElmIHRoaXMgd2lkZ2V0IGlzIGJlaW5nIHJlZGVmaW5lZCB0aGVuIHdlIG5lZWQgdG8gZmluZCBhbGwgd2lkZ2V0cyB0aGF0CgkvLyBhcmUgaW5oZXJpdGluZyBmcm9tIGl0IGFuZCByZWRlZmluZSBhbGwgb2YgdGhlbSBzbyB0aGF0IHRoZXkgaW5oZXJpdCBmcm9tCgkvLyB0aGUgbmV3IHZlcnNpb24gb2YgdGhpcyB3aWRnZXQuIFdlJ3JlIGVzc2VudGlhbGx5IHRyeWluZyB0byByZXBsYWNlIG9uZQoJLy8gbGV2ZWwgaW4gdGhlIHByb3RvdHlwZSBjaGFpbi4KCWlmICggZXhpc3RpbmdDb25zdHJ1Y3RvciApIHsKCQkkLmVhY2goIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzLCBmdW5jdGlvbiggaSwgY2hpbGQgKSB7CgkJCXZhciBjaGlsZFByb3RvdHlwZSA9IGNoaWxkLnByb3RvdHlwZTsKCgkJCS8vIHJlZGVmaW5lIHRoZSBjaGlsZCB3aWRnZXQgdXNpbmcgdGhlIHNhbWUgcHJvdG90eXBlIHRoYXQgd2FzCgkJCS8vIG9yaWdpbmFsbHkgdXNlZCwgYnV0IGluaGVyaXQgZnJvbSB0aGUgbmV3IHZlcnNpb24gb2YgdGhlIGJhc2UKCQkJJC53aWRnZXQoIGNoaWxkUHJvdG90eXBlLm5hbWVzcGFjZSArICIuIiArIGNoaWxkUHJvdG90eXBlLndpZGdldE5hbWUsIGNvbnN0cnVjdG9yLCBjaGlsZC5fcHJvdG8gKTsKCQl9KTsKCQkvLyByZW1vdmUgdGhlIGxpc3Qgb2YgZXhpc3RpbmcgY2hpbGQgY29uc3RydWN0b3JzIGZyb20gdGhlIG9sZCBjb25zdHJ1Y3RvcgoJCS8vIHNvIHRoZSBvbGQgY2hpbGQgY29uc3RydWN0b3JzIGNhbiBiZSBnYXJiYWdlIGNvbGxlY3RlZAoJCWRlbGV0ZSBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9yczsKCX0gZWxzZSB7CgkJYmFzZS5fY2hpbGRDb25zdHJ1Y3RvcnMucHVzaCggY29uc3RydWN0b3IgKTsKCX0KCgkkLndpZGdldC5icmlkZ2UoIG5hbWUsIGNvbnN0cnVjdG9yICk7CgoJcmV0dXJuIGNvbnN0cnVjdG9yOwp9OwoKJC53aWRnZXQuZXh0ZW5kID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCXZhciBpbnB1dCA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCWlucHV0SW5kZXggPSAwLAoJCWlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLAoJCWtleSwKCQl2YWx1ZTsKCWZvciAoIDsgaW5wdXRJbmRleCA8IGlucHV0TGVuZ3RoOyBpbnB1dEluZGV4KysgKSB7CgkJZm9yICgga2V5IGluIGlucHV0WyBpbnB1dEluZGV4IF0gKSB7CgkJCXZhbHVlID0gaW5wdXRbIGlucHV0SW5kZXggXVsga2V5IF07CgkJCWlmICggaW5wdXRbIGlucHV0SW5kZXggXS5oYXNPd25Qcm9wZXJ0eSgga2V5ICkgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCS8vIENsb25lIG9iamVjdHMKCQkJCWlmICggJC5pc1BsYWluT2JqZWN0KCB2YWx1ZSApICkgewoJCQkJCXRhcmdldFsga2V5IF0gPSAkLmlzUGxhaW5PYmplY3QoIHRhcmdldFsga2V5IF0gKSA/CgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHRhcmdldFsga2V5IF0sIHZhbHVlICkgOgoJCQkJCQkvLyBEb24ndCBleHRlbmQgc3RyaW5ncywgYXJyYXlzLCBldGMuIHdpdGggb2JqZWN0cwoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB2YWx1ZSApOwoJCQkJLy8gQ29weSBldmVyeXRoaW5nIGVsc2UgYnkgcmVmZXJlbmNlCgkJCQl9IGVsc2UgewoJCQkJCXRhcmdldFsga2V5IF0gPSB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCX0KCXJldHVybiB0YXJnZXQ7Cn07CgokLndpZGdldC5icmlkZ2UgPSBmdW5jdGlvbiggbmFtZSwgb2JqZWN0ICkgewoJdmFyIGZ1bGxOYW1lID0gb2JqZWN0LnByb3RvdHlwZS53aWRnZXRGdWxsTmFtZSB8fCBuYW1lOwoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlzTWV0aG9kQ2FsbCA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiwKCQkJYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCQlyZXR1cm5WYWx1ZSA9IHRoaXM7CgoJCS8vIGFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCW9wdGlvbnMgPSAhaXNNZXRob2RDYWxsICYmIGFyZ3MubGVuZ3RoID8KCQkJJC53aWRnZXQuZXh0ZW5kLmFwcGx5KCBudWxsLCBbIG9wdGlvbnMgXS5jb25jYXQoYXJncykgKSA6CgkJCW9wdGlvbnM7CgoJCWlmICggaXNNZXRob2RDYWxsICkgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgbWV0aG9kVmFsdWUsCgkJCQkJaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7CgkJCQlpZiAoIG9wdGlvbnMgPT09ICJpbnN0YW5jZSIgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBpbnN0YW5jZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKyAiIHByaW9yIHRvIGluaXRpYWxpemF0aW9uOyAiICsKCQkJCQkJImF0dGVtcHRlZCB0byBjYWxsIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyIgKTsKCQkJCX0KCQkJCWlmICggISQuaXNGdW5jdGlvbiggaW5zdGFuY2Vbb3B0aW9uc10gKSB8fCBvcHRpb25zLmNoYXJBdCggMCApID09PSAiXyIgKSB7CgkJCQkJcmV0dXJuICQuZXJyb3IoICJubyBzdWNoIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyBmb3IgIiArIG5hbWUgKyAiIHdpZGdldCBpbnN0YW5jZSIgKTsKCQkJCX0KCQkJCW1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCQkJCWlmICggbWV0aG9kVmFsdWUgIT09IGluc3RhbmNlICYmIG1ldGhvZFZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZSAmJiBtZXRob2RWYWx1ZS5qcXVlcnkgPwoJCQkJCQlyZXR1cm5WYWx1ZS5wdXNoU3RhY2soIG1ldGhvZFZhbHVlLmdldCgpICkgOgoJCQkJCQltZXRob2RWYWx1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICkuX2luaXQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSwgbmV3IG9iamVjdCggb3B0aW9ucywgdGhpcyApICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfTsKfTsKCiQuV2lkZ2V0ID0gZnVuY3Rpb24oIC8qIG9wdGlvbnMsIGVsZW1lbnQgKi8gKSB7fTsKJC5XaWRnZXQuX2NoaWxkQ29uc3RydWN0b3JzID0gW107CgokLldpZGdldC5wcm90b3R5cGUgPSB7Cgl3aWRnZXROYW1lOiAid2lkZ2V0IiwKCXdpZGdldEV2ZW50UHJlZml4OiAiIiwKCWRlZmF1bHRFbGVtZW50OiAiPGRpdj4iLAoJb3B0aW9uczogewoJCWRpc2FibGVkOiBmYWxzZSwKCgkJLy8gY2FsbGJhY2tzCgkJY3JlYXRlOiBudWxsCgl9LAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJZWxlbWVudCA9ICQoIGVsZW1lbnQgfHwgdGhpcy5kZWZhdWx0RWxlbWVudCB8fCB0aGlzIClbIDAgXTsKCQl0aGlzLmVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJdGhpcy51dWlkID0gdXVpZCsrOwoJCXRoaXMuZXZlbnROYW1lc3BhY2UgPSAiLiIgKyB0aGlzLndpZGdldE5hbWUgKyB0aGlzLnV1aWQ7CgkJdGhpcy5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwKCQkJdGhpcy5vcHRpb25zLAoJCQl0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksCgkJCW9wdGlvbnMgKTsKCgkJdGhpcy5iaW5kaW5ncyA9ICQoKTsKCQl0aGlzLmhvdmVyYWJsZSA9ICQoKTsKCQl0aGlzLmZvY3VzYWJsZSA9ICQoKTsKCgkJaWYgKCBlbGVtZW50ICE9PSB0aGlzICkgewoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0RnVsbE5hbWUsIHRoaXMgKTsKCQkJdGhpcy5fb24oIHRydWUsIHRoaXMuZWxlbWVudCwgewoJCQkJcmVtb3ZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBldmVudC50YXJnZXQgPT09IGVsZW1lbnQgKSB7CgkJCQkJCXRoaXMuZGVzdHJveSgpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJCXRoaXMuZG9jdW1lbnQgPSAkKCBlbGVtZW50LnN0eWxlID8KCQkJCS8vIGVsZW1lbnQgd2l0aGluIHRoZSBkb2N1bWVudAoJCQkJZWxlbWVudC5vd25lckRvY3VtZW50IDoKCQkJCS8vIGVsZW1lbnQgaXMgd2luZG93IG9yIGRvY3VtZW50CgkJCQllbGVtZW50LmRvY3VtZW50IHx8IGVsZW1lbnQgKTsKCQkJdGhpcy53aW5kb3cgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmRlZmF1bHRWaWV3IHx8IHRoaXMuZG9jdW1lbnRbMF0ucGFyZW50V2luZG93ICk7CgkJfQoKCQl0aGlzLl9jcmVhdGUoKTsKCQl0aGlzLl90cmlnZ2VyKCAiY3JlYXRlIiwgbnVsbCwgdGhpcy5fZ2V0Q3JlYXRlRXZlbnREYXRhKCkgKTsKCQl0aGlzLl9pbml0KCk7Cgl9LAoJX2dldENyZWF0ZU9wdGlvbnM6ICQubm9vcCwKCV9nZXRDcmVhdGVFdmVudERhdGE6ICQubm9vcCwKCV9jcmVhdGU6ICQubm9vcCwKCV9pbml0OiAkLm5vb3AsCgoJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZGVzdHJveSgpOwoJCS8vIHdlIGNhbiBwcm9iYWJseSByZW1vdmUgdGhlIHVuYmluZCBjYWxscyBpbiAyLjAKCQkvLyBhbGwgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGdvIHRocm91Z2ggdGhpcy5fb24oKQoJCXRoaXMuZWxlbWVudAoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKQoJCQkvLyBzdXBwb3J0OiBqcXVlcnkgPDEuNi4zCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMKCQkJLnJlbW92ZURhdGEoICQuY2FtZWxDYXNlKCB0aGlzLndpZGdldEZ1bGxOYW1lICkgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7CgoJCS8vIGNsZWFuIHVwIGV2ZW50cyBhbmQgc3RhdGVzCgkJdGhpcy5iaW5kaW5ncy51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKTsKCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7Cgl9LAoJX2Rlc3Ryb3k6ICQubm9vcCwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXksCgkJCXBhcnRzLAoJCQljdXJPcHRpb24sCgkJCWk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIGhhbmRsZSBuZXN0ZWQga2V5cywgZS5nLiwgImZvby5iYXIiID0+IHsgZm9vOiB7IGJhcjogX19fIH0gfQoJCQlvcHRpb25zID0ge307CgkJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIgKTsKCQkJa2V5ID0gcGFydHMuc2hpZnQoKTsKCQkJaWYgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQljdXJPcHRpb24gPSBvcHRpb25zWyBrZXkgXSA9ICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9uc1sga2V5IF0gKTsKCQkJCWZvciAoIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrICkgewoJCQkJCWN1ck9wdGlvblsgcGFydHNbIGkgXSBdID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gfHwge307CgkJCQkJY3VyT3B0aW9uID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF07CgkJCQl9CgkJCQlrZXkgPSBwYXJ0cy5wb3AoKTsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gY3VyT3B0aW9uWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IGN1ck9wdGlvblsga2V5IF07CgkJCQl9CgkJCQljdXJPcHRpb25bIGtleSBdID0gdmFsdWU7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQkJfQoJCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGtleTsKCgkJZm9yICgga2V5IGluIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3NldE9wdGlvbigga2V5LCBvcHRpb25zWyBrZXkgXSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnRvZ2dsZUNsYXNzKCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCIsICEhdmFsdWUgKTsKCQkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb25zKHsgZGlzYWJsZWQ6IGZhbHNlIH0pOwoJfSwKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb25zKHsgZGlzYWJsZWQ6IHRydWUgfSk7Cgl9LAoKCV9vbjogZnVuY3Rpb24oIHN1cHByZXNzRGlzYWJsZWRDaGVjaywgZWxlbWVudCwgaGFuZGxlcnMgKSB7CgkJdmFyIGRlbGVnYXRlRWxlbWVudCwKCQkJaW5zdGFuY2UgPSB0aGlzOwoKCQkvLyBubyBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgZmxhZywgc2h1ZmZsZSBhcmd1bWVudHMKCQlpZiAoIHR5cGVvZiBzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgIT09ICJib29sZWFuIiApIHsKCQkJaGFuZGxlcnMgPSBlbGVtZW50OwoJCQllbGVtZW50ID0gc3VwcHJlc3NEaXNhYmxlZENoZWNrOwoJCQlzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgPSBmYWxzZTsKCQl9CgoJCS8vIG5vIGVsZW1lbnQgYXJndW1lbnQsIHNodWZmbGUgYW5kIHVzZSB0aGlzLmVsZW1lbnQKCQlpZiAoICFoYW5kbGVycyApIHsKCQkJaGFuZGxlcnMgPSBlbGVtZW50OwoJCQllbGVtZW50ID0gdGhpcy5lbGVtZW50OwoJCQlkZWxlZ2F0ZUVsZW1lbnQgPSB0aGlzLndpZGdldCgpOwoJCX0gZWxzZSB7CgkJCS8vIGFjY2VwdCBzZWxlY3RvcnMsIERPTSBlbGVtZW50cwoJCQllbGVtZW50ID0gZGVsZWdhdGVFbGVtZW50ID0gJCggZWxlbWVudCApOwoJCQl0aGlzLmJpbmRpbmdzID0gdGhpcy5iaW5kaW5ncy5hZGQoIGVsZW1lbnQgKTsKCQl9CgoJCSQuZWFjaCggaGFuZGxlcnMsIGZ1bmN0aW9uKCBldmVudCwgaGFuZGxlciApIHsKCQkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQkJLy8gYWxsb3cgd2lkZ2V0cyB0byBjdXN0b21pemUgdGhlIGRpc2FibGVkIGhhbmRsaW5nCgkJCQkvLyAtIGRpc2FibGVkIGFzIGFuIGFycmF5IGluc3RlYWQgb2YgYm9vbGVhbgoJCQkJLy8gLSBkaXNhYmxlZCBjbGFzcyBhcyBtZXRob2QgZm9yIGRpc2FibGluZyBpbmRpdmlkdWFsIHBhcnRzCgkJCQlpZiAoICFzdXBwcmVzc0Rpc2FibGVkQ2hlY2sgJiYKCQkJCQkJKCBpbnN0YW5jZS5vcHRpb25zLmRpc2FibGVkID09PSB0cnVlIHx8CgkJCQkJCQkkKCB0aGlzICkuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQkJfQoKCQkJLy8gY29weSB0aGUgZ3VpZCBzbyBkaXJlY3QgdW5iaW5kaW5nIHdvcmtzCgkJCWlmICggdHlwZW9mIGhhbmRsZXIgIT09ICJzdHJpbmciICkgewoJCQkJaGFuZGxlclByb3h5Lmd1aWQgPSBoYW5kbGVyLmd1aWQgPQoJCQkJCWhhbmRsZXIuZ3VpZCB8fCBoYW5kbGVyUHJveHkuZ3VpZCB8fCAkLmd1aWQrKzsKCQkJfQoKCQkJdmFyIG1hdGNoID0gZXZlbnQubWF0Y2goIC9eKFx3KylccyooLiopJC8gKSwKCQkJCWV2ZW50TmFtZSA9IG1hdGNoWzFdICsgaW5zdGFuY2UuZXZlbnROYW1lc3BhY2UsCgkJCQlzZWxlY3RvciA9IG1hdGNoWzJdOwoJCQlpZiAoIHNlbGVjdG9yICkgewoJCQkJZGVsZWdhdGVFbGVtZW50LmRlbGVnYXRlKCBzZWxlY3RvciwgZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsKCQkJfSBlbHNlIHsKCQkJCWVsZW1lbnQuYmluZCggZXZlbnROYW1lLCBoYW5kbGVyUHJveHkgKTsKCQkJfQoJCX0pOwoJfSwKCglfb2ZmOiBmdW5jdGlvbiggZWxlbWVudCwgZXZlbnROYW1lICkgewoJCWV2ZW50TmFtZSA9IChldmVudE5hbWUgfHwgIiIpLnNwbGl0KCAiICIgKS5qb2luKCB0aGlzLmV2ZW50TmFtZXNwYWNlICsgIiAiICkgKyB0aGlzLmV2ZW50TmFtZXNwYWNlOwoJCWVsZW1lbnQudW5iaW5kKCBldmVudE5hbWUgKS51bmRlbGVnYXRlKCBldmVudE5hbWUgKTsKCX0sCgoJX2RlbGF5OiBmdW5jdGlvbiggaGFuZGxlciwgZGVsYXkgKSB7CgkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQlyZXR1cm4gKCB0eXBlb2YgaGFuZGxlciA9PT0gInN0cmluZyIgPyBpbnN0YW5jZVsgaGFuZGxlciBdIDogaGFuZGxlciApCgkJCQkuYXBwbHkoIGluc3RhbmNlLCBhcmd1bWVudHMgKTsKCQl9CgkJdmFyIGluc3RhbmNlID0gdGhpczsKCQlyZXR1cm4gc2V0VGltZW91dCggaGFuZGxlclByb3h5LCBkZWxheSB8fCAwICk7Cgl9LAoKCV9ob3ZlcmFibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXRoaXMuaG92ZXJhYmxlID0gdGhpcy5ob3ZlcmFibGUuYWRkKCBlbGVtZW50ICk7CgkJdGhpcy5fb24oIGVsZW1lbnQsIHsKCQkJbW91c2VlbnRlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLmFkZENsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0sCgkJCW1vdXNlbGVhdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV9mb2N1c2FibGU6IGZ1bmN0aW9uKCBlbGVtZW50ICkgewoJCXRoaXMuZm9jdXNhYmxlID0gdGhpcy5mb2N1c2FibGUuYWRkKCBlbGVtZW50ICk7CgkJdGhpcy5fb24oIGVsZW1lbnQsIHsKCQkJZm9jdXNpbjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLmFkZENsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0sCgkJCWZvY3Vzb3V0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfQoJCX0pOwoJfSwKCglfdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGV2ZW50LCBkYXRhICkgewoJCXZhciBwcm9wLCBvcmlnLAoJCQljYWxsYmFjayA9IHRoaXMub3B0aW9uc1sgdHlwZSBdOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCQlldmVudCA9ICQuRXZlbnQoIGV2ZW50ICk7CgkJZXZlbnQudHlwZSA9ICggdHlwZSA9PT0gdGhpcy53aWRnZXRFdmVudFByZWZpeCA/CgkJCXR5cGUgOgoJCQl0aGlzLndpZGdldEV2ZW50UHJlZml4ICsgdHlwZSApLnRvTG93ZXJDYXNlKCk7CgkJLy8gdGhlIG9yaWdpbmFsIGV2ZW50IG1heSBjb21lIGZyb20gYW55IGVsZW1lbnQKCQkvLyBzbyB3ZSBuZWVkIHRvIHJlc2V0IHRoZSB0YXJnZXQgb24gdGhlIG5ldyBldmVudAoJCWV2ZW50LnRhcmdldCA9IHRoaXMuZWxlbWVudFsgMCBdOwoKCQkvLyBjb3B5IG9yaWdpbmFsIGV2ZW50IHByb3BlcnRpZXMgb3ZlciB0byB0aGUgbmV3IGV2ZW50CgkJb3JpZyA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7CgkJaWYgKCBvcmlnICkgewoJCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCQlpZiAoICEoIHByb3AgaW4gZXZlbnQgKSApIHsKCQkJCQlldmVudFsgcHJvcCBdID0gb3JpZ1sgcHJvcCBdOwoJCQkJfQoJCQl9CgkJfQoKCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggZXZlbnQsIGRhdGEgKTsKCQlyZXR1cm4gISggJC5pc0Z1bmN0aW9uKCBjYWxsYmFjayApICYmCgkJCWNhbGxiYWNrLmFwcGx5KCB0aGlzLmVsZW1lbnRbMF0sIFsgZXZlbnQgXS5jb25jYXQoIGRhdGEgKSApID09PSBmYWxzZSB8fAoJCQlldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApOwoJfQp9OwoKJC5lYWNoKCB7IHNob3c6ICJmYWRlSW4iLCBoaWRlOiAiZmFkZU91dCIgfSwgZnVuY3Rpb24oIG1ldGhvZCwgZGVmYXVsdEVmZmVjdCApIHsKCSQuV2lkZ2V0LnByb3RvdHlwZVsgIl8iICsgbWV0aG9kIF0gPSBmdW5jdGlvbiggZWxlbWVudCwgb3B0aW9ucywgY2FsbGJhY2sgKSB7CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gInN0cmluZyIgKSB7CgkJCW9wdGlvbnMgPSB7IGVmZmVjdDogb3B0aW9ucyB9OwoJCX0KCQl2YXIgaGFzT3B0aW9ucywKCQkJZWZmZWN0TmFtZSA9ICFvcHRpb25zID8KCQkJCW1ldGhvZCA6CgkJCQlvcHRpb25zID09PSB0cnVlIHx8IHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiA/CgkJCQkJZGVmYXVsdEVmZmVjdCA6CgkJCQkJb3B0aW9ucy5lZmZlY3QgfHwgZGVmYXVsdEVmZmVjdDsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAibnVtYmVyIiApIHsKCQkJb3B0aW9ucyA9IHsgZHVyYXRpb246IG9wdGlvbnMgfTsKCQl9CgkJaGFzT3B0aW9ucyA9ICEkLmlzRW1wdHlPYmplY3QoIG9wdGlvbnMgKTsKCQlvcHRpb25zLmNvbXBsZXRlID0gY2FsbGJhY2s7CgkJaWYgKCBvcHRpb25zLmRlbGF5ICkgewoJCQllbGVtZW50LmRlbGF5KCBvcHRpb25zLmRlbGF5ICk7CgkJfQoJCWlmICggaGFzT3B0aW9ucyAmJiAkLmVmZmVjdHMgJiYgJC5lZmZlY3RzLmVmZmVjdFsgZWZmZWN0TmFtZSBdICkgewoJCQllbGVtZW50WyBtZXRob2QgXSggb3B0aW9ucyApOwoJCX0gZWxzZSBpZiAoIGVmZmVjdE5hbWUgIT09IG1ldGhvZCAmJiBlbGVtZW50WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIGVmZmVjdE5hbWUgXSggb3B0aW9ucy5kdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcsIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudC5xdWV1ZShmdW5jdGlvbiggbmV4dCApIHsKCQkJCSQoIHRoaXMgKVsgbWV0aG9kIF0oKTsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCggZWxlbWVudFsgMCBdICk7CgkJCQl9CgkJCQluZXh0KCk7CgkJCX0pOwoJCX0KCX07Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcmNhcGl0YWxzID0gL1tBLVpdL2csCglyZXBsYWNlRnVuY3Rpb24gPSBmdW5jdGlvbiggYyApIHsKCQlyZXR1cm4gIi0iICsgYy50b0xvd2VyQ2FzZSgpOwoJfTsKCiQuZXh0ZW5kKCAkLldpZGdldC5wcm90b3R5cGUsIHsKCV9nZXRDcmVhdGVPcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9uLCB2YWx1ZSwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudFsgMCBdLAoJCQlvcHRpb25zID0ge307CgoJCS8vCgkJaWYgKCAhJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBlbGVtLCAiZGVmYXVsdHMiICkgKSB7CgkJCWZvciAoIG9wdGlvbiBpbiB0aGlzLm9wdGlvbnMgKSB7CgkJCQl2YWx1ZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggZWxlbSwgb3B0aW9uLnJlcGxhY2UoIHJjYXBpdGFscywgcmVwbGFjZUZ1bmN0aW9uICkgKTsKCgkJCQlpZiAoIHZhbHVlICE9IG51bGwgKSB7CgkJCQkJb3B0aW9uc1sgb3B0aW9uIF0gPSB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIG9wdGlvbnM7Cgl9Cn0pOwoKLy9UT0RPOiBSZW1vdmUgaW4gMS41IGZvciBiYWNrY29tcGF0IG9ubHkKJC5tb2JpbGUud2lkZ2V0ID0gJC5XaWRnZXQ7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoJLy8gVE9ETyBtb3ZlIGxvYWRlciBjbGFzcyBkb3duIGludG8gdGhlIHdpZGdldCBzZXR0aW5ncwoJdmFyIGxvYWRlckNsYXNzID0gInVpLWxvYWRlciIsICRodG1sID0gJCggImh0bWwiICk7CgoJJC53aWRnZXQoICJtb2JpbGUubG9hZGVyIiwgewoJCS8vIE5PVEUgaWYgdGhlIGdsb2JhbCBjb25maWcgc2V0dGluZ3MgYXJlIGRlZmluZWQgdGhleSB3aWxsIG92ZXJyaWRlIHRoZXNlCgkJLy8gICAgICBvcHRpb25zCgkJb3B0aW9uczogewoJCQkvLyB0aGUgdGhlbWUgZm9yIHRoZSBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhlbWU6ICJhIiwKCgkJCS8vIHdoZXRoZXIgdGhlIHRleHQgaW4gdGhlIGxvYWRpbmcgbWVzc2FnZSBpcyBzaG93bgoJCQl0ZXh0VmlzaWJsZTogZmFsc2UsCgoJCQkvLyBjdXN0b20gaHRtbCBmb3IgdGhlIGlubmVyIGNvbnRlbnQgb2YgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQlodG1sOiAiIiwKCgkJCS8vIHRoZSB0ZXh0IHRvIGJlIGRpc3BsYXllZCB3aGVuIHRoZSBwb3B1cCBpcyBzaG93bgoJCQl0ZXh0OiAibG9hZGluZyIKCQl9LAoKCQlkZWZhdWx0SHRtbDogIjxkaXYgY2xhc3M9JyIgKyBsb2FkZXJDbGFzcyArICInPiIgKwoJCQkiPHNwYW4gY2xhc3M9J3VpLWljb24tbG9hZGluZyc+PC9zcGFuPiIgKwoJCQkiPGgxPjwvaDE+IiArCgkJCSI8L2Rpdj4iLAoKCQkvLyBGb3Igbm9uLWZpeGVkIHN1cHBvcnRpbiBicm93c2Vycy4gUG9zaXRpb24gYXQgeSBjZW50ZXIgKGlmIHNjcm9sbFRvcCBzdXBwb3J0ZWQpLCBhYm92ZSB0aGUgYWN0aXZlQnRuIChpZiBkZWZpbmVkKSwgb3IganVzdCAxMDBweCBmcm9tIHRvcAoJCWZha2VGaXhMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5maXJzdCgpOwoKCQkJdGhpcy5lbGVtZW50CgkJCQkuY3NzKHsKCQkJCQl0b3A6ICQuc3VwcG9ydC5zY3JvbGxUb3AgJiYgdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCkgKyB0aGlzLndpbmRvdy5oZWlnaHQoKSAvIDIgfHwKCQkJCQkJYWN0aXZlQnRuLmxlbmd0aCAmJiBhY3RpdmVCdG4ub2Zmc2V0KCkudG9wIHx8IDEwMAoJCQkJfSk7CgkJfSwKCgkJLy8gY2hlY2sgcG9zaXRpb24gb2YgbG9hZGVyIHRvIHNlZSBpZiBpdCBhcHBlYXJzIHRvIGJlICJmaXhlZCIgdG8gY2VudGVyCgkJLy8gaWYgbm90LCB1c2UgYWJzIHBvc2l0aW9uaW5nCgkJY2hlY2tMb2FkZXJQb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJCXZhciBvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCksCgkJCQlzY3JvbGxUb3AgPSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJaWYgKCBvZmZzZXQudG9wIDwgc2Nyb2xsVG9wIHx8ICggb2Zmc2V0LnRvcCAtIHNjcm9sbFRvcCApID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCQl0aGlzLmZha2VGaXhMb2FkZXIoKTsKCQkJCXRoaXMud2luZG93CgkJCQkJLnVuYmluZCggInNjcm9sbCIsIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiApCgkJCQkJLmJpbmQoICJzY3JvbGwiLCAkLnByb3h5KCB0aGlzLmZha2VGaXhMb2FkZXIsIHRoaXMgKSApOwoJCQl9CgkJfSwKCgkJcmVzZXRIdG1sOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50Lmh0bWwoICQoIHRoaXMuZGVmYXVsdEh0bWwgKS5odG1sKCkgKTsKCQl9LAoKCQkvLyBUdXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4gVGhlbWUgZG91YmxlcyBhcyBhbiBvYmplY3QgYXJndW1lbnQKCQkvLyB3aXRoIHRoZSBmb2xsb3dpbmcgc2hhcGU6IHsgdGhlbWU6ICcnLCB0ZXh0OiAnJywgaHRtbDogJycsIHRleHRWaXNpYmxlOiAnJyB9CgkJLy8gTk9URSB0aGF0IHRoZSAkLm1vYmlsZS5sb2FkaW5nKiBzZXR0aW5ncyBhbmQgcGFyYW1zIHBhc3QgdGhlIGZpcnN0IGFyZSBkZXByZWNhdGVkCgkJLy8gVE9ETyBzd2VldCBqZXN1cyB3ZSBuZWVkIHRvIGJyZWFrIHNvbWUgb2YgdGhpcyBvdXQKCQlzaG93OiBmdW5jdGlvbiggdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICkgewoJCQl2YXIgdGV4dFZpc2libGUsIG1lc3NhZ2UsIGxvYWRTZXR0aW5nczsKCgkJCXRoaXMucmVzZXRIdG1sKCk7CgoJCQkvLyB1c2UgdGhlIHByb3RvdHlwZSBvcHRpb25zIHNvIHRoYXQgcGVvcGxlIGNhbiBzZXQgdGhlbSBnbG9iYWxseSBhdAoJCQkvLyBtb2JpbGUgaW5pdC4gQ29uc2lzdGVuY3ksIGl0J3Mgd2hhdCdzIGZvciBkaW5uZXIKCQkJaWYgKCAkLnR5cGUoIHRoZW1lICkgPT09ICJvYmplY3QiICkgewoJCQkJbG9hZFNldHRpbmdzID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIHRoZW1lICk7CgoJCQkJdGhlbWUgPSBsb2FkU2V0dGluZ3MudGhlbWU7CgkJCX0gZWxzZSB7CgkJCQlsb2FkU2V0dGluZ3MgPSB0aGlzLm9wdGlvbnM7CgoJCQkJLy8gaGVyZSB3ZSBwcmVmZXIgdGhlIHRoZW1lIHZhbHVlIHBhc3NlZCBhcyBhIHN0cmluZyBhcmd1bWVudCwgdGhlbgoJCQkJLy8gd2UgcHJlZmVyIHRoZSBnbG9iYWwgb3B0aW9uIGJlY2F1c2Ugd2UgY2FuJ3QgdXNlIHVuZGVmaW5lZCBkZWZhdWx0CgkJCQkvLyBwcm90b3R5cGUgb3B0aW9ucywgdGhlbiB0aGUgcHJvdG90eXBlIG9wdGlvbgoJCQkJdGhlbWUgPSB0aGVtZSB8fCBsb2FkU2V0dGluZ3MudGhlbWU7CgkJCX0KCgkJCS8vIHNldCB0aGUgbWVzc2FnZSB0ZXh0LCBwcmVmZXIgdGhlIHBhcmFtLCB0aGVuIHRoZSBzZXR0aW5ncyBvYmplY3QKCQkJLy8gdGhlbiBsb2FkaW5nIG1lc3NhZ2UKCQkJbWVzc2FnZSA9IG1zZ1RleHQgfHwgKCBsb2FkU2V0dGluZ3MudGV4dCA9PT0gZmFsc2UgPyAiIiA6IGxvYWRTZXR0aW5ncy50ZXh0ICk7CgoJCQkvLyBwcmVwYXJlIHRoZSBkb20KCQkJJGh0bWwuYWRkQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJdGV4dFZpc2libGUgPSBsb2FkU2V0dGluZ3MudGV4dFZpc2libGU7CgoJCQkvLyBhZGQgdGhlIHByb3BlciBjc3MgZ2l2ZW4gdGhlIG9wdGlvbnMgKHRoZW1lLCB0ZXh0LCBldGMpCgkJCS8vIEZvcmNlIHRleHQgdmlzaWJpbGl0eSBpZiB0aGUgc2Vjb25kIGFyZ3VtZW50IHdhcyBzdXBwbGllZCwgb3IKCQkJLy8gaWYgdGhlIHRleHQgd2FzIGV4cGxpY2l0bHkgc2V0IGluIHRoZSBvYmplY3QgYXJncwoJCQl0aGlzLmVsZW1lbnQuYXR0cigiY2xhc3MiLCBsb2FkZXJDbGFzcyArCgkJCQkiIHVpLWNvcm5lci1hbGwgdWktYm9keS0iICsgdGhlbWUgKwoJCQkJIiB1aS1sb2FkZXItIiArICggdGV4dFZpc2libGUgfHwgbXNnVGV4dCB8fCB0aGVtZS50ZXh0ID8gInZlcmJvc2UiIDogImRlZmF1bHQiICkgKwoJCQkJKCBsb2FkU2V0dGluZ3MudGV4dG9ubHkgfHwgdGV4dG9ubHkgPyAiIHVpLWxvYWRlci10ZXh0b25seSIgOiAiIiApICk7CgoJCQkvLyBUT0RPIHZlcmlmeSB0aGF0IGpxdWVyeS5mbi5odG1sIGlzIG9rIHRvIHVzZSBpbiBib3RoIGNhc2VzIGhlcmUKCQkJLy8gICAgICB0aGlzIG1pZ2h0IGJlIG92ZXJseSBkZWZlbnNpdmUgaW4gcHJldmVudGluZyB1bmtub3dpbmcgeHNzCgkJCS8vIGlmIHRoZSBodG1sIGF0dHJpYnV0ZSBpcyBkZWZpbmVkIG9uIHRoZSBsb2FkaW5nIHNldHRpbmdzLCB1c2UgdGhhdAoJCQkvLyBvdGhlcndpc2UgdXNlIHRoZSBmYWxsYmFja3MgZnJvbSBhYm92ZQoJCQlpZiAoIGxvYWRTZXR0aW5ncy5odG1sICkgewoJCQkJdGhpcy5lbGVtZW50Lmh0bWwoIGxvYWRTZXR0aW5ncy5odG1sICk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggImgxIiApLnRleHQoIG1lc3NhZ2UgKTsKCQkJfQoKCQkJLy8gYXR0YWNoIHRoZSBsb2FkZXIgdG8gdGhlIERPTQoJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCS8vIGNoZWNrIHRoYXQgdGhlIGxvYWRlciBpcyB2aXNpYmxlCgkJCXRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbigpOwoKCQkJLy8gb24gc2Nyb2xsIGNoZWNrIHRoZSBsb2FkZXIgcG9zaXRpb24KCQkJdGhpcy53aW5kb3cuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiwgdGhpcyApICk7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oKSB7CgkJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLnRleHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJfQoKCQkJJC5tb2JpbGUud2luZG93LnVuYmluZCggInNjcm9sbCIsIHRoaXMuZmFrZUZpeExvYWRlciApOwoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICk7CgkJfQoJfSk7Cgp9KShqUXVlcnksIHRoaXMpOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8qISBtYXRjaE1lZGlhKCkgcG9seWZpbGwgLSBUZXN0IGEgQ1NTIG1lZGlhIHR5cGUvcXVlcnkgaW4gSlMuIEF1dGhvcnMgJiBjb3B5cmlnaHQgKGMpIDIwMTI6IFNjb3R0IEplaGwsIFBhdWwgSXJpc2gsIE5pY2hvbGFzIFpha2FzLiBEdWFsIE1JVC9CU0QgbGljZW5zZSAqLwoJd2luZG93Lm1hdGNoTWVkaWEgPSB3aW5kb3cubWF0Y2hNZWRpYSB8fCAoZnVuY3Rpb24oIGRvYywgdW5kZWZpbmVkICkgewoKCQl2YXIgYm9vbCwKCQkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCgkJCXJlZk5vZGUgPSBkb2NFbGVtLmZpcnN0RWxlbWVudENoaWxkIHx8IGRvY0VsZW0uZmlyc3RDaGlsZCwKCQkJLy8gZmFrZUJvZHkgcmVxdWlyZWQgZm9yIDxGRjQgd2hlbiBleGVjdXRlZCBpbiA8aGVhZD4KCQkJZmFrZUJvZHkgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvZHkiICksCgkJCWRpdiA9IGRvYy5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQlkaXYuaWQgPSAibXEtdGVzdC0xIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTEwMGVtIjsKCQlmYWtlQm9keS5zdHlsZS5iYWNrZ3JvdW5kID0gIm5vbmUiOwoJCWZha2VCb2R5LmFwcGVuZENoaWxkKGRpdik7CgoJCXJldHVybiBmdW5jdGlvbihxKXsKCgkJCWRpdi5pbm5lckhUTUwgPSAiJnNoeTs8c3R5bGUgbWVkaWE9XCIiICsgcSArICJcIj4gI21xLXRlc3QtMSB7IHdpZHRoOiA0MnB4OyB9PC9zdHlsZT4iOwoKCQkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGZha2VCb2R5LCByZWZOb2RlICk7CgkJCWJvb2wgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQyOwoJCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBmYWtlQm9keSApOwoKCQkJcmV0dXJuIHsKCQkJCW1hdGNoZXM6IGJvb2wsCgkJCQltZWRpYTogcQoJCQl9OwoKCQl9OwoKCX0oIGRvY3VtZW50ICkpOwoKCS8vICQubW9iaWxlLm1lZGlhIHVzZXMgbWF0Y2hNZWRpYSB0byByZXR1cm4gYSBib29sZWFuLgoJJC5tb2JpbGUubWVkaWEgPSBmdW5jdGlvbiggcSApIHsKCQlyZXR1cm4gd2luZG93Lm1hdGNoTWVkaWEoIHEgKS5tYXRjaGVzOwoJfTsKCn0pKGpRdWVyeSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZS5zdXBwb3J0ID0gJC5tb2JpbGUuc3VwcG9ydCB8fCB7fTsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCBzdXBwb3J0ICk7CgkJJC5leHRlbmQoICQubW9iaWxlLnN1cHBvcnQsIHN1cHBvcnQgKTsKCX0oIGpRdWVyeSApKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkJCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93CgkJfSk7Cgl9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKSwKCQl2OwoKCWZvciAoIHYgaW4gcHJvcHMgKSB7CgkJaWYgKCBmYkNTU1sgcHJvcHNbIHYgXSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KfQoKdmFyIGZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5wcmVwZW5kVG8oICJodG1sIiApLAoJZmJDU1MgPSBmYWtlQm9keVsgMCBdLnN0eWxlLAoJdmVuZG9ycyA9IFsgIldlYmtpdCIsICJNb3oiLCAiTyIgXSwKCXdlYm9zID0gInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93LCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBzY3JvbGxUb3AKCW9wZXJhbWluaSA9IHdpbmRvdy5vcGVyYW1pbmkgJiYgKHt9KS50b1N0cmluZy5jYWxsKCB3aW5kb3cub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iLAoJYmIgPSB3aW5kb3cuYmxhY2tiZXJyeSAmJiAhcHJvcEV4aXN0cyggIi13ZWJraXQtdHJhbnNmb3JtIiApLCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBib3ggc2hhZG93LCBhcyBpdCdzIGZpbGxlZCBvcGFxdWUgb24gQkIgNSBhbmQgbG93ZXIKCW5va2lhTFRFN18zOwoKLy8gaW5saW5lIFNWRyBzdXBwb3J0IHRlc3QKZnVuY3Rpb24gaW5saW5lU1ZHKCkgewoJLy8gVGhhbmtzIE1vZGVybml6ciAmIEVyaWsgRGFobHN0cm9tCgl2YXIgdyA9IHdpbmRvdywKCQlzdmcgPSAhIXcuZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TICYmICEhdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIsICJzdmciICkuY3JlYXRlU1ZHUmVjdCAmJiAhKCB3Lm9wZXJhICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkNocm9tZSIgKSA9PT0gLTEgKSwKCQlzdXBwb3J0ID0gZnVuY3Rpb24oIGRhdGEgKSB7CgkJCWlmICggISggZGF0YSAmJiBzdmcgKSApIHsKCQkJCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbm9zdmciICk7CgkJCX0KCQl9LAoJCWltZyA9IG5ldyB3LkltYWdlKCk7CgoJaW1nLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKCQlzdXBwb3J0KCBmYWxzZSApOwoJfTsKCWltZy5vbmxvYWQgPSBmdW5jdGlvbigpIHsKCQlzdXBwb3J0KCBpbWcud2lkdGggPT09IDEgJiYgaW1nLmhlaWdodCA9PT0gMSApOwoJfTsKCWltZy5zcmMgPSAiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUFBQUFBQVAvLy95d0FBQUFBQVFBQkFBQUNBVXdBT3c9PSI7Cn0KCmZ1bmN0aW9uIHRyYW5zZm9ybTNkVGVzdCgpIHsKCXZhciBtcVByb3AgPSAidHJhbnNmb3JtLTNkIiwKCQkvLyBCZWNhdXNlIHRoZSBgdHJhbnNsYXRlM2RgIHRlc3QgYmVsb3cgdGhyb3dzIGZhbHNlIHBvc2l0aXZlcyBpbiBBbmRyb2lkOgoJCXJldCA9ICQubW9iaWxlLm1lZGlhKCAiKC0iICsgdmVuZG9ycy5qb2luKCAiLSIgKyBtcVByb3AgKyAiKSwoLSIgKSArICItIiArIG1xUHJvcCArICIpLCgiICsgbXFQcm9wICsgIikiICksCgkJZWwsIHRyYW5zZm9ybXMsIHQ7CgoJaWYgKCByZXQgKSB7CgkJcmV0dXJuICEhcmV0OwoJfQoKCWVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCXRyYW5zZm9ybXMgPSB7CgkJLy8gV2XigJlyZSBvbWl0dGluZyBPcGVyYSBmb3IgdGhlIHRpbWUgYmVpbmc7IE1TIHVzZXMgdW5wcmVmaXhlZC4KCQkiTW96VHJhbnNmb3JtIjogIi1tb3otdHJhbnNmb3JtIiwKCQkidHJhbnNmb3JtIjogInRyYW5zZm9ybSIKCX07CgoJZmFrZUJvZHkuYXBwZW5kKCBlbCApOwoKCWZvciAoIHQgaW4gdHJhbnNmb3JtcyApIHsKCQlpZiAoIGVsLnN0eWxlWyB0IF0gIT09IHVuZGVmaW5lZCApIHsKCQkJZWwuc3R5bGVbIHQgXSA9ICJ0cmFuc2xhdGUzZCggMTAwcHgsIDFweCwgMXB4ICkiOwoJCQlyZXQgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZWwgKS5nZXRQcm9wZXJ0eVZhbHVlKCB0cmFuc2Zvcm1zWyB0IF0gKTsKCQl9Cgl9CglyZXR1cm4gKCAhIXJldCAmJiByZXQgIT09ICJub25lIiApOwp9CgovLyBUZXN0IGZvciBkeW5hbWljLXVwZGF0aW5nIGJhc2UgdGFnIHN1cHBvcnQgKCBhbGxvd3MgdXMgdG8gYXZvaWQgaHJlZixzcmMgYXR0ciByZXdyaXRpbmcgKQpmdW5jdGlvbiBiYXNlVGFnVGVzdCgpIHsKCXZhciBmYXV4QmFzZSA9IGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSArICJ1aS1kaXIvIiwKCQliYXNlID0gJCggImhlYWQgYmFzZSIgKSwKCQlmYXV4RWxlID0gbnVsbCwKCQlocmVmID0gIiIsCgkJbGluaywgcmViYXNlOwoKCWlmICggIWJhc2UubGVuZ3RoICkgewoJCWJhc2UgPSBmYXV4RWxlID0gJCggIjxiYXNlPiIsIHsgImhyZWYiOiBmYXV4QmFzZSB9KS5hcHBlbmRUbyggImhlYWQiICk7Cgl9IGVsc2UgewoJCWhyZWYgPSBiYXNlLmF0dHIoICJocmVmIiApOwoJfQoKCWxpbmsgPSAkKCAiPGEgaHJlZj0ndGVzdHVybCcgLz4iICkucHJlcGVuZFRvKCBmYWtlQm9keSApOwoJcmViYXNlID0gbGlua1sgMCBdLmhyZWY7CgliYXNlWyAwIF0uaHJlZiA9IGhyZWYgfHwgbG9jYXRpb24ucGF0aG5hbWU7CgoJaWYgKCBmYXV4RWxlICkgewoJCWZhdXhFbGUucmVtb3ZlKCk7Cgl9CglyZXR1cm4gcmViYXNlLmluZGV4T2YoIGZhdXhCYXNlICkgPT09IDA7Cn0KCi8vIFRoYW5rcyBNb2Rlcm5penIKZnVuY3Rpb24gY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSB7Cgl2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJ4IiApLAoJCWRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlnZXRDb21wdXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUsCgkJc3VwcG9ydHM7CgoJaWYgKCAhKCAicG9pbnRlckV2ZW50cyIgaW4gZWxlbWVudC5zdHlsZSApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAiYXV0byI7CgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAieCI7Cglkb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoIGVsZW1lbnQgKTsKCXN1cHBvcnRzID0gZ2V0Q29tcHV0ZWRTdHlsZSAmJgoJZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbWVudCwgIiIgKS5wb2ludGVyRXZlbnRzID09PSAiYXV0byI7Cglkb2N1bWVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoIGVsZW1lbnQgKTsKCXJldHVybiAhIXN1cHBvcnRzOwp9CgpmdW5jdGlvbiBib3VuZGluZ1JlY3QoKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCXJldHVybiB0eXBlb2YgZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gInVuZGVmaW5lZCI7Cn0KCi8vIG5vbi1VQS1iYXNlZCBJRSB2ZXJzaW9uIGNoZWNrIGJ5IEphbWVzIFBhZG9sc2V5LCBtb2RpZmllZCBieSBqZGFsdG9uIC0gZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzUyNzY4MwovLyBhbGxvd3MgZm9yIGluY2x1c2lvbiBvZiBJRSA2KywgaW5jbHVkaW5nIFdpbmRvd3MgTW9iaWxlIDcKJC5leHRlbmQoICQubW9iaWxlLCB7IGJyb3dzZXI6IHt9IH0gKTsKJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSA9IChmdW5jdGlvbigpIHsKCXZhciB2ID0gMywKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCWEgPSBkaXYuYWxsIHx8IFtdOwoKCWRvIHsKCQlkaXYuaW5uZXJIVE1MID0gIjwhLS1baWYgZ3QgSUUgIiArICggKyt2ICkgKyAiXT48YnI+PCFbZW5kaWZdLS0+IjsKCX0gd2hpbGUoIGFbMF0gKTsKCglyZXR1cm4gdiA+IDQgPyB2IDogIXY7Cn0pKCk7CgpmdW5jdGlvbiBmaXhlZFBvc2l0aW9uKCkgewoJdmFyIHcgPSB3aW5kb3csCgkJdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLAoJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJZmZtYXRjaCA9IHVhLm1hdGNoKCAvRmVubmVjXC8oWzAtOV0rKS8gKSwKCQlmZnZlcnNpb24gPSAhIWZmbWF0Y2ggJiYgZmZtYXRjaFsgMSBdLAoJCW9wZXJhbW1vYmlsZW1hdGNoID0gdWEubWF0Y2goIC9PcGVyYSBNb2JpXC8oWzAtOV0rKS8gKSwKCQlvbXZlcnNpb24gPSAhIW9wZXJhbW1vYmlsZW1hdGNoICYmIG9wZXJhbW1vYmlsZW1hdGNoWyAxIF07CgoJaWYgKAoJCS8vIGlPUyA0LjMgYW5kIG9sZGVyIDogUGxhdGZvcm0gaXMgaVBob25lL1BhZC9Ub3VjaCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzNCAoaW9zNSkKCQkoICggcGxhdGZvcm0uaW5kZXhPZiggImlQaG9uZSIgKSA+IC0xIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUGFkIiApID4gLTEgIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUG9kIiApID4gLTEgKSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkgfHwKCQkvLyBPcGVyYSBNaW5pCgkJKCB3Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHcub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iICkgfHwKCQkoIG9wZXJhbW1vYmlsZW1hdGNoICYmIG9tdmVyc2lvbiA8IDc0NTggKQl8fAoJCS8vQW5kcm9pZCBsdGUgMi4xOiBQbGF0Zm9ybSBpcyBBbmRyb2lkIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTMzIChBbmRyb2lkIDIuMikKCQkoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzMyApIHx8CgkJLy8gRmlyZWZveCBNb2JpbGUgYmVmb3JlIDYuMCAtCgkJKCBmZnZlcnNpb24gJiYgZmZ2ZXJzaW9uIDwgNiApIHx8CgkJLy8gV2ViT1MgbGVzcyB0aGFuIDMKCQkoICJwYWxtR2V0UmVzb3VyY2UiIGluIHdpbmRvdyAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkJfHwKCQkvLyBNZWVHbwoJCSggdWEuaW5kZXhPZiggIk1lZUdvIiApID4gLTEgJiYgdWEuaW5kZXhPZiggIk5va2lhQnJvd3Nlci84LjUuMCIgKSA+IC0xICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCXJldHVybiB0cnVlOwp9CgokLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkvLyBOb3RlLCBDaHJvbWUgZm9yIGlPUyBoYXMgYW4gZXh0cmVtZWx5IHF1aXJreSBpbXBsZW1lbnRhdGlvbiBvZiBwb3BzdGF0ZS4KCS8vIFdlJ3ZlIGNob3NlbiB0byB0YWtlIHRoZSBzaG9ydGVzdCBwYXRoIHRvIGEgYnVnIGZpeCBoZXJlIGZvciBpc3N1ZSAjNTQyNgoJLy8gU2VlIHRoZSBmb2xsb3dpbmcgbGluayBmb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlZ2V4IGNob3NlbgoJLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vY2hyb21lL21vYmlsZS9kb2NzL3VzZXItYWdlbnQjY2hyb21lX2Zvcl9pb3NfdXNlci1hZ2VudAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCS8vIFdoZW4gcnVubmluZyBpbnNpZGUgYSBGRiBpZnJhbWUsIGNhbGxpbmcgcmVwbGFjZVN0YXRlIGNhdXNlcyBhbiBlcnJvcgoJCSEoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJGaXJlZm94IiApID49IDAgJiYgd2luZG93LnRvcCAhPT0gd2luZG93ICkgJiYKCQkoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnNlYXJjaCgvQ3JpT1MvKSA9PT0gLTEgKSwKCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJYm94U2hhZG93OiAhIXByb3BFeGlzdHMoICJib3hTaGFkb3ciICkgJiYgIWJiLAoJZml4ZWRQb3NpdGlvbjogZml4ZWRQb3NpdGlvbigpLAoJc2Nyb2xsVG9wOiAoInBhZ2VYT2Zmc2V0IiBpbiB3aW5kb3cgfHwKCQkic2Nyb2xsVG9wIiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgfHwKCQkic2Nyb2xsVG9wIiBpbiBmYWtlQm9keVsgMCBdKSAmJiAhd2Vib3MgJiYgIW9wZXJhbWluaSwKCglkeW5hbWljQmFzZVRhZzogYmFzZVRhZ1Rlc3QoKSwKCWNzc1BvaW50ZXJFdmVudHM6IGNzc1BvaW50ZXJFdmVudHNUZXN0KCksCglib3VuZGluZ1JlY3Q6IGJvdW5kaW5nUmVjdCgpLAoJaW5saW5lU1ZHOiBpbmxpbmVTVkcKfSk7CgpmYWtlQm9keS5yZW1vdmUoKTsKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKbm9raWFMVEU3XzMgPSAoZnVuY3Rpb24oKSB7CgoJdmFyIHVhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7CgoJLy9UaGUgZm9sbG93aW5nIGlzIGFuIGF0dGVtcHQgdG8gbWF0Y2ggTm9raWEgYnJvd3NlcnMgdGhhdCBhcmUgcnVubmluZyBTeW1iaWFuL3M2MCwgd2l0aCB3ZWJraXQsIHZlcnNpb24gNy4zIG9yIG9sZGVyCglyZXR1cm4gdWEuaW5kZXhPZiggIk5va2lhIiApID4gLTEgJiYKCQkJKCB1YS5pbmRleE9mKCAiU3ltYmlhbi8zIiApID4gLTEgfHwgdWEuaW5kZXhPZiggIlNlcmllczYwLzUiICkgPiAtMSApICYmCgkJCXVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICYmCgkJCXVhLm1hdGNoKCAvKEJyb3dzZXJOR3xOb2tpYUJyb3dzZXIpXC83XC5bMC0zXS8gKTsKfSkoKTsKCi8vIFN1cHBvcnQgY29uZGl0aW9ucyB0aGF0IG11c3QgYmUgbWV0IGluIG9yZGVyIHRvIHByb2NlZWQKLy8gZGVmYXVsdCBlbmhhbmNlZCBxdWFsaWZpY2F0aW9ucyBhcmUgbWVkaWEgcXVlcnkgc3VwcG9ydCBPUiBJRSA3KwoKJC5tb2JpbGUuZ3JhZGVBID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gKCAoICQuc3VwcG9ydC5tZWRpYXF1ZXJ5ICYmICQuc3VwcG9ydC5jc3NQc2V1ZG9FbGVtZW50ICkgfHwgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFID49IDggKSAmJiAoICQuc3VwcG9ydC5ib3VuZGluZ1JlY3QgfHwgJC5mbi5qcXVlcnkubWF0Y2goLzFcLlswLTcrXVwuWzAtOStdPy8pICE9PSBudWxsICk7Cn07CgokLm1vYmlsZS5hamF4QmxhY2tsaXN0ID0KCQkJLy8gQmxhY2tCZXJyeSBicm93c2VycywgcHJlLXdlYmtpdAoJCQl3aW5kb3cuYmxhY2tiZXJyeSAmJiAhd2luZG93LldlYktpdFBvaW50IHx8CgkJCS8vIE9wZXJhIE1pbmkKCQkJb3BlcmFtaW5pIHx8CgkJCS8vIFN5bWJpYW4gd2Via2l0cyBwcmUgNy4zCgkJCW5va2lhTFRFN18zOwoKLy8gTGFzdGx5LCB0aGlzIHdvcmthcm91bmQgaXMgdGhlIG9ubHkgd2F5IHdlJ3ZlIGZvdW5kIHNvIGZhciB0byBnZXQgcHJlIDcuMyBTeW1iaWFuIHdlYmtpdCBkZXZpY2VzCi8vIHRvIHJlbmRlciB0aGUgc3R5bGVzaGVldHMgd2hlbiB0aGV5J3JlIHJlZmVyZW5jZWQgYmVmb3JlIHRoaXMgc2NyaXB0LCBhcyB3ZSdkIHJlY29tbWVuZCBkb2luZy4KLy8gVGhpcyBzaW1wbHkgcmVhcHBlbmRzIHRoZSBDU1MgaW4gcGxhY2UsIHdoaWNoIGZvciBzb21lIHJlYXNvbiBtYWtlcyBpdCBhcHBseQppZiAoIG5va2lhTFRFN18zICkgewoJJChmdW5jdGlvbigpIHsKCQkkKCAiaGVhZCBsaW5rW3JlbD0nc3R5bGVzaGVldCddIiApLmF0dHIoICJyZWwiLCAiYWx0ZXJuYXRlIHN0eWxlc2hlZXQiICkuYXR0ciggInJlbCIsICJzdHlsZXNoZWV0IiApOwoJfSk7Cn0KCi8vIEZvciBydWxpbmcgb3V0IHNoYWRvd3MgdmlhIGNzcwppZiAoICEkLnN1cHBvcnQuYm94U2hhZG93ICkgewoJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1ub2JveHNoYWRvdyIgKTsKfQoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3csIHNlbGYsCgkJZHVtbXlGblRvSW5pdE5hdmlnYXRlID0gZnVuY3Rpb24oKSB7CgkJfTsKCgkkLmV2ZW50LnNwZWNpYWwuYmVmb3JlbmF2aWdhdGUgPSB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkkd2luLm9uKCAibmF2aWdhdGUiLCBkdW1teUZuVG9Jbml0TmF2aWdhdGUgKTsKCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCSR3aW4ub2ZmKCAibmF2aWdhdGUiLCBkdW1teUZuVG9Jbml0TmF2aWdhdGUgKTsKCQl9Cgl9OwoKCSQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZSA9IHNlbGYgPSB7CgkJYm91bmQ6IGZhbHNlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQlvcmlnaW5hbEV2ZW50TmFtZTogdW5kZWZpbmVkLAoKCQkvLyBJZiBwdXNoc3RhdGUgc3VwcG9ydCBpcyBwcmVzZW50IGFuZCBwdXNoIHN0YXRlIHN1cHBvcnQgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIHRydWUgb24gdGhlIG1vYmlsZSBuYW1lc3BhY2UuCgkJaXNQdXNoU3RhdGVFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQuc3VwcG9ydC5wdXNoU3RhdGUgJiYKCQkJCSQubW9iaWxlLnB1c2hTdGF0ZUVuYWJsZWQgPT09IHRydWUgJiYKCQkJCXRoaXMuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpOwoJCX0sCgoJCS8vICEhIGFzc3VtZXMgbW9iaWxlIG5hbWVzcGFjZSBpcyBwcmVzZW50CgkJaXNIYXNoQ2hhbmdlRW5hYmxlZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCA9PT0gdHJ1ZTsKCQl9LAoKCQkvLyBUT0RPIGEgbG90IG9mIGR1cGxpY2F0aW9uIGJldHdlZW4gcG9wc3RhdGUgYW5kIGhhc2hjaGFuZ2UKCQlwb3BzdGF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApLAoJCQkJc3RhdGUgPSBldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlIHx8IHt9OwoKCQkJYmVmb3JlTmF2aWdhdGUub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiAoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIGV2ZW50Lmhpc3RvcnlTdGF0ZSApIHsKCQkJCSQuZXh0ZW5kKHN0YXRlLCBldmVudC5oaXN0b3J5U3RhdGUpOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhlIG9yaWdpbmFsIGV2ZW50IGlzIHRyYWNrZWQgZm9yIHRoZSBlbmQKCQkJLy8gdXNlciB0byBpbnNwZWN0IGluY2FzZSB0aGV5IHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwKCQkJbmV3RXZlbnQub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoKCQkJLy8gTk9URSB3ZSBsZXQgdGhlIGN1cnJlbnQgc3RhY2sgdW53aW5kIGJlY2F1c2UgYW55IGFzc2lnbm1lbnQgdG8KCQkJLy8gICAgICBsb2NhdGlvbi5oYXNoIHdpbGwgc3RvcCB0aGUgd29ybGQgYW5kIHJ1biB0aGlzIGV2ZW50IGhhbmRsZXIuIEJ5CgkJCS8vICAgICAgZG9pbmcgdGhpcyB3ZSBjcmVhdGUgYSBzaW1pbGFyIGJlaGF2aW9yIHRvIGhhc2hjaGFuZ2Ugb24gaGFzaAoJCQkvLyAgICAgIGFzc2lnbm1lbnQKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCQlzdGF0ZTogc3RhdGUKCQkJCX0pOwoJCQl9LCAwKTsKCQl9LAoKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgLyosIGRhdGEgKi8gKSB7CgkJCXZhciBuZXdFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgkJCQliZWZvcmVOYXZpZ2F0ZSA9IG5ldyAkLkV2ZW50KCAiYmVmb3JlbmF2aWdhdGUiICk7CgoJCQliZWZvcmVOYXZpZ2F0ZS5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmICggYmVmb3JlTmF2aWdhdGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgb3JpZ2luYWwgZXZlbnQgaXMgdHJhY2tlZCBmb3IgdGhlIGVuZAoJCQkvLyB1c2VyIHRvIGluc3BlY3QgaW5jYXNlIHRoZXkgd2FudCB0byBkbyBzb21ldGhpbmcgc3BlY2lhbAoJCQluZXdFdmVudC5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgoJCQkvLyBUcmlnZ2VyIHRoZSBoYXNoY2hhbmdlIHdpdGggc3RhdGUgcHJvdmlkZWQgYnkgdGhlIHVzZXIKCQkJLy8gdGhhdCBhbHRlcmVkIHRoZSBoYXNoCgkJCSR3aW4udHJpZ2dlciggbmV3RXZlbnQsIHsKCQkJCS8vIFVzZXJzIHRoYXQgd2FudCB0byBmdWxseSBub3JtYWxpemUgdGhlIHR3byBldmVudHMKCQkJCS8vIHdpbGwgbmVlZCB0byBkbyBoaXN0b3J5IG1hbmFnZW1lbnQgZG93biB0aGUgc3RhY2sgYW5kCgkJCQkvLyBhZGQgdGhlIHN0YXRlIHRvIHRoZSBldmVudCBiZWZvcmUgdGhpcyBiaW5kaW5nIGlzIGZpcmVkCgkJCQkvLyBUT0RPIGNvbnNpZGVyIGFsbG93aW5nIGZvciB0aGUgZXhwbGljaXQgYWRkaXRpb24gb2YgY2FsbGJhY2tzCgkJCQkvLyAgICAgIHRvIGJlIGZpcmVkIGJlZm9yZSB0aGlzIHZhbHVlIGlzIHNldCB0byBhdm9pZCBldmVudCB0aW1pbmcgaXNzdWVzCgkJCQlzdGF0ZTogZXZlbnQuaGFzaGNoYW5nZVN0YXRlIHx8IHt9CgkJCX0pOwoJCX0sCgoJCS8vIFRPRE8gV2UgcmVhbGx5IG9ubHkgd2FudCB0byBzZXQgdGhpcyB1cCBvbmNlCgkJLy8gICAgICBidXQgSSdtIG5vdCBjbGVhciBpZiB0aGVyZSdzIGEgYmV0ZXIgd2F5IHRvIGFjaGlldmUKCQkvLyAgICAgIHRoaXMgd2l0aCB0aGUgalF1ZXJ5IHNwZWNpYWwgZXZlbnQgc3RydWN0dXJlCgkJc2V0dXA6IGZ1bmN0aW9uKCAvKiBkYXRhLCBuYW1lc3BhY2VzICovICkgewoJCQlpZiAoIHNlbGYuYm91bmQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXNlbGYuYm91bmQgPSB0cnVlOwoKCQkJaWYgKCBzZWxmLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJwb3BzdGF0ZSI7CgkJCQkkd2luLmJpbmQoICJwb3BzdGF0ZS5uYXZpZ2F0ZSIsIHNlbGYucG9wc3RhdGUgKTsKCQkJfSBlbHNlIGlmICggc2VsZi5pc0hhc2hDaGFuZ2VFbmFibGVkKCkgKSB7CgkJCQlzZWxmLm9yaWdpbmFsRXZlbnROYW1lID0gImhhc2hjaGFuZ2UiOwoJCQkJJHdpbi5iaW5kKCAiaGFzaGNoYW5nZS5uYXZpZ2F0ZSIsIHNlbGYuaGFzaGNoYW5nZSApOwoJCQl9CgkJfQoJfTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgcGF0aCwgJGJhc2UsIGRpYWxvZ0hhc2hLZXkgPSAiJnVpLXN0YXRlPWRpYWxvZyI7CgoJCSQubW9iaWxlLnBhdGggPSBwYXRoID0gewoJCQl1aVN0YXRlS2V5OiAiJnVpLXN0YXRlIiwKCgkJCS8vIFRoaXMgc2NhcnkgbG9va2luZyByZWd1bGFyIGV4cHJlc3Npb24gcGFyc2VzIGFuIGFic29sdXRlIFVSTCBvciBpdHMgcmVsYXRpdmUKCQkJLy8gdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGFuZCBoYXNoKSwgaW50byB0aGUgdmFyaW91cwoJCQkvLyBjb21wb25lbnRzIChwcm90b2NvbCwgaG9zdCwgcGF0aCwgcXVlcnksIGZyYWdtZW50LCBldGMgdGhhdCBtYWtlIHVwIHRoZQoJCQkvLyBVUkwgYXMgd2VsbCBhcyBzb21lIG90aGVyIGNvbW1vbmx5IHVzZWQgc3ViLXBhcnRzLiBXaGVuIHVzZWQgd2l0aCBSZWdFeHAuZXhlYygpCgkJCS8vIG9yIFN0cmluZy5tYXRjaCwgaXQgcGFyc2VzIHRoZSBVUkwgaW50byBhIHJlc3VsdHMgYXJyYXkgdGhhdCBsb29rcyBsaWtlIHRoaXM6CgkJCS8vCgkJCS8vICAgICBbMF06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZCNtc2ctY29udGVudAoJCQkvLyAgICAgWzFdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgIFsyXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94CgkJCS8vICAgICBbM106IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs0XTogaHR0cDoKCQkJLy8gICAgIFs1XTogLy8KCQkJLy8gICAgIFs2XTogamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbN106IGpibGFzOnBhc3N3b3JkCgkJCS8vICAgICBbOF06IGpibGFzCgkJCS8vICAgICBbOV06IHBhc3N3b3JkCgkJCS8vICAgIFsxMF06IG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICBbMTFdOiBteWNvbXBhbnkuY29tCgkJCS8vICAgIFsxMl06IDgwODAKCQkJLy8gICAgWzEzXTogL21haWwvaW5ib3gKCQkJLy8gICAgWzE0XTogL21haWwvCgkJCS8vICAgIFsxNV06IGluYm94CgkJCS8vICAgIFsxNl06ID9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICBbMTddOiAjbXNnLWNvbnRlbnQKCQkJLy8KCQkJdXJsUGFyc2VSRTogL15ccyooKCgoW146XC8jXD9dKzopPyg/OihcL1wvKSgoPzooKFteOkBcLyNcP10rKSg/Olw6KFteOkBcLyNcP10rKSk/KUApPygoW146XC8jXD9cXVxbXSt8XFtbXlwvXF1AIz9dK1xdKSg/Olw6KFswLTldKykpPykpPyk/KT8oKFwvPyg/OlteXC9cPyNdK1wvKykqKShbXlw/I10qKSkpPyhcP1teI10rKT8pKCMuKik/LywKCgkJCS8vIEFic3RyYWN0aW9uIHRvIGFkZHJlc3MgeHNzIChJc3N1ZSAjNDc4NykgYnkgcmVtb3ZpbmcgdGhlIGF1dGhvcml0eSBpbgoJCQkvLyBicm93c2VycyB0aGF0IGF1dG8tZGVjb2RlIGl0LiBBbGwgcmVmZXJlbmNlcyB0byBsb2NhdGlvbi5ocmVmIHNob3VsZCBiZQoJCQkvLyByZXBsYWNlZCB3aXRoIGEgY2FsbCB0byB0aGlzIG1ldGhvZCBzbyB0aGF0IGl0IGNhbiBiZSBkZWFsdCB3aXRoIHByb3Blcmx5IGhlcmUKCQkJZ2V0TG9jYXRpb246IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgcGFyc2VkVXJsID0gdGhpcy5wYXJzZVVybCggdXJsIHx8IGxvY2F0aW9uLmhyZWYgKSwKCQkJCQl1cmkgPSB1cmwgPyBwYXJzZWRVcmwgOiBsb2NhdGlvbiwKCgkJCQkJLy8gTWFrZSBzdXJlIHRvIHBhcnNlIHRoZSB1cmwgb3IgdGhlIGxvY2F0aW9uIG9iamVjdCBmb3IgdGhlIGhhc2ggYmVjYXVzZSB1c2luZwoJCQkJCS8vIGxvY2F0aW9uLmhhc2ggaXMgYXV0b2RlY29kZWQgaW4gZmlyZWZveCwgdGhlIHJlc3Qgb2YgdGhlIHVybCBzaG91bGQgYmUgZnJvbQoJCQkJCS8vIHRoZSBvYmplY3QgKGxvY2F0aW9uIHVubGVzcyB3ZSdyZSB0ZXN0aW5nKSB0byBhdm9pZCB0aGUgaW5jbHVzaW9uIG9mIHRoZQoJCQkJCS8vIGF1dGhvcml0eQoJCQkJCWhhc2ggPSBwYXJzZWRVcmwuaGFzaDsKCgkJCQkvLyBtaW1pYyB0aGUgYnJvd3NlciB3aXRoIGFuIGVtcHR5IHN0cmluZyB3aGVuIHRoZSBoYXNoIGlzIGVtcHR5CgkJCQloYXNoID0gaGFzaCA9PT0gIiMiID8gIiIgOiBoYXNoOwoKCQkJCXJldHVybiB1cmkucHJvdG9jb2wgKwoJCQkJCXBhcnNlZFVybC5kb3VibGVTbGFzaCArCgkJCQkJdXJpLmhvc3QgKwoKCQkJCQkvLyBUaGUgcGF0aG5hbWUgbXVzdCBzdGFydCB3aXRoIGEgc2xhc2ggaWYgdGhlcmUncyBhIHByb3RvY29sLCBiZWNhdXNlIHlvdQoJCQkJCS8vIGNhbid0IGhhdmUgYSBwcm90b2NvbCBmb2xsb3dlZCBieSBhIHJlbGF0aXZlIHBhdGguIEFsc28sIGl0J3MgaW1wb3NzaWJsZSB0bwoJCQkJCS8vIGNhbGN1bGF0ZSBhYnNvbHV0ZSBVUkxzIGZyb20gcmVsYXRpdmUgb25lcyBpZiB0aGUgYWJzb2x1dGUgb25lIGRvZXNuJ3QgaGF2ZQoJCQkJCS8vIGEgbGVhZGluZyAiLyIuCgkJCQkJKCAoIHVyaS5wcm90b2NvbCAhPT0gIiIgJiYgdXJpLnBhdGhuYW1lLnN1YnN0cmluZyggMCwgMSApICE9PSAiLyIgKSA/CgkJCQkJCSIvIiA6ICIiICkgKwoJCQkJCXVyaS5wYXRobmFtZSArCgkJCQkJdXJpLnNlYXJjaCArCgkJCQkJaGFzaDsKCQkJfSwKCgkJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQkJZ2V0RG9jdW1lbnRVcmw6IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQkJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgcGF0aC5kb2N1bWVudFVybCApIDogcGF0aC5kb2N1bWVudFVybC5ocmVmOwoJCQl9LAoKCQkJcGFyc2VMb2NhdGlvbjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5wYXJzZVVybCggdGhpcy5nZXRMb2NhdGlvbigpICk7CgkJCX0sCgoJCQkvL1BhcnNlIGEgVVJMIGludG8gYSBzdHJ1Y3R1cmUgdGhhdCBhbGxvd3MgZWFzeSBhY2Nlc3MgdG8KCQkJLy9hbGwgb2YgdGhlIFVSTCBjb21wb25lbnRzIGJ5IG5hbWUuCgkJCXBhcnNlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gSWYgd2UncmUgcGFzc2VkIGFuIG9iamVjdCwgd2UnbGwgYXNzdW1lIHRoYXQgaXQgaXMKCQkJCS8vIGEgcGFyc2VkIHVybCBvYmplY3QgYW5kIGp1c3QgcmV0dXJuIGl0IGJhY2sgdG8gdGhlIGNhbGxlci4KCQkJCWlmICggJC50eXBlKCB1cmwgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQkJcmV0dXJuIHVybDsKCQkJCX0KCgkJCQl2YXIgbWF0Y2hlcyA9IHBhdGgudXJsUGFyc2VSRS5leGVjKCB1cmwgfHwgIiIgKSB8fCBbXTsKCgkJCQkJLy8gQ3JlYXRlIGFuIG9iamVjdCB0aGF0IGFsbG93cyB0aGUgY2FsbGVyIHRvIGFjY2VzcyB0aGUgc3ViLW1hdGNoZXMKCQkJCQkvLyBieSBuYW1lLiBOb3RlIHRoYXQgSUUgcmV0dXJucyBhbiBlbXB0eSBzdHJpbmcgaW5zdGVhZCBvZiB1bmRlZmluZWQsCgkJCQkJLy8gbGlrZSBhbGwgb3RoZXIgYnJvd3NlcnMgZG8sIHNvIHdlIG5vcm1hbGl6ZSBldmVyeXRoaW5nIHNvIGl0cyBjb25zaXN0ZW50CgkJCQkJLy8gbm8gbWF0dGVyIHdoYXQgYnJvd3NlciB3ZSdyZSBydW5uaW5nIG9uLgoJCQkJCXJldHVybiB7CgkJCQkJCWhyZWY6ICAgICAgICAgbWF0Y2hlc1sgIDAgXSB8fCAiIiwKCQkJCQkJaHJlZk5vSGFzaDogICBtYXRjaGVzWyAgMSBdIHx8ICIiLAoJCQkJCQlocmVmTm9TZWFyY2g6IG1hdGNoZXNbICAyIF0gfHwgIiIsCgkJCQkJCWRvbWFpbjogICAgICAgbWF0Y2hlc1sgIDMgXSB8fCAiIiwKCQkJCQkJcHJvdG9jb2w6ICAgICBtYXRjaGVzWyAgNCBdIHx8ICIiLAoJCQkJCQlkb3VibGVTbGFzaDogIG1hdGNoZXNbICA1IF0gfHwgIiIsCgkJCQkJCWF1dGhvcml0eTogICAgbWF0Y2hlc1sgIDYgXSB8fCAiIiwKCQkJCQkJdXNlcm5hbWU6ICAgICBtYXRjaGVzWyAgOCBdIHx8ICIiLAoJCQkJCQlwYXNzd29yZDogICAgIG1hdGNoZXNbICA5IF0gfHwgIiIsCgkJCQkJCWhvc3Q6ICAgICAgICAgbWF0Y2hlc1sgMTAgXSB8fCAiIiwKCQkJCQkJaG9zdG5hbWU6ICAgICBtYXRjaGVzWyAxMSBdIHx8ICIiLAoJCQkJCQlwb3J0OiAgICAgICAgIG1hdGNoZXNbIDEyIF0gfHwgIiIsCgkJCQkJCXBhdGhuYW1lOiAgICAgbWF0Y2hlc1sgMTMgXSB8fCAiIiwKCQkJCQkJZGlyZWN0b3J5OiAgICBtYXRjaGVzWyAxNCBdIHx8ICIiLAoJCQkJCQlmaWxlbmFtZTogICAgIG1hdGNoZXNbIDE1IF0gfHwgIiIsCgkJCQkJCXNlYXJjaDogICAgICAgbWF0Y2hlc1sgMTYgXSB8fCAiIiwKCQkJCQkJaGFzaDogICAgICAgICBtYXRjaGVzWyAxNyBdIHx8ICIiCgkJCQkJfTsKCQkJfSwKCgkJCS8vVHVybiByZWxQYXRoIGludG8gYW4gYXNib2x1dGUgcGF0aC4gYWJzUGF0aCBpcwoJCQkvL2FuIG9wdGlvbmFsIGFic29sdXRlIHBhdGggd2hpY2ggZGVzY3JpYmVzIHdoYXQKCQkJLy9yZWxQYXRoIGlzIHJlbGF0aXZlIHRvLgoJCQltYWtlUGF0aEFic29sdXRlOiBmdW5jdGlvbiggcmVsUGF0aCwgYWJzUGF0aCApIHsKCQkJCXZhciBhYnNTdGFjaywKCQkJCQlyZWxTdGFjaywKCQkJCQlpLCBkOwoKCQkJCWlmICggcmVsUGF0aCAmJiByZWxQYXRoLmNoYXJBdCggMCApID09PSAiLyIgKSB7CgkJCQkJcmV0dXJuIHJlbFBhdGg7CgkJCQl9CgoJCQkJcmVsUGF0aCA9IHJlbFBhdGggfHwgIiI7CgkJCQlhYnNQYXRoID0gYWJzUGF0aCA/IGFic1BhdGgucmVwbGFjZSggL15cL3woXC9bXlwvXSp8W15cL10rKSQvZywgIiIgKSA6ICIiOwoKCQkJCWFic1N0YWNrID0gYWJzUGF0aCA/IGFic1BhdGguc3BsaXQoICIvIiApIDogW107CgkJCQlyZWxTdGFjayA9IHJlbFBhdGguc3BsaXQoICIvIiApOwoKCQkJCWZvciAoIGkgPSAwOyBpIDwgcmVsU3RhY2subGVuZ3RoOyBpKysgKSB7CgkJCQkJZCA9IHJlbFN0YWNrWyBpIF07CgkJCQkJc3dpdGNoICggZCApIHsKCQkJCQkJY2FzZSAiLiI6CgkJCQkJCQlicmVhazsKCQkJCQkJY2FzZSAiLi4iOgoJCQkJCQkJaWYgKCBhYnNTdGFjay5sZW5ndGggKSB7CgkJCQkJCQkJYWJzU3RhY2sucG9wKCk7CgkJCQkJCQl9CgkJCQkJCQlicmVhazsKCQkJCQkJZGVmYXVsdDoKCQkJCQkJCWFic1N0YWNrLnB1c2goIGQgKTsKCQkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiAiLyIgKyBhYnNTdGFjay5qb2luKCAiLyIgKTsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGlmIGJvdGggdXJscyBoYXZlIHRoZSBzYW1lIGRvbWFpbi4KCQkJaXNTYW1lRG9tYWluOiBmdW5jdGlvbiggYWJzVXJsMSwgYWJzVXJsMiApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCBhYnNVcmwxICkuZG9tYWluLnRvTG93ZXJDYXNlKCkgPT09CgkJCQkJcGF0aC5wYXJzZVVybCggYWJzVXJsMiApLmRvbWFpbi50b0xvd2VyQ2FzZSgpOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFueSByZWxhdGl2ZSB2YXJpYW50LgoJCQlpc1JlbGF0aXZlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gQWxsIHJlbGF0aXZlIFVybCB2YXJpYW50cyBoYXZlIG9uZSB0aGluZyBpbiBjb21tb24sIG5vIHByb3RvY29sLgoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIHVybCApLnByb3RvY29sID09PSAiIjsKCQkJfSwKCgkJCS8vUmV0dXJucyB0cnVlIGZvciBhbiBhYnNvbHV0ZSB1cmwuCgkJCWlzQWJzb2x1dGVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgIT09ICIiOwoJCQl9LAoKCQkJLy9UdXJuIHRoZSBzcGVjaWZpZWQgcmVhbHRpdmUgVVJMIGludG8gYW4gYWJzb2x1dGUgb25lLiBUaGlzIGZ1bmN0aW9uCgkJCS8vY2FuIGhhbmRsZSBhbGwgcmVsYXRpdmUgdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGZyYWdtZW50KS4KCQkJbWFrZVVybEFic29sdXRlOiBmdW5jdGlvbiggcmVsVXJsLCBhYnNVcmwgKSB7CgkJCQlpZiAoICFwYXRoLmlzUmVsYXRpdmVVcmwoIHJlbFVybCApICkgewoJCQkJCXJldHVybiByZWxVcmw7CgkJCQl9CgoJCQkJaWYgKCBhYnNVcmwgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlhYnNVcmwgPSB0aGlzLmRvY3VtZW50QmFzZTsKCQkJCX0KCgkJCQl2YXIgcmVsT2JqID0gcGF0aC5wYXJzZVVybCggcmVsVXJsICksCgkJCQkJYWJzT2JqID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICksCgkJCQkJcHJvdG9jb2wgPSByZWxPYmoucHJvdG9jb2wgfHwgYWJzT2JqLnByb3RvY29sLAoJCQkJCWRvdWJsZVNsYXNoID0gcmVsT2JqLnByb3RvY29sID8gcmVsT2JqLmRvdWJsZVNsYXNoIDogKCByZWxPYmouZG91YmxlU2xhc2ggfHwgYWJzT2JqLmRvdWJsZVNsYXNoICksCgkJCQkJYXV0aG9yaXR5ID0gcmVsT2JqLmF1dGhvcml0eSB8fCBhYnNPYmouYXV0aG9yaXR5LAoJCQkJCWhhc1BhdGggPSByZWxPYmoucGF0aG5hbWUgIT09ICIiLAoJCQkJCXBhdGhuYW1lID0gcGF0aC5tYWtlUGF0aEFic29sdXRlKCByZWxPYmoucGF0aG5hbWUgfHwgYWJzT2JqLmZpbGVuYW1lLCBhYnNPYmoucGF0aG5hbWUgKSwKCQkJCQlzZWFyY2ggPSByZWxPYmouc2VhcmNoIHx8ICggIWhhc1BhdGggJiYgYWJzT2JqLnNlYXJjaCApIHx8ICIiLAoJCQkJCWhhc2ggPSByZWxPYmouaGFzaDsKCgkJCQlyZXR1cm4gcHJvdG9jb2wgKyBkb3VibGVTbGFzaCArIGF1dGhvcml0eSArIHBhdGhuYW1lICsgc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCS8vQWRkIHNlYXJjaCAoYWthIHF1ZXJ5KSBwYXJhbXMgdG8gdGhlIHNwZWNpZmllZCB1cmwuCgkJCWFkZFNlYXJjaFBhcmFtczogZnVuY3Rpb24oIHVybCwgcGFyYW1zICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwID0gKCB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApID8gJC5wYXJhbSggcGFyYW1zICkgOiBwYXJhbXMsCgkJCQkJcyA9IHUuc2VhcmNoIHx8ICI/IjsKCQkJCXJldHVybiB1LmhyZWZOb1NlYXJjaCArIHMgKyAoIHMuY2hhckF0KCBzLmxlbmd0aCAtIDEgKSAhPT0gIj8iID8gIiYiIDogIiIgKSArIHAgKyAoIHUuaGFzaCB8fCAiIiApOwoJCQl9LAoKCQkJY29udmVydFVybFRvRGF0YVVybDogZnVuY3Rpb24oIGFic1VybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICk7CgkJCQlpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIHUgKSApIHsKCQkJCQkvLyBGb3IgZW1iZWRkZWQgcGFnZXMsIHJlbW92ZSB0aGUgZGlhbG9nIGhhc2gga2V5IGFzIGluIGdldEZpbGVQYXRoKCksCgkJCQkJLy8gYW5kIHJlbW92ZSBvdGhlcndpc2UgdGhlIERhdGEgVXJsIHdvbid0IG1hdGNoIHRoZSBpZCBvZiB0aGUgZW1iZWRkZWQgUGFnZS4KCQkJCQlyZXR1cm4gdS5oYXNoCgkJCQkJCS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdCgkJCQkJCS5yZXBsYWNlKCAvXiMvLCAiIiApCgkJCQkJCS5yZXBsYWNlKCAvXD8uKiQvLCAiIiApOwoJCQkJfSBlbHNlIGlmICggcGF0aC5pc1NhbWVEb21haW4oIHUsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSB7CgkJCQkJcmV0dXJuIHUuaHJlZk5vSGFzaC5yZXBsYWNlKCB0aGlzLmRvY3VtZW50QmFzZS5kb21haW4sICIiICkuc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJCX0KCgkJCQlyZXR1cm4gd2luZG93LmRlY29kZVVSSUNvbXBvbmVudChhYnNVcmwpOwoJCQl9LAoKCQkJLy9nZXQgcGF0aCBmcm9tIGN1cnJlbnQgaGFzaCwgb3IgZnJvbSBhIGZpbGUgcGF0aAoJCQlnZXQ6IGZ1bmN0aW9uKCBuZXdQYXRoICkgewoJCQkJaWYgKCBuZXdQYXRoID09PSB1bmRlZmluZWQgKSB7CgkJCQkJbmV3UGF0aCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgkJCQl9CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIG5ld1BhdGggKS5yZXBsYWNlKCAvW15cL10qXC5bXlwvKl0rJC8sICIiICk7CgkJCX0sCgoJCQkvL3NldCBsb2NhdGlvbiBoYXNoIHRvIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCWxvY2F0aW9uLmhhc2ggPSBwYXRoOwoJCQl9LAoKCQkJLy90ZXN0IGlmIGEgZ2l2ZW4gdXJsIChzdHJpbmcpIGlzIGEgcGF0aAoJCQkvL05PVEUgbWlnaHQgYmUgZXhjZXB0aW9uYWxseSBuYWl2ZQoJCQlpc1BhdGg6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXC8vICkudGVzdCggdXJsICk7CgkJCX0sCgoJCQkvL3JldHVybiBhIHVybCBwYXRoIHdpdGggdGhlIHdpbmRvdydzIGxvY2F0aW9uIHByb3RvY29sL2hvc3RuYW1lL3BhdGhuYW1lIHJlbW92ZWQKCQkJY2xlYW46IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKTsKCQkJfSwKCgkJCS8vanVzdCByZXR1cm4gdGhlIHVybCB3aXRob3V0IGFuIGluaXRpYWwgIwoJCQlzdHJpcEhhc2g6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9eIy8sICIiICk7CgkJCX0sCgoJCQlzdHJpcFF1ZXJ5UGFyYW1zOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuIHVybC5yZXBsYWNlKCAvXD8uKiQvLCAiIiApOwoJCQl9LAoKCQkJLy9yZW1vdmUgdGhlIHByZWNlZGluZyBoYXNoLCBhbnkgcXVlcnkgcGFyYW1zLCBhbmQgZGlhbG9nIG5vdGF0aW9ucwoJCQljbGVhbkhhc2g6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBoYXNoLnJlcGxhY2UoIC9cPy4qJC8sICIiICkucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApOwoJCQl9LAoKCQkJaXNIYXNoVmFsaWQ6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJcmV0dXJuICggL14jW14jXSskLyApLnRlc3QoIGhhc2ggKTsKCQkJfSwKCgkJCS8vY2hlY2sgd2hldGhlciBhIHVybCBpcyByZWZlcmVuY2luZyB0aGUgc2FtZSBkb21haW4sIG9yIGFuIGV4dGVybmFsIGRvbWFpbiBvciBkaWZmZXJlbnQgcHJvdG9jb2wKCQkJLy9jb3VsZCBiZSBtYWlsdG8sIGV0YwoJCQlpc0V4dGVybmFsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQlyZXR1cm4gISEoIHUucHJvdG9jb2wgJiYKCQkJCQkoIHUuZG9tYWluLnRvTG93ZXJDYXNlKCkgIT09IHRoaXMuZG9jdW1lbnRVcmwuZG9tYWluLnRvTG93ZXJDYXNlKCkgKSApOwoJCQl9LAoKCQkJaGFzUHJvdG9jb2w6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXig6P1x3KzopLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJaXNFbWJlZGRlZFBhZ2U6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoKCQkJCS8vaWYgdGhlIHBhdGggaXMgYWJzb2x1dGUsIHRoZW4gd2UgbmVlZCB0byBjb21wYXJlIHRoZSB1cmwgYWdhaW5zdAoJCQkJLy9ib3RoIHRoZSB0aGlzLmRvY3VtZW50VXJsIGFuZCB0aGUgZG9jdW1lbnRCYXNlLiBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMKCQkJCS8vaXMgdGhhdCBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gZXh0ZXJuYWwgZG9jdW1lbnRzIHdpbGwgcmVmZXIgdG8gdGhlCgkJCQkvL2FwcGxpY2F0aW9uIGRvY3VtZW50LCB3aGVyZWFzIGxpbmtzIGVtYmVkZGVkIHdpdGhpbiB0aGUgYXBwbGljYXRpb24KCQkJCS8vZG9jdW1lbnQgd2lsbCBiZSByZXNvbHZlZCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBiYXNlLgoJCQkJaWYgKCB1LnByb3RvY29sICE9PSAiIiApIHsKCQkJCQlyZXR1cm4gKCAhdGhpcy5pc1BhdGgodS5oYXNoKSAmJiB1Lmhhc2ggJiYgKCB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSApICk7CgkJCQl9CgkJCQlyZXR1cm4gKCAvXiMvICkudGVzdCggdS5ocmVmICk7CgkJCX0sCgoJCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIHJlc29sdXRpb25VcmwgKSB7CgkJCQl2YXIgaHJlZiwgY2xlYW5lZFVybCwgc2VhcmNoLCBzdGF0ZUluZGV4LCBkb2NVcmwsCgkJCQkJaXNQYXRoID0gdGhpcy5pc1BhdGgoIHVybCApLAoJCQkJCXVyaSA9IHRoaXMucGFyc2VVcmwoIHVybCApLAoJCQkJCXByZXNlcnZlZEhhc2ggPSB1cmkuaGFzaCwKCQkJCQl1aVN0YXRlID0gIiI7CgoJCQkJLy8gcHJvZHVjZSBhIHVybCBhZ2FpbnN0IHdoaWNoIHdlIGNhbiByZXNvbHZlIHRoZSBwcm92aWRlZCBwYXRoCgkJCQlpZiAoICFyZXNvbHV0aW9uVXJsICkgewoJCQkJCWlmICggaXNQYXRoICkgewoJCQkJCQlyZXNvbHV0aW9uVXJsID0gcGF0aC5nZXRMb2NhdGlvbigpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWRvY1VybCA9IHBhdGguZ2V0RG9jdW1lbnRVcmwoIHRydWUgKTsKCQkJCQkJaWYgKCBwYXRoLmlzUGF0aCggZG9jVXJsLmhhc2ggKSApIHsKCQkJCQkJCXJlc29sdXRpb25VcmwgPSBwYXRoLnNxdWFzaCggZG9jVXJsLmhyZWYgKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJlc29sdXRpb25VcmwgPSBkb2NVcmwuaHJlZjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQkvLyBJZiB0aGUgdXJsIGlzIGFueXRoaW5nIGJ1dCBhIHNpbXBsZSBzdHJpbmcsIHJlbW92ZSBhbnkgcHJlY2VkaW5nIGhhc2gKCQkJCS8vIGVnICNmb28vYmFyIC0+IGZvby9iYXIKCQkJCS8vICAgICNmb28gLT4gI2ZvbwoJCQkJY2xlYW5lZFVybCA9IGlzUGF0aCA/IHBhdGguc3RyaXBIYXNoKCB1cmwgKSA6IHVybDsKCgkJCQkvLyBJZiB0aGUgdXJsIGlzIGEgZnVsbCB1cmwgd2l0aCBhIGhhc2ggY2hlY2sgaWYgdGhlIHBhcnNlZCBoYXNoIGlzIGEgcGF0aAoJCQkJLy8gaWYgaXQgaXMsIHN0cmlwIHRoZSAjLCBhbmQgdXNlIGl0IG90aGVyd2lzZSBjb250aW51ZSB3aXRob3V0IGNoYW5nZQoJCQkJY2xlYW5lZFVybCA9IHBhdGguaXNQYXRoKCB1cmkuaGFzaCApID8gcGF0aC5zdHJpcEhhc2goIHVyaS5oYXNoICkgOiBjbGVhbmVkVXJsOwoKCQkJCS8vIFNwbGl0IHRoZSBVSSBTdGF0ZSBrZXlzIG9mZiB0aGUgaHJlZgoJCQkJc3RhdGVJbmRleCA9IGNsZWFuZWRVcmwuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICk7CgoJCQkJLy8gc3RvcmUgdGhlIHVpIHN0YXRlIGtleXMgZm9yIHVzZQoJCQkJaWYgKCBzdGF0ZUluZGV4ID4gLTEgKSB7CgkJCQkJdWlTdGF0ZSA9IGNsZWFuZWRVcmwuc2xpY2UoIHN0YXRlSW5kZXggKTsKCQkJCQljbGVhbmVkVXJsID0gY2xlYW5lZFVybC5zbGljZSggMCwgc3RhdGVJbmRleCApOwoJCQkJfQoKCQkJCS8vIG1ha2UgdGhlIGNsZWFuZWRVcmwgYWJzb2x1dGUgcmVsYXRpdmUgdG8gdGhlIHJlc29sdXRpb24gdXJsCgkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGNsZWFuZWRVcmwsIHJlc29sdXRpb25VcmwgKTsKCgkJCQkvLyBncmFiIHRoZSBzZWFyY2ggZnJvbSB0aGUgcmVzb2x2ZWQgdXJsIHNpbmNlIHBhcnNpbmcgZnJvbQoJCQkJLy8gdGhlIHBhc3NlZCB1cmwgbWF5IG5vdCB5aWVsZCB0aGUgY29ycmVjdCByZXN1bHQKCQkJCXNlYXJjaCA9IHRoaXMucGFyc2VVcmwoIGhyZWYgKS5zZWFyY2g7CgoJCQkJLy8gVE9ETyBhbGwgdGhpcyBjcmFwIGlzIHRlcnJpYmxlLCBjbGVhbiBpdCB1cAoJCQkJaWYgKCBpc1BhdGggKSB7CgkJCQkJLy8gcmVqZWN0IHRoZSBoYXNoIGlmIGl0J3MgYSBwYXRoIG9yIGl0J3MganVzdCBhIGRpYWxvZyBrZXkKCQkJCQlpZiAoIHBhdGguaXNQYXRoKCBwcmVzZXJ2ZWRIYXNoICkgfHwgcHJlc2VydmVkSGFzaC5yZXBsYWNlKCIjIiwgIiIpLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAwKSB7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIjsKCQkJCQl9CgoJCQkJCS8vIEFwcGVuZCB0aGUgVUkgU3RhdGUga2V5cyB3aGVyZSBpdCBleGlzdHMgYW5kIGl0J3MgYmVlbiByZW1vdmVkCgkJCQkJLy8gZnJvbSB0aGUgdXJsCgkJCQkJaWYgKCB1aVN0YXRlICYmIHByZXNlcnZlZEhhc2guaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IC0xKSB7CgkJCQkJCXByZXNlcnZlZEhhc2ggKz0gdWlTdGF0ZTsKCQkJCQl9CgoJCQkJCS8vIG1ha2Ugc3VyZSB0aGF0IHBvdW5kIGlzIG9uIHRoZSBmcm9udCBvZiB0aGUgaGFzaAoJCQkJCWlmICggcHJlc2VydmVkSGFzaC5pbmRleE9mKCAiIyIgKSA9PT0gLTEgJiYgcHJlc2VydmVkSGFzaCAhPT0gIiIgKSB7CgkJCQkJCXByZXNlcnZlZEhhc2ggPSAiIyIgKyBwcmVzZXJ2ZWRIYXNoOwoJCQkJCX0KCgkJCQkJLy8gcmVjb25zdHJ1Y3QgZWFjaCBvZiB0aGUgcGllY2VzIHdpdGggdGhlIG5ldyBzZWFyY2ggc3RyaW5nIGFuZCBoYXNoCgkJCQkJaHJlZiA9IHBhdGgucGFyc2VVcmwoIGhyZWYgKTsKCQkJCQlocmVmID0gaHJlZi5wcm90b2NvbCArIGhyZWYuZG91YmxlU2xhc2ggKyBocmVmLmhvc3QgKyBocmVmLnBhdGhuYW1lICsgc2VhcmNoICsKCQkJCQkJcHJlc2VydmVkSGFzaDsKCQkJCX0gZWxzZSB7CgkJCQkJaHJlZiArPSBocmVmLmluZGV4T2YoICIjIiApID4gLTEgPyB1aVN0YXRlIDogIiMiICsgdWlTdGF0ZTsKCQkJCX0KCgkJCQlyZXR1cm4gaHJlZjsKCQkJfSwKCgkJCWlzUHJlc2VydmFibGVIYXNoOiBmdW5jdGlvbiggaGFzaCApIHsKCQkJCXJldHVybiBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMDsKCQkJfSwKCgkJCS8vIEVzY2FwZSB3ZWlyZCBjaGFyYWN0ZXJzIGluIHRoZSBoYXNoIGlmIGl0IGlzIHRvIGJlIHVzZWQgYXMgYSBzZWxlY3RvcgoJCQloYXNoVG9TZWxlY3RvcjogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQl2YXIgaGFzSGFzaCA9ICggaGFzaC5zdWJzdHJpbmcoIDAsIDEgKSA9PT0gIiMiICk7CgkJCQlpZiAoIGhhc0hhc2ggKSB7CgkJCQkJaGFzaCA9IGhhc2guc3Vic3RyaW5nKCAxICk7CgkJCQl9CgkJCQlyZXR1cm4gKCBoYXNIYXNoID8gIiMiIDogIiIgKSArIGhhc2gucmVwbGFjZSggLyhbISIjJCUmJygpKissLi86Ozw9Pj9AW1xdXmB7fH1+XSkvZywgIlxcJDEiICk7CgkJCX0sCgoJCQkvLyByZXR1cm4gdGhlIHN1YnN0cmluZyBvZiBhIGZpbGVwYXRoIGJlZm9yZSB0aGUgc3ViLXBhZ2Uga2V5LCBmb3IgbWFraW5nCgkJCS8vIGEgc2VydmVyIHJlcXVlc3QKCQkJZ2V0RmlsZVBhdGg6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJdmFyIHNwbGl0a2V5ID0gIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleTsKCQkJCXJldHVybiBwYXRoICYmIHBhdGguc3BsaXQoIHNwbGl0a2V5IClbMF0uc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJfSwKCgkJCS8vIGNoZWNrIGlmIHRoZSBzcGVjaWZpZWQgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgbWFpbgoJCQkvLyBhcHBsaWNhdGlvbiBkb2N1bWVudC4KCQkJaXNGaXJzdFBhZ2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBXZSBvbmx5IGRlYWwgd2l0aCBhYnNvbHV0ZSBwYXRocy4KCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgdGhpcy5kb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gdGhpcy5kb2N1bWVudFVybC5ocmVmTm9IYXNoIHx8CgkJCQkJCSggdGhpcy5kb2N1bWVudEJhc2VEaWZmZXJzICYmCgkJCQkJCQl1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSwKCgkJCQkJLy8gR2V0IHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQkJZnAgPSAkLm1vYmlsZS5maXJzdFBhZ2UsCgoJCQkJCS8vIEdldCB0aGUgaWQgb2YgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudCBpZiBpdCBoYXMgb25lLgoJCQkJCWZwSWQgPSBmcCAmJiBmcFswXSA/IGZwWzBdLmlkIDogdW5kZWZpbmVkOwoKCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJLy8gaXQgZWl0aGVyIGhhcyBubyBoYXNoIHZhbHVlLCBvciB0aGUgaGFzaCBpcyBleGFjdGx5IGVxdWFsIHRvIHRoZSBpZAoJCQkJLy8gb2YgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCXJldHVybiBzYW1lUGF0aCAmJgoJCQkJCSggIXUuaGFzaCB8fAoJCQkJCQl1Lmhhc2ggPT09ICIjIiB8fAoJCQkJCQkoIGZwSWQgJiYgdS5oYXNoLnJlcGxhY2UoIC9eIy8sICIiICkgPT09IGZwSWQgKSApOwoJCQl9LAoKCQkJLy8gU29tZSBlbWJlZGRlZCBicm93c2VycywgbGlrZSB0aGUgd2ViIHZpZXcgaW4gUGhvbmUgR2FwLCBhbGxvdwoJCQkvLyBjcm9zcy1kb21haW4gWEhSIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkCgkJCS8vIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4gVGhpcyBpcyB1c3VhbGx5IHRvIGFsbG93IHRoZSBhcHBsaWNhdGlvbiB0bwoJCQkvLyAicGhvbmUgaG9tZSIgYW5kIGZldGNoIGFwcCBzcGVjaWZpYyBkYXRhLiBXZSBub3JtYWxseSBsZXQgdGhlIGJyb3dzZXIKCQkJLy8gaGFuZGxlIGV4dGVybmFsL2Nyb3NzLWRvbWFpbiB1cmxzLCBidXQgaWYgdGhlIGFsbG93Q3Jvc3NEb21haW5QYWdlcwoJCQkvLyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcyByZXF1ZXN0cyB0byBnbwoJCQkvLyB0aHJvdWdoIG91ciBwYWdlIGxvYWRpbmcgbG9naWMuCgkJCWlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0OiBmdW5jdGlvbiggZG9jVXJsLCByZXFVcmwgKSB7CgkJCQlyZXR1cm4gJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzICYmCgkJCQkJKGRvY1VybC5wcm90b2NvbCA9PT0gImZpbGU6IiB8fCBkb2NVcmwucHJvdG9jb2wgPT09ICJjb250ZW50OiIpICYmCgkJCQkJcmVxVXJsLnNlYXJjaCggL15odHRwcz86LyApICE9PSAtMTsKCQkJfQoJCX07CgoJCXBhdGguZG9jdW1lbnRVcmwgPSBwYXRoLnBhcnNlTG9jYXRpb24oKTsKCgkJJGJhc2UgPSAkKCAiaGVhZCIgKS5maW5kKCAiYmFzZSIgKTsKCgkJcGF0aC5kb2N1bWVudEJhc2UgPSAkYmFzZS5sZW5ndGggPwoJCQlwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGJhc2UuYXR0ciggImhyZWYiICksIHBhdGguZG9jdW1lbnRVcmwuaHJlZiApICkgOgoJCQlwYXRoLmRvY3VtZW50VXJsOwoKCQlwYXRoLmRvY3VtZW50QmFzZURpZmZlcnMgPSAocGF0aC5kb2N1bWVudFVybC5ocmVmTm9IYXNoICE9PSBwYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoKTsKCgkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IGJhc2UgdXJsCgkJcGF0aC5nZXREb2N1bWVudEJhc2UgPSBmdW5jdGlvbiggYXNQYXJzZWRPYmplY3QgKSB7CgkJCXJldHVybiBhc1BhcnNlZE9iamVjdCA/ICQuZXh0ZW5kKCB7fSwgcGF0aC5kb2N1bWVudEJhc2UgKSA6IHBhdGguZG9jdW1lbnRCYXNlLmhyZWY7CgkJfTsKCgkJLy8gREVQUkVDQVRFRCBhcyBvZiAxLjQuMCAtIHJlbW92ZSBpbiAxLjUuMAoJCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoKCQkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJCQlnZXREb2N1bWVudFVybDogcGF0aC5nZXREb2N1bWVudFVybCwKCgkJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJCQlnZXREb2N1bWVudEJhc2U6IHBhdGguZ2V0RG9jdW1lbnRCYXNlCgkJfSk7Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLm1vYmlsZS5IaXN0b3J5ID0gZnVuY3Rpb24oIHN0YWNrLCBpbmRleCApIHsKCQl0aGlzLnN0YWNrID0gc3RhY2sgfHwgW107CgkJdGhpcy5hY3RpdmVJbmRleCA9IGluZGV4IHx8IDA7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLkhpc3RvcnkucHJvdG90eXBlLCB7CgkJZ2V0QWN0aXZlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggXTsKCQl9LAoKCQlnZXRMYXN0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMucHJldmlvdXNJbmRleCBdOwoJCX0sCgoJCWdldE5leHQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5hY3RpdmVJbmRleCArIDEgXTsKCQl9LAoKCQlnZXRQcmV2OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggLSAxIF07CgkJfSwKCgkJLy8gYWRkTmV3IGlzIHVzZWQgd2hlbmV2ZXIgYSBuZXcgcGFnZSBpcyBhZGRlZAoJCWFkZDogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJZGF0YSA9IGRhdGEgfHwge307CgoJCQkvL2lmIHRoZXJlJ3MgZm9yd2FyZCBoaXN0b3J5LCB3aXBlIGl0CgkJCWlmICggdGhpcy5nZXROZXh0KCkgKSB7CgkJCQl0aGlzLmNsZWFyRm9yd2FyZCgpOwoJCQl9CgoJCQkvLyBpZiB0aGUgaGFzaCBpcyBpbmNsdWRlZCBpbiB0aGUgZGF0YSBtYWtlIHN1cmUgdGhlIHNoYXBlCgkJCS8vIGlzIGNvbnNpc3RlbnQgZm9yIGNvbXBhcmlzb24KCQkJaWYgKCBkYXRhLmhhc2ggJiYgZGF0YS5oYXNoLmluZGV4T2YoICIjIiApID09PSAtMSkgewoJCQkJZGF0YS5oYXNoID0gIiMiICsgZGF0YS5oYXNoOwoJCQl9CgoJCQlkYXRhLnVybCA9IHVybDsKCQkJdGhpcy5zdGFjay5wdXNoKCBkYXRhICk7CgkJCXRoaXMuYWN0aXZlSW5kZXggPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7CgkJfSwKCgkJLy93aXBlIHVybHMgYWhlYWQgb2YgYWN0aXZlIGluZGV4CgkJY2xlYXJGb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zdGFjayA9IHRoaXMuc3RhY2suc2xpY2UoIDAsIHRoaXMuYWN0aXZlSW5kZXggKyAxICk7CgkJfSwKCgkJZmluZDogZnVuY3Rpb24oIHVybCwgc3RhY2ssIGVhcmx5UmV0dXJuICkgewoJCQlzdGFjayA9IHN0YWNrIHx8IHRoaXMuc3RhY2s7CgoJCQl2YXIgZW50cnksIGksIGxlbmd0aCA9IHN0YWNrLmxlbmd0aCwgaW5kZXg7CgoJCQlmb3IgKCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJZW50cnkgPSBzdGFja1tpXTsKCgkJCQlpZiAoIGRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkudXJsKSB8fAoJCQkJCWRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkuaGFzaCkgKSB7CgkJCQkJaW5kZXggPSBpOwoKCQkJCQlpZiAoIGVhcmx5UmV0dXJuICkgewoJCQkJCQlyZXR1cm4gaW5kZXg7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gaW5kZXg7CgkJfSwKCgkJX2ZpbmRCeUlkOiBmdW5jdGlvbiggaWQgKSB7CgkJCXZhciBzdGFja0luZGV4LAoJCQkJc3RhY2tMZW5ndGggPSB0aGlzLnN0YWNrLmxlbmd0aDsKCgkJCWZvciAoIHN0YWNrSW5kZXggPSAwIDsgc3RhY2tJbmRleCA8IHN0YWNrTGVuZ3RoIDsgc3RhY2tJbmRleCsrICkgewoJCQkJaWYgKCB0aGlzLnN0YWNrWyBzdGFja0luZGV4IF0uaWQgPT09IGlkICkgewoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gKCBzdGFja0luZGV4IDwgc3RhY2tMZW5ndGggPyBzdGFja0luZGV4IDogdW5kZWZpbmVkICk7CgkJfSwKCgkJY2xvc2VzdDogZnVuY3Rpb24oIHVybCwgaWQgKSB7CgkJCXZhciBjbG9zZXN0ID0gKCBpZCA9PT0gdW5kZWZpbmVkID8gdW5kZWZpbmVkIDogdGhpcy5fZmluZEJ5SWQoIGlkICkgKSwKCQkJCWEgPSB0aGlzLmFjdGl2ZUluZGV4OwoKCQkJLy8gRmlyc3QsIHdlIGNoZWNrIHdoZXRoZXIgd2UndmUgZm91bmQgYW4gZW50cnkgYnkgaWQuIElmIHNvLCB3ZSdyZSBkb25lLgoJCQlpZiAoIGNsb3Nlc3QgIT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBjbG9zZXN0OwoJCQl9CgoJCQkvLyBGYWlsaW5nIHRoYXQgdGFrZSB0aGUgc2xpY2Ugb2YgdGhlIGhpc3Rvcnkgc3RhY2sgYmVmb3JlIHRoZSBjdXJyZW50IGluZGV4IGFuZCBzZWFyY2gKCQkJLy8gZm9yIGEgdXJsIG1hdGNoLiBJZiBvbmUgaXMgZm91bmQsIHdlJ2xsIGF2b2lkIGF2b2lkIGxvb2tpbmcgdGhyb3VnaCBmb3J3YXJkIGhpc3RvcnkKCQkJLy8gTk9URSB0aGUgcHJlZmVyZW5jZSBmb3IgYmFja3dhcmQgaGlzdG9yeSBtb3ZlbWVudCBpcyBkcml2ZW4gYnkgdGhlIGZhY3QgdGhhdAoJCQkvLyAgICAgIG1vc3QgbW9iaWxlIGJyb3dzZXJzIG9ubHkgaGF2ZSBhIGRlZGljYXRlZCBiYWNrIGJ1dHRvbiwgYW5kIHVzZXJzIHJhcmVseSB1c2UKCQkJLy8gICAgICB0aGUgZm9yd2FyZCBidXR0b24gaW4gZGVza3RvcCBicm93c2VyIGFueWhvdwoJCQljbG9zZXN0ID0gdGhpcy5maW5kKCB1cmwsIHRoaXMuc3RhY2suc2xpY2UoMCwgYSkgKTsKCgkJCS8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGluIGJhY2t3YXJkIGhpc3RvcnkgY2hlY2sgZm9yd2FyZC4gVGhlIGB0cnVlYAoJCQkvLyB2YWx1ZSBwYXNzZWQgYXMgdGhlIHRoaXJkIHBhcmFtZXRlciBjYXVzZXMgdGhlIGZpbmQgbWV0aG9kIHRvIGJyZWFrCgkJCS8vIG9uIHRoZSBmaXJzdCBtYXRjaCBpbiB0aGUgZm9yd2FyZCBoaXN0b3J5IHNsaWNlLiBUaGUgc3RhcnRpbmcgaW5kZXgKCQkJLy8gb2YgdGhlIHNsaWNlIG11c3QgdGhlbiBiZSBhZGRlZCB0byB0aGUgcmVzdWx0IHRvIGdldCB0aGUgZWxlbWVudCBpbmRleAoJCQkvLyBpbiB0aGUgb3JpZ2luYWwgaGlzdG9yeSBzdGFjayA6KCA6KAoJCQkvLwoJCQkvLyBUT0RPIHRoaXMgaXMgaHlwZXIgY29uZnVzaW5nIGFuZCBzaG91bGQgYmUgY2xlYW5lZCB1cCAodWdoIHNvIGJhZCkKCQkJaWYgKCBjbG9zZXN0ID09PSB1bmRlZmluZWQgKSB7CgkJCQljbG9zZXN0ID0gdGhpcy5maW5kKCB1cmwsIHRoaXMuc3RhY2suc2xpY2UoYSksIHRydWUgKTsKCQkJCWNsb3Nlc3QgPSBjbG9zZXN0ID09PSB1bmRlZmluZWQgPyBjbG9zZXN0IDogY2xvc2VzdCArIGE7CgkJCX0KCgkJCXJldHVybiBjbG9zZXN0OwoJCX0sCgoJCWRpcmVjdDogZnVuY3Rpb24oIG9wdHMgKSB7CgkJCXZhciBuZXdBY3RpdmVJbmRleCA9IHRoaXMuY2xvc2VzdCggb3B0cy51cmwsIG9wdHMuaWQgKSwgYSA9IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkvLyBzYXZlIG5ldyBwYWdlIGluZGV4LCBudWxsIGNoZWNrIHRvIHByZXZlbnQgZmFsc2V5IDAgcmVzdWx0CgkJCS8vIHJlY29yZCB0aGUgcHJldmlvdXMgaW5kZXggZm9yIHJlZmVyZW5jZQoJCQlpZiAoIG5ld0FjdGl2ZUluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXg7CgkJCQl0aGlzLnByZXZpb3VzSW5kZXggPSBhOwoJCQl9CgoJCQkvLyBpbnZva2UgY2FsbGJhY2tzIHdoZXJlIGFwcHJvcHJpYXRlCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBhbHNvIGNvbnZvbHV0ZWQgYW5kIGNvbmZ1c2luZwoJCQlpZiAoIG5ld0FjdGl2ZUluZGV4IDwgYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuYmFjayB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgImJhY2siICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID4gYSApIHsKCQkJCSggb3B0cy5wcmVzZW50IHx8IG9wdHMuZm9yd2FyZCB8fCAkLm5vb3AgKSggdGhpcy5nZXRBY3RpdmUoKSwgImZvcndhcmQiICk7CgkJCX0gZWxzZSBpZiAoIG5ld0FjdGl2ZUluZGV4ID09PSB1bmRlZmluZWQgJiYgb3B0cy5taXNzaW5nICkgewoJCQkJb3B0cy5taXNzaW5nKCB0aGlzLmdldEFjdGl2ZSgpICk7CgkJCX0KCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBwYXRoID0gJC5tb2JpbGUucGF0aCwKCQlpbml0aWFsSHJlZiA9IGxvY2F0aW9uLmhyZWY7CgoJJC5tb2JpbGUuTmF2aWdhdG9yID0gZnVuY3Rpb24oIGhpc3RvcnkgKSB7CgkJdGhpcy5oaXN0b3J5ID0gaGlzdG9yeTsKCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gdHJ1ZTsKCgkJJC5tb2JpbGUud2luZG93LmJpbmQoewoJCQkicG9wc3RhdGUuaGlzdG9yeSI6ICQucHJveHkoIHRoaXMucG9wc3RhdGUsIHRoaXMgKSwKCQkJImhhc2hjaGFuZ2UuaGlzdG9yeSI6ICQucHJveHkoIHRoaXMuaGFzaGNoYW5nZSwgdGhpcyApCgkJfSk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLk5hdmlnYXRvci5wcm90b3R5cGUsIHsKCQloaXN0b3J5RW50cnlJZDogMCwKCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCXZhciBzdGF0ZSwgaHJlZiwgaGFzaCA9IHBhdGguaXNQYXRoKHVybCkgPyBwYXRoLnN0cmlwSGFzaCh1cmwpIDogdXJsOwoKCQkJaHJlZiA9IHBhdGguc3F1YXNoKCB1cmwgKTsKCgkJCS8vIG1ha2Ugc3VyZSB0byBwcm92aWRlIHRoaXMgaW5mb3JtYXRpb24gd2hlbiBpdCBpc24ndCBleHBsaWNpdGx5IHNldCBpbiB0aGUKCQkJLy8gZGF0YSBvYmplY3QgdGhhdCB3YXMgcGFzc2VkIHRvIHRoZSBzcXVhc2ggbWV0aG9kCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJaWQ6ICsrdGhpcy5oaXN0b3J5RW50cnlJZCwKCQkJCWhhc2g6IGhhc2gsCgkJCQl1cmw6IGhyZWYKCQkJfSwgZGF0YSk7CgoJCQkvLyByZXBsYWNlIHRoZSBjdXJyZW50IHVybCB3aXRoIHRoZSBuZXcgaHJlZiBhbmQgc3RvcmUgdGhlIHN0YXRlCgkJCS8vIE5vdGUgdGhhdCBpbiBzb21lIGNhc2VzIHdlIG1pZ2h0IGJlIHJlcGxhY2luZyBhbiB1cmwgd2l0aCB0aGUKCQkJLy8gc2FtZSB1cmwuIFdlIGRvIHRoaXMgYW55d2F5cyBiZWNhdXNlIHdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoYXQKCQkJLy8gYWxsIG9mIG91ciBoaXN0b3J5IGVudHJpZXMgaGF2ZSBhIHN0YXRlIG9iamVjdCBhc3NvY2lhdGVkIHdpdGgKCQkJLy8gdGhlbS4gVGhpcyBhbGxvd3MgdXMgdG8gd29yayBhcm91bmQgdGhlIGNhc2Ugd2hlcmUgJC5tb2JpbGUuYmFjaygpCgkJCS8vIGlzIGNhbGxlZCB0byB0cmFuc2l0aW9uIGZyb20gYW4gZXh0ZXJuYWwgcGFnZSB0byBhbiBlbWJlZGRlZCBwYWdlLgoJCQkvLyBJbiB0aGF0IHBhcnRpY3VsYXIgY2FzZSwgYSBoYXNoY2hhbmdlIGV2ZW50IGlzICpOT1QqIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4KCQkJLy8gRW5zdXJpbmcgZWFjaCBoaXN0b3J5IGVudHJ5IGhhcyBhIHN0YXRlIG9iamVjdCBtZWFucyB0aGF0IG9uUG9wU3RhdGUoKQoJCQkvLyB3aWxsIGFsd2F5cyB0cmlnZ2VyIG91ciBoYXNoY2hhbmdlIGNhbGxiYWNrIGV2ZW4gd2hlbiBhIGhhc2hjaGFuZ2UgZXZlbnQKCQkJLy8gaXMgbm90IGZpcmVkLgoJCQl3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHN0YXRlLCBzdGF0ZS50aXRsZSB8fCBkb2N1bWVudC50aXRsZSwgaHJlZiApOwoKCQkJcmV0dXJuIHN0YXRlOwoJCX0sCgoJCWhhc2g6IGZ1bmN0aW9uKCB1cmwsIGhyZWYgKSB7CgkJCXZhciBwYXJzZWQsIGxvYywgaGFzaCwgcmVzb2x2ZWQ7CgoJCQkvLyBHcmFiIHRoZSBoYXNoIGZvciByZWNvcmRpbmcuIElmIHRoZSBwYXNzZWQgdXJsIGlzIGEgcGF0aAoJCQkvLyB3ZSB1c2VkIHRoZSBwYXJzZWQgdmVyc2lvbiBvZiB0aGUgc3F1YXNoZWQgdXJsIHRvIHJlY29uc3RydWN0LAoJCQkvLyBvdGhlcndpc2Ugd2UgYXNzdW1lIGl0J3MgYSBoYXNoIGFuZCBzdG9yZSBpdCBkaXJlY3RseQoJCQlwYXJzZWQgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCQkJbG9jID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCQlpZiAoIGxvYy5wYXRobmFtZSArIGxvYy5zZWFyY2ggPT09IHBhcnNlZC5wYXRobmFtZSArIHBhcnNlZC5zZWFyY2ggKSB7CgkJCQkvLyBJZiB0aGUgcGF0aG5hbWUgYW5kIHNlYXJjaCBvZiB0aGUgcGFzc2VkIHVybCBpcyBpZGVudGljYWwgdG8gdGhlIGN1cnJlbnQgbG9jCgkJCQkvLyB0aGVuIHdlIG11c3QgdXNlIHRoZSBoYXNoLiBPdGhlcndpc2UgdGhlcmUgd2lsbCBiZSBubyBldmVudAoJCQkJLy8gZWcsIHVybCA9ICIvZm9vL2Jhcj9iYXojYmFuZyIsIGxvY2F0aW9uLmhyZWYgPSAiaHR0cDovL2V4YW1wbGUuY29tL2Zvby9iYXI/YmF6IgoJCQkJaGFzaCA9IHBhcnNlZC5oYXNoID8gcGFyc2VkLmhhc2ggOiBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoOwoJCQl9IGVsc2UgaWYgKCBwYXRoLmlzUGF0aCh1cmwpICkgewoJCQkJcmVzb2x2ZWQgPSBwYXRoLnBhcnNlVXJsKCBocmVmICk7CgkJCQkvLyBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgsIG1ha2UgaXQgZG9tYWluIHJlbGF0aXZlIGFuZCByZW1vdmUgYW55IHRyYWlsaW5nIGhhc2gKCQkJCWhhc2ggPSByZXNvbHZlZC5wYXRobmFtZSArIHJlc29sdmVkLnNlYXJjaCArIChwYXRoLmlzUHJlc2VydmFibGVIYXNoKCByZXNvbHZlZC5oYXNoICk/IHJlc29sdmVkLmhhc2gucmVwbGFjZSggIiMiLCAiIiApIDogIiIpOwoJCQl9IGVsc2UgewoJCQkJaGFzaCA9IHVybDsKCQkJfQoKCQkJcmV0dXJuIGhhc2g7CgkJfSwKCgkJLy8gVE9ETyByZWNvbnNpZGVyIG5hbWUKCQlnbzogZnVuY3Rpb24oIHVybCwgZGF0YSwgbm9FdmVudHMgKSB7CgkJCXZhciBzdGF0ZSwgaHJlZiwgaGFzaCwgcG9wc3RhdGVFdmVudCwKCQkJCWlzUG9wU3RhdGVFdmVudCA9ICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKTsKCgkJCS8vIEdldCB0aGUgdXJsIGFzIGl0IHdvdWxkIGxvb2sgc3F1YXNoZWQgb24gdG8gdGhlIGN1cnJlbnQgcmVzb2x1dGlvbiB1cmwKCQkJaHJlZiA9IHBhdGguc3F1YXNoKCB1cmwgKTsKCgkJCS8vIHNvcnQgb3V0IHdoYXQgdGhlIGhhc2ggc291bGQgYmUgZnJvbSB0aGUgdXJsCgkJCWhhc2ggPSB0aGlzLmhhc2goIHVybCwgaHJlZiApOwoKCQkJLy8gSGVyZSB3ZSBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggY2hhbmdlIG9yIHBvcHN0YXRlIGV2ZW50IGZyb20gZG9pbmcgYW55CgkJCS8vIGhpc3RvcnkgbWFuYWdlbWVudC4gSW4gdGhlIGNhc2Ugb2YgaGFzaGNoYW5nZSB3ZSBkb24ndCBzd2FsbG93IGl0CgkJCS8vIGlmIHRoZXJlIHdpbGwgYmUgbm8gaGFzaGNoYW5nZSBmaXJlZCAoc2luY2UgdGhhdCB3b24ndCByZXNldCB0aGUgdmFsdWUpCgkJCS8vIGFuZCB3aWxsIHN3YWxsb3cgdGhlIGZvbGxvd2luZyBoYXNoY2hhbmdlCgkJCWlmICggbm9FdmVudHMgJiYgaGFzaCAhPT0gcGF0aC5zdHJpcEhhc2gocGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCkgKSB7CgkJCQl0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSA9IG5vRXZlbnRzOwoJCQl9CgoJCQkvLyBJTVBPUlRBTlQgaW4gdGhlIGNhc2Ugd2hlcmUgcG9wc3RhdGUgaXMgc3VwcG9ydGVkIHRoZSBldmVudCB3aWxsIGJlIHRyaWdnZXJlZAoJCQkvLyAgICAgIGRpcmVjdGx5LCBzdG9wcGluZyBmdXJ0aGVyIGV4ZWN1dGlvbiAtIGllLCBpbnRlcnVwdGluZyB0aGUgZmxvdyBvZiB0aGlzCgkJCS8vICAgICAgbWV0aG9kIGNhbGwgdG8gZmlyZSBiaW5kaW5ncyBhdCB0aGlzIGV4cHJlc3Npb24uIEJlbG93IHRoZSBuYXZpZ2F0ZSBtZXRob2QKCQkJLy8gICAgICB0aGVyZSBpcyBhIGJpbmRpbmcgdG8gY2F0Y2ggdGhpcyBldmVudCBhbmQgc3RvcCBpdHMgcHJvcGFnYXRpb24uCgkJCS8vCgkJCS8vICAgICAgV2UgdGhlbiB0cmlnZ2VyIGEgbmV3IHBvcHN0YXRlIGV2ZW50IG9uIHRoZSB3aW5kb3cgd2l0aCBhIG51bGwgc3RhdGUKCQkJLy8gICAgICBzbyB0aGF0IHRoZSBuYXZpZ2F0ZSBldmVudHMgY2FuIGNvbmNsdWRlIHRoZWlyIHdvcmsgcHJvcGVybHkKCQkJLy8KCQkJLy8gaWYgdGhlIHVybCBpcyBhIHBhdGggd2Ugd2FudCB0byBwcmVzZXJ2ZSB0aGUgcXVlcnkgcGFyYW1zIHRoYXQgYXJlIGF2YWlsYWJsZSBvbgoJCQkvLyB0aGUgY3VycmVudCB1cmwuCgkJCXRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSA9IHRydWU7CgkJCXdpbmRvdy5sb2NhdGlvbi5oYXNoID0gaGFzaDsKCgkJCS8vIElmIHBvcHN0YXRlIGlzIGVuYWJsZWQgYW5kIHRoZSBicm93c2VyIHRyaWdnZXJzIGBwb3BzdGF0ZWAgZXZlbnRzIHdoZW4gdGhlIGhhc2gKCQkJLy8gaXMgc2V0ICh0aGlzIG9mdGVuIGhhcHBlbnMgaW1tZWRpYXRlbHkgaW4gYnJvd3NlcnMgbGlrZSBDaHJvbWUpLCB0aGVuIHRoZQoJCQkvLyB0aGlzIGZsYWcgd2lsbCBiZSBzZXQgdG8gZmFsc2UgYWxyZWFkeS4gSWYgaXQncyBhIGJyb3dzZXIgdGhhdCBkb2VzIG5vdCB0cmlnZ2VyCgkJCS8vIGEgYHBvcHN0YXRlYCBvbiBoYXNoIGFzc2lnbmVtZW50IG9yIGByZXBsYWNlU3RhdGVgIHRoZW4gd2UgbmVlZCBhdm9pZCB0aGUgYnJhbmNoCgkJCS8vIHRoYXQgc3dhbGxvd3MgdGhlIGV2ZW50IGNyZWF0ZWQgYnkgdGhlIHBvcHN0YXRlIGdlbmVyYXRlZCBieSB0aGUgaGFzaCBhc3NpZ25tZW50CgkJCS8vIEF0IHRoZSB0aW1lIG9mIHRoaXMgd3JpdGluZyB0aGlzIGhhcHBlbnMgd2l0aCBPcGVyYSAxMiBhbmQgc29tZSB2ZXJzaW9uIG9mIElFCgkJCXRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSA9IGZhbHNlOwoKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQl1cmw6IGhyZWYsCgkJCQloYXNoOiBoYXNoLAoJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlCgkJCX0sIGRhdGEpOwoKCQkJaWYgKCBpc1BvcFN0YXRlRXZlbnQgKSB7CgkJCQlwb3BzdGF0ZUV2ZW50ID0gbmV3ICQuRXZlbnQoICJwb3BzdGF0ZSIgKTsKCQkJCXBvcHN0YXRlRXZlbnQub3JpZ2luYWxFdmVudCA9IHsKCQkJCQl0eXBlOiAicG9wc3RhdGUiLAoJCQkJCXN0YXRlOiBudWxsCgkJCQl9OwoKCQkJCXN0YXRlLmlkID0gKCB0aGlzLnNxdWFzaCggdXJsLCBzdGF0ZSApIHx8IHt9ICkuaWQ7CgoJCQkJLy8gVHJpZ2dlciBhIG5ldyBmYXV4IHBvcHN0YXRlIGV2ZW50IHRvIHJlcGxhY2UgdGhlIG9uZSB0aGF0IHdlCgkJCQkvLyBjYXVnaHQgdGhhdCB3YXMgdHJpZ2dlcmVkIGJ5IHRoZSBoYXNoIHNldHRpbmcgYWJvdmUuCgkJCQlpZiAoICFub0V2ZW50cyApIHsKCQkJCQl0aGlzLmlnbm9yZVBvcFN0YXRlID0gdHJ1ZTsKCQkJCQkkLm1vYmlsZS53aW5kb3cudHJpZ2dlciggcG9wc3RhdGVFdmVudCApOwoJCQkJfQoJCQl9CgoJCQkvLyByZWNvcmQgdGhlIGhpc3RvcnkgZW50cnkgc28gdGhhdCB0aGUgaW5mb3JtYXRpb24gY2FuIGJlIGluY2x1ZGVkCgkJCS8vIGluIGhhc2hjaGFuZ2UgZXZlbnQgZHJpdmVuIG5hdmlnYXRlIGV2ZW50cyBpbiBhIHNpbWlsYXIgZmFzaGlvbiB0bwoJCQkvLyB0aGUgc3RhdGUgdGhhdCdzIHByb3ZpZGVkIGJ5IHBvcHN0YXRlCgkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCQl9LAoKCQkvLyBUaGlzIGJpbmRpbmcgaXMgaW50ZW5kZWQgdG8gY2F0Y2ggdGhlIHBvcHN0YXRlIGV2ZW50cyB0aGF0IGFyZSBmaXJlZAoJCS8vIHdoZW4gZXhlY3V0aW9uIG9mIHRoZSBgJC5uYXZpZ2F0ZWAgbWV0aG9kIHN0b3BzIGF0IHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gdXJsOwoJCS8vIGFuZCBjb21wbGV0ZWx5IHByZXZlbnQgdGhlbSBmcm9tIHByb3BhZ2F0aW5nLiBUaGUgcG9wc3RhdGUgZXZlbnQgd2lsbCB0aGVuIGJlCgkJLy8gcmV0cmlnZ2VyZWQgYWZ0ZXIgZXhlY3V0aW9uIHJlc3VtZXMKCQkvLwoJCS8vIFRPRE8gZ3JhYiB0aGUgb3JpZ2luYWwgZXZlbnQgaGVyZSBhbmQgdXNlIGl0IGZvciB0aGUgc3ludGhldGljIGV2ZW50IGluIHRoZQoJCS8vICAgICAgc2Vjb25kIGhhbGYgb2YgdGhlIG5hdmlnYXRlIGV4ZWN1dGlvbiB0aGF0IHdpbGwgZm9sbG93IHRoaXMgYmluZGluZwoJCXBvcHN0YXRlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoYXNoLCBzdGF0ZTsKCgkJCS8vIFBhcnRseSB0byBzdXBwb3J0IG91ciB0ZXN0IHN1aXRlIHdoaWNoIG1hbnVhbGx5IGFsdGVycyB0aGUgc3VwcG9ydAoJCQkvLyB2YWx1ZSB0byB0ZXN0IGhhc2hjaGFuZ2UuIFBhcnRseSB0byBwcmV2ZW50IGFsbCBhcm91bmQgd2VpcmRuZXNzCgkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgcG9wc3RhdGUgdHJpZ2dlcmVkIGJ5IHRoZSBhY3R1YWwgYWx0ZXJhdGlvbiBvZiB0aGUgaGFzaAoJCQkvLyBwcmV2ZW50IGl0IGNvbXBsZXRlbHkuIEhpc3RvcnkgaXMgdHJhY2tlZCBtYW51YWxseQoJCQlpZiAoIHRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSApIHsKCQkJCXRoaXMucHJldmVudEhhc2hBc3NpZ25Qb3BTdGF0ZSA9IGZhbHNlOwoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIGlmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBhZnRlciB0aGUgYHJlcGxhY2VTdGF0ZWAgY2FsbCBpbiB0aGUgZ28KCQkJLy8gbWV0aG9kLCB0aGVuIHNpbXBseSBpZ25vcmUgaXQuIFRoZSBoaXN0b3J5IGVudHJ5IGhhcyBhbHJlYWR5IGJlZW4gY2FwdHVyZWQKCQkJaWYgKCB0aGlzLmlnbm9yZVBvcFN0YXRlICkgewoJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IGZhbHNlOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiB0aGVyZSBpcyBubyBzdGF0ZSwgYW5kIHRoZSBoaXN0b3J5IHN0YWNrIGxlbmd0aCBpcyBvbmUgd2VyZQoJCQkvLyBwcm9iYWJseSBnZXR0aW5nIHRoZSBwYWdlIGxvYWQgcG9wc3RhdGUgZmlyZWQgYnkgYnJvd3NlcnMgbGlrZSBjaHJvbWUKCQkJLy8gYXZvaWQgaXQgYW5kIHNldCB0aGUgb25lIHRpbWUgZmxhZyB0byBmYWxzZS4KCQkJLy8gVE9ETzogRG8gd2UgcmVhbGx5IG5lZWQgYWxsIHRoZXNlIGNvbmRpdGlvbnM/IENvbXBhcmluZyBsb2NhdGlvbiBocmVmcwoJCQkvLyBzaG91bGQgYmUgc3VmZmljaWVudC4KCQkJaWYgKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJgoJCQkJdGhpcy5oaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMSAmJgoJCQkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSApIHsKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSBmYWxzZTsKCgkJCQlpZiAoIGxvY2F0aW9uLmhyZWYgPT09IGluaXRpYWxIcmVmICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBhY2NvdW50IGZvciBkaXJlY3QgbWFuaXB1bGF0aW9uIG9mIHRoZSBoYXNoLiBUaGF0IGlzLCB3ZSB3aWxsIHJlY2VpdmUgYSBwb3BzdGF0ZQoJCQkvLyB3aGVuIHRoZSBoYXNoIGlzIGNoYW5nZWQgYnkgYXNzaWdubWVudCwgYW5kIGl0IHdvbid0IGhhdmUgYSBzdGF0ZSBhc3NvY2lhdGVkLiBXZQoJCQkvLyB0aGVuIG5lZWQgdG8gc3F1YXNoIHRoZSBoYXNoLiBTZWUgYmVsb3cgZm9yIGhhbmRsaW5nIG9mIGhhc2ggYXNzaWdubWVudCB0aGF0CgkJCS8vIG1hdGNoZXMgYW4gZXhpc3RpbmcgaGlzdG9yeSBlbnRyeQoJCQkvLyBUT0RPIGl0IG1pZ2h0IGJlIGJldHRlciB0byBvbmx5IGFkZCB0byB0aGUgaGlzdG9yeSBzdGFjawoJCQkvLyAgICAgIHdoZW4gdGhlIGhhc2ggaXMgYWRqYWNlbnQgdG8gdGhlIGFjdGl2ZSBoaXN0b3J5IGVudHJ5CgkJCWhhc2ggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQlpZiAoICFldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlICYmIGhhc2ggKSB7CgkJCQkvLyBzcXVhc2ggdGhlIGhhc2ggdGhhdCdzIGJlZW4gYXNzaWduZWQgb24gdGhlIFVSTCB3aXRoIHJlcGxhY2VTdGF0ZQoJCQkJLy8gYWxzbyBncmFiIHRoZSByZXN1bHRpbmcgc3RhdGUgb2JqZWN0IGZvciBzdG9yYWdlCgkJCQlzdGF0ZSA9IHRoaXMuc3F1YXNoKCBoYXNoICk7CgoJCQkJLy8gcmVjb3JkIHRoZSBuZXcgaGFzaCBhcyBhbiBhZGRpdGlvbmFsIGhpc3RvcnkgZW50cnkKCQkJCS8vIHRvIG1hdGNoIHRoZSBicm93c2VyJ3MgdHJlYXRtZW50IG9mIGhhc2ggYXNzaWdubWVudAoJCQkJdGhpcy5oaXN0b3J5LmFkZCggc3RhdGUudXJsLCBzdGF0ZSApOwoKCQkJCS8vIHBhc3MgdGhlIG5ld2x5IGNyZWF0ZWQgc3RhdGUgaW5mb3JtYXRpb24KCQkJCS8vIGFsb25nIHdpdGggdGhlIGV2ZW50CgkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSBzdGF0ZTsKCgkJCQkvLyBkbyBub3QgYWx0ZXIgaGlzdG9yeSwgd2UndmUgYWRkZWQgYSBuZXcgaGlzdG9yeSBlbnRyeQoJCQkJLy8gc28gd2Uga25vdyB3aGVyZSB3ZSBhcmUKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgYWxsIGVsc2UgZmFpbHMgdGhpcyBpcyBhIHBvcHN0YXRlIHRoYXQgY29tZXMgZnJvbSB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbnMKCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgc3RhdGUgb2Ygb3VyIGhpc3Rvcnkgc3RhY2sgcHJvcGVybHksIGFuZCByZWNvcmQgdGhlIGRpcmVjdGlvbmFsaXR5CgkJCXRoaXMuaGlzdG9yeS5kaXJlY3QoewoJCQkJaWQ6ICggZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSB8fCB7fSApLmlkLAoJCQkJdXJsOiAoZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSB8fCB7fSkudXJsIHx8IGhhc2gsCgoJCQkJLy8gV2hlbiB0aGUgdXJsIGlzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIGhpc3RvcnkgaW5jbHVkZSB0aGUgZW50cnkKCQkJCS8vIGFzIGRhdGEgb24gdGhlIGV2ZW50IG9iamVjdCBmb3IgbWVyZ2luZyBhcyBkYXRhIGluIHRoZSBuYXZpZ2F0ZSBldmVudAoJCQkJcHJlc2VudDogZnVuY3Rpb24oIGhpc3RvcnlFbnRyeSwgZGlyZWN0aW9uICkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRvIHBhc3MgZG93biBhcyB0aGUgbmF2aWdhdGUgZXZlbnQgZGF0YQoJCQkJCWV2ZW50Lmhpc3RvcnlTdGF0ZSA9ICQuZXh0ZW5kKHt9LCBoaXN0b3J5RW50cnkpOwoJCQkJCWV2ZW50Lmhpc3RvcnlTdGF0ZS5kaXJlY3Rpb24gPSBkaXJlY3Rpb247CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIE5PVEUgbXVzdCBiaW5kIGJlZm9yZSBgbmF2aWdhdGVgIHNwZWNpYWwgZXZlbnQgaGFzaGNoYW5nZSBiaW5kaW5nIG90aGVyd2lzZSB0aGUKCQkvLyAgICAgIG5hdmlnYXRpb24gZGF0YSB3b24ndCBiZSBhdHRhY2hlZCB0byB0aGUgaGFzaGNoYW5nZSBldmVudCBpbiB0aW1lIGZvciB0aG9zZQoJCS8vICAgICAgYmluZGluZ3MgdG8gYXR0YWNoIGl0IHRvIHRoZSBgbmF2aWdhdGVgIHNwZWNpYWwgZXZlbnQKCQkvLyBUT0RPIGFkZCBhIGNoZWNrIGhlcmUgdGhhdCBgaGFzaGNoYW5nZS5uYXZpZ2F0ZWAgaXMgYm91bmQgYWxyZWFkeSBvdGhlcndpc2UgaXQncwoJCS8vICAgICAgYnJva2VuIChleGNlcHRpb24/KQoJCWhhc2hjaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGhpc3RvcnksIGhhc2g7CgoJCQkvLyBJZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBleHBsaWNpdGx5IGRpc2FibGVkIG9yIHB1c2hzdGF0ZSBpcyBzdXBwb3J0ZWQKCQkJLy8gYXZvaWQgbWFraW5nIHVzZSBvZiB0aGUgaGFzaGNoYW5nZSBoYW5kbGVyLgoJCQlpZiAoISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc0hhc2hDaGFuZ2VFbmFibGVkKCkgfHwKCQkJCSQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gT24gb2NjYXNpb24gZXhwbGljaXRseSB3YW50IHRvIHByZXZlbnQgdGhlIG5leHQgaGFzaCBmcm9tIHByb3BvZ2F0aW5nIGJlY2F1c2Ugd2Ugb25seQoJCQkvLyB3aXRoIHRvIGFsdGVyIHRoZSB1cmwgdG8gcmVwcmVzZW50IHRoZSBuZXcgc3RhdGUgZG8gc28gaGVyZQoJCQlpZiAoIHRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQloaXN0b3J5ID0gdGhpcy5oaXN0b3J5OwoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCgkJCS8vIElmIHRoaXMgaXMgYSBoYXNoY2hhbmdlIGNhdXNlZCBieSB0aGUgYmFjayBvciBmb3J3YXJkIGJ1dHRvbgoJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSBzdGF0ZSBvZiBvdXIgaGlzdG9yeSBzdGFjayBwcm9wZXJseQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogaGFzaCwKCgkJCQkvLyBXaGVuIHRoZSB1cmwgaXMgZWl0aGVyIGZvcndhcmQgb3IgYmFja3dhcmQgaW4gaGlzdG9yeSBpbmNsdWRlIHRoZSBlbnRyeQoJCQkJLy8gYXMgZGF0YSBvbiB0aGUgZXZlbnQgb2JqZWN0IGZvciBtZXJnaW5nIGFzIGRhdGEgaW4gdGhlIG5hdmlnYXRlIGV2ZW50CgkJCQlwcmVzZW50OiBmdW5jdGlvbiggaGlzdG9yeUVudHJ5LCBkaXJlY3Rpb24gKSB7CgkJCQkJLy8gbWFrZSBzdXJlIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdG8gcGFzcyBkb3duIGFzIHRoZSBuYXZpZ2F0ZSBldmVudCBkYXRhCgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlID0gJC5leHRlbmQoe30sIGhpc3RvcnlFbnRyeSk7CgkJCQkJZXZlbnQuaGFzaGNoYW5nZVN0YXRlLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjsKCQkJCX0sCgoJCQkJLy8gV2hlbiB3ZSBkb24ndCBmaW5kIGEgaGFzaCBpbiBvdXIgaGlzdG9yeSBjbGVhcmx5IHdlJ3JlIGFpbWluZyB0byBnbyB0aGVyZQoJCQkJLy8gcmVjb3JkIHRoZSBlbnRyeSBhcyBuZXcgZm9yIGZ1dHVyZSB0cmF2ZXJzYWwKCQkJCS8vCgkJCQkvLyBOT1RFIGl0J3Mgbm90IGVudGlyZWx5IGNsZWFyIHRoYXQgdGhpcyBpcyB0aGUgcmlnaHQgdGhpbmcgdG8gZG8gZ2l2ZW4gdGhhdCB3ZQoJCQkJLy8gICAgICBjYW4ndCBrbm93IHRoZSB1c2VycyBpbnRlbnRpb24uIEl0IG1pZ2h0IGJlIGJldHRlciB0byBleHBsaWNpdGx5IF9ub3RfCgkJCQkvLyAgICAgIHN1cHBvcnQgbG9jYXRpb24uaGFzaCBhc3NpZ25tZW50IGluIHByZWZlcmVuY2UgdG8gJC5uYXZpZ2F0ZSBjYWxscwoJCQkJLy8gVE9ETyBmaXJzdCBhcmcgdG8gYWRkIHNob3VsZCBiZSB0aGUgaHJlZiwgYnV0IGl0IGNhdXNlcyBpc3N1ZXMgaW4gaWRlbnRpZnlpbmcKCQkJCS8vICAgICAgZW1iZWRlZCBwYWdlcwoJCQkJbWlzc2luZzogZnVuY3Rpb24oKSB7CgkJCQkJaGlzdG9yeS5hZGQoIGhhc2gsIHsKCQkJCQkJaGFzaDogaGFzaCwKCQkJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJLy8gVE9ETyBjb25zaWRlciBxdWV1ZWluZyBuYXZpZ2F0aW9uIGFjdGl2aXR5IHVudGlsIHByZXZpb3VzIGFjdGl2aXRpZXMgaGF2ZSBjb21wbGV0ZWQKCS8vICAgICAgc28gdGhhdCBlbmQgdXNlcnMgZG9uJ3QgaGF2ZSB0byB0aGluayBhYm91dCBpdC4gUHVudGluZyBmb3Igbm93CgkvLyBUT0RPICEhIG1vdmUgdGhlIGV2ZW50IGJpbmRpbmdzIGludG8gY2FsbGJhY2tzIG9uIHRoZSBuYXZpZ2F0ZSBldmVudAoJJC5tb2JpbGUubmF2aWdhdGUgPSBmdW5jdGlvbiggdXJsLCBkYXRhLCBub0V2ZW50cyApIHsKCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IuZ28oIHVybCwgZGF0YSwgbm9FdmVudHMgKTsKCX07CgoJLy8gZXhwb3NlIHRoZSBoaXN0b3J5IG9uIHRoZSBuYXZpZ2F0ZSBtZXRob2QgaW4gYW50aWNpcGF0aW9uIG9mIGZ1bGwgaW50ZWdyYXRpb24gd2l0aAoJLy8gZXhpc3RpbmcgbmF2aWdhdGlvbiBmdW5jdGlvbmFsdHkgdGhhdCBpcyB0aWdodGx5IGNvdXBsZWQgdG8gdGhlIGhpc3RvcnkgaW5mb3JtYXRpb24KCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkgPSBuZXcgJC5tb2JpbGUuSGlzdG9yeSgpOwoKCS8vIGluc3RhbnRpYXRlIGFuIGluc3RhbmNlIG9mIHRoZSBuYXZpZ2F0b3IgZm9yIHVzZSB3aXRoaW4gdGhlICQubmF2aWdhdGUgbWV0aG9kCgkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3IgPSBuZXcgJC5tb2JpbGUuTmF2aWdhdG9yKCAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ICk7CgoJdmFyIGxvYyA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpOwoJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIGxvYy5ocmVmLCB7aGFzaDogbG9jLmhhc2h9ICk7Cn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBwcm9wcyA9IHsKCQkJImFuaW1hdGlvbiI6IHt9LAoJCQkidHJhbnNpdGlvbiI6IHt9CgkJfSwKCQl0ZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApLAoJCXZlbmRvclByZWZpeGVzID0gWyAiIiwgIndlYmtpdC0iLCAibW96LSIsICJvLSIgXTsKCgkkLmVhY2goIFsgImFuaW1hdGlvbiIsICJ0cmFuc2l0aW9uIiBdLCBmdW5jdGlvbiggaSwgdGVzdCApIHsKCgkJLy8gR2V0IGNvcnJlY3QgbmFtZSBmb3IgdGVzdAoJCXZhciB0ZXN0TmFtZSA9ICggaSA9PT0gMCApID8gdGVzdCArICItIiArICJuYW1lIiA6IHRlc3Q7CgoJCSQuZWFjaCggdmVuZG9yUHJlZml4ZXMsIGZ1bmN0aW9uKCBqLCBwcmVmaXggKSB7CgkJCWlmICggdGVzdEVsZW1lbnQuc3R5bGVbICQuY2FtZWxDYXNlKCBwcmVmaXggKyB0ZXN0TmFtZSApIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCSBwcm9wc1sgdGVzdCBdWyAicHJlZml4IiBdID0gcHJlZml4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7CgoJCS8vIFNldCBldmVudCBhbmQgZHVyYXRpb24gbmFtZXMgZm9yIGxhdGVyIHVzZQoJCXByb3BzWyB0ZXN0IF1bICJkdXJhdGlvbiIgXSA9CgkJCSQuY2FtZWxDYXNlKCBwcm9wc1sgdGVzdCBdWyAicHJlZml4IiBdICsgdGVzdCArICItIiArICJkdXJhdGlvbiIgKTsKCQlwcm9wc1sgdGVzdCBdWyAiZXZlbnQiIF0gPQoJCQkkLmNhbWVsQ2FzZSggcHJvcHNbIHRlc3QgXVsgInByZWZpeCIgXSArIHRlc3QgKyAiLSIgKyAiZW5kIiApOwoKCQkvLyBBbGwgbG93ZXIgY2FzZSBpZiBub3QgYSB2ZW5kb3IgcHJvcAoJCWlmICggcHJvcHNbIHRlc3QgXVsgInByZWZpeCIgXSA9PT0gIiIgKSB7CgkJCXByb3BzWyB0ZXN0IF1bICJldmVudCIgXSA9IHByb3BzWyB0ZXN0IF1bICJldmVudCIgXS50b0xvd2VyQ2FzZSgpOwoJCX0KCX0pOwoKCS8vIElmIGEgdmFsaWQgcHJlZml4IHdhcyBmb3VuZCB0aGVuIHRoZSBpdCBpcyBzdXBwb3J0ZWQgYnkgdGhlIGJyb3dzZXIKCSQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyA9ICggcHJvcHNbICJ0cmFuc2l0aW9uIiBdWyAicHJlZml4IiBdICE9PSB1bmRlZmluZWQgKTsKCSQuc3VwcG9ydC5jc3NBbmltYXRpb25zID0gKCBwcm9wc1sgImFuaW1hdGlvbiIgXVsgInByZWZpeCIgXSAhPT0gdW5kZWZpbmVkICk7CgoJLy8gUmVtb3ZlIHRoZSB0ZXN0RWxlbWVudAoJJCggdGVzdEVsZW1lbnQgKS5yZW1vdmUoKTsKCgkvLyBBbmltYXRpb24gY29tcGxldGUgY2FsbGJhY2sKCSQuZm4uYW5pbWF0aW9uQ29tcGxldGUgPSBmdW5jdGlvbiggY2FsbGJhY2ssIHR5cGUsIGZhbGxiYWNrVGltZSApIHsKCQl2YXIgdGltZXIsIGR1cmF0aW9uLAoJCQl0aGF0ID0gdGhpcywKCQkJZXZlbnRCaW5kaW5nID0gZnVuY3Rpb24oKSB7CgoJCQkJLy8gQ2xlYXIgdGhlIHRpbWVyIHNvIHdlIGRvbid0IGNhbGwgY2FsbGJhY2sgdHdpY2UKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCWNhbGxiYWNrLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfSwKCQkJYW5pbWF0aW9uVHlwZSA9ICggIXR5cGUgfHwgdHlwZSA9PT0gImFuaW1hdGlvbiIgKSA/ICJhbmltYXRpb24iIDogInRyYW5zaXRpb24iOwoKCQkvLyBNYWtlIHN1cmUgc2VsZWN0ZWQgdHlwZSBpcyBzdXBwb3J0ZWQgYnkgYnJvd3NlcgoJCWlmICggKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgJiYgYW5pbWF0aW9uVHlwZSA9PT0gInRyYW5zaXRpb24iICkgfHwKCQkJKCAkLnN1cHBvcnQuY3NzQW5pbWF0aW9ucyAmJiBhbmltYXRpb25UeXBlID09PSAiYW5pbWF0aW9uIiApICkgewoKCQkJLy8gSWYgYSBmYWxsYmFjayB0aW1lIHdhcyBub3QgcGFzc2VkIHNldCBvbmUKCQkJaWYgKCBmYWxsYmFja1RpbWUgPT09IHVuZGVmaW5lZCApIHsKCgkJCQkvLyBNYWtlIHN1cmUgdGhlIHdhcyBub3QgYm91bmQgdG8gZG9jdW1lbnQgYmVmb3JlIGNoZWNraW5nIC5jc3MKCQkJCWlmICggJCggdGhpcyApLmNvbnRleHQgIT09IGRvY3VtZW50ICkgewoKCQkJCQkvLyBQYXJzZSB0aGUgZHVycmF0aW9uIHNpbmNlIGl0cyBpbiBzZWNvbmQgbXVsdGlwbGUgYnkgMTAwMCBmb3IgbWlsbGlzZWNvbmRzCgkJCQkJLy8gTXVsdGlwbHkgYnkgMyB0byBtYWtlIHN1cmUgd2UgZ2l2ZSB0aGUgYW5pbWF0aW9uIHBsZW50eSBvZiB0aW1lLgoJCQkJCWR1cmF0aW9uID0gcGFyc2VGbG9hdCgKCQkJCQkJJCggdGhpcyApLmNzcyggcHJvcHNbIGFuaW1hdGlvblR5cGUgXS5kdXJhdGlvbiApCgkJCQkJKSAqIDMwMDA7CgkJCQl9CgoJCQkJLy8gSWYgd2UgY291bGQgbm90IHJlYWQgYSBkdXJhdGlvbiB1c2UgdGhlIGRlZmF1bHQKCQkJCWlmICggZHVyYXRpb24gPT09IDAgfHwgZHVyYXRpb24gPT09IHVuZGVmaW5lZCB8fCBpc05hTiggZHVyYXRpb24gKSApIHsKCQkJCQlkdXJhdGlvbiA9ICQuZm4uYW5pbWF0aW9uQ29tcGxldGUuZGVmYXVsdER1cmF0aW9uOwoJCQkJfQoJCQl9CgoJCQkvLyBTZXRzIHVwIHRoZSBmYWxsYmFjayBpZiBldmVudCBuZXZlciBjb21lcwoJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJJCggdGhhdCApLm9mZiggcHJvcHNbIGFuaW1hdGlvblR5cGUgXS5ldmVudCwgZXZlbnRCaW5kaW5nICk7CgkJCQljYWxsYmFjay5hcHBseSggdGhhdCApOwoJCQl9LCBkdXJhdGlvbiApOwoKCQkJLy8gQmluZCB0aGUgZXZlbnQKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoIHByb3BzWyBhbmltYXRpb25UeXBlIF0uZXZlbnQsIGV2ZW50QmluZGluZyApOwoJCX0gZWxzZSB7CgoJCQkvLyBDU1MgYW5pbWF0aW9uIC8gdHJhbnNpdGlvbnMgbm90IHN1cHBvcnRlZAoJCQkvLyBEZWZlciBleGVjdXRpb24gZm9yIGNvbnNpc3RlbmN5IGJldHdlZW4gd2Via2l0L25vbiB3ZWJraXQKCQkJc2V0VGltZW91dCggJC5wcm94eSggY2FsbGJhY2ssIHRoaXMgKSwgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy8gQWxsb3cgZGVmYXVsdCBjYWxsYmFjayB0byBiZSBjb25maWd1cmVkIG9uIG1vYmlsZUluaXQKCSQuZm4uYW5pbWF0aW9uQ29tcGxldGUuZGVmYXVsdER1cmF0aW9uID0gMTAwMDsKfSkoIGpRdWVyeSApOwoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCW1vdXNlSG9va1Byb3BzID0gJC5ldmVudC5tb3VzZUhvb2tzID8gJC5ldmVudC5tb3VzZUhvb2tzLnByb3BzIDogW10sCgltb3VzZUV2ZW50UHJvcHMgPSAkLmV2ZW50LnByb3BzLmNvbmNhdCggbW91c2VIb29rUHJvcHMgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMCwgdGhyZXNob2xkLAoJaTsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgaiwgbGVuOwoKCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgoJb2UgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJcHJvcHMgPSAkLmV2ZW50LnByb3BzOwoKCS8vIGFkZHJlc3NlcyBzZXBhcmF0aW9uIG9mICQuZXZlbnQucHJvcHMgaW4gdG8gJC5ldmVudC5tb3VzZUhvb2sucHJvcHMgYW5kIElzc3VlIDMyODAKCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzI4MAoJaWYgKCB0LnNlYXJjaCggL14obW91c2V8Y2xpY2spLyApID4gLTEgKSB7CgkJcHJvcHMgPSBtb3VzZUV2ZW50UHJvcHM7Cgl9CgoJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCglpZiAoIG9lICkgewoJCWZvciAoIGkgPSBwcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gcHJvcHNbIC0taSBdOwoJCQlldmVudFsgcHJvcCBdID0gb2VbIHByb3AgXTsKCQl9Cgl9CgoJLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIG1vdXNlIGFuZCBjbGljayB2aXJ0dWFsIGV2ZW50cyBhcmUgZ2VuZXJhdGVkCgkvLyB3aXRob3V0IGEgLndoaWNoIG9uZSBpcyBkZWZpbmVkCglpZiAoIHQuc2VhcmNoKC9tb3VzZShkb3dufHVwKXxjbGljay8pID4gLTEgJiYgIWV2ZW50LndoaWNoICkgewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoIGN0ICYmIGN0Lmxlbmd0aCApID8gY3RbIDAgXSA6IHVuZGVmaW5lZCApOwoKCQlpZiAoIHRvdWNoICkgewoJCQlmb3IgKCBqID0gMCwgbGVuID0gdG91Y2hFdmVudFByb3BzLmxlbmd0aDsgaiA8IGxlbjsgaisrKSB7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQlyZXNldFRpbWVySUQgPSAwOwoJCWVuYWJsZU1vdXNlQmluZGluZ3MoKTsKCX0sICQudm1vdXNlLnJlc2V0VGltZXJEdXJhdGlvbiApOwp9CgpmdW5jdGlvbiBjbGVhclJlc2V0VGltZXIoKSB7CglpZiAoIHJlc2V0VGltZXJJRCApIHsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICksCgkJdmU7CgoJaWYgKCAhYmxvY2tNb3VzZVRyaWdnZXJzICYmICggIWxhc3RUb3VjaElEIHx8IGxhc3RUb3VjaElEICE9PSB0b3VjaElEICkgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidiIgKyBldmVudC50eXBlLCBldmVudCApOwoJCWlmICggdmUgKSB7CgkJCWlmICggdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCWlmICggdmUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJCWlmICggdmUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KCBldmVudCApIHsKCgl2YXIgdG91Y2hlcyA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXMsCgkJdGFyZ2V0LCBmbGFncywgdDsKCglpZiAoIHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPT09IDEgKSB7CgoJCXRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIHRhcmdldCApOwoKCQlpZiAoIGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nICkgewoKCQkJbGFzdFRvdWNoSUQgPSBuZXh0VG91Y2hJRCsrOwoJCQkkLmRhdGEoIHRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUsIGxhc3RUb3VjaElEICk7CgoJCQljbGVhclJlc2V0VGltZXIoKTsKCgkJCWRpc2FibGVNb3VzZUJpbmRpbmdzKCk7CgkJCWRpZFNjcm9sbCA9IGZhbHNlOwoKCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXTsKCQkJc3RhcnRYID0gdC5wYWdlWDsKCQkJc3RhcnRZID0gdC5wYWdlWTsKCgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdmVyIiwgZXZlbnQsIGZsYWdzICk7CgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vkb3duIiwgZXZlbnQsIGZsYWdzICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVTY3JvbGwoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApICk7Cgl9CgoJZGlkU2Nyb2xsID0gdHJ1ZTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdLAoJCWRpZENhbmNlbCA9IGRpZFNjcm9sbCwKCQltb3ZlVGhyZXNob2xkID0gJC52bW91c2UubW92ZURpc3RhbmNlVGhyZXNob2xkLAoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICk7CgoJCWRpZFNjcm9sbCA9IGRpZFNjcm9sbCB8fAoJCQkoIE1hdGguYWJzKCB0LnBhZ2VYIC0gc3RhcnRYICkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyggdC5wYWdlWSAtIHN0YXJ0WSApID4gbW92ZVRocmVzaG9sZCApOwoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdmUsIHQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbigvKiBkYXRhLCBuYW1lc3BhY2UgKi8pIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKC8qIGRhdGEsIG5hbWVzcGFjZSAqLykgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGhlc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciAkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJCXN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCgkvLyBzZXR1cCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCwgYnViYmxlICkgewoJCXZhciBvcmlnaW5hbFR5cGUgPSBldmVudC50eXBlOwoJCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgkJaWYgKCBidWJibGUgKSB7CgkJCSQuZXZlbnQudHJpZ2dlciggZXZlbnQsIHVuZGVmaW5lZCwgb2JqICk7CgkJfSBlbHNlIHsKCQkJJC5ldmVudC5kaXNwYXRjaC5jYWxsKCBvYmosIGV2ZW50ICk7CgkJfQoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCXNjcm9sbGluZywKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJCX0KCgkJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCQl9LCA1MCApOwoJCQl9KTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLnVuYmluZCggc2Nyb2xsRXZlbnQgKTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyB0YXBob2xkCgkkLmV2ZW50LnNwZWNpYWwudGFwID0gewoJCXRhcGhvbGRUaHJlc2hvbGQ6IDc1MCwKCQllbWl0VGFwT25UYXBob2xkOiB0cnVlLAoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlpc1RhcGhvbGQgPSBmYWxzZTsKCgkJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaXNUYXBob2xkID0gZmFsc2U7CgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCAhaXNUYXBob2xkICYmIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9IGVsc2UgaWYgKCBpc1RhcGhvbGQgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKQoJCQkJCS5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICk7CgkJCQkkZG9jdW1lbnQuYmluZCggInZtb3VzZWNhbmNlbCIsIGNsZWFyVGFwSGFuZGxlcnMgKTsKCgkJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC50YXAuZW1pdFRhcE9uVGFwaG9sZCApIHsKCQkJCQkJaXNUYXBob2xkID0gdHJ1ZTsKCQkJCQl9CgkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwaG9sZCIsICQuRXZlbnQoICJ0YXBob2xkIiwgeyB0YXJnZXQ6IG9yaWdUYXJnZXQgfSApICk7CgkJCQl9LCAkLmV2ZW50LnNwZWNpYWwudGFwLnRhcGhvbGRUaHJlc2hvbGQgKTsKCQkJfSk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS51bmJpbmQoICJ2bW91c2Vkb3duIiApLnVuYmluZCggInZjbGljayIgKS51bmJpbmQoICJ2bW91c2V1cCIgKTsKCQkJJGRvY3VtZW50LnVuYmluZCggInZtb3VzZWNhbmNlbCIgKTsKCQl9Cgl9OwoKCS8vIEFsc28gaGFuZGxlcyBzd2lwZWxlZnQsIHN3aXBlcmlnaHQKCSQuZXZlbnQuc3BlY2lhbC5zd2lwZSA9IHsKCgkJLy8gTW9yZSB0aGFuIHRoaXMgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQsIGFuZCB3ZSB3aWxsIHN1cHByZXNzIHNjcm9sbGluZy4KCQlzY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkOiAzMCwKCgkJLy8gTW9yZSB0aW1lIHRoYW4gdGhpcywgYW5kIGl0IGlzbid0IGEgc3dpcGUuCgkJZHVyYXRpb25UaHJlc2hvbGQ6IDEwMDAsCgoJCS8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwKCgkJLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgkJdmVydGljYWxEaXN0YW5jZVRocmVzaG9sZDogMzAsCgoJCWdldExvY2F0aW9uOiBmdW5jdGlvbiAoIGV2ZW50ICkgewoJCQl2YXIgd2luUGFnZVggPSB3aW5kb3cucGFnZVhPZmZzZXQsCgkJCQl3aW5QYWdlWSA9IHdpbmRvdy5wYWdlWU9mZnNldCwKCQkJCXggPSBldmVudC5jbGllbnRYLAoJCQkJeSA9IGV2ZW50LmNsaWVudFk7CgoJCQlpZiAoIGV2ZW50LnBhZ2VZID09PSAwICYmIE1hdGguZmxvb3IoIHkgKSA+IE1hdGguZmxvb3IoIGV2ZW50LnBhZ2VZICkgfHwKCQkJCWV2ZW50LnBhZ2VYID09PSAwICYmIE1hdGguZmxvb3IoIHggKSA+IE1hdGguZmxvb3IoIGV2ZW50LnBhZ2VYICkgKSB7CgoJCQkJLy8gaU9TNCBjbGllbnRYL2NsaWVudFkgaGF2ZSB0aGUgdmFsdWUgdGhhdCBzaG91bGQgaGF2ZSBiZWVuCgkJCQkvLyBpbiBwYWdlWC9wYWdlWS4gV2hpbGUgcGFnZVgvcGFnZS8gaGF2ZSB0aGUgdmFsdWUgMAoJCQkJeCA9IHggLSB3aW5QYWdlWDsKCQkJCXkgPSB5IC0gd2luUGFnZVk7CgkJCX0gZWxzZSBpZiAoIHkgPCAoIGV2ZW50LnBhZ2VZIC0gd2luUGFnZVkpIHx8IHggPCAoIGV2ZW50LnBhZ2VYIC0gd2luUGFnZVggKSApIHsKCgkJCQkvLyBTb21lIEFuZHJvaWQgYnJvd3NlcnMgaGF2ZSB0b3RhbGx5IGJvZ3VzIHZhbHVlcyBmb3IgY2xpZW50WC9ZCgkJCQkvLyB3aGVuIHNjcm9sbGluZy96b29taW5nIGEgcGFnZS4gRGV0ZWN0YWJsZSBzaW5jZSBjbGllbnRYL2NsaWVudFkKCQkJCS8vIHNob3VsZCBuZXZlciBiZSBzbWFsbGVyIHRoYW4gcGFnZVgvcGFnZVkgbWludXMgcGFnZSBzY3JvbGwKCQkJCXggPSBldmVudC5wYWdlWCAtIHdpblBhZ2VYOwoJCQkJeSA9IGV2ZW50LnBhZ2VZIC0gd2luUGFnZVk7CgkJCX0KCgkJCXJldHVybiB7CgkJCQl4OiB4LAoJCQkJeTogeQoJCQl9OwoJCX0sCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50LAoJCQkJbG9jYXRpb24gPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZ2V0TG9jYXRpb24oIGRhdGEgKTsKCQkJcmV0dXJuIHsKCQkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCQljb29yZHM6IFsgbG9jYXRpb24ueCwgbG9jYXRpb24ueSBdLAoJCQkJCQlvcmlnaW46ICQoIGV2ZW50LnRhcmdldCApCgkJCQkJfTsKCQl9LAoKCQlzdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50LAoJCQkJbG9jYXRpb24gPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZ2V0TG9jYXRpb24oIGRhdGEgKTsKCQkJcmV0dXJuIHsKCQkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCQljb29yZHM6IFsgbG9jYXRpb24ueCwgbG9jYXRpb24ueSBdCgkJCQkJfTsKCQl9LAoKCQloYW5kbGVTd2lwZTogZnVuY3Rpb24oIHN0YXJ0LCBzdG9wLCB0aGlzT2JqZWN0LCBvcmlnVGFyZ2V0ICkgewoJCQlpZiAoIHN0b3AudGltZSAtIHN0YXJ0LnRpbWUgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZHVyYXRpb25UaHJlc2hvbGQgJiYKCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQgJiYKCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDEgXSAtIHN0b3AuY29vcmRzWyAxIF0gKSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS52ZXJ0aWNhbERpc3RhbmNlVGhyZXNob2xkICkgewoJCQkJdmFyIGRpcmVjdGlvbiA9IHN0YXJ0LmNvb3Jkc1swXSA+IHN0b3AuY29vcmRzWyAwIF0gPyAic3dpcGVsZWZ0IiA6ICJzd2lwZXJpZ2h0IjsKCgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJzd2lwZSIsICQuRXZlbnQoICJzd2lwZSIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0LCBzd2lwZXN0YXJ0OiBzdGFydCwgc3dpcGVzdG9wOiBzdG9wIH0pLCB0cnVlICk7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIGRpcmVjdGlvbiwkLkV2ZW50KCBkaXJlY3Rpb24sIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0LCBzd2lwZXN0YXJ0OiBzdGFydCwgc3dpcGVzdG9wOiBzdG9wIH0gKSwgdHJ1ZSApOwoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoKCQl9LAoKCQkvLyBUaGlzIHNlcnZlcyBhcyBhIGZsYWcgdG8gZW5zdXJlIHRoYXQgYXQgbW9zdCBvbmUgc3dpcGUgZXZlbnQgZXZlbnQgaXMKCQkvLyBpbiB3b3JrIGF0IGFueSBnaXZlbiB0aW1lCgkJZXZlbnRJblByb2dyZXNzOiBmYWxzZSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgZXZlbnRzLAoJCQkJdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCWNvbnRleHQgPSB7fTsKCgkJCS8vIFJldHJpZXZlIHRoZSBldmVudHMgZGF0YSBmb3IgdGhpcyBlbGVtZW50IGFuZCBhZGQgdGhlIHN3aXBlIGNvbnRleHQKCQkJZXZlbnRzID0gJC5kYXRhKCB0aGlzLCAibW9iaWxlLWV2ZW50cyIgKTsKCQkJaWYgKCAhZXZlbnRzICkgewoJCQkJZXZlbnRzID0geyBsZW5ndGg6IDAgfTsKCQkJCSQuZGF0YSggdGhpcywgIm1vYmlsZS1ldmVudHMiLCBldmVudHMgKTsKCQkJfQoJCQlldmVudHMubGVuZ3RoKys7CgkJCWV2ZW50cy5zd2lwZSA9IGNvbnRleHQ7CgoJCQljb250ZXh0LnN0YXJ0ID0gZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCS8vIEJhaWwgaWYgd2UncmUgYWxyZWFkeSB3b3JraW5nIG9uIGEgc3dpcGUgZXZlbnQKCQkJCWlmICggJC5ldmVudC5zcGVjaWFsLnN3aXBlLmV2ZW50SW5Qcm9ncmVzcyApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQkkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZXZlbnRJblByb2dyZXNzID0gdHJ1ZTsKCgkJCQl2YXIgc3RvcCwKCQkJCQlzdGFydCA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zdGFydCggZXZlbnQgKSwKCQkJCQlvcmlnVGFyZ2V0ID0gZXZlbnQudGFyZ2V0LAoJCQkJCWVtaXR0ZWQgPSBmYWxzZTsKCgkJCQljb250ZXh0Lm1vdmUgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCAhc3RhcnQgfHwgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCXN0b3AgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RvcCggZXZlbnQgKTsKCQkJCQlpZiAoICFlbWl0dGVkICkgewoJCQkJCQllbWl0dGVkID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhhbmRsZVN3aXBlKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApOwoJCQkJCQlpZiAoIGVtaXR0ZWQgKSB7CgoJCQkJCQkJLy8gUmVzZXQgdGhlIGNvbnRleHQgdG8gbWFrZSB3YXkgZm9yIHRoZSBuZXh0IHN3aXBlIGV2ZW50CgkJCQkJCQkkLmV2ZW50LnNwZWNpYWwuc3dpcGUuZXZlbnRJblByb2dyZXNzID0gZmFsc2U7CgkJCQkJCX0KCQkJCQl9CgkJCQkJLy8gcHJldmVudCBzY3JvbGxpbmcKCQkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0KCQkJCX07CgoJCQkJY29udGV4dC5zdG9wID0gZnVuY3Rpb24oKSB7CgkJCQkJCWVtaXR0ZWQgPSB0cnVlOwoKCQkJCQkJLy8gUmVzZXQgdGhlIGNvbnRleHQgdG8gbWFrZSB3YXkgZm9yIHRoZSBuZXh0IHN3aXBlIGV2ZW50CgkJCQkJCSQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ldmVudEluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJCQkJJGRvY3VtZW50Lm9mZiggdG91Y2hNb3ZlRXZlbnQsIGNvbnRleHQubW92ZSApOwoJCQkJCQljb250ZXh0Lm1vdmUgPSBudWxsOwoJCQkJfTsKCgkJCQkkZG9jdW1lbnQub24oIHRvdWNoTW92ZUV2ZW50LCBjb250ZXh0Lm1vdmUgKQoJCQkJCS5vbmUoIHRvdWNoU3RvcEV2ZW50LCBjb250ZXh0LnN0b3AgKTsKCQkJfTsKCQkJJHRoaXMub24oIHRvdWNoU3RhcnRFdmVudCwgY29udGV4dC5zdGFydCApOwoJCX0sCgoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJdmFyIGV2ZW50cywgY29udGV4dDsKCgkJCWV2ZW50cyA9ICQuZGF0YSggdGhpcywgIm1vYmlsZS1ldmVudHMiICk7CgkJCWlmICggZXZlbnRzICkgewoJCQkJY29udGV4dCA9IGV2ZW50cy5zd2lwZTsKCQkJCWRlbGV0ZSBldmVudHMuc3dpcGU7CgkJCQlldmVudHMubGVuZ3RoLS07CgkJCQlpZiAoIGV2ZW50cy5sZW5ndGggPT09IDAgKSB7CgkJCQkJJC5yZW1vdmVEYXRhKCB0aGlzLCAibW9iaWxlLWV2ZW50cyIgKTsKCQkJCX0KCQkJfQoKCQkJaWYgKCBjb250ZXh0ICkgewoJCQkJaWYgKCBjb250ZXh0LnN0YXJ0ICkgewoJCQkJCSQoIHRoaXMgKS5vZmYoIHRvdWNoU3RhcnRFdmVudCwgY29udGV4dC5zdGFydCApOwoJCQkJfQoJCQkJaWYgKCBjb250ZXh0Lm1vdmUgKSB7CgkJCQkJJGRvY3VtZW50Lm9mZiggdG91Y2hNb3ZlRXZlbnQsIGNvbnRleHQubW92ZSApOwoJCQkJfQoJCQkJaWYgKCBjb250ZXh0LnN0b3AgKSB7CgkJCQkJJGRvY3VtZW50Lm9mZiggdG91Y2hTdG9wRXZlbnQsIGNvbnRleHQuc3RvcCApOwoJCQkJfQoJCQl9CgkJfQoJfTsKCSQuZWFjaCh7CgkJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCQl0YXBob2xkOiAidGFwIiwKCQlzd2lwZWxlZnQ6ICJzd2lwZS5sZWZ0IiwKCQlzd2lwZXJpZ2h0OiAic3dpcGUucmlnaHQiCgl9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCQkkLmV2ZW50LnNwZWNpYWxbIGV2ZW50IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoIHNvdXJjZUV2ZW50ICk7CgkJCX0KCQl9OwoJfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoKCS8vIHRocm90dGxlZCByZXNpemUgZXZlbnQKCShmdW5jdGlvbiggJCApIHsKCQkkLmV2ZW50LnNwZWNpYWwudGhyb3R0bGVkcmVzaXplID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLnVuYmluZCggInJlc2l6ZSIsIGhhbmRsZXIgKTsKCQkJfQoJCX07CgoJCXZhciB0aHJvdHRsZSA9IDI1MCwKCQkJaGFuZGxlciA9IGZ1bmN0aW9uKCkgewoJCQkJY3VyciA9ICggbmV3IERhdGUoKSApLmdldFRpbWUoKTsKCQkJCWRpZmYgPSBjdXJyIC0gbGFzdENhbGw7CgoJCQkJaWYgKCBkaWZmID49IHRocm90dGxlICkgewoKCQkJCQlsYXN0Q2FsbCA9IGN1cnI7CgkJCQkJJCggdGhpcyApLnRyaWdnZXIoICJ0aHJvdHRsZWRyZXNpemUiICk7CgoJCQkJfSBlbHNlIHsKCgkJCQkJaWYgKCBoZWxkQ2FsbCApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBoZWxkQ2FsbCApOwoJCQkJCX0KCgkJCQkJLy8gUHJvbWlzZSBhIGhlbGQgY2FsbCB3aWxsIHN0aWxsIGV4ZWN1dGUKCQkJCQloZWxkQ2FsbCA9IHNldFRpbWVvdXQoIGhhbmRsZXIsIHRocm90dGxlIC0gZGlmZiApOwoJCQkJfQoJCQl9LAoJCQlsYXN0Q2FsbCA9IDAsCgkJCWhlbGRDYWxsLAoJCQljdXJyLAoJCQlkaWZmOwoJfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJdmFyIHdpbiA9ICQoIHdpbmRvdyApLAoJCWV2ZW50X25hbWUgPSAib3JpZW50YXRpb25jaGFuZ2UiLAoJCWdldF9vcmllbnRhdGlvbiwKCQlsYXN0X29yaWVudGF0aW9uLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlLAoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCwKCQlwb3J0cmFpdF9tYXAgPSB7ICIwIjogdHJ1ZSwgIjE4MCI6IHRydWUgfSwKCQl3dywgd2gsIGxhbmRzY2FwZV90aHJlc2hvbGQ7CgoJLy8gSXQgc2VlbXMgdGhhdCBzb21lIGRldmljZS9icm93c2VyIHZlbmRvcnMgdXNlIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZXMgMCBhbmQgMTgwIHRvCgkvLyBkZW5vdGUgdGhlICJkZWZhdWx0IiBvcmllbnRhdGlvbi4gRm9yIGlPUyBkZXZpY2VzLCBhbmQgbW9zdCBvdGhlciBzbWFydC1waG9uZXMgdGVzdGVkLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgYWx3YXlzICJwb3J0cmFpdCIsIGJ1dCBpbiBzb21lIEFuZHJvaWQgYW5kIFJJTSBiYXNlZCB0YWJsZXRzLAoJLy8gdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gaXMgImxhbmRzY2FwZSIuIFRoZSBmb2xsb3dpbmcgY29kZSBhdHRlbXB0cyB0byB1c2UgdGhlIHdpbmRvdwoJLy8gZGltZW5zaW9ucyB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gaXMsIGFuZCB0aGVuIG1ha2VzIGFkanVzdG1lbnRzCgkvLyB0byB0aGUgdG8gdGhlIHBvcnRyYWl0X21hcCBpZiBuZWNlc3NhcnksIHNvIHRoYXQgd2UgY2FuIHByb3Blcmx5IGRlY29kZSB0aGUKCS8vIHdpbmRvdy5vcmllbnRhdGlvbiB2YWx1ZSB3aGVuZXZlciBnZXRfb3JpZW50YXRpb24oKSBpcyBjYWxsZWQuCgkvLwoJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIGEgbWVkaWEgcXVlcnkgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBvcmllbnRhdGlvbiB0aGUgYnJvd3NlcgoJLy8gdGhpbmtzIGl0IGlzIGluOgoJLy8KCS8vICAgICBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9ICQubW9iaWxlLm1lZGlhKCJhbGwgYW5kIChvcmllbnRhdGlvbjogbGFuZHNjYXBlKSIpOwoJLy8KCS8vIGJ1dCB0aGVyZSB3YXMgYW4gaVBob25lL2lQb2QgVG91Y2ggYnVnIGJlZ2lubmluZyB3aXRoIGlPUyA0LjIsIHVwIHRocm91Z2ggaU9TIDUuMSwKCS8vIHdoZXJlIHRoZSBicm93c2VyICpBTFdBWVMqIGFwcGxpZWQgdGhlIGxhbmRzY2FwZSBtZWRpYSBxdWVyeS4gVGhpcyBidWcgZG9lcyBub3QKCS8vIGhhcHBlbiBvbiBpUGFkLgoKCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoKCQkvLyBDaGVjayB0aGUgd2luZG93IHdpZHRoIGFuZCBoZWlnaHQgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uCgkJLy8gb2YgdGhlIGRldmljZSBpcyBhdCB0aGlzIG1vbWVudC4gTm90ZSB0aGF0IHdlJ3ZlIGluaXRpYWxpemVkIHRoZSBwb3J0cmFpdCBtYXAKCQkvLyB2YWx1ZXMgdG8gMCBhbmQgMTgwLCAqQU5EKiB3ZSBwdXJwb3NlbHkgY2hlY2sgZm9yIGxhbmRzY2FwZSBzbyB0aGF0IGlmIHdlIGd1ZXNzCgkJLy8gd3JvbmcsICwgd2UgZGVmYXVsdCB0byB0aGUgYXNzdW1wdGlvbiB0aGF0IHBvcnRyYWl0IGlzIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uLgoJCS8vIFdlIHVzZSBhIHRocmVzaG9sZCBjaGVjayBiZWxvdyBiZWNhdXNlIG9uIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TLCB0aGUgaVBob25lCgkJLy8gZm9ybS1mYWN0b3IgY2FuIHJlcG9ydCBhIGxhcmdlciB3aWR0aCB0aGFuIGhlaWdodCBpZiB0aGUgdXNlciB0dXJucyBvbiB0aGUKCQkvLyBkZXZlbG9wZXIgY29uc29sZS4gVGhlIGFjdHVhbCB0aHJlc2hvbGQgdmFsdWUgaXMgc29tZXdoYXQgYXJiaXRyYXJ5LCB3ZSBqdXN0CgkJLy8gbmVlZCB0byBtYWtlIHN1cmUgaXQgaXMgbGFyZ2UgZW5vdWdoIHRvIGV4Y2x1ZGUgdGhlIGRldmVsb3BlciBjb25zb2xlIGNhc2UuCgoJCXd3ID0gd2luZG93LmlubmVyV2lkdGggfHwgd2luLndpZHRoKCk7CgkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgd2luLmhlaWdodCgpOwoJCWxhbmRzY2FwZV90aHJlc2hvbGQgPSA1MDsKCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSB3dyA+IHdoICYmICggd3cgLSB3aCApID4gbGFuZHNjYXBlX3RocmVzaG9sZDsKCgkJLy8gTm93IGNoZWNrIHRvIHNlZSBpZiB0aGUgY3VycmVudCB3aW5kb3cub3JpZW50YXRpb24gaXMgMCBvciAxODAuCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCgkJLy8gSWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgbGFuZHNjYXBlLCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgMCBvciAxODAsICpPUioKCQkvLyBpZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBwb3J0cmFpdCwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDkwIG9yIC05MCwgd2UKCQkvLyBuZWVkIHRvIGZsaXAgb3VyIHBvcnRyYWl0X21hcCB2YWx1ZXMgYmVjYXVzZSBsYW5kc2NhcGUgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gZm9yCgkJLy8gdGhpcyBkZXZpY2UvYnJvd3Nlci4KCQlpZiAoICggaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgfHwgKCAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgIWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApICkgewoJCQlwb3J0cmFpdF9tYXAgPSB7ICItOTAiOiB0cnVlLCAiOTAiOiB0cnVlIH07CgkJfQoJfQoKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSA9ICQuZXh0ZW5kKCB7fSwgJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLCB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdCBqUXVlcnkKCQkJLy8gd2lsbCBiaW5kIHRvIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdAoJCQkvLyBqUXVlcnkgd2lsbCB1bmJpbmQgdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCB1bmJpbmQgdGhlCgkJCS8vIHJlc2l6ZSBldmVudCBoYW5kbGVyLgoJCQl3aW4udW5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJYWRkOiBmdW5jdGlvbiggaGFuZGxlT2JqICkgewoJCQkvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBib3VuZCBldmVudCBoYW5kbGVyLgoJCQl2YXIgb2xkX2hhbmRsZXIgPSBoYW5kbGVPYmouaGFuZGxlcjsKCgkJCWhhbmRsZU9iai5oYW5kbGVyID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJLy8gTW9kaWZ5IGV2ZW50IG9iamVjdCwgYWRkaW5nIHRoZSAub3JpZW50YXRpb24gcHJvcGVydHkuCgkJCQlldmVudC5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQkJCS8vIENhbGwgdGhlIG9yaWdpbmFsbHktYm91bmQgZXZlbnQgaGFuZGxlciBhbmQgcmV0dXJuIGl0cyByZXN1bHQuCgkJCQlyZXR1cm4gb2xkX2hhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9OwoJCX0KCX0pOwoKCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGlzIGhhbmRsZXIgd2lsbCBiZSBib3VuZCB0bwoJLy8gdGhlIHdpbmRvdyByZXNpemUgZXZlbnQgdG8gc2ltdWxhdGUgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJZnVuY3Rpb24gaGFuZGxlcigpIHsKCQkvLyBHZXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24uCgkJdmFyIG9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCWlmICggb3JpZW50YXRpb24gIT09IGxhc3Rfb3JpZW50YXRpb24gKSB7CgkJCS8vIFRoZSBvcmllbnRhdGlvbiBoYXMgY2hhbmdlZCwgc28gdHJpZ2dlciB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBvcmllbnRhdGlvbjsKCQkJd2luLnRyaWdnZXIoIGV2ZW50X25hbWUgKTsKCQl9Cgl9CgoJLy8gR2V0IHRoZSBjdXJyZW50IHBhZ2Ugb3JpZW50YXRpb24uIFRoaXMgbWV0aG9kIGlzIGV4cG9zZWQgcHVibGljbHksIHNob3VsZCBpdAoJLy8gYmUgbmVlZGVkLCBhcyBqUXVlcnkuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbigpCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24gPSBmdW5jdGlvbigpIHsKCQl2YXIgaXNQb3J0cmFpdCA9IHRydWUsIGVsZW0gPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgoJCS8vIHByZWZlciB3aW5kb3cgb3JpZW50YXRpb24gdG8gdGhlIGNhbGN1bGF0aW9uIGJhc2VkIG9uIHNjcmVlbnNpemUgYXMKCQkvLyB0aGUgYWN0dWFsIHNjcmVlbiByZXNpemUgdGFrZXMgcGxhY2UgYmVmb3JlIG9yIGFmdGVyIHRoZSBvcmllbnRhdGlvbiBjaGFuZ2UgZXZlbnQKCQkvLyBoYXMgYmVlbiBmaXJlZCBkZXBlbmRpbmcgb24gaW1wbGVtZW50YXRpb24gKGVnIGFuZHJvaWQgMi4zIGlzIGJlZm9yZSwgaXBob25lIGFmdGVyKS4KCQkvLyBNb3JlIHRlc3RpbmcgaXMgcmVxdWlyZWQgdG8gZGV0ZXJtaW5lIGlmIGEgbW9yZSByZWxpYWJsZSBtZXRob2Qgb2YgZGV0ZXJtaW5pbmcgdGhlIG5ldyBzY3JlZW5zaXplCgkJLy8gaXMgcG9zc2libGUgd2hlbiBvcmllbnRhdGlvbmNoYW5nZSBpcyBmaXJlZC4gKGVnLCB1c2UgbWVkaWEgcXVlcmllcyArIGVsZW1lbnQgKyBvcGFjaXR5KQoJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoJCQkvLyBpZiB0aGUgd2luZG93IG9yaWVudGF0aW9uIHJlZ2lzdGVycyBhcyAwIG9yIDE4MCBkZWdyZWVzIHJlcG9ydAoJCQkvLyBwb3J0cmFpdCwgb3RoZXJ3aXNlIGxhbmRzY2FwZQoJCQlpc1BvcnRyYWl0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCQl9IGVsc2UgewoJCQlpc1BvcnRyYWl0ID0gZWxlbSAmJiBlbGVtLmNsaWVudFdpZHRoIC8gZWxlbS5jbGllbnRIZWlnaHQgPCAxLjE7CgkJfQoKCQlyZXR1cm4gaXNQb3J0cmFpdCA/ICJwb3J0cmFpdCIgOiAibGFuZHNjYXBlIjsKCX07CgoJJC5mblsgZXZlbnRfbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCXJldHVybiBmbiA/IHRoaXMuYmluZCggZXZlbnRfbmFtZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggZXZlbnRfbmFtZSApOwoJfTsKCgkvLyBqUXVlcnkgPCAxLjgKCWlmICggJC5hdHRyRm4gKSB7CgkJJC5hdHRyRm5bIGV2ZW50X25hbWUgXSA9IHRydWU7Cgl9Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvLyBleGlzdGluZyBiYXNlIHRhZz8KCXZhciBiYXNlRWxlbWVudCA9ICQoICJoZWFkIiApLmNoaWxkcmVuKCAiYmFzZSIgKSwKCgkvLyBiYXNlIGVsZW1lbnQgbWFuYWdlbWVudCwgZGVmaW5lZCBkZXBlbmRpbmcgb24gZHluYW1pYyBiYXNlIHRhZyBzdXBwb3J0CgkvLyBUT0RPIG1vdmUgdG8gZXh0ZXJuYWwgd2lkZ2V0CgliYXNlID0gewoKCQkvLyBkZWZpbmUgYmFzZSBlbGVtZW50LCBmb3IgdXNlIGluIHJvdXRpbmcgYXNzZXQgdXJscyB0aGF0IGFyZSByZWZlcmVuY2VkCgkJLy8gaW4gQWpheC1yZXF1ZXN0ZWQgbWFya3VwCgkJZWxlbWVudDogKCBiYXNlRWxlbWVudC5sZW5ndGggPyBiYXNlRWxlbWVudCA6CgkJCSQoICI8YmFzZT4iLCB7IGhyZWY6ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggfSApLnByZXBlbmRUbyggJCggImhlYWQiICkgKSApLAoKCQlsaW5rU2VsZWN0b3I6ICJbc3JjXSwgbGlua1tocmVmXSwgYVtyZWw9J2V4dGVybmFsJ10sIDpqcW1EYXRhKGFqYXg9J2ZhbHNlJyksIGFbdGFyZ2V0XSIsCgoJCS8vIHNldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCXNldDogZnVuY3Rpb24oIGhyZWYgKSB7CgoJCQkvLyB3ZSBzaG91bGQgZG8gbm90aGluZyBpZiB0aGUgdXNlciB3YW50cyB0byBtYW5hZ2UgdGhlaXIgdXJsIGJhc2UKCQkJLy8gbWFudWFsbHkKCQkJaWYgKCAhJC5tb2JpbGUuZHluYW1pY0Jhc2VFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyB3ZSBzaG91bGQgdXNlIHRoZSBiYXNlIHRhZyBpZiB3ZSBjYW4gbWFuaXB1bGF0ZSBpdCBkeW5hbWljYWxseQoJCQlpZiAoICQuc3VwcG9ydC5keW5hbWljQmFzZVRhZyApIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsCgkJCQkJJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlICkgKTsKCQkJfQoJCX0sCgoJCXJld3JpdGU6IGZ1bmN0aW9uKCBocmVmLCBwYWdlICkgewoJCQl2YXIgbmV3UGF0aCA9ICQubW9iaWxlLnBhdGguZ2V0KCBocmVmICk7CgoJCQlwYWdlLmZpbmQoIGJhc2UubGlua1NlbGVjdG9yICkuZWFjaChmdW5jdGlvbiggaSwgbGluayApIHsKCQkJCXZhciB0aGlzQXR0ciA9ICQoIGxpbmsgKS5pcyggIltocmVmXSIgKSA/ICJocmVmIiA6CgkJCQkJJCggbGluayApLmlzKCAiW3NyY10iICkgPyAic3JjIiA6ICJhY3Rpb24iLAoJCQkJdGhlTG9jYXRpb24gPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKSwKCQkJCXRoaXNVcmwgPSAkKCBsaW5rICkuYXR0ciggdGhpc0F0dHIgKTsKCgkJCQkvLyBYWFhfamJsYXM6IFdlIG5lZWQgdG8gZml4IHRoaXMgc28gdGhhdCBpdCByZW1vdmVzIHRoZSBkb2N1bWVudAoJCQkJLy8gICAgICAgICAgICBiYXNlIFVSTCwgYW5kIHRoZW4gcHJlcGVuZHMgd2l0aCB0aGUgbmV3IHBhZ2UgVVJMLgoJCQkJLy8gaWYgZnVsbCBwYXRoIGV4aXN0cyBhbmQgaXMgc2FtZSwgY2hvcCBpdCAtIGhlbHBzIElFIG91dAoJCQkJdGhpc1VybCA9IHRoaXNVcmwucmVwbGFjZSggdGhlTG9jYXRpb24ucHJvdG9jb2wgKyB0aGVMb2NhdGlvbi5kb3VibGVTbGFzaCArCgkJCQkJdGhlTG9jYXRpb24uaG9zdCArIHRoZUxvY2F0aW9uLnBhdGhuYW1lLCAiIiApOwoKCQkJCWlmICggIS9eKFx3Kzp8I3xcLykvLnRlc3QoIHRoaXNVcmwgKSApIHsKCQkJCQkkKCBsaW5rICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIHNldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCXJlc2V0OiBmdW5jdGlvbigvKiBocmVmICovKSB7CgkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb1NlYXJjaCApOwoJCX0KCX07CgoJJC5tb2JpbGUuYmFzZSA9IGJhc2U7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CiQubW9iaWxlLndpZGdldHMgPSB7fTsKCnZhciBvcmlnaW5hbFdpZGdldCA9ICQud2lkZ2V0LAoKCS8vIFJlY29yZCB0aGUgb3JpZ2luYWwsIG5vbi1tb2JpbGVpbml0LW1vZGlmaWVkIHZlcnNpb24gb2YgJC5tb2JpbGUua2VlcE5hdGl2ZQoJLy8gc28gd2UgY2FuIGxhdGVyIGRldGVybWluZSB3aGV0aGVyIHNvbWVvbmUgaGFzIG1vZGlmaWVkICQubW9iaWxlLmtlZXBOYXRpdmUKCWtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9ICQubW9iaWxlLmtlZXBOYXRpdmU7CgokLndpZGdldCA9IChmdW5jdGlvbiggb3JpZyApIHsKCXJldHVybiBmdW5jdGlvbigpIHsKCQl2YXIgY29uc3RydWN0b3IgPSBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJbmFtZSA9IGNvbnN0cnVjdG9yLnByb3RvdHlwZS53aWRnZXROYW1lOwoKCQljb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgPSAoICggY29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciAhPT0gdW5kZWZpbmVkICkgPwoJCQljb25zdHJ1Y3Rvci5wcm90b3R5cGUuaW5pdFNlbGVjdG9yIDogIjpqcW1EYXRhKHJvbGU9JyIgKyBuYW1lICsgIicpIiApOwoKCQkkLm1vYmlsZS53aWRnZXRzWyBuYW1lIF0gPSBjb25zdHJ1Y3RvcjsKCgkJcmV0dXJuIGNvbnN0cnVjdG9yOwoJfTsKfSkoICQud2lkZ2V0ICk7CgovLyBNYWtlIHN1cmUgJC53aWRnZXQgc3RpbGwgaGFzIGJyaWRnZSBhbmQgZXh0ZW5kIG1ldGhvZHMKJC5leHRlbmQoICQud2lkZ2V0LCBvcmlnaW5hbFdpZGdldCApOwoKLy8gRm9yIGJhY2tjb21wYXQgcmVtb3ZlIGluIDEuNQokLm1vYmlsZS5kb2N1bWVudC5vbiggImNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCSQoIGV2ZW50LnRhcmdldCApLmVuaGFuY2VXaXRoaW4oKTsKfSk7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYSIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICQubW9iaWxlLmtlZXBOYXRpdmUsCgoJCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQljb250ZW50VGhlbWU6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCS8vIERFUFJFQ0FURUQgZm9yID4gMS40CgkvLyBUT0RPIHJlbW92ZSBhdCAxLjUKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fY3JlYXRlV2lkZ2V0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl90cmlnZ2VyKCAiaW5pdCIgKTsKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJLy8gSWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY3JlYXRlIiApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LCB7CgkJCXBhZ2ViZWZvcmVoaWRlOiAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IgoJCX0pOwoKCQl0aGlzLmVsZW1lbnQuZW5oYW5jZVdpdGhpbigpOwoJCS8vIERpYWxvZyB3aWRnZXQgaXMgZGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIHRoaXMgaW4gMS41CgkJaWYgKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMuZWxlbWVudFswXSwgInJvbGUiICkgPT09ICJkaWFsb2ciICYmICQubW9iaWxlLmRpYWxvZyApIHsKCQkJdGhpcy5lbGVtZW50LmRpYWxvZygpOwoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uICgpIHsKCQl2YXIgYXR0clByZWZpeCA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXM7CgoJCWlmICggdGhpcy5vcHRpb25zLnJvbGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHRoaXMub3B0aW9ucy5yb2xlICk7CgkJfQoKCQl0aGlzLmVsZW1lbnQKCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCS5hZGRDbGFzcyggInVpLXBhZ2UgdWktcGFnZS10aGVtZS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgoJCS8vIE1hbmlwdWxhdGlvbiBvZiBjb250ZW50IG9zIERlcHJlY2F0ZWQgYXMgb2YgMS40IHJlbW92ZSBpbiAxLjUKCQl0aGlzLmVsZW1lbnQuZmluZCggIlsiICsgYXR0clByZWZpeCArICJyb2xlPSdjb250ZW50J10iICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCXRoZW1lID0gdGhpcy5nZXRBdHRyaWJ1dGUoIGF0dHJQcmVmaXggKyAidGhlbWUiICkgfHwgdW5kZWZpbmVkOwoJCQkJc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSA9IHRoZW1lIHx8IHNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgfHwgKCBzZWxmLm9wdGlvbnMuZGlhbG9nICYmIHNlbGYub3B0aW9ucy50aGVtZSApIHx8ICggc2VsZi5lbGVtZW50LmpxbURhdGEoInJvbGUiKSA9PT0gImRpYWxvZyIgJiYgIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1jb250ZW50IiApOwoJCQkJaWYgKCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lICkgewoJCQkJCSR0aGlzLmFkZENsYXNzKCAidWktYm9keS0iICsgKCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lICkgKTsKCQkJCX0KCQkJCS8vIEFkZCBBUklBIHJvbGUKCQkJCSR0aGlzLmF0dHIoICJyb2xlIiwgIm1haW4iICkuYWRkQ2xhc3MoICJ1aS1jb250ZW50IiApOwoJCX0pOwoJfSwKCgliaW5kUmVtb3ZlOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJdmFyIHBhZ2UgPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIHdoZW4gZG9tIGNhY2hpbmcgaXMgbm90IGVuYWJsZWQgb3IgdGhlIHBhZ2UgaXMgZW1iZWRkZWQgYmluZCB0byByZW1vdmUgdGhlIHBhZ2Ugb24gaGlkZQoJCWlmICggIXBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLm9wdGlvbnMuZG9tQ2FjaGUgJiYKCQkJcGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSApIHsKCgkJCS8vIFRPRE8gdXNlIF9vbiAtIHRoYXQgaXMsIHNvcnQgb3V0IHdoeSBpdCBkb2Vzbid0IHdvcmsgaW4gdGhpcyBjYXNlCgkJCXBhZ2UuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIsIGNhbGxiYWNrIHx8IGZ1bmN0aW9uKCBlLCBkYXRhICkgewoKCQkJCS8vY2hlY2sgaWYgdGhpcyBpcyBhIHNhbWUgcGFnZSB0cmFuc2l0aW9uIGFuZCBpZiBzbyBkb24ndCByZW1vdmUgdGhlIHBhZ2UKCQkJCWlmKCAhZGF0YS5zYW1lUGFnZSApewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG8gKSB7CgkJaWYgKCBvLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLXBhZ2UtdGhlbWUtIiArIHRoaXMub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCAidWktcGFnZS10aGVtZS0iICsgby50aGVtZSApOwoJCX0KCgkJaWYgKCBvLmNvbnRlbnRUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArICI9J2NvbnRlbnQnXSIgKS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy5jb250ZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oLyogZSAqLykgewoJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJfSwKCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiOm1vYmlsZS1wYWdlY29udGFpbmVyIiApLnBhZ2Vjb250YWluZXIoeyAidGhlbWUiOiAibm9uZSIgfSk7Cgl9LAoJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKSB7CgkJdGhpcy5lbGVtZW50LnBhcmVudCgpLnBhZ2Vjb250YWluZXIoIHsgInRoZW1lIjogdGhlbWUgfHwgdGhpcy5vcHRpb25zLnRoZW1lIH0gKTsKCX0sCgkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlID0gJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgfHwgIiIgKSwKCQkJZ2xvYmFsVmFsdWUgPSAkLnRyaW0oICQubW9iaWxlLmtlZXBOYXRpdmUgKSwKCQkJb3B0aW9uVmFsdWUgPSAkLnRyaW0oIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSwKCgkJCS8vIENoZWNrIGlmICQubW9iaWxlLmtlZXBOYXRpdmUgaGFzIGNoYW5nZWQgZnJvbSB0aGUgZmFjdG9yeSBkZWZhdWx0CgkJCW5ld0RlZmF1bHQgPSAoIGtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9PT0gZ2xvYmFsVmFsdWUgPwoJCQkJIiIgOiBnbG9iYWxWYWx1ZSApLAoKCQkJLy8gSWYgJC5tb2JpbGUua2VlcE5hdGl2ZSBoYXMgbm90IGNoYW5nZWQsIHVzZSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0CgkJCW9sZERlZmF1bHQgPSAoIG5ld0RlZmF1bHQgPT09ICIiID8gb3B0aW9uVmFsdWUgOiAiIiApOwoKCQkvLyBDb25jYXRlbmF0ZSBrZWVwTmF0aXZlIHNlbGVjdG9ycyBmcm9tIGFsbCBzb3VyY2VzIHdoZXJlIHRoZSB2YWx1ZSBoYXMKCQkvLyBjaGFuZ2VkIG9yLCBpZiBub3RoaW5nIGhhcyBjaGFuZ2VkLCByZXR1cm4gdGhlIGRlZmF1bHQKCQlyZXR1cm4gKCAoIGtlZXBOYXRpdmUgPyBbIGtlZXBOYXRpdmUgXSA6IFtdICkKCQkJLmNvbmNhdCggbmV3RGVmYXVsdCA/IFsgbmV3RGVmYXVsdCBdIDogW10gKQoJCQkuY29uY2F0KCBvbGREZWZhdWx0ID8gWyBvbGREZWZhdWx0IF0gOiBbXSApCgkJCS5qb2luKCAiLCAiICkgKTsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnBhZ2Vjb250YWluZXIiLCB7CgkJb3B0aW9uczogewoJCQl0aGVtZTogImEiCgkJfSwKCgkJaW5pdFNlbGVjdG9yOiBmYWxzZSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVjcmVhdGUiICk7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCQkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLAoJCQkJLy8gdGhpcyBvbmx5IHdvcmtzIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uCgkJCQkvLyBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlciB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlCgkJCQkvLyBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkJCQluYXZpZ2F0ZTogIl9kaXNhYmxlUmVjb3JkU2Nyb2xsIiwKCgkJCQkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlLCAicGFnZWNoYW5nZSIgd29uJ3QgYmUKCQkJCS8vIGZpcmVkIGluIHRoYXQgY2FzZQoJCQkJc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIgoJCQl9KTsKCgkJCS8vIFRPRE8gY29uc2lkZXIgbW92aW5nIHRoZSBuYXZpZ2F0aW9uIGhhbmRsZXIgT1VUIG9mIHdpZGdldCBpbnRvCgkJCS8vICAgICAgc29tZSBvdGhlciBvYmplY3QgYXMgZ2x1ZSBiZXR3ZWVuIHRoZSBuYXZpZ2F0ZSBldmVudCBhbmQgdGhlCgkJCS8vICAgICAgY29udGVudCB3aWRnZXQgbG9hZCBhbmQgY2hhbmdlIG1ldGhvZHMKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7IG5hdmlnYXRlOiAiX2ZpbHRlck5hdmlnYXRlRXZlbnRzIiB9KTsKCgkJCS8vIFRPRE8gbW92ZSBmcm9tIHBhZ2UqIGV2ZW50cyB0byBjb250ZW50KiBldmVudHMKCQkJdGhpcy5fb24oeyBwYWdlY2hhbmdlOiAiX2FmdGVyQ29udGVudENoYW5nZSIgfSk7CgoJCQkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkJCXRoaXMud2luZG93Lm9uZSggIm5hdmlnYXRlIiwgJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zLnRoZW1lICE9PSAibm9uZSIgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJCS5hZGRDbGFzcyggInVpLW92ZXJsYXktIiArIG9wdGlvbnMudGhlbWUgKTsKCQkJfSBlbHNlIGlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgkJCX0KCgkJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJfSwKCgkJX2Rpc2FibGVSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gZmFsc2U7CgkJfSwKCgkJX2VuYWJsZVJlY29yZFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gY29uc2lkZXIgdGhlIG5hbWUgaGVyZSwgc2luY2UgaXQncyBwdXJwb3NlIHNwZWNpZmljCgkJX2FmdGVyQ29udGVudENoYW5nZTogZnVuY3Rpb24oKSB7CgkJCS8vIG9uY2UgdGhlIHBhZ2UgaGFzIGNoYW5nZWQsIHJlLWVuYWJsZSB0aGUgc2Nyb2xsIHJlY29yZGluZwoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQKCQkJLy8gZGV0ZXJtaW5lZCBmb3IgdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJdGhpcy5fb2ZmKCB0aGlzLndpbmRvdywgInNjcm9sbHN0b3AiICk7CgoJCQkvLyBkZXRlcm1pbmUgYW5kIGJpbmQgdG8gdGhlIGN1cnJlbnQgc2NvbGwgZWxlbWVudCB3aGljaCBtYXkgYmUgdGhlCgkJCS8vIHdpbmRvdyBvciBpbiB0aGUgY2FzZSBvZiB0b3VjaCBvdmVyZmxvdyB0aGUgZWxlbWVudCB0b3VjaCBvdmVyZmxvdwoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIiB9KTsKCQl9LAoKCQlfcmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbgoJCQkvLyB0aGUgYnJvd3NlciBzY3JvbGxpbmcgdGhlIHdpbmRvdyBiYXNlZCBvbiBhIGhhc2hjaGFuZ2UKCQkJaWYgKCAhdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGFjdGl2ZSA9IHRoaXMuX2dldEFjdGl2ZUhpc3RvcnkoKSwKCQkJCWN1cnJlbnRTY3JvbGwsIG1pblNjcm9sbCwgZGVmYXVsdFNjcm9sbDsKCgkJCWlmICggYWN0aXZlICkgewoJCQkJY3VycmVudFNjcm9sbCA9IHRoaXMuX2dldFNjcm9sbCgpOwoJCQkJbWluU2Nyb2xsID0gdGhpcy5fZ2V0TWluU2Nyb2xsKCk7CgkJCQlkZWZhdWx0U2Nyb2xsID0gdGhpcy5fZ2V0RGVmYXVsdFNjcm9sbCgpOwoKCQkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlCgkJCQkvLyBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gY3VycmVudFNjcm9sbCA8IG1pblNjcm9sbCA/IGRlZmF1bHRTY3JvbGwgOiBjdXJyZW50U2Nyb2xsOwoJCQl9CgkJfSwKCgkJX2RlbGF5ZWRSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlzZXRUaW1lb3V0KCAkLnByb3h5KHRoaXMsICJfcmVjb3JkU2Nyb2xsIiksIDEwMCApOwoJCX0sCgoJCV9nZXRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgkJfSwKCgkJX2dldE1pblNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5taW5TY3JvbGxCYWNrOwoJCX0sCgoJCV9nZXREZWZhdWx0U2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCX0sCgoJCV9maWx0ZXJOYXZpZ2F0ZUV2ZW50czogZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJCXZhciB1cmw7CgoJCQlpZiAoIGUub3JpZ2luYWxFdmVudCAmJiBlLm9yaWdpbmFsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXVybCA9IGUub3JpZ2luYWxFdmVudC50eXBlLmluZGV4T2YoICJoYXNoY2hhbmdlIiApID4gLTEgPyBkYXRhLnN0YXRlLmhhc2ggOiBkYXRhLnN0YXRlLnVybDsKCgkJCWlmICggIXVybCApIHsKCQkJCXVybCA9IHRoaXMuX2dldEhhc2goKTsKCQkJfQoKCQkJaWYgKCAhdXJsIHx8IHVybCA9PT0gIiMiIHx8IHVybC5pbmRleE9mKCAiIyIgKyAkLm1vYmlsZS5wYXRoLnVpU3RhdGVLZXkgKSA9PT0gMCApIHsKCQkJCXVybCA9IGxvY2F0aW9uLmhyZWY7CgkJCX0KCgkJCXRoaXMuX2hhbmRsZU5hdmlnYXRlKCB1cmwsIGRhdGEuc3RhdGUgKTsKCQl9LAoKCQlfZ2V0SGFzaDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCX0sCgoJCS8vIFRPRE8gYWN0aXZlIHBhZ2Ugc2hvdWxkIGJlIG1hbmFnZWQgYnkgdGhlIGNvbnRhaW5lciAoaWUsIGl0IHNob3VsZCBiZSBhIHByb3BlcnR5KQoJCWdldEFjdGl2ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5hY3RpdmVQYWdlOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZpcnN0IHBhZ2Ugc2hvdWxkIGJlIGEgcHJvcGVydHkgc2V0IGR1cmluZyBfY3JlYXRlIHVzaW5nIHRoZSBsb2dpYwoJCS8vICAgICAgdGhhdCBjdXJyZW50bHkgcmVzaWRlcyBpbiBpbml0CgkJX2dldEluaXRpYWxDb250ZW50OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmZpcnN0UGFnZTsKCQl9LAoKCQkvLyBUT0RPIGVhY2ggY29udGVudCBjb250YWluZXIgc2hvdWxkIGhhdmUgYSBoaXN0b3J5IG9iamVjdAoJCV9nZXRIaXN0b3J5OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgkJfSwKCgkJX2dldEFjdGl2ZUhpc3Rvcnk6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5fZ2V0SGlzdG9yeSgpLmdldEFjdGl2ZSgpOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGRvY3VtZW50IGJhc2Ugc2hvdWxkIGJlIGRldGVybWluZWQgYXQgY3JlYXRpb24KCQlfZ2V0RG9jdW1lbnRCYXNlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlOwoJCX0sCgoJCWJhY2s6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdvKCAtMSApOwoJCX0sCgoJCWZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdvKCAxICk7CgkJfSwKCgkJZ286IGZ1bmN0aW9uKCBzdGVwcyApIHsKCgkJCS8vaWYgaGFzaGxpc3RlbmluZyBpcyBlbmFibGVkIHVzZSBuYXRpdmUgaGlzdG9yeSBtZXRob2QKCQkJaWYgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCApIHsKCQkJCXdpbmRvdy5oaXN0b3J5LmdvKCBzdGVwcyApOwoJCQl9IGVsc2UgewoKCQkJCS8vd2UgYXJlIG5vdCBsaXN0ZW5pbmcgdG8gdGhlIGhhc2ggc28gaGFuZGxlIGhpc3RvcnkgaW50ZXJuYWxseQoJCQkJdmFyIGFjdGl2ZUluZGV4ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCwKCQkJCQlpbmRleCA9IGFjdGl2ZUluZGV4ICsgcGFyc2VJbnQoIHN0ZXBzLCAxMCApLAoJCQkJCXVybCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnkuc3RhY2tbIGluZGV4IF0udXJsLAoJCQkJCWRpcmVjdGlvbiA9ICggc3RlcHMgPj0gMSApPyAiZm9yd2FyZCIgOiAiYmFjayI7CgoJCQkJLy91cGRhdGUgdGhlIGhpc3Rvcnkgb2JqZWN0CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID0gaW5kZXg7CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnByZXZpb3VzSW5kZXggPSBhY3RpdmVJbmRleDsKCgkJCQkvL2NoYW5nZSB0byB0aGUgbmV3IHBhZ2UKCQkJCXRoaXMuY2hhbmdlKCB1cmwsIHsgZGlyZWN0aW9uOiBkaXJlY3Rpb24sIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCQl9LAoKCQkvLyBUT0RPIHJlbmFtZSBfaGFuZGxlRGVzdGluYXRpb24KCQlfaGFuZGxlRGVzdGluYXRpb246IGZ1bmN0aW9uKCB0byApIHsKCQkJdmFyIGhpc3Rvcnk7CgoJCQkvLyBjbGVhbiB0aGUgaGFzaCBmb3IgY29tcGFyaXNvbiBpZiBpdCdzIGEgdXJsCgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQl0byA9ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCB0byApOwoJCQl9CgoJCQlpZiAoIHRvICkgewoJCQkJaGlzdG9yeSA9IHRoaXMuX2dldEhpc3RvcnkoKTsKCgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UKCQkJCS8vIGVsZW1lbnQgZnJvbSBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlIC8KCQkJCS8vIGFic29sdXRlIFVSTC4gSWYgJ3RvJyBpcyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QKCQkJCS8vIHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwgc2luY2UgdGhlIGhhc2hjaGFuZ2UKCQkJCS8vIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwKCQkJCS8vIHBhZ2UvZGlhbG9nLgoJCQkJLy8KCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdCBvciBwYXRoIG9iamVjdD8KCQkJCXRvID0gISQubW9iaWxlLnBhdGguaXNQYXRoKCB0byApID8gKCAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgdG8sIHRoaXMuX2dldERvY3VtZW50QmFzZSgpICkgKSA6IHRvOwoJCQl9CgkJCXJldHVybiB0byB8fCB0aGlzLl9nZXRJbml0aWFsQ29udGVudCgpOwoJCX0sCgoJCS8vIFRoZSBvcHRpb25zIGJ5IHdoaWNoIGEgZ2l2ZW4gcGFnZSB3YXMgcmVhY2hlZCBhcmUgc3RvcmVkIGluIHRoZSBoaXN0b3J5IGVudHJ5IGZvciB0aGF0CgkJLy8gcGFnZS4gV2hlbiB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCwgaGlzdG9yeSBpcyBhbHJlYWR5IGF0IHRoZSBuZXcgZW50cnkuIFNvLCB3aGVuIG1vdmluZwoJCS8vIGJhY2ssIHRoaXMgbWVhbnMgd2UgbmVlZCB0byBjb25zdWx0IHRoZSBvbGQgZW50cnkgYW5kIHJldmVyc2UgdGhlIG1lYW5pbmcgb2YgdGhlCgkJLy8gb3B0aW9ucy4gT3RoZXJ3aXNlLCBpZiB3ZSdyZSBtb3ZpbmcgZm9yd2FyZCwgd2UgbmVlZCB0byBjb25zdWx0IHRoZSBvcHRpb25zIGZvciB0aGUKCQkvLyBjdXJyZW50IGVudHJ5LgoJCV9vcHRpb25Gcm9tSGlzdG9yeTogZnVuY3Rpb24oIGRpcmVjdGlvbiwgb3B0aW9uTmFtZSwgZmFsbGJhY2tWYWx1ZSApIHsKCQkJdmFyIGhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCksCgkJCQllbnRyeSA9ICggZGlyZWN0aW9uID09PSAiYmFjayIgPyBoaXN0b3J5LmdldExhc3QoKSA6IGhpc3RvcnkuZ2V0QWN0aXZlKCkgKTsKCgkJCXJldHVybiAoICggZW50cnkgJiYgZW50cnlbIG9wdGlvbk5hbWUgXSApIHx8IGZhbGxiYWNrVmFsdWUgKTsKCQl9LAoKCQlfaGFuZGxlRGlhbG9nOiBmdW5jdGlvbiggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKSB7CgkJCXZhciB0bywgYWN0aXZlLCBhY3RpdmVDb250ZW50ID0gdGhpcy5nZXRBY3RpdmVQYWdlKCk7CgoJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQkvLyBOb3RlOiBUaGUgZGlhbG9nIHdpZGdldCBpcyBkZXByZWNhdGVkIGFzIG9mIDEuNC4wIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gMS41LjAuCgkJCS8vIFRodXMsIGFzIG9mIDEuNS4wIGFjdGl2ZUNvbnRlbnQuZGF0YSggIm1vYmlsZS1kaWFsb2ciICkgd2lsbCBhbHdheXMgZXZhbHVhdGUgdG8KCQkJLy8gZmFsc3ksIHNvIHRoZSBzZWNvbmQgY29uZGl0aW9uIGluIHRoZSBpZi1zdGF0ZW1lbnQgYmVsb3cgY2FuIGJlIHJlbW92ZWQgYWx0b2dldGhlci4KCQkJaWYgKCBhY3RpdmVDb250ZW50ICYmICFhY3RpdmVDb250ZW50LmRhdGEoICJtb2JpbGUtZGlhbG9nIiApICkgewoJCQkJLy8gZGV0ZXJtaW5lIGlmIHdlJ3JlIGhlYWRpbmcgZm9yd2FyZCBvciBiYWNrd2FyZCBhbmQgY29udGludWUKCQkJCS8vIGFjY29yZGluZ2x5IHBhc3QgdGhlIGN1cnJlbnQgZGlhbG9nCgkJCQlpZiAoIGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIgKSB7CgkJCQkJdGhpcy5iYWNrKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuZm9yd2FyZCgpOwoJCQkJfQoKCQkJCS8vIHByZXZlbnQgY2hhbmdlUGFnZSBjYWxsCgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSB7CgkJCQkvLyBpZiB0aGUgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBhIGRpYWxvZyBhbmQgd2UncmUgbmF2aWdhdGluZwoJCQkJLy8gdG8gYSBkaWFsb2cgdXNlIHRoZSBkaWFsb2cgb2JqZWN0ZWQgc2F2ZWQgaW4gdGhlIHN0YWNrCgkJCQl0byA9IGRhdGEucGFnZVVybDsKCQkJCWFjdGl2ZSA9IHRoaXMuX2dldEFjdGl2ZUhpc3RvcnkoKTsKCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSByb2xlLCB0cmFuc2l0aW9uIGFuZCByZXZlcnNhbAoJCQkJLy8gYXMgbW9zdCBvZiB0aGlzIGlzIGxvc3QgYnkgdGhlIGRvbUNhY2hlIGNsZWFuaW5nCgkJCQkkLmV4dGVuZCggY2hhbmdlUGFnZU9wdGlvbnMsIHsKCQkJCQlyb2xlOiBhY3RpdmUucm9sZSwKCQkJCQl0cmFuc2l0aW9uOiB0aGlzLl9vcHRpb25Gcm9tSGlzdG9yeSggZGF0YS5kaXJlY3Rpb24sICJ0cmFuc2l0aW9uIiwKCQkJCQkJY2hhbmdlUGFnZU9wdGlvbnMudHJhbnNpdGlvbiApLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX0pOwoJCQl9CgoJCQlyZXR1cm4gdG87CgkJfSwKCgkJX2hhbmRsZU5hdmlnYXRlOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQkvLyBUT0RPIHN0cmlwcGluZyB0aGUgaGFzaCB0d2ljZSB3aXRoIGhhbmRsZVVybAoJCQl2YXIgdG8gPSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggdXJsICksIGhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCksCgoJCQkJLy8gdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQKCQkJCS8vIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOgoJCQkJCXRoaXMuX29wdGlvbkZyb21IaXN0b3J5KCBkYXRhLmRpcmVjdGlvbiwgInRyYW5zaXRpb24iICksCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nCgkJCQkvLyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gsIE5PVEUgdGhhdCB0aGUKCQkJCS8vIHRyYW5zaXRpb24gaXMgZGVyaXZlZCBmcm9tIHRoZSBwcmV2aW91cyBoaXN0b3J5IGVudHJ5CgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZSwKCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQl9OwoKCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhLCB7CgkJCQl0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLAoJCQkJYWxsb3dTYW1lUGFnZVRyYW5zaXRpb246IHRoaXMuX29wdGlvbkZyb21IaXN0b3J5KCBkYXRhLmRpcmVjdGlvbiwKCQkJCQkiYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24iICkKCQkJfSk7CgoJCQkvLyBUT0RPIG1vdmUgdG8gX2hhbmRsZURlc3RpbmF0aW9uID8KCQkJLy8gSWYgdGhpcyBpc24ndCB0aGUgZmlyc3QgcGFnZSwgaWYgdGhlIGN1cnJlbnQgdXJsIGlzIGEgZGlhbG9nIGhhc2gKCQkJLy8ga2V5LCBhbmQgdGhlIGluaXRpYWwgZGVzdGluYXRpb24gaXNuJ3QgZXF1YWwgdG8gdGhlIGN1cnJlbnQgdGFyZ2V0CgkJCS8vIHBhZ2UsIHVzZSB0aGUgc3BlY2lhbCBkaWFsb2cgaGFuZGxpbmcKCQkJaWYgKCBoaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCAmJgoJCQkJdG8uaW5kZXhPZiggJC5tb2JpbGUuZGlhbG9nSGFzaEtleSApID4gLTEgKSB7CgoJCQkJdG8gPSB0aGlzLl9oYW5kbGVEaWFsb2coIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhICk7CgoJCQkJaWYgKCB0byA9PT0gZmFsc2UgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQl0aGlzLl9jaGFuZ2VDb250ZW50KCB0aGlzLl9oYW5kbGVEZXN0aW5hdGlvbiggdG8gKSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQl9LAoKCQlfY2hhbmdlQ29udGVudDogZnVuY3Rpb24oIHRvLCBvcHRzICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCB0bywgb3B0cyApOwoJCX0sCgoJCV9nZXRCYXNlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmJhc2U7CgkJfSwKCgkJX2dldE5zOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm5zOwoJCX0sCgoJCV9lbmhhbmNlOiBmdW5jdGlvbiggY29udGVudCwgcm9sZSApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBzdXBwb3J0aW5nIGEgY3VzdG9tIGNhbGxiYWNrLCBhbmQgcGFzc2luZyBpbgoJCQkvLyB0aGUgc2V0dGluZ3Mgd2hpY2ggaW5jbHVkZXMgdGhlIHJvbGUKCQkJcmV0dXJuIGNvbnRlbnQucGFnZSh7IHJvbGU6IHJvbGUgfSk7CgkJfSwKCgkJX2luY2x1ZGU6IGZ1bmN0aW9uKCBwYWdlLCBzZXR0aW5ncyApIHsKCQkJLy8gYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJcGFnZS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCQkvLyB1c2UgdGhlIHBhZ2Ugd2lkZ2V0IHRvIGVuaGFuY2UKCQkJdGhpcy5fZW5oYW5jZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJLy8gcmVtb3ZlIHBhZ2Ugb24gaGlkZQoJCQlwYWdlLnBhZ2UoICJiaW5kUmVtb3ZlIiApOwoJCX0sCgoJCV9maW5kOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkvLyBUT0RPIGNvbnNpZGVyIHN1cHBvcnRpbmcgYSBjdXN0b20gY2FsbGJhY2sKCQkJdmFyIGZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKSwKCQkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKSwKCQkJCXBhZ2UsIGluaXRpYWxDb250ZW50ID0gdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCgkJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCQkvLyBOT1RFIGRvIF9ub3RfIHVzZSB0aGUgOmpxbURhdGEgcHNldWRvIHNlbGVjdG9yIGJlY2F1c2UgcGFyZW50aGVzaXMKCQkJLy8gICAgICBhcmUgYSB2YWxpZCB1cmwgY2hhciBhbmQgaXQgYnJlYWtzIG9uIHRoZSBmaXJzdCBvY2N1cmVuY2UKCQkJcGFnZSA9IHRoaXMuZWxlbWVudAoJCQkJLmNoaWxkcmVuKCAiW2RhdGEtIiArIHRoaXMuX2dldE5zKCkgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoKCQkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgdGhlIHBhZ2UsIGNoZWNrIHRvIHNlZSBpZiB0aGUgdXJsIGlzIGEKCQkJLy8gcmVmZXJlbmNlIHRvIGFuIGVtYmVkZGVkIHBhZ2UuIElmIHNvLCBpdCBtYXkgaGF2ZSBiZWVuIGR5bmFtaWNhbGx5CgkJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYQoJCQkvLyBkYXRhLXVybCBhdHRyaWJ1dGUgYW5kIGluIG5lZWQgb2YgZW5oYW5jZW1lbnQuCgkJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYgZGF0YVVybCAmJiAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIGRhdGFVcmwgKSApIHsKCQkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICQubW9iaWxlLnBhdGguaGFzaFRvU2VsZWN0b3IoIiMiICsgZGF0YVVybCkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmwiLCBkYXRhVXJsICkKCQkJCQkuanFtRGF0YSggInVybCIsIGRhdGFVcmwgKTsKCQkJfQoKCQkJLy8gSWYgd2UgZmFpbGVkIHRvIGZpbmQgYSBwYWdlIGluIHRoZSBET00sIGNoZWNrIHRoZSBVUkwgdG8gc2VlIGlmIGl0CgkJCS8vIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgYXBwbGljYXRpb24uIEFsc28gY2hlY2sgdG8gbWFrZSBzdXJlCgkJCS8vIG91ciBjYWNoZWQtZmlyc3QtcGFnZSBpcyBhY3R1YWxseSBpbiB0aGUgRE9NLiBTb21lIHVzZXIgZGVwbG95ZWQKCQkJLy8gYXBwcyBhcmUgcHJ1bmluZyB0aGUgZmlyc3QgcGFnZSBmcm9tIHRoZSBET00gZm9yIHZhcmlvdXMgcmVhc29ucy4KCQkJLy8gV2UgY2hlY2sgZm9yIHRoaXMgY2FzZSBoZXJlIGJlY2F1c2Ugd2UgZG9uJ3Qgd2FudCBhIGZpcnN0LXBhZ2Ugd2l0aAoJCQkvLyBhbiBpZCBmYWxsaW5nIHRocm91Z2ggdG8gdGhlIG5vbi1leGlzdGVudCBlbWJlZGRlZCBwYWdlIGVycm9yIGNhc2UuCgkJCWlmICggcGFnZS5sZW5ndGggPT09IDAgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNGaXJzdFBhZ2VVcmwoIGZpbGVVcmwgKSAmJgoJCQkJaW5pdGlhbENvbnRlbnQgJiYKCQkJCWluaXRpYWxDb250ZW50LnBhcmVudCgpLmxlbmd0aCApIHsKCQkJCXBhZ2UgPSAkKCBpbml0aWFsQ29udGVudCApOwoJCQl9CgoJCQlyZXR1cm4gcGFnZTsKCQl9LAoKCQlfZ2V0TG9hZGVyOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmxvYWRpbmcoKTsKCQl9LAoKCQlfc2hvd0xvYWRpbmc6IGZ1bmN0aW9uKCBkZWxheSwgdGhlbWUsIG1zZywgdGV4dG9ubHkgKSB7CgkJCS8vIFRoaXMgY29uZmlndXJhYmxlIHRpbWVvdXQgYWxsb3dzIGNhY2hlZCBwYWdlcyBhIGJyaWVmCgkJCS8vIGRlbGF5IHRvIGxvYWQgd2l0aG91dCBzaG93aW5nIGEgbWVzc2FnZQoJCQlpZiAoIHRoaXMuX2xvYWRNc2cgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXRoaXMuX2xvYWRNc2cgPSBzZXRUaW1lb3V0KCQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9nZXRMb2FkZXIoKS5sb2FkZXIoICJzaG93IiwgdGhlbWUsIG1zZywgdGV4dG9ubHkgKTsKCQkJCXRoaXMuX2xvYWRNc2cgPSAwOwoJCQl9LCB0aGlzKSwgZGVsYXkgKTsKCQl9LAoKCQlfaGlkZUxvYWRpbmc6IGZ1bmN0aW9uKCkgewoJCQkvLyBTdG9wIG1lc3NhZ2Ugc2hvdyB0aW1lcgoJCQljbGVhclRpbWVvdXQoIHRoaXMuX2xvYWRNc2cgKTsKCQkJdGhpcy5fbG9hZE1zZyA9IDA7CgoJCQkvLyBIaWRlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGlzLl9nZXRMb2FkZXIoKS5sb2FkZXIoICJoaWRlIiApOwoJCX0sCgoJCV9zaG93RXJyb3I6IGZ1bmN0aW9uKCkgewoJCQkvLyBtYWtlIHN1cmUgdG8gcmVtb3ZlIHRoZSBjdXJyZW50IGxvYWRpbmcgbWVzc2FnZQoJCQl0aGlzLl9oaWRlTG9hZGluZygpOwoKCQkJLy8gc2hvdyB0aGUgZXJyb3IgbWVzc2FnZQoJCQl0aGlzLl9zaG93TG9hZGluZyggMCwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZSwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2UsIHRydWUgKTsKCgkJCS8vIGhpZGUgdGhlIGVycm9yIG1lc3NhZ2UgYWZ0ZXIgYSBkZWxheQoJCQkvLyBUT0RPIGNvbmZpZ3VyYXRpb24KCQkJc2V0VGltZW91dCggJC5wcm94eSh0aGlzLCAiX2hpZGVMb2FkaW5nIiksIDE1MDAgKTsKCQl9LAoKCQlfcGFyc2U6IGZ1bmN0aW9uKCBodG1sLCBmaWxlVXJsICkgewoJCQkvLyBUT0RPIGNvbnNpZGVyIGFsbG93aW5nIGN1c3RvbWl6YXRpb24gb2YgdGhpcyBtZXRob2QuIEl0J3MgdmVyeSBKUU0gc3BlY2lmaWMKCQkJdmFyIHBhZ2UsIGFsbCA9ICQoICI8ZGl2PjwvZGl2PiIgKTsKCgkJCS8vd29ya2Fyb3VuZCB0byBhbGxvdyBzY3JpcHRzIHRvIGV4ZWN1dGUgd2hlbiBpbmNsdWRlZCBpbiBwYWdlIGRpdnMKCQkJYWxsLmdldCggMCApLmlubmVySFRNTCA9IGh0bWw7CgoJCQlwYWdlID0gYWxsLmZpbmQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpcnN0KCk7CgoJCQkvL2lmIHBhZ2UgZWxlbSBjb3VsZG4ndCBiZSBmb3VuZCwgY3JlYXRlIG9uZSBhbmQgaW5zZXJ0IHRoZSBib2R5IGVsZW1lbnQncyBjb250ZW50cwoJCQlpZiAoICFwYWdlLmxlbmd0aCApIHsKCQkJCXBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInJvbGU9J3BhZ2UnPiIgKwoJCQkJCSggaHRtbC5zcGxpdCggLzxcLz9ib2R5W14+XSo+L2dtaSApWzFdIHx8ICIiICkgKwoJCQkJCSI8L2Rpdj4iICk7CgkJCX0KCgkJCS8vIFRPRE8gdGFnZ2luZyBhIHBhZ2Ugd2l0aCBleHRlcm5hbCB0byBtYWtlIHN1cmUgdGhhdCBlbWJlZGRlZCBwYWdlcyBhcmVuJ3QKCQkJLy8gcmVtb3ZlZCBieSB0aGUgdmFyaW91cyBwYWdlIGhhbmRsaW5nIGNvZGUgaXMgYmFkLiBIYXZpbmcgcGFnZSBoYW5kbGluZyBjb2RlCgkJCS8vIGluIG1hbnkgcGxhY2VzIGlzIGJhZC4gU29sdXRpb25zIHBvc3QgMS4wCgkJCXBhZ2UuYXR0ciggImRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAidXJsIiwgJC5tb2JpbGUucGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKGZpbGVVcmwpICkKCQkJCS5hdHRyKCAiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJleHRlcm5hbC1wYWdlIiwgdHJ1ZSApOwoKCQkJcmV0dXJuIHBhZ2U7CgkJfSwKCgkJX3NldExvYWRlZFRpdGxlOiBmdW5jdGlvbiggcGFnZSwgaHRtbCApIHsKCQkJLy9wYWdlIHRpdGxlIHJlZ2V4cAoJCQl2YXIgbmV3UGFnZVRpdGxlID0gaHRtbC5tYXRjaCggLzx0aXRsZVtePl0qPihbXjxdKikvICkgJiYgUmVnRXhwLiQxOwoKCQkJaWYgKCBuZXdQYWdlVGl0bGUgJiYgIXBhZ2UuanFtRGF0YSgidGl0bGUiKSApIHsKCQkJCW5ld1BhZ2VUaXRsZSA9ICQoICI8ZGl2PiIgKyBuZXdQYWdlVGl0bGUgKyAiPC9kaXY+IiApLnRleHQoKTsKCQkJCXBhZ2UuanFtRGF0YSggInRpdGxlIiwgbmV3UGFnZVRpdGxlICk7CgkJCX0KCQl9LAoKCQlfaXNSZXdyaXRhYmxlQmFzZVRhZzogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgJiYgISQuc3VwcG9ydC5keW5hbWljQmFzZVRhZzsKCQl9LAoKCQlfY3JlYXRlRGF0YVVybDogZnVuY3Rpb24oIGFic29sdXRlVXJsICkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBhYnNvbHV0ZVVybCApOwoJCX0sCgoJCV9jcmVhdGVGaWxlVXJsOiBmdW5jdGlvbiggYWJzb2x1dGVVcmwgKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLmdldEZpbGVQYXRoKCBhYnNvbHV0ZVVybCApOwoJCX0sCgoJCV90cmlnZ2VyV2l0aERlcHJlY2F0ZWQ6IGZ1bmN0aW9uKCBuYW1lLCBkYXRhLCBwYWdlICkgewoJCQl2YXIgZGVwcmVjYXRlZEV2ZW50ID0gJC5FdmVudCggInBhZ2UiICsgbmFtZSApLAoJCQkJbmV3RXZlbnQgPSAkLkV2ZW50KCB0aGlzLndpZGdldE5hbWUgKyBuYW1lICk7CgoJCQkvLyBERVBSRUNBVEVECgkJCS8vIHRyaWdnZXIgdGhlIG9sZCBkZXByZWNhdGVkIGV2ZW50IG9uIHRoZSBwYWdlIGlmIGl0J3MgcHJvdmlkZWQKCQkJKCBwYWdlIHx8IHRoaXMuZWxlbWVudCApLnRyaWdnZXIoIGRlcHJlY2F0ZWRFdmVudCwgZGF0YSApOwoKCQkJLy8gdXNlIHRoZSB3aWRnZXQgdHJpZ2dlciBtZXRob2QgZm9yIHRoZSBuZXcgY29udGVudCogZXZlbnQKCQkJdGhpcy5fdHJpZ2dlciggbmFtZSwgbmV3RXZlbnQsIGRhdGEgKTsKCgkJCXJldHVybiB7CgkJCQlkZXByZWNhdGVkRXZlbnQ6IGRlcHJlY2F0ZWRFdmVudCwKCQkJCWV2ZW50OiBuZXdFdmVudAoJCQl9OwoJCX0sCgoJCS8vIFRPRE8gaXQgd291bGQgYmUgbmljZSB0byBzcGxpdCB0aGlzIHVwIG1vcmUgYnV0IGV2ZXJ5dGhpbmcgYXBwZWFycyB0byBiZSAib25lIG9mZiIKCQkvLyAgICAgIG9yIHJlcXVpcmUgb3JkZXJpbmcgc3VjaCB0aGF0IG90aGVyIGJpdHMgYXJlIHNwcmlua2xlZCBpbiBiZXR3ZWVuIHBhcnRzIHRoYXQKCQkvLyAgICAgIGNvdWxkIGJlIGFic3RyYWN0ZWQgb3V0IGFzIGEgZ3JvdXAKCQlfbG9hZFN1Y2Nlc3M6IGZ1bmN0aW9uKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKSB7CgkJCXZhciBmaWxlVXJsID0gdGhpcy5fY3JlYXRlRmlsZVVybCggYWJzVXJsICksCgkJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICk7CgoJCQlyZXR1cm4gJC5wcm94eShmdW5jdGlvbiggaHRtbCwgdGV4dFN0YXR1cywgeGhyICkgewoJCQkJLy9wcmUtcGFyc2UgaHRtbCB0byBjaGVjayBmb3IgYSBkYXRhLXVybCwKCQkJCS8vdXNlIGl0IGFzIHRoZSBuZXcgZmlsZVVybCwgYmFzZSBwYXRoLCBldGMKCQkJCXZhciBjb250ZW50LAoKCQkJCQkvLyBUT0RPIGhhbmRsZSBkaWFsb2dzIGFnYWluCgkJCQkJcGFnZUVsZW1SZWdleCA9IG5ldyBSZWdFeHAoICIoPFtePl0rXFxiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJyb2xlPVtcIiddP3BhZ2VbXCInXT9bXj5dKj4pIiApLAoKCQkJCQlkYXRhVXJsUmVnZXggPSBuZXcgUmVnRXhwKCAiXFxiZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJ1cmw9W1wiJ10/KFteXCInPl0qKVtcIiddPyIgKTsKCgkJCQkvLyBkYXRhLXVybCBtdXN0IGJlIHByb3ZpZGVkIGZvciB0aGUgYmFzZSB0YWcgc28gcmVzb3VyY2UgcmVxdWVzdHMKCQkJCS8vIGNhbiBiZSBkaXJlY3RlZCB0byB0aGUgY29ycmVjdCB1cmwuIGxvYWRpbmcgaW50byBhIHRlbXByb3JhcnkKCQkJCS8vIGVsZW1lbnQgbWFrZXMgdGhlc2UgcmVxdWVzdHMgaW1tZWRpYXRlbHkKCQkJCWlmICggcGFnZUVsZW1SZWdleC50ZXN0KCBodG1sICkgJiYKCQkJCQlSZWdFeHAuJDEgJiYKCQkJCQlkYXRhVXJsUmVnZXgudGVzdCggUmVnRXhwLiQxICkgJiYKCQkJCQlSZWdFeHAuJDEgKSB7CgkJCQkJZmlsZVVybCA9ICQubW9iaWxlLnBhdGguZ2V0RmlsZVBhdGgoICQoIjxkaXY+IiArIFJlZ0V4cC4kMSArICI8L2Rpdj4iKS50ZXh0KCkgKTsKCQkJCX0KCgkJCQkvL2RvbnQgdXBkYXRlIHRoZSBiYXNlIHRhZyBpZiB3ZSBhcmUgcHJlZmV0Y2hpbmcKCQkJCWlmICggc2V0dGluZ3MucHJlZmV0Y2ggPT09IHVuZGVmaW5lZCApIHsKCQkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KCBmaWxlVXJsICk7CgkJCQl9CgoJCQkJY29udGVudCA9IHRoaXMuX3BhcnNlKCBodG1sLCBmaWxlVXJsICk7CgoJCQkJdGhpcy5fc2V0TG9hZGVkVGl0bGUoIGNvbnRlbnQsIGh0bWwgKTsKCgkJCQkvLyBBZGQgdGhlIGNvbnRlbnQgcmVmZXJlbmNlIGFuZCB4aHIgdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgoJCQkJLy8gREVQUkVDQVRFRAoJCQkJdHJpZ2dlckRhdGEucGFnZSA9IGNvbnRlbnQ7CgoJCQkJdHJpZ2dlckRhdGEuY29udGVudCA9IGNvbnRlbnQ7CgoJCQkJdHJpZ2dlckRhdGEudG9QYWdlID0gY29udGVudDsKCgkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQlpZiAoIHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImxvYWQiLCB0cmlnZ2VyRGF0YSApLmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyByZXdyaXRlIHNyYyBhbmQgaHJlZiBhdHRycyB0byB1c2UgYSBiYXNlIHVybCBpZiB0aGUgYmFzZSB0YWcgd29uJ3Qgd29yawoJCQkJaWYgKCB0aGlzLl9pc1Jld3JpdGFibGVCYXNlVGFnKCkgJiYgY29udGVudCApIHsKCQkJCQl0aGlzLl9nZXRCYXNlKCkucmV3cml0ZSggZmlsZVVybCwgY29udGVudCApOwoJCQkJfQoKCQkJCXRoaXMuX2luY2x1ZGUoIGNvbnRlbnQsIHNldHRpbmdzICk7CgoJCQkJLy8gRW5oYW5jaW5nIHRoZSBjb250ZW50IG1heSByZXN1bHQgaW4gbmV3IGRpYWxvZ3Mvc3ViIGNvbnRlbnQgYmVpbmcgaW5zZXJ0ZWQKCQkJCS8vIGludG8gdGhlIERPTS4gSWYgdGhlIG9yaWdpbmFsIGFic1VybCByZWZlcnMgdG8gYSBzdWItY29udGVudCwgdGhhdCBpcyB0aGUKCQkJCS8vIHJlYWwgY29udGVudCB3ZSBhcmUgaW50ZXJlc3RlZCBpbi4KCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCWNvbnRlbnQgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJbZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgkJCQl9CgoJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQkJdGhpcy5faGlkZUxvYWRpbmcoKTsKCQkJCX0KCgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIHNldHRpbmdzLCBjb250ZW50ICk7CgkJCX0sIHRoaXMpOwoJCX0sCgoJCV9sb2FkRGVmYXVsdHM6IHsKCQkJdHlwZTogImdldCIsCgkJCWRhdGE6IHVuZGVmaW5lZCwKCgkJCS8vIERFUFJFQ0FURUQKCQkJcmVsb2FkUGFnZTogZmFsc2UsCgoJCQlyZWxvYWQ6IGZhbHNlLAoKCQkJLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCQlyb2xlOiB1bmRlZmluZWQsCgoJCQlzaG93TG9hZE1zZzogZmFsc2UsCgoJCQkvLyBUaGlzIGRlbGF5IGFsbG93cyBsb2FkcyB0aGF0IHB1bGwgZnJvbSBicm93c2VyIGNhY2hlIHRvCgkJCS8vIG9jY3VyIHdpdGhvdXQgc2hvd2luZyB0aGUgbG9hZGluZyBtZXNzYWdlLgoJCQlsb2FkTXNnRGVsYXk6IDUwCgkJfSwKCgkJbG9hZDogZnVuY3Rpb24oIHVybCwgb3B0aW9ucyApIHsKCQkJLy8gVGhpcyBmdW5jdGlvbiB1c2VzIGRlZmVycmVkIG5vdGlmaWNhdGlvbnMgdG8gbGV0IGNhbGxlcnMKCQkJLy8ga25vdyB3aGVuIHRoZSBjb250ZW50IGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCQl2YXIgZGVmZXJyZWQgPSAoIG9wdGlvbnMgJiYgb3B0aW9ucy5kZWZlcnJlZCApIHx8ICQuRGVmZXJyZWQoKSwKCgkJCQkvLyBUaGUgZGVmYXVsdCBsb2FkIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5IHRoZSBjYWxsZXIuCgkJCQlzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5fbG9hZERlZmF1bHRzLCBvcHRpb25zICksCgoJCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgY29udGVudCBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCQljb250ZW50ID0gbnVsbCwKCgkJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIHBhc3NlZCBpbnRvIHRoZSBmdW5jdGlvbi4gVGhpcwoJCQkJLy8gdmVyc2lvbiBvZiB0aGUgVVJMIG1heSBjb250YWluIGRpYWxvZy9zdWJjb250ZW50IHBhcmFtcyBpbiBpdC4KCQkJCWFic1VybCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuX2ZpbmRCYXNlV2l0aERlZmF1bHQoKSApLAoJCQkJZmlsZVVybCwgZGF0YVVybCwgcGJsRXZlbnQsIHRyaWdnZXJEYXRhOwoKCQkJLy8gREVQUkVDQVRFRCByZWxvYWRQYWdlCgkJCXNldHRpbmdzLnJlbG9hZCA9IHNldHRpbmdzLnJlbG9hZFBhZ2U7CgoJCQkvLyBJZiB0aGUgY2FsbGVyIHByb3ZpZGVkIGRhdGEsIGFuZCB3ZSdyZSB1c2luZyAiZ2V0IiByZXF1ZXN0LAoJCQkvLyBhcHBlbmQgdGhlIGRhdGEgdG8gdGhlIFVSTC4KCQkJaWYgKCBzZXR0aW5ncy5kYXRhICYmIHNldHRpbmdzLnR5cGUgPT09ICJnZXQiICkgewoJCQkJYWJzVXJsID0gJC5tb2JpbGUucGF0aC5hZGRTZWFyY2hQYXJhbXMoIGFic1VybCwgc2V0dGluZ3MuZGF0YSApOwoJCQkJc2V0dGluZ3MuZGF0YSA9IHVuZGVmaW5lZDsKCQkJfQoKCQkJLy8gSWYgdGhlIGNhbGxlciBpcyB1c2luZyBhICJwb3N0IiByZXF1ZXN0LCByZWxvYWQgbXVzdCBiZSB0cnVlCgkJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAicG9zdCIgKSB7CgkJCQlzZXR0aW5ncy5yZWxvYWQgPSB0cnVlOwoJCQl9CgoJCQkvLyBUaGUgYWJzb2x1dGUgdmVyc2lvbiBvZiB0aGUgVVJMIG1pbnVzIGFueSBkaWFsb2cvc3ViY29udGVudCBwYXJhbXMuCgkJCS8vIEluIG90aGVyd29yZHMgdGhlIHJlYWwgVVJMIG9mIHRoZSBjb250ZW50IHRvIGJlIGxvYWRlZC4KCQkJZmlsZVVybCA9IHRoaXMuX2NyZWF0ZUZpbGVVcmwoIGFic1VybCApOwoKCQkJLy8gVGhlIHZlcnNpb24gb2YgdGhlIFVybCBhY3R1YWxseSBzdG9yZWQgaW4gdGhlIGRhdGEtdXJsIGF0dHJpYnV0ZSBvZgoJCQkvLyB0aGUgY29udGVudC4gRm9yIGVtYmVkZGVkIGNvbnRlbnQsIGl0IGlzIGp1c3QgdGhlIGlkIG9mIHRoZSBwYWdlLiBGb3IKCQkJLy8gY29udGVudCB3aXRoaW4gdGhlIHNhbWUgZG9tYWluIGFzIHRoZSBkb2N1bWVudCBiYXNlLCBpdCBpcyB0aGUgc2l0ZQoJCQkvLyByZWxhdGl2ZSBwYXRoLiBGb3IgY3Jvc3MtZG9tYWluIGNvbnRlbnQgKFBob25lIEdhcCBvbmx5KSB0aGUgZW50aXJlCgkJCS8vIGFic29sdXRlIFVybCBpcyB1c2VkIHRvIGxvYWQgdGhlIGNvbnRlbnQuCgkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKTsKCgkJCWNvbnRlbnQgPSB0aGlzLl9maW5kKCBhYnNVcmwgKTsKCgkJCS8vIElmIGl0IGlzbid0IGEgcmVmZXJlbmNlIHRvIHRoZSBmaXJzdCBjb250ZW50IGFuZCByZWZlcnMgdG8gbWlzc2luZwoJCQkvLyBlbWJlZGRlZCBjb250ZW50IHJlamVjdCB0aGUgZGVmZXJyZWQgYW5kIHJldHVybgoJCQlpZiAoIGNvbnRlbnQubGVuZ3RoID09PSAwICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzRW1iZWRkZWRQYWdlKGZpbGVVcmwpICYmCgkJCQkhJC5tb2JpbGUucGF0aC5pc0ZpcnN0UGFnZVVybChmaWxlVXJsKSApIHsKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlCgkJCS8vIFRPRE8gZmlndXJlIG91dCB3aHkgd2UgZG9lIHRoaXMKCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgoJCQkvLyBJZiB0aGUgY29udGVudCB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBSZXNvbHZlIHRoZSBkZWZlcnJyZWQgc28gdGhhdAoJCQkvLyB1c2VycyBjYW4gYmluZCB0byAuZG9uZSBvbiB0aGUgcHJvbWlzZQoJCQlpZiAoIGNvbnRlbnQubGVuZ3RoICYmICFzZXR0aW5ncy5yZWxvYWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlKCBjb250ZW50LCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIHNldHRpbmdzLCBjb250ZW50ICk7CgoJCQkJLy9pZiB3ZSBhcmUgcmVsb2FkaW5nIHRoZSBjb250ZW50IG1ha2Ugc3VyZSB3ZSB1cGRhdGUKCQkJCS8vIHRoZSBiYXNlIGlmIGl0cyBub3QgYSBwcmVmZXRjaAoJCQkJaWYgKCAhc2V0dGluZ3MucHJlZmV0Y2ggKSB7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCh1cmwpOwoJCQkJfQoKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCgkJCXRyaWdnZXJEYXRhID0gewoJCQkJdXJsOiB1cmwsCgkJCQlhYnNVcmw6IGFic1VybCwKCQkJCXRvUGFnZTogdXJsLAoJCQkJcHJldlBhZ2U6IG9wdGlvbnMgPyBvcHRpb25zLmZyb21QYWdlIDogdW5kZWZpbmVkLAoJCQkJZGF0YVVybDogZGF0YVVybCwKCQkJCWRlZmVycmVkOiBkZWZlcnJlZCwKCQkJCW9wdGlvbnM6IHNldHRpbmdzCgkJCX07CgoJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBjb250ZW50LgoJCQlwYmxFdmVudCA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImJlZm9yZWxvYWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCWlmICggcGJsRXZlbnQuZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQlwYmxFdmVudC5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCgkJCWlmICggc2V0dGluZ3Muc2hvd0xvYWRNc2cgKSB7CgkJCQl0aGlzLl9zaG93TG9hZGluZyggc2V0dGluZ3MubG9hZE1zZ0RlbGF5ICk7CgkJCX0KCgkJCS8vIFJlc2V0IGJhc2UgdG8gdGhlIGRlZmF1bHQgZG9jdW1lbnQgYmFzZS4KCQkJLy8gb25seSByZXNldCBpZiB3ZSBhcmUgbm90IHByZWZldGNoaW5nCgkJCWlmICggc2V0dGluZ3MucHJlZmV0Y2ggPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX2dldEJhc2UoKS5yZXNldCgpOwoJCQl9CgoJCQlpZiAoICEoICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyB8fAoJCQkJJC5tb2JpbGUucGF0aC5pc1NhbWVEb21haW4oJC5tb2JpbGUucGF0aC5kb2N1bWVudFVybCwgYWJzVXJsICkgKSApIHsKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoKCQkJLy8gTG9hZCB0aGUgbmV3IGNvbnRlbnQuCgkJCSQuYWpheCh7CgkJCQl1cmw6IGZpbGVVcmwsCgkJCQl0eXBlOiBzZXR0aW5ncy50eXBlLAoJCQkJZGF0YTogc2V0dGluZ3MuZGF0YSwKCQkJCWNvbnRlbnRUeXBlOiBzZXR0aW5ncy5jb250ZW50VHlwZSwKCQkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCQlzdWNjZXNzOiB0aGlzLl9sb2FkU3VjY2VzcyggYWJzVXJsLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MsIGRlZmVycmVkICksCgkJCQllcnJvcjogdGhpcy5fbG9hZEVycm9yKCBhYnNVcmwsIHRyaWdnZXJEYXRhLCBzZXR0aW5ncywgZGVmZXJyZWQgKQoJCQl9KTsKCgkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJfSwKCgkJX2xvYWRFcnJvcjogZnVuY3Rpb24oIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApIHsKCQkJcmV0dXJuICQucHJveHkoZnVuY3Rpb24oIHhociwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24gKSB7CgkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KCAkLm1vYmlsZS5wYXRoLmdldCgpICk7CgoJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkIGZhaWxlZC4KCQkJCXZhciBwbGZFdmVudCA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImxvYWRmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJLy8gdGhhdCBjYWxsZWQgcHJldmVudERlZmF1bHQoKSwgdG8gcmVzb2x2ZS9yZWplY3QgdGhlCgkJCQkvLyBkZWZlcnJlZCBvYmplY3Qgd2l0aGluIHRoZSB0cmlnZ2VyRGF0YS4KCQkJCWlmICggcGxmRXZlbnQuZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQkJcGxmRXZlbnQuZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCXRoaXMuX3Nob3dFcnJvcigpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQl9LCB0aGlzKTsKCQl9LAoKCQlfZ2V0VHJhbnNpdGlvbkhhbmRsZXI6IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHRyYW5zaXRpb24gKTsKCgkJCS8vZmluZCB0aGUgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIHRyYW5zaXRpb24uIElmIHRoZXJlCgkJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkJLy9jYWxsIHRoZSBoYW5kbGVyIGltbWVkaWF0ZWx5IHRvIGtpY2stb2ZmIHRoZSB0cmFuc2l0aW9uLgoJCQlyZXR1cm4gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIF0gfHwgJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyOwoJCX0sCgoJCS8vIFRPRE8gbW92ZSBpbnRvIHRyYW5zaXRpb24gaGFuZGxlcnM/CgkJX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzOiBmdW5jdGlvbiggdG8sIGZyb20sIHByZWZpeCApIHsKCQkJdmFyIHNhbWVQYWdlID0gZmFsc2U7CgoJCQlwcmVmaXggPSBwcmVmaXggfHwgIiI7CgoJCQkvLyBUT0RPIGRlY2lkZSBpZiB0aGVzZSBldmVudHMgc2hvdWxkIGluIGZhY3QgYmUgdHJpZ2dlcmVkIG9uIHRoZSBjb250YWluZXIKCQkJaWYgKCBmcm9tICkgewoKCQkJCS8vQ2hlY2sgaWYgdGhpcyBpcyBhIHNhbWUgcGFnZSB0cmFuc2l0aW9uIGFuZCB0ZWxsIHRoZSBoYW5kbGVyIGluIHBhZ2UKCQkJCWlmKCB0b1swXSA9PT0gZnJvbVswXSApewoJCQkJCXNhbWVQYWdlID0gdHJ1ZTsKCQkJCX0KCgkJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJCS8vIFRPRE8gZGVwcmVjYXRlIG5leHRQYWdlIGluIGZhdm9yIG9mIG5leHQKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggcHJlZml4ICsgImhpZGUiLCB7CgoJCQkJCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkJCQluZXh0UGFnZTogdG8sCgkJCQkJdG9QYWdlOiB0bywKCQkJCQlwcmV2UGFnZTogZnJvbSwKCQkJCQlzYW1lUGFnZTogc2FtZVBhZ2UKCQkJCX0sIGZyb20gKTsKCQkJfQoKCQkJLy8gVE9ETyBkZXByZWNhdGUgcHJldlBhZ2UgaW4gZmF2b3Igb2YgcHJldmlvdXMKCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCBwcmVmaXggKyAic2hvdyIsIHsKCQkJCXByZXZQYWdlOiBmcm9tIHx8ICQoICIiICksCgkJCQl0b1BhZ2U6IHRvCgkJCX0sIHRvICk7CgkJfSwKCgkJLy8gVE9ETyBtYWtlIHByaXZhdGUgb25jZSBjaGFuZ2UgaGFzIGJlZW4gZGVmaW5lZCBpbiB0aGUgd2lkZ2V0CgkJX2Nzc1RyYW5zaXRpb246IGZ1bmN0aW9uKCB0bywgZnJvbSwgb3B0aW9ucyApIHsKCQkJdmFyIHRyYW5zaXRpb24gPSBvcHRpb25zLnRyYW5zaXRpb24sCgkJCQlyZXZlcnNlID0gb3B0aW9ucy5yZXZlcnNlLAoJCQkJZGVmZXJyZWQgPSBvcHRpb25zLmRlZmVycmVkLAoJCQkJVHJhbnNpdGlvbkhhbmRsZXIsCgkJCQlwcm9taXNlOwoKCQkJdGhpcy5fdHJpZ2dlckNzc1RyYW5zaXRpb25FdmVudHMoIHRvLCBmcm9tLCAiYmVmb3JlIiApOwoKCQkJLy8gVE9ETyBwdXQgdGhpcyBpbiBhIGJpbmRpbmcgdG8gZXZlbnRzICpvdXRzaWRlKiB0aGUgd2lkZ2V0CgkJCXRoaXMuX2hpZGVMb2FkaW5nKCk7CgoJCQlUcmFuc2l0aW9uSGFuZGxlciA9IHRoaXMuX2dldFRyYW5zaXRpb25IYW5kbGVyKCB0cmFuc2l0aW9uICk7CgoJCQlwcm9taXNlID0gKCBuZXcgVHJhbnNpdGlvbkhhbmRsZXIoIHRyYW5zaXRpb24sIHJldmVyc2UsIHRvLCBmcm9tICkgKS50cmFuc2l0aW9uKCk7CgoJCQlwcm9taXNlLmRvbmUoICQucHJveHkoIGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fdHJpZ2dlckNzc1RyYW5zaXRpb25FdmVudHMoIHRvLCBmcm9tICk7CgkJCX0sIHRoaXMgKSk7CgoJCQkvLyBUT0RPIHRlbXBvcmFyeSBhY2NvbW9kYXRpb24gb2YgYXJndW1lbnQgZGVmZXJyZWQKCQkJcHJvbWlzZS5kb25lKGZ1bmN0aW9uKCkgewoJCQkJZGVmZXJyZWQucmVzb2x2ZS5hcHBseSggZGVmZXJyZWQsIGFyZ3VtZW50cyApOwoJCQl9KTsKCQl9LAoKCQlfcmVsZWFzZVRyYW5zaXRpb25Mb2NrOiBmdW5jdGlvbigpIHsKCQkJLy9yZWxlYXNlIHRyYW5zaXRpb24gbG9jayBzbyBuYXZpZ2F0aW9uIGlzIGZyZWUgYWdhaW4KCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQlpZiAoIHBhZ2VUcmFuc2l0aW9uUXVldWUubGVuZ3RoID4gMCApIHsKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UuYXBwbHkoIG51bGwsIHBhZ2VUcmFuc2l0aW9uUXVldWUucG9wKCkgKTsKCQkJfQoJCX0sCgoJCV9yZW1vdmVBY3RpdmVMaW5rQ2xhc3M6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQkJLy9jbGVhciBvdXQgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUKCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCBmb3JjZSApOwoJCX0sCgoJCV9sb2FkVXJsOiBmdW5jdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApIHsKCQkJLy8gcHJlc2VydmUgdGhlIG9yaWdpbmFsIHRhcmdldCBhcyB0aGUgZGF0YVVybCB2YWx1ZSB3aWxsIGJlCgkJCS8vIHNpbXBsaWZpZWQgZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zCgkJCS8vIGZyb20gdGhlIGhhc2ggdGhpcyBpcyBzbyB0aGF0IHVzZXJzIHdobyB3YW50IHRvIHVzZSBxdWVyeQoJCQkvLyBwYXJhbXMgaGF2ZSBhY2Nlc3MgdG8gdGhlbSBpbiB0aGUgZXZlbnQgYmluZGluZ3MgZm9yIHRoZSBwYWdlCgkJCS8vIGxpZmUgY3ljbGUgU2VlIGlzc3VlICM1MDg1CgkJCXNldHRpbmdzLnRhcmdldCA9IHRvOwoJCQlzZXR0aW5ncy5kZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJCXRoaXMubG9hZCggdG8sIHNldHRpbmdzICk7CgoJCQlzZXR0aW5ncy5kZWZlcnJlZC5kb25lKCQucHJveHkoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgY29udGVudCApIHsKCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCgkJCQkvLyBzdG9yZSB0aGUgb3JpZ2luYWwgYWJzb2x1dGUgdXJsIHNvIHRoYXQgaXQgY2FuIGJlIHByb3ZpZGVkCgkJCQkvLyB0byBldmVudHMgaW4gdGhlIHRyaWdnZXJEYXRhIG9mIHRoZSBzdWJzZXF1ZW50IGNoYW5nZVBhZ2UgY2FsbAoJCQkJb3B0aW9ucy5hYnNVcmwgPSB0cmlnZ2VyRGF0YS5hYnNVcmw7CgoJCQkJdGhpcy50cmFuc2l0aW9uKCBjb250ZW50LCB0cmlnZ2VyRGF0YSwgb3B0aW9ucyApOwoJCQl9LCB0aGlzKSk7CgoJCQlzZXR0aW5ncy5kZWZlcnJlZC5mYWlsKCQucHJveHkoZnVuY3Rpb24oLyogdXJsLCBvcHRpb25zICovKSB7CgkJCQl0aGlzLl9yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCXRoaXMuX3JlbGVhc2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiY2hhbmdlZmFpbGVkIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCV90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZTogZnVuY3Rpb24oIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKSB7CgkJCXZhciByZXR1cm5FdmVudHM7CgoJCQl0cmlnZ2VyRGF0YS5wcmV2UGFnZSA9IHRoaXMuYWN0aXZlUGFnZTsKCQkJJC5leHRlbmQoIHRyaWdnZXJEYXRhLCB7CgkJCQl0b1BhZ2U6IHRvLAoJCQkJb3B0aW9uczogc2V0dGluZ3MKCQkJfSk7CgoJCQkvLyBOT1RFOiBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgdGFyZ2V0IGFzIHRoZSBkYXRhVXJsIHZhbHVlIHdpbGwgYmUKCQkJLy8gc2ltcGxpZmllZCBlZywgcmVtb3ZpbmcgdWktc3RhdGUsIGFuZCByZW1vdmluZyBxdWVyeSBwYXJhbXMgZnJvbQoJCQkvLyB0aGUgaGFzaCB0aGlzIGlzIHNvIHRoYXQgdXNlcnMgd2hvIHdhbnQgdG8gdXNlIHF1ZXJ5IHBhcmFtcyBoYXZlCgkJCS8vIGFjY2VzcyB0byB0aGVtIGluIHRoZSBldmVudCBiaW5kaW5ncyBmb3IgdGhlIHBhZ2UgbGlmZSBjeWNsZQoJCQkvLyBTZWUgaXNzdWUgIzUwODUKCQkJaWYgKCAkLnR5cGUodG8pID09PSAic3RyaW5nIiApIHsKCQkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBzdHJpbmcgc2ltcGx5IGNvbnZlcnQgaXQKCQkJCXRyaWdnZXJEYXRhLmFic1VybCA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB0bywgdGhpcy5fZmluZEJhc2VXaXRoRGVmYXVsdCgpICk7CgkJCX0gZWxzZSB7CgkJCQkvLyBpZiB0aGUgdG9QYWdlIGlzIGEgalF1ZXJ5IG9iamVjdCBncmFiIHRoZSBhYnNvbHV0ZSB1cmwgc3RvcmVkCgkJCQkvLyBpbiB0aGUgbG9hZFBhZ2UgY2FsbGJhY2sgd2hlcmUgaXQgZXhpc3RzCgkJCQl0cmlnZ2VyRGF0YS5hYnNVcmwgPSBzZXR0aW5ncy5hYnNVcmw7CgkJCX0KCgkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBjaGFuZ2UgdGhlIGN1cnJlbnQgcGFnZS4KCQkJcmV0dXJuRXZlbnRzID0gdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiYmVmb3JlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCgkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQlpZiAoIHJldHVybkV2ZW50cy5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSB8fAoJCQkJcmV0dXJuRXZlbnRzLmRlcHJlY2F0ZWRFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJY2hhbmdlOiBmdW5jdGlvbiggdG8sIG9wdGlvbnMgKSB7CgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggYXJndW1lbnRzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoJCQkJdHJpZ2dlckRhdGEgPSB7fTsKCgkJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJCXNldHRpbmdzLmZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UgfHwgdGhpcy5hY3RpdmVQYWdlOwoKCQkJLy8gaWYgdGhlIHBhZ2UgYmVmb3JlY2hhbmdlIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQlpZiAoICF0aGlzLl90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZSh0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvIGluCgkJCS8vIHRoZSB0cmlnZ2VyIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0byBpcwoJCQkvLyB1cGRhdGVkLiBXZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgd2hldGhlciBpdCBpcyBhIHN0cmluZywKCQkJLy8gYmVjYXVzZSBhbiBvYmplY3QgY2FuIGFsc28gYmUgcmVwbGFjZWQgYnkgYSBzdHJpbmcKCQkJdG8gPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgoJCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCQkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkJCXRoaXMuX2xvYWRVcmwoIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMudHJhbnNpdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApOwoJCQl9CgkJfSwKCgkJdHJhbnNpdGlvbjogZnVuY3Rpb24oIHRvUGFnZSwgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQl2YXIgZnJvbVBhZ2UsIHVybCwgcGFnZVVybCwgZmlsZVVybCwKCQkJCWFjdGl2ZSwgYWN0aXZlSXNJbml0aWFsUGFnZSwKCQkJCWhpc3RvcnlEaXIsIHBhZ2VUaXRsZSwgaXNEaWFsb2csCgkJCQlhbHJlYWR5VGhlcmUsIG5ld1BhZ2VUaXRsZSwKCQkJCXBhcmFtcywJY3NzVHJhbnNpdGlvbkRlZmVycmVkLAoJCQkJYmVmb3JlVHJhbnNpdGlvbjsKCgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCS8vIG1ha2Ugc3VyZSB0byBvbmx5IHF1ZXVlIHRoZSB0byBhbmQgc2V0dGluZ3MgdmFsdWVzIHNvIHRoZSBhcmd1bWVudHMKCQkJCS8vIHdvcmsgd2l0aCBhIGNhbGwgdG8gdGhlIGNoYW5nZSBtZXRob2QKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggW3RvUGFnZSwgc2V0dGluZ3NdICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIERFUFJFQ0FURUQgLSB0aGlzIGNhbGwgb25seSwgaW4gZmF2b3Igb2YgdGhlIGJlZm9yZSB0cmFuc2l0aW9uCgkJCS8vIGlmIHRoZSBwYWdlIGJlZm9yZWNoYW5nZSBkZWZhdWx0IGlzIHByZXZlbnRlZCByZXR1cm4gZWFybHkKCQkJaWYgKCAhdGhpcy5fdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2UodG9QYWdlLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl0cmlnZ2VyRGF0YS5wcmV2UGFnZSA9IHNldHRpbmdzLmZyb21QYWdlOwoJCQkvLyBpZiB0aGUgKGNvbnRlbnR8cGFnZSliZWZvcmV0cmFuc2l0aW9uIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQkvLyBOb3RlLCB3ZSBoYXZlIHRvIGNoZWNrIGZvciBib3RoIHRoZSBkZXByZWNhdGVkIGFuZCBuZXcgZXZlbnRzCgkJCWJlZm9yZVRyYW5zaXRpb24gPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJiZWZvcmV0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJaWYgKGJlZm9yZVRyYW5zaXRpb24uZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQliZWZvcmVUcmFuc2l0aW9uLmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkJLy8gc3VyZSBzZXR0aW5ncy5kYXRhVXJsIGlzIHNldCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXJsLiBUaGlzIGFsbG93cwoJCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJCWlmICggdG9QYWdlWyAwIF0gPT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICYmICFzZXR0aW5ncy5kYXRhVXJsICkgewoJCQkJc2V0dGluZ3MuZGF0YVVybCA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaDsKCQkJfQoKCQkJLy8gVGhlIGNhbGxlciBwYXNzZWQgdXMgYSByZWFsIHBhZ2UgRE9NIGVsZW1lbnQuIFVwZGF0ZSBvdXIKCQkJLy8gaW50ZXJuYWwgc3RhdGUgYW5kIHRoZW4gdHJpZ2dlciBhIHRyYW5zaXRpb24gdG8gdGhlIHBhZ2UuCgkJCWZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2U7CgkJCXVybCA9ICggc2V0dGluZ3MuZGF0YVVybCAmJiAkLm1vYmlsZS5wYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoc2V0dGluZ3MuZGF0YVVybCkgKSB8fAoJCQkJdG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgoJCQkvLyBUaGUgcGFnZVVybCB2YXIgaXMgdXN1YWxseSB0aGUgc2FtZSBhcyB1cmwsIGV4Y2VwdCB3aGVuIHVybCBpcyBvYnNjdXJlZAoJCQkvLyBhcyBhIGRpYWxvZyB1cmwuIHBhZ2VVcmwgYWx3YXlzIGNvbnRhaW5zIHRoZSBmaWxlIHBhdGgKCQkJcGFnZVVybCA9IHVybDsKCQkJZmlsZVVybCA9ICQubW9iaWxlLnBhdGguZ2V0RmlsZVBhdGgoIHVybCApOwoJCQlhY3RpdmUgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpOwoJCQlhY3RpdmVJc0luaXRpYWxQYWdlID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMDsKCQkJaGlzdG9yeURpciA9IDA7CgkJCXBhZ2VUaXRsZSA9IGRvY3VtZW50LnRpdGxlOwoJCQlpc0RpYWxvZyA9ICggc2V0dGluZ3Mucm9sZSA9PT0gImRpYWxvZyIgfHwKCQkJCXRvUGFnZS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImRpYWxvZyIgKSAmJgoJCQkJdG9QYWdlLmpxbURhdGEoICJkaWFsb2ciICkgIT09IHRydWU7CgoJCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCQkvLyBhcmUgdGhlIHNhbWUgZWxlbWVudCwgYnV0IGZvbGtzIHRoYXQgZ2VuZXJhdGUgY29udGVudAoJCQkvLyBtYW51YWxseS9keW5hbWljYWxseSBhbmQgcmV1c2UgcGFnZXMgd2FudCB0byBiZSBhYmxlIHRvIHRyYW5zaXRpb24gdG8KCQkJLy8gdGhlIHNhbWUgcGFnZS4gVG8gYWxsb3cgdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0CgkJCS8vIHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uIHRvIHRydWUsICpPUiosIHBhc3MgaXQgaW4gYXMgYW4KCQkJLy8gb3B0aW9uIHdoZW4gdGhleSBtYW51YWxseSBjYWxsIGNoYW5nZVBhZ2UoKS4gSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQKCQkJLy8gb3VyIGRlZmF1bHQgdHJhbnNpdGlvbiBhbmltYXRpb25zIGFzc3VtZSB0aGF0IHRoZSBmb3JtUGFnZSBhbmQgdG9QYWdlCgkJCS8vIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuIEl0IGlzIHVwIHRvCgkJCS8vIHRoZSBkZXZlbG9wZXIgdGhhdCB0dXJucyBvbiB0aGUgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb25hIG9wdGlvbiB0bwoJCQkvLyBlaXRoZXIgdHVybiBvZmYgdHJhbnNpdGlvbiBhbmltYXRpb25zLCBvciBtYWtlIHN1cmUgdGhhdCBhbiBhcHByb3ByaWF0ZQoJCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCQlpZiAoIGZyb21QYWdlICYmIGZyb21QYWdlWzBdID09PSB0b1BhZ2VbMF0gJiYKCQkJCSFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJ0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgoJCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUKCQkJCS8vIHVybEhpc3RvcnkgaW4gc3luYyB3aXRoIHRoZSBoYXNoIGNoYW5nZXMKCQkJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5kaXJlY3QoeyB1cmw6IHVybCB9KTsKCQkJCX0KCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYWdlIHdlIGFyZSBnaXZlbiBoYXMgYWxyZWFkeSBiZWVuIGVuaGFuY2VkLgoJCQl0b1BhZ2UucGFnZSh7IHJvbGU6IHNldHRpbmdzLnJvbGUgfSk7CgoJCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0bwoJCQkvLyBzZWUgaWYgdGhlIHBhZ2UgaXMgYWxyZWFkeSB3aXRoaW4gdGhlIHVybEhpc3Rvcnkgc3RhY2suIElmIHNvLCB3ZSdsbAoJCQkvLyBhc3N1bWUgdGhlIHVzZXIgaGl0IHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUKCQkJLy8gdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCWhpc3RvcnlEaXIgPSBzZXR0aW5ncy5kaXJlY3Rpb24gPT09ICJiYWNrIiA/IC0xIDogMTsKCQkJfQoKCQkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4KCQkJLy8gICAgICAgICAgICBJbnN0ZWFkLCB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkKCQkJLy8gICAgICAgICAgICBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZSB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMKCQkJLy8gICAgICAgICAgICBwb2ludC4KCQkJLy8gV3JhcCB0aGlzIGluIGEgdHJ5L2NhdGNoIGJsb2NrIHNpbmNlIElFOSB0aHJvdyAiVW5zcGVjaWZpZWQgZXJyb3IiIGlmCgkJCS8vIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQkJdHJ5IHsKCQkJCWlmICggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJgoJCQkJCWRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gImJvZHkiICkgewoKCQkJCQkkKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICkuYmx1cigpOwoJCQkJfSBlbHNlIHsKCQkJCQkkKCAiaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzLCBzZWxlY3Q6Zm9jdXMiICkuYmx1cigpOwoJCQkJfQoJCQl9IGNhdGNoKCBlICkge30KCgkJCS8vIFJlY29yZCB3aGV0aGVyIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3Rvcnkgd2hlcmUgYSBkaWFsb2cgdXNlZCB0byBiZSAtCgkJCS8vIGlmIHNvLCBkbyBub3QgYWRkIGEgbmV3IGhpc3RvcnkgZW50cnkgYW5kIGRvIG5vdCBjaGFuZ2UgdGhlIGhhc2ggZWl0aGVyCgkJCWFscmVhZHlUaGVyZSA9IGZhbHNlOwoKCQkJLy8gSWYgd2UncmUgZGlzcGxheWluZyB0aGUgcGFnZSBhcyBhIGRpYWxvZywgd2UgZG9uJ3Qgd2FudCB0aGUgdXJsCgkJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCQkvLyB0byBhcHBlbmQgdGhlIGRpYWxvZ0hhc2hLZXkgdG8gdGhlIHVybCBvZiB0aGUgY3VycmVudCBwYWdlLgoJCQlpZiAoIGlzRGlhbG9nICYmIGFjdGl2ZSApIHsKCQkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlCgkJCQkvLyBzaG91bGQgYmUgYW4gZW1wdHkgc3RyaW5nLiBNb3ZpbmcgdGhlIHVuZGVmaW5lZCAtPiBlbXB0eSBzdHJpbmcgYmFjawoJCQkJLy8gaW50byB1cmxIaXN0b3J5LmFkZE5ldyBzZWVtZWQgaW1wcnVkZW50IGdpdmVuIHVuZGVmaW5lZCBiZXR0ZXIKCQkJCS8vIHJlcHJlc2VudHMgdGhlIHVybCBzdGF0ZQoKCQkJCS8vIElmIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3RvcnkgdGhhdCBvbmNlIGJlbG9uZ2VkIHRvIGEgZGlhbG9nLCByZXVzZQoJCQkJLy8gdGhpcyBzdGF0ZSB3aXRob3V0IGFkZGluZyB0byB1cmxIaXN0b3J5IGFuZCB3aXRob3V0IG1vZGlmeWluZyB0aGUKCQkJCS8vIGhhc2guIEhvd2V2ZXIsIGlmIGEgZGlhbG9nIGlzIGFscmVhZHkgZGlzcGxheWVkIGF0IHRoaXMgcG9pbnQsIGFuZAoJCQkJLy8gd2UncmUgYWJvdXQgdG8gZGlzcGxheSBhbm90aGVyIGRpYWxvZywgdGhlbiB3ZSBtdXN0IGFkZCBhbm90aGVyIGhhc2gKCQkJCS8vIGFuZCBoaXN0b3J5IGVudHJ5IG9uIHRvcCBzbyB0aGF0IG9uZSBtYXkgbmF2aWdhdGUgYmFjayB0byB0aGUKCQkJCS8vIG9yaWdpbmFsIGRpYWxvZwoJCQkJaWYgKCBhY3RpdmUudXJsICYmCgkJCQkJYWN0aXZlLnVybC5pbmRleE9mKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgPiAtMSAmJgoJCQkJCXRoaXMuYWN0aXZlUGFnZSAmJgoJCQkJCSF0aGlzLmFjdGl2ZVBhZ2UuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgJiYKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApIHsKCgkJCQkJc2V0dGluZ3MuY2hhbmdlSGFzaCA9IGZhbHNlOwoJCQkJCWFscmVhZHlUaGVyZSA9IHRydWU7CgkJCQl9CgoJCQkJLy8gTm9ybWFsbHksIHdlIHRhY2sgb24gYSBkaWFsb2cgaGFzaCBrZXksIGJ1dCBpZiB0aGlzIGlzIHRoZSBsb2NhdGlvbgoJCQkJLy8gb2YgYSBzdGFsZSBkaWFsb2csIHdlIHJldXNlIHRoZSBVUkwgZnJvbSB0aGUgZW50cnkKCQkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApOwoKCQkJCS8vIGFjY291bnQgZm9yIGFic29sdXRlIHVybHMgaW5zdGVhZCBvZiBqdXN0IHJlbGF0aXZlIHVybHMgdXNlIGFzIGhhc2hlcwoJCQkJaWYgKCAhYWxyZWFkeVRoZXJlICYmIHVybC5pbmRleE9mKCIjIikgPiAtMSApIHsKCQkJCQl1cmwgKz0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJCX0gZWxzZSB7CgkJCQkJdXJsICs9ICIjIiArICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJCQl9CgkJCX0KCgkJCS8vIGlmIHRpdGxlIGVsZW1lbnQgd2Fzbid0IGZvdW5kLCB0cnkgdGhlIHBhZ2UgZGl2IGRhdGEgYXR0ciB0b28KCQkJLy8gSWYgdGhpcyBpcyBhIGRlZXAtbGluayBvciBhIHJlbG9hZCAoIGFjdGl2ZSA9PT0gdW5kZWZpbmVkICkgdGhlbiBqdXN0CgkJCS8vIHVzZSBwYWdlVGl0bGUKCQkJbmV3UGFnZVRpdGxlID0gKCAhYWN0aXZlICkgPyBwYWdlVGl0bGUgOiB0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApIHx8CgkJCQl0b1BhZ2UuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maW5kKCAiLnVpLXRpdGxlIiApLnRleHQoKTsKCQkJaWYgKCAhIW5ld1BhZ2VUaXRsZSAmJiBwYWdlVGl0bGUgPT09IGRvY3VtZW50LnRpdGxlICkgewoJCQkJcGFnZVRpdGxlID0gbmV3UGFnZVRpdGxlOwoJCQl9CgkJCWlmICggIXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgKSB7CgkJCQl0b1BhZ2UuanFtRGF0YSggInRpdGxlIiwgcGFnZVRpdGxlICk7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgdHJhbnNpdGlvbiBkZWZpbmVkLgoJCQlzZXR0aW5ncy50cmFuc2l0aW9uID0gc2V0dGluZ3MudHJhbnNpdGlvbiB8fAoJCQkJKCAoIGhpc3RvcnlEaXIgJiYgIWFjdGl2ZUlzSW5pdGlhbFBhZ2UgKSA/IGFjdGl2ZS50cmFuc2l0aW9uIDogdW5kZWZpbmVkICkgfHwKCQkJCSggaXNEaWFsb2cgPyAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiA6ICQubW9iaWxlLmRlZmF1bHRQYWdlVHJhbnNpdGlvbiApOwoKCQkJLy9hZGQgcGFnZSB0byBoaXN0b3J5IHN0YWNrIGlmIGl0J3Mgbm90IGJhY2sgb3IgZm9yd2FyZAoJCQlpZiAoICFoaXN0b3J5RGlyICYmIGFscmVhZHlUaGVyZSApIHsKCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCkucGFnZVVybCA9IHBhZ2VVcmw7CgkJCX0KCgkJCS8vIFNldCB0aGUgbG9jYXRpb24gaGFzaC4KCQkJaWYgKCB1cmwgJiYgIXNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoKCQkJCS8vIHJlYnVpbGRpbmcgdGhlIGhhc2ggaGVyZSBzaW5jZSB3ZSBsb29zZSBpdCBlYXJsaWVyIG9uCgkJCQkvLyBUT0RPIHByZXNlcnZlIHRoZSBvcmlnaW5hbGx5IHBhc3NlZCBpbiBwYXRoCgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggdXJsICkgJiYgdXJsLmluZGV4T2YoICIjIiApIDwgMCApIHsKCQkJCQl1cmwgPSAiIyIgKyB1cmw7CgkJCQl9CgoJCQkJLy8gVE9ETyB0aGUgcHJvcGVydHkgbmFtZXMgaGVyZSBhcmUganVzdCBzaWxseQoJCQkJcGFyYW1zID0gewoJCQkJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiwKCQkJCQl0cmFuc2l0aW9uOiBzZXR0aW5ncy50cmFuc2l0aW9uLAoJCQkJCXRpdGxlOiBwYWdlVGl0bGUsCgkJCQkJcGFnZVVybDogcGFnZVVybCwKCQkJCQlyb2xlOiBzZXR0aW5ncy5yb2xlCgkJCQl9OwoKCQkJCWlmICggc2V0dGluZ3MuY2hhbmdlSGFzaCAhPT0gZmFsc2UgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwgcGFyYW1zLCB0cnVlKTsKCQkJCX0gZWxzZSBpZiAoIHRvUGFnZVsgMCBdICE9PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFkZCggdXJsLCBwYXJhbXMgKTsKCQkJCX0KCQkJfQoKCQkJLy9zZXQgcGFnZSB0aXRsZQoJCQlkb2N1bWVudC50aXRsZSA9IHBhZ2VUaXRsZTsKCgkJCS8vc2V0ICJ0b1BhZ2UiIGFzIGFjdGl2ZVBhZ2UgZGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCQkkLm1vYmlsZS5hY3RpdmVQYWdlID0gdG9QYWdlOwoKCQkJLy9uZXcgd2F5IHRvIGhhbmRsZSBhY3RpdmVQYWdlCgkJCXRoaXMuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJCS8vIElmIHdlJ3JlIG5hdmlnYXRpbmcgYmFjayBpbiB0aGUgVVJMIGhpc3RvcnksIHNldCByZXZlcnNlIGFjY29yZGluZ2x5LgoJCQlzZXR0aW5ncy5yZXZlcnNlID0gc2V0dGluZ3MucmV2ZXJzZSB8fCBoaXN0b3J5RGlyIDwgMDsKCgkJCWNzc1RyYW5zaXRpb25EZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJCXRoaXMuX2Nzc1RyYW5zaXRpb24odG9QYWdlLCBmcm9tUGFnZSwgewoJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCXJldmVyc2U6IHNldHRpbmdzLnJldmVyc2UsCgkJCQlkZWZlcnJlZDogY3NzVHJhbnNpdGlvbkRlZmVycmVkCgkJCX0pOwoKCQkJY3NzVHJhbnNpdGlvbkRlZmVycmVkLmRvbmUoJC5wcm94eShmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSwgYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQkkLm1vYmlsZS5yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoKTsKCgkJCQkvL2lmIHRoZXJlJ3MgYSBkdXBsaWNhdGVDYWNoZWRQYWdlLCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NIG5vdyB0aGF0IGl0J3MgaGlkZGVuCgkJCQlpZiAoIHNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgKSB7CgkJCQkJc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZS5yZW1vdmUoKTsKCQkJCX0KCgkJCQkvLyBkZXNwaXRlIHZpc2liaWxpdHk6IGhpZGRlbiBhZGRyZXNzZXMgaXNzdWUgIzI5NjUKCQkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMjk2NQoJCQkJaWYgKCAhYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0b1BhZ2UgKTsKCQkJCX0KCgkJCQl0aGlzLl9yZWxlYXNlVHJhbnNpdGlvbkxvY2soKTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggInRyYW5zaXRpb24iLCB0cmlnZ2VyRGF0YSApOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAiY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSwgdGhpcykpOwoJCX0sCgoJCS8vIGRldGVybWluZSB0aGUgY3VycmVudCBiYXNlIHVybAoJCV9maW5kQmFzZVdpdGhEZWZhdWx0OiBmdW5jdGlvbigpIHsKCQkJdmFyIGNsb3Nlc3RCYXNlID0gKCB0aGlzLmFjdGl2ZVBhZ2UgJiYKCQkJJC5tb2JpbGUuZ2V0Q2xvc2VzdEJhc2VVcmwoIHRoaXMuYWN0aXZlUGFnZSApICk7CgkJcmV0dXJuIGNsb3Nlc3RCYXNlIHx8ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgkJfQoJfSk7CgoJLy8gVGhlIGZvbGxvd2luZyBoYW5kbGVycyBzaG91bGQgYmUgYm91bmQgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgYmVlbiB0cmlnZ2VyZWQKCS8vIHRoZSBmb2xsb3dpbmcgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW4gdGhlIGluaXQgZmlsZQoJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkvL3RoZXNlIHZhcmlhYmxlcyBtYWtlIGFsbCBwYWdlIGNvbnRhaW5lcnMgdXNlIHRoZSBzYW1lIHF1ZXVlIGFuZCBvbmx5IG5hdmlnYXRlIG9uZSBhdCBhIHRpbWUKCS8vIHF1ZXVlIHRvIGhvbGQgc2ltdWx0YW5pb3VzIHBhZ2UgdHJhbnNpdGlvbnMKCXZhciBwYWdlVHJhbnNpdGlvblF1ZXVlID0gW10sCgoJCS8vIGluZGljYXRlcyB3aGV0aGVyIG9yIG5vdCBwYWdlIGlzIGluIHByb2Nlc3Mgb2YgdHJhbnNpdGlvbmluZwoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCQkvLyByZXNvbHZlZCBvbiBkb21yZWFkeQoJdmFyIGRvbXJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCksCgoJCS8vIHJlc29sdmVkIGFuZCBudWxsZWQgb24gd2luZG93LmxvYWQoKQoJCWxvYWREZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJLy8gZnVuY3Rpb24gdGhhdCByZXNvbHZlcyB0aGUgYWJvdmUgZGVmZXJyZWQKCQlwYWdlSXNGdWxseUxvYWRlZCA9IGZ1bmN0aW9uKCkgewoKCQkJLy8gUmVzb2x2ZSBhbmQgbnVsbCB0aGUgZGVmZXJyZWQKCQkJbG9hZERlZmVycmVkLnJlc29sdmUoKTsKCQkJbG9hZERlZmVycmVkID0gbnVsbDsKCQl9LAoKCQlkb2N1bWVudFVybCA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRVcmwsCgoJCS8vIHVzZWQgdG8gdHJhY2sgbGFzdCB2Y2xpY2tlZCBlbGVtZW50IHRvIG1ha2Ugc3VyZSBpdHMgdmFsdWUgaXMgYWRkZWQgdG8gZm9ybSBkYXRhCgkJJGxhc3RWQ2xpY2tlZCA9IG51bGw7CgoJLyogRXZlbnQgQmluZGluZ3MgLSBoYXNoY2hhbmdlLCBzdWJtaXQsIGFuZCBjbGljayAqLwoJZnVuY3Rpb24gZmluZENsb3Nlc3RMaW5rKCBlbGUgKQl7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCS8vIExvb2sgZm9yIHRoZSBjbG9zZXN0IGVsZW1lbnQgd2l0aCBhIG5vZGVOYW1lIG9mICJhIi4KCQkJLy8gTm90ZSB0aGF0IHdlIGFyZSBjaGVja2luZyBpZiB3ZSBoYXZlIGEgdmFsaWQgbm9kZU5hbWUKCQkJLy8gYmVmb3JlIGF0dGVtcHRpbmcgdG8gYWNjZXNzIGl0LiBUaGlzIGlzIGJlY2F1c2UgdGhlCgkJCS8vIG5vZGUgd2UgZ2V0IGNhbGxlZCB3aXRoIGNvdWxkIGhhdmUgb3JpZ2luYXRlZCBmcm9tIHdpdGhpbgoJCQkvLyBhbiBlbWJlZGRlZCBTVkcgZG9jdW1lbnQgd2hlcmUgc29tZSBzeW1ib2wgaW5zdGFuY2UgZWxlbWVudHMKCQkJLy8gZG9uJ3QgaGF2ZSBub2RlTmFtZSBkZWZpbmVkIG9uIHRoZW0sIG9yIHN0cmluZ3MgYXJlIG9mIHR5cGUKCQkJLy8gU1ZHQW5pbWF0ZWRTdHJpbmcuCgkJCWlmICggKCB0eXBlb2YgZWxlLm5vZGVOYW1lID09PSAic3RyaW5nIiApICYmIGVsZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiYSIgKSB7CgkJCQlicmVhazsKCQkJfQoJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIGVsZTsKCX0KCgkkLm1vYmlsZS5sb2FkUGFnZSA9IGZ1bmN0aW9uKCB1cmwsIG9wdHMgKSB7CgkJdmFyIGNvbnRhaW5lcjsKCgkJb3B0cyA9IG9wdHMgfHwge307CgkJY29udGFpbmVyID0gKCBvcHRzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkvLyBjcmVhdGUgdGhlIGRlZmVycmVkIHRoYXQgd2lsbCBiZSBzdXBwbGllZCB0byBsb2FkUGFnZSBjYWxsZXJzCgkJLy8gYW5kIHJlc29sdmVkIGJ5IHRoZSBjb250ZW50IHdpZGdldCdzIGxvYWQgbWV0aG9kCgkJb3B0cy5kZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCgkJLy8gUHJlZmVycmluZyB0byBhbGxvdyBleGNlcHRpb25zIGZvciB1bmluaXRpYWxpemVkIG9wdHMucGFnZUNvbnRhaW5lcgoJCS8vIHdpZGdldHMgc28gd2Uga25vdyBpZiB3ZSBuZWVkIHRvIGZvcmNlIGluaXQgaGVyZSBmb3IgdXNlcnMKCQljb250YWluZXIucGFnZWNvbnRhaW5lciggImxvYWQiLCB1cmwsIG9wdHMgKTsKCgkJLy8gcHJvdmlkZSB0aGUgZGVmZXJyZWQKCQlyZXR1cm4gb3B0cy5kZWZlcnJlZC5wcm9taXNlKCk7Cgl9OwoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgoJLyogaW50ZXJuYWwgdXRpbGl0eSBmdW5jdGlvbnMgKi8KCgkvLyBOT1RFIElzc3VlICM0OTUwIEFuZHJvaWQgcGhvbmVnYXAgZG9lc24ndCBuYXZpZ2F0ZSBiYWNrIHByb3Blcmx5CgkvLyAgICAgIHdoZW4gYSBmdWxsIHBhZ2UgcmVmcmVzaCBoYXMgdGFrZW4gcGxhY2UuIEl0IGFwcGVhcnMgdGhhdCBoYXNoY2hhbmdlCgkvLyAgICAgIGFuZCByZXBsYWNlc3RhdGUgaGlzdG9yeSBhbHRlcmF0aW9ucyB3b3JrIGZpbmUgYnV0IHdlIG5lZWQgdG8gc3VwcG9ydAoJLy8gICAgICBib3RoIGZvcm1zIG9mIGhpc3RvcnkgdHJhdmVyc2FsIGluIG91ciBjb2RlIHRoYXQgdXNlcyBiYWNrd2FyZCBoaXN0b3J5CgkvLyAgICAgIG1vdmVtZW50CgkkLm1vYmlsZS5iYWNrID0gZnVuY3Rpb24oKSB7CgkJdmFyIG5hdiA9IHdpbmRvdy5uYXZpZ2F0b3I7CgoJCS8vIGlmIHRoZSBzZXR0aW5nIGlzIG9uIGFuZCB0aGUgbmF2aWdhdG9yIG9iamVjdCBpcwoJCS8vIGF2YWlsYWJsZSB1c2UgdGhlIHBob25lZ2FwIG5hdmlnYXRpb24gY2FwYWJpbGl0eQoJCWlmICggdGhpcy5waG9uZWdhcE5hdmlnYXRpb25FbmFibGVkICYmCgkJCW5hdiAmJgoJCQluYXYuYXBwICYmCgkJCW5hdi5hcHAuYmFja0hpc3RvcnkgKSB7CgkJCW5hdi5hcHAuYmFja0hpc3RvcnkoKTsKCQl9IGVsc2UgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnBhZ2Vjb250YWluZXIoICJiYWNrIiApOwoJCX0KCX07CgoJLy8gRGlyZWN0IGZvY3VzIHRvIHRoZSBwYWdlIHRpdGxlLCBvciBvdGhlcndpc2UgZmlyc3QgZm9jdXNhYmxlIGVsZW1lbnQKCSQubW9iaWxlLmZvY3VzUGFnZSA9IGZ1bmN0aW9uICggcGFnZSApIHsKCQl2YXIgYXV0b2ZvY3VzID0gcGFnZS5maW5kKCAiW2F1dG9mb2N1c10iICksCgkJCXBhZ2VUaXRsZSA9IHBhZ2UuZmluZCggIi51aS10aXRsZTplcSgwKSIgKTsKCgkJaWYgKCBhdXRvZm9jdXMubGVuZ3RoICkgewoJCQlhdXRvZm9jdXMuZm9jdXMoKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBwYWdlVGl0bGUubGVuZ3RoICkgewoJCQlwYWdlVGl0bGUuZm9jdXMoKTsKCQl9IGVsc2V7CgkJCXBhZ2UuZm9jdXMoKTsKCQl9Cgl9OwoKCS8vIE5vLW9wIGltcGxlbWVudGF0aW9uIG9mIHRyYW5zaXRpb24gZGVncmFkYXRpb24KCSQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gfHwgZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJcmV0dXJuIHRyYW5zaXRpb247Cgl9OwoKCS8vIEV4cG9zZWQgJC5tb2JpbGUgbWV0aG9kcwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UgPSBmdW5jdGlvbiggdG8sIG9wdGlvbnMgKSB7CgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5wYWdlY29udGFpbmVyKCAiY2hhbmdlIiwgdG8sIG9wdGlvbnMgKTsKCX07CgoJJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cyA9IHsKCQl0cmFuc2l0aW9uOiB1bmRlZmluZWQsCgkJcmV2ZXJzZTogZmFsc2UsCgkJY2hhbmdlSGFzaDogdHJ1ZSwKCQlmcm9tSGFzaENoYW5nZTogZmFsc2UsCgkJcm9sZTogdW5kZWZpbmVkLCAvLyBCeSBkZWZhdWx0IHdlIHJlbHkgb24gdGhlIHJvbGUgZGVmaW5lZCBieSB0aGUgQGRhdGEtcm9sZSBhdHRyaWJ1dGUuCgkJZHVwbGljYXRlQ2FjaGVkUGFnZTogdW5kZWZpbmVkLAoJCXBhZ2VDb250YWluZXI6IHVuZGVmaW5lZCwKCQlzaG93TG9hZE1zZzogdHJ1ZSwgLy9sb2FkaW5nIG1lc3NhZ2Ugc2hvd3MgYnkgZGVmYXVsdCB3aGVuIHBhZ2VzIGFyZSBiZWluZyBmZXRjaGVkIGR1cmluZyBjaGFuZ2VQYWdlCgkJZGF0YVVybDogdW5kZWZpbmVkLAoJCWZyb21QYWdlOiB1bmRlZmluZWQsCgkJYWxsb3dTYW1lUGFnZVRyYW5zaXRpb246IGZhbHNlCgl9OwoKCSQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzID0gZnVuY3Rpb24oKSB7CgkJdmFyIGdldEFqYXhGb3JtRGF0YSA9IGZ1bmN0aW9uKCAkZm9ybSwgY2FsY3VsYXRlT25seSApIHsKCQkJdmFyIHVybCwgcmV0ID0gdHJ1ZSwgZm9ybURhdGEsIHZjbGlja2VkTmFtZSwgbWV0aG9kOwoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCB8fAoJCQkJCS8vIHRlc3QgdGhhdCB0aGUgZm9ybSBpcywgaXRzZWxmLCBhamF4IGZhbHNlCgkJCQkJJGZvcm0uaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8CgkJCQkJLy8gdGVzdCB0aGF0ICQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCBhbmQKCQkJCQkvLyB0aGUgZm9ybSBvciBvbmUgb2YgaXQncyBwYXJlbnRzIGlzIGFqYXg9ZmFsc2UKCQkJCQkhJGZvcm0uanFtSGlqYWNrYWJsZSgpLmxlbmd0aCB8fAoJCQkJCSRmb3JtLmF0dHIoICJ0YXJnZXQiICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXVybCA9ICggJGxhc3RWQ2xpY2tlZCAmJiAkbGFzdFZDbGlja2VkLmF0dHIoICJmb3JtYWN0aW9uIiApICkgfHwKCQkJCSRmb3JtLmF0dHIoICJhY3Rpb24iICk7CgkJCW1ldGhvZCA9ICggJGZvcm0uYXR0ciggIm1ldGhvZCIgKSB8fCAiZ2V0IiApLnRvTG93ZXJDYXNlKCk7CgoJCQkvLyBJZiBubyBhY3Rpb24gaXMgc3BlY2lmaWVkLCBicm93c2VycyBkZWZhdWx0IHRvIHVzaW5nIHRoZQoJCQkvLyBVUkwgb2YgdGhlIGRvY3VtZW50IGNvbnRhaW5pbmcgdGhlIGZvcm0uIFNpbmNlIHdlIGR5bmFtaWNhbGx5CgkJCS8vIHB1bGwgaW4gcGFnZXMgZnJvbSBleHRlcm5hbCBkb2N1bWVudHMsIHRoZSBmb3JtIHNob3VsZCBzdWJtaXQKCQkJLy8gdG8gdGhlIFVSTCBmb3IgdGhlIHNvdXJjZSBkb2N1bWVudCBvZiB0aGUgcGFnZSBjb250YWluaW5nCgkJCS8vIHRoZSBmb3JtLgoJCQlpZiAoICF1cmwgKSB7CgkJCQkvLyBHZXQgdGhlIEBkYXRhLXVybCBmb3IgdGhlIHBhZ2UgY29udGFpbmluZyB0aGUgZm9ybS4KCQkJCXVybCA9ICQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApOwoKCQkJCS8vIE5PVEU6IElmIHRoZSBtZXRob2QgaXMgImdldCIsIHdlIG5lZWQgdG8gc3RyaXAgb2ZmIHRoZSBxdWVyeSBzdHJpbmcKCQkJCS8vIGJlY2F1c2UgaXQgd2lsbCBnZXQgcmVwbGFjZWQgd2l0aCB0aGUgbmV3IGZvcm0gZGF0YS4gU2VlIGlzc3VlICM1NzEwLgoJCQkJaWYgKCBtZXRob2QgPT09ICJnZXQiICkgewoJCQkJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VVcmwoIHVybCApLmhyZWZOb1NlYXJjaDsKCQkJCX0KCgkJCQlpZiAoIHVybCA9PT0gJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApIHsKCQkJCQkvLyBUaGUgdXJsIHdlIGdvdCBiYWNrIG1hdGNoZXMgdGhlIGRvY3VtZW50IGJhc2UsCgkJCQkJLy8gd2hpY2ggbWVhbnMgdGhlIHBhZ2UgbXVzdCBiZSBhbiBpbnRlcm5hbC9lbWJlZGRlZCBwYWdlLAoJCQkJCS8vIHNvIGRlZmF1bHQgdG8gdXNpbmcgdGhlIGFjdHVhbCBkb2N1bWVudCB1cmwgYXMgYSBicm93c2VyCgkJCQkJLy8gd291bGQuCgkJCQkJdXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vU2VhcmNoOwoJCQkJfQoJCQl9CgoJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIHVybCwgJC5tb2JpbGUuZ2V0Q2xvc2VzdEJhc2VVcmwoICRmb3JtICkgKTsKCgkJCWlmICggKCAkLm1vYmlsZS5wYXRoLmlzRXh0ZXJuYWwoIHVybCApICYmICEkLm1vYmlsZS5wYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgdXJsICkgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJaWYgKCAhY2FsY3VsYXRlT25seSApIHsKCQkJCWZvcm1EYXRhID0gJGZvcm0uc2VyaWFsaXplQXJyYXkoKTsKCgkJCQlpZiAoICRsYXN0VkNsaWNrZWQgJiYgJGxhc3RWQ2xpY2tlZFsgMCBdLmZvcm0gPT09ICRmb3JtWyAwIF0gKSB7CgkJCQkJdmNsaWNrZWROYW1lID0gJGxhc3RWQ2xpY2tlZC5hdHRyKCAibmFtZSIgKTsKCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJLy8gTWFrZSBzdXJlIHRoZSBsYXN0IGNsaWNrZWQgZWxlbWVudCBpcyBpbmNsdWRlZCBpbiB0aGUgZm9ybQoJCQkJCQkkLmVhY2goIGZvcm1EYXRhLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCQkJCWlmICggdmFsdWUubmFtZSA9PT0gdmNsaWNrZWROYW1lICkgewoJCQkJCQkJCS8vIFVuc2V0IHZjbGlja2VkTmFtZSAtIHdlJ3ZlIGZvdW5kIGl0IGluIHRoZSBzZXJpYWxpemVkIGRhdGEgYWxyZWFkeQoJCQkJCQkJCXZjbGlja2VkTmFtZSA9ICIiOwoJCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJCWlmICggdmNsaWNrZWROYW1lICkgewoJCQkJCQkJZm9ybURhdGEucHVzaCggeyBuYW1lOiB2Y2xpY2tlZE5hbWUsIHZhbHVlOiAkbGFzdFZDbGlja2VkLmF0dHIoICJ2YWx1ZSIgKSB9ICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJcmV0ID0gewoJCQkJCXVybDogdXJsLAoJCQkJCW9wdGlvbnM6IHsKCQkJCQkJdHlwZToJCW1ldGhvZCwKCQkJCQkJZGF0YToJCSQucGFyYW0oIGZvcm1EYXRhICksCgkJCQkJCXRyYW5zaXRpb246CSRmb3JtLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJCQlyZXZlcnNlOgkkZm9ybS5qcW1EYXRhKCAiZGlyZWN0aW9uIiApID09PSAicmV2ZXJzZSIsCgkJCQkJCXJlbG9hZFBhZ2U6CXRydWUKCQkJCQl9CgkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCS8vYmluZCB0byBmb3JtIHN1Ym1pdCBldmVudHMsIGhhbmRsZSB3aXRoIEFqYXgKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggImZvcm0iLCAic3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZm9ybURhdGE7CgoJCQlpZiAoICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCWZvcm1EYXRhID0gZ2V0QWpheEZvcm1EYXRhKCAkKCB0aGlzICkgKTsKCQkJCWlmICggZm9ybURhdGEgKSB7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggZm9ybURhdGEudXJsLCBmb3JtRGF0YS5vcHRpb25zICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQkvL2FkZCBhY3RpdmUgc3RhdGUgb24gdmNsaWNrCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICRidG4sIGJ0bkVscywgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LCBuZWVkQ2xvc2VzdCA9IGZhbHNlOwoJCQkvLyBpZiB0aGlzIGlzbid0IGEgbGVmdCBjbGljayB3ZSBkb24ndCBjYXJlLiBJdHMgaW1wb3J0YW50IHRvIG5vdGUKCQkJLy8gdGhhdCB3aGVuIHRoZSB2aXJ0dWFsIGV2ZW50IGlzIGdlbmVyYXRlZCBpdCB3aWxsIGNyZWF0ZSB0aGUgd2hpY2ggYXR0cgoJCQlpZiAoIGV2ZW50LndoaWNoID4gMSB8fCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBSZWNvcmQgdGhhdCB0aGlzIGVsZW1lbnQgd2FzIGNsaWNrZWQsIGluIGNhc2Ugd2UgbmVlZCBpdCBmb3IgY29ycmVjdAoJCQkvLyBmb3JtIHN1Ym1pc3Npb24gZHVyaW5nIHRoZSAic3VibWl0IiBoYW5kbGVyIGFib3ZlCgkJCSRsYXN0VkNsaWNrZWQgPSAkKCB0YXJnZXQgKTsKCgkJCS8vIFRyeSB0byBmaW5kIGEgdGFyZ2V0IGVsZW1lbnQgdG8gd2hpY2ggdGhlIGFjdGl2ZSBjbGFzcyB3aWxsIGJlIGFwcGxpZWQKCQkJaWYgKCAkLmRhdGEoIHRhcmdldCwgIm1vYmlsZS1idXR0b24iICkgKSB7CgkJCQkvLyBJZiB0aGUgZm9ybSB3aWxsIG5vdCBiZSBzdWJtaXR0ZWQgdmlhIEFKQVgsIGRvIG5vdCBhZGQgYWN0aXZlIGNsYXNzCgkJCQlpZiAoICFnZXRBamF4Rm9ybURhdGEoICQoIHRhcmdldCApLmNsb3Nlc3QoICJmb3JtIiApLCB0cnVlICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJLy8gV2Ugd2lsbCBhcHBseSB0aGUgYWN0aXZlIHN0YXRlIHRvIHRoaXMgYnV0dG9uIHdpZGdldCAtIHRoZSBwYXJlbnQKCQkJCS8vIG9mIHRoZSBpbnB1dCB0aGF0IHdhcyBjbGlja2VkIHdpbGwgaGF2ZSB0aGUgYXNzb2NpYXRlZCBkYXRhCgkJCQlpZiAoIHRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJCXRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJdGFyZ2V0ID0gZmluZENsb3Nlc3RMaW5rKCB0YXJnZXQgKTsKCQkJCWlmICggISggdGFyZ2V0ICYmICQubW9iaWxlLnBhdGgucGFyc2VVcmwoIHRhcmdldC5nZXRBdHRyaWJ1dGUoICJocmVmIiApIHx8ICIjIiApLmhhc2ggIT09ICIjIiApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZQoJCQkJLy8gbGluayB3cmFwcGluZyBjYW4gYmUgYXZvaWRlZAoJCQkJaWYgKCAhJCggdGFyZ2V0ICkuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIEF2b2lkIGNhbGxpbmcgLmNsb3Nlc3QgYnkgdXNpbmcgdGhlIGRhdGEgc2V0IGR1cmluZyAuYnV0dG9uTWFya3VwKCkKCQkJLy8gTGlzdCBpdGVtcyBoYXZlIHRoZSBidXR0b24gZGF0YSBpbiB0aGUgcGFyZW50IG9mIHRoZSBlbGVtZW50IGNsaWNrZWQKCQkJaWYgKCAhIX50YXJnZXQuY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1saW5rLWluaGVyaXQiICkgKSB7CgkJCQlpZiAoIHRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LnBhcmVudE5vZGUsICJidXR0b25FbGVtZW50cyIgKTsKCQkJCX0KCQkJLy8gT3RoZXJ3aXNlLCBsb29rIGZvciB0aGUgZGF0YSBvbiB0aGUgdGFyZ2V0IGl0c2VsZgoJCQl9IGVsc2UgewoJCQkJYnRuRWxzID0gJC5kYXRhKCB0YXJnZXQsICJidXR0b25FbGVtZW50cyIgKTsKCQkJfQoJCQkvLyBJZiBmb3VuZCwgZ3JhYiB0aGUgYnV0dG9uJ3Mgb3V0ZXIgZWxlbWVudAoJCQlpZiAoIGJ0bkVscyApIHsKCQkJCXRhcmdldCA9IGJ0bkVscy5vdXRlcjsKCQkJfSBlbHNlIHsKCQkJCW5lZWRDbG9zZXN0ID0gdHJ1ZTsKCQkJfQoKCQkJJGJ0biA9ICQoIHRhcmdldCApOwoJCQkvLyBJZiB0aGUgb3V0ZXIgZWxlbWVudCB3YXNuJ3QgZm91bmQgYnkgdGhlIG91ciBoZXVyaXN0aWNzLCB1c2UgLmNsb3Nlc3QoKQoJCQlpZiAoIG5lZWRDbG9zZXN0ICkgewoJCQkJJGJ0biA9ICRidG4uY2xvc2VzdCggIi51aS1idG4iICk7CgkJCX0KCgkJCWlmICggJGJ0bi5sZW5ndGggPiAwICYmCgkJCQkhKCAkYnRuLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiIHx8CgoJCQkJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgYWZ0ZXIgMS40LjAgcmVsZWFzZQoJCQkJCS8vIG9ubHkgdWktc3RhdGUtZGlzYWJsZWQgc2hvdWxkIGJlIHByZXNlbnQgdGhlcmVhZnRlcgoJCQkJCSRidG4uaGFzQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKSApICkgKSB7CgkJCQkkLm1vYmlsZS5yZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCSQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rID0gJGJ0bjsKCQkJCSQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7CgoJCS8vIGNsaWNrIHJvdXRpbmcgLSBkaXJlY3QgdG8gSFRUUCBvciBBamF4LCBhY2NvcmRpbmdseQoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkIHx8IGV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgbGluayA9IGZpbmRDbG9zZXN0TGluayggZXZlbnQudGFyZ2V0ICksCgkJCQkkbGluayA9ICQoIGxpbmsgKSwKCgkJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQkJaHR0cENsZWFudXAgPSBmdW5jdGlvbigpIHsKCQkJCQl3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsgJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7IH0sIDIwMCApOwoJCQkJfSwKCQkJCWJhc2VVcmwsIGhyZWYsCgkJCQl1c2VEZWZhdWx0VXJsSGFuZGxpbmcsIGlzRXh0ZXJuYWwsCgkJCQl0cmFuc2l0aW9uLCByZXZlcnNlLCByb2xlOwoKCQkJLy8gSWYgYSBidXR0b24gd2FzIGNsaWNrZWQsIGNsZWFuIHVwIHRoZSBhY3RpdmUgY2xhc3MgYWRkZWQgYnkgdmNsaWNrIGFib3ZlCgkJCWlmICggJC5tb2JpbGUuYWN0aXZlQ2xpY2tlZExpbmsgJiYKCQkJCSQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rWyAwIF0gPT09IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJfQoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggIWxpbmsgfHwgZXZlbnQud2hpY2ggPiAxIHx8ICEkbGluay5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL2lmIHRoZXJlJ3MgYSBkYXRhLXJlbD1iYWNrIGF0dHIsIGdvIGJhY2sgaW4gaGlzdG9yeQoJCQlpZiAoICRsaW5rLmlzKCAiOmpxbURhdGEocmVsPSdiYWNrJykiICkgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWJhc2VVcmwgPSAkLm1vYmlsZS5nZXRDbG9zZXN0QmFzZVVybCggJGxpbmsgKTsKCgkJCS8vZ2V0IGhyZWYsIGlmIGRlZmluZWQsIG90aGVyd2lzZSBkZWZhdWx0IHRvIGVtcHR5IGhhc2gKCQkJaHJlZiA9ICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCAkbGluay5hdHRyKCAiaHJlZiIgKSB8fCAiIyIsIGJhc2VVcmwgKTsKCgkJCS8vaWYgYWpheCBpcyBkaXNhYmxlZCwgZXhpdCBlYXJseQoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAhJC5tb2JpbGUucGF0aC5pc0VtYmVkZGVkUGFnZSggaHJlZiApICkgewoJCQkJaHR0cENsZWFudXAoKTsKCQkJCS8vdXNlIGRlZmF1bHQgY2xpY2sgaGFuZGxpbmcKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gWFhYX2pibGFzOiBJZGVhbGx5IGxpbmtzIHRvIGFwcGxpY2F0aW9uIHBhZ2VzIHNob3VsZCBiZSBzcGVjaWZpZWQgYXMKCQkJLy8gICAgICAgICAgICBhbiB1cmwgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHdpdGggYSBoYXNoIHRoYXQgaXMgZWl0aGVyCgkJCS8vICAgICAgICAgICAgdGhlIHNpdGUgcmVsYXRpdmUgcGF0aCBvciBpZCB0byB0aGUgcGFnZS4gQnV0IHNvbWUgb2YgdGhlCgkJCS8vICAgICAgICAgICAgaW50ZXJuYWwgY29kZSB0aGF0IGR5bmFtaWNhbGx5IGdlbmVyYXRlcyBzdWItcGFnZXMgZm9yIG5lc3RlZAoJCQkvLyAgICAgICAgICAgIGxpc3RzIGFuZCBzZWxlY3QgZGlhbG9ncywganVzdCB3cml0ZSBhIGhhc2ggaW4gdGhlIGxpbmsgdGhleQoJCQkvLyAgICAgICAgICAgIGNyZWF0ZS4gVGhpcyBtZWFucyB0aGUgYWN0dWFsIFVSTCBwYXRoIGlzIGJhc2VkIG9uIHdoYXRldmVyCgkJCS8vICAgICAgICAgICAgdGhlIGN1cnJlbnQgdmFsdWUgb2YgdGhlIGJhc2UgdGFnIGlzIGF0IHRoZSB0aW1lIHRoaXMgY29kZQoJCQkvLyAgICAgICAgICAgIGlzIGNhbGxlZC4KCQkJaWYgKCBocmVmLnNlYXJjaCggIiMiICkgIT09IC0xICYmCgkJCQkhKCAkLm1vYmlsZS5wYXRoLmlzRXh0ZXJuYWwoIGhyZWYgKSAmJiAkLm1vYmlsZS5wYXRoLmlzQWJzb2x1dGVVcmwoIGhyZWYgKSApICkgewoKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoICQubW9iaWxlLnBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXVzZURlZmF1bHRVcmxIYW5kbGluZyA9ICRsaW5rLmlzKCAiW3JlbD0nZXh0ZXJuYWwnXSIgKSB8fCAkbGluay5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwgJGxpbmsuaXMoICJbdGFyZ2V0XSIgKTsKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoKCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCS8vICAgICBtb3ZlZCBpbnRvIG1vcmUgY29tcHJlaGVuc2l2ZSBpc0V4dGVybmFsTGluawoJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggJC5tb2JpbGUucGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgISQubW9iaWxlLnBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCBocmVmICkgKTsKCgkJCWlmICggaXNFeHRlcm5hbCApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vdXNlIGFqYXgKCQkJdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApOwoJCQlyZXZlcnNlID0gJGxpbmsuanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiIHx8CgkJCQkJCS8vIGRlcHJlY2F0ZWQgLSByZW1vdmUgYnkgMS4wCgkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApOwoKCQkJLy90aGlzIG1heSBuZWVkIHRvIGJlIG1vcmUgc3BlY2lmaWMgYXMgd2UgdXNlIGRhdGEtcmVsIG1vcmUKCQkJcm9sZSA9ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfHwgdW5kZWZpbmVkOwoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggaHJlZiwgeyB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCByZXZlcnNlOiByZXZlcnNlLCByb2xlOiByb2xlLCBsaW5rOiAkbGluayB9ICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vcHJlZmV0Y2ggcGFnZXMgd2hlbiBhbmNob3JzIHdpdGggZGF0YS1wcmVmZXRjaCBhcmUgZW5jb3VudGVyZWQKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93LnByZWZldGNoIiwgZnVuY3Rpb24oKSB7CgkJCXZhciB1cmxzID0gW107CgkJCSQoIHRoaXMgKS5maW5kKCAiYTpqcW1EYXRhKHByZWZldGNoKSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICRsaW5rID0gJCggdGhpcyApLAoJCQkJCXVybCA9ICRsaW5rLmF0dHIoICJocmVmIiApOwoKCQkJCWlmICggdXJsICYmICQuaW5BcnJheSggdXJsLCB1cmxzICkgPT09IC0xICkgewoJCQkJCXVybHMucHVzaCggdXJsICk7CgoJCQkJCSQubW9iaWxlLmxvYWRQYWdlKCB1cmwsIHsgcm9sZTogJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSxwcmVmZXRjaDogdHJ1ZSB9ICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoKCQkvLyBUT0RPIGVuc3VyZSB0aGF0IHRoZSBuYXZpZ2F0ZSBiaW5kaW5nIGluIHRoZSBjb250ZW50IHdpZGdldCBoYXBwZW5zIGF0IHRoZSByaWdodCB0aW1lCgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5wYWdlY29udGFpbmVyKCk7CgoJCS8vc2V0IHBhZ2UgbWluLWhlaWdodHMgdG8gYmUgZGV2aWNlIHNwZWNpZmljCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgoJCQkvLyBXZSBuZWVkIHRvIHdhaXQgZm9yIHdpbmRvdy5sb2FkIHRvIG1ha2Ugc3VyZSB0aGF0IHN0eWxlcyBoYXZlIGFscmVhZHkgYmVlbiByZW5kZXJlZCwKCQkJLy8gb3RoZXJ3aXNlIGhlaWdodHMgb2YgZXh0ZXJuYWwgdG9vbGJhcnMgd2lsbCBoYXZlIHRoZSB3cm9uZyB2YWx1ZQoJCQlpZiAoIGxvYWREZWZlcnJlZCApIHsKCQkJCWxvYWREZWZlcnJlZC5kb25lKCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCQkJfSBlbHNlIHsKCQkJCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCgpOwoJCQl9CgkJfSk7CgkJJC5tb2JpbGUud2luZG93LmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9Oy8vbmF2cmVhZHlEZWZlcnJlZCBkb25lIGNhbGxiYWNrCgoJJCggZnVuY3Rpb24oKSB7IGRvbXJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOyB9ICk7CgoJLy8gQWNjb3VudCBmb3IgdGhlIHBvc3NpYmlsaXR5IHRoYXQgdGhlIGxvYWQgZXZlbnQgaGFzIGFscmVhZHkgZmlyZWQKCWlmICggZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKCQlwYWdlSXNGdWxseUxvYWRlZCgpOwoJfSBlbHNlIHsKCQkkLm1vYmlsZS53aW5kb3cubG9hZCggcGFnZUlzRnVsbHlMb2FkZWQgKTsKCX0KCgkkLndoZW4oIGRvbXJlYWR5RGVmZXJyZWQsICQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgKS5kb25lKCBmdW5jdGlvbigpIHsgJC5tb2JpbGUuX3JlZ2lzdGVySW50ZXJuYWxFdmVudHMoKTsgfSApOwp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCgkvLyBUT0RPIHJlbW92ZSBkaXJlY3QgcmVmZXJlbmNlcyB0byAkLm1vYmlsZSBhbmQgcHJvcGVydGllcywgd2Ugc2hvdWxkCgkvLyAgICAgIGZhdm9yIGluamVjdGlvbiB3aXRoIHBhcmFtcyB0byB0aGUgY29uc3RydWN0b3IKCSQubW9iaWxlLlRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5UcmFuc2l0aW9uLnByb3RvdHlwZSwgewoJCXRvUHJlQ2xhc3M6ICIgdWktcGFnZS1wcmUtaW4iLAoKCQlpbml0OiBmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSApIHsKCQkJJC5leHRlbmQodGhpcywgewoJCQkJbmFtZTogbmFtZSwKCQkJCXJldmVyc2U6IHJldmVyc2UsCgkJCQkkdG86ICR0bywKCQkJCSRmcm9tOiAkZnJvbSwKCQkJCWRlZmVycmVkOiBuZXcgJC5EZWZlcnJlZCgpCgkJCX0pOwoJCX0sCgoJCWNsZWFuRnJvbTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuJGZyb20KCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICsgIiBvdXQgaW4gcmV2ZXJzZSAiICsgdGhpcy5uYW1lICkKCQkJCS5oZWlnaHQoICIiICk7CgkJfSwKCgkJLy8gTk9URSBvdmVycmlkZGVuIGJ5IGNoaWxkIG9iamVjdCBwcm90b3R5cGVzLCBub29wJ2QgaGVyZSBhcyBkZWZhdWx0cwoJCWJlZm9yZURvbmVJbjogZnVuY3Rpb24oKSB7fSwKCQliZWZvcmVEb25lT3V0OiBmdW5jdGlvbigpIHt9LAoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbigpIHt9LAoKCQlkb25lSW46IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmJlZm9yZURvbmVJbigpOwoKCQkJdGhpcy4kdG8ucmVtb3ZlQ2xhc3MoICJvdXQgaW4gcmV2ZXJzZSAiICsgdGhpcy5uYW1lICkuaGVpZ2h0KCAiIiApOwoKCQkJdGhpcy50b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCQkvLyBJbiBzb21lIGJyb3dzZXJzIChpT1M1KSwgM0QgdHJhbnNpdGlvbnMgYmxvY2sgdGhlIGFiaWxpdHkgdG8gc2Nyb2xsIHRvIHRoZSBkZXNpcmVkIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0aW9uCgkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCWlmICggJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpICE9PSB0aGlzLnRvU2Nyb2xsICkgewoJCQkJdGhpcy5zY3JvbGxQYWdlKCk7CgkJCX0KCQkJaWYgKCAhdGhpcy5zZXF1ZW50aWFsICkgewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApOwoJCQl9CgkJCXRoaXMuZGVmZXJyZWQucmVzb2x2ZSggdGhpcy5uYW1lLCB0aGlzLnJldmVyc2UsIHRoaXMuJHRvLCB0aGlzLiRmcm9tLCB0cnVlICk7CgkJfSwKCgkJZG9uZU91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuYmVmb3JlRG9uZU91dCgpOwoJCQl0aGlzLnN0YXJ0SW4oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKTsKCQl9LAoKCQloaWRlSW46IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQkJLy8gUHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcjogc2VlIGNvbW1lbnRzIGF0ICM0MDI0IHJlZ2FyZGluZyBpT1MKCQkJdGhpcy4kdG8uY3NzKCAiei1pbmRleCIsIC0xMCApOwoJCQljYWxsYmFjay5jYWxsKCB0aGlzICk7CgkJCXRoaXMuJHRvLmNzcyggInotaW5kZXgiLCAiIiApOwoJCX0sCgoJCXNjcm9sbFBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBCeSB1c2luZyBzY3JvbGxUbyBpbnN0ZWFkIG9mIHNpbGVudFNjcm9sbCwgd2UgY2FuIGtlZXAgdGhpbmdzIGJldHRlciBpbiBvcmRlcgoJCQkvLyBKdXN0IHRvIGJlIHByZWNhdXRpb3MsIGRpc2FibGUgc2Nyb2xsc3RhcnQgbGlzdGVuaW5nIGxpa2Ugc2lsZW50U2Nyb2xsIHdvdWxkCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgkJCS8vaWYgd2UgYXJlIGhpZGluZyB0aGUgdXJsIGJhciBvciB0aGUgcGFnZSB3YXMgcHJldmlvdXNseSBzY3JvbGxlZCBzY3JvbGwgdG8gaGlkZSBvciByZXR1cm4gdG8gcG9zaXRpb24KCQkJaWYgKCAkLm1vYmlsZS5oaWRlVXJsQmFyIHx8IHRoaXMudG9TY3JvbGwgIT09ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsICkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0aGlzLnRvU2Nyb2xsICk7CgkJCX0KCgkJCS8vIHJlZW5hYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJc3RhcnRJbjogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lLCBwcmV2ZW50Rm9jdXMgKSB7CgkJCXRoaXMuaGlkZUluKGZ1bmN0aW9uKCkgewoJCQkJdGhpcy4kdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRoaXMudG9QcmVDbGFzcyApOwoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gcGFnZSBhcyBpdCBpcyBub3cgZGlzcGxheTogYmxvY2sKCQkJCWlmICggIXByZXZlbnRGb2N1cyApIHsKCQkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoIHRoaXMuJHRvICk7CgkJCQl9CgoJCQkJLy8gU2V0IHRvIHBhZ2UgaGVpZ2h0CgkJCQl0aGlzLiR0by5oZWlnaHQoIHNjcmVlbkhlaWdodCArIHRoaXMudG9TY3JvbGwgKTsKCiAgICAgICAgICAgICAgICBpZiAoICFub25lICkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsUGFnZSgpOwogICAgICAgICAgICAgICAgfQoJCQl9KTsKCgkJCXRoaXMuJHRvCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMudG9QcmVDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgaW4gIiArIHJldmVyc2VDbGFzcyApOwoKCQkJaWYgKCAhbm9uZSApIHsKCQkJCXRoaXMuJHRvLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJCXRoaXMuZG9uZUluKCk7CgkJCQl9LCB0aGlzICkpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5kb25lSW4oKTsKCQkJfQoKCQl9LAoKCQlzdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoKCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCXRoaXMuJGZyb20KCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCX0sCgoJCXRvZ2dsZVZpZXdwb3J0Q2xhc3M6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIHRoaXMubmFtZSApOwoJCX0sCgoJCXRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewoJCQkvLyBOT1RFIG1hbnkgb2YgdGhlc2UgY291bGQgYmUgY2FsY3VsYXRlZC9yZWNvcmRlZCBpbiB0aGUgY29uc3RydWN0b3IsIGl0J3MgbXkKCQkJLy8gICAgICBvcGluaW9uIHRoYXQgYmluZGluZyB0aGVtIGFzIGxhdGUgYXMgcG9zc2libGUgaGFzIHZhbHVlIHdpdGggcmVnYXJkcyB0bwoJCQkvLyAgICAgIGJldHRlciB0cmFuc2l0aW9ucyB3aXRoIGZld2VyIGJ1Z3MuIEllLCBpdCdzIG5vdCBndWFyYW50ZWVkIHRoYXQgdGhlCgkJCS8vICAgICAgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgdHJhbnNpdGlvbiB3aWxsIGJlIHJ1biBpbW1lZGlhdGVseSBhZnRlciBhcwoJCQkvLyAgICAgIGl0IGlzIHRvZGF5LiBTbyB3ZSB3YWl0IHVudGlsIHRyYW5zaXRpb24gaXMgaW52b2tlZCB0byBnYXRoZXIgdGhlIGZvbGxvd2luZwoJCQl2YXIgbm9uZSwKCQkJCXJldmVyc2VDbGFzcyA9IHRoaXMucmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJgoJCQkJCSQubW9iaWxlLndpbmRvdy53aWR0aCgpID4gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoOwoKCQkJdGhpcy50b1Njcm9sbCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCkubGFzdFNjcm9sbCB8fCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbDsKCgkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8ICEkLnN1cHBvcnQuY3NzQW5pbWF0aW9ucyB8fAoJCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlIHx8ICF0aGlzLm5hbWUgfHwgdGhpcy5uYW1lID09PSAibm9uZSIgfHwKCQkJCU1hdGgubWF4KCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCksIHRoaXMudG9TY3JvbGwgKSA+CgkJCQkJJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbigpOwoKCQkJdGhpcy50b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCQlpZiAoIHRoaXMuJGZyb20gJiYgIW5vbmUgKSB7CgkJCQl0aGlzLnN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5kb25lT3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgdHJ1ZSApOwoJCQl9CgoJCQlyZXR1cm4gdGhpcy5kZWZlcnJlZC5wcm9taXNlKCk7CgkJfQoJfSk7Cn0pKCBqUXVlcnksIHRoaXMgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5TZXJpYWxUcmFuc2l0aW9uLnByb3RvdHlwZSwgJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQlzZXF1ZW50aWFsOiB0cnVlLAoKCQliZWZvcmVEb25lT3V0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLiRmcm9tICkgewoJCQkJdGhpcy5jbGVhbkZyb20oKTsKCQkJfQoJCX0sCgoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbiggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKSB7CgkJCXRoaXMuJGZyb20uYW5pbWF0aW9uQ29tcGxldGUoJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQkJfSwgdGhpcyApKTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJJC5tb2JpbGUuQ29uY3VycmVudFRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuQ29uY3VycmVudFRyYW5zaXRpb24ucHJvdG90eXBlLCAkLm1vYmlsZS5UcmFuc2l0aW9uLnByb3RvdHlwZSwgewoJCXNlcXVlbnRpYWw6IGZhbHNlLAoKCQliZWZvcmVEb25lSW46IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMuJGZyb20gKSB7CgkJCQl0aGlzLmNsZWFuRnJvbSgpOwoJCQl9CgkJfSwKCgkJYmVmb3JlU3RhcnRPdXQ6IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApIHsKCQkJdGhpcy5kb25lT3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoJCX0KCX0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCApIHsKCgkvLyBnZW5lcmF0ZSB0aGUgaGFuZGxlcnMgZnJvbSB0aGUgYWJvdmUKCXZhciBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSAqIDM7Cgl9OwoKCS8vdHJhbnNpdGlvbiBoYW5kbGVyIGRpY3Rpb25hcnkgZm9yIDNyZCBwYXJ0eSB0cmFuc2l0aW9ucwoJJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzID0gewoJCSJzZXF1ZW50aWFsIjogJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbiwKCQkic2ltdWx0YW5lb3VzIjogJC5tb2JpbGUuQ29uY3VycmVudFRyYW5zaXRpb24KCX07CgoJLy8gTWFrZSBvdXIgdHJhbnNpdGlvbiBoYW5kbGVyIHRoZSBwdWJsaWMgZGVmYXVsdC4KCSQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zZXF1ZW50aWFsOwoKCSQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MgPSB7fTsKCgkvLyBJZiB0cmFuc2l0aW9uIGlzIGRlZmluZWQsIGNoZWNrIGlmIGNzcyAzRCB0cmFuc2Zvcm1zIGFyZSBzdXBwb3J0ZWQsIGFuZCBpZiBub3QsIGlmIGEgZmFsbGJhY2sgaXMgc3BlY2lmaWVkCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCWlmICggdHJhbnNpdGlvbiAmJiAhJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXSApIHsKCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXTsKCQl9CgoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvLyBTZXQgdGhlIGdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gdG8gZGVmYXVsdCBpZiBubyBpbXBsZW1lbnRhdGlvbiB3YXMgc2V0IGJ5IHVzZXIKCSQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHx8IGRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uOwoKfSkoIGpRdWVyeSApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbGlwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbGlwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbG93IGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbG93ID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBwb3AgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnBvcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBVc2UgdGhlIHNpbXVsdGFuZW91cyB0cmFuc2l0aW9ucyBoYW5kbGVyIGZvciBzbGlkZSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2xpZGUgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2ltdWx0YW5lb3VzOwoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZWRvd24gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZG93biA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVmYWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZmFkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGV1cCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGV1cCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgdHVybiBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MudHVybiA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07Ci8vIEJhY2tjb21wYXQgcmVtb3ZlIGluIDEuNQokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzOwoKLy8gQXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCgl0YXJnZXQgPSAkKCB0YXJnZXQgKTsKCgkvLyBEZWdyYWRlIGlucHV0cyB0byBhdm9pZCBwb29ybHkgaW1wbGVtZW50ZWQgbmF0aXZlIGZ1bmN0aW9uYWxpdHkKCXRhcmdldC5maW5kKCAiaW5wdXQiICkubm90KCAkLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSApLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCB0aGlzICksCgkJCXR5cGUgPSB0aGlzLmdldEF0dHJpYnV0ZSggInR5cGUiICksCgkJCW9wdFR5cGUgPSAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gfHwgInRleHQiLAoJCQlodG1sLCBoYXNUeXBlLCBmaW5kc3RyLCByZXBzdHI7CgoJCWlmICggJC5tb2JpbGUuZGVncmFkZUlucHV0c1sgdHlwZSBdICkgewoJCQlodG1sID0gJCggIjxkaXY+IiApLmh0bWwoIGVsZW1lbnQuY2xvbmUoKSApLmh0bWwoKTsKCQkJLy8gSW4gSUUgYnJvd3NlcnMsIHRoZSB0eXBlIHNvbWV0aW1lcyBkb2Vzbid0IGV4aXN0IGluIHRoZSBjbG9uZWQgbWFya3VwLCBzbyB3ZSByZXBsYWNlIHRoZSBjbG9zaW5nIHRhZyBpbnN0ZWFkCgkJCWhhc1R5cGUgPSBodG1sLmluZGV4T2YoICIgdHlwZT0iICkgPiAtMTsKCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LzsKCQkJcmVwc3RyID0gIiB0eXBlPVwiIiArIG9wdFR5cGUgKyAiXCIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT1cIiIgKyB0eXBlICsgIlwiIiArICggaGFzVHlwZSA/ICIiIDogIj4iICk7CgoJCQllbGVtZW50LnJlcGxhY2VXaXRoKCBodG1sLnJlcGxhY2UoIGZpbmRzdHIsIHJlcHN0ciApICk7CgkJfQoJfSk7Cgp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhZ2UiLCAkLm1vYmlsZS5wYWdlLCB7CglvcHRpb25zOiB7CgoJCS8vIEFjY2VwdHMgbGVmdCwgcmlnaHQgYW5kIG5vbmUKCQljbG9zZUJ0bjogImxlZnQiLAoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQljb3JuZXJzOiB0cnVlLAoJCWRpYWxvZzogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaWFsb2cgKSB7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2lubmVyOiB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKSwKCQkJCV9oZWFkZXJDbG9zZUJ1dHRvbjogbnVsbAoJCQl9KTsKCgkJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJCXRoaXMuX3NldENsb3NlQnRuKCB0aGlzLm9wdGlvbnMuY2xvc2VCdG4gKTsKCQkJfQoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nIGFuZCB3cmFwIGludGVyaW9yCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlhbG9nICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1kaWFsb2ciICkKCQkJCS53cmFwSW5uZXIoICQoICI8ZGl2Lz4iLCB7CgoJCQkJCS8vIEFSSUEgcm9sZQoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktb3ZlcmxheS1zaGFkb3ciICsKCQkJCQkJKCB0aGlzLm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApCgkJCQl9KSk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX2lubmVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsICEhb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMub3ZlcmxheVRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWlmICggJC5tb2JpbGUuYWN0aXZlUGFnZVsgMCBdID09PSB0aGlzLmVsZW1lbnRbIDAgXSApIHsKCQkJCWN1cnJlbnRPcHRzLm92ZXJsYXlUaGVtZSA9IG9wdGlvbnMub3ZlcmxheVRoZW1lOwoJCQkJdGhpcy5faGFuZGxlUGFnZUJlZm9yZVNob3coKTsKCQkJfQoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gY3VycmVudE9wdHMuY2xvc2VCdG47CgkJCWNsb3NlQnV0dG9uVGV4dCA9IG9wdGlvbnMuY2xvc2VCdG5UZXh0OwoJCX0KCgkJaWYgKCBvcHRpb25zLmNsb3NlQnRuICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBvcHRpb25zLmNsb3NlQnRuOwoJCX0KCgkJaWYgKCBjbG9zZUJ1dHRvbkxvY2F0aW9uICkgewoJCQl0aGlzLl9zZXRDbG9zZUJ0biggY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0ICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uICgpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgJiYgdGhpcy5vcHRpb25zLmRpYWxvZyApIHsKCQkJdGhpcy5yZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kKCk7CgkJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJfQoJfSwKCglfc2V0Q2xvc2VCdG46IGZ1bmN0aW9uKCBsb2NhdGlvbiwgdGV4dCApIHsKCQl2YXIgZHN0LAoJCQlidG4gPSB0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbjsKCgkJLy8gU2FuaXRpemUgdmFsdWUKCQlsb2NhdGlvbiA9ICJsZWZ0IiA9PT0gbG9jYXRpb24gPyAibGVmdCIgOiAicmlnaHQiID09PSBsb2NhdGlvbiA/ICJyaWdodCIgOiAibm9uZSI7CgoJCWlmICggIm5vbmUiID09PSBsb2NhdGlvbiApIHsKCQkJaWYgKCBidG4gKSB7CgkJCQlidG4ucmVtb3ZlKCk7CgkJCQlidG4gPSBudWxsOwoJCQl9CgkJfSBlbHNlIGlmICggYnRuICkgewoJCQlidG4ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tIiArIGxvY2F0aW9uICk7CgkJCWlmICggdGV4dCApIHsKCQkJCWJ0bi50ZXh0KCB0ZXh0ICk7CgkJCX0KCQl9IGVsc2UgewoJCQlkc3QgPSB0aGlzLl9pbm5lci5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkuZmlyc3QoKTsKCQkJYnRuID0gJCggIjxhPjwvYT4iLCB7CgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJImNsYXNzIjogInVpLWJ0biB1aS1jb3JuZXItYWxsIHVpLWljb24tZGVsZXRlIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1idG4tIiArIGxvY2F0aW9uCgkJCQl9KQoJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiLCAiYmFjayIgKQoJCQkJLnRleHQoIHRleHQgfHwgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCB8fCAiIiApCgkJCQkucHJlcGVuZFRvKCBkc3QgKTsKCQl9CgoJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uID0gYnRuOwoJfQp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5kaWFsb2ciLCB7CglvcHRpb25zOiB7CgoJCS8vIEFjY2VwdHMgbGVmdCwgcmlnaHQgYW5kIG5vbmUKCQljbG9zZUJ0bjogImxlZnQiLAoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQljb3JuZXJzOiB0cnVlCgl9LAoKCS8vIE92ZXJyaWRlIHRoZSB0aGVtZSBzZXQgYnkgdGhlIHBhZ2UgcGx1Z2luIG9uIHBhZ2VzaG93CglfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gdHJ1ZTsKCQlpZiAoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKSB7CgkJCXRoaXMuZWxlbWVudAoJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkucGFnZSggInNldENvbnRhaW5lckJhY2tncm91bmQiLCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgkJfQoJfSwKCglfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2lzQ2xvc2VhYmxlID0gZmFsc2U7Cgl9LAoKCS8vIGNsaWNrIGFuZCBzdWJtaXQgZXZlbnRzOgoJLy8gLSBjbGlja3MgYW5kIHN1Ym1pdHMgc2hvdWxkIHVzZSB0aGUgY2xvc2luZyB0cmFuc2l0aW9uIHRoYXQgdGhlIGRpYWxvZwoJLy8gICBvcGVuZWQgd2l0aCB1bmxlc3MgYSBkYXRhLXRyYW5zaXRpb24gaXMgc3BlY2lmaWVkIG9uIHRoZSBsaW5rL2Zvcm0KCS8vIC0gaWYgdGhlIGNsaWNrIHdhcyBvbiB0aGUgY2xvc2UgYnV0dG9uLCBvciB0aGUgbGluayBoYXMgYSBkYXRhLXJlbD0iYmFjayIKCS8vICAgaXQnbGwgZ28gYmFjayBpbiBoaXN0b3J5IG5hdHVyYWxseQoJX2hhbmRsZVZDbGlja1N1Ym1pdDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBhdHRycywKCQkJJHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoIGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siID8gImEiIDogImZvcm0iICk7CgoJCWlmICggJHRhcmdldC5sZW5ndGggJiYgISR0YXJnZXQuanFtRGF0YSggInRyYW5zaXRpb24iICkgKSB7CgkJCWF0dHJzID0ge307CgkJCWF0dHJzWyAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHJhbnNpdGlvbiIgXSA9CgkJCQkoICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuZ2V0QWN0aXZlKCkgfHwge30gKVsgInRyYW5zaXRpb24iIF0gfHwKCQkJCSQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uOwoJCQlhdHRyc1sgImRhdGEtIiArICQubW9iaWxlLm5zICsgImRpcmVjdGlvbiIgXSA9ICJyZXZlcnNlIjsKCQkJJHRhcmdldC5hdHRyKCBhdHRycyApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nIGFuZCB3cmFwIGludGVyaW9yCgkJZWxlbS5hZGRDbGFzcyggInVpLWRpYWxvZyIgKQoJCQkud3JhcElubmVyKCAkKCAiPGRpdi8+IiwgewoKCQkJCS8vIEFSSUEgcm9sZQoJCQkJInJvbGUiIDogImRpYWxvZyIsCgkJCQkiY2xhc3MiIDogInVpLWRpYWxvZy1jb250YWluIHVpLW92ZXJsYXktc2hhZG93IiArCgkJCQkJKCAhIW9wdHMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApCgkJCX0pKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2lzQ2xvc2VhYmxlOiBmYWxzZSwKCQkJX2lubmVyOiBlbGVtLmNoaWxkcmVuKCksCgkJCV9oZWFkZXJDbG9zZUJ1dHRvbjogbnVsbAoJCX0pOwoKCQl0aGlzLl9vbiggZWxlbSwgewoJCQl2Y2xpY2s6ICJfaGFuZGxlVkNsaWNrU3VibWl0IiwKCQkJc3VibWl0OiAiX2hhbmRsZVZDbGlja1N1Ym1pdCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJcGFnZWJlZm9yZWhpZGU6ICJfaGFuZGxlUGFnZUJlZm9yZUhpZGUiCgkJfSk7CgoJCXRoaXMuX3NldENsb3NlQnRuKCBvcHRzLmNsb3NlQnRuICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2xvc2VCdXR0b25Mb2NhdGlvbiwgY2xvc2VCdXR0b25UZXh0LAoJCQljdXJyZW50T3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faW5uZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgISFvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5vdmVybGF5VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAkLm1vYmlsZS5hY3RpdmVQYWdlWyAwIF0gPT09IHRoaXMuZWxlbWVudFsgMCBdICkgewoJCQkJY3VycmVudE9wdHMub3ZlcmxheVRoZW1lID0gb3B0aW9ucy5vdmVybGF5VGhlbWU7CgkJCQl0aGlzLl9oYW5kbGVQYWdlQmVmb3JlU2hvdygpOwoJCQl9CgkJfQoKCQlpZiAoIG9wdGlvbnMuY2xvc2VCdG5UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCWNsb3NlQnV0dG9uTG9jYXRpb24gPSBjdXJyZW50T3B0cy5jbG9zZUJ0bjsKCQkJY2xvc2VCdXR0b25UZXh0ID0gb3B0aW9ucy5jbG9zZUJ0blRleHQ7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY2xvc2VCdG4gIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IG9wdGlvbnMuY2xvc2VCdG47CgkJfQoKCQlpZiAoIGNsb3NlQnV0dG9uTG9jYXRpb24gKSB7CgkJCXRoaXMuX3NldENsb3NlQnRuKCBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRDbG9zZUJ0bjogZnVuY3Rpb24oIGxvY2F0aW9uLCB0ZXh0ICkgewoJCXZhciBkc3QsCgkJCWJ0biA9IHRoaXMuX2hlYWRlckNsb3NlQnV0dG9uOwoKCQkvLyBTYW5pdGl6ZSB2YWx1ZQoJCWxvY2F0aW9uID0gImxlZnQiID09PSBsb2NhdGlvbiA/ICJsZWZ0IiA6ICJyaWdodCIgPT09IGxvY2F0aW9uID8gInJpZ2h0IiA6ICJub25lIjsKCgkJaWYgKCAibm9uZSIgPT09IGxvY2F0aW9uICkgewoJCQlpZiAoIGJ0biApIHsKCQkJCWJ0bi5yZW1vdmUoKTsKCQkJCWJ0biA9IG51bGw7CgkJCX0KCQl9IGVsc2UgaWYgKCBidG4gKSB7CgkJCWJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi0iICsgbG9jYXRpb24gKTsKCQkJaWYgKCB0ZXh0ICkgewoJCQkJYnRuLnRleHQoIHRleHQgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWRzdCA9IHRoaXMuX2lubmVyLmZpbmQoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKS5maXJzdCgpOwoJCQlidG4gPSAkKCAiPGE+PC9hPiIsIHsKCQkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktYnRuLSIgKyBsb2NhdGlvbgoJCQkJfSkKCQkJCS50ZXh0KCB0ZXh0IHx8IHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgfHwgIiIgKQoJCQkJLnByZXBlbmRUbyggZHN0ICk7CgkJCXRoaXMuX29uKCBidG4sIHsgY2xpY2s6ICJjbG9zZSIgfSApOwoJCX0KCgkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBoaXN0ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeTsKCgkJaWYgKCB0aGlzLl9pc0Nsb3NlYWJsZSApIHsKCQkJdGhpcy5faXNDbG9zZWFibGUgPSBmYWxzZTsKCQkJLy8gSWYgdGhlIGhhc2ggbGlzdGVuaW5nIGlzIGVuYWJsZWQgYW5kIHRoZXJlIGlzIGF0IGxlYXN0IG9uZSBwcmVjZWRpbmcgaGlzdG9yeQoJCQkvLyBlbnRyeSBpdCdzIG9rIHRvIGdvIGJhY2suIEluaXRpYWwgcGFnZXMgd2l0aCB0aGUgZGlhbG9nIGhhc2ggc3RhdGUgYXJlIGFuIGV4YW1wbGUKCQkJLy8gd2hlcmUgdGhlIHN0YWNrIGNoZWNrIGlzIG5lY2Vzc2FyeQoJCQlpZiAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmIGhpc3QuYWN0aXZlSW5kZXggPiAwICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQl9IGVsc2UgewoJCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5wYWdlY29udGFpbmVyKCAiYmFjayIgKTsKCQkJfQoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBySW5pdGlhbExldHRlciA9IC8oW0EtWl0pL2csCgoJLy8gQ29uc3RydWN0IGljb25wb3MgY2xhc3MgZnJvbSBpY29ucG9zIHZhbHVlCglpY29ucG9zQ2xhc3MgPSBmdW5jdGlvbiggaWNvbnBvcyApIHsKCQlyZXR1cm4gKCAidWktYnRuLWljb24tIiArICggaWNvbnBvcyA9PT0gbnVsbCA/ICJsZWZ0IiA6IGljb25wb3MgKSApOwoJfTsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgewoJb3B0aW9uczogewoJCWVuaGFuY2VkOiBmYWxzZSwKCQlleHBhbmRDdWVUZXh0OiBudWxsLAoJCWNvbGxhcHNlQ3VlVGV4dDogbnVsbCwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogbnVsbCwKCQlleHBhbmRlZEljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IG51bGwsCgkJY29ybmVyczogbnVsbCwKCQltaW5pOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQl1aSA9IHsKCQkJCWFjY29yZGlvbjogZWxlbQoJCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JyksIiArCgkJCQkJCSI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZXNldCcpIiArCgkJCQkJCSggJC5tb2JpbGUuY29sbGFwc2libGVzZXQgPyAiLCA6bW9iaWxlLWNvbGxhcHNpYmxlc2V0IiA6CgkJCQkJCQkiIiApICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQiICkKCQkJfTsKCgkJdGhpcy5fdWkgPSB1aTsKCQl0aGlzLl9yZW5kZXJlZE9wdGlvbnMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXVpLmhlYWRpbmcgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICIudWktY29sbGFwc2libGUtaGVhZGluZyIgKTsKCQkJdWkuY29udGVudCA9IHVpLmhlYWRpbmcubmV4dCgpOwoJCQl1aS5hbmNob3IgPSB1aS5oZWFkaW5nLmNoaWxkcmVuKCk7CgkJCXVpLnN0YXR1cyA9IHVpLmFuY2hvci5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyIgKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9lbmhhbmNlKCBlbGVtLCB1aSApOwoJCX0KCgkJdGhpcy5fb24oIHVpLmhlYWRpbmcsIHsKCQkJInRhcCI6IGZ1bmN0aW9uKCkgewoJCQkJdWkuaGVhZGluZy5maW5kKCAiYSIgKS5maXJzdCgpLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9LAoKCQkJImNsaWNrIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoICF1aS5oZWFkaW5nLmhhc0NsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkgKTsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0pOwoJfSwKCgkvLyBBZGp1c3QgdGhlIGtleXMgaW5zaWRlIG9wdGlvbnMgZm9yIGluaGVyaXRlZCB2YWx1ZXMKCV9nZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIga2V5LAoJCQlhY2NvcmRpb24gPSB0aGlzLl91aS5hY2NvcmRpb24sCgkJCWFjY29yZGlvbldpZGdldCA9IHRoaXMuX3VpLmFjY29yZGlvbldpZGdldDsKCgkJLy8gQ29weSBvcHRpb25zCgkJb3B0aW9ucyA9ICQuZXh0ZW5kKCB7fSwgb3B0aW9ucyApOwoKCQlpZiAoIGFjY29yZGlvbi5sZW5ndGggJiYgIWFjY29yZGlvbldpZGdldCApIHsKCQkJdGhpcy5fdWkuYWNjb3JkaW9uV2lkZ2V0ID0KCQkJYWNjb3JkaW9uV2lkZ2V0ID0gYWNjb3JkaW9uLmRhdGEoICJtb2JpbGUtY29sbGFwc2libGVzZXQiICk7CgkJfQoKCQlmb3IgKCBrZXkgaW4gb3B0aW9ucyApIHsKCgkJCS8vIFJldHJpZXZlIHRoZSBvcHRpb24gdmFsdWUgZmlyc3QgZnJvbSB0aGUgb3B0aW9ucyBvYmplY3QgcGFzc2VkIGluIGFuZCwgaWYKCQkJLy8gbnVsbCwgZnJvbSB0aGUgcGFyZW50IGFjY29yZGlvbiBvciwgaWYgdGhhdCdzIG51bGwgdG9vLCBvciBpZiB0aGVyZSdzIG5vCgkJCS8vIHBhcmVudCBhY2NvcmRpb24sIHRoZW4gZnJvbSB0aGUgZGVmYXVsdHMuCgkJCW9wdGlvbnNbIGtleSBdID0KCQkJCSggb3B0aW9uc1sga2V5IF0gIT0gbnVsbCApID8gb3B0aW9uc1sga2V5IF0gOgoJCQkJKCBhY2NvcmRpb25XaWRnZXQgKSA/IGFjY29yZGlvbldpZGdldC5vcHRpb25zWyBrZXkgXSA6CgkJCQlhY2NvcmRpb24ubGVuZ3RoID8gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBhY2NvcmRpb25bIDAgXSwKCQkJCQlrZXkucmVwbGFjZSggckluaXRpYWxMZXR0ZXIsICItJDEiICkudG9Mb3dlckNhc2UoKSApOgoJCQkJbnVsbDsKCgkJCWlmICggbnVsbCA9PSBvcHRpb25zWyBrZXkgXSApIHsKCQkJCW9wdGlvbnNbIGtleSBdID0gJC5tb2JpbGUuY29sbGFwc2libGUuZGVmYXVsdHNbIGtleSBdOwoJCQl9CgkJfQoKCQlyZXR1cm4gb3B0aW9uczsKCX0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggcHJlZml4LCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogcHJlZml4ICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbiggZWxlbSwgdWkgKSB7CgkJdmFyIGljb25jbGFzcywKCQkJb3B0cyA9IHRoaXMuX3JlbmRlcmVkT3B0aW9ucywKCQkJY29udGVudFRoZW1lQ2xhc3MgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgb3B0cy5jb250ZW50VGhlbWUgKTsKCgkJZWxlbS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlICIgKwoJCQkoIG9wdHMuaW5zZXQgPyAidWktY29sbGFwc2libGUtaW5zZXQgIiA6ICIiICkgKwoJCQkoIG9wdHMuaW5zZXQgJiYgb3B0cy5jb3JuZXJzID8gInVpLWNvcm5lci1hbGwgIiA6ICIiICkgKwoJCQkoIGNvbnRlbnRUaGVtZUNsYXNzID8gInVpLWNvbGxhcHNpYmxlLXRoZW1lZC1jb250ZW50ICIgOiAiIiApICk7CgkJdWkub3JpZ2luYWxIZWFkaW5nID0gZWxlbS5jaGlsZHJlbiggdGhpcy5vcHRpb25zLmhlYWRpbmcgKS5maXJzdCgpLAoJCXVpLmNvbnRlbnQgPSBlbGVtCgkJCS53cmFwSW5uZXIoICI8ZGl2ICIgKwoJCQkJImNsYXNzPSd1aS1jb2xsYXBzaWJsZS1jb250ZW50ICIgKwoJCQkJY29udGVudFRoZW1lQ2xhc3MgKyAiJz48L2Rpdj4iICkKCQkJLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWNvbnRlbnQiICksCgkJdWkuaGVhZGluZyA9IHVpLm9yaWdpbmFsSGVhZGluZzsKCgkJLy8gUmVwbGFjZSBjb2xsYXBzaWJsZUhlYWRpbmcgaWYgaXQncyBhIGxlZ2VuZAoJCWlmICggdWkuaGVhZGluZy5pcyggImxlZ2VuZCIgKSApIHsKCQkJdWkuaGVhZGluZyA9ICQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnPiIrIHVpLmhlYWRpbmcuaHRtbCgpICsiPC9kaXY+IiApOwoJCQl1aS5wbGFjZWhvbGRlciA9ICQoICI8ZGl2PjwhLS0gcGxhY2Vob2xkZXIgZm9yIGxlZ2VuZCAtLT48L2Rpdj4iICkuaW5zZXJ0QmVmb3JlKCB1aS5vcmlnaW5hbEhlYWRpbmcgKTsKCQkJdWkub3JpZ2luYWxIZWFkaW5nLnJlbW92ZSgpOwoJCX0KCgkJaWNvbmNsYXNzID0gKCBvcHRzLmNvbGxhcHNlZCA/ICggb3B0cy5jb2xsYXBzZWRJY29uID8gInVpLWljb24tIiArIG9wdHMuY29sbGFwc2VkSWNvbiA6ICIiICk6CgkJCSggb3B0cy5leHBhbmRlZEljb24gPyAidWktaWNvbi0iICsgb3B0cy5leHBhbmRlZEljb24gOiAiIiApICk7CgoJCXVpLnN0YXR1cyA9ICQoICI8c3BhbiBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMnPjwvc3Bhbj4iICk7CgkJdWkuYW5jaG9yID0gdWkuaGVhZGluZwoJCQkuZGV0YWNoKCkKCQkJLy9tb2RpZnkgbWFya3VwICYgYXR0cmlidXRlcwoJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCS5hcHBlbmQoIHVpLnN0YXR1cyApCgkJCS53cmFwSW5uZXIoICI8YSBocmVmPScjJyBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy10b2dnbGUnPjwvYT4iICkKCQkJLmZpbmQoICJhIiApCgkJCQkuZmlyc3QoKQoJCQkJLmFkZENsYXNzKCAidWktYnRuICIgKwoJCQkJCSggaWNvbmNsYXNzID8gaWNvbmNsYXNzICsgIiAiIDogIiIgKSArCgkJCQkJKCBpY29uY2xhc3MgPyBpY29ucG9zQ2xhc3MoIG9wdHMuaWNvbnBvcyApICsKCQkJCQkJIiAiIDogIiIgKSArCgkJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1idG4tIiwgb3B0cy50aGVtZSApICsgIiAiICsKCQkJCQkoIG9wdHMubWluaSA/ICJ1aS1taW5pICIgOiAiIiApICk7CgoJCS8vZHJvcCBoZWFkaW5nIGluIGJlZm9yZSBjb250ZW50CgkJdWkuaGVhZGluZy5pbnNlcnRCZWZvcmUoIHVpLmNvbnRlbnQgKTsKCgkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIHRoaXMub3B0aW9ucy5jb2xsYXBzZWQgKTsKCgkJcmV0dXJuIHVpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9hcHBseU9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCXRoaXMuX3JlbmRlcmVkT3B0aW9ucyA9IHRoaXMuX2dldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJfSwKCglfYXBwbHlPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNDb2xsYXBzZWQsIG5ld1RoZW1lLCBvbGRUaGVtZSwgaGFzQ29ybmVycywgaGFzSWNvbiwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLl9yZW5kZXJlZE9wdGlvbnMsCgkJCXVpID0gdGhpcy5fdWksCgkJCWFuY2hvciA9IHVpLmFuY2hvciwKCQkJc3RhdHVzID0gdWkuc3RhdHVzLAoJCQlvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQkvLyBGaXJzdCBhbmQgZm9yZW1vc3Qgd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIGNvbGxhcHNpYmxlIGlzIGluIHRoZSBwcm9wZXIKCQkvLyBzdGF0ZSwgaW4gY2FzZSBzb21lYm9keSBkZWNpZGVkIHRvIGNoYW5nZSB0aGUgY29sbGFwc2VkIG9wdGlvbiBhdCB0aGUKCQkvLyBzYW1lIHRpbWUgYXMgYW5vdGhlciBvcHRpb24KCQlpZiAoIG9wdGlvbnMuY29sbGFwc2VkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCBvcHRpb25zLmNvbGxhcHNlZCApOwoJCX0KCgkJaXNDb2xsYXBzZWQgPSBlbGVtLmhhc0NsYXNzKCAidWktY29sbGFwc2libGUtY29sbGFwc2VkIiApOwoKCQkvLyBXZSBvbmx5IG5lZWQgdG8gYXBwbHkgdGhlIGN1ZSB0ZXh0IGZvciB0aGUgY3VycmVudCBzdGF0ZSByaWdodCBhd2F5LgoJCS8vIFRoZSBjdWUgdGV4dCBmb3IgdGhlIGFsdGVybmF0ZSBzdGF0ZSB3aWxsIGJlIHN0b3JlZCBpbiB0aGUgb3B0aW9ucwoJCS8vIGFuZCBhcHBsaWVkIHRoZSBuZXh0IHRpbWUgdGhlIGNvbGxhcHNpYmxlJ3Mgc3RhdGUgaXMgdG9nZ2xlZAoJCWlmICggaXNDb2xsYXBzZWQgKSB7CgkJCWlmICggb3B0cy5leHBhbmRDdWVUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdGF0dXMudGV4dCggb3B0cy5leHBhbmRDdWVUZXh0ICk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIG9wdHMuY29sbGFwc2VDdWVUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdGF0dXMudGV4dCggb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQkJfQoJCX0KCgkJLy8gVXBkYXRlIGljb24KCgkJLy8gSXMgaXQgc3VwcG9zZWQgdG8gaGF2ZSBhbiBpY29uPwoJCWhhc0ljb24gPQoKCQkJLy8gSWYgdGhlIGNvbGxhcHNlZEljb24gaXMgYmVpbmcgc2V0LCBjb25zdWx0IHRoYXQKCQkJKCBvcHRzLmNvbGxhcHNlZEljb24gIT09IHVuZGVmaW5lZCA/IG9wdHMuY29sbGFwc2VkSWNvbiAhPT0gZmFsc2UgOgoKCQkJCS8vIE90aGVyd2lzZSBjb25zdWx0IHRoZSBleGlzdGluZyBvcHRpb24gdmFsdWUKCQkJCWN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gIT09IGZhbHNlICk7CgoKCQkvLyBJZiBhbnkgaWNvbi1yZWxhdGVkIG9wdGlvbnMgaGF2ZSBjaGFuZ2VkLCBtYWtlIHN1cmUgdGhlIG5ldyBpY29uCgkJLy8gc3RhdGUgaXMgcmVmbGVjdGVkIGJ5IGZpcnN0IHJlbW92aW5nIGFsbCBpY29uLXJlbGF0ZWQgY2xhc3NlcwoJCS8vIHJlZmxlY3RpbmcgdGhlIGN1cnJlbnQgc3RhdGUgYW5kIHRoZW4gYWRkaW5nIGFsbCBpY29uLXJlbGF0ZWQKCQkvLyBjbGFzc2VzIGZvciB0aGUgbmV3IHN0YXRlCgkJaWYgKCAhKCBvcHRzLmljb25wb3MgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRzLmNvbGxhcHNlZEljb24gPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRzLmV4cGFuZGVkSWNvbiA9PT0gdW5kZWZpbmVkICkgKSB7CgoJCQkvLyBSZW1vdmUgYWxsIGN1cnJlbnQgaWNvbi1yZWxhdGVkIGNsYXNzZXMKCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCBbIGljb25wb3NDbGFzcyggY3VycmVudE9wdHMuaWNvbnBvcyApIF0KCQkJCS5jb25jYXQoICggY3VycmVudE9wdHMuZXhwYW5kZWRJY29uID8KCQkJCQlbICJ1aS1pY29uLSIgKyBjdXJyZW50T3B0cy5leHBhbmRlZEljb24gXSA6IFtdICkgKQoJCQkJLmNvbmNhdCggKCBjdXJyZW50T3B0cy5jb2xsYXBzZWRJY29uID8KCQkJCQlbICJ1aS1pY29uLSIgKyBjdXJyZW50T3B0cy5jb2xsYXBzZWRJY29uIF0gOiBbXSApICkKCQkJCS5qb2luKCAiICIgKSApOwoKCQkJLy8gQWRkIG5ldyBjbGFzc2VzIGlmIGFuIGljb24gaXMgc3VwcG9zZWQgdG8gYmUgcHJlc2VudAoJCQlpZiAoIGhhc0ljb24gKSB7CgkJCQlhbmNob3IuYWRkQ2xhc3MoCgkJCQkJWyBpY29ucG9zQ2xhc3MoIG9wdHMuaWNvbnBvcyAhPT0gdW5kZWZpbmVkID8KCQkJCQkJb3B0cy5pY29ucG9zIDogY3VycmVudE9wdHMuaWNvbnBvcyApIF0KCQkJCQkJLmNvbmNhdCggaXNDb2xsYXBzZWQgPwoJCQkJCQkJWyAidWktaWNvbi0iICsgKCBvcHRzLmNvbGxhcHNlZEljb24gIT09IHVuZGVmaW5lZCA/CgkJCQkJCQkJb3B0cy5jb2xsYXBzZWRJY29uIDoKCQkJCQkJCQljdXJyZW50T3B0cy5jb2xsYXBzZWRJY29uICkgXSA6CgkJCQkJCQlbICJ1aS1pY29uLSIgKyAoIG9wdHMuZXhwYW5kZWRJY29uICE9PSB1bmRlZmluZWQgPwoJCQkJCQkJCW9wdHMuZXhwYW5kZWRJY29uIDoKCQkJCQkJCQljdXJyZW50T3B0cy5leHBhbmRlZEljb24gKSBdICkKCQkJCQkJLmpvaW4oICIgIiApICk7CgkJCX0KCQl9CgoJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYnRuLSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1idG4tIiwgb3B0cy50aGVtZSApOwoJCQlhbmNob3IucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdHMuY29udGVudFRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCW9sZFRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsCgkJCQljdXJyZW50T3B0cy5jb250ZW50VGhlbWUgKTsKCQkJbmV3VGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwKCQkJCW9wdHMuY29udGVudFRoZW1lICk7CgkJCXVpLmNvbnRlbnQucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdHMuaW5zZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWluc2V0Iiwgb3B0cy5pbnNldCApOwoJCQloYXNDb3JuZXJzID0gISEoIG9wdHMuaW5zZXQgJiYgKCBvcHRzLmNvcm5lcnMgfHwgY3VycmVudE9wdHMuY29ybmVycyApICk7CgkJfQoKCQlpZiAoIG9wdHMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQloYXNDb3JuZXJzID0gISEoIG9wdHMuY29ybmVycyAmJiAoIG9wdHMuaW5zZXQgfHwgY3VycmVudE9wdHMuaW5zZXQgKSApOwoJCX0KCgkJaWYgKCBoYXNDb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0udG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgaGFzQ29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRzLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJYW5jaG9yLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdHMubWluaSApOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXRoaXMuX2FwcGx5T3B0aW9ucyggb3B0aW9ucyApOwoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJdGhpcy5fcmVuZGVyZWRPcHRpb25zID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICk7Cgl9LAoKCV9oYW5kbGVFeHBhbmRDb2xsYXBzZTogZnVuY3Rpb24oIGlzQ29sbGFwc2UgKSB7CgkJdmFyIG9wdHMgPSB0aGlzLl9yZW5kZXJlZE9wdGlvbnMsCgkJCXVpID0gdGhpcy5fdWk7CgoJCXVpLnN0YXR1cy50ZXh0KCBpc0NvbGxhcHNlID8gb3B0cy5leHBhbmRDdWVUZXh0IDogb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQl1aS5oZWFkaW5nCgkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uLCAhaXNDb2xsYXBzZSApCgoJCQkvLyBsb2dpYyBvciBjYXVzZSBzYW1lIGljb24gZm9yIGV4cGFuZGVkL2NvbGxhcHNlZCBzdGF0ZSB3b3VsZCByZW1vdmUgdGhlIHVpLWljb24tY2xhc3MKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uLCAoIGlzQ29sbGFwc2UgfHwgb3B0cy5leHBhbmRlZEljb24gPT09IG9wdHMuY29sbGFwc2VkSWNvbiApICkKCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICk7CgkJdWkuY29udGVudAoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgaXNDb2xsYXBzZSApCgkJCS50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCXRoaXMub3B0aW9ucy5jb2xsYXBzZWQgPSBpc0NvbGxhcHNlOwoJCXRoaXMuX3RyaWdnZXIoIGlzQ29sbGFwc2UgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCX0sCgoJZXhwYW5kOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggZmFsc2UgKTsKCX0sCgoJY29sbGFwc2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCB0cnVlICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdWkgPSB0aGlzLl91aSwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHVpLnBsYWNlaG9sZGVyICkgewoJCQl1aS5vcmlnaW5hbEhlYWRpbmcuaW5zZXJ0QmVmb3JlKCB1aS5wbGFjZWhvbGRlciApOwoJCQl1aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCQkJdWkuaGVhZGluZy5yZW1vdmUoKTsKCQl9IGVsc2UgewoJCQl1aS5zdGF0dXMucmVtb3ZlKCk7CgkJCXVpLmhlYWRpbmcKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmcgdWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkKCQkJCS5jaGlsZHJlbigpCgkJCQkJLmNvbnRlbnRzKCkKCQkJCQkJLnVud3JhcCgpOwoJCX0KCgkJdWkuYW5jaG9yLmNvbnRlbnRzKCkudW53cmFwKCk7CgkJdWkuY29udGVudC5jb250ZW50cygpLnVud3JhcCgpOwoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSB1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQgIiArCgkJCQkidWktY29sbGFwc2libGUtdGhlbWVkLWNvbnRlbnQgdWktY29sbGFwc2libGUtaW5zZXQgdWktY29ybmVyLWFsbCIgKTsKCX0KfSk7CgovLyBEZWZhdWx0cyB0byBiZSB1c2VkIGJ5IGFsbCBpbnN0YW5jZXMgb2YgY29sbGFwc2libGUgaWYgcGVyLWluc3RhbmNlIHZhbHVlcwovLyBhcmUgdW5zZXQgb3IgaWYgbm90aGluZyBpcyBzcGVjaWZpZWQgYnkgd2F5IG9mIGluaGVyaXRhbmNlIGZyb20gYW4gYWNjb3JkaW9uLgovLyBOb3RlIHRoYXQgdGhpcyBoYXNoIGRvZXMgbm90IGNvbnRhaW4gb3B0aW9ucyAiY29sbGFwc2VkIiBvciAiaGVhZGluZyIsCi8vIGJlY2F1c2UgdGhvc2UgYXJlIG5vdCBpbmhlcml0YWJsZS4KJC5tb2JpbGUuY29sbGFwc2libGUuZGVmYXVsdHMgPSB7CglleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJY29sbGFwc2VkSWNvbjogInBsdXMiLAoJY29udGVudFRoZW1lOiAiaW5oZXJpdCIsCglleHBhbmRlZEljb246ICJtaW51cyIsCglpY29ucG9zOiAibGVmdCIsCglpbnNldDogdHJ1ZSwKCWNvcm5lcnM6IHRydWUsCgl0aGVtZTogImluaGVyaXQiLAoJbWluaTogZmFsc2UKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHVpU2NyZWVuSGlkZGVuUmVnZXggPSAvXGJ1aS1zY3JlZW4taGlkZGVuXGIvOwpmdW5jdGlvbiBub0hpZGRlbkNsYXNzKCBlbGVtZW50cyApIHsKCXZhciBpbmRleCwKCQlsZW5ndGggPSBlbGVtZW50cy5sZW5ndGgsCgkJcmVzdWx0ID0gW107CgoJZm9yICggaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQlpZiAoICFlbGVtZW50c1sgaW5kZXggXS5jbGFzc05hbWUubWF0Y2goIHVpU2NyZWVuSGlkZGVuUmVnZXggKSApIHsKCQkJcmVzdWx0LnB1c2goIGVsZW1lbnRzWyBpbmRleCBdICk7CgkJfQoJfQoKCXJldHVybiAkKCByZXN1bHQgKTsKfQoKJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgPSB7CglfZ2V0VmlzaWJsZXM6IGZ1bmN0aW9uKCAkZWxzLCBjcmVhdGUgKSB7CgkJdmFyIHZpc2libGVzOwoKCQlpZiAoIGNyZWF0ZSApIHsKCQkJdmlzaWJsZXMgPSBub0hpZGRlbkNsYXNzKCAkZWxzICk7CgkJfSBlbHNlIHsKCQkJdmlzaWJsZXMgPSAkZWxzLmZpbHRlciggIjp2aXNpYmxlIiApOwoJCQlpZiAoIHZpc2libGVzLmxlbmd0aCA9PT0gMCApIHsKCQkJCXZpc2libGVzID0gbm9IaWRkZW5DbGFzcyggJGVscyApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdmlzaWJsZXM7Cgl9LAoKCV9hZGRGaXJzdExhc3RDbGFzc2VzOiBmdW5jdGlvbiggJGVscywgJHZpc2libGVzLCBjcmVhdGUgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7CgkJJHZpc2libGVzLmVxKCAwICkuYWRkQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCIgKS5lbmQoKS5sYXN0KCkuYWRkQ2xhc3MoICJ1aS1sYXN0LWNoaWxkIiApOwoJCWlmICggIWNyZWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJfQoJfSwKCglfcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlczogZnVuY3Rpb24oICRlbHMgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yID0gIjptb2JpbGUtY29sbGFwc2libGUsICIgKyAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3I7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZXNldCIsICQuZXh0ZW5kKCB7CgoJLy8gVGhlIGluaXRTZWxlY3RvciBpcyBkZXByZWNhdGVkIGFzIG9mIDEuNC4wLiBJbiAxLjUuMCB3ZSB3aWxsIHVzZQoJLy8gOmpxbURhdGEocm9sZT0nY29sbGFwc2libGVzZXQnKSB3aGljaCB3aWxsIGFsbG93IHVzIHRvIGdldCByaWQgb2YgdGhlIGxpbmUKCS8vIGJlbG93IGFsdG9nZXRoZXIsIGJlY2F1c2UgdGhlIGF1dG9pbml0IHdpbGwgZ2VuZXJhdGUgc3VjaCBhbiBpbml0U2VsZWN0b3IKCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpLDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlc2V0JykiLAoKCW9wdGlvbnM6ICQuZXh0ZW5kKCB7CgkJZW5oYW5jZWQ6IGZhbHNlCgl9LCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0cyApLAoKCV9oYW5kbGVDb2xsYXBzaWJsZUV4cGFuZDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBjbG9zZXN0Q29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWNvbGxhcHNpYmxlIiApOwoKCQlpZiAoIGNsb3Nlc3RDb2xsYXBzaWJsZS5wYXJlbnQoKS5pcyggIjptb2JpbGUtY29sbGFwc2libGVzZXQsIDpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApICkgewoJCQljbG9zZXN0Q29sbGFwc2libGUKCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZTpub3QoLnVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCkiICkKCQkJCS5jb2xsYXBzaWJsZSggImNvbGxhcHNlIiApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9jbGFzc2VzOiAiIgoJCX0pOwoKCQlpZiAoICFvcHRzLmVuaGFuY2VkICkgewoJCQllbGVtLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0ICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJKCBvcHRzLmNvcm5lcnMgJiYgb3B0cy5pbnNldCA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3IgKS5jb2xsYXBzaWJsZSgpOwoJCX0KCgkJdGhpcy5fb24oIGVsZW0sIHsgY29sbGFwc2libGVleHBhbmQ6ICJfaGFuZGxlQ29sbGFwc2libGVFeHBhbmQiIH0gKTsKCX0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggcHJlZml4LCB2YWx1ZSApIHsKCQlyZXR1cm4gKCB2YWx1ZSA/ICggdmFsdWUgPT09ICJub25lIiA/ICIiIDogcHJlZml4ICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCB0cnVlICk7CgoJCS8vIEJlY2F1c2UgdGhlIGNvcm5lcnMgYXJlIGhhbmRsZWQgYnkgdGhlIGNvbGxhcHNpYmxlIGl0c2VsZiBhbmQgdGhlIGRlZmF1bHQgc3RhdGUgaXMgY29sbGFwc2VkCgkJLy8gVGhhdCB3YXMgY2F1c2luZyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQxMTYKCQl0aGlzLmVsZW1lbnQKCQkJLmNoaWxkcmVuKCBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yICkKCQkJLmZpbHRlciggIjpqcW1EYXRhKGNvbGxhcHNlZD0nZmFsc2UnKSIgKQoJCQkuY29sbGFwc2libGUoICJleHBhbmQiICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgcmV0LCBoYXNDb3JuZXJzLAoJCQllbGVtID0gdGhpcy5lbGVtZW50LAoJCQl0aGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCBvcHRpb25zLnRoZW1lICk7CgoJCWlmICggdGhlbWVDbGFzcyApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIHRoaXMub3B0aW9ucy50aGVtZSApICkKCQkJCS5hZGRDbGFzcyggdGhlbWVDbGFzcyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmluc2V0ICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0aW9ucy5pbnNldCAmJiAoIG9wdGlvbnMuY29ybmVycyB8fCB0aGlzLm9wdGlvbnMuY29ybmVycyApICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQloYXNDb3JuZXJzID0gISEoIG9wdGlvbnMuY29ybmVycyAmJiAoIG9wdGlvbnMuaW5zZXQgfHwgdGhpcy5vcHRpb25zLmluc2V0ICkgKTsKCQl9CgoJCWlmICggaGFzQ29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIGhhc0Nvcm5lcnMgKTsKCQl9CgoJCXJldCA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiOm1vYmlsZS1jb2xsYXBzaWJsZSIgKS5jb2xsYXBzaWJsZSggInJlZnJlc2giICk7CgkJcmV0dXJuIHJldDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuZWxlbWVudDsKCgkJdGhpcy5fcmVtb3ZlRmlyc3RMYXN0Q2xhc3NlcyggZWwuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKSApOwoJCWVsCgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCB1aS1jb3JuZXItYWxsICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ncm91cC10aGVtZS0iLCB0aGlzLm9wdGlvbnMudGhlbWUgKSApCgkJCS5jaGlsZHJlbiggIjptb2JpbGUtY29sbGFwc2libGUiICkKCQkJLmNvbGxhcHNpYmxlKCAiZGVzdHJveSIgKTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdmFyIGNvbGxhcHNpYmxlc0luU2V0ID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCBjaGlsZENvbGxhcHNpYmxlc1NlbGVjdG9yICk7CgoJCXRoaXMuZWxlbWVudC5maW5kKCAkLm1vYmlsZS5jb2xsYXBzaWJsZS5pbml0U2VsZWN0b3IgKS5ub3QoICIudWktY29sbGFwc2libGUiICkuY29sbGFwc2libGUoKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggY29sbGFwc2libGVzSW5TZXQsIHRoaXMuX2dldFZpc2libGVzKCBjb2xsYXBzaWJsZXNJblNldCwgY3JlYXRlICksIGNyZWF0ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIERlcHJlY2F0ZWQgaW4gMS40CiQuZm4uZmllbGRjb250YWluID0gZnVuY3Rpb24oLyogb3B0aW9ucyAqLykgewoJcmV0dXJuIHRoaXMuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIiApOwp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLmZuLmdyaWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJbyA9ICQuZXh0ZW5kKHsKCQkJCWdyaWQ6IG51bGwKCQkJfSwgb3B0aW9ucyApLAoJCQkka2lkcyA9ICR0aGlzLmNoaWxkcmVuKCksCgkJCWdyaWRDb2xzID0geyBzb2xvOjEsIGE6MiwgYjozLCBjOjQsIGQ6NSB9LAoJCQlncmlkID0gby5ncmlkLAoJCQlpdGVyYXRvciwKCQkJbGV0dGVyOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggbGV0dGVyIGluIGdyaWRDb2xzICkgewoJCQkJCQlpZiAoIGdyaWRDb2xzWyBsZXR0ZXIgXSA9PT0gJGtpZHMubGVuZ3RoICkgewoJCQkJCQkJZ3JpZCA9IGxldHRlcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJZ3JpZCA9ICJhIjsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtZHVvIiApOwoJCQkJfQoJCQl9CgkJCWl0ZXJhdG9yID0gZ3JpZENvbHNbZ3JpZF07CgoJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC0iICsgZ3JpZCApOwoKCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzEpIiApLmFkZENsYXNzKCAidWktYmxvY2stYSIgKTsKCgkJaWYgKCBpdGVyYXRvciA+IDEgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMikiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1iIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMiApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibiszKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWMiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAzICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzQpIiApLmFkZENsYXNzKCAidWktYmxvY2stZCIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDQgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1lIiApOwoJCX0KCX0pOwp9Owp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLm5hdmJhciIsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgJG5hdmJhciA9IHRoaXMuZWxlbWVudCwKCQkJJG5hdmJ0bnMgPSAkbmF2YmFyLmZpbmQoICJhLCBidXR0b24iICksCgkJCWljb25wb3MgPSAkbmF2YnRucy5maWx0ZXIoICI6anFtRGF0YShpY29uKSIgKS5sZW5ndGggPyB0aGlzLm9wdGlvbnMuaWNvbnBvcyA6IHVuZGVmaW5lZDsKCgkJJG5hdmJhci5hZGRDbGFzcyggInVpLW5hdmJhciIgKQoJCQkuYXR0ciggInJvbGUiLCAibmF2aWdhdGlvbiIgKQoJCQkuZmluZCggInVsIiApCgkJCS5qcW1FbmhhbmNlYWJsZSgpCgkJCS5ncmlkKHsgZ3JpZDogdGhpcy5vcHRpb25zLmdyaWQgfSk7CgoJCSRuYXZidG5zCgkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBpY29uID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiaWNvbiIgKSwKCQkJCQl0aGVtZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgInRoZW1lIiApLAoJCQkJCWNsYXNzZXMgPSAidWktYnRuIjsKCgkJCQlpZiAoIHRoZW1lICkgewoJCQkJCWNsYXNzZXMgKz0gIiB1aS1idG4tIiArIHRoZW1lOwoJCQkJfQoJCQkJaWYgKCBpY29uICkgewoJCQkJCWNsYXNzZXMgKz0gIiB1aS1pY29uLSIgKyBpY29uICsgIiB1aS1idG4taWNvbi0iICsgaWNvbnBvczsKCQkJCX0KCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggY2xhc3NlcyApOwoJCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggdGhpcyApOwoKCQkJaWYgKCAhKCBhY3RpdmVCdG4uaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSB8fAoKCQkJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgYWZ0ZXIgMS40LjAgcmVsZWFzZQoJCQkJLy8gb25seSB1aS1zdGF0ZS1kaXNhYmxlZCBzaG91bGQgYmUgcHJlc2VudCB0aGVyZWFmdGVyCgkJCQlhY3RpdmVCdG4uaGFzQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKSB8fAoJCQkJYWN0aXZlQnRuLmhhc0NsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApICkgKSB7CgoJCQkJJG5hdmJ0bnMucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQlhY3RpdmVCdG4uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCQkJLy8gVGhlIGNvZGUgYmVsb3cgaXMgYSB3b3JrYXJvdW5kIHRvIGZpeCAjMTE4MQoJCQkJJCggZG9jdW1lbnQgKS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWFjdGl2ZUJ0bi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0pOwoJCQl9CgkJfSk7CgoJCS8vIEJ1dHRvbnMgaW4gdGhlIG5hdmJhciB3aXRoIHVpLXN0YXRlLXBlcnNpc3QgY2xhc3Mgc2hvdWxkIHJlZ2FpbiB0aGVpciBhY3RpdmUgc3RhdGUgYmVmb3JlIHBhZ2Ugc2hvdwoJCSRuYXZiYXIuY2xvc2VzdCggIi51aS1wYWdlIiApLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkkbmF2YnRucy5maWx0ZXIoICIudWktc3RhdGUtcGVyc2lzdCIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBnZXRBdHRyID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlOwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLmV4dGVuZCggewoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3VudFRoZW1lOiBudWxsLCAvKiBEZXByZWNhdGVkIGluIDEuNCAqLwoJCWRpdmlkZXJUaGVtZTogbnVsbCwKCQlpY29uOiAiY2FyYXQtciIsCgkJc3BsaXRJY29uOiAiY2FyYXQtciIsCgkJc3BsaXRUaGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpbnNldDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSB0aGlzLAoJCQlsaXN0dmlld0NsYXNzZXMgPSAiIjsKCgkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5pbnNldCA/ICIgdWktbGlzdHZpZXctaW5zZXQiIDogIiI7CgoJCWlmICggISF0Lm9wdGlvbnMuaW5zZXQgKSB7CgkJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIjsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIjsKCQl9CgoJCS8vIGNyZWF0ZSBsaXN0dmlldyBtYXJrdXAKCQl0LmVsZW1lbnQuYWRkQ2xhc3MoICIgdWktbGlzdHZpZXciICsgbGlzdHZpZXdDbGFzc2VzICk7CgoJCXQucmVmcmVzaCggdHJ1ZSApOwoJfSwKCgkvLyBUT0RPOiBSZW1vdmUgaW4gMS41CglfZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbmV4dFByb3AsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciBkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXR1cm4gZWxlOwoJCQl9CgkJCWVsZSA9IGVsZVsgbmV4dFByb3AgXTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoJLy8gVE9ETzogUmVtb3ZlIGluIDEuNQoJX2FkZFRodW1iQ2xhc3NlczogZnVuY3Rpb24oIGNvbnRhaW5lcnMgKSB7CgkJdmFyIGksIGltZywgbGVuID0gY29udGFpbmVycy5sZW5ndGg7CgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJaW1nID0gJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggY29udGFpbmVyc1sgaSBdLmZpcnN0Q2hpbGQsICJuZXh0U2libGluZyIsICJpbWciLCAiSU1HIiApICk7CgkJCWlmICggaW1nLmxlbmd0aCApIHsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5oYXNDbGFzcyggInVpLWxpLWljb24iICkgPyAidWktbGktaGFzLWljb24iIDogInVpLWxpLWhhcy10aHVtYiIgKTsKCQkJfQoJCX0KCX0sCgoJX2dldENoaWxkcmVuQnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgcmVzdWx0cyA9IFtdLAoJCQlkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJZWxlID0gZWxlLmZpcnN0Q2hpbGQ7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZSApOwoJCQl9CgkJCWVsZSA9IGVsZS5uZXh0U2libGluZzsKCQl9CgkJcmV0dXJuICQoIHJlc3VsdHMgKTsKCX0sCgoJX2JlZm9yZUxpc3R2aWV3UmVmcmVzaDogJC5ub29wLAoJX2FmdGVyTGlzdHZpZXdSZWZyZXNoOiAkLm5vb3AsCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl2YXIgYnV0dG9uQ2xhc3MsIHBvcywgbnVtbGksIGl0ZW0sIGl0ZW1DbGFzcywgaXRlbVRoZW1lLCBpdGVtSWNvbiwgaWNvbiwgYSwKCQkJaXNEaXZpZGVyLCBzdGFydENvdW50LCBuZXdTdGFydENvdW50LCB2YWx1ZSwgbGFzdCwgc3BsaXR0aGVtZSwgc3BsaXRUaGVtZUNsYXNzLCBzcGxpdGljb24sCgkJCWFsdEJ1dHRvbkNsYXNzLCBkaXZpZGVyVGhlbWUsIGxpLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkkbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJb2wgPSAhISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSwKCQkJc3RhcnQgPSAkbGlzdC5hdHRyKCAic3RhcnQiICksCgkJCWl0ZW1DbGFzc0RpY3QgPSB7fSwKCQkJY291bnRCdWJibGVzID0gJGxpc3QuZmluZCggIi51aS1saS1jb3VudCIgKSwKCQkJY291bnRUaGVtZSA9IGdldEF0dHIoICRsaXN0WyAwIF0sICJjb3VudHRoZW1lIiApIHx8IHRoaXMub3B0aW9ucy5jb3VudFRoZW1lLAoJCQljb3VudFRoZW1lQ2xhc3MgPSBjb3VudFRoZW1lID8gInVpLWJvZHktIiArIGNvdW50VGhlbWUgOiAidWktYm9keS1pbmhlcml0IjsKCgkJaWYgKCBvLnRoZW1lICkgewoJCQkkbGlzdC5hZGRDbGFzcyggInVpLWdyb3VwLXRoZW1lLSIgKyBvLnRoZW1lICk7CgkJfQoKCQkvLyBDaGVjayBpZiBhIHN0YXJ0IGF0dHJpYnV0ZSBoYXMgYmVlbiBzZXQgd2hpbGUgdGFraW5nIGEgdmFsdWUgb2YgMCBpbnRvIGFjY291bnQKCQlpZiAoIG9sICYmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSApIHsKCQkJc3RhcnRDb3VudCA9IHBhcnNlSW50KCBzdGFydCwgMTAgKSAtIDE7CgkJCSRsaXN0LmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgc3RhcnRDb3VudCApOwoJCX0KCgkJdGhpcy5fYmVmb3JlTGlzdHZpZXdSZWZyZXNoKCk7CgoJCWxpID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoICRsaXN0WyAwIF0sICJsaSIsICJMSSIgKTsKCgkJZm9yICggcG9zID0gMCwgbnVtbGkgPSBsaS5sZW5ndGg7IHBvcyA8IG51bWxpOyBwb3MrKyApIHsKCQkJaXRlbSA9IGxpLmVxKCBwb3MgKTsKCQkJaXRlbUNsYXNzID0gIiI7CgoJCQlpZiAoIGNyZWF0ZSB8fCBpdGVtWyAwIF0uY2xhc3NOYW1lLnNlYXJjaCggL1xidWktbGktc3RhdGljXGJ8XGJ1aS1saS1kaXZpZGVyXGIvICkgPCAwICkgewoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQlpc0RpdmlkZXIgPSAoIGdldEF0dHIoIGl0ZW1bIDAgXSwgInJvbGUiICkgPT09ICJsaXN0LWRpdmlkZXIiICk7CgkJCQl2YWx1ZSA9IGl0ZW0uYXR0ciggInZhbHVlIiApOwoJCQkJaXRlbVRoZW1lID0gZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiICk7CgoJCQkJaWYgKCBhLmxlbmd0aCAmJiBhWyAwIF0uY2xhc3NOYW1lLnNlYXJjaCggL1xidWktYnRuXGIvICkgPCAwICYmICFpc0RpdmlkZXIgKSB7CgkJCQkJaXRlbUljb24gPSBnZXRBdHRyKCBpdGVtWyAwIF0sICJpY29uIiApOwoJCQkJCWljb24gPSAoIGl0ZW1JY29uID09PSBmYWxzZSApID8gZmFsc2UgOiAoIGl0ZW1JY29uIHx8IG8uaWNvbiApOwoKCQkJCQkvLyBUT0RPOiBSZW1vdmUgaW4gMS41IHRvZ2V0aGVyIHdpdGggbGlua3MuanMgKGxpbmtzLmpzIC8gLnVpLWxpbmsgZGVwcmVjYXRlZCBpbiAxLjQpCgkJCQkJYS5yZW1vdmVDbGFzcyggInVpLWxpbmsiICk7CgoJCQkJCWJ1dHRvbkNsYXNzID0gInVpLWJ0biI7CgoJCQkJCWlmICggaXRlbVRoZW1lICkgewoJCQkJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi0iICsgaXRlbVRoZW1lOwoJCQkJCX0KCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyA9ICJ1aS1saS1oYXMtYWx0IjsKCgkJCQkJCWxhc3QgPSBhLmxhc3QoKTsKCQkJCQkJc3BsaXR0aGVtZSA9IGdldEF0dHIoIGxhc3RbIDAgXSwgInRoZW1lIiApIHx8IG8uc3BsaXRUaGVtZSB8fCBnZXRBdHRyKCBpdGVtWyAwIF0sICJ0aGVtZSIsIHRydWUgKTsKCQkJCQkJc3BsaXRUaGVtZUNsYXNzID0gc3BsaXR0aGVtZSA/ICIgdWktYnRuLSIgKyBzcGxpdHRoZW1lIDogIiI7CgkJCQkJCXNwbGl0aWNvbiA9IGdldEF0dHIoIGxhc3RbIDAgXSwgImljb24iICkgfHwgZ2V0QXR0ciggaXRlbVsgMCBdLCAiaWNvbiIgKSB8fCBvLnNwbGl0SWNvbjsKCQkJCQkJYWx0QnV0dG9uQ2xhc3MgPSAidWktYnRuIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1pY29uLSIgKyBzcGxpdGljb24gKyBzcGxpdFRoZW1lQ2xhc3M7CgoJCQkJCQlsYXN0CgkJCQkJCQkuYXR0ciggInRpdGxlIiwgJC50cmltKCBsYXN0LmdldEVuY29kZWRUZXh0KCkgKSApCgkJCQkJCQkuYWRkQ2xhc3MoIGFsdEJ1dHRvbkNsYXNzICkKCQkJCQkJCS5lbXB0eSgpOwoKCQkJCQkJLy8gUmVkdWNlIHRvIHRoZSBmaXJzdCBhbmNob3IsIGJlY2F1c2Ugb25seSB0aGUgZmlyc3QgZ2V0cyB0aGUgYnV0dG9uQ2xhc3MKCQkJCQkJYSA9IGEuZmlyc3QoKTsKCQkJCQl9IGVsc2UgaWYgKCBpY29uICkgewoJCQkJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi1pY29uLXJpZ2h0IHVpLWljb24tIiArIGljb247CgkJCQkJfQoKCQkJCQkvLyBBcHBseSBidXR0b25DbGFzcyB0byB0aGUgKGZpcnN0KSBhbmNob3IKCQkJCQlhLmFkZENsYXNzKCBidXR0b25DbGFzcyApOwoJCQkJfSBlbHNlIGlmICggaXNEaXZpZGVyICkgewoJCQkJCWRpdmlkZXJUaGVtZSA9ICggZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiICkgfHwgby5kaXZpZGVyVGhlbWUgfHwgby50aGVtZSApOwoKCQkJCQlpdGVtQ2xhc3MgPSAidWktbGktZGl2aWRlciB1aS1iYXItIiArICggZGl2aWRlclRoZW1lID8gZGl2aWRlclRoZW1lIDogImluaGVyaXQiICk7CgoJCQkJCWl0ZW0uYXR0ciggInJvbGUiLCAiaGVhZGluZyIgKTsKCQkJCX0gZWxzZSBpZiAoIGEubGVuZ3RoIDw9IDAgKSB7CgkJCQkJaXRlbUNsYXNzID0gInVpLWxpLXN0YXRpYyB1aS1ib2R5LSIgKyAoIGl0ZW1UaGVtZSA/IGl0ZW1UaGVtZSA6ICJpbmhlcml0IiApOwoJCQkJfQoJCQkJaWYgKCBvbCAmJiB2YWx1ZSApIHsKCQkJCQluZXdTdGFydENvdW50ID0gcGFyc2VJbnQoIHZhbHVlICwgMTAgKSAtIDE7CgoJCQkJCWl0ZW0uY3NzKCAiY291bnRlci1yZXNldCIsICJsaXN0bnVtYmVyaW5nICIgKyBuZXdTdGFydENvdW50ICk7CgkJCQl9CgkJCX0KCgkJCS8vIEluc3RlYWQgb2Ygc2V0dGluZyBpdGVtIGNsYXNzIGRpcmVjdGx5IG9uIHRoZSBsaXN0IGl0ZW0KCQkJLy8gYXQgdGhpcyBwb2ludCBpbiB0aW1lLCBwdXNoIHRoZSBpdGVtIGludG8gYSBkaWN0aW9uYXJ5CgkJCS8vIHRoYXQgdGVsbHMgdXMgd2hhdCBjbGFzcyB0byBzZXQgb24gaXQgc28gd2UgY2FuIGRvIHRoaXMgYWZ0ZXIgdGhpcwoJCQkvLyBwcm9jZXNzaW5nIGxvb3AgaXMgZmluaXNoZWQuCgoJCQlpZiAoICFpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSApIHsKCQkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdID0gW107CgkJCX0KCgkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdLnB1c2goIGl0ZW1bIDAgXSApOwoJCX0KCgkJLy8gU2V0IHRoZSBhcHByb3ByaWF0ZSBsaXN0dmlldyBpdGVtIGNsYXNzZXMgb24gZWFjaCBsaXN0IGl0ZW0uCgkJLy8gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICk7CgkJfQoKCQljb3VudEJ1YmJsZXMuZWFjaCggZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICk7CgkJfSk7CgkJaWYgKCBjb3VudFRoZW1lQ2xhc3MgKSB7CgkJCWNvdW50QnViYmxlcy5ub3QoICJbY2xhc3MqPSd1aS1ib2R5LSddIiApLmFkZENsYXNzKCBjb3VudFRoZW1lQ2xhc3MgKTsKCQl9CgoJCS8vIERlcHJlY2F0ZWQgaW4gMS40LiBGcm9tIDEuNSB5b3UgaGF2ZSB0byBhZGQgY2xhc3MgdWktbGktaGFzLXRodW1iIG9yIHVpLWxpLWhhcy1pY29uIHRvIHRoZSBMSS4KCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoIGxpICk7CgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCBsaS5maW5kKCAiLnVpLWJ0biIgKSApOwoKCQl0aGlzLl9hZnRlckxpc3R2aWV3UmVmcmVzaCgpOwoKCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBsaSwgdGhpcy5fZ2V0VmlzaWJsZXMoIGxpLCBjcmVhdGUgKSwgY3JlYXRlICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKZnVuY3Rpb24gZGVmYXVsdEF1dG9kaXZpZGVyc1NlbGVjdG9yKCBlbHQgKSB7CgkvLyBsb29rIGZvciB0aGUgdGV4dCBpbiB0aGUgZ2l2ZW4gZWxlbWVudAoJdmFyIHRleHQgPSAkLnRyaW0oIGVsdC50ZXh0KCkgKSB8fCBudWxsOwoKCWlmICggIXRleHQgKSB7CgkJcmV0dXJuIG51bGw7Cgl9CgoJLy8gY3JlYXRlIHRoZSB0ZXh0IGZvciB0aGUgZGl2aWRlciAoZmlyc3QgdXBwZXJjYXNlZCBsZXR0ZXIpCgl0ZXh0ID0gdGV4dC5zbGljZSggMCwgMSApLnRvVXBwZXJDYXNlKCk7CgoJcmV0dXJuIHRleHQ7Cn0KCiQud2lkZ2V0KCAibW9iaWxlLmxpc3R2aWV3IiwgJC5tb2JpbGUubGlzdHZpZXcsIHsKCW9wdGlvbnM6IHsKCQlhdXRvZGl2aWRlcnM6IGZhbHNlLAoJCWF1dG9kaXZpZGVyc1NlbGVjdG9yOiBkZWZhdWx0QXV0b2RpdmlkZXJzU2VsZWN0b3IKCX0sCgoJX2JlZm9yZUxpc3R2aWV3UmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuYXV0b2RpdmlkZXJzICkgewoJCQl0aGlzLl9yZXBsYWNlRGl2aWRlcnMoKTsKCQkJdGhpcy5fc3VwZXJBcHBseSggYXJndW1lbnRzICk7CgkJfQoJfSwKCglfcmVwbGFjZURpdmlkZXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgaSwgbGlzLCBsaSwgZGl2aWRlclRleHQsCgkJCWxhc3REaXZpZGVyVGV4dCA9IG51bGwsCgkJCWxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCWRpdmlkZXI7CgoJCWxpc3QuY2hpbGRyZW4oICJsaTpqcW1EYXRhKHJvbGU9J2xpc3QtZGl2aWRlcicpIiApLnJlbW92ZSgpOwoKCQlsaXMgPSBsaXN0LmNoaWxkcmVuKCAibGkiICk7CgoJCWZvciAoIGkgPSAwOyBpIDwgbGlzLmxlbmd0aCA7IGkrKyApIHsKCQkJbGkgPSBsaXNbIGkgXTsKCQkJZGl2aWRlclRleHQgPSB0aGlzLm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IoICQoIGxpICkgKTsKCgkJCWlmICggZGl2aWRlclRleHQgJiYgbGFzdERpdmlkZXJUZXh0ICE9PSBkaXZpZGVyVGV4dCApIHsKCQkJCWRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggZGl2aWRlclRleHQgKSApOwoJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgImxpc3QtZGl2aWRlciIgKTsKCQkJCWxpLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBkaXZpZGVyLCBsaSApOwoJCQl9CgoJCQlsYXN0RGl2aWRlclRleHQgPSBkaXZpZGVyVGV4dDsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcmRpdmlkZXIgPSAvKF58XHMpdWktbGktZGl2aWRlcigkfFxzKS8sCglyaGlkZGVuID0gLyhefFxzKXVpLXNjcmVlbi1oaWRkZW4oJHxccykvOwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS5saXN0dmlldywgewoJb3B0aW9uczogewoJCWhpZGVEaXZpZGVyczogZmFsc2UKCX0sCgoJX2FmdGVyTGlzdHZpZXdSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgaXRlbXMsIGlkeCwgaXRlbSwgaGlkZURpdmlkZXIgPSB0cnVlOwoKCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlkZURpdmlkZXJzICkgewoJCQlpdGVtcyA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCB0aGlzLmVsZW1lbnRbIDAgXSwgImxpIiwgIkxJIiApOwoJCQlmb3IgKCBpZHggPSBpdGVtcy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJCWl0ZW0gPSBpdGVtc1sgaWR4IF07CgkJCQlpZiAoIGl0ZW0uY2xhc3NOYW1lLm1hdGNoKCByZGl2aWRlciApICkgewoJCQkJCWlmICggaGlkZURpdmlkZXIgKSB7CgkJCQkJCWl0ZW0uY2xhc3NOYW1lID0gaXRlbS5jbGFzc05hbWUgKyAiIHVpLXNjcmVlbi1oaWRkZW4iOwoJCQkJCX0KCQkJCQloaWRlRGl2aWRlciA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCWlmICggIWl0ZW0uY2xhc3NOYW1lLm1hdGNoKCByaGlkZGVuICkgKSB7CgkJCQkJCWhpZGVEaXZpZGVyID0gZmFsc2U7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUubm9qcyA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgkkKCAiOmpxbURhdGEocm9sZT0nbm9qcycpIiwgdGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1ub2pzIiApOwp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ID0gewoJX2hhbmRsZUZvcm1SZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSIgKSwgewoJCQlyZXNldDogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLl9kZWxheSggIl9yZXNldCIgKTsKCQkJfQoJCX0pOwoJfQp9OwoKfSkoIGpRdWVyeSApOwoKLyoKKiAiY2hlY2tib3hyYWRpbyIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBlc2NhcGVJZCA9ICQubW9iaWxlLnBhdGguaGFzaFRvU2VsZWN0b3I7CgokLndpZGdldCggIm1vYmlsZS5jaGVja2JveHJhZGlvIiwgJC5leHRlbmQoIHsKCglpbml0U2VsZWN0b3I6ICJpbnB1dDpub3QoIDpqcW1EYXRhKHJvbGU9J2ZsaXBzd2l0Y2gnICkgKVt0eXBlPSdjaGVja2JveCddLGlucHV0W3R5cGU9J3JhZGlvJ106bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJyApKSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiAiaW5oZXJpdCIsCgoJCS8vIERlcHJlY2F0ZWQgYXMgb2YgMS41LjAKCQltaW5pOiBmYWxzZSwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCWljb25wb3M6ICJsZWZ0IgoKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWluaGVyaXRBdHRyID0gZnVuY3Rpb24oIGlucHV0LCBkYXRhQXR0ciApIHsKCQkJCXJldHVybiBpbnB1dC5qcW1EYXRhKCBkYXRhQXR0ciApIHx8CgkJCQkJaW5wdXQuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0IiApLmpxbURhdGEoIGRhdGFBdHRyICk7CgkJCX0sCgkJCWxhYmVsID0gdGhpcy5vcHRpb25zLmVuaGFuY2VkID8KCQkJCXsKCQkJCQllbGVtZW50OiB0aGlzLmVsZW1lbnQuc2libGluZ3MoICJsYWJlbCIgKSwKCQkJCQlpc1BhcmVudDogZmFsc2UKCQkJCX0gOgoJCQkJdGhpcy5fZmluZExhYmVsKCksCgkJCWlucHV0dHlwZSA9IGlucHV0WzBdLnR5cGUsCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgaW5wdXR0eXBlICsgIi1vbiIsCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyBpbnB1dHR5cGUgKyAiLW9mZiI7CgoJCWlmICggaW5wdXR0eXBlICE9PSAiY2hlY2tib3giICYmIGlucHV0dHlwZSAhPT0gInJhZGlvIiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0aGlzLmVsZW1lbnRbMF0uZGlzYWJsZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJfQoKCQlvLmljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApIHx8CgkJCWxhYmVsLmVsZW1lbnQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3MiICkgfHwgby5pY29ucG9zLAoKCQkvLyBEZXByZWNhdGVkIGFzIG9mIDEuNS4wCgkJLy8gRXN0YWJsaXNoIG9wdGlvbnMKCQlvLm1pbmkgPSBpbmhlcml0QXR0ciggaW5wdXQsICJtaW5pIiApIHx8IG8ubWluaTsKCgkJLy8gRXhwb3NlIGZvciBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJaW5wdXQ6IGlucHV0LAoJCQlsYWJlbDogbGFiZWwuZWxlbWVudCwKCQkJbGFiZWxJc1BhcmVudDogbGFiZWwuaXNQYXJlbnQsCgkJCWlucHV0dHlwZTogaW5wdXR0eXBlLAoJCQljaGVja2VkQ2xhc3M6IGNoZWNrZWRDbGFzcywKCQkJdW5jaGVja2VkQ2xhc3M6IHVuY2hlY2tlZENsYXNzCgkJfSk7CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJdGhpcy5fb24oIGxhYmVsLmVsZW1lbnQsIHsKCQkJdm1vdXNlb3ZlcjogIl9oYW5kbGVMYWJlbFZNb3VzZU92ZXIiLAoJCQl2Y2xpY2s6ICJfaGFuZGxlTGFiZWxWQ2xpY2siCgkJfSk7CgoJCXRoaXMuX29uKCBpbnB1dCwgewoJCQl2bW91c2Vkb3duOiAiX2NhY2hlVmFscyIsCgkJCXZjbGljazogIl9oYW5kbGVJbnB1dFZDbGljayIsCgkJCWZvY3VzOiAiX2hhbmRsZUlucHV0Rm9jdXMiLAoJCQlibHVyOiAiX2hhbmRsZUlucHV0Qmx1ciIKCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9maW5kTGFiZWw6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRMYWJlbCwgbGFiZWwsIGlzUGFyZW50LAoJCQlpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbGFiZWxzTGlzdCA9IGlucHV0WyAwIF0ubGFiZWxzOwoKCQlpZiggbGFiZWxzTGlzdCAmJiBsYWJlbHNMaXN0Lmxlbmd0aCA+IDAgKSB7CgkJCWxhYmVsID0gJCggbGFiZWxzTGlzdFsgMCBdICk7CgkJCWlzUGFyZW50ID0gJC5jb250YWlucyggbGFiZWxbIDAgXSwgaW5wdXRbIDAgXSApOwoJCX0gZWxzZSB7CgkJCXBhcmVudExhYmVsID0gaW5wdXQuY2xvc2VzdCggImxhYmVsIiApOwoJCQlpc1BhcmVudCA9ICggcGFyZW50TGFiZWwubGVuZ3RoID4gMCApOwoKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCWxhYmVsID0gaXNQYXJlbnQgPyBwYXJlbnRMYWJlbCA6CgkJCQkkKCB0aGlzLmRvY3VtZW50WyAwIF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJsYWJlbCIgKSApCgkJCQkJLmZpbHRlciggIltmb3I9JyIgKyBlc2NhcGVJZCggaW5wdXRbIDAgXS5pZCApICsgIiddIiApCgkJCQkJLmZpcnN0KCk7CgkJfQoKCQlyZXR1cm4gewoJCQllbGVtZW50OiBsYWJlbCwKCQkJaXNQYXJlbnQ6IGlzUGFyZW50CgkJfTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwuYWRkQ2xhc3MoICJ1aS1idG4gdWktY29ybmVyLWFsbCIpOwoKCQlpZiAoIHRoaXMubGFiZWxJc1BhcmVudCApIHsKCQkJdGhpcy5pbnB1dC5hZGQoIHRoaXMubGFiZWwgKS53cmFwQWxsKCB0aGlzLl93cmFwcGVyKCkgKTsKCQl9IGVsc2UgewoJCQkvL3RoaXMuZWxlbWVudC5yZXBsYWNlV2l0aCggdGhpcy5pbnB1dC5hZGQoIHRoaXMubGFiZWwgKS53cmFwQWxsKCB0aGlzLl93cmFwcGVyKCkgKSApOwoJCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fd3JhcHBlcigpICk7CgkJCXRoaXMuZWxlbWVudC5wYXJlbnQoKS5wcmVwZW5kKCB0aGlzLmxhYmVsICk7CgkJfQoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgoJCXRoaXMuX3NldE9wdGlvbnMoewoJCQkidGhlbWUiOiB0aGlzLm9wdGlvbnMudGhlbWUsCgkJCSJpY29ucG9zIjogdGhpcy5vcHRpb25zLmljb25wb3MsCgkJCSJ3cmFwcGVyQ2xhc3MiOiB0aGlzLm9wdGlvbnMud3JhcHBlckNsYXNzLAoKCQkJLy8gRGVwcmVjYXRlZCBhcyBvZiAxLjUuMAoJCQkibWluaSI6IHRoaXMub3B0aW9ucy5taW5pCgkJfSk7CgoJfSwKCglfd3JhcHBlcjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2IGNsYXNzPSd1aS0iICsgdGhpcy5pbnB1dHR5cGUgKwoJCQkoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArICInID48L2Rpdj4iICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmxhYmVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9oYW5kbGVJbnB1dEJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX2hhbmRsZUlucHV0VkNsaWNrOiBmdW5jdGlvbigpIHsKCQkvLyBBZGRzIGNoZWNrZWQgYXR0cmlidXRlIHRvIGNoZWNrZWQgaW5wdXQgd2hlbiBrZXlib2FyZCBpcyB1c2VkCgkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgdGhpcy5lbGVtZW50LmlzKCAiOmNoZWNrZWQiICkgKTsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLm5vdCggdGhpcy5lbGVtZW50ICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCXRoaXMuX3VwZGF0ZUFsbCggdHJ1ZSApOwoJfSwKCglfaGFuZGxlTGFiZWxWTW91c2VPdmVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLmxhYmVsLnBhcmVudCgpLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCX0KCX0sCgoJX2hhbmRsZUxhYmVsVkNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50OwoKCQlpZiAoIGlucHV0LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9jYWNoZVZhbHMoKTsKCgkJaW5wdXQucHJvcCggImNoZWNrZWQiLCB0aGlzLmlucHV0dHlwZSA9PT0gInJhZGlvIiAmJiB0cnVlIHx8ICFpbnB1dC5wcm9wKCAiY2hlY2tlZCIgKSApOwoKCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCS8vIGhvdyBsYWJlbCBjbGlja3MgYmVoYXZlIG5vcm1hbGx5IGluIHRoZSBicm93c2VycwoJCS8vIFRPRE86IGl0IHdvdWxkIGJlIG5pY2UgdG8gbGV0IHRoZSBicm93c2VyJ3MgaGFuZGxlIHRoZSBjbGlja3MgYW5kIHBhc3MgdGhlbQoJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJLy8gICAgICAgd3JhcHBlciBlbGVtZW50IGxldmVsCgkJaW5wdXQudHJpZ2dlckhhbmRsZXIoICJjbGljayIgKTsKCgkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCS8vIGJ1dHRvbnMsIGJ1dCB3aWxsIG5vdCBmb3IgY2hlY2tib3hlcy4gY2xlYXJpbmcgdGhlIGNoZWNrZWQgc3RhdHVzCgkJLy8gb2Ygb3RoZXIgcmFkaW9zIGVuc3VyZXMgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUgaXMgYXBwbGllZCBwcm9wZXJseQoJCXRoaXMuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJdGhpcy5fdXBkYXRlQWxsKCk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfY2FjaGVWYWxzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuYXR0cigiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy8gUmV0dXJucyB0aG9zZSByYWRpbyBidXR0b25zIHRoYXQgYXJlIHN1cHBvc2VkIHRvIGJlIGluIHRoZSBzYW1lIGdyb3VwIGFzCgkvLyB0aGlzIHJhZGlvIGJ1dHRvbi4gSW4gdGhlIGNhc2Ugb2YgYSBjaGVja2JveCBvciBhIHJhZGlvIGxhY2tpbmcgYSBuYW1lCgkvLyBhdHRyaWJ1dGUsIGl0IHJldHVybnMgdGhpcy5lbGVtZW50LgoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0b3IsIGZvcm1JZCwKCQkJcmFkaW8gPSB0aGlzLmVsZW1lbnRbIDAgXSwKCQkJbmFtZSA9IHJhZGlvLm5hbWUsCgkJCWZvcm0gPSByYWRpby5mb3JtLAoJCQlkb2MgPSB0aGlzLmVsZW1lbnQucGFyZW50cygpLmxhc3QoKS5nZXQoIDAgKSwKCgkJCS8vIEEgcmFkaW8gaXMgYWx3YXlzIGEgbWVtYmVyIG9mIGl0cyBvd24gZ3JvdXAKCQkJcmFkaW9zID0gdGhpcy5lbGVtZW50OwoKCQkvLyBPbmx5IHN0YXJ0IHJ1bm5pbmcgc2VsZWN0b3JzIGlmIHRoaXMgaXMgYW4gYXR0YWNoZWQgcmFkaW8gYnV0dG9uIHdpdGggYSBuYW1lCgkJaWYgKCBuYW1lICYmIHRoaXMuaW5wdXR0eXBlID09PSAicmFkaW8iICYmIGRvYyApIHsKCQkJc2VsZWN0b3IgPSAiaW5wdXRbdHlwZT0ncmFkaW8nXVtuYW1lPSciICsgZXNjYXBlSWQoIG5hbWUgKSArICInXSI7CgoJCQkvLyBJZiB3ZSdyZSBpbnNpZGUgYSBmb3JtCgkJCWlmICggZm9ybSApIHsKCQkJCWZvcm1JZCA9IGZvcm0uZ2V0QXR0cmlidXRlKCAiaWQiICk7CgoJCQkJLy8gSWYgdGhlIGZvcm0gaGFzIGFuIElELCBjb2xsZWN0IHJhZGlvcyBzY2F0dGVyZWQgdGhyb3VnaHQgdGhlIGRvY3VtZW50IHdoaWNoCgkJCQkvLyBuZXZlcnRoZWxlc3MgYXJlIHBhcnQgb2YgdGhlIGZvcm0gYnkgd2F5IG9mIHRoZSB2YWx1ZSBvZiB0aGVpciBmb3JtIGF0dHJpYnV0ZQoJCQkJaWYgKCBmb3JtSWQgKSB7CgkJCQkJcmFkaW9zID0gJCggc2VsZWN0b3IgKyAiW2Zvcm09JyIgKyBlc2NhcGVJZCggZm9ybUlkICkgKyAiJ10iLCBkb2MgKTsKCQkJCX0KCgkJCQkvLyBBbHNvIGFkZCB0byB0aG9zZSB0aGUgcmFkaW9zIGluIHRoZSBmb3JtIGl0c2VsZgoJCQkJcmFkaW9zID0gJCggZm9ybSApLmZpbmQoIHNlbGVjdG9yICkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCgkJCQkJLy8gU29tZSByYWRpb3MgaW5zaWRlIHRoZSBmb3JtIG1heSBiZWxvbmcgdG8gc29tZSBvdGhlciBmb3JtIGJ5IHZpcnR1ZSBvZgoJCQkJCS8vIGhhdmluZyBhIGZvcm0gYXR0cmlidXRlIGRlZmluZWQgb24gdGhlbSwgc28gd2UgbXVzdCBmaWx0ZXIgdGhlbSBvdXQgaGVyZQoJCQkJCXJldHVybiAoIHRoaXMuZm9ybSA9PT0gZm9ybSApOwoJCQkJfSkuYWRkKCByYWRpb3MgKTsKCgkJCS8vIElmIHdlJ3JlIG91dHNpZGUgYSBmb3JtCgkJCX0gZWxzZSB7CgoJCQkJLy8gQ29sbGVjdCBhbGwgdGhvc2UgcmFkaW9zIHdoaWNoIGFyZSBhbHNvIG91dHNpZGUgb2YgYSBmb3JtIGFuZCBtYXRjaCBvdXIgbmFtZQoJCQkJcmFkaW9zID0gJCggc2VsZWN0b3IsIGRvYyApLmZpbHRlciggZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuICF0aGlzLmZvcm07CgkJCQl9KTsKCQkJfQoJCX0KCQlyZXR1cm4gcmFkaW9zOwoJfSwKCglfdXBkYXRlQWxsOiBmdW5jdGlvbiggY2hhbmdlVHJpZ2dlcmVkICkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJaWYgKCAoIHRoaXMuY2hlY2tlZCB8fCBzZWxmLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApICYmICFjaGFuZ2VUcmlnZ2VyZWQgKSB7CgkJCQkkdGhpcy50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfSkKCQkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCS8vIElzIHRoZSB3aWRnZXQgc3VwcG9zZWQgdG8gZGlzcGxheSBhbiBpY29uPwoJX2hhc0ljb246IGZ1bmN0aW9uKCkgewoJCXZhciBjb250cm9sZ3JvdXAsIGNvbnRyb2xncm91cFdpZGdldCwKCQkJY29udHJvbGdyb3VwQ29uc3RydWN0b3IgPSAkLm1vYmlsZS5jb250cm9sZ3JvdXA7CgoJCS8vIElmIHRoZSBjb250cm9sZ3JvdXAgd2lkZ2V0IGlzIGRlZmluZWQgLi4uCgkJaWYgKCBjb250cm9sZ3JvdXBDb25zdHJ1Y3RvciApIHsKCQkJY29udHJvbGdyb3VwID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoCgkJCQkiOm1vYmlsZS1jb250cm9sZ3JvdXAsIiArCgkJCQljb250cm9sZ3JvdXBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuaW5pdFNlbGVjdG9yICk7CgoJCQkvLyAuLi4gYW5kIHRoZSBjaGVja2JveCBpcyBpbiBhIGNvbnRyb2xncm91cCAuLi4KCQkJaWYgKCBjb250cm9sZ3JvdXAubGVuZ3RoID4gMCApIHsKCgkJCQkvLyAuLi4gbG9vayBmb3IgYSBjb250cm9sZ3JvdXAgd2lkZ2V0IGluc3RhbmNlLCBhbmQgLi4uCgkJCQljb250cm9sZ3JvdXBXaWRnZXQgPSAkLmRhdGEoIGNvbnRyb2xncm91cFsgMCBdLCAibW9iaWxlLWNvbnRyb2xncm91cCIgKTsKCgkJCQkvLyAuLi4gaWYgZm91bmQsIGRlY2lkZSBiYXNlZCBvbiB0aGUgb3B0aW9uIHZhbHVlLCAuLi4KCQkJCXJldHVybiAoICggY29udHJvbGdyb3VwV2lkZ2V0ID8gY29udHJvbGdyb3VwV2lkZ2V0Lm9wdGlvbnMudHlwZSA6CgoJCQkJCS8vIC4uLiBvdGhlcndpc2UgZGVjaWRlIGJhc2VkIG9uIHRoZSAidHlwZSIgZGF0YSBhdHRyaWJ1dGUuCgkJCQkJY29udHJvbGdyb3VwLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlIiApICkgIT09ICJob3Jpem9udGFsIiApOwoJCQl9CgkJfQoKCQkvLyBOb3JtYWxseSwgdGhlIHdpZGdldCBkaXNwbGF5cyBhbiBpY29uLgoJCXJldHVybiB0cnVlOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgaXNDaGVja2VkID0gdGhpcy5lbGVtZW50WyAwIF0uY2hlY2tlZCwKCQkJYWN0aXZlID0gJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MsCgkJCWljb25wb3NDbGFzcyA9ICJ1aS1idG4taWNvbi0iICsgdGhpcy5vcHRpb25zLmljb25wb3MsCgkJCWFkZENsYXNzZXMgPSBbXSwKCQkJcmVtb3ZlQ2xhc3NlcyA9IFtdOwoKCQlpZiAoIHRoaXMuX2hhc0ljb24oKSApIHsKCQkJcmVtb3ZlQ2xhc3Nlcy5wdXNoKCBhY3RpdmUgKTsKCQkJYWRkQ2xhc3Nlcy5wdXNoKCBpY29ucG9zQ2xhc3MgKTsKCQl9IGVsc2UgewoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIGljb25wb3NDbGFzcyApOwoJCQkoIGlzQ2hlY2tlZCA/IGFkZENsYXNzZXMgOiByZW1vdmVDbGFzc2VzICkucHVzaCggYWN0aXZlICk7CgkJfQoKCQlpZiAoIGlzQ2hlY2tlZCApIHsKCQkJYWRkQ2xhc3Nlcy5wdXNoKCB0aGlzLmNoZWNrZWRDbGFzcyApOwoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQl9IGVsc2UgewoJCQlhZGRDbGFzc2VzLnB1c2goIHRoaXMudW5jaGVja2VkQ2xhc3MgKTsKCQkJcmVtb3ZlQ2xhc3Nlcy5wdXNoKCB0aGlzLmNoZWNrZWRDbGFzcyApOwoJCX0KCgkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiwgdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIgKSApOwoKCQl0aGlzLmxhYmVsCgkJCS5hZGRDbGFzcyggYWRkQ2xhc3Nlcy5qb2luKCAiICIgKSApCgkJCS5yZW1vdmVDbGFzcyggcmVtb3ZlQ2xhc3Nlcy5qb2luKCAiICIgKSApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmxhYmVsLnBhcmVudCgpOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGxhYmVsID0gdGhpcy5sYWJlbCwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCW91dGVyID0gdGhpcy53aWRnZXQoKSwKCQkJaGFzSWNvbiA9IHRoaXMuX2hhc0ljb24oKTsKCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuaW5wdXQucHJvcCggImRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgoJCS8vIERlcHJlY2F0ZWQgYXMgb2YgMS41LjAKCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCAhIW9wdGlvbnMubWluaSApOwoJCX0KCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJbGFiZWwKCQkJCS5yZW1vdmVDbGFzcyggInVpLWJ0bi0iICsgY3VycmVudE9wdGlvbnMudGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy53cmFwcGVyQ2xhc3MgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIKCQkJCS5yZW1vdmVDbGFzcyggY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzICkKCQkJCS5hZGRDbGFzcyggb3B0aW9ucy53cmFwcGVyQ2xhc3MgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmljb25wb3MgIT09IHVuZGVmaW5lZCAmJiBoYXNJY29uICkgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggInVpLWJ0bi1pY29uLSIgKyBjdXJyZW50T3B0aW9ucy5pY29ucG9zICkuYWRkQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgb3B0aW9ucy5pY29ucG9zICk7CgkJfSBlbHNlIGlmICggIWhhc0ljb24gKSB7CgkJCWxhYmVsLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArIGN1cnJlbnRPcHRpb25zLmljb25wb3MgKTsKCQl9CgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5idXR0b24iLCB7CgoJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0nYnV0dG9uJ10sIGlucHV0W3R5cGU9J3N1Ym1pdCddLCBpbnB1dFt0eXBlPSdyZXNldCddIiwKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJaWNvbjogbnVsbCwKCQlpY29ucG9zOiAibGVmdCIsCgkJaWNvbnNoYWRvdzogZmFsc2UsIC8qIFRPRE86IERlcHJlY2F0ZWQgaW4gMS40LCByZW1vdmUgaW4gMS41LiAqLwoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWlubGluZTogbnVsbCwKCQltaW5pOiBudWxsLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCWlmICggdGhpcy5lbGVtZW50LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCX0KCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQl3cmFwcGVyOiB0aGlzLmVsZW1lbnQucGFyZW50KCkKCQl9KTsKCgkJdGhpcy5fb24oIHsKCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy53aWRnZXQoKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9LAoKCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLndpZGdldCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCB0cnVlICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fYnV0dG9uKCkgKTsKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWljb25DbGFzc2VzID0gdGhpcy5fZ2V0SWNvbkNsYXNzZXMoIHRoaXMub3B0aW9ucyApOwoKCQlyZXR1cm4gJCgiPGRpdiBjbGFzcz0ndWktYnRuIHVpLWlucHV0LWJ0biIgKwoJCQkoIG9wdGlvbnMud3JhcHBlckNsYXNzID8gIiAiICsgb3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsKCQkJKCBvcHRpb25zLnRoZW1lID8gIiB1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJKCBvcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKSArCgkJCSggb3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIiApICsKCQkJKCBvcHRpb25zLmlubGluZSA/ICIgdWktYnRuLWlubGluZSIgOiAiIiApICsKCQkJKCBvcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiIDogIiIgKSArCgkJCSggb3B0aW9ucy5kaXNhYmxlZCA/ICIgdWktc3RhdGUtZGlzYWJsZWQiIDogIiIgKSArCgkJCSggaWNvbkNsYXNzZXMgPyAoICIgIiArIGljb25DbGFzc2VzICkgOiAiIiApICsKCQkJIicgPiIgKyB0aGlzLmVsZW1lbnQudmFsKCkgKyAiPC9kaXY+IiApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLndyYXBwZXI7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50Lmluc2VydEJlZm9yZSggdGhpcy53cmFwcGVyICk7CgkJCXRoaXMud3JhcHBlci5yZW1vdmUoKTsKCX0sCgoJX2dldEljb25DbGFzc2VzOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQlyZXR1cm4gKCBvcHRpb25zLmljb24gPyAoICJ1aS1pY29uLSIgKyBvcHRpb25zLmljb24gKwoJCQkoIG9wdGlvbnMuaWNvbnNoYWRvdyA/ICIgdWktc2hhZG93LWljb24iIDogIiIgKSArIC8qIFRPRE86IERlcHJlY2F0ZWQgaW4gMS40LCByZW1vdmUgaW4gMS41LiAqLwoJCQkiIHVpLWJ0bi1pY29uLSIgKyBvcHRpb25zLmljb25wb3MgKSA6ICIiICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgb3V0ZXIgPSB0aGlzLndpZGdldCgpOwoKCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIKCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5vcHRpb25zLnRoZW1lICkKCQkJCS5hZGRDbGFzcyggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgkJaWYgKCBvcHRpb25zLnNoYWRvdyAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLXNoYWRvdyIsIG9wdGlvbnMuc2hhZG93ICk7CgkJfQoJCWlmICggb3B0aW9ucy5pbmxpbmUgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1idG4taW5saW5lIiwgb3B0aW9ucy5pbmxpbmUgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0aW9ucy5taW5pICk7CgkJfQoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgb3B0aW9ucy5kaXNhYmxlZCApOwoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiwgb3B0aW9ucy5kaXNhYmxlZCApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmljb24gIT09IHVuZGVmaW5lZCB8fAoJCQkJb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgfHwgLyogVE9ETzogRGVwcmVjYXRlZCBpbiAxLjQsIHJlbW92ZSBpbiAxLjUuICovCgkJCQlvcHRpb25zLmljb25wb3MgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIKCQkJCS5yZW1vdmVDbGFzcyggdGhpcy5fZ2V0SWNvbkNsYXNzZXMoIHRoaXMub3B0aW9ucyApICkKCQkJCS5hZGRDbGFzcyggdGhpcy5fZ2V0SWNvbkNsYXNzZXMoCgkJCQkJJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMgKSApICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBvcmlnaW5hbEVsZW1lbnQsCgkJCWlzRGlzYWJsZWQgPSB0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5pY29uICYmIHRoaXMub3B0aW9ucy5pY29ucG9zID09PSAibm90ZXh0IiAmJiB0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiApICkgewoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInRpdGxlIiwgdGhpcy5lbGVtZW50LnZhbCgpICk7CgkJfQoJCWlmICggIWNyZWF0ZSApIHsKCQkJb3JpZ2luYWxFbGVtZW50ID0gdGhpcy5lbGVtZW50LmRldGFjaCgpOwoJCQkkKCB0aGlzLndyYXBwZXIgKS50ZXh0KCB0aGlzLmVsZW1lbnQudmFsKCkgKS5hcHBlbmQoIG9yaWdpbmFsRWxlbWVudCApOwoJCX0KCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCAhPT0gaXNEaXNhYmxlZCApIHsKCQkJdGhpcy5fc2V0T3B0aW9ucyh7IGRpc2FibGVkOiBpc0Rpc2FibGVkIH0pOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQgKSB7Cgl2YXIJbWV0YSA9ICQoICJtZXRhW25hbWU9dmlld3BvcnRdIiApLAoJCWluaXRpYWxDb250ZW50ID0gbWV0YS5hdHRyKCAiY29udGVudCIgKSwKCQlkaXNhYmxlZFpvb20gPSBpbml0aWFsQ29udGVudCArICIsbWF4aW11bS1zY2FsZT0xLCB1c2VyLXNjYWxhYmxlPW5vIiwKCQllbmFibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEwLCB1c2VyLXNjYWxhYmxlPXllcyIsCgkJZGlzYWJsZWRJbml0aWFsbHkgPSAvKHVzZXItc2NhbGFibGVbXHNdKj1bXHNdKm5vKXwobWF4aW11bS1zY2FsZVtcc10qPVtcc10qMSlbJCxcc10vLnRlc3QoIGluaXRpYWxDb250ZW50ICk7CgoJJC5tb2JpbGUuem9vbSA9ICQuZXh0ZW5kKCB7fSwgewoJCWVuYWJsZWQ6ICFkaXNhYmxlZEluaXRpYWxseSwKCQlsb2NrZWQ6IGZhbHNlLAoJCWRpc2FibGU6IGZ1bmN0aW9uKCBsb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAhJC5tb2JpbGUuem9vbS5sb2NrZWQgKSB7CgkJCQltZXRhLmF0dHIoICJjb250ZW50IiwgZGlzYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSBmYWxzZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gbG9jayB8fCBmYWxzZTsKCQkJfQoJCX0sCgkJZW5hYmxlOiBmdW5jdGlvbiggdW5sb2NrICkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSAmJiAoICEkLm1vYmlsZS56b29tLmxvY2tlZCB8fCB1bmxvY2sgPT09IHRydWUgKSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBlbmFibGVkWm9vbSApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJCSQubW9iaWxlLnpvb20ubG9ja2VkID0gZmFsc2U7CgkJCX0KCQl9LAoJCXJlc3RvcmU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICFkaXNhYmxlZEluaXRpYWxseSApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBpbml0aWFsQ29udGVudCApOwoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCX0pOwoKfSggalF1ZXJ5ICkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCB7Cglpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSd0ZXh0J10sIiArCgkJImlucHV0W3R5cGU9J3NlYXJjaCddLCIgKwoJCSI6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSwiICsKCQkiaW5wdXRbdHlwZT0nbnVtYmVyJ10sIiArCgkJIjpqcW1EYXRhKHR5cGU9J251bWJlcicpLCIgKwoJCSJpbnB1dFt0eXBlPSdwYXNzd29yZCddLCIgKwoJCSJpbnB1dFt0eXBlPSdlbWFpbCddLCIgKwoJCSJpbnB1dFt0eXBlPSd1cmwnXSwiICsKCQkiaW5wdXRbdHlwZT0ndGVsJ10sIiArCgkJInRleHRhcmVhLCIgKwoJCSJpbnB1dFt0eXBlPSd0aW1lJ10sIiArCgkJImlucHV0W3R5cGU9J2RhdGUnXSwiICsKCQkiaW5wdXRbdHlwZT0nbW9udGgnXSwiICsKCQkiaW5wdXRbdHlwZT0nd2VlayddLCIgKwoJCSJpbnB1dFt0eXBlPSdkYXRldGltZSddLCIgKwoJCSJpbnB1dFt0eXBlPSdkYXRldGltZS1sb2NhbCddLCIgKwoJCSJpbnB1dFt0eXBlPSdjb2xvciddLCIgKwoJCSJpbnB1dDpub3QoW3R5cGVdKSwiICsKCQkiaW5wdXRbdHlwZT0nZmlsZSddIiwKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQltaW5pOiBmYWxzZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCXdyYXBwZXJDbGFzczogIiIsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJaXNTZWFyY2ggPSB0aGlzLmVsZW1lbnQuaXMoICJbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApLAoJCQlpc1RleHRhcmVhID0gdGhpcy5lbGVtZW50WyAwIF0udGFnTmFtZSA9PT0gIlRFWFRBUkVBIiwKCQkJaXNSYW5nZSA9IHRoaXMuZWxlbWVudC5pcyggIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAidHlwZT0ncmFuZ2UnXSIgKSwKCQkJaW5wdXROZWVkc1dyYXAgPSAoICh0aGlzLmVsZW1lbnQuaXMoICJpbnB1dCIgKSB8fAoJCQkJdGhpcy5lbGVtZW50LmlzKCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJ0eXBlPSdzZWFyY2gnXSIgKSApICYmCgkJCQkJIWlzUmFuZ2UgKTsKCgkJaWYgKCB0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiApICkgewoJCQlvcHRpb25zLmRpc2FibGVkID0gdHJ1ZTsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWNsYXNzZXM6IHRoaXMuX2NsYXNzZXNGcm9tT3B0aW9ucygpLAoJCQlpc1NlYXJjaDogaXNTZWFyY2gsCgkJCWlzVGV4dGFyZWE6IGlzVGV4dGFyZWEsCgkJCWlzUmFuZ2U6IGlzUmFuZ2UsCgkJCWlucHV0TmVlZHNXcmFwOiBpbnB1dE5lZWRzV3JhcAoJCX0pOwoKCQl0aGlzLl9hdXRvQ29ycmVjdCgpOwoKCQlpZiAoICFvcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggewoJCQkiZm9jdXMiOiAiX2hhbmRsZUZvY3VzIiwKCQkJImJsdXIiOiAiX2hhbmRsZUJsdXIiCgkJfSk7CgoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldE9wdGlvbnMoewoJCQkiZGlzYWJsZWQiIDogdGhpcy5lbGVtZW50LmlzKCAiOmRpc2FibGVkIiApCgkJfSk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbWVudENsYXNzZXMgPSBbXTsKCgkJaWYgKCB0aGlzLmlzVGV4dGFyZWEgKSB7CgkJCWVsZW1lbnRDbGFzc2VzLnB1c2goICJ1aS1pbnB1dC10ZXh0IiApOwoJCX0KCgkJaWYgKCB0aGlzLmlzVGV4dGFyZWEgfHwgdGhpcy5pc1JhbmdlICkgewoJCQllbGVtZW50Q2xhc3Nlcy5wdXNoKCAidWktc2hhZG93LWluc2V0IiApOwoJCX0KCgkJLy8ic2VhcmNoIiBhbmQgInRleHQiIGlucHV0IHdpZGdldHMKCQlpZiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCXRoaXMuZWxlbWVudC53cmFwKCB0aGlzLl93cmFwKCkgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50Q2xhc3NlcyA9IGVsZW1lbnRDbGFzc2VzLmNvbmNhdCggdGhpcy5jbGFzc2VzICk7CgkJfQoKCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIGVsZW1lbnRDbGFzc2VzLmpvaW4oICIgIiApICk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggdGhpcy5pbnB1dE5lZWRzV3JhcCApID8gdGhpcy5lbGVtZW50LnBhcmVudCgpIDogdGhpcy5lbGVtZW50OwoJfSwKCglfY2xhc3Nlc0Zyb21PcHRpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJY2xhc3NlcyA9IFtdOwoKCQljbGFzc2VzLnB1c2goICJ1aS1ib2R5LSIgKyAoICggb3B0aW9ucy50aGVtZSA9PT0gbnVsbCApID8gImluaGVyaXQiIDogb3B0aW9ucy50aGVtZSApICk7CgkJaWYgKCBvcHRpb25zLmNvcm5lcnMgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLWNvcm5lci1hbGwiICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICkgewoJCQljbGFzc2VzLnB1c2goICJ1aS1taW5pIiApOwoJCX0KCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJCX0KCQlpZiAoIG9wdGlvbnMud3JhcHBlckNsYXNzICkgewoJCQljbGFzc2VzLnB1c2goIG9wdGlvbnMud3JhcHBlckNsYXNzICk7CgkJfQoKCQlyZXR1cm4gY2xhc3NlczsKCX0sCgoJX3dyYXA6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdiBjbGFzcz0nIiArCgkJCSggdGhpcy5pc1NlYXJjaCA/ICJ1aS1pbnB1dC1zZWFyY2ggIiA6ICJ1aS1pbnB1dC10ZXh0ICIgKSArCgkJCXRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSArICIgIiArCgkJCSJ1aS1zaGFkb3ctaW5zZXQnPjwvZGl2PiIgKTsKCX0sCgoJX2F1dG9Db3JyZWN0OiBmdW5jdGlvbigpIHsKCQkvLyBYWFg6IFRlbXBvcmFyeSB3b3JrYXJvdW5kIGZvciBpc3N1ZSA3ODUgKEFwcGxlIGJ1ZyA4OTEwNTg5KS4KCQkvLyAgICAgIFR1cm4gb2ZmIGF1dG9jb3JyZWN0IGFuZCBhdXRvY29tcGxldGUgb24gbm9uLWlPUyA1IGRldmljZXMKCQkvLyAgICAgIHNpbmNlIHRoZSBwb3B1cCB0aGV5IHVzZSBjYW4ndCBiZSBkaXNtaXNzZWQgYnkgdGhlIHVzZXIuIE5vdGUKCQkvLyAgICAgIHRoYXQgd2UgdGVzdCBmb3IgdGhlIHByZXNlbmNlIG9mIHRoZSBmZWF0dXJlIGJ5IGxvb2tpbmcgZm9yCgkJLy8gICAgICB0aGUgYXV0b2NvcnJlY3QgcHJvcGVydHkgb24gdGhlIGlucHV0IGVsZW1lbnQuIFdlIGN1cnJlbnRseQoJCS8vICAgICAgaGF2ZSBubyB0ZXN0IGZvciBpT1MgNSBvciBuZXdlciBzbyB3ZSdyZSB0ZW1wb3JhcmlseSB1c2luZwoJCS8vICAgICAgdGhlIHRvdWNoT3ZlcmZsb3cgc3VwcG9ydCBmbGFnIGZvciBqUU0gMS4wLiBZZXMsIEkgZmVlbCBkaXJ0eS4KCQkvLyAgICAgIC0gamJsYXMKCQlpZiAoIHR5cGVvZiB0aGlzLmVsZW1lbnRbMF0uYXV0b2NvcnJlY3QgIT09ICJ1bmRlZmluZWQiICYmCgkJCSEkLnN1cHBvcnQudG91Y2hPdmVyZmxvdyApIHsKCgkJCS8vIFNldCB0aGUgYXR0cmlidXRlIGluc3RlYWQgb2YgdGhlIHByb3BlcnR5IGp1c3QgaW4gY2FzZSB0aGVyZQoJCQkvLyBpcyBjb2RlIHRoYXQgYXR0ZW1wdHMgdG8gbWFrZSBtb2RpZmljYXRpb25zIHZpYSBIVE1MLgoJCQl0aGlzLmVsZW1lbnRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvcnJlY3QiLCAib2ZmIiApOwoJCQl0aGlzLmVsZW1lbnRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvbXBsZXRlIiwgIm9mZiIgKTsKCQl9Cgl9LAoKCV9oYW5kbGVCbHVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLndpZGdldCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVGb2N1czogZnVuY3Rpb24oKSB7CgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIGlucHV0IHVwb24gdGFwLCB0aGlzCgkJLy8gcHJldmVudHMgdGhhdCBmcm9tIGhhcHBlbmluZwoJCWlmICggdGhpcy5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCX0KCQl0aGlzLndpZGdldCgpLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiAoIG9wdGlvbnMgKSB7CgkJdmFyIG91dGVyID0gdGhpcy53aWRnZXQoKTsKCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJaWYgKCAhKCBvcHRpb25zLmRpc2FibGVkID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy5taW5pID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy5jb3JuZXJzID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy50aGVtZSA9PT0gdW5kZWZpbmVkICYmCgkJCW9wdGlvbnMud3JhcHBlckNsYXNzID09PSB1bmRlZmluZWQgKSApIHsKCgkJCW91dGVyLnJlbW92ZUNsYXNzKCB0aGlzLmNsYXNzZXMuam9pbiggIiAiICkgKTsKCQkJdGhpcy5jbGFzc2VzID0gdGhpcy5fY2xhc3Nlc0Zyb21PcHRpb25zKCk7CgkJCW91dGVyLmFkZENsYXNzKCB0aGlzLmNsYXNzZXMuam9pbiggIiAiICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLmlucHV0TmVlZHNXcmFwICkgewoJCQl0aGlzLmVsZW1lbnQudW53cmFwKCk7CgkJfQoJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWlucHV0LXRleHQgIiArIHRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2xpZGVyIiwgJC5leHRlbmQoIHsKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3JhbmdlJ10sIDpqcW1EYXRhKHR5cGU9J3JhbmdlJyksIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpIiwKCgl3aWRnZXRFdmVudFByZWZpeDogInNsaWRlIiwKCglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJdHJhY2tUaGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCWhpZ2hsaWdodDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCS8vIFRPRE86IEVhY2ggb2YgdGhlc2Ugc2hvdWxkIGhhdmUgY29tbWVudHMgZXhwbGFpbiB3aGF0IHRoZXkncmUgZm9yCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBjb250cm9sWyAwIF0sICJ0aGVtZSIgKSwKCQkJdHJhY2tUaGVtZUNsYXNzID0gdHJhY2tUaGVtZSA/ICIgdWktYmFyLSIgKyB0cmFja1RoZW1lIDogIiB1aS1iYXItaW5oZXJpdCIsCgkJCWNvcm5lckNsYXNzID0gKCB0aGlzLm9wdGlvbnMuY29ybmVycyB8fCBjb250cm9sLmpxbURhdGEoICJjb3JuZXJzIiApICkgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIsCgkJCW1pbmlDbGFzcyA9ICggdGhpcy5vcHRpb25zLm1pbmkgfHwgY29udHJvbC5qcW1EYXRhKCAibWluaSIgKSApID8gIiB1aS1taW5pIiA6ICIiLAoJCQljVHlwZSA9IGNvbnRyb2xbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQlpc1RvZ2dsZVN3aXRjaCA9ICggY1R5cGUgPT09ICJzZWxlY3QiICksCgkJCWlzUmFuZ2VzbGlkZXIgPSBjb250cm9sLnBhcmVudCgpLmlzKCAiOmpxbURhdGEocm9sZT0ncmFuZ2VzbGlkZXInKSIgKSwKCQkJc2VsZWN0Q2xhc3MgPSAoIGlzVG9nZ2xlU3dpdGNoICkgPyAidWktc2xpZGVyLXN3aXRjaCIgOiAiIiwKCQkJY29udHJvbElEID0gY29udHJvbC5hdHRyKCAiaWQiICksCgkJCSRsYWJlbCA9ICQoICJbZm9yPSciICsgY29udHJvbElEICsgIiddIiApLAoJCQlsYWJlbElEID0gJGxhYmVsLmF0dHIoICJpZCIgKSB8fCBjb250cm9sSUQgKyAiLWxhYmVsIiwKCQkJbWluID0gIWlzVG9nZ2xlU3dpdGNoID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSAgIWlzVG9nZ2xlU3dpdGNoID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkubGVuZ3RoLTEsCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgkJCWRvbUhhbmRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApLAoJCQloYW5kbGUgPSAkKCBkb21IYW5kbGUgKSwKCQkJZG9tU2xpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQkJc2xpZGVyID0gJCggZG9tU2xpZGVyICksCgkJCXZhbHVlYmcgPSB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICFpc1RvZ2dsZVN3aXRjaCA/IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQliZy5jbGFzc05hbWUgPSAidWktc2xpZGVyLWJnICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0pKCkgOiBmYWxzZSwKCQkJb3B0aW9ucywKCQkJd3JhcHBlciwKCQkJaiwgbGVuZ3RoLAoJCQlpLCBvcHRpb25zQ291bnQsIG9yaWdUYWJJbmRleCwKCQkJc2lkZSwgYWN0aXZlQ2xhc3MsIHNsaWRlckltZzsKCgkJJGxhYmVsLmF0dHIoICJpZCIsIGxhYmVsSUQgKTsKCQl0aGlzLmlzVG9nZ2xlU3dpdGNoID0gaXNUb2dnbGVTd2l0Y2g7CgoJCWRvbUhhbmRsZS5zZXRBdHRyaWJ1dGUoICJocmVmIiwgIiMiICk7CgkJZG9tU2xpZGVyLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiYXBwbGljYXRpb24iICk7CgkJZG9tU2xpZGVyLmNsYXNzTmFtZSA9IFsgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXIgdWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCAiIDogInVpLXNsaWRlci10cmFjayB1aS1zaGFkb3ctaW5zZXQgIiwgc2VsZWN0Q2xhc3MsIHRyYWNrVGhlbWVDbGFzcywgY29ybmVyQ2xhc3MsIG1pbmlDbGFzcyBdLmpvaW4oICIiICk7CgkJZG9tSGFuZGxlLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItaGFuZGxlIjsKCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIGRvbUhhbmRsZSApOwoKCQloYW5kbGUuYXR0cih7CgkJCSJyb2xlIjogInNsaWRlciIsCgkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkiYXJpYS12YWx1ZW1heCI6IG1heCwKCQkJImFyaWEtdmFsdWVub3ciOiB0aGlzLl92YWx1ZSgpLAoJCQkiYXJpYS12YWx1ZXRleHQiOiB0aGlzLl92YWx1ZSgpLAoJCQkidGl0bGUiOiB0aGlzLl92YWx1ZSgpLAoJCQkiYXJpYS1sYWJlbGxlZGJ5IjogbGFiZWxJRAoJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCWNvbnRyb2w6IGNvbnRyb2wsCgkJCXR5cGU6IGNUeXBlLAoJCQlzdGVwOiBzdGVwLAoJCQltYXg6IG1heCwKCQkJbWluOiBtaW4sCgkJCXZhbHVlYmc6IHZhbHVlYmcsCgkJCWlzUmFuZ2VzbGlkZXI6IGlzUmFuZ2VzbGlkZXIsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCS8vIFRPRE86IHJlc3RvcmUgb3JpZ2luYWwgdGFiaW5kZXggKGlmIGFueSkgaW4gYSBkZXN0cm95IG1ldGhvZAoJCQlvcmlnVGFiSW5kZXggPSBjb250cm9sLmF0dHIoICJ0YWJpbmRleCIgKTsKCQkJaWYgKCBvcmlnVGFiSW5kZXggKSB7CgkJCQloYW5kbGUuYXR0ciggInRhYmluZGV4Iiwgb3JpZ1RhYkluZGV4ICk7CgkJCX0KCQkJY29udHJvbC5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkuZm9jdXMoZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmx1cigpOwoJCQkJaGFuZGxlLmZvY3VzKCk7CgkJCX0pOwoKCQkJd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCXdyYXBwZXIuY2xhc3NOYW1lID0gInVpLXNsaWRlci1pbm5lcm9mZnNldCI7CgoJCQlmb3IgKCBqID0gMCwgbGVuZ3RoID0gZG9tU2xpZGVyLmNoaWxkTm9kZXMubGVuZ3RoOyBqIDwgbGVuZ3RoOyBqKysgKSB7CgkJCQl3cmFwcGVyLmFwcGVuZENoaWxkKCBkb21TbGlkZXIuY2hpbGROb2Rlc1tqXSApOwoJCQl9CgoJCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIHdyYXBwZXIgKTsKCgkJCS8vIHNsaWRlci53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXItaW5uZXJvZmZzZXQnPjwvZGl2PiIgKTsKCgkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQloYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJb3B0aW9ucyA9IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCgkJCWZvciAoIGkgPSAwLCBvcHRpb25zQ291bnQgPSBvcHRpb25zLmxlbmd0aDsgaSA8IG9wdGlvbnNDb3VudDsgaSsrICkgewoJCQkJc2lkZSA9ICFpID8gImIiIDogImEiOwoJCQkJYWN0aXZlQ2xhc3MgPSAhaSA/ICIiIDogIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3M7CgkJCQlzbGlkZXJJbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKTsKCgkJCQlzbGlkZXJJbWcuY2xhc3NOYW1lID0gWyAidWktc2xpZGVyLWxhYmVsIHVpLXNsaWRlci1sYWJlbC0iLCBzaWRlLCBhY3RpdmVDbGFzcyBdLmpvaW4oICIiICk7CgkJCQlzbGlkZXJJbWcuc2V0QXR0cmlidXRlKCAicm9sZSIsICJpbWciICk7CgkJCQlzbGlkZXJJbWcuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRpb25zW2ldLmlubmVySFRNTCApICk7CgkJCQkkKCBzbGlkZXJJbWcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9CgoJCQlzZWxmLl9sYWJlbHMgPSAkKCAiLnVpLXNsaWRlci1sYWJlbCIsIHNsaWRlciApOwoKCQl9CgoJCS8vIG1vbml0b3IgdGhlIGlucHV0IGZvciB1cGRhdGVkIHZhbHVlcwoJCWNvbnRyb2wuYWRkQ2xhc3MoIGlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlci1zd2l0Y2giIDogInVpLXNsaWRlci1pbnB1dCIgKTsKCgkJdGhpcy5fb24oIGNvbnRyb2wsIHsKCQkJImNoYW5nZSI6ICJfY29udHJvbENoYW5nZSIsCgkJCSJrZXl1cCI6ICJfY29udHJvbEtleXVwIiwKCQkJImJsdXIiOiAiX2NvbnRyb2xCbHVyIiwKCQkJInZtb3VzZXVwIjogIl9jb250cm9sVk1vdXNlVXAiCgkJfSk7CgoJCXNsaWRlci5iaW5kKCAidm1vdXNlZG93biIsICQucHJveHkoIHRoaXMuX3NsaWRlclZNb3VzZURvd24sIHRoaXMgKSApCgkJCS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJLy8gV2UgaGF2ZSB0byBpbnN0YW50aWF0ZSBhIG5ldyBmdW5jdGlvbiBvYmplY3QgZm9yIHRoZSB1bmJpbmQgdG8gd29yayBwcm9wZXJseQoJCS8vIHNpbmNlIHRoZSBtZXRob2QgaXRzZWxmIGlzIGRlZmluZWQgaW4gdGhlIHByb3RvdHlwZSAoY2F1c2luZyBpdCB0byB1bmJpbmQgZXZlcnl0aGluZykKCQl0aGlzLl9vbiggZG9jdW1lbnQsIHsgInZtb3VzZW1vdmUiOiAiX3ByZXZlbnREb2N1bWVudERyYWciIH0pOwoJCXRoaXMuX29uKCBzbGlkZXIuYWRkKCBkb2N1bWVudCApLCB7ICJ2bW91c2V1cCI6ICJfc2xpZGVyVk1vdXNlVXAiIH0pOwoKCQlzbGlkZXIuaW5zZXJ0QWZ0ZXIoIGNvbnRyb2wgKTsKCgkJLy8gd3JhcCBpbiBhIGRpdiBmb3Igc3R5bGluZyBwdXJwb3NlcwoJCWlmICggIWlzVG9nZ2xlU3dpdGNoICYmICFpc1Jhbmdlc2xpZGVyICkgewoJCQl3cmFwcGVyID0gdGhpcy5vcHRpb25zLm1pbmkgPyAiPGRpdiBjbGFzcz0ndWktc2xpZGVyIHVpLW1pbmknPiIgOiAiPGRpdiBjbGFzcz0ndWktc2xpZGVyJz4iOwoKCQkJY29udHJvbC5hZGQoIHNsaWRlciApLndyYXBBbGwoIHdyYXBwZXIgKTsKCQl9CgoJCS8vIGJpbmQgdGhlIGhhbmRsZSBldmVudCBjYWxsYmFja3MgYW5kIHNldCB0aGUgY29udGV4dCB0byB0aGUgd2lkZ2V0IGluc3RhbmNlCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7CgkJCSJ2bW91c2Vkb3duIjogIl9oYW5kbGVWTW91c2VEb3duIiwKCQkJImtleWRvd24iOiAiX2hhbmRsZUtleWRvd24iLAoJCQkia2V5dXAiOiAiX2hhbmRsZUtleXVwIgoJCX0pOwoKCQl0aGlzLmhhbmRsZS5iaW5kKCAidmNsaWNrIiwgZmFsc2UgKTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUaGVtZSggb3B0aW9ucy50aGVtZSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLnRyYWNrVGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0VHJhY2tUaGVtZSggb3B0aW9ucy50cmFja1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRDb3JuZXJzKCBvcHRpb25zLmNvcm5lcnMgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldE1pbmkoIG9wdGlvbnMubWluaSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmhpZ2hsaWdodCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRIaWdobGlnaHQoIG9wdGlvbnMuaGlnaGxpZ2h0ICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0RGlzYWJsZWQoIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2NvbnRyb2xDaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBpZiB0aGUgdXNlciBkcmFnZ2VkIHRoZSBoYW5kbGUsIHRoZSAiY2hhbmdlIiBldmVudCB3YXMgdHJpZ2dlcmVkIGZyb20gaW5zaWRlIHJlZnJlc2goKTsgZG9uJ3QgY2FsbCByZWZyZXNoKCkgYWdhaW4KCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJjb250cm9sY2hhbmdlIiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCAhdGhpcy5tb3VzZU1vdmVkICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUgKTsKCQl9Cgl9LAoKCV9jb250cm9sS2V5dXA6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7IC8vIG5lY2Vzc2FyeT8KCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUsIHRydWUgKTsKCX0sCgoJX2NvbnRyb2xCbHVyOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJfSwKCgkvLyBpdCBhcHBlYXJzIHRoZSBjbGlja2luZyB0aGUgdXAgYW5kIGRvd24gYnV0dG9ucyBpbiBjaHJvbWUgb24KCS8vIHJhbmdlL251bWJlciBpbnB1dHMgZG9lc24ndCB0cmlnZ2VyIGEgY2hhbmdlIHVudGlsIHRoZSBmaWVsZCBpcwoJLy8gYmx1cnJlZC4gSGVyZSB3ZSBjaGVjayB0aGlmIHRoZSB2YWx1ZSBoYXMgY2hhbmdlZCBhbmQgcmVmcmVzaAoJX2NvbnRyb2xWTW91c2VVcDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQl0aGlzLl9jaGVja2VkUmVmcmVzaCgpOwoJfSwKCgkvLyBOT1RFIGZvcmNlIGZvY3VzIG9uIGhhbmRsZQoJX2hhbmRsZVZNb3VzZURvd246IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJdGhpcy5oYW5kbGUuZm9jdXMoKTsKCX0sCgoJX2hhbmRsZUtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaW5kZXggPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJbiBhbGwgY2FzZXMgcHJldmVudCB0aGUgZGVmYXVsdCBhbmQgbWFyayB0aGUgaGFuZGxlIGFzIGFjdGl2ZQoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJaWYgKCAhdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJCQl0aGlzLl9rZXlTbGlkaW5nID0gdHJ1ZTsKCQkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsgLyogVE9ETzogV2UgZG9uJ3QgdXNlIHRoaXMgY2xhc3MgZm9yIHN0eWxpbmcuIERvIHdlIG5lZWQgdG8gYWRkIGl0PyAqLwoJCQkJfQoKCQkJCWJyZWFrOwoJCX0KCgkJLy8gbW92ZSB0aGUgc2xpZGVyIGFjY29yZGluZyB0byB0aGUga2V5cHJlc3MKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuSE9NRToKCQkJCXRoaXMucmVmcmVzaCggdGhpcy5taW4gKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1heCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggKyB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkxFRlQ6CgkJCQl0aGlzLnJlZnJlc2goIGluZGV4IC0gdGhpcy5zdGVwICk7CgkJCQlicmVhazsKCQl9Cgl9LCAvLyByZW1vdmUgYWN0aXZlIG1hcmsKCglfaGFuZGxlS2V5dXA6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJaWYgKCB0aGlzLl9rZXlTbGlkaW5nICkgewoJCQl0aGlzLl9rZXlTbGlkaW5nID0gZmFsc2U7CgkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOyAvKiBTZWUgY29tbWVudCBhYm92ZS4gKi8KCQl9Cgl9LAoKCV9zbGlkZXJWTW91c2VEb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgISggZXZlbnQud2hpY2ggPT09IDEgfHwgZXZlbnQud2hpY2ggPT09IDAgfHwgZXZlbnQud2hpY2ggPT09IHVuZGVmaW5lZCApICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZXN0YXJ0IiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJdGhpcy5kcmFnZ2luZyA9IHRydWU7CgkJdGhpcy51c2VyTW9kaWZpZWQgPSBmYWxzZTsKCQl0aGlzLm1vdXNlTW92ZWQgPSBmYWxzZTsKCgkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0ID0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJfQoKCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgkJdGhpcy5fdHJpZ2dlciggInN0YXJ0IiApOwoJCXJldHVybiBmYWxzZTsKCX0sCgoJX3NsaWRlclZNb3VzZVVwOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuZHJhZ2dpbmcgKSB7CgkJCXRoaXMuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJCWlmICggdGhpcy5tb3VzZU1vdmVkICkgewoJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCWlmICggdGhpcy51c2VyTW9kaWZpZWQgKSB7CgkJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ICk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzIGlzIGp1c3QgYSBjbGljaywgY2hhbmdlIHRoZSB2YWx1ZQoJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQl9CgkJCX0KCgkJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoJCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJX3ByZXZlbnREb2N1bWVudERyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJkcmFnIiwgZXZlbnQgKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlpZiAoIHRoaXMuZHJhZ2dpbmcgJiYgIXRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCgkJCQkvLyB0aGlzLm1vdXNlTW92ZWQgbXVzdCBiZSB1cGRhdGVkIGJlZm9yZSByZWZyZXNoKCkgYmVjYXVzZSBpdCB3aWxsIGJlIHVzZWQgaW4gdGhlIGNvbnRyb2wgImNoYW5nZSIgZXZlbnQKCQkJCXRoaXMubW91c2VNb3ZlZCA9IHRydWU7CgoJCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIGluIHN5bmMgd2l0aCB0aGUgbW91c2UKCQkJCQl0aGlzLmhhbmRsZS5yZW1vdmVDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgkJCQl9CgoJCQkJdGhpcy5yZWZyZXNoKCBldmVudCApOwoKCQkJCS8vIG9ubHkgYWZ0ZXIgcmVmcmVzaCgpIHlvdSBjYW4gY2FsY3VsYXRlIHRoaXMudXNlck1vZGlmaWVkCgkJCQl0aGlzLnVzZXJNb2RpZmllZCA9IHRoaXMuYmVmb3JlU3RhcnQgIT09IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCglfY2hlY2tlZFJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy52YWx1ZSAhPT0gdGhpcy5fdmFsdWUoKSApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpICk7CgkJfQoJfSwKCglfdmFsdWU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiAgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4IDogcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LnZhbCgpICkgOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCBmYWxzZSwgdHJ1ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggdmFsLCBpc2Zyb21Db250cm9sLCBwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJLy8gTk9URTogd2UgZG9uJ3QgcmV0dXJuIGhlcmUgYmVjYXVzZSB3ZSB3YW50IHRvIHN1cHBvcnQgcHJvZ3JhbW1hdGljCgkJLy8gICAgICAgYWx0ZXJhdGlvbiBvZiB0aGUgaW5wdXQgdmFsdWUsIHdoaWNoIHNob3VsZCBzdGlsbCB1cGRhdGUgdGhlIHNsaWRlcgoKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXBhcmVudFRoZW1lID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLmVsZW1lbnRbIDAgXSwgInRoZW1lIiApLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdGhlbWVDbGFzcyA9ICB0aGVtZSA/ICIgdWktYnRuLSIgKyB0aGVtZSA6ICIiLAoJCQl0cmFja1RoZW1lID0gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCXRyYWNrVGhlbWVDbGFzcyA9IHRyYWNrVGhlbWUgPyAiIHVpLWJhci0iICsgdHJhY2tUaGVtZSA6ICIgdWktYmFyLWluaGVyaXQiLAoJCQljb3JuZXJDbGFzcyA9IHRoaXMub3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiLAoJCQltaW5pQ2xhc3MgPSB0aGlzLm9wdGlvbnMubWluaSA/ICIgdWktbWluaSIgOiAiIiwKCQkJbGVmdCwgd2lkdGgsIGRhdGEsIHRvbCwKCQkJcHhTdGVwLCBwZXJjZW50LAoJCQljb250cm9sLCBpc0lucHV0LCBvcHRpb25FbGVtZW50cywgbWluLCBtYXgsIHN0ZXAsCgkJCW5ld3ZhbCwgdmFsTW9kU3RlcCwgYWxpZ25WYWx1ZSwgcGVyY2VudFBlclN0ZXAsCgkJCWhhbmRsZVBlcmNlbnQsIGFQZXJjZW50LCBiUGVyY2VudCwKCQkJdmFsdWVDaGFuZ2VkOwoKCQlzZWxmLnNsaWRlclswXS5jbGFzc05hbWUgPSBbIHRoaXMuaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyIHVpLXNsaWRlci1zd2l0Y2ggdWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCIgOiAidWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCIsIHRyYWNrVGhlbWVDbGFzcywgY29ybmVyQ2xhc3MsIG1pbmlDbGFzcyBdLmpvaW4oICIiICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBzZXQgdGhlIHN0b3JlZCB2YWx1ZSBmb3IgY29tcGFyaXNvbiBsYXRlcgoJCXRoaXMudmFsdWUgPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmhpZ2hsaWdodCAmJiAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiB0aGlzLnNsaWRlci5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5sZW5ndGggPT09IDAgKSB7CgkJCXRoaXMudmFsdWViZyA9IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQliZy5jbGFzc05hbWUgPSAidWktc2xpZGVyLWJnICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXJldHVybiAkKCBiZyApLnByZXBlbmRUbyggc2VsZi5zbGlkZXIgKTsKCQkJfSkoKTsKCQl9CgkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1idG4iICsgdGhlbWVDbGFzcyArICIgdWktc2hhZG93IiApOwoKCQljb250cm9sID0gdGhpcy5lbGVtZW50OwoJCWlzSW5wdXQgPSAhdGhpcy5pc1RvZ2dsZVN3aXRjaDsKCQlvcHRpb25FbGVtZW50cyA9IGlzSW5wdXQgPyBbXSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKTsKCQltaW4gPSAgaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wuYXR0ciggIm1pbiIgKSApIDogMDsKCQltYXggPSBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBvcHRpb25FbGVtZW50cy5sZW5ndGggLSAxOwoJCXN0ZXAgPSAoIGlzSW5wdXQgJiYgcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApID4gMCApID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApIDogMTsKCgkJaWYgKCB0eXBlb2YgdmFsID09PSAib2JqZWN0IiApIHsKCQkJZGF0YSA9IHZhbDsKCQkJLy8gYSBzbGlnaHQgdG9sZXJhbmNlIGhlbHBlZCBnZXQgdG8gdGhlIGVuZHMgb2YgdGhlIHNsaWRlcgoJCQl0b2wgPSA4OwoKCQkJbGVmdCA9IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQ7CgkJCXdpZHRoID0gdGhpcy5zbGlkZXIud2lkdGgoKTsKCQkJcHhTdGVwID0gd2lkdGgvKChtYXgtbWluKS9zdGVwKTsKCQkJaWYgKCAhdGhpcy5kcmFnZ2luZyB8fAoJCQkJCWRhdGEucGFnZVggPCBsZWZ0IC0gdG9sIHx8CgkJCQkJZGF0YS5wYWdlWCA+IGxlZnQgKyB3aWR0aCArIHRvbCApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIHB4U3RlcCA+IDEgKSB7CgkJCQlwZXJjZW50ID0gKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwOwoJCQl9IGVsc2UgewoJCQkJcGVyY2VudCA9IE1hdGgucm91bmQoICggKCBkYXRhLnBhZ2VYIC0gbGVmdCApIC8gd2lkdGggKSAqIDEwMCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9IGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLnZhbCgpIHx8IDAgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfQoJCQlwZXJjZW50ID0gKCBwYXJzZUZsb2F0KCB2YWwgKSAtIG1pbiApIC8gKCBtYXggLSBtaW4gKSAqIDEwMDsKCQl9CgoJCWlmICggaXNOYU4oIHBlcmNlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJbmV3dmFsID0gKCBwZXJjZW50IC8gMTAwICkgKiAoIG1heCAtIG1pbiApICsgbWluOwoKCQkvL2Zyb20galF1ZXJ5IFVJIHNsaWRlciwgdGhlIGZvbGxvd2luZyBzb3VyY2Ugd2lsbCByb3VuZCB0byB0aGUgbmVhcmVzdCBzdGVwCgkJdmFsTW9kU3RlcCA9ICggbmV3dmFsIC0gbWluICkgJSBzdGVwOwoJCWFsaWduVmFsdWUgPSBuZXd2YWwgLSB2YWxNb2RTdGVwOwoKCQlpZiAoIE1hdGguYWJzKCB2YWxNb2RTdGVwICkgKiAyID49IHN0ZXAgKSB7CgkJCWFsaWduVmFsdWUgKz0gKCB2YWxNb2RTdGVwID4gMCApID8gc3RlcCA6ICggLXN0ZXAgKTsKCQl9CgoJCXBlcmNlbnRQZXJTdGVwID0gMTAwLygobWF4LW1pbikvc3RlcCk7CgkJLy8gU2luY2UgSmF2YVNjcmlwdCBoYXMgcHJvYmxlbXMgd2l0aCBsYXJnZSBmbG9hdHMsIHJvdW5kCgkJLy8gdGhlIGZpbmFsIHZhbHVlIHRvIDUgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50IChzZWUgalF1ZXJ5VUk6ICM0MTI0KQoJCW5ld3ZhbCA9IHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCg1KSApOwoKCQlpZiAoIHR5cGVvZiBweFN0ZXAgPT09ICJ1bmRlZmluZWQiICkgewoJCQlweFN0ZXAgPSB3aWR0aCAvICggKG1heC1taW4pIC8gc3RlcCApOwoJCX0KCQlpZiAoIHB4U3RlcCA+IDEgJiYgaXNJbnB1dCApIHsKCQkJcGVyY2VudCA9ICggbmV3dmFsIC0gbWluICkgKiBwZXJjZW50UGVyU3RlcCAqICggMSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBwZXJjZW50IDwgMCApIHsKCQkJcGVyY2VudCA9IDA7CgkJfQoKCQlpZiAoIHBlcmNlbnQgPiAxMDAgKSB7CgkJCXBlcmNlbnQgPSAxMDA7CgkJfQoKCQlpZiAoIG5ld3ZhbCA8IG1pbiApIHsKCQkJbmV3dmFsID0gbWluOwoJCX0KCgkJaWYgKCBuZXd2YWwgPiBtYXggKSB7CgkJCW5ld3ZhbCA9IG1heDsKCQl9CgoJCXRoaXMuaGFuZGxlLmNzcyggImxlZnQiLCBwZXJjZW50ICsgIiUiICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWVub3ciLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmF0dHIoICJ2YWx1ZSIgKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJhcmlhLXZhbHVldGV4dCIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJ0aXRsZSIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuZ2V0RW5jb2RlZFRleHQoKSApOwoKCQlpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLmNzcyggIndpZHRoIiwgcGVyY2VudCArICIlIiApOwoJCX0KCgkJLy8gZHJhZyB0aGUgbGFiZWwgd2lkdGhzCgkJaWYgKCB0aGlzLl9sYWJlbHMgKSB7CgkJCWhhbmRsZVBlcmNlbnQgPSB0aGlzLmhhbmRsZS53aWR0aCgpIC8gdGhpcy5zbGlkZXIud2lkdGgoKSAqIDEwMDsKCQkJYVBlcmNlbnQgPSBwZXJjZW50ICYmIGhhbmRsZVBlcmNlbnQgKyAoIDEwMCAtIGhhbmRsZVBlcmNlbnQgKSAqIHBlcmNlbnQgLyAxMDA7CgkJCWJQZXJjZW50ID0gcGVyY2VudCA9PT0gMTAwID8gMCA6IE1hdGgubWluKCBoYW5kbGVQZXJjZW50ICsgMTAwIC0gYVBlcmNlbnQsIDEwMCApOwoKCQkJdGhpcy5fbGFiZWxzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgYWIgPSAkKCB0aGlzICkuaGFzQ2xhc3MoICJ1aS1zbGlkZXItbGFiZWwtYSIgKTsKCQkJCSQoIHRoaXMgKS53aWR0aCggKCBhYiA/IGFQZXJjZW50IDogYlBlcmNlbnQgICkgKyAiJSIgKTsKCQkJfSk7CgkJfQoKCQlpZiAoICFwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJCXZhbHVlQ2hhbmdlZCA9IGZhbHNlOwoKCQkJLy8gdXBkYXRlIGNvbnRyb2wicyB2YWx1ZQoJCQlpZiAoIGlzSW5wdXQgKSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sLnZhbCgpICE9PSBuZXd2YWw7CgkJCQljb250cm9sLnZhbCggbmV3dmFsICk7CgkJCX0gZWxzZSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCAhPT0gbmV3dmFsOwoJCQkJY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggPSBuZXd2YWw7CgkJCX0KCQkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY2hhbmdlIiwgdmFsICkgPT09IGZhbHNlKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggIWlzZnJvbUNvbnRyb2wgJiYgdmFsdWVDaGFuZ2VkICkgewoJCQkJY29udHJvbC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCglfc2V0SGlnaGxpZ2h0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFsdWUgPSAhIXZhbHVlOwoJCWlmICggdmFsdWUgKSB7CgkJCXRoaXMub3B0aW9ucy5oaWdobGlnaHQgPSAhIXZhbHVlOwoJCQl0aGlzLnJlZnJlc2goKTsKCQl9IGVsc2UgaWYgKCB0aGlzLnZhbHVlYmcgKSB7CgkJCXRoaXMudmFsdWViZy5yZW1vdmUoKTsKCQkJdGhpcy52YWx1ZWJnID0gZmFsc2U7CgkJfQoJfSwKCglfc2V0VGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmhhbmRsZQoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1idG4tIiArIHRoaXMub3B0aW9ucy50aGVtZSApCgkJCS5hZGRDbGFzcyggInVpLWJ0bi0iICsgdmFsdWUgKTsKCgkJdmFyIGN1cnJlbnRUaGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSA/IHRoaXMub3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiwKCQkJbmV3VGhlbWUgPSB2YWx1ZSA/IHZhbHVlIDogImluaGVyaXQiOwoKCQl0aGlzLmNvbnRyb2wKCQkJLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgY3VycmVudFRoZW1lICkKCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgbmV3VGhlbWUgKTsKCX0sCgoJX3NldFRyYWNrVGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YXIgY3VycmVudFRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSA/IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIDogImluaGVyaXQiLAoJCQluZXdUcmFja1RoZW1lID0gdmFsdWUgPyB2YWx1ZSA6ICJpbmhlcml0IjsKCgkJdGhpcy5zbGlkZXIKCQkJLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgY3VycmVudFRyYWNrVGhlbWUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBuZXdUcmFja1RoZW1lICk7Cgl9LAoKCV9zZXRNaW5pOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFsdWUgPSAhIXZhbHVlOwoJCWlmICggIXRoaXMuaXNUb2dnbGVTd2l0Y2ggJiYgIXRoaXMuaXNSYW5nZXNsaWRlciApIHsKCQkJdGhpcy5zbGlkZXIucGFyZW50KCkudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIHZhbHVlICk7CgkJfQoJCXRoaXMuc2xpZGVyLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIHZhbHVlICk7Cgl9LAoKCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdGhpcy5zbGlkZXIudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCgkJaWYgKCAhdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJdGhpcy5jb250cm9sLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIHZhbHVlICk7CgkJfQoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJdGhpcy5zbGlkZXIKCQkJLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCB2YWx1ZSApCgkJCS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgoJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiwgdmFsdWUgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcG9wdXA7CgpmdW5jdGlvbiBnZXRQb3B1cCgpIHsKCWlmICggIXBvcHVwICkgewoJCXBvcHVwID0gJCggIjxkaXY+PC9kaXY+IiwgewoJCQkiY2xhc3MiOiAidWktc2xpZGVyLXBvcHVwIHVpLXNoYWRvdyB1aS1jb3JuZXItYWxsIgoJCX0pOwoJfQoJcmV0dXJuIHBvcHVwLmNsb25lKCk7Cn0KCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLnNsaWRlciwgewoJb3B0aW9uczogewoJCXBvcHVwRW5hYmxlZDogZmFsc2UsCgkJc2hvd1ZhbHVlOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY3VycmVudFZhbHVlOiBudWxsLAoJCQlfcG9wdXA6IG51bGwsCgkJCV9wb3B1cFZpc2libGU6IGZhbHNlCgkJfSk7CgoJCXRoaXMuX3NldE9wdGlvbiggInBvcHVwRW5hYmxlZCIsIHRoaXMub3B0aW9ucy5wb3B1cEVuYWJsZWQgKTsKCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7ICJ2bW91c2Vkb3duIiA6ICJfc2hvd1BvcHVwIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMuc2xpZGVyLmFkZCggdGhpcy5kb2N1bWVudCApLCB7ICJ2bW91c2V1cCIgOiAiX2hpZGVQb3B1cCIgfSApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJLy8gcG9zaXRpb24gdGhlIHBvcHVwIGNlbnRlcmVkIDVweCBhYm92ZSB0aGUgaGFuZGxlCglfcG9zaXRpb25Qb3B1cDogZnVuY3Rpb24oKSB7CgkJdmFyIGRzdE9mZnNldCA9IHRoaXMuaGFuZGxlLm9mZnNldCgpOwoKCQl0aGlzLl9wb3B1cC5vZmZzZXQoIHsKCQkJbGVmdDogZHN0T2Zmc2V0LmxlZnQgKyAoIHRoaXMuaGFuZGxlLndpZHRoKCkgLSB0aGlzLl9wb3B1cC53aWR0aCgpICkgLyAyLAoJCQl0b3A6IGRzdE9mZnNldC50b3AgLSB0aGlzLl9wb3B1cC5vdXRlckhlaWdodCgpIC0gNQoJCX0pOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gInNob3dWYWx1ZSIgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoIHZhbHVlICYmICF0aGlzLm9wdGlvbnMubWluaSA/IHRoaXMuX3ZhbHVlKCkgOiAiIiApOwoJCX0gZWxzZSBpZiAoIGtleSA9PT0gInBvcHVwRW5hYmxlZCIgKSB7CgkJCWlmICggdmFsdWUgJiYgIXRoaXMuX3BvcHVwICkgewoJCQkJdGhpcy5fcG9wdXAgPSBnZXRQb3B1cCgpCgkJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgKCB0aGlzLm9wdGlvbnMudGhlbWUgfHwgImEiICkgKQoJCQkJCS5oaWRlKCkKCQkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLmVsZW1lbnQgKTsKCQkJfQoJCX0KCX0sCgoJLy8gc2hvdyB2YWx1ZSBvbiB0aGUgaGFuZGxlIGFuZCBpbiBwb3B1cAoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zLCBuZXdWYWx1ZTsKCgkJaWYgKCBvLnBvcHVwRW5hYmxlZCApIHsKCQkJLy8gcmVtb3ZlIHRoZSB0aXRsZSBhdHRyaWJ1dGUgZnJvbSB0aGUgaGFuZGxlICh3aGljaCBpcwoJCQkvLyByZXNwb25zaWJsZSBmb3IgdGhlIGFubm95aW5nIHRvb2x0aXApOyBOQiB3ZSBoYXZlCgkJCS8vIHRvIGRvIGl0IGhlcmUgYXMgdGhlIGpxbSBzbGlkZXIgc2V0cyBpdCBldmVyeSB0aW1lCgkJCS8vIHRoZSBzbGlkZXIncyB2YWx1ZSBjaGFuZ2VzIDooCgkJCXRoaXMuaGFuZGxlLnJlbW92ZUF0dHIoICJ0aXRsZSIgKTsKCQl9CgoJCW5ld1ZhbHVlID0gdGhpcy5fdmFsdWUoKTsKCQlpZiAoIG5ld1ZhbHVlID09PSB0aGlzLl9jdXJyZW50VmFsdWUgKSB7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fY3VycmVudFZhbHVlID0gbmV3VmFsdWU7CgoJCWlmICggby5wb3B1cEVuYWJsZWQgJiYgdGhpcy5fcG9wdXAgKSB7CgkJCXRoaXMuX3Bvc2l0aW9uUG9wdXAoKTsKCQkJdGhpcy5fcG9wdXAuaHRtbCggbmV3VmFsdWUgKTsKCQl9CgoJCWlmICggby5zaG93VmFsdWUgJiYgIXRoaXMub3B0aW9ucy5taW5pICkgewoJCQl0aGlzLmhhbmRsZS5odG1sKCBuZXdWYWx1ZSApOwoJCX0KCX0sCgoJX3Nob3dQb3B1cDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMucG9wdXBFbmFibGVkICYmICF0aGlzLl9wb3B1cFZpc2libGUgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoICIiICk7CgkJCXRoaXMuX3BvcHVwLnNob3coKTsKCQkJdGhpcy5fcG9zaXRpb25Qb3B1cCgpOwoJCQl0aGlzLl9wb3B1cFZpc2libGUgPSB0cnVlOwoJCX0KCX0sCgoJX2hpZGVQb3B1cDogZnVuY3Rpb24oKSB7CgkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggby5wb3B1cEVuYWJsZWQgJiYgdGhpcy5fcG9wdXBWaXNpYmxlICkgewoJCQlpZiAoIG8uc2hvd1ZhbHVlICYmICFvLm1pbmkgKSB7CgkJCQl0aGlzLmhhbmRsZS5odG1sKCB0aGlzLl92YWx1ZSgpICk7CgkJCX0KCQkJdGhpcy5fcG9wdXAuaGlkZSgpOwoJCQl0aGlzLl9wb3B1cFZpc2libGUgPSBmYWxzZTsKCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5mbGlwc3dpdGNoIiwgJC5leHRlbmQoewoKCW9wdGlvbnM6IHsKCQlvblRleHQ6ICJPbiIsCgkJb2ZmVGV4dDogIk9mZiIsCgkJdGhlbWU6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlKCk7CgkJCX0gZWxzZSB7CgkJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJCWZsaXBzd2l0Y2g6IHRoaXMuZWxlbWVudC5wYXJlbnQoKSwKCQkJCQlvbjogdGhpcy5lbGVtZW50LmZpbmQoICIudWktZmxpcHN3aXRjaC1vbiIgKS5lcSggMCApLAoJCQkJCW9mZjogdGhpcy5lbGVtZW50LmZpbmQoICIudWktZmxpcHN3aXRjaC1vZmYiICkuZXEoMCksCgkJCQkJdHlwZTogdGhpcy5lbGVtZW50LmdldCggMCApLnRhZ05hbWUKCQkJCX0pOwoJCQl9CgoJCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJCS8vIFRyYW5zZmVyIHRhYmluZGV4IHRvICJvbiIgZWxlbWVudCBhbmQgbWFrZSBpbnB1dCB1bmZvY3VzYWJsZQoJCQl0aGlzLl9vcmlnaW5hbFRhYkluZGV4ID0gdGhpcy5lbGVtZW50LmF0dHIoICJ0YWJpbmRleCIgKTsKCQkJaWYgKCB0aGlzLl9vcmlnaW5hbFRhYkluZGV4ICE9IG51bGwgKSB7CgkJCQl0aGlzLm9uLmF0dHIoICJ0YWJpbmRleCIsIHRoaXMuX29yaWdpbmFsVGFiSW5kZXggKTsKCQkJfQoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoJCQl0aGlzLl9vbih7CgkJCQkiZm9jdXMiIDogIl9oYW5kbGVJbnB1dEZvY3VzIgoJCQl9KTsKCgkJCWlmICggdGhpcy5lbGVtZW50LmlzKCAiOmRpc2FibGVkIiApICkgewoJCQkJdGhpcy5fc2V0T3B0aW9ucyh7CgkJCQkJImRpc2FibGVkIjogdHJ1ZQoJCQkJfSk7CgkJCX0KCgkJCXRoaXMuX29uKCB0aGlzLmZsaXBzd2l0Y2gsIHsKCQkJCSJjbGljayI6ICJfdG9nZ2xlIiwKCQkJCSJzd2lwZWxlZnQiOiAiX2xlZnQiLAoJCQkJInN3aXBlcmlnaHQiOiAiX3JpZ2h0IgoJCQl9KTsKCgkJCXRoaXMuX29uKCB0aGlzLm9uLCB7CgkJCQkia2V5ZG93biI6ICJfa2V5ZG93biIKCQkJfSk7CgoJCQl0aGlzLl9vbiggewoJCQkJImNoYW5nZSI6ICJyZWZyZXNoIgoJCQl9KTsKCX0sCgoJX2hhbmRsZUlucHV0Rm9jdXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMub24uZm9jdXMoKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5mbGlwc3dpdGNoOwoJfSwKCglfbGVmdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5mbGlwc3dpdGNoLnJlbW92ZUNsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICk7CgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQl0aGlzLmVsZW1lbnQuZ2V0KCAwICkuc2VsZWN0ZWRJbmRleCA9IDA7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQl9CgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjaGFuZ2UiICk7Cgl9LAoKCV9yaWdodDogZnVuY3Rpb24oKSB7CgkJdGhpcy5mbGlwc3dpdGNoLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICk7CgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQl0aGlzLmVsZW1lbnQuZ2V0KCAwICkuc2VsZWN0ZWRJbmRleCA9IDE7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiwgdHJ1ZSApOwoJCX0KCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImNoYW5nZSIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBmbGlwc3dpdGNoID0gJCggIjxkaXY+IiApLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQllbGVtZW50ID0gdGhpcy5lbGVtZW50LAoJCQl0aGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoKCQkJLy8gVGhlICJvbiIgYnV0dG9uIGlzIGFuIGFuY2hvciBzbyBpdCdzIGZvY3VzYWJsZQoJCQlvbiA9ICQoICI8YT48L2E+IiwgewoJCQkJImhyZWYiOiAiIyIKCQkJfSksCgkJCW9mZiA9ICQoICI8c3Bhbj48L3NwYW4+IiApLAoJCQl0eXBlID0gZWxlbWVudC5nZXQoIDAgKS50YWdOYW1lLAoJCQlvblRleHQgPSAoIHR5cGUgPT09ICJJTlBVVCIgKSA/CgkJCQlvcHRpb25zLm9uVGV4dCA6IGVsZW1lbnQuZmluZCggIm9wdGlvbiIgKS5lcSggMSApLnRleHQoKSwKCQkJb2ZmVGV4dCA9ICggdHlwZSA9PT0gIklOUFVUIiApID8KCQkJCW9wdGlvbnMub2ZmVGV4dCA6IGVsZW1lbnQuZmluZCggIm9wdGlvbiIgKS5lcSggMCApLnRleHQoKTsKCgkJCW9uCgkJCQkuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLW9uIHVpLWJ0biB1aS1zaGFkb3cgdWktYnRuLWluaGVyaXQiICkKCQkJCS50ZXh0KCBvblRleHQgKTsKCQkJb2ZmCgkJCQkuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLW9mZiIgKQoJCQkJLnRleHQoIG9mZlRleHQgKTsKCgkJCWZsaXBzd2l0Y2gKCQkJCS5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2ggdWktc2hhZG93LWluc2V0ICIgKwoJCQkJCSJ1aS1iYXItIiArIHRoZW1lICsgIiAiICsKCQkJCQkoIG9wdGlvbnMud3JhcHBlckNsYXNzID8gb3B0aW9ucy53cmFwcGVyQ2xhc3MgOiAiIiApICsgIiAiICsKCQkJCQkoICggZWxlbWVudC5pcyggIjpjaGVja2VkIiApIHx8CgkJCQkJCWVsZW1lbnQKCQkJCQkJCS5maW5kKCAib3B0aW9uIiApCgkJCQkJCQkuZXEoIDEgKQoJCQkJCQkJLmlzKCAiOnNlbGVjdGVkIiApICkgPyAidWktZmxpcHN3aXRjaC1hY3RpdmUiIDogIiIgKSArCgkJCQkJKCBlbGVtZW50LmlzKCI6ZGlzYWJsZWQiKSA/ICIgdWktc3RhdGUtZGlzYWJsZWQiOiAiIikgKwoJCQkJCSggb3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIjogIiIgKSArCgkJCQkJKCBvcHRpb25zLm1pbmkgPyAiIHVpLW1pbmkiOiAiIiApICkKCQkJCS5hcHBlbmQoIG9uLCBvZmYgKTsKCgkJCWVsZW1lbnQKCQkJCS5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtaW5wdXQiICkKCQkJCS5hZnRlciggZmxpcHN3aXRjaCApCgkJCQkuYXBwZW5kVG8oIGZsaXBzd2l0Y2ggKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJZmxpcHN3aXRjaDogZmxpcHN3aXRjaCwKCQkJb246IG9uLAoJCQlvZmY6IG9mZiwKCQkJdHlwZTogdHlwZQoJCX0pOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgZGlyZWN0aW9uLAoJCQlleGlzdGluZ0RpcmVjdGlvbiA9IHRoaXMuZmxpcHN3aXRjaC5oYXNDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApID8gIl9yaWdodCIgOiAiX2xlZnQiOwoKCQlpZiAoIHRoaXMudHlwZSA9PT0gIlNFTEVDVCIgKSB7CgkJCWRpcmVjdGlvbiA9ICggdGhpcy5lbGVtZW50LmdldCggMCApLnNlbGVjdGVkSW5kZXggPiAwICkgPyAiX3JpZ2h0IjogIl9sZWZ0IjsKCQl9IGVsc2UgewoJCQlkaXJlY3Rpb24gPSB0aGlzLmVsZW1lbnQucHJvcCggImNoZWNrZWQiICkgPyAiX3JpZ2h0IjogIl9sZWZ0IjsKCQl9CgoJCWlmICggZGlyZWN0aW9uICE9PSBleGlzdGluZ0RpcmVjdGlvbiApIHsKCQkJdGhpc1sgZGlyZWN0aW9uIF0oKTsKCQl9Cgl9LAoKCV90b2dnbGU6IGZ1bmN0aW9uKCkgewoJCXZhciBkaXJlY3Rpb24gPSB0aGlzLmZsaXBzd2l0Y2guaGFzQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgKSA/ICJfbGVmdCIgOiAiX3JpZ2h0IjsKCgkJdGhpc1sgZGlyZWN0aW9uIF0oKTsKCX0sCgoJX2tleWRvd246IGZ1bmN0aW9uKCBlICkgewoJCWlmICggZS53aGljaCA9PT0gJC5tb2JpbGUua2V5Q29kZS5MRUZUICkgewoJCQl0aGlzLl9sZWZ0KCk7CgkJfSBlbHNlIGlmICggZS53aGljaCA9PT0gJC5tb2JpbGUua2V5Q29kZS5SSUdIVCApIHsKCQkJdGhpcy5fcmlnaHQoKTsKCQl9IGVsc2UgaWYgKCBlLndoaWNoID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFICkgewoJCQl0aGlzLl90b2dnbGUoKTsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl2YXIgY3VycmVudFRoZW1lID0gb3B0aW9ucy50aGVtZSA/IG9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIsCgkJCQluZXdUaGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogImluaGVyaXQiOwoKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktYmFyLSIgKyBjdXJyZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyBuZXdUaGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMub25UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub24udGV4dCggb3B0aW9ucy5vblRleHQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm9mZlRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5vZmYudGV4dCggb3B0aW9ucy5vZmZUZXh0ICk7CgkJfQoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJfQoJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0aW9ucy5taW5pICk7CgkJfQoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMud2lkZ2V0KCkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgb3B0aW9ucy5jb3JuZXJzICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXJldHVybjsKCQl9CgkJaWYgKCB0aGlzLl9vcmlnaW5hbFRhYkluZGV4ICE9IG51bGwgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAidGFiaW5kZXgiLCB0aGlzLl9vcmlnaW5hbFRhYkluZGV4ICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCQl9CgkJdGhpcy5vbi5yZW1vdmUoKTsKCQl0aGlzLm9mZi5yZW1vdmUoKTsKCQl0aGlzLmVsZW1lbnQudW53cmFwKCk7CgkJdGhpcy5mbGlwc3dpdGNoLnJlbW92ZSgpOwoJCXRoaXMucmVtb3ZlQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWlucHV0IiApOwoJfQoKfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnJhbmdlc2xpZGVyIiwgJC5leHRlbmQoIHsKCgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJdHJhY2tUaGVtZTogbnVsbCwKCQkJY29ybmVyczogdHJ1ZSwKCQkJbWluaTogZmFsc2UsCgkJCWhpZ2hsaWdodDogdHJ1ZQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQllbENsYXNzID0gdGhpcy5vcHRpb25zLm1pbmkgPyAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgOiAidWktcmFuZ2VzbGlkZXIiLAoJCQlfaW5wdXRGaXJzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkuZmlyc3QoKSwKCQkJX2lucHV0TGFzdCA9ICRlbC5maW5kKCAiaW5wdXQiICkubGFzdCgpLAoJCQlfbGFiZWwgPSAkZWwuZmluZCggImxhYmVsIiApLmZpcnN0KCksCgkJCV9zbGlkZXJXaWRnZXRGaXJzdCA9ICQuZGF0YSggX2lucHV0Rmlyc3QuZ2V0KCAwICksICJtb2JpbGUtc2xpZGVyIiApIHx8CgkJCQkkLmRhdGEoIF9pbnB1dEZpcnN0LnNsaWRlcigpLmdldCggMCApLCAibW9iaWxlLXNsaWRlciIgKSwKCQkJX3NsaWRlcldpZGdldExhc3QgPSAkLmRhdGEoIF9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKSB8fAoJCQkJJC5kYXRhKCBfaW5wdXRMYXN0LnNsaWRlcigpLmdldCggMCApLCAibW9iaWxlLXNsaWRlciIgKSwKCQkJX3NsaWRlckZpcnN0ID0gX3NsaWRlcldpZGdldEZpcnN0LnNsaWRlciwKCQkJX3NsaWRlckxhc3QgPSBfc2xpZGVyV2lkZ2V0TGFzdC5zbGlkZXIsCgkJCWZpcnN0SGFuZGxlID0gX3NsaWRlcldpZGdldEZpcnN0LmhhbmRsZSwKCQkJX3NsaWRlcnMgPSAkKCAiPGRpdiBjbGFzcz0ndWktcmFuZ2VzbGlkZXItc2xpZGVycycgLz4iICkuYXBwZW5kVG8oICRlbCApOwoKCQkJX2lucHV0Rmlyc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCIgKTsKCQkJX2lucHV0TGFzdC5hZGRDbGFzcyggInVpLXJhbmdlc2xpZGVyLWxhc3QiICk7CgkJCSRlbC5hZGRDbGFzcyggZWxDbGFzcyApOwoKCQkJX3NsaWRlckZpcnN0LmFwcGVuZFRvKCBfc2xpZGVycyApOwoJCQlfc2xpZGVyTGFzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJX2xhYmVsLmluc2VydEJlZm9yZSggJGVsICk7CgkJCWZpcnN0SGFuZGxlLnByZXBlbmRUbyggX3NsaWRlckxhc3QgKTsKCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfaW5wdXRGaXJzdDogX2lucHV0Rmlyc3QsCgkJCQlfaW5wdXRMYXN0OiBfaW5wdXRMYXN0LAoJCQkJX3NsaWRlckZpcnN0OiBfc2xpZGVyRmlyc3QsCgkJCQlfc2xpZGVyTGFzdDogX3NsaWRlckxhc3QsCgkJCQlfbGFiZWw6IF9sYWJlbCwKCQkJCV90YXJnZXRWYWw6IG51bGwsCgkJCQlfc2xpZGVyVGFyZ2V0OiBmYWxzZSwKCQkJCV9zbGlkZXJzOiBfc2xpZGVycywKCQkJCV9wcm94eTogZmFsc2UKCQkJfSk7CgoJCQl0aGlzLnJlZnJlc2goKTsKCQkJdGhpcy5fb24oIHRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQudWktc2xpZGVyLWlucHV0IiApLCB7CgkJCQkic2xpZGViZWZvcmVzdGFydCI6ICJfc2xpZGViZWZvcmVzdGFydCIsCgkJCQkic2xpZGVzdG9wIjogIl9zbGlkZXN0b3AiLAoJCQkJInNsaWRlZHJhZyI6ICJfc2xpZGVkcmFnIiwKCQkJCSJzbGlkZWJlZm9yZWNoYW5nZSI6ICJfY2hhbmdlIiwKCQkJCSJibHVyIjogIl9jaGFuZ2UiLAoJCQkJImtleXVwIjogIl9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbih7CgkJCQkibW91c2Vkb3duIjoiX2NoYW5nZSIKCQkJfSk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0iICksIHsKCQkJCSJyZXNldCI6Il9oYW5kbGVSZXNldCIKCQkJfSk7CgkJCXRoaXMuX29uKCBmaXJzdEhhbmRsZSwgewoJCQkJInZtb3VzZWRvd24iOiAiX2RyYWdGaXJzdEhhbmRsZSIKCQkJfSk7CgkJfSwKCQlfaGFuZGxlUmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCS8vd2UgbXVzdCB3YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIGJlZm9yZSB1cGRhdGVpbmcgb3RoZXIgd2lzZSBzbGlkZXJzIHdpbGwgbm90IGhhdmUgdXBkYXRlZCB5ZXQKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQlzZWxmLl91cGRhdGVIaWdobGlnaHQoKTsKCQkJfSwwKTsKCQl9LAoKCQlfZHJhZ0ZpcnN0SGFuZGxlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vaWYgdGhlIGZpcnN0IGhhbmRsZSBpcyBkcmFnZ2VkIHNlbmQgdGhlIGV2ZW50IHRvIHRoZSBmaXJzdCBzbGlkZXIKCQkJJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5yZWZyZXNoKCBldmVudCApOwoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5fdHJpZ2dlciggInN0YXJ0IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCgkJX3NsaWRlZHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5pcyggdGhpcy5faW5wdXRGaXJzdCApLAoJCQkJb3RoZXJTbGlkZXIgPSAoIGZpcnN0ICkgPyB0aGlzLl9pbnB1dExhc3QgOiB0aGlzLl9pbnB1dEZpcnN0OwoKCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gZmFsc2U7CgkJCS8vaWYgdGhlIGRyYWcgd2FzIGluaXRpYXRlZCBvbiBhbiBleHRyZW1lIGFuZCB0aGUgb3RoZXIgaGFuZGxlIGlzIGZvY3VzZWQgc2VuZCB0aGUgZXZlbnRzIHRvCgkJCS8vdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCWlmICggKCB0aGlzLl9wcm94eSA9PT0gImZpcnN0IiAmJiBmaXJzdCApIHx8ICggdGhpcy5fcHJveHkgPT09ICJsYXN0IiAmJiAhZmlyc3QgKSApIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5kcmFnZ2luZyA9IHRydWU7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV9zbGlkZXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKTsKCgkJCXRoaXMuX3Byb3h5ID0gZmFsc2U7CgkJCS8vdGhpcyBzdG9wcyBkcmFnZ2luZyBvZiB0aGUgaGFuZGxlIGFuZCBicmluZ3MgdGhlIGFjdGl2ZSB0cmFjayB0byB0aGUgZnJvbnQKCQkJLy90aGlzIG1ha2VzIGNsaWNrcyBvbiB0aGUgdHJhY2sgZ28gdGhlIHRoZSBsYXN0IGhhbmRsZSB1c2VkCgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkudHJpZ2dlciggInZtb3VzZXVwIiApOwoJCQl0aGlzLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAxIDogIiIgKTsKCQl9LAoKCQlfc2xpZGViZWZvcmVzdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSBmYWxzZTsKCQkJLy9pZiB0aGUgdHJhY2sgaXMgdGhlIHRhcmdldCByZW1lbWJlciB0aGlzIGFuZCB0aGUgb3JpZ2luYWwgdmFsdWUKCQkJaWYgKCAkKCBldmVudC5vcmlnaW5hbEV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktc2xpZGVyLXRyYWNrIiApICkgewoJCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gdHJ1ZTsKCQkJCXRoaXMuX3RhcmdldFZhbCA9ICQoIGV2ZW50LnRhcmdldCApLnZhbCgpOwoJCQl9CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldFRoZW1lKCBvcHRpb25zLnRoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy50cmFja1RoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRUcmFja1RoZW1lKCBvcHRpb25zLnRyYWNrVGhlbWUgKTsKCQkJfQoKCQkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3NldE1pbmkoIG9wdGlvbnMubWluaSApOwoJCQl9CgoJCQlpZiAoIG9wdGlvbnMuaGlnaGxpZ2h0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRIaWdobGlnaHQoIG9wdGlvbnMuaGlnaGxpZ2h0ICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0RGlzYWJsZWQoIG9wdGlvbnMuZGlzYWJsZWQgKTsKCQkJfQoKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkJaWYgKCB0aGlzLl9pbnB1dEZpcnN0LmlzKCAiOmRpc2FibGVkIiApIHx8IHRoaXMuX2lucHV0TGFzdC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IHRydWU7CgkJCX0KCgkJCSRlbC5maW5kKCAiaW5wdXQiICkuc2xpZGVyKHsKCQkJCXRoZW1lOiBvLnRoZW1lLAoJCQkJdHJhY2tUaGVtZTogby50cmFja1RoZW1lLAoJCQkJZGlzYWJsZWQ6IG8uZGlzYWJsZWQsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQltaW5pOiBvLm1pbmksCgkJCQloaWdobGlnaHQ6IG8uaGlnaGxpZ2h0CgkJCX0pLnNsaWRlciggInJlZnJlc2giICk7CgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCX0sCgoJCV9jaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCBldmVudC50eXBlID09PSAia2V5dXAiICkgewoJCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW1pbiA9IHBhcnNlRmxvYXQoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCksIDEwICksCgkJCQltYXggPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dExhc3QudmFsKCksIDEwICksCgkJCQlmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmhhc0NsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICksCgkJCQl0aGlzU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dEZpcnN0IDogdGhpcy5faW5wdXRMYXN0LAoJCQkJb3RoZXJTbGlkZXIgPSBmaXJzdCA/IHRoaXMuX2lucHV0TGFzdCA6IHRoaXMuX2lucHV0Rmlyc3Q7CgoJCQlpZiAoICggdGhpcy5faW5wdXRGaXJzdC52YWwoKSA+IHRoaXMuX2lucHV0TGFzdC52YWwoKSAmJiBldmVudC50eXBlID09PSAibW91c2Vkb3duIiAmJiAhJChldmVudC50YXJnZXQpLmhhc0NsYXNzKCJ1aS1zbGlkZXItaGFuZGxlIikpICkgewoJCQkJdGhpc1NsaWRlci5ibHVyKCk7CgkJCX0gZWxzZSBpZiAoIGV2ZW50LnR5cGUgPT09ICJtb3VzZWRvd24iICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggbWluID4gbWF4ICYmICF0aGlzLl9zbGlkZXJUYXJnZXQgKSB7CgkJCQkvL3RoaXMgcHJldmVudHMgbWluIGZyb20gYmVpbmcgZ3JlYXRlciB0aGVuIG1heAoJCQkJdGhpc1NsaWRlci52YWwoIGZpcnN0ID8gbWF4OiBtaW4gKS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQkJdGhpcy5fdHJpZ2dlciggIm5vcm1hbGl6ZSIgKTsKCQkJfSBlbHNlIGlmICggbWluID4gbWF4ICkgewoJCQkJLy90aGlzIG1ha2VzIGl0IHNvIGNsaWNrcyBvbiB0aGUgdGFyZ2V0IG9uIGVpdGhlciBleHRyZW1lIGdvIHRvIHRoZSBjbG9zZXN0IGhhbmRsZQoJCQkJdGhpc1NsaWRlci52YWwoIHRoaXMuX3RhcmdldFZhbCApLnNsaWRlciggInJlZnJlc2giICk7CgoJCQkJLy9Zb3UgbXVzdCB3YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIHNvIGZpcnN0IHNsaWRlciBpcyB1cGRhdGVkIGJlZm9yZSB1cGRhdGluZyBzZWNvbmQKCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCW90aGVyU2xpZGVyLnZhbCggZmlyc3QgPyBtaW46IG1heCApLnNsaWRlciggInJlZnJlc2giICk7CgkJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5mb2N1cygpOwoJCQkJCXNlbGYuX3NsaWRlckZpcnN0LmNzcyggInotaW5kZXgiLCBmaXJzdCA/ICIiIDogMSApOwoJCQkJCXNlbGYuX3RyaWdnZXIoICJub3JtYWxpemUiICk7CgkJCQl9LCAwICk7CgkJCQl0aGlzLl9wcm94eSA9ICggZmlyc3QgKSA/ICJmaXJzdCIgOiAibGFzdCI7CgkJCX0KCQkJLy9maXhlcyBpc3N1ZSB3aGVyZSB3aGVuIGJvdGggX3NsaWRlcnMgYXJlIGF0IG1pbiB0aGV5IGNhbm5vdCBiZSBhZGp1c3RlZAoJCQlpZiAoIG1pbiA9PT0gbWF4ICkgewoJCQkJJC5kYXRhKCB0aGlzU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAxICk7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAwICk7CgkJCX0gZWxzZSB7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQkJJC5kYXRhKCB0aGlzU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQl9CgoJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCgkJCWlmICggbWluID49IG1heCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgoJCV91cGRhdGVIaWdobGlnaHQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWluID0gcGFyc2VJbnQoICQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5nZXQoMCkuc3R5bGUubGVmdCwgMTAgKSwKCQkJCW1heCA9IHBhcnNlSW50KCAkLmRhdGEoIHRoaXMuX2lucHV0TGFzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5nZXQoMCkuc3R5bGUubGVmdCwgMTAgKSwKCQkJCXdpZHRoID0gKG1heCAtIG1pbik7CgoJCQl0aGlzLmVsZW1lbnQuZmluZCggIi51aS1zbGlkZXItYmciICkuY3NzKHsKCQkJCSJtYXJnaW4tbGVmdCI6IG1pbiArICIlIiwKCQkJCSJ3aWR0aCI6IHdpZHRoICsgIiUiCgkJCX0pOwoJCX0sCgoJCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJ0aGVtZSIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAidGhlbWUiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRUcmFja1RoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgInRyYWNrVGhlbWUiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgInRyYWNrVGhlbWUiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRNaW5pOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgIm1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgIm1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgISF2YWx1ZSApOwoJCX0sCgoJCV9zZXRIaWdobGlnaHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAiaGlnaGxpZ2h0IiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJoaWdobGlnaHQiLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXREaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnByb3AoICJkaXNhYmxlZCIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5wcm9wKCAiZGlzYWJsZWQiLCB2YWx1ZSApOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fbGFiZWwucHJlcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgKTsKCQkJdGhpcy5faW5wdXRGaXJzdC5hZnRlciggdGhpcy5fc2xpZGVyRmlyc3QgKTsKCQkJdGhpcy5faW5wdXRMYXN0LmFmdGVyKCB0aGlzLl9zbGlkZXJMYXN0ICk7CgkJCXRoaXMuX3NsaWRlcnMucmVtb3ZlKCk7CgkJCXRoaXMuZWxlbWVudC5maW5kKCAiaW5wdXQiICkucmVtb3ZlQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1maXJzdCB1aS1yYW5nZXNsaWRlci1sYXN0IiApLnNsaWRlciggImRlc3Ryb3kiICk7CgkJfQoKCX0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJJC53aWRnZXQoICJtb2JpbGUudGV4dGlucHV0IiwgJC5tb2JpbGUudGV4dGlucHV0LCB7CgkJb3B0aW9uczogewoJCQljbGVhckJ0bjogZmFsc2UsCgkJCWNsZWFyQnRuVGV4dDogIkNsZWFyIHRleHQiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgoJCQlpZiAoIHRoaXMuaXNTZWFyY2ggKSB7CgkJCQl0aGlzLm9wdGlvbnMuY2xlYXJCdG4gPSB0cnVlOwoJCQl9CgoJCQlpZiAoICEhdGhpcy5vcHRpb25zLmNsZWFyQnRuICYmIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCQl0aGlzLl9hZGRDbGVhckJ0bigpOwoJCQl9CgkJfSwKCgkJY2xlYXJCdXR0b246IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJCggIjxhIGhyZWY9JyMnICIgKwoJCQkJImNsYXNzPSd1aS1pbnB1dC1jbGVhciB1aS1idG4gdWktaWNvbi1kZWxldGUgdWktYnRuLWljb24tbm90ZXh0IHVpLWNvcm5lci1hbGwnPiIgKwoJCQkJIjwvYT4iICkKCQkJCQkuYXR0ciggInRpdGxlIiwgdGhpcy5vcHRpb25zLmNsZWFyQnRuVGV4dCApCgkJCQkJLnRleHQoIHRoaXMub3B0aW9ucy5jbGVhckJ0blRleHQgKTsKCQl9LAoKCQlfY2xlYXJCdG5DbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl0aGlzLmVsZW1lbnQudmFsKCAiIiApCgkJCQkJLmZvY3VzKCkKCQkJCQkudHJpZ2dlciggImNoYW5nZSIgKTsKCgkJCXRoaXMuX2NsZWFyQnRuLmFkZENsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0sCgoJCV9hZGRDbGVhckJ0bjogZnVuY3Rpb24oKSB7CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlQ2xlYXIoKTsKCQkJfQoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9jbGVhckJ0bjogdGhpcy53aWRnZXQoKS5maW5kKCJhLnVpLWlucHV0LWNsZWFyIikKCQkJfSk7CgoJCQl0aGlzLl9iaW5kQ2xlYXJFdmVudHMoKTsKCgkJCXRoaXMuX3RvZ2dsZUNsZWFyKCk7CgoJCX0sCgoJCV9lbmhhbmNlQ2xlYXI6IGZ1bmN0aW9uKCkgewoKCQkJdGhpcy5jbGVhckJ1dHRvbigpLmFwcGVuZFRvKCB0aGlzLndpZGdldCgpICk7CgkJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICJ1aS1pbnB1dC1oYXMtY2xlYXIiICk7CgoJCX0sCgoJCV9iaW5kQ2xlYXJFdmVudHM6IGZ1bmN0aW9uKCkgewoKCQkJdGhpcy5fb24oIHRoaXMuX2NsZWFyQnRuLCB7CgkJCQkiY2xpY2siOiAiX2NsZWFyQnRuQ2xpY2siCgkJCX0pOwoKCQkJdGhpcy5fb24oewoJCQkJImtleXVwIjogIl90b2dnbGVDbGVhciIsCgkJCQkiY2hhbmdlIjogIl90b2dnbGVDbGVhciIsCgkJCQkiaW5wdXQiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJmb2N1cyI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImJsdXIiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJjdXQiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJwYXN0ZSI6ICJfdG9nZ2xlQ2xlYXIiCgoJCQl9KTsKCgkJfSwKCgkJX3VuYmluZENsZWFyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fb2ZmKCB0aGlzLl9jbGVhckJ0biwgImNsaWNrIik7CgkJCXRoaXMuX29mZiggdGhpcy5lbGVtZW50LCAia2V5dXAgY2hhbmdlIGlucHV0IGZvY3VzIGJsdXIgY3V0IHBhc3RlIiApOwoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJCWlmICggb3B0aW9ucy5jbGVhckJ0biAhPT0gdW5kZWZpbmVkICYmCgkJCQkhdGhpcy5lbGVtZW50LmlzKCAidGV4dGFyZWEsIDpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICkgKSB7CgkJCQlpZiAoIG9wdGlvbnMuY2xlYXJCdG4gKSB7CgkJCQkJdGhpcy5fYWRkQ2xlYXJCdG4oKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5fZGVzdHJveUNsZWFyKCk7CgkJCQl9CgkJCX0KCgkJCWlmICggb3B0aW9ucy5jbGVhckJ0blRleHQgIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9jbGVhckJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fY2xlYXJCdG4udGV4dCggb3B0aW9ucy5jbGVhckJ0blRleHQgKQoJCQkJCS5hdHRyKCJ0aXRsZSIsIG9wdGlvbnMuY2xlYXJCdG5UZXh0KTsKCQkJfQoJCX0sCgoJCV90b2dnbGVDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2RlbGF5KCAiX3RvZ2dsZUNsZWFyQ2xhc3MiLCAwICk7CgkJfSwKCgkJX3RvZ2dsZUNsZWFyQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9jbGVhckJ0bi50b2dnbGVDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIsICF0aGlzLmVsZW1lbnQudmFsKCkgKTsKCQl9LAoKCQlfZGVzdHJveUNsZWFyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggInVpLWlucHV0LWhhcy1jbGVhciIgKTsKCQkJdGhpcy5fdW5iaW5kQ2xlYXIoKTsKCQkJdGhpcy5fY2xlYXJCdG4ucmVtb3ZlKCk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLl9kZXN0cm95Q2xlYXIoKTsKCQl9CgoJfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50ZXh0aW5wdXQiLCAkLm1vYmlsZS50ZXh0aW5wdXQsIHsKCQlvcHRpb25zOiB7CgkJCWF1dG9ncm93OnRydWUsCgkJCWtleXVwVGltZW91dEJ1ZmZlcjogMTAwCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgoJCQlpZiAoIHRoaXMub3B0aW9ucy5hdXRvZ3JvdyAmJiB0aGlzLmlzVGV4dGFyZWEgKSB7CgkJCQl0aGlzLl9hdXRvZ3JvdygpOwoJCQl9CgkJfSwKCgkJX2F1dG9ncm93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktdGV4dGlucHV0LWF1dG9ncm93IiApOwoKCQkJdGhpcy5fb24oewoJCQkJImtleXVwIjogIl90aW1lb3V0IiwKCQkJCSJjaGFuZ2UiOiAiX3RpbWVvdXQiLAoJCQkJImlucHV0IjogIl90aW1lb3V0IiwKCQkJCSJwYXN0ZSI6ICJfdGltZW91dCIKCQkJfSk7CgoJCQkvLyBBdHRhY2ggdG8gdGhlIHZhcmlvdXMgeW91LWhhdmUtYmVjb21lLXZpc2libGUgbm90aWZpY2F0aW9ucyB0aGF0IHRoZQoJCQkvLyB2YXJpb3VzIGZyYW1ld29yayBlbGVtZW50cyBlbWl0LgoJCQkvLyBUT0RPOiBSZW1vdmUgYWxsIGJ1dCB0aGUgdXBkYXRlbGF5b3V0IGhhbmRsZXIgb25jZSAjNjQyNiBpcyBmaXhlZC4KCQkJdGhpcy5fb24oIHRydWUsIHRoaXMuZG9jdW1lbnQsIHsKCgkJCQkvLyBUT0RPOiBNb3ZlIHRvIG5vbi1kZXByZWNhdGVkIGV2ZW50CgkJCQkicGFnZXNob3ciOiAiX2hhbmRsZVNob3ciLAoJCQkJInBvcHVwYmVmb3JlcG9zaXRpb24iOiAiX2hhbmRsZVNob3ciLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlU2hvdyIsCgkJCQkicGFuZWxvcGVuIjogIl9oYW5kbGVTaG93IgoJCQl9KTsKCQl9LAoKCQkvLyBTeW5jaHJvbm91c2x5IGZpeCB0aGUgd2lkZ2V0IGhlaWdodCBpZiB0aGlzIHdpZGdldCdzIHBhcmVudHMgYXJlIHN1Y2gKCQkvLyB0aGF0IHRoZXkgc2hvdy9oaWRlIGNvbnRlbnQgYXQgcnVudGltZS4gV2Ugc3RpbGwgbmVlZCB0byBjaGVjayB3aGV0aGVyCgkJLy8gdGhlIHdpZGdldCBpcyBhY3R1YWxseSB2aXNpYmxlIGluIGNhc2UgaXQgaXMgY29udGFpbmVkIGluc2lkZSBtdWx0aXBsZQoJCS8vIHN1Y2ggY29udGFpbmVycy4gRm9yIGV4YW1wbGU6IHBhbmVsIGNvbnRhaW5zIGNvbGxhcHNpYmxlIGNvbnRhaW5zCgkJLy8gYXV0b2dyb3cgdGV4dGlucHV0LiBUaGUgcGFuZWwgbWF5IGVtaXQgInBhbmVsb3BlbiIgaW5kaWNhdGluZyB0aGF0IGl0cwoJCS8vIGNvbnRlbnQgaGFzIGJlY29tZSB2aXNpYmxlLCBidXQgdGhlIGNvbGxhcHNpYmxlIGlzIHN0aWxsIGNvbGxhcHNlZCwgc28KCQkvLyB0aGUgYXV0b2dyb3cgdGV4dGFyZWEgaXMgc3RpbGwgbm90IHZpc2libGUuCgkJX2hhbmRsZVNob3c6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAkLmNvbnRhaW5zKCBldmVudC50YXJnZXQsIHRoaXMuZWxlbWVudFsgMCBdICkgJiYKCQkJCXRoaXMuZWxlbWVudC5pcyggIjp2aXNpYmxlIiApICkgewoKCQkJCWlmICggZXZlbnQudHlwZSAhPT0gInBvcHVwYmVmb3JlcG9zaXRpb24iICkgewoJCQkJCXRoaXMuZWxlbWVudAoJCQkJCQkuYWRkQ2xhc3MoICJ1aS10ZXh0aW5wdXQtYXV0b2dyb3ctcmVzaXplIiApCgkJCQkJCS5hbmltYXRpb25Db21wbGV0ZSgKCQkJCQkJCSQucHJveHkoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLXRleHRpbnB1dC1hdXRvZ3Jvdy1yZXNpemUiICk7CgkJCQkJCQl9LCB0aGlzICksCgkJCQkJCSJ0cmFuc2l0aW9uIiApOwoJCQkJfQoJCQkJdGhpcy5fcHJlcGFyZUhlaWdodFVwZGF0ZSgpOwoJCQl9CgkJfSwKCgkJX3VuYmluZEF1dG9ncm93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktdGV4dGlucHV0LWF1dG9ncm93IiApOwoJCQl0aGlzLl9vZmYoIHRoaXMuZWxlbWVudCwgImtleXVwIGNoYW5nZSBpbnB1dCBwYXN0ZSIgKTsKCQkJdGhpcy5fb2ZmKCB0aGlzLmRvY3VtZW50LAoJCQkJInBhZ2VzaG93IHBvcHVwYmVmb3JlcG9zaXRpb24gdXBkYXRlbGF5b3V0IHBhbmVsb3BlbiIgKTsKCQl9LAoKCQlrZXl1cFRpbWVvdXQ6IG51bGwsCgoJCV9wcmVwYXJlSGVpZ2h0VXBkYXRlOiBmdW5jdGlvbiggZGVsYXkgKSB7CgkJCWlmICggdGhpcy5rZXl1cFRpbWVvdXQgKSB7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMua2V5dXBUaW1lb3V0ICk7CgkJCX0KCQkJaWYgKCBkZWxheSA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fdXBkYXRlSGVpZ2h0KCk7CgkJCX0gZWxzZSB7CgkJCQl0aGlzLmtleXVwVGltZW91dCA9IHRoaXMuX2RlbGF5KCAiX3VwZGF0ZUhlaWdodCIsIGRlbGF5ICk7CgkJCX0KCQl9LAoKCQlfdGltZW91dDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3ByZXBhcmVIZWlnaHRVcGRhdGUoIHRoaXMub3B0aW9ucy5rZXl1cFRpbWVvdXRCdWZmZXIgKTsKCQl9LAoKCQlfdXBkYXRlSGVpZ2h0OiBmdW5jdGlvbigpIHsKCQkJdmFyIHBhZGRpbmdUb3AsIHBhZGRpbmdCb3R0b20sIHBhZGRpbmdIZWlnaHQsIHNjcm9sbEhlaWdodCwgY2xpZW50SGVpZ2h0LAoJCQkJYm9yZGVyVG9wLCBib3JkZXJCb3R0b20sIGJvcmRlckhlaWdodCwgaGVpZ2h0LAoJCQkJc2Nyb2xsVG9wID0gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgkJCXRoaXMua2V5dXBUaW1lb3V0ID0gMDsKCgkJCS8vIElFOCB0ZXh0YXJlYXMgaGF2ZSB0aGUgb25wYWdlIHByb3BlcnR5IC0gb3RoZXJzIGRvIG5vdAoJCQlpZiAoICEoICJvbnBhZ2UiIGluIHRoaXMuZWxlbWVudFsgMCBdICkgKSB7CgkJCQl0aGlzLmVsZW1lbnQuY3NzKHsKCQkJCQkiaGVpZ2h0IjogMCwKCQkJCQkibWluLWhlaWdodCI6IDAsCgkJCQkJIm1heC1oZWlnaHQiOiAwCgkJCQl9KTsKCQkJfQoKCQkJc2Nyb2xsSGVpZ2h0ID0gdGhpcy5lbGVtZW50WyAwIF0uc2Nyb2xsSGVpZ2h0OwoJCQljbGllbnRIZWlnaHQgPSB0aGlzLmVsZW1lbnRbIDAgXS5jbGllbnRIZWlnaHQ7CgkJCWJvcmRlclRvcCA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJib3JkZXItdG9wLXdpZHRoIiApICk7CgkJCWJvcmRlckJvdHRvbSA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJib3JkZXItYm90dG9tLXdpZHRoIiApICk7CgkJCWJvcmRlckhlaWdodCA9IGJvcmRlclRvcCArIGJvcmRlckJvdHRvbTsKCQkJaGVpZ2h0ID0gc2Nyb2xsSGVpZ2h0ICsgYm9yZGVySGVpZ2h0ICsgMTU7CgoJCQkvLyBJc3N1ZSA2MTc5OiBQYWRkaW5nIGlzIG5vdCBpbmNsdWRlZCBpbiBzY3JvbGxIZWlnaHQgYW5kCgkJCS8vIGNsaWVudEhlaWdodCBieSBGaXJlZm94IGlmIG5vIHNjcm9sbGJhciBpcyB2aXNpYmxlLiBCZWNhdXNlCgkJCS8vIHRleHRhcmVhcyB1c2UgdGhlIGJvcmRlci1ib3ggYm94LXNpemluZyBtb2RlbCwgcGFkZGluZyBzaG91bGQgYmUKCQkJLy8gaW5jbHVkZWQgaW4gdGhlIG5ldyAoYXNzaWduZWQpIGhlaWdodC4gQmVjYXVzZSB0aGUgaGVpZ2h0IGlzIHNldAoJCQkvLyB0byAwLCBjbGllbnRIZWlnaHQgPT0gMCBpbiBGaXJlZm94LiBUaGVyZWZvcmUsIHdlIGNhbiB1c2UgdGhpcyB0bwoJCQkvLyBjaGVjayBpZiBwYWRkaW5nIG11c3QgYmUgYWRkZWQuCgkJCWlmICggY2xpZW50SGVpZ2h0ID09PSAwICkgewoJCQkJcGFkZGluZ1RvcCA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJwYWRkaW5nLXRvcCIgKSApOwoJCQkJcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoIHRoaXMuZWxlbWVudC5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApOwoJCQkJcGFkZGluZ0hlaWdodCA9IHBhZGRpbmdUb3AgKyBwYWRkaW5nQm90dG9tOwoKCQkJCWhlaWdodCArPSBwYWRkaW5nSGVpZ2h0OwoJCQl9CgoJCQl0aGlzLmVsZW1lbnQuY3NzKHsKCQkJCSJoZWlnaHQiOiBoZWlnaHQsCgkJCQkibWluLWhlaWdodCI6ICIiLAoJCQkJIm1heC1oZWlnaHQiOiAiIgoJCQl9KTsKCgkJCXRoaXMud2luZG93LnNjcm9sbFRvcCggc2Nyb2xsVG9wICk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLmF1dG9ncm93ICYmIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJCXRoaXMuX3VwZGF0ZUhlaWdodCgpOwoJCQl9CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJCWlmICggb3B0aW9ucy5hdXRvZ3JvdyAhPT0gdW5kZWZpbmVkICYmIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJCWlmICggb3B0aW9ucy5hdXRvZ3JvdyApIHsKCQkJCQl0aGlzLl9hdXRvZ3JvdygpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl91bmJpbmRBdXRvZ3JvdygpOwoJCQkJfQoJCQl9CgkJfQoKCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLmV4dGVuZCggewoJaW5pdFNlbGVjdG9yOiAic2VsZWN0Om5vdCggOmpxbURhdGEocm9sZT0nc2xpZGVyJykpOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcpICkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpY29uOiAiY2FyYXQtZCIsCgkJaWNvbnBvczogInJpZ2h0IiwKCQlpbmxpbmU6IGZhbHNlLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQlvdmVybGF5VGhlbWU6IG51bGwsCgkJZGl2aWRlclRoZW1lOiBudWxsLAoJCWhpZGVQbGFjZWhvbGRlck1lbnVJdGVtczogdHJ1ZSwKCQljbG9zZVRleHQ6ICJDbG9zZSIsCgkJbmF0aXZlTWVudTogdHJ1ZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKCV9zZWxlY3RPcHRpb25zOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKCX0sCgoJLy8gc2V0dXAgaXRlbXMgdGhhdCBhcmUgZ2VuZXJhbGx5IG5lY2Vzc2FyeSBmb3Igc2VsZWN0IG1lbnUgZXh0ZW5zaW9uCglfcHJlRXh0ZW5zaW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5saW5lID0gdGhpcy5vcHRpb25zLmlubGluZSB8fCB0aGlzLmVsZW1lbnQuanFtRGF0YSggImlubGluZSIgKSwKCQkJbWluaSA9IHRoaXMub3B0aW9ucy5taW5pIHx8IHRoaXMuZWxlbWVudC5qcW1EYXRhKCAibWluaSIgKSwKCQkJY2xhc3NlcyA9ICIiOwoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLWxlZnQiOwoJCX0KCgkJaWYgKCAgISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gIiB1aS1idG4tcmlnaHQiOwoJCX0KCgkJaWYgKCBpbmxpbmUgKSB7CgkJCWNsYXNzZXMgKz0gIiB1aS1idG4taW5saW5lIjsKCQl9CgkJaWYgKCBtaW5pICkgewoJCQljbGFzc2VzICs9ICIgdWktbWluaSI7CgkJfQoKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0IiArIGNsYXNzZXMgKyAiJz4iICk7CgkJdGhpcy5zZWxlY3RJZCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICkgfHwgKCAic2VsZWN0LSIgKyB0aGlzLnV1aWQgKTsKCQl0aGlzLmJ1dHRvbklkID0gdGhpcy5zZWxlY3RJZCArICItYnV0dG9uIjsKCQl0aGlzLmxhYmVsID0gJCggImxhYmVsW2Zvcj0nIisgdGhpcy5zZWxlY3RJZCArIiddIiApOwoJCXRoaXMuaXNNdWx0aXBsZSA9IHRoaXMuc2VsZWN0WyAwIF0ubXVsdGlwbGU7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiLnVpLXNlbGVjdCIgKTsKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID4gMCApIHsKCQkJaWYgKCB3cmFwcGVyLmlzKCAiLnVpLWJ0bi1sZWZ0LCAudWktYnRuLXJpZ2h0IiApICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB3cmFwcGVyLmhhc0NsYXNzKCAidWktYnRuLWxlZnQiICkgPyAidWktYnRuLWxlZnQiIDogInVpLWJ0bi1yaWdodCIgKTsKCQkJfQoJCQl0aGlzLmVsZW1lbnQuaW5zZXJ0QWZ0ZXIoIHdyYXBwZXIgKTsKCQkJd3JhcHBlci5yZW1vdmUoKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJaWNvbnBvcyA9IG9wdGlvbnMuaWNvbiA/ICggb3B0aW9ucy5pY29ucG9zIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpY29ucG9zIiApICkgOiBmYWxzZSwKCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYXR0ciggImlkIiwgdGhpcy5idXR0b25JZCApCgkJCQkuYWRkQ2xhc3MoICJ1aS1idG4iICsKCQkJCQkoIG9wdGlvbnMuaWNvbiA/ICggIiB1aS1pY29uLSIgKyBvcHRpb25zLmljb24gKyAiIHVpLWJ0bi1pY29uLSIgKyBpY29ucG9zICsKCQkJCQkoIG9wdGlvbnMuaWNvbnNoYWRvdyA/ICIgdWktc2hhZG93LWljb24iIDogIiIgKSApIDoJIiIgKSArIC8qIFRPRE86IFJlbW92ZSBpbiAxLjUuICovCgkJCQkJKCBvcHRpb25zLnRoZW1lID8gIiB1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJCQkoIG9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApICsKCQkJCQkoIG9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiIgKSApOwoKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCgkJLy8gT3BlcmEgZG9lcyBub3QgcHJvcGVybHkgc3VwcG9ydCBvcGFjaXR5IG9uIHNlbGVjdCBlbGVtZW50cwoJCS8vIEluIE1pbmksIGl0IGhpZGVzIHRoZSBlbGVtZW50LCBidXQgbm90IGl0cyB0ZXh0CgkJLy8gT24gdGhlIGRlc2t0b3AsaXQgc2VlbXMgdG8gZG8gdGhlIG9wcG9zaXRlCgkJLy8gZm9yIHRoZXNlIHJlYXNvbnMsIHVzaW5nIHRoZSBuYXRpdmVNZW51IG9wdGlvbiByZXN1bHRzIGluIGEgZnVsbCBuYXRpdmUgc2VsZWN0IGluIE9wZXJhCgkJaWYgKCBvcHRpb25zLm5hdGl2ZU1lbnUgJiYgd2luZG93Lm9wZXJhICYmIHdpbmRvdy5vcGVyYS52ZXJzaW9uICkgewoJCQlidXR0b24uYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1ib2R5LWluaGVyaXQiICkKCQkJCS5oaWRlKCkKCQkJCS5hcHBlbmRUbyggYnV0dG9uLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiApKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gRXZlbnRzIG9uIG5hdGl2ZSBzZWxlY3QKCQl0aGlzLnNlbGVjdC5jaGFuZ2UoZnVuY3Rpb24oKSB7CgkJCXNlbGYucmVmcmVzaCgpOwoKCQkJaWYgKCAhIW9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJCXRoaXMuYmx1cigpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLl9vbiggdGhpcy5idXR0b24sIHsKCQkJa2V5ZG93bjogIl9oYW5kbGVLZXlkb3duIgoJCX0pOwoKCQl0aGlzLmJ1aWxkKCk7Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuc2VsZWN0CgkJCS5hcHBlbmRUbyggc2VsZi5idXR0b24gKQoJCQkuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCS8vIEFkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIHZtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoJCQl9KQoJCQkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCS8vIFJlbW92ZSBhY3RpdmUgY2xhc3Mgb24gc2Nyb2xsL3RvdWNobW92ZQoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIgdm1vdXNlb3V0IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3V0IiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KTsKCgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJc2VsZi5idXR0b24uYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYubGFiZWwuYmluZCggImNsaWNrIGZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuYnV0dG9uLmJpbmQoICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9LCAwICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkIiApOwoJfSwKCglzZWxlY3RlZEluZGljZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJcmV0dXJuIHRoaXMuc2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWxmLl9zZWxlY3RPcHRpb25zKCkuaW5kZXgoIHRoaXMgKTsKCQl9KS5nZXQoKTsKCX0sCgoJc2V0QnV0dG9uVGV4dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJdGV4dCA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCXNwYW4gPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApOwoKCQl0aGlzLmJ1dHRvbi5jaGlsZHJlbiggInNwYW4iICkubm90KCAiLnVpLWxpLWNvdW50IiApLnJlbW92ZSgpLmVuZCgpLmVuZCgpLnByZXBlbmQoIChmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxlY3RlZC5sZW5ndGggKSB7CgkJCQl0ZXh0ID0gc2VsZWN0ZWQubWFwKGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQkJfSkuZ2V0KCkuam9pbiggIiwgIiApOwoJCQl9IGVsc2UgewoJCQkJdGV4dCA9IHNlbGYucGxhY2Vob2xkZXI7CgkJCX0KCgkJCWlmICggdGV4dCApIHsKCQkJCXNwYW4udGV4dCggdGV4dCApOwoJCQl9IGVsc2UgewoKCQkJCS8vIFNldCB0aGUgY29udGVudHMgdG8gJm5ic3A7IHdoaWNoIHdlIHdyaXRlIGFzICYjMTYwOyB0byBiZSBYSFRNTCBjb21wbGlhbnQgLSBzZWUgZ2gtNjY5OQoJCQkJc3Bhbi5odG1sKCAiJiMxNjA7IiApOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4KCQkJCS5hZGRDbGFzcyggc2VsZi5zZWxlY3QuYXR0ciggImNsYXNzIiApICkKCQkJCS5hZGRDbGFzcyggc2VsZWN0ZWQuYXR0ciggImNsYXNzIiApICkKCQkJCS5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSkoKSk7Cgl9LAoKCXNldEJ1dHRvbkNvdW50OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCk7CgoJCS8vIG11bHRpcGxlIGNvdW50IGluc2lkZSBidXR0b24KCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudFsgc2VsZWN0ZWQubGVuZ3RoID4gMSA/ICJzaG93IiA6ICJoaWRlIiBdKCkudGV4dCggc2VsZWN0ZWQubGVuZ3RoICk7CgkJfQoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgewoJCXRoaXMuX2RlbGF5KCAiX3JlZnJlc2hCdXR0b24iICk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoQnV0dG9uOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCQl0aGlzLnNldEJ1dHRvbkNvdW50KCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2hCdXR0b24oKTsKCX0sCgoJLy8gb3BlbiBhbmQgY2xvc2UgcHJlc2VydmVkIGluIG5hdGl2ZSBzZWxlY3RzCgkvLyB0byBzaW1wbGlmeSB1c2VycyBjb2RlIHdoZW4gbG9vcGluZyBvdmVyIHNlbGVjdHMKCW9wZW46ICQubm9vcCwKCWNsb3NlOiAkLm5vb3AsCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saW5rcyA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcywgdGVzdHMgaW5jbHVkZWQgd2l0aCBwYWdlCgkkKCB0YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLmZpbHRlciggIjpqcW1EYXRhKHJlbD0ncG9wdXAnKVtocmVmXVtocmVmIT0nJ10iICkKCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCS8vIEFjY2Vzc2liaWxpdHkgaW5mbyBmb3IgcG9wdXBzCgkJCXZhciBlbGVtZW50ID0gdGhpcywKCQkJCWlkcmVmID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoICJocmVmIiApLnN1YnN0cmluZyggMSApOwoKCQkJaWYgKCBpZHJlZiApIHsKCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAiYXJpYS1oYXNwb3B1cCIsIHRydWUgKTsKCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAiYXJpYS1vd25zIiwgaWRyZWYgKTsKCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAiYXJpYS1leHBhbmRlZCIsIGZhbHNlICk7CgkJCX0KCQl9KQoJCS5lbmQoKQoJCS5ub3QoICIudWktYnRuLCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5hZGRDbGFzcyggInVpLWxpbmsiICk7Cgp9OwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKZnVuY3Rpb24gZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHdpbmRvd1NpemUsIHNlZ21lbnRTaXplLCBvZmZzZXQsIGRlc2lyZWQgKSB7Cgl2YXIgcmV0dXJuVmFsdWUgPSBkZXNpcmVkOwoKCWlmICggd2luZG93U2l6ZSA8IHNlZ21lbnRTaXplICkgewoJCS8vIENlbnRlciBzZWdtZW50IGlmIGl0J3MgYmlnZ2VyIHRoYW4gdGhlIHdpbmRvdwoJCXJldHVyblZhbHVlID0gb2Zmc2V0ICsgKCB3aW5kb3dTaXplIC0gc2VnbWVudFNpemUgKSAvIDI7Cgl9IGVsc2UgewoJCS8vIE90aGVyd2lzZSBjZW50ZXIgaXQgYXQgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZSB3aGlsZSBrZWVwaW5nIGl0IGNvbXBsZXRlbHkgaW5zaWRlIHRoZSB3aW5kb3cKCQlyZXR1cm5WYWx1ZSA9IE1hdGgubWluKCBNYXRoLm1heCggb2Zmc2V0LCBkZXNpcmVkIC0gc2VnbWVudFNpemUgLyAyICksIG9mZnNldCArIHdpbmRvd1NpemUgLSBzZWdtZW50U2l6ZSApOwoJfQoKCXJldHVybiByZXR1cm5WYWx1ZTsKfQoKZnVuY3Rpb24gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoZVdpbmRvdyApIHsKCXJldHVybiB7CgkJeDogdGhlV2luZG93LnNjcm9sbExlZnQoKSwKCQl5OiB0aGVXaW5kb3cuc2Nyb2xsVG9wKCksCgkJY3g6ICggdGhlV2luZG93WyAwIF0uaW5uZXJXaWR0aCB8fCB0aGVXaW5kb3cud2lkdGgoKSApLAoJCWN5OiAoIHRoZVdpbmRvd1sgMCBdLmlubmVySGVpZ2h0IHx8IHRoZVdpbmRvdy5oZWlnaHQoKSApCgl9Owp9CgokLndpZGdldCggIm1vYmlsZS5wb3B1cCIsIHsKCW9wdGlvbnM6IHsKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJdGhlbWU6IG51bGwsCgkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCXNoYWRvdzogdHJ1ZSwKCQljb3JuZXJzOiB0cnVlLAoJCXRyYW5zaXRpb246ICJub25lIiwKCQlwb3NpdGlvblRvOiAib3JpZ2luIiwKCQl0b2xlcmFuY2U6IG51bGwsCgkJY2xvc2VMaW5rU2VsZWN0b3I6ICJhOmpxbURhdGEocmVsPSdiYWNrJykiLAoJCWNsb3NlTGlua0V2ZW50czogImNsaWNrLnBvcHVwIiwKCQluYXZpZ2F0ZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIiwKCQljbG9zZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIHBhZ2ViZWZvcmVjaGFuZ2UucG9wdXAiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWVuaGFuY2VkOiBmYWxzZSwKCgkJLy8gTk9URSBXaW5kb3dzIFBob25lIDcgaGFzIGEgc2Nyb2xsIHBvc2l0aW9uIGNhY2hpbmcgaXNzdWUgdGhhdAoJCS8vICAgICAgcmVxdWlyZXMgdXMgdG8gZGlzYWJsZSBwb3B1cCBoaXN0b3J5IG1hbmFnZW1lbnQgYnkgZGVmYXVsdAoJCS8vICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80Nzg0CgkJLy8KCQkvLyBOT1RFIHRoaXMgb3B0aW9uIGlzIG1vZGlmaWVkIGluIF9jcmVhdGUhCgkJaGlzdG9yeTogISQubW9iaWxlLmJyb3dzZXIub2xkSUUKCX0sCgoJLy8gV2hlbiB0aGUgdXNlciBkZXByZXNzZXMgdGhlIG1vdXNlL2ZpbmdlciBvbiBhbiBlbGVtZW50IGluc2lkZSB0aGUgcG9wdXAgd2hpbGUgdGhlIHBvcHVwIGlzCgkvLyBvcGVuLCB3ZSBpZ25vcmUgcmVzaXplIGV2ZW50cyBmb3IgYSBzaG9ydCB3aGlsZS4gVGhpcyBwcmV2ZW50cyAjNjk2MS4KCV9oYW5kbGVEb2N1bWVudFZtb3VzZWRvd246IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiAkLmNvbnRhaW5zKCB0aGlzLl91aS5jb250YWluZXJbIDAgXSwgdGhlRXZlbnQudGFyZ2V0ICkgKSB7CgkJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoZUVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCgkJCW15SWQgPSB0aGVFbGVtZW50LmF0dHIoICJpZCIgKSwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFdlIG5lZWQgdG8gYWRqdXN0IHRoZSBoaXN0b3J5IG9wdGlvbiB0byBiZSBmYWxzZSBpZiB0aGVyZSdzIG5vIEFKQVggbmF2LgoJCS8vIFdlIGNhbid0IGRvIGl0IGluIHRoZSBvcHRpb24gZGVjbGFyYXRpb25zIGJlY2F1c2UgdGhvc2UgYXJlIHJ1biBiZWZvcmUKCQkvLyBpdCBpcyBkZXRlcm1pbmVkIHdoZXRoZXIgdGhlcmUgc2hhbGwgYmUgQUpBWCBuYXYuCgkJY3VycmVudE9wdGlvbnMuaGlzdG9yeSA9IGN1cnJlbnRPcHRpb25zLmhpc3RvcnkgJiYgJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQ7CgoJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7CgkJCSJ2bW91c2Vkb3duIjogIl9oYW5kbGVEb2N1bWVudFZtb3VzZWRvd24iCgkJfSk7CgoJCS8vIERlZmluZSBpbnN0YW5jZSB2YXJpYWJsZXMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfc2Nyb2xsVG9wOiAwLAoJCQlfcGFnZTogdGhlRWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCV91aTogbnVsbCwKCQkJX2ZhbGxiYWNrVHJhbnNpdGlvbjogIiIsCgkJCV9jdXJyZW50VHJhbnNpdGlvbjogZmFsc2UsCgkJCV9wcmVyZXF1aXNpdGVzOiBudWxsLAoJCQlfaXNPcGVuOiBmYWxzZSwKCQkJX3RvbGVyYW5jZTogbnVsbCwKCQkJX3Jlc2l6ZURhdGE6IG51bGwsCgkJCV9pZ25vcmVSZXNpemVUbzogMCwKCQkJX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzczogZmFsc2UKCQl9KTsKCgkJaWYgKCB0aGlzLl9wYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy5fcGFnZSA9ICQoICJib2R5IiApOwoJCX0KCgkJaWYgKCBjdXJyZW50T3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fdWkgPSB7CgkJCQljb250YWluZXI6IHRoZUVsZW1lbnQucGFyZW50KCksCgkJCQlzY3JlZW46IHRoZUVsZW1lbnQucGFyZW50KCkucHJldigpLAoJCQkJcGxhY2Vob2xkZXI6ICQoIHRoaXMuZG9jdW1lbnRbIDAgXS5nZXRFbGVtZW50QnlJZCggbXlJZCArICItcGxhY2Vob2xkZXIiICkgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSggdGhlRWxlbWVudCwgbXlJZCApOwoJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGN1cnJlbnRPcHRpb25zLnRyYW5zaXRpb24gKTsKCQl9CgkJdGhpcwoJCQkuX3NldFRvbGVyYW5jZSggY3VycmVudE9wdGlvbnMudG9sZXJhbmNlICkKCQkJLl91aS5mb2N1c0VsZW1lbnQgPSB0aGlzLl91aS5jb250YWluZXI7CgoJCS8vIEV2ZW50IGhhbmRsZXJzCgkJdGhpcy5fb24oIHRoaXMuX3VpLnNjcmVlbiwgeyAidmNsaWNrIjogIl9lYXRFdmVudEFuZENsb3NlIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCW9yaWVudGF0aW9uY2hhbmdlOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlIiApLAoJCQlyZXNpemU6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93UmVzaXplIiApLAoJCQlrZXl1cDogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dLZXlVcCIgKQoJCX0pOwoJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7ICJmb2N1c2luIjogIl9oYW5kbGVEb2N1bWVudEZvY3VzSW4iIH0gKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCB0aGVFbGVtZW50LCBteUlkICkgewoJCXZhciBjdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJd3JhcHBlckNsYXNzID0gY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzLAoJCQl1aSA9IHsKCQkJCXNjcmVlbjogJCggIjxkaXYgY2xhc3M9J3VpLXNjcmVlbi1oaWRkZW4gdWktcG9wdXAtc2NyZWVuICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIGN1cnJlbnRPcHRpb25zLm92ZXJsYXlUaGVtZSApICsgIic+PC9kaXY+IiApLAoJCQkJcGxhY2Vob2xkZXI6ICQoICI8ZGl2IHN0eWxlPSdkaXNwbGF5OiBub25lOyc+PCEtLSBwbGFjZWhvbGRlciAtLT48L2Rpdj4iICksCgkJCQljb250YWluZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1jb250YWluZXIgdWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiArCgkJCQkJKCB3cmFwcGVyQ2xhc3MgPyAoICIgIiArIHdyYXBwZXJDbGFzcyApIDogIiIgKSArICInPjwvZGl2PiIgKQoJCQl9LAoJCQlmcmFnbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCB1aS5zY3JlZW5bIDAgXSApOwoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCB1aS5jb250YWluZXJbIDAgXSApOwoKCQlpZiAoIG15SWQgKSB7CgkJCXVpLnNjcmVlbi5hdHRyKCAiaWQiLCBteUlkICsgIi1zY3JlZW4iICk7CgkJCXVpLmNvbnRhaW5lci5hdHRyKCAiaWQiLCBteUlkICsgIi1wb3B1cCIgKTsKCQkJdWkucGxhY2Vob2xkZXIKCQkJCS5hdHRyKCAiaWQiLCBteUlkICsgIi1wbGFjZWhvbGRlciIgKQoJCQkJLmh0bWwoICI8IS0tIHBsYWNlaG9sZGVyIGZvciAiICsgbXlJZCArICIgLS0+IiApOwoJCX0KCgkJLy8gQXBwbHkgdGhlIHByb3RvCgkJdGhpcy5fcGFnZVsgMCBdLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoJCS8vIExlYXZlIGEgcGxhY2Vob2xkZXIgd2hlcmUgdGhlIGVsZW1lbnQgdXNlZCB0byBiZQoJCXVpLnBsYWNlaG9sZGVyLmluc2VydEFmdGVyKCB0aGVFbGVtZW50ICk7CgkJdGhlRWxlbWVudAoJCQkuZGV0YWNoKCkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgY3VycmVudE9wdGlvbnMudGhlbWUgKSArICIgIiArCgkJCQkoIGN1cnJlbnRPcHRpb25zLnNoYWRvdyA/ICJ1aS1vdmVybGF5LXNoYWRvdyAiIDogIiIgKSArCgkJCQkoIGN1cnJlbnRPcHRpb25zLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSApCgkJCS5hcHBlbmRUbyggdWkuY29udGFpbmVyICk7CgoJCXJldHVybiB1aTsKCX0sCgoJX2VhdEV2ZW50QW5kQ2xvc2U6IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCXRoZUV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJLy8gTWFrZSBzdXJlIHRoZSBzY3JlZW4gY292ZXJzIHRoZSBlbnRpcmUgZG9jdW1lbnQgLSBDU1MgaXMgc29tZXRpbWVzIG5vdAoJLy8gZW5vdWdoIHRvIGFjY29tcGxpc2ggdGhpcy4KCV9yZXNpemVTY3JlZW46IGZ1bmN0aW9uKCkgewoJCXZhciBzY3JlZW4gPSB0aGlzLl91aS5zY3JlZW4sCgkJCXBvcHVwSGVpZ2h0ID0gdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICksCgkJCXNjcmVlbkhlaWdodCA9IHNjcmVlbi5yZW1vdmVBdHRyKCAic3R5bGUiICkuaGVpZ2h0KCksCgoJCQkvLyBTdWJ0cmFjdGluZyAxIGhlcmUgaXMgbmVjZXNzYXJ5IGZvciBhbiBvYnNjdXJlIEFuZHJkb2lkIDQuMCBidWcgd2hlcmUKCQkJLy8gdGhlIGJyb3dzZXIgaGFuZ3MgaWYgdGhlIHNjcmVlbiBjb3ZlcnMgdGhlIGVudGlyZSBkb2N1bWVudCA6LwoJCQlkb2N1bWVudEhlaWdodCA9IHRoaXMuZG9jdW1lbnQuaGVpZ2h0KCkgLSAxOwoKCQlpZiAoIHNjcmVlbkhlaWdodCA8IGRvY3VtZW50SGVpZ2h0ICkgewoJCQlzY3JlZW4uaGVpZ2h0KCBkb2N1bWVudEhlaWdodCApOwoJCX0gZWxzZSBpZiAoIHBvcHVwSGVpZ2h0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQlzY3JlZW4uaGVpZ2h0KCBwb3B1cEhlaWdodCApOwoJCX0KCX0sCgoJX2hhbmRsZVdpbmRvd0tleVVwOiBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gJiYgdGhlRXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FU0NBUEUgKSB7CgkJCXJldHVybiB0aGlzLl9lYXRFdmVudEFuZENsb3NlKCB0aGVFdmVudCApOwoJCX0KCX0sCgoJX2V4cGVjdFJlc2l6ZUV2ZW50OiBmdW5jdGlvbigpIHsKCQl2YXIgd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcyggdGhpcy53aW5kb3cgKTsKCgkJaWYgKCB0aGlzLl9yZXNpemVEYXRhICkgewoJCQlpZiAoIHdpbmRvd0Nvb3JkaW5hdGVzLnggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMueCAmJgoJCQkJd2luZG93Q29vcmRpbmF0ZXMueSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy55ICYmCgkJCQl3aW5kb3dDb29yZGluYXRlcy5jeCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy5jeCAmJgoJCQkJd2luZG93Q29vcmRpbmF0ZXMuY3kgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMuY3kgKSB7CgkJCQkvLyB0aW1lb3V0IG5vdCByZWZyZXNoZWQKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIHsKCQkJCS8vIGNsZWFyIGV4aXN0aW5nIHRpbWVvdXQgLSBpdCB3aWxsIGJlIHJlZnJlc2hlZCBiZWxvdwoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9yZXNpemVEYXRhLnRpbWVvdXRJZCApOwoJCQl9CgkJfQoKCQl0aGlzLl9yZXNpemVEYXRhID0gewoJCQl0aW1lb3V0SWQ6IHRoaXMuX2RlbGF5KCAiX3Jlc2l6ZVRpbWVvdXQiLCAyMDAgKSwKCQkJd2luZG93Q29vcmRpbmF0ZXM6IHdpbmRvd0Nvb3JkaW5hdGVzCgkJfTsKCgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9yZXNpemVUaW1lb3V0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJaWYgKCAhdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKSApIHsKCQkJCWlmICggdGhpcy5fdWkuY29udGFpbmVyLmhhc0NsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApICkgewoJCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLW9wZW4gdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICk7CgkJCQkJdGhpcy5yZXBvc2l0aW9uKCB7IHBvc2l0aW9uVG86ICJ3aW5kb3ciIH0gKTsKCQkJCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQkJCX0KCgkJCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJCX0KCQl9IGVsc2UgewoJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJfQoJfSwKCglfc3RvcElnbm9yaW5nUmVzaXplRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pZ25vcmVSZXNpemVUbyA9IDA7Cgl9LAoKCV9pZ25vcmVSZXNpemVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5faWdub3JlUmVzaXplVG8gKSB7CgkJCWNsZWFyVGltZW91dCggdGhpcy5faWdub3JlUmVzaXplVG8gKTsKCQl9CgkJdGhpcy5faWdub3JlUmVzaXplVG8gPSB0aGlzLl9kZWxheSggIl9zdG9wSWdub3JpbmdSZXNpemVFdmVudHMiLCAxMDAwICk7Cgl9LAoKCV9oYW5kbGVXaW5kb3dSZXNpemU6IGZ1bmN0aW9uKC8qIHRoZUV2ZW50ICovKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gJiYgdGhpcy5faWdub3JlUmVzaXplVG8gPT09IDAgKSB7CgkJCWlmICggKCB0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpIHx8IHRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyApICYmCgkJCQkhdGhpcy5fdWkuY29udGFpbmVyLmhhc0NsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApICkgewoJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtY2xvc2UgdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJCX0KCQl9Cgl9LAoKCV9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZTogZnVuY3Rpb24oLyogdGhlRXZlbnQgKi8pIHsKCQlpZiAoICF0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgJiYgdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQl0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpOwoJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSB0cnVlOwoJCX0KCX0sCgoJLy8gV2hlbiB0aGUgcG9wdXAgaXMgb3BlbiwgYXR0ZW1wdGluZyB0byBmb2N1cyBvbiBhbiBlbGVtZW50IHRoYXQgaXMgbm90IGEKCS8vIGNoaWxkIG9mIHRoZSBwb3B1cCB3aWxsIHJlZGlyZWN0IGZvY3VzIHRvIHRoZSBwb3B1cAoJX2hhbmRsZURvY3VtZW50Rm9jdXNJbjogZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCXZhciB0YXJnZXQsCgkJCXRhcmdldEVsZW1lbnQgPSB0aGVFdmVudC50YXJnZXQsCgkJCXVpID0gdGhpcy5fdWk7CgoJCWlmICggIXRoaXMuX2lzT3BlbiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0YXJnZXRFbGVtZW50ICE9PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJdGFyZ2V0ID0gJCggdGFyZ2V0RWxlbWVudCApOwoJCQlpZiAoIDAgPT09IHRhcmdldC5wYXJlbnRzKCkuZmlsdGVyKCB1aS5jb250YWluZXJbIDAgXSApLmxlbmd0aCApIHsKCQkJCSQoIHRoaXMuZG9jdW1lbnRbIDAgXS5hY3RpdmVFbGVtZW50ICkub25lKCAiZm9jdXMiLCBmdW5jdGlvbigvKiB0aGVFdmVudCAqLykgewoJCQkJCWlmICggdGFyZ2V0RWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAiYm9keSIgKSB7CgkJCQkgICAgICAgICAgICB0YXJnZXQuYmx1cigpOwoJCQkJICAgICAgICB9CgkJCQl9KTsKCQkJCXVpLmZvY3VzRWxlbWVudC5mb2N1cygpOwoJCQkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCXRoZUV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9IGVsc2UgaWYgKCB1aS5mb2N1c0VsZW1lbnRbIDAgXSA9PT0gdWkuY29udGFpbmVyWyAwIF0gKSB7CgkJCQl1aS5mb2N1c0VsZW1lbnQgPSB0YXJnZXQ7CgkJCX0KCQl9CgoJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiAoIHByZWZpeCArIHZhbHVlICkgKSA6ICggcHJlZml4ICsgImluaGVyaXQiICkgKTsKCX0sCgoJX2FwcGx5VHJhbnNpdGlvbjogZnVuY3Rpb24oIHZhbHVlICkgewoJCWlmICggdmFsdWUgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCWlmICggdmFsdWUgIT09ICJub25lIiApIHsKCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCQkJaWYgKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPT09ICJub25lIiApIHsKCQkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAiIjsKCQkJCX0KCQkJCXRoaXMuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG5ld09wdGlvbnMgKSB7CgkJdmFyIGN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQl0aGVFbGVtZW50ID0gdGhpcy5lbGVtZW50LAoJCQlzY3JlZW4gPSB0aGlzLl91aS5zY3JlZW47CgoJCWlmICggbmV3T3B0aW9ucy53cmFwcGVyQ2xhc3MgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkucmVtb3ZlQ2xhc3MoIGN1cnJlbnRPcHRpb25zLndyYXBwZXJDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIG5ld09wdGlvbnMud3JhcHBlckNsYXNzICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhlRWxlbWVudAoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgY3VycmVudE9wdGlvbnMudGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBuZXdPcHRpb25zLnRoZW1lICkgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy5vdmVybGF5VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJc2NyZWVuCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktb3ZlcmxheS0iLCBjdXJyZW50T3B0aW9ucy5vdmVybGF5VGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktb3ZlcmxheS0iLCBuZXdPcHRpb25zLm92ZXJsYXlUaGVtZSApICk7CgoJCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJCXNjcmVlbi5hZGRDbGFzcyggImluIiApOwoJCQl9CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoZUVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1vdmVybGF5LXNoYWRvdyIsIG5ld09wdGlvbnMuc2hhZG93ICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVFbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG5ld09wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnRyYW5zaXRpb24gIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAhdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIG5ld09wdGlvbnMudHJhbnNpdGlvbiApOwoJCQl9CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMudG9sZXJhbmNlICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldFRvbGVyYW5jZSggbmV3T3B0aW9ucy50b2xlcmFuY2UgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIG5ld09wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQl0aGlzLmNsb3NlKCk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9zdXBlciggbmV3T3B0aW9ucyApOwoJfSwKCglfc2V0VG9sZXJhbmNlOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIHRvbCA9IHsgdDogMzAsIHI6IDE1LCBiOiAzMCwgbDogMTUgfSwKCQkJYXI7CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJYXIgPSBTdHJpbmcoIHZhbHVlICkuc3BsaXQoICIsIiApOwoKCQkJJC5lYWNoKCBhciwgZnVuY3Rpb24oIGlkeCwgdmFsICkgeyBhclsgaWR4IF0gPSBwYXJzZUludCggdmFsLCAxMCApOyB9ICk7CgoJCQlzd2l0Y2goIGFyLmxlbmd0aCApIHsKCQkJCS8vIEFsbCB2YWx1ZXMgYXJlIHRvIGJlIHRoZSBzYW1lCgkJCQljYXNlIDE6CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJdG9sLnQgPSB0b2wuciA9IHRvbC5iID0gdG9sLmwgPSBhclsgMCBdOwoJCQkJCX0KCQkJCQlicmVhazsKCgkJCQkvLyBUaGUgZmlyc3QgdmFsdWUgZGVub3RlcyB0b3AvYm90dG9tIHRvbGVyYW5jZSwgYW5kIHRoZSBzZWNvbmQgdmFsdWUgZGVub3RlcyBsZWZ0L3JpZ2h0IHRvbGVyYW5jZQoJCQkJY2FzZSAyOgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gdG9sLmIgPSBhclsgMCBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQl0b2wubCA9IHRvbC5yID0gYXJbIDEgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJLy8gVGhlIGFycmF5IGNvbnRhaW5zIHZhbHVlcyBpbiB0aGUgb3JkZXIgdG9wLCByaWdodCwgYm90dG9tLCBsZWZ0CgkJCQljYXNlIDQ6CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJdG9sLnQgPSBhclsgMCBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQl0b2wuciA9IGFyWyAxIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMiBdICkgKSB7CgkJCQkJCXRvbC5iID0gYXJbIDIgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAzIF0gKSApIHsKCQkJCQkJdG9sLmwgPSBhclsgMyBdOwoJCQkJCX0KCQkJCQlicmVhazsKCgkJCQlkZWZhdWx0OgoJCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQl0aGlzLl90b2xlcmFuY2UgPSB0b2w7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9jbGFtcFBvcHVwV2lkdGg6IGZ1bmN0aW9uKCBpbmZvT25seSApIHsKCQl2YXIgbWVudVNpemUsCgkJCXdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoaXMud2luZG93ICksCgkJCS8vIHJlY3RhbmdsZSB3aXRoaW4gd2hpY2ggdGhlIHBvcHVwIG11c3QgZml0CgkJCXJlY3RhbmdsZSA9IHsKCQkJCXg6IHRoaXMuX3RvbGVyYW5jZS5sLAoJCQkJeTogd2luZG93Q29vcmRpbmF0ZXMueSArIHRoaXMuX3RvbGVyYW5jZS50LAoJCQkJY3g6IHdpbmRvd0Nvb3JkaW5hdGVzLmN4IC0gdGhpcy5fdG9sZXJhbmNlLmwgLSB0aGlzLl90b2xlcmFuY2UuciwKCQkJCWN5OiB3aW5kb3dDb29yZGluYXRlcy5jeSAtIHRoaXMuX3RvbGVyYW5jZS50IC0gdGhpcy5fdG9sZXJhbmNlLmIKCQkJfTsKCgkJaWYgKCAhaW5mb09ubHkgKSB7CgkJCS8vIENsYW1wIHRoZSB3aWR0aCBvZiB0aGUgbWVudSBiZWZvcmUgZ3JhYmJpbmcgaXRzIHNpemUKCQkJdGhpcy5fdWkuY29udGFpbmVyLmNzcyggIm1heC13aWR0aCIsIHJlY3RhbmdsZS5jeCApOwoJCX0KCgkJbWVudVNpemUgPSB7CgkJCWN4OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJXaWR0aCggdHJ1ZSApLAoJCQljeTogdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICkKCQl9OwoKCQlyZXR1cm4geyByYzogcmVjdGFuZ2xlLCBtZW51U2l6ZTogbWVudVNpemUgfTsKCX0sCgoJX2NhbGN1bGF0ZUZpbmFsTG9jYXRpb246IGZ1bmN0aW9uKCBkZXNpcmVkLCBjbGFtcEluZm8gKSB7CgkJdmFyIHJldHVyblZhbHVlLAoJCQlyZWN0YW5nbGUgPSBjbGFtcEluZm8ucmMsCgkJCW1lbnVTaXplID0gY2xhbXBJbmZvLm1lbnVTaXplOwoKCQkvLyBDZW50ZXIgdGhlIG1lbnUgb3ZlciB0aGUgZGVzaXJlZCBjb29yZGluYXRlcywgd2hpbGUgbm90IGdvaW5nIG91dHNpZGUKCQkvLyB0aGUgd2luZG93IHRvbGVyYW5jZXMuIFRoaXMgd2lsbCBjZW50ZXIgd3J0LiB0aGUgd2luZG93IGlmIHRoZSBwb3B1cCBpcwoJCS8vIHRvbyBsYXJnZS4KCQlyZXR1cm5WYWx1ZSA9IHsKCQkJbGVmdDogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJlY3RhbmdsZS5jeCwgbWVudVNpemUuY3gsIHJlY3RhbmdsZS54LCBkZXNpcmVkLnggKSwKCQkJdG9wOiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmVjdGFuZ2xlLmN5LCBtZW51U2l6ZS5jeSwgcmVjdGFuZ2xlLnksIGRlc2lyZWQueSApCgkJfTsKCgkJLy8gTWFrZSBzdXJlIHRoZSB0b3Agb2YgdGhlIG1lbnUgaXMgdmlzaWJsZQoJCXJldHVyblZhbHVlLnRvcCA9IE1hdGgubWF4KCAwLCByZXR1cm5WYWx1ZS50b3AgKTsKCgkJLy8gSWYgdGhlIGhlaWdodCBvZiB0aGUgbWVudSBpcyBzbWFsbGVyIHRoYW4gdGhlIGhlaWdodCBvZiB0aGUgZG9jdW1lbnQKCQkvLyBhbGlnbiB0aGUgYm90dG9tIHdpdGggdGhlIGJvdHRvbSBvZiB0aGUgZG9jdW1lbnQKCgkJcmV0dXJuVmFsdWUudG9wIC09IE1hdGgubWluKCByZXR1cm5WYWx1ZS50b3AsCgkJCU1hdGgubWF4KCAwLCByZXR1cm5WYWx1ZS50b3AgKyBtZW51U2l6ZS5jeSAtIHRoaXMuZG9jdW1lbnQuaGVpZ2h0KCkgKSApOwoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9LAoKCS8vIFRyeSBhbmQgY2VudGVyIHRoZSBvdmVybGF5IG92ZXIgdGhlIGdpdmVuIGNvb3JkaW5hdGVzCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQlyZXR1cm4gdGhpcy5fY2FsY3VsYXRlRmluYWxMb2NhdGlvbiggZGVzaXJlZCwgdGhpcy5fY2xhbXBQb3B1cFdpZHRoKCkgKTsKCX0sCgoJX2NyZWF0ZVByZXJlcXVpc2l0ZXM6IGZ1bmN0aW9uKCBzY3JlZW5QcmVyZXF1aXNpdGUsIGNvbnRhaW5lclByZXJlcXVpc2l0ZSwgd2hlbkRvbmUgKSB7CgkJdmFyIHByZXJlcXVpc2l0ZXMsCgkJCXNlbGYgPSB0aGlzOwoKCQkvLyBJdCBpcyBpbXBvcnRhbnQgdG8gbWFpbnRhaW4gYm90aCB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxdWlzaXRlcyBhbmQKCQkvLyBzZWxmLl9wcmVyZXF1aXNpdGVzLiBUaGUgbG9jYWwgdmFyaWFibGUgcmVtYWlucyBpbiB0aGUgY2xvc3VyZSBvZiB0aGUKCQkvLyBmdW5jdGlvbnMgd2hpY2ggY2FsbCB0aGUgY2FsbGJhY2tzIHBhc3NlZCBpbi4gVGhlIGNvbXBhcmlzb24gYmV0d2VlbiB0aGUKCQkvLyBsb2NhbCB2YXJpYWJsZSBhbmQgc2VsZi5fcHJlcmVxdWlzaXRlcyBpcyBuZWNlc3NhcnksIGJlY2F1c2Ugb25jZSBhCgkJLy8gZnVuY3Rpb24gaGFzIGJlZW4gcGFzc2VkIHRvIC5hbmltYXRpb25Db21wbGV0ZSgpIGl0IHdpbGwgYmUgY2FsbGVkIG5leHQKCQkvLyB0aW1lIGFuIGFuaW1hdGlvbiBjb21wbGV0ZXMsIGV2ZW4gaWYgdGhhdCdzIG5vdCB0aGUgYW5pbWF0aW9uIHdob3NlIGVuZAoJCS8vIHRoZSBmdW5jdGlvbiB3YXMgc3VwcG9zZWQgdG8gY2F0Y2ggKGZvciBleGFtcGxlLCBpZiBhbiBhYm9ydCBoYXBwZW5zCgkJLy8gZHVyaW5nIHRoZSBvcGVuaW5nIGFuaW1hdGlvbiwgdGhlIC5hbmltYXRpb25Db21wbGV0ZSBoYW5kbGVyIGlzIG5vdAoJCS8vIGNhbGxlZCBmb3IgdGhhdCBhbmltYXRpb24gYW55bW9yZSwgYnV0IHRoZSBoYW5kbGVyIHJlbWFpbnMgYXR0YWNoZWQsIHNvCgkJLy8gaXQgaXMgY2FsbGVkIHRoZSBuZXh0IHRpbWUgdGhlIHBvcHVwIGlzIG9wZW5lZCAtIG1ha2luZyBpdCBzdGFsZS4KCQkvLyBDb21wYXJpbmcgdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXVpc2l0ZXMgdG8gdGhlIHdpZGdldC1sZXZlbCB2YXJpYWJsZQoJCS8vIHNlbGYuX3ByZXJlcXVpc2l0ZXMgZW5zdXJlcyB0aGF0IGNhbGxiYWNrcyB0cmlnZ2VyZWQgYnkgYSBzdGFsZQoJCS8vIC5hbmltYXRpb25Db21wbGV0ZSB3aWxsIGJlIGlnbm9yZWQuCgoJCXByZXJlcXVpc2l0ZXMgPSB7CgkJCXNjcmVlbjogJC5EZWZlcnJlZCgpLAoJCQljb250YWluZXI6ICQuRGVmZXJyZWQoKQoJCX07CgoJCXByZXJlcXVpc2l0ZXMuc2NyZWVuLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQlzY3JlZW5QcmVyZXF1aXNpdGUoKTsKCQkJfQoJCX0pOwoKCQlwcmVyZXF1aXNpdGVzLmNvbnRhaW5lci50aGVuKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJY29udGFpbmVyUHJlcmVxdWlzaXRlKCk7CgkJCX0KCQl9KTsKCgkJJC53aGVuKCBwcmVyZXF1aXNpdGVzLnNjcmVlbiwgcHJlcmVxdWlzaXRlcy5jb250YWluZXIgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJc2VsZi5fcHJlcmVxdWlzaXRlcyA9IG51bGw7CgkJCQl3aGVuRG9uZSgpOwoJCQl9CgkJfSk7CgoJCXNlbGYuX3ByZXJlcXVpc2l0ZXMgPSBwcmVyZXF1aXNpdGVzOwoJfSwKCglfYW5pbWF0ZTogZnVuY3Rpb24oIGFyZ3MgKSB7CgkJLy8gTk9URSBiZWZvcmUgcmVtb3ZpbmcgdGhlIGRlZmF1bHQgYW5pbWF0aW9uIG9mIHRoZSBzY3JlZW4KCQkvLyAgICAgIHRoaXMgaGFkIGFuIGFuaW1hdGUgY2FsbGJhY2sgdGhhdCB3b3VsZCByZXNvbHZlIHRoZSBkZWZlcnJlZAoJCS8vICAgICAgbm93IHRoZSBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbW1lZGlhdGVseQoJCS8vIFRPRE8gcmVtb3ZlIHRoZSBkZXBlbmRlbmN5IG9uIHRoZSBzY3JlZW4gZGVmZXJyZWQKCQl0aGlzLl91aS5zY3JlZW4KCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkuYWRkQ2xhc3MoIGFyZ3Muc2NyZWVuQ2xhc3NUb0FkZCApOwoKCQlhcmdzLnByZXJlcXVpc2l0ZXMuc2NyZWVuLnJlc29sdmUoKTsKCgkJaWYgKCBhcmdzLnRyYW5zaXRpb24gJiYgYXJncy50cmFuc2l0aW9uICE9PSAibm9uZSIgKSB7CgkJCWlmICggYXJncy5hcHBseVRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGFyZ3MudHJhbnNpdGlvbiApOwoJCQl9CgkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFkZENsYXNzKCBhcmdzLmNvbnRhaW5lckNsYXNzVG9BZGQgKQoJCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoIGFyZ3MucHJlcmVxdWlzaXRlcy5jb250YWluZXIsICJyZXNvbHZlIiApICk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQlhcmdzLnByZXJlcXVpc2l0ZXMuY29udGFpbmVyLnJlc29sdmUoKTsKCX0sCgoJLy8gVGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgcGFzc2VkIGluIHdpbGwgYmUgcmV0dXJuZWQgdW50b3VjaGVkIGlmIG5vIHJlZmVyZW5jZSBlbGVtZW50IGNhbiBiZSBpZGVudGlmaWVkIHZpYQoJLy8gZGVzaXJlZFBvc2l0aW9uLnBvc2l0aW9uVG8uIE5ldmVydGhlbGVzcywgdGhpcyBmdW5jdGlvbiBlbnN1cmVzIHRoYXQgaXRzIHJldHVybiB2YWx1ZSBhbHdheXMgY29udGFpbnMgdmFsaWQKCS8vIHggYW5kIHkgY29vcmRpbmF0ZXMgYnkgc3BlY2lmeWluZyB0aGUgY2VudGVyIG1pZGRsZSBvZiB0aGUgd2luZG93IGlmIHRoZSBjb29yZGluYXRlcyBhcmUgYWJzZW50LgoJLy8gb3B0aW9uczogeyB4OiBjb29yZGluYXRlLCB5OiBjb29yZGluYXRlLCBwb3NpdGlvblRvOiBzdHJpbmc6ICJvcmlnaW4iLCAid2luZG93Iiwgb3IgalF1ZXJ5IHNlbGVjdG9yCglfZGVzaXJlZENvb3JkczogZnVuY3Rpb24oIG9wZW5PcHRpb25zICkgewoJCXZhciBvZmZzZXQsCgkJCWRzdCA9IG51bGwsCgkJCXdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoaXMud2luZG93ICksCgkJCXggPSBvcGVuT3B0aW9ucy54LAoJCQl5ID0gb3Blbk9wdGlvbnMueSwKCQkJcFRvID0gb3Blbk9wdGlvbnMucG9zaXRpb25UbzsKCgkJLy8gRXN0YWJsaXNoIHdoaWNoIGVsZW1lbnQgd2lsbCBzZXJ2ZSBhcyB0aGUgcmVmZXJlbmNlCgkJaWYgKCBwVG8gJiYgcFRvICE9PSAib3JpZ2luIiApIHsKCQkJaWYgKCBwVG8gPT09ICJ3aW5kb3ciICkgewoJCQkJeCA9IHdpbmRvd0Nvb3JkaW5hdGVzLmN4IC8gMiArIHdpbmRvd0Nvb3JkaW5hdGVzLng7CgkJCQl5ID0gd2luZG93Q29vcmRpbmF0ZXMuY3kgLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueTsKCQkJfSBlbHNlIHsKCQkJCXRyeSB7CgkJCQkJZHN0ID0gJCggcFRvICk7CgkJCQl9IGNhdGNoKCBlcnIgKSB7CgkJCQkJZHN0ID0gbnVsbDsKCQkJCX0KCQkJCWlmICggZHN0ICkgewoJCQkJCWRzdC5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCQkJCQlpZiAoIGRzdC5sZW5ndGggPT09IDAgKSB7CgkJCQkJCWRzdCA9IG51bGw7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQkvLyBJZiBhbiBlbGVtZW50IHdhcyBmb3VuZCwgY2VudGVyIG92ZXIgaXQKCQlpZiAoIGRzdCApIHsKCQkJb2Zmc2V0ID0gZHN0Lm9mZnNldCgpOwoJCQl4ID0gb2Zmc2V0LmxlZnQgKyBkc3Qub3V0ZXJXaWR0aCgpIC8gMjsKCQkJeSA9IG9mZnNldC50b3AgKyBkc3Qub3V0ZXJIZWlnaHQoKSAvIDI7CgkJfQoKCQkvLyBNYWtlIHN1cmUgeCBhbmQgeSBhcmUgdmFsaWQgbnVtYmVycyAtIGNlbnRlciBvdmVyIHRoZSB3aW5kb3cKCQlpZiAoICQudHlwZSggeCApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeCApICkgewoJCQl4ID0gd2luZG93Q29vcmRpbmF0ZXMuY3ggLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueDsKCQl9CgkJaWYgKCAkLnR5cGUoIHkgKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHkgKSApIHsKCQkJeSA9IHdpbmRvd0Nvb3JkaW5hdGVzLmN5IC8gMiArIHdpbmRvd0Nvb3JkaW5hdGVzLnk7CgkJfQoKCQlyZXR1cm4geyB4OiB4LCB5OiB5IH07Cgl9LAoKCV9yZXBvc2l0aW9uOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJLy8gV2Ugb25seSBjYXJlIGFib3V0IHBvc2l0aW9uLXJlbGF0ZWQgcGFyYW1ldGVycyBmb3IgcmVwb3NpdGlvbmluZwoJCW9wZW5PcHRpb25zID0gewoJCQl4OiBvcGVuT3B0aW9ucy54LAoJCQl5OiBvcGVuT3B0aW9ucy55LAoJCQlwb3NpdGlvblRvOiBvcGVuT3B0aW9ucy5wb3NpdGlvblRvCgkJfTsKCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlcG9zaXRpb24iLCB1bmRlZmluZWQsIG9wZW5PcHRpb25zICk7CgkJdGhpcy5fdWkuY29udGFpbmVyLm9mZnNldCggdGhpcy5fcGxhY2VtZW50Q29vcmRzKCB0aGlzLl9kZXNpcmVkQ29vcmRzKCBvcGVuT3B0aW9ucyApICkgKTsKCX0sCgoJcmVwb3NpdGlvbjogZnVuY3Rpb24oIG9wZW5PcHRpb25zICkgewoJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQl0aGlzLl9yZXBvc2l0aW9uKCBvcGVuT3B0aW9ucyApOwoJCX0KCX0sCgoJX29wZW5QcmVyZXF1aXNpdGVzQ29tcGxldGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICk7CgoJCXRoaXMuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQl0aGlzLl9pc09wZW4gPSB0cnVlOwoJCXRoaXMuX3Jlc2l6ZVNjcmVlbigpOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKS5mb2N1cygpOwoJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCWlmICggaWQgKSB7CgkJCXRoaXMuZG9jdW1lbnQuZmluZCggIlthcmlhLWhhc3BvcHVwPSd0cnVlJ11bYXJpYS1vd25zPSciICsgIGlkICsgIiddIiApLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgdHJ1ZSApOwoJCX0KCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJvcGVuIiApOwoJfSwKCglfb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIG9wZW5PcHRpb25zID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMgKSwKCQkJLy8gVE9ETyBtb3ZlIGJsYWNrbGlzdCB0byBwcml2YXRlIG1ldGhvZAoJCQlhbmRyb2lkQmxhY2tsaXN0ID0gKCBmdW5jdGlvbigpIHsKCQkJCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTlcLl0rKS8gKSwKCQkJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQkJCWFuZHJvaWRtYXRjaCA9IHVhLm1hdGNoKCAvQW5kcm9pZCAoXGQrKD86XC5cZCspKS8gKSwKCQkJCQlhbmR2ZXJzaW9uID0gISFhbmRyb2lkbWF0Y2ggJiYgYW5kcm9pZG1hdGNoWyAxIF0sCgkJCQkJY2hyb21lbWF0Y2ggPSB1YS5pbmRleE9mKCAiQ2hyb21lIiApID4gLTE7CgoJCQkJLy8gUGxhdGZvcm0gaXMgQW5kcm9pZCwgV2ViS2l0IHZlcnNpb24gaXMgZ3JlYXRlciB0aGFuIDUzNC4xMyAoIEFuZHJvaWQgMy4yLjEgKSBhbmQgbm90IENocm9tZS4KCQkJCWlmICggYW5kcm9pZG1hdGNoICE9PSBudWxsICYmIGFuZHZlcnNpb24gPT09ICI0LjAiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPiA1MzQuMTMgJiYgIWNocm9tZW1hdGNoICkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9KCkpOwoKCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJvcGVuIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJdGhpcy5fY3JlYXRlUHJlcmVxdWlzaXRlcygKCQkJJC5ub29wLAoJCQkkLm5vb3AsCgkJCSQucHJveHkoIHRoaXMsICJfb3BlblByZXJlcXVpc2l0ZXNDb21wbGV0ZSIgKSApOwoKCQl0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiA9IG9wZW5PcHRpb25zLnRyYW5zaXRpb247CgkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBvcGVuT3B0aW9ucy50cmFuc2l0aW9uICk7CgoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtdHJ1bmNhdGUiICk7CgoJCS8vIEdpdmUgYXBwbGljYXRpb25zIGEgY2hhbmNlIHRvIG1vZGlmeSB0aGUgY29udGVudHMgb2YgdGhlIGNvbnRhaW5lciBiZWZvcmUgaXQgYXBwZWFycwoJCXRoaXMuX3JlcG9zaXRpb24oIG9wZW5PcHRpb25zICk7CgoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICYmIGFuZHJvaWRCbGFja2xpc3QgKSB7CgkJCS8qIFRPRE86IFRoZSBuYXRpdmUgYnJvd3NlciBvbiBBbmRyb2lkIDQuMC5YICgiSWNlIENyZWFtIFNhbmR3aWNoIikgc3VmZmVycyBmcm9tIGFuIGlzc3VlIHdoZXJlIHRoZSBwb3B1cCBvdmVybGF5IGFwcGVhcnMgdG8gYmUgei1pbmRleGVkIGFib3ZlIHRoZSBwb3B1cCBpdHNlbGYgd2hlbiBjZXJ0YWluIG90aGVyIHN0eWxlcyBleGlzdCBvbiB0aGUgc2FtZSBwYWdlIC0tIG5hbWVseSwgYW55IGVsZW1lbnQgc2V0IHRvIGBwb3NpdGlvbjogZml4ZWRgIGFuZCBjZXJ0YWluIHR5cGVzIG9mIGlucHV0LiBUaGVzZSBpc3N1ZXMgYXJlIHJlbWluaXNjZW50IG9mIHByZXZpb3VzbHkgdW5jb3ZlcmVkIGJ1Z3MgaW4gb2xkZXIgdmVyc2lvbnMgb2YgQW5kcm9pZCdzIG5hdGl2ZSBicm93c2VyOiBodHRwczovL2dpdGh1Yi5jb20vc2NvdHRqZWhsL0RldmljZS1CdWdzL2lzc3Vlcy8zCgkJCVRoaXMgZml4IGNsb3NlcyB0aGUgZm9sbG93aW5nIGJ1Z3MgKCBJIHVzZSAiY2xvc2VzIiB3aXRoIHJlbHVjdGFuY2UsIGFuZCBzdHJlc3MgdGhhdCB0aGlzIGlzc3VlIHNob3VsZCBiZSByZXZpc2l0ZWQgYXMgc29vbiBhcyBwb3NzaWJsZSApOgoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4MTYKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODQ0CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg3NAoJCQkqLwoKCQkJLy8gVE9ETyBzb3J0IG91dCB3aHkgdGhpcy5fcGFnZSBpc24ndCB3b3JraW5nCgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoJCX0KCQl0aGlzLl9hbmltYXRlKHsKCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogb3Blbk9wdGlvbnMudHJhbnNpdGlvbiwKCQkJY2xhc3NUb1JlbW92ZTogIiIsCgkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJpbiIsCgkJCWNvbnRhaW5lckNsYXNzVG9BZGQ6ICJpbiIsCgkJCWFwcGx5VHJhbnNpdGlvbjogZmFsc2UsCgkJCXByZXJlcXVpc2l0ZXM6IHRoaXMuX3ByZXJlcXVpc2l0ZXMKCQl9KTsKCX0sCgoJX2Nsb3NlUHJlcmVxdWlzaXRlU2NyZWVuOiBmdW5jdGlvbigpIHsKCQl0aGlzLl91aS5zY3JlZW4KCQkJLnJlbW92ZUNsYXNzKCAib3V0IiApCgkJCS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7Cgl9LAoKCV9jbG9zZVByZXJlcXVpc2l0ZUNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyCgkJCS5yZW1vdmVDbGFzcyggInJldmVyc2Ugb3V0IiApCgkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKQoJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJfSwKCglfY2xvc2VQcmVyZXF1aXNpdGVzRG9uZTogZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnRhaW5lciA9IHRoaXMuX3VpLmNvbnRhaW5lciwKCQkJaWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApOwoKCQljb250YWluZXIucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoKCQkvLyByZW1vdmUgdGhlIGdsb2JhbCBtdXRleCBmb3IgcG9wdXBzCgkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdW5kZWZpbmVkOwoKCQkvLyBCbHVyIGVsZW1lbnRzIGluc2lkZSB0aGUgY29udGFpbmVyLCBpbmNsdWRpbmcgdGhlIGNvbnRhaW5lcgoJCSQoICI6Zm9jdXMiLCBjb250YWluZXJbIDAgXSApLmFkZCggY29udGFpbmVyWyAwIF0gKS5ibHVyKCk7CgoJCWlmICggaWQgKSB7CgkJCXRoaXMuZG9jdW1lbnQuZmluZCggIlthcmlhLWhhc3BvcHVwPSd0cnVlJ11bYXJpYS1vd25zPSciICsgIGlkICsgIiddIiApLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQl9CgoJCS8vIGFsZXJ0IHVzZXJzIHRoYXQgdGhlIHBvcHVwIGlzIGNsb3NlZAoJCXRoaXMuX3RyaWdnZXIoICJhZnRlcmNsb3NlIiApOwoJfSwKCglfY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoKCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsKCgkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyY2xvc2UiIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IHJldmVyc2UgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCXRoaXMuX2NyZWF0ZVByZXJlcXVpc2l0ZXMoCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXF1aXNpdGVTY3JlZW4iICksCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXF1aXNpdGVDb250YWluZXIiICksCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXF1aXNpdGVzRG9uZSIgKSApOwoKCQl0aGlzLl9hbmltYXRlKCB7CgkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRoaXMuX3VpLnNjcmVlbi5oYXNDbGFzcyggImluIiApLAoJCQl0cmFuc2l0aW9uOiAoIGltbWVkaWF0ZSA/ICJub25lIiA6ICggdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSApLAoJCQljbGFzc1RvUmVtb3ZlOiAiaW4iLAoJCQlzY3JlZW5DbGFzc1RvQWRkOiAib3V0IiwKCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogInJldmVyc2Ugb3V0IiwKCQkJYXBwbHlUcmFuc2l0aW9uOiB0cnVlLAoJCQlwcmVyZXF1aXNpdGVzOiB0aGlzLl9wcmVyZXF1aXNpdGVzCgkJfSk7Cgl9LAoKCV91bmVuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBQdXQgdGhlIGVsZW1lbnQgYmFjayB0byB3aGVyZSB0aGUgcGxhY2Vob2xkZXIgd2FzIGFuZCByZW1vdmUgdGhlICJ1aS1wb3B1cCIgY2xhc3MKCQl0aGlzLl9zZXRPcHRpb25zKCB7IHRoZW1lOiAkLm1vYmlsZS5wb3B1cC5wcm90b3R5cGUub3B0aW9ucy50aGVtZSB9ICk7CgkJdGhpcy5lbGVtZW50CgkJCS8vIENhbm5vdCBkaXJlY3RseSBpbnNlcnRBZnRlcigpIC0gd2UgbmVlZCB0byBkZXRhY2goKSBmaXJzdCwgYmVjYXVzZQoJCQkvLyBpbnNlcnRBZnRlcigpIHdpbGwgZG8gbm90aGluZyBpZiB0aGUgcGF5bG9hZCBkaXYgd2FzIG5vdCBhdHRhY2hlZAoJCQkvLyB0byB0aGUgRE9NIGF0IHRoZSB0aW1lIHRoZSB3aWRnZXQgd2FzIGNyZWF0ZWQsIGFuZCBzbyB0aGUgcGF5bG9hZAoJCQkvLyB3aWxsIHJlbWFpbiBpbnNpZGUgdGhlIGNvbnRhaW5lciBldmVuIGFmdGVyIHdlIGNhbGwgaW5zZXJ0QWZ0ZXIoKS4KCQkJLy8gSWYgdGhhdCBoYXBwZW5zIGFuZCB3ZSByZW1vdmUgdGhlIGNvbnRhaW5lciBhIGZldyBsaW5lcyBiZWxvdywgd2UKCQkJLy8gd2lsbCBjYXVzZSBhbiBpbmZpbml0ZSByZWN1cnNpb24gLSAjNTI0NAoJCQkuZGV0YWNoKCkKCQkJLmluc2VydEFmdGVyKCB0aGlzLl91aS5wbGFjZWhvbGRlciApCgkJCS5yZW1vdmVDbGFzcyggInVpLXBvcHVwIHVpLW92ZXJsYXktc2hhZG93IHVpLWNvcm5lci1hbGwgdWktYm9keS1pbmhlcml0IiApOwoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmUoKTsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlKCk7CgkJdGhpcy5fdWkucGxhY2Vob2xkZXIucmVtb3ZlKCk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9PT0gdGhpcyApIHsKCQkJdGhpcy5lbGVtZW50Lm9uZSggInBvcHVwYWZ0ZXJjbG9zZSIsICQucHJveHkoIHRoaXMsICJfdW5lbmhhbmNlIiApICk7CgkJCXRoaXMuY2xvc2UoKTsKCQl9IGVsc2UgewoJCQl0aGlzLl91bmVuaGFuY2UoKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglfY2xvc2VQb3B1cDogZnVuY3Rpb24oIHRoZUV2ZW50LCBkYXRhICkgewoJCXZhciBwYXJzZWREc3QsIHRvVXJsLAoJCQljdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJaW1tZWRpYXRlID0gZmFsc2U7CgoJCWlmICggKCB0aGVFdmVudCAmJiB0aGVFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHx8ICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gcmVzdG9yZSBsb2NhdGlvbiBvbiBzY3JlZW4KCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHRoaXMuX3Njcm9sbFRvcCApOwoKCQlpZiAoIHRoZUV2ZW50ICYmIHRoZUV2ZW50LnR5cGUgPT09ICJwYWdlYmVmb3JlY2hhbmdlIiAmJiBkYXRhICkgewoJCQkvLyBEZXRlcm1pbmUgd2hldGhlciB3ZSBuZWVkIHRvIHJhcGlkLWNsb3NlIHRoZSBwb3B1cCwgb3Igd2hldGhlciB3ZSBjYW4KCQkJLy8gdGFrZSB0aGUgdGltZSB0byBydW4gdGhlIGNsb3NpbmcgdHJhbnNpdGlvbgoJCQlpZiAoIHR5cGVvZiBkYXRhLnRvUGFnZSA9PT0gInN0cmluZyIgKSB7CgkJCQlwYXJzZWREc3QgPSBkYXRhLnRvUGFnZTsKCQkJfSBlbHNlIHsKCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCX0KCQkJcGFyc2VkRHN0ID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggcGFyc2VkRHN0ICk7CgkJCXRvVXJsID0gcGFyc2VkRHN0LnBhdGhuYW1lICsgcGFyc2VkRHN0LnNlYXJjaCArIHBhcnNlZERzdC5oYXNoOwoKCQkJaWYgKCB0aGlzLl9teVVybCAhPT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvVXJsICkgKSB7CgkJCQkvLyBHb2luZyB0byBhIGRpZmZlcmVudCBwYWdlIC0gY2xvc2UgaW1tZWRpYXRlbHkKCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCX0gZWxzZSB7CgkJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfQoKCQkvLyByZW1vdmUgbmF2IGJpbmRpbmdzCgkJdGhpcy53aW5kb3cub2ZmKCBjdXJyZW50T3B0aW9ucy5jbG9zZUV2ZW50cyApOwoJCS8vIHVuYmluZCBjbGljayBoYW5kbGVycyBhZGRlZCB3aGVuIGhpc3RvcnkgaXMgZGlzYWJsZWQKCQl0aGlzLmVsZW1lbnQudW5kZWxlZ2F0ZSggY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rU2VsZWN0b3IsIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua0V2ZW50cyApOwoKCQl0aGlzLl9jbG9zZSggaW1tZWRpYXRlICk7Cgl9LAoKCS8vIGFueSBuYXZpZ2F0aW9uIGV2ZW50IGFmdGVyIGEgcG9wdXAgaXMgb3BlbmVkIHNob3VsZCBjbG9zZSB0aGUgcG9wdXAKCS8vIE5PVEUgdGhlIHBhZ2ViZWZvcmVjaGFuZ2UgaXMgYm91bmQgdG8gY2F0Y2ggbmF2aWdhdGlvbiBldmVudHMgdGhhdCBkb24ndAoJLy8gICAgICBhbHRlciB0aGUgdXJsIChlZywgZGlhbG9ncyBmcm9tIHBvcHVwcykKCV9iaW5kQ29udGFpbmVyQ2xvc2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMud2luZG93CgkJCS5vbiggdGhpcy5vcHRpb25zLmNsb3NlRXZlbnRzLCAkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUG9wdXAiICkgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fdWkuY29udGFpbmVyOwoJfSwKCgkvLyBUT0RPIG5vIGNsZWFyIGRlbGluaWF0aW9uIG9mIHdoYXQgc2hvdWxkIGJlIGhlcmUgYW5kCgkvLyB3aGF0IHNob3VsZCBiZSBpbiBfb3Blbi4gU2VlbXMgdG8gYmUgInZpc3VhbCIgdnMgImhpc3RvcnkiIGZvciBub3cKCW9wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciB1cmwsIGhhc2hrZXksIGFjdGl2ZVBhZ2UsIGN1cnJlbnRJc0RpYWxvZywgaGFzSGFzaCwgdXJsSGlzdG9yeSwKCQkJc2VsZiA9IHRoaXMsCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQkvLyBtYWtlIHN1cmUgb3BlbiBpcyBpZGVtcG90ZW50CgkJaWYgKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgfHwgY3VycmVudE9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gc2V0IHRoZSBnbG9iYWwgcG9wdXAgbXV0ZXgKCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB0aGlzOwoJCXRoaXMuX3Njcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpOwoKCQkvLyBpZiBoaXN0b3J5IGFsdGVyYXRpb24gaXMgZGlzYWJsZWQgY2xvc2Ugb24gbmF2aWdhdGUgZXZlbnRzCgkJLy8gYW5kIGxlYXZlIHRoZSB1cmwgYXMgaXMKCQlpZiAoICEoIGN1cnJlbnRPcHRpb25zLmhpc3RvcnkgKSApIHsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCgkJCS8vIFdoZW4gaGlzdG95IGlzIGRpc2FibGVkIHdlIGhhdmUgdG8gZ3JhYiB0aGUgZGF0YS1yZWwKCQkJLy8gYmFjayBsaW5rIGNsaWNrcyBzbyB3ZSBjYW4gY2xvc2UgdGhlIHBvcHVwIGluc3RlYWQgb2YKCQkJLy8gcmVseWluZyBvbiBoaXN0b3J5IHRvIGRvIGl0IGZvciB1cwoJCQlzZWxmLmVsZW1lbnQKCQkJCS5kZWxlZ2F0ZSggY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rU2VsZWN0b3IsIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua0V2ZW50cywgZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCS8vIGNhY2hlIHNvbWUgdmFsdWVzIGZvciBtaW4vcmVhZGFiaWxpdHkKCQl1cmxIaXN0b3J5ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeTsKCQloYXNoa2V5ID0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQlhY3RpdmVQYWdlID0gJC5tb2JpbGUuYWN0aXZlUGFnZTsKCQljdXJyZW50SXNEaWFsb2cgPSAoIGFjdGl2ZVBhZ2UgPyBhY3RpdmVQYWdlLmhhc0NsYXNzKCAidWktZGlhbG9nIiApIDogZmFsc2UgKTsKCQl0aGlzLl9teVVybCA9IHVybCA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCkudXJsOwoJCWhhc0hhc2ggPSAoIHVybC5pbmRleE9mKCBoYXNoa2V5ICkgPiAtMSApICYmICFjdXJyZW50SXNEaWFsb2cgJiYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApOwoKCQlpZiAoIGhhc0hhc2ggKSB7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gaWYgdGhlIGN1cnJlbnQgdXJsIGhhcyBubyBkaWFsb2cgaGFzaCBrZXkgcHJvY2VlZCBhcyBub3JtYWwKCQkvLyBvdGhlcndpc2UsIGlmIHRoZSBwYWdlIGlzIGEgZGlhbG9nIHNpbXBseSB0YWNrIG9uIHRoZSBoYXNoIGtleQoJCWlmICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA9PT0gLTEgJiYgIWN1cnJlbnRJc0RpYWxvZyApIHsKCQkJdXJsID0gdXJsICsgKHVybC5pbmRleE9mKCAiIyIgKSA+IC0xID8gaGFzaGtleSA6ICIjIiArIGhhc2hrZXkpOwoJCX0gZWxzZSB7CgkJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2ggKyBoYXNoa2V5OwoJCX0KCgkJLy8gc3dhbGxvdyB0aGUgdGhlIGluaXRpYWwgbmF2aWdhdGlvbiBldmVudCwgYW5kIGJpbmQgZm9yIHRoZSBuZXh0CgkJdGhpcy53aW5kb3cub25lKCAiYmVmb3JlbmF2aWdhdGUiLCBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJfSk7CgoJCXRoaXMudXJsQWx0ZXJlZCA9IHRydWU7CgkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwgeyByb2xlOiAiZGlhbG9nIiB9ICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9zZTogZnVuY3Rpb24oKSB7CgkJLy8gbWFrZSBzdXJlIGNsb3NlIGlzIGlkZW1wb3RlbnQKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQl0aGlzLl9zY3JvbGxUb3AgPSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlzdG9yeSAmJiB0aGlzLnVybEFsdGVyZWQgKSB7CgkJCSQubW9iaWxlLmJhY2soKTsKCQkJdGhpcy51cmxBbHRlcmVkID0gZmFsc2U7CgkJfSBlbHNlIHsKCQkJLy8gc2ltdWxhdGUgdGhlIG5hdiBiaW5kaW5ncyBoYXZpbmcgZmlyZWQKCQkJdGhpcy5fY2xvc2VQb3B1cCgpOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9Cn0pOwoKLy8gVE9ETyB0aGlzIGNhbiBiZSBtb3ZlZCBpbnNpZGUgdGhlIHdpZGdldAokLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rID0gZnVuY3Rpb24oICRsaW5rICkgewoJdmFyIG9mZnNldCwKCQlwYXRoID0gJC5tb2JpbGUucGF0aCwKCgkJLy8gTk9URSBtYWtlIHN1cmUgdG8gZ2V0IG9ubHkgdGhlIGhhc2ggZnJvbSB0aGUgaHJlZiBiZWNhdXNlIGllNyAod3A3KQoJCS8vICAgICAgcmV0dXJucyB0aGUgYWJzb2x1dGUgaHJlZiBpbiB0aGlzIGNhc2UgcnVpbmluZyB0aGUgZWxlbWVudCBzZWxlY3Rpb24KCQlwb3B1cCA9ICQoIHBhdGguaGFzaFRvU2VsZWN0b3IoIHBhdGgucGFyc2VVcmwoICRsaW5rLmF0dHIoICJocmVmIiApICkuaGFzaCApICkuZmlyc3QoKTsKCglpZiAoIHBvcHVwLmxlbmd0aCA+IDAgJiYgcG9wdXAuZGF0YSggIm1vYmlsZS1wb3B1cCIgKSApIHsKCQlvZmZzZXQgPSAkbGluay5vZmZzZXQoKTsKCQlwb3B1cC5wb3B1cCggIm9wZW4iLCB7CgkJCXg6IG9mZnNldC5sZWZ0ICsgJGxpbmsub3V0ZXJXaWR0aCgpIC8gMiwKCQkJeTogb2Zmc2V0LnRvcCArICRsaW5rLm91dGVySGVpZ2h0KCkgLyAyLAoJCQl0cmFuc2l0aW9uOiAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJcG9zaXRpb25UbzogJGxpbmsuanFtRGF0YSggInBvc2l0aW9uLXRvIiApCgkJfSk7Cgl9CgoJLy9yZW1vdmUgYWZ0ZXIgZGVsYXkKCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCSRsaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJfSwgMzAwICk7Cn07CgovLyBUT0RPIG1vdmUgaW5zaWRlIF9jcmVhdGUKJC5tb2JpbGUuZG9jdW1lbnQub24oICJwYWdlYmVmb3JlY2hhbmdlIiwgZnVuY3Rpb24oIHRoZUV2ZW50LCBkYXRhICkgewoJaWYgKCBkYXRhLm9wdGlvbnMucm9sZSA9PT0gInBvcHVwIiApIHsKCQkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rKCBkYXRhLm9wdGlvbnMubGluayApOwoJCXRoZUV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKLyoKKiBjdXN0b20gInNlbGVjdG1lbnUiIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdW5mb2N1c2FibGVJdGVtU2VsZWN0b3IgPSAiLnVpLWRpc2FibGVkLC51aS1zdGF0ZS1kaXNhYmxlZCwudWktbGktZGl2aWRlciwudWktc2NyZWVuLWhpZGRlbiw6anFtRGF0YShyb2xlPSdwbGFjZWhvbGRlcicpIiwKCWdvVG9BZGphY2VudEl0ZW0gPSBmdW5jdGlvbiggaXRlbSwgdGFyZ2V0LCBkaXJlY3Rpb24gKSB7CgkJdmFyIGFkamFjZW50ID0gaXRlbVsgZGlyZWN0aW9uICsgIkFsbCIgXSgpCgkJCS5ub3QoIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yICkKCQkJLmZpcnN0KCk7CgoJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJaWYgKCBhZGphY2VudC5sZW5ndGggKSB7CgkJCXRhcmdldAoJCQkJLmJsdXIoKQoJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCWFkamFjZW50LmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQl9Cgl9OwoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLnNlbGVjdG1lbnUsIHsKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBDdXN0b20gc2VsZWN0cyBjYW5ub3QgZXhpc3QgaW5zaWRlIHBvcHVwcywgc28gcmV2ZXJ0IHRoZSAibmF0aXZlTWVudSIKCQkvLyBvcHRpb24gdG8gdHJ1ZSBpZiBhIHBhcmVudCBpcyBhIHBvcHVwCgkJby5uYXRpdmVNZW51ID0gby5uYXRpdmVNZW51IHx8ICggdGhpcy5lbGVtZW50LnBhcmVudHMoICI6anFtRGF0YShyb2xlPSdwb3B1cCcpLDptb2JpbGUtcG9wdXAiICkubGVuZ3RoID4gMCApOwoKCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0sCgoJX2hhbmRsZVNlbGVjdEZvY3VzOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYmx1cigpOwoJCXRoaXMuYnV0dG9uLmZvY3VzKCk7Cgl9LAoKCV9oYW5kbGVLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5fc3VwZXIoIGV2ZW50ICk7CgkJdGhpcy5faGFuZGxlQnV0dG9uVmNsaWNrS2V5ZG93biggZXZlbnQgKTsKCX0sCgoJX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmlzT3BlbiB8fCB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siIHx8CgkJCQlldmVudC5rZXlDb2RlICYmIChldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8IGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuU1BBQ0UpKSB7CgoJCQl0aGlzLl9kZWNpZGVGb3JtYXQoKTsKCQkJaWYgKCB0aGlzLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCQl0aGlzLmJ1dHRvbi5hdHRyKCAiaHJlZiIsICIjIiArIHRoaXMucG9wdXBJZCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgInBvcHVwIiApOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyB0aGlzLmRpYWxvZ0lkICkuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJyZWwiLCAiZGlhbG9nIiApOwoJCQl9CgkJCXRoaXMuaXNPcGVuID0gdHJ1ZTsKCQkJLy8gRG8gbm90IHByZXZlbnQgZGVmYXVsdCwgc28gdGhlIG5hdmlnYXRpb24gbWF5IGhhdmUgYSBjaGFuY2UgdG8gYWN0dWFsbHkgb3BlbiB0aGUgY2hvc2VuIGZvcm1hdAoJCX0KCX0sCgoJX2hhbmRsZUxpc3RGb2N1czogZnVuY3Rpb24oIGUgKSB7CgkJdmFyIHBhcmFtcyA9ICggZS50eXBlID09PSAiZm9jdXNpbiIgKSA/CgkJCXsgdGFiaW5kZXg6ICIwIiwgZXZlbnQ6ICJ2bW91c2VvdmVyIiB9OgoJCQl7IHRhYmluZGV4OiAiLTEiLCBldmVudDogInZtb3VzZW91dCIgfTsKCgkJJCggZS50YXJnZXQgKQoJCQkuYXR0ciggInRhYmluZGV4IiwgcGFyYW1zLnRhYmluZGV4ICkKCQkJLnRyaWdnZXIoIHBhcmFtcy5ldmVudCApOwoJfSwKCglfaGFuZGxlTGlzdEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICksCgkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKTsKCgkJLy8gc3dpdGNoIGxvZ2ljIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCWNhc2UgMzg6CgkJCWdvVG9BZGphY2VudEl0ZW0oIGxpLCB0YXJnZXQsICJwcmV2IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJCS8vIGRvd24gb3IgcmlnaHQgYXJyb3cga2V5cwoJCWNhc2UgNDA6CgkJCWdvVG9BZGphY2VudEl0ZW0oIGxpLCB0YXJnZXQsICJuZXh0IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJCS8vIElmIGVudGVyIG9yIHNwYWNlIGlzIHByZXNzZWQsIHRyaWdnZXIgY2xpY2sKCQljYXNlIDEzOgoJCWNhc2UgMzI6CgkJCXRhcmdldC50cmlnZ2VyKCAiY2xpY2siICk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9oYW5kbGVNZW51UGFnZUhpZGU6IGZ1bmN0aW9uKCkgewoKCQkvLyBBZnRlciB0aGUgZGlhbG9nJ3MgZG9uZSwgd2UgbWF5IHdhbnQgdG8gdHJpZ2dlciBjaGFuZ2UgaWYgdGhlIHZhbHVlIGhhcyBhY3R1YWxseSBjaGFuZ2VkCgkJdGhpcy5fZGVsYXllZFRyaWdnZXIoKTsKCgkJLy8gVE9ETyBjZW50cmFsaXplIHBhZ2UgcmVtb3ZhbCBiaW5kaW5nIC8gaGFuZGxpbmcgaW4gdGhlIHBhZ2UgcGx1Z2luLgoJCS8vIFN1Z2dlc3Rpb24gZnJvbSBAamJsYXMgdG8gZG8gcmVmY291bnRpbmcKCQkvLwoJCS8vIFRPRE8gZXh0cmVtZWx5IGNvbmZ1c2luZyBkZXBlbmRlbmN5IG9uIHRoZSBvcGVuIG1ldGhvZCB3aGVyZSB0aGUgcGFnZWhpZGUucmVtb3ZlCgkJLy8gYmluZGluZ3MgYXJlIHN0cmlwcGVkIHRvIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gZGlzYXBwZWFyaW5nLiBUaGUgd2F5CgkJLy8gd2UncmUga2VlcGluZyBwYWdlcyBpbiB0aGUgRE9NIHJpZ2h0IG5vdyBzdWNrcwoJCS8vCgkJLy8gcmViaW5kIHRoZSBwYWdlIHJlbW92ZSB0aGF0IHdhcyB1bmJvdW5kIGluIHRoZSBvcGVuIGZ1bmN0aW9uCgkJLy8gdG8gYWxsb3cgZm9yIHRoZSBwYXJlbnQgcGFnZSByZW1vdmFsIGZyb20gYWN0aW9ucyBvdGhlciB0aGFuIHRoZSB1c2UKCQkvLyBvZiBhIGRpYWxvZyBzaXplZCBjdXN0b20gc2VsZWN0CgkJLy8KCQkvLyBkb2luZyB0aGlzIGhlcmUgcHJvdmlkZXMgZm9yIHRoZSBiYWNrIGJ1dHRvbiBvbiB0aGUgY3VzdG9tIHNlbGVjdCBkaWFsb2cKCQl0aGlzLnRoaXNQYWdlLnBhZ2UoICJiaW5kUmVtb3ZlIiApOwoJfSwKCglfaGFuZGxlSGVhZGVyQ2xvc2VDbGljazogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCXRoaXMuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJX2hhbmRsZUxpc3RJdGVtQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgbGlzdEl0ZW0gPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCAibGkiICksCgoJCQkvLyBJbmRleCBvZiBvcHRpb24gdGFnIHRvIGJlIHNlbGVjdGVkCgkJCW9sZEluZGV4ID0gdGhpcy5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQluZXdJbmRleCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggbGlzdEl0ZW0sICJvcHRpb24taW5kZXgiICksCgkJCW9wdGlvbiA9IHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkvLyBUb2dnbGUgc2VsZWN0ZWQgc3RhdHVzIG9uIHRoZSB0YWcgZm9yIG11bHRpIHNlbGVjdHMKCQlvcHRpb24uc2VsZWN0ZWQgPSB0aGlzLmlzTXVsdGlwbGUgPyAhb3B0aW9uLnNlbGVjdGVkIDogdHJ1ZTsKCgkJLy8gVG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCWxpc3RJdGVtLmZpbmQoICJhIiApCgkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jaGVja2JveC1vZmYiLCAhb3B0aW9uLnNlbGVjdGVkICk7CgkJfQoKCQkvLyBJZiBpdCdzIG5vdCBhIG11bHRpcGxlIHNlbGVjdCwgdHJpZ2dlciBjaGFuZ2UgYWZ0ZXIgaXQgaGFzIGZpbmlzaGVkIGNsb3NpbmcKCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgb2xkSW5kZXggIT09IG5ld0luZGV4ICkgewoJCQl0aGlzLl90cmlnZ2VyQ2hhbmdlID0gdHJ1ZTsKCQl9CgoJCS8vIFRyaWdnZXIgY2hhbmdlIGlmIGl0J3MgYSBtdWx0aXBsZSBzZWxlY3QKCQkvLyBIaWRlIGN1c3RvbSBzZWxlY3QgZm9yIHNpbmdsZSBzZWxlY3RzIG9ubHkgLSBvdGhlcndpc2UgZm9jdXMgY2xpY2tlZCBpdGVtCgkJLy8gV2UgbmVlZCB0byBncmFiIHRoZSBjbGlja2VkIGl0ZW0gdGhlIGhhcmQgd2F5LCBiZWNhdXNlIHRoZSBsaXN0IG1heSBoYXZlIGJlZW4gcmVidWlsdAoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLnNlbGVjdC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl0aGlzLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuZXEoIG5ld0luZGV4ICkKCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJfQoJCWVsc2UgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoKCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdElkLCBwb3B1cElkLCBkaWFsb2dJZCwgbGFiZWwsIHRoaXNQYWdlLCBpc011bHRpcGxlLCBtZW51SWQsCgkJCXRoZW1lQXR0ciwgb3ZlcmxheVRoZW1lLCBvdmVybGF5VGhlbWVBdHRyLCBkaXZpZGVyVGhlbWVBdHRyLAoJCQltZW51UGFnZSwgbGlzdGJveCwgbGlzdCwgaGVhZGVyLCBoZWFkZXJUaXRsZSwgbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlLCBoZWFkZXJDbG9zZSwKCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvLm5hdGl2ZU1lbnUgKSB7CgkJCXJldHVybiB0aGlzLl9zdXBlcigpOwoJCX0KCgkJc2VsZWN0SWQgPSB0aGlzLnNlbGVjdElkOwoJCXBvcHVwSWQgPSBzZWxlY3RJZCArICItbGlzdGJveCI7CgkJZGlhbG9nSWQgPSBzZWxlY3RJZCArICItZGlhbG9nIjsKCQlsYWJlbCA9IHRoaXMubGFiZWw7CgkJdGhpc1BhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCWlzTXVsdGlwbGUgPSB0aGlzLmVsZW1lbnRbIDAgXS5tdWx0aXBsZTsKCQltZW51SWQgPSBzZWxlY3RJZCArICItbWVudSI7CgkJdGhlbWVBdHRyID0gby50aGVtZSA/ICggIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZT0nIiArIG8udGhlbWUgKyAiJyIgKSA6ICIiOwoJCW92ZXJsYXlUaGVtZSA9IG8ub3ZlcmxheVRoZW1lIHx8IG8udGhlbWUgfHwgbnVsbDsKCQlvdmVybGF5VGhlbWVBdHRyID0gb3ZlcmxheVRoZW1lID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsKCQkJIm92ZXJsYXktdGhlbWU9JyIgKyBvdmVybGF5VGhlbWUgKyAiJyIgKSA6ICIiOwoJCWRpdmlkZXJUaGVtZUF0dHIgPSAoIG8uZGl2aWRlclRoZW1lICYmIGlzTXVsdGlwbGUgKSA/ICggIiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJkaXZpZGVyLXRoZW1lPSciICsgby5kaXZpZGVyVGhlbWUgKyAiJyIgKSA6ICIiOwoJCW1lbnVQYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0nZGlhbG9nJyBjbGFzcz0ndWktc2VsZWN0bWVudScgaWQ9JyIgKyBkaWFsb2dJZCArICInIiArIHRoZW1lQXR0ciArIG92ZXJsYXlUaGVtZUF0dHIgKyAiPiIgKwoJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkiPGRpdiBjbGFzcz0ndWktdGl0bGUnPjwvZGl2PiIrCgkJCSI8L2Rpdj4iKwoJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkiPC9kaXY+IiApOwoJCWxpc3Rib3ggPSAkKCAiPGRpdiIgKyB0aGVtZUF0dHIgKyBvdmVybGF5VGhlbWVBdHRyICsgIiBpZD0nIiArIHBvcHVwSWQgKwoJCQkJIicgY2xhc3M9J3VpLXNlbGVjdG1lbnUnPjwvZGl2PiIgKQoJCQkuaW5zZXJ0QWZ0ZXIoIHRoaXMuc2VsZWN0ICkKCQkJLnBvcHVwKCk7CgkJbGlzdCA9ICQoICI8dWwgY2xhc3M9J3VpLXNlbGVjdG1lbnUtbGlzdCcgaWQ9JyIgKyBtZW51SWQgKyAiJyByb2xlPSdsaXN0Ym94JyBhcmlhLWxhYmVsbGVkYnk9JyIgKyB0aGlzLmJ1dHRvbklkICsgIiciICsgdGhlbWVBdHRyICsgZGl2aWRlclRoZW1lQXR0ciArICI+PC91bD4iICkuYXBwZW5kVG8oIGxpc3Rib3ggKTsKCQloZWFkZXIgPSAkKCAiPGRpdiBjbGFzcz0ndWktaGVhZGVyIHVpLWJhci0iICsgKCBvLnRoZW1lID8gby50aGVtZSA6ICJpbmhlcml0IiApICsgIic+PC9kaXY+IiApLnByZXBlbmRUbyggbGlzdGJveCApOwoJCWhlYWRlclRpdGxlID0gJCggIjxoMSBjbGFzcz0ndWktdGl0bGUnPjwvaDE+IiApLmFwcGVuZFRvKCBoZWFkZXIgKTsKCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkidGV4dCI6IG8uY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuIHVpLWNvcm5lci1hbGwgdWktYnRuLWxlZnQgdWktYnRuLWljb24tbm90ZXh0IHVpLWljb24tZGVsZXRlIgoJCQl9KS5hcHBlbmRUbyggaGVhZGVyICk7CgkJfQoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzZWxlY3RJZDogc2VsZWN0SWQsCgkJCW1lbnVJZDogbWVudUlkLAoJCQlwb3B1cElkOiBwb3B1cElkLAoJCQlkaWFsb2dJZDogZGlhbG9nSWQsCgkJCXRoaXNQYWdlOiB0aGlzUGFnZSwKCQkJbWVudVBhZ2U6IG1lbnVQYWdlLAoJCQlsYWJlbDogbGFiZWwsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiBvLnRoZW1lLAoJCQlsaXN0Ym94OiBsaXN0Ym94LAoJCQlsaXN0OiBsaXN0LAoJCQloZWFkZXI6IGhlYWRlciwKCQkJaGVhZGVyVGl0bGU6IGhlYWRlclRpdGxlLAoJCQloZWFkZXJDbG9zZTogaGVhZGVyQ2xvc2UsCgkJCW1lbnVQYWdlQ29udGVudDogbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlOiBtZW51UGFnZUNsb3NlLAoJCQlwbGFjZWhvbGRlcjogIiIKCQl9KTsKCgkJLy8gQ3JlYXRlIGxpc3QgZnJvbSBzZWxlY3QsIHVwZGF0ZSBzdGF0ZQoJCXRoaXMucmVmcmVzaCgpOwoKCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkICkgewoJCQkvLyBNYXAgdW5kZWZpbmVkIHRvIGZhbHNlLCBiZWNhdXNlIHRoaXMuX29yaWdUYWJJbmRleCA9PT0gdW5kZWZpbmVkCgkJCS8vIGluZGljYXRlcyB0aGF0IHdlIGhhdmUgbm90IHlldCBjaGVja2VkIHdoZXRoZXIgdGhlIHNlbGVjdCBoYXMKCQkJLy8gb3JpZ2luYWxseSBoYWQgYSB0YWJpbmRleCBhdHRyaWJ1dGUsIHdoZXJlYXMgZmFsc2UgaW5kaWNhdGVzIHRoYXQKCQkJLy8gd2UgaGF2ZSBjaGVja2VkIHRoZSBzZWxlY3QgZm9yIHN1Y2ggYW4gYXR0cmlidXRlLCBhbmQgaGF2ZSBmb3VuZAoJCQkvLyBub25lIHByZXNlbnQuCgkJCXRoaXMuX29yaWdUYWJJbmRleCA9ICggdGhpcy5zZWxlY3RbIDAgXS5nZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIgKSA9PT0gbnVsbCApID8gZmFsc2UgOiB0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiICk7CgkJfQoJCXRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCQl0aGlzLl9vbiggdGhpcy5zZWxlY3QsIHsgZm9jdXMgOiAiX2hhbmRsZVNlbGVjdEZvY3VzIiB9ICk7CgoJCS8vIEJ1dHRvbiBldmVudHMKCQl0aGlzLl9vbiggdGhpcy5idXR0b24sIHsKCQkJdmNsaWNrOiAiX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd24iCgkJfSk7CgoJCS8vIEV2ZW50cyBmb3IgbGlzdCBpdGVtcwoJCXRoaXMubGlzdC5hdHRyKCAicm9sZSIsICJsaXN0Ym94IiApOwoJCXRoaXMuX29uKCB0aGlzLmxpc3QsIHsKCQkJImZvY3VzaW4iOiAiX2hhbmRsZUxpc3RGb2N1cyIsCgkJCSJmb2N1c291dCI6ICJfaGFuZGxlTGlzdEZvY3VzIiwKCQkJImtleWRvd24iOiAiX2hhbmRsZUxpc3RLZXlkb3duIiwKCQkJImNsaWNrIGxpOm5vdCgudWktZGlzYWJsZWQsLnVpLXN0YXRlLWRpc2FibGVkLC51aS1saS1kaXZpZGVyKSI6ICJfaGFuZGxlTGlzdEl0ZW1DbGljayIKCQl9KTsKCgkJLy8gYnV0dG9uIHJlZm9jdXMgZW5zdXJlcyBwcm9wZXIgaGVpZ2h0IGNhbGN1bGF0aW9uCgkJLy8gYnkgcmVtb3ZpbmcgdGhlIGlubGluZSBzdHlsZSBhbmQgZW5zdXJpbmcgcGFnZSBpbmNsdXNpb24KCQl0aGlzLl9vbiggdGhpcy5tZW51UGFnZSwgeyBwYWdlaGlkZTogIl9oYW5kbGVNZW51UGFnZUhpZGUiIH0gKTsKCgkJLy8gRXZlbnRzIG9uIHRoZSBwb3B1cAoJCXRoaXMuX29uKCB0aGlzLmxpc3Rib3gsIHsgcG9wdXBhZnRlcmNsb3NlOiAiX3BvcHVwQ2xvc2VkIiB9ICk7CgoJCS8vIENsb3NlIGJ1dHRvbiBvbiBzbWFsbCBvdmVybGF5cwoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLl9vbiggdGhpcy5oZWFkZXJDbG9zZSwgeyBjbGljazogIl9oYW5kbGVIZWFkZXJDbG9zZUNsaWNrIiB9ICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJX3BvcHVwQ2xvc2VkOiBmdW5jdGlvbigpIHsKCQl0aGlzLmNsb3NlKCk7CgkJdGhpcy5fZGVsYXllZFRyaWdnZXIoKTsKCX0sCgoJX2RlbGF5ZWRUcmlnZ2VyOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX3RyaWdnZXJDaGFuZ2UgKSB7CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCX0KCQl0aGlzLl90cmlnZ2VyQ2hhbmdlID0gZmFsc2U7Cgl9LAoKCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoKCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJfSwKCglzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQ6bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkiICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQl2YXIgc2VsZiwgaW5kaWNlczsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBmb3JjZSApOwoJCX0KCgkJc2VsZiA9IHRoaXM7CgkJaWYgKCBmb3JjZSB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQlzZWxmLl9idWlsZExpc3QoKTsKCQl9CgoJCWluZGljZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkuZmluZCggImEiICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZW5kKCkKCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNlcyApID4gLTEgKSB7CgkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQlpdGVtLmZpbmQoICJhIiApLnJlbW92ZUNsYXNzKCAidWktY2hlY2tib3gtb2ZmIiApLmFkZENsYXNzKCAidWktY2hlY2tib3gtb24iICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJaWYgKCBpdGVtLmhhc0NsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKSApIHsKCQkJCQkJCWl0ZW0ubmV4dCgpLmZpbmQoICJhIiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJaXRlbS5maW5kKCAiYSIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSk7Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhdGhpcy5pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBzZWxmID0gdGhpczsKCgkJaWYgKCBzZWxmLm1lbnVUeXBlID09PSAicGFnZSIgKSB7CgkJCXNlbGYubWVudVBhZ2UuZGlhbG9nKCAiY2xvc2UiICk7CgkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5saXN0Ym94LnBvcHVwKCAiY2xvc2UiICk7CgkJfQoKCQlzZWxmLl9mb2N1c0J1dHRvbigpOwoJCS8vIGFsbG93IHRoZSBkaWFsb2cgdG8gYmUgY2xvc2VkIGFnYWluCgkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCX0sCgoJb3BlbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5idXR0b24uY2xpY2soKTsKCX0sCgoJX2ZvY3VzTWVudUl0ZW06IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RvciA9IHRoaXMubGlzdC5maW5kKCAiYS4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQlpZiAoIHNlbGVjdG9yLmxlbmd0aCA9PT0gMCApIHsKCQkJc2VsZWN0b3IgPSB0aGlzLmxpc3QuZmluZCggImxpOm5vdCgiICsgdW5mb2N1c2FibGVJdGVtU2VsZWN0b3IgKyAiKSBhLnVpLWJ0biIgKTsKCQl9CgkJc2VsZWN0b3IuZmlyc3QoKS5mb2N1cygpOwoJfSwKCglfZGVjaWRlRm9ybWF0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCSR3aW5kb3cgPSB0aGlzLndpbmRvdywKCQkJc2VsZkxpc3RQYXJlbnQgPSBzZWxmLmxpc3QucGFyZW50KCksCgkJCW1lbnVIZWlnaHQgPSBzZWxmTGlzdFBhcmVudC5vdXRlckhlaWdodCgpLAoJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQlidG5PZmZzZXQgPSBzZWxmLmJ1dHRvbi5vZmZzZXQoKS50b3AsCgkJCXNjcmVlbkhlaWdodCA9ICR3aW5kb3cuaGVpZ2h0KCk7CgoJCWlmICggbWVudUhlaWdodCA+IHNjcmVlbkhlaWdodCAtIDgwIHx8ICEkLnN1cHBvcnQuc2Nyb2xsVG9wICkgewoKCQkJc2VsZi5tZW51UGFnZS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApLnBhZ2UoKTsKCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQgPSBzZWxmLm1lbnVQYWdlLmZpbmQoICIudWktY29udGVudCIgKTsKCQkJc2VsZi5tZW51UGFnZUNsb3NlID0gc2VsZi5tZW51UGFnZS5maW5kKCAiLnVpLWhlYWRlciBhIiApOwoKCQkJLy8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBiZWluZyByZW1vdmVkIGZyb20gdGhlIERPTSwKCQkJLy8gb3RoZXJ3aXNlIHRoZSByZXN1bHRzIG9mIHNlbGVjdGluZyBhIGxpc3QgaXRlbSBpbiB0aGUgZGlhbG9nCgkJCS8vIGZhbGwgaW50byBhIGJsYWNrIGhvbGUKCQkJc2VsZi50aGlzUGFnZS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICk7CgoJCQkvL2ZvciBXZWJPUy9PcGVyYSBNaW5pIChzZXQgbGFzdHNjcm9sbCB1c2luZyBidXR0b24gb2Zmc2V0KQoJCQlpZiAoIHNjcm9sbFRvcCA9PT0gMCAmJiBidG5PZmZzZXQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQlzZWxmLnRoaXNQYWdlLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJJCggdGhpcyApLmpxbURhdGEoICJsYXN0U2Nyb2xsIiwgYnRuT2Zmc2V0ICk7CgkJCQl9KTsKCQkJfQoKCQkJc2VsZi5tZW51UGFnZS5vbmUoIHsKCQkJCXBhZ2VzaG93OiAkLnByb3h5KCB0aGlzLCAiX2ZvY3VzTWVudUl0ZW0iICksCgkJCQlwYWdlaGlkZTogJC5wcm94eSggdGhpcywgImNsb3NlIiApCgkJCX0pOwoKCQkJc2VsZi5tZW51VHlwZSA9ICJwYWdlIjsKCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQuYXBwZW5kKCBzZWxmLmxpc3QgKTsKCQkJc2VsZi5tZW51UGFnZQoJCQkJLmZpbmQoICJkaXYgLnVpLXRpdGxlIiApCgkJCQkJLnRleHQoIHNlbGYubGFiZWwuZ2V0RW5jb2RlZFRleHQoKSB8fCBzZWxmLnBsYWNlaG9sZGVyICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5tZW51VHlwZSA9ICJvdmVybGF5IjsKCgkJCXNlbGYubGlzdGJveC5vbmUoIHsgcG9wdXBhZnRlcm9wZW46ICQucHJveHkoIHRoaXMsICJfZm9jdXNNZW51SXRlbSIgKSB9ICk7CgkJfQoJfSwKCglfYnVpbGRMaXN0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCXBsYWNlaG9sZGVyID0gdGhpcy5wbGFjZWhvbGRlciwKCQkJbmVlZFBsYWNlaG9sZGVyID0gdHJ1ZSwKCQkJZGF0YUljb24gPSAiZmFsc2UiLAoJCQkkb3B0aW9ucywgbnVtT3B0aW9ucywgc2VsZWN0LAoJCQlkYXRhUHJlZml4ID0gImRhdGEtIiArICQubW9iaWxlLm5zLAoJCQlkYXRhSW5kZXhBdHRyID0gZGF0YVByZWZpeCArICJvcHRpb24taW5kZXgiLAoJCQlkYXRhSWNvbkF0dHIgPSBkYXRhUHJlZml4ICsgImljb24iLAoJCQlkYXRhUm9sZUF0dHIgPSBkYXRhUHJlZml4ICsgInJvbGUiLAoJCQlkYXRhUGxhY2Vob2xkZXJBdHRyID0gZGF0YVByZWZpeCArICJwbGFjZWhvbGRlciIsCgkJCWZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCQlpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlLAoJCQlvcHRHcm91cCwKCQkJaSwKCQkJb3B0aW9uLCAkb3B0aW9uLCBwYXJlbnQsIHRleHQsIGFuY2hvciwgY2xhc3NlcywKCQkJb3B0TGFiZWwsIGRpdmlkZXIsIGl0ZW07CgoJCXNlbGYubGlzdC5lbXB0eSgpLmZpbHRlciggIi51aS1saXN0dmlldyIgKS5saXN0dmlldyggImRlc3Ryb3kiICk7CgkJJG9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCk7CgkJbnVtT3B0aW9ucyA9ICRvcHRpb25zLmxlbmd0aDsKCQlzZWxlY3QgPSB0aGlzLnNlbGVjdFsgMCBdOwoKCQlmb3IgKCBpID0gMDsgaSA8IG51bU9wdGlvbnM7aSsrLCBpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlKSB7CgkJCW9wdGlvbiA9ICRvcHRpb25zW2ldOwoJCQkkb3B0aW9uID0gJCggb3B0aW9uICk7CgoJCQkvLyBEbyBub3QgY3JlYXRlIG9wdGlvbnMgYmFzZWQgb24gdWktc2NyZWVuLWhpZGRlbiBzZWxlY3Qgb3B0aW9ucwoJCQlpZiAoICRvcHRpb24uaGFzQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCXBhcmVudCA9IG9wdGlvbi5wYXJlbnROb2RlOwoJCQljbGFzc2VzID0gW107CgoJCQkvLyBBbHRob3VnaCB1c2luZyAudGV4dCgpIGhlcmUgcmFpc2VzIHRoZSByaXNrIHRoYXQsIHdoZW4gd2UgbGF0ZXIgcGFzdGUgdGhpcyBpbnRvIHRoZQoJCQkvLyBsaXN0IGl0ZW0gd2UgZW5kIHVwIHBhc3RpbmcgcG9zc2libHkgbWFsaWNpb3VzIHRoaW5ncyBsaWtlIDxzY3JpcHQ+IHRhZ3MsIHRoYXQgcmlzawoJCQkvLyBvbmx5IGFyaXNlcyBpZiB3ZSBkbyBzb21ldGhpbmcgbGlrZSAkKCAiPGxpPjxhIGhyZWY9JyMnPiIgKyB0ZXh0ICsgIjwvYT48L2xpPiIgKS4gV2UKCQkJLy8gZG9uJ3QgZG8gdGhhdC4gV2UgZG8gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHRleHQgKSBpbnN0ZWFkLCB3aGljaCBndWFyYW50ZWVzIHRoYXQKCQkJLy8gd2hhdGV2ZXIgd2UgcGFzdGUgaW4gd2lsbCBlbmQgdXAgYXMgdGV4dCwgd2l0aCBjaGFyYWN0ZXJzIGxpa2UgPCwgPiBhbmQgJiBlc2NhcGVkLgoJCQl0ZXh0ID0gJG9wdGlvbi50ZXh0KCk7CgkJCWFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApOwoJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAiaHJlZiIsICIjIiApOwoJCQlhbmNob3IuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCB0ZXh0ICkgKTsKCgkJCS8vIEFyZSB3ZSBpbnNpZGUgYW4gb3B0Z3JvdXA/CgkJCWlmICggcGFyZW50ICE9PSBzZWxlY3QgJiYgcGFyZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJvcHRncm91cCIgKSB7CgkJCQlvcHRMYWJlbCA9IHBhcmVudC5nZXRBdHRyaWJ1dGUoICJsYWJlbCIgKTsKCQkJCWlmICggb3B0TGFiZWwgIT09IG9wdEdyb3VwICkgewoJCQkJCWRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoIGRhdGFSb2xlQXR0ciwgImxpc3QtZGl2aWRlciIgKTsKCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggInJvbGUiLCAib3B0aW9uIiApOwoJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdExhYmVsICkgKTsKCQkJCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggZGl2aWRlciApOwoJCQkJCW9wdEdyb3VwID0gb3B0TGFiZWw7CgkJCQl9CgkJCX0KCgkJCWlmICggbmVlZFBsYWNlaG9sZGVyICYmICggIW9wdGlvbi5nZXRBdHRyaWJ1dGUoICJ2YWx1ZSIgKSB8fCB0ZXh0Lmxlbmd0aCA9PT0gMCB8fCAkb3B0aW9uLmpxbURhdGEoICJwbGFjZWhvbGRlciIgKSApICkgewoJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IHRydWU7CgoJCQkJLy8gSWYgd2UgaGF2ZSBpZGVudGlmaWVkIGEgcGxhY2Vob2xkZXIsIHJlY29yZCB0aGUgZmFjdCB0aGF0IGl0IHdhcwoJCQkJLy8gdXMgd2hvIGhhdmUgYWRkZWQgdGhlIHBsYWNlaG9sZGVyIHRvIHRoZSBvcHRpb24gYW5kIG1hcmsgaXQKCQkJCS8vIHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQlpZiAoIG51bGwgPT09IG9wdGlvbi5nZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIgKSApIHsKCQkJCQl0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgPSB0cnVlOwoJCQkJfQoJCQkJb3B0aW9uLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQljbGFzc2VzLnB1c2goICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCQkJfQoJCQkJaWYgKCBwbGFjZWhvbGRlciAhPT0gdGV4dCApIHsKCQkJCQlwbGFjZWhvbGRlciA9IHNlbGYucGxhY2Vob2xkZXIgPSB0ZXh0OwoJCQkJfQoJCQl9CgoJCQlpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImxpIiApOwoJCQlpZiAoIG9wdGlvbi5kaXNhYmxlZCApIHsKCQkJCWNsYXNzZXMucHVzaCggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICJhcmlhLWRpc2FibGVkIiwgdHJ1ZSApOwoJCQl9CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSW5kZXhBdHRyLCBpICk7CgkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSWNvbkF0dHIsIGRhdGFJY29uICk7CgkJCWlmICggaXNQbGFjZWhvbGRlckl0ZW0gKSB7CgkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQl9CgkJCWl0ZW0uY2xhc3NOYW1lID0gY2xhc3Nlcy5qb2luKCAiICIgKTsKCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgIm9wdGlvbiIgKTsKCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggInRhYmluZGV4IiwgIi0xIiApOwoJCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJCSQoIGFuY2hvciApLmFkZENsYXNzKCAidWktYnRuIHVpLWNoZWNrYm94LW9mZiB1aS1idG4taWNvbi1yaWdodCIgKTsKCQkJfQoKCQkJaXRlbS5hcHBlbmRDaGlsZCggYW5jaG9yICk7CgkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBpdGVtICk7CgkJfQoKCQlzZWxmLmxpc3RbMF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgoJCS8vIEhpZGUgaGVhZGVyIGlmIGl0J3Mgbm90IGEgbXVsdGlzZWxlY3QgYW5kIHRoZXJlJ3Mgbm8gcGxhY2Vob2xkZXIKCQlpZiAoICF0aGlzLmlzTXVsdGlwbGUgJiYgIXBsYWNlaG9sZGVyLmxlbmd0aCApIHsKCQkJdGhpcy5oZWFkZXIuYWRkQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuaGVhZGVyVGl0bGUudGV4dCggdGhpcy5wbGFjZWhvbGRlciApOwoJCX0KCgkJLy8gTm93IHBvcHVsYXRlZCwgY3JlYXRlIGxpc3R2aWV3CgkJc2VsZi5saXN0Lmxpc3R2aWV3KCk7Cgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSA/CgkJCXRoaXMuX3N1cGVyKCkgOgoJCQkkKCAiPGE+IiwgewoJCQkJImhyZWYiOiAiIyIsCgkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkiYXJpYS1oYXNwb3B1cCI6ICJ0cnVlIiwKCgkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCX0pOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgoJCWlmICggIXRoaXMub3B0aW9ucy5uYXRpdmVNZW51ICkgewoJCQl0aGlzLmNsb3NlKCk7CgoJCQkvLyBSZXN0b3JlIHRoZSB0YWJpbmRleCBhdHRyaWJ1dGUgdG8gaXRzIG9yaWdpbmFsIHZhbHVlCgkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gZmFsc2UgKSB7CgkJCQkJdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgdGhpcy5fb3JpZ1RhYkluZGV4ICk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuc2VsZWN0LnJlbW92ZUF0dHIoICJ0YWJpbmRleCIgKTsKCQkJCX0KCQkJfQoKCQkJLy8gUmVtb3ZlIHRoZSBwbGFjZWhvbGRlciBhdHRyaWJ1dGUgaWYgd2Ugd2VyZSB0aGUgb25lcyB0byBhZGQgaXQKCQkJaWYgKCB0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgKSB7CgkJCQl0aGlzLl9zZWxlY3RPcHRpb25zKCkucmVtb3ZlQXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInBsYWNlaG9sZGVyIiApOwoJCQl9CgoJCQkvLyBSZW1vdmUgdGhlIHBvcHVwCgkJCXRoaXMubGlzdGJveC5yZW1vdmUoKTsKCgkJCS8vIFJlbW92ZSB0aGUgZGlhbG9nCgkJCXRoaXMubWVudVBhZ2UucmVtb3ZlKCk7CgkJfQoKCQkvLyBDaGFpbiB1cAoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCi8vIGJ1dHRvbk1hcmt1cCBpcyBkZXByZWNhdGVkIGFzIG9mIDEuNC4wIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gMS41LjAuCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIEdlbmVyYWwgcG9saWN5OiBEbyBub3QgYWNjZXNzIGRhdGEtKiBhdHRyaWJ1dGVzIGV4Y2VwdCBkdXJpbmcgZW5oYW5jZW1lbnQuCi8vIEluIGFsbCBvdGhlciBjYXNlcyB3ZSBkZXRlcm1pbmUgdGhlIHN0YXRlIG9mIHRoZSBidXR0b24gZXhjbHVzaXZlbHkgZnJvbSBpdHMKLy8gY2xhc3NOYW1lLiBUaGF0J3Mgd2h5IG9wdGlvbnNUb0NsYXNzZXMgZXhwZWN0cyBhIGZ1bGwgY29tcGxlbWVudCBvZiBvcHRpb25zLAovLyBhbmQgdGhlIGpRdWVyeSBwbHVnaW4gY29tcGxldGVzIHRoZSBzZXQgb2Ygb3B0aW9ucyBmcm9tIHRoZSBkZWZhdWx0IHZhbHVlcy4KCi8vIE1hcCBjbGFzc2VzIHRvIGJ1dHRvbk1hcmt1cCBib29sZWFuIG9wdGlvbnMgLSB1c2VkIGluIGNsYXNzTmFtZVRvT3B0aW9ucygpCnZhciByZXZlcnNlQm9vbE9wdGlvbk1hcCA9IHsKCQkidWktc2hhZG93IiA6ICJzaGFkb3ciLAoJCSJ1aS1jb3JuZXItYWxsIiA6ICJjb3JuZXJzIiwKCQkidWktYnRuLWlubGluZSIgOiAiaW5saW5lIiwKCQkidWktc2hhZG93LWljb24iIDogImljb25zaGFkb3ciLCAvKiBUT0RPOiBSZW1vdmUgaW4gMS41ICovCgkJInVpLW1pbmkiIDogIm1pbmkiCgl9LAoJZ2V0QXR0ckZpeGVkID0gZnVuY3Rpb24oKSB7CgkJdmFyIHJldCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCXJldHVybiAoIHJldCA9PSBudWxsID8gdW5kZWZpbmVkIDogcmV0ICk7Cgl9LAoJY2FwaXRhbExldHRlcnNSRSA9IC9bQS1aXS9nOwoKLy8gb3B0aW9uc1RvQ2xhc3NlczoKLy8gQG9wdGlvbnM6IEEgY29tcGxldGUgc2V0IG9mIG9wdGlvbnMgdG8gY29udmVydCB0byBjbGFzcyBuYW1lcy4KLy8gQGV4aXN0aW5nQ2xhc3NlczogZXh0cmEgY2xhc3NlcyB0byBhZGQgdG8gdGhlIHJlc3VsdAovLwovLyBDb252ZXJ0cyBAb3B0aW9ucyB0byBidXR0b25NYXJrdXAgY2xhc3NlcyBhbmQgcmV0dXJucyB0aGUgcmVzdWx0IGFzIGFuIGFycmF5Ci8vIHRoYXQgY2FuIGJlIGNvbnZlcnRlZCB0byBhbiBlbGVtZW50J3MgY2xhc3NOYW1lIHdpdGggLmpvaW4oICIgIiApLiBBbGwKLy8gcG9zc2libGUgb3B0aW9ucyBtdXN0IGJlIHNldCBpbnNpZGUgQG9wdGlvbnMuIFVzZSAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cwovLyB0byBnZXQgYSBjb21wbGV0ZSBzZXQgYW5kIHVzZSAkLmV4dGVuZCB0byBvdmVycmlkZSB5b3VyIGNob2ljZSBvZiBvcHRpb25zCi8vIGZyb20gdGhhdCBzZXQuCmZ1bmN0aW9uIG9wdGlvbnNUb0NsYXNzZXMoIG9wdGlvbnMsIGV4aXN0aW5nQ2xhc3NlcyApIHsKCXZhciBjbGFzc2VzID0gZXhpc3RpbmdDbGFzc2VzID8gZXhpc3RpbmdDbGFzc2VzIDogW107CgoJLy8gQWRkIGNsYXNzZXMgdG8gdGhlIGFycmF5IC0gZmlyc3QgdWktYnRuCgljbGFzc2VzLnB1c2goICJ1aS1idG4iICk7CgoJLy8gSWYgdGhlcmUgaXMgYSB0aGVtZQoJaWYgKCBvcHRpb25zLnRoZW1lICkgewoJCWNsYXNzZXMucHVzaCggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJfQoKCS8vIElmIHRoZXJlJ3MgYW4gaWNvbiwgYWRkIHRoZSBpY29uLXJlbGF0ZWQgY2xhc3NlcwoJaWYgKCBvcHRpb25zLmljb24gKSB7CgkJY2xhc3NlcyA9IGNsYXNzZXMuY29uY2F0KFsKCQkJInVpLWljb24tIiArIG9wdGlvbnMuaWNvbiwKCQkJInVpLWJ0bi1pY29uLSIgKyBvcHRpb25zLmljb25wb3MKCQldKTsKCQlpZiAoIG9wdGlvbnMuaWNvbnNoYWRvdyApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktc2hhZG93LWljb24iICk7IC8qIFRPRE86IFJlbW92ZSBpbiAxLjUgKi8KCQl9Cgl9CgoJLy8gQWRkIHRoZSBhcHByb3ByaWF0ZSBjbGFzcyBmb3IgZWFjaCBib29sZWFuIG9wdGlvbgoJaWYgKCBvcHRpb25zLmlubGluZSApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1idG4taW5saW5lIiApOwoJfQoJaWYgKCBvcHRpb25zLnNoYWRvdyApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ciICk7Cgl9CglpZiAoIG9wdGlvbnMuY29ybmVycyApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1jb3JuZXItYWxsIiApOwoJfQoJaWYgKCBvcHRpb25zLm1pbmkgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktbWluaSIgKTsKCX0KCgkvLyBDcmVhdGUgYSBzdHJpbmcgZnJvbSB0aGUgYXJyYXkgYW5kIHJldHVybiBpdAoJcmV0dXJuIGNsYXNzZXM7Cn0KCi8vIGNsYXNzTmFtZVRvT3B0aW9uczoKLy8gQGNsYXNzZXM6IEEgc3RyaW5nIGNvbnRhaW5pbmcgYSAuY2xhc3NOYW1lLXN0eWxlIHNwYWNlLXNlcGFyYXRlZCBjbGFzcyBsaXN0Ci8vCi8vIExvb3BzIG92ZXIgQGNsYXNzZXMgYW5kIGNhbGN1bGF0ZXMgYW4gb3B0aW9ucyBvYmplY3QgYmFzZWQgb24gdGhlCi8vIGJ1dHRvbk1hcmt1cC1yZWxhdGVkIGNsYXNzZXMgaXQgZmluZHMuIEl0IHJlY29yZHMgdW5yZWNvZ25pemVkIGNsYXNzZXMgaW4gYW4KLy8gYXJyYXkuCi8vCi8vIFJldHVybnM6IEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBmb2xsb3dpbmcgaXRlbXM6Ci8vCi8vICJvcHRpb25zIjogYnV0dG9uTWFya3VwIG9wdGlvbnMgZm91bmQgdG8gYmUgcHJlc2VudCBiZWNhdXNlIG9mIHRoZQovLyBwcmVzZW5jZS9hYnNlbmNlIG9mIGNvcnJlc3BvbmRpbmcgY2xhc3NlcwovLwovLyAidW5rbm93bkNsYXNzZXMiOiBhIHN0cmluZyBjb250YWluaW5nIGFsbCB0aGUgbm9uLWJ1dHRvbk1hcmt1cC1yZWxhdGVkCi8vIGNsYXNzZXMgZm91bmQgaW4gQGNsYXNzZXMKLy8KLy8gImFscmVhZHlFbmhhbmNlZCI6IEEgYm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHVpLWJ0biBjbGFzcyB3YXMgYW1vbmcKLy8gdGhvc2UgZm91bmQgdG8gYmUgcHJlc2VudApmdW5jdGlvbiBjbGFzc05hbWVUb09wdGlvbnMoIGNsYXNzZXMgKSB7Cgl2YXIgaWR4LCBtYXAsIHVua25vd25DbGFzcywKCQlhbHJlYWR5RW5oYW5jZWQgPSBmYWxzZSwKCQlub0ljb24gPSB0cnVlLAoJCW8gPSB7CgkJCWljb246ICIiLAoJCQlpbmxpbmU6IGZhbHNlLAoJCQlzaGFkb3c6IGZhbHNlLAoJCQljb3JuZXJzOiBmYWxzZSwKCQkJaWNvbnNoYWRvdzogZmFsc2UsCgkJCW1pbmk6IGZhbHNlCgkJfSwKCQl1bmtub3duQ2xhc3NlcyA9IFtdOwoKCWNsYXNzZXMgPSBjbGFzc2VzLnNwbGl0KCAiICIgKTsKCgkvLyBMb29wIG92ZXIgdGhlIGNsYXNzZXMKCWZvciAoIGlkeCA9IDAgOyBpZHggPCBjbGFzc2VzLmxlbmd0aCA7IGlkeCsrICkgewoKCQkvLyBBc3N1bWUgaXQncyBhbiB1bnJlY29nbml6ZWQgY2xhc3MKCQl1bmtub3duQ2xhc3MgPSB0cnVlOwoKCQkvLyBSZWNvZ25pemUgYm9vbGVhbiBvcHRpb25zIGZyb20gdGhlIHByZXNlbmNlIG9mIGNsYXNzZXMKCQltYXAgPSByZXZlcnNlQm9vbE9wdGlvbk1hcFsgY2xhc3Nlc1sgaWR4IF0gXTsKCQlpZiAoIG1hcCAhPT0gdW5kZWZpbmVkICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJb1sgbWFwIF0gPSB0cnVlOwoKCQkvLyBSZWNvZ25pemUgdGhlIHByZXNlbmNlIG9mIGFuIGljb24gYW5kIGVzdGFibGlzaCB0aGUgaWNvbiBwb3NpdGlvbgoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdLmluZGV4T2YoICJ1aS1idG4taWNvbi0iICkgPT09IDAgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlub0ljb24gPSBmYWxzZTsKCQkJby5pY29ucG9zID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCAxMiApOwoKCQkvLyBFc3RhYmxpc2ggd2hpY2ggaWNvbiBpcyBwcmVzZW50CgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0uaW5kZXhPZiggInVpLWljb24tIiApID09PSAwICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJby5pY29uID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCA4ICk7CgoJCS8vIEVzdGFibGlzaCB0aGUgdGhlbWUgLSB0aGlzIHJlY29nbml6ZXMgb25lLWxldHRlciB0aGVtZSBzd2F0Y2ggbmFtZXMKCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXS5pbmRleE9mKCAidWktYnRuLSIgKSA9PT0gMCAmJiBjbGFzc2VzWyBpZHggXS5sZW5ndGggPT09IDggKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvLnRoZW1lID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCA3ICk7CgoJCS8vIFJlY29nbml6ZSB0aGF0IHRoaXMgZWxlbWVudCBoYXMgYWxyZWFkeSBiZWVuIGJ1dHRvbk1hcmt1cC1lbmhhbmNlZAoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdID09PSAidWktYnRuIiApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCWFscmVhZHlFbmhhbmNlZCA9IHRydWU7CgkJfQoKCQkvLyBJZiB0aGlzIGNsYXNzIGhhcyBub3QgYmVlbiByZWNvZ25pemVkLCBhZGQgaXQgdG8gdGhlIGxpc3QKCQlpZiAoIHVua25vd25DbGFzcyApIHsKCQkJdW5rbm93bkNsYXNzZXMucHVzaCggY2xhc3Nlc1sgaWR4IF0gKTsKCQl9Cgl9CgoJLy8gSWYgYSAidWktYnRuLWljb24tKiIgaWNvbiBwb3NpdGlvbiBjbGFzcyBpcyBhYnNlbnQgdGhlcmUgY2Fubm90IGJlIGFuIGljb24KCWlmICggbm9JY29uICkgewoJCW8uaWNvbiA9ICIiOwoJfQoKCXJldHVybiB7CgkJb3B0aW9uczogbywKCQl1bmtub3duQ2xhc3NlczogdW5rbm93bkNsYXNzZXMsCgkJYWxyZWFkeUVuaGFuY2VkOiBhbHJlYWR5RW5oYW5jZWQKCX07Cn0KCmZ1bmN0aW9uIGNhbWVsQ2FzZTJIeXBoZW5hdGVkKCBjICkgewoJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKfQoKLy8gJC5mbi5idXR0b25NYXJrdXA6Ci8vIERPTTogZ2V0cy9zZXRzIC5jbGFzc05hbWUKLy8KLy8gQG9wdGlvbnM6IG9wdGlvbnMgdG8gYXBwbHkgdG8gdGhlIGVsZW1lbnRzIGluIHRoZSBqUXVlcnkgb2JqZWN0Ci8vIEBvdmVyd3JpdGVDbGFzc2VzOiBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0byBob25vdXIgZXhpc3RpbmcgY2xhc3NlcwovLwovLyBDYWxjdWxhdGVzIHRoZSBjbGFzc2VzIHRvIGFwcGx5IHRvIHRoZSBlbGVtZW50cyBpbiB0aGUgalF1ZXJ5IG9iamVjdCBiYXNlZCBvbgovLyB0aGUgb3B0aW9ucyBwYXNzZWQgaW4uIElmIEBvdmVyd3JpdGVDbGFzc2VzIGlzIHRydWUsIGl0IHNldHMgdGhlIGNsYXNzTmFtZQovLyBwcm9wZXJ0eSBvZiBlYWNoIGVsZW1lbnQgaW4gdGhlIGpRdWVyeSBvYmplY3QgdG8gdGhlIGJ1dHRvbk1hcmt1cCBjbGFzc2VzCi8vIGl0IGNhbGN1bGF0ZXMgYmFzZWQgb24gdGhlIG9wdGlvbnMgcGFzc2VkIGluLgovLwovLyBJZiB5b3Ugd2lzaCB0byBwcmVzZXJ2ZSBhbnkgY2xhc3NlcyB0aGF0IGFyZSBhbHJlYWR5IHByZXNlbnQgb24gdGhlIGVsZW1lbnRzCi8vIGluc2lkZSB0aGUgalF1ZXJ5IG9iamVjdCwgaW5jbHVkaW5nIGJ1dHRvbk1hcmt1cC1yZWxhdGVkIGNsYXNzZXMgdGhhdCB3ZXJlCi8vIGFkZGVkIGJ5IGEgcHJldmlvdXMgY2FsbCB0byAkLmZuLmJ1dHRvbk1hcmt1cCgpIG9yIGR1cmluZyBwYWdlIGVuaGFuY2VtZW50Ci8vIHRoZW4geW91IHNob3VsZCBvbWl0IEBvdmVyd3JpdGVDbGFzc2VzIG9yIHNldCBpdCB0byBmYWxzZS4KJC5mbi5idXR0b25NYXJrdXAgPSBmdW5jdGlvbiggb3B0aW9ucywgb3ZlcndyaXRlQ2xhc3NlcyApIHsKCXZhciBpZHgsIGRhdGEsIGVsLCByZXRyaWV2ZWRPcHRpb25zLCBvcHRpb25LZXksCgkJZGVmYXVsdHMgPSAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0czsKCglmb3IgKCBpZHggPSAwIDsgaWR4IDwgdGhpcy5sZW5ndGggOyBpZHgrKyApIHsKCQllbCA9IHRoaXNbIGlkeCBdOwoJCWRhdGEgPSBvdmVyd3JpdGVDbGFzc2VzID8KCgkJCS8vIEFzc3VtZSB0aGlzIGVsZW1lbnQgaXMgbm90IGVuaGFuY2VkIGFuZCBpZ25vcmUgaXRzIGNsYXNzZXMKCQkJeyBhbHJlYWR5RW5oYW5jZWQ6IGZhbHNlLCB1bmtub3duQ2xhc3NlczogW10gfSA6CgoJCQkvLyBPdGhlcndpc2UgYW5hbHl6ZSBleGlzdGluZyBjbGFzc2VzIHRvIGVzdGFibGlzaCBleGlzdGluZyBvcHRpb25zIGFuZAoJCQkvLyBjbGFzc2VzCgkJCWNsYXNzTmFtZVRvT3B0aW9ucyggZWwuY2xhc3NOYW1lICk7CgoJCXJldHJpZXZlZE9wdGlvbnMgPSAkLmV4dGVuZCgge30sCgoJCQkvLyBJZiB0aGUgZWxlbWVudCBhbHJlYWR5IGhhcyB0aGUgY2xhc3MgdWktYnRuLCB0aGVuIHdlIGFzc3VtZSB0aGF0CgkJCS8vIGl0IGhhcyBwYXNzZWQgdGhyb3VnaCBidXR0b25NYXJrdXAgYmVmb3JlIC0gb3RoZXJ3aXNlLCB0aGUgb3B0aW9ucwoJCQkvLyByZXR1cm5lZCBieSBjbGFzc05hbWVUb09wdGlvbnMgZG8gbm90IGNvcnJlY3RseSByZWZsZWN0IHRoZSBzdGF0ZSBvZgoJCQkvLyB0aGUgZWxlbWVudAoJCQkoIGRhdGEuYWxyZWFkeUVuaGFuY2VkID8gZGF0YS5vcHRpb25zIDoge30gKSwKCgkJCS8vIEZpbmFsbHksIGFwcGx5IHRoZSBvcHRpb25zIHBhc3NlZCBpbgoJCQlvcHRpb25zICk7CgoJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IGNhbGwgb24gdGhpcyBlbGVtZW50LCByZXRyaWV2ZSByZW1haW5pbmcgb3B0aW9ucwoJCS8vIGZyb20gdGhlIGRhdGEtYXR0cmlidXRlcwoJCWlmICggIWRhdGEuYWxyZWFkeUVuaGFuY2VkICkgewoJCQlmb3IgKCBvcHRpb25LZXkgaW4gZGVmYXVsdHMgKSB7CgkJCQlpZiAoIHJldHJpZXZlZE9wdGlvbnNbIG9wdGlvbktleSBdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0cmlldmVkT3B0aW9uc1sgb3B0aW9uS2V5IF0gPSBnZXRBdHRyRml4ZWQoIGVsLAoJCQkJCQlvcHRpb25LZXkucmVwbGFjZSggY2FwaXRhbExldHRlcnNSRSwgY2FtZWxDYXNlMkh5cGhlbmF0ZWQgKQoJCQkJCSk7CgkJCQl9CgkJCX0KCQl9CgoJCWVsLmNsYXNzTmFtZSA9IG9wdGlvbnNUb0NsYXNzZXMoCgoJCQkvLyBNZXJnZSBhbGwgdGhlIG9wdGlvbnMgYW5kIGFwcGx5IHRoZW0gYXMgY2xhc3NlcwoJCQkkLmV4dGVuZCgge30sCgoJCQkJLy8gVGhlIGRlZmF1bHRzIGZvcm0gdGhlIGJhc2lzCgkJCQlkZWZhdWx0cywKCgkJCQkvLyBBZGQgdGhlIGNvbXB1dGVkIG9wdGlvbnMKCQkJCXJldHJpZXZlZE9wdGlvbnMKCQkJKSwKCgkJCS8vIC4uLiBhbmQgcmUtYXBwbHkgYW55IHVucmVjb2duaXplZCBjbGFzc2VzIHRoYXQgd2VyZSBmb3VuZAoJCQlkYXRhLnVua25vd25DbGFzc2VzICkuam9pbiggIiAiICk7CgkJaWYgKCBlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJidXR0b24iICkgewoJCQllbC5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImJ1dHRvbiIgKTsKCQl9Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgovLyBidXR0b25NYXJrdXAgZGVmYXVsdHMuIFRoaXMgbXVzdCBiZSBhIGNvbXBsZXRlIHNldCwgaS5lLiwgYSB2YWx1ZSBtdXN0IGJlCi8vIGdpdmVuIGhlcmUgZm9yIGFsbCByZWNvZ25pemVkIG9wdGlvbnMKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7CglpY29uOiAiIiwKCWljb25wb3M6ICJsZWZ0IiwKCXRoZW1lOiBudWxsLAoJaW5saW5lOiBmYWxzZSwKCXNoYWRvdzogdHJ1ZSwKCWNvcm5lcnM6IHRydWUsCglpY29uc2hhZG93OiBmYWxzZSwgLyogVE9ETzogUmVtb3ZlIGluIDEuNS4gT3B0aW9uIGRlcHJlY2F0ZWQgaW4gMS40LiAqLwoJbWluaTogZmFsc2UKfTsKCiQuZXh0ZW5kKCAkLmZuLmJ1dHRvbk1hcmt1cCwgewoJaW5pdFNlbGVjdG9yOiAiYTpqcW1EYXRhKHJvbGU9J2J1dHRvbicpLCAudWktYmFyID4gYSwgLnVpLWJhciA+IDpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpID4gYSwgYnV0dG9uOm5vdCg6anFtRGF0YShyb2xlPSduYXZiYXInKSBidXR0b24pIgp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbnRyb2xncm91cCIsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJZW5oYW5jZWQ6IGZhbHNlLAoJCXRoZW1lOiBudWxsLAoJCXNoYWRvdzogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlleGNsdWRlSW52aXNpYmxlOiB0cnVlLAoJCXR5cGU6ICJ2ZXJ0aWNhbCIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFJ1biBidXR0b25tYXJrdXAKCQlpZiAoICQuZm4uYnV0dG9uTWFya3VwICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5mbi5idXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkuYnV0dG9uTWFya3VwKCk7CgkJfQoJCS8vIEVuaGFuY2UgY2hpbGQgd2lkZ2V0cwoJCSQuZWFjaCggdGhpcy5fY2hpbGRXaWRnZXRzLCAkLnByb3h5KCBmdW5jdGlvbiggbnVtYmVyLCB3aWRnZXROYW1lICkgewoJCQlpZiAoICQubW9iaWxlWyB3aWRnZXROYW1lIF0gKSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGVbIHdpZGdldE5hbWUgXS5pbml0U2VsZWN0b3IgKS5ub3QoICQubW9iaWxlLnBhZ2UucHJvdG90eXBlLmtlZXBOYXRpdmVTZWxlY3RvcigpIClbIHdpZGdldE5hbWUgXSgpOwoJCQl9CgkJfSwgdGhpcyApKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3VpOiBudWxsLAoJCQlfaW5pdGlhbFJlZnJlc2g6IHRydWUKCQl9KTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQl0aGlzLl91aSA9IHsKCQkJCWdyb3VwTGVnZW5kOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIgKS5jaGlsZHJlbigpLAoJCQkJY2hpbGRXcmFwcGVyOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgl9LAoKCV9jaGlsZFdpZGdldHM6IFsgImNoZWNrYm94cmFkaW8iLCAic2VsZWN0bWVudSIsICJidXR0b24iIF0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6ICJ1aS1ncm91cC10aGVtZS0iICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJdWkgPSB7CgkJCQlncm91cExlZ2VuZDogZWxlbS5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJCWNoaWxkV3JhcHBlcjogZWxlbQoJCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCQkJInVpLWNvbnRyb2xncm91cC0iICsKCQkJCQkJCSggb3B0cy50eXBlID09PSAiaG9yaXpvbnRhbCIgPyAiaG9yaXpvbnRhbCIgOiAidmVydGljYWwiICkgKyAiICIgKwoJCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0cy50aGVtZSApICsgIiAiICsKCQkJCQkJKCBvcHRzLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSArCgkJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKQoJCQkJCS53cmFwSW5uZXIoICI8ZGl2ICIgKwoJCQkJCQkiY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyAiICsKCQkJCQkJCSggb3B0cy5zaGFkb3cgPT09IHRydWUgPyAidWktc2hhZG93IiA6ICIiICkgKyAiJz48L2Rpdj4iICkKCQkJCQkuY2hpbGRyZW4oKQoJCQl9OwoKCQlpZiAoIHVpLmdyb3VwTGVnZW5kLmxlbmd0aCA+IDAgKSB7CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPjwvZGl2PiIgKQoJCQkJLmFwcGVuZCggdWkuZ3JvdXBMZWdlbmQgKQoJCQkJLnByZXBlbmRUbyggZWxlbSApOwoJCX0KCgkJcmV0dXJuIHVpOwoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2FsbFJlZnJlc2gsIHJldHVyblZhbHVlLAoJCQllbGVtID0gdGhpcy5lbGVtZW50OwoKCQkvLyBNdXN0IGhhdmUgb25lIG9mIGhvcml6b250YWwgb3IgdmVydGljYWwKCQlpZiAoIG9wdGlvbnMudHlwZSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwiICkKCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC0iICsgKCBvcHRpb25zLnR5cGUgPT09ICJob3Jpem9udGFsIiA/ICJob3Jpem9udGFsIiA6ICJ2ZXJ0aWNhbCIgKSApOwoJCQljYWxsUmVmcmVzaCA9IHRydWU7CgkJfQoKCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0aW9ucy50aGVtZSApICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fdWkuY2hpbGRXcmFwcGVyLnRvZ2dsZUNsYXNzKCAidWktc2hhZG93Iiwgb3B0aW9ucy5zaGFkb3cgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5leGNsdWRlSW52aXNpYmxlICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5leGNsdWRlSW52aXNpYmxlID0gb3B0aW9ucy5leGNsdWRlSW52aXNpYmxlOwoJCQljYWxsUmVmcmVzaCA9IHRydWU7CgkJfQoKCQlyZXR1cm5WYWx1ZSA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggY2FsbFJlZnJlc2ggKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfSwKCgljb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl91aS5jaGlsZFdyYXBwZXI7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmNvbnRhaW5lcigpLAoJCQllbHMgPSAkZWwuZmluZCggIi51aS1idG4iICkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICksCgkJCWNyZWF0ZSA9IHRoaXMuX2luaXRpYWxSZWZyZXNoOwoJCWlmICggJC5tb2JpbGUuY2hlY2tib3hyYWRpbyApIHsKCQkJJGVsLmZpbmQoICI6bW9iaWxlLWNoZWNrYm94cmFkaW8iICkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJfQoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGVscywKCQkJdGhpcy5vcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgPyB0aGlzLl9nZXRWaXNpYmxlcyggZWxzLCBjcmVhdGUgKSA6IGVscywKCQkJY3JlYXRlICk7CgkJdGhpcy5faW5pdGlhbFJlZnJlc2ggPSBmYWxzZTsKCX0sCgoJLy8gQ2F2ZWF0OiBJZiB0aGUgbGVnZW5kIGlzIG5vdCB0aGUgZmlyc3QgY2hpbGQgb2YgdGhlIGNvbnRyb2xncm91cCBhdCBlbmhhbmNlCgkvLyB0aW1lLCBpdCB3aWxsIGJlIGFmdGVyIF9kZXN0cm95KCkuCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHVpLCBidXR0b25zLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdWkgPSB0aGlzLl91aTsKCQlidXR0b25zID0gdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCSJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwgdWktY29ybmVyLWFsbCB1aS1taW5pICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oIG9wdHMudGhlbWUgKSApCgkJCS5maW5kKCAiLnVpLWJ0biIgKQoJCQkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICk7CgoJCXRoaXMuX3JlbW92ZUZpcnN0TGFzdENsYXNzZXMoIGJ1dHRvbnMgKTsKCgkJdWkuZ3JvdXBMZWdlbmQudW53cmFwKCk7CgkJdWkuY2hpbGRXcmFwcGVyLmNoaWxkcmVuKCkudW53cmFwKCk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgewoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdoZWFkZXInKSIsCgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCWFkZEJhY2tCdG46IGZhbHNlLAoJCQliYWNrQnRuVGhlbWU6IG51bGwsCgkJCWJhY2tCdG5UZXh0OiAiQmFjayIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIGxlZnRidG4sIHJpZ2h0YnRuLAoJCQkJcm9sZSA9ICB0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciIsCgkJCQlwYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJCXBhZ2UgPSBmYWxzZTsKCQkJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7CgkJCQkJInBhZ2VzaG93IjogInJlZnJlc2giCgkJCQl9KTsKCQkJfQoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJcm9sZTogcm9sZSwKCQkJCXBhZ2U6IHBhZ2UsCgkJCQlsZWZ0YnRuOiBsZWZ0YnRuLAoJCQkJcmlnaHRidG46IHJpZ2h0YnRuCgkJCX0pOwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggInJvbGUiLCByb2xlID09PSAiaGVhZGVyIiA/ICJiYW5uZXIiIDogImNvbnRlbnRpbmZvIiApLmFkZENsYXNzKCAidWktIiArIHJvbGUgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvICkgewoJCQlpZiAoIG8uYWRkQmFja0J0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fdXBkYXRlQmFja0J1dHRvbigpOwoJCQl9CgkJCWlmICggby5iYWNrQnRuVGhlbWUgIT0gbnVsbCApIHsKCQkJCXRoaXMuZWxlbWVudAoJCQkJCS5maW5kKCAiLnVpLXRvb2xiYXItYmFjay1idG4iICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1idG4gdWktYnRuLSIgKyBvLmJhY2tCdG5UaGVtZSApOwoJCQl9CgkJCWlmICggby5iYWNrQnRuVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktdG9vbGJhci1iYWNrLWJ0biAudWktYnRuLXRleHQiICkudGV4dCggby5iYWNrQnRuVGV4dCApOwoJCQl9CgkJCWlmICggby50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdmFyIGN1cnJlbnRUaGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSA/IHRoaXMub3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiwKCQkJCQluZXdUaGVtZSA9IG8udGhlbWUgPyBvLnRoZW1lIDogImluaGVyaXQiOwoKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJhci0iICsgY3VycmVudFRoZW1lICkuYWRkQ2xhc3MoICJ1aS1iYXItIiArIG5ld1RoZW1lICk7CgkJCX0KCgkJCXRoaXMuX3N1cGVyKCBvICk7CgkJfSwKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLnJvbGUgPT09ICJoZWFkZXIiICkgewoJCQkJdGhpcy5fYWRkSGVhZGVyQnV0dG9uQ2xhc3NlcygpOwoJCQl9CgkJCWlmICggIXRoaXMucGFnZSApIHsKCQkJCXRoaXMuX3NldFJlbGF0aXZlKCk7CgkJCQlpZiAoIHRoaXMucm9sZSA9PT0gImZvb3RlciIgKSB7CgkJCQkJdGhpcy5lbGVtZW50LmFwcGVuZFRvKCAiYm9keSIgKTsKCQkJCX0gZWxzZSBpZiAoIHRoaXMucm9sZSA9PT0gImhlYWRlciIgKSB7CgkJCQkJdGhpcy5fdXBkYXRlQmFja0J1dHRvbigpOwoJCQkJfQoJCQl9CgkJCXRoaXMuX2FkZEhlYWRpbmdDbGFzc2VzKCk7CgkJCXRoaXMuX2J0bk1hcmt1cCgpOwoJCX0sCgoJCS8vd2Ugb25seSB3YW50IHRoaXMgdG8gcnVuIG9uIG5vbiBmaXhlZCB0b29sYmFycyBzbyBtYWtlIGl0IGVhc3kgdG8gb3ZlcnJpZGUKCQlfc2V0UmVsYXRpdmU6IGZ1bmN0aW9uKCkgewoJCQkkKCAiW2RhdGEtIisgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSddIiApLmNzcyh7ICJwb3NpdGlvbiI6ICJyZWxhdGl2ZSIgfSk7CgkJfSwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEFzIGZyb20gMS41IGJ1dHRvbiBjbGFzc2VzIGhhdmUgdG8gYmUgcHJlc2VudCBpbiB0aGUgbWFya3VwLgoJCV9idG5NYXJrdXA6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQKCQkJCS5jaGlsZHJlbiggImEiICkKCQkJCS5maWx0ZXIoICI6bm90KFtkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdub25lJ10pIiApCgkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCAiYnV0dG9uIiApOwoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggImNyZWF0ZSIgKTsKCQl9LAoJCS8vIERlcHJlY2F0ZWQgaW4gMS40LiBBcyBmcm9tIDEuNSB1aS1idG4tbGVmdC9yaWdodCBjbGFzc2VzIGhhdmUgdG8gYmUgcHJlc2VudCBpbiB0aGUgbWFya3VwLgoJCV9hZGRIZWFkZXJCdXR0b25DbGFzc2VzOiBmdW5jdGlvbigpIHsKCQkJdmFyIGhlYWRlckFuY2hvcnMgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJhLCBidXR0b24iICk7CgoJCQkvLyBEbyBub3QgbWlzdGFrZSBhIGJhY2sgYnV0dG9uIGZvciBhIGxlZnQgdG9vbGJhciBidXR0b24KCQkJdGhpcy5sZWZ0YnRuID0gaGVhZGVyQW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApICYmCgkJCQkhaGVhZGVyQW5jaG9ycy5oYXNDbGFzcyggInVpLXRvb2xiYXItYmFjay1idG4iICk7CgoJCQl0aGlzLnJpZ2h0YnRuID0gaGVhZGVyQW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCS8vIEZpbHRlciBvdXQgcmlnaHQgYnV0dG9ucyBhbmQgYmFjayBidXR0b25zCgkJCXRoaXMubGVmdGJ0biA9IHRoaXMubGVmdGJ0biB8fAoJCQkJaGVhZGVyQW5jaG9ycy5lcSggMCApCgkJCQkJLm5vdCggIi51aS1idG4tcmlnaHQsLnVpLXRvb2xiYXItYmFjay1idG4iICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1idG4tbGVmdCIgKQoJCQkJCS5sZW5ndGg7CgoJCQl0aGlzLnJpZ2h0YnRuID0gdGhpcy5yaWdodGJ0biB8fCBoZWFkZXJBbmNob3JzLmVxKCAxICkuYWRkQ2xhc3MoICJ1aS1idG4tcmlnaHQiICkubGVuZ3RoOwoJCX0sCgkJX3VwZGF0ZUJhY2tCdXR0b246IGZ1bmN0aW9uKCkgewoJCQl2YXIgYmFja0J1dHRvbiwKCQkJCW9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCQl0aGVtZSA9IG9wdGlvbnMuYmFja0J0blRoZW1lIHx8IG9wdGlvbnMudGhlbWU7CgoJCQkvLyBSZXRyaWV2ZSB0aGUgYmFjayBidXR0b24gb3IgY3JlYXRlIGEgbmV3LCBlbXB0eSBvbmUKCQkJYmFja0J1dHRvbiA9IHRoaXMuX2JhY2tCdXR0b24gPSAoIHRoaXMuX2JhY2tCdXR0b24gfHwge30gKTsKCgkJCS8vIFdlIGFkZCBhIGJhY2sgYnV0dG9uIG9ubHkgaWYgdGhlIG9wdGlvbiB0byBkbyBzbyBpcyBvbgoJCQlpZiAoIHRoaXMub3B0aW9ucy5hZGRCYWNrQnRuICYmCgoJCQkJCS8vIFRoaXMgbXVzdCBhbHNvIGJlIGEgaGVhZGVyIHRvb2xiYXIKCQkJCQl0aGlzLnJvbGUgPT09ICJoZWFkZXIiICYmCgoJCQkJCS8vIFRoZXJlIG11c3QgYmUgbXVsdGlwbGUgcGFnZXMgaW4gdGhlIERPTQoJCQkJCSQoICIudWktcGFnZSIgKS5sZW5ndGggPiAxICYmCgkJCQkJKCB0aGlzLnBhZ2UgPwoKCQkJCQkJLy8gSWYgdGhlIHRvb2xiYXIgaXMgaW50ZXJuYWwgdGhlIHBhZ2UncyBVUkwgbXVzdCBkaWZmZXIgZnJvbSB0aGUgaGFzaAoJCQkJCQkoIHRoaXMucGFnZVsgMCBdLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInVybCIgKSAhPT0KCQkJCQkJCSQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCBsb2NhdGlvbi5oYXNoICkgKSA6CgoJCQkJCQkvLyBPdGhlcndpc2UsIGlmIHRoZSB0b29sYmFyIGlzIGV4dGVybmFsIHRoZXJlIG11c3QgYmUgYXQgbGVhc3Qgb25lCgkJCQkJCS8vIGhpc3RvcnkgaXRlbSB0byB3aGljaCBvbmUgY2FuIGdvIGJhY2sKCQkJCQkJKCAkLm1vYmlsZS5uYXZpZ2F0ZSAmJiAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ICYmCgkJCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApICkgJiYKCgkJCQkJLy8gVGhlIHRvb2xiYXIgZG9lcyBub3QgaGF2ZSBhIGxlZnQgYnV0dG9uCgkJCQkJIXRoaXMubGVmdGJ0biApIHsKCgkJCQkvLyBTa2lwIGJhY2sgYnV0dG9uIGNyZWF0aW9uIGlmIG9uZSBpcyBhbHJlYWR5IHByZXNlbnQKCQkJCWlmICggIWJhY2tCdXR0b24uYXR0YWNoZWQgKSB7CgkJCQkJYmFja0J1dHRvbi5lbGVtZW50ID0gKCBiYWNrQnV0dG9uLmVsZW1lbnQgfHwKCQkJCQkJJCggIjxhIHJvbGU9J2J1dHRvbicgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApOycgIiArCgkJCQkJCQkiY2xhc3M9J3VpLWJ0biB1aS1jb3JuZXItYWxsIHVpLXNoYWRvdyB1aS1idG4tbGVmdCAiICsKCQkJCQkJCQkoIHRoZW1lID8gInVpLWJ0bi0iICsgdGhlbWUgKyAiICIgOiAiIiApICsKCQkJCQkJCQkidWktdG9vbGJhci1iYWNrLWJ0biB1aS1pY29uLWNhcmF0LWwgdWktYnRuLWljb24tbGVmdCcgIiArCgkJCQkJCQkiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsPSdiYWNrJz4iICsgb3B0aW9ucy5iYWNrQnRuVGV4dCArCgkJCQkJCQkiPC9hPiIgKSApCgkJCQkJCQkucHJlcGVuZFRvKCB0aGlzLmVsZW1lbnQgKTsKCQkJCQliYWNrQnV0dG9uLmF0dGFjaGVkID0gdHJ1ZTsKCQkJCX0KCgkJCS8vIElmIHdlIGFyZSBub3QgYWRkaW5nIGEgYmFjayBidXR0b24sIHRoZW4gcmVtb3ZlIHRoZSBvbmUgcHJlc2VudCwgaWYgYW55CgkJCX0gZWxzZSBpZiAoIGJhY2tCdXR0b24uZWxlbWVudCApIHsKCQkJCWJhY2tCdXR0b24uZWxlbWVudC5kZXRhY2goKTsKCQkJCWJhY2tCdXR0b24uYXR0YWNoZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJX2FkZEhlYWRpbmdDbGFzc2VzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKQoJCQkJLmFkZENsYXNzKCAidWktdGl0bGUiICkKCQkJCS8vIFJlZ2FyZGxlc3Mgb2YgaCBlbGVtZW50IG51bWJlciBpbiBzcmMsIGl0IGJlY29tZXMgaDEgZm9yIHRoZSBlbmhhbmNlZCBwYWdlCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAiaGVhZGluZyIsCgkJCQkJImFyaWEtbGV2ZWwiOiAiMSIKCQkJCX0pOwoJCX0KCX0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJJC53aWRnZXQoICJtb2JpbGUudG9vbGJhciIsICQubW9iaWxlLnRvb2xiYXIsIHsKCQlvcHRpb25zOiB7CgkJCXBvc2l0aW9uOm51bGwsCgkJCXZpc2libGVPblBhZ2VTaG93OiB0cnVlLAoJCQlkaXNhYmxlUGFnZVpvb206IHRydWUsCgkJCXRyYW5zaXRpb246ICJzbGlkZSIsIC8vY2FuIGJlIG5vbmUsIGZhZGUsIHNsaWRlIChzbGlkZSBtYXBzIHRvIHNsaWRldXAgb3Igc2xpZGVkb3duKQoJCQlmdWxsc2NyZWVuOiBmYWxzZSwKCQkJdGFwVG9nZ2xlOiB0cnVlLAoJCQl0YXBUb2dnbGVCbGFja2xpc3Q6ICJhLCBidXR0b24sIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCAudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkLCAudWktZmxpcHN3aXRjaCwgLnVpLXBvcHVwLCAudWktcGFuZWwsIC51aS1wYW5lbC1kaXNtaXNzLW9wZW4iLAoJCQloaWRlRHVyaW5nRm9jdXM6ICJpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCIsCgkJCXVwZGF0ZVBhZ2VQYWRkaW5nOiB0cnVlLAoJCQl0cmFja1BlcnNpc3RlbnRUb29sYmFyczogdHJ1ZSwKCgkJCS8vIEJyb3dzZXIgZGV0ZWN0aW9uISBXZWVlZSwgaGVyZSB3ZSBnby4uLgoJCQkvLyBVbmZvcnR1bmF0ZWx5LCBwb3NpdGlvbjpmaXhlZCBpcyBjb3N0bHksIG5vdCB0byBtZW50aW9uIHByb2JhYmx5IGltcG9zc2libGUsIHRvIGZlYXR1cmUtZGV0ZWN0IGFjY3VyYXRlbHkuCgkJCS8vIFNvbWUgdGVzdHMgZXhpc3QsIGJ1dCB0aGV5IGN1cnJlbnRseSByZXR1cm4gZmFsc2UgcmVzdWx0cyBpbiBjcml0aWNhbCBkZXZpY2VzIGFuZCBicm93c2Vycywgd2hpY2ggY291bGQgbGVhZCB0byBhIGJyb2tlbiBleHBlcmllbmNlLgoJCQkvLyBUZXN0aW5nIGZpeGVkIHBvc2l0aW9uaW5nIGlzIGFsc28gcHJldHR5IG9idHJ1c2l2ZSB0byBwYWdlIGxvYWQsIHJlcXVpcmluZyBpbmplY3RlZCBlbGVtZW50cyBhbmQgc2Nyb2xsaW5nIHRoZSB3aW5kb3cKCQkJLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBzZXJ2ZXMgdG8gcnVsZSBvdXQgc29tZSBwb3B1bGFyIGJyb3dzZXJzIHdpdGgga25vd24gZml4ZWQtcG9zaXRpb25pbmcgaXNzdWVzCgkJCS8vIFRoaXMgaXMgYSBwbHVnaW4gb3B0aW9uIGxpa2UgYW55IG90aGVyLCBzbyBmZWVsIGZyZWUgdG8gaW1wcm92ZSBvciBvdmVyd3JpdGUgaXQKCQkJc3VwcG9ydEJsYWNrbGlzdDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gISQuc3VwcG9ydC5maXhlZFBvc2l0aW9uOwoJCQl9CgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCWlmICggdGhpcy5vcHRpb25zLnBvc2l0aW9uID09PSAiZml4ZWQiICYmICF0aGlzLm9wdGlvbnMuc3VwcG9ydEJsYWNrbGlzdCgpICkgewoJCQkJdGhpcy5fbWFrZUZpeGVkKCk7CgkJCX0KCQl9LAoKCQlfbWFrZUZpeGVkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZpeGVkIiApOwoJCQl0aGlzLnVwZGF0ZVBhZ2VQYWRkaW5nKCk7CgkJCXRoaXMuX2FkZFRyYW5zaXRpb25DbGFzcygpOwoJCQl0aGlzLl9iaW5kUGFnZUV2ZW50cygpOwoJCQl0aGlzLl9iaW5kVG9nZ2xlSGFuZGxlcnMoKTsKCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG8gKSB7CgkJCWlmICggby5wb3NpdGlvbiA9PT0gImZpeGVkIiAmJiB0aGlzLm9wdGlvbnMucG9zaXRpb24gIT09ICJmaXhlZCIgKSB7CgkJCQl0aGlzLl9tYWtlRml4ZWQoKTsKCQkJfQoJCQlpZiAoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gImZpeGVkIiAmJiAhdGhpcy5vcHRpb25zLnN1cHBvcnRCbGFja2xpc3QoKSApIHsKCQkJCXZhciAkcGFnZSA9ICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAoICQoIi51aS1wYWdlLWFjdGl2ZSIpLmxlbmd0aCA+IDAgKT8gJCgiLnVpLXBhZ2UtYWN0aXZlIik6ICQoIi51aS1wYWdlIikuZXEoMCk7CgoJCQkJaWYgKCBvLmZ1bGxzY3JlZW4gIT09IHVuZGVmaW5lZCkgewoJCQkJCWlmICggby5mdWxsc2NyZWVuICkgewoJCQkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS0iKyB0aGlzLnJvbGUgKyItZnVsbHNjcmVlbiIgKTsKCQkJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0aGlzLnJvbGUgKyAiLWZ1bGxzY3JlZW4iICk7CgkJCQkJfQoJCQkJCS8vIElmIG5vdCBmdWxsc2NyZWVuLCBhZGQgY2xhc3MgdG8gcGFnZSB0byBzZXQgdG9wIG9yIGJvdHRvbSBwYWRkaW5nCgkJCQkJZWxzZSB7CgkJCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJCQkkcGFnZS5yZW1vdmVDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSArICItZnVsbHNjcmVlbiIgKS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSsgIi1maXhlZCIgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJdGhpcy5fc3VwZXIobyk7CgkJfSwKCgkJX2FkZFRyYW5zaXRpb25DbGFzczogZnVuY3Rpb24oKSB7CgkJCXZhciB0Y2xhc3MgPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCgkJCWlmICggdGNsYXNzICYmIHRjbGFzcyAhPT0gIm5vbmUiICkgewoJCQkJLy8gdXNlIGFwcHJvcHJpYXRlIHNsaWRlIGZvciBoZWFkZXIgb3IgZm9vdGVyCgkJCQlpZiAoIHRjbGFzcyA9PT0gInNsaWRlIiApIHsKCQkJCQl0Y2xhc3MgPSB0aGlzLmVsZW1lbnQuaGFzQ2xhc3MoICJ1aS1oZWFkZXIiICkgPyAic2xpZGVkb3duIiA6ICJzbGlkZXVwIjsKCQkJCX0KCgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRjbGFzcyApOwoJCQl9CgkJfSwKCgkJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk6IHRoaXMuZG9jdW1lbnQ7CgkJCS8vcGFnZSBldmVudCBiaW5kaW5ncwoJCQkvLyBGaXhlZCB0b29sYmFycyByZXF1aXJlIHBhZ2Ugem9vbSB0byBiZSBkaXNhYmxlZCwgb3RoZXJ3aXNlIHVzYWJpbGl0eSBpc3N1ZXMgY3JvcCB1cAoJCQkvLyBUaGlzIG1ldGhvZCBpcyBtZWFudCB0byBkaXNhYmxlIHpvb20gd2hpbGUgYSBmaXhlZC1wb3NpdGlvbmVkIHRvb2xiYXIgcGFnZSBpcyB2aXNpYmxlCgkJCXRoaXMuX29uKCBwYWdlICwgewoJCQkJInBhZ2ViZWZvcmVzaG93IjogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIsCgkJCQkid2Via2l0QW5pbWF0aW9uU3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJImFuaW1hdGlvbnN0YXJ0IjoiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJ1cGRhdGVsYXlvdXQiOiAiX2hhbmRsZUFuaW1hdGlvblN0YXJ0IiwKCQkJCSJwYWdlc2hvdyI6ICJfaGFuZGxlUGFnZVNob3ciLAoJCQkJInBhZ2ViZWZvcmVoaWRlIjogIl9oYW5kbGVQYWdlQmVmb3JlSGlkZSIKCQkJfSk7CgkJfSwKCgkJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbiggKSB7CgkJCXZhciBvID0gdGhpcy5vcHRpb25zOwoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQkJaWYgKCAhby52aXNpYmxlT25QYWdlU2hvdyApIHsKCQkJCXRoaXMuaGlkZSggdHJ1ZSApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZUFuaW1hdGlvblN0YXJ0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLm9wdGlvbnMudXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLnVwZGF0ZVBhZ2VQYWRkaW5nKCAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogIi51aS1wYWdlLWFjdGl2ZSIgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlU2hvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgeyAidGhyb3R0bGVkcmVzaXplIjogInVwZGF0ZVBhZ2VQYWRkaW5nIiB9ICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCQl0aGlzRm9vdGVyLCB0aGlzSGVhZGVyLCBuZXh0Rm9vdGVyLCBuZXh0SGVhZGVyOwoKCQkJaWYgKCBvLmRpc2FibGVQYWdlWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCX0KCQkJaWYgKCBvLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb2ZmKCB0aGlzLndpbmRvdywgInRocm90dGxlZHJlc2l6ZSIgKTsKCQkJfQoKCQkJaWYgKCBvLnRyYWNrUGVyc2lzdGVudFRvb2xiYXJzICkgewoJCQkJdGhpc0Zvb3RlciA9ICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcy5wYWdlICk7CgkJCQl0aGlzSGVhZGVyID0gJCggIi51aS1oZWFkZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLnBhZ2UgKTsKCQkJCW5leHRGb290ZXIgPSB0aGlzRm9vdGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0Zvb3Rlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApIHx8ICQoKTsKCQkJCW5leHRIZWFkZXIgPSB0aGlzSGVhZGVyLmxlbmd0aCAmJiB1aS5uZXh0UGFnZSAmJiAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkPSciICsgdGhpc0hlYWRlci5qcW1EYXRhKCAiaWQiICkgKyAiJykiLCB1aS5uZXh0UGFnZSApIHx8ICQoKTsKCgkJCQlpZiAoIG5leHRGb290ZXIubGVuZ3RoIHx8IG5leHRIZWFkZXIubGVuZ3RoICkgewoKCQkJCQluZXh0Rm9vdGVyLmFkZCggbmV4dEhlYWRlciApLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQkJCXVpLm5leHRQYWdlLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCW5leHRIZWFkZXIucHJlcGVuZFRvKCB0aGlzICk7CgkJCQkJCW5leHRGb290ZXIuYXBwZW5kVG8oIHRoaXMgKTsKCQkJCQl9KTsKCQkJCX0KCQkJfQoJCX0sCgoJCV92aXNpYmxlOiB0cnVlLAoKCQkvLyBUaGlzIHdpbGwgc2V0IHRoZSBjb250ZW50IGVsZW1lbnQncyB0b3Agb3IgYm90dG9tIHBhZGRpbmcgZXF1YWwgdG8gdGhlIHRvb2xiYXIncyBoZWlnaHQKCQl1cGRhdGVQYWdlUGFkZGluZzogZnVuY3Rpb24oIHRiUGFnZSApIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICggdGhpcy5yb2xlID09PSJoZWFkZXIiICksCgkJCQlwb3MgPSBwYXJzZUZsb2F0KCAkZWwuY3NzKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICkgKTsKCgkJCS8vIFRoaXMgYmVoYXZpb3Igb25seSBhcHBsaWVzIHRvICJmaXhlZCIsIG5vdCAiZnVsbHNjcmVlbiIKCQkJaWYgKCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiApIHsgcmV0dXJuOyB9CgkJCS8vIHRiUGFnZSBhcmd1bWVudCBjYW4gYmUgYSBQYWdlIG9iamVjdCBvciBhbiBldmVudCwgaWYgY29taW5nIGZyb20gdGhyb3R0bGVkIHJlc2l6ZS4KCQkJdGJQYWdlID0gKCB0YlBhZ2UgJiYgdGJQYWdlLnR5cGUgPT09IHVuZGVmaW5lZCAmJiB0YlBhZ2UgKSB8fCB0aGlzLnBhZ2UgfHwgJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJdGJQYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICIudWktcGFnZS1hY3RpdmUiOwoJCQkkKCB0YlBhZ2UgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgJGVsLm91dGVySGVpZ2h0KCkgKyBwb3MgKTsKCQl9LAoKCQlfdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyICR3aW4gPSB0aGlzLndpbmRvdywKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCXNjcm9sbCA9ICR3aW4uc2Nyb2xsVG9wKCksCgkJCQllbEhlaWdodCA9ICRlbC5oZWlnaHQoKSwKCQkJCXBIZWlnaHQgPSAoICEhdGhpcy5wYWdlICk/ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuaGVpZ2h0KCk6JCgiLnVpLXBhZ2UtYWN0aXZlIikuaGVpZ2h0KCksCgkJCQl2aWV3cG9ydEhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJcmV0dXJuICFub3RyYW5zaXRpb24gJiYKCQkJCSggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gJiYgdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gIT09ICJub25lIiAmJgoJCQkJKAoJCQkJCSggdGhpcy5yb2xlID09PSAiaGVhZGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsID4gZWxIZWlnaHQgKSB8fAoJCQkJCSggdGhpcy5yb2xlID09PSAiZm9vdGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsICsgdmlld3BvcnRIZWlnaHQgPCBwSGVpZ2h0IC0gZWxIZWlnaHQgKQoJCQkJKSB8fCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbgoJCQkJKTsKCQl9LAoKCQlzaG93OiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0ICIgKyBoaWRlQ2xhc3MgKQoJCQkJCS5hZGRDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uICgpIHsKCQkJCQkJJGVsLnJlbW92ZUNsYXNzKCAiaW4iICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwucmVtb3ZlQ2xhc3MoIGhpZGVDbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSB0cnVlOwoJCX0sCgoJCWhpZGU6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCS8vIGlmIGl0J3MgYSBzbGlkZSB0cmFuc2l0aW9uLCBvdXIgbmV3IHRyYW5zaXRpb25zIG5lZWQgdGhlIHJldmVyc2UgY2xhc3MgYXMgd2VsbCB0byBzbGlkZSBvdXR3YXJkCgkJCQlvdXRjbGFzcyA9ICJvdXQiICsgKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiA9PT0gInNsaWRlIiA/ICIgcmV2ZXJzZSIgOiAiIiApOwoKCQkJaWYgKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5hZGRDbGFzcyggb3V0Y2xhc3MgKQoJCQkJCS5yZW1vdmVDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uKCkgewoJCQkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gZmFsc2U7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQkJdGhpc1sgdGhpcy5fdmlzaWJsZSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJfSwKCgkJX2JpbmRUb2dnbGVIYW5kbGVyczogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQlkZWxheVNob3csIGRlbGF5SGlkZSwKCQkJCWlzVmlzaWJsZSA9IHRydWUsCgkJCQlwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICQoIi51aS1wYWdlIik7CgoJCQkvLyB0YXAgdG9nZ2xlCgkJCXBhZ2UKCQkJCS5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJaWYgKCBvLnRhcFRvZ2dsZSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCBvLnRhcFRvZ2dsZUJsYWNrbGlzdCApLmxlbmd0aCApIHsKCQkJCQkJc2VsZi50b2dnbGUoKTsKCQkJCQl9CgkJCQl9KQoJCQkJLmJpbmQoICJmb2N1c2luIGZvY3Vzb3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJLy90aGlzIGhpZGVzIHRoZSB0b29sYmFycyBvbiBhIGtleWJvYXJkIHBvcCB0byBnaXZlIG1vcmUgc2NyZWVuIHJvb20gYW5kIHByZXZlbnQgaW9zIGJ1ZyB3aGljaAoJCQkJCS8vcG9zaXRpb25zIGZpeGVkIHRvb2xiYXJzIGluIHRoZSBtaWRkbGUgb2YgdGhlIHNjcmVlbiBvbiBwb3AgaWYgdGhlIGlucHV0IGlzIG5lYXIgdGhlIHRvcCBvcgoJCQkJCS8vYm90dG9tIG9mIHRoZSBzY3JlZW4gYWRkcmVzc2VzIGlzc3VlcyAjNDQxMCBGb290ZXIgbmF2YmFyIG1vdmVzIHVwIHdoZW4gY2xpY2tpbmcgb24gYSB0ZXh0Ym94IGluIGFuIEFuZHJvaWQgZW52aXJvbm1lbnQKCQkJCQkvL2FuZCBpc3N1ZSAjNDExMyBIZWFkZXIgYW5kIGZvb3RlciBjaGFuZ2UgdGhlaXIgcG9zaXRpb24gYWZ0ZXIga2V5Ym9hcmQgcG9wdXAgLSBpT1MKCQkJCQkvL2FuZCBpc3N1ZSAjNDQxMCBGb290ZXIgbmF2YmFyIG1vdmVzIHVwIHdoZW4gY2xpY2tpbmcgb24gYSB0ZXh0Ym94IGluIGFuIEFuZHJvaWQgZW52aXJvbm1lbnQKCQkJCQlpZiAoIHNjcmVlbi53aWR0aCA8IDEwMjUgJiYgJCggZS50YXJnZXQgKS5pcyggby5oaWRlRHVyaW5nRm9jdXMgKSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCIgKS5sZW5ndGggKSB7CgkJCQkJCS8vRml4IGZvciBpc3N1ZSAjNDcyNCBNb3ZpbmcgdGhyb3VnaCBmb3JtIGluIE1vYmlsZSBTYWZhcmkgd2l0aCAiTmV4dCIgYW5kICJQcmV2aW91cyIgc3lzdGVtCgkJCQkJCS8vY29udHJvbHMgY2F1c2VzIGZpeGVkIHBvc2l0aW9uLCB0YXAtdG9nZ2xlIGZhbHNlIEhlYWRlciB0byByZXZlYWwgaXRzZWxmCgkJCQkJCS8vIGlzVmlzaWJsZSBpbnN0ZWFkIG9mIHNlbGYuX3Zpc2libGUgYmVjYXVzZSB0aGUgZm9jdXNpbiBhbmQgZm9jdXNvdXQgZXZlbnRzIGZpcmUgdHdpY2UgYXQgdGhlIHNhbWUgdGltZQoJCQkJCQkvLyBBbHNvIHVzZSBhIGRlbGF5IGZvciBoaWRpbmcgdGhlIHRvb2xiYXJzIGJlY2F1c2Ugb24gQW5kcm9pZCBuYXRpdmUgYnJvd3NlciBmb2N1c2luIGlzIGRpcmVjbHR5IGZvbGxvd2VkCgkJCQkJCS8vIGJ5IGEgZm9jdXNvdXQgd2hlbiBhIG5hdGl2ZSBzZWxlY3RzIG9wZW5zIGFuZCB0aGUgb3RoZXIgd2F5IGFyb3VuZCB3aGVuIGl0IGNsb3Nlcy4KCQkJCQkJaWYgKCBlLnR5cGUgPT09ICJmb2N1c291dCIgJiYgIWlzVmlzaWJsZSApIHsKCQkJCQkJCWlzVmlzaWJsZSA9IHRydWU7CgkJCQkJCQkvL3dhaXQgZm9yIHRoZSBzdGFjayB0byB1bndpbmQgYW5kIHNlZSBpZiB3ZSBoYXZlIGp1bXBlZCB0byBhbm90aGVyIGlucHV0CgkJCQkJCQljbGVhclRpbWVvdXQoIGRlbGF5SGlkZSApOwoJCQkJCQkJZGVsYXlTaG93ID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkJc2VsZi5zaG93KCk7CgkJCQkJCQl9LCAwICk7CgkJCQkJCX0gZWxzZSBpZiAoIGUudHlwZSA9PT0gImZvY3VzaW4iICYmICEhaXNWaXNpYmxlICkgewoJCQkJCQkJLy9pZiB3ZSBoYXZlIGp1bXBlZCB0byBhbm90aGVyIGlucHV0IGNsZWFyIHRoZSB0aW1lIG91dCB0byBjYW5jZWwgdGhlIHNob3cuCgkJCQkJCQljbGVhclRpbWVvdXQoIGRlbGF5U2hvdyApOwoJCQkJCQkJaXNWaXNpYmxlID0gZmFsc2U7CgkJCQkJCQlkZWxheUhpZGUgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLmhpZGUoKTsKCQkJCQkJCX0sIDAgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pOwoJCX0sCgoJCV9zZXRSZWxhdGl2ZTogZnVuY3Rpb24oKSB7CgkJCWlmKCB0aGlzLm9wdGlvbnMucG9zaXRpb24gIT09ICJmaXhlZCIgKXsKCQkJCSQoICJbZGF0YS0iKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJ10iICkuY3NzKHsgInBvc2l0aW9uIjogInJlbGF0aXZlIiB9KTsKCQkJfQoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5oYXNDbGFzcyggInVpLWhlYWRlciIgKTsKCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICIiICk7CgkJCSRlbC5yZW1vdmVDbGFzcyggInVpLWhlYWRlci1maXhlZCB1aS1mb290ZXItZml4ZWQgdWktaGVhZGVyLWZ1bGxzY3JlZW4gdWktZm9vdGVyLWZ1bGxzY3JlZW4gaW4gb3V0IGZhZGUgc2xpZGVkb3duIHNsaWRldXAgdWktZml4ZWQtaGlkZGVuIiApOwoJCQkkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApLnJlbW92ZUNsYXNzKCAidWktcGFnZS1oZWFkZXItZml4ZWQgdWktcGFnZS1mb290ZXItZml4ZWQgdWktcGFnZS1oZWFkZXItZnVsbHNjcmVlbiB1aS1wYWdlLWZvb3Rlci1mdWxsc2NyZWVuIiApOwoJCX0KCgl9KTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgJC5tb2JpbGUudG9vbGJhciwgewoKCQlfbWFrZUZpeGVkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCQkJdGhpcy5fd29ya2Fyb3VuZHMoKTsKCQl9LAoKCQkvL2NoZWNrIHRoZSBicm93c2VyIGFuZCB2ZXJzaW9uIGFuZCBydW4gbmVlZGVkIHdvcmthcm91bmRzCgkJX3dvcmthcm91bmRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJCS8vIFJlbmRlcmluZyBlbmdpbmUgaXMgV2Via2l0LCBhbmQgY2FwdHVyZSBtYWpvciB2ZXJzaW9uCgkJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJb3MgPSBudWxsLAoJCQlzZWxmID0gdGhpczsKCQkJLy9zZXQgdGhlIG9zIHdlIGFyZSB3b3JraW5nIGluIGlmIGl0IGRvc2VudCBtYXRjaCBvbmUgd2l0aCB3b3JrYXJvdW5kcyByZXR1cm4KCQkJaWYgKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApIHsKCQkJCW9zID0gImlvcyI7CgkJCX0gZWxzZSBpZiAoIHVhLmluZGV4T2YoICJBbmRyb2lkIiApID4gLTEgKSB7CgkJCQlvcyA9ICJhbmRyb2lkIjsKCQkJfSBlbHNlIHsKCQkJCXJldHVybjsKCQkJfQoJCQkvL2NoZWNrIG9zIHZlcnNpb24gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQlpZiAoIG9zID09PSAiaW9zIiApIHsKCQkJCS8vaU9TICB3b3JrYXJvdW5kcwoJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJfSBlbHNlIGlmICggb3MgPT09ICJhbmRyb2lkIiAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTM0ICkgewoJCQkJLy9BbmRyb2lkIDIuMyBydW4gYWxsIEFuZHJvaWQgMi4zIHdvcmthcm91bmQKCQkJCXNlbGYuX2JpbmRTY3JvbGxXb3JrYXJvdW5kKCk7CgkJCQlzZWxmLl9iaW5kTGlzdFRodW1iV29ya2Fyb3VuZCgpOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuOwoJCQl9CgkJfSwKCgkJLy9VdGlsaXR5IGNsYXNzIGZvciBjaGVja2luZyBoZWFkZXIgYW5kIGZvb3RlciBwb3NpdGlvbnMgcmVsYXRpdmUgdG8gdmlld3BvcnQKCQlfdmlld3BvcnRPZmZzZXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmhhc0NsYXNzKCAidWktaGVhZGVyIiApLAoJCQkJb2Zmc2V0ID0gTWF0aC5hYnMoICRlbC5vZmZzZXQoKS50b3AgLSB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKSApOwoJCQlpZiAoICFoZWFkZXIgKSB7CgkJCQlvZmZzZXQgPSBNYXRoLnJvdW5kKCBvZmZzZXQgLSB0aGlzLndpbmRvdy5oZWlnaHQoKSArICRlbC5vdXRlckhlaWdodCgpICkgLSA2MDsKCQkJfQoJCQlyZXR1cm4gb2Zmc2V0OwoJCX0sCgoJCS8vYmluZCBldmVudHMgZm9yIF90cmlnZ2VyUmVkcmF3KCkgZnVuY3Rpb24KCQlfYmluZFNjcm9sbFdvcmthcm91bmQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCS8vYmluZCB0byBzY3JvbGxzdG9wIGFuZCBjaGVjayBpZiB0aGUgdG9vbGJhcnMgYXJlIGNvcnJlY3RseSBwb3NpdGlvbmVkCgkJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgeyBzY3JvbGxzdG9wOiBmdW5jdGlvbigpIHsKCQkJCXZhciB2aWV3cG9ydE9mZnNldCA9IHNlbGYuX3ZpZXdwb3J0T2Zmc2V0KCk7CgkJCQkvL2NoZWNrIGlmIHRoZSBoZWFkZXIgaXMgdmlzaWJsZSBhbmQgaWYgaXRzIGluIHRoZSByaWdodCBwbGFjZQoJCQkJaWYgKCB2aWV3cG9ydE9mZnNldCA+IDIgJiYgc2VsZi5fdmlzaWJsZSApIHsKCQkJCQlzZWxmLl90cmlnZ2VyUmVkcmF3KCk7CgkJCQl9CgkJCX19KTsKCQl9LAoKCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlICM0MjUwIFBlcnNpc3RlbnQgZm9vdGVyIGluc3RhYmlsaXR5IGluIHYxLjEgd2l0aCBsb25nIHNlbGVjdCBsaXN0cyBpbiBBbmRyb2lkIDIuMy4zCgkJLy9hbmQgaXNzdWUgIzM3NDggQW5kcm9pZCAyLng6IFBhZ2UgdHJhbnNpdGlvbnMgYnJva2VuIHdoZW4gZml4ZWQgdG9vbGJhcnMgdXNlZAoJCS8vdGhlIGFic29sdXRlbHkgcG9zaXRpb25lZCB0aHVtYm5haWwgaW4gYSBsaXN0IHZpZXcgY2F1c2VzIHByb2JsZW1zIHdpdGggZml4ZWQgcG9zaXRpb24gYnV0dG9ucyBhYm92ZSBpbiBhIG5hdiBiYXIKCQkvL3NldHRpbmcgdGhlIGxpJ3MgdG8gLXdlYmtpdC10cmFuc2Zvcm06dHJhbnNsYXRlM2QoMCwwLDApOyBzb2x2ZXMgdGhpcyBwcm9ibGVtIHRvIGF2b2lkZSBwb3RlbnRpYWwgaXNzdWVzIGluIG90aGVyCgkJLy9wbGF0Zm9ybXMgd2Ugc2NvcGUgdGhpcyB3aXRoIHRoZSBjbGFzcyB1aS1hbmRyb2lkLTJ4LWZpeAoJCV9iaW5kTGlzdFRodW1iV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1hbmRyb2lkLTJ4LWZpeGVkIiApOwoJCX0sCgkJLy90aGlzIGFkZHJlc3NlcyBpc3N1ZXMgIzQzMzcgRml4ZWQgaGVhZGVyIHByb2JsZW0gYWZ0ZXIgc2Nyb2xsaW5nIGNvbnRlbnQgb24gaU9TIGFuZCBBbmRyb2lkCgkJLy9hbmQgZGV2aWNlIGJ1Z3MgcHJvamVjdCBpc3N1ZSAjMSBGb3JtIGVsZW1lbnRzIGNhbiBsb3NlIGNsaWNrIGhpdCBhcmVhIGluIHBvc2l0aW9uOiBmaXhlZCBjb250YWluZXJzLgoJCS8vdGhpcyBhbHNvIGFkZHJlc3NlcyBub3Qgb24gZml4ZWQgdG9vbGJhcnMgcGFnZSBpbiBkb2NzCgkJLy9hZGRpbmcgMXB4IG9mIHBhZGRpbmcgdG8gdGhlIGJvdHRvbSB0aGVuIHJlbW92aW5nIGl0IGNhdXNlcyBhICJyZWRyYXciCgkJLy93aGljaCBwb3NpdGlvbnMgdGhlIHRvb2xiYXJzIGNvcnJlY3RseSAodGhleSB3aWxsIGFsd2F5cyBiZSB2aXN1YWxseSBjb3JyZWN0KQoJCV90cmlnZ2VyUmVkcmF3OiBmdW5jdGlvbigpIHsKCQkJdmFyIHBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCAkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiApICk7CgkJCS8vdHJpZ2dlciBwYWdlIHJlZHJhdyB0byBmaXggaW5jb3JyZWN0bHkgcG9zaXRpb25lZCBmaXhlZCBlbGVtZW50cwoJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiwgKCBwYWRkaW5nQm90dG9tICsgMSApICsgInB4IiApOwoJCQkvL2lmIHRoZSBwYWRkaW5nIGlzIHJlc2V0IHdpdGggb3V0IGEgdGltZW91dCB0aGUgcmVwb3NpdGlvbiB3aWxsIG5vdCBvY2N1cmUuCgkJCS8vdGhpcyBpcyBpbmRlcGVuZGFudCBvZiBKUU0gdGhlIGJyb3dzZXIgc2VlbXMgdG8gbmVlZCB0aGUgdGltZSB0byByZWFjdC4KCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiwgcGFkZGluZ0JvdHRvbSArICJweCIgKTsKCQkJfSwgMCApOwoJCX0sCgoJCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQkvL1JlbW92ZSB0aGUgY2xhc3Mgd2UgYWRkZWQgdG8gdGhlIHBhZ2UgcHJldmlvdXNseSBpbiBhbmRyb2lkIDIueAoJCQl0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlLWFjdGl2ZSIgKS5yZW1vdmVDbGFzcyggInVpLWFuZHJvaWQtMngtZml4IiApOwoJCX0KCX0pOwoKfSkoIGpRdWVyeSApOwoKCiggZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBpZUhhY2sgPSAoICQubW9iaWxlLmJyb3dzZXIub2xkSUUgJiYgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSA8PSA4ICksCgl1aVRlbXBsYXRlID0gJCgKCQkiPGRpdiBjbGFzcz0ndWktcG9wdXAtYXJyb3ctZ3VpZGUnPjwvZGl2PiIgKwoJCSI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1hcnJvdy1jb250YWluZXIiICsgKCBpZUhhY2sgPyAiIGllIiA6ICIiICkgKyAiJz4iICsKCQkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93Jz48L2Rpdj4iICsKCQkiPC9kaXY+IgoJKTsKCmZ1bmN0aW9uIGdldEFycm93KCkgewoJdmFyIGNsb25lID0gdWlUZW1wbGF0ZS5jbG9uZSgpLAoJCWdkID0gY2xvbmUuZXEoIDAgKSwKCQljdCA9IGNsb25lLmVxKCAxICksCgkJYXIgPSBjdC5jaGlsZHJlbigpOwoKCXJldHVybiB7IGFyRWxzOiBjdC5hZGQoIGdkICksIGdkOiBnZCwgY3Q6IGN0LCBhcjogYXIgfTsKfQoKJC53aWRnZXQoICJtb2JpbGUucG9wdXAiLCAkLm1vYmlsZS5wb3B1cCwgewoJb3B0aW9uczogewoKCQlhcnJvdzogIiIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyLAoJCQlyZXQgPSB0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5hcnJvdyApIHsKCQkJdGhpcy5fdWkuYXJyb3cgPSBhciA9IHRoaXMuX2FkZEFycm93KCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfYWRkQXJyb3c6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGVtZSwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJYXIgPSBnZXRBcnJvdygpOwoKCQl0aGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvcHRzLnRoZW1lICk7CgkJYXIuYXIuYWRkQ2xhc3MoIHRoZW1lICsgKCBvcHRzLnNoYWRvdyA/ICIgdWktb3ZlcmxheS1zaGFkb3ciIDogIiIgKSApOwoJCWFyLmFyRWxzLmhpZGUoKS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCXJldHVybiBhcjsKCX0sCgoJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9LAoKCS8vIFByZXRlbmQgdG8gc2hvdyBhbiBhcnJvdyBkZXNjcmliZWQgYnkgQHAgYW5kIEBkaXIgYW5kIGNhbGN1bGF0ZSB0aGUKCS8vIGRpc3RhbmNlIGZyb20gdGhlIGRlc2lyZWQgcG9pbnQuIElmIGEgYmVzdC1kaXN0YW5jZSBpcyBwYXNzZWQgaW4sIHJldHVybgoJLy8gdGhlIG1pbmltdW0gb2YgdGhlIG9uZSBwYXNzZWQgaW4gYW5kIHRoZSBvbmUgY2FsY3VsYXRlZC4KCV90cnlBbkFycm93OiBmdW5jdGlvbiggcCwgZGlyLCBkZXNpcmVkLCBzLCBiZXN0ICkgewoJCXZhciByZXN1bHQsIHIsIGRpZmYsIGRlc2lyZWRGb3JBcnJvdyA9IHt9LCB0aXAgPSB7fTsKCgkJLy8gSWYgdGhlIGFycm93IGhhcyBubyB3aWdnbGUgcm9vbSBhbG9uZyB0aGUgZWRnZSBvZiB0aGUgcG9wdXAsIGl0IGNhbm5vdAoJCS8vIGJlIGRpc3BsYXllZCBhbG9uZyB0aGUgcmVxdWVzdGVkIGVkZ2Ugd2l0aG91dCBpdCBzdGlja2luZyBvdXQuCgkJaWYgKCBzLmFyRnVsbFsgcC5kaW1LZXkgXSA+IHMuZ3VpZGVEaW1zWyBwLmRpbUtleSBdICkgewoJCQlyZXR1cm4gYmVzdDsKCQl9CgoJCWRlc2lyZWRGb3JBcnJvd1sgcC5mc3QgXSA9IGRlc2lyZWRbIHAuZnN0IF0gKwoJCQkoIHMuYXJIYWxmWyBwLm9EaW1LZXkgXSArIHMubWVudUhhbGZbIHAub0RpbUtleSBdICkgKiBwLm9mZnNldEZhY3RvciAtCgkJCXMuY29udGVudEJveFsgcC5mc3QgXSArICggcy5jbGFtcEluZm8ubWVudVNpemVbIHAub0RpbUtleSBdIC0gcy5jb250ZW50Qm94WyBwLm9EaW1LZXkgXSApICogcC5hcnJvd09mZnNldEZhY3RvcjsKCQlkZXNpcmVkRm9yQXJyb3dbIHAuc25kIF0gPSBkZXNpcmVkWyBwLnNuZCBdOwoKCQlyZXN1bHQgPSBzLnJlc3VsdCB8fCB0aGlzLl9jYWxjdWxhdGVGaW5hbExvY2F0aW9uKCBkZXNpcmVkRm9yQXJyb3csIHMuY2xhbXBJbmZvICk7CgkJciA9IHsgeDogcmVzdWx0LmxlZnQsIHk6IHJlc3VsdC50b3AgfTsKCgkJdGlwWyBwLmZzdCBdID0gclsgcC5mc3QgXSArIHMuY29udGVudEJveFsgcC5mc3QgXSArIHAudGlwT2Zmc2V0OwoJCXRpcFsgcC5zbmQgXSA9IE1hdGgubWF4KCByZXN1bHRbIHAucHJvcCBdICsgcy5ndWlkZU9mZnNldFsgcC5wcm9wIF0gKyBzLmFySGFsZlsgcC5kaW1LZXkgXSwKCQkJTWF0aC5taW4oIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmd1aWRlT2Zmc2V0WyBwLnByb3AgXSArIHMuZ3VpZGVEaW1zWyBwLmRpbUtleSBdIC0gcy5hckhhbGZbIHAuZGltS2V5IF0sCgkJCQlkZXNpcmVkWyBwLnNuZCBdICkgKTsKCgkJZGlmZiA9IE1hdGguYWJzKCBkZXNpcmVkLnggLSB0aXAueCApICsgTWF0aC5hYnMoIGRlc2lyZWQueSAtIHRpcC55ICk7CgkJaWYgKCAhYmVzdCB8fCBkaWZmIDwgYmVzdC5kaWZmICkgewoJCQkvLyBDb252ZXJ0IHRpcCBvZmZzZXQgdG8gY29vcmRpbmF0ZXMgaW5zaWRlIHRoZSBwb3B1cAoJCQl0aXBbIHAuc25kIF0gLT0gcy5hckhhbGZbIHAuZGltS2V5IF0gKyByZXN1bHRbIHAucHJvcCBdICsgcy5jb250ZW50Qm94WyBwLnNuZCBdOwoJCQliZXN0ID0geyBkaXI6IGRpciwgZGlmZjogZGlmZiwgcmVzdWx0OiByZXN1bHQsIHBvc1Byb3A6IHAucHJvcCwgcG9zVmFsOiB0aXBbIHAuc25kIF0gfTsKCQl9CgoJCXJldHVybiBiZXN0OwoJfSwKCglfZ2V0UGxhY2VtZW50U3RhdGU6IGZ1bmN0aW9uKCBjbGFtcCApIHsKCQl2YXIgb2Zmc2V0LCBnZE9mZnNldCwKCQkJYXIgPSB0aGlzLl91aS5hcnJvdywKCQkJc3RhdGUgPSB7CgkJCQljbGFtcEluZm86IHRoaXMuX2NsYW1wUG9wdXBXaWR0aCggIWNsYW1wICksCgkJCQlhckZ1bGw6IHsgY3g6IGFyLmN0LndpZHRoKCksIGN5OiBhci5jdC5oZWlnaHQoKSB9LAoJCQkJZ3VpZGVEaW1zOiB7IGN4OiBhci5nZC53aWR0aCgpLCBjeTogYXIuZ2QuaGVpZ2h0KCkgfSwKCQkJCWd1aWRlT2Zmc2V0OiBhci5nZC5vZmZzZXQoKQoJCQl9OwoKCQlvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCk7CgoJCWFyLmdkLmNzcyggeyBsZWZ0OiAwLCB0b3A6IDAsIHJpZ2h0OiAwLCBib3R0b206IDAgfSApOwoJCWdkT2Zmc2V0ID0gYXIuZ2Qub2Zmc2V0KCk7CgkJc3RhdGUuY29udGVudEJveCA9IHsKCQkJeDogZ2RPZmZzZXQubGVmdCAtIG9mZnNldC5sZWZ0LAoJCQl5OiBnZE9mZnNldC50b3AgLSBvZmZzZXQudG9wLAoJCQljeDogYXIuZ2Qud2lkdGgoKSwKCQkJY3k6IGFyLmdkLmhlaWdodCgpCgkJfTsKCQlhci5nZC5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgoJCS8vIFRoZSBhcnJvdyBib3ggbW92ZXMgYmV0d2VlbiBndWlkZU9mZnNldCBhbmQgZ3VpZGVPZmZzZXQgKyBndWlkZURpbXMgLSBhckZ1bGwKCQlzdGF0ZS5ndWlkZU9mZnNldCA9IHsgbGVmdDogc3RhdGUuZ3VpZGVPZmZzZXQubGVmdCAtIG9mZnNldC5sZWZ0LCB0b3A6IHN0YXRlLmd1aWRlT2Zmc2V0LnRvcCAtIG9mZnNldC50b3AgfTsKCQlzdGF0ZS5hckhhbGYgPSB7IGN4OiBzdGF0ZS5hckZ1bGwuY3ggLyAyLCBjeTogc3RhdGUuYXJGdWxsLmN5IC8gMiB9OwoJCXN0YXRlLm1lbnVIYWxmID0geyBjeDogc3RhdGUuY2xhbXBJbmZvLm1lbnVTaXplLmN4IC8gMiwgY3k6IHN0YXRlLmNsYW1wSW5mby5tZW51U2l6ZS5jeSAvIDIgfTsKCgkJcmV0dXJuIHN0YXRlOwoJfSwKCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQl2YXIgc3RhdGUsIGJlc3QsIHBhcmFtcywgZWxPZmZzZXQsIGJnUmVmLAoJCQlvcHRpb25WYWx1ZSA9IHRoaXMub3B0aW9ucy5hcnJvdywKCQkJYXIgPSB0aGlzLl91aS5hcnJvdzsKCgkJaWYgKCAhYXIgKSB7CgkJCXJldHVybiB0aGlzLl9zdXBlciggZGVzaXJlZCApOwoJCX0KCgkJYXIuYXJFbHMuc2hvdygpOwoKCQliZ1JlZiA9IHt9OwoJCXN0YXRlID0gdGhpcy5fZ2V0UGxhY2VtZW50U3RhdGUoIHRydWUgKTsKCQlwYXJhbXMgPSB7CgkJCSJsIjogeyBmc3Q6ICJ4Iiwgc25kOiAieSIsIHByb3A6ICJ0b3AiLCBkaW1LZXk6ICJjeSIsIG9EaW1LZXk6ICJjeCIsIG9mZnNldEZhY3RvcjogMSwgdGlwT2Zmc2V0OiAgLXN0YXRlLmFySGFsZi5jeCwgYXJyb3dPZmZzZXRGYWN0b3I6IDAgfSwKCQkJInIiOiB7IGZzdDogIngiLCBzbmQ6ICJ5IiwgcHJvcDogInRvcCIsIGRpbUtleTogImN5Iiwgb0RpbUtleTogImN4Iiwgb2Zmc2V0RmFjdG9yOiAtMSwgdGlwT2Zmc2V0OiBzdGF0ZS5hckhhbGYuY3ggKyBzdGF0ZS5jb250ZW50Qm94LmN4LCBhcnJvd09mZnNldEZhY3RvcjogMSB9LAoJCQkiYiI6IHsgZnN0OiAieSIsIHNuZDogIngiLCBwcm9wOiAibGVmdCIsIGRpbUtleTogImN4Iiwgb0RpbUtleTogImN5Iiwgb2Zmc2V0RmFjdG9yOiAtMSwgdGlwT2Zmc2V0OiBzdGF0ZS5hckhhbGYuY3kgKyBzdGF0ZS5jb250ZW50Qm94LmN5LCBhcnJvd09mZnNldEZhY3RvcjogMSB9LAoJCQkidCI6IHsgZnN0OiAieSIsIHNuZDogIngiLCBwcm9wOiAibGVmdCIsIGRpbUtleTogImN4Iiwgb0RpbUtleTogImN5Iiwgb2Zmc2V0RmFjdG9yOiAxLCB0aXBPZmZzZXQ6IC1zdGF0ZS5hckhhbGYuY3ksIGFycm93T2Zmc2V0RmFjdG9yOiAwIH0KCQl9OwoKCQkvLyBUcnkgZWFjaCBzaWRlIHNwZWNpZmllZCBpbiB0aGUgb3B0aW9ucyB0byBzZWUgb24gd2hpY2ggb25lIHRoZSBhcnJvdwoJCS8vIHNob3VsZCBiZSBwbGFjZWQgc3VjaCB0aGF0IHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSB0aXAgb2YgdGhlIGFycm93IGFuZAoJCS8vIHRoZSBkZXNpcmVkIGNvb3JkaW5hdGVzIGlzIHRoZSBzaG9ydGVzdC4KCQkkLmVhY2goICggb3B0aW9uVmFsdWUgPT09IHRydWUgPyAibCx0LHIsYiIgOiBvcHRpb25WYWx1ZSApLnNwbGl0KCAiLCIgKSwKCQkJJC5wcm94eSggZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQliZXN0ID0gdGhpcy5fdHJ5QW5BcnJvdyggcGFyYW1zWyB2YWx1ZSBdLCB2YWx1ZSwgZGVzaXJlZCwgc3RhdGUsIGJlc3QgKTsKCQkJfSwgdGhpcyApICk7CgoJCS8vIENvdWxkIG5vdCBwbGFjZSB0aGUgYXJyb3cgYWxvbmcgYW55IG9mIHRoZSBlZGdlcyAtIGJlaGF2ZSBhcyBpZiBzaG93aW5nCgkJLy8gdGhlIGFycm93IHdhcyB0dXJuZWQgb2ZmLgoJCWlmICggIWJlc3QgKSB7CgkJCWFyLmFyRWxzLmhpZGUoKTsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBkZXNpcmVkICk7CgkJfQoKCQkvLyBNb3ZlIHRoZSBhcnJvdyBpbnRvIHBsYWNlCgkJYXIuY3QKCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtYXJyb3ctbCB1aS1wb3B1cC1hcnJvdy10IHVpLXBvcHVwLWFycm93LXIgdWktcG9wdXAtYXJyb3ctYiIgKQoJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1hcnJvdy0iICsgYmVzdC5kaXIgKQoJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApLmNzcyggYmVzdC5wb3NQcm9wLCBiZXN0LnBvc1ZhbCApCgkJCS5zaG93KCk7CgoJCS8vIERvIG5vdCBtb3ZlL3NpemUgdGhlIGJhY2tncm91bmQgZGl2IG9uIElFLCBiZWNhdXNlIHdlIHVzZSB0aGUgYXJyb3cgZGl2IGZvciBiYWNrZ3JvdW5kIGFzIHdlbGwuCgkJaWYgKCAhaWVIYWNrICkgewoJCQllbE9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKTsKCQkJYmdSZWZbIHBhcmFtc1sgYmVzdC5kaXIgXS5mc3QgXSA9IGFyLmN0Lm9mZnNldCgpOwoJCQliZ1JlZlsgcGFyYW1zWyBiZXN0LmRpciBdLnNuZCBdID0gewoJCQkJbGVmdDogZWxPZmZzZXQubGVmdCArIHN0YXRlLmNvbnRlbnRCb3gueCwKCQkJCXRvcDogZWxPZmZzZXQudG9wICsgc3RhdGUuY29udGVudEJveC55CgkJCX07CgkJfQoKCQlyZXR1cm4gYmVzdC5yZXN1bHQ7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0cyApIHsKCQl2YXIgbmV3VGhlbWUsCgkJCW9sZFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lLAoJCQlhciA9IHRoaXMuX3VpLmFycm93LAoJCQlyZXQgPSB0aGlzLl9zdXBlciggb3B0cyApOwoKCQlpZiAoIG9wdHMuYXJyb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAhYXIgJiYgb3B0cy5hcnJvdyApIHsKCQkJCXRoaXMuX3VpLmFycm93ID0gdGhpcy5fYWRkQXJyb3coKTsKCgkJCQkvLyBJbXBvcnRhbnQgdG8gcmV0dXJuIGhlcmUgc28gd2UgZG9uJ3Qgc2V0IHRoZSBzYW1lIG9wdGlvbnMgYWxsIG92ZXIKCQkJCS8vIGFnYWluIGJlbG93LgoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgaWYgKCBhciAmJiAhb3B0cy5hcnJvdyApIHsKCQkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCQkJdGhpcy5fdWkuYXJyb3cgPSBudWxsOwoJCQl9CgkJfQoKCQkvLyBSZWFzc2lnbiB3aXRoIHBvdGVudGlhbGx5IG5ldyBhcnJvdwoJCWFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb2xkVGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgb2xkVGhlbWUgKTsKCQkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQkJCWFyLmFyLnJlbW92ZUNsYXNzKCBvbGRUaGVtZSApLmFkZENsYXNzKCBuZXdUaGVtZSApOwoJCQl9CgoJCQlpZiAoIG9wdHMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlhci5hci50b2dnbGVDbGFzcyggInVpLW92ZXJsYXktc2hhZG93Iiwgb3B0cy5zaGFkb3cgKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHJldDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBhciA9IHRoaXMuX3VpLmFycm93OwoKCQlpZiAoIGFyICkgewoJCQlhci5hckVscy5yZW1vdmUoKTsKCQl9CgoJCXJldHVybiB0aGlzLl9zdXBlcigpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnBhbmVsIiwgewoJb3B0aW9uczogewoJCWNsYXNzZXM6IHsKCQkJcGFuZWw6ICJ1aS1wYW5lbCIsCgkJCXBhbmVsT3BlbjogInVpLXBhbmVsLW9wZW4iLAoJCQlwYW5lbENsb3NlZDogInVpLXBhbmVsLWNsb3NlZCIsCgkJCXBhbmVsRml4ZWQ6ICJ1aS1wYW5lbC1maXhlZCIsCgkJCXBhbmVsSW5uZXI6ICJ1aS1wYW5lbC1pbm5lciIsCgkJCW1vZGFsOiAidWktcGFuZWwtZGlzbWlzcyIsCgkJCW1vZGFsT3BlbjogInVpLXBhbmVsLWRpc21pc3Mtb3BlbiIsCgkJCXBhZ2VDb250YWluZXI6ICJ1aS1wYW5lbC1wYWdlLWNvbnRhaW5lciIsCgkJCXBhZ2VXcmFwcGVyOiAidWktcGFuZWwtd3JhcHBlciIsCgkJCXBhZ2VGaXhlZFRvb2xiYXI6ICJ1aS1wYW5lbC1maXhlZC10b29sYmFyIiwKCQkJcGFnZUNvbnRlbnRQcmVmaXg6ICJ1aS1wYW5lbC1wYWdlLWNvbnRlbnQiLCAvKiBVc2VkIGZvciB3cmFwcGVyIGFuZCBmaXhlZCB0b29sYmFycyBwb3NpdGlvbiwgZGlzcGxheSBhbmQgb3BlbiBjbGFzc2VzLiAqLwoJCQlhbmltYXRlOiAidWktcGFuZWwtYW5pbWF0ZSIKCQl9LAoJCWFuaW1hdGU6IHRydWUsCgkJdGhlbWU6IG51bGwsCgkJcG9zaXRpb246ICJsZWZ0IiwKCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCQlkaXNwbGF5OiAicmV2ZWFsIiwgLy9hY2NlcHRzIHJldmVhbCwgcHVzaCwgb3ZlcmxheQoJCXN3aXBlQ2xvc2U6IHRydWUsCgkJcG9zaXRpb25GaXhlZDogZmFsc2UKCX0sCgoJX2Nsb3NlTGluazogbnVsbCwKCV9wYXJlbnRQYWdlOiBudWxsLAoJX3BhZ2U6IG51bGwsCglfbW9kYWw6IG51bGwsCglfcGFuZWxJbm5lcjogbnVsbCwKCV93cmFwcGVyOiBudWxsLAoJX2ZpeGVkVG9vbGJhcnM6IG51bGwsCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gZWwuY2xvc2VzdCggIi51aS1wYWdlLCA6anFtRGF0YShyb2xlPSdwYWdlJykiICk7CgoJCS8vIGV4cG9zZSBzb21lIHByaXZhdGUgcHJvcHMgdG8gb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9jbG9zZUxpbms6IGVsLmZpbmQoICI6anFtRGF0YShyZWw9J2Nsb3NlJykiICksCgkJCV9wYXJlbnRQYWdlOiAoIHBhcmVudFBhZ2UubGVuZ3RoID4gMCApID8gcGFyZW50UGFnZSA6IGZhbHNlLAoJCQlfb3BlbmVkUGFnZTogbnVsbCwKCQkJX3BhZ2U6IHRoaXMuX2dldFBhZ2UsCgkJCV9wYW5lbElubmVyOiB0aGlzLl9nZXRQYW5lbElubmVyKCksCgkJCV9maXhlZFRvb2xiYXJzOiB0aGlzLl9nZXRGaXhlZFRvb2xiYXJzCgkJfSk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICl7CgkJCXRoaXMuX2dldFdyYXBwZXIoKTsKCQl9CgkJdGhpcy5fYWRkUGFuZWxDbGFzc2VzKCk7CgoJCS8vIGlmIGFuaW1hdGluZywgYWRkIHRoZSBjbGFzcyB0byBkbyBzbwoJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhdGhpcy5vcHRpb25zLmFuaW1hdGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCX0KCgkJdGhpcy5fYmluZFVwZGF0ZUxheW91dCgpOwoJCXRoaXMuX2JpbmRDbG9zZUV2ZW50cygpOwoJCXRoaXMuX2JpbmRMaW5rTGlzdGVuZXJzKCk7CgkJdGhpcy5fYmluZFBhZ2VFdmVudHMoKTsKCgkJaWYgKCAhIXRoaXMub3B0aW9ucy5kaXNtaXNzaWJsZSApIHsKCQkJdGhpcy5fY3JlYXRlTW9kYWwoKTsKCQl9CgoJCXRoaXMuX2JpbmRTd2lwZUV2ZW50cygpOwoJfSwKCglfZ2V0UGFuZWxJbm5lcjogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsSW5uZXIgPSB0aGlzLmVsZW1lbnQuZmluZCggIi4iICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciApOwoKCQlpZiAoIHBhbmVsSW5uZXIubGVuZ3RoID09PSAwICkgewoJCQlwYW5lbElubmVyID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCkud3JhcEFsbCggIjxkaXYgY2xhc3M9JyIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbElubmVyICsgIicgLz4iICkucGFyZW50KCk7CgkJfQoKCQlyZXR1cm4gcGFuZWxJbm5lcjsKCX0sCgoJX2NyZWF0ZU1vZGFsOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCXRhcmdldCA9IHNlbGYuX3BhcmVudFBhZ2UgPyBzZWxmLl9wYXJlbnRQYWdlLnBhcmVudCgpIDogc2VsZi5lbGVtZW50LnBhcmVudCgpOwoKCQlzZWxmLl9tb2RhbCA9ICQoICI8ZGl2IGNsYXNzPSciICsgc2VsZi5vcHRpb25zLmNsYXNzZXMubW9kYWwgKyAiJz48L2Rpdj4iICkKCQkJLm9uKCAibW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmNsb3NlKCk7CgkJCX0pCgkJCS5hcHBlbmRUbyggdGFyZ2V0ICk7Cgl9LAoKCV9nZXRQYWdlOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFnZSA9IHRoaXMuX29wZW5lZFBhZ2UgfHwgdGhpcy5fcGFyZW50UGFnZSB8fCAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCgkJcmV0dXJuIHBhZ2U7Cgl9LAoKCV9nZXRXcmFwcGVyOiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuX3BhZ2UoKS5maW5kKCAiLiIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlV3JhcHBlciApOwoJCWlmICggd3JhcHBlci5sZW5ndGggPT09IDAgKSB7CgkJCXdyYXBwZXIgPSB0aGlzLl9wYWdlKCkuY2hpbGRyZW4oICIudWktaGVhZGVyOm5vdCgudWktaGVhZGVyLWZpeGVkKSwgLnVpLWNvbnRlbnQ6bm90KC51aS1wb3B1cCksIC51aS1mb290ZXI6bm90KC51aS1mb290ZXItZml4ZWQpIiApCgkJCQkud3JhcEFsbCggIjxkaXYgY2xhc3M9JyIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlV3JhcHBlciArICInPjwvZGl2PiIgKQoJCQkJLnBhcmVudCgpOwoJCX0KCgkJdGhpcy5fd3JhcHBlciA9IHdyYXBwZXI7Cgl9LAoKCV9nZXRGaXhlZFRvb2xiYXJzOiBmdW5jdGlvbigpIHsKCQl2YXIgZXh0Rml4ZWRUb29sYmFycyA9ICQoICJib2R5IiApLmNoaWxkcmVuKCAiLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCIgKSwKCQkJaW50Rml4ZWRUb29sYmFycyA9IHRoaXMuX3BhZ2UoKS5maW5kKCAiLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCIgKSwKCQkJZml4ZWRUb29sYmFycyA9IGV4dEZpeGVkVG9vbGJhcnMuYWRkKCBpbnRGaXhlZFRvb2xiYXJzICkuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhZ2VGaXhlZFRvb2xiYXIgKTsKCgkJcmV0dXJuIGZpeGVkVG9vbGJhcnM7Cgl9LAoKCV9nZXRQb3NEaXNwbGF5Q2xhc3NlczogZnVuY3Rpb24oIHByZWZpeCApIHsKCQlyZXR1cm4gcHJlZml4ICsgIi1wb3NpdGlvbi0iICsgdGhpcy5vcHRpb25zLnBvc2l0aW9uICsgIiAiICsgcHJlZml4ICsgIi1kaXNwbGF5LSIgKyB0aGlzLm9wdGlvbnMuZGlzcGxheTsKCX0sCgoJX2dldFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhbmVsQ2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICsKCQkJIiAiICsgdGhpcy5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsICkgKwoJCQkiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbENsb3NlZCArCgkJCSIgIiArICJ1aS1ib2R5LSIgKyAoIHRoaXMub3B0aW9ucy50aGVtZSA/IHRoaXMub3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiApOwoKCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgKSB7CgkJCXBhbmVsQ2xhc3NlcyArPSAiICIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkOwoJCX0KCgkJcmV0dXJuIHBhbmVsQ2xhc3NlczsKCX0sCgoJX2FkZFBhbmVsQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSApOwoJfSwKCglfaGFuZGxlQ2xvc2VDbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJfSwKCglfYmluZENsb3NlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggdGhpcy5fY2xvc2VMaW5rLCB7CgkJCSJjbGljayI6ICJfaGFuZGxlQ2xvc2VDbGljayIKCQl9KTsKCgkJdGhpcy5fb24oewoJCQkiY2xpY2sgYTpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiOiAiX2hhbmRsZUNsb3NlQ2xpY2siCgkJfSk7Cgl9LAoKCV9wb3NpdGlvblBhbmVsOiBmdW5jdGlvbiggc2Nyb2xsVG9Ub3AgKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlwYW5lbElubmVySGVpZ2h0ID0gc2VsZi5fcGFuZWxJbm5lci5vdXRlckhlaWdodCgpLAoJCQlleHBhbmQgPSBwYW5lbElubmVySGVpZ2h0ID4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCWlmICggZXhwYW5kIHx8ICFzZWxmLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJaWYgKCBleHBhbmQgKSB7CgkJCQlzZWxmLl91bmZpeFBhbmVsKCk7CgkJCQkkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQoIHBhbmVsSW5uZXJIZWlnaHQgKTsKCQkJfQoJCQlpZiAoIHNjcm9sbFRvVG9wICkgewoJCQkJdGhpcy53aW5kb3dbIDAgXS5zY3JvbGxUbyggMCwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJfQoJfSwKCglfYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggJCggd2luZG93ICksIHsgInRocm90dGxlZHJlc2l6ZSI6ICJfcG9zaXRpb25QYW5lbCIgfSk7Cgl9LAoKCV91bmJpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb2ZmKCAkKCB3aW5kb3cgKSwgInRocm90dGxlZHJlc2l6ZSIgKTsKCX0sCgoJX3VuZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfYmluZFVwZGF0ZUxheW91dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLmVsZW1lbnQub24oICJ1cGRhdGVsYXlvdXQiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJfQoJCX0pOwoJfSwKCglfYmluZExpbmtMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAiYm9keSIsIHsKCQkJImNsaWNrIGEiOiAiX2hhbmRsZUNsaWNrIgoJCX0pOwoKCX0sCgoJX2hhbmRsZUNsaWNrOiBmdW5jdGlvbiggZSApIHsKCQl2YXIgbGluaywKCQkJcGFuZWxJZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICk7CgoJCWlmICggZS5jdXJyZW50VGFyZ2V0LmhyZWYuc3BsaXQoICIjIiApWyAxIF0gPT09IHBhbmVsSWQgJiYgcGFuZWxJZCAhPT0gdW5kZWZpbmVkICkgewoKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlsaW5rID0gJCggZS50YXJnZXQgKTsKCQkJaWYgKCBsaW5rLmhhc0NsYXNzKCAidWktYnRuIiApICkgewoJCQkJbGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCXRoaXMuZWxlbWVudC5vbmUoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQl9KTsKCQkJfQoJCQl0aGlzLnRvZ2dsZSgpOwoJCX0KCX0sCgoJX2JpbmRTd2lwZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlhcmVhID0gc2VsZi5fbW9kYWwgPyBzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl9tb2RhbCApIDogc2VsZi5lbGVtZW50OwoKCQkvLyBvbiBzd2lwZSwgY2xvc2UgdGhlIHBhbmVsCgkJaWYgKCAhIXNlbGYub3B0aW9ucy5zd2lwZUNsb3NlICkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wb3NpdGlvbiA9PT0gImxlZnQiICkgewoJCQkJYXJlYS5vbiggInN3aXBlbGVmdC5wYW5lbCIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCWFyZWEub24oICJzd2lwZXJpZ2h0LnBhbmVsIiwgZnVuY3Rpb24oLyogZSAqLykgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoJCQl9CgkJfQoJfSwKCglfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5kb2N1bWVudAoJCQkvLyBDbG9zZSB0aGUgcGFuZWwgaWYgYW5vdGhlciBwYW5lbCBvbiB0aGUgcGFnZSBvcGVucwoJCQkub24oICJwYW5lbGJlZm9yZW9wZW4iLCBmdW5jdGlvbiggZSApIHsKCQkJCWlmICggc2VsZi5fb3BlbiAmJiBlLnRhcmdldCAhPT0gc2VsZi5lbGVtZW50WyAwIF0gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KQoJCQkvLyBPbiBlc2NhcGUsIGNsb3NlPyBtaWdodCBuZWVkIHRvIGhhdmUgYSB0YXJnZXQgY2hlY2sgdG9vLi4uCgkJCS5vbiggImtleXVwLnBhbmVsIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIGUua2V5Q29kZSA9PT0gMjcgJiYgc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgkJCX0pOwoJCWlmICggIXRoaXMuX3BhcmVudFBhZ2UgJiYgdGhpcy5vcHRpb25zLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJdGhpcy5fb24oIHRoaXMuZG9jdW1lbnQsIHsKCQkJCSJwYWdlc2hvdyI6ICJfZ2V0V3JhcHBlciIKCQkJfSk7CgkJfQoJCS8vIENsZWFuIHVwIG9wZW4gcGFuZWxzIGFmdGVyIHBhZ2UgaGlkZQoJCWlmICggc2VsZi5fcGFyZW50UGFnZSApIHsKCQkJdGhpcy5kb2N1bWVudC5vbiggInBhZ2VoaWRlIiwgIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBzZWxmLl9vcGVuICkgewoJCQkJCXNlbGYuY2xvc2UoIHRydWUgKTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5kb2N1bWVudC5vbiggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9Cgl9LAoKCS8vIHN0YXRlIHN0b3JhZ2Ugb2Ygb3BlbiBvciBjbG9zZWQKCV9vcGVuOiBmYWxzZSwKCV9wYWdlQ29udGVudE9wZW5DbGFzc2VzOiBudWxsLAoJX21vZGFsT3BlbkNsYXNzZXM6IG51bGwsCgoJb3BlbjogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoICF0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoKCQkJCV9vcGVuUGFuZWwgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLl9vZmYoIHNlbGYuZG9jdW1lbnQgLCAicGFuZWxjbG9zZSIgKTsKCQkJCQlzZWxmLl9wYWdlKCkuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLmFkZENsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoKCQkJCQlpZiAoICFpbW1lZGlhdGUgJiYgJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCQkoIHNlbGYuX3dyYXBwZXIgfHwgc2VsZi5lbGVtZW50ICkKCQkJCQkJCS5hbmltYXRpb25Db21wbGV0ZSggY29tcGxldGUsICJ0cmFuc2l0aW9uIiApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldFRpbWVvdXQoIGNvbXBsZXRlLCAwICk7CgkJCQkJfQoKCQkJCQlpZiAoIG8udGhlbWUgJiYgby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UoKS5wYXJlbnQoKQoJCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItdGhlbWVkICIgKyBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItIiArIG8udGhlbWUgKTsKCQkJCQl9CgoJCQkJCXNlbGYuZWxlbWVudAoJCQkJCQkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbENsb3NlZCApCgkJCQkJCS5hZGRDbGFzcyggby5jbGFzc2VzLnBhbmVsT3BlbiApOwoKCQkJCQlzZWxmLl9wb3NpdGlvblBhbmVsKCB0cnVlICk7CgoJCQkJCXNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICk7CgoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UoKS5wYXJlbnQoKS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKTsKCQkJCQkJc2VsZi5fd3JhcHBlci5hZGRDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX21vZGFsT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLm1vZGFsICkgKyAiICIgKyBvLmNsYXNzZXMubW9kYWxPcGVuOwoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsCgkJCQkJCQkuYWRkQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKQoJCQkJCQkJLmhlaWdodCggTWF0aC5tYXgoIHNlbGYuX21vZGFsLmhlaWdodCgpLCBzZWxmLmRvY3VtZW50LmhlaWdodCgpICkgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCgkJCQkJLy8gQmFpbCBpZiB0aGUgcGFuZWwgd2FzIGNsb3NlZCBiZWZvcmUgdGhlIG9wZW5pbmcgYW5pbWF0aW9uIGhhcyBjb21wbGV0ZWQKCQkJCQlpZiAoICFzZWxmLl9vcGVuICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCX0KCgkJCQkJc2VsZi5fYmluZEZpeExpc3RlbmVyKCk7CgoJCQkJCXNlbGYuX3RyaWdnZXIoICJvcGVuIiApOwoKCQkJCQlzZWxmLl9vcGVuZWRQYWdlID0gc2VsZi5fcGFnZSgpOwoJCQkJfTsKCgkJCXNlbGYuX3RyaWdnZXIoICJiZWZvcmVvcGVuIiApOwoKCQkJaWYgKCBzZWxmLl9wYWdlKCkuanFtRGF0YSggInBhbmVsIiApID09PSAib3BlbiIgKSB7CgkJCQlzZWxmLl9vbiggc2VsZi5kb2N1bWVudCwgewoJCQkJCSJwYW5lbGNsb3NlIjogX29wZW5QYW5lbAoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlfb3BlblBhbmVsKCk7CgkJCX0KCgkJCXNlbGYuX29wZW4gPSB0cnVlOwoJCX0KCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gdGhpcy5vcHRpb25zLAoKCQkJCV9jbG9zZVBhbmVsID0gZnVuY3Rpb24oKSB7CgoJCQkJCXNlbGYuZWxlbWVudC5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsT3BlbiApOwoKCQkJCQlpZiAoIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCX0KCgkJCQkJaWYgKCAhaW1tZWRpYXRlICYmICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQkJKCBzZWxmLl93cmFwcGVyIHx8IHNlbGYuZWxlbWVudCApCgkJCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoIGNvbXBsZXRlLCAidHJhbnNpdGlvbiIgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRUaW1lb3V0KCBjb21wbGV0ZSwgMCApOwoJCQkJCX0KCgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwKCQkJCQkJCS5yZW1vdmVDbGFzcyggc2VsZi5fbW9kYWxPcGVuQ2xhc3NlcyApCgkJCQkJCQkuaGVpZ2h0KCAiIiApOwoJCQkJCX0KCQkJCX0sCgkJCQljb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewoJCQkJCWlmICggby50aGVtZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItdGhlbWVkICIgKyBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciArICItIiArIG8udGhlbWUgKTsKCQkJCQl9CgoJCQkJCXNlbGYuZWxlbWVudC5hZGRDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICk7CgoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3BhZ2UoKS5wYXJlbnQoKS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250YWluZXIgKTsKCQkJCQkJc2VsZi5fd3JhcHBlci5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQl9CgoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9maXhQYW5lbCgpOwoJCQkJCXNlbGYuX3VuYmluZEZpeExpc3RlbmVyKCk7CgkJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgoJCQkJCXNlbGYuX3BhZ2UoKS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgoJCQkJCXNlbGYuX3RyaWdnZXIoICJjbG9zZSIgKTsKCgkJCQkJc2VsZi5fb3BlbmVkUGFnZSA9IG51bGw7CgkJCQl9OwoKCQkJc2VsZi5fdHJpZ2dlciggImJlZm9yZWNsb3NlIiApOwoKCQkJX2Nsb3NlUGFuZWwoKTsKCgkJCXNlbGYuX29wZW4gPSBmYWxzZTsKCQl9Cgl9LAoKCXRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdGhpc1sgdGhpcy5fb3BlbiA/ICJjbG9zZSIgOiAib3BlbiIgXSgpOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIG90aGVyUGFuZWxzLAoJCW8gPSB0aGlzLm9wdGlvbnMsCgkJbXVsdGlwbGVQYW5lbHMgPSAoICQoICJib2R5ID4gOm1vYmlsZS1wYW5lbCIgKS5sZW5ndGggKyAkLm1vYmlsZS5hY3RpdmVQYWdlLmZpbmQoICI6bW9iaWxlLXBhbmVsIiApLmxlbmd0aCApID4gMTsKCgkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCgkJCS8vICByZW1vdmUgdGhlIHdyYXBwZXIgaWYgbm90IGluIHVzZSBieSBhbm90aGVyIHBhbmVsCgkJCW90aGVyUGFuZWxzID0gJCggImJvZHkgPiA6bW9iaWxlLXBhbmVsIiApLmFkZCggJC5tb2JpbGUuYWN0aXZlUGFnZS5maW5kKCAiOm1vYmlsZS1wYW5lbCIgKSApOwoJCQlpZiAoIG90aGVyUGFuZWxzLm5vdCggIi51aS1wYW5lbC1kaXNwbGF5LW92ZXJsYXkiICkubm90KCB0aGlzLmVsZW1lbnQgKS5sZW5ndGggPT09IDAgKSB7CgkJCQl0aGlzLl93cmFwcGVyLmNoaWxkcmVuKCkudW53cmFwKCk7CgkJCX0KCgkJCWlmICggdGhpcy5fb3BlbiApIHsKCgkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCgkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQl9CgoJCQkJdGhpcy5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoKCQkJCWlmICggby50aGVtZSApIHsKCQkJCQl0aGlzLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJfQoJCQl9CgkJfQoKCQlpZiAoICFtdWx0aXBsZVBhbmVscyApIHsKCgkJCXRoaXMuZG9jdW1lbnQub2ZmKCAicGFuZWxvcGVuIHBhbmVsY2xvc2UiICk7CgoJCX0KCgkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQl0aGlzLl9wYWdlKCkuanFtUmVtb3ZlRGF0YSggInBhbmVsIiApOwoJCX0KCgkJdGhpcy5fcGFuZWxJbm5lci5jaGlsZHJlbigpLnVud3JhcCgpOwoKCQl0aGlzLmVsZW1lbnQKCQkJLnJlbW92ZUNsYXNzKCBbIHRoaXMuX2dldFBhbmVsQ2xhc3NlcygpLCBvLmNsYXNzZXMucGFuZWxPcGVuLCBvLmNsYXNzZXMuYW5pbWF0ZSBdLmpvaW4oICIgIiApICkKCQkJLm9mZiggInN3aXBlbGVmdC5wYW5lbCBzd2lwZXJpZ2h0LnBhbmVsIiApCgkJCS5vZmYoICJwYW5lbGJlZm9yZW9wZW4iICkKCQkJLm9mZiggInBhbmVsaGlkZSIgKQoJCQkub2ZmKCAia2V5dXAucGFuZWwiICkKCQkJLm9mZiggInVwZGF0ZWxheW91dCIgKTsKCgkJaWYgKCB0aGlzLl9tb2RhbCApIHsKCQkJdGhpcy5fbW9kYWwucmVtb3ZlKCk7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGFibGUiLCB7CglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQl0YWJsZTogInVpLXRhYmxlIgoJCX0sCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy50YWJsZSApOwoJCX0KCgkJLy8gZXh0ZW5kIGhlcmUsIGFzc2lnbiBvbiByZWZyZXNoID4gX3NldEhlYWRlcnMKCQkkLmV4dGVuZCggdGhpcywgewoKCQkJLy8gRXhwb3NlIGhlYWRlcnMgYW5kIGFsbEhlYWRlcnMgcHJvcGVydGllcyBvbiB0aGUgd2lkZ2V0CgkJCS8vIGhlYWRlcnMgcmVmZXJlbmNlcyB0aGUgVEhzIHdpdGhpbiB0aGUgZmlyc3QgVFIgaW4gdGhlIHRhYmxlCgkJCWhlYWRlcnM6IHVuZGVmaW5lZCwKCgkJCS8vIGFsbEhlYWRlcnMgcmVmZXJlbmNlcyBoZWFkZXJzLCBwbHVzIGFsbCBUSHMgaW4gdGhlIHRoZWFkLCB3aGljaCBtYXkKCQkJLy8gaW5jbHVkZSBzZXZlcmFsIHJvd3MsIG9yIG5vdAoJCQlhbGxIZWFkZXJzOiB1bmRlZmluZWQKCQl9KTsKCgkJdGhpcy5fcmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfc2V0SGVhZGVyczogZnVuY3Rpb24oKSB7CgkJdmFyIHRycyA9IHRoaXMuZWxlbWVudC5maW5kKCAidGhlYWQgdHIiICk7CgoJCXRoaXMuaGVhZGVycyA9IHRoaXMuZWxlbWVudC5maW5kKCAidHI6ZXEoMCkiICkuY2hpbGRyZW4oKTsKCQl0aGlzLmFsbEhlYWRlcnMgPSB0aGlzLmhlYWRlcnMuYWRkKCB0cnMuY2hpbGRyZW4oKSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCk7Cgl9LAoKCXJlYnVpbGQ6ICQubm9vcCwKCglfcmVmcmVzaDogZnVuY3Rpb24oIC8qIGNyZWF0ZSAqLyApIHsKCQl2YXIgdGFibGUgPSB0aGlzLmVsZW1lbnQsCgkJCXRycyA9IHRhYmxlLmZpbmQoICJ0aGVhZCB0ciIgKTsKCgkJLy8gdXBkYXRpbmcgaGVhZGVycyBvbiByZWZyZXNoIChmaXhlcyAjNTg4MCkKCQl0aGlzLl9zZXRIZWFkZXJzKCk7CgoJCS8vIEl0ZXJhdGUgb3ZlciB0aGUgdHJzCgkJdHJzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgY29sdW1uQ291bnQgPSAwOwoKCQkJLy8gSXRlcmF0ZSBvdmVyIHRoZSBjaGlsZHJlbiBvZiB0aGUgdHIKCQkJJCggdGhpcyApLmNoaWxkcmVuKCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCQl2YXIgc3BhbiA9IHBhcnNlSW50KCB0aGlzLmdldEF0dHJpYnV0ZSggImNvbHNwYW4iICksIDEwICksCgkJCQkJc2VsZWN0b3IgPSAiOm50aC1jaGlsZCgiICsgKCBjb2x1bW5Db3VudCArIDEgKSArICIpIiwKCQkJCQlqOwoKCQkJCXRoaXMuc2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiY29sc3RhcnQiLCBjb2x1bW5Db3VudCArIDEgKTsKCgkJCQlpZiAoIHNwYW4gKSB7CgkJCQkJZm9yKCBqID0gMDsgaiA8IHNwYW4gLSAxOyBqKysgKSB7CgkJCQkJCWNvbHVtbkNvdW50Kys7CgkJCQkJCXNlbGVjdG9yICs9ICIsIDpudGgtY2hpbGQoIiArICggY29sdW1uQ291bnQgKyAxICkgKyAiKSI7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFN0b3JlICJjZWxscyIgZGF0YSBvbiBoZWFkZXIgYXMgYSByZWZlcmVuY2UgdG8gYWxsIGNlbGxzIGluIHRoZQoJCQkJLy8gc2FtZSBjb2x1bW4gYXMgdGhpcyBUSAoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIsIHRhYmxlLmZpbmQoICJ0ciIgKS5ub3QoIHRycy5lcSggMCApICkubm90KCB0aGlzICkuY2hpbGRyZW4oIHNlbGVjdG9yICkgKTsKCgkJCQljb2x1bW5Db3VudCsrOwoJCQl9KTsKCQl9KTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLnRhYmxlLCB7CglvcHRpb25zOiB7CgkJbW9kZTogImNvbHVtbnRvZ2dsZSIsCgkJY29sdW1uQnRuVGhlbWU6IG51bGwsCgkJY29sdW1uUG9wdXBUaGVtZTogbnVsbCwKCQljb2x1bW5CdG5UZXh0OiAiQ29sdW1ucy4uLiIsCgkJY2xhc3NlczogJC5leHRlbmQoICQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsIHsKCQkJcG9wdXA6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtcG9wdXAiLAoJCQljb2x1bW5CdG46ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtYnRuIiwKCQkJcHJpb3JpdHlQcmVmaXg6ICJ1aS10YWJsZS1wcmlvcml0eS0iLAoJCQljb2x1bW5Ub2dnbGVUYWJsZTogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZSIKCQl9KQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5tb2RlICE9PSAiY29sdW1udG9nZ2xlIiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX21lbnU6IG51bGwKCQl9KTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX21lbnUgPSAkKCB0aGlzLmRvY3VtZW50WyAwIF0uZ2V0RWxlbWVudEJ5SWQoIHRoaXMuX2lkKCkgKyAiLXBvcHVwIiApICkuY2hpbGRyZW4oKS5maXJzdCgpOwoJCQl0aGlzLl9hZGRUb2dnbGVzKCB0aGlzLl9tZW51LCB0cnVlICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5fbWVudSA9IHRoaXMuX2VuaGFuY2VDb2xUb2dnbGUoKTsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5jb2x1bW5Ub2dnbGVUYWJsZSApOwoJCX0KCgkJdGhpcy5fc2V0dXBFdmVudHMoKTsKCgkJdGhpcy5fc2V0VG9nZ2xlU3RhdGUoKTsKCX0sCgoJX2lkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApIHx8ICggdGhpcy53aWRnZXROYW1lICsgdGhpcy51dWlkICkgKTsKCX0sCgoJX3NldHVwRXZlbnRzOiBmdW5jdGlvbigpIHsKCQkvL05PVEU6IGlucHV0cyBhcmUgYm91bmQgaW4gYmluZFRvZ2dsZXMsCgkJLy8gc28gaXQgY2FuIGJlIGNhbGxlZCBvbiByZWZyZXNoLCB0b28KCgkJLy8gdXBkYXRlIGNvbHVtbiB0b2dnbGVzIG9uIHJlc2l6ZQoJCXRoaXMuX29uKCB0aGlzLndpbmRvdywgewoJCQl0aHJvdHRsZWRyZXNpemU6ICJfc2V0VG9nZ2xlU3RhdGUiCgkJfSk7CgkJdGhpcy5fb24oIHRoaXMuX21lbnUsIHsKCQkJImNoYW5nZSBpbnB1dCI6ICJfbWVudUlucHV0Q2hhbmdlIgoJCX0pOwoJfSwKCglfYWRkVG9nZ2xlczogZnVuY3Rpb24oIG1lbnUsIGtlZXAgKSB7CgkJdmFyIGlucHV0cywKCQkJY2hlY2tib3hJbmRleCA9IDAsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWNvbnRhaW5lciA9IG1lbnUuY29udHJvbGdyb3VwKCAiY29udGFpbmVyIiApOwoKCQkvLyBhbGxvdyB1cGRhdGUgb2YgbWVudSBvbiByZWZyZXNoIChmaXhlcyAjNTg4MCkKCQlpZiAoIGtlZXAgKSB7CgkJCWlucHV0cyA9IG1lbnUuZmluZCggImlucHV0IiApOwoJCX0gZWxzZSB7CgkJCWNvbnRhaW5lci5lbXB0eSgpOwoJCX0KCgkJLy8gY3JlYXRlIHRoZSBoaWRlL3Nob3cgdG9nZ2xlcwoJCXRoaXMuaGVhZGVycy5ub3QoICJ0ZCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGlucHV0LCBjZWxscywKCQkJCWhlYWRlciA9ICQoIHRoaXMgKSwKCQkJCXByaW9yaXR5ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAicHJpb3JpdHkiICk7CgoJCQlpZiAoIHByaW9yaXR5ICkgewoJCQkJY2VsbHMgPSBoZWFkZXIuYWRkKCBoZWFkZXIuanFtRGF0YSggImNlbGxzIiApICk7CgkJCQljZWxscy5hZGRDbGFzcyggb3B0cy5jbGFzc2VzLnByaW9yaXR5UHJlZml4ICsgcHJpb3JpdHkgKTsKCgkJCQkvLyBNYWtlIHN1cmUgdGhlIChuZXc/KSBjaGVja2JveCBpcyBhc3NvY2lhdGVkIHdpdGggaXRzIGhlYWRlciB2aWEgLmpxbURhdGEoKSBhbmQKCQkJCS8vIHRoYXQsIHZpY2UgdmVyc2EsIHRoZSBoZWFkZXIgaXMgYWxzbyBhc3NvY2lhdGVkIHdpdGggdGhlIGNoZWNrYm94CgkJCQlpbnB1dCA9ICgga2VlcCA/IGlucHV0cy5lcSggY2hlY2tib3hJbmRleCsrICkgOgoJCQkJCSQoIjxsYWJlbD48aW5wdXQgdHlwZT0nY2hlY2tib3gnIGNoZWNrZWQgLz4iICsKCQkJCQkJKCBoZWFkZXIuY2hpbGRyZW4oICJhYmJyIiApLmZpcnN0KCkuYXR0ciggInRpdGxlIiApIHx8CgkJCQkJCQloZWFkZXIudGV4dCgpICkgKwoJCQkJCQkiPC9sYWJlbD4iICkKCQkJCQkJLmFwcGVuZFRvKCBjb250YWluZXIgKQoJCQkJCQkuY2hpbGRyZW4oIDAgKQoJCQkJCQkuY2hlY2tib3hyYWRpbyggewoJCQkJCQkJdGhlbWU6IG9wdHMuY29sdW1uUG9wdXBUaGVtZQoJCQkJCQl9KSApCgoJCQkJCQkvLyBBc3NvY2lhdGUgdGhlIGhlYWRlciB3aXRoIHRoZSBjaGVja2JveAoJCQkJCQkuanFtRGF0YSggImhlYWRlciIsIGhlYWRlciApCgkJCQkJCS5qcW1EYXRhKCAiY2VsbHMiLCBjZWxscyApOwoKCQkJCS8vIEFzc29jaWF0ZSB0aGUgY2hlY2tib3ggd2l0aCB0aGUgaGVhZGVyCgkJCQloZWFkZXIuanFtRGF0YSggImlucHV0IiwgaW5wdXQgKTsKCQkJfQoJCX0pOwoKCQkvLyBzZXQgYmluZGluZ3MgaGVyZQoJCWlmICggIWtlZXAgKSB7CgkJCW1lbnUuY29udHJvbGdyb3VwKCAicmVmcmVzaCIgKTsKCQl9Cgl9LAoKCV9tZW51SW5wdXRDaGFuZ2U6IGZ1bmN0aW9uKCBldnQgKSB7CgkJdmFyIGlucHV0ID0gJCggZXZ0LnRhcmdldCApLAoJCQljaGVja2VkID0gaW5wdXRbIDAgXS5jaGVja2VkOwoKCQlpbnB1dC5qcW1EYXRhKCAiY2VsbHMiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFibGUtY2VsbC1oaWRkZW4iLCAhY2hlY2tlZCApCgkJCS50b2dnbGVDbGFzcyggInVpLXRhYmxlLWNlbGwtdmlzaWJsZSIsIGNoZWNrZWQgKTsKCX0sCgoJX3VubG9ja0NlbGxzOiBmdW5jdGlvbiggY2VsbHMgKSB7CgkJLy8gYWxsb3cgaGlkZS9zaG93IHZpYSBDU1Mgb25seSA9IHJlbW92ZSBhbGwgdG9nZ2xlLWxvY2tzCgkJY2VsbHMucmVtb3ZlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiB1aS10YWJsZS1jZWxsLXZpc2libGUiKTsKCX0sCgoJX2VuaGFuY2VDb2xUb2dnbGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpZCAsIG1lbnVCdXR0b24sIHBvcHVwLCBtZW51LAoJCQl0YWJsZSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJbnMgPSAkLm1vYmlsZS5ucywKCQkJZnJhZ21lbnQgPSB0aGlzLmRvY3VtZW50WyAwIF0uY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlpZCA9IHRoaXMuX2lkKCkgKyAiLXBvcHVwIjsKCQltZW51QnV0dG9uID0gJCggIjxhIGhyZWY9JyMiICsgaWQgKyAiJyAiICsKCQkJImNsYXNzPSciICsgb3B0cy5jbGFzc2VzLmNvbHVtbkJ0biArICIgdWktYnRuICIgKwoJCQkidWktYnRuLSIgKyAoIG9wdHMuY29sdW1uQnRuVGhlbWUgfHwgImEiICkgKwoJCQkiIHVpLWNvcm5lci1hbGwgdWktc2hhZG93IHVpLW1pbmknICIgKwoJCQkiZGF0YS0iICsgbnMgKyAicmVsPSdwb3B1cCc+IiArIG9wdHMuY29sdW1uQnRuVGV4dCArICI8L2E+IiApOwoJCXBvcHVwID0gJCggIjxkaXYgY2xhc3M9JyIgKyBvcHRzLmNsYXNzZXMucG9wdXAgKyAiJyBpZD0nIiArIGlkICsgIic+PC9kaXY+IiApOwoJCW1lbnUgPSAkKCAiPGZpZWxkc2V0PjwvZmllbGRzZXQ+IiApLmNvbnRyb2xncm91cCgpOwoKCQkvLyBzZXQgZXh0ZW5zaW9uIGhlcmUsIHNlbmQgImZhbHNlIiB0byB0cmlnZ2VyIGJ1aWxkL3JlYnVpbGQKCQl0aGlzLl9hZGRUb2dnbGVzKCBtZW51LCBmYWxzZSApOwoKCQltZW51LmFwcGVuZFRvKCBwb3B1cCApOwoKCQlmcmFnbWVudC5hcHBlbmRDaGlsZCggcG9wdXBbIDAgXSApOwoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBtZW51QnV0dG9uWyAwIF0gKTsKCQl0YWJsZS5iZWZvcmUoIGZyYWdtZW50ICk7CgoJCXBvcHVwLnBvcHVwKCk7CgoJCXJldHVybiBtZW51OwoJfSwKCglyZWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5tb2RlID09PSAiY29sdW1udG9nZ2xlIiApIHsKCQkJLy8gTk9URTogcmVidWlsZCBwYXNzZXMgImZhbHNlIiwgd2hpbGUgcmVmcmVzaCBwYXNzZXMgInVuZGVmaW5lZCIKCQkJLy8gYm90aCByZWZyZXNoIHRoZSB0YWJsZSwgYnV0IGluc2lkZSBhZGRUb2dnbGVzLCAhZmFsc2Ugd2lsbCBiZSB0cnVlLAoJCQkvLyBzbyBhIHJlYnVpbGQgY2FsbCBjYW4gYmUgaW5kZW50aWZpZWQKCQkJdGhpcy5fcmVmcmVzaCggZmFsc2UgKTsKCQl9Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBoZWFkZXJzLCBoaWRkZW5Db2x1bW5zLCBpbmRleDsKCgkJLy8gQ2FsbGluZyBfc3VwZXIoKSBoZXJlIHVwZGF0ZXMgdGhpcy5oZWFkZXJzCgkJdGhpcy5fc3VwZXIoIGNyZWF0ZSApOwoKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQloZWFkZXJzID0gdGhpcy5oZWFkZXJzOwoJCQloaWRkZW5Db2x1bW5zID0gW107CgoJCQkvLyBGaW5kIHRoZSBpbmRleCBvZiB0aGUgY29sdW1uIGhlYWRlciBhc3NvY2lhdGVkIHdpdGggZWFjaCBvbGQgY2hlY2tib3ggYW1vbmcgdGhlCgkJCS8vIHBvc3QtcmVmcmVzaCBoZWFkZXJzIGFuZCwgaWYgdGhlIGhlYWRlciBpcyBzdGlsbCB0aGVyZSwgbWFrZSBzdXJlIHRoZSBjb3JyZXNwb25kaW5nCgkJCS8vIGNvbHVtbiB3aWxsIGJlIGhpZGRlbiBpZiB0aGUgcHJlLXJlZnJlc2ggY2hlY2tib3ggaW5kaWNhdGVzIHRoYXQgdGhlIGNvbHVtbiBpcwoJCQkvLyBoaWRkZW4gYnkgcmVjb3JkaW5nIGl0cyBpbmRleCBpbiB0aGUgYXJyYXkgb2YgaGlkZGVuIGNvbHVtbnMuCgkJCXRoaXMuX21lbnUuZmluZCggImlucHV0IiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIGlucHV0ID0gJCggdGhpcyApLAoJCQkJCWhlYWRlciA9IGlucHV0LmpxbURhdGEoICJoZWFkZXIiICksCgkJCQkJaW5kZXggPSBoZWFkZXJzLmluZGV4KCBoZWFkZXJbIDAgXSApOwoKCQkJCWlmICggaW5kZXggPiAtMSAmJiAhaW5wdXQucHJvcCggImNoZWNrZWQiICkgKSB7CgoJCQkJCS8vIFRoZSBjb2x1bW4gaGVhZGVyIGFzc29jaWF0ZWQgd2l0aCAvdGhpcy8gY2hlY2tib3ggaXMgc3RpbGwgcHJlc2VudCBpbiB0aGUKCQkJCQkvLyBwb3N0LXJlZnJlc2ggdGFibGUgYW5kIHRoZSBjaGVja2JveCBpcyBub3QgY2hlY2tlZCwgc28gdGhlIGNvbHVtbiBhc3NvY2lhdGVkCgkJCQkJLy8gd2l0aCB0aGlzIGNvbHVtbiBoZWFkZXIgaXMgY3VycmVudGx5IGhpZGRlbi4gTGV0J3MgcmVjb3JkIHRoYXQuCgkJCQkJaGlkZGVuQ29sdW1ucy5wdXNoKCBpbmRleCApOwoJCQkJfQoJCQl9KTsKCgkJCS8vIGNvbHVtbnMgbm90IGJlaW5nIHJlcGxhY2VkIG11c3QgYmUgY2xlYXJlZCBmcm9tIGlucHV0IHRvZ2dsZS1sb2NrcwoJCQl0aGlzLl91bmxvY2tDZWxscyggdGhpcy5lbGVtZW50LmZpbmQoICIudWktdGFibGUtY2VsbC1oaWRkZW4sICIgKwoJCQkJIi51aS10YWJsZS1jZWxsLXZpc2libGUiICkgKTsKCgkJCS8vIHVwZGF0ZSBjb2x1bW50b2dnbGVzIGFuZCBjZWxscwoJCQl0aGlzLl9hZGRUb2dnbGVzKCB0aGlzLl9tZW51LCBjcmVhdGUgKTsKCgkJCS8vIEF0IHRoaXMgcG9pbnQgYWxsIGNvbHVtbnMgYXJlIHZpc2libGUsIHNvIHVuY2hlY2sgdGhlIGNoZWNrYm94ZXMgdGhhdCBjb3JyZXNwb25kIHRvCgkJCS8vIHRob3NlIGNvbHVtbnMgd2UndmUgZm91bmQgdG8gYmUgaGlkZGVuCgkJCWZvciAoIGluZGV4ID0gaGlkZGVuQ29sdW1ucy5sZW5ndGggLSAxIDsgaW5kZXggPiAtMSA7IGluZGV4LS0gKSB7CgkJCQloZWFkZXJzLmVxKCBoaWRkZW5Db2x1bW5zWyBpbmRleCBdICkuanFtRGF0YSggImlucHV0IiApCgkJCQkJLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKQoJCQkJCS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKQoJCQkJCS50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCglfc2V0VG9nZ2xlU3RhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX21lbnUuZmluZCggImlucHV0IiApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgY2hlY2tib3ggPSAkKCB0aGlzICk7CgoJCQl0aGlzLmNoZWNrZWQgPSBjaGVja2JveC5qcW1EYXRhKCAiY2VsbHMiICkuZXEoIDAgKS5jc3MoICJkaXNwbGF5IiApID09PSAidGFibGUtY2VsbCI7CgkJCWNoZWNrYm94LmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJCX0pOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgJC5tb2JpbGUudGFibGUsIHsKCW9wdGlvbnM6IHsKCQltb2RlOiAicmVmbG93IiwKCQljbGFzc2VzOiAkLmV4dGVuZCggJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY2xhc3NlcywgewoJCQlyZWZsb3dUYWJsZTogInVpLXRhYmxlLXJlZmxvdyIsCgkJCWNlbGxMYWJlbHM6ICJ1aS10YWJsZS1jZWxsLWxhYmVsIgoJCX0pCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCS8vIElmIGl0J3Mgbm90IHJlZmxvdyBtb2RlLCByZXR1cm4gaGVyZS4KCQlpZiAoIHRoaXMub3B0aW9ucy5tb2RlICE9PSAicmVmbG93IiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnJlZmxvd1RhYmxlICk7CgoJCQl0aGlzLl91cGRhdGVSZWZsb3coKTsKCQl9Cgl9LAoKCXJlYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgPT09ICJyZWZsb3ciICkgewoJCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJCX0KCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5fc3VwZXIoIGNyZWF0ZSApOwoJCWlmICggIWNyZWF0ZSAmJiB0aGlzLm9wdGlvbnMubW9kZSA9PT0gInJlZmxvdyIgKSB7CgkJCXRoaXMuX3VwZGF0ZVJlZmxvdyggKTsKCQl9Cgl9LAoKCV91cGRhdGVSZWZsb3c6IGZ1bmN0aW9uKCkgewoJCXZhciB0YWJsZSA9IHRoaXMsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIGdldCBoZWFkZXJzIGluIHJldmVyc2Ugb3JkZXIgc28gdGhhdCB0b3AtbGV2ZWwgaGVhZGVycyBhcmUgYXBwZW5kZWQgbGFzdAoJCSQoIHRhYmxlLmFsbEhlYWRlcnMuZ2V0KCkucmV2ZXJzZSgpICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciBjZWxscyA9ICQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICksCgkJCQljb2xzdGFydCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgImNvbHN0YXJ0IiApLAoJCQkJaGllcmFyY2h5Q2xhc3MgPSBjZWxscy5ub3QoIHRoaXMgKS5maWx0ZXIoICJ0aGVhZCB0aCIgKS5sZW5ndGggJiYgIiB1aS10YWJsZS1jZWxsLWxhYmVsLXRvcCIsCgkJCQljb250ZW50cyA9ICQoIHRoaXMgKS5jbG9uZSgpLmNvbnRlbnRzKCksCgkJCQlpdGVyYXRpb24sIGZpbHRlcjsKCgkJCQlpZiAoIGNvbnRlbnRzLmxlbmd0aCA+IDAgICkgewoKCQkJCQlpZiAoIGhpZXJhcmNoeUNsYXNzICkgewoJCQkJCQlpdGVyYXRpb24gPSBwYXJzZUludCggdGhpcy5nZXRBdHRyaWJ1dGUoICJjb2xzcGFuIiApLCAxMCApOwoJCQkJCQlmaWx0ZXIgPSAiIjsKCgkJCQkJCWlmICggaXRlcmF0aW9uICkgewoJCQkJCQkJZmlsdGVyID0gInRkOm50aC1jaGlsZCgiKyBpdGVyYXRpb24gKyJuICsgIiArICggY29sc3RhcnQgKSArIikiOwoJCQkJCQl9CgoJCQkJCQl0YWJsZS5fYWRkTGFiZWxzKCBjZWxscy5maWx0ZXIoIGZpbHRlciApLAoJCQkJCQkJb3B0cy5jbGFzc2VzLmNlbGxMYWJlbHMgKyBoaWVyYXJjaHlDbGFzcywgY29udGVudHMgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0YWJsZS5fYWRkTGFiZWxzKCBjZWxscywgb3B0cy5jbGFzc2VzLmNlbGxMYWJlbHMsIGNvbnRlbnRzICk7CgkJCQkJfQoKCQkJCX0KCQl9KTsKCX0sCgoJX2FkZExhYmVsczogZnVuY3Rpb24oIGNlbGxzLCBsYWJlbCwgY29udGVudHMgKSB7CgkJaWYgKCBjb250ZW50cy5sZW5ndGggPT09IDEgJiYgY29udGVudHNbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiYWJiciIgKSB7CgkJCWNvbnRlbnRzID0gY29udGVudHMuZXEoIDAgKS5hdHRyKCAidGl0bGUiICk7CgkJfQoJCS8vIC5ub3QgZml4ZXMgIzYwMDYKCQljZWxscwoJCQkubm90KCAiOmhhcyhiLiIgKyBsYWJlbCArICIpIiApCgkJCQkucHJlcGVuZCggJCggIjxiIGNsYXNzPSciICsgbGFiZWwgKyAiJz48L2I+IiApLmFwcGVuZCggY29udGVudHMgKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gVE9ETyByZW5hbWUgZmlsdGVyQ2FsbGJhY2svZGVwcmVjYXRlIGFuZCBkZWZhdWx0IHRvIHRoZSBpdGVtIGl0c2VsZiBhcyB0aGUgZmlyc3QgYXJndW1lbnQKdmFyIGRlZmF1bHRGaWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCBpbmRleCwgc2VhcmNoVmFsdWUgKSB7CglyZXR1cm4gKCAoICIiICsgKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJmaWx0ZXJ0ZXh0IiApIHx8ICQoIHRoaXMgKS50ZXh0KCkgKSApCgkJLnRvTG93ZXJDYXNlKCkuaW5kZXhPZiggc2VhcmNoVmFsdWUgKSA9PT0gLTEgKTsKfTsKCiQud2lkZ2V0KCAibW9iaWxlLmZpbHRlcmFibGUiLCB7CgoJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEoZmlsdGVyPSd0cnVlJykiLAoKCW9wdGlvbnM6IHsKCQlmaWx0ZXJSZXZlYWw6IGZhbHNlLAoJCWZpbHRlckNhbGxiYWNrOiBkZWZhdWx0RmlsdGVyQ2FsbGJhY2ssCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCWlucHV0OiBudWxsLAoJCWNoaWxkcmVuOiAiPiBsaSwgPiBvcHRpb24sID4gb3B0Z3JvdXAgb3B0aW9uLCA+IHRib2R5IHRyLCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktYnRuLCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktY2hlY2tib3gsID4gLnVpLWNvbnRyb2xncm91cC1jb250cm9scyA+IC51aS1yYWRpbyIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9zZWFyY2g6IG51bGwsCgkJCV90aW1lcjogMAoJCX0pOwoKCQl0aGlzLl9zZXRJbnB1dCggb3B0cy5pbnB1dCApOwoJCWlmICggIW9wdHMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2ZpbHRlckl0ZW1zKCAoICggdGhpcy5fc2VhcmNoICYmIHRoaXMuX3NlYXJjaC52YWwoKSApIHx8ICIiICkudG9Mb3dlckNhc2UoKSApOwoJCX0KCX0sCgoJX29uS2V5VXA6IGZ1bmN0aW9uKCkgewoJCXZhciB2YWwsIGxhc3R2YWwsCgkJCXNlYXJjaCA9IHRoaXMuX3NlYXJjaDsKCgkJaWYgKCBzZWFyY2ggKSB7CgkJCXZhbCA9IHNlYXJjaC52YWwoKS50b0xvd2VyQ2FzZSgpLAoJCQlsYXN0dmFsID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBzZWFyY2hbIDAgXSwgImxhc3R2YWwiICkgKyAiIjsKCgkJCWlmICggbGFzdHZhbCAmJiBsYXN0dmFsID09PSB2YWwgKSB7CgkJCQkvLyBFeGVjdXRlIHRoZSBoYW5kbGVyIG9ubHkgb25jZSBwZXIgdmFsdWUgY2hhbmdlCgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aGlzLl90aW1lciApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9CgoJCQl0aGlzLl90aW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZWZpbHRlciIsIG51bGwsIHsgaW5wdXQ6IHNlYXJjaCB9ICkgPT09IGZhbHNlICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCQlzZWFyY2hbIDAgXS5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJsYXN0dmFsIiwgdmFsICk7CgoJCQkJdGhpcy5fZmlsdGVySXRlbXMoIHZhbCApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9LCAyNTAgKTsKCQl9Cgl9LAoKCV9nZXRGaWx0ZXJhYmxlSXRlbXM6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQljaGlsZHJlbiA9IHRoaXMub3B0aW9ucy5jaGlsZHJlbiwKCQkJaXRlbXMgPSAhY2hpbGRyZW4gPyB7IGxlbmd0aDogMCB9OgoJCQkJJC5pc0Z1bmN0aW9uKCBjaGlsZHJlbiApID8gY2hpbGRyZW4oKToKCQkJCWNoaWxkcmVuLm5vZGVOYW1lID8gJCggY2hpbGRyZW4gKToKCQkJCWNoaWxkcmVuLmpxdWVyeSA/IGNoaWxkcmVuOgoJCQkJdGhpcy5lbGVtZW50LmZpbmQoIGNoaWxkcmVuICk7CgoJCWlmICggaXRlbXMubGVuZ3RoID09PSAwICkgewoJCQlpdGVtcyA9IGVsZW0uY2hpbGRyZW4oKTsKCQl9CgoJCXJldHVybiBpdGVtczsKCX0sCgoJX2ZpbHRlckl0ZW1zOiBmdW5jdGlvbiggdmFsICkgewoJCXZhciBpZHgsIGNhbGxiYWNrLCBsZW5ndGgsIGRzdCwKCQkJc2hvdyA9IFtdLAoJCQloaWRlID0gW10sCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWZpbHRlckl0ZW1zID0gdGhpcy5fZ2V0RmlsdGVyYWJsZUl0ZW1zKCk7CgoJCWlmICggdmFsICE9IG51bGwgKSB7CgkJCWNhbGxiYWNrID0gb3B0cy5maWx0ZXJDYWxsYmFjayB8fCBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgkJCWxlbmd0aCA9IGZpbHRlckl0ZW1zLmxlbmd0aDsKCgkJCS8vIFBhcnRpdGlvbiB0aGUgaXRlbXMgaW50byB0aG9zZSB0byBiZSBoaWRkZW4gYW5kIHRob3NlIHRvIGJlIHNob3duCgkJCWZvciAoIGlkeCA9IDAgOyBpZHggPCBsZW5ndGggOyBpZHgrKyApIHsKCQkJCWRzdCA9ICggY2FsbGJhY2suY2FsbCggZmlsdGVySXRlbXNbIGlkeCBdLCBpZHgsIHZhbCApICkgPyBoaWRlIDogc2hvdzsKCQkJCWRzdC5wdXNoKCBmaWx0ZXJJdGVtc1sgaWR4IF0gKTsKCQkJfQoJCX0KCgkJLy8gSWYgbm90aGluZyBpcyBoaWRkZW4sIHRoZW4gdGhlIGRlY2lzaW9uIHdoZXRoZXIgdG8gaGlkZSBvciBzaG93IHRoZSBpdGVtcwoJCS8vIGlzIGJhc2VkIG9uIHRoZSAiZmlsdGVyUmV2ZWFsIiBvcHRpb24uCgkJaWYgKCBoaWRlLmxlbmd0aCA9PT0gMCApIHsKCQkJZmlsdGVySXRlbXNbICggb3B0cy5maWx0ZXJSZXZlYWwgJiYgdmFsLmxlbmd0aCA9PT0gMCApID8KCQkJCSJhZGRDbGFzcyIgOiAicmVtb3ZlQ2xhc3MiIF0oICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCSQoIGhpZGUgKS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCSQoIHNob3cgKS5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoQ2hpbGRXaWRnZXQoKTsKCgkJdGhpcy5fdHJpZ2dlciggImZpbHRlciIsIG51bGwsIHsKCQkJaXRlbXM6IGZpbHRlckl0ZW1zCgkJfSk7Cgl9LAoKCS8vIFRoZSBEZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIF9yZWZyZXNoQ2hpbGRXaWRnZXQgYXR0ZW1wdHMgdG8gY2FsbAoJLy8gcmVmcmVzaCBvbiBjb2xsYXBzaWJsZXNldCwgY29udHJvbGdyb3VwLCBzZWxlY3RtZW51LCBvciBsaXN0dmlldwoJX3JlZnJlc2hDaGlsZFdpZGdldDogZnVuY3Rpb24oKSB7CgkJdmFyIHdpZGdldCwgaWR4LAoJCQlyZWNvZ25pemVkV2lkZ2V0cyA9IFsgImNvbGxhcHNpYmxlc2V0IiwgInNlbGVjdG1lbnUiLCAiY29udHJvbGdyb3VwIiwgImxpc3R2aWV3IiBdOwoKCQlmb3IgKCBpZHggPSByZWNvZ25pemVkV2lkZ2V0cy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJd2lkZ2V0ID0gcmVjb2duaXplZFdpZGdldHNbIGlkeCBdOwoJCQlpZiAoICQubW9iaWxlWyB3aWRnZXQgXSApIHsKCQkJCXdpZGdldCA9IHRoaXMuZWxlbWVudC5kYXRhKCAibW9iaWxlLSIgKyB3aWRnZXQgKTsKCQkJCWlmICggd2lkZ2V0ICYmICQuaXNGdW5jdGlvbiggd2lkZ2V0LnJlZnJlc2ggKSApIHsKCQkJCQl3aWRnZXQucmVmcmVzaCgpOwoJCQkJfQoJCQl9CgkJfQoJfSwKCgkvLyBUT0RPOiBXaGVuIHRoZSBpbnB1dCBpcyBub3QgaW50ZXJuYWwsIGRvIG5vdCBldmVuIHN0b3JlIGl0IGluIHRoaXMuX3NlYXJjaAoJX3NldElucHV0OiBmdW5jdGlvbiAoIHNlbGVjdG9yICkgewoJCXZhciBzZWFyY2ggPSB0aGlzLl9zZWFyY2g7CgoJCS8vIFN0b3AgYSBwZW5kaW5nIGZpbHRlciBvcGVyYXRpb24KCQlpZiAoIHRoaXMuX3RpbWVyICkgewoJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aGlzLl90aW1lciApOwoJCQl0aGlzLl90aW1lciA9IDA7CgkJfQoKCQlpZiAoIHNlYXJjaCApIHsKCQkJdGhpcy5fb2ZmKCBzZWFyY2gsICJrZXl1cCBjaGFuZ2UgaW5wdXQiICk7CgkJCXNlYXJjaCA9IG51bGw7CgkJfQoKCQlpZiAoIHNlbGVjdG9yICkgewoJCQlzZWFyY2ggPSBzZWxlY3Rvci5qcXVlcnkgPyBzZWxlY3RvcjoKCQkJCXNlbGVjdG9yLm5vZGVOYW1lID8gJCggc2VsZWN0b3IgKToKCQkJCXRoaXMuZG9jdW1lbnQuZmluZCggc2VsZWN0b3IgKTsKCgkJCXRoaXMuX29uKCBzZWFyY2gsIHsKCQkJCWtleWRvd246ICJfb25LZXlEb3duIiwKCQkJCWtleXByZXNzOiAiX29uS2V5UHJlc3MiLAoJCQkJa2V5dXA6ICJfb25LZXlVcCIsCgkJCQljaGFuZ2U6ICJfb25LZXlVcCIsCgkJCQlpbnB1dDogIl9vbktleVVwIgoJCQl9KTsKCQl9CgoJCXRoaXMuX3NlYXJjaCA9IHNlYXJjaDsKCX0sCgoJLy8gUHJldmVudCBmb3JtIHN1Ym1pc3Npb24KCV9vbktleURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5FTlRFUiApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJdGhpcy5fcHJldmVudEtleVByZXNzID0gdHJ1ZTsKCQl9Cgl9LAoKCV9vbktleVByZXNzOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9wcmV2ZW50S2V5UHJlc3MgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXRoaXMuX3ByZXZlbnRLZXlQcmVzcyA9IGZhbHNlOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZWZpbHRlciA9ICEoICggb3B0aW9ucy5maWx0ZXJSZXZlYWwgPT09IHVuZGVmaW5lZCApICYmCgkJCQkoIG9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPT09IHVuZGVmaW5lZCApICYmCgkJCQkoIG9wdGlvbnMuY2hpbGRyZW4gPT09IHVuZGVmaW5lZCApICk7CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggb3B0aW9ucy5pbnB1dCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRJbnB1dCggb3B0aW9ucy5pbnB1dCApOwoJCQlyZWZpbHRlciA9IHRydWU7CgkJfQoKCQlpZiAoIHJlZmlsdGVyICkgewoJCQl0aGlzLnJlZnJlc2goKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJaXRlbXMgPSB0aGlzLl9nZXRGaWx0ZXJhYmxlSXRlbXMoKTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlpdGVtcy50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBvcHRzLmZpbHRlclJldmVhbCApOwoJCX0gZWxzZSB7CgkJCWl0ZW1zLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCXdpbmRvdy5jbGVhclRpbWVvdXQoIHRoaXMuX3RpbWVyICk7CgkJCXRoaXMuX3RpbWVyID0gMDsKCQl9CgkJdGhpcy5fZmlsdGVySXRlbXMoICggKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLnZhbCgpICkgfHwgIiIgKS50b0xvd2VyQ2FzZSgpICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyBDcmVhdGUgYSBmdW5jdGlvbiB0aGF0IHdpbGwgcmVwbGFjZSB0aGUgX3NldE9wdGlvbnMgZnVuY3Rpb24gb2YgYSB3aWRnZXQsCi8vIGFuZCB3aWxsIHBhc3MgdGhlIG9wdGlvbnMgb24gdG8gdGhlIGlucHV0IG9mIHRoZSBmaWx0ZXJhYmxlLgp2YXIgcmVwbGFjZVNldE9wdGlvbnMgPSBmdW5jdGlvbiggc2VsZiwgb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCW9yaWcuY2FsbCggdGhpcywgb3B0aW9ucyApOwoJCQlzZWxmLl9zeW5jVGV4dElucHV0T3B0aW9ucyggb3B0aW9ucyApOwoJCX07Cgl9LAoJckRpdmlkZXJMaXN0SXRlbSA9IC8oXnxccyl1aS1saS1kaXZpZGVyKFxzfCQpLywKCW9yaWdEZWZhdWx0RmlsdGVyQ2FsbGJhY2sgPSAkLm1vYmlsZS5maWx0ZXJhYmxlLnByb3RvdHlwZS5vcHRpb25zLmZpbHRlckNhbGxiYWNrOwoKLy8gT3ZlcnJpZGUgdGhlIGRlZmF1bHQgZmlsdGVyIGNhbGxiYWNrIHdpdGggb25lIHRoYXQgZG9lcyBub3QgaGlkZSBsaXN0IGRpdmlkZXJzCiQubW9iaWxlLmZpbHRlcmFibGUucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPSBmdW5jdGlvbiggaW5kZXgsIHNlYXJjaFZhbHVlICkgewoJcmV0dXJuICF0aGlzLmNsYXNzTmFtZS5tYXRjaCggckRpdmlkZXJMaXN0SXRlbSApICYmCgkJb3JpZ0RlZmF1bHRGaWx0ZXJDYWxsYmFjay5jYWxsKCB0aGlzLCBpbmRleCwgc2VhcmNoVmFsdWUgKTsKfTsKCiQud2lkZ2V0KCAibW9iaWxlLmZpbHRlcmFibGUiLCAkLm1vYmlsZS5maWx0ZXJhYmxlLCB7CglvcHRpb25zOiB7CgkJZmlsdGVyUGxhY2Vob2xkZXI6ICJGaWx0ZXIgaXRlbXMuLi4iLAoJCWZpbHRlclRoZW1lOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpZHgsIHdpZGdldE5hbWUsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCXJlY29nbml6ZWRXaWRnZXRzID0gWyAiY29sbGFwc2libGVzZXQiLCAic2VsZWN0bWVudSIsICJjb250cm9sZ3JvdXAiLCAibGlzdHZpZXciIF0sCgkJCWNyZWF0ZUhhbmRsZXJzID0ge307CgoJCXRoaXMuX3N1cGVyKCk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV93aWRnZXQ6IG51bGwKCQl9KTsKCgkJZm9yICggaWR4ID0gcmVjb2duaXplZFdpZGdldHMubGVuZ3RoIC0gMSA7IGlkeCA+IC0xIDsgaWR4LS0gKSB7CgkJCXdpZGdldE5hbWUgPSByZWNvZ25pemVkV2lkZ2V0c1sgaWR4IF07CgkJCWlmICggJC5tb2JpbGVbIHdpZGdldE5hbWUgXSApIHsKCQkJCWlmICggdGhpcy5fc2V0V2lkZ2V0KCBlbGVtLmRhdGEoICJtb2JpbGUtIiArIHdpZGdldE5hbWUgKSApICkgewoJCQkJCWJyZWFrOwoJCQkJfSBlbHNlIHsKCQkJCQljcmVhdGVIYW5kbGVyc1sgd2lkZ2V0TmFtZSArICJjcmVhdGUiIF0gPSAiX2hhbmRsZUNyZWF0ZSI7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICggIXRoaXMuX3dpZGdldCApIHsKCQkJdGhpcy5fb24oIGVsZW0sIGNyZWF0ZUhhbmRsZXJzICk7CgkJfQoJfSwKCglfaGFuZGxlQ3JlYXRlOiBmdW5jdGlvbiggZXZ0ICkgewoJCXRoaXMuX3NldFdpZGdldCggdGhpcy5lbGVtZW50LmRhdGEoICJtb2JpbGUtIiArIGV2dC50eXBlLnN1YnN0cmluZyggMCwgZXZ0LnR5cGUubGVuZ3RoIC0gNiApICkgKTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQlpZiAoIHRoaXMuX3dpZGdldCAmJiB0aGlzLl93aWRnZXQud2lkZ2V0RnVsbE5hbWUgPT09ICJtb2JpbGUtbGlzdHZpZXciICYmCgkJCXR5cGUgPT09ICJiZWZvcmVmaWx0ZXIiICkgewoKCQkJLy8gQWxzbyB0cmlnZ2VyIGxpc3R2aWV3YmVmb3JlZmlsdGVyIGlmIHRoaXMgd2lkZ2V0IGlzIGFsc28gYSBsaXN0dmlldwoJCQl0aGlzLl93aWRnZXQuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCBldmVudCwgZGF0YSApOwoJCX0KCgkJLy8gUGFzc2luZyBiYWNrIHRoZSByZXNwb25zZSBlbmFibGVzIGNhbGxpbmcgcHJldmVudERlZmF1bHQoKQoJCXJldHVybiB0aGlzLl9zdXBlciggdHlwZSwgZXZlbnQsIGRhdGEgKTsKCX0sCgoJX3NldFdpZGdldDogZnVuY3Rpb24oIHdpZGdldCApIHsKCQlpZiAoICF0aGlzLl93aWRnZXQgJiYgd2lkZ2V0ICkgewoJCQl0aGlzLl93aWRnZXQgPSB3aWRnZXQ7CgkJCXRoaXMuX3dpZGdldC5fc2V0T3B0aW9ucyA9IHJlcGxhY2VTZXRPcHRpb25zKCB0aGlzLCB0aGlzLl93aWRnZXQuX3NldE9wdGlvbnMgKTsKCQl9CgoJCWlmICggISF0aGlzLl93aWRnZXQgKSB7CgkJCXRoaXMuX3N5bmNUZXh0SW5wdXRPcHRpb25zKCB0aGlzLl93aWRnZXQub3B0aW9ucyApOwoJCQlpZiAoIHRoaXMuX3dpZGdldC53aWRnZXROYW1lID09PSAibGlzdHZpZXciICkgewoJCQkJdGhpcy5fd2lkZ2V0Lm9wdGlvbnMuaGlkZURpdmlkZXJzID0gdHJ1ZTsKCQkJCXRoaXMuX3dpZGdldC5lbGVtZW50Lmxpc3R2aWV3KCAicmVmcmVzaCIgKTsKCQkJfQoJCX0KCgkJcmV0dXJuICEhdGhpcy5fd2lkZ2V0OwoJfSwKCglfaXNTZWFyY2hJbnRlcm5hbDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggdGhpcy5fc2VhcmNoICYmIHRoaXMuX3NlYXJjaC5qcW1EYXRhKCAidWktZmlsdGVyYWJsZS0iICsgdGhpcy51dWlkICsgIi1pbnRlcm5hbCIgKSApOwoJfSwKCglfc2V0SW5wdXQ6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJdXBkYXRlUGxhY2Vob2xkZXIgPSB0cnVlLAoJCQl0ZXh0aW5wdXRPcHRzID0ge307CgoJCWlmICggIXNlbGVjdG9yICkgewoJCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSApIHsKCgkJCQkvLyBJZ25vcmUgdGhlIGNhbGwgdG8gc2V0IGEgbmV3IGlucHV0IGlmIHRoZSBzZWxlY3RvciBnb2VzIHRvIGZhbHN5IGFuZAoJCQkJLy8gdGhlIGN1cnJlbnQgdGV4dGlucHV0IGlzIGFscmVhZHkgb2YgdGhlIGludGVybmFsbHkgZ2VuZXJhdGVkIHZhcmlldHkuCgkJCQlyZXR1cm47CgkJCX0gZWxzZSB7CgoJCQkJLy8gR2VuZXJhdGluZyBhIG5ldyB0ZXh0aW5wdXQgd2lkZ2V0LiBObyBuZWVkIHRvIHNldCB0aGUgcGxhY2Vob2xkZXIKCQkJCS8vIGZ1cnRoZXIgZG93biB0aGUgZnVuY3Rpb24uCgkJCQl1cGRhdGVQbGFjZWhvbGRlciA9IGZhbHNlOwoJCQkJc2VsZWN0b3IgPSAkKCAiPGlucHV0ICIgKwoJCQkJCSJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlPSdzZWFyY2gnICIgKwoJCQkJCSJwbGFjZWhvbGRlcj0nIiArIG9wdHMuZmlsdGVyUGxhY2Vob2xkZXIgKyAiJz48L2lucHV0PiIgKQoJCQkJCS5qcW1EYXRhKCAidWktZmlsdGVyYWJsZS0iICsgdGhpcy51dWlkICsgIi1pbnRlcm5hbCIsIHRydWUgKTsKCQkJCSQoICI8Zm9ybSBjbGFzcz0ndWktZmlsdGVyYWJsZSc+PC9mb3JtPiIgKQoJCQkJCS5hcHBlbmQoIHNlbGVjdG9yICkKCQkJCQkuc3VibWl0KCBmdW5jdGlvbiggZXZ0ICkgewoJCQkJCQlldnQucHJldmVudERlZmF1bHQoKTsKCQkJCQkJc2VsZWN0b3IuYmx1cigpOwoJCQkJCX0pCgkJCQkJLmluc2VydEJlZm9yZSggdGhpcy5lbGVtZW50ICk7CgkJCQlpZiAoICQubW9iaWxlLnRleHRpbnB1dCApIHsKCQkJCQlpZiAoIHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZSAhPSBudWxsICkgewoJCQkJCQl0ZXh0aW5wdXRPcHRzWyAidGhlbWUiIF0gPSBvcHRzLmZpbHRlclRoZW1lOwoJCQkJCX0KCgkJCQkJc2VsZWN0b3IudGV4dGlucHV0KCB0ZXh0aW5wdXRPcHRzICk7CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuX3N1cGVyKCBzZWxlY3RvciApOwoKCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSAmJiB1cGRhdGVQbGFjZWhvbGRlciApIHsKCQkJdGhpcy5fc2VhcmNoLmF0dHIoICJwbGFjZWhvbGRlciIsIHRoaXMub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciApOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZXQgPSB0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQkvLyBOZWVkIHRvIHNldCB0aGUgZmlsdGVyUGxhY2Vob2xkZXIgYWZ0ZXIgaGF2aW5nIGVzdGFibGlzaGVkIHRoZSBzZWFyY2ggaW5wdXQKCQlpZiAoIG9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgKSB7CgkJCQl0aGlzLl9zZWFyY2guYXR0ciggInBsYWNlaG9sZGVyIiwgb3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciApOwoJCQl9CgkJfQoKCQlpZiAoIG9wdGlvbnMuZmlsdGVyVGhlbWUgIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9zZWFyY2ggJiYgJC5tb2JpbGUudGV4dGlucHV0ICkgewoJCQl0aGlzLl9zZWFyY2gudGV4dGlucHV0KCAib3B0aW9uIiwgInRoZW1lIiwgb3B0aW9ucy5maWx0ZXJUaGVtZSApOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICkgewoJCQl0aGlzLl9zZWFyY2gucmVtb3ZlKCk7CgkJfQoJCXRoaXMuX3N1cGVyKCk7Cgl9LAoKCV9zeW5jVGV4dElucHV0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlkeCwKCQkJdGV4dGlucHV0T3B0aW9ucyA9IHt9OwoKCQkvLyBXZSBvbmx5IHN5bmMgb3B0aW9ucyBpZiB0aGUgZmlsdGVyYWJsZSdzIHRleHRpbnB1dCBpcyBvZiB0aGUgaW50ZXJuYWxseQoJCS8vIGdlbmVyYXRlZCB2YXJpZXR5LCByYXRoZXIgdGhhbiBvbmUgc3BlY2lmaWVkIGJ5IHRoZSB1c2VyLgoJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICYmICQubW9iaWxlLnRleHRpbnB1dCApIHsKCgkJCS8vIEFwcGx5IG9ubHkgdGhlIG9wdGlvbnMgdW5kZXJzdG9vZCBieSB0ZXh0aW5wdXQKCQkJZm9yICggaWR4IGluICQubW9iaWxlLnRleHRpbnB1dC5wcm90b3R5cGUub3B0aW9ucyApIHsKCQkJCWlmICggb3B0aW9uc1sgaWR4IF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCQlpZiAoIGlkeCA9PT0gInRoZW1lIiAmJiB0aGlzLm9wdGlvbnMuZmlsdGVyVGhlbWUgIT0gbnVsbCApIHsKCQkJCQkJdGV4dGlucHV0T3B0aW9uc1sgaWR4IF0gPSB0aGlzLm9wdGlvbnMuZmlsdGVyVGhlbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGV4dGlucHV0T3B0aW9uc1sgaWR4IF0gPSBvcHRpb25zWyBpZHggXTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJdGhpcy5fc2VhcmNoLnRleHRpbnB1dCggIm9wdGlvbiIsIHRleHRpbnB1dE9wdGlvbnMgKTsKCQl9Cgl9Cn0pOwoKLy8gSW5zdGFudGlhdGUgYSBmaWx0ZXJhYmxlIG9uIGEgbGlzdHZpZXcgdGhhdCBoYXMgdGhlIGRhdGEtZmlsdGVyPSJ0cnVlIiBhdHRyaWJ1dGUKLy8gVGhpcyBpcyBub3QgbmVjZXNzYXJ5IGZvciBzdGF0aWMgY29udGVudCwgYmVjYXVzZSB0aGUgYXV0by1lbmhhbmNlIHRha2VzIGNhcmUgb2YgaW5zdGFudGlhdGluZwovLyB0aGUgZmlsdGVyYWJsZSB1cG9uIGVuY291bnRlcmluZyBkYXRhLWZpbHRlcj0idHJ1ZSIuIEhvd2V2ZXIsIGJlY2F1c2Ugb2YgMS4zLnggaXQgaXMgZXhwZWN0ZWQKLy8gdGhhdCBhIGxpc3R2aWV3IHdpdGggZGF0YS1maWx0ZXI9InRydWUiIHdpbGwgYmUgZmlsdGVyYWJsZSBldmVuIGlmIHlvdSBqdXN0IGluc3RhbnRpYXRlIGEKLy8gbGlzdHZpZXcgb24gaXQuIFRoZSBleHRlbnNpb24gYmVsb3cgZW5zdXJlcyB0aGF0IHRoaXMgY29udGludWVzIHRvIGhhcHBlbiBpbiAxLjQueC4KJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS5saXN0dmlldywgewoJb3B0aW9uczogewoJCWZpbHRlcjogZmFsc2UKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5maWx0ZXIgPT09IHRydWUgJiYKCQkJCSF0aGlzLmVsZW1lbnQuZGF0YSggIm1vYmlsZS1maWx0ZXJhYmxlIiApICkgewoJCQl0aGlzLmVsZW1lbnQuZmlsdGVyYWJsZSgpOwoJCX0KCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgovKiEKICogalF1ZXJ5IFVJIFRhYnMgYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MAogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3RhYnMvCiAqCiAqIERlcGVuZHM6CiAqCWpxdWVyeS51aS5jb3JlLmpzCiAqCWpxdWVyeS51aS53aWRnZXQuanMKICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHRhYklkID0gMCwKCXJoYXNoID0gLyMuKiQvOwoKZnVuY3Rpb24gZ2V0TmV4dFRhYklkKCkgewoJcmV0dXJuICsrdGFiSWQ7Cn0KCmZ1bmN0aW9uIGlzTG9jYWwoIGFuY2hvciApIHsKCS8vIHN1cHBvcnQ6IElFNwoJLy8gSUU3IGRvZXNuJ3Qgbm9ybWFsaXplIHRoZSBocmVmIHByb3BlcnR5IHdoZW4gc2V0IHZpYSBzY3JpcHQgKCM5MzE3KQoJYW5jaG9yID0gYW5jaG9yLmNsb25lTm9kZSggZmFsc2UgKTsKCglyZXR1cm4gYW5jaG9yLmhhc2gubGVuZ3RoID4gMSAmJgoJCWRlY29kZVVSSUNvbXBvbmVudCggYW5jaG9yLmhyZWYucmVwbGFjZSggcmhhc2gsICIiICkgKSA9PT0KCQkJZGVjb2RlVVJJQ29tcG9uZW50KCBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoIHJoYXNoLCAiIiApICk7Cn0KCiQud2lkZ2V0KCAidWkudGFicyIsIHsKCXZlcnNpb246ICJjMGFiNzEwNTZiOTM2NjI3ZThhNzgyMWYwM2MwNDRhZWM2MjgwYTQwIiwKCWRlbGF5OiAzMDAsCglvcHRpb25zOiB7CgkJYWN0aXZlOiBudWxsLAoJCWNvbGxhcHNpYmxlOiBmYWxzZSwKCQlldmVudDogImNsaWNrIiwKCQloZWlnaHRTdHlsZTogImNvbnRlbnQiLAoJCWhpZGU6IG51bGwsCgkJc2hvdzogbnVsbCwKCgkJLy8gY2FsbGJhY2tzCgkJYWN0aXZhdGU6IG51bGwsCgkJYmVmb3JlQWN0aXZhdGU6IG51bGwsCgkJYmVmb3JlTG9hZDogbnVsbCwKCQlsb2FkOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgoJCXRoaXMuZWxlbWVudAoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYWxsIiApCgkJCS50b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCBvcHRpb25zLmNvbGxhcHNpYmxlICkKCQkJLy8gUHJldmVudCB1c2VycyBmcm9tIGZvY3VzaW5nIGRpc2FibGVkIHRhYnMgdmlhIGNsaWNrCgkJCS5kZWxlZ2F0ZSggIi51aS10YWJzLW5hdiA+IGxpIiwgIm1vdXNlZG93biIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICQoIHRoaXMgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9KQoJCQkvLyBzdXBwb3J0OiBJRSA8OQoJCQkvLyBQcmV2ZW50aW5nIHRoZSBkZWZhdWx0IGFjdGlvbiBpbiBtb3VzZWRvd24gZG9lc24ndCBwcmV2ZW50IElFCgkJCS8vIGZyb20gZm9jdXNpbmcgdGhlIGVsZW1lbnQsIHNvIGlmIHRoZSBhbmNob3IgZ2V0cyBmb2N1c2VkLCBibHVyLgoJCQkvLyBXZSBkb24ndCBoYXZlIHRvIHdvcnJ5IGFib3V0IGZvY3VzaW5nIHRoZSBwcmV2aW91c2x5IGZvY3VzZWQKCQkJLy8gZWxlbWVudCBzaW5jZSBjbGlja2luZyBvbiBhIG5vbi1mb2N1c2FibGUgZWxlbWVudCBzaG91bGQgZm9jdXMKCQkJLy8gdGhlIGJvZHkgYW55d2F5LgoJCQkuZGVsZWdhdGUoICIudWktdGFicy1hbmNob3IiLCAiZm9jdXMiICsgdGhpcy5ldmVudE5hbWVzcGFjZSwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoICQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuaXMoICIudWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCQkJdGhpcy5ibHVyKCk7CgkJCQl9CgkJCX0pOwoKCQl0aGlzLl9wcm9jZXNzVGFicygpOwoJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy5faW5pdGlhbEFjdGl2ZSgpOwoKCQkvLyBUYWtlIGRpc2FibGluZyB0YWJzIHZpYSBjbGFzcyBhdHRyaWJ1dGUgZnJvbSBIVE1MCgkJLy8gaW50byBhY2NvdW50IGFuZCB1cGRhdGUgb3B0aW9uIHByb3Blcmx5LgoJCWlmICggJC5pc0FycmF5KCBvcHRpb25zLmRpc2FibGVkICkgKSB7CgkJCW9wdGlvbnMuZGlzYWJsZWQgPSAkLnVuaXF1ZSggb3B0aW9ucy5kaXNhYmxlZC5jb25jYXQoCgkJCQkkLm1hcCggdGhpcy50YWJzLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSwgZnVuY3Rpb24oIGxpICkgewoJCQkJCXJldHVybiB0aGF0LnRhYnMuaW5kZXgoIGxpICk7CgkJCQl9KQoJCQkpICkuc29ydCgpOwoJCX0KCgkJLy8gY2hlY2sgZm9yIGxlbmd0aCBhdm9pZHMgZXJyb3Igd2hlbiBpbml0aWFsaXppbmcgZW1wdHkgbGlzdAoJCWlmICggdGhpcy5vcHRpb25zLmFjdGl2ZSAhPT0gZmFsc2UgJiYgdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJdGhpcy5hY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBvcHRpb25zLmFjdGl2ZSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuYWN0aXZlID0gJCgpOwoJCX0KCgkJdGhpcy5fcmVmcmVzaCgpOwoKCQlpZiAoIHRoaXMuYWN0aXZlLmxlbmd0aCApIHsKCQkJdGhpcy5sb2FkKCBvcHRpb25zLmFjdGl2ZSApOwoJCX0KCX0sCgoJX2luaXRpYWxBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCXZhciBhY3RpdmUgPSB0aGlzLm9wdGlvbnMuYWN0aXZlLAoJCQljb2xsYXBzaWJsZSA9IHRoaXMub3B0aW9ucy5jb2xsYXBzaWJsZSwKCQkJbG9jYXRpb25IYXNoID0gbG9jYXRpb24uaGFzaC5zdWJzdHJpbmcoIDEgKTsKCgkJaWYgKCBhY3RpdmUgPT09IG51bGwgKSB7CgkJCS8vIGNoZWNrIHRoZSBmcmFnbWVudCBpZGVudGlmaWVyIGluIHRoZSBVUkwKCQkJaWYgKCBsb2NhdGlvbkhhc2ggKSB7CgkJCQl0aGlzLnRhYnMuZWFjaChmdW5jdGlvbiggaSwgdGFiICkgewoJCQkJCWlmICggJCggdGFiICkuYXR0ciggImFyaWEtY29udHJvbHMiICkgPT09IGxvY2F0aW9uSGFzaCApIHsKCQkJCQkJYWN0aXZlID0gaTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgoJCQkvLyBjaGVjayBmb3IgYSB0YWIgbWFya2VkIGFjdGl2ZSB2aWEgYSBjbGFzcwoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCQkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmZpbHRlciggIi51aS10YWJzLWFjdGl2ZSIgKSApOwoJCQl9CgoJCQkvLyBubyBhY3RpdmUgdGFiLCBzZXQgdG8gZmFsc2UKCQkJaWYgKCBhY3RpdmUgPT09IG51bGwgfHwgYWN0aXZlID09PSAtMSApIHsKCQkJCWFjdGl2ZSA9IHRoaXMudGFicy5sZW5ndGggPyAwIDogZmFsc2U7CgkJCX0KCQl9CgoJCS8vIGhhbmRsZSBudW1iZXJzOiBuZWdhdGl2ZSwgb3V0IG9mIHJhbmdlCgkJaWYgKCBhY3RpdmUgIT09IGZhbHNlICkgewoJCQlhY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMudGFicy5lcSggYWN0aXZlICkgKTsKCQkJaWYgKCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gY29sbGFwc2libGUgPyBmYWxzZSA6IDA7CgkJCX0KCQl9CgoJCS8vIGRvbid0IGFsbG93IGNvbGxhcHNpYmxlOiBmYWxzZSBhbmQgYWN0aXZlOiBmYWxzZQoJCWlmICggIWNvbGxhcHNpYmxlICYmIGFjdGl2ZSA9PT0gZmFsc2UgJiYgdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJYWN0aXZlID0gMDsKCQl9CgoJCXJldHVybiBhY3RpdmU7Cgl9LAoKCV9nZXRDcmVhdGVFdmVudERhdGE6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB7CgkJCXRhYjogdGhpcy5hY3RpdmUsCgkJCXBhbmVsOiAhdGhpcy5hY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkKCQl9OwoJfSwKCglfdGFiS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBmb2N1c2VkVGFiID0gJCggdGhpcy5kb2N1bWVudFswXS5hY3RpdmVFbGVtZW50ICkuY2xvc2VzdCggImxpIiApLAoJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy50YWJzLmluZGV4KCBmb2N1c2VkVGFiICksCgkJCWdvaW5nRm9yd2FyZCA9IHRydWU7CgoJCWlmICggdGhpcy5faGFuZGxlUGFnZU5hdiggZXZlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLnVpLmtleUNvZGUuUklHSFQ6CgkJCWNhc2UgJC51aS5rZXlDb2RlLkRPV046CgkJCQlzZWxlY3RlZEluZGV4Kys7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuVVA6CgkJCWNhc2UgJC51aS5rZXlDb2RlLkxFRlQ6CgkJCQlnb2luZ0ZvcndhcmQgPSBmYWxzZTsKCQkJCXNlbGVjdGVkSW5kZXgtLTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5FTkQ6CgkJCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5hbmNob3JzLmxlbmd0aCAtIDE7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuSE9NRToKCQkJCXNlbGVjdGVkSW5kZXggPSAwOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLlNQQUNFOgoJCQkJLy8gQWN0aXZhdGUgb25seSwgbm8gY29sbGFwc2luZwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCApOwoJCQkJcmV0dXJuOwoJCQljYXNlICQudWkua2V5Q29kZS5FTlRFUjoKCQkJCS8vIFRvZ2dsZSAoY2FuY2VsIGRlbGF5ZWQgYWN0aXZhdGlvbiwgYWxsb3cgY29sbGFwc2luZykKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCQkJLy8gRGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBjb2xsYXBzZSBvciBhY3RpdmF0ZQoJCQkJdGhpcy5fYWN0aXZhdGUoIHNlbGVjdGVkSW5kZXggPT09IHRoaXMub3B0aW9ucy5hY3RpdmUgPyBmYWxzZSA6IHNlbGVjdGVkSW5kZXggKTsKCQkJCXJldHVybjsKCQkJZGVmYXVsdDoKCQkJCXJldHVybjsKCQl9CgoJCS8vIEZvY3VzIHRoZSBhcHByb3ByaWF0ZSB0YWIsIGJhc2VkIG9uIHdoaWNoIGtleSB3YXMgcHJlc3NlZAoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQlzZWxlY3RlZEluZGV4ID0gdGhpcy5fZm9jdXNOZXh0VGFiKCBzZWxlY3RlZEluZGV4LCBnb2luZ0ZvcndhcmQgKTsKCgkJLy8gTmF2aWdhdGluZyB3aXRoIGNvbnRyb2wga2V5IHdpbGwgcHJldmVudCBhdXRvbWF0aWMgYWN0aXZhdGlvbgoJCWlmICggIWV2ZW50LmN0cmxLZXkgKSB7CgkJCS8vIFVwZGF0ZSBhcmlhLXNlbGVjdGVkIGltbWVkaWF0ZWx5IHNvIHRoYXQgQVQgdGhpbmsgdGhlIHRhYiBpcyBhbHJlYWR5IHNlbGVjdGVkLgoJCQkvLyBPdGhlcndpc2UgQVQgbWF5IGNvbmZ1c2UgdGhlIHVzZXIgYnkgc3RhdGluZyB0aGF0IHRoZXkgbmVlZCB0byBhY3RpdmF0ZSB0aGUgdGFiLAoJCQkvLyBidXQgdGhlIHRhYiB3aWxsIGFscmVhZHkgYmUgYWN0aXZhdGVkIGJ5IHRoZSB0aW1lIHRoZSBhbm5vdW5jZW1lbnQgZmluaXNoZXMuCgkJCWZvY3VzZWRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJCXRoaXMudGFicy5lcSggc2VsZWN0ZWRJbmRleCApLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgInRydWUiICk7CgoJCQl0aGlzLmFjdGl2YXRpbmcgPSB0aGlzLl9kZWxheShmdW5jdGlvbigpIHsKCQkJCXRoaXMub3B0aW9uKCAiYWN0aXZlIiwgc2VsZWN0ZWRJbmRleCApOwoJCQl9LCB0aGlzLmRlbGF5ICk7CgkJfQoJfSwKCglfcGFuZWxLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBDdHJsK3VwIG1vdmVzIGZvY3VzIHRvIHRoZSBjdXJyZW50IHRhYgoJCWlmICggZXZlbnQuY3RybEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuVVAgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCXRoaXMuYWN0aXZlLmZvY3VzKCk7CgkJfQoJfSwKCgkvLyBBbHQrcGFnZSB1cC9kb3duIG1vdmVzIGZvY3VzIHRvIHRoZSBwcmV2aW91cy9uZXh0IHRhYiAoYW5kIGFjdGl2YXRlcykKCV9oYW5kbGVQYWdlTmF2OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCBldmVudC5hbHRLZXkgJiYgZXZlbnQua2V5Q29kZSA9PT0gJC51aS5rZXlDb2RlLlBBR0VfVVAgKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgLSAxLCBmYWxzZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9ET1dOICkgewoJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZm9jdXNOZXh0VGFiKCB0aGlzLm9wdGlvbnMuYWN0aXZlICsgMSwgdHJ1ZSApICk7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0sCgoJX2ZpbmROZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQl2YXIgbGFzdFRhYkluZGV4ID0gdGhpcy50YWJzLmxlbmd0aCAtIDE7CgoJCWZ1bmN0aW9uIGNvbnN0cmFpbigpIHsKCQkJaWYgKCBpbmRleCA+IGxhc3RUYWJJbmRleCApIHsKCQkJCWluZGV4ID0gMDsKCQkJfQoJCQlpZiAoIGluZGV4IDwgMCApIHsKCQkJCWluZGV4ID0gbGFzdFRhYkluZGV4OwoJCQl9CgkJCXJldHVybiBpbmRleDsKCQl9CgoJCXdoaWxlICggJC5pbkFycmF5KCBjb25zdHJhaW4oKSwgdGhpcy5vcHRpb25zLmRpc2FibGVkICkgIT09IC0xICkgewoJCQlpbmRleCA9IGdvaW5nRm9yd2FyZCA/IGluZGV4ICsgMSA6IGluZGV4IC0gMTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2ZvY3VzTmV4dFRhYjogZnVuY3Rpb24oIGluZGV4LCBnb2luZ0ZvcndhcmQgKSB7CgkJaW5kZXggPSB0aGlzLl9maW5kTmV4dFRhYiggaW5kZXgsIGdvaW5nRm9yd2FyZCApOwoJCXRoaXMudGFicy5lcSggaW5kZXggKS5mb2N1cygpOwoJCXJldHVybiBpbmRleDsKCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJhY3RpdmUiICkgewoJCQkvLyBfYWN0aXZhdGUoKSB3aWxsIGhhbmRsZSBpbnZhbGlkIHZhbHVlcyBhbmQgdXBkYXRlIHRoaXMub3B0aW9ucwoJCQl0aGlzLl9hY3RpdmF0ZSggdmFsdWUgKTsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCS8vIGRvbid0IHVzZSB0aGUgd2lkZ2V0IGZhY3RvcnkncyBkaXNhYmxlZCBoYW5kbGluZwoJCQl0aGlzLl9zZXR1cERpc2FibGVkKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSk7CgoJCWlmICgga2V5ID09PSAiY29sbGFwc2libGUiICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS10YWJzLWNvbGxhcHNpYmxlIiwgdmFsdWUgKTsKCQkJLy8gU2V0dGluZyBjb2xsYXBzaWJsZTogZmFsc2Ugd2hpbGUgY29sbGFwc2VkOyBvcGVuIGZpcnN0IHBhbmVsCgkJCWlmICggIXZhbHVlICYmIHRoaXMub3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlICkgewoJCQkJdGhpcy5fYWN0aXZhdGUoIDAgKTsKCQkJfQoJCX0KCgkJaWYgKCBrZXkgPT09ICJldmVudCIgKSB7CgkJCXRoaXMuX3NldHVwRXZlbnRzKCB2YWx1ZSApOwoJCX0KCgkJaWYgKCBrZXkgPT09ICJoZWlnaHRTdHlsZSIgKSB7CgkJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHZhbHVlICk7CgkJfQoJfSwKCglfdGFiSWQ6IGZ1bmN0aW9uKCB0YWIgKSB7CgkJcmV0dXJuIHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKSB8fCAidWktdGFicy0iICsgZ2V0TmV4dFRhYklkKCk7Cgl9LAoKCV9zYW5pdGl6ZVNlbGVjdG9yOiBmdW5jdGlvbiggaGFzaCApIHsKCQlyZXR1cm4gaGFzaCA/IGhhc2gucmVwbGFjZSggL1shIiQlJicoKSorLC5cLzo7PD0+P0BcW1xdXF5ge3x9fl0vZywgIlxcJCYiICkgOiAiIjsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWxpcyA9IHRoaXMudGFibGlzdC5jaGlsZHJlbiggIjpoYXMoYVtocmVmXSkiICk7CgoJCS8vIGdldCBkaXNhYmxlZCB0YWJzIGZyb20gY2xhc3MgYXR0cmlidXRlIGZyb20gSFRNTAoJCS8vIHRoaXMgd2lsbCBnZXQgY29udmVydGVkIHRvIGEgYm9vbGVhbiBpZiBuZWVkZWQgaW4gX3JlZnJlc2goKQoJCW9wdGlvbnMuZGlzYWJsZWQgPSAkLm1hcCggbGlzLmZpbHRlciggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSwgZnVuY3Rpb24oIHRhYiApIHsKCQkJcmV0dXJuIGxpcy5pbmRleCggdGFiICk7CgkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgoJCS8vIHdhcyBjb2xsYXBzZWQgb3Igbm8gdGFicwoJCWlmICggb3B0aW9ucy5hY3RpdmUgPT09IGZhbHNlIHx8ICF0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkvLyB3YXMgYWN0aXZlLCBidXQgYWN0aXZlIHRhYiBpcyBnb25lCgkJfSBlbHNlIGlmICggdGhpcy5hY3RpdmUubGVuZ3RoICYmICEkLmNvbnRhaW5zKCB0aGlzLnRhYmxpc3RbIDAgXSwgdGhpcy5hY3RpdmVbIDAgXSApICkgewoJCQkvLyBhbGwgcmVtYWluaW5nIHRhYnMgYXJlIGRpc2FibGVkCgkJCWlmICggdGhpcy50YWJzLmxlbmd0aCA9PT0gb3B0aW9ucy5kaXNhYmxlZC5sZW5ndGggKSB7CgkJCQlvcHRpb25zLmFjdGl2ZSA9IGZhbHNlOwoJCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJCS8vIGFjdGl2YXRlIHByZXZpb3VzIHRhYgoJCQl9IGVsc2UgewoJCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZpbmROZXh0VGFiKCBNYXRoLm1heCggMCwgb3B0aW9ucy5hY3RpdmUgLSAxICksIGZhbHNlICkgKTsKCQkJfQoJCS8vIHdhcyBhY3RpdmUsIGFjdGl2ZSB0YWIgc3RpbGwgZXhpc3RzCgkJfSBlbHNlIHsKCQkJLy8gbWFrZSBzdXJlIGFjdGl2ZSBpbmRleCBpcyBjb3JyZWN0CgkJCW9wdGlvbnMuYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLmFjdGl2ZSApOwoJCX0KCgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggdGhpcy5vcHRpb25zLmRpc2FibGVkICk7CgkJdGhpcy5fc2V0dXBFdmVudHMoIHRoaXMub3B0aW9ucy5ldmVudCApOwoJCXRoaXMuX3NldHVwSGVpZ2h0U3R5bGUoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSApOwoKCQl0aGlzLnRhYnMubm90KCB0aGlzLmFjdGl2ZSApLmF0dHIoewoJCQkiYXJpYS1zZWxlY3RlZCI6ICJmYWxzZSIsCgkJCXRhYkluZGV4OiAtMQoJCX0pOwoJCXRoaXMucGFuZWxzLm5vdCggdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkgKQoJCQkuaGlkZSgpCgkJCS5hdHRyKHsKCQkJCSJhcmlhLWV4cGFuZGVkIjogImZhbHNlIiwKCQkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCQl9KTsKCgkJLy8gTWFrZSBzdXJlIG9uZSB0YWIgaXMgaW4gdGhlIHRhYiBvcmRlcgoJCWlmICggIXRoaXMuYWN0aXZlLmxlbmd0aCApIHsKCQkJdGhpcy50YWJzLmVxKCAwICkuYXR0ciggInRhYkluZGV4IiwgMCApOwoJCX0gZWxzZSB7CgkJCXRoaXMuYWN0aXZlCgkJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1zZWxlY3RlZCI6ICJ0cnVlIiwKCQkJCQl0YWJJbmRleDogMAoJCQkJfSk7CgkJCXRoaXMuX2dldFBhbmVsRm9yVGFiKCB0aGlzLmFjdGl2ZSApCgkJCQkuc2hvdygpCgkJCQkuYXR0cih7CgkJCQkJImFyaWEtZXhwYW5kZWQiOiAidHJ1ZSIsCgkJCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCQkJfSk7CgkJfQoJfSwKCglfcHJvY2Vzc1RhYnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGF0ID0gdGhpczsKCgkJdGhpcy50YWJsaXN0ID0gdGhpcy5fZ2V0TGlzdCgpCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtbmF2IHVpLWhlbHBlci1yZXNldCB1aS1oZWxwZXItY2xlYXJmaXggdWktd2lkZ2V0LWhlYWRlciB1aS1jb3JuZXItYWxsIiApCgkJCS5hdHRyKCAicm9sZSIsICJ0YWJsaXN0IiApOwoKCQl0aGlzLnRhYnMgPSB0aGlzLnRhYmxpc3QuZmluZCggIj4gbGk6aGFzKGFbaHJlZl0pIiApCgkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWRlZmF1bHQgdWktY29ybmVyLXRvcCIgKQoJCQkuYXR0cih7CgkJCQlyb2xlOiAidGFiIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9KTsKCgkJdGhpcy5hbmNob3JzID0gdGhpcy50YWJzLm1hcChmdW5jdGlvbigpIHsKCQkJCXJldHVybiAkKCAiYSIsIHRoaXMgKVsgMCBdOwoJCQl9KQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLWFuY2hvciIgKQoJCQkuYXR0cih7CgkJCQlyb2xlOiAicHJlc2VudGF0aW9uIiwKCQkJCXRhYkluZGV4OiAtMQoJCQl9KTsKCgkJdGhpcy5wYW5lbHMgPSAkKCk7CgoJCXRoaXMuYW5jaG9ycy5lYWNoKGZ1bmN0aW9uKCBpLCBhbmNob3IgKSB7CgkJCXZhciBzZWxlY3RvciwgcGFuZWwsIHBhbmVsSWQsCgkJCQlhbmNob3JJZCA9ICQoIGFuY2hvciApLnVuaXF1ZUlkKCkuYXR0ciggImlkIiApLAoJCQkJdGFiID0gJCggYW5jaG9yICkuY2xvc2VzdCggImxpIiApLAoJCQkJb3JpZ2luYWxBcmlhQ29udHJvbHMgPSB0YWIuYXR0ciggImFyaWEtY29udHJvbHMiICk7CgoJCQkvLyBpbmxpbmUgdGFiCgkJCWlmICggaXNMb2NhbCggYW5jaG9yICkgKSB7CgkJCQlzZWxlY3RvciA9IGFuY2hvci5oYXNoOwoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggdGhhdC5fc2FuaXRpemVTZWxlY3Rvciggc2VsZWN0b3IgKSApOwoJCQkvLyByZW1vdGUgdGFiCgkJCX0gZWxzZSB7CgkJCQlwYW5lbElkID0gdGhhdC5fdGFiSWQoIHRhYiApOwoJCQkJc2VsZWN0b3IgPSAiIyIgKyBwYW5lbElkOwoJCQkJcGFuZWwgPSB0aGF0LmVsZW1lbnQuZmluZCggc2VsZWN0b3IgKTsKCQkJCWlmICggIXBhbmVsLmxlbmd0aCApIHsKCQkJCQlwYW5lbCA9IHRoYXQuX2NyZWF0ZVBhbmVsKCBwYW5lbElkICk7CgkJCQkJcGFuZWwuaW5zZXJ0QWZ0ZXIoIHRoYXQucGFuZWxzWyBpIC0gMSBdIHx8IHRoYXQudGFibGlzdCApOwoJCQkJfQoJCQkJcGFuZWwuYXR0ciggImFyaWEtbGl2ZSIsICJwb2xpdGUiICk7CgkJCX0KCgkJCWlmICggcGFuZWwubGVuZ3RoKSB7CgkJCQl0aGF0LnBhbmVscyA9IHRoYXQucGFuZWxzLmFkZCggcGFuZWwgKTsKCQkJfQoJCQlpZiAoIG9yaWdpbmFsQXJpYUNvbnRyb2xzICkgewoJCQkJdGFiLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiLCBvcmlnaW5hbEFyaWFDb250cm9scyApOwoJCQl9CgkJCXRhYi5hdHRyKHsKCQkJCSJhcmlhLWNvbnRyb2xzIjogc2VsZWN0b3Iuc3Vic3RyaW5nKCAxICksCgkJCQkiYXJpYS1sYWJlbGxlZGJ5IjogYW5jaG9ySWQKCQkJfSk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWxhYmVsbGVkYnkiLCBhbmNob3JJZCApOwoJCX0pOwoKCQl0aGlzLnBhbmVscwoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLXBhbmVsIHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1ib3R0b20iICkKCQkJLmF0dHIoICJyb2xlIiwgInRhYnBhbmVsIiApOwoJfSwKCgkvLyBhbGxvdyBvdmVycmlkaW5nIGhvdyB0byBmaW5kIHRoZSBsaXN0IGZvciByYXJlIHVzYWdlIHNjZW5hcmlvcyAoIzc3MTUpCglfZ2V0TGlzdDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudC5maW5kKCAib2wsdWwiICkuZXEoIDAgKTsKCX0sCgoJX2NyZWF0ZVBhbmVsOiBmdW5jdGlvbiggaWQgKSB7CgkJcmV0dXJuICQoICI8ZGl2PiIgKQoJCQkuYXR0ciggImlkIiwgaWQgKQoJCQkuYWRkQ2xhc3MoICJ1aS10YWJzLXBhbmVsIHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1ib3R0b20iICkKCQkJLmRhdGEoICJ1aS10YWJzLWRlc3Ryb3kiLCB0cnVlICk7Cgl9LAoKCV9zZXR1cERpc2FibGVkOiBmdW5jdGlvbiggZGlzYWJsZWQgKSB7CgkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCWlmICggIWRpc2FibGVkLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIGRpc2FibGVkLmxlbmd0aCA9PT0gdGhpcy5hbmNob3JzLmxlbmd0aCApIHsKCQkJCWRpc2FibGVkID0gdHJ1ZTsKCQkJfQoJCX0KCgkJLy8gZGlzYWJsZSB0YWJzCgkJZm9yICggdmFyIGkgPSAwLCBsaTsgKCBsaSA9IHRoaXMudGFic1sgaSBdICk7IGkrKyApIHsKCQkJaWYgKCBkaXNhYmxlZCA9PT0gdHJ1ZSB8fCAkLmluQXJyYXkoIGksIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJJCggbGkgKQoJCQkJCS5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApCgkJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgInRydWUiICk7CgkJCX0gZWxzZSB7CgkJCQkkKCBsaSApCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICk7CgkJCX0KCQl9CgoJCXRoaXMub3B0aW9ucy5kaXNhYmxlZCA9IGRpc2FibGVkOwoJfSwKCglfc2V0dXBFdmVudHM6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgZXZlbnRzID0ge307CgkJaWYgKCBldmVudCApIHsKCQkJJC5lYWNoKCBldmVudC5zcGxpdCgiICIpLCBmdW5jdGlvbiggaW5kZXgsIGV2ZW50TmFtZSApIHsKCQkJCWV2ZW50c1sgZXZlbnROYW1lIF0gPSAiX2V2ZW50SGFuZGxlciI7CgkJCX0pOwoJCX0KCgkJdGhpcy5fb2ZmKCB0aGlzLmFuY2hvcnMuYWRkKCB0aGlzLnRhYnMgKS5hZGQoIHRoaXMucGFuZWxzICkgKTsKCQkvLyBBbHdheXMgcHJldmVudCB0aGUgZGVmYXVsdCBhY3Rpb24sIGV2ZW4gd2hlbiBkaXNhYmxlZAoJCXRoaXMuX29uKCB0cnVlLCB0aGlzLmFuY2hvcnMsIHsKCQkJY2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9KTsKCQl0aGlzLl9vbiggdGhpcy5hbmNob3JzLCBldmVudHMgKTsKCQl0aGlzLl9vbiggdGhpcy50YWJzLCB7IGtleWRvd246ICJfdGFiS2V5ZG93biIgfSApOwoJCXRoaXMuX29uKCB0aGlzLnBhbmVscywgeyBrZXlkb3duOiAiX3BhbmVsS2V5ZG93biIgfSApOwoKCQl0aGlzLl9mb2N1c2FibGUoIHRoaXMudGFicyApOwoJCXRoaXMuX2hvdmVyYWJsZSggdGhpcy50YWJzICk7Cgl9LAoKCV9zZXR1cEhlaWdodFN0eWxlOiBmdW5jdGlvbiggaGVpZ2h0U3R5bGUgKSB7CgkJdmFyIG1heEhlaWdodCwKCQkJcGFyZW50ID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoKCQlpZiAoIGhlaWdodFN0eWxlID09PSAiZmlsbCIgKSB7CgkJCW1heEhlaWdodCA9IHBhcmVudC5oZWlnaHQoKTsKCQkJbWF4SGVpZ2h0IC09IHRoaXMuZWxlbWVudC5vdXRlckhlaWdodCgpIC0gdGhpcy5lbGVtZW50LmhlaWdodCgpOwoKCQkJdGhpcy5lbGVtZW50LnNpYmxpbmdzKCAiOnZpc2libGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBlbGVtID0gJCggdGhpcyApLAoJCQkJCXBvc2l0aW9uID0gZWxlbS5jc3MoICJwb3NpdGlvbiIgKTsKCgkJCQlpZiAoIHBvc2l0aW9uID09PSAiYWJzb2x1dGUiIHx8IHBvc2l0aW9uID09PSAiZml4ZWQiICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCW1heEhlaWdodCAtPSBlbGVtLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0pOwoKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCkubm90KCB0aGlzLnBhbmVscyApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQltYXhIZWlnaHQgLT0gJCggdGhpcyApLm91dGVySGVpZ2h0KCB0cnVlICk7CgkJCX0pOwoKCQkJdGhpcy5wYW5lbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5oZWlnaHQoIE1hdGgubWF4KCAwLCBtYXhIZWlnaHQgLQoJCQkJCSQoIHRoaXMgKS5pbm5lckhlaWdodCgpICsgJCggdGhpcyApLmhlaWdodCgpICkgKTsKCQkJfSkKCQkJLmNzcyggIm92ZXJmbG93IiwgImF1dG8iICk7CgkJfSBlbHNlIGlmICggaGVpZ2h0U3R5bGUgPT09ICJhdXRvIiApIHsKCQkJbWF4SGVpZ2h0ID0gMDsKCQkJdGhpcy5wYW5lbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCA9IE1hdGgubWF4KCBtYXhIZWlnaHQsICQoIHRoaXMgKS5oZWlnaHQoICIiICkuaGVpZ2h0KCkgKTsKCQkJfSkuaGVpZ2h0KCBtYXhIZWlnaHQgKTsKCQl9Cgl9LAoKCV9ldmVudEhhbmRsZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJYWN0aXZlID0gdGhpcy5hY3RpdmUsCgkJCWFuY2hvciA9ICQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKSwKCQkJdGFiID0gYW5jaG9yLmNsb3Nlc3QoICJsaSIgKSwKCQkJY2xpY2tlZElzQWN0aXZlID0gdGFiWyAwIF0gPT09IGFjdGl2ZVsgMCBdLAoJCQljb2xsYXBzaW5nID0gY2xpY2tlZElzQWN0aXZlICYmIG9wdGlvbnMuY29sbGFwc2libGUsCgkJCXRvU2hvdyA9IGNvbGxhcHNpbmcgPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCXRvSGlkZSA9ICFhY3RpdmUubGVuZ3RoID8gJCgpIDogdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIGFjdGl2ZSApLAoJCQlldmVudERhdGEgPSB7CgkJCQlvbGRUYWI6IGFjdGl2ZSwKCQkJCW9sZFBhbmVsOiB0b0hpZGUsCgkJCQluZXdUYWI6IGNvbGxhcHNpbmcgPyAkKCkgOiB0YWIsCgkJCQluZXdQYW5lbDogdG9TaG93CgkJCX07CgoJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCWlmICggdGFiLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgfHwKCQkJCS8vIHRhYiBpcyBhbHJlYWR5IGxvYWRpbmcKCQkJCXRhYi5oYXNDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKSB8fAoJCQkJLy8gY2FuJ3Qgc3dpdGNoIGR1cm5pbmcgYW4gYW5pbWF0aW9uCgkJCQl0aGlzLnJ1bm5pbmcgfHwKCQkJCS8vIGNsaWNrIG9uIGFjdGl2ZSBoZWFkZXIsIGJ1dCBub3QgY29sbGFwc2libGUKCQkJCSggY2xpY2tlZElzQWN0aXZlICYmICFvcHRpb25zLmNvbGxhcHNpYmxlICkgfHwKCQkJCS8vIGFsbG93IGNhbmNlbGluZyBhY3RpdmF0aW9uCgkJCQkoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVBY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKSA9PT0gZmFsc2UgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJb3B0aW9ucy5hY3RpdmUgPSBjb2xsYXBzaW5nID8gZmFsc2UgOiB0aGlzLnRhYnMuaW5kZXgoIHRhYiApOwoKCQl0aGlzLmFjdGl2ZSA9IGNsaWNrZWRJc0FjdGl2ZSA/ICQoKSA6IHRhYjsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJaWYgKCAhdG9IaWRlLmxlbmd0aCAmJiAhdG9TaG93Lmxlbmd0aCApIHsKCQkJJC5lcnJvciggImpRdWVyeSBVSSBUYWJzOiBNaXNtYXRjaGluZyBmcmFnbWVudCBpZGVudGlmaWVyLiIgKTsKCQl9CgoJCWlmICggdG9TaG93Lmxlbmd0aCApIHsKCQkJdGhpcy5sb2FkKCB0aGlzLnRhYnMuaW5kZXgoIHRhYiApLCBldmVudCApOwoJCX0KCQl0aGlzLl90b2dnbGUoIGV2ZW50LCBldmVudERhdGEgKTsKCX0sCgoJLy8gaGFuZGxlcyBzaG93L2hpZGUgZm9yIHNlbGVjdGluZyB0YWJzCglfdG9nZ2xlOiBmdW5jdGlvbiggZXZlbnQsIGV2ZW50RGF0YSApIHsKCQl2YXIgdGhhdCA9IHRoaXMsCgkJCXRvU2hvdyA9IGV2ZW50RGF0YS5uZXdQYW5lbCwKCQkJdG9IaWRlID0gZXZlbnREYXRhLm9sZFBhbmVsOwoKCQl0aGlzLnJ1bm5pbmcgPSB0cnVlOwoKCQlmdW5jdGlvbiBjb21wbGV0ZSgpIHsKCQkJdGhhdC5ydW5uaW5nID0gZmFsc2U7CgkJCXRoYXQuX3RyaWdnZXIoICJhY3RpdmF0ZSIsIGV2ZW50LCBldmVudERhdGEgKTsKCQl9CgoJCWZ1bmN0aW9uIHNob3coKSB7CgkJCWV2ZW50RGF0YS5uZXdUYWIuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoKCQkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRoYXQub3B0aW9ucy5zaG93ICkgewoJCQkJdGhhdC5fc2hvdyggdG9TaG93LCB0aGF0Lm9wdGlvbnMuc2hvdywgY29tcGxldGUgKTsKCQkJfSBlbHNlIHsKCQkJCXRvU2hvdy5zaG93KCk7CgkJCQljb21wbGV0ZSgpOwoJCQl9CgkJfQoKCQkvLyBzdGFydCBvdXQgYnkgaGlkaW5nLCB0aGVuIHNob3dpbmcsIHRoZW4gY29tcGxldGluZwoJCWlmICggdG9IaWRlLmxlbmd0aCAmJiB0aGlzLm9wdGlvbnMuaGlkZSApIHsKCQkJdGhpcy5faGlkZSggdG9IaWRlLCB0aGlzLm9wdGlvbnMuaGlkZSwgZnVuY3Rpb24oKSB7CgkJCQlldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCXNob3coKTsKCQkJfSk7CgkJfSBlbHNlIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5jbG9zZXN0KCAibGkiICkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCXRvSGlkZS5oaWRlKCk7CgkJCXNob3coKTsKCQl9CgoJCXRvSGlkZS5hdHRyKHsKCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQkiYXJpYS1oaWRkZW4iOiAidHJ1ZSIKCQl9KTsKCQlldmVudERhdGEub2xkVGFiLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgImZhbHNlIiApOwoJCS8vIElmIHdlJ3JlIHN3aXRjaGluZyB0YWJzLCByZW1vdmUgdGhlIG9sZCB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIG9wZW5pbmcgZnJvbSBjb2xsYXBzZWQgc3RhdGUsIHJlbW92ZSB0aGUgcHJldmlvdXMgdGFiIGZyb20gdGhlIHRhYiBvcmRlci4KCQkvLyBJZiB3ZSdyZSBjb2xsYXBzaW5nLCB0aGVuIGtlZXAgdGhlIGNvbGxhcHNpbmcgdGFiIGluIHRoZSB0YWIgb3JkZXIuCgkJaWYgKCB0b1Nob3cubGVuZ3RoICYmIHRvSGlkZS5sZW5ndGggKSB7CgkJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggInRhYkluZGV4IiwgLTEgKTsKCQl9IGVsc2UgaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoIHRoaXMgKS5hdHRyKCAidGFiSW5kZXgiICkgPT09IDA7CgkJCX0pCgkJCS5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0KCgkJdG9TaG93LmF0dHIoewoJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJImFyaWEtaGlkZGVuIjogImZhbHNlIgoJCX0pOwoJCWV2ZW50RGF0YS5uZXdUYWIuYXR0cih7CgkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQl0YWJJbmRleDogMAoJCX0pOwoJfSwKCglfYWN0aXZhdGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgYW5jaG9yLAoJCQlhY3RpdmUgPSB0aGlzLl9maW5kQWN0aXZlKCBpbmRleCApOwoKCQkvLyB0cnlpbmcgdG8gYWN0aXZhdGUgdGhlIGFscmVhZHkgYWN0aXZlIHBhbmVsCgkJaWYgKCBhY3RpdmVbIDAgXSA9PT0gdGhpcy5hY3RpdmVbIDAgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gdHJ5aW5nIHRvIGNvbGxhcHNlLCBzaW11bGF0ZSBhIGNsaWNrIG9uIHRoZSBjdXJyZW50IGFjdGl2ZSBoZWFkZXIKCQlpZiAoICFhY3RpdmUubGVuZ3RoICkgewoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZTsKCQl9CgoJCWFuY2hvciA9IGFjdGl2ZS5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApWyAwIF07CgkJdGhpcy5fZXZlbnRIYW5kbGVyKHsKCQkJdGFyZ2V0OiBhbmNob3IsCgkJCWN1cnJlbnRUYXJnZXQ6IGFuY2hvciwKCQkJcHJldmVudERlZmF1bHQ6ICQubm9vcAoJCX0pOwoJfSwKCglfZmluZEFjdGl2ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXJldHVybiBpbmRleCA9PT0gZmFsc2UgPyAkKCkgOiB0aGlzLnRhYnMuZXEoIGluZGV4ICk7Cgl9LAoKCV9nZXRJbmRleDogZnVuY3Rpb24oIGluZGV4ICkgewoJCS8vIG1ldGEtZnVuY3Rpb24gdG8gZ2l2ZSB1c2VycyBvcHRpb24gdG8gcHJvdmlkZSBhIGhyZWYgc3RyaW5nIGluc3RlYWQgb2YgYSBudW1lcmljYWwgaW5kZXguCgkJaWYgKCB0eXBlb2YgaW5kZXggPT09ICJzdHJpbmciICkgewoJCQlpbmRleCA9IHRoaXMuYW5jaG9ycy5pbmRleCggdGhpcy5hbmNob3JzLmZpbHRlciggIltocmVmJD0nIiArIGluZGV4ICsgIiddIiApICk7CgkJfQoKCQlyZXR1cm4gaW5kZXg7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMueGhyICkgewoJCQl0aGlzLnhoci5hYm9ydCgpOwoJCX0KCgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktdGFicyB1aS13aWRnZXQgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWFsbCB1aS10YWJzLWNvbGxhcHNpYmxlIiApOwoKCQl0aGlzLnRhYmxpc3QKCQkJLnJlbW92ZUNsYXNzKCAidWktdGFicy1uYXYgdWktaGVscGVyLXJlc2V0IHVpLWhlbHBlci1jbGVhcmZpeCB1aS13aWRnZXQtaGVhZGVyIHVpLWNvcm5lci1hbGwiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApOwoKCQl0aGlzLmFuY2hvcnMKCQkJLnJlbW92ZUNsYXNzKCAidWktdGFicy1hbmNob3IiICkKCQkJLnJlbW92ZUF0dHIoICJyb2xlIiApCgkJCS5yZW1vdmVBdHRyKCAidGFiSW5kZXgiICkKCQkJLnJlbW92ZVVuaXF1ZUlkKCk7CgoJCXRoaXMudGFicy5hZGQoIHRoaXMucGFuZWxzICkuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAkLmRhdGEoIHRoaXMsICJ1aS10YWJzLWRlc3Ryb3kiICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlKCk7CgkJCX0gZWxzZSB7CgkJCQkkKCB0aGlzICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kZWZhdWx0IHVpLXN0YXRlLWFjdGl2ZSB1aS1zdGF0ZS1kaXNhYmxlZCAiICsKCQkJCQkJInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSB1aS13aWRnZXQtY29udGVudCB1aS10YWJzLWFjdGl2ZSB1aS10YWJzLXBhbmVsIiApCgkJCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1saXZlIiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWJ1c3kiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtc2VsZWN0ZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtbGFiZWxsZWRieSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1oaWRkZW4iICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtZXhwYW5kZWQiICkKCQkJCQkucmVtb3ZlQXR0ciggInJvbGUiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy50YWJzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBsaSA9ICQoIHRoaXMgKSwKCQkJCXByZXYgPSBsaS5kYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQlpZiAoIHByZXYgKSB7CgkJCQlsaQoJCQkJCS5hdHRyKCAiYXJpYS1jb250cm9scyIsIHByZXYgKQoJCQkJCS5yZW1vdmVEYXRhKCAidWktdGFicy1hcmlhLWNvbnRyb2xzIiApOwoJCQl9IGVsc2UgewoJCQkJbGkucmVtb3ZlQXR0ciggImFyaWEtY29udHJvbHMiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5wYW5lbHMuc2hvdygpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oZWlnaHRTdHlsZSAhPT0gImNvbnRlbnQiICkgewoJCQl0aGlzLnBhbmVscy5jc3MoICJoZWlnaHQiLCAiIiApOwoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gZmFsc2U7CgkJfSBlbHNlIHsKCQkJaW5kZXggPSB0aGlzLl9nZXRJbmRleCggaW5kZXggKTsKCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWFwKCBkaXNhYmxlZCwgZnVuY3Rpb24oIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCWRpc2FibGVkID0gJC5tYXAoIHRoaXMudGFicywgZnVuY3Rpb24oIGxpLCBudW0gKSB7CgkJCQkJcmV0dXJuIG51bSAhPT0gaW5kZXggPyBudW0gOiBudWxsOwoJCQkJfSk7CgkJCX0KCQl9CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBkaXNhYmxlZCA9IHRoaXMub3B0aW9ucy5kaXNhYmxlZDsKCQlpZiAoIGRpc2FibGVkID09PSB0cnVlICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCWRpc2FibGVkID0gdHJ1ZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaW5BcnJheSggaW5kZXgsIGRpc2FibGVkICkgIT09IC0xICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggJC5pc0FycmF5KCBkaXNhYmxlZCApICkgewoJCQkJZGlzYWJsZWQgPSAkLm1lcmdlKCBbIGluZGV4IF0sIGRpc2FibGVkICkuc29ydCgpOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSBbIGluZGV4IF07CgkJCX0KCQl9CgkJdGhpcy5fc2V0dXBEaXNhYmxlZCggZGlzYWJsZWQgKTsKCX0sCgoJbG9hZDogZnVuY3Rpb24oIGluZGV4LCBldmVudCApIHsKCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCXZhciB0aGF0ID0gdGhpcywKCQkJdGFiID0gdGhpcy50YWJzLmVxKCBpbmRleCApLAoJCQlhbmNob3IgPSB0YWIuZmluZCggIi51aS10YWJzLWFuY2hvciIgKSwKCQkJcGFuZWwgPSB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGFiICksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCXRhYjogdGFiLAoJCQkJcGFuZWw6IHBhbmVsCgkJCX07CgoJCS8vIG5vdCByZW1vdGUKCQlpZiAoIGlzTG9jYWwoIGFuY2hvclsgMCBdICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMueGhyID0gJC5hamF4KCB0aGlzLl9hamF4U2V0dGluZ3MoIGFuY2hvciwgZXZlbnQsIGV2ZW50RGF0YSApICk7CgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJLy8galF1ZXJ5IDwxLjggcmV0dXJucyBmYWxzZSBpZiB0aGUgcmVxdWVzdCBpcyBjYW5jZWxlZCBpbiBiZWZvcmVTZW5kLAoJCS8vIGJ1dCBhcyBvZiAxLjgsICQuYWpheCgpIGFsd2F5cyByZXR1cm5zIGEganFYSFIgb2JqZWN0LgoJCWlmICggdGhpcy54aHIgJiYgdGhpcy54aHIuc3RhdHVzVGV4dCAhPT0gImNhbmNlbGVkIiApIHsKCQkJdGFiLmFkZENsYXNzKCAidWktdGFicy1sb2FkaW5nIiApOwoJCQlwYW5lbC5hdHRyKCAiYXJpYS1idXN5IiwgInRydWUiICk7CgoJCQl0aGlzLnhocgoJCQkJLnN1Y2Nlc3MoZnVuY3Rpb24oIHJlc3BvbnNlICkgewoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQlwYW5lbC5odG1sKCByZXNwb25zZSApOwoJCQkJCQl0aGF0Ll90cmlnZ2VyKCAibG9hZCIsIGV2ZW50LCBldmVudERhdGEgKTsKCQkJCQl9LCAxICk7CgkJCQl9KQoJCQkJLmNvbXBsZXRlKGZ1bmN0aW9uKCBqcVhIUiwgc3RhdHVzICkgewoJCQkJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTE3NzgKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQlpZiAoIHN0YXR1cyA9PT0gImFib3J0IiApIHsKCQkJCQkJCXRoYXQucGFuZWxzLnN0b3AoIGZhbHNlLCB0cnVlICk7CgkJCQkJCX0KCgkJCQkJCXRhYi5yZW1vdmVDbGFzcyggInVpLXRhYnMtbG9hZGluZyIgKTsKCQkJCQkJcGFuZWwucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKTsKCgkJCQkJCWlmICgganFYSFIgPT09IHRoYXQueGhyICkgewoJCQkJCQkJZGVsZXRlIHRoYXQueGhyOwoJCQkJCQl9CgkJCQkJfSwgMSApOwoJCQkJfSk7CgkJfQoJfSwKCglfYWpheFNldHRpbmdzOiBmdW5jdGlvbiggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpczsKCQlyZXR1cm4gewoJCQl1cmw6IGFuY2hvci5hdHRyKCAiaHJlZiIgKSwKCQkJYmVmb3JlU2VuZDogZnVuY3Rpb24oIGpxWEhSLCBzZXR0aW5ncyApIHsKCQkJCXJldHVybiB0aGF0Ll90cmlnZ2VyKCAiYmVmb3JlTG9hZCIsIGV2ZW50LAoJCQkJCSQuZXh0ZW5kKCB7IGpxWEhSIDoganFYSFIsIGFqYXhTZXR0aW5nczogc2V0dGluZ3MgfSwgZXZlbnREYXRhICkgKTsKCQkJfQoJCX07Cgl9LAoKCV9nZXRQYW5lbEZvclRhYjogZnVuY3Rpb24oIHRhYiApIHsKCQl2YXIgaWQgPSAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoIHRoaXMuX3Nhbml0aXplU2VsZWN0b3IoICIjIiArIGlkICkgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoKCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IHRydWU7CgoJLy8gVGhpcyBmaXggYWRkcmVzc2VzIGFuIGlPUyBidWcsIHNvIHJldHVybiBlYXJseSBpZiB0aGUgVUEgY2xhaW1zIGl0J3Mgc29tZXRoaW5nIGVsc2UuCgl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCXpvb20sCgkJZXZ0LCB4LCB5LCB6LCBhaWc7CglpZiAoICEoIC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiAvT1MgWzEtNV1fWzAtOV9dKiBsaWtlIE1hYyBPUyBYL2kudGVzdCggdWEgKSAmJiB1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSApICkgewoJCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IGZhbHNlOwoJCXJldHVybjsKCX0KCgl6b29tID0gJC5tb2JpbGUuem9vbTsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCkgewoJCWlmICggJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkICkgewoJCQkkLm1vYmlsZS53aW5kb3cKCQkJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJCQkuYmluZCggImRldmljZW1vdGlvbi5pb3NvcmllbnRhdGlvbmZpeCIsIGNoZWNrVGlsdCApOwoJCX0KCX0pOwoKfSggalF1ZXJ5LCB0aGlzICkpOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCSR3aW5kb3cgPSAkLm1vYmlsZS53aW5kb3c7CgoJLy9yZW1vdmUgaW5pdGlhbCBidWlsZCBjbGFzcyAob25seSBwcmVzZW50IG9uIGZpcnN0IHBhZ2VzaG93KQoJZnVuY3Rpb24gaGlkZVJlbmRlcmluZ0NsYXNzKCkgewoJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCX0KCgkvLyB0cmlnZ2VyIG1vYmlsZWluaXQgZXZlbnQgLSB1c2VmdWwgaG9vayBmb3IgY29uZmlndXJpbmcgJC5tb2JpbGUgc2V0dGluZ3MgYmVmb3JlIHRoZXkncmUgdXNlZAoJJCggd2luZG93LmRvY3VtZW50ICkudHJpZ2dlciggIm1vYmlsZWluaXQiICk7CgoJLy8gc3VwcG9ydCBjb25kaXRpb25zCgkvLyBpZiBkZXZpY2Ugc3VwcG9ydCBjb25kaXRpb24ocykgYXJlbid0IG1ldCwgbGVhdmUgdGhpbmdzIGFzIHRoZXkgYXJlIC0+IGEgYmFzaWMsIHVzYWJsZSBleHBlcmllbmNlLAoJLy8gb3RoZXJ3aXNlLCBwcm9jZWVkIHdpdGggdGhlIGVuaGFuY2VtZW50cwoJaWYgKCAhJC5tb2JpbGUuZ3JhZGVBKCkgKSB7CgkJcmV0dXJuOwoJfQoKCS8vIG92ZXJyaWRlIGFqYXhFbmFibGVkIG9uIHBsYXRmb3JtcyB0aGF0IGhhdmUga25vd24gY29uZmxpY3RzIHdpdGggaGFzaCBoaXN0b3J5IHVwZGF0ZXMKCS8vIG9yIGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKEJCNSwgT3BlcmEgTWluaSkKCWlmICggJC5tb2JpbGUuYWpheEJsYWNrbGlzdCApIHsKCQkkLm1vYmlsZS5hamF4RW5hYmxlZCA9IGZhbHNlOwoJfQoKCS8vIEFkZCBtb2JpbGUsIGluaXRpYWwgbG9hZCAicmVuZGVyaW5nIiBjbGFzc2VzIHRvIGRvY0VsCgkkaHRtbC5hZGRDbGFzcyggInVpLW1vYmlsZSB1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoKCS8vIFRoaXMgaXMgYSBmYWxsYmFjay4gSWYgYW55dGhpbmcgZ29lcyB3cm9uZyAoSlMgZXJyb3JzLCBldGMpLCBvciBldmVudHMgZG9uJ3QgZmlyZSwKCS8vIHRoaXMgZW5zdXJlcyB0aGUgcmVuZGVyaW5nIGNsYXNzIGlzIHJlbW92ZWQgYWZ0ZXIgNSBzZWNvbmRzLCBzbyBjb250ZW50IGlzIHZpc2libGUgYW5kIGFjY2Vzc2libGUKCXNldFRpbWVvdXQoIGhpZGVSZW5kZXJpbmdDbGFzcywgNTAwMCApOwoKCSQuZXh0ZW5kKCAkLm1vYmlsZSwgewoJCS8vIGZpbmQgYW5kIGVuaGFuY2UgdGhlIHBhZ2VzIGluIHRoZSBkb20gYW5kIHRyYW5zaXRpb24gdG8gdGhlIGZpcnN0IHBhZ2UuCgkJaW5pdGlhbGl6ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBmaW5kIHByZXNlbnQgcGFnZXMKCQkJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCQkJJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICksCgkJCQloYXNoID0gcGF0aC5zdHJpcEhhc2goIHBhdGguc3RyaXBRdWVyeVBhcmFtcyhwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoKSApLAoJCQkJdGhlTG9jYXRpb24gPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKSwKCQkJCWhhc2hQYWdlID0gaGFzaCA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBoYXNoICkgOiB1bmRlZmluZWQ7CgoJCQkvLyBpZiBubyBwYWdlcyBhcmUgZm91bmQsIGNyZWF0ZSBvbmUgd2l0aCBib2R5J3MgaW5uZXIgaHRtbAoJCQlpZiAoICEkcGFnZXMubGVuZ3RoICkgewoJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJfQoKCQkJLy8gYWRkIGRpYWxvZ3MsIHNldCBkYXRhLXVybCBhdHRycwoJCQkkcGFnZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCQkvLyB1bmxlc3MgdGhlIGRhdGEgdXJsIGlzIGFscmVhZHkgc2V0IHNldCBpdCB0byB0aGUgcGF0aG5hbWUKCQkJCWlmICggISR0aGlzWyAwIF0uZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiApICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwKCQkJCQkJdGhlTG9jYXRpb24ucGF0aG5hbWUgKyB0aGVMb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICQubW9iaWxlLmZpcnN0UGFnZQoJCQkJLnBhcmVudCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICkKCQkJCS5wYWdlY29udGFpbmVyKCk7CgoJCQkvLyBpbml0aWFsaXplIG5hdmlnYXRpb24gZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQgYW5kIHRoZSBwYWdlIGNvbnRhaW5lcgoJCQkvLyBoYXMgYmVlbiBjcmVhdGVkIGJ1dCBiZWZvcmUgdGhlIHJlc3Qgb2YgdGhlIGxpYnJhcnkgaXMgYWxlcnRlZCB0byB0aGF0IGZhY3QKCQkJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5sb2FkaW5nKCAic2hvdyIgKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCwgdGhlcmUncyBubyBoYXNoIGRlZXBsaW5rLAoJCQkvLyB0aGUgaGFzaCBpcyBub3QgdmFsaWQgKGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgIyBvciBkb2VzIG5vdCBzdGFydCB3aXRoICMpCgkJCS8vIG9yIHRoZXJlIGlzIG5vIHBhZ2Ugd2l0aCB0aGF0IGhhc2gsIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCS8vIFJlbWVtYmVyLCBob3dldmVyLCB0aGF0IHRoZSBoYXNoIGNhbiBhbHNvIGJlIGEgcGF0aCEKCQkJaWYgKCAhICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJKCAkKCBoYXNoUGFnZSApLmlzKCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApIHx8CgkJCQkJJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSB8fAoJCQkJCWhhc2ggPT09ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSApICkgewoKCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgaW5pdGlhbCBwb3BzdGF0ZSBzdGF0ZSBpZiBpdCBleGlzdHMKCQkJCS8vIHNvIHRoYXQgbmF2aWdhdGlvbiBiYWNrIHRvIHRoZSBpbml0aWFsIHBhZ2Ugd29ya3MgcHJvcGVybHkKCQkJCWlmICggJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvci5zcXVhc2goIHBhdGgucGFyc2VMb2NhdGlvbigpLmhyZWYgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIHsKCQkJCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJCQkJcmV2ZXJzZTogdHJ1ZSwKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZQoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkvLyB0cmlnZ2VyIGhhc2hjaGFuZ2Ugb3IgbmF2aWdhdGUgdG8gc3F1YXNoIGFuZCByZWNvcmQgdGhlIGNvcnJlY3QKCQkJCS8vIGhpc3RvcnkgZW50cnkgZm9yIGFuIGluaXRpYWwgaGFzaCBwYXRoCgkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQkJJHdpbmRvdy50cmlnZ2VyKCAiaGFzaGNoYW5nZSIsIFt0cnVlXSApOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBUT0RPIGZpZ3VyZSBvdXQgaG93IHRvIHNpbXBsaWZ5IHRoaXMgaW50ZXJhY3Rpb24gd2l0aCB0aGUgaW5pdGlhbCBoaXN0b3J5IGVudHJ5CgkJCQkJLy8gYXQgdGhlIGJvdHRvbSBqcy9uYXZpZ2F0ZS9uYXZpZ2F0ZS5qcwoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnkuc3RhY2sgPSBbXTsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZSggJC5tb2JpbGUucGF0aC5pc1BhdGgoIGxvY2F0aW9uLmhhc2ggKSA/IGxvY2F0aW9uLmhhc2ggOiBsb2NhdGlvbi5ocmVmICk7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKCgkkKGZ1bmN0aW9uKCkgewoJCS8vUnVuIGlubGluZVNWRyBzdXBwb3J0IHRlc3QKCQkkLnN1cHBvcnQuaW5saW5lU1ZHKCk7CgoJCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJCS8vIHRoZW4gY2hlY2sgd2hhdCB0aGUgc2Nyb2xsIHRvcCBpcy4gQW5kcm9pZCB3aWxsIHJlcG9ydCAwLi4uIG90aGVycyAxCgkJLy8gbm90ZSB0aGF0IHRoaXMgaW5pdGlhbCBzY3JvbGwgd29uJ3QgaGlkZSB0aGUgYWRkcmVzcyBiYXIuIEl0J3MganVzdCBmb3IgdGhlIGNoZWNrLgoKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkIGlmIGhpZGVVcmxCYXIgaXMgdHJ1ZSB0aGlzIGlzIHRvIHRyeSBhbmQgZG8gaXQgYXMgc29vbiBhcyBwb3NzaWJsZQoJCWlmICggJC5tb2JpbGUuaGlkZVVybEJhciApIHsKCQkJd2luZG93LnNjcm9sbFRvKCAwLCAxICk7CgkJfQoKCQkvLyBpZiBkZWZhdWx0SG9tZVNjcm9sbCBoYXNuJ3QgYmVlbiBzZXQgeWV0LCBzZWUgaWYgc2Nyb2xsVG9wIGlzIDEKCQkvLyBpdCBzaG91bGQgYmUgMSBpbiBtb3N0IGJyb3dzZXJzLCBidXQgYW5kcm9pZCB0cmVhdHMgMSBhcyAwIChmb3IgaGlkaW5nIGFkZHIgYmFyKQoJCS8vIHNvIGlmIGl0J3MgMSwgdXNlIDAgZnJvbSBub3cgb24KCQkkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA9ICggISQuc3VwcG9ydC5zY3JvbGxUb3AgfHwgJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpID09PSAxICkgPyAwIDogMTsKCgkJLy9kb20tcmVhZHkgaW5pdHMKCQlpZiAoICQubW9iaWxlLmF1dG9Jbml0aWFsaXplUGFnZSApIHsKCQkJJC5tb2JpbGUuaW5pdGlhbGl6ZVBhZ2UoKTsKCQl9CgoJCS8vIHdpbmRvdyBsb2FkIGV2ZW50CgkJLy8gaGlkZSBpT1MgYnJvd3NlciBjaHJvbWUgb24gbG9hZCBpZiBoaWRlVXJsQmFyIGlzIHRydWUgdGhpcyBpcyBhcyBmYWxsIGJhY2sgaW5jYXNlIHdlIHdlcmUgdG9vIGVhcmx5IGJlZm9yZQoJCWlmICggJC5tb2JpbGUuaGlkZVVybEJhciApIHsKCQkJJHdpbmRvdy5sb2FkKCAkLm1vYmlsZS5zaWxlbnRTY3JvbGwgKTsKCQl9CgoJCWlmICggISQuc3VwcG9ydC5jc3NQb2ludGVyRXZlbnRzICkgewoJCQkvLyBJRSBhbmQgT3BlcmEgZG9uJ3Qgc3VwcG9ydCBDU1MgcG9pbnRlci1ldmVudHM6IG5vbmUgdGhhdCB3ZSB1c2UgdG8gZGlzYWJsZSBsaW5rLWJhc2VkIGJ1dHRvbnMKCQkJLy8gYnkgYWRkaW5nIHRoZSAndWktZGlzYWJsZWQnIGNsYXNzIHRvIHRoZW0uIFVzaW5nIGEgSmF2YVNjcmlwdCB3b3JrYXJvdW5kIGZvciB0aG9zZSBicm93c2VyLgoJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NTgKCgkJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgdWktZGlzYWJsZWQgYWZ0ZXIgMS40LjAgcmVsZWFzZQoJCQkvLyBvbmx5IHVpLXN0YXRlLWRpc2FibGVkIHNob3VsZCBiZSBwcmVzZW50IHRoZXJlYWZ0ZXIKCQkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktc3RhdGUtZGlzYWJsZWQsLnVpLWRpc2FibGVkIiwgInZjbGljayIsCgkJCQlmdW5jdGlvbiggZSApIHsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCX0KCQkJKTsKCQl9Cgl9KTsKfSggalF1ZXJ5LCB0aGlzICkpOwoKCn0pKTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 06:49:25 GMT",
                    "Content-Length": "446130",
                    "Date": "Fri, 07 Nov 2014 06:49:26 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}