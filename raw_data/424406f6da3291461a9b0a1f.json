{
    "url": "http://localhost:9999/ariya/esprima/test/3rdparty/mootools-1.4.5.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>document.location.pathname</b> and written to <b>the 'open()' function of an XMLHttpRequest object</b> via the following statements:<ul><li>url = document.location.pathname;</li><li>url = url.substr(0, trimPosition);</li><li>xhr.open(method.toUpperCase(), url, this.options.async, this.options.user, this.options.password);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/ariya/esprima/test/3rdparty/mootools-1.4.5.js",
                "path": "/ariya/esprima/test/3rdparty/mootools-1.4.5.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9hcml5YS9lc3ByaW1hL3Rlc3QvM3JkcGFydHkvbW9vdG9vbHMtMS40LjUuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTYwNDk1DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDIzOjI0OjU0IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAyMzoyNDo1MyBHTVQNCg0KLyoKLS0tCk1vb1Rvb2xzOiB0aGUgamF2YXNjcmlwdCBmcmFtZXdvcmsKCndlYiBidWlsZDoKIC0gaHR0cDovL21vb3Rvb2xzLm5ldC9jb3JlLzc2YmY0NzA2MmQ2YzE5ODNkNjZjZTQ3YWQ2NmFhMGUwCgpwYWNrYWdlciBidWlsZDoKIC0gcGFja2FnZXIgYnVpbGQgQ29yZS9Db3JlIENvcmUvQXJyYXkgQ29yZS9TdHJpbmcgQ29yZS9OdW1iZXIgQ29yZS9GdW5jdGlvbiBDb3JlL09iamVjdCBDb3JlL0V2ZW50IENvcmUvQnJvd3NlciBDb3JlL0NsYXNzIENvcmUvQ2xhc3MuRXh0cmFzIENvcmUvU2xpY2suUGFyc2VyIENvcmUvU2xpY2suRmluZGVyIENvcmUvRWxlbWVudCBDb3JlL0VsZW1lbnQuU3R5bGUgQ29yZS9FbGVtZW50LkV2ZW50IENvcmUvRWxlbWVudC5EZWxlZ2F0aW9uIENvcmUvRWxlbWVudC5EaW1lbnNpb25zIENvcmUvRnggQ29yZS9GeC5DU1MgQ29yZS9GeC5Ud2VlbiBDb3JlL0Z4Lk1vcnBoIENvcmUvRnguVHJhbnNpdGlvbnMgQ29yZS9SZXF1ZXN0IENvcmUvUmVxdWVzdC5IVE1MIENvcmUvUmVxdWVzdC5KU09OIENvcmUvQ29va2llIENvcmUvSlNPTiBDb3JlL0RPTVJlYWR5IENvcmUvU3dpZmYKCi4uLgoqLwoKLyoKLS0tCgpuYW1lOiBDb3JlCgpkZXNjcmlwdGlvbjogVGhlIGhlYXJ0IG9mIE1vb1Rvb2xzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjb3B5cmlnaHQ6IENvcHlyaWdodCAoYykgMjAwNi0yMDEyIFtWYWxlcmlvIFByb2lldHRpXShodHRwOi8vbWFkNG1pbGsubmV0LykuCgphdXRob3JzOiBUaGUgTW9vVG9vbHMgcHJvZHVjdGlvbiB0ZWFtIChodHRwOi8vbW9vdG9vbHMubmV0L2RldmVsb3BlcnMvKQoKaW5zcGlyYXRpb246CiAgLSBDbGFzcyBpbXBsZW1lbnRhdGlvbiBpbnNwaXJlZCBieSBbQmFzZS5qc10oaHR0cDovL2RlYW4uZWR3YXJkcy5uYW1lL3dlYmxvZy8yMDA2LzAzL2Jhc2UvKSBDb3B5cmlnaHQgKGMpIDIwMDYgRGVhbiBFZHdhcmRzLCBbR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXShodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbGdwbC1saWNlbnNlLnBocCkKICAtIFNvbWUgZnVuY3Rpb25hbGl0eSBpbnNwaXJlZCBieSBbUHJvdG90eXBlLmpzXShodHRwOi8vcHJvdG90eXBlanMub3JnKSBDb3B5cmlnaHQgKGMpIDIwMDUtMjAwNyBTYW0gU3RlcGhlbnNvbiwgW01JVCBMaWNlbnNlXShodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoKcHJvdmlkZXM6IFtDb3JlLCBNb29Ub29scywgVHlwZSwgdHlwZU9mLCBpbnN0YW5jZU9mLCBOYXRpdmVdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdGhpcy5Nb29Ub29scyA9IHsKCXZlcnNpb246ICcxLjQuNScsCglidWlsZDogJ2FiOGVhODgyNGRjM2IyNGI2NjY2ODY3YTJjNGVkNThlYmI3NjJjZjAnCn07CgovLyB0eXBlT2YsIGluc3RhbmNlT2YKCnZhciB0eXBlT2YgPSB0aGlzLnR5cGVPZiA9IGZ1bmN0aW9uKGl0ZW0pewoJaWYgKGl0ZW0gPT0gbnVsbCkgcmV0dXJuICdudWxsJzsKCWlmIChpdGVtLiRmYW1pbHkgIT0gbnVsbCkgcmV0dXJuIGl0ZW0uJGZhbWlseSgpOwoKCWlmIChpdGVtLm5vZGVOYW1lKXsKCQlpZiAoaXRlbS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gJ2VsZW1lbnQnOwoJCWlmIChpdGVtLm5vZGVUeXBlID09IDMpIHJldHVybiAoL1xTLykudGVzdChpdGVtLm5vZGVWYWx1ZSkgPyAndGV4dG5vZGUnIDogJ3doaXRlc3BhY2UnOwoJfSBlbHNlIGlmICh0eXBlb2YgaXRlbS5sZW5ndGggPT0gJ251bWJlcicpewoJCWlmIChpdGVtLmNhbGxlZSkgcmV0dXJuICdhcmd1bWVudHMnOwoJCWlmICgnaXRlbScgaW4gaXRlbSkgcmV0dXJuICdjb2xsZWN0aW9uJzsKCX0KCglyZXR1cm4gdHlwZW9mIGl0ZW07Cn07Cgp2YXIgaW5zdGFuY2VPZiA9IHRoaXMuaW5zdGFuY2VPZiA9IGZ1bmN0aW9uKGl0ZW0sIG9iamVjdCl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gZmFsc2U7Cgl2YXIgY29uc3RydWN0b3IgPSBpdGVtLiRjb25zdHJ1Y3RvciB8fCBpdGVtLmNvbnN0cnVjdG9yOwoJd2hpbGUgKGNvbnN0cnVjdG9yKXsKCQlpZiAoY29uc3RydWN0b3IgPT09IG9iamVjdCkgcmV0dXJuIHRydWU7CgkJY29uc3RydWN0b3IgPSBjb25zdHJ1Y3Rvci5wYXJlbnQ7Cgl9CgkvKjxsdElFOD4qLwoJaWYgKCFpdGVtLmhhc093blByb3BlcnR5KSByZXR1cm4gZmFsc2U7CgkvKjwvbHRJRTg+Ki8KCXJldHVybiBpdGVtIGluc3RhbmNlb2Ygb2JqZWN0Owp9OwoKLy8gRnVuY3Rpb24gb3ZlcmxvYWRpbmcKCnZhciBGdW5jdGlvbiA9IHRoaXMuRnVuY3Rpb247Cgp2YXIgZW51bWVyYWJsZXMgPSB0cnVlOwpmb3IgKHZhciBpIGluIHt0b1N0cmluZzogMX0pIGVudW1lcmFibGVzID0gbnVsbDsKaWYgKGVudW1lcmFibGVzKSBlbnVtZXJhYmxlcyA9IFsnaGFzT3duUHJvcGVydHknLCAndmFsdWVPZicsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvU3RyaW5nJywgJ2NvbnN0cnVjdG9yJ107CgpGdW5jdGlvbi5wcm90b3R5cGUub3ZlcmxvYWRTZXR0ZXIgPSBmdW5jdGlvbih1c2VQbHVyYWwpewoJdmFyIHNlbGYgPSB0aGlzOwoJcmV0dXJuIGZ1bmN0aW9uKGEsIGIpewoJCWlmIChhID09IG51bGwpIHJldHVybiB0aGlzOwoJCWlmICh1c2VQbHVyYWwgfHwgdHlwZW9mIGEgIT0gJ3N0cmluZycpewoJCQlmb3IgKHZhciBrIGluIGEpIHNlbGYuY2FsbCh0aGlzLCBrLCBhW2tdKTsKCQkJaWYgKGVudW1lcmFibGVzKSBmb3IgKHZhciBpID0gZW51bWVyYWJsZXMubGVuZ3RoOyBpLS07KXsKCQkJCWsgPSBlbnVtZXJhYmxlc1tpXTsKCQkJCWlmIChhLmhhc093blByb3BlcnR5KGspKSBzZWxmLmNhbGwodGhpcywgaywgYVtrXSk7CgkJCX0KCQl9IGVsc2UgewoJCQlzZWxmLmNhbGwodGhpcywgYSwgYik7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKfTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5vdmVybG9hZEdldHRlciA9IGZ1bmN0aW9uKHVzZVBsdXJhbCl7Cgl2YXIgc2VsZiA9IHRoaXM7CglyZXR1cm4gZnVuY3Rpb24oYSl7CgkJdmFyIGFyZ3MsIHJlc3VsdDsKCQlpZiAodHlwZW9mIGEgIT0gJ3N0cmluZycpIGFyZ3MgPSBhOwoJCWVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSBhcmdzID0gYXJndW1lbnRzOwoJCWVsc2UgaWYgKHVzZVBsdXJhbCkgYXJncyA9IFthXTsKCQlpZiAoYXJncyl7CgkJCXJlc3VsdCA9IHt9OwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHJlc3VsdFthcmdzW2ldXSA9IHNlbGYuY2FsbCh0aGlzLCBhcmdzW2ldKTsKCQl9IGVsc2UgewoJCQlyZXN1bHQgPSBzZWxmLmNhbGwodGhpcywgYSk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9Owp9OwoKRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJdGhpc1trZXldID0gdmFsdWU7Cn0ub3ZlcmxvYWRTZXR0ZXIoKTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKCXRoaXMucHJvdG90eXBlW2tleV0gPSB2YWx1ZTsKfS5vdmVybG9hZFNldHRlcigpOwoKLy8gRnJvbQoKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKRnVuY3Rpb24uZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuICh0eXBlT2YoaXRlbSkgPT0gJ2Z1bmN0aW9uJykgPyBpdGVtIDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gaXRlbTsKCX07Cn07CgpBcnJheS5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gW107CglyZXR1cm4gKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pICYmIHR5cGVvZiBpdGVtICE9ICdzdHJpbmcnKSA/ICh0eXBlT2YoaXRlbSkgPT0gJ2FycmF5JykgPyBpdGVtIDogc2xpY2UuY2FsbChpdGVtKSA6IFtpdGVtXTsKfTsKCk51bWJlci5mcm9tID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgbnVtYmVyID0gcGFyc2VGbG9hdChpdGVtKTsKCXJldHVybiBpc0Zpbml0ZShudW1iZXIpID8gbnVtYmVyIDogbnVsbDsKfTsKClN0cmluZy5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaXRlbSArICcnOwp9OwoKLy8gaGlkZSwgcHJvdGVjdAoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCgloaWRlOiBmdW5jdGlvbigpewoJCXRoaXMuJGhpZGRlbiA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByb3RlY3Q6IGZ1bmN0aW9uKCl7CgkJdGhpcy4kcHJvdGVjdGVkID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gVHlwZQoKdmFyIFR5cGUgPSB0aGlzLlR5cGUgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QpewoJaWYgKG5hbWUpewoJCXZhciBsb3dlciA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQl2YXIgdHlwZUNoZWNrID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiAodHlwZU9mKGl0ZW0pID09IGxvd2VyKTsKCQl9OwoKCQlUeXBlWydpcycgKyBuYW1lXSA9IHR5cGVDaGVjazsKCQlpZiAob2JqZWN0ICE9IG51bGwpewoJCQlvYmplY3QucHJvdG90eXBlLiRmYW1pbHkgPSAoZnVuY3Rpb24oKXsKCQkJCXJldHVybiBsb3dlcjsKCQkJfSkuaGlkZSgpOwoJCQkvLzwxLjJjb21wYXQ+CgkJCW9iamVjdC50eXBlID0gdHlwZUNoZWNrOwoJCQkvLzwvMS4yY29tcGF0PgoJCX0KCX0KCglpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwoKCW9iamVjdC5leHRlbmQodGhpcyk7CglvYmplY3QuJGNvbnN0cnVjdG9yID0gVHlwZTsKCW9iamVjdC5wcm90b3R5cGUuJGNvbnN0cnVjdG9yID0gb2JqZWN0OwoKCXJldHVybiBvYmplY3Q7Cn07Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKVHlwZS5pc0VudW1lcmFibGUgPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiAoaXRlbSAhPSBudWxsICYmIHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyAmJiB0b1N0cmluZy5jYWxsKGl0ZW0pICE9ICdbb2JqZWN0IEZ1bmN0aW9uXScgKTsKfTsKCnZhciBob29rcyA9IHt9OwoKdmFyIGhvb2tzT2YgPSBmdW5jdGlvbihvYmplY3QpewoJdmFyIHR5cGUgPSB0eXBlT2Yob2JqZWN0LnByb3RvdHlwZSk7CglyZXR1cm4gaG9va3NbdHlwZV0gfHwgKGhvb2tzW3R5cGVdID0gW10pOwp9OwoKdmFyIGltcGxlbWVudCA9IGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7CglpZiAobWV0aG9kICYmIG1ldGhvZC4kaGlkZGVuKSByZXR1cm47CgoJdmFyIGhvb2tzID0gaG9va3NPZih0aGlzKTsKCglmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgaSsrKXsKCQl2YXIgaG9vayA9IGhvb2tzW2ldOwoJCWlmICh0eXBlT2YoaG9vaykgPT0gJ3R5cGUnKSBpbXBsZW1lbnQuY2FsbChob29rLCBuYW1lLCBtZXRob2QpOwoJCWVsc2UgaG9vay5jYWxsKHRoaXMsIG5hbWUsIG1ldGhvZCk7Cgl9CgoJdmFyIHByZXZpb3VzID0gdGhpcy5wcm90b3R5cGVbbmFtZV07CglpZiAocHJldmlvdXMgPT0gbnVsbCB8fCAhcHJldmlvdXMuJHByb3RlY3RlZCkgdGhpcy5wcm90b3R5cGVbbmFtZV0gPSBtZXRob2Q7CgoJaWYgKHRoaXNbbmFtZV0gPT0gbnVsbCAmJiB0eXBlT2YobWV0aG9kKSA9PSAnZnVuY3Rpb24nKSBleHRlbmQuY2FsbCh0aGlzLCBuYW1lLCBmdW5jdGlvbihpdGVtKXsKCQlyZXR1cm4gbWV0aG9kLmFwcGx5KGl0ZW0sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7Cgl9KTsKfTsKCnZhciBleHRlbmQgPSBmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJaWYgKG1ldGhvZCAmJiBtZXRob2QuJGhpZGRlbikgcmV0dXJuOwoJdmFyIHByZXZpb3VzID0gdGhpc1tuYW1lXTsKCWlmIChwcmV2aW91cyA9PSBudWxsIHx8ICFwcmV2aW91cy4kcHJvdGVjdGVkKSB0aGlzW25hbWVdID0gbWV0aG9kOwp9OwoKVHlwZS5pbXBsZW1lbnQoewoKCWltcGxlbWVudDogaW1wbGVtZW50Lm92ZXJsb2FkU2V0dGVyKCksCgoJZXh0ZW5kOiBleHRlbmQub3ZlcmxvYWRTZXR0ZXIoKSwKCglhbGlhczogZnVuY3Rpb24obmFtZSwgZXhpc3RpbmcpewoJCWltcGxlbWVudC5jYWxsKHRoaXMsIG5hbWUsIHRoaXMucHJvdG90eXBlW2V4aXN0aW5nXSk7Cgl9Lm92ZXJsb2FkU2V0dGVyKCksCgoJbWlycm9yOiBmdW5jdGlvbihob29rKXsKCQlob29rc09mKHRoaXMpLnB1c2goaG9vayk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCm5ldyBUeXBlKCdUeXBlJywgVHlwZSk7CgovLyBEZWZhdWx0IFR5cGVzCgp2YXIgZm9yY2UgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QsIG1ldGhvZHMpewoJdmFyIGlzVHlwZSA9IChvYmplY3QgIT0gT2JqZWN0KSwKCQlwcm90b3R5cGUgPSBvYmplY3QucHJvdG90eXBlOwoKCWlmIChpc1R5cGUpIG9iamVjdCA9IG5ldyBUeXBlKG5hbWUsIG9iamVjdCk7CgoJZm9yICh2YXIgaSA9IDAsIGwgPSBtZXRob2RzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJdmFyIGtleSA9IG1ldGhvZHNbaV0sCgkJCWdlbmVyaWMgPSBvYmplY3Rba2V5XSwKCQkJcHJvdG8gPSBwcm90b3R5cGVba2V5XTsKCgkJaWYgKGdlbmVyaWMpIGdlbmVyaWMucHJvdGVjdCgpOwoJCWlmIChpc1R5cGUgJiYgcHJvdG8pIG9iamVjdC5pbXBsZW1lbnQoa2V5LCBwcm90by5wcm90ZWN0KCkpOwoJfQoKCWlmIChpc1R5cGUpewoJCXZhciBtZXRob2RzRW51bWVyYWJsZSA9IHByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZShtZXRob2RzWzBdKTsKCQlvYmplY3QuZm9yRWFjaE1ldGhvZCA9IGZ1bmN0aW9uKGZuKXsKCQkJaWYgKCFtZXRob2RzRW51bWVyYWJsZSkgZm9yICh2YXIgaSA9IDAsIGwgPSBtZXRob2RzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCQlmbi5jYWxsKHByb3RvdHlwZSwgcHJvdG90eXBlW21ldGhvZHNbaV1dLCBtZXRob2RzW2ldKTsKCQkJfQoJCQlmb3IgKHZhciBrZXkgaW4gcHJvdG90eXBlKSBmbi5jYWxsKHByb3RvdHlwZSwgcHJvdG90eXBlW2tleV0sIGtleSkKCQl9OwoJfQoKCXJldHVybiBmb3JjZTsKfTsKCmZvcmNlKCdTdHJpbmcnLCBTdHJpbmcsIFsKCSdjaGFyQXQnLCAnY2hhckNvZGVBdCcsICdjb25jYXQnLCAnaW5kZXhPZicsICdsYXN0SW5kZXhPZicsICdtYXRjaCcsICdxdW90ZScsICdyZXBsYWNlJywgJ3NlYXJjaCcsCgknc2xpY2UnLCAnc3BsaXQnLCAnc3Vic3RyJywgJ3N1YnN0cmluZycsICd0cmltJywgJ3RvTG93ZXJDYXNlJywgJ3RvVXBwZXJDYXNlJwpdKSgnQXJyYXknLCBBcnJheSwgWwoJJ3BvcCcsICdwdXNoJywgJ3JldmVyc2UnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCcsICdjb25jYXQnLCAnam9pbicsICdzbGljZScsCgknaW5kZXhPZicsICdsYXN0SW5kZXhPZicsICdmaWx0ZXInLCAnZm9yRWFjaCcsICdldmVyeScsICdtYXAnLCAnc29tZScsICdyZWR1Y2UnLCAncmVkdWNlUmlnaHQnCl0pKCdOdW1iZXInLCBOdW1iZXIsIFsKCSd0b0V4cG9uZW50aWFsJywgJ3RvRml4ZWQnLCAndG9Mb2NhbGVTdHJpbmcnLCAndG9QcmVjaXNpb24nCl0pKCdGdW5jdGlvbicsIEZ1bmN0aW9uLCBbCgknYXBwbHknLCAnY2FsbCcsICdiaW5kJwpdKSgnUmVnRXhwJywgUmVnRXhwLCBbCgknZXhlYycsICd0ZXN0JwpdKSgnT2JqZWN0JywgT2JqZWN0LCBbCgknY3JlYXRlJywgJ2RlZmluZVByb3BlcnR5JywgJ2RlZmluZVByb3BlcnRpZXMnLCAna2V5cycsCgknZ2V0UHJvdG90eXBlT2YnLCAnZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yJywgJ2dldE93blByb3BlcnR5TmFtZXMnLAoJJ3ByZXZlbnRFeHRlbnNpb25zJywgJ2lzRXh0ZW5zaWJsZScsICdzZWFsJywgJ2lzU2VhbGVkJywgJ2ZyZWV6ZScsICdpc0Zyb3plbicKXSkoJ0RhdGUnLCBEYXRlLCBbJ25vdyddKTsKCk9iamVjdC5leHRlbmQgPSBleHRlbmQub3ZlcmxvYWRTZXR0ZXIoKTsKCkRhdGUuZXh0ZW5kKCdub3cnLCBmdW5jdGlvbigpewoJcmV0dXJuICsobmV3IERhdGUpOwp9KTsKCm5ldyBUeXBlKCdCb29sZWFuJywgQm9vbGVhbik7CgovLyBmaXhlcyBOYU4gcmV0dXJuaW5nIGFzIE51bWJlcgoKTnVtYmVyLnByb3RvdHlwZS4kZmFtaWx5ID0gZnVuY3Rpb24oKXsKCXJldHVybiBpc0Zpbml0ZSh0aGlzKSA/ICdudW1iZXInIDogJ251bGwnOwp9LmhpZGUoKTsKCi8vIE51bWJlci5yYW5kb20KCk51bWJlci5leHRlbmQoJ3JhbmRvbScsIGZ1bmN0aW9uKG1pbiwgbWF4KXsKCXJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkgKyBtaW4pOwp9KTsKCi8vIGZvckVhY2gsIGVhY2gKCnZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7Ck9iamVjdC5leHRlbmQoJ2ZvckVhY2gnLCBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5LCBvYmplY3QpOwoJfQp9KTsKCk9iamVjdC5lYWNoID0gT2JqZWN0LmZvckVhY2g7CgpBcnJheS5pbXBsZW1lbnQoewoKCWZvckVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKGkgaW4gdGhpcykgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9Cgl9LAoKCWVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlBcnJheS5mb3JFYWNoKHRoaXMsIGZuLCBiaW5kKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gQXJyYXkgJiBPYmplY3QgY2xvbmluZywgT2JqZWN0IG1lcmdpbmcgYW5kIGFwcGVuZGluZwoKdmFyIGNsb25lT2YgPSBmdW5jdGlvbihpdGVtKXsKCXN3aXRjaCAodHlwZU9mKGl0ZW0pKXsKCQljYXNlICdhcnJheSc6IHJldHVybiBpdGVtLmNsb25lKCk7CgkJY2FzZSAnb2JqZWN0JzogcmV0dXJuIE9iamVjdC5jbG9uZShpdGVtKTsKCQlkZWZhdWx0OiByZXR1cm4gaXRlbTsKCX0KfTsKCkFycmF5LmltcGxlbWVudCgnY2xvbmUnLCBmdW5jdGlvbigpewoJdmFyIGkgPSB0aGlzLmxlbmd0aCwgY2xvbmUgPSBuZXcgQXJyYXkoaSk7Cgl3aGlsZSAoaS0tKSBjbG9uZVtpXSA9IGNsb25lT2YodGhpc1tpXSk7CglyZXR1cm4gY2xvbmU7Cn0pOwoKdmFyIG1lcmdlT25lID0gZnVuY3Rpb24oc291cmNlLCBrZXksIGN1cnJlbnQpewoJc3dpdGNoICh0eXBlT2YoY3VycmVudCkpewoJCWNhc2UgJ29iamVjdCc6CgkJCWlmICh0eXBlT2Yoc291cmNlW2tleV0pID09ICdvYmplY3QnKSBPYmplY3QubWVyZ2Uoc291cmNlW2tleV0sIGN1cnJlbnQpOwoJCQllbHNlIHNvdXJjZVtrZXldID0gT2JqZWN0LmNsb25lKGN1cnJlbnQpOwoJCWJyZWFrOwoJCWNhc2UgJ2FycmF5Jzogc291cmNlW2tleV0gPSBjdXJyZW50LmNsb25lKCk7IGJyZWFrOwoJCWRlZmF1bHQ6IHNvdXJjZVtrZXldID0gY3VycmVudDsKCX0KCXJldHVybiBzb3VyY2U7Cn07CgpPYmplY3QuZXh0ZW5kKHsKCgltZXJnZTogZnVuY3Rpb24oc291cmNlLCBrLCB2KXsKCQlpZiAodHlwZU9mKGspID09ICdzdHJpbmcnKSByZXR1cm4gbWVyZ2VPbmUoc291cmNlLCBrLCB2KTsKCQlmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgb2JqZWN0ID0gYXJndW1lbnRzW2ldOwoJCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBtZXJnZU9uZShzb3VyY2UsIGtleSwgb2JqZWN0W2tleV0pOwoJCX0KCQlyZXR1cm4gc291cmNlOwoJfSwKCgljbG9uZTogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgY2xvbmUgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBjbG9uZVtrZXldID0gY2xvbmVPZihvYmplY3Rba2V5XSk7CgkJcmV0dXJuIGNsb25lOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKG9yaWdpbmFsKXsKCQlmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgZXh0ZW5kZWQgPSBhcmd1bWVudHNbaV0gfHwge307CgkJCWZvciAodmFyIGtleSBpbiBleHRlbmRlZCkgb3JpZ2luYWxba2V5XSA9IGV4dGVuZGVkW2tleV07CgkJfQoJCXJldHVybiBvcmlnaW5hbDsKCX0KCn0pOwoKLy8gT2JqZWN0LWxlc3MgdHlwZXMKClsnT2JqZWN0JywgJ1doaXRlU3BhY2UnLCAnVGV4dE5vZGUnLCAnQ29sbGVjdGlvbicsICdBcmd1bWVudHMnXS5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJbmV3IFR5cGUobmFtZSk7Cn0pOwoKLy8gVW5pcXVlIElECgp2YXIgVUlEID0gRGF0ZS5ub3coKTsKClN0cmluZy5leHRlbmQoJ3VuaXF1ZUlEJywgZnVuY3Rpb24oKXsKCXJldHVybiAoVUlEKyspLnRvU3RyaW5nKDM2KTsKfSk7CgovLzwxLjJjb21wYXQ+Cgp2YXIgSGFzaCA9IHRoaXMuSGFzaCA9IG5ldyBUeXBlKCdIYXNoJywgZnVuY3Rpb24ob2JqZWN0KXsKCWlmICh0eXBlT2Yob2JqZWN0KSA9PSAnaGFzaCcpIG9iamVjdCA9IE9iamVjdC5jbG9uZShvYmplY3QuZ2V0Q2xlYW4oKSk7Cglmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB0aGlzW2tleV0gPSBvYmplY3Rba2V5XTsKCXJldHVybiB0aGlzOwp9KTsKCkhhc2guaW1wbGVtZW50KHsKCglmb3JFYWNoOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJT2JqZWN0LmZvckVhY2godGhpcywgZm4sIGJpbmQpOwoJfSwKCglnZXRDbGVhbjogZnVuY3Rpb24oKXsKCQl2YXIgY2xlYW4gPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gdGhpcyl7CgkJCWlmICh0aGlzLmhhc093blByb3BlcnR5KGtleSkpIGNsZWFuW2tleV0gPSB0aGlzW2tleV07CgkJfQoJCXJldHVybiBjbGVhbjsKCX0sCgoJZ2V0TGVuZ3RoOiBmdW5jdGlvbigpewoJCXZhciBsZW5ndGggPSAwOwoJCWZvciAodmFyIGtleSBpbiB0aGlzKXsKCQkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgbGVuZ3RoKys7CgkJfQoJCXJldHVybiBsZW5ndGg7Cgl9Cgp9KTsKCkhhc2guYWxpYXMoJ2VhY2gnLCAnZm9yRWFjaCcpOwoKT2JqZWN0LnR5cGUgPSBUeXBlLmlzT2JqZWN0OwoKdmFyIE5hdGl2ZSA9IHRoaXMuTmF0aXZlID0gZnVuY3Rpb24ocHJvcGVydGllcyl7CglyZXR1cm4gbmV3IFR5cGUocHJvcGVydGllcy5uYW1lLCBwcm9wZXJ0aWVzLmluaXRpYWxpemUpOwp9OwoKTmF0aXZlLnR5cGUgPSBUeXBlLnR5cGU7CgpOYXRpdmUuaW1wbGVtZW50ID0gZnVuY3Rpb24ob2JqZWN0cywgbWV0aG9kcyl7Cglmb3IgKHZhciBpID0gMDsgaSA8IG9iamVjdHMubGVuZ3RoOyBpKyspIG9iamVjdHNbaV0uaW1wbGVtZW50KG1ldGhvZHMpOwoJcmV0dXJuIE5hdGl2ZTsKfTsKCnZhciBhcnJheVR5cGUgPSBBcnJheS50eXBlOwpBcnJheS50eXBlID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaW5zdGFuY2VPZihpdGVtLCBBcnJheSkgfHwgYXJyYXlUeXBlKGl0ZW0pOwp9OwoKdGhpcy4kQSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuIEFycmF5LmZyb20oaXRlbSkuc2xpY2UoKTsKfTsKCnRoaXMuJGFyZ3VtZW50cyA9IGZ1bmN0aW9uKGkpewoJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJcmV0dXJuIGFyZ3VtZW50c1tpXTsKCX07Cn07Cgp0aGlzLiRjaGsgPSBmdW5jdGlvbihvYmopewoJcmV0dXJuICEhKG9iaiB8fCBvYmogPT09IDApOwp9OwoKdGhpcy4kY2xlYXIgPSBmdW5jdGlvbih0aW1lcil7CgljbGVhclRpbWVvdXQodGltZXIpOwoJY2xlYXJJbnRlcnZhbCh0aW1lcik7CglyZXR1cm4gbnVsbDsKfTsKCnRoaXMuJGRlZmluZWQgPSBmdW5jdGlvbihvYmopewoJcmV0dXJuIChvYmogIT0gbnVsbCk7Cn07Cgp0aGlzLiRlYWNoID0gZnVuY3Rpb24oaXRlcmFibGUsIGZuLCBiaW5kKXsKCXZhciB0eXBlID0gdHlwZU9mKGl0ZXJhYmxlKTsKCSgodHlwZSA9PSAnYXJndW1lbnRzJyB8fCB0eXBlID09ICdjb2xsZWN0aW9uJyB8fCB0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnZWxlbWVudHMnKSA/IEFycmF5IDogT2JqZWN0KS5lYWNoKGl0ZXJhYmxlLCBmbiwgYmluZCk7Cn07Cgp0aGlzLiRlbXB0eSA9IGZ1bmN0aW9uKCl7fTsKCnRoaXMuJGV4dGVuZCA9IGZ1bmN0aW9uKG9yaWdpbmFsLCBleHRlbmRlZCl7CglyZXR1cm4gT2JqZWN0LmFwcGVuZChvcmlnaW5hbCwgZXh0ZW5kZWQpOwp9OwoKdGhpcy4kSCA9IGZ1bmN0aW9uKG9iamVjdCl7CglyZXR1cm4gbmV3IEhhc2gob2JqZWN0KTsKfTsKCnRoaXMuJG1lcmdlID0gZnVuY3Rpb24oKXsKCXZhciBhcmdzID0gQXJyYXkuc2xpY2UoYXJndW1lbnRzKTsKCWFyZ3MudW5zaGlmdCh7fSk7CglyZXR1cm4gT2JqZWN0Lm1lcmdlLmFwcGx5KG51bGwsIGFyZ3MpOwp9OwoKdGhpcy4kbGFtYmRhID0gRnVuY3Rpb24uZnJvbTsKdGhpcy4kbWl4aW4gPSBPYmplY3QubWVyZ2U7CnRoaXMuJHJhbmRvbSA9IE51bWJlci5yYW5kb207CnRoaXMuJHNwbGF0ID0gQXJyYXkuZnJvbTsKdGhpcy4kdGltZSA9IERhdGUubm93OwoKdGhpcy4kdHlwZSA9IGZ1bmN0aW9uKG9iamVjdCl7Cgl2YXIgdHlwZSA9IHR5cGVPZihvYmplY3QpOwoJaWYgKHR5cGUgPT0gJ2VsZW1lbnRzJykgcmV0dXJuICdhcnJheSc7CglyZXR1cm4gKHR5cGUgPT0gJ251bGwnKSA/IGZhbHNlIDogdHlwZTsKfTsKCnRoaXMuJHVubGluayA9IGZ1bmN0aW9uKG9iamVjdCl7Cglzd2l0Y2ggKHR5cGVPZihvYmplY3QpKXsKCQljYXNlICdvYmplY3QnOiByZXR1cm4gT2JqZWN0LmNsb25lKG9iamVjdCk7CgkJY2FzZSAnYXJyYXknOiByZXR1cm4gQXJyYXkuY2xvbmUob2JqZWN0KTsKCQljYXNlICdoYXNoJzogcmV0dXJuIG5ldyBIYXNoKG9iamVjdCk7CgkJZGVmYXVsdDogcmV0dXJuIG9iamVjdDsKCX0KfTsKCi8vPC8xLjJjb21wYXQ+Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogQXJyYXkKCmRlc2NyaXB0aW9uOiBDb250YWlucyBBcnJheSBQcm90b3R5cGVzIGxpa2UgZWFjaCwgY29udGFpbnMsIGFuZCBlcmFzZS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBBcnJheQoKLi4uCiovCgpBcnJheS5pbXBsZW1lbnQoewoKCS8qPCFFUzU+Ki8KCWV2ZXJ5OiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCA+Pj4gMDsgaSA8IGw7IGkrKyl7CgkJCWlmICgoaSBpbiB0aGlzKSAmJiAhZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJZmlsdGVyOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSBbXTsKCQlmb3IgKHZhciB2YWx1ZSwgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCA+Pj4gMDsgaSA8IGw7IGkrKykgaWYgKGkgaW4gdGhpcyl7CgkJCXZhbHVlID0gdGhpc1tpXTsKCQkJaWYgKGZuLmNhbGwoYmluZCwgdmFsdWUsIGksIHRoaXMpKSByZXN1bHRzLnB1c2godmFsdWUpOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJaW5kZXhPZjogZnVuY3Rpb24oaXRlbSwgZnJvbSl7CgkJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoID4+PiAwOwoJCWZvciAodmFyIGkgPSAoZnJvbSA8IDApID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgZnJvbSkgOiBmcm9tIHx8IDA7IGkgPCBsZW5ndGg7IGkrKyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSByZXR1cm4gaTsKCQl9CgkJcmV0dXJuIC0xOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGggPj4+IDAsIHJlc3VsdHMgPSBBcnJheShsZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSByZXN1bHRzW2ldID0gZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoID4+PiAwOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiB0cnVlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoJLyo8LyFFUzU+Ki8KCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtICE9IG51bGw7CgkJfSk7Cgl9LAoKCWludm9rZTogZnVuY3Rpb24obWV0aG9kTmFtZSl7CgkJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpOwoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW1bbWV0aG9kTmFtZV0uYXBwbHkoaXRlbSwgYXJncyk7CgkJfSk7Cgl9LAoKCWFzc29jaWF0ZTogZnVuY3Rpb24oa2V5cyl7CgkJdmFyIG9iaiA9IHt9LCBsZW5ndGggPSBNYXRoLm1pbih0aGlzLmxlbmd0aCwga2V5cy5sZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIG9ialtrZXlzW2ldXSA9IHRoaXNbaV07CgkJcmV0dXJuIG9iajsKCX0sCgoJbGluazogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgcmVzdWx0ID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQkJaWYgKG9iamVjdFtrZXldKHRoaXNbaV0pKXsKCQkJCQlyZXN1bHRba2V5XSA9IHRoaXNbaV07CgkJCQkJZGVsZXRlIG9iamVjdFtrZXldOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQlyZXR1cm4gdGhpcy5pbmRleE9mKGl0ZW0sIGZyb20pICE9IC0xOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGFycmF5KXsKCQl0aGlzLnB1c2guYXBwbHkodGhpcywgYXJyYXkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1t0aGlzLmxlbmd0aCAtIDFdIDogbnVsbDsKCX0sCgoJZ2V0UmFuZG9tOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1tOdW1iZXIucmFuZG9tKDAsIHRoaXMubGVuZ3RoIC0gMSldIDogbnVsbDsKCX0sCgoJaW5jbHVkZTogZnVuY3Rpb24oaXRlbSl7CgkJaWYgKCF0aGlzLmNvbnRhaW5zKGl0ZW0pKSB0aGlzLnB1c2goaXRlbSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNvbWJpbmU6IGZ1bmN0aW9uKGFycmF5KXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5pbmNsdWRlKGFycmF5W2ldKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGl0ZW0pewoJCWZvciAodmFyIGkgPSB0aGlzLmxlbmd0aDsgaS0tOyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSB0aGlzLnNwbGljZShpLCAxKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXRoaXMubGVuZ3RoID0gMDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmxhdHRlbjogZnVuY3Rpb24oKXsKCQl2YXIgYXJyYXkgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIHR5cGUgPSB0eXBlT2YodGhpc1tpXSk7CgkJCWlmICh0eXBlID09ICdudWxsJykgY29udGludWU7CgkJCWFycmF5ID0gYXJyYXkuY29uY2F0KCh0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnY29sbGVjdGlvbicgfHwgdHlwZSA9PSAnYXJndW1lbnRzJyB8fCBpbnN0YW5jZU9mKHRoaXNbaV0sIEFycmF5KSkgPyBBcnJheS5mbGF0dGVuKHRoaXNbaV0pIDogdGhpc1tpXSk7CgkJfQoJCXJldHVybiBhcnJheTsKCX0sCgoJcGljazogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gIT0gbnVsbCkgcmV0dXJuIHRoaXNbaV07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCAhPSAzKSByZXR1cm4gbnVsbDsKCQl2YXIgcmdiID0gdGhpcy5tYXAoZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubGVuZ3RoID09IDEpIHZhbHVlICs9IHZhbHVlOwoJCQlyZXR1cm4gdmFsdWUudG9JbnQoMTYpOwoJCX0pOwoJCXJldHVybiAoYXJyYXkpID8gcmdiIDogJ3JnYignICsgcmdiICsgJyknOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCA8IDMpIHJldHVybiBudWxsOwoJCWlmICh0aGlzLmxlbmd0aCA9PSA0ICYmIHRoaXNbM10gPT0gMCAmJiAhYXJyYXkpIHJldHVybiAndHJhbnNwYXJlbnQnOwoJCXZhciBoZXggPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKyl7CgkJCXZhciBiaXQgPSAodGhpc1tpXSAtIDApLnRvU3RyaW5nKDE2KTsKCQkJaGV4LnB1c2goKGJpdC5sZW5ndGggPT0gMSkgPyAnMCcgKyBiaXQgOiBiaXQpOwoJCX0KCQlyZXR1cm4gKGFycmF5KSA/IGhleCA6ICcjJyArIGhleC5qb2luKCcnKTsKCX0KCn0pOwoKLy88MS4yY29tcGF0PgoKQXJyYXkuYWxpYXMoJ2V4dGVuZCcsICdhcHBlbmQnKTsKCnZhciAkcGljayA9IGZ1bmN0aW9uKCl7CglyZXR1cm4gQXJyYXkuZnJvbShhcmd1bWVudHMpLnBpY2soKTsKfTsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBTdHJpbmcKCmRlc2NyaXB0aW9uOiBDb250YWlucyBTdHJpbmcgUHJvdG90eXBlcyBsaWtlIGNhbWVsQ2FzZSwgY2FwaXRhbGl6ZSwgdGVzdCwgYW5kIHRvSW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IFN0cmluZwoKLi4uCiovCgpTdHJpbmcuaW1wbGVtZW50KHsKCgl0ZXN0OiBmdW5jdGlvbihyZWdleCwgcGFyYW1zKXsKCQlyZXR1cm4gKCh0eXBlT2YocmVnZXgpID09ICdyZWdleHAnKSA/IHJlZ2V4IDogbmV3IFJlZ0V4cCgnJyArIHJlZ2V4LCBwYXJhbXMpKS50ZXN0KHRoaXMpOwoJfSwKCgljb250YWluczogZnVuY3Rpb24oc3RyaW5nLCBzZXBhcmF0b3IpewoJCXJldHVybiAoc2VwYXJhdG9yKSA/IChzZXBhcmF0b3IgKyB0aGlzICsgc2VwYXJhdG9yKS5pbmRleE9mKHNlcGFyYXRvciArIHN0cmluZyArIHNlcGFyYXRvcikgPiAtMSA6IFN0cmluZyh0aGlzKS5pbmRleE9mKHN0cmluZykgPiAtMTsKCX0sCgoJdHJpbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7Cgl9LAoKCWNsZWFuOiBmdW5jdGlvbigpewoJCXJldHVybiBTdHJpbmcodGhpcykucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwoJfSwKCgljYW1lbENhc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIFN0cmluZyh0aGlzKS5yZXBsYWNlKC8tXEQvZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2guY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWh5cGhlbmF0ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuICgnLScgKyBtYXRjaC5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSk7CgkJfSk7Cgl9LAoKCWNhcGl0YWxpemU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIFN0cmluZyh0aGlzKS5yZXBsYWNlKC9cYlthLXpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWVzY2FwZVJlZ0V4cDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoLyhbLS4qKz9eJHt9KCl8W1xdXC9cXF0pL2csICdcXCQxJyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCWhleFRvUmdiOiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIGhleCA9IFN0cmluZyh0aGlzKS5tYXRjaCgvXiM/KFx3ezEsMn0pKFx3ezEsMn0pKFx3ezEsMn0pJC8pOwoJCXJldHVybiAoaGV4KSA/IGhleC5zbGljZSgxKS5oZXhUb1JnYihhcnJheSkgOiBudWxsOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCXZhciByZ2IgPSBTdHJpbmcodGhpcykubWF0Y2goL1xkezEsM30vZyk7CgkJcmV0dXJuIChyZ2IpID8gcmdiLnJnYlRvSGV4KGFycmF5KSA6IG51bGw7Cgl9LAoKCXN1YnN0aXR1dGU6IGZ1bmN0aW9uKG9iamVjdCwgcmVnZXhwKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UocmVnZXhwIHx8ICgvXFw/XHsoW157fV0rKVx9L2cpLCBmdW5jdGlvbihtYXRjaCwgbmFtZSl7CgkJCWlmIChtYXRjaC5jaGFyQXQoMCkgPT0gJ1xcJykgcmV0dXJuIG1hdGNoLnNsaWNlKDEpOwoJCQlyZXR1cm4gKG9iamVjdFtuYW1lXSAhPSBudWxsKSA/IG9iamVjdFtuYW1lXSA6ICcnOwoJCX0pOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBOdW1iZXIKCmRlc2NyaXB0aW9uOiBDb250YWlucyBOdW1iZXIgUHJvdG90eXBlcyBsaWtlIGxpbWl0LCByb3VuZCwgdGltZXMsIGFuZCBjZWlsLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IE51bWJlcgoKLi4uCiovCgpOdW1iZXIuaW1wbGVtZW50KHsKCglsaW1pdDogZnVuY3Rpb24obWluLCBtYXgpewoJCXJldHVybiBNYXRoLm1pbihtYXgsIE1hdGgubWF4KG1pbiwgdGhpcykpOwoJfSwKCglyb3VuZDogZnVuY3Rpb24ocHJlY2lzaW9uKXsKCQlwcmVjaXNpb24gPSBNYXRoLnBvdygxMCwgcHJlY2lzaW9uIHx8IDApLnRvRml4ZWQocHJlY2lzaW9uIDwgMCA/IC1wcmVjaXNpb24gOiAwKTsKCQlyZXR1cm4gTWF0aC5yb3VuZCh0aGlzICogcHJlY2lzaW9uKSAvIHByZWNpc2lvbjsKCX0sCgoJdGltZXM6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXM7IGkrKykgZm4uY2FsbChiaW5kLCBpLCB0aGlzKTsKCX0sCgoJdG9GbG9hdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gcGFyc2VGbG9hdCh0aGlzKTsKCX0sCgoJdG9JbnQ6IGZ1bmN0aW9uKGJhc2UpewoJCXJldHVybiBwYXJzZUludCh0aGlzLCBiYXNlIHx8IDEwKTsKCX0KCn0pOwoKTnVtYmVyLmFsaWFzKCdlYWNoJywgJ3RpbWVzJyk7CgooZnVuY3Rpb24obWF0aCl7Cgl2YXIgbWV0aG9kcyA9IHt9OwoJbWF0aC5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJCWlmICghTnVtYmVyW25hbWVdKSBtZXRob2RzW25hbWVdID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIE1hdGhbbmFtZV0uYXBwbHkobnVsbCwgW3RoaXNdLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQl9OwoJfSk7CglOdW1iZXIuaW1wbGVtZW50KG1ldGhvZHMpOwp9KShbJ2FicycsICdhY29zJywgJ2FzaW4nLCAnYXRhbicsICdhdGFuMicsICdjZWlsJywgJ2NvcycsICdleHAnLCAnZmxvb3InLCAnbG9nJywgJ21heCcsICdtaW4nLCAncG93JywgJ3NpbicsICdzcXJ0JywgJ3RhbiddKTsKCgovKgotLS0KCm5hbWU6IEZ1bmN0aW9uCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRnVuY3Rpb24gUHJvdG90eXBlcyBsaWtlIGNyZWF0ZSwgYmluZCwgcGFzcywgYW5kIGRlbGF5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEZ1bmN0aW9uCgouLi4KKi8KCkZ1bmN0aW9uLmV4dGVuZCh7CgoJYXR0ZW1wdDogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl0cnkgewoJCQkJcmV0dXJuIGFyZ3VtZW50c1tpXSgpOwoJCQl9IGNhdGNoIChlKXt9CgkJfQoJCXJldHVybiBudWxsOwoJfQoKfSk7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLmFwcGx5KGJpbmQsIEFycmF5LmZyb20oYXJncykpOwoJCX0gY2F0Y2ggKGUpe30KCgkJcmV0dXJuIG51bGw7Cgl9LAoKCS8qPCFFUzUtYmluZD4qLwoJYmluZDogZnVuY3Rpb24odGhhdCl7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbCwKCQkJRiA9IGZ1bmN0aW9uKCl7fTsKCgkJdmFyIGJvdW5kID0gZnVuY3Rpb24oKXsKCQkJdmFyIGNvbnRleHQgPSB0aGF0LCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwoJCQlpZiAodGhpcyBpbnN0YW5jZW9mIGJvdW5kKXsKCQkJCUYucHJvdG90eXBlID0gc2VsZi5wcm90b3R5cGU7CgkJCQljb250ZXh0ID0gbmV3IEY7CgkJCX0KCQkJdmFyIHJlc3VsdCA9ICghYXJncyAmJiAhbGVuZ3RoKQoJCQkJPyBzZWxmLmNhbGwoY29udGV4dCkKCQkJCTogc2VsZi5hcHBseShjb250ZXh0LCBhcmdzICYmIGxlbmd0aCA/IGFyZ3MuY29uY2F0KEFycmF5LnNsaWNlKGFyZ3VtZW50cykpIDogYXJncyB8fCBhcmd1bWVudHMpOwoJCQlyZXR1cm4gY29udGV4dCA9PSB0aGF0ID8gcmVzdWx0IDogY29udGV4dDsKCQl9OwoJCXJldHVybiBib3VuZDsKCX0sCgkvKjwvIUVTNS1iaW5kPiovCgoJcGFzczogZnVuY3Rpb24oYXJncywgYmluZCl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbigpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzIHx8IGFyZ3VtZW50cyk7CgkJfTsKCX0sCgoJZGVsYXk6IGZ1bmN0aW9uKGRlbGF5LCBiaW5kLCBhcmdzKXsKCQlyZXR1cm4gc2V0VGltZW91dCh0aGlzLnBhc3MoKGFyZ3MgPT0gbnVsbCA/IFtdIDogYXJncyksIGJpbmQpLCBkZWxheSk7Cgl9LAoKCXBlcmlvZGljYWw6IGZ1bmN0aW9uKHBlcmlvZGljYWwsIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRJbnRlcnZhbCh0aGlzLnBhc3MoKGFyZ3MgPT0gbnVsbCA/IFtdIDogYXJncyksIGJpbmQpLCBwZXJpb2RpY2FsKTsKCX0KCn0pOwoKLy88MS4yY29tcGF0PgoKZGVsZXRlIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kOwoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCgljcmVhdGU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXZhciBzZWxmID0gdGhpczsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlyZXR1cm4gZnVuY3Rpb24oZXZlbnQpewoJCQl2YXIgYXJncyA9IG9wdGlvbnMuYXJndW1lbnRzOwoJCQlhcmdzID0gKGFyZ3MgIT0gbnVsbCkgPyBBcnJheS5mcm9tKGFyZ3MpIDogQXJyYXkuc2xpY2UoYXJndW1lbnRzLCAob3B0aW9ucy5ldmVudCkgPyAxIDogMCk7CgkJCWlmIChvcHRpb25zLmV2ZW50KSBhcmdzID0gW2V2ZW50IHx8IHdpbmRvdy5ldmVudF0uZXh0ZW5kKGFyZ3MpOwoJCQl2YXIgcmV0dXJucyA9IGZ1bmN0aW9uKCl7CgkJCQlyZXR1cm4gc2VsZi5hcHBseShvcHRpb25zLmJpbmQgfHwgbnVsbCwgYXJncyk7CgkJCX07CgkJCWlmIChvcHRpb25zLmRlbGF5KSByZXR1cm4gc2V0VGltZW91dChyZXR1cm5zLCBvcHRpb25zLmRlbGF5KTsKCQkJaWYgKG9wdGlvbnMucGVyaW9kaWNhbCkgcmV0dXJuIHNldEludGVydmFsKHJldHVybnMsIG9wdGlvbnMucGVyaW9kaWNhbCk7CgkJCWlmIChvcHRpb25zLmF0dGVtcHQpIHJldHVybiBGdW5jdGlvbi5hdHRlbXB0KHJldHVybnMpOwoJCQlyZXR1cm4gcmV0dXJucygpOwoJCX07Cgl9LAoKCWJpbmQ6IGZ1bmN0aW9uKGJpbmQsIGFyZ3MpewoJCXZhciBzZWxmID0gdGhpczsKCQlpZiAoYXJncyAhPSBudWxsKSBhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncyB8fCBhcmd1bWVudHMpOwoJCX07Cgl9LAoKCWJpbmRXaXRoRXZlbnQ6IGZ1bmN0aW9uKGJpbmQsIGFyZ3MpewoJCXZhciBzZWxmID0gdGhpczsKCQlpZiAoYXJncyAhPSBudWxsKSBhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlyZXR1cm4gZnVuY3Rpb24oZXZlbnQpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCAoYXJncyA9PSBudWxsKSA/IGFyZ3VtZW50cyA6IFtldmVudF0uY29uY2F0KGFyZ3MpKTsKCQl9OwoJfSwKCglydW46IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXJldHVybiB0aGlzLmFwcGx5KGJpbmQsIEFycmF5LmZyb20oYXJncykpOwoJfQoKfSk7CgppZiAoT2JqZWN0LmNyZWF0ZSA9PSBGdW5jdGlvbi5wcm90b3R5cGUuY3JlYXRlKSBPYmplY3QuY3JlYXRlID0gbnVsbDsKCnZhciAkdHJ5ID0gRnVuY3Rpb24uYXR0ZW1wdDsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBPYmplY3QKCmRlc2NyaXB0aW9uOiBPYmplY3QgZ2VuZXJpYyBtZXRob2RzCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogW09iamVjdCwgSGFzaF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwoKT2JqZWN0LmV4dGVuZCh7CgoJc3Vic2V0OiBmdW5jdGlvbihvYmplY3QsIGtleXMpewoJCXZhciByZXN1bHRzID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBrID0ga2V5c1tpXTsKCQkJaWYgKGsgaW4gb2JqZWN0KSByZXN1bHRzW2tdID0gb2JqZWN0W2tdOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJbWFwOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHJlc3VsdHNba2V5XSA9IGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSAmJiBmbi5jYWxsKGJpbmQsIHZhbHVlLCBrZXksIG9iamVjdCkpIHJlc3VsdHNba2V5XSA9IHZhbHVlOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgIWZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSkpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIga2V5cyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIGtleXMucHVzaChrZXkpOwoJCX0KCQlyZXR1cm4ga2V5czsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB2YWx1ZXMucHVzaChvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiB2YWx1ZXM7Cgl9LAoKCWdldExlbmd0aDogZnVuY3Rpb24ob2JqZWN0KXsKCQlyZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGg7Cgl9LAoKCWtleU9mOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpICYmIG9iamVjdFtrZXldID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKG9iamVjdCwgdmFsdWUpICE9IG51bGw7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChiYXNlKSBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nOwoJCQl2YXIgcmVzdWx0OwoJCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQkJY2FzZSAnb2JqZWN0JzogcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSk7IGJyZWFrOwoJCQkJY2FzZSAnYXJyYXknOgoJCQkJCXZhciBxcyA9IHt9OwoJCQkJCXZhbHVlLmVhY2goZnVuY3Rpb24odmFsLCBpKXsKCQkJCQkJcXNbaV0gPSB2YWw7CgkJCQkJfSk7CgkJCQkJcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcocXMsIGtleSk7CgkJCQlicmVhazsKCQkJCWRlZmF1bHQ6IHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCX0KCQkJaWYgKHZhbHVlICE9IG51bGwpIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KTsKCQl9KTsKCgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKfSkoKTsKCi8vPDEuMmNvbXBhdD4KCkhhc2guaW1wbGVtZW50KHsKCgloYXM6IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCgoJa2V5T2Y6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKHRoaXMsIHZhbHVlKTsKCX0sCgoJaGFzVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmNvbnRhaW5zKHRoaXMsIHZhbHVlKTsKCX0sCgoJZXh0ZW5kOiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlIYXNoLmVhY2gocHJvcGVydGllcyB8fCB7fSwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCUhhc2guc2V0KHRoaXMsIGtleSwgdmFsdWUpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21iaW5lOiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlIYXNoLmVhY2gocHJvcGVydGllcyB8fCB7fSwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCUhhc2guaW5jbHVkZSh0aGlzLCBrZXksIHZhbHVlKTsKCQl9LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGtleSl7CgkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgZGVsZXRlIHRoaXNba2V5XTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbihrZXkpewoJCXJldHVybiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSA/IHRoaXNba2V5XSA6IG51bGw7Cgl9LAoKCXNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSl7CgkJaWYgKCF0aGlzW2tleV0gfHwgdGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB0aGlzW2tleV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJSGFzaC5lYWNoKHRoaXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQlkZWxldGUgdGhpc1trZXldOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmNsdWRlOiBmdW5jdGlvbihrZXksIHZhbHVlKXsKCQlpZiAodGhpc1trZXldID09IG51bGwpIHRoaXNba2V5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gbmV3IEhhc2goT2JqZWN0Lm1hcCh0aGlzLCBmbiwgYmluZCkpOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gbmV3IEhhc2goT2JqZWN0LmZpbHRlcih0aGlzLCBmbiwgYmluZCkpOwoJfSwKCglldmVyeTogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXJldHVybiBPYmplY3QuZXZlcnkodGhpcywgZm4sIGJpbmQpOwoJfSwKCglzb21lOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJcmV0dXJuIE9iamVjdC5zb21lKHRoaXMsIGZuLCBiaW5kKTsKCX0sCgoJZ2V0S2V5czogZnVuY3Rpb24oKXsKCQlyZXR1cm4gT2JqZWN0LmtleXModGhpcyk7Cgl9LAoKCWdldFZhbHVlczogZnVuY3Rpb24oKXsKCQlyZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzKTsKCX0sCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24oYmFzZSl7CgkJcmV0dXJuIE9iamVjdC50b1F1ZXJ5U3RyaW5nKHRoaXMsIGJhc2UpOwoJfQoKfSk7CgpIYXNoLmV4dGVuZCA9IE9iamVjdC5hcHBlbmQ7CgpIYXNoLmFsaWFzKHtpbmRleE9mOiAna2V5T2YnLCBjb250YWluczogJ2hhc1ZhbHVlJ30pOwoKLy88LzEuMmNvbXBhdD4KCgovKgotLS0KCm5hbWU6IEJyb3dzZXIKCmRlc2NyaXB0aW9uOiBUaGUgQnJvd3NlciBPYmplY3QuIENvbnRhaW5zIEJyb3dzZXIgaW5pdGlhbGl6YXRpb24sIFdpbmRvdyBhbmQgRG9jdW1lbnQsIGFuZCB0aGUgQnJvd3NlciBIYXNoLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0FycmF5LCBGdW5jdGlvbiwgTnVtYmVyLCBTdHJpbmddCgpwcm92aWRlczogW0Jyb3dzZXIsIFdpbmRvdywgRG9jdW1lbnRdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGRvY3VtZW50ID0gdGhpcy5kb2N1bWVudDsKdmFyIHdpbmRvdyA9IGRvY3VtZW50LndpbmRvdyA9IHRoaXM7Cgp2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCksCglwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybS50b0xvd2VyQ2FzZSgpLAoJVUEgPSB1YS5tYXRjaCgvKG9wZXJhfGllfGZpcmVmb3h8Y2hyb21lfHZlcnNpb24pW1xzXC86XShbXHdcZFwuXSspPy4qPyhzYWZhcml8dmVyc2lvbltcc1wvOl0oW1x3XGRcLl0rKXwkKS8pIHx8IFtudWxsLCAndW5rbm93bicsIDBdLAoJbW9kZSA9IFVBWzFdID09ICdpZScgJiYgZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwoKdmFyIEJyb3dzZXIgPSB0aGlzLkJyb3dzZXIgPSB7CgoJZXh0ZW5kOiBGdW5jdGlvbi5wcm90b3R5cGUuZXh0ZW5kLAoKCW5hbWU6IChVQVsxXSA9PSAndmVyc2lvbicpID8gVUFbM10gOiBVQVsxXSwKCgl2ZXJzaW9uOiBtb2RlIHx8IHBhcnNlRmxvYXQoKFVBWzFdID09ICdvcGVyYScgJiYgVUFbNF0pID8gVUFbNF0gOiBVQVsyXSksCgoJUGxhdGZvcm06IHsKCQluYW1lOiB1YS5tYXRjaCgvaXAoPzphZHxvZHxob25lKS8pID8gJ2lvcycgOiAodWEubWF0Y2goLyg/OndlYm9zfGFuZHJvaWQpLykgfHwgcGxhdGZvcm0ubWF0Y2goL21hY3x3aW58bGludXgvKSB8fCBbJ290aGVyJ10pWzBdCgl9LAoKCUZlYXR1cmVzOiB7CgkJeHBhdGg6ICEhKGRvY3VtZW50LmV2YWx1YXRlKSwKCQlhaXI6ICEhKHdpbmRvdy5ydW50aW1lKSwKCQlxdWVyeTogISEoZG9jdW1lbnQucXVlcnlTZWxlY3RvciksCgkJanNvbjogISEod2luZG93LkpTT04pCgl9LAoKCVBsdWdpbnM6IHt9Cgp9OwoKQnJvd3NlcltCcm93c2VyLm5hbWVdID0gdHJ1ZTsKQnJvd3NlcltCcm93c2VyLm5hbWUgKyBwYXJzZUludChCcm93c2VyLnZlcnNpb24sIDEwKV0gPSB0cnVlOwpCcm93c2VyLlBsYXRmb3JtW0Jyb3dzZXIuUGxhdGZvcm0ubmFtZV0gPSB0cnVlOwoKLy8gUmVxdWVzdAoKQnJvd3Nlci5SZXF1ZXN0ID0gKGZ1bmN0aW9uKCl7CgoJdmFyIFhNTEhUVFAgPSBmdW5jdGlvbigpewoJCXJldHVybiBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCX07CgoJdmFyIE1TWE1MMiA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNU1hNTDIuWE1MSFRUUCcpOwoJfTsKCgl2YXIgTVNYTUwgPSBmdW5jdGlvbigpewoJCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTEhUVFAnKTsKCX07CgoJcmV0dXJuIEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCQlYTUxIVFRQKCk7CgkJcmV0dXJuIFhNTEhUVFA7Cgl9LCBmdW5jdGlvbigpewoJCU1TWE1MMigpOwoJCXJldHVybiBNU1hNTDI7Cgl9LCBmdW5jdGlvbigpewoJCU1TWE1MKCk7CgkJcmV0dXJuIE1TWE1MOwoJfSk7Cgp9KSgpOwoKQnJvd3Nlci5GZWF0dXJlcy54aHIgPSAhIShCcm93c2VyLlJlcXVlc3QpOwoKLy8gRmxhc2ggZGV0ZWN0aW9uCgp2YXIgdmVyc2lvbiA9IChGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CglyZXR1cm4gbmF2aWdhdG9yLnBsdWdpbnNbJ1Nob2Nrd2F2ZSBGbGFzaCddLmRlc2NyaXB0aW9uOwp9LCBmdW5jdGlvbigpewoJcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdTaG9ja3dhdmVGbGFzaC5TaG9ja3dhdmVGbGFzaCcpLkdldFZhcmlhYmxlKCckdmVyc2lvbicpOwp9KSB8fCAnMCByMCcpLm1hdGNoKC9cZCsvZyk7CgpCcm93c2VyLlBsdWdpbnMuRmxhc2ggPSB7Cgl2ZXJzaW9uOiBOdW1iZXIodmVyc2lvblswXSB8fCAnMC4nICsgdmVyc2lvblsxXSkgfHwgMCwKCWJ1aWxkOiBOdW1iZXIodmVyc2lvblsyXSkgfHwgMAp9OwoKLy8gU3RyaW5nIHNjcmlwdHMKCkJyb3dzZXIuZXhlYyA9IGZ1bmN0aW9uKHRleHQpewoJaWYgKCF0ZXh0KSByZXR1cm4gdGV4dDsKCWlmICh3aW5kb3cuZXhlY1NjcmlwdCl7CgkJd2luZG93LmV4ZWNTY3JpcHQodGV4dCk7Cgl9IGVsc2UgewoJCXZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQlzY3JpcHQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ3RleHQvamF2YXNjcmlwdCcpOwoJCXNjcmlwdC50ZXh0ID0gdGV4dDsKCQlkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJZG9jdW1lbnQuaGVhZC5yZW1vdmVDaGlsZChzY3JpcHQpOwoJfQoJcmV0dXJuIHRleHQ7Cn07CgpTdHJpbmcuaW1wbGVtZW50KCdzdHJpcFNjcmlwdHMnLCBmdW5jdGlvbihleGVjKXsKCXZhciBzY3JpcHRzID0gJyc7Cgl2YXIgdGV4dCA9IHRoaXMucmVwbGFjZSgvPHNjcmlwdFtePl0qPihbXHNcU10qPyk8XC9zY3JpcHQ+L2dpLCBmdW5jdGlvbihhbGwsIGNvZGUpewoJCXNjcmlwdHMgKz0gY29kZSArICdcbic7CgkJcmV0dXJuICcnOwoJfSk7CglpZiAoZXhlYyA9PT0gdHJ1ZSkgQnJvd3Nlci5leGVjKHNjcmlwdHMpOwoJZWxzZSBpZiAodHlwZU9mKGV4ZWMpID09ICdmdW5jdGlvbicpIGV4ZWMoc2NyaXB0cywgdGV4dCk7CglyZXR1cm4gdGV4dDsKfSk7CgovLyBXaW5kb3csIERvY3VtZW50CgpCcm93c2VyLmV4dGVuZCh7CglEb2N1bWVudDogdGhpcy5Eb2N1bWVudCwKCVdpbmRvdzogdGhpcy5XaW5kb3csCglFbGVtZW50OiB0aGlzLkVsZW1lbnQsCglFdmVudDogdGhpcy5FdmVudAp9KTsKCnRoaXMuV2luZG93ID0gdGhpcy4kY29uc3RydWN0b3IgPSBuZXcgVHlwZSgnV2luZG93JywgZnVuY3Rpb24oKXt9KTsKCnRoaXMuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ3dpbmRvdycpLmhpZGUoKTsKCldpbmRvdy5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCXdpbmRvd1tuYW1lXSA9IG1ldGhvZDsKfSk7Cgp0aGlzLkRvY3VtZW50ID0gZG9jdW1lbnQuJGNvbnN0cnVjdG9yID0gbmV3IFR5cGUoJ0RvY3VtZW50JywgZnVuY3Rpb24oKXt9KTsKCmRvY3VtZW50LiRmYW1pbHkgPSBGdW5jdGlvbi5mcm9tKCdkb2N1bWVudCcpLmhpZGUoKTsKCkRvY3VtZW50Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJZG9jdW1lbnRbbmFtZV0gPSBtZXRob2Q7Cn0pOwoKZG9jdW1lbnQuaHRtbCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKaWYgKCFkb2N1bWVudC5oZWFkKSBkb2N1bWVudC5oZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXTsKCmlmIChkb2N1bWVudC5leGVjQ29tbWFuZCkgdHJ5IHsKCWRvY3VtZW50LmV4ZWNDb21tYW5kKCJCYWNrZ3JvdW5kSW1hZ2VDYWNoZSIsIGZhbHNlLCB0cnVlKTsKfSBjYXRjaCAoZSl7fQoKLyo8bHRJRTk+Ki8KaWYgKHRoaXMuYXR0YWNoRXZlbnQgJiYgIXRoaXMuYWRkRXZlbnRMaXN0ZW5lcil7Cgl2YXIgdW5sb2FkRXZlbnQgPSBmdW5jdGlvbigpewoJCXRoaXMuZGV0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwoJCWRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5odG1sID0gZG9jdW1lbnQud2luZG93ID0gbnVsbDsKCX07Cgl0aGlzLmF0dGFjaEV2ZW50KCdvbnVubG9hZCcsIHVubG9hZEV2ZW50KTsKfQoKLy8gSUUgZmFpbHMgb24gY29sbGVjdGlvbnMgYW5kIDxzZWxlY3Q+Lm9wdGlvbnMgKHJlZmVycyB0byA8c2VsZWN0PikKdmFyIGFycmF5RnJvbSA9IEFycmF5LmZyb207CnRyeSB7CglhcnJheUZyb20oZG9jdW1lbnQuaHRtbC5jaGlsZE5vZGVzKTsKfSBjYXRjaChlKXsKCUFycmF5LmZyb20gPSBmdW5jdGlvbihpdGVtKXsKCQlpZiAodHlwZW9mIGl0ZW0gIT0gJ3N0cmluZycgJiYgVHlwZS5pc0VudW1lcmFibGUoaXRlbSkgJiYgdHlwZU9mKGl0ZW0pICE9ICdhcnJheScpewoJCQl2YXIgaSA9IGl0ZW0ubGVuZ3RoLCBhcnJheSA9IG5ldyBBcnJheShpKTsKCQkJd2hpbGUgKGktLSkgYXJyYXlbaV0gPSBpdGVtW2ldOwoJCQlyZXR1cm4gYXJyYXk7CgkJfQoJCXJldHVybiBhcnJheUZyb20oaXRlbSk7Cgl9OwoKCXZhciBwcm90b3R5cGUgPSBBcnJheS5wcm90b3R5cGUsCgkJc2xpY2UgPSBwcm90b3R5cGUuc2xpY2U7CglbJ3BvcCcsICdwdXNoJywgJ3JldmVyc2UnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCcsICdjb25jYXQnLCAnam9pbicsICdzbGljZSddLmVhY2goZnVuY3Rpb24obmFtZSl7CgkJdmFyIG1ldGhvZCA9IHByb3RvdHlwZVtuYW1lXTsKCQlBcnJheVtuYW1lXSA9IGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gbWV0aG9kLmFwcGx5KEFycmF5LmZyb20oaXRlbSksIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CgkJfTsKCX0pOwp9Ci8qPC9sdElFOT4qLwoKLy88MS4yY29tcGF0PgoKaWYgKEJyb3dzZXIuUGxhdGZvcm0uaW9zKSBCcm93c2VyLlBsYXRmb3JtLmlwb2QgPSB0cnVlOwoKQnJvd3Nlci5FbmdpbmUgPSB7fTsKCnZhciBzZXRFbmdpbmUgPSBmdW5jdGlvbihuYW1lLCB2ZXJzaW9uKXsKCUJyb3dzZXIuRW5naW5lLm5hbWUgPSBuYW1lOwoJQnJvd3Nlci5FbmdpbmVbbmFtZSArIHZlcnNpb25dID0gdHJ1ZTsKCUJyb3dzZXIuRW5naW5lLnZlcnNpb24gPSB2ZXJzaW9uOwp9OwoKaWYgKEJyb3dzZXIuaWUpewoJQnJvd3Nlci5FbmdpbmUudHJpZGVudCA9IHRydWU7CgoJc3dpdGNoIChCcm93c2VyLnZlcnNpb24pewoJCWNhc2UgNjogc2V0RW5naW5lKCd0cmlkZW50JywgNCk7IGJyZWFrOwoJCWNhc2UgNzogc2V0RW5naW5lKCd0cmlkZW50JywgNSk7IGJyZWFrOwoJCWNhc2UgODogc2V0RW5naW5lKCd0cmlkZW50JywgNik7Cgl9Cn0KCmlmIChCcm93c2VyLmZpcmVmb3gpewoJQnJvd3Nlci5FbmdpbmUuZ2Vja28gPSB0cnVlOwoKCWlmIChCcm93c2VyLnZlcnNpb24gPj0gMykgc2V0RW5naW5lKCdnZWNrbycsIDE5KTsKCWVsc2Ugc2V0RW5naW5lKCdnZWNrbycsIDE4KTsKfQoKaWYgKEJyb3dzZXIuc2FmYXJpIHx8IEJyb3dzZXIuY2hyb21lKXsKCUJyb3dzZXIuRW5naW5lLndlYmtpdCA9IHRydWU7CgoJc3dpdGNoIChCcm93c2VyLnZlcnNpb24pewoJCWNhc2UgMjogc2V0RW5naW5lKCd3ZWJraXQnLCA0MTkpOyBicmVhazsKCQljYXNlIDM6IHNldEVuZ2luZSgnd2Via2l0JywgNDIwKTsgYnJlYWs7CgkJY2FzZSA0OiBzZXRFbmdpbmUoJ3dlYmtpdCcsIDUyNSk7Cgl9Cn0KCmlmIChCcm93c2VyLm9wZXJhKXsKCUJyb3dzZXIuRW5naW5lLnByZXN0byA9IHRydWU7CgoJaWYgKEJyb3dzZXIudmVyc2lvbiA+PSA5LjYpIHNldEVuZ2luZSgncHJlc3RvJywgOTYwKTsKCWVsc2UgaWYgKEJyb3dzZXIudmVyc2lvbiA+PSA5LjUpIHNldEVuZ2luZSgncHJlc3RvJywgOTUwKTsKCWVsc2Ugc2V0RW5naW5lKCdwcmVzdG8nLCA5MjUpOwp9CgppZiAoQnJvd3Nlci5uYW1lID09ICd1bmtub3duJyl7Cglzd2l0Y2ggKCh1YS5tYXRjaCgvKD86d2Via2l0fGtodG1sfGdlY2tvKS8pIHx8IFtdKVswXSl7CgkJY2FzZSAnd2Via2l0JzoKCQljYXNlICdraHRtbCc6CgkJCUJyb3dzZXIuRW5naW5lLndlYmtpdCA9IHRydWU7CgkJYnJlYWs7CgkJY2FzZSAnZ2Vja28nOgoJCQlCcm93c2VyLkVuZ2luZS5nZWNrbyA9IHRydWU7Cgl9Cn0KCnRoaXMuJGV4ZWMgPSBCcm93c2VyLmV4ZWM7CgovLzwvMS4yY29tcGF0PgoKfSkoKTsKCgovKgotLS0KCm5hbWU6IEV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIEV2ZW50IFR5cGUsIHRvIG1ha2UgdGhlIGV2ZW50IG9iamVjdCBjcm9zcy1icm93c2VyLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW1dpbmRvdywgRG9jdW1lbnQsIEFycmF5LCBGdW5jdGlvbiwgU3RyaW5nLCBPYmplY3RdCgpwcm92aWRlczogRXZlbnQKCi4uLgoqLwoKKGZ1bmN0aW9uKCkgewoKdmFyIF9rZXlzID0ge307Cgp2YXIgRE9NRXZlbnQgPSB0aGlzLkRPTUV2ZW50ID0gbmV3IFR5cGUoJ0RPTUV2ZW50JywgZnVuY3Rpb24oZXZlbnQsIHdpbil7CglpZiAoIXdpbikgd2luID0gd2luZG93OwoJZXZlbnQgPSBldmVudCB8fCB3aW4uZXZlbnQ7CglpZiAoZXZlbnQuJGV4dGVuZGVkKSByZXR1cm4gZXZlbnQ7Cgl0aGlzLmV2ZW50ID0gZXZlbnQ7Cgl0aGlzLiRleHRlbmRlZCA9IHRydWU7Cgl0aGlzLnNoaWZ0ID0gZXZlbnQuc2hpZnRLZXk7Cgl0aGlzLmNvbnRyb2wgPSBldmVudC5jdHJsS2V5OwoJdGhpcy5hbHQgPSBldmVudC5hbHRLZXk7Cgl0aGlzLm1ldGEgPSBldmVudC5tZXRhS2V5OwoJdmFyIHR5cGUgPSB0aGlzLnR5cGUgPSBldmVudC50eXBlOwoJdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50OwoJd2hpbGUgKHRhcmdldCAmJiB0YXJnZXQubm9kZVR5cGUgPT0gMykgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7Cgl0aGlzLnRhcmdldCA9IGRvY3VtZW50LmlkKHRhcmdldCk7CgoJaWYgKHR5cGUuaW5kZXhPZigna2V5JykgPT0gMCl7CgkJdmFyIGNvZGUgPSB0aGlzLmNvZGUgPSAoZXZlbnQud2hpY2ggfHwgZXZlbnQua2V5Q29kZSk7CgkJdGhpcy5rZXkgPSBfa2V5c1tjb2RlXS8qPDEuM2NvbXBhdD4qLyB8fCBPYmplY3Qua2V5T2YoRXZlbnQuS2V5cywgY29kZSkvKjwvMS4zY29tcGF0PiovOwoJCWlmICh0eXBlID09ICdrZXlkb3duJyl7CgkJCWlmIChjb2RlID4gMTExICYmIGNvZGUgPCAxMjQpIHRoaXMua2V5ID0gJ2YnICsgKGNvZGUgLSAxMTEpOwoJCQllbHNlIGlmIChjb2RlID4gOTUgJiYgY29kZSA8IDEwNikgdGhpcy5rZXkgPSBjb2RlIC0gOTY7CgkJfQoJCWlmICh0aGlzLmtleSA9PSBudWxsKSB0aGlzLmtleSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoY29kZSkudG9Mb3dlckNhc2UoKTsKCX0gZWxzZSBpZiAodHlwZSA9PSAnY2xpY2snIHx8IHR5cGUgPT0gJ2RibGNsaWNrJyB8fCB0eXBlID09ICdjb250ZXh0bWVudScgfHwgdHlwZSA9PSAnRE9NTW91c2VTY3JvbGwnIHx8IHR5cGUuaW5kZXhPZignbW91c2UnKSA9PSAwKXsKCQl2YXIgZG9jID0gd2luLmRvY3VtZW50OwoJCWRvYyA9ICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7CgkJdGhpcy5wYWdlID0gewoJCQl4OiAoZXZlbnQucGFnZVggIT0gbnVsbCkgPyBldmVudC5wYWdlWCA6IGV2ZW50LmNsaWVudFggKyBkb2Muc2Nyb2xsTGVmdCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgOiBldmVudC5jbGllbnRZICsgZG9jLnNjcm9sbFRvcAoJCX07CgkJdGhpcy5jbGllbnQgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIC0gd2luLnBhZ2VYT2Zmc2V0IDogZXZlbnQuY2xpZW50WCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgLSB3aW4ucGFnZVlPZmZzZXQgOiBldmVudC5jbGllbnRZCgkJfTsKCQlpZiAodHlwZSA9PSAnRE9NTW91c2VTY3JvbGwnIHx8IHR5cGUgPT0gJ21vdXNld2hlZWwnKQoJCQl0aGlzLndoZWVsID0gKGV2ZW50LndoZWVsRGVsdGEpID8gZXZlbnQud2hlZWxEZWx0YSAvIDEyMCA6IC0oZXZlbnQuZGV0YWlsIHx8IDApIC8gMzsKCgkJdGhpcy5yaWdodENsaWNrID0gKGV2ZW50LndoaWNoID09IDMgfHwgZXZlbnQuYnV0dG9uID09IDIpOwoJCWlmICh0eXBlID09ICdtb3VzZW92ZXInIHx8IHR5cGUgPT0gJ21vdXNlb3V0Jyl7CgkJCXZhciByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCB8fCBldmVudFsodHlwZSA9PSAnbW91c2VvdmVyJyA/ICdmcm9tJyA6ICd0bycpICsgJ0VsZW1lbnQnXTsKCQkJd2hpbGUgKHJlbGF0ZWQgJiYgcmVsYXRlZC5ub2RlVHlwZSA9PSAzKSByZWxhdGVkID0gcmVsYXRlZC5wYXJlbnROb2RlOwoJCQl0aGlzLnJlbGF0ZWRUYXJnZXQgPSBkb2N1bWVudC5pZChyZWxhdGVkKTsKCQl9Cgl9IGVsc2UgaWYgKHR5cGUuaW5kZXhPZigndG91Y2gnKSA9PSAwIHx8IHR5cGUuaW5kZXhPZignZ2VzdHVyZScpID09IDApewoJCXRoaXMucm90YXRpb24gPSBldmVudC5yb3RhdGlvbjsKCQl0aGlzLnNjYWxlID0gZXZlbnQuc2NhbGU7CgkJdGhpcy50YXJnZXRUb3VjaGVzID0gZXZlbnQudGFyZ2V0VG91Y2hlczsKCQl0aGlzLmNoYW5nZWRUb3VjaGVzID0gZXZlbnQuY2hhbmdlZFRvdWNoZXM7CgkJdmFyIHRvdWNoZXMgPSB0aGlzLnRvdWNoZXMgPSBldmVudC50b3VjaGVzOwoJCWlmICh0b3VjaGVzICYmIHRvdWNoZXNbMF0pewoJCQl2YXIgdG91Y2ggPSB0b3VjaGVzWzBdOwoJCQl0aGlzLnBhZ2UgPSB7eDogdG91Y2gucGFnZVgsIHk6IHRvdWNoLnBhZ2VZfTsKCQkJdGhpcy5jbGllbnQgPSB7eDogdG91Y2guY2xpZW50WCwgeTogdG91Y2guY2xpZW50WX07CgkJfQoJfQoKCWlmICghdGhpcy5jbGllbnQpIHRoaXMuY2xpZW50ID0ge307CglpZiAoIXRoaXMucGFnZSkgdGhpcy5wYWdlID0ge307Cn0pOwoKRE9NRXZlbnQuaW1wbGVtZW50KHsKCglzdG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnByZXZlbnREZWZhdWx0KCkuc3RvcFByb3BhZ2F0aW9uKCk7Cgl9LAoKCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24pIHRoaXMuZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJZWxzZSB0aGlzLmV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmV2ZW50LnByZXZlbnREZWZhdWx0KSB0aGlzLmV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJZWxzZSB0aGlzLmV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkRPTUV2ZW50LmRlZmluZUtleSA9IGZ1bmN0aW9uKGNvZGUsIGtleSl7Cglfa2V5c1tjb2RlXSA9IGtleTsKCXJldHVybiB0aGlzOwp9OwoKRE9NRXZlbnQuZGVmaW5lS2V5cyA9IERPTUV2ZW50LmRlZmluZUtleS5vdmVybG9hZFNldHRlcih0cnVlKTsKCkRPTUV2ZW50LmRlZmluZUtleXMoewoJJzM4JzogJ3VwJywgJzQwJzogJ2Rvd24nLCAnMzcnOiAnbGVmdCcsICczOSc6ICdyaWdodCcsCgknMjcnOiAnZXNjJywgJzMyJzogJ3NwYWNlJywgJzgnOiAnYmFja3NwYWNlJywgJzknOiAndGFiJywKCSc0Nic6ICdkZWxldGUnLCAnMTMnOiAnZW50ZXInCn0pOwoKfSkoKTsKCi8qPDEuM2NvbXBhdD4qLwp2YXIgRXZlbnQgPSBET01FdmVudDsKRXZlbnQuS2V5cyA9IHt9OwovKjwvMS4zY29tcGF0PiovCgovKjwxLjJjb21wYXQ+Ki8KCkV2ZW50LktleXMgPSBuZXcgSGFzaChFdmVudC5LZXlzKTsKCi8qPC8xLjJjb21wYXQ+Ki8KCgovKgotLS0KCm5hbWU6IENsYXNzCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENsYXNzIEZ1bmN0aW9uIGZvciBlYXNpbHkgY3JlYXRpbmcsIGV4dGVuZGluZywgYW5kIGltcGxlbWVudGluZyByZXVzYWJsZSBDbGFzc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIEZ1bmN0aW9uLCBOdW1iZXJdCgpwcm92aWRlczogQ2xhc3MKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgQ2xhc3MgPSB0aGlzLkNsYXNzID0gbmV3IFR5cGUoJ0NsYXNzJywgZnVuY3Rpb24ocGFyYW1zKXsKCWlmIChpbnN0YW5jZU9mKHBhcmFtcywgRnVuY3Rpb24pKSBwYXJhbXMgPSB7aW5pdGlhbGl6ZTogcGFyYW1zfTsKCgl2YXIgbmV3Q2xhc3MgPSBmdW5jdGlvbigpewoJCXJlc2V0KHRoaXMpOwoJCWlmIChuZXdDbGFzcy4kcHJvdG90eXBpbmcpIHJldHVybiB0aGlzOwoJCXRoaXMuJGNhbGxlciA9IG51bGw7CgkJdmFyIHZhbHVlID0gKHRoaXMuaW5pdGlhbGl6ZSkgPyB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IHRoaXM7CgkJdGhpcy4kY2FsbGVyID0gdGhpcy5jYWxsZXIgPSBudWxsOwoJCXJldHVybiB2YWx1ZTsKCX0uZXh0ZW5kKHRoaXMpLmltcGxlbWVudChwYXJhbXMpOwoKCW5ld0NsYXNzLiRjb25zdHJ1Y3RvciA9IENsYXNzOwoJbmV3Q2xhc3MucHJvdG90eXBlLiRjb25zdHJ1Y3RvciA9IG5ld0NsYXNzOwoJbmV3Q2xhc3MucHJvdG90eXBlLnBhcmVudCA9IHBhcmVudDsKCglyZXR1cm4gbmV3Q2xhc3M7Cn0pOwoKdmFyIHBhcmVudCA9IGZ1bmN0aW9uKCl7CglpZiAoIXRoaXMuJGNhbGxlcikgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICJwYXJlbnQiIGNhbm5vdCBiZSBjYWxsZWQuJyk7Cgl2YXIgbmFtZSA9IHRoaXMuJGNhbGxlci4kbmFtZSwKCQlwYXJlbnQgPSB0aGlzLiRjYWxsZXIuJG93bmVyLnBhcmVudCwKCQlwcmV2aW91cyA9IChwYXJlbnQpID8gcGFyZW50LnByb3RvdHlwZVtuYW1lXSA6IG51bGw7CglpZiAoIXByZXZpb3VzKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgIicgKyBuYW1lICsgJyIgaGFzIG5vIHBhcmVudC4nKTsKCXJldHVybiBwcmV2aW91cy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKdmFyIHJlc2V0ID0gZnVuY3Rpb24ob2JqZWN0KXsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCXZhciB2YWx1ZSA9IG9iamVjdFtrZXldOwoJCXN3aXRjaCAodHlwZU9mKHZhbHVlKSl7CgkJCWNhc2UgJ29iamVjdCc6CgkJCQl2YXIgRiA9IGZ1bmN0aW9uKCl7fTsKCQkJCUYucHJvdG90eXBlID0gdmFsdWU7CgkJCQlvYmplY3Rba2V5XSA9IHJlc2V0KG5ldyBGKTsKCQkJYnJlYWs7CgkJCWNhc2UgJ2FycmF5Jzogb2JqZWN0W2tleV0gPSB2YWx1ZS5jbG9uZSgpOyBicmVhazsKCQl9Cgl9CglyZXR1cm4gb2JqZWN0Owp9OwoKdmFyIHdyYXAgPSBmdW5jdGlvbihzZWxmLCBrZXksIG1ldGhvZCl7CglpZiAobWV0aG9kLiRvcmlnaW4pIG1ldGhvZCA9IG1ldGhvZC4kb3JpZ2luOwoJdmFyIHdyYXBwZXIgPSBmdW5jdGlvbigpewoJCWlmIChtZXRob2QuJHByb3RlY3RlZCAmJiB0aGlzLiRjYWxsZXIgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICInICsga2V5ICsgJyIgY2Fubm90IGJlIGNhbGxlZC4nKTsKCQl2YXIgY2FsbGVyID0gdGhpcy5jYWxsZXIsIGN1cnJlbnQgPSB0aGlzLiRjYWxsZXI7CgkJdGhpcy5jYWxsZXIgPSBjdXJyZW50OyB0aGlzLiRjYWxsZXIgPSB3cmFwcGVyOwoJCXZhciByZXN1bHQgPSBtZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQl0aGlzLiRjYWxsZXIgPSBjdXJyZW50OyB0aGlzLmNhbGxlciA9IGNhbGxlcjsKCQlyZXR1cm4gcmVzdWx0OwoJfS5leHRlbmQoeyRvd25lcjogc2VsZiwgJG9yaWdpbjogbWV0aG9kLCAkbmFtZToga2V5fSk7CglyZXR1cm4gd3JhcHBlcjsKfTsKCnZhciBpbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlLCByZXRhaW4pewoJaWYgKENsYXNzLk11dGF0b3JzLmhhc093blByb3BlcnR5KGtleSkpewoJCXZhbHVlID0gQ2xhc3MuTXV0YXRvcnNba2V5XS5jYWxsKHRoaXMsIHZhbHVlKTsKCQlpZiAodmFsdWUgPT0gbnVsbCkgcmV0dXJuIHRoaXM7Cgl9CgoJaWYgKHR5cGVPZih2YWx1ZSkgPT0gJ2Z1bmN0aW9uJyl7CgkJaWYgKHZhbHVlLiRoaWRkZW4pIHJldHVybiB0aGlzOwoJCXRoaXMucHJvdG90eXBlW2tleV0gPSAocmV0YWluKSA/IHZhbHVlIDogd3JhcCh0aGlzLCBrZXksIHZhbHVlKTsKCX0gZWxzZSB7CgkJT2JqZWN0Lm1lcmdlKHRoaXMucHJvdG90eXBlLCBrZXksIHZhbHVlKTsKCX0KCglyZXR1cm4gdGhpczsKfTsKCnZhciBnZXRJbnN0YW5jZSA9IGZ1bmN0aW9uKGtsYXNzKXsKCWtsYXNzLiRwcm90b3R5cGluZyA9IHRydWU7Cgl2YXIgcHJvdG8gPSBuZXcga2xhc3M7CglkZWxldGUga2xhc3MuJHByb3RvdHlwaW5nOwoJcmV0dXJuIHByb3RvOwp9OwoKQ2xhc3MuaW1wbGVtZW50KCdpbXBsZW1lbnQnLCBpbXBsZW1lbnQub3ZlcmxvYWRTZXR0ZXIoKSk7CgpDbGFzcy5NdXRhdG9ycyA9IHsKCglFeHRlbmRzOiBmdW5jdGlvbihwYXJlbnQpewoJCXRoaXMucGFyZW50ID0gcGFyZW50OwoJCXRoaXMucHJvdG90eXBlID0gZ2V0SW5zdGFuY2UocGFyZW50KTsKCX0sCgoJSW1wbGVtZW50czogZnVuY3Rpb24oaXRlbXMpewoJCUFycmF5LmZyb20oaXRlbXMpLmVhY2goZnVuY3Rpb24oaXRlbSl7CgkJCXZhciBpbnN0YW5jZSA9IG5ldyBpdGVtOwoJCQlmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2UpIGltcGxlbWVudC5jYWxsKHRoaXMsIGtleSwgaW5zdGFuY2Vba2V5XSwgdHJ1ZSk7CgkJfSwgdGhpcyk7Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogQ2xhc3MuRXh0cmFzCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgVXRpbGl0eSBDbGFzc2VzIHRoYXQgY2FuIGJlIGltcGxlbWVudGVkIGludG8geW91ciBvd24gQ2xhc3NlcyB0byBlYXNlIHRoZSBleGVjdXRpb24gb2YgbWFueSBjb21tb24gdGFza3MuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBDbGFzcwoKcHJvdmlkZXM6IFtDbGFzcy5FeHRyYXMsIENoYWluLCBFdmVudHMsIE9wdGlvbnNdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdGhpcy5DaGFpbiA9IG5ldyBDbGFzcyh7CgoJJGNoYWluOiBbXSwKCgljaGFpbjogZnVuY3Rpb24oKXsKCQl0aGlzLiRjaGFpbi5hcHBlbmQoQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FsbENoYWluOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy4kY2hhaW4ubGVuZ3RoKSA/IHRoaXMuJGNoYWluLnNoaWZ0KCkuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IGZhbHNlOwoJfSwKCgljbGVhckNoYWluOiBmdW5jdGlvbigpewoJCXRoaXMuJGNoYWluLmVtcHR5KCk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciByZW1vdmVPbiA9IGZ1bmN0aW9uKHN0cmluZyl7CglyZXR1cm4gc3RyaW5nLnJlcGxhY2UoL15vbihbQS1aXSkvLCBmdW5jdGlvbihmdWxsLCBmaXJzdCl7CgkJcmV0dXJuIGZpcnN0LnRvTG93ZXJDYXNlKCk7Cgl9KTsKfTsKCnRoaXMuRXZlbnRzID0gbmV3IENsYXNzKHsKCgkkZXZlbnRzOiB7fSwKCglhZGRFdmVudDogZnVuY3Rpb24odHlwZSwgZm4sIGludGVybmFsKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgoJCS8qPDEuMmNvbXBhdD4qLwoJCWlmIChmbiA9PSAkZW1wdHkpIHJldHVybiB0aGlzOwoJCS8qPC8xLjJjb21wYXQ+Ki8KCgkJdGhpcy4kZXZlbnRzW3R5cGVdID0gKHRoaXMuJGV2ZW50c1t0eXBlXSB8fCBbXSkuaW5jbHVkZShmbik7CgkJaWYgKGludGVybmFsKSBmbi5pbnRlcm5hbCA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWFkZEV2ZW50czogZnVuY3Rpb24oZXZlbnRzKXsKCQlmb3IgKHZhciB0eXBlIGluIGV2ZW50cykgdGhpcy5hZGRFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglmaXJlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGFyZ3MsIGRlbGF5KXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJYXJncyA9IEFycmF5LmZyb20oYXJncyk7CgkJZXZlbnRzLmVhY2goZnVuY3Rpb24oZm4pewoJCQlpZiAoZGVsYXkpIGZuLmRlbGF5KGRlbGF5LCB0aGlzLCBhcmdzKTsKCQkJZWxzZSBmbi5hcHBseSh0aGlzLCBhcmdzKTsKCQl9LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoZXZlbnRzICYmICFmbi5pbnRlcm5hbCl7CgkJCXZhciBpbmRleCA9ICBldmVudHMuaW5kZXhPZihmbik7CgkJCWlmIChpbmRleCAhPSAtMSkgZGVsZXRlIGV2ZW50c1tpbmRleF07CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKGV2ZW50cykgZXZlbnRzID0gcmVtb3ZlT24oZXZlbnRzKTsKCQlmb3IgKHR5cGUgaW4gdGhpcy4kZXZlbnRzKXsKCQkJaWYgKGV2ZW50cyAmJiBldmVudHMgIT0gdHlwZSkgY29udGludWU7CgkJCXZhciBmbnMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJCWZvciAodmFyIGkgPSBmbnMubGVuZ3RoOyBpLS07KSBpZiAoaSBpbiBmbnMpewoJCQkJdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBmbnNbaV0pOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp0aGlzLk9wdGlvbnMgPSBuZXcgQ2xhc3MoewoKCXNldE9wdGlvbnM6IGZ1bmN0aW9uKCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMgPSBPYmplY3QubWVyZ2UuYXBwbHkobnVsbCwgW3t9LCB0aGlzLm9wdGlvbnNdLmFwcGVuZChhcmd1bWVudHMpKTsKCQlpZiAodGhpcy5hZGRFdmVudCkgZm9yICh2YXIgb3B0aW9uIGluIG9wdGlvbnMpewoJCQlpZiAodHlwZU9mKG9wdGlvbnNbb3B0aW9uXSkgIT0gJ2Z1bmN0aW9uJyB8fCAhKC9eb25bQS1aXS8pLnRlc3Qob3B0aW9uKSkgY29udGludWU7CgkJCXRoaXMuYWRkRXZlbnQob3B0aW9uLCBvcHRpb25zW29wdGlvbl0pOwoJCQlkZWxldGUgb3B0aW9uc1tvcHRpb25dOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKfSkoKTsKCgovKgotLS0KbmFtZTogU2xpY2suUGFyc2VyCmRlc2NyaXB0aW9uOiBTdGFuZGFsb25lIENTUzMgU2VsZWN0b3IgcGFyc2VyCnByb3ZpZGVzOiBTbGljay5QYXJzZXIKLi4uCiovCgo7KGZ1bmN0aW9uKCl7Cgp2YXIgcGFyc2VkLAoJc2VwYXJhdG9ySW5kZXgsCgljb21iaW5hdG9ySW5kZXgsCglyZXZlcnNlZCwKCWNhY2hlID0ge30sCglyZXZlcnNlQ2FjaGUgPSB7fSwKCXJlVW5lc2NhcGUgPSAvXFwvZzsKCnZhciBwYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGlzUmV2ZXJzZWQpewoJaWYgKGV4cHJlc3Npb24gPT0gbnVsbCkgcmV0dXJuIG51bGw7CglpZiAoZXhwcmVzc2lvbi5TbGljayA9PT0gdHJ1ZSkgcmV0dXJuIGV4cHJlc3Npb247CglleHByZXNzaW9uID0gKCcnICsgZXhwcmVzc2lvbikucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCXJldmVyc2VkID0gISFpc1JldmVyc2VkOwoJdmFyIGN1cnJlbnRDYWNoZSA9IChyZXZlcnNlZCkgPyByZXZlcnNlQ2FjaGUgOiBjYWNoZTsKCWlmIChjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl0pIHJldHVybiBjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl07CglwYXJzZWQgPSB7CgkJU2xpY2s6IHRydWUsCgkJZXhwcmVzc2lvbnM6IFtdLAoJCXJhdzogZXhwcmVzc2lvbiwKCQlyZXZlcnNlOiBmdW5jdGlvbigpewoJCQlyZXR1cm4gcGFyc2UodGhpcy5yYXcsIHRydWUpOwoJCX0KCX07CglzZXBhcmF0b3JJbmRleCA9IC0xOwoJd2hpbGUgKGV4cHJlc3Npb24gIT0gKGV4cHJlc3Npb24gPSBleHByZXNzaW9uLnJlcGxhY2UocmVnZXhwLCBwYXJzZXIpKSk7CglwYXJzZWQubGVuZ3RoID0gcGFyc2VkLmV4cHJlc3Npb25zLmxlbmd0aDsKCXJldHVybiBjdXJyZW50Q2FjaGVbcGFyc2VkLnJhd10gPSAocmV2ZXJzZWQpID8gcmV2ZXJzZShwYXJzZWQpIDogcGFyc2VkOwp9OwoKdmFyIHJldmVyc2VDb21iaW5hdG9yID0gZnVuY3Rpb24oY29tYmluYXRvcil7CglpZiAoY29tYmluYXRvciA9PT0gJyEnKSByZXR1cm4gJyAnOwoJZWxzZSBpZiAoY29tYmluYXRvciA9PT0gJyAnKSByZXR1cm4gJyEnOwoJZWxzZSBpZiAoKC9eIS8pLnRlc3QoY29tYmluYXRvcikpIHJldHVybiBjb21iaW5hdG9yLnJlcGxhY2UoL14hLywgJycpOwoJZWxzZSByZXR1cm4gJyEnICsgY29tYmluYXRvcjsKfTsKCnZhciByZXZlcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbil7Cgl2YXIgZXhwcmVzc2lvbnMgPSBleHByZXNzaW9uLmV4cHJlc3Npb25zOwoJZm9yICh2YXIgaSA9IDA7IGkgPCBleHByZXNzaW9ucy5sZW5ndGg7IGkrKyl7CgkJdmFyIGV4cCA9IGV4cHJlc3Npb25zW2ldOwoJCXZhciBsYXN0ID0ge3BhcnRzOiBbXSwgdGFnOiAnKicsIGNvbWJpbmF0b3I6IHJldmVyc2VDb21iaW5hdG9yKGV4cFswXS5jb21iaW5hdG9yKX07CgoJCWZvciAodmFyIGogPSAwOyBqIDwgZXhwLmxlbmd0aDsgaisrKXsKCQkJdmFyIGNleHAgPSBleHBbal07CgkJCWlmICghY2V4cC5yZXZlcnNlQ29tYmluYXRvcikgY2V4cC5yZXZlcnNlQ29tYmluYXRvciA9ICcgJzsKCQkJY2V4cC5jb21iaW5hdG9yID0gY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQkJZGVsZXRlIGNleHAucmV2ZXJzZUNvbWJpbmF0b3I7CgkJfQoKCQlleHAucmV2ZXJzZSgpLnB1c2gobGFzdCk7Cgl9CglyZXR1cm4gZXhwcmVzc2lvbjsKfTsKCnZhciBlc2NhcGVSZWdFeHAgPSBmdW5jdGlvbihzdHJpbmcpey8vIENyZWRpdDogWFJlZ0V4cCAwLjYuMSAoYykgMjAwNy0yMDA4IFN0ZXZlbiBMZXZpdGhhbiA8aHR0cDovL3N0ZXZlbmxldml0aGFuLmNvbS9yZWdleC94cmVnZXhwLz4gTUlUIExpY2Vuc2UKCXJldHVybiBzdHJpbmcucmVwbGFjZSgvWy1bXF17fSgpKis/LlxcXiR8LCNcc10vZywgZnVuY3Rpb24obWF0Y2gpewoJCXJldHVybiAnXFwnICsgbWF0Y2g7Cgl9KTsKfTsKCnZhciByZWdleHAgPSBuZXcgUmVnRXhwKAovKgojIS91c3IvYmluL2VudiBydWJ5CnB1dHMgIlx0XHQiICsgREFUQS5yZWFkLmdzdWIoL1woXD94XCl8XHMrIy4qJHxccyt8XFwkfFxcbi8sJycpCl9fRU5EX18KCSIoP3gpXig/OlwKCSAgXFxzKiAoICwgKSBcXHMqICAgICAgICAgICAgICAgIyBTZXBhcmF0b3IgICAgICAgICAgXG5cCgl8IFxccyogKCA8Y29tYmluYXRvcj4rICkgXFxzKiAgICMgQ29tYmluYXRvciAgICAgICAgIFxuXAoJfCAgICAgICggXFxzKyApICAgICAgICAgICAgICAgICAjIENvbWJpbmF0b3JDaGlsZHJlbiBcblwKCXwgICAgICAoIDx1bmljb2RlPisgfCBcXCogKSAgICAgIyBUYWcgICAgICAgICAgICAgICAgXG5cCgl8IFxcIyAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgSUQgICAgICAgICAgICAgICAgIFxuXAoJfCBcXC4gICggPHVuaWNvZGU+KyAgICAgICApICAgICAjIENsYXNzTmFtZSAgICAgICAgICBcblwKCXwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBBdHRyaWJ1dGUgICAgICAgICAgXG5cCglcXFsgIFwKCQlcXHMqICg8dW5pY29kZTE+KykgICg/OiAgXAoJCQlcXHMqIChbKl4kIX58XT89KSAgKD86ICBcCgkJCQlcXHMqICg/OlwKCQkJCQkoW1wiJ10/KSguKj8pXFw5IFwKCQkJCSlcCgkJCSkgIFwKCQkpPyAgXFxzKiAgXAoJXFxdKD8hXFxdKSBcblwKCXwgICA6KyAoIDx1bmljb2RlPisgKSg/OlwKCVxcKCAoPzpcCgkJKD86KFtcIiddKShbXlxcMTJdKilcXDEyKXwoKD86XFwoW14pXStcXCl8W14oKV0qKSspXAoJKSBcXClcCgkpP1wKCSkiCiovCgkiXig/OlxccyooLClcXHMqfFxccyooPGNvbWJpbmF0b3I+KylcXHMqfChcXHMrKXwoPHVuaWNvZGU+K3xcXCopfFxcIyg8dW5pY29kZT4rKXxcXC4oPHVuaWNvZGU+Kyl8XFxbXFxzKig8dW5pY29kZTE+KykoPzpcXHMqKFsqXiQhfnxdPz0pKD86XFxzKig/OihbXCInXT8pKC4qPylcXDkpKSk/XFxzKlxcXSg/IVxcXSl8KDorKSg8dW5pY29kZT4rKSg/OlxcKCg/Oig/OihbXCInXSkoW15cXDEzXSopXFwxMyl8KCg/OlxcKFteKV0rXFwpfFteKCldKikrKSlcXCkpPykiCgkucmVwbGFjZSgvPGNvbWJpbmF0b3I+LywgJ1snICsgZXNjYXBlUmVnRXhwKCI+K35gIUAkJV4mPXt9XFw7PC8iKSArICddJykKCS5yZXBsYWNlKC88dW5pY29kZT4vZywgJyg/OltcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCgkucmVwbGFjZSgvPHVuaWNvZGUxPi9nLCAnKD86WzpcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCik7CgpmdW5jdGlvbiBwYXJzZXIoCglyYXdNYXRjaCwKCglzZXBhcmF0b3IsCgljb21iaW5hdG9yLAoJY29tYmluYXRvckNoaWxkcmVuLAoKCXRhZ05hbWUsCglpZCwKCWNsYXNzTmFtZSwKCglhdHRyaWJ1dGVLZXksCglhdHRyaWJ1dGVPcGVyYXRvciwKCWF0dHJpYnV0ZVF1b3RlLAoJYXR0cmlidXRlVmFsdWUsCgoJcHNldWRvTWFya2VyLAoJcHNldWRvQ2xhc3MsCglwc2V1ZG9RdW90ZSwKCXBzZXVkb0NsYXNzUXVvdGVkVmFsdWUsCglwc2V1ZG9DbGFzc1ZhbHVlCil7CglpZiAoc2VwYXJhdG9yIHx8IHNlcGFyYXRvckluZGV4ID09PSAtMSl7CgkJcGFyc2VkLmV4cHJlc3Npb25zWysrc2VwYXJhdG9ySW5kZXhdID0gW107CgkJY29tYmluYXRvckluZGV4ID0gLTE7CgkJaWYgKHNlcGFyYXRvcikgcmV0dXJuICcnOwoJfQoKCWlmIChjb21iaW5hdG9yIHx8IGNvbWJpbmF0b3JDaGlsZHJlbiB8fCBjb21iaW5hdG9ySW5kZXggPT09IC0xKXsKCQljb21iaW5hdG9yID0gY29tYmluYXRvciB8fCAnICc7CgkJdmFyIGN1cnJlbnRTZXBhcmF0b3IgPSBwYXJzZWQuZXhwcmVzc2lvbnNbc2VwYXJhdG9ySW5kZXhdOwoJCWlmIChyZXZlcnNlZCAmJiBjdXJyZW50U2VwYXJhdG9yW2NvbWJpbmF0b3JJbmRleF0pCgkJCWN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XS5yZXZlcnNlQ29tYmluYXRvciA9IHJldmVyc2VDb21iaW5hdG9yKGNvbWJpbmF0b3IpOwoJCWN1cnJlbnRTZXBhcmF0b3JbKytjb21iaW5hdG9ySW5kZXhdID0ge2NvbWJpbmF0b3I6IGNvbWJpbmF0b3IsIHRhZzogJyonfTsKCX0KCgl2YXIgY3VycmVudFBhcnNlZCA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF1bY29tYmluYXRvckluZGV4XTsKCglpZiAodGFnTmFtZSl7CgkJY3VycmVudFBhcnNlZC50YWcgPSB0YWdOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoaWQpewoJCWN1cnJlbnRQYXJzZWQuaWQgPSBpZC5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgl9IGVsc2UgaWYgKGNsYXNzTmFtZSl7CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0KSBjdXJyZW50UGFyc2VkLmNsYXNzTGlzdCA9IFtdOwoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc2VzKSBjdXJyZW50UGFyc2VkLmNsYXNzZXMgPSBbXTsKCQljdXJyZW50UGFyc2VkLmNsYXNzTGlzdC5wdXNoKGNsYXNzTmFtZSk7CgkJY3VycmVudFBhcnNlZC5jbGFzc2VzLnB1c2goewoJCQl2YWx1ZTogY2xhc3NOYW1lLAoJCQlyZWdleHA6IG5ldyBSZWdFeHAoJyhefFxccyknICsgZXNjYXBlUmVnRXhwKGNsYXNzTmFtZSkgKyAnKFxcc3wkKScpCgkJfSk7CgoJfSBlbHNlIGlmIChwc2V1ZG9DbGFzcyl7CgkJcHNldWRvQ2xhc3NWYWx1ZSA9IHBzZXVkb0NsYXNzVmFsdWUgfHwgcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZTsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSA/IHBzZXVkb0NsYXNzVmFsdWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJykgOiBudWxsOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQucHNldWRvcykgY3VycmVudFBhcnNlZC5wc2V1ZG9zID0gW107CgkJY3VycmVudFBhcnNlZC5wc2V1ZG9zLnB1c2goewoJCQlrZXk6IHBzZXVkb0NsYXNzLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpLAoJCQl2YWx1ZTogcHNldWRvQ2xhc3NWYWx1ZSwKCQkJdHlwZTogcHNldWRvTWFya2VyLmxlbmd0aCA9PSAxID8gJ2NsYXNzJyA6ICdlbGVtZW50JwoJCX0pOwoKCX0gZWxzZSBpZiAoYXR0cmlidXRlS2V5KXsKCQlhdHRyaWJ1dGVLZXkgPSBhdHRyaWJ1dGVLZXkucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgkJYXR0cmlidXRlVmFsdWUgPSAoYXR0cmlidXRlVmFsdWUgfHwgJycpLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQl2YXIgdGVzdCwgcmVnZXhwOwoKCQlzd2l0Y2ggKGF0dHJpYnV0ZU9wZXJhdG9yKXsKCQkJY2FzZSAnXj0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICAgICAgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJyQ9JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICAgICAgICAgICAgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyQnICAgICAgICk7IGJyZWFrOwoJCQljYXNlICd+PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAnKF58XFxzKScrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoXFxzfCQpJyApOyBicmVhazsKCQkJY2FzZSAnfD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnKC18JCknICAgKTsgYnJlYWs7CgkJCWNhc2UgICc9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgPT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQljYXNlICcqPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIHZhbHVlICYmIHZhbHVlLmluZGV4T2YoYXR0cmlidXRlVmFsdWUpID4gLTE7CgkJCX07IGJyZWFrOwoJCQljYXNlICchPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIGF0dHJpYnV0ZVZhbHVlICE9IHZhbHVlOwoJCQl9OyBicmVhazsKCQkJZGVmYXVsdCAgIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiAhIXZhbHVlOwoJCQl9OwoJCX0KCgkJaWYgKGF0dHJpYnV0ZVZhbHVlID09ICcnICYmICgvXlsqJF5dPSQvKS50ZXN0KGF0dHJpYnV0ZU9wZXJhdG9yKSkgdGVzdCA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCQlpZiAoIXRlc3QpIHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCXJldHVybiB2YWx1ZSAmJiByZWdleHAudGVzdCh2YWx1ZSk7CgkJfTsKCgkJaWYgKCFjdXJyZW50UGFyc2VkLmF0dHJpYnV0ZXMpIGN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcy5wdXNoKHsKCQkJa2V5OiBhdHRyaWJ1dGVLZXksCgkJCW9wZXJhdG9yOiBhdHRyaWJ1dGVPcGVyYXRvciwKCQkJdmFsdWU6IGF0dHJpYnV0ZVZhbHVlLAoJCQl0ZXN0OiB0ZXN0CgkJfSk7CgoJfQoKCXJldHVybiAnJzsKfTsKCi8vIFNsaWNrIE5TCgp2YXIgU2xpY2sgPSAodGhpcy5TbGljayB8fCB7fSk7CgpTbGljay5wYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJcmV0dXJuIHBhcnNlKGV4cHJlc3Npb24pOwp9OwoKU2xpY2suZXNjYXBlUmVnRXhwID0gZXNjYXBlUmVnRXhwOwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CgoKLyoKLS0tCm5hbWU6IFNsaWNrLkZpbmRlcgpkZXNjcmlwdGlvbjogVGhlIG5ldywgc3VwZXJmYXN0IGNzcyBzZWxlY3RvciBlbmdpbmUuCnByb3ZpZGVzOiBTbGljay5GaW5kZXIKcmVxdWlyZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCjsoZnVuY3Rpb24oKXsKCnZhciBsb2NhbCA9IHt9LAoJZmVhdHVyZXNDYWNoZSA9IHt9LAoJdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKLy8gRmVhdHVyZSAvIEJ1ZyBkZXRlY3Rpb24KCmxvY2FsLmlzTmF0aXZlQ29kZSA9IGZ1bmN0aW9uKGZuKXsKCXJldHVybiAoL1x7XHMqXFtuYXRpdmUgY29kZVxdXHMqXH0vKS50ZXN0KCcnICsgZm4pOwp9OwoKbG9jYWwuaXNYTUwgPSBmdW5jdGlvbihkb2N1bWVudCl7CglyZXR1cm4gKCEhZG9jdW1lbnQueG1sVmVyc2lvbikgfHwgKCEhZG9jdW1lbnQueG1sKSB8fCAodG9TdHJpbmcuY2FsbChkb2N1bWVudCkgPT0gJ1tvYmplY3QgWE1MRG9jdW1lbnRdJykgfHwKCShkb2N1bWVudC5ub2RlVHlwZSA9PSA5ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPSAnSFRNTCcpOwp9OwoKbG9jYWwuc2V0RG9jdW1lbnQgPSBmdW5jdGlvbihkb2N1bWVudCl7CgoJLy8gY29udmVydCBlbGVtZW50cyAvIHdpbmRvdyBhcmd1bWVudHMgdG8gZG9jdW1lbnQuIGlmIGRvY3VtZW50IGNhbm5vdCBiZSBleHRyYXBvbGF0ZWQsIHRoZSBmdW5jdGlvbiByZXR1cm5zLgoJdmFyIG5vZGVUeXBlID0gZG9jdW1lbnQubm9kZVR5cGU7CglpZiAobm9kZVR5cGUgPT0gOSk7IC8vIGRvY3VtZW50CgllbHNlIGlmIChub2RlVHlwZSkgZG9jdW1lbnQgPSBkb2N1bWVudC5vd25lckRvY3VtZW50OyAvLyBub2RlCgllbHNlIGlmIChkb2N1bWVudC5uYXZpZ2F0b3IpIGRvY3VtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnQ7IC8vIHdpbmRvdwoJZWxzZSByZXR1cm47CgoJLy8gY2hlY2sgaWYgaXQncyB0aGUgb2xkIGRvY3VtZW50CgoJaWYgKHRoaXMuZG9jdW1lbnQgPT09IGRvY3VtZW50KSByZXR1cm47Cgl0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQ7CgoJLy8gY2hlY2sgaWYgd2UgaGF2ZSBkb25lIGZlYXR1cmUgZGV0ZWN0aW9uIG9uIHRoaXMgZG9jdW1lbnQgYmVmb3JlCgoJdmFyIHJvb3QgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJcm9vdFVpZCA9IHRoaXMuZ2V0VUlEWE1MKHJvb3QpLAoJCWZlYXR1cmVzID0gZmVhdHVyZXNDYWNoZVtyb290VWlkXSwKCQlmZWF0dXJlOwoKCWlmIChmZWF0dXJlcyl7CgkJZm9yIChmZWF0dXJlIGluIGZlYXR1cmVzKXsKCQkJdGhpc1tmZWF0dXJlXSA9IGZlYXR1cmVzW2ZlYXR1cmVdOwoJCX0KCQlyZXR1cm47Cgl9CgoJZmVhdHVyZXMgPSBmZWF0dXJlc0NhY2hlW3Jvb3RVaWRdID0ge307CgoJZmVhdHVyZXMucm9vdCA9IHJvb3Q7CglmZWF0dXJlcy5pc1hNTERvY3VtZW50ID0gdGhpcy5pc1hNTChkb2N1bWVudCk7CgoJZmVhdHVyZXMuYnJva2VuU3RhckdFQlROCgk9IGZlYXR1cmVzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBCgk9IGZlYXR1cmVzLmlkR2V0c05hbWUKCT0gZmVhdHVyZXMuYnJva2VuTWl4ZWRDYXNlUVNBCgk9IGZlYXR1cmVzLmJyb2tlbkdFQkNOCgk9IGZlYXR1cmVzLmJyb2tlbkNoZWNrZWRRU0EKCT0gZmVhdHVyZXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EKCT0gZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQKCT0gZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yCgk9IGZhbHNlOwoKCXZhciBzdGFyU2VsZWN0c0Nsb3NlZCwgc3RhclNlbGVjdHNDb21tZW50cywKCQlicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTiwgY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSwKCQlicm9rZW5Gb3JtQXR0cmlidXRlR2V0dGVyOwoKCXZhciBzZWxlY3RlZCwgaWQgPSAnc2xpY2tfdW5pcXVlaWQnOwoJdmFyIHRlc3ROb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgoJdmFyIHRlc3RSb290ID0gZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYm9keScpWzBdIHx8IHJvb3Q7Cgl0ZXN0Um9vdC5hcHBlbmRDaGlsZCh0ZXN0Tm9kZSk7CgoJLy8gb24gbm9uLUhUTUwgZG9jdW1lbnRzIGlubmVySFRNTCBhbmQgZ2V0RWxlbWVudHNCeUlkIGRvZXNudCB3b3JrIHByb3Blcmx5Cgl0cnkgewoJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBpZD0iJytpZCsnIj48L2E+JzsKCQlmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCA9ICEhZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwoJfSBjYXRjaChlKXt9OwoKCWlmIChmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCl7CgoJCXRlc3ROb2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgoJCS8vIElFIHJldHVybnMgY29tbWVudCBub2RlcyBmb3IgZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQl0ZXN0Tm9kZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVDb21tZW50KCcnKSk7CgkJc3RhclNlbGVjdHNDb21tZW50cyA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpLmxlbmd0aCA+IDEpOwoKCQkvLyBJRSByZXR1cm5zIGNsb3NlZCBub2RlcyAoRUc6IjwvZm9vPiIpIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICdmb288L2Zvbz4nOwoJCQlzZWxlY3RlZCA9IHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJCXN0YXJTZWxlY3RzQ2xvc2VkID0gKHNlbGVjdGVkICYmICEhc2VsZWN0ZWQubGVuZ3RoICYmIHNlbGVjdGVkWzBdLm5vZGVOYW1lLmNoYXJBdCgwKSA9PSAnLycpOwoJCX0gY2F0Y2goZSl7fTsKCgkJZmVhdHVyZXMuYnJva2VuU3RhckdFQlROID0gc3RhclNlbGVjdHNDb21tZW50cyB8fCBzdGFyU2VsZWN0c0Nsb3NlZDsKCgkJLy8gSUUgcmV0dXJucyBlbGVtZW50cyB3aXRoIHRoZSBuYW1lIGluc3RlYWQgb2YganVzdCBpZCBmb3IgZ2V0RWxlbWVudHNCeUlkIGZvciBzb21lIGRvY3VtZW50cwoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBuYW1lPSInKyBpZCArJyI+PC9hPjxiIGlkPSInKyBpZCArJyI+PC9iPic7CgkJCWZlYXR1cmVzLmlkR2V0c05hbWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCkgPT09IHRlc3ROb2RlLmZpcnN0Q2hpbGQ7CgkJfSBjYXRjaChlKXt9OwoKCQlpZiAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSl7CgoJCQkvLyBTYWZhcmkgMy4yIGdldEVsZW1lbnRzQnlDbGFzc05hbWUgY2FjaGVzIHJlc3VsdHMKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iZiI+PC9hPjxhIGNsYXNzPSJiIj48L2E+JzsKCQkJCXRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2InKS5sZW5ndGg7CgkJCQl0ZXN0Tm9kZS5maXJzdENoaWxkLmNsYXNzTmFtZSA9ICdiJzsKCQkJCWNhY2hlZEdldEVsZW1lbnRzQnlDbGFzc05hbWUgPSAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYicpLmxlbmd0aCAhPSAyKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gT3BlcmEgOS42IGdldEVsZW1lbnRzQnlDbGFzc05hbWUgZG9lc250IGRldGVjdHMgdGhlIGNsYXNzIGlmIGl0cyBub3QgdGhlIGZpcnN0IG9uZQoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJhIj48L2E+PGEgY2xhc3M9ImYgYiBhIj48L2E+JzsKCQkJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2EnKS5sZW5ndGggIT0gMik7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCWZlYXR1cmVzLmJyb2tlbkdFQkNOID0gY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCBicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTjsKCQl9CgoJCWlmICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKXsKCQkJLy8gSUUgOCByZXR1cm5zIGNsb3NlZCBub2RlcyAoRUc6IjwvZm9vPiIpIGZvciBxdWVyeVNlbGVjdG9yQWxsKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnZm9vPC9mb28+JzsKCQkJCXNlbGVjdGVkID0gdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnKicpOwoJCQkJZmVhdHVyZXMuc3RhclNlbGVjdHNDbG9zZWRRU0EgPSAoc2VsZWN0ZWQgJiYgISFzZWxlY3RlZC5sZW5ndGggJiYgc2VsZWN0ZWRbMF0ubm9kZU5hbWUuY2hhckF0KDApID09ICcvJyk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIFNhZmFyaSAzLjIgcXVlcnlTZWxlY3RvckFsbCBkb2VzbnQgd29yayB3aXRoIG1peGVkY2FzZSBvbiBxdWlya3Ntb2RlCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9Ik1pWCI+PC9hPic7CgkJCQlmZWF0dXJlcy5icm9rZW5NaXhlZENhc2VRU0EgPSAhdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnLk1pWCcpLmxlbmd0aDsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gV2Via2l0IGFuZCBPcGVyYSBkb250IHJldHVybiBzZWxlY3RlZCBvcHRpb25zIG9uIHF1ZXJ5U2VsZWN0b3JBbGwKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8c2VsZWN0PjxvcHRpb24gc2VsZWN0ZWQ9InNlbGVjdGVkIj5hPC9vcHRpb24+PC9zZWxlY3Q+JzsKCQkJCWZlYXR1cmVzLmJyb2tlbkNoZWNrZWRRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnOmNoZWNrZWQnKS5sZW5ndGggPT0gMCk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIElFIHJldHVybnMgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIGF0dHJbKl4kXT0iIiBzZWxlY3RvcnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSIiPjwvYT4nOwoJCQkJZmVhdHVyZXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnW2NsYXNzKj0iIl0nKS5sZW5ndGggIT0gMCk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJfQoKCQkvLyBJRTYtNywgaWYgYSBmb3JtIGhhcyBhbiBpbnB1dCBvZiBpZCB4LCBmb3JtLmdldEF0dHJpYnV0ZSh4KSByZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnB1dAoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8Zm9ybSBhY3Rpb249InMiPjxpbnB1dCBpZD0iYWN0aW9uIi8+PC9mb3JtPic7CgkJCWJyb2tlbkZvcm1BdHRyaWJ1dGVHZXR0ZXIgPSAodGVzdE5vZGUuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoJ2FjdGlvbicpICE9ICdzJyk7CgkJfSBjYXRjaChlKXt9OwoKCQkvLyBuYXRpdmUgbWF0Y2hlc1NlbGVjdG9yIGZ1bmN0aW9uCgoJCWZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvciA9IHJvb3QubWF0Y2hlc1NlbGVjdG9yIHx8IC8qcm9vdC5tc01hdGNoZXNTZWxlY3RvciB8fCovIHJvb3QubW96TWF0Y2hlc1NlbGVjdG9yIHx8IHJvb3Qud2Via2l0TWF0Y2hlc1NlbGVjdG9yOwoJCWlmIChmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IpIHRyeSB7CgkJCS8vIGlmIG1hdGNoZXNTZWxlY3RvciB0cm93cyBlcnJvcnMgb24gaW5jb3JyZWN0IHNpbnRheGVzIHdlIGNhbiB1c2UgaXQKCQkJZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yLmNhbGwocm9vdCwgJzpzbGljaycpOwoJCQlmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IgPSBudWxsOwoJCX0gY2F0Y2goZSl7fTsKCgl9CgoJdHJ5IHsKCQlyb290LnNsaWNrX2V4cGFuZG8gPSAxOwoJCWRlbGV0ZSByb290LnNsaWNrX2V4cGFuZG87CgkJZmVhdHVyZXMuZ2V0VUlEID0gdGhpcy5nZXRVSURIVE1MOwoJfSBjYXRjaChlKSB7CgkJZmVhdHVyZXMuZ2V0VUlEID0gdGhpcy5nZXRVSURYTUw7Cgl9CgoJdGVzdFJvb3QucmVtb3ZlQ2hpbGQodGVzdE5vZGUpOwoJdGVzdE5vZGUgPSBzZWxlY3RlZCA9IHRlc3RSb290ID0gbnVsbDsKCgkvLyBnZXRBdHRyaWJ1dGUKCglmZWF0dXJlcy5nZXRBdHRyaWJ1dGUgPSAoZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQgJiYgYnJva2VuRm9ybUF0dHJpYnV0ZUdldHRlcikgPyBmdW5jdGlvbihub2RlLCBuYW1lKXsKCQl2YXIgbWV0aG9kID0gdGhpcy5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdOwoJCWlmIChtZXRob2QpIHJldHVybiBtZXRob2QuY2FsbChub2RlKTsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShuYW1lKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSA6IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJCXZhciBtZXRob2QgPSB0aGlzLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07CgkJcmV0dXJuIChtZXRob2QpID8gbWV0aG9kLmNhbGwobm9kZSkgOiBub2RlLmdldEF0dHJpYnV0ZShuYW1lKTsKCX07CgoJLy8gaGFzQXR0cmlidXRlCgoJZmVhdHVyZXMuaGFzQXR0cmlidXRlID0gKHJvb3QgJiYgdGhpcy5pc05hdGl2ZUNvZGUocm9vdC5oYXNBdHRyaWJ1dGUpKSA/IGZ1bmN0aW9uKG5vZGUsIGF0dHJpYnV0ZSkgewoJCXJldHVybiBub2RlLmhhc0F0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJfSA6IGZ1bmN0aW9uKG5vZGUsIGF0dHJpYnV0ZSkgewoJCW5vZGUgPSBub2RlLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKTsKCQlyZXR1cm4gISEobm9kZSAmJiAobm9kZS5zcGVjaWZpZWQgfHwgbm9kZS5ub2RlVmFsdWUpKTsKCX07CgoJLy8gY29udGFpbnMKCS8vIEZJWE1FOiBBZGQgc3BlY3M6IGxvY2FsLmNvbnRhaW5zIHNob3VsZCBiZSBkaWZmZXJlbnQgZm9yIHhtbCBhbmQgaHRtbCBkb2N1bWVudHM/Cgl2YXIgbmF0aXZlUm9vdENvbnRhaW5zID0gcm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290LmNvbnRhaW5zKSwKCQluYXRpdmVEb2N1bWVudENvbnRhaW5zID0gZG9jdW1lbnQgJiYgdGhpcy5pc05hdGl2ZUNvZGUoZG9jdW1lbnQuY29udGFpbnMpOwoKCWZlYXR1cmVzLmNvbnRhaW5zID0gKG5hdGl2ZVJvb3RDb250YWlucyAmJiBuYXRpdmVEb2N1bWVudENvbnRhaW5zKSA/IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCXJldHVybiBjb250ZXh0LmNvbnRhaW5zKG5vZGUpOwoJfSA6IChuYXRpdmVSb290Q29udGFpbnMgJiYgIW5hdGl2ZURvY3VtZW50Q29udGFpbnMpID8gZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJLy8gSUU4IGRvZXMgbm90IGhhdmUgLmNvbnRhaW5zIG9uIGRvY3VtZW50LgoJCXJldHVybiBjb250ZXh0ID09PSBub2RlIHx8ICgoY29udGV4dCA9PT0gZG9jdW1lbnQpID8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IDogY29udGV4dCkuY29udGFpbnMobm9kZSk7Cgl9IDogKHJvb3QgJiYgcm9vdC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlyZXR1cm4gY29udGV4dCA9PT0gbm9kZSB8fCAhIShjb250ZXh0LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5vZGUpICYgMTYpOwoJfSA6IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCWlmIChub2RlKSBkbyB7CgkJCWlmIChub2RlID09PSBjb250ZXh0KSByZXR1cm4gdHJ1ZTsKCQl9IHdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpOwoJCXJldHVybiBmYWxzZTsKCX07CgoJLy8gZG9jdW1lbnQgb3JkZXIgc29ydGluZwoJLy8gY3JlZGl0cyB0byBTaXp6bGUgKGh0dHA6Ly9zaXp6bGVqcy5jb20vKQoKCWZlYXR1cmVzLmRvY3VtZW50U29ydGVyID0gKHJvb3QuY29tcGFyZURvY3VtZW50UG9zaXRpb24pID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIHx8ICFiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSByZXR1cm4gMDsKCQlyZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSAmIDQgPyAtMSA6IGEgPT09IGIgPyAwIDogMTsKCX0gOiAoJ3NvdXJjZUluZGV4JyBpbiByb290KSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5zb3VyY2VJbmRleCB8fCAhYi5zb3VyY2VJbmRleCkgcmV0dXJuIDA7CgkJcmV0dXJuIGEuc291cmNlSW5kZXggLSBiLnNvdXJjZUluZGV4OwoJfSA6IChkb2N1bWVudC5jcmVhdGVSYW5nZSkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEub3duZXJEb2N1bWVudCB8fCAhYi5vd25lckRvY3VtZW50KSByZXR1cm4gMDsKCQl2YXIgYVJhbmdlID0gYS5vd25lckRvY3VtZW50LmNyZWF0ZVJhbmdlKCksIGJSYW5nZSA9IGIub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpOwoJCWFSYW5nZS5zZXRTdGFydChhLCAwKTsKCQlhUmFuZ2Uuc2V0RW5kKGEsIDApOwoJCWJSYW5nZS5zZXRTdGFydChiLCAwKTsKCQliUmFuZ2Uuc2V0RW5kKGIsIDApOwoJCXJldHVybiBhUmFuZ2UuY29tcGFyZUJvdW5kYXJ5UG9pbnRzKFJhbmdlLlNUQVJUX1RPX0VORCwgYlJhbmdlKTsKCX0gOiBudWxsIDsKCglyb290ID0gbnVsbDsKCglmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCXRoaXNbZmVhdHVyZV0gPSBmZWF0dXJlc1tmZWF0dXJlXTsKCX0KfTsKCi8vIE1haW4gTWV0aG9kCgp2YXIgcmVTaW1wbGVTZWxlY3RvciA9IC9eKFsjLl0/KSgoPzpbXHctXSt8XCopKSQvLAoJcmVFbXB0eUF0dHJpYnV0ZSA9IC9cWy4rWyokXl09KD86IiJ8JycpP1xdLywKCXFzYUZhaWxFeHBDYWNoZSA9IHt9OwoKbG9jYWwuc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kLCBmaXJzdCl7CgoJdmFyIGZvdW5kID0gdGhpcy5mb3VuZCA9IChmaXJzdCkgPyBudWxsIDogKGFwcGVuZCB8fCBbXSk7CgoJaWYgKCFjb250ZXh0KSByZXR1cm4gZm91bmQ7CgllbHNlIGlmIChjb250ZXh0Lm5hdmlnYXRvcikgY29udGV4dCA9IGNvbnRleHQuZG9jdW1lbnQ7IC8vIENvbnZlcnQgdGhlIG5vZGUgZnJvbSBhIHdpbmRvdyB0byBhIGRvY3VtZW50CgllbHNlIGlmICghY29udGV4dC5ub2RlVHlwZSkgcmV0dXJuIGZvdW5kOwoKCS8vIHNldHVwCgoJdmFyIHBhcnNlZCwgaSwKCQl1bmlxdWVzID0gdGhpcy51bmlxdWVzID0ge30sCgkJaGFzT3RoZXJzID0gISEoYXBwZW5kICYmIGFwcGVuZC5sZW5ndGgpLAoJCWNvbnRleHRJc0RvY3VtZW50ID0gKGNvbnRleHQubm9kZVR5cGUgPT0gOSk7CgoJaWYgKHRoaXMuZG9jdW1lbnQgIT09IChjb250ZXh0SXNEb2N1bWVudCA/IGNvbnRleHQgOiBjb250ZXh0Lm93bmVyRG9jdW1lbnQpKSB0aGlzLnNldERvY3VtZW50KGNvbnRleHQpOwoKCS8vIGF2b2lkIGR1cGxpY2F0aW5nIGl0ZW1zIGFscmVhZHkgaW4gdGhlIGFwcGVuZCBhcnJheQoJaWYgKGhhc090aGVycykgZm9yIChpID0gZm91bmQubGVuZ3RoOyBpLS07KSB1bmlxdWVzW3RoaXMuZ2V0VUlEKGZvdW5kW2ldKV0gPSB0cnVlOwoKCS8vIGV4cHJlc3Npb24gY2hlY2tzCgoJaWYgKHR5cGVvZiBleHByZXNzaW9uID09ICdzdHJpbmcnKXsgLy8gZXhwcmVzc2lvbiBpcyBhIHN0cmluZwoKCQkvKjxzaW1wbGUtc2VsZWN0b3JzLW92ZXJyaWRlPiovCgkJdmFyIHNpbXBsZVNlbGVjdG9yID0gZXhwcmVzc2lvbi5tYXRjaChyZVNpbXBsZVNlbGVjdG9yKTsKCQlzaW1wbGVTZWxlY3RvcnM6IGlmIChzaW1wbGVTZWxlY3RvcikgewoKCQkJdmFyIHN5bWJvbCA9IHNpbXBsZVNlbGVjdG9yWzFdLAoJCQkJbmFtZSA9IHNpbXBsZVNlbGVjdG9yWzJdLAoJCQkJbm9kZSwgbm9kZXM7CgoJCQlpZiAoIXN5bWJvbCl7CgoJCQkJaWYgKG5hbWUgPT0gJyonICYmIHRoaXMuYnJva2VuU3RhckdFQlROKSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlub2RlcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUobmFtZSk7CgkJCQlpZiAoZmlyc3QpIHJldHVybiBub2Rlc1swXSB8fCBudWxsOwoJCQkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJfQoKCQkJfSBlbHNlIGlmIChzeW1ib2wgPT0gJyMnKXsKCgkJCQlpZiAoIXRoaXMuaXNIVE1MRG9jdW1lbnQgfHwgIWNvbnRleHRJc0RvY3VtZW50KSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlub2RlID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChuYW1lKTsKCQkJCWlmICghbm9kZSkgcmV0dXJuIGZvdW5kOwoJCQkJaWYgKHRoaXMuaWRHZXRzTmFtZSAmJiBub2RlLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IG5hbWUpIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGUgfHwgbnVsbDsKCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgoJCQl9IGVsc2UgaWYgKHN5bWJvbCA9PSAnLicpewoKCQkJCWlmICghdGhpcy5pc0hUTUxEb2N1bWVudCB8fCAoKCFjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgdGhpcy5icm9rZW5HRUJDTikgJiYgY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKSkgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJaWYgKGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiAhdGhpcy5icm9rZW5HRUJDTil7CgkJCQkJbm9kZXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUobmFtZSk7CgkJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZXNbMF0gfHwgbnVsbDsKCQkJCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdmFyIG1hdGNoQ2xhc3MgPSBuZXcgUmVnRXhwKCcoXnxcXHMpJysgU2xpY2suZXNjYXBlUmVnRXhwKG5hbWUpICsnKFxcc3wkKScpOwoJCQkJCW5vZGVzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCQkJCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQkJCWNsYXNzTmFtZSA9IG5vZGUuY2xhc3NOYW1lOwoJCQkJCQlpZiAoIShjbGFzc05hbWUgJiYgbWF0Y2hDbGFzcy50ZXN0KGNsYXNzTmFtZSkpKSBjb250aW51ZTsKCQkJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZTsKCQkJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJCQl9CgkJCQl9CgoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gKGZpcnN0KSA/IG51bGwgOiBmb3VuZDsKCgkJfQoJCS8qPC9zaW1wbGUtc2VsZWN0b3JzLW92ZXJyaWRlPiovCgoJCS8qPHF1ZXJ5LXNlbGVjdG9yLW92ZXJyaWRlPiovCgkJcXVlcnlTZWxlY3RvcjogaWYgKGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCkgewoKCQkJaWYgKCF0aGlzLmlzSFRNTERvY3VtZW50CgkJCQl8fCBxc2FGYWlsRXhwQ2FjaGVbZXhwcmVzc2lvbl0KCQkJCS8vVE9ETzogb25seSBza2lwIHdoZW4gZXhwcmVzc2lvbiBpcyBhY3R1YWxseSBtaXhlZCBjYXNlCgkJCQl8fCB0aGlzLmJyb2tlbk1peGVkQ2FzZVFTQQoJCQkJfHwgKHRoaXMuYnJva2VuQ2hlY2tlZFFTQSAmJiBleHByZXNzaW9uLmluZGV4T2YoJzpjaGVja2VkJykgPiAtMSkKCQkJCXx8ICh0aGlzLmJyb2tlbkVtcHR5QXR0cmlidXRlUVNBICYmIHJlRW1wdHlBdHRyaWJ1dGUudGVzdChleHByZXNzaW9uKSkKCQkJCXx8ICghY29udGV4dElzRG9jdW1lbnQgLy9BYm9ydCB3aGVuICFjb250ZXh0SXNEb2N1bWVudCBhbmQuLi4KCQkJCQkvLyAgdGhlcmUgYXJlIG11bHRpcGxlIGV4cHJlc3Npb25zIGluIHRoZSBzZWxlY3RvcgoJCQkJCS8vICBzaW5jZSB3ZSBjdXJyZW50bHkgb25seSBmaXggbm9uLWRvY3VtZW50IHJvb3RlZCBRU0EgZm9yIHNpbmdsZSBleHByZXNzaW9uIHNlbGVjdG9ycwoJCQkJCSYmIGV4cHJlc3Npb24uaW5kZXhPZignLCcpID4gLTEKCQkJCSkKCQkJCXx8IFNsaWNrLmRpc2FibGVRU0EKCQkJKSBicmVhayBxdWVyeVNlbGVjdG9yOwoKCQkJdmFyIF9leHByZXNzaW9uID0gZXhwcmVzc2lvbiwgX2NvbnRleHQgPSBjb250ZXh0OwoJCQlpZiAoIWNvbnRleHRJc0RvY3VtZW50KXsKCQkJCS8vIG5vbi1kb2N1bWVudCByb290ZWQgUVNBCgkJCQkvLyBjcmVkaXRzIHRvIEFuZHJldyBEdXBvbnQKCQkJCXZhciBjdXJyZW50SWQgPSBfY29udGV4dC5nZXRBdHRyaWJ1dGUoJ2lkJyksIHNsaWNraWQgPSAnc2xpY2tpZF9fJzsKCQkJCV9jb250ZXh0LnNldEF0dHJpYnV0ZSgnaWQnLCBzbGlja2lkKTsKCQkJCV9leHByZXNzaW9uID0gJyMnICsgc2xpY2tpZCArICcgJyArIF9leHByZXNzaW9uOwoJCQkJY29udGV4dCA9IF9jb250ZXh0LnBhcmVudE5vZGU7CgkJCX0KCgkJCXRyeSB7CgkJCQlpZiAoZmlyc3QpIHJldHVybiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3IoX2V4cHJlc3Npb24pIHx8IG51bGw7CgkJCQllbHNlIG5vZGVzID0gY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKF9leHByZXNzaW9uKTsKCQkJfSBjYXRjaChlKSB7CgkJCQlxc2FGYWlsRXhwQ2FjaGVbZXhwcmVzc2lvbl0gPSAxOwoJCQkJYnJlYWsgcXVlcnlTZWxlY3RvcjsKCQkJfSBmaW5hbGx5IHsKCQkJCWlmICghY29udGV4dElzRG9jdW1lbnQpewoJCQkJCWlmIChjdXJyZW50SWQpIF9jb250ZXh0LnNldEF0dHJpYnV0ZSgnaWQnLCBjdXJyZW50SWQpOwoJCQkJCWVsc2UgX2NvbnRleHQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwoJCQkJCWNvbnRleHQgPSBfY29udGV4dDsKCQkJCX0KCQkJfQoKCQkJaWYgKHRoaXMuc3RhclNlbGVjdHNDbG9zZWRRU0EpIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQlpZiAobm9kZS5ub2RlTmFtZSA+ICdAJyAmJiAhKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCX0gZWxzZSBmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJfQoKCQkJaWYgKGhhc090aGVycykgdGhpcy5zb3J0KGZvdW5kKTsKCQkJcmV0dXJuIGZvdW5kOwoKCQl9CgkJLyo8L3F1ZXJ5LXNlbGVjdG9yLW92ZXJyaWRlPiovCgoJCXBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2UoZXhwcmVzc2lvbik7CgkJaWYgKCFwYXJzZWQubGVuZ3RoKSByZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24gPT0gbnVsbCl7IC8vIHRoZXJlIGlzIG5vIGV4cHJlc3Npb24KCQlyZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24uU2xpY2speyAvLyBleHByZXNzaW9uIGlzIGEgcGFyc2VkIFNsaWNrIG9iamVjdAoJCXBhcnNlZCA9IGV4cHJlc3Npb247Cgl9IGVsc2UgaWYgKHRoaXMuY29udGFpbnMoY29udGV4dC5kb2N1bWVudEVsZW1lbnQgfHwgY29udGV4dCwgZXhwcmVzc2lvbikpeyAvLyBleHByZXNzaW9uIGlzIGEgbm9kZQoJCShmb3VuZCkgPyBmb3VuZC5wdXNoKGV4cHJlc3Npb24pIDogZm91bmQgPSBleHByZXNzaW9uOwoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSB7IC8vIG90aGVyIGp1bmsKCQlyZXR1cm4gZm91bmQ7Cgl9CgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLy8gY2FjaGUgZWxlbWVudHMgZm9yIHRoZSBudGggc2VsZWN0b3JzCgoJdGhpcy5wb3NOVEggPSB7fTsKCXRoaXMucG9zTlRITGFzdCA9IHt9OwoJdGhpcy5wb3NOVEhUeXBlID0ge307Cgl0aGlzLnBvc05USFR5cGVMYXN0ID0ge307CgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBpZiBhcHBlbmQgaXMgbnVsbCBhbmQgdGhlcmUgaXMgb25seSBhIHNpbmdsZSBzZWxlY3RvciB3aXRoIG9uZSBleHByZXNzaW9uIHVzZSBwdXNoQXJyYXksIGVsc2UgdXNlIHB1c2hVSUQKCXRoaXMucHVzaCA9ICghaGFzT3RoZXJzICYmIChmaXJzdCB8fCAocGFyc2VkLmxlbmd0aCA9PSAxICYmIHBhcnNlZC5leHByZXNzaW9uc1swXS5sZW5ndGggPT0gMSkpKSA/IHRoaXMucHVzaEFycmF5IDogdGhpcy5wdXNoVUlEOwoKCWlmIChmb3VuZCA9PSBudWxsKSBmb3VuZCA9IFtdOwoKCS8vIGRlZmF1bHQgZW5naW5lCgoJdmFyIGosIG0sIG47Cgl2YXIgY29tYmluYXRvciwgdGFnLCBpZCwgY2xhc3NMaXN0LCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zOwoJdmFyIGN1cnJlbnRJdGVtcywgY3VycmVudEV4cHJlc3Npb24sIGN1cnJlbnRCaXQsIGxhc3RCaXQsIGV4cHJlc3Npb25zID0gcGFyc2VkLmV4cHJlc3Npb25zOwoKCXNlYXJjaDogZm9yIChpID0gMDsgKGN1cnJlbnRFeHByZXNzaW9uID0gZXhwcmVzc2lvbnNbaV0pOyBpKyspIGZvciAoaiA9IDA7IChjdXJyZW50Qml0ID0gY3VycmVudEV4cHJlc3Npb25bal0pOyBqKyspewoKCQljb21iaW5hdG9yID0gJ2NvbWJpbmF0b3I6JyArIGN1cnJlbnRCaXQuY29tYmluYXRvcjsKCQlpZiAoIXRoaXNbY29tYmluYXRvcl0pIGNvbnRpbnVlIHNlYXJjaDsKCgkJdGFnICAgICAgICA9ICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gY3VycmVudEJpdC50YWcgOiBjdXJyZW50Qml0LnRhZy50b1VwcGVyQ2FzZSgpOwoJCWlkICAgICAgICAgPSBjdXJyZW50Qml0LmlkOwoJCWNsYXNzTGlzdCAgPSBjdXJyZW50Qml0LmNsYXNzTGlzdDsKCQljbGFzc2VzICAgID0gY3VycmVudEJpdC5jbGFzc2VzOwoJCWF0dHJpYnV0ZXMgPSBjdXJyZW50Qml0LmF0dHJpYnV0ZXM7CgkJcHNldWRvcyAgICA9IGN1cnJlbnRCaXQucHNldWRvczsKCQlsYXN0Qml0ICAgID0gKGogPT09IChjdXJyZW50RXhwcmVzc2lvbi5sZW5ndGggLSAxKSk7CgoJCXRoaXMuYml0VW5pcXVlcyA9IHt9OwoKCQlpZiAobGFzdEJpdCl7CgkJCXRoaXMudW5pcXVlcyA9IHVuaXF1ZXM7CgkJCXRoaXMuZm91bmQgPSBmb3VuZDsKCQl9IGVsc2UgewoJCQl0aGlzLnVuaXF1ZXMgPSB7fTsKCQkJdGhpcy5mb3VuZCA9IFtdOwoJCX0KCgkJaWYgKGogPT09IDApewoJCQl0aGlzW2NvbWJpbmF0b3JdKGNvbnRleHQsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJCWlmIChmaXJzdCAmJiBsYXN0Qml0ICYmIGZvdW5kLmxlbmd0aCkgYnJlYWsgc2VhcmNoOwoJCX0gZWxzZSB7CgkJCWlmIChmaXJzdCAmJiBsYXN0Qml0KSBmb3IgKG0gPSAwLCBuID0gY3VycmVudEl0ZW1zLmxlbmd0aDsgbSA8IG47IG0rKyl7CgkJCQl0aGlzW2NvbWJpbmF0b3JdKGN1cnJlbnRJdGVtc1ttXSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQkJCWlmIChmb3VuZC5sZW5ndGgpIGJyZWFrIHNlYXJjaDsKCQkJfSBlbHNlIGZvciAobSA9IDAsIG4gPSBjdXJyZW50SXRlbXMubGVuZ3RoOyBtIDwgbjsgbSsrKSB0aGlzW2NvbWJpbmF0b3JdKGN1cnJlbnRJdGVtc1ttXSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQl9CgoJCWN1cnJlbnRJdGVtcyA9IHRoaXMuZm91bmQ7Cgl9CgoJLy8gc2hvdWxkIHNvcnQgaWYgdGhlcmUgYXJlIG5vZGVzIGluIGFwcGVuZCBhbmQgaWYgeW91IHBhc3MgbXVsdGlwbGUgZXhwcmVzc2lvbnMuCglpZiAoaGFzT3RoZXJzIHx8IChwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoID4gMSkpIHRoaXMuc29ydChmb3VuZCk7CgoJcmV0dXJuIChmaXJzdCkgPyAoZm91bmRbMF0gfHwgbnVsbCkgOiBmb3VuZDsKfTsKCi8vIFV0aWxzCgpsb2NhbC51aWR4ID0gMTsKbG9jYWwudWlkayA9ICdzbGljay11bmlxdWVpZCc7Cgpsb2NhbC5nZXRVSURYTUwgPSBmdW5jdGlvbihub2RlKXsKCXZhciB1aWQgPSBub2RlLmdldEF0dHJpYnV0ZSh0aGlzLnVpZGspOwoJaWYgKCF1aWQpewoJCXVpZCA9IHRoaXMudWlkeCsrOwoJCW5vZGUuc2V0QXR0cmlidXRlKHRoaXMudWlkaywgdWlkKTsKCX0KCXJldHVybiB1aWQ7Cn07Cgpsb2NhbC5nZXRVSURIVE1MID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbm9kZS51bmlxdWVOdW1iZXIgfHwgKG5vZGUudW5pcXVlTnVtYmVyID0gdGhpcy51aWR4KyspOwp9OwoKLy8gc29ydCBiYXNlZCBvbiB0aGUgc2V0RG9jdW1lbnQgZG9jdW1lbnRTb3J0ZXIgbWV0aG9kLgoKbG9jYWwuc29ydCA9IGZ1bmN0aW9uKHJlc3VsdHMpewoJaWYgKCF0aGlzLmRvY3VtZW50U29ydGVyKSByZXR1cm4gcmVzdWx0czsKCXJlc3VsdHMuc29ydCh0aGlzLmRvY3VtZW50U29ydGVyKTsKCXJldHVybiByZXN1bHRzOwp9OwoKLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgpsb2NhbC5jYWNoZU5USCA9IHt9OwoKbG9jYWwubWF0Y2hOVEggPSAvXihbKy1dP1xkKik/KFthLXpdKyk/KFsrLV1cZCspPyQvOwoKbG9jYWwucGFyc2VOVEhBcmd1bWVudCA9IGZ1bmN0aW9uKGFyZ3VtZW50KXsKCXZhciBwYXJzZWQgPSBhcmd1bWVudC5tYXRjaCh0aGlzLm1hdGNoTlRIKTsKCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7Cgl2YXIgc3BlY2lhbCA9IHBhcnNlZFsyXSB8fCBmYWxzZTsKCXZhciBhID0gcGFyc2VkWzFdIHx8IDE7CglpZiAoYSA9PSAnLScpIGEgPSAtMTsKCXZhciBiID0gK3BhcnNlZFszXSB8fCAwOwoJcGFyc2VkID0KCQkoc3BlY2lhbCA9PSAnbicpCT8ge2E6IGEsIGI6IGJ9IDoKCQkoc3BlY2lhbCA9PSAnb2RkJykJPyB7YTogMiwgYjogMX0gOgoJCShzcGVjaWFsID09ICdldmVuJykJPyB7YTogMiwgYjogMH0gOiB7YTogMCwgYjogYX07CgoJcmV0dXJuICh0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSA9IHBhcnNlZCk7Cn07Cgpsb2NhbC5jcmVhdGVOVEhQc2V1ZG8gPSBmdW5jdGlvbihjaGlsZCwgc2libGluZywgcG9zaXRpb25zLCBvZlR5cGUpewoJcmV0dXJuIGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJaWYgKCF0aGlzW3Bvc2l0aW9uc11bdWlkXSl7CgkJCXZhciBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CgkJCWlmICghcGFyZW50KSByZXR1cm4gZmFsc2U7CgkJCXZhciBlbCA9IHBhcmVudFtjaGlsZF0sIGNvdW50ID0gMTsKCQkJaWYgKG9mVHlwZSl7CgkJCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlTmFtZSAhPSBub2RlTmFtZSkgY29udGludWU7CgkJCQkJdGhpc1twb3NpdGlvbnNdW3RoaXMuZ2V0VUlEKGVsKV0gPSBjb3VudCsrOwoJCQkJfSB3aGlsZSAoKGVsID0gZWxbc2libGluZ10pKTsKCQkJfSBlbHNlIHsKCQkJCWRvIHsKCQkJCQlpZiAoZWwubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCQkJdGhpc1twb3NpdGlvbnNdW3RoaXMuZ2V0VUlEKGVsKV0gPSBjb3VudCsrOwoJCQkJfSB3aGlsZSAoKGVsID0gZWxbc2libGluZ10pKTsKCQkJfQoJCX0KCQlhcmd1bWVudCA9IGFyZ3VtZW50IHx8ICduJzsKCQl2YXIgcGFyc2VkID0gdGhpcy5jYWNoZU5USFthcmd1bWVudF0gfHwgdGhpcy5wYXJzZU5USEFyZ3VtZW50KGFyZ3VtZW50KTsKCQlpZiAoIXBhcnNlZCkgcmV0dXJuIGZhbHNlOwoJCXZhciBhID0gcGFyc2VkLmEsIGIgPSBwYXJzZWQuYiwgcG9zID0gdGhpc1twb3NpdGlvbnNdW3VpZF07CgkJaWYgKGEgPT0gMCkgcmV0dXJuIGIgPT0gcG9zOwoJCWlmIChhID4gMCl7CgkJCWlmIChwb3MgPCBiKSByZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJaWYgKGIgPCBwb3MpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuICgocG9zIC0gYikgJSBhKSA9PSAwOwoJfTsKfTsKCi8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLy8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCgpsb2NhbC5wdXNoQXJyYXkgPSBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsKCWlmICh0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpIHRoaXMuZm91bmQucHVzaChub2RlKTsKfTsKCmxvY2FsLnB1c2hVSUQgPSBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsKCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCWlmICghdGhpcy51bmlxdWVzW3VpZF0gJiYgdGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpKXsKCQl0aGlzLnVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwoJfQp9OwoKbG9jYWwubWF0Y2hOb2RlID0gZnVuY3Rpb24obm9kZSwgc2VsZWN0b3IpewoJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQgJiYgdGhpcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IpewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLm5hdGl2ZU1hdGNoZXNTZWxlY3Rvci5jYWxsKG5vZGUsIHNlbGVjdG9yLnJlcGxhY2UoL1xbKFtePV0rKT1ccyooW14nIlxdXSs/KVxzKlxdL2csICdbJDE9IiQyIl0nKSk7CgkJfSBjYXRjaChtYXRjaEVycm9yKSB7fQoJfQoKCXZhciBwYXJzZWQgPSB0aGlzLlNsaWNrLnBhcnNlKHNlbGVjdG9yKTsKCWlmICghcGFyc2VkKSByZXR1cm4gdHJ1ZTsKCgkvLyBzaW1wbGUgKHNpbmdsZSkgc2VsZWN0b3JzCgl2YXIgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnMsIHNpbXBsZUV4cENvdW50ZXIgPSAwLCBpOwoJZm9yIChpID0gMDsgKGN1cnJlbnRFeHByZXNzaW9uID0gZXhwcmVzc2lvbnNbaV0pOyBpKyspewoJCWlmIChjdXJyZW50RXhwcmVzc2lvbi5sZW5ndGggPT0gMSl7CgkJCXZhciBleHAgPSBjdXJyZW50RXhwcmVzc2lvblswXTsKCQkJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCAodGhpcy5pc1hNTERvY3VtZW50KSA/IGV4cC50YWcgOiBleHAudGFnLnRvVXBwZXJDYXNlKCksIGV4cC5pZCwgZXhwLmNsYXNzZXMsIGV4cC5hdHRyaWJ1dGVzLCBleHAucHNldWRvcykpIHJldHVybiB0cnVlOwoJCQlzaW1wbGVFeHBDb3VudGVyKys7CgkJfQoJfQoKCWlmIChzaW1wbGVFeHBDb3VudGVyID09IHBhcnNlZC5sZW5ndGgpIHJldHVybiBmYWxzZTsKCgl2YXIgbm9kZXMgPSB0aGlzLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBwYXJzZWQpLCBpdGVtOwoJZm9yIChpID0gMDsgaXRlbSA9IG5vZGVzW2krK107KXsKCQlpZiAoaXRlbSA9PT0gbm9kZSkgcmV0dXJuIHRydWU7Cgl9CglyZXR1cm4gZmFsc2U7Cn07Cgpsb2NhbC5tYXRjaFBzZXVkbyA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUsIGFyZ3VtZW50KXsKCXZhciBwc2V1ZG9OYW1lID0gJ3BzZXVkbzonICsgbmFtZTsKCWlmICh0aGlzW3BzZXVkb05hbWVdKSByZXR1cm4gdGhpc1twc2V1ZG9OYW1lXShub2RlLCBhcmd1bWVudCk7Cgl2YXIgYXR0cmlidXRlID0gdGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSk7CglyZXR1cm4gKGFyZ3VtZW50KSA/IGFyZ3VtZW50ID09IGF0dHJpYnV0ZSA6ICEhYXR0cmlidXRlOwp9OwoKbG9jYWwubWF0Y2hTZWxlY3RvciA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRhZyl7CgkJdmFyIG5vZGVOYW1lID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBub2RlLm5vZGVOYW1lIDogbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpOwoJCWlmICh0YWcgPT0gJyonKXsKCQkJaWYgKG5vZGVOYW1lIDwgJ0AnKSByZXR1cm4gZmFsc2U7IC8vIEZpeCBmb3IgY29tbWVudCBub2RlcyBhbmQgY2xvc2VkIG5vZGVzCgkJfSBlbHNlIHsKCQkJaWYgKG5vZGVOYW1lICE9IHRhZykgcmV0dXJuIGZhbHNlOwoJCX0KCX0KCglpZiAoaWQgJiYgbm9kZS5nZXRBdHRyaWJ1dGUoJ2lkJykgIT0gaWQpIHJldHVybiBmYWxzZTsKCgl2YXIgaSwgcGFydCwgY2xzOwoJaWYgKGNsYXNzZXMpIGZvciAoaSA9IGNsYXNzZXMubGVuZ3RoOyBpLS07KXsKCQljbHMgPSB0aGlzLmdldEF0dHJpYnV0ZShub2RlLCAnY2xhc3MnKTsKCQlpZiAoIShjbHMgJiYgY2xhc3Nlc1tpXS5yZWdleHAudGVzdChjbHMpKSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKGF0dHJpYnV0ZXMpIGZvciAoaSA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gYXR0cmlidXRlc1tpXTsKCQlpZiAocGFydC5vcGVyYXRvciA/ICFwYXJ0LnRlc3QodGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgcGFydC5rZXkpKSA6ICF0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIHJldHVybiBmYWxzZTsKCX0KCWlmIChwc2V1ZG9zKSBmb3IgKGkgPSBwc2V1ZG9zLmxlbmd0aDsgaS0tOyl7CgkJcGFydCA9IHBzZXVkb3NbaV07CgkJaWYgKCF0aGlzLm1hdGNoUHNldWRvKG5vZGUsIHBhcnQua2V5LCBwYXJ0LnZhbHVlKSkgcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn07Cgp2YXIgY29tYmluYXRvcnMgPSB7CgoJJyAnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpeyAvLyBhbGwgY2hpbGQgbm9kZXMsIGFueSBsZXZlbAoKCQl2YXIgaSwgaXRlbSwgY2hpbGRyZW47CgoJCWlmICh0aGlzLmlzSFRNTERvY3VtZW50KXsKCQkJZ2V0QnlJZDogaWYgKGlkKXsKCQkJCWl0ZW0gPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCQkJCWlmICgoIWl0ZW0gJiYgbm9kZS5hbGwpIHx8ICh0aGlzLmlkR2V0c05hbWUgJiYgaXRlbSAmJiBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSl7CgkJCQkJLy8gYWxsW2lkXSByZXR1cm5zIGFsbCB0aGUgZWxlbWVudHMgd2l0aCB0aGF0IG5hbWUgb3IgaWQgaW5zaWRlIG5vZGUKCQkJCQkvLyBpZiB0aGVyZXMganVzdCBvbmUgaXQgd2lsbCByZXR1cm4gdGhlIGVsZW1lbnQsIGVsc2UgaXQgd2lsbCBiZSBhIGNvbGxlY3Rpb24KCQkJCQljaGlsZHJlbiA9IG5vZGUuYWxsW2lkXTsKCQkJCQlpZiAoIWNoaWxkcmVuKSByZXR1cm47CgkJCQkJaWYgKCFjaGlsZHJlblswXSkgY2hpbGRyZW4gPSBbY2hpbGRyZW5dOwoJCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOyl7CgkJCQkJCXZhciBpZE5vZGUgPSBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJyk7CgkJCQkJCWlmIChpZE5vZGUgJiYgaWROb2RlLm5vZGVWYWx1ZSA9PSBpZCl7CgkJCQkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghaXRlbSl7CgkJCQkJLy8gaWYgdGhlIGNvbnRleHQgaXMgaW4gdGhlIGRvbSB3ZSByZXR1cm4sIGVsc2Ugd2Ugd2lsbCB0cnkgR0VCVE4sIGJyZWFraW5nIHRoZSBnZXRCeUlkIGxhYmVsCgkJCQkJaWYgKHRoaXMuY29udGFpbnModGhpcy5yb290LCBub2RlKSkgcmV0dXJuOwoJCQkJCWVsc2UgYnJlYWsgZ2V0QnlJZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5kb2N1bWVudCAhPT0gbm9kZSAmJiAhdGhpcy5jb250YWlucyhub2RlLCBpdGVtKSkgcmV0dXJuOwoJCQkJdGhpcy5wdXNoKGl0ZW0sIHRhZywgbnVsbCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQkJZ2V0QnlDbGFzczogaWYgKGNsYXNzZXMgJiYgbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTGlzdC5qb2luKCcgJykpOwoJCQkJaWYgKCEoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSkgYnJlYWsgZ2V0QnlDbGFzczsKCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgdGhpcy5wdXNoKGl0ZW0sIHRhZywgaWQsIG51bGwsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoJCWdldEJ5VGFnOiB7CgkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwoJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeVRhZzsKCQkJaWYgKCF0aGlzLmJyb2tlblN0YXJHRUJUTikgdGFnID0gbnVsbDsKCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgY2hpbGRyZW4KCQlpZiAoKG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQpKSBkbyB7CgkJCWlmIChub2RlLm5vZGVUeXBlID09IDEpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9IHdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKTsKCX0sCgoJJysnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5nCgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJ14nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZmlyc3QgY2hpbGQKCQlub2RlID0gbm9kZS5maXJzdENoaWxkOwoJCWlmIChub2RlKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJ34nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQkJaWYgKHRoaXMuYml0VW5pcXVlc1t1aWRdKSBicmVhazsKCQkJdGhpcy5iaXRVbmlxdWVzW3VpZF0gPSB0cnVlOwoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknKysnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5nIGFuZCBwcmV2aW91cyBzaWJsaW5nCgkJdGhpc1snY29tYmluYXRvcjorJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJdGhpc1snY29tYmluYXRvcjohKyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknfn4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncyBhbmQgcHJldmlvdXMgc2libGluZ3MKCQl0aGlzWydjb21iaW5hdG9yOn4nXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl0aGlzWydjb21iaW5hdG9yOiF+J10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGFsbCBwYXJlbnQgbm9kZXMgdXAgdG8gZG9jdW1lbnQKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnBhcmVudE5vZGUpKSBpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknIT4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZGlyZWN0IHBhcmVudCAob25lIGxldmVsKQoJCW5vZGUgPSBub2RlLnBhcmVudE5vZGU7CgkJaWYgKG5vZGUgIT09IHRoaXMuZG9jdW1lbnQpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJyErJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIHByZXZpb3VzIHNpYmxpbmcKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJyFeJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGxhc3QgY2hpbGQKCQlub2RlID0gbm9kZS5sYXN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWVsc2UgdGhpc1snY29tYmluYXRvcjohKyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJyF+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIHByZXZpb3VzIHNpYmxpbmdzCgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQkJaWYgKHRoaXMuYml0VW5pcXVlc1t1aWRdKSBicmVhazsKCQkJdGhpcy5iaXRVbmlxdWVzW3VpZF0gPSB0cnVlOwoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfQoKfTsKCmZvciAodmFyIGMgaW4gY29tYmluYXRvcnMpIGxvY2FsWydjb21iaW5hdG9yOicgKyBjXSA9IGNvbWJpbmF0b3JzW2NdOwoKdmFyIHBzZXVkb3MgPSB7CgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLwoKCSdlbXB0eSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBjaGlsZCA9IG5vZGUuZmlyc3RDaGlsZDsKCQlyZXR1cm4gIShjaGlsZCAmJiBjaGlsZC5ub2RlVHlwZSA9PSAxKSAmJiAhKG5vZGUuaW5uZXJUZXh0IHx8IG5vZGUudGV4dENvbnRlbnQgfHwgJycpLmxlbmd0aDsKCX0sCgoJJ25vdCc6IGZ1bmN0aW9uKG5vZGUsIGV4cHJlc3Npb24pewoJCXJldHVybiAhdGhpcy5tYXRjaE5vZGUobm9kZSwgZXhwcmVzc2lvbik7Cgl9LAoKCSdjb250YWlucyc6IGZ1bmN0aW9uKG5vZGUsIHRleHQpewoJCXJldHVybiAobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykuaW5kZXhPZih0ZXh0KSA+IC0xOwoJfSwKCgknZmlyc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknb25seS1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBwcmV2ID0gbm9kZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQl2YXIgbmV4dCA9IG5vZGU7CgkJd2hpbGUgKChuZXh0ID0gbmV4dC5uZXh0U2libGluZykpIGlmIChuZXh0Lm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgknbnRoLWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USCcpLAoKCSdudGgtbGFzdC1jaGlsZCc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhMYXN0JyksCgoJJ250aC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USFR5cGUnLCB0cnVlKSwKCgknbnRoLWxhc3Qtb2YtdHlwZSc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhUeXBlTGFzdCcsIHRydWUpLAoKCSdpbmRleCc6IGZ1bmN0aW9uKG5vZGUsIGluZGV4KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcnICsgKGluZGV4ICsgMSkpOwoJfSwKCgknZXZlbic6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJzJuJyk7Cgl9LAoKCSdvZGQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcybisxJyk7Cgl9LAoKCS8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8qPG9mLXR5cGUtcHNldWRvLXNlbGVjdG9ycz4qLwoKCSdmaXJzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdsYXN0LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknb25seS1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIHByZXYgPSBub2RlLCBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJd2hpbGUgKChwcmV2ID0gcHJldi5wcmV2aW91c1NpYmxpbmcpKSBpZiAocHJldi5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8L29mLXR5cGUtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8vIGN1c3RvbSBwc2V1ZG9zCgoJJ2VuYWJsZWQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gIW5vZGUuZGlzYWJsZWQ7Cgl9LAoKCSdkaXNhYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLmRpc2FibGVkOwoJfSwKCgknY2hlY2tlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLmNoZWNrZWQgfHwgbm9kZS5zZWxlY3RlZDsKCX0sCgoJJ2ZvY3VzJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIHRoaXMuaXNIVE1MRG9jdW1lbnQgJiYgdGhpcy5kb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSBub2RlICYmIChub2RlLmhyZWYgfHwgbm9kZS50eXBlIHx8IHRoaXMuaGFzQXR0cmlidXRlKG5vZGUsICd0YWJpbmRleCcpKTsKCX0sCgoJJ3Jvb3QnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gKG5vZGUgPT09IHRoaXMucm9vdCk7Cgl9LAoKCSdzZWxlY3RlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLnNlbGVjdGVkOwoJfQoKCS8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCn07Cgpmb3IgKHZhciBwIGluIHBzZXVkb3MpIGxvY2FsWydwc2V1ZG86JyArIHBdID0gcHNldWRvc1twXTsKCi8vIGF0dHJpYnV0ZXMgbWV0aG9kcwoKdmFyIGF0dHJpYnV0ZUdldHRlcnMgPSBsb2NhbC5hdHRyaWJ1dGVHZXR0ZXJzID0gewoKCSdmb3InOiBmdW5jdGlvbigpewoJCXJldHVybiAoJ2h0bWxGb3InIGluIHRoaXMpID8gdGhpcy5odG1sRm9yIDogdGhpcy5nZXRBdHRyaWJ1dGUoJ2ZvcicpOwoJfSwKCgknaHJlZic6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICgnaHJlZicgaW4gdGhpcykgPyB0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicsIDIpIDogdGhpcy5nZXRBdHRyaWJ1dGUoJ2hyZWYnKTsKCX0sCgoJJ3N0eWxlJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMuc3R5bGUpID8gdGhpcy5zdHlsZS5jc3NUZXh0IDogdGhpcy5nZXRBdHRyaWJ1dGUoJ3N0eWxlJyk7Cgl9LAoKCSd0YWJpbmRleCc6IGZ1bmN0aW9uKCl7CgkJdmFyIGF0dHJpYnV0ZU5vZGUgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoJ3RhYmluZGV4Jyk7CgkJcmV0dXJuIChhdHRyaWJ1dGVOb2RlICYmIGF0dHJpYnV0ZU5vZGUuc3BlY2lmaWVkKSA/IGF0dHJpYnV0ZU5vZGUubm9kZVZhbHVlIDogbnVsbDsKCX0sCgoJJ3R5cGUnOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgndHlwZScpOwoJfSwKCgknbWF4bGVuZ3RoJzogZnVuY3Rpb24oKXsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgnbWF4TGVuZ3RoJyk7CgkJcmV0dXJuIChhdHRyaWJ1dGVOb2RlICYmIGF0dHJpYnV0ZU5vZGUuc3BlY2lmaWVkKSA/IGF0dHJpYnV0ZU5vZGUubm9kZVZhbHVlIDogbnVsbDsKCX0KCn07CgphdHRyaWJ1dGVHZXR0ZXJzLk1BWExFTkdUSCA9IGF0dHJpYnV0ZUdldHRlcnMubWF4TGVuZ3RoID0gYXR0cmlidXRlR2V0dGVycy5tYXhsZW5ndGg7CgovLyBTbGljawoKdmFyIFNsaWNrID0gbG9jYWwuU2xpY2sgPSAodGhpcy5TbGljayB8fCB7fSk7CgpTbGljay52ZXJzaW9uID0gJzEuMS43JzsKCi8vIFNsaWNrIGZpbmRlcgoKU2xpY2suc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kKXsKCXJldHVybiBsb2NhbC5zZWFyY2goY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kKTsKfTsKClNsaWNrLmZpbmQgPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uKXsKCXJldHVybiBsb2NhbC5zZWFyY2goY29udGV4dCwgZXhwcmVzc2lvbiwgbnVsbCwgdHJ1ZSk7Cn07CgovLyBTbGljayBjb250YWlubWVudCBjaGVja2VyCgpTbGljay5jb250YWlucyA9IGZ1bmN0aW9uKGNvbnRhaW5lciwgbm9kZSl7Cglsb2NhbC5zZXREb2N1bWVudChjb250YWluZXIpOwoJcmV0dXJuIGxvY2FsLmNvbnRhaW5zKGNvbnRhaW5lciwgbm9kZSk7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgZ2V0dGVyCgpTbGljay5nZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbihub2RlLCBuYW1lKXsKCWxvY2FsLnNldERvY3VtZW50KG5vZGUpOwoJcmV0dXJuIGxvY2FsLmdldEF0dHJpYnV0ZShub2RlLCBuYW1lKTsKfTsKClNsaWNrLmhhc0F0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJbG9jYWwuc2V0RG9jdW1lbnQobm9kZSk7CglyZXR1cm4gbG9jYWwuaGFzQXR0cmlidXRlKG5vZGUsIG5hbWUpOwp9OwoKLy8gU2xpY2sgbWF0Y2hlcgoKU2xpY2subWF0Y2ggPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CglpZiAoIShub2RlICYmIHNlbGVjdG9yKSkgcmV0dXJuIGZhbHNlOwoJaWYgKCFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gbm9kZSkgcmV0dXJuIHRydWU7Cglsb2NhbC5zZXREb2N1bWVudChub2RlKTsKCXJldHVybiBsb2NhbC5tYXRjaE5vZGUobm9kZSwgc2VsZWN0b3IpOwp9OwoKLy8gU2xpY2sgYXR0cmlidXRlIGFjY2Vzc29yCgpTbGljay5kZWZpbmVBdHRyaWJ1dGVHZXR0ZXIgPSBmdW5jdGlvbihuYW1lLCBmbil7Cglsb2NhbC5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdID0gZm47CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmxvb2t1cEF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUpewoJcmV0dXJuIGxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07Cn07CgovLyBTbGljayBwc2V1ZG8gYWNjZXNzb3IKClNsaWNrLmRlZmluZVBzZXVkbyA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsWydwc2V1ZG86JyArIG5hbWVdID0gZnVuY3Rpb24obm9kZSwgYXJndW1lbnQpewoJCXJldHVybiBmbi5jYWxsKG5vZGUsIGFyZ3VtZW50KTsKCX07CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmxvb2t1cFBzZXVkbyA9IGZ1bmN0aW9uKG5hbWUpewoJdmFyIHBzZXVkbyA9IGxvY2FsWydwc2V1ZG86JyArIG5hbWVdOwoJaWYgKHBzZXVkbykgcmV0dXJuIGZ1bmN0aW9uKGFyZ3VtZW50KXsKCQlyZXR1cm4gcHNldWRvLmNhbGwodGhpcywgYXJndW1lbnQpOwoJfTsKCXJldHVybiBudWxsOwp9OwoKLy8gU2xpY2sgb3ZlcnJpZGVzIGFjY2Vzc29yCgpTbGljay5vdmVycmlkZSA9IGZ1bmN0aW9uKHJlZ2V4cCwgZm4pewoJbG9jYWwub3ZlcnJpZGUocmVnZXhwLCBmbik7CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmlzWE1MID0gbG9jYWwuaXNYTUw7CgpTbGljay51aWRPZiA9IGZ1bmN0aW9uKG5vZGUpewoJcmV0dXJuIGxvY2FsLmdldFVJREhUTUwobm9kZSk7Cn07CgppZiAoIXRoaXMuU2xpY2spIHRoaXMuU2xpY2sgPSBTbGljazsKCn0pLmFwcGx5KC8qPENvbW1vbkpTPiovKHR5cGVvZiBleHBvcnRzICE9ICd1bmRlZmluZWQnKSA/IGV4cG9ydHMgOiAvKjwvQ29tbW9uSlM+Ki90aGlzKTsKCgovKgotLS0KCm5hbWU6IEVsZW1lbnQKCmRlc2NyaXB0aW9uOiBPbmUgb2YgdGhlIG1vc3QgaW1wb3J0YW50IGl0ZW1zIGluIE1vb1Rvb2xzLiBDb250YWlucyB0aGUgZG9sbGFyIGZ1bmN0aW9uLCB0aGUgZG9sbGFycyBmdW5jdGlvbiwgYW5kIGFuIGhhbmRmdWwgb2YgY3Jvc3MtYnJvd3NlciwgdGltZS1zYXZlciBtZXRob2RzIHRvIGxldCB5b3UgZWFzaWx5IHdvcmsgd2l0aCBIVE1MIEVsZW1lbnRzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW1dpbmRvdywgRG9jdW1lbnQsIEFycmF5LCBTdHJpbmcsIEZ1bmN0aW9uLCBPYmplY3QsIE51bWJlciwgU2xpY2suUGFyc2VyLCBTbGljay5GaW5kZXJdCgpwcm92aWRlczogW0VsZW1lbnQsIEVsZW1lbnRzLCAkLCAkJCwgSWZyYW1lLCBTZWxlY3RvcnNdCgouLi4KKi8KCnZhciBFbGVtZW50ID0gZnVuY3Rpb24odGFnLCBwcm9wcyl7Cgl2YXIga29uc3RydWN0b3IgPSBFbGVtZW50LkNvbnN0cnVjdG9yc1t0YWddOwoJaWYgKGtvbnN0cnVjdG9yKSByZXR1cm4ga29uc3RydWN0b3IocHJvcHMpOwoJaWYgKHR5cGVvZiB0YWcgIT0gJ3N0cmluZycpIHJldHVybiBkb2N1bWVudC5pZCh0YWcpLnNldChwcm9wcyk7CgoJaWYgKCFwcm9wcykgcHJvcHMgPSB7fTsKCglpZiAoISgvXltcdy1dKyQvKS50ZXN0KHRhZykpewoJCXZhciBwYXJzZWQgPSBTbGljay5wYXJzZSh0YWcpLmV4cHJlc3Npb25zWzBdWzBdOwoJCXRhZyA9IChwYXJzZWQudGFnID09ICcqJykgPyAnZGl2JyA6IHBhcnNlZC50YWc7CgkJaWYgKHBhcnNlZC5pZCAmJiBwcm9wcy5pZCA9PSBudWxsKSBwcm9wcy5pZCA9IHBhcnNlZC5pZDsKCgkJdmFyIGF0dHJpYnV0ZXMgPSBwYXJzZWQuYXR0cmlidXRlczsKCQlpZiAoYXR0cmlidXRlcykgZm9yICh2YXIgYXR0ciwgaSA9IDAsIGwgPSBhdHRyaWJ1dGVzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWF0dHIgPSBhdHRyaWJ1dGVzW2ldOwoJCQlpZiAocHJvcHNbYXR0ci5rZXldICE9IG51bGwpIGNvbnRpbnVlOwoKCQkJaWYgKGF0dHIudmFsdWUgIT0gbnVsbCAmJiBhdHRyLm9wZXJhdG9yID09ICc9JykgcHJvcHNbYXR0ci5rZXldID0gYXR0ci52YWx1ZTsKCQkJZWxzZSBpZiAoIWF0dHIudmFsdWUgJiYgIWF0dHIub3BlcmF0b3IpIHByb3BzW2F0dHIua2V5XSA9IHRydWU7CgkJfQoKCQlpZiAocGFyc2VkLmNsYXNzTGlzdCAmJiBwcm9wc1snY2xhc3MnXSA9PSBudWxsKSBwcm9wc1snY2xhc3MnXSA9IHBhcnNlZC5jbGFzc0xpc3Quam9pbignICcpOwoJfQoKCXJldHVybiBkb2N1bWVudC5uZXdFbGVtZW50KHRhZywgcHJvcHMpOwp9OwoKCmlmIChCcm93c2VyLkVsZW1lbnQpewoJRWxlbWVudC5wcm90b3R5cGUgPSBCcm93c2VyLkVsZW1lbnQucHJvdG90eXBlOwoJLy8gSUU4IGFuZCBJRTkgcmVxdWlyZSB0aGUgd3JhcHBpbmcuCglFbGVtZW50LnByb3RvdHlwZS5fZmlyZUV2ZW50ID0gKGZ1bmN0aW9uKGZpcmVFdmVudCl7CgkJcmV0dXJuIGZ1bmN0aW9uKHR5cGUsIGV2ZW50KXsKCQkJcmV0dXJuIGZpcmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIGV2ZW50KTsKCQl9OwoJfSkoRWxlbWVudC5wcm90b3R5cGUuZmlyZUV2ZW50KTsKfQoKbmV3IFR5cGUoJ0VsZW1lbnQnLCBFbGVtZW50KS5taXJyb3IoZnVuY3Rpb24obmFtZSl7CglpZiAoQXJyYXkucHJvdG90eXBlW25hbWVdKSByZXR1cm47CgoJdmFyIG9iaiA9IHt9OwoJb2JqW25hbWVdID0gZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0cyA9IFtdLCBhcmdzID0gYXJndW1lbnRzLCBlbGVtZW50cyA9IHRydWU7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBlbGVtZW50ID0gdGhpc1tpXSwgcmVzdWx0ID0gcmVzdWx0c1tpXSA9IGVsZW1lbnRbbmFtZV0uYXBwbHkoZWxlbWVudCwgYXJncyk7CgkJCWVsZW1lbnRzID0gKGVsZW1lbnRzICYmIHR5cGVPZihyZXN1bHQpID09ICdlbGVtZW50Jyk7CgkJfQoJCXJldHVybiAoZWxlbWVudHMpID8gbmV3IEVsZW1lbnRzKHJlc3VsdHMpIDogcmVzdWx0czsKCX07CgoJRWxlbWVudHMuaW1wbGVtZW50KG9iaik7Cn0pOwoKaWYgKCFCcm93c2VyLkVsZW1lbnQpewoJRWxlbWVudC5wYXJlbnQgPSBPYmplY3Q7CgoJRWxlbWVudC5Qcm90b3R5cGUgPSB7CgkJJyRjb25zdHJ1Y3Rvcic6IEVsZW1lbnQsCgkJJyRmYW1pbHknOiBGdW5jdGlvbi5mcm9tKCdlbGVtZW50JykuaGlkZSgpCgl9OwoKCUVsZW1lbnQubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7CgkJRWxlbWVudC5Qcm90b3R5cGVbbmFtZV0gPSBtZXRob2Q7Cgl9KTsKfQoKRWxlbWVudC5Db25zdHJ1Y3RvcnMgPSB7fTsKCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuQ29uc3RydWN0b3JzID0gbmV3IEhhc2g7CgovLzwvMS4yY29tcGF0PgoKdmFyIElGcmFtZSA9IG5ldyBUeXBlKCdJRnJhbWUnLCBmdW5jdGlvbigpewoJdmFyIHBhcmFtcyA9IEFycmF5LmxpbmsoYXJndW1lbnRzLCB7CgkJcHJvcGVydGllczogVHlwZS5pc09iamVjdCwKCQlpZnJhbWU6IGZ1bmN0aW9uKG9iail7CgkJCXJldHVybiAob2JqICE9IG51bGwpOwoJCX0KCX0pOwoKCXZhciBwcm9wcyA9IHBhcmFtcy5wcm9wZXJ0aWVzIHx8IHt9LCBpZnJhbWU7CglpZiAocGFyYW1zLmlmcmFtZSkgaWZyYW1lID0gZG9jdW1lbnQuaWQocGFyYW1zLmlmcmFtZSk7Cgl2YXIgb25sb2FkID0gcHJvcHMub25sb2FkIHx8IGZ1bmN0aW9uKCl7fTsKCWRlbGV0ZSBwcm9wcy5vbmxvYWQ7Cglwcm9wcy5pZCA9IHByb3BzLm5hbWUgPSBbcHJvcHMuaWQsIHByb3BzLm5hbWUsIGlmcmFtZSA/IChpZnJhbWUuaWQgfHwgaWZyYW1lLm5hbWUpIDogJ0lGcmFtZV8nICsgU3RyaW5nLnVuaXF1ZUlEKCldLnBpY2soKTsKCWlmcmFtZSA9IG5ldyBFbGVtZW50KGlmcmFtZSB8fCAnaWZyYW1lJywgcHJvcHMpOwoKCXZhciBvbkxvYWQgPSBmdW5jdGlvbigpewoJCW9ubG9hZC5jYWxsKGlmcmFtZS5jb250ZW50V2luZG93KTsKCX07CgoJaWYgKHdpbmRvdy5mcmFtZXNbcHJvcHMuaWRdKSBvbkxvYWQoKTsKCWVsc2UgaWZyYW1lLmFkZExpc3RlbmVyKCdsb2FkJywgb25Mb2FkKTsKCXJldHVybiBpZnJhbWU7Cn0pOwoKdmFyIEVsZW1lbnRzID0gdGhpcy5FbGVtZW50cyA9IGZ1bmN0aW9uKG5vZGVzKXsKCWlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGgpewoJCXZhciB1bmlxdWVzID0ge30sIG5vZGU7CgkJZm9yICh2YXIgaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCXZhciB1aWQgPSBTbGljay51aWRPZihub2RlKTsKCQkJaWYgKCF1bmlxdWVzW3VpZF0pewoJCQkJdW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJCXRoaXMucHVzaChub2RlKTsKCQkJfQoJCX0KCX0KfTsKCkVsZW1lbnRzLnByb3RvdHlwZSA9IHtsZW5ndGg6IDB9OwpFbGVtZW50cy5wYXJlbnQgPSBBcnJheTsKCm5ldyBUeXBlKCdFbGVtZW50cycsIEVsZW1lbnRzKS5pbXBsZW1lbnQoewoKCWZpbHRlcjogZnVuY3Rpb24oZmlsdGVyLCBiaW5kKXsKCQlpZiAoIWZpbHRlcikgcmV0dXJuIHRoaXM7CgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5maWx0ZXIodGhpcywgKHR5cGVPZihmaWx0ZXIpID09ICdzdHJpbmcnKSA/IGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gaXRlbS5tYXRjaChmaWx0ZXIpOwoJCX0gOiBmaWx0ZXIsIGJpbmQpKTsKCX0ucHJvdGVjdCgpLAoKCXB1c2g6IGZ1bmN0aW9uKCl7CgkJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gZG9jdW1lbnQuaWQoYXJndW1lbnRzW2ldKTsKCQkJaWYgKGl0ZW0pIHRoaXNbbGVuZ3RoKytdID0gaXRlbTsKCQl9CgkJcmV0dXJuICh0aGlzLmxlbmd0aCA9IGxlbmd0aCk7Cgl9LnByb3RlY3QoKSwKCgl1bnNoaWZ0OiBmdW5jdGlvbigpewoJCXZhciBpdGVtcyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gZG9jdW1lbnQuaWQoYXJndW1lbnRzW2ldKTsKCQkJaWYgKGl0ZW0pIGl0ZW1zLnB1c2goaXRlbSk7CgkJfQoJCXJldHVybiBBcnJheS5wcm90b3R5cGUudW5zaGlmdC5hcHBseSh0aGlzLCBpdGVtcyk7Cgl9LnByb3RlY3QoKSwKCgljb25jYXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG5ld0VsZW1lbnRzID0gbmV3IEVsZW1lbnRzKHRoaXMpOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gYXJndW1lbnRzW2ldOwoJCQlpZiAoVHlwZS5pc0VudW1lcmFibGUoaXRlbSkpIG5ld0VsZW1lbnRzLmFwcGVuZChpdGVtKTsKCQkJZWxzZSBuZXdFbGVtZW50cy5wdXNoKGl0ZW0pOwoJCX0KCQlyZXR1cm4gbmV3RWxlbWVudHM7Cgl9LnByb3RlY3QoKSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGNvbGxlY3Rpb24pewoJCWZvciAodmFyIGkgPSAwLCBsID0gY29sbGVjdGlvbi5sZW5ndGg7IGkgPCBsOyBpKyspIHRoaXMucHVzaChjb2xsZWN0aW9uW2ldKTsKCQlyZXR1cm4gdGhpczsKCX0ucHJvdGVjdCgpLAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXdoaWxlICh0aGlzLmxlbmd0aCkgZGVsZXRlIHRoaXNbLS10aGlzLmxlbmd0aF07CgkJcmV0dXJuIHRoaXM7Cgl9LnByb3RlY3QoKQoKfSk7CgovLzwxLjJjb21wYXQ+CgpFbGVtZW50cy5hbGlhcygnZXh0ZW5kJywgJ2FwcGVuZCcpOwoKLy88LzEuMmNvbXBhdD4KCihmdW5jdGlvbigpewoKLy8gRkYsIElFCnZhciBzcGxpY2UgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLCBvYmplY3QgPSB7JzAnOiAwLCAnMSc6IDEsIGxlbmd0aDogMn07CgpzcGxpY2UuY2FsbChvYmplY3QsIDEsIDEpOwppZiAob2JqZWN0WzFdID09IDEpIEVsZW1lbnRzLmltcGxlbWVudCgnc3BsaWNlJywgZnVuY3Rpb24oKXsKCXZhciBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCXZhciByZXN1bHQgPSBzcGxpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCXdoaWxlIChsZW5ndGggPj0gdGhpcy5sZW5ndGgpIGRlbGV0ZSB0aGlzW2xlbmd0aC0tXTsKCXJldHVybiByZXN1bHQ7Cn0ucHJvdGVjdCgpKTsKCkFycmF5LmZvckVhY2hNZXRob2QoZnVuY3Rpb24obWV0aG9kLCBuYW1lKXsKCUVsZW1lbnRzLmltcGxlbWVudChuYW1lLCBtZXRob2QpOwp9KTsKCkFycmF5Lm1pcnJvcihFbGVtZW50cyk7CgovKjxsdElFOD4qLwp2YXIgY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MOwp0cnkgewogICAgY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MID0gKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJzxpbnB1dCBuYW1lPXg+JykubmFtZSA9PSAneCcpOwp9IGNhdGNoIChlKXt9Cgp2YXIgZXNjYXBlUXVvdGVzID0gZnVuY3Rpb24oaHRtbCl7CglyZXR1cm4gKCcnICsgaHRtbCkucmVwbGFjZSgvJi9nLCAnJmFtcDsnKS5yZXBsYWNlKC8iL2csICcmcXVvdDsnKTsKfTsKLyo8L2x0SUU4PiovCgpEb2N1bWVudC5pbXBsZW1lbnQoewoKCW5ld0VsZW1lbnQ6IGZ1bmN0aW9uKHRhZywgcHJvcHMpewoJCWlmIChwcm9wcyAmJiBwcm9wcy5jaGVja2VkICE9IG51bGwpIHByb3BzLmRlZmF1bHRDaGVja2VkID0gcHJvcHMuY2hlY2tlZDsKCQkvKjxsdElFOD4qLy8vIEZpeCBmb3IgcmVhZG9ubHkgbmFtZSBhbmQgdHlwZSBwcm9wZXJ0aWVzIGluIElFIDwgOAoJCWlmIChjcmVhdGVFbGVtZW50QWNjZXB0c0hUTUwgJiYgcHJvcHMpewoJCQl0YWcgPSAnPCcgKyB0YWc7CgkJCWlmIChwcm9wcy5uYW1lKSB0YWcgKz0gJyBuYW1lPSInICsgZXNjYXBlUXVvdGVzKHByb3BzLm5hbWUpICsgJyInOwoJCQlpZiAocHJvcHMudHlwZSkgdGFnICs9ICcgdHlwZT0iJyArIGVzY2FwZVF1b3Rlcyhwcm9wcy50eXBlKSArICciJzsKCQkJdGFnICs9ICc+JzsKCQkJZGVsZXRlIHByb3BzLm5hbWU7CgkJCWRlbGV0ZSBwcm9wcy50eXBlOwoJCX0KCQkvKjwvbHRJRTg+Ki8KCQlyZXR1cm4gdGhpcy5pZCh0aGlzLmNyZWF0ZUVsZW1lbnQodGFnKSkuc2V0KHByb3BzKTsKCX0KCn0pOwoKfSkoKTsKCihmdW5jdGlvbigpewoKU2xpY2sudWlkT2Yod2luZG93KTsKU2xpY2sudWlkT2YoZG9jdW1lbnQpOwoKRG9jdW1lbnQuaW1wbGVtZW50KHsKCgluZXdUZXh0Tm9kZTogZnVuY3Rpb24odGV4dCl7CgkJcmV0dXJuIHRoaXMuY3JlYXRlVGV4dE5vZGUodGV4dCk7Cgl9LAoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMud2luZG93OwoJfSwKCglpZDogKGZ1bmN0aW9uKCl7CgoJCXZhciB0eXBlcyA9IHsKCgkJCXN0cmluZzogZnVuY3Rpb24oaWQsIG5vY2FzaCwgZG9jKXsKCQkJCWlkID0gU2xpY2suZmluZChkb2MsICcjJyArIGlkLnJlcGxhY2UoLyhcVykvZywgJ1xcJDEnKSk7CgkJCQlyZXR1cm4gKGlkKSA/IHR5cGVzLmVsZW1lbnQoaWQsIG5vY2FzaCkgOiBudWxsOwoJCQl9LAoKCQkJZWxlbWVudDogZnVuY3Rpb24oZWwsIG5vY2FzaCl7CgkJCQlTbGljay51aWRPZihlbCk7CgkJCQlpZiAoIW5vY2FzaCAmJiAhZWwuJGZhbWlseSAmJiAhKC9eKD86b2JqZWN0fGVtYmVkKSQvaSkudGVzdChlbC50YWdOYW1lKSl7CgkJCQkJdmFyIGZpcmVFdmVudCA9IGVsLmZpcmVFdmVudDsKCQkJCQkvLyB3cmFwcGluZyBuZWVkZWQgaW4gSUU3LCBvciBlbHNlIGNyYXNoCgkJCQkJZWwuX2ZpcmVFdmVudCA9IGZ1bmN0aW9uKHR5cGUsIGV2ZW50KXsKCQkJCQkJcmV0dXJuIGZpcmVFdmVudCh0eXBlLCBldmVudCk7CgkJCQkJfTsKCQkJCQlPYmplY3QuYXBwZW5kKGVsLCBFbGVtZW50LlByb3RvdHlwZSk7CgkJCQl9CgkJCQlyZXR1cm4gZWw7CgkJCX0sCgoJCQlvYmplY3Q6IGZ1bmN0aW9uKG9iaiwgbm9jYXNoLCBkb2MpewoJCQkJaWYgKG9iai50b0VsZW1lbnQpIHJldHVybiB0eXBlcy5lbGVtZW50KG9iai50b0VsZW1lbnQoZG9jKSwgbm9jYXNoKTsKCQkJCXJldHVybiBudWxsOwoJCQl9CgoJCX07CgoJCXR5cGVzLnRleHRub2RlID0gdHlwZXMud2hpdGVzcGFjZSA9IHR5cGVzLndpbmRvdyA9IHR5cGVzLmRvY3VtZW50ID0gZnVuY3Rpb24oemVybyl7CgkJCXJldHVybiB6ZXJvOwoJCX07CgoJCXJldHVybiBmdW5jdGlvbihlbCwgbm9jYXNoLCBkb2MpewoJCQlpZiAoZWwgJiYgZWwuJGZhbWlseSAmJiBlbC51bmlxdWVOdW1iZXIpIHJldHVybiBlbDsKCQkJdmFyIHR5cGUgPSB0eXBlT2YoZWwpOwoJCQlyZXR1cm4gKHR5cGVzW3R5cGVdKSA/IHR5cGVzW3R5cGVdKGVsLCBub2Nhc2gsIGRvYyB8fCBkb2N1bWVudCkgOiBudWxsOwoJCX07CgoJfSkoKQoKfSk7CgppZiAod2luZG93LiQgPT0gbnVsbCkgV2luZG93LmltcGxlbWVudCgnJCcsIGZ1bmN0aW9uKGVsLCBuYyl7CglyZXR1cm4gZG9jdW1lbnQuaWQoZWwsIG5jLCB0aGlzLmRvY3VtZW50KTsKfSk7CgpXaW5kb3cuaW1wbGVtZW50KHsKCglnZXREb2N1bWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5kb2N1bWVudDsKCX0sCgoJZ2V0V2luZG93OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpbRG9jdW1lbnQsIEVsZW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWdldEVsZW1lbnRzOiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gU2xpY2suc2VhcmNoKHRoaXMsIGV4cHJlc3Npb24sIG5ldyBFbGVtZW50cyk7Cgl9LAoKCWdldEVsZW1lbnQ6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsIGV4cHJlc3Npb24pKTsKCX0KCn0pOwoKdmFyIGNvbnRhaW5zID0ge2NvbnRhaW5zOiBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiBTbGljay5jb250YWlucyh0aGlzLCBlbGVtZW50KTsKfX07CgppZiAoIWRvY3VtZW50LmNvbnRhaW5zKSBEb2N1bWVudC5pbXBsZW1lbnQoY29udGFpbnMpOwppZiAoIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLmNvbnRhaW5zKSBFbGVtZW50LmltcGxlbWVudChjb250YWlucyk7CgovLzwxLjJjb21wYXQ+CgpFbGVtZW50LmltcGxlbWVudCgnaGFzQ2hpbGQnLCBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiB0aGlzICE9PSBlbGVtZW50ICYmIHRoaXMuY29udGFpbnMoZWxlbWVudCk7Cn0pOwoKKGZ1bmN0aW9uKHNlYXJjaCwgZmluZCwgbWF0Y2gpewoKCXRoaXMuU2VsZWN0b3JzID0ge307Cgl2YXIgcHNldWRvcyA9IHRoaXMuU2VsZWN0b3JzLlBzZXVkbyA9IG5ldyBIYXNoKCk7CgoJdmFyIGFkZFNsaWNrUHNldWRvcyA9IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgbmFtZSBpbiBwc2V1ZG9zKSBpZiAocHNldWRvcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSl7CgkJCVNsaWNrLmRlZmluZVBzZXVkbyhuYW1lLCBwc2V1ZG9zW25hbWVdKTsKCQkJZGVsZXRlIHBzZXVkb3NbbmFtZV07CgkJfQoJfTsKCglTbGljay5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpewoJCWFkZFNsaWNrUHNldWRvcygpOwoJCXJldHVybiBzZWFyY2guY2FsbCh0aGlzLCBjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpOwoJfTsKCglTbGljay5maW5kID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbil7CgkJYWRkU2xpY2tQc2V1ZG9zKCk7CgkJcmV0dXJuIGZpbmQuY2FsbCh0aGlzLCBjb250ZXh0LCBleHByZXNzaW9uKTsKCX07CgoJU2xpY2subWF0Y2ggPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CgkJYWRkU2xpY2tQc2V1ZG9zKCk7CgkJcmV0dXJuIG1hdGNoLmNhbGwodGhpcywgbm9kZSwgc2VsZWN0b3IpOwoJfTsKCn0pKFNsaWNrLnNlYXJjaCwgU2xpY2suZmluZCwgU2xpY2subWF0Y2gpOwoKLy88LzEuMmNvbXBhdD4KCi8vIHRyZWUgd2Fsa2luZwoKdmFyIGluamVjdENvbWJpbmF0b3IgPSBmdW5jdGlvbihleHByZXNzaW9uLCBjb21iaW5hdG9yKXsKCWlmICghZXhwcmVzc2lvbikgcmV0dXJuIGNvbWJpbmF0b3I7CgoJZXhwcmVzc2lvbiA9IE9iamVjdC5jbG9uZShTbGljay5wYXJzZShleHByZXNzaW9uKSk7CgoJdmFyIGV4cHJlc3Npb25zID0gZXhwcmVzc2lvbi5leHByZXNzaW9uczsKCWZvciAodmFyIGkgPSBleHByZXNzaW9ucy5sZW5ndGg7IGktLTspCgkJZXhwcmVzc2lvbnNbaV1bMF0uY29tYmluYXRvciA9IGNvbWJpbmF0b3I7CgoJcmV0dXJuIGV4cHJlc3Npb247Cn07CgpPYmplY3QuZm9yRWFjaCh7CglnZXROZXh0OiAnficsCglnZXRQcmV2aW91czogJyF+JywKCWdldFBhcmVudDogJyEnCn0sIGZ1bmN0aW9uKGNvbWJpbmF0b3IsIG1ldGhvZCl7CglFbGVtZW50LmltcGxlbWVudChtZXRob2QsIGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiB0aGlzLmdldEVsZW1lbnQoaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCBjb21iaW5hdG9yKSk7Cgl9KTsKfSk7CgpPYmplY3QuZm9yRWFjaCh7CglnZXRBbGxOZXh0OiAnficsCglnZXRBbGxQcmV2aW91czogJyF+JywKCWdldFNpYmxpbmdzOiAnfn4nLAoJZ2V0Q2hpbGRyZW46ICc+JywKCWdldFBhcmVudHM6ICchJwp9LCBmdW5jdGlvbihjb21iaW5hdG9yLCBtZXRob2QpewoJRWxlbWVudC5pbXBsZW1lbnQobWV0aG9kLCBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gdGhpcy5nZXRFbGVtZW50cyhpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sIGNvbWJpbmF0b3IpKTsKCX0pOwp9KTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglnZXRGaXJzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpWzBdKTsKCX0sCgoJZ2V0TGFzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpLmdldExhc3QoKSk7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50LndpbmRvdzsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMub3duZXJEb2N1bWVudDsKCX0sCgoJZ2V0RWxlbWVudEJ5SWQ6IGZ1bmN0aW9uKGlkKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suZmluZCh0aGlzLCAnIycgKyAoJycgKyBpZCkucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKSk7Cgl9LAoKCW1hdGNoOiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gIWV4cHJlc3Npb24gfHwgU2xpY2subWF0Y2godGhpcywgZXhwcmVzc2lvbik7Cgl9Cgp9KTsKCi8vPDEuMmNvbXBhdD4KCmlmICh3aW5kb3cuJCQgPT0gbnVsbCkgV2luZG93LmltcGxlbWVudCgnJCQnLCBmdW5jdGlvbihzZWxlY3Rvcil7Cgl2YXIgZWxlbWVudHMgPSBuZXcgRWxlbWVudHM7CglpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxICYmIHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJykgcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBzZWxlY3RvciwgZWxlbWVudHMpOwoJdmFyIGFyZ3MgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyk7Cglmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3MubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQl2YXIgaXRlbSA9IGFyZ3NbaV07CgkJc3dpdGNoICh0eXBlT2YoaXRlbSkpewoJCQljYXNlICdlbGVtZW50JzogZWxlbWVudHMucHVzaChpdGVtKTsgYnJlYWs7CgkJCWNhc2UgJ3N0cmluZyc6IFNsaWNrLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBpdGVtLCBlbGVtZW50cyk7CgkJfQoJfQoJcmV0dXJuIGVsZW1lbnRzOwp9KTsKCi8vPC8xLjJjb21wYXQ+CgppZiAod2luZG93LiQkID09IG51bGwpIFdpbmRvdy5pbXBsZW1lbnQoJyQkJywgZnVuY3Rpb24oc2VsZWN0b3IpewoJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSl7CgkJaWYgKHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJykgcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBzZWxlY3RvciwgbmV3IEVsZW1lbnRzKTsKCQllbHNlIGlmIChUeXBlLmlzRW51bWVyYWJsZShzZWxlY3RvcikpIHJldHVybiBuZXcgRWxlbWVudHMoc2VsZWN0b3IpOwoJfQoJcmV0dXJuIG5ldyBFbGVtZW50cyhhcmd1bWVudHMpOwp9KTsKCi8vIEluc2VydGVycwoKdmFyIGluc2VydGVycyA9IHsKCgliZWZvcmU6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50KTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50Lm5leHRTaWJsaW5nKTsKCX0sCgoJYm90dG9tOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQllbGVtZW50LmFwcGVuZENoaWxkKGNvbnRleHQpOwoJfSwKCgl0b3A6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCWVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7Cgl9Cgp9OwoKaW5zZXJ0ZXJzLmluc2lkZSA9IGluc2VydGVycy5ib3R0b207CgovLzwxLjJjb21wYXQ+CgpPYmplY3QuZWFjaChpbnNlcnRlcnMsIGZ1bmN0aW9uKGluc2VydGVyLCB3aGVyZSl7CgoJd2hlcmUgPSB3aGVyZS5jYXBpdGFsaXplKCk7CgoJdmFyIG1ldGhvZHMgPSB7fTsKCgltZXRob2RzWydpbmplY3QnICsgd2hlcmVdID0gZnVuY3Rpb24oZWwpewoJCWluc2VydGVyKHRoaXMsIGRvY3VtZW50LmlkKGVsLCB0cnVlKSk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCW1ldGhvZHNbJ2dyYWInICsgd2hlcmVdID0gZnVuY3Rpb24oZWwpewoJCWluc2VydGVyKGRvY3VtZW50LmlkKGVsLCB0cnVlKSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCUVsZW1lbnQuaW1wbGVtZW50KG1ldGhvZHMpOwoKfSk7CgovLzwvMS4yY29tcGF0PgoKLy8gZ2V0UHJvcGVydHkgLyBzZXRQcm9wZXJ0eQoKdmFyIHByb3BlcnR5R2V0dGVycyA9IHt9LCBwcm9wZXJ0eVNldHRlcnMgPSB7fTsKCi8vIHByb3BlcnRpZXMKCnZhciBwcm9wZXJ0aWVzID0ge307CkFycmF5LmZvckVhY2goWwoJJ3R5cGUnLCAndmFsdWUnLCAnZGVmYXVsdFZhbHVlJywgJ2FjY2Vzc0tleScsICdjZWxsUGFkZGluZycsICdjZWxsU3BhY2luZycsICdjb2xTcGFuJywKCSdmcmFtZUJvcmRlcicsICdyb3dTcGFuJywgJ3RhYkluZGV4JywgJ3VzZU1hcCcKXSwgZnVuY3Rpb24ocHJvcGVydHkpewoJcHJvcGVydGllc1twcm9wZXJ0eS50b0xvd2VyQ2FzZSgpXSA9IHByb3BlcnR5Owp9KTsKCnByb3BlcnRpZXMuaHRtbCA9ICdpbm5lckhUTUwnOwpwcm9wZXJ0aWVzLnRleHQgPSAoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykudGV4dENvbnRlbnQgPT0gbnVsbCkgPyAnaW5uZXJUZXh0JzogJ3RleHRDb250ZW50JzsKCk9iamVjdC5mb3JFYWNoKHByb3BlcnRpZXMsIGZ1bmN0aW9uKHJlYWwsIGtleSl7Cglwcm9wZXJ0eVNldHRlcnNba2V5XSA9IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKXsKCQlub2RlW3JlYWxdID0gdmFsdWU7Cgl9OwoJcHJvcGVydHlHZXR0ZXJzW2tleV0gPSBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gbm9kZVtyZWFsXTsKCX07Cn0pOwoKLy8gQm9vbGVhbnMKCnZhciBib29scyA9IFsKCSdjb21wYWN0JywgJ25vd3JhcCcsICdpc21hcCcsICdkZWNsYXJlJywgJ25vc2hhZGUnLCAnY2hlY2tlZCcsCgknZGlzYWJsZWQnLCAncmVhZE9ubHknLCAnbXVsdGlwbGUnLCAnc2VsZWN0ZWQnLCAnbm9yZXNpemUnLAoJJ2RlZmVyJywgJ2RlZmF1bHRDaGVja2VkJywgJ2F1dG9mb2N1cycsICdjb250cm9scycsICdhdXRvcGxheScsCgknbG9vcCcKXTsKCnZhciBib29sZWFucyA9IHt9OwpBcnJheS5mb3JFYWNoKGJvb2xzLCBmdW5jdGlvbihib29sKXsKCXZhciBsb3dlciA9IGJvb2wudG9Mb3dlckNhc2UoKTsKCWJvb2xlYW5zW2xvd2VyXSA9IGJvb2w7Cglwcm9wZXJ0eVNldHRlcnNbbG93ZXJdID0gZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJCW5vZGVbYm9vbF0gPSAhIXZhbHVlOwoJfTsKCXByb3BlcnR5R2V0dGVyc1tsb3dlcl0gPSBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gISFub2RlW2Jvb2xdOwoJfTsKfSk7CgovLyBTcGVjaWFsIGNhc2VzCgpPYmplY3QuYXBwZW5kKHByb3BlcnR5U2V0dGVycywgewoKCSdjbGFzcyc6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKXsKCQkoJ2NsYXNzTmFtZScgaW4gbm9kZSkgPyBub2RlLmNsYXNzTmFtZSA9ICh2YWx1ZSB8fCAnJykgOiBub2RlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCB2YWx1ZSk7Cgl9LAoKCSdmb3InOiBmdW5jdGlvbihub2RlLCB2YWx1ZSl7CgkJKCdodG1sRm9yJyBpbiBub2RlKSA/IG5vZGUuaHRtbEZvciA9IHZhbHVlIDogbm9kZS5zZXRBdHRyaWJ1dGUoJ2ZvcicsIHZhbHVlKTsKCX0sCgoJJ3N0eWxlJzogZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJCShub2RlLnN0eWxlKSA/IG5vZGUuc3R5bGUuY3NzVGV4dCA9IHZhbHVlIDogbm9kZS5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgdmFsdWUpOwoJfSwKCgkndmFsdWUnOiBmdW5jdGlvbihub2RlLCB2YWx1ZSl7CgkJbm9kZS52YWx1ZSA9ICh2YWx1ZSAhPSBudWxsKSA/IHZhbHVlIDogJyc7Cgl9Cgp9KTsKCnByb3BlcnR5R2V0dGVyc1snY2xhc3MnXSA9IGZ1bmN0aW9uKG5vZGUpewoJcmV0dXJuICgnY2xhc3NOYW1lJyBpbiBub2RlKSA/IG5vZGUuY2xhc3NOYW1lIHx8IG51bGwgOiBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKTsKfTsKCi8qIDx3ZWJraXQ+ICovCnZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpOwovLyBJRSBzZXRzIHR5cGUgYXMgcmVhZG9ubHkgYW5kIHRocm93cwp0cnkgeyBlbC50eXBlID0gJ2J1dHRvbic7IH0gY2F0Y2goZSl7fQppZiAoZWwudHlwZSAhPSAnYnV0dG9uJykgcHJvcGVydHlTZXR0ZXJzLnR5cGUgPSBmdW5jdGlvbihub2RlLCB2YWx1ZSl7Cglub2RlLnNldEF0dHJpYnV0ZSgndHlwZScsIHZhbHVlKTsKfTsKZWwgPSBudWxsOwovKiA8L3dlYmtpdD4gKi8KCi8qPElFPiovCnZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7CmlucHV0LnZhbHVlID0gJ3QnOwppbnB1dC50eXBlID0gJ3N1Ym1pdCc7CmlmIChpbnB1dC52YWx1ZSAhPSAndCcpIHByb3BlcnR5U2V0dGVycy50eXBlID0gZnVuY3Rpb24obm9kZSwgdHlwZSl7Cgl2YXIgdmFsdWUgPSBub2RlLnZhbHVlOwoJbm9kZS50eXBlID0gdHlwZTsKCW5vZGUudmFsdWUgPSB2YWx1ZTsKfTsKaW5wdXQgPSBudWxsOwovKjwvSUU+Ki8KCi8qIGdldFByb3BlcnR5LCBzZXRQcm9wZXJ0eSAqLwoKLyogPGx0SUU5PiAqLwp2YXIgcG9sbHV0ZXNHZXRBdHRyaWJ1dGUgPSAoZnVuY3Rpb24oZGl2KXsKCWRpdi5yYW5kb20gPSAnYXR0cmlidXRlJzsKCXJldHVybiAoZGl2LmdldEF0dHJpYnV0ZSgncmFuZG9tJykgPT0gJ2F0dHJpYnV0ZScpOwp9KShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7CgovKiA8bHRJRTk+ICovCgpFbGVtZW50LmltcGxlbWVudCh7CgoJc2V0UHJvcGVydHk6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKCQl2YXIgc2V0dGVyID0gcHJvcGVydHlTZXR0ZXJzW25hbWUudG9Mb3dlckNhc2UoKV07CgkJaWYgKHNldHRlcil7CgkJCXNldHRlcih0aGlzLCB2YWx1ZSk7CgkJfSBlbHNlIHsKCQkJLyogPGx0SUU5PiAqLwoJCQlpZiAocG9sbHV0ZXNHZXRBdHRyaWJ1dGUpIHZhciBhdHRyaWJ1dGVXaGl0ZUxpc3QgPSB0aGlzLnJldHJpZXZlKCckYXR0cmlidXRlV2hpdGVMaXN0Jywge30pOwoJCQkvKiA8L2x0SUU5PiAqLwoKCQkJaWYgKHZhbHVlID09IG51bGwpewoJCQkJdGhpcy5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CgkJCQkvKiA8bHRJRTk+ICovCgkJCQlpZiAocG9sbHV0ZXNHZXRBdHRyaWJ1dGUpIGRlbGV0ZSBhdHRyaWJ1dGVXaGl0ZUxpc3RbbmFtZV07CgkJCQkvKiA8L2x0SUU5PiAqLwoJCQl9IGVsc2UgewoJCQkJdGhpcy5zZXRBdHRyaWJ1dGUobmFtZSwgJycgKyB2YWx1ZSk7CgkJCQkvKiA8bHRJRTk+ICovCgkJCQlpZiAocG9sbHV0ZXNHZXRBdHRyaWJ1dGUpIGF0dHJpYnV0ZVdoaXRlTGlzdFtuYW1lXSA9IHRydWU7CgkJCQkvKiA8L2x0SUU5PiAqLwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbihhdHRyaWJ1dGVzKXsKCQlmb3IgKHZhciBhdHRyaWJ1dGUgaW4gYXR0cmlidXRlcykgdGhpcy5zZXRQcm9wZXJ0eShhdHRyaWJ1dGUsIGF0dHJpYnV0ZXNbYXR0cmlidXRlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFByb3BlcnR5OiBmdW5jdGlvbihuYW1lKXsKCQl2YXIgZ2V0dGVyID0gcHJvcGVydHlHZXR0ZXJzW25hbWUudG9Mb3dlckNhc2UoKV07CgkJaWYgKGdldHRlcikgcmV0dXJuIGdldHRlcih0aGlzKTsKCQkvKiA8bHRJRTk+ICovCgkJaWYgKHBvbGx1dGVzR2V0QXR0cmlidXRlKXsKCQkJdmFyIGF0dHIgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUobmFtZSksIGF0dHJpYnV0ZVdoaXRlTGlzdCA9IHRoaXMucmV0cmlldmUoJyRhdHRyaWJ1dGVXaGl0ZUxpc3QnLCB7fSk7CgkJCWlmICghYXR0cikgcmV0dXJuIG51bGw7CgkJCWlmIChhdHRyLmV4cGFuZG8gJiYgIWF0dHJpYnV0ZVdoaXRlTGlzdFtuYW1lXSl7CgkJCQl2YXIgb3V0ZXIgPSB0aGlzLm91dGVySFRNTDsKCQkJCS8vIHNlZ21lbnQgYnkgdGhlIG9wZW5pbmcgdGFnIGFuZCBmaW5kIG1lbnRpb24gb2YgYXR0cmlidXRlIG5hbWUKCQkJCWlmIChvdXRlci5zdWJzdHIoMCwgb3V0ZXIuc2VhcmNoKC9cLz9bJyJdPz4oPyFbXjxdKjxbJyJdKS8pKS5pbmRleE9mKG5hbWUpIDwgMCkgcmV0dXJuIG51bGw7CgkJCQlhdHRyaWJ1dGVXaGl0ZUxpc3RbbmFtZV0gPSB0cnVlOwoJCQl9CgkJfQoJCS8qIDwvbHRJRTk+ICovCgkJdmFyIHJlc3VsdCA9IFNsaWNrLmdldEF0dHJpYnV0ZSh0aGlzLCBuYW1lKTsKCQlyZXR1cm4gKCFyZXN1bHQgJiYgIVNsaWNrLmhhc0F0dHJpYnV0ZSh0aGlzLCBuYW1lKSkgPyBudWxsIDogcmVzdWx0OwoJfSwKCglnZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbigpewoJCXZhciBhcmdzID0gQXJyYXkuZnJvbShhcmd1bWVudHMpOwoJCXJldHVybiBhcmdzLm1hcCh0aGlzLmdldFByb3BlcnR5LCB0aGlzKS5hc3NvY2lhdGUoYXJncyk7Cgl9LAoKCXJlbW92ZVByb3BlcnR5OiBmdW5jdGlvbihuYW1lKXsKCQlyZXR1cm4gdGhpcy5zZXRQcm9wZXJ0eShuYW1lLCBudWxsKTsKCX0sCgoJcmVtb3ZlUHJvcGVydGllczogZnVuY3Rpb24oKXsKCQlBcnJheS5lYWNoKGFyZ3VtZW50cywgdGhpcy5yZW1vdmVQcm9wZXJ0eSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXNldDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuc2V0KSA/IHByb3BlcnR5LnNldC5jYWxsKHRoaXMsIHZhbHVlKSA6IHRoaXMuc2V0UHJvcGVydHkocHJvcCwgdmFsdWUpOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCWdldDogZnVuY3Rpb24ocHJvcCl7CgkJdmFyIHByb3BlcnR5ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BdOwoJCXJldHVybiAocHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0KSA/IHByb3BlcnR5LmdldC5hcHBseSh0aGlzKSA6IHRoaXMuZ2V0UHJvcGVydHkocHJvcCk7Cgl9Lm92ZXJsb2FkR2V0dGVyKCksCgoJZXJhc2U6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuZXJhc2UpID8gcHJvcGVydHkuZXJhc2UuYXBwbHkodGhpcykgOiB0aGlzLnJlbW92ZVByb3BlcnR5KHByb3ApOwoJCXJldHVybiB0aGlzOwoJfSwKCgloYXNDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlyZXR1cm4gdGhpcy5jbGFzc05hbWUuY2xlYW4oKS5jb250YWlucyhjbGFzc05hbWUsICcgJyk7Cgl9LAoKCWFkZENsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCWlmICghdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpKSB0aGlzLmNsYXNzTmFtZSA9ICh0aGlzLmNsYXNzTmFtZSArICcgJyArIGNsYXNzTmFtZSkuY2xlYW4oKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJdGhpcy5jbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZS5yZXBsYWNlKG5ldyBSZWdFeHAoJyhefFxccyknICsgY2xhc3NOYW1lICsgJyg/Olxcc3wkKScpLCAnJDEnKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSwgZm9yY2UpewoJCWlmIChmb3JjZSA9PSBudWxsKSBmb3JjZSA9ICF0aGlzLmhhc0NsYXNzKGNsYXNzTmFtZSk7CgkJcmV0dXJuIChmb3JjZSkgPyB0aGlzLmFkZENsYXNzKGNsYXNzTmFtZSkgOiB0aGlzLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7Cgl9LAoKCWFkb3B0OiBmdW5jdGlvbigpewoJCXZhciBwYXJlbnQgPSB0aGlzLCBmcmFnbWVudCwgZWxlbWVudHMgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyksIGxlbmd0aCA9IGVsZW1lbnRzLmxlbmd0aDsKCQlpZiAobGVuZ3RoID4gMSkgcGFyZW50ID0gZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspewoJCQl2YXIgZWxlbWVudCA9IGRvY3VtZW50LmlkKGVsZW1lbnRzW2ldLCB0cnVlKTsKCQkJaWYgKGVsZW1lbnQpIHBhcmVudC5hcHBlbmRDaGlsZChlbGVtZW50KTsKCQl9CgoJCWlmIChmcmFnbWVudCkgdGhpcy5hcHBlbmRDaGlsZChmcmFnbWVudCk7CgoJCXJldHVybiB0aGlzOwoJfSwKCglhcHBlbmRUZXh0OiBmdW5jdGlvbih0ZXh0LCB3aGVyZSl7CgkJcmV0dXJuIHRoaXMuZ3JhYih0aGlzLmdldERvY3VtZW50KCkubmV3VGV4dE5vZGUodGV4dCksIHdoZXJlKTsKCX0sCgoJZ3JhYjogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQlpbnNlcnRlcnNbd2hlcmUgfHwgJ2JvdHRvbSddKGRvY3VtZW50LmlkKGVsLCB0cnVlKSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluamVjdDogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQlpbnNlcnRlcnNbd2hlcmUgfHwgJ2JvdHRvbSddKHRoaXMsIGRvY3VtZW50LmlkKGVsLCB0cnVlKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlcGxhY2VzOiBmdW5jdGlvbihlbCl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcywgZWwpOwoJCXJldHVybiB0aGlzOwoJfSwKCgl3cmFwczogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQllbCA9IGRvY3VtZW50LmlkKGVsLCB0cnVlKTsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlcyhlbCkuZ3JhYihlbCwgd2hlcmUpOwoJfSwKCglnZXRTZWxlY3RlZDogZnVuY3Rpb24oKXsKCQl0aGlzLnNlbGVjdGVkSW5kZXg7IC8vIFNhZmFyaSAzLjIuMQoJCXJldHVybiBuZXcgRWxlbWVudHMoQXJyYXkuZnJvbSh0aGlzLm9wdGlvbnMpLmZpbHRlcihmdW5jdGlvbihvcHRpb24pewoJCQlyZXR1cm4gb3B0aW9uLnNlbGVjdGVkOwoJCX0pKTsKCX0sCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24oKXsKCQl2YXIgcXVlcnlTdHJpbmcgPSBbXTsKCQl0aGlzLmdldEVsZW1lbnRzKCdpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYScpLmVhY2goZnVuY3Rpb24oZWwpewoJCQl2YXIgdHlwZSA9IGVsLnR5cGU7CgkJCWlmICghZWwubmFtZSB8fCBlbC5kaXNhYmxlZCB8fCB0eXBlID09ICdzdWJtaXQnIHx8IHR5cGUgPT0gJ3Jlc2V0JyB8fCB0eXBlID09ICdmaWxlJyB8fCB0eXBlID09ICdpbWFnZScpIHJldHVybjsKCgkJCXZhciB2YWx1ZSA9IChlbC5nZXQoJ3RhZycpID09ICdzZWxlY3QnKSA/IGVsLmdldFNlbGVjdGVkKCkubWFwKGZ1bmN0aW9uKG9wdCl7CgkJCQkvLyBJRQoJCQkJcmV0dXJuIGRvY3VtZW50LmlkKG9wdCkuZ2V0KCd2YWx1ZScpOwoJCQl9KSA6ICgodHlwZSA9PSAncmFkaW8nIHx8IHR5cGUgPT0gJ2NoZWNrYm94JykgJiYgIWVsLmNoZWNrZWQpID8gbnVsbCA6IGVsLmdldCgndmFsdWUnKTsKCgkJCUFycmF5LmZyb20odmFsdWUpLmVhY2goZnVuY3Rpb24odmFsKXsKCQkJCWlmICh0eXBlb2YgdmFsICE9ICd1bmRlZmluZWQnKSBxdWVyeVN0cmluZy5wdXNoKGVuY29kZVVSSUNvbXBvbmVudChlbC5uYW1lKSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpKTsKCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKdmFyIGNvbGxlY3RlZCA9IHt9LCBzdG9yYWdlID0ge307Cgp2YXIgZ2V0ID0gZnVuY3Rpb24odWlkKXsKCXJldHVybiAoc3RvcmFnZVt1aWRdIHx8IChzdG9yYWdlW3VpZF0gPSB7fSkpOwp9OwoKdmFyIGNsZWFuID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgdWlkID0gaXRlbS51bmlxdWVOdW1iZXI7CglpZiAoaXRlbS5yZW1vdmVFdmVudHMpIGl0ZW0ucmVtb3ZlRXZlbnRzKCk7CglpZiAoaXRlbS5jbGVhckF0dHJpYnV0ZXMpIGl0ZW0uY2xlYXJBdHRyaWJ1dGVzKCk7CglpZiAodWlkICE9IG51bGwpewoJCWRlbGV0ZSBjb2xsZWN0ZWRbdWlkXTsKCQlkZWxldGUgc3RvcmFnZVt1aWRdOwoJfQoJcmV0dXJuIGl0ZW07Cn07Cgp2YXIgZm9ybVByb3BzID0ge2lucHV0OiAnY2hlY2tlZCcsIG9wdGlvbjogJ3NlbGVjdGVkJywgdGV4dGFyZWE6ICd2YWx1ZSd9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWRlc3Ryb3k6IGZ1bmN0aW9uKCl7CgkJdmFyIGNoaWxkcmVuID0gY2xlYW4odGhpcykuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQlBcnJheS5lYWNoKGNoaWxkcmVuLCBjbGVhbik7CgkJRWxlbWVudC5kaXNwb3NlKHRoaXMpOwoJCXJldHVybiBudWxsOwoJfSwKCgllbXB0eTogZnVuY3Rpb24oKXsKCQlBcnJheS5mcm9tKHRoaXMuY2hpbGROb2RlcykuZWFjaChFbGVtZW50LmRpc3Bvc2UpOwoJCXJldHVybiB0aGlzOwoJfSwKCglkaXNwb3NlOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5wYXJlbnROb2RlKSA/IHRoaXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzKSA6IHRoaXM7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbihjb250ZW50cywga2VlcGlkKXsKCQljb250ZW50cyA9IGNvbnRlbnRzICE9PSBmYWxzZTsKCQl2YXIgY2xvbmUgPSB0aGlzLmNsb25lTm9kZShjb250ZW50cyksIGNlID0gW2Nsb25lXSwgdGUgPSBbdGhpc10sIGk7CgoJCWlmIChjb250ZW50cyl7CgkJCWNlLmFwcGVuZChBcnJheS5mcm9tKGNsb25lLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykpKTsKCQkJdGUuYXBwZW5kKEFycmF5LmZyb20odGhpcy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpKSk7CgkJfQoKCQlmb3IgKGkgPSBjZS5sZW5ndGg7IGktLTspewoJCQl2YXIgbm9kZSA9IGNlW2ldLCBlbGVtZW50ID0gdGVbaV07CgkJCWlmICgha2VlcGlkKSBub2RlLnJlbW92ZUF0dHJpYnV0ZSgnaWQnKTsKCQkJLyo8bHRJRTk+Ki8KCQkJaWYgKG5vZGUuY2xlYXJBdHRyaWJ1dGVzKXsKCQkJCW5vZGUuY2xlYXJBdHRyaWJ1dGVzKCk7CgkJCQlub2RlLm1lcmdlQXR0cmlidXRlcyhlbGVtZW50KTsKCQkJCW5vZGUucmVtb3ZlQXR0cmlidXRlKCd1bmlxdWVOdW1iZXInKTsKCQkJCWlmIChub2RlLm9wdGlvbnMpewoJCQkJCXZhciBubyA9IG5vZGUub3B0aW9ucywgZW8gPSBlbGVtZW50Lm9wdGlvbnM7CgkJCQkJZm9yICh2YXIgaiA9IG5vLmxlbmd0aDsgai0tOykgbm9bal0uc2VsZWN0ZWQgPSBlb1tqXS5zZWxlY3RlZDsKCQkJCX0KCQkJfQoJCQkvKjwvbHRJRTk+Ki8KCQkJdmFyIHByb3AgPSBmb3JtUHJvcHNbZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCldOwoJCQlpZiAocHJvcCAmJiBlbGVtZW50W3Byb3BdKSBub2RlW3Byb3BdID0gZWxlbWVudFtwcm9wXTsKCQl9CgoJCS8qPGx0SUU5PiovCgkJaWYgKEJyb3dzZXIuaWUpewoJCQl2YXIgY28gPSBjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0JyksIHRvID0gdGhpcy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0Jyk7CgkJCWZvciAoaSA9IGNvLmxlbmd0aDsgaS0tOykgY29baV0ub3V0ZXJIVE1MID0gdG9baV0ub3V0ZXJIVE1MOwoJCX0KCQkvKjwvbHRJRTk+Ki8KCQlyZXR1cm4gZG9jdW1lbnQuaWQoY2xvbmUpOwoJfQoKfSk7CgpbRWxlbWVudCwgV2luZG93LCBEb2N1bWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJYWRkTGlzdGVuZXI6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQlpZiAodHlwZSA9PSAndW5sb2FkJyl7CgkJCXZhciBvbGQgPSBmbiwgc2VsZiA9IHRoaXM7CgkJCWZuID0gZnVuY3Rpb24oKXsKCQkJCXNlbGYucmVtb3ZlTGlzdGVuZXIoJ3VubG9hZCcsIGZuKTsKCQkJCW9sZCgpOwoJCQl9OwoJCX0gZWxzZSB7CgkJCWNvbGxlY3RlZFtTbGljay51aWRPZih0aGlzKV0gPSB0aGlzOwoJCX0KCQlpZiAodGhpcy5hZGRFdmVudExpc3RlbmVyKSB0aGlzLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZm4sICEhYXJndW1lbnRzWzJdKTsKCQllbHNlIHRoaXMuYXR0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlTGlzdGVuZXI6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQlpZiAodGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKSB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sICEhYXJndW1lbnRzWzJdKTsKCQllbHNlIHRoaXMuZGV0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmV0cmlldmU6IGZ1bmN0aW9uKHByb3BlcnR5LCBkZmx0KXsKCQl2YXIgc3RvcmFnZSA9IGdldChTbGljay51aWRPZih0aGlzKSksIHByb3AgPSBzdG9yYWdlW3Byb3BlcnR5XTsKCQlpZiAoZGZsdCAhPSBudWxsICYmIHByb3AgPT0gbnVsbCkgcHJvcCA9IHN0b3JhZ2VbcHJvcGVydHldID0gZGZsdDsKCQlyZXR1cm4gcHJvcCAhPSBudWxsID8gcHJvcCA6IG51bGw7Cgl9LAoKCXN0b3JlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCXZhciBzdG9yYWdlID0gZ2V0KFNsaWNrLnVpZE9mKHRoaXMpKTsKCQlzdG9yYWdlW3Byb3BlcnR5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgllbGltaW5hdGU6IGZ1bmN0aW9uKHByb3BlcnR5KXsKCQl2YXIgc3RvcmFnZSA9IGdldChTbGljay51aWRPZih0aGlzKSk7CgkJZGVsZXRlIHN0b3JhZ2VbcHJvcGVydHldOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovKjxsdElFOT4qLwppZiAod2luZG93LmF0dGFjaEV2ZW50ICYmICF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikgd2luZG93LmFkZExpc3RlbmVyKCd1bmxvYWQnLCBmdW5jdGlvbigpewoJT2JqZWN0LmVhY2goY29sbGVjdGVkLCBjbGVhbik7CglpZiAod2luZG93LkNvbGxlY3RHYXJiYWdlKSBDb2xsZWN0R2FyYmFnZSgpOwp9KTsKLyo8L2x0SUU5PiovCgpFbGVtZW50LlByb3BlcnRpZXMgPSB7fTsKCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuUHJvcGVydGllcyA9IG5ldyBIYXNoOwoKLy88LzEuMmNvbXBhdD4KCkVsZW1lbnQuUHJvcGVydGllcy5zdHlsZSA9IHsKCglzZXQ6IGZ1bmN0aW9uKHN0eWxlKXsKCQl0aGlzLnN0eWxlLmNzc1RleHQgPSBzdHlsZTsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnN0eWxlLmNzc1RleHQ7Cgl9LAoKCWVyYXNlOiBmdW5jdGlvbigpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9ICcnOwoJfQoKfTsKCkVsZW1lbnQuUHJvcGVydGllcy50YWcgPSB7CgoJZ2V0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCX0KCn07CgpFbGVtZW50LlByb3BlcnRpZXMuaHRtbCA9IHsKCglzZXQ6IGZ1bmN0aW9uKGh0bWwpewoJCWlmIChodG1sID09IG51bGwpIGh0bWwgPSAnJzsKCQllbHNlIGlmICh0eXBlT2YoaHRtbCkgPT0gJ2FycmF5JykgaHRtbCA9IGh0bWwuam9pbignJyk7CgkJdGhpcy5pbm5lckhUTUwgPSBodG1sOwoJfSwKCgllcmFzZTogZnVuY3Rpb24oKXsKCQl0aGlzLmlubmVySFRNTCA9ICcnOwoJfQoKfTsKCi8qPGx0SUU5PiovCi8vIHRlY2huaXF1ZSBieSBqZGJhcmxldHQgLSBodHRwOi8vamRiYXJ0bGV0dC5jb20vaW5uZXJzaGl2Lwp2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CmRpdi5pbm5lckhUTUwgPSAnPG5hdj48L25hdj4nOwp2YXIgc3VwcG9ydHNIVE1MNUVsZW1lbnRzID0gKGRpdi5jaGlsZE5vZGVzLmxlbmd0aCA9PSAxKTsKaWYgKCFzdXBwb3J0c0hUTUw1RWxlbWVudHMpewoJdmFyIHRhZ3MgPSAnYWJiciBhcnRpY2xlIGFzaWRlIGF1ZGlvIGNhbnZhcyBkYXRhbGlzdCBkZXRhaWxzIGZpZ2NhcHRpb24gZmlndXJlIGZvb3RlciBoZWFkZXIgaGdyb3VwIG1hcmsgbWV0ZXIgbmF2IG91dHB1dCBwcm9ncmVzcyBzZWN0aW9uIHN1bW1hcnkgdGltZSB2aWRlbycuc3BsaXQoJyAnKSwKCQlmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwgbCA9IHRhZ3MubGVuZ3RoOwoJd2hpbGUgKGwtLSkgZnJhZ21lbnQuY3JlYXRlRWxlbWVudCh0YWdzW2xdKTsKfQpkaXYgPSBudWxsOwovKjwvbHRJRTk+Ki8KCi8qPElFPiovCnZhciBzdXBwb3J0c1RhYmxlSW5uZXJIVE1MID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJdmFyIHRhYmxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGFibGUnKTsKCXRhYmxlLmlubmVySFRNTCA9ICc8dHI+PHRkPjwvdGQ+PC90cj4nOwoJcmV0dXJuIHRydWU7Cn0pOwoKLyo8bHRGRjQ+Ki8KdmFyIHRyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndHInKSwgaHRtbCA9ICc8dGQ+PC90ZD4nOwp0ci5pbm5lckhUTUwgPSBodG1sOwp2YXIgc3VwcG9ydHNUUklubmVySFRNTCA9ICh0ci5pbm5lckhUTUwgPT0gaHRtbCk7CnRyID0gbnVsbDsKLyo8L2x0RkY0PiovCgppZiAoIXN1cHBvcnRzVGFibGVJbm5lckhUTUwgfHwgIXN1cHBvcnRzVFJJbm5lckhUTUwgfHwgIXN1cHBvcnRzSFRNTDVFbGVtZW50cyl7CgoJRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwuc2V0ID0gKGZ1bmN0aW9uKHNldCl7CgoJCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJCXRhYmxlOiBbMSwgJzx0YWJsZT4nLCAnPC90YWJsZT4nXSwKCQkJc2VsZWN0OiBbMSwgJzxzZWxlY3Q+JywgJzwvc2VsZWN0PiddLAoJCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJCXRyOiBbMywgJzx0YWJsZT48dGJvZHk+PHRyPicsICc8L3RyPjwvdGJvZHk+PC90YWJsZT4nXQoJCX07CgoJCXRyYW5zbGF0aW9ucy50aGVhZCA9IHRyYW5zbGF0aW9ucy50Zm9vdCA9IHRyYW5zbGF0aW9ucy50Ym9keTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGh0bWwpewoJCQl2YXIgd3JhcCA9IHRyYW5zbGF0aW9uc1t0aGlzLmdldCgndGFnJyldOwoJCQlpZiAoIXdyYXAgJiYgIXN1cHBvcnRzSFRNTDVFbGVtZW50cykgd3JhcCA9IFswLCAnJywgJyddOwoJCQlpZiAoIXdyYXApIHJldHVybiBzZXQuY2FsbCh0aGlzLCBodG1sKTsKCgkJCXZhciBsZXZlbCA9IHdyYXBbMF0sIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgdGFyZ2V0ID0gd3JhcHBlcjsKCQkJaWYgKCFzdXBwb3J0c0hUTUw1RWxlbWVudHMpIGZyYWdtZW50LmFwcGVuZENoaWxkKHdyYXBwZXIpOwoJCQl3cmFwcGVyLmlubmVySFRNTCA9IFt3cmFwWzFdLCBodG1sLCB3cmFwWzJdXS5mbGF0dGVuKCkuam9pbignJyk7CgkJCXdoaWxlIChsZXZlbC0tKSB0YXJnZXQgPSB0YXJnZXQuZmlyc3RDaGlsZDsKCQkJdGhpcy5lbXB0eSgpLmFkb3B0KHRhcmdldC5jaGlsZE5vZGVzKTsKCQkJaWYgKCFzdXBwb3J0c0hUTUw1RWxlbWVudHMpIGZyYWdtZW50LnJlbW92ZUNoaWxkKHdyYXBwZXIpOwoJCQl3cmFwcGVyID0gbnVsbDsKCQl9OwoKCX0pKEVsZW1lbnQuUHJvcGVydGllcy5odG1sLnNldCk7Cn0KLyo8L0lFPiovCgovKjxsdElFOT4qLwp2YXIgdGVzdEZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdmb3JtJyk7CnRlc3RGb3JtLmlubmVySFRNTCA9ICc8c2VsZWN0PjxvcHRpb24+czwvb3B0aW9uPjwvc2VsZWN0Pic7CgppZiAodGVzdEZvcm0uZmlyc3RDaGlsZC52YWx1ZSAhPSAncycpIEVsZW1lbnQuUHJvcGVydGllcy52YWx1ZSA9IHsKCglzZXQ6IGZ1bmN0aW9uKHZhbHVlKXsKCQl2YXIgdGFnID0gdGhpcy5nZXQoJ3RhZycpOwoJCWlmICh0YWcgIT0gJ3NlbGVjdCcpIHJldHVybiB0aGlzLnNldFByb3BlcnR5KCd2YWx1ZScsIHZhbHVlKTsKCQl2YXIgb3B0aW9ucyA9IHRoaXMuZ2V0RWxlbWVudHMoJ29wdGlvbicpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgb3B0aW9ucy5sZW5ndGg7IGkrKyl7CgkJCXZhciBvcHRpb24gPSBvcHRpb25zW2ldLAoJCQkJYXR0ciA9IG9wdGlvbi5nZXRBdHRyaWJ1dGVOb2RlKCd2YWx1ZScpLAoJCQkJb3B0aW9uVmFsdWUgPSAoYXR0ciAmJiBhdHRyLnNwZWNpZmllZCkgPyBvcHRpb24udmFsdWUgOiBvcHRpb24uZ2V0KCd0ZXh0Jyk7CgkJCWlmIChvcHRpb25WYWx1ZSA9PSB2YWx1ZSkgcmV0dXJuIG9wdGlvbi5zZWxlY3RlZCA9IHRydWU7CgkJfQoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG9wdGlvbiA9IHRoaXMsIHRhZyA9IG9wdGlvbi5nZXQoJ3RhZycpOwoKCQlpZiAodGFnICE9ICdzZWxlY3QnICYmIHRhZyAhPSAnb3B0aW9uJykgcmV0dXJuIHRoaXMuZ2V0UHJvcGVydHkoJ3ZhbHVlJyk7CgoJCWlmICh0YWcgPT0gJ3NlbGVjdCcgJiYgIShvcHRpb24gPSBvcHRpb24uZ2V0U2VsZWN0ZWQoKVswXSkpIHJldHVybiAnJzsKCgkJdmFyIGF0dHIgPSBvcHRpb24uZ2V0QXR0cmlidXRlTm9kZSgndmFsdWUnKTsKCQlyZXR1cm4gKGF0dHIgJiYgYXR0ci5zcGVjaWZpZWQpID8gb3B0aW9uLnZhbHVlIDogb3B0aW9uLmdldCgndGV4dCcpOwoJfQoKfTsKdGVzdEZvcm0gPSBudWxsOwovKjwvbHRJRTk+Ki8KCi8qPElFPiovCmlmIChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKS5nZXRBdHRyaWJ1dGVOb2RlKCdpZCcpKSBFbGVtZW50LlByb3BlcnRpZXMuaWQgPSB7CglzZXQ6IGZ1bmN0aW9uKGlkKXsKCQl0aGlzLmlkID0gdGhpcy5nZXRBdHRyaWJ1dGVOb2RlKCdpZCcpLnZhbHVlID0gaWQ7Cgl9LAoJZ2V0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmlkIHx8IG51bGw7Cgl9LAoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5pZCA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS52YWx1ZSA9ICcnOwoJfQp9OwovKjwvSUU+Ki8KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LlN0eWxlCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgbWV0aG9kcyBmb3IgaW50ZXJhY3Rpbmcgd2l0aCB0aGUgc3R5bGVzIG9mIEVsZW1lbnRzIGluIGEgZmFzaGlvbmFibGUgd2F5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRWxlbWVudAoKcHJvdmlkZXM6IEVsZW1lbnQuU3R5bGUKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaHRtbCA9IGRvY3VtZW50Lmh0bWw7CgovLzxsdElFOT4KLy8gQ2hlY2sgZm9yIG9sZElFLCB3aGljaCBkb2VzIG5vdCByZW1vdmUgc3R5bGVzIHdoZW4gdGhleSdyZSBzZXQgdG8gbnVsbAp2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKZWwuc3R5bGUuY29sb3IgPSAncmVkJzsKZWwuc3R5bGUuY29sb3IgPSBudWxsOwp2YXIgZG9lc05vdFJlbW92ZVN0eWxlcyA9IGVsLnN0eWxlLmNvbG9yID09ICdyZWQnOwplbCA9IG51bGw7Ci8vPC9sdElFOT4KCkVsZW1lbnQuUHJvcGVydGllcy5zdHlsZXMgPSB7c2V0OiBmdW5jdGlvbihzdHlsZXMpewoJdGhpcy5zZXRTdHlsZXMoc3R5bGVzKTsKfX07Cgp2YXIgaGFzT3BhY2l0eSA9IChodG1sLnN0eWxlLm9wYWNpdHkgIT0gbnVsbCksCgloYXNGaWx0ZXIgPSAoaHRtbC5zdHlsZS5maWx0ZXIgIT0gbnVsbCksCglyZUFscGhhID0gL2FscGhhXChvcGFjaXR5PShbXGQuXSspXCkvaTsKCnZhciBzZXRWaXNpYmlsaXR5ID0gZnVuY3Rpb24oZWxlbWVudCwgb3BhY2l0eSl7CgllbGVtZW50LnN0b3JlKCckb3BhY2l0eScsIG9wYWNpdHkpOwoJZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gb3BhY2l0eSA+IDAgfHwgb3BhY2l0eSA9PSBudWxsID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7Cn07Cgp2YXIgc2V0T3BhY2l0eSA9IChoYXNPcGFjaXR5ID8gZnVuY3Rpb24oZWxlbWVudCwgb3BhY2l0eSl7CgllbGVtZW50LnN0eWxlLm9wYWNpdHkgPSBvcGFjaXR5Owp9IDogKGhhc0ZpbHRlciA/IGZ1bmN0aW9uKGVsZW1lbnQsIG9wYWNpdHkpewoJdmFyIHN0eWxlID0gZWxlbWVudC5zdHlsZTsKCWlmICghZWxlbWVudC5jdXJyZW50U3R5bGUgfHwgIWVsZW1lbnQuY3VycmVudFN0eWxlLmhhc0xheW91dCkgc3R5bGUuem9vbSA9IDE7CglpZiAob3BhY2l0eSA9PSBudWxsIHx8IG9wYWNpdHkgPT0gMSkgb3BhY2l0eSA9ICcnOwoJZWxzZSBvcGFjaXR5ID0gJ2FscGhhKG9wYWNpdHk9JyArIChvcGFjaXR5ICogMTAwKS5saW1pdCgwLCAxMDApLnJvdW5kKCkgKyAnKSc7Cgl2YXIgZmlsdGVyID0gc3R5bGUuZmlsdGVyIHx8IGVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZSgnZmlsdGVyJykgfHwgJyc7CglzdHlsZS5maWx0ZXIgPSByZUFscGhhLnRlc3QoZmlsdGVyKSA/IGZpbHRlci5yZXBsYWNlKHJlQWxwaGEsIG9wYWNpdHkpIDogZmlsdGVyICsgb3BhY2l0eTsKCWlmICghc3R5bGUuZmlsdGVyKSBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUoJ2ZpbHRlcicpOwp9IDogc2V0VmlzaWJpbGl0eSkpOwoKdmFyIGdldE9wYWNpdHkgPSAoaGFzT3BhY2l0eSA/IGZ1bmN0aW9uKGVsZW1lbnQpewoJdmFyIG9wYWNpdHkgPSBlbGVtZW50LnN0eWxlLm9wYWNpdHkgfHwgZWxlbWVudC5nZXRDb21wdXRlZFN0eWxlKCdvcGFjaXR5Jyk7CglyZXR1cm4gKG9wYWNpdHkgPT0gJycpID8gMSA6IG9wYWNpdHkudG9GbG9hdCgpOwp9IDogKGhhc0ZpbHRlciA/IGZ1bmN0aW9uKGVsZW1lbnQpewoJdmFyIGZpbHRlciA9IChlbGVtZW50LnN0eWxlLmZpbHRlciB8fCBlbGVtZW50LmdldENvbXB1dGVkU3R5bGUoJ2ZpbHRlcicpKSwKCQlvcGFjaXR5OwoJaWYgKGZpbHRlcikgb3BhY2l0eSA9IGZpbHRlci5tYXRjaChyZUFscGhhKTsKCXJldHVybiAob3BhY2l0eSA9PSBudWxsIHx8IGZpbHRlciA9PSBudWxsKSA/IDEgOiAob3BhY2l0eVsxXSAvIDEwMCk7Cn0gOiBmdW5jdGlvbihlbGVtZW50KXsKCXZhciBvcGFjaXR5ID0gZWxlbWVudC5yZXRyaWV2ZSgnJG9wYWNpdHknKTsKCWlmIChvcGFjaXR5ID09IG51bGwpIG9wYWNpdHkgPSAoZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID09ICdoaWRkZW4nID8gMCA6IDEpOwoJcmV0dXJuIG9wYWNpdHk7Cn0pKTsKCnZhciBmbG9hdE5hbWUgPSAoaHRtbC5zdHlsZS5jc3NGbG9hdCA9PSBudWxsKSA/ICdzdHlsZUZsb2F0JyA6ICdjc3NGbG9hdCc7CgpFbGVtZW50LmltcGxlbWVudCh7CgoJZ2V0Q29tcHV0ZWRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmICh0aGlzLmN1cnJlbnRTdHlsZSkgcmV0dXJuIHRoaXMuY3VycmVudFN0eWxlW3Byb3BlcnR5LmNhbWVsQ2FzZSgpXTsKCQl2YXIgZGVmYXVsdFZpZXcgPSBFbGVtZW50LmdldERvY3VtZW50KHRoaXMpLmRlZmF1bHRWaWV3LAoJCQljb21wdXRlZCA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCBudWxsKSA6IG51bGw7CgkJcmV0dXJuIChjb21wdXRlZCkgPyBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKChwcm9wZXJ0eSA9PSBmbG9hdE5hbWUpID8gJ2Zsb2F0JyA6IHByb3BlcnR5Lmh5cGhlbmF0ZSgpKSA6IG51bGw7Cgl9LAoKCXNldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCWlmIChwcm9wZXJ0eSA9PSAnb3BhY2l0eScpewoJCQlpZiAodmFsdWUgIT0gbnVsbCkgdmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTsKCQkJc2V0T3BhY2l0eSh0aGlzLCB2YWx1ZSk7CgkJCXJldHVybiB0aGlzOwoJCX0KCQlwcm9wZXJ0eSA9IChwcm9wZXJ0eSA9PSAnZmxvYXQnID8gZmxvYXROYW1lIDogcHJvcGVydHkpLmNhbWVsQ2FzZSgpOwoJCWlmICh0eXBlT2YodmFsdWUpICE9ICdzdHJpbmcnKXsKCQkJdmFyIG1hcCA9IChFbGVtZW50LlN0eWxlc1twcm9wZXJ0eV0gfHwgJ0AnKS5zcGxpdCgnICcpOwoJCQl2YWx1ZSA9IEFycmF5LmZyb20odmFsdWUpLm1hcChmdW5jdGlvbih2YWwsIGkpewoJCQkJaWYgKCFtYXBbaV0pIHJldHVybiAnJzsKCQkJCXJldHVybiAodHlwZU9mKHZhbCkgPT0gJ251bWJlcicpID8gbWFwW2ldLnJlcGxhY2UoJ0AnLCBNYXRoLnJvdW5kKHZhbCkpIDogdmFsOwoJCQl9KS5qb2luKCcgJyk7CgkJfSBlbHNlIGlmICh2YWx1ZSA9PSBTdHJpbmcoTnVtYmVyKHZhbHVlKSkpewoJCQl2YWx1ZSA9IE1hdGgucm91bmQodmFsdWUpOwoJCX0KCQl0aGlzLnN0eWxlW3Byb3BlcnR5XSA9IHZhbHVlOwoJCS8vPGx0SUU5PgoJCWlmICgodmFsdWUgPT0gJycgfHwgdmFsdWUgPT0gbnVsbCkgJiYgZG9lc05vdFJlbW92ZVN0eWxlcyAmJiB0aGlzLnN0eWxlLnJlbW92ZUF0dHJpYnV0ZSl7CgkJCXRoaXMuc3R5bGUucmVtb3ZlQXR0cmlidXRlKHByb3BlcnR5KTsKCQl9CgkJLy88L2x0SUU5PgoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmIChwcm9wZXJ0eSA9PSAnb3BhY2l0eScpIHJldHVybiBnZXRPcGFjaXR5KHRoaXMpOwoJCXByb3BlcnR5ID0gKHByb3BlcnR5ID09ICdmbG9hdCcgPyBmbG9hdE5hbWUgOiBwcm9wZXJ0eSkuY2FtZWxDYXNlKCk7CgkJdmFyIHJlc3VsdCA9IHRoaXMuc3R5bGVbcHJvcGVydHldOwoJCWlmICghcmVzdWx0IHx8IHByb3BlcnR5ID09ICd6SW5kZXgnKXsKCQkJcmVzdWx0ID0gW107CgkJCWZvciAodmFyIHN0eWxlIGluIEVsZW1lbnQuU2hvcnRTdHlsZXMpewoJCQkJaWYgKHByb3BlcnR5ICE9IHN0eWxlKSBjb250aW51ZTsKCQkJCWZvciAodmFyIHMgaW4gRWxlbWVudC5TaG9ydFN0eWxlc1tzdHlsZV0pIHJlc3VsdC5wdXNoKHRoaXMuZ2V0U3R5bGUocykpOwoJCQkJcmV0dXJuIHJlc3VsdC5qb2luKCcgJyk7CgkJCX0KCQkJcmVzdWx0ID0gdGhpcy5nZXRDb21wdXRlZFN0eWxlKHByb3BlcnR5KTsKCQl9CgkJaWYgKHJlc3VsdCl7CgkJCXJlc3VsdCA9IFN0cmluZyhyZXN1bHQpOwoJCQl2YXIgY29sb3IgPSByZXN1bHQubWF0Y2goL3JnYmE/XChbXGRccyxdK1wpLyk7CgkJCWlmIChjb2xvcikgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoY29sb3JbMF0sIGNvbG9yWzBdLnJnYlRvSGV4KCkpOwoJCX0KCQlpZiAoQnJvd3Nlci5vcGVyYSB8fCBCcm93c2VyLmllKXsKCQkJaWYgKCgvXihoZWlnaHR8d2lkdGgpJC8pLnRlc3QocHJvcGVydHkpICYmICEoL3B4JC8udGVzdChyZXN1bHQpKSl7CgkJCQl2YXIgdmFsdWVzID0gKHByb3BlcnR5ID09ICd3aWR0aCcpID8gWydsZWZ0JywgJ3JpZ2h0J10gOiBbJ3RvcCcsICdib3R0b20nXSwgc2l6ZSA9IDA7CgkJCQl2YWx1ZXMuZWFjaChmdW5jdGlvbih2YWx1ZSl7CgkJCQkJc2l6ZSArPSB0aGlzLmdldFN0eWxlKCdib3JkZXItJyArIHZhbHVlICsgJy13aWR0aCcpLnRvSW50KCkgKyB0aGlzLmdldFN0eWxlKCdwYWRkaW5nLScgKyB2YWx1ZSkudG9JbnQoKTsKCQkJCX0sIHRoaXMpOwoJCQkJcmV0dXJuIHRoaXNbJ29mZnNldCcgKyBwcm9wZXJ0eS5jYXBpdGFsaXplKCldIC0gc2l6ZSArICdweCc7CgkJCX0KCQkJaWYgKEJyb3dzZXIuaWUgJiYgKC9eYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nLykudGVzdChwcm9wZXJ0eSkgJiYgaXNOYU4ocGFyc2VGbG9hdChyZXN1bHQpKSl7CgkJCQlyZXR1cm4gJzBweCc7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJc2V0U3R5bGVzOiBmdW5jdGlvbihzdHlsZXMpewoJCWZvciAodmFyIHN0eWxlIGluIHN0eWxlcykgdGhpcy5zZXRTdHlsZShzdHlsZSwgc3R5bGVzW3N0eWxlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlczogZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0ID0ge307CgkJQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLmVhY2goZnVuY3Rpb24oa2V5KXsKCQkJcmVzdWx0W2tleV0gPSB0aGlzLmdldFN0eWxlKGtleSk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHJlc3VsdDsKCX0KCn0pOwoKRWxlbWVudC5TdHlsZXMgPSB7CglsZWZ0OiAnQHB4JywgdG9wOiAnQHB4JywgYm90dG9tOiAnQHB4JywgcmlnaHQ6ICdAcHgnLAoJd2lkdGg6ICdAcHgnLCBoZWlnaHQ6ICdAcHgnLCBtYXhXaWR0aDogJ0BweCcsIG1heEhlaWdodDogJ0BweCcsIG1pbldpZHRoOiAnQHB4JywgbWluSGVpZ2h0OiAnQHB4JywKCWJhY2tncm91bmRDb2xvcjogJ3JnYihALCBALCBAKScsIGJhY2tncm91bmRQb3NpdGlvbjogJ0BweCBAcHgnLCBjb2xvcjogJ3JnYihALCBALCBAKScsCglmb250U2l6ZTogJ0BweCcsIGxldHRlclNwYWNpbmc6ICdAcHgnLCBsaW5lSGVpZ2h0OiAnQHB4JywgY2xpcDogJ3JlY3QoQHB4IEBweCBAcHggQHB4KScsCgltYXJnaW46ICdAcHggQHB4IEBweCBAcHgnLCBwYWRkaW5nOiAnQHB4IEBweCBAcHggQHB4JywgYm9yZGVyOiAnQHB4IEAgcmdiKEAsIEAsIEApIEBweCBAIHJnYihALCBALCBAKSBAcHggQCByZ2IoQCwgQCwgQCknLAoJYm9yZGVyV2lkdGg6ICdAcHggQHB4IEBweCBAcHgnLCBib3JkZXJTdHlsZTogJ0AgQCBAIEAnLCBib3JkZXJDb2xvcjogJ3JnYihALCBALCBAKSByZ2IoQCwgQCwgQCkgcmdiKEAsIEAsIEApIHJnYihALCBALCBAKScsCgl6SW5kZXg6ICdAJywgJ3pvb20nOiAnQCcsIGZvbnRXZWlnaHQ6ICdAJywgdGV4dEluZGVudDogJ0BweCcsIG9wYWNpdHk6ICdAJwp9OwoKLy88MS4zY29tcGF0PgoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNldE9wYWNpdHk6IGZ1bmN0aW9uKHZhbHVlKXsKCQlzZXRPcGFjaXR5KHRoaXMsIHZhbHVlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0T3BhY2l0eTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gZ2V0T3BhY2l0eSh0aGlzKTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLm9wYWNpdHkgPSB7CgoJc2V0OiBmdW5jdGlvbihvcGFjaXR5KXsKCQlzZXRPcGFjaXR5KHRoaXMsIG9wYWNpdHkpOwoJCXNldFZpc2liaWxpdHkodGhpcywgb3BhY2l0eSk7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gZ2V0T3BhY2l0eSh0aGlzKTsKCX0KCn07CgovLzwvMS4zY29tcGF0PgoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5TdHlsZXMgPSBuZXcgSGFzaChFbGVtZW50LlN0eWxlcyk7CgovLzwvMS4yY29tcGF0PgoKRWxlbWVudC5TaG9ydFN0eWxlcyA9IHttYXJnaW46IHt9LCBwYWRkaW5nOiB7fSwgYm9yZGVyOiB7fSwgYm9yZGVyV2lkdGg6IHt9LCBib3JkZXJTdHlsZToge30sIGJvcmRlckNvbG9yOiB7fX07CgpbJ1RvcCcsICdSaWdodCcsICdCb3R0b20nLCAnTGVmdCddLmVhY2goZnVuY3Rpb24oZGlyZWN0aW9uKXsKCXZhciBTaG9ydCA9IEVsZW1lbnQuU2hvcnRTdHlsZXM7Cgl2YXIgQWxsID0gRWxlbWVudC5TdHlsZXM7CglbJ21hcmdpbicsICdwYWRkaW5nJ10uZWFjaChmdW5jdGlvbihzdHlsZSl7CgkJdmFyIHNkID0gc3R5bGUgKyBkaXJlY3Rpb247CgkJU2hvcnRbc3R5bGVdW3NkXSA9IEFsbFtzZF0gPSAnQHB4JzsKCX0pOwoJdmFyIGJkID0gJ2JvcmRlcicgKyBkaXJlY3Rpb247CglTaG9ydC5ib3JkZXJbYmRdID0gQWxsW2JkXSA9ICdAcHggQCByZ2IoQCwgQCwgQCknOwoJdmFyIGJkdyA9IGJkICsgJ1dpZHRoJywgYmRzID0gYmQgKyAnU3R5bGUnLCBiZGMgPSBiZCArICdDb2xvcic7CglTaG9ydFtiZF0gPSB7fTsKCVNob3J0LmJvcmRlcldpZHRoW2Jkd10gPSBTaG9ydFtiZF1bYmR3XSA9IEFsbFtiZHddID0gJ0BweCc7CglTaG9ydC5ib3JkZXJTdHlsZVtiZHNdID0gU2hvcnRbYmRdW2Jkc10gPSBBbGxbYmRzXSA9ICdAJzsKCVNob3J0LmJvcmRlckNvbG9yW2JkY10gPSBTaG9ydFtiZF1bYmRjXSA9IEFsbFtiZGNdID0gJ3JnYihALCBALCBAKSc7Cn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IEVsZW1lbnQuRXZlbnQKCmRlc2NyaXB0aW9uOiBDb250YWlucyBFbGVtZW50IG1ldGhvZHMgZm9yIGRlYWxpbmcgd2l0aCBldmVudHMuIFRoaXMgZmlsZSBhbHNvIGluY2x1ZGVzIG1vdXNlZW50ZXIgYW5kIG1vdXNlbGVhdmUgY3VzdG9tIEVsZW1lbnQgRXZlbnRzLCBpZiBuZWNlc3NhcnkuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgRXZlbnRdCgpwcm92aWRlczogRWxlbWVudC5FdmVudAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCkVsZW1lbnQuUHJvcGVydGllcy5ldmVudHMgPSB7c2V0OiBmdW5jdGlvbihldmVudHMpewoJdGhpcy5hZGRFdmVudHMoZXZlbnRzKTsKfX07CgpbRWxlbWVudCwgV2luZG93LCBEb2N1bWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl2YXIgZXZlbnRzID0gdGhpcy5yZXRyaWV2ZSgnZXZlbnRzJywge30pOwoJCWlmICghZXZlbnRzW3R5cGVdKSBldmVudHNbdHlwZV0gPSB7a2V5czogW10sIHZhbHVlczogW119OwoJCWlmIChldmVudHNbdHlwZV0ua2V5cy5jb250YWlucyhmbikpIHJldHVybiB0aGlzOwoJCWV2ZW50c1t0eXBlXS5rZXlzLnB1c2goZm4pOwoJCXZhciByZWFsVHlwZSA9IHR5cGUsCgkJCWN1c3RvbSA9IEVsZW1lbnQuRXZlbnRzW3R5cGVdLAoJCQljb25kaXRpb24gPSBmbiwKCQkJc2VsZiA9IHRoaXM7CgkJaWYgKGN1c3RvbSl7CgkJCWlmIChjdXN0b20ub25BZGQpIGN1c3RvbS5vbkFkZC5jYWxsKHRoaXMsIGZuLCB0eXBlKTsKCQkJaWYgKGN1c3RvbS5jb25kaXRpb24pewoJCQkJY29uZGl0aW9uID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJCWlmIChjdXN0b20uY29uZGl0aW9uLmNhbGwodGhpcywgZXZlbnQsIHR5cGUpKSByZXR1cm4gZm4uY2FsbCh0aGlzLCBldmVudCk7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9OwoJCQl9CgkJCWlmIChjdXN0b20uYmFzZSkgcmVhbFR5cGUgPSBGdW5jdGlvbi5mcm9tKGN1c3RvbS5iYXNlKS5jYWxsKHRoaXMsIHR5cGUpOwoJCX0KCQl2YXIgZGVmbiA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmbi5jYWxsKHNlbGYpOwoJCX07CgkJdmFyIG5hdGl2ZUV2ZW50ID0gRWxlbWVudC5OYXRpdmVFdmVudHNbcmVhbFR5cGVdOwoJCWlmIChuYXRpdmVFdmVudCl7CgkJCWlmIChuYXRpdmVFdmVudCA9PSAyKXsKCQkJCWRlZm4gPSBmdW5jdGlvbihldmVudCl7CgkJCQkJZXZlbnQgPSBuZXcgRE9NRXZlbnQoZXZlbnQsIHNlbGYuZ2V0V2luZG93KCkpOwoJCQkJCWlmIChjb25kaXRpb24uY2FsbChzZWxmLCBldmVudCkgPT09IGZhbHNlKSBldmVudC5zdG9wKCk7CgkJCQl9OwoJCQl9CgkJCXRoaXMuYWRkTGlzdGVuZXIocmVhbFR5cGUsIGRlZm4sIGFyZ3VtZW50c1syXSk7CgkJfQoJCWV2ZW50c1t0eXBlXS52YWx1ZXMucHVzaChkZWZuKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl2YXIgZXZlbnRzID0gdGhpcy5yZXRyaWV2ZSgnZXZlbnRzJyk7CgkJaWYgKCFldmVudHMgfHwgIWV2ZW50c1t0eXBlXSkgcmV0dXJuIHRoaXM7CgkJdmFyIGxpc3QgPSBldmVudHNbdHlwZV07CgkJdmFyIGluZGV4ID0gbGlzdC5rZXlzLmluZGV4T2YoZm4pOwoJCWlmIChpbmRleCA9PSAtMSkgcmV0dXJuIHRoaXM7CgkJdmFyIHZhbHVlID0gbGlzdC52YWx1ZXNbaW5kZXhdOwoJCWRlbGV0ZSBsaXN0LmtleXNbaW5kZXhdOwoJCWRlbGV0ZSBsaXN0LnZhbHVlc1tpbmRleF07CgkJdmFyIGN1c3RvbSA9IEVsZW1lbnQuRXZlbnRzW3R5cGVdOwoJCWlmIChjdXN0b20pewoJCQlpZiAoY3VzdG9tLm9uUmVtb3ZlKSBjdXN0b20ub25SZW1vdmUuY2FsbCh0aGlzLCBmbiwgdHlwZSk7CgkJCWlmIChjdXN0b20uYmFzZSkgdHlwZSA9IEZ1bmN0aW9uLmZyb20oY3VzdG9tLmJhc2UpLmNhbGwodGhpcywgdHlwZSk7CgkJfQoJCXJldHVybiAoRWxlbWVudC5OYXRpdmVFdmVudHNbdHlwZV0pID8gdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCB2YWx1ZSwgYXJndW1lbnRzWzJdKSA6IHRoaXM7Cgl9LAoKCWFkZEV2ZW50czogZnVuY3Rpb24oZXZlbnRzKXsKCQlmb3IgKHZhciBldmVudCBpbiBldmVudHMpIHRoaXMuYWRkRXZlbnQoZXZlbnQsIGV2ZW50c1tldmVudF0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJdmFyIGF0dGFjaGVkID0gdGhpcy5yZXRyaWV2ZSgnZXZlbnRzJyk7CgkJaWYgKCFhdHRhY2hlZCkgcmV0dXJuIHRoaXM7CgkJaWYgKCFldmVudHMpewoJCQlmb3IgKHR5cGUgaW4gYXR0YWNoZWQpIHRoaXMucmVtb3ZlRXZlbnRzKHR5cGUpOwoJCQl0aGlzLmVsaW1pbmF0ZSgnZXZlbnRzJyk7CgkJfSBlbHNlIGlmIChhdHRhY2hlZFtldmVudHNdKXsKCQkJYXR0YWNoZWRbZXZlbnRzXS5rZXlzLmVhY2goZnVuY3Rpb24oZm4pewoJCQkJdGhpcy5yZW1vdmVFdmVudChldmVudHMsIGZuKTsKCQkJfSwgdGhpcyk7CgkJCWRlbGV0ZSBhdHRhY2hlZFtldmVudHNdOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJZmlyZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBhcmdzLCBkZWxheSl7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghZXZlbnRzIHx8ICFldmVudHNbdHlwZV0pIHJldHVybiB0aGlzOwoJCWFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoKCQlldmVudHNbdHlwZV0ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJaWYgKGRlbGF5KSBmbi5kZWxheShkZWxheSwgdGhpcywgYXJncyk7CgkJCWVsc2UgZm4uYXBwbHkodGhpcywgYXJncyk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb25lRXZlbnRzOiBmdW5jdGlvbihmcm9tLCB0eXBlKXsKCQlmcm9tID0gZG9jdW1lbnQuaWQoZnJvbSk7CgkJdmFyIGV2ZW50cyA9IGZyb20ucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghZXZlbnRzKSByZXR1cm4gdGhpczsKCQlpZiAoIXR5cGUpewoJCQlmb3IgKHZhciBldmVudFR5cGUgaW4gZXZlbnRzKSB0aGlzLmNsb25lRXZlbnRzKGZyb20sIGV2ZW50VHlwZSk7CgkJfSBlbHNlIGlmIChldmVudHNbdHlwZV0pewoJCQlldmVudHNbdHlwZV0ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMuYWRkRXZlbnQodHlwZSwgZm4pOwoJCQl9LCB0aGlzKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkVsZW1lbnQuTmF0aXZlRXZlbnRzID0gewoJY2xpY2s6IDIsIGRibGNsaWNrOiAyLCBtb3VzZXVwOiAyLCBtb3VzZWRvd246IDIsIGNvbnRleHRtZW51OiAyLCAvL21vdXNlIGJ1dHRvbnMKCW1vdXNld2hlZWw6IDIsIERPTU1vdXNlU2Nyb2xsOiAyLCAvL21vdXNlIHdoZWVsCgltb3VzZW92ZXI6IDIsIG1vdXNlb3V0OiAyLCBtb3VzZW1vdmU6IDIsIHNlbGVjdHN0YXJ0OiAyLCBzZWxlY3RlbmQ6IDIsIC8vbW91c2UgbW92ZW1lbnQKCWtleWRvd246IDIsIGtleXByZXNzOiAyLCBrZXl1cDogMiwgLy9rZXlib2FyZAoJb3JpZW50YXRpb25jaGFuZ2U6IDIsIC8vIG1vYmlsZQoJdG91Y2hzdGFydDogMiwgdG91Y2htb3ZlOiAyLCB0b3VjaGVuZDogMiwgdG91Y2hjYW5jZWw6IDIsIC8vIHRvdWNoCglnZXN0dXJlc3RhcnQ6IDIsIGdlc3R1cmVjaGFuZ2U6IDIsIGdlc3R1cmVlbmQ6IDIsIC8vIGdlc3R1cmUKCWZvY3VzOiAyLCBibHVyOiAyLCBjaGFuZ2U6IDIsIHJlc2V0OiAyLCBzZWxlY3Q6IDIsIHN1Ym1pdDogMiwgcGFzdGU6IDIsIGlucHV0OiAyLCAvL2Zvcm0gZWxlbWVudHMKCWxvYWQ6IDIsIHVubG9hZDogMSwgYmVmb3JldW5sb2FkOiAyLCByZXNpemU6IDEsIG1vdmU6IDEsIERPTUNvbnRlbnRMb2FkZWQ6IDEsIHJlYWR5c3RhdGVjaGFuZ2U6IDEsIC8vd2luZG93CgllcnJvcjogMSwgYWJvcnQ6IDEsIHNjcm9sbDogMSAvL21pc2MKfTsKCkVsZW1lbnQuRXZlbnRzID0ge21vdXNld2hlZWw6IHsKCWJhc2U6IChCcm93c2VyLmZpcmVmb3gpID8gJ0RPTU1vdXNlU2Nyb2xsJyA6ICdtb3VzZXdoZWVsJwp9fTsKCmlmICgnb25tb3VzZWVudGVyJyBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpewoJRWxlbWVudC5OYXRpdmVFdmVudHMubW91c2VlbnRlciA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzLm1vdXNlbGVhdmUgPSAyOwp9IGVsc2UgewoJdmFyIGNoZWNrID0gZnVuY3Rpb24oZXZlbnQpewoJCXZhciByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldDsKCQlpZiAocmVsYXRlZCA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKCQlpZiAoIXJlbGF0ZWQpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gKHJlbGF0ZWQgIT0gdGhpcyAmJiByZWxhdGVkLnByZWZpeCAhPSAneHVsJyAmJiB0eXBlT2YodGhpcykgIT0gJ2RvY3VtZW50JyAmJiAhdGhpcy5jb250YWlucyhyZWxhdGVkKSk7Cgl9OwoKCUVsZW1lbnQuRXZlbnRzLm1vdXNlZW50ZXIgPSB7CgkJYmFzZTogJ21vdXNlb3ZlcicsCgkJY29uZGl0aW9uOiBjaGVjawoJfTsKCglFbGVtZW50LkV2ZW50cy5tb3VzZWxlYXZlID0gewoJCWJhc2U6ICdtb3VzZW91dCcsCgkJY29uZGl0aW9uOiBjaGVjawoJfTsKfQoKLyo8bHRJRTk+Ki8KaWYgKCF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcil7CglFbGVtZW50Lk5hdGl2ZUV2ZW50cy5wcm9wZXJ0eWNoYW5nZSA9IDI7CglFbGVtZW50LkV2ZW50cy5jaGFuZ2UgPSB7CgkJYmFzZTogZnVuY3Rpb24oKXsKCQkJdmFyIHR5cGUgPSB0aGlzLnR5cGU7CgkJCXJldHVybiAodGhpcy5nZXQoJ3RhZycpID09ICdpbnB1dCcgJiYgKHR5cGUgPT0gJ3JhZGlvJyB8fCB0eXBlID09ICdjaGVja2JveCcpKSA/ICdwcm9wZXJ0eWNoYW5nZScgOiAnY2hhbmdlJwoJCX0sCgkJY29uZGl0aW9uOiBmdW5jdGlvbihldmVudCl7CgkJCXJldHVybiB0aGlzLnR5cGUgIT0gJ3JhZGlvJyB8fCAoZXZlbnQuZXZlbnQucHJvcGVydHlOYW1lID09ICdjaGVja2VkJyAmJiB0aGlzLmNoZWNrZWQpOwoJCX0KCX0KfQovKjwvbHRJRTk+Ki8KCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuRXZlbnRzID0gbmV3IEhhc2goRWxlbWVudC5FdmVudHMpOwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkRlbGVnYXRpb24KCmRlc2NyaXB0aW9uOiBFeHRlbmRzIHRoZSBFbGVtZW50IG5hdGl2ZSBvYmplY3QgdG8gaW5jbHVkZSB0aGUgZGVsZWdhdGUgbWV0aG9kIGZvciBtb3JlIGVmZmljaWVudCBldmVudCBtYW5hZ2VtZW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQuRXZlbnRdCgpwcm92aWRlczogW0VsZW1lbnQuRGVsZWdhdGlvbl0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZXZlbnRMaXN0ZW5lclN1cHBvcnQgPSAhIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyOwoKRWxlbWVudC5OYXRpdmVFdmVudHMuZm9jdXNpbiA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzLmZvY3Vzb3V0ID0gMjsKCnZhciBidWJibGVVcCA9IGZ1bmN0aW9uKHNlbGYsIG1hdGNoLCBmbiwgZXZlbnQsIHRhcmdldCl7Cgl3aGlsZSAodGFyZ2V0ICYmIHRhcmdldCAhPSBzZWxmKXsKCQlpZiAobWF0Y2godGFyZ2V0LCBldmVudCkpIHJldHVybiBmbi5jYWxsKHRhcmdldCwgZXZlbnQsIHRhcmdldCk7CgkJdGFyZ2V0ID0gZG9jdW1lbnQuaWQodGFyZ2V0LnBhcmVudE5vZGUpOwoJfQp9OwoKdmFyIG1hcCA9IHsKCW1vdXNlZW50ZXI6IHsKCQliYXNlOiAnbW91c2VvdmVyJwoJfSwKCW1vdXNlbGVhdmU6IHsKCQliYXNlOiAnbW91c2VvdXQnCgl9LAoJZm9jdXM6IHsKCQliYXNlOiAnZm9jdXMnICsgKGV2ZW50TGlzdGVuZXJTdXBwb3J0ID8gJycgOiAnaW4nKSwKCQljYXB0dXJlOiB0cnVlCgl9LAoJYmx1cjogewoJCWJhc2U6IGV2ZW50TGlzdGVuZXJTdXBwb3J0ID8gJ2JsdXInIDogJ2ZvY3Vzb3V0JywKCQljYXB0dXJlOiB0cnVlCgl9Cn07CgovKjxsdElFOT4qLwp2YXIgX2tleSA9ICckZGVsZWdhdGlvbjonOwp2YXIgZm9ybU9ic2VydmVyID0gZnVuY3Rpb24odHlwZSl7CgoJcmV0dXJuIHsKCgkJYmFzZTogJ2ZvY3VzaW4nLAoKCQlyZW1vdmU6IGZ1bmN0aW9uKHNlbGYsIHVpZCl7CgkJCXZhciBsaXN0ID0gc2VsZi5yZXRyaWV2ZShfa2V5ICsgdHlwZSArICdsaXN0ZW5lcnMnLCB7fSlbdWlkXTsKCQkJaWYgKGxpc3QgJiYgbGlzdC5mb3JtcykgZm9yICh2YXIgaSA9IGxpc3QuZm9ybXMubGVuZ3RoOyBpLS07KXsKCQkJCWxpc3QuZm9ybXNbaV0ucmVtb3ZlRXZlbnQodHlwZSwgbGlzdC5mbnNbaV0pOwoJCQl9CgkJfSwKCgkJbGlzdGVuOiBmdW5jdGlvbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQsIHVpZCl7CgkJCXZhciBmb3JtID0gKHRhcmdldC5nZXQoJ3RhZycpID09ICdmb3JtJykgPyB0YXJnZXQgOiBldmVudC50YXJnZXQuZ2V0UGFyZW50KCdmb3JtJyk7CgkJCWlmICghZm9ybSkgcmV0dXJuOwoKCQkJdmFyIGxpc3RlbmVycyA9IHNlbGYucmV0cmlldmUoX2tleSArIHR5cGUgKyAnbGlzdGVuZXJzJywge30pLAoJCQkJbGlzdGVuZXIgPSBsaXN0ZW5lcnNbdWlkXSB8fCB7Zm9ybXM6IFtdLCBmbnM6IFtdfSwKCQkJCWZvcm1zID0gbGlzdGVuZXIuZm9ybXMsIGZucyA9IGxpc3RlbmVyLmZuczsKCgkJCWlmIChmb3Jtcy5pbmRleE9mKGZvcm0pICE9IC0xKSByZXR1cm47CgkJCWZvcm1zLnB1c2goZm9ybSk7CgoJCQl2YXIgX2ZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQkJfTsKCQkJZm9ybS5hZGRFdmVudCh0eXBlLCBfZm4pOwoJCQlmbnMucHVzaChfZm4pOwoKCQkJbGlzdGVuZXJzW3VpZF0gPSBsaXN0ZW5lcjsKCQkJc2VsZi5zdG9yZShfa2V5ICsgdHlwZSArICdsaXN0ZW5lcnMnLCBsaXN0ZW5lcnMpOwoJCX0KCX07Cn07Cgp2YXIgaW5wdXRPYnNlcnZlciA9IGZ1bmN0aW9uKHR5cGUpewoJcmV0dXJuIHsKCQliYXNlOiAnZm9jdXNpbicsCgkJbGlzdGVuOiBmdW5jdGlvbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQpewoJCQl2YXIgZXZlbnRzID0ge2JsdXI6IGZ1bmN0aW9uKCl7CgkJCQl0aGlzLnJlbW92ZUV2ZW50cyhldmVudHMpOwoJCQl9fTsKCQkJZXZlbnRzW3R5cGVdID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQkJfTsKCQkJZXZlbnQudGFyZ2V0LmFkZEV2ZW50cyhldmVudHMpOwoJCX0KCX07Cn07CgppZiAoIWV2ZW50TGlzdGVuZXJTdXBwb3J0KSBPYmplY3QuYXBwZW5kKG1hcCwgewoJc3VibWl0OiBmb3JtT2JzZXJ2ZXIoJ3N1Ym1pdCcpLAoJcmVzZXQ6IGZvcm1PYnNlcnZlcigncmVzZXQnKSwKCWNoYW5nZTogaW5wdXRPYnNlcnZlcignY2hhbmdlJyksCglzZWxlY3Q6IGlucHV0T2JzZXJ2ZXIoJ3NlbGVjdCcpCn0pOwovKjwvbHRJRTk+Ki8KCnZhciBwcm90byA9IEVsZW1lbnQucHJvdG90eXBlLAoJYWRkRXZlbnQgPSBwcm90by5hZGRFdmVudCwKCXJlbW92ZUV2ZW50ID0gcHJvdG8ucmVtb3ZlRXZlbnQ7Cgp2YXIgcmVsYXkgPSBmdW5jdGlvbihvbGQsIG1ldGhvZCl7CglyZXR1cm4gZnVuY3Rpb24odHlwZSwgZm4sIHVzZUNhcHR1cmUpewoJCWlmICh0eXBlLmluZGV4T2YoJzpyZWxheScpID09IC0xKSByZXR1cm4gb2xkLmNhbGwodGhpcywgdHlwZSwgZm4sIHVzZUNhcHR1cmUpOwoJCXZhciBwYXJzZWQgPSBTbGljay5wYXJzZSh0eXBlKS5leHByZXNzaW9uc1swXVswXTsKCQlpZiAocGFyc2VkLnBzZXVkb3NbMF0ua2V5ICE9ICdyZWxheScpIHJldHVybiBvbGQuY2FsbCh0aGlzLCB0eXBlLCBmbiwgdXNlQ2FwdHVyZSk7CgkJdmFyIG5ld1R5cGUgPSBwYXJzZWQudGFnOwoJCXBhcnNlZC5wc2V1ZG9zLnNsaWNlKDEpLmVhY2goZnVuY3Rpb24ocHNldWRvKXsKCQkJbmV3VHlwZSArPSAnOicgKyBwc2V1ZG8ua2V5ICsgKHBzZXVkby52YWx1ZSA/ICcoJyArIHBzZXVkby52YWx1ZSArICcpJyA6ICcnKTsKCQl9KTsKCQlvbGQuY2FsbCh0aGlzLCB0eXBlLCBmbik7CgkJcmV0dXJuIG1ldGhvZC5jYWxsKHRoaXMsIG5ld1R5cGUsIHBhcnNlZC5wc2V1ZG9zWzBdLnZhbHVlLCBmbik7Cgl9Owp9OwoKdmFyIGRlbGVnYXRpb24gPSB7CgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIG1hdGNoLCBmbil7CgkJdmFyIHN0b3JhZ2UgPSB0aGlzLnJldHJpZXZlKCckZGVsZWdhdGVzJywge30pLCBzdG9yZWQgPSBzdG9yYWdlW3R5cGVdOwoJCWlmIChzdG9yZWQpIGZvciAodmFyIF91aWQgaW4gc3RvcmVkKXsKCQkJaWYgKHN0b3JlZFtfdWlkXS5mbiA9PSBmbiAmJiBzdG9yZWRbX3VpZF0ubWF0Y2ggPT0gbWF0Y2gpIHJldHVybiB0aGlzOwoJCX0KCgkJdmFyIF90eXBlID0gdHlwZSwgX21hdGNoID0gbWF0Y2gsIF9mbiA9IGZuLCBfbWFwID0gbWFwW3R5cGVdIHx8IHt9OwoJCXR5cGUgPSBfbWFwLmJhc2UgfHwgX3R5cGU7CgoJCW1hdGNoID0gZnVuY3Rpb24odGFyZ2V0KXsKCQkJcmV0dXJuIFNsaWNrLm1hdGNoKHRhcmdldCwgX21hdGNoKTsKCQl9OwoKCQl2YXIgZWxlbWVudEV2ZW50ID0gRWxlbWVudC5FdmVudHNbX3R5cGVdOwoJCWlmIChlbGVtZW50RXZlbnQgJiYgZWxlbWVudEV2ZW50LmNvbmRpdGlvbil7CgkJCXZhciBfX21hdGNoID0gbWF0Y2gsIGNvbmRpdGlvbiA9IGVsZW1lbnRFdmVudC5jb25kaXRpb247CgkJCW1hdGNoID0gZnVuY3Rpb24odGFyZ2V0LCBldmVudCl7CgkJCQlyZXR1cm4gX19tYXRjaCh0YXJnZXQsIGV2ZW50KSAmJiBjb25kaXRpb24uY2FsbCh0YXJnZXQsIGV2ZW50LCB0eXBlKTsKCQkJfTsKCQl9CgoJCXZhciBzZWxmID0gdGhpcywgdWlkID0gU3RyaW5nLnVuaXF1ZUlEKCk7CgkJdmFyIGRlbGVnYXRvciA9IF9tYXAubGlzdGVuID8gZnVuY3Rpb24oZXZlbnQsIHRhcmdldCl7CgkJCWlmICghdGFyZ2V0ICYmIGV2ZW50ICYmIGV2ZW50LnRhcmdldCkgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCQlpZiAodGFyZ2V0KSBfbWFwLmxpc3RlbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQsIHVpZCk7CgkJfSA6IGZ1bmN0aW9uKGV2ZW50LCB0YXJnZXQpewoJCQlpZiAoIXRhcmdldCAmJiBldmVudCAmJiBldmVudC50YXJnZXQpIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQkJaWYgKHRhcmdldCkgYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQl9OwoKCQlpZiAoIXN0b3JlZCkgc3RvcmVkID0ge307CgkJc3RvcmVkW3VpZF0gPSB7CgkJCW1hdGNoOiBfbWF0Y2gsCgkJCWZuOiBfZm4sCgkJCWRlbGVnYXRvcjogZGVsZWdhdG9yCgkJfTsKCQlzdG9yYWdlW190eXBlXSA9IHN0b3JlZDsKCQlyZXR1cm4gYWRkRXZlbnQuY2FsbCh0aGlzLCB0eXBlLCBkZWxlZ2F0b3IsIF9tYXAuY2FwdHVyZSk7Cgl9LAoKCXJlbW92ZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBtYXRjaCwgZm4sIF91aWQpewoJCXZhciBzdG9yYWdlID0gdGhpcy5yZXRyaWV2ZSgnJGRlbGVnYXRlcycsIHt9KSwgc3RvcmVkID0gc3RvcmFnZVt0eXBlXTsKCQlpZiAoIXN0b3JlZCkgcmV0dXJuIHRoaXM7CgoJCWlmIChfdWlkKXsKCQkJdmFyIF90eXBlID0gdHlwZSwgZGVsZWdhdG9yID0gc3RvcmVkW191aWRdLmRlbGVnYXRvciwgX21hcCA9IG1hcFt0eXBlXSB8fCB7fTsKCQkJdHlwZSA9IF9tYXAuYmFzZSB8fCBfdHlwZTsKCQkJaWYgKF9tYXAucmVtb3ZlKSBfbWFwLnJlbW92ZSh0aGlzLCBfdWlkKTsKCQkJZGVsZXRlIHN0b3JlZFtfdWlkXTsKCQkJc3RvcmFnZVtfdHlwZV0gPSBzdG9yZWQ7CgkJCXJldHVybiByZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIGRlbGVnYXRvcik7CgkJfQoKCQl2YXIgX191aWQsIHM7CgkJaWYgKGZuKSBmb3IgKF9fdWlkIGluIHN0b3JlZCl7CgkJCXMgPSBzdG9yZWRbX191aWRdOwoJCQlpZiAocy5tYXRjaCA9PSBtYXRjaCAmJiBzLmZuID09IGZuKSByZXR1cm4gZGVsZWdhdGlvbi5yZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIG1hdGNoLCBmbiwgX191aWQpOwoJCX0gZWxzZSBmb3IgKF9fdWlkIGluIHN0b3JlZCl7CgkJCXMgPSBzdG9yZWRbX191aWRdOwoJCQlpZiAocy5tYXRjaCA9PSBtYXRjaCkgZGVsZWdhdGlvbi5yZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIG1hdGNoLCBzLmZuLCBfX3VpZCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfTsKCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCWFkZEV2ZW50OiByZWxheShhZGRFdmVudCwgZGVsZWdhdGlvbi5hZGRFdmVudCksCglyZW1vdmVFdmVudDogcmVsYXkocmVtb3ZlRXZlbnQsIGRlbGVnYXRpb24ucmVtb3ZlRXZlbnQpCn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IEVsZW1lbnQuRGltZW5zaW9ucwoKZGVzY3JpcHRpb246IENvbnRhaW5zIG1ldGhvZHMgdG8gd29yayB3aXRoIHNpemUsIHNjcm9sbCwgb3IgcG9zaXRpb25pbmcgb2YgRWxlbWVudHMgYW5kIHRoZSB3aW5kb3cgb2JqZWN0LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRWxlbWVudCBwb3NpdGlvbmluZyBiYXNlZCBvbiB0aGUgW3Fvb3hkb29dKGh0dHA6Ly9xb294ZG9vLm9yZy8pIGNvZGUgYW5kIHNtYXJ0IGJyb3dzZXIgZml4ZXMsIFtMR1BMIExpY2Vuc2VdKGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9sZ3BsLmh0bWwpLgogIC0gVmlld3BvcnQgZGltZW5zaW9ucyBiYXNlZCBvbiBbWVVJXShodHRwOi8vZGV2ZWxvcGVyLnlhaG9vLmNvbS95dWkvKSBjb2RlLCBbQlNEIExpY2Vuc2VdKGh0dHA6Ly9kZXZlbG9wZXIueWFob28uY29tL3l1aS9saWNlbnNlLmh0bWwpLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBFbGVtZW50LlN0eWxlXQoKcHJvdmlkZXM6IFtFbGVtZW50LkRpbWVuc2lvbnNdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKCWNoaWxkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CmVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gJzAnOwplbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKdmFyIGJyb2tlbk9mZnNldFBhcmVudCA9IChjaGlsZC5vZmZzZXRQYXJlbnQgPT09IGVsZW1lbnQpOwplbGVtZW50ID0gY2hpbGQgPSBudWxsOwoKdmFyIGlzT2Zmc2V0ID0gZnVuY3Rpb24oZWwpewoJcmV0dXJuIHN0eWxlU3RyaW5nKGVsLCAncG9zaXRpb24nKSAhPSAnc3RhdGljJyB8fCBpc0JvZHkoZWwpOwp9OwoKdmFyIGlzT2Zmc2V0U3RhdGljID0gZnVuY3Rpb24oZWwpewoJcmV0dXJuIGlzT2Zmc2V0KGVsKSB8fCAoL14oPzp0YWJsZXx0ZHx0aCkkL2kpLnRlc3QoZWwudGFnTmFtZSk7Cn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJc2Nyb2xsVG86IGZ1bmN0aW9uKHgsIHkpewoJCWlmIChpc0JvZHkodGhpcykpewoJCQl0aGlzLmdldFdpbmRvdygpLnNjcm9sbFRvKHgsIHkpOwoJCX0gZWxzZSB7CgkJCXRoaXMuc2Nyb2xsTGVmdCA9IHg7CgkJCXRoaXMuc2Nyb2xsVG9wID0geTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFNpemU6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2l6ZSgpOwoJCXJldHVybiB7eDogdGhpcy5vZmZzZXRXaWR0aCwgeTogdGhpcy5vZmZzZXRIZWlnaHR9OwoJfSwKCglnZXRTY3JvbGxTaXplOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNjcm9sbFNpemUoKTsKCQlyZXR1cm4ge3g6IHRoaXMuc2Nyb2xsV2lkdGgsIHk6IHRoaXMuc2Nyb2xsSGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNjcm9sbCgpOwoJCXJldHVybiB7eDogdGhpcy5zY3JvbGxMZWZ0LCB5OiB0aGlzLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbHM6IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzLnBhcmVudE5vZGUsIHBvc2l0aW9uID0ge3g6IDAsIHk6IDB9OwoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQuc2Nyb2xsTGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50LnNjcm9sbFRvcDsKCQkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRPZmZzZXRQYXJlbnQ6IGJyb2tlbk9mZnNldFBhcmVudCA/IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzOwoJCWlmIChpc0JvZHkoZWxlbWVudCkgfHwgc3R5bGVTdHJpbmcoZWxlbWVudCwgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJykgcmV0dXJuIG51bGw7CgoJCXZhciBpc09mZnNldENoZWNrID0gKHN0eWxlU3RyaW5nKGVsZW1lbnQsICdwb3NpdGlvbicpID09ICdzdGF0aWMnKSA/IGlzT2Zmc2V0U3RhdGljIDogaXNPZmZzZXQ7CgkJd2hpbGUgKChlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlKSl7CgkJCWlmIChpc09mZnNldENoZWNrKGVsZW1lbnQpKSByZXR1cm4gZWxlbWVudDsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9IDogZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXM7CgkJaWYgKGlzQm9keShlbGVtZW50KSB8fCBzdHlsZVN0cmluZyhlbGVtZW50LCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKSByZXR1cm4gbnVsbDsKCgkJdHJ5IHsKCQkJcmV0dXJuIGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0gY2F0Y2goZSkge30KCQlyZXR1cm4gbnVsbDsKCX0sCgoJZ2V0T2Zmc2V0czogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QgJiYgIUJyb3dzZXIuUGxhdGZvcm0uaW9zKXsKCQkJdmFyIGJvdW5kID0gdGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwKCQkJCWh0bWwgPSBkb2N1bWVudC5pZCh0aGlzLmdldERvY3VtZW50KCkuZG9jdW1lbnRFbGVtZW50KSwKCQkJCWh0bWxTY3JvbGwgPSBodG1sLmdldFNjcm9sbCgpLAoJCQkJZWxlbVNjcm9sbHMgPSB0aGlzLmdldFNjcm9sbHMoKSwKCQkJCWlzRml4ZWQgPSAoc3R5bGVTdHJpbmcodGhpcywgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJyk7CgoJCQlyZXR1cm4gewoJCQkJeDogYm91bmQubGVmdC50b0ludCgpICsgZWxlbVNjcm9sbHMueCArICgoaXNGaXhlZCkgPyAwIDogaHRtbFNjcm9sbC54KSAtIGh0bWwuY2xpZW50TGVmdCwKCQkJCXk6IGJvdW5kLnRvcC50b0ludCgpICArIGVsZW1TY3JvbGxzLnkgKyAoKGlzRml4ZWQpID8gMCA6IGh0bWxTY3JvbGwueSkgLSBodG1sLmNsaWVudFRvcAoJCQl9OwoJCX0KCgkJdmFyIGVsZW1lbnQgPSB0aGlzLCBwb3NpdGlvbiA9IHt4OiAwLCB5OiAwfTsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gcG9zaXRpb247CgoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQub2Zmc2V0TGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50Lm9mZnNldFRvcDsKCgkJCWlmIChCcm93c2VyLmZpcmVmb3gpewoJCQkJaWYgKCFib3JkZXJCb3goZWxlbWVudCkpewoJCQkJCXBvc2l0aW9uLnggKz0gbGVmdEJvcmRlcihlbGVtZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJCX0KCQkJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJCQlpZiAocGFyZW50ICYmIHN0eWxlU3RyaW5nKHBhcmVudCwgJ292ZXJmbG93JykgIT0gJ3Zpc2libGUnKXsKCQkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIocGFyZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihwYXJlbnQpOwoJCQkJfQoJCQl9IGVsc2UgaWYgKGVsZW1lbnQgIT0gdGhpcyAmJiBCcm93c2VyLnNhZmFyaSl7CgkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIoZWxlbWVudCk7CgkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJfQoKCQkJZWxlbWVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0KCQlpZiAoQnJvd3Nlci5maXJlZm94ICYmICFib3JkZXJCb3godGhpcykpewoJCQlwb3NpdGlvbi54IC09IGxlZnRCb3JkZXIodGhpcyk7CgkJCXBvc2l0aW9uLnkgLT0gdG9wQm9yZGVyKHRoaXMpOwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldFBvc2l0aW9uOiBmdW5jdGlvbihyZWxhdGl2ZSl7CgkJdmFyIG9mZnNldCA9IHRoaXMuZ2V0T2Zmc2V0cygpLAoJCQlzY3JvbGwgPSB0aGlzLmdldFNjcm9sbHMoKTsKCQl2YXIgcG9zaXRpb24gPSB7CgkJCXg6IG9mZnNldC54IC0gc2Nyb2xsLngsCgkJCXk6IG9mZnNldC55IC0gc2Nyb2xsLnkKCQl9OwoKCQlpZiAocmVsYXRpdmUgJiYgKHJlbGF0aXZlID0gZG9jdW1lbnQuaWQocmVsYXRpdmUpKSl7CgkJCXZhciByZWxhdGl2ZVBvc2l0aW9uID0gcmVsYXRpdmUuZ2V0UG9zaXRpb24oKTsKCQkJcmV0dXJuIHt4OiBwb3NpdGlvbi54IC0gcmVsYXRpdmVQb3NpdGlvbi54IC0gbGVmdEJvcmRlcihyZWxhdGl2ZSksIHk6IHBvc2l0aW9uLnkgLSByZWxhdGl2ZVBvc2l0aW9uLnkgLSB0b3BCb3JkZXIocmVsYXRpdmUpfTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oZWxlbWVudCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0Q29vcmRpbmF0ZXMoKTsKCQl2YXIgcG9zaXRpb24gPSB0aGlzLmdldFBvc2l0aW9uKGVsZW1lbnQpLAoJCQlzaXplID0gdGhpcy5nZXRTaXplKCk7CgkJdmFyIG9iaiA9IHsKCQkJbGVmdDogcG9zaXRpb24ueCwKCQkJdG9wOiBwb3NpdGlvbi55LAoJCQl3aWR0aDogc2l6ZS54LAoJCQloZWlnaHQ6IHNpemUueQoJCX07CgkJb2JqLnJpZ2h0ID0gb2JqLmxlZnQgKyBvYmoud2lkdGg7CgkJb2JqLmJvdHRvbSA9IG9iai50b3AgKyBvYmouaGVpZ2h0OwoJCXJldHVybiBvYmo7Cgl9LAoKCWNvbXB1dGVQb3NpdGlvbjogZnVuY3Rpb24ob2JqKXsKCQlyZXR1cm4gewoJCQlsZWZ0OiBvYmoueCAtIHN0eWxlTnVtYmVyKHRoaXMsICdtYXJnaW4tbGVmdCcpLAoJCQl0b3A6IG9iai55IC0gc3R5bGVOdW1iZXIodGhpcywgJ21hcmdpbi10b3AnKQoJCX07Cgl9LAoKCXNldFBvc2l0aW9uOiBmdW5jdGlvbihvYmopewoJCXJldHVybiB0aGlzLnNldFN0eWxlcyh0aGlzLmNvbXB1dGVQb3NpdGlvbihvYmopKTsKCX0KCn0pOwoKCltEb2N1bWVudCwgV2luZG93XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglnZXRTaXplOiBmdW5jdGlvbigpewoJCXZhciBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogZG9jLmNsaWVudFdpZHRoLCB5OiBkb2MuY2xpZW50SGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCXZhciB3aW4gPSB0aGlzLmdldFdpbmRvdygpLCBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogd2luLnBhZ2VYT2Zmc2V0IHx8IGRvYy5zY3JvbGxMZWZ0LCB5OiB3aW4ucGFnZVlPZmZzZXQgfHwgZG9jLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbFNpemU6IGZ1bmN0aW9uKCl7CgkJdmFyIGRvYyA9IGdldENvbXBhdEVsZW1lbnQodGhpcyksCgkJCW1pbiA9IHRoaXMuZ2V0U2l6ZSgpLAoJCQlib2R5ID0gdGhpcy5nZXREb2N1bWVudCgpLmJvZHk7CgoJCXJldHVybiB7eDogTWF0aC5tYXgoZG9jLnNjcm9sbFdpZHRoLCBib2R5LnNjcm9sbFdpZHRoLCBtaW4ueCksIHk6IE1hdGgubWF4KGRvYy5zY3JvbGxIZWlnaHQsIGJvZHkuc2Nyb2xsSGVpZ2h0LCBtaW4ueSl9OwoJfSwKCglnZXRQb3NpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4ge3g6IDAsIHk6IDB9OwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oKXsKCQl2YXIgc2l6ZSA9IHRoaXMuZ2V0U2l6ZSgpOwoJCXJldHVybiB7dG9wOiAwLCBsZWZ0OiAwLCBib3R0b206IHNpemUueSwgcmlnaHQ6IHNpemUueCwgaGVpZ2h0OiBzaXplLnksIHdpZHRoOiBzaXplLnh9OwoJfQoKfSk7CgovLyBwcml2YXRlIG1ldGhvZHMKCnZhciBzdHlsZVN0cmluZyA9IEVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZTsKCmZ1bmN0aW9uIHN0eWxlTnVtYmVyKGVsZW1lbnQsIHN0eWxlKXsKCXJldHVybiBzdHlsZVN0cmluZyhlbGVtZW50LCBzdHlsZSkudG9JbnQoKSB8fCAwOwp9CgpmdW5jdGlvbiBib3JkZXJCb3goZWxlbWVudCl7CglyZXR1cm4gc3R5bGVTdHJpbmcoZWxlbWVudCwgJy1tb3otYm94LXNpemluZycpID09ICdib3JkZXItYm94JzsKfQoKZnVuY3Rpb24gdG9wQm9yZGVyKGVsZW1lbnQpewoJcmV0dXJuIHN0eWxlTnVtYmVyKGVsZW1lbnQsICdib3JkZXItdG9wLXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGxlZnRCb3JkZXIoZWxlbWVudCl7CglyZXR1cm4gc3R5bGVOdW1iZXIoZWxlbWVudCwgJ2JvcmRlci1sZWZ0LXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGlzQm9keShlbGVtZW50KXsKCXJldHVybiAoL14oPzpib2R5fGh0bWwpJC9pKS50ZXN0KGVsZW1lbnQudGFnTmFtZSk7Cn0KCmZ1bmN0aW9uIGdldENvbXBhdEVsZW1lbnQoZWxlbWVudCl7Cgl2YXIgZG9jID0gZWxlbWVudC5nZXREb2N1bWVudCgpOwoJcmV0dXJuICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7Cn0KCn0pKCk7CgovL2FsaWFzZXMKRWxlbWVudC5hbGlhcyh7cG9zaXRpb246ICdzZXRQb3NpdGlvbid9KTsgLy9jb21wYXRhYmlsaXR5CgpbV2luZG93LCBEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0SGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNpemUoKS55OwoJfSwKCglnZXRXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTaXplKCkueDsKCX0sCgoJZ2V0U2Nyb2xsVG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbCgpLnk7Cgl9LAoKCWdldFNjcm9sbExlZnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsKCkueDsKCX0sCgoJZ2V0U2Nyb2xsSGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbFNpemUoKS55OwoJfSwKCglnZXRTY3JvbGxXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGxTaXplKCkueDsKCX0sCgoJZ2V0VG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFBvc2l0aW9uKCkueTsKCX0sCgoJZ2V0TGVmdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRQb3NpdGlvbigpLng7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIGJhc2ljIGFuaW1hdGlvbiBsb2dpYyB0byBiZSBleHRlbmRlZCBieSBhbGwgb3RoZXIgRnggQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXQoKcHJvdmlkZXM6IEZ4CgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIEZ4ID0gdGhpcy5GeCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsKCQkvKgoJCW9uU3RhcnQ6IG5pbCwKCQlvbkNhbmNlbDogbmlsLAoJCW9uQ29tcGxldGU6IG5pbCwKCQkqLwoJCWZwczogNjAsCgkJdW5pdDogZmFsc2UsCgkJZHVyYXRpb246IDUwMCwKCQlmcmFtZXM6IG51bGwsCgkJZnJhbWVTa2lwOiB0cnVlLAoJCWxpbms6ICdpZ25vcmUnCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuc3ViamVjdCA9IHRoaXMuc3ViamVjdCB8fCB0aGlzOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCX0sCgoJZ2V0VHJhbnNpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gZnVuY3Rpb24ocCl7CgkJCXJldHVybiAtKE1hdGguY29zKE1hdGguUEkgKiBwKSAtIDEpIC8gMjsKCQl9OwoJfSwKCglzdGVwOiBmdW5jdGlvbihub3cpewoJCWlmICh0aGlzLm9wdGlvbnMuZnJhbWVTa2lwKXsKCQkJdmFyIGRpZmYgPSAodGhpcy50aW1lICE9IG51bGwpID8gKG5vdyAtIHRoaXMudGltZSkgOiAwLCBmcmFtZXMgPSBkaWZmIC8gdGhpcy5mcmFtZUludGVydmFsOwoJCQl0aGlzLnRpbWUgPSBub3c7CgkJCXRoaXMuZnJhbWUgKz0gZnJhbWVzOwoJCX0gZWxzZSB7CgkJCXRoaXMuZnJhbWUrKzsKCQl9CgoJCWlmICh0aGlzLmZyYW1lIDwgdGhpcy5mcmFtZXMpewoJCQl2YXIgZGVsdGEgPSB0aGlzLnRyYW5zaXRpb24odGhpcy5mcmFtZSAvIHRoaXMuZnJhbWVzKTsKCQkJdGhpcy5zZXQodGhpcy5jb21wdXRlKHRoaXMuZnJvbSwgdGhpcy50bywgZGVsdGEpKTsKCQl9IGVsc2UgewoJCQl0aGlzLmZyYW1lID0gdGhpcy5mcmFtZXM7CgkJCXRoaXMuc2V0KHRoaXMuY29tcHV0ZSh0aGlzLmZyb20sIHRoaXMudG8sIDEpKTsKCQkJdGhpcy5zdG9wKCk7CgkJfQoJfSwKCglzZXQ6IGZ1bmN0aW9uKG5vdyl7CgkJcmV0dXJuIG5vdzsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQlyZXR1cm4gRnguY29tcHV0ZShmcm9tLCB0bywgZGVsdGEpOwoJfSwKCgljaGVjazogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMuaXNSdW5uaW5nKCkpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglzdGFydDogZnVuY3Rpb24oZnJvbSwgdG8pewoJCWlmICghdGhpcy5jaGVjayhmcm9tLCB0bykpIHJldHVybiB0aGlzOwoJCXRoaXMuZnJvbSA9IGZyb207CgkJdGhpcy50byA9IHRvOwoJCXRoaXMuZnJhbWUgPSAodGhpcy5vcHRpb25zLmZyYW1lU2tpcCkgPyAwIDogLTE7CgkJdGhpcy50aW1lID0gbnVsbDsKCQl0aGlzLnRyYW5zaXRpb24gPSB0aGlzLmdldFRyYW5zaXRpb24oKTsKCQl2YXIgZnJhbWVzID0gdGhpcy5vcHRpb25zLmZyYW1lcywgZnBzID0gdGhpcy5vcHRpb25zLmZwcywgZHVyYXRpb24gPSB0aGlzLm9wdGlvbnMuZHVyYXRpb247CgkJdGhpcy5kdXJhdGlvbiA9IEZ4LkR1cmF0aW9uc1tkdXJhdGlvbl0gfHwgZHVyYXRpb24udG9JbnQoKTsKCQl0aGlzLmZyYW1lSW50ZXJ2YWwgPSAxMDAwIC8gZnBzOwoJCXRoaXMuZnJhbWVzID0gZnJhbWVzIHx8IE1hdGgucm91bmQodGhpcy5kdXJhdGlvbiAvIHRoaXMuZnJhbWVJbnRlcnZhbCk7CgkJdGhpcy5maXJlRXZlbnQoJ3N0YXJ0JywgdGhpcy5zdWJqZWN0KTsKCQlwdXNoSW5zdGFuY2UuY2FsbCh0aGlzLCBmcHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdG9wOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCWlmICh0aGlzLmZyYW1lcyA9PSB0aGlzLmZyYW1lKXsKCQkJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScsIHRoaXMuc3ViamVjdCk7CgkJCQlpZiAoIXRoaXMuY2FsbENoYWluKCkpIHRoaXMuZmlyZUV2ZW50KCdjaGFpbkNvbXBsZXRlJywgdGhpcy5zdWJqZWN0KTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZmlyZUV2ZW50KCdzdG9wJywgdGhpcy5zdWJqZWN0KTsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FuY2VsOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCXRoaXMuZnJhbWUgPSB0aGlzLmZyYW1lczsKCQkJdGhpcy5maXJlRXZlbnQoJ2NhbmNlbCcsIHRoaXMuc3ViamVjdCkuY2xlYXJDaGFpbigpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJcGF1c2U6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaXNSdW5uaW5nKCkpewoJCQl0aGlzLnRpbWUgPSBudWxsOwoJCQlwdWxsSW5zdGFuY2UuY2FsbCh0aGlzLCB0aGlzLm9wdGlvbnMuZnBzKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlc3VtZTogZnVuY3Rpb24oKXsKCQlpZiAoKHRoaXMuZnJhbWUgPCB0aGlzLmZyYW1lcykgJiYgIXRoaXMuaXNSdW5uaW5nKCkpIHB1c2hJbnN0YW5jZS5jYWxsKHRoaXMsIHRoaXMub3B0aW9ucy5mcHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJdmFyIGxpc3QgPSBpbnN0YW5jZXNbdGhpcy5vcHRpb25zLmZwc107CgkJcmV0dXJuIGxpc3QgJiYgbGlzdC5jb250YWlucyh0aGlzKTsKCX0KCn0pOwoKRnguY29tcHV0ZSA9IGZ1bmN0aW9uKGZyb20sIHRvLCBkZWx0YSl7CglyZXR1cm4gKHRvIC0gZnJvbSkgKiBkZWx0YSArIGZyb207Cn07CgpGeC5EdXJhdGlvbnMgPSB7J3Nob3J0JzogMjUwLCAnbm9ybWFsJzogNTAwLCAnbG9uZyc6IDEwMDB9OwoKLy8gZ2xvYmFsIHRpbWVycwoKdmFyIGluc3RhbmNlcyA9IHt9LCB0aW1lcnMgPSB7fTsKCnZhciBsb29wID0gZnVuY3Rpb24oKXsKCXZhciBub3cgPSBEYXRlLm5vdygpOwoJZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoOyBpLS07KXsKCQl2YXIgaW5zdGFuY2UgPSB0aGlzW2ldOwoJCWlmIChpbnN0YW5jZSkgaW5zdGFuY2Uuc3RlcChub3cpOwoJfQp9OwoKdmFyIHB1c2hJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdIHx8IChpbnN0YW5jZXNbZnBzXSA9IFtdKTsKCWxpc3QucHVzaCh0aGlzKTsKCWlmICghdGltZXJzW2Zwc10pIHRpbWVyc1tmcHNdID0gbG9vcC5wZXJpb2RpY2FsKE1hdGgucm91bmQoMTAwMCAvIGZwcyksIGxpc3QpOwp9OwoKdmFyIHB1bGxJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdOwoJaWYgKGxpc3QpewoJCWxpc3QuZXJhc2UodGhpcyk7CgkJaWYgKCFsaXN0Lmxlbmd0aCAmJiB0aW1lcnNbZnBzXSl7CgkJCWRlbGV0ZSBpbnN0YW5jZXNbZnBzXTsKCQkJdGltZXJzW2Zwc10gPSBjbGVhckludGVydmFsKHRpbWVyc1tmcHNdKTsKCQl9Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRnguQ1NTCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENTUyBhbmltYXRpb24gbG9naWMuIFVzZWQgYnkgRnguVHdlZW4sIEZ4Lk1vcnBoLCBGeC5FbGVtZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtGeCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBGeC5DU1MKCi4uLgoqLwoKRnguQ1NTID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeCwKCgkvL3ByZXBhcmVzIHRoZSBiYXNlIGZyb20vdG8gb2JqZWN0CgoJcHJlcGFyZTogZnVuY3Rpb24oZWxlbWVudCwgcHJvcGVydHksIHZhbHVlcyl7CgkJdmFsdWVzID0gQXJyYXkuZnJvbSh2YWx1ZXMpOwoJCXZhciBmcm9tID0gdmFsdWVzWzBdLCB0byA9IHZhbHVlc1sxXTsKCQlpZiAodG8gPT0gbnVsbCl7CgkJCXRvID0gZnJvbTsKCQkJZnJvbSA9IGVsZW1lbnQuZ2V0U3R5bGUocHJvcGVydHkpOwoJCQl2YXIgdW5pdCA9IHRoaXMub3B0aW9ucy51bml0OwoJCQkvLyBhZGFwdGVkIGZyb206IGh0dHBzOi8vZ2l0aHViLmNvbS9yeWFubW9yci9meC9ibG9iL21hc3Rlci9meC5qcyNMMjk5CgkJCWlmICh1bml0ICYmIGZyb20uc2xpY2UoLXVuaXQubGVuZ3RoKSAhPSB1bml0ICYmIHBhcnNlRmxvYXQoZnJvbSkgIT0gMCl7CgkJCQllbGVtZW50LnNldFN0eWxlKHByb3BlcnR5LCB0byArIHVuaXQpOwoJCQkJdmFyIHZhbHVlID0gZWxlbWVudC5nZXRDb21wdXRlZFN0eWxlKHByb3BlcnR5KTsKCQkJCS8vIElFIGFuZCBPcGVyYSBzdXBwb3J0IHBpeGVsTGVmdCBvciBwaXhlbFdpZHRoCgkJCQlpZiAoISgvcHgkLy50ZXN0KHZhbHVlKSkpewoJCQkJCXZhbHVlID0gZWxlbWVudC5zdHlsZVsoJ3BpeGVsLScgKyBwcm9wZXJ0eSkuY2FtZWxDYXNlKCldOwoJCQkJCWlmICh2YWx1ZSA9PSBudWxsKXsKCQkJCQkJLy8gYWRhcHRlZCBmcm9tIERlYW4gRWR3YXJkcycgaHR0cDovL2VyaWsuZWFlLm5ldC9hcmNoaXZlcy8yMDA3LzA3LzI3LzE4LjU0LjE1LyNjb21tZW50LTEwMjI5MQoJCQkJCQl2YXIgbGVmdCA9IGVsZW1lbnQuc3R5bGUubGVmdDsKCQkJCQkJZWxlbWVudC5zdHlsZS5sZWZ0ID0gdG8gKyB1bml0OwoJCQkJCQl2YWx1ZSA9IGVsZW1lbnQuc3R5bGUucGl4ZWxMZWZ0OwoJCQkJCQllbGVtZW50LnN0eWxlLmxlZnQgPSBsZWZ0OwoJCQkJCX0KCQkJCX0KCQkJCWZyb20gPSAodG8gfHwgMSkgLyAocGFyc2VGbG9hdCh2YWx1ZSkgfHwgMSkgKiAocGFyc2VGbG9hdChmcm9tKSB8fCAwKTsKCQkJCWVsZW1lbnQuc2V0U3R5bGUocHJvcGVydHksIGZyb20gKyB1bml0KTsKCQkJfQoJCX0KCQlyZXR1cm4ge2Zyb206IHRoaXMucGFyc2UoZnJvbSksIHRvOiB0aGlzLnBhcnNlKHRvKX07Cgl9LAoKCS8vcGFyc2VzIGEgdmFsdWUgaW50byBhbiBhcnJheQoKCXBhcnNlOiBmdW5jdGlvbih2YWx1ZSl7CgkJdmFsdWUgPSBGdW5jdGlvbi5mcm9tKHZhbHVlKSgpOwoJCXZhbHVlID0gKHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJykgPyB2YWx1ZS5zcGxpdCgnICcpIDogQXJyYXkuZnJvbSh2YWx1ZSk7CgkJcmV0dXJuIHZhbHVlLm1hcChmdW5jdGlvbih2YWwpewoJCQl2YWwgPSBTdHJpbmcodmFsKTsKCQkJdmFyIGZvdW5kID0gZmFsc2U7CgkJCU9iamVjdC5lYWNoKEZ4LkNTUy5QYXJzZXJzLCBmdW5jdGlvbihwYXJzZXIsIGtleSl7CgkJCQlpZiAoZm91bmQpIHJldHVybjsKCQkJCXZhciBwYXJzZWQgPSBwYXJzZXIucGFyc2UodmFsKTsKCQkJCWlmIChwYXJzZWQgfHwgcGFyc2VkID09PSAwKSBmb3VuZCA9IHt2YWx1ZTogcGFyc2VkLCBwYXJzZXI6IHBhcnNlcn07CgkJCX0pOwoJCQlmb3VuZCA9IGZvdW5kIHx8IHt2YWx1ZTogdmFsLCBwYXJzZXI6IEZ4LkNTUy5QYXJzZXJzLlN0cmluZ307CgkJCXJldHVybiBmb3VuZDsKCQl9KTsKCX0sCgoJLy9jb21wdXRlcyBieSBhIGZyb20gYW5kIHRvIHByZXBhcmVkIG9iamVjdHMsIHVzaW5nIHRoZWlyIHBhcnNlcnMuCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQl2YXIgY29tcHV0ZWQgPSBbXTsKCQkoTWF0aC5taW4oZnJvbS5sZW5ndGgsIHRvLmxlbmd0aCkpLnRpbWVzKGZ1bmN0aW9uKGkpewoJCQljb21wdXRlZC5wdXNoKHt2YWx1ZTogZnJvbVtpXS5wYXJzZXIuY29tcHV0ZShmcm9tW2ldLnZhbHVlLCB0b1tpXS52YWx1ZSwgZGVsdGEpLCBwYXJzZXI6IGZyb21baV0ucGFyc2VyfSk7CgkJfSk7CgkJY29tcHV0ZWQuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ2Z4OmNzczp2YWx1ZScpOwoJCXJldHVybiBjb21wdXRlZDsKCX0sCgoJLy9zZXJ2ZXMgdGhlIHZhbHVlIGFzIHNldHRhYmxlCgoJc2VydmU6IGZ1bmN0aW9uKHZhbHVlLCB1bml0KXsKCQlpZiAodHlwZU9mKHZhbHVlKSAhPSAnZng6Y3NzOnZhbHVlJykgdmFsdWUgPSB0aGlzLnBhcnNlKHZhbHVlKTsKCQl2YXIgcmV0dXJuZWQgPSBbXTsKCQl2YWx1ZS5lYWNoKGZ1bmN0aW9uKGJpdCl7CgkJCXJldHVybmVkID0gcmV0dXJuZWQuY29uY2F0KGJpdC5wYXJzZXIuc2VydmUoYml0LnZhbHVlLCB1bml0KSk7CgkJfSk7CgkJcmV0dXJuIHJldHVybmVkOwoJfSwKCgkvL3JlbmRlcnMgdGhlIGNoYW5nZSB0byBhbiBlbGVtZW50CgoJcmVuZGVyOiBmdW5jdGlvbihlbGVtZW50LCBwcm9wZXJ0eSwgdmFsdWUsIHVuaXQpewoJCWVsZW1lbnQuc2V0U3R5bGUocHJvcGVydHksIHRoaXMuc2VydmUodmFsdWUsIHVuaXQpKTsKCX0sCgoJLy9zZWFyY2hlcyBpbnNpZGUgdGhlIHBhZ2UgY3NzIHRvIGZpbmQgdGhlIHZhbHVlcyBmb3IgYSBzZWxlY3RvcgoKCXNlYXJjaDogZnVuY3Rpb24oc2VsZWN0b3IpewoJCWlmIChGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdKSByZXR1cm4gRnguQ1NTLkNhY2hlW3NlbGVjdG9yXTsKCQl2YXIgdG8gPSB7fSwgc2VsZWN0b3JUZXN0ID0gbmV3IFJlZ0V4cCgnXicgKyBzZWxlY3Rvci5lc2NhcGVSZWdFeHAoKSArICckJyk7CgkJQXJyYXkuZWFjaChkb2N1bWVudC5zdHlsZVNoZWV0cywgZnVuY3Rpb24oc2hlZXQsIGopewoJCQl2YXIgaHJlZiA9IHNoZWV0LmhyZWY7CgkJCWlmIChocmVmICYmIGhyZWYuY29udGFpbnMoJzovLycpICYmICFocmVmLmNvbnRhaW5zKGRvY3VtZW50LmRvbWFpbikpIHJldHVybjsKCQkJdmFyIHJ1bGVzID0gc2hlZXQucnVsZXMgfHwgc2hlZXQuY3NzUnVsZXM7CgkJCUFycmF5LmVhY2gocnVsZXMsIGZ1bmN0aW9uKHJ1bGUsIGkpewoJCQkJaWYgKCFydWxlLnN0eWxlKSByZXR1cm47CgkJCQl2YXIgc2VsZWN0b3JUZXh0ID0gKHJ1bGUuc2VsZWN0b3JUZXh0KSA/IHJ1bGUuc2VsZWN0b3JUZXh0LnJlcGxhY2UoL15cdysvLCBmdW5jdGlvbihtKXsKCQkJCQlyZXR1cm4gbS50b0xvd2VyQ2FzZSgpOwoJCQkJfSkgOiBudWxsOwoJCQkJaWYgKCFzZWxlY3RvclRleHQgfHwgIXNlbGVjdG9yVGVzdC50ZXN0KHNlbGVjdG9yVGV4dCkpIHJldHVybjsKCQkJCU9iamVjdC5lYWNoKEVsZW1lbnQuU3R5bGVzLCBmdW5jdGlvbih2YWx1ZSwgc3R5bGUpewoJCQkJCWlmICghcnVsZS5zdHlsZVtzdHlsZV0gfHwgRWxlbWVudC5TaG9ydFN0eWxlc1tzdHlsZV0pIHJldHVybjsKCQkJCQl2YWx1ZSA9IFN0cmluZyhydWxlLnN0eWxlW3N0eWxlXSk7CgkJCQkJdG9bc3R5bGVdID0gKCgvXnJnYi8pLnRlc3QodmFsdWUpKSA/IHZhbHVlLnJnYlRvSGV4KCkgOiB2YWx1ZTsKCQkJCX0pOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gRnguQ1NTLkNhY2hlW3NlbGVjdG9yXSA9IHRvOwoJfQoKfSk7CgpGeC5DU1MuQ2FjaGUgPSB7fTsKCkZ4LkNTUy5QYXJzZXJzID0gewoKCUNvbG9yOiB7CgkJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJaWYgKHZhbHVlLm1hdGNoKC9eI1swLTlhLWZdezMsNn0kL2kpKSByZXR1cm4gdmFsdWUuaGV4VG9SZ2IodHJ1ZSk7CgkJCXJldHVybiAoKHZhbHVlID0gdmFsdWUubWF0Y2goLyhcZCspLFxzKihcZCspLFxzKihcZCspLykpKSA/IFt2YWx1ZVsxXSwgdmFsdWVbMl0sIHZhbHVlWzNdXSA6IGZhbHNlOwoJCX0sCgkJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQkJcmV0dXJuIGZyb20ubWFwKGZ1bmN0aW9uKHZhbHVlLCBpKXsKCQkJCXJldHVybiBNYXRoLnJvdW5kKEZ4LmNvbXB1dGUoZnJvbVtpXSwgdG9baV0sIGRlbHRhKSk7CgkJCX0pOwoJCX0sCgkJc2VydmU6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIHZhbHVlLm1hcChOdW1iZXIpOwoJCX0KCX0sCgoJTnVtYmVyOiB7CgkJcGFyc2U6IHBhcnNlRmxvYXQsCgkJY29tcHV0ZTogRnguY29tcHV0ZSwKCQlzZXJ2ZTogZnVuY3Rpb24odmFsdWUsIHVuaXQpewoJCQlyZXR1cm4gKHVuaXQpID8gdmFsdWUgKyB1bml0IDogdmFsdWU7CgkJfQoJfSwKCglTdHJpbmc6IHsKCQlwYXJzZTogRnVuY3Rpb24uZnJvbShmYWxzZSksCgkJY29tcHV0ZTogZnVuY3Rpb24oemVybywgb25lKXsKCQkJcmV0dXJuIG9uZTsKCQl9LAoJCXNlcnZlOiBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfQoJfQoKfTsKCi8vPDEuMmNvbXBhdD4KCkZ4LkNTUy5QYXJzZXJzID0gbmV3IEhhc2goRnguQ1NTLlBhcnNlcnMpOwoKLy88LzEuMmNvbXBhdD4KCgovKgotLS0KCm5hbWU6IEZ4LlR3ZWVuCgpkZXNjcmlwdGlvbjogRm9ybWVybHkgRnguU3R5bGUsIGVmZmVjdCB0byB0cmFuc2l0aW9uIGFueSBDU1MgcHJvcGVydHkgZm9yIGFuIGVsZW1lbnQuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBGeC5DU1MKCnByb3ZpZGVzOiBbRnguVHdlZW4sIEVsZW1lbnQuZmFkZSwgRWxlbWVudC5oaWdobGlnaHRdCgouLi4KKi8KCkZ4LlR3ZWVuID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeC5DU1MsCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucyl7CgkJdGhpcy5lbGVtZW50ID0gdGhpcy5zdWJqZWN0ID0gZG9jdW1lbnQuaWQoZWxlbWVudCk7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7Cgl9LAoKCXNldDogZnVuY3Rpb24ocHJvcGVydHksIG5vdyl7CgkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSl7CgkJCW5vdyA9IHByb3BlcnR5OwoJCQlwcm9wZXJ0eSA9IHRoaXMucHJvcGVydHkgfHwgdGhpcy5vcHRpb25zLnByb3BlcnR5OwoJCX0KCQl0aGlzLnJlbmRlcih0aGlzLmVsZW1lbnQsIHByb3BlcnR5LCBub3csIHRoaXMub3B0aW9ucy51bml0KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKHByb3BlcnR5LCBmcm9tLCB0byl7CgkJaWYgKCF0aGlzLmNoZWNrKHByb3BlcnR5LCBmcm9tLCB0bykpIHJldHVybiB0aGlzOwoJCXZhciBhcmdzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpOwoJCXRoaXMucHJvcGVydHkgPSB0aGlzLm9wdGlvbnMucHJvcGVydHkgfHwgYXJncy5zaGlmdCgpOwoJCXZhciBwYXJzZWQgPSB0aGlzLnByZXBhcmUodGhpcy5lbGVtZW50LCB0aGlzLnByb3BlcnR5LCBhcmdzKTsKCQlyZXR1cm4gdGhpcy5wYXJlbnQocGFyc2VkLmZyb20sIHBhcnNlZC50byk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy50d2VlbiA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuZ2V0KCd0d2VlbicpLmNhbmNlbCgpLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgdHdlZW4gPSB0aGlzLnJldHJpZXZlKCd0d2VlbicpOwoJCWlmICghdHdlZW4pewoJCQl0d2VlbiA9IG5ldyBGeC5Ud2Vlbih0aGlzLCB7bGluazogJ2NhbmNlbCd9KTsKCQkJdGhpcy5zdG9yZSgndHdlZW4nLCB0d2Vlbik7CgkJfQoJCXJldHVybiB0d2VlbjsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJdHdlZW46IGZ1bmN0aW9uKHByb3BlcnR5LCBmcm9tLCB0byl7CgkJdGhpcy5nZXQoJ3R3ZWVuJykuc3RhcnQocHJvcGVydHksIGZyb20sIHRvKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmFkZTogZnVuY3Rpb24oaG93KXsKCQl2YXIgZmFkZSA9IHRoaXMuZ2V0KCd0d2VlbicpLCBtZXRob2QsIGFyZ3MgPSBbJ29wYWNpdHknXS5hcHBlbmQoYXJndW1lbnRzKSwgdG9nZ2xlOwoJCWlmIChhcmdzWzFdID09IG51bGwpIGFyZ3NbMV0gPSAndG9nZ2xlJzsKCQlzd2l0Y2ggKGFyZ3NbMV0pewoJCQljYXNlICdpbic6IG1ldGhvZCA9ICdzdGFydCc7IGFyZ3NbMV0gPSAxOyBicmVhazsKCQkJY2FzZSAnb3V0JzogbWV0aG9kID0gJ3N0YXJ0JzsgYXJnc1sxXSA9IDA7IGJyZWFrOwoJCQljYXNlICdzaG93JzogbWV0aG9kID0gJ3NldCc7IGFyZ3NbMV0gPSAxOyBicmVhazsKCQkJY2FzZSAnaGlkZSc6IG1ldGhvZCA9ICdzZXQnOyBhcmdzWzFdID0gMDsgYnJlYWs7CgkJCWNhc2UgJ3RvZ2dsZSc6CgkJCQl2YXIgZmxhZyA9IHRoaXMucmV0cmlldmUoJ2ZhZGU6ZmxhZycsIHRoaXMuZ2V0U3R5bGUoJ29wYWNpdHknKSA9PSAxKTsKCQkJCW1ldGhvZCA9ICdzdGFydCc7CgkJCQlhcmdzWzFdID0gZmxhZyA/IDAgOiAxOwoJCQkJdGhpcy5zdG9yZSgnZmFkZTpmbGFnJywgIWZsYWcpOwoJCQkJdG9nZ2xlID0gdHJ1ZTsKCQkJYnJlYWs7CgkJCWRlZmF1bHQ6IG1ldGhvZCA9ICdzdGFydCc7CgkJfQoJCWlmICghdG9nZ2xlKSB0aGlzLmVsaW1pbmF0ZSgnZmFkZTpmbGFnJyk7CgkJZmFkZVttZXRob2RdLmFwcGx5KGZhZGUsIGFyZ3MpOwoJCXZhciB0byA9IGFyZ3NbYXJncy5sZW5ndGggLSAxXTsKCQlpZiAobWV0aG9kID09ICdzZXQnIHx8IHRvICE9IDApIHRoaXMuc2V0U3R5bGUoJ3Zpc2liaWxpdHknLCB0byA9PSAwID8gJ2hpZGRlbicgOiAndmlzaWJsZScpOwoJCWVsc2UgZmFkZS5jaGFpbihmdW5jdGlvbigpewoJCQl0aGlzLmVsZW1lbnQuc2V0U3R5bGUoJ3Zpc2liaWxpdHknLCAnaGlkZGVuJyk7CgkJCXRoaXMuY2FsbENoYWluKCk7CgkJfSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWhpZ2hsaWdodDogZnVuY3Rpb24oc3RhcnQsIGVuZCl7CgkJaWYgKCFlbmQpewoJCQllbmQgPSB0aGlzLnJldHJpZXZlKCdoaWdobGlnaHQ6b3JpZ2luYWwnLCB0aGlzLmdldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJykpOwoJCQllbmQgPSAoZW5kID09ICd0cmFuc3BhcmVudCcpID8gJyNmZmYnIDogZW5kOwoJCX0KCQl2YXIgdHdlZW4gPSB0aGlzLmdldCgndHdlZW4nKTsKCQl0d2Vlbi5zdGFydCgnYmFja2dyb3VuZC1jb2xvcicsIHN0YXJ0IHx8ICcjZmZmZjg4JywgZW5kKS5jaGFpbihmdW5jdGlvbigpewoJCQl0aGlzLnNldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJywgdGhpcy5yZXRyaWV2ZSgnaGlnaGxpZ2h0Om9yaWdpbmFsJykpOwoJCQl0d2Vlbi5jYWxsQ2hhaW4oKTsKCQl9LmJpbmQodGhpcykpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeC5Nb3JwaAoKZGVzY3JpcHRpb246IEZvcm1lcmx5IEZ4LlN0eWxlcywgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IG51bWJlciBvZiBDU1MgcHJvcGVydGllcyBmb3IgYW4gZWxlbWVudCB1c2luZyBhbiBvYmplY3Qgb2YgcnVsZXMsIG9yIENTUyBiYXNlZCBzZWxlY3RvciBydWxlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IEZ4Lk1vcnBoCgouLi4KKi8KCkZ4Lk1vcnBoID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeC5DU1MsCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucyl7CgkJdGhpcy5lbGVtZW50ID0gdGhpcy5zdWJqZWN0ID0gZG9jdW1lbnQuaWQoZWxlbWVudCk7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7Cgl9LAoKCXNldDogZnVuY3Rpb24obm93KXsKCQlpZiAodHlwZW9mIG5vdyA9PSAnc3RyaW5nJykgbm93ID0gdGhpcy5zZWFyY2gobm93KTsKCQlmb3IgKHZhciBwIGluIG5vdykgdGhpcy5yZW5kZXIodGhpcy5lbGVtZW50LCBwLCBub3dbcF0sIHRoaXMub3B0aW9ucy51bml0KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQl2YXIgbm93ID0ge307CgkJZm9yICh2YXIgcCBpbiBmcm9tKSBub3dbcF0gPSB0aGlzLnBhcmVudChmcm9tW3BdLCB0b1twXSwgZGVsdGEpOwoJCXJldHVybiBub3c7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydGllcykpIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2YgcHJvcGVydGllcyA9PSAnc3RyaW5nJykgcHJvcGVydGllcyA9IHRoaXMuc2VhcmNoKHByb3BlcnRpZXMpOwoJCXZhciBmcm9tID0ge30sIHRvID0ge307CgkJZm9yICh2YXIgcCBpbiBwcm9wZXJ0aWVzKXsKCQkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHAsIHByb3BlcnRpZXNbcF0pOwoJCQlmcm9tW3BdID0gcGFyc2VkLmZyb207CgkJCXRvW3BdID0gcGFyc2VkLnRvOwoJCX0KCQlyZXR1cm4gdGhpcy5wYXJlbnQoZnJvbSwgdG8pOwoJfQoKfSk7CgpFbGVtZW50LlByb3BlcnRpZXMubW9ycGggPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLmdldCgnbW9ycGgnKS5jYW5jZWwoKS5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG1vcnBoID0gdGhpcy5yZXRyaWV2ZSgnbW9ycGgnKTsKCQlpZiAoIW1vcnBoKXsKCQkJbW9ycGggPSBuZXcgRnguTW9ycGgodGhpcywge2xpbms6ICdjYW5jZWwnfSk7CgkJCXRoaXMuc3RvcmUoJ21vcnBoJywgbW9ycGgpOwoJCX0KCQlyZXR1cm4gbW9ycGg7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCW1vcnBoOiBmdW5jdGlvbihwcm9wcyl7CgkJdGhpcy5nZXQoJ21vcnBoJykuc3RhcnQocHJvcHMpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeC5UcmFuc2l0aW9ucwoKZGVzY3JpcHRpb246IENvbnRhaW5zIGEgc2V0IG9mIGFkdmFuY2VkIHRyYW5zaXRpb25zIHRvIGJlIHVzZWQgd2l0aCBhbnkgb2YgdGhlIEZ4IENsYXNzZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBFYXNpbmcgRXF1YXRpb25zIGJ5IFJvYmVydCBQZW5uZXIsIDxodHRwOi8vd3d3LnJvYmVydHBlbm5lci5jb20vZWFzaW5nLz4sIG1vZGlmaWVkIGFuZCBvcHRpbWl6ZWQgdG8gYmUgdXNlZCB3aXRoIE1vb1Rvb2xzLgoKcmVxdWlyZXM6IEZ4Cgpwcm92aWRlczogRnguVHJhbnNpdGlvbnMKCi4uLgoqLwoKRnguaW1wbGVtZW50KHsKCglnZXRUcmFuc2l0aW9uOiBmdW5jdGlvbigpewoJCXZhciB0cmFucyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uIHx8IEZ4LlRyYW5zaXRpb25zLlNpbmUuZWFzZUluT3V0OwoJCWlmICh0eXBlb2YgdHJhbnMgPT0gJ3N0cmluZycpewoJCQl2YXIgZGF0YSA9IHRyYW5zLnNwbGl0KCc6Jyk7CgkJCXRyYW5zID0gRnguVHJhbnNpdGlvbnM7CgkJCXRyYW5zID0gdHJhbnNbZGF0YVswXV0gfHwgdHJhbnNbZGF0YVswXS5jYXBpdGFsaXplKCldOwoJCQlpZiAoZGF0YVsxXSkgdHJhbnMgPSB0cmFuc1snZWFzZScgKyBkYXRhWzFdLmNhcGl0YWxpemUoKSArIChkYXRhWzJdID8gZGF0YVsyXS5jYXBpdGFsaXplKCkgOiAnJyldOwoJCX0KCQlyZXR1cm4gdHJhbnM7Cgl9Cgp9KTsKCkZ4LlRyYW5zaXRpb24gPSBmdW5jdGlvbih0cmFuc2l0aW9uLCBwYXJhbXMpewoJcGFyYW1zID0gQXJyYXkuZnJvbShwYXJhbXMpOwoJdmFyIGVhc2VJbiA9IGZ1bmN0aW9uKHBvcyl7CgkJcmV0dXJuIHRyYW5zaXRpb24ocG9zLCBwYXJhbXMpOwoJfTsKCXJldHVybiBPYmplY3QuYXBwZW5kKGVhc2VJbiwgewoJCWVhc2VJbjogZWFzZUluLAoJCWVhc2VPdXQ6IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiAxIC0gdHJhbnNpdGlvbigxIC0gcG9zLCBwYXJhbXMpOwoJCX0sCgkJZWFzZUluT3V0OiBmdW5jdGlvbihwb3MpewoJCQlyZXR1cm4gKHBvcyA8PSAwLjUgPyB0cmFuc2l0aW9uKDIgKiBwb3MsIHBhcmFtcykgOiAoMiAtIHRyYW5zaXRpb24oMiAqICgxIC0gcG9zKSwgcGFyYW1zKSkpIC8gMjsKCQl9Cgl9KTsKfTsKCkZ4LlRyYW5zaXRpb25zID0gewoKCWxpbmVhcjogZnVuY3Rpb24oemVybyl7CgkJcmV0dXJuIHplcm87Cgl9Cgp9OwoKLy88MS4yY29tcGF0PgoKRnguVHJhbnNpdGlvbnMgPSBuZXcgSGFzaChGeC5UcmFuc2l0aW9ucyk7CgovLzwvMS4yY29tcGF0PgoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kID0gZnVuY3Rpb24odHJhbnNpdGlvbnMpewoJZm9yICh2YXIgdHJhbnNpdGlvbiBpbiB0cmFuc2l0aW9ucykgRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbih0cmFuc2l0aW9uc1t0cmFuc2l0aW9uXSk7Cn07CgpGeC5UcmFuc2l0aW9ucy5leHRlbmQoewoKCVBvdzogZnVuY3Rpb24ocCwgeCl7CgkJcmV0dXJuIE1hdGgucG93KHAsIHggJiYgeFswXSB8fCA2KTsKCX0sCgoJRXhwbzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDggKiAocCAtIDEpKTsKCX0sCgoJQ2lyYzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLnNpbihNYXRoLmFjb3MocCkpOwoJfSwKCglTaW5lOiBmdW5jdGlvbihwKXsKCQlyZXR1cm4gMSAtIE1hdGguY29zKHAgKiBNYXRoLlBJIC8gMik7Cgl9LAoKCUJhY2s6IGZ1bmN0aW9uKHAsIHgpewoJCXggPSB4ICYmIHhbMF0gfHwgMS42MTg7CgkJcmV0dXJuIE1hdGgucG93KHAsIDIpICogKCh4ICsgMSkgKiBwIC0geCk7Cgl9LAoKCUJvdW5jZTogZnVuY3Rpb24ocCl7CgkJdmFyIHZhbHVlOwoJCWZvciAodmFyIGEgPSAwLCBiID0gMTsgMTsgYSArPSBiLCBiIC89IDIpewoJCQlpZiAocCA+PSAoNyAtIDQgKiBhKSAvIDExKXsKCQkJCXZhbHVlID0gYiAqIGIgLSBNYXRoLnBvdygoMTEgLSA2ICogYSAtIDExICogcCkgLyA0LCAyKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCXJldHVybiB2YWx1ZTsKCX0sCgoJRWxhc3RpYzogZnVuY3Rpb24ocCwgeCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDEwICogLS1wKSAqIE1hdGguY29zKDIwICogcCAqIE1hdGguUEkgKiAoeCAmJiB4WzBdIHx8IDEpIC8gMyk7Cgl9Cgp9KTsKClsnUXVhZCcsICdDdWJpYycsICdRdWFydCcsICdRdWludCddLmVhY2goZnVuY3Rpb24odHJhbnNpdGlvbiwgaSl7CglGeC5UcmFuc2l0aW9uc1t0cmFuc2l0aW9uXSA9IG5ldyBGeC5UcmFuc2l0aW9uKGZ1bmN0aW9uKHApewoJCXJldHVybiBNYXRoLnBvdyhwLCBpICsgMik7Cgl9KTsKfSk7CgoKLyoKLS0tCgpuYW1lOiBSZXF1ZXN0CgpkZXNjcmlwdGlvbjogUG93ZXJmdWwgYWxsIHB1cnBvc2UgUmVxdWVzdCBDbGFzcy4gVXNlcyBYTUxIVFRQUmVxdWVzdC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtPYmplY3QsIEVsZW1lbnQsIENoYWluLCBFdmVudHMsIE9wdGlvbnMsIEJyb3dzZXJdCgpwcm92aWRlczogUmVxdWVzdAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBlbXB0eSA9IGZ1bmN0aW9uKCl7fSwKCXByb2dyZXNzU3VwcG9ydCA9ICgnb25wcm9ncmVzcycgaW4gbmV3IEJyb3dzZXIuUmVxdWVzdCk7Cgp2YXIgUmVxdWVzdCA9IHRoaXMuUmVxdWVzdCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsvKgoJCW9uUmVxdWVzdDogZnVuY3Rpb24oKXt9LAoJCW9uTG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uUHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50LCB4aHIpe30sCgkJb25Db21wbGV0ZTogZnVuY3Rpb24oKXt9LAoJCW9uQ2FuY2VsOiBmdW5jdGlvbigpe30sCgkJb25TdWNjZXNzOiBmdW5jdGlvbihyZXNwb25zZVRleHQsIHJlc3BvbnNlWE1MKXt9LAoJCW9uRmFpbHVyZTogZnVuY3Rpb24oeGhyKXt9LAoJCW9uRXhjZXB0aW9uOiBmdW5jdGlvbihoZWFkZXJOYW1lLCB2YWx1ZSl7fSwKCQlvblRpbWVvdXQ6IGZ1bmN0aW9uKCl7fSwKCQl1c2VyOiAnJywKCQlwYXNzd29yZDogJycsKi8KCQl1cmw6ICcnLAoJCWRhdGE6ICcnLAoJCWhlYWRlcnM6IHsKCQkJJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnLAoJCQknQWNjZXB0JzogJ3RleHQvamF2YXNjcmlwdCwgdGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCgkJfSwKCQlhc3luYzogdHJ1ZSwKCQlmb3JtYXQ6IGZhbHNlLAoJCW1ldGhvZDogJ3Bvc3QnLAoJCWxpbms6ICdpZ25vcmUnLAoJCWlzU3VjY2VzczogbnVsbCwKCQllbXVsYXRpb246IHRydWUsCgkJdXJsRW5jb2RlZDogdHJ1ZSwKCQllbmNvZGluZzogJ3V0Zi04JywKCQlldmFsU2NyaXB0czogZmFsc2UsCgkJZXZhbFJlc3BvbnNlOiBmYWxzZSwKCQl0aW1lb3V0OiAwLAoJCW5vQ2FjaGU6IGZhbHNlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMueGhyID0gbmV3IEJyb3dzZXIuUmVxdWVzdCgpOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLm9wdGlvbnMuaGVhZGVyczsKCX0sCgoJb25TdGF0ZUNoYW5nZTogZnVuY3Rpb24oKXsKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJaWYgKHhoci5yZWFkeVN0YXRlICE9IDQgfHwgIXRoaXMucnVubmluZykgcmV0dXJuOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXRoaXMuc3RhdHVzID0gMDsKCQlGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJCXZhciBzdGF0dXMgPSB4aHIuc3RhdHVzOwoJCQl0aGlzLnN0YXR1cyA9IChzdGF0dXMgPT0gMTIyMykgPyAyMDQgOiBzdGF0dXM7CgkJfS5iaW5kKHRoaXMpKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCkgeGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBlbXB0eTsKCQljbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgoJCXRoaXMucmVzcG9uc2UgPSB7dGV4dDogdGhpcy54aHIucmVzcG9uc2VUZXh0IHx8ICcnLCB4bWw6IHRoaXMueGhyLnJlc3BvbnNlWE1MfTsKCQlpZiAodGhpcy5vcHRpb25zLmlzU3VjY2Vzcy5jYWxsKHRoaXMsIHRoaXMuc3RhdHVzKSkKCQkJdGhpcy5zdWNjZXNzKHRoaXMucmVzcG9uc2UudGV4dCwgdGhpcy5yZXNwb25zZS54bWwpOwoJCWVsc2UKCQkJdGhpcy5mYWlsdXJlKCk7Cgl9LAoKCWlzU3VjY2VzczogZnVuY3Rpb24oKXsKCQl2YXIgc3RhdHVzID0gdGhpcy5zdGF0dXM7CgkJcmV0dXJuIChzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCk7Cgl9LAoKCWlzUnVubmluZzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gISF0aGlzLnJ1bm5pbmc7Cgl9LAoKCXByb2Nlc3NTY3JpcHRzOiBmdW5jdGlvbih0ZXh0KXsKCQlpZiAodGhpcy5vcHRpb25zLmV2YWxSZXNwb25zZSB8fCAoLyhlY21hfGphdmEpc2NyaXB0LykudGVzdCh0aGlzLmdldEhlYWRlcignQ29udGVudC10eXBlJykpKSByZXR1cm4gQnJvd3Nlci5leGVjKHRleHQpOwoJCXJldHVybiB0ZXh0LnN0cmlwU2NyaXB0cyh0aGlzLm9wdGlvbnMuZXZhbFNjcmlwdHMpOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0LCB4bWwpewoJCXRoaXMub25TdWNjZXNzKHRoaXMucHJvY2Vzc1NjcmlwdHModGV4dCksIHhtbCk7Cgl9LAoKCW9uU3VjY2VzczogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgnY29tcGxldGUnLCBhcmd1bWVudHMpLmZpcmVFdmVudCgnc3VjY2VzcycsIGFyZ3VtZW50cykuY2FsbENoYWluKCk7Cgl9LAoKCWZhaWx1cmU6IGZ1bmN0aW9uKCl7CgkJdGhpcy5vbkZhaWx1cmUoKTsKCX0sCgoJb25GYWlsdXJlOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScpLmZpcmVFdmVudCgnZmFpbHVyZScsIHRoaXMueGhyKTsKCX0sCgoJbG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ2xvYWRzdGFydCcsIFtldmVudCwgdGhpcy54aHJdKTsKCX0sCgoJcHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50KXsKCQl0aGlzLmZpcmVFdmVudCgncHJvZ3Jlc3MnLCBbZXZlbnQsIHRoaXMueGhyXSk7Cgl9LAoKCXRpbWVvdXQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ3RpbWVvdXQnLCB0aGlzLnhocik7Cgl9LAoKCXNldEhlYWRlcjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewoJCXRoaXMuaGVhZGVyc1tuYW1lXSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUpewoJCXJldHVybiBGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJCXJldHVybiB0aGlzLnhoci5nZXRSZXNwb25zZUhlYWRlcihuYW1lKTsKCQl9LmJpbmQodGhpcykpOwoJfSwKCgljaGVjazogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMucnVubmluZykgcmV0dXJuIHRydWU7CgkJc3dpdGNoICh0aGlzLm9wdGlvbnMubGluayl7CgkJCWNhc2UgJ2NhbmNlbCc6IHRoaXMuY2FuY2VsKCk7IHJldHVybiB0cnVlOwoJCQljYXNlICdjaGFpbic6IHRoaXMuY2hhaW4odGhpcy5jYWxsZXIucGFzcyhhcmd1bWVudHMsIHRoaXMpKTsgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCXNlbmQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCWlmICghdGhpcy5jaGVjayhvcHRpb25zKSkgcmV0dXJuIHRoaXM7CgoJCXRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MgPSB0aGlzLm9wdGlvbnMuaXNTdWNjZXNzIHx8IHRoaXMuaXNTdWNjZXNzOwoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCXZhciB0eXBlID0gdHlwZU9mKG9wdGlvbnMpOwoJCWlmICh0eXBlID09ICdzdHJpbmcnIHx8IHR5cGUgPT0gJ2VsZW1lbnQnKSBvcHRpb25zID0ge2RhdGE6IG9wdGlvbnN9OwoKCQl2YXIgb2xkID0gdGhpcy5vcHRpb25zOwoJCW9wdGlvbnMgPSBPYmplY3QuYXBwZW5kKHtkYXRhOiBvbGQuZGF0YSwgdXJsOiBvbGQudXJsLCBtZXRob2Q6IG9sZC5tZXRob2R9LCBvcHRpb25zKTsKCQl2YXIgZGF0YSA9IG9wdGlvbnMuZGF0YSwgdXJsID0gU3RyaW5nKG9wdGlvbnMudXJsKSwgbWV0aG9kID0gb3B0aW9ucy5tZXRob2QudG9Mb3dlckNhc2UoKTsKCgkJc3dpdGNoICh0eXBlT2YoZGF0YSkpewoJCQljYXNlICdlbGVtZW50JzogZGF0YSA9IGRvY3VtZW50LmlkKGRhdGEpLnRvUXVlcnlTdHJpbmcoKTsgYnJlYWs7CgkJCWNhc2UgJ29iamVjdCc6IGNhc2UgJ2hhc2gnOiBkYXRhID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcoZGF0YSk7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmZvcm1hdCl7CgkJCXZhciBmb3JtYXQgPSAnZm9ybWF0PScgKyB0aGlzLm9wdGlvbnMuZm9ybWF0OwoJCQlkYXRhID0gKGRhdGEpID8gZm9ybWF0ICsgJyYnICsgZGF0YSA6IGZvcm1hdDsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMuZW11bGF0aW9uICYmICFbJ2dldCcsICdwb3N0J10uY29udGFpbnMobWV0aG9kKSl7CgkJCXZhciBfbWV0aG9kID0gJ19tZXRob2Q9JyArIG1ldGhvZDsKCQkJZGF0YSA9IChkYXRhKSA/IF9tZXRob2QgKyAnJicgKyBkYXRhIDogX21ldGhvZDsKCQkJbWV0aG9kID0gJ3Bvc3QnOwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy51cmxFbmNvZGVkICYmIFsncG9zdCcsICdwdXQnXS5jb250YWlucyhtZXRob2QpKXsKCQkJdmFyIGVuY29kaW5nID0gKHRoaXMub3B0aW9ucy5lbmNvZGluZykgPyAnOyBjaGFyc2V0PScgKyB0aGlzLm9wdGlvbnMuZW5jb2RpbmcgOiAnJzsKCQkJdGhpcy5oZWFkZXJzWydDb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnICsgZW5jb2Rpbmc7CgkJfQoKCQlpZiAoIXVybCkgdXJsID0gZG9jdW1lbnQubG9jYXRpb24ucGF0aG5hbWU7CgoJCXZhciB0cmltUG9zaXRpb24gPSB1cmwubGFzdEluZGV4T2YoJy8nKTsKCQlpZiAodHJpbVBvc2l0aW9uID4gLTEgJiYgKHRyaW1Qb3NpdGlvbiA9IHVybC5pbmRleE9mKCcjJykpID4gLTEpIHVybCA9IHVybC5zdWJzdHIoMCwgdHJpbVBvc2l0aW9uKTsKCgkJaWYgKHRoaXMub3B0aW9ucy5ub0NhY2hlKQoJCQl1cmwgKz0gKHVybC5jb250YWlucygnPycpID8gJyYnIDogJz8nKSArIFN0cmluZy51bmlxdWVJRCgpOwoKCQlpZiAoZGF0YSAmJiBtZXRob2QgPT0gJ2dldCcpewoJCQl1cmwgKz0gKHVybC5jb250YWlucygnPycpID8gJyYnIDogJz8nKSArIGRhdGE7CgkJCWRhdGEgPSBudWxsOwoJCX0KCgkJdmFyIHhociA9IHRoaXMueGhyOwoJCWlmIChwcm9ncmVzc1N1cHBvcnQpewoJCQl4aHIub25sb2Fkc3RhcnQgPSB0aGlzLmxvYWRzdGFydC5iaW5kKHRoaXMpOwoJCQl4aHIub25wcm9ncmVzcyA9IHRoaXMucHJvZ3Jlc3MuYmluZCh0aGlzKTsKCQl9CgoJCXhoci5vcGVuKG1ldGhvZC50b1VwcGVyQ2FzZSgpLCB1cmwsIHRoaXMub3B0aW9ucy5hc3luYywgdGhpcy5vcHRpb25zLnVzZXIsIHRoaXMub3B0aW9ucy5wYXNzd29yZCk7CgkJaWYgKHRoaXMub3B0aW9ucy51c2VyICYmICd3aXRoQ3JlZGVudGlhbHMnIGluIHhocikgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CgoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSB0aGlzLm9uU3RhdGVDaGFuZ2UuYmluZCh0aGlzKTsKCgkJT2JqZWN0LmVhY2godGhpcy5oZWFkZXJzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJdHJ5IHsKCQkJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwoJCQl9IGNhdGNoIChlKXsKCQkJCXRoaXMuZmlyZUV2ZW50KCdleGNlcHRpb24nLCBba2V5LCB2YWx1ZV0pOwoJCQl9CgkJfSwgdGhpcyk7CgoJCXRoaXMuZmlyZUV2ZW50KCdyZXF1ZXN0Jyk7CgkJeGhyLnNlbmQoZGF0YSk7CgkJaWYgKCF0aGlzLm9wdGlvbnMuYXN5bmMpIHRoaXMub25TdGF0ZUNoYW5nZSgpOwoJCWVsc2UgaWYgKHRoaXMub3B0aW9ucy50aW1lb3V0KSB0aGlzLnRpbWVyID0gdGhpcy50aW1lb3V0LmRlbGF5KHRoaXMub3B0aW9ucy50aW1lb3V0LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FuY2VsOiBmdW5jdGlvbigpewoJCWlmICghdGhpcy5ydW5uaW5nKSByZXR1cm4gdGhpczsKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJeGhyLmFib3J0KCk7CgkJY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eTsKCQlpZiAocHJvZ3Jlc3NTdXBwb3J0KSB4aHIub25wcm9ncmVzcyA9IHhoci5vbmxvYWRzdGFydCA9IGVtcHR5OwoJCXRoaXMueGhyID0gbmV3IEJyb3dzZXIuUmVxdWVzdCgpOwoJCXRoaXMuZmlyZUV2ZW50KCdjYW5jZWwnKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKdmFyIG1ldGhvZHMgPSB7fTsKWydnZXQnLCAncG9zdCcsICdwdXQnLCAnZGVsZXRlJywgJ0dFVCcsICdQT1NUJywgJ1BVVCcsICdERUxFVEUnXS5lYWNoKGZ1bmN0aW9uKG1ldGhvZCl7CgltZXRob2RzW21ldGhvZF0gPSBmdW5jdGlvbihkYXRhKXsKCQl2YXIgb2JqZWN0ID0gewoJCQltZXRob2Q6IG1ldGhvZAoJCX07CgkJaWYgKGRhdGEgIT0gbnVsbCkgb2JqZWN0LmRhdGEgPSBkYXRhOwoJCXJldHVybiB0aGlzLnNlbmQob2JqZWN0KTsKCX07Cn0pOwoKUmVxdWVzdC5pbXBsZW1lbnQobWV0aG9kcyk7CgpFbGVtZW50LlByb3BlcnRpZXMuc2VuZCA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXZhciBzZW5kID0gdGhpcy5nZXQoJ3NlbmQnKS5jYW5jZWwoKTsKCQlzZW5kLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgc2VuZCA9IHRoaXMucmV0cmlldmUoJ3NlbmQnKTsKCQlpZiAoIXNlbmQpewoJCQlzZW5kID0gbmV3IFJlcXVlc3QoewoJCQkJZGF0YTogdGhpcywgbGluazogJ2NhbmNlbCcsIG1ldGhvZDogdGhpcy5nZXQoJ21ldGhvZCcpIHx8ICdwb3N0JywgdXJsOiB0aGlzLmdldCgnYWN0aW9uJykKCQkJfSk7CgkJCXRoaXMuc3RvcmUoJ3NlbmQnLCBzZW5kKTsKCQl9CgkJcmV0dXJuIHNlbmQ7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNlbmQ6IGZ1bmN0aW9uKHVybCl7CgkJdmFyIHNlbmRlciA9IHRoaXMuZ2V0KCdzZW5kJyk7CgkJc2VuZGVyLnNlbmQoe2RhdGE6IHRoaXMsIHVybDogdXJsIHx8IHNlbmRlci5vcHRpb25zLnVybH0pOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogUmVxdWVzdC5IVE1MCgpkZXNjcmlwdGlvbjogRXh0ZW5kcyB0aGUgYmFzaWMgUmVxdWVzdCBDbGFzcyB3aXRoIGFkZGl0aW9uYWwgbWV0aG9kcyBmb3IgaW50ZXJhY3Rpbmcgd2l0aCBIVE1MIHJlc3BvbnNlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBSZXF1ZXN0XQoKcHJvdmlkZXM6IFJlcXVlc3QuSFRNTAoKLi4uCiovCgpSZXF1ZXN0LkhUTUwgPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IFJlcXVlc3QsCgoJb3B0aW9uczogewoJCXVwZGF0ZTogZmFsc2UsCgkJYXBwZW5kOiBmYWxzZSwKCQlldmFsU2NyaXB0czogdHJ1ZSwKCQlmaWx0ZXI6IGZhbHNlLAoJCWhlYWRlcnM6IHsKCQkJQWNjZXB0OiAndGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCgkJfQoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0KXsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywgcmVzcG9uc2UgPSB0aGlzLnJlc3BvbnNlOwoKCQlyZXNwb25zZS5odG1sID0gdGV4dC5zdHJpcFNjcmlwdHMoZnVuY3Rpb24oc2NyaXB0KXsKCQkJcmVzcG9uc2UuamF2YXNjcmlwdCA9IHNjcmlwdDsKCQl9KTsKCgkJdmFyIG1hdGNoID0gcmVzcG9uc2UuaHRtbC5tYXRjaCgvPGJvZHlbXj5dKj4oW1xzXFNdKj8pPFwvYm9keT4vaSk7CgkJaWYgKG1hdGNoKSByZXNwb25zZS5odG1sID0gbWF0Y2hbMV07CgkJdmFyIHRlbXAgPSBuZXcgRWxlbWVudCgnZGl2Jykuc2V0KCdodG1sJywgcmVzcG9uc2UuaHRtbCk7CgoJCXJlc3BvbnNlLnRyZWUgPSB0ZW1wLmNoaWxkTm9kZXM7CgkJcmVzcG9uc2UuZWxlbWVudHMgPSB0ZW1wLmdldEVsZW1lbnRzKG9wdGlvbnMuZmlsdGVyIHx8ICcqJyk7CgoJCWlmIChvcHRpb25zLmZpbHRlcikgcmVzcG9uc2UudHJlZSA9IHJlc3BvbnNlLmVsZW1lbnRzOwoJCWlmIChvcHRpb25zLnVwZGF0ZSl7CgkJCXZhciB1cGRhdGUgPSBkb2N1bWVudC5pZChvcHRpb25zLnVwZGF0ZSkuZW1wdHkoKTsKCQkJaWYgKG9wdGlvbnMuZmlsdGVyKSB1cGRhdGUuYWRvcHQocmVzcG9uc2UuZWxlbWVudHMpOwoJCQllbHNlIHVwZGF0ZS5zZXQoJ2h0bWwnLCByZXNwb25zZS5odG1sKTsKCQl9IGVsc2UgaWYgKG9wdGlvbnMuYXBwZW5kKXsKCQkJdmFyIGFwcGVuZCA9IGRvY3VtZW50LmlkKG9wdGlvbnMuYXBwZW5kKTsKCQkJaWYgKG9wdGlvbnMuZmlsdGVyKSByZXNwb25zZS5lbGVtZW50cy5yZXZlcnNlKCkuaW5qZWN0KGFwcGVuZCk7CgkJCWVsc2UgYXBwZW5kLmFkb3B0KHRlbXAuZ2V0Q2hpbGRyZW4oKSk7CgkJfQoJCWlmIChvcHRpb25zLmV2YWxTY3JpcHRzKSBCcm93c2VyLmV4ZWMocmVzcG9uc2UuamF2YXNjcmlwdCk7CgoJCXRoaXMub25TdWNjZXNzKHJlc3BvbnNlLnRyZWUsIHJlc3BvbnNlLmVsZW1lbnRzLCByZXNwb25zZS5odG1sLCByZXNwb25zZS5qYXZhc2NyaXB0KTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLmxvYWQgPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgbG9hZCA9IHRoaXMuZ2V0KCdsb2FkJykuY2FuY2VsKCk7CgkJbG9hZC5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIGxvYWQgPSB0aGlzLnJldHJpZXZlKCdsb2FkJyk7CgkJaWYgKCFsb2FkKXsKCQkJbG9hZCA9IG5ldyBSZXF1ZXN0LkhUTUwoe2RhdGE6IHRoaXMsIGxpbms6ICdjYW5jZWwnLCB1cGRhdGU6IHRoaXMsIG1ldGhvZDogJ2dldCd9KTsKCQkJdGhpcy5zdG9yZSgnbG9hZCcsIGxvYWQpOwoJCX0KCQlyZXR1cm4gbG9hZDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJbG9hZDogZnVuY3Rpb24oKXsKCQl0aGlzLmdldCgnbG9hZCcpLnNlbmQoQXJyYXkubGluayhhcmd1bWVudHMsIHtkYXRhOiBUeXBlLmlzT2JqZWN0LCB1cmw6IFR5cGUuaXNTdHJpbmd9KSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEpTT04KCmRlc2NyaXB0aW9uOiBKU09OIGVuY29kZXIgYW5kIGRlY29kZXIuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KClNlZUFsc286IDxodHRwOi8vd3d3Lmpzb24ub3JnLz4KCnJlcXVpcmVzOiBbQXJyYXksIFN0cmluZywgTnVtYmVyLCBGdW5jdGlvbl0KCnByb3ZpZGVzOiBKU09OCgouLi4KKi8KCmlmICh0eXBlb2YgSlNPTiA9PSAndW5kZWZpbmVkJykgdGhpcy5KU09OID0ge307CgovLzwxLjJjb21wYXQ+CgpKU09OID0gbmV3IEhhc2goewoJc3RyaW5naWZ5OiBKU09OLnN0cmluZ2lmeSwKCXBhcnNlOiBKU09OLnBhcnNlCn0pOwoKLy88LzEuMmNvbXBhdD4KCihmdW5jdGlvbigpewoKdmFyIHNwZWNpYWwgPSB7J1xiJzogJ1xcYicsICdcdCc6ICdcXHQnLCAnXG4nOiAnXFxuJywgJ1xmJzogJ1xcZicsICdccic6ICdcXHInLCAnIicgOiAnXFwiJywgJ1xcJzogJ1xcXFwnfTsKCnZhciBlc2NhcGUgPSBmdW5jdGlvbihjaHIpewoJcmV0dXJuIHNwZWNpYWxbY2hyXSB8fCAnXFx1JyArICgnMDAwMCcgKyBjaHIuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC00KTsKfTsKCkpTT04udmFsaWRhdGUgPSBmdW5jdGlvbihzdHJpbmcpewoJc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UoL1xcKD86WyJcXFwvYmZucnRdfHVbMC05YS1mQS1GXXs0fSkvZywgJ0AnKS4KCQkJCQlyZXBsYWNlKC8iW14iXFxcblxyXSoifHRydWV8ZmFsc2V8bnVsbHwtP1xkKyg/OlwuXGQqKT8oPzpbZUVdWytcLV0/XGQrKT8vZywgJ10nKS4KCQkJCQlyZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICcnKTsKCglyZXR1cm4gKC9eW1xdLDp7fVxzXSokLykudGVzdChzdHJpbmcpOwp9OwoKSlNPTi5lbmNvZGUgPSBKU09OLnN0cmluZ2lmeSA/IGZ1bmN0aW9uKG9iail7CglyZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqKTsKfSA6IGZ1bmN0aW9uKG9iail7CglpZiAob2JqICYmIG9iai50b0pTT04pIG9iaiA9IG9iai50b0pTT04oKTsKCglzd2l0Y2ggKHR5cGVPZihvYmopKXsKCQljYXNlICdzdHJpbmcnOgoJCQlyZXR1cm4gJyInICsgb2JqLnJlcGxhY2UoL1tceDAwLVx4MWZcXCJdL2csIGVzY2FwZSkgKyAnIic7CgkJY2FzZSAnYXJyYXknOgoJCQlyZXR1cm4gJ1snICsgb2JqLm1hcChKU09OLmVuY29kZSkuY2xlYW4oKSArICddJzsKCQljYXNlICdvYmplY3QnOiBjYXNlICdoYXNoJzoKCQkJdmFyIHN0cmluZyA9IFtdOwoJCQlPYmplY3QuZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQkJdmFyIGpzb24gPSBKU09OLmVuY29kZSh2YWx1ZSk7CgkJCQlpZiAoanNvbikgc3RyaW5nLnB1c2goSlNPTi5lbmNvZGUoa2V5KSArICc6JyArIGpzb24pOwoJCQl9KTsKCQkJcmV0dXJuICd7JyArIHN0cmluZyArICd9JzsKCQljYXNlICdudW1iZXInOiBjYXNlICdib29sZWFuJzogcmV0dXJuICcnICsgb2JqOwoJCWNhc2UgJ251bGwnOiByZXR1cm4gJ251bGwnOwoJfQoKCXJldHVybiBudWxsOwp9OwoKSlNPTi5kZWNvZGUgPSBmdW5jdGlvbihzdHJpbmcsIHNlY3VyZSl7CglpZiAoIXN0cmluZyB8fCB0eXBlT2Yoc3RyaW5nKSAhPSAnc3RyaW5nJykgcmV0dXJuIG51bGw7CgoJaWYgKHNlY3VyZSB8fCBKU09OLnNlY3VyZSl7CgkJaWYgKEpTT04ucGFyc2UpIHJldHVybiBKU09OLnBhcnNlKHN0cmluZyk7CgkJaWYgKCFKU09OLnZhbGlkYXRlKHN0cmluZykpIHRocm93IG5ldyBFcnJvcignSlNPTiBjb3VsZCBub3QgZGVjb2RlIHRoZSBpbnB1dDsgc2VjdXJpdHkgaXMgZW5hYmxlZCBhbmQgdGhlIHZhbHVlIGlzIG5vdCBzZWN1cmUuJyk7Cgl9CgoJcmV0dXJuIGV2YWwoJygnICsgc3RyaW5nICsgJyknKTsKfTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBSZXF1ZXN0LkpTT04KCmRlc2NyaXB0aW9uOiBFeHRlbmRzIHRoZSBiYXNpYyBSZXF1ZXN0IENsYXNzIHdpdGggYWRkaXRpb25hbCBtZXRob2RzIGZvciBzZW5kaW5nIGFuZCByZWNlaXZpbmcgSlNPTiBkYXRhLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW1JlcXVlc3QsIEpTT05dCgpwcm92aWRlczogUmVxdWVzdC5KU09OCgouLi4KKi8KClJlcXVlc3QuSlNPTiA9IG5ldyBDbGFzcyh7CgoJRXh0ZW5kczogUmVxdWVzdCwKCglvcHRpb25zOiB7CgkJLypvbkVycm9yOiBmdW5jdGlvbih0ZXh0LCBlcnJvcil7fSwqLwoJCXNlY3VyZTogdHJ1ZQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCQlPYmplY3QuYXBwZW5kKHRoaXMuaGVhZGVycywgewoJCQknQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLAoJCQknWC1SZXF1ZXN0JzogJ0pTT04nCgkJfSk7Cgl9LAoKCXN1Y2Nlc3M6IGZ1bmN0aW9uKHRleHQpewoJCXZhciBqc29uOwoJCXRyeSB7CgkJCWpzb24gPSB0aGlzLnJlc3BvbnNlLmpzb24gPSBKU09OLmRlY29kZSh0ZXh0LCB0aGlzLm9wdGlvbnMuc2VjdXJlKTsKCQl9IGNhdGNoIChlcnJvcil7CgkJCXRoaXMuZmlyZUV2ZW50KCdlcnJvcicsIFt0ZXh0LCBlcnJvcl0pOwoJCQlyZXR1cm47CgkJfQoJCWlmIChqc29uID09IG51bGwpIHRoaXMub25GYWlsdXJlKCk7CgkJZWxzZSB0aGlzLm9uU3VjY2Vzcyhqc29uLCB0ZXh0KTsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogQ29va2llCgpkZXNjcmlwdGlvbjogQ2xhc3MgZm9yIGNyZWF0aW5nLCByZWFkaW5nLCBhbmQgZGVsZXRpbmcgYnJvd3NlciBDb29raWVzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gQmFzZWQgb24gdGhlIGZ1bmN0aW9ucyBieSBQZXRlci1QYXVsIEtvY2ggKGh0dHA6Ly9xdWlya3Ntb2RlLm9yZykuCgpyZXF1aXJlczogW09wdGlvbnMsIEJyb3dzZXJdCgpwcm92aWRlczogQ29va2llCgouLi4KKi8KCnZhciBDb29raWUgPSBuZXcgQ2xhc3MoewoKCUltcGxlbWVudHM6IE9wdGlvbnMsCgoJb3B0aW9uczogewoJCXBhdGg6ICcvJywKCQlkb21haW46IGZhbHNlLAoJCWR1cmF0aW9uOiBmYWxzZSwKCQlzZWN1cmU6IGZhbHNlLAoJCWRvY3VtZW50OiBkb2N1bWVudCwKCQllbmNvZGU6IHRydWUKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oa2V5LCBvcHRpb25zKXsKCQl0aGlzLmtleSA9IGtleTsKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7Cgl9LAoKCXdyaXRlOiBmdW5jdGlvbih2YWx1ZSl7CgkJaWYgKHRoaXMub3B0aW9ucy5lbmNvZGUpIHZhbHVlID0gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKCQlpZiAodGhpcy5vcHRpb25zLmRvbWFpbikgdmFsdWUgKz0gJzsgZG9tYWluPScgKyB0aGlzLm9wdGlvbnMuZG9tYWluOwoJCWlmICh0aGlzLm9wdGlvbnMucGF0aCkgdmFsdWUgKz0gJzsgcGF0aD0nICsgdGhpcy5vcHRpb25zLnBhdGg7CgkJaWYgKHRoaXMub3B0aW9ucy5kdXJhdGlvbil7CgkJCXZhciBkYXRlID0gbmV3IERhdGUoKTsKCQkJZGF0ZS5zZXRUaW1lKGRhdGUuZ2V0VGltZSgpICsgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogMjQgKiA2MCAqIDYwICogMTAwMCk7CgkJCXZhbHVlICs9ICc7IGV4cGlyZXM9JyArIGRhdGUudG9HTVRTdHJpbmcoKTsKCQl9CgkJaWYgKHRoaXMub3B0aW9ucy5zZWN1cmUpIHZhbHVlICs9ICc7IHNlY3VyZSc7CgkJdGhpcy5vcHRpb25zLmRvY3VtZW50LmNvb2tpZSA9IHRoaXMua2V5ICsgJz0nICsgdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlYWQ6IGZ1bmN0aW9uKCl7CgkJdmFyIHZhbHVlID0gdGhpcy5vcHRpb25zLmRvY3VtZW50LmNvb2tpZS5tYXRjaCgnKD86Xnw7KVxccyonICsgdGhpcy5rZXkuZXNjYXBlUmVnRXhwKCkgKyAnPShbXjtdKiknKTsKCQlyZXR1cm4gKHZhbHVlKSA/IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZVsxXSkgOiBudWxsOwoJfSwKCglkaXNwb3NlOiBmdW5jdGlvbigpewoJCW5ldyBDb29raWUodGhpcy5rZXksIE9iamVjdC5tZXJnZSh7fSwgdGhpcy5vcHRpb25zLCB7ZHVyYXRpb246IC0xfSkpLndyaXRlKCcnKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKQ29va2llLndyaXRlID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSwgb3B0aW9ucyl7CglyZXR1cm4gbmV3IENvb2tpZShrZXksIG9wdGlvbnMpLndyaXRlKHZhbHVlKTsKfTsKCkNvb2tpZS5yZWFkID0gZnVuY3Rpb24oa2V5KXsKCXJldHVybiBuZXcgQ29va2llKGtleSkucmVhZCgpOwp9OwoKQ29va2llLmRpc3Bvc2UgPSBmdW5jdGlvbihrZXksIG9wdGlvbnMpewoJcmV0dXJuIG5ldyBDb29raWUoa2V5LCBvcHRpb25zKS5kaXNwb3NlKCk7Cn07CgoKLyoKLS0tCgpuYW1lOiBET01SZWFkeQoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBjdXN0b20gZXZlbnQgZG9tcmVhZHkuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQnJvd3NlciwgRWxlbWVudCwgRWxlbWVudC5FdmVudF0KCnByb3ZpZGVzOiBbRE9NUmVhZHksIERvbVJlYWR5XQoKLi4uCiovCgooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCl7Cgp2YXIgcmVhZHksCglsb2FkZWQsCgljaGVja3MgPSBbXSwKCXNob3VsZFBvbGwsCgl0aW1lciwKCXRlc3RFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7Cgp2YXIgZG9tcmVhZHkgPSBmdW5jdGlvbigpewoJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCWlmIChyZWFkeSkgcmV0dXJuOwoJQnJvd3Nlci5sb2FkZWQgPSByZWFkeSA9IHRydWU7Cglkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbXJlYWR5KS5yZW1vdmVMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGNoZWNrKTsKCglkb2N1bWVudC5maXJlRXZlbnQoJ2RvbXJlYWR5Jyk7Cgl3aW5kb3cuZmlyZUV2ZW50KCdkb21yZWFkeScpOwp9OwoKdmFyIGNoZWNrID0gZnVuY3Rpb24oKXsKCWZvciAodmFyIGkgPSBjaGVja3MubGVuZ3RoOyBpLS07KSBpZiAoY2hlY2tzW2ldKCkpewoJCWRvbXJlYWR5KCk7CgkJcmV0dXJuIHRydWU7Cgl9CglyZXR1cm4gZmFsc2U7Cn07Cgp2YXIgcG9sbCA9IGZ1bmN0aW9uKCl7CgljbGVhclRpbWVvdXQodGltZXIpOwoJaWYgKCFjaGVjaygpKSB0aW1lciA9IHNldFRpbWVvdXQocG9sbCwgMTApOwp9OwoKZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21yZWFkeSk7CgovKjxsdElFOD4qLwovLyBkb1Njcm9sbCB0ZWNobmlxdWUgYnkgRGllZ28gUGVyaW5pIGh0dHA6Ly9qYXZhc2NyaXB0Lm53Ym94LmNvbS9JRUNvbnRlbnRMb2FkZWQvCi8vIHRlc3RFbGVtZW50LmRvU2Nyb2xsKCkgdGhyb3dzIHdoZW4gdGhlIERPTSBpcyBub3QgcmVhZHksIG9ubHkgaW4gdGhlIHRvcCB3aW5kb3cKdmFyIGRvU2Nyb2xsV29ya3MgPSBmdW5jdGlvbigpewoJdHJ5IHsKCQl0ZXN0RWxlbWVudC5kb1Njcm9sbCgpOwoJCXJldHVybiB0cnVlOwoJfSBjYXRjaCAoZSl7fQoJcmV0dXJuIGZhbHNlOwp9OwovLyBJZiBkb1Njcm9sbCB3b3JrcyBhbHJlYWR5LCBpdCBjYW4ndCBiZSB1c2VkIHRvIGRldGVybWluZSBkb21yZWFkeQovLyAgIGUuZy4gaW4gYW4gaWZyYW1lCmlmICh0ZXN0RWxlbWVudC5kb1Njcm9sbCAmJiAhZG9TY3JvbGxXb3JrcygpKXsKCWNoZWNrcy5wdXNoKGRvU2Nyb2xsV29ya3MpOwoJc2hvdWxkUG9sbCA9IHRydWU7Cn0KLyo8L2x0SUU4PiovCgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSkgY2hlY2tzLnB1c2goZnVuY3Rpb24oKXsKCXZhciBzdGF0ZSA9IGRvY3VtZW50LnJlYWR5U3RhdGU7CglyZXR1cm4gKHN0YXRlID09ICdsb2FkZWQnIHx8IHN0YXRlID09ICdjb21wbGV0ZScpOwp9KTsKCmlmICgnb25yZWFkeXN0YXRlY2hhbmdlJyBpbiBkb2N1bWVudCkgZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBjaGVjayk7CmVsc2Ugc2hvdWxkUG9sbCA9IHRydWU7CgppZiAoc2hvdWxkUG9sbCkgcG9sbCgpOwoKRWxlbWVudC5FdmVudHMuZG9tcmVhZHkgPSB7CglvbkFkZDogZnVuY3Rpb24oZm4pewoJCWlmIChyZWFkeSkgZm4uY2FsbCh0aGlzKTsKCX0KfTsKCi8vIE1ha2Ugc3VyZSB0aGF0IGRvbXJlYWR5IGZpcmVzIGJlZm9yZSBsb2FkCkVsZW1lbnQuRXZlbnRzLmxvYWQgPSB7CgliYXNlOiAnbG9hZCcsCglvbkFkZDogZnVuY3Rpb24oZm4pewoJCWlmIChsb2FkZWQgJiYgdGhpcyA9PSB3aW5kb3cpIGZuLmNhbGwodGhpcyk7Cgl9LAoJY29uZGl0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzID09IHdpbmRvdyl7CgkJCWRvbXJlYWR5KCk7CgkJCWRlbGV0ZSBFbGVtZW50LkV2ZW50cy5sb2FkOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0KfTsKCi8vIFRoaXMgaXMgYmFzZWQgb24gdGhlIGN1c3RvbSBsb2FkIGV2ZW50CndpbmRvdy5hZGRFdmVudCgnbG9hZCcsIGZ1bmN0aW9uKCl7Cglsb2FkZWQgPSB0cnVlOwp9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwoKCi8qCi0tLQoKbmFtZTogU3dpZmYKCmRlc2NyaXB0aW9uOiBXcmFwcGVyIGZvciBlbWJlZGRpbmcgU1dGIG1vdmllcy4gU3VwcG9ydHMgRXh0ZXJuYWwgSW50ZXJmYWNlIENvbW11bmljYXRpb24uCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBGbGFzaCBkZXRlY3Rpb24gJiBJbnRlcm5ldCBFeHBsb3JlciArIEZsYXNoIFBsYXllciA5IGZpeCBpbnNwaXJlZCBieSBTV0ZPYmplY3QuCgpyZXF1aXJlczogW09wdGlvbnMsIE9iamVjdCwgRWxlbWVudF0KCnByb3ZpZGVzOiBTd2lmZgoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBTd2lmZiA9IHRoaXMuU3dpZmYgPSBuZXcgQ2xhc3MoewoKCUltcGxlbWVudHM6IE9wdGlvbnMsCgoJb3B0aW9uczogewoJCWlkOiBudWxsLAoJCWhlaWdodDogMSwKCQl3aWR0aDogMSwKCQljb250YWluZXI6IG51bGwsCgkJcHJvcGVydGllczoge30sCgkJcGFyYW1zOiB7CgkJCXF1YWxpdHk6ICdoaWdoJywKCQkJYWxsb3dTY3JpcHRBY2Nlc3M6ICdhbHdheXMnLAoJCQl3TW9kZTogJ3dpbmRvdycsCgkJCXN3TGl2ZUNvbm5lY3Q6IHRydWUKCQl9LAoJCWNhbGxCYWNrczoge30sCgkJdmFyczoge30KCX0sCgoJdG9FbGVtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLm9iamVjdDsKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ocGF0aCwgb3B0aW9ucyl7CgkJdGhpcy5pbnN0YW5jZSA9ICdTd2lmZl8nICsgU3RyaW5nLnVuaXF1ZUlEKCk7CgoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoJCXZhciBpZCA9IHRoaXMuaWQgPSBvcHRpb25zLmlkIHx8IHRoaXMuaW5zdGFuY2U7CgkJdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmlkKG9wdGlvbnMuY29udGFpbmVyKTsKCgkJU3dpZmYuQ2FsbEJhY2tzW3RoaXMuaW5zdGFuY2VdID0ge307CgoJCXZhciBwYXJhbXMgPSBvcHRpb25zLnBhcmFtcywgdmFycyA9IG9wdGlvbnMudmFycywgY2FsbEJhY2tzID0gb3B0aW9ucy5jYWxsQmFja3M7CgkJdmFyIHByb3BlcnRpZXMgPSBPYmplY3QuYXBwZW5kKHtoZWlnaHQ6IG9wdGlvbnMuaGVpZ2h0LCB3aWR0aDogb3B0aW9ucy53aWR0aH0sIG9wdGlvbnMucHJvcGVydGllcyk7CgoJCXZhciBzZWxmID0gdGhpczsKCgkJZm9yICh2YXIgY2FsbEJhY2sgaW4gY2FsbEJhY2tzKXsKCQkJU3dpZmYuQ2FsbEJhY2tzW3RoaXMuaW5zdGFuY2VdW2NhbGxCYWNrXSA9IChmdW5jdGlvbihvcHRpb24pewoJCQkJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJCQkJcmV0dXJuIG9wdGlvbi5hcHBseShzZWxmLm9iamVjdCwgYXJndW1lbnRzKTsKCQkJCX07CgkJCX0pKGNhbGxCYWNrc1tjYWxsQmFja10pOwoJCQl2YXJzW2NhbGxCYWNrXSA9ICdTd2lmZi5DYWxsQmFja3MuJyArIHRoaXMuaW5zdGFuY2UgKyAnLicgKyBjYWxsQmFjazsKCQl9CgoJCXBhcmFtcy5mbGFzaFZhcnMgPSBPYmplY3QudG9RdWVyeVN0cmluZyh2YXJzKTsKCQlpZiAoQnJvd3Nlci5pZSl7CgkJCXByb3BlcnRpZXMuY2xhc3NpZCA9ICdjbHNpZDpEMjdDREI2RS1BRTZELTExY2YtOTZCOC00NDQ1NTM1NDAwMDAnOwoJCQlwYXJhbXMubW92aWUgPSBwYXRoOwoJCX0gZWxzZSB7CgkJCXByb3BlcnRpZXMudHlwZSA9ICdhcHBsaWNhdGlvbi94LXNob2Nrd2F2ZS1mbGFzaCc7CgkJfQoJCXByb3BlcnRpZXMuZGF0YSA9IHBhdGg7CgoJCXZhciBidWlsZCA9ICc8b2JqZWN0IGlkPSInICsgaWQgKyAnIic7CgkJZm9yICh2YXIgcHJvcGVydHkgaW4gcHJvcGVydGllcykgYnVpbGQgKz0gJyAnICsgcHJvcGVydHkgKyAnPSInICsgcHJvcGVydGllc1twcm9wZXJ0eV0gKyAnIic7CgkJYnVpbGQgKz0gJz4nOwoJCWZvciAodmFyIHBhcmFtIGluIHBhcmFtcyl7CgkJCWlmIChwYXJhbXNbcGFyYW1dKSBidWlsZCArPSAnPHBhcmFtIG5hbWU9IicgKyBwYXJhbSArICciIHZhbHVlPSInICsgcGFyYW1zW3BhcmFtXSArICciIC8+JzsKCQl9CgkJYnVpbGQgKz0gJzwvb2JqZWN0Pic7CgkJdGhpcy5vYmplY3QgPSAoKGNvbnRhaW5lcikgPyBjb250YWluZXIuZW1wdHkoKSA6IG5ldyBFbGVtZW50KCdkaXYnKSkuc2V0KCdodG1sJywgYnVpbGQpLmZpcnN0Q2hpbGQ7Cgl9LAoKCXJlcGxhY2VzOiBmdW5jdGlvbihlbGVtZW50KXsKCQllbGVtZW50ID0gZG9jdW1lbnQuaWQoZWxlbWVudCwgdHJ1ZSk7CgkJZWxlbWVudC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZCh0aGlzLnRvRWxlbWVudCgpLCBlbGVtZW50KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaW5qZWN0OiBmdW5jdGlvbihlbGVtZW50KXsKCQlkb2N1bWVudC5pZChlbGVtZW50LCB0cnVlKS5hcHBlbmRDaGlsZCh0aGlzLnRvRWxlbWVudCgpKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3RlOiBmdW5jdGlvbigpewoJCXJldHVybiBTd2lmZi5yZW1vdGUuYXBwbHkoU3dpZmYsIFt0aGlzLnRvRWxlbWVudCgpXS5hcHBlbmQoYXJndW1lbnRzKSk7Cgl9Cgp9KTsKClN3aWZmLkNhbGxCYWNrcyA9IHt9OwoKU3dpZmYucmVtb3RlID0gZnVuY3Rpb24ob2JqLCBmbil7Cgl2YXIgcnMgPSBvYmouQ2FsbEZ1bmN0aW9uKCc8aW52b2tlIG5hbWU9IicgKyBmbiArICciIHJldHVybnR5cGU9ImphdmFzY3JpcHQiPicgKyBfX2ZsYXNoX19hcmd1bWVudHNUb1hNTChhcmd1bWVudHMsIDIpICsgJzwvaW52b2tlPicpOwoJcmV0dXJuIGV2YWwocnMpOwp9OwoKfSkoKTsKCg==",
                "body": "LyoKLS0tCk1vb1Rvb2xzOiB0aGUgamF2YXNjcmlwdCBmcmFtZXdvcmsKCndlYiBidWlsZDoKIC0gaHR0cDovL21vb3Rvb2xzLm5ldC9jb3JlLzc2YmY0NzA2MmQ2YzE5ODNkNjZjZTQ3YWQ2NmFhMGUwCgpwYWNrYWdlciBidWlsZDoKIC0gcGFja2FnZXIgYnVpbGQgQ29yZS9Db3JlIENvcmUvQXJyYXkgQ29yZS9TdHJpbmcgQ29yZS9OdW1iZXIgQ29yZS9GdW5jdGlvbiBDb3JlL09iamVjdCBDb3JlL0V2ZW50IENvcmUvQnJvd3NlciBDb3JlL0NsYXNzIENvcmUvQ2xhc3MuRXh0cmFzIENvcmUvU2xpY2suUGFyc2VyIENvcmUvU2xpY2suRmluZGVyIENvcmUvRWxlbWVudCBDb3JlL0VsZW1lbnQuU3R5bGUgQ29yZS9FbGVtZW50LkV2ZW50IENvcmUvRWxlbWVudC5EZWxlZ2F0aW9uIENvcmUvRWxlbWVudC5EaW1lbnNpb25zIENvcmUvRnggQ29yZS9GeC5DU1MgQ29yZS9GeC5Ud2VlbiBDb3JlL0Z4Lk1vcnBoIENvcmUvRnguVHJhbnNpdGlvbnMgQ29yZS9SZXF1ZXN0IENvcmUvUmVxdWVzdC5IVE1MIENvcmUvUmVxdWVzdC5KU09OIENvcmUvQ29va2llIENvcmUvSlNPTiBDb3JlL0RPTVJlYWR5IENvcmUvU3dpZmYKCi4uLgoqLwoKLyoKLS0tCgpuYW1lOiBDb3JlCgpkZXNjcmlwdGlvbjogVGhlIGhlYXJ0IG9mIE1vb1Rvb2xzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjb3B5cmlnaHQ6IENvcHlyaWdodCAoYykgMjAwNi0yMDEyIFtWYWxlcmlvIFByb2lldHRpXShodHRwOi8vbWFkNG1pbGsubmV0LykuCgphdXRob3JzOiBUaGUgTW9vVG9vbHMgcHJvZHVjdGlvbiB0ZWFtIChodHRwOi8vbW9vdG9vbHMubmV0L2RldmVsb3BlcnMvKQoKaW5zcGlyYXRpb246CiAgLSBDbGFzcyBpbXBsZW1lbnRhdGlvbiBpbnNwaXJlZCBieSBbQmFzZS5qc10oaHR0cDovL2RlYW4uZWR3YXJkcy5uYW1lL3dlYmxvZy8yMDA2LzAzL2Jhc2UvKSBDb3B5cmlnaHQgKGMpIDIwMDYgRGVhbiBFZHdhcmRzLCBbR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXShodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbGdwbC1saWNlbnNlLnBocCkKICAtIFNvbWUgZnVuY3Rpb25hbGl0eSBpbnNwaXJlZCBieSBbUHJvdG90eXBlLmpzXShodHRwOi8vcHJvdG90eXBlanMub3JnKSBDb3B5cmlnaHQgKGMpIDIwMDUtMjAwNyBTYW0gU3RlcGhlbnNvbiwgW01JVCBMaWNlbnNlXShodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoKcHJvdmlkZXM6IFtDb3JlLCBNb29Ub29scywgVHlwZSwgdHlwZU9mLCBpbnN0YW5jZU9mLCBOYXRpdmVdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdGhpcy5Nb29Ub29scyA9IHsKCXZlcnNpb246ICcxLjQuNScsCglidWlsZDogJ2FiOGVhODgyNGRjM2IyNGI2NjY2ODY3YTJjNGVkNThlYmI3NjJjZjAnCn07CgovLyB0eXBlT2YsIGluc3RhbmNlT2YKCnZhciB0eXBlT2YgPSB0aGlzLnR5cGVPZiA9IGZ1bmN0aW9uKGl0ZW0pewoJaWYgKGl0ZW0gPT0gbnVsbCkgcmV0dXJuICdudWxsJzsKCWlmIChpdGVtLiRmYW1pbHkgIT0gbnVsbCkgcmV0dXJuIGl0ZW0uJGZhbWlseSgpOwoKCWlmIChpdGVtLm5vZGVOYW1lKXsKCQlpZiAoaXRlbS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gJ2VsZW1lbnQnOwoJCWlmIChpdGVtLm5vZGVUeXBlID09IDMpIHJldHVybiAoL1xTLykudGVzdChpdGVtLm5vZGVWYWx1ZSkgPyAndGV4dG5vZGUnIDogJ3doaXRlc3BhY2UnOwoJfSBlbHNlIGlmICh0eXBlb2YgaXRlbS5sZW5ndGggPT0gJ251bWJlcicpewoJCWlmIChpdGVtLmNhbGxlZSkgcmV0dXJuICdhcmd1bWVudHMnOwoJCWlmICgnaXRlbScgaW4gaXRlbSkgcmV0dXJuICdjb2xsZWN0aW9uJzsKCX0KCglyZXR1cm4gdHlwZW9mIGl0ZW07Cn07Cgp2YXIgaW5zdGFuY2VPZiA9IHRoaXMuaW5zdGFuY2VPZiA9IGZ1bmN0aW9uKGl0ZW0sIG9iamVjdCl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gZmFsc2U7Cgl2YXIgY29uc3RydWN0b3IgPSBpdGVtLiRjb25zdHJ1Y3RvciB8fCBpdGVtLmNvbnN0cnVjdG9yOwoJd2hpbGUgKGNvbnN0cnVjdG9yKXsKCQlpZiAoY29uc3RydWN0b3IgPT09IG9iamVjdCkgcmV0dXJuIHRydWU7CgkJY29uc3RydWN0b3IgPSBjb25zdHJ1Y3Rvci5wYXJlbnQ7Cgl9CgkvKjxsdElFOD4qLwoJaWYgKCFpdGVtLmhhc093blByb3BlcnR5KSByZXR1cm4gZmFsc2U7CgkvKjwvbHRJRTg+Ki8KCXJldHVybiBpdGVtIGluc3RhbmNlb2Ygb2JqZWN0Owp9OwoKLy8gRnVuY3Rpb24gb3ZlcmxvYWRpbmcKCnZhciBGdW5jdGlvbiA9IHRoaXMuRnVuY3Rpb247Cgp2YXIgZW51bWVyYWJsZXMgPSB0cnVlOwpmb3IgKHZhciBpIGluIHt0b1N0cmluZzogMX0pIGVudW1lcmFibGVzID0gbnVsbDsKaWYgKGVudW1lcmFibGVzKSBlbnVtZXJhYmxlcyA9IFsnaGFzT3duUHJvcGVydHknLCAndmFsdWVPZicsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvU3RyaW5nJywgJ2NvbnN0cnVjdG9yJ107CgpGdW5jdGlvbi5wcm90b3R5cGUub3ZlcmxvYWRTZXR0ZXIgPSBmdW5jdGlvbih1c2VQbHVyYWwpewoJdmFyIHNlbGYgPSB0aGlzOwoJcmV0dXJuIGZ1bmN0aW9uKGEsIGIpewoJCWlmIChhID09IG51bGwpIHJldHVybiB0aGlzOwoJCWlmICh1c2VQbHVyYWwgfHwgdHlwZW9mIGEgIT0gJ3N0cmluZycpewoJCQlmb3IgKHZhciBrIGluIGEpIHNlbGYuY2FsbCh0aGlzLCBrLCBhW2tdKTsKCQkJaWYgKGVudW1lcmFibGVzKSBmb3IgKHZhciBpID0gZW51bWVyYWJsZXMubGVuZ3RoOyBpLS07KXsKCQkJCWsgPSBlbnVtZXJhYmxlc1tpXTsKCQkJCWlmIChhLmhhc093blByb3BlcnR5KGspKSBzZWxmLmNhbGwodGhpcywgaywgYVtrXSk7CgkJCX0KCQl9IGVsc2UgewoJCQlzZWxmLmNhbGwodGhpcywgYSwgYik7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKfTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5vdmVybG9hZEdldHRlciA9IGZ1bmN0aW9uKHVzZVBsdXJhbCl7Cgl2YXIgc2VsZiA9IHRoaXM7CglyZXR1cm4gZnVuY3Rpb24oYSl7CgkJdmFyIGFyZ3MsIHJlc3VsdDsKCQlpZiAodHlwZW9mIGEgIT0gJ3N0cmluZycpIGFyZ3MgPSBhOwoJCWVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSBhcmdzID0gYXJndW1lbnRzOwoJCWVsc2UgaWYgKHVzZVBsdXJhbCkgYXJncyA9IFthXTsKCQlpZiAoYXJncyl7CgkJCXJlc3VsdCA9IHt9OwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHJlc3VsdFthcmdzW2ldXSA9IHNlbGYuY2FsbCh0aGlzLCBhcmdzW2ldKTsKCQl9IGVsc2UgewoJCQlyZXN1bHQgPSBzZWxmLmNhbGwodGhpcywgYSk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9Owp9OwoKRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJdGhpc1trZXldID0gdmFsdWU7Cn0ub3ZlcmxvYWRTZXR0ZXIoKTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKCXRoaXMucHJvdG90eXBlW2tleV0gPSB2YWx1ZTsKfS5vdmVybG9hZFNldHRlcigpOwoKLy8gRnJvbQoKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKRnVuY3Rpb24uZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuICh0eXBlT2YoaXRlbSkgPT0gJ2Z1bmN0aW9uJykgPyBpdGVtIDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gaXRlbTsKCX07Cn07CgpBcnJheS5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gW107CglyZXR1cm4gKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pICYmIHR5cGVvZiBpdGVtICE9ICdzdHJpbmcnKSA/ICh0eXBlT2YoaXRlbSkgPT0gJ2FycmF5JykgPyBpdGVtIDogc2xpY2UuY2FsbChpdGVtKSA6IFtpdGVtXTsKfTsKCk51bWJlci5mcm9tID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgbnVtYmVyID0gcGFyc2VGbG9hdChpdGVtKTsKCXJldHVybiBpc0Zpbml0ZShudW1iZXIpID8gbnVtYmVyIDogbnVsbDsKfTsKClN0cmluZy5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaXRlbSArICcnOwp9OwoKLy8gaGlkZSwgcHJvdGVjdAoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCgloaWRlOiBmdW5jdGlvbigpewoJCXRoaXMuJGhpZGRlbiA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByb3RlY3Q6IGZ1bmN0aW9uKCl7CgkJdGhpcy4kcHJvdGVjdGVkID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gVHlwZQoKdmFyIFR5cGUgPSB0aGlzLlR5cGUgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QpewoJaWYgKG5hbWUpewoJCXZhciBsb3dlciA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQl2YXIgdHlwZUNoZWNrID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiAodHlwZU9mKGl0ZW0pID09IGxvd2VyKTsKCQl9OwoKCQlUeXBlWydpcycgKyBuYW1lXSA9IHR5cGVDaGVjazsKCQlpZiAob2JqZWN0ICE9IG51bGwpewoJCQlvYmplY3QucHJvdG90eXBlLiRmYW1pbHkgPSAoZnVuY3Rpb24oKXsKCQkJCXJldHVybiBsb3dlcjsKCQkJfSkuaGlkZSgpOwoJCQkvLzwxLjJjb21wYXQ+CgkJCW9iamVjdC50eXBlID0gdHlwZUNoZWNrOwoJCQkvLzwvMS4yY29tcGF0PgoJCX0KCX0KCglpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwoKCW9iamVjdC5leHRlbmQodGhpcyk7CglvYmplY3QuJGNvbnN0cnVjdG9yID0gVHlwZTsKCW9iamVjdC5wcm90b3R5cGUuJGNvbnN0cnVjdG9yID0gb2JqZWN0OwoKCXJldHVybiBvYmplY3Q7Cn07Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKVHlwZS5pc0VudW1lcmFibGUgPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiAoaXRlbSAhPSBudWxsICYmIHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyAmJiB0b1N0cmluZy5jYWxsKGl0ZW0pICE9ICdbb2JqZWN0IEZ1bmN0aW9uXScgKTsKfTsKCnZhciBob29rcyA9IHt9OwoKdmFyIGhvb2tzT2YgPSBmdW5jdGlvbihvYmplY3QpewoJdmFyIHR5cGUgPSB0eXBlT2Yob2JqZWN0LnByb3RvdHlwZSk7CglyZXR1cm4gaG9va3NbdHlwZV0gfHwgKGhvb2tzW3R5cGVdID0gW10pOwp9OwoKdmFyIGltcGxlbWVudCA9IGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7CglpZiAobWV0aG9kICYmIG1ldGhvZC4kaGlkZGVuKSByZXR1cm47CgoJdmFyIGhvb2tzID0gaG9va3NPZih0aGlzKTsKCglmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgaSsrKXsKCQl2YXIgaG9vayA9IGhvb2tzW2ldOwoJCWlmICh0eXBlT2YoaG9vaykgPT0gJ3R5cGUnKSBpbXBsZW1lbnQuY2FsbChob29rLCBuYW1lLCBtZXRob2QpOwoJCWVsc2UgaG9vay5jYWxsKHRoaXMsIG5hbWUsIG1ldGhvZCk7Cgl9CgoJdmFyIHByZXZpb3VzID0gdGhpcy5wcm90b3R5cGVbbmFtZV07CglpZiAocHJldmlvdXMgPT0gbnVsbCB8fCAhcHJldmlvdXMuJHByb3RlY3RlZCkgdGhpcy5wcm90b3R5cGVbbmFtZV0gPSBtZXRob2Q7CgoJaWYgKHRoaXNbbmFtZV0gPT0gbnVsbCAmJiB0eXBlT2YobWV0aG9kKSA9PSAnZnVuY3Rpb24nKSBleHRlbmQuY2FsbCh0aGlzLCBuYW1lLCBmdW5jdGlvbihpdGVtKXsKCQlyZXR1cm4gbWV0aG9kLmFwcGx5KGl0ZW0sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7Cgl9KTsKfTsKCnZhciBleHRlbmQgPSBmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJaWYgKG1ldGhvZCAmJiBtZXRob2QuJGhpZGRlbikgcmV0dXJuOwoJdmFyIHByZXZpb3VzID0gdGhpc1tuYW1lXTsKCWlmIChwcmV2aW91cyA9PSBudWxsIHx8ICFwcmV2aW91cy4kcHJvdGVjdGVkKSB0aGlzW25hbWVdID0gbWV0aG9kOwp9OwoKVHlwZS5pbXBsZW1lbnQoewoKCWltcGxlbWVudDogaW1wbGVtZW50Lm92ZXJsb2FkU2V0dGVyKCksCgoJZXh0ZW5kOiBleHRlbmQub3ZlcmxvYWRTZXR0ZXIoKSwKCglhbGlhczogZnVuY3Rpb24obmFtZSwgZXhpc3RpbmcpewoJCWltcGxlbWVudC5jYWxsKHRoaXMsIG5hbWUsIHRoaXMucHJvdG90eXBlW2V4aXN0aW5nXSk7Cgl9Lm92ZXJsb2FkU2V0dGVyKCksCgoJbWlycm9yOiBmdW5jdGlvbihob29rKXsKCQlob29rc09mKHRoaXMpLnB1c2goaG9vayk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCm5ldyBUeXBlKCdUeXBlJywgVHlwZSk7CgovLyBEZWZhdWx0IFR5cGVzCgp2YXIgZm9yY2UgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QsIG1ldGhvZHMpewoJdmFyIGlzVHlwZSA9IChvYmplY3QgIT0gT2JqZWN0KSwKCQlwcm90b3R5cGUgPSBvYmplY3QucHJvdG90eXBlOwoKCWlmIChpc1R5cGUpIG9iamVjdCA9IG5ldyBUeXBlKG5hbWUsIG9iamVjdCk7CgoJZm9yICh2YXIgaSA9IDAsIGwgPSBtZXRob2RzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJdmFyIGtleSA9IG1ldGhvZHNbaV0sCgkJCWdlbmVyaWMgPSBvYmplY3Rba2V5XSwKCQkJcHJvdG8gPSBwcm90b3R5cGVba2V5XTsKCgkJaWYgKGdlbmVyaWMpIGdlbmVyaWMucHJvdGVjdCgpOwoJCWlmIChpc1R5cGUgJiYgcHJvdG8pIG9iamVjdC5pbXBsZW1lbnQoa2V5LCBwcm90by5wcm90ZWN0KCkpOwoJfQoKCWlmIChpc1R5cGUpewoJCXZhciBtZXRob2RzRW51bWVyYWJsZSA9IHByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZShtZXRob2RzWzBdKTsKCQlvYmplY3QuZm9yRWFjaE1ldGhvZCA9IGZ1bmN0aW9uKGZuKXsKCQkJaWYgKCFtZXRob2RzRW51bWVyYWJsZSkgZm9yICh2YXIgaSA9IDAsIGwgPSBtZXRob2RzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCQlmbi5jYWxsKHByb3RvdHlwZSwgcHJvdG90eXBlW21ldGhvZHNbaV1dLCBtZXRob2RzW2ldKTsKCQkJfQoJCQlmb3IgKHZhciBrZXkgaW4gcHJvdG90eXBlKSBmbi5jYWxsKHByb3RvdHlwZSwgcHJvdG90eXBlW2tleV0sIGtleSkKCQl9OwoJfQoKCXJldHVybiBmb3JjZTsKfTsKCmZvcmNlKCdTdHJpbmcnLCBTdHJpbmcsIFsKCSdjaGFyQXQnLCAnY2hhckNvZGVBdCcsICdjb25jYXQnLCAnaW5kZXhPZicsICdsYXN0SW5kZXhPZicsICdtYXRjaCcsICdxdW90ZScsICdyZXBsYWNlJywgJ3NlYXJjaCcsCgknc2xpY2UnLCAnc3BsaXQnLCAnc3Vic3RyJywgJ3N1YnN0cmluZycsICd0cmltJywgJ3RvTG93ZXJDYXNlJywgJ3RvVXBwZXJDYXNlJwpdKSgnQXJyYXknLCBBcnJheSwgWwoJJ3BvcCcsICdwdXNoJywgJ3JldmVyc2UnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCcsICdjb25jYXQnLCAnam9pbicsICdzbGljZScsCgknaW5kZXhPZicsICdsYXN0SW5kZXhPZicsICdmaWx0ZXInLCAnZm9yRWFjaCcsICdldmVyeScsICdtYXAnLCAnc29tZScsICdyZWR1Y2UnLCAncmVkdWNlUmlnaHQnCl0pKCdOdW1iZXInLCBOdW1iZXIsIFsKCSd0b0V4cG9uZW50aWFsJywgJ3RvRml4ZWQnLCAndG9Mb2NhbGVTdHJpbmcnLCAndG9QcmVjaXNpb24nCl0pKCdGdW5jdGlvbicsIEZ1bmN0aW9uLCBbCgknYXBwbHknLCAnY2FsbCcsICdiaW5kJwpdKSgnUmVnRXhwJywgUmVnRXhwLCBbCgknZXhlYycsICd0ZXN0JwpdKSgnT2JqZWN0JywgT2JqZWN0LCBbCgknY3JlYXRlJywgJ2RlZmluZVByb3BlcnR5JywgJ2RlZmluZVByb3BlcnRpZXMnLCAna2V5cycsCgknZ2V0UHJvdG90eXBlT2YnLCAnZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yJywgJ2dldE93blByb3BlcnR5TmFtZXMnLAoJJ3ByZXZlbnRFeHRlbnNpb25zJywgJ2lzRXh0ZW5zaWJsZScsICdzZWFsJywgJ2lzU2VhbGVkJywgJ2ZyZWV6ZScsICdpc0Zyb3plbicKXSkoJ0RhdGUnLCBEYXRlLCBbJ25vdyddKTsKCk9iamVjdC5leHRlbmQgPSBleHRlbmQub3ZlcmxvYWRTZXR0ZXIoKTsKCkRhdGUuZXh0ZW5kKCdub3cnLCBmdW5jdGlvbigpewoJcmV0dXJuICsobmV3IERhdGUpOwp9KTsKCm5ldyBUeXBlKCdCb29sZWFuJywgQm9vbGVhbik7CgovLyBmaXhlcyBOYU4gcmV0dXJuaW5nIGFzIE51bWJlcgoKTnVtYmVyLnByb3RvdHlwZS4kZmFtaWx5ID0gZnVuY3Rpb24oKXsKCXJldHVybiBpc0Zpbml0ZSh0aGlzKSA/ICdudW1iZXInIDogJ251bGwnOwp9LmhpZGUoKTsKCi8vIE51bWJlci5yYW5kb20KCk51bWJlci5leHRlbmQoJ3JhbmRvbScsIGZ1bmN0aW9uKG1pbiwgbWF4KXsKCXJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkgKyBtaW4pOwp9KTsKCi8vIGZvckVhY2gsIGVhY2gKCnZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7Ck9iamVjdC5leHRlbmQoJ2ZvckVhY2gnLCBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSkgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5LCBvYmplY3QpOwoJfQp9KTsKCk9iamVjdC5lYWNoID0gT2JqZWN0LmZvckVhY2g7CgpBcnJheS5pbXBsZW1lbnQoewoKCWZvckVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKGkgaW4gdGhpcykgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9Cgl9LAoKCWVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlBcnJheS5mb3JFYWNoKHRoaXMsIGZuLCBiaW5kKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gQXJyYXkgJiBPYmplY3QgY2xvbmluZywgT2JqZWN0IG1lcmdpbmcgYW5kIGFwcGVuZGluZwoKdmFyIGNsb25lT2YgPSBmdW5jdGlvbihpdGVtKXsKCXN3aXRjaCAodHlwZU9mKGl0ZW0pKXsKCQljYXNlICdhcnJheSc6IHJldHVybiBpdGVtLmNsb25lKCk7CgkJY2FzZSAnb2JqZWN0JzogcmV0dXJuIE9iamVjdC5jbG9uZShpdGVtKTsKCQlkZWZhdWx0OiByZXR1cm4gaXRlbTsKCX0KfTsKCkFycmF5LmltcGxlbWVudCgnY2xvbmUnLCBmdW5jdGlvbigpewoJdmFyIGkgPSB0aGlzLmxlbmd0aCwgY2xvbmUgPSBuZXcgQXJyYXkoaSk7Cgl3aGlsZSAoaS0tKSBjbG9uZVtpXSA9IGNsb25lT2YodGhpc1tpXSk7CglyZXR1cm4gY2xvbmU7Cn0pOwoKdmFyIG1lcmdlT25lID0gZnVuY3Rpb24oc291cmNlLCBrZXksIGN1cnJlbnQpewoJc3dpdGNoICh0eXBlT2YoY3VycmVudCkpewoJCWNhc2UgJ29iamVjdCc6CgkJCWlmICh0eXBlT2Yoc291cmNlW2tleV0pID09ICdvYmplY3QnKSBPYmplY3QubWVyZ2Uoc291cmNlW2tleV0sIGN1cnJlbnQpOwoJCQllbHNlIHNvdXJjZVtrZXldID0gT2JqZWN0LmNsb25lKGN1cnJlbnQpOwoJCWJyZWFrOwoJCWNhc2UgJ2FycmF5Jzogc291cmNlW2tleV0gPSBjdXJyZW50LmNsb25lKCk7IGJyZWFrOwoJCWRlZmF1bHQ6IHNvdXJjZVtrZXldID0gY3VycmVudDsKCX0KCXJldHVybiBzb3VyY2U7Cn07CgpPYmplY3QuZXh0ZW5kKHsKCgltZXJnZTogZnVuY3Rpb24oc291cmNlLCBrLCB2KXsKCQlpZiAodHlwZU9mKGspID09ICdzdHJpbmcnKSByZXR1cm4gbWVyZ2VPbmUoc291cmNlLCBrLCB2KTsKCQlmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgb2JqZWN0ID0gYXJndW1lbnRzW2ldOwoJCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBtZXJnZU9uZShzb3VyY2UsIGtleSwgb2JqZWN0W2tleV0pOwoJCX0KCQlyZXR1cm4gc291cmNlOwoJfSwKCgljbG9uZTogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgY2xvbmUgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBjbG9uZVtrZXldID0gY2xvbmVPZihvYmplY3Rba2V5XSk7CgkJcmV0dXJuIGNsb25lOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKG9yaWdpbmFsKXsKCQlmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgZXh0ZW5kZWQgPSBhcmd1bWVudHNbaV0gfHwge307CgkJCWZvciAodmFyIGtleSBpbiBleHRlbmRlZCkgb3JpZ2luYWxba2V5XSA9IGV4dGVuZGVkW2tleV07CgkJfQoJCXJldHVybiBvcmlnaW5hbDsKCX0KCn0pOwoKLy8gT2JqZWN0LWxlc3MgdHlwZXMKClsnT2JqZWN0JywgJ1doaXRlU3BhY2UnLCAnVGV4dE5vZGUnLCAnQ29sbGVjdGlvbicsICdBcmd1bWVudHMnXS5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJbmV3IFR5cGUobmFtZSk7Cn0pOwoKLy8gVW5pcXVlIElECgp2YXIgVUlEID0gRGF0ZS5ub3coKTsKClN0cmluZy5leHRlbmQoJ3VuaXF1ZUlEJywgZnVuY3Rpb24oKXsKCXJldHVybiAoVUlEKyspLnRvU3RyaW5nKDM2KTsKfSk7CgovLzwxLjJjb21wYXQ+Cgp2YXIgSGFzaCA9IHRoaXMuSGFzaCA9IG5ldyBUeXBlKCdIYXNoJywgZnVuY3Rpb24ob2JqZWN0KXsKCWlmICh0eXBlT2Yob2JqZWN0KSA9PSAnaGFzaCcpIG9iamVjdCA9IE9iamVjdC5jbG9uZShvYmplY3QuZ2V0Q2xlYW4oKSk7Cglmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB0aGlzW2tleV0gPSBvYmplY3Rba2V5XTsKCXJldHVybiB0aGlzOwp9KTsKCkhhc2guaW1wbGVtZW50KHsKCglmb3JFYWNoOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJT2JqZWN0LmZvckVhY2godGhpcywgZm4sIGJpbmQpOwoJfSwKCglnZXRDbGVhbjogZnVuY3Rpb24oKXsKCQl2YXIgY2xlYW4gPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gdGhpcyl7CgkJCWlmICh0aGlzLmhhc093blByb3BlcnR5KGtleSkpIGNsZWFuW2tleV0gPSB0aGlzW2tleV07CgkJfQoJCXJldHVybiBjbGVhbjsKCX0sCgoJZ2V0TGVuZ3RoOiBmdW5jdGlvbigpewoJCXZhciBsZW5ndGggPSAwOwoJCWZvciAodmFyIGtleSBpbiB0aGlzKXsKCQkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgbGVuZ3RoKys7CgkJfQoJCXJldHVybiBsZW5ndGg7Cgl9Cgp9KTsKCkhhc2guYWxpYXMoJ2VhY2gnLCAnZm9yRWFjaCcpOwoKT2JqZWN0LnR5cGUgPSBUeXBlLmlzT2JqZWN0OwoKdmFyIE5hdGl2ZSA9IHRoaXMuTmF0aXZlID0gZnVuY3Rpb24ocHJvcGVydGllcyl7CglyZXR1cm4gbmV3IFR5cGUocHJvcGVydGllcy5uYW1lLCBwcm9wZXJ0aWVzLmluaXRpYWxpemUpOwp9OwoKTmF0aXZlLnR5cGUgPSBUeXBlLnR5cGU7CgpOYXRpdmUuaW1wbGVtZW50ID0gZnVuY3Rpb24ob2JqZWN0cywgbWV0aG9kcyl7Cglmb3IgKHZhciBpID0gMDsgaSA8IG9iamVjdHMubGVuZ3RoOyBpKyspIG9iamVjdHNbaV0uaW1wbGVtZW50KG1ldGhvZHMpOwoJcmV0dXJuIE5hdGl2ZTsKfTsKCnZhciBhcnJheVR5cGUgPSBBcnJheS50eXBlOwpBcnJheS50eXBlID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaW5zdGFuY2VPZihpdGVtLCBBcnJheSkgfHwgYXJyYXlUeXBlKGl0ZW0pOwp9OwoKdGhpcy4kQSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuIEFycmF5LmZyb20oaXRlbSkuc2xpY2UoKTsKfTsKCnRoaXMuJGFyZ3VtZW50cyA9IGZ1bmN0aW9uKGkpewoJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJcmV0dXJuIGFyZ3VtZW50c1tpXTsKCX07Cn07Cgp0aGlzLiRjaGsgPSBmdW5jdGlvbihvYmopewoJcmV0dXJuICEhKG9iaiB8fCBvYmogPT09IDApOwp9OwoKdGhpcy4kY2xlYXIgPSBmdW5jdGlvbih0aW1lcil7CgljbGVhclRpbWVvdXQodGltZXIpOwoJY2xlYXJJbnRlcnZhbCh0aW1lcik7CglyZXR1cm4gbnVsbDsKfTsKCnRoaXMuJGRlZmluZWQgPSBmdW5jdGlvbihvYmopewoJcmV0dXJuIChvYmogIT0gbnVsbCk7Cn07Cgp0aGlzLiRlYWNoID0gZnVuY3Rpb24oaXRlcmFibGUsIGZuLCBiaW5kKXsKCXZhciB0eXBlID0gdHlwZU9mKGl0ZXJhYmxlKTsKCSgodHlwZSA9PSAnYXJndW1lbnRzJyB8fCB0eXBlID09ICdjb2xsZWN0aW9uJyB8fCB0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnZWxlbWVudHMnKSA/IEFycmF5IDogT2JqZWN0KS5lYWNoKGl0ZXJhYmxlLCBmbiwgYmluZCk7Cn07Cgp0aGlzLiRlbXB0eSA9IGZ1bmN0aW9uKCl7fTsKCnRoaXMuJGV4dGVuZCA9IGZ1bmN0aW9uKG9yaWdpbmFsLCBleHRlbmRlZCl7CglyZXR1cm4gT2JqZWN0LmFwcGVuZChvcmlnaW5hbCwgZXh0ZW5kZWQpOwp9OwoKdGhpcy4kSCA9IGZ1bmN0aW9uKG9iamVjdCl7CglyZXR1cm4gbmV3IEhhc2gob2JqZWN0KTsKfTsKCnRoaXMuJG1lcmdlID0gZnVuY3Rpb24oKXsKCXZhciBhcmdzID0gQXJyYXkuc2xpY2UoYXJndW1lbnRzKTsKCWFyZ3MudW5zaGlmdCh7fSk7CglyZXR1cm4gT2JqZWN0Lm1lcmdlLmFwcGx5KG51bGwsIGFyZ3MpOwp9OwoKdGhpcy4kbGFtYmRhID0gRnVuY3Rpb24uZnJvbTsKdGhpcy4kbWl4aW4gPSBPYmplY3QubWVyZ2U7CnRoaXMuJHJhbmRvbSA9IE51bWJlci5yYW5kb207CnRoaXMuJHNwbGF0ID0gQXJyYXkuZnJvbTsKdGhpcy4kdGltZSA9IERhdGUubm93OwoKdGhpcy4kdHlwZSA9IGZ1bmN0aW9uKG9iamVjdCl7Cgl2YXIgdHlwZSA9IHR5cGVPZihvYmplY3QpOwoJaWYgKHR5cGUgPT0gJ2VsZW1lbnRzJykgcmV0dXJuICdhcnJheSc7CglyZXR1cm4gKHR5cGUgPT0gJ251bGwnKSA/IGZhbHNlIDogdHlwZTsKfTsKCnRoaXMuJHVubGluayA9IGZ1bmN0aW9uKG9iamVjdCl7Cglzd2l0Y2ggKHR5cGVPZihvYmplY3QpKXsKCQljYXNlICdvYmplY3QnOiByZXR1cm4gT2JqZWN0LmNsb25lKG9iamVjdCk7CgkJY2FzZSAnYXJyYXknOiByZXR1cm4gQXJyYXkuY2xvbmUob2JqZWN0KTsKCQljYXNlICdoYXNoJzogcmV0dXJuIG5ldyBIYXNoKG9iamVjdCk7CgkJZGVmYXVsdDogcmV0dXJuIG9iamVjdDsKCX0KfTsKCi8vPC8xLjJjb21wYXQ+Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogQXJyYXkKCmRlc2NyaXB0aW9uOiBDb250YWlucyBBcnJheSBQcm90b3R5cGVzIGxpa2UgZWFjaCwgY29udGFpbnMsIGFuZCBlcmFzZS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBBcnJheQoKLi4uCiovCgpBcnJheS5pbXBsZW1lbnQoewoKCS8qPCFFUzU+Ki8KCWV2ZXJ5OiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCA+Pj4gMDsgaSA8IGw7IGkrKyl7CgkJCWlmICgoaSBpbiB0aGlzKSAmJiAhZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJZmlsdGVyOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSBbXTsKCQlmb3IgKHZhciB2YWx1ZSwgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aCA+Pj4gMDsgaSA8IGw7IGkrKykgaWYgKGkgaW4gdGhpcyl7CgkJCXZhbHVlID0gdGhpc1tpXTsKCQkJaWYgKGZuLmNhbGwoYmluZCwgdmFsdWUsIGksIHRoaXMpKSByZXN1bHRzLnB1c2godmFsdWUpOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJaW5kZXhPZjogZnVuY3Rpb24oaXRlbSwgZnJvbSl7CgkJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoID4+PiAwOwoJCWZvciAodmFyIGkgPSAoZnJvbSA8IDApID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgZnJvbSkgOiBmcm9tIHx8IDA7IGkgPCBsZW5ndGg7IGkrKyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSByZXR1cm4gaTsKCQl9CgkJcmV0dXJuIC0xOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGggPj4+IDAsIHJlc3VsdHMgPSBBcnJheShsZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSByZXN1bHRzW2ldID0gZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoID4+PiAwOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiB0cnVlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoJLyo8LyFFUzU+Ki8KCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtICE9IG51bGw7CgkJfSk7Cgl9LAoKCWludm9rZTogZnVuY3Rpb24obWV0aG9kTmFtZSl7CgkJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpOwoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW1bbWV0aG9kTmFtZV0uYXBwbHkoaXRlbSwgYXJncyk7CgkJfSk7Cgl9LAoKCWFzc29jaWF0ZTogZnVuY3Rpb24oa2V5cyl7CgkJdmFyIG9iaiA9IHt9LCBsZW5ndGggPSBNYXRoLm1pbih0aGlzLmxlbmd0aCwga2V5cy5sZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIG9ialtrZXlzW2ldXSA9IHRoaXNbaV07CgkJcmV0dXJuIG9iajsKCX0sCgoJbGluazogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgcmVzdWx0ID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQkJaWYgKG9iamVjdFtrZXldKHRoaXNbaV0pKXsKCQkJCQlyZXN1bHRba2V5XSA9IHRoaXNbaV07CgkJCQkJZGVsZXRlIG9iamVjdFtrZXldOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQlyZXR1cm4gdGhpcy5pbmRleE9mKGl0ZW0sIGZyb20pICE9IC0xOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGFycmF5KXsKCQl0aGlzLnB1c2guYXBwbHkodGhpcywgYXJyYXkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1t0aGlzLmxlbmd0aCAtIDFdIDogbnVsbDsKCX0sCgoJZ2V0UmFuZG9tOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1tOdW1iZXIucmFuZG9tKDAsIHRoaXMubGVuZ3RoIC0gMSldIDogbnVsbDsKCX0sCgoJaW5jbHVkZTogZnVuY3Rpb24oaXRlbSl7CgkJaWYgKCF0aGlzLmNvbnRhaW5zKGl0ZW0pKSB0aGlzLnB1c2goaXRlbSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNvbWJpbmU6IGZ1bmN0aW9uKGFycmF5KXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5pbmNsdWRlKGFycmF5W2ldKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGl0ZW0pewoJCWZvciAodmFyIGkgPSB0aGlzLmxlbmd0aDsgaS0tOyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSB0aGlzLnNwbGljZShpLCAxKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXRoaXMubGVuZ3RoID0gMDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmxhdHRlbjogZnVuY3Rpb24oKXsKCQl2YXIgYXJyYXkgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIHR5cGUgPSB0eXBlT2YodGhpc1tpXSk7CgkJCWlmICh0eXBlID09ICdudWxsJykgY29udGludWU7CgkJCWFycmF5ID0gYXJyYXkuY29uY2F0KCh0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnY29sbGVjdGlvbicgfHwgdHlwZSA9PSAnYXJndW1lbnRzJyB8fCBpbnN0YW5jZU9mKHRoaXNbaV0sIEFycmF5KSkgPyBBcnJheS5mbGF0dGVuKHRoaXNbaV0pIDogdGhpc1tpXSk7CgkJfQoJCXJldHVybiBhcnJheTsKCX0sCgoJcGljazogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gIT0gbnVsbCkgcmV0dXJuIHRoaXNbaV07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCAhPSAzKSByZXR1cm4gbnVsbDsKCQl2YXIgcmdiID0gdGhpcy5tYXAoZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubGVuZ3RoID09IDEpIHZhbHVlICs9IHZhbHVlOwoJCQlyZXR1cm4gdmFsdWUudG9JbnQoMTYpOwoJCX0pOwoJCXJldHVybiAoYXJyYXkpID8gcmdiIDogJ3JnYignICsgcmdiICsgJyknOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCA8IDMpIHJldHVybiBudWxsOwoJCWlmICh0aGlzLmxlbmd0aCA9PSA0ICYmIHRoaXNbM10gPT0gMCAmJiAhYXJyYXkpIHJldHVybiAndHJhbnNwYXJlbnQnOwoJCXZhciBoZXggPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKyl7CgkJCXZhciBiaXQgPSAodGhpc1tpXSAtIDApLnRvU3RyaW5nKDE2KTsKCQkJaGV4LnB1c2goKGJpdC5sZW5ndGggPT0gMSkgPyAnMCcgKyBiaXQgOiBiaXQpOwoJCX0KCQlyZXR1cm4gKGFycmF5KSA/IGhleCA6ICcjJyArIGhleC5qb2luKCcnKTsKCX0KCn0pOwoKLy88MS4yY29tcGF0PgoKQXJyYXkuYWxpYXMoJ2V4dGVuZCcsICdhcHBlbmQnKTsKCnZhciAkcGljayA9IGZ1bmN0aW9uKCl7CglyZXR1cm4gQXJyYXkuZnJvbShhcmd1bWVudHMpLnBpY2soKTsKfTsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBTdHJpbmcKCmRlc2NyaXB0aW9uOiBDb250YWlucyBTdHJpbmcgUHJvdG90eXBlcyBsaWtlIGNhbWVsQ2FzZSwgY2FwaXRhbGl6ZSwgdGVzdCwgYW5kIHRvSW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IFN0cmluZwoKLi4uCiovCgpTdHJpbmcuaW1wbGVtZW50KHsKCgl0ZXN0OiBmdW5jdGlvbihyZWdleCwgcGFyYW1zKXsKCQlyZXR1cm4gKCh0eXBlT2YocmVnZXgpID09ICdyZWdleHAnKSA/IHJlZ2V4IDogbmV3IFJlZ0V4cCgnJyArIHJlZ2V4LCBwYXJhbXMpKS50ZXN0KHRoaXMpOwoJfSwKCgljb250YWluczogZnVuY3Rpb24oc3RyaW5nLCBzZXBhcmF0b3IpewoJCXJldHVybiAoc2VwYXJhdG9yKSA/IChzZXBhcmF0b3IgKyB0aGlzICsgc2VwYXJhdG9yKS5pbmRleE9mKHNlcGFyYXRvciArIHN0cmluZyArIHNlcGFyYXRvcikgPiAtMSA6IFN0cmluZyh0aGlzKS5pbmRleE9mKHN0cmluZykgPiAtMTsKCX0sCgoJdHJpbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJyk7Cgl9LAoKCWNsZWFuOiBmdW5jdGlvbigpewoJCXJldHVybiBTdHJpbmcodGhpcykucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwoJfSwKCgljYW1lbENhc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIFN0cmluZyh0aGlzKS5yZXBsYWNlKC8tXEQvZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2guY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWh5cGhlbmF0ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuICgnLScgKyBtYXRjaC5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSk7CgkJfSk7Cgl9LAoKCWNhcGl0YWxpemU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIFN0cmluZyh0aGlzKS5yZXBsYWNlKC9cYlthLXpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWVzY2FwZVJlZ0V4cDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UoLyhbLS4qKz9eJHt9KCl8W1xdXC9cXF0pL2csICdcXCQxJyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCWhleFRvUmdiOiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIGhleCA9IFN0cmluZyh0aGlzKS5tYXRjaCgvXiM/KFx3ezEsMn0pKFx3ezEsMn0pKFx3ezEsMn0pJC8pOwoJCXJldHVybiAoaGV4KSA/IGhleC5zbGljZSgxKS5oZXhUb1JnYihhcnJheSkgOiBudWxsOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCXZhciByZ2IgPSBTdHJpbmcodGhpcykubWF0Y2goL1xkezEsM30vZyk7CgkJcmV0dXJuIChyZ2IpID8gcmdiLnJnYlRvSGV4KGFycmF5KSA6IG51bGw7Cgl9LAoKCXN1YnN0aXR1dGU6IGZ1bmN0aW9uKG9iamVjdCwgcmVnZXhwKXsKCQlyZXR1cm4gU3RyaW5nKHRoaXMpLnJlcGxhY2UocmVnZXhwIHx8ICgvXFw/XHsoW157fV0rKVx9L2cpLCBmdW5jdGlvbihtYXRjaCwgbmFtZSl7CgkJCWlmIChtYXRjaC5jaGFyQXQoMCkgPT0gJ1xcJykgcmV0dXJuIG1hdGNoLnNsaWNlKDEpOwoJCQlyZXR1cm4gKG9iamVjdFtuYW1lXSAhPSBudWxsKSA/IG9iamVjdFtuYW1lXSA6ICcnOwoJCX0pOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBOdW1iZXIKCmRlc2NyaXB0aW9uOiBDb250YWlucyBOdW1iZXIgUHJvdG90eXBlcyBsaWtlIGxpbWl0LCByb3VuZCwgdGltZXMsIGFuZCBjZWlsLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IE51bWJlcgoKLi4uCiovCgpOdW1iZXIuaW1wbGVtZW50KHsKCglsaW1pdDogZnVuY3Rpb24obWluLCBtYXgpewoJCXJldHVybiBNYXRoLm1pbihtYXgsIE1hdGgubWF4KG1pbiwgdGhpcykpOwoJfSwKCglyb3VuZDogZnVuY3Rpb24ocHJlY2lzaW9uKXsKCQlwcmVjaXNpb24gPSBNYXRoLnBvdygxMCwgcHJlY2lzaW9uIHx8IDApLnRvRml4ZWQocHJlY2lzaW9uIDwgMCA/IC1wcmVjaXNpb24gOiAwKTsKCQlyZXR1cm4gTWF0aC5yb3VuZCh0aGlzICogcHJlY2lzaW9uKSAvIHByZWNpc2lvbjsKCX0sCgoJdGltZXM6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXM7IGkrKykgZm4uY2FsbChiaW5kLCBpLCB0aGlzKTsKCX0sCgoJdG9GbG9hdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gcGFyc2VGbG9hdCh0aGlzKTsKCX0sCgoJdG9JbnQ6IGZ1bmN0aW9uKGJhc2UpewoJCXJldHVybiBwYXJzZUludCh0aGlzLCBiYXNlIHx8IDEwKTsKCX0KCn0pOwoKTnVtYmVyLmFsaWFzKCdlYWNoJywgJ3RpbWVzJyk7CgooZnVuY3Rpb24obWF0aCl7Cgl2YXIgbWV0aG9kcyA9IHt9OwoJbWF0aC5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJCWlmICghTnVtYmVyW25hbWVdKSBtZXRob2RzW25hbWVdID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIE1hdGhbbmFtZV0uYXBwbHkobnVsbCwgW3RoaXNdLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQl9OwoJfSk7CglOdW1iZXIuaW1wbGVtZW50KG1ldGhvZHMpOwp9KShbJ2FicycsICdhY29zJywgJ2FzaW4nLCAnYXRhbicsICdhdGFuMicsICdjZWlsJywgJ2NvcycsICdleHAnLCAnZmxvb3InLCAnbG9nJywgJ21heCcsICdtaW4nLCAncG93JywgJ3NpbicsICdzcXJ0JywgJ3RhbiddKTsKCgovKgotLS0KCm5hbWU6IEZ1bmN0aW9uCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRnVuY3Rpb24gUHJvdG90eXBlcyBsaWtlIGNyZWF0ZSwgYmluZCwgcGFzcywgYW5kIGRlbGF5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEZ1bmN0aW9uCgouLi4KKi8KCkZ1bmN0aW9uLmV4dGVuZCh7CgoJYXR0ZW1wdDogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl0cnkgewoJCQkJcmV0dXJuIGFyZ3VtZW50c1tpXSgpOwoJCQl9IGNhdGNoIChlKXt9CgkJfQoJCXJldHVybiBudWxsOwoJfQoKfSk7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLmFwcGx5KGJpbmQsIEFycmF5LmZyb20oYXJncykpOwoJCX0gY2F0Y2ggKGUpe30KCgkJcmV0dXJuIG51bGw7Cgl9LAoKCS8qPCFFUzUtYmluZD4qLwoJYmluZDogZnVuY3Rpb24odGhhdCl7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlhcmdzID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbCwKCQkJRiA9IGZ1bmN0aW9uKCl7fTsKCgkJdmFyIGJvdW5kID0gZnVuY3Rpb24oKXsKCQkJdmFyIGNvbnRleHQgPSB0aGF0LCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwoJCQlpZiAodGhpcyBpbnN0YW5jZW9mIGJvdW5kKXsKCQkJCUYucHJvdG90eXBlID0gc2VsZi5wcm90b3R5cGU7CgkJCQljb250ZXh0ID0gbmV3IEY7CgkJCX0KCQkJdmFyIHJlc3VsdCA9ICghYXJncyAmJiAhbGVuZ3RoKQoJCQkJPyBzZWxmLmNhbGwoY29udGV4dCkKCQkJCTogc2VsZi5hcHBseShjb250ZXh0LCBhcmdzICYmIGxlbmd0aCA/IGFyZ3MuY29uY2F0KEFycmF5LnNsaWNlKGFyZ3VtZW50cykpIDogYXJncyB8fCBhcmd1bWVudHMpOwoJCQlyZXR1cm4gY29udGV4dCA9PSB0aGF0ID8gcmVzdWx0IDogY29udGV4dDsKCQl9OwoJCXJldHVybiBib3VuZDsKCX0sCgkvKjwvIUVTNS1iaW5kPiovCgoJcGFzczogZnVuY3Rpb24oYXJncywgYmluZCl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbigpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzIHx8IGFyZ3VtZW50cyk7CgkJfTsKCX0sCgoJZGVsYXk6IGZ1bmN0aW9uKGRlbGF5LCBiaW5kLCBhcmdzKXsKCQlyZXR1cm4gc2V0VGltZW91dCh0aGlzLnBhc3MoKGFyZ3MgPT0gbnVsbCA/IFtdIDogYXJncyksIGJpbmQpLCBkZWxheSk7Cgl9LAoKCXBlcmlvZGljYWw6IGZ1bmN0aW9uKHBlcmlvZGljYWwsIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRJbnRlcnZhbCh0aGlzLnBhc3MoKGFyZ3MgPT0gbnVsbCA/IFtdIDogYXJncyksIGJpbmQpLCBwZXJpb2RpY2FsKTsKCX0KCn0pOwoKLy88MS4yY29tcGF0PgoKZGVsZXRlIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kOwoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCgljcmVhdGU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXZhciBzZWxmID0gdGhpczsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlyZXR1cm4gZnVuY3Rpb24oZXZlbnQpewoJCQl2YXIgYXJncyA9IG9wdGlvbnMuYXJndW1lbnRzOwoJCQlhcmdzID0gKGFyZ3MgIT0gbnVsbCkgPyBBcnJheS5mcm9tKGFyZ3MpIDogQXJyYXkuc2xpY2UoYXJndW1lbnRzLCAob3B0aW9ucy5ldmVudCkgPyAxIDogMCk7CgkJCWlmIChvcHRpb25zLmV2ZW50KSBhcmdzID0gW2V2ZW50IHx8IHdpbmRvdy5ldmVudF0uZXh0ZW5kKGFyZ3MpOwoJCQl2YXIgcmV0dXJucyA9IGZ1bmN0aW9uKCl7CgkJCQlyZXR1cm4gc2VsZi5hcHBseShvcHRpb25zLmJpbmQgfHwgbnVsbCwgYXJncyk7CgkJCX07CgkJCWlmIChvcHRpb25zLmRlbGF5KSByZXR1cm4gc2V0VGltZW91dChyZXR1cm5zLCBvcHRpb25zLmRlbGF5KTsKCQkJaWYgKG9wdGlvbnMucGVyaW9kaWNhbCkgcmV0dXJuIHNldEludGVydmFsKHJldHVybnMsIG9wdGlvbnMucGVyaW9kaWNhbCk7CgkJCWlmIChvcHRpb25zLmF0dGVtcHQpIHJldHVybiBGdW5jdGlvbi5hdHRlbXB0KHJldHVybnMpOwoJCQlyZXR1cm4gcmV0dXJucygpOwoJCX07Cgl9LAoKCWJpbmQ6IGZ1bmN0aW9uKGJpbmQsIGFyZ3MpewoJCXZhciBzZWxmID0gdGhpczsKCQlpZiAoYXJncyAhPSBudWxsKSBhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncyB8fCBhcmd1bWVudHMpOwoJCX07Cgl9LAoKCWJpbmRXaXRoRXZlbnQ6IGZ1bmN0aW9uKGJpbmQsIGFyZ3MpewoJCXZhciBzZWxmID0gdGhpczsKCQlpZiAoYXJncyAhPSBudWxsKSBhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlyZXR1cm4gZnVuY3Rpb24oZXZlbnQpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCAoYXJncyA9PSBudWxsKSA/IGFyZ3VtZW50cyA6IFtldmVudF0uY29uY2F0KGFyZ3MpKTsKCQl9OwoJfSwKCglydW46IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXJldHVybiB0aGlzLmFwcGx5KGJpbmQsIEFycmF5LmZyb20oYXJncykpOwoJfQoKfSk7CgppZiAoT2JqZWN0LmNyZWF0ZSA9PSBGdW5jdGlvbi5wcm90b3R5cGUuY3JlYXRlKSBPYmplY3QuY3JlYXRlID0gbnVsbDsKCnZhciAkdHJ5ID0gRnVuY3Rpb24uYXR0ZW1wdDsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBPYmplY3QKCmRlc2NyaXB0aW9uOiBPYmplY3QgZ2VuZXJpYyBtZXRob2RzCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogW09iamVjdCwgSGFzaF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwoKT2JqZWN0LmV4dGVuZCh7CgoJc3Vic2V0OiBmdW5jdGlvbihvYmplY3QsIGtleXMpewoJCXZhciByZXN1bHRzID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBrID0ga2V5c1tpXTsKCQkJaWYgKGsgaW4gb2JqZWN0KSByZXN1bHRzW2tdID0gb2JqZWN0W2tdOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJbWFwOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHJlc3VsdHNba2V5XSA9IGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSAmJiBmbi5jYWxsKGJpbmQsIHZhbHVlLCBrZXksIG9iamVjdCkpIHJlc3VsdHNba2V5XSA9IHZhbHVlOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgIWZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSkpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIga2V5cyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIGtleXMucHVzaChrZXkpOwoJCX0KCQlyZXR1cm4ga2V5czsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB2YWx1ZXMucHVzaChvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiB2YWx1ZXM7Cgl9LAoKCWdldExlbmd0aDogZnVuY3Rpb24ob2JqZWN0KXsKCQlyZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGg7Cgl9LAoKCWtleU9mOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpICYmIG9iamVjdFtrZXldID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKG9iamVjdCwgdmFsdWUpICE9IG51bGw7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChiYXNlKSBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nOwoJCQl2YXIgcmVzdWx0OwoJCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQkJY2FzZSAnb2JqZWN0JzogcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSk7IGJyZWFrOwoJCQkJY2FzZSAnYXJyYXknOgoJCQkJCXZhciBxcyA9IHt9OwoJCQkJCXZhbHVlLmVhY2goZnVuY3Rpb24odmFsLCBpKXsKCQkJCQkJcXNbaV0gPSB2YWw7CgkJCQkJfSk7CgkJCQkJcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcocXMsIGtleSk7CgkJCQlicmVhazsKCQkJCWRlZmF1bHQ6IHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCX0KCQkJaWYgKHZhbHVlICE9IG51bGwpIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KTsKCQl9KTsKCgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKfSkoKTsKCi8vPDEuMmNvbXBhdD4KCkhhc2guaW1wbGVtZW50KHsKCgloYXM6IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCgoJa2V5T2Y6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKHRoaXMsIHZhbHVlKTsKCX0sCgoJaGFzVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmNvbnRhaW5zKHRoaXMsIHZhbHVlKTsKCX0sCgoJZXh0ZW5kOiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlIYXNoLmVhY2gocHJvcGVydGllcyB8fCB7fSwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCUhhc2guc2V0KHRoaXMsIGtleSwgdmFsdWUpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21iaW5lOiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlIYXNoLmVhY2gocHJvcGVydGllcyB8fCB7fSwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCUhhc2guaW5jbHVkZSh0aGlzLCBrZXksIHZhbHVlKTsKCQl9LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGtleSl7CgkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgZGVsZXRlIHRoaXNba2V5XTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbihrZXkpewoJCXJldHVybiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSA/IHRoaXNba2V5XSA6IG51bGw7Cgl9LAoKCXNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSl7CgkJaWYgKCF0aGlzW2tleV0gfHwgdGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB0aGlzW2tleV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJSGFzaC5lYWNoKHRoaXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQlkZWxldGUgdGhpc1trZXldOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmNsdWRlOiBmdW5jdGlvbihrZXksIHZhbHVlKXsKCQlpZiAodGhpc1trZXldID09IG51bGwpIHRoaXNba2V5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gbmV3IEhhc2goT2JqZWN0Lm1hcCh0aGlzLCBmbiwgYmluZCkpOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gbmV3IEhhc2goT2JqZWN0LmZpbHRlcih0aGlzLCBmbiwgYmluZCkpOwoJfSwKCglldmVyeTogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXJldHVybiBPYmplY3QuZXZlcnkodGhpcywgZm4sIGJpbmQpOwoJfSwKCglzb21lOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJcmV0dXJuIE9iamVjdC5zb21lKHRoaXMsIGZuLCBiaW5kKTsKCX0sCgoJZ2V0S2V5czogZnVuY3Rpb24oKXsKCQlyZXR1cm4gT2JqZWN0LmtleXModGhpcyk7Cgl9LAoKCWdldFZhbHVlczogZnVuY3Rpb24oKXsKCQlyZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzKTsKCX0sCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24oYmFzZSl7CgkJcmV0dXJuIE9iamVjdC50b1F1ZXJ5U3RyaW5nKHRoaXMsIGJhc2UpOwoJfQoKfSk7CgpIYXNoLmV4dGVuZCA9IE9iamVjdC5hcHBlbmQ7CgpIYXNoLmFsaWFzKHtpbmRleE9mOiAna2V5T2YnLCBjb250YWluczogJ2hhc1ZhbHVlJ30pOwoKLy88LzEuMmNvbXBhdD4KCgovKgotLS0KCm5hbWU6IEJyb3dzZXIKCmRlc2NyaXB0aW9uOiBUaGUgQnJvd3NlciBPYmplY3QuIENvbnRhaW5zIEJyb3dzZXIgaW5pdGlhbGl6YXRpb24sIFdpbmRvdyBhbmQgRG9jdW1lbnQsIGFuZCB0aGUgQnJvd3NlciBIYXNoLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0FycmF5LCBGdW5jdGlvbiwgTnVtYmVyLCBTdHJpbmddCgpwcm92aWRlczogW0Jyb3dzZXIsIFdpbmRvdywgRG9jdW1lbnRdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGRvY3VtZW50ID0gdGhpcy5kb2N1bWVudDsKdmFyIHdpbmRvdyA9IGRvY3VtZW50LndpbmRvdyA9IHRoaXM7Cgp2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCksCglwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybS50b0xvd2VyQ2FzZSgpLAoJVUEgPSB1YS5tYXRjaCgvKG9wZXJhfGllfGZpcmVmb3h8Y2hyb21lfHZlcnNpb24pW1xzXC86XShbXHdcZFwuXSspPy4qPyhzYWZhcml8dmVyc2lvbltcc1wvOl0oW1x3XGRcLl0rKXwkKS8pIHx8IFtudWxsLCAndW5rbm93bicsIDBdLAoJbW9kZSA9IFVBWzFdID09ICdpZScgJiYgZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwoKdmFyIEJyb3dzZXIgPSB0aGlzLkJyb3dzZXIgPSB7CgoJZXh0ZW5kOiBGdW5jdGlvbi5wcm90b3R5cGUuZXh0ZW5kLAoKCW5hbWU6IChVQVsxXSA9PSAndmVyc2lvbicpID8gVUFbM10gOiBVQVsxXSwKCgl2ZXJzaW9uOiBtb2RlIHx8IHBhcnNlRmxvYXQoKFVBWzFdID09ICdvcGVyYScgJiYgVUFbNF0pID8gVUFbNF0gOiBVQVsyXSksCgoJUGxhdGZvcm06IHsKCQluYW1lOiB1YS5tYXRjaCgvaXAoPzphZHxvZHxob25lKS8pID8gJ2lvcycgOiAodWEubWF0Y2goLyg/OndlYm9zfGFuZHJvaWQpLykgfHwgcGxhdGZvcm0ubWF0Y2goL21hY3x3aW58bGludXgvKSB8fCBbJ290aGVyJ10pWzBdCgl9LAoKCUZlYXR1cmVzOiB7CgkJeHBhdGg6ICEhKGRvY3VtZW50LmV2YWx1YXRlKSwKCQlhaXI6ICEhKHdpbmRvdy5ydW50aW1lKSwKCQlxdWVyeTogISEoZG9jdW1lbnQucXVlcnlTZWxlY3RvciksCgkJanNvbjogISEod2luZG93LkpTT04pCgl9LAoKCVBsdWdpbnM6IHt9Cgp9OwoKQnJvd3NlcltCcm93c2VyLm5hbWVdID0gdHJ1ZTsKQnJvd3NlcltCcm93c2VyLm5hbWUgKyBwYXJzZUludChCcm93c2VyLnZlcnNpb24sIDEwKV0gPSB0cnVlOwpCcm93c2VyLlBsYXRmb3JtW0Jyb3dzZXIuUGxhdGZvcm0ubmFtZV0gPSB0cnVlOwoKLy8gUmVxdWVzdAoKQnJvd3Nlci5SZXF1ZXN0ID0gKGZ1bmN0aW9uKCl7CgoJdmFyIFhNTEhUVFAgPSBmdW5jdGlvbigpewoJCXJldHVybiBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCX07CgoJdmFyIE1TWE1MMiA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNU1hNTDIuWE1MSFRUUCcpOwoJfTsKCgl2YXIgTVNYTUwgPSBmdW5jdGlvbigpewoJCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTWljcm9zb2Z0LlhNTEhUVFAnKTsKCX07CgoJcmV0dXJuIEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCQlYTUxIVFRQKCk7CgkJcmV0dXJuIFhNTEhUVFA7Cgl9LCBmdW5jdGlvbigpewoJCU1TWE1MMigpOwoJCXJldHVybiBNU1hNTDI7Cgl9LCBmdW5jdGlvbigpewoJCU1TWE1MKCk7CgkJcmV0dXJuIE1TWE1MOwoJfSk7Cgp9KSgpOwoKQnJvd3Nlci5GZWF0dXJlcy54aHIgPSAhIShCcm93c2VyLlJlcXVlc3QpOwoKLy8gRmxhc2ggZGV0ZWN0aW9uCgp2YXIgdmVyc2lvbiA9IChGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CglyZXR1cm4gbmF2aWdhdG9yLnBsdWdpbnNbJ1Nob2Nrd2F2ZSBGbGFzaCddLmRlc2NyaXB0aW9uOwp9LCBmdW5jdGlvbigpewoJcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdTaG9ja3dhdmVGbGFzaC5TaG9ja3dhdmVGbGFzaCcpLkdldFZhcmlhYmxlKCckdmVyc2lvbicpOwp9KSB8fCAnMCByMCcpLm1hdGNoKC9cZCsvZyk7CgpCcm93c2VyLlBsdWdpbnMuRmxhc2ggPSB7Cgl2ZXJzaW9uOiBOdW1iZXIodmVyc2lvblswXSB8fCAnMC4nICsgdmVyc2lvblsxXSkgfHwgMCwKCWJ1aWxkOiBOdW1iZXIodmVyc2lvblsyXSkgfHwgMAp9OwoKLy8gU3RyaW5nIHNjcmlwdHMKCkJyb3dzZXIuZXhlYyA9IGZ1bmN0aW9uKHRleHQpewoJaWYgKCF0ZXh0KSByZXR1cm4gdGV4dDsKCWlmICh3aW5kb3cuZXhlY1NjcmlwdCl7CgkJd2luZG93LmV4ZWNTY3JpcHQodGV4dCk7Cgl9IGVsc2UgewoJCXZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQlzY3JpcHQuc2V0QXR0cmlidXRlKCd0eXBlJywgJ3RleHQvamF2YXNjcmlwdCcpOwoJCXNjcmlwdC50ZXh0ID0gdGV4dDsKCQlkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJZG9jdW1lbnQuaGVhZC5yZW1vdmVDaGlsZChzY3JpcHQpOwoJfQoJcmV0dXJuIHRleHQ7Cn07CgpTdHJpbmcuaW1wbGVtZW50KCdzdHJpcFNjcmlwdHMnLCBmdW5jdGlvbihleGVjKXsKCXZhciBzY3JpcHRzID0gJyc7Cgl2YXIgdGV4dCA9IHRoaXMucmVwbGFjZSgvPHNjcmlwdFtePl0qPihbXHNcU10qPyk8XC9zY3JpcHQ+L2dpLCBmdW5jdGlvbihhbGwsIGNvZGUpewoJCXNjcmlwdHMgKz0gY29kZSArICdcbic7CgkJcmV0dXJuICcnOwoJfSk7CglpZiAoZXhlYyA9PT0gdHJ1ZSkgQnJvd3Nlci5leGVjKHNjcmlwdHMpOwoJZWxzZSBpZiAodHlwZU9mKGV4ZWMpID09ICdmdW5jdGlvbicpIGV4ZWMoc2NyaXB0cywgdGV4dCk7CglyZXR1cm4gdGV4dDsKfSk7CgovLyBXaW5kb3csIERvY3VtZW50CgpCcm93c2VyLmV4dGVuZCh7CglEb2N1bWVudDogdGhpcy5Eb2N1bWVudCwKCVdpbmRvdzogdGhpcy5XaW5kb3csCglFbGVtZW50OiB0aGlzLkVsZW1lbnQsCglFdmVudDogdGhpcy5FdmVudAp9KTsKCnRoaXMuV2luZG93ID0gdGhpcy4kY29uc3RydWN0b3IgPSBuZXcgVHlwZSgnV2luZG93JywgZnVuY3Rpb24oKXt9KTsKCnRoaXMuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ3dpbmRvdycpLmhpZGUoKTsKCldpbmRvdy5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCXdpbmRvd1tuYW1lXSA9IG1ldGhvZDsKfSk7Cgp0aGlzLkRvY3VtZW50ID0gZG9jdW1lbnQuJGNvbnN0cnVjdG9yID0gbmV3IFR5cGUoJ0RvY3VtZW50JywgZnVuY3Rpb24oKXt9KTsKCmRvY3VtZW50LiRmYW1pbHkgPSBGdW5jdGlvbi5mcm9tKCdkb2N1bWVudCcpLmhpZGUoKTsKCkRvY3VtZW50Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJZG9jdW1lbnRbbmFtZV0gPSBtZXRob2Q7Cn0pOwoKZG9jdW1lbnQuaHRtbCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKaWYgKCFkb2N1bWVudC5oZWFkKSBkb2N1bWVudC5oZWFkID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXTsKCmlmIChkb2N1bWVudC5leGVjQ29tbWFuZCkgdHJ5IHsKCWRvY3VtZW50LmV4ZWNDb21tYW5kKCJCYWNrZ3JvdW5kSW1hZ2VDYWNoZSIsIGZhbHNlLCB0cnVlKTsKfSBjYXRjaCAoZSl7fQoKLyo8bHRJRTk+Ki8KaWYgKHRoaXMuYXR0YWNoRXZlbnQgJiYgIXRoaXMuYWRkRXZlbnRMaXN0ZW5lcil7Cgl2YXIgdW5sb2FkRXZlbnQgPSBmdW5jdGlvbigpewoJCXRoaXMuZGV0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwoJCWRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5odG1sID0gZG9jdW1lbnQud2luZG93ID0gbnVsbDsKCX07Cgl0aGlzLmF0dGFjaEV2ZW50KCdvbnVubG9hZCcsIHVubG9hZEV2ZW50KTsKfQoKLy8gSUUgZmFpbHMgb24gY29sbGVjdGlvbnMgYW5kIDxzZWxlY3Q+Lm9wdGlvbnMgKHJlZmVycyB0byA8c2VsZWN0PikKdmFyIGFycmF5RnJvbSA9IEFycmF5LmZyb207CnRyeSB7CglhcnJheUZyb20oZG9jdW1lbnQuaHRtbC5jaGlsZE5vZGVzKTsKfSBjYXRjaChlKXsKCUFycmF5LmZyb20gPSBmdW5jdGlvbihpdGVtKXsKCQlpZiAodHlwZW9mIGl0ZW0gIT0gJ3N0cmluZycgJiYgVHlwZS5pc0VudW1lcmFibGUoaXRlbSkgJiYgdHlwZU9mKGl0ZW0pICE9ICdhcnJheScpewoJCQl2YXIgaSA9IGl0ZW0ubGVuZ3RoLCBhcnJheSA9IG5ldyBBcnJheShpKTsKCQkJd2hpbGUgKGktLSkgYXJyYXlbaV0gPSBpdGVtW2ldOwoJCQlyZXR1cm4gYXJyYXk7CgkJfQoJCXJldHVybiBhcnJheUZyb20oaXRlbSk7Cgl9OwoKCXZhciBwcm90b3R5cGUgPSBBcnJheS5wcm90b3R5cGUsCgkJc2xpY2UgPSBwcm90b3R5cGUuc2xpY2U7CglbJ3BvcCcsICdwdXNoJywgJ3JldmVyc2UnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCcsICdjb25jYXQnLCAnam9pbicsICdzbGljZSddLmVhY2goZnVuY3Rpb24obmFtZSl7CgkJdmFyIG1ldGhvZCA9IHByb3RvdHlwZVtuYW1lXTsKCQlBcnJheVtuYW1lXSA9IGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gbWV0aG9kLmFwcGx5KEFycmF5LmZyb20oaXRlbSksIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CgkJfTsKCX0pOwp9Ci8qPC9sdElFOT4qLwoKLy88MS4yY29tcGF0PgoKaWYgKEJyb3dzZXIuUGxhdGZvcm0uaW9zKSBCcm93c2VyLlBsYXRmb3JtLmlwb2QgPSB0cnVlOwoKQnJvd3Nlci5FbmdpbmUgPSB7fTsKCnZhciBzZXRFbmdpbmUgPSBmdW5jdGlvbihuYW1lLCB2ZXJzaW9uKXsKCUJyb3dzZXIuRW5naW5lLm5hbWUgPSBuYW1lOwoJQnJvd3Nlci5FbmdpbmVbbmFtZSArIHZlcnNpb25dID0gdHJ1ZTsKCUJyb3dzZXIuRW5naW5lLnZlcnNpb24gPSB2ZXJzaW9uOwp9OwoKaWYgKEJyb3dzZXIuaWUpewoJQnJvd3Nlci5FbmdpbmUudHJpZGVudCA9IHRydWU7CgoJc3dpdGNoIChCcm93c2VyLnZlcnNpb24pewoJCWNhc2UgNjogc2V0RW5naW5lKCd0cmlkZW50JywgNCk7IGJyZWFrOwoJCWNhc2UgNzogc2V0RW5naW5lKCd0cmlkZW50JywgNSk7IGJyZWFrOwoJCWNhc2UgODogc2V0RW5naW5lKCd0cmlkZW50JywgNik7Cgl9Cn0KCmlmIChCcm93c2VyLmZpcmVmb3gpewoJQnJvd3Nlci5FbmdpbmUuZ2Vja28gPSB0cnVlOwoKCWlmIChCcm93c2VyLnZlcnNpb24gPj0gMykgc2V0RW5naW5lKCdnZWNrbycsIDE5KTsKCWVsc2Ugc2V0RW5naW5lKCdnZWNrbycsIDE4KTsKfQoKaWYgKEJyb3dzZXIuc2FmYXJpIHx8IEJyb3dzZXIuY2hyb21lKXsKCUJyb3dzZXIuRW5naW5lLndlYmtpdCA9IHRydWU7CgoJc3dpdGNoIChCcm93c2VyLnZlcnNpb24pewoJCWNhc2UgMjogc2V0RW5naW5lKCd3ZWJraXQnLCA0MTkpOyBicmVhazsKCQljYXNlIDM6IHNldEVuZ2luZSgnd2Via2l0JywgNDIwKTsgYnJlYWs7CgkJY2FzZSA0OiBzZXRFbmdpbmUoJ3dlYmtpdCcsIDUyNSk7Cgl9Cn0KCmlmIChCcm93c2VyLm9wZXJhKXsKCUJyb3dzZXIuRW5naW5lLnByZXN0byA9IHRydWU7CgoJaWYgKEJyb3dzZXIudmVyc2lvbiA+PSA5LjYpIHNldEVuZ2luZSgncHJlc3RvJywgOTYwKTsKCWVsc2UgaWYgKEJyb3dzZXIudmVyc2lvbiA+PSA5LjUpIHNldEVuZ2luZSgncHJlc3RvJywgOTUwKTsKCWVsc2Ugc2V0RW5naW5lKCdwcmVzdG8nLCA5MjUpOwp9CgppZiAoQnJvd3Nlci5uYW1lID09ICd1bmtub3duJyl7Cglzd2l0Y2ggKCh1YS5tYXRjaCgvKD86d2Via2l0fGtodG1sfGdlY2tvKS8pIHx8IFtdKVswXSl7CgkJY2FzZSAnd2Via2l0JzoKCQljYXNlICdraHRtbCc6CgkJCUJyb3dzZXIuRW5naW5lLndlYmtpdCA9IHRydWU7CgkJYnJlYWs7CgkJY2FzZSAnZ2Vja28nOgoJCQlCcm93c2VyLkVuZ2luZS5nZWNrbyA9IHRydWU7Cgl9Cn0KCnRoaXMuJGV4ZWMgPSBCcm93c2VyLmV4ZWM7CgovLzwvMS4yY29tcGF0PgoKfSkoKTsKCgovKgotLS0KCm5hbWU6IEV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIEV2ZW50IFR5cGUsIHRvIG1ha2UgdGhlIGV2ZW50IG9iamVjdCBjcm9zcy1icm93c2VyLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW1dpbmRvdywgRG9jdW1lbnQsIEFycmF5LCBGdW5jdGlvbiwgU3RyaW5nLCBPYmplY3RdCgpwcm92aWRlczogRXZlbnQKCi4uLgoqLwoKKGZ1bmN0aW9uKCkgewoKdmFyIF9rZXlzID0ge307Cgp2YXIgRE9NRXZlbnQgPSB0aGlzLkRPTUV2ZW50ID0gbmV3IFR5cGUoJ0RPTUV2ZW50JywgZnVuY3Rpb24oZXZlbnQsIHdpbil7CglpZiAoIXdpbikgd2luID0gd2luZG93OwoJZXZlbnQgPSBldmVudCB8fCB3aW4uZXZlbnQ7CglpZiAoZXZlbnQuJGV4dGVuZGVkKSByZXR1cm4gZXZlbnQ7Cgl0aGlzLmV2ZW50ID0gZXZlbnQ7Cgl0aGlzLiRleHRlbmRlZCA9IHRydWU7Cgl0aGlzLnNoaWZ0ID0gZXZlbnQuc2hpZnRLZXk7Cgl0aGlzLmNvbnRyb2wgPSBldmVudC5jdHJsS2V5OwoJdGhpcy5hbHQgPSBldmVudC5hbHRLZXk7Cgl0aGlzLm1ldGEgPSBldmVudC5tZXRhS2V5OwoJdmFyIHR5cGUgPSB0aGlzLnR5cGUgPSBldmVudC50eXBlOwoJdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50OwoJd2hpbGUgKHRhcmdldCAmJiB0YXJnZXQubm9kZVR5cGUgPT0gMykgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7Cgl0aGlzLnRhcmdldCA9IGRvY3VtZW50LmlkKHRhcmdldCk7CgoJaWYgKHR5cGUuaW5kZXhPZigna2V5JykgPT0gMCl7CgkJdmFyIGNvZGUgPSB0aGlzLmNvZGUgPSAoZXZlbnQud2hpY2ggfHwgZXZlbnQua2V5Q29kZSk7CgkJdGhpcy5rZXkgPSBfa2V5c1tjb2RlXS8qPDEuM2NvbXBhdD4qLyB8fCBPYmplY3Qua2V5T2YoRXZlbnQuS2V5cywgY29kZSkvKjwvMS4zY29tcGF0PiovOwoJCWlmICh0eXBlID09ICdrZXlkb3duJyl7CgkJCWlmIChjb2RlID4gMTExICYmIGNvZGUgPCAxMjQpIHRoaXMua2V5ID0gJ2YnICsgKGNvZGUgLSAxMTEpOwoJCQllbHNlIGlmIChjb2RlID4gOTUgJiYgY29kZSA8IDEwNikgdGhpcy5rZXkgPSBjb2RlIC0gOTY7CgkJfQoJCWlmICh0aGlzLmtleSA9PSBudWxsKSB0aGlzLmtleSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoY29kZSkudG9Mb3dlckNhc2UoKTsKCX0gZWxzZSBpZiAodHlwZSA9PSAnY2xpY2snIHx8IHR5cGUgPT0gJ2RibGNsaWNrJyB8fCB0eXBlID09ICdjb250ZXh0bWVudScgfHwgdHlwZSA9PSAnRE9NTW91c2VTY3JvbGwnIHx8IHR5cGUuaW5kZXhPZignbW91c2UnKSA9PSAwKXsKCQl2YXIgZG9jID0gd2luLmRvY3VtZW50OwoJCWRvYyA9ICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7CgkJdGhpcy5wYWdlID0gewoJCQl4OiAoZXZlbnQucGFnZVggIT0gbnVsbCkgPyBldmVudC5wYWdlWCA6IGV2ZW50LmNsaWVudFggKyBkb2Muc2Nyb2xsTGVmdCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgOiBldmVudC5jbGllbnRZICsgZG9jLnNjcm9sbFRvcAoJCX07CgkJdGhpcy5jbGllbnQgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIC0gd2luLnBhZ2VYT2Zmc2V0IDogZXZlbnQuY2xpZW50WCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgLSB3aW4ucGFnZVlPZmZzZXQgOiBldmVudC5jbGllbnRZCgkJfTsKCQlpZiAodHlwZSA9PSAnRE9NTW91c2VTY3JvbGwnIHx8IHR5cGUgPT0gJ21vdXNld2hlZWwnKQoJCQl0aGlzLndoZWVsID0gKGV2ZW50LndoZWVsRGVsdGEpID8gZXZlbnQud2hlZWxEZWx0YSAvIDEyMCA6IC0oZXZlbnQuZGV0YWlsIHx8IDApIC8gMzsKCgkJdGhpcy5yaWdodENsaWNrID0gKGV2ZW50LndoaWNoID09IDMgfHwgZXZlbnQuYnV0dG9uID09IDIpOwoJCWlmICh0eXBlID09ICdtb3VzZW92ZXInIHx8IHR5cGUgPT0gJ21vdXNlb3V0Jyl7CgkJCXZhciByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCB8fCBldmVudFsodHlwZSA9PSAnbW91c2VvdmVyJyA/ICdmcm9tJyA6ICd0bycpICsgJ0VsZW1lbnQnXTsKCQkJd2hpbGUgKHJlbGF0ZWQgJiYgcmVsYXRlZC5ub2RlVHlwZSA9PSAzKSByZWxhdGVkID0gcmVsYXRlZC5wYXJlbnROb2RlOwoJCQl0aGlzLnJlbGF0ZWRUYXJnZXQgPSBkb2N1bWVudC5pZChyZWxhdGVkKTsKCQl9Cgl9IGVsc2UgaWYgKHR5cGUuaW5kZXhPZigndG91Y2gnKSA9PSAwIHx8IHR5cGUuaW5kZXhPZignZ2VzdHVyZScpID09IDApewoJCXRoaXMucm90YXRpb24gPSBldmVudC5yb3RhdGlvbjsKCQl0aGlzLnNjYWxlID0gZXZlbnQuc2NhbGU7CgkJdGhpcy50YXJnZXRUb3VjaGVzID0gZXZlbnQudGFyZ2V0VG91Y2hlczsKCQl0aGlzLmNoYW5nZWRUb3VjaGVzID0gZXZlbnQuY2hhbmdlZFRvdWNoZXM7CgkJdmFyIHRvdWNoZXMgPSB0aGlzLnRvdWNoZXMgPSBldmVudC50b3VjaGVzOwoJCWlmICh0b3VjaGVzICYmIHRvdWNoZXNbMF0pewoJCQl2YXIgdG91Y2ggPSB0b3VjaGVzWzBdOwoJCQl0aGlzLnBhZ2UgPSB7eDogdG91Y2gucGFnZVgsIHk6IHRvdWNoLnBhZ2VZfTsKCQkJdGhpcy5jbGllbnQgPSB7eDogdG91Y2guY2xpZW50WCwgeTogdG91Y2guY2xpZW50WX07CgkJfQoJfQoKCWlmICghdGhpcy5jbGllbnQpIHRoaXMuY2xpZW50ID0ge307CglpZiAoIXRoaXMucGFnZSkgdGhpcy5wYWdlID0ge307Cn0pOwoKRE9NRXZlbnQuaW1wbGVtZW50KHsKCglzdG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnByZXZlbnREZWZhdWx0KCkuc3RvcFByb3BhZ2F0aW9uKCk7Cgl9LAoKCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24pIHRoaXMuZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJZWxzZSB0aGlzLmV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByZXZlbnREZWZhdWx0OiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmV2ZW50LnByZXZlbnREZWZhdWx0KSB0aGlzLmV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJZWxzZSB0aGlzLmV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkRPTUV2ZW50LmRlZmluZUtleSA9IGZ1bmN0aW9uKGNvZGUsIGtleSl7Cglfa2V5c1tjb2RlXSA9IGtleTsKCXJldHVybiB0aGlzOwp9OwoKRE9NRXZlbnQuZGVmaW5lS2V5cyA9IERPTUV2ZW50LmRlZmluZUtleS5vdmVybG9hZFNldHRlcih0cnVlKTsKCkRPTUV2ZW50LmRlZmluZUtleXMoewoJJzM4JzogJ3VwJywgJzQwJzogJ2Rvd24nLCAnMzcnOiAnbGVmdCcsICczOSc6ICdyaWdodCcsCgknMjcnOiAnZXNjJywgJzMyJzogJ3NwYWNlJywgJzgnOiAnYmFja3NwYWNlJywgJzknOiAndGFiJywKCSc0Nic6ICdkZWxldGUnLCAnMTMnOiAnZW50ZXInCn0pOwoKfSkoKTsKCi8qPDEuM2NvbXBhdD4qLwp2YXIgRXZlbnQgPSBET01FdmVudDsKRXZlbnQuS2V5cyA9IHt9OwovKjwvMS4zY29tcGF0PiovCgovKjwxLjJjb21wYXQ+Ki8KCkV2ZW50LktleXMgPSBuZXcgSGFzaChFdmVudC5LZXlzKTsKCi8qPC8xLjJjb21wYXQ+Ki8KCgovKgotLS0KCm5hbWU6IENsYXNzCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENsYXNzIEZ1bmN0aW9uIGZvciBlYXNpbHkgY3JlYXRpbmcsIGV4dGVuZGluZywgYW5kIGltcGxlbWVudGluZyByZXVzYWJsZSBDbGFzc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIEZ1bmN0aW9uLCBOdW1iZXJdCgpwcm92aWRlczogQ2xhc3MKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgQ2xhc3MgPSB0aGlzLkNsYXNzID0gbmV3IFR5cGUoJ0NsYXNzJywgZnVuY3Rpb24ocGFyYW1zKXsKCWlmIChpbnN0YW5jZU9mKHBhcmFtcywgRnVuY3Rpb24pKSBwYXJhbXMgPSB7aW5pdGlhbGl6ZTogcGFyYW1zfTsKCgl2YXIgbmV3Q2xhc3MgPSBmdW5jdGlvbigpewoJCXJlc2V0KHRoaXMpOwoJCWlmIChuZXdDbGFzcy4kcHJvdG90eXBpbmcpIHJldHVybiB0aGlzOwoJCXRoaXMuJGNhbGxlciA9IG51bGw7CgkJdmFyIHZhbHVlID0gKHRoaXMuaW5pdGlhbGl6ZSkgPyB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IHRoaXM7CgkJdGhpcy4kY2FsbGVyID0gdGhpcy5jYWxsZXIgPSBudWxsOwoJCXJldHVybiB2YWx1ZTsKCX0uZXh0ZW5kKHRoaXMpLmltcGxlbWVudChwYXJhbXMpOwoKCW5ld0NsYXNzLiRjb25zdHJ1Y3RvciA9IENsYXNzOwoJbmV3Q2xhc3MucHJvdG90eXBlLiRjb25zdHJ1Y3RvciA9IG5ld0NsYXNzOwoJbmV3Q2xhc3MucHJvdG90eXBlLnBhcmVudCA9IHBhcmVudDsKCglyZXR1cm4gbmV3Q2xhc3M7Cn0pOwoKdmFyIHBhcmVudCA9IGZ1bmN0aW9uKCl7CglpZiAoIXRoaXMuJGNhbGxlcikgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICJwYXJlbnQiIGNhbm5vdCBiZSBjYWxsZWQuJyk7Cgl2YXIgbmFtZSA9IHRoaXMuJGNhbGxlci4kbmFtZSwKCQlwYXJlbnQgPSB0aGlzLiRjYWxsZXIuJG93bmVyLnBhcmVudCwKCQlwcmV2aW91cyA9IChwYXJlbnQpID8gcGFyZW50LnByb3RvdHlwZVtuYW1lXSA6IG51bGw7CglpZiAoIXByZXZpb3VzKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgIicgKyBuYW1lICsgJyIgaGFzIG5vIHBhcmVudC4nKTsKCXJldHVybiBwcmV2aW91cy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKdmFyIHJlc2V0ID0gZnVuY3Rpb24ob2JqZWN0KXsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCXZhciB2YWx1ZSA9IG9iamVjdFtrZXldOwoJCXN3aXRjaCAodHlwZU9mKHZhbHVlKSl7CgkJCWNhc2UgJ29iamVjdCc6CgkJCQl2YXIgRiA9IGZ1bmN0aW9uKCl7fTsKCQkJCUYucHJvdG90eXBlID0gdmFsdWU7CgkJCQlvYmplY3Rba2V5XSA9IHJlc2V0KG5ldyBGKTsKCQkJYnJlYWs7CgkJCWNhc2UgJ2FycmF5Jzogb2JqZWN0W2tleV0gPSB2YWx1ZS5jbG9uZSgpOyBicmVhazsKCQl9Cgl9CglyZXR1cm4gb2JqZWN0Owp9OwoKdmFyIHdyYXAgPSBmdW5jdGlvbihzZWxmLCBrZXksIG1ldGhvZCl7CglpZiAobWV0aG9kLiRvcmlnaW4pIG1ldGhvZCA9IG1ldGhvZC4kb3JpZ2luOwoJdmFyIHdyYXBwZXIgPSBmdW5jdGlvbigpewoJCWlmIChtZXRob2QuJHByb3RlY3RlZCAmJiB0aGlzLiRjYWxsZXIgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICInICsga2V5ICsgJyIgY2Fubm90IGJlIGNhbGxlZC4nKTsKCQl2YXIgY2FsbGVyID0gdGhpcy5jYWxsZXIsIGN1cnJlbnQgPSB0aGlzLiRjYWxsZXI7CgkJdGhpcy5jYWxsZXIgPSBjdXJyZW50OyB0aGlzLiRjYWxsZXIgPSB3cmFwcGVyOwoJCXZhciByZXN1bHQgPSBtZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQl0aGlzLiRjYWxsZXIgPSBjdXJyZW50OyB0aGlzLmNhbGxlciA9IGNhbGxlcjsKCQlyZXR1cm4gcmVzdWx0OwoJfS5leHRlbmQoeyRvd25lcjogc2VsZiwgJG9yaWdpbjogbWV0aG9kLCAkbmFtZToga2V5fSk7CglyZXR1cm4gd3JhcHBlcjsKfTsKCnZhciBpbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlLCByZXRhaW4pewoJaWYgKENsYXNzLk11dGF0b3JzLmhhc093blByb3BlcnR5KGtleSkpewoJCXZhbHVlID0gQ2xhc3MuTXV0YXRvcnNba2V5XS5jYWxsKHRoaXMsIHZhbHVlKTsKCQlpZiAodmFsdWUgPT0gbnVsbCkgcmV0dXJuIHRoaXM7Cgl9CgoJaWYgKHR5cGVPZih2YWx1ZSkgPT0gJ2Z1bmN0aW9uJyl7CgkJaWYgKHZhbHVlLiRoaWRkZW4pIHJldHVybiB0aGlzOwoJCXRoaXMucHJvdG90eXBlW2tleV0gPSAocmV0YWluKSA/IHZhbHVlIDogd3JhcCh0aGlzLCBrZXksIHZhbHVlKTsKCX0gZWxzZSB7CgkJT2JqZWN0Lm1lcmdlKHRoaXMucHJvdG90eXBlLCBrZXksIHZhbHVlKTsKCX0KCglyZXR1cm4gdGhpczsKfTsKCnZhciBnZXRJbnN0YW5jZSA9IGZ1bmN0aW9uKGtsYXNzKXsKCWtsYXNzLiRwcm90b3R5cGluZyA9IHRydWU7Cgl2YXIgcHJvdG8gPSBuZXcga2xhc3M7CglkZWxldGUga2xhc3MuJHByb3RvdHlwaW5nOwoJcmV0dXJuIHByb3RvOwp9OwoKQ2xhc3MuaW1wbGVtZW50KCdpbXBsZW1lbnQnLCBpbXBsZW1lbnQub3ZlcmxvYWRTZXR0ZXIoKSk7CgpDbGFzcy5NdXRhdG9ycyA9IHsKCglFeHRlbmRzOiBmdW5jdGlvbihwYXJlbnQpewoJCXRoaXMucGFyZW50ID0gcGFyZW50OwoJCXRoaXMucHJvdG90eXBlID0gZ2V0SW5zdGFuY2UocGFyZW50KTsKCX0sCgoJSW1wbGVtZW50czogZnVuY3Rpb24oaXRlbXMpewoJCUFycmF5LmZyb20oaXRlbXMpLmVhY2goZnVuY3Rpb24oaXRlbSl7CgkJCXZhciBpbnN0YW5jZSA9IG5ldyBpdGVtOwoJCQlmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2UpIGltcGxlbWVudC5jYWxsKHRoaXMsIGtleSwgaW5zdGFuY2Vba2V5XSwgdHJ1ZSk7CgkJfSwgdGhpcyk7Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogQ2xhc3MuRXh0cmFzCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgVXRpbGl0eSBDbGFzc2VzIHRoYXQgY2FuIGJlIGltcGxlbWVudGVkIGludG8geW91ciBvd24gQ2xhc3NlcyB0byBlYXNlIHRoZSBleGVjdXRpb24gb2YgbWFueSBjb21tb24gdGFza3MuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBDbGFzcwoKcHJvdmlkZXM6IFtDbGFzcy5FeHRyYXMsIENoYWluLCBFdmVudHMsIE9wdGlvbnNdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdGhpcy5DaGFpbiA9IG5ldyBDbGFzcyh7CgoJJGNoYWluOiBbXSwKCgljaGFpbjogZnVuY3Rpb24oKXsKCQl0aGlzLiRjaGFpbi5hcHBlbmQoQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FsbENoYWluOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy4kY2hhaW4ubGVuZ3RoKSA/IHRoaXMuJGNoYWluLnNoaWZ0KCkuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IGZhbHNlOwoJfSwKCgljbGVhckNoYWluOiBmdW5jdGlvbigpewoJCXRoaXMuJGNoYWluLmVtcHR5KCk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCnZhciByZW1vdmVPbiA9IGZ1bmN0aW9uKHN0cmluZyl7CglyZXR1cm4gc3RyaW5nLnJlcGxhY2UoL15vbihbQS1aXSkvLCBmdW5jdGlvbihmdWxsLCBmaXJzdCl7CgkJcmV0dXJuIGZpcnN0LnRvTG93ZXJDYXNlKCk7Cgl9KTsKfTsKCnRoaXMuRXZlbnRzID0gbmV3IENsYXNzKHsKCgkkZXZlbnRzOiB7fSwKCglhZGRFdmVudDogZnVuY3Rpb24odHlwZSwgZm4sIGludGVybmFsKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgoJCS8qPDEuMmNvbXBhdD4qLwoJCWlmIChmbiA9PSAkZW1wdHkpIHJldHVybiB0aGlzOwoJCS8qPC8xLjJjb21wYXQ+Ki8KCgkJdGhpcy4kZXZlbnRzW3R5cGVdID0gKHRoaXMuJGV2ZW50c1t0eXBlXSB8fCBbXSkuaW5jbHVkZShmbik7CgkJaWYgKGludGVybmFsKSBmbi5pbnRlcm5hbCA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWFkZEV2ZW50czogZnVuY3Rpb24oZXZlbnRzKXsKCQlmb3IgKHZhciB0eXBlIGluIGV2ZW50cykgdGhpcy5hZGRFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglmaXJlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGFyZ3MsIGRlbGF5KXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJYXJncyA9IEFycmF5LmZyb20oYXJncyk7CgkJZXZlbnRzLmVhY2goZnVuY3Rpb24oZm4pewoJCQlpZiAoZGVsYXkpIGZuLmRlbGF5KGRlbGF5LCB0aGlzLCBhcmdzKTsKCQkJZWxzZSBmbi5hcHBseSh0aGlzLCBhcmdzKTsKCQl9LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoZXZlbnRzICYmICFmbi5pbnRlcm5hbCl7CgkJCXZhciBpbmRleCA9ICBldmVudHMuaW5kZXhPZihmbik7CgkJCWlmIChpbmRleCAhPSAtMSkgZGVsZXRlIGV2ZW50c1tpbmRleF07CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKGV2ZW50cykgZXZlbnRzID0gcmVtb3ZlT24oZXZlbnRzKTsKCQlmb3IgKHR5cGUgaW4gdGhpcy4kZXZlbnRzKXsKCQkJaWYgKGV2ZW50cyAmJiBldmVudHMgIT0gdHlwZSkgY29udGludWU7CgkJCXZhciBmbnMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJCWZvciAodmFyIGkgPSBmbnMubGVuZ3RoOyBpLS07KSBpZiAoaSBpbiBmbnMpewoJCQkJdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBmbnNbaV0pOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp0aGlzLk9wdGlvbnMgPSBuZXcgQ2xhc3MoewoKCXNldE9wdGlvbnM6IGZ1bmN0aW9uKCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMgPSBPYmplY3QubWVyZ2UuYXBwbHkobnVsbCwgW3t9LCB0aGlzLm9wdGlvbnNdLmFwcGVuZChhcmd1bWVudHMpKTsKCQlpZiAodGhpcy5hZGRFdmVudCkgZm9yICh2YXIgb3B0aW9uIGluIG9wdGlvbnMpewoJCQlpZiAodHlwZU9mKG9wdGlvbnNbb3B0aW9uXSkgIT0gJ2Z1bmN0aW9uJyB8fCAhKC9eb25bQS1aXS8pLnRlc3Qob3B0aW9uKSkgY29udGludWU7CgkJCXRoaXMuYWRkRXZlbnQob3B0aW9uLCBvcHRpb25zW29wdGlvbl0pOwoJCQlkZWxldGUgb3B0aW9uc1tvcHRpb25dOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKfSkoKTsKCgovKgotLS0KbmFtZTogU2xpY2suUGFyc2VyCmRlc2NyaXB0aW9uOiBTdGFuZGFsb25lIENTUzMgU2VsZWN0b3IgcGFyc2VyCnByb3ZpZGVzOiBTbGljay5QYXJzZXIKLi4uCiovCgo7KGZ1bmN0aW9uKCl7Cgp2YXIgcGFyc2VkLAoJc2VwYXJhdG9ySW5kZXgsCgljb21iaW5hdG9ySW5kZXgsCglyZXZlcnNlZCwKCWNhY2hlID0ge30sCglyZXZlcnNlQ2FjaGUgPSB7fSwKCXJlVW5lc2NhcGUgPSAvXFwvZzsKCnZhciBwYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGlzUmV2ZXJzZWQpewoJaWYgKGV4cHJlc3Npb24gPT0gbnVsbCkgcmV0dXJuIG51bGw7CglpZiAoZXhwcmVzc2lvbi5TbGljayA9PT0gdHJ1ZSkgcmV0dXJuIGV4cHJlc3Npb247CglleHByZXNzaW9uID0gKCcnICsgZXhwcmVzc2lvbikucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCXJldmVyc2VkID0gISFpc1JldmVyc2VkOwoJdmFyIGN1cnJlbnRDYWNoZSA9IChyZXZlcnNlZCkgPyByZXZlcnNlQ2FjaGUgOiBjYWNoZTsKCWlmIChjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl0pIHJldHVybiBjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl07CglwYXJzZWQgPSB7CgkJU2xpY2s6IHRydWUsCgkJZXhwcmVzc2lvbnM6IFtdLAoJCXJhdzogZXhwcmVzc2lvbiwKCQlyZXZlcnNlOiBmdW5jdGlvbigpewoJCQlyZXR1cm4gcGFyc2UodGhpcy5yYXcsIHRydWUpOwoJCX0KCX07CglzZXBhcmF0b3JJbmRleCA9IC0xOwoJd2hpbGUgKGV4cHJlc3Npb24gIT0gKGV4cHJlc3Npb24gPSBleHByZXNzaW9uLnJlcGxhY2UocmVnZXhwLCBwYXJzZXIpKSk7CglwYXJzZWQubGVuZ3RoID0gcGFyc2VkLmV4cHJlc3Npb25zLmxlbmd0aDsKCXJldHVybiBjdXJyZW50Q2FjaGVbcGFyc2VkLnJhd10gPSAocmV2ZXJzZWQpID8gcmV2ZXJzZShwYXJzZWQpIDogcGFyc2VkOwp9OwoKdmFyIHJldmVyc2VDb21iaW5hdG9yID0gZnVuY3Rpb24oY29tYmluYXRvcil7CglpZiAoY29tYmluYXRvciA9PT0gJyEnKSByZXR1cm4gJyAnOwoJZWxzZSBpZiAoY29tYmluYXRvciA9PT0gJyAnKSByZXR1cm4gJyEnOwoJZWxzZSBpZiAoKC9eIS8pLnRlc3QoY29tYmluYXRvcikpIHJldHVybiBjb21iaW5hdG9yLnJlcGxhY2UoL14hLywgJycpOwoJZWxzZSByZXR1cm4gJyEnICsgY29tYmluYXRvcjsKfTsKCnZhciByZXZlcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbil7Cgl2YXIgZXhwcmVzc2lvbnMgPSBleHByZXNzaW9uLmV4cHJlc3Npb25zOwoJZm9yICh2YXIgaSA9IDA7IGkgPCBleHByZXNzaW9ucy5sZW5ndGg7IGkrKyl7CgkJdmFyIGV4cCA9IGV4cHJlc3Npb25zW2ldOwoJCXZhciBsYXN0ID0ge3BhcnRzOiBbXSwgdGFnOiAnKicsIGNvbWJpbmF0b3I6IHJldmVyc2VDb21iaW5hdG9yKGV4cFswXS5jb21iaW5hdG9yKX07CgoJCWZvciAodmFyIGogPSAwOyBqIDwgZXhwLmxlbmd0aDsgaisrKXsKCQkJdmFyIGNleHAgPSBleHBbal07CgkJCWlmICghY2V4cC5yZXZlcnNlQ29tYmluYXRvcikgY2V4cC5yZXZlcnNlQ29tYmluYXRvciA9ICcgJzsKCQkJY2V4cC5jb21iaW5hdG9yID0gY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQkJZGVsZXRlIGNleHAucmV2ZXJzZUNvbWJpbmF0b3I7CgkJfQoKCQlleHAucmV2ZXJzZSgpLnB1c2gobGFzdCk7Cgl9CglyZXR1cm4gZXhwcmVzc2lvbjsKfTsKCnZhciBlc2NhcGVSZWdFeHAgPSBmdW5jdGlvbihzdHJpbmcpey8vIENyZWRpdDogWFJlZ0V4cCAwLjYuMSAoYykgMjAwNy0yMDA4IFN0ZXZlbiBMZXZpdGhhbiA8aHR0cDovL3N0ZXZlbmxldml0aGFuLmNvbS9yZWdleC94cmVnZXhwLz4gTUlUIExpY2Vuc2UKCXJldHVybiBzdHJpbmcucmVwbGFjZSgvWy1bXF17fSgpKis/LlxcXiR8LCNcc10vZywgZnVuY3Rpb24obWF0Y2gpewoJCXJldHVybiAnXFwnICsgbWF0Y2g7Cgl9KTsKfTsKCnZhciByZWdleHAgPSBuZXcgUmVnRXhwKAovKgojIS91c3IvYmluL2VudiBydWJ5CnB1dHMgIlx0XHQiICsgREFUQS5yZWFkLmdzdWIoL1woXD94XCl8XHMrIy4qJHxccyt8XFwkfFxcbi8sJycpCl9fRU5EX18KCSIoP3gpXig/OlwKCSAgXFxzKiAoICwgKSBcXHMqICAgICAgICAgICAgICAgIyBTZXBhcmF0b3IgICAgICAgICAgXG5cCgl8IFxccyogKCA8Y29tYmluYXRvcj4rICkgXFxzKiAgICMgQ29tYmluYXRvciAgICAgICAgIFxuXAoJfCAgICAgICggXFxzKyApICAgICAgICAgICAgICAgICAjIENvbWJpbmF0b3JDaGlsZHJlbiBcblwKCXwgICAgICAoIDx1bmljb2RlPisgfCBcXCogKSAgICAgIyBUYWcgICAgICAgICAgICAgICAgXG5cCgl8IFxcIyAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgSUQgICAgICAgICAgICAgICAgIFxuXAoJfCBcXC4gICggPHVuaWNvZGU+KyAgICAgICApICAgICAjIENsYXNzTmFtZSAgICAgICAgICBcblwKCXwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBBdHRyaWJ1dGUgICAgICAgICAgXG5cCglcXFsgIFwKCQlcXHMqICg8dW5pY29kZTE+KykgICg/OiAgXAoJCQlcXHMqIChbKl4kIX58XT89KSAgKD86ICBcCgkJCQlcXHMqICg/OlwKCQkJCQkoW1wiJ10/KSguKj8pXFw5IFwKCQkJCSlcCgkJCSkgIFwKCQkpPyAgXFxzKiAgXAoJXFxdKD8hXFxdKSBcblwKCXwgICA6KyAoIDx1bmljb2RlPisgKSg/OlwKCVxcKCAoPzpcCgkJKD86KFtcIiddKShbXlxcMTJdKilcXDEyKXwoKD86XFwoW14pXStcXCl8W14oKV0qKSspXAoJKSBcXClcCgkpP1wKCSkiCiovCgkiXig/OlxccyooLClcXHMqfFxccyooPGNvbWJpbmF0b3I+KylcXHMqfChcXHMrKXwoPHVuaWNvZGU+K3xcXCopfFxcIyg8dW5pY29kZT4rKXxcXC4oPHVuaWNvZGU+Kyl8XFxbXFxzKig8dW5pY29kZTE+KykoPzpcXHMqKFsqXiQhfnxdPz0pKD86XFxzKig/OihbXCInXT8pKC4qPylcXDkpKSk/XFxzKlxcXSg/IVxcXSl8KDorKSg8dW5pY29kZT4rKSg/OlxcKCg/Oig/OihbXCInXSkoW15cXDEzXSopXFwxMyl8KCg/OlxcKFteKV0rXFwpfFteKCldKikrKSlcXCkpPykiCgkucmVwbGFjZSgvPGNvbWJpbmF0b3I+LywgJ1snICsgZXNjYXBlUmVnRXhwKCI+K35gIUAkJV4mPXt9XFw7PC8iKSArICddJykKCS5yZXBsYWNlKC88dW5pY29kZT4vZywgJyg/OltcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCgkucmVwbGFjZSgvPHVuaWNvZGUxPi9nLCAnKD86WzpcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCik7CgpmdW5jdGlvbiBwYXJzZXIoCglyYXdNYXRjaCwKCglzZXBhcmF0b3IsCgljb21iaW5hdG9yLAoJY29tYmluYXRvckNoaWxkcmVuLAoKCXRhZ05hbWUsCglpZCwKCWNsYXNzTmFtZSwKCglhdHRyaWJ1dGVLZXksCglhdHRyaWJ1dGVPcGVyYXRvciwKCWF0dHJpYnV0ZVF1b3RlLAoJYXR0cmlidXRlVmFsdWUsCgoJcHNldWRvTWFya2VyLAoJcHNldWRvQ2xhc3MsCglwc2V1ZG9RdW90ZSwKCXBzZXVkb0NsYXNzUXVvdGVkVmFsdWUsCglwc2V1ZG9DbGFzc1ZhbHVlCil7CglpZiAoc2VwYXJhdG9yIHx8IHNlcGFyYXRvckluZGV4ID09PSAtMSl7CgkJcGFyc2VkLmV4cHJlc3Npb25zWysrc2VwYXJhdG9ySW5kZXhdID0gW107CgkJY29tYmluYXRvckluZGV4ID0gLTE7CgkJaWYgKHNlcGFyYXRvcikgcmV0dXJuICcnOwoJfQoKCWlmIChjb21iaW5hdG9yIHx8IGNvbWJpbmF0b3JDaGlsZHJlbiB8fCBjb21iaW5hdG9ySW5kZXggPT09IC0xKXsKCQljb21iaW5hdG9yID0gY29tYmluYXRvciB8fCAnICc7CgkJdmFyIGN1cnJlbnRTZXBhcmF0b3IgPSBwYXJzZWQuZXhwcmVzc2lvbnNbc2VwYXJhdG9ySW5kZXhdOwoJCWlmIChyZXZlcnNlZCAmJiBjdXJyZW50U2VwYXJhdG9yW2NvbWJpbmF0b3JJbmRleF0pCgkJCWN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XS5yZXZlcnNlQ29tYmluYXRvciA9IHJldmVyc2VDb21iaW5hdG9yKGNvbWJpbmF0b3IpOwoJCWN1cnJlbnRTZXBhcmF0b3JbKytjb21iaW5hdG9ySW5kZXhdID0ge2NvbWJpbmF0b3I6IGNvbWJpbmF0b3IsIHRhZzogJyonfTsKCX0KCgl2YXIgY3VycmVudFBhcnNlZCA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF1bY29tYmluYXRvckluZGV4XTsKCglpZiAodGFnTmFtZSl7CgkJY3VycmVudFBhcnNlZC50YWcgPSB0YWdOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoaWQpewoJCWN1cnJlbnRQYXJzZWQuaWQgPSBpZC5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgl9IGVsc2UgaWYgKGNsYXNzTmFtZSl7CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0KSBjdXJyZW50UGFyc2VkLmNsYXNzTGlzdCA9IFtdOwoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc2VzKSBjdXJyZW50UGFyc2VkLmNsYXNzZXMgPSBbXTsKCQljdXJyZW50UGFyc2VkLmNsYXNzTGlzdC5wdXNoKGNsYXNzTmFtZSk7CgkJY3VycmVudFBhcnNlZC5jbGFzc2VzLnB1c2goewoJCQl2YWx1ZTogY2xhc3NOYW1lLAoJCQlyZWdleHA6IG5ldyBSZWdFeHAoJyhefFxccyknICsgZXNjYXBlUmVnRXhwKGNsYXNzTmFtZSkgKyAnKFxcc3wkKScpCgkJfSk7CgoJfSBlbHNlIGlmIChwc2V1ZG9DbGFzcyl7CgkJcHNldWRvQ2xhc3NWYWx1ZSA9IHBzZXVkb0NsYXNzVmFsdWUgfHwgcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZTsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSA/IHBzZXVkb0NsYXNzVmFsdWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJykgOiBudWxsOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQucHNldWRvcykgY3VycmVudFBhcnNlZC5wc2V1ZG9zID0gW107CgkJY3VycmVudFBhcnNlZC5wc2V1ZG9zLnB1c2goewoJCQlrZXk6IHBzZXVkb0NsYXNzLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpLAoJCQl2YWx1ZTogcHNldWRvQ2xhc3NWYWx1ZSwKCQkJdHlwZTogcHNldWRvTWFya2VyLmxlbmd0aCA9PSAxID8gJ2NsYXNzJyA6ICdlbGVtZW50JwoJCX0pOwoKCX0gZWxzZSBpZiAoYXR0cmlidXRlS2V5KXsKCQlhdHRyaWJ1dGVLZXkgPSBhdHRyaWJ1dGVLZXkucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgkJYXR0cmlidXRlVmFsdWUgPSAoYXR0cmlidXRlVmFsdWUgfHwgJycpLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQl2YXIgdGVzdCwgcmVnZXhwOwoKCQlzd2l0Y2ggKGF0dHJpYnV0ZU9wZXJhdG9yKXsKCQkJY2FzZSAnXj0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICAgICAgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJyQ9JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICAgICAgICAgICAgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyQnICAgICAgICk7IGJyZWFrOwoJCQljYXNlICd+PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAnKF58XFxzKScrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoXFxzfCQpJyApOyBicmVhazsKCQkJY2FzZSAnfD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnKC18JCknICAgKTsgYnJlYWs7CgkJCWNhc2UgICc9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgPT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQljYXNlICcqPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIHZhbHVlICYmIHZhbHVlLmluZGV4T2YoYXR0cmlidXRlVmFsdWUpID4gLTE7CgkJCX07IGJyZWFrOwoJCQljYXNlICchPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIGF0dHJpYnV0ZVZhbHVlICE9IHZhbHVlOwoJCQl9OyBicmVhazsKCQkJZGVmYXVsdCAgIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiAhIXZhbHVlOwoJCQl9OwoJCX0KCgkJaWYgKGF0dHJpYnV0ZVZhbHVlID09ICcnICYmICgvXlsqJF5dPSQvKS50ZXN0KGF0dHJpYnV0ZU9wZXJhdG9yKSkgdGVzdCA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCQlpZiAoIXRlc3QpIHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCXJldHVybiB2YWx1ZSAmJiByZWdleHAudGVzdCh2YWx1ZSk7CgkJfTsKCgkJaWYgKCFjdXJyZW50UGFyc2VkLmF0dHJpYnV0ZXMpIGN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcy5wdXNoKHsKCQkJa2V5OiBhdHRyaWJ1dGVLZXksCgkJCW9wZXJhdG9yOiBhdHRyaWJ1dGVPcGVyYXRvciwKCQkJdmFsdWU6IGF0dHJpYnV0ZVZhbHVlLAoJCQl0ZXN0OiB0ZXN0CgkJfSk7CgoJfQoKCXJldHVybiAnJzsKfTsKCi8vIFNsaWNrIE5TCgp2YXIgU2xpY2sgPSAodGhpcy5TbGljayB8fCB7fSk7CgpTbGljay5wYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJcmV0dXJuIHBhcnNlKGV4cHJlc3Npb24pOwp9OwoKU2xpY2suZXNjYXBlUmVnRXhwID0gZXNjYXBlUmVnRXhwOwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CgoKLyoKLS0tCm5hbWU6IFNsaWNrLkZpbmRlcgpkZXNjcmlwdGlvbjogVGhlIG5ldywgc3VwZXJmYXN0IGNzcyBzZWxlY3RvciBlbmdpbmUuCnByb3ZpZGVzOiBTbGljay5GaW5kZXIKcmVxdWlyZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCjsoZnVuY3Rpb24oKXsKCnZhciBsb2NhbCA9IHt9LAoJZmVhdHVyZXNDYWNoZSA9IHt9LAoJdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKLy8gRmVhdHVyZSAvIEJ1ZyBkZXRlY3Rpb24KCmxvY2FsLmlzTmF0aXZlQ29kZSA9IGZ1bmN0aW9uKGZuKXsKCXJldHVybiAoL1x7XHMqXFtuYXRpdmUgY29kZVxdXHMqXH0vKS50ZXN0KCcnICsgZm4pOwp9OwoKbG9jYWwuaXNYTUwgPSBmdW5jdGlvbihkb2N1bWVudCl7CglyZXR1cm4gKCEhZG9jdW1lbnQueG1sVmVyc2lvbikgfHwgKCEhZG9jdW1lbnQueG1sKSB8fCAodG9TdHJpbmcuY2FsbChkb2N1bWVudCkgPT0gJ1tvYmplY3QgWE1MRG9jdW1lbnRdJykgfHwKCShkb2N1bWVudC5ub2RlVHlwZSA9PSA5ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPSAnSFRNTCcpOwp9OwoKbG9jYWwuc2V0RG9jdW1lbnQgPSBmdW5jdGlvbihkb2N1bWVudCl7CgoJLy8gY29udmVydCBlbGVtZW50cyAvIHdpbmRvdyBhcmd1bWVudHMgdG8gZG9jdW1lbnQuIGlmIGRvY3VtZW50IGNhbm5vdCBiZSBleHRyYXBvbGF0ZWQsIHRoZSBmdW5jdGlvbiByZXR1cm5zLgoJdmFyIG5vZGVUeXBlID0gZG9jdW1lbnQubm9kZVR5cGU7CglpZiAobm9kZVR5cGUgPT0gOSk7IC8vIGRvY3VtZW50CgllbHNlIGlmIChub2RlVHlwZSkgZG9jdW1lbnQgPSBkb2N1bWVudC5vd25lckRvY3VtZW50OyAvLyBub2RlCgllbHNlIGlmIChkb2N1bWVudC5uYXZpZ2F0b3IpIGRvY3VtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnQ7IC8vIHdpbmRvdwoJZWxzZSByZXR1cm47CgoJLy8gY2hlY2sgaWYgaXQncyB0aGUgb2xkIGRvY3VtZW50CgoJaWYgKHRoaXMuZG9jdW1lbnQgPT09IGRvY3VtZW50KSByZXR1cm47Cgl0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQ7CgoJLy8gY2hlY2sgaWYgd2UgaGF2ZSBkb25lIGZlYXR1cmUgZGV0ZWN0aW9uIG9uIHRoaXMgZG9jdW1lbnQgYmVmb3JlCgoJdmFyIHJvb3QgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJcm9vdFVpZCA9IHRoaXMuZ2V0VUlEWE1MKHJvb3QpLAoJCWZlYXR1cmVzID0gZmVhdHVyZXNDYWNoZVtyb290VWlkXSwKCQlmZWF0dXJlOwoKCWlmIChmZWF0dXJlcyl7CgkJZm9yIChmZWF0dXJlIGluIGZlYXR1cmVzKXsKCQkJdGhpc1tmZWF0dXJlXSA9IGZlYXR1cmVzW2ZlYXR1cmVdOwoJCX0KCQlyZXR1cm47Cgl9CgoJZmVhdHVyZXMgPSBmZWF0dXJlc0NhY2hlW3Jvb3RVaWRdID0ge307CgoJZmVhdHVyZXMucm9vdCA9IHJvb3Q7CglmZWF0dXJlcy5pc1hNTERvY3VtZW50ID0gdGhpcy5pc1hNTChkb2N1bWVudCk7CgoJZmVhdHVyZXMuYnJva2VuU3RhckdFQlROCgk9IGZlYXR1cmVzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBCgk9IGZlYXR1cmVzLmlkR2V0c05hbWUKCT0gZmVhdHVyZXMuYnJva2VuTWl4ZWRDYXNlUVNBCgk9IGZlYXR1cmVzLmJyb2tlbkdFQkNOCgk9IGZlYXR1cmVzLmJyb2tlbkNoZWNrZWRRU0EKCT0gZmVhdHVyZXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EKCT0gZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQKCT0gZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yCgk9IGZhbHNlOwoKCXZhciBzdGFyU2VsZWN0c0Nsb3NlZCwgc3RhclNlbGVjdHNDb21tZW50cywKCQlicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTiwgY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSwKCQlicm9rZW5Gb3JtQXR0cmlidXRlR2V0dGVyOwoKCXZhciBzZWxlY3RlZCwgaWQgPSAnc2xpY2tfdW5pcXVlaWQnOwoJdmFyIHRlc3ROb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgoJdmFyIHRlc3RSb290ID0gZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYm9keScpWzBdIHx8IHJvb3Q7Cgl0ZXN0Um9vdC5hcHBlbmRDaGlsZCh0ZXN0Tm9kZSk7CgoJLy8gb24gbm9uLUhUTUwgZG9jdW1lbnRzIGlubmVySFRNTCBhbmQgZ2V0RWxlbWVudHNCeUlkIGRvZXNudCB3b3JrIHByb3Blcmx5Cgl0cnkgewoJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBpZD0iJytpZCsnIj48L2E+JzsKCQlmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCA9ICEhZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwoJfSBjYXRjaChlKXt9OwoKCWlmIChmZWF0dXJlcy5pc0hUTUxEb2N1bWVudCl7CgoJCXRlc3ROb2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgoJCS8vIElFIHJldHVybnMgY29tbWVudCBub2RlcyBmb3IgZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQl0ZXN0Tm9kZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVDb21tZW50KCcnKSk7CgkJc3RhclNlbGVjdHNDb21tZW50cyA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpLmxlbmd0aCA+IDEpOwoKCQkvLyBJRSByZXR1cm5zIGNsb3NlZCBub2RlcyAoRUc6IjwvZm9vPiIpIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICdmb288L2Zvbz4nOwoJCQlzZWxlY3RlZCA9IHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJCXN0YXJTZWxlY3RzQ2xvc2VkID0gKHNlbGVjdGVkICYmICEhc2VsZWN0ZWQubGVuZ3RoICYmIHNlbGVjdGVkWzBdLm5vZGVOYW1lLmNoYXJBdCgwKSA9PSAnLycpOwoJCX0gY2F0Y2goZSl7fTsKCgkJZmVhdHVyZXMuYnJva2VuU3RhckdFQlROID0gc3RhclNlbGVjdHNDb21tZW50cyB8fCBzdGFyU2VsZWN0c0Nsb3NlZDsKCgkJLy8gSUUgcmV0dXJucyBlbGVtZW50cyB3aXRoIHRoZSBuYW1lIGluc3RlYWQgb2YganVzdCBpZCBmb3IgZ2V0RWxlbWVudHNCeUlkIGZvciBzb21lIGRvY3VtZW50cwoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBuYW1lPSInKyBpZCArJyI+PC9hPjxiIGlkPSInKyBpZCArJyI+PC9iPic7CgkJCWZlYXR1cmVzLmlkR2V0c05hbWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCkgPT09IHRlc3ROb2RlLmZpcnN0Q2hpbGQ7CgkJfSBjYXRjaChlKXt9OwoKCQlpZiAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSl7CgoJCQkvLyBTYWZhcmkgMy4yIGdldEVsZW1lbnRzQnlDbGFzc05hbWUgY2FjaGVzIHJlc3VsdHMKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iZiI+PC9hPjxhIGNsYXNzPSJiIj48L2E+JzsKCQkJCXRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2InKS5sZW5ndGg7CgkJCQl0ZXN0Tm9kZS5maXJzdENoaWxkLmNsYXNzTmFtZSA9ICdiJzsKCQkJCWNhY2hlZEdldEVsZW1lbnRzQnlDbGFzc05hbWUgPSAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnYicpLmxlbmd0aCAhPSAyKTsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gT3BlcmEgOS42IGdldEVsZW1lbnRzQnlDbGFzc05hbWUgZG9lc250IGRldGVjdHMgdGhlIGNsYXNzIGlmIGl0cyBub3QgdGhlIGZpcnN0IG9uZQoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJhIj48L2E+PGEgY2xhc3M9ImYgYiBhIj48L2E+JzsKCQkJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2EnKS5sZW5ndGggIT0gMik7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCWZlYXR1cmVzLmJyb2tlbkdFQkNOID0gY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCBicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTjsKCQl9CgoJCWlmICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKXsKCQkJLy8gSUUgOCByZXR1cm5zIGNsb3NlZCBub2RlcyAoRUc6IjwvZm9vPiIpIGZvciBxdWVyeVNlbGVjdG9yQWxsKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnZm9vPC9mb28+JzsKCQkJCXNlbGVjdGVkID0gdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnKicpOwoJCQkJZmVhdHVyZXMuc3RhclNlbGVjdHNDbG9zZWRRU0EgPSAoc2VsZWN0ZWQgJiYgISFzZWxlY3RlZC5sZW5ndGggJiYgc2VsZWN0ZWRbMF0ubm9kZU5hbWUuY2hhckF0KDApID09ICcvJyk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIFNhZmFyaSAzLjIgcXVlcnlTZWxlY3RvckFsbCBkb2VzbnQgd29yayB3aXRoIG1peGVkY2FzZSBvbiBxdWlya3Ntb2RlCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9Ik1pWCI+PC9hPic7CgkJCQlmZWF0dXJlcy5icm9rZW5NaXhlZENhc2VRU0EgPSAhdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnLk1pWCcpLmxlbmd0aDsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gV2Via2l0IGFuZCBPcGVyYSBkb250IHJldHVybiBzZWxlY3RlZCBvcHRpb25zIG9uIHF1ZXJ5U2VsZWN0b3JBbGwKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8c2VsZWN0PjxvcHRpb24gc2VsZWN0ZWQ9InNlbGVjdGVkIj5hPC9vcHRpb24+PC9zZWxlY3Q+JzsKCQkJCWZlYXR1cmVzLmJyb2tlbkNoZWNrZWRRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnOmNoZWNrZWQnKS5sZW5ndGggPT0gMCk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIElFIHJldHVybnMgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIGF0dHJbKl4kXT0iIiBzZWxlY3RvcnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSIiPjwvYT4nOwoJCQkJZmVhdHVyZXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnW2NsYXNzKj0iIl0nKS5sZW5ndGggIT0gMCk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJfQoKCQkvLyBJRTYtNywgaWYgYSBmb3JtIGhhcyBhbiBpbnB1dCBvZiBpZCB4LCBmb3JtLmdldEF0dHJpYnV0ZSh4KSByZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnB1dAoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8Zm9ybSBhY3Rpb249InMiPjxpbnB1dCBpZD0iYWN0aW9uIi8+PC9mb3JtPic7CgkJCWJyb2tlbkZvcm1BdHRyaWJ1dGVHZXR0ZXIgPSAodGVzdE5vZGUuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoJ2FjdGlvbicpICE9ICdzJyk7CgkJfSBjYXRjaChlKXt9OwoKCQkvLyBuYXRpdmUgbWF0Y2hlc1NlbGVjdG9yIGZ1bmN0aW9uCgoJCWZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvciA9IHJvb3QubWF0Y2hlc1NlbGVjdG9yIHx8IC8qcm9vdC5tc01hdGNoZXNTZWxlY3RvciB8fCovIHJvb3QubW96TWF0Y2hlc1NlbGVjdG9yIHx8IHJvb3Qud2Via2l0TWF0Y2hlc1NlbGVjdG9yOwoJCWlmIChmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IpIHRyeSB7CgkJCS8vIGlmIG1hdGNoZXNTZWxlY3RvciB0cm93cyBlcnJvcnMgb24gaW5jb3JyZWN0IHNpbnRheGVzIHdlIGNhbiB1c2UgaXQKCQkJZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yLmNhbGwocm9vdCwgJzpzbGljaycpOwoJCQlmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IgPSBudWxsOwoJCX0gY2F0Y2goZSl7fTsKCgl9CgoJdHJ5IHsKCQlyb290LnNsaWNrX2V4cGFuZG8gPSAxOwoJCWRlbGV0ZSByb290LnNsaWNrX2V4cGFuZG87CgkJZmVhdHVyZXMuZ2V0VUlEID0gdGhpcy5nZXRVSURIVE1MOwoJfSBjYXRjaChlKSB7CgkJZmVhdHVyZXMuZ2V0VUlEID0gdGhpcy5nZXRVSURYTUw7Cgl9CgoJdGVzdFJvb3QucmVtb3ZlQ2hpbGQodGVzdE5vZGUpOwoJdGVzdE5vZGUgPSBzZWxlY3RlZCA9IHRlc3RSb290ID0gbnVsbDsKCgkvLyBnZXRBdHRyaWJ1dGUKCglmZWF0dXJlcy5nZXRBdHRyaWJ1dGUgPSAoZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQgJiYgYnJva2VuRm9ybUF0dHJpYnV0ZUdldHRlcikgPyBmdW5jdGlvbihub2RlLCBuYW1lKXsKCQl2YXIgbWV0aG9kID0gdGhpcy5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdOwoJCWlmIChtZXRob2QpIHJldHVybiBtZXRob2QuY2FsbChub2RlKTsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShuYW1lKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSA6IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJCXZhciBtZXRob2QgPSB0aGlzLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07CgkJcmV0dXJuIChtZXRob2QpID8gbWV0aG9kLmNhbGwobm9kZSkgOiBub2RlLmdldEF0dHJpYnV0ZShuYW1lKTsKCX07CgoJLy8gaGFzQXR0cmlidXRlCgoJZmVhdHVyZXMuaGFzQXR0cmlidXRlID0gKHJvb3QgJiYgdGhpcy5pc05hdGl2ZUNvZGUocm9vdC5oYXNBdHRyaWJ1dGUpKSA/IGZ1bmN0aW9uKG5vZGUsIGF0dHJpYnV0ZSkgewoJCXJldHVybiBub2RlLmhhc0F0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJfSA6IGZ1bmN0aW9uKG5vZGUsIGF0dHJpYnV0ZSkgewoJCW5vZGUgPSBub2RlLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKTsKCQlyZXR1cm4gISEobm9kZSAmJiAobm9kZS5zcGVjaWZpZWQgfHwgbm9kZS5ub2RlVmFsdWUpKTsKCX07CgoJLy8gY29udGFpbnMKCS8vIEZJWE1FOiBBZGQgc3BlY3M6IGxvY2FsLmNvbnRhaW5zIHNob3VsZCBiZSBkaWZmZXJlbnQgZm9yIHhtbCBhbmQgaHRtbCBkb2N1bWVudHM/Cgl2YXIgbmF0aXZlUm9vdENvbnRhaW5zID0gcm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290LmNvbnRhaW5zKSwKCQluYXRpdmVEb2N1bWVudENvbnRhaW5zID0gZG9jdW1lbnQgJiYgdGhpcy5pc05hdGl2ZUNvZGUoZG9jdW1lbnQuY29udGFpbnMpOwoKCWZlYXR1cmVzLmNvbnRhaW5zID0gKG5hdGl2ZVJvb3RDb250YWlucyAmJiBuYXRpdmVEb2N1bWVudENvbnRhaW5zKSA/IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCXJldHVybiBjb250ZXh0LmNvbnRhaW5zKG5vZGUpOwoJfSA6IChuYXRpdmVSb290Q29udGFpbnMgJiYgIW5hdGl2ZURvY3VtZW50Q29udGFpbnMpID8gZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJLy8gSUU4IGRvZXMgbm90IGhhdmUgLmNvbnRhaW5zIG9uIGRvY3VtZW50LgoJCXJldHVybiBjb250ZXh0ID09PSBub2RlIHx8ICgoY29udGV4dCA9PT0gZG9jdW1lbnQpID8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IDogY29udGV4dCkuY29udGFpbnMobm9kZSk7Cgl9IDogKHJvb3QgJiYgcm9vdC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlyZXR1cm4gY29udGV4dCA9PT0gbm9kZSB8fCAhIShjb250ZXh0LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKG5vZGUpICYgMTYpOwoJfSA6IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCWlmIChub2RlKSBkbyB7CgkJCWlmIChub2RlID09PSBjb250ZXh0KSByZXR1cm4gdHJ1ZTsKCQl9IHdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpOwoJCXJldHVybiBmYWxzZTsKCX07CgoJLy8gZG9jdW1lbnQgb3JkZXIgc29ydGluZwoJLy8gY3JlZGl0cyB0byBTaXp6bGUgKGh0dHA6Ly9zaXp6bGVqcy5jb20vKQoKCWZlYXR1cmVzLmRvY3VtZW50U29ydGVyID0gKHJvb3QuY29tcGFyZURvY3VtZW50UG9zaXRpb24pID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uIHx8ICFiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSByZXR1cm4gMDsKCQlyZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihiKSAmIDQgPyAtMSA6IGEgPT09IGIgPyAwIDogMTsKCX0gOiAoJ3NvdXJjZUluZGV4JyBpbiByb290KSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5zb3VyY2VJbmRleCB8fCAhYi5zb3VyY2VJbmRleCkgcmV0dXJuIDA7CgkJcmV0dXJuIGEuc291cmNlSW5kZXggLSBiLnNvdXJjZUluZGV4OwoJfSA6IChkb2N1bWVudC5jcmVhdGVSYW5nZSkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEub3duZXJEb2N1bWVudCB8fCAhYi5vd25lckRvY3VtZW50KSByZXR1cm4gMDsKCQl2YXIgYVJhbmdlID0gYS5vd25lckRvY3VtZW50LmNyZWF0ZVJhbmdlKCksIGJSYW5nZSA9IGIub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpOwoJCWFSYW5nZS5zZXRTdGFydChhLCAwKTsKCQlhUmFuZ2Uuc2V0RW5kKGEsIDApOwoJCWJSYW5nZS5zZXRTdGFydChiLCAwKTsKCQliUmFuZ2Uuc2V0RW5kKGIsIDApOwoJCXJldHVybiBhUmFuZ2UuY29tcGFyZUJvdW5kYXJ5UG9pbnRzKFJhbmdlLlNUQVJUX1RPX0VORCwgYlJhbmdlKTsKCX0gOiBudWxsIDsKCglyb290ID0gbnVsbDsKCglmb3IgKGZlYXR1cmUgaW4gZmVhdHVyZXMpewoJCXRoaXNbZmVhdHVyZV0gPSBmZWF0dXJlc1tmZWF0dXJlXTsKCX0KfTsKCi8vIE1haW4gTWV0aG9kCgp2YXIgcmVTaW1wbGVTZWxlY3RvciA9IC9eKFsjLl0/KSgoPzpbXHctXSt8XCopKSQvLAoJcmVFbXB0eUF0dHJpYnV0ZSA9IC9cWy4rWyokXl09KD86IiJ8JycpP1xdLywKCXFzYUZhaWxFeHBDYWNoZSA9IHt9OwoKbG9jYWwuc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kLCBmaXJzdCl7CgoJdmFyIGZvdW5kID0gdGhpcy5mb3VuZCA9IChmaXJzdCkgPyBudWxsIDogKGFwcGVuZCB8fCBbXSk7CgoJaWYgKCFjb250ZXh0KSByZXR1cm4gZm91bmQ7CgllbHNlIGlmIChjb250ZXh0Lm5hdmlnYXRvcikgY29udGV4dCA9IGNvbnRleHQuZG9jdW1lbnQ7IC8vIENvbnZlcnQgdGhlIG5vZGUgZnJvbSBhIHdpbmRvdyB0byBhIGRvY3VtZW50CgllbHNlIGlmICghY29udGV4dC5ub2RlVHlwZSkgcmV0dXJuIGZvdW5kOwoKCS8vIHNldHVwCgoJdmFyIHBhcnNlZCwgaSwKCQl1bmlxdWVzID0gdGhpcy51bmlxdWVzID0ge30sCgkJaGFzT3RoZXJzID0gISEoYXBwZW5kICYmIGFwcGVuZC5sZW5ndGgpLAoJCWNvbnRleHRJc0RvY3VtZW50ID0gKGNvbnRleHQubm9kZVR5cGUgPT0gOSk7CgoJaWYgKHRoaXMuZG9jdW1lbnQgIT09IChjb250ZXh0SXNEb2N1bWVudCA/IGNvbnRleHQgOiBjb250ZXh0Lm93bmVyRG9jdW1lbnQpKSB0aGlzLnNldERvY3VtZW50KGNvbnRleHQpOwoKCS8vIGF2b2lkIGR1cGxpY2F0aW5nIGl0ZW1zIGFscmVhZHkgaW4gdGhlIGFwcGVuZCBhcnJheQoJaWYgKGhhc090aGVycykgZm9yIChpID0gZm91bmQubGVuZ3RoOyBpLS07KSB1bmlxdWVzW3RoaXMuZ2V0VUlEKGZvdW5kW2ldKV0gPSB0cnVlOwoKCS8vIGV4cHJlc3Npb24gY2hlY2tzCgoJaWYgKHR5cGVvZiBleHByZXNzaW9uID09ICdzdHJpbmcnKXsgLy8gZXhwcmVzc2lvbiBpcyBhIHN0cmluZwoKCQkvKjxzaW1wbGUtc2VsZWN0b3JzLW92ZXJyaWRlPiovCgkJdmFyIHNpbXBsZVNlbGVjdG9yID0gZXhwcmVzc2lvbi5tYXRjaChyZVNpbXBsZVNlbGVjdG9yKTsKCQlzaW1wbGVTZWxlY3RvcnM6IGlmIChzaW1wbGVTZWxlY3RvcikgewoKCQkJdmFyIHN5bWJvbCA9IHNpbXBsZVNlbGVjdG9yWzFdLAoJCQkJbmFtZSA9IHNpbXBsZVNlbGVjdG9yWzJdLAoJCQkJbm9kZSwgbm9kZXM7CgoJCQlpZiAoIXN5bWJvbCl7CgoJCQkJaWYgKG5hbWUgPT0gJyonICYmIHRoaXMuYnJva2VuU3RhckdFQlROKSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlub2RlcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUobmFtZSk7CgkJCQlpZiAoZmlyc3QpIHJldHVybiBub2Rlc1swXSB8fCBudWxsOwoJCQkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJfQoKCQkJfSBlbHNlIGlmIChzeW1ib2wgPT0gJyMnKXsKCgkJCQlpZiAoIXRoaXMuaXNIVE1MRG9jdW1lbnQgfHwgIWNvbnRleHRJc0RvY3VtZW50KSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlub2RlID0gY29udGV4dC5nZXRFbGVtZW50QnlJZChuYW1lKTsKCQkJCWlmICghbm9kZSkgcmV0dXJuIGZvdW5kOwoJCQkJaWYgKHRoaXMuaWRHZXRzTmFtZSAmJiBub2RlLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IG5hbWUpIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGUgfHwgbnVsbDsKCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgoJCQl9IGVsc2UgaWYgKHN5bWJvbCA9PSAnLicpewoKCQkJCWlmICghdGhpcy5pc0hUTUxEb2N1bWVudCB8fCAoKCFjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgdGhpcy5icm9rZW5HRUJDTikgJiYgY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKSkgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJaWYgKGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiAhdGhpcy5icm9rZW5HRUJDTil7CgkJCQkJbm9kZXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUobmFtZSk7CgkJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZXNbMF0gfHwgbnVsbDsKCQkJCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdmFyIG1hdGNoQ2xhc3MgPSBuZXcgUmVnRXhwKCcoXnxcXHMpJysgU2xpY2suZXNjYXBlUmVnRXhwKG5hbWUpICsnKFxcc3wkKScpOwoJCQkJCW5vZGVzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCQkJCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQkJCWNsYXNzTmFtZSA9IG5vZGUuY2xhc3NOYW1lOwoJCQkJCQlpZiAoIShjbGFzc05hbWUgJiYgbWF0Y2hDbGFzcy50ZXN0KGNsYXNzTmFtZSkpKSBjb250aW51ZTsKCQkJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZTsKCQkJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJCQl9CgkJCQl9CgoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gKGZpcnN0KSA/IG51bGwgOiBmb3VuZDsKCgkJfQoJCS8qPC9zaW1wbGUtc2VsZWN0b3JzLW92ZXJyaWRlPiovCgoJCS8qPHF1ZXJ5LXNlbGVjdG9yLW92ZXJyaWRlPiovCgkJcXVlcnlTZWxlY3RvcjogaWYgKGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCkgewoKCQkJaWYgKCF0aGlzLmlzSFRNTERvY3VtZW50CgkJCQl8fCBxc2FGYWlsRXhwQ2FjaGVbZXhwcmVzc2lvbl0KCQkJCS8vVE9ETzogb25seSBza2lwIHdoZW4gZXhwcmVzc2lvbiBpcyBhY3R1YWxseSBtaXhlZCBjYXNlCgkJCQl8fCB0aGlzLmJyb2tlbk1peGVkQ2FzZVFTQQoJCQkJfHwgKHRoaXMuYnJva2VuQ2hlY2tlZFFTQSAmJiBleHByZXNzaW9uLmluZGV4T2YoJzpjaGVja2VkJykgPiAtMSkKCQkJCXx8ICh0aGlzLmJyb2tlbkVtcHR5QXR0cmlidXRlUVNBICYmIHJlRW1wdHlBdHRyaWJ1dGUudGVzdChleHByZXNzaW9uKSkKCQkJCXx8ICghY29udGV4dElzRG9jdW1lbnQgLy9BYm9ydCB3aGVuICFjb250ZXh0SXNEb2N1bWVudCBhbmQuLi4KCQkJCQkvLyAgdGhlcmUgYXJlIG11bHRpcGxlIGV4cHJlc3Npb25zIGluIHRoZSBzZWxlY3RvcgoJCQkJCS8vICBzaW5jZSB3ZSBjdXJyZW50bHkgb25seSBmaXggbm9uLWRvY3VtZW50IHJvb3RlZCBRU0EgZm9yIHNpbmdsZSBleHByZXNzaW9uIHNlbGVjdG9ycwoJCQkJCSYmIGV4cHJlc3Npb24uaW5kZXhPZignLCcpID4gLTEKCQkJCSkKCQkJCXx8IFNsaWNrLmRpc2FibGVRU0EKCQkJKSBicmVhayBxdWVyeVNlbGVjdG9yOwoKCQkJdmFyIF9leHByZXNzaW9uID0gZXhwcmVzc2lvbiwgX2NvbnRleHQgPSBjb250ZXh0OwoJCQlpZiAoIWNvbnRleHRJc0RvY3VtZW50KXsKCQkJCS8vIG5vbi1kb2N1bWVudCByb290ZWQgUVNBCgkJCQkvLyBjcmVkaXRzIHRvIEFuZHJldyBEdXBvbnQKCQkJCXZhciBjdXJyZW50SWQgPSBfY29udGV4dC5nZXRBdHRyaWJ1dGUoJ2lkJyksIHNsaWNraWQgPSAnc2xpY2tpZF9fJzsKCQkJCV9jb250ZXh0LnNldEF0dHJpYnV0ZSgnaWQnLCBzbGlja2lkKTsKCQkJCV9leHByZXNzaW9uID0gJyMnICsgc2xpY2tpZCArICcgJyArIF9leHByZXNzaW9uOwoJCQkJY29udGV4dCA9IF9jb250ZXh0LnBhcmVudE5vZGU7CgkJCX0KCgkJCXRyeSB7CgkJCQlpZiAoZmlyc3QpIHJldHVybiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3IoX2V4cHJlc3Npb24pIHx8IG51bGw7CgkJCQllbHNlIG5vZGVzID0gY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKF9leHByZXNzaW9uKTsKCQkJfSBjYXRjaChlKSB7CgkJCQlxc2FGYWlsRXhwQ2FjaGVbZXhwcmVzc2lvbl0gPSAxOwoJCQkJYnJlYWsgcXVlcnlTZWxlY3RvcjsKCQkJfSBmaW5hbGx5IHsKCQkJCWlmICghY29udGV4dElzRG9jdW1lbnQpewoJCQkJCWlmIChjdXJyZW50SWQpIF9jb250ZXh0LnNldEF0dHJpYnV0ZSgnaWQnLCBjdXJyZW50SWQpOwoJCQkJCWVsc2UgX2NvbnRleHQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwoJCQkJCWNvbnRleHQgPSBfY29udGV4dDsKCQkJCX0KCQkJfQoKCQkJaWYgKHRoaXMuc3RhclNlbGVjdHNDbG9zZWRRU0EpIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQlpZiAobm9kZS5ub2RlTmFtZSA+ICdAJyAmJiAhKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCX0gZWxzZSBmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJfQoKCQkJaWYgKGhhc090aGVycykgdGhpcy5zb3J0KGZvdW5kKTsKCQkJcmV0dXJuIGZvdW5kOwoKCQl9CgkJLyo8L3F1ZXJ5LXNlbGVjdG9yLW92ZXJyaWRlPiovCgoJCXBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2UoZXhwcmVzc2lvbik7CgkJaWYgKCFwYXJzZWQubGVuZ3RoKSByZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24gPT0gbnVsbCl7IC8vIHRoZXJlIGlzIG5vIGV4cHJlc3Npb24KCQlyZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24uU2xpY2speyAvLyBleHByZXNzaW9uIGlzIGEgcGFyc2VkIFNsaWNrIG9iamVjdAoJCXBhcnNlZCA9IGV4cHJlc3Npb247Cgl9IGVsc2UgaWYgKHRoaXMuY29udGFpbnMoY29udGV4dC5kb2N1bWVudEVsZW1lbnQgfHwgY29udGV4dCwgZXhwcmVzc2lvbikpeyAvLyBleHByZXNzaW9uIGlzIGEgbm9kZQoJCShmb3VuZCkgPyBmb3VuZC5wdXNoKGV4cHJlc3Npb24pIDogZm91bmQgPSBleHByZXNzaW9uOwoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSB7IC8vIG90aGVyIGp1bmsKCQlyZXR1cm4gZm91bmQ7Cgl9CgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLy8gY2FjaGUgZWxlbWVudHMgZm9yIHRoZSBudGggc2VsZWN0b3JzCgoJdGhpcy5wb3NOVEggPSB7fTsKCXRoaXMucG9zTlRITGFzdCA9IHt9OwoJdGhpcy5wb3NOVEhUeXBlID0ge307Cgl0aGlzLnBvc05USFR5cGVMYXN0ID0ge307CgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBpZiBhcHBlbmQgaXMgbnVsbCBhbmQgdGhlcmUgaXMgb25seSBhIHNpbmdsZSBzZWxlY3RvciB3aXRoIG9uZSBleHByZXNzaW9uIHVzZSBwdXNoQXJyYXksIGVsc2UgdXNlIHB1c2hVSUQKCXRoaXMucHVzaCA9ICghaGFzT3RoZXJzICYmIChmaXJzdCB8fCAocGFyc2VkLmxlbmd0aCA9PSAxICYmIHBhcnNlZC5leHByZXNzaW9uc1swXS5sZW5ndGggPT0gMSkpKSA/IHRoaXMucHVzaEFycmF5IDogdGhpcy5wdXNoVUlEOwoKCWlmIChmb3VuZCA9PSBudWxsKSBmb3VuZCA9IFtdOwoKCS8vIGRlZmF1bHQgZW5naW5lCgoJdmFyIGosIG0sIG47Cgl2YXIgY29tYmluYXRvciwgdGFnLCBpZCwgY2xhc3NMaXN0LCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zOwoJdmFyIGN1cnJlbnRJdGVtcywgY3VycmVudEV4cHJlc3Npb24sIGN1cnJlbnRCaXQsIGxhc3RCaXQsIGV4cHJlc3Npb25zID0gcGFyc2VkLmV4cHJlc3Npb25zOwoKCXNlYXJjaDogZm9yIChpID0gMDsgKGN1cnJlbnRFeHByZXNzaW9uID0gZXhwcmVzc2lvbnNbaV0pOyBpKyspIGZvciAoaiA9IDA7IChjdXJyZW50Qml0ID0gY3VycmVudEV4cHJlc3Npb25bal0pOyBqKyspewoKCQljb21iaW5hdG9yID0gJ2NvbWJpbmF0b3I6JyArIGN1cnJlbnRCaXQuY29tYmluYXRvcjsKCQlpZiAoIXRoaXNbY29tYmluYXRvcl0pIGNvbnRpbnVlIHNlYXJjaDsKCgkJdGFnICAgICAgICA9ICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gY3VycmVudEJpdC50YWcgOiBjdXJyZW50Qml0LnRhZy50b1VwcGVyQ2FzZSgpOwoJCWlkICAgICAgICAgPSBjdXJyZW50Qml0LmlkOwoJCWNsYXNzTGlzdCAgPSBjdXJyZW50Qml0LmNsYXNzTGlzdDsKCQljbGFzc2VzICAgID0gY3VycmVudEJpdC5jbGFzc2VzOwoJCWF0dHJpYnV0ZXMgPSBjdXJyZW50Qml0LmF0dHJpYnV0ZXM7CgkJcHNldWRvcyAgICA9IGN1cnJlbnRCaXQucHNldWRvczsKCQlsYXN0Qml0ICAgID0gKGogPT09IChjdXJyZW50RXhwcmVzc2lvbi5sZW5ndGggLSAxKSk7CgoJCXRoaXMuYml0VW5pcXVlcyA9IHt9OwoKCQlpZiAobGFzdEJpdCl7CgkJCXRoaXMudW5pcXVlcyA9IHVuaXF1ZXM7CgkJCXRoaXMuZm91bmQgPSBmb3VuZDsKCQl9IGVsc2UgewoJCQl0aGlzLnVuaXF1ZXMgPSB7fTsKCQkJdGhpcy5mb3VuZCA9IFtdOwoJCX0KCgkJaWYgKGogPT09IDApewoJCQl0aGlzW2NvbWJpbmF0b3JdKGNvbnRleHQsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJCWlmIChmaXJzdCAmJiBsYXN0Qml0ICYmIGZvdW5kLmxlbmd0aCkgYnJlYWsgc2VhcmNoOwoJCX0gZWxzZSB7CgkJCWlmIChmaXJzdCAmJiBsYXN0Qml0KSBmb3IgKG0gPSAwLCBuID0gY3VycmVudEl0ZW1zLmxlbmd0aDsgbSA8IG47IG0rKyl7CgkJCQl0aGlzW2NvbWJpbmF0b3JdKGN1cnJlbnRJdGVtc1ttXSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQkJCWlmIChmb3VuZC5sZW5ndGgpIGJyZWFrIHNlYXJjaDsKCQkJfSBlbHNlIGZvciAobSA9IDAsIG4gPSBjdXJyZW50SXRlbXMubGVuZ3RoOyBtIDwgbjsgbSsrKSB0aGlzW2NvbWJpbmF0b3JdKGN1cnJlbnRJdGVtc1ttXSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQl9CgoJCWN1cnJlbnRJdGVtcyA9IHRoaXMuZm91bmQ7Cgl9CgoJLy8gc2hvdWxkIHNvcnQgaWYgdGhlcmUgYXJlIG5vZGVzIGluIGFwcGVuZCBhbmQgaWYgeW91IHBhc3MgbXVsdGlwbGUgZXhwcmVzc2lvbnMuCglpZiAoaGFzT3RoZXJzIHx8IChwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoID4gMSkpIHRoaXMuc29ydChmb3VuZCk7CgoJcmV0dXJuIChmaXJzdCkgPyAoZm91bmRbMF0gfHwgbnVsbCkgOiBmb3VuZDsKfTsKCi8vIFV0aWxzCgpsb2NhbC51aWR4ID0gMTsKbG9jYWwudWlkayA9ICdzbGljay11bmlxdWVpZCc7Cgpsb2NhbC5nZXRVSURYTUwgPSBmdW5jdGlvbihub2RlKXsKCXZhciB1aWQgPSBub2RlLmdldEF0dHJpYnV0ZSh0aGlzLnVpZGspOwoJaWYgKCF1aWQpewoJCXVpZCA9IHRoaXMudWlkeCsrOwoJCW5vZGUuc2V0QXR0cmlidXRlKHRoaXMudWlkaywgdWlkKTsKCX0KCXJldHVybiB1aWQ7Cn07Cgpsb2NhbC5nZXRVSURIVE1MID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbm9kZS51bmlxdWVOdW1iZXIgfHwgKG5vZGUudW5pcXVlTnVtYmVyID0gdGhpcy51aWR4KyspOwp9OwoKLy8gc29ydCBiYXNlZCBvbiB0aGUgc2V0RG9jdW1lbnQgZG9jdW1lbnRTb3J0ZXIgbWV0aG9kLgoKbG9jYWwuc29ydCA9IGZ1bmN0aW9uKHJlc3VsdHMpewoJaWYgKCF0aGlzLmRvY3VtZW50U29ydGVyKSByZXR1cm4gcmVzdWx0czsKCXJlc3VsdHMuc29ydCh0aGlzLmRvY3VtZW50U29ydGVyKTsKCXJldHVybiByZXN1bHRzOwp9OwoKLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgpsb2NhbC5jYWNoZU5USCA9IHt9OwoKbG9jYWwubWF0Y2hOVEggPSAvXihbKy1dP1xkKik/KFthLXpdKyk/KFsrLV1cZCspPyQvOwoKbG9jYWwucGFyc2VOVEhBcmd1bWVudCA9IGZ1bmN0aW9uKGFyZ3VtZW50KXsKCXZhciBwYXJzZWQgPSBhcmd1bWVudC5tYXRjaCh0aGlzLm1hdGNoTlRIKTsKCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7Cgl2YXIgc3BlY2lhbCA9IHBhcnNlZFsyXSB8fCBmYWxzZTsKCXZhciBhID0gcGFyc2VkWzFdIHx8IDE7CglpZiAoYSA9PSAnLScpIGEgPSAtMTsKCXZhciBiID0gK3BhcnNlZFszXSB8fCAwOwoJcGFyc2VkID0KCQkoc3BlY2lhbCA9PSAnbicpCT8ge2E6IGEsIGI6IGJ9IDoKCQkoc3BlY2lhbCA9PSAnb2RkJykJPyB7YTogMiwgYjogMX0gOgoJCShzcGVjaWFsID09ICdldmVuJykJPyB7YTogMiwgYjogMH0gOiB7YTogMCwgYjogYX07CgoJcmV0dXJuICh0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSA9IHBhcnNlZCk7Cn07Cgpsb2NhbC5jcmVhdGVOVEhQc2V1ZG8gPSBmdW5jdGlvbihjaGlsZCwgc2libGluZywgcG9zaXRpb25zLCBvZlR5cGUpewoJcmV0dXJuIGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJaWYgKCF0aGlzW3Bvc2l0aW9uc11bdWlkXSl7CgkJCXZhciBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CgkJCWlmICghcGFyZW50KSByZXR1cm4gZmFsc2U7CgkJCXZhciBlbCA9IHBhcmVudFtjaGlsZF0sIGNvdW50ID0gMTsKCQkJaWYgKG9mVHlwZSl7CgkJCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlTmFtZSAhPSBub2RlTmFtZSkgY29udGludWU7CgkJCQkJdGhpc1twb3NpdGlvbnNdW3RoaXMuZ2V0VUlEKGVsKV0gPSBjb3VudCsrOwoJCQkJfSB3aGlsZSAoKGVsID0gZWxbc2libGluZ10pKTsKCQkJfSBlbHNlIHsKCQkJCWRvIHsKCQkJCQlpZiAoZWwubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCQkJdGhpc1twb3NpdGlvbnNdW3RoaXMuZ2V0VUlEKGVsKV0gPSBjb3VudCsrOwoJCQkJfSB3aGlsZSAoKGVsID0gZWxbc2libGluZ10pKTsKCQkJfQoJCX0KCQlhcmd1bWVudCA9IGFyZ3VtZW50IHx8ICduJzsKCQl2YXIgcGFyc2VkID0gdGhpcy5jYWNoZU5USFthcmd1bWVudF0gfHwgdGhpcy5wYXJzZU5USEFyZ3VtZW50KGFyZ3VtZW50KTsKCQlpZiAoIXBhcnNlZCkgcmV0dXJuIGZhbHNlOwoJCXZhciBhID0gcGFyc2VkLmEsIGIgPSBwYXJzZWQuYiwgcG9zID0gdGhpc1twb3NpdGlvbnNdW3VpZF07CgkJaWYgKGEgPT0gMCkgcmV0dXJuIGIgPT0gcG9zOwoJCWlmIChhID4gMCl7CgkJCWlmIChwb3MgPCBiKSByZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJaWYgKGIgPCBwb3MpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuICgocG9zIC0gYikgJSBhKSA9PSAwOwoJfTsKfTsKCi8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLy8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCgpsb2NhbC5wdXNoQXJyYXkgPSBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsKCWlmICh0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpIHRoaXMuZm91bmQucHVzaChub2RlKTsKfTsKCmxvY2FsLnB1c2hVSUQgPSBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsKCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCWlmICghdGhpcy51bmlxdWVzW3VpZF0gJiYgdGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpKXsKCQl0aGlzLnVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwoJfQp9OwoKbG9jYWwubWF0Y2hOb2RlID0gZnVuY3Rpb24obm9kZSwgc2VsZWN0b3IpewoJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQgJiYgdGhpcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IpewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLm5hdGl2ZU1hdGNoZXNTZWxlY3Rvci5jYWxsKG5vZGUsIHNlbGVjdG9yLnJlcGxhY2UoL1xbKFtePV0rKT1ccyooW14nIlxdXSs/KVxzKlxdL2csICdbJDE9IiQyIl0nKSk7CgkJfSBjYXRjaChtYXRjaEVycm9yKSB7fQoJfQoKCXZhciBwYXJzZWQgPSB0aGlzLlNsaWNrLnBhcnNlKHNlbGVjdG9yKTsKCWlmICghcGFyc2VkKSByZXR1cm4gdHJ1ZTsKCgkvLyBzaW1wbGUgKHNpbmdsZSkgc2VsZWN0b3JzCgl2YXIgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnMsIHNpbXBsZUV4cENvdW50ZXIgPSAwLCBpOwoJZm9yIChpID0gMDsgKGN1cnJlbnRFeHByZXNzaW9uID0gZXhwcmVzc2lvbnNbaV0pOyBpKyspewoJCWlmIChjdXJyZW50RXhwcmVzc2lvbi5sZW5ndGggPT0gMSl7CgkJCXZhciBleHAgPSBjdXJyZW50RXhwcmVzc2lvblswXTsKCQkJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCAodGhpcy5pc1hNTERvY3VtZW50KSA/IGV4cC50YWcgOiBleHAudGFnLnRvVXBwZXJDYXNlKCksIGV4cC5pZCwgZXhwLmNsYXNzZXMsIGV4cC5hdHRyaWJ1dGVzLCBleHAucHNldWRvcykpIHJldHVybiB0cnVlOwoJCQlzaW1wbGVFeHBDb3VudGVyKys7CgkJfQoJfQoKCWlmIChzaW1wbGVFeHBDb3VudGVyID09IHBhcnNlZC5sZW5ndGgpIHJldHVybiBmYWxzZTsKCgl2YXIgbm9kZXMgPSB0aGlzLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBwYXJzZWQpLCBpdGVtOwoJZm9yIChpID0gMDsgaXRlbSA9IG5vZGVzW2krK107KXsKCQlpZiAoaXRlbSA9PT0gbm9kZSkgcmV0dXJuIHRydWU7Cgl9CglyZXR1cm4gZmFsc2U7Cn07Cgpsb2NhbC5tYXRjaFBzZXVkbyA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUsIGFyZ3VtZW50KXsKCXZhciBwc2V1ZG9OYW1lID0gJ3BzZXVkbzonICsgbmFtZTsKCWlmICh0aGlzW3BzZXVkb05hbWVdKSByZXR1cm4gdGhpc1twc2V1ZG9OYW1lXShub2RlLCBhcmd1bWVudCk7Cgl2YXIgYXR0cmlidXRlID0gdGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSk7CglyZXR1cm4gKGFyZ3VtZW50KSA/IGFyZ3VtZW50ID09IGF0dHJpYnV0ZSA6ICEhYXR0cmlidXRlOwp9OwoKbG9jYWwubWF0Y2hTZWxlY3RvciA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRhZyl7CgkJdmFyIG5vZGVOYW1lID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBub2RlLm5vZGVOYW1lIDogbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpOwoJCWlmICh0YWcgPT0gJyonKXsKCQkJaWYgKG5vZGVOYW1lIDwgJ0AnKSByZXR1cm4gZmFsc2U7IC8vIEZpeCBmb3IgY29tbWVudCBub2RlcyBhbmQgY2xvc2VkIG5vZGVzCgkJfSBlbHNlIHsKCQkJaWYgKG5vZGVOYW1lICE9IHRhZykgcmV0dXJuIGZhbHNlOwoJCX0KCX0KCglpZiAoaWQgJiYgbm9kZS5nZXRBdHRyaWJ1dGUoJ2lkJykgIT0gaWQpIHJldHVybiBmYWxzZTsKCgl2YXIgaSwgcGFydCwgY2xzOwoJaWYgKGNsYXNzZXMpIGZvciAoaSA9IGNsYXNzZXMubGVuZ3RoOyBpLS07KXsKCQljbHMgPSB0aGlzLmdldEF0dHJpYnV0ZShub2RlLCAnY2xhc3MnKTsKCQlpZiAoIShjbHMgJiYgY2xhc3Nlc1tpXS5yZWdleHAudGVzdChjbHMpKSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKGF0dHJpYnV0ZXMpIGZvciAoaSA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gYXR0cmlidXRlc1tpXTsKCQlpZiAocGFydC5vcGVyYXRvciA/ICFwYXJ0LnRlc3QodGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgcGFydC5rZXkpKSA6ICF0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIHJldHVybiBmYWxzZTsKCX0KCWlmIChwc2V1ZG9zKSBmb3IgKGkgPSBwc2V1ZG9zLmxlbmd0aDsgaS0tOyl7CgkJcGFydCA9IHBzZXVkb3NbaV07CgkJaWYgKCF0aGlzLm1hdGNoUHNldWRvKG5vZGUsIHBhcnQua2V5LCBwYXJ0LnZhbHVlKSkgcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn07Cgp2YXIgY29tYmluYXRvcnMgPSB7CgoJJyAnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpeyAvLyBhbGwgY2hpbGQgbm9kZXMsIGFueSBsZXZlbAoKCQl2YXIgaSwgaXRlbSwgY2hpbGRyZW47CgoJCWlmICh0aGlzLmlzSFRNTERvY3VtZW50KXsKCQkJZ2V0QnlJZDogaWYgKGlkKXsKCQkJCWl0ZW0gPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCQkJCWlmICgoIWl0ZW0gJiYgbm9kZS5hbGwpIHx8ICh0aGlzLmlkR2V0c05hbWUgJiYgaXRlbSAmJiBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSl7CgkJCQkJLy8gYWxsW2lkXSByZXR1cm5zIGFsbCB0aGUgZWxlbWVudHMgd2l0aCB0aGF0IG5hbWUgb3IgaWQgaW5zaWRlIG5vZGUKCQkJCQkvLyBpZiB0aGVyZXMganVzdCBvbmUgaXQgd2lsbCByZXR1cm4gdGhlIGVsZW1lbnQsIGVsc2UgaXQgd2lsbCBiZSBhIGNvbGxlY3Rpb24KCQkJCQljaGlsZHJlbiA9IG5vZGUuYWxsW2lkXTsKCQkJCQlpZiAoIWNoaWxkcmVuKSByZXR1cm47CgkJCQkJaWYgKCFjaGlsZHJlblswXSkgY2hpbGRyZW4gPSBbY2hpbGRyZW5dOwoJCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOyl7CgkJCQkJCXZhciBpZE5vZGUgPSBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJyk7CgkJCQkJCWlmIChpZE5vZGUgJiYgaWROb2RlLm5vZGVWYWx1ZSA9PSBpZCl7CgkJCQkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghaXRlbSl7CgkJCQkJLy8gaWYgdGhlIGNvbnRleHQgaXMgaW4gdGhlIGRvbSB3ZSByZXR1cm4sIGVsc2Ugd2Ugd2lsbCB0cnkgR0VCVE4sIGJyZWFraW5nIHRoZSBnZXRCeUlkIGxhYmVsCgkJCQkJaWYgKHRoaXMuY29udGFpbnModGhpcy5yb290LCBub2RlKSkgcmV0dXJuOwoJCQkJCWVsc2UgYnJlYWsgZ2V0QnlJZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5kb2N1bWVudCAhPT0gbm9kZSAmJiAhdGhpcy5jb250YWlucyhub2RlLCBpdGVtKSkgcmV0dXJuOwoJCQkJdGhpcy5wdXNoKGl0ZW0sIHRhZywgbnVsbCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQkJZ2V0QnlDbGFzczogaWYgKGNsYXNzZXMgJiYgbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTGlzdC5qb2luKCcgJykpOwoJCQkJaWYgKCEoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSkgYnJlYWsgZ2V0QnlDbGFzczsKCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgdGhpcy5wdXNoKGl0ZW0sIHRhZywgaWQsIG51bGwsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoJCWdldEJ5VGFnOiB7CgkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwoJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeVRhZzsKCQkJaWYgKCF0aGlzLmJyb2tlblN0YXJHRUJUTikgdGFnID0gbnVsbDsKCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgY2hpbGRyZW4KCQlpZiAoKG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQpKSBkbyB7CgkJCWlmIChub2RlLm5vZGVUeXBlID09IDEpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9IHdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKTsKCX0sCgoJJysnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5nCgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJ14nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZmlyc3QgY2hpbGQKCQlub2RlID0gbm9kZS5maXJzdENoaWxkOwoJCWlmIChub2RlKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJ34nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQkJaWYgKHRoaXMuYml0VW5pcXVlc1t1aWRdKSBicmVhazsKCQkJdGhpcy5iaXRVbmlxdWVzW3VpZF0gPSB0cnVlOwoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknKysnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5nIGFuZCBwcmV2aW91cyBzaWJsaW5nCgkJdGhpc1snY29tYmluYXRvcjorJ10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJdGhpc1snY29tYmluYXRvcjohKyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknfn4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncyBhbmQgcHJldmlvdXMgc2libGluZ3MKCQl0aGlzWydjb21iaW5hdG9yOn4nXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl0aGlzWydjb21iaW5hdG9yOiF+J10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGFsbCBwYXJlbnQgbm9kZXMgdXAgdG8gZG9jdW1lbnQKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnBhcmVudE5vZGUpKSBpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknIT4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZGlyZWN0IHBhcmVudCAob25lIGxldmVsKQoJCW5vZGUgPSBub2RlLnBhcmVudE5vZGU7CgkJaWYgKG5vZGUgIT09IHRoaXMuZG9jdW1lbnQpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJyErJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIHByZXZpb3VzIHNpYmxpbmcKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJyFeJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGxhc3QgY2hpbGQKCQlub2RlID0gbm9kZS5sYXN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWVsc2UgdGhpc1snY29tYmluYXRvcjohKyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJyF+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIHByZXZpb3VzIHNpYmxpbmdzCgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT0gMSkgY29udGludWU7CgkJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQkJaWYgKHRoaXMuYml0VW5pcXVlc1t1aWRdKSBicmVhazsKCQkJdGhpcy5iaXRVbmlxdWVzW3VpZF0gPSB0cnVlOwoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfQoKfTsKCmZvciAodmFyIGMgaW4gY29tYmluYXRvcnMpIGxvY2FsWydjb21iaW5hdG9yOicgKyBjXSA9IGNvbWJpbmF0b3JzW2NdOwoKdmFyIHBzZXVkb3MgPSB7CgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLwoKCSdlbXB0eSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBjaGlsZCA9IG5vZGUuZmlyc3RDaGlsZDsKCQlyZXR1cm4gIShjaGlsZCAmJiBjaGlsZC5ub2RlVHlwZSA9PSAxKSAmJiAhKG5vZGUuaW5uZXJUZXh0IHx8IG5vZGUudGV4dENvbnRlbnQgfHwgJycpLmxlbmd0aDsKCX0sCgoJJ25vdCc6IGZ1bmN0aW9uKG5vZGUsIGV4cHJlc3Npb24pewoJCXJldHVybiAhdGhpcy5tYXRjaE5vZGUobm9kZSwgZXhwcmVzc2lvbik7Cgl9LAoKCSdjb250YWlucyc6IGZ1bmN0aW9uKG5vZGUsIHRleHQpewoJCXJldHVybiAobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykuaW5kZXhPZih0ZXh0KSA+IC0xOwoJfSwKCgknZmlyc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknb25seS1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBwcmV2ID0gbm9kZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQl2YXIgbmV4dCA9IG5vZGU7CgkJd2hpbGUgKChuZXh0ID0gbmV4dC5uZXh0U2libGluZykpIGlmIChuZXh0Lm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgknbnRoLWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USCcpLAoKCSdudGgtbGFzdC1jaGlsZCc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhMYXN0JyksCgoJJ250aC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USFR5cGUnLCB0cnVlKSwKCgknbnRoLWxhc3Qtb2YtdHlwZSc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhUeXBlTGFzdCcsIHRydWUpLAoKCSdpbmRleCc6IGZ1bmN0aW9uKG5vZGUsIGluZGV4KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcnICsgKGluZGV4ICsgMSkpOwoJfSwKCgknZXZlbic6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJzJuJyk7Cgl9LAoKCSdvZGQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcybisxJyk7Cgl9LAoKCS8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8qPG9mLXR5cGUtcHNldWRvLXNlbGVjdG9ycz4qLwoKCSdmaXJzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdsYXN0LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknb25seS1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIHByZXYgPSBub2RlLCBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJd2hpbGUgKChwcmV2ID0gcHJldi5wcmV2aW91c1NpYmxpbmcpKSBpZiAocHJldi5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8L29mLXR5cGUtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8vIGN1c3RvbSBwc2V1ZG9zCgoJJ2VuYWJsZWQnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gIW5vZGUuZGlzYWJsZWQ7Cgl9LAoKCSdkaXNhYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLmRpc2FibGVkOwoJfSwKCgknY2hlY2tlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLmNoZWNrZWQgfHwgbm9kZS5zZWxlY3RlZDsKCX0sCgoJJ2ZvY3VzJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIHRoaXMuaXNIVE1MRG9jdW1lbnQgJiYgdGhpcy5kb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSBub2RlICYmIChub2RlLmhyZWYgfHwgbm9kZS50eXBlIHx8IHRoaXMuaGFzQXR0cmlidXRlKG5vZGUsICd0YWJpbmRleCcpKTsKCX0sCgoJJ3Jvb3QnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gKG5vZGUgPT09IHRoaXMucm9vdCk7Cgl9LAoKCSdzZWxlY3RlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLnNlbGVjdGVkOwoJfQoKCS8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCn07Cgpmb3IgKHZhciBwIGluIHBzZXVkb3MpIGxvY2FsWydwc2V1ZG86JyArIHBdID0gcHNldWRvc1twXTsKCi8vIGF0dHJpYnV0ZXMgbWV0aG9kcwoKdmFyIGF0dHJpYnV0ZUdldHRlcnMgPSBsb2NhbC5hdHRyaWJ1dGVHZXR0ZXJzID0gewoKCSdmb3InOiBmdW5jdGlvbigpewoJCXJldHVybiAoJ2h0bWxGb3InIGluIHRoaXMpID8gdGhpcy5odG1sRm9yIDogdGhpcy5nZXRBdHRyaWJ1dGUoJ2ZvcicpOwoJfSwKCgknaHJlZic6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICgnaHJlZicgaW4gdGhpcykgPyB0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicsIDIpIDogdGhpcy5nZXRBdHRyaWJ1dGUoJ2hyZWYnKTsKCX0sCgoJJ3N0eWxlJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMuc3R5bGUpID8gdGhpcy5zdHlsZS5jc3NUZXh0IDogdGhpcy5nZXRBdHRyaWJ1dGUoJ3N0eWxlJyk7Cgl9LAoKCSd0YWJpbmRleCc6IGZ1bmN0aW9uKCl7CgkJdmFyIGF0dHJpYnV0ZU5vZGUgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoJ3RhYmluZGV4Jyk7CgkJcmV0dXJuIChhdHRyaWJ1dGVOb2RlICYmIGF0dHJpYnV0ZU5vZGUuc3BlY2lmaWVkKSA/IGF0dHJpYnV0ZU5vZGUubm9kZVZhbHVlIDogbnVsbDsKCX0sCgoJJ3R5cGUnOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgndHlwZScpOwoJfSwKCgknbWF4bGVuZ3RoJzogZnVuY3Rpb24oKXsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgnbWF4TGVuZ3RoJyk7CgkJcmV0dXJuIChhdHRyaWJ1dGVOb2RlICYmIGF0dHJpYnV0ZU5vZGUuc3BlY2lmaWVkKSA/IGF0dHJpYnV0ZU5vZGUubm9kZVZhbHVlIDogbnVsbDsKCX0KCn07CgphdHRyaWJ1dGVHZXR0ZXJzLk1BWExFTkdUSCA9IGF0dHJpYnV0ZUdldHRlcnMubWF4TGVuZ3RoID0gYXR0cmlidXRlR2V0dGVycy5tYXhsZW5ndGg7CgovLyBTbGljawoKdmFyIFNsaWNrID0gbG9jYWwuU2xpY2sgPSAodGhpcy5TbGljayB8fCB7fSk7CgpTbGljay52ZXJzaW9uID0gJzEuMS43JzsKCi8vIFNsaWNrIGZpbmRlcgoKU2xpY2suc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kKXsKCXJldHVybiBsb2NhbC5zZWFyY2goY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kKTsKfTsKClNsaWNrLmZpbmQgPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uKXsKCXJldHVybiBsb2NhbC5zZWFyY2goY29udGV4dCwgZXhwcmVzc2lvbiwgbnVsbCwgdHJ1ZSk7Cn07CgovLyBTbGljayBjb250YWlubWVudCBjaGVja2VyCgpTbGljay5jb250YWlucyA9IGZ1bmN0aW9uKGNvbnRhaW5lciwgbm9kZSl7Cglsb2NhbC5zZXREb2N1bWVudChjb250YWluZXIpOwoJcmV0dXJuIGxvY2FsLmNvbnRhaW5zKGNvbnRhaW5lciwgbm9kZSk7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgZ2V0dGVyCgpTbGljay5nZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbihub2RlLCBuYW1lKXsKCWxvY2FsLnNldERvY3VtZW50KG5vZGUpOwoJcmV0dXJuIGxvY2FsLmdldEF0dHJpYnV0ZShub2RlLCBuYW1lKTsKfTsKClNsaWNrLmhhc0F0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJbG9jYWwuc2V0RG9jdW1lbnQobm9kZSk7CglyZXR1cm4gbG9jYWwuaGFzQXR0cmlidXRlKG5vZGUsIG5hbWUpOwp9OwoKLy8gU2xpY2sgbWF0Y2hlcgoKU2xpY2subWF0Y2ggPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CglpZiAoIShub2RlICYmIHNlbGVjdG9yKSkgcmV0dXJuIGZhbHNlOwoJaWYgKCFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gbm9kZSkgcmV0dXJuIHRydWU7Cglsb2NhbC5zZXREb2N1bWVudChub2RlKTsKCXJldHVybiBsb2NhbC5tYXRjaE5vZGUobm9kZSwgc2VsZWN0b3IpOwp9OwoKLy8gU2xpY2sgYXR0cmlidXRlIGFjY2Vzc29yCgpTbGljay5kZWZpbmVBdHRyaWJ1dGVHZXR0ZXIgPSBmdW5jdGlvbihuYW1lLCBmbil7Cglsb2NhbC5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdID0gZm47CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmxvb2t1cEF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUpewoJcmV0dXJuIGxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07Cn07CgovLyBTbGljayBwc2V1ZG8gYWNjZXNzb3IKClNsaWNrLmRlZmluZVBzZXVkbyA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsWydwc2V1ZG86JyArIG5hbWVdID0gZnVuY3Rpb24obm9kZSwgYXJndW1lbnQpewoJCXJldHVybiBmbi5jYWxsKG5vZGUsIGFyZ3VtZW50KTsKCX07CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmxvb2t1cFBzZXVkbyA9IGZ1bmN0aW9uKG5hbWUpewoJdmFyIHBzZXVkbyA9IGxvY2FsWydwc2V1ZG86JyArIG5hbWVdOwoJaWYgKHBzZXVkbykgcmV0dXJuIGZ1bmN0aW9uKGFyZ3VtZW50KXsKCQlyZXR1cm4gcHNldWRvLmNhbGwodGhpcywgYXJndW1lbnQpOwoJfTsKCXJldHVybiBudWxsOwp9OwoKLy8gU2xpY2sgb3ZlcnJpZGVzIGFjY2Vzc29yCgpTbGljay5vdmVycmlkZSA9IGZ1bmN0aW9uKHJlZ2V4cCwgZm4pewoJbG9jYWwub3ZlcnJpZGUocmVnZXhwLCBmbik7CglyZXR1cm4gdGhpczsKfTsKClNsaWNrLmlzWE1MID0gbG9jYWwuaXNYTUw7CgpTbGljay51aWRPZiA9IGZ1bmN0aW9uKG5vZGUpewoJcmV0dXJuIGxvY2FsLmdldFVJREhUTUwobm9kZSk7Cn07CgppZiAoIXRoaXMuU2xpY2spIHRoaXMuU2xpY2sgPSBTbGljazsKCn0pLmFwcGx5KC8qPENvbW1vbkpTPiovKHR5cGVvZiBleHBvcnRzICE9ICd1bmRlZmluZWQnKSA/IGV4cG9ydHMgOiAvKjwvQ29tbW9uSlM+Ki90aGlzKTsKCgovKgotLS0KCm5hbWU6IEVsZW1lbnQKCmRlc2NyaXB0aW9uOiBPbmUgb2YgdGhlIG1vc3QgaW1wb3J0YW50IGl0ZW1zIGluIE1vb1Rvb2xzLiBDb250YWlucyB0aGUgZG9sbGFyIGZ1bmN0aW9uLCB0aGUgZG9sbGFycyBmdW5jdGlvbiwgYW5kIGFuIGhhbmRmdWwgb2YgY3Jvc3MtYnJvd3NlciwgdGltZS1zYXZlciBtZXRob2RzIHRvIGxldCB5b3UgZWFzaWx5IHdvcmsgd2l0aCBIVE1MIEVsZW1lbnRzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW1dpbmRvdywgRG9jdW1lbnQsIEFycmF5LCBTdHJpbmcsIEZ1bmN0aW9uLCBPYmplY3QsIE51bWJlciwgU2xpY2suUGFyc2VyLCBTbGljay5GaW5kZXJdCgpwcm92aWRlczogW0VsZW1lbnQsIEVsZW1lbnRzLCAkLCAkJCwgSWZyYW1lLCBTZWxlY3RvcnNdCgouLi4KKi8KCnZhciBFbGVtZW50ID0gZnVuY3Rpb24odGFnLCBwcm9wcyl7Cgl2YXIga29uc3RydWN0b3IgPSBFbGVtZW50LkNvbnN0cnVjdG9yc1t0YWddOwoJaWYgKGtvbnN0cnVjdG9yKSByZXR1cm4ga29uc3RydWN0b3IocHJvcHMpOwoJaWYgKHR5cGVvZiB0YWcgIT0gJ3N0cmluZycpIHJldHVybiBkb2N1bWVudC5pZCh0YWcpLnNldChwcm9wcyk7CgoJaWYgKCFwcm9wcykgcHJvcHMgPSB7fTsKCglpZiAoISgvXltcdy1dKyQvKS50ZXN0KHRhZykpewoJCXZhciBwYXJzZWQgPSBTbGljay5wYXJzZSh0YWcpLmV4cHJlc3Npb25zWzBdWzBdOwoJCXRhZyA9IChwYXJzZWQudGFnID09ICcqJykgPyAnZGl2JyA6IHBhcnNlZC50YWc7CgkJaWYgKHBhcnNlZC5pZCAmJiBwcm9wcy5pZCA9PSBudWxsKSBwcm9wcy5pZCA9IHBhcnNlZC5pZDsKCgkJdmFyIGF0dHJpYnV0ZXMgPSBwYXJzZWQuYXR0cmlidXRlczsKCQlpZiAoYXR0cmlidXRlcykgZm9yICh2YXIgYXR0ciwgaSA9IDAsIGwgPSBhdHRyaWJ1dGVzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWF0dHIgPSBhdHRyaWJ1dGVzW2ldOwoJCQlpZiAocHJvcHNbYXR0ci5rZXldICE9IG51bGwpIGNvbnRpbnVlOwoKCQkJaWYgKGF0dHIudmFsdWUgIT0gbnVsbCAmJiBhdHRyLm9wZXJhdG9yID09ICc9JykgcHJvcHNbYXR0ci5rZXldID0gYXR0ci52YWx1ZTsKCQkJZWxzZSBpZiAoIWF0dHIudmFsdWUgJiYgIWF0dHIub3BlcmF0b3IpIHByb3BzW2F0dHIua2V5XSA9IHRydWU7CgkJfQoKCQlpZiAocGFyc2VkLmNsYXNzTGlzdCAmJiBwcm9wc1snY2xhc3MnXSA9PSBudWxsKSBwcm9wc1snY2xhc3MnXSA9IHBhcnNlZC5jbGFzc0xpc3Quam9pbignICcpOwoJfQoKCXJldHVybiBkb2N1bWVudC5uZXdFbGVtZW50KHRhZywgcHJvcHMpOwp9OwoKCmlmIChCcm93c2VyLkVsZW1lbnQpewoJRWxlbWVudC5wcm90b3R5cGUgPSBCcm93c2VyLkVsZW1lbnQucHJvdG90eXBlOwoJLy8gSUU4IGFuZCBJRTkgcmVxdWlyZSB0aGUgd3JhcHBpbmcuCglFbGVtZW50LnByb3RvdHlwZS5fZmlyZUV2ZW50ID0gKGZ1bmN0aW9uKGZpcmVFdmVudCl7CgkJcmV0dXJuIGZ1bmN0aW9uKHR5cGUsIGV2ZW50KXsKCQkJcmV0dXJuIGZpcmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIGV2ZW50KTsKCQl9OwoJfSkoRWxlbWVudC5wcm90b3R5cGUuZmlyZUV2ZW50KTsKfQoKbmV3IFR5cGUoJ0VsZW1lbnQnLCBFbGVtZW50KS5taXJyb3IoZnVuY3Rpb24obmFtZSl7CglpZiAoQXJyYXkucHJvdG90eXBlW25hbWVdKSByZXR1cm47CgoJdmFyIG9iaiA9IHt9OwoJb2JqW25hbWVdID0gZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0cyA9IFtdLCBhcmdzID0gYXJndW1lbnRzLCBlbGVtZW50cyA9IHRydWU7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBlbGVtZW50ID0gdGhpc1tpXSwgcmVzdWx0ID0gcmVzdWx0c1tpXSA9IGVsZW1lbnRbbmFtZV0uYXBwbHkoZWxlbWVudCwgYXJncyk7CgkJCWVsZW1lbnRzID0gKGVsZW1lbnRzICYmIHR5cGVPZihyZXN1bHQpID09ICdlbGVtZW50Jyk7CgkJfQoJCXJldHVybiAoZWxlbWVudHMpID8gbmV3IEVsZW1lbnRzKHJlc3VsdHMpIDogcmVzdWx0czsKCX07CgoJRWxlbWVudHMuaW1wbGVtZW50KG9iaik7Cn0pOwoKaWYgKCFCcm93c2VyLkVsZW1lbnQpewoJRWxlbWVudC5wYXJlbnQgPSBPYmplY3Q7CgoJRWxlbWVudC5Qcm90b3R5cGUgPSB7CgkJJyRjb25zdHJ1Y3Rvcic6IEVsZW1lbnQsCgkJJyRmYW1pbHknOiBGdW5jdGlvbi5mcm9tKCdlbGVtZW50JykuaGlkZSgpCgl9OwoKCUVsZW1lbnQubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7CgkJRWxlbWVudC5Qcm90b3R5cGVbbmFtZV0gPSBtZXRob2Q7Cgl9KTsKfQoKRWxlbWVudC5Db25zdHJ1Y3RvcnMgPSB7fTsKCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuQ29uc3RydWN0b3JzID0gbmV3IEhhc2g7CgovLzwvMS4yY29tcGF0PgoKdmFyIElGcmFtZSA9IG5ldyBUeXBlKCdJRnJhbWUnLCBmdW5jdGlvbigpewoJdmFyIHBhcmFtcyA9IEFycmF5LmxpbmsoYXJndW1lbnRzLCB7CgkJcHJvcGVydGllczogVHlwZS5pc09iamVjdCwKCQlpZnJhbWU6IGZ1bmN0aW9uKG9iail7CgkJCXJldHVybiAob2JqICE9IG51bGwpOwoJCX0KCX0pOwoKCXZhciBwcm9wcyA9IHBhcmFtcy5wcm9wZXJ0aWVzIHx8IHt9LCBpZnJhbWU7CglpZiAocGFyYW1zLmlmcmFtZSkgaWZyYW1lID0gZG9jdW1lbnQuaWQocGFyYW1zLmlmcmFtZSk7Cgl2YXIgb25sb2FkID0gcHJvcHMub25sb2FkIHx8IGZ1bmN0aW9uKCl7fTsKCWRlbGV0ZSBwcm9wcy5vbmxvYWQ7Cglwcm9wcy5pZCA9IHByb3BzLm5hbWUgPSBbcHJvcHMuaWQsIHByb3BzLm5hbWUsIGlmcmFtZSA/IChpZnJhbWUuaWQgfHwgaWZyYW1lLm5hbWUpIDogJ0lGcmFtZV8nICsgU3RyaW5nLnVuaXF1ZUlEKCldLnBpY2soKTsKCWlmcmFtZSA9IG5ldyBFbGVtZW50KGlmcmFtZSB8fCAnaWZyYW1lJywgcHJvcHMpOwoKCXZhciBvbkxvYWQgPSBmdW5jdGlvbigpewoJCW9ubG9hZC5jYWxsKGlmcmFtZS5jb250ZW50V2luZG93KTsKCX07CgoJaWYgKHdpbmRvdy5mcmFtZXNbcHJvcHMuaWRdKSBvbkxvYWQoKTsKCWVsc2UgaWZyYW1lLmFkZExpc3RlbmVyKCdsb2FkJywgb25Mb2FkKTsKCXJldHVybiBpZnJhbWU7Cn0pOwoKdmFyIEVsZW1lbnRzID0gdGhpcy5FbGVtZW50cyA9IGZ1bmN0aW9uKG5vZGVzKXsKCWlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGgpewoJCXZhciB1bmlxdWVzID0ge30sIG5vZGU7CgkJZm9yICh2YXIgaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCXZhciB1aWQgPSBTbGljay51aWRPZihub2RlKTsKCQkJaWYgKCF1bmlxdWVzW3VpZF0pewoJCQkJdW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJCXRoaXMucHVzaChub2RlKTsKCQkJfQoJCX0KCX0KfTsKCkVsZW1lbnRzLnByb3RvdHlwZSA9IHtsZW5ndGg6IDB9OwpFbGVtZW50cy5wYXJlbnQgPSBBcnJheTsKCm5ldyBUeXBlKCdFbGVtZW50cycsIEVsZW1lbnRzKS5pbXBsZW1lbnQoewoKCWZpbHRlcjogZnVuY3Rpb24oZmlsdGVyLCBiaW5kKXsKCQlpZiAoIWZpbHRlcikgcmV0dXJuIHRoaXM7CgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5maWx0ZXIodGhpcywgKHR5cGVPZihmaWx0ZXIpID09ICdzdHJpbmcnKSA/IGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gaXRlbS5tYXRjaChmaWx0ZXIpOwoJCX0gOiBmaWx0ZXIsIGJpbmQpKTsKCX0ucHJvdGVjdCgpLAoKCXB1c2g6IGZ1bmN0aW9uKCl7CgkJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gZG9jdW1lbnQuaWQoYXJndW1lbnRzW2ldKTsKCQkJaWYgKGl0ZW0pIHRoaXNbbGVuZ3RoKytdID0gaXRlbTsKCQl9CgkJcmV0dXJuICh0aGlzLmxlbmd0aCA9IGxlbmd0aCk7Cgl9LnByb3RlY3QoKSwKCgl1bnNoaWZ0OiBmdW5jdGlvbigpewoJCXZhciBpdGVtcyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gZG9jdW1lbnQuaWQoYXJndW1lbnRzW2ldKTsKCQkJaWYgKGl0ZW0pIGl0ZW1zLnB1c2goaXRlbSk7CgkJfQoJCXJldHVybiBBcnJheS5wcm90b3R5cGUudW5zaGlmdC5hcHBseSh0aGlzLCBpdGVtcyk7Cgl9LnByb3RlY3QoKSwKCgljb25jYXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG5ld0VsZW1lbnRzID0gbmV3IEVsZW1lbnRzKHRoaXMpOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gYXJndW1lbnRzW2ldOwoJCQlpZiAoVHlwZS5pc0VudW1lcmFibGUoaXRlbSkpIG5ld0VsZW1lbnRzLmFwcGVuZChpdGVtKTsKCQkJZWxzZSBuZXdFbGVtZW50cy5wdXNoKGl0ZW0pOwoJCX0KCQlyZXR1cm4gbmV3RWxlbWVudHM7Cgl9LnByb3RlY3QoKSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGNvbGxlY3Rpb24pewoJCWZvciAodmFyIGkgPSAwLCBsID0gY29sbGVjdGlvbi5sZW5ndGg7IGkgPCBsOyBpKyspIHRoaXMucHVzaChjb2xsZWN0aW9uW2ldKTsKCQlyZXR1cm4gdGhpczsKCX0ucHJvdGVjdCgpLAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXdoaWxlICh0aGlzLmxlbmd0aCkgZGVsZXRlIHRoaXNbLS10aGlzLmxlbmd0aF07CgkJcmV0dXJuIHRoaXM7Cgl9LnByb3RlY3QoKQoKfSk7CgovLzwxLjJjb21wYXQ+CgpFbGVtZW50cy5hbGlhcygnZXh0ZW5kJywgJ2FwcGVuZCcpOwoKLy88LzEuMmNvbXBhdD4KCihmdW5jdGlvbigpewoKLy8gRkYsIElFCnZhciBzcGxpY2UgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLCBvYmplY3QgPSB7JzAnOiAwLCAnMSc6IDEsIGxlbmd0aDogMn07CgpzcGxpY2UuY2FsbChvYmplY3QsIDEsIDEpOwppZiAob2JqZWN0WzFdID09IDEpIEVsZW1lbnRzLmltcGxlbWVudCgnc3BsaWNlJywgZnVuY3Rpb24oKXsKCXZhciBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCXZhciByZXN1bHQgPSBzcGxpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCXdoaWxlIChsZW5ndGggPj0gdGhpcy5sZW5ndGgpIGRlbGV0ZSB0aGlzW2xlbmd0aC0tXTsKCXJldHVybiByZXN1bHQ7Cn0ucHJvdGVjdCgpKTsKCkFycmF5LmZvckVhY2hNZXRob2QoZnVuY3Rpb24obWV0aG9kLCBuYW1lKXsKCUVsZW1lbnRzLmltcGxlbWVudChuYW1lLCBtZXRob2QpOwp9KTsKCkFycmF5Lm1pcnJvcihFbGVtZW50cyk7CgovKjxsdElFOD4qLwp2YXIgY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MOwp0cnkgewogICAgY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MID0gKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJzxpbnB1dCBuYW1lPXg+JykubmFtZSA9PSAneCcpOwp9IGNhdGNoIChlKXt9Cgp2YXIgZXNjYXBlUXVvdGVzID0gZnVuY3Rpb24oaHRtbCl7CglyZXR1cm4gKCcnICsgaHRtbCkucmVwbGFjZSgvJi9nLCAnJmFtcDsnKS5yZXBsYWNlKC8iL2csICcmcXVvdDsnKTsKfTsKLyo8L2x0SUU4PiovCgpEb2N1bWVudC5pbXBsZW1lbnQoewoKCW5ld0VsZW1lbnQ6IGZ1bmN0aW9uKHRhZywgcHJvcHMpewoJCWlmIChwcm9wcyAmJiBwcm9wcy5jaGVja2VkICE9IG51bGwpIHByb3BzLmRlZmF1bHRDaGVja2VkID0gcHJvcHMuY2hlY2tlZDsKCQkvKjxsdElFOD4qLy8vIEZpeCBmb3IgcmVhZG9ubHkgbmFtZSBhbmQgdHlwZSBwcm9wZXJ0aWVzIGluIElFIDwgOAoJCWlmIChjcmVhdGVFbGVtZW50QWNjZXB0c0hUTUwgJiYgcHJvcHMpewoJCQl0YWcgPSAnPCcgKyB0YWc7CgkJCWlmIChwcm9wcy5uYW1lKSB0YWcgKz0gJyBuYW1lPSInICsgZXNjYXBlUXVvdGVzKHByb3BzLm5hbWUpICsgJyInOwoJCQlpZiAocHJvcHMudHlwZSkgdGFnICs9ICcgdHlwZT0iJyArIGVzY2FwZVF1b3Rlcyhwcm9wcy50eXBlKSArICciJzsKCQkJdGFnICs9ICc+JzsKCQkJZGVsZXRlIHByb3BzLm5hbWU7CgkJCWRlbGV0ZSBwcm9wcy50eXBlOwoJCX0KCQkvKjwvbHRJRTg+Ki8KCQlyZXR1cm4gdGhpcy5pZCh0aGlzLmNyZWF0ZUVsZW1lbnQodGFnKSkuc2V0KHByb3BzKTsKCX0KCn0pOwoKfSkoKTsKCihmdW5jdGlvbigpewoKU2xpY2sudWlkT2Yod2luZG93KTsKU2xpY2sudWlkT2YoZG9jdW1lbnQpOwoKRG9jdW1lbnQuaW1wbGVtZW50KHsKCgluZXdUZXh0Tm9kZTogZnVuY3Rpb24odGV4dCl7CgkJcmV0dXJuIHRoaXMuY3JlYXRlVGV4dE5vZGUodGV4dCk7Cgl9LAoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMud2luZG93OwoJfSwKCglpZDogKGZ1bmN0aW9uKCl7CgoJCXZhciB0eXBlcyA9IHsKCgkJCXN0cmluZzogZnVuY3Rpb24oaWQsIG5vY2FzaCwgZG9jKXsKCQkJCWlkID0gU2xpY2suZmluZChkb2MsICcjJyArIGlkLnJlcGxhY2UoLyhcVykvZywgJ1xcJDEnKSk7CgkJCQlyZXR1cm4gKGlkKSA/IHR5cGVzLmVsZW1lbnQoaWQsIG5vY2FzaCkgOiBudWxsOwoJCQl9LAoKCQkJZWxlbWVudDogZnVuY3Rpb24oZWwsIG5vY2FzaCl7CgkJCQlTbGljay51aWRPZihlbCk7CgkJCQlpZiAoIW5vY2FzaCAmJiAhZWwuJGZhbWlseSAmJiAhKC9eKD86b2JqZWN0fGVtYmVkKSQvaSkudGVzdChlbC50YWdOYW1lKSl7CgkJCQkJdmFyIGZpcmVFdmVudCA9IGVsLmZpcmVFdmVudDsKCQkJCQkvLyB3cmFwcGluZyBuZWVkZWQgaW4gSUU3LCBvciBlbHNlIGNyYXNoCgkJCQkJZWwuX2ZpcmVFdmVudCA9IGZ1bmN0aW9uKHR5cGUsIGV2ZW50KXsKCQkJCQkJcmV0dXJuIGZpcmVFdmVudCh0eXBlLCBldmVudCk7CgkJCQkJfTsKCQkJCQlPYmplY3QuYXBwZW5kKGVsLCBFbGVtZW50LlByb3RvdHlwZSk7CgkJCQl9CgkJCQlyZXR1cm4gZWw7CgkJCX0sCgoJCQlvYmplY3Q6IGZ1bmN0aW9uKG9iaiwgbm9jYXNoLCBkb2MpewoJCQkJaWYgKG9iai50b0VsZW1lbnQpIHJldHVybiB0eXBlcy5lbGVtZW50KG9iai50b0VsZW1lbnQoZG9jKSwgbm9jYXNoKTsKCQkJCXJldHVybiBudWxsOwoJCQl9CgoJCX07CgoJCXR5cGVzLnRleHRub2RlID0gdHlwZXMud2hpdGVzcGFjZSA9IHR5cGVzLndpbmRvdyA9IHR5cGVzLmRvY3VtZW50ID0gZnVuY3Rpb24oemVybyl7CgkJCXJldHVybiB6ZXJvOwoJCX07CgoJCXJldHVybiBmdW5jdGlvbihlbCwgbm9jYXNoLCBkb2MpewoJCQlpZiAoZWwgJiYgZWwuJGZhbWlseSAmJiBlbC51bmlxdWVOdW1iZXIpIHJldHVybiBlbDsKCQkJdmFyIHR5cGUgPSB0eXBlT2YoZWwpOwoJCQlyZXR1cm4gKHR5cGVzW3R5cGVdKSA/IHR5cGVzW3R5cGVdKGVsLCBub2Nhc2gsIGRvYyB8fCBkb2N1bWVudCkgOiBudWxsOwoJCX07CgoJfSkoKQoKfSk7CgppZiAod2luZG93LiQgPT0gbnVsbCkgV2luZG93LmltcGxlbWVudCgnJCcsIGZ1bmN0aW9uKGVsLCBuYyl7CglyZXR1cm4gZG9jdW1lbnQuaWQoZWwsIG5jLCB0aGlzLmRvY3VtZW50KTsKfSk7CgpXaW5kb3cuaW1wbGVtZW50KHsKCglnZXREb2N1bWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5kb2N1bWVudDsKCX0sCgoJZ2V0V2luZG93OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpbRG9jdW1lbnQsIEVsZW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWdldEVsZW1lbnRzOiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gU2xpY2suc2VhcmNoKHRoaXMsIGV4cHJlc3Npb24sIG5ldyBFbGVtZW50cyk7Cgl9LAoKCWdldEVsZW1lbnQ6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsIGV4cHJlc3Npb24pKTsKCX0KCn0pOwoKdmFyIGNvbnRhaW5zID0ge2NvbnRhaW5zOiBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiBTbGljay5jb250YWlucyh0aGlzLCBlbGVtZW50KTsKfX07CgppZiAoIWRvY3VtZW50LmNvbnRhaW5zKSBEb2N1bWVudC5pbXBsZW1lbnQoY29udGFpbnMpOwppZiAoIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLmNvbnRhaW5zKSBFbGVtZW50LmltcGxlbWVudChjb250YWlucyk7CgovLzwxLjJjb21wYXQ+CgpFbGVtZW50LmltcGxlbWVudCgnaGFzQ2hpbGQnLCBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiB0aGlzICE9PSBlbGVtZW50ICYmIHRoaXMuY29udGFpbnMoZWxlbWVudCk7Cn0pOwoKKGZ1bmN0aW9uKHNlYXJjaCwgZmluZCwgbWF0Y2gpewoKCXRoaXMuU2VsZWN0b3JzID0ge307Cgl2YXIgcHNldWRvcyA9IHRoaXMuU2VsZWN0b3JzLlBzZXVkbyA9IG5ldyBIYXNoKCk7CgoJdmFyIGFkZFNsaWNrUHNldWRvcyA9IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgbmFtZSBpbiBwc2V1ZG9zKSBpZiAocHNldWRvcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSl7CgkJCVNsaWNrLmRlZmluZVBzZXVkbyhuYW1lLCBwc2V1ZG9zW25hbWVdKTsKCQkJZGVsZXRlIHBzZXVkb3NbbmFtZV07CgkJfQoJfTsKCglTbGljay5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpewoJCWFkZFNsaWNrUHNldWRvcygpOwoJCXJldHVybiBzZWFyY2guY2FsbCh0aGlzLCBjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpOwoJfTsKCglTbGljay5maW5kID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbil7CgkJYWRkU2xpY2tQc2V1ZG9zKCk7CgkJcmV0dXJuIGZpbmQuY2FsbCh0aGlzLCBjb250ZXh0LCBleHByZXNzaW9uKTsKCX07CgoJU2xpY2subWF0Y2ggPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CgkJYWRkU2xpY2tQc2V1ZG9zKCk7CgkJcmV0dXJuIG1hdGNoLmNhbGwodGhpcywgbm9kZSwgc2VsZWN0b3IpOwoJfTsKCn0pKFNsaWNrLnNlYXJjaCwgU2xpY2suZmluZCwgU2xpY2subWF0Y2gpOwoKLy88LzEuMmNvbXBhdD4KCi8vIHRyZWUgd2Fsa2luZwoKdmFyIGluamVjdENvbWJpbmF0b3IgPSBmdW5jdGlvbihleHByZXNzaW9uLCBjb21iaW5hdG9yKXsKCWlmICghZXhwcmVzc2lvbikgcmV0dXJuIGNvbWJpbmF0b3I7CgoJZXhwcmVzc2lvbiA9IE9iamVjdC5jbG9uZShTbGljay5wYXJzZShleHByZXNzaW9uKSk7CgoJdmFyIGV4cHJlc3Npb25zID0gZXhwcmVzc2lvbi5leHByZXNzaW9uczsKCWZvciAodmFyIGkgPSBleHByZXNzaW9ucy5sZW5ndGg7IGktLTspCgkJZXhwcmVzc2lvbnNbaV1bMF0uY29tYmluYXRvciA9IGNvbWJpbmF0b3I7CgoJcmV0dXJuIGV4cHJlc3Npb247Cn07CgpPYmplY3QuZm9yRWFjaCh7CglnZXROZXh0OiAnficsCglnZXRQcmV2aW91czogJyF+JywKCWdldFBhcmVudDogJyEnCn0sIGZ1bmN0aW9uKGNvbWJpbmF0b3IsIG1ldGhvZCl7CglFbGVtZW50LmltcGxlbWVudChtZXRob2QsIGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiB0aGlzLmdldEVsZW1lbnQoaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCBjb21iaW5hdG9yKSk7Cgl9KTsKfSk7CgpPYmplY3QuZm9yRWFjaCh7CglnZXRBbGxOZXh0OiAnficsCglnZXRBbGxQcmV2aW91czogJyF+JywKCWdldFNpYmxpbmdzOiAnfn4nLAoJZ2V0Q2hpbGRyZW46ICc+JywKCWdldFBhcmVudHM6ICchJwp9LCBmdW5jdGlvbihjb21iaW5hdG9yLCBtZXRob2QpewoJRWxlbWVudC5pbXBsZW1lbnQobWV0aG9kLCBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gdGhpcy5nZXRFbGVtZW50cyhpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sIGNvbWJpbmF0b3IpKTsKCX0pOwp9KTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglnZXRGaXJzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpWzBdKTsKCX0sCgoJZ2V0TGFzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpLmdldExhc3QoKSk7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50LndpbmRvdzsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMub3duZXJEb2N1bWVudDsKCX0sCgoJZ2V0RWxlbWVudEJ5SWQ6IGZ1bmN0aW9uKGlkKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suZmluZCh0aGlzLCAnIycgKyAoJycgKyBpZCkucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKSk7Cgl9LAoKCW1hdGNoOiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gIWV4cHJlc3Npb24gfHwgU2xpY2subWF0Y2godGhpcywgZXhwcmVzc2lvbik7Cgl9Cgp9KTsKCi8vPDEuMmNvbXBhdD4KCmlmICh3aW5kb3cuJCQgPT0gbnVsbCkgV2luZG93LmltcGxlbWVudCgnJCQnLCBmdW5jdGlvbihzZWxlY3Rvcil7Cgl2YXIgZWxlbWVudHMgPSBuZXcgRWxlbWVudHM7CglpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxICYmIHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJykgcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBzZWxlY3RvciwgZWxlbWVudHMpOwoJdmFyIGFyZ3MgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyk7Cglmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3MubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQl2YXIgaXRlbSA9IGFyZ3NbaV07CgkJc3dpdGNoICh0eXBlT2YoaXRlbSkpewoJCQljYXNlICdlbGVtZW50JzogZWxlbWVudHMucHVzaChpdGVtKTsgYnJlYWs7CgkJCWNhc2UgJ3N0cmluZyc6IFNsaWNrLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBpdGVtLCBlbGVtZW50cyk7CgkJfQoJfQoJcmV0dXJuIGVsZW1lbnRzOwp9KTsKCi8vPC8xLjJjb21wYXQ+CgppZiAod2luZG93LiQkID09IG51bGwpIFdpbmRvdy5pbXBsZW1lbnQoJyQkJywgZnVuY3Rpb24oc2VsZWN0b3IpewoJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSl7CgkJaWYgKHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJykgcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBzZWxlY3RvciwgbmV3IEVsZW1lbnRzKTsKCQllbHNlIGlmIChUeXBlLmlzRW51bWVyYWJsZShzZWxlY3RvcikpIHJldHVybiBuZXcgRWxlbWVudHMoc2VsZWN0b3IpOwoJfQoJcmV0dXJuIG5ldyBFbGVtZW50cyhhcmd1bWVudHMpOwp9KTsKCi8vIEluc2VydGVycwoKdmFyIGluc2VydGVycyA9IHsKCgliZWZvcmU6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50KTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50Lm5leHRTaWJsaW5nKTsKCX0sCgoJYm90dG9tOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQllbGVtZW50LmFwcGVuZENoaWxkKGNvbnRleHQpOwoJfSwKCgl0b3A6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCWVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7Cgl9Cgp9OwoKaW5zZXJ0ZXJzLmluc2lkZSA9IGluc2VydGVycy5ib3R0b207CgovLzwxLjJjb21wYXQ+CgpPYmplY3QuZWFjaChpbnNlcnRlcnMsIGZ1bmN0aW9uKGluc2VydGVyLCB3aGVyZSl7CgoJd2hlcmUgPSB3aGVyZS5jYXBpdGFsaXplKCk7CgoJdmFyIG1ldGhvZHMgPSB7fTsKCgltZXRob2RzWydpbmplY3QnICsgd2hlcmVdID0gZnVuY3Rpb24oZWwpewoJCWluc2VydGVyKHRoaXMsIGRvY3VtZW50LmlkKGVsLCB0cnVlKSk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCW1ldGhvZHNbJ2dyYWInICsgd2hlcmVdID0gZnVuY3Rpb24oZWwpewoJCWluc2VydGVyKGRvY3VtZW50LmlkKGVsLCB0cnVlKSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCUVsZW1lbnQuaW1wbGVtZW50KG1ldGhvZHMpOwoKfSk7CgovLzwvMS4yY29tcGF0PgoKLy8gZ2V0UHJvcGVydHkgLyBzZXRQcm9wZXJ0eQoKdmFyIHByb3BlcnR5R2V0dGVycyA9IHt9LCBwcm9wZXJ0eVNldHRlcnMgPSB7fTsKCi8vIHByb3BlcnRpZXMKCnZhciBwcm9wZXJ0aWVzID0ge307CkFycmF5LmZvckVhY2goWwoJJ3R5cGUnLCAndmFsdWUnLCAnZGVmYXVsdFZhbHVlJywgJ2FjY2Vzc0tleScsICdjZWxsUGFkZGluZycsICdjZWxsU3BhY2luZycsICdjb2xTcGFuJywKCSdmcmFtZUJvcmRlcicsICdyb3dTcGFuJywgJ3RhYkluZGV4JywgJ3VzZU1hcCcKXSwgZnVuY3Rpb24ocHJvcGVydHkpewoJcHJvcGVydGllc1twcm9wZXJ0eS50b0xvd2VyQ2FzZSgpXSA9IHByb3BlcnR5Owp9KTsKCnByb3BlcnRpZXMuaHRtbCA9ICdpbm5lckhUTUwnOwpwcm9wZXJ0aWVzLnRleHQgPSAoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykudGV4dENvbnRlbnQgPT0gbnVsbCkgPyAnaW5uZXJUZXh0JzogJ3RleHRDb250ZW50JzsKCk9iamVjdC5mb3JFYWNoKHByb3BlcnRpZXMsIGZ1bmN0aW9uKHJlYWwsIGtleSl7Cglwcm9wZXJ0eVNldHRlcnNba2V5XSA9IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKXsKCQlub2RlW3JlYWxdID0gdmFsdWU7Cgl9OwoJcHJvcGVydHlHZXR0ZXJzW2tleV0gPSBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gbm9kZVtyZWFsXTsKCX07Cn0pOwoKLy8gQm9vbGVhbnMKCnZhciBib29scyA9IFsKCSdjb21wYWN0JywgJ25vd3JhcCcsICdpc21hcCcsICdkZWNsYXJlJywgJ25vc2hhZGUnLCAnY2hlY2tlZCcsCgknZGlzYWJsZWQnLCAncmVhZE9ubHknLCAnbXVsdGlwbGUnLCAnc2VsZWN0ZWQnLCAnbm9yZXNpemUnLAoJJ2RlZmVyJywgJ2RlZmF1bHRDaGVja2VkJywgJ2F1dG9mb2N1cycsICdjb250cm9scycsICdhdXRvcGxheScsCgknbG9vcCcKXTsKCnZhciBib29sZWFucyA9IHt9OwpBcnJheS5mb3JFYWNoKGJvb2xzLCBmdW5jdGlvbihib29sKXsKCXZhciBsb3dlciA9IGJvb2wudG9Mb3dlckNhc2UoKTsKCWJvb2xlYW5zW2xvd2VyXSA9IGJvb2w7Cglwcm9wZXJ0eVNldHRlcnNbbG93ZXJdID0gZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJCW5vZGVbYm9vbF0gPSAhIXZhbHVlOwoJfTsKCXByb3BlcnR5R2V0dGVyc1tsb3dlcl0gPSBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gISFub2RlW2Jvb2xdOwoJfTsKfSk7CgovLyBTcGVjaWFsIGNhc2VzCgpPYmplY3QuYXBwZW5kKHByb3BlcnR5U2V0dGVycywgewoKCSdjbGFzcyc6IGZ1bmN0aW9uKG5vZGUsIHZhbHVlKXsKCQkoJ2NsYXNzTmFtZScgaW4gbm9kZSkgPyBub2RlLmNsYXNzTmFtZSA9ICh2YWx1ZSB8fCAnJykgOiBub2RlLnNldEF0dHJpYnV0ZSgnY2xhc3MnLCB2YWx1ZSk7Cgl9LAoKCSdmb3InOiBmdW5jdGlvbihub2RlLCB2YWx1ZSl7CgkJKCdodG1sRm9yJyBpbiBub2RlKSA/IG5vZGUuaHRtbEZvciA9IHZhbHVlIDogbm9kZS5zZXRBdHRyaWJ1dGUoJ2ZvcicsIHZhbHVlKTsKCX0sCgoJJ3N0eWxlJzogZnVuY3Rpb24obm9kZSwgdmFsdWUpewoJCShub2RlLnN0eWxlKSA/IG5vZGUuc3R5bGUuY3NzVGV4dCA9IHZhbHVlIDogbm9kZS5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgdmFsdWUpOwoJfSwKCgkndmFsdWUnOiBmdW5jdGlvbihub2RlLCB2YWx1ZSl7CgkJbm9kZS52YWx1ZSA9ICh2YWx1ZSAhPSBudWxsKSA/IHZhbHVlIDogJyc7Cgl9Cgp9KTsKCnByb3BlcnR5R2V0dGVyc1snY2xhc3MnXSA9IGZ1bmN0aW9uKG5vZGUpewoJcmV0dXJuICgnY2xhc3NOYW1lJyBpbiBub2RlKSA/IG5vZGUuY2xhc3NOYW1lIHx8IG51bGwgOiBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKTsKfTsKCi8qIDx3ZWJraXQ+ICovCnZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpOwovLyBJRSBzZXRzIHR5cGUgYXMgcmVhZG9ubHkgYW5kIHRocm93cwp0cnkgeyBlbC50eXBlID0gJ2J1dHRvbic7IH0gY2F0Y2goZSl7fQppZiAoZWwudHlwZSAhPSAnYnV0dG9uJykgcHJvcGVydHlTZXR0ZXJzLnR5cGUgPSBmdW5jdGlvbihub2RlLCB2YWx1ZSl7Cglub2RlLnNldEF0dHJpYnV0ZSgndHlwZScsIHZhbHVlKTsKfTsKZWwgPSBudWxsOwovKiA8L3dlYmtpdD4gKi8KCi8qPElFPiovCnZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lucHV0Jyk7CmlucHV0LnZhbHVlID0gJ3QnOwppbnB1dC50eXBlID0gJ3N1Ym1pdCc7CmlmIChpbnB1dC52YWx1ZSAhPSAndCcpIHByb3BlcnR5U2V0dGVycy50eXBlID0gZnVuY3Rpb24obm9kZSwgdHlwZSl7Cgl2YXIgdmFsdWUgPSBub2RlLnZhbHVlOwoJbm9kZS50eXBlID0gdHlwZTsKCW5vZGUudmFsdWUgPSB2YWx1ZTsKfTsKaW5wdXQgPSBudWxsOwovKjwvSUU+Ki8KCi8qIGdldFByb3BlcnR5LCBzZXRQcm9wZXJ0eSAqLwoKLyogPGx0SUU5PiAqLwp2YXIgcG9sbHV0ZXNHZXRBdHRyaWJ1dGUgPSAoZnVuY3Rpb24oZGl2KXsKCWRpdi5yYW5kb20gPSAnYXR0cmlidXRlJzsKCXJldHVybiAoZGl2LmdldEF0dHJpYnV0ZSgncmFuZG9tJykgPT0gJ2F0dHJpYnV0ZScpOwp9KShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7CgovKiA8bHRJRTk+ICovCgpFbGVtZW50LmltcGxlbWVudCh7CgoJc2V0UHJvcGVydHk6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKCQl2YXIgc2V0dGVyID0gcHJvcGVydHlTZXR0ZXJzW25hbWUudG9Mb3dlckNhc2UoKV07CgkJaWYgKHNldHRlcil7CgkJCXNldHRlcih0aGlzLCB2YWx1ZSk7CgkJfSBlbHNlIHsKCQkJLyogPGx0SUU5PiAqLwoJCQlpZiAocG9sbHV0ZXNHZXRBdHRyaWJ1dGUpIHZhciBhdHRyaWJ1dGVXaGl0ZUxpc3QgPSB0aGlzLnJldHJpZXZlKCckYXR0cmlidXRlV2hpdGVMaXN0Jywge30pOwoJCQkvKiA8L2x0SUU5PiAqLwoKCQkJaWYgKHZhbHVlID09IG51bGwpewoJCQkJdGhpcy5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CgkJCQkvKiA8bHRJRTk+ICovCgkJCQlpZiAocG9sbHV0ZXNHZXRBdHRyaWJ1dGUpIGRlbGV0ZSBhdHRyaWJ1dGVXaGl0ZUxpc3RbbmFtZV07CgkJCQkvKiA8L2x0SUU5PiAqLwoJCQl9IGVsc2UgewoJCQkJdGhpcy5zZXRBdHRyaWJ1dGUobmFtZSwgJycgKyB2YWx1ZSk7CgkJCQkvKiA8bHRJRTk+ICovCgkJCQlpZiAocG9sbHV0ZXNHZXRBdHRyaWJ1dGUpIGF0dHJpYnV0ZVdoaXRlTGlzdFtuYW1lXSA9IHRydWU7CgkJCQkvKiA8L2x0SUU5PiAqLwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbihhdHRyaWJ1dGVzKXsKCQlmb3IgKHZhciBhdHRyaWJ1dGUgaW4gYXR0cmlidXRlcykgdGhpcy5zZXRQcm9wZXJ0eShhdHRyaWJ1dGUsIGF0dHJpYnV0ZXNbYXR0cmlidXRlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFByb3BlcnR5OiBmdW5jdGlvbihuYW1lKXsKCQl2YXIgZ2V0dGVyID0gcHJvcGVydHlHZXR0ZXJzW25hbWUudG9Mb3dlckNhc2UoKV07CgkJaWYgKGdldHRlcikgcmV0dXJuIGdldHRlcih0aGlzKTsKCQkvKiA8bHRJRTk+ICovCgkJaWYgKHBvbGx1dGVzR2V0QXR0cmlidXRlKXsKCQkJdmFyIGF0dHIgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUobmFtZSksIGF0dHJpYnV0ZVdoaXRlTGlzdCA9IHRoaXMucmV0cmlldmUoJyRhdHRyaWJ1dGVXaGl0ZUxpc3QnLCB7fSk7CgkJCWlmICghYXR0cikgcmV0dXJuIG51bGw7CgkJCWlmIChhdHRyLmV4cGFuZG8gJiYgIWF0dHJpYnV0ZVdoaXRlTGlzdFtuYW1lXSl7CgkJCQl2YXIgb3V0ZXIgPSB0aGlzLm91dGVySFRNTDsKCQkJCS8vIHNlZ21lbnQgYnkgdGhlIG9wZW5pbmcgdGFnIGFuZCBmaW5kIG1lbnRpb24gb2YgYXR0cmlidXRlIG5hbWUKCQkJCWlmIChvdXRlci5zdWJzdHIoMCwgb3V0ZXIuc2VhcmNoKC9cLz9bJyJdPz4oPyFbXjxdKjxbJyJdKS8pKS5pbmRleE9mKG5hbWUpIDwgMCkgcmV0dXJuIG51bGw7CgkJCQlhdHRyaWJ1dGVXaGl0ZUxpc3RbbmFtZV0gPSB0cnVlOwoJCQl9CgkJfQoJCS8qIDwvbHRJRTk+ICovCgkJdmFyIHJlc3VsdCA9IFNsaWNrLmdldEF0dHJpYnV0ZSh0aGlzLCBuYW1lKTsKCQlyZXR1cm4gKCFyZXN1bHQgJiYgIVNsaWNrLmhhc0F0dHJpYnV0ZSh0aGlzLCBuYW1lKSkgPyBudWxsIDogcmVzdWx0OwoJfSwKCglnZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbigpewoJCXZhciBhcmdzID0gQXJyYXkuZnJvbShhcmd1bWVudHMpOwoJCXJldHVybiBhcmdzLm1hcCh0aGlzLmdldFByb3BlcnR5LCB0aGlzKS5hc3NvY2lhdGUoYXJncyk7Cgl9LAoKCXJlbW92ZVByb3BlcnR5OiBmdW5jdGlvbihuYW1lKXsKCQlyZXR1cm4gdGhpcy5zZXRQcm9wZXJ0eShuYW1lLCBudWxsKTsKCX0sCgoJcmVtb3ZlUHJvcGVydGllczogZnVuY3Rpb24oKXsKCQlBcnJheS5lYWNoKGFyZ3VtZW50cywgdGhpcy5yZW1vdmVQcm9wZXJ0eSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXNldDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuc2V0KSA/IHByb3BlcnR5LnNldC5jYWxsKHRoaXMsIHZhbHVlKSA6IHRoaXMuc2V0UHJvcGVydHkocHJvcCwgdmFsdWUpOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCWdldDogZnVuY3Rpb24ocHJvcCl7CgkJdmFyIHByb3BlcnR5ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BdOwoJCXJldHVybiAocHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0KSA/IHByb3BlcnR5LmdldC5hcHBseSh0aGlzKSA6IHRoaXMuZ2V0UHJvcGVydHkocHJvcCk7Cgl9Lm92ZXJsb2FkR2V0dGVyKCksCgoJZXJhc2U6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuZXJhc2UpID8gcHJvcGVydHkuZXJhc2UuYXBwbHkodGhpcykgOiB0aGlzLnJlbW92ZVByb3BlcnR5KHByb3ApOwoJCXJldHVybiB0aGlzOwoJfSwKCgloYXNDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlyZXR1cm4gdGhpcy5jbGFzc05hbWUuY2xlYW4oKS5jb250YWlucyhjbGFzc05hbWUsICcgJyk7Cgl9LAoKCWFkZENsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCWlmICghdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpKSB0aGlzLmNsYXNzTmFtZSA9ICh0aGlzLmNsYXNzTmFtZSArICcgJyArIGNsYXNzTmFtZSkuY2xlYW4oKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJdGhpcy5jbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZS5yZXBsYWNlKG5ldyBSZWdFeHAoJyhefFxccyknICsgY2xhc3NOYW1lICsgJyg/Olxcc3wkKScpLCAnJDEnKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSwgZm9yY2UpewoJCWlmIChmb3JjZSA9PSBudWxsKSBmb3JjZSA9ICF0aGlzLmhhc0NsYXNzKGNsYXNzTmFtZSk7CgkJcmV0dXJuIChmb3JjZSkgPyB0aGlzLmFkZENsYXNzKGNsYXNzTmFtZSkgOiB0aGlzLnJlbW92ZUNsYXNzKGNsYXNzTmFtZSk7Cgl9LAoKCWFkb3B0OiBmdW5jdGlvbigpewoJCXZhciBwYXJlbnQgPSB0aGlzLCBmcmFnbWVudCwgZWxlbWVudHMgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyksIGxlbmd0aCA9IGVsZW1lbnRzLmxlbmd0aDsKCQlpZiAobGVuZ3RoID4gMSkgcGFyZW50ID0gZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspewoJCQl2YXIgZWxlbWVudCA9IGRvY3VtZW50LmlkKGVsZW1lbnRzW2ldLCB0cnVlKTsKCQkJaWYgKGVsZW1lbnQpIHBhcmVudC5hcHBlbmRDaGlsZChlbGVtZW50KTsKCQl9CgoJCWlmIChmcmFnbWVudCkgdGhpcy5hcHBlbmRDaGlsZChmcmFnbWVudCk7CgoJCXJldHVybiB0aGlzOwoJfSwKCglhcHBlbmRUZXh0OiBmdW5jdGlvbih0ZXh0LCB3aGVyZSl7CgkJcmV0dXJuIHRoaXMuZ3JhYih0aGlzLmdldERvY3VtZW50KCkubmV3VGV4dE5vZGUodGV4dCksIHdoZXJlKTsKCX0sCgoJZ3JhYjogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQlpbnNlcnRlcnNbd2hlcmUgfHwgJ2JvdHRvbSddKGRvY3VtZW50LmlkKGVsLCB0cnVlKSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluamVjdDogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQlpbnNlcnRlcnNbd2hlcmUgfHwgJ2JvdHRvbSddKHRoaXMsIGRvY3VtZW50LmlkKGVsLCB0cnVlKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlcGxhY2VzOiBmdW5jdGlvbihlbCl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcywgZWwpOwoJCXJldHVybiB0aGlzOwoJfSwKCgl3cmFwczogZnVuY3Rpb24oZWwsIHdoZXJlKXsKCQllbCA9IGRvY3VtZW50LmlkKGVsLCB0cnVlKTsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlcyhlbCkuZ3JhYihlbCwgd2hlcmUpOwoJfSwKCglnZXRTZWxlY3RlZDogZnVuY3Rpb24oKXsKCQl0aGlzLnNlbGVjdGVkSW5kZXg7IC8vIFNhZmFyaSAzLjIuMQoJCXJldHVybiBuZXcgRWxlbWVudHMoQXJyYXkuZnJvbSh0aGlzLm9wdGlvbnMpLmZpbHRlcihmdW5jdGlvbihvcHRpb24pewoJCQlyZXR1cm4gb3B0aW9uLnNlbGVjdGVkOwoJCX0pKTsKCX0sCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24oKXsKCQl2YXIgcXVlcnlTdHJpbmcgPSBbXTsKCQl0aGlzLmdldEVsZW1lbnRzKCdpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYScpLmVhY2goZnVuY3Rpb24oZWwpewoJCQl2YXIgdHlwZSA9IGVsLnR5cGU7CgkJCWlmICghZWwubmFtZSB8fCBlbC5kaXNhYmxlZCB8fCB0eXBlID09ICdzdWJtaXQnIHx8IHR5cGUgPT0gJ3Jlc2V0JyB8fCB0eXBlID09ICdmaWxlJyB8fCB0eXBlID09ICdpbWFnZScpIHJldHVybjsKCgkJCXZhciB2YWx1ZSA9IChlbC5nZXQoJ3RhZycpID09ICdzZWxlY3QnKSA/IGVsLmdldFNlbGVjdGVkKCkubWFwKGZ1bmN0aW9uKG9wdCl7CgkJCQkvLyBJRQoJCQkJcmV0dXJuIGRvY3VtZW50LmlkKG9wdCkuZ2V0KCd2YWx1ZScpOwoJCQl9KSA6ICgodHlwZSA9PSAncmFkaW8nIHx8IHR5cGUgPT0gJ2NoZWNrYm94JykgJiYgIWVsLmNoZWNrZWQpID8gbnVsbCA6IGVsLmdldCgndmFsdWUnKTsKCgkJCUFycmF5LmZyb20odmFsdWUpLmVhY2goZnVuY3Rpb24odmFsKXsKCQkJCWlmICh0eXBlb2YgdmFsICE9ICd1bmRlZmluZWQnKSBxdWVyeVN0cmluZy5wdXNoKGVuY29kZVVSSUNvbXBvbmVudChlbC5uYW1lKSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWwpKTsKCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKdmFyIGNvbGxlY3RlZCA9IHt9LCBzdG9yYWdlID0ge307Cgp2YXIgZ2V0ID0gZnVuY3Rpb24odWlkKXsKCXJldHVybiAoc3RvcmFnZVt1aWRdIHx8IChzdG9yYWdlW3VpZF0gPSB7fSkpOwp9OwoKdmFyIGNsZWFuID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgdWlkID0gaXRlbS51bmlxdWVOdW1iZXI7CglpZiAoaXRlbS5yZW1vdmVFdmVudHMpIGl0ZW0ucmVtb3ZlRXZlbnRzKCk7CglpZiAoaXRlbS5jbGVhckF0dHJpYnV0ZXMpIGl0ZW0uY2xlYXJBdHRyaWJ1dGVzKCk7CglpZiAodWlkICE9IG51bGwpewoJCWRlbGV0ZSBjb2xsZWN0ZWRbdWlkXTsKCQlkZWxldGUgc3RvcmFnZVt1aWRdOwoJfQoJcmV0dXJuIGl0ZW07Cn07Cgp2YXIgZm9ybVByb3BzID0ge2lucHV0OiAnY2hlY2tlZCcsIG9wdGlvbjogJ3NlbGVjdGVkJywgdGV4dGFyZWE6ICd2YWx1ZSd9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWRlc3Ryb3k6IGZ1bmN0aW9uKCl7CgkJdmFyIGNoaWxkcmVuID0gY2xlYW4odGhpcykuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQlBcnJheS5lYWNoKGNoaWxkcmVuLCBjbGVhbik7CgkJRWxlbWVudC5kaXNwb3NlKHRoaXMpOwoJCXJldHVybiBudWxsOwoJfSwKCgllbXB0eTogZnVuY3Rpb24oKXsKCQlBcnJheS5mcm9tKHRoaXMuY2hpbGROb2RlcykuZWFjaChFbGVtZW50LmRpc3Bvc2UpOwoJCXJldHVybiB0aGlzOwoJfSwKCglkaXNwb3NlOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5wYXJlbnROb2RlKSA/IHRoaXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzKSA6IHRoaXM7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbihjb250ZW50cywga2VlcGlkKXsKCQljb250ZW50cyA9IGNvbnRlbnRzICE9PSBmYWxzZTsKCQl2YXIgY2xvbmUgPSB0aGlzLmNsb25lTm9kZShjb250ZW50cyksIGNlID0gW2Nsb25lXSwgdGUgPSBbdGhpc10sIGk7CgoJCWlmIChjb250ZW50cyl7CgkJCWNlLmFwcGVuZChBcnJheS5mcm9tKGNsb25lLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykpKTsKCQkJdGUuYXBwZW5kKEFycmF5LmZyb20odGhpcy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpKSk7CgkJfQoKCQlmb3IgKGkgPSBjZS5sZW5ndGg7IGktLTspewoJCQl2YXIgbm9kZSA9IGNlW2ldLCBlbGVtZW50ID0gdGVbaV07CgkJCWlmICgha2VlcGlkKSBub2RlLnJlbW92ZUF0dHJpYnV0ZSgnaWQnKTsKCQkJLyo8bHRJRTk+Ki8KCQkJaWYgKG5vZGUuY2xlYXJBdHRyaWJ1dGVzKXsKCQkJCW5vZGUuY2xlYXJBdHRyaWJ1dGVzKCk7CgkJCQlub2RlLm1lcmdlQXR0cmlidXRlcyhlbGVtZW50KTsKCQkJCW5vZGUucmVtb3ZlQXR0cmlidXRlKCd1bmlxdWVOdW1iZXInKTsKCQkJCWlmIChub2RlLm9wdGlvbnMpewoJCQkJCXZhciBubyA9IG5vZGUub3B0aW9ucywgZW8gPSBlbGVtZW50Lm9wdGlvbnM7CgkJCQkJZm9yICh2YXIgaiA9IG5vLmxlbmd0aDsgai0tOykgbm9bal0uc2VsZWN0ZWQgPSBlb1tqXS5zZWxlY3RlZDsKCQkJCX0KCQkJfQoJCQkvKjwvbHRJRTk+Ki8KCQkJdmFyIHByb3AgPSBmb3JtUHJvcHNbZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCldOwoJCQlpZiAocHJvcCAmJiBlbGVtZW50W3Byb3BdKSBub2RlW3Byb3BdID0gZWxlbWVudFtwcm9wXTsKCQl9CgoJCS8qPGx0SUU5PiovCgkJaWYgKEJyb3dzZXIuaWUpewoJCQl2YXIgY28gPSBjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0JyksIHRvID0gdGhpcy5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0Jyk7CgkJCWZvciAoaSA9IGNvLmxlbmd0aDsgaS0tOykgY29baV0ub3V0ZXJIVE1MID0gdG9baV0ub3V0ZXJIVE1MOwoJCX0KCQkvKjwvbHRJRTk+Ki8KCQlyZXR1cm4gZG9jdW1lbnQuaWQoY2xvbmUpOwoJfQoKfSk7CgpbRWxlbWVudCwgV2luZG93LCBEb2N1bWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJYWRkTGlzdGVuZXI6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQlpZiAodHlwZSA9PSAndW5sb2FkJyl7CgkJCXZhciBvbGQgPSBmbiwgc2VsZiA9IHRoaXM7CgkJCWZuID0gZnVuY3Rpb24oKXsKCQkJCXNlbGYucmVtb3ZlTGlzdGVuZXIoJ3VubG9hZCcsIGZuKTsKCQkJCW9sZCgpOwoJCQl9OwoJCX0gZWxzZSB7CgkJCWNvbGxlY3RlZFtTbGljay51aWRPZih0aGlzKV0gPSB0aGlzOwoJCX0KCQlpZiAodGhpcy5hZGRFdmVudExpc3RlbmVyKSB0aGlzLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZm4sICEhYXJndW1lbnRzWzJdKTsKCQllbHNlIHRoaXMuYXR0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlTGlzdGVuZXI6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQlpZiAodGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKSB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgZm4sICEhYXJndW1lbnRzWzJdKTsKCQllbHNlIHRoaXMuZGV0YWNoRXZlbnQoJ29uJyArIHR5cGUsIGZuKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmV0cmlldmU6IGZ1bmN0aW9uKHByb3BlcnR5LCBkZmx0KXsKCQl2YXIgc3RvcmFnZSA9IGdldChTbGljay51aWRPZih0aGlzKSksIHByb3AgPSBzdG9yYWdlW3Byb3BlcnR5XTsKCQlpZiAoZGZsdCAhPSBudWxsICYmIHByb3AgPT0gbnVsbCkgcHJvcCA9IHN0b3JhZ2VbcHJvcGVydHldID0gZGZsdDsKCQlyZXR1cm4gcHJvcCAhPSBudWxsID8gcHJvcCA6IG51bGw7Cgl9LAoKCXN0b3JlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCXZhciBzdG9yYWdlID0gZ2V0KFNsaWNrLnVpZE9mKHRoaXMpKTsKCQlzdG9yYWdlW3Byb3BlcnR5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgllbGltaW5hdGU6IGZ1bmN0aW9uKHByb3BlcnR5KXsKCQl2YXIgc3RvcmFnZSA9IGdldChTbGljay51aWRPZih0aGlzKSk7CgkJZGVsZXRlIHN0b3JhZ2VbcHJvcGVydHldOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovKjxsdElFOT4qLwppZiAod2luZG93LmF0dGFjaEV2ZW50ICYmICF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikgd2luZG93LmFkZExpc3RlbmVyKCd1bmxvYWQnLCBmdW5jdGlvbigpewoJT2JqZWN0LmVhY2goY29sbGVjdGVkLCBjbGVhbik7CglpZiAod2luZG93LkNvbGxlY3RHYXJiYWdlKSBDb2xsZWN0R2FyYmFnZSgpOwp9KTsKLyo8L2x0SUU5PiovCgpFbGVtZW50LlByb3BlcnRpZXMgPSB7fTsKCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuUHJvcGVydGllcyA9IG5ldyBIYXNoOwoKLy88LzEuMmNvbXBhdD4KCkVsZW1lbnQuUHJvcGVydGllcy5zdHlsZSA9IHsKCglzZXQ6IGZ1bmN0aW9uKHN0eWxlKXsKCQl0aGlzLnN0eWxlLmNzc1RleHQgPSBzdHlsZTsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnN0eWxlLmNzc1RleHQ7Cgl9LAoKCWVyYXNlOiBmdW5jdGlvbigpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9ICcnOwoJfQoKfTsKCkVsZW1lbnQuUHJvcGVydGllcy50YWcgPSB7CgoJZ2V0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCX0KCn07CgpFbGVtZW50LlByb3BlcnRpZXMuaHRtbCA9IHsKCglzZXQ6IGZ1bmN0aW9uKGh0bWwpewoJCWlmIChodG1sID09IG51bGwpIGh0bWwgPSAnJzsKCQllbHNlIGlmICh0eXBlT2YoaHRtbCkgPT0gJ2FycmF5JykgaHRtbCA9IGh0bWwuam9pbignJyk7CgkJdGhpcy5pbm5lckhUTUwgPSBodG1sOwoJfSwKCgllcmFzZTogZnVuY3Rpb24oKXsKCQl0aGlzLmlubmVySFRNTCA9ICcnOwoJfQoKfTsKCi8qPGx0SUU5PiovCi8vIHRlY2huaXF1ZSBieSBqZGJhcmxldHQgLSBodHRwOi8vamRiYXJ0bGV0dC5jb20vaW5uZXJzaGl2Lwp2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CmRpdi5pbm5lckhUTUwgPSAnPG5hdj48L25hdj4nOwp2YXIgc3VwcG9ydHNIVE1MNUVsZW1lbnRzID0gKGRpdi5jaGlsZE5vZGVzLmxlbmd0aCA9PSAxKTsKaWYgKCFzdXBwb3J0c0hUTUw1RWxlbWVudHMpewoJdmFyIHRhZ3MgPSAnYWJiciBhcnRpY2xlIGFzaWRlIGF1ZGlvIGNhbnZhcyBkYXRhbGlzdCBkZXRhaWxzIGZpZ2NhcHRpb24gZmlndXJlIGZvb3RlciBoZWFkZXIgaGdyb3VwIG1hcmsgbWV0ZXIgbmF2IG91dHB1dCBwcm9ncmVzcyBzZWN0aW9uIHN1bW1hcnkgdGltZSB2aWRlbycuc3BsaXQoJyAnKSwKCQlmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwgbCA9IHRhZ3MubGVuZ3RoOwoJd2hpbGUgKGwtLSkgZnJhZ21lbnQuY3JlYXRlRWxlbWVudCh0YWdzW2xdKTsKfQpkaXYgPSBudWxsOwovKjwvbHRJRTk+Ki8KCi8qPElFPiovCnZhciBzdXBwb3J0c1RhYmxlSW5uZXJIVE1MID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJdmFyIHRhYmxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGFibGUnKTsKCXRhYmxlLmlubmVySFRNTCA9ICc8dHI+PHRkPjwvdGQ+PC90cj4nOwoJcmV0dXJuIHRydWU7Cn0pOwoKLyo8bHRGRjQ+Ki8KdmFyIHRyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndHInKSwgaHRtbCA9ICc8dGQ+PC90ZD4nOwp0ci5pbm5lckhUTUwgPSBodG1sOwp2YXIgc3VwcG9ydHNUUklubmVySFRNTCA9ICh0ci5pbm5lckhUTUwgPT0gaHRtbCk7CnRyID0gbnVsbDsKLyo8L2x0RkY0PiovCgppZiAoIXN1cHBvcnRzVGFibGVJbm5lckhUTUwgfHwgIXN1cHBvcnRzVFJJbm5lckhUTUwgfHwgIXN1cHBvcnRzSFRNTDVFbGVtZW50cyl7CgoJRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwuc2V0ID0gKGZ1bmN0aW9uKHNldCl7CgoJCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJCXRhYmxlOiBbMSwgJzx0YWJsZT4nLCAnPC90YWJsZT4nXSwKCQkJc2VsZWN0OiBbMSwgJzxzZWxlY3Q+JywgJzwvc2VsZWN0PiddLAoJCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJCXRyOiBbMywgJzx0YWJsZT48dGJvZHk+PHRyPicsICc8L3RyPjwvdGJvZHk+PC90YWJsZT4nXQoJCX07CgoJCXRyYW5zbGF0aW9ucy50aGVhZCA9IHRyYW5zbGF0aW9ucy50Zm9vdCA9IHRyYW5zbGF0aW9ucy50Ym9keTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGh0bWwpewoJCQl2YXIgd3JhcCA9IHRyYW5zbGF0aW9uc1t0aGlzLmdldCgndGFnJyldOwoJCQlpZiAoIXdyYXAgJiYgIXN1cHBvcnRzSFRNTDVFbGVtZW50cykgd3JhcCA9IFswLCAnJywgJyddOwoJCQlpZiAoIXdyYXApIHJldHVybiBzZXQuY2FsbCh0aGlzLCBodG1sKTsKCgkJCXZhciBsZXZlbCA9IHdyYXBbMF0sIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwgdGFyZ2V0ID0gd3JhcHBlcjsKCQkJaWYgKCFzdXBwb3J0c0hUTUw1RWxlbWVudHMpIGZyYWdtZW50LmFwcGVuZENoaWxkKHdyYXBwZXIpOwoJCQl3cmFwcGVyLmlubmVySFRNTCA9IFt3cmFwWzFdLCBodG1sLCB3cmFwWzJdXS5mbGF0dGVuKCkuam9pbignJyk7CgkJCXdoaWxlIChsZXZlbC0tKSB0YXJnZXQgPSB0YXJnZXQuZmlyc3RDaGlsZDsKCQkJdGhpcy5lbXB0eSgpLmFkb3B0KHRhcmdldC5jaGlsZE5vZGVzKTsKCQkJaWYgKCFzdXBwb3J0c0hUTUw1RWxlbWVudHMpIGZyYWdtZW50LnJlbW92ZUNoaWxkKHdyYXBwZXIpOwoJCQl3cmFwcGVyID0gbnVsbDsKCQl9OwoKCX0pKEVsZW1lbnQuUHJvcGVydGllcy5odG1sLnNldCk7Cn0KLyo8L0lFPiovCgovKjxsdElFOT4qLwp2YXIgdGVzdEZvcm0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdmb3JtJyk7CnRlc3RGb3JtLmlubmVySFRNTCA9ICc8c2VsZWN0PjxvcHRpb24+czwvb3B0aW9uPjwvc2VsZWN0Pic7CgppZiAodGVzdEZvcm0uZmlyc3RDaGlsZC52YWx1ZSAhPSAncycpIEVsZW1lbnQuUHJvcGVydGllcy52YWx1ZSA9IHsKCglzZXQ6IGZ1bmN0aW9uKHZhbHVlKXsKCQl2YXIgdGFnID0gdGhpcy5nZXQoJ3RhZycpOwoJCWlmICh0YWcgIT0gJ3NlbGVjdCcpIHJldHVybiB0aGlzLnNldFByb3BlcnR5KCd2YWx1ZScsIHZhbHVlKTsKCQl2YXIgb3B0aW9ucyA9IHRoaXMuZ2V0RWxlbWVudHMoJ29wdGlvbicpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgb3B0aW9ucy5sZW5ndGg7IGkrKyl7CgkJCXZhciBvcHRpb24gPSBvcHRpb25zW2ldLAoJCQkJYXR0ciA9IG9wdGlvbi5nZXRBdHRyaWJ1dGVOb2RlKCd2YWx1ZScpLAoJCQkJb3B0aW9uVmFsdWUgPSAoYXR0ciAmJiBhdHRyLnNwZWNpZmllZCkgPyBvcHRpb24udmFsdWUgOiBvcHRpb24uZ2V0KCd0ZXh0Jyk7CgkJCWlmIChvcHRpb25WYWx1ZSA9PSB2YWx1ZSkgcmV0dXJuIG9wdGlvbi5zZWxlY3RlZCA9IHRydWU7CgkJfQoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG9wdGlvbiA9IHRoaXMsIHRhZyA9IG9wdGlvbi5nZXQoJ3RhZycpOwoKCQlpZiAodGFnICE9ICdzZWxlY3QnICYmIHRhZyAhPSAnb3B0aW9uJykgcmV0dXJuIHRoaXMuZ2V0UHJvcGVydHkoJ3ZhbHVlJyk7CgoJCWlmICh0YWcgPT0gJ3NlbGVjdCcgJiYgIShvcHRpb24gPSBvcHRpb24uZ2V0U2VsZWN0ZWQoKVswXSkpIHJldHVybiAnJzsKCgkJdmFyIGF0dHIgPSBvcHRpb24uZ2V0QXR0cmlidXRlTm9kZSgndmFsdWUnKTsKCQlyZXR1cm4gKGF0dHIgJiYgYXR0ci5zcGVjaWZpZWQpID8gb3B0aW9uLnZhbHVlIDogb3B0aW9uLmdldCgndGV4dCcpOwoJfQoKfTsKdGVzdEZvcm0gPSBudWxsOwovKjwvbHRJRTk+Ki8KCi8qPElFPiovCmlmIChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKS5nZXRBdHRyaWJ1dGVOb2RlKCdpZCcpKSBFbGVtZW50LlByb3BlcnRpZXMuaWQgPSB7CglzZXQ6IGZ1bmN0aW9uKGlkKXsKCQl0aGlzLmlkID0gdGhpcy5nZXRBdHRyaWJ1dGVOb2RlKCdpZCcpLnZhbHVlID0gaWQ7Cgl9LAoJZ2V0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmlkIHx8IG51bGw7Cgl9LAoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5pZCA9IHRoaXMuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS52YWx1ZSA9ICcnOwoJfQp9OwovKjwvSUU+Ki8KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LlN0eWxlCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgbWV0aG9kcyBmb3IgaW50ZXJhY3Rpbmcgd2l0aCB0aGUgc3R5bGVzIG9mIEVsZW1lbnRzIGluIGEgZmFzaGlvbmFibGUgd2F5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogRWxlbWVudAoKcHJvdmlkZXM6IEVsZW1lbnQuU3R5bGUKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaHRtbCA9IGRvY3VtZW50Lmh0bWw7CgovLzxsdElFOT4KLy8gQ2hlY2sgZm9yIG9sZElFLCB3aGljaCBkb2VzIG5vdCByZW1vdmUgc3R5bGVzIHdoZW4gdGhleSdyZSBzZXQgdG8gbnVsbAp2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKZWwuc3R5bGUuY29sb3IgPSAncmVkJzsKZWwuc3R5bGUuY29sb3IgPSBudWxsOwp2YXIgZG9lc05vdFJlbW92ZVN0eWxlcyA9IGVsLnN0eWxlLmNvbG9yID09ICdyZWQnOwplbCA9IG51bGw7Ci8vPC9sdElFOT4KCkVsZW1lbnQuUHJvcGVydGllcy5zdHlsZXMgPSB7c2V0OiBmdW5jdGlvbihzdHlsZXMpewoJdGhpcy5zZXRTdHlsZXMoc3R5bGVzKTsKfX07Cgp2YXIgaGFzT3BhY2l0eSA9IChodG1sLnN0eWxlLm9wYWNpdHkgIT0gbnVsbCksCgloYXNGaWx0ZXIgPSAoaHRtbC5zdHlsZS5maWx0ZXIgIT0gbnVsbCksCglyZUFscGhhID0gL2FscGhhXChvcGFjaXR5PShbXGQuXSspXCkvaTsKCnZhciBzZXRWaXNpYmlsaXR5ID0gZnVuY3Rpb24oZWxlbWVudCwgb3BhY2l0eSl7CgllbGVtZW50LnN0b3JlKCckb3BhY2l0eScsIG9wYWNpdHkpOwoJZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gb3BhY2l0eSA+IDAgfHwgb3BhY2l0eSA9PSBudWxsID8gJ3Zpc2libGUnIDogJ2hpZGRlbic7Cn07Cgp2YXIgc2V0T3BhY2l0eSA9IChoYXNPcGFjaXR5ID8gZnVuY3Rpb24oZWxlbWVudCwgb3BhY2l0eSl7CgllbGVtZW50LnN0eWxlLm9wYWNpdHkgPSBvcGFjaXR5Owp9IDogKGhhc0ZpbHRlciA/IGZ1bmN0aW9uKGVsZW1lbnQsIG9wYWNpdHkpewoJdmFyIHN0eWxlID0gZWxlbWVudC5zdHlsZTsKCWlmICghZWxlbWVudC5jdXJyZW50U3R5bGUgfHwgIWVsZW1lbnQuY3VycmVudFN0eWxlLmhhc0xheW91dCkgc3R5bGUuem9vbSA9IDE7CglpZiAob3BhY2l0eSA9PSBudWxsIHx8IG9wYWNpdHkgPT0gMSkgb3BhY2l0eSA9ICcnOwoJZWxzZSBvcGFjaXR5ID0gJ2FscGhhKG9wYWNpdHk9JyArIChvcGFjaXR5ICogMTAwKS5saW1pdCgwLCAxMDApLnJvdW5kKCkgKyAnKSc7Cgl2YXIgZmlsdGVyID0gc3R5bGUuZmlsdGVyIHx8IGVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZSgnZmlsdGVyJykgfHwgJyc7CglzdHlsZS5maWx0ZXIgPSByZUFscGhhLnRlc3QoZmlsdGVyKSA/IGZpbHRlci5yZXBsYWNlKHJlQWxwaGEsIG9wYWNpdHkpIDogZmlsdGVyICsgb3BhY2l0eTsKCWlmICghc3R5bGUuZmlsdGVyKSBzdHlsZS5yZW1vdmVBdHRyaWJ1dGUoJ2ZpbHRlcicpOwp9IDogc2V0VmlzaWJpbGl0eSkpOwoKdmFyIGdldE9wYWNpdHkgPSAoaGFzT3BhY2l0eSA/IGZ1bmN0aW9uKGVsZW1lbnQpewoJdmFyIG9wYWNpdHkgPSBlbGVtZW50LnN0eWxlLm9wYWNpdHkgfHwgZWxlbWVudC5nZXRDb21wdXRlZFN0eWxlKCdvcGFjaXR5Jyk7CglyZXR1cm4gKG9wYWNpdHkgPT0gJycpID8gMSA6IG9wYWNpdHkudG9GbG9hdCgpOwp9IDogKGhhc0ZpbHRlciA/IGZ1bmN0aW9uKGVsZW1lbnQpewoJdmFyIGZpbHRlciA9IChlbGVtZW50LnN0eWxlLmZpbHRlciB8fCBlbGVtZW50LmdldENvbXB1dGVkU3R5bGUoJ2ZpbHRlcicpKSwKCQlvcGFjaXR5OwoJaWYgKGZpbHRlcikgb3BhY2l0eSA9IGZpbHRlci5tYXRjaChyZUFscGhhKTsKCXJldHVybiAob3BhY2l0eSA9PSBudWxsIHx8IGZpbHRlciA9PSBudWxsKSA/IDEgOiAob3BhY2l0eVsxXSAvIDEwMCk7Cn0gOiBmdW5jdGlvbihlbGVtZW50KXsKCXZhciBvcGFjaXR5ID0gZWxlbWVudC5yZXRyaWV2ZSgnJG9wYWNpdHknKTsKCWlmIChvcGFjaXR5ID09IG51bGwpIG9wYWNpdHkgPSAoZWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID09ICdoaWRkZW4nID8gMCA6IDEpOwoJcmV0dXJuIG9wYWNpdHk7Cn0pKTsKCnZhciBmbG9hdE5hbWUgPSAoaHRtbC5zdHlsZS5jc3NGbG9hdCA9PSBudWxsKSA/ICdzdHlsZUZsb2F0JyA6ICdjc3NGbG9hdCc7CgpFbGVtZW50LmltcGxlbWVudCh7CgoJZ2V0Q29tcHV0ZWRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmICh0aGlzLmN1cnJlbnRTdHlsZSkgcmV0dXJuIHRoaXMuY3VycmVudFN0eWxlW3Byb3BlcnR5LmNhbWVsQ2FzZSgpXTsKCQl2YXIgZGVmYXVsdFZpZXcgPSBFbGVtZW50LmdldERvY3VtZW50KHRoaXMpLmRlZmF1bHRWaWV3LAoJCQljb21wdXRlZCA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCBudWxsKSA6IG51bGw7CgkJcmV0dXJuIChjb21wdXRlZCkgPyBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKChwcm9wZXJ0eSA9PSBmbG9hdE5hbWUpID8gJ2Zsb2F0JyA6IHByb3BlcnR5Lmh5cGhlbmF0ZSgpKSA6IG51bGw7Cgl9LAoKCXNldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCWlmIChwcm9wZXJ0eSA9PSAnb3BhY2l0eScpewoJCQlpZiAodmFsdWUgIT0gbnVsbCkgdmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTsKCQkJc2V0T3BhY2l0eSh0aGlzLCB2YWx1ZSk7CgkJCXJldHVybiB0aGlzOwoJCX0KCQlwcm9wZXJ0eSA9IChwcm9wZXJ0eSA9PSAnZmxvYXQnID8gZmxvYXROYW1lIDogcHJvcGVydHkpLmNhbWVsQ2FzZSgpOwoJCWlmICh0eXBlT2YodmFsdWUpICE9ICdzdHJpbmcnKXsKCQkJdmFyIG1hcCA9IChFbGVtZW50LlN0eWxlc1twcm9wZXJ0eV0gfHwgJ0AnKS5zcGxpdCgnICcpOwoJCQl2YWx1ZSA9IEFycmF5LmZyb20odmFsdWUpLm1hcChmdW5jdGlvbih2YWwsIGkpewoJCQkJaWYgKCFtYXBbaV0pIHJldHVybiAnJzsKCQkJCXJldHVybiAodHlwZU9mKHZhbCkgPT0gJ251bWJlcicpID8gbWFwW2ldLnJlcGxhY2UoJ0AnLCBNYXRoLnJvdW5kKHZhbCkpIDogdmFsOwoJCQl9KS5qb2luKCcgJyk7CgkJfSBlbHNlIGlmICh2YWx1ZSA9PSBTdHJpbmcoTnVtYmVyKHZhbHVlKSkpewoJCQl2YWx1ZSA9IE1hdGgucm91bmQodmFsdWUpOwoJCX0KCQl0aGlzLnN0eWxlW3Byb3BlcnR5XSA9IHZhbHVlOwoJCS8vPGx0SUU5PgoJCWlmICgodmFsdWUgPT0gJycgfHwgdmFsdWUgPT0gbnVsbCkgJiYgZG9lc05vdFJlbW92ZVN0eWxlcyAmJiB0aGlzLnN0eWxlLnJlbW92ZUF0dHJpYnV0ZSl7CgkJCXRoaXMuc3R5bGUucmVtb3ZlQXR0cmlidXRlKHByb3BlcnR5KTsKCQl9CgkJLy88L2x0SUU5PgoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmIChwcm9wZXJ0eSA9PSAnb3BhY2l0eScpIHJldHVybiBnZXRPcGFjaXR5KHRoaXMpOwoJCXByb3BlcnR5ID0gKHByb3BlcnR5ID09ICdmbG9hdCcgPyBmbG9hdE5hbWUgOiBwcm9wZXJ0eSkuY2FtZWxDYXNlKCk7CgkJdmFyIHJlc3VsdCA9IHRoaXMuc3R5bGVbcHJvcGVydHldOwoJCWlmICghcmVzdWx0IHx8IHByb3BlcnR5ID09ICd6SW5kZXgnKXsKCQkJcmVzdWx0ID0gW107CgkJCWZvciAodmFyIHN0eWxlIGluIEVsZW1lbnQuU2hvcnRTdHlsZXMpewoJCQkJaWYgKHByb3BlcnR5ICE9IHN0eWxlKSBjb250aW51ZTsKCQkJCWZvciAodmFyIHMgaW4gRWxlbWVudC5TaG9ydFN0eWxlc1tzdHlsZV0pIHJlc3VsdC5wdXNoKHRoaXMuZ2V0U3R5bGUocykpOwoJCQkJcmV0dXJuIHJlc3VsdC5qb2luKCcgJyk7CgkJCX0KCQkJcmVzdWx0ID0gdGhpcy5nZXRDb21wdXRlZFN0eWxlKHByb3BlcnR5KTsKCQl9CgkJaWYgKHJlc3VsdCl7CgkJCXJlc3VsdCA9IFN0cmluZyhyZXN1bHQpOwoJCQl2YXIgY29sb3IgPSByZXN1bHQubWF0Y2goL3JnYmE/XChbXGRccyxdK1wpLyk7CgkJCWlmIChjb2xvcikgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoY29sb3JbMF0sIGNvbG9yWzBdLnJnYlRvSGV4KCkpOwoJCX0KCQlpZiAoQnJvd3Nlci5vcGVyYSB8fCBCcm93c2VyLmllKXsKCQkJaWYgKCgvXihoZWlnaHR8d2lkdGgpJC8pLnRlc3QocHJvcGVydHkpICYmICEoL3B4JC8udGVzdChyZXN1bHQpKSl7CgkJCQl2YXIgdmFsdWVzID0gKHByb3BlcnR5ID09ICd3aWR0aCcpID8gWydsZWZ0JywgJ3JpZ2h0J10gOiBbJ3RvcCcsICdib3R0b20nXSwgc2l6ZSA9IDA7CgkJCQl2YWx1ZXMuZWFjaChmdW5jdGlvbih2YWx1ZSl7CgkJCQkJc2l6ZSArPSB0aGlzLmdldFN0eWxlKCdib3JkZXItJyArIHZhbHVlICsgJy13aWR0aCcpLnRvSW50KCkgKyB0aGlzLmdldFN0eWxlKCdwYWRkaW5nLScgKyB2YWx1ZSkudG9JbnQoKTsKCQkJCX0sIHRoaXMpOwoJCQkJcmV0dXJuIHRoaXNbJ29mZnNldCcgKyBwcm9wZXJ0eS5jYXBpdGFsaXplKCldIC0gc2l6ZSArICdweCc7CgkJCX0KCQkJaWYgKEJyb3dzZXIuaWUgJiYgKC9eYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nLykudGVzdChwcm9wZXJ0eSkgJiYgaXNOYU4ocGFyc2VGbG9hdChyZXN1bHQpKSl7CgkJCQlyZXR1cm4gJzBweCc7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJc2V0U3R5bGVzOiBmdW5jdGlvbihzdHlsZXMpewoJCWZvciAodmFyIHN0eWxlIGluIHN0eWxlcykgdGhpcy5zZXRTdHlsZShzdHlsZSwgc3R5bGVzW3N0eWxlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlczogZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0ID0ge307CgkJQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLmVhY2goZnVuY3Rpb24oa2V5KXsKCQkJcmVzdWx0W2tleV0gPSB0aGlzLmdldFN0eWxlKGtleSk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHJlc3VsdDsKCX0KCn0pOwoKRWxlbWVudC5TdHlsZXMgPSB7CglsZWZ0OiAnQHB4JywgdG9wOiAnQHB4JywgYm90dG9tOiAnQHB4JywgcmlnaHQ6ICdAcHgnLAoJd2lkdGg6ICdAcHgnLCBoZWlnaHQ6ICdAcHgnLCBtYXhXaWR0aDogJ0BweCcsIG1heEhlaWdodDogJ0BweCcsIG1pbldpZHRoOiAnQHB4JywgbWluSGVpZ2h0OiAnQHB4JywKCWJhY2tncm91bmRDb2xvcjogJ3JnYihALCBALCBAKScsIGJhY2tncm91bmRQb3NpdGlvbjogJ0BweCBAcHgnLCBjb2xvcjogJ3JnYihALCBALCBAKScsCglmb250U2l6ZTogJ0BweCcsIGxldHRlclNwYWNpbmc6ICdAcHgnLCBsaW5lSGVpZ2h0OiAnQHB4JywgY2xpcDogJ3JlY3QoQHB4IEBweCBAcHggQHB4KScsCgltYXJnaW46ICdAcHggQHB4IEBweCBAcHgnLCBwYWRkaW5nOiAnQHB4IEBweCBAcHggQHB4JywgYm9yZGVyOiAnQHB4IEAgcmdiKEAsIEAsIEApIEBweCBAIHJnYihALCBALCBAKSBAcHggQCByZ2IoQCwgQCwgQCknLAoJYm9yZGVyV2lkdGg6ICdAcHggQHB4IEBweCBAcHgnLCBib3JkZXJTdHlsZTogJ0AgQCBAIEAnLCBib3JkZXJDb2xvcjogJ3JnYihALCBALCBAKSByZ2IoQCwgQCwgQCkgcmdiKEAsIEAsIEApIHJnYihALCBALCBAKScsCgl6SW5kZXg6ICdAJywgJ3pvb20nOiAnQCcsIGZvbnRXZWlnaHQ6ICdAJywgdGV4dEluZGVudDogJ0BweCcsIG9wYWNpdHk6ICdAJwp9OwoKLy88MS4zY29tcGF0PgoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNldE9wYWNpdHk6IGZ1bmN0aW9uKHZhbHVlKXsKCQlzZXRPcGFjaXR5KHRoaXMsIHZhbHVlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0T3BhY2l0eTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gZ2V0T3BhY2l0eSh0aGlzKTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLm9wYWNpdHkgPSB7CgoJc2V0OiBmdW5jdGlvbihvcGFjaXR5KXsKCQlzZXRPcGFjaXR5KHRoaXMsIG9wYWNpdHkpOwoJCXNldFZpc2liaWxpdHkodGhpcywgb3BhY2l0eSk7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gZ2V0T3BhY2l0eSh0aGlzKTsKCX0KCn07CgovLzwvMS4zY29tcGF0PgoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5TdHlsZXMgPSBuZXcgSGFzaChFbGVtZW50LlN0eWxlcyk7CgovLzwvMS4yY29tcGF0PgoKRWxlbWVudC5TaG9ydFN0eWxlcyA9IHttYXJnaW46IHt9LCBwYWRkaW5nOiB7fSwgYm9yZGVyOiB7fSwgYm9yZGVyV2lkdGg6IHt9LCBib3JkZXJTdHlsZToge30sIGJvcmRlckNvbG9yOiB7fX07CgpbJ1RvcCcsICdSaWdodCcsICdCb3R0b20nLCAnTGVmdCddLmVhY2goZnVuY3Rpb24oZGlyZWN0aW9uKXsKCXZhciBTaG9ydCA9IEVsZW1lbnQuU2hvcnRTdHlsZXM7Cgl2YXIgQWxsID0gRWxlbWVudC5TdHlsZXM7CglbJ21hcmdpbicsICdwYWRkaW5nJ10uZWFjaChmdW5jdGlvbihzdHlsZSl7CgkJdmFyIHNkID0gc3R5bGUgKyBkaXJlY3Rpb247CgkJU2hvcnRbc3R5bGVdW3NkXSA9IEFsbFtzZF0gPSAnQHB4JzsKCX0pOwoJdmFyIGJkID0gJ2JvcmRlcicgKyBkaXJlY3Rpb247CglTaG9ydC5ib3JkZXJbYmRdID0gQWxsW2JkXSA9ICdAcHggQCByZ2IoQCwgQCwgQCknOwoJdmFyIGJkdyA9IGJkICsgJ1dpZHRoJywgYmRzID0gYmQgKyAnU3R5bGUnLCBiZGMgPSBiZCArICdDb2xvcic7CglTaG9ydFtiZF0gPSB7fTsKCVNob3J0LmJvcmRlcldpZHRoW2Jkd10gPSBTaG9ydFtiZF1bYmR3XSA9IEFsbFtiZHddID0gJ0BweCc7CglTaG9ydC5ib3JkZXJTdHlsZVtiZHNdID0gU2hvcnRbYmRdW2Jkc10gPSBBbGxbYmRzXSA9ICdAJzsKCVNob3J0LmJvcmRlckNvbG9yW2JkY10gPSBTaG9ydFtiZF1bYmRjXSA9IEFsbFtiZGNdID0gJ3JnYihALCBALCBAKSc7Cn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IEVsZW1lbnQuRXZlbnQKCmRlc2NyaXB0aW9uOiBDb250YWlucyBFbGVtZW50IG1ldGhvZHMgZm9yIGRlYWxpbmcgd2l0aCBldmVudHMuIFRoaXMgZmlsZSBhbHNvIGluY2x1ZGVzIG1vdXNlZW50ZXIgYW5kIG1vdXNlbGVhdmUgY3VzdG9tIEVsZW1lbnQgRXZlbnRzLCBpZiBuZWNlc3NhcnkuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgRXZlbnRdCgpwcm92aWRlczogRWxlbWVudC5FdmVudAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCkVsZW1lbnQuUHJvcGVydGllcy5ldmVudHMgPSB7c2V0OiBmdW5jdGlvbihldmVudHMpewoJdGhpcy5hZGRFdmVudHMoZXZlbnRzKTsKfX07CgpbRWxlbWVudCwgV2luZG93LCBEb2N1bWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl2YXIgZXZlbnRzID0gdGhpcy5yZXRyaWV2ZSgnZXZlbnRzJywge30pOwoJCWlmICghZXZlbnRzW3R5cGVdKSBldmVudHNbdHlwZV0gPSB7a2V5czogW10sIHZhbHVlczogW119OwoJCWlmIChldmVudHNbdHlwZV0ua2V5cy5jb250YWlucyhmbikpIHJldHVybiB0aGlzOwoJCWV2ZW50c1t0eXBlXS5rZXlzLnB1c2goZm4pOwoJCXZhciByZWFsVHlwZSA9IHR5cGUsCgkJCWN1c3RvbSA9IEVsZW1lbnQuRXZlbnRzW3R5cGVdLAoJCQljb25kaXRpb24gPSBmbiwKCQkJc2VsZiA9IHRoaXM7CgkJaWYgKGN1c3RvbSl7CgkJCWlmIChjdXN0b20ub25BZGQpIGN1c3RvbS5vbkFkZC5jYWxsKHRoaXMsIGZuLCB0eXBlKTsKCQkJaWYgKGN1c3RvbS5jb25kaXRpb24pewoJCQkJY29uZGl0aW9uID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJCWlmIChjdXN0b20uY29uZGl0aW9uLmNhbGwodGhpcywgZXZlbnQsIHR5cGUpKSByZXR1cm4gZm4uY2FsbCh0aGlzLCBldmVudCk7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9OwoJCQl9CgkJCWlmIChjdXN0b20uYmFzZSkgcmVhbFR5cGUgPSBGdW5jdGlvbi5mcm9tKGN1c3RvbS5iYXNlKS5jYWxsKHRoaXMsIHR5cGUpOwoJCX0KCQl2YXIgZGVmbiA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmbi5jYWxsKHNlbGYpOwoJCX07CgkJdmFyIG5hdGl2ZUV2ZW50ID0gRWxlbWVudC5OYXRpdmVFdmVudHNbcmVhbFR5cGVdOwoJCWlmIChuYXRpdmVFdmVudCl7CgkJCWlmIChuYXRpdmVFdmVudCA9PSAyKXsKCQkJCWRlZm4gPSBmdW5jdGlvbihldmVudCl7CgkJCQkJZXZlbnQgPSBuZXcgRE9NRXZlbnQoZXZlbnQsIHNlbGYuZ2V0V2luZG93KCkpOwoJCQkJCWlmIChjb25kaXRpb24uY2FsbChzZWxmLCBldmVudCkgPT09IGZhbHNlKSBldmVudC5zdG9wKCk7CgkJCQl9OwoJCQl9CgkJCXRoaXMuYWRkTGlzdGVuZXIocmVhbFR5cGUsIGRlZm4sIGFyZ3VtZW50c1syXSk7CgkJfQoJCWV2ZW50c1t0eXBlXS52YWx1ZXMucHVzaChkZWZuKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl2YXIgZXZlbnRzID0gdGhpcy5yZXRyaWV2ZSgnZXZlbnRzJyk7CgkJaWYgKCFldmVudHMgfHwgIWV2ZW50c1t0eXBlXSkgcmV0dXJuIHRoaXM7CgkJdmFyIGxpc3QgPSBldmVudHNbdHlwZV07CgkJdmFyIGluZGV4ID0gbGlzdC5rZXlzLmluZGV4T2YoZm4pOwoJCWlmIChpbmRleCA9PSAtMSkgcmV0dXJuIHRoaXM7CgkJdmFyIHZhbHVlID0gbGlzdC52YWx1ZXNbaW5kZXhdOwoJCWRlbGV0ZSBsaXN0LmtleXNbaW5kZXhdOwoJCWRlbGV0ZSBsaXN0LnZhbHVlc1tpbmRleF07CgkJdmFyIGN1c3RvbSA9IEVsZW1lbnQuRXZlbnRzW3R5cGVdOwoJCWlmIChjdXN0b20pewoJCQlpZiAoY3VzdG9tLm9uUmVtb3ZlKSBjdXN0b20ub25SZW1vdmUuY2FsbCh0aGlzLCBmbiwgdHlwZSk7CgkJCWlmIChjdXN0b20uYmFzZSkgdHlwZSA9IEZ1bmN0aW9uLmZyb20oY3VzdG9tLmJhc2UpLmNhbGwodGhpcywgdHlwZSk7CgkJfQoJCXJldHVybiAoRWxlbWVudC5OYXRpdmVFdmVudHNbdHlwZV0pID8gdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCB2YWx1ZSwgYXJndW1lbnRzWzJdKSA6IHRoaXM7Cgl9LAoKCWFkZEV2ZW50czogZnVuY3Rpb24oZXZlbnRzKXsKCQlmb3IgKHZhciBldmVudCBpbiBldmVudHMpIHRoaXMuYWRkRXZlbnQoZXZlbnQsIGV2ZW50c1tldmVudF0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJdmFyIGF0dGFjaGVkID0gdGhpcy5yZXRyaWV2ZSgnZXZlbnRzJyk7CgkJaWYgKCFhdHRhY2hlZCkgcmV0dXJuIHRoaXM7CgkJaWYgKCFldmVudHMpewoJCQlmb3IgKHR5cGUgaW4gYXR0YWNoZWQpIHRoaXMucmVtb3ZlRXZlbnRzKHR5cGUpOwoJCQl0aGlzLmVsaW1pbmF0ZSgnZXZlbnRzJyk7CgkJfSBlbHNlIGlmIChhdHRhY2hlZFtldmVudHNdKXsKCQkJYXR0YWNoZWRbZXZlbnRzXS5rZXlzLmVhY2goZnVuY3Rpb24oZm4pewoJCQkJdGhpcy5yZW1vdmVFdmVudChldmVudHMsIGZuKTsKCQkJfSwgdGhpcyk7CgkJCWRlbGV0ZSBhdHRhY2hlZFtldmVudHNdOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJZmlyZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBhcmdzLCBkZWxheSl7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghZXZlbnRzIHx8ICFldmVudHNbdHlwZV0pIHJldHVybiB0aGlzOwoJCWFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoKCQlldmVudHNbdHlwZV0ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJaWYgKGRlbGF5KSBmbi5kZWxheShkZWxheSwgdGhpcywgYXJncyk7CgkJCWVsc2UgZm4uYXBwbHkodGhpcywgYXJncyk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNsb25lRXZlbnRzOiBmdW5jdGlvbihmcm9tLCB0eXBlKXsKCQlmcm9tID0gZG9jdW1lbnQuaWQoZnJvbSk7CgkJdmFyIGV2ZW50cyA9IGZyb20ucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghZXZlbnRzKSByZXR1cm4gdGhpczsKCQlpZiAoIXR5cGUpewoJCQlmb3IgKHZhciBldmVudFR5cGUgaW4gZXZlbnRzKSB0aGlzLmNsb25lRXZlbnRzKGZyb20sIGV2ZW50VHlwZSk7CgkJfSBlbHNlIGlmIChldmVudHNbdHlwZV0pewoJCQlldmVudHNbdHlwZV0ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMuYWRkRXZlbnQodHlwZSwgZm4pOwoJCQl9LCB0aGlzKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkVsZW1lbnQuTmF0aXZlRXZlbnRzID0gewoJY2xpY2s6IDIsIGRibGNsaWNrOiAyLCBtb3VzZXVwOiAyLCBtb3VzZWRvd246IDIsIGNvbnRleHRtZW51OiAyLCAvL21vdXNlIGJ1dHRvbnMKCW1vdXNld2hlZWw6IDIsIERPTU1vdXNlU2Nyb2xsOiAyLCAvL21vdXNlIHdoZWVsCgltb3VzZW92ZXI6IDIsIG1vdXNlb3V0OiAyLCBtb3VzZW1vdmU6IDIsIHNlbGVjdHN0YXJ0OiAyLCBzZWxlY3RlbmQ6IDIsIC8vbW91c2UgbW92ZW1lbnQKCWtleWRvd246IDIsIGtleXByZXNzOiAyLCBrZXl1cDogMiwgLy9rZXlib2FyZAoJb3JpZW50YXRpb25jaGFuZ2U6IDIsIC8vIG1vYmlsZQoJdG91Y2hzdGFydDogMiwgdG91Y2htb3ZlOiAyLCB0b3VjaGVuZDogMiwgdG91Y2hjYW5jZWw6IDIsIC8vIHRvdWNoCglnZXN0dXJlc3RhcnQ6IDIsIGdlc3R1cmVjaGFuZ2U6IDIsIGdlc3R1cmVlbmQ6IDIsIC8vIGdlc3R1cmUKCWZvY3VzOiAyLCBibHVyOiAyLCBjaGFuZ2U6IDIsIHJlc2V0OiAyLCBzZWxlY3Q6IDIsIHN1Ym1pdDogMiwgcGFzdGU6IDIsIGlucHV0OiAyLCAvL2Zvcm0gZWxlbWVudHMKCWxvYWQ6IDIsIHVubG9hZDogMSwgYmVmb3JldW5sb2FkOiAyLCByZXNpemU6IDEsIG1vdmU6IDEsIERPTUNvbnRlbnRMb2FkZWQ6IDEsIHJlYWR5c3RhdGVjaGFuZ2U6IDEsIC8vd2luZG93CgllcnJvcjogMSwgYWJvcnQ6IDEsIHNjcm9sbDogMSAvL21pc2MKfTsKCkVsZW1lbnQuRXZlbnRzID0ge21vdXNld2hlZWw6IHsKCWJhc2U6IChCcm93c2VyLmZpcmVmb3gpID8gJ0RPTU1vdXNlU2Nyb2xsJyA6ICdtb3VzZXdoZWVsJwp9fTsKCmlmICgnb25tb3VzZWVudGVyJyBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpewoJRWxlbWVudC5OYXRpdmVFdmVudHMubW91c2VlbnRlciA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzLm1vdXNlbGVhdmUgPSAyOwp9IGVsc2UgewoJdmFyIGNoZWNrID0gZnVuY3Rpb24oZXZlbnQpewoJCXZhciByZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldDsKCQlpZiAocmVsYXRlZCA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKCQlpZiAoIXJlbGF0ZWQpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gKHJlbGF0ZWQgIT0gdGhpcyAmJiByZWxhdGVkLnByZWZpeCAhPSAneHVsJyAmJiB0eXBlT2YodGhpcykgIT0gJ2RvY3VtZW50JyAmJiAhdGhpcy5jb250YWlucyhyZWxhdGVkKSk7Cgl9OwoKCUVsZW1lbnQuRXZlbnRzLm1vdXNlZW50ZXIgPSB7CgkJYmFzZTogJ21vdXNlb3ZlcicsCgkJY29uZGl0aW9uOiBjaGVjawoJfTsKCglFbGVtZW50LkV2ZW50cy5tb3VzZWxlYXZlID0gewoJCWJhc2U6ICdtb3VzZW91dCcsCgkJY29uZGl0aW9uOiBjaGVjawoJfTsKfQoKLyo8bHRJRTk+Ki8KaWYgKCF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcil7CglFbGVtZW50Lk5hdGl2ZUV2ZW50cy5wcm9wZXJ0eWNoYW5nZSA9IDI7CglFbGVtZW50LkV2ZW50cy5jaGFuZ2UgPSB7CgkJYmFzZTogZnVuY3Rpb24oKXsKCQkJdmFyIHR5cGUgPSB0aGlzLnR5cGU7CgkJCXJldHVybiAodGhpcy5nZXQoJ3RhZycpID09ICdpbnB1dCcgJiYgKHR5cGUgPT0gJ3JhZGlvJyB8fCB0eXBlID09ICdjaGVja2JveCcpKSA/ICdwcm9wZXJ0eWNoYW5nZScgOiAnY2hhbmdlJwoJCX0sCgkJY29uZGl0aW9uOiBmdW5jdGlvbihldmVudCl7CgkJCXJldHVybiB0aGlzLnR5cGUgIT0gJ3JhZGlvJyB8fCAoZXZlbnQuZXZlbnQucHJvcGVydHlOYW1lID09ICdjaGVja2VkJyAmJiB0aGlzLmNoZWNrZWQpOwoJCX0KCX0KfQovKjwvbHRJRTk+Ki8KCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuRXZlbnRzID0gbmV3IEhhc2goRWxlbWVudC5FdmVudHMpOwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkRlbGVnYXRpb24KCmRlc2NyaXB0aW9uOiBFeHRlbmRzIHRoZSBFbGVtZW50IG5hdGl2ZSBvYmplY3QgdG8gaW5jbHVkZSB0aGUgZGVsZWdhdGUgbWV0aG9kIGZvciBtb3JlIGVmZmljaWVudCBldmVudCBtYW5hZ2VtZW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQuRXZlbnRdCgpwcm92aWRlczogW0VsZW1lbnQuRGVsZWdhdGlvbl0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZXZlbnRMaXN0ZW5lclN1cHBvcnQgPSAhIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyOwoKRWxlbWVudC5OYXRpdmVFdmVudHMuZm9jdXNpbiA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzLmZvY3Vzb3V0ID0gMjsKCnZhciBidWJibGVVcCA9IGZ1bmN0aW9uKHNlbGYsIG1hdGNoLCBmbiwgZXZlbnQsIHRhcmdldCl7Cgl3aGlsZSAodGFyZ2V0ICYmIHRhcmdldCAhPSBzZWxmKXsKCQlpZiAobWF0Y2godGFyZ2V0LCBldmVudCkpIHJldHVybiBmbi5jYWxsKHRhcmdldCwgZXZlbnQsIHRhcmdldCk7CgkJdGFyZ2V0ID0gZG9jdW1lbnQuaWQodGFyZ2V0LnBhcmVudE5vZGUpOwoJfQp9OwoKdmFyIG1hcCA9IHsKCW1vdXNlZW50ZXI6IHsKCQliYXNlOiAnbW91c2VvdmVyJwoJfSwKCW1vdXNlbGVhdmU6IHsKCQliYXNlOiAnbW91c2VvdXQnCgl9LAoJZm9jdXM6IHsKCQliYXNlOiAnZm9jdXMnICsgKGV2ZW50TGlzdGVuZXJTdXBwb3J0ID8gJycgOiAnaW4nKSwKCQljYXB0dXJlOiB0cnVlCgl9LAoJYmx1cjogewoJCWJhc2U6IGV2ZW50TGlzdGVuZXJTdXBwb3J0ID8gJ2JsdXInIDogJ2ZvY3Vzb3V0JywKCQljYXB0dXJlOiB0cnVlCgl9Cn07CgovKjxsdElFOT4qLwp2YXIgX2tleSA9ICckZGVsZWdhdGlvbjonOwp2YXIgZm9ybU9ic2VydmVyID0gZnVuY3Rpb24odHlwZSl7CgoJcmV0dXJuIHsKCgkJYmFzZTogJ2ZvY3VzaW4nLAoKCQlyZW1vdmU6IGZ1bmN0aW9uKHNlbGYsIHVpZCl7CgkJCXZhciBsaXN0ID0gc2VsZi5yZXRyaWV2ZShfa2V5ICsgdHlwZSArICdsaXN0ZW5lcnMnLCB7fSlbdWlkXTsKCQkJaWYgKGxpc3QgJiYgbGlzdC5mb3JtcykgZm9yICh2YXIgaSA9IGxpc3QuZm9ybXMubGVuZ3RoOyBpLS07KXsKCQkJCWxpc3QuZm9ybXNbaV0ucmVtb3ZlRXZlbnQodHlwZSwgbGlzdC5mbnNbaV0pOwoJCQl9CgkJfSwKCgkJbGlzdGVuOiBmdW5jdGlvbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQsIHVpZCl7CgkJCXZhciBmb3JtID0gKHRhcmdldC5nZXQoJ3RhZycpID09ICdmb3JtJykgPyB0YXJnZXQgOiBldmVudC50YXJnZXQuZ2V0UGFyZW50KCdmb3JtJyk7CgkJCWlmICghZm9ybSkgcmV0dXJuOwoKCQkJdmFyIGxpc3RlbmVycyA9IHNlbGYucmV0cmlldmUoX2tleSArIHR5cGUgKyAnbGlzdGVuZXJzJywge30pLAoJCQkJbGlzdGVuZXIgPSBsaXN0ZW5lcnNbdWlkXSB8fCB7Zm9ybXM6IFtdLCBmbnM6IFtdfSwKCQkJCWZvcm1zID0gbGlzdGVuZXIuZm9ybXMsIGZucyA9IGxpc3RlbmVyLmZuczsKCgkJCWlmIChmb3Jtcy5pbmRleE9mKGZvcm0pICE9IC0xKSByZXR1cm47CgkJCWZvcm1zLnB1c2goZm9ybSk7CgoJCQl2YXIgX2ZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQkJfTsKCQkJZm9ybS5hZGRFdmVudCh0eXBlLCBfZm4pOwoJCQlmbnMucHVzaChfZm4pOwoKCQkJbGlzdGVuZXJzW3VpZF0gPSBsaXN0ZW5lcjsKCQkJc2VsZi5zdG9yZShfa2V5ICsgdHlwZSArICdsaXN0ZW5lcnMnLCBsaXN0ZW5lcnMpOwoJCX0KCX07Cn07Cgp2YXIgaW5wdXRPYnNlcnZlciA9IGZ1bmN0aW9uKHR5cGUpewoJcmV0dXJuIHsKCQliYXNlOiAnZm9jdXNpbicsCgkJbGlzdGVuOiBmdW5jdGlvbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQpewoJCQl2YXIgZXZlbnRzID0ge2JsdXI6IGZ1bmN0aW9uKCl7CgkJCQl0aGlzLnJlbW92ZUV2ZW50cyhldmVudHMpOwoJCQl9fTsKCQkJZXZlbnRzW3R5cGVdID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQkJfTsKCQkJZXZlbnQudGFyZ2V0LmFkZEV2ZW50cyhldmVudHMpOwoJCX0KCX07Cn07CgppZiAoIWV2ZW50TGlzdGVuZXJTdXBwb3J0KSBPYmplY3QuYXBwZW5kKG1hcCwgewoJc3VibWl0OiBmb3JtT2JzZXJ2ZXIoJ3N1Ym1pdCcpLAoJcmVzZXQ6IGZvcm1PYnNlcnZlcigncmVzZXQnKSwKCWNoYW5nZTogaW5wdXRPYnNlcnZlcignY2hhbmdlJyksCglzZWxlY3Q6IGlucHV0T2JzZXJ2ZXIoJ3NlbGVjdCcpCn0pOwovKjwvbHRJRTk+Ki8KCnZhciBwcm90byA9IEVsZW1lbnQucHJvdG90eXBlLAoJYWRkRXZlbnQgPSBwcm90by5hZGRFdmVudCwKCXJlbW92ZUV2ZW50ID0gcHJvdG8ucmVtb3ZlRXZlbnQ7Cgp2YXIgcmVsYXkgPSBmdW5jdGlvbihvbGQsIG1ldGhvZCl7CglyZXR1cm4gZnVuY3Rpb24odHlwZSwgZm4sIHVzZUNhcHR1cmUpewoJCWlmICh0eXBlLmluZGV4T2YoJzpyZWxheScpID09IC0xKSByZXR1cm4gb2xkLmNhbGwodGhpcywgdHlwZSwgZm4sIHVzZUNhcHR1cmUpOwoJCXZhciBwYXJzZWQgPSBTbGljay5wYXJzZSh0eXBlKS5leHByZXNzaW9uc1swXVswXTsKCQlpZiAocGFyc2VkLnBzZXVkb3NbMF0ua2V5ICE9ICdyZWxheScpIHJldHVybiBvbGQuY2FsbCh0aGlzLCB0eXBlLCBmbiwgdXNlQ2FwdHVyZSk7CgkJdmFyIG5ld1R5cGUgPSBwYXJzZWQudGFnOwoJCXBhcnNlZC5wc2V1ZG9zLnNsaWNlKDEpLmVhY2goZnVuY3Rpb24ocHNldWRvKXsKCQkJbmV3VHlwZSArPSAnOicgKyBwc2V1ZG8ua2V5ICsgKHBzZXVkby52YWx1ZSA/ICcoJyArIHBzZXVkby52YWx1ZSArICcpJyA6ICcnKTsKCQl9KTsKCQlvbGQuY2FsbCh0aGlzLCB0eXBlLCBmbik7CgkJcmV0dXJuIG1ldGhvZC5jYWxsKHRoaXMsIG5ld1R5cGUsIHBhcnNlZC5wc2V1ZG9zWzBdLnZhbHVlLCBmbik7Cgl9Owp9OwoKdmFyIGRlbGVnYXRpb24gPSB7CgoJYWRkRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIG1hdGNoLCBmbil7CgkJdmFyIHN0b3JhZ2UgPSB0aGlzLnJldHJpZXZlKCckZGVsZWdhdGVzJywge30pLCBzdG9yZWQgPSBzdG9yYWdlW3R5cGVdOwoJCWlmIChzdG9yZWQpIGZvciAodmFyIF91aWQgaW4gc3RvcmVkKXsKCQkJaWYgKHN0b3JlZFtfdWlkXS5mbiA9PSBmbiAmJiBzdG9yZWRbX3VpZF0ubWF0Y2ggPT0gbWF0Y2gpIHJldHVybiB0aGlzOwoJCX0KCgkJdmFyIF90eXBlID0gdHlwZSwgX21hdGNoID0gbWF0Y2gsIF9mbiA9IGZuLCBfbWFwID0gbWFwW3R5cGVdIHx8IHt9OwoJCXR5cGUgPSBfbWFwLmJhc2UgfHwgX3R5cGU7CgoJCW1hdGNoID0gZnVuY3Rpb24odGFyZ2V0KXsKCQkJcmV0dXJuIFNsaWNrLm1hdGNoKHRhcmdldCwgX21hdGNoKTsKCQl9OwoKCQl2YXIgZWxlbWVudEV2ZW50ID0gRWxlbWVudC5FdmVudHNbX3R5cGVdOwoJCWlmIChlbGVtZW50RXZlbnQgJiYgZWxlbWVudEV2ZW50LmNvbmRpdGlvbil7CgkJCXZhciBfX21hdGNoID0gbWF0Y2gsIGNvbmRpdGlvbiA9IGVsZW1lbnRFdmVudC5jb25kaXRpb247CgkJCW1hdGNoID0gZnVuY3Rpb24odGFyZ2V0LCBldmVudCl7CgkJCQlyZXR1cm4gX19tYXRjaCh0YXJnZXQsIGV2ZW50KSAmJiBjb25kaXRpb24uY2FsbCh0YXJnZXQsIGV2ZW50LCB0eXBlKTsKCQkJfTsKCQl9CgoJCXZhciBzZWxmID0gdGhpcywgdWlkID0gU3RyaW5nLnVuaXF1ZUlEKCk7CgkJdmFyIGRlbGVnYXRvciA9IF9tYXAubGlzdGVuID8gZnVuY3Rpb24oZXZlbnQsIHRhcmdldCl7CgkJCWlmICghdGFyZ2V0ICYmIGV2ZW50ICYmIGV2ZW50LnRhcmdldCkgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwoJCQlpZiAodGFyZ2V0KSBfbWFwLmxpc3RlbihzZWxmLCBtYXRjaCwgZm4sIGV2ZW50LCB0YXJnZXQsIHVpZCk7CgkJfSA6IGZ1bmN0aW9uKGV2ZW50LCB0YXJnZXQpewoJCQlpZiAoIXRhcmdldCAmJiBldmVudCAmJiBldmVudC50YXJnZXQpIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQkJaWYgKHRhcmdldCkgYnViYmxlVXAoc2VsZiwgbWF0Y2gsIGZuLCBldmVudCwgdGFyZ2V0KTsKCQl9OwoKCQlpZiAoIXN0b3JlZCkgc3RvcmVkID0ge307CgkJc3RvcmVkW3VpZF0gPSB7CgkJCW1hdGNoOiBfbWF0Y2gsCgkJCWZuOiBfZm4sCgkJCWRlbGVnYXRvcjogZGVsZWdhdG9yCgkJfTsKCQlzdG9yYWdlW190eXBlXSA9IHN0b3JlZDsKCQlyZXR1cm4gYWRkRXZlbnQuY2FsbCh0aGlzLCB0eXBlLCBkZWxlZ2F0b3IsIF9tYXAuY2FwdHVyZSk7Cgl9LAoKCXJlbW92ZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBtYXRjaCwgZm4sIF91aWQpewoJCXZhciBzdG9yYWdlID0gdGhpcy5yZXRyaWV2ZSgnJGRlbGVnYXRlcycsIHt9KSwgc3RvcmVkID0gc3RvcmFnZVt0eXBlXTsKCQlpZiAoIXN0b3JlZCkgcmV0dXJuIHRoaXM7CgoJCWlmIChfdWlkKXsKCQkJdmFyIF90eXBlID0gdHlwZSwgZGVsZWdhdG9yID0gc3RvcmVkW191aWRdLmRlbGVnYXRvciwgX21hcCA9IG1hcFt0eXBlXSB8fCB7fTsKCQkJdHlwZSA9IF9tYXAuYmFzZSB8fCBfdHlwZTsKCQkJaWYgKF9tYXAucmVtb3ZlKSBfbWFwLnJlbW92ZSh0aGlzLCBfdWlkKTsKCQkJZGVsZXRlIHN0b3JlZFtfdWlkXTsKCQkJc3RvcmFnZVtfdHlwZV0gPSBzdG9yZWQ7CgkJCXJldHVybiByZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIGRlbGVnYXRvcik7CgkJfQoKCQl2YXIgX191aWQsIHM7CgkJaWYgKGZuKSBmb3IgKF9fdWlkIGluIHN0b3JlZCl7CgkJCXMgPSBzdG9yZWRbX191aWRdOwoJCQlpZiAocy5tYXRjaCA9PSBtYXRjaCAmJiBzLmZuID09IGZuKSByZXR1cm4gZGVsZWdhdGlvbi5yZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIG1hdGNoLCBmbiwgX191aWQpOwoJCX0gZWxzZSBmb3IgKF9fdWlkIGluIHN0b3JlZCl7CgkJCXMgPSBzdG9yZWRbX191aWRdOwoJCQlpZiAocy5tYXRjaCA9PSBtYXRjaCkgZGVsZWdhdGlvbi5yZW1vdmVFdmVudC5jYWxsKHRoaXMsIHR5cGUsIG1hdGNoLCBzLmZuLCBfX3VpZCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfTsKCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCWFkZEV2ZW50OiByZWxheShhZGRFdmVudCwgZGVsZWdhdGlvbi5hZGRFdmVudCksCglyZW1vdmVFdmVudDogcmVsYXkocmVtb3ZlRXZlbnQsIGRlbGVnYXRpb24ucmVtb3ZlRXZlbnQpCn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IEVsZW1lbnQuRGltZW5zaW9ucwoKZGVzY3JpcHRpb246IENvbnRhaW5zIG1ldGhvZHMgdG8gd29yayB3aXRoIHNpemUsIHNjcm9sbCwgb3IgcG9zaXRpb25pbmcgb2YgRWxlbWVudHMgYW5kIHRoZSB3aW5kb3cgb2JqZWN0LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRWxlbWVudCBwb3NpdGlvbmluZyBiYXNlZCBvbiB0aGUgW3Fvb3hkb29dKGh0dHA6Ly9xb294ZG9vLm9yZy8pIGNvZGUgYW5kIHNtYXJ0IGJyb3dzZXIgZml4ZXMsIFtMR1BMIExpY2Vuc2VdKGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9sZ3BsLmh0bWwpLgogIC0gVmlld3BvcnQgZGltZW5zaW9ucyBiYXNlZCBvbiBbWVVJXShodHRwOi8vZGV2ZWxvcGVyLnlhaG9vLmNvbS95dWkvKSBjb2RlLCBbQlNEIExpY2Vuc2VdKGh0dHA6Ly9kZXZlbG9wZXIueWFob28uY29tL3l1aS9saWNlbnNlLmh0bWwpLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBFbGVtZW50LlN0eWxlXQoKcHJvdmlkZXM6IFtFbGVtZW50LkRpbWVuc2lvbnNdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKCWNoaWxkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CmVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gJzAnOwplbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKTsKdmFyIGJyb2tlbk9mZnNldFBhcmVudCA9IChjaGlsZC5vZmZzZXRQYXJlbnQgPT09IGVsZW1lbnQpOwplbGVtZW50ID0gY2hpbGQgPSBudWxsOwoKdmFyIGlzT2Zmc2V0ID0gZnVuY3Rpb24oZWwpewoJcmV0dXJuIHN0eWxlU3RyaW5nKGVsLCAncG9zaXRpb24nKSAhPSAnc3RhdGljJyB8fCBpc0JvZHkoZWwpOwp9OwoKdmFyIGlzT2Zmc2V0U3RhdGljID0gZnVuY3Rpb24oZWwpewoJcmV0dXJuIGlzT2Zmc2V0KGVsKSB8fCAoL14oPzp0YWJsZXx0ZHx0aCkkL2kpLnRlc3QoZWwudGFnTmFtZSk7Cn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJc2Nyb2xsVG86IGZ1bmN0aW9uKHgsIHkpewoJCWlmIChpc0JvZHkodGhpcykpewoJCQl0aGlzLmdldFdpbmRvdygpLnNjcm9sbFRvKHgsIHkpOwoJCX0gZWxzZSB7CgkJCXRoaXMuc2Nyb2xsTGVmdCA9IHg7CgkJCXRoaXMuc2Nyb2xsVG9wID0geTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFNpemU6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2l6ZSgpOwoJCXJldHVybiB7eDogdGhpcy5vZmZzZXRXaWR0aCwgeTogdGhpcy5vZmZzZXRIZWlnaHR9OwoJfSwKCglnZXRTY3JvbGxTaXplOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNjcm9sbFNpemUoKTsKCQlyZXR1cm4ge3g6IHRoaXMuc2Nyb2xsV2lkdGgsIHk6IHRoaXMuc2Nyb2xsSGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNjcm9sbCgpOwoJCXJldHVybiB7eDogdGhpcy5zY3JvbGxMZWZ0LCB5OiB0aGlzLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbHM6IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzLnBhcmVudE5vZGUsIHBvc2l0aW9uID0ge3g6IDAsIHk6IDB9OwoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQuc2Nyb2xsTGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50LnNjcm9sbFRvcDsKCQkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRPZmZzZXRQYXJlbnQ6IGJyb2tlbk9mZnNldFBhcmVudCA/IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzOwoJCWlmIChpc0JvZHkoZWxlbWVudCkgfHwgc3R5bGVTdHJpbmcoZWxlbWVudCwgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJykgcmV0dXJuIG51bGw7CgoJCXZhciBpc09mZnNldENoZWNrID0gKHN0eWxlU3RyaW5nKGVsZW1lbnQsICdwb3NpdGlvbicpID09ICdzdGF0aWMnKSA/IGlzT2Zmc2V0U3RhdGljIDogaXNPZmZzZXQ7CgkJd2hpbGUgKChlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlKSl7CgkJCWlmIChpc09mZnNldENoZWNrKGVsZW1lbnQpKSByZXR1cm4gZWxlbWVudDsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9IDogZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXM7CgkJaWYgKGlzQm9keShlbGVtZW50KSB8fCBzdHlsZVN0cmluZyhlbGVtZW50LCAncG9zaXRpb24nKSA9PSAnZml4ZWQnKSByZXR1cm4gbnVsbDsKCgkJdHJ5IHsKCQkJcmV0dXJuIGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0gY2F0Y2goZSkge30KCQlyZXR1cm4gbnVsbDsKCX0sCgoJZ2V0T2Zmc2V0czogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QgJiYgIUJyb3dzZXIuUGxhdGZvcm0uaW9zKXsKCQkJdmFyIGJvdW5kID0gdGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwKCQkJCWh0bWwgPSBkb2N1bWVudC5pZCh0aGlzLmdldERvY3VtZW50KCkuZG9jdW1lbnRFbGVtZW50KSwKCQkJCWh0bWxTY3JvbGwgPSBodG1sLmdldFNjcm9sbCgpLAoJCQkJZWxlbVNjcm9sbHMgPSB0aGlzLmdldFNjcm9sbHMoKSwKCQkJCWlzRml4ZWQgPSAoc3R5bGVTdHJpbmcodGhpcywgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJyk7CgoJCQlyZXR1cm4gewoJCQkJeDogYm91bmQubGVmdC50b0ludCgpICsgZWxlbVNjcm9sbHMueCArICgoaXNGaXhlZCkgPyAwIDogaHRtbFNjcm9sbC54KSAtIGh0bWwuY2xpZW50TGVmdCwKCQkJCXk6IGJvdW5kLnRvcC50b0ludCgpICArIGVsZW1TY3JvbGxzLnkgKyAoKGlzRml4ZWQpID8gMCA6IGh0bWxTY3JvbGwueSkgLSBodG1sLmNsaWVudFRvcAoJCQl9OwoJCX0KCgkJdmFyIGVsZW1lbnQgPSB0aGlzLCBwb3NpdGlvbiA9IHt4OiAwLCB5OiAwfTsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gcG9zaXRpb247CgoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQub2Zmc2V0TGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50Lm9mZnNldFRvcDsKCgkJCWlmIChCcm93c2VyLmZpcmVmb3gpewoJCQkJaWYgKCFib3JkZXJCb3goZWxlbWVudCkpewoJCQkJCXBvc2l0aW9uLnggKz0gbGVmdEJvcmRlcihlbGVtZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJCX0KCQkJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJCQlpZiAocGFyZW50ICYmIHN0eWxlU3RyaW5nKHBhcmVudCwgJ292ZXJmbG93JykgIT0gJ3Zpc2libGUnKXsKCQkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIocGFyZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihwYXJlbnQpOwoJCQkJfQoJCQl9IGVsc2UgaWYgKGVsZW1lbnQgIT0gdGhpcyAmJiBCcm93c2VyLnNhZmFyaSl7CgkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIoZWxlbWVudCk7CgkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJfQoKCQkJZWxlbWVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0KCQlpZiAoQnJvd3Nlci5maXJlZm94ICYmICFib3JkZXJCb3godGhpcykpewoJCQlwb3NpdGlvbi54IC09IGxlZnRCb3JkZXIodGhpcyk7CgkJCXBvc2l0aW9uLnkgLT0gdG9wQm9yZGVyKHRoaXMpOwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldFBvc2l0aW9uOiBmdW5jdGlvbihyZWxhdGl2ZSl7CgkJdmFyIG9mZnNldCA9IHRoaXMuZ2V0T2Zmc2V0cygpLAoJCQlzY3JvbGwgPSB0aGlzLmdldFNjcm9sbHMoKTsKCQl2YXIgcG9zaXRpb24gPSB7CgkJCXg6IG9mZnNldC54IC0gc2Nyb2xsLngsCgkJCXk6IG9mZnNldC55IC0gc2Nyb2xsLnkKCQl9OwoKCQlpZiAocmVsYXRpdmUgJiYgKHJlbGF0aXZlID0gZG9jdW1lbnQuaWQocmVsYXRpdmUpKSl7CgkJCXZhciByZWxhdGl2ZVBvc2l0aW9uID0gcmVsYXRpdmUuZ2V0UG9zaXRpb24oKTsKCQkJcmV0dXJuIHt4OiBwb3NpdGlvbi54IC0gcmVsYXRpdmVQb3NpdGlvbi54IC0gbGVmdEJvcmRlcihyZWxhdGl2ZSksIHk6IHBvc2l0aW9uLnkgLSByZWxhdGl2ZVBvc2l0aW9uLnkgLSB0b3BCb3JkZXIocmVsYXRpdmUpfTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oZWxlbWVudCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0Q29vcmRpbmF0ZXMoKTsKCQl2YXIgcG9zaXRpb24gPSB0aGlzLmdldFBvc2l0aW9uKGVsZW1lbnQpLAoJCQlzaXplID0gdGhpcy5nZXRTaXplKCk7CgkJdmFyIG9iaiA9IHsKCQkJbGVmdDogcG9zaXRpb24ueCwKCQkJdG9wOiBwb3NpdGlvbi55LAoJCQl3aWR0aDogc2l6ZS54LAoJCQloZWlnaHQ6IHNpemUueQoJCX07CgkJb2JqLnJpZ2h0ID0gb2JqLmxlZnQgKyBvYmoud2lkdGg7CgkJb2JqLmJvdHRvbSA9IG9iai50b3AgKyBvYmouaGVpZ2h0OwoJCXJldHVybiBvYmo7Cgl9LAoKCWNvbXB1dGVQb3NpdGlvbjogZnVuY3Rpb24ob2JqKXsKCQlyZXR1cm4gewoJCQlsZWZ0OiBvYmoueCAtIHN0eWxlTnVtYmVyKHRoaXMsICdtYXJnaW4tbGVmdCcpLAoJCQl0b3A6IG9iai55IC0gc3R5bGVOdW1iZXIodGhpcywgJ21hcmdpbi10b3AnKQoJCX07Cgl9LAoKCXNldFBvc2l0aW9uOiBmdW5jdGlvbihvYmopewoJCXJldHVybiB0aGlzLnNldFN0eWxlcyh0aGlzLmNvbXB1dGVQb3NpdGlvbihvYmopKTsKCX0KCn0pOwoKCltEb2N1bWVudCwgV2luZG93XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglnZXRTaXplOiBmdW5jdGlvbigpewoJCXZhciBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogZG9jLmNsaWVudFdpZHRoLCB5OiBkb2MuY2xpZW50SGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsOiBmdW5jdGlvbigpewoJCXZhciB3aW4gPSB0aGlzLmdldFdpbmRvdygpLCBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpOwoJCXJldHVybiB7eDogd2luLnBhZ2VYT2Zmc2V0IHx8IGRvYy5zY3JvbGxMZWZ0LCB5OiB3aW4ucGFnZVlPZmZzZXQgfHwgZG9jLnNjcm9sbFRvcH07Cgl9LAoKCWdldFNjcm9sbFNpemU6IGZ1bmN0aW9uKCl7CgkJdmFyIGRvYyA9IGdldENvbXBhdEVsZW1lbnQodGhpcyksCgkJCW1pbiA9IHRoaXMuZ2V0U2l6ZSgpLAoJCQlib2R5ID0gdGhpcy5nZXREb2N1bWVudCgpLmJvZHk7CgoJCXJldHVybiB7eDogTWF0aC5tYXgoZG9jLnNjcm9sbFdpZHRoLCBib2R5LnNjcm9sbFdpZHRoLCBtaW4ueCksIHk6IE1hdGgubWF4KGRvYy5zY3JvbGxIZWlnaHQsIGJvZHkuc2Nyb2xsSGVpZ2h0LCBtaW4ueSl9OwoJfSwKCglnZXRQb3NpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4ge3g6IDAsIHk6IDB9OwoJfSwKCglnZXRDb29yZGluYXRlczogZnVuY3Rpb24oKXsKCQl2YXIgc2l6ZSA9IHRoaXMuZ2V0U2l6ZSgpOwoJCXJldHVybiB7dG9wOiAwLCBsZWZ0OiAwLCBib3R0b206IHNpemUueSwgcmlnaHQ6IHNpemUueCwgaGVpZ2h0OiBzaXplLnksIHdpZHRoOiBzaXplLnh9OwoJfQoKfSk7CgovLyBwcml2YXRlIG1ldGhvZHMKCnZhciBzdHlsZVN0cmluZyA9IEVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZTsKCmZ1bmN0aW9uIHN0eWxlTnVtYmVyKGVsZW1lbnQsIHN0eWxlKXsKCXJldHVybiBzdHlsZVN0cmluZyhlbGVtZW50LCBzdHlsZSkudG9JbnQoKSB8fCAwOwp9CgpmdW5jdGlvbiBib3JkZXJCb3goZWxlbWVudCl7CglyZXR1cm4gc3R5bGVTdHJpbmcoZWxlbWVudCwgJy1tb3otYm94LXNpemluZycpID09ICdib3JkZXItYm94JzsKfQoKZnVuY3Rpb24gdG9wQm9yZGVyKGVsZW1lbnQpewoJcmV0dXJuIHN0eWxlTnVtYmVyKGVsZW1lbnQsICdib3JkZXItdG9wLXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGxlZnRCb3JkZXIoZWxlbWVudCl7CglyZXR1cm4gc3R5bGVOdW1iZXIoZWxlbWVudCwgJ2JvcmRlci1sZWZ0LXdpZHRoJyk7Cn0KCmZ1bmN0aW9uIGlzQm9keShlbGVtZW50KXsKCXJldHVybiAoL14oPzpib2R5fGh0bWwpJC9pKS50ZXN0KGVsZW1lbnQudGFnTmFtZSk7Cn0KCmZ1bmN0aW9uIGdldENvbXBhdEVsZW1lbnQoZWxlbWVudCl7Cgl2YXIgZG9jID0gZWxlbWVudC5nZXREb2N1bWVudCgpOwoJcmV0dXJuICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7Cn0KCn0pKCk7CgovL2FsaWFzZXMKRWxlbWVudC5hbGlhcyh7cG9zaXRpb246ICdzZXRQb3NpdGlvbid9KTsgLy9jb21wYXRhYmlsaXR5CgpbV2luZG93LCBEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0SGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNpemUoKS55OwoJfSwKCglnZXRXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTaXplKCkueDsKCX0sCgoJZ2V0U2Nyb2xsVG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbCgpLnk7Cgl9LAoKCWdldFNjcm9sbExlZnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsKCkueDsKCX0sCgoJZ2V0U2Nyb2xsSGVpZ2h0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbFNpemUoKS55OwoJfSwKCglnZXRTY3JvbGxXaWR0aDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGxTaXplKCkueDsKCX0sCgoJZ2V0VG9wOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFBvc2l0aW9uKCkueTsKCX0sCgoJZ2V0TGVmdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRQb3NpdGlvbigpLng7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEZ4CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIGJhc2ljIGFuaW1hdGlvbiBsb2dpYyB0byBiZSBleHRlbmRlZCBieSBhbGwgb3RoZXIgRnggQ2xhc3Nlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXQoKcHJvdmlkZXM6IEZ4CgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIEZ4ID0gdGhpcy5GeCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsKCQkvKgoJCW9uU3RhcnQ6IG5pbCwKCQlvbkNhbmNlbDogbmlsLAoJCW9uQ29tcGxldGU6IG5pbCwKCQkqLwoJCWZwczogNjAsCgkJdW5pdDogZmFsc2UsCgkJZHVyYXRpb246IDUwMCwKCQlmcmFtZXM6IG51bGwsCgkJZnJhbWVTa2lwOiB0cnVlLAoJCWxpbms6ICdpZ25vcmUnCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuc3ViamVjdCA9IHRoaXMuc3ViamVjdCB8fCB0aGlzOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCX0sCgoJZ2V0VHJhbnNpdGlvbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gZnVuY3Rpb24ocCl7CgkJCXJldHVybiAtKE1hdGguY29zKE1hdGguUEkgKiBwKSAtIDEpIC8gMjsKCQl9OwoJfSwKCglzdGVwOiBmdW5jdGlvbihub3cpewoJCWlmICh0aGlzLm9wdGlvbnMuZnJhbWVTa2lwKXsKCQkJdmFyIGRpZmYgPSAodGhpcy50aW1lICE9IG51bGwpID8gKG5vdyAtIHRoaXMudGltZSkgOiAwLCBmcmFtZXMgPSBkaWZmIC8gdGhpcy5mcmFtZUludGVydmFsOwoJCQl0aGlzLnRpbWUgPSBub3c7CgkJCXRoaXMuZnJhbWUgKz0gZnJhbWVzOwoJCX0gZWxzZSB7CgkJCXRoaXMuZnJhbWUrKzsKCQl9CgoJCWlmICh0aGlzLmZyYW1lIDwgdGhpcy5mcmFtZXMpewoJCQl2YXIgZGVsdGEgPSB0aGlzLnRyYW5zaXRpb24odGhpcy5mcmFtZSAvIHRoaXMuZnJhbWVzKTsKCQkJdGhpcy5zZXQodGhpcy5jb21wdXRlKHRoaXMuZnJvbSwgdGhpcy50bywgZGVsdGEpKTsKCQl9IGVsc2UgewoJCQl0aGlzLmZyYW1lID0gdGhpcy5mcmFtZXM7CgkJCXRoaXMuc2V0KHRoaXMuY29tcHV0ZSh0aGlzLmZyb20sIHRoaXMudG8sIDEpKTsKCQkJdGhpcy5zdG9wKCk7CgkJfQoJfSwKCglzZXQ6IGZ1bmN0aW9uKG5vdyl7CgkJcmV0dXJuIG5vdzsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQlyZXR1cm4gRnguY29tcHV0ZShmcm9tLCB0bywgZGVsdGEpOwoJfSwKCgljaGVjazogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMuaXNSdW5uaW5nKCkpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglzdGFydDogZnVuY3Rpb24oZnJvbSwgdG8pewoJCWlmICghdGhpcy5jaGVjayhmcm9tLCB0bykpIHJldHVybiB0aGlzOwoJCXRoaXMuZnJvbSA9IGZyb207CgkJdGhpcy50byA9IHRvOwoJCXRoaXMuZnJhbWUgPSAodGhpcy5vcHRpb25zLmZyYW1lU2tpcCkgPyAwIDogLTE7CgkJdGhpcy50aW1lID0gbnVsbDsKCQl0aGlzLnRyYW5zaXRpb24gPSB0aGlzLmdldFRyYW5zaXRpb24oKTsKCQl2YXIgZnJhbWVzID0gdGhpcy5vcHRpb25zLmZyYW1lcywgZnBzID0gdGhpcy5vcHRpb25zLmZwcywgZHVyYXRpb24gPSB0aGlzLm9wdGlvbnMuZHVyYXRpb247CgkJdGhpcy5kdXJhdGlvbiA9IEZ4LkR1cmF0aW9uc1tkdXJhdGlvbl0gfHwgZHVyYXRpb24udG9JbnQoKTsKCQl0aGlzLmZyYW1lSW50ZXJ2YWwgPSAxMDAwIC8gZnBzOwoJCXRoaXMuZnJhbWVzID0gZnJhbWVzIHx8IE1hdGgucm91bmQodGhpcy5kdXJhdGlvbiAvIHRoaXMuZnJhbWVJbnRlcnZhbCk7CgkJdGhpcy5maXJlRXZlbnQoJ3N0YXJ0JywgdGhpcy5zdWJqZWN0KTsKCQlwdXNoSW5zdGFuY2UuY2FsbCh0aGlzLCBmcHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdG9wOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCWlmICh0aGlzLmZyYW1lcyA9PSB0aGlzLmZyYW1lKXsKCQkJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScsIHRoaXMuc3ViamVjdCk7CgkJCQlpZiAoIXRoaXMuY2FsbENoYWluKCkpIHRoaXMuZmlyZUV2ZW50KCdjaGFpbkNvbXBsZXRlJywgdGhpcy5zdWJqZWN0KTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZmlyZUV2ZW50KCdzdG9wJywgdGhpcy5zdWJqZWN0KTsKCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FuY2VsOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCXRoaXMuZnJhbWUgPSB0aGlzLmZyYW1lczsKCQkJdGhpcy5maXJlRXZlbnQoJ2NhbmNlbCcsIHRoaXMuc3ViamVjdCkuY2xlYXJDaGFpbigpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJcGF1c2U6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaXNSdW5uaW5nKCkpewoJCQl0aGlzLnRpbWUgPSBudWxsOwoJCQlwdWxsSW5zdGFuY2UuY2FsbCh0aGlzLCB0aGlzLm9wdGlvbnMuZnBzKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlc3VtZTogZnVuY3Rpb24oKXsKCQlpZiAoKHRoaXMuZnJhbWUgPCB0aGlzLmZyYW1lcykgJiYgIXRoaXMuaXNSdW5uaW5nKCkpIHB1c2hJbnN0YW5jZS5jYWxsKHRoaXMsIHRoaXMub3B0aW9ucy5mcHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJdmFyIGxpc3QgPSBpbnN0YW5jZXNbdGhpcy5vcHRpb25zLmZwc107CgkJcmV0dXJuIGxpc3QgJiYgbGlzdC5jb250YWlucyh0aGlzKTsKCX0KCn0pOwoKRnguY29tcHV0ZSA9IGZ1bmN0aW9uKGZyb20sIHRvLCBkZWx0YSl7CglyZXR1cm4gKHRvIC0gZnJvbSkgKiBkZWx0YSArIGZyb207Cn07CgpGeC5EdXJhdGlvbnMgPSB7J3Nob3J0JzogMjUwLCAnbm9ybWFsJzogNTAwLCAnbG9uZyc6IDEwMDB9OwoKLy8gZ2xvYmFsIHRpbWVycwoKdmFyIGluc3RhbmNlcyA9IHt9LCB0aW1lcnMgPSB7fTsKCnZhciBsb29wID0gZnVuY3Rpb24oKXsKCXZhciBub3cgPSBEYXRlLm5vdygpOwoJZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoOyBpLS07KXsKCQl2YXIgaW5zdGFuY2UgPSB0aGlzW2ldOwoJCWlmIChpbnN0YW5jZSkgaW5zdGFuY2Uuc3RlcChub3cpOwoJfQp9OwoKdmFyIHB1c2hJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdIHx8IChpbnN0YW5jZXNbZnBzXSA9IFtdKTsKCWxpc3QucHVzaCh0aGlzKTsKCWlmICghdGltZXJzW2Zwc10pIHRpbWVyc1tmcHNdID0gbG9vcC5wZXJpb2RpY2FsKE1hdGgucm91bmQoMTAwMCAvIGZwcyksIGxpc3QpOwp9OwoKdmFyIHB1bGxJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdOwoJaWYgKGxpc3QpewoJCWxpc3QuZXJhc2UodGhpcyk7CgkJaWYgKCFsaXN0Lmxlbmd0aCAmJiB0aW1lcnNbZnBzXSl7CgkJCWRlbGV0ZSBpbnN0YW5jZXNbZnBzXTsKCQkJdGltZXJzW2Zwc10gPSBjbGVhckludGVydmFsKHRpbWVyc1tmcHNdKTsKCQl9Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRnguQ1NTCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENTUyBhbmltYXRpb24gbG9naWMuIFVzZWQgYnkgRnguVHdlZW4sIEZ4Lk1vcnBoLCBGeC5FbGVtZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtGeCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBGeC5DU1MKCi4uLgoqLwoKRnguQ1NTID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeCwKCgkvL3ByZXBhcmVzIHRoZSBiYXNlIGZyb20vdG8gb2JqZWN0CgoJcHJlcGFyZTogZnVuY3Rpb24oZWxlbWVudCwgcHJvcGVydHksIHZhbHVlcyl7CgkJdmFsdWVzID0gQXJyYXkuZnJvbSh2YWx1ZXMpOwoJCXZhciBmcm9tID0gdmFsdWVzWzBdLCB0byA9IHZhbHVlc1sxXTsKCQlpZiAodG8gPT0gbnVsbCl7CgkJCXRvID0gZnJvbTsKCQkJZnJvbSA9IGVsZW1lbnQuZ2V0U3R5bGUocHJvcGVydHkpOwoJCQl2YXIgdW5pdCA9IHRoaXMub3B0aW9ucy51bml0OwoJCQkvLyBhZGFwdGVkIGZyb206IGh0dHBzOi8vZ2l0aHViLmNvbS9yeWFubW9yci9meC9ibG9iL21hc3Rlci9meC5qcyNMMjk5CgkJCWlmICh1bml0ICYmIGZyb20uc2xpY2UoLXVuaXQubGVuZ3RoKSAhPSB1bml0ICYmIHBhcnNlRmxvYXQoZnJvbSkgIT0gMCl7CgkJCQllbGVtZW50LnNldFN0eWxlKHByb3BlcnR5LCB0byArIHVuaXQpOwoJCQkJdmFyIHZhbHVlID0gZWxlbWVudC5nZXRDb21wdXRlZFN0eWxlKHByb3BlcnR5KTsKCQkJCS8vIElFIGFuZCBPcGVyYSBzdXBwb3J0IHBpeGVsTGVmdCBvciBwaXhlbFdpZHRoCgkJCQlpZiAoISgvcHgkLy50ZXN0KHZhbHVlKSkpewoJCQkJCXZhbHVlID0gZWxlbWVudC5zdHlsZVsoJ3BpeGVsLScgKyBwcm9wZXJ0eSkuY2FtZWxDYXNlKCldOwoJCQkJCWlmICh2YWx1ZSA9PSBudWxsKXsKCQkJCQkJLy8gYWRhcHRlZCBmcm9tIERlYW4gRWR3YXJkcycgaHR0cDovL2VyaWsuZWFlLm5ldC9hcmNoaXZlcy8yMDA3LzA3LzI3LzE4LjU0LjE1LyNjb21tZW50LTEwMjI5MQoJCQkJCQl2YXIgbGVmdCA9IGVsZW1lbnQuc3R5bGUubGVmdDsKCQkJCQkJZWxlbWVudC5zdHlsZS5sZWZ0ID0gdG8gKyB1bml0OwoJCQkJCQl2YWx1ZSA9IGVsZW1lbnQuc3R5bGUucGl4ZWxMZWZ0OwoJCQkJCQllbGVtZW50LnN0eWxlLmxlZnQgPSBsZWZ0OwoJCQkJCX0KCQkJCX0KCQkJCWZyb20gPSAodG8gfHwgMSkgLyAocGFyc2VGbG9hdCh2YWx1ZSkgfHwgMSkgKiAocGFyc2VGbG9hdChmcm9tKSB8fCAwKTsKCQkJCWVsZW1lbnQuc2V0U3R5bGUocHJvcGVydHksIGZyb20gKyB1bml0KTsKCQkJfQoJCX0KCQlyZXR1cm4ge2Zyb206IHRoaXMucGFyc2UoZnJvbSksIHRvOiB0aGlzLnBhcnNlKHRvKX07Cgl9LAoKCS8vcGFyc2VzIGEgdmFsdWUgaW50byBhbiBhcnJheQoKCXBhcnNlOiBmdW5jdGlvbih2YWx1ZSl7CgkJdmFsdWUgPSBGdW5jdGlvbi5mcm9tKHZhbHVlKSgpOwoJCXZhbHVlID0gKHR5cGVvZiB2YWx1ZSA9PSAnc3RyaW5nJykgPyB2YWx1ZS5zcGxpdCgnICcpIDogQXJyYXkuZnJvbSh2YWx1ZSk7CgkJcmV0dXJuIHZhbHVlLm1hcChmdW5jdGlvbih2YWwpewoJCQl2YWwgPSBTdHJpbmcodmFsKTsKCQkJdmFyIGZvdW5kID0gZmFsc2U7CgkJCU9iamVjdC5lYWNoKEZ4LkNTUy5QYXJzZXJzLCBmdW5jdGlvbihwYXJzZXIsIGtleSl7CgkJCQlpZiAoZm91bmQpIHJldHVybjsKCQkJCXZhciBwYXJzZWQgPSBwYXJzZXIucGFyc2UodmFsKTsKCQkJCWlmIChwYXJzZWQgfHwgcGFyc2VkID09PSAwKSBmb3VuZCA9IHt2YWx1ZTogcGFyc2VkLCBwYXJzZXI6IHBhcnNlcn07CgkJCX0pOwoJCQlmb3VuZCA9IGZvdW5kIHx8IHt2YWx1ZTogdmFsLCBwYXJzZXI6IEZ4LkNTUy5QYXJzZXJzLlN0cmluZ307CgkJCXJldHVybiBmb3VuZDsKCQl9KTsKCX0sCgoJLy9jb21wdXRlcyBieSBhIGZyb20gYW5kIHRvIHByZXBhcmVkIG9iamVjdHMsIHVzaW5nIHRoZWlyIHBhcnNlcnMuCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQl2YXIgY29tcHV0ZWQgPSBbXTsKCQkoTWF0aC5taW4oZnJvbS5sZW5ndGgsIHRvLmxlbmd0aCkpLnRpbWVzKGZ1bmN0aW9uKGkpewoJCQljb21wdXRlZC5wdXNoKHt2YWx1ZTogZnJvbVtpXS5wYXJzZXIuY29tcHV0ZShmcm9tW2ldLnZhbHVlLCB0b1tpXS52YWx1ZSwgZGVsdGEpLCBwYXJzZXI6IGZyb21baV0ucGFyc2VyfSk7CgkJfSk7CgkJY29tcHV0ZWQuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ2Z4OmNzczp2YWx1ZScpOwoJCXJldHVybiBjb21wdXRlZDsKCX0sCgoJLy9zZXJ2ZXMgdGhlIHZhbHVlIGFzIHNldHRhYmxlCgoJc2VydmU6IGZ1bmN0aW9uKHZhbHVlLCB1bml0KXsKCQlpZiAodHlwZU9mKHZhbHVlKSAhPSAnZng6Y3NzOnZhbHVlJykgdmFsdWUgPSB0aGlzLnBhcnNlKHZhbHVlKTsKCQl2YXIgcmV0dXJuZWQgPSBbXTsKCQl2YWx1ZS5lYWNoKGZ1bmN0aW9uKGJpdCl7CgkJCXJldHVybmVkID0gcmV0dXJuZWQuY29uY2F0KGJpdC5wYXJzZXIuc2VydmUoYml0LnZhbHVlLCB1bml0KSk7CgkJfSk7CgkJcmV0dXJuIHJldHVybmVkOwoJfSwKCgkvL3JlbmRlcnMgdGhlIGNoYW5nZSB0byBhbiBlbGVtZW50CgoJcmVuZGVyOiBmdW5jdGlvbihlbGVtZW50LCBwcm9wZXJ0eSwgdmFsdWUsIHVuaXQpewoJCWVsZW1lbnQuc2V0U3R5bGUocHJvcGVydHksIHRoaXMuc2VydmUodmFsdWUsIHVuaXQpKTsKCX0sCgoJLy9zZWFyY2hlcyBpbnNpZGUgdGhlIHBhZ2UgY3NzIHRvIGZpbmQgdGhlIHZhbHVlcyBmb3IgYSBzZWxlY3RvcgoKCXNlYXJjaDogZnVuY3Rpb24oc2VsZWN0b3IpewoJCWlmIChGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdKSByZXR1cm4gRnguQ1NTLkNhY2hlW3NlbGVjdG9yXTsKCQl2YXIgdG8gPSB7fSwgc2VsZWN0b3JUZXN0ID0gbmV3IFJlZ0V4cCgnXicgKyBzZWxlY3Rvci5lc2NhcGVSZWdFeHAoKSArICckJyk7CgkJQXJyYXkuZWFjaChkb2N1bWVudC5zdHlsZVNoZWV0cywgZnVuY3Rpb24oc2hlZXQsIGopewoJCQl2YXIgaHJlZiA9IHNoZWV0LmhyZWY7CgkJCWlmIChocmVmICYmIGhyZWYuY29udGFpbnMoJzovLycpICYmICFocmVmLmNvbnRhaW5zKGRvY3VtZW50LmRvbWFpbikpIHJldHVybjsKCQkJdmFyIHJ1bGVzID0gc2hlZXQucnVsZXMgfHwgc2hlZXQuY3NzUnVsZXM7CgkJCUFycmF5LmVhY2gocnVsZXMsIGZ1bmN0aW9uKHJ1bGUsIGkpewoJCQkJaWYgKCFydWxlLnN0eWxlKSByZXR1cm47CgkJCQl2YXIgc2VsZWN0b3JUZXh0ID0gKHJ1bGUuc2VsZWN0b3JUZXh0KSA/IHJ1bGUuc2VsZWN0b3JUZXh0LnJlcGxhY2UoL15cdysvLCBmdW5jdGlvbihtKXsKCQkJCQlyZXR1cm4gbS50b0xvd2VyQ2FzZSgpOwoJCQkJfSkgOiBudWxsOwoJCQkJaWYgKCFzZWxlY3RvclRleHQgfHwgIXNlbGVjdG9yVGVzdC50ZXN0KHNlbGVjdG9yVGV4dCkpIHJldHVybjsKCQkJCU9iamVjdC5lYWNoKEVsZW1lbnQuU3R5bGVzLCBmdW5jdGlvbih2YWx1ZSwgc3R5bGUpewoJCQkJCWlmICghcnVsZS5zdHlsZVtzdHlsZV0gfHwgRWxlbWVudC5TaG9ydFN0eWxlc1tzdHlsZV0pIHJldHVybjsKCQkJCQl2YWx1ZSA9IFN0cmluZyhydWxlLnN0eWxlW3N0eWxlXSk7CgkJCQkJdG9bc3R5bGVdID0gKCgvXnJnYi8pLnRlc3QodmFsdWUpKSA/IHZhbHVlLnJnYlRvSGV4KCkgOiB2YWx1ZTsKCQkJCX0pOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gRnguQ1NTLkNhY2hlW3NlbGVjdG9yXSA9IHRvOwoJfQoKfSk7CgpGeC5DU1MuQ2FjaGUgPSB7fTsKCkZ4LkNTUy5QYXJzZXJzID0gewoKCUNvbG9yOiB7CgkJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJaWYgKHZhbHVlLm1hdGNoKC9eI1swLTlhLWZdezMsNn0kL2kpKSByZXR1cm4gdmFsdWUuaGV4VG9SZ2IodHJ1ZSk7CgkJCXJldHVybiAoKHZhbHVlID0gdmFsdWUubWF0Y2goLyhcZCspLFxzKihcZCspLFxzKihcZCspLykpKSA/IFt2YWx1ZVsxXSwgdmFsdWVbMl0sIHZhbHVlWzNdXSA6IGZhbHNlOwoJCX0sCgkJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQkJcmV0dXJuIGZyb20ubWFwKGZ1bmN0aW9uKHZhbHVlLCBpKXsKCQkJCXJldHVybiBNYXRoLnJvdW5kKEZ4LmNvbXB1dGUoZnJvbVtpXSwgdG9baV0sIGRlbHRhKSk7CgkJCX0pOwoJCX0sCgkJc2VydmU6IGZ1bmN0aW9uKHZhbHVlKXsKCQkJcmV0dXJuIHZhbHVlLm1hcChOdW1iZXIpOwoJCX0KCX0sCgoJTnVtYmVyOiB7CgkJcGFyc2U6IHBhcnNlRmxvYXQsCgkJY29tcHV0ZTogRnguY29tcHV0ZSwKCQlzZXJ2ZTogZnVuY3Rpb24odmFsdWUsIHVuaXQpewoJCQlyZXR1cm4gKHVuaXQpID8gdmFsdWUgKyB1bml0IDogdmFsdWU7CgkJfQoJfSwKCglTdHJpbmc6IHsKCQlwYXJzZTogRnVuY3Rpb24uZnJvbShmYWxzZSksCgkJY29tcHV0ZTogZnVuY3Rpb24oemVybywgb25lKXsKCQkJcmV0dXJuIG9uZTsKCQl9LAoJCXNlcnZlOiBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfQoJfQoKfTsKCi8vPDEuMmNvbXBhdD4KCkZ4LkNTUy5QYXJzZXJzID0gbmV3IEhhc2goRnguQ1NTLlBhcnNlcnMpOwoKLy88LzEuMmNvbXBhdD4KCgovKgotLS0KCm5hbWU6IEZ4LlR3ZWVuCgpkZXNjcmlwdGlvbjogRm9ybWVybHkgRnguU3R5bGUsIGVmZmVjdCB0byB0cmFuc2l0aW9uIGFueSBDU1MgcHJvcGVydHkgZm9yIGFuIGVsZW1lbnQuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBGeC5DU1MKCnByb3ZpZGVzOiBbRnguVHdlZW4sIEVsZW1lbnQuZmFkZSwgRWxlbWVudC5oaWdobGlnaHRdCgouLi4KKi8KCkZ4LlR3ZWVuID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeC5DU1MsCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucyl7CgkJdGhpcy5lbGVtZW50ID0gdGhpcy5zdWJqZWN0ID0gZG9jdW1lbnQuaWQoZWxlbWVudCk7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7Cgl9LAoKCXNldDogZnVuY3Rpb24ocHJvcGVydHksIG5vdyl7CgkJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSl7CgkJCW5vdyA9IHByb3BlcnR5OwoJCQlwcm9wZXJ0eSA9IHRoaXMucHJvcGVydHkgfHwgdGhpcy5vcHRpb25zLnByb3BlcnR5OwoJCX0KCQl0aGlzLnJlbmRlcih0aGlzLmVsZW1lbnQsIHByb3BlcnR5LCBub3csIHRoaXMub3B0aW9ucy51bml0KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKHByb3BlcnR5LCBmcm9tLCB0byl7CgkJaWYgKCF0aGlzLmNoZWNrKHByb3BlcnR5LCBmcm9tLCB0bykpIHJldHVybiB0aGlzOwoJCXZhciBhcmdzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpOwoJCXRoaXMucHJvcGVydHkgPSB0aGlzLm9wdGlvbnMucHJvcGVydHkgfHwgYXJncy5zaGlmdCgpOwoJCXZhciBwYXJzZWQgPSB0aGlzLnByZXBhcmUodGhpcy5lbGVtZW50LCB0aGlzLnByb3BlcnR5LCBhcmdzKTsKCQlyZXR1cm4gdGhpcy5wYXJlbnQocGFyc2VkLmZyb20sIHBhcnNlZC50byk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy50d2VlbiA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMuZ2V0KCd0d2VlbicpLmNhbmNlbCgpLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgdHdlZW4gPSB0aGlzLnJldHJpZXZlKCd0d2VlbicpOwoJCWlmICghdHdlZW4pewoJCQl0d2VlbiA9IG5ldyBGeC5Ud2Vlbih0aGlzLCB7bGluazogJ2NhbmNlbCd9KTsKCQkJdGhpcy5zdG9yZSgndHdlZW4nLCB0d2Vlbik7CgkJfQoJCXJldHVybiB0d2VlbjsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJdHdlZW46IGZ1bmN0aW9uKHByb3BlcnR5LCBmcm9tLCB0byl7CgkJdGhpcy5nZXQoJ3R3ZWVuJykuc3RhcnQocHJvcGVydHksIGZyb20sIHRvKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmFkZTogZnVuY3Rpb24oaG93KXsKCQl2YXIgZmFkZSA9IHRoaXMuZ2V0KCd0d2VlbicpLCBtZXRob2QsIGFyZ3MgPSBbJ29wYWNpdHknXS5hcHBlbmQoYXJndW1lbnRzKSwgdG9nZ2xlOwoJCWlmIChhcmdzWzFdID09IG51bGwpIGFyZ3NbMV0gPSAndG9nZ2xlJzsKCQlzd2l0Y2ggKGFyZ3NbMV0pewoJCQljYXNlICdpbic6IG1ldGhvZCA9ICdzdGFydCc7IGFyZ3NbMV0gPSAxOyBicmVhazsKCQkJY2FzZSAnb3V0JzogbWV0aG9kID0gJ3N0YXJ0JzsgYXJnc1sxXSA9IDA7IGJyZWFrOwoJCQljYXNlICdzaG93JzogbWV0aG9kID0gJ3NldCc7IGFyZ3NbMV0gPSAxOyBicmVhazsKCQkJY2FzZSAnaGlkZSc6IG1ldGhvZCA9ICdzZXQnOyBhcmdzWzFdID0gMDsgYnJlYWs7CgkJCWNhc2UgJ3RvZ2dsZSc6CgkJCQl2YXIgZmxhZyA9IHRoaXMucmV0cmlldmUoJ2ZhZGU6ZmxhZycsIHRoaXMuZ2V0U3R5bGUoJ29wYWNpdHknKSA9PSAxKTsKCQkJCW1ldGhvZCA9ICdzdGFydCc7CgkJCQlhcmdzWzFdID0gZmxhZyA/IDAgOiAxOwoJCQkJdGhpcy5zdG9yZSgnZmFkZTpmbGFnJywgIWZsYWcpOwoJCQkJdG9nZ2xlID0gdHJ1ZTsKCQkJYnJlYWs7CgkJCWRlZmF1bHQ6IG1ldGhvZCA9ICdzdGFydCc7CgkJfQoJCWlmICghdG9nZ2xlKSB0aGlzLmVsaW1pbmF0ZSgnZmFkZTpmbGFnJyk7CgkJZmFkZVttZXRob2RdLmFwcGx5KGZhZGUsIGFyZ3MpOwoJCXZhciB0byA9IGFyZ3NbYXJncy5sZW5ndGggLSAxXTsKCQlpZiAobWV0aG9kID09ICdzZXQnIHx8IHRvICE9IDApIHRoaXMuc2V0U3R5bGUoJ3Zpc2liaWxpdHknLCB0byA9PSAwID8gJ2hpZGRlbicgOiAndmlzaWJsZScpOwoJCWVsc2UgZmFkZS5jaGFpbihmdW5jdGlvbigpewoJCQl0aGlzLmVsZW1lbnQuc2V0U3R5bGUoJ3Zpc2liaWxpdHknLCAnaGlkZGVuJyk7CgkJCXRoaXMuY2FsbENoYWluKCk7CgkJfSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWhpZ2hsaWdodDogZnVuY3Rpb24oc3RhcnQsIGVuZCl7CgkJaWYgKCFlbmQpewoJCQllbmQgPSB0aGlzLnJldHJpZXZlKCdoaWdobGlnaHQ6b3JpZ2luYWwnLCB0aGlzLmdldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJykpOwoJCQllbmQgPSAoZW5kID09ICd0cmFuc3BhcmVudCcpID8gJyNmZmYnIDogZW5kOwoJCX0KCQl2YXIgdHdlZW4gPSB0aGlzLmdldCgndHdlZW4nKTsKCQl0d2Vlbi5zdGFydCgnYmFja2dyb3VuZC1jb2xvcicsIHN0YXJ0IHx8ICcjZmZmZjg4JywgZW5kKS5jaGFpbihmdW5jdGlvbigpewoJCQl0aGlzLnNldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJywgdGhpcy5yZXRyaWV2ZSgnaGlnaGxpZ2h0Om9yaWdpbmFsJykpOwoJCQl0d2Vlbi5jYWxsQ2hhaW4oKTsKCQl9LmJpbmQodGhpcykpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeC5Nb3JwaAoKZGVzY3JpcHRpb246IEZvcm1lcmx5IEZ4LlN0eWxlcywgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IG51bWJlciBvZiBDU1MgcHJvcGVydGllcyBmb3IgYW4gZWxlbWVudCB1c2luZyBhbiBvYmplY3Qgb2YgcnVsZXMsIG9yIENTUyBiYXNlZCBzZWxlY3RvciBydWxlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IEZ4Lk1vcnBoCgouLi4KKi8KCkZ4Lk1vcnBoID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeC5DU1MsCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucyl7CgkJdGhpcy5lbGVtZW50ID0gdGhpcy5zdWJqZWN0ID0gZG9jdW1lbnQuaWQoZWxlbWVudCk7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7Cgl9LAoKCXNldDogZnVuY3Rpb24obm93KXsKCQlpZiAodHlwZW9mIG5vdyA9PSAnc3RyaW5nJykgbm93ID0gdGhpcy5zZWFyY2gobm93KTsKCQlmb3IgKHZhciBwIGluIG5vdykgdGhpcy5yZW5kZXIodGhpcy5lbGVtZW50LCBwLCBub3dbcF0sIHRoaXMub3B0aW9ucy51bml0KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQl2YXIgbm93ID0ge307CgkJZm9yICh2YXIgcCBpbiBmcm9tKSBub3dbcF0gPSB0aGlzLnBhcmVudChmcm9tW3BdLCB0b1twXSwgZGVsdGEpOwoJCXJldHVybiBub3c7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydGllcykpIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2YgcHJvcGVydGllcyA9PSAnc3RyaW5nJykgcHJvcGVydGllcyA9IHRoaXMuc2VhcmNoKHByb3BlcnRpZXMpOwoJCXZhciBmcm9tID0ge30sIHRvID0ge307CgkJZm9yICh2YXIgcCBpbiBwcm9wZXJ0aWVzKXsKCQkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHAsIHByb3BlcnRpZXNbcF0pOwoJCQlmcm9tW3BdID0gcGFyc2VkLmZyb207CgkJCXRvW3BdID0gcGFyc2VkLnRvOwoJCX0KCQlyZXR1cm4gdGhpcy5wYXJlbnQoZnJvbSwgdG8pOwoJfQoKfSk7CgpFbGVtZW50LlByb3BlcnRpZXMubW9ycGggPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLmdldCgnbW9ycGgnKS5jYW5jZWwoKS5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG1vcnBoID0gdGhpcy5yZXRyaWV2ZSgnbW9ycGgnKTsKCQlpZiAoIW1vcnBoKXsKCQkJbW9ycGggPSBuZXcgRnguTW9ycGgodGhpcywge2xpbms6ICdjYW5jZWwnfSk7CgkJCXRoaXMuc3RvcmUoJ21vcnBoJywgbW9ycGgpOwoJCX0KCQlyZXR1cm4gbW9ycGg7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCW1vcnBoOiBmdW5jdGlvbihwcm9wcyl7CgkJdGhpcy5nZXQoJ21vcnBoJykuc3RhcnQocHJvcHMpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeC5UcmFuc2l0aW9ucwoKZGVzY3JpcHRpb246IENvbnRhaW5zIGEgc2V0IG9mIGFkdmFuY2VkIHRyYW5zaXRpb25zIHRvIGJlIHVzZWQgd2l0aCBhbnkgb2YgdGhlIEZ4IENsYXNzZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBFYXNpbmcgRXF1YXRpb25zIGJ5IFJvYmVydCBQZW5uZXIsIDxodHRwOi8vd3d3LnJvYmVydHBlbm5lci5jb20vZWFzaW5nLz4sIG1vZGlmaWVkIGFuZCBvcHRpbWl6ZWQgdG8gYmUgdXNlZCB3aXRoIE1vb1Rvb2xzLgoKcmVxdWlyZXM6IEZ4Cgpwcm92aWRlczogRnguVHJhbnNpdGlvbnMKCi4uLgoqLwoKRnguaW1wbGVtZW50KHsKCglnZXRUcmFuc2l0aW9uOiBmdW5jdGlvbigpewoJCXZhciB0cmFucyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uIHx8IEZ4LlRyYW5zaXRpb25zLlNpbmUuZWFzZUluT3V0OwoJCWlmICh0eXBlb2YgdHJhbnMgPT0gJ3N0cmluZycpewoJCQl2YXIgZGF0YSA9IHRyYW5zLnNwbGl0KCc6Jyk7CgkJCXRyYW5zID0gRnguVHJhbnNpdGlvbnM7CgkJCXRyYW5zID0gdHJhbnNbZGF0YVswXV0gfHwgdHJhbnNbZGF0YVswXS5jYXBpdGFsaXplKCldOwoJCQlpZiAoZGF0YVsxXSkgdHJhbnMgPSB0cmFuc1snZWFzZScgKyBkYXRhWzFdLmNhcGl0YWxpemUoKSArIChkYXRhWzJdID8gZGF0YVsyXS5jYXBpdGFsaXplKCkgOiAnJyldOwoJCX0KCQlyZXR1cm4gdHJhbnM7Cgl9Cgp9KTsKCkZ4LlRyYW5zaXRpb24gPSBmdW5jdGlvbih0cmFuc2l0aW9uLCBwYXJhbXMpewoJcGFyYW1zID0gQXJyYXkuZnJvbShwYXJhbXMpOwoJdmFyIGVhc2VJbiA9IGZ1bmN0aW9uKHBvcyl7CgkJcmV0dXJuIHRyYW5zaXRpb24ocG9zLCBwYXJhbXMpOwoJfTsKCXJldHVybiBPYmplY3QuYXBwZW5kKGVhc2VJbiwgewoJCWVhc2VJbjogZWFzZUluLAoJCWVhc2VPdXQ6IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiAxIC0gdHJhbnNpdGlvbigxIC0gcG9zLCBwYXJhbXMpOwoJCX0sCgkJZWFzZUluT3V0OiBmdW5jdGlvbihwb3MpewoJCQlyZXR1cm4gKHBvcyA8PSAwLjUgPyB0cmFuc2l0aW9uKDIgKiBwb3MsIHBhcmFtcykgOiAoMiAtIHRyYW5zaXRpb24oMiAqICgxIC0gcG9zKSwgcGFyYW1zKSkpIC8gMjsKCQl9Cgl9KTsKfTsKCkZ4LlRyYW5zaXRpb25zID0gewoKCWxpbmVhcjogZnVuY3Rpb24oemVybyl7CgkJcmV0dXJuIHplcm87Cgl9Cgp9OwoKLy88MS4yY29tcGF0PgoKRnguVHJhbnNpdGlvbnMgPSBuZXcgSGFzaChGeC5UcmFuc2l0aW9ucyk7CgovLzwvMS4yY29tcGF0PgoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kID0gZnVuY3Rpb24odHJhbnNpdGlvbnMpewoJZm9yICh2YXIgdHJhbnNpdGlvbiBpbiB0cmFuc2l0aW9ucykgRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbih0cmFuc2l0aW9uc1t0cmFuc2l0aW9uXSk7Cn07CgpGeC5UcmFuc2l0aW9ucy5leHRlbmQoewoKCVBvdzogZnVuY3Rpb24ocCwgeCl7CgkJcmV0dXJuIE1hdGgucG93KHAsIHggJiYgeFswXSB8fCA2KTsKCX0sCgoJRXhwbzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDggKiAocCAtIDEpKTsKCX0sCgoJQ2lyYzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLnNpbihNYXRoLmFjb3MocCkpOwoJfSwKCglTaW5lOiBmdW5jdGlvbihwKXsKCQlyZXR1cm4gMSAtIE1hdGguY29zKHAgKiBNYXRoLlBJIC8gMik7Cgl9LAoKCUJhY2s6IGZ1bmN0aW9uKHAsIHgpewoJCXggPSB4ICYmIHhbMF0gfHwgMS42MTg7CgkJcmV0dXJuIE1hdGgucG93KHAsIDIpICogKCh4ICsgMSkgKiBwIC0geCk7Cgl9LAoKCUJvdW5jZTogZnVuY3Rpb24ocCl7CgkJdmFyIHZhbHVlOwoJCWZvciAodmFyIGEgPSAwLCBiID0gMTsgMTsgYSArPSBiLCBiIC89IDIpewoJCQlpZiAocCA+PSAoNyAtIDQgKiBhKSAvIDExKXsKCQkJCXZhbHVlID0gYiAqIGIgLSBNYXRoLnBvdygoMTEgLSA2ICogYSAtIDExICogcCkgLyA0LCAyKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCXJldHVybiB2YWx1ZTsKCX0sCgoJRWxhc3RpYzogZnVuY3Rpb24ocCwgeCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDEwICogLS1wKSAqIE1hdGguY29zKDIwICogcCAqIE1hdGguUEkgKiAoeCAmJiB4WzBdIHx8IDEpIC8gMyk7Cgl9Cgp9KTsKClsnUXVhZCcsICdDdWJpYycsICdRdWFydCcsICdRdWludCddLmVhY2goZnVuY3Rpb24odHJhbnNpdGlvbiwgaSl7CglGeC5UcmFuc2l0aW9uc1t0cmFuc2l0aW9uXSA9IG5ldyBGeC5UcmFuc2l0aW9uKGZ1bmN0aW9uKHApewoJCXJldHVybiBNYXRoLnBvdyhwLCBpICsgMik7Cgl9KTsKfSk7CgoKLyoKLS0tCgpuYW1lOiBSZXF1ZXN0CgpkZXNjcmlwdGlvbjogUG93ZXJmdWwgYWxsIHB1cnBvc2UgUmVxdWVzdCBDbGFzcy4gVXNlcyBYTUxIVFRQUmVxdWVzdC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtPYmplY3QsIEVsZW1lbnQsIENoYWluLCBFdmVudHMsIE9wdGlvbnMsIEJyb3dzZXJdCgpwcm92aWRlczogUmVxdWVzdAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBlbXB0eSA9IGZ1bmN0aW9uKCl7fSwKCXByb2dyZXNzU3VwcG9ydCA9ICgnb25wcm9ncmVzcycgaW4gbmV3IEJyb3dzZXIuUmVxdWVzdCk7Cgp2YXIgUmVxdWVzdCA9IHRoaXMuUmVxdWVzdCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsvKgoJCW9uUmVxdWVzdDogZnVuY3Rpb24oKXt9LAoJCW9uTG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uUHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50LCB4aHIpe30sCgkJb25Db21wbGV0ZTogZnVuY3Rpb24oKXt9LAoJCW9uQ2FuY2VsOiBmdW5jdGlvbigpe30sCgkJb25TdWNjZXNzOiBmdW5jdGlvbihyZXNwb25zZVRleHQsIHJlc3BvbnNlWE1MKXt9LAoJCW9uRmFpbHVyZTogZnVuY3Rpb24oeGhyKXt9LAoJCW9uRXhjZXB0aW9uOiBmdW5jdGlvbihoZWFkZXJOYW1lLCB2YWx1ZSl7fSwKCQlvblRpbWVvdXQ6IGZ1bmN0aW9uKCl7fSwKCQl1c2VyOiAnJywKCQlwYXNzd29yZDogJycsKi8KCQl1cmw6ICcnLAoJCWRhdGE6ICcnLAoJCWhlYWRlcnM6IHsKCQkJJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnLAoJCQknQWNjZXB0JzogJ3RleHQvamF2YXNjcmlwdCwgdGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCgkJfSwKCQlhc3luYzogdHJ1ZSwKCQlmb3JtYXQ6IGZhbHNlLAoJCW1ldGhvZDogJ3Bvc3QnLAoJCWxpbms6ICdpZ25vcmUnLAoJCWlzU3VjY2VzczogbnVsbCwKCQllbXVsYXRpb246IHRydWUsCgkJdXJsRW5jb2RlZDogdHJ1ZSwKCQllbmNvZGluZzogJ3V0Zi04JywKCQlldmFsU2NyaXB0czogZmFsc2UsCgkJZXZhbFJlc3BvbnNlOiBmYWxzZSwKCQl0aW1lb3V0OiAwLAoJCW5vQ2FjaGU6IGZhbHNlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMueGhyID0gbmV3IEJyb3dzZXIuUmVxdWVzdCgpOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLm9wdGlvbnMuaGVhZGVyczsKCX0sCgoJb25TdGF0ZUNoYW5nZTogZnVuY3Rpb24oKXsKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJaWYgKHhoci5yZWFkeVN0YXRlICE9IDQgfHwgIXRoaXMucnVubmluZykgcmV0dXJuOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXRoaXMuc3RhdHVzID0gMDsKCQlGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJCXZhciBzdGF0dXMgPSB4aHIuc3RhdHVzOwoJCQl0aGlzLnN0YXR1cyA9IChzdGF0dXMgPT0gMTIyMykgPyAyMDQgOiBzdGF0dXM7CgkJfS5iaW5kKHRoaXMpKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCkgeGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBlbXB0eTsKCQljbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgoJCXRoaXMucmVzcG9uc2UgPSB7dGV4dDogdGhpcy54aHIucmVzcG9uc2VUZXh0IHx8ICcnLCB4bWw6IHRoaXMueGhyLnJlc3BvbnNlWE1MfTsKCQlpZiAodGhpcy5vcHRpb25zLmlzU3VjY2Vzcy5jYWxsKHRoaXMsIHRoaXMuc3RhdHVzKSkKCQkJdGhpcy5zdWNjZXNzKHRoaXMucmVzcG9uc2UudGV4dCwgdGhpcy5yZXNwb25zZS54bWwpOwoJCWVsc2UKCQkJdGhpcy5mYWlsdXJlKCk7Cgl9LAoKCWlzU3VjY2VzczogZnVuY3Rpb24oKXsKCQl2YXIgc3RhdHVzID0gdGhpcy5zdGF0dXM7CgkJcmV0dXJuIChzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCk7Cgl9LAoKCWlzUnVubmluZzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gISF0aGlzLnJ1bm5pbmc7Cgl9LAoKCXByb2Nlc3NTY3JpcHRzOiBmdW5jdGlvbih0ZXh0KXsKCQlpZiAodGhpcy5vcHRpb25zLmV2YWxSZXNwb25zZSB8fCAoLyhlY21hfGphdmEpc2NyaXB0LykudGVzdCh0aGlzLmdldEhlYWRlcignQ29udGVudC10eXBlJykpKSByZXR1cm4gQnJvd3Nlci5leGVjKHRleHQpOwoJCXJldHVybiB0ZXh0LnN0cmlwU2NyaXB0cyh0aGlzLm9wdGlvbnMuZXZhbFNjcmlwdHMpOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0LCB4bWwpewoJCXRoaXMub25TdWNjZXNzKHRoaXMucHJvY2Vzc1NjcmlwdHModGV4dCksIHhtbCk7Cgl9LAoKCW9uU3VjY2VzczogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgnY29tcGxldGUnLCBhcmd1bWVudHMpLmZpcmVFdmVudCgnc3VjY2VzcycsIGFyZ3VtZW50cykuY2FsbENoYWluKCk7Cgl9LAoKCWZhaWx1cmU6IGZ1bmN0aW9uKCl7CgkJdGhpcy5vbkZhaWx1cmUoKTsKCX0sCgoJb25GYWlsdXJlOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScpLmZpcmVFdmVudCgnZmFpbHVyZScsIHRoaXMueGhyKTsKCX0sCgoJbG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ2xvYWRzdGFydCcsIFtldmVudCwgdGhpcy54aHJdKTsKCX0sCgoJcHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50KXsKCQl0aGlzLmZpcmVFdmVudCgncHJvZ3Jlc3MnLCBbZXZlbnQsIHRoaXMueGhyXSk7Cgl9LAoKCXRpbWVvdXQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ3RpbWVvdXQnLCB0aGlzLnhocik7Cgl9LAoKCXNldEhlYWRlcjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewoJCXRoaXMuaGVhZGVyc1tuYW1lXSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUpewoJCXJldHVybiBGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJCXJldHVybiB0aGlzLnhoci5nZXRSZXNwb25zZUhlYWRlcihuYW1lKTsKCQl9LmJpbmQodGhpcykpOwoJfSwKCgljaGVjazogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMucnVubmluZykgcmV0dXJuIHRydWU7CgkJc3dpdGNoICh0aGlzLm9wdGlvbnMubGluayl7CgkJCWNhc2UgJ2NhbmNlbCc6IHRoaXMuY2FuY2VsKCk7IHJldHVybiB0cnVlOwoJCQljYXNlICdjaGFpbic6IHRoaXMuY2hhaW4odGhpcy5jYWxsZXIucGFzcyhhcmd1bWVudHMsIHRoaXMpKTsgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCXNlbmQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCWlmICghdGhpcy5jaGVjayhvcHRpb25zKSkgcmV0dXJuIHRoaXM7CgoJCXRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MgPSB0aGlzLm9wdGlvbnMuaXNTdWNjZXNzIHx8IHRoaXMuaXNTdWNjZXNzOwoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCXZhciB0eXBlID0gdHlwZU9mKG9wdGlvbnMpOwoJCWlmICh0eXBlID09ICdzdHJpbmcnIHx8IHR5cGUgPT0gJ2VsZW1lbnQnKSBvcHRpb25zID0ge2RhdGE6IG9wdGlvbnN9OwoKCQl2YXIgb2xkID0gdGhpcy5vcHRpb25zOwoJCW9wdGlvbnMgPSBPYmplY3QuYXBwZW5kKHtkYXRhOiBvbGQuZGF0YSwgdXJsOiBvbGQudXJsLCBtZXRob2Q6IG9sZC5tZXRob2R9LCBvcHRpb25zKTsKCQl2YXIgZGF0YSA9IG9wdGlvbnMuZGF0YSwgdXJsID0gU3RyaW5nKG9wdGlvbnMudXJsKSwgbWV0aG9kID0gb3B0aW9ucy5tZXRob2QudG9Mb3dlckNhc2UoKTsKCgkJc3dpdGNoICh0eXBlT2YoZGF0YSkpewoJCQljYXNlICdlbGVtZW50JzogZGF0YSA9IGRvY3VtZW50LmlkKGRhdGEpLnRvUXVlcnlTdHJpbmcoKTsgYnJlYWs7CgkJCWNhc2UgJ29iamVjdCc6IGNhc2UgJ2hhc2gnOiBkYXRhID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcoZGF0YSk7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmZvcm1hdCl7CgkJCXZhciBmb3JtYXQgPSAnZm9ybWF0PScgKyB0aGlzLm9wdGlvbnMuZm9ybWF0OwoJCQlkYXRhID0gKGRhdGEpID8gZm9ybWF0ICsgJyYnICsgZGF0YSA6IGZvcm1hdDsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMuZW11bGF0aW9uICYmICFbJ2dldCcsICdwb3N0J10uY29udGFpbnMobWV0aG9kKSl7CgkJCXZhciBfbWV0aG9kID0gJ19tZXRob2Q9JyArIG1ldGhvZDsKCQkJZGF0YSA9IChkYXRhKSA/IF9tZXRob2QgKyAnJicgKyBkYXRhIDogX21ldGhvZDsKCQkJbWV0aG9kID0gJ3Bvc3QnOwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy51cmxFbmNvZGVkICYmIFsncG9zdCcsICdwdXQnXS5jb250YWlucyhtZXRob2QpKXsKCQkJdmFyIGVuY29kaW5nID0gKHRoaXMub3B0aW9ucy5lbmNvZGluZykgPyAnOyBjaGFyc2V0PScgKyB0aGlzLm9wdGlvbnMuZW5jb2RpbmcgOiAnJzsKCQkJdGhpcy5oZWFkZXJzWydDb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnICsgZW5jb2Rpbmc7CgkJfQoKCQlpZiAoIXVybCkgdXJsID0gZG9jdW1lbnQubG9jYXRpb24ucGF0aG5hbWU7CgoJCXZhciB0cmltUG9zaXRpb24gPSB1cmwubGFzdEluZGV4T2YoJy8nKTsKCQlpZiAodHJpbVBvc2l0aW9uID4gLTEgJiYgKHRyaW1Qb3NpdGlvbiA9IHVybC5pbmRleE9mKCcjJykpID4gLTEpIHVybCA9IHVybC5zdWJzdHIoMCwgdHJpbVBvc2l0aW9uKTsKCgkJaWYgKHRoaXMub3B0aW9ucy5ub0NhY2hlKQoJCQl1cmwgKz0gKHVybC5jb250YWlucygnPycpID8gJyYnIDogJz8nKSArIFN0cmluZy51bmlxdWVJRCgpOwoKCQlpZiAoZGF0YSAmJiBtZXRob2QgPT0gJ2dldCcpewoJCQl1cmwgKz0gKHVybC5jb250YWlucygnPycpID8gJyYnIDogJz8nKSArIGRhdGE7CgkJCWRhdGEgPSBudWxsOwoJCX0KCgkJdmFyIHhociA9IHRoaXMueGhyOwoJCWlmIChwcm9ncmVzc1N1cHBvcnQpewoJCQl4aHIub25sb2Fkc3RhcnQgPSB0aGlzLmxvYWRzdGFydC5iaW5kKHRoaXMpOwoJCQl4aHIub25wcm9ncmVzcyA9IHRoaXMucHJvZ3Jlc3MuYmluZCh0aGlzKTsKCQl9CgoJCXhoci5vcGVuKG1ldGhvZC50b1VwcGVyQ2FzZSgpLCB1cmwsIHRoaXMub3B0aW9ucy5hc3luYywgdGhpcy5vcHRpb25zLnVzZXIsIHRoaXMub3B0aW9ucy5wYXNzd29yZCk7CgkJaWYgKHRoaXMub3B0aW9ucy51c2VyICYmICd3aXRoQ3JlZGVudGlhbHMnIGluIHhocikgeGhyLndpdGhDcmVkZW50aWFscyA9IHRydWU7CgoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSB0aGlzLm9uU3RhdGVDaGFuZ2UuYmluZCh0aGlzKTsKCgkJT2JqZWN0LmVhY2godGhpcy5oZWFkZXJzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJdHJ5IHsKCQkJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwoJCQl9IGNhdGNoIChlKXsKCQkJCXRoaXMuZmlyZUV2ZW50KCdleGNlcHRpb24nLCBba2V5LCB2YWx1ZV0pOwoJCQl9CgkJfSwgdGhpcyk7CgoJCXRoaXMuZmlyZUV2ZW50KCdyZXF1ZXN0Jyk7CgkJeGhyLnNlbmQoZGF0YSk7CgkJaWYgKCF0aGlzLm9wdGlvbnMuYXN5bmMpIHRoaXMub25TdGF0ZUNoYW5nZSgpOwoJCWVsc2UgaWYgKHRoaXMub3B0aW9ucy50aW1lb3V0KSB0aGlzLnRpbWVyID0gdGhpcy50aW1lb3V0LmRlbGF5KHRoaXMub3B0aW9ucy50aW1lb3V0LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2FuY2VsOiBmdW5jdGlvbigpewoJCWlmICghdGhpcy5ydW5uaW5nKSByZXR1cm4gdGhpczsKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJeGhyLmFib3J0KCk7CgkJY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eTsKCQlpZiAocHJvZ3Jlc3NTdXBwb3J0KSB4aHIub25wcm9ncmVzcyA9IHhoci5vbmxvYWRzdGFydCA9IGVtcHR5OwoJCXRoaXMueGhyID0gbmV3IEJyb3dzZXIuUmVxdWVzdCgpOwoJCXRoaXMuZmlyZUV2ZW50KCdjYW5jZWwnKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKdmFyIG1ldGhvZHMgPSB7fTsKWydnZXQnLCAncG9zdCcsICdwdXQnLCAnZGVsZXRlJywgJ0dFVCcsICdQT1NUJywgJ1BVVCcsICdERUxFVEUnXS5lYWNoKGZ1bmN0aW9uKG1ldGhvZCl7CgltZXRob2RzW21ldGhvZF0gPSBmdW5jdGlvbihkYXRhKXsKCQl2YXIgb2JqZWN0ID0gewoJCQltZXRob2Q6IG1ldGhvZAoJCX07CgkJaWYgKGRhdGEgIT0gbnVsbCkgb2JqZWN0LmRhdGEgPSBkYXRhOwoJCXJldHVybiB0aGlzLnNlbmQob2JqZWN0KTsKCX07Cn0pOwoKUmVxdWVzdC5pbXBsZW1lbnQobWV0aG9kcyk7CgpFbGVtZW50LlByb3BlcnRpZXMuc2VuZCA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXZhciBzZW5kID0gdGhpcy5nZXQoJ3NlbmQnKS5jYW5jZWwoKTsKCQlzZW5kLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgc2VuZCA9IHRoaXMucmV0cmlldmUoJ3NlbmQnKTsKCQlpZiAoIXNlbmQpewoJCQlzZW5kID0gbmV3IFJlcXVlc3QoewoJCQkJZGF0YTogdGhpcywgbGluazogJ2NhbmNlbCcsIG1ldGhvZDogdGhpcy5nZXQoJ21ldGhvZCcpIHx8ICdwb3N0JywgdXJsOiB0aGlzLmdldCgnYWN0aW9uJykKCQkJfSk7CgkJCXRoaXMuc3RvcmUoJ3NlbmQnLCBzZW5kKTsKCQl9CgkJcmV0dXJuIHNlbmQ7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNlbmQ6IGZ1bmN0aW9uKHVybCl7CgkJdmFyIHNlbmRlciA9IHRoaXMuZ2V0KCdzZW5kJyk7CgkJc2VuZGVyLnNlbmQoe2RhdGE6IHRoaXMsIHVybDogdXJsIHx8IHNlbmRlci5vcHRpb25zLnVybH0pOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogUmVxdWVzdC5IVE1MCgpkZXNjcmlwdGlvbjogRXh0ZW5kcyB0aGUgYmFzaWMgUmVxdWVzdCBDbGFzcyB3aXRoIGFkZGl0aW9uYWwgbWV0aG9kcyBmb3IgaW50ZXJhY3Rpbmcgd2l0aCBIVE1MIHJlc3BvbnNlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBSZXF1ZXN0XQoKcHJvdmlkZXM6IFJlcXVlc3QuSFRNTAoKLi4uCiovCgpSZXF1ZXN0LkhUTUwgPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IFJlcXVlc3QsCgoJb3B0aW9uczogewoJCXVwZGF0ZTogZmFsc2UsCgkJYXBwZW5kOiBmYWxzZSwKCQlldmFsU2NyaXB0czogdHJ1ZSwKCQlmaWx0ZXI6IGZhbHNlLAoJCWhlYWRlcnM6IHsKCQkJQWNjZXB0OiAndGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCgkJfQoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0KXsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywgcmVzcG9uc2UgPSB0aGlzLnJlc3BvbnNlOwoKCQlyZXNwb25zZS5odG1sID0gdGV4dC5zdHJpcFNjcmlwdHMoZnVuY3Rpb24oc2NyaXB0KXsKCQkJcmVzcG9uc2UuamF2YXNjcmlwdCA9IHNjcmlwdDsKCQl9KTsKCgkJdmFyIG1hdGNoID0gcmVzcG9uc2UuaHRtbC5tYXRjaCgvPGJvZHlbXj5dKj4oW1xzXFNdKj8pPFwvYm9keT4vaSk7CgkJaWYgKG1hdGNoKSByZXNwb25zZS5odG1sID0gbWF0Y2hbMV07CgkJdmFyIHRlbXAgPSBuZXcgRWxlbWVudCgnZGl2Jykuc2V0KCdodG1sJywgcmVzcG9uc2UuaHRtbCk7CgoJCXJlc3BvbnNlLnRyZWUgPSB0ZW1wLmNoaWxkTm9kZXM7CgkJcmVzcG9uc2UuZWxlbWVudHMgPSB0ZW1wLmdldEVsZW1lbnRzKG9wdGlvbnMuZmlsdGVyIHx8ICcqJyk7CgoJCWlmIChvcHRpb25zLmZpbHRlcikgcmVzcG9uc2UudHJlZSA9IHJlc3BvbnNlLmVsZW1lbnRzOwoJCWlmIChvcHRpb25zLnVwZGF0ZSl7CgkJCXZhciB1cGRhdGUgPSBkb2N1bWVudC5pZChvcHRpb25zLnVwZGF0ZSkuZW1wdHkoKTsKCQkJaWYgKG9wdGlvbnMuZmlsdGVyKSB1cGRhdGUuYWRvcHQocmVzcG9uc2UuZWxlbWVudHMpOwoJCQllbHNlIHVwZGF0ZS5zZXQoJ2h0bWwnLCByZXNwb25zZS5odG1sKTsKCQl9IGVsc2UgaWYgKG9wdGlvbnMuYXBwZW5kKXsKCQkJdmFyIGFwcGVuZCA9IGRvY3VtZW50LmlkKG9wdGlvbnMuYXBwZW5kKTsKCQkJaWYgKG9wdGlvbnMuZmlsdGVyKSByZXNwb25zZS5lbGVtZW50cy5yZXZlcnNlKCkuaW5qZWN0KGFwcGVuZCk7CgkJCWVsc2UgYXBwZW5kLmFkb3B0KHRlbXAuZ2V0Q2hpbGRyZW4oKSk7CgkJfQoJCWlmIChvcHRpb25zLmV2YWxTY3JpcHRzKSBCcm93c2VyLmV4ZWMocmVzcG9uc2UuamF2YXNjcmlwdCk7CgoJCXRoaXMub25TdWNjZXNzKHJlc3BvbnNlLnRyZWUsIHJlc3BvbnNlLmVsZW1lbnRzLCByZXNwb25zZS5odG1sLCByZXNwb25zZS5qYXZhc2NyaXB0KTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLmxvYWQgPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgbG9hZCA9IHRoaXMuZ2V0KCdsb2FkJykuY2FuY2VsKCk7CgkJbG9hZC5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIGxvYWQgPSB0aGlzLnJldHJpZXZlKCdsb2FkJyk7CgkJaWYgKCFsb2FkKXsKCQkJbG9hZCA9IG5ldyBSZXF1ZXN0LkhUTUwoe2RhdGE6IHRoaXMsIGxpbms6ICdjYW5jZWwnLCB1cGRhdGU6IHRoaXMsIG1ldGhvZDogJ2dldCd9KTsKCQkJdGhpcy5zdG9yZSgnbG9hZCcsIGxvYWQpOwoJCX0KCQlyZXR1cm4gbG9hZDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJbG9hZDogZnVuY3Rpb24oKXsKCQl0aGlzLmdldCgnbG9hZCcpLnNlbmQoQXJyYXkubGluayhhcmd1bWVudHMsIHtkYXRhOiBUeXBlLmlzT2JqZWN0LCB1cmw6IFR5cGUuaXNTdHJpbmd9KSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEpTT04KCmRlc2NyaXB0aW9uOiBKU09OIGVuY29kZXIgYW5kIGRlY29kZXIuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KClNlZUFsc286IDxodHRwOi8vd3d3Lmpzb24ub3JnLz4KCnJlcXVpcmVzOiBbQXJyYXksIFN0cmluZywgTnVtYmVyLCBGdW5jdGlvbl0KCnByb3ZpZGVzOiBKU09OCgouLi4KKi8KCmlmICh0eXBlb2YgSlNPTiA9PSAndW5kZWZpbmVkJykgdGhpcy5KU09OID0ge307CgovLzwxLjJjb21wYXQ+CgpKU09OID0gbmV3IEhhc2goewoJc3RyaW5naWZ5OiBKU09OLnN0cmluZ2lmeSwKCXBhcnNlOiBKU09OLnBhcnNlCn0pOwoKLy88LzEuMmNvbXBhdD4KCihmdW5jdGlvbigpewoKdmFyIHNwZWNpYWwgPSB7J1xiJzogJ1xcYicsICdcdCc6ICdcXHQnLCAnXG4nOiAnXFxuJywgJ1xmJzogJ1xcZicsICdccic6ICdcXHInLCAnIicgOiAnXFwiJywgJ1xcJzogJ1xcXFwnfTsKCnZhciBlc2NhcGUgPSBmdW5jdGlvbihjaHIpewoJcmV0dXJuIHNwZWNpYWxbY2hyXSB8fCAnXFx1JyArICgnMDAwMCcgKyBjaHIuY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikpLnNsaWNlKC00KTsKfTsKCkpTT04udmFsaWRhdGUgPSBmdW5jdGlvbihzdHJpbmcpewoJc3RyaW5nID0gc3RyaW5nLnJlcGxhY2UoL1xcKD86WyJcXFwvYmZucnRdfHVbMC05YS1mQS1GXXs0fSkvZywgJ0AnKS4KCQkJCQlyZXBsYWNlKC8iW14iXFxcblxyXSoifHRydWV8ZmFsc2V8bnVsbHwtP1xkKyg/OlwuXGQqKT8oPzpbZUVdWytcLV0/XGQrKT8vZywgJ10nKS4KCQkJCQlyZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICcnKTsKCglyZXR1cm4gKC9eW1xdLDp7fVxzXSokLykudGVzdChzdHJpbmcpOwp9OwoKSlNPTi5lbmNvZGUgPSBKU09OLnN0cmluZ2lmeSA/IGZ1bmN0aW9uKG9iail7CglyZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqKTsKfSA6IGZ1bmN0aW9uKG9iail7CglpZiAob2JqICYmIG9iai50b0pTT04pIG9iaiA9IG9iai50b0pTT04oKTsKCglzd2l0Y2ggKHR5cGVPZihvYmopKXsKCQljYXNlICdzdHJpbmcnOgoJCQlyZXR1cm4gJyInICsgb2JqLnJlcGxhY2UoL1tceDAwLVx4MWZcXCJdL2csIGVzY2FwZSkgKyAnIic7CgkJY2FzZSAnYXJyYXknOgoJCQlyZXR1cm4gJ1snICsgb2JqLm1hcChKU09OLmVuY29kZSkuY2xlYW4oKSArICddJzsKCQljYXNlICdvYmplY3QnOiBjYXNlICdoYXNoJzoKCQkJdmFyIHN0cmluZyA9IFtdOwoJCQlPYmplY3QuZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQkJdmFyIGpzb24gPSBKU09OLmVuY29kZSh2YWx1ZSk7CgkJCQlpZiAoanNvbikgc3RyaW5nLnB1c2goSlNPTi5lbmNvZGUoa2V5KSArICc6JyArIGpzb24pOwoJCQl9KTsKCQkJcmV0dXJuICd7JyArIHN0cmluZyArICd9JzsKCQljYXNlICdudW1iZXInOiBjYXNlICdib29sZWFuJzogcmV0dXJuICcnICsgb2JqOwoJCWNhc2UgJ251bGwnOiByZXR1cm4gJ251bGwnOwoJfQoKCXJldHVybiBudWxsOwp9OwoKSlNPTi5kZWNvZGUgPSBmdW5jdGlvbihzdHJpbmcsIHNlY3VyZSl7CglpZiAoIXN0cmluZyB8fCB0eXBlT2Yoc3RyaW5nKSAhPSAnc3RyaW5nJykgcmV0dXJuIG51bGw7CgoJaWYgKHNlY3VyZSB8fCBKU09OLnNlY3VyZSl7CgkJaWYgKEpTT04ucGFyc2UpIHJldHVybiBKU09OLnBhcnNlKHN0cmluZyk7CgkJaWYgKCFKU09OLnZhbGlkYXRlKHN0cmluZykpIHRocm93IG5ldyBFcnJvcignSlNPTiBjb3VsZCBub3QgZGVjb2RlIHRoZSBpbnB1dDsgc2VjdXJpdHkgaXMgZW5hYmxlZCBhbmQgdGhlIHZhbHVlIGlzIG5vdCBzZWN1cmUuJyk7Cgl9CgoJcmV0dXJuIGV2YWwoJygnICsgc3RyaW5nICsgJyknKTsKfTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBSZXF1ZXN0LkpTT04KCmRlc2NyaXB0aW9uOiBFeHRlbmRzIHRoZSBiYXNpYyBSZXF1ZXN0IENsYXNzIHdpdGggYWRkaXRpb25hbCBtZXRob2RzIGZvciBzZW5kaW5nIGFuZCByZWNlaXZpbmcgSlNPTiBkYXRhLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW1JlcXVlc3QsIEpTT05dCgpwcm92aWRlczogUmVxdWVzdC5KU09OCgouLi4KKi8KClJlcXVlc3QuSlNPTiA9IG5ldyBDbGFzcyh7CgoJRXh0ZW5kczogUmVxdWVzdCwKCglvcHRpb25zOiB7CgkJLypvbkVycm9yOiBmdW5jdGlvbih0ZXh0LCBlcnJvcil7fSwqLwoJCXNlY3VyZTogdHJ1ZQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCQlPYmplY3QuYXBwZW5kKHRoaXMuaGVhZGVycywgewoJCQknQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLAoJCQknWC1SZXF1ZXN0JzogJ0pTT04nCgkJfSk7Cgl9LAoKCXN1Y2Nlc3M6IGZ1bmN0aW9uKHRleHQpewoJCXZhciBqc29uOwoJCXRyeSB7CgkJCWpzb24gPSB0aGlzLnJlc3BvbnNlLmpzb24gPSBKU09OLmRlY29kZSh0ZXh0LCB0aGlzLm9wdGlvbnMuc2VjdXJlKTsKCQl9IGNhdGNoIChlcnJvcil7CgkJCXRoaXMuZmlyZUV2ZW50KCdlcnJvcicsIFt0ZXh0LCBlcnJvcl0pOwoJCQlyZXR1cm47CgkJfQoJCWlmIChqc29uID09IG51bGwpIHRoaXMub25GYWlsdXJlKCk7CgkJZWxzZSB0aGlzLm9uU3VjY2Vzcyhqc29uLCB0ZXh0KTsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogQ29va2llCgpkZXNjcmlwdGlvbjogQ2xhc3MgZm9yIGNyZWF0aW5nLCByZWFkaW5nLCBhbmQgZGVsZXRpbmcgYnJvd3NlciBDb29raWVzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gQmFzZWQgb24gdGhlIGZ1bmN0aW9ucyBieSBQZXRlci1QYXVsIEtvY2ggKGh0dHA6Ly9xdWlya3Ntb2RlLm9yZykuCgpyZXF1aXJlczogW09wdGlvbnMsIEJyb3dzZXJdCgpwcm92aWRlczogQ29va2llCgouLi4KKi8KCnZhciBDb29raWUgPSBuZXcgQ2xhc3MoewoKCUltcGxlbWVudHM6IE9wdGlvbnMsCgoJb3B0aW9uczogewoJCXBhdGg6ICcvJywKCQlkb21haW46IGZhbHNlLAoJCWR1cmF0aW9uOiBmYWxzZSwKCQlzZWN1cmU6IGZhbHNlLAoJCWRvY3VtZW50OiBkb2N1bWVudCwKCQllbmNvZGU6IHRydWUKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oa2V5LCBvcHRpb25zKXsKCQl0aGlzLmtleSA9IGtleTsKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7Cgl9LAoKCXdyaXRlOiBmdW5jdGlvbih2YWx1ZSl7CgkJaWYgKHRoaXMub3B0aW9ucy5lbmNvZGUpIHZhbHVlID0gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKCQlpZiAodGhpcy5vcHRpb25zLmRvbWFpbikgdmFsdWUgKz0gJzsgZG9tYWluPScgKyB0aGlzLm9wdGlvbnMuZG9tYWluOwoJCWlmICh0aGlzLm9wdGlvbnMucGF0aCkgdmFsdWUgKz0gJzsgcGF0aD0nICsgdGhpcy5vcHRpb25zLnBhdGg7CgkJaWYgKHRoaXMub3B0aW9ucy5kdXJhdGlvbil7CgkJCXZhciBkYXRlID0gbmV3IERhdGUoKTsKCQkJZGF0ZS5zZXRUaW1lKGRhdGUuZ2V0VGltZSgpICsgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogMjQgKiA2MCAqIDYwICogMTAwMCk7CgkJCXZhbHVlICs9ICc7IGV4cGlyZXM9JyArIGRhdGUudG9HTVRTdHJpbmcoKTsKCQl9CgkJaWYgKHRoaXMub3B0aW9ucy5zZWN1cmUpIHZhbHVlICs9ICc7IHNlY3VyZSc7CgkJdGhpcy5vcHRpb25zLmRvY3VtZW50LmNvb2tpZSA9IHRoaXMua2V5ICsgJz0nICsgdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlYWQ6IGZ1bmN0aW9uKCl7CgkJdmFyIHZhbHVlID0gdGhpcy5vcHRpb25zLmRvY3VtZW50LmNvb2tpZS5tYXRjaCgnKD86Xnw7KVxccyonICsgdGhpcy5rZXkuZXNjYXBlUmVnRXhwKCkgKyAnPShbXjtdKiknKTsKCQlyZXR1cm4gKHZhbHVlKSA/IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZVsxXSkgOiBudWxsOwoJfSwKCglkaXNwb3NlOiBmdW5jdGlvbigpewoJCW5ldyBDb29raWUodGhpcy5rZXksIE9iamVjdC5tZXJnZSh7fSwgdGhpcy5vcHRpb25zLCB7ZHVyYXRpb246IC0xfSkpLndyaXRlKCcnKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKQ29va2llLndyaXRlID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSwgb3B0aW9ucyl7CglyZXR1cm4gbmV3IENvb2tpZShrZXksIG9wdGlvbnMpLndyaXRlKHZhbHVlKTsKfTsKCkNvb2tpZS5yZWFkID0gZnVuY3Rpb24oa2V5KXsKCXJldHVybiBuZXcgQ29va2llKGtleSkucmVhZCgpOwp9OwoKQ29va2llLmRpc3Bvc2UgPSBmdW5jdGlvbihrZXksIG9wdGlvbnMpewoJcmV0dXJuIG5ldyBDb29raWUoa2V5LCBvcHRpb25zKS5kaXNwb3NlKCk7Cn07CgoKLyoKLS0tCgpuYW1lOiBET01SZWFkeQoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBjdXN0b20gZXZlbnQgZG9tcmVhZHkuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQnJvd3NlciwgRWxlbWVudCwgRWxlbWVudC5FdmVudF0KCnByb3ZpZGVzOiBbRE9NUmVhZHksIERvbVJlYWR5XQoKLi4uCiovCgooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCl7Cgp2YXIgcmVhZHksCglsb2FkZWQsCgljaGVja3MgPSBbXSwKCXNob3VsZFBvbGwsCgl0aW1lciwKCXRlc3RFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7Cgp2YXIgZG9tcmVhZHkgPSBmdW5jdGlvbigpewoJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCWlmIChyZWFkeSkgcmV0dXJuOwoJQnJvd3Nlci5sb2FkZWQgPSByZWFkeSA9IHRydWU7Cglkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbXJlYWR5KS5yZW1vdmVMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGNoZWNrKTsKCglkb2N1bWVudC5maXJlRXZlbnQoJ2RvbXJlYWR5Jyk7Cgl3aW5kb3cuZmlyZUV2ZW50KCdkb21yZWFkeScpOwp9OwoKdmFyIGNoZWNrID0gZnVuY3Rpb24oKXsKCWZvciAodmFyIGkgPSBjaGVja3MubGVuZ3RoOyBpLS07KSBpZiAoY2hlY2tzW2ldKCkpewoJCWRvbXJlYWR5KCk7CgkJcmV0dXJuIHRydWU7Cgl9CglyZXR1cm4gZmFsc2U7Cn07Cgp2YXIgcG9sbCA9IGZ1bmN0aW9uKCl7CgljbGVhclRpbWVvdXQodGltZXIpOwoJaWYgKCFjaGVjaygpKSB0aW1lciA9IHNldFRpbWVvdXQocG9sbCwgMTApOwp9OwoKZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21yZWFkeSk7CgovKjxsdElFOD4qLwovLyBkb1Njcm9sbCB0ZWNobmlxdWUgYnkgRGllZ28gUGVyaW5pIGh0dHA6Ly9qYXZhc2NyaXB0Lm53Ym94LmNvbS9JRUNvbnRlbnRMb2FkZWQvCi8vIHRlc3RFbGVtZW50LmRvU2Nyb2xsKCkgdGhyb3dzIHdoZW4gdGhlIERPTSBpcyBub3QgcmVhZHksIG9ubHkgaW4gdGhlIHRvcCB3aW5kb3cKdmFyIGRvU2Nyb2xsV29ya3MgPSBmdW5jdGlvbigpewoJdHJ5IHsKCQl0ZXN0RWxlbWVudC5kb1Njcm9sbCgpOwoJCXJldHVybiB0cnVlOwoJfSBjYXRjaCAoZSl7fQoJcmV0dXJuIGZhbHNlOwp9OwovLyBJZiBkb1Njcm9sbCB3b3JrcyBhbHJlYWR5LCBpdCBjYW4ndCBiZSB1c2VkIHRvIGRldGVybWluZSBkb21yZWFkeQovLyAgIGUuZy4gaW4gYW4gaWZyYW1lCmlmICh0ZXN0RWxlbWVudC5kb1Njcm9sbCAmJiAhZG9TY3JvbGxXb3JrcygpKXsKCWNoZWNrcy5wdXNoKGRvU2Nyb2xsV29ya3MpOwoJc2hvdWxkUG9sbCA9IHRydWU7Cn0KLyo8L2x0SUU4PiovCgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSkgY2hlY2tzLnB1c2goZnVuY3Rpb24oKXsKCXZhciBzdGF0ZSA9IGRvY3VtZW50LnJlYWR5U3RhdGU7CglyZXR1cm4gKHN0YXRlID09ICdsb2FkZWQnIHx8IHN0YXRlID09ICdjb21wbGV0ZScpOwp9KTsKCmlmICgnb25yZWFkeXN0YXRlY2hhbmdlJyBpbiBkb2N1bWVudCkgZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBjaGVjayk7CmVsc2Ugc2hvdWxkUG9sbCA9IHRydWU7CgppZiAoc2hvdWxkUG9sbCkgcG9sbCgpOwoKRWxlbWVudC5FdmVudHMuZG9tcmVhZHkgPSB7CglvbkFkZDogZnVuY3Rpb24oZm4pewoJCWlmIChyZWFkeSkgZm4uY2FsbCh0aGlzKTsKCX0KfTsKCi8vIE1ha2Ugc3VyZSB0aGF0IGRvbXJlYWR5IGZpcmVzIGJlZm9yZSBsb2FkCkVsZW1lbnQuRXZlbnRzLmxvYWQgPSB7CgliYXNlOiAnbG9hZCcsCglvbkFkZDogZnVuY3Rpb24oZm4pewoJCWlmIChsb2FkZWQgJiYgdGhpcyA9PSB3aW5kb3cpIGZuLmNhbGwodGhpcyk7Cgl9LAoJY29uZGl0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzID09IHdpbmRvdyl7CgkJCWRvbXJlYWR5KCk7CgkJCWRlbGV0ZSBFbGVtZW50LkV2ZW50cy5sb2FkOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0KfTsKCi8vIFRoaXMgaXMgYmFzZWQgb24gdGhlIGN1c3RvbSBsb2FkIGV2ZW50CndpbmRvdy5hZGRFdmVudCgnbG9hZCcsIGZ1bmN0aW9uKCl7Cglsb2FkZWQgPSB0cnVlOwp9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwoKCi8qCi0tLQoKbmFtZTogU3dpZmYKCmRlc2NyaXB0aW9uOiBXcmFwcGVyIGZvciBlbWJlZGRpbmcgU1dGIG1vdmllcy4gU3VwcG9ydHMgRXh0ZXJuYWwgSW50ZXJmYWNlIENvbW11bmljYXRpb24uCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBGbGFzaCBkZXRlY3Rpb24gJiBJbnRlcm5ldCBFeHBsb3JlciArIEZsYXNoIFBsYXllciA5IGZpeCBpbnNwaXJlZCBieSBTV0ZPYmplY3QuCgpyZXF1aXJlczogW09wdGlvbnMsIE9iamVjdCwgRWxlbWVudF0KCnByb3ZpZGVzOiBTd2lmZgoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBTd2lmZiA9IHRoaXMuU3dpZmYgPSBuZXcgQ2xhc3MoewoKCUltcGxlbWVudHM6IE9wdGlvbnMsCgoJb3B0aW9uczogewoJCWlkOiBudWxsLAoJCWhlaWdodDogMSwKCQl3aWR0aDogMSwKCQljb250YWluZXI6IG51bGwsCgkJcHJvcGVydGllczoge30sCgkJcGFyYW1zOiB7CgkJCXF1YWxpdHk6ICdoaWdoJywKCQkJYWxsb3dTY3JpcHRBY2Nlc3M6ICdhbHdheXMnLAoJCQl3TW9kZTogJ3dpbmRvdycsCgkJCXN3TGl2ZUNvbm5lY3Q6IHRydWUKCQl9LAoJCWNhbGxCYWNrczoge30sCgkJdmFyczoge30KCX0sCgoJdG9FbGVtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLm9iamVjdDsKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ocGF0aCwgb3B0aW9ucyl7CgkJdGhpcy5pbnN0YW5jZSA9ICdTd2lmZl8nICsgU3RyaW5nLnVuaXF1ZUlEKCk7CgoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoJCXZhciBpZCA9IHRoaXMuaWQgPSBvcHRpb25zLmlkIHx8IHRoaXMuaW5zdGFuY2U7CgkJdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmlkKG9wdGlvbnMuY29udGFpbmVyKTsKCgkJU3dpZmYuQ2FsbEJhY2tzW3RoaXMuaW5zdGFuY2VdID0ge307CgoJCXZhciBwYXJhbXMgPSBvcHRpb25zLnBhcmFtcywgdmFycyA9IG9wdGlvbnMudmFycywgY2FsbEJhY2tzID0gb3B0aW9ucy5jYWxsQmFja3M7CgkJdmFyIHByb3BlcnRpZXMgPSBPYmplY3QuYXBwZW5kKHtoZWlnaHQ6IG9wdGlvbnMuaGVpZ2h0LCB3aWR0aDogb3B0aW9ucy53aWR0aH0sIG9wdGlvbnMucHJvcGVydGllcyk7CgoJCXZhciBzZWxmID0gdGhpczsKCgkJZm9yICh2YXIgY2FsbEJhY2sgaW4gY2FsbEJhY2tzKXsKCQkJU3dpZmYuQ2FsbEJhY2tzW3RoaXMuaW5zdGFuY2VdW2NhbGxCYWNrXSA9IChmdW5jdGlvbihvcHRpb24pewoJCQkJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJCQkJcmV0dXJuIG9wdGlvbi5hcHBseShzZWxmLm9iamVjdCwgYXJndW1lbnRzKTsKCQkJCX07CgkJCX0pKGNhbGxCYWNrc1tjYWxsQmFja10pOwoJCQl2YXJzW2NhbGxCYWNrXSA9ICdTd2lmZi5DYWxsQmFja3MuJyArIHRoaXMuaW5zdGFuY2UgKyAnLicgKyBjYWxsQmFjazsKCQl9CgoJCXBhcmFtcy5mbGFzaFZhcnMgPSBPYmplY3QudG9RdWVyeVN0cmluZyh2YXJzKTsKCQlpZiAoQnJvd3Nlci5pZSl7CgkJCXByb3BlcnRpZXMuY2xhc3NpZCA9ICdjbHNpZDpEMjdDREI2RS1BRTZELTExY2YtOTZCOC00NDQ1NTM1NDAwMDAnOwoJCQlwYXJhbXMubW92aWUgPSBwYXRoOwoJCX0gZWxzZSB7CgkJCXByb3BlcnRpZXMudHlwZSA9ICdhcHBsaWNhdGlvbi94LXNob2Nrd2F2ZS1mbGFzaCc7CgkJfQoJCXByb3BlcnRpZXMuZGF0YSA9IHBhdGg7CgoJCXZhciBidWlsZCA9ICc8b2JqZWN0IGlkPSInICsgaWQgKyAnIic7CgkJZm9yICh2YXIgcHJvcGVydHkgaW4gcHJvcGVydGllcykgYnVpbGQgKz0gJyAnICsgcHJvcGVydHkgKyAnPSInICsgcHJvcGVydGllc1twcm9wZXJ0eV0gKyAnIic7CgkJYnVpbGQgKz0gJz4nOwoJCWZvciAodmFyIHBhcmFtIGluIHBhcmFtcyl7CgkJCWlmIChwYXJhbXNbcGFyYW1dKSBidWlsZCArPSAnPHBhcmFtIG5hbWU9IicgKyBwYXJhbSArICciIHZhbHVlPSInICsgcGFyYW1zW3BhcmFtXSArICciIC8+JzsKCQl9CgkJYnVpbGQgKz0gJzwvb2JqZWN0Pic7CgkJdGhpcy5vYmplY3QgPSAoKGNvbnRhaW5lcikgPyBjb250YWluZXIuZW1wdHkoKSA6IG5ldyBFbGVtZW50KCdkaXYnKSkuc2V0KCdodG1sJywgYnVpbGQpLmZpcnN0Q2hpbGQ7Cgl9LAoKCXJlcGxhY2VzOiBmdW5jdGlvbihlbGVtZW50KXsKCQllbGVtZW50ID0gZG9jdW1lbnQuaWQoZWxlbWVudCwgdHJ1ZSk7CgkJZWxlbWVudC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZCh0aGlzLnRvRWxlbWVudCgpLCBlbGVtZW50KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaW5qZWN0OiBmdW5jdGlvbihlbGVtZW50KXsKCQlkb2N1bWVudC5pZChlbGVtZW50LCB0cnVlKS5hcHBlbmRDaGlsZCh0aGlzLnRvRWxlbWVudCgpKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3RlOiBmdW5jdGlvbigpewoJCXJldHVybiBTd2lmZi5yZW1vdGUuYXBwbHkoU3dpZmYsIFt0aGlzLnRvRWxlbWVudCgpXS5hcHBlbmQoYXJndW1lbnRzKSk7Cgl9Cgp9KTsKClN3aWZmLkNhbGxCYWNrcyA9IHt9OwoKU3dpZmYucmVtb3RlID0gZnVuY3Rpb24ob2JqLCBmbil7Cgl2YXIgcnMgPSBvYmouQ2FsbEZ1bmN0aW9uKCc8aW52b2tlIG5hbWU9IicgKyBmbiArICciIHJldHVybnR5cGU9ImphdmFzY3JpcHQiPicgKyBfX2ZsYXNoX19hcmd1bWVudHNUb1hNTChhcmd1bWVudHMsIDIpICsgJzwvaW52b2tlPicpOwoJcmV0dXJuIGV2YWwocnMpOwp9OwoKfSkoKTsKCg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 23:24:53 GMT",
                    "Content-Length": "160495",
                    "Date": "Thu, 06 Nov 2014 23:24:54 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}