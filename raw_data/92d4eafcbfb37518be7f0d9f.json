{
    "url": "http://localhost:9999/menglr/turbolinks/lib/assets/javascripts/turbolinks.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>document.location.hash</b> and written to <b>window.history.replaceState()</b> via the following statements:<ul><li>preservedHash = location.hasNoHash() ? document.location.hash : '';</li><li>return window.history.replaceState(currentState, '', location.href + preservedHash);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/menglr/turbolinks/lib/assets/javascripts/turbolinks.js",
                "path": "/menglr/turbolinks/lib/assets/javascripts/turbolinks.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9tZW5nbHIvdHVyYm9saW5rcy9saWIvYXNzZXRzL2phdmFzY3JpcHRzL3R1cmJvbGlua3MuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjI3NTENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMjM6NDc6MzggR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDIzOjQ3OjM4IEdNVA0KDQovLyBHZW5lcmF0ZWQgYnkgQ29mZmVlU2NyaXB0IDEuOC4wCihmdW5jdGlvbigpIHsKICB2YXIgQ1NSRlRva2VuLCBDbGljaywgQ29tcG9uZW50VXJsLCBFVkVOVFMsIExpbmssIGJyb3dzZXJDb21wYXRpYmxlRG9jdW1lbnRQYXJzZXIsIGJyb3dzZXJJc250QnVnZ3ksIGJyb3dzZXJTdXBwb3J0c0N1c3RvbUV2ZW50cywgYnJvd3NlclN1cHBvcnRzUHVzaFN0YXRlLCBicm93c2VyU3VwcG9ydHNUdXJib2xpbmtzLCBieXBhc3NPbkxvYWRQb3BzdGF0ZSwgY2FjaGVDdXJyZW50UGFnZSwgY2FjaGVTaXplLCBjaGFuZ2VQYWdlLCBjbG9uZSwgY29uc3RyYWluUGFnZUNhY2hlVG8sIGNyZWF0ZURvY3VtZW50LCBjcm9zc09yaWdpblJlZGlyZWN0LCBjdXJyZW50U3RhdGUsIGVuYWJsZVRyYW5zaXRpb25DYWNoZSwgZXhlY3V0ZVNjcmlwdFRhZ3MsIGV4dHJhY3RUaXRsZUFuZEJvZHksIGZldGNoLCBmZXRjaEhpc3RvcnksIGZldGNoUmVwbGFjZW1lbnQsIGhpc3RvcnlTdGF0ZUlzRGVmaW5lZCwgaW5pdGlhbGl6ZVR1cmJvbGlua3MsIGluc3RhbGxEb2N1bWVudFJlYWR5UGFnZUV2ZW50VHJpZ2dlcnMsIGluc3RhbGxIaXN0b3J5Q2hhbmdlSGFuZGxlciwgaW5zdGFsbEpxdWVyeUFqYXhTdWNjZXNzUGFnZVVwZGF0ZVRyaWdnZXIsIGxvYWRlZEFzc2V0cywgbWFudWFsbHlUcmlnZ2VySGFzaENoYW5nZUZvckZpcmVmb3gsIHBhZ2VDYWNoZSwgcGFnZUNoYW5nZVByZXZlbnRlZCwgcGFnZXNDYWNoZWQsIHBvcENvb2tpZSwgcHJvY2Vzc1Jlc3BvbnNlLCByZWNhbGxTY3JvbGxQb3NpdGlvbiwgcmVmZXJlciwgcmVmbGVjdE5ld1VybCwgcmVmbGVjdFJlZGlyZWN0ZWRVcmwsIHJlbWVtYmVyQ3VycmVudFN0YXRlLCByZW1lbWJlckN1cnJlbnRVcmwsIHJlbWVtYmVyUmVmZXJlciwgcmVtb3ZlTm9zY3JpcHRUYWdzLCByZXF1ZXN0TWV0aG9kSXNTYWZlLCByZXNldFNjcm9sbFBvc2l0aW9uLCBzZXRBdXRvZm9jdXNFbGVtZW50LCB0cmFuc2l0aW9uQ2FjaGVFbmFibGVkLCB0cmFuc2l0aW9uQ2FjaGVGb3IsIHRyaWdnZXJFdmVudCwgdmlzaXQsIHhociwgX3JlZiwKICAgIF9faW5kZXhPZiA9IFtdLmluZGV4T2YgfHwgZnVuY3Rpb24oaXRlbSkgeyBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7IGlmIChpIGluIHRoaXMgJiYgdGhpc1tpXSA9PT0gaXRlbSkgcmV0dXJuIGk7IH0gcmV0dXJuIC0xOyB9LAogICAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksCiAgICBfX2V4dGVuZHMgPSBmdW5jdGlvbihjaGlsZCwgcGFyZW50KSB7IGZvciAodmFyIGtleSBpbiBwYXJlbnQpIHsgaWYgKF9faGFzUHJvcC5jYWxsKHBhcmVudCwga2V5KSkgY2hpbGRba2V5XSA9IHBhcmVudFtrZXldOyB9IGZ1bmN0aW9uIGN0b3IoKSB7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfSBjdG9yLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBjdG9yKCk7IGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7IHJldHVybiBjaGlsZDsgfSwKICAgIF9fc2xpY2UgPSBbXS5zbGljZTsKCiAgcGFnZUNhY2hlID0ge307CgogIGNhY2hlU2l6ZSA9IDEwOwoKICB0cmFuc2l0aW9uQ2FjaGVFbmFibGVkID0gZmFsc2U7CgogIGN1cnJlbnRTdGF0ZSA9IG51bGw7CgogIGxvYWRlZEFzc2V0cyA9IG51bGw7CgogIHJlZmVyZXIgPSBudWxsOwoKICBjcmVhdGVEb2N1bWVudCA9IG51bGw7CgogIHhociA9IG51bGw7CgogIEVWRU5UUyA9IHsKICAgIEJFRk9SRV9DSEFOR0U6ICdwYWdlOmJlZm9yZS1jaGFuZ2UnLAogICAgRkVUQ0g6ICdwYWdlOmZldGNoJywKICAgIFJFQ0VJVkU6ICdwYWdlOnJlY2VpdmUnLAogICAgQ0hBTkdFOiAncGFnZTpjaGFuZ2UnLAogICAgVVBEQVRFOiAncGFnZTp1cGRhdGUnLAogICAgTE9BRDogJ3BhZ2U6bG9hZCcsCiAgICBSRVNUT1JFOiAncGFnZTpyZXN0b3JlJywKICAgIEJFRk9SRV9VTkxPQUQ6ICdwYWdlOmJlZm9yZS11bmxvYWQnLAogICAgRVhQSVJFOiAncGFnZTpleHBpcmUnCiAgfTsKCiAgZmV0Y2ggPSBmdW5jdGlvbih1cmwpIHsKICAgIHZhciBjYWNoZWRQYWdlOwogICAgdXJsID0gbmV3IENvbXBvbmVudFVybCh1cmwpOwogICAgcmVtZW1iZXJSZWZlcmVyKCk7CiAgICBjYWNoZUN1cnJlbnRQYWdlKCk7CiAgICBpZiAodHJhbnNpdGlvbkNhY2hlRW5hYmxlZCAmJiAoY2FjaGVkUGFnZSA9IHRyYW5zaXRpb25DYWNoZUZvcih1cmwuYWJzb2x1dGUpKSkgewogICAgICBmZXRjaEhpc3RvcnkoY2FjaGVkUGFnZSk7CiAgICAgIHJldHVybiBmZXRjaFJlcGxhY2VtZW50KHVybCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZmV0Y2hSZXBsYWNlbWVudCh1cmwsIHJlc2V0U2Nyb2xsUG9zaXRpb24pOwogICAgfQogIH07CgogIHRyYW5zaXRpb25DYWNoZUZvciA9IGZ1bmN0aW9uKHVybCkgewogICAgdmFyIGNhY2hlZFBhZ2U7CiAgICBjYWNoZWRQYWdlID0gcGFnZUNhY2hlW3VybF07CiAgICBpZiAoY2FjaGVkUGFnZSAmJiAhY2FjaGVkUGFnZS50cmFuc2l0aW9uQ2FjaGVEaXNhYmxlZCkgewogICAgICByZXR1cm4gY2FjaGVkUGFnZTsKICAgIH0KICB9OwoKICBlbmFibGVUcmFuc2l0aW9uQ2FjaGUgPSBmdW5jdGlvbihlbmFibGUpIHsKICAgIGlmIChlbmFibGUgPT0gbnVsbCkgewogICAgICBlbmFibGUgPSB0cnVlOwogICAgfQogICAgcmV0dXJuIHRyYW5zaXRpb25DYWNoZUVuYWJsZWQgPSBlbmFibGU7CiAgfTsKCiAgZmV0Y2hSZXBsYWNlbWVudCA9IGZ1bmN0aW9uKHVybCwgb25Mb2FkRnVuY3Rpb24pIHsKICAgIGlmIChvbkxvYWRGdW5jdGlvbiA9PSBudWxsKSB7CiAgICAgIG9uTG9hZEZ1bmN0aW9uID0gKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkge307CiAgICAgIH0pKHRoaXMpOwogICAgfQogICAgdHJpZ2dlckV2ZW50KEVWRU5UUy5GRVRDSCwgewogICAgICB1cmw6IHVybC5hYnNvbHV0ZQogICAgfSk7CiAgICBpZiAoeGhyICE9IG51bGwpIHsKICAgICAgeGhyLmFib3J0KCk7CiAgICB9CiAgICB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3Q7CiAgICB4aHIub3BlbignR0VUJywgdXJsLndpdGhvdXRIYXNoRm9ySUUxMGNvbXBhdGliaWxpdHkoKSwgdHJ1ZSk7CiAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQWNjZXB0JywgJ3RleHQvaHRtbCwgYXBwbGljYXRpb24veGh0bWwreG1sLCBhcHBsaWNhdGlvbi94bWwnKTsKICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdYLVhIUi1SZWZlcmVyJywgcmVmZXJlcik7CiAgICB4aHIub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBkb2M7CiAgICAgIHRyaWdnZXJFdmVudChFVkVOVFMuUkVDRUlWRSwgewogICAgICAgIHVybDogdXJsLmFic29sdXRlCiAgICAgIH0pOwogICAgICBpZiAoZG9jID0gcHJvY2Vzc1Jlc3BvbnNlKCkpIHsKICAgICAgICByZWZsZWN0TmV3VXJsKHVybCk7CiAgICAgICAgY2hhbmdlUGFnZS5hcHBseShudWxsLCBleHRyYWN0VGl0bGVBbmRCb2R5KGRvYykpOwogICAgICAgIG1hbnVhbGx5VHJpZ2dlckhhc2hDaGFuZ2VGb3JGaXJlZm94KCk7CiAgICAgICAgcmVmbGVjdFJlZGlyZWN0ZWRVcmwoKTsKICAgICAgICBvbkxvYWRGdW5jdGlvbigpOwogICAgICAgIHJldHVybiB0cmlnZ2VyRXZlbnQoRVZFTlRTLkxPQUQpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmID0gY3Jvc3NPcmlnaW5SZWRpcmVjdCgpIHx8IHVybC5hYnNvbHV0ZTsKICAgICAgfQogICAgfTsKICAgIHhoci5vbmxvYWRlbmQgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHhociA9IG51bGw7CiAgICB9OwogICAgeGhyLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgPSB1cmwuYWJzb2x1dGU7CiAgICB9OwogICAgcmV0dXJuIHhoci5zZW5kKCk7CiAgfTsKCiAgZmV0Y2hIaXN0b3J5ID0gZnVuY3Rpb24oY2FjaGVkUGFnZSkgewogICAgaWYgKHhociAhPSBudWxsKSB7CiAgICAgIHhoci5hYm9ydCgpOwogICAgfQogICAgY2hhbmdlUGFnZShjYWNoZWRQYWdlLnRpdGxlLCBjYWNoZWRQYWdlLmJvZHkpOwogICAgcmVjYWxsU2Nyb2xsUG9zaXRpb24oY2FjaGVkUGFnZSk7CiAgICByZXR1cm4gdHJpZ2dlckV2ZW50KEVWRU5UUy5SRVNUT1JFKTsKICB9OwoKICBjYWNoZUN1cnJlbnRQYWdlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgY3VycmVudFN0YXRlVXJsOwogICAgY3VycmVudFN0YXRlVXJsID0gbmV3IENvbXBvbmVudFVybChjdXJyZW50U3RhdGUudXJsKTsKICAgIHBhZ2VDYWNoZVtjdXJyZW50U3RhdGVVcmwuYWJzb2x1dGVdID0gewogICAgICB1cmw6IGN1cnJlbnRTdGF0ZVVybC5yZWxhdGl2ZSwKICAgICAgYm9keTogZG9jdW1lbnQuYm9keSwKICAgICAgdGl0bGU6IGRvY3VtZW50LnRpdGxlLAogICAgICBwb3NpdGlvblk6IHdpbmRvdy5wYWdlWU9mZnNldCwKICAgICAgcG9zaXRpb25YOiB3aW5kb3cucGFnZVhPZmZzZXQsCiAgICAgIGNhY2hlZEF0OiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKICAgICAgdHJhbnNpdGlvbkNhY2hlRGlzYWJsZWQ6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLW5vLXRyYW5zaXRpb24tY2FjaGVdJykgIT0gbnVsbAogICAgfTsKICAgIHJldHVybiBjb25zdHJhaW5QYWdlQ2FjaGVUbyhjYWNoZVNpemUpOwogIH07CgogIHBhZ2VzQ2FjaGVkID0gZnVuY3Rpb24oc2l6ZSkgewogICAgaWYgKHNpemUgPT0gbnVsbCkgewogICAgICBzaXplID0gY2FjaGVTaXplOwogICAgfQogICAgaWYgKC9eW1xkXSskLy50ZXN0KHNpemUpKSB7CiAgICAgIHJldHVybiBjYWNoZVNpemUgPSBwYXJzZUludChzaXplKTsKICAgIH0KICB9OwoKICBjb25zdHJhaW5QYWdlQ2FjaGVUbyA9IGZ1bmN0aW9uKGxpbWl0KSB7CiAgICB2YXIgY2FjaGVUaW1lc1JlY2VudEZpcnN0LCBrZXksIHBhZ2VDYWNoZUtleXMsIF9pLCBfbGVuLCBfcmVzdWx0czsKICAgIHBhZ2VDYWNoZUtleXMgPSBPYmplY3Qua2V5cyhwYWdlQ2FjaGUpOwogICAgY2FjaGVUaW1lc1JlY2VudEZpcnN0ID0gcGFnZUNhY2hlS2V5cy5tYXAoZnVuY3Rpb24odXJsKSB7CiAgICAgIHJldHVybiBwYWdlQ2FjaGVbdXJsXS5jYWNoZWRBdDsKICAgIH0pLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICByZXR1cm4gYiAtIGE7CiAgICB9KTsKICAgIF9yZXN1bHRzID0gW107CiAgICBmb3IgKF9pID0gMCwgX2xlbiA9IHBhZ2VDYWNoZUtleXMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAga2V5ID0gcGFnZUNhY2hlS2V5c1tfaV07CiAgICAgIGlmICghKHBhZ2VDYWNoZVtrZXldLmNhY2hlZEF0IDw9IGNhY2hlVGltZXNSZWNlbnRGaXJzdFtsaW1pdF0pKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgdHJpZ2dlckV2ZW50KEVWRU5UUy5FWFBJUkUsIHBhZ2VDYWNoZVtrZXldKTsKICAgICAgX3Jlc3VsdHMucHVzaChkZWxldGUgcGFnZUNhY2hlW2tleV0pOwogICAgfQogICAgcmV0dXJuIF9yZXN1bHRzOwogIH07CgogIGNoYW5nZVBhZ2UgPSBmdW5jdGlvbih0aXRsZSwgYm9keSwgY3NyZlRva2VuLCBydW5TY3JpcHRzKSB7CiAgICB0cmlnZ2VyRXZlbnQoRVZFTlRTLkJFRk9SRV9VTkxPQUQpOwogICAgZG9jdW1lbnQudGl0bGUgPSB0aXRsZTsKICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5yZXBsYWNlQ2hpbGQoYm9keSwgZG9jdW1lbnQuYm9keSk7CiAgICBpZiAoY3NyZlRva2VuICE9IG51bGwpIHsKICAgICAgQ1NSRlRva2VuLnVwZGF0ZShjc3JmVG9rZW4pOwogICAgfQogICAgc2V0QXV0b2ZvY3VzRWxlbWVudCgpOwogICAgaWYgKHJ1blNjcmlwdHMpIHsKICAgICAgZXhlY3V0ZVNjcmlwdFRhZ3MoKTsKICAgIH0KICAgIGN1cnJlbnRTdGF0ZSA9IHdpbmRvdy5oaXN0b3J5LnN0YXRlOwogICAgdHJpZ2dlckV2ZW50KEVWRU5UUy5DSEFOR0UpOwogICAgcmV0dXJuIHRyaWdnZXJFdmVudChFVkVOVFMuVVBEQVRFKTsKICB9OwoKICBleGVjdXRlU2NyaXB0VGFncyA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGF0dHIsIGNvcHksIG5leHRTaWJsaW5nLCBwYXJlbnROb2RlLCBzY3JpcHQsIHNjcmlwdHMsIF9pLCBfaiwgX2xlbiwgX2xlbjEsIF9yZWYsIF9yZWYxOwogICAgc2NyaXB0cyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbCgnc2NyaXB0Om5vdChbZGF0YS10dXJib2xpbmtzLWV2YWw9ImZhbHNlIl0pJykpOwogICAgZm9yIChfaSA9IDAsIF9sZW4gPSBzY3JpcHRzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgIHNjcmlwdCA9IHNjcmlwdHNbX2ldOwogICAgICBpZiAoISgoX3JlZiA9IHNjcmlwdC50eXBlKSA9PT0gJycgfHwgX3JlZiA9PT0gJ3RleHQvamF2YXNjcmlwdCcpKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgY29weSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwogICAgICBfcmVmMSA9IHNjcmlwdC5hdHRyaWJ1dGVzOwogICAgICBmb3IgKF9qID0gMCwgX2xlbjEgPSBfcmVmMS5sZW5ndGg7IF9qIDwgX2xlbjE7IF9qKyspIHsKICAgICAgICBhdHRyID0gX3JlZjFbX2pdOwogICAgICAgIGNvcHkuc2V0QXR0cmlidXRlKGF0dHIubmFtZSwgYXR0ci52YWx1ZSk7CiAgICAgIH0KICAgICAgaWYgKCFzY3JpcHQuaGFzQXR0cmlidXRlKCdhc3luYycpKSB7CiAgICAgICAgY29weS5hc3luYyA9IGZhbHNlOwogICAgICB9CiAgICAgIGNvcHkuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoc2NyaXB0LmlubmVySFRNTCkpOwogICAgICBwYXJlbnROb2RlID0gc2NyaXB0LnBhcmVudE5vZGUsIG5leHRTaWJsaW5nID0gc2NyaXB0Lm5leHRTaWJsaW5nOwogICAgICBwYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcmlwdCk7CiAgICAgIHBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNvcHksIG5leHRTaWJsaW5nKTsKICAgIH0KICB9OwoKICByZW1vdmVOb3NjcmlwdFRhZ3MgPSBmdW5jdGlvbihub2RlKSB7CiAgICBub2RlLmlubmVySFRNTCA9IG5vZGUuaW5uZXJIVE1MLnJlcGxhY2UoLzxub3NjcmlwdFtcU1xzXSo/PFwvbm9zY3JpcHQ+L2lnLCAnJyk7CiAgICByZXR1cm4gbm9kZTsKICB9OwoKICBzZXRBdXRvZm9jdXNFbGVtZW50ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXV0b2ZvY3VzRWxlbWVudCwgbGlzdDsKICAgIGF1dG9mb2N1c0VsZW1lbnQgPSAobGlzdCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2lucHV0W2F1dG9mb2N1c10sIHRleHRhcmVhW2F1dG9mb2N1c10nKSlbbGlzdC5sZW5ndGggLSAxXTsKICAgIGlmIChhdXRvZm9jdXNFbGVtZW50ICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgIT09IGF1dG9mb2N1c0VsZW1lbnQpIHsKICAgICAgcmV0dXJuIGF1dG9mb2N1c0VsZW1lbnQuZm9jdXMoKTsKICAgIH0KICB9OwoKICByZWZsZWN0TmV3VXJsID0gZnVuY3Rpb24odXJsKSB7CiAgICBpZiAoKHVybCA9IG5ldyBDb21wb25lbnRVcmwodXJsKSkuYWJzb2x1dGUgIT09IHJlZmVyZXIpIHsKICAgICAgcmV0dXJuIHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZSh7CiAgICAgICAgdHVyYm9saW5rczogdHJ1ZSwKICAgICAgICB1cmw6IHVybC5hYnNvbHV0ZQogICAgICB9LCAnJywgdXJsLmFic29sdXRlKTsKICAgIH0KICB9OwoKICByZWZsZWN0UmVkaXJlY3RlZFVybCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGxvY2F0aW9uLCBwcmVzZXJ2ZWRIYXNoOwogICAgaWYgKGxvY2F0aW9uID0geGhyLmdldFJlc3BvbnNlSGVhZGVyKCdYLVhIUi1SZWRpcmVjdGVkLVRvJykpIHsKICAgICAgbG9jYXRpb24gPSBuZXcgQ29tcG9uZW50VXJsKGxvY2F0aW9uKTsKICAgICAgcHJlc2VydmVkSGFzaCA9IGxvY2F0aW9uLmhhc05vSGFzaCgpID8gZG9jdW1lbnQubG9jYXRpb24uaGFzaCA6ICcnOwogICAgICByZXR1cm4gd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKGN1cnJlbnRTdGF0ZSwgJycsIGxvY2F0aW9uLmhyZWYgKyBwcmVzZXJ2ZWRIYXNoKTsKICAgIH0KICB9OwoKICBjcm9zc09yaWdpblJlZGlyZWN0ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVkaXJlY3Q7CiAgICBpZiAoKChyZWRpcmVjdCA9IHhoci5nZXRSZXNwb25zZUhlYWRlcignTG9jYXRpb24nKSkgIT0gbnVsbCkgJiYgKG5ldyBDb21wb25lbnRVcmwocmVkaXJlY3QpKS5jcm9zc09yaWdpbigpKSB7CiAgICAgIHJldHVybiByZWRpcmVjdDsKICAgIH0KICB9OwoKICByZW1lbWJlclJlZmVyZXIgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiByZWZlcmVyID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKICB9OwoKICByZW1lbWJlckN1cnJlbnRVcmwgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoewogICAgICB0dXJib2xpbmtzOiB0cnVlLAogICAgICB1cmw6IGRvY3VtZW50LmxvY2F0aW9uLmhyZWYKICAgIH0sICcnLCBkb2N1bWVudC5sb2NhdGlvbi5ocmVmKTsKICB9OwoKICByZW1lbWJlckN1cnJlbnRTdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGN1cnJlbnRTdGF0ZSA9IHdpbmRvdy5oaXN0b3J5LnN0YXRlOwogIH07CgogIG1hbnVhbGx5VHJpZ2dlckhhc2hDaGFuZ2VGb3JGaXJlZm94ID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgdXJsOwogICAgaWYgKG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL0ZpcmVmb3gvKSAmJiAhKHVybCA9IG5ldyBDb21wb25lbnRVcmwpLmhhc05vSGFzaCgpKSB7CiAgICAgIHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZShjdXJyZW50U3RhdGUsICcnLCB1cmwud2l0aG91dEhhc2goKSk7CiAgICAgIHJldHVybiBkb2N1bWVudC5sb2NhdGlvbi5oYXNoID0gdXJsLmhhc2g7CiAgICB9CiAgfTsKCiAgcmVjYWxsU2Nyb2xsUG9zaXRpb24gPSBmdW5jdGlvbihwYWdlKSB7CiAgICByZXR1cm4gd2luZG93LnNjcm9sbFRvKHBhZ2UucG9zaXRpb25YLCBwYWdlLnBvc2l0aW9uWSk7CiAgfTsKCiAgcmVzZXRTY3JvbGxQb3NpdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgaWYgKGRvY3VtZW50LmxvY2F0aW9uLmhhc2gpIHsKICAgICAgcmV0dXJuIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgIH0KICB9OwoKICBjbG9uZSA9IGZ1bmN0aW9uKG9yaWdpbmFsKSB7CiAgICB2YXIgY29weSwga2V5LCB2YWx1ZTsKICAgIGlmICgob3JpZ2luYWwgPT0gbnVsbCkgfHwgdHlwZW9mIG9yaWdpbmFsICE9PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gb3JpZ2luYWw7CiAgICB9CiAgICBjb3B5ID0gbmV3IG9yaWdpbmFsLmNvbnN0cnVjdG9yKCk7CiAgICBmb3IgKGtleSBpbiBvcmlnaW5hbCkgewogICAgICB2YWx1ZSA9IG9yaWdpbmFsW2tleV07CiAgICAgIGNvcHlba2V5XSA9IGNsb25lKHZhbHVlKTsKICAgIH0KICAgIHJldHVybiBjb3B5OwogIH07CgogIHBvcENvb2tpZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciB2YWx1ZSwgX3JlZjsKICAgIHZhbHVlID0gKChfcmVmID0gZG9jdW1lbnQuY29va2llLm1hdGNoKG5ldyBSZWdFeHAobmFtZSArICI9KFxcdyspIikpKSAhPSBudWxsID8gX3JlZlsxXS50b1VwcGVyQ2FzZSgpIDogdm9pZCAwKSB8fCAnJzsKICAgIGRvY3VtZW50LmNvb2tpZSA9IG5hbWUgKyAnPTsgZXhwaXJlcz1UaHUsIDAxLUphbi03MCAwMDowMDowMSBHTVQ7IHBhdGg9Lyc7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKCiAgdHJpZ2dlckV2ZW50ID0gZnVuY3Rpb24obmFtZSwgZGF0YSkgewogICAgdmFyIGV2ZW50OwogICAgaWYgKHR5cGVvZiBQcm90b3R5cGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIEV2ZW50LmZpcmUoZG9jdW1lbnQsIG5hbWUsIGRhdGEsIHRydWUpOwogICAgfQogICAgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnRXZlbnRzJyk7CiAgICBpZiAoZGF0YSkgewogICAgICBldmVudC5kYXRhID0gZGF0YTsKICAgIH0KICAgIGV2ZW50LmluaXRFdmVudChuYW1lLCB0cnVlLCB0cnVlKTsKICAgIHJldHVybiBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICB9OwoKICBwYWdlQ2hhbmdlUHJldmVudGVkID0gZnVuY3Rpb24odXJsKSB7CiAgICByZXR1cm4gIXRyaWdnZXJFdmVudChFVkVOVFMuQkVGT1JFX0NIQU5HRSwgewogICAgICB1cmw6IHVybAogICAgfSk7CiAgfTsKCiAgcHJvY2Vzc1Jlc3BvbnNlID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXNzZXRzQ2hhbmdlZCwgY2xpZW50T3JTZXJ2ZXJFcnJvciwgZG9jLCBleHRyYWN0VHJhY2tBc3NldHMsIGludGVyc2VjdGlvbiwgdmFsaWRDb250ZW50OwogICAgY2xpZW50T3JTZXJ2ZXJFcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgX3JlZjsKICAgICAgcmV0dXJuICg0MDAgPD0gKF9yZWYgPSB4aHIuc3RhdHVzKSAmJiBfcmVmIDwgNjAwKTsKICAgIH07CiAgICB2YWxpZENvbnRlbnQgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvbnRlbnRUeXBlOwogICAgICByZXR1cm4gKChjb250ZW50VHlwZSA9IHhoci5nZXRSZXNwb25zZUhlYWRlcignQ29udGVudC1UeXBlJykpICE9IG51bGwpICYmIGNvbnRlbnRUeXBlLm1hdGNoKC9eKD86dGV4dFwvaHRtbHxhcHBsaWNhdGlvblwveGh0bWxcK3htbHxhcHBsaWNhdGlvblwveG1sKSg/Ojt8JCkvKTsKICAgIH07CiAgICBleHRyYWN0VHJhY2tBc3NldHMgPSBmdW5jdGlvbihkb2MpIHsKICAgICAgdmFyIG5vZGUsIF9pLCBfbGVuLCBfcmVmLCBfcmVzdWx0czsKICAgICAgX3JlZiA9IGRvYy5xdWVyeVNlbGVjdG9yKCdoZWFkJykuY2hpbGROb2RlczsKICAgICAgX3Jlc3VsdHMgPSBbXTsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBfcmVmLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgbm9kZSA9IF9yZWZbX2ldOwogICAgICAgIGlmICgodHlwZW9mIG5vZGUuZ2V0QXR0cmlidXRlID09PSAiZnVuY3Rpb24iID8gbm9kZS5nZXRBdHRyaWJ1dGUoJ2RhdGEtdHVyYm9saW5rcy10cmFjaycpIDogdm9pZCAwKSAhPSBudWxsKSB7CiAgICAgICAgICBfcmVzdWx0cy5wdXNoKG5vZGUuZ2V0QXR0cmlidXRlKCdzcmMnKSB8fCBub2RlLmdldEF0dHJpYnV0ZSgnaHJlZicpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIF9yZXN1bHRzOwogICAgfTsKICAgIGFzc2V0c0NoYW5nZWQgPSBmdW5jdGlvbihkb2MpIHsKICAgICAgdmFyIGZldGNoZWRBc3NldHM7CiAgICAgIGxvYWRlZEFzc2V0cyB8fCAobG9hZGVkQXNzZXRzID0gZXh0cmFjdFRyYWNrQXNzZXRzKGRvY3VtZW50KSk7CiAgICAgIGZldGNoZWRBc3NldHMgPSBleHRyYWN0VHJhY2tBc3NldHMoZG9jKTsKICAgICAgcmV0dXJuIGZldGNoZWRBc3NldHMubGVuZ3RoICE9PSBsb2FkZWRBc3NldHMubGVuZ3RoIHx8IGludGVyc2VjdGlvbihmZXRjaGVkQXNzZXRzLCBsb2FkZWRBc3NldHMpLmxlbmd0aCAhPT0gbG9hZGVkQXNzZXRzLmxlbmd0aDsKICAgIH07CiAgICBpbnRlcnNlY3Rpb24gPSBmdW5jdGlvbihhLCBiKSB7CiAgICAgIHZhciB2YWx1ZSwgX2ksIF9sZW4sIF9yZWYsIF9yZXN1bHRzOwogICAgICBpZiAoYS5sZW5ndGggPiBiLmxlbmd0aCkgewogICAgICAgIF9yZWYgPSBbYiwgYV0sIGEgPSBfcmVmWzBdLCBiID0gX3JlZlsxXTsKICAgICAgfQogICAgICBfcmVzdWx0cyA9IFtdOwogICAgICBmb3IgKF9pID0gMCwgX2xlbiA9IGEubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICB2YWx1ZSA9IGFbX2ldOwogICAgICAgIGlmIChfX2luZGV4T2YuY2FsbChiLCB2YWx1ZSkgPj0gMCkgewogICAgICAgICAgX3Jlc3VsdHMucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBfcmVzdWx0czsKICAgIH07CiAgICBpZiAoIWNsaWVudE9yU2VydmVyRXJyb3IoKSAmJiB2YWxpZENvbnRlbnQoKSkgewogICAgICBkb2MgPSBjcmVhdGVEb2N1bWVudCh4aHIucmVzcG9uc2VUZXh0KTsKICAgICAgaWYgKGRvYyAmJiAhYXNzZXRzQ2hhbmdlZChkb2MpKSB7CiAgICAgICAgcmV0dXJuIGRvYzsKICAgICAgfQogICAgfQogIH07CgogIGV4dHJhY3RUaXRsZUFuZEJvZHkgPSBmdW5jdGlvbihkb2MpIHsKICAgIHZhciB0aXRsZTsKICAgIHRpdGxlID0gZG9jLnF1ZXJ5U2VsZWN0b3IoJ3RpdGxlJyk7CiAgICByZXR1cm4gW3RpdGxlICE9IG51bGwgPyB0aXRsZS50ZXh0Q29udGVudCA6IHZvaWQgMCwgcmVtb3ZlTm9zY3JpcHRUYWdzKGRvYy5xdWVyeVNlbGVjdG9yKCdib2R5JykpLCBDU1JGVG9rZW4uZ2V0KGRvYykudG9rZW4sICdydW5TY3JpcHRzJ107CiAgfTsKCiAgQ1NSRlRva2VuID0gewogICAgZ2V0OiBmdW5jdGlvbihkb2MpIHsKICAgICAgdmFyIHRhZzsKICAgICAgaWYgKGRvYyA9PSBudWxsKSB7CiAgICAgICAgZG9jID0gZG9jdW1lbnQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBub2RlOiB0YWcgPSBkb2MucXVlcnlTZWxlY3RvcignbWV0YVtuYW1lPSJjc3JmLXRva2VuIl0nKSwKICAgICAgICB0b2tlbjogdGFnICE9IG51bGwgPyB0eXBlb2YgdGFnLmdldEF0dHJpYnV0ZSA9PT0gImZ1bmN0aW9uIiA/IHRhZy5nZXRBdHRyaWJ1dGUoJ2NvbnRlbnQnKSA6IHZvaWQgMCA6IHZvaWQgMAogICAgICB9OwogICAgfSwKICAgIHVwZGF0ZTogZnVuY3Rpb24obGF0ZXN0KSB7CiAgICAgIHZhciBjdXJyZW50OwogICAgICBjdXJyZW50ID0gdGhpcy5nZXQoKTsKICAgICAgaWYgKChjdXJyZW50LnRva2VuICE9IG51bGwpICYmIChsYXRlc3QgIT0gbnVsbCkgJiYgY3VycmVudC50b2tlbiAhPT0gbGF0ZXN0KSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnQubm9kZS5zZXRBdHRyaWJ1dGUoJ2NvbnRlbnQnLCBsYXRlc3QpOwogICAgICB9CiAgICB9CiAgfTsKCiAgYnJvd3NlckNvbXBhdGlibGVEb2N1bWVudFBhcnNlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGJ1aWxkVGVzdHNVc2luZywgY3JlYXRlRG9jdW1lbnRVc2luZ0RPTSwgY3JlYXRlRG9jdW1lbnRVc2luZ0ZyYWdtZW50LCBjcmVhdGVEb2N1bWVudFVzaW5nUGFyc2VyLCBjcmVhdGVEb2N1bWVudFVzaW5nV3JpdGUsIGRvY1Rlc3QsIGRvY1Rlc3RzLCBlLCBfaSwgX2xlbjsKICAgIGNyZWF0ZURvY3VtZW50VXNpbmdQYXJzZXIgPSBmdW5jdGlvbihodG1sKSB7CiAgICAgIHJldHVybiAobmV3IERPTVBhcnNlcikucGFyc2VGcm9tU3RyaW5nKGh0bWwsICd0ZXh0L2h0bWwnKTsKICAgIH07CiAgICBjcmVhdGVEb2N1bWVudFVzaW5nRE9NID0gZnVuY3Rpb24oaHRtbCkgewogICAgICB2YXIgZG9jOwogICAgICBkb2MgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoJycpOwogICAgICBkb2MuZG9jdW1lbnRFbGVtZW50LmlubmVySFRNTCA9IGh0bWw7CiAgICAgIHJldHVybiBkb2M7CiAgICB9OwogICAgY3JlYXRlRG9jdW1lbnRVc2luZ1dyaXRlID0gZnVuY3Rpb24oaHRtbCkgewogICAgICB2YXIgZG9jOwogICAgICBkb2MgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoJycpOwogICAgICBkb2Mub3BlbigncmVwbGFjZScpOwogICAgICBkb2Mud3JpdGUoaHRtbCk7CiAgICAgIGRvYy5jbG9zZSgpOwogICAgICByZXR1cm4gZG9jOwogICAgfTsKICAgIGNyZWF0ZURvY3VtZW50VXNpbmdGcmFnbWVudCA9IGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgdmFyIGJvZHksIGRvYywgaGVhZCwgaHRtbFdyYXBwZXIsIF9yZWYsIF9yZWYxOwogICAgICBoZWFkID0gKChfcmVmID0gaHRtbC5tYXRjaCgvPGhlYWRbXj5dKj4oW1xzXFMuXSopPFwvaGVhZD4vaSkpICE9IG51bGwgPyBfcmVmWzBdIDogdm9pZCAwKSB8fCAnPGhlYWQ+PC9oZWFkPic7CiAgICAgIGJvZHkgPSAoKF9yZWYxID0gaHRtbC5tYXRjaCgvPGJvZHlbXj5dKj4oW1xzXFMuXSopPFwvYm9keT4vaSkpICE9IG51bGwgPyBfcmVmMVswXSA6IHZvaWQgMCkgfHwgJzxib2R5PjwvYm9keT4nOwogICAgICBodG1sV3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2h0bWwnKTsKICAgICAgaHRtbFdyYXBwZXIuaW5uZXJIVE1MID0gaGVhZCArIGJvZHk7CiAgICAgIGRvYyA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgZG9jLmFwcGVuZENoaWxkKGh0bWxXcmFwcGVyKTsKICAgICAgcmV0dXJuIGRvYzsKICAgIH07CiAgICBidWlsZFRlc3RzVXNpbmcgPSBmdW5jdGlvbihjcmVhdGVNZXRob2QpIHsKICAgICAgdmFyIGJ1aWxkVGVzdCwgZm9ybU5lc3RpbmdUZXN0LCBzdHJ1Y3R1cmVUZXN0OwogICAgICBidWlsZFRlc3QgPSBmdW5jdGlvbihmYWxsYmFjaywgcGFzc2VzKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHBhc3NlczogcGFzc2VzKCksCiAgICAgICAgICBmYWxsYmFjazogZmFsbGJhY2sKICAgICAgICB9OwogICAgICB9OwogICAgICBzdHJ1Y3R1cmVUZXN0ID0gYnVpbGRUZXN0KGNyZWF0ZURvY3VtZW50VXNpbmdXcml0ZSwgKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIF9yZWYsIF9yZWYxOwogICAgICAgICAgcmV0dXJuICgoX3JlZiA9IGNyZWF0ZU1ldGhvZCgnPGh0bWw+PGJvZHk+PHA+dGVzdCcpKSAhPSBudWxsID8gKF9yZWYxID0gX3JlZi5ib2R5KSAhPSBudWxsID8gX3JlZjEuY2hpbGROb2Rlcy5sZW5ndGggOiB2b2lkIDAgOiB2b2lkIDApID09PSAxOwogICAgICAgIH07CiAgICAgIH0pKHRoaXMpKTsKICAgICAgZm9ybU5lc3RpbmdUZXN0ID0gYnVpbGRUZXN0KGNyZWF0ZURvY3VtZW50VXNpbmdGcmFnbWVudCwgKGZ1bmN0aW9uKF90aGlzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIF9yZWYsIF9yZWYxOwogICAgICAgICAgcmV0dXJuICgoX3JlZiA9IGNyZWF0ZU1ldGhvZCgnPGh0bWw+PGJvZHk+PGZvcm0+PC9mb3JtPjxkaXY+PC9kaXY+PC9ib2R5PjwvaHRtbD4nKSkgIT0gbnVsbCA/IChfcmVmMSA9IF9yZWYuYm9keSkgIT0gbnVsbCA/IF9yZWYxLmNoaWxkTm9kZXMubGVuZ3RoIDogdm9pZCAwIDogdm9pZCAwKSA9PT0gMjsKICAgICAgICB9OwogICAgICB9KSh0aGlzKSk7CiAgICAgIHJldHVybiBbc3RydWN0dXJlVGVzdCwgZm9ybU5lc3RpbmdUZXN0XTsKICAgIH07CiAgICB0cnkgewogICAgICBpZiAod2luZG93LkRPTVBhcnNlcikgewogICAgICAgIGRvY1Rlc3RzID0gYnVpbGRUZXN0c1VzaW5nKGNyZWF0ZURvY3VtZW50VXNpbmdQYXJzZXIpOwogICAgICAgIHJldHVybiBjcmVhdGVEb2N1bWVudFVzaW5nUGFyc2VyOwogICAgICB9CiAgICB9IGNhdGNoIChfZXJyb3IpIHsKICAgICAgZSA9IF9lcnJvcjsKICAgICAgZG9jVGVzdHMgPSBidWlsZFRlc3RzVXNpbmcoY3JlYXRlRG9jdW1lbnRVc2luZ0RPTSk7CiAgICAgIHJldHVybiBjcmVhdGVEb2N1bWVudFVzaW5nRE9NOwogICAgfSBmaW5hbGx5IHsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBkb2NUZXN0cy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIGRvY1Rlc3QgPSBkb2NUZXN0c1tfaV07CiAgICAgICAgaWYgKCFkb2NUZXN0LnBhc3NlcykgewogICAgICAgICAgcmV0dXJuIGRvY1Rlc3QuZmFsbGJhY2s7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgQ29tcG9uZW50VXJsID0gKGZ1bmN0aW9uKCkgewogICAgZnVuY3Rpb24gQ29tcG9uZW50VXJsKG9yaWdpbmFsKSB7CiAgICAgIHRoaXMub3JpZ2luYWwgPSBvcmlnaW5hbCAhPSBudWxsID8gb3JpZ2luYWwgOiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmOwogICAgICBpZiAodGhpcy5vcmlnaW5hbC5jb25zdHJ1Y3RvciA9PT0gQ29tcG9uZW50VXJsKSB7CiAgICAgICAgcmV0dXJuIHRoaXMub3JpZ2luYWw7CiAgICAgIH0KICAgICAgdGhpcy5fcGFyc2UoKTsKICAgIH0KCiAgICBDb21wb25lbnRVcmwucHJvdG90eXBlLndpdGhvdXRIYXNoID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmhyZWYucmVwbGFjZSh0aGlzLmhhc2gsICcnKS5yZXBsYWNlKCcjJywgJycpOwogICAgfTsKCiAgICBDb21wb25lbnRVcmwucHJvdG90eXBlLndpdGhvdXRIYXNoRm9ySUUxMGNvbXBhdGliaWxpdHkgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMud2l0aG91dEhhc2goKTsKICAgIH07CgogICAgQ29tcG9uZW50VXJsLnByb3RvdHlwZS5oYXNOb0hhc2ggPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuaGFzaC5sZW5ndGggPT09IDA7CiAgICB9OwoKICAgIENvbXBvbmVudFVybC5wcm90b3R5cGUuY3Jvc3NPcmlnaW4gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMub3JpZ2luICE9PSAobmV3IENvbXBvbmVudFVybCkub3JpZ2luOwogICAgfTsKCiAgICBDb21wb25lbnRVcmwucHJvdG90eXBlLl9wYXJzZSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgX3JlZjsKICAgICAgKHRoaXMubGluayAhPSBudWxsID8gdGhpcy5saW5rIDogdGhpcy5saW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpKS5ocmVmID0gdGhpcy5vcmlnaW5hbDsKICAgICAgX3JlZiA9IHRoaXMubGluaywgdGhpcy5ocmVmID0gX3JlZi5ocmVmLCB0aGlzLnByb3RvY29sID0gX3JlZi5wcm90b2NvbCwgdGhpcy5ob3N0ID0gX3JlZi5ob3N0LCB0aGlzLmhvc3RuYW1lID0gX3JlZi5ob3N0bmFtZSwgdGhpcy5wb3J0ID0gX3JlZi5wb3J0LCB0aGlzLnBhdGhuYW1lID0gX3JlZi5wYXRobmFtZSwgdGhpcy5zZWFyY2ggPSBfcmVmLnNlYXJjaCwgdGhpcy5oYXNoID0gX3JlZi5oYXNoOwogICAgICB0aGlzLm9yaWdpbiA9IFt0aGlzLnByb3RvY29sLCAnLy8nLCB0aGlzLmhvc3RuYW1lXS5qb2luKCcnKTsKICAgICAgaWYgKHRoaXMucG9ydC5sZW5ndGggIT09IDApIHsKICAgICAgICB0aGlzLm9yaWdpbiArPSAiOiIgKyB0aGlzLnBvcnQ7CiAgICAgIH0KICAgICAgdGhpcy5yZWxhdGl2ZSA9IFt0aGlzLnBhdGhuYW1lLCB0aGlzLnNlYXJjaCwgdGhpcy5oYXNoXS5qb2luKCcnKTsKICAgICAgcmV0dXJuIHRoaXMuYWJzb2x1dGUgPSB0aGlzLmhyZWY7CiAgICB9OwoKICAgIHJldHVybiBDb21wb25lbnRVcmw7CgogIH0pKCk7CgogIExpbmsgPSAoZnVuY3Rpb24oX3N1cGVyKSB7CiAgICBfX2V4dGVuZHMoTGluaywgX3N1cGVyKTsKCiAgICBMaW5rLkhUTUxfRVhURU5TSU9OUyA9IFsnaHRtbCddOwoKICAgIExpbmsuYWxsb3dFeHRlbnNpb25zID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBleHRlbnNpb24sIGV4dGVuc2lvbnMsIF9pLCBfbGVuOwogICAgICBleHRlbnNpb25zID0gMSA8PSBhcmd1bWVudHMubGVuZ3RoID8gX19zbGljZS5jYWxsKGFyZ3VtZW50cywgMCkgOiBbXTsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBleHRlbnNpb25zLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgZXh0ZW5zaW9uID0gZXh0ZW5zaW9uc1tfaV07CiAgICAgICAgTGluay5IVE1MX0VYVEVOU0lPTlMucHVzaChleHRlbnNpb24pOwogICAgICB9CiAgICAgIHJldHVybiBMaW5rLkhUTUxfRVhURU5TSU9OUzsKICAgIH07CgogICAgZnVuY3Rpb24gTGluayhsaW5rKSB7CiAgICAgIHRoaXMubGluayA9IGxpbms7CiAgICAgIGlmICh0aGlzLmxpbmsuY29uc3RydWN0b3IgPT09IExpbmspIHsKICAgICAgICByZXR1cm4gdGhpcy5saW5rOwogICAgICB9CiAgICAgIHRoaXMub3JpZ2luYWwgPSB0aGlzLmxpbmsuaHJlZjsKICAgICAgdGhpcy5vcmlnaW5hbEVsZW1lbnQgPSB0aGlzLmxpbms7CiAgICAgIHRoaXMubGluayA9IHRoaXMubGluay5jbG9uZU5vZGUoZmFsc2UpOwogICAgICBMaW5rLl9fc3VwZXJfXy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICAgIExpbmsucHJvdG90eXBlLnNob3VsZElnbm9yZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5jcm9zc09yaWdpbigpIHx8IHRoaXMuX2FuY2hvcmVkKCkgfHwgdGhpcy5fbm9uSHRtbCgpIHx8IHRoaXMuX29wdE91dCgpIHx8IHRoaXMuX3RhcmdldCgpOwogICAgfTsKCiAgICBMaW5rLnByb3RvdHlwZS5fYW5jaG9yZWQgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICh0aGlzLmhhc2gubGVuZ3RoID4gMCB8fCB0aGlzLmhyZWYuY2hhckF0KHRoaXMuaHJlZi5sZW5ndGggLSAxKSA9PT0gJyMnKSAmJiAodGhpcy53aXRob3V0SGFzaCgpID09PSAobmV3IENvbXBvbmVudFVybCkud2l0aG91dEhhc2goKSk7CiAgICB9OwoKICAgIExpbmsucHJvdG90eXBlLl9ub25IdG1sID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnBhdGhuYW1lLm1hdGNoKC9cLlthLXpdKyQvZykgJiYgIXRoaXMucGF0aG5hbWUubWF0Y2gobmV3IFJlZ0V4cCgiXFwuKD86IiArIChMaW5rLkhUTUxfRVhURU5TSU9OUy5qb2luKCd8JykpICsgIik/JCIsICdnJykpOwogICAgfTsKCiAgICBMaW5rLnByb3RvdHlwZS5fb3B0T3V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpZ25vcmUsIGxpbms7CiAgICAgIGxpbmsgPSB0aGlzLm9yaWdpbmFsRWxlbWVudDsKICAgICAgd2hpbGUgKCEoaWdub3JlIHx8IGxpbmsgPT09IGRvY3VtZW50KSkgewogICAgICAgIGlnbm9yZSA9IGxpbmsuZ2V0QXR0cmlidXRlKCdkYXRhLW5vLXR1cmJvbGluaycpICE9IG51bGw7CiAgICAgICAgbGluayA9IGxpbmsucGFyZW50Tm9kZTsKICAgICAgfQogICAgICByZXR1cm4gaWdub3JlOwogICAgfTsKCiAgICBMaW5rLnByb3RvdHlwZS5fdGFyZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmxpbmsudGFyZ2V0Lmxlbmd0aCAhPT0gMDsKICAgIH07CgogICAgcmV0dXJuIExpbms7CgogIH0pKENvbXBvbmVudFVybCk7CgogIENsaWNrID0gKGZ1bmN0aW9uKCkgewogICAgQ2xpY2suaW5zdGFsbEhhbmRsZXJMYXN0ID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgaWYgKCFldmVudC5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCBDbGljay5oYW5kbGUsIGZhbHNlKTsKICAgICAgICByZXR1cm4gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBDbGljay5oYW5kbGUsIGZhbHNlKTsKICAgICAgfQogICAgfTsKCiAgICBDbGljay5oYW5kbGUgPSBmdW5jdGlvbihldmVudCkgewogICAgICByZXR1cm4gbmV3IENsaWNrKGV2ZW50KTsKICAgIH07CgogICAgZnVuY3Rpb24gQ2xpY2soZXZlbnQpIHsKICAgICAgdGhpcy5ldmVudCA9IGV2ZW50OwogICAgICBpZiAodGhpcy5ldmVudC5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuX2V4dHJhY3RMaW5rKCk7CiAgICAgIGlmICh0aGlzLl92YWxpZEZvclR1cmJvbGlua3MoKSkgewogICAgICAgIGlmICghcGFnZUNoYW5nZVByZXZlbnRlZCh0aGlzLmxpbmsuYWJzb2x1dGUpKSB7CiAgICAgICAgICB2aXNpdCh0aGlzLmxpbmsuaHJlZik7CiAgICAgICAgfQogICAgICAgIHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgfQogICAgfQoKICAgIENsaWNrLnByb3RvdHlwZS5fZXh0cmFjdExpbmsgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGxpbms7CiAgICAgIGxpbmsgPSB0aGlzLmV2ZW50LnRhcmdldDsKICAgICAgd2hpbGUgKCEoIWxpbmsucGFyZW50Tm9kZSB8fCBsaW5rLm5vZGVOYW1lID09PSAnQScpKSB7CiAgICAgICAgbGluayA9IGxpbmsucGFyZW50Tm9kZTsKICAgICAgfQogICAgICBpZiAobGluay5ub2RlTmFtZSA9PT0gJ0EnICYmIGxpbmsuaHJlZi5sZW5ndGggIT09IDApIHsKICAgICAgICByZXR1cm4gdGhpcy5saW5rID0gbmV3IExpbmsobGluayk7CiAgICAgIH0KICAgIH07CgogICAgQ2xpY2sucHJvdG90eXBlLl92YWxpZEZvclR1cmJvbGlua3MgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICh0aGlzLmxpbmsgIT0gbnVsbCkgJiYgISh0aGlzLmxpbmsuc2hvdWxkSWdub3JlKCkgfHwgdGhpcy5fbm9uU3RhbmRhcmRDbGljaygpKTsKICAgIH07CgogICAgQ2xpY2sucHJvdG90eXBlLl9ub25TdGFuZGFyZENsaWNrID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmV2ZW50LndoaWNoID4gMSB8fCB0aGlzLmV2ZW50Lm1ldGFLZXkgfHwgdGhpcy5ldmVudC5jdHJsS2V5IHx8IHRoaXMuZXZlbnQuc2hpZnRLZXkgfHwgdGhpcy5ldmVudC5hbHRLZXk7CiAgICB9OwoKICAgIHJldHVybiBDbGljazsKCiAgfSkoKTsKCiAgYnlwYXNzT25Mb2FkUG9wc3RhdGUgPSBmdW5jdGlvbihmbikgewogICAgcmV0dXJuIHNldFRpbWVvdXQoZm4sIDUwMCk7CiAgfTsKCiAgaW5zdGFsbERvY3VtZW50UmVhZHlQYWdlRXZlbnRUcmlnZ2VycyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCAoZnVuY3Rpb24oKSB7CiAgICAgIHRyaWdnZXJFdmVudChFVkVOVFMuQ0hBTkdFKTsKICAgICAgcmV0dXJuIHRyaWdnZXJFdmVudChFVkVOVFMuVVBEQVRFKTsKICAgIH0pLCB0cnVlKTsKICB9OwoKICBpbnN0YWxsSnF1ZXJ5QWpheFN1Y2Nlc3NQYWdlVXBkYXRlVHJpZ2dlciA9IGZ1bmN0aW9uKCkgewogICAgaWYgKHR5cGVvZiBqUXVlcnkgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHJldHVybiBqUXVlcnkoZG9jdW1lbnQpLm9uKCdhamF4U3VjY2VzcycsIGZ1bmN0aW9uKGV2ZW50LCB4aHIsIHNldHRpbmdzKSB7CiAgICAgICAgaWYgKCFqUXVlcnkudHJpbSh4aHIucmVzcG9uc2VUZXh0KSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJpZ2dlckV2ZW50KEVWRU5UUy5VUERBVEUpOwogICAgICB9KTsKICAgIH0KICB9OwoKICBpbnN0YWxsSGlzdG9yeUNoYW5nZUhhbmRsZXIgPSBmdW5jdGlvbihldmVudCkgewogICAgdmFyIGNhY2hlZFBhZ2UsIF9yZWY7CiAgICBpZiAoKF9yZWYgPSBldmVudC5zdGF0ZSkgIT0gbnVsbCA/IF9yZWYudHVyYm9saW5rcyA6IHZvaWQgMCkgewogICAgICBpZiAoY2FjaGVkUGFnZSA9IHBhZ2VDYWNoZVsobmV3IENvbXBvbmVudFVybChldmVudC5zdGF0ZS51cmwpKS5hYnNvbHV0ZV0pIHsKICAgICAgICBjYWNoZUN1cnJlbnRQYWdlKCk7CiAgICAgICAgcmV0dXJuIGZldGNoSGlzdG9yeShjYWNoZWRQYWdlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdmlzaXQoZXZlbnQudGFyZ2V0LmxvY2F0aW9uLmhyZWYpOwogICAgICB9CiAgICB9CiAgfTsKCiAgaW5pdGlhbGl6ZVR1cmJvbGlua3MgPSBmdW5jdGlvbigpIHsKICAgIHJlbWVtYmVyQ3VycmVudFVybCgpOwogICAgcmVtZW1iZXJDdXJyZW50U3RhdGUoKTsKICAgIGNyZWF0ZURvY3VtZW50ID0gYnJvd3NlckNvbXBhdGlibGVEb2N1bWVudFBhcnNlcigpOwogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBDbGljay5pbnN0YWxsSGFuZGxlckxhc3QsIHRydWUpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihldmVudCkgewogICAgICByZW1lbWJlckN1cnJlbnRVcmwoKTsKICAgICAgcmV0dXJuIHJlbWVtYmVyQ3VycmVudFN0YXRlKCk7CiAgICB9LCBmYWxzZSk7CiAgICByZXR1cm4gYnlwYXNzT25Mb2FkUG9wc3RhdGUoZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCBpbnN0YWxsSGlzdG9yeUNoYW5nZUhhbmRsZXIsIGZhbHNlKTsKICAgIH0pOwogIH07CgogIGhpc3RvcnlTdGF0ZUlzRGVmaW5lZCA9IHdpbmRvdy5oaXN0b3J5LnN0YXRlICE9PSB2b2lkIDAgfHwgbmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCgvRmlyZWZveFwvMls2fDddLyk7CgogIGJyb3dzZXJTdXBwb3J0c1B1c2hTdGF0ZSA9IHdpbmRvdy5oaXN0b3J5ICYmIHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZSAmJiB3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUgJiYgaGlzdG9yeVN0YXRlSXNEZWZpbmVkOwoKICBicm93c2VySXNudEJ1Z2d5ID0gIW5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL0NyaU9TXC8vKTsKCiAgcmVxdWVzdE1ldGhvZElzU2FmZSA9IChfcmVmID0gcG9wQ29va2llKCdyZXF1ZXN0X21ldGhvZCcpKSA9PT0gJ0dFVCcgfHwgX3JlZiA9PT0gJyc7CgogIGJyb3dzZXJTdXBwb3J0c1R1cmJvbGlua3MgPSBicm93c2VyU3VwcG9ydHNQdXNoU3RhdGUgJiYgYnJvd3NlcklzbnRCdWdneSAmJiByZXF1ZXN0TWV0aG9kSXNTYWZlOwoKICBicm93c2VyU3VwcG9ydHNDdXN0b21FdmVudHMgPSBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyICYmIGRvY3VtZW50LmNyZWF0ZUV2ZW50OwoKICBpZiAoYnJvd3NlclN1cHBvcnRzQ3VzdG9tRXZlbnRzKSB7CiAgICBpbnN0YWxsRG9jdW1lbnRSZWFkeVBhZ2VFdmVudFRyaWdnZXJzKCk7CiAgICBpbnN0YWxsSnF1ZXJ5QWpheFN1Y2Nlc3NQYWdlVXBkYXRlVHJpZ2dlcigpOwogIH0KCiAgaWYgKGJyb3dzZXJTdXBwb3J0c1R1cmJvbGlua3MpIHsKICAgIHZpc2l0ID0gZmV0Y2g7CiAgICBpbml0aWFsaXplVHVyYm9saW5rcygpOwogIH0gZWxzZSB7CiAgICB2aXNpdCA9IGZ1bmN0aW9uKHVybCkgewogICAgICByZXR1cm4gZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9IHVybDsKICAgIH07CiAgfQoKICB0aGlzLlR1cmJvbGlua3MgPSB7CiAgICB2aXNpdDogdmlzaXQsCiAgICBwYWdlc0NhY2hlZDogcGFnZXNDYWNoZWQsCiAgICBlbmFibGVUcmFuc2l0aW9uQ2FjaGU6IGVuYWJsZVRyYW5zaXRpb25DYWNoZSwKICAgIGFsbG93TGlua0V4dGVuc2lvbnM6IExpbmsuYWxsb3dFeHRlbnNpb25zLAogICAgc3VwcG9ydGVkOiBicm93c2VyU3VwcG9ydHNUdXJib2xpbmtzLAogICAgRVZFTlRTOiBjbG9uZShFVkVOVFMpCiAgfTsKCn0pLmNhbGwodGhpcyk7Cg==",
                "body": "Ly8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjguMAooZnVuY3Rpb24oKSB7CiAgdmFyIENTUkZUb2tlbiwgQ2xpY2ssIENvbXBvbmVudFVybCwgRVZFTlRTLCBMaW5rLCBicm93c2VyQ29tcGF0aWJsZURvY3VtZW50UGFyc2VyLCBicm93c2VySXNudEJ1Z2d5LCBicm93c2VyU3VwcG9ydHNDdXN0b21FdmVudHMsIGJyb3dzZXJTdXBwb3J0c1B1c2hTdGF0ZSwgYnJvd3NlclN1cHBvcnRzVHVyYm9saW5rcywgYnlwYXNzT25Mb2FkUG9wc3RhdGUsIGNhY2hlQ3VycmVudFBhZ2UsIGNhY2hlU2l6ZSwgY2hhbmdlUGFnZSwgY2xvbmUsIGNvbnN0cmFpblBhZ2VDYWNoZVRvLCBjcmVhdGVEb2N1bWVudCwgY3Jvc3NPcmlnaW5SZWRpcmVjdCwgY3VycmVudFN0YXRlLCBlbmFibGVUcmFuc2l0aW9uQ2FjaGUsIGV4ZWN1dGVTY3JpcHRUYWdzLCBleHRyYWN0VGl0bGVBbmRCb2R5LCBmZXRjaCwgZmV0Y2hIaXN0b3J5LCBmZXRjaFJlcGxhY2VtZW50LCBoaXN0b3J5U3RhdGVJc0RlZmluZWQsIGluaXRpYWxpemVUdXJib2xpbmtzLCBpbnN0YWxsRG9jdW1lbnRSZWFkeVBhZ2VFdmVudFRyaWdnZXJzLCBpbnN0YWxsSGlzdG9yeUNoYW5nZUhhbmRsZXIsIGluc3RhbGxKcXVlcnlBamF4U3VjY2Vzc1BhZ2VVcGRhdGVUcmlnZ2VyLCBsb2FkZWRBc3NldHMsIG1hbnVhbGx5VHJpZ2dlckhhc2hDaGFuZ2VGb3JGaXJlZm94LCBwYWdlQ2FjaGUsIHBhZ2VDaGFuZ2VQcmV2ZW50ZWQsIHBhZ2VzQ2FjaGVkLCBwb3BDb29raWUsIHByb2Nlc3NSZXNwb25zZSwgcmVjYWxsU2Nyb2xsUG9zaXRpb24sIHJlZmVyZXIsIHJlZmxlY3ROZXdVcmwsIHJlZmxlY3RSZWRpcmVjdGVkVXJsLCByZW1lbWJlckN1cnJlbnRTdGF0ZSwgcmVtZW1iZXJDdXJyZW50VXJsLCByZW1lbWJlclJlZmVyZXIsIHJlbW92ZU5vc2NyaXB0VGFncywgcmVxdWVzdE1ldGhvZElzU2FmZSwgcmVzZXRTY3JvbGxQb3NpdGlvbiwgc2V0QXV0b2ZvY3VzRWxlbWVudCwgdHJhbnNpdGlvbkNhY2hlRW5hYmxlZCwgdHJhbnNpdGlvbkNhY2hlRm9yLCB0cmlnZ2VyRXZlbnQsIHZpc2l0LCB4aHIsIF9yZWYsCiAgICBfX2luZGV4T2YgPSBbXS5pbmRleE9mIHx8IGZ1bmN0aW9uKGl0ZW0pIHsgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKykgeyBpZiAoaSBpbiB0aGlzICYmIHRoaXNbaV0gPT09IGl0ZW0pIHJldHVybiBpOyB9IHJldHVybiAtMTsgfSwKICAgIF9faGFzUHJvcCA9IHt9Lmhhc093blByb3BlcnR5LAogICAgX19leHRlbmRzID0gZnVuY3Rpb24oY2hpbGQsIHBhcmVudCkgeyBmb3IgKHZhciBrZXkgaW4gcGFyZW50KSB7IGlmIChfX2hhc1Byb3AuY2FsbChwYXJlbnQsIGtleSkpIGNoaWxkW2tleV0gPSBwYXJlbnRba2V5XTsgfSBmdW5jdGlvbiBjdG9yKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH0gY3Rvci5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOyBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOyBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOyByZXR1cm4gY2hpbGQ7IH0sCiAgICBfX3NsaWNlID0gW10uc2xpY2U7CgogIHBhZ2VDYWNoZSA9IHt9OwoKICBjYWNoZVNpemUgPSAxMDsKCiAgdHJhbnNpdGlvbkNhY2hlRW5hYmxlZCA9IGZhbHNlOwoKICBjdXJyZW50U3RhdGUgPSBudWxsOwoKICBsb2FkZWRBc3NldHMgPSBudWxsOwoKICByZWZlcmVyID0gbnVsbDsKCiAgY3JlYXRlRG9jdW1lbnQgPSBudWxsOwoKICB4aHIgPSBudWxsOwoKICBFVkVOVFMgPSB7CiAgICBCRUZPUkVfQ0hBTkdFOiAncGFnZTpiZWZvcmUtY2hhbmdlJywKICAgIEZFVENIOiAncGFnZTpmZXRjaCcsCiAgICBSRUNFSVZFOiAncGFnZTpyZWNlaXZlJywKICAgIENIQU5HRTogJ3BhZ2U6Y2hhbmdlJywKICAgIFVQREFURTogJ3BhZ2U6dXBkYXRlJywKICAgIExPQUQ6ICdwYWdlOmxvYWQnLAogICAgUkVTVE9SRTogJ3BhZ2U6cmVzdG9yZScsCiAgICBCRUZPUkVfVU5MT0FEOiAncGFnZTpiZWZvcmUtdW5sb2FkJywKICAgIEVYUElSRTogJ3BhZ2U6ZXhwaXJlJwogIH07CgogIGZldGNoID0gZnVuY3Rpb24odXJsKSB7CiAgICB2YXIgY2FjaGVkUGFnZTsKICAgIHVybCA9IG5ldyBDb21wb25lbnRVcmwodXJsKTsKICAgIHJlbWVtYmVyUmVmZXJlcigpOwogICAgY2FjaGVDdXJyZW50UGFnZSgpOwogICAgaWYgKHRyYW5zaXRpb25DYWNoZUVuYWJsZWQgJiYgKGNhY2hlZFBhZ2UgPSB0cmFuc2l0aW9uQ2FjaGVGb3IodXJsLmFic29sdXRlKSkpIHsKICAgICAgZmV0Y2hIaXN0b3J5KGNhY2hlZFBhZ2UpOwogICAgICByZXR1cm4gZmV0Y2hSZXBsYWNlbWVudCh1cmwpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGZldGNoUmVwbGFjZW1lbnQodXJsLCByZXNldFNjcm9sbFBvc2l0aW9uKTsKICAgIH0KICB9OwoKICB0cmFuc2l0aW9uQ2FjaGVGb3IgPSBmdW5jdGlvbih1cmwpIHsKICAgIHZhciBjYWNoZWRQYWdlOwogICAgY2FjaGVkUGFnZSA9IHBhZ2VDYWNoZVt1cmxdOwogICAgaWYgKGNhY2hlZFBhZ2UgJiYgIWNhY2hlZFBhZ2UudHJhbnNpdGlvbkNhY2hlRGlzYWJsZWQpIHsKICAgICAgcmV0dXJuIGNhY2hlZFBhZ2U7CiAgICB9CiAgfTsKCiAgZW5hYmxlVHJhbnNpdGlvbkNhY2hlID0gZnVuY3Rpb24oZW5hYmxlKSB7CiAgICBpZiAoZW5hYmxlID09IG51bGwpIHsKICAgICAgZW5hYmxlID0gdHJ1ZTsKICAgIH0KICAgIHJldHVybiB0cmFuc2l0aW9uQ2FjaGVFbmFibGVkID0gZW5hYmxlOwogIH07CgogIGZldGNoUmVwbGFjZW1lbnQgPSBmdW5jdGlvbih1cmwsIG9uTG9hZEZ1bmN0aW9uKSB7CiAgICBpZiAob25Mb2FkRnVuY3Rpb24gPT0gbnVsbCkgewogICAgICBvbkxvYWRGdW5jdGlvbiA9IChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHt9OwogICAgICB9KSh0aGlzKTsKICAgIH0KICAgIHRyaWdnZXJFdmVudChFVkVOVFMuRkVUQ0gsIHsKICAgICAgdXJsOiB1cmwuYWJzb2x1dGUKICAgIH0pOwogICAgaWYgKHhociAhPSBudWxsKSB7CiAgICAgIHhoci5hYm9ydCgpOwogICAgfQogICAgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0OwogICAgeGhyLm9wZW4oJ0dFVCcsIHVybC53aXRob3V0SGFzaEZvcklFMTBjb21wYXRpYmlsaXR5KCksIHRydWUpOwogICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0FjY2VwdCcsICd0ZXh0L2h0bWwsIGFwcGxpY2F0aW9uL3hodG1sK3htbCwgYXBwbGljYXRpb24veG1sJyk7CiAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1YSFItUmVmZXJlcicsIHJlZmVyZXIpOwogICAgeGhyLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZG9jOwogICAgICB0cmlnZ2VyRXZlbnQoRVZFTlRTLlJFQ0VJVkUsIHsKICAgICAgICB1cmw6IHVybC5hYnNvbHV0ZQogICAgICB9KTsKICAgICAgaWYgKGRvYyA9IHByb2Nlc3NSZXNwb25zZSgpKSB7CiAgICAgICAgcmVmbGVjdE5ld1VybCh1cmwpOwogICAgICAgIGNoYW5nZVBhZ2UuYXBwbHkobnVsbCwgZXh0cmFjdFRpdGxlQW5kQm9keShkb2MpKTsKICAgICAgICBtYW51YWxseVRyaWdnZXJIYXNoQ2hhbmdlRm9yRmlyZWZveCgpOwogICAgICAgIHJlZmxlY3RSZWRpcmVjdGVkVXJsKCk7CiAgICAgICAgb25Mb2FkRnVuY3Rpb24oKTsKICAgICAgICByZXR1cm4gdHJpZ2dlckV2ZW50KEVWRU5UUy5MT0FEKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9IGNyb3NzT3JpZ2luUmVkaXJlY3QoKSB8fCB1cmwuYWJzb2x1dGU7CiAgICAgIH0KICAgIH07CiAgICB4aHIub25sb2FkZW5kID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB4aHIgPSBudWxsOwogICAgfTsKICAgIHhoci5vbmVycm9yID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmID0gdXJsLmFic29sdXRlOwogICAgfTsKICAgIHJldHVybiB4aHIuc2VuZCgpOwogIH07CgogIGZldGNoSGlzdG9yeSA9IGZ1bmN0aW9uKGNhY2hlZFBhZ2UpIHsKICAgIGlmICh4aHIgIT0gbnVsbCkgewogICAgICB4aHIuYWJvcnQoKTsKICAgIH0KICAgIGNoYW5nZVBhZ2UoY2FjaGVkUGFnZS50aXRsZSwgY2FjaGVkUGFnZS5ib2R5KTsKICAgIHJlY2FsbFNjcm9sbFBvc2l0aW9uKGNhY2hlZFBhZ2UpOwogICAgcmV0dXJuIHRyaWdnZXJFdmVudChFVkVOVFMuUkVTVE9SRSk7CiAgfTsKCiAgY2FjaGVDdXJyZW50UGFnZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGN1cnJlbnRTdGF0ZVVybDsKICAgIGN1cnJlbnRTdGF0ZVVybCA9IG5ldyBDb21wb25lbnRVcmwoY3VycmVudFN0YXRlLnVybCk7CiAgICBwYWdlQ2FjaGVbY3VycmVudFN0YXRlVXJsLmFic29sdXRlXSA9IHsKICAgICAgdXJsOiBjdXJyZW50U3RhdGVVcmwucmVsYXRpdmUsCiAgICAgIGJvZHk6IGRvY3VtZW50LmJvZHksCiAgICAgIHRpdGxlOiBkb2N1bWVudC50aXRsZSwKICAgICAgcG9zaXRpb25ZOiB3aW5kb3cucGFnZVlPZmZzZXQsCiAgICAgIHBvc2l0aW9uWDogd2luZG93LnBhZ2VYT2Zmc2V0LAogICAgICBjYWNoZWRBdDogbmV3IERhdGUoKS5nZXRUaW1lKCksCiAgICAgIHRyYW5zaXRpb25DYWNoZURpc2FibGVkOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1uby10cmFuc2l0aW9uLWNhY2hlXScpICE9IG51bGwKICAgIH07CiAgICByZXR1cm4gY29uc3RyYWluUGFnZUNhY2hlVG8oY2FjaGVTaXplKTsKICB9OwoKICBwYWdlc0NhY2hlZCA9IGZ1bmN0aW9uKHNpemUpIHsKICAgIGlmIChzaXplID09IG51bGwpIHsKICAgICAgc2l6ZSA9IGNhY2hlU2l6ZTsKICAgIH0KICAgIGlmICgvXltcZF0rJC8udGVzdChzaXplKSkgewogICAgICByZXR1cm4gY2FjaGVTaXplID0gcGFyc2VJbnQoc2l6ZSk7CiAgICB9CiAgfTsKCiAgY29uc3RyYWluUGFnZUNhY2hlVG8gPSBmdW5jdGlvbihsaW1pdCkgewogICAgdmFyIGNhY2hlVGltZXNSZWNlbnRGaXJzdCwga2V5LCBwYWdlQ2FjaGVLZXlzLCBfaSwgX2xlbiwgX3Jlc3VsdHM7CiAgICBwYWdlQ2FjaGVLZXlzID0gT2JqZWN0LmtleXMocGFnZUNhY2hlKTsKICAgIGNhY2hlVGltZXNSZWNlbnRGaXJzdCA9IHBhZ2VDYWNoZUtleXMubWFwKGZ1bmN0aW9uKHVybCkgewogICAgICByZXR1cm4gcGFnZUNhY2hlW3VybF0uY2FjaGVkQXQ7CiAgICB9KS5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgcmV0dXJuIGIgLSBhOwogICAgfSk7CiAgICBfcmVzdWx0cyA9IFtdOwogICAgZm9yIChfaSA9IDAsIF9sZW4gPSBwYWdlQ2FjaGVLZXlzLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgIGtleSA9IHBhZ2VDYWNoZUtleXNbX2ldOwogICAgICBpZiAoIShwYWdlQ2FjaGVba2V5XS5jYWNoZWRBdCA8PSBjYWNoZVRpbWVzUmVjZW50Rmlyc3RbbGltaXRdKSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIHRyaWdnZXJFdmVudChFVkVOVFMuRVhQSVJFLCBwYWdlQ2FjaGVba2V5XSk7CiAgICAgIF9yZXN1bHRzLnB1c2goZGVsZXRlIHBhZ2VDYWNoZVtrZXldKTsKICAgIH0KICAgIHJldHVybiBfcmVzdWx0czsKICB9OwoKICBjaGFuZ2VQYWdlID0gZnVuY3Rpb24odGl0bGUsIGJvZHksIGNzcmZUb2tlbiwgcnVuU2NyaXB0cykgewogICAgdHJpZ2dlckV2ZW50KEVWRU5UUy5CRUZPUkVfVU5MT0FEKTsKICAgIGRvY3VtZW50LnRpdGxlID0gdGl0bGU7CiAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQucmVwbGFjZUNoaWxkKGJvZHksIGRvY3VtZW50LmJvZHkpOwogICAgaWYgKGNzcmZUb2tlbiAhPSBudWxsKSB7CiAgICAgIENTUkZUb2tlbi51cGRhdGUoY3NyZlRva2VuKTsKICAgIH0KICAgIHNldEF1dG9mb2N1c0VsZW1lbnQoKTsKICAgIGlmIChydW5TY3JpcHRzKSB7CiAgICAgIGV4ZWN1dGVTY3JpcHRUYWdzKCk7CiAgICB9CiAgICBjdXJyZW50U3RhdGUgPSB3aW5kb3cuaGlzdG9yeS5zdGF0ZTsKICAgIHRyaWdnZXJFdmVudChFVkVOVFMuQ0hBTkdFKTsKICAgIHJldHVybiB0cmlnZ2VyRXZlbnQoRVZFTlRTLlVQREFURSk7CiAgfTsKCiAgZXhlY3V0ZVNjcmlwdFRhZ3MgPSBmdW5jdGlvbigpIHsKICAgIHZhciBhdHRyLCBjb3B5LCBuZXh0U2libGluZywgcGFyZW50Tm9kZSwgc2NyaXB0LCBzY3JpcHRzLCBfaSwgX2osIF9sZW4sIF9sZW4xLCBfcmVmLCBfcmVmMTsKICAgIHNjcmlwdHMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3JBbGwoJ3NjcmlwdDpub3QoW2RhdGEtdHVyYm9saW5rcy1ldmFsPSJmYWxzZSJdKScpKTsKICAgIGZvciAoX2kgPSAwLCBfbGVuID0gc2NyaXB0cy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICBzY3JpcHQgPSBzY3JpcHRzW19pXTsKICAgICAgaWYgKCEoKF9yZWYgPSBzY3JpcHQudHlwZSkgPT09ICcnIHx8IF9yZWYgPT09ICd0ZXh0L2phdmFzY3JpcHQnKSkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGNvcHkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKICAgICAgX3JlZjEgPSBzY3JpcHQuYXR0cmlidXRlczsKICAgICAgZm9yIChfaiA9IDAsIF9sZW4xID0gX3JlZjEubGVuZ3RoOyBfaiA8IF9sZW4xOyBfaisrKSB7CiAgICAgICAgYXR0ciA9IF9yZWYxW19qXTsKICAgICAgICBjb3B5LnNldEF0dHJpYnV0ZShhdHRyLm5hbWUsIGF0dHIudmFsdWUpOwogICAgICB9CiAgICAgIGlmICghc2NyaXB0Lmhhc0F0dHJpYnV0ZSgnYXN5bmMnKSkgewogICAgICAgIGNvcHkuYXN5bmMgPSBmYWxzZTsKICAgICAgfQogICAgICBjb3B5LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHNjcmlwdC5pbm5lckhUTUwpKTsKICAgICAgcGFyZW50Tm9kZSA9IHNjcmlwdC5wYXJlbnROb2RlLCBuZXh0U2libGluZyA9IHNjcmlwdC5uZXh0U2libGluZzsKICAgICAgcGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICBwYXJlbnROb2RlLmluc2VydEJlZm9yZShjb3B5LCBuZXh0U2libGluZyk7CiAgICB9CiAgfTsKCiAgcmVtb3ZlTm9zY3JpcHRUYWdzID0gZnVuY3Rpb24obm9kZSkgewogICAgbm9kZS5pbm5lckhUTUwgPSBub2RlLmlubmVySFRNTC5yZXBsYWNlKC88bm9zY3JpcHRbXFNcc10qPzxcL25vc2NyaXB0Pi9pZywgJycpOwogICAgcmV0dXJuIG5vZGU7CiAgfTsKCiAgc2V0QXV0b2ZvY3VzRWxlbWVudCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGF1dG9mb2N1c0VsZW1lbnQsIGxpc3Q7CiAgICBhdXRvZm9jdXNFbGVtZW50ID0gKGxpc3QgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dFthdXRvZm9jdXNdLCB0ZXh0YXJlYVthdXRvZm9jdXNdJykpW2xpc3QubGVuZ3RoIC0gMV07CiAgICBpZiAoYXV0b2ZvY3VzRWxlbWVudCAmJiBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICE9PSBhdXRvZm9jdXNFbGVtZW50KSB7CiAgICAgIHJldHVybiBhdXRvZm9jdXNFbGVtZW50LmZvY3VzKCk7CiAgICB9CiAgfTsKCiAgcmVmbGVjdE5ld1VybCA9IGZ1bmN0aW9uKHVybCkgewogICAgaWYgKCh1cmwgPSBuZXcgQ29tcG9uZW50VXJsKHVybCkpLmFic29sdXRlICE9PSByZWZlcmVyKSB7CiAgICAgIHJldHVybiB3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUoewogICAgICAgIHR1cmJvbGlua3M6IHRydWUsCiAgICAgICAgdXJsOiB1cmwuYWJzb2x1dGUKICAgICAgfSwgJycsIHVybC5hYnNvbHV0ZSk7CiAgICB9CiAgfTsKCiAgcmVmbGVjdFJlZGlyZWN0ZWRVcmwgPSBmdW5jdGlvbigpIHsKICAgIHZhciBsb2NhdGlvbiwgcHJlc2VydmVkSGFzaDsKICAgIGlmIChsb2NhdGlvbiA9IHhoci5nZXRSZXNwb25zZUhlYWRlcignWC1YSFItUmVkaXJlY3RlZC1UbycpKSB7CiAgICAgIGxvY2F0aW9uID0gbmV3IENvbXBvbmVudFVybChsb2NhdGlvbik7CiAgICAgIHByZXNlcnZlZEhhc2ggPSBsb2NhdGlvbi5oYXNOb0hhc2goKSA/IGRvY3VtZW50LmxvY2F0aW9uLmhhc2ggOiAnJzsKICAgICAgcmV0dXJuIHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZShjdXJyZW50U3RhdGUsICcnLCBsb2NhdGlvbi5ocmVmICsgcHJlc2VydmVkSGFzaCk7CiAgICB9CiAgfTsKCiAgY3Jvc3NPcmlnaW5SZWRpcmVjdCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlZGlyZWN0OwogICAgaWYgKCgocmVkaXJlY3QgPSB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoJ0xvY2F0aW9uJykpICE9IG51bGwpICYmIChuZXcgQ29tcG9uZW50VXJsKHJlZGlyZWN0KSkuY3Jvc3NPcmlnaW4oKSkgewogICAgICByZXR1cm4gcmVkaXJlY3Q7CiAgICB9CiAgfTsKCiAgcmVtZW1iZXJSZWZlcmVyID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gcmVmZXJlciA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CiAgfTsKCiAgcmVtZW1iZXJDdXJyZW50VXJsID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHsKICAgICAgdHVyYm9saW5rczogdHJ1ZSwKICAgICAgdXJsOiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmCiAgICB9LCAnJywgZG9jdW1lbnQubG9jYXRpb24uaHJlZik7CiAgfTsKCiAgcmVtZW1iZXJDdXJyZW50U3RhdGUgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjdXJyZW50U3RhdGUgPSB3aW5kb3cuaGlzdG9yeS5zdGF0ZTsKICB9OwoKICBtYW51YWxseVRyaWdnZXJIYXNoQ2hhbmdlRm9yRmlyZWZveCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHVybDsKICAgIGlmIChuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9GaXJlZm94LykgJiYgISh1cmwgPSBuZXcgQ29tcG9uZW50VXJsKS5oYXNOb0hhc2goKSkgewogICAgICB3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoY3VycmVudFN0YXRlLCAnJywgdXJsLndpdGhvdXRIYXNoKCkpOwogICAgICByZXR1cm4gZG9jdW1lbnQubG9jYXRpb24uaGFzaCA9IHVybC5oYXNoOwogICAgfQogIH07CgogIHJlY2FsbFNjcm9sbFBvc2l0aW9uID0gZnVuY3Rpb24ocGFnZSkgewogICAgcmV0dXJuIHdpbmRvdy5zY3JvbGxUbyhwYWdlLnBvc2l0aW9uWCwgcGFnZS5wb3NpdGlvblkpOwogIH07CgogIHJlc2V0U2Nyb2xsUG9zaXRpb24gPSBmdW5jdGlvbigpIHsKICAgIGlmIChkb2N1bWVudC5sb2NhdGlvbi5oYXNoKSB7CiAgICAgIHJldHVybiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmID0gZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CiAgICB9CiAgfTsKCiAgY2xvbmUgPSBmdW5jdGlvbihvcmlnaW5hbCkgewogICAgdmFyIGNvcHksIGtleSwgdmFsdWU7CiAgICBpZiAoKG9yaWdpbmFsID09IG51bGwpIHx8IHR5cGVvZiBvcmlnaW5hbCAhPT0gJ29iamVjdCcpIHsKICAgICAgcmV0dXJuIG9yaWdpbmFsOwogICAgfQogICAgY29weSA9IG5ldyBvcmlnaW5hbC5jb25zdHJ1Y3RvcigpOwogICAgZm9yIChrZXkgaW4gb3JpZ2luYWwpIHsKICAgICAgdmFsdWUgPSBvcmlnaW5hbFtrZXldOwogICAgICBjb3B5W2tleV0gPSBjbG9uZSh2YWx1ZSk7CiAgICB9CiAgICByZXR1cm4gY29weTsKICB9OwoKICBwb3BDb29raWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICB2YXIgdmFsdWUsIF9yZWY7CiAgICB2YWx1ZSA9ICgoX3JlZiA9IGRvY3VtZW50LmNvb2tpZS5tYXRjaChuZXcgUmVnRXhwKG5hbWUgKyAiPShcXHcrKSIpKSkgIT0gbnVsbCA/IF9yZWZbMV0udG9VcHBlckNhc2UoKSA6IHZvaWQgMCkgfHwgJyc7CiAgICBkb2N1bWVudC5jb29raWUgPSBuYW1lICsgJz07IGV4cGlyZXM9VGh1LCAwMS1KYW4tNzAgMDA6MDA6MDEgR01UOyBwYXRoPS8nOwogICAgcmV0dXJuIHZhbHVlOwogIH07CgogIHRyaWdnZXJFdmVudCA9IGZ1bmN0aW9uKG5hbWUsIGRhdGEpIHsKICAgIHZhciBldmVudDsKICAgIGlmICh0eXBlb2YgUHJvdG90eXBlICE9PSAndW5kZWZpbmVkJykgewogICAgICBFdmVudC5maXJlKGRvY3VtZW50LCBuYW1lLCBkYXRhLCB0cnVlKTsKICAgIH0KICAgIGV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0V2ZW50cycpOwogICAgaWYgKGRhdGEpIHsKICAgICAgZXZlbnQuZGF0YSA9IGRhdGE7CiAgICB9CiAgICBldmVudC5pbml0RXZlbnQobmFtZSwgdHJ1ZSwgdHJ1ZSk7CiAgICByZXR1cm4gZG9jdW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgfTsKCiAgcGFnZUNoYW5nZVByZXZlbnRlZCA9IGZ1bmN0aW9uKHVybCkgewogICAgcmV0dXJuICF0cmlnZ2VyRXZlbnQoRVZFTlRTLkJFRk9SRV9DSEFOR0UsIHsKICAgICAgdXJsOiB1cmwKICAgIH0pOwogIH07CgogIHByb2Nlc3NSZXNwb25zZSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGFzc2V0c0NoYW5nZWQsIGNsaWVudE9yU2VydmVyRXJyb3IsIGRvYywgZXh0cmFjdFRyYWNrQXNzZXRzLCBpbnRlcnNlY3Rpb24sIHZhbGlkQ29udGVudDsKICAgIGNsaWVudE9yU2VydmVyRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIF9yZWY7CiAgICAgIHJldHVybiAoNDAwIDw9IChfcmVmID0geGhyLnN0YXR1cykgJiYgX3JlZiA8IDYwMCk7CiAgICB9OwogICAgdmFsaWRDb250ZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjb250ZW50VHlwZTsKICAgICAgcmV0dXJuICgoY29udGVudFR5cGUgPSB4aHIuZ2V0UmVzcG9uc2VIZWFkZXIoJ0NvbnRlbnQtVHlwZScpKSAhPSBudWxsKSAmJiBjb250ZW50VHlwZS5tYXRjaCgvXig/OnRleHRcL2h0bWx8YXBwbGljYXRpb25cL3hodG1sXCt4bWx8YXBwbGljYXRpb25cL3htbCkoPzo7fCQpLyk7CiAgICB9OwogICAgZXh0cmFjdFRyYWNrQXNzZXRzID0gZnVuY3Rpb24oZG9jKSB7CiAgICAgIHZhciBub2RlLCBfaSwgX2xlbiwgX3JlZiwgX3Jlc3VsdHM7CiAgICAgIF9yZWYgPSBkb2MucXVlcnlTZWxlY3RvcignaGVhZCcpLmNoaWxkTm9kZXM7CiAgICAgIF9yZXN1bHRzID0gW107CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gX3JlZi5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIG5vZGUgPSBfcmVmW19pXTsKICAgICAgICBpZiAoKHR5cGVvZiBub2RlLmdldEF0dHJpYnV0ZSA9PT0gImZ1bmN0aW9uIiA/IG5vZGUuZ2V0QXR0cmlidXRlKCdkYXRhLXR1cmJvbGlua3MtdHJhY2snKSA6IHZvaWQgMCkgIT0gbnVsbCkgewogICAgICAgICAgX3Jlc3VsdHMucHVzaChub2RlLmdldEF0dHJpYnV0ZSgnc3JjJykgfHwgbm9kZS5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBfcmVzdWx0czsKICAgIH07CiAgICBhc3NldHNDaGFuZ2VkID0gZnVuY3Rpb24oZG9jKSB7CiAgICAgIHZhciBmZXRjaGVkQXNzZXRzOwogICAgICBsb2FkZWRBc3NldHMgfHwgKGxvYWRlZEFzc2V0cyA9IGV4dHJhY3RUcmFja0Fzc2V0cyhkb2N1bWVudCkpOwogICAgICBmZXRjaGVkQXNzZXRzID0gZXh0cmFjdFRyYWNrQXNzZXRzKGRvYyk7CiAgICAgIHJldHVybiBmZXRjaGVkQXNzZXRzLmxlbmd0aCAhPT0gbG9hZGVkQXNzZXRzLmxlbmd0aCB8fCBpbnRlcnNlY3Rpb24oZmV0Y2hlZEFzc2V0cywgbG9hZGVkQXNzZXRzKS5sZW5ndGggIT09IGxvYWRlZEFzc2V0cy5sZW5ndGg7CiAgICB9OwogICAgaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oYSwgYikgewogICAgICB2YXIgdmFsdWUsIF9pLCBfbGVuLCBfcmVmLCBfcmVzdWx0czsKICAgICAgaWYgKGEubGVuZ3RoID4gYi5sZW5ndGgpIHsKICAgICAgICBfcmVmID0gW2IsIGFdLCBhID0gX3JlZlswXSwgYiA9IF9yZWZbMV07CiAgICAgIH0KICAgICAgX3Jlc3VsdHMgPSBbXTsKICAgICAgZm9yIChfaSA9IDAsIF9sZW4gPSBhLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CiAgICAgICAgdmFsdWUgPSBhW19pXTsKICAgICAgICBpZiAoX19pbmRleE9mLmNhbGwoYiwgdmFsdWUpID49IDApIHsKICAgICAgICAgIF9yZXN1bHRzLnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gX3Jlc3VsdHM7CiAgICB9OwogICAgaWYgKCFjbGllbnRPclNlcnZlckVycm9yKCkgJiYgdmFsaWRDb250ZW50KCkpIHsKICAgICAgZG9jID0gY3JlYXRlRG9jdW1lbnQoeGhyLnJlc3BvbnNlVGV4dCk7CiAgICAgIGlmIChkb2MgJiYgIWFzc2V0c0NoYW5nZWQoZG9jKSkgewogICAgICAgIHJldHVybiBkb2M7CiAgICAgIH0KICAgIH0KICB9OwoKICBleHRyYWN0VGl0bGVBbmRCb2R5ID0gZnVuY3Rpb24oZG9jKSB7CiAgICB2YXIgdGl0bGU7CiAgICB0aXRsZSA9IGRvYy5xdWVyeVNlbGVjdG9yKCd0aXRsZScpOwogICAgcmV0dXJuIFt0aXRsZSAhPSBudWxsID8gdGl0bGUudGV4dENvbnRlbnQgOiB2b2lkIDAsIHJlbW92ZU5vc2NyaXB0VGFncyhkb2MucXVlcnlTZWxlY3RvcignYm9keScpKSwgQ1NSRlRva2VuLmdldChkb2MpLnRva2VuLCAncnVuU2NyaXB0cyddOwogIH07CgogIENTUkZUb2tlbiA9IHsKICAgIGdldDogZnVuY3Rpb24oZG9jKSB7CiAgICAgIHZhciB0YWc7CiAgICAgIGlmIChkb2MgPT0gbnVsbCkgewogICAgICAgIGRvYyA9IGRvY3VtZW50OwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgbm9kZTogdGFnID0gZG9jLnF1ZXJ5U2VsZWN0b3IoJ21ldGFbbmFtZT0iY3NyZi10b2tlbiJdJyksCiAgICAgICAgdG9rZW46IHRhZyAhPSBudWxsID8gdHlwZW9mIHRhZy5nZXRBdHRyaWJ1dGUgPT09ICJmdW5jdGlvbiIgPyB0YWcuZ2V0QXR0cmlidXRlKCdjb250ZW50JykgOiB2b2lkIDAgOiB2b2lkIDAKICAgICAgfTsKICAgIH0sCiAgICB1cGRhdGU6IGZ1bmN0aW9uKGxhdGVzdCkgewogICAgICB2YXIgY3VycmVudDsKICAgICAgY3VycmVudCA9IHRoaXMuZ2V0KCk7CiAgICAgIGlmICgoY3VycmVudC50b2tlbiAhPSBudWxsKSAmJiAobGF0ZXN0ICE9IG51bGwpICYmIGN1cnJlbnQudG9rZW4gIT09IGxhdGVzdCkgewogICAgICAgIHJldHVybiBjdXJyZW50Lm5vZGUuc2V0QXR0cmlidXRlKCdjb250ZW50JywgbGF0ZXN0KTsKICAgICAgfQogICAgfQogIH07CgogIGJyb3dzZXJDb21wYXRpYmxlRG9jdW1lbnRQYXJzZXIgPSBmdW5jdGlvbigpIHsKICAgIHZhciBidWlsZFRlc3RzVXNpbmcsIGNyZWF0ZURvY3VtZW50VXNpbmdET00sIGNyZWF0ZURvY3VtZW50VXNpbmdGcmFnbWVudCwgY3JlYXRlRG9jdW1lbnRVc2luZ1BhcnNlciwgY3JlYXRlRG9jdW1lbnRVc2luZ1dyaXRlLCBkb2NUZXN0LCBkb2NUZXN0cywgZSwgX2ksIF9sZW47CiAgICBjcmVhdGVEb2N1bWVudFVzaW5nUGFyc2VyID0gZnVuY3Rpb24oaHRtbCkgewogICAgICByZXR1cm4gKG5ldyBET01QYXJzZXIpLnBhcnNlRnJvbVN0cmluZyhodG1sLCAndGV4dC9odG1sJyk7CiAgICB9OwogICAgY3JlYXRlRG9jdW1lbnRVc2luZ0RPTSA9IGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgdmFyIGRvYzsKICAgICAgZG9jID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KCcnKTsKICAgICAgZG9jLmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUwgPSBodG1sOwogICAgICByZXR1cm4gZG9jOwogICAgfTsKICAgIGNyZWF0ZURvY3VtZW50VXNpbmdXcml0ZSA9IGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgdmFyIGRvYzsKICAgICAgZG9jID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KCcnKTsKICAgICAgZG9jLm9wZW4oJ3JlcGxhY2UnKTsKICAgICAgZG9jLndyaXRlKGh0bWwpOwogICAgICBkb2MuY2xvc2UoKTsKICAgICAgcmV0dXJuIGRvYzsKICAgIH07CiAgICBjcmVhdGVEb2N1bWVudFVzaW5nRnJhZ21lbnQgPSBmdW5jdGlvbihodG1sKSB7CiAgICAgIHZhciBib2R5LCBkb2MsIGhlYWQsIGh0bWxXcmFwcGVyLCBfcmVmLCBfcmVmMTsKICAgICAgaGVhZCA9ICgoX3JlZiA9IGh0bWwubWF0Y2goLzxoZWFkW14+XSo+KFtcc1xTLl0qKTxcL2hlYWQ+L2kpKSAhPSBudWxsID8gX3JlZlswXSA6IHZvaWQgMCkgfHwgJzxoZWFkPjwvaGVhZD4nOwogICAgICBib2R5ID0gKChfcmVmMSA9IGh0bWwubWF0Y2goLzxib2R5W14+XSo+KFtcc1xTLl0qKTxcL2JvZHk+L2kpKSAhPSBudWxsID8gX3JlZjFbMF0gOiB2b2lkIDApIHx8ICc8Ym9keT48L2JvZHk+JzsKICAgICAgaHRtbFdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdodG1sJyk7CiAgICAgIGh0bWxXcmFwcGVyLmlubmVySFRNTCA9IGhlYWQgKyBib2R5OwogICAgICBkb2MgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIGRvYy5hcHBlbmRDaGlsZChodG1sV3JhcHBlcik7CiAgICAgIHJldHVybiBkb2M7CiAgICB9OwogICAgYnVpbGRUZXN0c1VzaW5nID0gZnVuY3Rpb24oY3JlYXRlTWV0aG9kKSB7CiAgICAgIHZhciBidWlsZFRlc3QsIGZvcm1OZXN0aW5nVGVzdCwgc3RydWN0dXJlVGVzdDsKICAgICAgYnVpbGRUZXN0ID0gZnVuY3Rpb24oZmFsbGJhY2ssIHBhc3NlcykgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwYXNzZXM6IHBhc3NlcygpLAogICAgICAgICAgZmFsbGJhY2s6IGZhbGxiYWNrCiAgICAgICAgfTsKICAgICAgfTsKICAgICAgc3RydWN0dXJlVGVzdCA9IGJ1aWxkVGVzdChjcmVhdGVEb2N1bWVudFVzaW5nV3JpdGUsIChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBfcmVmLCBfcmVmMTsKICAgICAgICAgIHJldHVybiAoKF9yZWYgPSBjcmVhdGVNZXRob2QoJzxodG1sPjxib2R5PjxwPnRlc3QnKSkgIT0gbnVsbCA/IChfcmVmMSA9IF9yZWYuYm9keSkgIT0gbnVsbCA/IF9yZWYxLmNoaWxkTm9kZXMubGVuZ3RoIDogdm9pZCAwIDogdm9pZCAwKSA9PT0gMTsKICAgICAgICB9OwogICAgICB9KSh0aGlzKSk7CiAgICAgIGZvcm1OZXN0aW5nVGVzdCA9IGJ1aWxkVGVzdChjcmVhdGVEb2N1bWVudFVzaW5nRnJhZ21lbnQsIChmdW5jdGlvbihfdGhpcykgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBfcmVmLCBfcmVmMTsKICAgICAgICAgIHJldHVybiAoKF9yZWYgPSBjcmVhdGVNZXRob2QoJzxodG1sPjxib2R5Pjxmb3JtPjwvZm9ybT48ZGl2PjwvZGl2PjwvYm9keT48L2h0bWw+JykpICE9IG51bGwgPyAoX3JlZjEgPSBfcmVmLmJvZHkpICE9IG51bGwgPyBfcmVmMS5jaGlsZE5vZGVzLmxlbmd0aCA6IHZvaWQgMCA6IHZvaWQgMCkgPT09IDI7CiAgICAgICAgfTsKICAgICAgfSkodGhpcykpOwogICAgICByZXR1cm4gW3N0cnVjdHVyZVRlc3QsIGZvcm1OZXN0aW5nVGVzdF07CiAgICB9OwogICAgdHJ5IHsKICAgICAgaWYgKHdpbmRvdy5ET01QYXJzZXIpIHsKICAgICAgICBkb2NUZXN0cyA9IGJ1aWxkVGVzdHNVc2luZyhjcmVhdGVEb2N1bWVudFVzaW5nUGFyc2VyKTsKICAgICAgICByZXR1cm4gY3JlYXRlRG9jdW1lbnRVc2luZ1BhcnNlcjsKICAgICAgfQogICAgfSBjYXRjaCAoX2Vycm9yKSB7CiAgICAgIGUgPSBfZXJyb3I7CiAgICAgIGRvY1Rlc3RzID0gYnVpbGRUZXN0c1VzaW5nKGNyZWF0ZURvY3VtZW50VXNpbmdET00pOwogICAgICByZXR1cm4gY3JlYXRlRG9jdW1lbnRVc2luZ0RPTTsKICAgIH0gZmluYWxseSB7CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZG9jVGVzdHMubGVuZ3RoOyBfaSA8IF9sZW47IF9pKyspIHsKICAgICAgICBkb2NUZXN0ID0gZG9jVGVzdHNbX2ldOwogICAgICAgIGlmICghZG9jVGVzdC5wYXNzZXMpIHsKICAgICAgICAgIHJldHVybiBkb2NUZXN0LmZhbGxiYWNrOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CgogIENvbXBvbmVudFVybCA9IChmdW5jdGlvbigpIHsKICAgIGZ1bmN0aW9uIENvbXBvbmVudFVybChvcmlnaW5hbCkgewogICAgICB0aGlzLm9yaWdpbmFsID0gb3JpZ2luYWwgIT0gbnVsbCA/IG9yaWdpbmFsIDogZG9jdW1lbnQubG9jYXRpb24uaHJlZjsKICAgICAgaWYgKHRoaXMub3JpZ2luYWwuY29uc3RydWN0b3IgPT09IENvbXBvbmVudFVybCkgewogICAgICAgIHJldHVybiB0aGlzLm9yaWdpbmFsOwogICAgICB9CiAgICAgIHRoaXMuX3BhcnNlKCk7CiAgICB9CgogICAgQ29tcG9uZW50VXJsLnByb3RvdHlwZS53aXRob3V0SGFzaCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5ocmVmLnJlcGxhY2UodGhpcy5oYXNoLCAnJykucmVwbGFjZSgnIycsICcnKTsKICAgIH07CgogICAgQ29tcG9uZW50VXJsLnByb3RvdHlwZS53aXRob3V0SGFzaEZvcklFMTBjb21wYXRpYmlsaXR5ID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLndpdGhvdXRIYXNoKCk7CiAgICB9OwoKICAgIENvbXBvbmVudFVybC5wcm90b3R5cGUuaGFzTm9IYXNoID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmhhc2gubGVuZ3RoID09PSAwOwogICAgfTsKCiAgICBDb21wb25lbnRVcmwucHJvdG90eXBlLmNyb3NzT3JpZ2luID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLm9yaWdpbiAhPT0gKG5ldyBDb21wb25lbnRVcmwpLm9yaWdpbjsKICAgIH07CgogICAgQ29tcG9uZW50VXJsLnByb3RvdHlwZS5fcGFyc2UgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIF9yZWY7CiAgICAgICh0aGlzLmxpbmsgIT0gbnVsbCA/IHRoaXMubGluayA6IHRoaXMubGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKSkuaHJlZiA9IHRoaXMub3JpZ2luYWw7CiAgICAgIF9yZWYgPSB0aGlzLmxpbmssIHRoaXMuaHJlZiA9IF9yZWYuaHJlZiwgdGhpcy5wcm90b2NvbCA9IF9yZWYucHJvdG9jb2wsIHRoaXMuaG9zdCA9IF9yZWYuaG9zdCwgdGhpcy5ob3N0bmFtZSA9IF9yZWYuaG9zdG5hbWUsIHRoaXMucG9ydCA9IF9yZWYucG9ydCwgdGhpcy5wYXRobmFtZSA9IF9yZWYucGF0aG5hbWUsIHRoaXMuc2VhcmNoID0gX3JlZi5zZWFyY2gsIHRoaXMuaGFzaCA9IF9yZWYuaGFzaDsKICAgICAgdGhpcy5vcmlnaW4gPSBbdGhpcy5wcm90b2NvbCwgJy8vJywgdGhpcy5ob3N0bmFtZV0uam9pbignJyk7CiAgICAgIGlmICh0aGlzLnBvcnQubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgdGhpcy5vcmlnaW4gKz0gIjoiICsgdGhpcy5wb3J0OwogICAgICB9CiAgICAgIHRoaXMucmVsYXRpdmUgPSBbdGhpcy5wYXRobmFtZSwgdGhpcy5zZWFyY2gsIHRoaXMuaGFzaF0uam9pbignJyk7CiAgICAgIHJldHVybiB0aGlzLmFic29sdXRlID0gdGhpcy5ocmVmOwogICAgfTsKCiAgICByZXR1cm4gQ29tcG9uZW50VXJsOwoKICB9KSgpOwoKICBMaW5rID0gKGZ1bmN0aW9uKF9zdXBlcikgewogICAgX19leHRlbmRzKExpbmssIF9zdXBlcik7CgogICAgTGluay5IVE1MX0VYVEVOU0lPTlMgPSBbJ2h0bWwnXTsKCiAgICBMaW5rLmFsbG93RXh0ZW5zaW9ucyA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZXh0ZW5zaW9uLCBleHRlbnNpb25zLCBfaSwgX2xlbjsKICAgICAgZXh0ZW5zaW9ucyA9IDEgPD0gYXJndW1lbnRzLmxlbmd0aCA/IF9fc2xpY2UuY2FsbChhcmd1bWVudHMsIDApIDogW107CiAgICAgIGZvciAoX2kgPSAwLCBfbGVuID0gZXh0ZW5zaW9ucy5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewogICAgICAgIGV4dGVuc2lvbiA9IGV4dGVuc2lvbnNbX2ldOwogICAgICAgIExpbmsuSFRNTF9FWFRFTlNJT05TLnB1c2goZXh0ZW5zaW9uKTsKICAgICAgfQogICAgICByZXR1cm4gTGluay5IVE1MX0VYVEVOU0lPTlM7CiAgICB9OwoKICAgIGZ1bmN0aW9uIExpbmsobGluaykgewogICAgICB0aGlzLmxpbmsgPSBsaW5rOwogICAgICBpZiAodGhpcy5saW5rLmNvbnN0cnVjdG9yID09PSBMaW5rKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubGluazsKICAgICAgfQogICAgICB0aGlzLm9yaWdpbmFsID0gdGhpcy5saW5rLmhyZWY7CiAgICAgIHRoaXMub3JpZ2luYWxFbGVtZW50ID0gdGhpcy5saW5rOwogICAgICB0aGlzLmxpbmsgPSB0aGlzLmxpbmsuY2xvbmVOb2RlKGZhbHNlKTsKICAgICAgTGluay5fX3N1cGVyX18uY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgICBMaW5rLnByb3RvdHlwZS5zaG91bGRJZ25vcmUgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuY3Jvc3NPcmlnaW4oKSB8fCB0aGlzLl9hbmNob3JlZCgpIHx8IHRoaXMuX25vbkh0bWwoKSB8fCB0aGlzLl9vcHRPdXQoKSB8fCB0aGlzLl90YXJnZXQoKTsKICAgIH07CgogICAgTGluay5wcm90b3R5cGUuX2FuY2hvcmVkID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAodGhpcy5oYXNoLmxlbmd0aCA+IDAgfHwgdGhpcy5ocmVmLmNoYXJBdCh0aGlzLmhyZWYubGVuZ3RoIC0gMSkgPT09ICcjJykgJiYgKHRoaXMud2l0aG91dEhhc2goKSA9PT0gKG5ldyBDb21wb25lbnRVcmwpLndpdGhvdXRIYXNoKCkpOwogICAgfTsKCiAgICBMaW5rLnByb3RvdHlwZS5fbm9uSHRtbCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5wYXRobmFtZS5tYXRjaCgvXC5bYS16XSskL2cpICYmICF0aGlzLnBhdGhuYW1lLm1hdGNoKG5ldyBSZWdFeHAoIlxcLig/OiIgKyAoTGluay5IVE1MX0VYVEVOU0lPTlMuam9pbignfCcpKSArICIpPyQiLCAnZycpKTsKICAgIH07CgogICAgTGluay5wcm90b3R5cGUuX29wdE91dCA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaWdub3JlLCBsaW5rOwogICAgICBsaW5rID0gdGhpcy5vcmlnaW5hbEVsZW1lbnQ7CiAgICAgIHdoaWxlICghKGlnbm9yZSB8fCBsaW5rID09PSBkb2N1bWVudCkpIHsKICAgICAgICBpZ25vcmUgPSBsaW5rLmdldEF0dHJpYnV0ZSgnZGF0YS1uby10dXJib2xpbmsnKSAhPSBudWxsOwogICAgICAgIGxpbmsgPSBsaW5rLnBhcmVudE5vZGU7CiAgICAgIH0KICAgICAgcmV0dXJuIGlnbm9yZTsKICAgIH07CgogICAgTGluay5wcm90b3R5cGUuX3RhcmdldCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5saW5rLnRhcmdldC5sZW5ndGggIT09IDA7CiAgICB9OwoKICAgIHJldHVybiBMaW5rOwoKICB9KShDb21wb25lbnRVcmwpOwoKICBDbGljayA9IChmdW5jdGlvbigpIHsKICAgIENsaWNrLmluc3RhbGxIYW5kbGVyTGFzdCA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIGlmICghZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgQ2xpY2suaGFuZGxlLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgQ2xpY2suaGFuZGxlLCBmYWxzZSk7CiAgICAgIH0KICAgIH07CgogICAgQ2xpY2suaGFuZGxlID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgcmV0dXJuIG5ldyBDbGljayhldmVudCk7CiAgICB9OwoKICAgIGZ1bmN0aW9uIENsaWNrKGV2ZW50KSB7CiAgICAgIHRoaXMuZXZlbnQgPSBldmVudDsKICAgICAgaWYgKHRoaXMuZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLl9leHRyYWN0TGluaygpOwogICAgICBpZiAodGhpcy5fdmFsaWRGb3JUdXJib2xpbmtzKCkpIHsKICAgICAgICBpZiAoIXBhZ2VDaGFuZ2VQcmV2ZW50ZWQodGhpcy5saW5rLmFic29sdXRlKSkgewogICAgICAgICAgdmlzaXQodGhpcy5saW5rLmhyZWYpOwogICAgICAgIH0KICAgICAgICB0aGlzLmV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0KICAgIH0KCiAgICBDbGljay5wcm90b3R5cGUuX2V4dHJhY3RMaW5rID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsaW5rOwogICAgICBsaW5rID0gdGhpcy5ldmVudC50YXJnZXQ7CiAgICAgIHdoaWxlICghKCFsaW5rLnBhcmVudE5vZGUgfHwgbGluay5ub2RlTmFtZSA9PT0gJ0EnKSkgewogICAgICAgIGxpbmsgPSBsaW5rLnBhcmVudE5vZGU7CiAgICAgIH0KICAgICAgaWYgKGxpbmsubm9kZU5hbWUgPT09ICdBJyAmJiBsaW5rLmhyZWYubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubGluayA9IG5ldyBMaW5rKGxpbmspOwogICAgICB9CiAgICB9OwoKICAgIENsaWNrLnByb3RvdHlwZS5fdmFsaWRGb3JUdXJib2xpbmtzID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAodGhpcy5saW5rICE9IG51bGwpICYmICEodGhpcy5saW5rLnNob3VsZElnbm9yZSgpIHx8IHRoaXMuX25vblN0YW5kYXJkQ2xpY2soKSk7CiAgICB9OwoKICAgIENsaWNrLnByb3RvdHlwZS5fbm9uU3RhbmRhcmRDbGljayA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5ldmVudC53aGljaCA+IDEgfHwgdGhpcy5ldmVudC5tZXRhS2V5IHx8IHRoaXMuZXZlbnQuY3RybEtleSB8fCB0aGlzLmV2ZW50LnNoaWZ0S2V5IHx8IHRoaXMuZXZlbnQuYWx0S2V5OwogICAgfTsKCiAgICByZXR1cm4gQ2xpY2s7CgogIH0pKCk7CgogIGJ5cGFzc09uTG9hZFBvcHN0YXRlID0gZnVuY3Rpb24oZm4pIHsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZuLCA1MDApOwogIH07CgogIGluc3RhbGxEb2N1bWVudFJlYWR5UGFnZUV2ZW50VHJpZ2dlcnMgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgKGZ1bmN0aW9uKCkgewogICAgICB0cmlnZ2VyRXZlbnQoRVZFTlRTLkNIQU5HRSk7CiAgICAgIHJldHVybiB0cmlnZ2VyRXZlbnQoRVZFTlRTLlVQREFURSk7CiAgICB9KSwgdHJ1ZSk7CiAgfTsKCiAgaW5zdGFsbEpxdWVyeUFqYXhTdWNjZXNzUGFnZVVwZGF0ZVRyaWdnZXIgPSBmdW5jdGlvbigpIHsKICAgIGlmICh0eXBlb2YgalF1ZXJ5ICE9PSAndW5kZWZpbmVkJykgewogICAgICByZXR1cm4galF1ZXJ5KGRvY3VtZW50KS5vbignYWpheFN1Y2Nlc3MnLCBmdW5jdGlvbihldmVudCwgeGhyLCBzZXR0aW5ncykgewogICAgICAgIGlmICghalF1ZXJ5LnRyaW0oeGhyLnJlc3BvbnNlVGV4dCkpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRyaWdnZXJFdmVudChFVkVOVFMuVVBEQVRFKTsKICAgICAgfSk7CiAgICB9CiAgfTsKCiAgaW5zdGFsbEhpc3RvcnlDaGFuZ2VIYW5kbGVyID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgIHZhciBjYWNoZWRQYWdlLCBfcmVmOwogICAgaWYgKChfcmVmID0gZXZlbnQuc3RhdGUpICE9IG51bGwgPyBfcmVmLnR1cmJvbGlua3MgOiB2b2lkIDApIHsKICAgICAgaWYgKGNhY2hlZFBhZ2UgPSBwYWdlQ2FjaGVbKG5ldyBDb21wb25lbnRVcmwoZXZlbnQuc3RhdGUudXJsKSkuYWJzb2x1dGVdKSB7CiAgICAgICAgY2FjaGVDdXJyZW50UGFnZSgpOwogICAgICAgIHJldHVybiBmZXRjaEhpc3RvcnkoY2FjaGVkUGFnZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHZpc2l0KGV2ZW50LnRhcmdldC5sb2NhdGlvbi5ocmVmKTsKICAgICAgfQogICAgfQogIH07CgogIGluaXRpYWxpemVUdXJib2xpbmtzID0gZnVuY3Rpb24oKSB7CiAgICByZW1lbWJlckN1cnJlbnRVcmwoKTsKICAgIHJlbWVtYmVyQ3VycmVudFN0YXRlKCk7CiAgICBjcmVhdGVEb2N1bWVudCA9IGJyb3dzZXJDb21wYXRpYmxlRG9jdW1lbnRQYXJzZXIoKTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgQ2xpY2suaW5zdGFsbEhhbmRsZXJMYXN0LCB0cnVlKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdoYXNoY2hhbmdlJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgcmVtZW1iZXJDdXJyZW50VXJsKCk7CiAgICAgIHJldHVybiByZW1lbWJlckN1cnJlbnRTdGF0ZSgpOwogICAgfSwgZmFsc2UpOwogICAgcmV0dXJuIGJ5cGFzc09uTG9hZFBvcHN0YXRlKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgaW5zdGFsbEhpc3RvcnlDaGFuZ2VIYW5kbGVyLCBmYWxzZSk7CiAgICB9KTsKICB9OwoKICBoaXN0b3J5U3RhdGVJc0RlZmluZWQgPSB3aW5kb3cuaGlzdG9yeS5zdGF0ZSAhPT0gdm9pZCAwIHx8IG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goL0ZpcmVmb3hcLzJbNnw3XS8pOwoKICBicm93c2VyU3VwcG9ydHNQdXNoU3RhdGUgPSB3aW5kb3cuaGlzdG9yeSAmJiB3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUgJiYgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlICYmIGhpc3RvcnlTdGF0ZUlzRGVmaW5lZDsKCiAgYnJvd3NlcklzbnRCdWdneSA9ICFuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9DcmlPU1wvLyk7CgogIHJlcXVlc3RNZXRob2RJc1NhZmUgPSAoX3JlZiA9IHBvcENvb2tpZSgncmVxdWVzdF9tZXRob2QnKSkgPT09ICdHRVQnIHx8IF9yZWYgPT09ICcnOwoKICBicm93c2VyU3VwcG9ydHNUdXJib2xpbmtzID0gYnJvd3NlclN1cHBvcnRzUHVzaFN0YXRlICYmIGJyb3dzZXJJc250QnVnZ3kgJiYgcmVxdWVzdE1ldGhvZElzU2FmZTsKCiAgYnJvd3NlclN1cHBvcnRzQ3VzdG9tRXZlbnRzID0gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciAmJiBkb2N1bWVudC5jcmVhdGVFdmVudDsKCiAgaWYgKGJyb3dzZXJTdXBwb3J0c0N1c3RvbUV2ZW50cykgewogICAgaW5zdGFsbERvY3VtZW50UmVhZHlQYWdlRXZlbnRUcmlnZ2VycygpOwogICAgaW5zdGFsbEpxdWVyeUFqYXhTdWNjZXNzUGFnZVVwZGF0ZVRyaWdnZXIoKTsKICB9CgogIGlmIChicm93c2VyU3VwcG9ydHNUdXJib2xpbmtzKSB7CiAgICB2aXNpdCA9IGZldGNoOwogICAgaW5pdGlhbGl6ZVR1cmJvbGlua3MoKTsKICB9IGVsc2UgewogICAgdmlzaXQgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgcmV0dXJuIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgPSB1cmw7CiAgICB9OwogIH0KCiAgdGhpcy5UdXJib2xpbmtzID0gewogICAgdmlzaXQ6IHZpc2l0LAogICAgcGFnZXNDYWNoZWQ6IHBhZ2VzQ2FjaGVkLAogICAgZW5hYmxlVHJhbnNpdGlvbkNhY2hlOiBlbmFibGVUcmFuc2l0aW9uQ2FjaGUsCiAgICBhbGxvd0xpbmtFeHRlbnNpb25zOiBMaW5rLmFsbG93RXh0ZW5zaW9ucywKICAgIHN1cHBvcnRlZDogYnJvd3NlclN1cHBvcnRzVHVyYm9saW5rcywKICAgIEVWRU5UUzogY2xvbmUoRVZFTlRTKQogIH07Cgp9KS5jYWxsKHRoaXMpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 23:47:38 GMT",
                    "Content-Length": "22751",
                    "Date": "Sat, 08 Nov 2014 23:47:38 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}