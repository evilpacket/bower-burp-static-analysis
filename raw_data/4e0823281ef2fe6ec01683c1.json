{
    "url": "http://localhost:9999/binyatov/captis.js/workspace/Introduction_files/impress.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>document.URL</b> and written to <b>the 'innerHTML' property of a DOM element</b> via the following statements:<ul><li>var baseURL = document.URL.substring(0, document.URL.search('#/'));</li><li>button.innerHTML = '&lt;iframe src=\"'+baseURL+\"?preview#/\"+id+'\"&gt;';</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/binyatov/captis.js/workspace/Introduction_files/impress.js",
                "path": "/binyatov/captis.js/workspace/Introduction_files/impress.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9iaW55YXRvdi9jYXB0aXMuanMvd29ya3NwYWNlL0ludHJvZHVjdGlvbl9maWxlcy9pbXByZXNzLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDEzODINCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTQ6NDM6MzggR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDE0OjQzOjM1IEdNVA0KDQovKioKICogaW1wcmVzcy5qcwogKgogKiBpbXByZXNzLmpzIGlzIGEgcHJlc2VudGF0aW9uIHRvb2wgYmFzZWQgb24gdGhlIHBvd2VyIG9mIENTUzMgdHJhbnNmb3JtcyBhbmQgdHJhbnNpdGlvbnMKICogaW4gbW9kZXJuIGJyb3dzZXJzIGFuZCBpbnNwaXJlZCBieSB0aGUgaWRlYSBiZWhpbmQgcHJlemkuY29tLgogKgogKgogKiBDb3B5cmlnaHQgMjAxMS0yMDEyIEJhcnRlayBTem9wa2EgKEBiYXJ0YXopCiAqCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBMaWNlbnNlcy4KICoKICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAqICBhdXRob3I6ICBCYXJ0ZWsgU3pvcGthCiAqICB2ZXJzaW9uOiAwLjUuMwogKiAgdXJsOiAgICAgaHR0cDovL2JhcnRhei5naXRodWIuY29tL2ltcHJlc3MuanMvCiAqICBzb3VyY2U6ICBodHRwOi8vZ2l0aHViLmNvbS9iYXJ0YXovaW1wcmVzcy5qcy8KICovCgovKmpzaGludCBiaXR3aXNlOnRydWUsIGN1cmx5OnRydWUsIGVxZXFlcTp0cnVlLCBmb3Jpbjp0cnVlLCBsYXRlZGVmOnRydWUsIG5ld2NhcDp0cnVlLAogICAgICAgICBub2FyZzp0cnVlLCBub2VtcHR5OnRydWUsIHVuZGVmOnRydWUsIHN0cmljdDp0cnVlLCBicm93c2VyOnRydWUgKi8KCi8vIFlvdSBhcmUgb25lIG9mIHRob3NlIHdobyBsaWtlIHRvIGtub3cgaG93IHRoaW5nIHdvcmsgaW5zaWRlPwovLyBMZXQgbWUgc2hvdyB5b3UgdGhlIGNvZ3MgdGhhdCBtYWtlIGltcHJlc3MuanMgcnVuLi4uCihmdW5jdGlvbiAoIGRvY3VtZW50LCB3aW5kb3cgKSB7CiAgICAndXNlIHN0cmljdCc7CiAgICAKICAgIC8vIEhFTFBFUiBGVU5DVElPTlMKICAgIAogICAgLy8gYHBmeGAgaXMgYSBmdW5jdGlvbiB0aGF0IHRha2VzIGEgc3RhbmRhcmQgQ1NTIHByb3BlcnR5IG5hbWUgYXMgYSBwYXJhbWV0ZXIKICAgIC8vIGFuZCByZXR1cm5zIGl0J3MgcHJlZml4ZWQgdmVyc2lvbiB2YWxpZCBmb3IgY3VycmVudCBicm93c2VyIGl0IHJ1bnMgaW4uCiAgICAvLyBUaGUgY29kZSBpcyBoZWF2aWx5IGluc3BpcmVkIGJ5IE1vZGVybml6ciBodHRwOi8vd3d3Lm1vZGVybml6ci5jb20vCiAgICB2YXIgcGZ4ID0gKGZ1bmN0aW9uICgpIHsKICAgICAgICAKICAgICAgICB2YXIgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkdW1teScpLnN0eWxlLAogICAgICAgICAgICBwcmVmaXhlcyA9ICdXZWJraXQgTW96IE8gbXMgS2h0bWwnLnNwbGl0KCcgJyksCiAgICAgICAgICAgIG1lbW9yeSA9IHt9OwogICAgICAgIAogICAgICAgIHJldHVybiBmdW5jdGlvbiAoIHByb3AgKSB7CiAgICAgICAgICAgIGlmICggdHlwZW9mIG1lbW9yeVsgcHJvcCBdID09PSAidW5kZWZpbmVkIiApIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdmFyIHVjUHJvcCAgPSBwcm9wLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoMSksCiAgICAgICAgICAgICAgICAgICAgcHJvcHMgICA9IChwcm9wICsgJyAnICsgcHJlZml4ZXMuam9pbih1Y1Byb3AgKyAnICcpICsgdWNQcm9wKS5zcGxpdCgnICcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBtZW1vcnlbIHByb3AgXSA9IG51bGw7CiAgICAgICAgICAgICAgICBmb3IgKCB2YXIgaSBpbiBwcm9wcyApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIHN0eWxlWyBwcm9wc1tpXSBdICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lbW9yeVsgcHJvcCBdID0gcHJvcHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBtZW1vcnlbIHByb3AgXTsKICAgICAgICB9OwogICAgCiAgICB9KSgpOwogICAgCiAgICAvLyBgYXJyYWlmeWAgdGFrZXMgYW4gYXJyYXktbGlrZSBvYmplY3QgYW5kIHR1cm5zIGl0IGludG8gcmVhbCBBcnJheQogICAgLy8gdG8gbWFrZSBhbGwgdGhlIEFycmF5LnByb3RvdHlwZSBnb29kbmVzcyBhdmFpbGFibGUuCiAgICB2YXIgYXJyYXlpZnkgPSBmdW5jdGlvbiAoIGEgKSB7CiAgICAgICAgcmV0dXJuIFtdLnNsaWNlLmNhbGwoIGEgKTsKICAgIH07CiAgICAKICAgIC8vIGBjc3NgIGZ1bmN0aW9uIGFwcGxpZXMgdGhlIHN0eWxlcyBnaXZlbiBpbiBgcHJvcHNgIG9iamVjdCB0byB0aGUgZWxlbWVudAogICAgLy8gZ2l2ZW4gYXMgYGVsYC4gSXQgcnVucyBhbGwgcHJvcGVydHkgbmFtZXMgdGhyb3VnaCBgcGZ4YCBmdW5jdGlvbiB0byBtYWtlCiAgICAvLyBzdXJlIHByb3BlciBwcmVmaXhlZCB2ZXJzaW9uIG9mIHRoZSBwcm9wZXJ0eSBpcyB1c2VkLgogICAgdmFyIGNzcyA9IGZ1bmN0aW9uICggZWwsIHByb3BzICkgewogICAgICAgIHZhciBrZXksIHBrZXk7CiAgICAgICAgZm9yICgga2V5IGluIHByb3BzICkgewogICAgICAgICAgICBpZiAoIHByb3BzLmhhc093blByb3BlcnR5KGtleSkgKSB7CiAgICAgICAgICAgICAgICBwa2V5ID0gcGZ4KGtleSk7CiAgICAgICAgICAgICAgICBpZiAoIHBrZXkgIT09IG51bGwgKSB7CiAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGVbcGtleV0gPSBwcm9wc1trZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBlbDsKICAgIH07CiAgICAKICAgIC8vIGB0b051bWJlcmAgdGFrZXMgYSB2YWx1ZSBnaXZlbiBhcyBgbnVtZXJpY2AgcGFyYW1ldGVyIGFuZCB0cmllcyB0byB0dXJuCiAgICAvLyBpdCBpbnRvIGEgbnVtYmVyLiBJZiBpdCBpcyBub3QgcG9zc2libGUgaXQgcmV0dXJucyAwIChvciBvdGhlciB2YWx1ZQogICAgLy8gZ2l2ZW4gYXMgYGZhbGxiYWNrYCkuCiAgICB2YXIgdG9OdW1iZXIgPSBmdW5jdGlvbiAobnVtZXJpYywgZmFsbGJhY2spIHsKICAgICAgICByZXR1cm4gaXNOYU4obnVtZXJpYykgPyAoZmFsbGJhY2sgfHwgMCkgOiBOdW1iZXIobnVtZXJpYyk7CiAgICB9OwogICAgCiAgICAvLyBgYnlJZGAgcmV0dXJucyBlbGVtZW50IHdpdGggZ2l2ZW4gYGlkYCAtIHlvdSBwcm9iYWJseSBoYXZlIGd1ZXNzZWQgdGhhdCA7KQogICAgdmFyIGJ5SWQgPSBmdW5jdGlvbiAoIGlkICkgewogICAgICAgIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgICB9OwogICAgCiAgICAvLyBgJGAgcmV0dXJucyBmaXJzdCBlbGVtZW50IGZvciBnaXZlbiBDU1MgYHNlbGVjdG9yYCBpbiB0aGUgYGNvbnRleHRgIG9mCiAgICAvLyB0aGUgZ2l2ZW4gZWxlbWVudCBvciB3aG9sZSBkb2N1bWVudC4KICAgIHZhciAkID0gZnVuY3Rpb24gKCBzZWxlY3RvciwgY29udGV4dCApIHsKICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKICAgICAgICByZXR1cm4gY29udGV4dC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTsKICAgIH07CiAgICAKICAgIC8vIGAkJGAgcmV0dXJuIGFuIGFycmF5IG9mIGVsZW1lbnRzIGZvciBnaXZlbiBDU1MgYHNlbGVjdG9yYCBpbiB0aGUgYGNvbnRleHRgIG9mCiAgICAvLyB0aGUgZ2l2ZW4gZWxlbWVudCBvciB3aG9sZSBkb2N1bWVudC4KICAgIHZhciAkJCA9IGZ1bmN0aW9uICggc2VsZWN0b3IsIGNvbnRleHQgKSB7CiAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CiAgICAgICAgcmV0dXJuIGFycmF5aWZ5KCBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpICk7CiAgICB9OwogICAgCiAgICAvLyBgdHJpZ2dlckV2ZW50YCBidWlsZHMgYSBjdXN0b20gRE9NIGV2ZW50IHdpdGggZ2l2ZW4gYGV2ZW50TmFtZWAgYW5kIGBkZXRhaWxgIGRhdGEKICAgIC8vIGFuZCB0cmlnZ2VycyBpdCBvbiBlbGVtZW50IGdpdmVuIGFzIGBlbGAuCiAgICB2YXIgdHJpZ2dlckV2ZW50ID0gZnVuY3Rpb24gKGVsLCBldmVudE5hbWUsIGRldGFpbCkgewogICAgICAgIHZhciBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJDdXN0b21FdmVudCIpOwogICAgICAgIGV2ZW50LmluaXRDdXN0b21FdmVudChldmVudE5hbWUsIHRydWUsIHRydWUsIGRldGFpbCk7CiAgICAgICAgZWwuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICB9OwogICAgCiAgICAvLyBgdHJhbnNsYXRlYCBidWlsZHMgYSB0cmFuc2xhdGUgdHJhbnNmb3JtIHN0cmluZyBmb3IgZ2l2ZW4gZGF0YS4KICAgIHZhciB0cmFuc2xhdGUgPSBmdW5jdGlvbiAoIHQgKSB7CiAgICAgICAgcmV0dXJuICIgdHJhbnNsYXRlM2QoIiArIHQueCArICJweCwiICsgdC55ICsgInB4LCIgKyB0LnogKyAicHgpICI7CiAgICB9OwogICAgCiAgICAvLyBgcm90YXRlYCBidWlsZHMgYSByb3RhdGUgdHJhbnNmb3JtIHN0cmluZyBmb3IgZ2l2ZW4gZGF0YS4KICAgIC8vIEJ5IGRlZmF1bHQgdGhlIHJvdGF0aW9ucyBhcmUgaW4gWCBZIFogb3JkZXIgdGhhdCBjYW4gYmUgcmV2ZXJ0ZWQgYnkgcGFzc2luZyBgdHJ1ZWAKICAgIC8vIGFzIHNlY29uZCBwYXJhbWV0ZXIuCiAgICB2YXIgcm90YXRlID0gZnVuY3Rpb24gKCByLCByZXZlcnQgKSB7CiAgICAgICAgdmFyIHJYID0gIiByb3RhdGVYKCIgKyByLnggKyAiZGVnKSAiLAogICAgICAgICAgICByWSA9ICIgcm90YXRlWSgiICsgci55ICsgImRlZykgIiwKICAgICAgICAgICAgclogPSAiIHJvdGF0ZVooIiArIHIueiArICJkZWcpICI7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJldmVydCA/IHJaK3JZK3JYIDogclgrclkrclo7CiAgICB9OwogICAgCiAgICAvLyBgc2NhbGVgIGJ1aWxkcyBhIHNjYWxlIHRyYW5zZm9ybSBzdHJpbmcgZm9yIGdpdmVuIGRhdGEuCiAgICB2YXIgc2NhbGUgPSBmdW5jdGlvbiAoIHMgKSB7CiAgICAgICAgcmV0dXJuICIgc2NhbGUoIiArIHMgKyAiKSAiOwogICAgfTsKICAgIAogICAgLy8gYHBlcnNwZWN0aXZlYCBidWlsZHMgYSBwZXJzcGVjdGl2ZSB0cmFuc2Zvcm0gc3RyaW5nIGZvciBnaXZlbiBkYXRhLgogICAgdmFyIHBlcnNwZWN0aXZlID0gZnVuY3Rpb24gKCBwICkgewogICAgICAgIHJldHVybiAiIHBlcnNwZWN0aXZlKCIgKyBwICsgInB4KSAiOwogICAgfTsKICAgIAogICAgLy8gYGdldEVsZW1lbnRGcm9tSGFzaGAgcmV0dXJucyBhbiBlbGVtZW50IGxvY2F0ZWQgYnkgaWQgZnJvbSBoYXNoIHBhcnQgb2YKICAgIC8vIHdpbmRvdyBsb2NhdGlvbi4KICAgIHZhciBnZXRFbGVtZW50RnJvbUhhc2ggPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gZ2V0IGlkIGZyb20gdXJsICMgYnkgcmVtb3ZpbmcgYCNgIG9yIGAjL2AgZnJvbSB0aGUgYmVnaW5uaW5nLAogICAgICAgIC8vIHNvIGJvdGggImZhbGxiYWNrIiBgI3NsaWRlLWlkYCBhbmQgImVuaGFuY2VkIiBgIy9zbGlkZS1pZGAgd2lsbCB3b3JrCiAgICAgICAgcmV0dXJuIGJ5SWQoIHdpbmRvdy5sb2NhdGlvbi5oYXNoLnJlcGxhY2UoL14jXC8/LywiIikgKTsKICAgIH07CiAgICAKICAgIC8vIGBjb21wdXRlV2luZG93U2NhbGVgIGNvdW50cyB0aGUgc2NhbGUgZmFjdG9yIGJldHdlZW4gd2luZG93IHNpemUgYW5kIHNpemUKICAgIC8vIGRlZmluZWQgZm9yIHRoZSBwcmVzZW50YXRpb24gaW4gdGhlIGNvbmZpZy4KICAgIHZhciBjb21wdXRlV2luZG93U2NhbGUgPSBmdW5jdGlvbiAoIGNvbmZpZyApIHsKICAgICAgICB2YXIgaFNjYWxlID0gd2luZG93LmlubmVySGVpZ2h0IC8gY29uZmlnLmhlaWdodCwKICAgICAgICAgICAgd1NjYWxlID0gd2luZG93LmlubmVyV2lkdGggLyBjb25maWcud2lkdGgsCiAgICAgICAgICAgIHNjYWxlID0gaFNjYWxlID4gd1NjYWxlID8gd1NjYWxlIDogaFNjYWxlOwogICAgICAgIAogICAgICAgIGlmIChjb25maWcubWF4U2NhbGUgJiYgc2NhbGUgPiBjb25maWcubWF4U2NhbGUpIHsKICAgICAgICAgICAgc2NhbGUgPSBjb25maWcubWF4U2NhbGU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChjb25maWcubWluU2NhbGUgJiYgc2NhbGUgPCBjb25maWcubWluU2NhbGUpIHsKICAgICAgICAgICAgc2NhbGUgPSBjb25maWcubWluU2NhbGU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiBzY2FsZTsKICAgIH07CiAgICAKICAgIC8vIENIRUNLIFNVUFBPUlQKICAgIHZhciBib2R5ID0gZG9jdW1lbnQuYm9keTsKICAgIAogICAgdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpOwogICAgdmFyIGltcHJlc3NTdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJyb3dzZXIgc2hvdWxkIHN1cHBvcnQgQ1NTIDNEIHRyYW5zdG9ybXMgCiAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vKCBwZngoInBlcnNwZWN0aXZlIikgIT09IG51bGwgKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgYGNsYXNzTGlzdGAgYW5kIGBkYXRhc2V0YCBBUElzCiAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vKCBib2R5LmNsYXNzTGlzdCApICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vKCBib2R5LmRhdGFzZXQgKTsvLyAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBidXQgc29tZSBtb2JpbGUgZGV2aWNlcyBuZWVkIHRvIGJlIGJsYWNrbGlzdGVkLAogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgdGhlaXIgQ1NTIDNEIHN1cHBvcnQgb3IgaGFyZHdhcmUgaXMgbm90CiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZ29vZCBlbm91Z2ggdG8gcnVuIGltcHJlc3MuanMgcHJvcGVybHksIHNvcnJ5Li4uCiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgKCB1YS5zZWFyY2goLyhpcGhvbmUpfChpcG9kKXwoYW5kcm9pZCkvKSA9PT0gLTEgKTsKICAgIAogICAgaWYgKCFpbXByZXNzU3VwcG9ydGVkKSB7CiAgICAgICAgLy8gd2UgY2FuJ3QgYmUgc3VyZSB0aGF0IGBjbGFzc0xpc3RgIGlzIHN1cHBvcnRlZAogICAgICAgIGJvZHkuY2xhc3NOYW1lICs9ICIgaW1wcmVzcy1ub3Qtc3VwcG9ydGVkICI7CiAgICB9IGVsc2UgewogICAgICAgIGJvZHkuY2xhc3NMaXN0LnJlbW92ZSgiaW1wcmVzcy1ub3Qtc3VwcG9ydGVkIik7CiAgICAgICAgYm9keS5jbGFzc0xpc3QuYWRkKCJpbXByZXNzLXN1cHBvcnRlZCIpOwogICAgfQogICAgCiAgICAvLyBHTE9CQUxTIEFORCBERUZBVUxUUwogICAgCiAgICAvLyBUaGlzIGlzIHdlcmUgdGhlIHJvb3QgZWxlbWVudHMgb2YgYWxsIGltcHJlc3MuanMgaW5zdGFuY2VzIHdpbGwgYmUga2VwdC4KICAgIC8vIFllcywgdGhpcyBtZWFucyB5b3UgY2FuIGhhdmUgbW9yZSB0aGFuIG9uZSBpbnN0YW5jZSBvbiBhIHBhZ2UsIGJ1dCBJJ20gbm90CiAgICAvLyBzdXJlIGlmIGl0IG1ha2VzIGFueSBzZW5zZSBpbiBwcmFjdGljZSA7KQogICAgdmFyIHJvb3RzID0ge307CiAgICAKICAgIC8vIHNvbWUgZGVmYXVsdCBjb25maWcgdmFsdWVzLgogICAgdmFyIGRlZmF1bHRzID0gewogICAgICAgIHdpZHRoOiAxMDI0LAogICAgICAgIGhlaWdodDogNzY4LAogICAgICAgIG1heFNjYWxlOiAxLAogICAgICAgIG1pblNjYWxlOiAwLAogICAgICAgIAogICAgICAgIHBlcnNwZWN0aXZlOiAxMDAwLAogICAgICAgIAogICAgICAgIHRyYW5zaXRpb25EdXJhdGlvbjogMTAwMAogICAgfTsKICAgIAogICAgLy8gaXQncyBqdXN0IGFuIGVtcHR5IGZ1bmN0aW9uIC4uLiBhbmQgYSB1c2VsZXNzIGNvbW1lbnQuCiAgICB2YXIgZW1wdHkgPSBmdW5jdGlvbiAoKSB7IHJldHVybiBmYWxzZTsgfTsKICAgIAogICAgLy8gSU1QUkVTUy5KUyBBUEkKICAgIAogICAgLy8gQW5kIHRoYXQncyB3aGVyZSBpbnRlcmVzdGluZyB0aGluZ3Mgd2lsbCBzdGFydCB0byBoYXBwZW4uCiAgICAvLyBJdCdzIHRoZSBjb3JlIGBpbXByZXNzYCBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIGltcHJlc3MuanMgQVBJCiAgICAvLyBmb3IgYSBwcmVzZW50YXRpb24gYmFzZWQgb24gdGhlIGVsZW1lbnQgd2l0aCBnaXZlbiBpZCAoJ2ltcHJlc3MnCiAgICAvLyBieSBkZWZhdWx0KS4KICAgIHZhciBpbXByZXNzID0gd2luZG93LmltcHJlc3MgPSBmdW5jdGlvbiAoIHJvb3RJZCApIHsKICAgICAgICAKICAgICAgICAvLyBJZiBpbXByZXNzLmpzIGlzIG5vdCBzdXBwb3J0ZWQgYnkgdGhlIGJyb3dzZXIgcmV0dXJuIGEgZHVtbXkgQVBJCiAgICAgICAgLy8gaXQgbWF5IG5vdCBiZSBhIHBlcmZlY3Qgc29sdXRpb24gYnV0IHdlIHJldHVybiBlYXJseSBhbmQgYXZvaWQKICAgICAgICAvLyBydW5uaW5nIGNvZGUgdGhhdCBtYXkgdXNlIGZlYXR1cmVzIG5vdCBpbXBsZW1lbnRlZCBpbiB0aGUgYnJvd3Nlci4KICAgICAgICBpZiAoIWltcHJlc3NTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGluaXQ6IGVtcHR5LAogICAgICAgICAgICAgICAgZ290bzogZW1wdHksCiAgICAgICAgICAgICAgICBwcmV2OiBlbXB0eSwKICAgICAgICAgICAgICAgIG5leHQ6IGVtcHR5CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJvb3RJZCA9IHJvb3RJZCB8fCAiaW1wcmVzcyI7CiAgICAgICAgCiAgICAgICAgLy8gaWYgZ2l2ZW4gcm9vdCBpcyBhbHJlYWR5IGluaXRpYWxpemVkIGp1c3QgcmV0dXJuIHRoZSBBUEkKICAgICAgICBpZiAocm9vdHNbImltcHJlc3Mtcm9vdC0iICsgcm9vdElkXSkgewogICAgICAgICAgICByZXR1cm4gcm9vdHNbImltcHJlc3Mtcm9vdC0iICsgcm9vdElkXTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gZGF0YSBvZiBhbGwgcHJlc2VudGF0aW9uIHN0ZXBzCiAgICAgICAgdmFyIHN0ZXBzRGF0YSA9IHt9OwogICAgICAgIAogICAgICAgIC8vIGVsZW1lbnQgb2YgY3VycmVudGx5IGFjdGl2ZSBzdGVwCiAgICAgICAgdmFyIGFjdGl2ZVN0ZXAgPSBudWxsOwogICAgICAgIAogICAgICAgIC8vIGN1cnJlbnQgc3RhdGUgKHBvc2l0aW9uLCByb3RhdGlvbiBhbmQgc2NhbGUpIG9mIHRoZSBwcmVzZW50YXRpb24KICAgICAgICB2YXIgY3VycmVudFN0YXRlID0gbnVsbDsKICAgICAgICAKICAgICAgICAvLyBhcnJheSBvZiBzdGVwIGVsZW1lbnRzCiAgICAgICAgdmFyIHN0ZXBzID0gbnVsbDsKICAgICAgICAKICAgICAgICAvLyBjb25maWd1cmF0aW9uIG9wdGlvbnMKICAgICAgICB2YXIgY29uZmlnID0gbnVsbDsKICAgICAgICAKICAgICAgICAvLyBzY2FsZSBmYWN0b3Igb2YgdGhlIGJyb3dzZXIgd2luZG93CiAgICAgICAgdmFyIHdpbmRvd1NjYWxlID0gbnVsbDsgICAgICAgIAogICAgICAgIAogICAgICAgIC8vIHJvb3QgcHJlc2VudGF0aW9uIGVsZW1lbnRzCiAgICAgICAgdmFyIHJvb3QgPSBieUlkKCByb290SWQgKTsKICAgICAgICB2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgCiAgICAgICAgdmFyIGluaXRpYWxpemVkID0gZmFsc2U7CiAgICAgICAgCiAgICAgICAgLy8gU1RFUCBFVkVOVFMKICAgICAgICAvLwogICAgICAgIC8vIFRoZXJlIGFyZSBjdXJyZW50bHkgdHdvIHN0ZXAgZXZlbnRzIHRyaWdnZXJlZCBieSBpbXByZXNzLmpzCiAgICAgICAgLy8gYGltcHJlc3M6c3RlcGVudGVyYCBpcyB0cmlnZ2VyZWQgd2hlbiB0aGUgc3RlcCBpcyBzaG93biBvbiB0aGUgCiAgICAgICAgLy8gc2NyZWVuICh0aGUgdHJhbnNpdGlvbiBmcm9tIHRoZSBwcmV2aW91cyBvbmUgaXMgZmluaXNoZWQpIGFuZAogICAgICAgIC8vIGBpbXByZXNzOnN0ZXBsZWF2ZWAgaXMgdHJpZ2dlcmVkIHdoZW4gdGhlIHN0ZXAgaXMgbGVmdCAodGhlCiAgICAgICAgLy8gdHJhbnNpdGlvbiB0byBuZXh0IHN0ZXAganVzdCBzdGFydHMpLgogICAgICAgIAogICAgICAgIC8vIHJlZmVyZW5jZSB0byBsYXN0IGVudGVyZWQgc3RlcAogICAgICAgIHZhciBsYXN0RW50ZXJlZCA9IG51bGw7CiAgICAgICAgCiAgICAgICAgLy8gYG9uU3RlcEVudGVyYCBpcyBjYWxsZWQgd2hlbmV2ZXIgdGhlIHN0ZXAgZWxlbWVudCBpcyBlbnRlcmVkCiAgICAgICAgLy8gYnV0IHRoZSBldmVudCBpcyB0cmlnZ2VyZWQgb25seSBpZiB0aGUgc3RlcCBpcyBkaWZmZXJlbnQgdGhhbgogICAgICAgIC8vIGxhc3QgZW50ZXJlZCBzdGVwLgogICAgICAgIHZhciBvblN0ZXBFbnRlciA9IGZ1bmN0aW9uIChzdGVwKSB7CiAgICAgICAgICAgIGlmIChsYXN0RW50ZXJlZCAhPT0gc3RlcCkgewogICAgICAgICAgICAgICAgdHJpZ2dlckV2ZW50KHN0ZXAsICJpbXByZXNzOnN0ZXBlbnRlciIpOwogICAgICAgICAgICAgICAgbGFzdEVudGVyZWQgPSBzdGVwOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICAvLyBgb25TdGVwTGVhdmVgIGlzIGNhbGxlZCB3aGVuZXZlciB0aGUgc3RlcCBlbGVtZW50IGlzIGxlZnQKICAgICAgICAvLyBidXQgdGhlIGV2ZW50IGlzIHRyaWdnZXJlZCBvbmx5IGlmIHRoZSBzdGVwIGlzIHRoZSBzYW1lIGFzCiAgICAgICAgLy8gbGFzdCBlbnRlcmVkIHN0ZXAuCiAgICAgICAgdmFyIG9uU3RlcExlYXZlID0gZnVuY3Rpb24gKHN0ZXApIHsKICAgICAgICAgICAgaWYgKGxhc3RFbnRlcmVkID09PSBzdGVwKSB7CiAgICAgICAgICAgICAgICB0cmlnZ2VyRXZlbnQoc3RlcCwgImltcHJlc3M6c3RlcGxlYXZlIik7CiAgICAgICAgICAgICAgICBsYXN0RW50ZXJlZCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIAogICAgICAgIC8vIGBpbml0U3RlcGAgaW5pdGlhbGl6ZXMgZ2l2ZW4gc3RlcCBlbGVtZW50IGJ5IHJlYWRpbmcgZGF0YSBmcm9tIGl0cwogICAgICAgIC8vIGRhdGEgYXR0cmlidXRlcyBhbmQgc2V0dGluZyBjb3JyZWN0IHN0eWxlcy4KICAgICAgICB2YXIgaW5pdFN0ZXAgPSBmdW5jdGlvbiAoIGVsLCBpZHggKSB7CiAgICAgICAgICAgIHZhciBkYXRhID0gZWwuZGF0YXNldCwKICAgICAgICAgICAgICAgIHN0ZXAgPSB7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHg6IHRvTnVtYmVyKGRhdGEueCksCiAgICAgICAgICAgICAgICAgICAgICAgIHk6IHRvTnVtYmVyKGRhdGEueSksCiAgICAgICAgICAgICAgICAgICAgICAgIHo6IHRvTnVtYmVyKGRhdGEueikKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHJvdGF0ZTogewogICAgICAgICAgICAgICAgICAgICAgICB4OiB0b051bWJlcihkYXRhLnJvdGF0ZVgpLAogICAgICAgICAgICAgICAgICAgICAgICB5OiB0b051bWJlcihkYXRhLnJvdGF0ZVkpLAogICAgICAgICAgICAgICAgICAgICAgICB6OiB0b051bWJlcihkYXRhLnJvdGF0ZVogfHwgZGF0YS5yb3RhdGUpCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBzY2FsZTogdG9OdW1iZXIoZGF0YS5zY2FsZSwgMSksCiAgICAgICAgICAgICAgICAgICAgZWw6IGVsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCAhZWwuaWQgKSB7CiAgICAgICAgICAgICAgICBlbC5pZCA9ICJzdGVwLSIgKyAoaWR4ICsgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHN0ZXBzRGF0YVsiaW1wcmVzcy0iICsgZWwuaWRdID0gc3RlcDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNzcyhlbCwgewogICAgICAgICAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm06ICJ0cmFuc2xhdGUoLTUwJSwtNTAlKSIgKwogICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGUoc3RlcC50cmFuc2xhdGUpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRlKHN0ZXAucm90YXRlKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlKHN0ZXAuc2NhbGUpLAogICAgICAgICAgICAgICAgdHJhbnNmb3JtU3R5bGU6ICJwcmVzZXJ2ZS0zZCIKICAgICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICB2YXIgbmV3U3RlcCA9IGZ1bmN0aW9uICggZWwgKSB7CiAgICAgICAgICAgIGluaXRTdGVwKGVsKTsKICAgICAgICAgICAgc3RlcHMucHVzaChlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBgaW5pdGAgQVBJIGZ1bmN0aW9uIHRoYXQgaW5pdGlhbGl6ZXMgKGFuZCBydW5zKSB0aGUgcHJlc2VudGF0aW9uLgogICAgICAgIHZhciBpbml0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAoaW5pdGlhbGl6ZWQpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBGaXJzdCB3ZSBzZXQgdXAgdGhlIHZpZXdwb3J0IGZvciBtb2JpbGUgZGV2aWNlcy4KICAgICAgICAgICAgLy8gRm9yIHNvbWUgcmVhc29uIGlQYWQgZ29lcyBudXRzIHdoZW4gaXQgaXMgbm90IGRvbmUgcHJvcGVybHkuCiAgICAgICAgICAgIHZhciBtZXRhID0gJCgibWV0YVtuYW1lPSd2aWV3cG9ydCddIikgfHwgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibWV0YSIpOwogICAgICAgICAgICBtZXRhLmNvbnRlbnQgPSAid2lkdGg9ZGV2aWNlLXdpZHRoLCBtaW5pbXVtLXNjYWxlPTEsIG1heGltdW0tc2NhbGU9MSwgdXNlci1zY2FsYWJsZT1ubyI7CiAgICAgICAgICAgIGlmIChtZXRhLnBhcmVudE5vZGUgIT09IGRvY3VtZW50LmhlYWQpIHsKICAgICAgICAgICAgICAgIG1ldGEubmFtZSA9ICd2aWV3cG9ydCc7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKG1ldGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBpbml0aWFsaXplIGNvbmZpZ3VyYXRpb24gb2JqZWN0CiAgICAgICAgICAgIHZhciByb290RGF0YSA9IHJvb3QuZGF0YXNldDsKICAgICAgICAgICAgY29uZmlnID0gewogICAgICAgICAgICAgICAgd2lkdGg6IHRvTnVtYmVyKCByb290RGF0YS53aWR0aCwgZGVmYXVsdHMud2lkdGggKSwKICAgICAgICAgICAgICAgIGhlaWdodDogdG9OdW1iZXIoIHJvb3REYXRhLmhlaWdodCwgZGVmYXVsdHMuaGVpZ2h0ICksCiAgICAgICAgICAgICAgICBtYXhTY2FsZTogdG9OdW1iZXIoIHJvb3REYXRhLm1heFNjYWxlLCBkZWZhdWx0cy5tYXhTY2FsZSApLAogICAgICAgICAgICAgICAgbWluU2NhbGU6IHRvTnVtYmVyKCByb290RGF0YS5taW5TY2FsZSwgZGVmYXVsdHMubWluU2NhbGUgKSwgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwZXJzcGVjdGl2ZTogdG9OdW1iZXIoIHJvb3REYXRhLnBlcnNwZWN0aXZlLCBkZWZhdWx0cy5wZXJzcGVjdGl2ZSApLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbkR1cmF0aW9uOiB0b051bWJlciggcm9vdERhdGEudHJhbnNpdGlvbkR1cmF0aW9uLCBkZWZhdWx0cy50cmFuc2l0aW9uRHVyYXRpb24gKQogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93U2NhbGUgPSBjb21wdXRlV2luZG93U2NhbGUoIGNvbmZpZyApOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gd3JhcCBzdGVwcyB3aXRoICJjYW52YXMiIGVsZW1lbnQKICAgICAgICAgICAgYXJyYXlpZnkoIHJvb3QuY2hpbGROb2RlcyApLmZvckVhY2goZnVuY3Rpb24gKCBlbCApIHsKICAgICAgICAgICAgICAgIGNhbnZhcy5hcHBlbmRDaGlsZCggZWwgKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJvb3QuYXBwZW5kQ2hpbGQoY2FudmFzKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIHNldCBpbml0aWFsIHN0eWxlcwogICAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gIjEwMCUiOwogICAgICAgICAgICAKICAgICAgICAgICAgY3NzKGJvZHksIHsKICAgICAgICAgICAgICAgIGhlaWdodDogIjEwMCUiLAogICAgICAgICAgICAgICAgb3ZlcmZsb3c6ICJoaWRkZW4iCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHJvb3RTdHlsZXMgPSB7CiAgICAgICAgICAgICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybU9yaWdpbjogInRvcCBsZWZ0IiwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb246ICJhbGwgMHMgZWFzZS1pbi1vdXQiLAogICAgICAgICAgICAgICAgdHJhbnNmb3JtU3R5bGU6ICJwcmVzZXJ2ZS0zZCIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNzcyhyb290LCByb290U3R5bGVzKTsKICAgICAgICAgICAgY3NzKHJvb3QsIHsKICAgICAgICAgICAgICAgIHRvcDogIjUwJSIsCiAgICAgICAgICAgICAgICBsZWZ0OiAiNTAlIiwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogcGVyc3BlY3RpdmUoIGNvbmZpZy5wZXJzcGVjdGl2ZS93aW5kb3dTY2FsZSApICsgc2NhbGUoIHdpbmRvd1NjYWxlICkKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNzcyhjYW52YXMsIHJvb3RTdHlsZXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgYm9keS5jbGFzc0xpc3QucmVtb3ZlKCJpbXByZXNzLWRpc2FibGVkIik7CiAgICAgICAgICAgIGJvZHkuY2xhc3NMaXN0LmFkZCgiaW1wcmVzcy1lbmFibGVkIik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBnZXQgYW5kIGluaXQgc3RlcHMKICAgICAgICAgICAgc3RlcHMgPSAkJCgiLnN0ZXAiLCByb290KTsKICAgICAgICAgICAgc3RlcHMuZm9yRWFjaCggaW5pdFN0ZXAgKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIHNldCBhIGRlZmF1bHQgaW5pdGlhbCBzdGF0ZSBvZiB0aGUgY2FudmFzCiAgICAgICAgICAgIGN1cnJlbnRTdGF0ZSA9IHsKICAgICAgICAgICAgICAgIHRyYW5zbGF0ZTogeyB4OiAwLCB5OiAwLCB6OiAwIH0sCiAgICAgICAgICAgICAgICByb3RhdGU6ICAgIHsgeDogMCwgeTogMCwgejogMCB9LAogICAgICAgICAgICAgICAgc2NhbGU6ICAgICAxCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICBpbml0aWFsaXplZCA9IHRydWU7CiAgICAgICAgICAgIAogICAgICAgICAgICB0cmlnZ2VyRXZlbnQocm9vdCwgImltcHJlc3M6aW5pdCIsIHsgYXBpOiByb290c1sgImltcHJlc3Mtcm9vdC0iICsgcm9vdElkIF0gfSk7CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICAvLyBgZ2V0U3RlcGAgaXMgYSBoZWxwZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgc3RlcCBlbGVtZW50IGRlZmluZWQgYnkgcGFyYW1ldGVyLgogICAgICAgIC8vIElmIGEgbnVtYmVyIGlzIGdpdmVuLCBzdGVwIHdpdGggaW5kZXggZ2l2ZW4gYnkgdGhlIG51bWJlciBpcyByZXR1cm5lZCwgaWYgYSBzdHJpbmcKICAgICAgICAvLyBpcyBnaXZlbiBzdGVwIGVsZW1lbnQgd2l0aCBzdWNoIGlkIGlzIHJldHVybmVkLCBpZiBET00gZWxlbWVudCBpcyBnaXZlbiBpdCBpcyByZXR1cm5lZAogICAgICAgIC8vIGlmIGl0IGlzIGEgY29ycmVjdCBzdGVwIGVsZW1lbnQuCiAgICAgICAgdmFyIGdldFN0ZXAgPSBmdW5jdGlvbiAoIHN0ZXAgKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RlcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIHN0ZXAgPSBzdGVwIDwgMCA/IHN0ZXBzWyBzdGVwcy5sZW5ndGggKyBzdGVwXSA6IHN0ZXBzWyBzdGVwIF07CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0ZXAgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBzdGVwID0gYnlJZChzdGVwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gKHN0ZXAgJiYgc3RlcC5pZCAmJiBzdGVwc0RhdGFbImltcHJlc3MtIiArIHN0ZXAuaWRdKSA/IHN0ZXAgOiBudWxsOwogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgLy8gdXNlZCB0byByZXNldCB0aW1lb3V0IGZvciBgaW1wcmVzczpzdGVwZW50ZXJgIGV2ZW50CiAgICAgICAgdmFyIHN0ZXBFbnRlclRpbWVvdXQgPSBudWxsOwogICAgICAgIAogICAgICAgIHZhciB0cmFuc2Zvcm1hdGlvbkNhbGxiYWNrID0gbnVsbDsKICAgICAgICB2YXIgc2V0VHJhbnNmb3JtYXRpb25DYWxsYmFjayA9IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgICAgIHRyYW5zZm9ybWF0aW9uQ2FsbGJhY2s9Y2FsbGJhY2s7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIGBnb3RvYCBBUEkgZnVuY3Rpb24gdGhhdCBtb3ZlcyB0byBzdGVwIGdpdmVuIHdpdGggYGVsYCBwYXJhbWV0ZXIgKGJ5IGluZGV4LCBpZCBvciBlbGVtZW50KSwKICAgICAgICAvLyB3aXRoIGEgdHJhbnNpdGlvbiBgZHVyYXRpb25gIG9wdGlvbmFsbHkgZ2l2ZW4gYXMgc2Vjb25kIHBhcmFtZXRlci4KICAgICAgICB2YXIgZ290byA9IGZ1bmN0aW9uICggZWwsIGR1cmF0aW9uICkgewogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCAhaW5pdGlhbGl6ZWQgfHwgIShlbCA9IGdldFN0ZXAoZWwpKSApIHsKICAgICAgICAgICAgICAgIC8vIHByZXNlbnRhdGlvbiBub3QgaW5pdGlhbGl6ZWQgb3IgZ2l2ZW4gZWxlbWVudCBpcyBub3QgYSBzdGVwCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNvbWV0aW1lcyBpdCdzIHBvc3NpYmxlIHRvIHRyaWdnZXIgZm9jdXMgb24gZmlyc3QgbGluayB3aXRoIHNvbWUga2V5Ym9hcmQgYWN0aW9uLgogICAgICAgICAgICAvLyBCcm93c2VyIGluIHN1Y2ggYSBjYXNlIHRyaWVzIHRvIHNjcm9sbCB0aGUgcGFnZSB0byBtYWtlIHRoaXMgZWxlbWVudCB2aXNpYmxlCiAgICAgICAgICAgIC8vIChldmVuIHRoYXQgYm9keSBvdmVyZmxvdyBpcyBzZXQgdG8gaGlkZGVuKSBhbmQgaXQgYnJlYWtzIG91ciBjYXJlZnVsIHBvc2l0aW9uaW5nLgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBTbywgYXMgYSBsb3VzeSAoYW5kIGxhenkpIHdvcmthcm91bmQgd2Ugd2lsbCBtYWtlIHRoZSBwYWdlIHNjcm9sbCBiYWNrIHRvIHRoZSB0b3AKICAgICAgICAgICAgLy8gd2hlbmV2ZXIgc2xpZGUgaXMgc2VsZWN0ZWQKICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gSWYgeW91IGFyZSByZWFkaW5nIHRoaXMgYW5kIGtub3cgYW55IGJldHRlciB3YXkgdG8gaGFuZGxlIGl0LCBJJ2xsIGJlIGdsYWQgdG8gaGVhciBhYm91dCBpdCEKICAgICAgICAgICAgd2luZG93LnNjcm9sbFRvKDAsIDApOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHN0ZXAgPSBzdGVwc0RhdGFbImltcHJlc3MtIiArIGVsLmlkXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICggYWN0aXZlU3RlcCApIHsKICAgICAgICAgICAgICAgIGFjdGl2ZVN0ZXAuY2xhc3NMaXN0LnJlbW92ZSgiYWN0aXZlIik7CiAgICAgICAgICAgICAgICBib2R5LmNsYXNzTGlzdC5yZW1vdmUoImltcHJlc3Mtb24tIiArIGFjdGl2ZVN0ZXAuaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5hZGQoImFjdGl2ZSIpOwogICAgICAgICAgICAKICAgICAgICAgICAgYm9keS5jbGFzc0xpc3QuYWRkKCJpbXByZXNzLW9uLSIgKyBlbC5pZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBjb21wdXRlIHRhcmdldCBzdGF0ZSBvZiB0aGUgY2FudmFzIGJhc2VkIG9uIGdpdmVuIHN0ZXAKICAgICAgICAgICAgdmFyIHRhcmdldCA9IHsKICAgICAgICAgICAgICAgIHJvdGF0ZTogewogICAgICAgICAgICAgICAgICAgIHg6IC1zdGVwLnJvdGF0ZS54LAogICAgICAgICAgICAgICAgICAgIHk6IC1zdGVwLnJvdGF0ZS55LAogICAgICAgICAgICAgICAgICAgIHo6IC1zdGVwLnJvdGF0ZS56CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdHJhbnNsYXRlOiB7CiAgICAgICAgICAgICAgICAgICAgeDogLXN0ZXAudHJhbnNsYXRlLngsCiAgICAgICAgICAgICAgICAgICAgeTogLXN0ZXAudHJhbnNsYXRlLnksCiAgICAgICAgICAgICAgICAgICAgejogLXN0ZXAudHJhbnNsYXRlLnoKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzY2FsZTogMSAvIHN0ZXAuc2NhbGUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKHRyYW5zZm9ybWF0aW9uQ2FsbGJhY2spIHsgCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm1hdGlvbkNhbGxiYWNrKHsKICAgICAgICAgICAgICAgICAgc2NhbGU6c3RlcC5zY2FsZSwKICAgICAgICAgICAgICAgICAgcm90YXRlOnN0ZXAucm90YXRlLAogICAgICAgICAgICAgICAgICB0cmFuc2xhdGU6c3RlcC50cmFuc2xhdGUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgdHJhbnNpdGlvbiBpcyB6b29taW5nIGluIG9yIG5vdC4KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gVGhpcyBpbmZvcm1hdGlvbiBpcyB1c2VkIHRvIGFsdGVyIHRoZSB0cmFuc2l0aW9uIHN0eWxlOgogICAgICAgICAgICAvLyB3aGVuIHdlIGFyZSB6b29taW5nIGluIC0gd2Ugc3RhcnQgd2l0aCBtb3ZlIGFuZCByb3RhdGUgdHJhbnNpdGlvbgogICAgICAgICAgICAvLyBhbmQgdGhlIHNjYWxpbmcgaXMgZGVsYXllZCwgYnV0IHdoZW4gd2UgYXJlIHpvb21pbmcgb3V0IHdlIHN0YXJ0CiAgICAgICAgICAgIC8vIHdpdGggc2NhbGluZyBkb3duIGFuZCBtb3ZlIGFuZCByb3RhdGlvbiBhcmUgZGVsYXllZC4KICAgICAgICAgICAgdmFyIHpvb21pbiA9IHRhcmdldC5zY2FsZSA+PSBjdXJyZW50U3RhdGUuc2NhbGU7CiAgICAgICAgICAgIAogICAgICAgICAgICBkdXJhdGlvbiA9IHRvTnVtYmVyKGR1cmF0aW9uLCBjb25maWcudHJhbnNpdGlvbkR1cmF0aW9uKTsKICAgICAgICAgICAgdmFyIGRlbGF5ID0gKGR1cmF0aW9uIC8gMik7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBpZiB0aGUgc2FtZSBzdGVwIGlzIHJlLXNlbGVjdGVkLCBmb3JjZSBjb21wdXRpbmcgd2luZG93IHNjYWxpbmcsCiAgICAgICAgICAgIC8vIGJlY2F1c2UgaXQgaXMgbGlrZWx5IHRvIGJlIGNhdXNlZCBieSB3aW5kb3cgcmVzaXplCiAgICAgICAgICAgIGlmIChlbCA9PT0gYWN0aXZlU3RlcCkgewogICAgICAgICAgICAgICAgd2luZG93U2NhbGUgPSBjb21wdXRlV2luZG93U2NhbGUoY29uZmlnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHRhcmdldFNjYWxlID0gdGFyZ2V0LnNjYWxlICogd2luZG93U2NhbGU7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyB0cmlnZ2VyIGxlYXZlIG9mIGN1cnJlbnRseSBhY3RpdmUgZWxlbWVudCAoaWYgaXQncyBub3QgdGhlIHNhbWUgc3RlcCBhZ2FpbikKICAgICAgICAgICAgaWYgKGFjdGl2ZVN0ZXAgJiYgYWN0aXZlU3RlcCAhPT0gZWwpIHsKICAgICAgICAgICAgICAgIG9uU3RlcExlYXZlKGFjdGl2ZVN0ZXApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBOb3cgd2UgYWx0ZXIgdHJhbnNmb3JtcyBvZiBgcm9vdGAgYW5kIGBjYW52YXNgIHRvIHRyaWdnZXIgdHJhbnNpdGlvbnMuCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIEFuZCBoZXJlIGlzIHdoeSB0aGVyZSBhcmUgdHdvIGVsZW1lbnRzOiBgcm9vdGAgYW5kIGBjYW52YXNgIC0gdGhleSBhcmUKICAgICAgICAgICAgLy8gYmVpbmcgYW5pbWF0ZWQgc2VwYXJhdGVseToKICAgICAgICAgICAgLy8gYHJvb3RgIGlzIHVzZWQgZm9yIHNjYWxpbmcgYW5kIGBjYW52YXNgIGZvciB0cmFuc2xhdGUgYW5kIHJvdGF0aW9ucy4KICAgICAgICAgICAgLy8gVHJhbnNpdGlvbnMgb24gdGhlbSBhcmUgdHJpZ2dlcmVkIHdpdGggZGlmZmVyZW50IGRlbGF5cyAodG8gbWFrZQogICAgICAgICAgICAvLyB2aXN1YWxseSBuaWNlIGFuZCAnbmF0dXJhbCcgbG9va2luZyB0cmFuc2l0aW9ucyksIHNvIHdlIG5lZWQgdG8ga25vdwogICAgICAgICAgICAvLyB0aGF0IGJvdGggb2YgdGhlbSBhcmUgZmluaXNoZWQuCiAgICAgICAgICAgIGNzcyhyb290LCB7CiAgICAgICAgICAgICAgICAvLyB0byBrZWVwIHRoZSBwZXJzcGVjdGl2ZSBsb29rIHNpbWlsYXIgZm9yIGRpZmZlcmVudCBzY2FsZXMKICAgICAgICAgICAgICAgIC8vIHdlIG5lZWQgdG8gJ3NjYWxlJyB0aGUgcGVyc3BlY3RpdmUsIHRvbwogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiBwZXJzcGVjdGl2ZSggY29uZmlnLnBlcnNwZWN0aXZlIC8gdGFyZ2V0U2NhbGUgKSArIHNjYWxlKCB0YXJnZXRTY2FsZSApLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbkR1cmF0aW9uOiBkdXJhdGlvbiArICJtcyIsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uRGVsYXk6ICh6b29taW4gPyBkZWxheSA6IDApICsgIm1zIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNzcyhjYW52YXMsIHsKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogcm90YXRlKHRhcmdldC5yb3RhdGUsIHRydWUpICsgdHJhbnNsYXRlKHRhcmdldC50cmFuc2xhdGUpLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbkR1cmF0aW9uOiBkdXJhdGlvbiArICJtcyIsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uRGVsYXk6ICh6b29taW4gPyAwIDogZGVsYXkpICsgIm1zIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEhlcmUgaXMgYSB0cmlja3kgcGFydC4uLgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBubyBjaGFuZ2UgaW4gc2NhbGUgb3Igbm8gY2hhbmdlIGluIHJvdGF0aW9uIGFuZCB0cmFuc2xhdGlvbiwgaXQgbWVhbnMgdGhlcmUgd2FzIGFjdHVhbGx5CiAgICAgICAgICAgIC8vIG5vIGRlbGF5IC0gYmVjYXVzZSB0aGVyZSB3YXMgbm8gdHJhbnNpdGlvbiBvbiBgcm9vdGAgb3IgYGNhbnZhc2AgZWxlbWVudHMuCiAgICAgICAgICAgIC8vIFdlIHdhbnQgdG8gdHJpZ2dlciBgaW1wcmVzczpzdGVwZW50ZXJgIGV2ZW50IGluIHRoZSBjb3JyZWN0IG1vbWVudCwgc28gaGVyZSB3ZSBjb21wYXJlIHRoZSBjdXJyZW50CiAgICAgICAgICAgIC8vIGFuZCB0YXJnZXQgdmFsdWVzIHRvIGNoZWNrIGlmIGRlbGF5IHNob3VsZCBiZSB0YWtlbiBpbnRvIGFjY291bnQuCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIEkga25vdyB0aGF0IHRoaXMgYGlmYCBzdGF0ZW1lbnQgbG9va3Mgc2NhcnksIGJ1dCBpdCdzIHByZXR0eSBzaW1wbGUgd2hlbiB5b3Uga25vdyB3aGF0IGlzIGdvaW5nIG9uCiAgICAgICAgICAgIC8vIC0gaXQncyBzaW1wbHkgY29tcGFyaW5nIGFsbCB0aGUgdmFsdWVzLgogICAgICAgICAgICBpZiAoIGN1cnJlbnRTdGF0ZS5zY2FsZSA9PT0gdGFyZ2V0LnNjYWxlIHx8CiAgICAgICAgICAgICAgICAoY3VycmVudFN0YXRlLnJvdGF0ZS54ID09PSB0YXJnZXQucm90YXRlLnggJiYgY3VycmVudFN0YXRlLnJvdGF0ZS55ID09PSB0YXJnZXQucm90YXRlLnkgJiYKICAgICAgICAgICAgICAgICBjdXJyZW50U3RhdGUucm90YXRlLnogPT09IHRhcmdldC5yb3RhdGUueiAmJiBjdXJyZW50U3RhdGUudHJhbnNsYXRlLnggPT09IHRhcmdldC50cmFuc2xhdGUueCAmJgogICAgICAgICAgICAgICAgIGN1cnJlbnRTdGF0ZS50cmFuc2xhdGUueSA9PT0gdGFyZ2V0LnRyYW5zbGF0ZS55ICYmIGN1cnJlbnRTdGF0ZS50cmFuc2xhdGUueiA9PT0gdGFyZ2V0LnRyYW5zbGF0ZS56KSApIHsKICAgICAgICAgICAgICAgIGRlbGF5ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gc3RvcmUgY3VycmVudCBzdGF0ZQogICAgICAgICAgICBjdXJyZW50U3RhdGUgPSB0YXJnZXQ7CiAgICAgICAgICAgIGFjdGl2ZVN0ZXAgPSBlbDsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFuZCBoZXJlIGlzIHdoZXJlIHdlIHRyaWdnZXIgYGltcHJlc3M6c3RlcGVudGVyYCBldmVudC4KICAgICAgICAgICAgLy8gV2Ugc2ltcGx5IHNldCB1cCBhIHRpbWVvdXQgdG8gZmlyZSBpdCB0YWtpbmcgdHJhbnNpdGlvbiBkdXJhdGlvbiAoYW5kIHBvc3NpYmxlIGRlbGF5KSBpbnRvIGFjY291bnQuCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIEkgcmVhbGx5IHdhbnRlZCB0byBtYWtlIGl0IGluIG1vcmUgZWxlZ2FudCB3YXkuIFRoZSBgdHJhbnNpdGlvbmVuZGAgZXZlbnQgc2VlbWVkIHRvIGJlIHRoZSBiZXN0IHdheQogICAgICAgICAgICAvLyB0byBkbyBpdCwgYnV0IHRoZSBmYWN0IHRoYXQgSSdtIHVzaW5nIHRyYW5zaXRpb25zIG9uIHR3byBzZXBhcmF0ZSBlbGVtZW50cyBhbmQgdGhhdCB0aGUgYHRyYW5zaXRpb25lbmRgCiAgICAgICAgICAgIC8vIGV2ZW50IGlzIG9ubHkgdHJpZ2dlcmVkIHdoZW4gdGhlcmUgd2FzIGEgdHJhbnNpdGlvbiAoY2hhbmdlIGluIHRoZSB2YWx1ZXMpIGNhdXNlZCBzb21lIGJ1Z3MgYW5kIAogICAgICAgICAgICAvLyBtYWRlIHRoZSBjb2RlIHJlYWxseSBjb21wbGljYXRlZCwgY2F1c2UgSSBoYWQgdG8gaGFuZGxlIGFsbCB0aGUgY29uZGl0aW9ucyBzZXBhcmF0ZWx5LiBBbmQgaXQgc3RpbGwKICAgICAgICAgICAgLy8gbmVlZGVkIGEgYHNldFRpbWVvdXRgIGZhbGxiYWNrIGZvciB0aGUgc2l0dWF0aW9ucyB3aGVuIHRoZXJlIGlzIG5vIHRyYW5zaXRpb24gYXQgYWxsLgogICAgICAgICAgICAvLyBTbyBJIGRlY2lkZWQgdGhhdCBJJ2QgcmF0aGVyIG1ha2UgdGhlIGNvZGUgc2ltcGxlciB0aGFuIHVzZSBzaGlueSBuZXcgYHRyYW5zaXRpb25lbmRgLgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBJZiB5b3Ugd2FudCBsZWFybiBzb21ldGhpbmcgaW50ZXJlc3RpbmcgYW5kIHNlZSBob3cgaXQgd2FzIGRvbmUgd2l0aCBgdHJhbnNpdGlvbmVuZGAgZ28gYmFjayB0bwogICAgICAgICAgICAvLyB2ZXJzaW9uIDAuNS4yIG9mIGltcHJlc3MuanM6IGh0dHA6Ly9naXRodWIuY29tL2JhcnRhei9pbXByZXNzLmpzL2Jsb2IvMC41LjIvanMvaW1wcmVzcy5qcwogICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHN0ZXBFbnRlclRpbWVvdXQpOwogICAgICAgICAgICBzdGVwRW50ZXJUaW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBvblN0ZXBFbnRlcihhY3RpdmVTdGVwKTsKICAgICAgICAgICAgfSwgZHVyYXRpb24gKyBkZWxheSk7CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gZWw7CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICAvLyBgcHJldmAgQVBJIGZ1bmN0aW9uIGdvZXMgdG8gcHJldmlvdXMgc3RlcCAoaW4gZG9jdW1lbnQgb3JkZXIpCiAgICAgICAgdmFyIF9wcmV2ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgcHJldiA9IHN0ZXBzLmluZGV4T2YoIGFjdGl2ZVN0ZXAgKSAtIDE7CiAgICAgICAgICAgIHByZXYgPSBwcmV2ID49IDAgPyBzdGVwc1sgcHJldiBdIDogc3RlcHNbIHN0ZXBzLmxlbmd0aC0xIF07CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gZ290byhwcmV2KTsKICAgICAgICB9OwogICAgICAgIAogICAgICAgIC8vIGBuZXh0YCBBUEkgZnVuY3Rpb24gZ29lcyB0byBuZXh0IHN0ZXAgKGluIGRvY3VtZW50IG9yZGVyKQogICAgICAgIHZhciBfbmV4dCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG5leHQgPSBzdGVwcy5pbmRleE9mKCBhY3RpdmVTdGVwICkgKyAxOwogICAgICAgICAgICBuZXh0ID0gbmV4dCA8IHN0ZXBzLmxlbmd0aCA/IHN0ZXBzWyBuZXh0IF0gOiBzdGVwc1sgMCBdOwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGdvdG8obmV4dCk7CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICAKIC8vUEFUQ0ggZm9yIE1lbnUKIAogICAgICAgICAvLyBDYXBpdGFsaXplIGZpcnN0IGxldHRlciBvZiBzdHJpbmcKICAgICAgICB2YXIgY2FwaXRhbGl6ZSA9IGZ1bmN0aW9uKCBzdHIgKSB7CiAgICAgICAgICAgIHJldHVybiBzdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc2xpY2UoMSk7CiAgICAgICAgfTsKCiAgICAKICAgICAgICAvLyBJdCBkZWZpbmVzIHRoZSBuYW1lcyBvZiBlYWNoIGVudHJ5IGJ5IHRoZSBpZCBjYXBpdGFsaXplZC4KICAgICAgICB2YXIgc2hvd01lbnUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBtZW51IHdyYXBwZXIgYW5kIHRoZSBlbGVtZW50IHRoYXQgd2lsbCBiZSBjbG9uZWQKICAgICAgICAgICAgLy8gZm9yIGVhY2ggZW50cnkuCiAgICAgICAgICAvLyAgY29uc29sZS5sb2coJ3Nob3dNZW51JykKICAgICAgICAgICAgdmFyIG1lbnUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSwKICAgICAgICAgICAgICAgIGZyYWcgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgICAgICAgICBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKICAgICAgICAgICAgLy8gQXBwbHkgc29tZSBjbGFzc2VzCiAgICAgICAgICAgIG1lbnUuY2xhc3NOYW1lID0gJ21lbnUnOwogICAgICAgICAgICBlbC5jbGFzc05hbWUgPSAnbWVudS1pdGVtJzsKCiAgICAgICAgICAgIC8vIENyZWF0ZSBhbiBlbGVtZW50IHRoYXQgd2lsbCBiZSB0aGUgImJ1dHRvbiIgYW5kIGFwcGVuZCBpdAogICAgICAgICAgICAvLyB0byB0aGUgbWVudQogICAgICAgICAgICB2YXIgYnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIGJ1dHRvbi5jbGFzc05hbWUgPSAnbWVudS1idXR0b24nOwogICAgICAgICAgICBidXR0b24udGV4dENvbnRlbnQgPSAnJzsKICAgICAgICAgICAgbWVudS5hcHBlbmRDaGlsZChidXR0b24pOwoKICAgICAgICAgICAgLy8gTm93LCBmb3IgZWFjaCBkaXYgaW4gdGhlIGZpcnN0IGVsZW1lbnQgY2hpbGQgb2YgICNpbXByZXNzLAogICAgICAgICAgICAvLyBhZGQgYW4gZW50cnkgdG8gdGhlIG1lbnUgICAgICAgICAKICAgICAgICAgICAgICBhcnJheWlmeShieUlkKCdpbXByZXNzJykuZmlyc3RFbGVtZW50Q2hpbGQuY2hpbGRyZW4pLmZvckVhY2goCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oIGNoaWxkLCBpbmRleCApIHsKICAgICAgICAgICAgICAgICAgICAJCiAgICAgICAgICAgICAgICBpZiAoIWNoaWxkLmNsYXNzTGlzdC5jb250YWlucygnc3RlcCcpKSByZXR1cm47CgogICAgICAgICAgICAgICAgdmFyIG5ld0VsID0gZWwuY2xvbmVOb2RlKCksCiAgICAgICAgICAgICAgICAgICAgaSA9IGluZGV4ICsgMSwgLy8gV2UgZG9uJ3Qgd2FudCB0byBzdGFydCBhdCAwCiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IGkgKyAnLiAnICsgY2FwaXRhbGl6ZShjaGlsZC5pZCk7CgogICAgICAgICAgICAgICAgLy8gU2V0IHRoZSB0ZXh0IG9mIHRoZSBuZXcgZWxlbWVudAogICAgICAgICAgICAgICAgbmV3RWwuaW5uZXJIVE1MID0gJzxhIGhyZWY9IiMvJytjaGlsZC5pZCsnIiB0aXRsZT0iJyt0ZXh0KyciPiZidWxsOzwvYT4nOwogICAgICAgICAgICAgICAgbmV3RWwuaWQgPSAibS0iICsgY2hpbGQuaWQ7CgogICAgICAgICAgICAgICAgLy8gQWRkIGFuIG9uY2xpY2sgZXZlbnQgdG8gdGhlIG5ldyBlbGVtZW50CiAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIHVzZSBhIGNsb3N1cmUgdG8gbWFrZSBzdXJlIHRoZSBpbmRleCBpcyBjb3JyZWN0CiAgICAgICAgICAgICAgICAoZnVuY3Rpb24oIGluZGV4LCBpZCApIHsKICAgICAgICAgICAgICAgICAgICBuZXdFbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBnb3RvKGluZGV4KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBuZXdFbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW92ZXInLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAJdmFyIGJhc2VVUkwgPSBkb2N1bWVudC5VUkwuc3Vic3RyaW5nKDAsIGRvY3VtZW50LlVSTC5zZWFyY2goJyMvJykpOwogICAgICAgICAgICAgICAgICAgICAgICBidXR0b24uaW5uZXJIVE1MID0gJzxpZnJhbWUgc3JjPSInK2Jhc2VVUkwrIj9wcmV2aWV3Iy8iK2lkKyciPic7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgbmV3RWwuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VvdXQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uLmlubmVySFRNTCA9ICIiOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSggaW5kZXgsIGNoaWxkLmlkICkpOwoKICAgICAgICAgICAgICAgIC8vIEFuZCBhcHBlbmQgdGhlIG5ldyBlbGVtZW50IHRvIHRoZSBtZW51CiAgICAgICAgICAgICAgICBmcmFnLmFwcGVuZENoaWxkKG5ld0VsKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBBZGQgdGhlIGZyYWcgdG8gdGhlIG1lbnUKICAgICAgICAgICAgbWVudS5hcHBlbmRDaGlsZChmcmFnKTsKCiAgICAgICAgICAgIC8vIEFuZCBhcHBlbmQgdGhlIG1lbnUgdG8gdGhlIGJvZHkuCiAgICAgICAgICAgIC8vIEFwcGVuZGluZyBpdCB0byAjaW1wcmVzcyB3b3VsZCBtZXNzIHRoaW5ncyB1cCwgc2luY2UKICAgICAgICAgICAgLy8gYHBvc2l0aW9uOiBhYnNvbHV0ZWAgd291bGRuJ3Qgd29yayBhbnltb3JlIGluIGl0LgogICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG1lbnUpOwogICAgICAgIH07CiAKIC8vRU5EIFBBVENICiAgICAgICAgCiAvL1BBVENIIGZvciBTVUJTVEVQUwogCXZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2gsCiAgICAgICAgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UsCiAgICAgICAgaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7CiAgICAgICAgCiAgICB2YXIgcmVtb3ZlQ2xhc3MgPSBmdW5jdGlvbiAoZWxtLCBjbGFzc05hbWUpIHsKICAgIGlmIChlbG0uY2xhc3NMaXN0KSB7CiAgICAgICAgICAgIGVsbS5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7CiAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoIWVsbSB8fCAhZWxtLmNsYXNzTmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZWdleHAgPSBuZXcgUmVnRXhwKCIoXnxcXHMpIiArIGNsYXNzTmFtZSArICIoXFxzfCQpIiwgImciKTsKICAgICAgICAgICAgZWxtLmNsYXNzTmFtZSA9IGVsbS5jbGFzc05hbWUucmVwbGFjZShyZWdleHAsICIkMiIpOwogICAgfQoJfQogICAgCiAKICAgIHZhciBzZXRQcmV2aW91cyA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgaWYgKGlzQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgZGF0YS5mb3JFYWNoKHNldFByZXZpb3VzKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvL3JlbW92ZUNsYXNzKGRhdGEsJ2FjdGl2ZScpOwogICAgICAgIC8vZGF0YS5jbGFzc05hbWUgPSBkYXRhLmNsYXNzTmFtZSArICcgcHJldmlvdXMnOwogICAgICAgIGRhdGEuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgZGF0YS5jbGFzc0xpc3QuYWRkKCdwcmV2aW91cycpOwogICAgfTsKCiAgICB2YXIgc2V0QWN0aXZlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBpZiAoaXNBcnJheShkYXRhKSkgewogICAgICAgICAgICBkYXRhLmZvckVhY2goc2V0QWN0aXZlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAvL3JlbW92ZUNsYXNzKGRhdGEsJ3ByZXZpb3VzJyk7CiAgICAgICAgLy9kYXRhLmNsYXNzTmFtZSA9IGRhdGEuY2xhc3NOYW1lICsgJyBhY3RpdmUnOwogICAgICAgIGRhdGEuY2xhc3NMaXN0LnJlbW92ZSgncHJldmlvdXMnKTsKICAgICAgICBkYXRhLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgfTsKCiAgICB2YXIgY2xlYXJTdWIgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGlmIChpc0FycmF5KGRhdGEpKSB7CiAgICAgICAgICAgIGRhdGEuZm9yRWFjaChjbGVhclN1Yik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy9yZW1vdmVDbGFzcyhkYXRhLCdwcmV2aW91cycpOwogICAgICAgIC8vcmVtb3ZlQ2xhc3MoZGF0YSwnYWN0aXZlJyk7CiAgICAgICAgZGF0YS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICBkYXRhLmNsYXNzTGlzdC5yZW1vdmUoJ3ByZXZpb3VzJyk7CiAgICB9OwogCiAJdmFyIG5leHQgPSBmdW5jdGlvbiAoKSB7CiAJCXZhciBhY3RpdmUgPSBhY3RpdmVTdGVwOwogCQkKICAgICAgICB2YXIgc3ViYWN0aXZlLCBuZXh0LCBzdWJTdGVwczsKICAgICAgICAKICAgICAgICBpZiAoIWFjdGl2ZS5zdWJTdGVwcykgewogICAgICAgICAgICBzZXRTdWJTdGVwcyhhY3RpdmUpOwogICAgICAgIH0KICAgICAgICBzdWJTdGVwcyA9IGFjdGl2ZS5zdWJTdGVwczsKICAgICAgICBpZiAoc3ViU3RlcHMubGVuZ3RoICYmICgoc3ViYWN0aXZlID0gc3ViU3RlcHMuYWN0aXZlKSAhPT0gKHN1YlN0ZXBzLmxlbmd0aCAtIDEpKSkgewogICAgICAgICAgICBpZiAoc3ViYWN0aXZlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNldFByZXZpb3VzKHN1YlN0ZXBzW3N1YmFjdGl2ZV0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3ViYWN0aXZlID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0QWN0aXZlKHN1YlN0ZXBzWysrc3ViYWN0aXZlXSk7CiAgICAgICAgICAgIHN1YlN0ZXBzLmFjdGl2ZSA9IHN1YmFjdGl2ZTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBuZXh0ID0gc3RlcHMuaW5kZXhPZiggYWN0aXZlICkgKyAxOwogICAgICAgIG5leHQgPSBuZXh0IDwgc3RlcHMubGVuZ3RoID8gc3RlcHNbIG5leHQgXSA6IHN0ZXBzWyAwIF07CiAgICAgICAgaWYgKCFuZXh0LnN1YlN0ZXBzKSB7CiAgICAgICAgICAgIHNldFN1YlN0ZXBzKG5leHQpOwogICAgICAgIH0KICAgICAgICBpZiAobmV4dC5zdWJTdGVwcy5hY3RpdmUgIT0gbnVsbCkgewogICAgICAgICAgICBmb3JFYWNoLmNhbGwobmV4dC5zdWJTdGVwcywgY2xlYXJTdWIpOwogICAgICAgICAgICBuZXh0LnN1YlN0ZXBzLmFjdGl2ZSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnb3RvKG5leHQpOwogICAgfTsKIAogCXZhciBwcmV2ID0gZnVuY3Rpb24gKCkgewogCQl2YXIgYWN0aXZlID0gYWN0aXZlU3RlcDsKIAkJCiAgICAgICAgdmFyIHN1YmFjdGl2ZSwgbmV4dCwgc3ViU3RlcHM7CiAgICAgICAgaWYgKCFhY3RpdmUuc3ViU3RlcHMpIHsKICAgICAgICAgICAgc2V0U3ViU3RlcHMoYWN0aXZlKTsKICAgICAgICB9CiAgICAgICAgc3ViU3RlcHMgPSBhY3RpdmUuc3ViU3RlcHM7CiAgICAgICAgaWYgKHN1YlN0ZXBzLmxlbmd0aCAmJiAoKHN1YmFjdGl2ZSA9IHN1YlN0ZXBzLmFjdGl2ZSkgfHwgKHN1YmFjdGl2ZSA9PT0gMCkpKSB7CiAgICAgICAgICAgIGNsZWFyU3ViKHN1YlN0ZXBzW3N1YmFjdGl2ZV0pOwogICAgICAgICAgICBpZiAoc3ViYWN0aXZlKSB7CiAgICAgICAgICAgICAgICBzZXRBY3RpdmUoc3ViU3RlcHNbLS1zdWJhY3RpdmVdKTsKICAgICAgICAgICAgICAgIHN1YlN0ZXBzLmFjdGl2ZSA9IHN1YmFjdGl2ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN1YlN0ZXBzLmFjdGl2ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBuZXh0ID0gc3RlcHMuaW5kZXhPZiggYWN0aXZlICkgLSAxOwogICAgICAgIG5leHQgPSBuZXh0ID49IDAgPyBzdGVwc1sgbmV4dCBdIDogc3RlcHNbIHN0ZXBzLmxlbmd0aC0xIF07CiAgICAgICAgaWYgKCFuZXh0LnN1YlN0ZXBzKSB7CiAgICAgICAgICAgIHNldFN1YlN0ZXBzKG5leHQpOwogICAgICAgIH0KICAgICAgICBpZiAobmV4dC5zdWJTdGVwcy5sZW5ndGggJiYKICAgICAgICAgICAgKG5leHQuc3ViU3RlcHMuYWN0aXZlICE9PSAobmV4dC5zdWJTdGVwcy5sZW5ndGggLSAxKSkpIHsKICAgICAgICAgICAgc2xpY2UuY2FsbChuZXh0LnN1YlN0ZXBzLCAwLCAtMSkuZm9yRWFjaChzZXRQcmV2aW91cyk7CiAgICAgICAgICAgIHNldEFjdGl2ZShuZXh0LnN1YlN0ZXBzW25leHQuc3ViU3RlcHMubGVuZ3RoIC0gMV0pOwogICAgICAgICAgICBuZXh0LnN1YlN0ZXBzLmFjdGl2ZSA9IG5leHQuc3ViU3RlcHMubGVuZ3RoIC0gMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGdvdG8obmV4dCk7CiAgICB9OwogCgkgdmFyIHNldFN1YlN0ZXBzID0gZnVuY3Rpb24gKGVsKSB7CiAgICAgICAgdmFyIHN0ZXBzID0gZWwucXVlcnlTZWxlY3RvckFsbCgiLnN1YnN0ZXAiKSwKICAgICAgICBvcmRlciA9IFtdLCB1bm9yZGVyZWQgPSBbXTsKICAgICAgICBmb3JFYWNoLmNhbGwoc3RlcHMsIGZ1bmN0aW9uIChlbCkgewogICAgICAgIAlpZiAoZWwuZGF0YXNldCkgewogICAgICAgICAgICB2YXIgaW5kZXggPSBOdW1iZXIoZWwuZGF0YXNldC5vcmRlcik7CiAgICAgICAgICAgIGlmICghaXNOYU4oaW5kZXgpKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9yZGVyW2luZGV4XSkgewogICAgICAgICAgICAgICAgICAgIG9yZGVyW2luZGV4XSA9IGVsOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KG9yZGVyW2luZGV4XSkpIHsKICAgICAgICAgICAgICAgICAgICBvcmRlcltpbmRleF0ucHVzaChlbCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG9yZGVyW2luZGV4XSA9IFtvcmRlcltpbmRleF0sIGVsXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVub3JkZXJlZC5wdXNoKGVsKTsKICAgICAgICAgICAgfSB9IGVsc2UgewogICAgICAgICAgICAJdW5vcmRlcmVkLnB1c2goZWwpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgZWwuc3ViU3RlcHMgPSBvcmRlci5maWx0ZXIoQm9vbGVhbikuY29uY2F0KHVub3JkZXJlZCk7CiAgICB9OwogCiAvL0VORCBQQVRDSCAgICAgICAKICAgICAgICAKICAgICAgICAvLyBBZGRpbmcgc29tZSB1c2VmdWwgY2xhc3NlcyB0byBzdGVwIGVsZW1lbnRzLgogICAgICAgIC8vCiAgICAgICAgLy8gQWxsIHRoZSBzdGVwcyB0aGF0IGhhdmUgbm90IGJlZW4gc2hvd24geWV0IGFyZSBnaXZlbiBgZnV0dXJlYCBjbGFzcy4KICAgICAgICAvLyBXaGVuIHRoZSBzdGVwIGlzIGVudGVyZWQgdGhlIGBmdXR1cmVgIGNsYXNzIGlzIHJlbW92ZWQgYW5kIHRoZSBgcHJlc2VudGAKICAgICAgICAvLyBjbGFzcyBpcyBnaXZlbi4gV2hlbiB0aGUgc3RlcCBpcyBsZWZ0IGBwcmVzZW50YCBjbGFzcyBpcyByZXBsYWNlZCB3aXRoCiAgICAgICAgLy8gYHBhc3RgIGNsYXNzLgogICAgICAgIC8vCiAgICAgICAgLy8gU28gZXZlcnkgc3RlcCBlbGVtZW50IGlzIGFsd2F5cyBpbiBvbmUgb2YgdGhyZWUgcG9zc2libGUgc3RhdGVzOgogICAgICAgIC8vIGBmdXR1cmVgLCBgcHJlc2VudGAgYW5kIGBwYXN0YC4KICAgICAgICAvLwogICAgICAgIC8vIFRoZXJlIGNsYXNzZXMgY2FuIGJlIHVzZWQgaW4gQ1NTIHRvIHN0eWxlIGRpZmZlcmVudCB0eXBlcyBvZiBzdGVwcy4KICAgICAgICAvLyBGb3IgZXhhbXBsZSB0aGUgYHByZXNlbnRgIGNsYXNzIGNhbiBiZSB1c2VkIHRvIHRyaWdnZXIgc29tZSBjdXN0b20KICAgICAgICAvLyBhbmltYXRpb25zIHdoZW4gc3RlcCBpcyBzaG93bi4KICAgICAgICByb290LmFkZEV2ZW50TGlzdGVuZXIoImltcHJlc3M6aW5pdCIsIGZ1bmN0aW9uKCl7CiAgICAgICAgCQogICAgICAgIAl2YXIgX2FkZCA9IGZ1bmN0aW9uKGRvbSwgYykgewogICAgICAgIAkJZG9tLmNsYXNzTGlzdC5hZGQoYyk7CiAgICAgICAgCQl2YXIgbV9kb20gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibS0iK2RvbS5pZCk7CiAgICAgICAgCQlpZiAobV9kb20pIG1fZG9tLmNsYXNzTGlzdC5hZGQoYyk7CiAgICAgICAgCX0KICAgICAgICAJCiAgICAgICAgCXZhciBfcmVtb3ZlID0gZnVuY3Rpb24oZG9tLCBjKSB7CiAgICAgICAgCQlkb20uY2xhc3NMaXN0LnJlbW92ZShjKTsKICAgICAgICAJCXZhciBtX2RvbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJtLSIrZG9tLmlkKTsKICAgICAgICAJCWlmIChtX2RvbSkgbV9kb20uY2xhc3NMaXN0LnJlbW92ZShjKTsgICAgICAgIAkJCiAgICAgICAgCX0KICAgICAgICAJCiAgICAgICAgICAgIC8vIFNURVAgQ0xBU1NFUwogICAgICAgICAgICBzdGVwcy5mb3JFYWNoKGZ1bmN0aW9uIChzdGVwKSB7CiAgICAgICAgICAgIAlfYWRkKHN0ZXAsImZ1dHVyZSIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJvb3QuYWRkRXZlbnRMaXN0ZW5lcigiaW1wcmVzczpzdGVwZW50ZXIiLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgCV9hZGQoZXZlbnQudGFyZ2V0LCJwcmVzZW50Iik7CiAgICAgICAgICAgIAlfcmVtb3ZlKGV2ZW50LnRhcmdldCwicGFzdCIpOwogICAgICAgICAgICAJX3JlbW92ZShldmVudC50YXJnZXQsImZ1dHVyZSIpOwovLyAgICAgICAgICAgICAgICBldmVudC50YXJnZXQuY2xhc3NMaXN0LnJlbW92ZSgicGFzdCIpOwogLy8gICAgICAgICAgICAgICBldmVudC50YXJnZXQuY2xhc3NMaXN0LnJlbW92ZSgiZnV0dXJlIik7CiAvLyAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5jbGFzc0xpc3QuYWRkKCJwcmVzZW50Iik7CiAgICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJvb3QuYWRkRXZlbnRMaXN0ZW5lcigiaW1wcmVzczpzdGVwbGVhdmUiLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgCV9yZW1vdmUoZXZlbnQudGFyZ2V0LCJwcmVzZW50Iik7CiAgICAgICAgICAgIAlfYWRkKGV2ZW50LnRhcmdldCwicGFzdCIpOyAgICAgICAgICAJCi8vICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5jbGFzc0xpc3QucmVtb3ZlKCJwcmVzZW50Iik7Ci8vICAgICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5jbGFzc0xpc3QuYWRkKCJwYXN0Iik7CiAgICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAgICAgCiAgICAgICAgfSwgZmFsc2UpOwogICAgICAgIAogICAgICAgIC8vIEFkZGluZyBoYXNoIGNoYW5nZSBzdXBwb3J0LgogICAgICAgIHJvb3QuYWRkRXZlbnRMaXN0ZW5lcigiaW1wcmVzczppbml0IiwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIGxhc3QgaGFzaCBkZXRlY3RlZAogICAgICAgICAgICB2YXIgbGFzdEhhc2ggPSAiIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIGAjL3N0ZXAtaWRgIGlzIHVzZWQgaW5zdGVhZCBvZiBgI3N0ZXAtaWRgIHRvIHByZXZlbnQgZGVmYXVsdCBicm93c2VyCiAgICAgICAgICAgIC8vIHNjcm9sbGluZyB0byBlbGVtZW50IGluIGhhc2guCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIEFuZCBpdCBoYXMgdG8gYmUgc2V0IGFmdGVyIGFuaW1hdGlvbiBmaW5pc2hlcywgYmVjYXVzZSBpbiBDaHJvbWUgaXQKICAgICAgICAgICAgLy8gbWFrZXMgdHJhbnN0aW9uIGxhZ2d5LgogICAgICAgICAgICAvLyBCVUc6IGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTYyODIwCiAgICAgICAgICAgIHJvb3QuYWRkRXZlbnRMaXN0ZW5lcigiaW1wcmVzczpzdGVwZW50ZXIiLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gbGFzdEhhc2ggPSAiIy8iICsgZXZlbnQudGFyZ2V0LmlkOwogICAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIC8vIFdoZW4gdGhlIHN0ZXAgaXMgZW50ZXJlZCBoYXNoIGluIHRoZSBsb2NhdGlvbiBpcyB1cGRhdGVkCiAgICAgICAgICAgICAgICAvLyAoanVzdCBmZXcgbGluZXMgYWJvdmUgZnJvbSBoZXJlKSwgc28gdGhlIGhhc2ggY2hhbmdlIGlzIAogICAgICAgICAgICAgICAgLy8gdHJpZ2dlcmVkIGFuZCB3ZSB3b3VsZCBjYWxsIGBnb3RvYCBhZ2FpbiBvbiB0aGUgc2FtZSBlbGVtZW50LgogICAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAgIC8vIFRvIGF2b2lkIHRoaXMgd2Ugc3RvcmUgbGFzdCBlbnRlcmVkIGhhc2ggYW5kIGNvbXBhcmUuCiAgICAgICAgICAgICAgICBpZiAod2luZG93LmxvY2F0aW9uLmhhc2ggIT09IGxhc3RIYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgZ290byggZ2V0RWxlbWVudEZyb21IYXNoKCkgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU1RBUlQgCiAgICAgICAgICAgIC8vIGJ5IHNlbGVjdGluZyBzdGVwIGRlZmluZWQgaW4gdXJsIG9yIGZpcnN0IHN0ZXAgb2YgdGhlIHByZXNlbnRhdGlvbgogICAgICAgICAgICBnb3RvKGdldEVsZW1lbnRGcm9tSGFzaCgpIHx8IHN0ZXBzWzBdLCAwKTsKICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgCiAgICAgICAgYm9keS5jbGFzc0xpc3QuYWRkKCJpbXByZXNzLWRpc2FibGVkIik7CiAgICAgICAgCiAgICAgICAgLy8gc3RvcmUgYW5kIHJldHVybiBBUEkgZm9yIGdpdmVuIGltcHJlc3MuanMgcm9vdCBlbGVtZW50CiAgICAgICAgcmV0dXJuIChyb290c1sgImltcHJlc3Mtcm9vdC0iICsgcm9vdElkIF0gPSB7CiAgICAgICAgICAgIGluaXQ6IGluaXQsCiAgICAgICAgICAgIGdvdG86IGdvdG8sCiAgICAgICAgICAgIG5leHQ6IG5leHQsCiAgICAgICAgICAgIHByZXY6IHByZXYsCiAgICAgICAgICAgIGluaXRTdGVwOiBpbml0U3RlcCwKICAgICAgICAgICAgbmV3U3RlcDpuZXdTdGVwLAogICAgICAgICAgICBzZXRUcmFuc2Zvcm1hdGlvbkNhbGxiYWNrOnNldFRyYW5zZm9ybWF0aW9uQ2FsbGJhY2ssCiAgICAgICAgICAgIHNob3dNZW51OiBzaG93TWVudQogICAgICAgIH0pOwoKICAgIH07CiAgICAKICAgIC8vIGZsYWcgdGhhdCBjYW4gYmUgdXNlZCBpbiBKUyB0byBjaGVjayBpZiBicm93c2VyIGhhdmUgcGFzc2VkIHRoZSBzdXBwb3J0IHRlc3QKICAgIGltcHJlc3Muc3VwcG9ydGVkID0gaW1wcmVzc1N1cHBvcnRlZDsKICAgIAp9KShkb2N1bWVudCwgd2luZG93KTsKCi8vIE5BVklHQVRJT04gRVZFTlRTCgovLyBBcyB5b3UgY2FuIHNlZSB0aGlzIHBhcnQgaXMgc2VwYXJhdGUgZnJvbSB0aGUgaW1wcmVzcy5qcyBjb3JlIGNvZGUuCi8vIEl0J3MgYmVjYXVzZSB0aGVzZSBuYXZpZ2F0aW9uIGFjdGlvbnMgb25seSBuZWVkIHdoYXQgaW1wcmVzcy5qcyBwcm92aWRlcyB3aXRoCi8vIGl0cyBzaW1wbGUgQVBJLgovLwovLyBJbiBmdXR1cmUgSSB0aGluayBhYm91dCBtb3ZpbmcgaXQgdG8gbWFrZSB0aGVtIG9wdGlvbmFsLCBtb3ZlIHRvIHNlcGFyYXRlIGZpbGVzCi8vIGFuZCB0cmVhdCBtb3JlIGxpa2UgYSAncGx1Z2lucycuCihmdW5jdGlvbiAoIGRvY3VtZW50LCB3aW5kb3cgKSB7CiAgICAndXNlIHN0cmljdCc7CiAgICAKICAgIC8vIHRocm90dGxpbmcgZnVuY3Rpb24gY2FsbHMsIGJ5IFJlbXkgU2hhcnAKICAgIC8vIGh0dHA6Ly9yZW15c2hhcnAuY29tLzIwMTAvMDcvMjEvdGhyb3R0bGluZy1mdW5jdGlvbi1jYWxscy8KICAgIHZhciB0aHJvdHRsZSA9IGZ1bmN0aW9uIChmbiwgZGVsYXkpIHsKICAgICAgICB2YXIgdGltZXIgPSBudWxsOwogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdGhpcywgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKICAgICAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGZuLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICB9LCBkZWxheSk7CiAgICAgICAgfTsKICAgIH07CiAgICAKICAgIC8vIHdhaXQgZm9yIGltcHJlc3MuanMgdG8gYmUgaW5pdGlhbGl6ZWQKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImltcHJlc3M6aW5pdCIsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIC8vIEdldHRpbmcgQVBJIGZyb20gZXZlbnQgZGF0YS4KICAgICAgICAvLyBTbyB5b3UgZG9uJ3QgZXZlbnQgbmVlZCB0byBrbm93IHdoYXQgaXMgdGhlIGlkIG9mIHRoZSByb290IGVsZW1lbnQKICAgICAgICAvLyBvciBhbnl0aGluZy4gYGltcHJlc3M6aW5pdGAgZXZlbnQgZGF0YSBnaXZlcyB5b3UgZXZlcnl0aGluZyB5b3UgCiAgICAgICAgLy8gbmVlZCB0byBjb250cm9sIHRoZSBwcmVzZW50YXRpb24gdGhhdCB3YXMganVzdCBpbml0aWFsaXplZC4KICAgICAgICB2YXIgYXBpID0gZXZlbnQuZGV0YWlsLmFwaTsKICAgICAgICAKICAgICAgICAvLyBLRVlCT0FSRCBOQVZJR0FUSU9OIEhBTkRMRVJTCiAgICAgICAgCiAgICAgICAgLy8gUHJldmVudCBkZWZhdWx0IGtleWRvd24gYWN0aW9uIHdoZW4gb25lIG9mIHN1cHBvcnRlZCBrZXkgaXMgcHJlc3NlZC4KICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgZnVuY3Rpb24gKCBldmVudCApIHsKICAgICAgICAgICAgaWYgKCBldmVudC5rZXlDb2RlID09PSA5IHx8ICggZXZlbnQua2V5Q29kZSA+PSAzMiAmJiBldmVudC5rZXlDb2RlIDw9IDM0ICkgfHwgKGV2ZW50LmtleUNvZGUgPj0gMzcgJiYgZXZlbnQua2V5Q29kZSA8PSA0MCkgKSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwgZmFsc2UpOwogICAgICAgIAogICAgICAgIC8vIFRyaWdnZXIgaW1wcmVzcyBhY3Rpb24gKG5leHQgb3IgcHJldikgb24ga2V5dXAuCiAgICAgICAgCiAgICAgICAgLy8gU3VwcG9ydGVkIGtleXMgYXJlOgogICAgICAgIC8vIFtzcGFjZV0gLSBxdWl0ZSBjb21tb24gaW4gcHJlc2VudGF0aW9uIHNvZnR3YXJlIHRvIG1vdmUgZm9yd2FyZAogICAgICAgIC8vIFt1cF0gW3JpZ2h0XSAvIFtkb3duXSBbbGVmdF0gLSBhZ2FpbiBjb21tb24gYW5kIG5hdHVyYWwgYWRkaXRpb24sCiAgICAgICAgLy8gW3BnZG93bl0gLyBbcGd1cF0gLSBvZnRlbiB0cmlnZ2VyZWQgYnkgcmVtb3RlIGNvbnRyb2xsZXJzLAogICAgICAgIC8vIFt0YWJdIC0gdGhpcyBvbmUgaXMgcXVpdGUgY29udHJvdmVyc2lhbCwgYnV0IHRoZSByZWFzb24gaXQgZW5kZWQgdXAgb24KICAgICAgICAvLyAgIHRoaXMgbGlzdCBpcyBxdWl0ZSBhbiBpbnRlcmVzdGluZyBzdG9yeS4uLiBSZW1lbWJlciB0aGF0IHN0cmFuZ2UgcGFydAogICAgICAgIC8vICAgaW4gdGhlIGltcHJlc3MuanMgY29kZSB3aGVyZSB3aW5kb3cgaXMgc2Nyb2xsZWQgdG8gMCwwIG9uIGV2ZXJ5IHByZXNlbnRhdGlvbgogICAgICAgIC8vICAgc3RlcCwgYmVjYXVzZSBzb21ldGltZXMgYnJvd3NlciBzY3JvbGxzIHZpZXdwb3J0IGJlY2F1c2Ugb2YgdGhlIGZvY3VzZWQgZWxlbWVudD8KICAgICAgICAvLyAgIFdlbGwsIHRoZSBbdGFiXSBrZXkgYnkgZGVmYXVsdCBuYXZpZ2F0ZXMgYXJvdW5kIGZvY3VzYWJsZSBlbGVtZW50cywgc28gY2xpY2tpbmcKICAgICAgICAvLyAgIGl0IHZlcnkgb2Z0ZW4gY2F1c2VkIHNjcm9sbGluZyB0byBmb2N1c2VkIGVsZW1lbnQgYW5kIGJyZWFraW5nIGltcHJlc3MuanMKICAgICAgICAvLyAgIHBvc2l0aW9uaW5nLiBJIGRpZG4ndCB3YW50IHRvIGp1c3QgcHJldmVudCB0aGlzIGRlZmF1bHQgYWN0aW9uLCBzbyBJIHVzZWQgW3RhYl0KICAgICAgICAvLyAgIGFzIGFub3RoZXIgd2F5IHRvIG1vdmluZyB0byBuZXh0IHN0ZXAuLi4gQW5kIHllcywgSSBrbm93IHRoYXQgZm9yIHRoZSBzYWtlIG9mCiAgICAgICAgLy8gICBjb25zaXN0ZW5jeSBJIHNob3VsZCBhZGQgW3NoaWZ0K3RhYl0gYXMgb3Bwb3NpdGUgYWN0aW9uLi4uCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigia2V5dXAiLCBmdW5jdGlvbiAoIGV2ZW50ICkgewogICAgICAgICAgICBpZiAoIGV2ZW50LmtleUNvZGUgPT09IDkgfHwgKCBldmVudC5rZXlDb2RlID49IDMyICYmIGV2ZW50LmtleUNvZGUgPD0gMzQgKSB8fCAoZXZlbnQua2V5Q29kZSA+PSAzNyAmJiBldmVudC5rZXlDb2RlIDw9IDQwKSApIHsKICAgICAgICAgICAgICAgIHN3aXRjaCggZXZlbnQua2V5Q29kZSApIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIDMzOiAvLyBwZyB1cAogICAgICAgICAgICAgICAgICAgIGNhc2UgMzc6IC8vIGxlZnQKICAgICAgICAgICAgICAgICAgICBjYXNlIDM4OiAvLyB1cAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwaS5wcmV2KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSA5OiAgLy8gdGFiCiAgICAgICAgICAgICAgICAgICAgY2FzZSAzMjogLy8gc3BhY2UKICAgICAgICAgICAgICAgICAgICBjYXNlIDM0OiAvLyBwZyBkb3duCiAgICAgICAgICAgICAgICAgICAgY2FzZSAzOTogLy8gcmlnaHQKICAgICAgICAgICAgICAgICAgICBjYXNlIDQwOiAvLyBkb3duCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBpLm5leHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAKICAgICAgICAvLyBkZWxlZ2F0ZWQgaGFuZGxlciBmb3IgY2xpY2tpbmcgb24gdGhlIGxpbmtzIHRvIHByZXNlbnRhdGlvbiBzdGVwcwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24gKCBldmVudCApIHsKICAgICAgICAgICAgLy8gZXZlbnQgZGVsZWdhdGlvbiB3aXRoICJidWJibGluZyIKICAgICAgICAgICAgLy8gY2hlY2sgaWYgZXZlbnQgdGFyZ2V0IChvciBhbnkgb2YgaXRzIHBhcmVudHMgaXMgYSBsaW5rKQogICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwogICAgICAgICAgICB3aGlsZSAoICh0YXJnZXQudGFnTmFtZSAhPT0gIkEiKSAmJgogICAgICAgICAgICAgICAgICAgICh0YXJnZXQgIT09IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgKSB7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCB0YXJnZXQudGFnTmFtZSA9PT0gIkEiICkgewogICAgICAgICAgICAgICAgdmFyIGhyZWYgPSB0YXJnZXQuZ2V0QXR0cmlidXRlKCJocmVmIik7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIGlmIGl0J3MgYSBsaW5rIHRvIHByZXNlbnRhdGlvbiBzdGVwLCB0YXJnZXQgdGhpcyBzdGVwCiAgICAgICAgICAgICAgICBpZiAoIGhyZWYgJiYgaHJlZlswXSA9PT0gJyMnICkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBocmVmLnNsaWNlKDEpICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICggYXBpLmdvdG8odGFyZ2V0KSApIHsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAKICAgICAgICAvLyBkZWxlZ2F0ZWQgaGFuZGxlciBmb3IgY2xpY2tpbmcgb24gc3RlcCBlbGVtZW50cwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgZnVuY3Rpb24gKCBldmVudCApIHsKICAgICAgICAgICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKICAgICAgICAgICAgLy8gZmluZCBjbG9zZXN0IHN0ZXAgZWxlbWVudCB0aGF0IGlzIG5vdCBhY3RpdmUKICAgICAgICAgICAgd2hpbGUgKCAhKHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoInN0ZXAiKSAmJiAhdGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygiYWN0aXZlIikpICYmCiAgICAgICAgICAgICAgICAgICAgKHRhcmdldCAhPT0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSApIHsKICAgICAgICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIGFwaS5nb3RvKHRhcmdldCkgKSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9CiAgICAgICAgfSwgZmFsc2UpOwogICAgICAgIAogICAgICAgIC8vIHRvdWNoIGhhbmRsZXIgdG8gZGV0ZWN0IHRhcHMgb24gdGhlIGxlZnQgYW5kIHJpZ2h0IHNpZGUgb2YgdGhlIHNjcmVlbgogICAgICAgIC8vIGJhc2VkIG9uIGF3ZXNvbWUgd29yayBvZiBAaGFraW1lbDogaHR0cHM6Ly9naXRodWIuY29tL2hha2ltZWwvcmV2ZWFsLmpzCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigidG91Y2hzdGFydCIsIGZ1bmN0aW9uICggZXZlbnQgKSB7CiAgICAgICAgICAgIGlmIChldmVudC50b3VjaGVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgdmFyIHggPSBldmVudC50b3VjaGVzWzBdLmNsaWVudFgsCiAgICAgICAgICAgICAgICAgICAgd2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aCAqIDAuMywKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCB4IDwgd2lkdGggKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gYXBpLnByZXYoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIHggPiB3aW5kb3cuaW5uZXJXaWR0aCAtIHdpZHRoICkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGFwaS5uZXh0KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwgZmFsc2UpOwogICAgICAgIAogICAgICAgIC8vIHJlc2NhbGUgcHJlc2VudGF0aW9uIHdoZW4gd2luZG93IGlzIHJlc2l6ZWQKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgdGhyb3R0bGUoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBmb3JjZSBnb2luZyB0byBhY3RpdmUgc3RlcCBhZ2FpbiwgdG8gdHJpZ2dlciByZXNjYWxpbmcKICAgICAgICAgICAgYXBpLmdvdG8oIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5hY3RpdmUiKSwgNTAwICk7CiAgICAgICAgfSwgMjUwKSwgZmFsc2UpOwogICAgICAgIAogICAgfSwgZmFsc2UpOwogICAgICAgIAp9KShkb2N1bWVudCwgd2luZG93KTsKCi8vIFRIQVQnUyBBTEwgRk9MS1MhCi8vCi8vIFRoYW5rcyBmb3IgcmVhZGluZyBpdCBhbGwuCi8vIE9yIHRoYW5rcyBmb3Igc2Nyb2xsaW5nIGRvd24gYW5kIHJlYWRpbmcgdGhlIGxhc3QgcGFydC4KLy8KLy8gSSd2ZSBsZWFybnQgYSBsb3Qgd2hlbiBidWlsZGluZyBpbXByZXNzLmpzIGFuZCBJIGhvcGUgdGhpcyBjb2RlIGFuZCBjb21tZW50cwovLyB3aWxsIGhlbHAgc29tZWJvZHkgbGVhcm4gYXQgbGVhc3Qgc29tZSBwYXJ0IG9mIGl0Lgo=",
                "body": "LyoqCiAqIGltcHJlc3MuanMKICoKICogaW1wcmVzcy5qcyBpcyBhIHByZXNlbnRhdGlvbiB0b29sIGJhc2VkIG9uIHRoZSBwb3dlciBvZiBDU1MzIHRyYW5zZm9ybXMgYW5kIHRyYW5zaXRpb25zCiAqIGluIG1vZGVybiBicm93c2VycyBhbmQgaW5zcGlyZWQgYnkgdGhlIGlkZWEgYmVoaW5kIHByZXppLmNvbS4KICoKICoKICogQ29weXJpZ2h0IDIwMTEtMjAxMiBCYXJ0ZWsgU3pvcGthIChAYmFydGF6KQogKgogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgTGljZW5zZXMuCiAqCiAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogKiAgYXV0aG9yOiAgQmFydGVrIFN6b3BrYQogKiAgdmVyc2lvbjogMC41LjMKICogIHVybDogICAgIGh0dHA6Ly9iYXJ0YXouZ2l0aHViLmNvbS9pbXByZXNzLmpzLwogKiAgc291cmNlOiAgaHR0cDovL2dpdGh1Yi5jb20vYmFydGF6L2ltcHJlc3MuanMvCiAqLwoKLypqc2hpbnQgYml0d2lzZTp0cnVlLCBjdXJseTp0cnVlLCBlcWVxZXE6dHJ1ZSwgZm9yaW46dHJ1ZSwgbGF0ZWRlZjp0cnVlLCBuZXdjYXA6dHJ1ZSwKICAgICAgICAgbm9hcmc6dHJ1ZSwgbm9lbXB0eTp0cnVlLCB1bmRlZjp0cnVlLCBzdHJpY3Q6dHJ1ZSwgYnJvd3Nlcjp0cnVlICovCgovLyBZb3UgYXJlIG9uZSBvZiB0aG9zZSB3aG8gbGlrZSB0byBrbm93IGhvdyB0aGluZyB3b3JrIGluc2lkZT8KLy8gTGV0IG1lIHNob3cgeW91IHRoZSBjb2dzIHRoYXQgbWFrZSBpbXByZXNzLmpzIHJ1bi4uLgooZnVuY3Rpb24gKCBkb2N1bWVudCwgd2luZG93ICkgewogICAgJ3VzZSBzdHJpY3QnOwogICAgCiAgICAvLyBIRUxQRVIgRlVOQ1RJT05TCiAgICAKICAgIC8vIGBwZnhgIGlzIGEgZnVuY3Rpb24gdGhhdCB0YWtlcyBhIHN0YW5kYXJkIENTUyBwcm9wZXJ0eSBuYW1lIGFzIGEgcGFyYW1ldGVyCiAgICAvLyBhbmQgcmV0dXJucyBpdCdzIHByZWZpeGVkIHZlcnNpb24gdmFsaWQgZm9yIGN1cnJlbnQgYnJvd3NlciBpdCBydW5zIGluLgogICAgLy8gVGhlIGNvZGUgaXMgaGVhdmlseSBpbnNwaXJlZCBieSBNb2Rlcm5penIgaHR0cDovL3d3dy5tb2Rlcm5penIuY29tLwogICAgdmFyIHBmeCA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgCiAgICAgICAgdmFyIHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZHVtbXknKS5zdHlsZSwKICAgICAgICAgICAgcHJlZml4ZXMgPSAnV2Via2l0IE1veiBPIG1zIEtodG1sJy5zcGxpdCgnICcpLAogICAgICAgICAgICBtZW1vcnkgPSB7fTsKICAgICAgICAKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCBwcm9wICkgewogICAgICAgICAgICBpZiAoIHR5cGVvZiBtZW1vcnlbIHByb3AgXSA9PT0gInVuZGVmaW5lZCIgKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZhciB1Y1Byb3AgID0gcHJvcC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHByb3Auc3Vic3RyKDEpLAogICAgICAgICAgICAgICAgICAgIHByb3BzICAgPSAocHJvcCArICcgJyArIHByZWZpeGVzLmpvaW4odWNQcm9wICsgJyAnKSArIHVjUHJvcCkuc3BsaXQoJyAnKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbWVtb3J5WyBwcm9wIF0gPSBudWxsOwogICAgICAgICAgICAgICAgZm9yICggdmFyIGkgaW4gcHJvcHMgKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCBzdHlsZVsgcHJvcHNbaV0gXSAhPT0gdW5kZWZpbmVkICkgewogICAgICAgICAgICAgICAgICAgICAgICBtZW1vcnlbIHByb3AgXSA9IHByb3BzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gbWVtb3J5WyBwcm9wIF07CiAgICAgICAgfTsKICAgIAogICAgfSkoKTsKICAgIAogICAgLy8gYGFycmFpZnlgIHRha2VzIGFuIGFycmF5LWxpa2Ugb2JqZWN0IGFuZCB0dXJucyBpdCBpbnRvIHJlYWwgQXJyYXkKICAgIC8vIHRvIG1ha2UgYWxsIHRoZSBBcnJheS5wcm90b3R5cGUgZ29vZG5lc3MgYXZhaWxhYmxlLgogICAgdmFyIGFycmF5aWZ5ID0gZnVuY3Rpb24gKCBhICkgewogICAgICAgIHJldHVybiBbXS5zbGljZS5jYWxsKCBhICk7CiAgICB9OwogICAgCiAgICAvLyBgY3NzYCBmdW5jdGlvbiBhcHBsaWVzIHRoZSBzdHlsZXMgZ2l2ZW4gaW4gYHByb3BzYCBvYmplY3QgdG8gdGhlIGVsZW1lbnQKICAgIC8vIGdpdmVuIGFzIGBlbGAuIEl0IHJ1bnMgYWxsIHByb3BlcnR5IG5hbWVzIHRocm91Z2ggYHBmeGAgZnVuY3Rpb24gdG8gbWFrZQogICAgLy8gc3VyZSBwcm9wZXIgcHJlZml4ZWQgdmVyc2lvbiBvZiB0aGUgcHJvcGVydHkgaXMgdXNlZC4KICAgIHZhciBjc3MgPSBmdW5jdGlvbiAoIGVsLCBwcm9wcyApIHsKICAgICAgICB2YXIga2V5LCBwa2V5OwogICAgICAgIGZvciAoIGtleSBpbiBwcm9wcyApIHsKICAgICAgICAgICAgaWYgKCBwcm9wcy5oYXNPd25Qcm9wZXJ0eShrZXkpICkgewogICAgICAgICAgICAgICAgcGtleSA9IHBmeChrZXkpOwogICAgICAgICAgICAgICAgaWYgKCBwa2V5ICE9PSBudWxsICkgewogICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlW3BrZXldID0gcHJvcHNba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZWw7CiAgICB9OwogICAgCiAgICAvLyBgdG9OdW1iZXJgIHRha2VzIGEgdmFsdWUgZ2l2ZW4gYXMgYG51bWVyaWNgIHBhcmFtZXRlciBhbmQgdHJpZXMgdG8gdHVybgogICAgLy8gaXQgaW50byBhIG51bWJlci4gSWYgaXQgaXMgbm90IHBvc3NpYmxlIGl0IHJldHVybnMgMCAob3Igb3RoZXIgdmFsdWUKICAgIC8vIGdpdmVuIGFzIGBmYWxsYmFja2ApLgogICAgdmFyIHRvTnVtYmVyID0gZnVuY3Rpb24gKG51bWVyaWMsIGZhbGxiYWNrKSB7CiAgICAgICAgcmV0dXJuIGlzTmFOKG51bWVyaWMpID8gKGZhbGxiYWNrIHx8IDApIDogTnVtYmVyKG51bWVyaWMpOwogICAgfTsKICAgIAogICAgLy8gYGJ5SWRgIHJldHVybnMgZWxlbWVudCB3aXRoIGdpdmVuIGBpZGAgLSB5b3UgcHJvYmFibHkgaGF2ZSBndWVzc2VkIHRoYXQgOykKICAgIHZhciBieUlkID0gZnVuY3Rpb24gKCBpZCApIHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgfTsKICAgIAogICAgLy8gYCRgIHJldHVybnMgZmlyc3QgZWxlbWVudCBmb3IgZ2l2ZW4gQ1NTIGBzZWxlY3RvcmAgaW4gdGhlIGBjb250ZXh0YCBvZgogICAgLy8gdGhlIGdpdmVuIGVsZW1lbnQgb3Igd2hvbGUgZG9jdW1lbnQuCiAgICB2YXIgJCA9IGZ1bmN0aW9uICggc2VsZWN0b3IsIGNvbnRleHQgKSB7CiAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CiAgICAgICAgcmV0dXJuIGNvbnRleHQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7CiAgICB9OwogICAgCiAgICAvLyBgJCRgIHJldHVybiBhbiBhcnJheSBvZiBlbGVtZW50cyBmb3IgZ2l2ZW4gQ1NTIGBzZWxlY3RvcmAgaW4gdGhlIGBjb250ZXh0YCBvZgogICAgLy8gdGhlIGdpdmVuIGVsZW1lbnQgb3Igd2hvbGUgZG9jdW1lbnQuCiAgICB2YXIgJCQgPSBmdW5jdGlvbiAoIHNlbGVjdG9yLCBjb250ZXh0ICkgewogICAgICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IGRvY3VtZW50OwogICAgICAgIHJldHVybiBhcnJheWlmeSggY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKSApOwogICAgfTsKICAgIAogICAgLy8gYHRyaWdnZXJFdmVudGAgYnVpbGRzIGEgY3VzdG9tIERPTSBldmVudCB3aXRoIGdpdmVuIGBldmVudE5hbWVgIGFuZCBgZGV0YWlsYCBkYXRhCiAgICAvLyBhbmQgdHJpZ2dlcnMgaXQgb24gZWxlbWVudCBnaXZlbiBhcyBgZWxgLgogICAgdmFyIHRyaWdnZXJFdmVudCA9IGZ1bmN0aW9uIChlbCwgZXZlbnROYW1lLCBkZXRhaWwpIHsKICAgICAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiQ3VzdG9tRXZlbnQiKTsKICAgICAgICBldmVudC5pbml0Q3VzdG9tRXZlbnQoZXZlbnROYW1lLCB0cnVlLCB0cnVlLCBkZXRhaWwpOwogICAgICAgIGVsLmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgfTsKICAgIAogICAgLy8gYHRyYW5zbGF0ZWAgYnVpbGRzIGEgdHJhbnNsYXRlIHRyYW5zZm9ybSBzdHJpbmcgZm9yIGdpdmVuIGRhdGEuCiAgICB2YXIgdHJhbnNsYXRlID0gZnVuY3Rpb24gKCB0ICkgewogICAgICAgIHJldHVybiAiIHRyYW5zbGF0ZTNkKCIgKyB0LnggKyAicHgsIiArIHQueSArICJweCwiICsgdC56ICsgInB4KSAiOwogICAgfTsKICAgIAogICAgLy8gYHJvdGF0ZWAgYnVpbGRzIGEgcm90YXRlIHRyYW5zZm9ybSBzdHJpbmcgZm9yIGdpdmVuIGRhdGEuCiAgICAvLyBCeSBkZWZhdWx0IHRoZSByb3RhdGlvbnMgYXJlIGluIFggWSBaIG9yZGVyIHRoYXQgY2FuIGJlIHJldmVydGVkIGJ5IHBhc3NpbmcgYHRydWVgCiAgICAvLyBhcyBzZWNvbmQgcGFyYW1ldGVyLgogICAgdmFyIHJvdGF0ZSA9IGZ1bmN0aW9uICggciwgcmV2ZXJ0ICkgewogICAgICAgIHZhciByWCA9ICIgcm90YXRlWCgiICsgci54ICsgImRlZykgIiwKICAgICAgICAgICAgclkgPSAiIHJvdGF0ZVkoIiArIHIueSArICJkZWcpICIsCiAgICAgICAgICAgIHJaID0gIiByb3RhdGVaKCIgKyByLnogKyAiZGVnKSAiOwogICAgICAgIAogICAgICAgIHJldHVybiByZXZlcnQgPyByWityWStyWCA6IHJYK3JZK3JaOwogICAgfTsKICAgIAogICAgLy8gYHNjYWxlYCBidWlsZHMgYSBzY2FsZSB0cmFuc2Zvcm0gc3RyaW5nIGZvciBnaXZlbiBkYXRhLgogICAgdmFyIHNjYWxlID0gZnVuY3Rpb24gKCBzICkgewogICAgICAgIHJldHVybiAiIHNjYWxlKCIgKyBzICsgIikgIjsKICAgIH07CiAgICAKICAgIC8vIGBwZXJzcGVjdGl2ZWAgYnVpbGRzIGEgcGVyc3BlY3RpdmUgdHJhbnNmb3JtIHN0cmluZyBmb3IgZ2l2ZW4gZGF0YS4KICAgIHZhciBwZXJzcGVjdGl2ZSA9IGZ1bmN0aW9uICggcCApIHsKICAgICAgICByZXR1cm4gIiBwZXJzcGVjdGl2ZSgiICsgcCArICJweCkgIjsKICAgIH07CiAgICAKICAgIC8vIGBnZXRFbGVtZW50RnJvbUhhc2hgIHJldHVybnMgYW4gZWxlbWVudCBsb2NhdGVkIGJ5IGlkIGZyb20gaGFzaCBwYXJ0IG9mCiAgICAvLyB3aW5kb3cgbG9jYXRpb24uCiAgICB2YXIgZ2V0RWxlbWVudEZyb21IYXNoID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIGdldCBpZCBmcm9tIHVybCAjIGJ5IHJlbW92aW5nIGAjYCBvciBgIy9gIGZyb20gdGhlIGJlZ2lubmluZywKICAgICAgICAvLyBzbyBib3RoICJmYWxsYmFjayIgYCNzbGlkZS1pZGAgYW5kICJlbmhhbmNlZCIgYCMvc2xpZGUtaWRgIHdpbGwgd29yawogICAgICAgIHJldHVybiBieUlkKCB3aW5kb3cubG9jYXRpb24uaGFzaC5yZXBsYWNlKC9eI1wvPy8sIiIpICk7CiAgICB9OwogICAgCiAgICAvLyBgY29tcHV0ZVdpbmRvd1NjYWxlYCBjb3VudHMgdGhlIHNjYWxlIGZhY3RvciBiZXR3ZWVuIHdpbmRvdyBzaXplIGFuZCBzaXplCiAgICAvLyBkZWZpbmVkIGZvciB0aGUgcHJlc2VudGF0aW9uIGluIHRoZSBjb25maWcuCiAgICB2YXIgY29tcHV0ZVdpbmRvd1NjYWxlID0gZnVuY3Rpb24gKCBjb25maWcgKSB7CiAgICAgICAgdmFyIGhTY2FsZSA9IHdpbmRvdy5pbm5lckhlaWdodCAvIGNvbmZpZy5oZWlnaHQsCiAgICAgICAgICAgIHdTY2FsZSA9IHdpbmRvdy5pbm5lcldpZHRoIC8gY29uZmlnLndpZHRoLAogICAgICAgICAgICBzY2FsZSA9IGhTY2FsZSA+IHdTY2FsZSA/IHdTY2FsZSA6IGhTY2FsZTsKICAgICAgICAKICAgICAgICBpZiAoY29uZmlnLm1heFNjYWxlICYmIHNjYWxlID4gY29uZmlnLm1heFNjYWxlKSB7CiAgICAgICAgICAgIHNjYWxlID0gY29uZmlnLm1heFNjYWxlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoY29uZmlnLm1pblNjYWxlICYmIHNjYWxlIDwgY29uZmlnLm1pblNjYWxlKSB7CiAgICAgICAgICAgIHNjYWxlID0gY29uZmlnLm1pblNjYWxlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gc2NhbGU7CiAgICB9OwogICAgCiAgICAvLyBDSEVDSyBTVVBQT1JUCiAgICB2YXIgYm9keSA9IGRvY3VtZW50LmJvZHk7CiAgICAKICAgIHZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKTsKICAgIHZhciBpbXByZXNzU3VwcG9ydGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBicm93c2VyIHNob3VsZCBzdXBwb3J0IENTUyAzRCB0cmFuc3Rvcm1zIAogICAgICAgICAgICAgICAgICAgICAgICAgICAvLyggcGZ4KCJwZXJzcGVjdGl2ZSIpICE9PSBudWxsICkgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIGBjbGFzc0xpc3RgIGFuZCBgZGF0YXNldGAgQVBJcwogICAgICAgICAgICAgICAgICAgICAgICAgICAvLyggYm9keS5jbGFzc0xpc3QgKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAvLyggYm9keS5kYXRhc2V0ICk7Ly8gJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnV0IHNvbWUgbW9iaWxlIGRldmljZXMgbmVlZCB0byBiZSBibGFja2xpc3RlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBiZWNhdXNlIHRoZWlyIENTUyAzRCBzdXBwb3J0IG9yIGhhcmR3YXJlIGlzIG5vdAogICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGdvb2QgZW5vdWdoIHRvIHJ1biBpbXByZXNzLmpzIHByb3Blcmx5LCBzb3JyeS4uLgogICAgLy8gICAgICAgICAgICAgICAgICAgICAgICggdWEuc2VhcmNoKC8oaXBob25lKXwoaXBvZCl8KGFuZHJvaWQpLykgPT09IC0xICk7CiAgICAKICAgIGlmICghaW1wcmVzc1N1cHBvcnRlZCkgewogICAgICAgIC8vIHdlIGNhbid0IGJlIHN1cmUgdGhhdCBgY2xhc3NMaXN0YCBpcyBzdXBwb3J0ZWQKICAgICAgICBib2R5LmNsYXNzTmFtZSArPSAiIGltcHJlc3Mtbm90LXN1cHBvcnRlZCAiOwogICAgfSBlbHNlIHsKICAgICAgICBib2R5LmNsYXNzTGlzdC5yZW1vdmUoImltcHJlc3Mtbm90LXN1cHBvcnRlZCIpOwogICAgICAgIGJvZHkuY2xhc3NMaXN0LmFkZCgiaW1wcmVzcy1zdXBwb3J0ZWQiKTsKICAgIH0KICAgIAogICAgLy8gR0xPQkFMUyBBTkQgREVGQVVMVFMKICAgIAogICAgLy8gVGhpcyBpcyB3ZXJlIHRoZSByb290IGVsZW1lbnRzIG9mIGFsbCBpbXByZXNzLmpzIGluc3RhbmNlcyB3aWxsIGJlIGtlcHQuCiAgICAvLyBZZXMsIHRoaXMgbWVhbnMgeW91IGNhbiBoYXZlIG1vcmUgdGhhbiBvbmUgaW5zdGFuY2Ugb24gYSBwYWdlLCBidXQgSSdtIG5vdAogICAgLy8gc3VyZSBpZiBpdCBtYWtlcyBhbnkgc2Vuc2UgaW4gcHJhY3RpY2UgOykKICAgIHZhciByb290cyA9IHt9OwogICAgCiAgICAvLyBzb21lIGRlZmF1bHQgY29uZmlnIHZhbHVlcy4KICAgIHZhciBkZWZhdWx0cyA9IHsKICAgICAgICB3aWR0aDogMTAyNCwKICAgICAgICBoZWlnaHQ6IDc2OCwKICAgICAgICBtYXhTY2FsZTogMSwKICAgICAgICBtaW5TY2FsZTogMCwKICAgICAgICAKICAgICAgICBwZXJzcGVjdGl2ZTogMTAwMCwKICAgICAgICAKICAgICAgICB0cmFuc2l0aW9uRHVyYXRpb246IDEwMDAKICAgIH07CiAgICAKICAgIC8vIGl0J3MganVzdCBhbiBlbXB0eSBmdW5jdGlvbiAuLi4gYW5kIGEgdXNlbGVzcyBjb21tZW50LgogICAgdmFyIGVtcHR5ID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gZmFsc2U7IH07CiAgICAKICAgIC8vIElNUFJFU1MuSlMgQVBJCiAgICAKICAgIC8vIEFuZCB0aGF0J3Mgd2hlcmUgaW50ZXJlc3RpbmcgdGhpbmdzIHdpbGwgc3RhcnQgdG8gaGFwcGVuLgogICAgLy8gSXQncyB0aGUgY29yZSBgaW1wcmVzc2AgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBpbXByZXNzLmpzIEFQSQogICAgLy8gZm9yIGEgcHJlc2VudGF0aW9uIGJhc2VkIG9uIHRoZSBlbGVtZW50IHdpdGggZ2l2ZW4gaWQgKCdpbXByZXNzJwogICAgLy8gYnkgZGVmYXVsdCkuCiAgICB2YXIgaW1wcmVzcyA9IHdpbmRvdy5pbXByZXNzID0gZnVuY3Rpb24gKCByb290SWQgKSB7CiAgICAgICAgCiAgICAgICAgLy8gSWYgaW1wcmVzcy5qcyBpcyBub3Qgc3VwcG9ydGVkIGJ5IHRoZSBicm93c2VyIHJldHVybiBhIGR1bW15IEFQSQogICAgICAgIC8vIGl0IG1heSBub3QgYmUgYSBwZXJmZWN0IHNvbHV0aW9uIGJ1dCB3ZSByZXR1cm4gZWFybHkgYW5kIGF2b2lkCiAgICAgICAgLy8gcnVubmluZyBjb2RlIHRoYXQgbWF5IHVzZSBmZWF0dXJlcyBub3QgaW1wbGVtZW50ZWQgaW4gdGhlIGJyb3dzZXIuCiAgICAgICAgaWYgKCFpbXByZXNzU3VwcG9ydGVkKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBpbml0OiBlbXB0eSwKICAgICAgICAgICAgICAgIGdvdG86IGVtcHR5LAogICAgICAgICAgICAgICAgcHJldjogZW1wdHksCiAgICAgICAgICAgICAgICBuZXh0OiBlbXB0eQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICAKICAgICAgICByb290SWQgPSByb290SWQgfHwgImltcHJlc3MiOwogICAgICAgIAogICAgICAgIC8vIGlmIGdpdmVuIHJvb3QgaXMgYWxyZWFkeSBpbml0aWFsaXplZCBqdXN0IHJldHVybiB0aGUgQVBJCiAgICAgICAgaWYgKHJvb3RzWyJpbXByZXNzLXJvb3QtIiArIHJvb3RJZF0pIHsKICAgICAgICAgICAgcmV0dXJuIHJvb3RzWyJpbXByZXNzLXJvb3QtIiArIHJvb3RJZF07CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIGRhdGEgb2YgYWxsIHByZXNlbnRhdGlvbiBzdGVwcwogICAgICAgIHZhciBzdGVwc0RhdGEgPSB7fTsKICAgICAgICAKICAgICAgICAvLyBlbGVtZW50IG9mIGN1cnJlbnRseSBhY3RpdmUgc3RlcAogICAgICAgIHZhciBhY3RpdmVTdGVwID0gbnVsbDsKICAgICAgICAKICAgICAgICAvLyBjdXJyZW50IHN0YXRlIChwb3NpdGlvbiwgcm90YXRpb24gYW5kIHNjYWxlKSBvZiB0aGUgcHJlc2VudGF0aW9uCiAgICAgICAgdmFyIGN1cnJlbnRTdGF0ZSA9IG51bGw7CiAgICAgICAgCiAgICAgICAgLy8gYXJyYXkgb2Ygc3RlcCBlbGVtZW50cwogICAgICAgIHZhciBzdGVwcyA9IG51bGw7CiAgICAgICAgCiAgICAgICAgLy8gY29uZmlndXJhdGlvbiBvcHRpb25zCiAgICAgICAgdmFyIGNvbmZpZyA9IG51bGw7CiAgICAgICAgCiAgICAgICAgLy8gc2NhbGUgZmFjdG9yIG9mIHRoZSBicm93c2VyIHdpbmRvdwogICAgICAgIHZhciB3aW5kb3dTY2FsZSA9IG51bGw7ICAgICAgICAKICAgICAgICAKICAgICAgICAvLyByb290IHByZXNlbnRhdGlvbiBlbGVtZW50cwogICAgICAgIHZhciByb290ID0gYnlJZCggcm9vdElkICk7CiAgICAgICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIAogICAgICAgIHZhciBpbml0aWFsaXplZCA9IGZhbHNlOwogICAgICAgIAogICAgICAgIC8vIFNURVAgRVZFTlRTCiAgICAgICAgLy8KICAgICAgICAvLyBUaGVyZSBhcmUgY3VycmVudGx5IHR3byBzdGVwIGV2ZW50cyB0cmlnZ2VyZWQgYnkgaW1wcmVzcy5qcwogICAgICAgIC8vIGBpbXByZXNzOnN0ZXBlbnRlcmAgaXMgdHJpZ2dlcmVkIHdoZW4gdGhlIHN0ZXAgaXMgc2hvd24gb24gdGhlIAogICAgICAgIC8vIHNjcmVlbiAodGhlIHRyYW5zaXRpb24gZnJvbSB0aGUgcHJldmlvdXMgb25lIGlzIGZpbmlzaGVkKSBhbmQKICAgICAgICAvLyBgaW1wcmVzczpzdGVwbGVhdmVgIGlzIHRyaWdnZXJlZCB3aGVuIHRoZSBzdGVwIGlzIGxlZnQgKHRoZQogICAgICAgIC8vIHRyYW5zaXRpb24gdG8gbmV4dCBzdGVwIGp1c3Qgc3RhcnRzKS4KICAgICAgICAKICAgICAgICAvLyByZWZlcmVuY2UgdG8gbGFzdCBlbnRlcmVkIHN0ZXAKICAgICAgICB2YXIgbGFzdEVudGVyZWQgPSBudWxsOwogICAgICAgIAogICAgICAgIC8vIGBvblN0ZXBFbnRlcmAgaXMgY2FsbGVkIHdoZW5ldmVyIHRoZSBzdGVwIGVsZW1lbnQgaXMgZW50ZXJlZAogICAgICAgIC8vIGJ1dCB0aGUgZXZlbnQgaXMgdHJpZ2dlcmVkIG9ubHkgaWYgdGhlIHN0ZXAgaXMgZGlmZmVyZW50IHRoYW4KICAgICAgICAvLyBsYXN0IGVudGVyZWQgc3RlcC4KICAgICAgICB2YXIgb25TdGVwRW50ZXIgPSBmdW5jdGlvbiAoc3RlcCkgewogICAgICAgICAgICBpZiAobGFzdEVudGVyZWQgIT09IHN0ZXApIHsKICAgICAgICAgICAgICAgIHRyaWdnZXJFdmVudChzdGVwLCAiaW1wcmVzczpzdGVwZW50ZXIiKTsKICAgICAgICAgICAgICAgIGxhc3RFbnRlcmVkID0gc3RlcDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgLy8gYG9uU3RlcExlYXZlYCBpcyBjYWxsZWQgd2hlbmV2ZXIgdGhlIHN0ZXAgZWxlbWVudCBpcyBsZWZ0CiAgICAgICAgLy8gYnV0IHRoZSBldmVudCBpcyB0cmlnZ2VyZWQgb25seSBpZiB0aGUgc3RlcCBpcyB0aGUgc2FtZSBhcwogICAgICAgIC8vIGxhc3QgZW50ZXJlZCBzdGVwLgogICAgICAgIHZhciBvblN0ZXBMZWF2ZSA9IGZ1bmN0aW9uIChzdGVwKSB7CiAgICAgICAgICAgIGlmIChsYXN0RW50ZXJlZCA9PT0gc3RlcCkgewogICAgICAgICAgICAgICAgdHJpZ2dlckV2ZW50KHN0ZXAsICJpbXByZXNzOnN0ZXBsZWF2ZSIpOwogICAgICAgICAgICAgICAgbGFzdEVudGVyZWQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICAvLyBgaW5pdFN0ZXBgIGluaXRpYWxpemVzIGdpdmVuIHN0ZXAgZWxlbWVudCBieSByZWFkaW5nIGRhdGEgZnJvbSBpdHMKICAgICAgICAvLyBkYXRhIGF0dHJpYnV0ZXMgYW5kIHNldHRpbmcgY29ycmVjdCBzdHlsZXMuCiAgICAgICAgdmFyIGluaXRTdGVwID0gZnVuY3Rpb24gKCBlbCwgaWR4ICkgewogICAgICAgICAgICB2YXIgZGF0YSA9IGVsLmRhdGFzZXQsCiAgICAgICAgICAgICAgICBzdGVwID0gewogICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZTogewogICAgICAgICAgICAgICAgICAgICAgICB4OiB0b051bWJlcihkYXRhLngpLAogICAgICAgICAgICAgICAgICAgICAgICB5OiB0b051bWJlcihkYXRhLnkpLAogICAgICAgICAgICAgICAgICAgICAgICB6OiB0b051bWJlcihkYXRhLnopCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICByb3RhdGU6IHsKICAgICAgICAgICAgICAgICAgICAgICAgeDogdG9OdW1iZXIoZGF0YS5yb3RhdGVYKSwKICAgICAgICAgICAgICAgICAgICAgICAgeTogdG9OdW1iZXIoZGF0YS5yb3RhdGVZKSwKICAgICAgICAgICAgICAgICAgICAgICAgejogdG9OdW1iZXIoZGF0YS5yb3RhdGVaIHx8IGRhdGEucm90YXRlKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2NhbGU6IHRvTnVtYmVyKGRhdGEuc2NhbGUsIDEpLAogICAgICAgICAgICAgICAgICAgIGVsOiBlbAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICggIWVsLmlkICkgewogICAgICAgICAgICAgICAgZWwuaWQgPSAic3RlcC0iICsgKGlkeCArIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBzdGVwc0RhdGFbImltcHJlc3MtIiArIGVsLmlkXSA9IHN0ZXA7CiAgICAgICAgICAgIAogICAgICAgICAgICBjc3MoZWwsIHsKICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAidHJhbnNsYXRlKC01MCUsLTUwJSkiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlKHN0ZXAudHJhbnNsYXRlKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0ZShzdGVwLnJvdGF0ZSkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZShzdGVwLnNjYWxlKSwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybVN0eWxlOiAicHJlc2VydmUtM2QiCiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgdmFyIG5ld1N0ZXAgPSBmdW5jdGlvbiAoIGVsICkgewogICAgICAgICAgICBpbml0U3RlcChlbCk7CiAgICAgICAgICAgIHN0ZXBzLnB1c2goZWwpOwogICAgICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gYGluaXRgIEFQSSBmdW5jdGlvbiB0aGF0IGluaXRpYWxpemVzIChhbmQgcnVucykgdGhlIHByZXNlbnRhdGlvbi4KICAgICAgICB2YXIgaW5pdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKGluaXRpYWxpemVkKSB7IHJldHVybjsgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmlyc3Qgd2Ugc2V0IHVwIHRoZSB2aWV3cG9ydCBmb3IgbW9iaWxlIGRldmljZXMuCiAgICAgICAgICAgIC8vIEZvciBzb21lIHJlYXNvbiBpUGFkIGdvZXMgbnV0cyB3aGVuIGl0IGlzIG5vdCBkb25lIHByb3Blcmx5LgogICAgICAgICAgICB2YXIgbWV0YSA9ICQoIm1ldGFbbmFtZT0ndmlld3BvcnQnXSIpIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm1ldGEiKTsKICAgICAgICAgICAgbWV0YS5jb250ZW50ID0gIndpZHRoPWRldmljZS13aWR0aCwgbWluaW11bS1zY2FsZT0xLCBtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iOwogICAgICAgICAgICBpZiAobWV0YS5wYXJlbnROb2RlICE9PSBkb2N1bWVudC5oZWFkKSB7CiAgICAgICAgICAgICAgICBtZXRhLm5hbWUgPSAndmlld3BvcnQnOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChtZXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gaW5pdGlhbGl6ZSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgICAgICAgICB2YXIgcm9vdERhdGEgPSByb290LmRhdGFzZXQ7CiAgICAgICAgICAgIGNvbmZpZyA9IHsKICAgICAgICAgICAgICAgIHdpZHRoOiB0b051bWJlciggcm9vdERhdGEud2lkdGgsIGRlZmF1bHRzLndpZHRoICksCiAgICAgICAgICAgICAgICBoZWlnaHQ6IHRvTnVtYmVyKCByb290RGF0YS5oZWlnaHQsIGRlZmF1bHRzLmhlaWdodCApLAogICAgICAgICAgICAgICAgbWF4U2NhbGU6IHRvTnVtYmVyKCByb290RGF0YS5tYXhTY2FsZSwgZGVmYXVsdHMubWF4U2NhbGUgKSwKICAgICAgICAgICAgICAgIG1pblNjYWxlOiB0b051bWJlciggcm9vdERhdGEubWluU2NhbGUsIGRlZmF1bHRzLm1pblNjYWxlICksICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcGVyc3BlY3RpdmU6IHRvTnVtYmVyKCByb290RGF0YS5wZXJzcGVjdGl2ZSwgZGVmYXVsdHMucGVyc3BlY3RpdmUgKSwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvbjogdG9OdW1iZXIoIHJvb3REYXRhLnRyYW5zaXRpb25EdXJhdGlvbiwgZGVmYXVsdHMudHJhbnNpdGlvbkR1cmF0aW9uICkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdpbmRvd1NjYWxlID0gY29tcHV0ZVdpbmRvd1NjYWxlKCBjb25maWcgKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIHdyYXAgc3RlcHMgd2l0aCAiY2FudmFzIiBlbGVtZW50CiAgICAgICAgICAgIGFycmF5aWZ5KCByb290LmNoaWxkTm9kZXMgKS5mb3JFYWNoKGZ1bmN0aW9uICggZWwgKSB7CiAgICAgICAgICAgICAgICBjYW52YXMuYXBwZW5kQ2hpbGQoIGVsICk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByb290LmFwcGVuZENoaWxkKGNhbnZhcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBzZXQgaW5pdGlhbCBzdHlsZXMKICAgICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlLmhlaWdodCA9ICIxMDAlIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNzcyhib2R5LCB7CiAgICAgICAgICAgICAgICBoZWlnaHQ6ICIxMDAlIiwKICAgICAgICAgICAgICAgIG92ZXJmbG93OiAiaGlkZGVuIgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciByb290U3R5bGVzID0gewogICAgICAgICAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm1PcmlnaW46ICJ0b3AgbGVmdCIsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uOiAiYWxsIDBzIGVhc2UtaW4tb3V0IiwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybVN0eWxlOiAicHJlc2VydmUtM2QiCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICBjc3Mocm9vdCwgcm9vdFN0eWxlcyk7CiAgICAgICAgICAgIGNzcyhyb290LCB7CiAgICAgICAgICAgICAgICB0b3A6ICI1MCUiLAogICAgICAgICAgICAgICAgbGVmdDogIjUwJSIsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm06IHBlcnNwZWN0aXZlKCBjb25maWcucGVyc3BlY3RpdmUvd2luZG93U2NhbGUgKSArIHNjYWxlKCB3aW5kb3dTY2FsZSApCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjc3MoY2FudmFzLCByb290U3R5bGVzKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGJvZHkuY2xhc3NMaXN0LnJlbW92ZSgiaW1wcmVzcy1kaXNhYmxlZCIpOwogICAgICAgICAgICBib2R5LmNsYXNzTGlzdC5hZGQoImltcHJlc3MtZW5hYmxlZCIpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gZ2V0IGFuZCBpbml0IHN0ZXBzCiAgICAgICAgICAgIHN0ZXBzID0gJCQoIi5zdGVwIiwgcm9vdCk7CiAgICAgICAgICAgIHN0ZXBzLmZvckVhY2goIGluaXRTdGVwICk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBzZXQgYSBkZWZhdWx0IGluaXRpYWwgc3RhdGUgb2YgdGhlIGNhbnZhcwogICAgICAgICAgICBjdXJyZW50U3RhdGUgPSB7CiAgICAgICAgICAgICAgICB0cmFuc2xhdGU6IHsgeDogMCwgeTogMCwgejogMCB9LAogICAgICAgICAgICAgICAgcm90YXRlOiAgICB7IHg6IDAsIHk6IDAsIHo6IDAgfSwKICAgICAgICAgICAgICAgIHNjYWxlOiAgICAgMQogICAgICAgICAgICB9OwogICAgICAgICAgICAKICAgICAgICAgICAgaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgdHJpZ2dlckV2ZW50KHJvb3QsICJpbXByZXNzOmluaXQiLCB7IGFwaTogcm9vdHNbICJpbXByZXNzLXJvb3QtIiArIHJvb3RJZCBdIH0pOwogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgLy8gYGdldFN0ZXBgIGlzIGEgaGVscGVyIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIHN0ZXAgZWxlbWVudCBkZWZpbmVkIGJ5IHBhcmFtZXRlci4KICAgICAgICAvLyBJZiBhIG51bWJlciBpcyBnaXZlbiwgc3RlcCB3aXRoIGluZGV4IGdpdmVuIGJ5IHRoZSBudW1iZXIgaXMgcmV0dXJuZWQsIGlmIGEgc3RyaW5nCiAgICAgICAgLy8gaXMgZ2l2ZW4gc3RlcCBlbGVtZW50IHdpdGggc3VjaCBpZCBpcyByZXR1cm5lZCwgaWYgRE9NIGVsZW1lbnQgaXMgZ2l2ZW4gaXQgaXMgcmV0dXJuZWQKICAgICAgICAvLyBpZiBpdCBpcyBhIGNvcnJlY3Qgc3RlcCBlbGVtZW50LgogICAgICAgIHZhciBnZXRTdGVwID0gZnVuY3Rpb24gKCBzdGVwICkgewogICAgICAgICAgICBpZiAodHlwZW9mIHN0ZXAgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICBzdGVwID0gc3RlcCA8IDAgPyBzdGVwc1sgc3RlcHMubGVuZ3RoICsgc3RlcF0gOiBzdGVwc1sgc3RlcCBdOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBzdGVwID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgc3RlcCA9IGJ5SWQoc3RlcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIChzdGVwICYmIHN0ZXAuaWQgJiYgc3RlcHNEYXRhWyJpbXByZXNzLSIgKyBzdGVwLmlkXSkgPyBzdGVwIDogbnVsbDsKICAgICAgICB9OwogICAgICAgIAogICAgICAgIC8vIHVzZWQgdG8gcmVzZXQgdGltZW91dCBmb3IgYGltcHJlc3M6c3RlcGVudGVyYCBldmVudAogICAgICAgIHZhciBzdGVwRW50ZXJUaW1lb3V0ID0gbnVsbDsKICAgICAgICAKICAgICAgICB2YXIgdHJhbnNmb3JtYXRpb25DYWxsYmFjayA9IG51bGw7CiAgICAgICAgdmFyIHNldFRyYW5zZm9ybWF0aW9uQ2FsbGJhY2sgPSBmdW5jdGlvbihjYWxsYmFjayl7CiAgICAgICAgICB0cmFuc2Zvcm1hdGlvbkNhbGxiYWNrPWNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBgZ290b2AgQVBJIGZ1bmN0aW9uIHRoYXQgbW92ZXMgdG8gc3RlcCBnaXZlbiB3aXRoIGBlbGAgcGFyYW1ldGVyIChieSBpbmRleCwgaWQgb3IgZWxlbWVudCksCiAgICAgICAgLy8gd2l0aCBhIHRyYW5zaXRpb24gYGR1cmF0aW9uYCBvcHRpb25hbGx5IGdpdmVuIGFzIHNlY29uZCBwYXJhbWV0ZXIuCiAgICAgICAgdmFyIGdvdG8gPSBmdW5jdGlvbiAoIGVsLCBkdXJhdGlvbiApIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICggIWluaXRpYWxpemVkIHx8ICEoZWwgPSBnZXRTdGVwKGVsKSkgKSB7CiAgICAgICAgICAgICAgICAvLyBwcmVzZW50YXRpb24gbm90IGluaXRpYWxpemVkIG9yIGdpdmVuIGVsZW1lbnQgaXMgbm90IGEgc3RlcAogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTb21ldGltZXMgaXQncyBwb3NzaWJsZSB0byB0cmlnZ2VyIGZvY3VzIG9uIGZpcnN0IGxpbmsgd2l0aCBzb21lIGtleWJvYXJkIGFjdGlvbi4KICAgICAgICAgICAgLy8gQnJvd3NlciBpbiBzdWNoIGEgY2FzZSB0cmllcyB0byBzY3JvbGwgdGhlIHBhZ2UgdG8gbWFrZSB0aGlzIGVsZW1lbnQgdmlzaWJsZQogICAgICAgICAgICAvLyAoZXZlbiB0aGF0IGJvZHkgb3ZlcmZsb3cgaXMgc2V0IHRvIGhpZGRlbikgYW5kIGl0IGJyZWFrcyBvdXIgY2FyZWZ1bCBwb3NpdGlvbmluZy4KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gU28sIGFzIGEgbG91c3kgKGFuZCBsYXp5KSB3b3JrYXJvdW5kIHdlIHdpbGwgbWFrZSB0aGUgcGFnZSBzY3JvbGwgYmFjayB0byB0aGUgdG9wCiAgICAgICAgICAgIC8vIHdoZW5ldmVyIHNsaWRlIGlzIHNlbGVjdGVkCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIElmIHlvdSBhcmUgcmVhZGluZyB0aGlzIGFuZCBrbm93IGFueSBiZXR0ZXIgd2F5IHRvIGhhbmRsZSBpdCwgSSdsbCBiZSBnbGFkIHRvIGhlYXIgYWJvdXQgaXQhCiAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBzdGVwID0gc3RlcHNEYXRhWyJpbXByZXNzLSIgKyBlbC5pZF07CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIGFjdGl2ZVN0ZXAgKSB7CiAgICAgICAgICAgICAgICBhY3RpdmVTdGVwLmNsYXNzTGlzdC5yZW1vdmUoImFjdGl2ZSIpOwogICAgICAgICAgICAgICAgYm9keS5jbGFzc0xpc3QucmVtb3ZlKCJpbXByZXNzLW9uLSIgKyBhY3RpdmVTdGVwLmlkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbC5jbGFzc0xpc3QuYWRkKCJhY3RpdmUiKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGJvZHkuY2xhc3NMaXN0LmFkZCgiaW1wcmVzcy1vbi0iICsgZWwuaWQpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gY29tcHV0ZSB0YXJnZXQgc3RhdGUgb2YgdGhlIGNhbnZhcyBiYXNlZCBvbiBnaXZlbiBzdGVwCiAgICAgICAgICAgIHZhciB0YXJnZXQgPSB7CiAgICAgICAgICAgICAgICByb3RhdGU6IHsKICAgICAgICAgICAgICAgICAgICB4OiAtc3RlcC5yb3RhdGUueCwKICAgICAgICAgICAgICAgICAgICB5OiAtc3RlcC5yb3RhdGUueSwKICAgICAgICAgICAgICAgICAgICB6OiAtc3RlcC5yb3RhdGUuegogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHRyYW5zbGF0ZTogewogICAgICAgICAgICAgICAgICAgIHg6IC1zdGVwLnRyYW5zbGF0ZS54LAogICAgICAgICAgICAgICAgICAgIHk6IC1zdGVwLnRyYW5zbGF0ZS55LAogICAgICAgICAgICAgICAgICAgIHo6IC1zdGVwLnRyYW5zbGF0ZS56CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2NhbGU6IDEgLyBzdGVwLnNjYWxlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIAogICAgICAgICAgICBpZih0cmFuc2Zvcm1hdGlvbkNhbGxiYWNrKSB7IAogICAgICAgICAgICAgICAgdHJhbnNmb3JtYXRpb25DYWxsYmFjayh7CiAgICAgICAgICAgICAgICAgIHNjYWxlOnN0ZXAuc2NhbGUsCiAgICAgICAgICAgICAgICAgIHJvdGF0ZTpzdGVwLnJvdGF0ZSwKICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlOnN0ZXAudHJhbnNsYXRlCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIHRyYW5zaXRpb24gaXMgem9vbWluZyBpbiBvciBub3QuCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIC8vIFRoaXMgaW5mb3JtYXRpb24gaXMgdXNlZCB0byBhbHRlciB0aGUgdHJhbnNpdGlvbiBzdHlsZToKICAgICAgICAgICAgLy8gd2hlbiB3ZSBhcmUgem9vbWluZyBpbiAtIHdlIHN0YXJ0IHdpdGggbW92ZSBhbmQgcm90YXRlIHRyYW5zaXRpb24KICAgICAgICAgICAgLy8gYW5kIHRoZSBzY2FsaW5nIGlzIGRlbGF5ZWQsIGJ1dCB3aGVuIHdlIGFyZSB6b29taW5nIG91dCB3ZSBzdGFydAogICAgICAgICAgICAvLyB3aXRoIHNjYWxpbmcgZG93biBhbmQgbW92ZSBhbmQgcm90YXRpb24gYXJlIGRlbGF5ZWQuCiAgICAgICAgICAgIHZhciB6b29taW4gPSB0YXJnZXQuc2NhbGUgPj0gY3VycmVudFN0YXRlLnNjYWxlOwogICAgICAgICAgICAKICAgICAgICAgICAgZHVyYXRpb24gPSB0b051bWJlcihkdXJhdGlvbiwgY29uZmlnLnRyYW5zaXRpb25EdXJhdGlvbik7CiAgICAgICAgICAgIHZhciBkZWxheSA9IChkdXJhdGlvbiAvIDIpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gaWYgdGhlIHNhbWUgc3RlcCBpcyByZS1zZWxlY3RlZCwgZm9yY2UgY29tcHV0aW5nIHdpbmRvdyBzY2FsaW5nLAogICAgICAgICAgICAvLyBiZWNhdXNlIGl0IGlzIGxpa2VseSB0byBiZSBjYXVzZWQgYnkgd2luZG93IHJlc2l6ZQogICAgICAgICAgICBpZiAoZWwgPT09IGFjdGl2ZVN0ZXApIHsKICAgICAgICAgICAgICAgIHdpbmRvd1NjYWxlID0gY29tcHV0ZVdpbmRvd1NjYWxlKGNvbmZpZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciB0YXJnZXRTY2FsZSA9IHRhcmdldC5zY2FsZSAqIHdpbmRvd1NjYWxlOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gdHJpZ2dlciBsZWF2ZSBvZiBjdXJyZW50bHkgYWN0aXZlIGVsZW1lbnQgKGlmIGl0J3Mgbm90IHRoZSBzYW1lIHN0ZXAgYWdhaW4pCiAgICAgICAgICAgIGlmIChhY3RpdmVTdGVwICYmIGFjdGl2ZVN0ZXAgIT09IGVsKSB7CiAgICAgICAgICAgICAgICBvblN0ZXBMZWF2ZShhY3RpdmVTdGVwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTm93IHdlIGFsdGVyIHRyYW5zZm9ybXMgb2YgYHJvb3RgIGFuZCBgY2FudmFzYCB0byB0cmlnZ2VyIHRyYW5zaXRpb25zLgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBBbmQgaGVyZSBpcyB3aHkgdGhlcmUgYXJlIHR3byBlbGVtZW50czogYHJvb3RgIGFuZCBgY2FudmFzYCAtIHRoZXkgYXJlCiAgICAgICAgICAgIC8vIGJlaW5nIGFuaW1hdGVkIHNlcGFyYXRlbHk6CiAgICAgICAgICAgIC8vIGByb290YCBpcyB1c2VkIGZvciBzY2FsaW5nIGFuZCBgY2FudmFzYCBmb3IgdHJhbnNsYXRlIGFuZCByb3RhdGlvbnMuCiAgICAgICAgICAgIC8vIFRyYW5zaXRpb25zIG9uIHRoZW0gYXJlIHRyaWdnZXJlZCB3aXRoIGRpZmZlcmVudCBkZWxheXMgKHRvIG1ha2UKICAgICAgICAgICAgLy8gdmlzdWFsbHkgbmljZSBhbmQgJ25hdHVyYWwnIGxvb2tpbmcgdHJhbnNpdGlvbnMpLCBzbyB3ZSBuZWVkIHRvIGtub3cKICAgICAgICAgICAgLy8gdGhhdCBib3RoIG9mIHRoZW0gYXJlIGZpbmlzaGVkLgogICAgICAgICAgICBjc3Mocm9vdCwgewogICAgICAgICAgICAgICAgLy8gdG8ga2VlcCB0aGUgcGVyc3BlY3RpdmUgbG9vayBzaW1pbGFyIGZvciBkaWZmZXJlbnQgc2NhbGVzCiAgICAgICAgICAgICAgICAvLyB3ZSBuZWVkIHRvICdzY2FsZScgdGhlIHBlcnNwZWN0aXZlLCB0b28KICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogcGVyc3BlY3RpdmUoIGNvbmZpZy5wZXJzcGVjdGl2ZSAvIHRhcmdldFNjYWxlICkgKyBzY2FsZSggdGFyZ2V0U2NhbGUgKSwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvbjogZHVyYXRpb24gKyAibXMiLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbkRlbGF5OiAoem9vbWluID8gZGVsYXkgOiAwKSArICJtcyIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBjc3MoY2FudmFzLCB7CiAgICAgICAgICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSh0YXJnZXQucm90YXRlLCB0cnVlKSArIHRyYW5zbGF0ZSh0YXJnZXQudHJhbnNsYXRlKSwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25EdXJhdGlvbjogZHVyYXRpb24gKyAibXMiLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbkRlbGF5OiAoem9vbWluID8gMCA6IGRlbGF5KSArICJtcyIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBIZXJlIGlzIGEgdHJpY2t5IHBhcnQuLi4KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gY2hhbmdlIGluIHNjYWxlIG9yIG5vIGNoYW5nZSBpbiByb3RhdGlvbiBhbmQgdHJhbnNsYXRpb24sIGl0IG1lYW5zIHRoZXJlIHdhcyBhY3R1YWxseQogICAgICAgICAgICAvLyBubyBkZWxheSAtIGJlY2F1c2UgdGhlcmUgd2FzIG5vIHRyYW5zaXRpb24gb24gYHJvb3RgIG9yIGBjYW52YXNgIGVsZW1lbnRzLgogICAgICAgICAgICAvLyBXZSB3YW50IHRvIHRyaWdnZXIgYGltcHJlc3M6c3RlcGVudGVyYCBldmVudCBpbiB0aGUgY29ycmVjdCBtb21lbnQsIHNvIGhlcmUgd2UgY29tcGFyZSB0aGUgY3VycmVudAogICAgICAgICAgICAvLyBhbmQgdGFyZ2V0IHZhbHVlcyB0byBjaGVjayBpZiBkZWxheSBzaG91bGQgYmUgdGFrZW4gaW50byBhY2NvdW50LgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBJIGtub3cgdGhhdCB0aGlzIGBpZmAgc3RhdGVtZW50IGxvb2tzIHNjYXJ5LCBidXQgaXQncyBwcmV0dHkgc2ltcGxlIHdoZW4geW91IGtub3cgd2hhdCBpcyBnb2luZyBvbgogICAgICAgICAgICAvLyAtIGl0J3Mgc2ltcGx5IGNvbXBhcmluZyBhbGwgdGhlIHZhbHVlcy4KICAgICAgICAgICAgaWYgKCBjdXJyZW50U3RhdGUuc2NhbGUgPT09IHRhcmdldC5zY2FsZSB8fAogICAgICAgICAgICAgICAgKGN1cnJlbnRTdGF0ZS5yb3RhdGUueCA9PT0gdGFyZ2V0LnJvdGF0ZS54ICYmIGN1cnJlbnRTdGF0ZS5yb3RhdGUueSA9PT0gdGFyZ2V0LnJvdGF0ZS55ICYmCiAgICAgICAgICAgICAgICAgY3VycmVudFN0YXRlLnJvdGF0ZS56ID09PSB0YXJnZXQucm90YXRlLnogJiYgY3VycmVudFN0YXRlLnRyYW5zbGF0ZS54ID09PSB0YXJnZXQudHJhbnNsYXRlLnggJiYKICAgICAgICAgICAgICAgICBjdXJyZW50U3RhdGUudHJhbnNsYXRlLnkgPT09IHRhcmdldC50cmFuc2xhdGUueSAmJiBjdXJyZW50U3RhdGUudHJhbnNsYXRlLnogPT09IHRhcmdldC50cmFuc2xhdGUueikgKSB7CiAgICAgICAgICAgICAgICBkZWxheSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIHN0b3JlIGN1cnJlbnQgc3RhdGUKICAgICAgICAgICAgY3VycmVudFN0YXRlID0gdGFyZ2V0OwogICAgICAgICAgICBhY3RpdmVTdGVwID0gZWw7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBbmQgaGVyZSBpcyB3aGVyZSB3ZSB0cmlnZ2VyIGBpbXByZXNzOnN0ZXBlbnRlcmAgZXZlbnQuCiAgICAgICAgICAgIC8vIFdlIHNpbXBseSBzZXQgdXAgYSB0aW1lb3V0IHRvIGZpcmUgaXQgdGFraW5nIHRyYW5zaXRpb24gZHVyYXRpb24gKGFuZCBwb3NzaWJsZSBkZWxheSkgaW50byBhY2NvdW50LgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBJIHJlYWxseSB3YW50ZWQgdG8gbWFrZSBpdCBpbiBtb3JlIGVsZWdhbnQgd2F5LiBUaGUgYHRyYW5zaXRpb25lbmRgIGV2ZW50IHNlZW1lZCB0byBiZSB0aGUgYmVzdCB3YXkKICAgICAgICAgICAgLy8gdG8gZG8gaXQsIGJ1dCB0aGUgZmFjdCB0aGF0IEknbSB1c2luZyB0cmFuc2l0aW9ucyBvbiB0d28gc2VwYXJhdGUgZWxlbWVudHMgYW5kIHRoYXQgdGhlIGB0cmFuc2l0aW9uZW5kYAogICAgICAgICAgICAvLyBldmVudCBpcyBvbmx5IHRyaWdnZXJlZCB3aGVuIHRoZXJlIHdhcyBhIHRyYW5zaXRpb24gKGNoYW5nZSBpbiB0aGUgdmFsdWVzKSBjYXVzZWQgc29tZSBidWdzIGFuZCAKICAgICAgICAgICAgLy8gbWFkZSB0aGUgY29kZSByZWFsbHkgY29tcGxpY2F0ZWQsIGNhdXNlIEkgaGFkIHRvIGhhbmRsZSBhbGwgdGhlIGNvbmRpdGlvbnMgc2VwYXJhdGVseS4gQW5kIGl0IHN0aWxsCiAgICAgICAgICAgIC8vIG5lZWRlZCBhIGBzZXRUaW1lb3V0YCBmYWxsYmFjayBmb3IgdGhlIHNpdHVhdGlvbnMgd2hlbiB0aGVyZSBpcyBubyB0cmFuc2l0aW9uIGF0IGFsbC4KICAgICAgICAgICAgLy8gU28gSSBkZWNpZGVkIHRoYXQgSSdkIHJhdGhlciBtYWtlIHRoZSBjb2RlIHNpbXBsZXIgdGhhbiB1c2Ugc2hpbnkgbmV3IGB0cmFuc2l0aW9uZW5kYC4KICAgICAgICAgICAgLy8KICAgICAgICAgICAgLy8gSWYgeW91IHdhbnQgbGVhcm4gc29tZXRoaW5nIGludGVyZXN0aW5nIGFuZCBzZWUgaG93IGl0IHdhcyBkb25lIHdpdGggYHRyYW5zaXRpb25lbmRgIGdvIGJhY2sgdG8KICAgICAgICAgICAgLy8gdmVyc2lvbiAwLjUuMiBvZiBpbXByZXNzLmpzOiBodHRwOi8vZ2l0aHViLmNvbS9iYXJ0YXovaW1wcmVzcy5qcy9ibG9iLzAuNS4yL2pzL2ltcHJlc3MuanMKICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChzdGVwRW50ZXJUaW1lb3V0KTsKICAgICAgICAgICAgc3RlcEVudGVyVGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgb25TdGVwRW50ZXIoYWN0aXZlU3RlcCk7CiAgICAgICAgICAgIH0sIGR1cmF0aW9uICsgZGVsYXkpOwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGVsOwogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgLy8gYHByZXZgIEFQSSBmdW5jdGlvbiBnb2VzIHRvIHByZXZpb3VzIHN0ZXAgKGluIGRvY3VtZW50IG9yZGVyKQogICAgICAgIHZhciBfcHJldiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHByZXYgPSBzdGVwcy5pbmRleE9mKCBhY3RpdmVTdGVwICkgLSAxOwogICAgICAgICAgICBwcmV2ID0gcHJldiA+PSAwID8gc3RlcHNbIHByZXYgXSA6IHN0ZXBzWyBzdGVwcy5sZW5ndGgtMSBdOwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGdvdG8ocHJldik7CiAgICAgICAgfTsKICAgICAgICAKICAgICAgICAvLyBgbmV4dGAgQVBJIGZ1bmN0aW9uIGdvZXMgdG8gbmV4dCBzdGVwIChpbiBkb2N1bWVudCBvcmRlcikKICAgICAgICB2YXIgX25leHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBuZXh0ID0gc3RlcHMuaW5kZXhPZiggYWN0aXZlU3RlcCApICsgMTsKICAgICAgICAgICAgbmV4dCA9IG5leHQgPCBzdGVwcy5sZW5ndGggPyBzdGVwc1sgbmV4dCBdIDogc3RlcHNbIDAgXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBnb3RvKG5leHQpOwogICAgICAgIH07CiAgICAgICAgCiAgICAgICAgCiAvL1BBVENIIGZvciBNZW51CiAKICAgICAgICAgLy8gQ2FwaXRhbGl6ZSBmaXJzdCBsZXR0ZXIgb2Ygc3RyaW5nCiAgICAgICAgdmFyIGNhcGl0YWxpemUgPSBmdW5jdGlvbiggc3RyICkgewogICAgICAgICAgICByZXR1cm4gc3RyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyLnNsaWNlKDEpOwogICAgICAgIH07CgogICAgCiAgICAgICAgLy8gSXQgZGVmaW5lcyB0aGUgbmFtZXMgb2YgZWFjaCBlbnRyeSBieSB0aGUgaWQgY2FwaXRhbGl6ZWQuCiAgICAgICAgdmFyIHNob3dNZW51ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIENyZWF0ZSB0aGUgbWVudSB3cmFwcGVyIGFuZCB0aGUgZWxlbWVudCB0aGF0IHdpbGwgYmUgY2xvbmVkCiAgICAgICAgICAgIC8vIGZvciBlYWNoIGVudHJ5LgogICAgICAgICAgLy8gIGNvbnNvbGUubG9nKCdzaG93TWVudScpCiAgICAgICAgICAgIHZhciBtZW51ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksCiAgICAgICAgICAgICAgICBmcmFnID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICAgICAgICAgICAgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCiAgICAgICAgICAgIC8vIEFwcGx5IHNvbWUgY2xhc3NlcwogICAgICAgICAgICBtZW51LmNsYXNzTmFtZSA9ICdtZW51JzsKICAgICAgICAgICAgZWwuY2xhc3NOYW1lID0gJ21lbnUtaXRlbSc7CgogICAgICAgICAgICAvLyBDcmVhdGUgYW4gZWxlbWVudCB0aGF0IHdpbGwgYmUgdGhlICJidXR0b24iIGFuZCBhcHBlbmQgaXQKICAgICAgICAgICAgLy8gdG8gdGhlIG1lbnUKICAgICAgICAgICAgdmFyIGJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICBidXR0b24uY2xhc3NOYW1lID0gJ21lbnUtYnV0dG9uJzsKICAgICAgICAgICAgYnV0dG9uLnRleHRDb250ZW50ID0gJyc7CiAgICAgICAgICAgIG1lbnUuYXBwZW5kQ2hpbGQoYnV0dG9uKTsKCiAgICAgICAgICAgIC8vIE5vdywgZm9yIGVhY2ggZGl2IGluIHRoZSBmaXJzdCBlbGVtZW50IGNoaWxkIG9mICAjaW1wcmVzcywKICAgICAgICAgICAgLy8gYWRkIGFuIGVudHJ5IHRvIHRoZSBtZW51ICAgICAgICAgCiAgICAgICAgICAgICAgYXJyYXlpZnkoYnlJZCgnaW1wcmVzcycpLmZpcnN0RWxlbWVudENoaWxkLmNoaWxkcmVuKS5mb3JFYWNoKAogICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCBjaGlsZCwgaW5kZXggKSB7CiAgICAgICAgICAgICAgICAgICAgCQogICAgICAgICAgICAgICAgaWYgKCFjaGlsZC5jbGFzc0xpc3QuY29udGFpbnMoJ3N0ZXAnKSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIHZhciBuZXdFbCA9IGVsLmNsb25lTm9kZSgpLAogICAgICAgICAgICAgICAgICAgIGkgPSBpbmRleCArIDEsIC8vIFdlIGRvbid0IHdhbnQgdG8gc3RhcnQgYXQgMAogICAgICAgICAgICAgICAgICAgIHRleHQgPSBpICsgJy4gJyArIGNhcGl0YWxpemUoY2hpbGQuaWQpOwoKICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgdGV4dCBvZiB0aGUgbmV3IGVsZW1lbnQKICAgICAgICAgICAgICAgIG5ld0VsLmlubmVySFRNTCA9ICc8YSBocmVmPSIjLycrY2hpbGQuaWQrJyIgdGl0bGU9IicrdGV4dCsnIj4mYnVsbDs8L2E+JzsKICAgICAgICAgICAgICAgIG5ld0VsLmlkID0gIm0tIiArIGNoaWxkLmlkOwoKICAgICAgICAgICAgICAgIC8vIEFkZCBhbiBvbmNsaWNrIGV2ZW50IHRvIHRoZSBuZXcgZWxlbWVudAogICAgICAgICAgICAgICAgLy8gV2UgbmVlZCB0byB1c2UgYSBjbG9zdXJlIHRvIG1ha2Ugc3VyZSB0aGUgaW5kZXggaXMgY29ycmVjdAogICAgICAgICAgICAgICAgKGZ1bmN0aW9uKCBpbmRleCwgaWQgKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3RWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ290byhpbmRleCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgbmV3RWwuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VvdmVyJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgCXZhciBiYXNlVVJMID0gZG9jdW1lbnQuVVJMLnN1YnN0cmluZygwLCBkb2N1bWVudC5VUkwuc2VhcmNoKCcjLycpKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uLmlubmVySFRNTCA9ICc8aWZyYW1lIHNyYz0iJytiYXNlVVJMKyI/cHJldmlldyMvIitpZCsnIj4nOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIG5ld0VsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlb3V0JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbi5pbm5lckhUTUwgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0oIGluZGV4LCBjaGlsZC5pZCApKTsKCiAgICAgICAgICAgICAgICAvLyBBbmQgYXBwZW5kIHRoZSBuZXcgZWxlbWVudCB0byB0aGUgbWVudQogICAgICAgICAgICAgICAgZnJhZy5hcHBlbmRDaGlsZChuZXdFbCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gQWRkIHRoZSBmcmFnIHRvIHRoZSBtZW51CiAgICAgICAgICAgIG1lbnUuYXBwZW5kQ2hpbGQoZnJhZyk7CgogICAgICAgICAgICAvLyBBbmQgYXBwZW5kIHRoZSBtZW51IHRvIHRoZSBib2R5LgogICAgICAgICAgICAvLyBBcHBlbmRpbmcgaXQgdG8gI2ltcHJlc3Mgd291bGQgbWVzcyB0aGluZ3MgdXAsIHNpbmNlCiAgICAgICAgICAgIC8vIGBwb3NpdGlvbjogYWJzb2x1dGVgIHdvdWxkbid0IHdvcmsgYW55bW9yZSBpbiBpdC4KICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChtZW51KTsKICAgICAgICB9OwogCiAvL0VORCBQQVRDSAogICAgICAgIAogLy9QQVRDSCBmb3IgU1VCU1RFUFMKIAl2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLAogICAgICAgIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAogICAgICAgIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5OwogICAgICAgIAogICAgdmFyIHJlbW92ZUNsYXNzID0gZnVuY3Rpb24gKGVsbSwgY2xhc3NOYW1lKSB7CiAgICBpZiAoZWxtLmNsYXNzTGlzdCkgewogICAgICAgICAgICBlbG0uY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKCFlbG0gfHwgIWVsbS5jbGFzc05hbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVnZXhwID0gbmV3IFJlZ0V4cCgiKF58XFxzKSIgKyBjbGFzc05hbWUgKyAiKFxcc3wkKSIsICJnIik7CiAgICAgICAgICAgIGVsbS5jbGFzc05hbWUgPSBlbG0uY2xhc3NOYW1lLnJlcGxhY2UocmVnZXhwLCAiJDIiKTsKICAgIH0KCX0KICAgIAogCiAgICB2YXIgc2V0UHJldmlvdXMgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgIGlmIChpc0FycmF5KGRhdGEpKSB7CiAgICAgICAgICAgIGRhdGEuZm9yRWFjaChzZXRQcmV2aW91cyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy9yZW1vdmVDbGFzcyhkYXRhLCdhY3RpdmUnKTsKICAgICAgICAvL2RhdGEuY2xhc3NOYW1lID0gZGF0YS5jbGFzc05hbWUgKyAnIHByZXZpb3VzJzsKICAgICAgICBkYXRhLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgIGRhdGEuY2xhc3NMaXN0LmFkZCgncHJldmlvdXMnKTsKICAgIH07CgogICAgdmFyIHNldEFjdGl2ZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgaWYgKGlzQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgZGF0YS5mb3JFYWNoKHNldEFjdGl2ZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy9yZW1vdmVDbGFzcyhkYXRhLCdwcmV2aW91cycpOwogICAgICAgIC8vZGF0YS5jbGFzc05hbWUgPSBkYXRhLmNsYXNzTmFtZSArICcgYWN0aXZlJzsKICAgICAgICBkYXRhLmNsYXNzTGlzdC5yZW1vdmUoJ3ByZXZpb3VzJyk7CiAgICAgICAgZGF0YS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgIH07CgogICAgdmFyIGNsZWFyU3ViID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICBpZiAoaXNBcnJheShkYXRhKSkgewogICAgICAgICAgICBkYXRhLmZvckVhY2goY2xlYXJTdWIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIC8vcmVtb3ZlQ2xhc3MoZGF0YSwncHJldmlvdXMnKTsKICAgICAgICAvL3JlbW92ZUNsYXNzKGRhdGEsJ2FjdGl2ZScpOwogICAgICAgIGRhdGEuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgZGF0YS5jbGFzc0xpc3QucmVtb3ZlKCdwcmV2aW91cycpOwogICAgfTsKIAogCXZhciBuZXh0ID0gZnVuY3Rpb24gKCkgewogCQl2YXIgYWN0aXZlID0gYWN0aXZlU3RlcDsKIAkJCiAgICAgICAgdmFyIHN1YmFjdGl2ZSwgbmV4dCwgc3ViU3RlcHM7CiAgICAgICAgCiAgICAgICAgaWYgKCFhY3RpdmUuc3ViU3RlcHMpIHsKICAgICAgICAgICAgc2V0U3ViU3RlcHMoYWN0aXZlKTsKICAgICAgICB9CiAgICAgICAgc3ViU3RlcHMgPSBhY3RpdmUuc3ViU3RlcHM7CiAgICAgICAgaWYgKHN1YlN0ZXBzLmxlbmd0aCAmJiAoKHN1YmFjdGl2ZSA9IHN1YlN0ZXBzLmFjdGl2ZSkgIT09IChzdWJTdGVwcy5sZW5ndGggLSAxKSkpIHsKICAgICAgICAgICAgaWYgKHN1YmFjdGl2ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRQcmV2aW91cyhzdWJTdGVwc1tzdWJhY3RpdmVdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN1YmFjdGl2ZSA9IC0xOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldEFjdGl2ZShzdWJTdGVwc1srK3N1YmFjdGl2ZV0pOwogICAgICAgICAgICBzdWJTdGVwcy5hY3RpdmUgPSBzdWJhY3RpdmU7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgbmV4dCA9IHN0ZXBzLmluZGV4T2YoIGFjdGl2ZSApICsgMTsKICAgICAgICBuZXh0ID0gbmV4dCA8IHN0ZXBzLmxlbmd0aCA/IHN0ZXBzWyBuZXh0IF0gOiBzdGVwc1sgMCBdOwogICAgICAgIGlmICghbmV4dC5zdWJTdGVwcykgewogICAgICAgICAgICBzZXRTdWJTdGVwcyhuZXh0KTsKICAgICAgICB9CiAgICAgICAgaWYgKG5leHQuc3ViU3RlcHMuYWN0aXZlICE9IG51bGwpIHsKICAgICAgICAgICAgZm9yRWFjaC5jYWxsKG5leHQuc3ViU3RlcHMsIGNsZWFyU3ViKTsKICAgICAgICAgICAgbmV4dC5zdWJTdGVwcy5hY3RpdmUgPSBudWxsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZ290byhuZXh0KTsKICAgIH07CiAKIAl2YXIgcHJldiA9IGZ1bmN0aW9uICgpIHsKIAkJdmFyIGFjdGl2ZSA9IGFjdGl2ZVN0ZXA7CiAJCQogICAgICAgIHZhciBzdWJhY3RpdmUsIG5leHQsIHN1YlN0ZXBzOwogICAgICAgIGlmICghYWN0aXZlLnN1YlN0ZXBzKSB7CiAgICAgICAgICAgIHNldFN1YlN0ZXBzKGFjdGl2ZSk7CiAgICAgICAgfQogICAgICAgIHN1YlN0ZXBzID0gYWN0aXZlLnN1YlN0ZXBzOwogICAgICAgIGlmIChzdWJTdGVwcy5sZW5ndGggJiYgKChzdWJhY3RpdmUgPSBzdWJTdGVwcy5hY3RpdmUpIHx8IChzdWJhY3RpdmUgPT09IDApKSkgewogICAgICAgICAgICBjbGVhclN1YihzdWJTdGVwc1tzdWJhY3RpdmVdKTsKICAgICAgICAgICAgaWYgKHN1YmFjdGl2ZSkgewogICAgICAgICAgICAgICAgc2V0QWN0aXZlKHN1YlN0ZXBzWy0tc3ViYWN0aXZlXSk7CiAgICAgICAgICAgICAgICBzdWJTdGVwcy5hY3RpdmUgPSBzdWJhY3RpdmU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdWJTdGVwcy5hY3RpdmUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgbmV4dCA9IHN0ZXBzLmluZGV4T2YoIGFjdGl2ZSApIC0gMTsKICAgICAgICBuZXh0ID0gbmV4dCA+PSAwID8gc3RlcHNbIG5leHQgXSA6IHN0ZXBzWyBzdGVwcy5sZW5ndGgtMSBdOwogICAgICAgIGlmICghbmV4dC5zdWJTdGVwcykgewogICAgICAgICAgICBzZXRTdWJTdGVwcyhuZXh0KTsKICAgICAgICB9CiAgICAgICAgaWYgKG5leHQuc3ViU3RlcHMubGVuZ3RoICYmCiAgICAgICAgICAgIChuZXh0LnN1YlN0ZXBzLmFjdGl2ZSAhPT0gKG5leHQuc3ViU3RlcHMubGVuZ3RoIC0gMSkpKSB7CiAgICAgICAgICAgIHNsaWNlLmNhbGwobmV4dC5zdWJTdGVwcywgMCwgLTEpLmZvckVhY2goc2V0UHJldmlvdXMpOwogICAgICAgICAgICBzZXRBY3RpdmUobmV4dC5zdWJTdGVwc1tuZXh0LnN1YlN0ZXBzLmxlbmd0aCAtIDFdKTsKICAgICAgICAgICAgbmV4dC5zdWJTdGVwcy5hY3RpdmUgPSBuZXh0LnN1YlN0ZXBzLmxlbmd0aCAtIDE7CiAgICAgICAgfQogICAgICAgIHJldHVybiBnb3RvKG5leHQpOwogICAgfTsKIAoJIHZhciBzZXRTdWJTdGVwcyA9IGZ1bmN0aW9uIChlbCkgewogICAgICAgIHZhciBzdGVwcyA9IGVsLnF1ZXJ5U2VsZWN0b3JBbGwoIi5zdWJzdGVwIiksCiAgICAgICAgb3JkZXIgPSBbXSwgdW5vcmRlcmVkID0gW107CiAgICAgICAgZm9yRWFjaC5jYWxsKHN0ZXBzLCBmdW5jdGlvbiAoZWwpIHsKICAgICAgICAJaWYgKGVsLmRhdGFzZXQpIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0gTnVtYmVyKGVsLmRhdGFzZXQub3JkZXIpOwogICAgICAgICAgICBpZiAoIWlzTmFOKGluZGV4KSkgewogICAgICAgICAgICAgICAgaWYgKCFvcmRlcltpbmRleF0pIHsKICAgICAgICAgICAgICAgICAgICBvcmRlcltpbmRleF0gPSBlbDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShvcmRlcltpbmRleF0pKSB7CiAgICAgICAgICAgICAgICAgICAgb3JkZXJbaW5kZXhdLnB1c2goZWwpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBvcmRlcltpbmRleF0gPSBbb3JkZXJbaW5kZXhdLCBlbF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1bm9yZGVyZWQucHVzaChlbCk7CiAgICAgICAgICAgIH0gfSBlbHNlIHsKICAgICAgICAgICAgCXVub3JkZXJlZC5wdXNoKGVsKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGVsLnN1YlN0ZXBzID0gb3JkZXIuZmlsdGVyKEJvb2xlYW4pLmNvbmNhdCh1bm9yZGVyZWQpOwogICAgfTsKIAogLy9FTkQgUEFUQ0ggICAgICAgCiAgICAgICAgCiAgICAgICAgLy8gQWRkaW5nIHNvbWUgdXNlZnVsIGNsYXNzZXMgdG8gc3RlcCBlbGVtZW50cy4KICAgICAgICAvLwogICAgICAgIC8vIEFsbCB0aGUgc3RlcHMgdGhhdCBoYXZlIG5vdCBiZWVuIHNob3duIHlldCBhcmUgZ2l2ZW4gYGZ1dHVyZWAgY2xhc3MuCiAgICAgICAgLy8gV2hlbiB0aGUgc3RlcCBpcyBlbnRlcmVkIHRoZSBgZnV0dXJlYCBjbGFzcyBpcyByZW1vdmVkIGFuZCB0aGUgYHByZXNlbnRgCiAgICAgICAgLy8gY2xhc3MgaXMgZ2l2ZW4uIFdoZW4gdGhlIHN0ZXAgaXMgbGVmdCBgcHJlc2VudGAgY2xhc3MgaXMgcmVwbGFjZWQgd2l0aAogICAgICAgIC8vIGBwYXN0YCBjbGFzcy4KICAgICAgICAvLwogICAgICAgIC8vIFNvIGV2ZXJ5IHN0ZXAgZWxlbWVudCBpcyBhbHdheXMgaW4gb25lIG9mIHRocmVlIHBvc3NpYmxlIHN0YXRlczoKICAgICAgICAvLyBgZnV0dXJlYCwgYHByZXNlbnRgIGFuZCBgcGFzdGAuCiAgICAgICAgLy8KICAgICAgICAvLyBUaGVyZSBjbGFzc2VzIGNhbiBiZSB1c2VkIGluIENTUyB0byBzdHlsZSBkaWZmZXJlbnQgdHlwZXMgb2Ygc3RlcHMuCiAgICAgICAgLy8gRm9yIGV4YW1wbGUgdGhlIGBwcmVzZW50YCBjbGFzcyBjYW4gYmUgdXNlZCB0byB0cmlnZ2VyIHNvbWUgY3VzdG9tCiAgICAgICAgLy8gYW5pbWF0aW9ucyB3aGVuIHN0ZXAgaXMgc2hvd24uCiAgICAgICAgcm9vdC5hZGRFdmVudExpc3RlbmVyKCJpbXByZXNzOmluaXQiLCBmdW5jdGlvbigpewogICAgICAgIAkKICAgICAgICAJdmFyIF9hZGQgPSBmdW5jdGlvbihkb20sIGMpIHsKICAgICAgICAJCWRvbS5jbGFzc0xpc3QuYWRkKGMpOwogICAgICAgIAkJdmFyIG1fZG9tID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm0tIitkb20uaWQpOwogICAgICAgIAkJaWYgKG1fZG9tKSBtX2RvbS5jbGFzc0xpc3QuYWRkKGMpOwogICAgICAgIAl9CiAgICAgICAgCQogICAgICAgIAl2YXIgX3JlbW92ZSA9IGZ1bmN0aW9uKGRvbSwgYykgewogICAgICAgIAkJZG9tLmNsYXNzTGlzdC5yZW1vdmUoYyk7CiAgICAgICAgCQl2YXIgbV9kb20gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibS0iK2RvbS5pZCk7CiAgICAgICAgCQlpZiAobV9kb20pIG1fZG9tLmNsYXNzTGlzdC5yZW1vdmUoYyk7ICAgICAgICAJCQogICAgICAgIAl9CiAgICAgICAgCQogICAgICAgICAgICAvLyBTVEVQIENMQVNTRVMKICAgICAgICAgICAgc3RlcHMuZm9yRWFjaChmdW5jdGlvbiAoc3RlcCkgewogICAgICAgICAgICAJX2FkZChzdGVwLCJmdXR1cmUiKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICByb290LmFkZEV2ZW50TGlzdGVuZXIoImltcHJlc3M6c3RlcGVudGVyIiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIAlfYWRkKGV2ZW50LnRhcmdldCwicHJlc2VudCIpOwogICAgICAgICAgICAJX3JlbW92ZShldmVudC50YXJnZXQsInBhc3QiKTsKICAgICAgICAgICAgCV9yZW1vdmUoZXZlbnQudGFyZ2V0LCJmdXR1cmUiKTsKLy8gICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LmNsYXNzTGlzdC5yZW1vdmUoInBhc3QiKTsKIC8vICAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0LmNsYXNzTGlzdC5yZW1vdmUoImZ1dHVyZSIpOwogLy8gICAgICAgICAgICAgICBldmVudC50YXJnZXQuY2xhc3NMaXN0LmFkZCgicHJlc2VudCIpOwogICAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICByb290LmFkZEV2ZW50TGlzdGVuZXIoImltcHJlc3M6c3RlcGxlYXZlIiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIAlfcmVtb3ZlKGV2ZW50LnRhcmdldCwicHJlc2VudCIpOwogICAgICAgICAgICAJX2FkZChldmVudC50YXJnZXQsInBhc3QiKTsgICAgICAgICAgCQovLyAgICAgICAgICAgICAgICBldmVudC50YXJnZXQuY2xhc3NMaXN0LnJlbW92ZSgicHJlc2VudCIpOwovLyAgICAgICAgICAgICAgICBldmVudC50YXJnZXQuY2xhc3NMaXN0LmFkZCgicGFzdCIpOwogICAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgICAgIAogICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAKICAgICAgICAvLyBBZGRpbmcgaGFzaCBjaGFuZ2Ugc3VwcG9ydC4KICAgICAgICByb290LmFkZEV2ZW50TGlzdGVuZXIoImltcHJlc3M6aW5pdCIsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBsYXN0IGhhc2ggZGV0ZWN0ZWQKICAgICAgICAgICAgdmFyIGxhc3RIYXNoID0gIiI7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBgIy9zdGVwLWlkYCBpcyB1c2VkIGluc3RlYWQgb2YgYCNzdGVwLWlkYCB0byBwcmV2ZW50IGRlZmF1bHQgYnJvd3NlcgogICAgICAgICAgICAvLyBzY3JvbGxpbmcgdG8gZWxlbWVudCBpbiBoYXNoLgogICAgICAgICAgICAvLwogICAgICAgICAgICAvLyBBbmQgaXQgaGFzIHRvIGJlIHNldCBhZnRlciBhbmltYXRpb24gZmluaXNoZXMsIGJlY2F1c2UgaW4gQ2hyb21lIGl0CiAgICAgICAgICAgIC8vIG1ha2VzIHRyYW5zdGlvbiBsYWdneS4KICAgICAgICAgICAgLy8gQlVHOiBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD02MjgyMAogICAgICAgICAgICByb290LmFkZEV2ZW50TGlzdGVuZXIoImltcHJlc3M6c3RlcGVudGVyIiwgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaGFzaCA9IGxhc3RIYXNoID0gIiMvIiArIGV2ZW50LnRhcmdldC5pZDsKICAgICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgICAgICAKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImhhc2hjaGFuZ2UiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAvLyBXaGVuIHRoZSBzdGVwIGlzIGVudGVyZWQgaGFzaCBpbiB0aGUgbG9jYXRpb24gaXMgdXBkYXRlZAogICAgICAgICAgICAgICAgLy8gKGp1c3QgZmV3IGxpbmVzIGFib3ZlIGZyb20gaGVyZSksIHNvIHRoZSBoYXNoIGNoYW5nZSBpcyAKICAgICAgICAgICAgICAgIC8vIHRyaWdnZXJlZCBhbmQgd2Ugd291bGQgY2FsbCBgZ290b2AgYWdhaW4gb24gdGhlIHNhbWUgZWxlbWVudC4KICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAvLyBUbyBhdm9pZCB0aGlzIHdlIHN0b3JlIGxhc3QgZW50ZXJlZCBoYXNoIGFuZCBjb21wYXJlLgogICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5sb2NhdGlvbi5oYXNoICE9PSBsYXN0SGFzaCkgewogICAgICAgICAgICAgICAgICAgIGdvdG8oIGdldEVsZW1lbnRGcm9tSGFzaCgpICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNUQVJUIAogICAgICAgICAgICAvLyBieSBzZWxlY3Rpbmcgc3RlcCBkZWZpbmVkIGluIHVybCBvciBmaXJzdCBzdGVwIG9mIHRoZSBwcmVzZW50YXRpb24KICAgICAgICAgICAgZ290byhnZXRFbGVtZW50RnJvbUhhc2goKSB8fCBzdGVwc1swXSwgMCk7CiAgICAgICAgfSwgZmFsc2UpOwogICAgICAgIAogICAgICAgIGJvZHkuY2xhc3NMaXN0LmFkZCgiaW1wcmVzcy1kaXNhYmxlZCIpOwogICAgICAgIAogICAgICAgIC8vIHN0b3JlIGFuZCByZXR1cm4gQVBJIGZvciBnaXZlbiBpbXByZXNzLmpzIHJvb3QgZWxlbWVudAogICAgICAgIHJldHVybiAocm9vdHNbICJpbXByZXNzLXJvb3QtIiArIHJvb3RJZCBdID0gewogICAgICAgICAgICBpbml0OiBpbml0LAogICAgICAgICAgICBnb3RvOiBnb3RvLAogICAgICAgICAgICBuZXh0OiBuZXh0LAogICAgICAgICAgICBwcmV2OiBwcmV2LAogICAgICAgICAgICBpbml0U3RlcDogaW5pdFN0ZXAsCiAgICAgICAgICAgIG5ld1N0ZXA6bmV3U3RlcCwKICAgICAgICAgICAgc2V0VHJhbnNmb3JtYXRpb25DYWxsYmFjazpzZXRUcmFuc2Zvcm1hdGlvbkNhbGxiYWNrLAogICAgICAgICAgICBzaG93TWVudTogc2hvd01lbnUKICAgICAgICB9KTsKCiAgICB9OwogICAgCiAgICAvLyBmbGFnIHRoYXQgY2FuIGJlIHVzZWQgaW4gSlMgdG8gY2hlY2sgaWYgYnJvd3NlciBoYXZlIHBhc3NlZCB0aGUgc3VwcG9ydCB0ZXN0CiAgICBpbXByZXNzLnN1cHBvcnRlZCA9IGltcHJlc3NTdXBwb3J0ZWQ7CiAgICAKfSkoZG9jdW1lbnQsIHdpbmRvdyk7CgovLyBOQVZJR0FUSU9OIEVWRU5UUwoKLy8gQXMgeW91IGNhbiBzZWUgdGhpcyBwYXJ0IGlzIHNlcGFyYXRlIGZyb20gdGhlIGltcHJlc3MuanMgY29yZSBjb2RlLgovLyBJdCdzIGJlY2F1c2UgdGhlc2UgbmF2aWdhdGlvbiBhY3Rpb25zIG9ubHkgbmVlZCB3aGF0IGltcHJlc3MuanMgcHJvdmlkZXMgd2l0aAovLyBpdHMgc2ltcGxlIEFQSS4KLy8KLy8gSW4gZnV0dXJlIEkgdGhpbmsgYWJvdXQgbW92aW5nIGl0IHRvIG1ha2UgdGhlbSBvcHRpb25hbCwgbW92ZSB0byBzZXBhcmF0ZSBmaWxlcwovLyBhbmQgdHJlYXQgbW9yZSBsaWtlIGEgJ3BsdWdpbnMnLgooZnVuY3Rpb24gKCBkb2N1bWVudCwgd2luZG93ICkgewogICAgJ3VzZSBzdHJpY3QnOwogICAgCiAgICAvLyB0aHJvdHRsaW5nIGZ1bmN0aW9uIGNhbGxzLCBieSBSZW15IFNoYXJwCiAgICAvLyBodHRwOi8vcmVteXNoYXJwLmNvbS8yMDEwLzA3LzIxL3Rocm90dGxpbmctZnVuY3Rpb24tY2FsbHMvCiAgICB2YXIgdGhyb3R0bGUgPSBmdW5jdGlvbiAoZm4sIGRlbGF5KSB7CiAgICAgICAgdmFyIHRpbWVyID0gbnVsbDsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IHRoaXMsIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7CiAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBmbi5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgICAgfSwgZGVsYXkpOwogICAgICAgIH07CiAgICB9OwogICAgCiAgICAvLyB3YWl0IGZvciBpbXByZXNzLmpzIHRvIGJlIGluaXRpYWxpemVkCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJpbXByZXNzOmluaXQiLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAvLyBHZXR0aW5nIEFQSSBmcm9tIGV2ZW50IGRhdGEuCiAgICAgICAgLy8gU28geW91IGRvbid0IGV2ZW50IG5lZWQgdG8ga25vdyB3aGF0IGlzIHRoZSBpZCBvZiB0aGUgcm9vdCBlbGVtZW50CiAgICAgICAgLy8gb3IgYW55dGhpbmcuIGBpbXByZXNzOmluaXRgIGV2ZW50IGRhdGEgZ2l2ZXMgeW91IGV2ZXJ5dGhpbmcgeW91IAogICAgICAgIC8vIG5lZWQgdG8gY29udHJvbCB0aGUgcHJlc2VudGF0aW9uIHRoYXQgd2FzIGp1c3QgaW5pdGlhbGl6ZWQuCiAgICAgICAgdmFyIGFwaSA9IGV2ZW50LmRldGFpbC5hcGk7CiAgICAgICAgCiAgICAgICAgLy8gS0VZQk9BUkQgTkFWSUdBVElPTiBIQU5ETEVSUwogICAgICAgIAogICAgICAgIC8vIFByZXZlbnQgZGVmYXVsdCBrZXlkb3duIGFjdGlvbiB3aGVuIG9uZSBvZiBzdXBwb3J0ZWQga2V5IGlzIHByZXNzZWQuCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigia2V5ZG93biIsIGZ1bmN0aW9uICggZXZlbnQgKSB7CiAgICAgICAgICAgIGlmICggZXZlbnQua2V5Q29kZSA9PT0gOSB8fCAoIGV2ZW50LmtleUNvZGUgPj0gMzIgJiYgZXZlbnQua2V5Q29kZSA8PSAzNCApIHx8IChldmVudC5rZXlDb2RlID49IDM3ICYmIGV2ZW50LmtleUNvZGUgPD0gNDApICkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAKICAgICAgICAvLyBUcmlnZ2VyIGltcHJlc3MgYWN0aW9uIChuZXh0IG9yIHByZXYpIG9uIGtleXVwLgogICAgICAgIAogICAgICAgIC8vIFN1cHBvcnRlZCBrZXlzIGFyZToKICAgICAgICAvLyBbc3BhY2VdIC0gcXVpdGUgY29tbW9uIGluIHByZXNlbnRhdGlvbiBzb2Z0d2FyZSB0byBtb3ZlIGZvcndhcmQKICAgICAgICAvLyBbdXBdIFtyaWdodF0gLyBbZG93bl0gW2xlZnRdIC0gYWdhaW4gY29tbW9uIGFuZCBuYXR1cmFsIGFkZGl0aW9uLAogICAgICAgIC8vIFtwZ2Rvd25dIC8gW3BndXBdIC0gb2Z0ZW4gdHJpZ2dlcmVkIGJ5IHJlbW90ZSBjb250cm9sbGVycywKICAgICAgICAvLyBbdGFiXSAtIHRoaXMgb25lIGlzIHF1aXRlIGNvbnRyb3ZlcnNpYWwsIGJ1dCB0aGUgcmVhc29uIGl0IGVuZGVkIHVwIG9uCiAgICAgICAgLy8gICB0aGlzIGxpc3QgaXMgcXVpdGUgYW4gaW50ZXJlc3Rpbmcgc3RvcnkuLi4gUmVtZW1iZXIgdGhhdCBzdHJhbmdlIHBhcnQKICAgICAgICAvLyAgIGluIHRoZSBpbXByZXNzLmpzIGNvZGUgd2hlcmUgd2luZG93IGlzIHNjcm9sbGVkIHRvIDAsMCBvbiBldmVyeSBwcmVzZW50YXRpb24KICAgICAgICAvLyAgIHN0ZXAsIGJlY2F1c2Ugc29tZXRpbWVzIGJyb3dzZXIgc2Nyb2xscyB2aWV3cG9ydCBiZWNhdXNlIG9mIHRoZSBmb2N1c2VkIGVsZW1lbnQ/CiAgICAgICAgLy8gICBXZWxsLCB0aGUgW3RhYl0ga2V5IGJ5IGRlZmF1bHQgbmF2aWdhdGVzIGFyb3VuZCBmb2N1c2FibGUgZWxlbWVudHMsIHNvIGNsaWNraW5nCiAgICAgICAgLy8gICBpdCB2ZXJ5IG9mdGVuIGNhdXNlZCBzY3JvbGxpbmcgdG8gZm9jdXNlZCBlbGVtZW50IGFuZCBicmVha2luZyBpbXByZXNzLmpzCiAgICAgICAgLy8gICBwb3NpdGlvbmluZy4gSSBkaWRuJ3Qgd2FudCB0byBqdXN0IHByZXZlbnQgdGhpcyBkZWZhdWx0IGFjdGlvbiwgc28gSSB1c2VkIFt0YWJdCiAgICAgICAgLy8gICBhcyBhbm90aGVyIHdheSB0byBtb3ZpbmcgdG8gbmV4dCBzdGVwLi4uIEFuZCB5ZXMsIEkga25vdyB0aGF0IGZvciB0aGUgc2FrZSBvZgogICAgICAgIC8vICAgY29uc2lzdGVuY3kgSSBzaG91bGQgYWRkIFtzaGlmdCt0YWJdIGFzIG9wcG9zaXRlIGFjdGlvbi4uLgogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleXVwIiwgZnVuY3Rpb24gKCBldmVudCApIHsKICAgICAgICAgICAgaWYgKCBldmVudC5rZXlDb2RlID09PSA5IHx8ICggZXZlbnQua2V5Q29kZSA+PSAzMiAmJiBldmVudC5rZXlDb2RlIDw9IDM0ICkgfHwgKGV2ZW50LmtleUNvZGUgPj0gMzcgJiYgZXZlbnQua2V5Q29kZSA8PSA0MCkgKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2goIGV2ZW50LmtleUNvZGUgKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAzMzogLy8gcGcgdXAKICAgICAgICAgICAgICAgICAgICBjYXNlIDM3OiAvLyBsZWZ0CiAgICAgICAgICAgICAgICAgICAgY2FzZSAzODogLy8gdXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcGkucHJldigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgOTogIC8vIHRhYgogICAgICAgICAgICAgICAgICAgIGNhc2UgMzI6IC8vIHNwYWNlCiAgICAgICAgICAgICAgICAgICAgY2FzZSAzNDogLy8gcGcgZG93bgogICAgICAgICAgICAgICAgICAgIGNhc2UgMzk6IC8vIHJpZ2h0CiAgICAgICAgICAgICAgICAgICAgY2FzZSA0MDogLy8gZG93bgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwaS5uZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgCiAgICAgICAgLy8gZGVsZWdhdGVkIGhhbmRsZXIgZm9yIGNsaWNraW5nIG9uIHRoZSBsaW5rcyB0byBwcmVzZW50YXRpb24gc3RlcHMKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uICggZXZlbnQgKSB7CiAgICAgICAgICAgIC8vIGV2ZW50IGRlbGVnYXRpb24gd2l0aCAiYnViYmxpbmciCiAgICAgICAgICAgIC8vIGNoZWNrIGlmIGV2ZW50IHRhcmdldCAob3IgYW55IG9mIGl0cyBwYXJlbnRzIGlzIGEgbGluaykKICAgICAgICAgICAgdmFyIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKICAgICAgICAgICAgd2hpbGUgKCAodGFyZ2V0LnRhZ05hbWUgIT09ICJBIikgJiYKICAgICAgICAgICAgICAgICAgICAodGFyZ2V0ICE9PSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpICkgewogICAgICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICggdGFyZ2V0LnRhZ05hbWUgPT09ICJBIiApIHsKICAgICAgICAgICAgICAgIHZhciBocmVmID0gdGFyZ2V0LmdldEF0dHJpYnV0ZSgiaHJlZiIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBpZiBpdCdzIGEgbGluayB0byBwcmVzZW50YXRpb24gc3RlcCwgdGFyZ2V0IHRoaXMgc3RlcAogICAgICAgICAgICAgICAgaWYgKCBocmVmICYmIGhyZWZbMF0gPT09ICcjJyApIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggaHJlZi5zbGljZSgxKSApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIGFwaS5nb3RvKHRhcmdldCkgKSB7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgCiAgICAgICAgLy8gZGVsZWdhdGVkIGhhbmRsZXIgZm9yIGNsaWNraW5nIG9uIHN0ZXAgZWxlbWVudHMKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGZ1bmN0aW9uICggZXZlbnQgKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBldmVudC50YXJnZXQ7CiAgICAgICAgICAgIC8vIGZpbmQgY2xvc2VzdCBzdGVwIGVsZW1lbnQgdGhhdCBpcyBub3QgYWN0aXZlCiAgICAgICAgICAgIHdoaWxlICggISh0YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKCJzdGVwIikgJiYgIXRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoImFjdGl2ZSIpKSAmJgogICAgICAgICAgICAgICAgICAgICh0YXJnZXQgIT09IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgKSB7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCBhcGkuZ290byh0YXJnZXQpICkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAKICAgICAgICAvLyB0b3VjaCBoYW5kbGVyIHRvIGRldGVjdCB0YXBzIG9uIHRoZSBsZWZ0IGFuZCByaWdodCBzaWRlIG9mIHRoZSBzY3JlZW4KICAgICAgICAvLyBiYXNlZCBvbiBhd2Vzb21lIHdvcmsgb2YgQGhha2ltZWw6IGh0dHBzOi8vZ2l0aHViLmNvbS9oYWtpbWVsL3JldmVhbC5qcwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoInRvdWNoc3RhcnQiLCBmdW5jdGlvbiAoIGV2ZW50ICkgewogICAgICAgICAgICBpZiAoZXZlbnQudG91Y2hlcy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgIHZhciB4ID0gZXZlbnQudG91Y2hlc1swXS5jbGllbnRYLAogICAgICAgICAgICAgICAgICAgIHdpZHRoID0gd2luZG93LmlubmVyV2lkdGggKiAwLjMsCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICggeCA8IHdpZHRoICkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGFwaS5wcmV2KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCB4ID4gd2luZG93LmlubmVyV2lkdGggLSB3aWR0aCApIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBhcGkubmV4dCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAKICAgICAgICAvLyByZXNjYWxlIHByZXNlbnRhdGlvbiB3aGVuIHdpbmRvdyBpcyByZXNpemVkCiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInJlc2l6ZSIsIHRocm90dGxlKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gZm9yY2UgZ29pbmcgdG8gYWN0aXZlIHN0ZXAgYWdhaW4sIHRvIHRyaWdnZXIgcmVzY2FsaW5nCiAgICAgICAgICAgIGFwaS5nb3RvKCBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuYWN0aXZlIiksIDUwMCApOwogICAgICAgIH0sIDI1MCksIGZhbHNlKTsKICAgICAgICAKICAgIH0sIGZhbHNlKTsKICAgICAgICAKfSkoZG9jdW1lbnQsIHdpbmRvdyk7CgovLyBUSEFUJ1MgQUxMIEZPTEtTIQovLwovLyBUaGFua3MgZm9yIHJlYWRpbmcgaXQgYWxsLgovLyBPciB0aGFua3MgZm9yIHNjcm9sbGluZyBkb3duIGFuZCByZWFkaW5nIHRoZSBsYXN0IHBhcnQuCi8vCi8vIEkndmUgbGVhcm50IGEgbG90IHdoZW4gYnVpbGRpbmcgaW1wcmVzcy5qcyBhbmQgSSBob3BlIHRoaXMgY29kZSBhbmQgY29tbWVudHMKLy8gd2lsbCBoZWxwIHNvbWVib2R5IGxlYXJuIGF0IGxlYXN0IHNvbWUgcGFydCBvZiBpdC4K",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 14:43:35 GMT",
                    "Content-Length": "41382",
                    "Date": "Thu, 06 Nov 2014 14:43:38 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}