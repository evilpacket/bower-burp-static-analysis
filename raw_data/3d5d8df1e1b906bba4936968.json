{
    "url": "http://localhost:9999/basisjs/basisjs/src/basis.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location.href</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statement:<ul><li>baseEl.setAttribute('href', location.href);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/basisjs/basisjs/src/basis.js",
                "path": "/basisjs/basisjs/src/basis.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9iYXNpc2pzL2Jhc2lzanMvc3JjL2Jhc2lzLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogOTcyMjcNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTI6MTA6NDMgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDEyOjEwOjM1IEdNVA0KDQovKgogIEJhc2lzIGphdmFzY3JpcHQgbGlicmFyeQogIGh0dHA6Ly9naXRodWIuY29tL2Jhc2lzanMvYmFzaXNqcwoqLwoKLyoqCiAqIEBhbm5vdGF0aW9uCiAqIEJhc2lzIGxpYnJhcnkgY29yZSBtb2R1bGUuIEl0IHByb3ZpZGVzIHZhcmlvdXMgbW9zdCB1c2luZyBmdW5jdGlvbnMsCiAqIGNsYXNzZXMgYW5kIGZ1bmN0aW9uYWxpdHkuCiAqCiAqIFRoaXMgZmlsZSBzaG91bGQgYmUgbG9hZGVkIGZpcnN0LgogKgogKiBDb250ZW50IG92ZXJ2aWV3OgogKiAtIHV0aWwgZnVuY3Rpb25zCiAqIC0gYmFzaXMuZ2V0dGVyCiAqIC0gY29uc29sZSBtZXRob2Qgd3JhcHBlcnMgKGJhc2lzLmRldikKICogLSB0aW1lciBmdW5jdGlvbnMgKGJhc2lzLnNldEltbWVkaWF0ZSwgYmFzaXMuY2xlYXJJbW1lZGlhdGUsIGJhc2lzLm5leHRUaWNrKQogKiAtIHBhdGggdXRpbHMgKGJhc2lzLnBhdGgpCiAqIC0gcHJvY2VzcyBjb25maWcgKGJhc2lzLmNvbmZpZykKICogLSBiYXNpcy5uYW1lc3BhY2UKICogLSBiYXNpcy5DbGFzcyBuYW1lc3BhY2UgKHByb3ZpZGVzIGluaGVyaXRhbmNlKQogKiAtIGJhc2lzLlRva2VuCiAqIC0gYmFzaXMucmVzb3VyY2UKICogLSBiYXNpcy5yZXF1aXJlCiAqIC0gcG9seWZpbGxzIGZvciBgRnVuY3Rpb24jYmluZGAsIGBBcnJheS5pc0FycmF5YCwgYEFycmF5I2luZGV4T2ZgLCBgQXJyYXkjbGFzdEluZGV4T2ZgLCBgQXJyYXkjZm9yRWFjaGAsIGBBcnJheSNtYXBgLCBgQXJyYXkjZmlsdGVyYCwgYEFycmF5I3NvbWVgLCBgQXJyYXkjZXZlcnlgLCBgQXJyYXkjcmVkdWNlYCwgYFN0cmluZyN0cmltYCwgYERhdGUjbm93YAogKiAtIGZ1bmN0aW9uIHRvIHdvcmsgd2l0aCBwcmltaXRpdmVzCiAqICAgLSBGdW5jdGlvbgogKiAgIC0gQXJyYXkKICogICAtIFN0cmluZwogKiAgIC0gTnVtYmVyCiAqIC0gYmFzaXMucmVhZHkKICogLSBhc3luYyBkb2N1bWVudCBpbXRlcmZhY2UgKGJhc2lzLmRvYykKICogLSBiYXNpcy5jbGVhbmVyCiAqLwoKLy8gZ2xvYmFsIGlzIGN1cnJlbnQgY29udGV4dCAoYHdpbmRvd2AgaW4gYnJvd3NlciBhbmQgYGdsb2JhbGAgb24gbm9kZS5qcykKOyhmdW5jdGlvbiBjcmVhdGVCYXNpc0luc3RhbmNlKGdsb2JhbCwgX19iYXNpc0ZpbGVuYW1lLCBfX2NvbmZpZyl7CiAgJ3VzZSBzdHJpY3QnOwoKICB2YXIgVkVSU0lPTiA9ICcxLjMuMyc7CgogIHZhciBkb2N1bWVudCA9IGdsb2JhbC5kb2N1bWVudDsKICB2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKCiAvKioKICAqIEdlbmVyYXRlcyB1bmlxdWUgaWQgKG1peCBkYXRldGltZSBhbmQgcmFuZG9tKS4KICAqIEBwYXJhbSB7bnVtYmVyPX0gbGVuIFJlcXVpcmVkIGxlbmd0aCBvZiBpZCAoMTYgYnkgZGVmYXVsdCkuCiAgKiBAcmV0dXJucyB7c3RyaW5nfSBHZW5lcmF0ZWQgaWQuCiAgKi8KICBmdW5jdGlvbiBnZW5VSUQobGVuKXsKICAgIGZ1bmN0aW9uIGJhc2UzNih2YWwpewogICAgICByZXR1cm4gTWF0aC5yb3VuZCh2YWwpLnRvU3RyaW5nKDM2KTsKICAgIH0KCiAgICAvLyB1aWQgc2hvdWxkIHN0YXJ0cyB3aXRoIGFscGhhCiAgICB2YXIgcmVzdWx0ID0gYmFzZTM2KDEwICsgMjUgKiBNYXRoLnJhbmRvbSgpKTsKCiAgICBpZiAoIWxlbikKICAgICAgbGVuID0gMTY7CgogICAgd2hpbGUgKHJlc3VsdC5sZW5ndGggPCBsZW4pCiAgICAgIHJlc3VsdCArPSBiYXNlMzYobmV3IERhdGUgKiBNYXRoLnJhbmRvbSgpKTsKCiAgICByZXR1cm4gcmVzdWx0LnN1YnN0cigwLCBsZW4pOwogIH0KCgogLyoqCiAgKiBDb3B5IGFsbCBwcm9wZXJ0aWVzIGZyb20gc291cmNlIChvYmplY3QpIHRvIGRlc3RpbmF0aW9uIG9iamVjdC4KICAqIEBwYXJhbSB7b2JqZWN0fSBkZXN0IE9iamVjdCBzaG91bGQgYmUgZXh0ZW5kZWQuCiAgKiBAcGFyYW0ge29iamVjdH0gc291cmNlCiAgKiBAcmV0dXJuIHtvYmplY3R9IERlc3RpbmF0aW9uIG9iamVjdC4KICAqLwogIGZ1bmN0aW9uIGV4dGVuZChkZXN0LCBzb3VyY2UpewogICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkKICAgICAgZGVzdFtrZXldID0gc291cmNlW2tleV07CgogICAgcmV0dXJuIGRlc3Q7CiAgfQoKIC8qKgogICogQ29weSBvbmx5IG1pc3NlZCBwcm9wZXJ0aWVzIGZyb20gc291cmNlIChvYmplY3QpIHRvIG9iamVjdC4KICAqIEBwYXJhbSB7b2JqZWN0fSBkZXN0IE9iamVjdCBzaG91bGQgYmUgY29tcGxldGVkLgogICogQHBhcmFtIHtvYmplY3R9IHNvdXJjZQogICogQHJldHVybiB7b2JqZWN0fSBEZXN0aW5hdGlvbiBvYmplY3QuCiAgKi8KICBmdW5jdGlvbiBjb21wbGV0ZShkZXN0LCBzb3VyY2UpewogICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkKICAgICAgaWYgKGtleSBpbiBkZXN0ID09IGZhbHNlKQogICAgICAgIGRlc3Rba2V5XSA9IHNvdXJjZVtrZXldOwoKICAgIHJldHVybiBkZXN0OwogIH0KCiAvKioKICAqIFJldHVybnMgYWxsIHByb3BlcnR5IG5hbWVzIG9mIG9iamVjdC4KICAqIEBwYXJhbSB7b2JqZWN0fSBvYmplY3QgQW55IG9iamVjdCBjYW4gaGFzIHByb3BlcnRpZXMuCiAgKiBAcmV0dXJuIHtBcnJheS48c3RyaW5nPn0KICAqLwogIGZ1bmN0aW9uIGtleXMob2JqZWN0KXsKICAgIHZhciByZXN1bHQgPSBbXTsKCiAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KQogICAgICByZXN1bHQucHVzaChrZXkpOwoKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKIC8qKgogICogUmV0dXJucyBhbGwgcHJvcGVydHkgdmFsdWVzIG9mIG9iamVjdC4KICAqIEBwYXJhbSB7b2JqZWN0fSBvYmplY3QgQW55IG9iamVjdCBjYW4gaGFzIHByb3BlcnRpZXMuCiAgKiBAcmV0dXJuIHtBcnJheS48b2JqZWN0Pn0KICAqLwogIGZ1bmN0aW9uIHZhbHVlcyhvYmplY3QpewogICAgdmFyIHJlc3VsdCA9IFtdOwoKICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpCiAgICAgIHJlc3VsdC5wdXNoKG9iamVjdFtrZXldKTsKCiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAvKioKICAqIENyZWF0ZXMgYSBzbGljZSBvZiBzb3VyY2Ugb2JqZWN0LgogICogQHBhcmFtIHtvYmplY3R9IHNvdXJjZSBBbnkgb2JqZWN0IGNhbiBoYXMgcHJvcGVydGllcy4KICAqIEBwYXJhbSB7QXJyYXkuPHN0cmluZz59IGtleXMgRGVzaXJlZCBrZXkgc2V0LgogICogQHJldHVybiB7b2JqZWN0fSBOZXcgb2JqZWN0IHdpdGggZGVzaXJlZCBrZXlzIGZyb20gc291cmNlIG9iamVjdC4KICAqLwogIGZ1bmN0aW9uIHNsaWNlKHNvdXJjZSwga2V5cyl7CiAgICB2YXIgcmVzdWx0ID0ge307CgogICAgaWYgKCFrZXlzKQogICAgICByZXR1cm4gZXh0ZW5kKHJlc3VsdCwgc291cmNlKTsKCiAgICBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBrZXlzW2krK107KQogICAgICBpZiAoa2V5IGluIHNvdXJjZSkKICAgICAgICByZXN1bHRba2V5XSA9IHNvdXJjZVtrZXldOwoKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKIC8qKgogICogQ3JlYXRlcyBhIHNsaWNlIG9mIHNvdXJjZSBvYmplY3QgYW5kIGRlbGV0ZSBrZXlzIGZyb20gc291cmNlLgogICogQHBhcmFtIHtvYmplY3R9IHNvdXJjZSBBbnkgb2JqZWN0IGNhbiBoYXMgcHJvcGVydGllcy4KICAqIEBwYXJhbSB7QXJyYXkuPHN0cmluZz59IGtleXMgRGVzaXJlZCBrZXkgc2V0LgogICogQHJldHVybiB7b2JqZWN0fSBOZXcgb2JqZWN0IHdpdGggZGVzaXJlZCBrZXlzIGZyb20gc291cmNlIG9iamVjdC4KICAqIFRPRE86IGZpeCBjYXNlIHdoZW4ga2V5cyBpcyBub3QgcGFzc2VkOyBpdCByZXR1cm5zIGNvcHkgb2Ygc291cmNlLAogICogICAgICAgYnV0IGRvZXNuJ3QgZGVsZXRlIGFueXRoaW5nIChzb3VyY2Ugc2hvdWxkIGJlY29tZSBlbXB0eSBvYmplY3QpCiAgKi8KICBmdW5jdGlvbiBzcGxpY2Uoc291cmNlLCBrZXlzKXsKICAgIHZhciByZXN1bHQgPSB7fTsKCiAgICBpZiAoIWtleXMpCiAgICAgIHJldHVybiBleHRlbmQocmVzdWx0LCBzb3VyY2UpOwoKICAgIGZvciAodmFyIGkgPSAwLCBrZXk7IGtleSA9IGtleXNbaSsrXTspCiAgICAgIGlmIChrZXkgaW4gc291cmNlKQogICAgICB7CiAgICAgICAgcmVzdWx0W2tleV0gPSBzb3VyY2Vba2V5XTsKICAgICAgICBkZWxldGUgc291cmNlW2tleV07CiAgICAgIH0KCiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAvKioKICAqIE1lcmdlIHNldmVyYWwgb2JqZWN0cyBpbnRvIG5ldyBvYmplY3QgYW5kIHJldHVybnMgaXQuCiAgKiBAcGFyYW0gey4uLip9IGFyZ3MKICAqIEByZXR1cm4ge29iamVjdH0KICAqLwogIGZ1bmN0aW9uIG1lcmdlKC8qIG9iajEgLi4gb2JqTiAqLyl7CiAgICB2YXIgcmVzdWx0ID0ge307CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspCiAgICAgIGV4dGVuZChyZXN1bHQsIGFyZ3VtZW50c1tpXSk7CgogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogLyoqCiAgKiBSZXR1cm5zIGxpc3Qgb2YgY2FsbGJhY2sgY2FsbCByZXN1bHQgZm9yIGV2ZXJ5IG9iamVjdCdzIGtleS12YWx1ZSBwYWlyLgogICogQHBhcmFtIHtvYmplY3R9IG9iamVjdCBBbnkgb2JqZWN0IGNhbiBoYXMgcHJvcGVydGllcy4KICAqIEBwYXJhbSB7ZnVuY3Rpb24oa2V5LCB2YWx1ZSl9IGNhbGxiYWNrCiAgKiBAcGFyYW0geyo9fSB0aGlzT2JqZWN0CiAgKiBAcmV0dXJuIHtBcnJheS48Kj59CiAgKi8KICBmdW5jdGlvbiBpdGVyYXRlKG9iamVjdCwgY2FsbGJhY2ssIHRoaXNPYmplY3QpewogICAgdmFyIHJlc3VsdCA9IFtdOwoKICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpCiAgICAgIHJlc3VsdC5wdXNoKGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwga2V5LCBvYmplY3Rba2V5XSkpOwoKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKIC8qKgogICogQHBhcmFtIHsqfSB2YWx1ZQogICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHZhbHVlIGlzIHVuZGVmaW5lZC4KICAqLwogIGZ1bmN0aW9uICR1bmRlZmluZWQodmFsdWUpewogICAgcmV0dXJuIHZhbHVlID09IHVuZGVmaW5lZDsKICB9CgogLyoqCiAgKiBAcGFyYW0geyp9IHZhbHVlCiAgKiBAcmV0dXJuIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdmFsdWUgaXMgbm90IHVuZGVmaW5lZC4KICAqLwogIGZ1bmN0aW9uICRkZWZpbmVkKHZhbHVlKXsKICAgIHJldHVybiB2YWx1ZSAhPSB1bmRlZmluZWQ7CiAgfQoKIC8qKgogICogQHBhcmFtIHsqfSB2YWx1ZQogICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHZhbHVlIGlzIG51bGwuCiAgKi8KICBmdW5jdGlvbiAkaXNOdWxsKHZhbHVlKXsKICAgIHJldHVybiB2YWx1ZSA9PSBudWxsIHx8IHZhbHVlID09IHVuZGVmaW5lZDsKICB9CgogLyoqCiAgKiBAcGFyYW0geyp9IHZhbHVlCiAgKiBAcmV0dXJuIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdmFsdWUgaXMgbm90IG51bGwuCiAgKi8KICBmdW5jdGlvbiAkaXNOb3ROdWxsKHZhbHVlKXsKICAgIHJldHVybiB2YWx1ZSAhPSBudWxsICYmIHZhbHVlICE9IHVuZGVmaW5lZDsKICB9CgogLyoqCiAgKiBAcGFyYW0geyp9IHZhbHVlCiAgKiBAcmV0dXJuIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdmFsdWUgaXMgZXF1YWwgKD09PSkgdG8gdGhpcy4KICAqLwogIGZ1bmN0aW9uICRpc1NhbWUodmFsdWUpewogICAgcmV0dXJuIHZhbHVlID09PSB0aGlzOwogIH0KCiAvKioKICAqIEBwYXJhbSB7Kn0gdmFsdWUKICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB2YWx1ZSBpcyBub3QgZXF1YWwgKCE9PSkgdG8gdGhpcy4KICAqLwogIGZ1bmN0aW9uICRpc05vdFNhbWUodmFsdWUpewogICAgcmV0dXJuIHZhbHVlICE9PSB0aGlzOwogIH0KCiAvKioKICAqIG5vdGhpbmcgdG8gZG8sIGp1c3QgcmV0dXJucyBmaXJzdCBhcmd1bWVudC4KICAqIEBwYXJhbSB7Kn0gdmFsdWUKICAqIEByZXR1cm4geyp9IFJldHVybnMgZmlyc3QgYXJndW1lbnQuCiAgKi8KICBmdW5jdGlvbiAkc2VsZih2YWx1ZSl7CiAgICByZXR1cm4gdmFsdWU7CiAgfQoKIC8qKgogICogUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgYWx3YXlzIHJldHVybnMgdGhlIHNhbWUgdmFsdWUuCiAgKiBAcGFyYW0geyp9IHZhbHVlCiAgKiBAcmV0dXJuIHtmdW5jdGlvbigpfQogICovCiAgZnVuY3Rpb24gJGNvbnN0KHZhbHVlKXsKICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9OwogIH0KCiAvKioKICAqIEFsd2F5cyByZXR1cm5zIGZhbHNlLgogICogQHJldHVybiB7Ym9vbGVhbn0KICAqLwogIGZ1bmN0aW9uICRmYWxzZSgpewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAvKioKICAqIEFsd2F5cyByZXR1cm5zIHRydWUuCiAgKiBAcmV0dXJuIHtib29sZWFufQogICovCiAgZnVuY3Rpb24gJHRydWUoKXsKICAgIHJldHVybiB0cnVlOwogIH0KCiAvKioKICAqIEFsd2F5cyByZXR1cm5zIG51bGwuCiAgKi8KICBmdW5jdGlvbiAkbnVsbCgpewogICAgcmV0dXJuIG51bGw7CiAgfQoKIC8qKgogICogQWx3YXlzIHJldHVybnMgdW5kZWZpbmVkLgogICovCiAgZnVuY3Rpb24gJHVuZGVmKCl7CiAgfQoKIC8qKgogICogQHBhcmFtIHtmdW5jdGlvbihvYmplY3QpfHN0cmluZ30gcGF0aAogICogQHBhcmFtIHtmdW5jdGlvbih2YWx1ZSl8c3RyaW5nfG9iamVjdD19IG1vZGlmaWNhdG9yCiAgKiBAcmV0dXJuIHtmdW5jdGlvbihvYmplY3QpfSBSZXR1cm5zIGZ1bmN0aW9uIHRoYXQgcmVzb2x2ZSBzb21lIHBhdGggaW4gb2JqZWN0IGFuZCBjYW4gdXNlIG1vZGlmaWNhdG9yIGZvciB2YWx1ZSB0cmFuc2Zvcm1hdGlvbi4KICAqLwogIHZhciBnZXR0ZXIgPSAoZnVuY3Rpb24oKXsKICAgIHZhciBJRCA9ICdiYXNpc0dldHRlcklkJyArIGdlblVJRCgpICsgJ18nOwogICAgdmFyIG1vZGlmaWNhdG9yU2VlZCA9IDE7CiAgICB2YXIgc2ltcGxlUGF0aCA9IC9eW2EteiRfXVthLXokXzAtOV0qKFwuW2EteiRfXVthLXokXzAtOV0qKSokL2k7CgogICAgdmFyIGdldHRlck1hcCA9IFtdOwogICAgdmFyIHBhdGhDYWNoZSA9IHt9OwogICAgdmFyIG1vZENhY2hlID0ge307CgogICAgZnVuY3Rpb24gYnVpbGRGdW5jdGlvbihwYXRoKXsKICAgICAgaWYgKHNpbXBsZVBhdGgudGVzdChwYXRoKSkKICAgICAgewogICAgICAgIHZhciBwYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgICAgICB2YXIgZm9vID0gcGFydHNbMF07CiAgICAgICAgdmFyIGJhciA9IHBhcnRzWzFdOwogICAgICAgIHZhciBiYXogPSBwYXJ0c1syXTsKICAgICAgICB2YXIgZm47CgogICAgICAgIC8vIFRoaXMgYXBwcm9hY2ggaGVscHMgcHJvZHVjZSBmdW5jdGlvbiB0aGF0IGNvdWxkIGJlCiAgICAgICAgLy8gb3B0aW1pemVkIChpbmxpbmVkKSBieSBqcyBlbmdpbmUuIEluIG1vc3QgY2FzZXMgcGF0aCBjb250YWlucwogICAgICAgIC8vIGZyb20gMSB0byAzIHBhcnRzIGFuZCB3ZSBkb24ndCB1c2UgYSBsb29wIGluIHRob3NlIGNhc2VzLgogICAgICAgIHN3aXRjaCAocGFydHMubGVuZ3RoKQogICAgICAgIHsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgZm4gPSBmdW5jdGlvbihvYmplY3QpewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dIDogb2JqZWN0OwogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgZm4gPSBmdW5jdGlvbihvYmplY3QpewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dW2Jhcl0gOiBvYmplY3Q7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCl7CiAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdCAhPSBudWxsID8gb2JqZWN0W2Zvb11bYmFyXVtiYXpdIDogb2JqZWN0OwogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGZuID0gZnVuY3Rpb24ob2JqZWN0KXsKICAgICAgICAgICAgICBpZiAob2JqZWN0ICE9IG51bGwpCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb2JqZWN0ID0gb2JqZWN0W2Zvb11bYmFyXVtiYXpdOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDMsIGtleTsga2V5ID0gcGFydHNbaV07IGkrKykKICAgICAgICAgICAgICAgICAgb2JqZWN0ID0gb2JqZWN0W2tleV07CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgLy8gdmVyYm9zZSBmdW5jdGlvbiBjb2RlIGluIGRldiBtb2RlCiAgICAgICAgLyoqIEBjdXQgKi8gZm4gPSBGdW5jdGlvbigncGFydHMnLCAncmV0dXJuICcgKyBmbi50b1N0cmluZygpCiAgICAgICAgLyoqIEBjdXQgKi8gICAucmVwbGFjZSgvKGZvb3xiYXJ8YmF6KS9nLCBmdW5jdGlvbihtLCB3KXsKICAgICAgICAvKiogQGN1dCAqLyAgICAgIHJldHVybiAnIicgKyBwYXJ0c1t3ID09ICdmb28nID8gMCA6ICh3ID09ICdiYXInID8gMSA6IDIpXSArICciJzsKICAgICAgICAvKiogQGN1dCAqLyAgICB9KQogICAgICAgIC8qKiBAY3V0ICovICAgLnJlcGxhY2UoL1xbXCIoW14iXSspXCJcXS9nLCAnLiQxJykpKHBhcnRzKTsKCiAgICAgICAgcmV0dXJuIGZuOwogICAgICB9CgogICAgICAvLyBmb3IgY2FzZXMgd2hlbiBwYXRoIGlzbid0IGEgcHJvcGVydHkgbmFtZSBjaGFpbgogICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCdvYmplY3QnLCAncmV0dXJuIG9iamVjdCAhPSBudWxsID8gb2JqZWN0LicgKyBwYXRoICsgJyA6IG9iamVjdCcpOwogICAgfQoKICAgIHZhciBnZXR0ZXJGbiA9IGZ1bmN0aW9uKHBhdGgsIG1vZGlmaWNhdG9yKXsKICAgICAgdmFyIGZ1bmM7CiAgICAgIHZhciByZXN1bHQ7CiAgICAgIHZhciBnZXR0ZXJJZDsKCiAgICAgIC8vIHJldHVybiBudWxsR2V0dGVyIGlmIG5vIHBhdGggb3IgbnVsbEdldHRlciBwYXNzZWQKICAgICAgaWYgKCFwYXRoIHx8IHBhdGggPT09IG51bGxHZXR0ZXIpCiAgICAgICAgcmV0dXJuIG51bGxHZXR0ZXI7CgogICAgICAvLyByZXNvbHZlIGdldHRlciBieSBwYXRoCiAgICAgIGlmICh0eXBlb2YgcGF0aCA9PSAnZnVuY3Rpb24nKQogICAgICB7CiAgICAgICAgZ2V0dGVySWQgPSBwYXRoW0lEXTsKCiAgICAgICAgLy8gcGF0aCBpcyBmdW5jdGlvbgogICAgICAgIGlmIChnZXR0ZXJJZCkKICAgICAgICB7CiAgICAgICAgICAvLyB0aGlzIGZ1bmN0aW9uIHVzZWQgZm9yIGdldHRlciBiZWZvcmUKICAgICAgICAgIGZ1bmMgPSBnZXR0ZXJNYXBbTWF0aC5hYnMoZ2V0dGVySWQpIC0gMV07CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAvLyB0aGlzIGZ1bmN0aW9uIG5ldmVyIHVzZWQgZm9yIGdldHRlciBiZWZvcmUsIHdyYXAgYW5kIGNhY2hlIGl0CgogICAgICAgICAgLy8gd3JhcCBmdW5jdGlvbiB0byBwcmV2ZW50IGZ1bmN0aW9uIHByb3BlcnRpZXMgcmV3cml0ZQogICAgICAgICAgZnVuYyA9IGZ1bmN0aW9uKG9iamVjdCl7CiAgICAgICAgICAgIHJldHVybiBwYXRoKG9iamVjdCk7CiAgICAgICAgICB9OwogICAgICAgICAgZnVuYy5iYXNlID0gcGF0aDsKICAgICAgICAgIGZ1bmMuX19leHRlbmRfXyA9IGdldHRlcjsKCiAgICAgICAgICAvLyBhZGQgdG8gY2FjaGUKICAgICAgICAgIGdldHRlcklkID0gZ2V0dGVyTWFwLnB1c2goZnVuYyk7CiAgICAgICAgICBwYXRoW0lEXSA9IC1nZXR0ZXJJZDsKICAgICAgICAgIGZ1bmNbSURdID0gZ2V0dGVySWQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UKICAgICAgewogICAgICAgIC8vIHRocmVhZCBwYXRoIGFzIHN0cmluZywgc2VhcmNoIGluIGNhY2hlCiAgICAgICAgZnVuYyA9IHBhdGhDYWNoZVtwYXRoXTsKCiAgICAgICAgaWYgKGZ1bmMpCiAgICAgICAgewogICAgICAgICAgLy8gcmVzb2x2ZSBnZXR0ZXIgaWQKICAgICAgICAgIGdldHRlcklkID0gZnVuY1tJRF07CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAvLyBjcmVhdGUgZ2V0dGVyIGZ1bmN0aW9uCiAgICAgICAgICBmdW5jID0gYnVpbGRGdW5jdGlvbihwYXRoKTsKICAgICAgICAgIGZ1bmMuYmFzZSA9IHBhdGg7CiAgICAgICAgICBmdW5jLl9fZXh0ZW5kX18gPSBnZXR0ZXI7CgogICAgICAgICAgLy8gYWRkIHRvIGNhY2hlCiAgICAgICAgICBnZXR0ZXJJZCA9IGdldHRlck1hcC5wdXNoKGZ1bmMpOwogICAgICAgICAgZnVuY1tJRF0gPSBnZXR0ZXJJZDsKICAgICAgICAgIHBhdGhDYWNoZVtwYXRoXSA9IGZ1bmM7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyByZXNvbHZlIGdldHRlciB3aXRoIG1vZGlmaWNhdG9yCiAgICAgIHZhciBtb2RUeXBlID0gbW9kaWZpY2F0b3IgIT0gbnVsbCAmJiB0eXBlb2YgbW9kaWZpY2F0b3I7CgogICAgICAvLyBpZiBubyBtb2RpZmljYXRvciwgcmV0dXJuIGZ1bmMKICAgICAgaWYgKCFtb2RUeXBlKQogICAgICAgIHJldHVybiBmdW5jOwoKICAgICAgdmFyIG1vZExpc3QgPSBtb2RDYWNoZVtnZXR0ZXJJZF07CiAgICAgIHZhciBtb2RJZDsKCiAgICAgIC8vIHJlc29sdmUgbW9kaWZpY2F0b3IgaWQgaWYgcG9zc2libGUKICAgICAgaWYgKG1vZFR5cGUgPT0gJ3N0cmluZycpCiAgICAgICAgbW9kSWQgPSBtb2RUeXBlICsgbW9kaWZpY2F0b3I7CiAgICAgIGVsc2UKICAgICAgICBpZiAobW9kVHlwZSA9PSAnZnVuY3Rpb24nKQogICAgICAgICAgbW9kSWQgPSBtb2RpZmljYXRvci5iYXNpc01vZElkXzsKICAgICAgICBlbHNlCiAgICAgICAgICBpZiAobW9kVHlwZSAhPSAnb2JqZWN0JykKICAgICAgICAgIHsKICAgICAgICAgICAgLy8gb25seSBzdHJpbmcsIGZ1bmN0aW9uIGFuZCBvYmplY3RzIGFyZSBzdXBwb3J0IGFzIG1vZGlmaWNhdG9yCiAgICAgICAgICAgIC8qKiBAY3V0ICovIGNvbnNvbGVNZXRob2RzLndhcm4oJ2Jhc2lzLmdldHRlcjogd3JvbmcgbW9kaWZpY2F0b3IgdHlwZSwgbW9kaWZpY2F0b3Igbm90IHVzZWQsIHBhdGg6ICcsIHBhdGgsICcsIG1vZGlmaWNhdG9yOicsIG1vZGlmaWNhdG9yKTsKCiAgICAgICAgICAgIHJldHVybiBmdW5jOwogICAgICAgICAgfQoKICAgICAgLy8gdHJ5IGZldGNoIGdldHRlciBmcm9tIGNhY2hlCiAgICAgIGlmIChtb2RJZCAmJiBtb2RMaXN0ICYmIG1vZExpc3RbbW9kSWRdKQogICAgICAgIHJldHVybiBtb2RMaXN0W21vZElkXTsKCiAgICAgIC8vIHJlY292ZXIgb3JpZ2luYWwgZnVuY3Rpb24sIHJlZHVjZSBmdW5jdGlvbnMgY2FsbCBkZWVwCiAgICAgIGlmICh0eXBlb2YgZnVuYy5iYXNlID09ICdmdW5jdGlvbicpCiAgICAgICAgZnVuYyA9IGZ1bmMuYmFzZTsKCiAgICAgIHN3aXRjaCAobW9kVHlwZSkKICAgICAgewogICAgICAgIGNhc2UgJ3N0cmluZyc6CiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbihvYmplY3QpewogICAgICAgICAgICByZXR1cm4gc3RyaW5nRnVuY3Rpb25zLmZvcm1hdChtb2RpZmljYXRvciwgZnVuYyhvYmplY3QpKTsKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnZnVuY3Rpb24nOgogICAgICAgICAgaWYgKCFtb2RJZCkKICAgICAgICAgIHsKICAgICAgICAgICAgLy8gbWFyayBmdW5jdGlvbiB3aXRoIG1vZGlmaWNhdG9yIGlkCiAgICAgICAgICAgIG1vZElkID0gbW9kVHlwZSArIG1vZGlmaWNhdG9yU2VlZCsrOwogICAgICAgICAgICBtb2RpZmljYXRvci5iYXNpc01vZElkXyA9IG1vZElkOwogICAgICAgICAgfQoKICAgICAgICAgIHJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCl7CiAgICAgICAgICAgIHJldHVybiBtb2RpZmljYXRvcihmdW5jKG9iamVjdCkpOwogICAgICAgICAgfTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBkZWZhdWx0OiAvL2Nhc2UgJ29iamVjdCc6CiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbihvYmplY3QpewogICAgICAgICAgICByZXR1cm4gbW9kaWZpY2F0b3JbZnVuYyhvYmplY3QpXTsKICAgICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJlc3VsdC5iYXNlID0gZnVuYy5iYXNlIHx8IGZ1bmM7CiAgICAgIHJlc3VsdC5fX2V4dGVuZF9fID0gZ2V0dGVyOwoKICAgICAgaWYgKG1vZElkKQogICAgICB7CiAgICAgICAgaWYgKCFtb2RMaXN0KQogICAgICAgIHsKICAgICAgICAgIC8vIGNyZWF0ZSBuZXcgbW9kaWZpY2F0b3IgbGlzdCBpZiBpdCBub3QgZXhpc3RzIHlldAogICAgICAgICAgbW9kTGlzdCA9IHt9OwogICAgICAgICAgbW9kQ2FjaGVbZ2V0dGVySWRdID0gbW9kTGlzdDsKICAgICAgICB9CgogICAgICAgIC8vIGNhY2hlIGdldHRlciB3aXRoIG1vZGlmaWNhdG9yCiAgICAgICAgbW9kTGlzdFttb2RJZF0gPSByZXN1bHQ7CiAgICAgICAgcmVzdWx0Lm1vZCA9IG1vZGlmaWNhdG9yOwoKICAgICAgICAvLyBjYWNoZSBuZXcgZ2V0dGVyCiAgICAgICAgcmVzdWx0W0lEXSA9IGdldHRlck1hcC5wdXNoKHJlc3VsdCk7CiAgICAgIH0KICAgICAgZWxzZQogICAgICB7CiAgICAgICAgLy8gb25seSBvYmplY3QgbW9kaWZpY2F0b3JzIGhhcyBubyBtb2RJZAogICAgICAgIC8vIGdldHRlcnMgd2l0aCBvYmplY3QgbW9kaWZpY2F0b3IgYXJlIG5vdCBjYWNoaW5nCiAgICAgICAgLy8gdGhpcyBwcmV2ZW50cyBvZiBzdG9yaW5nIChpbiBjbG9zdXJlKSBvYmplY3QgdGhhdCBjYW4ndCBiZSByZWxlYXNlZCBieSBnYWJhZ2UgY29sbGVjdG9ycwogICAgICB9CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKCiAgICBnZXR0ZXJGbi5JRCA9IElEOwoKICAgIHJldHVybiBnZXR0ZXJGbjsKICB9KSgpOwoKICB2YXIgbnVsbEdldHRlciA9IGV4dGVuZChmdW5jdGlvbigpe30sIHsKICAgIF9fZXh0ZW5kX186IGdldHRlcgogIH0pOwoKCiAvKioKICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkKICAqIEByZXR1cm4ge29iamVjdH0KICAqLwogIGZ1bmN0aW9uIHdyYXBwZXIoa2V5KXsKICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQoKIC8qKgogICogQHBhcmFtIHtmdW5jdGlvbigpfSBpbml0IEZ1bmN0aW9uIHRoYXQgc2hvdWxkIGJlIGNhbGxlZCBhdCBmaXJzdCB0aW1lLgogICogQHBhcmFtIHtPYmplY3Q9fSB0aGlzT2JqZWN0CiAgKiBAcmV0dXJuIHtmdW5jdGlvbigpfSBSZXR1cm5zIGxhenkgZnVuY3Rpb24uCiAgKi8KICBmdW5jdGlvbiBsYXp5SW5pdChpbml0LCB0aGlzT2JqZWN0KXsKICAgIHZhciBpbml0ZWQgPSAwOwogICAgdmFyIHNlbGY7CiAgICB2YXIgZGF0YTsKICAgIHJldHVybiBzZWxmID0gZnVuY3Rpb24oKXsKICAgICAgaWYgKCFpbml0ZWQrKykKICAgICAgewogICAgICAgIHNlbGYuaW5pdGVkID0gdHJ1ZTsgIC8vIERPTidUIFVTRSBUSElTIFBST1BFUlRZLCBJVCdTIEZPUiBERUJVRyBQVVJQT1NFUyBPTkxZCiAgICAgICAgc2VsZi5kYXRhID0gICAgICAgICAgLy8gRE9OJ1QgVVNFIFRISVMgUFJPUEVSVFksIElUJ1MgRk9SIERFQlVHIFBVUlBPU0VTIE9OTFkKICAgICAgICBkYXRhID0gaW5pdC5hcHBseSh0aGlzT2JqZWN0IHx8IHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgLyoqIEBjdXQgKi8gaWYgKHR5cGVvZiBkYXRhID09ICd1bmRlZmluZWQnKSBjb25zb2xlTWV0aG9kcy53YXJuKCdsYXp5SW5pdCBmdW5jdGlvbiByZXR1cm5zIG5vdGhpbmc6XG4nICsgaW5pdCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwogIH0KCiAvKioKICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gaW5pdCBGdW5jdGlvbiB0aGF0IHNob3VsZCBiZSBjYWxsZWQgYXQgZmlyc3QgdGltZS4KICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gcnVuIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgYWxsIHRpbWVzLgogICogQHBhcmFtIHtPYmplY3Q9fSB0aGlzT2JqZWN0CiAgKiBAcmV0dXJuIHtmdW5jdGlvbigpfSBSZXR1cm5zIGxhenkgZnVuY3Rpb24uCiAgKi8KICBmdW5jdGlvbiBsYXp5SW5pdEFuZFJ1bihpbml0LCBydW4sIHRoaXNPYmplY3QpewogICAgdmFyIGluaXRlZCA9IDA7CiAgICB2YXIgc2VsZjsKICAgIHZhciBkYXRhOwogICAgcmV0dXJuIHNlbGYgPSBmdW5jdGlvbigpewogICAgICBpZiAoIWluaXRlZCsrKQogICAgICB7CiAgICAgICAgc2VsZi5pbml0ZWQgPSB0cnVlOyAgLy8gRE9OJ1QgVVNFIFRISVMgUFJPUEVSVFksIElUJ1MgRk9SIERFQlVHIFBVUlBPU0VTIE9OTFkKICAgICAgICBzZWxmLmRhdGEgPSAgICAgICAgICAvLyBET04nVCBVU0UgVEhJUyBQUk9QRVJUWSwgSVQnUyBGT1IgREVCVUcgUFVSUE9TRVMgT05MWQogICAgICAgIGRhdGEgPSBpbml0LmNhbGwodGhpc09iamVjdCB8fCB0aGlzKTsKICAgICAgICAvKiogQGN1dCAqLyBpZiAodHlwZW9mIGRhdGEgPT0gJ3VuZGVmaW5lZCcpIGNvbnNvbGVNZXRob2RzLndhcm4oJ2xhenlJbml0QW5kUnVuIGZ1bmN0aW9uIHJldHVybnMgbm90aGluZzpcbicgKyBpbml0KTsKICAgICAgfQogICAgICBydW4uYXBwbHkoZGF0YSwgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9OwogIH0KCiAvKioKICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gcnVuIEZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQgb25seSBvbmNlLgogICogQHBhcmFtIHtPYmplY3Q9fSB0aGlzT2JqZWN0CiAgKiBAcmV0dXJuIHtmdW5jdGlvbigpfSBSZXR1cm5zIGxhenkgZnVuY3Rpb24uCiAgKi8KICBmdW5jdGlvbiBydW5PbmNlKHJ1biwgdGhpc09iamVjdCl7CiAgICB2YXIgZmlyZWQgPSAwOwogICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAgIGlmICghZmlyZWQrKykKICAgICAgICByZXR1cm4gcnVuLmFwcGx5KHRoaXNPYmplY3QgfHwgdGhpcywgYXJndW1lbnRzKTsKICAgIH07CiAgfQoKCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAvLyBzYWZlIGNvbnNvbGUgbWV0aG9kIHdyYXBwZXJzCiAgLy8KCiAgdmFyIGNvbnNvbGVNZXRob2RzID0gKGZ1bmN0aW9uKCl7CiAgICB2YXIgbWV0aG9kcyA9IHsKICAgICAgbG9nOiAkdW5kZWYsCiAgICAgIGluZm86ICR1bmRlZiwKICAgICAgd2FybjogJHVuZGVmLAogICAgICBlcnJvcjogJHVuZGVmCiAgICB9OwoKICAgIGlmICh0eXBlb2YgY29uc29sZSAhPSAndW5kZWZpbmVkJykKICAgICAgaXRlcmF0ZShtZXRob2RzLCBmdW5jdGlvbihtZXRob2ROYW1lKXsKICAgICAgICBtZXRob2RzW21ldGhvZE5hbWVdID0gJ2JpbmQnIGluIEZ1bmN0aW9uLnByb3RvdHlwZSAmJiB0eXBlb2YgY29uc29sZVttZXRob2ROYW1lXSA9PSAnZnVuY3Rpb24nCiAgICAgICAgICA/IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kLmNhbGwoY29uc29sZVttZXRob2ROYW1lXSwgY29uc29sZSkKICAgICAgICAgICAgLy8gaWU4IGFuZCBsb3dlciwgaXQncyBhbHNvIG1vcmUgc2FmZSB3aGVuIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kIGRlZmluZWQKICAgICAgICAgICAgLy8gYnkgb3RoZXIgbGlicmFyaWVzIChsaWtlIGVzNS1zaGltKQogICAgICAgICAgOiBmdW5jdGlvbigpewogICAgICAgICAgICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGVbbWV0aG9kTmFtZV0sIGNvbnNvbGUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH07CiAgICAgIH0pOwoKICAgIHJldHVybiBtZXRob2RzOwogIH0pKCk7CgoKICAvLwogIC8vIFN1cHBvcnQgZm9yIHNldEltbWVkaWF0ZS9jbGVhckltbWVkaWF0ZQogIC8vCgogIHZhciBzZXRJbW1lZGlhdGUgPSBnbG9iYWwuc2V0SW1tZWRpYXRlIHx8IGdsb2JhbC5tc1NldEltbWVkaWF0ZTsKICB2YXIgY2xlYXJJbW1lZGlhdGUgPSBnbG9iYWwuY2xlYXJJbW1lZGlhdGUgfHwgZ2xvYmFsLm1zU2V0SW1tZWRpYXRlOwoKICAvLyBiaW5kIGNvbnRleHQgZm9yIHNldEltbWVkaWF0ZS9jbGVhckltbWVkaWF0ZSwgSUUxMCB0aHJvdyBleGNlcHRpb24gaWYgY29udGV4dCBpc24ndCBnbG9iYWwKICBpZiAoc2V0SW1tZWRpYXRlKQogICAgc2V0SW1tZWRpYXRlID0gc2V0SW1tZWRpYXRlLmJpbmQoZ2xvYmFsKTsKCiAgaWYgKGNsZWFySW1tZWRpYXRlKQogICAgY2xlYXJJbW1lZGlhdGUgPSBjbGVhckltbWVkaWF0ZS5iaW5kKGdsb2JhbCk7CgogIC8vCiAgLy8gZW11bGF0ZSBzZXRJbW1lZGlhdGUvY2xlYXJJbW1lZGlhdGUKICAvLyBJbnNwaXJlZCBvbiBEb21lbmljIERlbmljb2xhJ3Mgc29sdXRpb24gaHR0cHM6Ly9naXRodWIuY29tL05vYmxlSlMvc2V0SW1tZWRpYXRlCiAgLy8KICBpZiAoIXNldEltbWVkaWF0ZSkKICAgIChmdW5jdGlvbigpewogICAgICB2YXIgTUVTU0FHRV9OQU1FID0gJ2Jhc2lzanMuc2V0SW1tZWRpYXRlJzsKICAgICAgdmFyIHJ1blRhc2sgPSAoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgdGFza0J5SWQgPSB7fTsKICAgICAgICB2YXIgdGFza0lkID0gMTsKCiAgICAgICAgLy8gZW11bGF0ZSBzZXRJbW1lZGlhdGUKICAgICAgICBzZXRJbW1lZGlhdGUgPSBmdW5jdGlvbihmbi8qLCAuLmFyZ3MgKi8pewogICAgICAgICAgaWYgKHR5cGVvZiBmbiAhPSAnZnVuY3Rpb24nKQogICAgICAgICAgewogICAgICAgICAgICAvKiogQGN1dCAqLyBjb25zb2xlTWV0aG9kcy53YXJuKCdiYXNpcy5zZXRJbW1lZGlhdGUoKSBhbmQgYmFzaXMubmV4dFRpY2soKSBhY2NlcHQgZnVuY3Rpb25zIG9ubHkgKGNhbGwgaWdub3JlZCknKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHRhc2tCeUlkWysrdGFza0lkXSA9IHsKICAgICAgICAgICAgZm46IGZuLAogICAgICAgICAgICBhcmdzOiBhcnJheUZyb20oYXJndW1lbnRzLCAxKQogICAgICAgICAgfTsKCiAgICAgICAgICBhZGRUb1F1ZXVlKHRhc2tJZCk7CgogICAgICAgICAgcmV0dXJuIHRhc2tJZDsKICAgICAgICB9OwoKICAgICAgICAvLyBlbXVsYXRlIGNsZWFySW1tZWRpYXRlCiAgICAgICAgY2xlYXJJbW1lZGlhdGUgPSBmdW5jdGlvbihpZCl7CiAgICAgICAgICBkZWxldGUgdGFza0J5SWRbaWRdOwogICAgICAgIH07CgogICAgICAgIC8vCiAgICAgICAgLy8gcmV0dXJuIHJlc3VsdCBmdW5jdGlvbiBmb3IgdGFzayBydW4KICAgICAgICAvLwogICAgICAgIHJldHVybiBmdW5jdGlvbihpZCl7CiAgICAgICAgICB2YXIgdGFzayA9IHRhc2tCeUlkW2lkXTsKCiAgICAgICAgICBpZiAodGFzaykKICAgICAgICAgIHsKICAgICAgICAgICAgZGVsZXRlIHRhc2tCeUlkW2lkXTsKICAgICAgICAgICAgcmV0dXJuIHRhc2suZm4uYXBwbHkodW5kZWZpbmVkLCB0YXNrLmFyZ3MpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0pKCk7CgogICAgICAvLyBieSBkZWZhdWx0CiAgICAgIHZhciBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKXsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICBydW5UYXNrKHRhc2tJZCk7CiAgICAgICAgfSwgMCk7CiAgICAgIH07CgogICAgICAvLwogICAgICAvLyBpbXBsZW1lbnQgcGxhdGZvcm0gc3BlY2lmaWMgc29sdXRpb24KICAgICAgLy8KICAgICAgaWYgKGdsb2JhbC5wcm9jZXNzICYmIHR5cGVvZiBwcm9jZXNzLm5leHRUaWNrID09ICdmdW5jdGlvbicpCiAgICAgIHsKICAgICAgICAvLyB1c2UgbmV4dCB0aWNrIG9uIG5vZGUuanMKICAgICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKXsKICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKXsKICAgICAgICAgICAgcnVuVGFzayh0YXNrSWQpOwogICAgICAgICAgfSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBlbHNlCiAgICAgIHsKICAgICAgICBpZiAoZ2xvYmFsLk1lc3NhZ2VDaGFubmVsKQogICAgICAgIHsKICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IGdsb2JhbC5NZXNzYWdlQ2hhbm5lbCgpOwoKICAgICAgICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgICB2YXIgdGFza0lkID0gZXZlbnQuZGF0YTsKICAgICAgICAgICAgcnVuVGFzayh0YXNrSWQpOwogICAgICAgICAgfTsKCiAgICAgICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKXsKICAgICAgICAgICAgY2hhbm5lbC5wb3J0Mi5wb3N0TWVzc2FnZSh0YXNrSWQpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgIC8vIFRoZSB0ZXN0IGFnYWluc3QgYGltcG9ydFNjcmlwdHNgIHByZXZlbnRzIHRoaXMgaW1wbGVtZW50YXRpb24gZnJvbSBiZWluZyBpbnN0YWxsZWQgaW5zaWRlIGEgd2ViIHdvcmtlciwKICAgICAgICAgIC8vIHdoZXJlIGBnbG9iYWwucG9zdE1lc3NhZ2VgIG1lYW5zIHNvbWV0aGluZyBjb21wbGV0ZWx5IGRpZmZlcmVudCBhbmQgY2FuJ3QgYmUgdXNlZCBmb3IgdGhpcyBwdXJwb3NlLgogICAgICAgICAgdmFyIHBvc3RNZXNzYWdlU3VwcG9ydGVkID0gZ2xvYmFsLnBvc3RNZXNzYWdlICYmICFnbG9iYWwuaW1wb3J0U2NyaXB0czsKCiAgICAgICAgICAvLyBJRTggaGFzIHBvc3RNZXNzYWdlIGltcGxlbWVudGF0aW9uLCBidXQgaXQgaXMgc3luY2hyb25vdXMgYW5kIGNhbid0IGJlIHVzZWQuCiAgICAgICAgICBpZiAocG9zdE1lc3NhZ2VTdXBwb3J0ZWQpCiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvbGRPbk1lc3NhZ2UgPSBnbG9iYWwub25tZXNzYWdlOwogICAgICAgICAgICBnbG9iYWwub25tZXNzYWdlID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBwb3N0TWVzc2FnZVN1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgICAgICB9OwogICAgICAgICAgICBnbG9iYWwucG9zdE1lc3NhZ2UoJycsICcqJyk7CiAgICAgICAgICAgIGdsb2JhbC5vbm1lc3NhZ2UgPSBvbGRPbk1lc3NhZ2U7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHBvc3RNZXNzYWdlU3VwcG9ydGVkKQogICAgICAgICAgewogICAgICAgICAgICAvLyBwb3N0TWVzc2FnZSBzY2hlbWUKICAgICAgICAgICAgdmFyIHNldEltbWVkaWF0ZUhhbmRsZXIgPSBmdW5jdGlvbihldmVudCl7CiAgICAgICAgICAgICAgaWYgKGV2ZW50ICYmIGV2ZW50LnNvdXJjZSA9PSBnbG9iYWwpCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHRhc2tJZCA9IFN0cmluZyhldmVudC5kYXRhKS5zcGxpdChNRVNTQUdFX05BTUUpWzFdOwoKICAgICAgICAgICAgICAgIGlmICh0YXNrSWQpCiAgICAgICAgICAgICAgICAgIHJ1blRhc2sodGFza0lkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAoZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIpCiAgICAgICAgICAgICAgZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBzZXRJbW1lZGlhdGVIYW5kbGVyLCB0cnVlKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgIGdsb2JhbC5hdHRhY2hFdmVudCgnb25tZXNzYWdlJywgc2V0SW1tZWRpYXRlSGFuZGxlcik7CgogICAgICAgICAgICAvLyBNYWtlIGBnbG9iYWxgIHBvc3QgYSBtZXNzYWdlIHRvIGl0c2VsZiB3aXRoIHRoZSBoYW5kbGUgYW5kIGlkZW50aWZ5aW5nIHByZWZpeCwgdGh1cyBhc3luY2hyb25vdXNseQogICAgICAgICAgICAvLyBpbnZva2luZyBvdXIgb25HbG9iYWxNZXNzYWdlIGxpc3RlbmVyIGFib3ZlLgogICAgICAgICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24odGFza0lkKXsKICAgICAgICAgICAgICBnbG9iYWwucG9zdE1lc3NhZ2UoTUVTU0FHRV9OQU1FICsgdGFza0lkLCAnKicpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgZWxzZQogICAgICAgICAgewogICAgICAgICAgICB2YXIgY3JlYXRlU2NyaXB0ID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpZiAoZG9jdW1lbnQgJiYgJ29ucmVhZHlzdGF0ZWNoYW5nZScgaW4gY3JlYXRlU2NyaXB0KCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAvLyBDcmVhdGUgYSA8c2NyaXB0PiBlbGVtZW50OyBpdHMgcmVhZHlzdGF0ZWNoYW5nZSBldmVudCB3aWxsIGJlIGZpcmVkIGFzeW5jaHJvbm91c2x5IG9uY2UgaXQgaXMgaW5zZXJ0ZWQKICAgICAgICAgICAgICAvLyBpbnRvIHRoZSBkb2N1bWVudC4gRG8gc28sIHRodXMgcXVldWluZyB1cCB0aGUgdGFzay4gUmVtZW1iZXIgdG8gY2xlYW4gdXAgb25jZSBpdCdzIGJlZW4gY2FsbGVkCiAgICAgICAgICAgICAgdmFyIGRlZmF1bHRBZGRUb1F1ZXVlID0gYWRkVG9RdWV1ZTsKICAgICAgICAgICAgICBhZGRUb1F1ZXVlID0gZnVuY3Rpb24gYmVmb3JlSGVhZFJlYWR5KHRhc2tJZCl7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGRvY3VtZW50SW50ZXJmYWNlICE9ICd1bmRlZmluZWQnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBhZGRUb1F1ZXVlID0gZGVmYXVsdEFkZFRvUXVldWU7CgogICAgICAgICAgICAgICAgICBkb2N1bWVudEludGVyZmFjZS5oZWFkLnJlYWR5KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCl7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc2NyaXB0RWwgPSBjcmVhdGVTY3JpcHQoKTsKICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdEVsLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdEVsLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vc2NyaXB0RWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHRFbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50SW50ZXJmYWNlLnJlbW92ZShzY3JpcHRFbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdEVsID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNob3VsZCBiZSBjYWxsZWQgbGFzdCBhcyBleGNlcHRpb24gcG9zc2libGUKICAgICAgICAgICAgICAgICAgICAgICAgcnVuVGFzayh0YXNrSWQpOwogICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgIC8vZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKHNjcmlwdEVsKTsKICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50SW50ZXJmYWNlLmhlYWQuYWRkKHNjcmlwdEVsKTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYWRkVG9RdWV1ZSA9PT0gYmVmb3JlSGVhZFJlYWR5KQogICAgICAgICAgICAgICAgICBkZWZhdWx0QWRkVG9RdWV1ZSh0YXNrSWQpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICBhZGRUb1F1ZXVlKHRhc2tJZCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSkoKTsKCgogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgLy8gcGF0aCB1dGlscwogIC8vCgogIHZhciBOT0RFX0VOViA9IHR5cGVvZiBwcm9jZXNzID09ICdvYmplY3QnICYmIHRvU3RyaW5nLmNhbGwocHJvY2VzcykgPT0gJ1tvYmplY3QgcHJvY2Vzc10nOwoKIC8qKgogICogVXRpbGl0aWVzIGZvciBoYW5kbGluZyBhbmQgdHJhbnNmb3JtaW5nIGZpbGUgcGF0aHMuIEFsbCB0aGVzZSBmdW5jdGlvbnMgcGVyZm9ybQogICogb25seSBzdHJpbmcgdHJhbnNmb3JtYXRpb25zLiBTZXJ2ZXIgb3Igc29tZXRoaW5nIGVsc2UgYXJlIG5vdCBjb25zdWx0ZWQgdG8KICAqIGNoZWNrIHdoZXRoZXIgcGF0aHMgYXJlIHZhbGlkLgogICoKICAqIEZ1bmN0aW9ucyBhcmUgd29yayBzaW1pbGFyIHRvIG5vZGUuanMgYHBhdGhgIG1vZHVsZS4gRm9yIG5vZGUuanMgZW52aXJvbm1lbnQKICAqIGBwYXRoYCBtb2R1bGUgaXMgdXNlZC4KICAqCiAgKiBAbmFtZSBwYXRoCiAgKiBAbmFtZXNwYWNlIGJhc2lzLnBhdGgKICAqLwogIHZhciBwYXRoVXRpbHMgPSAoZnVuY3Rpb24oKXsKICAgIHZhciBBQlNPTFVURV9SWCA9IC9eKFteXC9dKzp8XC8pLzsKICAgIHZhciBQUk9UT0NPTF9SWCA9IC9eW2EtekEtWjAtOVwtXSs6XC8/LzsKICAgIHZhciBPUklHSU5fUlggPSAvXig/OlthLXpBLVowLTlcLV0rOik/XC9cL1teXC9dK1wvPy87CiAgICB2YXIgU0VBUkNIX0hBU0hfUlggPSAvW1w/I10uKiQvOwoKICAgIHZhciBiYXNlVVJJOwogICAgdmFyIG9yaWdpbjsKICAgIHZhciB1dGlsczsKCiAgICBpZiAoTk9ERV9FTlYpCiAgICB7CiAgICAgIC8vIHRyeSB0byB1c2UgYmFzZVVSSSBmcm9tIHByb2Nlc3MsIGl0IG1heSBiZSBwcm92aWRlZCBieSBwYXJlbnQgbW9kdWxlCiAgICAgIHZhciBwYXRoID0gKHByb2Nlc3MuYmFzaXNqc0Jhc2VVUkkgfHwgcmVxdWlyZSgncGF0aCcpLnJlc29sdmUoJy4nKSkucmVwbGFjZSgvXFwvZywgJy8nKTsgLy8gb24gV2luZG93cyBwYXRoIGNvbnRhaW5zIGJhY2tzbGFzaGVzCiAgICAgIGJhc2VVUkkgPSBwYXRoLnJlcGxhY2UoL15bXlwvXSovLCAnJyk7CiAgICAgIG9yaWdpbiA9IHBhdGgucmVwbGFjZSgvXC8uKi8sICcnKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgYmFzZVVSSSA9IGxvY2F0aW9uLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dKyQvLCAnJyk7CiAgICAgIG9yaWdpbiA9IGxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIGxvY2F0aW9uLmhvc3Q7CiAgICB9CgogICAgdXRpbHMgPSB7CiAgICAgIGJhc2VVUkk6IGJhc2VVUkksCiAgICAgIG9yaWdpbjogb3JpZ2luLAoKICAgICAvKioKICAgICAgKiBOb3JtYWxpemUgYSBzdHJpbmcgcGF0aCwgdGFraW5nIGNhcmUgb2YgJy4uJyBhbmQgJy4nIHBhcnRzLgogICAgICAqIFdoZW4gbXVsdGlwbGUgc2xhc2hlcyBhcmUgZm91bmQsIHRoZXkncmUgcmVwbGFjZWQgYnkgYSBzaW5nbGUgb25lOwogICAgICAqIHdoZW4gdGhlIHBhdGggY29udGFpbnMgYSB0cmFpbGluZyBzbGFzaCwgaXQgaXMgcHJlc2VydmVkLgogICAgICAqCiAgICAgICogT3JpZ2luIGlzIG5vdCBpbmNsdWRlcyBpbiByZXN1bHQgcGF0aC4KICAgICAgKgogICAgICAqIEBleGFtcGxlCiAgICAgICogICBiYXNpcy5wYXRoLm5vcm1hbGl6ZSgnL2Zvby9iYXIvL2Jhei9hc2RmL3F1dXgvLi4nKTsKICAgICAgKiAgIC8vIHJldHVybnMgJy9mb28vYmFyL2Jhei9hc2RmJwogICAgICAqCiAgICAgICogICBiYXNpcy5wYXRoLm5vcm1hbGl6ZSgnaHR0cDovL2V4YW1wbGUuY29tOjgwODAvZm9vLy8uLi8vYmFyLycpOwogICAgICAqICAgLy8gcmV0dXJucyAnL2JhcicKICAgICAgKgogICAgICAqICAgYmFzaXMucGF0aC5ub3JtYWxpemUoJy8vbG9jYWxob3N0L2Zvby8uLy4uLy9iYXIvJyk7CiAgICAgICogICAvLyByZXR1cm5zICcvYmFyJwogICAgICAqCiAgICAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGgKICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICAgICovCiAgICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24ocGF0aCl7CiAgICAgICAgcGF0aCA9IChwYXRoIHx8ICcnKQogICAgICAgICAgICAgIC5yZXBsYWNlKFBST1RPQ09MX1JYLCAnLycpCiAgICAgICAgICAgICAgLnJlcGxhY2UoT1JJR0lOX1JYLCAnLycpICAgICAgICAvLyBidXQgY3V0IG9mZiBvcmlnaW4KICAgICAgICAgICAgICAucmVwbGFjZShTRUFSQ0hfSEFTSF9SWCwgJycpOyAgIC8vIGN1dCBvZmYgcXVlcnkgc2VhcmNoIGFuZCBoYXNoCgogICAgICAgIC8vIHVzZSBsaW5rIGVsZW1lbnQgYXMgcGF0aCByZXNvbHZlcgogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCcvJyk7ICAgICAgICAgICAgIC8vIHNwbGl0CgogICAgICAgIC8vIHByb2Nlc3MgcGF0aCBwYXJ0cwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgaWYgKHBhcnRzW2ldID09ICcuLicpCiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMSB8fCByZXN1bHRbMF0pCiAgICAgICAgICAgICAgcmVzdWx0LnBvcCgpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZQogICAgICAgICAgewogICAgICAgICAgICBpZiAoKHBhcnRzW2ldIHx8ICFpKSAmJiBwYXJ0c1tpXSAhPSAnLicpCiAgICAgICAgICAgICAgcmVzdWx0LnB1c2gocGFydHNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdC5qb2luKCcvJykgfHwKICAgICAgICAgICAgICAgKHBhdGhbMF0gPT09ICcvJyA/ICcvJyA6ICcnKTsKICAgICAgfSwKCiAgICAgLyoqCiAgICAgICogUmV0dXJuIHRoZSBkaXJlY3RvcnkgbmFtZSBvZiBhIHBhdGguIFNpbWlsYXIgdG8gbm9kZS5qcyBwYXRoLmRpcm5hbWUKICAgICAgKiBvciB0aGUgVW5peCBkaXJuYW1lIGNvbW1hbmQuCiAgICAgICoKICAgICAgKiBAZXhhbXBsZQogICAgICAqICAgYmFzaXMucGF0aC5kaXJuYW1lKCcvZm9vL2Jhci9iYXovd2hhdGV2ZXInKTsgLy8gcmV0dXJucyAnL2Zvby9iYXIvYmF6JwogICAgICAqCiAgICAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGgKICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICAgICovCiAgICAgIGRpcm5hbWU6IGZ1bmN0aW9uKHBhdGgpewogICAgICAgIHZhciByZXN1bHQgPSB1dGlscy5ub3JtYWxpemUocGF0aCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdC5yZXBsYWNlKC9cLyhbXlwvXSopJHxeW15cL10rJC8sICcnKSB8fAogICAgICAgICAgICAgICAocmVzdWx0WzBdID09ICcvJyA/ICcvJyA6ICcuJyk7CiAgICAgIH0sCgogICAgIC8qKgogICAgICAqIFJldHVybiB0aGUgZXh0ZW5zaW9uIG9mIHRoZSBwYXRoLCBmcm9tIHRoZSBsYXN0ICcuJyB0byBlbmQgb2Ygc3RyaW5nCiAgICAgICogaW4gdGhlIGxhc3QgcG9ydGlvbiBvZiB0aGUgcGF0aC4gSWYgdGhlcmUgaXMgbm8gJy4nIGluIHRoZSBsYXN0CiAgICAgICogcG9ydGlvbiBvZiB0aGUgcGF0aCBvciB0aGUgZmlyc3QgY2hhcmFjdGVyIG9mIGl0IGlzICcuJywgdGhlbiBpdAogICAgICAqIHJldHVybnMgYW4gZW1wdHkgc3RyaW5nLgogICAgICAqCiAgICAgICogQGV4YW1wbGUKICAgICAgKiAgIGJhc2lzLnBhdGguZXh0bmFtZSgnaW5kZXguaHRtbCcpOyAvLyByZXR1cm5zICcuaHRtbCcKICAgICAgKiAgIGJhc2lzLnBhdGguZXh0bmFtZSgnaW5kZXguJyk7ICAgICAvLyByZXR1cm5zICcuJwogICAgICAqICAgYmFzaXMucGF0aC5leHRuYW1lKCdpbmRleCcpOyAgICAgIC8vIHJldHVybnMgJycKICAgICAgKgogICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoCiAgICAgICogQHJldHVybiB7c3RyaW5nfSBQYXRoIGV4dGVuc2lvbiB3aXRoIGxlYWRpbmcgZG90IG9yIGVtcHR5IHN0cmluZy4KICAgICAgKi8KICAgICAgZXh0bmFtZTogZnVuY3Rpb24ocGF0aCl7CiAgICAgICAgdmFyIGV4dCA9IHV0aWxzLm5vcm1hbGl6ZShwYXRoKS5tYXRjaCgvW15cL10oXC5bXlwvXC5dKikkLyk7CiAgICAgICAgcmV0dXJuIGV4dCA/IGV4dFsxXSA6ICcnOwogICAgICB9LAoKICAgICAvKioKICAgICAgKiBSZXR1cm4gdGhlIGxhc3QgcG9ydGlvbiBvZiBhIHBhdGguIFNpbWlsYXIgdG8gbm9kZS5qcyBwYXRoLmJhc2VuYW1lCiAgICAgICogb3IgdGhlIFVuaXggYmFzZW5hbWUgY29tbWFuZC4KICAgICAgKgogICAgICAqIEBleGFtcGxlCiAgICAgICogICBiYXNpcy5wYXRoLmJhc2VuYW1lKCcvZm9vL2Jhci9iYXouaHRtbCcpOyAgICAgICAgICAvLyByZXR1cm5zICdiYXouaHRtbCcKICAgICAgKiAgIGJhc2lzLnBhdGguYmFzZW5hbWUoJy9mb28vYmFyL2Jhei5odG1sJywgJy5odG1sJyk7IC8vIHJldHVybnMgJ2JheicKICAgICAgKgogICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoCiAgICAgICogQHBhcmFtIHtzdHJpbmc9fSBleHQKICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICAgICovCiAgICAgIGJhc2VuYW1lOiBmdW5jdGlvbihwYXRoLCBleHQpewogICAgICAgIHZhciBmaWxlbmFtZSA9IHV0aWxzLm5vcm1hbGl6ZShwYXRoKS5tYXRjaCgvW15cXFwvXSokLyk7CiAgICAgICAgZmlsZW5hbWUgPSBmaWxlbmFtZSA/IGZpbGVuYW1lWzBdIDogJyc7CgogICAgICAgIGlmIChleHQgPT0gdXRpbHMuZXh0bmFtZShmaWxlbmFtZSkpCiAgICAgICAgICBmaWxlbmFtZSA9IGZpbGVuYW1lLnN1YnN0cmluZygwLCBmaWxlbmFtZS5sZW5ndGggLSBleHQubGVuZ3RoKTsKCiAgICAgICAgcmV0dXJuIGZpbGVuYW1lOwogICAgICB9LAoKICAgICAvKioKICAgICAgKiBSZXNvbHZlcyB0byB0byBhbiBhYnNvbHV0ZSBwYXRoLgogICAgICAqCiAgICAgICogSWYgdG8gaXNuJ3QgYWxyZWFkeSBhYnNvbHV0ZSBmcm9tIGFyZ3VtZW50cyBhcmUgcHJlcGVuZGVkIGluIHJpZ2h0CiAgICAgICogdG8gbGVmdCBvcmRlciwgdW50aWwgYW4gYWJzb2x1dGUgcGF0aCBpcyBmb3VuZC4gSWYgYWZ0ZXIgdXNpbmcgYWxsCiAgICAgICogZnJvbSBwYXRocyBzdGlsbCBubyBhYnNvbHV0ZSBwYXRoIGlzIGZvdW5kLCB0aGUgY3VycmVudCBsb2NhdGlvbiBpcwogICAgICAqIHVzZWQgYXMgd2VsbC4gVGhlIHJlc3VsdGluZyBwYXRoIGlzIG5vcm1hbGl6ZWQsIGFuZCB0cmFpbGluZyBzbGFzaGVzCiAgICAgICogYXJlIHJlbW92ZWQgdW5sZXNzIHRoZSBwYXRoIGdldHMgcmVzb2x2ZWQgdG8gdGhlIHJvb3QgZGlyZWN0b3J5LgogICAgICAqIE5vbi1zdHJpbmcgYXJndW1lbnRzIGFyZSBpZ25vcmVkLgogICAgICAqCiAgICAgICogQGV4YW1wbGUKICAgICAgKiAgIGJhc2lzLnBhdGgucmVzb2x2ZSgnL2Zvby9iYXInLCAnLi9iYXonKTsKICAgICAgKiAgIC8vIHJldHVybnMgJy9mb28vYmFyL2JheicKICAgICAgKgogICAgICAqICAgYmFzaXMucGF0aC5yZXNvbHZlKCcvZm9vL2JhcicsICcvZGVtby9maWxlLycpOwogICAgICAqICAgLy8gcmV0dXJucyAnL2RlbW8vZmlsZScKICAgICAgKgogICAgICAqICAgYmFzaXMucGF0aC5yZXNvbHZlKCdmb28nLCAnYmFyL2Jhei8nLCAnLi4vZ2lmL2ltYWdlLmdpZicpOwogICAgICAqICAgLy8gaWYgY3VycmVudCBsb2NhdGlvbiBpcyAvZGVtbywgaXQgcmV0dXJucyAnL2RlbW8vZm9vL2Jhci9naWYvaW1hZ2UuZ2lmJwogICAgICAqCiAgICAgICogQHBhcmFtIHsuLnN0cmluZz19IGZyb20KICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdG8KICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICAgICovCiAgICAgIHJlc29sdmU6IGZ1bmN0aW9uKGZyb20sIHRvKXsKICAgICAgICB2YXIgYXJncyA9IGFycmF5RnJvbShhcmd1bWVudHMpLnJldmVyc2UoKTsKICAgICAgICB2YXIgcGF0aCA9IFtdOwogICAgICAgIHZhciBhYnNvbHV0ZUZvdW5kID0gZmFsc2U7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyAhYWJzb2x1dGVGb3VuZCAmJiBpIDwgYXJncy5sZW5ndGg7IGkrKykKICAgICAgICAgIGlmICh0eXBlb2YgYXJnc1tpXSA9PSAnc3RyaW5nJykKICAgICAgICAgIHsKICAgICAgICAgICAgcGF0aC51bnNoaWZ0KGFyZ3NbaV0pOwogICAgICAgICAgICBhYnNvbHV0ZUZvdW5kID0gQUJTT0xVVEVfUlgudGVzdChhcmdzW2ldKTsKICAgICAgICAgIH0KCiAgICAgICAgaWYgKCFhYnNvbHV0ZUZvdW5kKQogICAgICAgICAgcGF0aC51bnNoaWZ0KGJhc2VVUkkgPT0gJy8nID8gJycgOiBiYXNlVVJJKTsKCiAgICAgICAgcmV0dXJuIHV0aWxzLm5vcm1hbGl6ZShwYXRoLmpvaW4oJy8nKSk7CiAgICAgIH0sCgogICAgIC8qKgogICAgICAqIFNvbHZlIHRoZSByZWxhdGl2ZSBwYXRoIGZyb20gZnJvbSB0byB0by4KICAgICAgKgogICAgICAqIEF0IHRpbWVzIHdlIGhhdmUgdHdvIGFic29sdXRlIHBhdGhzLCBhbmQgd2UgbmVlZCB0byBkZXJpdmUgdGhlCiAgICAgICogcmVsYXRpdmUgcGF0aCBmcm9tIG9uZSB0byB0aGUgb3RoZXIuIFRoaXMgaXMgYWN0dWFsbHkgdGhlIHJldmVyc2UKICAgICAgKiB0cmFuc2Zvcm0gb2Yge2Jhc2lzLnBhdGgucmVzb2x2ZX0sIHdoaWNoIG1lYW5zIHdlIHNlZSB0aGF0OgogICAgICAqCiAgICAgICogICBiYXNpcy5wYXRoLnJlc29sdmUoZnJvbSwgYmFzaXMucGF0aC5yZWxhdGl2ZShmcm9tLCB0bykpID09IGJhc2lzLnBhdGgucmVzb2x2ZSh0bykKICAgICAgKgogICAgICAqIElmIGB0b2AgYXJndW1lbnQgb21pdHRlZCB0aGFuIHJlc29sdmUgYGZyb21gIHJlbGF0aXZlIHRvIGN1cnJlbnQgYmFzZVVSSS4KICAgICAgKgogICAgICAqIEZ1bmN0aW9uIGFsc28gY291bGQgYmUgdXNlZCB3aXRoIEFycmF5I21hcCBtZXRob2QgYXMgd2VsbC4gSW4gdGhpcyBjYXNlCiAgICAgICogZXZlcnkgYXJyYXkgbWVtYmVyIHJlc29sdmVzIHRvIGN1cnJlbnQgYmFzZVVSSS4KICAgICAgKgogICAgICAqIEBleGFtcGxlCiAgICAgICogICBiYXNpcy5wYXRoLnJlbGF0aXZlKCcvZGF0YS9vcmFuZGVhL3Rlc3QvYWFhJywgJy9kYXRhL29yYW5kZWEvaW1wbC9iYmInKTsKICAgICAgKiAgIC8vIHJldHVybnMgJy4uLy4uL2ltcGwvYmJiJwogICAgICAqCiAgICAgICogICBbJ2ZvbycsICcvYS9iL2JhcicsICdhL2IvYmF6J10ubWFwKGJhc2lzLnBhdGgucmVsYXRpdmUpOwogICAgICAqICAgLy8gaWYgYmFzZVVSSSBpcyAnL2EvYicgaXQgcHJvZHVjZXMKICAgICAgKiAgIC8vIFsnLi4vLi4vZm9vJywgJ2JhcicsICcuLi8uLi9hL2IvYmF6J10KICAgICAgKgogICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmcm9tCiAgICAgICogQHBhcmFtIHtzdHJpbmc9fSB0bwogICAgICAqIEByZXR1cm4ge3N0cmluZ30KICAgICAgKi8KICAgICAgcmVsYXRpdmU6IGZ1bmN0aW9uKGZyb20sIHRvKXsKICAgICAgICAvLyBpdCBtYWtlcyBmdW5jdGlvbiB1c2VmdWwgd2l0aCBhcnJheSBpdGVyYXRlIG1ldGhvZHMsIGkuZS4KICAgICAgICAvLyBbJ2ZvbycsICdiYXInXS5tYXAoYmFzaXMucGF0aC5yZWxhdGl2ZSkKICAgICAgICBpZiAodHlwZW9mIHRvICE9ICdzdHJpbmcnKQogICAgICAgIHsKICAgICAgICAgIHRvID0gZnJvbTsKICAgICAgICAgIGZyb20gPSBiYXNlVVJJOwogICAgICAgIH0KCiAgICAgICAgZnJvbSA9IHV0aWxzLm5vcm1hbGl6ZShmcm9tKTsKICAgICAgICB0byA9IHV0aWxzLm5vcm1hbGl6ZSh0byk7CgogICAgICAgIGlmIChmcm9tWzBdID09ICcvJyAmJiB0b1swXSAhPSAnLycpCiAgICAgICAgICByZXR1cm4gZnJvbTsKICAgICAgICBpZiAodG9bMF0gPT0gJy8nICYmIGZyb21bMF0gIT0gJy8nKQogICAgICAgICAgcmV0dXJuIHRvOwoKICAgICAgICB2YXIgYmFzZSA9IGZyb20ucmVwbGFjZSgvXlwvJC8sICcnKS5zcGxpdCgvXC8vKTsKICAgICAgICB2YXIgcGF0aCA9IHRvLnJlcGxhY2UoL15cLyQvLCAnJykuc3BsaXQoL1wvLyk7CiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICAgIHZhciBpID0gMDsKCiAgICAgICAgd2hpbGUgKHBhdGhbaV0gPT0gYmFzZVtpXSAmJiB0eXBlb2YgYmFzZVtpXSA9PSAnc3RyaW5nJykKICAgICAgICAgIGkrKzsKCiAgICAgICAgZm9yICh2YXIgaiA9IGJhc2UubGVuZ3RoIC0gaTsgaiA+IDA7IGotLSkKICAgICAgICAgIHJlc3VsdC5wdXNoKCcuLicpOwoKICAgICAgICByZXR1cm4gcmVzdWx0LmNvbmNhdChwYXRoLnNsaWNlKGkpLmZpbHRlcihCb29sZWFuKSkuam9pbignLycpOwogICAgICB9CiAgICB9OwoKICAgIHJldHVybiB1dGlsczsKICB9KSgpOwoKCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgLy8gYXBwbHkgY29uZmlnCiAgLy8KCiAvKioKICAqIEBuYW1lc3BhY2UgYmFzaXMKICAqLwoKICB2YXIgYmFzaXNGaWxlbmFtZSA9IF9fYmFzaXNGaWxlbmFtZSB8fCAnJzsKICB2YXIgY29uZmlnID0gZmV0Y2hDb25maWcoKTsKCiAvKioKICAqIEZldGNoIGJhc2lzLmpzIG9wdGlvbnMgZnJvbSBzY3JpcHQncyBgYmFzaXMtY29uZmlnYCBvciBgZGF0YS1iYXNpcy1jb25maWdgIGF0dHJpYnV0ZS4KICAqLwogIGZ1bmN0aW9uIGZldGNoQ29uZmlnKCl7CiAgICB2YXIgY29uZmlnID0gX19jb25maWc7CgogICAgaWYgKCFjb25maWcpCiAgICB7CiAgICAgIGlmIChOT0RFX0VOVikKICAgICAgewogICAgICAgIC8vIG5vZGUuanMgZW52CiAgICAgICAgYmFzaXNGaWxlbmFtZSA9IF9fZmlsZW5hbWUucmVwbGFjZSgvXFwvZywgJy8nKTsgIC8vIG9uIFdpbmRvd3MgcGF0aCBjb250YWlucyBiYWNrc2xhc2hlcwogICAgICB9CiAgICAgIGVsc2UKICAgICAgewogICAgICAgIC8vIGJyb3dzZXIgZW52CiAgICAgICAgdmFyIHNjcmlwdHMgPSBkb2N1bWVudC5zY3JpcHRzOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBzY3JpcHRFbDsgc2NyaXB0RWwgPSBzY3JpcHRzW2ldOyBpKyspCiAgICAgICAgewogICAgICAgICAgdmFyIGNvbmZpZ0F0dHJWYWx1ZSA9IHNjcmlwdEVsLmhhc0F0dHJpYnV0ZSgnYmFzaXMtY29uZmlnJykKICAgICAgICAgICAgPyBzY3JpcHRFbC5nZXRBdHRyaWJ1dGUoJ2Jhc2lzLWNvbmZpZycpCiAgICAgICAgICAgIDogc2NyaXB0RWwuZ2V0QXR0cmlidXRlKCdkYXRhLWJhc2lzLWNvbmZpZycpOwoKICAgICAgICAgIHNjcmlwdEVsLnJlbW92ZUF0dHJpYnV0ZSgnYmFzaXMtY29uZmlnJyk7CiAgICAgICAgICBzY3JpcHRFbC5yZW1vdmVBdHRyaWJ1dGUoJ2RhdGEtYmFzaXMtY29uZmlnJyk7CgogICAgICAgICAgaWYgKGNvbmZpZ0F0dHJWYWx1ZSAhPT0gbnVsbCkKICAgICAgICAgIHsKICAgICAgICAgICAgYmFzaXNGaWxlbmFtZSA9IHBhdGhVdGlscy5ub3JtYWxpemUoc2NyaXB0RWwuc3JjKTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY29uZmlnID0gRnVuY3Rpb24oJ3JldHVybnsnICsgY29uZmlnQXR0clZhbHVlICsgJ30nKSgpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAvKiogQGN1dCAqLyBjb25zb2xlTWV0aG9kcy5lcnJvcignYmFzaXMtY29uZmlnOiBiYXNpcy5qcyBjb25maWcgcGFyc2UgZmF1bHQ6ICcgKyBlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHByb2Nlc3NDb25maWcoY29uZmlnKTsKICB9CgogLyoqCiAgKiBQcm9jZXNzIGNvbmZpZyBvYmplY3QgYW5kIHJldHVybnMgYWRvcHRlZCBjb25maWcuCiAgKgogICogU3BlY2lhbCBvcHRpb25zOgogICogLSBhdXRvbG9hZDogbmFtZXNwYWNlIHRoYXQgbXVzdCBiZSBsb2FkZWQgcmlnaHQgYWZ0ZXIgY29yZSBsb2FkZWQKICAqIC0gcGF0aDogZGljdGlvbmFyeSBvZiBwYXRocyBmb3Igcm9vdCBuYW1lc3BhY2VzCiAgKiAtIG1vZHVsZXM6IGRpY3Rpb25hcnkgb2YgbW9kdWxlcyB3aXRoIG9wdGlvbnMKICAqCiAgKiBPdGhlciBvcHRpb25zIGNvcHkgaW50byBiYXNpcy5jb25maWcgYXMgaXMuCiAgKi8KICBmdW5jdGlvbiBwcm9jZXNzQ29uZmlnKGNvbmZpZywgdmVyYm9zZSl7CiAgICAvLyBtYWtlIGEgY29weSBvZiBjb25maWcKICAgIGNvbmZpZyA9IHNsaWNlKGNvbmZpZyk7CgogICAgLy8gd2FybiBhYm91dCBleHRQcm90byBpbiBiYXNpcy1jb25maWcsIHRoaXMgb3B0aW9uIHdhcyByZW1vdmVkIGluIDEuMy4wCiAgICAvKiogQGN1dCAqLyBpZiAoJ2V4dFByb3RvJyBpbiBjb25maWcpCiAgICAvKiogQGN1dCAqLyAgIGNvbnNvbGVNZXRob2RzLndhcm4oJ2Jhc2lzLWNvbmZpZzogYGV4dFByb3RvYCBvcHRpb24gaW4gYmFzaXMtY29uZmlnIGlzIG5vdCBzdXBwb3J0IGFueW1vcmUnKTsKCiAgICAvLyB3YXJuIGFib3V0IHBhdGggaW4gYmFzaXMtY29uZmlnLCB0aGlzIG9wdGlvbiB3YXMgZGVwcmVjYXRlZCBpbiAxLjMuMAogICAgLyoqIEBjdXQgKi8gaWYgKCdwYXRoJyBpbiBjb25maWcpCiAgICAvKiogQGN1dCAqLyAgIGNvbnNvbGVNZXRob2RzLndhcm4oJ2Jhc2lzLWNvbmZpZzogYHBhdGhgIG9wdGlvbiBpbiBiYXNpcy1jb25maWcgaXMgZGVwcmVjYXRlZCwgdXNlIGBtb2R1bGVzYCBpbnN0ZWFkJyk7CgogICAgLy8gYnVpbGQgbW9kdWxlcyBsaXN0CiAgICB2YXIgYXV0b2xvYWQgPSBbXTsKICAgIHZhciBtb2R1bGVzID0gbWVyZ2UoY29uZmlnLnBhdGgsIGNvbmZpZy5tb2R1bGVzLCB7CiAgICAgIGJhc2lzOiBiYXNpc0ZpbGVuYW1lCiAgICB9KTsKCiAgICAvLyByZXNldCBtb2R1bGVzCiAgICBjb25maWcubW9kdWxlcyA9IHt9OwoKICAgIC8vIHByb2Nlc3MgYXV0b2xvYWQKICAgIGlmIChjb25maWcuYXV0b2xvYWQpCiAgICB7CiAgICAgIC8vIFtwYXRoL3RvL11bbmFtZV1bLnJlc3QuZXh0XSAtPiB7CiAgICAgIC8vICAgbmFtZTogbmFtZSwKICAgICAgLy8gICBmaWxlbmFtZTogcGF0aCArIG5hbWUgKyByZXN0CiAgICAgIC8vIH0KCiAgICAgIHZhciBtID0gU3RyaW5nKGNvbmZpZy5hdXRvbG9hZCkubWF0Y2goL14oKD86W15cL10qXC8pKikoW2EteiRfXVthLXowLTkkX10qKSgoPzpcLlthLXokX11bYS16MC05JF9dKikqKSQvaSk7CiAgICAgIGlmIChtKQogICAgICB7CiAgICAgICAgbW9kdWxlc1ttWzJdXSA9IHsKICAgICAgICAgIGF1dG9sb2FkOiB0cnVlLAogICAgICAgICAgZmlsZW5hbWU6IG1bMV0gKyBtWzJdICsgKG1bM10gfHwgJy5qcycpCiAgICAgICAgfTsKICAgICAgfQogICAgICBlbHNlCiAgICAgIHsKICAgICAgICAvKiogQGN1dCAqLyBjb25zb2xlTWV0aG9kcy53YXJuKCdiYXNpcy1jb25maWc6IHdyb25nIGBhdXRvbG9hZGAgdmFsdWUgKHNldHRpbmcgaWdub3JlZCk6ICcgKyBjb25maWcuYXV0b2xvYWQpOwogICAgICB9CgogICAgICBkZWxldGUgY29uZmlnLmF1dG9sb2FkOwogICAgfQoKICAgIC8vIHByb2Nlc3MgbW9kdWxlcwogICAgZm9yICh2YXIgbmFtZSBpbiBtb2R1bGVzKQogICAgewogICAgICAvLyBuYW1lOiB7CiAgICAgIC8vICAgYXV0b2xvYWQ6IGJvb2xlYW4sCiAgICAgIC8vICAgcGF0aDogJ3BhdGgvdG8nLAogICAgICAvLyAgIGZpbGVuYW1lOiAnbW9kdWxlLmpzJwogICAgICAvLyB9CiAgICAgIC8vCiAgICAgIC8vIG9yCiAgICAgIC8vCiAgICAgIC8vIG5hbWU6ICdmaWxlbmFtZScKCiAgICAgIHZhciBtb2R1bGUgPSBtb2R1bGVzW25hbWVdOwoKICAgICAgLy8gaWYgdmFsdWUgaXMgc3RyaW5nLCBjb252ZXJ0IHRvIGNvbmZpZwogICAgICBpZiAodHlwZW9mIG1vZHVsZSA9PSAnc3RyaW5nJykKICAgICAgICAvLyB2YWx1ZSBpcyBmaWxlbmFtZQogICAgICAgIG1vZHVsZSA9IHsKICAgICAgICAgIC8vIGlmIHBhdGggZW5kcyB3aXRoIGAvYCBhZGQgYFtuYW1lXS5qc2AgdG8gdGhlIGVuZAogICAgICAgICAgZmlsZW5hbWU6IG1vZHVsZS5yZXBsYWNlKC9cLyQvLCAnLycgKyBuYW1lICsgJy5qcycpCiAgICAgICAgfTsKCiAgICAgIC8vIGdldCBhbmQgcmVzb2x2ZSBwYXRoIGFuZCBmaWxlbmFtZQogICAgICB2YXIgZmlsZW5hbWUgPSBtb2R1bGUuZmlsZW5hbWU7CiAgICAgIHZhciBwYXRoID0gbW9kdWxlLnBhdGg7CgogICAgICAvLyBpZiBubyBwYXRoIGJ1dCBmaWxlbmFtZQogICAgICAvLyBsZXQgZmlsZW5hbWUgZXF1YWxzIHRvICdwYXRoL3RvL2ZpbGVbLmV4dF0nLCB0aGVuCiAgICAgIC8vICAgcGF0aCA9ICdwYXRoL3RvL2ZpbGUnCiAgICAgIC8vICAgZmlsZW5hbWUgPSAnLi4vZmlsZVsuZXh0XScKICAgICAgaWYgKGZpbGVuYW1lICYmICFwYXRoKQogICAgICB7CiAgICAgICAgZmlsZW5hbWUgPSBwYXRoVXRpbHMucmVzb2x2ZShmaWxlbmFtZSk7CiAgICAgICAgcGF0aCA9IGZpbGVuYW1lLnN1YnN0cigwLCBmaWxlbmFtZS5sZW5ndGggLSBwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkubGVuZ3RoKTsKICAgICAgICBmaWxlbmFtZSA9ICcuLi8nICsgcGF0aFV0aWxzLmJhc2VuYW1lKGZpbGVuYW1lKTsKICAgICAgfQoKICAgICAgLy8gcGF0aCBzaG91bGQgYmUgYWJzb2x1dGUKICAgICAgLy8gYXQgdGhpcyBwb2ludCBwYXRoIGlzIGRlZmluZWQgaW4gYW55IGNhc2UKICAgICAgcGF0aCA9IHBhdGhVdGlscy5yZXNvbHZlKHBhdGgpOwoKICAgICAgLy8gaWYgbm8gZmlsZW5hbWUgYnV0IHBhdGgKICAgICAgLy8gbGV0IHBhdGggZXF1YWxzIHRvICdwYXRoL3RvL2ZpbGVbLmV4dF0nLCB0aGVuCiAgICAgIC8vICAgcGF0aCA9ICdwYXRoL3RvJwogICAgICAvLyAgIGZpbGVuYW1lID0gJ2ZpbGVbLmV4dF0nCiAgICAgIGlmICghZmlsZW5hbWUgJiYgcGF0aCkKICAgICAgewogICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLmJhc2VuYW1lKHBhdGgpOwogICAgICAgIHBhdGggPSBwYXRoVXRpbHMuZGlybmFtZShwYXRoKTsKICAgICAgfQoKICAgICAgLy8gaWYgZmlsZW5hbWUgaGFzIG5vIGV4dGVuc2lvbiwgYWRkcyBgLmpzYAogICAgICBpZiAoIXBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSkKICAgICAgICBmaWxlbmFtZSArPSAnLmpzJzsKCiAgICAgIC8vIHJlc29sdmUgZmlsZW5hbWUKICAgICAgZmlsZW5hbWUgPSBwYXRoVXRpbHMucmVzb2x2ZShwYXRoLCBmaWxlbmFtZSk7CgogICAgICAvLyBzdG9yZSByZXN1bHRzCiAgICAgIGNvbmZpZy5tb2R1bGVzW25hbWVdID0gewogICAgICAgIHBhdGg6IHBhdGgsCiAgICAgICAgZmlsZW5hbWU6IGZpbGVuYW1lCiAgICAgIH07CgogICAgICAvLyBzdG9yZSBhdXRvbG9hZCBtb2R1bGVzCiAgICAgIGlmIChtb2R1bGUuYXV0b2xvYWQpCiAgICAgIHsKICAgICAgICBjb25maWcuYXV0b2xvYWQgPSBhdXRvbG9hZDsKICAgICAgICBhdXRvbG9hZC5wdXNoKG5hbWUpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGNvbmZpZzsKICB9CgoKICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogIC8vIE9PUCBzZWN0aW9uOiBDbGFzcyBpbXBsZW1lbnRhdGlvbgogIC8vCgogIHZhciBDbGFzcyA9IChmdW5jdGlvbigpewoKICAgLyoqCiAgICAqIFRoaXMgbmFtZXNwYWNlIGludHJvZHVjZSBjbGFzcyBjcmVhdGlvbiBzY2hlbWUuIEl0IHJlY29tZW5kZWQgZm9yIG5ldwogICAgKiBjbGFzc2VzIGNyZWF0aW9uLCBidXQgdXNlIGFibGUgdG8gdXNlIGJ1aWxkaW4gc2hlbWUgZm9yIHlvdXIgcHVycG9zZXMuCiAgICAqCiAgICAqIEFsbCBCYXNpcyBjbGFzc2VzIGFuZCBjb21wb25lbnRzICh3aXRoIHNvbWUgZXhjZXB0aW9ucykgYXJlCiAgICAqIGJ1aWxkaW5nIHVzaW5nIHRoaXMgc2hlbWUuCiAgICAqCiAgICAqIEBleGFtcGxlCiAgICAqICAgdmFyIEZvbyA9IGJhc2lzLkNsYXNzKG51bGwsIHsgLy8geW91IGNhbiB1c2UgYmFzaXMuQ2xhc3MgaW5zdGVhZCBvZiBudWxsCiAgICAqICAgICBuYW1lOiAnZGVmYXVsdCB2YWx1ZScsCiAgICAqICAgICBpbml0OiBmdW5jdGlvbih0aXRsZSl7IC8vIHNwZWNpYWwgbWV0aG9kIC0gY29uc3RydWN0b3IKICAgICogICAgICAgdGhpcy50aXRsZSA9IHRpdGxlOwogICAgKiAgICAgfSwKICAgICogICAgIHNheTogZnVuY3Rpb24oKXsKICAgICogICAgICAgcmV0dXJuICdNeSBuYW1lIGlzICcgKyB0aGlzLnRpdGxlOwogICAgKiAgICAgfQogICAgKiAgIH0pOwogICAgKgogICAgKiAgIHZhciBCYXIgPSBiYXNpcy5DbGFzcyhGb28sIHsKICAgICogICAgIGFnZTogMCwKICAgICogICAgIGluaXQ6IGZ1bmN0aW9uKHRpdGxlLCBhZ2UpewogICAgKiAgICAgICBGb28ucHJvdG90eXBlLmluaXQuY2FsbCh0aGlzLCB0aXRsZSk7CiAgICAqICAgICAgIHRoaXMuYWdlID0gYWdlOwogICAgKiAgICAgfSwKICAgICogICAgIHNheTogZnVuY3Rpb24oKXsKICAgICogICAgICAgcmV0dXJuIEZvby5wcm90b3R5cGUuc2F5LmNhbGwodGhpcykgKyAnIElcJ20gJyArIHRoaXMuYWdlICsgJyB5ZWFyIG9sZC4nOwogICAgKiAgICAgfQogICAgKiAgIH0pOwogICAgKgogICAgKiAgIHZhciBmb28gPSBuZXcgRm9vKCdKb2huJyk7CiAgICAqICAgdmFyIGJhciA9IG5ldyBCYXIoJ0l2YW4nLCAyNSk7CiAgICAqICAgY29uc29sZS5sb2coZm9vLnNheSgpKTsgLy8gTXkgbmFtZSBpcyBKb2huLgogICAgKiAgIGNvbnNvbGUubG9nKGJhci5zYXkoKSk7IC8vIE15IG5hbWUgaXMgSXZhbi4gSSdtIDI1IHllYXIgb2xkLgogICAgKiAgIGNvbnNvbGUubG9nKGJhciBpbnN0YW5jZW9mIGJhc2lzLkNsYXNzKTsgLy8gdHJ1ZQogICAgKiAgIGNvbnNvbGUubG9nKGJhciBpbnN0YW5jZW9mIEZvbyk7IC8vIHRydWUKICAgICogICBjb25zb2xlLmxvZyhiYXIgaW5zdGFuY2VvZiBCYXIpOyAvLyB0cnVlCiAgICAqCiAgICAqIEBuYW1lc3BhY2UgYmFzaXMuQ2xhc3MKICAgICovCgogICAvKioKICAgICogR2xvYmFsIGluc3RhbmNlcyBzZWVkLgogICAgKi8KICAgIHZhciBpbnN0YW5jZVNlZWQgPSB7IGlkOiAxIH07CiAgICB2YXIgY2xhc3NTZWVkID0gMTsKICAgIC8qKiBAY3V0ICovIHZhciBjbGFzc2VzID0gW107CgogICAvKioKICAgICogQ2xhc3MgY29uc3RydWN0IGhlbHBlcjogc2VsZiByZWZlcmVuY2UgdmFsdWUKICAgICovCiAgICB2YXIgU0VMRiA9IHt9OwoKICAgLyoqCiAgICAqIFRlc3Qgb2JqZWN0IGlzIGl0IGEgY2xhc3MuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QKICAgICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIG9iamVjdCBpcyBjbGFzcy4KICAgICovCiAgICBmdW5jdGlvbiBpc0NsYXNzKG9iamVjdCl7CiAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09ICdmdW5jdGlvbicgJiYgISFvYmplY3QuYmFzaXNDbGFzc0lkXzsKICAgIH0KCiAgIC8qKgogICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IHN1cGVyQ2xhc3MKICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICBmdW5jdGlvbiBpc1N1YmNsYXNzT2Yoc3VwZXJDbGFzcyl7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwoKICAgICAgd2hpbGUgKGN1cnNvciAmJiBjdXJzb3IgIT09IHN1cGVyQ2xhc3MpCiAgICAgICAgY3Vyc29yID0gY3Vyc29yLnN1cGVyQ2xhc3NfOwoKICAgICAgcmV0dXJuIGN1cnNvciA9PT0gc3VwZXJDbGFzczsKICAgIH0KCiAgIC8qKgogICAgKiBkZXYgbW9kZSBvbmx5CiAgICAqLwogICAgZnVuY3Rpb24gZGV2VmVyYm9zZU5hbWUobmFtZSwgYXJncywgZm4pewogICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKGtleXMoYXJncyksICdyZXR1cm4geyInICsgbmFtZSArICciOiAnICsgZm4gKyAnXG59WyInICsgbmFtZSArICciXScpLmFwcGx5KG51bGwsIHZhbHVlcyhhcmdzKSk7CiAgICB9CgoKICAgIC8vIHRlc3QgaXMgdG9TdHJpbmcgcHJvcGVydHkgZW51bWVyYWJsZQogICAgdmFyIFRPU1RSSU5HX0JVRyA9IChmdW5jdGlvbigpewogICAgICBmb3IgKHZhciBrZXkgaW4geyB0b1N0cmluZzogMSB9KQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9KSgpOwoKCiAgIC8qKgogICAgKiBDbGFzcyBjb25zdHJ1Y3Rvci4KICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBTdXBlckNsYXNzIENsYXNzIHRoYXQgbmV3IG9uZSBpbmhlcml0cyBvZi4KICAgICogQHBhcmFtIHsuLi5vYmplY3R9IGV4dGVuc2lvbnMgT2JqZWN0cyB0aGF0IGV4dGVuZHMgbmV3IGNsYXNzIHByb3RvdHlwZS4KICAgICogQHJldHVybiB7ZnVuY3Rpb24oKX0gQSBuZXcgY2xhc3MuCiAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlQ2xhc3MoU3VwZXJDbGFzcywgZXh0ZW5zaW9ucyl7CiAgICAgIHZhciBjbGFzc0lkID0gY2xhc3NTZWVkKys7CgogICAgICBpZiAodHlwZW9mIFN1cGVyQ2xhc3MgIT0gJ2Z1bmN0aW9uJykKICAgICAgICBTdXBlckNsYXNzID0gQmFzZUNsYXNzOwoKICAgICAgLyoqIEBjdXQgKi8gdmFyIGNsYXNzTmFtZSA9ICcnOwoKICAgICAgLyoqIEBjdXQgKi8gZm9yICh2YXIgaSA9IDEsIGV4dGVuc2lvbjsgZXh0ZW5zaW9uID0gYXJndW1lbnRzW2ldOyBpKyspCiAgICAgIC8qKiBAY3V0ICovICAgaWYgKHR5cGVvZiBleHRlbnNpb24gIT0gJ2Z1bmN0aW9uJyAmJiBleHRlbnNpb24uY2xhc3NOYW1lKQogICAgICAvKiogQGN1dCAqLyAgICAgY2xhc3NOYW1lID0gZXh0ZW5zaW9uLmNsYXNzTmFtZTsKCiAgICAgIC8qKiBAY3V0ICovIGlmICghY2xhc3NOYW1lKQogICAgICAvKiogQGN1dCAqLyAgIGNsYXNzTmFtZSA9IFN1cGVyQ2xhc3MuY2xhc3NOYW1lICsgJy5fQ2xhc3MnICsgY2xhc3NJZDsKICAgICAgLyoqIEBjdXQgKi8gLy8gY29uc29sZU1ldGhvZHMud2FybignQ2xhc3MgaGFzIG5vIG5hbWUnKTsKCiAgICAgIC8vIHRlbXAgY2xhc3MgY29uc3RydWN0b3Igd2l0aCBubyBpbml0IGNhbGwKICAgICAgdmFyIE5ld0NsYXNzUHJvdG8gPSBmdW5jdGlvbigpe307CgogICAgICAvLyB2ZXJib3NlIG5hbWUgaW4gZGV2CiAgICAgIC8qKiBAY3V0ICovIE5ld0NsYXNzUHJvdG8gPSBkZXZWZXJib3NlTmFtZShjbGFzc05hbWUsIHt9LCBOZXdDbGFzc1Byb3RvKTsKCiAgICAgIE5ld0NsYXNzUHJvdG8ucHJvdG90eXBlID0gU3VwZXJDbGFzcy5wcm90b3R5cGU7CgogICAgICB2YXIgbmV3UHJvdG8gPSBuZXcgTmV3Q2xhc3NQcm90bzsKICAgICAgdmFyIG5ld0NsYXNzUHJvcHMgPSB7CiAgICAgICAgLyoqIEBjdXQgKi8gY2xhc3NOYW1lOiBjbGFzc05hbWUsCgogICAgICAgIGJhc2lzQ2xhc3NJZF86IGNsYXNzSWQsCiAgICAgICAgc3VwZXJDbGFzc186IFN1cGVyQ2xhc3MsCiAgICAgICAgZXh0ZW5kQ29uc3RydWN0b3JfOiAhIVN1cGVyQ2xhc3MuZXh0ZW5kQ29uc3RydWN0b3JfLAoKICAgICAgICAvLyBjbGFzcyBtZXRob2RzCiAgICAgICAgaXNTdWJjbGFzc09mOiBpc1N1YmNsYXNzT2YsCiAgICAgICAgc3ViY2xhc3M6IGZ1bmN0aW9uKCl7CiAgICAgICAgICByZXR1cm4gY3JlYXRlQ2xhc3MuYXBwbHkobnVsbCwgW25ld0NsYXNzXS5jb25jYXQoYXJyYXlGcm9tKGFyZ3VtZW50cykpKTsKICAgICAgICB9LAogICAgICAgIGV4dGVuZDogZXh0ZW5kQ2xhc3MsCgogICAgICAgIC8vIGF1dG8gZXh0ZW5kIGNyZWF0ZXMgYSBzdWJjbGFzcwogICAgICAgIF9fZXh0ZW5kX186IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZSAhPT0gU0VMRiAmJiAodHlwZW9mIHZhbHVlID09ICdvYmplY3QnIHx8ICh0eXBlb2YgdmFsdWUgPT0gJ2Z1bmN0aW9uJyAmJiAhaXNDbGFzcyh2YWx1ZSkpKSkKICAgICAgICAgICAgcmV0dXJuIEJhc2VDbGFzcy5jcmVhdGUuY2FsbChudWxsLCBuZXdDbGFzcywgdmFsdWUpOwogICAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfSwKCiAgICAgICAgLy8gbmV3IGNsYXNzIHByb3RvdHlwZQogICAgICAgIHByb3RvdHlwZTogbmV3UHJvdG8KICAgICAgfTsKCiAgICAgIC8vIGV4dGVuZCBuZXdDbGFzcyBwcm90b3R5cGUKICAgICAgZm9yICh2YXIgaSA9IDEsIGV4dGVuc2lvbjsgZXh0ZW5zaW9uID0gYXJndW1lbnRzW2ldOyBpKyspCiAgICAgICAgbmV3Q2xhc3NQcm9wcy5leHRlbmQoZXh0ZW5zaW9uKTsKCiAgICAgIC8qKiBAY3V0ICovaWYgKG5ld1Byb3RvLmluaXQgIT09IEJhc2VDbGFzcy5wcm90b3R5cGUuaW5pdCAmJiAhL15mdW5jdGlvblteKF0qXChcKS8udGVzdChuZXdQcm90by5pbml0KSAmJiBuZXdDbGFzc1Byb3BzLmV4dGVuZENvbnN0cnVjdG9yXykgY29uc29sZU1ldGhvZHMud2FybigncHJvYmFibHkgd3JvbmcgZXh0ZW5kQ29uc3RydWN0b3JfIHZhbHVlIGZvciAnICsgbmV3Q2xhc3NQcm9wcy5jbGFzc05hbWUpOwoKICAgICAgLy8gbmV3IGNsYXNzIGNvbnN0cnVjdG9yCiAgICAgIHZhciBuZXdDbGFzcyA9IG5ld0NsYXNzUHJvcHMuZXh0ZW5kQ29uc3RydWN0b3JfCiAgICAgICAgLy8gY29uc3RydWN0b3Igd2l0aCBpbnN0YW5jZSBleHRlbnNpb24KICAgICAgICA/IGZ1bmN0aW9uKGV4dGVuZCl7CiAgICAgICAgICAgIC8vIG1hcmsgb2JqZWN0CiAgICAgICAgICAgIHRoaXMuYmFzaXNPYmplY3RJZCA9IGluc3RhbmNlU2VlZC5pZCsrOwoKICAgICAgICAgICAgLy8gZXh0ZW5kIGFuZCBvdmVycmlkZSBpbnN0YW5jZSBwcm9wZXJ0aWVzCiAgICAgICAgICAgIHZhciBwcm9wOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXh0ZW5kKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcHJvcCA9IHRoaXNba2V5XTsKICAgICAgICAgICAgICB0aGlzW2tleV0gPSBwcm9wICYmIHByb3AuX19leHRlbmRfXwogICAgICAgICAgICAgICAgPyBwcm9wLl9fZXh0ZW5kX18oZXh0ZW5kW2tleV0pCiAgICAgICAgICAgICAgICA6IGV4dGVuZFtrZXldOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBjYWxsIGNvbnN0cnVjdG9yCiAgICAgICAgICAgIHRoaXMuaW5pdCgpOwoKICAgICAgICAgICAgLy8gcG9zdCBpbml0CiAgICAgICAgICAgIHRoaXMucG9zdEluaXQoKTsKICAgICAgICAgIH0KCiAgICAgICAgLy8gc2ltcGxlIGNvbnN0cnVjdG9yCiAgICAgICAgOiBmdW5jdGlvbigpewogICAgICAgICAgICAvLyBtYXJrIG9iamVjdAogICAgICAgICAgICB0aGlzLmJhc2lzT2JqZWN0SWQgPSBpbnN0YW5jZVNlZWQuaWQrKzsKCiAgICAgICAgICAgIC8vIGNhbGwgY29uc3RydWN0b3IKICAgICAgICAgICAgdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgICAgICAvLyBwb3N0IGluaXQKICAgICAgICAgICAgdGhpcy5wb3N0SW5pdCgpOwogICAgICAgICAgfTsKCiAgICAgIC8vIHZlcmJvc2UgbmFtZSBpbiBkZXYKICAgICAgLy8gTk9URTogdGhpcyBjb2RlIG1ha2VzIENocm9tZSBhbmQgRmlyZWZveCBzaG93IGNsYXNzIG5hbWUgaW4gY29uc29sZQogICAgICAvKiogQGN1dCAqLyBuZXdDbGFzcyA9IGRldlZlcmJvc2VOYW1lKGNsYXNzTmFtZSwgeyBpbnN0YW5jZVNlZWQ6IGluc3RhbmNlU2VlZCB9LCBuZXdDbGFzcyk7CgogICAgICAvLyBhZGQgY29uc3RydWN0b3IgcHJvcGVydHkgdG8gcHJvdG90eXBlCiAgICAgIG5ld1Byb3RvLmNvbnN0cnVjdG9yID0gbmV3Q2xhc3M7CgogICAgICBmb3IgKHZhciBrZXkgaW4gbmV3UHJvdG8pCiAgICAgICAgaWYgKG5ld1Byb3RvW2tleV0gPT09IFNFTEYpCiAgICAgICAgICBuZXdQcm90b1trZXldID0gbmV3Q2xhc3M7CiAgICAgICAgLy9lbHNlCiAgICAgICAgLy8gIG5ld1Byb3RvW2tleV0gPSBuZXdQcm90b1trZXldOwoKICAgICAgLy8gZXh0ZW5kIGNvbnN0cnVjdG9yIHdpdGggcHJvcGVydGllcwogICAgICBleHRlbmQobmV3Q2xhc3MsIG5ld0NsYXNzUHJvcHMpOwoKICAgICAgLy8gZm9yIGNsYXNzIGludHJvc3BlY3Rpb24KICAgICAgLyoqIEBjdXQgKi8gY2xhc3Nlcy5wdXNoKG5ld0NsYXNzKTsKCiAgICAgIC8vIHJldHVybiBuZXcgY2xhc3MKICAgICAgcmV0dXJuIG5ld0NsYXNzOwogICAgfQoKICAgLyoqCiAgICAqIEV4dGVuZCBjbGFzcyBwcm90b3R5cGUKICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBJZiBzb3VyY2UgaGFzIGEgcHJvdG90eXBlLCBpdCB3aWxsIGJlIHVzZWQgdG8gZXh0ZW5kIGN1cnJlbnQgcHJvdG90eXBlLgogICAgKiBAcmV0dXJuIHtmdW5jdGlvbigpfSBSZXR1cm5zIGB0aGlzYC4KICAgICovCiAgICBmdW5jdGlvbiBleHRlbmRDbGFzcyhzb3VyY2UpewogICAgICB2YXIgcHJvdG8gPSB0aGlzLnByb3RvdHlwZTsKCiAgICAgIGlmICh0eXBlb2Ygc291cmNlID09ICdmdW5jdGlvbicgJiYgIWlzQ2xhc3Moc291cmNlKSkKICAgICAgICBzb3VyY2UgPSBzb3VyY2UodGhpcy5zdXBlckNsYXNzXy5wcm90b3R5cGUsIHNsaWNlKHByb3RvKSk7CgogICAgICBpZiAoc291cmNlLnByb3RvdHlwZSkKICAgICAgICBzb3VyY2UgPSBzb3VyY2UucHJvdG90eXBlOwoKICAgICAgZm9yICh2YXIga2V5IGluIHNvdXJjZSkKICAgICAgewogICAgICAgIHZhciB2YWx1ZSA9IHNvdXJjZVtrZXldOwogICAgICAgIHZhciBwcm90b1ZhbHVlID0gcHJvdG9ba2V5XTsKCiAgICAgICAgaWYgKGtleSA9PSAnY2xhc3NOYW1lJyB8fCBrZXkgPT0gJ2V4dGVuZENvbnN0cnVjdG9yXycpCiAgICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZTsKICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgaWYgKHByb3RvVmFsdWUgJiYgcHJvdG9WYWx1ZS5fX2V4dGVuZF9fKQogICAgICAgICAgICBwcm90b1trZXldID0gcHJvdG9WYWx1ZS5fX2V4dGVuZF9fKHZhbHVlKTsKICAgICAgICAgIGVsc2UKICAgICAgICAgIHsKICAgICAgICAgICAgcHJvdG9ba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAvLy8qKiBAY3V0ICovIGlmICh2YWx1ZSAmJiAhdmFsdWUuX19leHRlbmRfXyAmJiAodmFsdWUuY29uc3RydWN0b3IgPT0gT2JqZWN0IHx8IHZhbHVlLmNvbnN0cnVjdG9yID09IEFycmF5KSl7IGNvbnNvbGVNZXRob2RzLndhcm4oJyEnICsga2V5KTsgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gZm9yIGJyb3dzZXJzIHRoYXQgZG9lc24ndCBlbnVtIHRvU3RyaW5nCiAgICAgIGlmIChUT1NUUklOR19CVUcgJiYgc291cmNlW2tleSA9ICd0b1N0cmluZyddICE9PSB0b1N0cmluZykKICAgICAgICBwcm90b1trZXldID0gc291cmNlW2tleV07CgogICAgICByZXR1cm4gdGhpczsKICAgIH0KCgogICAgLy8KICAgIC8vIGJhc2UgY2xhc3MKICAgIC8vCiAgICB2YXIgQmFzZUNsYXNzID0gZXh0ZW5kKGNyZWF0ZUNsYXNzLCB7CiAgICAgIGNsYXNzTmFtZTogJ2Jhc2lzLkNsYXNzJywKCiAgICAgIC8vIG5vbi1hdXRvIGV4dGVuZCBieSBkZWZhdWx0CiAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogZmFsc2UsCgogICAgICAvLyBwcm90b3R5cGUgZGVmYXVsdHMKICAgICAgcHJvdG90eXBlOiB7CiAgICAgICAgYmFzaXNPYmplY3RJZDogMCwKCiAgICAgICAgY29uc3RydWN0b3I6IG51bGwsCgogICAgICAgIGluaXQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgfSwKICAgICAgICBwb3N0SW5pdDogZnVuY3Rpb24oKXsKICAgICAgICB9LAoKICAgICAgICAvKiogQGN1dCAqLyB0b1N0cmluZzogZnVuY3Rpb24oKXsgLy8gdmVyYm9zZSBpbiBkZXYKICAgICAgICAvKiogQGN1dCAqLyAgIHJldHVybiAnW29iamVjdCAnICsgKHRoaXMuY29uc3RydWN0b3IgfHwgdGhpcykuY2xhc3NOYW1lICsgJ10nOwogICAgICAgIC8qKiBAY3V0ICovIH0sCgogICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCl7CiAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIHRoaXMpCiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMsIHByb3ApKQogICAgICAgICAgICAgIHRoaXNbcHJvcF0gPSBudWxsOwoKICAgICAgICAgIHRoaXMuZGVzdHJveSA9ICR1bmRlZjsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwoKCiAgIC8qKgogICAgKiBAcGFyYW0ge29iamVjdH0gZXh0ZW5zaW9uCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKT19IGZuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBkZXZOYW1lIERldiBvbmx5CiAgICAqIEByZXR1cm4ge29iamVjdH0KICAgICovCiAgICB2YXIgY3VzdG9tRXh0ZW5kUHJvcGVydHkgPSBmdW5jdGlvbihleHRlbnNpb24sIGZuLCBkZXZOYW1lKXsKICAgICAgcmV0dXJuIHsKICAgICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbihleHRlbnNpb24pewogICAgICAgICAgaWYgKCFleHRlbnNpb24pCiAgICAgICAgICAgIHJldHVybiBleHRlbnNpb247CgogICAgICAgICAgaWYgKGV4dGVuc2lvbiAmJiBleHRlbnNpb24uX19leHRlbmRfXykKICAgICAgICAgICAgcmV0dXJuIGV4dGVuc2lvbjsKCiAgICAgICAgICB2YXIgQmFzZSA9IGZ1bmN0aW9uKCl7fTsKICAgICAgICAgIC8qKiBAY3V0IHZlcmJvc2UgbmFtZSBpbiBkZXYgKi8gQmFzZSA9IGRldlZlcmJvc2VOYW1lKGRldk5hbWUgfHwgJ2N1c3RvbUV4dGVuZFByb3BlcnR5Jywge30sIEJhc2UpOwogICAgICAgICAgQmFzZS5wcm90b3R5cGUgPSB0aGlzOwoKICAgICAgICAgIHZhciByZXN1bHQgPSBuZXcgQmFzZTsKCiAgICAgICAgICBmbihyZXN1bHQsIGV4dGVuc2lvbik7CgogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgIH0uX19leHRlbmRfXyhleHRlbnNpb24gfHwge30pOwogICAgfTsKCgogICAvKioKICAgICogQHBhcmFtIHtvYmplY3R9IGV4dGVuc2lvbgogICAgKiBAcmV0dXJuIHtvYmplY3R9CiAgICAqLwogICAgdmFyIGV4dGVuc2libGVQcm9wZXJ0eSA9IGZ1bmN0aW9uKGV4dGVuc2lvbil7CiAgICAgIHJldHVybiBjdXN0b21FeHRlbmRQcm9wZXJ0eShleHRlbnNpb24sIGV4dGVuZCwgJ2V4dGVuc2libGVQcm9wZXJ0eScpOwogICAgfTsKCgogICAvKioKICAgICogQHBhcmFtIHtvYmplY3R9IGV4dGVuc2lvbgogICAgKiBAcmV0dXJuIHtvYmplY3R9CiAgICAqLwogICAgdmFyIG5lc3RlZEV4dGVuZFByb3BlcnR5ID0gZnVuY3Rpb24oZXh0ZW5zaW9uKXsKICAgICAgcmV0dXJuIGN1c3RvbUV4dGVuZFByb3BlcnR5KGV4dGVuc2lvbiwgZnVuY3Rpb24ocmVzdWx0LCBleHRlbnNpb24pewogICAgICAgIGZvciAodmFyIGtleSBpbiBleHRlbnNpb24pCiAgICAgICAgewogICAgICAgICAgdmFyIHZhbHVlID0gcmVzdWx0W2tleV07CiAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlICYmIHZhbHVlLl9fZXh0ZW5kX18KICAgICAgICAgICAgPyB2YWx1ZS5fX2V4dGVuZF9fKGV4dGVuc2lvbltrZXldKQogICAgICAgICAgICA6IGV4dGVuc2libGVQcm9wZXJ0eShleHRlbnNpb25ba2V5XSk7CiAgICAgICAgfQogICAgICB9LCAnbmVzdGVkRXh0ZW5kUHJvcGVydHknKTsKICAgIH07CgogICAvKioKICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBmbgogICAgKiBAcGFyYW0ge29iamVjdD19IGtleXMKICAgICogQHJldHVybiB7b2JqZWN0fQogICAgKi8KICAgIHZhciBvbmVGdW5jdGlvblByb3BlcnR5ID0gZnVuY3Rpb24oZm4sIGtleXMpewogICAgICB2YXIgY3JlYXRlID0gZnVuY3Rpb24oa2V5cyl7CiAgICAgICAgdmFyIHJlc3VsdCA9IHsKICAgICAgICAgIF9fZXh0ZW5kX186IGNyZWF0ZQogICAgICAgIH07CgogICAgICAgIGlmIChrZXlzKQogICAgICAgIHsKICAgICAgICAgIGlmIChrZXlzLl9fZXh0ZW5kX18pCiAgICAgICAgICAgIHJldHVybiBrZXlzOwoKICAgICAgICAgIC8vIHZlcmJvc2UgbmFtZSBpbiBkZXYKICAgICAgICAgIC8qKiBAY3V0ICovIHZhciBDbHMgPSBkZXZWZXJib3NlTmFtZSgnb25lRnVuY3Rpb25Qcm9wZXJ0eScsIHt9LCBmdW5jdGlvbigpe30pOwogICAgICAgICAgLyoqIEBjdXQgKi8gcmVzdWx0ID0gbmV3IENsczsKICAgICAgICAgIC8qKiBAY3V0ICovIHJlc3VsdC5fX2V4dGVuZF9fID0gY3JlYXRlOwoKICAgICAgICAgIGZvciAodmFyIGtleSBpbiBrZXlzKQogICAgICAgICAgICBpZiAoa2V5c1trZXldKQogICAgICAgICAgICAgIHJlc3VsdFtrZXldID0gZm47CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwoKICAgICAgcmV0dXJuIGNyZWF0ZShrZXlzIHx8IHt9KTsKICAgIH07CgoKICAgIC8vCiAgICAvLyBleHBvcnQgbmFtZXMKICAgIC8vCgogICAgcmV0dXJuIGV4dGVuZChCYXNlQ2xhc3MsIHsKICAgICAgLyoqIEBjdXQgKi8gYWxsXzogY2xhc3NlcywKCiAgICAgIFNFTEY6IFNFTEYsCgogICAgICBjcmVhdGU6IGNyZWF0ZUNsYXNzLAogICAgICBpc0NsYXNzOiBpc0NsYXNzLAoKICAgICAgY3VzdG9tRXh0ZW5kUHJvcGVydHk6IGN1c3RvbUV4dGVuZFByb3BlcnR5LAogICAgICBleHRlbnNpYmxlUHJvcGVydHk6IGV4dGVuc2libGVQcm9wZXJ0eSwKICAgICAgbmVzdGVkRXh0ZW5kUHJvcGVydHk6IG5lc3RlZEV4dGVuZFByb3BlcnR5LAogICAgICBvbmVGdW5jdGlvblByb3BlcnR5OiBvbmVGdW5jdGlvblByb3BlcnR5CiAgICB9KTsKICB9KSgpOwoKCiAvKioKICAqIEBuYW1lc3BhY2UgYmFzaXMKICAqLwoKIC8qKgogICogQGNsYXNzCiAgKi8KICB2YXIgVG9rZW4gPSBDbGFzcyhudWxsLCB7CiAgICBjbGFzc05hbWU6ICdiYXNpcy5Ub2tlbicsCgogICAvKioKICAgICogQHR5cGUgeyp9CiAgICAqLwogICAgdmFsdWU6IG51bGwsCgogICAvKioKICAgICogQHR5cGUge29iamVjdH0KICAgICovCiAgICBoYW5kbGVyOiBudWxsLAoKICAgLyoqCiAgICAqIEB0eXBlIHtiYXNpcy5EZWZlcnJlZFRva2VufQogICAgKi8KICAgIGRlZmVycmVkVG9rZW46IG51bGwsCgogICAvKioKICAgICogQmluZGluZyBpbnRlcmZhY2UuCiAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAqLwogICAgYmluZGluZ0JyaWRnZTogewogICAgICBhdHRhY2g6IGZ1bmN0aW9uKGhvc3QsIGZuLCBjb250ZXh0KXsKICAgICAgICBob3N0LmF0dGFjaChmbiwgY29udGV4dCk7CiAgICAgIH0sCiAgICAgIGRldGFjaDogZnVuY3Rpb24oaG9zdCwgZm4sIGNvbnRleHQpewogICAgICAgIGhvc3QuZGV0YWNoKGZuLCBjb250ZXh0KTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbihob3N0KXsKICAgICAgICByZXR1cm4gaG9zdC5nZXQoKTsKICAgICAgfQogICAgfSwKCiAgIC8qKgogICAgKiBAY29uc3RydWN0b3IKICAgICovCiAgICBpbml0OiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgIH0sCgogICAvKioKICAgICogUmV0dXJucyB0b2tlbiB2YWx1ZS4KICAgICogQHJldHVybiB7Kn0gQ3VycmVudCB0b2tlbiB2YWx1ZS4KICAgICovCiAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLnZhbHVlOwogICAgfSwKCiAgIC8qKgogICAgKiBTZXQgbmV3IHZhbHVlIGZvciB0b2tlbi4gQ2FsbCBhcHBseSBtZXRob2QgaWYgdmFsdWUgaGFzIGJlZW4gY2hhbmdlZC4KICAgICogQHBhcmFtIHsqfSB2YWx1ZQogICAgKi8KICAgIHNldDogZnVuY3Rpb24odmFsdWUpewogICAgICBpZiAodGhpcy52YWx1ZSAhPT0gdmFsdWUpCiAgICAgIHsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgdGhpcy5hcHBseSgpOwogICAgICB9CiAgICB9LAoKICAgLyoqCiAgICAqIEFkZCBjYWxsYmFjayBvbiB0b2tlbiB2YWx1ZSBjaGFuZ2VzLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHZhbHVlKX0gZm4KICAgICogQHBhcmFtIHtvYmplY3Q9fSBjb250ZXh0CiAgICAqLwogICAgYXR0YWNoOiBmdW5jdGlvbihmbiwgY29udGV4dCl7CiAgICAgIC8qKiBAY3V0ICovIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICAvKiogQGN1dCAqLyB3aGlsZSAoY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpCiAgICAgIC8qKiBAY3V0ICovICAgaWYgKGN1cnNvci5mbiA9PT0gZm4gJiYgY3Vyc29yLmNvbnRleHQgPT09IGNvbnRleHQpCiAgICAgIC8qKiBAY3V0ICovICAgICBjb25zb2xlTWV0aG9kcy53YXJuKCdiYXNpcy5Ub2tlbiNhdHRhY2g6IGR1cGxpY2F0ZSBmbiAmIGNvbnRleHQgcGFpcicpOwoKICAgICAgdGhpcy5oYW5kbGVyID0gewogICAgICAgIGZuOiBmbiwKICAgICAgICBjb250ZXh0OiBjb250ZXh0LAogICAgICAgIGhhbmRsZXI6IHRoaXMuaGFuZGxlcgogICAgICB9OwogICAgfSwKCiAgIC8qKgogICAgKiBSZW1vdmUgY2FsbGJhY2suIE11c3QgYmUgcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBmb3Ige2Jhc2lzLlRva2VuI2F0dGFjaH0gbWV0aG9kLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9uKHZhbHVlKX0gZm4KICAgICogQHBhcmFtIHtvYmplY3Q9fSBjb250ZXh0CiAgICAqLwogICAgZGV0YWNoOiBmdW5jdGlvbihmbiwgY29udGV4dCl7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwogICAgICB2YXIgcHJldjsKCiAgICAgIHdoaWxlIChwcmV2ID0gY3Vyc29yLCBjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikKICAgICAgICBpZiAoY3Vyc29yLmZuID09PSBmbiAmJiBjdXJzb3IuY29udGV4dCA9PT0gY29udGV4dCkKICAgICAgICB7CiAgICAgICAgICAvLyBtYWtlIGl0IG5vbi1jYWxsYWJsZQogICAgICAgICAgY3Vyc29yLmZuID0gJHVuZGVmOwoKICAgICAgICAgIC8vIHJlbW92ZSBmcm9tIGxpc3QKICAgICAgICAgIHByZXYuaGFuZGxlciA9IGN1cnNvci5oYW5kbGVyOwoKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAvKiogQGN1dCAqLyBjb25zb2xlTWV0aG9kcy53YXJuKCdiYXNpcy5Ub2tlbiNkZXRhY2g6IGZuICYgY29udGV4dCBwYWlyIG5vdCBmb3VuZCwgbm90aGluZyB3YXMgcmVtb3ZlZCcpOwogICAgfSwKCiAgIC8qKgogICAgKiBDYWxsIGV2ZXJ5IGF0dGFjaGVkIGNhbGxiYWNrcyB3aXRoIGN1cnJlbnQgdG9rZW4gdmFsdWUuCiAgICAqLwogICAgYXBwbHk6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciB2YWx1ZSA9IHRoaXMuZ2V0KCk7CiAgICAgIHZhciBjdXJzb3IgPSB0aGlzOwoKICAgICAgd2hpbGUgKGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKQogICAgICAgIGN1cnNvci5mbi5jYWxsKGN1cnNvci5jb250ZXh0LCB2YWx1ZSk7CiAgICB9LAoKICAgLyoqCiAgICAqIFJldHVybnMgZGVmZXJyZWQgdG9rZW4gYmFzZWQgb24gdGhpcyB0b2tlbi4gRXZlcnkgdG9rZW4gY2FuIGhhcwogICAgKiBvbmx5IG9uZSBpdCdzIG93biBkZWZlcnJlZCB0b2tlbi4KICAgICogQHJldHVybiB7YmFzaXMuRGVmZXJyZWRUb2tlbn0KICAgICovCiAgICBkZWZlcnJlZDogZnVuY3Rpb24oKXsKICAgICAgdmFyIHRva2VuID0gdGhpcy5kZWZlcnJlZFRva2VuOwoKICAgICAgaWYgKCF0b2tlbikKICAgICAgewogICAgICAgIHRva2VuID0gdGhpcy5kZWZlcnJlZFRva2VuID0gbmV3IERlZmVycmVkVG9rZW4odGhpcy52YWx1ZSk7CiAgICAgICAgdGhpcy5hdHRhY2godG9rZW4uc2V0LCB0b2tlbik7CiAgICAgIH0KCiAgICAgIHJldHVybiB0b2tlbjsKICAgIH0sCgogICAvKioKICAgICogQWN0dWFsbHkgaXQncyBub3QgcmVxdWlyZSBpbnZva2UgZGVzdHJveSBtZXRob2QgZm9yIHRva2VuLCBnYXJiYWdlCiAgICAqIGNvbGxlY3RvciBoYXZlIG5vIHByb2JsZW1zIHRvIGZyZWUgdG9rZW4ncyBtZW1vcnkgd2hlbiBhbGwgcmVmZXJlbmNlcwogICAgKiB0byB0b2tlbiBhcmUgcmVtb3ZlZC4KICAgICogQGRlc3RydWN0b3IKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbigpewogICAgICBpZiAodGhpcy5kZWZlcnJlZFRva2VuKQogICAgICB7CiAgICAgICAgdGhpcy5kZWZlcnJlZFRva2VuLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLmRlZmVycmVkVG9rZW4gPSBudWxsOwogICAgICB9CgogICAgICB0aGlzLmhhbmRsZXIgPSBudWxsOwogICAgICB0aGlzLnZhbHVlID0gbnVsbDsKICAgICAgdGhpcy5hdHRhY2ggPSAkdW5kZWY7CiAgICAgIHRoaXMuZGV0YWNoID0gJHVuZGVmOwogICAgfQogIH0pOwoKICAvLwogIC8vIERlZmVycmVkIHRva2VuCiAgLy8KCiAgdmFyIGF3YWl0VG9BcHBseSA9IChmdW5jdGlvbigpewogICAgdmFyIHRva2VucyA9IHt9OwogICAgdmFyIHRpbWVyOwoKICAgIGZ1bmN0aW9uIGFwcGx5VG9rZW5zKCl7CiAgICAgIHZhciBsaXN0ID0gdG9rZW5zOwoKICAgICAgLy8gcmVzZXQgbGlzdCAmIHRpbWVyCiAgICAgIHRva2VucyA9IHt9OwogICAgICB0aW1lciA9IG51bGw7CgogICAgICAvLyBjYWxsIGFwcGx5IG1ldGhvZCBmb3IgYWxsIHRva2VucyBpbiB0aGUgbGlzdAogICAgICBmb3IgKHZhciBrZXkgaW4gbGlzdCkKICAgICAgICBsaXN0W2tleV0uYXBwbHkoKTsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24odG9rZW4pewogICAgICBpZiAodG9rZW4uYmFzaXNPYmplY3RJZCBpbiB0b2tlbnMpCiAgICAgICAgcmV0dXJuOwoKICAgICAgdG9rZW5zW3Rva2VuLmJhc2lzT2JqZWN0SWRdID0gdG9rZW47CgogICAgICBpZiAoIXRpbWVyKQogICAgICAgIHNldEltbWVkaWF0ZShhcHBseVRva2Vucyk7CiAgICB9OwogIH0pKCk7CgogLyoqCiAgKiBAY2xhc3MKICAqLwogIHZhciBEZWZlcnJlZFRva2VuID0gVG9rZW4uc3ViY2xhc3MoewogICAgY2xhc3NOYW1lOiAnYmFzaXMuRGVmZXJyZWRUb2tlbicsCgogICAvKioKICAgICogU2V0IG5ldyB2YWx1ZSBmb3IgdG9rZW4gYW5kIHNjaGVkdWxlIHRvIGNhbGwgYXBwbHkgbWV0aG9kLgogICAgKiBAcGFyYW0geyp9IHZhbHVlCiAgICAqLwogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSkKICAgICAgewogICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgICBhd2FpdFRvQXBwbHkodGhpcyk7CiAgICAgIH0KICAgIH0sCgogICAvKioKICAgICogVGhhdCBtZXRob2QgZm9yIERlZmVycmVkVG9rZW4gcmV0dXJucyB0b2tlbiBpdHNlbGYuCiAgICAqLwogICAgZGVmZXJyZWQ6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0pOwoKCiAgLy8KICAvLyBSZXNvdXJjZXMKICAvLwoKICB2YXIgcmVzb3VyY2VzID0ge307CiAgdmFyIHJlc291cmNlQ29udGVudENhY2hlID0ge307CiAgdmFyIHJlc291cmNlUGF0Y2ggPSB7fTsKICB2YXIgdmlydHVhbFJlc291cmNlU2VlZCA9IDE7CiAgLyoqIEBjdXQgKi8gdmFyIHJlc291cmNlUmVzb2x2aW5nU3RhY2sgPSBbXTsKICAvKiogQGN1dCAqLyB2YXIgcmVxdWlyZXM7CiAgLy8gdmFyIHJlc291cmNlVXBkYXRlTm90aWZpZXIgPSBleHRlbmQobmV3IFRva2VuKCksIHsKICAvLyAgIHNldDogZnVuY3Rpb24odmFsdWUpewogIC8vICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgLy8gICAgIHRoaXMuYXBwbHkoKTsKICAvLyAgIH0KICAvLyB9KTsKCiAgLy8gYXBwbHkgcHJlZmV0Y2hlZCByZXNvdXJjZXMgdG8gY2FjaGUKICAoZnVuY3Rpb24oKXsKICAgIHZhciBtYXAgPSB0eXBlb2YgX19yZXNvdXJjZXNfXyAhPSAndW5kZWZpbmVkJyA/IF9fcmVzb3VyY2VzX18gOiBudWxsOwogICAgaWYgKG1hcCkKICAgIHsKICAgICAgZm9yICh2YXIga2V5IGluIG1hcCkKICAgICAgICByZXNvdXJjZUNvbnRlbnRDYWNoZVtwYXRoVXRpbHMucmVzb2x2ZShrZXkpXSA9IG1hcFtrZXldOwoKICAgICAgLy9fX3Jlc291cmNlc19fID0gbnVsbDsgLy8gcmVzZXQgcHJlZmV0Y2hlZCB0byByZWR1Y2UgbWVtb3J5IGxlYWtzCiAgICB9CiAgfSkoKTsKCiAgZnVuY3Rpb24gYXBwbHlSZXNvdXJjZVBhdGNoZXMocmVzb3VyY2UpewogICAgdmFyIHBhdGNoZXMgPSByZXNvdXJjZVBhdGNoW3Jlc291cmNlLnVybF07CgogICAgaWYgKHBhdGNoZXMpCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGF0Y2hlcy5sZW5ndGg7IGkrKykKICAgICAgewogICAgICAgIC8qKiBAY3V0ICovIGNvbnNvbGVNZXRob2RzLmluZm8oJ0FwcGx5IHBhdGNoIGZvciAnICsgcmVzb3VyY2UudXJsKTsKICAgICAgICBwYXRjaGVzW2ldKHJlc291cmNlLmdldCgpLCByZXNvdXJjZS51cmwpOwogICAgICB9CiAgfQoKICB2YXIgZ2V0UmVzb3VyY2VDb250ZW50ID0gZnVuY3Rpb24odXJsLCBpZ25vcmVDYWNoZSl7CiAgICBpZiAoaWdub3JlQ2FjaGUgfHwgIXJlc291cmNlQ29udGVudENhY2hlLmhhc093blByb3BlcnR5KHVybCkpCiAgICB7CiAgICAgIHZhciByZXNvdXJjZUNvbnRlbnQgPSAnJzsKCiAgICAgIGlmICghTk9ERV9FTlYpCiAgICAgIHsKICAgICAgICB2YXIgcmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgcmVxLm9wZW4oJ0dFVCcsIHVybCwgZmFsc2UpOwogICAgICAgIC8vIHNldCBpZi1tb2RpZmllZC1zaW5jZSBoZWFkZXIgc2luY2UgYmVnaW5pbmcgcHJldmVudHMgY2FjaGUgdXNpbmc7CiAgICAgICAgLy8gb3RoZXJ3aXNlIGJyb3dzZXIgY291bGQgbmV2ZXIgYXNrIHNlcnZlciBmb3IgbmV3IGZpbGUgY29udGVudAogICAgICAgIC8vIGFuZCB1c2UgZmlsZSBjb250ZW50IGZyb20gY2FjaGUKICAgICAgICByZXEuc2V0UmVxdWVzdEhlYWRlcignSWYtTW9kaWZpZWQtU2luY2UnLCBuZXcgRGF0ZSgwKS50b0dNVFN0cmluZygpKTsKICAgICAgICByZXEuc2V0UmVxdWVzdEhlYWRlcignWC1CYXNpcy1SZXNvdXJjZScsIDEpOwogICAgICAgIHJlcS5zZW5kKCcnKTsKCiAgICAgICAgaWYgKHJlcS5zdGF0dXMgPj0gMjAwICYmIHJlcS5zdGF0dXMgPCA0MDApCiAgICAgICAgICByZXNvdXJjZUNvbnRlbnQgPSByZXEucmVzcG9uc2VUZXh0OwogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAvKiogQGN1dCAqLyBjb25zb2xlTWV0aG9kcy5lcnJvcignYmFzaXMucmVzb3VyY2U6IFVuYWJsZSB0byBsb2FkICcgKyB1cmwgKyAnIChzdGF0dXMgY29kZSAnICsgcmVxLnN0YXR1cyArICcpJyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UKICAgICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAvLyB0cnkgdG8gdXNlIHNwZWNpYWwgcmVhZCBmaWxlIGZ1bmN0aW9uLCBpdCBtYXkgYmUgcHJvdmlkZWQgYnkgcGFyZW50IG1vZHVsZQogICAgICAgICAgcmVzb3VyY2VDb250ZW50ID0gcHJvY2Vzcy5iYXNpc2pzUmVhZEZpbGUKICAgICAgICAgICAgPyBwcm9jZXNzLmJhc2lzanNSZWFkRmlsZSh1cmwpCiAgICAgICAgICAgIDogcmVxdWlyZSgnZnMnKS5yZWFkRmlsZVN5bmModXJsLCAndXRmLTgnKTsKICAgICAgICB9IGNhdGNoKGUpewogICAgICAgICAgLyoqIEBjdXQgKi8gY29uc29sZU1ldGhvZHMuZXJyb3IoJ2Jhc2lzLnJlc291cmNlOiBVbmFibGUgdG8gbG9hZCAnICsgdXJsLCBlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJlc291cmNlQ29udGVudENhY2hlW3VybF0gPSByZXNvdXJjZUNvbnRlbnQ7CiAgICB9CgogICAgcmV0dXJuIHJlc291cmNlQ29udGVudENhY2hlW3VybF07CiAgfTsKCiAgdmFyIGNyZWF0ZVJlc291cmNlID0gZnVuY3Rpb24ocmVzb3VyY2VVcmwsIGNvbnRlbnQpewogICAgdmFyIGNvbnRlbnRUeXBlID0gcGF0aFV0aWxzLmV4dG5hbWUocmVzb3VyY2VVcmwpOwogICAgdmFyIGNvbnRlbnRXcmFwcGVyID0gZ2V0UmVzb3VyY2UuZXh0ZW5zaW9uc1tjb250ZW50VHlwZV07CiAgICB2YXIgaXNWaXJ0dWFsID0gYXJndW1lbnRzLmxlbmd0aCA+IDE7CiAgICB2YXIgcmVzb2x2ZWQgPSBmYWxzZTsKICAgIHZhciB3cmFwcGVkID0gZmFsc2U7CiAgICAvKiogQGN1dCAqLyB2YXIgd3JhcHBlZENvbnRlbnQ7CgogICAgaWYgKGlzVmlydHVhbCkKICAgICAgcmVzb3VyY2VVcmwgKz0gJyN2aXJ0dWFsJzsKCiAgICB2YXIgcmVzb3VyY2UgPSBmdW5jdGlvbigpewogICAgICAvLyBpZiByZXNvdXJjZSByZXNvbHZlZCwganVzdCByZXR1cm4gY29udGVudAogICAgICBpZiAocmVzb2x2ZWQpCiAgICAgICAgcmV0dXJuIGNvbnRlbnQ7CgogICAgICAvLyBmZXRjaCB1cmwgY29udGVudAogICAgICB2YXIgdXJsQ29udGVudCA9IGlzVmlydHVhbCA/IGNvbnRlbnQgOiBnZXRSZXNvdXJjZUNvbnRlbnQocmVzb3VyY2VVcmwpOwoKICAgICAgLyoqIEBjdXQgICAgcmVjdXJzaW9uIHdhcm5pbmcgKi8KICAgICAgLyoqIEBjdXQgKi8gdmFyIGlkeCA9IHJlc291cmNlUmVzb2x2aW5nU3RhY2suaW5kZXhPZihyZXNvdXJjZVVybCk7CiAgICAgIC8qKiBAY3V0ICovIGlmIChpZHggIT0gLTEpCiAgICAgIC8qKiBAY3V0ICovICAgY29uc29sZU1ldGhvZHMud2FybignYmFzaXMucmVzb3VyY2UgcmVjdXJzaW9uOicsIHJlc291cmNlUmVzb2x2aW5nU3RhY2suc2xpY2UoaWR4KS5jb25jYXQocmVzb3VyY2VVcmwpLm1hcChwYXRoVXRpbHMucmVsYXRpdmUsIHBhdGhVdGlscykuam9pbignIC0+ICcpKTsKICAgICAgLyoqIEBjdXQgKi8gcmVzb3VyY2VSZXNvbHZpbmdTdGFjay5wdXNoKHJlc291cmNlVXJsKTsKCiAgICAgIC8vIGlmIHJlc291cmNlIHR5cGUgaGFzIHdyYXBwZXIgLSB3cmFwIGl0LCBvciB1c2UgdXJsIGNvbnRlbnQgYXMgcmVzdWx0CiAgICAgIGlmIChjb250ZW50V3JhcHBlcikKICAgICAgewogICAgICAgIGlmICghd3JhcHBlZCkKICAgICAgICB7CiAgICAgICAgICB3cmFwcGVkID0gdHJ1ZTsKICAgICAgICAgIGNvbnRlbnQgPSBjb250ZW50V3JhcHBlcih1cmxDb250ZW50LCByZXNvdXJjZVVybCk7CiAgICAgICAgICAvKiogQGN1dCAqLyB3cmFwcGVkQ29udGVudCA9IHVybENvbnRlbnQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UKICAgICAgewogICAgICAgIGNvbnRlbnQgPSB1cmxDb250ZW50OwogICAgICB9CgogICAgICAvLyBtYXJrIGFzIHJlc29sdmVkIGFuZCBhcHBseSBiaW5kZWQgZnVuY3Rpb25zCiAgICAgIHJlc29sdmVkID0gdHJ1ZTsKICAgICAgYXBwbHlSZXNvdXJjZVBhdGNoZXMocmVzb3VyY2UpOwogICAgICByZXNvdXJjZS5hcHBseSgpOwoKICAgICAgLy8gcmVzb3VyY2VVcGRhdGVOb3RpZmllci52YWx1ZSA9IHJlc291cmNlVXJsOwogICAgICAvLyByZXNvdXJjZVVwZGF0ZU5vdGlmaWVyLmFwcGx5KCk7CgogICAgICAvKiogQGN1dCAgICByZWN1cnNpb24gd2FybmluZyAqLwogICAgICAvKiogQGN1dCAqLyByZXNvdXJjZVJlc29sdmluZ1N0YWNrLnBvcCgpOwoKICAgICAgcmV0dXJuIGNvbnRlbnQ7CiAgICB9OwoKICAgIGV4dGVuZChyZXNvdXJjZSwgZXh0ZW5kKG5ldyBUb2tlbigpLCB7CiAgICAgIHVybDogcmVzb3VyY2VVcmwsCiAgICAgIHR5cGU6IGNvbnRlbnRUeXBlLAogICAgICB2aXJ0dWFsOiBpc1ZpcnR1YWwsCgogICAgICBmZXRjaDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gcmVzb3VyY2UoKTsKICAgICAgfSwKICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuICdbYmFzaXMucmVzb3VyY2UgJyArIHJlc291cmNlVXJsICsgJ10nOwogICAgICB9LAogICAgICBpc1Jlc29sdmVkOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiByZXNvbHZlZDsKICAgICAgfSwKICAgICAgLyoqIEBjdXQgKi8gaGFzQ2hhbmdlczogZnVuY3Rpb24oKXsKICAgICAgLyoqIEBjdXQgKi8gICByZXR1cm4gY29udGVudFdyYXBwZXIgPyByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF0gIT09IHdyYXBwZWRDb250ZW50IDogZmFsc2U7CiAgICAgIC8qKiBAY3V0ICovIH0sCiAgICAgIHVwZGF0ZTogZnVuY3Rpb24obmV3Q29udGVudCl7CiAgICAgICAgaWYgKCFyZXNvbHZlZCB8fCBpc1ZpcnR1YWwgfHwgbmV3Q29udGVudCAhPSByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF0pCiAgICAgICAgewogICAgICAgICAgaWYgKCFpc1ZpcnR1YWwpCiAgICAgICAgICAgIHJlc291cmNlQ29udGVudENhY2hlW3Jlc291cmNlVXJsXSA9IG5ld0NvbnRlbnQ7CgogICAgICAgICAgaWYgKGNvbnRlbnRXcmFwcGVyKQogICAgICAgICAgewogICAgICAgICAgICBpZiAoIXdyYXBwZWQgJiYgaXNWaXJ0dWFsKQogICAgICAgICAgICAgIGNvbnRlbnQgPSBuZXdDb250ZW50OwoKICAgICAgICAgICAgLy8gd3JhcCBjb250ZW50IG9ubHkgaWYgaXQgd3JhcHBlZCBhbHJlYWR5IGFuZCBub24tdXBkYXRhYmxlCiAgICAgICAgICAgIGlmICh3cmFwcGVkICYmICFjb250ZW50V3JhcHBlci5wZXJtYW5lbnQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb250ZW50ID0gY29udGVudFdyYXBwZXIobmV3Q29udGVudCwgcmVzb3VyY2VVcmwsIGNvbnRlbnQpOwogICAgICAgICAgICAgIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKTsKICAgICAgICAgICAgICByZXNvdXJjZS5hcHBseSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlCiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbnRlbnQgPSBuZXdDb250ZW50OwogICAgICAgICAgICByZXNvbHZlZCA9IHRydWU7CiAgICAgICAgICAgIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKTsKICAgICAgICAgICAgcmVzb3VyY2UuYXBwbHkoKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyByZXNvdXJjZVVwZGF0ZU5vdGlmaWVyLnZhbHVlID0gcmVzb3VyY2VVcmw7CiAgICAgICAgICAvLyByZXNvdXJjZVVwZGF0ZU5vdGlmaWVyLmFwcGx5KCk7CiAgICAgICAgfQogICAgICB9LAogICAgICByZWxvYWQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKGlzVmlydHVhbCkKICAgICAgICAgIHJldHVybjsKCiAgICAgICAgdmFyIG9sZENvbnRlbnQgPSByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF07CiAgICAgICAgdmFyIG5ld0NvbnRlbnQgPSBnZXRSZXNvdXJjZUNvbnRlbnQocmVzb3VyY2VVcmwsIHRydWUpOwoKICAgICAgICBpZiAobmV3Q29udGVudCAhPSBvbGRDb250ZW50KQogICAgICAgIHsKICAgICAgICAgIHJlc29sdmVkID0gZmFsc2U7CiAgICAgICAgICByZXNvdXJjZS51cGRhdGUobmV3Q29udGVudCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKHNvdXJjZSl7CiAgICAgICAgaWYgKGlzVmlydHVhbCkKICAgICAgICAgIGlmIChzb3VyY2UpCiAgICAgICAgICAgIHJldHVybiBjb250ZW50V3JhcHBlciA/IHdyYXBwZWRDb250ZW50IDogY29udGVudDsKCiAgICAgICAgcmV0dXJuIHNvdXJjZSA/IGdldFJlc291cmNlQ29udGVudChyZXNvdXJjZVVybCkgOiByZXNvdXJjZSgpOwogICAgICB9LAogICAgICByZWFkeTogZnVuY3Rpb24oZm4sIGNvbnRleHQpewogICAgICAgIGlmIChyZXNvbHZlZCkKICAgICAgICB7CiAgICAgICAgICBmbi5jYWxsKGNvbnRleHQsIHJlc291cmNlKCkpOwoKICAgICAgICAgIGlmIChjb250ZW50V3JhcHBlciAmJiBjb250ZW50V3JhcHBlci5wZXJtYW5lbnQpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHJlc291cmNlLmF0dGFjaChmbiwgY29udGV4dCk7CgogICAgICAgIHJldHVybiByZXNvdXJjZTsKICAgICAgfQogICAgfSkpOwoKICAgIC8vIGNhY2hlIGl0CiAgICByZXNvdXJjZXNbcmVzb3VyY2VVcmxdID0gcmVzb3VyY2U7CgogICAgcmV0dXJuIHJlc291cmNlOwogIH07CgogLyoqCiAgKiBAbmFtZSByZXNvdXJjZQogICovCiAgdmFyIGdldFJlc291cmNlID0gZnVuY3Rpb24ocmVzb3VyY2VVcmwpewogICAgdmFyIHJlc291cmNlID0gcmVzb3VyY2VzW3Jlc291cmNlVXJsXTsKCiAgICBpZiAocmVzb3VyY2UpCiAgICAgIHJldHVybiByZXNvdXJjZTsKCiAgICAvKiogQGN1dCAqLyBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QocmVzb3VyY2VVcmwpKQogICAgLyoqIEBjdXQgKi8gICBjb25zb2xlTWV0aG9kcy53YXJuKCdCYWQgdXNhZ2U6IGJhc2lzLnJlc291cmNlKFwnJyArIHJlc291cmNlVXJsICsgJ1wnKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuJyk7CgogICAgLy8gdHJ5IHJlc29sdmUgcmVzb3VyY2UgcGF0aAogICAgcmVzb3VyY2VVcmwgPSBwYXRoVXRpbHMucmVzb2x2ZShyZXNvdXJjZVVybCk7CiAgICByZXNvdXJjZSA9IHJlc291cmNlc1tyZXNvdXJjZVVybF07CgogICAgLy8gcmV0dXJuIHJlc291cmNlIG9yIGNyZWF0ZSBpdAogICAgcmV0dXJuIHJlc291cmNlIHx8IGNyZWF0ZVJlc291cmNlKHJlc291cmNlVXJsKTsKICB9OwoKICBleHRlbmQoZ2V0UmVzb3VyY2UsIHsKICAgIC8vIG9uVXBkYXRlOiBmdW5jdGlvbihmbiwgY29udGV4dCl7CiAgICAvLyAgIHJlc291cmNlVXBkYXRlTm90aWZpZXIuYXR0YWNoKGZuLCBjb250ZXh0KTsKICAgIC8vIH0sCiAgICBpc1Jlc291cmNlOiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHJldHVybiB2YWx1ZSA/IHJlc291cmNlc1t2YWx1ZS51cmxdID09PSB2YWx1ZSA6IGZhbHNlOwogICAgfSwKICAgIGlzUmVzb2x2ZWQ6IGZ1bmN0aW9uKHJlc291cmNlVXJsKXsKICAgICAgdmFyIHJlc291cmNlID0gZ2V0UmVzb3VyY2UuZ2V0KHJlc291cmNlVXJsKTsKCiAgICAgIHJldHVybiByZXNvdXJjZSA/IHJlc291cmNlLmlzUmVzb2x2ZWQoKSA6IGZhbHNlOwogICAgfSwKICAgIGV4aXN0czogZnVuY3Rpb24ocmVzb3VyY2VVcmwpewogICAgICAvKiogQGN1dCAqLyBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QocmVzb3VyY2VVcmwpKQogICAgICAvKiogQGN1dCAqLyAgIGNvbnNvbGVNZXRob2RzLndhcm4oJ0JhZCB1c2FnZTogYmFzaXMucmVzb3VyY2UuZXhpc3RzKFwnJyArIHJlc291cmNlVXJsICsgJ1wnKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuJyk7CgogICAgICByZXR1cm4gcmVzb3VyY2VzLmhhc093blByb3BlcnR5KHBhdGhVdGlscy5yZXNvbHZlKHJlc291cmNlVXJsKSk7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbihyZXNvdXJjZVVybCl7CiAgICAgIC8qKiBAY3V0ICovIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChyZXNvdXJjZVVybCkpCiAgICAgIC8qKiBAY3V0ICovICAgY29uc29sZU1ldGhvZHMud2FybignQmFkIHVzYWdlOiBiYXNpcy5yZXNvdXJjZS5nZXQoXCcnICsgcmVzb3VyY2VVcmwgKyAnXCcpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4nKTsKCiAgICAgIHJlc291cmNlVXJsID0gcGF0aFV0aWxzLnJlc29sdmUocmVzb3VyY2VVcmwpOwoKICAgICAgaWYgKCFnZXRSZXNvdXJjZS5leGlzdHMocmVzb3VyY2VVcmwpKQogICAgICAgIHJldHVybiBudWxsOwoKICAgICAgcmV0dXJuIGdldFJlc291cmNlKHJlc291cmNlVXJsKTsKICAgIH0sCiAgICBnZXRGaWxlczogZnVuY3Rpb24oY2FjaGUpewogICAgICByZXR1cm4ga2V5cyhjYWNoZSA/IHJlc291cmNlQ29udGVudENhY2hlIDogcmVzb3VyY2VzKS5tYXAocGF0aFV0aWxzLnJlbGF0aXZlKTsKICAgIH0sCgogICAgdmlydHVhbDogZnVuY3Rpb24odHlwZSwgY29udGVudCwgb3duZXJVcmwpewogICAgICByZXR1cm4gY3JlYXRlUmVzb3VyY2UoCiAgICAgICAgKG93bmVyVXJsID8gb3duZXJVcmwgKyAnOicgOiBwYXRoVXRpbHMubm9ybWFsaXplKHBhdGhVdGlscy5iYXNlVVJJID09ICcvJyA/ICcnIDogcGF0aFV0aWxzLmJhc2VVUkkpICsgJy8nKSArCiAgICAgICAgICAndmlydHVhbC1yZXNvdXJjZScgKyAodmlydHVhbFJlc291cmNlU2VlZCsrKSArICcuJyArIHR5cGUsCiAgICAgICAgY29udGVudAogICAgICApOwogICAgfSwKCiAgICBleHRlbnNpb25zOiB7CiAgICAgICcuanMnOiBleHRlbmQoZnVuY3Rpb24oY29udGVudCwgZmlsZW5hbWUpewogICAgICAgIHZhciBuYW1lc3BhY2UgPSBmaWxlbmFtZTJuYW1lc3BhY2VbZmlsZW5hbWVdOwoKICAgICAgICBpZiAoIW5hbWVzcGFjZSkKICAgICAgICB7CiAgICAgICAgICB2YXIgaW1wbGljaXROYW1lc3BhY2UgPSB0cnVlOwogICAgICAgICAgdmFyIHJlc29sdmVkRmlsZW5hbWUgPSAocGF0aFV0aWxzLmRpcm5hbWUoZmlsZW5hbWUpICsgJy8nICsgcGF0aFV0aWxzLmJhc2VuYW1lKGZpbGVuYW1lLCBwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkpKTsKCiAgICAgICAgICBmb3IgKHZhciBucyBpbiBuc1Jvb3RQYXRoKQogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGF0aCA9IG5zUm9vdFBhdGhbbnNdICsgbnMgKyAnLyc7CiAgICAgICAgICAgIGlmIChyZXNvbHZlZEZpbGVuYW1lLnN1YnN0cigwLCBwYXRoLmxlbmd0aCkgPT0gcGF0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgIGltcGxpY2l0TmFtZXNwYWNlID0gZmFsc2U7CiAgICAgICAgICAgICAgcmVzb2x2ZWRGaWxlbmFtZSA9IHJlc29sdmVkRmlsZW5hbWUuc3Vic3RyKG5zUm9vdFBhdGhbbnNdLmxlbmd0aCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBuYW1lc3BhY2UgPSByZXNvbHZlZEZpbGVuYW1lCiAgICAgICAgICAgIC5yZXBsYWNlKC9cLi9nLCAnXycpCiAgICAgICAgICAgIC5yZXBsYWNlKC9eXC8vZywgJycpCiAgICAgICAgICAgIC5yZXBsYWNlKC9cLy9nLCAnLicpOwoKICAgICAgICAgIGlmIChpbXBsaWNpdE5hbWVzcGFjZSkKICAgICAgICAgICAgbmFtZXNwYWNlID0gJ2ltcGxpY2l0LicgKyBuYW1lc3BhY2U7CiAgICAgICAgfQoKICAgICAgICAvKiogQGN1dCAqLyBpZiAocmVxdWlyZXMpCiAgICAgICAgLyoqIEBjdXQgKi8gICBhcnJheUZ1bmN0aW9ucy5hZGQocmVxdWlyZXMsIG5hbWVzcGFjZSk7CgogICAgICAgIGlmICghbmFtZXNwYWNlc1tuYW1lc3BhY2VdKQogICAgICAgIHsKICAgICAgICAgIHZhciBucyA9IGdldE5hbWVzcGFjZShuYW1lc3BhY2UpOwoKICAgICAgICAgIC8qKiBAY3V0ICovIHZhciBzYXZlZFJlcXVpcmVzID0gcmVxdWlyZXM7CiAgICAgICAgICAvKiogQGN1dCAqLyByZXF1aXJlcyA9IFtdOwoKICAgICAgICAgIG5zLmV4cG9ydHMgPSBydW5TY3JpcHRJbkNvbnRleHQoewogICAgICAgICAgICBwYXRoOiBucy5wYXRoLAogICAgICAgICAgICBleHBvcnRzOiBucy5leHBvcnRzCiAgICAgICAgICB9LCBmaWxlbmFtZSwgY29udGVudCkuZXhwb3J0czsKCiAgICAgICAgICBpZiAobnMuZXhwb3J0cyAmJiBucy5leHBvcnRzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpCiAgICAgICAgICAgIGNvbXBsZXRlKG5zLCBucy5leHBvcnRzKTsKCiAgICAgICAgICAvKiogQGN1dCAqLyBucy5maWxlbmFtZV8gPSBmaWxlbmFtZTsKICAgICAgICAgIC8qKiBAY3V0ICovIG5zLnNvdXJjZV8gPSBjb250ZW50OwogICAgICAgICAgLyoqIEBjdXQgKi8gbnMucmVxdWlyZXNfID0gcmVxdWlyZXM7CgogICAgICAgICAgLyoqIEBjdXQgKi8gcmVxdWlyZXMgPSBzYXZlZFJlcXVpcmVzOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG5hbWVzcGFjZXNbbmFtZXNwYWNlXS5leHBvcnRzOwogICAgICB9LCB7CiAgICAgICAgcGVybWFuZW50OiB0cnVlCiAgICAgIH0pLAoKICAgICAgJy5jc3MnOiBmdW5jdGlvbihjb250ZW50LCB1cmwsIGNzc1Jlc291cmNlKXsKICAgICAgICBpZiAoIWNzc1Jlc291cmNlKQogICAgICAgICAgY3NzUmVzb3VyY2UgPSBuZXcgQ3NzUmVzb3VyY2UodXJsKTsKCiAgICAgICAgY3NzUmVzb3VyY2UudXBkYXRlQ3NzVGV4dChjb250ZW50KTsKCiAgICAgICAgcmV0dXJuIGNzc1Jlc291cmNlOwogICAgICB9LAoKICAgICAgJy5qc29uJzogZnVuY3Rpb24oY29udGVudCwgdXJsKXsKICAgICAgICBpZiAodHlwZW9mIGNvbnRlbnQgPT0gJ29iamVjdCcpCiAgICAgICAgICByZXR1cm4gY29udGVudDsKCiAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICB0cnkgewogICAgICAgICAgY29udGVudCA9IFN0cmluZyhjb250ZW50KTsKICAgICAgICAgIHJlc3VsdCA9IGJhc2lzLmpzb24ucGFyc2UoY29udGVudCk7CiAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAvKiogQGN1dCAqLyBjb25zb2xlTWV0aG9kcy53YXJuKCdiYXNpcy5yZXNvdXJjZTogQ2FuXCd0IHBhcnNlIEpTT04gZnJvbSAnICsgdXJsLCB7IHVybDogdXJsLCBjb250ZW50OiBjb250ZW50IH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0IHx8IG51bGw7CiAgICAgIH0KICAgIH0KICB9KTsKCgogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgLy8gc2NyaXB0IGNvbXBpbGF0aW9uIGFuZCBleGVjdXRpb24KICAvLwoKICBmdW5jdGlvbiBjb21waWxlRnVuY3Rpb24oc291cmNlVVJMLCBhcmdzLCBib2R5KXsKICAgIHRyeSB7CiAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oYXJncywgYm9keQogICAgICAgIC8qKiBAY3V0ICovICsgJ1xuXG4vLyMgc291cmNlVVJMPScgKyBwYXRoVXRpbHMub3JpZ2luICsgc291cmNlVVJMCiAgICAgICk7CiAgICB9IGNhdGNoKGUpIHsKICAgICAgLyoqIEBjdXQgKi8gaWYgKGRvY3VtZW50ICYmICdsaW5lJyBpbiBlID09IGZhbHNlICYmICdhZGRFdmVudExpc3RlbmVyJyBpbiBnbG9iYWwpCiAgICAgIC8qKiBAY3V0ICovIHsKICAgICAgLyoqIEBjdXQgKi8gICAvLyBDaHJvbWUgKFY4KSBkb2Vzbid0IHByb3ZpZGUgbGluZSBudW1iZXIgd2hlcmUgZG9lcyBlcnJvciBvY2N1ciwKICAgICAgLyoqIEBjdXQgKi8gICAvLyBoZXJlIGlzIHRyaWNreSBhcHJvYWNoIHRvIGZldGNoIGxpbmUgbnVtYmVyIGluIHNlY29uZCAnY29tcGlsYXRpb24gZXJyb3InIG1lc3NhZ2UKICAgICAgLyoqIEBjdXQgKi8gICBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcignZXJyb3InLCBmdW5jdGlvbiBvbmVycm9yKGV2ZW50KXsKICAgICAgLyoqIEBjdXQgKi8gICAgIGlmIChldmVudC5maWxlbmFtZSA9PSBwYXRoVXRpbHMub3JpZ2luICsgc291cmNlVVJMKQogICAgICAvKiogQGN1dCAqLyAgICAgewogICAgICAvKiogQGN1dCAqLyAgICAgICBnbG9iYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignZXJyb3InLCBvbmVycm9yKTsKICAgICAgLyoqIEBjdXQgKi8gICAgICAgY29uc29sZU1ldGhvZHMuZXJyb3IoJ0NvbXBpbGF0aW9uIGVycm9yIGF0ICcgKyBldmVudC5maWxlbmFtZSArICc6JyArIGV2ZW50LmxpbmVubyArICc6ICcgKyBlKTsKICAgICAgLyoqIEBjdXQgKi8gICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgLyoqIEBjdXQgKi8gICAgIH0KICAgICAgLyoqIEBjdXQgKi8gICB9KTsKICAgICAgLyoqIEBjdXQgKi8KICAgICAgLyoqIEBjdXQgKi8gICB2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICAgIC8qKiBAY3V0ICovICAgc2NyaXB0LnNyYyA9IHNvdXJjZVVSTDsKICAgICAgLyoqIEBjdXQgKi8gICBzY3JpcHQuYXN5bmMgPSBmYWxzZTsKICAgICAgLyoqIEBjdXQgKi8gICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICAgIC8qKiBAY3V0ICovICAgZG9jdW1lbnQuaGVhZC5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICAvKiogQGN1dCAqLyB9CgogICAgICAvLyBkb24ndCB0aHJvdyBuZXcgZXhjZXB0aW9uLCBqdXN0IG91dHB1dCBlcnJvciBtZXNzYWdlIGFuZCByZXR1cm4gdW5kZWZpbmVkCiAgICAgIC8vIGluIHRoaXMgY2FzZSBtb3JlIGNoYW5jZXMgZm9yIG90aGVyIG1vZHVsZXMgY29udGludWUgdG8gd29yawogICAgICBjb25zb2xlTWV0aG9kcy5lcnJvcignQ29tcGlsYXRpb24gZXJyb3IgYXQgJyArIHNvdXJjZVVSTCArICgnbGluZScgaW4gZSA/ICc6JyArIChlLmxpbmUgLSAxKSA6ICcnKSArICc6ICcgKyBlKTsKICAgIH0KICB9CgogIHZhciBydW5TY3JpcHRJbkNvbnRleHQgPSBmdW5jdGlvbihjb250ZXh0LCBzb3VyY2VVUkwsIHNvdXJjZUNvZGUpewogICAgdmFyIGJhc2VVUkwgPSBwYXRoVXRpbHMuZGlybmFtZShzb3VyY2VVUkwpICsgJy8nOwogICAgdmFyIGNvbXBpbGVkU291cmNlQ29kZSA9IHNvdXJjZUNvZGU7CgogICAgaWYgKCFjb250ZXh0LmV4cG9ydHMpCiAgICAgIGNvbnRleHQuZXhwb3J0cyA9IHt9OwoKICAgIC8vIGNvbXBpbGUgZnVuY3Rpb24gaWYgcmVxdWlyZWQKICAgIGlmICh0eXBlb2YgY29tcGlsZWRTb3VyY2VDb2RlICE9ICdmdW5jdGlvbicpCiAgICAgIGNvbXBpbGVkU291cmNlQ29kZSA9IGNvbXBpbGVGdW5jdGlvbihzb3VyY2VVUkwsIFsnZXhwb3J0cycsICdtb2R1bGUnLCAnYmFzaXMnLCAnZ2xvYmFsJywgJ19fZmlsZW5hbWUnLCAnX19kaXJuYW1lJywgJ3Jlc291cmNlJywgJ3JlcXVpcmUnXSwKICAgICAgICAnInVzZSBzdHJpY3QiO1xuJyArCiAgICAgICAgc291cmNlQ29kZQogICAgICApOwoKICAgIC8vIHJ1bgogICAgaWYgKHR5cGVvZiBjb21waWxlZFNvdXJjZUNvZGUgPT0gJ2Z1bmN0aW9uJykKICAgICAgY29tcGlsZWRTb3VyY2VDb2RlLmNhbGwoCiAgICAgICAgY29udGV4dC5leHBvcnRzLAogICAgICAgIGNvbnRleHQuZXhwb3J0cywKICAgICAgICBjb250ZXh0LAogICAgICAgIGJhc2lzLAogICAgICAgIGdsb2JhbCwKICAgICAgICBzb3VyY2VVUkwsCiAgICAgICAgYmFzZVVSTCwKICAgICAgICBmdW5jdGlvbihyZWxhdGl2ZVBhdGgpewogICAgICAgICAgLyoqIEBjdXQgKi8gaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHJlbGF0aXZlUGF0aCkpCiAgICAgICAgICAvKiogQGN1dCAqLyAgIGNvbnNvbGVNZXRob2RzLndhcm4oJ0JhZCB1c2FnZTogcmVzb3VyY2UoXCcnICsgcmVsYXRpdmVQYXRoICsgJ1wnKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuJyk7CgogICAgICAgICAgcmV0dXJuIGdldFJlc291cmNlKHBhdGhVdGlscy5yZXNvbHZlKGJhc2VVUkwsIHJlbGF0aXZlUGF0aCkpOwogICAgICAgIH0sCiAgICAgICAgZnVuY3Rpb24ocmVsYXRpdmVQYXRoLCBiYXNlKXsKICAgICAgICAgIHJldHVybiByZXF1aXJlTmFtZXNwYWNlKHJlbGF0aXZlUGF0aCwgYmFzZSB8fCBiYXNlVVJMKTsKICAgICAgICB9CiAgICAgICk7CgogICAgcmV0dXJuIGNvbnRleHQ7CiAgfTsKCgogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgLy8gTmFtZXNwYWNlIHN1YnN5c3RlbQogIC8vCgogIHZhciBuYW1lc3BhY2VzID0ge307CiAgdmFyIG5hbWVzcGFjZTJmaWxlbmFtZSA9IHt9OwogIHZhciBmaWxlbmFtZTJuYW1lc3BhY2UgPSB7fTsKICB2YXIgbnNSb290UGF0aCA9IHt9OwoKICBpdGVyYXRlKGNvbmZpZy5tb2R1bGVzLCBmdW5jdGlvbihuYW1lLCBtb2R1bGUpewogICAgbnNSb290UGF0aFtuYW1lXSA9IG1vZHVsZS5wYXRoICsgJy8nOwogICAgbmFtZXNwYWNlMmZpbGVuYW1lW25hbWVdID0gbW9kdWxlLmZpbGVuYW1lOwogICAgZmlsZW5hbWUybmFtZXNwYWNlW21vZHVsZS5maWxlbmFtZV0gPSBuYW1lOwogIH0pOwoKICAoZnVuY3Rpb24obWFwKXsKICAgIHZhciBtYXAgPSB0eXBlb2YgX19uYW1lc3BhY2VfbWFwX18gIT0gJ3VuZGVmaW5lZCcgPyBfX25hbWVzcGFjZV9tYXBfXyA6IG51bGw7CiAgICBpZiAobWFwKQogICAgewogICAgICBmb3IgKHZhciBrZXkgaW4gbWFwKQogICAgICB7CiAgICAgICAgdmFyIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoa2V5KTsKICAgICAgICB2YXIgbmFtZXNwYWNlID0gbWFwW2tleV07CiAgICAgICAgZmlsZW5hbWUybmFtZXNwYWNlW2ZpbGVuYW1lXSA9IG5hbWVzcGFjZTsKICAgICAgICBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZXNwYWNlXSA9IGZpbGVuYW1lOwogICAgICB9CiAgICB9CiAgfSkoKTsKCgogIHZhciBOYW1lc3BhY2UgPSBDbGFzcyhudWxsLCB7CiAgICBjbGFzc05hbWU6ICdiYXNpcy5OYW1lc3BhY2UnLAogICAgaW5pdDogZnVuY3Rpb24obmFtZSl7CiAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgIHRoaXMuZXhwb3J0cyA9IHsKICAgICAgICBwYXRoOiB0aGlzLm5hbWUKICAgICAgfTsKICAgIH0sCiAgICB0b1N0cmluZzogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuICdbYmFzaXMubmFtZXNwYWNlICcgKyB0aGlzLnBhdGggKyAnXSc7CiAgICB9LAogICAgZXh0ZW5kOiBmdW5jdGlvbihuYW1lcyl7CiAgICAgIGV4dGVuZCh0aGlzLmV4cG9ydHMsIG5hbWVzKTsKICAgICAgcmV0dXJuIGNvbXBsZXRlKHRoaXMsIG5hbWVzKTsKICAgIH0KICB9KTsKCiAgZnVuY3Rpb24gcmVzb2x2ZU5TRmlsZW5hbWUobmFtZXNwYWNlKXsKICAgIGlmIChuYW1lc3BhY2UgaW4gbmFtZXNwYWNlMmZpbGVuYW1lID09IGZhbHNlKQogICAgewogICAgICB2YXIgcGFydHMgPSBuYW1lc3BhY2Uuc3BsaXQoJy4nKTsKICAgICAgdmFyIG5hbWVzcGFjZVJvb3QgPSBwYXJ0cy5zaGlmdCgpOwogICAgICB2YXIgZmlsZW5hbWUgPSBwYXJ0cy5qb2luKCcvJykgKyAnLmpzJzsKCiAgICAgIGlmIChuYW1lc3BhY2VSb290IGluIG5zUm9vdFBhdGggPT0gZmFsc2UpCiAgICAgICAgbnNSb290UGF0aFtuYW1lc3BhY2VSb290XSA9IHBhdGhVdGlscy5iYXNlVVJJICsgbmFtZXNwYWNlUm9vdCArICcvJzsKCiAgICAgIGlmIChuYW1lc3BhY2VSb290ID09IG5hbWVzcGFjZSkKICAgICAgICBmaWxlbmFtZSA9IG5zUm9vdFBhdGhbbmFtZXNwYWNlUm9vdF0ucmVwbGFjZSgvXC8kLywgJycpICsgJy5qcyc7CiAgICAgIGVsc2UKICAgICAgICBmaWxlbmFtZSA9IG5zUm9vdFBhdGhbbmFtZXNwYWNlUm9vdF0gKyBmaWxlbmFtZTsKCiAgICAgIG5hbWVzcGFjZTJmaWxlbmFtZVtuYW1lc3BhY2VdID0gZmlsZW5hbWU7CiAgICAgIGZpbGVuYW1lMm5hbWVzcGFjZVtmaWxlbmFtZV0gPSBuYW1lc3BhY2U7CiAgICB9CgogICAgcmV0dXJuIG5hbWVzcGFjZTJmaWxlbmFtZVtuYW1lc3BhY2VdOwogIH0KCiAgZnVuY3Rpb24gZ2V0Um9vdE5hbWVzcGFjZShuYW1lKXsKICAgIHZhciBuYW1lc3BhY2UgPSBuYW1lc3BhY2VzW25hbWVdOwoKICAgIGlmICghbmFtZXNwYWNlKQogICAgewogICAgICBuYW1lc3BhY2UgPSBuYW1lc3BhY2VzW25hbWVdID0gbmV3IE5hbWVzcGFjZShuYW1lKTsKCiAgICAgIG5hbWVzcGFjZS5uYW1lc3BhY2VzXyA9IHt9OwogICAgICBuYW1lc3BhY2UubmFtZXNwYWNlc19bbmFtZV0gPSBuYW1lc3BhY2U7CgogICAgICBpZiAoIWNvbmZpZy5ub0NvbmZsaWN0KQogICAgICAgIGdsb2JhbFtuYW1lXSA9IG5hbWVzcGFjZTsKICAgIH0KCiAgICAvLyBidWlsZGVyIGNvdWxkIGdlbmVyYXRlIHNvbWUgY29kZSBoZXJlLCBzb21ldGhpbmcgbGlrZSB0aGlzCiAgICAvLyBpZiAobmFtZSA9PSAnYXBwJyAmJiAhYXBwKQogICAgLy8gICByZXR1cm4gYXBwID0gbmFtZXNwYWNlOwoKICAgIHJldHVybiBuYW1lc3BhY2U7CiAgfQoKIC8qKgogICogUmV0dXJucyBuYW1lc3BhY2UgYnkgcGF0aCBvciBjcmVhdGVzIG5ldyBvbmUgKGlmIG5hbWVzcGFjZSBpc24ndCBleGlzdHMpLgogICogQGV4YW1wbGUKICAqICAgdmFyIGZvb0Jhck5hbWVzcGFjZSA9IGJhc2lzLm5hbWVzcGFjZSgnZm9vLmJhcicpOwogICogQG5hbWUgbmFtZXNwYWNlCiAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aAogICogQHJldHVybiB7YmFzaXMuTmFtZXNwYWNlfQogICovCiAgZnVuY3Rpb24gZ2V0TmFtZXNwYWNlKHBhdGgpewogICAgcGF0aCA9IHBhdGguc3BsaXQoJy4nKTsKCiAgICB2YXIgcm9vdE5zID0gZ2V0Um9vdE5hbWVzcGFjZShwYXRoWzBdKTsKICAgIHZhciBjdXJzb3IgPSByb290TnM7CgogICAgZm9yICh2YXIgaSA9IDEsIG5hbWU7IG5hbWUgPSBwYXRoW2ldOyBpKyspCiAgICB7CiAgICAgIGlmICghY3Vyc29yW25hbWVdKQogICAgICB7CiAgICAgICAgdmFyIG5zcGF0aCA9IHBhdGguc2xpY2UoMCwgaSArIDEpLmpvaW4oJy4nKTsKCiAgICAgICAgLy8gY3JlYXRlIG5ldyBuYW1lc3BhY2UKICAgICAgICBjdXJzb3JbbmFtZV0gPSBuZXcgTmFtZXNwYWNlKG5zcGF0aCk7CiAgICAgICAgcm9vdE5zLm5hbWVzcGFjZXNfW25zcGF0aF0gPSBjdXJzb3JbbmFtZV07CiAgICAgIH0KCiAgICAgIGN1cnNvciA9IGN1cnNvcltuYW1lXTsKICAgIH0KCiAgICBuYW1lc3BhY2VzW3BhdGguam9pbignLicpXSA9IGN1cnNvcjsKCiAgICByZXR1cm4gY3Vyc29yOwogIH0KCgogLyoqCiAgKiBAcGFyYW0ge3N0cmluZ30gZmlsZW5hbWUKICAqIEBwYXJhbSB7c3RyaW5nfSBkaXJuYW1lCiAgKiBAbmFtZSByZXF1aXJlCiAgKi8KICB2YXIgcmVxdWlyZU5hbWVzcGFjZSA9IChmdW5jdGlvbigpewogICAgaWYgKE5PREVfRU5WKQogICAgewogICAgICB2YXIgbW9kdWxlUHJvdG8gPSBtb2R1bGUuY29uc3RydWN0b3IucHJvdG90eXBlOwogICAgICByZXR1cm4gZnVuY3Rpb24oZmlsZW5hbWUsIGRpcm5hbWUpewogICAgICAgIGlmICghL1teYS16MC05X1wuXS9pLnRlc3QoZmlsZW5hbWUpIHx8IHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSA9PSAnLmpzJykKICAgICAgICB7CiAgICAgICAgICB2YXIgX2NvbXBpbGUgPSBtb2R1bGVQcm90by5fY29tcGlsZTsKICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBnZXROYW1lc3BhY2UoZmlsZW5hbWUpOwoKICAgICAgICAgIC8vIHBhdGNoIG5vZGUuanMgbW9kdWxlLl9jb21waWxlCiAgICAgICAgICBtb2R1bGVQcm90by5fY29tcGlsZSA9IGZ1bmN0aW9uKGNvbnRlbnQsIGZpbGVuYW1lKXsKICAgICAgICAgICAgdGhpcy5iYXNpcyA9IGJhc2lzOwogICAgICAgICAgICBjb250ZW50ID0KICAgICAgICAgICAgICAndmFyIF9fbm9kZWpzUmVxdWlyZSA9IHJlcXVpcmU7XG4nICsKICAgICAgICAgICAgICAndmFyIGJhc2lzID0gbW9kdWxlLmJhc2lzO1xuJyArCiAgICAgICAgICAgICAgJ3ZhciByZXNvdXJjZSA9IGZ1bmN0aW9uKGZpbGVuYW1lKXsgcmV0dXJuIGJhc2lzLnJlc291cmNlKF9fZGlybmFtZSArICIvIiArIGZpbGVuYW1lKSB9O1xuJyArCiAgICAgICAgICAgICAgJ3ZhciByZXF1aXJlID0gZnVuY3Rpb24oZmlsZW5hbWUsIGJhc2VVUkkpeyByZXR1cm4gYmFzaXMucmVxdWlyZShmaWxlbmFtZSwgYmFzZVVSSSB8fCBfX2Rpcm5hbWUpIH07XG4nICsKICAgICAgICAgICAgICBjb250ZW50OwogICAgICAgICAgICBfY29tcGlsZS5jYWxsKGV4dGVuZCh0aGlzLCBuYW1lc3BhY2UpLCBjb250ZW50LCBmaWxlbmFtZSk7CiAgICAgICAgICB9OwoKICAgICAgICAgIHZhciBleHBvcnRzID0gcmVxdWlyZShfX2Rpcm5hbWUgKyAnLycgKyBmaWxlbmFtZS5yZXBsYWNlKC9cLi9nLCAnLycpKTsKCiAgICAgICAgICBuYW1lc3BhY2UuZXhwb3J0cyA9IGV4cG9ydHM7CiAgICAgICAgICBpZiAoZXhwb3J0cyAmJiBleHBvcnRzLmNvbnN0cnVjdG9yID09PSBPYmplY3QpCiAgICAgICAgICAgIGNvbXBsZXRlKG5hbWVzcGFjZSwgZXhwb3J0cyk7CgogICAgICAgICAgLy8gcmVzdG9yZSBub2RlLmpzIG1vZHVsZS5fY29tcGlsZQogICAgICAgICAgbW9kdWxlUHJvdG8uX2NvbXBpbGUgPSBfY29tcGlsZTsKCiAgICAgICAgICByZXR1cm4gZXhwb3J0czsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZGlybmFtZSwgZmlsZW5hbWUpOwogICAgICAgICAgcmV0dXJuIHJlcXVpcmUoZmlsZW5hbWUpOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZpbGVuYW1lLCBkaXJuYW1lKXsKICAgICAgICBpZiAoIS9bXmEtejAtOV9cLl0vaS50ZXN0KGZpbGVuYW1lKSAmJiBwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkgIT0gJy5qcycpCiAgICAgICAgewogICAgICAgICAgLy8gbmFtZXNwYWNlLCBsaWtlICdmb28uYmFyLmJheicKICAgICAgICAgIGZpbGVuYW1lID0gcmVzb2x2ZU5TRmlsZW5hbWUoZmlsZW5hbWUpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgLyoqIEBjdXQgKi8gaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KGZpbGVuYW1lKSkKICAgICAgICAgIC8qKiBAY3V0ICovICAgY29uc29sZU1ldGhvZHMud2FybignQmFkIHVzYWdlOiByZXF1aXJlKFwnJyArIGZpbGVuYW1lICsgJ1wnKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuJyk7CgogICAgICAgICAgLy8gcmVndWxhciBmaWxlbmFtZQogICAgICAgICAgZmlsZW5hbWUgPSBwYXRoVXRpbHMucmVzb2x2ZShkaXJuYW1lLCBmaWxlbmFtZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZ2V0UmVzb3VyY2UoZmlsZW5hbWUpLmZldGNoKCk7CiAgICAgIH07CiAgICB9CiAgfSkoKTsKCgogIGZ1bmN0aW9uIHBhdGNoKGZpbGVuYW1lLCBwYXRjaEZuKXsKICAgIGlmICghL1teYS16MC05X1wuXS9pLnRlc3QoZmlsZW5hbWUpICYmIHBhdGhVdGlscy5leHRuYW1lKGZpbGVuYW1lKSAhPSAnLmpzJykKICAgIHsKICAgICAgLy8gbmFtZXNwYWNlLCBsaWtlICdmb28uYmFyLmJheicKICAgICAgZmlsZW5hbWUgPSByZXNvbHZlTlNGaWxlbmFtZShmaWxlbmFtZSk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgIC8qKiBAY3V0ICovIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChmaWxlbmFtZSkpCiAgICAgIC8qKiBAY3V0ICovICAgY29uc29sZU1ldGhvZHMud2FybignQmFkIHVzYWdlOiBiYXNpcy5wYXRjaChcJycgKyBmaWxlbmFtZSArICdcJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLicpOwoKICAgICAgLy8gcmVndWxhciBmaWxlbmFtZQogICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGZpbGVuYW1lKTsKICAgIH0KCiAgICBpZiAoIXJlc291cmNlUGF0Y2hbZmlsZW5hbWVdKQogICAgICByZXNvdXJjZVBhdGNoW2ZpbGVuYW1lXSA9IFtwYXRjaEZuXTsKICAgIGVsc2UKICAgICAgcmVzb3VyY2VQYXRjaFtmaWxlbmFtZV0ucHVzaChwYXRjaEZuKTsKCiAgICAvLyBpZiByZXNvdXJjZSBleGlzdHMgYW5kIHJlc29sdmVkIC0+IGFwcGx5IHBhdGNoCiAgICB2YXIgcmVzb3VyY2UgPSBnZXRSZXNvdXJjZS5nZXQoZmlsZW5hbWUpOwogICAgaWYgKHJlc291cmNlICYmIHJlc291cmNlLmlzUmVzb2x2ZWQoKSkKICAgICAgcGF0Y2hGbihyZXNvdXJjZS5nZXQoKSwgcmVzb3VyY2UudXJsKTsKICB9CgoKIC8qKgogICogQG5hbWVzcGFjZSBGdW5jdGlvbi5wcm90b3R5cGUKICAqLwoKICBjb21wbGV0ZShGdW5jdGlvbi5wcm90b3R5cGUsIHsKICAgLyoqCiAgICAqIENoYW5nZXMgZnVuY3Rpb24gZGVmYXVsdCBjb250ZXh0LiBJdCBhbHNvIG1ha2VzIHBvc3NpYmxlIHRvIHNldCBzdGF0aWMKICAgICogYXJndW1lbnRzIChmb2xkaW5nKSBmb3IgZnVuY3Rpb24uCiAgICAqIEltcGxlbWVudGVkIGluIEVTNS4KICAgICogQHBhcmFtIHtPYmplY3R9IHRoaXNPYmplY3QKICAgICogQHBhcmFtIHsuLi4qfSBhcmdzCiAgICAqIEByZXR1cm4ge2Z1bmN0aW9uKCl9CiAgICAqIFRPRE86IGNoZWNrIGNvbXBsaWFuY2UKICAgICovCiAgICBiaW5kOiBmdW5jdGlvbih0aGlzT2JqZWN0KXsKICAgICAgdmFyIGZuID0gdGhpczsKICAgICAgdmFyIHBhcmFtcyA9IGFycmF5RnJvbShhcmd1bWVudHMsIDEpOwoKICAgICAgcmV0dXJuIHBhcmFtcy5sZW5ndGgKICAgICAgICA/IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzT2JqZWN0LCBwYXJhbXMuY29uY2F0LmFwcGx5KHBhcmFtcywgYXJndW1lbnRzKSk7CiAgICAgICAgICB9CiAgICAgICAgOiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkodGhpc09iamVjdCwgYXJndW1lbnRzKTsKICAgICAgICAgIH07CiAgICB9CiAgfSk7CgoKIC8qKgogICogQXJyYXkgZXh0ZW5zaW9ucwogICogQG5hbWVzcGFjZSBBcnJheQogICovCgogIGNvbXBsZXRlKEFycmF5LCB7CiAgIC8qKgogICAgKiBSZXR1cm5zIHRydWUgaWYgdmFsdWUgaXMgQXJyYXkgaW5zdGFuY2UuCiAgICAqIEltcGxlbWVudGVkIGluIEVTNS4KICAgICogQHBhcmFtIHsqfSB2YWx1ZSBWYWx1ZSB0byBiZSB0ZXN0ZWQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAgaXNBcnJheTogZnVuY3Rpb24odmFsdWUpewogICAgICByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgICB9CiAgfSk7CgogIGZ1bmN0aW9uIGFycmF5RnJvbShvYmplY3QsIG9mZnNldCl7CiAgICBpZiAob2JqZWN0ICE9IG51bGwpCiAgICB7CiAgICAgIHZhciBsZW4gPSBvYmplY3QubGVuZ3RoOwoKICAgICAgaWYgKHR5cGVvZiBsZW4gPT0gJ3VuZGVmaW5lZCcgfHwKICAgICAgICAgIHRvU3RyaW5nLmNhbGwob2JqZWN0KSA9PSAnW29iamVjdCBGdW5jdGlvbl0nKSAvLyBTYWZhcmkgNS4xIGhhcyBhIGJ1ZywgdHlwZW9mIGZvciBub2RlIGNvbGxlY3Rpb24gcmV0dXJucyBgZnVuY3Rpb25gCiAgICAgICAgcmV0dXJuIFtvYmplY3RdOwoKICAgICAgaWYgKCFvZmZzZXQpCiAgICAgICAgb2Zmc2V0ID0gMDsKCiAgICAgIGlmIChsZW4gLSBvZmZzZXQgPiAwKQogICAgICB7CiAgICAgICAgZm9yICh2YXIgcmVzdWx0ID0gW10sIGsgPSAwLCBpID0gb2Zmc2V0OyBpIDwgbGVuOykKICAgICAgICAgIHJlc3VsdFtrKytdID0gb2JqZWN0W2krK107CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBbXTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUFycmF5KGxlbmd0aCwgZmlsbFZhbHVlLCB0aGlzT2JqZWN0KXsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIHZhciBpc0Z1bmMgPSB0eXBlb2YgZmlsbFZhbHVlID09ICdmdW5jdGlvbic7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykKICAgICAgcmVzdWx0W2ldID0gaXNGdW5jID8gZmlsbFZhbHVlLmNhbGwodGhpc09iamVjdCwgaSwgcmVzdWx0KSA6IGZpbGxWYWx1ZTsKCiAgICByZXR1cm4gcmVzdWx0OwogIH0KCgogLyoqCiAgKiBAbmFtZXNwYWNlIEFycmF5LnByb3RvdHlwZQogICovCgogIGNvbXBsZXRlKEFycmF5LnByb3RvdHlwZSwgewogICAgLy8gSmF2YVNjcmlwdCAxLjYKICAgIGluZGV4T2Y6IGZ1bmN0aW9uKHNlYXJjaEVsZW1lbnQsIG9mZnNldCl7CiAgICAgIG9mZnNldCA9IHBhcnNlSW50KG9mZnNldCwgMTApIHx8IDA7CiAgICAgIGlmIChvZmZzZXQgPCAwKQogICAgICAgIHJldHVybiAtMTsKICAgICAgZm9yICg7IG9mZnNldCA8IHRoaXMubGVuZ3RoOyBvZmZzZXQrKykKICAgICAgICBpZiAodGhpc1tvZmZzZXRdID09PSBzZWFyY2hFbGVtZW50KQogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgcmV0dXJuIC0xOwogICAgfSwKICAgIGxhc3RJbmRleE9mOiBmdW5jdGlvbihzZWFyY2hFbGVtZW50LCBvZmZzZXQpewogICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGg7CiAgICAgIG9mZnNldCA9IHBhcnNlSW50KG9mZnNldCwgMTApOwogICAgICBpZiAoaXNOYU4ob2Zmc2V0KSB8fCBvZmZzZXQgPj0gbGVuKQogICAgICAgIG9mZnNldCA9IGxlbiAtIDE7CiAgICAgIGVsc2UKICAgICAgICBvZmZzZXQgPSAob2Zmc2V0ICsgbGVuKSAlIGxlbjsKICAgICAgZm9yICg7IG9mZnNldCA+PSAwOyBvZmZzZXQtLSkKICAgICAgICBpZiAodGhpc1tvZmZzZXRdID09PSBzZWFyY2hFbGVtZW50KQogICAgICAgICAgcmV0dXJuIG9mZnNldDsKICAgICAgcmV0dXJuIC0xOwogICAgfSwKICAgIGZvckVhY2g6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KXsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgaWYgKGkgaW4gdGhpcykKICAgICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcyk7CiAgICB9LAogICAgZXZlcnk6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KXsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgaWYgKGkgaW4gdGhpcyAmJiAhY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKSkKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogICAgc29tZTogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpewogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICBpZiAoaSBpbiB0aGlzICYmIGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcykpCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIGZpbHRlcjogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIGlmIChpIGluIHRoaXMgJiYgY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKSkKICAgICAgICAgIHJlc3VsdC5wdXNoKHRoaXNbaV0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKICAgIG1hcDogZnVuY3Rpb24oY2FsbGJhY2ssIHRoaXNPYmplY3QpewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIGlmIChpIGluIHRoaXMpCiAgICAgICAgICByZXN1bHRbaV0gPSBjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKICAgIC8vIEphdmFTY3JpcHQgMS44CiAgICByZWR1Y2U6IGZ1bmN0aW9uKGNhbGxiYWNrLCBpbml0aWFsVmFsdWUpewogICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGg7CiAgICAgIHZhciBhcmdzTGVuID0gYXJndW1lbnRzLmxlbmd0aDsKCiAgICAgIC8vIG5vIHZhbHVlIHRvIHJldHVybiBpZiBubyBpbml0aWFsIHZhbHVlIGFuZCBhbiBlbXB0eSBhcnJheQogICAgICBpZiAobGVuID09IDAgJiYgYXJnc0xlbiA9PSAxKQogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoKTsKCiAgICAgIHZhciByZXN1bHQ7CiAgICAgIHZhciBpbml0ZWQgPSAwOwoKICAgICAgaWYgKGFyZ3NMZW4gPiAxKQogICAgICB7CiAgICAgICAgcmVzdWx0ID0gaW5pdGlhbFZhbHVlOwogICAgICAgIGluaXRlZCA9IDE7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspCiAgICAgICAgaWYgKGkgaW4gdGhpcykKICAgICAgICAgIGlmIChpbml0ZWQrKykKICAgICAgICAgICAgcmVzdWx0ID0gY2FsbGJhY2suY2FsbChudWxsLCByZXN1bHQsIHRoaXNbaV0sIGksIHRoaXMpOwogICAgICAgICAgZWxzZQogICAgICAgICAgICByZXN1bHQgPSB0aGlzW2ldOwoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9KTsKCiAgdmFyIGFycmF5RnVuY3Rpb25zID0gewogICAgZnJvbTogYXJyYXlGcm9tLAogICAgY3JlYXRlOiBjcmVhdGVBcnJheSwKCiAgICAvLyBleHRyYWN0b3JzCiAgICBmbGF0dGVuOiBmdW5jdGlvbih0aGlzXyl7CiAgICAgIHJldHVybiB0aGlzXy5jb25jYXQuYXBwbHkoW10sIHRoaXNfKTsKICAgIH0sCiAgICByZXBlYXQ6IGZ1bmN0aW9uKHRoaXNfLCBjb3VudCl7CiAgICAgIHJldHVybiBhcnJheUZ1bmN0aW9ucy5mbGF0dGVuKGNyZWF0ZUFycmF5KHBhcnNlSW50KGNvdW50LCAxMCkgfHwgMCwgdGhpc18pKTsKICAgIH0sCgogICAgLy8gc2VhcmNoCiAgIC8qKgogICAgKiBSZXR1cm5zIGZpcnN0IGl0ZW0gd2hlcmUgZ2V0dGVyKGl0ZW0pID09PSB2YWx1ZQogICAgKiBAZXhhbXBsZQogICAgKiAgIHZhciBsaXN0ID0gW3sgYTogMSwgYjogMiB9LCB7IGE6IDIsIGI6IDMgfSwgeyBhOiAxLCBiOiA0fSwgeyBhOiA1IH1dOwogICAgKgogICAgKiAgIC8vIHNlYXJjaCBmb3IgaXRlbSB3aGVyZSBvYmplY3QuYSA9PSAyCiAgICAqICAgdmFyIHJlc3VsdCA9IGxpc3Quc2VhcmNoKDUsICdhJyk7CiAgICAqICAgICAvLyByZXN1bHQgLT4geyBhOiA1IH0KICAgICoKICAgICogICAvLyBzZWFyY2ggZm9yIHdoZXJlIGEgPT0gMSAmJiBiID4gMgogICAgKiAgIHZhciByZXN1bHQgPSBsaXN0LnNlYXJjaCh0cnVlLCBmdW5jdGlvbihvYmplY3QpeyByZXR1cm4gb2JqZWN0LmEgPT0gMSAmJiBvYmplY3QuYiA+IDIgfSk7CiAgICAqICAgICAvLyByZXN1bHQgLT4geyBhOiAxLCBiOiAzIH0KICAgICoKICAgICogICAvLyBzZWFyY2ggYWxsIGl0ZW1zIHdoZXJlIGEgPT0gMQogICAgKiAgIHZhciByZXN1bHQgPSBuZXcgQXJyYXkoKTsKICAgICogICB2YXIgaXRlbSA9IGxpc3Quc2VhcmNoKDEsICdhJyk7CiAgICAqICAgd2hpbGUgKGl0ZW0pCiAgICAqICAgewogICAgKiAgICAgcmVzdWx0LnB1c2goaXRlbSkKICAgICogICAgIGl0ZW0gPSBsaXN0LnNlYXJjaCgxLCAnYScsIGxpc3QubGFzdFNlYXJjaEluZGV4ICsgMSk7CiAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBsYXN0U2VhcmNoSW5kZXggc3RvcmUgaW5kZXggb2YgbGFzdCBmb3VuZGVkIGl0ZW0KICAgICogICB9CiAgICAqICAgICAvLyByZXN1bHQgLT4gW3sgYTogMSwgYjogMiB9LCB7IGE6IDEsIGI6IDR9XQogICAgKgogICAgKiAgIC8vIGJ1dCBpZiB5b3UgbmVlZCBhbGwgaXRlbXMgb2YgYXJyYXkgd2l0aCBmaWx0ZXJlZCBieSBjb25kaXRpb24gdXNlIEFycmF5I2ZpbHRlciBtZXRob2QgaW5zdGVhZAogICAgKiAgIHZhciByZXN1bHQgPSBsaXN0LmZpbHRlcihiYXNpcy5nZXR0ZXIoJ2EgPT0gMScpKTsKICAgICoKICAgICogQHBhcmFtIHtBcnJheX0gdGhpc18KICAgICogQHBhcmFtIHsqfSB2YWx1ZQogICAgKiBAcGFyYW0ge2Z1bmN0aW9uKG9iamVjdCl8c3RyaW5nfSBnZXR0ZXJfCiAgICAqIEBwYXJhbSB7bnVtYmVyPX0gb2Zmc2V0CiAgICAqIEByZXR1cm4geyp9CiAgICAqLwogICAgc2VhcmNoOiBmdW5jdGlvbih0aGlzXywgdmFsdWUsIGdldHRlcl8sIG9mZnNldCl7CiAgICAgIHRoaXNfLmxhc3RTZWFyY2hJbmRleCA9IC0xOwogICAgICBnZXR0ZXJfID0gZ2V0dGVyKGdldHRlcl8gfHwgJHNlbGYpOwoKICAgICAgZm9yICh2YXIgaW5kZXggPSBwYXJzZUludChvZmZzZXQsIDEwKSB8fCAwLCBsZW4gPSB0aGlzXy5sZW5ndGg7IGluZGV4IDwgbGVuOyBpbmRleCsrKQogICAgICAgIGlmIChnZXR0ZXJfKHRoaXNfW2luZGV4XSkgPT09IHZhbHVlKQogICAgICAgICAgcmV0dXJuIHRoaXNfW3RoaXNfLmxhc3RTZWFyY2hJbmRleCA9IGluZGV4XTsKICAgIH0sCgogICAvKioKICAgICogQHBhcmFtIHtBcnJheX0gdGhpc18KICAgICogQHBhcmFtIHsqfSB2YWx1ZQogICAgKiBAcGFyYW0ge2Z1bmN0aW9uKG9iamVjdCl8c3RyaW5nfSBnZXR0ZXJfCiAgICAqIEBwYXJhbSB7bnVtYmVyPX0gb2Zmc2V0CiAgICAqIEByZXR1cm4geyp9CiAgICAqLwogICAgbGFzdFNlYXJjaDogZnVuY3Rpb24odGhpc18sIHZhbHVlLCBnZXR0ZXJfLCBvZmZzZXQpewogICAgICB0aGlzXy5sYXN0U2VhcmNoSW5kZXggPSAtMTsKICAgICAgZ2V0dGVyXyA9IGdldHRlcihnZXR0ZXJfIHx8ICRzZWxmKTsKCiAgICAgIHZhciBsZW4gPSB0aGlzXy5sZW5ndGg7CiAgICAgIHZhciBpbmRleCA9IGlzTmFOKG9mZnNldCkgfHwgb2Zmc2V0ID09IG51bGwgPyBsZW4gOiBwYXJzZUludChvZmZzZXQsIDEwKTsKCiAgICAgIGZvciAodmFyIGkgPSBpbmRleCA+IGxlbiA/IGxlbiA6IGluZGV4OyBpLS0gPiAwOykKICAgICAgICBpZiAoZ2V0dGVyXyh0aGlzX1tpXSkgPT09IHZhbHVlKQogICAgICAgICAgcmV0dXJuIHRoaXNfW3RoaXNfLmxhc3RTZWFyY2hJbmRleCA9IGldOwogICAgfSwKCiAgICAvLyBjb2xsZWN0aW9uIGZvcgogICAgYWRkOiBmdW5jdGlvbih0aGlzXywgdmFsdWUpewogICAgICByZXR1cm4gdGhpc18uaW5kZXhPZih2YWx1ZSkgPT0gLTEgJiYgISF0aGlzXy5wdXNoKHZhbHVlKTsKICAgIH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSl7CiAgICAgIHZhciBpbmRleCA9IHRoaXNfLmluZGV4T2YodmFsdWUpOwogICAgICByZXR1cm4gaW5kZXggIT0gLTEgJiYgISF0aGlzXy5zcGxpY2UoaW5kZXgsIDEpOwogICAgfSwKICAgIGhhczogZnVuY3Rpb24odGhpc18sIHZhbHVlKXsKICAgICAgcmV0dXJuIHRoaXNfLmluZGV4T2YodmFsdWUpICE9IC0xOwogICAgfSwKCiAgICAvLyBtaXNjLgogICAgc29ydEFzT2JqZWN0OiBmdW5jdGlvbigpewogICAgICAvLyBkZXByZWNhdGVkIGluIGJhc2lzLmpzIDEuMy4wCiAgICAgIC8qKiBAY3V0ICovIGNvbnNvbGVNZXRob2RzLndhcm4oJ2Jhc2lzLmFycmF5LnNvcnRBc09iamVjdCBpcyBkZXByZWNhdGVkLCB1c2UgYmFzaXMuYXJyYXkuc29ydCBpbnN0ZWFkJyk7CiAgICAgIHJldHVybiBhcnJheUZ1bmN0aW9ucy5zb3J0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgc29ydDogZnVuY3Rpb24odGhpc18sIGdldHRlcl8sIGNvbXBhcmF0b3IsIGRlc2MpewogICAgICBnZXR0ZXJfID0gZ2V0dGVyKGdldHRlcl8pOwogICAgICBkZXNjID0gZGVzYyA/IC0xIDogMTsKCiAgICAgIHJldHVybiB0aGlzXwogICAgICAgIC5tYXAoZnVuY3Rpb24oaXRlbSwgaW5kZXgpewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgaTogaW5kZXgsICAgICAgICAvLyBpbmRleAogICAgICAgICAgICB2OiBnZXR0ZXJfKGl0ZW0pIC8vIHZhbHVlCiAgICAgICAgICB9OwogICAgICAgIH0pCiAgICAgICAgLnNvcnQoY29tcGFyYXRvciB8fCBmdW5jdGlvbihhLCBiKXsgICAgICAgICAgICAgLy8gc3RhYmlsaXR5IHNvcnRpbmcgKG5lY2Nlc3Nhcnkgb25seSBmb3IgYnJvd3NlcnMgd2l0aCBubyBzdHJvbmcgc29ydGluZywganVzdCBmb3Igc3VyZSkKICAgICAgICAgIHJldHVybiBkZXNjICogKChhLnYgPiBiLnYpIHx8IC0oYS52IDwgYi52KSB8fCAoYS5pID4gYi5pID8gMSA6IC0xKSk7CiAgICAgICAgfSkKICAgICAgICAubWFwKGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgcmV0dXJuIHRoaXNbaXRlbS5pXTsKICAgICAgICB9LCB0aGlzXyk7CiAgICB9CiAgfTsKCiAgLy8gSUUgNS41KyAmIE9wZXJhCiAgLy8gd2hlbiBzZWNvbmQgYXJndW1lbnQgaXMgb21pdGVkLCBtZXRob2Qgc2V0IHRoaXMgcGFyYW1ldGVyIGVxdWFsIHplcm8gKG11c3QgYmUgZXF1YWwgYXJyYXkgbGVuZ3RoKQogIGlmICghWzEsIDJdLnNwbGljZSgxKS5sZW5ndGgpCiAgewogICAgdmFyIG5hdGl2ZUFycmF5U3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZTsKICAgIEFycmF5LnByb3RvdHlwZS5zcGxpY2UgPSBmdW5jdGlvbigpewogICAgICB2YXIgcGFyYW1zID0gYXJyYXlGcm9tKGFyZ3VtZW50cyk7CiAgICAgIGlmIChwYXJhbXMubGVuZ3RoIDwgMikKICAgICAgICBwYXJhbXNbMV0gPSB0aGlzLmxlbmd0aDsKICAgICAgcmV0dXJuIG5hdGl2ZUFycmF5U3BsaWNlLmFwcGx5KHRoaXMsIHBhcmFtcyk7CiAgICB9OwogIH0KCiAvKioKICAqIFN0cmluZyBleHRlbnNpb25zCiAgKiBAbmFtZXNwYWNlIFN0cmluZwogICovCgogIHZhciBFU0NBUEVfRk9SX1JFR0VYUCA9IC8oW1wvXFxcKFwpXFtcXVw/XHtcfVx8XCpcK1wtXC5cXlwkXSkvZzsKICB2YXIgRk9STUFUX1JFR0VYUCA9IC9ceyhbYS16XGRfXSspKD86OihbXC4wXSkoXGQrKXw6KFw/KSk/XH0vZ2k7CgogIGNvbXBsZXRlKFN0cmluZywgewogICAgdG9Mb3dlckNhc2U6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudG9Mb3dlckNhc2UoKTsKICAgIH0sCiAgICB0b1VwcGVyQ2FzZTogZnVuY3Rpb24odmFsdWUpewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50b1VwcGVyQ2FzZSgpOwogICAgfSwKICAgIHRyaW06IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudHJpbSgpOwogICAgfSwKICAgIHRyaW1MZWZ0OiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRyaW1MZWZ0KCk7CiAgICB9LAogICAgdHJpbVJpZ2h0OiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRyaW1SaWdodCgpOwogICAgfQogIH0pOwoKCiAvKioKICAqIEBuYW1lc3BhY2UgU3RyaW5nLnByb3RvdHlwZQogICovCiAgY29tcGxldGUoU3RyaW5nLnByb3RvdHlwZSwgewogICAgdHJpbUxlZnQ6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLnJlcGxhY2UoL15ccysvLCAnJyk7CiAgICB9LAogICAgdHJpbVJpZ2h0OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5yZXBsYWNlKC9ccyskLywgJycpOwogICAgfSwKICAgIC8vIGltcGxlbWVudGVkIGF0IEVDTUFTY3JpcHQ1CiAgICB0cmltOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy50cmltTGVmdCgpLnRyaW1SaWdodCgpOwogICAgfQogIH0pOwoKICB2YXIgc3RyaW5nRnVuY3Rpb25zID0gewogICAvKioKICAgICogQHJldHVybiB7Kn0KICAgICovCiAgICB0b09iamVjdDogZnVuY3Rpb24odGhpc18sIHJldGhyb3cpewogICAgICAvLyB0cnkgeyByZXR1cm4gZXZhbCgnMCwnICsgdGhpc18pIH0gY2F0Y2goZSkge30KICAgICAgLy8gc2FmZSBzb2x1dGlvbiB3aXRoIG5vIGV2YWw6CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbigncmV0dXJuIDAsJyArIHRoaXNfKSgpOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICBpZiAocmV0aHJvdykKICAgICAgICAgIHRocm93IGU7CiAgICAgIH0KICAgIH0sCiAgICByZXBlYXQ6IGZ1bmN0aW9uKHRoaXNfLCBjb3VudCl7CiAgICAgIHJldHVybiAobmV3IEFycmF5KHBhcnNlSW50KGNvdW50LCAxMCkgKyAxIHx8IDApKS5qb2luKHRoaXNfKTsKICAgIH0sCiAgICBxdzogZnVuY3Rpb24odGhpc18pewogICAgICB2YXIgdHJpbW1lZCA9IHRoaXNfLnRyaW0oKTsKICAgICAgcmV0dXJuIHRyaW1tZWQgPyB0cmltbWVkLnNwbGl0KC9ccysvKSA6IFtdOwogICAgfSwKICAgIGZvclJlZ0V4cDogZnVuY3Rpb24odGhpc18pewogICAgICByZXR1cm4gdGhpc18ucmVwbGFjZShFU0NBUEVfRk9SX1JFR0VYUCwgJ1xcJDEnKTsKICAgIH0sCiAgICBmb3JtYXQ6IGZ1bmN0aW9uKHRoaXNfLCBmaXJzdCl7CiAgICAgIHZhciBkYXRhID0gYXJyYXlGcm9tKGFyZ3VtZW50cywgMSk7CgogICAgICBpZiAodHlwZW9mIGZpcnN0ID09ICdvYmplY3QnKQogICAgICAgIGV4dGVuZChkYXRhLCBmaXJzdCk7CgogICAgICByZXR1cm4gdGhpc18ucmVwbGFjZShGT1JNQVRfUkVHRVhQLAogICAgICAgIGZ1bmN0aW9uKG0sIGtleSwgbnVtRm9ybWF0LCBudW0sIG5vTnVsbCl7CiAgICAgICAgICB2YXIgdmFsdWUgPSBrZXkgaW4gZGF0YSA/IGRhdGFba2V5XSA6IChub051bGwgPyAnJyA6IG0pOwogICAgICAgICAgaWYgKG51bUZvcm1hdCAmJiAhaXNOYU4odmFsdWUpKQogICAgICAgICAgewogICAgICAgICAgICB2YWx1ZSA9IE51bWJlcih2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiBudW1Gb3JtYXQgPT0gJy4nCiAgICAgICAgICAgICAgPyB2YWx1ZS50b0ZpeGVkKG51bSkKICAgICAgICAgICAgICA6IG51bWJlckZ1bmN0aW9ucy5sZWFkKHZhbHVlLCBudW0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgKTsKICAgIH0sCiAgICBjYXBpdGFsaXplOiBmdW5jdGlvbih0aGlzXyl7CiAgICAgIHJldHVybiB0aGlzXy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHRoaXNfLnN1YnN0cigxKS50b0xvd2VyQ2FzZSgpOwogICAgfSwKICAgIGNhbWVsaXplOiBmdW5jdGlvbih0aGlzXyl7CiAgICAgIHJldHVybiB0aGlzXy5yZXBsYWNlKC8tKC4pL2csIGZ1bmN0aW9uKG0sIGNocil7CiAgICAgICAgcmV0dXJuIGNoci50b1VwcGVyQ2FzZSgpOwogICAgICB9KTsKICAgIH0sCiAgICBkYXNoZXJpemU6IGZ1bmN0aW9uKHRoaXNfKXsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoL1tBLVpdL2csIGZ1bmN0aW9uKG0pewogICAgICAgIHJldHVybiAnLScgKyBtLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0pOwogICAgfSwKCiAgICBpc0VtcHR5OiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsIHx8IFN0cmluZyh2YWx1ZSkgPT0gJyc7CiAgICB9LAogICAgaXNOb3RFbXB0eTogZnVuY3Rpb24odmFsdWUpewogICAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiBTdHJpbmcodmFsdWUpICE9ICcnOwogICAgfQogIH07CgoKICAvLyBGaXggc29tZSBtZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLQogIC8vIElFIDUuMC04LjAgZml4CiAgLy8gMS4gcmVzdWx0IGFycmF5IHdpdGhvdXQgbnVsbCBlbGVtZW50cwogIC8vIDIuIHdoZW4gcGFyZW50aGVzaXMgdXNlcywgcmVzdWx0IGFycmF5IHdpdGggbm8gcGFyZW50aGVzaXMgdmFsdWUKICBpZiAoJ3x8fCcuc3BsaXQoL1x8LykubGVuZ3RoICsgJ3x8fCcuc3BsaXQoLyhcfCkvKS5sZW5ndGggIT0gMTEpCiAgewogICAgdmFyIG5hdGl2ZVN0cmluZ1NwbGl0ID0gU3RyaW5nLnByb3RvdHlwZS5zcGxpdDsKICAgIFN0cmluZy5wcm90b3R5cGUuc3BsaXQgPSBmdW5jdGlvbihwYXR0ZXJuLCBjb3VudCl7CiAgICAgIGlmICghcGF0dGVybiB8fCBwYXR0ZXJuIGluc3RhbmNlb2YgUmVnRXhwID09IGZhbHNlIHx8IHBhdHRlcm4uc291cmNlID09ICcnKQogICAgICAgIHJldHVybiBuYXRpdmVTdHJpbmdTcGxpdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB2YXIgcG9zID0gMDsKICAgICAgdmFyIG1hdGNoOwoKICAgICAgaWYgKCFwYXR0ZXJuLmdsb2JhbCkKICAgICAgICBwYXR0ZXJuID0gbmV3IFJlZ0V4cChwYXR0ZXJuLnNvdXJjZSwgL1wvKFttaV0qKSQvLmV4ZWMocGF0dGVybilbMV0gKyAnZycpOwoKICAgICAgd2hpbGUgKG1hdGNoID0gcGF0dGVybi5leGVjKHRoaXMpKQogICAgICB7CiAgICAgICAgbWF0Y2hbMF0gPSB0aGlzLnN1YnN0cmluZyhwb3MsIG1hdGNoLmluZGV4KTsKICAgICAgICByZXN1bHQucHVzaC5hcHBseShyZXN1bHQsIG1hdGNoKTsKICAgICAgICBwb3MgPSBwYXR0ZXJuLmxhc3RJbmRleDsKICAgICAgfQoKICAgICAgcmVzdWx0LnB1c2godGhpcy5zdWJzdHIocG9zKSk7CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9CgogIC8vIElFIDUuMC04LjAgZml4CiAgaWYgKCcxMicuc3Vic3RyKC0xKSAhPSAnMicpCiAgewogICAgdmFyIG5hdGl2ZVN0cmluZ1N1YnN0ciA9IFN0cmluZy5wcm90b3R5cGUuc3Vic3RyOwogICAgU3RyaW5nLnByb3RvdHlwZS5zdWJzdHIgPSBmdW5jdGlvbihzdGFydCwgZW5kKXsKICAgICAgcmV0dXJuIG5hdGl2ZVN0cmluZ1N1YnN0ci5jYWxsKHRoaXMsIHN0YXJ0IDwgMCA/IE1hdGgubWF4KDAsIHRoaXMubGVuZ3RoICsgc3RhcnQpIDogc3RhcnQsIGVuZCk7CiAgICB9OwogIH0KCgogLyoqCiAgKiBOdW1iZXIgZXh0ZW5zaW9ucwogICogQG5hbWVzcGFjZSBOdW1iZXIucHJvdG90eXBlCiAgKi8KCiAgdmFyIG51bWJlckZ1bmN0aW9ucyA9IHsKICAgIGZpdDogZnVuY3Rpb24odGhpc18sIG1pbiwgbWF4KXsKICAgICAgaWYgKCFpc05hTihtaW4pICYmIHRoaXNfIDwgbWluKQogICAgICAgIHJldHVybiBOdW1iZXIobWluKTsKICAgICAgaWYgKCFpc05hTihtYXgpICYmIHRoaXNfID4gbWF4KQogICAgICAgIHJldHVybiBOdW1iZXIobWF4KTsKICAgICAgcmV0dXJuIHRoaXNfOwogICAgfSwKICAgIGxlYWQ6IGZ1bmN0aW9uKHRoaXNfLCBsZW4sIGxlYWRDaGFyKXsKICAgICAgLy8gY29udmVydCB0byBzdHJpbmcgYW5kIGxlYWQgZmlyc3QgZGlnaXRzIGJ5IGxlYWRDaGFyCiAgICAgIHJldHVybiBTdHJpbmcodGhpc18pLnJlcGxhY2UoL1xkKy8sIGZ1bmN0aW9uKG51bWJlcil7CiAgICAgICAgLy8gc3Vic3RyYWN0IG51bWJlciBsZW5ndGggZnJvbSBkZXNpcmVkIGxlbmd0aCBjb252ZXJ0aW5nIGxlbiB0byBOdW1iZXIgYW5kIGluZGljYXRlcyBob3cgbXVjaCBsZWFkQ2hhcnMgd2UgbmVlZCB0byBhZGQKICAgICAgICAvLyBoZXJlIGlzIG5vIGlzTmFOKGxlbikgY2hlY2ssIGJlY2F1c2UgY29tcGFyYXRpb24gb2YgTmFOIGFuZCBhIE51bWJlciBpcyBhbHdheXMgZmFsc2UKICAgICAgICByZXR1cm4gKGxlbiAtPSBudW1iZXIubGVuZ3RoIC0gMSkgPiAxID8gbmV3IEFycmF5KGxlbikuam9pbihsZWFkQ2hhciB8fCAwKSArIG51bWJlciA6IG51bWJlcjsKICAgICAgfSk7CiAgICB9LAogICAgZ3JvdXA6IGZ1bmN0aW9uKHRoaXNfLCBsZW4sIHNwbGl0dGVyKXsKICAgICAgcmV0dXJuIFN0cmluZyh0aGlzXykucmVwbGFjZSgvXGQrLywgZnVuY3Rpb24obnVtYmVyKXsKICAgICAgICByZXR1cm4gbnVtYmVyLnJlcGxhY2UoL1xkL2csIGZ1bmN0aW9uKG0sIHBvcyl7CiAgICAgICAgICByZXR1cm4gIXBvcyArIChudW1iZXIubGVuZ3RoIC0gcG9zKSAlIChsZW4gfHwgMykgPyBtIDogKHNwbGl0dGVyIHx8ICcgJykgKyBtOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0sCiAgICBmb3JtYXQ6IGZ1bmN0aW9uKHRoaXNfLCBwcmVjLCBncywgcHJlZml4LCBwb3N0Zml4LCBjb21tYSl7CiAgICAgIHZhciByZXMgPSB0aGlzXy50b0ZpeGVkKHByZWMpOwogICAgICBpZiAoZ3MgfHwgY29tbWEpCiAgICAgICAgcmVzID0gcmVzLnJlcGxhY2UoLyhcZCspKFwuPykvLCBmdW5jdGlvbihtLCBudW1iZXIsIGMpewogICAgICAgICAgcmV0dXJuIChncyA/IGJhc2lzLm51bWJlci5ncm91cChOdW1iZXIobnVtYmVyKSwgMywgZ3MpIDogbnVtYmVyKSArIChjID8gY29tbWEgfHwgYyA6ICcnKTsKICAgICAgICB9KTsKICAgICAgaWYgKHByZWZpeCkKICAgICAgICByZXMgPSByZXMucmVwbGFjZSgvXi0/LywgJyQmJyArIChwcmVmaXggfHwgJycpKTsKICAgICAgcmV0dXJuIHJlcyArIChwb3N0Zml4IHx8ICcnKTsKICAgIH0KICB9OwoKCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAvLyBEYXRlIChvdGhlciBleHRlbnNpb25zICYgZml4ZXMgbW92ZWQgdG8gYmFzaXMuZGF0ZSkKICAvLwoKIC8qKgogICogQG5hbWVzcGFjZSBEYXRlCiAgKi8KCiAgY29tcGxldGUoRGF0ZSwgewogICAvKioKICAgICogUmV0dXJucyB0aGUgbWlsbGlzZWNvbmRzIGVsYXBzZWQgc2luY2UgMSBKYW51YXJ5IDE5NzAgMDA6MDA6MDAgVVRDIHVwIHVudGlsIG5vdyBhcyBhIG51bWJlci4KICAgICogV2hlbiB1c2luZyBub3cgdG8gY3JlYXRlIHRpbWVzdGFtcHMgb3IgdW5pcXVlIElEcywga2VlcCBpbiBtaW5kIHRoYXQgdGhlIHJlc29sdXRpb24gbWF5IGJlCiAgICAqIDE1IG1pbGxpc2Vjb25kcyBvbiBXaW5kb3dzLCBzbyB5b3UgY291bGQgZW5kIHVwIHdpdGggc2V2ZXJhbCBlcXVhbCB2YWx1ZXMgaWYgbm93IGlzIGNhbGxlZAogICAgKiBtdWx0aXBsZSB0aW1lcyB3aXRoaW4gYSBzaG9ydCB0aW1lIHNwYW4uCiAgICAqCiAgICAqIFRoaXMgbWV0aG9kIHdhcyBzdGFuZGFyZGl6ZWQgaW4gRUNNQS0yNjIgNXRoIGVkaXRpb24uCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBub3c6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBOdW1iZXIobmV3IERhdGUoKSk7CiAgICB9CiAgfSk7CgoKICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogIC8vIE1haW4gcGFydAogIC8vCgogLyoqCiAgKiBSb290IG5hbWVzcGFjZSBmb3IgYmFzaXMuanMgZnJhbWV3b3JrLgogICogQG5hbWVzcGFjZSBiYXNpcwogICovCgogLyoqCiAgKiBBdHRhY2ggZG9jdW1lbnQgcmVhZHkgaGFuZGxlcnMKICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gY2FsbGJhY2sKICAqIEBwYXJhbSB7Kn0gY29udGV4dCBDb250ZXh0IGZvciBoYW5kbGVyCiAgKi8KICB2YXIgcmVhZHkgPSAoZnVuY3Rpb24oKXsKICAgIC8vIE1hdHRoaWFzIE1pbGxlci9NYXJrIFd1YmJlbi9QYXVsIFNvd2Rlbi9EZWFuIEVkd2FyZHMvSm9obiBSZXNpZy9Sb21hbiBEdm9ybm92CgogICAgZnVuY3Rpb24gaXNSZWFkeSgpewogICAgICByZXR1cm4gZG9jdW1lbnQucmVhZHlTdGF0ZSA9PSAnY29tcGxldGUnICYmICEhZG9jdW1lbnQuYm9keTsKICAgIH0KCiAgICB2YXIgZmlyZWQgPSAhZG9jdW1lbnQgfHwgaXNSZWFkeSgpOwogICAgdmFyIGRlZmVycmVkSGFuZGxlcjsKCiAgICBmdW5jdGlvbiBydW5SZWFkeUhhbmRsZXIoaGFuZGxlcil7CiAgICAgIGhhbmRsZXIuY2FsbGJhY2suY2FsbChoYW5kbGVyLmNvbnRleHQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGZpcmVIYW5kbGVycygpewogICAgICBpZiAoaXNSZWFkeSgpKQogICAgICAgIGlmICghZmlyZWQrKykKICAgICAgICAgIHdoaWxlIChkZWZlcnJlZEhhbmRsZXIpCiAgICAgICAgICB7CiAgICAgICAgICAgIHJ1blJlYWR5SGFuZGxlcihkZWZlcnJlZEhhbmRsZXIpOwogICAgICAgICAgICBkZWZlcnJlZEhhbmRsZXIgPSBkZWZlcnJlZEhhbmRsZXIubmV4dDsKICAgICAgICAgIH0KICAgIH0KCiAgICAvLyBUaGUgRE9NIHJlYWR5IGNoZWNrIGZvciBJbnRlcm5ldCBFeHBsb3JlcgogICAgZnVuY3Rpb24gZG9TY3JvbGxDaGVjaygpewogICAgICB0cnkgewogICAgICAgIC8vIElmIElFIGlzIHVzZWQsIHVzZSB0aGUgdHJpY2sgYnkgRGllZ28gUGVyaW5pCiAgICAgICAgLy8gaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwoJ2xlZnQnKTsKICAgICAgICBmaXJlSGFuZGxlcnMoKTsKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgc2V0VGltZW91dChkb1Njcm9sbENoZWNrLCAxKTsKICAgICAgfQogICAgfQoKICAgIGlmICghZmlyZWQpCiAgICB7CiAgICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKQogICAgICB7CiAgICAgICAgLy8gdXNlIHRoZSByZWFsIGV2ZW50IGZvciBicm93c2VycyB0aGF0IHN1cHBvcnQgaXQgKGFsbCBtb2Rlcm4gYnJvd3NlcnMgc3VwcG9ydCBpdCkKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgZmlyZUhhbmRsZXJzLCBmYWxzZSk7CgogICAgICAgIC8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCiAgICAgICAgZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBmaXJlSGFuZGxlcnMsIGZhbHNlKTsKICAgICAgfQogICAgICBlbHNlCiAgICAgIHsKICAgICAgICAvLyBlbnN1cmUgZmlyaW5nIGJlZm9yZSBvbmxvYWQsCiAgICAgICAgLy8gbWF5YmUgbGF0ZSBidXQgc2FmZSBhbHNvIGZvciBpZnJhbWVzCiAgICAgICAgZG9jdW1lbnQuYXR0YWNoRXZlbnQoJ29ucmVhZHlzdGF0ZWNoYW5nZScsIGZpcmVIYW5kbGVycyk7CgogICAgICAgIC8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCiAgICAgICAgZ2xvYmFsLmF0dGFjaEV2ZW50KCdvbmxvYWQnLCBmaXJlSGFuZGxlcnMpOwoKICAgICAgICAvLyBJZiBJRSBhbmQgbm90IGEgZnJhbWUKICAgICAgICAvLyBjb250aW51YWxseSBjaGVjayB0byBzZWUgaWYgdGhlIGRvY3VtZW50IGlzIHJlYWR5CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGlmICghZ2xvYmFsLmZyYW1lRWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwpCiAgICAgICAgICAgIGRvU2Nyb2xsQ2hlY2soKTsKICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyByZXR1cm4gYXR0YWNoIGZ1bmN0aW9uCiAgICByZXR1cm4gZnVuY3Rpb24oY2FsbGJhY2ssIGNvbnRleHQpewogICAgICBpZiAoIWZpcmVkKQogICAgICB7CiAgICAgICAgZGVmZXJyZWRIYW5kbGVyID0gewogICAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICAgICAgY29udGV4dDogY29udGV4dCwKICAgICAgICAgIG5leHQ6IGRlZmVycmVkSGFuZGxlcgogICAgICAgIH07CiAgICAgIH0KICAgICAgZWxzZQogICAgICAgIHJ1blJlYWR5SGFuZGxlcih7CiAgICAgICAgICBjYWxsYmFjazogY2FsbGJhY2ssCiAgICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgICAgfSk7CiAgICB9OwogIH0pKCk7CgoKIC8qKgogICogRG9jdW1lbnQgaW50ZXJmYWNlIGZvciBzYWZlIGFkZC9yZW1vdmUgbm9kZXMgdG8vZnJvbSBoZWFkIGFuZCBib2R5LgogICovCiAgdmFyIGRvY3VtZW50SW50ZXJmYWNlID0gKGZ1bmN0aW9uKCl7CiAgICB2YXIgdGltZXI7CiAgICB2YXIgcmVmZXJlbmNlID0ge307CiAgICB2YXIgY2FsbGJhY2tzID0gewogICAgICBoZWFkOiBbXSwKICAgICAgYm9keTogW10KICAgIH07CgogICAgZnVuY3Rpb24gZ2V0UGFyZW50KG5hbWUpewogICAgICBpZiAoZG9jdW1lbnQgJiYgIXJlZmVyZW5jZVtuYW1lXSkKICAgICAgewogICAgICAgIHJlZmVyZW5jZVtuYW1lXSA9IGRvY3VtZW50W25hbWVdIHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKG5hbWUpWzBdOwoKICAgICAgICBpZiAocmVmZXJlbmNlW25hbWVdKQogICAgICAgIHsKICAgICAgICAgIHZhciBpdGVtcyA9IGNhbGxiYWNrc1tuYW1lXTsKICAgICAgICAgIGRlbGV0ZSBjYWxsYmFja3NbbmFtZV07CiAgICAgICAgICBmb3IgKHZhciBpID0gMCwgY2I7IGNiID0gaXRlbXNbaV07IGkrKykKICAgICAgICAgICAgY2JbMF0uY2FsbChjYlsxXSwgcmVmZXJlbmNlW25hbWVdKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiByZWZlcmVuY2VbbmFtZV07CiAgICB9CgogICAgZnVuY3Rpb24gYWRkKCl7CiAgICAgIHZhciBuYW1lID0gdGhpc1swXTsKICAgICAgdmFyIG5vZGUgPSB0aGlzWzFdOwogICAgICB2YXIgcmVmID0gdGhpc1syXTsKCiAgICAgIHJlbW92ZShub2RlKTsKCiAgICAgIHZhciBwYXJlbnQgPSBnZXRQYXJlbnQobmFtZSk7CiAgICAgIGlmIChwYXJlbnQpCiAgICAgIHsKICAgICAgICBpZiAocmVmID09PSB0cnVlKQogICAgICAgICAgcmVmID0gcGFyZW50LmZpcnN0Q2hpbGQ7CgogICAgICAgIGlmICghcmVmIHx8IHJlZi5wYXJlbnROb2RlICE9PSBwYXJlbnQpCiAgICAgICAgICByZWYgPSBudWxsOwoKICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHJlZik7CiAgICAgIH0KICAgICAgZWxzZQogICAgICAgIGNhbGxiYWNrc1tuYW1lXS5wdXNoKFthZGQsIFtuYW1lLCBub2RlLCByZWZdXSk7CiAgICB9CgogICAgZnVuY3Rpb24gZG9jUmVhZHkobmFtZSwgZm4sIGNvbnRleHQpewogICAgICBpZiAoY2FsbGJhY2tzW25hbWVdKQogICAgICAgIGNhbGxiYWNrc1tuYW1lXS5wdXNoKFtmbiwgY29udGV4dF0pOwogICAgICBlbHNlCiAgICAgICAgZm4uY2FsbChjb250ZXh0LCByZWZlcmVuY2VbbmFtZV0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlbW92ZShub2RlKXsKICAgICAgZm9yICh2YXIga2V5IGluIGNhbGxiYWNrcykKICAgICAgewogICAgICAgIHZhciBlbnRyeSA9IGFycmF5RnVuY3Rpb25zLnNlYXJjaChjYWxsYmFja3Nba2V5XSwgbm9kZSwgZnVuY3Rpb24oaXRlbSl7CiAgICAgICAgICByZXR1cm4gaXRlbVsxXSAmJiBpdGVtWzFdWzFdOwogICAgICAgIH0pOwoKICAgICAgICBpZiAoZW50cnkpCiAgICAgICAgICBhcnJheUZ1bmN0aW9ucy5yZW1vdmUoY2FsbGJhY2tzW2tleV0sIGVudHJ5KTsKICAgICAgfQoKICAgICAgaWYgKG5vZGUgJiYgbm9kZS5wYXJlbnROb2RlICYmIG5vZGUucGFyZW50Tm9kZS5ub2RlVHlwZSA9PSAxKQogICAgICAgIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjaGVja1BhcmVudHMoKXsKICAgICAgaWYgKHRpbWVyICYmIGdldFBhcmVudCgnaGVhZCcpICYmIGdldFBhcmVudCgnYm9keScpKQogICAgICAgIHRpbWVyID0gY2xlYXJJbnRlcnZhbCh0aW1lcik7CiAgICB9CgogICAgaWYgKGRvY3VtZW50ICYmICghZ2V0UGFyZW50KCdoZWFkJykgfHwgIWdldFBhcmVudCgnYm9keScpKSkKICAgIHsKICAgICAgdGltZXIgPSBzZXRJbnRlcnZhbChjaGVja1BhcmVudHMsIDUpOwogICAgICByZWFkeShjaGVja1BhcmVudHMpOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGhlYWQ6IHsKICAgICAgICByZWFkeTogZnVuY3Rpb24oZm4sIGNvbnRleHQpewogICAgICAgICAgZG9jUmVhZHkoJ2hlYWQnLCBmbiwgY29udGV4dCk7CiAgICAgICAgfSwKICAgICAgICBhZGQ6IGZ1bmN0aW9uKG5vZGUsIHJlZil7CiAgICAgICAgICBhZGQuY2FsbChbJ2hlYWQnLCBub2RlLCByZWZdKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGJvZHk6IHsKICAgICAgICByZWFkeTogZnVuY3Rpb24oZm4sIGNvbnRleHQpewogICAgICAgICAgZG9jUmVhZHkoJ2JvZHknLCBmbiwgY29udGV4dCk7CiAgICAgICAgfSwKICAgICAgICBhZGQ6IGZ1bmN0aW9uKG5vZGUsIHJlZil7CiAgICAgICAgICBhZGQuY2FsbChbJ2JvZHknLCBub2RlLCByZWZdKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHJlbW92ZTogcmVtb3ZlCiAgICB9OwogIH0pKCk7CgoKIC8qKgogICogQG5hbWVzcGFjZSBiYXNpcwogICovCgogLyoqCiAgKiBTaW5nbGV0b24gb2JqZWN0IHRvIGRlc3Ryb3kgcmVnaXN0cmVkIHZpYSB7YmFzaXMuY2xlYW5lci5hZGR9IG1ldGhvZCBvYmplY3RzIG9uIHBhZ2UgdW5sb2FkIGV2ZW50LgogICovCiAgdmFyIGNsZWFuZXIgPSAoZnVuY3Rpb24oKXsKICAgIHZhciBvYmplY3RzID0gW107CgogICAgZnVuY3Rpb24gZGVzdHJveShsb2cpewogICAgICAvKiogQGN1dCAqLyB2YXIgbG9nRGVzdHJveSA9IGxvZyAmJiB0eXBlb2YgbG9nID09ICdib29sZWFuJzsKICAgICAgcmVzdWx0Lmdsb2JhbERlc3Ryb3kgPSB0cnVlOwogICAgICByZXN1bHQuYWRkID0gJHVuZGVmOwogICAgICByZXN1bHQucmVtb3ZlID0gJHVuZGVmOwoKICAgICAgdmFyIG9iamVjdDsKICAgICAgd2hpbGUgKG9iamVjdCA9IG9iamVjdHMucG9wKCkpCiAgICAgIHsKICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5kZXN0cm95ID09ICdmdW5jdGlvbicpCiAgICAgICAgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLyoqIEBjdXQgKi8gaWYgKGxvZ0Rlc3Ryb3kpIGNvbnNvbGVNZXRob2RzLmxvZygnZGVzdHJveScsICdbJyArIFN0cmluZyhvYmplY3QuY2xhc3NOYW1lKSArICddJywgb2JqZWN0KTsKICAgICAgICAgICAgb2JqZWN0LmRlc3Ryb3koKTsKICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAvKiogQGN1dCAqLyBjb25zb2xlTWV0aG9kcy53YXJuKFN0cmluZyhvYmplY3QpLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gb2JqZWN0KQogICAgICAgICAgICBvYmplY3RbcHJvcF0gPSBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgICBvYmplY3RzLmxlbmd0aCA9IDA7CiAgICB9CgogICAgaWYgKCdhdHRhY2hFdmVudCcgaW4gZ2xvYmFsKQogICAgICBnbG9iYWwuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgZGVzdHJveSk7CiAgICBlbHNlCiAgICAgIGlmICgnYWRkRXZlbnRMaXN0ZW5lcicgaW4gZ2xvYmFsKQogICAgICAgIGdsb2JhbC5hZGRFdmVudExpc3RlbmVyKCd1bmxvYWQnLCBkZXN0cm95LCBmYWxzZSk7CiAgICAgIGVsc2UKICAgICAgICByZXR1cm4gewogICAgICAgICAgYWRkOiAkdW5kZWYsCiAgICAgICAgICByZW1vdmU6ICR1bmRlZgogICAgICAgIH07CgogICAgdmFyIHJlc3VsdCA9IHsKICAgICAgYWRkOiBmdW5jdGlvbihvYmplY3QpewogICAgICAgIGlmIChvYmplY3QgIT0gbnVsbCkKICAgICAgICAgIG9iamVjdHMucHVzaChvYmplY3QpOwogICAgICB9LAogICAgICByZW1vdmU6IGZ1bmN0aW9uKG9iamVjdCl7CiAgICAgICAgYXJyYXlGdW5jdGlvbnMucmVtb3ZlKG9iamVjdHMsIG9iamVjdCk7CiAgICAgIH0KICAgIH07CgogICAgLy8gZm9yIGRlYnVnIHB1cnBvc2VzCiAgICAvKiogQGN1dCAqLyByZXN1bHQuZGVzdHJveV8gPSBkZXN0cm95OwogICAgLyoqIEBjdXQgKi8gcmVzdWx0Lm9iamVjdHNfID0gb2JqZWN0czsKCiAgICByZXR1cm4gcmVzdWx0OwogIH0pKCk7CgoKICAvLwogIC8vIENTUyByZXNvdXJjZQogIC8vCgogIHZhciBDc3NSZXNvdXJjZSA9IChmdW5jdGlvbigpewogICAgLy8gVGVzdCBmb3IgYXBwZW5kQ2hpbGQgYnVncyAob2xkIElFIGJyb3dzZXJzIGhhcyBhIHByb2JsZW0gd2l0aCBhcHBlbmQgdGV4dE5vZGUgaW50byA8c3R5bGU+KQogICAgdmFyIFNUWUxFX0FQUEVORF9CVUdHWSA9IChmdW5jdGlvbigpewogICAgICB0cnkgewogICAgICAgIHJldHVybiAhZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKS5hcHBlbmRDaGlsZCgKICAgICAgICAgIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcnKQogICAgICAgICk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9KSgpOwoKCiAgIC8qKgogICAgKiBIZWxwZXIgZnVuY3Rpb25zIGZvciBwYXRoIHJlc29sdmluZwogICAgKi8KICAgIHZhciBiYXNlRWwgPSBkb2N1bWVudCAmJiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdiYXNlJyk7CgogICAgZnVuY3Rpb24gc2V0QmFzZShiYXNlVVJJKXsKICAgICAgLy8gT3BlcmEgYW5kIElFIGRvZXNuJ3QgcmVzb2x2ZSBwYXRoZXMgY29ycmVjdGx5LCBpZiBiYXNlIGhyZWYgaXMgbm90IGFuIGFic29sdXRlIHBhdGgKICAgICAgLy8gY29udmVydCBwYXRoIHRvIGFic29sdXRlIHZhbHVlCiAgICAgIGJhc2VFbC5zZXRBdHRyaWJ1dGUoJ2hyZWYnLCBiYXNlVVJJKTsKCiAgICAgIC8vIGlmIG1vcmUgdGhhbiBvbmUgPGJhc2U+IGVsZW1lbnRzIGluIGRvY3VtZW50LCBvbmx5IGZpcnN0IGhhcyBlZmZlY3QKICAgICAgLy8gcHV0IG91ciA8YmFzZT4gcmVzb2x2ZXIgYXQgdGhlIGJlZ2luaW5nIG9mIDxoZWFkPgogICAgICBkb2N1bWVudEludGVyZmFjZS5oZWFkLmFkZChiYXNlRWwsIHRydWUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHJlc3RvcmVCYXNlKCl7CiAgICAgIC8vIE9wZXJhIGxlZnQgZG9jdW1lbnQgYmFzZSBhcyA8YmFzZT4gZWxlbWVudCBzcGVjaWZpZWQsCiAgICAgIC8vIGV2ZW4gaWYgdGhpcyBlbGVtZW50IGlzIHJlbW92ZWQgZnJvbSBkb2N1bWVudAogICAgICAvLyBzbyB3ZSBzZXQgY3VycmVudCBsb2NhdGlvbiBmb3IgYmFzZQogICAgICBiYXNlRWwuc2V0QXR0cmlidXRlKCdocmVmJywgbG9jYXRpb24uaHJlZik7CgogICAgICBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUoYmFzZUVsKTsKICAgIH0KCiAgICAvLyBpbmplY3Qgc3R5bGUgaW50byBkb2N1bWVudAogICAgZnVuY3Rpb24gaW5qZWN0U3R5bGVUb0hlYWQoKXsKICAgICAgLy8gc2V0IGJhc2UgYmVmb3JlIDxzdHlsZT4gZWxlbWVudCBjcmVhdGluZywgYmVjYXVzZSBJRTkrIHNldCBiYXNlVVJJCiAgICAgIC8vIGZvciA8c3R5bGU+IGVsZW1lbnQgb24gZWxlbWVudCBjcmVhdGlvbgogICAgICBzZXRCYXNlKHRoaXMuYmFzZVVSSSk7CgogICAgICAvLyBjcmVhdGUgPHN0eWxlPiBlbGVtZW50IGZvciBmaXJzdCB0aW1lCiAgICAgIGlmICghdGhpcy5lbGVtZW50KQogICAgICB7CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKCiAgICAgICAgaWYgKCFTVFlMRV9BUFBFTkRfQlVHR1kpCiAgICAgICAgICB0aGlzLmVsZW1lbnQuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJycpKTsKCiAgICAgICAgLyoqIEBjdXQgKi8gdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSgnc3JjJywgdGhpcy51cmwpOwogICAgICB9CgogICAgICAvLyBhZGQgZWxlbWVudCB0byBkb2N1bWVudAogICAgICBkb2N1bWVudEludGVyZmFjZS5oZWFkLmFkZCh0aGlzLmVsZW1lbnQpOwoKICAgICAgLy8gc2V0IGNzcyB0ZXh0IGFmdGVyIG5vZGUgaW5zZXJ0ZWQgaW50byBkb2N1bWVudCwKICAgICAgLy8gSUU4IGFuZCBsb3dlciBjcmFzaCBvdGhlcndpc2UgKHRoaXMuZWxlbWVudC5zdHlsZVNoZWV0IGlzIG5vdCBkZWZpbmVkKQogICAgICB0aGlzLnN5bmNDc3NUZXh0KCk7CgogICAgICByZXN0b3JlQmFzZSgpOwogICAgfQoKCiAgIC8qKgogICAgKiBAY2xhc3MKICAgICovCiAgICByZXR1cm4gQ2xhc3MobnVsbCwgewogICAgICBjbGFzc05hbWU6ICdiYXNpcy5Dc3NSZXNvdXJjZScsCgogICAgICBpblVzZTogMCwKCiAgICAgIHVybDogJycsCiAgICAgIGJhc2VVUkk6ICcnLAogICAgICBjc3NUZXh0OiB1bmRlZmluZWQsCgogICAgICBlbGVtZW50OiBudWxsLAoKICAgICAgaW5pdDogZnVuY3Rpb24odXJsKXsKICAgICAgICB0aGlzLnVybCA9IHVybDsKICAgICAgICB0aGlzLmJhc2VVUkkgPSBwYXRoVXRpbHMuZGlybmFtZSh1cmwpICsgJy8nOwogICAgICB9LAoKICAgICAgdXBkYXRlQ3NzVGV4dDogZnVuY3Rpb24oY3NzVGV4dCl7CiAgICAgICAgaWYgKHRoaXMuY3NzVGV4dCAhPSBjc3NUZXh0KQogICAgICAgIHsKICAgICAgICAgIHRoaXMuY3NzVGV4dCA9IGNzc1RleHQ7CgogICAgICAgICAgaWYgKHRoaXMuaW5Vc2UgJiYgdGhpcy5lbGVtZW50KQogICAgICAgICAgewogICAgICAgICAgICBzZXRCYXNlKHRoaXMuYmFzZVVSSSk7CiAgICAgICAgICAgIHRoaXMuc3luY0Nzc1RleHQoKTsKICAgICAgICAgICAgcmVzdG9yZUJhc2UoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCgogICAgICBzeW5jQ3NzVGV4dDogU1RZTEVfQVBQRU5EX0JVR0dZCiAgICAgICAgLy8gb2xkIElFCiAgICAgICAgPyBmdW5jdGlvbigpewogICAgICAgICAgICB0aGlzLmVsZW1lbnQuc3R5bGVTaGVldC5jc3NUZXh0ID0gdGhpcy5jc3NUZXh0OwogICAgICAgICAgfQogICAgICAgIC8vIFczQyBicm93c2VycwogICAgICAgIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIGNzc1RleHQgPSB0aGlzLmNzc1RleHQ7CgogICAgICAgICAgICAvKiogQGN1dCBhZGQgc291cmNlIHVybCBmb3IgZGVidWcgKi8KICAgICAgICAgICAgLyoqIEBjdXQgKi8gY3NzVGV4dCArPSAnXG4vKiMgc291cmNlVVJMPScgKyBwYXRoVXRpbHMub3JpZ2luICsgdGhpcy51cmwgKyAnICovJzsKCiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5maXJzdENoaWxkLm5vZGVWYWx1ZSA9IGNzc1RleHQ7CiAgICAgICAgICB9LAoKICAgICAgc3RhcnRVc2U6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKCF0aGlzLmluVXNlKQogICAgICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5yZWFkeShpbmplY3RTdHlsZVRvSGVhZCwgdGhpcyk7CgogICAgICAgIHRoaXMuaW5Vc2UgKz0gMTsKICAgICAgfSwKCiAgICAgIHN0b3BVc2U6IGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKHRoaXMuaW5Vc2UpCiAgICAgICAgewogICAgICAgICAgLy8gZGVjcmVhc2UgdXNhZ2UgY291bnQKICAgICAgICAgIHRoaXMuaW5Vc2UgLT0gMTsKCiAgICAgICAgICAvLyByZW1vdmUgZWxlbWVudCBpZiBub2JvZHkgdXNlIGl0CiAgICAgICAgICBpZiAoIXRoaXMuaW5Vc2UgJiYgdGhpcy5lbGVtZW50KQogICAgICAgICAgICBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUodGhpcy5lbGVtZW50KTsKICAgICAgICB9CiAgICAgIH0sCgogICAgICBkZXN0cm95OiBmdW5jdGlvbigpewogICAgICAgIGlmICh0aGlzLmVsZW1lbnQpCiAgICAgICAgICBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUodGhpcy5lbGVtZW50KTsKCiAgICAgICAgdGhpcy5lbGVtZW50ID0gbnVsbDsKICAgICAgICB0aGlzLmNzc1RleHQgPSBudWxsOwogICAgICB9CiAgICB9KTsKICB9KSgpOwoKCiAgLy8KICAvLyBleHBvcnQgbmFtZXMKICAvLwoKICAvLyBjcmVhdGUgYW5kIGV4dGVuZCBiYXNpcyBuYW1lc3BhY2UKICB2YXIgYmFzaXMgPSBnZXROYW1lc3BhY2UoJ2Jhc2lzJykuZXh0ZW5kKHsKICAgIC8qKiBAY3V0ICovIGZpbGVuYW1lXzogYmFzaXNGaWxlbmFtZSwKICAgIC8qKiBAY3V0ICovIHByb2Nlc3NDb25maWc6IHByb2Nlc3NDb25maWcsCgogICAgLy8gcHJvcGVydGllcyBhbmQgc2V0dGluZ3MKICAgIHZlcnNpb246IFZFUlNJT04sCgogICAgLy8gY29uZmlnIGFuZCBlbnZpcm9ubWVudAogICAgTk9ERV9FTlY6IE5PREVfRU5WLAogICAgY29uZmlnOiBjb25maWcsCiAgICBjcmVhdGVTYW5kYm94OiBmdW5jdGlvbihjb25maWcpewogICAgICByZXR1cm4gY3JlYXRlQmFzaXNJbnN0YW5jZSgKICAgICAgICBnbG9iYWwsCiAgICAgICAgYmFzaXNGaWxlbmFtZSwKICAgICAgICBjb21wbGV0ZSh7IG5vQ29uZmxpY3Q6IHRydWUgfSwgY29uZmlnKQogICAgICApOwogICAgfSwKCiAgICAvLyBtb2R1bGFyaXR5CiAgICByZXNvbHZlTlNGaWxlbmFtZTogcmVzb2x2ZU5TRmlsZW5hbWUsCiAgICBwYXRjaDogcGF0Y2gsCiAgICBuYW1lc3BhY2U6IGdldE5hbWVzcGFjZSwKICAgIHJlcXVpcmU6IHJlcXVpcmVOYW1lc3BhY2UsCiAgICByZXNvdXJjZTogZ2V0UmVzb3VyY2UsCiAgICBhc3NldDogZnVuY3Rpb24odXJsKXsgICAvLyBOT1RFOiBkb24ndCByZXBsYWNlIGZvciAkc2VsZiwgYnVpbGRlciBhdHRhY2gKICAgICAgcmV0dXJuIHVybDsgICAgICAgICAgIC8vIHNwZWNpYWwgaGFuZGxlciBmb3IgdGhpcyBmdW5jdGlvbgogICAgfSwKCiAgICAvLyB0aW1lcnMKICAgIHNldEltbWVkaWF0ZTogc2V0SW1tZWRpYXRlLAogICAgY2xlYXJJbW1lZGlhdGU6IGNsZWFySW1tZWRpYXRlLAogICAgbmV4dFRpY2s6IGZ1bmN0aW9uKCl7CiAgICAgIHNldEltbWVkaWF0ZS5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBjbGFzc2VzCiAgICBDbGFzczogQ2xhc3MsCiAgICBUb2tlbjogVG9rZW4sCiAgICBEZWZlcnJlZFRva2VuOiBEZWZlcnJlZFRva2VuLAoKICAgIC8vIHV0aWwgZnVuY3Rpb25zCiAgICBnZW5VSUQ6IGdlblVJRCwKICAgIGdldHRlcjogZ2V0dGVyLAogICAgcmVhZHk6IHJlYWR5LAoKICAgIGNsZWFuZXI6IGNsZWFuZXIsCiAgICBjb25zb2xlOiBjb25zb2xlTWV0aG9kcywKICAgIHBhdGg6IHBhdGhVdGlscywKICAgIGRvYzogZG9jdW1lbnRJbnRlcmZhY2UsCgogICAgb2JqZWN0OiB7CiAgICAgIGV4dGVuZDogZXh0ZW5kLAogICAgICBjb21wbGV0ZTogY29tcGxldGUsCiAgICAgIGtleXM6IGtleXMsCiAgICAgIHZhbHVlczogdmFsdWVzLAogICAgICBzbGljZTogc2xpY2UsCiAgICAgIHNwbGljZTogc3BsaWNlLAogICAgICBtZXJnZTogbWVyZ2UsCiAgICAgIGl0ZXJhdGU6IGl0ZXJhdGUKICAgIH0sCiAgICBmbjogewogICAgICAvLyB0ZXN0IGZ1bmN0aW9ucwogICAgICAkdW5kZWZpbmVkOiAkdW5kZWZpbmVkLAogICAgICAkZGVmaW5lZDogJGRlZmluZWQsCiAgICAgICRpc051bGw6ICRpc051bGwsCiAgICAgICRpc05vdE51bGw6ICRpc05vdE51bGwsCiAgICAgICRpc1NhbWU6ICRpc1NhbWUsCiAgICAgICRpc05vdFNhbWU6ICRpc05vdFNhbWUsCgogICAgICAvLyBnYWcgZnVuY3Rpb25zCiAgICAgICRzZWxmOiAkc2VsZiwKICAgICAgJGNvbnN0OiAkY29uc3QsCiAgICAgICRmYWxzZTogJGZhbHNlLAogICAgICAkdHJ1ZTogJHRydWUsCiAgICAgICRudWxsOiAkbnVsbCwKICAgICAgJHVuZGVmOiAkdW5kZWYsCgogICAgICAvLyBnZXR0ZXJzIGFuZCBtb2RpZmljYXRvcnMKICAgICAgZ2V0dGVyOiBnZXR0ZXIsCiAgICAgIG51bGxHZXR0ZXI6IG51bGxHZXR0ZXIsCiAgICAgIHdyYXBwZXI6IHdyYXBwZXIsCgogICAgICAvLyBsYXp5CiAgICAgIGxhenlJbml0OiBsYXp5SW5pdCwKICAgICAgbGF6eUluaXRBbmRSdW46IGxhenlJbml0QW5kUnVuLAogICAgICBydW5PbmNlOiBydW5PbmNlCiAgICB9LAogICAgYXJyYXk6IGV4dGVuZChhcnJheUZyb20sIGFycmF5RnVuY3Rpb25zKSwKICAgIHN0cmluZzogc3RyaW5nRnVuY3Rpb25zLAogICAgbnVtYmVyOiBudW1iZXJGdW5jdGlvbnMsCiAgICBib29sOiB7CiAgICAgIGludmVydDogZnVuY3Rpb24odmFsdWUpewogICAgICAgIHJldHVybiAhdmFsdWU7CiAgICAgIH0KICAgIH0sCiAgICBqc29uOiB7CiAgICAgIHBhcnNlOiB0eXBlb2YgSlNPTiAhPSAndW5kZWZpbmVkJwogICAgICAgID8gSlNPTi5wYXJzZQogICAgICAgIDogZnVuY3Rpb24oc3RyKXsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZ0Z1bmN0aW9ucy50b09iamVjdChzdHIsIHRydWUpOwogICAgICAgICAgfQogICAgfQogIH0pOwoKICAvLyBhZGQgZGV2IG5hbWVzcGFjZSwgaG9zdCBmb3Igc3BlY2lhbCBmdW5jdGlvbmFsaXR5IGluIGRldmVsb3BtZW50IGVudmlyb25tZW50CiAgZ2V0TmFtZXNwYWNlKCdiYXNpcy5kZXYnKS5leHRlbmQoY29uc29sZU1ldGhvZHMpOwoKCiAgLy8KICAvLyBhdXRvIGxvYWQgc2VjdGlvbgogIC8vCgogIGlmIChjb25maWcuYXV0b2xvYWQpCiAgICBjb25maWcuYXV0b2xvYWQuZm9yRWFjaChmdW5jdGlvbihuYW1lKXsKICAgICAgcmVxdWlyZU5hbWVzcGFjZShuYW1lKTsKICAgIH0pOwoKCiAgLy8KICAvLyByZXR1cm4gYmFzaXMgaW5zdGFuY2UgKG5lZWRzIGZvciBjcmVhdGVTYW5kYm94KQogIC8vCgogIHJldHVybiBiYXNpczsKCn0pKHRoaXMpOwo=",
                "body": "LyoKICBCYXNpcyBqYXZhc2NyaXB0IGxpYnJhcnkKICBodHRwOi8vZ2l0aHViLmNvbS9iYXNpc2pzL2Jhc2lzanMKKi8KCi8qKgogKiBAYW5ub3RhdGlvbgogKiBCYXNpcyBsaWJyYXJ5IGNvcmUgbW9kdWxlLiBJdCBwcm92aWRlcyB2YXJpb3VzIG1vc3QgdXNpbmcgZnVuY3Rpb25zLAogKiBjbGFzc2VzIGFuZCBmdW5jdGlvbmFsaXR5LgogKgogKiBUaGlzIGZpbGUgc2hvdWxkIGJlIGxvYWRlZCBmaXJzdC4KICoKICogQ29udGVudCBvdmVydmlldzoKICogLSB1dGlsIGZ1bmN0aW9ucwogKiAtIGJhc2lzLmdldHRlcgogKiAtIGNvbnNvbGUgbWV0aG9kIHdyYXBwZXJzIChiYXNpcy5kZXYpCiAqIC0gdGltZXIgZnVuY3Rpb25zIChiYXNpcy5zZXRJbW1lZGlhdGUsIGJhc2lzLmNsZWFySW1tZWRpYXRlLCBiYXNpcy5uZXh0VGljaykKICogLSBwYXRoIHV0aWxzIChiYXNpcy5wYXRoKQogKiAtIHByb2Nlc3MgY29uZmlnIChiYXNpcy5jb25maWcpCiAqIC0gYmFzaXMubmFtZXNwYWNlCiAqIC0gYmFzaXMuQ2xhc3MgbmFtZXNwYWNlIChwcm92aWRlcyBpbmhlcml0YW5jZSkKICogLSBiYXNpcy5Ub2tlbgogKiAtIGJhc2lzLnJlc291cmNlCiAqIC0gYmFzaXMucmVxdWlyZQogKiAtIHBvbHlmaWxscyBmb3IgYEZ1bmN0aW9uI2JpbmRgLCBgQXJyYXkuaXNBcnJheWAsIGBBcnJheSNpbmRleE9mYCwgYEFycmF5I2xhc3RJbmRleE9mYCwgYEFycmF5I2ZvckVhY2hgLCBgQXJyYXkjbWFwYCwgYEFycmF5I2ZpbHRlcmAsIGBBcnJheSNzb21lYCwgYEFycmF5I2V2ZXJ5YCwgYEFycmF5I3JlZHVjZWAsIGBTdHJpbmcjdHJpbWAsIGBEYXRlI25vd2AKICogLSBmdW5jdGlvbiB0byB3b3JrIHdpdGggcHJpbWl0aXZlcwogKiAgIC0gRnVuY3Rpb24KICogICAtIEFycmF5CiAqICAgLSBTdHJpbmcKICogICAtIE51bWJlcgogKiAtIGJhc2lzLnJlYWR5CiAqIC0gYXN5bmMgZG9jdW1lbnQgaW10ZXJmYWNlIChiYXNpcy5kb2MpCiAqIC0gYmFzaXMuY2xlYW5lcgogKi8KCi8vIGdsb2JhbCBpcyBjdXJyZW50IGNvbnRleHQgKGB3aW5kb3dgIGluIGJyb3dzZXIgYW5kIGBnbG9iYWxgIG9uIG5vZGUuanMpCjsoZnVuY3Rpb24gY3JlYXRlQmFzaXNJbnN0YW5jZShnbG9iYWwsIF9fYmFzaXNGaWxlbmFtZSwgX19jb25maWcpewogICd1c2Ugc3RyaWN0JzsKCiAgdmFyIFZFUlNJT04gPSAnMS4zLjMnOwoKICB2YXIgZG9jdW1lbnQgPSBnbG9iYWwuZG9jdW1lbnQ7CiAgdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKCgogLyoqCiAgKiBHZW5lcmF0ZXMgdW5pcXVlIGlkIChtaXggZGF0ZXRpbWUgYW5kIHJhbmRvbSkuCiAgKiBAcGFyYW0ge251bWJlcj19IGxlbiBSZXF1aXJlZCBsZW5ndGggb2YgaWQgKDE2IGJ5IGRlZmF1bHQpLgogICogQHJldHVybnMge3N0cmluZ30gR2VuZXJhdGVkIGlkLgogICovCiAgZnVuY3Rpb24gZ2VuVUlEKGxlbil7CiAgICBmdW5jdGlvbiBiYXNlMzYodmFsKXsKICAgICAgcmV0dXJuIE1hdGgucm91bmQodmFsKS50b1N0cmluZygzNik7CiAgICB9CgogICAgLy8gdWlkIHNob3VsZCBzdGFydHMgd2l0aCBhbHBoYQogICAgdmFyIHJlc3VsdCA9IGJhc2UzNigxMCArIDI1ICogTWF0aC5yYW5kb20oKSk7CgogICAgaWYgKCFsZW4pCiAgICAgIGxlbiA9IDE2OwoKICAgIHdoaWxlIChyZXN1bHQubGVuZ3RoIDwgbGVuKQogICAgICByZXN1bHQgKz0gYmFzZTM2KG5ldyBEYXRlICogTWF0aC5yYW5kb20oKSk7CgogICAgcmV0dXJuIHJlc3VsdC5zdWJzdHIoMCwgbGVuKTsKICB9CgoKIC8qKgogICogQ29weSBhbGwgcHJvcGVydGllcyBmcm9tIHNvdXJjZSAob2JqZWN0KSB0byBkZXN0aW5hdGlvbiBvYmplY3QuCiAgKiBAcGFyYW0ge29iamVjdH0gZGVzdCBPYmplY3Qgc2hvdWxkIGJlIGV4dGVuZGVkLgogICogQHBhcmFtIHtvYmplY3R9IHNvdXJjZQogICogQHJldHVybiB7b2JqZWN0fSBEZXN0aW5hdGlvbiBvYmplY3QuCiAgKi8KICBmdW5jdGlvbiBleHRlbmQoZGVzdCwgc291cmNlKXsKICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpCiAgICAgIGRlc3Rba2V5XSA9IHNvdXJjZVtrZXldOwoKICAgIHJldHVybiBkZXN0OwogIH0KCiAvKioKICAqIENvcHkgb25seSBtaXNzZWQgcHJvcGVydGllcyBmcm9tIHNvdXJjZSAob2JqZWN0KSB0byBvYmplY3QuCiAgKiBAcGFyYW0ge29iamVjdH0gZGVzdCBPYmplY3Qgc2hvdWxkIGJlIGNvbXBsZXRlZC4KICAqIEBwYXJhbSB7b2JqZWN0fSBzb3VyY2UKICAqIEByZXR1cm4ge29iamVjdH0gRGVzdGluYXRpb24gb2JqZWN0LgogICovCiAgZnVuY3Rpb24gY29tcGxldGUoZGVzdCwgc291cmNlKXsKICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpCiAgICAgIGlmIChrZXkgaW4gZGVzdCA9PSBmYWxzZSkKICAgICAgICBkZXN0W2tleV0gPSBzb3VyY2Vba2V5XTsKCiAgICByZXR1cm4gZGVzdDsKICB9CgogLyoqCiAgKiBSZXR1cm5zIGFsbCBwcm9wZXJ0eSBuYW1lcyBvZiBvYmplY3QuCiAgKiBAcGFyYW0ge29iamVjdH0gb2JqZWN0IEFueSBvYmplY3QgY2FuIGhhcyBwcm9wZXJ0aWVzLgogICogQHJldHVybiB7QXJyYXkuPHN0cmluZz59CiAgKi8KICBmdW5jdGlvbiBrZXlzKG9iamVjdCl7CiAgICB2YXIgcmVzdWx0ID0gW107CgogICAgZm9yICh2YXIga2V5IGluIG9iamVjdCkKICAgICAgcmVzdWx0LnB1c2goa2V5KTsKCiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAvKioKICAqIFJldHVybnMgYWxsIHByb3BlcnR5IHZhbHVlcyBvZiBvYmplY3QuCiAgKiBAcGFyYW0ge29iamVjdH0gb2JqZWN0IEFueSBvYmplY3QgY2FuIGhhcyBwcm9wZXJ0aWVzLgogICogQHJldHVybiB7QXJyYXkuPG9iamVjdD59CiAgKi8KICBmdW5jdGlvbiB2YWx1ZXMob2JqZWN0KXsKICAgIHZhciByZXN1bHQgPSBbXTsKCiAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KQogICAgICByZXN1bHQucHVzaChvYmplY3Rba2V5XSk7CgogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogLyoqCiAgKiBDcmVhdGVzIGEgc2xpY2Ugb2Ygc291cmNlIG9iamVjdC4KICAqIEBwYXJhbSB7b2JqZWN0fSBzb3VyY2UgQW55IG9iamVjdCBjYW4gaGFzIHByb3BlcnRpZXMuCiAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmc+fSBrZXlzIERlc2lyZWQga2V5IHNldC4KICAqIEByZXR1cm4ge29iamVjdH0gTmV3IG9iamVjdCB3aXRoIGRlc2lyZWQga2V5cyBmcm9tIHNvdXJjZSBvYmplY3QuCiAgKi8KICBmdW5jdGlvbiBzbGljZShzb3VyY2UsIGtleXMpewogICAgdmFyIHJlc3VsdCA9IHt9OwoKICAgIGlmICgha2V5cykKICAgICAgcmV0dXJuIGV4dGVuZChyZXN1bHQsIHNvdXJjZSk7CgogICAgZm9yICh2YXIgaSA9IDAsIGtleTsga2V5ID0ga2V5c1tpKytdOykKICAgICAgaWYgKGtleSBpbiBzb3VyY2UpCiAgICAgICAgcmVzdWx0W2tleV0gPSBzb3VyY2Vba2V5XTsKCiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAvKioKICAqIENyZWF0ZXMgYSBzbGljZSBvZiBzb3VyY2Ugb2JqZWN0IGFuZCBkZWxldGUga2V5cyBmcm9tIHNvdXJjZS4KICAqIEBwYXJhbSB7b2JqZWN0fSBzb3VyY2UgQW55IG9iamVjdCBjYW4gaGFzIHByb3BlcnRpZXMuCiAgKiBAcGFyYW0ge0FycmF5LjxzdHJpbmc+fSBrZXlzIERlc2lyZWQga2V5IHNldC4KICAqIEByZXR1cm4ge29iamVjdH0gTmV3IG9iamVjdCB3aXRoIGRlc2lyZWQga2V5cyBmcm9tIHNvdXJjZSBvYmplY3QuCiAgKiBUT0RPOiBmaXggY2FzZSB3aGVuIGtleXMgaXMgbm90IHBhc3NlZDsgaXQgcmV0dXJucyBjb3B5IG9mIHNvdXJjZSwKICAqICAgICAgIGJ1dCBkb2Vzbid0IGRlbGV0ZSBhbnl0aGluZyAoc291cmNlIHNob3VsZCBiZWNvbWUgZW1wdHkgb2JqZWN0KQogICovCiAgZnVuY3Rpb24gc3BsaWNlKHNvdXJjZSwga2V5cyl7CiAgICB2YXIgcmVzdWx0ID0ge307CgogICAgaWYgKCFrZXlzKQogICAgICByZXR1cm4gZXh0ZW5kKHJlc3VsdCwgc291cmNlKTsKCiAgICBmb3IgKHZhciBpID0gMCwga2V5OyBrZXkgPSBrZXlzW2krK107KQogICAgICBpZiAoa2V5IGluIHNvdXJjZSkKICAgICAgewogICAgICAgIHJlc3VsdFtrZXldID0gc291cmNlW2tleV07CiAgICAgICAgZGVsZXRlIHNvdXJjZVtrZXldOwogICAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogLyoqCiAgKiBNZXJnZSBzZXZlcmFsIG9iamVjdHMgaW50byBuZXcgb2JqZWN0IGFuZCByZXR1cm5zIGl0LgogICogQHBhcmFtIHsuLi4qfSBhcmdzCiAgKiBAcmV0dXJuIHtvYmplY3R9CiAgKi8KICBmdW5jdGlvbiBtZXJnZSgvKiBvYmoxIC4uIG9iak4gKi8pewogICAgdmFyIHJlc3VsdCA9IHt9OwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKQogICAgICBleHRlbmQocmVzdWx0LCBhcmd1bWVudHNbaV0pOwoKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKIC8qKgogICogUmV0dXJucyBsaXN0IG9mIGNhbGxiYWNrIGNhbGwgcmVzdWx0IGZvciBldmVyeSBvYmplY3QncyBrZXktdmFsdWUgcGFpci4KICAqIEBwYXJhbSB7b2JqZWN0fSBvYmplY3QgQW55IG9iamVjdCBjYW4gaGFzIHByb3BlcnRpZXMuCiAgKiBAcGFyYW0ge2Z1bmN0aW9uKGtleSwgdmFsdWUpfSBjYWxsYmFjawogICogQHBhcmFtIHsqPX0gdGhpc09iamVjdAogICogQHJldHVybiB7QXJyYXkuPCo+fQogICovCiAgZnVuY3Rpb24gaXRlcmF0ZShvYmplY3QsIGNhbGxiYWNrLCB0aGlzT2JqZWN0KXsKICAgIHZhciByZXN1bHQgPSBbXTsKCiAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KQogICAgICByZXN1bHQucHVzaChjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIGtleSwgb2JqZWN0W2tleV0pKTsKCiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAvKioKICAqIEBwYXJhbSB7Kn0gdmFsdWUKICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB2YWx1ZSBpcyB1bmRlZmluZWQuCiAgKi8KICBmdW5jdGlvbiAkdW5kZWZpbmVkKHZhbHVlKXsKICAgIHJldHVybiB2YWx1ZSA9PSB1bmRlZmluZWQ7CiAgfQoKIC8qKgogICogQHBhcmFtIHsqfSB2YWx1ZQogICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHZhbHVlIGlzIG5vdCB1bmRlZmluZWQuCiAgKi8KICBmdW5jdGlvbiAkZGVmaW5lZCh2YWx1ZSl7CiAgICByZXR1cm4gdmFsdWUgIT0gdW5kZWZpbmVkOwogIH0KCiAvKioKICAqIEBwYXJhbSB7Kn0gdmFsdWUKICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB2YWx1ZSBpcyBudWxsLgogICovCiAgZnVuY3Rpb24gJGlzTnVsbCh2YWx1ZSl7CiAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB2YWx1ZSA9PSB1bmRlZmluZWQ7CiAgfQoKIC8qKgogICogQHBhcmFtIHsqfSB2YWx1ZQogICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHZhbHVlIGlzIG5vdCBudWxsLgogICovCiAgZnVuY3Rpb24gJGlzTm90TnVsbCh2YWx1ZSl7CiAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB2YWx1ZSAhPSB1bmRlZmluZWQ7CiAgfQoKIC8qKgogICogQHBhcmFtIHsqfSB2YWx1ZQogICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHZhbHVlIGlzIGVxdWFsICg9PT0pIHRvIHRoaXMuCiAgKi8KICBmdW5jdGlvbiAkaXNTYW1lKHZhbHVlKXsKICAgIHJldHVybiB2YWx1ZSA9PT0gdGhpczsKICB9CgogLyoqCiAgKiBAcGFyYW0geyp9IHZhbHVlCiAgKiBAcmV0dXJuIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdmFsdWUgaXMgbm90IGVxdWFsICghPT0pIHRvIHRoaXMuCiAgKi8KICBmdW5jdGlvbiAkaXNOb3RTYW1lKHZhbHVlKXsKICAgIHJldHVybiB2YWx1ZSAhPT0gdGhpczsKICB9CgogLyoqCiAgKiBub3RoaW5nIHRvIGRvLCBqdXN0IHJldHVybnMgZmlyc3QgYXJndW1lbnQuCiAgKiBAcGFyYW0geyp9IHZhbHVlCiAgKiBAcmV0dXJuIHsqfSBSZXR1cm5zIGZpcnN0IGFyZ3VtZW50LgogICovCiAgZnVuY3Rpb24gJHNlbGYodmFsdWUpewogICAgcmV0dXJuIHZhbHVlOwogIH0KCiAvKioKICAqIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGFsd2F5cyByZXR1cm5zIHRoZSBzYW1lIHZhbHVlLgogICogQHBhcmFtIHsqfSB2YWx1ZQogICogQHJldHVybiB7ZnVuY3Rpb24oKX0KICAqLwogIGZ1bmN0aW9uICRjb25zdCh2YWx1ZSl7CiAgICByZXR1cm4gZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICB9CgogLyoqCiAgKiBBbHdheXMgcmV0dXJucyBmYWxzZS4KICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgKi8KICBmdW5jdGlvbiAkZmFsc2UoKXsKICAgIHJldHVybiBmYWxzZTsKICB9CgogLyoqCiAgKiBBbHdheXMgcmV0dXJucyB0cnVlLgogICogQHJldHVybiB7Ym9vbGVhbn0KICAqLwogIGZ1bmN0aW9uICR0cnVlKCl7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogLyoqCiAgKiBBbHdheXMgcmV0dXJucyBudWxsLgogICovCiAgZnVuY3Rpb24gJG51bGwoKXsKICAgIHJldHVybiBudWxsOwogIH0KCiAvKioKICAqIEFsd2F5cyByZXR1cm5zIHVuZGVmaW5lZC4KICAqLwogIGZ1bmN0aW9uICR1bmRlZigpewogIH0KCiAvKioKICAqIEBwYXJhbSB7ZnVuY3Rpb24ob2JqZWN0KXxzdHJpbmd9IHBhdGgKICAqIEBwYXJhbSB7ZnVuY3Rpb24odmFsdWUpfHN0cmluZ3xvYmplY3Q9fSBtb2RpZmljYXRvcgogICogQHJldHVybiB7ZnVuY3Rpb24ob2JqZWN0KX0gUmV0dXJucyBmdW5jdGlvbiB0aGF0IHJlc29sdmUgc29tZSBwYXRoIGluIG9iamVjdCBhbmQgY2FuIHVzZSBtb2RpZmljYXRvciBmb3IgdmFsdWUgdHJhbnNmb3JtYXRpb24uCiAgKi8KICB2YXIgZ2V0dGVyID0gKGZ1bmN0aW9uKCl7CiAgICB2YXIgSUQgPSAnYmFzaXNHZXR0ZXJJZCcgKyBnZW5VSUQoKSArICdfJzsKICAgIHZhciBtb2RpZmljYXRvclNlZWQgPSAxOwogICAgdmFyIHNpbXBsZVBhdGggPSAvXlthLXokX11bYS16JF8wLTldKihcLlthLXokX11bYS16JF8wLTldKikqJC9pOwoKICAgIHZhciBnZXR0ZXJNYXAgPSBbXTsKICAgIHZhciBwYXRoQ2FjaGUgPSB7fTsKICAgIHZhciBtb2RDYWNoZSA9IHt9OwoKICAgIGZ1bmN0aW9uIGJ1aWxkRnVuY3Rpb24ocGF0aCl7CiAgICAgIGlmIChzaW1wbGVQYXRoLnRlc3QocGF0aCkpCiAgICAgIHsKICAgICAgICB2YXIgcGFydHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICAgICAgdmFyIGZvbyA9IHBhcnRzWzBdOwogICAgICAgIHZhciBiYXIgPSBwYXJ0c1sxXTsKICAgICAgICB2YXIgYmF6ID0gcGFydHNbMl07CiAgICAgICAgdmFyIGZuOwoKICAgICAgICAvLyBUaGlzIGFwcHJvYWNoIGhlbHBzIHByb2R1Y2UgZnVuY3Rpb24gdGhhdCBjb3VsZCBiZQogICAgICAgIC8vIG9wdGltaXplZCAoaW5saW5lZCkgYnkganMgZW5naW5lLiBJbiBtb3N0IGNhc2VzIHBhdGggY29udGFpbnMKICAgICAgICAvLyBmcm9tIDEgdG8gMyBwYXJ0cyBhbmQgd2UgZG9uJ3QgdXNlIGEgbG9vcCBpbiB0aG9zZSBjYXNlcy4KICAgICAgICBzd2l0Y2ggKHBhcnRzLmxlbmd0aCkKICAgICAgICB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGZuID0gZnVuY3Rpb24ob2JqZWN0KXsKICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0ICE9IG51bGwgPyBvYmplY3RbZm9vXSA6IG9iamVjdDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIGZuID0gZnVuY3Rpb24ob2JqZWN0KXsKICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0ICE9IG51bGwgPyBvYmplY3RbZm9vXVtiYXJdIDogb2JqZWN0OwogICAgICAgICAgICB9OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgZm4gPSBmdW5jdGlvbihvYmplY3QpewogICAgICAgICAgICAgIHJldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdFtmb29dW2Jhcl1bYmF6XSA6IG9iamVjdDsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBmbiA9IGZ1bmN0aW9uKG9iamVjdCl7CiAgICAgICAgICAgICAgaWYgKG9iamVjdCAhPSBudWxsKQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9iamVjdCA9IG9iamVjdFtmb29dW2Jhcl1bYmF6XTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAzLCBrZXk7IGtleSA9IHBhcnRzW2ldOyBpKyspCiAgICAgICAgICAgICAgICAgIG9iamVjdCA9IG9iamVjdFtrZXldOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIC8vIHZlcmJvc2UgZnVuY3Rpb24gY29kZSBpbiBkZXYgbW9kZQogICAgICAgIC8qKiBAY3V0ICovIGZuID0gRnVuY3Rpb24oJ3BhcnRzJywgJ3JldHVybiAnICsgZm4udG9TdHJpbmcoKQogICAgICAgIC8qKiBAY3V0ICovICAgLnJlcGxhY2UoLyhmb298YmFyfGJheikvZywgZnVuY3Rpb24obSwgdyl7CiAgICAgICAgLyoqIEBjdXQgKi8gICAgICByZXR1cm4gJyInICsgcGFydHNbdyA9PSAnZm9vJyA/IDAgOiAodyA9PSAnYmFyJyA/IDEgOiAyKV0gKyAnIic7CiAgICAgICAgLyoqIEBjdXQgKi8gICAgfSkKICAgICAgICAvKiogQGN1dCAqLyAgIC5yZXBsYWNlKC9cW1wiKFteIl0rKVwiXF0vZywgJy4kMScpKShwYXJ0cyk7CgogICAgICAgIHJldHVybiBmbjsKICAgICAgfQoKICAgICAgLy8gZm9yIGNhc2VzIHdoZW4gcGF0aCBpc24ndCBhIHByb3BlcnR5IG5hbWUgY2hhaW4KICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbignb2JqZWN0JywgJ3JldHVybiBvYmplY3QgIT0gbnVsbCA/IG9iamVjdC4nICsgcGF0aCArICcgOiBvYmplY3QnKTsKICAgIH0KCiAgICB2YXIgZ2V0dGVyRm4gPSBmdW5jdGlvbihwYXRoLCBtb2RpZmljYXRvcil7CiAgICAgIHZhciBmdW5jOwogICAgICB2YXIgcmVzdWx0OwogICAgICB2YXIgZ2V0dGVySWQ7CgogICAgICAvLyByZXR1cm4gbnVsbEdldHRlciBpZiBubyBwYXRoIG9yIG51bGxHZXR0ZXIgcGFzc2VkCiAgICAgIGlmICghcGF0aCB8fCBwYXRoID09PSBudWxsR2V0dGVyKQogICAgICAgIHJldHVybiBudWxsR2V0dGVyOwoKICAgICAgLy8gcmVzb2x2ZSBnZXR0ZXIgYnkgcGF0aAogICAgICBpZiAodHlwZW9mIHBhdGggPT0gJ2Z1bmN0aW9uJykKICAgICAgewogICAgICAgIGdldHRlcklkID0gcGF0aFtJRF07CgogICAgICAgIC8vIHBhdGggaXMgZnVuY3Rpb24KICAgICAgICBpZiAoZ2V0dGVySWQpCiAgICAgICAgewogICAgICAgICAgLy8gdGhpcyBmdW5jdGlvbiB1c2VkIGZvciBnZXR0ZXIgYmVmb3JlCiAgICAgICAgICBmdW5jID0gZ2V0dGVyTWFwW01hdGguYWJzKGdldHRlcklkKSAtIDFdOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgLy8gdGhpcyBmdW5jdGlvbiBuZXZlciB1c2VkIGZvciBnZXR0ZXIgYmVmb3JlLCB3cmFwIGFuZCBjYWNoZSBpdAoKICAgICAgICAgIC8vIHdyYXAgZnVuY3Rpb24gdG8gcHJldmVudCBmdW5jdGlvbiBwcm9wZXJ0aWVzIHJld3JpdGUKICAgICAgICAgIGZ1bmMgPSBmdW5jdGlvbihvYmplY3QpewogICAgICAgICAgICByZXR1cm4gcGF0aChvYmplY3QpOwogICAgICAgICAgfTsKICAgICAgICAgIGZ1bmMuYmFzZSA9IHBhdGg7CiAgICAgICAgICBmdW5jLl9fZXh0ZW5kX18gPSBnZXR0ZXI7CgogICAgICAgICAgLy8gYWRkIHRvIGNhY2hlCiAgICAgICAgICBnZXR0ZXJJZCA9IGdldHRlck1hcC5wdXNoKGZ1bmMpOwogICAgICAgICAgcGF0aFtJRF0gPSAtZ2V0dGVySWQ7CiAgICAgICAgICBmdW5jW0lEXSA9IGdldHRlcklkOwogICAgICAgIH0KICAgICAgfQogICAgICBlbHNlCiAgICAgIHsKICAgICAgICAvLyB0aHJlYWQgcGF0aCBhcyBzdHJpbmcsIHNlYXJjaCBpbiBjYWNoZQogICAgICAgIGZ1bmMgPSBwYXRoQ2FjaGVbcGF0aF07CgogICAgICAgIGlmIChmdW5jKQogICAgICAgIHsKICAgICAgICAgIC8vIHJlc29sdmUgZ2V0dGVyIGlkCiAgICAgICAgICBnZXR0ZXJJZCA9IGZ1bmNbSURdOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgLy8gY3JlYXRlIGdldHRlciBmdW5jdGlvbgogICAgICAgICAgZnVuYyA9IGJ1aWxkRnVuY3Rpb24ocGF0aCk7CiAgICAgICAgICBmdW5jLmJhc2UgPSBwYXRoOwogICAgICAgICAgZnVuYy5fX2V4dGVuZF9fID0gZ2V0dGVyOwoKICAgICAgICAgIC8vIGFkZCB0byBjYWNoZQogICAgICAgICAgZ2V0dGVySWQgPSBnZXR0ZXJNYXAucHVzaChmdW5jKTsKICAgICAgICAgIGZ1bmNbSURdID0gZ2V0dGVySWQ7CiAgICAgICAgICBwYXRoQ2FjaGVbcGF0aF0gPSBmdW5jOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gcmVzb2x2ZSBnZXR0ZXIgd2l0aCBtb2RpZmljYXRvcgogICAgICB2YXIgbW9kVHlwZSA9IG1vZGlmaWNhdG9yICE9IG51bGwgJiYgdHlwZW9mIG1vZGlmaWNhdG9yOwoKICAgICAgLy8gaWYgbm8gbW9kaWZpY2F0b3IsIHJldHVybiBmdW5jCiAgICAgIGlmICghbW9kVHlwZSkKICAgICAgICByZXR1cm4gZnVuYzsKCiAgICAgIHZhciBtb2RMaXN0ID0gbW9kQ2FjaGVbZ2V0dGVySWRdOwogICAgICB2YXIgbW9kSWQ7CgogICAgICAvLyByZXNvbHZlIG1vZGlmaWNhdG9yIGlkIGlmIHBvc3NpYmxlCiAgICAgIGlmIChtb2RUeXBlID09ICdzdHJpbmcnKQogICAgICAgIG1vZElkID0gbW9kVHlwZSArIG1vZGlmaWNhdG9yOwogICAgICBlbHNlCiAgICAgICAgaWYgKG1vZFR5cGUgPT0gJ2Z1bmN0aW9uJykKICAgICAgICAgIG1vZElkID0gbW9kaWZpY2F0b3IuYmFzaXNNb2RJZF87CiAgICAgICAgZWxzZQogICAgICAgICAgaWYgKG1vZFR5cGUgIT0gJ29iamVjdCcpCiAgICAgICAgICB7CiAgICAgICAgICAgIC8vIG9ubHkgc3RyaW5nLCBmdW5jdGlvbiBhbmQgb2JqZWN0cyBhcmUgc3VwcG9ydCBhcyBtb2RpZmljYXRvcgogICAgICAgICAgICAvKiogQGN1dCAqLyBjb25zb2xlTWV0aG9kcy53YXJuKCdiYXNpcy5nZXR0ZXI6IHdyb25nIG1vZGlmaWNhdG9yIHR5cGUsIG1vZGlmaWNhdG9yIG5vdCB1c2VkLCBwYXRoOiAnLCBwYXRoLCAnLCBtb2RpZmljYXRvcjonLCBtb2RpZmljYXRvcik7CgogICAgICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgICAgIH0KCiAgICAgIC8vIHRyeSBmZXRjaCBnZXR0ZXIgZnJvbSBjYWNoZQogICAgICBpZiAobW9kSWQgJiYgbW9kTGlzdCAmJiBtb2RMaXN0W21vZElkXSkKICAgICAgICByZXR1cm4gbW9kTGlzdFttb2RJZF07CgogICAgICAvLyByZWNvdmVyIG9yaWdpbmFsIGZ1bmN0aW9uLCByZWR1Y2UgZnVuY3Rpb25zIGNhbGwgZGVlcAogICAgICBpZiAodHlwZW9mIGZ1bmMuYmFzZSA9PSAnZnVuY3Rpb24nKQogICAgICAgIGZ1bmMgPSBmdW5jLmJhc2U7CgogICAgICBzd2l0Y2ggKG1vZFR5cGUpCiAgICAgIHsKICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgcmVzdWx0ID0gZnVuY3Rpb24ob2JqZWN0KXsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZ0Z1bmN0aW9ucy5mb3JtYXQobW9kaWZpY2F0b3IsIGZ1bmMob2JqZWN0KSk7CiAgICAgICAgICB9OwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ2Z1bmN0aW9uJzoKICAgICAgICAgIGlmICghbW9kSWQpCiAgICAgICAgICB7CiAgICAgICAgICAgIC8vIG1hcmsgZnVuY3Rpb24gd2l0aCBtb2RpZmljYXRvciBpZAogICAgICAgICAgICBtb2RJZCA9IG1vZFR5cGUgKyBtb2RpZmljYXRvclNlZWQrKzsKICAgICAgICAgICAgbW9kaWZpY2F0b3IuYmFzaXNNb2RJZF8gPSBtb2RJZDsKICAgICAgICAgIH0KCiAgICAgICAgICByZXN1bHQgPSBmdW5jdGlvbihvYmplY3QpewogICAgICAgICAgICByZXR1cm4gbW9kaWZpY2F0b3IoZnVuYyhvYmplY3QpKTsKICAgICAgICAgIH07CiAgICAgICAgICBicmVhazsKCiAgICAgICAgZGVmYXVsdDogLy9jYXNlICdvYmplY3QnOgogICAgICAgICAgcmVzdWx0ID0gZnVuY3Rpb24ob2JqZWN0KXsKICAgICAgICAgICAgcmV0dXJuIG1vZGlmaWNhdG9yW2Z1bmMob2JqZWN0KV07CiAgICAgICAgICB9OwogICAgICB9CgogICAgICByZXN1bHQuYmFzZSA9IGZ1bmMuYmFzZSB8fCBmdW5jOwogICAgICByZXN1bHQuX19leHRlbmRfXyA9IGdldHRlcjsKCiAgICAgIGlmIChtb2RJZCkKICAgICAgewogICAgICAgIGlmICghbW9kTGlzdCkKICAgICAgICB7CiAgICAgICAgICAvLyBjcmVhdGUgbmV3IG1vZGlmaWNhdG9yIGxpc3QgaWYgaXQgbm90IGV4aXN0cyB5ZXQKICAgICAgICAgIG1vZExpc3QgPSB7fTsKICAgICAgICAgIG1vZENhY2hlW2dldHRlcklkXSA9IG1vZExpc3Q7CiAgICAgICAgfQoKICAgICAgICAvLyBjYWNoZSBnZXR0ZXIgd2l0aCBtb2RpZmljYXRvcgogICAgICAgIG1vZExpc3RbbW9kSWRdID0gcmVzdWx0OwogICAgICAgIHJlc3VsdC5tb2QgPSBtb2RpZmljYXRvcjsKCiAgICAgICAgLy8gY2FjaGUgbmV3IGdldHRlcgogICAgICAgIHJlc3VsdFtJRF0gPSBnZXR0ZXJNYXAucHVzaChyZXN1bHQpOwogICAgICB9CiAgICAgIGVsc2UKICAgICAgewogICAgICAgIC8vIG9ubHkgb2JqZWN0IG1vZGlmaWNhdG9ycyBoYXMgbm8gbW9kSWQKICAgICAgICAvLyBnZXR0ZXJzIHdpdGggb2JqZWN0IG1vZGlmaWNhdG9yIGFyZSBub3QgY2FjaGluZwogICAgICAgIC8vIHRoaXMgcHJldmVudHMgb2Ygc3RvcmluZyAoaW4gY2xvc3VyZSkgb2JqZWN0IHRoYXQgY2FuJ3QgYmUgcmVsZWFzZWQgYnkgZ2FiYWdlIGNvbGxlY3RvcnMKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CgogICAgZ2V0dGVyRm4uSUQgPSBJRDsKCiAgICByZXR1cm4gZ2V0dGVyRm47CiAgfSkoKTsKCiAgdmFyIG51bGxHZXR0ZXIgPSBleHRlbmQoZnVuY3Rpb24oKXt9LCB7CiAgICBfX2V4dGVuZF9fOiBnZXR0ZXIKICB9KTsKCgogLyoqCiAgKiBAcGFyYW0ge3N0cmluZ30ga2V5CiAgKiBAcmV0dXJuIHtvYmplY3R9CiAgKi8KICBmdW5jdGlvbiB3cmFwcGVyKGtleSl7CiAgICByZXR1cm4gZnVuY3Rpb24odmFsdWUpewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KCiAvKioKICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gaW5pdCBGdW5jdGlvbiB0aGF0IHNob3VsZCBiZSBjYWxsZWQgYXQgZmlyc3QgdGltZS4KICAqIEBwYXJhbSB7T2JqZWN0PX0gdGhpc09iamVjdAogICogQHJldHVybiB7ZnVuY3Rpb24oKX0gUmV0dXJucyBsYXp5IGZ1bmN0aW9uLgogICovCiAgZnVuY3Rpb24gbGF6eUluaXQoaW5pdCwgdGhpc09iamVjdCl7CiAgICB2YXIgaW5pdGVkID0gMDsKICAgIHZhciBzZWxmOwogICAgdmFyIGRhdGE7CiAgICByZXR1cm4gc2VsZiA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmICghaW5pdGVkKyspCiAgICAgIHsKICAgICAgICBzZWxmLmluaXRlZCA9IHRydWU7ICAvLyBET04nVCBVU0UgVEhJUyBQUk9QRVJUWSwgSVQnUyBGT1IgREVCVUcgUFVSUE9TRVMgT05MWQogICAgICAgIHNlbGYuZGF0YSA9ICAgICAgICAgIC8vIERPTidUIFVTRSBUSElTIFBST1BFUlRZLCBJVCdTIEZPUiBERUJVRyBQVVJQT1NFUyBPTkxZCiAgICAgICAgZGF0YSA9IGluaXQuYXBwbHkodGhpc09iamVjdCB8fCB0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIC8qKiBAY3V0ICovIGlmICh0eXBlb2YgZGF0YSA9PSAndW5kZWZpbmVkJykgY29uc29sZU1ldGhvZHMud2FybignbGF6eUluaXQgZnVuY3Rpb24gcmV0dXJucyBub3RoaW5nOlxuJyArIGluaXQpOwogICAgICB9CiAgICAgIHJldHVybiBkYXRhOwogICAgfTsKICB9CgogLyoqCiAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGluaXQgRnVuY3Rpb24gdGhhdCBzaG91bGQgYmUgY2FsbGVkIGF0IGZpcnN0IHRpbWUuCiAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IHJ1biBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIGFsbCB0aW1lcy4KICAqIEBwYXJhbSB7T2JqZWN0PX0gdGhpc09iamVjdAogICogQHJldHVybiB7ZnVuY3Rpb24oKX0gUmV0dXJucyBsYXp5IGZ1bmN0aW9uLgogICovCiAgZnVuY3Rpb24gbGF6eUluaXRBbmRSdW4oaW5pdCwgcnVuLCB0aGlzT2JqZWN0KXsKICAgIHZhciBpbml0ZWQgPSAwOwogICAgdmFyIHNlbGY7CiAgICB2YXIgZGF0YTsKICAgIHJldHVybiBzZWxmID0gZnVuY3Rpb24oKXsKICAgICAgaWYgKCFpbml0ZWQrKykKICAgICAgewogICAgICAgIHNlbGYuaW5pdGVkID0gdHJ1ZTsgIC8vIERPTidUIFVTRSBUSElTIFBST1BFUlRZLCBJVCdTIEZPUiBERUJVRyBQVVJQT1NFUyBPTkxZCiAgICAgICAgc2VsZi5kYXRhID0gICAgICAgICAgLy8gRE9OJ1QgVVNFIFRISVMgUFJPUEVSVFksIElUJ1MgRk9SIERFQlVHIFBVUlBPU0VTIE9OTFkKICAgICAgICBkYXRhID0gaW5pdC5jYWxsKHRoaXNPYmplY3QgfHwgdGhpcyk7CiAgICAgICAgLyoqIEBjdXQgKi8gaWYgKHR5cGVvZiBkYXRhID09ICd1bmRlZmluZWQnKSBjb25zb2xlTWV0aG9kcy53YXJuKCdsYXp5SW5pdEFuZFJ1biBmdW5jdGlvbiByZXR1cm5zIG5vdGhpbmc6XG4nICsgaW5pdCk7CiAgICAgIH0KICAgICAgcnVuLmFwcGx5KGRhdGEsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBkYXRhOwogICAgfTsKICB9CgogLyoqCiAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IHJ1biBGdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9ubHkgb25jZS4KICAqIEBwYXJhbSB7T2JqZWN0PX0gdGhpc09iamVjdAogICogQHJldHVybiB7ZnVuY3Rpb24oKX0gUmV0dXJucyBsYXp5IGZ1bmN0aW9uLgogICovCiAgZnVuY3Rpb24gcnVuT25jZShydW4sIHRoaXNPYmplY3QpewogICAgdmFyIGZpcmVkID0gMDsKICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICBpZiAoIWZpcmVkKyspCiAgICAgICAgcmV0dXJuIHJ1bi5hcHBseSh0aGlzT2JqZWN0IHx8IHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogIH0KCgogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgLy8gc2FmZSBjb25zb2xlIG1ldGhvZCB3cmFwcGVycwogIC8vCgogIHZhciBjb25zb2xlTWV0aG9kcyA9IChmdW5jdGlvbigpewogICAgdmFyIG1ldGhvZHMgPSB7CiAgICAgIGxvZzogJHVuZGVmLAogICAgICBpbmZvOiAkdW5kZWYsCiAgICAgIHdhcm46ICR1bmRlZiwKICAgICAgZXJyb3I6ICR1bmRlZgogICAgfTsKCiAgICBpZiAodHlwZW9mIGNvbnNvbGUgIT0gJ3VuZGVmaW5lZCcpCiAgICAgIGl0ZXJhdGUobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kTmFtZSl7CiAgICAgICAgbWV0aG9kc1ttZXRob2ROYW1lXSA9ICdiaW5kJyBpbiBGdW5jdGlvbi5wcm90b3R5cGUgJiYgdHlwZW9mIGNvbnNvbGVbbWV0aG9kTmFtZV0gPT0gJ2Z1bmN0aW9uJwogICAgICAgICAgPyBGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5jYWxsKGNvbnNvbGVbbWV0aG9kTmFtZV0sIGNvbnNvbGUpCiAgICAgICAgICAgIC8vIGllOCBhbmQgbG93ZXIsIGl0J3MgYWxzbyBtb3JlIHNhZmUgd2hlbiBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCBkZWZpbmVkCiAgICAgICAgICAgIC8vIGJ5IG90aGVyIGxpYnJhcmllcyAobGlrZSBlczUtc2hpbSkKICAgICAgICAgIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW21ldGhvZE5hbWVdLCBjb25zb2xlLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9OwogICAgICB9KTsKCiAgICByZXR1cm4gbWV0aG9kczsKICB9KSgpOwoKCiAgLy8KICAvLyBTdXBwb3J0IGZvciBzZXRJbW1lZGlhdGUvY2xlYXJJbW1lZGlhdGUKICAvLwoKICB2YXIgc2V0SW1tZWRpYXRlID0gZ2xvYmFsLnNldEltbWVkaWF0ZSB8fCBnbG9iYWwubXNTZXRJbW1lZGlhdGU7CiAgdmFyIGNsZWFySW1tZWRpYXRlID0gZ2xvYmFsLmNsZWFySW1tZWRpYXRlIHx8IGdsb2JhbC5tc1NldEltbWVkaWF0ZTsKCiAgLy8gYmluZCBjb250ZXh0IGZvciBzZXRJbW1lZGlhdGUvY2xlYXJJbW1lZGlhdGUsIElFMTAgdGhyb3cgZXhjZXB0aW9uIGlmIGNvbnRleHQgaXNuJ3QgZ2xvYmFsCiAgaWYgKHNldEltbWVkaWF0ZSkKICAgIHNldEltbWVkaWF0ZSA9IHNldEltbWVkaWF0ZS5iaW5kKGdsb2JhbCk7CgogIGlmIChjbGVhckltbWVkaWF0ZSkKICAgIGNsZWFySW1tZWRpYXRlID0gY2xlYXJJbW1lZGlhdGUuYmluZChnbG9iYWwpOwoKICAvLwogIC8vIGVtdWxhdGUgc2V0SW1tZWRpYXRlL2NsZWFySW1tZWRpYXRlCiAgLy8gSW5zcGlyZWQgb24gRG9tZW5pYyBEZW5pY29sYSdzIHNvbHV0aW9uIGh0dHBzOi8vZ2l0aHViLmNvbS9Ob2JsZUpTL3NldEltbWVkaWF0ZQogIC8vCiAgaWYgKCFzZXRJbW1lZGlhdGUpCiAgICAoZnVuY3Rpb24oKXsKICAgICAgdmFyIE1FU1NBR0VfTkFNRSA9ICdiYXNpc2pzLnNldEltbWVkaWF0ZSc7CiAgICAgIHZhciBydW5UYXNrID0gKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIHRhc2tCeUlkID0ge307CiAgICAgICAgdmFyIHRhc2tJZCA9IDE7CgogICAgICAgIC8vIGVtdWxhdGUgc2V0SW1tZWRpYXRlCiAgICAgICAgc2V0SW1tZWRpYXRlID0gZnVuY3Rpb24oZm4vKiwgLi5hcmdzICovKXsKICAgICAgICAgIGlmICh0eXBlb2YgZm4gIT0gJ2Z1bmN0aW9uJykKICAgICAgICAgIHsKICAgICAgICAgICAgLyoqIEBjdXQgKi8gY29uc29sZU1ldGhvZHMud2FybignYmFzaXMuc2V0SW1tZWRpYXRlKCkgYW5kIGJhc2lzLm5leHRUaWNrKCkgYWNjZXB0IGZ1bmN0aW9ucyBvbmx5IChjYWxsIGlnbm9yZWQpJyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICB0YXNrQnlJZFsrK3Rhc2tJZF0gPSB7CiAgICAgICAgICAgIGZuOiBmbiwKICAgICAgICAgICAgYXJnczogYXJyYXlGcm9tKGFyZ3VtZW50cywgMSkKICAgICAgICAgIH07CgogICAgICAgICAgYWRkVG9RdWV1ZSh0YXNrSWQpOwoKICAgICAgICAgIHJldHVybiB0YXNrSWQ7CiAgICAgICAgfTsKCiAgICAgICAgLy8gZW11bGF0ZSBjbGVhckltbWVkaWF0ZQogICAgICAgIGNsZWFySW1tZWRpYXRlID0gZnVuY3Rpb24oaWQpewogICAgICAgICAgZGVsZXRlIHRhc2tCeUlkW2lkXTsKICAgICAgICB9OwoKICAgICAgICAvLwogICAgICAgIC8vIHJldHVybiByZXN1bHQgZnVuY3Rpb24gZm9yIHRhc2sgcnVuCiAgICAgICAgLy8KICAgICAgICByZXR1cm4gZnVuY3Rpb24oaWQpewogICAgICAgICAgdmFyIHRhc2sgPSB0YXNrQnlJZFtpZF07CgogICAgICAgICAgaWYgKHRhc2spCiAgICAgICAgICB7CiAgICAgICAgICAgIGRlbGV0ZSB0YXNrQnlJZFtpZF07CiAgICAgICAgICAgIHJldHVybiB0YXNrLmZuLmFwcGx5KHVuZGVmaW5lZCwgdGFzay5hcmdzKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9KSgpOwoKICAgICAgLy8gYnkgZGVmYXVsdAogICAgICB2YXIgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCl7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgcnVuVGFzayh0YXNrSWQpOwogICAgICAgIH0sIDApOwogICAgICB9OwoKICAgICAgLy8KICAgICAgLy8gaW1wbGVtZW50IHBsYXRmb3JtIHNwZWNpZmljIHNvbHV0aW9uCiAgICAgIC8vCiAgICAgIGlmIChnbG9iYWwucHJvY2VzcyAmJiB0eXBlb2YgcHJvY2Vzcy5uZXh0VGljayA9PSAnZnVuY3Rpb24nKQogICAgICB7CiAgICAgICAgLy8gdXNlIG5leHQgdGljayBvbiBub2RlLmpzCiAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCl7CiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJ1blRhc2sodGFza0lkKTsKICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgIH0KICAgICAgZWxzZQogICAgICB7CiAgICAgICAgaWYgKGdsb2JhbC5NZXNzYWdlQ2hhbm5lbCkKICAgICAgICB7CiAgICAgICAgICB2YXIgY2hhbm5lbCA9IG5ldyBnbG9iYWwuTWVzc2FnZUNoYW5uZWwoKTsKCiAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgICAgdmFyIHRhc2tJZCA9IGV2ZW50LmRhdGE7CiAgICAgICAgICAgIHJ1blRhc2sodGFza0lkKTsKICAgICAgICAgIH07CgogICAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCl7CiAgICAgICAgICAgIGNoYW5uZWwucG9ydDIucG9zdE1lc3NhZ2UodGFza0lkKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAvLyBUaGUgdGVzdCBhZ2FpbnN0IGBpbXBvcnRTY3JpcHRzYCBwcmV2ZW50cyB0aGlzIGltcGxlbWVudGF0aW9uIGZyb20gYmVpbmcgaW5zdGFsbGVkIGluc2lkZSBhIHdlYiB3b3JrZXIsCiAgICAgICAgICAvLyB3aGVyZSBgZ2xvYmFsLnBvc3RNZXNzYWdlYCBtZWFucyBzb21ldGhpbmcgY29tcGxldGVseSBkaWZmZXJlbnQgYW5kIGNhbid0IGJlIHVzZWQgZm9yIHRoaXMgcHVycG9zZS4KICAgICAgICAgIHZhciBwb3N0TWVzc2FnZVN1cHBvcnRlZCA9IGdsb2JhbC5wb3N0TWVzc2FnZSAmJiAhZ2xvYmFsLmltcG9ydFNjcmlwdHM7CgogICAgICAgICAgLy8gSUU4IGhhcyBwb3N0TWVzc2FnZSBpbXBsZW1lbnRhdGlvbiwgYnV0IGl0IGlzIHN5bmNocm9ub3VzIGFuZCBjYW4ndCBiZSB1c2VkLgogICAgICAgICAgaWYgKHBvc3RNZXNzYWdlU3VwcG9ydGVkKQogICAgICAgICAgewogICAgICAgICAgICB2YXIgb2xkT25NZXNzYWdlID0gZ2xvYmFsLm9ubWVzc2FnZTsKICAgICAgICAgICAgZ2xvYmFsLm9ubWVzc2FnZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgcG9zdE1lc3NhZ2VTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgZ2xvYmFsLnBvc3RNZXNzYWdlKCcnLCAnKicpOwogICAgICAgICAgICBnbG9iYWwub25tZXNzYWdlID0gb2xkT25NZXNzYWdlOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChwb3N0TWVzc2FnZVN1cHBvcnRlZCkKICAgICAgICAgIHsKICAgICAgICAgICAgLy8gcG9zdE1lc3NhZ2Ugc2NoZW1lCiAgICAgICAgICAgIHZhciBzZXRJbW1lZGlhdGVIYW5kbGVyID0gZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgICAgIGlmIChldmVudCAmJiBldmVudC5zb3VyY2UgPT0gZ2xvYmFsKQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0YXNrSWQgPSBTdHJpbmcoZXZlbnQuZGF0YSkuc3BsaXQoTUVTU0FHRV9OQU1FKVsxXTsKCiAgICAgICAgICAgICAgICBpZiAodGFza0lkKQogICAgICAgICAgICAgICAgICBydW5UYXNrKHRhc2tJZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGdsb2JhbC5hZGRFdmVudExpc3RlbmVyKQogICAgICAgICAgICAgIGdsb2JhbC5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgc2V0SW1tZWRpYXRlSGFuZGxlciwgdHJ1ZSk7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICBnbG9iYWwuYXR0YWNoRXZlbnQoJ29ubWVzc2FnZScsIHNldEltbWVkaWF0ZUhhbmRsZXIpOwoKICAgICAgICAgICAgLy8gTWFrZSBgZ2xvYmFsYCBwb3N0IGEgbWVzc2FnZSB0byBpdHNlbGYgd2l0aCB0aGUgaGFuZGxlIGFuZCBpZGVudGlmeWluZyBwcmVmaXgsIHRodXMgYXN5bmNocm9ub3VzbHkKICAgICAgICAgICAgLy8gaW52b2tpbmcgb3VyIG9uR2xvYmFsTWVzc2FnZSBsaXN0ZW5lciBhYm92ZS4KICAgICAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uKHRhc2tJZCl7CiAgICAgICAgICAgICAgZ2xvYmFsLnBvc3RNZXNzYWdlKE1FU1NBR0VfTkFNRSArIHRhc2tJZCwgJyonKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNyZWF0ZVNjcmlwdCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaWYgKGRvY3VtZW50ICYmICdvbnJlYWR5c3RhdGVjaGFuZ2UnIGluIGNyZWF0ZVNjcmlwdCgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgLy8gQ3JlYXRlIGEgPHNjcmlwdD4gZWxlbWVudDsgaXRzIHJlYWR5c3RhdGVjaGFuZ2UgZXZlbnQgd2lsbCBiZSBmaXJlZCBhc3luY2hyb25vdXNseSBvbmNlIGl0IGlzIGluc2VydGVkCiAgICAgICAgICAgICAgLy8gaW50byB0aGUgZG9jdW1lbnQuIERvIHNvLCB0aHVzIHF1ZXVpbmcgdXAgdGhlIHRhc2suIFJlbWVtYmVyIHRvIGNsZWFuIHVwIG9uY2UgaXQncyBiZWVuIGNhbGxlZAogICAgICAgICAgICAgIHZhciBkZWZhdWx0QWRkVG9RdWV1ZSA9IGFkZFRvUXVldWU7CiAgICAgICAgICAgICAgYWRkVG9RdWV1ZSA9IGZ1bmN0aW9uIGJlZm9yZUhlYWRSZWFkeSh0YXNrSWQpewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkb2N1bWVudEludGVyZmFjZSAhPSAndW5kZWZpbmVkJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgYWRkVG9RdWV1ZSA9IGRlZmF1bHRBZGRUb1F1ZXVlOwoKICAgICAgICAgICAgICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5yZWFkeShmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIGFkZFRvUXVldWUgPSBmdW5jdGlvbih0YXNrSWQpewogICAgICAgICAgICAgICAgICAgICAgdmFyIHNjcmlwdEVsID0gY3JlYXRlU2NyaXB0KCk7CiAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRFbC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRFbC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAvL3NjcmlwdEVsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2NyaXB0RWwpOwogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudEludGVyZmFjZS5yZW1vdmUoc2NyaXB0RWwpOwogICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHRFbCA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBzaG91bGQgYmUgY2FsbGVkIGxhc3QgYXMgZXhjZXB0aW9uIHBvc3NpYmxlCiAgICAgICAgICAgICAgICAgICAgICAgIHJ1blRhc2sodGFza0lkKTsKICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAvL2RvY3VtZW50LmRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZChzY3JpcHRFbCk7CiAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudEludGVyZmFjZS5oZWFkLmFkZChzY3JpcHRFbCk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGFkZFRvUXVldWUgPT09IGJlZm9yZUhlYWRSZWFkeSkKICAgICAgICAgICAgICAgICAgZGVmYXVsdEFkZFRvUXVldWUodGFza0lkKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgYWRkVG9RdWV1ZSh0YXNrSWQpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pKCk7CgoKICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogIC8vIHBhdGggdXRpbHMKICAvLwoKICB2YXIgTk9ERV9FTlYgPSB0eXBlb2YgcHJvY2VzcyA9PSAnb2JqZWN0JyAmJiB0b1N0cmluZy5jYWxsKHByb2Nlc3MpID09ICdbb2JqZWN0IHByb2Nlc3NdJzsKCiAvKioKICAqIFV0aWxpdGllcyBmb3IgaGFuZGxpbmcgYW5kIHRyYW5zZm9ybWluZyBmaWxlIHBhdGhzLiBBbGwgdGhlc2UgZnVuY3Rpb25zIHBlcmZvcm0KICAqIG9ubHkgc3RyaW5nIHRyYW5zZm9ybWF0aW9ucy4gU2VydmVyIG9yIHNvbWV0aGluZyBlbHNlIGFyZSBub3QgY29uc3VsdGVkIHRvCiAgKiBjaGVjayB3aGV0aGVyIHBhdGhzIGFyZSB2YWxpZC4KICAqCiAgKiBGdW5jdGlvbnMgYXJlIHdvcmsgc2ltaWxhciB0byBub2RlLmpzIGBwYXRoYCBtb2R1bGUuIEZvciBub2RlLmpzIGVudmlyb25tZW50CiAgKiBgcGF0aGAgbW9kdWxlIGlzIHVzZWQuCiAgKgogICogQG5hbWUgcGF0aAogICogQG5hbWVzcGFjZSBiYXNpcy5wYXRoCiAgKi8KICB2YXIgcGF0aFV0aWxzID0gKGZ1bmN0aW9uKCl7CiAgICB2YXIgQUJTT0xVVEVfUlggPSAvXihbXlwvXSs6fFwvKS87CiAgICB2YXIgUFJPVE9DT0xfUlggPSAvXlthLXpBLVowLTlcLV0rOlwvPy87CiAgICB2YXIgT1JJR0lOX1JYID0gL14oPzpbYS16QS1aMC05XC1dKzopP1wvXC9bXlwvXStcLz8vOwogICAgdmFyIFNFQVJDSF9IQVNIX1JYID0gL1tcPyNdLiokLzsKCiAgICB2YXIgYmFzZVVSSTsKICAgIHZhciBvcmlnaW47CiAgICB2YXIgdXRpbHM7CgogICAgaWYgKE5PREVfRU5WKQogICAgewogICAgICAvLyB0cnkgdG8gdXNlIGJhc2VVUkkgZnJvbSBwcm9jZXNzLCBpdCBtYXkgYmUgcHJvdmlkZWQgYnkgcGFyZW50IG1vZHVsZQogICAgICB2YXIgcGF0aCA9IChwcm9jZXNzLmJhc2lzanNCYXNlVVJJIHx8IHJlcXVpcmUoJ3BhdGgnKS5yZXNvbHZlKCcuJykpLnJlcGxhY2UoL1xcL2csICcvJyk7IC8vIG9uIFdpbmRvd3MgcGF0aCBjb250YWlucyBiYWNrc2xhc2hlcwogICAgICBiYXNlVVJJID0gcGF0aC5yZXBsYWNlKC9eW15cL10qLywgJycpOwogICAgICBvcmlnaW4gPSBwYXRoLnJlcGxhY2UoL1wvLiovLCAnJyk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgIGJhc2VVUkkgPSBsb2NhdGlvbi5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSskLywgJycpOwogICAgICBvcmlnaW4gPSBsb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyBsb2NhdGlvbi5ob3N0OwogICAgfQoKICAgIHV0aWxzID0gewogICAgICBiYXNlVVJJOiBiYXNlVVJJLAogICAgICBvcmlnaW46IG9yaWdpbiwKCiAgICAgLyoqCiAgICAgICogTm9ybWFsaXplIGEgc3RyaW5nIHBhdGgsIHRha2luZyBjYXJlIG9mICcuLicgYW5kICcuJyBwYXJ0cy4KICAgICAgKiBXaGVuIG11bHRpcGxlIHNsYXNoZXMgYXJlIGZvdW5kLCB0aGV5J3JlIHJlcGxhY2VkIGJ5IGEgc2luZ2xlIG9uZTsKICAgICAgKiB3aGVuIHRoZSBwYXRoIGNvbnRhaW5zIGEgdHJhaWxpbmcgc2xhc2gsIGl0IGlzIHByZXNlcnZlZC4KICAgICAgKgogICAgICAqIE9yaWdpbiBpcyBub3QgaW5jbHVkZXMgaW4gcmVzdWx0IHBhdGguCiAgICAgICoKICAgICAgKiBAZXhhbXBsZQogICAgICAqICAgYmFzaXMucGF0aC5ub3JtYWxpemUoJy9mb28vYmFyLy9iYXovYXNkZi9xdXV4Ly4uJyk7CiAgICAgICogICAvLyByZXR1cm5zICcvZm9vL2Jhci9iYXovYXNkZicKICAgICAgKgogICAgICAqICAgYmFzaXMucGF0aC5ub3JtYWxpemUoJ2h0dHA6Ly9leGFtcGxlLmNvbTo4MDgwL2Zvby8vLi4vL2Jhci8nKTsKICAgICAgKiAgIC8vIHJldHVybnMgJy9iYXInCiAgICAgICoKICAgICAgKiAgIGJhc2lzLnBhdGgubm9ybWFsaXplKCcvL2xvY2FsaG9zdC9mb28vLi8uLi8vYmFyLycpOwogICAgICAqICAgLy8gcmV0dXJucyAnL2JhcicKICAgICAgKgogICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoCiAgICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICAqLwogICAgICBub3JtYWxpemU6IGZ1bmN0aW9uKHBhdGgpewogICAgICAgIHBhdGggPSAocGF0aCB8fCAnJykKICAgICAgICAgICAgICAucmVwbGFjZShQUk9UT0NPTF9SWCwgJy8nKQogICAgICAgICAgICAgIC5yZXBsYWNlKE9SSUdJTl9SWCwgJy8nKSAgICAgICAgLy8gYnV0IGN1dCBvZmYgb3JpZ2luCiAgICAgICAgICAgICAgLnJlcGxhY2UoU0VBUkNIX0hBU0hfUlgsICcnKTsgICAvLyBjdXQgb2ZmIHF1ZXJ5IHNlYXJjaCBhbmQgaGFzaAoKICAgICAgICAvLyB1c2UgbGluayBlbGVtZW50IGFzIHBhdGggcmVzb2x2ZXIKICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgdmFyIHBhcnRzID0gcGF0aC5zcGxpdCgnLycpOyAgICAgICAgICAgICAvLyBzcGxpdAoKICAgICAgICAvLyBwcm9jZXNzIHBhdGggcGFydHMKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgIGlmIChwYXJ0c1tpXSA9PSAnLi4nKQogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDEgfHwgcmVzdWx0WzBdKQogICAgICAgICAgICAgIHJlc3VsdC5wb3AoKTsKICAgICAgICAgIH0KICAgICAgICAgIGVsc2UKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKChwYXJ0c1tpXSB8fCAhaSkgJiYgcGFydHNbaV0gIT0gJy4nKQogICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHBhcnRzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQuam9pbignLycpIHx8CiAgICAgICAgICAgICAgIChwYXRoWzBdID09PSAnLycgPyAnLycgOiAnJyk7CiAgICAgIH0sCgogICAgIC8qKgogICAgICAqIFJldHVybiB0aGUgZGlyZWN0b3J5IG5hbWUgb2YgYSBwYXRoLiBTaW1pbGFyIHRvIG5vZGUuanMgcGF0aC5kaXJuYW1lCiAgICAgICogb3IgdGhlIFVuaXggZGlybmFtZSBjb21tYW5kLgogICAgICAqCiAgICAgICogQGV4YW1wbGUKICAgICAgKiAgIGJhc2lzLnBhdGguZGlybmFtZSgnL2Zvby9iYXIvYmF6L3doYXRldmVyJyk7IC8vIHJldHVybnMgJy9mb28vYmFyL2JheicKICAgICAgKgogICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoCiAgICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICAqLwogICAgICBkaXJuYW1lOiBmdW5jdGlvbihwYXRoKXsKICAgICAgICB2YXIgcmVzdWx0ID0gdXRpbHMubm9ybWFsaXplKHBhdGgpOwogICAgICAgIHJldHVybiByZXN1bHQucmVwbGFjZSgvXC8oW15cL10qKSR8XlteXC9dKyQvLCAnJykgfHwKICAgICAgICAgICAgICAgKHJlc3VsdFswXSA9PSAnLycgPyAnLycgOiAnLicpOwogICAgICB9LAoKICAgICAvKioKICAgICAgKiBSZXR1cm4gdGhlIGV4dGVuc2lvbiBvZiB0aGUgcGF0aCwgZnJvbSB0aGUgbGFzdCAnLicgdG8gZW5kIG9mIHN0cmluZwogICAgICAqIGluIHRoZSBsYXN0IHBvcnRpb24gb2YgdGhlIHBhdGguIElmIHRoZXJlIGlzIG5vICcuJyBpbiB0aGUgbGFzdAogICAgICAqIHBvcnRpb24gb2YgdGhlIHBhdGggb3IgdGhlIGZpcnN0IGNoYXJhY3RlciBvZiBpdCBpcyAnLicsIHRoZW4gaXQKICAgICAgKiByZXR1cm5zIGFuIGVtcHR5IHN0cmluZy4KICAgICAgKgogICAgICAqIEBleGFtcGxlCiAgICAgICogICBiYXNpcy5wYXRoLmV4dG5hbWUoJ2luZGV4Lmh0bWwnKTsgLy8gcmV0dXJucyAnLmh0bWwnCiAgICAgICogICBiYXNpcy5wYXRoLmV4dG5hbWUoJ2luZGV4LicpOyAgICAgLy8gcmV0dXJucyAnLicKICAgICAgKiAgIGJhc2lzLnBhdGguZXh0bmFtZSgnaW5kZXgnKTsgICAgICAvLyByZXR1cm5zICcnCiAgICAgICoKICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aAogICAgICAqIEByZXR1cm4ge3N0cmluZ30gUGF0aCBleHRlbnNpb24gd2l0aCBsZWFkaW5nIGRvdCBvciBlbXB0eSBzdHJpbmcuCiAgICAgICovCiAgICAgIGV4dG5hbWU6IGZ1bmN0aW9uKHBhdGgpewogICAgICAgIHZhciBleHQgPSB1dGlscy5ub3JtYWxpemUocGF0aCkubWF0Y2goL1teXC9dKFwuW15cL1wuXSopJC8pOwogICAgICAgIHJldHVybiBleHQgPyBleHRbMV0gOiAnJzsKICAgICAgfSwKCiAgICAgLyoqCiAgICAgICogUmV0dXJuIHRoZSBsYXN0IHBvcnRpb24gb2YgYSBwYXRoLiBTaW1pbGFyIHRvIG5vZGUuanMgcGF0aC5iYXNlbmFtZQogICAgICAqIG9yIHRoZSBVbml4IGJhc2VuYW1lIGNvbW1hbmQuCiAgICAgICoKICAgICAgKiBAZXhhbXBsZQogICAgICAqICAgYmFzaXMucGF0aC5iYXNlbmFtZSgnL2Zvby9iYXIvYmF6Lmh0bWwnKTsgICAgICAgICAgLy8gcmV0dXJucyAnYmF6Lmh0bWwnCiAgICAgICogICBiYXNpcy5wYXRoLmJhc2VuYW1lKCcvZm9vL2Jhci9iYXouaHRtbCcsICcuaHRtbCcpOyAvLyByZXR1cm5zICdiYXonCiAgICAgICoKICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGF0aAogICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gZXh0CiAgICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICAqLwogICAgICBiYXNlbmFtZTogZnVuY3Rpb24ocGF0aCwgZXh0KXsKICAgICAgICB2YXIgZmlsZW5hbWUgPSB1dGlscy5ub3JtYWxpemUocGF0aCkubWF0Y2goL1teXFxcL10qJC8pOwogICAgICAgIGZpbGVuYW1lID0gZmlsZW5hbWUgPyBmaWxlbmFtZVswXSA6ICcnOwoKICAgICAgICBpZiAoZXh0ID09IHV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpKQogICAgICAgICAgZmlsZW5hbWUgPSBmaWxlbmFtZS5zdWJzdHJpbmcoMCwgZmlsZW5hbWUubGVuZ3RoIC0gZXh0Lmxlbmd0aCk7CgogICAgICAgIHJldHVybiBmaWxlbmFtZTsKICAgICAgfSwKCiAgICAgLyoqCiAgICAgICogUmVzb2x2ZXMgdG8gdG8gYW4gYWJzb2x1dGUgcGF0aC4KICAgICAgKgogICAgICAqIElmIHRvIGlzbid0IGFscmVhZHkgYWJzb2x1dGUgZnJvbSBhcmd1bWVudHMgYXJlIHByZXBlbmRlZCBpbiByaWdodAogICAgICAqIHRvIGxlZnQgb3JkZXIsIHVudGlsIGFuIGFic29sdXRlIHBhdGggaXMgZm91bmQuIElmIGFmdGVyIHVzaW5nIGFsbAogICAgICAqIGZyb20gcGF0aHMgc3RpbGwgbm8gYWJzb2x1dGUgcGF0aCBpcyBmb3VuZCwgdGhlIGN1cnJlbnQgbG9jYXRpb24gaXMKICAgICAgKiB1c2VkIGFzIHdlbGwuIFRoZSByZXN1bHRpbmcgcGF0aCBpcyBub3JtYWxpemVkLCBhbmQgdHJhaWxpbmcgc2xhc2hlcwogICAgICAqIGFyZSByZW1vdmVkIHVubGVzcyB0aGUgcGF0aCBnZXRzIHJlc29sdmVkIHRvIHRoZSByb290IGRpcmVjdG9yeS4KICAgICAgKiBOb24tc3RyaW5nIGFyZ3VtZW50cyBhcmUgaWdub3JlZC4KICAgICAgKgogICAgICAqIEBleGFtcGxlCiAgICAgICogICBiYXNpcy5wYXRoLnJlc29sdmUoJy9mb28vYmFyJywgJy4vYmF6Jyk7CiAgICAgICogICAvLyByZXR1cm5zICcvZm9vL2Jhci9iYXonCiAgICAgICoKICAgICAgKiAgIGJhc2lzLnBhdGgucmVzb2x2ZSgnL2Zvby9iYXInLCAnL2RlbW8vZmlsZS8nKTsKICAgICAgKiAgIC8vIHJldHVybnMgJy9kZW1vL2ZpbGUnCiAgICAgICoKICAgICAgKiAgIGJhc2lzLnBhdGgucmVzb2x2ZSgnZm9vJywgJ2Jhci9iYXovJywgJy4uL2dpZi9pbWFnZS5naWYnKTsKICAgICAgKiAgIC8vIGlmIGN1cnJlbnQgbG9jYXRpb24gaXMgL2RlbW8sIGl0IHJldHVybnMgJy9kZW1vL2Zvby9iYXIvZ2lmL2ltYWdlLmdpZicKICAgICAgKgogICAgICAqIEBwYXJhbSB7Li5zdHJpbmc9fSBmcm9tCiAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRvCiAgICAgICogQHJldHVybiB7c3RyaW5nfQogICAgICAqLwogICAgICByZXNvbHZlOiBmdW5jdGlvbihmcm9tLCB0byl7CiAgICAgICAgdmFyIGFyZ3MgPSBhcnJheUZyb20oYXJndW1lbnRzKS5yZXZlcnNlKCk7CiAgICAgICAgdmFyIHBhdGggPSBbXTsKICAgICAgICB2YXIgYWJzb2x1dGVGb3VuZCA9IGZhbHNlOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgIWFic29sdXRlRm91bmQgJiYgaSA8IGFyZ3MubGVuZ3RoOyBpKyspCiAgICAgICAgICBpZiAodHlwZW9mIGFyZ3NbaV0gPT0gJ3N0cmluZycpCiAgICAgICAgICB7CiAgICAgICAgICAgIHBhdGgudW5zaGlmdChhcmdzW2ldKTsKICAgICAgICAgICAgYWJzb2x1dGVGb3VuZCA9IEFCU09MVVRFX1JYLnRlc3QoYXJnc1tpXSk7CiAgICAgICAgICB9CgogICAgICAgIGlmICghYWJzb2x1dGVGb3VuZCkKICAgICAgICAgIHBhdGgudW5zaGlmdChiYXNlVVJJID09ICcvJyA/ICcnIDogYmFzZVVSSSk7CgogICAgICAgIHJldHVybiB1dGlscy5ub3JtYWxpemUocGF0aC5qb2luKCcvJykpOwogICAgICB9LAoKICAgICAvKioKICAgICAgKiBTb2x2ZSB0aGUgcmVsYXRpdmUgcGF0aCBmcm9tIGZyb20gdG8gdG8uCiAgICAgICoKICAgICAgKiBBdCB0aW1lcyB3ZSBoYXZlIHR3byBhYnNvbHV0ZSBwYXRocywgYW5kIHdlIG5lZWQgdG8gZGVyaXZlIHRoZQogICAgICAqIHJlbGF0aXZlIHBhdGggZnJvbSBvbmUgdG8gdGhlIG90aGVyLiBUaGlzIGlzIGFjdHVhbGx5IHRoZSByZXZlcnNlCiAgICAgICogdHJhbnNmb3JtIG9mIHtiYXNpcy5wYXRoLnJlc29sdmV9LCB3aGljaCBtZWFucyB3ZSBzZWUgdGhhdDoKICAgICAgKgogICAgICAqICAgYmFzaXMucGF0aC5yZXNvbHZlKGZyb20sIGJhc2lzLnBhdGgucmVsYXRpdmUoZnJvbSwgdG8pKSA9PSBiYXNpcy5wYXRoLnJlc29sdmUodG8pCiAgICAgICoKICAgICAgKiBJZiBgdG9gIGFyZ3VtZW50IG9taXR0ZWQgdGhhbiByZXNvbHZlIGBmcm9tYCByZWxhdGl2ZSB0byBjdXJyZW50IGJhc2VVUkkuCiAgICAgICoKICAgICAgKiBGdW5jdGlvbiBhbHNvIGNvdWxkIGJlIHVzZWQgd2l0aCBBcnJheSNtYXAgbWV0aG9kIGFzIHdlbGwuIEluIHRoaXMgY2FzZQogICAgICAqIGV2ZXJ5IGFycmF5IG1lbWJlciByZXNvbHZlcyB0byBjdXJyZW50IGJhc2VVUkkuCiAgICAgICoKICAgICAgKiBAZXhhbXBsZQogICAgICAqICAgYmFzaXMucGF0aC5yZWxhdGl2ZSgnL2RhdGEvb3JhbmRlYS90ZXN0L2FhYScsICcvZGF0YS9vcmFuZGVhL2ltcGwvYmJiJyk7CiAgICAgICogICAvLyByZXR1cm5zICcuLi8uLi9pbXBsL2JiYicKICAgICAgKgogICAgICAqICAgWydmb28nLCAnL2EvYi9iYXInLCAnYS9iL2JheiddLm1hcChiYXNpcy5wYXRoLnJlbGF0aXZlKTsKICAgICAgKiAgIC8vIGlmIGJhc2VVUkkgaXMgJy9hL2InIGl0IHByb2R1Y2VzCiAgICAgICogICAvLyBbJy4uLy4uL2ZvbycsICdiYXInLCAnLi4vLi4vYS9iL2JheiddCiAgICAgICoKICAgICAgKiBAcGFyYW0ge3N0cmluZ30gZnJvbQogICAgICAqIEBwYXJhbSB7c3RyaW5nPX0gdG8KICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICAgICovCiAgICAgIHJlbGF0aXZlOiBmdW5jdGlvbihmcm9tLCB0byl7CiAgICAgICAgLy8gaXQgbWFrZXMgZnVuY3Rpb24gdXNlZnVsIHdpdGggYXJyYXkgaXRlcmF0ZSBtZXRob2RzLCBpLmUuCiAgICAgICAgLy8gWydmb28nLCAnYmFyJ10ubWFwKGJhc2lzLnBhdGgucmVsYXRpdmUpCiAgICAgICAgaWYgKHR5cGVvZiB0byAhPSAnc3RyaW5nJykKICAgICAgICB7CiAgICAgICAgICB0byA9IGZyb207CiAgICAgICAgICBmcm9tID0gYmFzZVVSSTsKICAgICAgICB9CgogICAgICAgIGZyb20gPSB1dGlscy5ub3JtYWxpemUoZnJvbSk7CiAgICAgICAgdG8gPSB1dGlscy5ub3JtYWxpemUodG8pOwoKICAgICAgICBpZiAoZnJvbVswXSA9PSAnLycgJiYgdG9bMF0gIT0gJy8nKQogICAgICAgICAgcmV0dXJuIGZyb207CiAgICAgICAgaWYgKHRvWzBdID09ICcvJyAmJiBmcm9tWzBdICE9ICcvJykKICAgICAgICAgIHJldHVybiB0bzsKCiAgICAgICAgdmFyIGJhc2UgPSBmcm9tLnJlcGxhY2UoL15cLyQvLCAnJykuc3BsaXQoL1wvLyk7CiAgICAgICAgdmFyIHBhdGggPSB0by5yZXBsYWNlKC9eXC8kLywgJycpLnNwbGl0KC9cLy8pOwogICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICB2YXIgaSA9IDA7CgogICAgICAgIHdoaWxlIChwYXRoW2ldID09IGJhc2VbaV0gJiYgdHlwZW9mIGJhc2VbaV0gPT0gJ3N0cmluZycpCiAgICAgICAgICBpKys7CgogICAgICAgIGZvciAodmFyIGogPSBiYXNlLmxlbmd0aCAtIGk7IGogPiAwOyBqLS0pCiAgICAgICAgICByZXN1bHQucHVzaCgnLi4nKTsKCiAgICAgICAgcmV0dXJuIHJlc3VsdC5jb25jYXQocGF0aC5zbGljZShpKS5maWx0ZXIoQm9vbGVhbikpLmpvaW4oJy8nKTsKICAgICAgfQogICAgfTsKCiAgICByZXR1cm4gdXRpbHM7CiAgfSkoKTsKCgogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogIC8vIGFwcGx5IGNvbmZpZwogIC8vCgogLyoqCiAgKiBAbmFtZXNwYWNlIGJhc2lzCiAgKi8KCiAgdmFyIGJhc2lzRmlsZW5hbWUgPSBfX2Jhc2lzRmlsZW5hbWUgfHwgJyc7CiAgdmFyIGNvbmZpZyA9IGZldGNoQ29uZmlnKCk7CgogLyoqCiAgKiBGZXRjaCBiYXNpcy5qcyBvcHRpb25zIGZyb20gc2NyaXB0J3MgYGJhc2lzLWNvbmZpZ2Agb3IgYGRhdGEtYmFzaXMtY29uZmlnYCBhdHRyaWJ1dGUuCiAgKi8KICBmdW5jdGlvbiBmZXRjaENvbmZpZygpewogICAgdmFyIGNvbmZpZyA9IF9fY29uZmlnOwoKICAgIGlmICghY29uZmlnKQogICAgewogICAgICBpZiAoTk9ERV9FTlYpCiAgICAgIHsKICAgICAgICAvLyBub2RlLmpzIGVudgogICAgICAgIGJhc2lzRmlsZW5hbWUgPSBfX2ZpbGVuYW1lLnJlcGxhY2UoL1xcL2csICcvJyk7ICAvLyBvbiBXaW5kb3dzIHBhdGggY29udGFpbnMgYmFja3NsYXNoZXMKICAgICAgfQogICAgICBlbHNlCiAgICAgIHsKICAgICAgICAvLyBicm93c2VyIGVudgogICAgICAgIHZhciBzY3JpcHRzID0gZG9jdW1lbnQuc2NyaXB0czsKICAgICAgICBmb3IgKHZhciBpID0gMCwgc2NyaXB0RWw7IHNjcmlwdEVsID0gc2NyaXB0c1tpXTsgaSsrKQogICAgICAgIHsKICAgICAgICAgIHZhciBjb25maWdBdHRyVmFsdWUgPSBzY3JpcHRFbC5oYXNBdHRyaWJ1dGUoJ2Jhc2lzLWNvbmZpZycpCiAgICAgICAgICAgID8gc2NyaXB0RWwuZ2V0QXR0cmlidXRlKCdiYXNpcy1jb25maWcnKQogICAgICAgICAgICA6IHNjcmlwdEVsLmdldEF0dHJpYnV0ZSgnZGF0YS1iYXNpcy1jb25maWcnKTsKCiAgICAgICAgICBzY3JpcHRFbC5yZW1vdmVBdHRyaWJ1dGUoJ2Jhc2lzLWNvbmZpZycpOwogICAgICAgICAgc2NyaXB0RWwucmVtb3ZlQXR0cmlidXRlKCdkYXRhLWJhc2lzLWNvbmZpZycpOwoKICAgICAgICAgIGlmIChjb25maWdBdHRyVmFsdWUgIT09IG51bGwpCiAgICAgICAgICB7CiAgICAgICAgICAgIGJhc2lzRmlsZW5hbWUgPSBwYXRoVXRpbHMubm9ybWFsaXplKHNjcmlwdEVsLnNyYyk7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbmZpZyA9IEZ1bmN0aW9uKCdyZXR1cm57JyArIGNvbmZpZ0F0dHJWYWx1ZSArICd9JykoKTsKICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgLyoqIEBjdXQgKi8gY29uc29sZU1ldGhvZHMuZXJyb3IoJ2Jhc2lzLWNvbmZpZzogYmFzaXMuanMgY29uZmlnIHBhcnNlIGZhdWx0OiAnICsgZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIHJldHVybiBwcm9jZXNzQ29uZmlnKGNvbmZpZyk7CiAgfQoKIC8qKgogICogUHJvY2VzcyBjb25maWcgb2JqZWN0IGFuZCByZXR1cm5zIGFkb3B0ZWQgY29uZmlnLgogICoKICAqIFNwZWNpYWwgb3B0aW9uczoKICAqIC0gYXV0b2xvYWQ6IG5hbWVzcGFjZSB0aGF0IG11c3QgYmUgbG9hZGVkIHJpZ2h0IGFmdGVyIGNvcmUgbG9hZGVkCiAgKiAtIHBhdGg6IGRpY3Rpb25hcnkgb2YgcGF0aHMgZm9yIHJvb3QgbmFtZXNwYWNlcwogICogLSBtb2R1bGVzOiBkaWN0aW9uYXJ5IG9mIG1vZHVsZXMgd2l0aCBvcHRpb25zCiAgKgogICogT3RoZXIgb3B0aW9ucyBjb3B5IGludG8gYmFzaXMuY29uZmlnIGFzIGlzLgogICovCiAgZnVuY3Rpb24gcHJvY2Vzc0NvbmZpZyhjb25maWcsIHZlcmJvc2UpewogICAgLy8gbWFrZSBhIGNvcHkgb2YgY29uZmlnCiAgICBjb25maWcgPSBzbGljZShjb25maWcpOwoKICAgIC8vIHdhcm4gYWJvdXQgZXh0UHJvdG8gaW4gYmFzaXMtY29uZmlnLCB0aGlzIG9wdGlvbiB3YXMgcmVtb3ZlZCBpbiAxLjMuMAogICAgLyoqIEBjdXQgKi8gaWYgKCdleHRQcm90bycgaW4gY29uZmlnKQogICAgLyoqIEBjdXQgKi8gICBjb25zb2xlTWV0aG9kcy53YXJuKCdiYXNpcy1jb25maWc6IGBleHRQcm90b2Agb3B0aW9uIGluIGJhc2lzLWNvbmZpZyBpcyBub3Qgc3VwcG9ydCBhbnltb3JlJyk7CgogICAgLy8gd2FybiBhYm91dCBwYXRoIGluIGJhc2lzLWNvbmZpZywgdGhpcyBvcHRpb24gd2FzIGRlcHJlY2F0ZWQgaW4gMS4zLjAKICAgIC8qKiBAY3V0ICovIGlmICgncGF0aCcgaW4gY29uZmlnKQogICAgLyoqIEBjdXQgKi8gICBjb25zb2xlTWV0aG9kcy53YXJuKCdiYXNpcy1jb25maWc6IGBwYXRoYCBvcHRpb24gaW4gYmFzaXMtY29uZmlnIGlzIGRlcHJlY2F0ZWQsIHVzZSBgbW9kdWxlc2AgaW5zdGVhZCcpOwoKICAgIC8vIGJ1aWxkIG1vZHVsZXMgbGlzdAogICAgdmFyIGF1dG9sb2FkID0gW107CiAgICB2YXIgbW9kdWxlcyA9IG1lcmdlKGNvbmZpZy5wYXRoLCBjb25maWcubW9kdWxlcywgewogICAgICBiYXNpczogYmFzaXNGaWxlbmFtZQogICAgfSk7CgogICAgLy8gcmVzZXQgbW9kdWxlcwogICAgY29uZmlnLm1vZHVsZXMgPSB7fTsKCiAgICAvLyBwcm9jZXNzIGF1dG9sb2FkCiAgICBpZiAoY29uZmlnLmF1dG9sb2FkKQogICAgewogICAgICAvLyBbcGF0aC90by9dW25hbWVdWy5yZXN0LmV4dF0gLT4gewogICAgICAvLyAgIG5hbWU6IG5hbWUsCiAgICAgIC8vICAgZmlsZW5hbWU6IHBhdGggKyBuYW1lICsgcmVzdAogICAgICAvLyB9CgogICAgICB2YXIgbSA9IFN0cmluZyhjb25maWcuYXV0b2xvYWQpLm1hdGNoKC9eKCg/OlteXC9dKlwvKSopKFthLXokX11bYS16MC05JF9dKikoKD86XC5bYS16JF9dW2EtejAtOSRfXSopKikkL2kpOwogICAgICBpZiAobSkKICAgICAgewogICAgICAgIG1vZHVsZXNbbVsyXV0gPSB7CiAgICAgICAgICBhdXRvbG9hZDogdHJ1ZSwKICAgICAgICAgIGZpbGVuYW1lOiBtWzFdICsgbVsyXSArIChtWzNdIHx8ICcuanMnKQogICAgICAgIH07CiAgICAgIH0KICAgICAgZWxzZQogICAgICB7CiAgICAgICAgLyoqIEBjdXQgKi8gY29uc29sZU1ldGhvZHMud2FybignYmFzaXMtY29uZmlnOiB3cm9uZyBgYXV0b2xvYWRgIHZhbHVlIChzZXR0aW5nIGlnbm9yZWQpOiAnICsgY29uZmlnLmF1dG9sb2FkKTsKICAgICAgfQoKICAgICAgZGVsZXRlIGNvbmZpZy5hdXRvbG9hZDsKICAgIH0KCiAgICAvLyBwcm9jZXNzIG1vZHVsZXMKICAgIGZvciAodmFyIG5hbWUgaW4gbW9kdWxlcykKICAgIHsKICAgICAgLy8gbmFtZTogewogICAgICAvLyAgIGF1dG9sb2FkOiBib29sZWFuLAogICAgICAvLyAgIHBhdGg6ICdwYXRoL3RvJywKICAgICAgLy8gICBmaWxlbmFtZTogJ21vZHVsZS5qcycKICAgICAgLy8gfQogICAgICAvLwogICAgICAvLyBvcgogICAgICAvLwogICAgICAvLyBuYW1lOiAnZmlsZW5hbWUnCgogICAgICB2YXIgbW9kdWxlID0gbW9kdWxlc1tuYW1lXTsKCiAgICAgIC8vIGlmIHZhbHVlIGlzIHN0cmluZywgY29udmVydCB0byBjb25maWcKICAgICAgaWYgKHR5cGVvZiBtb2R1bGUgPT0gJ3N0cmluZycpCiAgICAgICAgLy8gdmFsdWUgaXMgZmlsZW5hbWUKICAgICAgICBtb2R1bGUgPSB7CiAgICAgICAgICAvLyBpZiBwYXRoIGVuZHMgd2l0aCBgL2AgYWRkIGBbbmFtZV0uanNgIHRvIHRoZSBlbmQKICAgICAgICAgIGZpbGVuYW1lOiBtb2R1bGUucmVwbGFjZSgvXC8kLywgJy8nICsgbmFtZSArICcuanMnKQogICAgICAgIH07CgogICAgICAvLyBnZXQgYW5kIHJlc29sdmUgcGF0aCBhbmQgZmlsZW5hbWUKICAgICAgdmFyIGZpbGVuYW1lID0gbW9kdWxlLmZpbGVuYW1lOwogICAgICB2YXIgcGF0aCA9IG1vZHVsZS5wYXRoOwoKICAgICAgLy8gaWYgbm8gcGF0aCBidXQgZmlsZW5hbWUKICAgICAgLy8gbGV0IGZpbGVuYW1lIGVxdWFscyB0byAncGF0aC90by9maWxlWy5leHRdJywgdGhlbgogICAgICAvLyAgIHBhdGggPSAncGF0aC90by9maWxlJwogICAgICAvLyAgIGZpbGVuYW1lID0gJy4uL2ZpbGVbLmV4dF0nCiAgICAgIGlmIChmaWxlbmFtZSAmJiAhcGF0aCkKICAgICAgewogICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZmlsZW5hbWUpOwogICAgICAgIHBhdGggPSBmaWxlbmFtZS5zdWJzdHIoMCwgZmlsZW5hbWUubGVuZ3RoIC0gcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpLmxlbmd0aCk7CiAgICAgICAgZmlsZW5hbWUgPSAnLi4vJyArIHBhdGhVdGlscy5iYXNlbmFtZShmaWxlbmFtZSk7CiAgICAgIH0KCiAgICAgIC8vIHBhdGggc2hvdWxkIGJlIGFic29sdXRlCiAgICAgIC8vIGF0IHRoaXMgcG9pbnQgcGF0aCBpcyBkZWZpbmVkIGluIGFueSBjYXNlCiAgICAgIHBhdGggPSBwYXRoVXRpbHMucmVzb2x2ZShwYXRoKTsKCiAgICAgIC8vIGlmIG5vIGZpbGVuYW1lIGJ1dCBwYXRoCiAgICAgIC8vIGxldCBwYXRoIGVxdWFscyB0byAncGF0aC90by9maWxlWy5leHRdJywgdGhlbgogICAgICAvLyAgIHBhdGggPSAncGF0aC90bycKICAgICAgLy8gICBmaWxlbmFtZSA9ICdmaWxlWy5leHRdJwogICAgICBpZiAoIWZpbGVuYW1lICYmIHBhdGgpCiAgICAgIHsKICAgICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5iYXNlbmFtZShwYXRoKTsKICAgICAgICBwYXRoID0gcGF0aFV0aWxzLmRpcm5hbWUocGF0aCk7CiAgICAgIH0KCiAgICAgIC8vIGlmIGZpbGVuYW1lIGhhcyBubyBleHRlbnNpb24sIGFkZHMgYC5qc2AKICAgICAgaWYgKCFwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkpCiAgICAgICAgZmlsZW5hbWUgKz0gJy5qcyc7CgogICAgICAvLyByZXNvbHZlIGZpbGVuYW1lCiAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUocGF0aCwgZmlsZW5hbWUpOwoKICAgICAgLy8gc3RvcmUgcmVzdWx0cwogICAgICBjb25maWcubW9kdWxlc1tuYW1lXSA9IHsKICAgICAgICBwYXRoOiBwYXRoLAogICAgICAgIGZpbGVuYW1lOiBmaWxlbmFtZQogICAgICB9OwoKICAgICAgLy8gc3RvcmUgYXV0b2xvYWQgbW9kdWxlcwogICAgICBpZiAobW9kdWxlLmF1dG9sb2FkKQogICAgICB7CiAgICAgICAgY29uZmlnLmF1dG9sb2FkID0gYXV0b2xvYWQ7CiAgICAgICAgYXV0b2xvYWQucHVzaChuYW1lKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBjb25maWc7CiAgfQoKCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAvLyBPT1Agc2VjdGlvbjogQ2xhc3MgaW1wbGVtZW50YXRpb24KICAvLwoKICB2YXIgQ2xhc3MgPSAoZnVuY3Rpb24oKXsKCiAgIC8qKgogICAgKiBUaGlzIG5hbWVzcGFjZSBpbnRyb2R1Y2UgY2xhc3MgY3JlYXRpb24gc2NoZW1lLiBJdCByZWNvbWVuZGVkIGZvciBuZXcKICAgICogY2xhc3NlcyBjcmVhdGlvbiwgYnV0IHVzZSBhYmxlIHRvIHVzZSBidWlsZGluIHNoZW1lIGZvciB5b3VyIHB1cnBvc2VzLgogICAgKgogICAgKiBBbGwgQmFzaXMgY2xhc3NlcyBhbmQgY29tcG9uZW50cyAod2l0aCBzb21lIGV4Y2VwdGlvbnMpIGFyZQogICAgKiBidWlsZGluZyB1c2luZyB0aGlzIHNoZW1lLgogICAgKgogICAgKiBAZXhhbXBsZQogICAgKiAgIHZhciBGb28gPSBiYXNpcy5DbGFzcyhudWxsLCB7IC8vIHlvdSBjYW4gdXNlIGJhc2lzLkNsYXNzIGluc3RlYWQgb2YgbnVsbAogICAgKiAgICAgbmFtZTogJ2RlZmF1bHQgdmFsdWUnLAogICAgKiAgICAgaW5pdDogZnVuY3Rpb24odGl0bGUpeyAvLyBzcGVjaWFsIG1ldGhvZCAtIGNvbnN0cnVjdG9yCiAgICAqICAgICAgIHRoaXMudGl0bGUgPSB0aXRsZTsKICAgICogICAgIH0sCiAgICAqICAgICBzYXk6IGZ1bmN0aW9uKCl7CiAgICAqICAgICAgIHJldHVybiAnTXkgbmFtZSBpcyAnICsgdGhpcy50aXRsZTsKICAgICogICAgIH0KICAgICogICB9KTsKICAgICoKICAgICogICB2YXIgQmFyID0gYmFzaXMuQ2xhc3MoRm9vLCB7CiAgICAqICAgICBhZ2U6IDAsCiAgICAqICAgICBpbml0OiBmdW5jdGlvbih0aXRsZSwgYWdlKXsKICAgICogICAgICAgRm9vLnByb3RvdHlwZS5pbml0LmNhbGwodGhpcywgdGl0bGUpOwogICAgKiAgICAgICB0aGlzLmFnZSA9IGFnZTsKICAgICogICAgIH0sCiAgICAqICAgICBzYXk6IGZ1bmN0aW9uKCl7CiAgICAqICAgICAgIHJldHVybiBGb28ucHJvdG90eXBlLnNheS5jYWxsKHRoaXMpICsgJyBJXCdtICcgKyB0aGlzLmFnZSArICcgeWVhciBvbGQuJzsKICAgICogICAgIH0KICAgICogICB9KTsKICAgICoKICAgICogICB2YXIgZm9vID0gbmV3IEZvbygnSm9obicpOwogICAgKiAgIHZhciBiYXIgPSBuZXcgQmFyKCdJdmFuJywgMjUpOwogICAgKiAgIGNvbnNvbGUubG9nKGZvby5zYXkoKSk7IC8vIE15IG5hbWUgaXMgSm9obi4KICAgICogICBjb25zb2xlLmxvZyhiYXIuc2F5KCkpOyAvLyBNeSBuYW1lIGlzIEl2YW4uIEknbSAyNSB5ZWFyIG9sZC4KICAgICogICBjb25zb2xlLmxvZyhiYXIgaW5zdGFuY2VvZiBiYXNpcy5DbGFzcyk7IC8vIHRydWUKICAgICogICBjb25zb2xlLmxvZyhiYXIgaW5zdGFuY2VvZiBGb28pOyAvLyB0cnVlCiAgICAqICAgY29uc29sZS5sb2coYmFyIGluc3RhbmNlb2YgQmFyKTsgLy8gdHJ1ZQogICAgKgogICAgKiBAbmFtZXNwYWNlIGJhc2lzLkNsYXNzCiAgICAqLwoKICAgLyoqCiAgICAqIEdsb2JhbCBpbnN0YW5jZXMgc2VlZC4KICAgICovCiAgICB2YXIgaW5zdGFuY2VTZWVkID0geyBpZDogMSB9OwogICAgdmFyIGNsYXNzU2VlZCA9IDE7CiAgICAvKiogQGN1dCAqLyB2YXIgY2xhc3NlcyA9IFtdOwoKICAgLyoqCiAgICAqIENsYXNzIGNvbnN0cnVjdCBoZWxwZXI6IHNlbGYgcmVmZXJlbmNlIHZhbHVlCiAgICAqLwogICAgdmFyIFNFTEYgPSB7fTsKCiAgIC8qKgogICAgKiBUZXN0IG9iamVjdCBpcyBpdCBhIGNsYXNzLgogICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0CiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiBvYmplY3QgaXMgY2xhc3MuCiAgICAqLwogICAgZnVuY3Rpb24gaXNDbGFzcyhvYmplY3QpewogICAgICByZXR1cm4gdHlwZW9mIG9iamVjdCA9PSAnZnVuY3Rpb24nICYmICEhb2JqZWN0LmJhc2lzQ2xhc3NJZF87CiAgICB9CgogICAvKioKICAgICogQHBhcmFtIHtmdW5jdGlvbigpfSBzdXBlckNsYXNzCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAgZnVuY3Rpb24gaXNTdWJjbGFzc09mKHN1cGVyQ2xhc3MpewogICAgICB2YXIgY3Vyc29yID0gdGhpczsKCiAgICAgIHdoaWxlIChjdXJzb3IgJiYgY3Vyc29yICE9PSBzdXBlckNsYXNzKQogICAgICAgIGN1cnNvciA9IGN1cnNvci5zdXBlckNsYXNzXzsKCiAgICAgIHJldHVybiBjdXJzb3IgPT09IHN1cGVyQ2xhc3M7CiAgICB9CgogICAvKioKICAgICogZGV2IG1vZGUgb25seQogICAgKi8KICAgIGZ1bmN0aW9uIGRldlZlcmJvc2VOYW1lKG5hbWUsIGFyZ3MsIGZuKXsKICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbihrZXlzKGFyZ3MpLCAncmV0dXJuIHsiJyArIG5hbWUgKyAnIjogJyArIGZuICsgJ1xufVsiJyArIG5hbWUgKyAnIl0nKS5hcHBseShudWxsLCB2YWx1ZXMoYXJncykpOwogICAgfQoKCiAgICAvLyB0ZXN0IGlzIHRvU3RyaW5nIHByb3BlcnR5IGVudW1lcmFibGUKICAgIHZhciBUT1NUUklOR19CVUcgPSAoZnVuY3Rpb24oKXsKICAgICAgZm9yICh2YXIga2V5IGluIHsgdG9TdHJpbmc6IDEgfSkKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSkoKTsKCgogICAvKioKICAgICogQ2xhc3MgY29uc3RydWN0b3IuCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gU3VwZXJDbGFzcyBDbGFzcyB0aGF0IG5ldyBvbmUgaW5oZXJpdHMgb2YuCiAgICAqIEBwYXJhbSB7Li4ub2JqZWN0fSBleHRlbnNpb25zIE9iamVjdHMgdGhhdCBleHRlbmRzIG5ldyBjbGFzcyBwcm90b3R5cGUuCiAgICAqIEByZXR1cm4ge2Z1bmN0aW9uKCl9IEEgbmV3IGNsYXNzLgogICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUNsYXNzKFN1cGVyQ2xhc3MsIGV4dGVuc2lvbnMpewogICAgICB2YXIgY2xhc3NJZCA9IGNsYXNzU2VlZCsrOwoKICAgICAgaWYgKHR5cGVvZiBTdXBlckNsYXNzICE9ICdmdW5jdGlvbicpCiAgICAgICAgU3VwZXJDbGFzcyA9IEJhc2VDbGFzczsKCiAgICAgIC8qKiBAY3V0ICovIHZhciBjbGFzc05hbWUgPSAnJzsKCiAgICAgIC8qKiBAY3V0ICovIGZvciAodmFyIGkgPSAxLCBleHRlbnNpb247IGV4dGVuc2lvbiA9IGFyZ3VtZW50c1tpXTsgaSsrKQogICAgICAvKiogQGN1dCAqLyAgIGlmICh0eXBlb2YgZXh0ZW5zaW9uICE9ICdmdW5jdGlvbicgJiYgZXh0ZW5zaW9uLmNsYXNzTmFtZSkKICAgICAgLyoqIEBjdXQgKi8gICAgIGNsYXNzTmFtZSA9IGV4dGVuc2lvbi5jbGFzc05hbWU7CgogICAgICAvKiogQGN1dCAqLyBpZiAoIWNsYXNzTmFtZSkKICAgICAgLyoqIEBjdXQgKi8gICBjbGFzc05hbWUgPSBTdXBlckNsYXNzLmNsYXNzTmFtZSArICcuX0NsYXNzJyArIGNsYXNzSWQ7CiAgICAgIC8qKiBAY3V0ICovIC8vIGNvbnNvbGVNZXRob2RzLndhcm4oJ0NsYXNzIGhhcyBubyBuYW1lJyk7CgogICAgICAvLyB0ZW1wIGNsYXNzIGNvbnN0cnVjdG9yIHdpdGggbm8gaW5pdCBjYWxsCiAgICAgIHZhciBOZXdDbGFzc1Byb3RvID0gZnVuY3Rpb24oKXt9OwoKICAgICAgLy8gdmVyYm9zZSBuYW1lIGluIGRldgogICAgICAvKiogQGN1dCAqLyBOZXdDbGFzc1Byb3RvID0gZGV2VmVyYm9zZU5hbWUoY2xhc3NOYW1lLCB7fSwgTmV3Q2xhc3NQcm90byk7CgogICAgICBOZXdDbGFzc1Byb3RvLnByb3RvdHlwZSA9IFN1cGVyQ2xhc3MucHJvdG90eXBlOwoKICAgICAgdmFyIG5ld1Byb3RvID0gbmV3IE5ld0NsYXNzUHJvdG87CiAgICAgIHZhciBuZXdDbGFzc1Byb3BzID0gewogICAgICAgIC8qKiBAY3V0ICovIGNsYXNzTmFtZTogY2xhc3NOYW1lLAoKICAgICAgICBiYXNpc0NsYXNzSWRfOiBjbGFzc0lkLAogICAgICAgIHN1cGVyQ2xhc3NfOiBTdXBlckNsYXNzLAogICAgICAgIGV4dGVuZENvbnN0cnVjdG9yXzogISFTdXBlckNsYXNzLmV4dGVuZENvbnN0cnVjdG9yXywKCiAgICAgICAgLy8gY2xhc3MgbWV0aG9kcwogICAgICAgIGlzU3ViY2xhc3NPZjogaXNTdWJjbGFzc09mLAogICAgICAgIHN1YmNsYXNzOiBmdW5jdGlvbigpewogICAgICAgICAgcmV0dXJuIGNyZWF0ZUNsYXNzLmFwcGx5KG51bGwsIFtuZXdDbGFzc10uY29uY2F0KGFycmF5RnJvbShhcmd1bWVudHMpKSk7CiAgICAgICAgfSwKICAgICAgICBleHRlbmQ6IGV4dGVuZENsYXNzLAoKICAgICAgICAvLyBhdXRvIGV4dGVuZCBjcmVhdGVzIGEgc3ViY2xhc3MKICAgICAgICBfX2V4dGVuZF9fOiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUgIT09IFNFTEYgJiYgKHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyB8fCAodHlwZW9mIHZhbHVlID09ICdmdW5jdGlvbicgJiYgIWlzQ2xhc3ModmFsdWUpKSkpCiAgICAgICAgICAgIHJldHVybiBCYXNlQ2xhc3MuY3JlYXRlLmNhbGwobnVsbCwgbmV3Q2xhc3MsIHZhbHVlKTsKICAgICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0sCgogICAgICAgIC8vIG5ldyBjbGFzcyBwcm90b3R5cGUKICAgICAgICBwcm90b3R5cGU6IG5ld1Byb3RvCiAgICAgIH07CgogICAgICAvLyBleHRlbmQgbmV3Q2xhc3MgcHJvdG90eXBlCiAgICAgIGZvciAodmFyIGkgPSAxLCBleHRlbnNpb247IGV4dGVuc2lvbiA9IGFyZ3VtZW50c1tpXTsgaSsrKQogICAgICAgIG5ld0NsYXNzUHJvcHMuZXh0ZW5kKGV4dGVuc2lvbik7CgogICAgICAvKiogQGN1dCAqL2lmIChuZXdQcm90by5pbml0ICE9PSBCYXNlQ2xhc3MucHJvdG90eXBlLmluaXQgJiYgIS9eZnVuY3Rpb25bXihdKlwoXCkvLnRlc3QobmV3UHJvdG8uaW5pdCkgJiYgbmV3Q2xhc3NQcm9wcy5leHRlbmRDb25zdHJ1Y3Rvcl8pIGNvbnNvbGVNZXRob2RzLndhcm4oJ3Byb2JhYmx5IHdyb25nIGV4dGVuZENvbnN0cnVjdG9yXyB2YWx1ZSBmb3IgJyArIG5ld0NsYXNzUHJvcHMuY2xhc3NOYW1lKTsKCiAgICAgIC8vIG5ldyBjbGFzcyBjb25zdHJ1Y3RvcgogICAgICB2YXIgbmV3Q2xhc3MgPSBuZXdDbGFzc1Byb3BzLmV4dGVuZENvbnN0cnVjdG9yXwogICAgICAgIC8vIGNvbnN0cnVjdG9yIHdpdGggaW5zdGFuY2UgZXh0ZW5zaW9uCiAgICAgICAgPyBmdW5jdGlvbihleHRlbmQpewogICAgICAgICAgICAvLyBtYXJrIG9iamVjdAogICAgICAgICAgICB0aGlzLmJhc2lzT2JqZWN0SWQgPSBpbnN0YW5jZVNlZWQuaWQrKzsKCiAgICAgICAgICAgIC8vIGV4dGVuZCBhbmQgb3ZlcnJpZGUgaW5zdGFuY2UgcHJvcGVydGllcwogICAgICAgICAgICB2YXIgcHJvcDsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGV4dGVuZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgIHByb3AgPSB0aGlzW2tleV07CiAgICAgICAgICAgICAgdGhpc1trZXldID0gcHJvcCAmJiBwcm9wLl9fZXh0ZW5kX18KICAgICAgICAgICAgICAgID8gcHJvcC5fX2V4dGVuZF9fKGV4dGVuZFtrZXldKQogICAgICAgICAgICAgICAgOiBleHRlbmRba2V5XTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY2FsbCBjb25zdHJ1Y3RvcgogICAgICAgICAgICB0aGlzLmluaXQoKTsKCiAgICAgICAgICAgIC8vIHBvc3QgaW5pdAogICAgICAgICAgICB0aGlzLnBvc3RJbml0KCk7CiAgICAgICAgICB9CgogICAgICAgIC8vIHNpbXBsZSBjb25zdHJ1Y3RvcgogICAgICAgIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgLy8gbWFyayBvYmplY3QKICAgICAgICAgICAgdGhpcy5iYXNpc09iamVjdElkID0gaW5zdGFuY2VTZWVkLmlkKys7CgogICAgICAgICAgICAvLyBjYWxsIGNvbnN0cnVjdG9yCiAgICAgICAgICAgIHRoaXMuaW5pdC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICAgICAgLy8gcG9zdCBpbml0CiAgICAgICAgICAgIHRoaXMucG9zdEluaXQoKTsKICAgICAgICAgIH07CgogICAgICAvLyB2ZXJib3NlIG5hbWUgaW4gZGV2CiAgICAgIC8vIE5PVEU6IHRoaXMgY29kZSBtYWtlcyBDaHJvbWUgYW5kIEZpcmVmb3ggc2hvdyBjbGFzcyBuYW1lIGluIGNvbnNvbGUKICAgICAgLyoqIEBjdXQgKi8gbmV3Q2xhc3MgPSBkZXZWZXJib3NlTmFtZShjbGFzc05hbWUsIHsgaW5zdGFuY2VTZWVkOiBpbnN0YW5jZVNlZWQgfSwgbmV3Q2xhc3MpOwoKICAgICAgLy8gYWRkIGNvbnN0cnVjdG9yIHByb3BlcnR5IHRvIHByb3RvdHlwZQogICAgICBuZXdQcm90by5jb25zdHJ1Y3RvciA9IG5ld0NsYXNzOwoKICAgICAgZm9yICh2YXIga2V5IGluIG5ld1Byb3RvKQogICAgICAgIGlmIChuZXdQcm90b1trZXldID09PSBTRUxGKQogICAgICAgICAgbmV3UHJvdG9ba2V5XSA9IG5ld0NsYXNzOwogICAgICAgIC8vZWxzZQogICAgICAgIC8vICBuZXdQcm90b1trZXldID0gbmV3UHJvdG9ba2V5XTsKCiAgICAgIC8vIGV4dGVuZCBjb25zdHJ1Y3RvciB3aXRoIHByb3BlcnRpZXMKICAgICAgZXh0ZW5kKG5ld0NsYXNzLCBuZXdDbGFzc1Byb3BzKTsKCiAgICAgIC8vIGZvciBjbGFzcyBpbnRyb3NwZWN0aW9uCiAgICAgIC8qKiBAY3V0ICovIGNsYXNzZXMucHVzaChuZXdDbGFzcyk7CgogICAgICAvLyByZXR1cm4gbmV3IGNsYXNzCiAgICAgIHJldHVybiBuZXdDbGFzczsKICAgIH0KCiAgIC8qKgogICAgKiBFeHRlbmQgY2xhc3MgcHJvdG90eXBlCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBzb3VyY2UgSWYgc291cmNlIGhhcyBhIHByb3RvdHlwZSwgaXQgd2lsbCBiZSB1c2VkIHRvIGV4dGVuZCBjdXJyZW50IHByb3RvdHlwZS4KICAgICogQHJldHVybiB7ZnVuY3Rpb24oKX0gUmV0dXJucyBgdGhpc2AuCiAgICAqLwogICAgZnVuY3Rpb24gZXh0ZW5kQ2xhc3Moc291cmNlKXsKICAgICAgdmFyIHByb3RvID0gdGhpcy5wcm90b3R5cGU7CgogICAgICBpZiAodHlwZW9mIHNvdXJjZSA9PSAnZnVuY3Rpb24nICYmICFpc0NsYXNzKHNvdXJjZSkpCiAgICAgICAgc291cmNlID0gc291cmNlKHRoaXMuc3VwZXJDbGFzc18ucHJvdG90eXBlLCBzbGljZShwcm90bykpOwoKICAgICAgaWYgKHNvdXJjZS5wcm90b3R5cGUpCiAgICAgICAgc291cmNlID0gc291cmNlLnByb3RvdHlwZTsKCiAgICAgIGZvciAodmFyIGtleSBpbiBzb3VyY2UpCiAgICAgIHsKICAgICAgICB2YXIgdmFsdWUgPSBzb3VyY2Vba2V5XTsKICAgICAgICB2YXIgcHJvdG9WYWx1ZSA9IHByb3RvW2tleV07CgogICAgICAgIGlmIChrZXkgPT0gJ2NsYXNzTmFtZScgfHwga2V5ID09ICdleHRlbmRDb25zdHJ1Y3Rvcl8nKQogICAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgIGlmIChwcm90b1ZhbHVlICYmIHByb3RvVmFsdWUuX19leHRlbmRfXykKICAgICAgICAgICAgcHJvdG9ba2V5XSA9IHByb3RvVmFsdWUuX19leHRlbmRfXyh2YWx1ZSk7CiAgICAgICAgICBlbHNlCiAgICAgICAgICB7CiAgICAgICAgICAgIHByb3RvW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgLy8vKiogQGN1dCAqLyBpZiAodmFsdWUgJiYgIXZhbHVlLl9fZXh0ZW5kX18gJiYgKHZhbHVlLmNvbnN0cnVjdG9yID09IE9iamVjdCB8fCB2YWx1ZS5jb25zdHJ1Y3RvciA9PSBBcnJheSkpeyBjb25zb2xlTWV0aG9kcy53YXJuKCchJyArIGtleSk7IH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIGZvciBicm93c2VycyB0aGF0IGRvZXNuJ3QgZW51bSB0b1N0cmluZwogICAgICBpZiAoVE9TVFJJTkdfQlVHICYmIHNvdXJjZVtrZXkgPSAndG9TdHJpbmcnXSAhPT0gdG9TdHJpbmcpCiAgICAgICAgcHJvdG9ba2V5XSA9IHNvdXJjZVtrZXldOwoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgoKICAgIC8vCiAgICAvLyBiYXNlIGNsYXNzCiAgICAvLwogICAgdmFyIEJhc2VDbGFzcyA9IGV4dGVuZChjcmVhdGVDbGFzcywgewogICAgICBjbGFzc05hbWU6ICdiYXNpcy5DbGFzcycsCgogICAgICAvLyBub24tYXV0byBleHRlbmQgYnkgZGVmYXVsdAogICAgICBleHRlbmRDb25zdHJ1Y3Rvcl86IGZhbHNlLAoKICAgICAgLy8gcHJvdG90eXBlIGRlZmF1bHRzCiAgICAgIHByb3RvdHlwZTogewogICAgICAgIGJhc2lzT2JqZWN0SWQ6IDAsCgogICAgICAgIGNvbnN0cnVjdG9yOiBudWxsLAoKICAgICAgICBpbml0OiBmdW5jdGlvbigpewogICAgICAgIH0sCiAgICAgICAgcG9zdEluaXQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgfSwKCiAgICAgICAgLyoqIEBjdXQgKi8gdG9TdHJpbmc6IGZ1bmN0aW9uKCl7IC8vIHZlcmJvc2UgaW4gZGV2CiAgICAgICAgLyoqIEBjdXQgKi8gICByZXR1cm4gJ1tvYmplY3QgJyArICh0aGlzLmNvbnN0cnVjdG9yIHx8IHRoaXMpLmNsYXNzTmFtZSArICddJzsKICAgICAgICAvKiogQGN1dCAqLyB9LAoKICAgICAgICBkZXN0cm95OiBmdW5jdGlvbigpewogICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiB0aGlzKQogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCBwcm9wKSkKICAgICAgICAgICAgICB0aGlzW3Byb3BdID0gbnVsbDsKCiAgICAgICAgICB0aGlzLmRlc3Ryb3kgPSAkdW5kZWY7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKCgogICAvKioKICAgICogQHBhcmFtIHtvYmplY3R9IGV4dGVuc2lvbgogICAgKiBAcGFyYW0ge2Z1bmN0aW9uKCk9fSBmbgogICAgKiBAcGFyYW0ge3N0cmluZ30gZGV2TmFtZSBEZXYgb25seQogICAgKiBAcmV0dXJuIHtvYmplY3R9CiAgICAqLwogICAgdmFyIGN1c3RvbUV4dGVuZFByb3BlcnR5ID0gZnVuY3Rpb24oZXh0ZW5zaW9uLCBmbiwgZGV2TmFtZSl7CiAgICAgIHJldHVybiB7CiAgICAgICAgX19leHRlbmRfXzogZnVuY3Rpb24oZXh0ZW5zaW9uKXsKICAgICAgICAgIGlmICghZXh0ZW5zaW9uKQogICAgICAgICAgICByZXR1cm4gZXh0ZW5zaW9uOwoKICAgICAgICAgIGlmIChleHRlbnNpb24gJiYgZXh0ZW5zaW9uLl9fZXh0ZW5kX18pCiAgICAgICAgICAgIHJldHVybiBleHRlbnNpb247CgogICAgICAgICAgdmFyIEJhc2UgPSBmdW5jdGlvbigpe307CiAgICAgICAgICAvKiogQGN1dCB2ZXJib3NlIG5hbWUgaW4gZGV2ICovIEJhc2UgPSBkZXZWZXJib3NlTmFtZShkZXZOYW1lIHx8ICdjdXN0b21FeHRlbmRQcm9wZXJ0eScsIHt9LCBCYXNlKTsKICAgICAgICAgIEJhc2UucHJvdG90eXBlID0gdGhpczsKCiAgICAgICAgICB2YXIgcmVzdWx0ID0gbmV3IEJhc2U7CgogICAgICAgICAgZm4ocmVzdWx0LCBleHRlbnNpb24pOwoKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICB9Ll9fZXh0ZW5kX18oZXh0ZW5zaW9uIHx8IHt9KTsKICAgIH07CgoKICAgLyoqCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBleHRlbnNpb24KICAgICogQHJldHVybiB7b2JqZWN0fQogICAgKi8KICAgIHZhciBleHRlbnNpYmxlUHJvcGVydHkgPSBmdW5jdGlvbihleHRlbnNpb24pewogICAgICByZXR1cm4gY3VzdG9tRXh0ZW5kUHJvcGVydHkoZXh0ZW5zaW9uLCBleHRlbmQsICdleHRlbnNpYmxlUHJvcGVydHknKTsKICAgIH07CgoKICAgLyoqCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBleHRlbnNpb24KICAgICogQHJldHVybiB7b2JqZWN0fQogICAgKi8KICAgIHZhciBuZXN0ZWRFeHRlbmRQcm9wZXJ0eSA9IGZ1bmN0aW9uKGV4dGVuc2lvbil7CiAgICAgIHJldHVybiBjdXN0b21FeHRlbmRQcm9wZXJ0eShleHRlbnNpb24sIGZ1bmN0aW9uKHJlc3VsdCwgZXh0ZW5zaW9uKXsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXh0ZW5zaW9uKQogICAgICAgIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IHJlc3VsdFtrZXldOwogICAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZSAmJiB2YWx1ZS5fX2V4dGVuZF9fCiAgICAgICAgICAgID8gdmFsdWUuX19leHRlbmRfXyhleHRlbnNpb25ba2V5XSkKICAgICAgICAgICAgOiBleHRlbnNpYmxlUHJvcGVydHkoZXh0ZW5zaW9uW2tleV0pOwogICAgICAgIH0KICAgICAgfSwgJ25lc3RlZEV4dGVuZFByb3BlcnR5Jyk7CiAgICB9OwoKICAgLyoqCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb24oKX0gZm4KICAgICogQHBhcmFtIHtvYmplY3Q9fSBrZXlzCiAgICAqIEByZXR1cm4ge29iamVjdH0KICAgICovCiAgICB2YXIgb25lRnVuY3Rpb25Qcm9wZXJ0eSA9IGZ1bmN0aW9uKGZuLCBrZXlzKXsKICAgICAgdmFyIGNyZWF0ZSA9IGZ1bmN0aW9uKGtleXMpewogICAgICAgIHZhciByZXN1bHQgPSB7CiAgICAgICAgICBfX2V4dGVuZF9fOiBjcmVhdGUKICAgICAgICB9OwoKICAgICAgICBpZiAoa2V5cykKICAgICAgICB7CiAgICAgICAgICBpZiAoa2V5cy5fX2V4dGVuZF9fKQogICAgICAgICAgICByZXR1cm4ga2V5czsKCiAgICAgICAgICAvLyB2ZXJib3NlIG5hbWUgaW4gZGV2CiAgICAgICAgICAvKiogQGN1dCAqLyB2YXIgQ2xzID0gZGV2VmVyYm9zZU5hbWUoJ29uZUZ1bmN0aW9uUHJvcGVydHknLCB7fSwgZnVuY3Rpb24oKXt9KTsKICAgICAgICAgIC8qKiBAY3V0ICovIHJlc3VsdCA9IG5ldyBDbHM7CiAgICAgICAgICAvKiogQGN1dCAqLyByZXN1bHQuX19leHRlbmRfXyA9IGNyZWF0ZTsKCiAgICAgICAgICBmb3IgKHZhciBrZXkgaW4ga2V5cykKICAgICAgICAgICAgaWYgKGtleXNba2V5XSkKICAgICAgICAgICAgICByZXN1bHRba2V5XSA9IGZuOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKCiAgICAgIHJldHVybiBjcmVhdGUoa2V5cyB8fCB7fSk7CiAgICB9OwoKCiAgICAvLwogICAgLy8gZXhwb3J0IG5hbWVzCiAgICAvLwoKICAgIHJldHVybiBleHRlbmQoQmFzZUNsYXNzLCB7CiAgICAgIC8qKiBAY3V0ICovIGFsbF86IGNsYXNzZXMsCgogICAgICBTRUxGOiBTRUxGLAoKICAgICAgY3JlYXRlOiBjcmVhdGVDbGFzcywKICAgICAgaXNDbGFzczogaXNDbGFzcywKCiAgICAgIGN1c3RvbUV4dGVuZFByb3BlcnR5OiBjdXN0b21FeHRlbmRQcm9wZXJ0eSwKICAgICAgZXh0ZW5zaWJsZVByb3BlcnR5OiBleHRlbnNpYmxlUHJvcGVydHksCiAgICAgIG5lc3RlZEV4dGVuZFByb3BlcnR5OiBuZXN0ZWRFeHRlbmRQcm9wZXJ0eSwKICAgICAgb25lRnVuY3Rpb25Qcm9wZXJ0eTogb25lRnVuY3Rpb25Qcm9wZXJ0eQogICAgfSk7CiAgfSkoKTsKCgogLyoqCiAgKiBAbmFtZXNwYWNlIGJhc2lzCiAgKi8KCiAvKioKICAqIEBjbGFzcwogICovCiAgdmFyIFRva2VuID0gQ2xhc3MobnVsbCwgewogICAgY2xhc3NOYW1lOiAnYmFzaXMuVG9rZW4nLAoKICAgLyoqCiAgICAqIEB0eXBlIHsqfQogICAgKi8KICAgIHZhbHVlOiBudWxsLAoKICAgLyoqCiAgICAqIEB0eXBlIHtvYmplY3R9CiAgICAqLwogICAgaGFuZGxlcjogbnVsbCwKCiAgIC8qKgogICAgKiBAdHlwZSB7YmFzaXMuRGVmZXJyZWRUb2tlbn0KICAgICovCiAgICBkZWZlcnJlZFRva2VuOiBudWxsLAoKICAgLyoqCiAgICAqIEJpbmRpbmcgaW50ZXJmYWNlLgogICAgKiBAdHlwZSB7b2JqZWN0fQogICAgKi8KICAgIGJpbmRpbmdCcmlkZ2U6IHsKICAgICAgYXR0YWNoOiBmdW5jdGlvbihob3N0LCBmbiwgY29udGV4dCl7CiAgICAgICAgaG9zdC5hdHRhY2goZm4sIGNvbnRleHQpOwogICAgICB9LAogICAgICBkZXRhY2g6IGZ1bmN0aW9uKGhvc3QsIGZuLCBjb250ZXh0KXsKICAgICAgICBob3N0LmRldGFjaChmbiwgY29udGV4dCk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oaG9zdCl7CiAgICAgICAgcmV0dXJuIGhvc3QuZ2V0KCk7CiAgICAgIH0KICAgIH0sCgogICAvKioKICAgICogQGNvbnN0cnVjdG9yCiAgICAqLwogICAgaW5pdDogZnVuY3Rpb24odmFsdWUpewogICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9LAoKICAgLyoqCiAgICAqIFJldHVybnMgdG9rZW4gdmFsdWUuCiAgICAqIEByZXR1cm4geyp9IEN1cnJlbnQgdG9rZW4gdmFsdWUuCiAgICAqLwogICAgZ2V0OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy52YWx1ZTsKICAgIH0sCgogICAvKioKICAgICogU2V0IG5ldyB2YWx1ZSBmb3IgdG9rZW4uIENhbGwgYXBwbHkgbWV0aG9kIGlmIHZhbHVlIGhhcyBiZWVuIGNoYW5nZWQuCiAgICAqIEBwYXJhbSB7Kn0gdmFsdWUKICAgICovCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKQogICAgICB7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgIHRoaXMuYXBwbHkoKTsKICAgICAgfQogICAgfSwKCiAgIC8qKgogICAgKiBBZGQgY2FsbGJhY2sgb24gdG9rZW4gdmFsdWUgY2hhbmdlcy4KICAgICogQHBhcmFtIHtmdW5jdGlvbih2YWx1ZSl9IGZuCiAgICAqIEBwYXJhbSB7b2JqZWN0PX0gY29udGV4dAogICAgKi8KICAgIGF0dGFjaDogZnVuY3Rpb24oZm4sIGNvbnRleHQpewogICAgICAvKiogQGN1dCAqLyB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgLyoqIEBjdXQgKi8gd2hpbGUgKGN1cnNvciA9IGN1cnNvci5oYW5kbGVyKQogICAgICAvKiogQGN1dCAqLyAgIGlmIChjdXJzb3IuZm4gPT09IGZuICYmIGN1cnNvci5jb250ZXh0ID09PSBjb250ZXh0KQogICAgICAvKiogQGN1dCAqLyAgICAgY29uc29sZU1ldGhvZHMud2FybignYmFzaXMuVG9rZW4jYXR0YWNoOiBkdXBsaWNhdGUgZm4gJiBjb250ZXh0IHBhaXInKTsKCiAgICAgIHRoaXMuaGFuZGxlciA9IHsKICAgICAgICBmbjogZm4sCiAgICAgICAgY29udGV4dDogY29udGV4dCwKICAgICAgICBoYW5kbGVyOiB0aGlzLmhhbmRsZXIKICAgICAgfTsKICAgIH0sCgogICAvKioKICAgICogUmVtb3ZlIGNhbGxiYWNrLiBNdXN0IGJlIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgZm9yIHtiYXNpcy5Ub2tlbiNhdHRhY2h9IG1ldGhvZC4KICAgICogQHBhcmFtIHtmdW5jdGlvbih2YWx1ZSl9IGZuCiAgICAqIEBwYXJhbSB7b2JqZWN0PX0gY29udGV4dAogICAgKi8KICAgIGRldGFjaDogZnVuY3Rpb24oZm4sIGNvbnRleHQpewogICAgICB2YXIgY3Vyc29yID0gdGhpczsKICAgICAgdmFyIHByZXY7CgogICAgICB3aGlsZSAocHJldiA9IGN1cnNvciwgY3Vyc29yID0gY3Vyc29yLmhhbmRsZXIpCiAgICAgICAgaWYgKGN1cnNvci5mbiA9PT0gZm4gJiYgY3Vyc29yLmNvbnRleHQgPT09IGNvbnRleHQpCiAgICAgICAgewogICAgICAgICAgLy8gbWFrZSBpdCBub24tY2FsbGFibGUKICAgICAgICAgIGN1cnNvci5mbiA9ICR1bmRlZjsKCiAgICAgICAgICAvLyByZW1vdmUgZnJvbSBsaXN0CiAgICAgICAgICBwcmV2LmhhbmRsZXIgPSBjdXJzb3IuaGFuZGxlcjsKCiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgLyoqIEBjdXQgKi8gY29uc29sZU1ldGhvZHMud2FybignYmFzaXMuVG9rZW4jZGV0YWNoOiBmbiAmIGNvbnRleHQgcGFpciBub3QgZm91bmQsIG5vdGhpbmcgd2FzIHJlbW92ZWQnKTsKICAgIH0sCgogICAvKioKICAgICogQ2FsbCBldmVyeSBhdHRhY2hlZCBjYWxsYmFja3Mgd2l0aCBjdXJyZW50IHRva2VuIHZhbHVlLgogICAgKi8KICAgIGFwcGx5OiBmdW5jdGlvbigpewogICAgICB2YXIgdmFsdWUgPSB0aGlzLmdldCgpOwogICAgICB2YXIgY3Vyc29yID0gdGhpczsKCiAgICAgIHdoaWxlIChjdXJzb3IgPSBjdXJzb3IuaGFuZGxlcikKICAgICAgICBjdXJzb3IuZm4uY2FsbChjdXJzb3IuY29udGV4dCwgdmFsdWUpOwogICAgfSwKCiAgIC8qKgogICAgKiBSZXR1cm5zIGRlZmVycmVkIHRva2VuIGJhc2VkIG9uIHRoaXMgdG9rZW4uIEV2ZXJ5IHRva2VuIGNhbiBoYXMKICAgICogb25seSBvbmUgaXQncyBvd24gZGVmZXJyZWQgdG9rZW4uCiAgICAqIEByZXR1cm4ge2Jhc2lzLkRlZmVycmVkVG9rZW59CiAgICAqLwogICAgZGVmZXJyZWQ6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciB0b2tlbiA9IHRoaXMuZGVmZXJyZWRUb2tlbjsKCiAgICAgIGlmICghdG9rZW4pCiAgICAgIHsKICAgICAgICB0b2tlbiA9IHRoaXMuZGVmZXJyZWRUb2tlbiA9IG5ldyBEZWZlcnJlZFRva2VuKHRoaXMudmFsdWUpOwogICAgICAgIHRoaXMuYXR0YWNoKHRva2VuLnNldCwgdG9rZW4pOwogICAgICB9CgogICAgICByZXR1cm4gdG9rZW47CiAgICB9LAoKICAgLyoqCiAgICAqIEFjdHVhbGx5IGl0J3Mgbm90IHJlcXVpcmUgaW52b2tlIGRlc3Ryb3kgbWV0aG9kIGZvciB0b2tlbiwgZ2FyYmFnZQogICAgKiBjb2xsZWN0b3IgaGF2ZSBubyBwcm9ibGVtcyB0byBmcmVlIHRva2VuJ3MgbWVtb3J5IHdoZW4gYWxsIHJlZmVyZW5jZXMKICAgICogdG8gdG9rZW4gYXJlIHJlbW92ZWQuCiAgICAqIEBkZXN0cnVjdG9yCiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24oKXsKICAgICAgaWYgKHRoaXMuZGVmZXJyZWRUb2tlbikKICAgICAgewogICAgICAgIHRoaXMuZGVmZXJyZWRUb2tlbi5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5kZWZlcnJlZFRva2VuID0gbnVsbDsKICAgICAgfQoKICAgICAgdGhpcy5oYW5kbGVyID0gbnVsbDsKICAgICAgdGhpcy52YWx1ZSA9IG51bGw7CiAgICAgIHRoaXMuYXR0YWNoID0gJHVuZGVmOwogICAgICB0aGlzLmRldGFjaCA9ICR1bmRlZjsKICAgIH0KICB9KTsKCiAgLy8KICAvLyBEZWZlcnJlZCB0b2tlbgogIC8vCgogIHZhciBhd2FpdFRvQXBwbHkgPSAoZnVuY3Rpb24oKXsKICAgIHZhciB0b2tlbnMgPSB7fTsKICAgIHZhciB0aW1lcjsKCiAgICBmdW5jdGlvbiBhcHBseVRva2VucygpewogICAgICB2YXIgbGlzdCA9IHRva2VuczsKCiAgICAgIC8vIHJlc2V0IGxpc3QgJiB0aW1lcgogICAgICB0b2tlbnMgPSB7fTsKICAgICAgdGltZXIgPSBudWxsOwoKICAgICAgLy8gY2FsbCBhcHBseSBtZXRob2QgZm9yIGFsbCB0b2tlbnMgaW4gdGhlIGxpc3QKICAgICAgZm9yICh2YXIga2V5IGluIGxpc3QpCiAgICAgICAgbGlzdFtrZXldLmFwcGx5KCk7CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uKHRva2VuKXsKICAgICAgaWYgKHRva2VuLmJhc2lzT2JqZWN0SWQgaW4gdG9rZW5zKQogICAgICAgIHJldHVybjsKCiAgICAgIHRva2Vuc1t0b2tlbi5iYXNpc09iamVjdElkXSA9IHRva2VuOwoKICAgICAgaWYgKCF0aW1lcikKICAgICAgICBzZXRJbW1lZGlhdGUoYXBwbHlUb2tlbnMpOwogICAgfTsKICB9KSgpOwoKIC8qKgogICogQGNsYXNzCiAgKi8KICB2YXIgRGVmZXJyZWRUb2tlbiA9IFRva2VuLnN1YmNsYXNzKHsKICAgIGNsYXNzTmFtZTogJ2Jhc2lzLkRlZmVycmVkVG9rZW4nLAoKICAgLyoqCiAgICAqIFNldCBuZXcgdmFsdWUgZm9yIHRva2VuIGFuZCBzY2hlZHVsZSB0byBjYWxsIGFwcGx5IG1ldGhvZC4KICAgICogQHBhcmFtIHsqfSB2YWx1ZQogICAgKi8KICAgIHNldDogZnVuY3Rpb24odmFsdWUpewogICAgICBpZiAodGhpcy52YWx1ZSAhPT0gdmFsdWUpCiAgICAgIHsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgYXdhaXRUb0FwcGx5KHRoaXMpOwogICAgICB9CiAgICB9LAoKICAgLyoqCiAgICAqIFRoYXQgbWV0aG9kIGZvciBEZWZlcnJlZFRva2VuIHJldHVybnMgdG9rZW4gaXRzZWxmLgogICAgKi8KICAgIGRlZmVycmVkOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9KTsKCgogIC8vCiAgLy8gUmVzb3VyY2VzCiAgLy8KCiAgdmFyIHJlc291cmNlcyA9IHt9OwogIHZhciByZXNvdXJjZUNvbnRlbnRDYWNoZSA9IHt9OwogIHZhciByZXNvdXJjZVBhdGNoID0ge307CiAgdmFyIHZpcnR1YWxSZXNvdXJjZVNlZWQgPSAxOwogIC8qKiBAY3V0ICovIHZhciByZXNvdXJjZVJlc29sdmluZ1N0YWNrID0gW107CiAgLyoqIEBjdXQgKi8gdmFyIHJlcXVpcmVzOwogIC8vIHZhciByZXNvdXJjZVVwZGF0ZU5vdGlmaWVyID0gZXh0ZW5kKG5ldyBUb2tlbigpLCB7CiAgLy8gICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKXsKICAvLyAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogIC8vICAgICB0aGlzLmFwcGx5KCk7CiAgLy8gICB9CiAgLy8gfSk7CgogIC8vIGFwcGx5IHByZWZldGNoZWQgcmVzb3VyY2VzIHRvIGNhY2hlCiAgKGZ1bmN0aW9uKCl7CiAgICB2YXIgbWFwID0gdHlwZW9mIF9fcmVzb3VyY2VzX18gIT0gJ3VuZGVmaW5lZCcgPyBfX3Jlc291cmNlc19fIDogbnVsbDsKICAgIGlmIChtYXApCiAgICB7CiAgICAgIGZvciAodmFyIGtleSBpbiBtYXApCiAgICAgICAgcmVzb3VyY2VDb250ZW50Q2FjaGVbcGF0aFV0aWxzLnJlc29sdmUoa2V5KV0gPSBtYXBba2V5XTsKCiAgICAgIC8vX19yZXNvdXJjZXNfXyA9IG51bGw7IC8vIHJlc2V0IHByZWZldGNoZWQgdG8gcmVkdWNlIG1lbW9yeSBsZWFrcwogICAgfQogIH0pKCk7CgogIGZ1bmN0aW9uIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKXsKICAgIHZhciBwYXRjaGVzID0gcmVzb3VyY2VQYXRjaFtyZXNvdXJjZS51cmxdOwoKICAgIGlmIChwYXRjaGVzKQogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGNoZXMubGVuZ3RoOyBpKyspCiAgICAgIHsKICAgICAgICAvKiogQGN1dCAqLyBjb25zb2xlTWV0aG9kcy5pbmZvKCdBcHBseSBwYXRjaCBmb3IgJyArIHJlc291cmNlLnVybCk7CiAgICAgICAgcGF0Y2hlc1tpXShyZXNvdXJjZS5nZXQoKSwgcmVzb3VyY2UudXJsKTsKICAgICAgfQogIH0KCiAgdmFyIGdldFJlc291cmNlQ29udGVudCA9IGZ1bmN0aW9uKHVybCwgaWdub3JlQ2FjaGUpewogICAgaWYgKGlnbm9yZUNhY2hlIHx8ICFyZXNvdXJjZUNvbnRlbnRDYWNoZS5oYXNPd25Qcm9wZXJ0eSh1cmwpKQogICAgewogICAgICB2YXIgcmVzb3VyY2VDb250ZW50ID0gJyc7CgogICAgICBpZiAoIU5PREVfRU5WKQogICAgICB7CiAgICAgICAgdmFyIHJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgIHJlcS5vcGVuKCdHRVQnLCB1cmwsIGZhbHNlKTsKICAgICAgICAvLyBzZXQgaWYtbW9kaWZpZWQtc2luY2UgaGVhZGVyIHNpbmNlIGJlZ2luaW5nIHByZXZlbnRzIGNhY2hlIHVzaW5nOwogICAgICAgIC8vIG90aGVyd2lzZSBicm93c2VyIGNvdWxkIG5ldmVyIGFzayBzZXJ2ZXIgZm9yIG5ldyBmaWxlIGNvbnRlbnQKICAgICAgICAvLyBhbmQgdXNlIGZpbGUgY29udGVudCBmcm9tIGNhY2hlCiAgICAgICAgcmVxLnNldFJlcXVlc3RIZWFkZXIoJ0lmLU1vZGlmaWVkLVNpbmNlJywgbmV3IERhdGUoMCkudG9HTVRTdHJpbmcoKSk7CiAgICAgICAgcmVxLnNldFJlcXVlc3RIZWFkZXIoJ1gtQmFzaXMtUmVzb3VyY2UnLCAxKTsKICAgICAgICByZXEuc2VuZCgnJyk7CgogICAgICAgIGlmIChyZXEuc3RhdHVzID49IDIwMCAmJiByZXEuc3RhdHVzIDwgNDAwKQogICAgICAgICAgcmVzb3VyY2VDb250ZW50ID0gcmVxLnJlc3BvbnNlVGV4dDsKICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgLyoqIEBjdXQgKi8gY29uc29sZU1ldGhvZHMuZXJyb3IoJ2Jhc2lzLnJlc291cmNlOiBVbmFibGUgdG8gbG9hZCAnICsgdXJsICsgJyAoc3RhdHVzIGNvZGUgJyArIHJlcS5zdGF0dXMgKyAnKScpOwogICAgICAgIH0KICAgICAgfQogICAgICBlbHNlCiAgICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgLy8gdHJ5IHRvIHVzZSBzcGVjaWFsIHJlYWQgZmlsZSBmdW5jdGlvbiwgaXQgbWF5IGJlIHByb3ZpZGVkIGJ5IHBhcmVudCBtb2R1bGUKICAgICAgICAgIHJlc291cmNlQ29udGVudCA9IHByb2Nlc3MuYmFzaXNqc1JlYWRGaWxlCiAgICAgICAgICAgID8gcHJvY2Vzcy5iYXNpc2pzUmVhZEZpbGUodXJsKQogICAgICAgICAgICA6IHJlcXVpcmUoJ2ZzJykucmVhZEZpbGVTeW5jKHVybCwgJ3V0Zi04Jyk7CiAgICAgICAgfSBjYXRjaChlKXsKICAgICAgICAgIC8qKiBAY3V0ICovIGNvbnNvbGVNZXRob2RzLmVycm9yKCdiYXNpcy5yZXNvdXJjZTogVW5hYmxlIHRvIGxvYWQgJyArIHVybCwgZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXNvdXJjZUNvbnRlbnRDYWNoZVt1cmxdID0gcmVzb3VyY2VDb250ZW50OwogICAgfQoKICAgIHJldHVybiByZXNvdXJjZUNvbnRlbnRDYWNoZVt1cmxdOwogIH07CgogIHZhciBjcmVhdGVSZXNvdXJjZSA9IGZ1bmN0aW9uKHJlc291cmNlVXJsLCBjb250ZW50KXsKICAgIHZhciBjb250ZW50VHlwZSA9IHBhdGhVdGlscy5leHRuYW1lKHJlc291cmNlVXJsKTsKICAgIHZhciBjb250ZW50V3JhcHBlciA9IGdldFJlc291cmNlLmV4dGVuc2lvbnNbY29udGVudFR5cGVdOwogICAgdmFyIGlzVmlydHVhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxOwogICAgdmFyIHJlc29sdmVkID0gZmFsc2U7CiAgICB2YXIgd3JhcHBlZCA9IGZhbHNlOwogICAgLyoqIEBjdXQgKi8gdmFyIHdyYXBwZWRDb250ZW50OwoKICAgIGlmIChpc1ZpcnR1YWwpCiAgICAgIHJlc291cmNlVXJsICs9ICcjdmlydHVhbCc7CgogICAgdmFyIHJlc291cmNlID0gZnVuY3Rpb24oKXsKICAgICAgLy8gaWYgcmVzb3VyY2UgcmVzb2x2ZWQsIGp1c3QgcmV0dXJuIGNvbnRlbnQKICAgICAgaWYgKHJlc29sdmVkKQogICAgICAgIHJldHVybiBjb250ZW50OwoKICAgICAgLy8gZmV0Y2ggdXJsIGNvbnRlbnQKICAgICAgdmFyIHVybENvbnRlbnQgPSBpc1ZpcnR1YWwgPyBjb250ZW50IDogZ2V0UmVzb3VyY2VDb250ZW50KHJlc291cmNlVXJsKTsKCiAgICAgIC8qKiBAY3V0ICAgIHJlY3Vyc2lvbiB3YXJuaW5nICovCiAgICAgIC8qKiBAY3V0ICovIHZhciBpZHggPSByZXNvdXJjZVJlc29sdmluZ1N0YWNrLmluZGV4T2YocmVzb3VyY2VVcmwpOwogICAgICAvKiogQGN1dCAqLyBpZiAoaWR4ICE9IC0xKQogICAgICAvKiogQGN1dCAqLyAgIGNvbnNvbGVNZXRob2RzLndhcm4oJ2Jhc2lzLnJlc291cmNlIHJlY3Vyc2lvbjonLCByZXNvdXJjZVJlc29sdmluZ1N0YWNrLnNsaWNlKGlkeCkuY29uY2F0KHJlc291cmNlVXJsKS5tYXAocGF0aFV0aWxzLnJlbGF0aXZlLCBwYXRoVXRpbHMpLmpvaW4oJyAtPiAnKSk7CiAgICAgIC8qKiBAY3V0ICovIHJlc291cmNlUmVzb2x2aW5nU3RhY2sucHVzaChyZXNvdXJjZVVybCk7CgogICAgICAvLyBpZiByZXNvdXJjZSB0eXBlIGhhcyB3cmFwcGVyIC0gd3JhcCBpdCwgb3IgdXNlIHVybCBjb250ZW50IGFzIHJlc3VsdAogICAgICBpZiAoY29udGVudFdyYXBwZXIpCiAgICAgIHsKICAgICAgICBpZiAoIXdyYXBwZWQpCiAgICAgICAgewogICAgICAgICAgd3JhcHBlZCA9IHRydWU7CiAgICAgICAgICBjb250ZW50ID0gY29udGVudFdyYXBwZXIodXJsQ29udGVudCwgcmVzb3VyY2VVcmwpOwogICAgICAgICAgLyoqIEBjdXQgKi8gd3JhcHBlZENvbnRlbnQgPSB1cmxDb250ZW50OwogICAgICAgIH0KICAgICAgfQogICAgICBlbHNlCiAgICAgIHsKICAgICAgICBjb250ZW50ID0gdXJsQ29udGVudDsKICAgICAgfQoKICAgICAgLy8gbWFyayBhcyByZXNvbHZlZCBhbmQgYXBwbHkgYmluZGVkIGZ1bmN0aW9ucwogICAgICByZXNvbHZlZCA9IHRydWU7CiAgICAgIGFwcGx5UmVzb3VyY2VQYXRjaGVzKHJlc291cmNlKTsKICAgICAgcmVzb3VyY2UuYXBwbHkoKTsKCiAgICAgIC8vIHJlc291cmNlVXBkYXRlTm90aWZpZXIudmFsdWUgPSByZXNvdXJjZVVybDsKICAgICAgLy8gcmVzb3VyY2VVcGRhdGVOb3RpZmllci5hcHBseSgpOwoKICAgICAgLyoqIEBjdXQgICAgcmVjdXJzaW9uIHdhcm5pbmcgKi8KICAgICAgLyoqIEBjdXQgKi8gcmVzb3VyY2VSZXNvbHZpbmdTdGFjay5wb3AoKTsKCiAgICAgIHJldHVybiBjb250ZW50OwogICAgfTsKCiAgICBleHRlbmQocmVzb3VyY2UsIGV4dGVuZChuZXcgVG9rZW4oKSwgewogICAgICB1cmw6IHJlc291cmNlVXJsLAogICAgICB0eXBlOiBjb250ZW50VHlwZSwKICAgICAgdmlydHVhbDogaXNWaXJ0dWFsLAoKICAgICAgZmV0Y2g6IGZ1bmN0aW9uKCl7CiAgICAgICAgcmV0dXJuIHJlc291cmNlKCk7CiAgICAgIH0sCiAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpewogICAgICAgIHJldHVybiAnW2Jhc2lzLnJlc291cmNlICcgKyByZXNvdXJjZVVybCArICddJzsKICAgICAgfSwKICAgICAgaXNSZXNvbHZlZDogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gcmVzb2x2ZWQ7CiAgICAgIH0sCiAgICAgIC8qKiBAY3V0ICovIGhhc0NoYW5nZXM6IGZ1bmN0aW9uKCl7CiAgICAgIC8qKiBAY3V0ICovICAgcmV0dXJuIGNvbnRlbnRXcmFwcGVyID8gcmVzb3VyY2VDb250ZW50Q2FjaGVbcmVzb3VyY2VVcmxdICE9PSB3cmFwcGVkQ29udGVudCA6IGZhbHNlOwogICAgICAvKiogQGN1dCAqLyB9LAogICAgICB1cGRhdGU6IGZ1bmN0aW9uKG5ld0NvbnRlbnQpewogICAgICAgIGlmICghcmVzb2x2ZWQgfHwgaXNWaXJ0dWFsIHx8IG5ld0NvbnRlbnQgIT0gcmVzb3VyY2VDb250ZW50Q2FjaGVbcmVzb3VyY2VVcmxdKQogICAgICAgIHsKICAgICAgICAgIGlmICghaXNWaXJ0dWFsKQogICAgICAgICAgICByZXNvdXJjZUNvbnRlbnRDYWNoZVtyZXNvdXJjZVVybF0gPSBuZXdDb250ZW50OwoKICAgICAgICAgIGlmIChjb250ZW50V3JhcHBlcikKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCF3cmFwcGVkICYmIGlzVmlydHVhbCkKICAgICAgICAgICAgICBjb250ZW50ID0gbmV3Q29udGVudDsKCiAgICAgICAgICAgIC8vIHdyYXAgY29udGVudCBvbmx5IGlmIGl0IHdyYXBwZWQgYWxyZWFkeSBhbmQgbm9uLXVwZGF0YWJsZQogICAgICAgICAgICBpZiAod3JhcHBlZCAmJiAhY29udGVudFdyYXBwZXIucGVybWFuZW50KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnRXcmFwcGVyKG5ld0NvbnRlbnQsIHJlc291cmNlVXJsLCBjb250ZW50KTsKICAgICAgICAgICAgICBhcHBseVJlc291cmNlUGF0Y2hlcyhyZXNvdXJjZSk7CiAgICAgICAgICAgICAgcmVzb3VyY2UuYXBwbHkoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZWxzZQogICAgICAgICAgewogICAgICAgICAgICBjb250ZW50ID0gbmV3Q29udGVudDsKICAgICAgICAgICAgcmVzb2x2ZWQgPSB0cnVlOwogICAgICAgICAgICBhcHBseVJlc291cmNlUGF0Y2hlcyhyZXNvdXJjZSk7CiAgICAgICAgICAgIHJlc291cmNlLmFwcGx5KCk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gcmVzb3VyY2VVcGRhdGVOb3RpZmllci52YWx1ZSA9IHJlc291cmNlVXJsOwogICAgICAgICAgLy8gcmVzb3VyY2VVcGRhdGVOb3RpZmllci5hcHBseSgpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcmVsb2FkOiBmdW5jdGlvbigpewogICAgICAgIGlmIChpc1ZpcnR1YWwpCiAgICAgICAgICByZXR1cm47CgogICAgICAgIHZhciBvbGRDb250ZW50ID0gcmVzb3VyY2VDb250ZW50Q2FjaGVbcmVzb3VyY2VVcmxdOwogICAgICAgIHZhciBuZXdDb250ZW50ID0gZ2V0UmVzb3VyY2VDb250ZW50KHJlc291cmNlVXJsLCB0cnVlKTsKCiAgICAgICAgaWYgKG5ld0NvbnRlbnQgIT0gb2xkQ29udGVudCkKICAgICAgICB7CiAgICAgICAgICByZXNvbHZlZCA9IGZhbHNlOwogICAgICAgICAgcmVzb3VyY2UudXBkYXRlKG5ld0NvbnRlbnQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbihzb3VyY2UpewogICAgICAgIGlmIChpc1ZpcnR1YWwpCiAgICAgICAgICBpZiAoc291cmNlKQogICAgICAgICAgICByZXR1cm4gY29udGVudFdyYXBwZXIgPyB3cmFwcGVkQ29udGVudCA6IGNvbnRlbnQ7CgogICAgICAgIHJldHVybiBzb3VyY2UgPyBnZXRSZXNvdXJjZUNvbnRlbnQocmVzb3VyY2VVcmwpIDogcmVzb3VyY2UoKTsKICAgICAgfSwKICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KXsKICAgICAgICBpZiAocmVzb2x2ZWQpCiAgICAgICAgewogICAgICAgICAgZm4uY2FsbChjb250ZXh0LCByZXNvdXJjZSgpKTsKCiAgICAgICAgICBpZiAoY29udGVudFdyYXBwZXIgJiYgY29udGVudFdyYXBwZXIucGVybWFuZW50KQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICByZXNvdXJjZS5hdHRhY2goZm4sIGNvbnRleHQpOwoKICAgICAgICByZXR1cm4gcmVzb3VyY2U7CiAgICAgIH0KICAgIH0pKTsKCiAgICAvLyBjYWNoZSBpdAogICAgcmVzb3VyY2VzW3Jlc291cmNlVXJsXSA9IHJlc291cmNlOwoKICAgIHJldHVybiByZXNvdXJjZTsKICB9OwoKIC8qKgogICogQG5hbWUgcmVzb3VyY2UKICAqLwogIHZhciBnZXRSZXNvdXJjZSA9IGZ1bmN0aW9uKHJlc291cmNlVXJsKXsKICAgIHZhciByZXNvdXJjZSA9IHJlc291cmNlc1tyZXNvdXJjZVVybF07CgogICAgaWYgKHJlc291cmNlKQogICAgICByZXR1cm4gcmVzb3VyY2U7CgogICAgLyoqIEBjdXQgKi8gaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHJlc291cmNlVXJsKSkKICAgIC8qKiBAY3V0ICovICAgY29uc29sZU1ldGhvZHMud2FybignQmFkIHVzYWdlOiBiYXNpcy5yZXNvdXJjZShcJycgKyByZXNvdXJjZVVybCArICdcJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLicpOwoKICAgIC8vIHRyeSByZXNvbHZlIHJlc291cmNlIHBhdGgKICAgIHJlc291cmNlVXJsID0gcGF0aFV0aWxzLnJlc29sdmUocmVzb3VyY2VVcmwpOwogICAgcmVzb3VyY2UgPSByZXNvdXJjZXNbcmVzb3VyY2VVcmxdOwoKICAgIC8vIHJldHVybiByZXNvdXJjZSBvciBjcmVhdGUgaXQKICAgIHJldHVybiByZXNvdXJjZSB8fCBjcmVhdGVSZXNvdXJjZShyZXNvdXJjZVVybCk7CiAgfTsKCiAgZXh0ZW5kKGdldFJlc291cmNlLCB7CiAgICAvLyBvblVwZGF0ZTogZnVuY3Rpb24oZm4sIGNvbnRleHQpewogICAgLy8gICByZXNvdXJjZVVwZGF0ZU5vdGlmaWVyLmF0dGFjaChmbiwgY29udGV4dCk7CiAgICAvLyB9LAogICAgaXNSZXNvdXJjZTogZnVuY3Rpb24odmFsdWUpewogICAgICByZXR1cm4gdmFsdWUgPyByZXNvdXJjZXNbdmFsdWUudXJsXSA9PT0gdmFsdWUgOiBmYWxzZTsKICAgIH0sCiAgICBpc1Jlc29sdmVkOiBmdW5jdGlvbihyZXNvdXJjZVVybCl7CiAgICAgIHZhciByZXNvdXJjZSA9IGdldFJlc291cmNlLmdldChyZXNvdXJjZVVybCk7CgogICAgICByZXR1cm4gcmVzb3VyY2UgPyByZXNvdXJjZS5pc1Jlc29sdmVkKCkgOiBmYWxzZTsKICAgIH0sCiAgICBleGlzdHM6IGZ1bmN0aW9uKHJlc291cmNlVXJsKXsKICAgICAgLyoqIEBjdXQgKi8gaWYgKCEvXihcLlwvfFwuXC58XC8pLy50ZXN0KHJlc291cmNlVXJsKSkKICAgICAgLyoqIEBjdXQgKi8gICBjb25zb2xlTWV0aG9kcy53YXJuKCdCYWQgdXNhZ2U6IGJhc2lzLnJlc291cmNlLmV4aXN0cyhcJycgKyByZXNvdXJjZVVybCArICdcJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLicpOwoKICAgICAgcmV0dXJuIHJlc291cmNlcy5oYXNPd25Qcm9wZXJ0eShwYXRoVXRpbHMucmVzb2x2ZShyZXNvdXJjZVVybCkpOwogICAgfSwKICAgIGdldDogZnVuY3Rpb24ocmVzb3VyY2VVcmwpewogICAgICAvKiogQGN1dCAqLyBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QocmVzb3VyY2VVcmwpKQogICAgICAvKiogQGN1dCAqLyAgIGNvbnNvbGVNZXRob2RzLndhcm4oJ0JhZCB1c2FnZTogYmFzaXMucmVzb3VyY2UuZ2V0KFwnJyArIHJlc291cmNlVXJsICsgJ1wnKS5cbkZpbGVuYW1lcyBzaG91bGQgc3RhcnRzIHdpdGggYC4vYCwgYC4uYCBvciBgL2AuIE90aGVyd2lzZSBpdCB3aWxsIHRyZWF0cyBhcyBzcGVjaWFsIHJlZmVyZW5jZSBpbiBuZXh0IG1pbm9yIHJlbGVhc2UuJyk7CgogICAgICByZXNvdXJjZVVybCA9IHBhdGhVdGlscy5yZXNvbHZlKHJlc291cmNlVXJsKTsKCiAgICAgIGlmICghZ2V0UmVzb3VyY2UuZXhpc3RzKHJlc291cmNlVXJsKSkKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICAgIHJldHVybiBnZXRSZXNvdXJjZShyZXNvdXJjZVVybCk7CiAgICB9LAogICAgZ2V0RmlsZXM6IGZ1bmN0aW9uKGNhY2hlKXsKICAgICAgcmV0dXJuIGtleXMoY2FjaGUgPyByZXNvdXJjZUNvbnRlbnRDYWNoZSA6IHJlc291cmNlcykubWFwKHBhdGhVdGlscy5yZWxhdGl2ZSk7CiAgICB9LAoKICAgIHZpcnR1YWw6IGZ1bmN0aW9uKHR5cGUsIGNvbnRlbnQsIG93bmVyVXJsKXsKICAgICAgcmV0dXJuIGNyZWF0ZVJlc291cmNlKAogICAgICAgIChvd25lclVybCA/IG93bmVyVXJsICsgJzonIDogcGF0aFV0aWxzLm5vcm1hbGl6ZShwYXRoVXRpbHMuYmFzZVVSSSA9PSAnLycgPyAnJyA6IHBhdGhVdGlscy5iYXNlVVJJKSArICcvJykgKwogICAgICAgICAgJ3ZpcnR1YWwtcmVzb3VyY2UnICsgKHZpcnR1YWxSZXNvdXJjZVNlZWQrKykgKyAnLicgKyB0eXBlLAogICAgICAgIGNvbnRlbnQKICAgICAgKTsKICAgIH0sCgogICAgZXh0ZW5zaW9uczogewogICAgICAnLmpzJzogZXh0ZW5kKGZ1bmN0aW9uKGNvbnRlbnQsIGZpbGVuYW1lKXsKICAgICAgICB2YXIgbmFtZXNwYWNlID0gZmlsZW5hbWUybmFtZXNwYWNlW2ZpbGVuYW1lXTsKCiAgICAgICAgaWYgKCFuYW1lc3BhY2UpCiAgICAgICAgewogICAgICAgICAgdmFyIGltcGxpY2l0TmFtZXNwYWNlID0gdHJ1ZTsKICAgICAgICAgIHZhciByZXNvbHZlZEZpbGVuYW1lID0gKHBhdGhVdGlscy5kaXJuYW1lKGZpbGVuYW1lKSArICcvJyArIHBhdGhVdGlscy5iYXNlbmFtZShmaWxlbmFtZSwgcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpKSk7CgogICAgICAgICAgZm9yICh2YXIgbnMgaW4gbnNSb290UGF0aCkKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhdGggPSBuc1Jvb3RQYXRoW25zXSArIG5zICsgJy8nOwogICAgICAgICAgICBpZiAocmVzb2x2ZWRGaWxlbmFtZS5zdWJzdHIoMCwgcGF0aC5sZW5ndGgpID09IHBhdGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpbXBsaWNpdE5hbWVzcGFjZSA9IGZhbHNlOwogICAgICAgICAgICAgIHJlc29sdmVkRmlsZW5hbWUgPSByZXNvbHZlZEZpbGVuYW1lLnN1YnN0cihuc1Jvb3RQYXRoW25zXS5sZW5ndGgpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgbmFtZXNwYWNlID0gcmVzb2x2ZWRGaWxlbmFtZQogICAgICAgICAgICAucmVwbGFjZSgvXC4vZywgJ18nKQogICAgICAgICAgICAucmVwbGFjZSgvXlwvL2csICcnKQogICAgICAgICAgICAucmVwbGFjZSgvXC8vZywgJy4nKTsKCiAgICAgICAgICBpZiAoaW1wbGljaXROYW1lc3BhY2UpCiAgICAgICAgICAgIG5hbWVzcGFjZSA9ICdpbXBsaWNpdC4nICsgbmFtZXNwYWNlOwogICAgICAgIH0KCiAgICAgICAgLyoqIEBjdXQgKi8gaWYgKHJlcXVpcmVzKQogICAgICAgIC8qKiBAY3V0ICovICAgYXJyYXlGdW5jdGlvbnMuYWRkKHJlcXVpcmVzLCBuYW1lc3BhY2UpOwoKICAgICAgICBpZiAoIW5hbWVzcGFjZXNbbmFtZXNwYWNlXSkKICAgICAgICB7CiAgICAgICAgICB2YXIgbnMgPSBnZXROYW1lc3BhY2UobmFtZXNwYWNlKTsKCiAgICAgICAgICAvKiogQGN1dCAqLyB2YXIgc2F2ZWRSZXF1aXJlcyA9IHJlcXVpcmVzOwogICAgICAgICAgLyoqIEBjdXQgKi8gcmVxdWlyZXMgPSBbXTsKCiAgICAgICAgICBucy5leHBvcnRzID0gcnVuU2NyaXB0SW5Db250ZXh0KHsKICAgICAgICAgICAgcGF0aDogbnMucGF0aCwKICAgICAgICAgICAgZXhwb3J0czogbnMuZXhwb3J0cwogICAgICAgICAgfSwgZmlsZW5hbWUsIGNvbnRlbnQpLmV4cG9ydHM7CgogICAgICAgICAgaWYgKG5zLmV4cG9ydHMgJiYgbnMuZXhwb3J0cy5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0KQogICAgICAgICAgICBjb21wbGV0ZShucywgbnMuZXhwb3J0cyk7CgogICAgICAgICAgLyoqIEBjdXQgKi8gbnMuZmlsZW5hbWVfID0gZmlsZW5hbWU7CiAgICAgICAgICAvKiogQGN1dCAqLyBucy5zb3VyY2VfID0gY29udGVudDsKICAgICAgICAgIC8qKiBAY3V0ICovIG5zLnJlcXVpcmVzXyA9IHJlcXVpcmVzOwoKICAgICAgICAgIC8qKiBAY3V0ICovIHJlcXVpcmVzID0gc2F2ZWRSZXF1aXJlczsKICAgICAgICB9CgogICAgICAgIHJldHVybiBuYW1lc3BhY2VzW25hbWVzcGFjZV0uZXhwb3J0czsKICAgICAgfSwgewogICAgICAgIHBlcm1hbmVudDogdHJ1ZQogICAgICB9KSwKCiAgICAgICcuY3NzJzogZnVuY3Rpb24oY29udGVudCwgdXJsLCBjc3NSZXNvdXJjZSl7CiAgICAgICAgaWYgKCFjc3NSZXNvdXJjZSkKICAgICAgICAgIGNzc1Jlc291cmNlID0gbmV3IENzc1Jlc291cmNlKHVybCk7CgogICAgICAgIGNzc1Jlc291cmNlLnVwZGF0ZUNzc1RleHQoY29udGVudCk7CgogICAgICAgIHJldHVybiBjc3NSZXNvdXJjZTsKICAgICAgfSwKCiAgICAgICcuanNvbic6IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCl7CiAgICAgICAgaWYgKHR5cGVvZiBjb250ZW50ID09ICdvYmplY3QnKQogICAgICAgICAgcmV0dXJuIGNvbnRlbnQ7CgogICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnRlbnQgPSBTdHJpbmcoY29udGVudCk7CiAgICAgICAgICByZXN1bHQgPSBiYXNpcy5qc29uLnBhcnNlKGNvbnRlbnQpOwogICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgLyoqIEBjdXQgKi8gY29uc29sZU1ldGhvZHMud2FybignYmFzaXMucmVzb3VyY2U6IENhblwndCBwYXJzZSBKU09OIGZyb20gJyArIHVybCwgeyB1cmw6IHVybCwgY29udGVudDogY29udGVudCB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdCB8fCBudWxsOwogICAgICB9CiAgICB9CiAgfSk7CgoKICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogIC8vIHNjcmlwdCBjb21waWxhdGlvbiBhbmQgZXhlY3V0aW9uCiAgLy8KCiAgZnVuY3Rpb24gY29tcGlsZUZ1bmN0aW9uKHNvdXJjZVVSTCwgYXJncywgYm9keSl7CiAgICB0cnkgewogICAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKGFyZ3MsIGJvZHkKICAgICAgICAvKiogQGN1dCAqLyArICdcblxuLy8jIHNvdXJjZVVSTD0nICsgcGF0aFV0aWxzLm9yaWdpbiArIHNvdXJjZVVSTAogICAgICApOwogICAgfSBjYXRjaChlKSB7CiAgICAgIC8qKiBAY3V0ICovIGlmIChkb2N1bWVudCAmJiAnbGluZScgaW4gZSA9PSBmYWxzZSAmJiAnYWRkRXZlbnRMaXN0ZW5lcicgaW4gZ2xvYmFsKQogICAgICAvKiogQGN1dCAqLyB7CiAgICAgIC8qKiBAY3V0ICovICAgLy8gQ2hyb21lIChWOCkgZG9lc24ndCBwcm92aWRlIGxpbmUgbnVtYmVyIHdoZXJlIGRvZXMgZXJyb3Igb2NjdXIsCiAgICAgIC8qKiBAY3V0ICovICAgLy8gaGVyZSBpcyB0cmlja3kgYXByb2FjaCB0byBmZXRjaCBsaW5lIG51bWJlciBpbiBzZWNvbmQgJ2NvbXBpbGF0aW9uIGVycm9yJyBtZXNzYWdlCiAgICAgIC8qKiBAY3V0ICovICAgZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgZnVuY3Rpb24gb25lcnJvcihldmVudCl7CiAgICAgIC8qKiBAY3V0ICovICAgICBpZiAoZXZlbnQuZmlsZW5hbWUgPT0gcGF0aFV0aWxzLm9yaWdpbiArIHNvdXJjZVVSTCkKICAgICAgLyoqIEBjdXQgKi8gICAgIHsKICAgICAgLyoqIEBjdXQgKi8gICAgICAgZ2xvYmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgb25lcnJvcik7CiAgICAgIC8qKiBAY3V0ICovICAgICAgIGNvbnNvbGVNZXRob2RzLmVycm9yKCdDb21waWxhdGlvbiBlcnJvciBhdCAnICsgZXZlbnQuZmlsZW5hbWUgKyAnOicgKyBldmVudC5saW5lbm8gKyAnOiAnICsgZSk7CiAgICAgIC8qKiBAY3V0ICovICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgIC8qKiBAY3V0ICovICAgICB9CiAgICAgIC8qKiBAY3V0ICovICAgfSk7CiAgICAgIC8qKiBAY3V0ICovCiAgICAgIC8qKiBAY3V0ICovICAgdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwogICAgICAvKiogQGN1dCAqLyAgIHNjcmlwdC5zcmMgPSBzb3VyY2VVUkw7CiAgICAgIC8qKiBAY3V0ICovICAgc2NyaXB0LmFzeW5jID0gZmFsc2U7CiAgICAgIC8qKiBAY3V0ICovICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgICAvKiogQGN1dCAqLyAgIGRvY3VtZW50LmhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICAgICAgLyoqIEBjdXQgKi8gfQoKICAgICAgLy8gZG9uJ3QgdGhyb3cgbmV3IGV4Y2VwdGlvbiwganVzdCBvdXRwdXQgZXJyb3IgbWVzc2FnZSBhbmQgcmV0dXJuIHVuZGVmaW5lZAogICAgICAvLyBpbiB0aGlzIGNhc2UgbW9yZSBjaGFuY2VzIGZvciBvdGhlciBtb2R1bGVzIGNvbnRpbnVlIHRvIHdvcmsKICAgICAgY29uc29sZU1ldGhvZHMuZXJyb3IoJ0NvbXBpbGF0aW9uIGVycm9yIGF0ICcgKyBzb3VyY2VVUkwgKyAoJ2xpbmUnIGluIGUgPyAnOicgKyAoZS5saW5lIC0gMSkgOiAnJykgKyAnOiAnICsgZSk7CiAgICB9CiAgfQoKICB2YXIgcnVuU2NyaXB0SW5Db250ZXh0ID0gZnVuY3Rpb24oY29udGV4dCwgc291cmNlVVJMLCBzb3VyY2VDb2RlKXsKICAgIHZhciBiYXNlVVJMID0gcGF0aFV0aWxzLmRpcm5hbWUoc291cmNlVVJMKSArICcvJzsKICAgIHZhciBjb21waWxlZFNvdXJjZUNvZGUgPSBzb3VyY2VDb2RlOwoKICAgIGlmICghY29udGV4dC5leHBvcnRzKQogICAgICBjb250ZXh0LmV4cG9ydHMgPSB7fTsKCiAgICAvLyBjb21waWxlIGZ1bmN0aW9uIGlmIHJlcXVpcmVkCiAgICBpZiAodHlwZW9mIGNvbXBpbGVkU291cmNlQ29kZSAhPSAnZnVuY3Rpb24nKQogICAgICBjb21waWxlZFNvdXJjZUNvZGUgPSBjb21waWxlRnVuY3Rpb24oc291cmNlVVJMLCBbJ2V4cG9ydHMnLCAnbW9kdWxlJywgJ2Jhc2lzJywgJ2dsb2JhbCcsICdfX2ZpbGVuYW1lJywgJ19fZGlybmFtZScsICdyZXNvdXJjZScsICdyZXF1aXJlJ10sCiAgICAgICAgJyJ1c2Ugc3RyaWN0IjtcbicgKwogICAgICAgIHNvdXJjZUNvZGUKICAgICAgKTsKCiAgICAvLyBydW4KICAgIGlmICh0eXBlb2YgY29tcGlsZWRTb3VyY2VDb2RlID09ICdmdW5jdGlvbicpCiAgICAgIGNvbXBpbGVkU291cmNlQ29kZS5jYWxsKAogICAgICAgIGNvbnRleHQuZXhwb3J0cywKICAgICAgICBjb250ZXh0LmV4cG9ydHMsCiAgICAgICAgY29udGV4dCwKICAgICAgICBiYXNpcywKICAgICAgICBnbG9iYWwsCiAgICAgICAgc291cmNlVVJMLAogICAgICAgIGJhc2VVUkwsCiAgICAgICAgZnVuY3Rpb24ocmVsYXRpdmVQYXRoKXsKICAgICAgICAgIC8qKiBAY3V0ICovIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChyZWxhdGl2ZVBhdGgpKQogICAgICAgICAgLyoqIEBjdXQgKi8gICBjb25zb2xlTWV0aG9kcy53YXJuKCdCYWQgdXNhZ2U6IHJlc291cmNlKFwnJyArIHJlbGF0aXZlUGF0aCArICdcJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLicpOwoKICAgICAgICAgIHJldHVybiBnZXRSZXNvdXJjZShwYXRoVXRpbHMucmVzb2x2ZShiYXNlVVJMLCByZWxhdGl2ZVBhdGgpKTsKICAgICAgICB9LAogICAgICAgIGZ1bmN0aW9uKHJlbGF0aXZlUGF0aCwgYmFzZSl7CiAgICAgICAgICByZXR1cm4gcmVxdWlyZU5hbWVzcGFjZShyZWxhdGl2ZVBhdGgsIGJhc2UgfHwgYmFzZVVSTCk7CiAgICAgICAgfQogICAgICApOwoKICAgIHJldHVybiBjb250ZXh0OwogIH07CgoKICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogIC8vIE5hbWVzcGFjZSBzdWJzeXN0ZW0KICAvLwoKICB2YXIgbmFtZXNwYWNlcyA9IHt9OwogIHZhciBuYW1lc3BhY2UyZmlsZW5hbWUgPSB7fTsKICB2YXIgZmlsZW5hbWUybmFtZXNwYWNlID0ge307CiAgdmFyIG5zUm9vdFBhdGggPSB7fTsKCiAgaXRlcmF0ZShjb25maWcubW9kdWxlcywgZnVuY3Rpb24obmFtZSwgbW9kdWxlKXsKICAgIG5zUm9vdFBhdGhbbmFtZV0gPSBtb2R1bGUucGF0aCArICcvJzsKICAgIG5hbWVzcGFjZTJmaWxlbmFtZVtuYW1lXSA9IG1vZHVsZS5maWxlbmFtZTsKICAgIGZpbGVuYW1lMm5hbWVzcGFjZVttb2R1bGUuZmlsZW5hbWVdID0gbmFtZTsKICB9KTsKCiAgKGZ1bmN0aW9uKG1hcCl7CiAgICB2YXIgbWFwID0gdHlwZW9mIF9fbmFtZXNwYWNlX21hcF9fICE9ICd1bmRlZmluZWQnID8gX19uYW1lc3BhY2VfbWFwX18gOiBudWxsOwogICAgaWYgKG1hcCkKICAgIHsKICAgICAgZm9yICh2YXIga2V5IGluIG1hcCkKICAgICAgewogICAgICAgIHZhciBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGtleSk7CiAgICAgICAgdmFyIG5hbWVzcGFjZSA9IG1hcFtrZXldOwogICAgICAgIGZpbGVuYW1lMm5hbWVzcGFjZVtmaWxlbmFtZV0gPSBuYW1lc3BhY2U7CiAgICAgICAgbmFtZXNwYWNlMmZpbGVuYW1lW25hbWVzcGFjZV0gPSBmaWxlbmFtZTsKICAgICAgfQogICAgfQogIH0pKCk7CgoKICB2YXIgTmFtZXNwYWNlID0gQ2xhc3MobnVsbCwgewogICAgY2xhc3NOYW1lOiAnYmFzaXMuTmFtZXNwYWNlJywKICAgIGluaXQ6IGZ1bmN0aW9uKG5hbWUpewogICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICB0aGlzLmV4cG9ydHMgPSB7CiAgICAgICAgcGF0aDogdGhpcy5uYW1lCiAgICAgIH07CiAgICB9LAogICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiAnW2Jhc2lzLm5hbWVzcGFjZSAnICsgdGhpcy5wYXRoICsgJ10nOwogICAgfSwKICAgIGV4dGVuZDogZnVuY3Rpb24obmFtZXMpewogICAgICBleHRlbmQodGhpcy5leHBvcnRzLCBuYW1lcyk7CiAgICAgIHJldHVybiBjb21wbGV0ZSh0aGlzLCBuYW1lcyk7CiAgICB9CiAgfSk7CgogIGZ1bmN0aW9uIHJlc29sdmVOU0ZpbGVuYW1lKG5hbWVzcGFjZSl7CiAgICBpZiAobmFtZXNwYWNlIGluIG5hbWVzcGFjZTJmaWxlbmFtZSA9PSBmYWxzZSkKICAgIHsKICAgICAgdmFyIHBhcnRzID0gbmFtZXNwYWNlLnNwbGl0KCcuJyk7CiAgICAgIHZhciBuYW1lc3BhY2VSb290ID0gcGFydHMuc2hpZnQoKTsKICAgICAgdmFyIGZpbGVuYW1lID0gcGFydHMuam9pbignLycpICsgJy5qcyc7CgogICAgICBpZiAobmFtZXNwYWNlUm9vdCBpbiBuc1Jvb3RQYXRoID09IGZhbHNlKQogICAgICAgIG5zUm9vdFBhdGhbbmFtZXNwYWNlUm9vdF0gPSBwYXRoVXRpbHMuYmFzZVVSSSArIG5hbWVzcGFjZVJvb3QgKyAnLyc7CgogICAgICBpZiAobmFtZXNwYWNlUm9vdCA9PSBuYW1lc3BhY2UpCiAgICAgICAgZmlsZW5hbWUgPSBuc1Jvb3RQYXRoW25hbWVzcGFjZVJvb3RdLnJlcGxhY2UoL1wvJC8sICcnKSArICcuanMnOwogICAgICBlbHNlCiAgICAgICAgZmlsZW5hbWUgPSBuc1Jvb3RQYXRoW25hbWVzcGFjZVJvb3RdICsgZmlsZW5hbWU7CgogICAgICBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZXNwYWNlXSA9IGZpbGVuYW1lOwogICAgICBmaWxlbmFtZTJuYW1lc3BhY2VbZmlsZW5hbWVdID0gbmFtZXNwYWNlOwogICAgfQoKICAgIHJldHVybiBuYW1lc3BhY2UyZmlsZW5hbWVbbmFtZXNwYWNlXTsKICB9CgogIGZ1bmN0aW9uIGdldFJvb3ROYW1lc3BhY2UobmFtZSl7CiAgICB2YXIgbmFtZXNwYWNlID0gbmFtZXNwYWNlc1tuYW1lXTsKCiAgICBpZiAoIW5hbWVzcGFjZSkKICAgIHsKICAgICAgbmFtZXNwYWNlID0gbmFtZXNwYWNlc1tuYW1lXSA9IG5ldyBOYW1lc3BhY2UobmFtZSk7CgogICAgICBuYW1lc3BhY2UubmFtZXNwYWNlc18gPSB7fTsKICAgICAgbmFtZXNwYWNlLm5hbWVzcGFjZXNfW25hbWVdID0gbmFtZXNwYWNlOwoKICAgICAgaWYgKCFjb25maWcubm9Db25mbGljdCkKICAgICAgICBnbG9iYWxbbmFtZV0gPSBuYW1lc3BhY2U7CiAgICB9CgogICAgLy8gYnVpbGRlciBjb3VsZCBnZW5lcmF0ZSBzb21lIGNvZGUgaGVyZSwgc29tZXRoaW5nIGxpa2UgdGhpcwogICAgLy8gaWYgKG5hbWUgPT0gJ2FwcCcgJiYgIWFwcCkKICAgIC8vICAgcmV0dXJuIGFwcCA9IG5hbWVzcGFjZTsKCiAgICByZXR1cm4gbmFtZXNwYWNlOwogIH0KCiAvKioKICAqIFJldHVybnMgbmFtZXNwYWNlIGJ5IHBhdGggb3IgY3JlYXRlcyBuZXcgb25lIChpZiBuYW1lc3BhY2UgaXNuJ3QgZXhpc3RzKS4KICAqIEBleGFtcGxlCiAgKiAgIHZhciBmb29CYXJOYW1lc3BhY2UgPSBiYXNpcy5uYW1lc3BhY2UoJ2Zvby5iYXInKTsKICAqIEBuYW1lIG5hbWVzcGFjZQogICogQHBhcmFtIHtzdHJpbmd9IHBhdGgKICAqIEByZXR1cm4ge2Jhc2lzLk5hbWVzcGFjZX0KICAqLwogIGZ1bmN0aW9uIGdldE5hbWVzcGFjZShwYXRoKXsKICAgIHBhdGggPSBwYXRoLnNwbGl0KCcuJyk7CgogICAgdmFyIHJvb3ROcyA9IGdldFJvb3ROYW1lc3BhY2UocGF0aFswXSk7CiAgICB2YXIgY3Vyc29yID0gcm9vdE5zOwoKICAgIGZvciAodmFyIGkgPSAxLCBuYW1lOyBuYW1lID0gcGF0aFtpXTsgaSsrKQogICAgewogICAgICBpZiAoIWN1cnNvcltuYW1lXSkKICAgICAgewogICAgICAgIHZhciBuc3BhdGggPSBwYXRoLnNsaWNlKDAsIGkgKyAxKS5qb2luKCcuJyk7CgogICAgICAgIC8vIGNyZWF0ZSBuZXcgbmFtZXNwYWNlCiAgICAgICAgY3Vyc29yW25hbWVdID0gbmV3IE5hbWVzcGFjZShuc3BhdGgpOwogICAgICAgIHJvb3ROcy5uYW1lc3BhY2VzX1tuc3BhdGhdID0gY3Vyc29yW25hbWVdOwogICAgICB9CgogICAgICBjdXJzb3IgPSBjdXJzb3JbbmFtZV07CiAgICB9CgogICAgbmFtZXNwYWNlc1twYXRoLmpvaW4oJy4nKV0gPSBjdXJzb3I7CgogICAgcmV0dXJuIGN1cnNvcjsKICB9CgoKIC8qKgogICogQHBhcmFtIHtzdHJpbmd9IGZpbGVuYW1lCiAgKiBAcGFyYW0ge3N0cmluZ30gZGlybmFtZQogICogQG5hbWUgcmVxdWlyZQogICovCiAgdmFyIHJlcXVpcmVOYW1lc3BhY2UgPSAoZnVuY3Rpb24oKXsKICAgIGlmIChOT0RFX0VOVikKICAgIHsKICAgICAgdmFyIG1vZHVsZVByb3RvID0gbW9kdWxlLmNvbnN0cnVjdG9yLnByb3RvdHlwZTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZpbGVuYW1lLCBkaXJuYW1lKXsKICAgICAgICBpZiAoIS9bXmEtejAtOV9cLl0vaS50ZXN0KGZpbGVuYW1lKSB8fCBwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkgPT0gJy5qcycpCiAgICAgICAgewogICAgICAgICAgdmFyIF9jb21waWxlID0gbW9kdWxlUHJvdG8uX2NvbXBpbGU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gZ2V0TmFtZXNwYWNlKGZpbGVuYW1lKTsKCiAgICAgICAgICAvLyBwYXRjaCBub2RlLmpzIG1vZHVsZS5fY29tcGlsZQogICAgICAgICAgbW9kdWxlUHJvdG8uX2NvbXBpbGUgPSBmdW5jdGlvbihjb250ZW50LCBmaWxlbmFtZSl7CiAgICAgICAgICAgIHRoaXMuYmFzaXMgPSBiYXNpczsKICAgICAgICAgICAgY29udGVudCA9CiAgICAgICAgICAgICAgJ3ZhciBfX25vZGVqc1JlcXVpcmUgPSByZXF1aXJlO1xuJyArCiAgICAgICAgICAgICAgJ3ZhciBiYXNpcyA9IG1vZHVsZS5iYXNpcztcbicgKwogICAgICAgICAgICAgICd2YXIgcmVzb3VyY2UgPSBmdW5jdGlvbihmaWxlbmFtZSl7IHJldHVybiBiYXNpcy5yZXNvdXJjZShfX2Rpcm5hbWUgKyAiLyIgKyBmaWxlbmFtZSkgfTtcbicgKwogICAgICAgICAgICAgICd2YXIgcmVxdWlyZSA9IGZ1bmN0aW9uKGZpbGVuYW1lLCBiYXNlVVJJKXsgcmV0dXJuIGJhc2lzLnJlcXVpcmUoZmlsZW5hbWUsIGJhc2VVUkkgfHwgX19kaXJuYW1lKSB9O1xuJyArCiAgICAgICAgICAgICAgY29udGVudDsKICAgICAgICAgICAgX2NvbXBpbGUuY2FsbChleHRlbmQodGhpcywgbmFtZXNwYWNlKSwgY29udGVudCwgZmlsZW5hbWUpOwogICAgICAgICAgfTsKCiAgICAgICAgICB2YXIgZXhwb3J0cyA9IHJlcXVpcmUoX19kaXJuYW1lICsgJy8nICsgZmlsZW5hbWUucmVwbGFjZSgvXC4vZywgJy8nKSk7CgogICAgICAgICAgbmFtZXNwYWNlLmV4cG9ydHMgPSBleHBvcnRzOwogICAgICAgICAgaWYgKGV4cG9ydHMgJiYgZXhwb3J0cy5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0KQogICAgICAgICAgICBjb21wbGV0ZShuYW1lc3BhY2UsIGV4cG9ydHMpOwoKICAgICAgICAgIC8vIHJlc3RvcmUgbm9kZS5qcyBtb2R1bGUuX2NvbXBpbGUKICAgICAgICAgIG1vZHVsZVByb3RvLl9jb21waWxlID0gX2NvbXBpbGU7CgogICAgICAgICAgcmV0dXJuIGV4cG9ydHM7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICBmaWxlbmFtZSA9IHBhdGhVdGlscy5yZXNvbHZlKGRpcm5hbWUsIGZpbGVuYW1lKTsKICAgICAgICAgIHJldHVybiByZXF1aXJlKGZpbGVuYW1lKTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgIHJldHVybiBmdW5jdGlvbihmaWxlbmFtZSwgZGlybmFtZSl7CiAgICAgICAgaWYgKCEvW15hLXowLTlfXC5dL2kudGVzdChmaWxlbmFtZSkgJiYgcGF0aFV0aWxzLmV4dG5hbWUoZmlsZW5hbWUpICE9ICcuanMnKQogICAgICAgIHsKICAgICAgICAgIC8vIG5hbWVzcGFjZSwgbGlrZSAnZm9vLmJhci5iYXonCiAgICAgICAgICBmaWxlbmFtZSA9IHJlc29sdmVOU0ZpbGVuYW1lKGZpbGVuYW1lKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgIC8qKiBAY3V0ICovIGlmICghL14oXC5cL3xcLlwufFwvKS8udGVzdChmaWxlbmFtZSkpCiAgICAgICAgICAvKiogQGN1dCAqLyAgIGNvbnNvbGVNZXRob2RzLndhcm4oJ0JhZCB1c2FnZTogcmVxdWlyZShcJycgKyBmaWxlbmFtZSArICdcJykuXG5GaWxlbmFtZXMgc2hvdWxkIHN0YXJ0cyB3aXRoIGAuL2AsIGAuLmAgb3IgYC9gLiBPdGhlcndpc2UgaXQgd2lsbCB0cmVhdHMgYXMgc3BlY2lhbCByZWZlcmVuY2UgaW4gbmV4dCBtaW5vciByZWxlYXNlLicpOwoKICAgICAgICAgIC8vIHJlZ3VsYXIgZmlsZW5hbWUKICAgICAgICAgIGZpbGVuYW1lID0gcGF0aFV0aWxzLnJlc29sdmUoZGlybmFtZSwgZmlsZW5hbWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGdldFJlc291cmNlKGZpbGVuYW1lKS5mZXRjaCgpOwogICAgICB9OwogICAgfQogIH0pKCk7CgoKICBmdW5jdGlvbiBwYXRjaChmaWxlbmFtZSwgcGF0Y2hGbil7CiAgICBpZiAoIS9bXmEtejAtOV9cLl0vaS50ZXN0KGZpbGVuYW1lKSAmJiBwYXRoVXRpbHMuZXh0bmFtZShmaWxlbmFtZSkgIT0gJy5qcycpCiAgICB7CiAgICAgIC8vIG5hbWVzcGFjZSwgbGlrZSAnZm9vLmJhci5iYXonCiAgICAgIGZpbGVuYW1lID0gcmVzb2x2ZU5TRmlsZW5hbWUoZmlsZW5hbWUpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAvKiogQGN1dCAqLyBpZiAoIS9eKFwuXC98XC5cLnxcLykvLnRlc3QoZmlsZW5hbWUpKQogICAgICAvKiogQGN1dCAqLyAgIGNvbnNvbGVNZXRob2RzLndhcm4oJ0JhZCB1c2FnZTogYmFzaXMucGF0Y2goXCcnICsgZmlsZW5hbWUgKyAnXCcpLlxuRmlsZW5hbWVzIHNob3VsZCBzdGFydHMgd2l0aCBgLi9gLCBgLi5gIG9yIGAvYC4gT3RoZXJ3aXNlIGl0IHdpbGwgdHJlYXRzIGFzIHNwZWNpYWwgcmVmZXJlbmNlIGluIG5leHQgbWlub3IgcmVsZWFzZS4nKTsKCiAgICAgIC8vIHJlZ3VsYXIgZmlsZW5hbWUKICAgICAgZmlsZW5hbWUgPSBwYXRoVXRpbHMucmVzb2x2ZShmaWxlbmFtZSk7CiAgICB9CgogICAgaWYgKCFyZXNvdXJjZVBhdGNoW2ZpbGVuYW1lXSkKICAgICAgcmVzb3VyY2VQYXRjaFtmaWxlbmFtZV0gPSBbcGF0Y2hGbl07CiAgICBlbHNlCiAgICAgIHJlc291cmNlUGF0Y2hbZmlsZW5hbWVdLnB1c2gocGF0Y2hGbik7CgogICAgLy8gaWYgcmVzb3VyY2UgZXhpc3RzIGFuZCByZXNvbHZlZCAtPiBhcHBseSBwYXRjaAogICAgdmFyIHJlc291cmNlID0gZ2V0UmVzb3VyY2UuZ2V0KGZpbGVuYW1lKTsKICAgIGlmIChyZXNvdXJjZSAmJiByZXNvdXJjZS5pc1Jlc29sdmVkKCkpCiAgICAgIHBhdGNoRm4ocmVzb3VyY2UuZ2V0KCksIHJlc291cmNlLnVybCk7CiAgfQoKCiAvKioKICAqIEBuYW1lc3BhY2UgRnVuY3Rpb24ucHJvdG90eXBlCiAgKi8KCiAgY29tcGxldGUoRnVuY3Rpb24ucHJvdG90eXBlLCB7CiAgIC8qKgogICAgKiBDaGFuZ2VzIGZ1bmN0aW9uIGRlZmF1bHQgY29udGV4dC4gSXQgYWxzbyBtYWtlcyBwb3NzaWJsZSB0byBzZXQgc3RhdGljCiAgICAqIGFyZ3VtZW50cyAoZm9sZGluZykgZm9yIGZ1bmN0aW9uLgogICAgKiBJbXBsZW1lbnRlZCBpbiBFUzUuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSB0aGlzT2JqZWN0CiAgICAqIEBwYXJhbSB7Li4uKn0gYXJncwogICAgKiBAcmV0dXJuIHtmdW5jdGlvbigpfQogICAgKiBUT0RPOiBjaGVjayBjb21wbGlhbmNlCiAgICAqLwogICAgYmluZDogZnVuY3Rpb24odGhpc09iamVjdCl7CiAgICAgIHZhciBmbiA9IHRoaXM7CiAgICAgIHZhciBwYXJhbXMgPSBhcnJheUZyb20oYXJndW1lbnRzLCAxKTsKCiAgICAgIHJldHVybiBwYXJhbXMubGVuZ3RoCiAgICAgICAgPyBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gZm4uYXBwbHkodGhpc09iamVjdCwgcGFyYW1zLmNvbmNhdC5hcHBseShwYXJhbXMsIGFyZ3VtZW50cykpOwogICAgICAgICAgfQogICAgICAgIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgcmV0dXJuIGZuLmFwcGx5KHRoaXNPYmplY3QsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9OwogICAgfQogIH0pOwoKCiAvKioKICAqIEFycmF5IGV4dGVuc2lvbnMKICAqIEBuYW1lc3BhY2UgQXJyYXkKICAqLwoKICBjb21wbGV0ZShBcnJheSwgewogICAvKioKICAgICogUmV0dXJucyB0cnVlIGlmIHZhbHVlIGlzIEFycmF5IGluc3RhbmNlLgogICAgKiBJbXBsZW1lbnRlZCBpbiBFUzUuCiAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVmFsdWUgdG8gYmUgdGVzdGVkLgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGlzQXJyYXk6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuIHRvU3RyaW5nLmNhbGwodmFsdWUpID09PSAnW29iamVjdCBBcnJheV0nOwogICAgfQogIH0pOwoKICBmdW5jdGlvbiBhcnJheUZyb20ob2JqZWN0LCBvZmZzZXQpewogICAgaWYgKG9iamVjdCAhPSBudWxsKQogICAgewogICAgICB2YXIgbGVuID0gb2JqZWN0Lmxlbmd0aDsKCiAgICAgIGlmICh0eXBlb2YgbGVuID09ICd1bmRlZmluZWQnIHx8CiAgICAgICAgICB0b1N0cmluZy5jYWxsKG9iamVjdCkgPT0gJ1tvYmplY3QgRnVuY3Rpb25dJykgLy8gU2FmYXJpIDUuMSBoYXMgYSBidWcsIHR5cGVvZiBmb3Igbm9kZSBjb2xsZWN0aW9uIHJldHVybnMgYGZ1bmN0aW9uYAogICAgICAgIHJldHVybiBbb2JqZWN0XTsKCiAgICAgIGlmICghb2Zmc2V0KQogICAgICAgIG9mZnNldCA9IDA7CgogICAgICBpZiAobGVuIC0gb2Zmc2V0ID4gMCkKICAgICAgewogICAgICAgIGZvciAodmFyIHJlc3VsdCA9IFtdLCBrID0gMCwgaSA9IG9mZnNldDsgaSA8IGxlbjspCiAgICAgICAgICByZXN1bHRbaysrXSA9IG9iamVjdFtpKytdOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gW107CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVBcnJheShsZW5ndGgsIGZpbGxWYWx1ZSwgdGhpc09iamVjdCl7CiAgICB2YXIgcmVzdWx0ID0gW107CiAgICB2YXIgaXNGdW5jID0gdHlwZW9mIGZpbGxWYWx1ZSA9PSAnZnVuY3Rpb24nOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspCiAgICAgIHJlc3VsdFtpXSA9IGlzRnVuYyA/IGZpbGxWYWx1ZS5jYWxsKHRoaXNPYmplY3QsIGksIHJlc3VsdCkgOiBmaWxsVmFsdWU7CgogICAgcmV0dXJuIHJlc3VsdDsKICB9CgoKIC8qKgogICogQG5hbWVzcGFjZSBBcnJheS5wcm90b3R5cGUKICAqLwoKICBjb21wbGV0ZShBcnJheS5wcm90b3R5cGUsIHsKICAgIC8vIEphdmFTY3JpcHQgMS42CiAgICBpbmRleE9mOiBmdW5jdGlvbihzZWFyY2hFbGVtZW50LCBvZmZzZXQpewogICAgICBvZmZzZXQgPSBwYXJzZUludChvZmZzZXQsIDEwKSB8fCAwOwogICAgICBpZiAob2Zmc2V0IDwgMCkKICAgICAgICByZXR1cm4gLTE7CiAgICAgIGZvciAoOyBvZmZzZXQgPCB0aGlzLmxlbmd0aDsgb2Zmc2V0KyspCiAgICAgICAgaWYgKHRoaXNbb2Zmc2V0XSA9PT0gc2VhcmNoRWxlbWVudCkKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgIHJldHVybiAtMTsKICAgIH0sCiAgICBsYXN0SW5kZXhPZjogZnVuY3Rpb24oc2VhcmNoRWxlbWVudCwgb2Zmc2V0KXsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICBvZmZzZXQgPSBwYXJzZUludChvZmZzZXQsIDEwKTsKICAgICAgaWYgKGlzTmFOKG9mZnNldCkgfHwgb2Zmc2V0ID49IGxlbikKICAgICAgICBvZmZzZXQgPSBsZW4gLSAxOwogICAgICBlbHNlCiAgICAgICAgb2Zmc2V0ID0gKG9mZnNldCArIGxlbikgJSBsZW47CiAgICAgIGZvciAoOyBvZmZzZXQgPj0gMDsgb2Zmc2V0LS0pCiAgICAgICAgaWYgKHRoaXNbb2Zmc2V0XSA9PT0gc2VhcmNoRWxlbWVudCkKICAgICAgICAgIHJldHVybiBvZmZzZXQ7CiAgICAgIHJldHVybiAtMTsKICAgIH0sCiAgICBmb3JFYWNoOiBmdW5jdGlvbihjYWxsYmFjaywgdGhpc09iamVjdCl7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIGlmIChpIGluIHRoaXMpCiAgICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpOwogICAgfSwKICAgIGV2ZXJ5OiBmdW5jdGlvbihjYWxsYmFjaywgdGhpc09iamVjdCl7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIGlmIChpIGluIHRoaXMgJiYgIWNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcykpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKICAgIHNvbWU6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KXsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgaWYgKGkgaW4gdGhpcyAmJiBjYWxsYmFjay5jYWxsKHRoaXNPYmplY3QsIHRoaXNbaV0sIGksIHRoaXMpKQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCiAgICBmaWx0ZXI6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KXsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICBpZiAoaSBpbiB0aGlzICYmIGNhbGxiYWNrLmNhbGwodGhpc09iamVjdCwgdGhpc1tpXSwgaSwgdGhpcykpCiAgICAgICAgICByZXN1bHQucHVzaCh0aGlzW2ldKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCiAgICBtYXA6IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aGlzT2JqZWN0KXsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICBpZiAoaSBpbiB0aGlzKQogICAgICAgICAgcmVzdWx0W2ldID0gY2FsbGJhY2suY2FsbCh0aGlzT2JqZWN0LCB0aGlzW2ldLCBpLCB0aGlzKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCiAgICAvLyBKYXZhU2NyaXB0IDEuOAogICAgcmVkdWNlOiBmdW5jdGlvbihjYWxsYmFjaywgaW5pdGlhbFZhbHVlKXsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwogICAgICB2YXIgYXJnc0xlbiA9IGFyZ3VtZW50cy5sZW5ndGg7CgogICAgICAvLyBubyB2YWx1ZSB0byByZXR1cm4gaWYgbm8gaW5pdGlhbCB2YWx1ZSBhbmQgYW4gZW1wdHkgYXJyYXkKICAgICAgaWYgKGxlbiA9PSAwICYmIGFyZ3NMZW4gPT0gMSkKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CgogICAgICB2YXIgcmVzdWx0OwogICAgICB2YXIgaW5pdGVkID0gMDsKCiAgICAgIGlmIChhcmdzTGVuID4gMSkKICAgICAgewogICAgICAgIHJlc3VsdCA9IGluaXRpYWxWYWx1ZTsKICAgICAgICBpbml0ZWQgPSAxOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKQogICAgICAgIGlmIChpIGluIHRoaXMpCiAgICAgICAgICBpZiAoaW5pdGVkKyspCiAgICAgICAgICAgIHJlc3VsdCA9IGNhbGxiYWNrLmNhbGwobnVsbCwgcmVzdWx0LCB0aGlzW2ldLCBpLCB0aGlzKTsKICAgICAgICAgIGVsc2UKICAgICAgICAgICAgcmVzdWx0ID0gdGhpc1tpXTsKCiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgfSk7CgogIHZhciBhcnJheUZ1bmN0aW9ucyA9IHsKICAgIGZyb206IGFycmF5RnJvbSwKICAgIGNyZWF0ZTogY3JlYXRlQXJyYXksCgogICAgLy8gZXh0cmFjdG9ycwogICAgZmxhdHRlbjogZnVuY3Rpb24odGhpc18pewogICAgICByZXR1cm4gdGhpc18uY29uY2F0LmFwcGx5KFtdLCB0aGlzXyk7CiAgICB9LAogICAgcmVwZWF0OiBmdW5jdGlvbih0aGlzXywgY291bnQpewogICAgICByZXR1cm4gYXJyYXlGdW5jdGlvbnMuZmxhdHRlbihjcmVhdGVBcnJheShwYXJzZUludChjb3VudCwgMTApIHx8IDAsIHRoaXNfKSk7CiAgICB9LAoKICAgIC8vIHNlYXJjaAogICAvKioKICAgICogUmV0dXJucyBmaXJzdCBpdGVtIHdoZXJlIGdldHRlcihpdGVtKSA9PT0gdmFsdWUKICAgICogQGV4YW1wbGUKICAgICogICB2YXIgbGlzdCA9IFt7IGE6IDEsIGI6IDIgfSwgeyBhOiAyLCBiOiAzIH0sIHsgYTogMSwgYjogNH0sIHsgYTogNSB9XTsKICAgICoKICAgICogICAvLyBzZWFyY2ggZm9yIGl0ZW0gd2hlcmUgb2JqZWN0LmEgPT0gMgogICAgKiAgIHZhciByZXN1bHQgPSBsaXN0LnNlYXJjaCg1LCAnYScpOwogICAgKiAgICAgLy8gcmVzdWx0IC0+IHsgYTogNSB9CiAgICAqCiAgICAqICAgLy8gc2VhcmNoIGZvciB3aGVyZSBhID09IDEgJiYgYiA+IDIKICAgICogICB2YXIgcmVzdWx0ID0gbGlzdC5zZWFyY2godHJ1ZSwgZnVuY3Rpb24ob2JqZWN0KXsgcmV0dXJuIG9iamVjdC5hID09IDEgJiYgb2JqZWN0LmIgPiAyIH0pOwogICAgKiAgICAgLy8gcmVzdWx0IC0+IHsgYTogMSwgYjogMyB9CiAgICAqCiAgICAqICAgLy8gc2VhcmNoIGFsbCBpdGVtcyB3aGVyZSBhID09IDEKICAgICogICB2YXIgcmVzdWx0ID0gbmV3IEFycmF5KCk7CiAgICAqICAgdmFyIGl0ZW0gPSBsaXN0LnNlYXJjaCgxLCAnYScpOwogICAgKiAgIHdoaWxlIChpdGVtKQogICAgKiAgIHsKICAgICogICAgIHJlc3VsdC5wdXNoKGl0ZW0pCiAgICAqICAgICBpdGVtID0gbGlzdC5zZWFyY2goMSwgJ2EnLCBsaXN0Lmxhc3RTZWFyY2hJbmRleCArIDEpOwogICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbGFzdFNlYXJjaEluZGV4IHN0b3JlIGluZGV4IG9mIGxhc3QgZm91bmRlZCBpdGVtCiAgICAqICAgfQogICAgKiAgICAgLy8gcmVzdWx0IC0+IFt7IGE6IDEsIGI6IDIgfSwgeyBhOiAxLCBiOiA0fV0KICAgICoKICAgICogICAvLyBidXQgaWYgeW91IG5lZWQgYWxsIGl0ZW1zIG9mIGFycmF5IHdpdGggZmlsdGVyZWQgYnkgY29uZGl0aW9uIHVzZSBBcnJheSNmaWx0ZXIgbWV0aG9kIGluc3RlYWQKICAgICogICB2YXIgcmVzdWx0ID0gbGlzdC5maWx0ZXIoYmFzaXMuZ2V0dGVyKCdhID09IDEnKSk7CiAgICAqCiAgICAqIEBwYXJhbSB7QXJyYXl9IHRoaXNfCiAgICAqIEBwYXJhbSB7Kn0gdmFsdWUKICAgICogQHBhcmFtIHtmdW5jdGlvbihvYmplY3QpfHN0cmluZ30gZ2V0dGVyXwogICAgKiBAcGFyYW0ge251bWJlcj19IG9mZnNldAogICAgKiBAcmV0dXJuIHsqfQogICAgKi8KICAgIHNlYXJjaDogZnVuY3Rpb24odGhpc18sIHZhbHVlLCBnZXR0ZXJfLCBvZmZzZXQpewogICAgICB0aGlzXy5sYXN0U2VhcmNoSW5kZXggPSAtMTsKICAgICAgZ2V0dGVyXyA9IGdldHRlcihnZXR0ZXJfIHx8ICRzZWxmKTsKCiAgICAgIGZvciAodmFyIGluZGV4ID0gcGFyc2VJbnQob2Zmc2V0LCAxMCkgfHwgMCwgbGVuID0gdGhpc18ubGVuZ3RoOyBpbmRleCA8IGxlbjsgaW5kZXgrKykKICAgICAgICBpZiAoZ2V0dGVyXyh0aGlzX1tpbmRleF0pID09PSB2YWx1ZSkKICAgICAgICAgIHJldHVybiB0aGlzX1t0aGlzXy5sYXN0U2VhcmNoSW5kZXggPSBpbmRleF07CiAgICB9LAoKICAgLyoqCiAgICAqIEBwYXJhbSB7QXJyYXl9IHRoaXNfCiAgICAqIEBwYXJhbSB7Kn0gdmFsdWUKICAgICogQHBhcmFtIHtmdW5jdGlvbihvYmplY3QpfHN0cmluZ30gZ2V0dGVyXwogICAgKiBAcGFyYW0ge251bWJlcj19IG9mZnNldAogICAgKiBAcmV0dXJuIHsqfQogICAgKi8KICAgIGxhc3RTZWFyY2g6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSwgZ2V0dGVyXywgb2Zmc2V0KXsKICAgICAgdGhpc18ubGFzdFNlYXJjaEluZGV4ID0gLTE7CiAgICAgIGdldHRlcl8gPSBnZXR0ZXIoZ2V0dGVyXyB8fCAkc2VsZik7CgogICAgICB2YXIgbGVuID0gdGhpc18ubGVuZ3RoOwogICAgICB2YXIgaW5kZXggPSBpc05hTihvZmZzZXQpIHx8IG9mZnNldCA9PSBudWxsID8gbGVuIDogcGFyc2VJbnQob2Zmc2V0LCAxMCk7CgogICAgICBmb3IgKHZhciBpID0gaW5kZXggPiBsZW4gPyBsZW4gOiBpbmRleDsgaS0tID4gMDspCiAgICAgICAgaWYgKGdldHRlcl8odGhpc19baV0pID09PSB2YWx1ZSkKICAgICAgICAgIHJldHVybiB0aGlzX1t0aGlzXy5sYXN0U2VhcmNoSW5kZXggPSBpXTsKICAgIH0sCgogICAgLy8gY29sbGVjdGlvbiBmb3IKICAgIGFkZDogZnVuY3Rpb24odGhpc18sIHZhbHVlKXsKICAgICAgcmV0dXJuIHRoaXNfLmluZGV4T2YodmFsdWUpID09IC0xICYmICEhdGhpc18ucHVzaCh2YWx1ZSk7CiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbih0aGlzXywgdmFsdWUpewogICAgICB2YXIgaW5kZXggPSB0aGlzXy5pbmRleE9mKHZhbHVlKTsKICAgICAgcmV0dXJuIGluZGV4ICE9IC0xICYmICEhdGhpc18uc3BsaWNlKGluZGV4LCAxKTsKICAgIH0sCiAgICBoYXM6IGZ1bmN0aW9uKHRoaXNfLCB2YWx1ZSl7CiAgICAgIHJldHVybiB0aGlzXy5pbmRleE9mKHZhbHVlKSAhPSAtMTsKICAgIH0sCgogICAgLy8gbWlzYy4KICAgIHNvcnRBc09iamVjdDogZnVuY3Rpb24oKXsKICAgICAgLy8gZGVwcmVjYXRlZCBpbiBiYXNpcy5qcyAxLjMuMAogICAgICAvKiogQGN1dCAqLyBjb25zb2xlTWV0aG9kcy53YXJuKCdiYXNpcy5hcnJheS5zb3J0QXNPYmplY3QgaXMgZGVwcmVjYXRlZCwgdXNlIGJhc2lzLmFycmF5LnNvcnQgaW5zdGVhZCcpOwogICAgICByZXR1cm4gYXJyYXlGdW5jdGlvbnMuc29ydC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKICAgIHNvcnQ6IGZ1bmN0aW9uKHRoaXNfLCBnZXR0ZXJfLCBjb21wYXJhdG9yLCBkZXNjKXsKICAgICAgZ2V0dGVyXyA9IGdldHRlcihnZXR0ZXJfKTsKICAgICAgZGVzYyA9IGRlc2MgPyAtMSA6IDE7CgogICAgICByZXR1cm4gdGhpc18KICAgICAgICAubWFwKGZ1bmN0aW9uKGl0ZW0sIGluZGV4KXsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGk6IGluZGV4LCAgICAgICAgLy8gaW5kZXgKICAgICAgICAgICAgdjogZ2V0dGVyXyhpdGVtKSAvLyB2YWx1ZQogICAgICAgICAgfTsKICAgICAgICB9KQogICAgICAgIC5zb3J0KGNvbXBhcmF0b3IgfHwgZnVuY3Rpb24oYSwgYil7ICAgICAgICAgICAgIC8vIHN0YWJpbGl0eSBzb3J0aW5nIChuZWNjZXNzYXJ5IG9ubHkgZm9yIGJyb3dzZXJzIHdpdGggbm8gc3Ryb25nIHNvcnRpbmcsIGp1c3QgZm9yIHN1cmUpCiAgICAgICAgICByZXR1cm4gZGVzYyAqICgoYS52ID4gYi52KSB8fCAtKGEudiA8IGIudikgfHwgKGEuaSA+IGIuaSA/IDEgOiAtMSkpOwogICAgICAgIH0pCiAgICAgICAgLm1hcChmdW5jdGlvbihpdGVtKXsKICAgICAgICAgIHJldHVybiB0aGlzW2l0ZW0uaV07CiAgICAgICAgfSwgdGhpc18pOwogICAgfQogIH07CgogIC8vIElFIDUuNSsgJiBPcGVyYQogIC8vIHdoZW4gc2Vjb25kIGFyZ3VtZW50IGlzIG9taXRlZCwgbWV0aG9kIHNldCB0aGlzIHBhcmFtZXRlciBlcXVhbCB6ZXJvIChtdXN0IGJlIGVxdWFsIGFycmF5IGxlbmd0aCkKICBpZiAoIVsxLCAyXS5zcGxpY2UoMSkubGVuZ3RoKQogIHsKICAgIHZhciBuYXRpdmVBcnJheVNwbGljZSA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2U7CiAgICBBcnJheS5wcm90b3R5cGUuc3BsaWNlID0gZnVuY3Rpb24oKXsKICAgICAgdmFyIHBhcmFtcyA9IGFycmF5RnJvbShhcmd1bWVudHMpOwogICAgICBpZiAocGFyYW1zLmxlbmd0aCA8IDIpCiAgICAgICAgcGFyYW1zWzFdID0gdGhpcy5sZW5ndGg7CiAgICAgIHJldHVybiBuYXRpdmVBcnJheVNwbGljZS5hcHBseSh0aGlzLCBwYXJhbXMpOwogICAgfTsKICB9CgogLyoqCiAgKiBTdHJpbmcgZXh0ZW5zaW9ucwogICogQG5hbWVzcGFjZSBTdHJpbmcKICAqLwoKICB2YXIgRVNDQVBFX0ZPUl9SRUdFWFAgPSAvKFtcL1xcXChcKVxbXF1cP1x7XH1cfFwqXCtcLVwuXF5cJF0pL2c7CiAgdmFyIEZPUk1BVF9SRUdFWFAgPSAvXHsoW2EtelxkX10rKSg/OjooW1wuMF0pKFxkKyl8OihcPykpP1x9L2dpOwoKICBjb21wbGV0ZShTdHJpbmcsIHsKICAgIHRvTG93ZXJDYXNlOiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRvTG93ZXJDYXNlKCk7CiAgICB9LAogICAgdG9VcHBlckNhc2U6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkudG9VcHBlckNhc2UoKTsKICAgIH0sCiAgICB0cmltOiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpLnRyaW0oKTsKICAgIH0sCiAgICB0cmltTGVmdDogZnVuY3Rpb24odmFsdWUpewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50cmltTGVmdCgpOwogICAgfSwKICAgIHRyaW1SaWdodDogZnVuY3Rpb24odmFsdWUpewogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKS50cmltUmlnaHQoKTsKICAgIH0KICB9KTsKCgogLyoqCiAgKiBAbmFtZXNwYWNlIFN0cmluZy5wcm90b3R5cGUKICAqLwogIGNvbXBsZXRlKFN0cmluZy5wcm90b3R5cGUsIHsKICAgIHRyaW1MZWZ0OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5yZXBsYWNlKC9eXHMrLywgJycpOwogICAgfSwKICAgIHRyaW1SaWdodDogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMucmVwbGFjZSgvXHMrJC8sICcnKTsKICAgIH0sCiAgICAvLyBpbXBsZW1lbnRlZCBhdCBFQ01BU2NyaXB0NQogICAgdHJpbTogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMudHJpbUxlZnQoKS50cmltUmlnaHQoKTsKICAgIH0KICB9KTsKCiAgdmFyIHN0cmluZ0Z1bmN0aW9ucyA9IHsKICAgLyoqCiAgICAqIEByZXR1cm4geyp9CiAgICAqLwogICAgdG9PYmplY3Q6IGZ1bmN0aW9uKHRoaXNfLCByZXRocm93KXsKICAgICAgLy8gdHJ5IHsgcmV0dXJuIGV2YWwoJzAsJyArIHRoaXNfKSB9IGNhdGNoKGUpIHt9CiAgICAgIC8vIHNhZmUgc29sdXRpb24gd2l0aCBubyBldmFsOgogICAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oJ3JldHVybiAwLCcgKyB0aGlzXykoKTsKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgaWYgKHJldGhyb3cpCiAgICAgICAgICB0aHJvdyBlOwogICAgICB9CiAgICB9LAogICAgcmVwZWF0OiBmdW5jdGlvbih0aGlzXywgY291bnQpewogICAgICByZXR1cm4gKG5ldyBBcnJheShwYXJzZUludChjb3VudCwgMTApICsgMSB8fCAwKSkuam9pbih0aGlzXyk7CiAgICB9LAogICAgcXc6IGZ1bmN0aW9uKHRoaXNfKXsKICAgICAgdmFyIHRyaW1tZWQgPSB0aGlzXy50cmltKCk7CiAgICAgIHJldHVybiB0cmltbWVkID8gdHJpbW1lZC5zcGxpdCgvXHMrLykgOiBbXTsKICAgIH0sCiAgICBmb3JSZWdFeHA6IGZ1bmN0aW9uKHRoaXNfKXsKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoRVNDQVBFX0ZPUl9SRUdFWFAsICdcXCQxJyk7CiAgICB9LAogICAgZm9ybWF0OiBmdW5jdGlvbih0aGlzXywgZmlyc3QpewogICAgICB2YXIgZGF0YSA9IGFycmF5RnJvbShhcmd1bWVudHMsIDEpOwoKICAgICAgaWYgKHR5cGVvZiBmaXJzdCA9PSAnb2JqZWN0JykKICAgICAgICBleHRlbmQoZGF0YSwgZmlyc3QpOwoKICAgICAgcmV0dXJuIHRoaXNfLnJlcGxhY2UoRk9STUFUX1JFR0VYUCwKICAgICAgICBmdW5jdGlvbihtLCBrZXksIG51bUZvcm1hdCwgbnVtLCBub051bGwpewogICAgICAgICAgdmFyIHZhbHVlID0ga2V5IGluIGRhdGEgPyBkYXRhW2tleV0gOiAobm9OdWxsID8gJycgOiBtKTsKICAgICAgICAgIGlmIChudW1Gb3JtYXQgJiYgIWlzTmFOKHZhbHVlKSkKICAgICAgICAgIHsKICAgICAgICAgICAgdmFsdWUgPSBOdW1iZXIodmFsdWUpOwogICAgICAgICAgICByZXR1cm4gbnVtRm9ybWF0ID09ICcuJwogICAgICAgICAgICAgID8gdmFsdWUudG9GaXhlZChudW0pCiAgICAgICAgICAgICAgOiBudW1iZXJGdW5jdGlvbnMubGVhZCh2YWx1ZSwgbnVtKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICk7CiAgICB9LAogICAgY2FwaXRhbGl6ZTogZnVuY3Rpb24odGhpc18pewogICAgICByZXR1cm4gdGhpc18uY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB0aGlzXy5zdWJzdHIoMSkudG9Mb3dlckNhc2UoKTsKICAgIH0sCiAgICBjYW1lbGl6ZTogZnVuY3Rpb24odGhpc18pewogICAgICByZXR1cm4gdGhpc18ucmVwbGFjZSgvLSguKS9nLCBmdW5jdGlvbihtLCBjaHIpewogICAgICAgIHJldHVybiBjaHIudG9VcHBlckNhc2UoKTsKICAgICAgfSk7CiAgICB9LAogICAgZGFzaGVyaXplOiBmdW5jdGlvbih0aGlzXyl7CiAgICAgIHJldHVybiB0aGlzXy5yZXBsYWNlKC9bQS1aXS9nLCBmdW5jdGlvbihtKXsKICAgICAgICByZXR1cm4gJy0nICsgbS50b0xvd2VyQ2FzZSgpOwogICAgICB9KTsKICAgIH0sCgogICAgaXNFbXB0eTogZnVuY3Rpb24odmFsdWUpewogICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCBTdHJpbmcodmFsdWUpID09ICcnOwogICAgfSwKICAgIGlzTm90RW1wdHk6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuIHZhbHVlICE9IG51bGwgJiYgU3RyaW5nKHZhbHVlKSAhPSAnJzsKICAgIH0KICB9OwoKCiAgLy8gRml4IHNvbWUgbWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tLS0KICAvLyBJRSA1LjAtOC4wIGZpeAogIC8vIDEuIHJlc3VsdCBhcnJheSB3aXRob3V0IG51bGwgZWxlbWVudHMKICAvLyAyLiB3aGVuIHBhcmVudGhlc2lzIHVzZXMsIHJlc3VsdCBhcnJheSB3aXRoIG5vIHBhcmVudGhlc2lzIHZhbHVlCiAgaWYgKCd8fHwnLnNwbGl0KC9cfC8pLmxlbmd0aCArICd8fHwnLnNwbGl0KC8oXHwpLykubGVuZ3RoICE9IDExKQogIHsKICAgIHZhciBuYXRpdmVTdHJpbmdTcGxpdCA9IFN0cmluZy5wcm90b3R5cGUuc3BsaXQ7CiAgICBTdHJpbmcucHJvdG90eXBlLnNwbGl0ID0gZnVuY3Rpb24ocGF0dGVybiwgY291bnQpewogICAgICBpZiAoIXBhdHRlcm4gfHwgcGF0dGVybiBpbnN0YW5jZW9mIFJlZ0V4cCA9PSBmYWxzZSB8fCBwYXR0ZXJuLnNvdXJjZSA9PSAnJykKICAgICAgICByZXR1cm4gbmF0aXZlU3RyaW5nU3BsaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgdmFyIHBvcyA9IDA7CiAgICAgIHZhciBtYXRjaDsKCiAgICAgIGlmICghcGF0dGVybi5nbG9iYWwpCiAgICAgICAgcGF0dGVybiA9IG5ldyBSZWdFeHAocGF0dGVybi5zb3VyY2UsIC9cLyhbbWldKikkLy5leGVjKHBhdHRlcm4pWzFdICsgJ2cnKTsKCiAgICAgIHdoaWxlIChtYXRjaCA9IHBhdHRlcm4uZXhlYyh0aGlzKSkKICAgICAgewogICAgICAgIG1hdGNoWzBdID0gdGhpcy5zdWJzdHJpbmcocG9zLCBtYXRjaC5pbmRleCk7CiAgICAgICAgcmVzdWx0LnB1c2guYXBwbHkocmVzdWx0LCBtYXRjaCk7CiAgICAgICAgcG9zID0gcGF0dGVybi5sYXN0SW5kZXg7CiAgICAgIH0KCiAgICAgIHJlc3VsdC5wdXNoKHRoaXMuc3Vic3RyKHBvcykpOwoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfQoKICAvLyBJRSA1LjAtOC4wIGZpeAogIGlmICgnMTInLnN1YnN0cigtMSkgIT0gJzInKQogIHsKICAgIHZhciBuYXRpdmVTdHJpbmdTdWJzdHIgPSBTdHJpbmcucHJvdG90eXBlLnN1YnN0cjsKICAgIFN0cmluZy5wcm90b3R5cGUuc3Vic3RyID0gZnVuY3Rpb24oc3RhcnQsIGVuZCl7CiAgICAgIHJldHVybiBuYXRpdmVTdHJpbmdTdWJzdHIuY2FsbCh0aGlzLCBzdGFydCA8IDAgPyBNYXRoLm1heCgwLCB0aGlzLmxlbmd0aCArIHN0YXJ0KSA6IHN0YXJ0LCBlbmQpOwogICAgfTsKICB9CgoKIC8qKgogICogTnVtYmVyIGV4dGVuc2lvbnMKICAqIEBuYW1lc3BhY2UgTnVtYmVyLnByb3RvdHlwZQogICovCgogIHZhciBudW1iZXJGdW5jdGlvbnMgPSB7CiAgICBmaXQ6IGZ1bmN0aW9uKHRoaXNfLCBtaW4sIG1heCl7CiAgICAgIGlmICghaXNOYU4obWluKSAmJiB0aGlzXyA8IG1pbikKICAgICAgICByZXR1cm4gTnVtYmVyKG1pbik7CiAgICAgIGlmICghaXNOYU4obWF4KSAmJiB0aGlzXyA+IG1heCkKICAgICAgICByZXR1cm4gTnVtYmVyKG1heCk7CiAgICAgIHJldHVybiB0aGlzXzsKICAgIH0sCiAgICBsZWFkOiBmdW5jdGlvbih0aGlzXywgbGVuLCBsZWFkQ2hhcil7CiAgICAgIC8vIGNvbnZlcnQgdG8gc3RyaW5nIGFuZCBsZWFkIGZpcnN0IGRpZ2l0cyBieSBsZWFkQ2hhcgogICAgICByZXR1cm4gU3RyaW5nKHRoaXNfKS5yZXBsYWNlKC9cZCsvLCBmdW5jdGlvbihudW1iZXIpewogICAgICAgIC8vIHN1YnN0cmFjdCBudW1iZXIgbGVuZ3RoIGZyb20gZGVzaXJlZCBsZW5ndGggY29udmVydGluZyBsZW4gdG8gTnVtYmVyIGFuZCBpbmRpY2F0ZXMgaG93IG11Y2ggbGVhZENoYXJzIHdlIG5lZWQgdG8gYWRkCiAgICAgICAgLy8gaGVyZSBpcyBubyBpc05hTihsZW4pIGNoZWNrLCBiZWNhdXNlIGNvbXBhcmF0aW9uIG9mIE5hTiBhbmQgYSBOdW1iZXIgaXMgYWx3YXlzIGZhbHNlCiAgICAgICAgcmV0dXJuIChsZW4gLT0gbnVtYmVyLmxlbmd0aCAtIDEpID4gMSA/IG5ldyBBcnJheShsZW4pLmpvaW4obGVhZENoYXIgfHwgMCkgKyBudW1iZXIgOiBudW1iZXI7CiAgICAgIH0pOwogICAgfSwKICAgIGdyb3VwOiBmdW5jdGlvbih0aGlzXywgbGVuLCBzcGxpdHRlcil7CiAgICAgIHJldHVybiBTdHJpbmcodGhpc18pLnJlcGxhY2UoL1xkKy8sIGZ1bmN0aW9uKG51bWJlcil7CiAgICAgICAgcmV0dXJuIG51bWJlci5yZXBsYWNlKC9cZC9nLCBmdW5jdGlvbihtLCBwb3MpewogICAgICAgICAgcmV0dXJuICFwb3MgKyAobnVtYmVyLmxlbmd0aCAtIHBvcykgJSAobGVuIHx8IDMpID8gbSA6IChzcGxpdHRlciB8fCAnICcpICsgbTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAogICAgZm9ybWF0OiBmdW5jdGlvbih0aGlzXywgcHJlYywgZ3MsIHByZWZpeCwgcG9zdGZpeCwgY29tbWEpewogICAgICB2YXIgcmVzID0gdGhpc18udG9GaXhlZChwcmVjKTsKICAgICAgaWYgKGdzIHx8IGNvbW1hKQogICAgICAgIHJlcyA9IHJlcy5yZXBsYWNlKC8oXGQrKShcLj8pLywgZnVuY3Rpb24obSwgbnVtYmVyLCBjKXsKICAgICAgICAgIHJldHVybiAoZ3MgPyBiYXNpcy5udW1iZXIuZ3JvdXAoTnVtYmVyKG51bWJlciksIDMsIGdzKSA6IG51bWJlcikgKyAoYyA/IGNvbW1hIHx8IGMgOiAnJyk7CiAgICAgICAgfSk7CiAgICAgIGlmIChwcmVmaXgpCiAgICAgICAgcmVzID0gcmVzLnJlcGxhY2UoL14tPy8sICckJicgKyAocHJlZml4IHx8ICcnKSk7CiAgICAgIHJldHVybiByZXMgKyAocG9zdGZpeCB8fCAnJyk7CiAgICB9CiAgfTsKCgogIC8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgLy8gRGF0ZSAob3RoZXIgZXh0ZW5zaW9ucyAmIGZpeGVzIG1vdmVkIHRvIGJhc2lzLmRhdGUpCiAgLy8KCiAvKioKICAqIEBuYW1lc3BhY2UgRGF0ZQogICovCgogIGNvbXBsZXRlKERhdGUsIHsKICAgLyoqCiAgICAqIFJldHVybnMgdGhlIG1pbGxpc2Vjb25kcyBlbGFwc2VkIHNpbmNlIDEgSmFudWFyeSAxOTcwIDAwOjAwOjAwIFVUQyB1cCB1bnRpbCBub3cgYXMgYSBudW1iZXIuCiAgICAqIFdoZW4gdXNpbmcgbm93IHRvIGNyZWF0ZSB0aW1lc3RhbXBzIG9yIHVuaXF1ZSBJRHMsIGtlZXAgaW4gbWluZCB0aGF0IHRoZSByZXNvbHV0aW9uIG1heSBiZQogICAgKiAxNSBtaWxsaXNlY29uZHMgb24gV2luZG93cywgc28geW91IGNvdWxkIGVuZCB1cCB3aXRoIHNldmVyYWwgZXF1YWwgdmFsdWVzIGlmIG5vdyBpcyBjYWxsZWQKICAgICogbXVsdGlwbGUgdGltZXMgd2l0aGluIGEgc2hvcnQgdGltZSBzcGFuLgogICAgKgogICAgKiBUaGlzIG1ldGhvZCB3YXMgc3RhbmRhcmRpemVkIGluIEVDTUEtMjYyIDV0aCBlZGl0aW9uLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgbm93OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gTnVtYmVyKG5ldyBEYXRlKCkpOwogICAgfQogIH0pOwoKCiAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAvLyBNYWluIHBhcnQKICAvLwoKIC8qKgogICogUm9vdCBuYW1lc3BhY2UgZm9yIGJhc2lzLmpzIGZyYW1ld29yay4KICAqIEBuYW1lc3BhY2UgYmFzaXMKICAqLwoKIC8qKgogICogQXR0YWNoIGRvY3VtZW50IHJlYWR5IGhhbmRsZXJzCiAgKiBAcGFyYW0ge2Z1bmN0aW9uKCl9IGNhbGxiYWNrCiAgKiBAcGFyYW0geyp9IGNvbnRleHQgQ29udGV4dCBmb3IgaGFuZGxlcgogICovCiAgdmFyIHJlYWR5ID0gKGZ1bmN0aW9uKCl7CiAgICAvLyBNYXR0aGlhcyBNaWxsZXIvTWFyayBXdWJiZW4vUGF1bCBTb3dkZW4vRGVhbiBFZHdhcmRzL0pvaG4gUmVzaWcvUm9tYW4gRHZvcm5vdgoKICAgIGZ1bmN0aW9uIGlzUmVhZHkoKXsKICAgICAgcmV0dXJuIGRvY3VtZW50LnJlYWR5U3RhdGUgPT0gJ2NvbXBsZXRlJyAmJiAhIWRvY3VtZW50LmJvZHk7CiAgICB9CgogICAgdmFyIGZpcmVkID0gIWRvY3VtZW50IHx8IGlzUmVhZHkoKTsKICAgIHZhciBkZWZlcnJlZEhhbmRsZXI7CgogICAgZnVuY3Rpb24gcnVuUmVhZHlIYW5kbGVyKGhhbmRsZXIpewogICAgICBoYW5kbGVyLmNhbGxiYWNrLmNhbGwoaGFuZGxlci5jb250ZXh0KTsKICAgIH0KCiAgICBmdW5jdGlvbiBmaXJlSGFuZGxlcnMoKXsKICAgICAgaWYgKGlzUmVhZHkoKSkKICAgICAgICBpZiAoIWZpcmVkKyspCiAgICAgICAgICB3aGlsZSAoZGVmZXJyZWRIYW5kbGVyKQogICAgICAgICAgewogICAgICAgICAgICBydW5SZWFkeUhhbmRsZXIoZGVmZXJyZWRIYW5kbGVyKTsKICAgICAgICAgICAgZGVmZXJyZWRIYW5kbGVyID0gZGVmZXJyZWRIYW5kbGVyLm5leHQ7CiAgICAgICAgICB9CiAgICB9CgogICAgLy8gVGhlIERPTSByZWFkeSBjaGVjayBmb3IgSW50ZXJuZXQgRXhwbG9yZXIKICAgIGZ1bmN0aW9uIGRvU2Nyb2xsQ2hlY2soKXsKICAgICAgdHJ5IHsKICAgICAgICAvLyBJZiBJRSBpcyB1c2VkLCB1c2UgdGhlIHRyaWNrIGJ5IERpZWdvIFBlcmluaQogICAgICAgIC8vIGh0dHA6Ly9qYXZhc2NyaXB0Lm53Ym94LmNvbS9JRUNvbnRlbnRMb2FkZWQvCiAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRvU2Nyb2xsKCdsZWZ0Jyk7CiAgICAgICAgZmlyZUhhbmRsZXJzKCk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIHNldFRpbWVvdXQoZG9TY3JvbGxDaGVjaywgMSk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoIWZpcmVkKQogICAgewogICAgICBpZiAoZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcikKICAgICAgewogICAgICAgIC8vIHVzZSB0aGUgcmVhbCBldmVudCBmb3IgYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0IChhbGwgbW9kZXJuIGJyb3dzZXJzIHN1cHBvcnQgaXQpCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZpcmVIYW5kbGVycywgZmFsc2UpOwoKICAgICAgICAvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawogICAgICAgIGdsb2JhbC5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgZmlyZUhhbmRsZXJzLCBmYWxzZSk7CiAgICAgIH0KICAgICAgZWxzZQogICAgICB7CiAgICAgICAgLy8gZW5zdXJlIGZpcmluZyBiZWZvcmUgb25sb2FkLAogICAgICAgIC8vIG1heWJlIGxhdGUgYnV0IHNhZmUgYWxzbyBmb3IgaWZyYW1lcwogICAgICAgIGRvY3VtZW50LmF0dGFjaEV2ZW50KCdvbnJlYWR5c3RhdGVjaGFuZ2UnLCBmaXJlSGFuZGxlcnMpOwoKICAgICAgICAvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawogICAgICAgIGdsb2JhbC5hdHRhY2hFdmVudCgnb25sb2FkJywgZmlyZUhhbmRsZXJzKTsKCiAgICAgICAgLy8gSWYgSUUgYW5kIG5vdCBhIGZyYW1lCiAgICAgICAgLy8gY29udGludWFsbHkgY2hlY2sgdG8gc2VlIGlmIHRoZSBkb2N1bWVudCBpcyByZWFkeQogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoIWdsb2JhbC5mcmFtZUVsZW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRvU2Nyb2xsKQogICAgICAgICAgICBkb1Njcm9sbENoZWNrKCk7CiAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gcmV0dXJuIGF0dGFjaCBmdW5jdGlvbgogICAgcmV0dXJuIGZ1bmN0aW9uKGNhbGxiYWNrLCBjb250ZXh0KXsKICAgICAgaWYgKCFmaXJlZCkKICAgICAgewogICAgICAgIGRlZmVycmVkSGFuZGxlciA9IHsKICAgICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjaywKICAgICAgICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICAgICAgICBuZXh0OiBkZWZlcnJlZEhhbmRsZXIKICAgICAgICB9OwogICAgICB9CiAgICAgIGVsc2UKICAgICAgICBydW5SZWFkeUhhbmRsZXIoewogICAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLAogICAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICAgIH0pOwogICAgfTsKICB9KSgpOwoKCiAvKioKICAqIERvY3VtZW50IGludGVyZmFjZSBmb3Igc2FmZSBhZGQvcmVtb3ZlIG5vZGVzIHRvL2Zyb20gaGVhZCBhbmQgYm9keS4KICAqLwogIHZhciBkb2N1bWVudEludGVyZmFjZSA9IChmdW5jdGlvbigpewogICAgdmFyIHRpbWVyOwogICAgdmFyIHJlZmVyZW5jZSA9IHt9OwogICAgdmFyIGNhbGxiYWNrcyA9IHsKICAgICAgaGVhZDogW10sCiAgICAgIGJvZHk6IFtdCiAgICB9OwoKICAgIGZ1bmN0aW9uIGdldFBhcmVudChuYW1lKXsKICAgICAgaWYgKGRvY3VtZW50ICYmICFyZWZlcmVuY2VbbmFtZV0pCiAgICAgIHsKICAgICAgICByZWZlcmVuY2VbbmFtZV0gPSBkb2N1bWVudFtuYW1lXSB8fCBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShuYW1lKVswXTsKCiAgICAgICAgaWYgKHJlZmVyZW5jZVtuYW1lXSkKICAgICAgICB7CiAgICAgICAgICB2YXIgaXRlbXMgPSBjYWxsYmFja3NbbmFtZV07CiAgICAgICAgICBkZWxldGUgY2FsbGJhY2tzW25hbWVdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGNiOyBjYiA9IGl0ZW1zW2ldOyBpKyspCiAgICAgICAgICAgIGNiWzBdLmNhbGwoY2JbMV0sIHJlZmVyZW5jZVtuYW1lXSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gcmVmZXJlbmNlW25hbWVdOwogICAgfQoKICAgIGZ1bmN0aW9uIGFkZCgpewogICAgICB2YXIgbmFtZSA9IHRoaXNbMF07CiAgICAgIHZhciBub2RlID0gdGhpc1sxXTsKICAgICAgdmFyIHJlZiA9IHRoaXNbMl07CgogICAgICByZW1vdmUobm9kZSk7CgogICAgICB2YXIgcGFyZW50ID0gZ2V0UGFyZW50KG5hbWUpOwogICAgICBpZiAocGFyZW50KQogICAgICB7CiAgICAgICAgaWYgKHJlZiA9PT0gdHJ1ZSkKICAgICAgICAgIHJlZiA9IHBhcmVudC5maXJzdENoaWxkOwoKICAgICAgICBpZiAoIXJlZiB8fCByZWYucGFyZW50Tm9kZSAhPT0gcGFyZW50KQogICAgICAgICAgcmVmID0gbnVsbDsKCiAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShub2RlLCByZWYpOwogICAgICB9CiAgICAgIGVsc2UKICAgICAgICBjYWxsYmFja3NbbmFtZV0ucHVzaChbYWRkLCBbbmFtZSwgbm9kZSwgcmVmXV0pOwogICAgfQoKICAgIGZ1bmN0aW9uIGRvY1JlYWR5KG5hbWUsIGZuLCBjb250ZXh0KXsKICAgICAgaWYgKGNhbGxiYWNrc1tuYW1lXSkKICAgICAgICBjYWxsYmFja3NbbmFtZV0ucHVzaChbZm4sIGNvbnRleHRdKTsKICAgICAgZWxzZQogICAgICAgIGZuLmNhbGwoY29udGV4dCwgcmVmZXJlbmNlW25hbWVdKTsKICAgIH0KCiAgICBmdW5jdGlvbiByZW1vdmUobm9kZSl7CiAgICAgIGZvciAodmFyIGtleSBpbiBjYWxsYmFja3MpCiAgICAgIHsKICAgICAgICB2YXIgZW50cnkgPSBhcnJheUZ1bmN0aW9ucy5zZWFyY2goY2FsbGJhY2tzW2tleV0sIG5vZGUsIGZ1bmN0aW9uKGl0ZW0pewogICAgICAgICAgcmV0dXJuIGl0ZW1bMV0gJiYgaXRlbVsxXVsxXTsKICAgICAgICB9KTsKCiAgICAgICAgaWYgKGVudHJ5KQogICAgICAgICAgYXJyYXlGdW5jdGlvbnMucmVtb3ZlKGNhbGxiYWNrc1trZXldLCBlbnRyeSk7CiAgICAgIH0KCiAgICAgIGlmIChub2RlICYmIG5vZGUucGFyZW50Tm9kZSAmJiBub2RlLnBhcmVudE5vZGUubm9kZVR5cGUgPT0gMSkKICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tQYXJlbnRzKCl7CiAgICAgIGlmICh0aW1lciAmJiBnZXRQYXJlbnQoJ2hlYWQnKSAmJiBnZXRQYXJlbnQoJ2JvZHknKSkKICAgICAgICB0aW1lciA9IGNsZWFySW50ZXJ2YWwodGltZXIpOwogICAgfQoKICAgIGlmIChkb2N1bWVudCAmJiAoIWdldFBhcmVudCgnaGVhZCcpIHx8ICFnZXRQYXJlbnQoJ2JvZHknKSkpCiAgICB7CiAgICAgIHRpbWVyID0gc2V0SW50ZXJ2YWwoY2hlY2tQYXJlbnRzLCA1KTsKICAgICAgcmVhZHkoY2hlY2tQYXJlbnRzKTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICBoZWFkOiB7CiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KXsKICAgICAgICAgIGRvY1JlYWR5KCdoZWFkJywgZm4sIGNvbnRleHQpOwogICAgICAgIH0sCiAgICAgICAgYWRkOiBmdW5jdGlvbihub2RlLCByZWYpewogICAgICAgICAgYWRkLmNhbGwoWydoZWFkJywgbm9kZSwgcmVmXSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBib2R5OiB7CiAgICAgICAgcmVhZHk6IGZ1bmN0aW9uKGZuLCBjb250ZXh0KXsKICAgICAgICAgIGRvY1JlYWR5KCdib2R5JywgZm4sIGNvbnRleHQpOwogICAgICAgIH0sCiAgICAgICAgYWRkOiBmdW5jdGlvbihub2RlLCByZWYpewogICAgICAgICAgYWRkLmNhbGwoWydib2R5Jywgbm9kZSwgcmVmXSk7CiAgICAgICAgfQogICAgICB9LAogICAgICByZW1vdmU6IHJlbW92ZQogICAgfTsKICB9KSgpOwoKCiAvKioKICAqIEBuYW1lc3BhY2UgYmFzaXMKICAqLwoKIC8qKgogICogU2luZ2xldG9uIG9iamVjdCB0byBkZXN0cm95IHJlZ2lzdHJlZCB2aWEge2Jhc2lzLmNsZWFuZXIuYWRkfSBtZXRob2Qgb2JqZWN0cyBvbiBwYWdlIHVubG9hZCBldmVudC4KICAqLwogIHZhciBjbGVhbmVyID0gKGZ1bmN0aW9uKCl7CiAgICB2YXIgb2JqZWN0cyA9IFtdOwoKICAgIGZ1bmN0aW9uIGRlc3Ryb3kobG9nKXsKICAgICAgLyoqIEBjdXQgKi8gdmFyIGxvZ0Rlc3Ryb3kgPSBsb2cgJiYgdHlwZW9mIGxvZyA9PSAnYm9vbGVhbic7CiAgICAgIHJlc3VsdC5nbG9iYWxEZXN0cm95ID0gdHJ1ZTsKICAgICAgcmVzdWx0LmFkZCA9ICR1bmRlZjsKICAgICAgcmVzdWx0LnJlbW92ZSA9ICR1bmRlZjsKCiAgICAgIHZhciBvYmplY3Q7CiAgICAgIHdoaWxlIChvYmplY3QgPSBvYmplY3RzLnBvcCgpKQogICAgICB7CiAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QuZGVzdHJveSA9PSAnZnVuY3Rpb24nKQogICAgICAgIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8qKiBAY3V0ICovIGlmIChsb2dEZXN0cm95KSBjb25zb2xlTWV0aG9kcy5sb2coJ2Rlc3Ryb3knLCAnWycgKyBTdHJpbmcob2JqZWN0LmNsYXNzTmFtZSkgKyAnXScsIG9iamVjdCk7CiAgICAgICAgICAgIG9iamVjdC5kZXN0cm95KCk7CiAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgLyoqIEBjdXQgKi8gY29uc29sZU1ldGhvZHMud2FybihTdHJpbmcob2JqZWN0KSwgZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIG9iamVjdCkKICAgICAgICAgICAgb2JqZWN0W3Byb3BdID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0KICAgICAgb2JqZWN0cy5sZW5ndGggPSAwOwogICAgfQoKICAgIGlmICgnYXR0YWNoRXZlbnQnIGluIGdsb2JhbCkKICAgICAgZ2xvYmFsLmF0dGFjaEV2ZW50KCdvbnVubG9hZCcsIGRlc3Ryb3kpOwogICAgZWxzZQogICAgICBpZiAoJ2FkZEV2ZW50TGlzdGVuZXInIGluIGdsb2JhbCkKICAgICAgICBnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigndW5sb2FkJywgZGVzdHJveSwgZmFsc2UpOwogICAgICBlbHNlCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGFkZDogJHVuZGVmLAogICAgICAgICAgcmVtb3ZlOiAkdW5kZWYKICAgICAgICB9OwoKICAgIHZhciByZXN1bHQgPSB7CiAgICAgIGFkZDogZnVuY3Rpb24ob2JqZWN0KXsKICAgICAgICBpZiAob2JqZWN0ICE9IG51bGwpCiAgICAgICAgICBvYmplY3RzLnB1c2gob2JqZWN0KTsKICAgICAgfSwKICAgICAgcmVtb3ZlOiBmdW5jdGlvbihvYmplY3QpewogICAgICAgIGFycmF5RnVuY3Rpb25zLnJlbW92ZShvYmplY3RzLCBvYmplY3QpOwogICAgICB9CiAgICB9OwoKICAgIC8vIGZvciBkZWJ1ZyBwdXJwb3NlcwogICAgLyoqIEBjdXQgKi8gcmVzdWx0LmRlc3Ryb3lfID0gZGVzdHJveTsKICAgIC8qKiBAY3V0ICovIHJlc3VsdC5vYmplY3RzXyA9IG9iamVjdHM7CgogICAgcmV0dXJuIHJlc3VsdDsKICB9KSgpOwoKCiAgLy8KICAvLyBDU1MgcmVzb3VyY2UKICAvLwoKICB2YXIgQ3NzUmVzb3VyY2UgPSAoZnVuY3Rpb24oKXsKICAgIC8vIFRlc3QgZm9yIGFwcGVuZENoaWxkIGJ1Z3MgKG9sZCBJRSBicm93c2VycyBoYXMgYSBwcm9ibGVtIHdpdGggYXBwZW5kIHRleHROb2RlIGludG8gPHN0eWxlPikKICAgIHZhciBTVFlMRV9BUFBFTkRfQlVHR1kgPSAoZnVuY3Rpb24oKXsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJykuYXBwZW5kQ2hpbGQoCiAgICAgICAgICBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnJykKICAgICAgICApOwogICAgICB9IGNhdGNoKGUpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSkoKTsKCgogICAvKioKICAgICogSGVscGVyIGZ1bmN0aW9ucyBmb3IgcGF0aCByZXNvbHZpbmcKICAgICovCiAgICB2YXIgYmFzZUVsID0gZG9jdW1lbnQgJiYgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYmFzZScpOwoKICAgIGZ1bmN0aW9uIHNldEJhc2UoYmFzZVVSSSl7CiAgICAgIC8vIE9wZXJhIGFuZCBJRSBkb2Vzbid0IHJlc29sdmUgcGF0aGVzIGNvcnJlY3RseSwgaWYgYmFzZSBocmVmIGlzIG5vdCBhbiBhYnNvbHV0ZSBwYXRoCiAgICAgIC8vIGNvbnZlcnQgcGF0aCB0byBhYnNvbHV0ZSB2YWx1ZQogICAgICBiYXNlRWwuc2V0QXR0cmlidXRlKCdocmVmJywgYmFzZVVSSSk7CgogICAgICAvLyBpZiBtb3JlIHRoYW4gb25lIDxiYXNlPiBlbGVtZW50cyBpbiBkb2N1bWVudCwgb25seSBmaXJzdCBoYXMgZWZmZWN0CiAgICAgIC8vIHB1dCBvdXIgPGJhc2U+IHJlc29sdmVyIGF0IHRoZSBiZWdpbmluZyBvZiA8aGVhZD4KICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5hZGQoYmFzZUVsLCB0cnVlKTsKICAgIH0KCiAgICBmdW5jdGlvbiByZXN0b3JlQmFzZSgpewogICAgICAvLyBPcGVyYSBsZWZ0IGRvY3VtZW50IGJhc2UgYXMgPGJhc2U+IGVsZW1lbnQgc3BlY2lmaWVkLAogICAgICAvLyBldmVuIGlmIHRoaXMgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gZG9jdW1lbnQKICAgICAgLy8gc28gd2Ugc2V0IGN1cnJlbnQgbG9jYXRpb24gZm9yIGJhc2UKICAgICAgYmFzZUVsLnNldEF0dHJpYnV0ZSgnaHJlZicsIGxvY2F0aW9uLmhyZWYpOwoKICAgICAgZG9jdW1lbnRJbnRlcmZhY2UucmVtb3ZlKGJhc2VFbCk7CiAgICB9CgogICAgLy8gaW5qZWN0IHN0eWxlIGludG8gZG9jdW1lbnQKICAgIGZ1bmN0aW9uIGluamVjdFN0eWxlVG9IZWFkKCl7CiAgICAgIC8vIHNldCBiYXNlIGJlZm9yZSA8c3R5bGU+IGVsZW1lbnQgY3JlYXRpbmcsIGJlY2F1c2UgSUU5KyBzZXQgYmFzZVVSSQogICAgICAvLyBmb3IgPHN0eWxlPiBlbGVtZW50IG9uIGVsZW1lbnQgY3JlYXRpb24KICAgICAgc2V0QmFzZSh0aGlzLmJhc2VVUkkpOwoKICAgICAgLy8gY3JlYXRlIDxzdHlsZT4gZWxlbWVudCBmb3IgZmlyc3QgdGltZQogICAgICBpZiAoIXRoaXMuZWxlbWVudCkKICAgICAgewogICAgICAgIHRoaXMuZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CgogICAgICAgIGlmICghU1RZTEVfQVBQRU5EX0JVR0dZKQogICAgICAgICAgdGhpcy5lbGVtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcnKSk7CgogICAgICAgIC8qKiBAY3V0ICovIHRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3NyYycsIHRoaXMudXJsKTsKICAgICAgfQoKICAgICAgLy8gYWRkIGVsZW1lbnQgdG8gZG9jdW1lbnQKICAgICAgZG9jdW1lbnRJbnRlcmZhY2UuaGVhZC5hZGQodGhpcy5lbGVtZW50KTsKCiAgICAgIC8vIHNldCBjc3MgdGV4dCBhZnRlciBub2RlIGluc2VydGVkIGludG8gZG9jdW1lbnQsCiAgICAgIC8vIElFOCBhbmQgbG93ZXIgY3Jhc2ggb3RoZXJ3aXNlICh0aGlzLmVsZW1lbnQuc3R5bGVTaGVldCBpcyBub3QgZGVmaW5lZCkKICAgICAgdGhpcy5zeW5jQ3NzVGV4dCgpOwoKICAgICAgcmVzdG9yZUJhc2UoKTsKICAgIH0KCgogICAvKioKICAgICogQGNsYXNzCiAgICAqLwogICAgcmV0dXJuIENsYXNzKG51bGwsIHsKICAgICAgY2xhc3NOYW1lOiAnYmFzaXMuQ3NzUmVzb3VyY2UnLAoKICAgICAgaW5Vc2U6IDAsCgogICAgICB1cmw6ICcnLAogICAgICBiYXNlVVJJOiAnJywKICAgICAgY3NzVGV4dDogdW5kZWZpbmVkLAoKICAgICAgZWxlbWVudDogbnVsbCwKCiAgICAgIGluaXQ6IGZ1bmN0aW9uKHVybCl7CiAgICAgICAgdGhpcy51cmwgPSB1cmw7CiAgICAgICAgdGhpcy5iYXNlVVJJID0gcGF0aFV0aWxzLmRpcm5hbWUodXJsKSArICcvJzsKICAgICAgfSwKCiAgICAgIHVwZGF0ZUNzc1RleHQ6IGZ1bmN0aW9uKGNzc1RleHQpewogICAgICAgIGlmICh0aGlzLmNzc1RleHQgIT0gY3NzVGV4dCkKICAgICAgICB7CiAgICAgICAgICB0aGlzLmNzc1RleHQgPSBjc3NUZXh0OwoKICAgICAgICAgIGlmICh0aGlzLmluVXNlICYmIHRoaXMuZWxlbWVudCkKICAgICAgICAgIHsKICAgICAgICAgICAgc2V0QmFzZSh0aGlzLmJhc2VVUkkpOwogICAgICAgICAgICB0aGlzLnN5bmNDc3NUZXh0KCk7CiAgICAgICAgICAgIHJlc3RvcmVCYXNlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAoKICAgICAgc3luY0Nzc1RleHQ6IFNUWUxFX0FQUEVORF9CVUdHWQogICAgICAgIC8vIG9sZCBJRQogICAgICAgID8gZnVuY3Rpb24oKXsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LnN0eWxlU2hlZXQuY3NzVGV4dCA9IHRoaXMuY3NzVGV4dDsKICAgICAgICAgIH0KICAgICAgICAvLyBXM0MgYnJvd3NlcnMKICAgICAgICA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciBjc3NUZXh0ID0gdGhpcy5jc3NUZXh0OwoKICAgICAgICAgICAgLyoqIEBjdXQgYWRkIHNvdXJjZSB1cmwgZm9yIGRlYnVnICovCiAgICAgICAgICAgIC8qKiBAY3V0ICovIGNzc1RleHQgKz0gJ1xuLyojIHNvdXJjZVVSTD0nICsgcGF0aFV0aWxzLm9yaWdpbiArIHRoaXMudXJsICsgJyAqLyc7CgogICAgICAgICAgICB0aGlzLmVsZW1lbnQuZmlyc3RDaGlsZC5ub2RlVmFsdWUgPSBjc3NUZXh0OwogICAgICAgICAgfSwKCiAgICAgIHN0YXJ0VXNlOiBmdW5jdGlvbigpewogICAgICAgIGlmICghdGhpcy5pblVzZSkKICAgICAgICAgIGRvY3VtZW50SW50ZXJmYWNlLmhlYWQucmVhZHkoaW5qZWN0U3R5bGVUb0hlYWQsIHRoaXMpOwoKICAgICAgICB0aGlzLmluVXNlICs9IDE7CiAgICAgIH0sCgogICAgICBzdG9wVXNlOiBmdW5jdGlvbigpewogICAgICAgIGlmICh0aGlzLmluVXNlKQogICAgICAgIHsKICAgICAgICAgIC8vIGRlY3JlYXNlIHVzYWdlIGNvdW50CiAgICAgICAgICB0aGlzLmluVXNlIC09IDE7CgogICAgICAgICAgLy8gcmVtb3ZlIGVsZW1lbnQgaWYgbm9ib2R5IHVzZSBpdAogICAgICAgICAgaWYgKCF0aGlzLmluVXNlICYmIHRoaXMuZWxlbWVudCkKICAgICAgICAgICAgZG9jdW1lbnRJbnRlcmZhY2UucmVtb3ZlKHRoaXMuZWxlbWVudCk7CiAgICAgICAgfQogICAgICB9LAoKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKXsKICAgICAgICBpZiAodGhpcy5lbGVtZW50KQogICAgICAgICAgZG9jdW1lbnRJbnRlcmZhY2UucmVtb3ZlKHRoaXMuZWxlbWVudCk7CgogICAgICAgIHRoaXMuZWxlbWVudCA9IG51bGw7CiAgICAgICAgdGhpcy5jc3NUZXh0ID0gbnVsbDsKICAgICAgfQogICAgfSk7CiAgfSkoKTsKCgogIC8vCiAgLy8gZXhwb3J0IG5hbWVzCiAgLy8KCiAgLy8gY3JlYXRlIGFuZCBleHRlbmQgYmFzaXMgbmFtZXNwYWNlCiAgdmFyIGJhc2lzID0gZ2V0TmFtZXNwYWNlKCdiYXNpcycpLmV4dGVuZCh7CiAgICAvKiogQGN1dCAqLyBmaWxlbmFtZV86IGJhc2lzRmlsZW5hbWUsCiAgICAvKiogQGN1dCAqLyBwcm9jZXNzQ29uZmlnOiBwcm9jZXNzQ29uZmlnLAoKICAgIC8vIHByb3BlcnRpZXMgYW5kIHNldHRpbmdzCiAgICB2ZXJzaW9uOiBWRVJTSU9OLAoKICAgIC8vIGNvbmZpZyBhbmQgZW52aXJvbm1lbnQKICAgIE5PREVfRU5WOiBOT0RFX0VOViwKICAgIGNvbmZpZzogY29uZmlnLAogICAgY3JlYXRlU2FuZGJveDogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgcmV0dXJuIGNyZWF0ZUJhc2lzSW5zdGFuY2UoCiAgICAgICAgZ2xvYmFsLAogICAgICAgIGJhc2lzRmlsZW5hbWUsCiAgICAgICAgY29tcGxldGUoeyBub0NvbmZsaWN0OiB0cnVlIH0sIGNvbmZpZykKICAgICAgKTsKICAgIH0sCgogICAgLy8gbW9kdWxhcml0eQogICAgcmVzb2x2ZU5TRmlsZW5hbWU6IHJlc29sdmVOU0ZpbGVuYW1lLAogICAgcGF0Y2g6IHBhdGNoLAogICAgbmFtZXNwYWNlOiBnZXROYW1lc3BhY2UsCiAgICByZXF1aXJlOiByZXF1aXJlTmFtZXNwYWNlLAogICAgcmVzb3VyY2U6IGdldFJlc291cmNlLAogICAgYXNzZXQ6IGZ1bmN0aW9uKHVybCl7ICAgLy8gTk9URTogZG9uJ3QgcmVwbGFjZSBmb3IgJHNlbGYsIGJ1aWxkZXIgYXR0YWNoCiAgICAgIHJldHVybiB1cmw7ICAgICAgICAgICAvLyBzcGVjaWFsIGhhbmRsZXIgZm9yIHRoaXMgZnVuY3Rpb24KICAgIH0sCgogICAgLy8gdGltZXJzCiAgICBzZXRJbW1lZGlhdGU6IHNldEltbWVkaWF0ZSwKICAgIGNsZWFySW1tZWRpYXRlOiBjbGVhckltbWVkaWF0ZSwKICAgIG5leHRUaWNrOiBmdW5jdGlvbigpewogICAgICBzZXRJbW1lZGlhdGUuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gY2xhc3NlcwogICAgQ2xhc3M6IENsYXNzLAogICAgVG9rZW46IFRva2VuLAogICAgRGVmZXJyZWRUb2tlbjogRGVmZXJyZWRUb2tlbiwKCiAgICAvLyB1dGlsIGZ1bmN0aW9ucwogICAgZ2VuVUlEOiBnZW5VSUQsCiAgICBnZXR0ZXI6IGdldHRlciwKICAgIHJlYWR5OiByZWFkeSwKCiAgICBjbGVhbmVyOiBjbGVhbmVyLAogICAgY29uc29sZTogY29uc29sZU1ldGhvZHMsCiAgICBwYXRoOiBwYXRoVXRpbHMsCiAgICBkb2M6IGRvY3VtZW50SW50ZXJmYWNlLAoKICAgIG9iamVjdDogewogICAgICBleHRlbmQ6IGV4dGVuZCwKICAgICAgY29tcGxldGU6IGNvbXBsZXRlLAogICAgICBrZXlzOiBrZXlzLAogICAgICB2YWx1ZXM6IHZhbHVlcywKICAgICAgc2xpY2U6IHNsaWNlLAogICAgICBzcGxpY2U6IHNwbGljZSwKICAgICAgbWVyZ2U6IG1lcmdlLAogICAgICBpdGVyYXRlOiBpdGVyYXRlCiAgICB9LAogICAgZm46IHsKICAgICAgLy8gdGVzdCBmdW5jdGlvbnMKICAgICAgJHVuZGVmaW5lZDogJHVuZGVmaW5lZCwKICAgICAgJGRlZmluZWQ6ICRkZWZpbmVkLAogICAgICAkaXNOdWxsOiAkaXNOdWxsLAogICAgICAkaXNOb3ROdWxsOiAkaXNOb3ROdWxsLAogICAgICAkaXNTYW1lOiAkaXNTYW1lLAogICAgICAkaXNOb3RTYW1lOiAkaXNOb3RTYW1lLAoKICAgICAgLy8gZ2FnIGZ1bmN0aW9ucwogICAgICAkc2VsZjogJHNlbGYsCiAgICAgICRjb25zdDogJGNvbnN0LAogICAgICAkZmFsc2U6ICRmYWxzZSwKICAgICAgJHRydWU6ICR0cnVlLAogICAgICAkbnVsbDogJG51bGwsCiAgICAgICR1bmRlZjogJHVuZGVmLAoKICAgICAgLy8gZ2V0dGVycyBhbmQgbW9kaWZpY2F0b3JzCiAgICAgIGdldHRlcjogZ2V0dGVyLAogICAgICBudWxsR2V0dGVyOiBudWxsR2V0dGVyLAogICAgICB3cmFwcGVyOiB3cmFwcGVyLAoKICAgICAgLy8gbGF6eQogICAgICBsYXp5SW5pdDogbGF6eUluaXQsCiAgICAgIGxhenlJbml0QW5kUnVuOiBsYXp5SW5pdEFuZFJ1biwKICAgICAgcnVuT25jZTogcnVuT25jZQogICAgfSwKICAgIGFycmF5OiBleHRlbmQoYXJyYXlGcm9tLCBhcnJheUZ1bmN0aW9ucyksCiAgICBzdHJpbmc6IHN0cmluZ0Z1bmN0aW9ucywKICAgIG51bWJlcjogbnVtYmVyRnVuY3Rpb25zLAogICAgYm9vbDogewogICAgICBpbnZlcnQ6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICByZXR1cm4gIXZhbHVlOwogICAgICB9CiAgICB9LAogICAganNvbjogewogICAgICBwYXJzZTogdHlwZW9mIEpTT04gIT0gJ3VuZGVmaW5lZCcKICAgICAgICA/IEpTT04ucGFyc2UKICAgICAgICA6IGZ1bmN0aW9uKHN0cil7CiAgICAgICAgICAgIHJldHVybiBzdHJpbmdGdW5jdGlvbnMudG9PYmplY3Qoc3RyLCB0cnVlKTsKICAgICAgICAgIH0KICAgIH0KICB9KTsKCiAgLy8gYWRkIGRldiBuYW1lc3BhY2UsIGhvc3QgZm9yIHNwZWNpYWwgZnVuY3Rpb25hbGl0eSBpbiBkZXZlbG9wbWVudCBlbnZpcm9ubWVudAogIGdldE5hbWVzcGFjZSgnYmFzaXMuZGV2JykuZXh0ZW5kKGNvbnNvbGVNZXRob2RzKTsKCgogIC8vCiAgLy8gYXV0byBsb2FkIHNlY3Rpb24KICAvLwoKICBpZiAoY29uZmlnLmF1dG9sb2FkKQogICAgY29uZmlnLmF1dG9sb2FkLmZvckVhY2goZnVuY3Rpb24obmFtZSl7CiAgICAgIHJlcXVpcmVOYW1lc3BhY2UobmFtZSk7CiAgICB9KTsKCgogIC8vCiAgLy8gcmV0dXJuIGJhc2lzIGluc3RhbmNlIChuZWVkcyBmb3IgY3JlYXRlU2FuZGJveCkKICAvLwoKICByZXR1cm4gYmFzaXM7Cgp9KSh0aGlzKTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 12:10:35 GMT",
                    "Content-Length": "97227",
                    "Date": "Thu, 06 Nov 2014 12:10:43 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}