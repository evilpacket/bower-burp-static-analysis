{
    "url": "http://localhost:9999/x-tag/panel/demo/x-tag-components.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>the 'baseURI' property of a DOM element</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statement:<ul><li>base.setAttribute('href', document.baseURI);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/x-tag/panel/demo/x-tag-components.js",
                "path": "/x-tag/panel/demo/x-tag-components.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC94LXRhZy9wYW5lbC9kZW1vL3gtdGFnLWNvbXBvbmVudHMuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogODczNjMNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDM6NDQ6NDEgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAzOjQ0OjQxIEdNVA0KDQovLyBXZSBkb24ndCB1c2UgdGhlIHBsYXRmb3JtIGJvb3RzdHJhcHBlciwgc28gZmFrZSB0aGlzIHN0dWZmLgoKd2luZG93LlBsYXRmb3JtID0ge307CnZhciBsb2dGbGFncyA9IHt9OwoKCgovLyBET01Ub2tlbkxpc3QgcG9seWZpbGwgZmlyIElFOQooZnVuY3Rpb24gKCkgewoKaWYgKHR5cGVvZiB3aW5kb3cuRWxlbWVudCA9PT0gInVuZGVmaW5lZCIgfHwgImNsYXNzTGlzdCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSByZXR1cm47Cgp2YXIgcHJvdG90eXBlID0gQXJyYXkucHJvdG90eXBlLAogICAgaW5kZXhPZiA9IHByb3RvdHlwZS5pbmRleE9mLAogICAgc2xpY2UgPSBwcm90b3R5cGUuc2xpY2UsCiAgICBwdXNoID0gcHJvdG90eXBlLnB1c2gsCiAgICBzcGxpY2UgPSBwcm90b3R5cGUuc3BsaWNlLAogICAgam9pbiA9IHByb3RvdHlwZS5qb2luOwoKZnVuY3Rpb24gRE9NVG9rZW5MaXN0KGVsKSB7CiAgdGhpcy5fZWxlbWVudCA9IGVsOwogIGlmIChlbC5jbGFzc05hbWUgIT0gdGhpcy5fY2xhc3NDYWNoZSkgewogICAgdGhpcy5fY2xhc3NDYWNoZSA9IGVsLmNsYXNzTmFtZTsKCiAgICBpZiAoIXRoaXMuX2NsYXNzQ2FjaGUpIHJldHVybjsKCiAgICAgIC8vIFRoZSBjbGFzc05hbWUgbmVlZHMgdG8gYmUgdHJpbW1lZCBhbmQgc3BsaXQgb24gd2hpdGVzcGFjZQogICAgICAvLyB0byByZXRyaWV2ZSBhIGxpc3Qgb2YgY2xhc3Nlcy4KICAgICAgdmFyIGNsYXNzZXMgPSB0aGlzLl9jbGFzc0NhY2hlLnJlcGxhY2UoL15ccyt8XHMrJC9nLCcnKS5zcGxpdCgvXHMrLyksCiAgICAgICAgaTsKICAgIGZvciAoaSA9IDA7IGkgPCBjbGFzc2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHB1c2guY2FsbCh0aGlzLCBjbGFzc2VzW2ldKTsKICAgIH0KICB9Cn07CgpmdW5jdGlvbiBzZXRUb0NsYXNzTmFtZShlbCwgY2xhc3NlcykgewogIGVsLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbignICcpOwp9CgpET01Ub2tlbkxpc3QucHJvdG90eXBlID0gewogIGFkZDogZnVuY3Rpb24odG9rZW4pIHsKICAgIGlmKHRoaXMuY29udGFpbnModG9rZW4pKSByZXR1cm47CiAgICBwdXNoLmNhbGwodGhpcywgdG9rZW4pOwogICAgc2V0VG9DbGFzc05hbWUodGhpcy5fZWxlbWVudCwgc2xpY2UuY2FsbCh0aGlzLCAwKSk7CiAgfSwKICBjb250YWluczogZnVuY3Rpb24odG9rZW4pIHsKICAgIHJldHVybiBpbmRleE9mLmNhbGwodGhpcywgdG9rZW4pICE9PSAtMTsKICB9LAogIGl0ZW06IGZ1bmN0aW9uKGluZGV4KSB7CiAgICByZXR1cm4gdGhpc1tpbmRleF0gfHwgbnVsbDsKICB9LAogIHJlbW92ZTogZnVuY3Rpb24odG9rZW4pIHsKICAgIHZhciBpID0gaW5kZXhPZi5jYWxsKHRoaXMsIHRva2VuKTsKICAgICBpZiAoaSA9PT0gLTEpIHsKICAgICAgIHJldHVybjsKICAgICB9CiAgICBzcGxpY2UuY2FsbCh0aGlzLCBpLCAxKTsKICAgIHNldFRvQ2xhc3NOYW1lKHRoaXMuX2VsZW1lbnQsIHNsaWNlLmNhbGwodGhpcywgMCkpOwogIH0sCiAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGpvaW4uY2FsbCh0aGlzLCAnICcpOwogIH0sCiAgdG9nZ2xlOiBmdW5jdGlvbih0b2tlbikgewogICAgaWYgKGluZGV4T2YuY2FsbCh0aGlzLCB0b2tlbikgPT09IC0xKSB7CiAgICAgIHRoaXMuYWRkKHRva2VuKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucmVtb3ZlKHRva2VuKTsKICAgIH0KICB9Cn07Cgp3aW5kb3cuRE9NVG9rZW5MaXN0ID0gRE9NVG9rZW5MaXN0OwoKZnVuY3Rpb24gZGVmaW5lRWxlbWVudEdldHRlciAob2JqLCBwcm9wLCBnZXR0ZXIpIHsKICBpZiAoT2JqZWN0LmRlZmluZVByb3BlcnR5KSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBwcm9wLHsKICAgICAgZ2V0IDogZ2V0dGVyCiAgICB9KQogIH0gZWxzZSB7CiAgICBvYmouX19kZWZpbmVHZXR0ZXJfXyhwcm9wLCBnZXR0ZXIpOwogIH0KfQoKZGVmaW5lRWxlbWVudEdldHRlcihFbGVtZW50LnByb3RvdHlwZSwgJ2NsYXNzTGlzdCcsIGZ1bmN0aW9uICgpIHsKICByZXR1cm4gbmV3IERPTVRva2VuTGlzdCh0aGlzKTsKfSk7Cgp9KSgpOwoKCi8qCiAqIENvcHlyaWdodCAyMDEyIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVyZW5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKLy8gU2lkZVRhYmxlIGlzIGEgd2VhayBtYXAgd2hlcmUgcG9zc2libGUuIElmIFdlYWtNYXAgaXMgbm90IGF2YWlsYWJsZSB0aGUKLy8gYXNzb2NpYXRpb24gaXMgc3RvcmVkIGFzIGFuIGV4cGFuZG8gcHJvcGVydHkuCnZhciBTaWRlVGFibGU7Ci8vIFRPRE8oYXJ2KTogV2Vha01hcCBkb2VzIG5vdCBhbGxvdyBmb3IgTm9kZSBldGMgdG8gYmUga2V5cyBpbiBGaXJlZm94CmlmICh0eXBlb2YgV2Vha01hcCAhPT0gJ3VuZGVmaW5lZCcgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdGaXJlZm94LycpIDwgMCkgewogIFNpZGVUYWJsZSA9IFdlYWtNYXA7Cn0gZWxzZSB7CiAgKGZ1bmN0aW9uKCkgewogICAgdmFyIGRlZmluZVByb3BlcnR5ID0gT2JqZWN0LmRlZmluZVByb3BlcnR5OwogICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0Lmhhc093blByb3BlcnR5OwogICAgdmFyIGNvdW50ZXIgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAlIDFlOTsKCiAgICBTaWRlVGFibGUgPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5uYW1lID0gJ19fc3QnICsgKE1hdGgucmFuZG9tKCkgKiAxZTkgPj4+IDApICsgKGNvdW50ZXIrKyArICdfXycpOwogICAgfTsKCiAgICBTaWRlVGFibGUucHJvdG90eXBlID0gewogICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICBkZWZpbmVQcm9wZXJ0eShrZXksIHRoaXMubmFtZSwge3ZhbHVlOiB2YWx1ZSwgd3JpdGFibGU6IHRydWV9KTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICByZXR1cm4gaGFzT3duUHJvcGVydHkuY2FsbChrZXksIHRoaXMubmFtZSkgPyBrZXlbdGhpcy5uYW1lXSA6IHVuZGVmaW5lZDsKICAgICAgfSwKICAgICAgZGVsZXRlOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICB0aGlzLnNldChrZXksIHVuZGVmaW5lZCk7CiAgICAgIH0KICAgIH0KICB9KSgpOwp9CgovKgogKiBDb3B5cmlnaHQgMjAxMiBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3ZlcmVuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihnbG9iYWwpIHsKCiAgdmFyIHJlZ2lzdHJhdGlvbnNUYWJsZSA9IG5ldyBTaWRlVGFibGUoKTsKCiAgLy8gV2UgdXNlIHNldEltbWVkaWF0ZSBvciBwb3N0TWVzc2FnZSBmb3Igb3VyIGZ1dHVyZSBjYWxsYmFjay4KICB2YXIgc2V0SW1tZWRpYXRlID0gd2luZG93Lm1zU2V0SW1tZWRpYXRlOwoKICAvLyBVc2UgcG9zdCBtZXNzYWdlIHRvIGVtdWxhdGUgc2V0SW1tZWRpYXRlLgogIGlmICghc2V0SW1tZWRpYXRlKSB7CiAgICB2YXIgc2V0SW1tZWRpYXRlUXVldWUgPSBbXTsKICAgIHZhciBzZW50aW5lbCA9IFN0cmluZyhNYXRoLnJhbmRvbSgpKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZnVuY3Rpb24oZSkgewogICAgICBpZiAoZS5kYXRhID09PSBzZW50aW5lbCkgewogICAgICAgIHZhciBxdWV1ZSA9IHNldEltbWVkaWF0ZVF1ZXVlOwogICAgICAgIHNldEltbWVkaWF0ZVF1ZXVlID0gW107CiAgICAgICAgcXVldWUuZm9yRWFjaChmdW5jdGlvbihmdW5jKSB7CiAgICAgICAgICBmdW5jKCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgc2V0SW1tZWRpYXRlID0gZnVuY3Rpb24oZnVuYykgewogICAgICBzZXRJbW1lZGlhdGVRdWV1ZS5wdXNoKGZ1bmMpOwogICAgICB3aW5kb3cucG9zdE1lc3NhZ2Uoc2VudGluZWwsICcqJyk7CiAgICB9OwogIH0KCiAgLy8gVGhpcyBpcyB1c2VkIHRvIGVuc3VyZSB0aGF0IHdlIG5ldmVyIHNjaGVkdWxlIDIgY2FsbGFzIHRvIHNldEltbWVkaWF0ZQogIHZhciBpc1NjaGVkdWxlZCA9IGZhbHNlOwoKICAvLyBLZWVwIHRyYWNrIG9mIG9ic2VydmVycyB0aGF0IG5lZWRzIHRvIGJlIG5vdGlmaWVkIG5leHQgdGltZS4KICB2YXIgc2NoZWR1bGVkT2JzZXJ2ZXJzID0gW107CgogIC8qKgogICAqIFNjaGVkdWxlcyB8ZGlzcGF0Y2hDYWxsYmFja3wgdG8gYmUgY2FsbGVkIGluIHRoZSBmdXR1cmUuCiAgICogQHBhcmFtIHtNdXRhdGlvbk9ic2VydmVyfSBvYnNlcnZlcgogICAqLwogIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbGJhY2sob2JzZXJ2ZXIpIHsKICAgIHNjaGVkdWxlZE9ic2VydmVycy5wdXNoKG9ic2VydmVyKTsKICAgIGlmICghaXNTY2hlZHVsZWQpIHsKICAgICAgaXNTY2hlZHVsZWQgPSB0cnVlOwogICAgICBzZXRJbW1lZGlhdGUoZGlzcGF0Y2hDYWxsYmFja3MpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gd3JhcElmTmVlZGVkKG5vZGUpIHsKICAgIHJldHVybiB3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwgJiYKICAgICAgICB3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwud3JhcElmTmVlZGVkKG5vZGUpIHx8CiAgICAgICAgbm9kZTsKICB9CgogIGZ1bmN0aW9uIGRpc3BhdGNoQ2FsbGJhY2tzKCkgewogICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI211dGF0aW9uLW9ic2VydmVycwoKICAgIGlzU2NoZWR1bGVkID0gZmFsc2U7IC8vIFVzZWQgdG8gYWxsb3cgYSBuZXcgc2V0SW1tZWRpYXRlIGNhbGwgYWJvdmUuCgogICAgdmFyIG9ic2VydmVycyA9IHNjaGVkdWxlZE9ic2VydmVyczsKICAgIHNjaGVkdWxlZE9ic2VydmVycyA9IFtdOwogICAgLy8gU29ydCBvYnNlcnZlcnMgYmFzZWQgb24gdGhlaXIgY3JlYXRpb24gVUlEIChpbmNyZW1lbnRhbCkuCiAgICBvYnNlcnZlcnMuc29ydChmdW5jdGlvbihvMSwgbzIpIHsKICAgICAgcmV0dXJuIG8xLnVpZF8gLSBvMi51aWRfOwogICAgfSk7CgogICAgdmFyIGFueU5vbkVtcHR5ID0gZmFsc2U7CiAgICBvYnNlcnZlcnMuZm9yRWFjaChmdW5jdGlvbihvYnNlcnZlcikgewoKICAgICAgLy8gMi4xLCAyLjIKICAgICAgdmFyIHF1ZXVlID0gb2JzZXJ2ZXIudGFrZVJlY29yZHMoKTsKICAgICAgLy8gMi4zLiBSZW1vdmUgYWxsIHRyYW5zaWVudCByZWdpc3RlcmVkIG9ic2VydmVycyB3aG9zZSBvYnNlcnZlciBpcyBtby4KICAgICAgcmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzRm9yKG9ic2VydmVyKTsKCiAgICAgIC8vIDIuNAogICAgICBpZiAocXVldWUubGVuZ3RoKSB7CiAgICAgICAgb2JzZXJ2ZXIuY2FsbGJhY2tfKHF1ZXVlLCBvYnNlcnZlcik7CiAgICAgICAgYW55Tm9uRW1wdHkgPSB0cnVlOwogICAgICB9CiAgICB9KTsKCiAgICAvLyAzLgogICAgaWYgKGFueU5vbkVtcHR5KQogICAgICBkaXNwYXRjaENhbGxiYWNrcygpOwogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzRm9yKG9ic2VydmVyKSB7CiAgICBvYnNlcnZlci5ub2Rlc18uZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKICAgICAgaWYgKCFyZWdpc3RyYXRpb25zKQogICAgICAgIHJldHVybjsKICAgICAgcmVnaXN0cmF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHJlZ2lzdHJhdGlvbikgewogICAgICAgIGlmIChyZWdpc3RyYXRpb24ub2JzZXJ2ZXIgPT09IG9ic2VydmVyKQogICAgICAgICAgcmVnaXN0cmF0aW9uLnJlbW92ZVRyYW5zaWVudE9ic2VydmVycygpOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGZvciB0aGUgIkZvciBlYWNoIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgb2JzZXJ2ZXIgKHdpdGgKICAgKiBvYnNlcnZlcidzIG9wdGlvbnMgYXMgb3B0aW9ucykgaW4gdGFyZ2V0J3MgbGlzdCBvZiByZWdpc3RlcmVkIG9ic2VydmVycywKICAgKiBydW4gdGhlc2Ugc3Vic3RlcHM6IiBhbmQgdGhlICJGb3IgZWFjaCBhbmNlc3RvciBhbmNlc3RvciBvZiB0YXJnZXQsIGFuZCBmb3IKICAgKiBlYWNoIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgb2JzZXJ2ZXIgKHdpdGggb3B0aW9ucyBvcHRpb25zKSBpbiBhbmNlc3RvcidzIGxpc3QKICAgKiBvZiByZWdpc3RlcmVkIG9ic2VydmVycywgcnVuIHRoZXNlIHN1YnN0ZXBzOiIgcGFydCBvZiB0aGUgYWxnb3JpdGhtcy4gVGhlCiAgICogfG9wdGlvbnMuc3VidHJlZXwgaXMgY2hlY2tlZCB0byBlbnN1cmUgdGhhdCB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkCiAgICogY29ycmVjdGx5LgogICAqCiAgICogQHBhcmFtIHtOb2RlfSB0YXJnZXQKICAgKiBAcGFyYW0ge2Z1bmN0aW9uKE11dGF0aW9uT2JzZXJ2ZXJJbml0KTpNdXRhdGlvblJlY29yZH0gY2FsbGJhY2sKICAgKi8KICBmdW5jdGlvbiBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBjYWxsYmFjaykgewogICAgZm9yICh2YXIgbm9kZSA9IHRhcmdldDsgbm9kZTsgbm9kZSA9IG5vZGUucGFyZW50Tm9kZSkgewogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CgogICAgICBpZiAocmVnaXN0cmF0aW9ucykgewogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGorKykgewogICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbiA9IHJlZ2lzdHJhdGlvbnNbal07CiAgICAgICAgICB2YXIgb3B0aW9ucyA9IHJlZ2lzdHJhdGlvbi5vcHRpb25zOwoKICAgICAgICAgIC8vIE9ubHkgdGFyZ2V0IGlnbm9yZXMgc3VidHJlZS4KICAgICAgICAgIGlmIChub2RlICE9PSB0YXJnZXQgJiYgIW9wdGlvbnMuc3VidHJlZSkKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgdmFyIHJlY29yZCA9IGNhbGxiYWNrKG9wdGlvbnMpOwogICAgICAgICAgaWYgKHJlY29yZCkKICAgICAgICAgICAgcmVnaXN0cmF0aW9uLmVucXVldWUocmVjb3JkKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIHZhciB1aWRDb3VudGVyID0gMDsKCiAgLyoqCiAgICogVGhlIGNsYXNzIHRoYXQgbWFwcyB0byB0aGUgRE9NIE11dGF0aW9uT2JzZXJ2ZXIgaW50ZXJmYWNlLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrLgogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIEpzTXV0YXRpb25PYnNlcnZlcihjYWxsYmFjaykgewogICAgdGhpcy5jYWxsYmFja18gPSBjYWxsYmFjazsKICAgIHRoaXMubm9kZXNfID0gW107CiAgICB0aGlzLnJlY29yZHNfID0gW107CiAgICB0aGlzLnVpZF8gPSArK3VpZENvdW50ZXI7CiAgfQoKICBKc011dGF0aW9uT2JzZXJ2ZXIucHJvdG90eXBlID0gewogICAgb2JzZXJ2ZTogZnVuY3Rpb24odGFyZ2V0LCBvcHRpb25zKSB7CiAgICAgIHRhcmdldCA9IHdyYXBJZk5lZWRlZCh0YXJnZXQpOwoKICAgICAgLy8gMS4xCiAgICAgIGlmICghb3B0aW9ucy5jaGlsZExpc3QgJiYgIW9wdGlvbnMuYXR0cmlidXRlcyAmJiAhb3B0aW9ucy5jaGFyYWN0ZXJEYXRhIHx8CgogICAgICAgICAgLy8gMS4yCiAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZU9sZFZhbHVlICYmICFvcHRpb25zLmF0dHJpYnV0ZXMgfHwKCiAgICAgICAgICAvLyAxLjMKICAgICAgICAgIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyICYmIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyLmxlbmd0aCAmJgogICAgICAgICAgICAgICFvcHRpb25zLmF0dHJpYnV0ZXMgfHwKCiAgICAgICAgICAvLyAxLjQKICAgICAgICAgIG9wdGlvbnMuY2hhcmFjdGVyRGF0YU9sZFZhbHVlICYmICFvcHRpb25zLmNoYXJhY3RlckRhdGEpIHsKCiAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCk7CiAgICAgIH0KCiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldCh0YXJnZXQpOwogICAgICBpZiAoIXJlZ2lzdHJhdGlvbnMpCiAgICAgICAgcmVnaXN0cmF0aW9uc1RhYmxlLnNldCh0YXJnZXQsIHJlZ2lzdHJhdGlvbnMgPSBbXSk7CgogICAgICAvLyAyCiAgICAgIC8vIElmIHRhcmdldCdzIGxpc3Qgb2YgcmVnaXN0ZXJlZCBvYnNlcnZlcnMgYWxyZWFkeSBpbmNsdWRlcyBhIHJlZ2lzdGVyZWQKICAgICAgLy8gb2JzZXJ2ZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBjb250ZXh0IG9iamVjdCwgcmVwbGFjZSB0aGF0IHJlZ2lzdGVyZWQKICAgICAgLy8gb2JzZXJ2ZXIncyBvcHRpb25zIHdpdGggb3B0aW9ucy4KICAgICAgdmFyIHJlZ2lzdHJhdGlvbjsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbnNbaV0ub2JzZXJ2ZXIgPT09IHRoaXMpIHsKICAgICAgICAgIHJlZ2lzdHJhdGlvbiA9IHJlZ2lzdHJhdGlvbnNbaV07CiAgICAgICAgICByZWdpc3RyYXRpb24ucmVtb3ZlTGlzdGVuZXJzKCk7CiAgICAgICAgICByZWdpc3RyYXRpb24ub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIDMuCiAgICAgIC8vIE90aGVyd2lzZSwgYWRkIGEgbmV3IHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgdG8gdGFyZ2V0J3MgbGlzdCBvZiByZWdpc3RlcmVkCiAgICAgIC8vIG9ic2VydmVycyB3aXRoIHRoZSBjb250ZXh0IG9iamVjdCBhcyB0aGUgb2JzZXJ2ZXIgYW5kIG9wdGlvbnMgYXMgdGhlCiAgICAgIC8vIG9wdGlvbnMsIGFuZCBhZGQgdGFyZ2V0IHRvIGNvbnRleHQgb2JqZWN0J3MgbGlzdCBvZiBub2RlcyBvbiB3aGljaCBpdAogICAgICAvLyBpcyByZWdpc3RlcmVkLgogICAgICBpZiAoIXJlZ2lzdHJhdGlvbikgewogICAgICAgIHJlZ2lzdHJhdGlvbiA9IG5ldyBSZWdpc3RyYXRpb24odGhpcywgdGFyZ2V0LCBvcHRpb25zKTsKICAgICAgICByZWdpc3RyYXRpb25zLnB1c2gocmVnaXN0cmF0aW9uKTsKICAgICAgICB0aGlzLm5vZGVzXy5wdXNoKHRhcmdldCk7CiAgICAgIH0KCiAgICAgIHJlZ2lzdHJhdGlvbi5hZGRMaXN0ZW5lcnMoKTsKICAgIH0sCgogICAgZGlzY29ubmVjdDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubm9kZXNfLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciByZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25zW2ldOwogICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbi5vYnNlcnZlciA9PT0gdGhpcykgewogICAgICAgICAgICByZWdpc3RyYXRpb24ucmVtb3ZlTGlzdGVuZXJzKCk7CiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAvLyBFYWNoIG5vZGUgY2FuIG9ubHkgaGF2ZSBvbmUgcmVnaXN0ZXJlZCBvYnNlcnZlciBhc3NvY2lhdGVkIHdpdGgKICAgICAgICAgICAgLy8gdGhpcyBvYnNlcnZlci4KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgICAgdGhpcy5yZWNvcmRzXyA9IFtdOwogICAgfSwKCiAgICB0YWtlUmVjb3JkczogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjb3B5T2ZSZWNvcmRzID0gdGhpcy5yZWNvcmRzXzsKICAgICAgdGhpcy5yZWNvcmRzXyA9IFtdOwogICAgICByZXR1cm4gY29weU9mUmVjb3JkczsKICAgIH0KICB9OwoKICAvKioKICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZQogICAqIEBwYXJhbSB7Tm9kZX0gdGFyZ2V0CiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gTXV0YXRpb25SZWNvcmQodHlwZSwgdGFyZ2V0KSB7CiAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CiAgICB0aGlzLmFkZGVkTm9kZXMgPSBbXTsKICAgIHRoaXMucmVtb3ZlZE5vZGVzID0gW107CiAgICB0aGlzLnByZXZpb3VzU2libGluZyA9IG51bGw7CiAgICB0aGlzLm5leHRTaWJsaW5nID0gbnVsbDsKICAgIHRoaXMuYXR0cmlidXRlTmFtZSA9IG51bGw7CiAgICB0aGlzLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IG51bGw7CiAgICB0aGlzLm9sZFZhbHVlID0gbnVsbDsKICB9CgogIGZ1bmN0aW9uIGNvcHlNdXRhdGlvblJlY29yZChvcmlnaW5hbCkgewogICAgdmFyIHJlY29yZCA9IG5ldyBNdXRhdGlvblJlY29yZChvcmlnaW5hbC50eXBlLCBvcmlnaW5hbC50YXJnZXQpOwogICAgcmVjb3JkLmFkZGVkTm9kZXMgPSBvcmlnaW5hbC5hZGRlZE5vZGVzLnNsaWNlKCk7CiAgICByZWNvcmQucmVtb3ZlZE5vZGVzID0gb3JpZ2luYWwucmVtb3ZlZE5vZGVzLnNsaWNlKCk7CiAgICByZWNvcmQucHJldmlvdXNTaWJsaW5nID0gb3JpZ2luYWwucHJldmlvdXNTaWJsaW5nOwogICAgcmVjb3JkLm5leHRTaWJsaW5nID0gb3JpZ2luYWwubmV4dFNpYmxpbmc7CiAgICByZWNvcmQuYXR0cmlidXRlTmFtZSA9IG9yaWdpbmFsLmF0dHJpYnV0ZU5hbWU7CiAgICByZWNvcmQuYXR0cmlidXRlTmFtZXNwYWNlID0gb3JpZ2luYWwuYXR0cmlidXRlTmFtZXNwYWNlOwogICAgcmVjb3JkLm9sZFZhbHVlID0gb3JpZ2luYWwub2xkVmFsdWU7CiAgICByZXR1cm4gcmVjb3JkOwogIH07CgogIC8vIFdlIGtlZXAgdHJhY2sgb2YgdGhlIHR3byAocG9zc2libHkgb25lKSByZWNvcmRzIHVzZWQgaW4gYSBzaW5nbGUgbXV0YXRpb24uCiAgdmFyIGN1cnJlbnRSZWNvcmQsIHJlY29yZFdpdGhPbGRWYWx1ZTsKCiAgLyoqCiAgICogQ3JlYXRlcyBhIHJlY29yZCB3aXRob3V0IHxvbGRWYWx1ZXwgYW5kIGNhY2hlcyBpdCBhcyB8Y3VycmVudFJlY29yZHwgZm9yCiAgICogbGF0ZXIgdXNlLgogICAqIEBwYXJhbSB7c3RyaW5nfSBvbGRWYWx1ZQogICAqIEByZXR1cm4ge011dGF0aW9uUmVjb3JkfQogICAqLwogIGZ1bmN0aW9uIGdldFJlY29yZCh0eXBlLCB0YXJnZXQpIHsKICAgIHJldHVybiBjdXJyZW50UmVjb3JkID0gbmV3IE11dGF0aW9uUmVjb3JkKHR5cGUsIHRhcmdldCk7CiAgfQoKICAvKioKICAgKiBHZXRzIG9yIGNyZWF0ZXMgYSByZWNvcmQgd2l0aCB8b2xkVmFsdWV8IGJhc2VkIGluIHRoZSB8Y3VycmVudFJlY29yZHwKICAgKiBAcGFyYW0ge3N0cmluZ30gb2xkVmFsdWUKICAgKiBAcmV0dXJuIHtNdXRhdGlvblJlY29yZH0KICAgKi8KICBmdW5jdGlvbiBnZXRSZWNvcmRXaXRoT2xkVmFsdWUob2xkVmFsdWUpIHsKICAgIGlmIChyZWNvcmRXaXRoT2xkVmFsdWUpCiAgICAgIHJldHVybiByZWNvcmRXaXRoT2xkVmFsdWU7CiAgICByZWNvcmRXaXRoT2xkVmFsdWUgPSBjb3B5TXV0YXRpb25SZWNvcmQoY3VycmVudFJlY29yZCk7CiAgICByZWNvcmRXaXRoT2xkVmFsdWUub2xkVmFsdWUgPSBvbGRWYWx1ZTsKICAgIHJldHVybiByZWNvcmRXaXRoT2xkVmFsdWU7CiAgfQoKICBmdW5jdGlvbiBjbGVhclJlY29yZHMoKSB7CiAgICBjdXJyZW50UmVjb3JkID0gcmVjb3JkV2l0aE9sZFZhbHVlID0gdW5kZWZpbmVkOwogIH0KCiAgLyoqCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0gcmVjb3JkCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgcmVjb3JkIHJlcHJlc2VudHMgYSByZWNvcmQgZnJvbSB0aGUgY3VycmVudAogICAqIG11dGF0aW9uIGV2ZW50LgogICAqLwogIGZ1bmN0aW9uIHJlY29yZFJlcHJlc2VudHNDdXJyZW50TXV0YXRpb24ocmVjb3JkKSB7CiAgICByZXR1cm4gcmVjb3JkID09PSByZWNvcmRXaXRoT2xkVmFsdWUgfHwgcmVjb3JkID09PSBjdXJyZW50UmVjb3JkOwogIH0KCiAgLyoqCiAgICogU2VsZWN0cyB3aGljaCByZWNvcmQsIGlmIGFueSwgdG8gcmVwbGFjZSB0aGUgbGFzdCByZWNvcmQgaW4gdGhlIHF1ZXVlLgogICAqIFRoaXMgcmV0dXJucyB8bnVsbHwgaWYgbm8gcmVjb3JkIHNob3VsZCBiZSByZXBsYWNlZC4KICAgKgogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9IGxhc3RSZWNvcmQKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfSBuZXdSZWNvcmQKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfQogICAqLwogIGZ1bmN0aW9uIHNlbGVjdFJlY29yZChsYXN0UmVjb3JkLCBuZXdSZWNvcmQpIHsKICAgIGlmIChsYXN0UmVjb3JkID09PSBuZXdSZWNvcmQpCiAgICAgIHJldHVybiBsYXN0UmVjb3JkOwoKICAgIC8vIENoZWNrIGlmIHRoZSB0aGUgcmVjb3JkIHdlIGFyZSBhZGRpbmcgcmVwcmVzZW50cyB0aGUgc2FtZSByZWNvcmQuIElmCiAgICAvLyBzbywgd2Uga2VlcCB0aGUgb25lIHdpdGggdGhlIG9sZFZhbHVlIGluIGl0LgogICAgaWYgKHJlY29yZFdpdGhPbGRWYWx1ZSAmJiByZWNvcmRSZXByZXNlbnRzQ3VycmVudE11dGF0aW9uKGxhc3RSZWNvcmQpKQogICAgICByZXR1cm4gcmVjb3JkV2l0aE9sZFZhbHVlOwoKICAgIHJldHVybiBudWxsOwogIH0KCiAgLyoqCiAgICogQ2xhc3MgdXNlZCB0byByZXByZXNlbnQgYSByZWdpc3RlcmVkIG9ic2VydmVyLgogICAqIEBwYXJhbSB7TXV0YXRpb25PYnNlcnZlcn0gb2JzZXJ2ZXIKICAgKiBAcGFyYW0ge05vZGV9IHRhcmdldAogICAqIEBwYXJhbSB7TXV0YXRpb25PYnNlcnZlckluaXR9IG9wdGlvbnMKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBSZWdpc3RyYXRpb24ob2JzZXJ2ZXIsIHRhcmdldCwgb3B0aW9ucykgewogICAgdGhpcy5vYnNlcnZlciA9IG9ic2VydmVyOwogICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgdGhpcy50cmFuc2llbnRPYnNlcnZlZE5vZGVzID0gW107CiAgfQoKICBSZWdpc3RyYXRpb24ucHJvdG90eXBlID0gewogICAgZW5xdWV1ZTogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHZhciByZWNvcmRzID0gdGhpcy5vYnNlcnZlci5yZWNvcmRzXzsKICAgICAgdmFyIGxlbmd0aCA9IHJlY29yZHMubGVuZ3RoOwoKICAgICAgLy8gVGhlcmUgYXJlIGNhc2VzIHdoZXJlIHdlIHJlcGxhY2UgdGhlIGxhc3QgcmVjb3JkIHdpdGggdGhlIG5ldyByZWNvcmQuCiAgICAgIC8vIEZvciBleGFtcGxlIGlmIHRoZSByZWNvcmQgcmVwcmVzZW50cyB0aGUgc2FtZSBtdXRhdGlvbiB3ZSBuZWVkIHRvIHVzZQogICAgICAvLyB0aGUgb25lIHdpdGggdGhlIG9sZFZhbHVlLiBJZiB3ZSBnZXQgc2FtZSByZWNvcmQgKHRoaXMgY2FuIGhhcHBlbiBhcyB3ZQogICAgICAvLyB3YWxrIHVwIHRoZSB0cmVlKSB3ZSBpZ25vcmUgdGhlIG5ldyByZWNvcmQuCiAgICAgIGlmIChyZWNvcmRzLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgbGFzdFJlY29yZCA9IHJlY29yZHNbbGVuZ3RoIC0gMV07CiAgICAgICAgdmFyIHJlY29yZFRvUmVwbGFjZUxhc3QgPSBzZWxlY3RSZWNvcmQobGFzdFJlY29yZCwgcmVjb3JkKTsKICAgICAgICBpZiAocmVjb3JkVG9SZXBsYWNlTGFzdCkgewogICAgICAgICAgcmVjb3Jkc1tsZW5ndGggLSAxXSA9IHJlY29yZFRvUmVwbGFjZUxhc3Q7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHNjaGVkdWxlQ2FsbGJhY2sodGhpcy5vYnNlcnZlcik7CiAgICAgIH0KCiAgICAgIHJlY29yZHNbbGVuZ3RoXSA9IHJlY29yZDsKICAgIH0sCgogICAgYWRkTGlzdGVuZXJzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5hZGRMaXN0ZW5lcnNfKHRoaXMudGFyZ2V0KTsKICAgIH0sCgogICAgYWRkTGlzdGVuZXJzXzogZnVuY3Rpb24obm9kZSkgewogICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKICAgICAgaWYgKG9wdGlvbnMuYXR0cmlidXRlcykKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUF0dHJNb2RpZmllZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hhcmFjdGVyRGF0YSkKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNoYXJhY3RlckRhdGFNb2RpZmllZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0KQogICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignRE9NTm9kZUluc2VydGVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGlsZExpc3QgfHwgb3B0aW9ucy5zdWJ0cmVlKQogICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignRE9NTm9kZVJlbW92ZWQnLCB0aGlzLCB0cnVlKTsKICAgIH0sCgogICAgcmVtb3ZlTGlzdGVuZXJzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcnNfKHRoaXMudGFyZ2V0KTsKICAgIH0sCgogICAgcmVtb3ZlTGlzdGVuZXJzXzogZnVuY3Rpb24obm9kZSkgewogICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKICAgICAgaWYgKG9wdGlvbnMuYXR0cmlidXRlcykKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTUF0dHJNb2RpZmllZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hhcmFjdGVyRGF0YSkKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTUNoYXJhY3RlckRhdGFNb2RpZmllZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0KQogICAgICAgIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NTm9kZUluc2VydGVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGlsZExpc3QgfHwgb3B0aW9ucy5zdWJ0cmVlKQogICAgICAgIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NTm9kZVJlbW92ZWQnLCB0aGlzLCB0cnVlKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBBZGRzIGEgdHJhbnNpZW50IG9ic2VydmVyIG9uIG5vZGUuIFRoZSB0cmFuc2llbnQgb2JzZXJ2ZXIgZ2V0cyByZW1vdmVkCiAgICAgKiBuZXh0IHRpbWUgd2UgZGVsaXZlciB0aGUgY2hhbmdlIHJlY29yZHMuCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqLwogICAgYWRkVHJhbnNpZW50T2JzZXJ2ZXI6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgLy8gRG9uJ3QgYWRkIHRyYW5zaWVudCBvYnNlcnZlcnMgb24gdGhlIHRhcmdldCBpdHNlbGYuIFdlIGFscmVhZHkgaGF2ZSBhbGwKICAgICAgLy8gdGhlIHJlcXVpcmVkIGxpc3RlbmVycyBzZXQgdXAgb24gdGhlIHRhcmdldC4KICAgICAgaWYgKG5vZGUgPT09IHRoaXMudGFyZ2V0KQogICAgICAgIHJldHVybjsKCiAgICAgIHRoaXMuYWRkTGlzdGVuZXJzXyhub2RlKTsKICAgICAgdGhpcy50cmFuc2llbnRPYnNlcnZlZE5vZGVzLnB1c2gobm9kZSk7CiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKICAgICAgaWYgKCFyZWdpc3RyYXRpb25zKQogICAgICAgIHJlZ2lzdHJhdGlvbnNUYWJsZS5zZXQobm9kZSwgcmVnaXN0cmF0aW9ucyA9IFtdKTsKCiAgICAgIC8vIFdlIGtub3cgdGhhdCByZWdpc3RyYXRpb25zIGRvZXMgbm90IGNvbnRhaW4gdGhpcyBiZWNhdXNlIHdlIGFscmVhZHkKICAgICAgLy8gY2hlY2tlZCBpZiBub2RlID09PSB0aGlzLnRhcmdldC4KICAgICAgcmVnaXN0cmF0aW9ucy5wdXNoKHRoaXMpOwogICAgfSwKCiAgICByZW1vdmVUcmFuc2llbnRPYnNlcnZlcnM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdHJhbnNpZW50T2JzZXJ2ZWROb2RlcyA9IHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2RlczsKICAgICAgdGhpcy50cmFuc2llbnRPYnNlcnZlZE5vZGVzID0gW107CgogICAgICB0cmFuc2llbnRPYnNlcnZlZE5vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICAgIC8vIFRyYW5zaWVudCBvYnNlcnZlcnMgYXJlIG5ldmVyIGFkZGVkIHRvIHRoZSB0YXJnZXQuCiAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcnNfKG5vZGUpOwoKICAgICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uc1tpXSA9PT0gdGhpcykgewogICAgICAgICAgICByZWdpc3RyYXRpb25zLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgLy8gRWFjaCBub2RlIGNhbiBvbmx5IGhhdmUgb25lIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgYXNzb2NpYXRlZCB3aXRoCiAgICAgICAgICAgIC8vIHRoaXMgb2JzZXJ2ZXIuCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgdGhpcyk7CiAgICB9LAoKICAgIGhhbmRsZUV2ZW50OiBmdW5jdGlvbihlKSB7CiAgICAgIC8vIFN0b3AgcHJvcGFnYXRpb24gc2luY2Ugd2UgYXJlIG1hbmFnaW5nIHRoZSBwcm9wYWdhdGlvbiBtYW51YWxseS4KICAgICAgLy8gVGhpcyBtZWFucyB0aGF0IG90aGVyIG11dGF0aW9uIGV2ZW50cyBvbiB0aGUgcGFnZSB3aWxsIG5vdCB3b3JrCiAgICAgIC8vIGNvcnJlY3RseSBidXQgdGhhdCBpcyBieSBkZXNpZ24uCiAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgogICAgICBzd2l0Y2ggKGUudHlwZSkgewogICAgICAgIGNhc2UgJ0RPTUF0dHJNb2RpZmllZCc6CiAgICAgICAgICAvLyBodHRwOi8vZG9tLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC1tby1xdWV1ZS1hdHRyaWJ1dGVzCgogICAgICAgICAgdmFyIG5hbWUgPSBlLmF0dHJOYW1lOwogICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IGUucmVsYXRlZE5vZGUubmFtZXNwYWNlVVJJOwogICAgICAgICAgdmFyIHRhcmdldCA9IGUudGFyZ2V0OwoKICAgICAgICAgIC8vIDEuCiAgICAgICAgICB2YXIgcmVjb3JkID0gbmV3IGdldFJlY29yZCgnYXR0cmlidXRlcycsIHRhcmdldCk7CiAgICAgICAgICByZWNvcmQuYXR0cmlidXRlTmFtZSA9IG5hbWU7CiAgICAgICAgICByZWNvcmQuYXR0cmlidXRlTmFtZXNwYWNlID0gbmFtZXNwYWNlOwoKICAgICAgICAgIC8vIDIuCiAgICAgICAgICB2YXIgb2xkVmFsdWUgPQogICAgICAgICAgICAgIGUuYXR0ckNoYW5nZSA9PT0gTXV0YXRpb25FdmVudC5BRERJVElPTiA/IG51bGwgOiBlLnByZXZWYWx1ZTsKCiAgICAgICAgICBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIDMuMSwgNC4yCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5hdHRyaWJ1dGVzKQogICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIDMuMiwgNC4zCiAgICAgICAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZUZpbHRlciAmJiBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5sZW5ndGggJiYKICAgICAgICAgICAgICAgIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyLmluZGV4T2YobmFtZSkgPT09IC0xICYmCiAgICAgICAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5pbmRleE9mKG5hbWVzcGFjZSkgPT09IC0xKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIDMuMywgNC40CiAgICAgICAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZU9sZFZhbHVlKQogICAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmRXaXRoT2xkVmFsdWUob2xkVmFsdWUpOwoKICAgICAgICAgICAgLy8gMy40LCA0LjUKICAgICAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdET01DaGFyYWN0ZXJEYXRhTW9kaWZpZWQnOgogICAgICAgICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtbW8tcXVldWUtY2hhcmFjdGVyZGF0YQogICAgICAgICAgdmFyIHRhcmdldCA9IGUudGFyZ2V0OwoKICAgICAgICAgIC8vIDEuCiAgICAgICAgICB2YXIgcmVjb3JkID0gZ2V0UmVjb3JkKCdjaGFyYWN0ZXJEYXRhJywgdGFyZ2V0KTsKCiAgICAgICAgICAvLyAyLgogICAgICAgICAgdmFyIG9sZFZhbHVlID0gZS5wcmV2VmFsdWU7CgoKICAgICAgICAgIGZvckVhY2hBbmNlc3RvckFuZE9ic2VydmVyRW5xdWV1ZVJlY29yZCh0YXJnZXQsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgLy8gMy4xLCA0LjIKICAgICAgICAgICAgaWYgKCFvcHRpb25zLmNoYXJhY3RlckRhdGEpCiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMy4yLCA0LjMKICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2hhcmFjdGVyRGF0YU9sZFZhbHVlKQogICAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmRXaXRoT2xkVmFsdWUob2xkVmFsdWUpOwoKICAgICAgICAgICAgLy8gMy4zLCA0LjQKICAgICAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdET01Ob2RlUmVtb3ZlZCc6CiAgICAgICAgICB0aGlzLmFkZFRyYW5zaWVudE9ic2VydmVyKGUudGFyZ2V0KTsKICAgICAgICAgIC8vIEZhbGwgdGhyb3VnaC4KICAgICAgICBjYXNlICdET01Ob2RlSW5zZXJ0ZWQnOgogICAgICAgICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtbW8tcXVldWUtY2hpbGRsaXN0CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS5yZWxhdGVkTm9kZTsKICAgICAgICAgIHZhciBjaGFuZ2VkTm9kZSA9IGUudGFyZ2V0OwogICAgICAgICAgdmFyIGFkZGVkTm9kZXMsIHJlbW92ZWROb2RlczsKICAgICAgICAgIGlmIChlLnR5cGUgPT09ICdET01Ob2RlSW5zZXJ0ZWQnKSB7CiAgICAgICAgICAgIGFkZGVkTm9kZXMgPSBbY2hhbmdlZE5vZGVdOwogICAgICAgICAgICByZW1vdmVkTm9kZXMgPSBbXTsKICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBhZGRlZE5vZGVzID0gW107CiAgICAgICAgICAgIHJlbW92ZWROb2RlcyA9IFtjaGFuZ2VkTm9kZV07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNTaWJsaW5nID0gY2hhbmdlZE5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgdmFyIG5leHRTaWJsaW5nID0gY2hhbmdlZE5vZGUubmV4dFNpYmxpbmc7CgogICAgICAgICAgLy8gMS4KICAgICAgICAgIHZhciByZWNvcmQgPSBnZXRSZWNvcmQoJ2NoaWxkTGlzdCcsIHRhcmdldCk7CiAgICAgICAgICByZWNvcmQuYWRkZWROb2RlcyA9IGFkZGVkTm9kZXM7CiAgICAgICAgICByZWNvcmQucmVtb3ZlZE5vZGVzID0gcmVtb3ZlZE5vZGVzOwogICAgICAgICAgcmVjb3JkLnByZXZpb3VzU2libGluZyA9IHByZXZpb3VzU2libGluZzsKICAgICAgICAgIHJlY29yZC5uZXh0U2libGluZyA9IG5leHRTaWJsaW5nOwoKICAgICAgICAgIGZvckVhY2hBbmNlc3RvckFuZE9ic2VydmVyRW5xdWV1ZVJlY29yZCh0YXJnZXQsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgLy8gMi4xLCAzLjIKICAgICAgICAgICAgaWYgKCFvcHRpb25zLmNoaWxkTGlzdCkKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAvLyAyLjIsIDMuMwogICAgICAgICAgICByZXR1cm4gcmVjb3JkOwogICAgICAgICAgfSk7CgogICAgICB9CgogICAgICBjbGVhclJlY29yZHMoKTsKICAgIH0KICB9OwoKICBnbG9iYWwuSnNNdXRhdGlvbk9ic2VydmVyID0gSnNNdXRhdGlvbk9ic2VydmVyOwoKfSkodGhpcyk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKaWYgKCF3aW5kb3cuTXV0YXRpb25PYnNlcnZlcikgewogIHdpbmRvdy5NdXRhdGlvbk9ic2VydmVyID0gCiAgICAgIHdpbmRvdy5XZWJLaXRNdXRhdGlvbk9ic2VydmVyIHx8IAogICAgICB3aW5kb3cuSnNNdXRhdGlvbk9ic2VydmVyOwogIGlmICghTXV0YXRpb25PYnNlcnZlcikgewogICAgdGhyb3cgbmV3IEVycm9yKCJubyBtdXRhdGlvbiBvYnNlcnZlciBzdXBwb3J0Iik7CiAgfQp9CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKLyoqCiAqIEltcGxlbWVudHMgYGRvY3VtZW50LnJlZ2lzdGVyYAogKiBAbW9kdWxlIEN1c3RvbUVsZW1lbnRzCiovCgovKioKICogUG9seWZpbGxlZCBleHRlbnNpb25zIHRvIHRoZSBgZG9jdW1lbnRgIG9iamVjdC4KICogQGNsYXNzIERvY3VtZW50CiovCgooZnVuY3Rpb24oc2NvcGUpIHsKCmlmICghc2NvcGUpIHsKICBzY29wZSA9IHdpbmRvdy5DdXN0b21FbGVtZW50cyA9IHtmbGFnczp7fX07Cn0KCi8vIG5hdGl2ZSBkb2N1bWVudC5yZWdpc3Rlcj8KCnNjb3BlLmhhc05hdGl2ZSA9IChkb2N1bWVudC53ZWJraXRSZWdpc3RlciB8fCBkb2N1bWVudC5yZWdpc3RlcikgJiYgc2NvcGUuZmxhZ3MucmVnaXN0ZXIgPT09ICduYXRpdmUnOwppZiAoc2NvcGUuaGFzTmF0aXZlKSB7CgogIC8vIG5vcm1hbGl6ZQogIGRvY3VtZW50LnJlZ2lzdGVyID0gZG9jdW1lbnQucmVnaXN0ZXIgfHwgZG9jdW1lbnQud2Via2l0UmVnaXN0ZXI7CgogIHZhciBub3AgPSBmdW5jdGlvbigpIHt9OwoKICAvLyBleHBvcnRzCiAgc2NvcGUucmVnaXN0cnkgPSB7fTsKICBzY29wZS51cGdyYWRlRWxlbWVudCA9IG5vcDsKCn0gZWxzZSB7CgovKioKICogUmVnaXN0ZXJzIGEgY3VzdG9tIHRhZyBuYW1lIHdpdGggdGhlIGRvY3VtZW50LgogKgogKiBXaGVuIGEgcmVnaXN0ZXJlZCBlbGVtZW50IGlzIGNyZWF0ZWQsIGEgYHJlYWR5Q2FsbGJhY2tgIG1ldGhvZCBpcyBjYWxsZWQKICogaW4gdGhlIHNjb3BlIG9mIHRoZSBlbGVtZW50LiBUaGUgYHJlYWR5Q2FsbGJhY2tgIG1ldGhvZCBjYW4gYmUgc3BlY2lmaWVkIG9uCiAqIGVpdGhlciBgaW5PcHRpb25zLnByb3RvdHlwZWAgb3IgYGluT3B0aW9ucy5saWZlY3ljbGVgIHdpdGggdGhlIGxhdHRlciB0YWtpbmcKICogcHJlY2VkZW5jZS4KICoKICogQG1ldGhvZCByZWdpc3RlcgogKiBAcGFyYW0ge1N0cmluZ30gaW5OYW1lIFRoZSB0YWcgbmFtZSB0byByZWdpc3Rlci4gTXVzdCBpbmNsdWRlIGEgZGFzaCAoJy0nKSwKICogICAgZm9yIGV4YW1wbGUgJ3gtY29tcG9uZW50Jy4KICogQHBhcmFtIHtPYmplY3R9IGluT3B0aW9ucwogKiAgICBAcGFyYW0ge1N0cmluZ30gW2luT3B0aW9ucy5leHRlbmRzXQogKiAgICAgIChfb2ZmIHNwZWNfKSBUYWcgbmFtZSBvZiBhbiBlbGVtZW50IHRvIGV4dGVuZCAob3IgYmxhbmsgZm9yIGEgbmV3CiAqICAgICAgZWxlbWVudCkuIFRoaXMgcGFyYW1ldGVyIGlzIG5vdCBwYXJ0IG9mIHRoZSBzcGVjaWZpY2F0aW9uLCBidXQgaW5zdGVhZAogKiAgICAgIGlzIGEgaGludCBmb3IgdGhlIHBvbHlmaWxsIGJlY2F1c2UgdGhlIGV4dGVuZGVlIGlzIGRpZmZpY3VsdCB0byBpbmZlci4KICogICAgICBSZW1lbWJlciB0aGF0IHRoZSBpbnB1dCBwcm90b3R5cGUgbXVzdCBjaGFpbiB0byB0aGUgZXh0ZW5kZWQgZWxlbWVudCdzCiAqICAgICAgcHJvdG90eXBlIChvciBIVE1MRWxlbWVudC5wcm90b3R5cGUpIHJlZ2FyZGxlc3Mgb2YgdGhlIHZhbHVlIG9mCiAqICAgICAgYGV4dGVuZHNgLgogKiAgICBAcGFyYW0ge09iamVjdH0gaW5PcHRpb25zLnByb3RvdHlwZSBUaGUgcHJvdG90eXBlIHRvIHVzZSBmb3IgdGhlIG5ldwogKiAgICAgIGVsZW1lbnQuIFRoZSBwcm90b3R5cGUgbXVzdCBpbmhlcml0IGZyb20gSFRNTEVsZW1lbnQuCiAqICAgIEBwYXJhbSB7T2JqZWN0fSBbaW5PcHRpb25zLmxpZmVjeWNsZV0KICogICAgICBDYWxsYmFja3MgdGhhdCBmaXJlIGF0IGltcG9ydGFudCBwaGFzZXMgaW4gdGhlIGxpZmUgb2YgdGhlIGN1c3RvbQogKiAgICAgIGVsZW1lbnQuCiAqCiAqIEBleGFtcGxlCiAqICAgICAgRmFuY3lCdXR0b24gPSBkb2N1bWVudC5yZWdpc3RlcigiZmFuY3ktYnV0dG9uIiwgewogKiAgICAgICAgZXh0ZW5kczogJ2J1dHRvbicsCiAqICAgICAgICBwcm90b3R5cGU6IE9iamVjdC5jcmVhdGUoSFRNTEJ1dHRvbkVsZW1lbnQucHJvdG90eXBlLCB7CiAqICAgICAgICAgIHJlYWR5Q2FsbGJhY2s6IHsKICogICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24oKSB7CiAqICAgICAgICAgICAgICBjb25zb2xlLmxvZygiYSBmYW5jeS1idXR0b24gd2FzIGNyZWF0ZWQiLAogKiAgICAgICAgICAgIH0KICogICAgICAgICAgfQogKiAgICAgICAgfSkKICogICAgICB9KTsKICogQHJldHVybiB7RnVuY3Rpb259IENvbnN0cnVjdG9yIGZvciB0aGUgbmV3bHkgcmVnaXN0ZXJlZCB0eXBlLgogKi8KZnVuY3Rpb24gcmVnaXN0ZXIoaW5OYW1lLCBpbk9wdGlvbnMpIHsKICAvL2NvbnNvbGUud2FybignZG9jdW1lbnQucmVnaXN0ZXIoIicgKyBpbk5hbWUgKyAnIiwgJywgaW5PcHRpb25zLCAnKScpOwogIC8vIGNvbnN0cnVjdCBhIGRlZmludGlvbiBvdXQgb2Ygb3B0aW9ucwogIC8vIFRPRE8oc2ptaWxlcyk6IHByb2JhYmx5IHNob3VsZCBjbG9uZSBpbk9wdGlvbnMgaW5zdGVhZCBvZiBtdXRhdGluZyBpdAogIHZhciBkZWZpbml0aW9uID0gaW5PcHRpb25zIHx8IHt9OwogIGlmICghaW5OYW1lKSB7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiByZXBsYWNlIHdpdGggbW9yZSBhcHByb3ByaWF0ZSBlcnJvciAoRXJpayBjYW4gcHJvYmFibHkKICAgIC8vIG9mZmVyIGd1aWRhbmNlKQogICAgdGhyb3cgbmV3IEVycm9yKCdOYW1lIGFyZ3VtZW50IG11c3Qgbm90IGJlIGVtcHR5Jyk7CiAgfQogIC8vIHJlY29yZCBuYW1lCiAgZGVmaW5pdGlvbi5uYW1lID0gaW5OYW1lOwogIC8vIG11c3QgaGF2ZSBhIHByb3RvdHlwZSwgZGVmYXVsdCB0byBhbiBleHRlbnNpb24gb2YgSFRNTEVsZW1lbnQKICAvLyBUT0RPKHNqbWlsZXMpOiBwcm9iYWJseSBzaG91bGQgdGhyb3cgaWYgbm8gcHJvdG90eXBlLCBjaGVjayBzcGVjCiAgaWYgKCFkZWZpbml0aW9uLnByb3RvdHlwZSkgewogICAgLy8gVE9ETyhzam1pbGVzKTogcmVwbGFjZSB3aXRoIG1vcmUgYXBwcm9wcmlhdGUgZXJyb3IgKEVyaWsgY2FuIHByb2JhYmx5CiAgICAvLyBvZmZlciBndWlkYW5jZSkKICAgIHRocm93IG5ldyBFcnJvcignT3B0aW9ucyBtaXNzaW5nIHJlcXVpcmVkIHByb3RvdHlwZSBwcm9wZXJ0eScpOwogIH0KICAvLyBlbnN1cmUgYSBsaWZlY3ljbGUgb2JqZWN0IHNvIHdlIGRvbid0IGhhdmUgdG8gbnVsbCB0ZXN0IGl0CiAgZGVmaW5pdGlvbi5saWZlY3ljbGUgPSBkZWZpbml0aW9uLmxpZmVjeWNsZSB8fCB7fTsKICAvLyBidWlsZCBhIGxpc3Qgb2YgYW5jZXN0cmFsIGN1c3RvbSBlbGVtZW50cyAoZm9yIG5hdGl2ZSBiYXNlIGRldGVjdGlvbikKICAvLyBUT0RPKHNqbWlsZXMpOiB3ZSB1c2VkIHRvIG5lZWQgdG8gc3RvcmUgdGhpcywgYnV0IGN1cnJlbnQgY29kZSBvbmx5CiAgLy8gdXNlcyBpdCBpbiAncmVzb2x2ZVRhZ05hbWUnOiBpdCBzaG91bGQgcHJvYmFibHkgYmUgaW5saW5lZAogIGRlZmluaXRpb24uYW5jZXN0cnkgPSBhbmNlc3RyeShkZWZpbml0aW9uLmV4dGVuZHMpOwogIC8vIGV4dGVuc2lvbnMgb2YgbmF0aXZlIHNwZWNpYWxpemF0aW9ucyBvZiBIVE1MRWxlbWVudCByZXF1aXJlIGxvY2FsTmFtZQogIC8vIHRvIHJlbWFpbiBuYXRpdmUsIGFuZCB1c2Ugc2Vjb25kYXJ5ICdpcycgc3BlY2lmaWVyIGZvciBleHRlbnNpb24gdHlwZQogIHJlc29sdmVUYWdOYW1lKGRlZmluaXRpb24pOwogIC8vIHNvbWUgcGxhdGZvcm1zIHJlcXVpcmUgbW9kaWZpY2F0aW9ucyB0byB0aGUgdXNlci1zdXBwbGllZCBwcm90b3R5cGUKICAvLyBjaGFpbgogIHJlc29sdmVQcm90b3R5cGVDaGFpbihkZWZpbml0aW9uKTsKICAvLyBvdmVycmlkZXMgdG8gaW1wbGVtZW50IGF0dHJpYnV0ZUNoYW5nZWQgY2FsbGJhY2sKICBvdmVycmlkZUF0dHJpYnV0ZUFwaShkZWZpbml0aW9uLnByb3RvdHlwZSk7CiAgLy8gNy4xLjU6IFJlZ2lzdGVyIHRoZSBERUZJTklUSU9OIHdpdGggRE9DVU1FTlQKICByZWdpc3RlckRlZmluaXRpb24oaW5OYW1lLCBkZWZpbml0aW9uKTsKICAvLyA3LjEuNy4gUnVuIGN1c3RvbSBlbGVtZW50IGNvbnN0cnVjdG9yIGdlbmVyYXRpb24gYWxnb3JpdGhtIHdpdGggUFJPVE9UWVBFCiAgLy8gNy4xLjguIFJldHVybiB0aGUgb3V0cHV0IG9mIHRoZSBwcmV2aW91cyBzdGVwLgogIGRlZmluaXRpb24uY3RvciA9IGdlbmVyYXRlQ29uc3RydWN0b3IoZGVmaW5pdGlvbik7CiAgZGVmaW5pdGlvbi5jdG9yLnByb3RvdHlwZSA9IGRlZmluaXRpb24ucHJvdG90eXBlOwogIC8vIGZvcmNlIG91ciAuY29uc3RydWN0b3IgdG8gYmUgb3VyIGFjdHVhbCBjb25zdHJ1Y3RvcgogIGRlZmluaXRpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gZGVmaW5pdGlvbi5jdG9yOwogIC8vIGlmIGluaXRpYWwgcGFyc2luZyBpcyBjb21wbGV0ZQogIGlmIChzY29wZS5yZWFkeSkgewogICAgLy8gdXBncmFkZSBhbnkgcHJlLWV4aXN0aW5nIG5vZGVzIG9mIHRoaXMgdHlwZQogICAgc2NvcGUudXBncmFkZUFsbChkb2N1bWVudCk7CiAgfQogIHJldHVybiBkZWZpbml0aW9uLmN0b3I7Cn0KCmZ1bmN0aW9uIGFuY2VzdHJ5KGluRXh0ZW5kcykgewogIHZhciBleHRlbmRlZSA9IHJlZ2lzdHJ5W2luRXh0ZW5kc107CiAgaWYgKGV4dGVuZGVlKSB7CiAgICByZXR1cm4gYW5jZXN0cnkoZXh0ZW5kZWUuZXh0ZW5kcykuY29uY2F0KFtleHRlbmRlZV0pOwogIH0KICByZXR1cm4gW107Cn0KCmZ1bmN0aW9uIHJlc29sdmVUYWdOYW1lKGluRGVmaW5pdGlvbikgewogIC8vIGlmIHdlIGFyZSBleHBsaWNpdGx5IGV4dGVuZGluZyBzb21ldGhpbmcsIHRoYXQgdGhpbmcgaXMgb3VyCiAgLy8gYmFzZVRhZywgdW5sZXNzIGl0IHJlcHJlc2VudHMgYSBjdXN0b20gY29tcG9uZW50CiAgdmFyIGJhc2VUYWcgPSBpbkRlZmluaXRpb24uZXh0ZW5kczsKICAvLyBpZiBvdXIgYW5jZXN0cnkgaW5jbHVkZXMgY3VzdG9tIGNvbXBvbmVudHMsIHdlIG9ubHkgaGF2ZSBhCiAgLy8gYmFzZVRhZyBpZiBvbmUgb2YgdGhlbSBkb2VzCiAgZm9yICh2YXIgaT0wLCBhOyAoYT1pbkRlZmluaXRpb24uYW5jZXN0cnlbaV0pOyBpKyspIHsKICAgIGJhc2VUYWcgPSBhLmlzICYmIGEudGFnOwogIH0KICAvLyBvdXIgdGFnIGlzIG91ciBiYXNlVGFnLCBpZiBpdCBleGlzdHMsIGFuZCBvdGhlcndpc2UganVzdCBvdXIgbmFtZQogIGluRGVmaW5pdGlvbi50YWcgPSBiYXNlVGFnIHx8IGluRGVmaW5pdGlvbi5uYW1lOwogIGlmIChiYXNlVGFnKSB7CiAgICAvLyBpZiB0aGVyZSBpcyBhIGJhc2UgdGFnLCB1c2Ugc2Vjb25kYXJ5ICdpcycgc3BlY2lmaWVyCiAgICBpbkRlZmluaXRpb24uaXMgPSBpbkRlZmluaXRpb24ubmFtZTsKICB9Cn0KCmZ1bmN0aW9uIHJlc29sdmVQcm90b3R5cGVDaGFpbihpbkRlZmluaXRpb24pIHsKICAvLyBpZiB3ZSBkb24ndCBzdXBwb3J0IF9fcHJvdG9fXyB3ZSBuZWVkIHRvIGxvY2F0ZSB0aGUgbmF0aXZlIGxldmVsCiAgLy8gcHJvdG90eXBlIGZvciBwcmVjaXNlIG1peGluZyBpbgogIGlmICghT2JqZWN0Ll9fcHJvdG9fXykgewogICAgLy8gZGVmYXVsdCBwcm90b3R5cGUKICAgIHZhciBuYXRpdmUgPSBIVE1MRWxlbWVudC5wcm90b3R5cGU7CiAgICAvLyB3b3JrIG91dCBwcm90b3R5cGUgd2hlbiB1c2luZyB0eXBlLWV4dGVuc2lvbgogICAgaWYgKGluRGVmaW5pdGlvbi5pcykgewogICAgICB2YXIgaW5zdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoaW5EZWZpbml0aW9uLnRhZyk7CiAgICAgIG5hdGl2ZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihpbnN0KTsKICAgIH0KICB9CiAgLy8gY2FjaGUgdGhpcyBpbiBjYXNlIG9mIG1peGluCiAgaW5EZWZpbml0aW9uLm5hdGl2ZSA9IG5hdGl2ZTsKfQoKLy8gU0VDVElPTiA0CgpmdW5jdGlvbiBpbnN0YW50aWF0ZShpbkRlZmluaXRpb24pIHsKICAvLyA0LmEuMS4gQ3JlYXRlIGEgbmV3IG9iamVjdCB0aGF0IGltcGxlbWVudHMgUFJPVE9UWVBFCiAgLy8gNC5hLjIuIExldCBFTEVNRU5UIGJ5IHRoaXMgbmV3IG9iamVjdAogIC8vCiAgLy8gdGhlIGN1c3RvbSBlbGVtZW50IGluc3RhbnRpYXRpb24gYWxnb3JpdGhtIG11c3QgYWxzbyBlbnN1cmUgdGhhdCB0aGUKICAvLyBvdXRwdXQgaXMgYSB2YWxpZCBET00gZWxlbWVudCB3aXRoIHRoZSBwcm9wZXIgd3JhcHBlciBpbiBwbGFjZS4KICAvLwogIHJldHVybiB1cGdyYWRlKGRvbUNyZWF0ZUVsZW1lbnQoaW5EZWZpbml0aW9uLnRhZyksIGluRGVmaW5pdGlvbik7Cn0KCmZ1bmN0aW9uIHVwZ3JhZGUoaW5FbGVtZW50LCBpbkRlZmluaXRpb24pIHsKICAvLyBzb21lIGRlZmluaXRpb25zIHNwZWNpZnkgYW4gJ2lzJyBhdHRyaWJ1dGUKICBpZiAoaW5EZWZpbml0aW9uLmlzKSB7CiAgICBpbkVsZW1lbnQuc2V0QXR0cmlidXRlKCdpcycsIGluRGVmaW5pdGlvbi5pcyk7CiAgfQogIC8vIG1ha2UgJ2VsZW1lbnQnIGltcGxlbWVudCBpbkRlZmluaXRpb24ucHJvdG90eXBlCiAgaW1wbGVtZW50KGluRWxlbWVudCwgaW5EZWZpbml0aW9uKTsKICAvLyBmbGFnIGFzIHVwZ3JhZGVkCiAgaW5FbGVtZW50Ll9fdXBncmFkZWRfXyA9IHRydWU7CiAgLy8gdGhlcmUgc2hvdWxkIG5ldmVyIGJlIGEgc2hhZG93IHJvb3Qgb24gaW5FbGVtZW50IGF0IHRoaXMgcG9pbnQKICAvLyB3ZSByZXF1aXJlIGNoaWxkIG5vZGVzIGJlIHVwZ3JhZGVkIGJlZm9yZSByZWFkeQogIHNjb3BlLnVwZ3JhZGVTdWJ0cmVlKGluRWxlbWVudCk7CiAgLy8gbGlmZWN5Y2xlIG1hbmFnZW1lbnQKICByZWFkeShpbkVsZW1lbnQpOwogIC8vIE9VVFBVVAogIHJldHVybiBpbkVsZW1lbnQ7Cn0KCmZ1bmN0aW9uIGltcGxlbWVudChpbkVsZW1lbnQsIGluRGVmaW5pdGlvbikgewogIC8vIHByb3RvdHlwZSBzd2l6emxpbmcgaXMgYmVzdAogIGlmIChPYmplY3QuX19wcm90b19fKSB7CiAgICBpbkVsZW1lbnQuX19wcm90b19fID0gaW5EZWZpbml0aW9uLnByb3RvdHlwZTsKICB9IGVsc2UgewogICAgLy8gd2hlcmUgYWJvdmUgd2UgY2FuIHJlLWFjcXVpcmUgaW5Qcm90b3R5cGUgdmlhCiAgICAvLyBnZXRQcm90b3R5cGVPZihFbGVtZW50KSwgd2UgY2Fubm90IGRvIHNvIHdoZW4KICAgIC8vIHdlIHVzZSBtaXhpbiwgc28gd2UgaW5zdGFsbCBhIG1hZ2ljIHJlZmVyZW5jZQogICAgY3VzdG9tTWl4aW4oaW5FbGVtZW50LCBpbkRlZmluaXRpb24ucHJvdG90eXBlLCBpbkRlZmluaXRpb24ubmF0aXZlKTsKICAgIGluRWxlbWVudC5fX3Byb3RvX18gPSBpbkRlZmluaXRpb24ucHJvdG90eXBlOwogIH0KfQoKZnVuY3Rpb24gY3VzdG9tTWl4aW4oaW5UYXJnZXQsIGluU3JjLCBpbk5hdGl2ZSkgewogIC8vIFRPRE8oc2ptaWxlcyk6ICd1c2VkJyBhbGxvd3MgdXMgdG8gb25seSBjb3B5IHRoZSAneW91bmdlc3QnIHZlcnNpb24gb2YKICAvLyBhbnkgcHJvcGVydHkuIFRoaXMgc2V0IHNob3VsZCBiZSBwcmVjYWxjdWxhdGVkLiBXZSBhbHNvIG5lZWQgdG8KICAvLyBjb25zaWRlciB0aGlzIGZvciBzdXBwb3J0aW5nICdzdXBlcicuCiAgdmFyIHVzZWQgPSB7fTsKICAvLyBzdGFydCB3aXRoIGluU3JjCiAgdmFyIHAgPSBpblNyYzsKICAvLyBzb21ldGltZXMgdGhlIGRlZmF1bHQgaXMgSFRNTFVua25vd25FbGVtZW50LnByb3RvdHlwZSBpbnN0ZWFkIG9mCiAgLy8gSFRNTEVsZW1lbnQucHJvdG90eXBlLCBzbyB3ZSBhZGQgYSB0ZXN0CiAgLy8gdGhlIGlkZWEgaXMgdG8gYXZvaWQgbWl4aW5nIGluIG5hdGl2ZSBwcm90b3R5cGVzLCBzbyBhZGRpbmcKICAvLyB0aGUgc2Vjb25kIHRlc3QgaXMgV0xPRwogIHdoaWxlIChwICE9PSBpbk5hdGl2ZSAmJiBwICE9PSBIVE1MVW5rbm93bkVsZW1lbnQucHJvdG90eXBlKSB7CiAgICB2YXIga2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHApOwogICAgZm9yICh2YXIgaT0wLCBrOyBrPWtleXNbaV07IGkrKykgewogICAgICBpZiAoIXVzZWRba10pIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaW5UYXJnZXQsIGssCiAgICAgICAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocCwgaykpOwogICAgICAgIHVzZWRba10gPSAxOwogICAgICB9CiAgICB9CiAgICBwID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHApOwogIH0KfQoKZnVuY3Rpb24gcmVhZHkoaW5FbGVtZW50KSB7CiAgLy8gaW52b2tlIHJlYWR5Q2FsbGJhY2sKICBpZiAoaW5FbGVtZW50LnJlYWR5Q2FsbGJhY2spIHsKICAgIGluRWxlbWVudC5yZWFkeUNhbGxiYWNrKCk7CiAgfQp9CgovLyBhdHRyaWJ1dGUgd2F0Y2hpbmcKCmZ1bmN0aW9uIG92ZXJyaWRlQXR0cmlidXRlQXBpKHByb3RvdHlwZSkgewogIC8vIG92ZXJyaWRlcyB0byBpbXBsZW1lbnQgY2FsbGJhY2tzCiAgLy8gVE9ETyhzam1pbGVzKTogc2hvdWxkIHN1cHBvcnQgYWNjZXNzIHZpYSAuYXR0cmlidXRlcyBOYW1lZE5vZGVNYXAKICAvLyBUT0RPKHNqbWlsZXMpOiBwcmVzZXJ2ZXMgdXNlciBkZWZpbmVkIG92ZXJyaWRlcywgaWYgYW55CiAgdmFyIHNldEF0dHJpYnV0ZSA9IHByb3RvdHlwZS5zZXRBdHRyaWJ1dGU7CiAgcHJvdG90eXBlLnNldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICBjaGFuZ2VBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgc2V0QXR0cmlidXRlKTsKICB9CiAgdmFyIHJlbW92ZUF0dHJpYnV0ZSA9IHByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGU7CiAgcHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICBjaGFuZ2VBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgcmVtb3ZlQXR0cmlidXRlKTsKICB9Cn0KCmZ1bmN0aW9uIGNoYW5nZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgb3BlcmF0aW9uKSB7CiAgdmFyIG9sZFZhbHVlID0gdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgb3BlcmF0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgaWYgKHRoaXMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrIAogICAgICAmJiAodGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkgIT09IG9sZFZhbHVlKSkgewogICAgdGhpcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkVmFsdWUpOwogIH0KfQoKLy8gZWxlbWVudCByZWdpc3RyeSAobWFwcyB0YWcgbmFtZXMgdG8gZGVmaW5pdGlvbnMpCgp2YXIgcmVnaXN0cnkgPSB7fTsKCmZ1bmN0aW9uIHJlZ2lzdGVyRGVmaW5pdGlvbihpbk5hbWUsIGluRGVmaW5pdGlvbikgewogIHJlZ2lzdHJ5W2luTmFtZV0gPSBpbkRlZmluaXRpb247Cn0KCmZ1bmN0aW9uIGdlbmVyYXRlQ29uc3RydWN0b3IoaW5EZWZpbml0aW9uKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGluc3RhbnRpYXRlKGluRGVmaW5pdGlvbik7CiAgfTsKfQoKZnVuY3Rpb24gY3JlYXRlRWxlbWVudChpblRhZykgewogIHZhciBkZWZpbml0aW9uID0gcmVnaXN0cnlbaW5UYWddOwogIGlmIChkZWZpbml0aW9uKSB7CiAgICByZXR1cm4gbmV3IGRlZmluaXRpb24uY3RvcigpOwogIH0KICByZXR1cm4gZG9tQ3JlYXRlRWxlbWVudChpblRhZyk7Cn0KCmZ1bmN0aW9uIHVwZ3JhZGVFbGVtZW50KGluRWxlbWVudCkgewogIGlmICghaW5FbGVtZW50Ll9fdXBncmFkZWRfXyAmJiAoaW5FbGVtZW50Lm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkpIHsKICAgIHZhciB0eXBlID0gaW5FbGVtZW50LmdldEF0dHJpYnV0ZSgnaXMnKSB8fCBpbkVsZW1lbnQubG9jYWxOYW1lOwogICAgdmFyIGRlZmluaXRpb24gPSByZWdpc3RyeVt0eXBlXTsKICAgIHJldHVybiBkZWZpbml0aW9uICYmIHVwZ3JhZGUoaW5FbGVtZW50LCBkZWZpbml0aW9uKTsKICB9Cn0KCmZ1bmN0aW9uIGNsb25lTm9kZShkZWVwKSB7CiAgLy8gY2FsbCBvcmlnaW5hbCBjbG9uZQogIHZhciBuID0gZG9tQ2xvbmVOb2RlLmNhbGwodGhpcywgZGVlcCk7CiAgLy8gdXBncmFkZSB0aGUgZWxlbWVudCBhbmQgc3VidHJlZQogIHNjb3BlLnVwZ3JhZGVBbGwobik7CiAgcmV0dXJuIG47Cn0KLy8gY2FwdHVyZSBuYXRpdmUgY3JlYXRlRWxlbWVudCBiZWZvcmUgd2Ugb3ZlcnJpZGUgaXQKCnZhciBkb21DcmVhdGVFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudC5iaW5kKGRvY3VtZW50KTsKCi8vIGNhcHR1cmUgbmF0aXZlIGNsb25lTm9kZSBiZWZvcmUgd2Ugb3ZlcnJpZGUgaXQKCnZhciBkb21DbG9uZU5vZGUgPSBOb2RlLnByb3RvdHlwZS5jbG9uZU5vZGU7CgovLyBleHBvcnRzCgpkb2N1bWVudC5yZWdpc3RlciA9IHJlZ2lzdGVyOwpkb2N1bWVudC5jcmVhdGVFbGVtZW50ID0gY3JlYXRlRWxlbWVudDsgLy8gb3ZlcnJpZGUKTm9kZS5wcm90b3R5cGUuY2xvbmVOb2RlID0gY2xvbmVOb2RlOyAvLyBvdmVycmlkZQoKc2NvcGUucmVnaXN0cnkgPSByZWdpc3RyeTsKCi8qKgogKiBVcGdyYWRlIGFuIGVsZW1lbnQgdG8gYSBjdXN0b20gZWxlbWVudC4gVXBncmFkaW5nIGFuIGVsZW1lbnQKICogY2F1c2VzIHRoZSBjdXN0b20gcHJvdG90eXBlIHRvIGJlIGFwcGxpZWQsIGFuIGBpc2AgYXR0cmlidXRlIAogKiB0byBiZSBhdHRhY2hlZCAoYXMgbmVlZGVkKSwgYW5kIGludm9jYXRpb24gb2YgdGhlIGByZWFkeUNhbGxiYWNrYC4KICogYHVwZ3JhZGVgIGRvZXMgbm90aGluZyBpZiB0aGUgZWxlbWVudCBpcyBhbHJlYWR5IHVwZ3JhZGVkLCBvcgogKiBpZiBpdCBtYXRjaGVzIG5vIHJlZ2lzdGVyZWQgY3VzdG9tIHRhZyBuYW1lLgogKgogKiBAbWV0aG9kIHVncHJhZGUKICogQHBhcmFtIHtFbGVtZW50fSBpbkVsZW1lbnQgVGhlIGVsZW1lbnQgdG8gdXBncmFkZS4KICogQHJldHVybiB7RWxlbWVudH0gVGhlIHVwZ3JhZGVkIGVsZW1lbnQuCiAqLwpzY29wZS51cGdyYWRlID0gdXBncmFkZUVsZW1lbnQ7Cgp9Cgp9KSh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpOwoKIC8qDQpDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLg0KVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUNCmxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4NCiovDQoNCihmdW5jdGlvbihzY29wZSl7DQoNCi8qDQppZiAoSFRNTEVsZW1lbnQucHJvdG90eXBlLndlYmtpdFNoYWRvd1Jvb3QpIHsNCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEhUTUxFbGVtZW50LnByb3RvdHlwZSwgJ3NoYWRvd1Jvb3QnLCB7DQogICAgZ2V0OiBmdW5jdGlvbigpIHsNCiAgICAgIHJldHVybiB0aGlzLndlYmtpdFNoYWRvd1Jvb3Q7DQogICAgfQ0KICB9Ow0KfQ0KKi8NCg0KLy8gd2FsayB0aGUgc3VidHJlZSByb290ZWQgYXQgbm9kZSwgYXBwbHlpbmcgJ2ZpbmQoZWxlbWVudCwgZGF0YSknIGZ1bmN0aW9uIA0KLy8gdG8gZWFjaCBlbGVtZW50DQovLyBpZiAnZmluZCcgcmV0dXJucyB0cnVlIGZvciAnZWxlbWVudCcsIGRvIG5vdCBzZWFyY2ggZWxlbWVudCdzIHN1YnRyZWUgIA0KZnVuY3Rpb24gZmluZEFsbChub2RlLCBmaW5kLCBkYXRhKSB7DQogIHZhciBlID0gbm9kZS5maXJzdEVsZW1lbnRDaGlsZDsNCiAgaWYgKCFlKSB7DQogICAgZSA9IG5vZGUuZmlyc3RDaGlsZDsNCiAgICB3aGlsZSAoZSAmJiBlLm5vZGVUeXBlICE9PSBOb2RlLkVMRU1FTlRfTk9ERSkgew0KICAgICAgZSA9IGUubmV4dFNpYmxpbmc7DQogICAgfQ0KICB9DQogIHdoaWxlIChlKSB7DQogICAgaWYgKGZpbmQoZSwgZGF0YSkgIT09IHRydWUpIHsNCiAgICAgIGZpbmRBbGwoZSwgZmluZCwgZGF0YSk7DQogICAgfQ0KICAgIGUgPSBlLm5leHRFbGVtZW50U2libGluZzsNCiAgfQ0KICByZXR1cm4gbnVsbDsNCn0NCg0KLy8gd2FsayB0aGUgc3VidHJlZSByb290ZWQgYXQgbm9kZSwgaW5jbHVkaW5nIGRlc2NlbnQgaW50byBzaGFkb3ctcm9vdHMsIA0KLy8gYXBwbHlpbmcgJ2NiJyB0byBlYWNoIGVsZW1lbnQNCmZ1bmN0aW9uIGZvclN1YnRyZWUobm9kZSwgY2IpIHsNCiAgLy9sb2dGbGFncy5kb20gJiYgbm9kZS5jaGlsZE5vZGVzICYmIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggJiYgY29uc29sZS5ncm91cCgnc3ViVHJlZTogJywgbm9kZSk7DQogIGZpbmRBbGwobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgIGlmIChjYihlKSkgew0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICAgIGlmIChlLndlYmtpdFNoYWRvd1Jvb3QpIHsNCiAgICAgIGZvclN1YnRyZWUoZS53ZWJraXRTaGFkb3dSb290LCBjYik7DQogICAgfQ0KICB9KTsNCiAgaWYgKG5vZGUud2Via2l0U2hhZG93Um9vdCkgew0KICAgIGZvclN1YnRyZWUobm9kZS53ZWJraXRTaGFkb3dSb290LCBjYik7DQogIH0NCiAgLy9sb2dGbGFncy5kb20gJiYgbm9kZS5jaGlsZE5vZGVzICYmIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggJiYgY29uc29sZS5ncm91cEVuZCgpOw0KfQ0KDQovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUNCmZ1bmN0aW9uIGFkZGVkKG5vZGUpIHsNCiAgaWYgKHVwZ3JhZGUobm9kZSkpIHsNCiAgICBpbnNlcnRlZE5vZGUobm9kZSk7DQogICAgcmV0dXJuIHRydWU7IA0KICB9DQogIGluc2VydGVkKG5vZGUpOw0KfQ0KDQovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUncyBzdWJ0cmVlIG9ubHkNCmZ1bmN0aW9uIGFkZGVkU3VidHJlZShub2RlKSB7DQogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgIGlmIChhZGRlZChlKSkgew0KICAgICAgcmV0dXJuIHRydWU7IA0KICAgIH0NCiAgfSk7DQp9DQoNCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZSBhbmQgaXQncyBzdWJ0cmVlDQpmdW5jdGlvbiBhZGRlZE5vZGUobm9kZSkgew0KICByZXR1cm4gYWRkZWQobm9kZSkgfHwgYWRkZWRTdWJ0cmVlKG5vZGUpOw0KfQ0KDQovLyB1cGdyYWRlIGN1c3RvbSBlbGVtZW50cyBhdCBub2RlLCBpZiBhcHBsaWNhYmxlDQpmdW5jdGlvbiB1cGdyYWRlKG5vZGUpIHsNCiAgaWYgKCFub2RlLl9fdXBncmFkZWRfXyAmJiBub2RlLm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkgew0KICAgIHZhciB0eXBlID0gbm9kZS5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgbm9kZS5sb2NhbE5hbWU7DQogICAgdmFyIGRlZmluaXRpb24gPSBzY29wZS5yZWdpc3RyeVt0eXBlXTsNCiAgICBpZiAoZGVmaW5pdGlvbikgew0KICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ3VwZ3JhZGU6Jywgbm9kZS5sb2NhbE5hbWUpOw0KICAgICAgc2NvcGUudXBncmFkZShub2RlKTsNCiAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogIH0NCn0NCg0KZnVuY3Rpb24gaW5zZXJ0ZWROb2RlKG5vZGUpIHsNCiAgaW5zZXJ0ZWQobm9kZSk7DQogIGlmIChpbkRvY3VtZW50KG5vZGUpKSB7DQogICAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7DQogICAgICBpbnNlcnRlZChlKTsNCiAgICB9KTsNCiAgfQ0KfQ0KDQovLyBUT0RPKHNqbWlsZXMpOiBpZiB0aGVyZSBhcmUgZGVzY2VudHMgaW50byB0cmVlcyB0aGF0IGNhbiBuZXZlciBoYXZlIGluRG9jdW1lbnQoKikgdHJ1ZSwgZml4IHRoaXMNCg0KZnVuY3Rpb24gaW5zZXJ0ZWQoZWxlbWVudCkgew0KICAvLyBUT0RPKHNqbWlsZXMpOiBpdCdzIHBvc3NpYmxlIHdlIHdlcmUgaW5zZXJ0ZWQgYW5kIHJlbW92ZWQgaW4gdGhlIHNwYWNlDQogIC8vIG9mIG9uZSBtaWNyb3Rhc2ssIGluIHdoaWNoIGNhc2Ugd2Ugd29uJ3QgYmUgJ2luRG9jdW1lbnQnIGhlcmUNCiAgLy8gQnV0IHRoZXJlIGFyZSBvdGhlciBjYXNlcyB3aGVyZSB3ZSBhcmUgdGVzdGluZyBmb3IgaW5zZXJ0ZWQgd2l0aG91dA0KICAvLyBzcGVjaWZpYyBrbm93bGVkZ2Ugb2YgbXV0YXRpb25zLCBhbmQgbXVzdCB0ZXN0ICdpbkRvY3VtZW50JyB0byBkZXRlcm1pbmUNCiAgLy8gd2hldGhlciB0byBjYWxsIGluc2VydGVkDQogIC8vIElmIHdlIGNhbiBmYWN0b3IgdGhlc2UgY2FzZXMgaW50byBzZXBhcmF0ZSBjb2RlIHBhdGhzIHdlIGNhbiBoYXZlDQogIC8vIGJldHRlciBkaWFnbm9zdGljcy4NCiAgLy8gVE9ETyhzam1pbGVzKTogd2hlbiBsb2dnaW5nLCBkbyB3b3JrIG9uIGFsbCBjdXN0b20gZWxlbWVudHMgc28gd2UgY2FuDQogIC8vIHRyYWNrIGJlaGF2aW9yIGV2ZW4gd2hlbiBjYWxsYmFja3Mgbm90IGRlZmluZWQNCiAgLy9jb25zb2xlLmxvZygnaW5zZXJ0ZWQ6ICcsIGVsZW1lbnQubG9jYWxOYW1lKTsNCiAgaWYgKGVsZW1lbnQuaW5zZXJ0ZWRDYWxsYmFjayB8fCAoZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgbG9nRmxhZ3MuZG9tKSkgew0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7DQogICAgaWYgKGluRG9jdW1lbnQoZWxlbWVudCkpIHsNCiAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IChlbGVtZW50Ll9faW5zZXJ0ZWQgfHwgMCkgKyAxOw0KICAgICAgLy8gaWYgd2UgYXJlIGluIGEgJ3JlbW92ZWQnIHN0YXRlLCBibHVudGx5IGFkanVzdCB0byBhbiAnaW5zZXJ0ZWQnIHN0YXRlDQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkIDwgMSkgew0KICAgICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAxOw0KICAgICAgfQ0KICAgICAgLy8gaWYgd2UgYXJlICdvdmVyIGluc2VydGVkJywgc3F1ZWxjaCB0aGUgY2FsbGJhY2sNCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPiAxKSB7DQogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLndhcm4oJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lLA0KICAgICAgICAgICdpbnNlcnQvcmVtb3ZlIGNvdW50OicsIGVsZW1lbnQuX19pbnNlcnRlZCkNCiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5pbnNlcnRlZENhbGxiYWNrKSB7DQogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygnaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOw0KICAgICAgICBlbGVtZW50Lmluc2VydGVkQ2FsbGJhY2soKTsNCiAgICAgIH0NCiAgICB9DQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiByZW1vdmVkTm9kZShub2RlKSB7DQogIHJlbW92ZWQobm9kZSk7DQogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgIHJlbW92ZWQoZSk7DQogIH0pOw0KfQ0KDQpmdW5jdGlvbiByZW1vdmVkKGVsZW1lbnQpIHsNCiAgLy8gVE9ETyhzam1pbGVzKTogdGVtcG9yYXJ5OiBkbyB3b3JrIG9uIGFsbCBjdXN0b20gZWxlbWVudHMgc28gd2UgY2FuIHRyYWNrDQogIC8vIGJlaGF2aW9yIGV2ZW4gd2hlbiBjYWxsYmFja3Mgbm90IGRlZmluZWQNCiAgaWYgKGVsZW1lbnQucmVtb3ZlZENhbGxiYWNrIHx8IChlbGVtZW50Ll9fdXBncmFkZWRfXyAmJiBsb2dGbGFncy5kb20pKSB7DQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCdyZW1vdmVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsNCiAgICBpZiAoIWluRG9jdW1lbnQoZWxlbWVudCkpIHsNCiAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IChlbGVtZW50Ll9faW5zZXJ0ZWQgfHwgMCkgLSAxOw0KICAgICAgLy8gaWYgd2UgYXJlIGluIGEgJ2luc2VydGVkJyBzdGF0ZSwgYmx1bnRseSBhZGp1c3QgdG8gYW4gJ3JlbW92ZWQnIHN0YXRlDQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkID4gMCkgew0KICAgICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAwOw0KICAgICAgfQ0KICAgICAgLy8gaWYgd2UgYXJlICdvdmVyIHJlbW92ZWQnLCBzcXVlbGNoIHRoZSBjYWxsYmFjaw0KICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA8IDApIHsNCiAgICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUud2FybigncmVtb3ZlZDonLCBlbGVtZW50LmxvY2FsTmFtZSwNCiAgICAgICAgICAgICdpbnNlcnQvcmVtb3ZlIGNvdW50OicsIGVsZW1lbnQuX19pbnNlcnRlZCkNCiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5yZW1vdmVkQ2FsbGJhY2spIHsNCiAgICAgICAgZWxlbWVudC5yZW1vdmVkQ2FsbGJhY2soKTsNCiAgICAgIH0NCiAgICB9DQogIH0NCn0NCg0KZnVuY3Rpb24gaW5Eb2N1bWVudChlbGVtZW50KSB7DQogIHZhciBwID0gZWxlbWVudDsNCiAgd2hpbGUgKHApIHsNCiAgICBpZiAocCA9PSBlbGVtZW50Lm93bmVyRG9jdW1lbnQpIHsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICBwID0gcC5wYXJlbnROb2RlIHx8IHAuaG9zdDsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiB3YXRjaFNoYWRvdyhub2RlKSB7DQogIGlmIChub2RlLndlYmtpdFNoYWRvd1Jvb3QgJiYgIW5vZGUud2Via2l0U2hhZG93Um9vdC5fX3dhdGNoZWQpIHsNCiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ3dhdGNoaW5nIHNoYWRvdy1yb290IGZvcjogJywgbm9kZS5sb2NhbE5hbWUpOw0KICAgIG9ic2VydmUobm9kZS53ZWJraXRTaGFkb3dSb290KTsNCiAgICBub2RlLndlYmtpdFNoYWRvd1Jvb3QuX193YXRjaGVkID0gdHJ1ZTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiB3YXRjaEFsbFNoYWRvd3Mobm9kZSkgew0KICB3YXRjaFNoYWRvdyhub2RlKTsNCiAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7DQogICAgd2F0Y2hTaGFkb3cobm9kZSk7DQogIH0pOw0KfQ0KDQpmdW5jdGlvbiBmaWx0ZXIoaW5Ob2RlKSB7DQogIHN3aXRjaCAoaW5Ob2RlLmxvY2FsTmFtZSkgew0KICAgIGNhc2UgJ3N0eWxlJzoNCiAgICBjYXNlICdzY3JpcHQnOg0KICAgIGNhc2UgJ3RlbXBsYXRlJzoNCiAgICBjYXNlIHVuZGVmaW5lZDoNCiAgICAgIHJldHVybiB0cnVlOw0KICB9DQp9DQoNCmZ1bmN0aW9uIGhhbmRsZXIobXV0YXRpb25zKSB7DQogIC8vDQogIGlmIChsb2dGbGFncy5kb20pIHsNCiAgICB2YXIgbXggPSBtdXRhdGlvbnNbMF07DQogICAgaWYgKG14ICYmIG14LnR5cGUgPT09ICdjaGlsZExpc3QnICYmIG14LmFkZGVkTm9kZXMpIHsNCiAgICAgICAgaWYgKG14LmFkZGVkTm9kZXMpIHsNCiAgICAgICAgICB2YXIgZCA9IG14LmFkZGVkTm9kZXNbMF07DQogICAgICAgICAgd2hpbGUgKGQgJiYgZCAhPT0gZG9jdW1lbnQgJiYgIWQuaG9zdCkgew0KICAgICAgICAgICAgZCA9IGQucGFyZW50Tm9kZTsNCiAgICAgICAgICB9DQogICAgICAgICAgdmFyIHUgPSBkICYmIChkLlVSTCB8fCBkLl9VUkwgfHwgKGQuaG9zdCAmJiBkLmhvc3QubG9jYWxOYW1lKSkgfHwgJyc7DQogICAgICAgICAgdSA9IHUuc3BsaXQoJy8/Jykuc2hpZnQoKS5zcGxpdCgnLycpLnBvcCgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIGNvbnNvbGUuZ3JvdXAoJ211dGF0aW9ucyAoJWQpIFslc10nLCBtdXRhdGlvbnMubGVuZ3RoLCB1IHx8ICcnKTsNCiAgfQ0KICAvLw0KICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihteCkgew0KICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ211dGF0aW9uJyk7DQogICAgaWYgKG14LnR5cGUgPT09ICdjaGlsZExpc3QnKSB7DQogICAgICBmb3JFYWNoKG14LmFkZGVkTm9kZXMsIGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2cobi5sb2NhbE5hbWUpOw0KICAgICAgICBpZiAoZmlsdGVyKG4pKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIC8vIHdhdGNoIHNoYWRvdy1yb290cyBvbiBub2RlcyB0aGF0IGhhdmUgaGFkIHRoZW0gYXR0YWNoZWQgbWFudWFsbHkNCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVtb3ZlIGlmIGNyZWF0ZVNoYWRvd1Jvb3QgaXMgb3ZlcnJpZGRlbg0KICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiByZW1vdmVkIGFzIGFuIG9wdGltaXphdGlvbiwgbWFudWFsIHNoYWRvdyByb290cw0KICAgICAgICAvLyBtdXN0IGJlIHdhdGNoZWQgZXhwbGljaXRseQ0KICAgICAgICAvL3dhdGNoQWxsU2hhZG93cyhuKTsNCiAgICAgICAgLy8gbm9kZXMgYWRkZWQgbWF5IG5lZWQgbGlmZWN5Y2xlIG1hbmFnZW1lbnQNCiAgICAgICAgYWRkZWROb2RlKG4pOw0KICAgICAgfSk7DQogICAgICAvLyByZW1vdmVkIG5vZGVzIG1heSBuZWVkIGxpZmVjeWNsZSBtYW5hZ2VtZW50DQogICAgICBmb3JFYWNoKG14LnJlbW92ZWROb2RlcywgZnVuY3Rpb24obikgew0KICAgICAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZyhuLmxvY2FsTmFtZSk7DQogICAgICAgIGlmIChmaWx0ZXIobikpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgcmVtb3ZlZE5vZGUobik7DQogICAgICB9KTsNCiAgICB9DQogICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOw0KICB9KTsNCiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCn07DQoNCnZhciBvYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGhhbmRsZXIpOw0KDQpmdW5jdGlvbiB0YWtlUmVjb3JkcygpIHsNCiAgLy8gVE9ETyhzam1pbGVzKTogYXNrIFJhZiB3aHkgd2UgaGF2ZSB0byBjYWxsIGhhbmRsZXIgb3Vyc2VsdmVzDQogIGhhbmRsZXIob2JzZXJ2ZXIudGFrZVJlY29yZHMoKSk7DQp9DQoNCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsNCg0KZnVuY3Rpb24gb2JzZXJ2ZShpblJvb3QpIHsNCiAgb2JzZXJ2ZXIub2JzZXJ2ZShpblJvb3QsIHtjaGlsZExpc3Q6IHRydWUsIHN1YnRyZWU6IHRydWV9KTsNCn0NCg0KZnVuY3Rpb24gb2JzZXJ2ZURvY3VtZW50KGRvY3VtZW50KSB7DQogIG9ic2VydmUoZG9jdW1lbnQpOw0KfQ0KDQpmdW5jdGlvbiB1cGdyYWRlRG9jdW1lbnQoZG9jdW1lbnQpIHsNCiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ3VwZ3JhZGVEb2N1bWVudDogJywgKGRvY3VtZW50LlVSTCB8fCBkb2N1bWVudC5fVVJMIHx8ICcnKS5zcGxpdCgnLycpLnBvcCgpKTsNCiAgYWRkZWROb2RlKGRvY3VtZW50KTsNCiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCn0NCg0KLy8gZXhwb3J0cw0KDQpzY29wZS53YXRjaFNoYWRvdyA9IHdhdGNoU2hhZG93Ow0Kc2NvcGUud2F0Y2hBbGxTaGFkb3dzID0gd2F0Y2hBbGxTaGFkb3dzOw0KDQpzY29wZS51cGdyYWRlQWxsID0gYWRkZWROb2RlOw0Kc2NvcGUudXBncmFkZVN1YnRyZWUgPSBhZGRlZFN1YnRyZWU7DQoNCnNjb3BlLm9ic2VydmVEb2N1bWVudCA9IG9ic2VydmVEb2N1bWVudDsNCnNjb3BlLnVwZ3JhZGVEb2N1bWVudCA9IHVwZ3JhZGVEb2N1bWVudDsNCg0Kc2NvcGUudGFrZVJlY29yZHMgPSB0YWtlUmVjb3JkczsNCg0KfSkod2luZG93LkN1c3RvbUVsZW1lbnRzKTsNCgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgSFRNTEVsZW1lbnRFbGVtZW50ID0gZnVuY3Rpb24oaW5FbGVtZW50KSB7CiAgaW5FbGVtZW50LnJlZ2lzdGVyID0gSFRNTEVsZW1lbnRFbGVtZW50LnByb3RvdHlwZS5yZWdpc3RlcjsKICBwYXJzZUVsZW1lbnRFbGVtZW50KGluRWxlbWVudCk7CiAgcmV0dXJuIGluRWxlbWVudDsKfTsKCkhUTUxFbGVtZW50RWxlbWVudC5wcm90b3R5cGUgPSB7CiAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGluTW9yZSkgewogICAgaWYgKGluTW9yZSkgewogICAgICB0aGlzLm9wdGlvbnMubGlmZWN5Y2xlID0gaW5Nb3JlLmxpZmVjeWNsZTsKICAgICAgaWYgKGluTW9yZS5wcm90b3R5cGUpIHsKICAgICAgICBtaXhpbih0aGlzLm9wdGlvbnMucHJvdG90eXBlLCBpbk1vcmUucHJvdG90eXBlKTsKICAgICAgfQogICAgfQogIH0KfTsKCmZ1bmN0aW9uIHBhcnNlRWxlbWVudEVsZW1lbnQoaW5FbGVtZW50KSB7CiAgLy8gb3B0aW9ucyB0byBnbGVhbiBmcm9tIGluRWxlbWVudCBhdHRyaWJ1dGVzCiAgdmFyIG9wdGlvbnMgPSB7CiAgICBuYW1lOiAnJywKICAgIGV4dGVuZHM6IG51bGwKICB9OwogIC8vIGdsZWFuIHRoZW0KICB0YWtlQXR0cmlidXRlcyhpbkVsZW1lbnQsIG9wdGlvbnMpOwogIC8vIGRlZmF1bHQgYmFzZQogIHZhciBiYXNlID0gSFRNTEVsZW1lbnQucHJvdG90eXBlOwogIC8vIG9wdGlvbmFsIHNwZWNpZmllZCBiYXNlCiAgaWYgKG9wdGlvbnMuZXh0ZW5kcykgewogICAgLy8gYnVpbGQgYW4gaW5zdGFuY2Ugb2Ygb3B0aW9ucy5leHRlbmRzCiAgICB2YXIgYXJjaGV0eXBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChvcHRpb25zLmV4dGVuZHMpOwogICAgLy8gYWNxdWlyZSB0aGUgcHJvdG90eXBlCiAgICAvLyBUT0RPKHNqbWlsZXMpOiBfX3Byb3RvX18gbWF5IGJlIGhpbnRlZCBieSB0aGUgY3VzdG9tIGVsZW1lbnQKICAgIC8vIHN5c3RlbSBvbiBwbGF0Zm9ybXMgdGhhdCBkb24ndCBzdXBwb3J0IG5hdGl2ZSBfX3Byb3RvX18KICAgIC8vIG9uIHRob3NlIHBsYXRmb3JtcyB0aGUgQVBJIGlzIG1peGVkIGludG8gYXJjaGV0eXBlIGFuZCB0aGUKICAgIC8vIGVmZmVjdGl2ZSBiYXNlIGlzIG5vdCBhcmNoZXR5cGUncyByZWFsIHByb3RvdHlwZQogICAgYmFzZSA9IGFyY2hldHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKGFyY2hldHlwZSk7CiAgfQogIC8vIGV4dGVuZCBiYXNlCiAgb3B0aW9ucy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGJhc2UpOwogIC8vIGluc3RhbGwgb3B0aW9ucwogIGluRWxlbWVudC5vcHRpb25zID0gb3B0aW9uczsKICAvLyBsb2NhdGUgdXNlciBzY3JpcHQKICB2YXIgc2NyaXB0ID0gaW5FbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ3NjcmlwdDpub3QoW3R5cGVdKSxzY3JpcHRbdHlwZT0idGV4dC9qYXZhc2NyaXB0Il0sc2NyaXB0cycpOwogIGlmIChzY3JpcHQpIHsKICAgIC8vIGV4ZWN1dGUgdXNlciBzY3JpcHQgaW4gJ2luRWxlbWVudCcgY29udGV4dAogICAgZXhlY3V0ZUNvbXBvbmVudFNjcmlwdChzY3JpcHQudGV4dENvbnRlbnQsIGluRWxlbWVudCwgb3B0aW9ucy5uYW1lKTsKICB9OwogIC8vIHJlZ2lzdGVyIG91ciBuZXcgZWxlbWVudAogIHZhciBjdG9yID0gZG9jdW1lbnQucmVnaXN0ZXIob3B0aW9ucy5uYW1lLCBvcHRpb25zKTsKICBpbkVsZW1lbnQuY3RvciA9IGN0b3I7CiAgLy8gc3RvcmUgb3B0aW9uYWwgY29uc3RydWN0b3IgcmVmZXJlbmNlCiAgdmFyIHJlZk5hbWUgPSBpbkVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjb25zdHJ1Y3RvcicpOwogIGlmIChyZWZOYW1lKSB7CiAgICB3aW5kb3dbcmVmTmFtZV0gPSBjdG9yOwogIH0KfQoKLy8gZWFjaCBwcm9wZXJ0eSBpbiBpbkRpY3Rpb25hcnkgdGFrZXMgYSB2YWx1ZQovLyBmcm9tIHRoZSBtYXRjaGluZyBhdHRyaWJ1dGUgaW4gaW5FbGVtZW50LCBpZiBhbnkKZnVuY3Rpb24gdGFrZUF0dHJpYnV0ZXMoaW5FbGVtZW50LCBpbkRpY3Rpb25hcnkpIHsKICBmb3IgKHZhciBuIGluIGluRGljdGlvbmFyeSkgewogICAgdmFyIGEgPSBpbkVsZW1lbnQuYXR0cmlidXRlc1tuXTsKICAgIGlmIChhKSB7CiAgICAgIGluRGljdGlvbmFyeVtuXSA9IGEudmFsdWU7CiAgICB9CiAgfQp9CgovLyBpbnZva2UgaW5TY3JpcHQgaW4gaW5Db250ZXh0IHNjb3BlCmZ1bmN0aW9uIGV4ZWN1dGVDb21wb25lbnRTY3JpcHQoaW5TY3JpcHQsIGluQ29udGV4dCwgaW5OYW1lKSB7CiAgLy8gc2V0IChoaWdobGFuZGVyKSBjb250ZXh0CiAgY29udGV4dCA9IGluQ29udGV4dDsKICAvLyBzb3VyY2UgbG9jYXRpb24KICB2YXIgb3duZXIgPSBjb250ZXh0Lm93bmVyRG9jdW1lbnQ7CiAgdmFyIHVybCA9IChvd25lci5fVVJMIHx8IG93bmVyLlVSTCB8fCBvd25lci5pbXBsCiAgICAgICYmIChvd25lci5pbXBsLl9VUkwgfHwgb3duZXIuaW1wbC5VUkwpKTsKICAvLyBlbnN1cmUgdGhlIGNvbXBvbmVudCBoYXMgYSB1bmlxdWUgc291cmNlIG1hcCBzbyBpdCBjYW4gYmUgZGVidWdnZWQKICAvLyBpZiB0aGUgbmFtZSBtYXRjaGVzIHRoZSBmaWxlbmFtZSBwYXJ0IG9mIHRoZSBvd25pbmcgZG9jdW1lbnQncyB1cmwsCiAgLy8gdXNlIHRoaXMsIG90aGVyd2lzZSwgYWRkICI6PG5hbWU+IiB0byB0aGUgZG9jdW1lbnQgdXJsLgogIHZhciBtYXRjaCA9IHVybC5tYXRjaCgvLipcLyhbXi5dKilbLl0/LiokLyk7CiAgaWYgKG1hdGNoKSB7CiAgICB2YXIgbmFtZSA9IG1hdGNoWzFdOwogICAgdXJsICs9IG5hbWUgIT0gaW5OYW1lID8gJzonICsgaW5OYW1lIDogJyc7CiAgfQogIC8vIGNvbXBvc2Ugc2NyaXB0CiAgdmFyIGNvZGUgPSAiX19jb21wb25lbnRTY3JpcHQoJyIKICAgICsgaW5OYW1lCiAgICArICInLCBmdW5jdGlvbigpeyIKICAgICsgaW5TY3JpcHQKICAgICsgIn0pOyIKICAgICsgIlxuLy8jIHNvdXJjZVVSTD0iICsgdXJsICsgIlxuIgogIDsKICAvLyBpbmplY3Qgc2NyaXB0CiAgZXZhbChjb2RlKTsKfQoKdmFyIGNvbnRleHQ7CgovLyBnbG9iYWwgbmVjZXNzYXJ5IGZvciBzY3JpcHQgaW5qZWN0aW9uCndpbmRvdy5fX2NvbXBvbmVudFNjcmlwdCA9IGZ1bmN0aW9uKGluTmFtZSwgaW5GdW5jKSB7CiAgaW5GdW5jLmNhbGwoY29udGV4dCk7Cn07CgovLyB1dGlsaXR5CgovLyBjb3B5IHRvcCBsZXZlbCBwcm9wZXJ0aWVzIGZyb20gcHJvcHMgdG8gb2JqCmZ1bmN0aW9uIG1peGluKG9iaiwgcHJvcHMpIHsKICBvYmogPSBvYmogfHwge307CiAgdHJ5IHsKICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3BzKS5mb3JFYWNoKGZ1bmN0aW9uKG4pIHsKICAgICAgdmFyIHBkID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwcm9wcywgbik7CiAgICAgIGlmIChwZCkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIG4sIHBkKTsKICAgICAgfQogICAgfSk7CiAgfSBjYXRjaCh4KSB7CiAgfQogIHJldHVybiBvYmo7Cn0KCi8vIGV4cG9ydHMKCndpbmRvdy5IVE1MRWxlbWVudEVsZW1lbnQgPSBIVE1MRWxlbWVudEVsZW1lbnQ7Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihzY29wZSkgewoKaWYgKCFzY29wZSkgewogIHNjb3BlID0gd2luZG93LkhUTUxJbXBvcnRzID0ge2ZsYWdzOnt9fTsKfQoKLy8gaW1wb3J0cwoKdmFyIHhociA9IHNjb3BlLnhocjsKCi8vIGltcG9ydGVyCgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9ICdpbXBvcnQnOwp2YXIgU1RZTEVfTElOS19UWVBFID0gJ3N0eWxlc2hlZXQnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgcmVwcmVzZW50cyBhIHByaW1hcnkgZG9jdW1lbnQgKHRoZSBhcmd1bWVudCB0byAnbG9hZCcpCi8vIGF0IHRoZSByb290IG9mIGEgdHJlZSBvZiBkb2N1bWVudHMKCi8vIGZvciBhbnkgZG9jdW1lbnQsIGltcG9ydGVyOgovLyAtIGxvYWRzIGFueSBsaW5rZWQgZG9jdW1lbnRzICh3aXRoIGRlZHVwaW5nKSwgbW9kaWZpZXMgcGF0aHMgYW5kIGZlZWRzIHRoZW0gYmFjayBpbnRvIGltcG9ydGVyCi8vIC0gbG9hZHMgdGV4dCBvZiBleHRlcm5hbCBzY3JpcHQgdGFncwovLyAtIGxvYWRzIHRleHQgb2YgZXh0ZXJuYWwgc3R5bGUgdGFncyBpbnNpZGUgb2YgPGVsZW1lbnQ+LCBtb2RpZmllcyBwYXRocwoKLy8gd2hlbiBpbXBvcnRlciAnbW9kaWZpZXMgcGF0aHMnIGluIGEgZG9jdW1lbnQsIHRoaXMgaW5jbHVkZXMKLy8gLSBocmVmL3NyYy9hY3Rpb24gaW4gbm9kZSBhdHRyaWJ1dGVzCi8vIC0gcGF0aHMgaW4gaW5saW5lIHN0eWxlc2hlZXRzCi8vIC0gYWxsIGNvbnRlbnQgaW5zaWRlIHRlbXBsYXRlcwoKLy8gbGlua2VkIHN0eWxlIHNoZWV0cyBpbiBhbiBpbXBvcnQgaGF2ZSB0aGVpciBvd24gcGF0aCBmaXhlZCB1cCB3aGVuIHRoZWlyIGNvbnRhaW5pbmcgaW1wb3J0IG1vZGlmaWVzIHBhdGhzCi8vIGxpbmtlZCBzdHlsZSBzaGVldHMgaW4gYW4gPGVsZW1lbnQ+IGFyZSBsb2FkZWQsIGFuZCB0aGUgY29udGVudCBnZXRzIHBhdGggZml4dXBzCi8vIGlubGluZSBzdHlsZSBzaGVldHMgZ2V0IHBhdGggZml4dXBzIHdoZW4gdGhlaXIgY29udGFpbmluZyBpbXBvcnQgbW9kaWZpZXMgcGF0aHMKCnZhciBpbXBvcnRlciA9IHsKICBkb2N1bWVudHM6IHt9LAogIGNhY2hlOiB7fSwKICBwcmVsb2FkU2VsZWN0b3JzOiBbCiAgICAnbGlua1tyZWw9JyArIElNUE9SVF9MSU5LX1RZUEUgKyAnXScsCiAgICAnZWxlbWVudCBsaW5rW3JlbD0nICsgU1RZTEVfTElOS19UWVBFICsgJ10nLAogICAgJ3RlbXBsYXRlJywKICAgICdzY3JpcHRbc3JjXScsCiAgICAnc2NyaXB0Om5vdChbdHlwZV0pJywKICAgICdzY3JpcHRbdHlwZT0idGV4dC9qYXZhc2NyaXB0Il0nCiAgXS5qb2luKCcsJyksCiAgbG9hZGVyOiBmdW5jdGlvbihpbk5leHQpIHsKICAgIC8vIGNvbnN0cnVjdCBhIGxvYWRlciBpbnN0YW5jZQogICAgbG9hZGVyID0gbmV3IExvYWRlcihpbXBvcnRlci5sb2FkZWQsIGluTmV4dCk7CiAgICAvLyBhbGlhcyB0aGUgbG9hZGVyIGNhY2hlIChmb3IgZGVidWdnaW5nKQogICAgbG9hZGVyLmNhY2hlID0gaW1wb3J0ZXIuY2FjaGU7CiAgICByZXR1cm4gbG9hZGVyOwogIH0sCiAgbG9hZDogZnVuY3Rpb24oaW5Eb2N1bWVudCwgaW5OZXh0KSB7CiAgICAvLyBjb25zdHJ1Y3QgYSBsb2FkZXIgaW5zdGFuY2UKICAgIGxvYWRlciA9IGltcG9ydGVyLmxvYWRlcihpbk5leHQpOwogICAgLy8gYWRkIG5vZGVzIGZyb20gZG9jdW1lbnQgaW50byBsb2FkZXIgcXVldWUKICAgIGltcG9ydGVyLnByZWxvYWQoaW5Eb2N1bWVudCk7CiAgfSwKICBwcmVsb2FkOiBmdW5jdGlvbihpbkRvY3VtZW50KSB7CiAgICAvLyBhbGwgcHJlbG9hZGFibGUgbm9kZXMgaW4gaW5Eb2N1bWVudAogICAgdmFyIG5vZGVzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGltcG9ydGVyLnByZWxvYWRTZWxlY3RvcnMpOwogICAgLy8gZnJvbSB0aGUgbWFpbiBkb2N1bWVudCwgb25seSBsb2FkIGltcG9ydHMKICAgIC8vIFRPRE8oc2ptaWxlcyk6IGRvIHRoaXMgYnkgYWx0ZXJpbmcgdGhlIHNlbGVjdG9yIGxpc3QgaW5zdGVhZAogICAgbm9kZXMgPSB0aGlzLmZpbHRlck1haW5Eb2N1bWVudE5vZGVzKGluRG9jdW1lbnQsIG5vZGVzKTsKICAgIC8vIGV4dHJhIGxpbmsgbm9kZXMgZnJvbSB0ZW1wbGF0ZXMsIGZpbHRlciB0ZW1wbGF0ZXMgb3V0IG9mIHRoZSBub2RlcyBsaXN0CiAgICBub2RlcyA9IHRoaXMuZXh0cmFjdFRlbXBsYXRlTm9kZXMobm9kZXMpOwogICAgLy8gYWRkIHRoZXNlIG5vZGVzIHRvIGxvYWRlcidzIHF1ZXVlCiAgICBsb2FkZXIuYWRkTm9kZXMobm9kZXMpOwogIH0sCiAgZmlsdGVyTWFpbkRvY3VtZW50Tm9kZXM6IGZ1bmN0aW9uKGluRG9jdW1lbnQsIG5vZGVzKSB7CiAgICBpZiAoaW5Eb2N1bWVudCA9PT0gZG9jdW1lbnQpIHsKICAgICAgbm9kZXMgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICByZXR1cm4gIWlzU2NyaXB0KG4pOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBub2RlczsKICB9LAogIGV4dHJhY3RUZW1wbGF0ZU5vZGVzOiBmdW5jdGlvbihub2RlcykgewogICAgdmFyIGV4dHJhID0gW107CiAgICBub2RlcyA9IEFycmF5LnByb3RvdHlwZS5maWx0ZXIuY2FsbChub2RlcywgZnVuY3Rpb24obikgewogICAgICBpZiAobi5sb2NhbE5hbWUgPT09ICd0ZW1wbGF0ZScpIHsKICAgICAgICBpZiAobi5jb250ZW50KSB7CiAgICAgICAgICB2YXIgbCQgPSBuLmNvbnRlbnQucXVlcnlTZWxlY3RvckFsbCgnbGlua1tyZWw9JyArIFNUWUxFX0xJTktfVFlQRSArCiAgICAgICAgICAgICddJyk7CiAgICAgICAgICBpZiAobCQubGVuZ3RoKSB7CiAgICAgICAgICAgIGV4dHJhID0gZXh0cmEuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGwkLCAwKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0pOwogICAgaWYgKGV4dHJhLmxlbmd0aCkgewogICAgICBub2RlcyA9IG5vZGVzLmNvbmNhdChleHRyYSk7CiAgICB9CiAgICByZXR1cm4gbm9kZXM7CiAgfSwKICBsb2FkZWQ6IGZ1bmN0aW9uKHVybCwgZWx0LCByZXNvdXJjZSkgewogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGVsdCkpIHsKICAgICAgdmFyIGRvY3VtZW50ID0gaW1wb3J0ZXIuZG9jdW1lbnRzW3VybF07CiAgICAgIC8vIGlmIHdlJ3ZlIG5ldmVyIHNlZW4gYSBkb2N1bWVudCBhdCB0aGlzIHVybAogICAgICBpZiAoIWRvY3VtZW50KSB7CiAgICAgICAgLy8gZ2VuZXJhdGUgYW4gSFRNTERvY3VtZW50IGZyb20gZGF0YQogICAgICAgIGRvY3VtZW50ID0gbWFrZURvY3VtZW50KHJlc291cmNlLCB1cmwpOwogICAgICAgIC8vIHJlc29sdmUgcmVzb3VyY2UgcGF0aHMgcmVsYXRpdmUgdG8gaG9zdCBkb2N1bWVudAogICAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5IVE1MKGRvY3VtZW50LmJvZHkpOwogICAgICAgIC8vIGNhY2hlIGRvY3VtZW50CiAgICAgICAgaW1wb3J0ZXIuZG9jdW1lbnRzW3VybF0gPSBkb2N1bWVudDsKICAgICAgICAvLyBhZGQgbm9kZXMgZnJvbSB0aGlzIGRvY3VtZW50IHRvIHRoZSBsb2FkZXIgcXVldWUKICAgICAgICBpbXBvcnRlci5wcmVsb2FkKGRvY3VtZW50KTsKICAgICAgfQogICAgICAvLyBzdG9yZSBpbXBvcnQgcmVjb3JkCiAgICAgIGVsdC5pbXBvcnQgPSB7CiAgICAgICAgaHJlZjogdXJsLAogICAgICAgIG93bmVyTm9kZTogZWx0LAogICAgICAgIGNvbnRlbnQ6IGRvY3VtZW50CiAgICAgIH07CiAgICAgIC8vIHN0b3JlIGRvY3VtZW50IHJlc291cmNlCiAgICAgIGVsdC5jb250ZW50ID0gcmVzb3VyY2UgPSBkb2N1bWVudDsKICAgIH0KICAgIC8vIHN0b3JlIGdlbmVyaWMgcmVzb3VyY2UKICAgIC8vIFRPRE8oc29ydmVsbCk6IGZhaWxzIGZvciBub2RlcyBpbnNpZGUgPHRlbXBsYXRlPi5jb250ZW50CiAgICAvLyBzZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTI0OTM4MS4KICAgIGVsdC5fX3Jlc291cmNlID0gcmVzb3VyY2U7CiAgICAvLyBjc3MgcGF0aCBmaXh1cHMKICAgIGlmIChpc1N0eWxlc2hlZXRMaW5rKGVsdCkpIHsKICAgICAgcGF0aC5yZXNvbHZlUGF0aHNJblN0eWxlc2hlZXQoZWx0KTsKICAgIH0KICB9Cn07CgpmdW5jdGlvbiBpc0RvY3VtZW50TGluayhlbHQpIHsKICByZXR1cm4gaXNMaW5rUmVsKGVsdCwgSU1QT1JUX0xJTktfVFlQRSk7Cn0KCmZ1bmN0aW9uIGlzU3R5bGVzaGVldExpbmsoZWx0KSB7CiAgcmV0dXJuIGlzTGlua1JlbChlbHQsIFNUWUxFX0xJTktfVFlQRSk7Cn0KCmZ1bmN0aW9uIGlzTGlua1JlbChlbHQsIHJlbCkgewogIHJldHVybiBlbHQubG9jYWxOYW1lID09PSAnbGluaycgJiYgZWx0LmdldEF0dHJpYnV0ZSgncmVsJykgPT09IHJlbDsKfQoKZnVuY3Rpb24gaXNTY3JpcHQoZWx0KSB7CiAgcmV0dXJuIGVsdC5sb2NhbE5hbWUgPT09ICdzY3JpcHQnOwp9CgpmdW5jdGlvbiBtYWtlRG9jdW1lbnQoaW5IVE1MLCBpblVybCkgewogIC8vIGNyZWF0ZSBhIG5ldyBIVE1MIGRvY3VtZW50CiAgdmFyIGRvYyA9IGRvY3VtZW50LmltcGxlbWVudGF0aW9uLmNyZWF0ZUhUTUxEb2N1bWVudChJTVBPUlRfTElOS19UWVBFKTsKICAvLyBjYWNoZSB0aGUgbmV3IGRvY3VtZW50J3Mgc291cmNlIHVybAogIGRvYy5fVVJMID0gaW5Vcmw7CiAgLy8gZXN0YWJsaXNoIGEgcmVsYXRpdmUgcGF0aCB2aWEgPGJhc2U+CiAgdmFyIGJhc2UgPSBkb2MuY3JlYXRlRWxlbWVudCgnYmFzZScpOwogIGJhc2Uuc2V0QXR0cmlidXRlKCdocmVmJywgZG9jdW1lbnQuYmFzZVVSSSk7CiAgZG9jLmhlYWQuYXBwZW5kQ2hpbGQoYmFzZSk7CiAgLy8gaW5zdGFsbCBodG1sCiAgZG9jLmJvZHkuaW5uZXJIVE1MID0gaW5IVE1MOwogIC8vIFRPRE8oc29ydmVsbCk6IE1EViBQb2x5ZmlsbCBpbnRydXNpb246IGJvb3N0cmFwIHRlbXBsYXRlIHBvbHlmaWxsCiAgaWYgKHdpbmRvdy5IVE1MVGVtcGxhdGVFbGVtZW50ICYmIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKSB7CiAgICBIVE1MVGVtcGxhdGVFbGVtZW50LmJvb3RzdHJhcChkb2MpOwogIH0KICByZXR1cm4gZG9jOwp9Cgp2YXIgbG9hZGVyOwoKdmFyIExvYWRlciA9IGZ1bmN0aW9uKGluT25Mb2FkLCBpbk9uQ29tcGxldGUpIHsKICB0aGlzLm9ubG9hZCA9IGluT25Mb2FkOwogIHRoaXMub25jb21wbGV0ZSA9IGluT25Db21wbGV0ZTsKICB0aGlzLmluZmxpZ2h0ID0gMDsKICB0aGlzLnBlbmRpbmcgPSB7fTsKICB0aGlzLmNhY2hlID0ge307Cn07CgpMb2FkZXIucHJvdG90eXBlID0gewogIGFkZE5vZGVzOiBmdW5jdGlvbihpbk5vZGVzKSB7CiAgICAvLyBudW1iZXIgb2YgdHJhbnNhY3Rpb25zIHRvIGNvbXBsZXRlCiAgICB0aGlzLmluZmxpZ2h0ICs9IGluTm9kZXMubGVuZ3RoOwogICAgLy8gY29tbWVuY2UgdHJhbnNhY3Rpb25zCiAgICBmb3JFYWNoKGluTm9kZXMsIHRoaXMucmVxdWlyZSwgdGhpcyk7CiAgICAvLyBhbnl0aGluZyB0byBkbz8KICAgIHRoaXMuY2hlY2tEb25lKCk7CiAgfSwKICByZXF1aXJlOiBmdW5jdGlvbihpbkVsdCkgewogICAgdmFyIHVybCA9IHBhdGgubm9kZVVybChpbkVsdCk7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBhZC1ob2MKICAgIGluRWx0Ll9fbm9kZVVybCA9IHVybDsKICAgIC8vIGRlZHVwbGljYXRpb24KICAgIGlmICghdGhpcy5kZWR1cGUodXJsLCBpbkVsdCkpIHsKICAgICAgLy8gZmV0Y2ggdGhpcyByZXNvdXJjZQogICAgICB0aGlzLmZldGNoKHVybCwgaW5FbHQpOwogICAgfQogIH0sCiAgZGVkdXBlOiBmdW5jdGlvbihpblVybCwgaW5FbHQpIHsKICAgIGlmICh0aGlzLnBlbmRpbmdbaW5VcmxdKSB7CiAgICAgIC8vIGFkZCB0byBsaXN0IG9mIG5vZGVzIHdhaXRpbmcgZm9yIGluVXJsCiAgICAgIHRoaXMucGVuZGluZ1tpblVybF0ucHVzaChpbkVsdCk7CiAgICAgIC8vIGRvbid0IG5lZWQgZmV0Y2gKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAodGhpcy5jYWNoZVtpblVybF0pIHsKICAgICAgLy8gY29tcGxldGUgbG9hZCB1c2luZyBjYWNoZSBkYXRhCiAgICAgIHRoaXMub25sb2FkKGluVXJsLCBpbkVsdCwgbG9hZGVyLmNhY2hlW2luVXJsXSk7CiAgICAgIC8vIGZpbmlzaGVkIHRoaXMgdHJhbnNhY3Rpb24KICAgICAgdGhpcy50YWlsKCk7CiAgICAgIC8vIGRvbid0IG5lZWQgZmV0Y2gKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBmaXJzdCBub2RlIHdhaXRpbmcgZm9yIGluVXJsCiAgICB0aGlzLnBlbmRpbmdbaW5VcmxdID0gW2luRWx0XTsKICAgIC8vIG5lZWQgZmV0Y2ggKG5vdCBhIGR1cGUpCiAgICByZXR1cm4gZmFsc2U7CiAgfSwKICBmZXRjaDogZnVuY3Rpb24odXJsLCBlbHQpIHsKICAgIHZhciByZWNlaXZlWGhyID0gZnVuY3Rpb24oZXJyLCByZXNvdXJjZSkgewogICAgICB0aGlzLnJlY2VpdmUodXJsLCBlbHQsIGVyciwgcmVzb3VyY2UpOwogICAgfS5iaW5kKHRoaXMpOwogICAgeGhyLmxvYWQodXJsLCByZWNlaXZlWGhyKTsKICB9LAogIHJlY2VpdmU6IGZ1bmN0aW9uKGluVXJsLCBpbkVsdCwgaW5FcnIsIGluUmVzb3VyY2UpIHsKICAgIGlmICghaW5FcnIpIHsKICAgICAgbG9hZGVyLmNhY2hlW2luVXJsXSA9IGluUmVzb3VyY2U7CiAgICB9CiAgICBsb2FkZXIucGVuZGluZ1tpblVybF0uZm9yRWFjaChmdW5jdGlvbihlKSB7CiAgICAgIGlmICghaW5FcnIpIHsKICAgICAgICB0aGlzLm9ubG9hZChpblVybCwgZSwgaW5SZXNvdXJjZSk7CiAgICAgIH0KICAgICAgdGhpcy50YWlsKCk7CiAgICB9LCB0aGlzKTsKICAgIGxvYWRlci5wZW5kaW5nW2luVXJsXSA9IG51bGw7CiAgfSwKICB0YWlsOiBmdW5jdGlvbigpIHsKICAgIC0tdGhpcy5pbmZsaWdodDsKICAgIHRoaXMuY2hlY2tEb25lKCk7CiAgfSwKICBjaGVja0RvbmU6IGZ1bmN0aW9uKCkgewogICAgaWYgKCF0aGlzLmluZmxpZ2h0KSB7CiAgICAgIHRoaXMub25jb21wbGV0ZSgpOwogICAgfQogIH0KfTsKCnZhciBVUkxfQVRUUlMgPSBbJ2hyZWYnLCAnc3JjJywgJ2FjdGlvbiddOwp2YXIgVVJMX0FUVFJTX1NFTEVDVE9SID0gJ1snICsgVVJMX0FUVFJTLmpvaW4oJ10sWycpICsgJ10nOwp2YXIgVVJMX1RFTVBMQVRFX1NFQVJDSCA9ICd7ey4qfX0nOwoKdmFyIHBhdGggPSB7CiAgbm9kZVVybDogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gcGF0aC5yZXNvbHZlVXJsKHBhdGguZ2V0RG9jdW1lbnRVcmwoZG9jdW1lbnQpLCBwYXRoLmhyZWZPclNyYyhpbk5vZGUpKTsKICB9LAogIGhyZWZPclNyYzogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gaW5Ob2RlLmdldEF0dHJpYnV0ZSgiaHJlZiIpIHx8IGluTm9kZS5nZXRBdHRyaWJ1dGUoInNyYyIpOwogIH0sCiAgZG9jdW1lbnRVcmxGcm9tTm9kZTogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gcGF0aC5nZXREb2N1bWVudFVybChpbk5vZGUub3duZXJEb2N1bWVudCk7CiAgfSwKICBnZXREb2N1bWVudFVybDogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgdmFyIHVybCA9IGluRG9jdW1lbnQgJiYKICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET01Qb2x5ZmlsbCBpbnRydXNpb24KICAgICAgICAoaW5Eb2N1bWVudC5fVVJMIHx8IChpbkRvY3VtZW50LmltcGwgJiYgaW5Eb2N1bWVudC5pbXBsLl9VUkwpCiAgICAgICAgICAgIHx8IGluRG9jdW1lbnQuYmFzZVVSSSB8fCBpbkRvY3VtZW50LlVSTCkKICAgICAgICAgICAgICAgIHx8ICcnOwogICAgLy8gdGFrZSBvbmx5IHRoZSBsZWZ0IHNpZGUgaWYgdGhlcmUgaXMgYSAjCiAgICByZXR1cm4gdXJsLnNwbGl0KCcjJylbMF07CiAgfSwKICByZXNvbHZlVXJsOiBmdW5jdGlvbihpbkJhc2VVcmwsIGluVXJsLCBpblJlbGF0aXZlVG9Eb2N1bWVudCkgewogICAgaWYgKHRoaXMuaXNBYnNVcmwoaW5VcmwpKSB7CiAgICAgIHJldHVybiBpblVybDsKICAgIH0KICAgIHZhciB1cmwgPSB0aGlzLmNvbXByZXNzVXJsKHRoaXMudXJsVG9QYXRoKGluQmFzZVVybCkgKyBpblVybCk7CiAgICBpZiAoaW5SZWxhdGl2ZVRvRG9jdW1lbnQpIHsKICAgICAgdXJsID0gcGF0aC5tYWtlUmVsUGF0aChwYXRoLmdldERvY3VtZW50VXJsKGRvY3VtZW50KSwgdXJsKTsKICAgIH0KICAgIHJldHVybiB1cmw7CiAgfSwKICBpc0Fic1VybDogZnVuY3Rpb24oaW5VcmwpIHsKICAgIHJldHVybiAvKF5kYXRhOil8KF5odHRwW3NdPzopfCheXC8pLy50ZXN0KGluVXJsKTsKICB9LAogIHVybFRvUGF0aDogZnVuY3Rpb24oaW5CYXNlVXJsKSB7CiAgICB2YXIgcGFydHMgPSBpbkJhc2VVcmwuc3BsaXQoIi8iKTsKICAgIHBhcnRzLnBvcCgpOwogICAgcGFydHMucHVzaCgnJyk7CiAgICByZXR1cm4gcGFydHMuam9pbigiLyIpOwogIH0sCiAgY29tcHJlc3NVcmw6IGZ1bmN0aW9uKGluVXJsKSB7CiAgICB2YXIgcGFydHMgPSBpblVybC5zcGxpdCgiLyIpOwogICAgZm9yICh2YXIgaT0wLCBwOyBpPHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHAgPSBwYXJ0c1tpXTsKICAgICAgaWYgKHAgPT09ICIuLiIpIHsKICAgICAgICBwYXJ0cy5zcGxpY2UoaS0xLCAyKTsKICAgICAgICBpIC09IDI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwYXJ0cy5qb2luKCIvIik7CiAgfSwKICAvLyBtYWtlIGEgcmVsYXRpdmUgcGF0aCBmcm9tIHNvdXJjZSB0byB0YXJnZXQKICBtYWtlUmVsUGF0aDogZnVuY3Rpb24oaW5Tb3VyY2UsIGluVGFyZ2V0KSB7CiAgICB2YXIgcywgdDsKICAgIHMgPSB0aGlzLmNvbXByZXNzVXJsKGluU291cmNlKS5zcGxpdCgiLyIpOwogICAgdCA9IHRoaXMuY29tcHJlc3NVcmwoaW5UYXJnZXQpLnNwbGl0KCIvIik7CiAgICB3aGlsZSAocy5sZW5ndGggJiYgc1swXSA9PT0gdFswXSl7CiAgICAgIHMuc2hpZnQoKTsKICAgICAgdC5zaGlmdCgpOwogICAgfQogICAgZm9yKHZhciBpID0gMCwgbCA9IHMubGVuZ3RoLTE7IGkgPCBsOyBpKyspIHsKICAgICAgdC51bnNoaWZ0KCIuLiIpOwogICAgfQogICAgdmFyIHIgPSB0LmpvaW4oIi8iKTsKICAgIHJldHVybiByOwogIH0sCiAgcmVzb2x2ZVBhdGhzSW5IVE1MOiBmdW5jdGlvbihyb290LCB1cmwpIHsKICAgIHVybCA9IHVybCB8fCBwYXRoLmRvY3VtZW50VXJsRnJvbU5vZGUocm9vdCkKICAgIHBhdGgucmVzb2x2ZUF0dHJpYnV0ZXMocm9vdCwgdXJsKTsKICAgIHBhdGgucmVzb2x2ZVN0eWxlRWx0cyhyb290LCB1cmwpOwogICAgLy8gaGFuZGxlIHRlbXBsYXRlLmNvbnRlbnQKICAgIHZhciB0ZW1wbGF0ZXMgPSByb290LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RlbXBsYXRlJyk7CiAgICBpZiAodGVtcGxhdGVzKSB7CiAgICAgIGZvckVhY2godGVtcGxhdGVzLCBmdW5jdGlvbih0KSB7CiAgICAgICAgaWYgKHQuY29udGVudCkgewogICAgICAgICAgcGF0aC5yZXNvbHZlUGF0aHNJbkhUTUwodC5jb250ZW50LCB1cmwpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwKICByZXNvbHZlUGF0aHNJblN0eWxlc2hlZXQ6IGZ1bmN0aW9uKGluU2hlZXQpIHsKICAgIHZhciBkb2NVcmwgPSBwYXRoLm5vZGVVcmwoaW5TaGVldCk7CiAgICBpblNoZWV0Ll9fcmVzb3VyY2UgPSBwYXRoLnJlc29sdmVDc3NUZXh0KGluU2hlZXQuX19yZXNvdXJjZSwgZG9jVXJsKTsKICB9LAogIHJlc29sdmVTdHlsZUVsdHM6IGZ1bmN0aW9uKGluUm9vdCwgaW5VcmwpIHsKICAgIHZhciBzdHlsZXMgPSBpblJvb3QucXVlcnlTZWxlY3RvckFsbCgnc3R5bGUnKTsKICAgIGlmIChzdHlsZXMpIHsKICAgICAgZm9yRWFjaChzdHlsZXMsIGZ1bmN0aW9uKHN0eWxlKSB7CiAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBwYXRoLnJlc29sdmVDc3NUZXh0KHN0eWxlLnRleHRDb250ZW50LCBpblVybCk7CiAgICAgIH0pOwogICAgfQogIH0sCiAgcmVzb2x2ZUNzc1RleHQ6IGZ1bmN0aW9uKGluQ3NzVGV4dCwgaW5CYXNlVXJsKSB7CiAgICByZXR1cm4gaW5Dc3NUZXh0LnJlcGxhY2UoL3VybFwoW14pXSpcKS9nLCBmdW5jdGlvbihpbk1hdGNoKSB7CiAgICAgIC8vIGZpbmQgdGhlIHVybCBwYXRoLCBpZ25vcmUgcXVvdGVzIGluIHVybCBzdHJpbmcKICAgICAgdmFyIHVybFBhdGggPSBpbk1hdGNoLnJlcGxhY2UoL1siJ10vZywgIiIpLnNsaWNlKDQsIC0xKTsKICAgICAgdXJsUGF0aCA9IHBhdGgucmVzb2x2ZVVybChpbkJhc2VVcmwsIHVybFBhdGgsIHRydWUpOwogICAgICByZXR1cm4gInVybCgiICsgdXJsUGF0aCArICIpIjsKICAgIH0pOwogIH0sCiAgcmVzb2x2ZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGluUm9vdCwgaW5VcmwpIHsKICAgIC8vIHNlYXJjaCBmb3IgYXR0cmlidXRlcyB0aGF0IGhvc3QgdXJscwogICAgdmFyIG5vZGVzID0gaW5Sb290ICYmIGluUm9vdC5xdWVyeVNlbGVjdG9yQWxsKFVSTF9BVFRSU19TRUxFQ1RPUik7CiAgICBpZiAobm9kZXMpIHsKICAgICAgZm9yRWFjaChub2RlcywgZnVuY3Rpb24obikgewogICAgICAgIHRoaXMucmVzb2x2ZU5vZGVBdHRyaWJ1dGVzKG4sIGluVXJsKTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSwKICByZXNvbHZlTm9kZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGluTm9kZSwgaW5VcmwpIHsKICAgIFVSTF9BVFRSUy5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgdmFyIGF0dHIgPSBpbk5vZGUuYXR0cmlidXRlc1t2XTsKICAgICAgaWYgKGF0dHIgJiYgYXR0ci52YWx1ZSAmJgogICAgICAgICAoYXR0ci52YWx1ZS5zZWFyY2goVVJMX1RFTVBMQVRFX1NFQVJDSCkgPCAwKSkgewogICAgICAgIHZhciB1cmxQYXRoID0gcGF0aC5yZXNvbHZlVXJsKGluVXJsLCBhdHRyLnZhbHVlLCB0cnVlKTsKICAgICAgICBhdHRyLnZhbHVlID0gdXJsUGF0aDsKICAgICAgfQogICAgfSk7CiAgfQp9OwoKeGhyID0geGhyIHx8IHsKICBhc3luYzogdHJ1ZSwKICBvazogZnVuY3Rpb24oaW5SZXF1ZXN0KSB7CiAgICByZXR1cm4gKGluUmVxdWVzdC5zdGF0dXMgPj0gMjAwICYmIGluUmVxdWVzdC5zdGF0dXMgPCAzMDApCiAgICAgICAgfHwgKGluUmVxdWVzdC5zdGF0dXMgPT09IDMwNCkKICAgICAgICB8fCAoaW5SZXF1ZXN0LnN0YXR1cyA9PT0gMCk7CiAgfSwKICBsb2FkOiBmdW5jdGlvbih1cmwsIG5leHQsIG5leHRDb250ZXh0KSB7CiAgICB2YXIgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgaWYgKHNjb3BlLmZsYWdzLmRlYnVnIHx8IHNjb3BlLmZsYWdzLmJ1c3QpIHsKICAgICAgdXJsICs9ICc/JyArIE1hdGgucmFuZG9tKCk7CiAgICB9CiAgICByZXF1ZXN0Lm9wZW4oJ0dFVCcsIHVybCwgeGhyLmFzeW5jKTsKICAgIHJlcXVlc3QuYWRkRXZlbnRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKHJlcXVlc3QucmVhZHlTdGF0ZSA9PT0gNCkgewogICAgICAgIG5leHQuY2FsbChuZXh0Q29udGV4dCwgIXhoci5vayhyZXF1ZXN0KSAmJiByZXF1ZXN0LAogICAgICAgICAgcmVxdWVzdC5yZXNwb25zZSwgdXJsKTsKICAgICAgfQogICAgfSk7CiAgICByZXF1ZXN0LnNlbmQoKTsKICB9Cn07Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgovLyBleHBvcnRzCgpzY29wZS5wYXRoID0gcGF0aDsKc2NvcGUueGhyID0geGhyOwpzY29wZS5pbXBvcnRlciA9IGltcG9ydGVyOwpzY29wZS5nZXREb2N1bWVudFVybCA9IHBhdGguZ2V0RG9jdW1lbnRVcmw7CnNjb3BlLklNUE9SVF9MSU5LX1RZUEUgPSBJTVBPUlRfTElOS19UWVBFOwoKfSkod2luZG93LkhUTUxJbXBvcnRzKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oc2NvcGUpIHsKCnZhciBJTVBPUlRfTElOS19UWVBFID0gJ2ltcG9ydCc7CgovLyBoaWdobGFuZGVyIG9iamVjdCBmb3IgcGFyc2luZyBhIGRvY3VtZW50IHRyZWUKCnZhciBpbXBvcnRQYXJzZXIgPSB7CiAgc2VsZWN0b3JzOiBbCiAgICAnbGlua1tyZWw9JyArIElNUE9SVF9MSU5LX1RZUEUgKyAnXScsCiAgICAnbGlua1tyZWw9c3R5bGVzaGVldF0nLAogICAgJ3N0eWxlJywKICAgICdzY3JpcHQnCiAgXSwKICBtYXA6IHsKICAgIGxpbms6ICdwYXJzZUxpbmsnLAogICAgc2NyaXB0OiAncGFyc2VTY3JpcHQnLAogICAgc3R5bGU6ICdwYXJzZUdlbmVyaWMnCiAgfSwKICBwYXJzZTogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgaWYgKCFpbkRvY3VtZW50Ll9faW1wb3J0UGFyc2VkKSB7CiAgICAgIC8vIG9ubHkgcGFyc2Ugb25jZQogICAgICBpbkRvY3VtZW50Ll9faW1wb3J0UGFyc2VkID0gdHJ1ZTsKICAgICAgLy8gYWxsIHBhcnNhYmxlIGVsZW1lbnRzIGluIGluRG9jdW1lbnQgKGRlcHRoLWZpcnN0IHByZS1vcmRlciB0cmF2ZXJzYWwpCiAgICAgIHZhciBlbHRzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGltcG9ydFBhcnNlci5zZWxlY3RvcnMpOwogICAgICAvLyBmb3IgZWFjaCBwYXJzYWJsZSBub2RlIHR5cGUsIGNhbGwgdGhlIG1hcHBlZCBwYXJzaW5nIG1ldGhvZAogICAgICBmb3JFYWNoKGVsdHMsIGZ1bmN0aW9uKGUpIHsKICAgICAgICBpbXBvcnRQYXJzZXJbaW1wb3J0UGFyc2VyLm1hcFtlLmxvY2FsTmFtZV1dKGUpOwogICAgICB9KTsKICAgIH0KICB9LAogIHBhcnNlTGluazogZnVuY3Rpb24obGlua0VsdCkgewogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGxpbmtFbHQpKSB7CiAgICAgIGlmIChsaW5rRWx0LmNvbnRlbnQpIHsKICAgICAgICBpbXBvcnRQYXJzZXIucGFyc2UobGlua0VsdC5jb250ZW50KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5wYXJzZUdlbmVyaWMobGlua0VsdCk7CiAgICB9CiAgfSwKICBwYXJzZUdlbmVyaWM6IGZ1bmN0aW9uKGVsdCkgewogICAgaWYgKG5lZWRzTWFpbkRvY3VtZW50Q29udGV4dChlbHQpKSB7CiAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoZWx0KTsKICAgIH0KICB9LAogIHBhcnNlU2NyaXB0OiBmdW5jdGlvbihzY3JpcHRFbHQpIHsKICAgIGlmIChuZWVkc01haW5Eb2N1bWVudENvbnRleHQoc2NyaXB0RWx0KSkgewogICAgICAvLyBhY3F1aXJlIGNvZGUgdG8gZXhlY3V0ZQogICAgICB2YXIgY29kZSA9IChzY3JpcHRFbHQuX19yZXNvdXJjZSB8fCBzY3JpcHRFbHQudGV4dENvbnRlbnQpLnRyaW0oKTsKICAgICAgaWYgKGNvZGUpIHsKICAgICAgICAvLyBjYWxjdWxhdGUgc291cmNlIG1hcCBoaW50CiAgICAgICAgdmFyIG1vbmlrZXIgPSBzY3JpcHRFbHQuX19ub2RlVXJsOwogICAgICAgIGlmICghbW9uaWtlcikgewogICAgICAgICAgdmFyIG1vbmlrZXIgPSBzY29wZS5wYXRoLmRvY3VtZW50VXJsRnJvbU5vZGUoc2NyaXB0RWx0KTsKICAgICAgICAgIC8vIHRoZXJlIGNvdWxkIGJlIG1vcmUgdGhhbiBvbmUgc2NyaXB0IHRoaXMgdXJsCiAgICAgICAgICB2YXIgdGFnID0gJ1snICsgTWF0aC5mbG9vcigoTWF0aC5yYW5kb20oKSsxKSoxMDAwKSArICddJzsKICAgICAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IFBvbHltZXIgaGFjaywgc2hvdWxkIGJlIHBsdWdnYWJsZSBpZiB3ZSBuZWVkIHRvIGFsbG93IAogICAgICAgICAgLy8gdGhpcyBzb3J0IG9mIHRoaW5nCiAgICAgICAgICB2YXIgbWF0Y2hlcyA9IGNvZGUubWF0Y2goL1BvbHltZXJcKFsnIl0oW14nIl0qKS8pOwogICAgICAgICAgdGFnID0gbWF0Y2hlcyAmJiBtYXRjaGVzWzFdIHx8IHRhZzsKICAgICAgICAgIC8vIHRhZyB0aGUgbW9uaWtlcgogICAgICAgICAgbW9uaWtlciArPSAnLycgKyB0YWcgKyAnLmpzJzsKICAgICAgICB9CiAgICAgICAgLy8gc291cmNlIG1hcCBoaW50CiAgICAgICAgY29kZSArPSAiXG4vLyMgc291cmNlVVJMPSIgKyBtb25pa2VyICsgIlxuIjsKICAgICAgICAvLyBldmFsdWF0ZSB0aGUgY29kZQogICAgICAgIGV2YWwuY2FsbCh3aW5kb3csIGNvZGUpOwogICAgICB9CiAgICB9CiAgfQp9OwoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKZnVuY3Rpb24gaXNEb2N1bWVudExpbmsoZWx0KSB7CiAgcmV0dXJuIGVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJwogICAgICAmJiBlbHQuZ2V0QXR0cmlidXRlKCdyZWwnKSA9PT0gSU1QT1JUX0xJTktfVFlQRTsKfQoKZnVuY3Rpb24gbmVlZHNNYWluRG9jdW1lbnRDb250ZXh0KG5vZGUpIHsKICAvLyBub2RlcyBjYW4gYmUgbW92ZWQgdG8gdGhlIG1haW4gZG9jdW1lbnQ6CiAgLy8gaWYgdGhleSBhcmUgaW4gYSB0cmVlIGJ1dCBub3QgaW4gdGhlIG1haW4gZG9jdW1lbnQgYW5kIG5vdCBjaGlsZHJlbiBvZiA8ZWxlbWVudD4KICByZXR1cm4gbm9kZS5wYXJlbnROb2RlICYmICFpbk1haW5Eb2N1bWVudChub2RlKSAKICAgICAgJiYgIWlzRWxlbWVudEVsZW1lbnRDaGlsZChub2RlKTsKfQoKZnVuY3Rpb24gaW5NYWluRG9jdW1lbnQoZWx0KSB7CiAgcmV0dXJuIGVsdC5vd25lckRvY3VtZW50ID09PSBkb2N1bWVudCB8fAogICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NUG9seWZpbGwgaW50cnVzaW9uCiAgICBlbHQub3duZXJEb2N1bWVudC5pbXBsID09PSBkb2N1bWVudDsKfQoKZnVuY3Rpb24gaXNFbGVtZW50RWxlbWVudENoaWxkKGVsdCkgewogIHJldHVybiBlbHQucGFyZW50Tm9kZSAmJiBlbHQucGFyZW50Tm9kZS5sb2NhbE5hbWUgPT09ICdlbGVtZW50JzsKfQoKLy8gZXhwb3J0cwoKc2NvcGUucGFyc2VyID0gaW1wb3J0UGFyc2VyOwoKfSkoSFRNTEltcG9ydHMpOwovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwooZnVuY3Rpb24oKXsKCi8vIGJvb3RzdHJhcAoKLy8gSUUgc2hpbSBmb3IgQ3VzdG9tRXZlbnQKaWYgKHR5cGVvZiB3aW5kb3cuQ3VzdG9tRXZlbnQgIT09ICdmdW5jdGlvbicpIHsKICB3aW5kb3cuQ3VzdG9tRXZlbnQgPSBmdW5jdGlvbihpblR5cGUpIHsKICAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgICAgZS5pbml0RXZlbnQoaW5UeXBlLCB0cnVlLCB0cnVlKTsKICAgICByZXR1cm4gZTsKICB9Owp9CgpmdW5jdGlvbiBib290c3RyYXAoKSB7CiAgLy8gcHJlbG9hZCBkb2N1bWVudCByZXNvdXJjZSB0cmVlcwogIEhUTUxJbXBvcnRzLmltcG9ydGVyLmxvYWQoZG9jdW1lbnQsIGZ1bmN0aW9uKCkgewogICAgSFRNTEltcG9ydHMucGFyc2VyLnBhcnNlKGRvY3VtZW50KTsKICAgIEhUTUxJbXBvcnRzLnJlYWR5VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgLy8gc2VuZCBIVE1MSW1wb3J0c0xvYWRlZCB3aGVuIGZpbmlzaGVkCiAgICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KAogICAgICBuZXcgQ3VzdG9tRXZlbnQoJ0hUTUxJbXBvcnRzTG9hZGVkJywge2J1YmJsZXM6IHRydWV9KQogICAgKTsKICB9KTsKfTsKCmlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7CiAgYm9vdHN0cmFwKCk7Cn0gZWxzZSB7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBib290c3RyYXApOwp9Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbigpIHsKCi8vIGltcG9ydAoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSB3aW5kb3cuSFRNTEltcG9ydHMgPyBIVE1MSW1wb3J0cy5JTVBPUlRfTElOS19UWVBFIDogJ25vbmUnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgZm9yIHBhcnNpbmcgYSBkb2N1bWVudCB0cmVlCgp2YXIgcGFyc2VyID0gewogIHNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nLAogICAgJ2VsZW1lbnQnCiAgXSwKICBtYXA6IHsKICAgIGxpbms6ICdwYXJzZUxpbmsnLAogICAgZWxlbWVudDogJ3BhcnNlRWxlbWVudCcKICB9LAogIHBhcnNlOiBmdW5jdGlvbihpbkRvY3VtZW50KSB7CiAgICBpZiAoIWluRG9jdW1lbnQuX19wYXJzZWQpIHsKICAgICAgLy8gb25seSBwYXJzZSBvbmNlCiAgICAgIGluRG9jdW1lbnQuX19wYXJzZWQgPSB0cnVlOwogICAgICAvLyBhbGwgcGFyc2FibGUgZWxlbWVudHMgaW4gaW5Eb2N1bWVudCAoZGVwdGgtZmlyc3QgcHJlLW9yZGVyIHRyYXZlcnNhbCkKICAgICAgdmFyIGVsdHMgPSBpbkRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwocGFyc2VyLnNlbGVjdG9ycyk7CiAgICAgIC8vIGZvciBlYWNoIHBhcnNhYmxlIG5vZGUgdHlwZSwgY2FsbCB0aGUgbWFwcGVkIHBhcnNpbmcgbWV0aG9kCiAgICAgIGZvckVhY2goZWx0cywgZnVuY3Rpb24oZSkgewogICAgICAgIHBhcnNlcltwYXJzZXIubWFwW2UubG9jYWxOYW1lXV0oZSk7CiAgICAgIH0pOwogICAgICAvLyB1cGdyYWRlIGFsbCB1cGdyYWRlYWJsZSBzdGF0aWMgZWxlbWVudHMsIGFueXRoaW5nIGR5bmFtaWNhbGx5CiAgICAgIC8vIGNyZWF0ZWQgc2hvdWxkIGJlIGNhdWdodCBieSBvYnNlcnZlcgogICAgICBDdXN0b21FbGVtZW50cy51cGdyYWRlRG9jdW1lbnQoaW5Eb2N1bWVudCk7CiAgICAgIC8vIG9ic2VydmUgZG9jdW1lbnQgZm9yIGRvbSBjaGFuZ2VzCiAgICAgIEN1c3RvbUVsZW1lbnRzLm9ic2VydmVEb2N1bWVudChpbkRvY3VtZW50KTsKICAgIH0KICB9LAogIHBhcnNlTGluazogZnVuY3Rpb24obGlua0VsdCkgewogICAgLy8gaW1wb3J0cwogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGxpbmtFbHQpKSB7CiAgICAgIHRoaXMucGFyc2VJbXBvcnQobGlua0VsdCk7CiAgICB9CiAgfSwKICBwYXJzZUltcG9ydDogZnVuY3Rpb24obGlua0VsdCkgewogICAgaWYgKGxpbmtFbHQuY29udGVudCkgewogICAgICBwYXJzZXIucGFyc2UobGlua0VsdC5jb250ZW50KTsKICAgIH0KICB9LAogIHBhcnNlRWxlbWVudDogZnVuY3Rpb24oaW5FbGVtZW50RWx0KSB7CiAgICBuZXcgSFRNTEVsZW1lbnRFbGVtZW50KGluRWxlbWVudEVsdCk7CiAgfQp9OwoKZnVuY3Rpb24gaXNEb2N1bWVudExpbmsoaW5FbHQpIHsKICByZXR1cm4gKGluRWx0LmxvY2FsTmFtZSA9PT0gJ2xpbmsnCiAgICAgICYmIGluRWx0LmdldEF0dHJpYnV0ZSgncmVsJykgPT09IElNUE9SVF9MSU5LX1RZUEUpOwp9Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgovLyBleHBvcnRzCgpDdXN0b21FbGVtZW50cy5wYXJzZXIgPSBwYXJzZXI7Cgp9KSgpOwovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwooZnVuY3Rpb24oKXsKCi8vIGJvb3RzdHJhcCBwYXJzaW5nCgpmdW5jdGlvbiBib290c3RyYXAoKSB7CiAgLy8gZ28gYXN5bmMgc28gY2FsbCBzdGFjayBjYW4gdW53aW5kCiAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgIC8vIHBhcnNlIGRvY3VtZW50CiAgICBDdXN0b21FbGVtZW50cy5wYXJzZXIucGFyc2UoZG9jdW1lbnQpOwogICAgLy8gb25lIG1vcmUgcGFzcyBiZWZvcmUgcmVnaXN0ZXIgaXMgJ2xpdmUnCiAgICBDdXN0b21FbGVtZW50cy51cGdyYWRlRG9jdW1lbnQoZG9jdW1lbnQpOyAgCiAgICAvLyBzZXQgaW50ZXJuYWwgJ3JlYWR5JyBmbGFnLCBub3cgZG9jdW1lbnQucmVnaXN0ZXIgd2lsbCB0cmlnZ2VyIAogICAgLy8gc3luY2hyb25vdXMgdXBncmFkZXMKICAgIEN1c3RvbUVsZW1lbnRzLnJlYWR5ID0gdHJ1ZTsKICAgIC8vIGNhcHR1cmUgYmx1bnQgcHJvZmlsaW5nIGRhdGEKICAgIEN1c3RvbUVsZW1lbnRzLnJlYWR5VGltZSA9IERhdGUubm93KCk7CiAgICBpZiAod2luZG93LkhUTUxJbXBvcnRzKSB7CiAgICAgIEN1c3RvbUVsZW1lbnRzLmVsYXBzZWQgPSBDdXN0b21FbGVtZW50cy5yZWFkeVRpbWUgLSBIVE1MSW1wb3J0cy5yZWFkeVRpbWU7CiAgICB9CiAgICAvLyBub3RpZnkgdGhlIHN5c3RlbSB0aGF0IHdlIGFyZSBib290c3RyYXBwZWQKICAgIGRvY3VtZW50LmJvZHkuZGlzcGF0Y2hFdmVudCgKICAgICAgbmV3IEN1c3RvbUV2ZW50KCdXZWJDb21wb25lbnRzUmVhZHknLCB7YnViYmxlczogdHJ1ZX0pCiAgICApOwogIH0sIDApOwp9CgovLyBDdXN0b21FdmVudCBzaGltIGZvciBJRQppZiAodHlwZW9mIHdpbmRvdy5DdXN0b21FdmVudCAhPT0gJ2Z1bmN0aW9uJykgewogIHdpbmRvdy5DdXN0b21FdmVudCA9IGZ1bmN0aW9uKGluVHlwZSkgewogICAgIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgICBlLmluaXRFdmVudChpblR5cGUsIHRydWUsIHRydWUpOwogICAgIHJldHVybiBlOwogIH07Cn0KCmlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7CiAgYm9vdHN0cmFwKCk7Cn0gZWxzZSB7CiAgdmFyIGxvYWRFdmVudCA9IHdpbmRvdy5IVE1MSW1wb3J0cyA/ICdIVE1MSW1wb3J0c0xvYWRlZCcgOiAnRE9NQ29udGVudExvYWRlZCc7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIobG9hZEV2ZW50LCBib290c3RyYXApOwp9Cgp9KSgpOwoKKGZ1bmN0aW9uICgpIHsKCi8qKiogVmFyaWFibGVzICoqKi8KCiAgdmFyIHdpbiA9IHdpbmRvdywKICAgIGRvYyA9IGRvY3VtZW50LAogICAgbm9vcCA9IGZ1bmN0aW9uKCl7fSwKICAgIHJlZ2V4UHNldWRvU3BsaXQgPSAvKFtcdy1dKyg/OlwoW15cKV0rXCkpPykvZywKICAgIHJlZ2V4UHNldWRvUmVwbGFjZSA9IC8oXHcqKSg/OlwoKFteXCldKilcKSk/LywKICAgIHJlZ2V4RGlnaXRzID0gLyhcZCspL2csCiAgICBrZXlwc2V1ZG8gPSB7CiAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICByZXR1cm4gcHNldWRvLnZhbHVlLm1hdGNoKHJlZ2V4RGlnaXRzKS5pbmRleE9mKFN0cmluZyhldmVudC5rZXlDb2RlKSkgPiAtMSA9PSAocHNldWRvLm5hbWUgPT0gJ2tleXBhc3MnKTsKICAgICAgfQogICAgfSwKICAgIHByZWZpeCA9IChmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBzdHlsZXMgPSB3aW4uZ2V0Q29tcHV0ZWRTdHlsZShkb2MuZG9jdW1lbnRFbGVtZW50LCAnJyksCiAgICAgICAgICBwcmUgPSAoQXJyYXkucHJvdG90eXBlLnNsaWNlCiAgICAgICAgICAgIC5jYWxsKHN0eWxlcykKICAgICAgICAgICAgLmpvaW4oJycpCiAgICAgICAgICAgIC5tYXRjaCgvLShtb3p8d2Via2l0fG1zKS0vKSB8fCAoc3R5bGVzLk9MaW5rID09PSAnJyAmJiBbJycsICdvJ10pCiAgICAgICAgICApWzFdOwogICAgICByZXR1cm4gewogICAgICAgIGRvbTogcHJlID09ICdtcycgPyBwcmUudG9VcHBlckNhc2UoKSA6IHByZSwKICAgICAgICBsb3dlcmNhc2U6IHByZSwKICAgICAgICBjc3M6ICctJyArIHByZSArICctJywKICAgICAgICBqczogcHJlID09ICdtcycgPyBwcmUgOiBwcmVbMF0udG9VcHBlckNhc2UoKSArIHByZS5zdWJzdHIoMSkKICAgICAgfTsKCiAgICB9KSgpLAogICAgbWF0Y2hTZWxlY3RvciA9IEVsZW1lbnQucHJvdG90eXBlLm1hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50LnByb3RvdHlwZVtwcmVmaXgubG93ZXJjYXNlICsgJ01hdGNoZXNTZWxlY3RvciddOwoKLyoqKiBGdW5jdGlvbnMgKioqLwoKLy8gVXRpbGl0aWVzCgogIHZhciB0eXBlT2JqID0ge307CiAgZnVuY3Rpb24gdHlwZU9mKG9iaikgewogICAgcmV0dXJuIHR5cGVPYmoudG9TdHJpbmcuY2FsbChvYmopLm1hdGNoKC9ccyhbYS16QS1aXSspLylbMV0udG9Mb3dlckNhc2UoKTsKICB9CgogIGZ1bmN0aW9uIGNsb25lKGl0ZW0sIHR5cGUpewogICAgdmFyIGZuID0gY2xvbmVbdHlwZSB8fCB0eXBlT2YoaXRlbSldOwogICAgcmV0dXJuIGZuID8gZm4oaXRlbSkgOiBpdGVtOwogIH0KICAgIGNsb25lLm9iamVjdCA9IGZ1bmN0aW9uKHNyYyl7CiAgICAgIHZhciBvYmogPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHNyYykgb2JqW2tleV0gPSBjbG9uZShzcmNba2V5XSk7CiAgICAgIHJldHVybiBvYmo7CiAgICB9OwogICAgY2xvbmUuYXJyYXkgPSBmdW5jdGlvbihzcmMpewogICAgICB2YXIgaSA9IHNyYy5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwogICAgICB3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGNsb25lKHNyY1tpXSk7CiAgICAgIHJldHVybiBhcnJheTsKICAgIH07CgogIHZhciB1bnNsaWNlYWJsZSA9IFsnbnVtYmVyJywgJ2Jvb2xlYW4nLCAnc3RyaW5nJywgJ2Z1bmN0aW9uJ107CiAgZnVuY3Rpb24gdG9BcnJheShvYmopewogICAgcmV0dXJuIHVuc2xpY2VhYmxlLmluZGV4T2YodHlwZU9mKG9iaikpID09IC0xID8KICAgIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKG9iaiwgMCkgOgogICAgW29ial07CiAgfQoKLy8gRE9NCiAgdmFyIHN0ciA9ICcnOwogIGZ1bmN0aW9uIHF1ZXJ5KGVsZW1lbnQsIHNlbGVjdG9yKXsKICAgIHJldHVybiAoc2VsZWN0b3IgfHwgc3RyKS5sZW5ndGggPyB0b0FycmF5KGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikpIDogW107CiAgfQoKICBmdW5jdGlvbiBwYXJzZU11dGF0aW9ucyhlbGVtZW50LCBtdXRhdGlvbnMpIHsKICAgIHZhciBkaWZmID0geyBhZGRlZDogW10sIHJlbW92ZWQ6IFtdIH07CiAgICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihyZWNvcmQpewogICAgICByZWNvcmQuX211dGF0aW9uID0gdHJ1ZTsKICAgICAgZm9yICh2YXIgeiBpbiBkaWZmKSB7CiAgICAgICAgdmFyIHR5cGUgPSBlbGVtZW50Ll9yZWNvcmRzWyh6ID09ICdhZGRlZCcpID8gJ2luc2VydGVkJyA6ICdyZW1vdmVkJ10sCiAgICAgICAgICBub2RlcyA9IHJlY29yZFt6ICsgJ05vZGVzJ10sIGxlbmd0aCA9IG5vZGVzLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aCAmJiBkaWZmW3pdLmluZGV4T2Yobm9kZXNbaV0pID09IC0xOyBpKyspewogICAgICAgICAgZGlmZlt6XS5wdXNoKG5vZGVzW2ldKTsKICAgICAgICAgIHR5cGUuZm9yRWFjaChmdW5jdGlvbihmbil7CiAgICAgICAgICAgIGZuKG5vZGVzW2ldLCByZWNvcmQpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CgovLyBNaXhpbnMKCiAgZnVuY3Rpb24gbWVyZ2VPbmUoc291cmNlLCBrZXksIGN1cnJlbnQpewogICAgdmFyIHR5cGUgPSB0eXBlT2YoY3VycmVudCk7CiAgICBpZiAodHlwZSA9PSAnb2JqZWN0JyAmJiB0eXBlT2Yoc291cmNlW2tleV0pID09ICdvYmplY3QnKSB4dGFnLm1lcmdlKHNvdXJjZVtrZXldLCBjdXJyZW50KTsKICAgIGVsc2Ugc291cmNlW2tleV0gPSBjbG9uZShjdXJyZW50LCB0eXBlKTsKICAgIHJldHVybiBzb3VyY2U7CiAgfQoKICBmdW5jdGlvbiBtZXJnZU1peGluKHR5cGUsIG1peGluLCBvcHRpb24pIHsKICAgIHZhciBvcmlnaW5hbCA9IHt9OwogICAgZm9yICh2YXIgbyBpbiBvcHRpb24pIG9yaWdpbmFsW28uc3BsaXQoJzonKVswXV0gPSB0cnVlOwogICAgZm9yICh2YXIgeCBpbiBtaXhpbikgaWYgKCFvcmlnaW5hbFt4LnNwbGl0KCc6JylbMF1dKSBvcHRpb25beF0gPSBtaXhpblt4XTsKICB9CgogIGZ1bmN0aW9uIGFwcGx5TWl4aW5zKHRhZykgewogICAgdGFnLm1peGlucy5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHZhciBtaXhpbiA9IHh0YWcubWl4aW5zW25hbWVdOwogICAgICBmb3IgKHZhciB0eXBlIGluIG1peGluKSB7CiAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICBjYXNlICdsaWZlY3ljbGUnOiBjYXNlICdtZXRob2RzJzoKICAgICAgICAgICAgbWVyZ2VNaXhpbih0eXBlLCBtaXhpblt0eXBlXSwgdGFnW3R5cGVdKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdhY2Nlc3NvcnMnOiBjYXNlICdwcm90b3R5cGUnOgogICAgICAgICAgICBmb3IgKHZhciB6IGluIG1peGluW3R5cGVdKSBtZXJnZU1peGluKHosIG1peGluW3R5cGVdLCB0YWcuYWNjZXNzb3JzKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdldmVudHMnOgogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHRhZzsKICB9CgovLyBFdmVudHMKCiAgZnVuY3Rpb24gdG91Y2hGaWx0ZXIoY3VzdG9tLCBldmVudCkgewogICAgdmFyIHJldFZhbDsKICAgIGlmIChjdXN0b20ubGlzdGVuZXIudG91Y2hlZCkgewogICAgICBjdXN0b20ubGlzdGVuZXIudG91Y2hlZCA9IGZhbHNlOwogICAgICByZXRWYWwgPSBmYWxzZTsKICAgIH0KICAgIGVsc2UgaWYgKGV2ZW50LnR5cGUubWF0Y2goJ3RvdWNoJykpewogICAgIGN1c3RvbS5saXN0ZW5lci50b3VjaGVkID0gdHJ1ZTsKICAgIH0KICAgIHJldHVybiByZXRWYWw7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVGbG93RXZlbnQodHlwZSkgewogICAgdmFyIGZsb3cgPSB0eXBlID09ICdvdmVyJzsKICAgIHJldHVybiB7CiAgICAgIGJhc2U6ICdPdmVyZmxvd0V2ZW50JyBpbiB3aW4gPyAnb3ZlcmZsb3djaGFuZ2VkJyA6IHR5cGUgKyAnZmxvdycsCiAgICAgIGNvbmRpdGlvbjogZnVuY3Rpb24gKGN1c3RvbSwgZXZlbnQpIHsKICAgICAgICBldmVudC5mbG93ID0gdHlwZTsKICAgICAgICByZXR1cm4gZXZlbnQudHlwZSA9PSAodHlwZSArICdmbG93JykgfHwKICAgICAgICAoKGV2ZW50Lm9yaWVudCA9PT0gMCAmJiBldmVudC5ob3Jpem9udGFsT3ZlcmZsb3cgPT0gZmxvdykgfHwKICAgICAgICAoZXZlbnQub3JpZW50ID09IDEgJiYgZXZlbnQudmVydGljYWxPdmVyZmxvdyA9PSBmbG93KSB8fAogICAgICAgIChldmVudC5vcmllbnQgPT0gMiAmJiBldmVudC5ob3Jpem9udGFsT3ZlcmZsb3cgPT0gZmxvdyAmJiBldmVudC52ZXJ0aWNhbE92ZXJmbG93ID09IGZsb3cpKTsKICAgICAgfQogICAgfTsKICB9CgovLyBBY2Nlc3NvcnMKCiAgZnVuY3Rpb24gZ2V0QXJncyhhdHRyLCB2YWx1ZSl7CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSwKICAgICAgbWV0aG9kOiBhdHRyLmJvb2xlYW4gJiYgKHZhbHVlID09PSBmYWxzZSB8fCB2YWx1ZSA9PT0gbnVsbCkgPyAncmVtb3ZlQXR0cmlidXRlJyA6ICdzZXRBdHRyaWJ1dGUnCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gc2V0QXR0cihhdHRyLCBuYW1lLCB2YWx1ZSl7CiAgICB2YXIgYXJncyA9IGdldEFyZ3MoYXR0ciwgdmFsdWUpOwogICAgdGhpc1thcmdzLm1ldGhvZF0obmFtZSwgYXJncy52YWx1ZSk7CiAgfQoKICBmdW5jdGlvbiBzeW5jQXR0cihhdHRyLCBuYW1lLCB2YWx1ZSl7CiAgICB2YXIgYXJncyA9IGdldEFyZ3MoYXR0ciwgdmFsdWUpLAogICAgICAgIG5vZGVzID0gYXR0ci5wcm9wZXJ0eSA/IFt0aGlzLnh0YWdbYXR0ci5wcm9wZXJ0eV1dIDogYXR0ci5zZWxlY3RvciA/IHh0YWcucXVlcnkodGhpcywgYXR0ci5zZWxlY3RvcikgOiBbXSwKICAgICAgICBpbmRleCA9IG5vZGVzLmxlbmd0aDsKICAgIHdoaWxlIChpbmRleC0tKSBub2Rlc1tpbmRleF1bYXJncy5tZXRob2RdKG5hbWUsIGFyZ3MudmFsdWUpOwogIH0KCiAgZnVuY3Rpb24gd3JhcEF0dHIodGFnLCBtZXRob2QpewogICAgdmFyIG9yaWdpbmFsID0gdGFnLnByb3RvdHlwZVttZXRob2RdIHx8IEhUTUxFbGVtZW50LnByb3RvdHlwZVttZXRob2RdOwogICAgdGFnLnByb3RvdHlwZVttZXRob2RdID0gewogICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgZW51bWJlcmFibGU6IHRydWUsCiAgICAgIHZhbHVlOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUsIHNraXApewogICAgICAgIHZhciBhdHRyID0gdGFnLmF0dHJpYnV0ZXNbbmFtZS50b0xvd2VyQ2FzZSgpXTsKICAgICAgICBvcmlnaW5hbC5jYWxsKHRoaXMsIG5hbWUsIGF0dHIgJiYgYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSk7CiAgICAgICAgaWYgKGF0dHIpIHsKICAgICAgICAgIHN5bmNBdHRyLmNhbGwodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgICAgaWYgKCFhdHRyLnNraXAgJiYgIXRoaXMueHRhZy5fc2tpcEF0dHIpIHsKICAgICAgICAgICAgYXR0ci5zZXR0ZXIuY2FsbCh0aGlzLCBhdHRyLmJvb2xlYW4gPyBtZXRob2QgPT0gJ3NldEF0dHJpYnV0ZScgOiB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKSk7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgdGhpcy54dGFnLl9za2lwQXR0cjsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiB1cGRhdGVUZW1wbGF0ZShlbGVtZW50LCBuYW1lLCB2YWx1ZSl7CiAgICBpZiAoZWxlbWVudC50ZW1wbGF0ZSl7CiAgICAgIGVsZW1lbnQueHRhZy50ZW1wbGF0ZS51cGRhdGVCaW5kaW5nVmFsdWUoZWxlbWVudCwgbmFtZSwgdmFsdWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYXR0YWNoUHJvcGVydGllcyh0YWcsIHByb3AsIHosIGFjY2Vzc29yLCBhdHRyLCBuYW1lKXsKICAgIHZhciBrZXkgPSB6LnNwbGl0KCc6JyksIHR5cGUgPSBrZXlbMF07CiAgICBpZiAodHlwZSA9PSAnZ2V0JykgewogICAgICBrZXlbMF0gPSBwcm9wOwogICAgICB0YWcucHJvdG90eXBlW3Byb3BdLmdldCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGtleS5qb2luKCc6JyksIGFjY2Vzc29yW3pdLCB0YWcucHNldWRvcyk7CiAgICB9CiAgICBlbHNlIGlmICh0eXBlID09ICdzZXQnKSB7CiAgICAgIGtleVswXSA9IHByb3A7CiAgICAgIGlmIChhdHRyKSBhdHRyLnNldHRlciA9IGFjY2Vzc29yW3pdOwogICAgICB0YWcucHJvdG90eXBlW3Byb3BdLnNldCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGtleS5qb2luKCc6JyksIGF0dHIgPyBmdW5jdGlvbih2YWx1ZSwgc2tpcCl7CiAgICAgICAgc3luY0F0dHIuY2FsbCh0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgYWNjZXNzb3Jbel0uY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgaWYgKCFza2lwICYmICFhdHRyLnNraXApIHsKICAgICAgICAgIHRoaXMueHRhZy5fc2tpcEF0dHIgPSB0cnVlOwogICAgICAgICAgc2V0QXR0ci5jYWxsKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgdXBkYXRlVGVtcGxhdGUodGhpcywgbmFtZSwgdmFsdWUpOwoKICAgICAgfSA6IGFjY2Vzc29yW3pdID8gZnVuY3Rpb24odmFsdWUpewogICAgICAgIGFjY2Vzc29yW3pdLmNhbGwodGhpcywgdmFsdWUpOwogICAgICAgIHVwZGF0ZVRlbXBsYXRlKHRoaXMsIG5hbWUsIHZhbHVlKTsKICAgICAgfSA6IG51bGwsIHRhZy5wc2V1ZG9zKTsKICAgIH0KICAgIGVsc2UgdGFnLnByb3RvdHlwZVtwcm9wXVt6XSA9IGFjY2Vzc29yW3pdOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VBY2Nlc3Nvcih0YWcsIHByb3ApewogICAgdGFnLnByb3RvdHlwZVtwcm9wXSA9IHt9OwogICAgdmFyIGFjY2Vzc29yID0gdGFnLmFjY2Vzc29yc1twcm9wXSwKICAgICAgICBhdHRyID0gYWNjZXNzb3IuYXR0cmlidXRlLAogICAgICAgIG5hbWUgPSBhdHRyICYmIGF0dHIubmFtZSA/IGF0dHIubmFtZS50b0xvd2VyQ2FzZSgpIDogcHJvcDsKCiAgICBpZiAoYXR0cikgdGFnLmF0dHJpYnV0ZXNbbmFtZV0gPSBhdHRyOwogICAgZm9yICh2YXIgeiBpbiBhY2Nlc3NvcikgYXR0YWNoUHJvcGVydGllcyh0YWcsIHByb3AsIHosIGFjY2Vzc29yLCBhdHRyLCBuYW1lKTsKCiAgICBpZiAoYXR0cikgewogICAgICBpZiAoIXRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0KSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IChhdHRyLmJvb2xlYW4gPyAnaGFzJyA6ICdnZXQnKSArICdBdHRyaWJ1dGUnOwogICAgICAgIHRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0ID0gZnVuY3Rpb24oKXsKICAgICAgICAgIHJldHVybiB0aGlzW21ldGhvZF0obmFtZSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAoIXRhZy5wcm90b3R5cGVbcHJvcF0uc2V0KSB0YWcucHJvdG90eXBlW3Byb3BdLnNldCA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICB0aGlzLnh0YWcuX3NraXBBdHRyID0gdHJ1ZTsKICAgICAgICBzZXRBdHRyLmNhbGwodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgIHVwZGF0ZVRlbXBsYXRlKHRoaXMsIG5hbWUsIHZhbHVlKTsKICAgICAgfTsKICAgIH0KICB9CgovKioqIFgtVGFnIE9iamVjdCBEZWZpbml0aW9uICoqKi8KCiAgdmFyIHh0YWcgPSB7CiAgICB0YWdzOiB7fSwKICAgIGRlZmF1bHRPcHRpb25zOiB7CiAgICAgIHBzZXVkb3M6IFtdLAogICAgICBtaXhpbnM6IFtdLAogICAgICBldmVudHM6IHt9LAogICAgICBtZXRob2RzOiB7fSwKICAgICAgYWNjZXNzb3JzOiB7CiAgICAgICAgdGVtcGxhdGU6IHsKICAgICAgICAgIGF0dHJpYnV0ZToge30sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICAgICAgdmFyIGxhc3QgPSB0aGlzLmdldEF0dHJpYnV0ZSgndGVtcGxhdGUnKTsKICAgICAgICAgICAgdGhpcy54dGFnLl9fcHJldmlvdXNUZW1wbGF0ZV9fID0gbGFzdDsKICAgICAgICAgICAgeHRhZy5maXJlRXZlbnQodGhpcywgJ3RlbXBsYXRlY2hhbmdlJywgeyB0ZW1wbGF0ZTogdmFsdWUgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBsaWZlY3ljbGU6IHt9LAogICAgICBhdHRyaWJ1dGVzOiB7fSwKICAgICAgJ3Byb3RvdHlwZSc6IHsKICAgICAgICB4dGFnOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9feHRhZ19fID8gdGhpcy5fX3h0YWdfXyA6ICh0aGlzLl9feHRhZ19fID0geyBkYXRhOiB7fSB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICByZWdpc3RlcjogZnVuY3Rpb24gKG5hbWUsIG9wdGlvbnMpIHsKICAgICAgdmFyIGVsZW1lbnQsIF9uYW1lOwogICAgICBpZiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycpIHsKICAgICAgICBfbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgfSBlbHNlIGlmIChuYW1lLm5vZGVOYW1lID09ICdFTEVNRU5UJykgewogICAgICAgIGVsZW1lbnQgPSBuYW1lOwogICAgICAgIF9uYW1lID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ25hbWUnKS50b0xvd2VyQ2FzZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHRhZyA9IHh0YWcudGFnc1tfbmFtZV0gPSBhcHBseU1peGlucyh4dGFnLm1lcmdlKHt9LCB4dGFnLmRlZmF1bHRPcHRpb25zLCBvcHRpb25zKSk7CgogICAgICBmb3IgKHZhciB6IGluIHRhZy5ldmVudHMpIHRhZy5ldmVudHNbel0gPSB4dGFnLnBhcnNlRXZlbnQoeiwgdGFnLmV2ZW50c1t6XSk7CiAgICAgIGZvciAoeiBpbiB0YWcubGlmZWN5Y2xlKSB0YWcubGlmZWN5Y2xlW3ouc3BsaXQoJzonKVswXV0gPSB4dGFnLmFwcGx5UHNldWRvcyh6LCB0YWcubGlmZWN5Y2xlW3pdLCB0YWcucHNldWRvcyk7CiAgICAgIGZvciAoeiBpbiB0YWcubWV0aG9kcykgdGFnLnByb3RvdHlwZVt6LnNwbGl0KCc6JylbMF1dID0geyB2YWx1ZTogeHRhZy5hcHBseVBzZXVkb3MoeiwgdGFnLm1ldGhvZHNbel0sIHRhZy5wc2V1ZG9zKSwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBmb3IgKHogaW4gdGFnLmFjY2Vzc29ycykgcGFyc2VBY2Nlc3Nvcih0YWcsIHopOwoKICAgICAgdmFyIHJlYWR5ID0gdGFnLmxpZmVjeWNsZS5jcmVhdGVkIHx8IHRhZy5saWZlY3ljbGUucmVhZHk7CiAgICAgIHRhZy5wcm90b3R5cGUucmVhZHlDYWxsYmFjayA9IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzOwogICAgICAgICAgdmFyIHRlbXBsYXRlID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3RlbXBsYXRlJyk7CiAgICAgICAgICBpZiAodGVtcGxhdGUpewogICAgICAgICAgICB4dGFnLmZpcmVFdmVudCh0aGlzLCAndGVtcGxhdGVjaGFuZ2UnLCB7IHRlbXBsYXRlOiB0ZW1wbGF0ZSB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHh0YWcuYWRkRXZlbnRzKHRoaXMsIHRhZy5ldmVudHMpOwogICAgICAgICAgdGFnLm1peGlucy5mb3JFYWNoKGZ1bmN0aW9uKG1peGluKXsKICAgICAgICAgICAgaWYgKHh0YWcubWl4aW5zW21peGluXS5ldmVudHMpIHh0YWcuYWRkRXZlbnRzKGVsZW1lbnQsIHh0YWcubWl4aW5zW21peGluXS5ldmVudHMpOwogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgb3V0cHV0ID0gcmVhZHkgPyByZWFkeS5hcHBseSh0aGlzLCB0b0FycmF5KGFyZ3VtZW50cykpIDogbnVsbDsKICAgICAgICAgIGZvciAodmFyIG5hbWUgaW4gdGFnLmF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lXSwKICAgICAgICAgICAgICAgIGhhc0F0dHIgPSB0aGlzLmhhc0F0dHJpYnV0ZShuYW1lKSwKICAgICAgICAgICAgICAgIHZhbHVlID0gYXR0ci5ib29sZWFuID8gaGFzQXR0ciA6IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICBpZiAoYXR0ci5ib29sZWFuIHx8IGhhc0F0dHIpIHsKICAgICAgICAgICAgICBzeW5jQXR0ci5jYWxsKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICBpZiAoYXR0ci5zZXR0ZXIpIGF0dHIuc2V0dGVyLmNhbGwodGhpcywgdmFsdWUsIHRydWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0YWcucHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgICAgIG9iai5vbkFkZC5jYWxsKGVsZW1lbnQsIG9iaik7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgaWYgKHRhZy5saWZlY3ljbGUuaW5zZXJ0ZWQpIHRhZy5wcm90b3R5cGUuaW5zZXJ0ZWRDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUuaW5zZXJ0ZWQsIGVudW1lcmFibGU6IHRydWUgfTsKICAgICAgaWYgKHRhZy5saWZlY3ljbGUucmVtb3ZlZCkgdGFnLnByb3RvdHlwZS5yZW1vdmVkQ2FsbGJhY2sgPSB7IHZhbHVlOiB0YWcubGlmZWN5Y2xlLnJlbW92ZWQsIGVudW1lcmFibGU6IHRydWUgfTsKICAgICAgaWYgKHRhZy5saWZlY3ljbGUuYXR0cmlidXRlQ2hhbmdlZCkgdGFnLnByb3RvdHlwZS5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sgPSB7IHZhbHVlOiB0YWcubGlmZWN5Y2xlLmF0dHJpYnV0ZUNoYW5nZWQsIGVudW1lcmFibGU6IHRydWUgfTsKCiAgICAgIHdyYXBBdHRyKHRhZywgJ3NldEF0dHJpYnV0ZScpOwogICAgICB3cmFwQXR0cih0YWcsICdyZW1vdmVBdHRyaWJ1dGUnKTsKCiAgICAgIGlmIChlbGVtZW50KXsKICAgICAgICBlbGVtZW50LnJlZ2lzdGVyKHsKICAgICAgICAgICdwcm90b3R5cGUnOiBPYmplY3QuY3JlYXRlKE9iamVjdC5wcm90b3R5cGUsIHRhZy5wcm90b3R5cGUpCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGRvYy5yZWdpc3RlcihfbmFtZSwgewogICAgICAgICAgJ2V4dGVuZHMnOiBvcHRpb25zWydleHRlbmRzJ10sCiAgICAgICAgICAncHJvdG90eXBlJzogT2JqZWN0LmNyZWF0ZShPYmplY3QuY3JlYXRlKChvcHRpb25zWydleHRlbmRzJ10gPwogICAgICAgICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KG9wdGlvbnNbJ2V4dGVuZHMnXSkuY29uc3RydWN0b3IgOgogICAgICAgICAgICB3aW4uSFRNTEVsZW1lbnQpLnByb3RvdHlwZSwgdGFnLnByb3RvdHlwZSksIHRhZy5wcm90b3R5cGUpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgLyogRXhwb3NlZCBWYXJpYWJsZXMgKi8KCiAgICBtaXhpbnM6IHt9LAogICAgcHJlZml4OiBwcmVmaXgsCiAgICB0ZW1wbGF0ZXM6IHt9LAogICAgY2FwdHVyZUV2ZW50czogWydmb2N1cycsICdibHVyJ10sCiAgICBjdXN0b21FdmVudHM6IHsKICAgICAgb3ZlcmZsb3c6IGNyZWF0ZUZsb3dFdmVudCgnb3ZlcicpLAogICAgICB1bmRlcmZsb3c6IGNyZWF0ZUZsb3dFdmVudCgndW5kZXInKSwKICAgICAgYW5pbWF0aW9uc3RhcnQ6IHsKICAgICAgICBiYXNlOiBbCiAgICAgICAgICAnYW5pbWF0aW9uc3RhcnQnLAogICAgICAgICAgJ29BbmltYXRpb25TdGFydCcsCiAgICAgICAgICAnTVNBbmltYXRpb25TdGFydCcsCiAgICAgICAgICAnd2Via2l0QW5pbWF0aW9uU3RhcnQnCiAgICAgICAgXQogICAgICB9LAogICAgICB0cmFuc2l0aW9uZW5kOiB7CiAgICAgICAgYmFzZTogWwogICAgICAgICAgJ3RyYW5zaXRpb25lbmQnLAogICAgICAgICAgJ29UcmFuc2l0aW9uRW5kJywKICAgICAgICAgICdNU1RyYW5zaXRpb25FbmQnLAogICAgICAgICAgJ3dlYmtpdFRyYW5zaXRpb25FbmQnCiAgICAgICAgXQogICAgICB9LAogICAgICB0YXA6IHsKICAgICAgICBiYXNlOiBbJ2NsaWNrJywgJ3RvdWNoZW5kJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBzdGFydDogewogICAgICAgIGJhc2U6IFsnbW91c2Vkb3duJywgJ3RvdWNoc3RhcnQnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcGVuZDogewogICAgICAgIGJhc2U6IFsnbW91c2V1cCcsICd0b3VjaGVuZCddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwZW50ZXI6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlb3ZlcicsICd0b3VjaGVudGVyJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBsZWF2ZTogewogICAgICAgIGJhc2U6IFsnbW91c2VvdXQnLCAndG91Y2hsZWF2ZSddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwbW92ZTogewogICAgICAgIGJhc2U6IFsnbW91c2Vtb3ZlJywgJ3RvdWNobW92ZSddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfQogICAgfSwKICAgIHBzZXVkb3M6IHsKICAgICAga2V5cGFzczoga2V5cHNldWRvLAogICAgICBrZXlmYWlsOiBrZXlwc2V1ZG8sCiAgICAgIGRlbGVnYXRlOiB7CiAgICAgICAgYWN0aW9uOiBmdW5jdGlvbiAocHNldWRvLCBldmVudCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IHF1ZXJ5KHRoaXMsIHBzZXVkby52YWx1ZSkuZmlsdGVyKGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlID09IGV2ZW50LnRhcmdldCB8fCBub2RlLmNvbnRhaW5zID8gbm9kZS5jb250YWlucyhldmVudC50YXJnZXQpIDogZmFsc2U7CiAgICAgICAgICB9KVswXTsKICAgICAgICAgIHJldHVybiB0YXJnZXQgPyBwc2V1ZG8ubGlzdGVuZXIgPSBwc2V1ZG8ubGlzdGVuZXIuYmluZCh0YXJnZXQpIDogZmFsc2U7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmV2ZW50YWJsZTogewogICAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICAgIHJldHVybiAhZXZlbnQuZGVmYXVsdFByZXZlbnRlZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLyogVVRJTElUSUVTICovCgogICAgY2xvbmU6IGNsb25lLAogICAgdHlwZU9mOiB0eXBlT2YsCiAgICB0b0FycmF5OiB0b0FycmF5LAoKICAgIHdyYXA6IGZ1bmN0aW9uIChvcmlnaW5hbCwgZm4pIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICByZXR1cm5lZCA9IG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHJldHVybiByZXR1cm5lZCA9PT0gZmFsc2UgPyBmYWxzZSA6IGZuLmFwcGx5KHRoaXMsIHR5cGVvZiByZXR1cm5lZCAhPSAndW5kZWZpbmVkJyA/IHRvQXJyYXkocmV0dXJuZWQpIDogYXJncyk7CiAgICAgIH07CiAgICB9LAoKICAgIG1lcmdlOiBmdW5jdGlvbihzb3VyY2UsIGssIHYpewogICAgICBpZiAodHlwZU9mKGspID09ICdzdHJpbmcnKSByZXR1cm4gbWVyZ2VPbmUoc291cmNlLCBrLCB2KTsKICAgICAgZm9yICh2YXIgaSA9IDEsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKICAgICAgICB2YXIgb2JqZWN0ID0gYXJndW1lbnRzW2ldOwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIG1lcmdlT25lKHNvdXJjZSwga2V5LCBvYmplY3Rba2V5XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH0sCgogICAgdWlkOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsMTApOwogICAgfSwKCiAgICAvKiBET00gKi8KCiAgICBxdWVyeTogcXVlcnksCgogICAgc2tpcFRyYW5zaXRpb246IGZ1bmN0aW9uKGVsZW1lbnQsIGZuLCBiaW5kKXsKICAgICAgdmFyIHByb3AgPSBwcmVmaXguanMgKyAnVHJhbnNpdGlvblByb3BlcnR5JzsKICAgICAgZWxlbWVudC5zdHlsZVtwcm9wXSA9IGVsZW1lbnQuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID0gJ25vbmUnOwogICAgICB4dGFnLnJlcXVlc3RGcmFtZShmdW5jdGlvbigpewogICAgICAgIHZhciBjYWxsYmFjazsKICAgICAgICBpZiAoZm4pIGNhbGxiYWNrID0gZm4uY2FsbChiaW5kKTsKICAgICAgICB4dGFnLnJlcXVlc3RGcmFtZShmdW5jdGlvbigpewogICAgICAgICAgZWxlbWVudC5zdHlsZVtwcm9wXSA9IGVsZW1lbnQuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID0gJyc7CiAgICAgICAgICBpZiAoY2FsbGJhY2spIHh0YWcucmVxdWVzdEZyYW1lKGNhbGxiYWNrKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAoKICAgIHJlcXVlc3RGcmFtZTogKGZ1bmN0aW9uKCl7CiAgICAgIHZhciByYWYgPSB3aW4ucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgd2luW3ByZWZpeC5sb3dlcmNhc2UgKyAnUmVxdWVzdEFuaW1hdGlvbkZyYW1lJ10gfHwKICAgICAgICBmdW5jdGlvbihmbil7IHJldHVybiB3aW4uc2V0VGltZW91dChmbiwgMjApOyB9OwogICAgICByZXR1cm4gZnVuY3Rpb24oZm4pewogICAgICAgIHJldHVybiByYWYuY2FsbCh3aW4sIGZuKTsKICAgICAgfTsKICAgIH0pKCksCgogICAgbWF0Y2hTZWxlY3RvcjogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiBtYXRjaFNlbGVjdG9yLmNhbGwoZWxlbWVudCwgc2VsZWN0b3IpOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtZW50LCBtZXRob2QsIHZhbHVlKSB7CiAgICAgIGVsZW1lbnRbbWV0aG9kXSA9IHZhbHVlOwogICAgICBpZiAod2luZG93LkN1c3RvbUVsZW1lbnRzKSBDdXN0b21FbGVtZW50cy51cGdyYWRlQWxsKGVsZW1lbnQpOwogICAgfSwKCiAgICBpbm5lckhUTUw6IGZ1bmN0aW9uKGVsLCBodG1sKXsKICAgICAgeHRhZy5zZXQoZWwsICdpbm5lckhUTUwnLCBodG1sKTsKICAgIH0sCgogICAgaGFzQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICByZXR1cm4gZWxlbWVudC5jbGFzc05hbWUuc3BsaXQoJyAnKS5pbmRleE9mKGtsYXNzLnRyaW0oKSk+LTE7CiAgICB9LAoKICAgIGFkZENsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgdmFyIGxpc3QgPSBlbGVtZW50LmNsYXNzTmFtZS50cmltKCkuc3BsaXQoJyAnKTsKICAgICAga2xhc3MudHJpbSgpLnNwbGl0KCcgJykuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGlmICghfmxpc3QuaW5kZXhPZihuYW1lKSkgbGlzdC5wdXNoKG5hbWUpOwogICAgICB9KTsKICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBsaXN0LmpvaW4oJyAnKS50cmltKCk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfSwKCiAgICByZW1vdmVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHZhciBjbGFzc2VzID0ga2xhc3MudHJpbSgpLnNwbGl0KCcgJyk7CiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gZWxlbWVudC5jbGFzc05hbWUudHJpbSgpLnNwbGl0KCcgJykuZmlsdGVyKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIG5hbWUgJiYgIX5jbGFzc2VzLmluZGV4T2YobmFtZSk7CiAgICAgIH0pLmpvaW4oJyAnKTsKICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICB9LAoKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgcmV0dXJuIHh0YWdbeHRhZy5oYXNDbGFzcyhlbGVtZW50LCBrbGFzcykgPyAncmVtb3ZlQ2xhc3MnIDogJ2FkZENsYXNzJ10uY2FsbChudWxsLCBlbGVtZW50LCBrbGFzcyk7CgogICAgfSwKCiAgICBxdWVyeUNoaWxkcmVuOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgdmFyIGlkID0gZWxlbWVudC5pZCwKICAgICAgICBndWlkID0gZWxlbWVudC5pZCA9IGlkIHx8ICd4XycgKyB4dGFnLnVpZCgpLAogICAgICAgIGF0dHIgPSAnIycgKyBndWlkICsgJyA+ICc7CiAgICAgIHNlbGVjdG9yID0gYXR0ciArIChzZWxlY3RvciArICcnKS5yZXBsYWNlKCcsJywgJywnICsgYXR0ciwgJ2cnKTsKICAgICAgdmFyIHJlc3VsdCA9IGVsZW1lbnQucGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTsKICAgICAgaWYgKCFpZCkgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CiAgICAgIHJldHVybiB0b0FycmF5KHJlc3VsdCk7CiAgICB9LAoKICAgIGNyZWF0ZUZyYWdtZW50OiBmdW5jdGlvbihjb250ZW50KSB7CiAgICAgIHZhciBmcmFnID0gZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgaWYgKGNvbnRlbnQpIHsKICAgICAgICB2YXIgZGl2ID0gZnJhZy5hcHBlbmRDaGlsZChkb2MuY3JlYXRlRWxlbWVudCgnZGl2JykpLAogICAgICAgICAgbm9kZXMgPSB0b0FycmF5KGNvbnRlbnQubm9kZU5hbWUgPyBhcmd1bWVudHMgOiAhKGRpdi5pbm5lckhUTUwgPSBjb250ZW50KSB8fCBkaXYuY2hpbGRyZW4pLAogICAgICAgICAgbGVuZ3RoID0gbm9kZXMubGVuZ3RoLAogICAgICAgICAgaW5kZXggPSAwOwogICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgZnJhZy5pbnNlcnRCZWZvcmUobm9kZXNbaW5kZXgrK10sIGRpdik7CiAgICAgICAgZnJhZy5yZW1vdmVDaGlsZChkaXYpOwogICAgICB9CiAgICAgIHJldHVybiBmcmFnOwogICAgfSwKCiAgICBtYW5pcHVsYXRlOiBmdW5jdGlvbihlbGVtZW50LCBmbil7CiAgICAgIHZhciBuZXh0ID0gZWxlbWVudC5uZXh0U2libGluZywKICAgICAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGUsCiAgICAgICAgZnJhZyA9IGRvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgcmV0dXJuZWQgPSBmbi5jYWxsKGZyYWcuYXBwZW5kQ2hpbGQoZWxlbWVudCksIGZyYWcpIHx8IGVsZW1lbnQ7CiAgICAgIGlmIChuZXh0KSBwYXJlbnQuaW5zZXJ0QmVmb3JlKHJldHVybmVkLCBuZXh0KTsKICAgICAgZWxzZSBwYXJlbnQuYXBwZW5kQ2hpbGQocmV0dXJuZWQpOwogICAgfSwKCiAgICAvKiBQU0VVRE9TICovCgogICAgYXBwbHlQc2V1ZG9zOiBmdW5jdGlvbihrZXksIGZuLCBlbGVtZW50KSB7CiAgICAgIHZhciBsaXN0ZW5lciA9IGZuLAogICAgICAgICAgcHNldWRvcyA9IHt9OwogICAgICBpZiAoa2V5Lm1hdGNoKCc6JykpIHsKICAgICAgICB2YXIgc3BsaXQgPSBrZXkubWF0Y2gocmVnZXhQc2V1ZG9TcGxpdCksCiAgICAgICAgICAgIGkgPSBzcGxpdC5sZW5ndGg7CiAgICAgICAgd2hpbGUgKC0taSkgewogICAgICAgICAgc3BsaXRbaV0ucmVwbGFjZShyZWdleFBzZXVkb1JlcGxhY2UsIGZ1bmN0aW9uIChtYXRjaCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKCF4dGFnLnBzZXVkb3NbbmFtZV0pIHRocm93ICJwc2V1ZG8gbm90IGZvdW5kOiAiICsgbmFtZSArICIgIiArIHNwbGl0OwogICAgICAgICAgICB2YXIgcHNldWRvID0gcHNldWRvc1tpXSA9IE9iamVjdC5jcmVhdGUoeHRhZy5wc2V1ZG9zW25hbWVdKTsKICAgICAgICAgICAgICAgIHBzZXVkby5rZXkgPSBrZXk7CiAgICAgICAgICAgICAgICBwc2V1ZG8ubmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBwc2V1ZG8udmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgdmFyIGxhc3QgPSBsaXN0ZW5lcjsKICAgICAgICAgICAgbGlzdGVuZXIgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgICBvYmogPSB7CiAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXI6IGxhc3QKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZiAocHNldWRvLmFjdGlvbiAmJiBwc2V1ZG8uYWN0aW9uLmFwcGx5KHRoaXMsIFtvYmpdLmNvbmNhdChhcmdzKSkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgcmV0dXJuIG9iai5saXN0ZW5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgJiYgcHNldWRvLm9uQWRkKSB7CiAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKSB7CiAgICAgICAgICAgICAgICBwc2V1ZG8ub25BZGQuY2FsbChlbGVtZW50LCBwc2V1ZG8pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnB1c2gocHNldWRvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKHZhciB6IGluIHBzZXVkb3MpIHsKICAgICAgICBpZiAocHNldWRvc1t6XS5vbkNvbXBpbGVkKSBsaXN0ZW5lciA9IHBzZXVkb3Nbel0ub25Db21waWxlZChsaXN0ZW5lciwgcHNldWRvc1t6XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgfSwKCiAgICByZW1vdmVQc2V1ZG9zOiBmdW5jdGlvbihlbGVtZW50LCBldmVudCl7CiAgICAgIGV2ZW50Ll9wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICBvYmoub25SZW1vdmUuY2FsbChlbGVtZW50LCBvYmopOwogICAgICB9KTsKICAgIH0sCgogIC8qKiogRXZlbnRzICoqKi8KCiAgICBwYXJzZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbikgewogICAgICB2YXIgcHNldWRvcyA9IHR5cGUuc3BsaXQoJzonKSwKICAgICAgICBrZXkgPSBwc2V1ZG9zLnNoaWZ0KCksCiAgICAgICAgZXZlbnQgPSB4dGFnLm1lcmdlKHsKICAgICAgICAgIGJhc2U6IGtleSwKICAgICAgICAgIHBzZXVkb3M6ICcnLAogICAgICAgICAgX3BzZXVkb3M6IFtdLAogICAgICAgICAgb25BZGQ6IG5vb3AsCiAgICAgICAgICBvblJlbW92ZTogbm9vcCwKICAgICAgICAgIGNvbmRpdGlvbjogbm9vcAogICAgICAgIH0sIHh0YWcuY3VzdG9tRXZlbnRzW2tleV0gfHwge30pOwogICAgICBldmVudC50eXBlID0ga2V5ICsgKGV2ZW50LnBzZXVkb3MubGVuZ3RoID8gJzonICsgZXZlbnQucHNldWRvcyA6ICcnKSArIChwc2V1ZG9zLmxlbmd0aCA/ICc6JyArIHBzZXVkb3Muam9pbignOicpIDogJycpOwogICAgICBpZiAoZm4pIHsKICAgICAgICB2YXIgY2hhaW5lZCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGV2ZW50LnR5cGUsIGZuLCBldmVudC5fcHNldWRvcyk7CiAgICAgICAgZXZlbnQubGlzdGVuZXIgPSBmdW5jdGlvbigpewogICAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoZXZlbnQuY29uZGl0aW9uLmFwcGx5KHRoaXMsIFtldmVudF0uY29uY2F0KGFyZ3MpKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsKICAgICAgICAgIHJldHVybiBjaGFpbmVkLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50OwogICAgfSwKCiAgICBhZGRFdmVudDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgIHZhciBldmVudCA9ICh0eXBlb2YgZm4gPT0gJ2Z1bmN0aW9uJykgPyB4dGFnLnBhcnNlRXZlbnQodHlwZSwgZm4pIDogZm47CiAgICAgIGV2ZW50Lmxpc3RlbmVyLmV2ZW50ID0gZXZlbnQ7CiAgICAgIGV2ZW50Ll9wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICBvYmoub25BZGQuY2FsbChlbGVtZW50LCBvYmopOwogICAgICB9KTsKICAgICAgZXZlbnQub25BZGQuY2FsbChlbGVtZW50LCBldmVudCwgZXZlbnQubGlzdGVuZXIpOwogICAgICB0b0FycmF5KGV2ZW50LmJhc2UpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIobmFtZSwgZXZlbnQubGlzdGVuZXIsIHh0YWcuY2FwdHVyZUV2ZW50cy5pbmRleE9mKG5hbWUpID4gLTEpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGV2ZW50Lmxpc3RlbmVyOwogICAgfSwKCiAgICBhZGRFdmVudHM6IGZ1bmN0aW9uIChlbGVtZW50LCBldmVudHMpIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHt9OwogICAgICBmb3IgKHZhciB6IGluIGV2ZW50cykgewogICAgICAgIGxpc3RlbmVyc1t6XSA9IHh0YWcuYWRkRXZlbnQoZWxlbWVudCwgeiwgZXZlbnRzW3pdKTsKICAgICAgfQogICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgfSwKCiAgICByZW1vdmVFdmVudDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgIHZhciBldmVudCA9IGZuLmV2ZW50OwogICAgICBldmVudC5vblJlbW92ZS5jYWxsKGVsZW1lbnQsIGV2ZW50LCBmbik7CiAgICAgIHh0YWcucmVtb3ZlUHNldWRvcyhlbGVtZW50LCBldmVudCk7CiAgICAgIHRvQXJyYXkoZXZlbnQuYmFzZSkuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihuYW1lLCBmbik7CiAgICAgIH0pOwogICAgfSwKCiAgICByZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGVsZW1lbnQsIGxpc3RlbmVycyl7CiAgICAgIGZvciAodmFyIHogaW4gbGlzdGVuZXJzKSB4dGFnLnJlbW92ZUV2ZW50KGVsZW1lbnQsIHosIGxpc3RlbmVyc1t6XSk7CiAgICB9LAoKICAgIGZpcmVFdmVudDogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZGF0YSwgb3B0aW9ucyl7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICB2YXIgZXZlbnQgPSBkb2MuY3JlYXRlRXZlbnQoJ0V2ZW50Jyk7CiAgICAgIGV2ZW50LmluaXRFdmVudCh0eXBlLCAnYnViYmxlcycgaW4gb3B0aW9ucyA/IG9wdGlvbnMuYnViYmxlcyA6IHRydWUsICdjYW5jZWxhYmxlJyBpbiBvcHRpb25zID8gb3B0aW9ucy5jYW5jZWxhYmxlIDogdHJ1ZSk7CiAgICAgIGZvciAodmFyIHogaW4gZGF0YSkgZXZlbnRbel0gPSBkYXRhW3pdOwogICAgICBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgfSwKCiAgICBhZGRPYnNlcnZlcjogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pewogICAgICBpZiAoIWVsZW1lbnQuX3JlY29yZHMpIHsKICAgICAgICBlbGVtZW50Ll9yZWNvcmRzID0geyBpbnNlcnRlZDogW10sIHJlbW92ZWQ6IFtdIH07CiAgICAgICAgaWYgKG11dGF0aW9uKXsKICAgICAgICAgIGVsZW1lbnQuX29ic2VydmVyID0gbmV3IG11dGF0aW9uKGZ1bmN0aW9uKG11dGF0aW9ucykgewogICAgICAgICAgICBwYXJzZU11dGF0aW9ucyhlbGVtZW50LCBtdXRhdGlvbnMpOwogICAgICAgICAgfSk7CiAgICAgICAgICBlbGVtZW50Ll9vYnNlcnZlci5vYnNlcnZlKGVsZW1lbnQsIHsKICAgICAgICAgICAgc3VidHJlZTogdHJ1ZSwKICAgICAgICAgICAgY2hpbGRMaXN0OiB0cnVlLAogICAgICAgICAgICBhdHRyaWJ1dGVzOiAhdHJ1ZSwKICAgICAgICAgICAgY2hhcmFjdGVyRGF0YTogZmFsc2UKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlIFsnSW5zZXJ0ZWQnLCAnUmVtb3ZlZCddLmZvckVhY2goZnVuY3Rpb24odHlwZSl7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGUnICsgdHlwZSwgZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgICBldmVudC5fbXV0YXRpb24gPSB0cnVlOwogICAgICAgICAgICBlbGVtZW50Ll9yZWNvcmRzW3R5cGUudG9Mb3dlckNhc2UoKV0uZm9yRWFjaChmdW5jdGlvbihmbil7CiAgICAgICAgICAgICAgZm4oZXZlbnQudGFyZ2V0LCBldmVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChlbGVtZW50Ll9yZWNvcmRzW3R5cGVdLmluZGV4T2YoZm4pID09IC0xKSBlbGVtZW50Ll9yZWNvcmRzW3R5cGVdLnB1c2goZm4pOwogICAgfSwKCiAgICByZW1vdmVPYnNlcnZlcjogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pewogICAgICB2YXIgb2JqID0gZWxlbWVudC5fcmVjb3JkczsKICAgICAgaWYgKG9iaiAmJiBmbil7CiAgICAgICAgb2JqW3R5cGVdLnNwbGljZShvYmpbdHlwZV0uaW5kZXhPZihmbiksIDEpOwogICAgICB9CiAgICAgIGVsc2V7CiAgICAgICAgb2JqW3R5cGVdID0gW107CiAgICAgIH0KICAgIH0KCiAgfTsKCiAgaWYgKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSBkZWZpbmUoeHRhZyk7CiAgZWxzZSB3aW4ueHRhZyA9IHh0YWc7CgogIGRvYy5hZGRFdmVudExpc3RlbmVyKCdXZWJDb21wb25lbnRzUmVhZHknLCBmdW5jdGlvbigpewogICAgeHRhZy5maXJlRXZlbnQoZG9jLmJvZHksICdET01Db21wb25lbnRzTG9hZGVkJyk7CiAgfSk7Cgp9KSgpOwooZnVuY3Rpb24oKXsKCnZhciBoZWFkID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaGVhZCcpOwp2YXIgYW5jaG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwphbmNob3IuaHJlZiA9ICcnOwp4dGFnLmNhbGxiYWNrcyA9IHt9OwoKICBmdW5jdGlvbiByZXF1ZXN0KGVsZW1lbnQsIG9wdGlvbnMpewogICAgY2xlYXJSZXF1ZXN0KGVsZW1lbnQpOwogICAgdmFyIGxhc3QgPSBlbGVtZW50Lnh0YWcucmVxdWVzdCB8fCB7fTsKICAgIGVsZW1lbnQueHRhZy5yZXF1ZXN0ID0gb3B0aW9uczsKICAgIHZhciByZXF1ZXN0ID0gZWxlbWVudC54dGFnLnJlcXVlc3QsCiAgICAgIGNhbGxiYWNrS2V5ID0gKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdkYXRhLWNhbGxiYWNrLWtleScpIHx8CiAgICAgICAgJ2NhbGxiYWNrJykgKyAnPXh0YWcuY2FsbGJhY2tzLic7CiAgICBpZiAoeHRhZy5maXJlRXZlbnQoZWxlbWVudCwgJ2JlZm9yZXJlcXVlc3QnKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsKICAgIGlmIChsYXN0LnVybCAmJiAhb3B0aW9ucy51cGRhdGUgJiYKICAgICAgbGFzdC51cmwucmVwbGFjZShuZXcgUmVnRXhwKCdcJj9cKCcgKyBjYWxsYmFja0tleSArICd4WzAtOV0rKScpLCAnJykgPT0KICAgICAgICBlbGVtZW50Lnh0YWcucmVxdWVzdC51cmwpewogICAgICBlbGVtZW50Lnh0YWcucmVxdWVzdCA9IGxhc3Q7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdzcmMnLCBlbGVtZW50Lnh0YWcucmVxdWVzdC51cmwpOwogICAgYW5jaG9yLmhyZWYgPSBvcHRpb25zLnVybDsKICAgIGlmIChhbmNob3IuaG9zdG5hbWUgPT0gd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lKSB7CiAgICAgIHJlcXVlc3QgPSB4dGFnLm1lcmdlKG5ldyBYTUxIdHRwUmVxdWVzdCgpLCByZXF1ZXN0KTsKICAgICAgcmVxdWVzdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpewogICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdkYXRhLXJlYWR5c3RhdGUnLCByZXF1ZXN0LnJlYWR5U3RhdGUpOwogICAgICAgIGlmIChyZXF1ZXN0LnJlYWR5U3RhdGUgPT0gNCAmJiByZXF1ZXN0LnN0YXR1cyA8IDQwMCl7CiAgICAgICAgICByZXF1ZXN0Q2FsbGJhY2soZWxlbWVudCwgcmVxdWVzdCk7CiAgICAgICAgfQogICAgICB9OwogICAgICBbJ2Vycm9yJywgJ2Fib3J0JywgJ2xvYWQnXS5mb3JFYWNoKGZ1bmN0aW9uKHR5cGUpewogICAgICAgIHJlcXVlc3RbJ29uJyArIHR5cGVdID0gZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgZXZlbnQucmVxdWVzdCA9IHJlcXVlc3Q7CiAgICAgICAgICB4dGFnLmZpcmVFdmVudChlbGVtZW50LCB0eXBlLCBldmVudCk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmVxdWVzdC5vcGVuKHJlcXVlc3QubWV0aG9kICwgcmVxdWVzdC51cmwsIHRydWUpOwogICAgICByZXF1ZXN0LnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtVHlwZScsCiAgICAgICAgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpOwogICAgICByZXF1ZXN0LnNlbmQoKTsKICAgIH0KICAgIGVsc2UgewogICAgICB2YXIgY2FsbGJhY2tJRCA9IHJlcXVlc3QuY2FsbGJhY2tJRCA9ICd4JyArIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnZGF0YS1yZWFkeXN0YXRlJywgcmVxdWVzdC5yZWFkeVN0YXRlID0gMCk7CiAgICAgIHh0YWcuY2FsbGJhY2tzW2NhbGxiYWNrSURdID0gZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgcmVxdWVzdC5zdGF0dXMgPSAyMDA7CiAgICAgICAgcmVxdWVzdC5yZWFkeVN0YXRlID0gNDsKICAgICAgICByZXF1ZXN0LnJlc3BvbnNlVGV4dCA9IGRhdGE7CiAgICAgICAgcmVxdWVzdENhbGxiYWNrKGVsZW1lbnQsIHJlcXVlc3QpOwogICAgICAgIGRlbGV0ZSB4dGFnLmNhbGxiYWNrc1tjYWxsYmFja0lEXTsKICAgICAgICBjbGVhclJlcXVlc3QoZWxlbWVudCk7CiAgICAgIH0KICAgICAgcmVxdWVzdC5zY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKICAgICAgcmVxdWVzdC5zY3JpcHQudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnOwogICAgICByZXF1ZXN0LnNjcmlwdC5zcmMgPSBvcHRpb25zLnVybCA9IG9wdGlvbnMudXJsICsKICAgICAgICAofm9wdGlvbnMudXJsLmluZGV4T2YoJz8nKSA/ICcmJyA6ICc/JykgKyBjYWxsYmFja0tleSArIGNhbGxiYWNrSUQ7CiAgICAgIHJlcXVlc3Quc2NyaXB0Lm9uZXJyb3IgPSBmdW5jdGlvbihlcnJvcil7CiAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2RhdGEtcmVhZHlzdGF0ZScsIHJlcXVlc3QucmVhZHlTdGF0ZSA9IDQpOwogICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdkYXRhLXJlcXVlc3RzdGF0dXMnLCByZXF1ZXN0LnN0YXR1cyA9IDQwMCk7CiAgICAgICAgeHRhZy5maXJlRXZlbnQoZWxlbWVudCwgJ2Vycm9yJywgZXJyb3IpOwogICAgICB9CiAgICAgIGhlYWQuYXBwZW5kQ2hpbGQocmVxdWVzdC5zY3JpcHQpOwogICAgfQogICAgZWxlbWVudC54dGFnLnJlcXVlc3QgPSByZXF1ZXN0OwogIH0KCiAgZnVuY3Rpb24gcmVxdWVzdENhbGxiYWNrKGVsZW1lbnQsIHJlcXVlc3QpewogICAgaWYgKHJlcXVlc3QgIT0gZWxlbWVudC54dGFnLnJlcXVlc3QpIHJldHVybiB4dGFnOwogICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2RhdGEtcmVhZHlzdGF0ZScsIHJlcXVlc3QucmVhZHlTdGF0ZSk7CiAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnZGF0YS1yZXF1ZXN0c3RhdHVzJywgcmVxdWVzdC5zdGF0dXMpOwogICAgeHRhZy5maXJlRXZlbnQoZWxlbWVudCwgJ2RhdGFyZWFkeScsIHsgcmVxdWVzdDogcmVxdWVzdCB9KTsKICAgIGlmIChlbGVtZW50LmRhdGFyZWFkeSkgZWxlbWVudC5kYXRhcmVhZHkuY2FsbChlbGVtZW50LCByZXF1ZXN0KTsKICB9CgogIGZ1bmN0aW9uIGNsZWFyUmVxdWVzdChlbGVtZW50KXsKICAgIHZhciByZXEgPSBlbGVtZW50Lnh0YWcucmVxdWVzdDsKICAgIGlmICghcmVxKSByZXR1cm4geHRhZzsKICAgIGlmIChyZXEuc2NyaXB0ICYmIH54dGFnLnRvQXJyYXkoaGVhZC5jaGlsZHJlbikuaW5kZXhPZihyZXEuc2NyaXB0KSkgewogICAgICBoZWFkLnJlbW92ZUNoaWxkKHJlcS5zY3JpcHQpOwogICAgfQogICAgZWxzZSBpZiAocmVxLmFib3J0KSByZXEuYWJvcnQoKTsKICB9CgoKICB4dGFnLm1peGluc1sncmVxdWVzdCddID0gewogICAgbGlmZWN5Y2xlOnsKICAgICAgY3JlYXRlZDogIGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zcmMgPSB0aGlzLmdldEF0dHJpYnV0ZSgnc3JjJyk7CiAgICAgIH0KICAgIH0sCiAgICBhY2Nlc3NvcnM6ewogICAgICBkYXRhcmVhZHk6ewogICAgICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgICAgIHJldHVybiB0aGlzLnh0YWcuZGF0YXJlYWR5OwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbihmbil7CiAgICAgICAgICB0aGlzLnh0YWcuZGF0YXJlYWR5ID0gZm47CiAgICAgICAgfQogICAgICB9LAogICAgICBzcmM6ewogICAgICAgIHNldDogZnVuY3Rpb24oc3JjKXsKICAgICAgICAgIGlmIChzcmMpewogICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgnc3JjJywgc3JjKTsKICAgICAgICAgICAgcmVxdWVzdCh0aGlzLCB7IHVybDogc3JjLCBtZXRob2Q6ICdHRVQnIH0pOwogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZ2V0OiBmdW5jdGlvbigpewogICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QXR0cmlidXRlKCdzcmMnKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKfSkoKTs=",
                "body": "Ly8gV2UgZG9uJ3QgdXNlIHRoZSBwbGF0Zm9ybSBib290c3RyYXBwZXIsIHNvIGZha2UgdGhpcyBzdHVmZi4KCndpbmRvdy5QbGF0Zm9ybSA9IHt9Owp2YXIgbG9nRmxhZ3MgPSB7fTsKCgoKLy8gRE9NVG9rZW5MaXN0IHBvbHlmaWxsIGZpciBJRTkKKGZ1bmN0aW9uICgpIHsKCmlmICh0eXBlb2Ygd2luZG93LkVsZW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8ICJjbGFzc0xpc3QiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgcmV0dXJuOwoKdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKICAgIGluZGV4T2YgPSBwcm90b3R5cGUuaW5kZXhPZiwKICAgIHNsaWNlID0gcHJvdG90eXBlLnNsaWNlLAogICAgcHVzaCA9IHByb3RvdHlwZS5wdXNoLAogICAgc3BsaWNlID0gcHJvdG90eXBlLnNwbGljZSwKICAgIGpvaW4gPSBwcm90b3R5cGUuam9pbjsKCmZ1bmN0aW9uIERPTVRva2VuTGlzdChlbCkgewogIHRoaXMuX2VsZW1lbnQgPSBlbDsKICBpZiAoZWwuY2xhc3NOYW1lICE9IHRoaXMuX2NsYXNzQ2FjaGUpIHsKICAgIHRoaXMuX2NsYXNzQ2FjaGUgPSBlbC5jbGFzc05hbWU7CgogICAgaWYgKCF0aGlzLl9jbGFzc0NhY2hlKSByZXR1cm47CgogICAgICAvLyBUaGUgY2xhc3NOYW1lIG5lZWRzIHRvIGJlIHRyaW1tZWQgYW5kIHNwbGl0IG9uIHdoaXRlc3BhY2UKICAgICAgLy8gdG8gcmV0cmlldmUgYSBsaXN0IG9mIGNsYXNzZXMuCiAgICAgIHZhciBjbGFzc2VzID0gdGhpcy5fY2xhc3NDYWNoZS5yZXBsYWNlKC9eXHMrfFxzKyQvZywnJykuc3BsaXQoL1xzKy8pLAogICAgICAgIGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKykgewogICAgICBwdXNoLmNhbGwodGhpcywgY2xhc3Nlc1tpXSk7CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gc2V0VG9DbGFzc05hbWUoZWwsIGNsYXNzZXMpIHsKICBlbC5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTsKfQoKRE9NVG9rZW5MaXN0LnByb3RvdHlwZSA9IHsKICBhZGQ6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICBpZih0aGlzLmNvbnRhaW5zKHRva2VuKSkgcmV0dXJuOwogICAgcHVzaC5jYWxsKHRoaXMsIHRva2VuKTsKICAgIHNldFRvQ2xhc3NOYW1lKHRoaXMuX2VsZW1lbnQsIHNsaWNlLmNhbGwodGhpcywgMCkpOwogIH0sCiAgY29udGFpbnM6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICByZXR1cm4gaW5kZXhPZi5jYWxsKHRoaXMsIHRva2VuKSAhPT0gLTE7CiAgfSwKICBpdGVtOiBmdW5jdGlvbihpbmRleCkgewogICAgcmV0dXJuIHRoaXNbaW5kZXhdIHx8IG51bGw7CiAgfSwKICByZW1vdmU6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICB2YXIgaSA9IGluZGV4T2YuY2FsbCh0aGlzLCB0b2tlbik7CiAgICAgaWYgKGkgPT09IC0xKSB7CiAgICAgICByZXR1cm47CiAgICAgfQogICAgc3BsaWNlLmNhbGwodGhpcywgaSwgMSk7CiAgICBzZXRUb0NsYXNzTmFtZSh0aGlzLl9lbGVtZW50LCBzbGljZS5jYWxsKHRoaXMsIDApKTsKICB9LAogIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBqb2luLmNhbGwodGhpcywgJyAnKTsKICB9LAogIHRvZ2dsZTogZnVuY3Rpb24odG9rZW4pIHsKICAgIGlmIChpbmRleE9mLmNhbGwodGhpcywgdG9rZW4pID09PSAtMSkgewogICAgICB0aGlzLmFkZCh0b2tlbik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnJlbW92ZSh0b2tlbik7CiAgICB9CiAgfQp9OwoKd2luZG93LkRPTVRva2VuTGlzdCA9IERPTVRva2VuTGlzdDsKCmZ1bmN0aW9uIGRlZmluZUVsZW1lbnRHZXR0ZXIgKG9iaiwgcHJvcCwgZ2V0dGVyKSB7CiAgaWYgKE9iamVjdC5kZWZpbmVQcm9wZXJ0eSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgcHJvcCx7CiAgICAgIGdldCA6IGdldHRlcgogICAgfSkKICB9IGVsc2UgewogICAgb2JqLl9fZGVmaW5lR2V0dGVyX18ocHJvcCwgZ2V0dGVyKTsKICB9Cn0KCmRlZmluZUVsZW1lbnRHZXR0ZXIoRWxlbWVudC5wcm90b3R5cGUsICdjbGFzc0xpc3QnLCBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIG5ldyBET01Ub2tlbkxpc3QodGhpcyk7Cn0pOwoKfSkoKTsKCgovKgogKiBDb3B5cmlnaHQgMjAxMiBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3ZlcmVuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8vIFNpZGVUYWJsZSBpcyBhIHdlYWsgbWFwIHdoZXJlIHBvc3NpYmxlLiBJZiBXZWFrTWFwIGlzIG5vdCBhdmFpbGFibGUgdGhlCi8vIGFzc29jaWF0aW9uIGlzIHN0b3JlZCBhcyBhbiBleHBhbmRvIHByb3BlcnR5Lgp2YXIgU2lkZVRhYmxlOwovLyBUT0RPKGFydik6IFdlYWtNYXAgZG9lcyBub3QgYWxsb3cgZm9yIE5vZGUgZXRjIHRvIGJlIGtleXMgaW4gRmlyZWZveAppZiAodHlwZW9mIFdlYWtNYXAgIT09ICd1bmRlZmluZWQnICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignRmlyZWZveC8nKSA8IDApIHsKICBTaWRlVGFibGUgPSBXZWFrTWFwOwp9IGVsc2UgewogIChmdW5jdGlvbigpIHsKICAgIHZhciBkZWZpbmVQcm9wZXJ0eSA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5oYXNPd25Qcm9wZXJ0eTsKICAgIHZhciBjb3VudGVyID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgJSAxZTk7CgogICAgU2lkZVRhYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubmFtZSA9ICdfX3N0JyArIChNYXRoLnJhbmRvbSgpICogMWU5ID4+PiAwKSArIChjb3VudGVyKysgKyAnX18nKTsKICAgIH07CgogICAgU2lkZVRhYmxlLnByb3RvdHlwZSA9IHsKICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgZGVmaW5lUHJvcGVydHkoa2V5LCB0aGlzLm5hbWUsIHt2YWx1ZTogdmFsdWUsIHdyaXRhYmxlOiB0cnVlfSk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwoa2V5LCB0aGlzLm5hbWUpID8ga2V5W3RoaXMubmFtZV0gOiB1bmRlZmluZWQ7CiAgICAgIH0sCiAgICAgIGRlbGV0ZTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgdGhpcy5zZXQoa2V5LCB1bmRlZmluZWQpOwogICAgICB9CiAgICB9CiAgfSkoKTsKfQoKLyoKICogQ29weXJpZ2h0IDIwMTIgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJlbmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oZ2xvYmFsKSB7CgogIHZhciByZWdpc3RyYXRpb25zVGFibGUgPSBuZXcgU2lkZVRhYmxlKCk7CgogIC8vIFdlIHVzZSBzZXRJbW1lZGlhdGUgb3IgcG9zdE1lc3NhZ2UgZm9yIG91ciBmdXR1cmUgY2FsbGJhY2suCiAgdmFyIHNldEltbWVkaWF0ZSA9IHdpbmRvdy5tc1NldEltbWVkaWF0ZTsKCiAgLy8gVXNlIHBvc3QgbWVzc2FnZSB0byBlbXVsYXRlIHNldEltbWVkaWF0ZS4KICBpZiAoIXNldEltbWVkaWF0ZSkgewogICAgdmFyIHNldEltbWVkaWF0ZVF1ZXVlID0gW107CiAgICB2YXIgc2VudGluZWwgPSBTdHJpbmcoTWF0aC5yYW5kb20oKSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKGUuZGF0YSA9PT0gc2VudGluZWwpIHsKICAgICAgICB2YXIgcXVldWUgPSBzZXRJbW1lZGlhdGVRdWV1ZTsKICAgICAgICBzZXRJbW1lZGlhdGVRdWV1ZSA9IFtdOwogICAgICAgIHF1ZXVlLmZvckVhY2goZnVuY3Rpb24oZnVuYykgewogICAgICAgICAgZnVuYygpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIHNldEltbWVkaWF0ZSA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgc2V0SW1tZWRpYXRlUXVldWUucHVzaChmdW5jKTsKICAgICAgd2luZG93LnBvc3RNZXNzYWdlKHNlbnRpbmVsLCAnKicpOwogICAgfTsKICB9CgogIC8vIFRoaXMgaXMgdXNlZCB0byBlbnN1cmUgdGhhdCB3ZSBuZXZlciBzY2hlZHVsZSAyIGNhbGxhcyB0byBzZXRJbW1lZGlhdGUKICB2YXIgaXNTY2hlZHVsZWQgPSBmYWxzZTsKCiAgLy8gS2VlcCB0cmFjayBvZiBvYnNlcnZlcnMgdGhhdCBuZWVkcyB0byBiZSBub3RpZmllZCBuZXh0IHRpbWUuCiAgdmFyIHNjaGVkdWxlZE9ic2VydmVycyA9IFtdOwoKICAvKioKICAgKiBTY2hlZHVsZXMgfGRpc3BhdGNoQ2FsbGJhY2t8IHRvIGJlIGNhbGxlZCBpbiB0aGUgZnV0dXJlLgogICAqIEBwYXJhbSB7TXV0YXRpb25PYnNlcnZlcn0gb2JzZXJ2ZXIKICAgKi8KICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrKG9ic2VydmVyKSB7CiAgICBzY2hlZHVsZWRPYnNlcnZlcnMucHVzaChvYnNlcnZlcik7CiAgICBpZiAoIWlzU2NoZWR1bGVkKSB7CiAgICAgIGlzU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgc2V0SW1tZWRpYXRlKGRpc3BhdGNoQ2FsbGJhY2tzKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHdyYXBJZk5lZWRlZChub2RlKSB7CiAgICByZXR1cm4gd2luZG93LlNoYWRvd0RPTVBvbHlmaWxsICYmCiAgICAgICAgd2luZG93LlNoYWRvd0RPTVBvbHlmaWxsLndyYXBJZk5lZWRlZChub2RlKSB8fAogICAgICAgIG5vZGU7CiAgfQoKICBmdW5jdGlvbiBkaXNwYXRjaENhbGxiYWNrcygpIHsKICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNtdXRhdGlvbi1vYnNlcnZlcnMKCiAgICBpc1NjaGVkdWxlZCA9IGZhbHNlOyAvLyBVc2VkIHRvIGFsbG93IGEgbmV3IHNldEltbWVkaWF0ZSBjYWxsIGFib3ZlLgoKICAgIHZhciBvYnNlcnZlcnMgPSBzY2hlZHVsZWRPYnNlcnZlcnM7CiAgICBzY2hlZHVsZWRPYnNlcnZlcnMgPSBbXTsKICAgIC8vIFNvcnQgb2JzZXJ2ZXJzIGJhc2VkIG9uIHRoZWlyIGNyZWF0aW9uIFVJRCAoaW5jcmVtZW50YWwpLgogICAgb2JzZXJ2ZXJzLnNvcnQoZnVuY3Rpb24obzEsIG8yKSB7CiAgICAgIHJldHVybiBvMS51aWRfIC0gbzIudWlkXzsKICAgIH0pOwoKICAgIHZhciBhbnlOb25FbXB0eSA9IGZhbHNlOwogICAgb2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24ob2JzZXJ2ZXIpIHsKCiAgICAgIC8vIDIuMSwgMi4yCiAgICAgIHZhciBxdWV1ZSA9IG9ic2VydmVyLnRha2VSZWNvcmRzKCk7CiAgICAgIC8vIDIuMy4gUmVtb3ZlIGFsbCB0cmFuc2llbnQgcmVnaXN0ZXJlZCBvYnNlcnZlcnMgd2hvc2Ugb2JzZXJ2ZXIgaXMgbW8uCiAgICAgIHJlbW92ZVRyYW5zaWVudE9ic2VydmVyc0ZvcihvYnNlcnZlcik7CgogICAgICAvLyAyLjQKICAgICAgaWYgKHF1ZXVlLmxlbmd0aCkgewogICAgICAgIG9ic2VydmVyLmNhbGxiYWNrXyhxdWV1ZSwgb2JzZXJ2ZXIpOwogICAgICAgIGFueU5vbkVtcHR5ID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CgogICAgLy8gMy4KICAgIGlmIChhbnlOb25FbXB0eSkKICAgICAgZGlzcGF0Y2hDYWxsYmFja3MoKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZVRyYW5zaWVudE9ic2VydmVyc0ZvcihvYnNlcnZlcikgewogICAgb2JzZXJ2ZXIubm9kZXNfLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgIGlmICghcmVnaXN0cmF0aW9ucykKICAgICAgICByZXR1cm47CiAgICAgIHJlZ2lzdHJhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihyZWdpc3RyYXRpb24pIHsKICAgICAgICBpZiAocmVnaXN0cmF0aW9uLm9ic2VydmVyID09PSBvYnNlcnZlcikKICAgICAgICAgIHJlZ2lzdHJhdGlvbi5yZW1vdmVUcmFuc2llbnRPYnNlcnZlcnMoKTsKICAgICAgfSk7CiAgICB9KTsKICB9CgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgdGhlICJGb3IgZWFjaCByZWdpc3RlcmVkIG9ic2VydmVyIG9ic2VydmVyICh3aXRoCiAgICogb2JzZXJ2ZXIncyBvcHRpb25zIGFzIG9wdGlvbnMpIGluIHRhcmdldCdzIGxpc3Qgb2YgcmVnaXN0ZXJlZCBvYnNlcnZlcnMsCiAgICogcnVuIHRoZXNlIHN1YnN0ZXBzOiIgYW5kIHRoZSAiRm9yIGVhY2ggYW5jZXN0b3IgYW5jZXN0b3Igb2YgdGFyZ2V0LCBhbmQgZm9yCiAgICogZWFjaCByZWdpc3RlcmVkIG9ic2VydmVyIG9ic2VydmVyICh3aXRoIG9wdGlvbnMgb3B0aW9ucykgaW4gYW5jZXN0b3IncyBsaXN0CiAgICogb2YgcmVnaXN0ZXJlZCBvYnNlcnZlcnMsIHJ1biB0aGVzZSBzdWJzdGVwczoiIHBhcnQgb2YgdGhlIGFsZ29yaXRobXMuIFRoZQogICAqIHxvcHRpb25zLnN1YnRyZWV8IGlzIGNoZWNrZWQgdG8gZW5zdXJlIHRoYXQgdGhlIGNhbGxiYWNrIGlzIGNhbGxlZAogICAqIGNvcnJlY3RseS4KICAgKgogICAqIEBwYXJhbSB7Tm9kZX0gdGFyZ2V0CiAgICogQHBhcmFtIHtmdW5jdGlvbihNdXRhdGlvbk9ic2VydmVySW5pdCk6TXV0YXRpb25SZWNvcmR9IGNhbGxiYWNrCiAgICovCiAgZnVuY3Rpb24gZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgY2FsbGJhY2spIHsKICAgIGZvciAodmFyIG5vZGUgPSB0YXJnZXQ7IG5vZGU7IG5vZGUgPSBub2RlLnBhcmVudE5vZGUpIHsKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwoKICAgICAgaWYgKHJlZ2lzdHJhdGlvbnMpIHsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHZhciByZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25zW2pdOwogICAgICAgICAgdmFyIG9wdGlvbnMgPSByZWdpc3RyYXRpb24ub3B0aW9uczsKCiAgICAgICAgICAvLyBPbmx5IHRhcmdldCBpZ25vcmVzIHN1YnRyZWUuCiAgICAgICAgICBpZiAobm9kZSAhPT0gdGFyZ2V0ICYmICFvcHRpb25zLnN1YnRyZWUpCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIHZhciByZWNvcmQgPSBjYWxsYmFjayhvcHRpb25zKTsKICAgICAgICAgIGlmIChyZWNvcmQpCiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbi5lbnF1ZXVlKHJlY29yZCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICB2YXIgdWlkQ291bnRlciA9IDA7CgogIC8qKgogICAqIFRoZSBjbGFzcyB0aGF0IG1hcHMgdG8gdGhlIERPTSBNdXRhdGlvbk9ic2VydmVyIGludGVyZmFjZS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjay4KICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBKc011dGF0aW9uT2JzZXJ2ZXIoY2FsbGJhY2spIHsKICAgIHRoaXMuY2FsbGJhY2tfID0gY2FsbGJhY2s7CiAgICB0aGlzLm5vZGVzXyA9IFtdOwogICAgdGhpcy5yZWNvcmRzXyA9IFtdOwogICAgdGhpcy51aWRfID0gKyt1aWRDb3VudGVyOwogIH0KCiAgSnNNdXRhdGlvbk9ic2VydmVyLnByb3RvdHlwZSA9IHsKICAgIG9ic2VydmU6IGZ1bmN0aW9uKHRhcmdldCwgb3B0aW9ucykgewogICAgICB0YXJnZXQgPSB3cmFwSWZOZWVkZWQodGFyZ2V0KTsKCiAgICAgIC8vIDEuMQogICAgICBpZiAoIW9wdGlvbnMuY2hpbGRMaXN0ICYmICFvcHRpb25zLmF0dHJpYnV0ZXMgJiYgIW9wdGlvbnMuY2hhcmFjdGVyRGF0YSB8fAoKICAgICAgICAgIC8vIDEuMgogICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVPbGRWYWx1ZSAmJiAhb3B0aW9ucy5hdHRyaWJ1dGVzIHx8CgogICAgICAgICAgLy8gMS4zCiAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlciAmJiBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5sZW5ndGggJiYKICAgICAgICAgICAgICAhb3B0aW9ucy5hdHRyaWJ1dGVzIHx8CgogICAgICAgICAgLy8gMS40CiAgICAgICAgICBvcHRpb25zLmNoYXJhY3RlckRhdGFPbGRWYWx1ZSAmJiAhb3B0aW9ucy5jaGFyYWN0ZXJEYXRhKSB7CgogICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcigpOwogICAgICB9CgogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQodGFyZ2V0KTsKICAgICAgaWYgKCFyZWdpc3RyYXRpb25zKQogICAgICAgIHJlZ2lzdHJhdGlvbnNUYWJsZS5zZXQodGFyZ2V0LCByZWdpc3RyYXRpb25zID0gW10pOwoKICAgICAgLy8gMgogICAgICAvLyBJZiB0YXJnZXQncyBsaXN0IG9mIHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzIGFscmVhZHkgaW5jbHVkZXMgYSByZWdpc3RlcmVkCiAgICAgIC8vIG9ic2VydmVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgY29udGV4dCBvYmplY3QsIHJlcGxhY2UgdGhhdCByZWdpc3RlcmVkCiAgICAgIC8vIG9ic2VydmVyJ3Mgb3B0aW9ucyB3aXRoIG9wdGlvbnMuCiAgICAgIHZhciByZWdpc3RyYXRpb247CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChyZWdpc3RyYXRpb25zW2ldLm9ic2VydmVyID09PSB0aGlzKSB7CiAgICAgICAgICByZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25zW2ldOwogICAgICAgICAgcmVnaXN0cmF0aW9uLnJlbW92ZUxpc3RlbmVycygpOwogICAgICAgICAgcmVnaXN0cmF0aW9uLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyAzLgogICAgICAvLyBPdGhlcndpc2UsIGFkZCBhIG5ldyByZWdpc3RlcmVkIG9ic2VydmVyIHRvIHRhcmdldCdzIGxpc3Qgb2YgcmVnaXN0ZXJlZAogICAgICAvLyBvYnNlcnZlcnMgd2l0aCB0aGUgY29udGV4dCBvYmplY3QgYXMgdGhlIG9ic2VydmVyIGFuZCBvcHRpb25zIGFzIHRoZQogICAgICAvLyBvcHRpb25zLCBhbmQgYWRkIHRhcmdldCB0byBjb250ZXh0IG9iamVjdCdzIGxpc3Qgb2Ygbm9kZXMgb24gd2hpY2ggaXQKICAgICAgLy8gaXMgcmVnaXN0ZXJlZC4KICAgICAgaWYgKCFyZWdpc3RyYXRpb24pIHsKICAgICAgICByZWdpc3RyYXRpb24gPSBuZXcgUmVnaXN0cmF0aW9uKHRoaXMsIHRhcmdldCwgb3B0aW9ucyk7CiAgICAgICAgcmVnaXN0cmF0aW9ucy5wdXNoKHJlZ2lzdHJhdGlvbik7CiAgICAgICAgdGhpcy5ub2Rlc18ucHVzaCh0YXJnZXQpOwogICAgICB9CgogICAgICByZWdpc3RyYXRpb24uYWRkTGlzdGVuZXJzKCk7CiAgICB9LAoKICAgIGRpc2Nvbm5lY3Q6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5vZGVzXy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uID0gcmVnaXN0cmF0aW9uc1tpXTsKICAgICAgICAgIGlmIChyZWdpc3RyYXRpb24ub2JzZXJ2ZXIgPT09IHRoaXMpIHsKICAgICAgICAgICAgcmVnaXN0cmF0aW9uLnJlbW92ZUxpc3RlbmVycygpOwogICAgICAgICAgICByZWdpc3RyYXRpb25zLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgLy8gRWFjaCBub2RlIGNhbiBvbmx5IGhhdmUgb25lIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgYXNzb2NpYXRlZCB3aXRoCiAgICAgICAgICAgIC8vIHRoaXMgb2JzZXJ2ZXIuCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgdGhpcyk7CiAgICAgIHRoaXMucmVjb3Jkc18gPSBbXTsKICAgIH0sCgogICAgdGFrZVJlY29yZHM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgY29weU9mUmVjb3JkcyA9IHRoaXMucmVjb3Jkc187CiAgICAgIHRoaXMucmVjb3Jkc18gPSBbXTsKICAgICAgcmV0dXJuIGNvcHlPZlJlY29yZHM7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUKICAgKiBAcGFyYW0ge05vZGV9IHRhcmdldAogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIE11dGF0aW9uUmVjb3JkKHR5cGUsIHRhcmdldCkgewogICAgdGhpcy50eXBlID0gdHlwZTsKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgdGhpcy5hZGRlZE5vZGVzID0gW107CiAgICB0aGlzLnJlbW92ZWROb2RlcyA9IFtdOwogICAgdGhpcy5wcmV2aW91c1NpYmxpbmcgPSBudWxsOwogICAgdGhpcy5uZXh0U2libGluZyA9IG51bGw7CiAgICB0aGlzLmF0dHJpYnV0ZU5hbWUgPSBudWxsOwogICAgdGhpcy5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBudWxsOwogICAgdGhpcy5vbGRWYWx1ZSA9IG51bGw7CiAgfQoKICBmdW5jdGlvbiBjb3B5TXV0YXRpb25SZWNvcmQob3JpZ2luYWwpIHsKICAgIHZhciByZWNvcmQgPSBuZXcgTXV0YXRpb25SZWNvcmQob3JpZ2luYWwudHlwZSwgb3JpZ2luYWwudGFyZ2V0KTsKICAgIHJlY29yZC5hZGRlZE5vZGVzID0gb3JpZ2luYWwuYWRkZWROb2Rlcy5zbGljZSgpOwogICAgcmVjb3JkLnJlbW92ZWROb2RlcyA9IG9yaWdpbmFsLnJlbW92ZWROb2Rlcy5zbGljZSgpOwogICAgcmVjb3JkLnByZXZpb3VzU2libGluZyA9IG9yaWdpbmFsLnByZXZpb3VzU2libGluZzsKICAgIHJlY29yZC5uZXh0U2libGluZyA9IG9yaWdpbmFsLm5leHRTaWJsaW5nOwogICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWUgPSBvcmlnaW5hbC5hdHRyaWJ1dGVOYW1lOwogICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IG9yaWdpbmFsLmF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgIHJlY29yZC5vbGRWYWx1ZSA9IG9yaWdpbmFsLm9sZFZhbHVlOwogICAgcmV0dXJuIHJlY29yZDsKICB9OwoKICAvLyBXZSBrZWVwIHRyYWNrIG9mIHRoZSB0d28gKHBvc3NpYmx5IG9uZSkgcmVjb3JkcyB1c2VkIGluIGEgc2luZ2xlIG11dGF0aW9uLgogIHZhciBjdXJyZW50UmVjb3JkLCByZWNvcmRXaXRoT2xkVmFsdWU7CgogIC8qKgogICAqIENyZWF0ZXMgYSByZWNvcmQgd2l0aG91dCB8b2xkVmFsdWV8IGFuZCBjYWNoZXMgaXQgYXMgfGN1cnJlbnRSZWNvcmR8IGZvcgogICAqIGxhdGVyIHVzZS4KICAgKiBAcGFyYW0ge3N0cmluZ30gb2xkVmFsdWUKICAgKiBAcmV0dXJuIHtNdXRhdGlvblJlY29yZH0KICAgKi8KICBmdW5jdGlvbiBnZXRSZWNvcmQodHlwZSwgdGFyZ2V0KSB7CiAgICByZXR1cm4gY3VycmVudFJlY29yZCA9IG5ldyBNdXRhdGlvblJlY29yZCh0eXBlLCB0YXJnZXQpOwogIH0KCiAgLyoqCiAgICogR2V0cyBvciBjcmVhdGVzIGEgcmVjb3JkIHdpdGggfG9sZFZhbHVlfCBiYXNlZCBpbiB0aGUgfGN1cnJlbnRSZWNvcmR8CiAgICogQHBhcmFtIHtzdHJpbmd9IG9sZFZhbHVlCiAgICogQHJldHVybiB7TXV0YXRpb25SZWNvcmR9CiAgICovCiAgZnVuY3Rpb24gZ2V0UmVjb3JkV2l0aE9sZFZhbHVlKG9sZFZhbHVlKSB7CiAgICBpZiAocmVjb3JkV2l0aE9sZFZhbHVlKQogICAgICByZXR1cm4gcmVjb3JkV2l0aE9sZFZhbHVlOwogICAgcmVjb3JkV2l0aE9sZFZhbHVlID0gY29weU11dGF0aW9uUmVjb3JkKGN1cnJlbnRSZWNvcmQpOwogICAgcmVjb3JkV2l0aE9sZFZhbHVlLm9sZFZhbHVlID0gb2xkVmFsdWU7CiAgICByZXR1cm4gcmVjb3JkV2l0aE9sZFZhbHVlOwogIH0KCiAgZnVuY3Rpb24gY2xlYXJSZWNvcmRzKCkgewogICAgY3VycmVudFJlY29yZCA9IHJlY29yZFdpdGhPbGRWYWx1ZSA9IHVuZGVmaW5lZDsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9IHJlY29yZAogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIHJlY29yZCByZXByZXNlbnRzIGEgcmVjb3JkIGZyb20gdGhlIGN1cnJlbnQKICAgKiBtdXRhdGlvbiBldmVudC4KICAgKi8KICBmdW5jdGlvbiByZWNvcmRSZXByZXNlbnRzQ3VycmVudE11dGF0aW9uKHJlY29yZCkgewogICAgcmV0dXJuIHJlY29yZCA9PT0gcmVjb3JkV2l0aE9sZFZhbHVlIHx8IHJlY29yZCA9PT0gY3VycmVudFJlY29yZDsKICB9CgogIC8qKgogICAqIFNlbGVjdHMgd2hpY2ggcmVjb3JkLCBpZiBhbnksIHRvIHJlcGxhY2UgdGhlIGxhc3QgcmVjb3JkIGluIHRoZSBxdWV1ZS4KICAgKiBUaGlzIHJldHVybnMgfG51bGx8IGlmIG5vIHJlY29yZCBzaG91bGQgYmUgcmVwbGFjZWQuCiAgICoKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfSBsYXN0UmVjb3JkCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0gbmV3UmVjb3JkCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0KICAgKi8KICBmdW5jdGlvbiBzZWxlY3RSZWNvcmQobGFzdFJlY29yZCwgbmV3UmVjb3JkKSB7CiAgICBpZiAobGFzdFJlY29yZCA9PT0gbmV3UmVjb3JkKQogICAgICByZXR1cm4gbGFzdFJlY29yZDsKCiAgICAvLyBDaGVjayBpZiB0aGUgdGhlIHJlY29yZCB3ZSBhcmUgYWRkaW5nIHJlcHJlc2VudHMgdGhlIHNhbWUgcmVjb3JkLiBJZgogICAgLy8gc28sIHdlIGtlZXAgdGhlIG9uZSB3aXRoIHRoZSBvbGRWYWx1ZSBpbiBpdC4KICAgIGlmIChyZWNvcmRXaXRoT2xkVmFsdWUgJiYgcmVjb3JkUmVwcmVzZW50c0N1cnJlbnRNdXRhdGlvbihsYXN0UmVjb3JkKSkKICAgICAgcmV0dXJuIHJlY29yZFdpdGhPbGRWYWx1ZTsKCiAgICByZXR1cm4gbnVsbDsKICB9CgogIC8qKgogICAqIENsYXNzIHVzZWQgdG8gcmVwcmVzZW50IGEgcmVnaXN0ZXJlZCBvYnNlcnZlci4KICAgKiBAcGFyYW0ge011dGF0aW9uT2JzZXJ2ZXJ9IG9ic2VydmVyCiAgICogQHBhcmFtIHtOb2RlfSB0YXJnZXQKICAgKiBAcGFyYW0ge011dGF0aW9uT2JzZXJ2ZXJJbml0fSBvcHRpb25zCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gUmVnaXN0cmF0aW9uKG9ic2VydmVyLCB0YXJnZXQsIG9wdGlvbnMpIHsKICAgIHRoaXMub2JzZXJ2ZXIgPSBvYnNlcnZlcjsKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2RlcyA9IFtdOwogIH0KCiAgUmVnaXN0cmF0aW9uLnByb3RvdHlwZSA9IHsKICAgIGVucXVldWU6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICB2YXIgcmVjb3JkcyA9IHRoaXMub2JzZXJ2ZXIucmVjb3Jkc187CiAgICAgIHZhciBsZW5ndGggPSByZWNvcmRzLmxlbmd0aDsKCiAgICAgIC8vIFRoZXJlIGFyZSBjYXNlcyB3aGVyZSB3ZSByZXBsYWNlIHRoZSBsYXN0IHJlY29yZCB3aXRoIHRoZSBuZXcgcmVjb3JkLgogICAgICAvLyBGb3IgZXhhbXBsZSBpZiB0aGUgcmVjb3JkIHJlcHJlc2VudHMgdGhlIHNhbWUgbXV0YXRpb24gd2UgbmVlZCB0byB1c2UKICAgICAgLy8gdGhlIG9uZSB3aXRoIHRoZSBvbGRWYWx1ZS4gSWYgd2UgZ2V0IHNhbWUgcmVjb3JkICh0aGlzIGNhbiBoYXBwZW4gYXMgd2UKICAgICAgLy8gd2FsayB1cCB0aGUgdHJlZSkgd2UgaWdub3JlIHRoZSBuZXcgcmVjb3JkLgogICAgICBpZiAocmVjb3Jkcy5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIGxhc3RSZWNvcmQgPSByZWNvcmRzW2xlbmd0aCAtIDFdOwogICAgICAgIHZhciByZWNvcmRUb1JlcGxhY2VMYXN0ID0gc2VsZWN0UmVjb3JkKGxhc3RSZWNvcmQsIHJlY29yZCk7CiAgICAgICAgaWYgKHJlY29yZFRvUmVwbGFjZUxhc3QpIHsKICAgICAgICAgIHJlY29yZHNbbGVuZ3RoIC0gMV0gPSByZWNvcmRUb1JlcGxhY2VMYXN0OwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzY2hlZHVsZUNhbGxiYWNrKHRoaXMub2JzZXJ2ZXIpOwogICAgICB9CgogICAgICByZWNvcmRzW2xlbmd0aF0gPSByZWNvcmQ7CiAgICB9LAoKICAgIGFkZExpc3RlbmVyczogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuYWRkTGlzdGVuZXJzXyh0aGlzLnRhcmdldCk7CiAgICB9LAoKICAgIGFkZExpc3RlbmVyc186IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZXMpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01BdHRyTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoYXJhY3RlckRhdGEpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01DaGFyYWN0ZXJEYXRhTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCkKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVJbnNlcnRlZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0IHx8IG9wdGlvbnMuc3VidHJlZSkKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVSZW1vdmVkJywgdGhpcywgdHJ1ZSk7CiAgICB9LAoKICAgIHJlbW92ZUxpc3RlbmVyczogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXJzXyh0aGlzLnRhcmdldCk7CiAgICB9LAoKICAgIHJlbW92ZUxpc3RlbmVyc186IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZXMpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01BdHRyTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoYXJhY3RlckRhdGEpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01DaGFyYWN0ZXJEYXRhTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCkKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVJbnNlcnRlZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0IHx8IG9wdGlvbnMuc3VidHJlZSkKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVSZW1vdmVkJywgdGhpcywgdHJ1ZSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQWRkcyBhIHRyYW5zaWVudCBvYnNlcnZlciBvbiBub2RlLiBUaGUgdHJhbnNpZW50IG9ic2VydmVyIGdldHMgcmVtb3ZlZAogICAgICogbmV4dCB0aW1lIHdlIGRlbGl2ZXIgdGhlIGNoYW5nZSByZWNvcmRzLgogICAgICogQHBhcmFtIHtOb2RlfSBub2RlCiAgICAgKi8KICAgIGFkZFRyYW5zaWVudE9ic2VydmVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgIC8vIERvbid0IGFkZCB0cmFuc2llbnQgb2JzZXJ2ZXJzIG9uIHRoZSB0YXJnZXQgaXRzZWxmLiBXZSBhbHJlYWR5IGhhdmUgYWxsCiAgICAgIC8vIHRoZSByZXF1aXJlZCBsaXN0ZW5lcnMgc2V0IHVwIG9uIHRoZSB0YXJnZXQuCiAgICAgIGlmIChub2RlID09PSB0aGlzLnRhcmdldCkKICAgICAgICByZXR1cm47CgogICAgICB0aGlzLmFkZExpc3RlbmVyc18obm9kZSk7CiAgICAgIHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2Rlcy5wdXNoKG5vZGUpOwogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgIGlmICghcmVnaXN0cmF0aW9ucykKICAgICAgICByZWdpc3RyYXRpb25zVGFibGUuc2V0KG5vZGUsIHJlZ2lzdHJhdGlvbnMgPSBbXSk7CgogICAgICAvLyBXZSBrbm93IHRoYXQgcmVnaXN0cmF0aW9ucyBkb2VzIG5vdCBjb250YWluIHRoaXMgYmVjYXVzZSB3ZSBhbHJlYWR5CiAgICAgIC8vIGNoZWNrZWQgaWYgbm9kZSA9PT0gdGhpcy50YXJnZXQuCiAgICAgIHJlZ2lzdHJhdGlvbnMucHVzaCh0aGlzKTsKICAgIH0sCgogICAgcmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRyYW5zaWVudE9ic2VydmVkTm9kZXMgPSB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXM7CiAgICAgIHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2RlcyA9IFtdOwoKICAgICAgdHJhbnNpZW50T2JzZXJ2ZWROb2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAvLyBUcmFuc2llbnQgb2JzZXJ2ZXJzIGFyZSBuZXZlciBhZGRlZCB0byB0aGUgdGFyZ2V0LgogICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXJzXyhub2RlKTsKCiAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbnNbaV0gPT09IHRoaXMpIHsKICAgICAgICAgICAgcmVnaXN0cmF0aW9ucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIC8vIEVhY2ggbm9kZSBjYW4gb25seSBoYXZlIG9uZSByZWdpc3RlcmVkIG9ic2VydmVyIGFzc29jaWF0ZWQgd2l0aAogICAgICAgICAgICAvLyB0aGlzIG9ic2VydmVyLgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfSwKCiAgICBoYW5kbGVFdmVudDogZnVuY3Rpb24oZSkgewogICAgICAvLyBTdG9wIHByb3BhZ2F0aW9uIHNpbmNlIHdlIGFyZSBtYW5hZ2luZyB0aGUgcHJvcGFnYXRpb24gbWFudWFsbHkuCiAgICAgIC8vIFRoaXMgbWVhbnMgdGhhdCBvdGhlciBtdXRhdGlvbiBldmVudHMgb24gdGhlIHBhZ2Ugd2lsbCBub3Qgd29yawogICAgICAvLyBjb3JyZWN0bHkgYnV0IHRoYXQgaXMgYnkgZGVzaWduLgogICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoKICAgICAgc3dpdGNoIChlLnR5cGUpIHsKICAgICAgICBjYXNlICdET01BdHRyTW9kaWZpZWQnOgogICAgICAgICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtbW8tcXVldWUtYXR0cmlidXRlcwoKICAgICAgICAgIHZhciBuYW1lID0gZS5hdHRyTmFtZTsKICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBlLnJlbGF0ZWROb2RlLm5hbWVzcGFjZVVSSTsKICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDsKCiAgICAgICAgICAvLyAxLgogICAgICAgICAgdmFyIHJlY29yZCA9IG5ldyBnZXRSZWNvcmQoJ2F0dHJpYnV0ZXMnLCB0YXJnZXQpOwogICAgICAgICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWUgPSBuYW1lOwogICAgICAgICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IG5hbWVzcGFjZTsKCiAgICAgICAgICAvLyAyLgogICAgICAgICAgdmFyIG9sZFZhbHVlID0KICAgICAgICAgICAgICBlLmF0dHJDaGFuZ2UgPT09IE11dGF0aW9uRXZlbnQuQURESVRJT04gPyBudWxsIDogZS5wcmV2VmFsdWU7CgogICAgICAgICAgZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICAvLyAzLjEsIDQuMgogICAgICAgICAgICBpZiAoIW9wdGlvbnMuYXR0cmlidXRlcykKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAvLyAzLjIsIDQuMwogICAgICAgICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIgJiYgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIubGVuZ3RoICYmCiAgICAgICAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5pbmRleE9mKG5hbWUpID09PSAtMSAmJgogICAgICAgICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIuaW5kZXhPZihuYW1lc3BhY2UpID09PSAtMSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAzLjMsIDQuNAogICAgICAgICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVPbGRWYWx1ZSkKICAgICAgICAgICAgICByZXR1cm4gZ2V0UmVjb3JkV2l0aE9sZFZhbHVlKG9sZFZhbHVlKTsKCiAgICAgICAgICAgIC8vIDMuNCwgNC41CiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnRE9NQ2hhcmFjdGVyRGF0YU1vZGlmaWVkJzoKICAgICAgICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LW1vLXF1ZXVlLWNoYXJhY3RlcmRhdGEKICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDsKCiAgICAgICAgICAvLyAxLgogICAgICAgICAgdmFyIHJlY29yZCA9IGdldFJlY29yZCgnY2hhcmFjdGVyRGF0YScsIHRhcmdldCk7CgogICAgICAgICAgLy8gMi4KICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IGUucHJldlZhbHVlOwoKCiAgICAgICAgICBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIDMuMSwgNC4yCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5jaGFyYWN0ZXJEYXRhKQogICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIDMuMiwgNC4zCiAgICAgICAgICAgIGlmIChvcHRpb25zLmNoYXJhY3RlckRhdGFPbGRWYWx1ZSkKICAgICAgICAgICAgICByZXR1cm4gZ2V0UmVjb3JkV2l0aE9sZFZhbHVlKG9sZFZhbHVlKTsKCiAgICAgICAgICAgIC8vIDMuMywgNC40CiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnRE9NTm9kZVJlbW92ZWQnOgogICAgICAgICAgdGhpcy5hZGRUcmFuc2llbnRPYnNlcnZlcihlLnRhcmdldCk7CiAgICAgICAgICAvLyBGYWxsIHRocm91Z2guCiAgICAgICAgY2FzZSAnRE9NTm9kZUluc2VydGVkJzoKICAgICAgICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LW1vLXF1ZXVlLWNoaWxkbGlzdAogICAgICAgICAgdmFyIHRhcmdldCA9IGUucmVsYXRlZE5vZGU7CiAgICAgICAgICB2YXIgY2hhbmdlZE5vZGUgPSBlLnRhcmdldDsKICAgICAgICAgIHZhciBhZGRlZE5vZGVzLCByZW1vdmVkTm9kZXM7CiAgICAgICAgICBpZiAoZS50eXBlID09PSAnRE9NTm9kZUluc2VydGVkJykgewogICAgICAgICAgICBhZGRlZE5vZGVzID0gW2NoYW5nZWROb2RlXTsKICAgICAgICAgICAgcmVtb3ZlZE5vZGVzID0gW107CiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgYWRkZWROb2RlcyA9IFtdOwogICAgICAgICAgICByZW1vdmVkTm9kZXMgPSBbY2hhbmdlZE5vZGVdOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZpb3VzU2libGluZyA9IGNoYW5nZWROb2RlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIHZhciBuZXh0U2libGluZyA9IGNoYW5nZWROb2RlLm5leHRTaWJsaW5nOwoKICAgICAgICAgIC8vIDEuCiAgICAgICAgICB2YXIgcmVjb3JkID0gZ2V0UmVjb3JkKCdjaGlsZExpc3QnLCB0YXJnZXQpOwogICAgICAgICAgcmVjb3JkLmFkZGVkTm9kZXMgPSBhZGRlZE5vZGVzOwogICAgICAgICAgcmVjb3JkLnJlbW92ZWROb2RlcyA9IHJlbW92ZWROb2RlczsKICAgICAgICAgIHJlY29yZC5wcmV2aW91c1NpYmxpbmcgPSBwcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICByZWNvcmQubmV4dFNpYmxpbmcgPSBuZXh0U2libGluZzsKCiAgICAgICAgICBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIDIuMSwgMy4yCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5jaGlsZExpc3QpCiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMi4yLCAzLjMKICAgICAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgICAgICAgIH0pOwoKICAgICAgfQoKICAgICAgY2xlYXJSZWNvcmRzKCk7CiAgICB9CiAgfTsKCiAgZ2xvYmFsLkpzTXV0YXRpb25PYnNlcnZlciA9IEpzTXV0YXRpb25PYnNlcnZlcjsKCn0pKHRoaXMpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCmlmICghd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIpIHsKICB3aW5kb3cuTXV0YXRpb25PYnNlcnZlciA9IAogICAgICB3aW5kb3cuV2ViS2l0TXV0YXRpb25PYnNlcnZlciB8fCAKICAgICAgd2luZG93LkpzTXV0YXRpb25PYnNlcnZlcjsKICBpZiAoIU11dGF0aW9uT2JzZXJ2ZXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigibm8gbXV0YXRpb24gb2JzZXJ2ZXIgc3VwcG9ydCIpOwogIH0KfQoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8qKgogKiBJbXBsZW1lbnRzIGBkb2N1bWVudC5yZWdpc3RlcmAKICogQG1vZHVsZSBDdXN0b21FbGVtZW50cwoqLwoKLyoqCiAqIFBvbHlmaWxsZWQgZXh0ZW5zaW9ucyB0byB0aGUgYGRvY3VtZW50YCBvYmplY3QuCiAqIEBjbGFzcyBEb2N1bWVudAoqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7CgppZiAoIXNjb3BlKSB7CiAgc2NvcGUgPSB3aW5kb3cuQ3VzdG9tRWxlbWVudHMgPSB7ZmxhZ3M6e319Owp9CgovLyBuYXRpdmUgZG9jdW1lbnQucmVnaXN0ZXI/CgpzY29wZS5oYXNOYXRpdmUgPSAoZG9jdW1lbnQud2Via2l0UmVnaXN0ZXIgfHwgZG9jdW1lbnQucmVnaXN0ZXIpICYmIHNjb3BlLmZsYWdzLnJlZ2lzdGVyID09PSAnbmF0aXZlJzsKaWYgKHNjb3BlLmhhc05hdGl2ZSkgewoKICAvLyBub3JtYWxpemUKICBkb2N1bWVudC5yZWdpc3RlciA9IGRvY3VtZW50LnJlZ2lzdGVyIHx8IGRvY3VtZW50LndlYmtpdFJlZ2lzdGVyOwoKICB2YXIgbm9wID0gZnVuY3Rpb24oKSB7fTsKCiAgLy8gZXhwb3J0cwogIHNjb3BlLnJlZ2lzdHJ5ID0ge307CiAgc2NvcGUudXBncmFkZUVsZW1lbnQgPSBub3A7Cgp9IGVsc2UgewoKLyoqCiAqIFJlZ2lzdGVycyBhIGN1c3RvbSB0YWcgbmFtZSB3aXRoIHRoZSBkb2N1bWVudC4KICoKICogV2hlbiBhIHJlZ2lzdGVyZWQgZWxlbWVudCBpcyBjcmVhdGVkLCBhIGByZWFkeUNhbGxiYWNrYCBtZXRob2QgaXMgY2FsbGVkCiAqIGluIHRoZSBzY29wZSBvZiB0aGUgZWxlbWVudC4gVGhlIGByZWFkeUNhbGxiYWNrYCBtZXRob2QgY2FuIGJlIHNwZWNpZmllZCBvbgogKiBlaXRoZXIgYGluT3B0aW9ucy5wcm90b3R5cGVgIG9yIGBpbk9wdGlvbnMubGlmZWN5Y2xlYCB3aXRoIHRoZSBsYXR0ZXIgdGFraW5nCiAqIHByZWNlZGVuY2UuCiAqCiAqIEBtZXRob2QgcmVnaXN0ZXIKICogQHBhcmFtIHtTdHJpbmd9IGluTmFtZSBUaGUgdGFnIG5hbWUgdG8gcmVnaXN0ZXIuIE11c3QgaW5jbHVkZSBhIGRhc2ggKCctJyksCiAqICAgIGZvciBleGFtcGxlICd4LWNvbXBvbmVudCcuCiAqIEBwYXJhbSB7T2JqZWN0fSBpbk9wdGlvbnMKICogICAgQHBhcmFtIHtTdHJpbmd9IFtpbk9wdGlvbnMuZXh0ZW5kc10KICogICAgICAoX29mZiBzcGVjXykgVGFnIG5hbWUgb2YgYW4gZWxlbWVudCB0byBleHRlbmQgKG9yIGJsYW5rIGZvciBhIG5ldwogKiAgICAgIGVsZW1lbnQpLiBUaGlzIHBhcmFtZXRlciBpcyBub3QgcGFydCBvZiB0aGUgc3BlY2lmaWNhdGlvbiwgYnV0IGluc3RlYWQKICogICAgICBpcyBhIGhpbnQgZm9yIHRoZSBwb2x5ZmlsbCBiZWNhdXNlIHRoZSBleHRlbmRlZSBpcyBkaWZmaWN1bHQgdG8gaW5mZXIuCiAqICAgICAgUmVtZW1iZXIgdGhhdCB0aGUgaW5wdXQgcHJvdG90eXBlIG11c3QgY2hhaW4gdG8gdGhlIGV4dGVuZGVkIGVsZW1lbnQncwogKiAgICAgIHByb3RvdHlwZSAob3IgSFRNTEVsZW1lbnQucHJvdG90eXBlKSByZWdhcmRsZXNzIG9mIHRoZSB2YWx1ZSBvZgogKiAgICAgIGBleHRlbmRzYC4KICogICAgQHBhcmFtIHtPYmplY3R9IGluT3B0aW9ucy5wcm90b3R5cGUgVGhlIHByb3RvdHlwZSB0byB1c2UgZm9yIHRoZSBuZXcKICogICAgICBlbGVtZW50LiBUaGUgcHJvdG90eXBlIG11c3QgaW5oZXJpdCBmcm9tIEhUTUxFbGVtZW50LgogKiAgICBAcGFyYW0ge09iamVjdH0gW2luT3B0aW9ucy5saWZlY3ljbGVdCiAqICAgICAgQ2FsbGJhY2tzIHRoYXQgZmlyZSBhdCBpbXBvcnRhbnQgcGhhc2VzIGluIHRoZSBsaWZlIG9mIHRoZSBjdXN0b20KICogICAgICBlbGVtZW50LgogKgogKiBAZXhhbXBsZQogKiAgICAgIEZhbmN5QnV0dG9uID0gZG9jdW1lbnQucmVnaXN0ZXIoImZhbmN5LWJ1dHRvbiIsIHsKICogICAgICAgIGV4dGVuZHM6ICdidXR0b24nLAogKiAgICAgICAgcHJvdG90eXBlOiBPYmplY3QuY3JlYXRlKEhUTUxCdXR0b25FbGVtZW50LnByb3RvdHlwZSwgewogKiAgICAgICAgICByZWFkeUNhbGxiYWNrOiB7CiAqICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAgICAgY29uc29sZS5sb2coImEgZmFuY3ktYnV0dG9uIHdhcyBjcmVhdGVkIiwKICogICAgICAgICAgICB9CiAqICAgICAgICAgIH0KICogICAgICAgIH0pCiAqICAgICAgfSk7CiAqIEByZXR1cm4ge0Z1bmN0aW9ufSBDb25zdHJ1Y3RvciBmb3IgdGhlIG5ld2x5IHJlZ2lzdGVyZWQgdHlwZS4KICovCmZ1bmN0aW9uIHJlZ2lzdGVyKGluTmFtZSwgaW5PcHRpb25zKSB7CiAgLy9jb25zb2xlLndhcm4oJ2RvY3VtZW50LnJlZ2lzdGVyKCInICsgaW5OYW1lICsgJyIsICcsIGluT3B0aW9ucywgJyknKTsKICAvLyBjb25zdHJ1Y3QgYSBkZWZpbnRpb24gb3V0IG9mIG9wdGlvbnMKICAvLyBUT0RPKHNqbWlsZXMpOiBwcm9iYWJseSBzaG91bGQgY2xvbmUgaW5PcHRpb25zIGluc3RlYWQgb2YgbXV0YXRpbmcgaXQKICB2YXIgZGVmaW5pdGlvbiA9IGluT3B0aW9ucyB8fCB7fTsKICBpZiAoIWluTmFtZSkgewogICAgLy8gVE9ETyhzam1pbGVzKTogcmVwbGFjZSB3aXRoIG1vcmUgYXBwcm9wcmlhdGUgZXJyb3IgKEVyaWsgY2FuIHByb2JhYmx5CiAgICAvLyBvZmZlciBndWlkYW5jZSkKICAgIHRocm93IG5ldyBFcnJvcignTmFtZSBhcmd1bWVudCBtdXN0IG5vdCBiZSBlbXB0eScpOwogIH0KICAvLyByZWNvcmQgbmFtZQogIGRlZmluaXRpb24ubmFtZSA9IGluTmFtZTsKICAvLyBtdXN0IGhhdmUgYSBwcm90b3R5cGUsIGRlZmF1bHQgdG8gYW4gZXh0ZW5zaW9uIG9mIEhUTUxFbGVtZW50CiAgLy8gVE9ETyhzam1pbGVzKTogcHJvYmFibHkgc2hvdWxkIHRocm93IGlmIG5vIHByb3RvdHlwZSwgY2hlY2sgc3BlYwogIGlmICghZGVmaW5pdGlvbi5wcm90b3R5cGUpIHsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlcGxhY2Ugd2l0aCBtb3JlIGFwcHJvcHJpYXRlIGVycm9yIChFcmlrIGNhbiBwcm9iYWJseQogICAgLy8gb2ZmZXIgZ3VpZGFuY2UpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ09wdGlvbnMgbWlzc2luZyByZXF1aXJlZCBwcm90b3R5cGUgcHJvcGVydHknKTsKICB9CiAgLy8gZW5zdXJlIGEgbGlmZWN5Y2xlIG9iamVjdCBzbyB3ZSBkb24ndCBoYXZlIHRvIG51bGwgdGVzdCBpdAogIGRlZmluaXRpb24ubGlmZWN5Y2xlID0gZGVmaW5pdGlvbi5saWZlY3ljbGUgfHwge307CiAgLy8gYnVpbGQgYSBsaXN0IG9mIGFuY2VzdHJhbCBjdXN0b20gZWxlbWVudHMgKGZvciBuYXRpdmUgYmFzZSBkZXRlY3Rpb24pCiAgLy8gVE9ETyhzam1pbGVzKTogd2UgdXNlZCB0byBuZWVkIHRvIHN0b3JlIHRoaXMsIGJ1dCBjdXJyZW50IGNvZGUgb25seQogIC8vIHVzZXMgaXQgaW4gJ3Jlc29sdmVUYWdOYW1lJzogaXQgc2hvdWxkIHByb2JhYmx5IGJlIGlubGluZWQKICBkZWZpbml0aW9uLmFuY2VzdHJ5ID0gYW5jZXN0cnkoZGVmaW5pdGlvbi5leHRlbmRzKTsKICAvLyBleHRlbnNpb25zIG9mIG5hdGl2ZSBzcGVjaWFsaXphdGlvbnMgb2YgSFRNTEVsZW1lbnQgcmVxdWlyZSBsb2NhbE5hbWUKICAvLyB0byByZW1haW4gbmF0aXZlLCBhbmQgdXNlIHNlY29uZGFyeSAnaXMnIHNwZWNpZmllciBmb3IgZXh0ZW5zaW9uIHR5cGUKICByZXNvbHZlVGFnTmFtZShkZWZpbml0aW9uKTsKICAvLyBzb21lIHBsYXRmb3JtcyByZXF1aXJlIG1vZGlmaWNhdGlvbnMgdG8gdGhlIHVzZXItc3VwcGxpZWQgcHJvdG90eXBlCiAgLy8gY2hhaW4KICByZXNvbHZlUHJvdG90eXBlQ2hhaW4oZGVmaW5pdGlvbik7CiAgLy8gb3ZlcnJpZGVzIHRvIGltcGxlbWVudCBhdHRyaWJ1dGVDaGFuZ2VkIGNhbGxiYWNrCiAgb3ZlcnJpZGVBdHRyaWJ1dGVBcGkoZGVmaW5pdGlvbi5wcm90b3R5cGUpOwogIC8vIDcuMS41OiBSZWdpc3RlciB0aGUgREVGSU5JVElPTiB3aXRoIERPQ1VNRU5UCiAgcmVnaXN0ZXJEZWZpbml0aW9uKGluTmFtZSwgZGVmaW5pdGlvbik7CiAgLy8gNy4xLjcuIFJ1biBjdXN0b20gZWxlbWVudCBjb25zdHJ1Y3RvciBnZW5lcmF0aW9uIGFsZ29yaXRobSB3aXRoIFBST1RPVFlQRQogIC8vIDcuMS44LiBSZXR1cm4gdGhlIG91dHB1dCBvZiB0aGUgcHJldmlvdXMgc3RlcC4KICBkZWZpbml0aW9uLmN0b3IgPSBnZW5lcmF0ZUNvbnN0cnVjdG9yKGRlZmluaXRpb24pOwogIGRlZmluaXRpb24uY3Rvci5wcm90b3R5cGUgPSBkZWZpbml0aW9uLnByb3RvdHlwZTsKICAvLyBmb3JjZSBvdXIgLmNvbnN0cnVjdG9yIHRvIGJlIG91ciBhY3R1YWwgY29uc3RydWN0b3IKICBkZWZpbml0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGRlZmluaXRpb24uY3RvcjsKICAvLyBpZiBpbml0aWFsIHBhcnNpbmcgaXMgY29tcGxldGUKICBpZiAoc2NvcGUucmVhZHkpIHsKICAgIC8vIHVwZ3JhZGUgYW55IHByZS1leGlzdGluZyBub2RlcyBvZiB0aGlzIHR5cGUKICAgIHNjb3BlLnVwZ3JhZGVBbGwoZG9jdW1lbnQpOwogIH0KICByZXR1cm4gZGVmaW5pdGlvbi5jdG9yOwp9CgpmdW5jdGlvbiBhbmNlc3RyeShpbkV4dGVuZHMpIHsKICB2YXIgZXh0ZW5kZWUgPSByZWdpc3RyeVtpbkV4dGVuZHNdOwogIGlmIChleHRlbmRlZSkgewogICAgcmV0dXJuIGFuY2VzdHJ5KGV4dGVuZGVlLmV4dGVuZHMpLmNvbmNhdChbZXh0ZW5kZWVdKTsKICB9CiAgcmV0dXJuIFtdOwp9CgpmdW5jdGlvbiByZXNvbHZlVGFnTmFtZShpbkRlZmluaXRpb24pIHsKICAvLyBpZiB3ZSBhcmUgZXhwbGljaXRseSBleHRlbmRpbmcgc29tZXRoaW5nLCB0aGF0IHRoaW5nIGlzIG91cgogIC8vIGJhc2VUYWcsIHVubGVzcyBpdCByZXByZXNlbnRzIGEgY3VzdG9tIGNvbXBvbmVudAogIHZhciBiYXNlVGFnID0gaW5EZWZpbml0aW9uLmV4dGVuZHM7CiAgLy8gaWYgb3VyIGFuY2VzdHJ5IGluY2x1ZGVzIGN1c3RvbSBjb21wb25lbnRzLCB3ZSBvbmx5IGhhdmUgYQogIC8vIGJhc2VUYWcgaWYgb25lIG9mIHRoZW0gZG9lcwogIGZvciAodmFyIGk9MCwgYTsgKGE9aW5EZWZpbml0aW9uLmFuY2VzdHJ5W2ldKTsgaSsrKSB7CiAgICBiYXNlVGFnID0gYS5pcyAmJiBhLnRhZzsKICB9CiAgLy8gb3VyIHRhZyBpcyBvdXIgYmFzZVRhZywgaWYgaXQgZXhpc3RzLCBhbmQgb3RoZXJ3aXNlIGp1c3Qgb3VyIG5hbWUKICBpbkRlZmluaXRpb24udGFnID0gYmFzZVRhZyB8fCBpbkRlZmluaXRpb24ubmFtZTsKICBpZiAoYmFzZVRhZykgewogICAgLy8gaWYgdGhlcmUgaXMgYSBiYXNlIHRhZywgdXNlIHNlY29uZGFyeSAnaXMnIHNwZWNpZmllcgogICAgaW5EZWZpbml0aW9uLmlzID0gaW5EZWZpbml0aW9uLm5hbWU7CiAgfQp9CgpmdW5jdGlvbiByZXNvbHZlUHJvdG90eXBlQ2hhaW4oaW5EZWZpbml0aW9uKSB7CiAgLy8gaWYgd2UgZG9uJ3Qgc3VwcG9ydCBfX3Byb3RvX18gd2UgbmVlZCB0byBsb2NhdGUgdGhlIG5hdGl2ZSBsZXZlbAogIC8vIHByb3RvdHlwZSBmb3IgcHJlY2lzZSBtaXhpbmcgaW4KICBpZiAoIU9iamVjdC5fX3Byb3RvX18pIHsKICAgIC8vIGRlZmF1bHQgcHJvdG90eXBlCiAgICB2YXIgbmF0aXZlID0gSFRNTEVsZW1lbnQucHJvdG90eXBlOwogICAgLy8gd29yayBvdXQgcHJvdG90eXBlIHdoZW4gdXNpbmcgdHlwZS1leHRlbnNpb24KICAgIGlmIChpbkRlZmluaXRpb24uaXMpIHsKICAgICAgdmFyIGluc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGluRGVmaW5pdGlvbi50YWcpOwogICAgICBuYXRpdmUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoaW5zdCk7CiAgICB9CiAgfQogIC8vIGNhY2hlIHRoaXMgaW4gY2FzZSBvZiBtaXhpbgogIGluRGVmaW5pdGlvbi5uYXRpdmUgPSBuYXRpdmU7Cn0KCi8vIFNFQ1RJT04gNAoKZnVuY3Rpb24gaW5zdGFudGlhdGUoaW5EZWZpbml0aW9uKSB7CiAgLy8gNC5hLjEuIENyZWF0ZSBhIG5ldyBvYmplY3QgdGhhdCBpbXBsZW1lbnRzIFBST1RPVFlQRQogIC8vIDQuYS4yLiBMZXQgRUxFTUVOVCBieSB0aGlzIG5ldyBvYmplY3QKICAvLwogIC8vIHRoZSBjdXN0b20gZWxlbWVudCBpbnN0YW50aWF0aW9uIGFsZ29yaXRobSBtdXN0IGFsc28gZW5zdXJlIHRoYXQgdGhlCiAgLy8gb3V0cHV0IGlzIGEgdmFsaWQgRE9NIGVsZW1lbnQgd2l0aCB0aGUgcHJvcGVyIHdyYXBwZXIgaW4gcGxhY2UuCiAgLy8KICByZXR1cm4gdXBncmFkZShkb21DcmVhdGVFbGVtZW50KGluRGVmaW5pdGlvbi50YWcpLCBpbkRlZmluaXRpb24pOwp9CgpmdW5jdGlvbiB1cGdyYWRlKGluRWxlbWVudCwgaW5EZWZpbml0aW9uKSB7CiAgLy8gc29tZSBkZWZpbml0aW9ucyBzcGVjaWZ5IGFuICdpcycgYXR0cmlidXRlCiAgaWYgKGluRGVmaW5pdGlvbi5pcykgewogICAgaW5FbGVtZW50LnNldEF0dHJpYnV0ZSgnaXMnLCBpbkRlZmluaXRpb24uaXMpOwogIH0KICAvLyBtYWtlICdlbGVtZW50JyBpbXBsZW1lbnQgaW5EZWZpbml0aW9uLnByb3RvdHlwZQogIGltcGxlbWVudChpbkVsZW1lbnQsIGluRGVmaW5pdGlvbik7CiAgLy8gZmxhZyBhcyB1cGdyYWRlZAogIGluRWxlbWVudC5fX3VwZ3JhZGVkX18gPSB0cnVlOwogIC8vIHRoZXJlIHNob3VsZCBuZXZlciBiZSBhIHNoYWRvdyByb290IG9uIGluRWxlbWVudCBhdCB0aGlzIHBvaW50CiAgLy8gd2UgcmVxdWlyZSBjaGlsZCBub2RlcyBiZSB1cGdyYWRlZCBiZWZvcmUgcmVhZHkKICBzY29wZS51cGdyYWRlU3VidHJlZShpbkVsZW1lbnQpOwogIC8vIGxpZmVjeWNsZSBtYW5hZ2VtZW50CiAgcmVhZHkoaW5FbGVtZW50KTsKICAvLyBPVVRQVVQKICByZXR1cm4gaW5FbGVtZW50Owp9CgpmdW5jdGlvbiBpbXBsZW1lbnQoaW5FbGVtZW50LCBpbkRlZmluaXRpb24pIHsKICAvLyBwcm90b3R5cGUgc3dpenpsaW5nIGlzIGJlc3QKICBpZiAoT2JqZWN0Ll9fcHJvdG9fXykgewogICAgaW5FbGVtZW50Ll9fcHJvdG9fXyA9IGluRGVmaW5pdGlvbi5wcm90b3R5cGU7CiAgfSBlbHNlIHsKICAgIC8vIHdoZXJlIGFib3ZlIHdlIGNhbiByZS1hY3F1aXJlIGluUHJvdG90eXBlIHZpYQogICAgLy8gZ2V0UHJvdG90eXBlT2YoRWxlbWVudCksIHdlIGNhbm5vdCBkbyBzbyB3aGVuCiAgICAvLyB3ZSB1c2UgbWl4aW4sIHNvIHdlIGluc3RhbGwgYSBtYWdpYyByZWZlcmVuY2UKICAgIGN1c3RvbU1peGluKGluRWxlbWVudCwgaW5EZWZpbml0aW9uLnByb3RvdHlwZSwgaW5EZWZpbml0aW9uLm5hdGl2ZSk7CiAgICBpbkVsZW1lbnQuX19wcm90b19fID0gaW5EZWZpbml0aW9uLnByb3RvdHlwZTsKICB9Cn0KCmZ1bmN0aW9uIGN1c3RvbU1peGluKGluVGFyZ2V0LCBpblNyYywgaW5OYXRpdmUpIHsKICAvLyBUT0RPKHNqbWlsZXMpOiAndXNlZCcgYWxsb3dzIHVzIHRvIG9ubHkgY29weSB0aGUgJ3lvdW5nZXN0JyB2ZXJzaW9uIG9mCiAgLy8gYW55IHByb3BlcnR5LiBUaGlzIHNldCBzaG91bGQgYmUgcHJlY2FsY3VsYXRlZC4gV2UgYWxzbyBuZWVkIHRvCiAgLy8gY29uc2lkZXIgdGhpcyBmb3Igc3VwcG9ydGluZyAnc3VwZXInLgogIHZhciB1c2VkID0ge307CiAgLy8gc3RhcnQgd2l0aCBpblNyYwogIHZhciBwID0gaW5TcmM7CiAgLy8gc29tZXRpbWVzIHRoZSBkZWZhdWx0IGlzIEhUTUxVbmtub3duRWxlbWVudC5wcm90b3R5cGUgaW5zdGVhZCBvZgogIC8vIEhUTUxFbGVtZW50LnByb3RvdHlwZSwgc28gd2UgYWRkIGEgdGVzdAogIC8vIHRoZSBpZGVhIGlzIHRvIGF2b2lkIG1peGluZyBpbiBuYXRpdmUgcHJvdG90eXBlcywgc28gYWRkaW5nCiAgLy8gdGhlIHNlY29uZCB0ZXN0IGlzIFdMT0cKICB3aGlsZSAocCAhPT0gaW5OYXRpdmUgJiYgcCAhPT0gSFRNTFVua25vd25FbGVtZW50LnByb3RvdHlwZSkgewogICAgdmFyIGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwKTsKICAgIGZvciAodmFyIGk9MCwgazsgaz1rZXlzW2ldOyBpKyspIHsKICAgICAgaWYgKCF1c2VkW2tdKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGluVGFyZ2V0LCBrLAogICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHAsIGspKTsKICAgICAgICB1c2VkW2tdID0gMTsKICAgICAgfQogICAgfQogICAgcCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihwKTsKICB9Cn0KCmZ1bmN0aW9uIHJlYWR5KGluRWxlbWVudCkgewogIC8vIGludm9rZSByZWFkeUNhbGxiYWNrCiAgaWYgKGluRWxlbWVudC5yZWFkeUNhbGxiYWNrKSB7CiAgICBpbkVsZW1lbnQucmVhZHlDYWxsYmFjaygpOwogIH0KfQoKLy8gYXR0cmlidXRlIHdhdGNoaW5nCgpmdW5jdGlvbiBvdmVycmlkZUF0dHJpYnV0ZUFwaShwcm90b3R5cGUpIHsKICAvLyBvdmVycmlkZXMgdG8gaW1wbGVtZW50IGNhbGxiYWNrcwogIC8vIFRPRE8oc2ptaWxlcyk6IHNob3VsZCBzdXBwb3J0IGFjY2VzcyB2aWEgLmF0dHJpYnV0ZXMgTmFtZWROb2RlTWFwCiAgLy8gVE9ETyhzam1pbGVzKTogcHJlc2VydmVzIHVzZXIgZGVmaW5lZCBvdmVycmlkZXMsIGlmIGFueQogIHZhciBzZXRBdHRyaWJ1dGUgPSBwcm90b3R5cGUuc2V0QXR0cmlidXRlOwogIHByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgY2hhbmdlQXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIHNldEF0dHJpYnV0ZSk7CiAgfQogIHZhciByZW1vdmVBdHRyaWJ1dGUgPSBwcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlOwogIHByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgY2hhbmdlQXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIHJlbW92ZUF0dHJpYnV0ZSk7CiAgfQp9CgpmdW5jdGlvbiBjaGFuZ2VBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG9wZXJhdGlvbikgewogIHZhciBvbGRWYWx1ZSA9IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpOwogIG9wZXJhdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGlmICh0aGlzLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayAKICAgICAgJiYgKHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpICE9PSBvbGRWYWx1ZSkpIHsKICAgIHRoaXMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKG5hbWUsIG9sZFZhbHVlKTsKICB9Cn0KCi8vIGVsZW1lbnQgcmVnaXN0cnkgKG1hcHMgdGFnIG5hbWVzIHRvIGRlZmluaXRpb25zKQoKdmFyIHJlZ2lzdHJ5ID0ge307CgpmdW5jdGlvbiByZWdpc3RlckRlZmluaXRpb24oaW5OYW1lLCBpbkRlZmluaXRpb24pIHsKICByZWdpc3RyeVtpbk5hbWVdID0gaW5EZWZpbml0aW9uOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZUNvbnN0cnVjdG9yKGluRGVmaW5pdGlvbikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBpbnN0YW50aWF0ZShpbkRlZmluaXRpb24pOwogIH07Cn0KCmZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQoaW5UYWcpIHsKICB2YXIgZGVmaW5pdGlvbiA9IHJlZ2lzdHJ5W2luVGFnXTsKICBpZiAoZGVmaW5pdGlvbikgewogICAgcmV0dXJuIG5ldyBkZWZpbml0aW9uLmN0b3IoKTsKICB9CiAgcmV0dXJuIGRvbUNyZWF0ZUVsZW1lbnQoaW5UYWcpOwp9CgpmdW5jdGlvbiB1cGdyYWRlRWxlbWVudChpbkVsZW1lbnQpIHsKICBpZiAoIWluRWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgKGluRWxlbWVudC5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpKSB7CiAgICB2YXIgdHlwZSA9IGluRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgaW5FbGVtZW50LmxvY2FsTmFtZTsKICAgIHZhciBkZWZpbml0aW9uID0gcmVnaXN0cnlbdHlwZV07CiAgICByZXR1cm4gZGVmaW5pdGlvbiAmJiB1cGdyYWRlKGluRWxlbWVudCwgZGVmaW5pdGlvbik7CiAgfQp9CgpmdW5jdGlvbiBjbG9uZU5vZGUoZGVlcCkgewogIC8vIGNhbGwgb3JpZ2luYWwgY2xvbmUKICB2YXIgbiA9IGRvbUNsb25lTm9kZS5jYWxsKHRoaXMsIGRlZXApOwogIC8vIHVwZ3JhZGUgdGhlIGVsZW1lbnQgYW5kIHN1YnRyZWUKICBzY29wZS51cGdyYWRlQWxsKG4pOwogIHJldHVybiBuOwp9Ci8vIGNhcHR1cmUgbmF0aXZlIGNyZWF0ZUVsZW1lbnQgYmVmb3JlIHdlIG92ZXJyaWRlIGl0Cgp2YXIgZG9tQ3JlYXRlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQuYmluZChkb2N1bWVudCk7CgovLyBjYXB0dXJlIG5hdGl2ZSBjbG9uZU5vZGUgYmVmb3JlIHdlIG92ZXJyaWRlIGl0Cgp2YXIgZG9tQ2xvbmVOb2RlID0gTm9kZS5wcm90b3R5cGUuY2xvbmVOb2RlOwoKLy8gZXhwb3J0cwoKZG9jdW1lbnQucmVnaXN0ZXIgPSByZWdpc3RlcjsKZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQ7IC8vIG92ZXJyaWRlCk5vZGUucHJvdG90eXBlLmNsb25lTm9kZSA9IGNsb25lTm9kZTsgLy8gb3ZlcnJpZGUKCnNjb3BlLnJlZ2lzdHJ5ID0gcmVnaXN0cnk7CgovKioKICogVXBncmFkZSBhbiBlbGVtZW50IHRvIGEgY3VzdG9tIGVsZW1lbnQuIFVwZ3JhZGluZyBhbiBlbGVtZW50CiAqIGNhdXNlcyB0aGUgY3VzdG9tIHByb3RvdHlwZSB0byBiZSBhcHBsaWVkLCBhbiBgaXNgIGF0dHJpYnV0ZSAKICogdG8gYmUgYXR0YWNoZWQgKGFzIG5lZWRlZCksIGFuZCBpbnZvY2F0aW9uIG9mIHRoZSBgcmVhZHlDYWxsYmFja2AuCiAqIGB1cGdyYWRlYCBkb2VzIG5vdGhpbmcgaWYgdGhlIGVsZW1lbnQgaXMgYWxyZWFkeSB1cGdyYWRlZCwgb3IKICogaWYgaXQgbWF0Y2hlcyBubyByZWdpc3RlcmVkIGN1c3RvbSB0YWcgbmFtZS4KICoKICogQG1ldGhvZCB1Z3ByYWRlCiAqIEBwYXJhbSB7RWxlbWVudH0gaW5FbGVtZW50IFRoZSBlbGVtZW50IHRvIHVwZ3JhZGUuCiAqIEByZXR1cm4ge0VsZW1lbnR9IFRoZSB1cGdyYWRlZCBlbGVtZW50LgogKi8Kc2NvcGUudXBncmFkZSA9IHVwZ3JhZGVFbGVtZW50OwoKfQoKfSkod2luZG93LkN1c3RvbUVsZW1lbnRzKTsKCiAvKg0KQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4NClVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlDQpsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuDQoqLw0KDQooZnVuY3Rpb24oc2NvcGUpew0KDQovKg0KaWYgKEhUTUxFbGVtZW50LnByb3RvdHlwZS53ZWJraXRTaGFkb3dSb290KSB7DQogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShIVE1MRWxlbWVudC5wcm90b3R5cGUsICdzaGFkb3dSb290Jywgew0KICAgIGdldDogZnVuY3Rpb24oKSB7DQogICAgICByZXR1cm4gdGhpcy53ZWJraXRTaGFkb3dSb290Ow0KICAgIH0NCiAgfTsNCn0NCiovDQoNCi8vIHdhbGsgdGhlIHN1YnRyZWUgcm9vdGVkIGF0IG5vZGUsIGFwcGx5aW5nICdmaW5kKGVsZW1lbnQsIGRhdGEpJyBmdW5jdGlvbiANCi8vIHRvIGVhY2ggZWxlbWVudA0KLy8gaWYgJ2ZpbmQnIHJldHVybnMgdHJ1ZSBmb3IgJ2VsZW1lbnQnLCBkbyBub3Qgc2VhcmNoIGVsZW1lbnQncyBzdWJ0cmVlICANCmZ1bmN0aW9uIGZpbmRBbGwobm9kZSwgZmluZCwgZGF0YSkgew0KICB2YXIgZSA9IG5vZGUuZmlyc3RFbGVtZW50Q2hpbGQ7DQogIGlmICghZSkgew0KICAgIGUgPSBub2RlLmZpcnN0Q2hpbGQ7DQogICAgd2hpbGUgKGUgJiYgZS5ub2RlVHlwZSAhPT0gTm9kZS5FTEVNRU5UX05PREUpIHsNCiAgICAgIGUgPSBlLm5leHRTaWJsaW5nOw0KICAgIH0NCiAgfQ0KICB3aGlsZSAoZSkgew0KICAgIGlmIChmaW5kKGUsIGRhdGEpICE9PSB0cnVlKSB7DQogICAgICBmaW5kQWxsKGUsIGZpbmQsIGRhdGEpOw0KICAgIH0NCiAgICBlID0gZS5uZXh0RWxlbWVudFNpYmxpbmc7DQogIH0NCiAgcmV0dXJuIG51bGw7DQp9DQoNCi8vIHdhbGsgdGhlIHN1YnRyZWUgcm9vdGVkIGF0IG5vZGUsIGluY2x1ZGluZyBkZXNjZW50IGludG8gc2hhZG93LXJvb3RzLCANCi8vIGFwcGx5aW5nICdjYicgdG8gZWFjaCBlbGVtZW50DQpmdW5jdGlvbiBmb3JTdWJ0cmVlKG5vZGUsIGNiKSB7DQogIC8vbG9nRmxhZ3MuZG9tICYmIG5vZGUuY2hpbGROb2RlcyAmJiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoICYmIGNvbnNvbGUuZ3JvdXAoJ3N1YlRyZWU6ICcsIG5vZGUpOw0KICBmaW5kQWxsKG5vZGUsIGZ1bmN0aW9uKGUpIHsNCiAgICBpZiAoY2IoZSkpIHsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICBpZiAoZS53ZWJraXRTaGFkb3dSb290KSB7DQogICAgICBmb3JTdWJ0cmVlKGUud2Via2l0U2hhZG93Um9vdCwgY2IpOw0KICAgIH0NCiAgfSk7DQogIGlmIChub2RlLndlYmtpdFNoYWRvd1Jvb3QpIHsNCiAgICBmb3JTdWJ0cmVlKG5vZGUud2Via2l0U2hhZG93Um9vdCwgY2IpOw0KICB9DQogIC8vbG9nRmxhZ3MuZG9tICYmIG5vZGUuY2hpbGROb2RlcyAmJiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCn0NCg0KLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlDQpmdW5jdGlvbiBhZGRlZChub2RlKSB7DQogIGlmICh1cGdyYWRlKG5vZGUpKSB7DQogICAgaW5zZXJ0ZWROb2RlKG5vZGUpOw0KICAgIHJldHVybiB0cnVlOyANCiAgfQ0KICBpbnNlcnRlZChub2RlKTsNCn0NCg0KLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlJ3Mgc3VidHJlZSBvbmx5DQpmdW5jdGlvbiBhZGRlZFN1YnRyZWUobm9kZSkgew0KICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsNCiAgICBpZiAoYWRkZWQoZSkpIHsNCiAgICAgIHJldHVybiB0cnVlOyANCiAgICB9DQogIH0pOw0KfQ0KDQovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUgYW5kIGl0J3Mgc3VidHJlZQ0KZnVuY3Rpb24gYWRkZWROb2RlKG5vZGUpIHsNCiAgcmV0dXJuIGFkZGVkKG5vZGUpIHx8IGFkZGVkU3VidHJlZShub2RlKTsNCn0NCg0KLy8gdXBncmFkZSBjdXN0b20gZWxlbWVudHMgYXQgbm9kZSwgaWYgYXBwbGljYWJsZQ0KZnVuY3Rpb24gdXBncmFkZShub2RlKSB7DQogIGlmICghbm9kZS5fX3VwZ3JhZGVkX18gJiYgbm9kZS5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpIHsNCiAgICB2YXIgdHlwZSA9IG5vZGUuZ2V0QXR0cmlidXRlKCdpcycpIHx8IG5vZGUubG9jYWxOYW1lOw0KICAgIHZhciBkZWZpbml0aW9uID0gc2NvcGUucmVnaXN0cnlbdHlwZV07DQogICAgaWYgKGRlZmluaXRpb24pIHsNCiAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCd1cGdyYWRlOicsIG5vZGUubG9jYWxOYW1lKTsNCiAgICAgIHNjb3BlLnVwZ3JhZGUobm9kZSk7DQogICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOw0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICB9DQp9DQoNCmZ1bmN0aW9uIGluc2VydGVkTm9kZShub2RlKSB7DQogIGluc2VydGVkKG5vZGUpOw0KICBpZiAoaW5Eb2N1bWVudChub2RlKSkgew0KICAgIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgICAgaW5zZXJ0ZWQoZSk7DQogICAgfSk7DQogIH0NCn0NCg0KLy8gVE9ETyhzam1pbGVzKTogaWYgdGhlcmUgYXJlIGRlc2NlbnRzIGludG8gdHJlZXMgdGhhdCBjYW4gbmV2ZXIgaGF2ZSBpbkRvY3VtZW50KCopIHRydWUsIGZpeCB0aGlzDQoNCmZ1bmN0aW9uIGluc2VydGVkKGVsZW1lbnQpIHsNCiAgLy8gVE9ETyhzam1pbGVzKTogaXQncyBwb3NzaWJsZSB3ZSB3ZXJlIGluc2VydGVkIGFuZCByZW1vdmVkIGluIHRoZSBzcGFjZQ0KICAvLyBvZiBvbmUgbWljcm90YXNrLCBpbiB3aGljaCBjYXNlIHdlIHdvbid0IGJlICdpbkRvY3VtZW50JyBoZXJlDQogIC8vIEJ1dCB0aGVyZSBhcmUgb3RoZXIgY2FzZXMgd2hlcmUgd2UgYXJlIHRlc3RpbmcgZm9yIGluc2VydGVkIHdpdGhvdXQNCiAgLy8gc3BlY2lmaWMga25vd2xlZGdlIG9mIG11dGF0aW9ucywgYW5kIG11c3QgdGVzdCAnaW5Eb2N1bWVudCcgdG8gZGV0ZXJtaW5lDQogIC8vIHdoZXRoZXIgdG8gY2FsbCBpbnNlcnRlZA0KICAvLyBJZiB3ZSBjYW4gZmFjdG9yIHRoZXNlIGNhc2VzIGludG8gc2VwYXJhdGUgY29kZSBwYXRocyB3ZSBjYW4gaGF2ZQ0KICAvLyBiZXR0ZXIgZGlhZ25vc3RpY3MuDQogIC8vIFRPRE8oc2ptaWxlcyk6IHdoZW4gbG9nZ2luZywgZG8gd29yayBvbiBhbGwgY3VzdG9tIGVsZW1lbnRzIHNvIHdlIGNhbg0KICAvLyB0cmFjayBiZWhhdmlvciBldmVuIHdoZW4gY2FsbGJhY2tzIG5vdCBkZWZpbmVkDQogIC8vY29uc29sZS5sb2coJ2luc2VydGVkOiAnLCBlbGVtZW50LmxvY2FsTmFtZSk7DQogIGlmIChlbGVtZW50Lmluc2VydGVkQ2FsbGJhY2sgfHwgKGVsZW1lbnQuX191cGdyYWRlZF9fICYmIGxvZ0ZsYWdzLmRvbSkpIHsNCiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgnaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOw0KICAgIGlmIChpbkRvY3VtZW50KGVsZW1lbnQpKSB7DQogICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAoZWxlbWVudC5fX2luc2VydGVkIHx8IDApICsgMTsNCiAgICAgIC8vIGlmIHdlIGFyZSBpbiBhICdyZW1vdmVkJyBzdGF0ZSwgYmx1bnRseSBhZGp1c3QgdG8gYW4gJ2luc2VydGVkJyBzdGF0ZQ0KICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA8IDEpIHsNCiAgICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gMTsNCiAgICAgIH0NCiAgICAgIC8vIGlmIHdlIGFyZSAnb3ZlciBpbnNlcnRlZCcsIHNxdWVsY2ggdGhlIGNhbGxiYWNrDQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkID4gMSkgew0KICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS53YXJuKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSwNCiAgICAgICAgICAnaW5zZXJ0L3JlbW92ZSBjb3VudDonLCBlbGVtZW50Ll9faW5zZXJ0ZWQpDQogICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuaW5zZXJ0ZWRDYWxsYmFjaykgew0KICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsNCiAgICAgICAgZWxlbWVudC5pbnNlcnRlZENhbGxiYWNrKCk7DQogICAgICB9DQogICAgfQ0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQogIH0NCn0NCg0KZnVuY3Rpb24gcmVtb3ZlZE5vZGUobm9kZSkgew0KICByZW1vdmVkKG5vZGUpOw0KICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsNCiAgICByZW1vdmVkKGUpOw0KICB9KTsNCn0NCg0KZnVuY3Rpb24gcmVtb3ZlZChlbGVtZW50KSB7DQogIC8vIFRPRE8oc2ptaWxlcyk6IHRlbXBvcmFyeTogZG8gd29yayBvbiBhbGwgY3VzdG9tIGVsZW1lbnRzIHNvIHdlIGNhbiB0cmFjaw0KICAvLyBiZWhhdmlvciBldmVuIHdoZW4gY2FsbGJhY2tzIG5vdCBkZWZpbmVkDQogIGlmIChlbGVtZW50LnJlbW92ZWRDYWxsYmFjayB8fCAoZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgbG9nRmxhZ3MuZG9tKSkgew0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygncmVtb3ZlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7DQogICAgaWYgKCFpbkRvY3VtZW50KGVsZW1lbnQpKSB7DQogICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAoZWxlbWVudC5fX2luc2VydGVkIHx8IDApIC0gMTsNCiAgICAgIC8vIGlmIHdlIGFyZSBpbiBhICdpbnNlcnRlZCcgc3RhdGUsIGJsdW50bHkgYWRqdXN0IHRvIGFuICdyZW1vdmVkJyBzdGF0ZQ0KICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA+IDApIHsNCiAgICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gMDsNCiAgICAgIH0NCiAgICAgIC8vIGlmIHdlIGFyZSAnb3ZlciByZW1vdmVkJywgc3F1ZWxjaCB0aGUgY2FsbGJhY2sNCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPCAwKSB7DQogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLndhcm4oJ3JlbW92ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUsDQogICAgICAgICAgICAnaW5zZXJ0L3JlbW92ZSBjb3VudDonLCBlbGVtZW50Ll9faW5zZXJ0ZWQpDQogICAgICB9IGVsc2UgaWYgKGVsZW1lbnQucmVtb3ZlZENhbGxiYWNrKSB7DQogICAgICAgIGVsZW1lbnQucmVtb3ZlZENhbGxiYWNrKCk7DQogICAgICB9DQogICAgfQ0KICB9DQp9DQoNCmZ1bmN0aW9uIGluRG9jdW1lbnQoZWxlbWVudCkgew0KICB2YXIgcCA9IGVsZW1lbnQ7DQogIHdoaWxlIChwKSB7DQogICAgaWYgKHAgPT0gZWxlbWVudC5vd25lckRvY3VtZW50KSB7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogICAgcCA9IHAucGFyZW50Tm9kZSB8fCBwLmhvc3Q7DQogIH0NCn0NCg0KZnVuY3Rpb24gd2F0Y2hTaGFkb3cobm9kZSkgew0KICBpZiAobm9kZS53ZWJraXRTaGFkb3dSb290ICYmICFub2RlLndlYmtpdFNoYWRvd1Jvb3QuX193YXRjaGVkKSB7DQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCd3YXRjaGluZyBzaGFkb3ctcm9vdCBmb3I6ICcsIG5vZGUubG9jYWxOYW1lKTsNCiAgICBvYnNlcnZlKG5vZGUud2Via2l0U2hhZG93Um9vdCk7DQogICAgbm9kZS53ZWJraXRTaGFkb3dSb290Ll9fd2F0Y2hlZCA9IHRydWU7DQogIH0NCn0NCg0KZnVuY3Rpb24gd2F0Y2hBbGxTaGFkb3dzKG5vZGUpIHsNCiAgd2F0Y2hTaGFkb3cobm9kZSk7DQogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgIHdhdGNoU2hhZG93KG5vZGUpOw0KICB9KTsNCn0NCg0KZnVuY3Rpb24gZmlsdGVyKGluTm9kZSkgew0KICBzd2l0Y2ggKGluTm9kZS5sb2NhbE5hbWUpIHsNCiAgICBjYXNlICdzdHlsZSc6DQogICAgY2FzZSAnc2NyaXB0JzoNCiAgICBjYXNlICd0ZW1wbGF0ZSc6DQogICAgY2FzZSB1bmRlZmluZWQ6DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiBoYW5kbGVyKG11dGF0aW9ucykgew0KICAvLw0KICBpZiAobG9nRmxhZ3MuZG9tKSB7DQogICAgdmFyIG14ID0gbXV0YXRpb25zWzBdOw0KICAgIGlmIChteCAmJiBteC50eXBlID09PSAnY2hpbGRMaXN0JyAmJiBteC5hZGRlZE5vZGVzKSB7DQogICAgICAgIGlmIChteC5hZGRlZE5vZGVzKSB7DQogICAgICAgICAgdmFyIGQgPSBteC5hZGRlZE5vZGVzWzBdOw0KICAgICAgICAgIHdoaWxlIChkICYmIGQgIT09IGRvY3VtZW50ICYmICFkLmhvc3QpIHsNCiAgICAgICAgICAgIGQgPSBkLnBhcmVudE5vZGU7DQogICAgICAgICAgfQ0KICAgICAgICAgIHZhciB1ID0gZCAmJiAoZC5VUkwgfHwgZC5fVVJMIHx8IChkLmhvc3QgJiYgZC5ob3N0LmxvY2FsTmFtZSkpIHx8ICcnOw0KICAgICAgICAgIHUgPSB1LnNwbGl0KCcvPycpLnNoaWZ0KCkuc3BsaXQoJy8nKS5wb3AoKTsNCiAgICAgICAgfQ0KICAgIH0NCiAgICBjb25zb2xlLmdyb3VwKCdtdXRhdGlvbnMgKCVkKSBbJXNdJywgbXV0YXRpb25zLmxlbmd0aCwgdSB8fCAnJyk7DQogIH0NCiAgLy8NCiAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24obXgpIHsNCiAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCdtdXRhdGlvbicpOw0KICAgIGlmIChteC50eXBlID09PSAnY2hpbGRMaXN0Jykgew0KICAgICAgZm9yRWFjaChteC5hZGRlZE5vZGVzLCBmdW5jdGlvbihuKSB7DQogICAgICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKG4ubG9jYWxOYW1lKTsNCiAgICAgICAgaWYgKGZpbHRlcihuKSkgew0KICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KICAgICAgICAvLyB3YXRjaCBzaGFkb3ctcm9vdHMgb24gbm9kZXMgdGhhdCBoYXZlIGhhZCB0aGVtIGF0dGFjaGVkIG1hbnVhbGx5DQogICAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlbW92ZSBpZiBjcmVhdGVTaGFkb3dSb290IGlzIG92ZXJyaWRkZW4NCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVtb3ZlZCBhcyBhbiBvcHRpbWl6YXRpb24sIG1hbnVhbCBzaGFkb3cgcm9vdHMNCiAgICAgICAgLy8gbXVzdCBiZSB3YXRjaGVkIGV4cGxpY2l0bHkNCiAgICAgICAgLy93YXRjaEFsbFNoYWRvd3Mobik7DQogICAgICAgIC8vIG5vZGVzIGFkZGVkIG1heSBuZWVkIGxpZmVjeWNsZSBtYW5hZ2VtZW50DQogICAgICAgIGFkZGVkTm9kZShuKTsNCiAgICAgIH0pOw0KICAgICAgLy8gcmVtb3ZlZCBub2RlcyBtYXkgbmVlZCBsaWZlY3ljbGUgbWFuYWdlbWVudA0KICAgICAgZm9yRWFjaChteC5yZW1vdmVkTm9kZXMsIGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2cobi5sb2NhbE5hbWUpOw0KICAgICAgICBpZiAoZmlsdGVyKG4pKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIHJlbW92ZWROb2RlKG4pOw0KICAgICAgfSk7DQogICAgfQ0KICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCiAgfSk7DQogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQp9Ow0KDQp2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihoYW5kbGVyKTsNCg0KZnVuY3Rpb24gdGFrZVJlY29yZHMoKSB7DQogIC8vIFRPRE8oc2ptaWxlcyk6IGFzayBSYWYgd2h5IHdlIGhhdmUgdG8gY2FsbCBoYW5kbGVyIG91cnNlbHZlcw0KICBoYW5kbGVyKG9ic2VydmVyLnRha2VSZWNvcmRzKCkpOw0KfQ0KDQp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7DQoNCmZ1bmN0aW9uIG9ic2VydmUoaW5Sb290KSB7DQogIG9ic2VydmVyLm9ic2VydmUoaW5Sb290LCB7Y2hpbGRMaXN0OiB0cnVlLCBzdWJ0cmVlOiB0cnVlfSk7DQp9DQoNCmZ1bmN0aW9uIG9ic2VydmVEb2N1bWVudChkb2N1bWVudCkgew0KICBvYnNlcnZlKGRvY3VtZW50KTsNCn0NCg0KZnVuY3Rpb24gdXBncmFkZURvY3VtZW50KGRvY3VtZW50KSB7DQogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCd1cGdyYWRlRG9jdW1lbnQ6ICcsIChkb2N1bWVudC5VUkwgfHwgZG9jdW1lbnQuX1VSTCB8fCAnJykuc3BsaXQoJy8nKS5wb3AoKSk7DQogIGFkZGVkTm9kZShkb2N1bWVudCk7DQogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQp9DQoNCi8vIGV4cG9ydHMNCg0Kc2NvcGUud2F0Y2hTaGFkb3cgPSB3YXRjaFNoYWRvdzsNCnNjb3BlLndhdGNoQWxsU2hhZG93cyA9IHdhdGNoQWxsU2hhZG93czsNCg0Kc2NvcGUudXBncmFkZUFsbCA9IGFkZGVkTm9kZTsNCnNjb3BlLnVwZ3JhZGVTdWJ0cmVlID0gYWRkZWRTdWJ0cmVlOw0KDQpzY29wZS5vYnNlcnZlRG9jdW1lbnQgPSBvYnNlcnZlRG9jdW1lbnQ7DQpzY29wZS51cGdyYWRlRG9jdW1lbnQgPSB1cGdyYWRlRG9jdW1lbnQ7DQoNCnNjb3BlLnRha2VSZWNvcmRzID0gdGFrZVJlY29yZHM7DQoNCn0pKHdpbmRvdy5DdXN0b21FbGVtZW50cyk7DQoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbigpewoKdmFyIEhUTUxFbGVtZW50RWxlbWVudCA9IGZ1bmN0aW9uKGluRWxlbWVudCkgewogIGluRWxlbWVudC5yZWdpc3RlciA9IEhUTUxFbGVtZW50RWxlbWVudC5wcm90b3R5cGUucmVnaXN0ZXI7CiAgcGFyc2VFbGVtZW50RWxlbWVudChpbkVsZW1lbnQpOwogIHJldHVybiBpbkVsZW1lbnQ7Cn07CgpIVE1MRWxlbWVudEVsZW1lbnQucHJvdG90eXBlID0gewogIHJlZ2lzdGVyOiBmdW5jdGlvbihpbk1vcmUpIHsKICAgIGlmIChpbk1vcmUpIHsKICAgICAgdGhpcy5vcHRpb25zLmxpZmVjeWNsZSA9IGluTW9yZS5saWZlY3ljbGU7CiAgICAgIGlmIChpbk1vcmUucHJvdG90eXBlKSB7CiAgICAgICAgbWl4aW4odGhpcy5vcHRpb25zLnByb3RvdHlwZSwgaW5Nb3JlLnByb3RvdHlwZSk7CiAgICAgIH0KICAgIH0KICB9Cn07CgpmdW5jdGlvbiBwYXJzZUVsZW1lbnRFbGVtZW50KGluRWxlbWVudCkgewogIC8vIG9wdGlvbnMgdG8gZ2xlYW4gZnJvbSBpbkVsZW1lbnQgYXR0cmlidXRlcwogIHZhciBvcHRpb25zID0gewogICAgbmFtZTogJycsCiAgICBleHRlbmRzOiBudWxsCiAgfTsKICAvLyBnbGVhbiB0aGVtCiAgdGFrZUF0dHJpYnV0ZXMoaW5FbGVtZW50LCBvcHRpb25zKTsKICAvLyBkZWZhdWx0IGJhc2UKICB2YXIgYmFzZSA9IEhUTUxFbGVtZW50LnByb3RvdHlwZTsKICAvLyBvcHRpb25hbCBzcGVjaWZpZWQgYmFzZQogIGlmIChvcHRpb25zLmV4dGVuZHMpIHsKICAgIC8vIGJ1aWxkIGFuIGluc3RhbmNlIG9mIG9wdGlvbnMuZXh0ZW5kcwogICAgdmFyIGFyY2hldHlwZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQob3B0aW9ucy5leHRlbmRzKTsKICAgIC8vIGFjcXVpcmUgdGhlIHByb3RvdHlwZQogICAgLy8gVE9ETyhzam1pbGVzKTogX19wcm90b19fIG1heSBiZSBoaW50ZWQgYnkgdGhlIGN1c3RvbSBlbGVtZW50CiAgICAvLyBzeXN0ZW0gb24gcGxhdGZvcm1zIHRoYXQgZG9uJ3Qgc3VwcG9ydCBuYXRpdmUgX19wcm90b19fCiAgICAvLyBvbiB0aG9zZSBwbGF0Zm9ybXMgdGhlIEFQSSBpcyBtaXhlZCBpbnRvIGFyY2hldHlwZSBhbmQgdGhlCiAgICAvLyBlZmZlY3RpdmUgYmFzZSBpcyBub3QgYXJjaGV0eXBlJ3MgcmVhbCBwcm90b3R5cGUKICAgIGJhc2UgPSBhcmNoZXR5cGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihhcmNoZXR5cGUpOwogIH0KICAvLyBleHRlbmQgYmFzZQogIG9wdGlvbnMucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShiYXNlKTsKICAvLyBpbnN0YWxsIG9wdGlvbnMKICBpbkVsZW1lbnQub3B0aW9ucyA9IG9wdGlvbnM7CiAgLy8gbG9jYXRlIHVzZXIgc2NyaXB0CiAgdmFyIHNjcmlwdCA9IGluRWxlbWVudC5xdWVyeVNlbGVjdG9yKCdzY3JpcHQ6bm90KFt0eXBlXSksc2NyaXB0W3R5cGU9InRleHQvamF2YXNjcmlwdCJdLHNjcmlwdHMnKTsKICBpZiAoc2NyaXB0KSB7CiAgICAvLyBleGVjdXRlIHVzZXIgc2NyaXB0IGluICdpbkVsZW1lbnQnIGNvbnRleHQKICAgIGV4ZWN1dGVDb21wb25lbnRTY3JpcHQoc2NyaXB0LnRleHRDb250ZW50LCBpbkVsZW1lbnQsIG9wdGlvbnMubmFtZSk7CiAgfTsKICAvLyByZWdpc3RlciBvdXIgbmV3IGVsZW1lbnQKICB2YXIgY3RvciA9IGRvY3VtZW50LnJlZ2lzdGVyKG9wdGlvbnMubmFtZSwgb3B0aW9ucyk7CiAgaW5FbGVtZW50LmN0b3IgPSBjdG9yOwogIC8vIHN0b3JlIG9wdGlvbmFsIGNvbnN0cnVjdG9yIHJlZmVyZW5jZQogIHZhciByZWZOYW1lID0gaW5FbGVtZW50LmdldEF0dHJpYnV0ZSgnY29uc3RydWN0b3InKTsKICBpZiAocmVmTmFtZSkgewogICAgd2luZG93W3JlZk5hbWVdID0gY3RvcjsKICB9Cn0KCi8vIGVhY2ggcHJvcGVydHkgaW4gaW5EaWN0aW9uYXJ5IHRha2VzIGEgdmFsdWUKLy8gZnJvbSB0aGUgbWF0Y2hpbmcgYXR0cmlidXRlIGluIGluRWxlbWVudCwgaWYgYW55CmZ1bmN0aW9uIHRha2VBdHRyaWJ1dGVzKGluRWxlbWVudCwgaW5EaWN0aW9uYXJ5KSB7CiAgZm9yICh2YXIgbiBpbiBpbkRpY3Rpb25hcnkpIHsKICAgIHZhciBhID0gaW5FbGVtZW50LmF0dHJpYnV0ZXNbbl07CiAgICBpZiAoYSkgewogICAgICBpbkRpY3Rpb25hcnlbbl0gPSBhLnZhbHVlOwogICAgfQogIH0KfQoKLy8gaW52b2tlIGluU2NyaXB0IGluIGluQ29udGV4dCBzY29wZQpmdW5jdGlvbiBleGVjdXRlQ29tcG9uZW50U2NyaXB0KGluU2NyaXB0LCBpbkNvbnRleHQsIGluTmFtZSkgewogIC8vIHNldCAoaGlnaGxhbmRlcikgY29udGV4dAogIGNvbnRleHQgPSBpbkNvbnRleHQ7CiAgLy8gc291cmNlIGxvY2F0aW9uCiAgdmFyIG93bmVyID0gY29udGV4dC5vd25lckRvY3VtZW50OwogIHZhciB1cmwgPSAob3duZXIuX1VSTCB8fCBvd25lci5VUkwgfHwgb3duZXIuaW1wbAogICAgICAmJiAob3duZXIuaW1wbC5fVVJMIHx8IG93bmVyLmltcGwuVVJMKSk7CiAgLy8gZW5zdXJlIHRoZSBjb21wb25lbnQgaGFzIGEgdW5pcXVlIHNvdXJjZSBtYXAgc28gaXQgY2FuIGJlIGRlYnVnZ2VkCiAgLy8gaWYgdGhlIG5hbWUgbWF0Y2hlcyB0aGUgZmlsZW5hbWUgcGFydCBvZiB0aGUgb3duaW5nIGRvY3VtZW50J3MgdXJsLAogIC8vIHVzZSB0aGlzLCBvdGhlcndpc2UsIGFkZCAiOjxuYW1lPiIgdG8gdGhlIGRvY3VtZW50IHVybC4KICB2YXIgbWF0Y2ggPSB1cmwubWF0Y2goLy4qXC8oW14uXSopWy5dPy4qJC8pOwogIGlmIChtYXRjaCkgewogICAgdmFyIG5hbWUgPSBtYXRjaFsxXTsKICAgIHVybCArPSBuYW1lICE9IGluTmFtZSA/ICc6JyArIGluTmFtZSA6ICcnOwogIH0KICAvLyBjb21wb3NlIHNjcmlwdAogIHZhciBjb2RlID0gIl9fY29tcG9uZW50U2NyaXB0KCciCiAgICArIGluTmFtZQogICAgKyAiJywgZnVuY3Rpb24oKXsiCiAgICArIGluU2NyaXB0CiAgICArICJ9KTsiCiAgICArICJcbi8vIyBzb3VyY2VVUkw9IiArIHVybCArICJcbiIKICA7CiAgLy8gaW5qZWN0IHNjcmlwdAogIGV2YWwoY29kZSk7Cn0KCnZhciBjb250ZXh0OwoKLy8gZ2xvYmFsIG5lY2Vzc2FyeSBmb3Igc2NyaXB0IGluamVjdGlvbgp3aW5kb3cuX19jb21wb25lbnRTY3JpcHQgPSBmdW5jdGlvbihpbk5hbWUsIGluRnVuYykgewogIGluRnVuYy5jYWxsKGNvbnRleHQpOwp9OwoKLy8gdXRpbGl0eQoKLy8gY29weSB0b3AgbGV2ZWwgcHJvcGVydGllcyBmcm9tIHByb3BzIHRvIG9iagpmdW5jdGlvbiBtaXhpbihvYmosIHByb3BzKSB7CiAgb2JqID0gb2JqIHx8IHt9OwogIHRyeSB7CiAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm9wcykuZm9yRWFjaChmdW5jdGlvbihuKSB7CiAgICAgIHZhciBwZCA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocHJvcHMsIG4pOwogICAgICBpZiAocGQpIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBuLCBwZCk7CiAgICAgIH0KICAgIH0pOwogIH0gY2F0Y2goeCkgewogIH0KICByZXR1cm4gb2JqOwp9CgovLyBleHBvcnRzCgp3aW5kb3cuSFRNTEVsZW1lbnRFbGVtZW50ID0gSFRNTEVsZW1lbnRFbGVtZW50OwoKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oc2NvcGUpIHsKCmlmICghc2NvcGUpIHsKICBzY29wZSA9IHdpbmRvdy5IVE1MSW1wb3J0cyA9IHtmbGFnczp7fX07Cn0KCi8vIGltcG9ydHMKCnZhciB4aHIgPSBzY29wZS54aHI7CgovLyBpbXBvcnRlcgoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSAnaW1wb3J0JzsKdmFyIFNUWUxFX0xJTktfVFlQRSA9ICdzdHlsZXNoZWV0JzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IHJlcHJlc2VudHMgYSBwcmltYXJ5IGRvY3VtZW50ICh0aGUgYXJndW1lbnQgdG8gJ2xvYWQnKQovLyBhdCB0aGUgcm9vdCBvZiBhIHRyZWUgb2YgZG9jdW1lbnRzCgovLyBmb3IgYW55IGRvY3VtZW50LCBpbXBvcnRlcjoKLy8gLSBsb2FkcyBhbnkgbGlua2VkIGRvY3VtZW50cyAod2l0aCBkZWR1cGluZyksIG1vZGlmaWVzIHBhdGhzIGFuZCBmZWVkcyB0aGVtIGJhY2sgaW50byBpbXBvcnRlcgovLyAtIGxvYWRzIHRleHQgb2YgZXh0ZXJuYWwgc2NyaXB0IHRhZ3MKLy8gLSBsb2FkcyB0ZXh0IG9mIGV4dGVybmFsIHN0eWxlIHRhZ3MgaW5zaWRlIG9mIDxlbGVtZW50PiwgbW9kaWZpZXMgcGF0aHMKCi8vIHdoZW4gaW1wb3J0ZXIgJ21vZGlmaWVzIHBhdGhzJyBpbiBhIGRvY3VtZW50LCB0aGlzIGluY2x1ZGVzCi8vIC0gaHJlZi9zcmMvYWN0aW9uIGluIG5vZGUgYXR0cmlidXRlcwovLyAtIHBhdGhzIGluIGlubGluZSBzdHlsZXNoZWV0cwovLyAtIGFsbCBjb250ZW50IGluc2lkZSB0ZW1wbGF0ZXMKCi8vIGxpbmtlZCBzdHlsZSBzaGVldHMgaW4gYW4gaW1wb3J0IGhhdmUgdGhlaXIgb3duIHBhdGggZml4ZWQgdXAgd2hlbiB0aGVpciBjb250YWluaW5nIGltcG9ydCBtb2RpZmllcyBwYXRocwovLyBsaW5rZWQgc3R5bGUgc2hlZXRzIGluIGFuIDxlbGVtZW50PiBhcmUgbG9hZGVkLCBhbmQgdGhlIGNvbnRlbnQgZ2V0cyBwYXRoIGZpeHVwcwovLyBpbmxpbmUgc3R5bGUgc2hlZXRzIGdldCBwYXRoIGZpeHVwcyB3aGVuIHRoZWlyIGNvbnRhaW5pbmcgaW1wb3J0IG1vZGlmaWVzIHBhdGhzCgp2YXIgaW1wb3J0ZXIgPSB7CiAgZG9jdW1lbnRzOiB7fSwKICBjYWNoZToge30sCiAgcHJlbG9hZFNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nLAogICAgJ2VsZW1lbnQgbGlua1tyZWw9JyArIFNUWUxFX0xJTktfVFlQRSArICddJywKICAgICd0ZW1wbGF0ZScsCiAgICAnc2NyaXB0W3NyY10nLAogICAgJ3NjcmlwdDpub3QoW3R5cGVdKScsCiAgICAnc2NyaXB0W3R5cGU9InRleHQvamF2YXNjcmlwdCJdJwogIF0uam9pbignLCcpLAogIGxvYWRlcjogZnVuY3Rpb24oaW5OZXh0KSB7CiAgICAvLyBjb25zdHJ1Y3QgYSBsb2FkZXIgaW5zdGFuY2UKICAgIGxvYWRlciA9IG5ldyBMb2FkZXIoaW1wb3J0ZXIubG9hZGVkLCBpbk5leHQpOwogICAgLy8gYWxpYXMgdGhlIGxvYWRlciBjYWNoZSAoZm9yIGRlYnVnZ2luZykKICAgIGxvYWRlci5jYWNoZSA9IGltcG9ydGVyLmNhY2hlOwogICAgcmV0dXJuIGxvYWRlcjsKICB9LAogIGxvYWQ6IGZ1bmN0aW9uKGluRG9jdW1lbnQsIGluTmV4dCkgewogICAgLy8gY29uc3RydWN0IGEgbG9hZGVyIGluc3RhbmNlCiAgICBsb2FkZXIgPSBpbXBvcnRlci5sb2FkZXIoaW5OZXh0KTsKICAgIC8vIGFkZCBub2RlcyBmcm9tIGRvY3VtZW50IGludG8gbG9hZGVyIHF1ZXVlCiAgICBpbXBvcnRlci5wcmVsb2FkKGluRG9jdW1lbnQpOwogIH0sCiAgcHJlbG9hZDogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgLy8gYWxsIHByZWxvYWRhYmxlIG5vZGVzIGluIGluRG9jdW1lbnQKICAgIHZhciBub2RlcyA9IGluRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChpbXBvcnRlci5wcmVsb2FkU2VsZWN0b3JzKTsKICAgIC8vIGZyb20gdGhlIG1haW4gZG9jdW1lbnQsIG9ubHkgbG9hZCBpbXBvcnRzCiAgICAvLyBUT0RPKHNqbWlsZXMpOiBkbyB0aGlzIGJ5IGFsdGVyaW5nIHRoZSBzZWxlY3RvciBsaXN0IGluc3RlYWQKICAgIG5vZGVzID0gdGhpcy5maWx0ZXJNYWluRG9jdW1lbnROb2RlcyhpbkRvY3VtZW50LCBub2Rlcyk7CiAgICAvLyBleHRyYSBsaW5rIG5vZGVzIGZyb20gdGVtcGxhdGVzLCBmaWx0ZXIgdGVtcGxhdGVzIG91dCBvZiB0aGUgbm9kZXMgbGlzdAogICAgbm9kZXMgPSB0aGlzLmV4dHJhY3RUZW1wbGF0ZU5vZGVzKG5vZGVzKTsKICAgIC8vIGFkZCB0aGVzZSBub2RlcyB0byBsb2FkZXIncyBxdWV1ZQogICAgbG9hZGVyLmFkZE5vZGVzKG5vZGVzKTsKICB9LAogIGZpbHRlck1haW5Eb2N1bWVudE5vZGVzOiBmdW5jdGlvbihpbkRvY3VtZW50LCBub2RlcykgewogICAgaWYgKGluRG9jdW1lbnQgPT09IGRvY3VtZW50KSB7CiAgICAgIG5vZGVzID0gQXJyYXkucHJvdG90eXBlLmZpbHRlci5jYWxsKG5vZGVzLCBmdW5jdGlvbihuKSB7CiAgICAgICAgcmV0dXJuICFpc1NjcmlwdChuKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbm9kZXM7CiAgfSwKICBleHRyYWN0VGVtcGxhdGVOb2RlczogZnVuY3Rpb24obm9kZXMpIHsKICAgIHZhciBleHRyYSA9IFtdOwogICAgbm9kZXMgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgaWYgKG4ubG9jYWxOYW1lID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgaWYgKG4uY29udGVudCkgewogICAgICAgICAgdmFyIGwkID0gbi5jb250ZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2xpbmtbcmVsPScgKyBTVFlMRV9MSU5LX1RZUEUgKwogICAgICAgICAgICAnXScpOwogICAgICAgICAgaWYgKGwkLmxlbmd0aCkgewogICAgICAgICAgICBleHRyYSA9IGV4dHJhLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChsJCwgMCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICAgIGlmIChleHRyYS5sZW5ndGgpIHsKICAgICAgbm9kZXMgPSBub2Rlcy5jb25jYXQoZXh0cmEpOwogICAgfQogICAgcmV0dXJuIG5vZGVzOwogIH0sCiAgbG9hZGVkOiBmdW5jdGlvbih1cmwsIGVsdCwgcmVzb3VyY2UpIHsKICAgIGlmIChpc0RvY3VtZW50TGluayhlbHQpKSB7CiAgICAgIHZhciBkb2N1bWVudCA9IGltcG9ydGVyLmRvY3VtZW50c1t1cmxdOwogICAgICAvLyBpZiB3ZSd2ZSBuZXZlciBzZWVuIGEgZG9jdW1lbnQgYXQgdGhpcyB1cmwKICAgICAgaWYgKCFkb2N1bWVudCkgewogICAgICAgIC8vIGdlbmVyYXRlIGFuIEhUTUxEb2N1bWVudCBmcm9tIGRhdGEKICAgICAgICBkb2N1bWVudCA9IG1ha2VEb2N1bWVudChyZXNvdXJjZSwgdXJsKTsKICAgICAgICAvLyByZXNvbHZlIHJlc291cmNlIHBhdGhzIHJlbGF0aXZlIHRvIGhvc3QgZG9jdW1lbnQKICAgICAgICBwYXRoLnJlc29sdmVQYXRoc0luSFRNTChkb2N1bWVudC5ib2R5KTsKICAgICAgICAvLyBjYWNoZSBkb2N1bWVudAogICAgICAgIGltcG9ydGVyLmRvY3VtZW50c1t1cmxdID0gZG9jdW1lbnQ7CiAgICAgICAgLy8gYWRkIG5vZGVzIGZyb20gdGhpcyBkb2N1bWVudCB0byB0aGUgbG9hZGVyIHF1ZXVlCiAgICAgICAgaW1wb3J0ZXIucHJlbG9hZChkb2N1bWVudCk7CiAgICAgIH0KICAgICAgLy8gc3RvcmUgaW1wb3J0IHJlY29yZAogICAgICBlbHQuaW1wb3J0ID0gewogICAgICAgIGhyZWY6IHVybCwKICAgICAgICBvd25lck5vZGU6IGVsdCwKICAgICAgICBjb250ZW50OiBkb2N1bWVudAogICAgICB9OwogICAgICAvLyBzdG9yZSBkb2N1bWVudCByZXNvdXJjZQogICAgICBlbHQuY29udGVudCA9IHJlc291cmNlID0gZG9jdW1lbnQ7CiAgICB9CiAgICAvLyBzdG9yZSBnZW5lcmljIHJlc291cmNlCiAgICAvLyBUT0RPKHNvcnZlbGwpOiBmYWlscyBmb3Igbm9kZXMgaW5zaWRlIDx0ZW1wbGF0ZT4uY29udGVudAogICAgLy8gc2VlIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD0yNDkzODEuCiAgICBlbHQuX19yZXNvdXJjZSA9IHJlc291cmNlOwogICAgLy8gY3NzIHBhdGggZml4dXBzCiAgICBpZiAoaXNTdHlsZXNoZWV0TGluayhlbHQpKSB7CiAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5TdHlsZXNoZWV0KGVsdCk7CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gaXNEb2N1bWVudExpbmsoZWx0KSB7CiAgcmV0dXJuIGlzTGlua1JlbChlbHQsIElNUE9SVF9MSU5LX1RZUEUpOwp9CgpmdW5jdGlvbiBpc1N0eWxlc2hlZXRMaW5rKGVsdCkgewogIHJldHVybiBpc0xpbmtSZWwoZWx0LCBTVFlMRV9MSU5LX1RZUEUpOwp9CgpmdW5jdGlvbiBpc0xpbmtSZWwoZWx0LCByZWwpIHsKICByZXR1cm4gZWx0LmxvY2FsTmFtZSA9PT0gJ2xpbmsnICYmIGVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSByZWw7Cn0KCmZ1bmN0aW9uIGlzU2NyaXB0KGVsdCkgewogIHJldHVybiBlbHQubG9jYWxOYW1lID09PSAnc2NyaXB0JzsKfQoKZnVuY3Rpb24gbWFrZURvY3VtZW50KGluSFRNTCwgaW5VcmwpIHsKICAvLyBjcmVhdGUgYSBuZXcgSFRNTCBkb2N1bWVudAogIHZhciBkb2MgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoSU1QT1JUX0xJTktfVFlQRSk7CiAgLy8gY2FjaGUgdGhlIG5ldyBkb2N1bWVudCdzIHNvdXJjZSB1cmwKICBkb2MuX1VSTCA9IGluVXJsOwogIC8vIGVzdGFibGlzaCBhIHJlbGF0aXZlIHBhdGggdmlhIDxiYXNlPgogIHZhciBiYXNlID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2Jhc2UnKTsKICBiYXNlLnNldEF0dHJpYnV0ZSgnaHJlZicsIGRvY3VtZW50LmJhc2VVUkkpOwogIGRvYy5oZWFkLmFwcGVuZENoaWxkKGJhc2UpOwogIC8vIGluc3RhbGwgaHRtbAogIGRvYy5ib2R5LmlubmVySFRNTCA9IGluSFRNTDsKICAvLyBUT0RPKHNvcnZlbGwpOiBNRFYgUG9seWZpbGwgaW50cnVzaW9uOiBib29zdHJhcCB0ZW1wbGF0ZSBwb2x5ZmlsbAogIGlmICh3aW5kb3cuSFRNTFRlbXBsYXRlRWxlbWVudCAmJiBIVE1MVGVtcGxhdGVFbGVtZW50LmJvb3RzdHJhcCkgewogICAgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXAoZG9jKTsKICB9CiAgcmV0dXJuIGRvYzsKfQoKdmFyIGxvYWRlcjsKCnZhciBMb2FkZXIgPSBmdW5jdGlvbihpbk9uTG9hZCwgaW5PbkNvbXBsZXRlKSB7CiAgdGhpcy5vbmxvYWQgPSBpbk9uTG9hZDsKICB0aGlzLm9uY29tcGxldGUgPSBpbk9uQ29tcGxldGU7CiAgdGhpcy5pbmZsaWdodCA9IDA7CiAgdGhpcy5wZW5kaW5nID0ge307CiAgdGhpcy5jYWNoZSA9IHt9Owp9OwoKTG9hZGVyLnByb3RvdHlwZSA9IHsKICBhZGROb2RlczogZnVuY3Rpb24oaW5Ob2RlcykgewogICAgLy8gbnVtYmVyIG9mIHRyYW5zYWN0aW9ucyB0byBjb21wbGV0ZQogICAgdGhpcy5pbmZsaWdodCArPSBpbk5vZGVzLmxlbmd0aDsKICAgIC8vIGNvbW1lbmNlIHRyYW5zYWN0aW9ucwogICAgZm9yRWFjaChpbk5vZGVzLCB0aGlzLnJlcXVpcmUsIHRoaXMpOwogICAgLy8gYW55dGhpbmcgdG8gZG8/CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgcmVxdWlyZTogZnVuY3Rpb24oaW5FbHQpIHsKICAgIHZhciB1cmwgPSBwYXRoLm5vZGVVcmwoaW5FbHQpOwogICAgLy8gVE9ETyhzam1pbGVzKTogYWQtaG9jCiAgICBpbkVsdC5fX25vZGVVcmwgPSB1cmw7CiAgICAvLyBkZWR1cGxpY2F0aW9uCiAgICBpZiAoIXRoaXMuZGVkdXBlKHVybCwgaW5FbHQpKSB7CiAgICAgIC8vIGZldGNoIHRoaXMgcmVzb3VyY2UKICAgICAgdGhpcy5mZXRjaCh1cmwsIGluRWx0KTsKICAgIH0KICB9LAogIGRlZHVwZTogZnVuY3Rpb24oaW5VcmwsIGluRWx0KSB7CiAgICBpZiAodGhpcy5wZW5kaW5nW2luVXJsXSkgewogICAgICAvLyBhZGQgdG8gbGlzdCBvZiBub2RlcyB3YWl0aW5nIGZvciBpblVybAogICAgICB0aGlzLnBlbmRpbmdbaW5VcmxdLnB1c2goaW5FbHQpOwogICAgICAvLyBkb24ndCBuZWVkIGZldGNoCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKHRoaXMuY2FjaGVbaW5VcmxdKSB7CiAgICAgIC8vIGNvbXBsZXRlIGxvYWQgdXNpbmcgY2FjaGUgZGF0YQogICAgICB0aGlzLm9ubG9hZChpblVybCwgaW5FbHQsIGxvYWRlci5jYWNoZVtpblVybF0pOwogICAgICAvLyBmaW5pc2hlZCB0aGlzIHRyYW5zYWN0aW9uCiAgICAgIHRoaXMudGFpbCgpOwogICAgICAvLyBkb24ndCBuZWVkIGZldGNoCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gZmlyc3Qgbm9kZSB3YWl0aW5nIGZvciBpblVybAogICAgdGhpcy5wZW5kaW5nW2luVXJsXSA9IFtpbkVsdF07CiAgICAvLyBuZWVkIGZldGNoIChub3QgYSBkdXBlKQogICAgcmV0dXJuIGZhbHNlOwogIH0sCiAgZmV0Y2g6IGZ1bmN0aW9uKHVybCwgZWx0KSB7CiAgICB2YXIgcmVjZWl2ZVhociA9IGZ1bmN0aW9uKGVyciwgcmVzb3VyY2UpIHsKICAgICAgdGhpcy5yZWNlaXZlKHVybCwgZWx0LCBlcnIsIHJlc291cmNlKTsKICAgIH0uYmluZCh0aGlzKTsKICAgIHhoci5sb2FkKHVybCwgcmVjZWl2ZVhocik7CiAgfSwKICByZWNlaXZlOiBmdW5jdGlvbihpblVybCwgaW5FbHQsIGluRXJyLCBpblJlc291cmNlKSB7CiAgICBpZiAoIWluRXJyKSB7CiAgICAgIGxvYWRlci5jYWNoZVtpblVybF0gPSBpblJlc291cmNlOwogICAgfQogICAgbG9hZGVyLnBlbmRpbmdbaW5VcmxdLmZvckVhY2goZnVuY3Rpb24oZSkgewogICAgICBpZiAoIWluRXJyKSB7CiAgICAgICAgdGhpcy5vbmxvYWQoaW5VcmwsIGUsIGluUmVzb3VyY2UpOwogICAgICB9CiAgICAgIHRoaXMudGFpbCgpOwogICAgfSwgdGhpcyk7CiAgICBsb2FkZXIucGVuZGluZ1tpblVybF0gPSBudWxsOwogIH0sCiAgdGFpbDogZnVuY3Rpb24oKSB7CiAgICAtLXRoaXMuaW5mbGlnaHQ7CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgY2hlY2tEb25lOiBmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5pbmZsaWdodCkgewogICAgICB0aGlzLm9uY29tcGxldGUoKTsKICAgIH0KICB9Cn07Cgp2YXIgVVJMX0FUVFJTID0gWydocmVmJywgJ3NyYycsICdhY3Rpb24nXTsKdmFyIFVSTF9BVFRSU19TRUxFQ1RPUiA9ICdbJyArIFVSTF9BVFRSUy5qb2luKCddLFsnKSArICddJzsKdmFyIFVSTF9URU1QTEFURV9TRUFSQ0ggPSAne3suKn19JzsKCnZhciBwYXRoID0gewogIG5vZGVVcmw6IGZ1bmN0aW9uKGluTm9kZSkgewogICAgcmV0dXJuIHBhdGgucmVzb2x2ZVVybChwYXRoLmdldERvY3VtZW50VXJsKGRvY3VtZW50KSwgcGF0aC5ocmVmT3JTcmMoaW5Ob2RlKSk7CiAgfSwKICBocmVmT3JTcmM6IGZ1bmN0aW9uKGluTm9kZSkgewogICAgcmV0dXJuIGluTm9kZS5nZXRBdHRyaWJ1dGUoImhyZWYiKSB8fCBpbk5vZGUuZ2V0QXR0cmlidXRlKCJzcmMiKTsKICB9LAogIGRvY3VtZW50VXJsRnJvbU5vZGU6IGZ1bmN0aW9uKGluTm9kZSkgewogICAgcmV0dXJuIHBhdGguZ2V0RG9jdW1lbnRVcmwoaW5Ob2RlLm93bmVyRG9jdW1lbnQpOwogIH0sCiAgZ2V0RG9jdW1lbnRVcmw6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIHZhciB1cmwgPSBpbkRvY3VtZW50ICYmCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NUG9seWZpbGwgaW50cnVzaW9uCiAgICAgICAgKGluRG9jdW1lbnQuX1VSTCB8fCAoaW5Eb2N1bWVudC5pbXBsICYmIGluRG9jdW1lbnQuaW1wbC5fVVJMKQogICAgICAgICAgICB8fCBpbkRvY3VtZW50LmJhc2VVUkkgfHwgaW5Eb2N1bWVudC5VUkwpCiAgICAgICAgICAgICAgICB8fCAnJzsKICAgIC8vIHRha2Ugb25seSB0aGUgbGVmdCBzaWRlIGlmIHRoZXJlIGlzIGEgIwogICAgcmV0dXJuIHVybC5zcGxpdCgnIycpWzBdOwogIH0sCiAgcmVzb2x2ZVVybDogZnVuY3Rpb24oaW5CYXNlVXJsLCBpblVybCwgaW5SZWxhdGl2ZVRvRG9jdW1lbnQpIHsKICAgIGlmICh0aGlzLmlzQWJzVXJsKGluVXJsKSkgewogICAgICByZXR1cm4gaW5Vcmw7CiAgICB9CiAgICB2YXIgdXJsID0gdGhpcy5jb21wcmVzc1VybCh0aGlzLnVybFRvUGF0aChpbkJhc2VVcmwpICsgaW5VcmwpOwogICAgaWYgKGluUmVsYXRpdmVUb0RvY3VtZW50KSB7CiAgICAgIHVybCA9IHBhdGgubWFrZVJlbFBhdGgocGF0aC5nZXREb2N1bWVudFVybChkb2N1bWVudCksIHVybCk7CiAgICB9CiAgICByZXR1cm4gdXJsOwogIH0sCiAgaXNBYnNVcmw6IGZ1bmN0aW9uKGluVXJsKSB7CiAgICByZXR1cm4gLyheZGF0YTopfCheaHR0cFtzXT86KXwoXlwvKS8udGVzdChpblVybCk7CiAgfSwKICB1cmxUb1BhdGg6IGZ1bmN0aW9uKGluQmFzZVVybCkgewogICAgdmFyIHBhcnRzID0gaW5CYXNlVXJsLnNwbGl0KCIvIik7CiAgICBwYXJ0cy5wb3AoKTsKICAgIHBhcnRzLnB1c2goJycpOwogICAgcmV0dXJuIHBhcnRzLmpvaW4oIi8iKTsKICB9LAogIGNvbXByZXNzVXJsOiBmdW5jdGlvbihpblVybCkgewogICAgdmFyIHBhcnRzID0gaW5Vcmwuc3BsaXQoIi8iKTsKICAgIGZvciAodmFyIGk9MCwgcDsgaTxwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICBwID0gcGFydHNbaV07CiAgICAgIGlmIChwID09PSAiLi4iKSB7CiAgICAgICAgcGFydHMuc3BsaWNlKGktMSwgMik7CiAgICAgICAgaSAtPSAyOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcGFydHMuam9pbigiLyIpOwogIH0sCiAgLy8gbWFrZSBhIHJlbGF0aXZlIHBhdGggZnJvbSBzb3VyY2UgdG8gdGFyZ2V0CiAgbWFrZVJlbFBhdGg6IGZ1bmN0aW9uKGluU291cmNlLCBpblRhcmdldCkgewogICAgdmFyIHMsIHQ7CiAgICBzID0gdGhpcy5jb21wcmVzc1VybChpblNvdXJjZSkuc3BsaXQoIi8iKTsKICAgIHQgPSB0aGlzLmNvbXByZXNzVXJsKGluVGFyZ2V0KS5zcGxpdCgiLyIpOwogICAgd2hpbGUgKHMubGVuZ3RoICYmIHNbMF0gPT09IHRbMF0pewogICAgICBzLnNoaWZ0KCk7CiAgICAgIHQuc2hpZnQoKTsKICAgIH0KICAgIGZvcih2YXIgaSA9IDAsIGwgPSBzLmxlbmd0aC0xOyBpIDwgbDsgaSsrKSB7CiAgICAgIHQudW5zaGlmdCgiLi4iKTsKICAgIH0KICAgIHZhciByID0gdC5qb2luKCIvIik7CiAgICByZXR1cm4gcjsKICB9LAogIHJlc29sdmVQYXRoc0luSFRNTDogZnVuY3Rpb24ocm9vdCwgdXJsKSB7CiAgICB1cmwgPSB1cmwgfHwgcGF0aC5kb2N1bWVudFVybEZyb21Ob2RlKHJvb3QpCiAgICBwYXRoLnJlc29sdmVBdHRyaWJ1dGVzKHJvb3QsIHVybCk7CiAgICBwYXRoLnJlc29sdmVTdHlsZUVsdHMocm9vdCwgdXJsKTsKICAgIC8vIGhhbmRsZSB0ZW1wbGF0ZS5jb250ZW50CiAgICB2YXIgdGVtcGxhdGVzID0gcm9vdC5xdWVyeVNlbGVjdG9yQWxsKCd0ZW1wbGF0ZScpOwogICAgaWYgKHRlbXBsYXRlcykgewogICAgICBmb3JFYWNoKHRlbXBsYXRlcywgZnVuY3Rpb24odCkgewogICAgICAgIGlmICh0LmNvbnRlbnQpIHsKICAgICAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5IVE1MKHQuY29udGVudCwgdXJsKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sCiAgcmVzb2x2ZVBhdGhzSW5TdHlsZXNoZWV0OiBmdW5jdGlvbihpblNoZWV0KSB7CiAgICB2YXIgZG9jVXJsID0gcGF0aC5ub2RlVXJsKGluU2hlZXQpOwogICAgaW5TaGVldC5fX3Jlc291cmNlID0gcGF0aC5yZXNvbHZlQ3NzVGV4dChpblNoZWV0Ll9fcmVzb3VyY2UsIGRvY1VybCk7CiAgfSwKICByZXNvbHZlU3R5bGVFbHRzOiBmdW5jdGlvbihpblJvb3QsIGluVXJsKSB7CiAgICB2YXIgc3R5bGVzID0gaW5Sb290LnF1ZXJ5U2VsZWN0b3JBbGwoJ3N0eWxlJyk7CiAgICBpZiAoc3R5bGVzKSB7CiAgICAgIGZvckVhY2goc3R5bGVzLCBmdW5jdGlvbihzdHlsZSkgewogICAgICAgIHN0eWxlLnRleHRDb250ZW50ID0gcGF0aC5yZXNvbHZlQ3NzVGV4dChzdHlsZS50ZXh0Q29udGVudCwgaW5VcmwpOwogICAgICB9KTsKICAgIH0KICB9LAogIHJlc29sdmVDc3NUZXh0OiBmdW5jdGlvbihpbkNzc1RleHQsIGluQmFzZVVybCkgewogICAgcmV0dXJuIGluQ3NzVGV4dC5yZXBsYWNlKC91cmxcKFteKV0qXCkvZywgZnVuY3Rpb24oaW5NYXRjaCkgewogICAgICAvLyBmaW5kIHRoZSB1cmwgcGF0aCwgaWdub3JlIHF1b3RlcyBpbiB1cmwgc3RyaW5nCiAgICAgIHZhciB1cmxQYXRoID0gaW5NYXRjaC5yZXBsYWNlKC9bIiddL2csICIiKS5zbGljZSg0LCAtMSk7CiAgICAgIHVybFBhdGggPSBwYXRoLnJlc29sdmVVcmwoaW5CYXNlVXJsLCB1cmxQYXRoLCB0cnVlKTsKICAgICAgcmV0dXJuICJ1cmwoIiArIHVybFBhdGggKyAiKSI7CiAgICB9KTsKICB9LAogIHJlc29sdmVBdHRyaWJ1dGVzOiBmdW5jdGlvbihpblJvb3QsIGluVXJsKSB7CiAgICAvLyBzZWFyY2ggZm9yIGF0dHJpYnV0ZXMgdGhhdCBob3N0IHVybHMKICAgIHZhciBub2RlcyA9IGluUm9vdCAmJiBpblJvb3QucXVlcnlTZWxlY3RvckFsbChVUkxfQVRUUlNfU0VMRUNUT1IpOwogICAgaWYgKG5vZGVzKSB7CiAgICAgIGZvckVhY2gobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICB0aGlzLnJlc29sdmVOb2RlQXR0cmlidXRlcyhuLCBpblVybCk7CiAgICAgIH0sIHRoaXMpOwogICAgfQogIH0sCiAgcmVzb2x2ZU5vZGVBdHRyaWJ1dGVzOiBmdW5jdGlvbihpbk5vZGUsIGluVXJsKSB7CiAgICBVUkxfQVRUUlMuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIHZhciBhdHRyID0gaW5Ob2RlLmF0dHJpYnV0ZXNbdl07CiAgICAgIGlmIChhdHRyICYmIGF0dHIudmFsdWUgJiYKICAgICAgICAgKGF0dHIudmFsdWUuc2VhcmNoKFVSTF9URU1QTEFURV9TRUFSQ0gpIDwgMCkpIHsKICAgICAgICB2YXIgdXJsUGF0aCA9IHBhdGgucmVzb2x2ZVVybChpblVybCwgYXR0ci52YWx1ZSwgdHJ1ZSk7CiAgICAgICAgYXR0ci52YWx1ZSA9IHVybFBhdGg7CiAgICAgIH0KICAgIH0pOwogIH0KfTsKCnhociA9IHhociB8fCB7CiAgYXN5bmM6IHRydWUsCiAgb2s6IGZ1bmN0aW9uKGluUmVxdWVzdCkgewogICAgcmV0dXJuIChpblJlcXVlc3Quc3RhdHVzID49IDIwMCAmJiBpblJlcXVlc3Quc3RhdHVzIDwgMzAwKQogICAgICAgIHx8IChpblJlcXVlc3Quc3RhdHVzID09PSAzMDQpCiAgICAgICAgfHwgKGluUmVxdWVzdC5zdGF0dXMgPT09IDApOwogIH0sCiAgbG9hZDogZnVuY3Rpb24odXJsLCBuZXh0LCBuZXh0Q29udGV4dCkgewogICAgdmFyIHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgIGlmIChzY29wZS5mbGFncy5kZWJ1ZyB8fCBzY29wZS5mbGFncy5idXN0KSB7CiAgICAgIHVybCArPSAnPycgKyBNYXRoLnJhbmRvbSgpOwogICAgfQogICAgcmVxdWVzdC5vcGVuKCdHRVQnLCB1cmwsIHhoci5hc3luYyk7CiAgICByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgICAgIGlmIChyZXF1ZXN0LnJlYWR5U3RhdGUgPT09IDQpIHsKICAgICAgICBuZXh0LmNhbGwobmV4dENvbnRleHQsICF4aHIub2socmVxdWVzdCkgJiYgcmVxdWVzdCwKICAgICAgICAgIHJlcXVlc3QucmVzcG9uc2UsIHVybCk7CiAgICAgIH0KICAgIH0pOwogICAgcmVxdWVzdC5zZW5kKCk7CiAgfQp9OwoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKLy8gZXhwb3J0cwoKc2NvcGUucGF0aCA9IHBhdGg7CnNjb3BlLnhociA9IHhocjsKc2NvcGUuaW1wb3J0ZXIgPSBpbXBvcnRlcjsKc2NvcGUuZ2V0RG9jdW1lbnRVcmwgPSBwYXRoLmdldERvY3VtZW50VXJsOwpzY29wZS5JTVBPUlRfTElOS19UWVBFID0gSU1QT1JUX0xJTktfVFlQRTsKCn0pKHdpbmRvdy5IVE1MSW1wb3J0cyk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7Cgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9ICdpbXBvcnQnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgZm9yIHBhcnNpbmcgYSBkb2N1bWVudCB0cmVlCgp2YXIgaW1wb3J0UGFyc2VyID0gewogIHNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nLAogICAgJ2xpbmtbcmVsPXN0eWxlc2hlZXRdJywKICAgICdzdHlsZScsCiAgICAnc2NyaXB0JwogIF0sCiAgbWFwOiB7CiAgICBsaW5rOiAncGFyc2VMaW5rJywKICAgIHNjcmlwdDogJ3BhcnNlU2NyaXB0JywKICAgIHN0eWxlOiAncGFyc2VHZW5lcmljJwogIH0sCiAgcGFyc2U6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIGlmICghaW5Eb2N1bWVudC5fX2ltcG9ydFBhcnNlZCkgewogICAgICAvLyBvbmx5IHBhcnNlIG9uY2UKICAgICAgaW5Eb2N1bWVudC5fX2ltcG9ydFBhcnNlZCA9IHRydWU7CiAgICAgIC8vIGFsbCBwYXJzYWJsZSBlbGVtZW50cyBpbiBpbkRvY3VtZW50IChkZXB0aC1maXJzdCBwcmUtb3JkZXIgdHJhdmVyc2FsKQogICAgICB2YXIgZWx0cyA9IGluRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChpbXBvcnRQYXJzZXIuc2VsZWN0b3JzKTsKICAgICAgLy8gZm9yIGVhY2ggcGFyc2FibGUgbm9kZSB0eXBlLCBjYWxsIHRoZSBtYXBwZWQgcGFyc2luZyBtZXRob2QKICAgICAgZm9yRWFjaChlbHRzLCBmdW5jdGlvbihlKSB7CiAgICAgICAgaW1wb3J0UGFyc2VyW2ltcG9ydFBhcnNlci5tYXBbZS5sb2NhbE5hbWVdXShlKTsKICAgICAgfSk7CiAgICB9CiAgfSwKICBwYXJzZUxpbms6IGZ1bmN0aW9uKGxpbmtFbHQpIHsKICAgIGlmIChpc0RvY3VtZW50TGluayhsaW5rRWx0KSkgewogICAgICBpZiAobGlua0VsdC5jb250ZW50KSB7CiAgICAgICAgaW1wb3J0UGFyc2VyLnBhcnNlKGxpbmtFbHQuY29udGVudCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucGFyc2VHZW5lcmljKGxpbmtFbHQpOwogICAgfQogIH0sCiAgcGFyc2VHZW5lcmljOiBmdW5jdGlvbihlbHQpIHsKICAgIGlmIChuZWVkc01haW5Eb2N1bWVudENvbnRleHQoZWx0KSkgewogICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGVsdCk7CiAgICB9CiAgfSwKICBwYXJzZVNjcmlwdDogZnVuY3Rpb24oc2NyaXB0RWx0KSB7CiAgICBpZiAobmVlZHNNYWluRG9jdW1lbnRDb250ZXh0KHNjcmlwdEVsdCkpIHsKICAgICAgLy8gYWNxdWlyZSBjb2RlIHRvIGV4ZWN1dGUKICAgICAgdmFyIGNvZGUgPSAoc2NyaXB0RWx0Ll9fcmVzb3VyY2UgfHwgc2NyaXB0RWx0LnRleHRDb250ZW50KS50cmltKCk7CiAgICAgIGlmIChjb2RlKSB7CiAgICAgICAgLy8gY2FsY3VsYXRlIHNvdXJjZSBtYXAgaGludAogICAgICAgIHZhciBtb25pa2VyID0gc2NyaXB0RWx0Ll9fbm9kZVVybDsKICAgICAgICBpZiAoIW1vbmlrZXIpIHsKICAgICAgICAgIHZhciBtb25pa2VyID0gc2NvcGUucGF0aC5kb2N1bWVudFVybEZyb21Ob2RlKHNjcmlwdEVsdCk7CiAgICAgICAgICAvLyB0aGVyZSBjb3VsZCBiZSBtb3JlIHRoYW4gb25lIHNjcmlwdCB0aGlzIHVybAogICAgICAgICAgdmFyIHRhZyA9ICdbJyArIE1hdGguZmxvb3IoKE1hdGgucmFuZG9tKCkrMSkqMTAwMCkgKyAnXSc7CiAgICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiBQb2x5bWVyIGhhY2ssIHNob3VsZCBiZSBwbHVnZ2FibGUgaWYgd2UgbmVlZCB0byBhbGxvdyAKICAgICAgICAgIC8vIHRoaXMgc29ydCBvZiB0aGluZwogICAgICAgICAgdmFyIG1hdGNoZXMgPSBjb2RlLm1hdGNoKC9Qb2x5bWVyXChbJyJdKFteJyJdKikvKTsKICAgICAgICAgIHRhZyA9IG1hdGNoZXMgJiYgbWF0Y2hlc1sxXSB8fCB0YWc7CiAgICAgICAgICAvLyB0YWcgdGhlIG1vbmlrZXIKICAgICAgICAgIG1vbmlrZXIgKz0gJy8nICsgdGFnICsgJy5qcyc7CiAgICAgICAgfQogICAgICAgIC8vIHNvdXJjZSBtYXAgaGludAogICAgICAgIGNvZGUgKz0gIlxuLy8jIHNvdXJjZVVSTD0iICsgbW9uaWtlciArICJcbiI7CiAgICAgICAgLy8gZXZhbHVhdGUgdGhlIGNvZGUKICAgICAgICBldmFsLmNhbGwod2luZG93LCBjb2RlKTsKICAgICAgfQogICAgfQogIH0KfTsKCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsKCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGVsdCkgewogIHJldHVybiBlbHQubG9jYWxOYW1lID09PSAnbGluaycKICAgICAgJiYgZWx0LmdldEF0dHJpYnV0ZSgncmVsJykgPT09IElNUE9SVF9MSU5LX1RZUEU7Cn0KCmZ1bmN0aW9uIG5lZWRzTWFpbkRvY3VtZW50Q29udGV4dChub2RlKSB7CiAgLy8gbm9kZXMgY2FuIGJlIG1vdmVkIHRvIHRoZSBtYWluIGRvY3VtZW50OgogIC8vIGlmIHRoZXkgYXJlIGluIGEgdHJlZSBidXQgbm90IGluIHRoZSBtYWluIGRvY3VtZW50IGFuZCBub3QgY2hpbGRyZW4gb2YgPGVsZW1lbnQ+CiAgcmV0dXJuIG5vZGUucGFyZW50Tm9kZSAmJiAhaW5NYWluRG9jdW1lbnQobm9kZSkgCiAgICAgICYmICFpc0VsZW1lbnRFbGVtZW50Q2hpbGQobm9kZSk7Cn0KCmZ1bmN0aW9uIGluTWFpbkRvY3VtZW50KGVsdCkgewogIHJldHVybiBlbHQub3duZXJEb2N1bWVudCA9PT0gZG9jdW1lbnQgfHwKICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTVBvbHlmaWxsIGludHJ1c2lvbgogICAgZWx0Lm93bmVyRG9jdW1lbnQuaW1wbCA9PT0gZG9jdW1lbnQ7Cn0KCmZ1bmN0aW9uIGlzRWxlbWVudEVsZW1lbnRDaGlsZChlbHQpIHsKICByZXR1cm4gZWx0LnBhcmVudE5vZGUgJiYgZWx0LnBhcmVudE5vZGUubG9jYWxOYW1lID09PSAnZWxlbWVudCc7Cn0KCi8vIGV4cG9ydHMKCnNjb3BlLnBhcnNlciA9IGltcG9ydFBhcnNlcjsKCn0pKEhUTUxJbXBvcnRzKTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCl7CgovLyBib290c3RyYXAKCi8vIElFIHNoaW0gZm9yIEN1c3RvbUV2ZW50CmlmICh0eXBlb2Ygd2luZG93LkN1c3RvbUV2ZW50ICE9PSAnZnVuY3Rpb24nKSB7CiAgd2luZG93LkN1c3RvbUV2ZW50ID0gZnVuY3Rpb24oaW5UeXBlKSB7CiAgICAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogICAgIGUuaW5pdEV2ZW50KGluVHlwZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgcmV0dXJuIGU7CiAgfTsKfQoKZnVuY3Rpb24gYm9vdHN0cmFwKCkgewogIC8vIHByZWxvYWQgZG9jdW1lbnQgcmVzb3VyY2UgdHJlZXMKICBIVE1MSW1wb3J0cy5pbXBvcnRlci5sb2FkKGRvY3VtZW50LCBmdW5jdGlvbigpIHsKICAgIEhUTUxJbXBvcnRzLnBhcnNlci5wYXJzZShkb2N1bWVudCk7CiAgICBIVE1MSW1wb3J0cy5yZWFkeVRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIC8vIHNlbmQgSFRNTEltcG9ydHNMb2FkZWQgd2hlbiBmaW5pc2hlZAogICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudCgKICAgICAgbmV3IEN1c3RvbUV2ZW50KCdIVE1MSW1wb3J0c0xvYWRlZCcsIHtidWJibGVzOiB0cnVlfSkKICAgICk7CiAgfSk7Cn07CgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJykgewogIGJvb3RzdHJhcCgpOwp9IGVsc2UgewogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgYm9vdHN0cmFwKTsKfQoKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oKSB7CgovLyBpbXBvcnQKCnZhciBJTVBPUlRfTElOS19UWVBFID0gd2luZG93LkhUTUxJbXBvcnRzID8gSFRNTEltcG9ydHMuSU1QT1JUX0xJTktfVFlQRSA6ICdub25lJzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IGZvciBwYXJzaW5nIGEgZG9jdW1lbnQgdHJlZQoKdmFyIHBhcnNlciA9IHsKICBzZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJywKICAgICdlbGVtZW50JwogIF0sCiAgbWFwOiB7CiAgICBsaW5rOiAncGFyc2VMaW5rJywKICAgIGVsZW1lbnQ6ICdwYXJzZUVsZW1lbnQnCiAgfSwKICBwYXJzZTogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgaWYgKCFpbkRvY3VtZW50Ll9fcGFyc2VkKSB7CiAgICAgIC8vIG9ubHkgcGFyc2Ugb25jZQogICAgICBpbkRvY3VtZW50Ll9fcGFyc2VkID0gdHJ1ZTsKICAgICAgLy8gYWxsIHBhcnNhYmxlIGVsZW1lbnRzIGluIGluRG9jdW1lbnQgKGRlcHRoLWZpcnN0IHByZS1vcmRlciB0cmF2ZXJzYWwpCiAgICAgIHZhciBlbHRzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHBhcnNlci5zZWxlY3RvcnMpOwogICAgICAvLyBmb3IgZWFjaCBwYXJzYWJsZSBub2RlIHR5cGUsIGNhbGwgdGhlIG1hcHBlZCBwYXJzaW5nIG1ldGhvZAogICAgICBmb3JFYWNoKGVsdHMsIGZ1bmN0aW9uKGUpIHsKICAgICAgICBwYXJzZXJbcGFyc2VyLm1hcFtlLmxvY2FsTmFtZV1dKGUpOwogICAgICB9KTsKICAgICAgLy8gdXBncmFkZSBhbGwgdXBncmFkZWFibGUgc3RhdGljIGVsZW1lbnRzLCBhbnl0aGluZyBkeW5hbWljYWxseQogICAgICAvLyBjcmVhdGVkIHNob3VsZCBiZSBjYXVnaHQgYnkgb2JzZXJ2ZXIKICAgICAgQ3VzdG9tRWxlbWVudHMudXBncmFkZURvY3VtZW50KGluRG9jdW1lbnQpOwogICAgICAvLyBvYnNlcnZlIGRvY3VtZW50IGZvciBkb20gY2hhbmdlcwogICAgICBDdXN0b21FbGVtZW50cy5vYnNlcnZlRG9jdW1lbnQoaW5Eb2N1bWVudCk7CiAgICB9CiAgfSwKICBwYXJzZUxpbms6IGZ1bmN0aW9uKGxpbmtFbHQpIHsKICAgIC8vIGltcG9ydHMKICAgIGlmIChpc0RvY3VtZW50TGluayhsaW5rRWx0KSkgewogICAgICB0aGlzLnBhcnNlSW1wb3J0KGxpbmtFbHQpOwogICAgfQogIH0sCiAgcGFyc2VJbXBvcnQ6IGZ1bmN0aW9uKGxpbmtFbHQpIHsKICAgIGlmIChsaW5rRWx0LmNvbnRlbnQpIHsKICAgICAgcGFyc2VyLnBhcnNlKGxpbmtFbHQuY29udGVudCk7CiAgICB9CiAgfSwKICBwYXJzZUVsZW1lbnQ6IGZ1bmN0aW9uKGluRWxlbWVudEVsdCkgewogICAgbmV3IEhUTUxFbGVtZW50RWxlbWVudChpbkVsZW1lbnRFbHQpOwogIH0KfTsKCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGluRWx0KSB7CiAgcmV0dXJuIChpbkVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJwogICAgICAmJiBpbkVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSBJTVBPUlRfTElOS19UWVBFKTsKfQoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKLy8gZXhwb3J0cwoKQ3VzdG9tRWxlbWVudHMucGFyc2VyID0gcGFyc2VyOwoKfSkoKTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCl7CgovLyBib290c3RyYXAgcGFyc2luZwoKZnVuY3Rpb24gYm9vdHN0cmFwKCkgewogIC8vIGdvIGFzeW5jIHNvIGNhbGwgc3RhY2sgY2FuIHVud2luZAogIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAvLyBwYXJzZSBkb2N1bWVudAogICAgQ3VzdG9tRWxlbWVudHMucGFyc2VyLnBhcnNlKGRvY3VtZW50KTsKICAgIC8vIG9uZSBtb3JlIHBhc3MgYmVmb3JlIHJlZ2lzdGVyIGlzICdsaXZlJwogICAgQ3VzdG9tRWxlbWVudHMudXBncmFkZURvY3VtZW50KGRvY3VtZW50KTsgIAogICAgLy8gc2V0IGludGVybmFsICdyZWFkeScgZmxhZywgbm93IGRvY3VtZW50LnJlZ2lzdGVyIHdpbGwgdHJpZ2dlciAKICAgIC8vIHN5bmNocm9ub3VzIHVwZ3JhZGVzCiAgICBDdXN0b21FbGVtZW50cy5yZWFkeSA9IHRydWU7CiAgICAvLyBjYXB0dXJlIGJsdW50IHByb2ZpbGluZyBkYXRhCiAgICBDdXN0b21FbGVtZW50cy5yZWFkeVRpbWUgPSBEYXRlLm5vdygpOwogICAgaWYgKHdpbmRvdy5IVE1MSW1wb3J0cykgewogICAgICBDdXN0b21FbGVtZW50cy5lbGFwc2VkID0gQ3VzdG9tRWxlbWVudHMucmVhZHlUaW1lIC0gSFRNTEltcG9ydHMucmVhZHlUaW1lOwogICAgfQogICAgLy8gbm90aWZ5IHRoZSBzeXN0ZW0gdGhhdCB3ZSBhcmUgYm9vdHN0cmFwcGVkCiAgICBkb2N1bWVudC5ib2R5LmRpc3BhdGNoRXZlbnQoCiAgICAgIG5ldyBDdXN0b21FdmVudCgnV2ViQ29tcG9uZW50c1JlYWR5Jywge2J1YmJsZXM6IHRydWV9KQogICAgKTsKICB9LCAwKTsKfQoKLy8gQ3VzdG9tRXZlbnQgc2hpbSBmb3IgSUUKaWYgKHR5cGVvZiB3aW5kb3cuQ3VzdG9tRXZlbnQgIT09ICdmdW5jdGlvbicpIHsKICB3aW5kb3cuQ3VzdG9tRXZlbnQgPSBmdW5jdGlvbihpblR5cGUpIHsKICAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgICAgZS5pbml0RXZlbnQoaW5UeXBlLCB0cnVlLCB0cnVlKTsKICAgICByZXR1cm4gZTsKICB9Owp9CgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJykgewogIGJvb3RzdHJhcCgpOwp9IGVsc2UgewogIHZhciBsb2FkRXZlbnQgPSB3aW5kb3cuSFRNTEltcG9ydHMgPyAnSFRNTEltcG9ydHNMb2FkZWQnIDogJ0RPTUNvbnRlbnRMb2FkZWQnOwogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKGxvYWRFdmVudCwgYm9vdHN0cmFwKTsKfQoKfSkoKTsKCihmdW5jdGlvbiAoKSB7CgovKioqIFZhcmlhYmxlcyAqKiovCgogIHZhciB3aW4gPSB3aW5kb3csCiAgICBkb2MgPSBkb2N1bWVudCwKICAgIG5vb3AgPSBmdW5jdGlvbigpe30sCiAgICByZWdleFBzZXVkb1NwbGl0ID0gLyhbXHctXSsoPzpcKFteXCldK1wpKT8pL2csCiAgICByZWdleFBzZXVkb1JlcGxhY2UgPSAvKFx3KikoPzpcKChbXlwpXSopXCkpPy8sCiAgICByZWdleERpZ2l0cyA9IC8oXGQrKS9nLAogICAga2V5cHNldWRvID0gewogICAgICBhY3Rpb246IGZ1bmN0aW9uIChwc2V1ZG8sIGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIHBzZXVkby52YWx1ZS5tYXRjaChyZWdleERpZ2l0cykuaW5kZXhPZihTdHJpbmcoZXZlbnQua2V5Q29kZSkpID4gLTEgPT0gKHBzZXVkby5uYW1lID09ICdrZXlwYXNzJyk7CiAgICAgIH0KICAgIH0sCiAgICBwcmVmaXggPSAoZnVuY3Rpb24gKCkgewogICAgICB2YXIgc3R5bGVzID0gd2luLmdldENvbXB1dGVkU3R5bGUoZG9jLmRvY3VtZW50RWxlbWVudCwgJycpLAogICAgICAgICAgcHJlID0gKEFycmF5LnByb3RvdHlwZS5zbGljZQogICAgICAgICAgICAuY2FsbChzdHlsZXMpCiAgICAgICAgICAgIC5qb2luKCcnKQogICAgICAgICAgICAubWF0Y2goLy0obW96fHdlYmtpdHxtcyktLykgfHwgKHN0eWxlcy5PTGluayA9PT0gJycgJiYgWycnLCAnbyddKQogICAgICAgICAgKVsxXTsKICAgICAgcmV0dXJuIHsKICAgICAgICBkb206IHByZSA9PSAnbXMnID8gcHJlLnRvVXBwZXJDYXNlKCkgOiBwcmUsCiAgICAgICAgbG93ZXJjYXNlOiBwcmUsCiAgICAgICAgY3NzOiAnLScgKyBwcmUgKyAnLScsCiAgICAgICAganM6IHByZSA9PSAnbXMnID8gcHJlIDogcHJlWzBdLnRvVXBwZXJDYXNlKCkgKyBwcmUuc3Vic3RyKDEpCiAgICAgIH07CgogICAgfSkoKSwKICAgIG1hdGNoU2VsZWN0b3IgPSBFbGVtZW50LnByb3RvdHlwZS5tYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudC5wcm90b3R5cGVbcHJlZml4Lmxvd2VyY2FzZSArICdNYXRjaGVzU2VsZWN0b3InXTsKCi8qKiogRnVuY3Rpb25zICoqKi8KCi8vIFV0aWxpdGllcwoKICB2YXIgdHlwZU9iaiA9IHt9OwogIGZ1bmN0aW9uIHR5cGVPZihvYmopIHsKICAgIHJldHVybiB0eXBlT2JqLnRvU3RyaW5nLmNhbGwob2JqKS5tYXRjaCgvXHMoW2EtekEtWl0rKS8pWzFdLnRvTG93ZXJDYXNlKCk7CiAgfQoKICBmdW5jdGlvbiBjbG9uZShpdGVtLCB0eXBlKXsKICAgIHZhciBmbiA9IGNsb25lW3R5cGUgfHwgdHlwZU9mKGl0ZW0pXTsKICAgIHJldHVybiBmbiA/IGZuKGl0ZW0pIDogaXRlbTsKICB9CiAgICBjbG9uZS5vYmplY3QgPSBmdW5jdGlvbihzcmMpewogICAgICB2YXIgb2JqID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIG9ialtrZXldID0gY2xvbmUoc3JjW2tleV0pOwogICAgICByZXR1cm4gb2JqOwogICAgfTsKICAgIGNsb25lLmFycmF5ID0gZnVuY3Rpb24oc3JjKXsKICAgICAgdmFyIGkgPSBzcmMubGVuZ3RoLCBhcnJheSA9IG5ldyBBcnJheShpKTsKICAgICAgd2hpbGUgKGktLSkgYXJyYXlbaV0gPSBjbG9uZShzcmNbaV0pOwogICAgICByZXR1cm4gYXJyYXk7CiAgICB9OwoKICB2YXIgdW5zbGljZWFibGUgPSBbJ251bWJlcicsICdib29sZWFuJywgJ3N0cmluZycsICdmdW5jdGlvbiddOwogIGZ1bmN0aW9uIHRvQXJyYXkob2JqKXsKICAgIHJldHVybiB1bnNsaWNlYWJsZS5pbmRleE9mKHR5cGVPZihvYmopKSA9PSAtMSA/CiAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChvYmosIDApIDoKICAgIFtvYmpdOwogIH0KCi8vIERPTQogIHZhciBzdHIgPSAnJzsKICBmdW5jdGlvbiBxdWVyeShlbGVtZW50LCBzZWxlY3Rvcil7CiAgICByZXR1cm4gKHNlbGVjdG9yIHx8IHN0cikubGVuZ3RoID8gdG9BcnJheShlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpKSA6IFtdOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VNdXRhdGlvbnMoZWxlbWVudCwgbXV0YXRpb25zKSB7CiAgICB2YXIgZGlmZiA9IHsgYWRkZWQ6IFtdLCByZW1vdmVkOiBbXSB9OwogICAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24ocmVjb3JkKXsKICAgICAgcmVjb3JkLl9tdXRhdGlvbiA9IHRydWU7CiAgICAgIGZvciAodmFyIHogaW4gZGlmZikgewogICAgICAgIHZhciB0eXBlID0gZWxlbWVudC5fcmVjb3Jkc1soeiA9PSAnYWRkZWQnKSA/ICdpbnNlcnRlZCcgOiAncmVtb3ZlZCddLAogICAgICAgICAgbm9kZXMgPSByZWNvcmRbeiArICdOb2RlcyddLCBsZW5ndGggPSBub2Rlcy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGggJiYgZGlmZlt6XS5pbmRleE9mKG5vZGVzW2ldKSA9PSAtMTsgaSsrKXsKICAgICAgICAgIGRpZmZbel0ucHVzaChub2Rlc1tpXSk7CiAgICAgICAgICB0eXBlLmZvckVhY2goZnVuY3Rpb24oZm4pewogICAgICAgICAgICBmbihub2Rlc1tpXSwgcmVjb3JkKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKLy8gTWl4aW5zCgogIGZ1bmN0aW9uIG1lcmdlT25lKHNvdXJjZSwga2V5LCBjdXJyZW50KXsKICAgIHZhciB0eXBlID0gdHlwZU9mKGN1cnJlbnQpOwogICAgaWYgKHR5cGUgPT0gJ29iamVjdCcgJiYgdHlwZU9mKHNvdXJjZVtrZXldKSA9PSAnb2JqZWN0JykgeHRhZy5tZXJnZShzb3VyY2Vba2V5XSwgY3VycmVudCk7CiAgICBlbHNlIHNvdXJjZVtrZXldID0gY2xvbmUoY3VycmVudCwgdHlwZSk7CiAgICByZXR1cm4gc291cmNlOwogIH0KCiAgZnVuY3Rpb24gbWVyZ2VNaXhpbih0eXBlLCBtaXhpbiwgb3B0aW9uKSB7CiAgICB2YXIgb3JpZ2luYWwgPSB7fTsKICAgIGZvciAodmFyIG8gaW4gb3B0aW9uKSBvcmlnaW5hbFtvLnNwbGl0KCc6JylbMF1dID0gdHJ1ZTsKICAgIGZvciAodmFyIHggaW4gbWl4aW4pIGlmICghb3JpZ2luYWxbeC5zcGxpdCgnOicpWzBdXSkgb3B0aW9uW3hdID0gbWl4aW5beF07CiAgfQoKICBmdW5jdGlvbiBhcHBseU1peGlucyh0YWcpIHsKICAgIHRhZy5taXhpbnMuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICB2YXIgbWl4aW4gPSB4dGFnLm1peGluc1tuYW1lXTsKICAgICAgZm9yICh2YXIgdHlwZSBpbiBtaXhpbikgewogICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgY2FzZSAnbGlmZWN5Y2xlJzogY2FzZSAnbWV0aG9kcyc6CiAgICAgICAgICAgIG1lcmdlTWl4aW4odHlwZSwgbWl4aW5bdHlwZV0sIHRhZ1t0eXBlXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnYWNjZXNzb3JzJzogY2FzZSAncHJvdG90eXBlJzoKICAgICAgICAgICAgZm9yICh2YXIgeiBpbiBtaXhpblt0eXBlXSkgbWVyZ2VNaXhpbih6LCBtaXhpblt0eXBlXSwgdGFnLmFjY2Vzc29ycyk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAnZXZlbnRzJzoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHJldHVybiB0YWc7CiAgfQoKLy8gRXZlbnRzCgogIGZ1bmN0aW9uIHRvdWNoRmlsdGVyKGN1c3RvbSwgZXZlbnQpIHsKICAgIHZhciByZXRWYWw7CiAgICBpZiAoY3VzdG9tLmxpc3RlbmVyLnRvdWNoZWQpIHsKICAgICAgY3VzdG9tLmxpc3RlbmVyLnRvdWNoZWQgPSBmYWxzZTsKICAgICAgcmV0VmFsID0gZmFsc2U7CiAgICB9CiAgICBlbHNlIGlmIChldmVudC50eXBlLm1hdGNoKCd0b3VjaCcpKXsKICAgICBjdXN0b20ubGlzdGVuZXIudG91Y2hlZCA9IHRydWU7CiAgICB9CiAgICByZXR1cm4gcmV0VmFsOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRmxvd0V2ZW50KHR5cGUpIHsKICAgIHZhciBmbG93ID0gdHlwZSA9PSAnb3Zlcic7CiAgICByZXR1cm4gewogICAgICBiYXNlOiAnT3ZlcmZsb3dFdmVudCcgaW4gd2luID8gJ292ZXJmbG93Y2hhbmdlZCcgOiB0eXBlICsgJ2Zsb3cnLAogICAgICBjb25kaXRpb246IGZ1bmN0aW9uIChjdXN0b20sIGV2ZW50KSB7CiAgICAgICAgZXZlbnQuZmxvdyA9IHR5cGU7CiAgICAgICAgcmV0dXJuIGV2ZW50LnR5cGUgPT0gKHR5cGUgKyAnZmxvdycpIHx8CiAgICAgICAgKChldmVudC5vcmllbnQgPT09IDAgJiYgZXZlbnQuaG9yaXpvbnRhbE92ZXJmbG93ID09IGZsb3cpIHx8CiAgICAgICAgKGV2ZW50Lm9yaWVudCA9PSAxICYmIGV2ZW50LnZlcnRpY2FsT3ZlcmZsb3cgPT0gZmxvdykgfHwKICAgICAgICAoZXZlbnQub3JpZW50ID09IDIgJiYgZXZlbnQuaG9yaXpvbnRhbE92ZXJmbG93ID09IGZsb3cgJiYgZXZlbnQudmVydGljYWxPdmVyZmxvdyA9PSBmbG93KSk7CiAgICAgIH0KICAgIH07CiAgfQoKLy8gQWNjZXNzb3JzCgogIGZ1bmN0aW9uIGdldEFyZ3MoYXR0ciwgdmFsdWUpewogICAgcmV0dXJuIHsKICAgICAgdmFsdWU6IGF0dHIuYm9vbGVhbiA/ICcnIDogdmFsdWUsCiAgICAgIG1ldGhvZDogYXR0ci5ib29sZWFuICYmICh2YWx1ZSA9PT0gZmFsc2UgfHwgdmFsdWUgPT09IG51bGwpID8gJ3JlbW92ZUF0dHJpYnV0ZScgOiAnc2V0QXR0cmlidXRlJwogICAgfTsKICB9CgogIGZ1bmN0aW9uIHNldEF0dHIoYXR0ciwgbmFtZSwgdmFsdWUpewogICAgdmFyIGFyZ3MgPSBnZXRBcmdzKGF0dHIsIHZhbHVlKTsKICAgIHRoaXNbYXJncy5tZXRob2RdKG5hbWUsIGFyZ3MudmFsdWUpOwogIH0KCiAgZnVuY3Rpb24gc3luY0F0dHIoYXR0ciwgbmFtZSwgdmFsdWUpewogICAgdmFyIGFyZ3MgPSBnZXRBcmdzKGF0dHIsIHZhbHVlKSwKICAgICAgICBub2RlcyA9IGF0dHIucHJvcGVydHkgPyBbdGhpcy54dGFnW2F0dHIucHJvcGVydHldXSA6IGF0dHIuc2VsZWN0b3IgPyB4dGFnLnF1ZXJ5KHRoaXMsIGF0dHIuc2VsZWN0b3IpIDogW10sCiAgICAgICAgaW5kZXggPSBub2Rlcy5sZW5ndGg7CiAgICB3aGlsZSAoaW5kZXgtLSkgbm9kZXNbaW5kZXhdW2FyZ3MubWV0aG9kXShuYW1lLCBhcmdzLnZhbHVlKTsKICB9CgogIGZ1bmN0aW9uIHdyYXBBdHRyKHRhZywgbWV0aG9kKXsKICAgIHZhciBvcmlnaW5hbCA9IHRhZy5wcm90b3R5cGVbbWV0aG9kXSB8fCBIVE1MRWxlbWVudC5wcm90b3R5cGVbbWV0aG9kXTsKICAgIHRhZy5wcm90b3R5cGVbbWV0aG9kXSA9IHsKICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgIGVudW1iZXJhYmxlOiB0cnVlLAogICAgICB2YWx1ZTogZnVuY3Rpb24gKG5hbWUsIHZhbHVlLCBza2lwKXsKICAgICAgICB2YXIgYXR0ciA9IHRhZy5hdHRyaWJ1dGVzW25hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgb3JpZ2luYWwuY2FsbCh0aGlzLCBuYW1lLCBhdHRyICYmIGF0dHIuYm9vbGVhbiA/ICcnIDogdmFsdWUpOwogICAgICAgIGlmIChhdHRyKSB7CiAgICAgICAgICBzeW5jQXR0ci5jYWxsKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICAgIGlmICghYXR0ci5za2lwICYmICF0aGlzLnh0YWcuX3NraXBBdHRyKSB7CiAgICAgICAgICAgIGF0dHIuc2V0dGVyLmNhbGwodGhpcywgYXR0ci5ib29sZWFuID8gbWV0aG9kID09ICdzZXRBdHRyaWJ1dGUnIDogdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkpOwogICAgICAgICAgfQogICAgICAgICAgZGVsZXRlIHRoaXMueHRhZy5fc2tpcEF0dHI7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gdXBkYXRlVGVtcGxhdGUoZWxlbWVudCwgbmFtZSwgdmFsdWUpewogICAgaWYgKGVsZW1lbnQudGVtcGxhdGUpewogICAgICBlbGVtZW50Lnh0YWcudGVtcGxhdGUudXBkYXRlQmluZGluZ1ZhbHVlKGVsZW1lbnQsIG5hbWUsIHZhbHVlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGF0dGFjaFByb3BlcnRpZXModGFnLCBwcm9wLCB6LCBhY2Nlc3NvciwgYXR0ciwgbmFtZSl7CiAgICB2YXIga2V5ID0gei5zcGxpdCgnOicpLCB0eXBlID0ga2V5WzBdOwogICAgaWYgKHR5cGUgPT0gJ2dldCcpIHsKICAgICAga2V5WzBdID0gcHJvcDsKICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQgPSB4dGFnLmFwcGx5UHNldWRvcyhrZXkuam9pbignOicpLCBhY2Nlc3Nvclt6XSwgdGFnLnBzZXVkb3MpOwogICAgfQogICAgZWxzZSBpZiAodHlwZSA9PSAnc2V0JykgewogICAgICBrZXlbMF0gPSBwcm9wOwogICAgICBpZiAoYXR0cikgYXR0ci5zZXR0ZXIgPSBhY2Nlc3Nvclt6XTsKICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQgPSB4dGFnLmFwcGx5UHNldWRvcyhrZXkuam9pbignOicpLCBhdHRyID8gZnVuY3Rpb24odmFsdWUsIHNraXApewogICAgICAgIHN5bmNBdHRyLmNhbGwodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgIGFjY2Vzc29yW3pdLmNhbGwodGhpcywgdmFsdWUpOwogICAgICAgIGlmICghc2tpcCAmJiAhYXR0ci5za2lwKSB7CiAgICAgICAgICB0aGlzLnh0YWcuX3NraXBBdHRyID0gdHJ1ZTsKICAgICAgICAgIHNldEF0dHIuY2FsbCh0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHVwZGF0ZVRlbXBsYXRlKHRoaXMsIG5hbWUsIHZhbHVlKTsKCiAgICAgIH0gOiBhY2Nlc3Nvclt6XSA/IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICBhY2Nlc3Nvclt6XS5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICB1cGRhdGVUZW1wbGF0ZSh0aGlzLCBuYW1lLCB2YWx1ZSk7CiAgICAgIH0gOiBudWxsLCB0YWcucHNldWRvcyk7CiAgICB9CiAgICBlbHNlIHRhZy5wcm90b3R5cGVbcHJvcF1bel0gPSBhY2Nlc3Nvclt6XTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQWNjZXNzb3IodGFnLCBwcm9wKXsKICAgIHRhZy5wcm90b3R5cGVbcHJvcF0gPSB7fTsKICAgIHZhciBhY2Nlc3NvciA9IHRhZy5hY2Nlc3NvcnNbcHJvcF0sCiAgICAgICAgYXR0ciA9IGFjY2Vzc29yLmF0dHJpYnV0ZSwKICAgICAgICBuYW1lID0gYXR0ciAmJiBhdHRyLm5hbWUgPyBhdHRyLm5hbWUudG9Mb3dlckNhc2UoKSA6IHByb3A7CgogICAgaWYgKGF0dHIpIHRhZy5hdHRyaWJ1dGVzW25hbWVdID0gYXR0cjsKICAgIGZvciAodmFyIHogaW4gYWNjZXNzb3IpIGF0dGFjaFByb3BlcnRpZXModGFnLCBwcm9wLCB6LCBhY2Nlc3NvciwgYXR0ciwgbmFtZSk7CgogICAgaWYgKGF0dHIpIHsKICAgICAgaWYgKCF0YWcucHJvdG90eXBlW3Byb3BdLmdldCkgewogICAgICAgIHZhciBtZXRob2QgPSAoYXR0ci5ib29sZWFuID8gJ2hhcycgOiAnZ2V0JykgKyAnQXR0cmlidXRlJzsKICAgICAgICB0YWcucHJvdG90eXBlW3Byb3BdLmdldCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICByZXR1cm4gdGhpc1ttZXRob2RdKG5hbWUpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgaWYgKCF0YWcucHJvdG90eXBlW3Byb3BdLnNldCkgdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgdGhpcy54dGFnLl9za2lwQXR0ciA9IHRydWU7CiAgICAgICAgc2V0QXR0ci5jYWxsKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICB1cGRhdGVUZW1wbGF0ZSh0aGlzLCBuYW1lLCB2YWx1ZSk7CiAgICAgIH07CiAgICB9CiAgfQoKLyoqKiBYLVRhZyBPYmplY3QgRGVmaW5pdGlvbiAqKiovCgogIHZhciB4dGFnID0gewogICAgdGFnczoge30sCiAgICBkZWZhdWx0T3B0aW9uczogewogICAgICBwc2V1ZG9zOiBbXSwKICAgICAgbWl4aW5zOiBbXSwKICAgICAgZXZlbnRzOiB7fSwKICAgICAgbWV0aG9kczoge30sCiAgICAgIGFjY2Vzc29yczogewogICAgICAgIHRlbXBsYXRlOiB7CiAgICAgICAgICBhdHRyaWJ1dGU6IHt9LAogICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgICAgIHZhciBsYXN0ID0gdGhpcy5nZXRBdHRyaWJ1dGUoJ3RlbXBsYXRlJyk7CiAgICAgICAgICAgIHRoaXMueHRhZy5fX3ByZXZpb3VzVGVtcGxhdGVfXyA9IGxhc3Q7CiAgICAgICAgICAgIHh0YWcuZmlyZUV2ZW50KHRoaXMsICd0ZW1wbGF0ZWNoYW5nZScsIHsgdGVtcGxhdGU6IHZhbHVlIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgbGlmZWN5Y2xlOiB7fSwKICAgICAgYXR0cmlidXRlczoge30sCiAgICAgICdwcm90b3R5cGUnOiB7CiAgICAgICAgeHRhZzogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gdGhpcy5fX3h0YWdfXyA/IHRoaXMuX194dGFnX18gOiAodGhpcy5fX3h0YWdfXyA9IHsgZGF0YToge30gfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcmVnaXN0ZXI6IGZ1bmN0aW9uIChuYW1lLCBvcHRpb25zKSB7CiAgICAgIHZhciBlbGVtZW50LCBfbmFtZTsKICAgICAgaWYgKHR5cGVvZiBuYW1lID09ICdzdHJpbmcnKSB7CiAgICAgICAgX25hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0gZWxzZSBpZiAobmFtZS5ub2RlTmFtZSA9PSAnRUxFTUVOVCcpIHsKICAgICAgICBlbGVtZW50ID0gbmFtZTsKICAgICAgICBfbmFtZSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCduYW1lJykudG9Mb3dlckNhc2UoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciB0YWcgPSB4dGFnLnRhZ3NbX25hbWVdID0gYXBwbHlNaXhpbnMoeHRhZy5tZXJnZSh7fSwgeHRhZy5kZWZhdWx0T3B0aW9ucywgb3B0aW9ucykpOwoKICAgICAgZm9yICh2YXIgeiBpbiB0YWcuZXZlbnRzKSB0YWcuZXZlbnRzW3pdID0geHRhZy5wYXJzZUV2ZW50KHosIHRhZy5ldmVudHNbel0pOwogICAgICBmb3IgKHogaW4gdGFnLmxpZmVjeWNsZSkgdGFnLmxpZmVjeWNsZVt6LnNwbGl0KCc6JylbMF1dID0geHRhZy5hcHBseVBzZXVkb3MoeiwgdGFnLmxpZmVjeWNsZVt6XSwgdGFnLnBzZXVkb3MpOwogICAgICBmb3IgKHogaW4gdGFnLm1ldGhvZHMpIHRhZy5wcm90b3R5cGVbei5zcGxpdCgnOicpWzBdXSA9IHsgdmFsdWU6IHh0YWcuYXBwbHlQc2V1ZG9zKHosIHRhZy5tZXRob2RzW3pdLCB0YWcucHNldWRvcyksIGVudW1lcmFibGU6IHRydWUgfTsKICAgICAgZm9yICh6IGluIHRhZy5hY2Nlc3NvcnMpIHBhcnNlQWNjZXNzb3IodGFnLCB6KTsKCiAgICAgIHZhciByZWFkeSA9IHRhZy5saWZlY3ljbGUuY3JlYXRlZCB8fCB0YWcubGlmZWN5Y2xlLnJlYWR5OwogICAgICB0YWcucHJvdG90eXBlLnJlYWR5Q2FsbGJhY2sgPSB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24oKXsKICAgICAgICAgIHZhciBlbGVtZW50ID0gdGhpczsKICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCd0ZW1wbGF0ZScpOwogICAgICAgICAgaWYgKHRlbXBsYXRlKXsKICAgICAgICAgICAgeHRhZy5maXJlRXZlbnQodGhpcywgJ3RlbXBsYXRlY2hhbmdlJywgeyB0ZW1wbGF0ZTogdGVtcGxhdGUgfSk7CiAgICAgICAgICB9CiAgICAgICAgICB4dGFnLmFkZEV2ZW50cyh0aGlzLCB0YWcuZXZlbnRzKTsKICAgICAgICAgIHRhZy5taXhpbnMuZm9yRWFjaChmdW5jdGlvbihtaXhpbil7CiAgICAgICAgICAgIGlmICh4dGFnLm1peGluc1ttaXhpbl0uZXZlbnRzKSB4dGFnLmFkZEV2ZW50cyhlbGVtZW50LCB4dGFnLm1peGluc1ttaXhpbl0uZXZlbnRzKTsKICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIG91dHB1dCA9IHJlYWR5ID8gcmVhZHkuYXBwbHkodGhpcywgdG9BcnJheShhcmd1bWVudHMpKSA6IG51bGw7CiAgICAgICAgICBmb3IgKHZhciBuYW1lIGluIHRhZy5hdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgIHZhciBhdHRyID0gdGFnLmF0dHJpYnV0ZXNbbmFtZV0sCiAgICAgICAgICAgICAgICBoYXNBdHRyID0gdGhpcy5oYXNBdHRyaWJ1dGUobmFtZSksCiAgICAgICAgICAgICAgICB2YWx1ZSA9IGF0dHIuYm9vbGVhbiA/IGhhc0F0dHIgOiB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgaWYgKGF0dHIuYm9vbGVhbiB8fCBoYXNBdHRyKSB7CiAgICAgICAgICAgICAgc3luY0F0dHIuY2FsbCh0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgaWYgKGF0dHIuc2V0dGVyKSBhdHRyLnNldHRlci5jYWxsKHRoaXMsIHZhbHVlLCB0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGFnLnBzZXVkb3MuZm9yRWFjaChmdW5jdGlvbihvYmopewogICAgICAgICAgICBvYmoub25BZGQuY2FsbChlbGVtZW50LCBvYmopOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLmluc2VydGVkKSB0YWcucHJvdG90eXBlLmluc2VydGVkQ2FsbGJhY2sgPSB7IHZhbHVlOiB0YWcubGlmZWN5Y2xlLmluc2VydGVkLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLnJlbW92ZWQpIHRhZy5wcm90b3R5cGUucmVtb3ZlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5yZW1vdmVkLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLmF0dHJpYnV0ZUNoYW5nZWQpIHRhZy5wcm90b3R5cGUuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5hdHRyaWJ1dGVDaGFuZ2VkLCBlbnVtZXJhYmxlOiB0cnVlIH07CgogICAgICB3cmFwQXR0cih0YWcsICdzZXRBdHRyaWJ1dGUnKTsKICAgICAgd3JhcEF0dHIodGFnLCAncmVtb3ZlQXR0cmlidXRlJyk7CgogICAgICBpZiAoZWxlbWVudCl7CiAgICAgICAgZWxlbWVudC5yZWdpc3Rlcih7CiAgICAgICAgICAncHJvdG90eXBlJzogT2JqZWN0LmNyZWF0ZShPYmplY3QucHJvdG90eXBlLCB0YWcucHJvdG90eXBlKQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkb2MucmVnaXN0ZXIoX25hbWUsIHsKICAgICAgICAgICdleHRlbmRzJzogb3B0aW9uc1snZXh0ZW5kcyddLAogICAgICAgICAgJ3Byb3RvdHlwZSc6IE9iamVjdC5jcmVhdGUoT2JqZWN0LmNyZWF0ZSgob3B0aW9uc1snZXh0ZW5kcyddID8KICAgICAgICAgICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudChvcHRpb25zWydleHRlbmRzJ10pLmNvbnN0cnVjdG9yIDoKICAgICAgICAgICAgd2luLkhUTUxFbGVtZW50KS5wcm90b3R5cGUsIHRhZy5wcm90b3R5cGUpLCB0YWcucHJvdG90eXBlKQogICAgICAgIH0pOwogICAgICB9CiAgICB9LAoKICAgIC8qIEV4cG9zZWQgVmFyaWFibGVzICovCgogICAgbWl4aW5zOiB7fSwKICAgIHByZWZpeDogcHJlZml4LAogICAgdGVtcGxhdGVzOiB7fSwKICAgIGNhcHR1cmVFdmVudHM6IFsnZm9jdXMnLCAnYmx1ciddLAogICAgY3VzdG9tRXZlbnRzOiB7CiAgICAgIG92ZXJmbG93OiBjcmVhdGVGbG93RXZlbnQoJ292ZXInKSwKICAgICAgdW5kZXJmbG93OiBjcmVhdGVGbG93RXZlbnQoJ3VuZGVyJyksCiAgICAgIGFuaW1hdGlvbnN0YXJ0OiB7CiAgICAgICAgYmFzZTogWwogICAgICAgICAgJ2FuaW1hdGlvbnN0YXJ0JywKICAgICAgICAgICdvQW5pbWF0aW9uU3RhcnQnLAogICAgICAgICAgJ01TQW5pbWF0aW9uU3RhcnQnLAogICAgICAgICAgJ3dlYmtpdEFuaW1hdGlvblN0YXJ0JwogICAgICAgIF0KICAgICAgfSwKICAgICAgdHJhbnNpdGlvbmVuZDogewogICAgICAgIGJhc2U6IFsKICAgICAgICAgICd0cmFuc2l0aW9uZW5kJywKICAgICAgICAgICdvVHJhbnNpdGlvbkVuZCcsCiAgICAgICAgICAnTVNUcmFuc2l0aW9uRW5kJywKICAgICAgICAgICd3ZWJraXRUcmFuc2l0aW9uRW5kJwogICAgICAgIF0KICAgICAgfSwKICAgICAgdGFwOiB7CiAgICAgICAgYmFzZTogWydjbGljaycsICd0b3VjaGVuZCddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwc3RhcnQ6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlZG93bicsICd0b3VjaHN0YXJ0J10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBlbmQ6IHsKICAgICAgICBiYXNlOiBbJ21vdXNldXAnLCAndG91Y2hlbmQnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcGVudGVyOiB7CiAgICAgICAgYmFzZTogWydtb3VzZW92ZXInLCAndG91Y2hlbnRlciddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwbGVhdmU6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlb3V0JywgJ3RvdWNobGVhdmUnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcG1vdmU6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlbW92ZScsICd0b3VjaG1vdmUnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0KICAgIH0sCiAgICBwc2V1ZG9zOiB7CiAgICAgIGtleXBhc3M6IGtleXBzZXVkbywKICAgICAga2V5ZmFpbDoga2V5cHNldWRvLAogICAgICBkZWxlZ2F0ZTogewogICAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSBxdWVyeSh0aGlzLCBwc2V1ZG8udmFsdWUpLmZpbHRlcihmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZSA9PSBldmVudC50YXJnZXQgfHwgbm9kZS5jb250YWlucyA/IG5vZGUuY29udGFpbnMoZXZlbnQudGFyZ2V0KSA6IGZhbHNlOwogICAgICAgICAgfSlbMF07CiAgICAgICAgICByZXR1cm4gdGFyZ2V0ID8gcHNldWRvLmxpc3RlbmVyID0gcHNldWRvLmxpc3RlbmVyLmJpbmQodGFyZ2V0KSA6IGZhbHNlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJldmVudGFibGU6IHsKICAgICAgICBhY3Rpb246IGZ1bmN0aW9uIChwc2V1ZG8sIGV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qIFVUSUxJVElFUyAqLwoKICAgIGNsb25lOiBjbG9uZSwKICAgIHR5cGVPZjogdHlwZU9mLAogICAgdG9BcnJheTogdG9BcnJheSwKCiAgICB3cmFwOiBmdW5jdGlvbiAob3JpZ2luYWwsIGZuKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgcmV0dXJuZWQgPSBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICByZXR1cm4gcmV0dXJuZWQgPT09IGZhbHNlID8gZmFsc2UgOiBmbi5hcHBseSh0aGlzLCB0eXBlb2YgcmV0dXJuZWQgIT0gJ3VuZGVmaW5lZCcgPyB0b0FycmF5KHJldHVybmVkKSA6IGFyZ3MpOwogICAgICB9OwogICAgfSwKCiAgICBtZXJnZTogZnVuY3Rpb24oc291cmNlLCBrLCB2KXsKICAgICAgaWYgKHR5cGVPZihrKSA9PSAnc3RyaW5nJykgcmV0dXJuIG1lcmdlT25lKHNvdXJjZSwgaywgdik7CiAgICAgIGZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CiAgICAgICAgdmFyIG9iamVjdCA9IGFyZ3VtZW50c1tpXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBtZXJnZU9uZShzb3VyY2UsIGtleSwgb2JqZWN0W2tleV0pOwogICAgICB9CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9LAoKICAgIHVpZDogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLDEwKTsKICAgIH0sCgogICAgLyogRE9NICovCgogICAgcXVlcnk6IHF1ZXJ5LAoKICAgIHNraXBUcmFuc2l0aW9uOiBmdW5jdGlvbihlbGVtZW50LCBmbiwgYmluZCl7CiAgICAgIHZhciBwcm9wID0gcHJlZml4LmpzICsgJ1RyYW5zaXRpb25Qcm9wZXJ0eSc7CiAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICdub25lJzsKICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY2FsbGJhY2s7CiAgICAgICAgaWYgKGZuKSBjYWxsYmFjayA9IGZuLmNhbGwoYmluZCk7CiAgICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICcnOwogICAgICAgICAgaWYgKGNhbGxiYWNrKSB4dGFnLnJlcXVlc3RGcmFtZShjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKCiAgICByZXF1ZXN0RnJhbWU6IChmdW5jdGlvbigpewogICAgICB2YXIgcmFmID0gd2luLnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbltwcmVmaXgubG93ZXJjYXNlICsgJ1JlcXVlc3RBbmltYXRpb25GcmFtZSddIHx8CiAgICAgICAgZnVuY3Rpb24oZm4peyByZXR1cm4gd2luLnNldFRpbWVvdXQoZm4sIDIwKTsgfTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZuKXsKICAgICAgICByZXR1cm4gcmFmLmNhbGwod2luLCBmbik7CiAgICAgIH07CiAgICB9KSgpLAoKICAgIG1hdGNoU2VsZWN0b3I6IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICByZXR1cm4gbWF0Y2hTZWxlY3Rvci5jYWxsKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAoZWxlbWVudCwgbWV0aG9kLCB2YWx1ZSkgewogICAgICBlbGVtZW50W21ldGhvZF0gPSB2YWx1ZTsKICAgICAgaWYgKHdpbmRvdy5DdXN0b21FbGVtZW50cykgQ3VzdG9tRWxlbWVudHMudXBncmFkZUFsbChlbGVtZW50KTsKICAgIH0sCgogICAgaW5uZXJIVE1MOiBmdW5jdGlvbihlbCwgaHRtbCl7CiAgICAgIHh0YWcuc2V0KGVsLCAnaW5uZXJIVE1MJywgaHRtbCk7CiAgICB9LAoKICAgIGhhc0NsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQuY2xhc3NOYW1lLnNwbGl0KCcgJykuaW5kZXhPZihrbGFzcy50cmltKCkpPi0xOwogICAgfSwKCiAgICBhZGRDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHZhciBsaXN0ID0gZWxlbWVudC5jbGFzc05hbWUudHJpbSgpLnNwbGl0KCcgJyk7CiAgICAgIGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBpZiAoIX5saXN0LmluZGV4T2YobmFtZSkpIGxpc3QucHVzaChuYW1lKTsKICAgICAgfSk7CiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gbGlzdC5qb2luKCcgJykudHJpbSgpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0sCgogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICB2YXIgY2xhc3NlcyA9IGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpOwogICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnRyaW0oKS5zcGxpdCgnICcpLmZpbHRlcihmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHJldHVybiBuYW1lICYmICF+Y2xhc3Nlcy5pbmRleE9mKG5hbWUpOwogICAgICB9KS5qb2luKCcgJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfSwKCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHJldHVybiB4dGFnW3h0YWcuaGFzQ2xhc3MoZWxlbWVudCwga2xhc3MpID8gJ3JlbW92ZUNsYXNzJyA6ICdhZGRDbGFzcyddLmNhbGwobnVsbCwgZWxlbWVudCwga2xhc3MpOwoKICAgIH0sCgogICAgcXVlcnlDaGlsZHJlbjogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgIHZhciBpZCA9IGVsZW1lbnQuaWQsCiAgICAgICAgZ3VpZCA9IGVsZW1lbnQuaWQgPSBpZCB8fCAneF8nICsgeHRhZy51aWQoKSwKICAgICAgICBhdHRyID0gJyMnICsgZ3VpZCArICcgPiAnOwogICAgICBzZWxlY3RvciA9IGF0dHIgKyAoc2VsZWN0b3IgKyAnJykucmVwbGFjZSgnLCcsICcsJyArIGF0dHIsICdnJyk7CiAgICAgIHZhciByZXN1bHQgPSBlbGVtZW50LnBhcmVudE5vZGUucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICAgIGlmICghaWQpIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwogICAgICByZXR1cm4gdG9BcnJheShyZXN1bHQpOwogICAgfSwKCiAgICBjcmVhdGVGcmFnbWVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICB2YXIgZnJhZyA9IGRvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIGlmIChjb250ZW50KSB7CiAgICAgICAgdmFyIGRpdiA9IGZyYWcuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpKSwKICAgICAgICAgIG5vZGVzID0gdG9BcnJheShjb250ZW50Lm5vZGVOYW1lID8gYXJndW1lbnRzIDogIShkaXYuaW5uZXJIVE1MID0gY29udGVudCkgfHwgZGl2LmNoaWxkcmVuKSwKICAgICAgICAgIGxlbmd0aCA9IG5vZGVzLmxlbmd0aCwKICAgICAgICAgIGluZGV4ID0gMDsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIGZyYWcuaW5zZXJ0QmVmb3JlKG5vZGVzW2luZGV4KytdLCBkaXYpOwogICAgICAgIGZyYWcucmVtb3ZlQ2hpbGQoZGl2KTsKICAgICAgfQogICAgICByZXR1cm4gZnJhZzsKICAgIH0sCgogICAgbWFuaXB1bGF0ZTogZnVuY3Rpb24oZWxlbWVudCwgZm4pewogICAgICB2YXIgbmV4dCA9IGVsZW1lbnQubmV4dFNpYmxpbmcsCiAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlLAogICAgICAgIGZyYWcgPSBkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICAgIHJldHVybmVkID0gZm4uY2FsbChmcmFnLmFwcGVuZENoaWxkKGVsZW1lbnQpLCBmcmFnKSB8fCBlbGVtZW50OwogICAgICBpZiAobmV4dCkgcGFyZW50Lmluc2VydEJlZm9yZShyZXR1cm5lZCwgbmV4dCk7CiAgICAgIGVsc2UgcGFyZW50LmFwcGVuZENoaWxkKHJldHVybmVkKTsKICAgIH0sCgogICAgLyogUFNFVURPUyAqLwoKICAgIGFwcGx5UHNldWRvczogZnVuY3Rpb24oa2V5LCBmbiwgZWxlbWVudCkgewogICAgICB2YXIgbGlzdGVuZXIgPSBmbiwKICAgICAgICAgIHBzZXVkb3MgPSB7fTsKICAgICAgaWYgKGtleS5tYXRjaCgnOicpKSB7CiAgICAgICAgdmFyIHNwbGl0ID0ga2V5Lm1hdGNoKHJlZ2V4UHNldWRvU3BsaXQpLAogICAgICAgICAgICBpID0gc3BsaXQubGVuZ3RoOwogICAgICAgIHdoaWxlICgtLWkpIHsKICAgICAgICAgIHNwbGl0W2ldLnJlcGxhY2UocmVnZXhQc2V1ZG9SZXBsYWNlLCBmdW5jdGlvbiAobWF0Y2gsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICgheHRhZy5wc2V1ZG9zW25hbWVdKSB0aHJvdyAicHNldWRvIG5vdCBmb3VuZDogIiArIG5hbWUgKyAiICIgKyBzcGxpdDsKICAgICAgICAgICAgdmFyIHBzZXVkbyA9IHBzZXVkb3NbaV0gPSBPYmplY3QuY3JlYXRlKHh0YWcucHNldWRvc1tuYW1lXSk7CiAgICAgICAgICAgICAgICBwc2V1ZG8ua2V5ID0ga2V5OwogICAgICAgICAgICAgICAgcHNldWRvLm5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgcHNldWRvLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIHZhciBsYXN0ID0gbGlzdGVuZXI7CiAgICAgICAgICAgIGxpc3RlbmVyID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICAgICAgICAgICAgb2JqID0gewogICAgICAgICAgICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyOiBsYXN0CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgaWYgKHBzZXVkby5hY3Rpb24gJiYgcHNldWRvLmFjdGlvbi5hcHBseSh0aGlzLCBbb2JqXS5jb25jYXQoYXJncykpID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIHJldHVybiBvYmoubGlzdGVuZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIHBzZXVkby5vbkFkZCkgewogICAgICAgICAgICAgIGlmIChlbGVtZW50LmdldEF0dHJpYnV0ZSkgewogICAgICAgICAgICAgICAgcHNldWRvLm9uQWRkLmNhbGwoZWxlbWVudCwgcHNldWRvKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZWxlbWVudC5wdXNoKHBzZXVkbyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yICh2YXIgeiBpbiBwc2V1ZG9zKSB7CiAgICAgICAgaWYgKHBzZXVkb3Nbel0ub25Db21waWxlZCkgbGlzdGVuZXIgPSBwc2V1ZG9zW3pdLm9uQ29tcGlsZWQobGlzdGVuZXIsIHBzZXVkb3Nbel0pOwogICAgICB9CiAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgIH0sCgogICAgcmVtb3ZlUHNldWRvczogZnVuY3Rpb24oZWxlbWVudCwgZXZlbnQpewogICAgICBldmVudC5fcHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgb2JqLm9uUmVtb3ZlLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgfSk7CiAgICB9LAoKICAvKioqIEV2ZW50cyAqKiovCgogICAgcGFyc2VFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pIHsKICAgICAgdmFyIHBzZXVkb3MgPSB0eXBlLnNwbGl0KCc6JyksCiAgICAgICAga2V5ID0gcHNldWRvcy5zaGlmdCgpLAogICAgICAgIGV2ZW50ID0geHRhZy5tZXJnZSh7CiAgICAgICAgICBiYXNlOiBrZXksCiAgICAgICAgICBwc2V1ZG9zOiAnJywKICAgICAgICAgIF9wc2V1ZG9zOiBbXSwKICAgICAgICAgIG9uQWRkOiBub29wLAogICAgICAgICAgb25SZW1vdmU6IG5vb3AsCiAgICAgICAgICBjb25kaXRpb246IG5vb3AKICAgICAgICB9LCB4dGFnLmN1c3RvbUV2ZW50c1trZXldIHx8IHt9KTsKICAgICAgZXZlbnQudHlwZSA9IGtleSArIChldmVudC5wc2V1ZG9zLmxlbmd0aCA/ICc6JyArIGV2ZW50LnBzZXVkb3MgOiAnJykgKyAocHNldWRvcy5sZW5ndGggPyAnOicgKyBwc2V1ZG9zLmpvaW4oJzonKSA6ICcnKTsKICAgICAgaWYgKGZuKSB7CiAgICAgICAgdmFyIGNoYWluZWQgPSB4dGFnLmFwcGx5UHNldWRvcyhldmVudC50eXBlLCBmbiwgZXZlbnQuX3BzZXVkb3MpOwogICAgICAgIGV2ZW50Lmxpc3RlbmVyID0gZnVuY3Rpb24oKXsKICAgICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpOwogICAgICAgICAgaWYgKGV2ZW50LmNvbmRpdGlvbi5hcHBseSh0aGlzLCBbZXZlbnRdLmNvbmNhdChhcmdzKSkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICByZXR1cm4gY2hhaW5lZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiBldmVudDsKICAgIH0sCgogICAgYWRkRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgewogICAgICB2YXIgZXZlbnQgPSAodHlwZW9mIGZuID09ICdmdW5jdGlvbicpID8geHRhZy5wYXJzZUV2ZW50KHR5cGUsIGZuKSA6IGZuOwogICAgICBldmVudC5saXN0ZW5lci5ldmVudCA9IGV2ZW50OwogICAgICBldmVudC5fcHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgb2JqLm9uQWRkLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgfSk7CiAgICAgIGV2ZW50Lm9uQWRkLmNhbGwoZWxlbWVudCwgZXZlbnQsIGV2ZW50Lmxpc3RlbmVyKTsKICAgICAgdG9BcnJheShldmVudC5iYXNlKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKG5hbWUsIGV2ZW50Lmxpc3RlbmVyLCB4dGFnLmNhcHR1cmVFdmVudHMuaW5kZXhPZihuYW1lKSA+IC0xKTsKICAgICAgfSk7CiAgICAgIHJldHVybiBldmVudC5saXN0ZW5lcjsKICAgIH0sCgogICAgYWRkRXZlbnRzOiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnRzKSB7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB7fTsKICAgICAgZm9yICh2YXIgeiBpbiBldmVudHMpIHsKICAgICAgICBsaXN0ZW5lcnNbel0gPSB4dGFnLmFkZEV2ZW50KGVsZW1lbnQsIHosIGV2ZW50c1t6XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgIH0sCgogICAgcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbikgewogICAgICB2YXIgZXZlbnQgPSBmbi5ldmVudDsKICAgICAgZXZlbnQub25SZW1vdmUuY2FsbChlbGVtZW50LCBldmVudCwgZm4pOwogICAgICB4dGFnLnJlbW92ZVBzZXVkb3MoZWxlbWVudCwgZXZlbnQpOwogICAgICB0b0FycmF5KGV2ZW50LmJhc2UpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIobmFtZSwgZm4pOwogICAgICB9KTsKICAgIH0sCgogICAgcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihlbGVtZW50LCBsaXN0ZW5lcnMpewogICAgICBmb3IgKHZhciB6IGluIGxpc3RlbmVycykgeHRhZy5yZW1vdmVFdmVudChlbGVtZW50LCB6LCBsaXN0ZW5lcnNbel0pOwogICAgfSwKCiAgICBmaXJlRXZlbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGRhdGEsIG9wdGlvbnMpewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdmFyIGV2ZW50ID0gZG9jLmNyZWF0ZUV2ZW50KCdFdmVudCcpOwogICAgICBldmVudC5pbml0RXZlbnQodHlwZSwgJ2J1YmJsZXMnIGluIG9wdGlvbnMgPyBvcHRpb25zLmJ1YmJsZXMgOiB0cnVlLCAnY2FuY2VsYWJsZScgaW4gb3B0aW9ucyA/IG9wdGlvbnMuY2FuY2VsYWJsZSA6IHRydWUpOwogICAgICBmb3IgKHZhciB6IGluIGRhdGEpIGV2ZW50W3pdID0gZGF0YVt6XTsKICAgICAgZWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgIH0sCgogICAgYWRkT2JzZXJ2ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgaWYgKCFlbGVtZW50Ll9yZWNvcmRzKSB7CiAgICAgICAgZWxlbWVudC5fcmVjb3JkcyA9IHsgaW5zZXJ0ZWQ6IFtdLCByZW1vdmVkOiBbXSB9OwogICAgICAgIGlmIChtdXRhdGlvbil7CiAgICAgICAgICBlbGVtZW50Ll9vYnNlcnZlciA9IG5ldyBtdXRhdGlvbihmdW5jdGlvbihtdXRhdGlvbnMpIHsKICAgICAgICAgICAgcGFyc2VNdXRhdGlvbnMoZWxlbWVudCwgbXV0YXRpb25zKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZWxlbWVudC5fb2JzZXJ2ZXIub2JzZXJ2ZShlbGVtZW50LCB7CiAgICAgICAgICAgIHN1YnRyZWU6IHRydWUsCiAgICAgICAgICAgIGNoaWxkTGlzdDogdHJ1ZSwKICAgICAgICAgICAgYXR0cmlidXRlczogIXRydWUsCiAgICAgICAgICAgIGNoYXJhY3RlckRhdGE6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBbJ0luc2VydGVkJywgJ1JlbW92ZWQnXS5mb3JFYWNoKGZ1bmN0aW9uKHR5cGUpewogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlJyArIHR5cGUsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgICAgZXZlbnQuX211dGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZWxlbWVudC5fcmVjb3Jkc1t0eXBlLnRvTG93ZXJDYXNlKCldLmZvckVhY2goZnVuY3Rpb24oZm4pewogICAgICAgICAgICAgIGZuKGV2ZW50LnRhcmdldCwgZXZlbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoZWxlbWVudC5fcmVjb3Jkc1t0eXBlXS5pbmRleE9mKGZuKSA9PSAtMSkgZWxlbWVudC5fcmVjb3Jkc1t0eXBlXS5wdXNoKGZuKTsKICAgIH0sCgogICAgcmVtb3ZlT2JzZXJ2ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgdmFyIG9iaiA9IGVsZW1lbnQuX3JlY29yZHM7CiAgICAgIGlmIChvYmogJiYgZm4pewogICAgICAgIG9ialt0eXBlXS5zcGxpY2Uob2JqW3R5cGVdLmluZGV4T2YoZm4pLCAxKTsKICAgICAgfQogICAgICBlbHNlewogICAgICAgIG9ialt0eXBlXSA9IFtdOwogICAgICB9CiAgICB9CgogIH07CgogIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgZGVmaW5lKHh0YWcpOwogIGVsc2Ugd2luLnh0YWcgPSB4dGFnOwoKICBkb2MuYWRkRXZlbnRMaXN0ZW5lcignV2ViQ29tcG9uZW50c1JlYWR5JywgZnVuY3Rpb24oKXsKICAgIHh0YWcuZmlyZUV2ZW50KGRvYy5ib2R5LCAnRE9NQ29tcG9uZW50c0xvYWRlZCcpOwogIH0pOwoKfSkoKTsKKGZ1bmN0aW9uKCl7Cgp2YXIgaGVhZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2hlYWQnKTsKdmFyIGFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKYW5jaG9yLmhyZWYgPSAnJzsKeHRhZy5jYWxsYmFja3MgPSB7fTsKCiAgZnVuY3Rpb24gcmVxdWVzdChlbGVtZW50LCBvcHRpb25zKXsKICAgIGNsZWFyUmVxdWVzdChlbGVtZW50KTsKICAgIHZhciBsYXN0ID0gZWxlbWVudC54dGFnLnJlcXVlc3QgfHwge307CiAgICBlbGVtZW50Lnh0YWcucmVxdWVzdCA9IG9wdGlvbnM7CiAgICB2YXIgcmVxdWVzdCA9IGVsZW1lbnQueHRhZy5yZXF1ZXN0LAogICAgICBjYWxsYmFja0tleSA9IChlbGVtZW50LmdldEF0dHJpYnV0ZSgnZGF0YS1jYWxsYmFjay1rZXknKSB8fAogICAgICAgICdjYWxsYmFjaycpICsgJz14dGFnLmNhbGxiYWNrcy4nOwogICAgaWYgKHh0YWcuZmlyZUV2ZW50KGVsZW1lbnQsICdiZWZvcmVyZXF1ZXN0JykgPT09IGZhbHNlKSByZXR1cm4gZmFsc2U7CiAgICBpZiAobGFzdC51cmwgJiYgIW9wdGlvbnMudXBkYXRlICYmCiAgICAgIGxhc3QudXJsLnJlcGxhY2UobmV3IFJlZ0V4cCgnXCY/XCgnICsgY2FsbGJhY2tLZXkgKyAneFswLTldKyknKSwgJycpID09CiAgICAgICAgZWxlbWVudC54dGFnLnJlcXVlc3QudXJsKXsKICAgICAgZWxlbWVudC54dGFnLnJlcXVlc3QgPSBsYXN0OwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnc3JjJywgZWxlbWVudC54dGFnLnJlcXVlc3QudXJsKTsKICAgIGFuY2hvci5ocmVmID0gb3B0aW9ucy51cmw7CiAgICBpZiAoYW5jaG9yLmhvc3RuYW1lID09IHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZSkgewogICAgICByZXF1ZXN0ID0geHRhZy5tZXJnZShuZXcgWE1MSHR0cFJlcXVlc3QoKSwgcmVxdWVzdCk7CiAgICAgIHJlcXVlc3Qub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKXsKICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnZGF0YS1yZWFkeXN0YXRlJywgcmVxdWVzdC5yZWFkeVN0YXRlKTsKICAgICAgICBpZiAocmVxdWVzdC5yZWFkeVN0YXRlID09IDQgJiYgcmVxdWVzdC5zdGF0dXMgPCA0MDApewogICAgICAgICAgcmVxdWVzdENhbGxiYWNrKGVsZW1lbnQsIHJlcXVlc3QpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgWydlcnJvcicsICdhYm9ydCcsICdsb2FkJ10uZm9yRWFjaChmdW5jdGlvbih0eXBlKXsKICAgICAgICByZXF1ZXN0WydvbicgKyB0eXBlXSA9IGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgIGV2ZW50LnJlcXVlc3QgPSByZXF1ZXN0OwogICAgICAgICAgeHRhZy5maXJlRXZlbnQoZWxlbWVudCwgdHlwZSwgZXZlbnQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJlcXVlc3Qub3BlbihyZXF1ZXN0Lm1ldGhvZCAsIHJlcXVlc3QudXJsLCB0cnVlKTsKICAgICAgcmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLAogICAgICAgICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnKTsKICAgICAgcmVxdWVzdC5zZW5kKCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgdmFyIGNhbGxiYWNrSUQgPSByZXF1ZXN0LmNhbGxiYWNrSUQgPSAneCcgKyBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2RhdGEtcmVhZHlzdGF0ZScsIHJlcXVlc3QucmVhZHlTdGF0ZSA9IDApOwogICAgICB4dGFnLmNhbGxiYWNrc1tjYWxsYmFja0lEXSA9IGZ1bmN0aW9uKGRhdGEpewogICAgICAgIHJlcXVlc3Quc3RhdHVzID0gMjAwOwogICAgICAgIHJlcXVlc3QucmVhZHlTdGF0ZSA9IDQ7CiAgICAgICAgcmVxdWVzdC5yZXNwb25zZVRleHQgPSBkYXRhOwogICAgICAgIHJlcXVlc3RDYWxsYmFjayhlbGVtZW50LCByZXF1ZXN0KTsKICAgICAgICBkZWxldGUgeHRhZy5jYWxsYmFja3NbY2FsbGJhY2tJRF07CiAgICAgICAgY2xlYXJSZXF1ZXN0KGVsZW1lbnQpOwogICAgICB9CiAgICAgIHJlcXVlc3Quc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICAgIHJlcXVlc3Quc2NyaXB0LnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0JzsKICAgICAgcmVxdWVzdC5zY3JpcHQuc3JjID0gb3B0aW9ucy51cmwgPSBvcHRpb25zLnVybCArCiAgICAgICAgKH5vcHRpb25zLnVybC5pbmRleE9mKCc/JykgPyAnJicgOiAnPycpICsgY2FsbGJhY2tLZXkgKyBjYWxsYmFja0lEOwogICAgICByZXF1ZXN0LnNjcmlwdC5vbmVycm9yID0gZnVuY3Rpb24oZXJyb3IpewogICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdkYXRhLXJlYWR5c3RhdGUnLCByZXF1ZXN0LnJlYWR5U3RhdGUgPSA0KTsKICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnZGF0YS1yZXF1ZXN0c3RhdHVzJywgcmVxdWVzdC5zdGF0dXMgPSA0MDApOwogICAgICAgIHh0YWcuZmlyZUV2ZW50KGVsZW1lbnQsICdlcnJvcicsIGVycm9yKTsKICAgICAgfQogICAgICBoZWFkLmFwcGVuZENoaWxkKHJlcXVlc3Quc2NyaXB0KTsKICAgIH0KICAgIGVsZW1lbnQueHRhZy5yZXF1ZXN0ID0gcmVxdWVzdDsKICB9CgogIGZ1bmN0aW9uIHJlcXVlc3RDYWxsYmFjayhlbGVtZW50LCByZXF1ZXN0KXsKICAgIGlmIChyZXF1ZXN0ICE9IGVsZW1lbnQueHRhZy5yZXF1ZXN0KSByZXR1cm4geHRhZzsKICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdkYXRhLXJlYWR5c3RhdGUnLCByZXF1ZXN0LnJlYWR5U3RhdGUpOwogICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2RhdGEtcmVxdWVzdHN0YXR1cycsIHJlcXVlc3Quc3RhdHVzKTsKICAgIHh0YWcuZmlyZUV2ZW50KGVsZW1lbnQsICdkYXRhcmVhZHknLCB7IHJlcXVlc3Q6IHJlcXVlc3QgfSk7CiAgICBpZiAoZWxlbWVudC5kYXRhcmVhZHkpIGVsZW1lbnQuZGF0YXJlYWR5LmNhbGwoZWxlbWVudCwgcmVxdWVzdCk7CiAgfQoKICBmdW5jdGlvbiBjbGVhclJlcXVlc3QoZWxlbWVudCl7CiAgICB2YXIgcmVxID0gZWxlbWVudC54dGFnLnJlcXVlc3Q7CiAgICBpZiAoIXJlcSkgcmV0dXJuIHh0YWc7CiAgICBpZiAocmVxLnNjcmlwdCAmJiB+eHRhZy50b0FycmF5KGhlYWQuY2hpbGRyZW4pLmluZGV4T2YocmVxLnNjcmlwdCkpIHsKICAgICAgaGVhZC5yZW1vdmVDaGlsZChyZXEuc2NyaXB0KTsKICAgIH0KICAgIGVsc2UgaWYgKHJlcS5hYm9ydCkgcmVxLmFib3J0KCk7CiAgfQoKCiAgeHRhZy5taXhpbnNbJ3JlcXVlc3QnXSA9IHsKICAgIGxpZmVjeWNsZTp7CiAgICAgIGNyZWF0ZWQ6ICBmdW5jdGlvbigpewogICAgICAgIHRoaXMuc3JjID0gdGhpcy5nZXRBdHRyaWJ1dGUoJ3NyYycpOwogICAgICB9CiAgICB9LAogICAgYWNjZXNzb3JzOnsKICAgICAgZGF0YXJlYWR5OnsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICByZXR1cm4gdGhpcy54dGFnLmRhdGFyZWFkeTsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24oZm4pewogICAgICAgICAgdGhpcy54dGFnLmRhdGFyZWFkeSA9IGZuOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc3JjOnsKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHNyYyl7CiAgICAgICAgICBpZiAoc3JjKXsKICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ3NyYycsIHNyYyk7CiAgICAgICAgICAgIHJlcXVlc3QodGhpcywgeyB1cmw6IHNyYywgbWV0aG9kOiAnR0VUJyB9KTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgICAgIHJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgnc3JjJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCn0pKCk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 03:44:41 GMT",
                    "Content-Length": "87363",
                    "Date": "Sun, 09 Nov 2014 03:44:41 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}