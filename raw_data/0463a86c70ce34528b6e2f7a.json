{
    "url": "http://localhost:9999/yairEO/photobox/photobox/jquery.photobox.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.location.search</b> and written to <b>window.history.pushState()</b> via the following statement:<ul><li>window.history.pushS ...RIC...(activeURL) ) </li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/yairEO/photobox/photobox/jquery.photobox.js",
                "path": "/yairEO/photobox/photobox/jquery.photobox.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC95YWlyRU8vcGhvdG9ib3gvcGhvdG9ib3gvanF1ZXJ5LnBob3RvYm94LmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDMwNTcNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMjE6NTg6NDkgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDIxOjU4OjQ5IEdNVA0KDQovKiEKICAgIHBob3RvYm94IHYxLjkuMQogICAgKGMpIDIwMTMgWWFpciBFdmVuIE9yIDxodHRwOi8vZHJvcHRoZWJpdC5jb20+CgogICAgTUlULXN0eWxlIGxpY2Vuc2UuCiovCgooZnVuY3Rpb24oJCwgZG9jLCB3aW4pewogICAgInVzZSBzdHJpY3QiOwoKICAgIHZhciBQaG90b2JveCwgcGhvdG9ib3gsIG9wdGlvbnMsIGltYWdlcz1bXSwgaW1hZ2VMaW5rcywgYWN0aXZlSW1hZ2UgPSAtMSwgYWN0aXZlVVJMLCBsYXN0QWN0aXZlLCBhY3RpdmVUeXBlLCBwcmV2SW1hZ2UsIG5leHRJbWFnZSwgdGh1bWJzU3RyaXBlLCBkb2NFbG0sIEFQQ29udHJvbCwKICAgICAgICB0cmFuc2l0aW9uZW5kID0gInRyYW5zaXRpb25lbmQgd2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCBNU1RyYW5zaXRpb25FbmQiLAogICAgICAgIGlzT2xkSUUgPSAhKCdwbGFjZWhvbGRlcicgaW4gZG9jLmNyZWF0ZUVsZW1lbnQoJ2lucHV0JykpLAogICAgICAgIG5vUG9pbnRlckV2ZW50cyA9IChmdW5jdGlvbigpeyB2YXIgZWwgPSAkKCc8cD4nKVswXTsgZWwuc3R5bGUuY3NzVGV4dCA9ICdwb2ludGVyLWV2ZW50czphdXRvJzsgcmV0dXJuICFlbC5zdHlsZS5wb2ludGVyRXZlbnRzfSkoKSwKICAgICAgICBpc01vYmlsZSA9ICdvbnRvdWNoZW5kJyBpbiBkb2MsIC8vIHNob3VsZCBiZSB1cGRhdGVkIHRvIHNvbWV0aGluZyB0aGF0IGRldGVjdHMgdGhlIGxhY2sgb2YgYSBtb3VzZQogICAgICAgIHRodW1ic0NvbnRhaW5lcldpZHRoLCB0aHVtYnNUb3RhbFdpZHRoLCBhY3RpdmVUaHVtYiA9ICQoKSwKICAgICAgICBibGFua0ltZyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQUFQLy8vLy8vL3lINUJBRUtBQUVBTEFBQUFBQUJBQUVBQUFJQ1RBRUFPdz09IiwKICAgICAgICB0cmFuc2Zvcm1PcmlnaW4gPSBnZXRQcmVmaXhlZCgndHJhbnNmb3JtT3JpZ2luJyksCiAgICAgICAgdHJhbnNpdGlvbiA9IGdldFByZWZpeGVkKCd0cmFuc2l0aW9uJyksCiAgICAgICAgICAvLyBOb3JtYWxpemUgckFGCiAgICAgICAgcmFmID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZQogICAgICAgICAgIHx8IHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUKICAgICAgICAgICB8fCB3aW5kb3cubW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lCiAgICAgICAgICAgfHwgd2luZG93Lm1zUmVxdWVzdEFuaW1hdGlvbkZyYW1lCiAgICAgICAgICAgfHwgZnVuY3Rpb24oY2IpIHsgcmV0dXJuIHdpbmRvdy5zZXRUaW1lb3V0KGNiLCAxMDAwIC8gNjApOyB9LAoKICAgICAgICAvLyBQcmVsb2FkIGltYWdlcwogICAgICAgIHByZWxvYWQgPSB7fSwgcHJlbG9hZFByZXYgPSBuZXcgSW1hZ2UoKSwgcHJlbG9hZE5leHQgPSBuZXcgSW1hZ2UoKSwKICAgICAgICAvLyBET00gZWxlbWVudHMKICAgICAgICBjbG9zZUJ0biwgaW1hZ2UsIHZpZGVvLCBwcmV2QnRuLCBuZXh0QnRuLCB0aHVtYnNUb2dnbGVyLCBjYXB0aW9uLCBjYXB0aW9uVGV4dCwgcGJMb2FkZXIsIGF1dG9wbGF5QnRuLCB0aHVtYnMsIHdyYXBwZXIsCgogICAgICAgIGRlZmF1bHRzID0gewogICAgICAgICAgICBzaW5nbGUgICAgICAgIDogZmFsc2UsICAgLy8gaWYgInRydWUiIC0gZ2FsbGVyeSB3aWxsIG9ubHkgc2hvdyBhIHNpbmdsZSBpbWFnZSwgd2l0aCBubyB3YXkgdG8gbmF2aWdhdGUKICAgICAgICAgICAgYmVmb3JlU2hvdyAgICA6IG51bGwsICAgIC8vIENhbGxiYWNrIGJlZm9yZSBzaG93aW5nIGFuIGltYWdlCiAgICAgICAgICAgIGFmdGVyQ2xvc2UgICAgOiBudWxsLCAgICAvLyBDYWxsYmFjayBhZnRlciBjbG9zaW5nIHRoZSBnYWxsZXJ5CiAgICAgICAgICAgIGxvb3AgICAgICAgICAgOiB0cnVlLCAgICAvLyBBbGxvd3MgdG8gbmF2aWdhdGUgYmV0d2VlbiBmaXJzdCBhbmQgbGFzdCBpbWFnZXMKICAgICAgICAgICAgdGh1bWIgICAgICAgICA6IG51bGwsICAgIC8vIEEgcmVsYXRpdmUgcGF0aCBmcm9tIHRoZSBsaW5rIHRvIHRoZSB0aHVtYm5haWwgKGlmIGl0J3Mgbm90IGluc2lkZSB0aGUgbGluaykKICAgICAgICAgICAgdGh1bWJzICAgICAgICA6IHRydWUsICAgIC8vIFNob3cgZ2FsbGVyeSB0aHVtYm5haWxzIGJlbG93IHRoZSBwcmVzZW50ZWQgcGhvdG8KICAgICAgICAgICAgY291bnRlciAgICAgICA6ICIoQS9CKSIsIC8vIENvdW50cyB3aGljaCBwaWVjZSBvZiBjb250ZW50IGlzIGJlaW5nIHZpZXdlZCwgcmVsYXRpdmUgdG8gdGhlIHRvdGFsIGNvdW50IG9mIGl0ZW1zIGluIHRoZSBwaG90b2JveCBzZXQuIFsiZmFsc2UiLCJTdHJpbmciXQogICAgICAgICAgICB0aXRsZSAgICAgICAgIDogdHJ1ZSwgICAgLy8gc2hvdyB0aGUgb3JpZ2luYWwgYWx0IG9yIHRpdGxlIGF0dHJpYnV0ZSBvZiB0aGUgaW1hZ2UncyB0aHVtYm5haWwuIChwYXRoIHRvIGltYWdlLCByZWxhdGl2ZSB0byB0aGUgZWxlbWVudCB3aGljaCB0cmlnZ2VycyBwaG90b2JveCkKICAgICAgICAgICAgYXV0b3BsYXkgICAgICA6IGZhbHNlLCAgIC8vIHNob3VsZCBhdXRvcGxheSBvbiBmaXJzdCB0aW1lIG9yIG5vdAogICAgICAgICAgICB0aW1lICAgICAgICAgIDogMzAwMCwgICAgLy8gYXV0b3BsYXkgaW50ZXJ2YWwsIGluIG1pbGlzZWNvbmRzIChsZXNzIHRoYW4gMTAwMCB3aWxsIGhpZGUgdGhlIGF1dG9wbGF5IGJ1dHRvbikKICAgICAgICAgICAgaGlzdG9yeSAgICAgICA6IHRydWUsICAgIC8vIHNob3VsZCB1c2UgaGlzdG9yeSBoYXNoaW5nIGlmIHBvc3NpYmxlIChIVE1MNSBBUEkpCiAgICAgICAgICAgIGhpZGVGbGFzaCAgICAgOiB0cnVlLCAgICAvLyBIaWRlcyBmbGFzaCBlbGVtZW50cyBvbiB0aGUgcGFnZSB3aGVuIHBob3RvYm94IGlzIGFjdGl2YXRlZC4gTk9URTogZmxhc2ggZWxlbWVudHMgbXVzdCBoYXZlIHdtb2RlIHBhcmFtZXRlciBzZXQgdG8gIm9wYXF1ZSIgb3IgInRyYW5zcGFyZW50IiBpZiB0aGlzIGlzIHNldCB0byBmYWxzZQogICAgICAgICAgICB6b29tYWJsZSAgICAgIDogdHJ1ZSwgICAgLy8gZGlzYWJsZS9lbmFibGUgbW91c2V3aGVlbCBpbWFnZSB6b29taW5nCiAgICAgICAgICAgIHdoZWVsTmV4dFByZXYgOiB0cnVlLCAgICAvLyBjaGFuZ2UgaW1hZ2UgdXNpbmcgbW91c2V3aGVlbCBsZWZ0L3JpZ2h0CiAgICAgICAgICAgIGtleXMgICAgICAgICAgOiB7CiAgICAgICAgICAgICAgICBjbG9zZSA6ICcyNywgODgsIDY3JywgICAgLy8ga2V5Y29kZXMgdG8gY2xvc2UgcGhvdG9ib3gsIGRlZmF1bHQ6IGVzYyAoMjcpLCAneCcgKDg4KSwgJ2MnICg2NykKICAgICAgICAgICAgICAgIHByZXYgIDogJzM3LCA4MCcsICAgICAgICAvLyBrZXljb2RlcyB0byBuYXZpZ2F0ZSB0byB0aGUgcHJldmlvdXMgaW1hZ2UsIGRlZmF1bHQ6IExlZnQgYXJyb3cgKDM3KSwgJ3AnICg4MCkKICAgICAgICAgICAgICAgIG5leHQgIDogJzM5LCA3OCcgICAgICAgICAvLyBrZXljb2RlcyB0byBuYXZpZ2F0ZSB0byB0aGUgbmV4dCBpbWFnZSwgZGVmYXVsdDogUmlnaHQgYXJyb3cgKDM5KSwgJ24nICg3OCkKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8vIERPTSBzdHJ1Y3R1cmUKICAgICAgICBvdmVybGF5ID0gICAkKCc8ZGl2IGlkPSJwYk92ZXJsYXkiPicpLmFwcGVuZCgKICAgICAgICAgICAgICAgICAgICAgICAgdGh1bWJzVG9nZ2xlciA9ICQoJzxpbnB1dCB0eXBlPSJjaGVja2JveCIgaWQ9InBiVGh1bWJzVG9nZ2xlciIgY2hlY2tlZCBoaWRkZW4+JyksCiAgICAgICAgICAgICAgICAgICAgICAgIHBiTG9hZGVyID0gJCgnPGRpdiBjbGFzcz0icGJMb2FkZXIiPjxiPjwvYj48Yj48L2I+PGI+PC9iPjwvZGl2PicpLAogICAgICAgICAgICAgICAgICAgICAgICBwcmV2QnRuID0gJCgnPGRpdiBpZD0icGJQcmV2QnRuIiBjbGFzcz0icHJldk5leHQiPjxiPjwvYj48L2Rpdj4nKS5vbignY2xpY2snLCBuZXh0X3ByZXYpLAogICAgICAgICAgICAgICAgICAgICAgICBuZXh0QnRuID0gJCgnPGRpdiBpZD0icGJOZXh0QnRuIiBjbGFzcz0icHJldk5leHQiPjxiPjwvYj48L2Rpdj4nKS5vbignY2xpY2snLCBuZXh0X3ByZXYpLAogICAgICAgICAgICAgICAgICAgICAgICB3cmFwcGVyID0gJCgnPGRpdiBjbGFzcz0icGJXcmFwcGVyIj4nKS5hcHBlbmQoICAvLyBnaXZlcyBQZXJzcGVjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2UgPSAkKCc8aW1nPicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlkZW8gPSAkKCc8ZGl2PicpCiAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlQnRuID0gJCgnPGRpdiBpZD0icGJDbG9zZUJ0biI+Jykub24oJ2NsaWNrJywgY2xvc2UpWzBdLAogICAgICAgICAgICAgICAgICAgICAgICBhdXRvcGxheUJ0biA9ICQoJzxkaXYgaWQ9InBiQXV0b3BsYXlCdG4iPicpLmFwcGVuZCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJzxkaXYgY2xhc3M9InBiUHJvZ3Jlc3MiPicpCiAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHRpb24gPSAkKCc8ZGl2IGlkPSJwYkNhcHRpb24iPicpLmFwcGVuZCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8bGFiZWwgZm9yPSJwYlRodW1ic1RvZ2dsZXIiIHRpdGxlPSJ0aHVtYm5haWxzIG9uL29mZiI+PC9sYWJlbD4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FwdGlvblRleHQgPSAkKCc8ZGl2IGNsYXNzPSJwYkNhcHRpb25UZXh0Ij4nKS5hcHBlbmQoJzxkaXYgY2xhc3M9InRpdGxlIj48L2Rpdj48ZGl2IGNsYXNzPSJjb3VudGVyIj4nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRodW1icyA9ICQoJzxkaXY+JykuYWRkQ2xhc3MoJ3BiVGh1bWJzJykKICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICAgIEluaXRpYWxpemF0aW9uIChvbiBET00gcmVhZHkpCiAgICAqLwogICAgZnVuY3Rpb24gcHJlcGFyZURPTSgpewogICAgICAgIG5vUG9pbnRlckV2ZW50cyAmJiBvdmVybGF5LmhpZGUoKTsKCiAgICAgICAgYXV0b3BsYXlCdG4ub2ZmKCkub24oJ2NsaWNrJywgQVBDb250cm9sLnRvZ2dsZSk7CiAgICAgICAgLy8gYXR0YWNoIGEgZGVsZWdhdGVkIGV2ZW50IG9uIHRoZSB0aHVtYnMgY29udGFpbmVyCiAgICAgICAgdGh1bWJzLm9mZigpLm9uKCdjbGljaycsICdhJywgdGh1bWJzU3RyaXBlLmNsaWNrKTsKICAgICAgICAvLyBpZiB1c2VyYWdlbnQgaXMgSUUgPCAxMCAodXNlciBkZXNlcnZlcyBhIHNsYXAgb24gdGhlIGZhY2UsIGJ1dCBJIGdvdHRhIHN1cHBvcnQgdGhlbSBzdGlsbC4uLikKICAgICAgICBpc09sZElFICYmIG92ZXJsYXkuYWRkQ2xhc3MoJ21zaWUnKTsKICAgICAgICBpc01vYmlsZSAmJiBvdmVybGF5LmFkZENsYXNzKCdtb2JpbGUnKTsKCiAgICAgICAgLy8gY2FuY2VsIHByb3JvZ2F0aW9uIHVwIHRvIHRoZSBvdmVybGF5IGNvbnRhaW5lciBzbyBpdCB3b24ndCBjbG9zZQogICAgICAgIG92ZXJsYXkub2ZmKCkub24oJ2NsaWNrJywgJ2ltZycsIGZ1bmN0aW9uKGUpewogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgIH0pOwoKICAgICAgICAkKGRvYy5ib2R5KS5hcHBlbmQob3ZlcmxheSk7CgogICAgICAgIC8vIG5lZWQgdGhpcyBmb3IgbGF0ZXI6CiAgICAgICAgZG9jRWxtID0gZG9jLmRvY3VtZW50RWxlbWVudDsKICAgIH0KCiAgICAvLyBAcGFyYW0gW0xpc3Qgb2YgZWxlbWVudHMgdG8gd29yayBvbiwgQ3VzdG9tIHNldHRpbmdzLCBDYWxsYmFjayBhZnRlciBpbWFnZSBpcyBsb2FkZWRdCiAgICAkLmZuLnBob3RvYm94ID0gZnVuY3Rpb24odGFyZ2V0LCBzZXR0aW5ncywgY2FsbGJhY2spewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKICAgICAgICAgICAgdmFyIG8sCiAgICAgICAgICAgICAgICBQQl9kYXRhID0gJCh0aGlzKS5kYXRhKCdfcGhvdG9ib3gnKTsKCiAgICAgICAgICAgIGlmKCBQQl9kYXRhICl7IC8vIGRvbid0IGluaXRpYXRlIHRoZSBwbHVnaW4gbW9yZSB0aGFuIG9uY2Ugb24gdGhlIHNhbWUgZWxlbWVudAogICAgICAgICAgICAgICAgaWYoIHRhcmdldCA9PT0gJ2Rlc3Ryb3knKQogICAgICAgICAgICAgICAgICAgIFBCX2RhdGEuZGVzdHJveSgpOwoKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiggdHlwZW9mIHRhcmdldCAhPSAnc3RyaW5nJyApCiAgICAgICAgICAgICAgICB0YXJnZXQgPSAnYSc7CgogICAgICAgICAgICBpZiggdGFyZ2V0ID09PSAncHJlcGFyZURPTScgKXsKICAgICAgICAgICAgICAgIHByZXBhcmVET00oKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBvID0gJC5leHRlbmQoe30sIGRlZmF1bHRzLCBzZXR0aW5ncyB8fCB7fSk7CiAgICAgICAgICAgIHBob3RvYm94ID0gbmV3IFBob3RvYm94KG8sIHRoaXMsIHRhcmdldCk7CgogICAgICAgICAgICAvLyBTYXZlcyB0aGUgaW5zYW5jZSBvbiB0aGUgZ2FsbGVyeSdzIHRhcmdldCBlbGVtZW50CiAgICAgICAgICAgICQodGhpcykuZGF0YSgnX3Bob3RvYm94JywgcGhvdG9ib3gpOwogICAgICAgICAgICAvLyBhZGQgYSBjYWxsYmFjayB0byB0aGUgc3BlY2lmaWMgZ2FsbGVyeQogICAgICAgICAgICBwaG90b2JveC5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgIH0pOwogICAgfQoKICAgIFBob3RvYm94ID0gZnVuY3Rpb24oX29wdGlvbnMsIG9iamVjdCwgdGFyZ2V0KXsKICAgICAgICB0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgX29wdGlvbnMpOwogICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgICAgIHRoaXMuc2VsZWN0b3IgPSAkKG9iamVjdCB8fCBkb2MpOwoKICAgICAgICB0aGlzLnRodW1ic0xpc3QgPSBudWxsOwogICAgICAgIC8vIGZpbHRlciB0aGUgbGlua3Mgd2hpY2ggYWN0dWFsbHkgSEFTIGFuIGltYWdlIGFzIGEgY2hpbGQKICAgICAgICB2YXIgZmlsdGVyZWQgPSB0aGlzLmltYWdlTGlua3NGaWx0ZXIoIHRoaXMuc2VsZWN0b3IuZmluZCh0YXJnZXQpICk7CgogICAgICAgIHRoaXMuaW1hZ2VMaW5rcyA9IGZpbHRlcmVkWzBdOyAgLy8gQXJyYXkgb2YgalF1ZXJ5IGxpbmtzCiAgICAgICAgdGhpcy5pbWFnZXMgPSBmaWx0ZXJlZFsxXTsgICAgICAvLyAyRCBBcnJheSBvZiBpbWFnZSBVUkwgJiB0aXRsZQogICAgICAgIHRoaXMuaW5pdCgpOwogICAgfTsKCiAgICBQaG90b2JveC5wcm90b3R5cGUgPSB7CiAgICAgICAgaW5pdCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKCiAgICAgICAgICAgIC8vIG9ubHkgZ2VuZXJhdGVzIHRoZSB0aHVtYlN0cmlwZSBvbmNlLCBhbmQgbGlzdGVuIGZvciBhbnkgRE9NIGNoYW5nZXMgb24gdGhlIHNlbGVjdG9yIGVsZW1lbnQsIGlmIHNvLCByZS1nZW5lcmF0ZQogICAgICAgICAgICAvLyBUaGlzIGlzIGRvbmUgb24gIm1vdXNlZW50ZXIiIHNvIGltYWdlcyB3aWxsIG5vdCBnZXQgY2FsbGVkIHVubGVzcyBpdCdzIGxpZWtseSB0aGF0IHRoZXkgd291bGQgYmUgbmVlZGVkCiAgICAgICAgICAgIHRoaXMuc2VsZWN0b3Iub25lKCdtb3VzZWVudGVyLnBob3RvYm94JywgdGhpcy50YXJnZXQsIGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgdGhhdC50aHVtYnNMaXN0ID0gdGh1bWJzU3RyaXBlLmdlbmVyYXRlLmFwcGx5KHRoYXQpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHRoaXMuc2VsZWN0b3Iub24oJ2NsaWNrLnBob3RvYm94JywgdGhpcy50YXJnZXQsIGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgdGhhdC5vcGVuKHRoaXMpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIGlmIGFueSBub2RlIHdhcyBhZGRlZCBvciByZW1vdmVkIGZyb20gdGhlIFNlbGVjdG9yIG9mIHRoZSBnYWxsZXJ5CiAgICAgICAgICAgIHRoaXMub2JzZXJ2ZXJUaW1lb3V0ID0gbnVsbDsKCiAgICAgICAgICAgIGlmKCB0aGlzLnNlbGVjdG9yWzBdLm5vZGVUeXBlID09IDEgKSAvLyBvYnNlcnZlIG5vcm1hbCBub2RlcwogICAgICAgICAgICAgICAgdGhhdC5vYnNlcnZlRE9NKCB0aGF0LnNlbGVjdG9yWzBdLCBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIC8vIHVzZSBhIHRpbWVvdXQgdG8gcHJldmVudCBtb3JlIHRoYW4gb25lIERPTSBjaGFuZ2UgZXZlbnQgZmlyaW5nIGF0IG9uY2UsIGFuZCBhbHNvIHRvIG92ZXJjb21lIHRoZSBmYWN0IHRoYXQgSUUncyBET01Ob2RlUmVtb3ZlZCBpcyBmaXJlZCBCRUZPUkUgZWxlbWVudHMgd2VyZSBhY3R1YWxseSByZW1vdmVkCiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoYXQub2JzZXJ2ZXJUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB0aGF0Lm9ic2VydmVyVGltZW91dCA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmaWx0ZXJlZCA9IHRoYXQuaW1hZ2VMaW5rc0ZpbHRlciggdGhhdC5zZWxlY3Rvci5maW5kKHRoYXQudGFyZ2V0KSApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlSW5kZXggPSAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNBY3RpdmVVcmwgPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCBPTkxZIERPTSBjaGFuZ2VzIGluIHRoZSBwaG90b2JveCBudW1iZXIgb2YgaXRlbXMgd2lsbCB0cmlnZ2VyIGEgY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHRoYXQuaW1hZ2VMaW5rcy5sZW5ndGggPT0gZmlsdGVyZWRbMF0ubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5pbWFnZUxpbmtzID0gZmlsdGVyZWRbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuaW1hZ2VzID0gZmlsdGVyZWRbMV07CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBwaG90b2JveCBpcyBvcGVuZWQKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIHBob3RvYm94ICl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBnYWxsZXJ5IHdoaWNoIHdhcyBjaGFuZ2VkIGlzIHRoZSBjdXJyZW50bHkgdmlld2VkIG9uZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCB0aGF0LnNlbGVjdG9yID09IHBob3RvYm94LnNlbGVjdG9yICl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VzID0gdGhhdC5pbWFnZXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VMaW5rcyA9IHRoYXQuaW1hZ2VMaW5rczsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiB0aGUgY3VycmVudGx5IFZJRVdFRCBwaG90byBoYXMgYmVlbiBkZS10YWNoZWQgZnJvbSBhIHBob3RvYm94IHNldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHNvLCByZW1vdmUgbmF2aWdhdGlvbiBhcnJvd3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBmaXggdGhlICJpbWFnZXMiIHRvIGJlIGFuIG9iamVjdCBhbmQgbm90IGFuIGFycmF5LgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciggaSA9IGltYWdlcy5sZW5ndGg7IGktLTsgKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIGltYWdlc1tpXVswXSA9PSBhY3RpdmVVUkwgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNBY3RpdmVVcmwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBub3QgZXhpdHMgYW55IG1vcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIGlzQWN0aXZlVXJsICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmxheS5yZW1vdmVDbGFzcygnaGFzQXJyb3dzJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoaXMgZ2FsbGVyeSBoYXMgdGh1bWJzCiAgICAgICAgICAgICAgICAgICAgICAgIC8vaWYoIHRoYXQub3B0aW9ucy50aHVtYnMgKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQudGh1bWJzTGlzdCA9IHRodW1ic1N0cmlwZS5nZW5lcmF0ZS5hcHBseSh0aGF0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRodW1icy5odG1sKCB0aGF0LnRodW1ic0xpc3QgKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy99CgogICAgICAgICAgICAgICAgICAgICAgICBpZiggdGhhdC5pbWFnZXMubGVuZ3RoICYmIGFjdGl2ZVVSTCAmJiB0aGF0Lm9wdGlvbnMudGh1bWJzICl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVJbmRleCA9IHRoYXQudGh1bWJzTGlzdC5maW5kKCdhW2hyZWY9IicrYWN0aXZlVVJMKyciXScpLmVxKDApLnBhcmVudCgpLmluZGV4KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoIGFjdGl2ZUluZGV4ID09IC0xICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVJbmRleCA9IDA7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlSW5kZXhlcyhhY3RpdmVJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHVtYnNTdHJpcGUuY2hhbmdlQWN0aXZlKGFjdGl2ZUluZGV4LCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIDUwKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIG9wZW4gOiBmdW5jdGlvbihsaW5rKXsKICAgICAgICAgICAgdmFyIHN0YXJ0SW1hZ2UgPSAkLmluQXJyYXkobGluaywgdGhpcy5pbWFnZUxpbmtzKTsKICAgICAgICAgICAgLy8gaWYgaW1hZ2UgbGluayBkb2VzIG5vdCBleGlzdCBpbiB0aGUgaW1hZ2VMaW5rcyBhcnJheSAocHJvYmFibHkgbWVhbnMgaXQncyBub3QgYSB2YWxpZCBwYXJ0IG9mIHRoZSBnYWxsZXJ5KQogICAgICAgICAgICBpZiggc3RhcnRJbWFnZSA9PSAtMSApCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICAvLyBsb2FkIHRoZSByaWdodCBnYWxsZXJ5IHNlbGVjdG9yLi4uCiAgICAgICAgICAgIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgICAgICAgIGltYWdlcyA9IHRoaXMuaW1hZ2VzOwogICAgICAgICAgICBpbWFnZUxpbmtzID0gdGhpcy5pbWFnZUxpbmtzOwoKICAgICAgICAgICAgcGhvdG9ib3ggPSB0aGlzOwogICAgICAgICAgICB0aGlzLnNldHVwKDEpOwoKICAgICAgICAgICAgb3ZlcmxheS5vbih0cmFuc2l0aW9uZW5kLCBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgb3ZlcmxheS5vZmYodHJhbnNpdGlvbmVuZCkuYWRkQ2xhc3MoJ29uJyk7IC8vIGNsYXNzICdvbicgaXMgc2V0IHdoZW4gdGhlIGluaXRpYWwgZmFkZS1pbiBvZiB0aGUgb3ZlcmxheSBpcyBkb25lCiAgICAgICAgICAgICAgICBjaGFuZ2VJbWFnZShzdGFydEltYWdlLCB0cnVlKTsKICAgICAgICAgICAgfSkuYWRkQ2xhc3MoJ3Nob3cnKTsKCiAgICAgICAgICAgIGlmKCBpc09sZElFICkKICAgICAgICAgICAgICAgIG92ZXJsYXkudHJpZ2dlcignTVNUcmFuc2l0aW9uRW5kJyk7CgogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKCiAgICAgICAgaW1hZ2VMaW5rc0ZpbHRlciA6IGZ1bmN0aW9uKG9iail7CiAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpcywKICAgICAgICAgICAgICAgIGltYWdlcyA9IFtdLAogICAgICAgICAgICAgICAgY2FwdGlvbiA9IHt9LAogICAgICAgICAgICAgICAgY2FwdGlvbmxpbms7CgogICAgICAgICAgICByZXR1cm4gW29iai5maWx0ZXIoZnVuY3Rpb24oaSl7CiAgICAgICAgICAgICAgICAvLyBzZWFyY2ggZm9yIHRoZSB0aHVtYiBpbnNpZGUgdGhlIGxpbmssIGlmIG5vdCBmb3VuZCB0aGVuIHNlZSBpZiB0aGVyZSdzIGEgJ3RoYXQuc2V0dGluZ3MudGh1bWInIHBvaW50ZXIgdG8gdGhlIHRodW1ibmFpbAogICAgICAgICAgICAgICAgdmFyIGxpbmsgPSAkKHRoaXMpLAogICAgICAgICAgICAgICAgICAgIHRodW1iSW1nLAogICAgICAgICAgICAgICAgICAgIHRodW1iU3JjID0gJyc7CgogICAgICAgICAgICAgICAgY2FwdGlvbi5jb250ZW50ID0gbGlua1swXS5nZXRBdHRyaWJ1dGUoJ3RpdGxlJykgfHwgJyc7CgogICAgICAgICAgICAgICAgaWYoIHRoYXQub3B0aW9ucy50aHVtYiApCiAgICAgICAgICAgICAgICAgICAgdGh1bWJJbWcgPSBsaW5rLmZpbmQodGhhdC5vcHRpb25zLnRodW1iKVswXTsKCiAgICAgICAgICAgICAgICAvLyB0cnkgYSBkaXJlY3QgY2hpbGQgbG9va3VwCiAgICAgICAgICAgICAgICBpZiggIXRoYXQub3B0aW9ucy50aHVtYiB8fCAhdGh1bWJJbWcgKQogICAgICAgICAgICAgICAgICAgIHRodW1iSW1nID0gbGluay5maW5kKCdpbWcnKVswXTsKCiAgICAgICAgICAgICAgICAvLyBpZiBubyBpbWcgY2hpbGQgZm91bmQgaW4gdGhlIGxpbmsKICAgICAgICAgICAgICAgIGlmKCB0aHVtYkltZyApewogICAgICAgICAgICAgICAgICAgIGNhcHRpb25saW5rID0gdGh1bWJJbWcuZ2V0QXR0cmlidXRlKCdkYXRhLXBiLWNhcHRpb25saW5rJyk7CiAgICAgICAgICAgICAgICAgICAgdGh1bWJTcmMgPSB0aHVtYkltZy5nZXRBdHRyaWJ1dGUoJ3NyYycpOwoKICAgICAgICAgICAgICAgICAgICBjYXB0aW9uLmNvbnRlbnQgPSAoIHRodW1iSW1nLmdldEF0dHJpYnV0ZSgnYWx0JykgfHwgdGh1bWJJbWcuZ2V0QXR0cmlidXRlKCd0aXRsZScpIHx8ICcnKTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgLy8gaWYgdGhlcmUgaXMgYSBjYXB0aW9uIGxpbmsgdG8gYmUgYWRkZWQ6CiAgICAgICAgICAgICAgICBpZiggY2FwdGlvbmxpbmsgKXsKICAgICAgICAgICAgICAgICAgICBjYXB0aW9ubGluayA9IGNhcHRpb25saW5rLnNwbGl0KCdbJyk7CiAgICAgICAgICAgICAgICAgICAgLy8gcGFyc2UgY29tcGxleCBsaW5rczogdGV4dFt3d3cuc2l0ZS5jb21dCiAgICAgICAgICAgICAgICAgICAgaWYoIGNhcHRpb25saW5rLmxlbmd0aCA9PSAyICl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHRpb24ubGlua1RleHQgPSBjYXB0aW9ubGlua1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdGlvbi5saW5rSHJlZiA9IGNhcHRpb25saW5rWzFdLnNsaWNlKDAsLTEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgICAgICAgICBjYXB0aW9uLmxpbmtUZXh0ID0gY2FwdGlvbmxpbms7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHRpb24ubGlua0hyZWYgPSBjYXB0aW9ubGluazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2FwdGlvbi5jb250ZW50ICs9ICcgPGEgaHJlZj0iJysgY2FwdGlvbi5saW5rSHJlZiArJyI+JyArIGNhcHRpb24ubGlua1RleHQgKyAnPC9hPic7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaW1hZ2VzLnB1c2goIFtsaW5rWzBdLmhyZWYsIGNhcHRpb24uY29udGVudCwgdGh1bWJTcmNdICk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0pLCBpbWFnZXNdOwogICAgICAgIH0sCgogICAgICAgIC8vY2hlY2sgaWYgRE9NIG5vZGVzIHdlcmUgYWRkZWQgb3IgcmVtb3ZlZCwgdG8gcmUtYnVpbGQgdGhlIGltYWdlTGlua3MgYW5kIHRodW1ibmFpbHMKICAgICAgICBvYnNlcnZlRE9NIDogKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciBNdXRhdGlvbk9ic2VydmVyID0gd2luLk11dGF0aW9uT2JzZXJ2ZXIgfHwgd2luLldlYktpdE11dGF0aW9uT2JzZXJ2ZXIsCiAgICAgICAgICAgICAgICBldmVudExpc3RlbmVyU3VwcG9ydGVkID0gd2luLmFkZEV2ZW50TGlzdGVuZXI7CgogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqLCBjYWxsYmFjayl7CiAgICAgICAgICAgICAgICBpZiggTXV0YXRpb25PYnNlcnZlciApewogICAgICAgICAgICAgICAgICAgIC8vIGRlZmluZSBhIG5ldyBvYnNlcnZlcgogICAgICAgICAgICAgICAgICAgIHZhciBvYnMgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihmdW5jdGlvbihtdXRhdGlvbnMsIG9ic2VydmVyKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIG11dGF0aW9uc1swXS5hZGRlZE5vZGVzLmxlbmd0aCB8fCBtdXRhdGlvbnNbMF0ucmVtb3ZlZE5vZGVzLmxlbmd0aCApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIC8vIGhhdmUgdGhlIG9ic2VydmVyIG9ic2VydmUgZm9vIGZvciBjaGFuZ2VzIGluIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgICAgb2JzLm9ic2VydmUoIG9iaiwgeyBjaGlsZExpc3Q6dHJ1ZSwgc3VidHJlZTp0cnVlIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiggZXZlbnRMaXN0ZW5lclN1cHBvcnRlZCApewogICAgICAgICAgICAgICAgICAgIG9iai5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlSW5zZXJ0ZWQnLCBjYWxsYmFjaywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIG9iai5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlUmVtb3ZlZCcsIGNhbGxiYWNrLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KSgpLAoKICAgICAgICAvLyB0aGluZ3MgdGhhdCBzaG91bGQgaGFwcGVuIGV2ZXJ5IHRpbWUgdGhlIGdhbGxlcnkgb3BlbnMgb3IgY2xvc2VzIChzb21lIG1lc3NlZCB1cCBjb2RlIGJlbG93Li4pCiAgICAgICAgc2V0dXAgOiBmdW5jdGlvbiAob3Blbil7CiAgICAgICAgICAgIHZhciBmbiA9IG9wZW4gPyAib24iIDogIm9mZiI7CgogICAgICAgICAgICAvLyBhIGhhY2sgdG8gY2hhbmdlIHRoZSBpbWFnZSBzcmMgdG8gbm90aGluZywgYmVjYXVzZSB5b3UgY2FuJ3QgZG8gdGhhdCBpbiBDSFJPTUUKICAgICAgICAgICAgaW1hZ2VbMF0uc3JjID0gYmxhbmtJbWc7CgogICAgICAgICAgICAvLyB0aHVtYnMgc3R1ZmYKICAgICAgICAgICAgaWYoIG9wdGlvbnMudGh1bWJzICl7CiAgICAgICAgICAgICAgICBpZiggIWlzTW9iaWxlICl7CiAgICAgICAgICAgICAgICAgICAgdGh1bWJzW2ZuXSgnbW91c2VlbnRlci5waG90b2JveCcsIHRodW1ic1N0cmlwZS5jYWxjKQogICAgICAgICAgICAgICAgICAgICAgICAgIFtmbl0oJ21vdXNlbW92ZS5waG90b2JveCcsIHRodW1ic1N0cmlwZS5tb3ZlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoIG9wZW4gKXsKICAgICAgICAgICAgICAgIGltYWdlLmNzcyh7J3RyYW5zaXRpb24nOicwcyd9KS5yZW1vdmVBdHRyKCdzdHlsZScpOyAvLyByZXNldCBhbnkgdHJhbnNpdGlvbiB0aGF0IG1pZ2h0IGJlIG9uIHRoZSBlbGVtZW50ICh5ZXMgaXQncyB1Z2x5KQogICAgICAgICAgICAgICAgb3ZlcmxheS5zaG93KCk7CiAgICAgICAgICAgICAgICAvLyBDbGVhbiB1cCBpZiBhbm90aGVyIGdhbGxlcnkgd2FzIHZpZXdlZCBiZWZvcmUsIHdoaWNoIGhhZCBhIHRodW1ic0xpc3QKICAgICAgICAgICAgICAgIHRodW1icwogICAgICAgICAgICAgICAgICAgIC5odG1sKCB0aGlzLnRodW1ic0xpc3QgKQogICAgICAgICAgICAgICAgICAgIC50cmlnZ2VyKCdtb3VzZWVudGVyLnBob3RvYm94Jyk7CgogICAgICAgICAgICAgICAgaWYoIG9wdGlvbnMudGh1bWJzICl7CiAgICAgICAgICAgICAgICAgICAgb3ZlcmxheS5hZGRDbGFzcygndGh1bWJzJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgICAgIHRodW1ic1RvZ2dsZXIucHJvcCgnY2hlY2tlZCcsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICBvdmVybGF5LnJlbW92ZUNsYXNzKCd0aHVtYnMnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB0aGluZ3MgdG8gaGlkZSBpZiB0aGVyZSBhcmUgbGVzcyB0aGFuIDIgaW1hZ2VzCiAgICAgICAgICAgICAgICBpZiggdGhpcy5pbWFnZXMubGVuZ3RoIDwgMiB8fCAgb3B0aW9ucy5zaW5nbGUgKQogICAgICAgICAgICAgICAgICAgIG92ZXJsYXkucmVtb3ZlQ2xhc3MoJ3RodW1icyBoYXNBcnJvd3MgaGFzQ291bnRlciBoYXNBdXRvcGxheScpOwogICAgICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICAgICBvdmVybGF5LmFkZENsYXNzKCdoYXNBcnJvd3MgaGFzQ291bnRlcicpCgogICAgICAgICAgICAgICAgICAgIC8vIGNoZWNrIGlzIHRoZSBhdXRvcGxheSBidXR0b24gc2hvdWxkIGJlIHZpc2libGUgKHBlciBnYWxsZXJ5KSBhbmQgaWYgc28sIHNob3VsZCBpdCBhdXRvcGxheSBvciBub3QuCiAgICAgICAgICAgICAgICAgICAgaWYoIG9wdGlvbnMudGltZSA+IDEwMDAgKXsKICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmxheS5hZGRDbGFzcygnaGFzQXV0b3BsYXknKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIG9wdGlvbnMuYXV0b3BsYXkgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgQVBDb250cm9sLnByb2dyZXNzLnN0YXJ0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFQQ29udHJvbC5wYXVzZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJsYXkucmVtb3ZlQ2xhc3MoJ2hhc0F1dG9wbGF5Jyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgb3B0aW9ucy5oaWRlRmxhc2ggJiYgJCgnaWZyYW1lLCBvYmplY3QsIGVtYmVkJykuY3NzKCd2aXNpYmlsaXR5JywgJ2hpZGRlbicpOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICQod2luKS5vZmYoJ3Jlc2l6ZS5waG90b2JveCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkKGRvYykub2ZmKCJrZXlkb3duLnBob3RvYm94IilbZm5dKHsgImtleWRvd24ucGhvdG9ib3giOiBrZXlEb3duIH0pOwoKICAgICAgICAgICAgaWYoIGlzTW9iaWxlICl7CiAgICAgICAgICAgICAgICBvdmVybGF5LnJlbW92ZUNsYXNzKCdoYXNBcnJvd3MnKTsgLy8gbm8gbmVlZCBmb3IgQXJyb3dzIG9uIHRvdWNoLWVuYWJsZWQKICAgICAgICAgICAgICAgIHdyYXBwZXJbZm5dKCdzd2lwZScsIG9uU3dpcGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiggb3B0aW9ucy56b29tYWJsZSApewogICAgICAgICAgICAgICAgb3ZlcmxheVtmbl0oeyJtb3VzZXdoZWVsLnBob3RvYm94Ijogc2Nyb2xsWm9vbSB9KTsKICAgICAgICAgICAgICAgIGlmKCAhaXNPbGRJRSkgdGh1bWJzW2ZuXSh7Im1vdXNld2hlZWwucGhvdG9ib3giOiB0aHVtYnNSZXNpemUgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKCAhb3B0aW9ucy5zaW5nbGUgJiYgb3B0aW9ucy53aGVlbE5leHRQcmV2ICl7CiAgICAgICAgICAgICAgICBvdmVybGF5W2ZuXSh7Im1vdXNld2hlZWwucGhvdG9ib3giOiB3aGVlbE5leHRQcmV2IH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZGVzdHJveSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgICAgICAgIHRoaXMuc2VsZWN0b3IKICAgICAgICAgICAgICAgIC5vZmYoJ2NsaWNrLnBob3RvYm94JywgdGhpcy50YXJnZXQpCiAgICAgICAgICAgICAgICAucmVtb3ZlRGF0YSgnX3Bob3RvYm94Jyk7CgogICAgICAgICAgICBjbG9zZSgpOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBvbiB0b3VjaC1kZXZpY2VzIG9ubHkKICAgIGZ1bmN0aW9uIG9uU3dpcGUoZSwgRHgsIER5KXsKICAgICAgICBpZiggRHggPT0gMSApewogICAgICAgICAgICBpbWFnZS5jc3Moe3RyYW5zZm9ybTondHJhbnNsYXRlWCgyNSUpJywgdHJhbnNpdGlvbjonLjJzJywgb3BhY2l0eTowfSk7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsgY2hhbmdlSW1hZ2UocHJldkltYWdlKSB9LCAyMDApOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmKCBEeCA9PSAtMSApewogICAgICAgICAgICBpbWFnZS5jc3Moe3RyYW5zZm9ybTondHJhbnNsYXRlWCgtMjUlKScsIHRyYW5zaXRpb246Jy4ycycsIG9wYWNpdHk6MH0pOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7IGNoYW5nZUltYWdlKG5leHRJbWFnZSkgfSwgMjAwKTsKICAgICAgICB9CgogICAgICAgIGlmKCBEeSA9PSAxICkKICAgICAgICAgICAgdGh1bWJzVG9nZ2xlci5wcm9wKCdjaGVja2VkJywgdHJ1ZSk7CiAgICAgICAgZWxzZSBpZiggRHkgPT0gLTEgKQogICAgICAgICAgICB0aHVtYnNUb2dnbGVyLnByb3AoJ2NoZWNrZWQnLCBmYWxzZSk7CiAgICB9CgogICAgLy8gbWFuYWdlIHRoZSAoYm90dG9tKSB0aHVtYnMgc3RyaXAKICAgIHRodW1ic1N0cmlwZSA9IChmdW5jdGlvbigpewogICAgICAgIHZhciBjb250YWluZXJXaWR0aCAgID0gMCwKICAgICAgICAgICAgc2Nyb2xsV2lkdGggICAgICA9IDAsCiAgICAgICAgICAgIHBvc0Zyb21MZWZ0ICAgICAgPSAwLCAgICAvLyBTdHJpcGUgcG9zaXRpb24gZnJvbSB0aGUgbGVmdCBvZiB0aGUgc2NyZWVuCiAgICAgICAgICAgIHN0cmlwZVBvcyAgICAgICAgPSAwLCAgICAvLyBXaGVuIHJlbGF0aXZlIG1vdXNlIHBvc2l0aW9uIGluc2lkZSB0aGUgdGh1bWJzIHN0cmlwZQogICAgICAgICAgICBhbmltYXRlZCAgICAgICAgID0gbnVsbCwKICAgICAgICAgICAgcGFkZGluZywgICAgICAgICAgICAgICAgIC8vIGluIHBlcmNlbnRhZ2UgdG8gdGhlIGNvbnRhaW5lcldpZHRoCiAgICAgICAgICAgIGVsLCAkZWwsIHJhdGlvLCBzY3JvbGxQb3MsIHBvczsKCiAgICAgICAgcmV0dXJuewogICAgICAgICAgICAvLyByZXR1cm5zIGEgPHVsPiBlbGVtZW50IHdoaWNoIGlzIHBvcHVsYXRlZCB3aXRoIGFsbCB0aGUgZ2FsbGVyeSBsaW5rcyBhbmQgdGh1bWJzCiAgICAgICAgICAgIGdlbmVyYXRlIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIHZhciB0aHVtYnNMaXN0ID0gJCgnPHVsPicpLAogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRzICAgPSBbXSwKICAgICAgICAgICAgICAgICAgICBsZW4gICAgICAgID0gdGhpcy5pbWFnZUxpbmtzLnNpemUoKSwKICAgICAgICAgICAgICAgICAgICB0aXRsZSwgdGh1bWJTcmMsIGxpbmssIHR5cGUsIGk7CgogICAgICAgICAgICAgICAgZm9yKCBpID0gMDsgaSA8IGxlbjsgaSsrICl7CiAgICAgICAgICAgICAgICAgICAgbGluayA9IHRoaXMuaW1hZ2VMaW5rc1tpXTsKCiAgICAgICAgICAgICAgICAgICAgdGh1bWJTcmMgPSB0aGlzLmltYWdlc1tpXVsyXTsKICAgICAgICAgICAgICAgICAgICAvLyBjb250aW51ZSBpZiBoYXMgdGh1bWIKICAgICAgICAgICAgICAgICAgICBpZiggIXRodW1iU3JjICkKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgICAgICAgICAgIHRpdGxlID0gdGhpcy5pbWFnZXNbaV1bMV07CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9IGxpbmsucmVsID8gIiBjbGFzcz0nIiArIGxpbmsucmVsICsiJyIgOiAnJzsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50cy5wdXNoKCc8bGknKyB0eXBlICsnPjxhIGhyZWY9IicrIGxpbmsuaHJlZiArJyI+PGltZyBzcmM9IicrIHRodW1iU3JjICsnIiBhbHQ9IiIgdGl0bGU9IicrIHRpdGxlICsnIiAvPjwvYT48L2xpPicpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHRodW1ic0xpc3QuaHRtbCggZWxlbWVudHMuam9pbignJykgKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aHVtYnNMaXN0OwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY2xpY2sgOiBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICAgICAgICBhY3RpdmVUaHVtYi5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICBhY3RpdmVUaHVtYiA9ICQodGhpcykucGFyZW50KCkuYWRkQ2xhc3MoJ2FjdGl2ZScpOwoKICAgICAgICAgICAgICAgIHZhciBpbWFnZUluZGV4ID0gJCh0aGlzLnBhcmVudE5vZGUpLmluZGV4KCk7CiAgICAgICAgICAgICAgICByZXR1cm4gY2hhbmdlSW1hZ2UoaW1hZ2VJbmRleCwgMCwgMSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBjaGFuZ2VBY3RpdmVUaW1lb3V0IDogbnVsbCwKICAgICAgICAgICAgLyoqIEhpZ2hsaWdodHMgdGhlIHRodW1iIHdoaWNoIHJlcHJlc2VudHMgdGhlIHBob3RvIGFuZCBjZW50cmVzIHRoZSB0aHVtYnMgdmlld2VyIG9uIGl0LgogICAgICAgICAgICAqKiAgQHRodW1iQ2xpY2sgLSBpZiBhIHVzZXIgY2xpY2tlZCBvbiBhIHRodW1ibmFpbCwgZG9uJ3QgY2VudGVyIG9uIGl0CiAgICAgICAgICAgICovCiAgICAgICAgICAgIGNoYW5nZUFjdGl2ZSA6IGZ1bmN0aW9uKGluZGV4LCBkZWxheSwgdGh1bWJDbGljayl7CiAgICAgICAgICAgICAgICB2YXIgbGFzdEluZGV4ID0gYWN0aXZlVGh1bWIuaW5kZXgoKTsKICAgICAgICAgICAgICAgIGFjdGl2ZVRodW1iLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIGFjdGl2ZVRodW1iID0gdGh1bWJzLmZpbmQoJ2xpJykuZXEoaW5kZXgpLmFkZENsYXNzKCdhY3RpdmUnKTsKCiAgICAgICAgICAgICAgICBpZiggdGh1bWJDbGljayB8fCAhYWN0aXZlVGh1bWJbMF0gKSByZXR1cm47CiAgICAgICAgICAgICAgICAvLyBzZXQgdGhlIHNjcm9sbExlZnQgcG9zaXRpb24gb2YgdGhlIHRodW1icyBsaXN0IHRvIHNob3cgdGhlIGFjdGl2ZSB0aHVtYgogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuY2hhbmdlQWN0aXZlVGltZW91dCk7CiAgICAgICAgICAgICAgICAvLyBnaXZlIHRoZSBpbWFnZXMgdGltZSB0byB0byBzZXR0bGUgb24gdGhlaXIgbmV3IHNpemVzIChiZWNhdXNlIG9mIGNzcyB0cmFuc2l0aW9uKSBhbmQgdGhlbiBjYWxjdWxhdGUgdGhlIGNlbnRlci4uLgogICAgICAgICAgICAgICAgdGhpcy5jaGFuZ2VBY3RpdmVUaW1lb3V0ID0gc2V0VGltZW91dCgKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcG9zID0gYWN0aXZlVGh1bWJbMF0ub2Zmc2V0TGVmdCArIGFjdGl2ZVRodW1iWzBdLmNsaWVudFdpZHRoLzIgLSBkb2NFbG0uY2xpZW50V2lkdGgvMjsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsYXkgPyB0aHVtYnMuZGVsYXkoODAwKSA6IHRodW1icy5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRodW1icy5hbmltYXRlKHtzY3JvbGxMZWZ0OiBwb3N9LCA1MDAsICdzd2luZycpOwogICAgICAgICAgICAgICAgICAgIH0sIDIwMCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBjYWxjdWxhdGUgdGhlIHRodW1icyBjb250YWluZXIgd2lkdGgsIGlmIHRoZSB3aW5kb3cgaGFzIGJlZW4gcmVzaXplZAogICAgICAgICAgICBjYWxjIDogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBlbCA9IHRodW1ic1swXTsKCiAgICAgICAgICAgICAgICBjb250YWluZXJXaWR0aCAgICAgICA9IGVsLmNsaWVudFdpZHRoOwogICAgICAgICAgICAgICAgc2Nyb2xsV2lkdGggICAgICAgICAgPSBlbC5zY3JvbGxXaWR0aDsKICAgICAgICAgICAgICAgIHBhZGRpbmcgICAgICAgICAgICAgID0gMC4xNSAqIGNvbnRhaW5lcldpZHRoOwoKICAgICAgICAgICAgICAgIHBvc0Zyb21MZWZ0ICAgICAgICAgID0gdGh1bWJzLm9mZnNldCgpLmxlZnQ7CiAgICAgICAgICAgICAgICBzdHJpcGVQb3MgICAgICAgICAgICA9IGUucGFnZVggLSBwYWRkaW5nIC0gcG9zRnJvbUxlZnQ7CiAgICAgICAgICAgICAgICBwb3MgICAgICAgICAgICAgICAgICA9IHN0cmlwZVBvcyAvIChjb250YWluZXJXaWR0aCAtIHBhZGRpbmcqMik7CiAgICAgICAgICAgICAgICBzY3JvbGxQb3MgICAgICAgICAgICA9IChzY3JvbGxXaWR0aCAtIGNvbnRhaW5lcldpZHRoICkgKiBwb3M7CgogICAgICAgICAgICAgICAgdGh1bWJzLmFuaW1hdGUoe3Njcm9sbExlZnQ6c2Nyb2xsUG9zfSwgMjAwKTsKCiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoYW5pbWF0ZWQpOwogICAgICAgICAgICAgICAgYW5pbWF0ZWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgYW5pbWF0ZWQgPSBudWxsOwogICAgICAgICAgICAgICAgfSwgMjAwKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIG1vdmUgdGhlIHN0cmlwZSBsZWZ0IG9yIHJpZ2h0IGFjY29yZGluZyB0byBtb3VzZSBwb3NpdGlvbgogICAgICAgICAgICBtb3ZlIDogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICAvLyBkb24ndCBtb3ZlIGFueXRoaW5nIHVudGlsIGluaXRpYWwgbW92ZW1lbnQgb24gJ21vdXNlZW50ZXInIGhhcyBmaW5pc2hlZAogICAgICAgICAgICAgICAgaWYoIGFuaW1hdGVkICkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIHZhciByYXRpbyAgICAgPSBzY3JvbGxXaWR0aCAvIGNvbnRhaW5lcldpZHRoLAogICAgICAgICAgICAgICAgICAgIHN0cmlwZVBvcyA9IGUucGFnZVggLSBwYWRkaW5nIC0gcG9zRnJvbUxlZnQsIC8vIHRoZSBtb3VzZSBYIHBvc2l0aW9uLCAibm9ybWFsaXplZCIgdG8gdGhlIGNhcm91c2VsIHBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgcG9zLCBzY3JvbGxQb3M7CgogICAgICAgICAgICAgICAgaWYoIHN0cmlwZVBvcyA8IDApIHN0cmlwZVBvcyA9IDA7IC8vCgogICAgICAgICAgICAgICAgcG9zID0gc3RyaXBlUG9zIC8gKGNvbnRhaW5lcldpZHRoIC0gcGFkZGluZyoyKTsgLy8gY2FsY3VsYXRlZCBwb3NpdGlvbiBiZXR3ZWVuIDAgdG8gMQogICAgICAgICAgICAgICAgLy8gY2FsY3VsYXRlIHRoZSBwZXJjZW50YWdlIG9mIHRoZSBtb3VzZSBwb3NpdGlvbiB3aXRoaW4gdGhlIGNhcm91c2VsCiAgICAgICAgICAgICAgICBzY3JvbGxQb3MgPSAoc2Nyb2xsV2lkdGggLSBjb250YWluZXJXaWR0aCApICogcG9zOwoKICAgICAgICAgICAgICAgIHJhZihmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIGVsLnNjcm9sbExlZnQgPSBzY3JvbGxQb3M7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pKCk7CgogICAgLy8gQXV0b3BsYXkgY29udHJvbGxlcgogICAgQVBDb250cm9sID0gewogICAgICAgIGF1dG9QbGF5VGltZXIgOiBmYWxzZSwKICAgICAgICBwbGF5IDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgQVBDb250cm9sLmF1dG9QbGF5VGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7IGNoYW5nZUltYWdlKG5leHRJbWFnZSkgfSwgb3B0aW9ucy50aW1lKTsKICAgICAgICAgICAgQVBDb250cm9sLnByb2dyZXNzLnN0YXJ0KCk7CiAgICAgICAgICAgIGF1dG9wbGF5QnRuLnJlbW92ZUNsYXNzKCdwbGF5Jyk7CiAgICAgICAgICAgIEFQQ29udHJvbC5zZXRUaXRsZSgnQ2xpY2sgdG8gc3RvcCBhdXRvcGxheScpOwogICAgICAgICAgICBvcHRpb25zLmF1dG9wbGF5ID0gdHJ1ZTsKICAgICAgICB9LAogICAgICAgIHBhdXNlIDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KEFQQ29udHJvbC5hdXRvUGxheVRpbWVyKTsKICAgICAgICAgICAgQVBDb250cm9sLnByb2dyZXNzLnJlc2V0KCk7CiAgICAgICAgICAgIGF1dG9wbGF5QnRuLmFkZENsYXNzKCdwbGF5Jyk7CiAgICAgICAgICAgIEFQQ29udHJvbC5zZXRUaXRsZSgnQ2xpY2sgdG8gcmVzdW1lIGF1dG9wbGF5Jyk7CiAgICAgICAgICAgIG9wdGlvbnMuYXV0b3BsYXkgPSBmYWxzZTsKICAgICAgICB9LAogICAgICAgIHByb2dyZXNzIDogewogICAgICAgICAgICByZXNldCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBhdXRvcGxheUJ0bi5maW5kKCdkaXYnKS5yZW1vdmVBdHRyKCdzdHlsZScpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpeyBhdXRvcGxheUJ0bi5yZW1vdmVDbGFzcygncGxheWluZycpIH0sMjAwKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc3RhcnQgOiBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgaWYoICFpc09sZElFKQogICAgICAgICAgICAgICAgICAgIGF1dG9wbGF5QnRuLmZpbmQoJ2RpdicpLmNzcyh0cmFuc2l0aW9uLCBvcHRpb25zLnRpbWUrJ21zJyk7CiAgICAgICAgICAgICAgICBhdXRvcGxheUJ0bi5hZGRDbGFzcygncGxheWluZycpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvLyBzZXRzIHRoZSBidXR0b24gVGl0bGUgcHJvcGVydHkKICAgICAgICBzZXRUaXRsZSA6IGZ1bmN0aW9uKHRleHQpewogICAgICAgICAgICBpZih0ZXh0KQogICAgICAgICAgICAgICAgYXV0b3BsYXlCdG4ucHJvcCgndGl0bGUnLCB0ZXh0ICsgJyAoZXZlcnkgJyArIG9wdGlvbnMudGltZS8xMDAwICsgJyBzZWNvbmRzKScgKTsKICAgICAgICB9LAogICAgICAgIC8vIHRoZSBidXR0b24gb25DbGljayBoYW5kbGVyCiAgICAgICAgdG9nZ2xlIDogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIEFQQ29udHJvbFsgb3B0aW9ucy5hdXRvcGxheSA/ICdwYXVzZScgOiAncGxheSddKCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGdldFByZWZpeGVkKHByb3ApewogICAgICAgIHZhciBpLCBzID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3AnKS5zdHlsZSwgdiA9IFsnbXMnLCdPJywnTW96JywnV2Via2l0J107CiAgICAgICAgaWYoIHNbcHJvcF0gPT0gJycgKSByZXR1cm4gcHJvcDsKICAgICAgICBwcm9wID0gcHJvcC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHByb3Auc2xpY2UoMSk7CiAgICAgICAgZm9yKCBpID0gdi5sZW5ndGg7IGktLTsgKQogICAgICAgICAgICBpZiggc1t2W2ldICsgcHJvcF0gPT0gJycgKQogICAgICAgICAgICAgICAgcmV0dXJuICh2W2ldICsgcHJvcCk7CiAgICB9CgogICAgZnVuY3Rpb24ga2V5RG93bihldmVudCl7CiAgICAgICAgdmFyIGNvZGUgPSBldmVudC5rZXlDb2RlLCBvayA9IG9wdGlvbnMua2V5cywgcmVzdWx0OwogICAgICAgIC8vIFByZXZlbnQgZGVmYXVsdCBrZXlib2FyZCBhY3Rpb24gKGxpa2UgbmF2aWdhdGluZyBpbnNpZGUgdGhlIHBhZ2UpCiAgICAgICAgcmV0dXJuIG9rLmNsb3NlLmluZGV4T2YoY29kZSkgPj0gMCAmJiBjbG9zZSgpIHx8CiAgICAgICAgICAgICAgIG9rLm5leHQuaW5kZXhPZihjb2RlKSA+PSAwICYmICFvcHRpb25zLnNpbmdsZSAmJiBsb29waG9sZShuZXh0SW1hZ2UpIHx8CiAgICAgICAgICAgICAgIG9rLnByZXYuaW5kZXhPZihjb2RlKSA+PSAwICYmICFvcHRpb25zLnNpbmdsZSAmJiBsb29waG9sZShwcmV2SW1hZ2UpIHx8IHRydWU7CiAgICB9CgogICAgZnVuY3Rpb24gd2hlZWxOZXh0UHJldihlLCBkWSwgZFgpewogICAgICAgIGlmKCBkWCA9PSAxICkKICAgICAgICAgICAgbG9vcGhvbGUobmV4dEltYWdlKTsKICAgICAgICBlbHNlIGlmKCBkWCA9PSAtMSApCiAgICAgICAgICAgIGxvb3Bob2xlKHByZXZJbWFnZSk7CiAgICB9CgoKICAgIC8vIHNlcnZlcyBhcyBhIGNhbGxiYWNrIGZvciBwYlByZXZCdG4gLyBwYk5leHRCdG4gYnV0dG9ucyBidXQgYWxzbyBpcyBjYWxsZWQgb24ga2V5cHJlc3MgZXZlbnRzCiAgICBmdW5jdGlvbiBuZXh0X3ByZXYoKXsKICAgICAgICAvLyBkb24ndCBnZXQgY3Jhenkgd2hlbiB1c2VyIGNsaWNrcyBuZXh0IG9yIHByZXYgYnV0dG9ucyByYXBpZGx5CiAgICAgICAgLy9pZiggIWltYWdlLmhhc0NsYXNzKCd6b29tYWJsZScpICkKICAgICAgICAvLyAgcmV0dXJuIGZhbHNlOwoKICAgICAgICB2YXIgaWR4ID0gKHRoaXMuaWQgPT0gJ3BiUHJldkJ0bicpID8gcHJldkltYWdlIDogbmV4dEltYWdlOwoKICAgICAgICBsb29waG9sZShpZHgpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiB1cGRhdGVJbmRleGVzKGlkeCl7CiAgICAgICAgbGFzdEFjdGl2ZSA9IGFjdGl2ZUltYWdlOwogICAgICAgIGFjdGl2ZUltYWdlID0gaWR4OwogICAgICAgIGFjdGl2ZVVSTCA9IGltYWdlc1tpZHhdWzBdOwogICAgICAgIHByZXZJbWFnZSA9IChhY3RpdmVJbWFnZSB8fCAob3B0aW9ucy5sb29wID8gaW1hZ2VzLmxlbmd0aCA6IDApKSAtIDE7CiAgICAgICAgbmV4dEltYWdlID0gKChhY3RpdmVJbWFnZSArIDEpICUgaW1hZ2VzLmxlbmd0aCkgfHwgKG9wdGlvbnMubG9vcCA/IDAgOiAtMSk7CiAgICB9CgogICAgLy8gY2hlY2sgaWYgbG9vcGluZyBpcyBhbGxvd2VkIGJlZm9yZSBjaGFuZ2luZyBpbWFnZS92aWRlby4KICAgIC8vIEEgcHJlLWNoYW5nZUltYWdlIGZ1bmN0aW9uLCBvbmx5IGZvciBsaW5lYXIgY2hhbmdlcwogICAgZnVuY3Rpb24gbG9vcGhvbGUoaWR4KXsKICAgICAgICBpZiggIW9wdGlvbnMubG9vcCApewogICAgICAgICAgICB2YXIgYWZ0ZXJMYXN0ID0gYWN0aXZlSW1hZ2UgPT0gaW1hZ2VzLmxlbmd0aC0xICYmIGlkeCA9PSBuZXh0SW1hZ2UsCiAgICAgICAgICAgICAgICBiZWZvcmVGaXJzdCA9IGFjdGl2ZUltYWdlID09IDAgJiYgaWR4ID09IHByZXZJbWFnZTsKCiAgICAgICAgICAgIGlmKCBhZnRlckxhc3QgfHwgYmVmb3JlRmlyc3QgKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY2hhbmdlSW1hZ2UoaWR4KTsKICAgIH0KCiAgICBmdW5jdGlvbiBjaGFuZ2VJbWFnZShpbWFnZUluZGV4LCBmaXJzdFRpbWUsIHRodW1iQ2xpY2spewogICAgICAgIGlmKCAhaW1hZ2VJbmRleCB8fCBpbWFnZUluZGV4IDwgMCApCiAgICAgICAgICAgIGltYWdlSW5kZXggPSAwOwoKICAgICAgICAvLyBoaWRlL3Nob3cgbmV4dC1wcmV2IGJ1dHRvbnMKICAgICAgICBpZiggIW9wdGlvbnMubG9vcCApewogICAgICAgICAgICBuZXh0QnRuWyBpbWFnZUluZGV4ID09IGltYWdlcy5sZW5ndGgtMSA/ICdhZGRDbGFzcycgOiAncmVtb3ZlQ2xhc3MnIF0oJ2hpZGUnKTsKICAgICAgICAgICAgcHJldkJ0blsgaW1hZ2VJbmRleCA9PSAwID8gJ2FkZENsYXNzJyA6ICdyZW1vdmVDbGFzcycgXSgnaGlkZScpOwogICAgICAgIH0KCiAgICAgICAgLy8gaWYgdGhlcmUncyBhIGNhbGxiYWNrIGZvciB0aGlzIHBvaW50OgogICAgICAgIGlmKCB0eXBlb2Ygb3B0aW9ucy5iZWZvcmVTaG93ID09ICJmdW5jdGlvbiIpCiAgICAgICAgICAgIG9wdGlvbnMuYmVmb3JlU2hvdyhpbWFnZUxpbmtzW2ltYWdlSW5kZXhdKTsKCiAgICAgICAgb3ZlcmxheS5yZW1vdmVDbGFzcygnZXJyb3InKS5hZGRDbGFzcyggaW1hZ2VJbmRleCA+IGFjdGl2ZUltYWdlID8gJ25leHQnIDogJ3ByZXYnICk7CgogICAgICAgIHVwZGF0ZUluZGV4ZXMoaW1hZ2VJbmRleCk7CgogICAgICAgIC8vIHJlc2V0IHRoaW5ncwogICAgICAgIHN0b3AoKTsKICAgICAgICB2aWRlby5lbXB0eSgpOwogICAgICAgIHByZWxvYWQub25lcnJvciA9IG51bGw7CiAgICAgICAgaW1hZ2UuYWRkKHZpZGVvKS5kYXRhKCd6b29tJywgMSk7CgogICAgICAgIGFjdGl2ZVR5cGUgPSBpbWFnZUxpbmtzW2ltYWdlSW5kZXhdLnJlbCA9PSAndmlkZW8nID8gJ3ZpZGVvJyA6ICdpbWFnZSc7CgogICAgICAgIC8vIGNoZWNrIGlmIGN1cnJlbnQgbGluayBpcyBhIHZpZGVvCiAgICAgICAgaWYoIGFjdGl2ZVR5cGUgPT0gJ3ZpZGVvJyApewogICAgICAgICAgICB2aWRlby5odG1sKCBuZXdWaWRlbygpICkuYWRkQ2xhc3MoJ2hpZGUnKTsKICAgICAgICAgICAgc2hvd0NvbnRlbnQoZmlyc3RUaW1lKTsKICAgICAgICB9CiAgICAgICAgZWxzZXsKICAgICAgICAgICAgLy8gZ2l2ZSBhIHRpbnkgZGVsYXkgdG8gdGhlIHByZWxvYWRlciwgc28gaXQgd29uJ3QgYmUgc2hvd2VkIHdoZW4gaW1hZ2VzIGxvYWQgdmVyeSBxdWlja2x5CiAgICAgICAgICAgIHZhciBsb2FkZXJUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpeyBvdmVybGF5LmFkZENsYXNzKCdwYkxvYWRpbmcnKTsgfSwgNTApOwoKICAgICAgICAgICAgaWYoIGlzT2xkSUUgKSBvdmVybGF5LmFkZENsYXNzKCdoaWRlJyk7IC8vIHNob3VsZCB3YWl0IGZvciB0aGUgaW1hZ2Ugb25sb2FkLiBqdXN0IGhpZGUgdGhlIGltYWdlIHdoaWxlIG9sZCBJRSBkaXNwbGF5IHRoZSBwcmVsb2FkZXIKCiAgICAgICAgICAgIG9wdGlvbnMuYXV0b3BsYXkgJiYgQVBDb250cm9sLnByb2dyZXNzLnJlc2V0KCk7CiAgICAgICAgICAgIHByZWxvYWQgPSBuZXcgSW1hZ2UoKTsKICAgICAgICAgICAgcHJlbG9hZC5vbmxvYWQgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgcHJlbG9hZC5vbmxvYWQgPSBudWxsOwoKICAgICAgICAgICAgICAgIGlmKCBwcmV2SW1hZ2UgPj0gMCApIHByZWxvYWRQcmV2LnNyYyA9IGltYWdlc1twcmV2SW1hZ2VdWzBdOwogICAgICAgICAgICAgICAgaWYoIG5leHRJbWFnZSA+PSAwICkgcHJlbG9hZE5leHQuc3JjID0gaW1hZ2VzW25leHRJbWFnZV1bMF07CgogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGxvYWRlclRpbWVvdXQpOwogICAgICAgICAgICAgICAgc2hvd0NvbnRlbnQoZmlyc3RUaW1lKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgcHJlbG9hZC5vbmVycm9yID0gaW1hZ2VFcnJvcjsKICAgICAgICAgICAgcHJlbG9hZC5zcmMgPSBhY3RpdmVVUkw7CiAgICAgICAgfQoKICAgICAgICAvLyBTaG93IENhcHRpb24gdGV4dAogICAgICAgIGNhcHRpb25UZXh0Lm9uKHRyYW5zaXRpb25lbmQsIGNhcHRpb25UZXh0Q2hhbmdlKS5hZGRDbGFzcygnY2hhbmdlJyk7CiAgICAgICAgaWYoIGZpcnN0VGltZSB8fCBpc09sZElFICkgY2FwdGlvblRleHRDaGFuZ2UoKTsKCiAgICAgICAgaWYoIG9wdGlvbnMudGh1bWJzICkKICAgICAgICAgICAgdGh1bWJzU3RyaXBlLmNoYW5nZUFjdGl2ZShpbWFnZUluZGV4LCBmaXJzdFRpbWUsIHRodW1iQ2xpY2spOwogICAgICAgIC8vIFNhdmUgdXJsIGhhc2ggZm9yIGN1cnJlbnQgaW1hZ2UKICAgICAgICBoaXN0b3J5LnNhdmUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBuZXdWaWRlbygpewogICAgICAgIHZhciB1cmwgPSBpbWFnZXNbYWN0aXZlSW1hZ2VdWzBdLAogICAgICAgICAgICBzaWduID0gJCgnPGE+JykucHJvcCgnaHJlZicsaW1hZ2VzW2FjdGl2ZUltYWdlXVswXSlbMF0uc2VhcmNoID8gJyYnIDogJz8nOwogICAgICAgIHVybCArPSBzaWduICsgJ3ZxPWhkNzIwJndtb2RlPW9wYXF1ZSc7CiAgICAgICAgcmV0dXJuICQoIjxpZnJhbWU+IikucHJvcCh7IHNjcm9sbGluZzonbm8nLCBmcmFtZWJvcmRlcjowLCBhbGxvd1RyYW5zcGFyZW5jeTp0cnVlLCBzcmM6dXJsIH0pLmF0dHIoe3dlYmtpdEFsbG93RnVsbFNjcmVlbjp0cnVlLCBtb3phbGxvd2Z1bGxzY3JlZW46dHJ1ZSwgYWxsb3dGdWxsU2NyZWVuOnRydWV9KTsKICAgIH0KCiAgICAvLyBzaG93IHRoZSBpdGVtJ3MgVGl0bGUgJiBDb3VudGVyCiAgICBmdW5jdGlvbiBjYXB0aW9uVGV4dENoYW5nZSgpewogICAgICAgIGNhcHRpb25UZXh0Lm9mZih0cmFuc2l0aW9uZW5kKS5yZW1vdmVDbGFzcygnY2hhbmdlJyk7CiAgICAgICAgLy8gY2hhbmdlIGNhcHRpb24ncyB0ZXh0CiAgICAgICAgaWYoIG9wdGlvbnMuY291bnRlciApewogICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBvcHRpb25zLmNvdW50ZXIucmVwbGFjZSgnQScsIGFjdGl2ZUltYWdlICsgMSkucmVwbGFjZSgnQicsIGltYWdlcy5sZW5ndGgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGlmLCBmb3Igc29tZSByZWFzb24sIHRoZSBhYm92ZSBoYXMgZmFpbGVkIGZyb20gYSBiYWQgImNvdW50ZXIiIHZhbHVlLCByZXNldCBhbmQgcmV0cnkKICAgICAgICAgICAgY2F0Y2goZXJyKXsKICAgICAgICAgICAgICAgIG9wdGlvbnMuY291bnRlciA9ICcoQS9CKSc7CiAgICAgICAgICAgICAgICBjYXB0aW9uVGV4dENoYW5nZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhcHRpb24uZmluZCgnLmNvdW50ZXInKS50ZXh0KHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgaWYoIG9wdGlvbnMudGl0bGUgKQogICAgICAgICAgICBjYXB0aW9uLmZpbmQoJy50aXRsZScpLmh0bWwoJzxzcGFuPicgKyBpbWFnZXNbYWN0aXZlSW1hZ2VdWzFdICsgJzwvc3Bhbj4nKTsKICAgIH0KCiAgICAvLyBIYW5kbGVzIHRoZSBoaXN0b3J5IHN0YXRlcyB3aGVuIGNoYW5naW5nIGltYWdlcwogICAgdmFyIGhpc3RvcnkgPSB7CiAgICAgICAgc2F2ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIC8vIG9ubHkgc2F2ZSB0byBoaXN0b3J5IHVybHMgd2hpY2ggYXJlIG5vdCBhbHJlYWR5IGluIHRoZSBoYXNoCiAgICAgICAgICAgIGlmKCdwdXNoU3RhdGUnIGluIHdpbmRvdy5oaXN0b3J5ICYmIGRlY29kZVVSSUNvbXBvbmVudCh3aW5kb3cubG9jYXRpb24uaGFzaC5zbGljZSgxKSkgIT0gYWN0aXZlVVJMICYmIG9wdGlvbnMuaGlzdG9yeSApewogICAgICAgICAgICAgICAgd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKCAncGhvdG9ib3gnLCBkb2MudGl0bGUgKyAnLScgKyBpbWFnZXNbYWN0aXZlSW1hZ2VdWzFdLCB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgKyB3aW5kb3cubG9jYXRpb24uc2VhcmNoICsgJyMnICsgZW5jb2RlVVJJQ29tcG9uZW50KGFjdGl2ZVVSTCkgKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgbG9hZCA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGlmKCBvcHRpb25zICYmICFvcHRpb25zLmhpc3RvcnkgKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHZhciBoYXNoID0gZGVjb2RlVVJJQ29tcG9uZW50KCB3aW5kb3cubG9jYXRpb24uaGFzaC5zbGljZSgxKSApLCBpLCBqOwogICAgICAgICAgICBpZiggIWhhc2ggJiYgb3ZlcmxheS5oYXNDbGFzcygnc2hvdycpICkKICAgICAgICAgICAgICAgIGNsb3NlKCk7CiAgICAgICAgfSwKICAgICAgICBjbGVhciA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGlmKCBvcHRpb25zLmhpc3RvcnkgJiYgJ3B1c2hTdGF0ZScgaW4gd2luZG93Lmhpc3RvcnkgKQogICAgICAgICAgICAgICAgd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKCdwaG90b2JveCcsIGRvYy50aXRsZSwgd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lICsgd2luZG93LmxvY2F0aW9uLnNlYXJjaCk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBBZGQgUGhvdG9ib3ggc3BlY2lhbCBgb25wb3BzdGF0ZWAgdG8gdGhlIGBvbnBvcHN0YXRlYCBmdW5jdGlvbgogICAgd2luZG93Lm9ucG9wc3RhdGUgPSAoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY2FjaGVkID0gd2luZG93Lm9ucG9wc3RhdGU7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgICAgY2FjaGVkICYmIGNhY2hlZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICBpZiggZXZlbnQuc3RhdGUgPT0gJ3Bob3RvYm94JyApCiAgICAgICAgICAgICAgICBoaXN0b3J5LmxvYWQoKTsKICAgICAgICB9CiAgICB9KSgpOwoKICAgIC8vIGhhbmRsZXMgYWxsIGltYWdlIGxvYWRpbmcgZXJyb3IgKGlmIGltYWdlIGlzIGRlYWQpCiAgICBmdW5jdGlvbiBpbWFnZUVycm9yKCl7CiAgICAgICAgb3ZlcmxheS5hZGRDbGFzcygnZXJyb3InKTsKICAgICAgICBpbWFnZVswXS5zcmMgPSBibGFua0ltZzsgLy8gc2V0IHRoZSBzb3VyY2UgdG8gYSBibGFuayBpbWFnZQogICAgICAgIHByZWxvYWQub25lcnJvciA9IG51bGw7CiAgICB9CgogICAgLy8gU2hvd3MgdGhlIGNvbnRlbnQgKGltYWdlL3ZpZGVvKSBvbiB0aGUgc2NyZWVuCiAgICBmdW5jdGlvbiBzaG93Q29udGVudChmaXJzdFRpbWUpewogICAgICAgIHZhciBvdXQsIHNob3dTYWZ0eVRpbWVyOwogICAgICAgIHNob3dTYWZ0eVRpbWVyID0gc2V0VGltZW91dChzaG93LCAyMDAwKTsKCiAgICAgICAgLy8gaGlkZXMgdGhlIGN1cnJlbnQgaW1hZ2UgYW5kIHByZXBhcmUgZ3JvdW5kIGZvciBhbiBpbWFnZSBjaGFuZ2UKICAgICAgICBwYkxvYWRlci5mYWRlT3V0KDMwMCwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgb3ZlcmxheS5yZW1vdmVDbGFzcygicGJMb2FkaW5nIik7CiAgICAgICAgICAgIHBiTG9hZGVyLnJlbW92ZUF0dHIoJ3N0eWxlJyk7CiAgICAgICAgfSk7CiAgICAgICAgb3ZlcmxheS5hZGRDbGFzcygnaGlkZScpOwoKICAgICAgICBpbWFnZS5hZGQodmlkZW8pLnJlbW92ZUF0dHIoJ3N0eWxlJykucmVtb3ZlQ2xhc3MoJ3pvb21hYmxlJyk7IC8vIHdoaWxlIHRyYW5zaXRpb25pbmcgYW4gaW1hZ2UsIGRvIG5vdCBhcHBseSB0aGUgJ3pvb21hYmxlJyBjbGFzcwoKICAgICAgICAvLyBjaGVjayB3aGljaCBlbGVtZW50IG5lZWRzIHRvIHRyYW5zaXRpb24tb3V0OgogICAgICAgIGlmKCAhZmlyc3RUaW1lICYmIGltYWdlTGlua3NbbGFzdEFjdGl2ZV0ucmVsID09ICd2aWRlbycgKXsKICAgICAgICAgICAgb3V0ID0gdmlkZW87CiAgICAgICAgICAgIGltYWdlLmFkZENsYXNzKCdwcmVwYXJlJyk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICAgICAgb3V0ID0gaW1hZ2U7CgogICAgICAgIGlmKCBmaXJzdFRpbWUgfHwgaXNPbGRJRSApCiAgICAgICAgICAgIHNob3coKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIG91dC5vbih0cmFuc2l0aW9uZW5kLCBzaG93KTsKCiAgICAgICAgLy8gaW4gY2FzZSB0aGUgJ3RyYW5zaXRpb25lbmQnIGRpZG4ndCBmaXJlCiAgICAgICAgLy8gYWZ0ZXIgaGlkaW5nIHRoZSBsYXN0IHNlZW4gaW1hZ2UsIHNob3cgdGhlIG5ldyBvbmUKICAgICAgICBmdW5jdGlvbiBzaG93KCl7CiAgICAgICAgICAgIGNsZWFyVGltZW91dChzaG93U2FmdHlUaW1lcik7CiAgICAgICAgICAgIG91dC5vZmYodHJhbnNpdGlvbmVuZCkuY3NzKHsndHJhbnNpdGlvbic6J25vbmUnfSk7CiAgICAgICAgICAgIG92ZXJsYXkucmVtb3ZlQ2xhc3MoJ3ZpZGVvJyk7CiAgICAgICAgICAgIGlmKCBhY3RpdmVUeXBlID09ICd2aWRlbycgKXsKICAgICAgICAgICAgICAgIGltYWdlWzBdLnNyYyA9IGJsYW5rSW1nOwogICAgICAgICAgICAgICAgdmlkZW8uYWRkQ2xhc3MoJ3ByZXBhcmUnKTsKICAgICAgICAgICAgICAgIG92ZXJsYXkuYWRkQ2xhc3MoJ3ZpZGVvJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgaW1hZ2UucHJvcCh7ICdzcmMnOmFjdGl2ZVVSTCwgJ2NsYXNzJzoncHJlcGFyZScgfSk7CgogICAgICAgICAgICAvLyBmaWx0aHkgaGFjayBmb3IgdGhlIHRyYW5zaXRpb25lbmQgZXZlbnQsIGJ1dCBjYW5ub3Qgd29yayB3aXRob3V0IGl0OgogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBpbWFnZS5hZGQodmlkZW8pLnJlbW92ZUF0dHIoJ3N0eWxlJykucmVtb3ZlQ2xhc3MoJ3ByZXBhcmUnKTsKICAgICAgICAgICAgICAgIG92ZXJsYXkucmVtb3ZlQ2xhc3MoJ2hpZGUgbmV4dCBwcmV2Jyk7CiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgaW1hZ2UuYWRkKHZpZGVvKS5vbih0cmFuc2l0aW9uZW5kLCBzaG93RG9uZSk7CiAgICAgICAgICAgICAgICAgICAgaWYoaXNPbGRJRSkgc2hvd0RvbmUoKTsgLy8gSUU5IGFuZCBiZWxvdyBkb24ndCBzdXBwb3J0IHRyYW5zaXRpb25FbmQuLi4KICAgICAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICB9LDUwKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gYSBjYWxsYmFjayB3aGVuZXZlciBhIHRyYW5zaXRpb24gb2YgYW4gaW1hZ2Ugb3IgYSB2aWRlbyBpcyBkb25lCiAgICBmdW5jdGlvbiBzaG93RG9uZSgpewogICAgICAgIGltYWdlLmFkZCh2aWRlbykub2ZmKHRyYW5zaXRpb25lbmQpLmFkZENsYXNzKCd6b29tYWJsZScpOwogICAgICAgIGlmKCBhY3RpdmVUeXBlID09ICd2aWRlbycgKQogICAgICAgICAgICB2aWRlby5yZW1vdmVDbGFzcygnaGlkZScpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgYXV0b3BsYXlCdG4gJiYgb3B0aW9ucy5hdXRvcGxheSAmJiBBUENvbnRyb2wucGxheSgpOwogICAgICAgIGlmKCB0eXBlb2YgcGhvdG9ib3guY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJyApCiAgICAgICAgICAgIHBob3RvYm94LmNhbGxiYWNrLmFwcGx5KGltYWdlTGlua3NbYWN0aXZlSW1hZ2VdKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzY3JvbGxab29tKGUsIGRlbHRhWSwgZGVsdGFYKXsKICAgICAgICBpZiggZGVsdGFYICkgcmV0dXJuIGZhbHNlOwoKICAgICAgICBpZiggYWN0aXZlVHlwZSA9PSAndmlkZW8nICl7CiAgICAgICAgICAgIHZhciB6b29tTGV2ZWwgPSB2aWRlby5kYXRhKCd6b29tJykgfHwgMTsKICAgICAgICAgICAgem9vbUxldmVsICs9IChkZWx0YVkgLyAxMCk7CiAgICAgICAgICAgIGlmKCB6b29tTGV2ZWwgPCAwLjUgKQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgdmlkZW8uZGF0YSgnem9vbScsIHpvb21MZXZlbCkuY3NzKHt3aWR0aDo2MjQqem9vbUxldmVsLCBoZWlnaHQ6MzUxKnpvb21MZXZlbH0pOwogICAgICAgIH0KICAgICAgICBlbHNlewogICAgICAgICAgICB2YXIgem9vbUxldmVsID0gaW1hZ2UuZGF0YSgnem9vbScpIHx8IDEsCiAgICAgICAgICAgICAgICBnZXRTaXplID0gaW1hZ2VbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CgogICAgICAgICAgICB6b29tTGV2ZWwgKz0gKGRlbHRhWSAvIDEwKTsKCiAgICAgICAgICAgIGlmKCB6b29tTGV2ZWwgPCAwLjEgKQogICAgICAgICAgICAgICAgem9vbUxldmVsID0gMC4xOwoKICAgICAgICAgICAgcmFmKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaW1hZ2UuZGF0YSgnem9vbScsIHpvb21MZXZlbCkuY3NzKHsndHJhbnNmb3JtJzonc2NhbGUoJysgem9vbUxldmVsICsnKSd9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBjaGVjayBpZiBpbWFnZSAoYnkgbW91c2UpIG1vdmVtZW50IHNob3VsZCB0YWtlIGVmZmVjdCAoaWYgaW1hZ2UgaXMgbGFyZ2VyIHRoYW4gdGhlIHdpbmRvdwogICAgICAgICAgICBpZiggZ2V0U2l6ZS5oZWlnaHQgPiBkb2NFbG0uY2xpZW50SGVpZ2h0IHx8IGdldFNpemUud2lkdGggPiBkb2NFbG0uY2xpZW50V2lkdGggKXsKICAgICAgICAgICAgICAgICQoZG9jKS5vbignbW91c2Vtb3ZlLnBob3RvYm94JywgaW1hZ2VSZXBvc2l0aW9uKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlewogICAgICAgICAgICAgICAgJChkb2MpLm9mZignbW91c2Vtb3ZlLnBob3RvYm94Jyk7CiAgICAgICAgICAgICAgICBpbWFnZVswXS5zdHlsZVt0cmFuc2Zvcm1PcmlnaW5dID0gJzUwJSA1MCUnOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBmdW5jdGlvbiB0aHVtYnNSZXNpemUoZSwgZGVsdGEpewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyAvLyBzdG9wIHRoZSBldmVudCBmcm9tIGJ1YmJsaW5nIHVwIHRvIHRoZSBPdmVybGF5IGFuZCBlbmxhcmdlIHRoZSBjb250ZW50IGl0c2VsZgogICAgICAgIHZhciB0aHVtYkxpc3QgPSBwaG90b2JveC50aHVtYnNMaXN0LCBoOwogICAgICAgIHRodW1iTGlzdC5jc3MoJ2hlaWdodCcsIHRodW1iTGlzdFswXS5jbGllbnRIZWlnaHQgKyAoZGVsdGEgKiAxMCkgKTsKICAgICAgICBoID0gY2FwdGlvblswXS5jbGllbnRIZWlnaHQgLyAyOwogICAgICAgIHdyYXBwZXJbMF0uc3R5bGUuY3NzVGV4dCA9ICJtYXJnaW4tdG9wOiAtIisgaCArInB4OyBwYWRkaW5nOiAiKyBoICsicHggMDsiOwogICAgICAgIHRodW1icy5oaWRlKCkuc2hvdygwKTsKICAgICAgICAvL3RodW1icy50cmlnZ2VyKCdtb3VzZWVudGVyJykudHJpZ2dlcignbW91c2Vtb3ZlJyk7CiAgICB9CgogICAgLy8gbW92ZXMgdGhlIGltYWdlIGFyb3VuZCBkdXJpbmcgem9vbSBtb2RlIG9uIG1vdXNlbW92ZSBldmVudAogICAgZnVuY3Rpb24gaW1hZ2VSZXBvc2l0aW9uKGUpewogICAgICAgIHZhciB5ID0gKGUuY2xpZW50WSAvIGRvY0VsbS5jbGllbnRIZWlnaHQpICogKGRvY0VsbS5jbGllbnRIZWlnaHQgKyAyMDApIC0gMTAwLCAvLyBleHRlbmQgdGhlIHJhbmdlIG9mIHRoZSBZIGF4aXMgYnkgMTAwIGVhY2ggc2lkZQogICAgICAgICAgICB5RGVsdGEgPSB5IC8gZG9jRWxtLmNsaWVudEhlaWdodCAqIDEwMCwKICAgICAgICAgICAgeERlbHRhID0gZS5jbGllbnRYIC8gZG9jRWxtLmNsaWVudFdpZHRoICogMTAwLAogICAgICAgICAgICBvcmlnaW4gPSB4RGVsdGEudG9GaXhlZCgyKSsnJSAnICsgeURlbHRhLnRvRml4ZWQoMikgKyclJzsKCiAgICAgICAgcmFmKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpbWFnZVswXS5zdHlsZVt0cmFuc2Zvcm1PcmlnaW5dID0gb3JpZ2luOwogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHN0b3AoKXsKICAgICAgICBjbGVhclRpbWVvdXQoQVBDb250cm9sLmF1dG9QbGF5VGltZXIpOwogICAgICAgICQoZG9jKS5vZmYoJ21vdXNlbW92ZS5waG90b2JveCcpOwogICAgICAgIHByZWxvYWQub25sb2FkID0gZnVuY3Rpb24oKXt9OwogICAgICAgIHByZWxvYWQuc3JjID0gcHJlbG9hZFByZXYuc3JjID0gcHJlbG9hZE5leHQuc3JjID0gYWN0aXZlVVJMOwogICAgfQoKICAgIGZ1bmN0aW9uIGNsb3NlKCl7CiAgICAgICAgICAgIGlmKCAhb3ZlcmxheS5oYXNDbGFzcygnc2hvdycpICkKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIHN0b3AoKTsKICAgICAgICAgICAgdmlkZW8uZmluZCgnaWZyYW1lJykucHJvcCgnc3JjJywnJykuZW1wdHkoKTsKICAgICAgICAgICAgUGhvdG9ib3gucHJvdG90eXBlLnNldHVwKCk7CiAgICAgICAgICAgIGhpc3RvcnkuY2xlYXIoKTsKCiAgICAgICAgICAgIG92ZXJsYXkucmVtb3ZlQ2xhc3MoJ29uIHZpZGVvJykuYWRkQ2xhc3MoJ2hpZGUnKTsKCiAgICAgICAgICAgIGltYWdlLm9uKHRyYW5zaXRpb25lbmQsIGhpZGUpOwogICAgICAgICAgICBpc09sZElFICYmIGhpZGUoKTsKCiAgICAgICAgICAgIC8vIHRoZSAicGhvdG9ib3giIGluc3RhbmNlIG1pZ2h0IGJlIG5lZWRlZCBmb3IgYXN5bmMgdHJhbnNpdGlvbkVuZCBmdW5jdGlvbnMsIHNvIGdpdmUgaXQgc29tZSB0aW1lIGJlZm9yZSBjbGVhcmluZyBpdAogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBwaG90b2JveCA9IG51bGw7CiAgICAgICAgICAgIH0sMTAwMCk7CgogICAgICAgICAgICBmdW5jdGlvbiBoaWRlKCl7CiAgICAgICAgICAgICAgICBpZiggb3ZlcmxheVswXS5jbGFzc05hbWUgPT0gJycgKSByZXR1cm47IC8vIGlmIGFscmVhZHkgaGlkZGVuCiAgICAgICAgICAgICAgICBvdmVybGF5LnJlbW92ZUNsYXNzKCdzaG93IGhpZGUgZXJyb3IgcGJMb2FkaW5nJyk7CiAgICAgICAgICAgICAgICBpbWFnZS5yZW1vdmVBdHRyKCdjbGFzcycpLnJlbW92ZUF0dHIoJ3N0eWxlJykub2ZmKCkuZGF0YSgnem9vbScsMSk7CiAgICAgICAgICAgICAgICBjYXB0aW9uLmZpbmQoJy50aXRsZScpLmVtcHR5KCk7CgogICAgICAgICAgICAgICAgaWYobm9Qb2ludGVyRXZlbnRzKSAvLyBwb2ludGVyLWV2ZW50cyBsYWNrIHN1cHBvcnQgaW4gSUUsIHNvIGp1c3QgaGlkZSB0aGUgb3ZlcmxheQogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsgb3ZlcmxheS5oaWRlKCk7IH0sIDIwMCk7CgogICAgICAgICAgICAgICAgb3B0aW9ucy5oaWRlRmxhc2ggJiYgJCgnaWZyYW1lLCBvYmplY3QsIGVtYmVkJykuY3NzKCd2aXNpYmlsaXR5JywgJ3Zpc2libGUnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZmFsbC1iYWNrIGlmIHRoZSAndHJhbnNpdGlvbmVuZCcgZXZlbnQgZGlkbid0IGZpcmUKICAgICAgICAgICAgc2V0VGltZW91dChoaWRlLCA1MDApOwogICAgICAgICAgICAvLyBjYWxsYmFjayBhZnRlciBjbG9zaW5nIHRoZSBnYWxsZXJ5CiAgICAgICAgICAgIGlmKCB0eXBlb2Ygb3B0aW9ucy5hZnRlckNsb3NlID09PSAnZnVuY3Rpb24nICkKICAgICAgICAgICAgICAgIG9wdGlvbnMuYWZ0ZXJDbG9zZShvdmVybGF5KTsKICAgIH0KCgogICAgLyoqCiAgICAqIGpRdWVyeSBQbHVnaW4gdG8gYWRkIGJhc2ljICJzd2lwZSIgc3VwcG9ydCBvbiB0b3VjaC1lbmFibGVkIGRldmljZXMKICAgICoKICAgICogQGF1dGhvciBZYWlyIEV2ZW4gT3IKICAgICogQHZlcnNpb24gMS4wLjAgKE1hcmNoIDIwLCAyMDEzKQogICAgKi8KICAgICQuZXZlbnQuc3BlY2lhbC5zd2lwZSA9IHsKICAgICAgICBzZXR1cDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgJCh0aGlzKS5iaW5kKCd0b3VjaHN0YXJ0JywgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhhbmRsZXIpOwogICAgICAgIH0sCgogICAgICAgIHRlYXJkb3duOiBmdW5jdGlvbigpewogICAgICAgICAgICAkKHRoaXMpLnVuYmluZCgndG91Y2hzdGFydCcsICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5oYW5kbGVyKTsKICAgICAgICB9LAoKICAgICAgICBoYW5kbGVyOiBmdW5jdGlvbihldmVudCl7CiAgICAgICAgICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksIC8vIGNsb25lIGFyZ3VtZW50cyBhcnJheSwgcmVtb3ZlIG9yaWdpbmFsIGV2ZW50IGZyb20gY2xvbmVkIGFycmF5CiAgICAgICAgICAgICAgICB0b3VjaGVzID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzLAogICAgICAgICAgICAgICAgc3RhcnRYLCBzdGFydFksCiAgICAgICAgICAgICAgICBkZWx0YVggPSAwLCBkZWx0YVkgPSAwLAogICAgICAgICAgICAgICAgdGhhdCA9IHRoaXM7CgogICAgICAgICAgICBldmVudCA9ICQuZXZlbnQuZml4KGV2ZW50KTsKCiAgICAgICAgICAgIGlmKCB0b3VjaGVzLmxlbmd0aCA9PSAxICl7CiAgICAgICAgICAgICAgICBzdGFydFggPSB0b3VjaGVzWzBdLnBhZ2VYOwogICAgICAgICAgICAgICAgc3RhcnRZID0gdG91Y2hlc1swXS5wYWdlWTsKICAgICAgICAgICAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgb25Ub3VjaE1vdmUsIGZhbHNlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gY2FuY2VsVG91Y2goKXsKICAgICAgICAgICAgICAgIHRoYXQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgb25Ub3VjaE1vdmUpOwogICAgICAgICAgICAgICAgc3RhcnRYID0gc3RhcnRZID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnVuY3Rpb24gb25Ub3VjaE1vdmUoZSl7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgICAgICAgdmFyIER4ID0gc3RhcnRYIC0gZS50b3VjaGVzWzBdLnBhZ2VYLAogICAgICAgICAgICAgICAgICAgIER5ID0gc3RhcnRZIC0gZS50b3VjaGVzWzBdLnBhZ2VZOwoKICAgICAgICAgICAgICAgIGlmKCBNYXRoLmFicyhEeCkgPj0gMjAgKXsKICAgICAgICAgICAgICAgICAgICBjYW5jZWxUb3VjaCgpOwogICAgICAgICAgICAgICAgICAgIGRlbHRhWCA9IChEeCA+IDApID8gLTEgOiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiggTWF0aC5hYnMoRHkpID49IDIwICl7CiAgICAgICAgICAgICAgICAgICAgY2FuY2VsVG91Y2goKTsKICAgICAgICAgICAgICAgICAgICBkZWx0YVkgPSAoRHkgPiAwKSA/IDEgOiAtMTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBldmVudC50eXBlID0gJ3N3aXBlJzsKICAgICAgICAgICAgICAgIGFyZ3MudW5zaGlmdChldmVudCwgZGVsdGFYLCBkZWx0YVkpOyAvLyBhZGQgYmFjayB0aGUgbmV3IGV2ZW50IHRvIHRoZSBmcm9udCBvZiB0aGUgYXJndW1lbnRzIHdpdGggdGhlIGRlbGF0YXMKICAgICAgICAgICAgICAgIHJldHVybiAoJC5ldmVudC5kaXNwYXRjaCB8fCAkLmV2ZW50LmhhbmRsZSkuYXBwbHkodGhhdCwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIC8qISBDb3B5cmlnaHQgKGMpIDIwMTMgQnJhbmRvbiBBYXJvbiAoaHR0cDovL2JyYW5kb24uYWFyb24uc2gpCiAgICAgKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UgKExJQ0VOU0UudHh0KS4KICAgICAqCiAgICAgKiBWZXJzaW9uOiAzLjEuMTEKICAgICAqCiAgICAgKiBSZXF1aXJlczogalF1ZXJ5IDEuMi4yKwogICAgICovCiAgICAhZnVuY3Rpb24oYSl7ImZ1bmN0aW9uIj09dHlwZW9mIGRlZmluZSYmZGVmaW5lLmFtZD9kZWZpbmUoWyJqcXVlcnkiXSxhKToib2JqZWN0Ij09dHlwZW9mIGV4cG9ydHM/bW9kdWxlLmV4cG9ydHM9YTphKGpRdWVyeSl9KGZ1bmN0aW9uKGEpe2Z1bmN0aW9uIGIoYil7dmFyIGc9Ynx8d2luZG93LmV2ZW50LGg9aS5jYWxsKGFyZ3VtZW50cywxKSxqPTAsbD0wLG09MCxuPTAsbz0wLHA9MDtpZihiPWEuZXZlbnQuZml4KGcpLGIudHlwZT0ibW91c2V3aGVlbCIsImRldGFpbCJpbiBnJiYobT0tMSpnLmRldGFpbCksIndoZWVsRGVsdGEiaW4gZyYmKG09Zy53aGVlbERlbHRhKSwid2hlZWxEZWx0YVkiaW4gZyYmKG09Zy53aGVlbERlbHRhWSksIndoZWVsRGVsdGFYImluIGcmJihsPS0xKmcud2hlZWxEZWx0YVgpLCJheGlzImluIGcmJmcuYXhpcz09PWcuSE9SSVpPTlRBTF9BWElTJiYobD0tMSptLG09MCksaj0wPT09bT9sOm0sImRlbHRhWSJpbiBnJiYobT0tMSpnLmRlbHRhWSxqPW0pLCJkZWx0YVgiaW4gZyYmKGw9Zy5kZWx0YVgsMD09PW0mJihqPS0xKmwpKSwwIT09bXx8MCE9PWwpe2lmKDE9PT1nLmRlbHRhTW9kZSl7dmFyIHE9YS5kYXRhKHRoaXMsIm1vdXNld2hlZWwtbGluZS1oZWlnaHQiKTtqKj1xLG0qPXEsbCo9cX1lbHNlIGlmKDI9PT1nLmRlbHRhTW9kZSl7dmFyIHI9YS5kYXRhKHRoaXMsIm1vdXNld2hlZWwtcGFnZS1oZWlnaHQiKTtqKj1yLG0qPXIsbCo9cn1pZihuPU1hdGgubWF4KE1hdGguYWJzKG0pLE1hdGguYWJzKGwpKSwoIWZ8fGY+bikmJihmPW4sZChnLG4pJiYoZi89NDApKSxkKGcsbikmJihqLz00MCxsLz00MCxtLz00MCksaj1NYXRoW2o+PTE/ImZsb29yIjoiY2VpbCJdKGovZiksbD1NYXRoW2w+PTE/ImZsb29yIjoiY2VpbCJdKGwvZiksbT1NYXRoW20+PTE/ImZsb29yIjoiY2VpbCJdKG0vZiksay5zZXR0aW5ncy5ub3JtYWxpemVPZmZzZXQmJnRoaXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KXt2YXIgcz10aGlzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO289Yi5jbGllbnRYLXMubGVmdCxwPWIuY2xpZW50WS1zLnRvcH1yZXR1cm4gYi5kZWx0YVg9bCxiLmRlbHRhWT1tLGIuZGVsdGFGYWN0b3I9ZixiLm9mZnNldFg9byxiLm9mZnNldFk9cCxiLmRlbHRhTW9kZT0wLGgudW5zaGlmdChiLGosbCxtKSxlJiZjbGVhclRpbWVvdXQoZSksZT1zZXRUaW1lb3V0KGMsMjAwKSwoYS5ldmVudC5kaXNwYXRjaHx8YS5ldmVudC5oYW5kbGUpLmFwcGx5KHRoaXMsaCl9fWZ1bmN0aW9uIGMoKXtmPW51bGx9ZnVuY3Rpb24gZChhLGIpe3JldHVybiBrLnNldHRpbmdzLmFkanVzdE9sZERlbHRhcyYmIm1vdXNld2hlZWwiPT09YS50eXBlJiZiJTEyMD09PTB9dmFyIGUsZixnPVsid2hlZWwiLCJtb3VzZXdoZWVsIiwiRE9NTW91c2VTY3JvbGwiLCJNb3pNb3VzZVBpeGVsU2Nyb2xsIl0saD0ib253aGVlbCJpbiBkb2N1bWVudHx8ZG9jdW1lbnQuZG9jdW1lbnRNb2RlPj05P1sid2hlZWwiXTpbIm1vdXNld2hlZWwiLCJEb21Nb3VzZVNjcm9sbCIsIk1vek1vdXNlUGl4ZWxTY3JvbGwiXSxpPUFycmF5LnByb3RvdHlwZS5zbGljZTtpZihhLmV2ZW50LmZpeEhvb2tzKWZvcih2YXIgaj1nLmxlbmd0aDtqOylhLmV2ZW50LmZpeEhvb2tzW2dbLS1qXV09YS5ldmVudC5tb3VzZUhvb2tzO3ZhciBrPWEuZXZlbnQuc3BlY2lhbC5tb3VzZXdoZWVsPXt2ZXJzaW9uOiIzLjEuMTEiLHNldHVwOmZ1bmN0aW9uKCl7aWYodGhpcy5hZGRFdmVudExpc3RlbmVyKWZvcih2YXIgYz1oLmxlbmd0aDtjOyl0aGlzLmFkZEV2ZW50TGlzdGVuZXIoaFstLWNdLGIsITEpO2Vsc2UgdGhpcy5vbm1vdXNld2hlZWw9YjthLmRhdGEodGhpcywibW91c2V3aGVlbC1saW5lLWhlaWdodCIsay5nZXRMaW5lSGVpZ2h0KHRoaXMpKSxhLmRhdGEodGhpcywibW91c2V3aGVlbC1wYWdlLWhlaWdodCIsay5nZXRQYWdlSGVpZ2h0KHRoaXMpKX0sdGVhcmRvd246ZnVuY3Rpb24oKXtpZih0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIpZm9yKHZhciBjPWgubGVuZ3RoO2M7KXRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihoWy0tY10sYiwhMSk7ZWxzZSB0aGlzLm9ubW91c2V3aGVlbD1udWxsO2EucmVtb3ZlRGF0YSh0aGlzLCJtb3VzZXdoZWVsLWxpbmUtaGVpZ2h0IiksYS5yZW1vdmVEYXRhKHRoaXMsIm1vdXNld2hlZWwtcGFnZS1oZWlnaHQiKX0sZ2V0TGluZUhlaWdodDpmdW5jdGlvbihiKXt2YXIgYz1hKGIpWyJvZmZzZXRQYXJlbnQiaW4gYS5mbj8ib2Zmc2V0UGFyZW50IjoicGFyZW50Il0oKTtyZXR1cm4gYy5sZW5ndGh8fChjPWEoImJvZHkiKSkscGFyc2VJbnQoYy5jc3MoImZvbnRTaXplIiksMTApfSxnZXRQYWdlSGVpZ2h0OmZ1bmN0aW9uKGIpe3JldHVybiBhKGIpLmhlaWdodCgpfSxzZXR0aW5nczp7YWRqdXN0T2xkRGVsdGFzOiEwLG5vcm1hbGl6ZU9mZnNldDohMH19O2EuZm4uZXh0ZW5kKHttb3VzZXdoZWVsOmZ1bmN0aW9uKGEpe3JldHVybiBhP3RoaXMuYmluZCgibW91c2V3aGVlbCIsYSk6dGhpcy50cmlnZ2VyKCJtb3VzZXdoZWVsIil9LHVubW91c2V3aGVlbDpmdW5jdGlvbihhKXtyZXR1cm4gdGhpcy51bmJpbmQoIm1vdXNld2hlZWwiLGEpfX0pfSk7CgogICAgLy8vLy8vLy8vLy8vLy8gT04gRE9DVU1FTlQgUkVBRFkgLy8vLy8vLy8vLy8vLy8vLy8KICAgICQoZG9jKS5yZWFkeShwcmVwYXJlRE9NKTsKCiAgICAvLyBFeHBvc2U6CiAgICB3aW5kb3cuX3Bob3RvYm94ID0gewogICAgICAgIGNsb3NlICAgIDogY2xvc2UsCiAgICAgICAgaGlzdG9yeSAgOiBoaXN0b3J5LAogICAgICAgIGRlZmF1bHRzIDogZGVmYXVsdHMKICAgIH07Cn0pKGpRdWVyeSwgZG9jdW1lbnQsIHdpbmRvdyk7",
                "body": "LyohCiAgICBwaG90b2JveCB2MS45LjEKICAgIChjKSAyMDEzIFlhaXIgRXZlbiBPciA8aHR0cDovL2Ryb3B0aGViaXQuY29tPgoKICAgIE1JVC1zdHlsZSBsaWNlbnNlLgoqLwoKKGZ1bmN0aW9uKCQsIGRvYywgd2luKXsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIgUGhvdG9ib3gsIHBob3RvYm94LCBvcHRpb25zLCBpbWFnZXM9W10sIGltYWdlTGlua3MsIGFjdGl2ZUltYWdlID0gLTEsIGFjdGl2ZVVSTCwgbGFzdEFjdGl2ZSwgYWN0aXZlVHlwZSwgcHJldkltYWdlLCBuZXh0SW1hZ2UsIHRodW1ic1N0cmlwZSwgZG9jRWxtLCBBUENvbnRyb2wsCiAgICAgICAgdHJhbnNpdGlvbmVuZCA9ICJ0cmFuc2l0aW9uZW5kIHdlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQgTVNUcmFuc2l0aW9uRW5kIiwKICAgICAgICBpc09sZElFID0gISgncGxhY2Vob2xkZXInIGluIGRvYy5jcmVhdGVFbGVtZW50KCdpbnB1dCcpKSwKICAgICAgICBub1BvaW50ZXJFdmVudHMgPSAoZnVuY3Rpb24oKXsgdmFyIGVsID0gJCgnPHA+JylbMF07IGVsLnN0eWxlLmNzc1RleHQgPSAncG9pbnRlci1ldmVudHM6YXV0byc7IHJldHVybiAhZWwuc3R5bGUucG9pbnRlckV2ZW50c30pKCksCiAgICAgICAgaXNNb2JpbGUgPSAnb250b3VjaGVuZCcgaW4gZG9jLCAvLyBzaG91bGQgYmUgdXBkYXRlZCB0byBzb21ldGhpbmcgdGhhdCBkZXRlY3RzIHRoZSBsYWNrIG9mIGEgbW91c2UKICAgICAgICB0aHVtYnNDb250YWluZXJXaWR0aCwgdGh1bWJzVG90YWxXaWR0aCwgYWN0aXZlVGh1bWIgPSAkKCksCiAgICAgICAgYmxhbmtJbWcgPSAiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUFBUC8vLy8vLy95SDVCQUVLQUFFQUxBQUFBQUFCQUFFQUFBSUNUQUVBT3c9PSIsCiAgICAgICAgdHJhbnNmb3JtT3JpZ2luID0gZ2V0UHJlZml4ZWQoJ3RyYW5zZm9ybU9yaWdpbicpLAogICAgICAgIHRyYW5zaXRpb24gPSBnZXRQcmVmaXhlZCgndHJhbnNpdGlvbicpLAogICAgICAgICAgLy8gTm9ybWFsaXplIHJBRgogICAgICAgIHJhZiA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUKICAgICAgICAgICB8fCB3aW5kb3cud2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lCiAgICAgICAgICAgfHwgd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZQogICAgICAgICAgIHx8IHdpbmRvdy5tc1JlcXVlc3RBbmltYXRpb25GcmFtZQogICAgICAgICAgIHx8IGZ1bmN0aW9uKGNiKSB7IHJldHVybiB3aW5kb3cuc2V0VGltZW91dChjYiwgMTAwMCAvIDYwKTsgfSwKCiAgICAgICAgLy8gUHJlbG9hZCBpbWFnZXMKICAgICAgICBwcmVsb2FkID0ge30sIHByZWxvYWRQcmV2ID0gbmV3IEltYWdlKCksIHByZWxvYWROZXh0ID0gbmV3IEltYWdlKCksCiAgICAgICAgLy8gRE9NIGVsZW1lbnRzCiAgICAgICAgY2xvc2VCdG4sIGltYWdlLCB2aWRlbywgcHJldkJ0biwgbmV4dEJ0biwgdGh1bWJzVG9nZ2xlciwgY2FwdGlvbiwgY2FwdGlvblRleHQsIHBiTG9hZGVyLCBhdXRvcGxheUJ0biwgdGh1bWJzLCB3cmFwcGVyLAoKICAgICAgICBkZWZhdWx0cyA9IHsKICAgICAgICAgICAgc2luZ2xlICAgICAgICA6IGZhbHNlLCAgIC8vIGlmICJ0cnVlIiAtIGdhbGxlcnkgd2lsbCBvbmx5IHNob3cgYSBzaW5nbGUgaW1hZ2UsIHdpdGggbm8gd2F5IHRvIG5hdmlnYXRlCiAgICAgICAgICAgIGJlZm9yZVNob3cgICAgOiBudWxsLCAgICAvLyBDYWxsYmFjayBiZWZvcmUgc2hvd2luZyBhbiBpbWFnZQogICAgICAgICAgICBhZnRlckNsb3NlICAgIDogbnVsbCwgICAgLy8gQ2FsbGJhY2sgYWZ0ZXIgY2xvc2luZyB0aGUgZ2FsbGVyeQogICAgICAgICAgICBsb29wICAgICAgICAgIDogdHJ1ZSwgICAgLy8gQWxsb3dzIHRvIG5hdmlnYXRlIGJldHdlZW4gZmlyc3QgYW5kIGxhc3QgaW1hZ2VzCiAgICAgICAgICAgIHRodW1iICAgICAgICAgOiBudWxsLCAgICAvLyBBIHJlbGF0aXZlIHBhdGggZnJvbSB0aGUgbGluayB0byB0aGUgdGh1bWJuYWlsIChpZiBpdCdzIG5vdCBpbnNpZGUgdGhlIGxpbmspCiAgICAgICAgICAgIHRodW1icyAgICAgICAgOiB0cnVlLCAgICAvLyBTaG93IGdhbGxlcnkgdGh1bWJuYWlscyBiZWxvdyB0aGUgcHJlc2VudGVkIHBob3RvCiAgICAgICAgICAgIGNvdW50ZXIgICAgICAgOiAiKEEvQikiLCAvLyBDb3VudHMgd2hpY2ggcGllY2Ugb2YgY29udGVudCBpcyBiZWluZyB2aWV3ZWQsIHJlbGF0aXZlIHRvIHRoZSB0b3RhbCBjb3VudCBvZiBpdGVtcyBpbiB0aGUgcGhvdG9ib3ggc2V0LiBbImZhbHNlIiwiU3RyaW5nIl0KICAgICAgICAgICAgdGl0bGUgICAgICAgICA6IHRydWUsICAgIC8vIHNob3cgdGhlIG9yaWdpbmFsIGFsdCBvciB0aXRsZSBhdHRyaWJ1dGUgb2YgdGhlIGltYWdlJ3MgdGh1bWJuYWlsLiAocGF0aCB0byBpbWFnZSwgcmVsYXRpdmUgdG8gdGhlIGVsZW1lbnQgd2hpY2ggdHJpZ2dlcnMgcGhvdG9ib3gpCiAgICAgICAgICAgIGF1dG9wbGF5ICAgICAgOiBmYWxzZSwgICAvLyBzaG91bGQgYXV0b3BsYXkgb24gZmlyc3QgdGltZSBvciBub3QKICAgICAgICAgICAgdGltZSAgICAgICAgICA6IDMwMDAsICAgIC8vIGF1dG9wbGF5IGludGVydmFsLCBpbiBtaWxpc2Vjb25kcyAobGVzcyB0aGFuIDEwMDAgd2lsbCBoaWRlIHRoZSBhdXRvcGxheSBidXR0b24pCiAgICAgICAgICAgIGhpc3RvcnkgICAgICAgOiB0cnVlLCAgICAvLyBzaG91bGQgdXNlIGhpc3RvcnkgaGFzaGluZyBpZiBwb3NzaWJsZSAoSFRNTDUgQVBJKQogICAgICAgICAgICBoaWRlRmxhc2ggICAgIDogdHJ1ZSwgICAgLy8gSGlkZXMgZmxhc2ggZWxlbWVudHMgb24gdGhlIHBhZ2Ugd2hlbiBwaG90b2JveCBpcyBhY3RpdmF0ZWQuIE5PVEU6IGZsYXNoIGVsZW1lbnRzIG11c3QgaGF2ZSB3bW9kZSBwYXJhbWV0ZXIgc2V0IHRvICJvcGFxdWUiIG9yICJ0cmFuc3BhcmVudCIgaWYgdGhpcyBpcyBzZXQgdG8gZmFsc2UKICAgICAgICAgICAgem9vbWFibGUgICAgICA6IHRydWUsICAgIC8vIGRpc2FibGUvZW5hYmxlIG1vdXNld2hlZWwgaW1hZ2Ugem9vbWluZwogICAgICAgICAgICB3aGVlbE5leHRQcmV2IDogdHJ1ZSwgICAgLy8gY2hhbmdlIGltYWdlIHVzaW5nIG1vdXNld2hlZWwgbGVmdC9yaWdodAogICAgICAgICAgICBrZXlzICAgICAgICAgIDogewogICAgICAgICAgICAgICAgY2xvc2UgOiAnMjcsIDg4LCA2NycsICAgIC8vIGtleWNvZGVzIHRvIGNsb3NlIHBob3RvYm94LCBkZWZhdWx0OiBlc2MgKDI3KSwgJ3gnICg4OCksICdjJyAoNjcpCiAgICAgICAgICAgICAgICBwcmV2ICA6ICczNywgODAnLCAgICAgICAgLy8ga2V5Y29kZXMgdG8gbmF2aWdhdGUgdG8gdGhlIHByZXZpb3VzIGltYWdlLCBkZWZhdWx0OiBMZWZ0IGFycm93ICgzNyksICdwJyAoODApCiAgICAgICAgICAgICAgICBuZXh0ICA6ICczOSwgNzgnICAgICAgICAgLy8ga2V5Y29kZXMgdG8gbmF2aWdhdGUgdG8gdGhlIG5leHQgaW1hZ2UsIGRlZmF1bHQ6IFJpZ2h0IGFycm93ICgzOSksICduJyAoNzgpCiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBET00gc3RydWN0dXJlCiAgICAgICAgb3ZlcmxheSA9ICAgJCgnPGRpdiBpZD0icGJPdmVybGF5Ij4nKS5hcHBlbmQoCiAgICAgICAgICAgICAgICAgICAgICAgIHRodW1ic1RvZ2dsZXIgPSAkKCc8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJwYlRodW1ic1RvZ2dsZXIiIGNoZWNrZWQgaGlkZGVuPicpLAogICAgICAgICAgICAgICAgICAgICAgICBwYkxvYWRlciA9ICQoJzxkaXYgY2xhc3M9InBiTG9hZGVyIj48Yj48L2I+PGI+PC9iPjxiPjwvYj48L2Rpdj4nKSwKICAgICAgICAgICAgICAgICAgICAgICAgcHJldkJ0biA9ICQoJzxkaXYgaWQ9InBiUHJldkJ0biIgY2xhc3M9InByZXZOZXh0Ij48Yj48L2I+PC9kaXY+Jykub24oJ2NsaWNrJywgbmV4dF9wcmV2KSwKICAgICAgICAgICAgICAgICAgICAgICAgbmV4dEJ0biA9ICQoJzxkaXYgaWQ9InBiTmV4dEJ0biIgY2xhc3M9InByZXZOZXh0Ij48Yj48L2I+PC9kaXY+Jykub24oJ2NsaWNrJywgbmV4dF9wcmV2KSwKICAgICAgICAgICAgICAgICAgICAgICAgd3JhcHBlciA9ICQoJzxkaXYgY2xhc3M9InBiV3JhcHBlciI+JykuYXBwZW5kKCAgLy8gZ2l2ZXMgUGVyc3BlY3RpdmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlID0gJCgnPGltZz4nKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZGVvID0gJCgnPGRpdj4nKQogICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICBjbG9zZUJ0biA9ICQoJzxkaXYgaWQ9InBiQ2xvc2VCdG4iPicpLm9uKCdjbGljaycsIGNsb3NlKVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgYXV0b3BsYXlCdG4gPSAkKCc8ZGl2IGlkPSJwYkF1dG9wbGF5QnRuIj4nKS5hcHBlbmQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCc8ZGl2IGNsYXNzPSJwYlByb2dyZXNzIj4nKQogICAgICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgICAgICBjYXB0aW9uID0gJCgnPGRpdiBpZD0icGJDYXB0aW9uIj4nKS5hcHBlbmQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGxhYmVsIGZvcj0icGJUaHVtYnNUb2dnbGVyIiB0aXRsZT0idGh1bWJuYWlscyBvbi9vZmYiPjwvbGFiZWw+JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhcHRpb25UZXh0ID0gJCgnPGRpdiBjbGFzcz0icGJDYXB0aW9uVGV4dCI+JykuYXBwZW5kKCc8ZGl2IGNsYXNzPSJ0aXRsZSI+PC9kaXY+PGRpdiBjbGFzcz0iY291bnRlciI+JyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHVtYnMgPSAkKCc8ZGl2PicpLmFkZENsYXNzKCdwYlRodW1icycpCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICApOwogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgICBJbml0aWFsaXphdGlvbiAob24gRE9NIHJlYWR5KQogICAgKi8KICAgIGZ1bmN0aW9uIHByZXBhcmVET00oKXsKICAgICAgICBub1BvaW50ZXJFdmVudHMgJiYgb3ZlcmxheS5oaWRlKCk7CgogICAgICAgIGF1dG9wbGF5QnRuLm9mZigpLm9uKCdjbGljaycsIEFQQ29udHJvbC50b2dnbGUpOwogICAgICAgIC8vIGF0dGFjaCBhIGRlbGVnYXRlZCBldmVudCBvbiB0aGUgdGh1bWJzIGNvbnRhaW5lcgogICAgICAgIHRodW1icy5vZmYoKS5vbignY2xpY2snLCAnYScsIHRodW1ic1N0cmlwZS5jbGljayk7CiAgICAgICAgLy8gaWYgdXNlcmFnZW50IGlzIElFIDwgMTAgKHVzZXIgZGVzZXJ2ZXMgYSBzbGFwIG9uIHRoZSBmYWNlLCBidXQgSSBnb3R0YSBzdXBwb3J0IHRoZW0gc3RpbGwuLi4pCiAgICAgICAgaXNPbGRJRSAmJiBvdmVybGF5LmFkZENsYXNzKCdtc2llJyk7CiAgICAgICAgaXNNb2JpbGUgJiYgb3ZlcmxheS5hZGRDbGFzcygnbW9iaWxlJyk7CgogICAgICAgIC8vIGNhbmNlbCBwcm9yb2dhdGlvbiB1cCB0byB0aGUgb3ZlcmxheSBjb250YWluZXIgc28gaXQgd29uJ3QgY2xvc2UKICAgICAgICBvdmVybGF5Lm9mZigpLm9uKCdjbGljaycsICdpbWcnLCBmdW5jdGlvbihlKXsKICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICB9KTsKCiAgICAgICAgJChkb2MuYm9keSkuYXBwZW5kKG92ZXJsYXkpOwoKICAgICAgICAvLyBuZWVkIHRoaXMgZm9yIGxhdGVyOgogICAgICAgIGRvY0VsbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQ7CiAgICB9CgogICAgLy8gQHBhcmFtIFtMaXN0IG9mIGVsZW1lbnRzIHRvIHdvcmsgb24sIEN1c3RvbSBzZXR0aW5ncywgQ2FsbGJhY2sgYWZ0ZXIgaW1hZ2UgaXMgbG9hZGVkXQogICAgJC5mbi5waG90b2JveCA9IGZ1bmN0aW9uKHRhcmdldCwgc2V0dGluZ3MsIGNhbGxiYWNrKXsKICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHZhciBvLAogICAgICAgICAgICAgICAgUEJfZGF0YSA9ICQodGhpcykuZGF0YSgnX3Bob3RvYm94Jyk7CgogICAgICAgICAgICBpZiggUEJfZGF0YSApeyAvLyBkb24ndCBpbml0aWF0ZSB0aGUgcGx1Z2luIG1vcmUgdGhhbiBvbmNlIG9uIHRoZSBzYW1lIGVsZW1lbnQKICAgICAgICAgICAgICAgIGlmKCB0YXJnZXQgPT09ICdkZXN0cm95JykKICAgICAgICAgICAgICAgICAgICBQQl9kYXRhLmRlc3Ryb3koKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoIHR5cGVvZiB0YXJnZXQgIT0gJ3N0cmluZycgKQogICAgICAgICAgICAgICAgdGFyZ2V0ID0gJ2EnOwoKICAgICAgICAgICAgaWYoIHRhcmdldCA9PT0gJ3ByZXBhcmVET00nICl7CiAgICAgICAgICAgICAgICBwcmVwYXJlRE9NKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbyA9ICQuZXh0ZW5kKHt9LCBkZWZhdWx0cywgc2V0dGluZ3MgfHwge30pOwogICAgICAgICAgICBwaG90b2JveCA9IG5ldyBQaG90b2JveChvLCB0aGlzLCB0YXJnZXQpOwoKICAgICAgICAgICAgLy8gU2F2ZXMgdGhlIGluc2FuY2Ugb24gdGhlIGdhbGxlcnkncyB0YXJnZXQgZWxlbWVudAogICAgICAgICAgICAkKHRoaXMpLmRhdGEoJ19waG90b2JveCcsIHBob3RvYm94KTsKICAgICAgICAgICAgLy8gYWRkIGEgY2FsbGJhY2sgdG8gdGhlIHNwZWNpZmljIGdhbGxlcnkKICAgICAgICAgICAgcGhvdG9ib3guY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICB9KTsKICAgIH0KCiAgICBQaG90b2JveCA9IGZ1bmN0aW9uKF9vcHRpb25zLCBvYmplY3QsIHRhcmdldCl7CiAgICAgICAgdGhpcy5vcHRpb25zID0gJC5leHRlbmQoe30sIF9vcHRpb25zKTsKICAgICAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgICAgICB0aGlzLnNlbGVjdG9yID0gJChvYmplY3QgfHwgZG9jKTsKCiAgICAgICAgdGhpcy50aHVtYnNMaXN0ID0gbnVsbDsKICAgICAgICAvLyBmaWx0ZXIgdGhlIGxpbmtzIHdoaWNoIGFjdHVhbGx5IEhBUyBhbiBpbWFnZSBhcyBhIGNoaWxkCiAgICAgICAgdmFyIGZpbHRlcmVkID0gdGhpcy5pbWFnZUxpbmtzRmlsdGVyKCB0aGlzLnNlbGVjdG9yLmZpbmQodGFyZ2V0KSApOwoKICAgICAgICB0aGlzLmltYWdlTGlua3MgPSBmaWx0ZXJlZFswXTsgIC8vIEFycmF5IG9mIGpRdWVyeSBsaW5rcwogICAgICAgIHRoaXMuaW1hZ2VzID0gZmlsdGVyZWRbMV07ICAgICAgLy8gMkQgQXJyYXkgb2YgaW1hZ2UgVVJMICYgdGl0bGUKICAgICAgICB0aGlzLmluaXQoKTsKICAgIH07CgogICAgUGhvdG9ib3gucHJvdG90eXBlID0gewogICAgICAgIGluaXQgOiBmdW5jdGlvbigpewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7CgogICAgICAgICAgICAvLyBvbmx5IGdlbmVyYXRlcyB0aGUgdGh1bWJTdHJpcGUgb25jZSwgYW5kIGxpc3RlbiBmb3IgYW55IERPTSBjaGFuZ2VzIG9uIHRoZSBzZWxlY3RvciBlbGVtZW50LCBpZiBzbywgcmUtZ2VuZXJhdGUKICAgICAgICAgICAgLy8gVGhpcyBpcyBkb25lIG9uICJtb3VzZWVudGVyIiBzbyBpbWFnZXMgd2lsbCBub3QgZ2V0IGNhbGxlZCB1bmxlc3MgaXQncyBsaWVrbHkgdGhhdCB0aGV5IHdvdWxkIGJlIG5lZWRlZAogICAgICAgICAgICB0aGlzLnNlbGVjdG9yLm9uZSgnbW91c2VlbnRlci5waG90b2JveCcsIHRoaXMudGFyZ2V0LCBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAgIHRoYXQudGh1bWJzTGlzdCA9IHRodW1ic1N0cmlwZS5nZW5lcmF0ZS5hcHBseSh0aGF0KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0aGlzLnNlbGVjdG9yLm9uKCdjbGljay5waG90b2JveCcsIHRoaXMudGFyZ2V0LCBmdW5jdGlvbihlKXsKICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIHRoYXQub3Blbih0aGlzKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvLyBpZiBhbnkgbm9kZSB3YXMgYWRkZWQgb3IgcmVtb3ZlZCBmcm9tIHRoZSBTZWxlY3RvciBvZiB0aGUgZ2FsbGVyeQogICAgICAgICAgICB0aGlzLm9ic2VydmVyVGltZW91dCA9IG51bGw7CgogICAgICAgICAgICBpZiggdGhpcy5zZWxlY3RvclswXS5ub2RlVHlwZSA9PSAxICkgLy8gb2JzZXJ2ZSBub3JtYWwgbm9kZXMKICAgICAgICAgICAgICAgIHRoYXQub2JzZXJ2ZURPTSggdGhhdC5zZWxlY3RvclswXSwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAvLyB1c2UgYSB0aW1lb3V0IHRvIHByZXZlbnQgbW9yZSB0aGFuIG9uZSBET00gY2hhbmdlIGV2ZW50IGZpcmluZyBhdCBvbmNlLCBhbmQgYWxzbyB0byBvdmVyY29tZSB0aGUgZmFjdCB0aGF0IElFJ3MgRE9NTm9kZVJlbW92ZWQgaXMgZmlyZWQgQkVGT1JFIGVsZW1lbnRzIHdlcmUgYWN0dWFsbHkgcmVtb3ZlZAogICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGF0Lm9ic2VydmVyVGltZW91dCk7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5vYnNlcnZlclRpbWVvdXQgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZmlsdGVyZWQgPSB0aGF0LmltYWdlTGlua3NGaWx0ZXIoIHRoYXQuc2VsZWN0b3IuZmluZCh0aGF0LnRhcmdldCkgKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZUluZGV4ID0gMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzQWN0aXZlVXJsID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgT05MWSBET00gY2hhbmdlcyBpbiB0aGUgcGhvdG9ib3ggbnVtYmVyIG9mIGl0ZW1zIHdpbGwgdHJpZ2dlciBhIGNoYW5nZQogICAgICAgICAgICAgICAgICAgICAgICBpZih0aGF0LmltYWdlTGlua3MubGVuZ3RoID09IGZpbHRlcmVkWzBdLmxlbmd0aCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuaW1hZ2VMaW5rcyA9IGZpbHRlcmVkWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB0aGF0LmltYWdlcyA9IGZpbHRlcmVkWzFdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgcGhvdG9ib3ggaXMgb3BlbmVkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCBwaG90b2JveCApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgZ2FsbGVyeSB3aGljaCB3YXMgY2hhbmdlZCBpcyB0aGUgY3VycmVudGx5IHZpZXdlZCBvbmU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiggdGhhdC5zZWxlY3RvciA9PSBwaG90b2JveC5zZWxlY3RvciApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlcyA9IHRoYXQuaW1hZ2VzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlTGlua3MgPSB0aGF0LmltYWdlTGlua3M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgdGhlIGN1cnJlbnRseSBWSUVXRUQgcGhvdG8gaGFzIGJlZW4gZGUtdGFjaGVkIGZyb20gYSBwaG90b2JveCBzZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBzbywgcmVtb3ZlIG5hdmlnYXRpb24gYXJyb3dzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogZml4IHRoZSAiaW1hZ2VzIiB0byBiZSBhbiBvYmplY3QgYW5kIG5vdCBhbiBhcnJheS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IoIGkgPSBpbWFnZXMubGVuZ3RoOyBpLS07ICl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCBpbWFnZXNbaV1bMF0gPT0gYWN0aXZlVVJMICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzQWN0aXZlVXJsID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgbm90IGV4aXRzIGFueSBtb3JlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCBpc0FjdGl2ZVVybCApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJsYXkucmVtb3ZlQ2xhc3MoJ2hhc0Fycm93cycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGlzIGdhbGxlcnkgaGFzIHRodW1icwogICAgICAgICAgICAgICAgICAgICAgICAvL2lmKCB0aGF0Lm9wdGlvbnMudGh1bWJzICl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnRodW1ic0xpc3QgPSB0aHVtYnNTdHJpcGUuZ2VuZXJhdGUuYXBwbHkodGhhdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHVtYnMuaHRtbCggdGhhdC50aHVtYnNMaXN0ICk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIHRoYXQuaW1hZ2VzLmxlbmd0aCAmJiBhY3RpdmVVUkwgJiYgdGhhdC5vcHRpb25zLnRodW1icyApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlSW5kZXggPSB0aGF0LnRodW1ic0xpc3QuZmluZCgnYVtocmVmPSInK2FjdGl2ZVVSTCsnIl0nKS5lcSgwKS5wYXJlbnQoKS5pbmRleCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCBhY3RpdmVJbmRleCA9PSAtMSApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlSW5kZXggPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUluZGV4ZXMoYWN0aXZlSW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGh1bWJzU3RyaXBlLmNoYW5nZUFjdGl2ZShhY3RpdmVJbmRleCwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBvcGVuIDogZnVuY3Rpb24obGluayl7CiAgICAgICAgICAgIHZhciBzdGFydEltYWdlID0gJC5pbkFycmF5KGxpbmssIHRoaXMuaW1hZ2VMaW5rcyk7CiAgICAgICAgICAgIC8vIGlmIGltYWdlIGxpbmsgZG9lcyBub3QgZXhpc3QgaW4gdGhlIGltYWdlTGlua3MgYXJyYXkgKHByb2JhYmx5IG1lYW5zIGl0J3Mgbm90IGEgdmFsaWQgcGFydCBvZiB0aGUgZ2FsbGVyeSkKICAgICAgICAgICAgaWYoIHN0YXJ0SW1hZ2UgPT0gLTEgKQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgICAgLy8gbG9hZCB0aGUgcmlnaHQgZ2FsbGVyeSBzZWxlY3Rvci4uLgogICAgICAgICAgICBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICAgICAgICBpbWFnZXMgPSB0aGlzLmltYWdlczsKICAgICAgICAgICAgaW1hZ2VMaW5rcyA9IHRoaXMuaW1hZ2VMaW5rczsKCiAgICAgICAgICAgIHBob3RvYm94ID0gdGhpczsKICAgICAgICAgICAgdGhpcy5zZXR1cCgxKTsKCiAgICAgICAgICAgIG92ZXJsYXkub24odHJhbnNpdGlvbmVuZCwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIG92ZXJsYXkub2ZmKHRyYW5zaXRpb25lbmQpLmFkZENsYXNzKCdvbicpOyAvLyBjbGFzcyAnb24nIGlzIHNldCB3aGVuIHRoZSBpbml0aWFsIGZhZGUtaW4gb2YgdGhlIG92ZXJsYXkgaXMgZG9uZQogICAgICAgICAgICAgICAgY2hhbmdlSW1hZ2Uoc3RhcnRJbWFnZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0pLmFkZENsYXNzKCdzaG93Jyk7CgogICAgICAgICAgICBpZiggaXNPbGRJRSApCiAgICAgICAgICAgICAgICBvdmVybGF5LnRyaWdnZXIoJ01TVHJhbnNpdGlvbkVuZCcpOwoKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIGltYWdlTGlua3NGaWx0ZXIgOiBmdW5jdGlvbihvYmopewogICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXMsCiAgICAgICAgICAgICAgICBpbWFnZXMgPSBbXSwKICAgICAgICAgICAgICAgIGNhcHRpb24gPSB7fSwKICAgICAgICAgICAgICAgIGNhcHRpb25saW5rOwoKICAgICAgICAgICAgcmV0dXJuIFtvYmouZmlsdGVyKGZ1bmN0aW9uKGkpewogICAgICAgICAgICAgICAgLy8gc2VhcmNoIGZvciB0aGUgdGh1bWIgaW5zaWRlIHRoZSBsaW5rLCBpZiBub3QgZm91bmQgdGhlbiBzZWUgaWYgdGhlcmUncyBhICd0aGF0LnNldHRpbmdzLnRodW1iJyBwb2ludGVyIHRvIHRoZSB0aHVtYm5haWwKICAgICAgICAgICAgICAgIHZhciBsaW5rID0gJCh0aGlzKSwKICAgICAgICAgICAgICAgICAgICB0aHVtYkltZywKICAgICAgICAgICAgICAgICAgICB0aHVtYlNyYyA9ICcnOwoKICAgICAgICAgICAgICAgIGNhcHRpb24uY29udGVudCA9IGxpbmtbMF0uZ2V0QXR0cmlidXRlKCd0aXRsZScpIHx8ICcnOwoKICAgICAgICAgICAgICAgIGlmKCB0aGF0Lm9wdGlvbnMudGh1bWIgKQogICAgICAgICAgICAgICAgICAgIHRodW1iSW1nID0gbGluay5maW5kKHRoYXQub3B0aW9ucy50aHVtYilbMF07CgogICAgICAgICAgICAgICAgLy8gdHJ5IGEgZGlyZWN0IGNoaWxkIGxvb2t1cAogICAgICAgICAgICAgICAgaWYoICF0aGF0Lm9wdGlvbnMudGh1bWIgfHwgIXRodW1iSW1nICkKICAgICAgICAgICAgICAgICAgICB0aHVtYkltZyA9IGxpbmsuZmluZCgnaW1nJylbMF07CgogICAgICAgICAgICAgICAgLy8gaWYgbm8gaW1nIGNoaWxkIGZvdW5kIGluIHRoZSBsaW5rCiAgICAgICAgICAgICAgICBpZiggdGh1bWJJbWcgKXsKICAgICAgICAgICAgICAgICAgICBjYXB0aW9ubGluayA9IHRodW1iSW1nLmdldEF0dHJpYnV0ZSgnZGF0YS1wYi1jYXB0aW9ubGluaycpOwogICAgICAgICAgICAgICAgICAgIHRodW1iU3JjID0gdGh1bWJJbWcuZ2V0QXR0cmlidXRlKCdzcmMnKTsKCiAgICAgICAgICAgICAgICAgICAgY2FwdGlvbi5jb250ZW50ID0gKCB0aHVtYkltZy5nZXRBdHRyaWJ1dGUoJ2FsdCcpIHx8IHRodW1iSW1nLmdldEF0dHJpYnV0ZSgndGl0bGUnKSB8fCAnJyk7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgIC8vIGlmIHRoZXJlIGlzIGEgY2FwdGlvbiBsaW5rIHRvIGJlIGFkZGVkOgogICAgICAgICAgICAgICAgaWYoIGNhcHRpb25saW5rICl7CiAgICAgICAgICAgICAgICAgICAgY2FwdGlvbmxpbmsgPSBjYXB0aW9ubGluay5zcGxpdCgnWycpOwogICAgICAgICAgICAgICAgICAgIC8vIHBhcnNlIGNvbXBsZXggbGlua3M6IHRleHRbd3d3LnNpdGUuY29tXQogICAgICAgICAgICAgICAgICAgIGlmKCBjYXB0aW9ubGluay5sZW5ndGggPT0gMiApewogICAgICAgICAgICAgICAgICAgICAgICBjYXB0aW9uLmxpbmtUZXh0ID0gY2FwdGlvbmxpbmtbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHRpb24ubGlua0hyZWYgPSBjYXB0aW9ubGlua1sxXS5zbGljZSgwLC0xKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdGlvbi5saW5rVGV4dCA9IGNhcHRpb25saW5rOwogICAgICAgICAgICAgICAgICAgICAgICBjYXB0aW9uLmxpbmtIcmVmID0gY2FwdGlvbmxpbms7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNhcHRpb24uY29udGVudCArPSAnIDxhIGhyZWY9IicrIGNhcHRpb24ubGlua0hyZWYgKyciPicgKyBjYXB0aW9uLmxpbmtUZXh0ICsgJzwvYT4nOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGltYWdlcy5wdXNoKCBbbGlua1swXS5ocmVmLCBjYXB0aW9uLmNvbnRlbnQsIHRodW1iU3JjXSApOwoKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9KSwgaW1hZ2VzXTsKICAgICAgICB9LAoKICAgICAgICAvL2NoZWNrIGlmIERPTSBub2RlcyB3ZXJlIGFkZGVkIG9yIHJlbW92ZWQsIHRvIHJlLWJ1aWxkIHRoZSBpbWFnZUxpbmtzIGFuZCB0aHVtYm5haWxzCiAgICAgICAgb2JzZXJ2ZURPTSA6IChmdW5jdGlvbigpewogICAgICAgICAgICB2YXIgTXV0YXRpb25PYnNlcnZlciA9IHdpbi5NdXRhdGlvbk9ic2VydmVyIHx8IHdpbi5XZWJLaXRNdXRhdGlvbk9ic2VydmVyLAogICAgICAgICAgICAgICAgZXZlbnRMaXN0ZW5lclN1cHBvcnRlZCA9IHdpbi5hZGRFdmVudExpc3RlbmVyOwoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iaiwgY2FsbGJhY2spewogICAgICAgICAgICAgICAgaWYoIE11dGF0aW9uT2JzZXJ2ZXIgKXsKICAgICAgICAgICAgICAgICAgICAvLyBkZWZpbmUgYSBuZXcgb2JzZXJ2ZXIKICAgICAgICAgICAgICAgICAgICB2YXIgb2JzID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24obXV0YXRpb25zLCBvYnNlcnZlcil7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCBtdXRhdGlvbnNbMF0uYWRkZWROb2Rlcy5sZW5ndGggfHwgbXV0YXRpb25zWzBdLnJlbW92ZWROb2Rlcy5sZW5ndGggKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAvLyBoYXZlIHRoZSBvYnNlcnZlciBvYnNlcnZlIGZvbyBmb3IgY2hhbmdlcyBpbiBjaGlsZHJlbgogICAgICAgICAgICAgICAgICAgIG9icy5vYnNlcnZlKCBvYmosIHsgY2hpbGRMaXN0OnRydWUsIHN1YnRyZWU6dHJ1ZSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYoIGV2ZW50TGlzdGVuZXJTdXBwb3J0ZWQgKXsKICAgICAgICAgICAgICAgICAgICBvYmouYWRkRXZlbnRMaXN0ZW5lcignRE9NTm9kZUluc2VydGVkJywgY2FsbGJhY2ssIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICBvYmouYWRkRXZlbnRMaXN0ZW5lcignRE9NTm9kZVJlbW92ZWQnLCBjYWxsYmFjaywgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSkoKSwKCiAgICAgICAgLy8gdGhpbmdzIHRoYXQgc2hvdWxkIGhhcHBlbiBldmVyeSB0aW1lIHRoZSBnYWxsZXJ5IG9wZW5zIG9yIGNsb3NlcyAoc29tZSBtZXNzZWQgdXAgY29kZSBiZWxvdy4uKQogICAgICAgIHNldHVwIDogZnVuY3Rpb24gKG9wZW4pewogICAgICAgICAgICB2YXIgZm4gPSBvcGVuID8gIm9uIiA6ICJvZmYiOwoKICAgICAgICAgICAgLy8gYSBoYWNrIHRvIGNoYW5nZSB0aGUgaW1hZ2Ugc3JjIHRvIG5vdGhpbmcsIGJlY2F1c2UgeW91IGNhbid0IGRvIHRoYXQgaW4gQ0hST01FCiAgICAgICAgICAgIGltYWdlWzBdLnNyYyA9IGJsYW5rSW1nOwoKICAgICAgICAgICAgLy8gdGh1bWJzIHN0dWZmCiAgICAgICAgICAgIGlmKCBvcHRpb25zLnRodW1icyApewogICAgICAgICAgICAgICAgaWYoICFpc01vYmlsZSApewogICAgICAgICAgICAgICAgICAgIHRodW1ic1tmbl0oJ21vdXNlZW50ZXIucGhvdG9ib3gnLCB0aHVtYnNTdHJpcGUuY2FsYykKICAgICAgICAgICAgICAgICAgICAgICAgICBbZm5dKCdtb3VzZW1vdmUucGhvdG9ib3gnLCB0aHVtYnNTdHJpcGUubW92ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKCBvcGVuICl7CiAgICAgICAgICAgICAgICBpbWFnZS5jc3Moeyd0cmFuc2l0aW9uJzonMHMnfSkucmVtb3ZlQXR0cignc3R5bGUnKTsgLy8gcmVzZXQgYW55IHRyYW5zaXRpb24gdGhhdCBtaWdodCBiZSBvbiB0aGUgZWxlbWVudCAoeWVzIGl0J3MgdWdseSkKICAgICAgICAgICAgICAgIG92ZXJsYXkuc2hvdygpOwogICAgICAgICAgICAgICAgLy8gQ2xlYW4gdXAgaWYgYW5vdGhlciBnYWxsZXJ5IHdhcyB2aWV3ZWQgYmVmb3JlLCB3aGljaCBoYWQgYSB0aHVtYnNMaXN0CiAgICAgICAgICAgICAgICB0aHVtYnMKICAgICAgICAgICAgICAgICAgICAuaHRtbCggdGhpcy50aHVtYnNMaXN0ICkKICAgICAgICAgICAgICAgICAgICAudHJpZ2dlcignbW91c2VlbnRlci5waG90b2JveCcpOwoKICAgICAgICAgICAgICAgIGlmKCBvcHRpb25zLnRodW1icyApewogICAgICAgICAgICAgICAgICAgIG92ZXJsYXkuYWRkQ2xhc3MoJ3RodW1icycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICAgICB0aHVtYnNUb2dnbGVyLnByb3AoJ2NoZWNrZWQnLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgb3ZlcmxheS5yZW1vdmVDbGFzcygndGh1bWJzJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gdGhpbmdzIHRvIGhpZGUgaWYgdGhlcmUgYXJlIGxlc3MgdGhhbiAyIGltYWdlcwogICAgICAgICAgICAgICAgaWYoIHRoaXMuaW1hZ2VzLmxlbmd0aCA8IDIgfHwgIG9wdGlvbnMuc2luZ2xlICkKICAgICAgICAgICAgICAgICAgICBvdmVybGF5LnJlbW92ZUNsYXNzKCd0aHVtYnMgaGFzQXJyb3dzIGhhc0NvdW50ZXIgaGFzQXV0b3BsYXknKTsKICAgICAgICAgICAgICAgIGVsc2V7CiAgICAgICAgICAgICAgICAgICAgb3ZlcmxheS5hZGRDbGFzcygnaGFzQXJyb3dzIGhhc0NvdW50ZXInKQoKICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayBpcyB0aGUgYXV0b3BsYXkgYnV0dG9uIHNob3VsZCBiZSB2aXNpYmxlIChwZXIgZ2FsbGVyeSkgYW5kIGlmIHNvLCBzaG91bGQgaXQgYXV0b3BsYXkgb3Igbm90LgogICAgICAgICAgICAgICAgICAgIGlmKCBvcHRpb25zLnRpbWUgPiAxMDAwICl7CiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJsYXkuYWRkQ2xhc3MoJ2hhc0F1dG9wbGF5Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCBvcHRpb25zLmF1dG9wbGF5ICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFQQ29udHJvbC5wcm9ncmVzcy5zdGFydCgpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBBUENvbnRyb2wucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBvdmVybGF5LnJlbW92ZUNsYXNzKCdoYXNBdXRvcGxheScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG9wdGlvbnMuaGlkZUZsYXNoICYmICQoJ2lmcmFtZSwgb2JqZWN0LCBlbWJlZCcpLmNzcygndmlzaWJpbGl0eScsICdoaWRkZW4nKTsKCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkKHdpbikub2ZmKCdyZXNpemUucGhvdG9ib3gnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJChkb2MpLm9mZigia2V5ZG93bi5waG90b2JveCIpW2ZuXSh7ICJrZXlkb3duLnBob3RvYm94Ijoga2V5RG93biB9KTsKCiAgICAgICAgICAgIGlmKCBpc01vYmlsZSApewogICAgICAgICAgICAgICAgb3ZlcmxheS5yZW1vdmVDbGFzcygnaGFzQXJyb3dzJyk7IC8vIG5vIG5lZWQgZm9yIEFycm93cyBvbiB0b3VjaC1lbmFibGVkCiAgICAgICAgICAgICAgICB3cmFwcGVyW2ZuXSgnc3dpcGUnLCBvblN3aXBlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoIG9wdGlvbnMuem9vbWFibGUgKXsKICAgICAgICAgICAgICAgIG92ZXJsYXlbZm5dKHsibW91c2V3aGVlbC5waG90b2JveCI6IHNjcm9sbFpvb20gfSk7CiAgICAgICAgICAgICAgICBpZiggIWlzT2xkSUUpIHRodW1ic1tmbl0oeyJtb3VzZXdoZWVsLnBob3RvYm94IjogdGh1bWJzUmVzaXplIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiggIW9wdGlvbnMuc2luZ2xlICYmIG9wdGlvbnMud2hlZWxOZXh0UHJldiApewogICAgICAgICAgICAgICAgb3ZlcmxheVtmbl0oeyJtb3VzZXdoZWVsLnBob3RvYm94Ijogd2hlZWxOZXh0UHJldiB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGRlc3Ryb3kgOiBmdW5jdGlvbigpewogICAgICAgICAgICBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICAgICAgICB0aGlzLnNlbGVjdG9yCiAgICAgICAgICAgICAgICAub2ZmKCdjbGljay5waG90b2JveCcsIHRoaXMudGFyZ2V0KQogICAgICAgICAgICAgICAgLnJlbW92ZURhdGEoJ19waG90b2JveCcpOwoKICAgICAgICAgICAgY2xvc2UoKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gb24gdG91Y2gtZGV2aWNlcyBvbmx5CiAgICBmdW5jdGlvbiBvblN3aXBlKGUsIER4LCBEeSl7CiAgICAgICAgaWYoIER4ID09IDEgKXsKICAgICAgICAgICAgaW1hZ2UuY3NzKHt0cmFuc2Zvcm06J3RyYW5zbGF0ZVgoMjUlKScsIHRyYW5zaXRpb246Jy4ycycsIG9wYWNpdHk6MH0pOwogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7IGNoYW5nZUltYWdlKHByZXZJbWFnZSkgfSwgMjAwKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiggRHggPT0gLTEgKXsKICAgICAgICAgICAgaW1hZ2UuY3NzKHt0cmFuc2Zvcm06J3RyYW5zbGF0ZVgoLTI1JSknLCB0cmFuc2l0aW9uOicuMnMnLCBvcGFjaXR5OjB9KTsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpeyBjaGFuZ2VJbWFnZShuZXh0SW1hZ2UpIH0sIDIwMCk7CiAgICAgICAgfQoKICAgICAgICBpZiggRHkgPT0gMSApCiAgICAgICAgICAgIHRodW1ic1RvZ2dsZXIucHJvcCgnY2hlY2tlZCcsIHRydWUpOwogICAgICAgIGVsc2UgaWYoIER5ID09IC0xICkKICAgICAgICAgICAgdGh1bWJzVG9nZ2xlci5wcm9wKCdjaGVja2VkJywgZmFsc2UpOwogICAgfQoKICAgIC8vIG1hbmFnZSB0aGUgKGJvdHRvbSkgdGh1bWJzIHN0cmlwCiAgICB0aHVtYnNTdHJpcGUgPSAoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY29udGFpbmVyV2lkdGggICA9IDAsCiAgICAgICAgICAgIHNjcm9sbFdpZHRoICAgICAgPSAwLAogICAgICAgICAgICBwb3NGcm9tTGVmdCAgICAgID0gMCwgICAgLy8gU3RyaXBlIHBvc2l0aW9uIGZyb20gdGhlIGxlZnQgb2YgdGhlIHNjcmVlbgogICAgICAgICAgICBzdHJpcGVQb3MgICAgICAgID0gMCwgICAgLy8gV2hlbiByZWxhdGl2ZSBtb3VzZSBwb3NpdGlvbiBpbnNpZGUgdGhlIHRodW1icyBzdHJpcGUKICAgICAgICAgICAgYW5pbWF0ZWQgICAgICAgICA9IG51bGwsCiAgICAgICAgICAgIHBhZGRpbmcsICAgICAgICAgICAgICAgICAvLyBpbiBwZXJjZW50YWdlIHRvIHRoZSBjb250YWluZXJXaWR0aAogICAgICAgICAgICBlbCwgJGVsLCByYXRpbywgc2Nyb2xsUG9zLCBwb3M7CgogICAgICAgIHJldHVybnsKICAgICAgICAgICAgLy8gcmV0dXJucyBhIDx1bD4gZWxlbWVudCB3aGljaCBpcyBwb3B1bGF0ZWQgd2l0aCBhbGwgdGhlIGdhbGxlcnkgbGlua3MgYW5kIHRodW1icwogICAgICAgICAgICBnZW5lcmF0ZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICB2YXIgdGh1bWJzTGlzdCA9ICQoJzx1bD4nKSwKICAgICAgICAgICAgICAgICAgICBlbGVtZW50cyAgID0gW10sCiAgICAgICAgICAgICAgICAgICAgbGVuICAgICAgICA9IHRoaXMuaW1hZ2VMaW5rcy5zaXplKCksCiAgICAgICAgICAgICAgICAgICAgdGl0bGUsIHRodW1iU3JjLCBsaW5rLCB0eXBlLCBpOwoKICAgICAgICAgICAgICAgIGZvciggaSA9IDA7IGkgPCBsZW47IGkrKyApewogICAgICAgICAgICAgICAgICAgIGxpbmsgPSB0aGlzLmltYWdlTGlua3NbaV07CgogICAgICAgICAgICAgICAgICAgIHRodW1iU3JjID0gdGhpcy5pbWFnZXNbaV1bMl07CiAgICAgICAgICAgICAgICAgICAgLy8gY29udGludWUgaWYgaGFzIHRodW1iCiAgICAgICAgICAgICAgICAgICAgaWYoICF0aHVtYlNyYyApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgICAgICB0aXRsZSA9IHRoaXMuaW1hZ2VzW2ldWzFdOwogICAgICAgICAgICAgICAgICAgIHR5cGUgPSBsaW5rLnJlbCA/ICIgY2xhc3M9JyIgKyBsaW5rLnJlbCArIiciIDogJyc7CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudHMucHVzaCgnPGxpJysgdHlwZSArJz48YSBocmVmPSInKyBsaW5rLmhyZWYgKyciPjxpbWcgc3JjPSInKyB0aHVtYlNyYyArJyIgYWx0PSIiIHRpdGxlPSInKyB0aXRsZSArJyIgLz48L2E+PC9saT4nKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aHVtYnNMaXN0Lmh0bWwoIGVsZW1lbnRzLmpvaW4oJycpICk7CiAgICAgICAgICAgICAgICByZXR1cm4gdGh1bWJzTGlzdDsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGNsaWNrIDogZnVuY3Rpb24oZSl7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgICAgICAgICAgYWN0aXZlVGh1bWIucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgYWN0aXZlVGh1bWIgPSAkKHRoaXMpLnBhcmVudCgpLmFkZENsYXNzKCdhY3RpdmUnKTsKCiAgICAgICAgICAgICAgICB2YXIgaW1hZ2VJbmRleCA9ICQodGhpcy5wYXJlbnROb2RlKS5pbmRleCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNoYW5nZUltYWdlKGltYWdlSW5kZXgsIDAsIDEpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY2hhbmdlQWN0aXZlVGltZW91dCA6IG51bGwsCiAgICAgICAgICAgIC8qKiBIaWdobGlnaHRzIHRoZSB0aHVtYiB3aGljaCByZXByZXNlbnRzIHRoZSBwaG90byBhbmQgY2VudHJlcyB0aGUgdGh1bWJzIHZpZXdlciBvbiBpdC4KICAgICAgICAgICAgKiogIEB0aHVtYkNsaWNrIC0gaWYgYSB1c2VyIGNsaWNrZWQgb24gYSB0aHVtYm5haWwsIGRvbid0IGNlbnRlciBvbiBpdAogICAgICAgICAgICAqLwogICAgICAgICAgICBjaGFuZ2VBY3RpdmUgOiBmdW5jdGlvbihpbmRleCwgZGVsYXksIHRodW1iQ2xpY2spewogICAgICAgICAgICAgICAgdmFyIGxhc3RJbmRleCA9IGFjdGl2ZVRodW1iLmluZGV4KCk7CiAgICAgICAgICAgICAgICBhY3RpdmVUaHVtYi5yZW1vdmVDbGFzcygnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICBhY3RpdmVUaHVtYiA9IHRodW1icy5maW5kKCdsaScpLmVxKGluZGV4KS5hZGRDbGFzcygnYWN0aXZlJyk7CgogICAgICAgICAgICAgICAgaWYoIHRodW1iQ2xpY2sgfHwgIWFjdGl2ZVRodW1iWzBdICkgcmV0dXJuOwogICAgICAgICAgICAgICAgLy8gc2V0IHRoZSBzY3JvbGxMZWZ0IHBvc2l0aW9uIG9mIHRoZSB0aHVtYnMgbGlzdCB0byBzaG93IHRoZSBhY3RpdmUgdGh1bWIKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmNoYW5nZUFjdGl2ZVRpbWVvdXQpOwogICAgICAgICAgICAgICAgLy8gZ2l2ZSB0aGUgaW1hZ2VzIHRpbWUgdG8gdG8gc2V0dGxlIG9uIHRoZWlyIG5ldyBzaXplcyAoYmVjYXVzZSBvZiBjc3MgdHJhbnNpdGlvbikgYW5kIHRoZW4gY2FsY3VsYXRlIHRoZSBjZW50ZXIuLi4KICAgICAgICAgICAgICAgIHRoaXMuY2hhbmdlQWN0aXZlVGltZW91dCA9IHNldFRpbWVvdXQoCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBvcyA9IGFjdGl2ZVRodW1iWzBdLm9mZnNldExlZnQgKyBhY3RpdmVUaHVtYlswXS5jbGllbnRXaWR0aC8yIC0gZG9jRWxtLmNsaWVudFdpZHRoLzI7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGF5ID8gdGh1bWJzLmRlbGF5KDgwMCkgOiB0aHVtYnMuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aHVtYnMuYW5pbWF0ZSh7c2Nyb2xsTGVmdDogcG9zfSwgNTAwLCAnc3dpbmcnKTsKICAgICAgICAgICAgICAgICAgICB9LCAyMDApOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gY2FsY3VsYXRlIHRoZSB0aHVtYnMgY29udGFpbmVyIHdpZHRoLCBpZiB0aGUgd2luZG93IGhhcyBiZWVuIHJlc2l6ZWQKICAgICAgICAgICAgY2FsYyA6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgZWwgPSB0aHVtYnNbMF07CgogICAgICAgICAgICAgICAgY29udGFpbmVyV2lkdGggICAgICAgPSBlbC5jbGllbnRXaWR0aDsKICAgICAgICAgICAgICAgIHNjcm9sbFdpZHRoICAgICAgICAgID0gZWwuc2Nyb2xsV2lkdGg7CiAgICAgICAgICAgICAgICBwYWRkaW5nICAgICAgICAgICAgICA9IDAuMTUgKiBjb250YWluZXJXaWR0aDsKCiAgICAgICAgICAgICAgICBwb3NGcm9tTGVmdCAgICAgICAgICA9IHRodW1icy5vZmZzZXQoKS5sZWZ0OwogICAgICAgICAgICAgICAgc3RyaXBlUG9zICAgICAgICAgICAgPSBlLnBhZ2VYIC0gcGFkZGluZyAtIHBvc0Zyb21MZWZ0OwogICAgICAgICAgICAgICAgcG9zICAgICAgICAgICAgICAgICAgPSBzdHJpcGVQb3MgLyAoY29udGFpbmVyV2lkdGggLSBwYWRkaW5nKjIpOwogICAgICAgICAgICAgICAgc2Nyb2xsUG9zICAgICAgICAgICAgPSAoc2Nyb2xsV2lkdGggLSBjb250YWluZXJXaWR0aCApICogcG9zOwoKICAgICAgICAgICAgICAgIHRodW1icy5hbmltYXRlKHtzY3JvbGxMZWZ0OnNjcm9sbFBvc30sIDIwMCk7CgogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGFuaW1hdGVkKTsKICAgICAgICAgICAgICAgIGFuaW1hdGVkID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIGFuaW1hdGVkID0gbnVsbDsKICAgICAgICAgICAgICAgIH0sIDIwMCk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBtb3ZlIHRoZSBzdHJpcGUgbGVmdCBvciByaWdodCBhY2NvcmRpbmcgdG8gbW91c2UgcG9zaXRpb24KICAgICAgICAgICAgbW92ZSA6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICAgICAgLy8gZG9uJ3QgbW92ZSBhbnl0aGluZyB1bnRpbCBpbml0aWFsIG1vdmVtZW50IG9uICdtb3VzZWVudGVyJyBoYXMgZmluaXNoZWQKICAgICAgICAgICAgICAgIGlmKCBhbmltYXRlZCApIHJldHVybjsKCiAgICAgICAgICAgICAgICB2YXIgcmF0aW8gICAgID0gc2Nyb2xsV2lkdGggLyBjb250YWluZXJXaWR0aCwKICAgICAgICAgICAgICAgICAgICBzdHJpcGVQb3MgPSBlLnBhZ2VYIC0gcGFkZGluZyAtIHBvc0Zyb21MZWZ0LCAvLyB0aGUgbW91c2UgWCBwb3NpdGlvbiwgIm5vcm1hbGl6ZWQiIHRvIHRoZSBjYXJvdXNlbCBwb3NpdGlvbgogICAgICAgICAgICAgICAgICAgIHBvcywgc2Nyb2xsUG9zOwoKICAgICAgICAgICAgICAgIGlmKCBzdHJpcGVQb3MgPCAwKSBzdHJpcGVQb3MgPSAwOyAvLwoKICAgICAgICAgICAgICAgIHBvcyA9IHN0cmlwZVBvcyAvIChjb250YWluZXJXaWR0aCAtIHBhZGRpbmcqMik7IC8vIGNhbGN1bGF0ZWQgcG9zaXRpb24gYmV0d2VlbiAwIHRvIDEKICAgICAgICAgICAgICAgIC8vIGNhbGN1bGF0ZSB0aGUgcGVyY2VudGFnZSBvZiB0aGUgbW91c2UgcG9zaXRpb24gd2l0aGluIHRoZSBjYXJvdXNlbAogICAgICAgICAgICAgICAgc2Nyb2xsUG9zID0gKHNjcm9sbFdpZHRoIC0gY29udGFpbmVyV2lkdGggKSAqIHBvczsKCiAgICAgICAgICAgICAgICByYWYoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICBlbC5zY3JvbGxMZWZ0ID0gc2Nyb2xsUG9zOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSgpOwoKICAgIC8vIEF1dG9wbGF5IGNvbnRyb2xsZXIKICAgIEFQQ29udHJvbCA9IHsKICAgICAgICBhdXRvUGxheVRpbWVyIDogZmFsc2UsCiAgICAgICAgcGxheSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIEFQQ29udHJvbC5hdXRvUGxheVRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpeyBjaGFuZ2VJbWFnZShuZXh0SW1hZ2UpIH0sIG9wdGlvbnMudGltZSk7CiAgICAgICAgICAgIEFQQ29udHJvbC5wcm9ncmVzcy5zdGFydCgpOwogICAgICAgICAgICBhdXRvcGxheUJ0bi5yZW1vdmVDbGFzcygncGxheScpOwogICAgICAgICAgICBBUENvbnRyb2wuc2V0VGl0bGUoJ0NsaWNrIHRvIHN0b3AgYXV0b3BsYXknKTsKICAgICAgICAgICAgb3B0aW9ucy5hdXRvcGxheSA9IHRydWU7CiAgICAgICAgfSwKICAgICAgICBwYXVzZSA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGNsZWFyVGltZW91dChBUENvbnRyb2wuYXV0b1BsYXlUaW1lcik7CiAgICAgICAgICAgIEFQQ29udHJvbC5wcm9ncmVzcy5yZXNldCgpOwogICAgICAgICAgICBhdXRvcGxheUJ0bi5hZGRDbGFzcygncGxheScpOwogICAgICAgICAgICBBUENvbnRyb2wuc2V0VGl0bGUoJ0NsaWNrIHRvIHJlc3VtZSBhdXRvcGxheScpOwogICAgICAgICAgICBvcHRpb25zLmF1dG9wbGF5ID0gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICBwcm9ncmVzcyA6IHsKICAgICAgICAgICAgcmVzZXQgOiBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgYXV0b3BsYXlCdG4uZmluZCgnZGl2JykucmVtb3ZlQXR0cignc3R5bGUnKTsKICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsgYXV0b3BsYXlCdG4ucmVtb3ZlQ2xhc3MoJ3BsYXlpbmcnKSB9LDIwMCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0YXJ0IDogZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIGlmKCAhaXNPbGRJRSkKICAgICAgICAgICAgICAgICAgICBhdXRvcGxheUJ0bi5maW5kKCdkaXYnKS5jc3ModHJhbnNpdGlvbiwgb3B0aW9ucy50aW1lKydtcycpOwogICAgICAgICAgICAgICAgYXV0b3BsYXlCdG4uYWRkQ2xhc3MoJ3BsYXlpbmcnKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLy8gc2V0cyB0aGUgYnV0dG9uIFRpdGxlIHByb3BlcnR5CiAgICAgICAgc2V0VGl0bGUgOiBmdW5jdGlvbih0ZXh0KXsKICAgICAgICAgICAgaWYodGV4dCkKICAgICAgICAgICAgICAgIGF1dG9wbGF5QnRuLnByb3AoJ3RpdGxlJywgdGV4dCArICcgKGV2ZXJ5ICcgKyBvcHRpb25zLnRpbWUvMTAwMCArICcgc2Vjb25kcyknICk7CiAgICAgICAgfSwKICAgICAgICAvLyB0aGUgYnV0dG9uIG9uQ2xpY2sgaGFuZGxlcgogICAgICAgIHRvZ2dsZSA6IGZ1bmN0aW9uKGUpewogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICBBUENvbnRyb2xbIG9wdGlvbnMuYXV0b3BsYXkgPyAncGF1c2UnIDogJ3BsYXknXSgpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBnZXRQcmVmaXhlZChwcm9wKXsKICAgICAgICB2YXIgaSwgcyA9IGRvYy5jcmVhdGVFbGVtZW50KCdwJykuc3R5bGUsIHYgPSBbJ21zJywnTycsJ01veicsJ1dlYmtpdCddOwogICAgICAgIGlmKCBzW3Byb3BdID09ICcnICkgcmV0dXJuIHByb3A7CiAgICAgICAgcHJvcCA9IHByb3AuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnNsaWNlKDEpOwogICAgICAgIGZvciggaSA9IHYubGVuZ3RoOyBpLS07ICkKICAgICAgICAgICAgaWYoIHNbdltpXSArIHByb3BdID09ICcnICkKICAgICAgICAgICAgICAgIHJldHVybiAodltpXSArIHByb3ApOwogICAgfQoKICAgIGZ1bmN0aW9uIGtleURvd24oZXZlbnQpewogICAgICAgIHZhciBjb2RlID0gZXZlbnQua2V5Q29kZSwgb2sgPSBvcHRpb25zLmtleXMsIHJlc3VsdDsKICAgICAgICAvLyBQcmV2ZW50IGRlZmF1bHQga2V5Ym9hcmQgYWN0aW9uIChsaWtlIG5hdmlnYXRpbmcgaW5zaWRlIHRoZSBwYWdlKQogICAgICAgIHJldHVybiBvay5jbG9zZS5pbmRleE9mKGNvZGUpID49IDAgJiYgY2xvc2UoKSB8fAogICAgICAgICAgICAgICBvay5uZXh0LmluZGV4T2YoY29kZSkgPj0gMCAmJiAhb3B0aW9ucy5zaW5nbGUgJiYgbG9vcGhvbGUobmV4dEltYWdlKSB8fAogICAgICAgICAgICAgICBvay5wcmV2LmluZGV4T2YoY29kZSkgPj0gMCAmJiAhb3B0aW9ucy5zaW5nbGUgJiYgbG9vcGhvbGUocHJldkltYWdlKSB8fCB0cnVlOwogICAgfQoKICAgIGZ1bmN0aW9uIHdoZWVsTmV4dFByZXYoZSwgZFksIGRYKXsKICAgICAgICBpZiggZFggPT0gMSApCiAgICAgICAgICAgIGxvb3Bob2xlKG5leHRJbWFnZSk7CiAgICAgICAgZWxzZSBpZiggZFggPT0gLTEgKQogICAgICAgICAgICBsb29waG9sZShwcmV2SW1hZ2UpOwogICAgfQoKCiAgICAvLyBzZXJ2ZXMgYXMgYSBjYWxsYmFjayBmb3IgcGJQcmV2QnRuIC8gcGJOZXh0QnRuIGJ1dHRvbnMgYnV0IGFsc28gaXMgY2FsbGVkIG9uIGtleXByZXNzIGV2ZW50cwogICAgZnVuY3Rpb24gbmV4dF9wcmV2KCl7CiAgICAgICAgLy8gZG9uJ3QgZ2V0IGNyYXp5IHdoZW4gdXNlciBjbGlja3MgbmV4dCBvciBwcmV2IGJ1dHRvbnMgcmFwaWRseQogICAgICAgIC8vaWYoICFpbWFnZS5oYXNDbGFzcygnem9vbWFibGUnKSApCiAgICAgICAgLy8gIHJldHVybiBmYWxzZTsKCiAgICAgICAgdmFyIGlkeCA9ICh0aGlzLmlkID09ICdwYlByZXZCdG4nKSA/IHByZXZJbWFnZSA6IG5leHRJbWFnZTsKCiAgICAgICAgbG9vcGhvbGUoaWR4KTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gdXBkYXRlSW5kZXhlcyhpZHgpewogICAgICAgIGxhc3RBY3RpdmUgPSBhY3RpdmVJbWFnZTsKICAgICAgICBhY3RpdmVJbWFnZSA9IGlkeDsKICAgICAgICBhY3RpdmVVUkwgPSBpbWFnZXNbaWR4XVswXTsKICAgICAgICBwcmV2SW1hZ2UgPSAoYWN0aXZlSW1hZ2UgfHwgKG9wdGlvbnMubG9vcCA/IGltYWdlcy5sZW5ndGggOiAwKSkgLSAxOwogICAgICAgIG5leHRJbWFnZSA9ICgoYWN0aXZlSW1hZ2UgKyAxKSAlIGltYWdlcy5sZW5ndGgpIHx8IChvcHRpb25zLmxvb3AgPyAwIDogLTEpOwogICAgfQoKICAgIC8vIGNoZWNrIGlmIGxvb3BpbmcgaXMgYWxsb3dlZCBiZWZvcmUgY2hhbmdpbmcgaW1hZ2UvdmlkZW8uCiAgICAvLyBBIHByZS1jaGFuZ2VJbWFnZSBmdW5jdGlvbiwgb25seSBmb3IgbGluZWFyIGNoYW5nZXMKICAgIGZ1bmN0aW9uIGxvb3Bob2xlKGlkeCl7CiAgICAgICAgaWYoICFvcHRpb25zLmxvb3AgKXsKICAgICAgICAgICAgdmFyIGFmdGVyTGFzdCA9IGFjdGl2ZUltYWdlID09IGltYWdlcy5sZW5ndGgtMSAmJiBpZHggPT0gbmV4dEltYWdlLAogICAgICAgICAgICAgICAgYmVmb3JlRmlyc3QgPSBhY3RpdmVJbWFnZSA9PSAwICYmIGlkeCA9PSBwcmV2SW1hZ2U7CgogICAgICAgICAgICBpZiggYWZ0ZXJMYXN0IHx8IGJlZm9yZUZpcnN0ICkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNoYW5nZUltYWdlKGlkeCk7CiAgICB9CgogICAgZnVuY3Rpb24gY2hhbmdlSW1hZ2UoaW1hZ2VJbmRleCwgZmlyc3RUaW1lLCB0aHVtYkNsaWNrKXsKICAgICAgICBpZiggIWltYWdlSW5kZXggfHwgaW1hZ2VJbmRleCA8IDAgKQogICAgICAgICAgICBpbWFnZUluZGV4ID0gMDsKCiAgICAgICAgLy8gaGlkZS9zaG93IG5leHQtcHJldiBidXR0b25zCiAgICAgICAgaWYoICFvcHRpb25zLmxvb3AgKXsKICAgICAgICAgICAgbmV4dEJ0blsgaW1hZ2VJbmRleCA9PSBpbWFnZXMubGVuZ3RoLTEgPyAnYWRkQ2xhc3MnIDogJ3JlbW92ZUNsYXNzJyBdKCdoaWRlJyk7CiAgICAgICAgICAgIHByZXZCdG5bIGltYWdlSW5kZXggPT0gMCA/ICdhZGRDbGFzcycgOiAncmVtb3ZlQ2xhc3MnIF0oJ2hpZGUnKTsKICAgICAgICB9CgogICAgICAgIC8vIGlmIHRoZXJlJ3MgYSBjYWxsYmFjayBmb3IgdGhpcyBwb2ludDoKICAgICAgICBpZiggdHlwZW9mIG9wdGlvbnMuYmVmb3JlU2hvdyA9PSAiZnVuY3Rpb24iKQogICAgICAgICAgICBvcHRpb25zLmJlZm9yZVNob3coaW1hZ2VMaW5rc1tpbWFnZUluZGV4XSk7CgogICAgICAgIG92ZXJsYXkucmVtb3ZlQ2xhc3MoJ2Vycm9yJykuYWRkQ2xhc3MoIGltYWdlSW5kZXggPiBhY3RpdmVJbWFnZSA/ICduZXh0JyA6ICdwcmV2JyApOwoKICAgICAgICB1cGRhdGVJbmRleGVzKGltYWdlSW5kZXgpOwoKICAgICAgICAvLyByZXNldCB0aGluZ3MKICAgICAgICBzdG9wKCk7CiAgICAgICAgdmlkZW8uZW1wdHkoKTsKICAgICAgICBwcmVsb2FkLm9uZXJyb3IgPSBudWxsOwogICAgICAgIGltYWdlLmFkZCh2aWRlbykuZGF0YSgnem9vbScsIDEpOwoKICAgICAgICBhY3RpdmVUeXBlID0gaW1hZ2VMaW5rc1tpbWFnZUluZGV4XS5yZWwgPT0gJ3ZpZGVvJyA/ICd2aWRlbycgOiAnaW1hZ2UnOwoKICAgICAgICAvLyBjaGVjayBpZiBjdXJyZW50IGxpbmsgaXMgYSB2aWRlbwogICAgICAgIGlmKCBhY3RpdmVUeXBlID09ICd2aWRlbycgKXsKICAgICAgICAgICAgdmlkZW8uaHRtbCggbmV3VmlkZW8oKSApLmFkZENsYXNzKCdoaWRlJyk7CiAgICAgICAgICAgIHNob3dDb250ZW50KGZpcnN0VGltZSk7CiAgICAgICAgfQogICAgICAgIGVsc2V7CiAgICAgICAgICAgIC8vIGdpdmUgYSB0aW55IGRlbGF5IHRvIHRoZSBwcmVsb2FkZXIsIHNvIGl0IHdvbid0IGJlIHNob3dlZCB3aGVuIGltYWdlcyBsb2FkIHZlcnkgcXVpY2tseQogICAgICAgICAgICB2YXIgbG9hZGVyVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXsgb3ZlcmxheS5hZGRDbGFzcygncGJMb2FkaW5nJyk7IH0sIDUwKTsKCiAgICAgICAgICAgIGlmKCBpc09sZElFICkgb3ZlcmxheS5hZGRDbGFzcygnaGlkZScpOyAvLyBzaG91bGQgd2FpdCBmb3IgdGhlIGltYWdlIG9ubG9hZC4ganVzdCBoaWRlIHRoZSBpbWFnZSB3aGlsZSBvbGQgSUUgZGlzcGxheSB0aGUgcHJlbG9hZGVyCgogICAgICAgICAgICBvcHRpb25zLmF1dG9wbGF5ICYmIEFQQ29udHJvbC5wcm9ncmVzcy5yZXNldCgpOwogICAgICAgICAgICBwcmVsb2FkID0gbmV3IEltYWdlKCk7CiAgICAgICAgICAgIHByZWxvYWQub25sb2FkID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIHByZWxvYWQub25sb2FkID0gbnVsbDsKCiAgICAgICAgICAgICAgICBpZiggcHJldkltYWdlID49IDAgKSBwcmVsb2FkUHJldi5zcmMgPSBpbWFnZXNbcHJldkltYWdlXVswXTsKICAgICAgICAgICAgICAgIGlmKCBuZXh0SW1hZ2UgPj0gMCApIHByZWxvYWROZXh0LnNyYyA9IGltYWdlc1tuZXh0SW1hZ2VdWzBdOwoKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChsb2FkZXJUaW1lb3V0KTsKICAgICAgICAgICAgICAgIHNob3dDb250ZW50KGZpcnN0VGltZSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHByZWxvYWQub25lcnJvciA9IGltYWdlRXJyb3I7CiAgICAgICAgICAgIHByZWxvYWQuc3JjID0gYWN0aXZlVVJMOwogICAgICAgIH0KCiAgICAgICAgLy8gU2hvdyBDYXB0aW9uIHRleHQKICAgICAgICBjYXB0aW9uVGV4dC5vbih0cmFuc2l0aW9uZW5kLCBjYXB0aW9uVGV4dENoYW5nZSkuYWRkQ2xhc3MoJ2NoYW5nZScpOwogICAgICAgIGlmKCBmaXJzdFRpbWUgfHwgaXNPbGRJRSApIGNhcHRpb25UZXh0Q2hhbmdlKCk7CgogICAgICAgIGlmKCBvcHRpb25zLnRodW1icyApCiAgICAgICAgICAgIHRodW1ic1N0cmlwZS5jaGFuZ2VBY3RpdmUoaW1hZ2VJbmRleCwgZmlyc3RUaW1lLCB0aHVtYkNsaWNrKTsKICAgICAgICAvLyBTYXZlIHVybCBoYXNoIGZvciBjdXJyZW50IGltYWdlCiAgICAgICAgaGlzdG9yeS5zYXZlKCk7CiAgICB9CgogICAgZnVuY3Rpb24gbmV3VmlkZW8oKXsKICAgICAgICB2YXIgdXJsID0gaW1hZ2VzW2FjdGl2ZUltYWdlXVswXSwKICAgICAgICAgICAgc2lnbiA9ICQoJzxhPicpLnByb3AoJ2hyZWYnLGltYWdlc1thY3RpdmVJbWFnZV1bMF0pWzBdLnNlYXJjaCA/ICcmJyA6ICc/JzsKICAgICAgICB1cmwgKz0gc2lnbiArICd2cT1oZDcyMCZ3bW9kZT1vcGFxdWUnOwogICAgICAgIHJldHVybiAkKCI8aWZyYW1lPiIpLnByb3AoeyBzY3JvbGxpbmc6J25vJywgZnJhbWVib3JkZXI6MCwgYWxsb3dUcmFuc3BhcmVuY3k6dHJ1ZSwgc3JjOnVybCB9KS5hdHRyKHt3ZWJraXRBbGxvd0Z1bGxTY3JlZW46dHJ1ZSwgbW96YWxsb3dmdWxsc2NyZWVuOnRydWUsIGFsbG93RnVsbFNjcmVlbjp0cnVlfSk7CiAgICB9CgogICAgLy8gc2hvdyB0aGUgaXRlbSdzIFRpdGxlICYgQ291bnRlcgogICAgZnVuY3Rpb24gY2FwdGlvblRleHRDaGFuZ2UoKXsKICAgICAgICBjYXB0aW9uVGV4dC5vZmYodHJhbnNpdGlvbmVuZCkucmVtb3ZlQ2xhc3MoJ2NoYW5nZScpOwogICAgICAgIC8vIGNoYW5nZSBjYXB0aW9uJ3MgdGV4dAogICAgICAgIGlmKCBvcHRpb25zLmNvdW50ZXIgKXsKICAgICAgICAgICAgdHJ5ewogICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gb3B0aW9ucy5jb3VudGVyLnJlcGxhY2UoJ0EnLCBhY3RpdmVJbWFnZSArIDEpLnJlcGxhY2UoJ0InLCBpbWFnZXMubGVuZ3RoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBpZiwgZm9yIHNvbWUgcmVhc29uLCB0aGUgYWJvdmUgaGFzIGZhaWxlZCBmcm9tIGEgYmFkICJjb3VudGVyIiB2YWx1ZSwgcmVzZXQgYW5kIHJldHJ5CiAgICAgICAgICAgIGNhdGNoKGVycil7CiAgICAgICAgICAgICAgICBvcHRpb25zLmNvdW50ZXIgPSAnKEEvQiknOwogICAgICAgICAgICAgICAgY2FwdGlvblRleHRDaGFuZ2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXB0aW9uLmZpbmQoJy5jb3VudGVyJykudGV4dCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGlmKCBvcHRpb25zLnRpdGxlICkKICAgICAgICAgICAgY2FwdGlvbi5maW5kKCcudGl0bGUnKS5odG1sKCc8c3Bhbj4nICsgaW1hZ2VzW2FjdGl2ZUltYWdlXVsxXSArICc8L3NwYW4+Jyk7CiAgICB9CgogICAgLy8gSGFuZGxlcyB0aGUgaGlzdG9yeSBzdGF0ZXMgd2hlbiBjaGFuZ2luZyBpbWFnZXMKICAgIHZhciBoaXN0b3J5ID0gewogICAgICAgIHNhdmUgOiBmdW5jdGlvbigpewogICAgICAgICAgICAvLyBvbmx5IHNhdmUgdG8gaGlzdG9yeSB1cmxzIHdoaWNoIGFyZSBub3QgYWxyZWFkeSBpbiB0aGUgaGFzaAogICAgICAgICAgICBpZigncHVzaFN0YXRlJyBpbiB3aW5kb3cuaGlzdG9yeSAmJiBkZWNvZGVVUklDb21wb25lbnQod2luZG93LmxvY2F0aW9uLmhhc2guc2xpY2UoMSkpICE9IGFjdGl2ZVVSTCAmJiBvcHRpb25zLmhpc3RvcnkgKXsKICAgICAgICAgICAgICAgIHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZSggJ3Bob3RvYm94JywgZG9jLnRpdGxlICsgJy0nICsgaW1hZ2VzW2FjdGl2ZUltYWdlXVsxXSwgd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lICsgd2luZG93LmxvY2F0aW9uLnNlYXJjaCArICcjJyArIGVuY29kZVVSSUNvbXBvbmVudChhY3RpdmVVUkwpICk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGxvYWQgOiBmdW5jdGlvbigpewogICAgICAgICAgICBpZiggb3B0aW9ucyAmJiAhb3B0aW9ucy5oaXN0b3J5ICkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB2YXIgaGFzaCA9IGRlY29kZVVSSUNvbXBvbmVudCggd2luZG93LmxvY2F0aW9uLmhhc2guc2xpY2UoMSkgKSwgaSwgajsKICAgICAgICAgICAgaWYoICFoYXNoICYmIG92ZXJsYXkuaGFzQ2xhc3MoJ3Nob3cnKSApCiAgICAgICAgICAgICAgICBjbG9zZSgpOwogICAgICAgIH0sCiAgICAgICAgY2xlYXIgOiBmdW5jdGlvbigpewogICAgICAgICAgICBpZiggb3B0aW9ucy5oaXN0b3J5ICYmICdwdXNoU3RhdGUnIGluIHdpbmRvdy5oaXN0b3J5ICkKICAgICAgICAgICAgICAgIHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZSgncGhvdG9ib3gnLCBkb2MudGl0bGUsIHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSArIHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gpOwogICAgICAgIH0KICAgIH07CgogICAgLy8gQWRkIFBob3RvYm94IHNwZWNpYWwgYG9ucG9wc3RhdGVgIHRvIHRoZSBgb25wb3BzdGF0ZWAgZnVuY3Rpb24KICAgIHdpbmRvdy5vbnBvcHN0YXRlID0gKGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGNhY2hlZCA9IHdpbmRvdy5vbnBvcHN0YXRlOwogICAgICAgIHJldHVybiBmdW5jdGlvbihldmVudCl7CiAgICAgICAgICAgIGNhY2hlZCAmJiBjYWNoZWQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgaWYoIGV2ZW50LnN0YXRlID09ICdwaG90b2JveCcgKQogICAgICAgICAgICAgICAgaGlzdG9yeS5sb2FkKCk7CiAgICAgICAgfQogICAgfSkoKTsKCiAgICAvLyBoYW5kbGVzIGFsbCBpbWFnZSBsb2FkaW5nIGVycm9yIChpZiBpbWFnZSBpcyBkZWFkKQogICAgZnVuY3Rpb24gaW1hZ2VFcnJvcigpewogICAgICAgIG92ZXJsYXkuYWRkQ2xhc3MoJ2Vycm9yJyk7CiAgICAgICAgaW1hZ2VbMF0uc3JjID0gYmxhbmtJbWc7IC8vIHNldCB0aGUgc291cmNlIHRvIGEgYmxhbmsgaW1hZ2UKICAgICAgICBwcmVsb2FkLm9uZXJyb3IgPSBudWxsOwogICAgfQoKICAgIC8vIFNob3dzIHRoZSBjb250ZW50IChpbWFnZS92aWRlbykgb24gdGhlIHNjcmVlbgogICAgZnVuY3Rpb24gc2hvd0NvbnRlbnQoZmlyc3RUaW1lKXsKICAgICAgICB2YXIgb3V0LCBzaG93U2FmdHlUaW1lcjsKICAgICAgICBzaG93U2FmdHlUaW1lciA9IHNldFRpbWVvdXQoc2hvdywgMjAwMCk7CgogICAgICAgIC8vIGhpZGVzIHRoZSBjdXJyZW50IGltYWdlIGFuZCBwcmVwYXJlIGdyb3VuZCBmb3IgYW4gaW1hZ2UgY2hhbmdlCiAgICAgICAgcGJMb2FkZXIuZmFkZU91dCgzMDAsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIG92ZXJsYXkucmVtb3ZlQ2xhc3MoInBiTG9hZGluZyIpOwogICAgICAgICAgICBwYkxvYWRlci5yZW1vdmVBdHRyKCdzdHlsZScpOwogICAgICAgIH0pOwogICAgICAgIG92ZXJsYXkuYWRkQ2xhc3MoJ2hpZGUnKTsKCiAgICAgICAgaW1hZ2UuYWRkKHZpZGVvKS5yZW1vdmVBdHRyKCdzdHlsZScpLnJlbW92ZUNsYXNzKCd6b29tYWJsZScpOyAvLyB3aGlsZSB0cmFuc2l0aW9uaW5nIGFuIGltYWdlLCBkbyBub3QgYXBwbHkgdGhlICd6b29tYWJsZScgY2xhc3MKCiAgICAgICAgLy8gY2hlY2sgd2hpY2ggZWxlbWVudCBuZWVkcyB0byB0cmFuc2l0aW9uLW91dDoKICAgICAgICBpZiggIWZpcnN0VGltZSAmJiBpbWFnZUxpbmtzW2xhc3RBY3RpdmVdLnJlbCA9PSAndmlkZW8nICl7CiAgICAgICAgICAgIG91dCA9IHZpZGVvOwogICAgICAgICAgICBpbWFnZS5hZGRDbGFzcygncHJlcGFyZScpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgICAgIG91dCA9IGltYWdlOwoKICAgICAgICBpZiggZmlyc3RUaW1lIHx8IGlzT2xkSUUgKQogICAgICAgICAgICBzaG93KCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICBvdXQub24odHJhbnNpdGlvbmVuZCwgc2hvdyk7CgogICAgICAgIC8vIGluIGNhc2UgdGhlICd0cmFuc2l0aW9uZW5kJyBkaWRuJ3QgZmlyZQogICAgICAgIC8vIGFmdGVyIGhpZGluZyB0aGUgbGFzdCBzZWVuIGltYWdlLCBzaG93IHRoZSBuZXcgb25lCiAgICAgICAgZnVuY3Rpb24gc2hvdygpewogICAgICAgICAgICBjbGVhclRpbWVvdXQoc2hvd1NhZnR5VGltZXIpOwogICAgICAgICAgICBvdXQub2ZmKHRyYW5zaXRpb25lbmQpLmNzcyh7J3RyYW5zaXRpb24nOidub25lJ30pOwogICAgICAgICAgICBvdmVybGF5LnJlbW92ZUNsYXNzKCd2aWRlbycpOwogICAgICAgICAgICBpZiggYWN0aXZlVHlwZSA9PSAndmlkZW8nICl7CiAgICAgICAgICAgICAgICBpbWFnZVswXS5zcmMgPSBibGFua0ltZzsKICAgICAgICAgICAgICAgIHZpZGVvLmFkZENsYXNzKCdwcmVwYXJlJyk7CiAgICAgICAgICAgICAgICBvdmVybGF5LmFkZENsYXNzKCd2aWRlbycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIGltYWdlLnByb3AoeyAnc3JjJzphY3RpdmVVUkwsICdjbGFzcyc6J3ByZXBhcmUnIH0pOwoKICAgICAgICAgICAgLy8gZmlsdGh5IGhhY2sgZm9yIHRoZSB0cmFuc2l0aW9uZW5kIGV2ZW50LCBidXQgY2Fubm90IHdvcmsgd2l0aG91dCBpdDoKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgaW1hZ2UuYWRkKHZpZGVvKS5yZW1vdmVBdHRyKCdzdHlsZScpLnJlbW92ZUNsYXNzKCdwcmVwYXJlJyk7CiAgICAgICAgICAgICAgICBvdmVybGF5LnJlbW92ZUNsYXNzKCdoaWRlIG5leHQgcHJldicpOwogICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIGltYWdlLmFkZCh2aWRlbykub24odHJhbnNpdGlvbmVuZCwgc2hvd0RvbmUpOwogICAgICAgICAgICAgICAgICAgIGlmKGlzT2xkSUUpIHNob3dEb25lKCk7IC8vIElFOSBhbmQgYmVsb3cgZG9uJ3Qgc3VwcG9ydCB0cmFuc2l0aW9uRW5kLi4uCiAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgfSw1MCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIGEgY2FsbGJhY2sgd2hlbmV2ZXIgYSB0cmFuc2l0aW9uIG9mIGFuIGltYWdlIG9yIGEgdmlkZW8gaXMgZG9uZQogICAgZnVuY3Rpb24gc2hvd0RvbmUoKXsKICAgICAgICBpbWFnZS5hZGQodmlkZW8pLm9mZih0cmFuc2l0aW9uZW5kKS5hZGRDbGFzcygnem9vbWFibGUnKTsKICAgICAgICBpZiggYWN0aXZlVHlwZSA9PSAndmlkZW8nICkKICAgICAgICAgICAgdmlkZW8ucmVtb3ZlQ2xhc3MoJ2hpZGUnKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIGF1dG9wbGF5QnRuICYmIG9wdGlvbnMuYXV0b3BsYXkgJiYgQVBDb250cm9sLnBsYXkoKTsKICAgICAgICBpZiggdHlwZW9mIHBob3RvYm94LmNhbGxiYWNrID09ICdmdW5jdGlvbicgKQogICAgICAgICAgICBwaG90b2JveC5jYWxsYmFjay5hcHBseShpbWFnZUxpbmtzW2FjdGl2ZUltYWdlXSk7CiAgICB9CgogICAgZnVuY3Rpb24gc2Nyb2xsWm9vbShlLCBkZWx0YVksIGRlbHRhWCl7CiAgICAgICAgaWYoIGRlbHRhWCApIHJldHVybiBmYWxzZTsKCiAgICAgICAgaWYoIGFjdGl2ZVR5cGUgPT0gJ3ZpZGVvJyApewogICAgICAgICAgICB2YXIgem9vbUxldmVsID0gdmlkZW8uZGF0YSgnem9vbScpIHx8IDE7CiAgICAgICAgICAgIHpvb21MZXZlbCArPSAoZGVsdGFZIC8gMTApOwogICAgICAgICAgICBpZiggem9vbUxldmVsIDwgMC41ICkKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCiAgICAgICAgICAgIHZpZGVvLmRhdGEoJ3pvb20nLCB6b29tTGV2ZWwpLmNzcyh7d2lkdGg6NjI0Knpvb21MZXZlbCwgaGVpZ2h0OjM1MSp6b29tTGV2ZWx9KTsKICAgICAgICB9CiAgICAgICAgZWxzZXsKICAgICAgICAgICAgdmFyIHpvb21MZXZlbCA9IGltYWdlLmRhdGEoJ3pvb20nKSB8fCAxLAogICAgICAgICAgICAgICAgZ2V0U2l6ZSA9IGltYWdlWzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKICAgICAgICAgICAgem9vbUxldmVsICs9IChkZWx0YVkgLyAxMCk7CgogICAgICAgICAgICBpZiggem9vbUxldmVsIDwgMC4xICkKICAgICAgICAgICAgICAgIHpvb21MZXZlbCA9IDAuMTsKCiAgICAgICAgICAgIHJhZihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGltYWdlLmRhdGEoJ3pvb20nLCB6b29tTGV2ZWwpLmNzcyh7J3RyYW5zZm9ybSc6J3NjYWxlKCcrIHpvb21MZXZlbCArJyknfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gY2hlY2sgaWYgaW1hZ2UgKGJ5IG1vdXNlKSBtb3ZlbWVudCBzaG91bGQgdGFrZSBlZmZlY3QgKGlmIGltYWdlIGlzIGxhcmdlciB0aGFuIHRoZSB3aW5kb3cKICAgICAgICAgICAgaWYoIGdldFNpemUuaGVpZ2h0ID4gZG9jRWxtLmNsaWVudEhlaWdodCB8fCBnZXRTaXplLndpZHRoID4gZG9jRWxtLmNsaWVudFdpZHRoICl7CiAgICAgICAgICAgICAgICAkKGRvYykub24oJ21vdXNlbW92ZS5waG90b2JveCcsIGltYWdlUmVwb3NpdGlvbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZXsKICAgICAgICAgICAgICAgICQoZG9jKS5vZmYoJ21vdXNlbW92ZS5waG90b2JveCcpOwogICAgICAgICAgICAgICAgaW1hZ2VbMF0uc3R5bGVbdHJhbnNmb3JtT3JpZ2luXSA9ICc1MCUgNTAlJzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZnVuY3Rpb24gdGh1bWJzUmVzaXplKGUsIGRlbHRhKXsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsgLy8gc3RvcCB0aGUgZXZlbnQgZnJvbSBidWJibGluZyB1cCB0byB0aGUgT3ZlcmxheSBhbmQgZW5sYXJnZSB0aGUgY29udGVudCBpdHNlbGYKICAgICAgICB2YXIgdGh1bWJMaXN0ID0gcGhvdG9ib3gudGh1bWJzTGlzdCwgaDsKICAgICAgICB0aHVtYkxpc3QuY3NzKCdoZWlnaHQnLCB0aHVtYkxpc3RbMF0uY2xpZW50SGVpZ2h0ICsgKGRlbHRhICogMTApICk7CiAgICAgICAgaCA9IGNhcHRpb25bMF0uY2xpZW50SGVpZ2h0IC8gMjsKICAgICAgICB3cmFwcGVyWzBdLnN0eWxlLmNzc1RleHQgPSAibWFyZ2luLXRvcDogLSIrIGggKyJweDsgcGFkZGluZzogIisgaCArInB4IDA7IjsKICAgICAgICB0aHVtYnMuaGlkZSgpLnNob3coMCk7CiAgICAgICAgLy90aHVtYnMudHJpZ2dlcignbW91c2VlbnRlcicpLnRyaWdnZXIoJ21vdXNlbW92ZScpOwogICAgfQoKICAgIC8vIG1vdmVzIHRoZSBpbWFnZSBhcm91bmQgZHVyaW5nIHpvb20gbW9kZSBvbiBtb3VzZW1vdmUgZXZlbnQKICAgIGZ1bmN0aW9uIGltYWdlUmVwb3NpdGlvbihlKXsKICAgICAgICB2YXIgeSA9IChlLmNsaWVudFkgLyBkb2NFbG0uY2xpZW50SGVpZ2h0KSAqIChkb2NFbG0uY2xpZW50SGVpZ2h0ICsgMjAwKSAtIDEwMCwgLy8gZXh0ZW5kIHRoZSByYW5nZSBvZiB0aGUgWSBheGlzIGJ5IDEwMCBlYWNoIHNpZGUKICAgICAgICAgICAgeURlbHRhID0geSAvIGRvY0VsbS5jbGllbnRIZWlnaHQgKiAxMDAsCiAgICAgICAgICAgIHhEZWx0YSA9IGUuY2xpZW50WCAvIGRvY0VsbS5jbGllbnRXaWR0aCAqIDEwMCwKICAgICAgICAgICAgb3JpZ2luID0geERlbHRhLnRvRml4ZWQoMikrJyUgJyArIHlEZWx0YS50b0ZpeGVkKDIpICsnJSc7CgogICAgICAgIHJhZihmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW1hZ2VbMF0uc3R5bGVbdHJhbnNmb3JtT3JpZ2luXSA9IG9yaWdpbjsKICAgICAgICB9KTsKICAgIH0KCiAgICBmdW5jdGlvbiBzdG9wKCl7CiAgICAgICAgY2xlYXJUaW1lb3V0KEFQQ29udHJvbC5hdXRvUGxheVRpbWVyKTsKICAgICAgICAkKGRvYykub2ZmKCdtb3VzZW1vdmUucGhvdG9ib3gnKTsKICAgICAgICBwcmVsb2FkLm9ubG9hZCA9IGZ1bmN0aW9uKCl7fTsKICAgICAgICBwcmVsb2FkLnNyYyA9IHByZWxvYWRQcmV2LnNyYyA9IHByZWxvYWROZXh0LnNyYyA9IGFjdGl2ZVVSTDsKICAgIH0KCiAgICBmdW5jdGlvbiBjbG9zZSgpewogICAgICAgICAgICBpZiggIW92ZXJsYXkuaGFzQ2xhc3MoJ3Nob3cnKSApCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgICAgICAgICBzdG9wKCk7CiAgICAgICAgICAgIHZpZGVvLmZpbmQoJ2lmcmFtZScpLnByb3AoJ3NyYycsJycpLmVtcHR5KCk7CiAgICAgICAgICAgIFBob3RvYm94LnByb3RvdHlwZS5zZXR1cCgpOwogICAgICAgICAgICBoaXN0b3J5LmNsZWFyKCk7CgogICAgICAgICAgICBvdmVybGF5LnJlbW92ZUNsYXNzKCdvbiB2aWRlbycpLmFkZENsYXNzKCdoaWRlJyk7CgogICAgICAgICAgICBpbWFnZS5vbih0cmFuc2l0aW9uZW5kLCBoaWRlKTsKICAgICAgICAgICAgaXNPbGRJRSAmJiBoaWRlKCk7CgogICAgICAgICAgICAvLyB0aGUgInBob3RvYm94IiBpbnN0YW5jZSBtaWdodCBiZSBuZWVkZWQgZm9yIGFzeW5jIHRyYW5zaXRpb25FbmQgZnVuY3Rpb25zLCBzbyBnaXZlIGl0IHNvbWUgdGltZSBiZWZvcmUgY2xlYXJpbmcgaXQKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgcGhvdG9ib3ggPSBudWxsOwogICAgICAgICAgICB9LDEwMDApOwoKICAgICAgICAgICAgZnVuY3Rpb24gaGlkZSgpewogICAgICAgICAgICAgICAgaWYoIG92ZXJsYXlbMF0uY2xhc3NOYW1lID09ICcnICkgcmV0dXJuOyAvLyBpZiBhbHJlYWR5IGhpZGRlbgogICAgICAgICAgICAgICAgb3ZlcmxheS5yZW1vdmVDbGFzcygnc2hvdyBoaWRlIGVycm9yIHBiTG9hZGluZycpOwogICAgICAgICAgICAgICAgaW1hZ2UucmVtb3ZlQXR0cignY2xhc3MnKS5yZW1vdmVBdHRyKCdzdHlsZScpLm9mZigpLmRhdGEoJ3pvb20nLDEpOwogICAgICAgICAgICAgICAgY2FwdGlvbi5maW5kKCcudGl0bGUnKS5lbXB0eSgpOwoKICAgICAgICAgICAgICAgIGlmKG5vUG9pbnRlckV2ZW50cykgLy8gcG9pbnRlci1ldmVudHMgbGFjayBzdXBwb3J0IGluIElFLCBzbyBqdXN0IGhpZGUgdGhlIG92ZXJsYXkKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7IG92ZXJsYXkuaGlkZSgpOyB9LCAyMDApOwoKICAgICAgICAgICAgICAgIG9wdGlvbnMuaGlkZUZsYXNoICYmICQoJ2lmcmFtZSwgb2JqZWN0LCBlbWJlZCcpLmNzcygndmlzaWJpbGl0eScsICd2aXNpYmxlJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGZhbGwtYmFjayBpZiB0aGUgJ3RyYW5zaXRpb25lbmQnIGV2ZW50IGRpZG4ndCBmaXJlCiAgICAgICAgICAgIHNldFRpbWVvdXQoaGlkZSwgNTAwKTsKICAgICAgICAgICAgLy8gY2FsbGJhY2sgYWZ0ZXIgY2xvc2luZyB0aGUgZ2FsbGVyeQogICAgICAgICAgICBpZiggdHlwZW9mIG9wdGlvbnMuYWZ0ZXJDbG9zZSA9PT0gJ2Z1bmN0aW9uJyApCiAgICAgICAgICAgICAgICBvcHRpb25zLmFmdGVyQ2xvc2Uob3ZlcmxheSk7CiAgICB9CgoKICAgIC8qKgogICAgKiBqUXVlcnkgUGx1Z2luIHRvIGFkZCBiYXNpYyAic3dpcGUiIHN1cHBvcnQgb24gdG91Y2gtZW5hYmxlZCBkZXZpY2VzCiAgICAqCiAgICAqIEBhdXRob3IgWWFpciBFdmVuIE9yCiAgICAqIEB2ZXJzaW9uIDEuMC4wIChNYXJjaCAyMCwgMjAxMykKICAgICovCiAgICAkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICQodGhpcykuYmluZCgndG91Y2hzdGFydCcsICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5oYW5kbGVyKTsKICAgICAgICB9LAoKICAgICAgICB0ZWFyZG93bjogZnVuY3Rpb24oKXsKICAgICAgICAgICAgJCh0aGlzKS51bmJpbmQoJ3RvdWNoc3RhcnQnLCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaGFuZGxlcik7CiAgICAgICAgfSwKCiAgICAgICAgaGFuZGxlcjogZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgICB2YXIgYXJncyA9IFtdLnNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLCAvLyBjbG9uZSBhcmd1bWVudHMgYXJyYXksIHJlbW92ZSBvcmlnaW5hbCBldmVudCBmcm9tIGNsb25lZCBhcnJheQogICAgICAgICAgICAgICAgdG91Y2hlcyA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcywKICAgICAgICAgICAgICAgIHN0YXJ0WCwgc3RhcnRZLAogICAgICAgICAgICAgICAgZGVsdGFYID0gMCwgZGVsdGFZID0gMCwKICAgICAgICAgICAgICAgIHRoYXQgPSB0aGlzOwoKICAgICAgICAgICAgZXZlbnQgPSAkLmV2ZW50LmZpeChldmVudCk7CgogICAgICAgICAgICBpZiggdG91Y2hlcy5sZW5ndGggPT0gMSApewogICAgICAgICAgICAgICAgc3RhcnRYID0gdG91Y2hlc1swXS5wYWdlWDsKICAgICAgICAgICAgICAgIHN0YXJ0WSA9IHRvdWNoZXNbMF0ucGFnZVk7CiAgICAgICAgICAgICAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIG9uVG91Y2hNb3ZlLCBmYWxzZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIGNhbmNlbFRvdWNoKCl7CiAgICAgICAgICAgICAgICB0aGF0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIG9uVG91Y2hNb3ZlKTsKICAgICAgICAgICAgICAgIHN0YXJ0WCA9IHN0YXJ0WSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZ1bmN0aW9uIG9uVG91Y2hNb3ZlKGUpewogICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgICAgIHZhciBEeCA9IHN0YXJ0WCAtIGUudG91Y2hlc1swXS5wYWdlWCwKICAgICAgICAgICAgICAgICAgICBEeSA9IHN0YXJ0WSAtIGUudG91Y2hlc1swXS5wYWdlWTsKCiAgICAgICAgICAgICAgICBpZiggTWF0aC5hYnMoRHgpID49IDIwICl7CiAgICAgICAgICAgICAgICAgICAgY2FuY2VsVG91Y2goKTsKICAgICAgICAgICAgICAgICAgICBkZWx0YVggPSAoRHggPiAwKSA/IC0xIDogMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYoIE1hdGguYWJzKER5KSA+PSAyMCApewogICAgICAgICAgICAgICAgICAgIGNhbmNlbFRvdWNoKCk7CiAgICAgICAgICAgICAgICAgICAgZGVsdGFZID0gKER5ID4gMCkgPyAxIDogLTE7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZXZlbnQudHlwZSA9ICdzd2lwZSc7CiAgICAgICAgICAgICAgICBhcmdzLnVuc2hpZnQoZXZlbnQsIGRlbHRhWCwgZGVsdGFZKTsgLy8gYWRkIGJhY2sgdGhlIG5ldyBldmVudCB0byB0aGUgZnJvbnQgb2YgdGhlIGFyZ3VtZW50cyB3aXRoIHRoZSBkZWxhdGFzCiAgICAgICAgICAgICAgICByZXR1cm4gKCQuZXZlbnQuZGlzcGF0Y2ggfHwgJC5ldmVudC5oYW5kbGUpLmFwcGx5KHRoYXQsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICAvKiEgQ29weXJpZ2h0IChjKSAyMDEzIEJyYW5kb24gQWFyb24gKGh0dHA6Ly9icmFuZG9uLmFhcm9uLnNoKQogICAgICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlIChMSUNFTlNFLnR4dCkuCiAgICAgKgogICAgICogVmVyc2lvbjogMy4xLjExCiAgICAgKgogICAgICogUmVxdWlyZXM6IGpRdWVyeSAxLjIuMisKICAgICAqLwogICAgIWZ1bmN0aW9uKGEpeyJmdW5jdGlvbiI9PXR5cGVvZiBkZWZpbmUmJmRlZmluZS5hbWQ/ZGVmaW5lKFsianF1ZXJ5Il0sYSk6Im9iamVjdCI9PXR5cGVvZiBleHBvcnRzP21vZHVsZS5leHBvcnRzPWE6YShqUXVlcnkpfShmdW5jdGlvbihhKXtmdW5jdGlvbiBiKGIpe3ZhciBnPWJ8fHdpbmRvdy5ldmVudCxoPWkuY2FsbChhcmd1bWVudHMsMSksaj0wLGw9MCxtPTAsbj0wLG89MCxwPTA7aWYoYj1hLmV2ZW50LmZpeChnKSxiLnR5cGU9Im1vdXNld2hlZWwiLCJkZXRhaWwiaW4gZyYmKG09LTEqZy5kZXRhaWwpLCJ3aGVlbERlbHRhImluIGcmJihtPWcud2hlZWxEZWx0YSksIndoZWVsRGVsdGFZImluIGcmJihtPWcud2hlZWxEZWx0YVkpLCJ3aGVlbERlbHRhWCJpbiBnJiYobD0tMSpnLndoZWVsRGVsdGFYKSwiYXhpcyJpbiBnJiZnLmF4aXM9PT1nLkhPUklaT05UQUxfQVhJUyYmKGw9LTEqbSxtPTApLGo9MD09PW0/bDptLCJkZWx0YVkiaW4gZyYmKG09LTEqZy5kZWx0YVksaj1tKSwiZGVsdGFYImluIGcmJihsPWcuZGVsdGFYLDA9PT1tJiYoaj0tMSpsKSksMCE9PW18fDAhPT1sKXtpZigxPT09Zy5kZWx0YU1vZGUpe3ZhciBxPWEuZGF0YSh0aGlzLCJtb3VzZXdoZWVsLWxpbmUtaGVpZ2h0Iik7aio9cSxtKj1xLGwqPXF9ZWxzZSBpZigyPT09Zy5kZWx0YU1vZGUpe3ZhciByPWEuZGF0YSh0aGlzLCJtb3VzZXdoZWVsLXBhZ2UtaGVpZ2h0Iik7aio9cixtKj1yLGwqPXJ9aWYobj1NYXRoLm1heChNYXRoLmFicyhtKSxNYXRoLmFicyhsKSksKCFmfHxmPm4pJiYoZj1uLGQoZyxuKSYmKGYvPTQwKSksZChnLG4pJiYoai89NDAsbC89NDAsbS89NDApLGo9TWF0aFtqPj0xPyJmbG9vciI6ImNlaWwiXShqL2YpLGw9TWF0aFtsPj0xPyJmbG9vciI6ImNlaWwiXShsL2YpLG09TWF0aFttPj0xPyJmbG9vciI6ImNlaWwiXShtL2YpLGsuc2V0dGluZ3Mubm9ybWFsaXplT2Zmc2V0JiZ0aGlzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCl7dmFyIHM9dGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtvPWIuY2xpZW50WC1zLmxlZnQscD1iLmNsaWVudFktcy50b3B9cmV0dXJuIGIuZGVsdGFYPWwsYi5kZWx0YVk9bSxiLmRlbHRhRmFjdG9yPWYsYi5vZmZzZXRYPW8sYi5vZmZzZXRZPXAsYi5kZWx0YU1vZGU9MCxoLnVuc2hpZnQoYixqLGwsbSksZSYmY2xlYXJUaW1lb3V0KGUpLGU9c2V0VGltZW91dChjLDIwMCksKGEuZXZlbnQuZGlzcGF0Y2h8fGEuZXZlbnQuaGFuZGxlKS5hcHBseSh0aGlzLGgpfX1mdW5jdGlvbiBjKCl7Zj1udWxsfWZ1bmN0aW9uIGQoYSxiKXtyZXR1cm4gay5zZXR0aW5ncy5hZGp1c3RPbGREZWx0YXMmJiJtb3VzZXdoZWVsIj09PWEudHlwZSYmYiUxMjA9PT0wfXZhciBlLGYsZz1bIndoZWVsIiwibW91c2V3aGVlbCIsIkRPTU1vdXNlU2Nyb2xsIiwiTW96TW91c2VQaXhlbFNjcm9sbCJdLGg9Im9ud2hlZWwiaW4gZG9jdW1lbnR8fGRvY3VtZW50LmRvY3VtZW50TW9kZT49OT9bIndoZWVsIl06WyJtb3VzZXdoZWVsIiwiRG9tTW91c2VTY3JvbGwiLCJNb3pNb3VzZVBpeGVsU2Nyb2xsIl0saT1BcnJheS5wcm90b3R5cGUuc2xpY2U7aWYoYS5ldmVudC5maXhIb29rcylmb3IodmFyIGo9Zy5sZW5ndGg7ajspYS5ldmVudC5maXhIb29rc1tnWy0tal1dPWEuZXZlbnQubW91c2VIb29rczt2YXIgaz1hLmV2ZW50LnNwZWNpYWwubW91c2V3aGVlbD17dmVyc2lvbjoiMy4xLjExIixzZXR1cDpmdW5jdGlvbigpe2lmKHRoaXMuYWRkRXZlbnRMaXN0ZW5lcilmb3IodmFyIGM9aC5sZW5ndGg7YzspdGhpcy5hZGRFdmVudExpc3RlbmVyKGhbLS1jXSxiLCExKTtlbHNlIHRoaXMub25tb3VzZXdoZWVsPWI7YS5kYXRhKHRoaXMsIm1vdXNld2hlZWwtbGluZS1oZWlnaHQiLGsuZ2V0TGluZUhlaWdodCh0aGlzKSksYS5kYXRhKHRoaXMsIm1vdXNld2hlZWwtcGFnZS1oZWlnaHQiLGsuZ2V0UGFnZUhlaWdodCh0aGlzKSl9LHRlYXJkb3duOmZ1bmN0aW9uKCl7aWYodGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKWZvcih2YXIgYz1oLmxlbmd0aDtjOyl0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoaFstLWNdLGIsITEpO2Vsc2UgdGhpcy5vbm1vdXNld2hlZWw9bnVsbDthLnJlbW92ZURhdGEodGhpcywibW91c2V3aGVlbC1saW5lLWhlaWdodCIpLGEucmVtb3ZlRGF0YSh0aGlzLCJtb3VzZXdoZWVsLXBhZ2UtaGVpZ2h0Iil9LGdldExpbmVIZWlnaHQ6ZnVuY3Rpb24oYil7dmFyIGM9YShiKVsib2Zmc2V0UGFyZW50ImluIGEuZm4/Im9mZnNldFBhcmVudCI6InBhcmVudCJdKCk7cmV0dXJuIGMubGVuZ3RofHwoYz1hKCJib2R5IikpLHBhcnNlSW50KGMuY3NzKCJmb250U2l6ZSIpLDEwKX0sZ2V0UGFnZUhlaWdodDpmdW5jdGlvbihiKXtyZXR1cm4gYShiKS5oZWlnaHQoKX0sc2V0dGluZ3M6e2FkanVzdE9sZERlbHRhczohMCxub3JtYWxpemVPZmZzZXQ6ITB9fTthLmZuLmV4dGVuZCh7bW91c2V3aGVlbDpmdW5jdGlvbihhKXtyZXR1cm4gYT90aGlzLmJpbmQoIm1vdXNld2hlZWwiLGEpOnRoaXMudHJpZ2dlcigibW91c2V3aGVlbCIpfSx1bm1vdXNld2hlZWw6ZnVuY3Rpb24oYSl7cmV0dXJuIHRoaXMudW5iaW5kKCJtb3VzZXdoZWVsIixhKX19KX0pOwoKICAgIC8vLy8vLy8vLy8vLy8vIE9OIERPQ1VNRU5UIFJFQURZIC8vLy8vLy8vLy8vLy8vLy8vCiAgICAkKGRvYykucmVhZHkocHJlcGFyZURPTSk7CgogICAgLy8gRXhwb3NlOgogICAgd2luZG93Ll9waG90b2JveCA9IHsKICAgICAgICBjbG9zZSAgICA6IGNsb3NlLAogICAgICAgIGhpc3RvcnkgIDogaGlzdG9yeSwKICAgICAgICBkZWZhdWx0cyA6IGRlZmF1bHRzCiAgICB9Owp9KShqUXVlcnksIGRvY3VtZW50LCB3aW5kb3cpOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 21:58:49 GMT",
                    "Content-Length": "43057",
                    "Date": "Fri, 07 Nov 2014 21:58:49 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}