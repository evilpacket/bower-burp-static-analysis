{
    "url": "http://localhost:9999/lhorie/mithril/archive/v0.1.12/mithril-tests.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location.pathname</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>element.href = location.pathname + modes[m.route.mode] + element.pathname</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/lhorie/mithril/archive/v0.1.12/mithril-tests.js",
                "path": "/lhorie/mithril/archive/v0.1.12/mithril-tests.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9saG9yaWUvbWl0aHJpbC9hcmNoaXZlL3YwLjEuMTIvbWl0aHJpbC10ZXN0cy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDQ3NjMNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMTY6MTI6MDYgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDE2OjEyOjA1IEdNVA0KDQpNaXRocmlsID0gbSA9IG5ldyBmdW5jdGlvbiBhcHAod2luZG93KSB7Cgl2YXIgc2VsZWN0b3JDYWNoZSA9IHt9Cgl2YXIgdHlwZSA9IHt9LnRvU3RyaW5nCgl2YXIgcGFyc2VyID0gLyg/OihefCN8XC4pKFteI1wuXFtcXV0rKSl8KFxbLis/XF0pL2csIGF0dHJQYXJzZXIgPSAvXFsoLis/KSg/Oj0oInwnfCkoLis/KVwyKT9cXS8KCQoJZnVuY3Rpb24gbSgpIHsKCQl2YXIgYXJncyA9IGFyZ3VtZW50cwoJCXZhciBoYXNBdHRycyA9IHR5cGUuY2FsbChhcmdzWzFdKSA9PSAiW29iamVjdCBPYmplY3RdIgoJCXZhciBhdHRycyA9IGhhc0F0dHJzID8gYXJnc1sxXSA6IHt9CgkJdmFyIGNsYXNzQXR0ck5hbWUgPSAiY2xhc3MiIGluIGF0dHJzID8gImNsYXNzIiA6ICJjbGFzc05hbWUiCgkJdmFyIGNlbGwgPSBzZWxlY3RvckNhY2hlW2FyZ3NbMF1dCgkJaWYgKGNlbGwgPT09IHVuZGVmaW5lZCkgewoJCQlzZWxlY3RvckNhY2hlW2FyZ3NbMF1dID0gY2VsbCA9IHt0YWc6ICJkaXYiLCBhdHRyczoge319CgkJCXZhciBtYXRjaCwgY2xhc3NlcyA9IFtdCgkJCXdoaWxlIChtYXRjaCA9IHBhcnNlci5leGVjKGFyZ3NbMF0pKSB7CgkJCQlpZiAobWF0Y2hbMV0gPT0gIiIpIGNlbGwudGFnID0gbWF0Y2hbMl0KCQkJCWVsc2UgaWYgKG1hdGNoWzFdID09ICIjIikgY2VsbC5hdHRycy5pZCA9IG1hdGNoWzJdCgkJCQllbHNlIGlmIChtYXRjaFsxXSA9PSAiLiIpIGNsYXNzZXMucHVzaChtYXRjaFsyXSkKCQkJCWVsc2UgaWYgKG1hdGNoWzNdWzBdID09ICJbIikgewoJCQkJCXZhciBwYWlyID0gYXR0clBhcnNlci5leGVjKG1hdGNoWzNdKQoJCQkJCWNlbGwuYXR0cnNbcGFpclsxXV0gPSBwYWlyWzNdIHx8IHRydWUKCQkJCX0KCQkJfQoJCQlpZiAoY2xhc3Nlcy5sZW5ndGggPiAwKSBjZWxsLmF0dHJzW2NsYXNzQXR0ck5hbWVdID0gY2xhc3Nlcy5qb2luKCIgIikKCQl9CgkJY2VsbCA9IGNsb25lKGNlbGwpCgkJY2VsbC5hdHRycyA9IGNsb25lKGNlbGwuYXR0cnMpCgkJY2VsbC5jaGlsZHJlbiA9IGhhc0F0dHJzID8gYXJnc1syXSA6IGFyZ3NbMV0KCQlmb3IgKHZhciBhdHRyTmFtZSBpbiBhdHRycykgewoJCQlpZiAoYXR0ck5hbWUgPT0gY2xhc3NBdHRyTmFtZSkgY2VsbC5hdHRyc1thdHRyTmFtZV0gPSAoY2VsbC5hdHRyc1thdHRyTmFtZV0gfHwgIiIpICsgIiAiICsgYXR0cnNbYXR0ck5hbWVdCgkJCWVsc2UgY2VsbC5hdHRyc1thdHRyTmFtZV0gPSBhdHRyc1thdHRyTmFtZV0KCQl9CgkJcmV0dXJuIGNlbGwKCX0KCWZ1bmN0aW9uIGJ1aWxkKHBhcmVudEVsZW1lbnQsIHBhcmVudFRhZywgZGF0YSwgY2FjaGVkLCBzaG91bGRSZWF0dGFjaCwgaW5kZXgsIGVkaXRhYmxlLCBuYW1lc3BhY2UpIHsKCQlpZiAoZGF0YSA9PT0gbnVsbCB8fCBkYXRhID09PSB1bmRlZmluZWQpIGRhdGEgPSAiIgoJCWlmIChkYXRhLnN1YnRyZWUgPT09ICJyZXRhaW4iKSByZXR1cm4KCQkKCQl2YXIgY2FjaGVkVHlwZSA9IHR5cGUuY2FsbChjYWNoZWQpLCBkYXRhVHlwZSA9IHR5cGUuY2FsbChkYXRhKQoJCWlmIChjYWNoZWRUeXBlICE9IGRhdGFUeXBlKSB7CgkJCWlmIChjYWNoZWQgIT09IG51bGwgJiYgY2FjaGVkICE9PSB1bmRlZmluZWQpIGNsZWFyKGNhY2hlZC5ub2RlcykKCQkJY2FjaGVkID0gbmV3IGRhdGEuY29uc3RydWN0b3IKCQkJY2FjaGVkLm5vZGVzID0gW10KCQl9CgkJCgkJaWYgKGRhdGFUeXBlID09ICJbb2JqZWN0IEFycmF5XSIpIHsKCQkJdmFyIG5vZGVzID0gW10sIGludGFjdCA9IGNhY2hlZC5sZW5ndGggPT09IGRhdGEubGVuZ3RoLCBzdWJBcnJheUNvdW50ID0gMAoJCQlmb3IgKHZhciBpID0gMCwgY2FjaGVDb3VudCA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCQl2YXIgaXRlbSA9IGJ1aWxkKHBhcmVudEVsZW1lbnQsIG51bGwsIGRhdGFbaV0sIGNhY2hlZFtjYWNoZUNvdW50XSwgc2hvdWxkUmVhdHRhY2gsIGluZGV4ICsgc3ViQXJyYXlDb3VudCB8fCBzdWJBcnJheUNvdW50LCBlZGl0YWJsZSwgbmFtZXNwYWNlKQoJCQkJaWYgKGl0ZW0gPT09IHVuZGVmaW5lZCkgY29udGludWUKCQkJCWlmICghaXRlbS5ub2Rlcy5pbnRhY3QpIGludGFjdCA9IGZhbHNlCgkJCQlzdWJBcnJheUNvdW50ICs9IGl0ZW0gaW5zdGFuY2VvZiBBcnJheSA/IGl0ZW0ubGVuZ3RoIDogMQoJCQkJY2FjaGVkW2NhY2hlQ291bnQrK10gPSBpdGVtCgkJCX0KCQkJaWYgKCFpbnRhY3QpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgaWYgKGNhY2hlZFtpXSAhPT0gdW5kZWZpbmVkKSBub2RlcyA9IG5vZGVzLmNvbmNhdChjYWNoZWRbaV0ubm9kZXMpCgkJCQlmb3IgKHZhciBpID0gbm9kZXMubGVuZ3RoLCBub2RlOyBub2RlID0gY2FjaGVkLm5vZGVzW2ldOyBpKyspIGlmIChub2RlLnBhcmVudE5vZGUgIT09IG51bGwpIG5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKQoJCQkJZm9yICh2YXIgaSA9IGNhY2hlZC5ub2Rlcy5sZW5ndGgsIG5vZGU7IG5vZGUgPSBub2Rlc1tpXTsgaSsrKSBpZiAobm9kZS5wYXJlbnROb2RlID09PSBudWxsKSBwYXJlbnRFbGVtZW50LmFwcGVuZENoaWxkKG5vZGUpCgkJCQlpZiAoZGF0YS5sZW5ndGggPCBjYWNoZWQubGVuZ3RoKSBjYWNoZWQubGVuZ3RoID0gZGF0YS5sZW5ndGgKCQkJCWNhY2hlZC5ub2RlcyA9IG5vZGVzCgkJCX0KCQl9CgkJZWxzZSBpZiAoZGF0YVR5cGUgPT0gIltvYmplY3QgT2JqZWN0XSIpIHsKCQkJaWYgKGRhdGEudGFnICE9IGNhY2hlZC50YWcgfHwgT2JqZWN0LmtleXMoZGF0YS5hdHRycykuam9pbigpICE9IE9iamVjdC5rZXlzKGNhY2hlZC5hdHRycykuam9pbigpIHx8IGRhdGEuYXR0cnMuaWQgIT0gY2FjaGVkLmF0dHJzLmlkKSBjbGVhcihjYWNoZWQubm9kZXMpCgkJCWlmICh0eXBlb2YgZGF0YS50YWcgIT0gInN0cmluZyIpIHJldHVybgoJCQkKCQkJdmFyIG5vZGUsIGlzTmV3ID0gY2FjaGVkLm5vZGVzLmxlbmd0aCA9PT0gMAoJCQlpZiAoZGF0YS50YWcgPT09ICJzdmciKSBuYW1lc3BhY2UgPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCgkJCWlmIChpc05ldykgewoJCQkJbm9kZSA9IG5hbWVzcGFjZSA9PT0gdW5kZWZpbmVkID8gd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoZGF0YS50YWcpIDogd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2UsIGRhdGEudGFnKQoJCQkJY2FjaGVkID0gewoJCQkJCXRhZzogZGF0YS50YWcsCgkJCQkJYXR0cnM6IHNldEF0dHJpYnV0ZXMobm9kZSwgZGF0YS50YWcsIGRhdGEuYXR0cnMsIHt9LCBuYW1lc3BhY2UpLAoJCQkJCWNoaWxkcmVuOiBidWlsZChub2RlLCBkYXRhLnRhZywgZGF0YS5jaGlsZHJlbiwgY2FjaGVkLmNoaWxkcmVuLCB0cnVlLCAwLCBkYXRhLmF0dHJzLmNvbnRlbnRlZGl0YWJsZSA/IG5vZGUgOiBlZGl0YWJsZSwgbmFtZXNwYWNlKSwKCQkJCQlub2RlczogW25vZGVdCgkJCQl9CgkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShub2RlLCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdIHx8IG51bGwpCgkJCX0KCQkJZWxzZSB7CgkJCQlub2RlID0gY2FjaGVkLm5vZGVzWzBdCgkJCQlzZXRBdHRyaWJ1dGVzKG5vZGUsIGRhdGEudGFnLCBkYXRhLmF0dHJzLCBjYWNoZWQuYXR0cnMsIG5hbWVzcGFjZSkKCQkJCWNhY2hlZC5jaGlsZHJlbiA9IGJ1aWxkKG5vZGUsIGRhdGEudGFnLCBkYXRhLmNoaWxkcmVuLCBjYWNoZWQuY2hpbGRyZW4sIGZhbHNlLCAwLCBkYXRhLmF0dHJzLmNvbnRlbnRlZGl0YWJsZSA/IG5vZGUgOiBlZGl0YWJsZSwgbmFtZXNwYWNlKQoJCQkJY2FjaGVkLm5vZGVzLmludGFjdCA9IHRydWUKCQkJCWlmIChzaG91bGRSZWF0dGFjaCA9PT0gdHJ1ZSkgcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUobm9kZSwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XSB8fCBudWxsKQoJCQl9CgkJCWlmICh0eXBlLmNhbGwoZGF0YS5hdHRyc1siY29uZmlnIl0pID09ICJbb2JqZWN0IEZ1bmN0aW9uXSIpIGRhdGEuYXR0cnNbImNvbmZpZyJdKG5vZGUsICFpc05ldykKCQl9CgkJZWxzZSB7CgkJCXZhciBub2RlCgkJCWlmIChjYWNoZWQubm9kZXMubGVuZ3RoID09PSAwKSB7CgkJCQlpZiAoZGF0YS4kdHJ1c3RlZCkgewoJCQkJCW5vZGUgPSBpbmplY3RIVE1MKHBhcmVudEVsZW1lbnQsIGluZGV4LCBkYXRhKQoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJbm9kZSA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShkYXRhKQoJCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJCX0KCQkJCWNhY2hlZCA9ICJzdHJpbmcgbnVtYmVyIGJvb2xlYW4iLmluZGV4T2YodHlwZW9mIGRhdGEpID4gLTEgPyBuZXcgZGF0YS5jb25zdHJ1Y3RvcihkYXRhKSA6IGRhdGEKCQkJCWNhY2hlZC5ub2RlcyA9IFtub2RlXQoJCQl9CgkJCWVsc2UgaWYgKGNhY2hlZC52YWx1ZU9mKCkgIT09IGRhdGEudmFsdWVPZigpIHx8IHNob3VsZFJlYXR0YWNoID09PSB0cnVlKSB7CgkJCQlpZiAoIWVkaXRhYmxlIHx8IGVkaXRhYmxlICE9PSB3aW5kb3cuZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkgewoJCQkJCWlmIChkYXRhLiR0cnVzdGVkKSB7CgkJCQkJCXZhciBjdXJyZW50ID0gY2FjaGVkLm5vZGVzWzBdLCBub2RlcyA9IFtjdXJyZW50XQoJCQkJCQlpZiAoY3VycmVudCkgewoJCQkJCQkJd2hpbGUgKGN1cnJlbnQgPSBjdXJyZW50Lm5leHRTaWJsaW5nKSBub2Rlcy5wdXNoKGN1cnJlbnQpCgkJCQkJCQljbGVhcihub2RlcykKCQkJCQkJCW5vZGUgPSBpbmplY3RIVE1MKHBhcmVudEVsZW1lbnQsIGluZGV4LCBkYXRhKQoJCQkJCQl9CgkJCQkJCWVsc2UgcGFyZW50RWxlbWVudC5pbm5lckhUTUwgPSBkYXRhCgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQlub2RlID0gY2FjaGVkLm5vZGVzWzBdCgkJCQkJCWlmIChwYXJlbnRUYWcgPT09ICJ0ZXh0YXJlYSIpIHBhcmVudEVsZW1lbnQudmFsdWUgPSBkYXRhCgkJCQkJCWVsc2UgaWYgKGVkaXRhYmxlKSBlZGl0YWJsZS5pbm5lckhUTUwgPSBkYXRhCgkJCQkJCWVsc2UgewoJCQkJCQkJcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUobm9kZSwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XSB8fCBudWxsKQoJCQkJCQkJbm9kZS5ub2RlVmFsdWUgPSBkYXRhCgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQljYWNoZWQgPSBuZXcgZGF0YS5jb25zdHJ1Y3RvcihkYXRhKQoJCQkJY2FjaGVkLm5vZGVzID0gW25vZGVdCgkJCX0KCQkJZWxzZSBjYWNoZWQubm9kZXMuaW50YWN0ID0gdHJ1ZQoJCX0KCQkKCQlyZXR1cm4gY2FjaGVkCgl9CglmdW5jdGlvbiBzZXRBdHRyaWJ1dGVzKG5vZGUsIHRhZywgZGF0YUF0dHJzLCBjYWNoZWRBdHRycywgbmFtZXNwYWNlKSB7CgkJZm9yICh2YXIgYXR0ck5hbWUgaW4gZGF0YUF0dHJzKSB7CgkJCXZhciBkYXRhQXR0ciA9IGRhdGFBdHRyc1thdHRyTmFtZV0KCQkJdmFyIGNhY2hlZEF0dHIgPSBjYWNoZWRBdHRyc1thdHRyTmFtZV0KCQkJaWYgKCEoYXR0ck5hbWUgaW4gY2FjaGVkQXR0cnMpIHx8IChjYWNoZWRBdHRyICE9PSBkYXRhQXR0cikgfHwgbm9kZSA9PT0gd2luZG93LmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpIHsKCQkJCWNhY2hlZEF0dHJzW2F0dHJOYW1lXSA9IGRhdGFBdHRyCgkJCQlpZiAoYXR0ck5hbWUgPT09ICJjb25maWciKSBjb250aW51ZQoJCQkJZWxzZSBpZiAodHlwZW9mIGRhdGFBdHRyID09ICJmdW5jdGlvbiIgJiYgYXR0ck5hbWUuaW5kZXhPZigib24iKSA9PSAwKSB7CgkJCQkJbm9kZVthdHRyTmFtZV0gPSBhdXRvcmVkcmF3KGRhdGFBdHRyLCBub2RlKQoJCQkJfQoJCQkJZWxzZSBpZiAoYXR0ck5hbWUgPT09ICJzdHlsZSIpIHsKCQkJCQlmb3IgKHZhciBydWxlIGluIGRhdGFBdHRyKSB7CgkJCQkJCWlmIChjYWNoZWRBdHRyID09PSB1bmRlZmluZWQgfHwgY2FjaGVkQXR0cltydWxlXSAhPT0gZGF0YUF0dHJbcnVsZV0pIG5vZGUuc3R5bGVbcnVsZV0gPSBkYXRhQXR0cltydWxlXQoJCQkJCX0KCQkJCX0KCQkJCWVsc2UgaWYgKG5hbWVzcGFjZSAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJaWYgKGF0dHJOYW1lID09PSAiaHJlZiIpIG5vZGUuc2V0QXR0cmlidXRlTlMoImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLCAiaHJlZiIsIGRhdGFBdHRyKQoJCQkJCWVsc2UgaWYgKGF0dHJOYW1lID09PSAiY2xhc3NOYW1lIikgbm9kZS5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgZGF0YUF0dHIpCgkJCQkJZWxzZSBub2RlLnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgZGF0YUF0dHIpCgkJCQl9CgkJCQllbHNlIGlmIChhdHRyTmFtZSA9PT0gInZhbHVlIiAmJiB0YWcgPT09ICJpbnB1dCIpIHsKCQkJCQlpZiAobm9kZS52YWx1ZSAhPT0gZGF0YUF0dHIpIG5vZGUudmFsdWUgPSBkYXRhQXR0cgoJCQkJfQoJCQkJZWxzZSBpZiAoYXR0ck5hbWUgaW4gbm9kZSAmJiBhdHRyTmFtZSAhPSAibGlzdCIpIG5vZGVbYXR0ck5hbWVdID0gZGF0YUF0dHIKCQkJCWVsc2Ugbm9kZS5zZXRBdHRyaWJ1dGUoYXR0ck5hbWUsIGRhdGFBdHRyKQoJCQl9CgkJfQoJCXJldHVybiBjYWNoZWRBdHRycwoJfQoJZnVuY3Rpb24gY2xlYXIobm9kZXMpIHsKCQlmb3IgKHZhciBpID0gbm9kZXMubGVuZ3RoIC0gMTsgaSA+IC0xOyBpLS0pIG5vZGVzW2ldLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZXNbaV0pCgkJbm9kZXMubGVuZ3RoID0gMAoJfQoJZnVuY3Rpb24gaW5qZWN0SFRNTChwYXJlbnRFbGVtZW50LCBpbmRleCwgZGF0YSkgewoJCXZhciBuZXh0U2libGluZyA9IHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0KCQlpZiAobmV4dFNpYmxpbmcpIG5leHRTaWJsaW5nLmluc2VydEFkamFjZW50SFRNTCgiYmVmb3JlYmVnaW4iLCBkYXRhKQoJCWVsc2UgcGFyZW50RWxlbWVudC5pbnNlcnRBZGphY2VudEhUTUwoImJlZm9yZWVuZCIsIGRhdGEpCgkJcmV0dXJuIG5leHRTaWJsaW5nID8gbmV4dFNpYmxpbmcucHJldmlvdXNTaWJsaW5nIDogcGFyZW50RWxlbWVudC5maXJzdENoaWxkCgl9CglmdW5jdGlvbiBjbG9uZShvYmplY3QpIHsKCQl2YXIgcmVzdWx0ID0ge30KCQlmb3IgKHZhciBwcm9wIGluIG9iamVjdCkgcmVzdWx0W3Byb3BdID0gb2JqZWN0W3Byb3BdCgkJcmV0dXJuIHJlc3VsdAoJfQoJZnVuY3Rpb24gYXV0b3JlZHJhdyhjYWxsYmFjaywgb2JqZWN0KSB7CgkJcmV0dXJuIGZ1bmN0aW9uKGUpIHsKCQkJbS5zdGFydENvbXB1dGF0aW9uKCkKCQkJdHJ5IHtyZXR1cm4gY2FsbGJhY2suY2FsbChvYmplY3QsIGUpfQoJCQlmaW5hbGx5IHttLmVuZENvbXB1dGF0aW9uKCl9CgkJfQoJfQoJCgl2YXIgaHRtbAoJdmFyIGRvY3VtZW50Tm9kZSA9IHsKCQlpbnNlcnRBZGphY2VudEhUTUw6IGZ1bmN0aW9uKF8sIGRhdGEpIHsKCQkJd2luZG93LmRvY3VtZW50LndyaXRlKGRhdGEpCgkJCXdpbmRvdy5kb2N1bWVudC5jbG9zZSgpCgkJfSwKCQlhcHBlbmRDaGlsZDogZnVuY3Rpb24obm9kZSkgewoJCQlpZiAoaHRtbCA9PT0gdW5kZWZpbmVkKSBodG1sID0gd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImh0bWwiKQoJCQlpZiAobm9kZS5ub2RlTmFtZSA9PSAiSFRNTCIpIGh0bWwgPSBub2RlCgkJCWVsc2UgaHRtbC5hcHBlbmRDaGlsZChub2RlKQoJCQlpZiAod2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAhPT0gaHRtbCkgewoJCQkJd2luZG93LmRvY3VtZW50LnJlcGxhY2VDaGlsZChodG1sLCB3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KQoJCQl9CgkJfSwKCQlpbnNlcnRCZWZvcmU6IGZ1bmN0aW9uKG5vZGUpIHsKCQkJdGhpcy5hcHBlbmRDaGlsZChub2RlKQoJCX0sCgkJY2hpbGROb2RlczogW10KCX0KCXZhciBub2RlQ2FjaGUgPSBbXSwgY2VsbENhY2hlID0ge30KCW0ucmVuZGVyID0gZnVuY3Rpb24ocm9vdCwgY2VsbCkgewoJCXZhciBpbmRleCA9IG5vZGVDYWNoZS5pbmRleE9mKHJvb3QpCgkJdmFyIGlkID0gaW5kZXggPCAwID8gbm9kZUNhY2hlLnB1c2gocm9vdCkgLSAxIDogaW5kZXgKCQl2YXIgbm9kZSA9IHJvb3QgPT0gd2luZG93LmRvY3VtZW50IHx8IHJvb3QgPT0gd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCA/IGRvY3VtZW50Tm9kZSA6IHJvb3QKCQljZWxsQ2FjaGVbaWRdID0gYnVpbGQobm9kZSwgbnVsbCwgY2VsbCwgY2VsbENhY2hlW2lkXSwgZmFsc2UsIDAsIG51bGwsIHVuZGVmaW5lZCkKCX0KCQoJbS50cnVzdCA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJdmFsdWUgPSBuZXcgU3RyaW5nKHZhbHVlKQoJCXZhbHVlLiR0cnVzdGVkID0gdHJ1ZQoJCXJldHVybiB2YWx1ZQoJfQoJCgl2YXIgcm9vdHMgPSBbXSwgbW9kdWxlcyA9IFtdLCBjb250cm9sbGVycyA9IFtdLCBub3cgPSAwLCBsYXN0UmVkcmF3ID0gMCwgbGFzdFJlZHJhd0lkID0gMCwgY29tcHV0ZVBvc3RSZWRyYXdIb29rID0gbnVsbAoJbS5tb2R1bGUgPSBmdW5jdGlvbihyb290LCBtb2R1bGUpIHsKCQltLnN0YXJ0Q29tcHV0YXRpb24oKQoJCXZhciBpbmRleCA9IHJvb3RzLmluZGV4T2Yocm9vdCkKCQlpZiAoaW5kZXggPCAwKSBpbmRleCA9IHJvb3RzLmxlbmd0aAoJCXJvb3RzW2luZGV4XSA9IHJvb3QKCQltb2R1bGVzW2luZGV4XSA9IG1vZHVsZQoJCWNvbnRyb2xsZXJzW2luZGV4XSA9IG5ldyBtb2R1bGUuY29udHJvbGxlcgoJCW0uZW5kQ29tcHV0YXRpb24oKQoJfQoJbS5yZWRyYXcgPSBmdW5jdGlvbigpIHsKCQlub3cgPSB3aW5kb3cucGVyZm9ybWFuY2UgJiYgd2luZG93LnBlcmZvcm1hbmNlLm5vdyA/IHdpbmRvdy5wZXJmb3JtYW5jZS5ub3coKSA6IG5ldyB3aW5kb3cuRGF0ZSgpLmdldFRpbWUoKQoJCWlmIChub3cgLSBsYXN0UmVkcmF3ID4gMTYpIHJlZHJhdygpCgkJZWxzZSB7CgkJCXZhciBjYW5jZWwgPSB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwgd2luZG93LmNsZWFyVGltZW91dAoJCQl2YXIgZGVmZXIgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8IHdpbmRvdy5zZXRUaW1lb3V0CgkJCWNhbmNlbChsYXN0UmVkcmF3SWQpCgkJCWxhc3RSZWRyYXdJZCA9IGRlZmVyKHJlZHJhdywgMCkKCQl9Cgl9CglmdW5jdGlvbiByZWRyYXcoKSB7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCByb290cy5sZW5ndGg7IGkrKykgewoJCQltLnJlbmRlcihyb290c1tpXSwgbW9kdWxlc1tpXS52aWV3KGNvbnRyb2xsZXJzW2ldKSkKCQl9CgkJaWYgKGNvbXB1dGVQb3N0UmVkcmF3SG9vaykgewoJCQljb21wdXRlUG9zdFJlZHJhd0hvb2soKQoJCQljb21wdXRlUG9zdFJlZHJhd0hvb2sgPSBudWxsCgkJfQoJCWxhc3RSZWRyYXcgPSBub3cKCX0KCQoJdmFyIHBlbmRpbmdSZXF1ZXN0cyA9IDAKCW0uc3RhcnRDb21wdXRhdGlvbiA9IGZ1bmN0aW9uKCkge3BlbmRpbmdSZXF1ZXN0cysrfQoJbS5lbmRDb21wdXRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXBlbmRpbmdSZXF1ZXN0cyA9IE1hdGgubWF4KHBlbmRpbmdSZXF1ZXN0cyAtIDEsIDApCgkJaWYgKHBlbmRpbmdSZXF1ZXN0cyA9PSAwKSBtLnJlZHJhdygpCgl9CgkKCW0ud2l0aEF0dHIgPSBmdW5jdGlvbihwcm9wLCB3aXRoQXR0ckNhbGxiYWNrKSB7CgkJcmV0dXJuIGZ1bmN0aW9uKGUpIHt3aXRoQXR0ckNhbGxiYWNrKHByb3AgaW4gZS5jdXJyZW50VGFyZ2V0ID8gZS5jdXJyZW50VGFyZ2V0W3Byb3BdIDogZS5jdXJyZW50VGFyZ2V0LmdldEF0dHJpYnV0ZShwcm9wKSl9Cgl9CgkKCS8vcm91dGluZwoJdmFyIG1vZGVzID0ge3BhdGhuYW1lOiAiIiwgaGFzaDogIiMiLCBzZWFyY2g6ICI/In0KCXZhciByZWRpcmVjdCA9IGZ1bmN0aW9uKCkge30sIHJvdXRlUGFyYW1zID0ge30sIGN1cnJlbnRSb3V0ZQoJbS5yb3V0ZSA9IGZ1bmN0aW9uKCkgewoJCWlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSByZXR1cm4gY3VycmVudFJvdXRlCgkJZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMykgewoJCQljdXJyZW50Um91dGUgPSB3aW5kb3cubG9jYXRpb25bbS5yb3V0ZS5tb2RlXS5zbGljZShtb2Rlc1ttLnJvdXRlLm1vZGVdLmxlbmd0aCkKCQkJdmFyIHJvb3QgPSBhcmd1bWVudHNbMF0sIGRlZmF1bHRSb3V0ZSA9IGFyZ3VtZW50c1sxXSwgcm91dGVyID0gYXJndW1lbnRzWzJdCgkJCXJlZGlyZWN0ID0gZnVuY3Rpb24oc291cmNlKSB7CgkJCQl2YXIgcGF0aCA9IHNvdXJjZS5zbGljZShtb2Rlc1ttLnJvdXRlLm1vZGVdLmxlbmd0aCkKCQkJCWlmICghcm91dGVCeVZhbHVlKHJvb3QsIHJvdXRlciwgcGF0aCkpIHsKCQkJCQltLnJvdXRlKGRlZmF1bHRSb3V0ZSwgdHJ1ZSkKCQkJCX0KCQkJfQoJCQl2YXIgbGlzdGVuZXIgPSBtLnJvdXRlLm1vZGUgPT0gImhhc2giID8gIm9uaGFzaGNoYW5nZSIgOiAib25wb3BzdGF0ZSIKCQkJd2luZG93W2xpc3RlbmVyXSA9IGZ1bmN0aW9uKCkgewoJCQkJcmVkaXJlY3Qod2luZG93LmxvY2F0aW9uW20ucm91dGUubW9kZV0pCgkJCX0KCQkJY29tcHV0ZVBvc3RSZWRyYXdIb29rID0gc2Nyb2xsVG9IYXNoCgkJCXdpbmRvd1tsaXN0ZW5lcl0oKQoJCX0KCQllbHNlIGlmIChhcmd1bWVudHNbMF0uYWRkRXZlbnRMaXN0ZW5lcikgewoJCQl2YXIgZWxlbWVudCA9IGFyZ3VtZW50c1swXQoJCQl2YXIgaXNJbml0aWFsaXplZCA9IGFyZ3VtZW50c1sxXQoJCQlpZiAoZWxlbWVudC5ocmVmLmluZGV4T2YobW9kZXNbbS5yb3V0ZS5tb2RlXSkgPCAwKSB7CgkJCQllbGVtZW50LmhyZWYgPSBsb2NhdGlvbi5wYXRobmFtZSArIG1vZGVzW20ucm91dGUubW9kZV0gKyBlbGVtZW50LnBhdGhuYW1lCgkJCX0KCQkJaWYgKCFpc0luaXRpYWxpemVkKSB7CgkJCQllbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoImNsaWNrIiwgcm91dGVVbm9idHJ1c2l2ZSkKCQkJCWVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCByb3V0ZVVub2J0cnVzaXZlKQoJCQl9CgkJfQoJCWVsc2UgaWYgKHR5cGVvZiBhcmd1bWVudHNbMF0gPT0gInN0cmluZyIpIHsKCQkJY3VycmVudFJvdXRlID0gYXJndW1lbnRzWzBdCgkJCXZhciBzaG91bGRSZXBsYWNlSGlzdG9yeUVudHJ5ID0gYXJndW1lbnRzWzFdID09PSB0cnVlCgkJCWlmICh3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUpIHsKCQkJCWNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IGZ1bmN0aW9uKCkgewoJCQkJCXdpbmRvdy5oaXN0b3J5W3Nob3VsZFJlcGxhY2VIaXN0b3J5RW50cnkgPyAicmVwbGFjZVN0YXRlIiA6ICJwdXNoU3RhdGUiXShudWxsLCB3aW5kb3cuZG9jdW1lbnQudGl0bGUsIG1vZGVzW20ucm91dGUubW9kZV0gKyBjdXJyZW50Um91dGUpCgkJCQkJc2Nyb2xsVG9IYXNoKCkKCQkJCX0KCQkJCXJlZGlyZWN0KG1vZGVzW20ucm91dGUubW9kZV0gKyBjdXJyZW50Um91dGUpCgkJCX0KCQkJZWxzZSB3aW5kb3cubG9jYXRpb25bbS5yb3V0ZS5tb2RlXSA9IGN1cnJlbnRSb3V0ZQoJCX0KCX0KCW0ucm91dGUucGFyYW0gPSBmdW5jdGlvbihrZXkpIHtyZXR1cm4gcm91dGVQYXJhbXNba2V5XX0KCW0ucm91dGUubW9kZSA9ICJzZWFyY2giCglmdW5jdGlvbiByb3V0ZUJ5VmFsdWUocm9vdCwgcm91dGVyLCBwYXRoKSB7CgkJcm91dGVQYXJhbXMgPSB7fQoJCWZvciAodmFyIHJvdXRlIGluIHJvdXRlcikgewoJCQlpZiAocm91dGUgPT0gcGF0aCkgcmV0dXJuICF2b2lkIG0ubW9kdWxlKHJvb3QsIHJvdXRlcltyb3V0ZV0pCgkJCQoJCQl2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoIl4iICsgcm91dGUucmVwbGFjZSgvOlteXC9dKz9cLnszfS9nLCAiKC4qPykiKS5yZXBsYWNlKC86W15cL10rL2csICIoW15cXC9dKykiKSArICIkIikKCQkJCgkJCWlmIChtYXRjaGVyLnRlc3QocGF0aCkpIHsKCQkJCXJldHVybiAhdm9pZCBwYXRoLnJlcGxhY2UobWF0Y2hlciwgZnVuY3Rpb24oKSB7CgkJCQkJdmFyIGtleXMgPSByb3V0ZS5tYXRjaCgvOlteXC9dKy9nKQoJCQkJCXZhciB2YWx1ZXMgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSwgLTIpCgkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSByb3V0ZVBhcmFtc1trZXlzW2ldLnJlcGxhY2UoLzp8XC4vZywgIiIpXSA9IGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZXNbaV0pCgkJCQkJbS5tb2R1bGUocm9vdCwgcm91dGVyW3JvdXRlXSkKCQkJCX0pCgkJCX0KCQl9Cgl9CglmdW5jdGlvbiByb3V0ZVVub2J0cnVzaXZlKGUpIHsKCQlpZiAoZS5jdHJsS2V5IHx8IGUubWV0YUtleSB8fCBlLndoaWNoID09IDIpIHJldHVybgoJCWUucHJldmVudERlZmF1bHQoKQoJCW0ucm91dGUoZS5jdXJyZW50VGFyZ2V0W20ucm91dGUubW9kZV0uc2xpY2UobW9kZXNbbS5yb3V0ZS5tb2RlXS5sZW5ndGgpKQoJfQoJZnVuY3Rpb24gc2Nyb2xsVG9IYXNoKCkgewoJCWlmIChtLnJvdXRlLm1vZGUgIT0gImhhc2giICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoKSB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoCgl9CgkKCS8vbW9kZWwKCW0ucHJvcCA9IGZ1bmN0aW9uKHN0b3JlKSB7CgkJdmFyIHByb3AgPSBmdW5jdGlvbigpIHsKCQkJaWYgKGFyZ3VtZW50cy5sZW5ndGgpIHN0b3JlID0gYXJndW1lbnRzWzBdCgkJCXJldHVybiBzdG9yZQoJCX0KCQlwcm9wLnRvSlNPTiA9IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc3RvcmUKCQl9CgkJcmV0dXJuIHByb3AKCX0KCgltLmRlZmVycmVkID0gZnVuY3Rpb24oKSB7CgkJdmFyIHJlc29sdmVycyA9IFtdLCByZWplY3RlcnMgPSBbXQoJCXZhciBvYmplY3QgPSB7CgkJCXJlc29sdmU6IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IHJlc29sdmVycy5sZW5ndGg7IGkrKykgcmVzb2x2ZXJzW2ldKHZhbHVlKQoJCQl9LAoJCQlyZWplY3Q6IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IHJlamVjdGVycy5sZW5ndGg7IGkrKykgcmVqZWN0ZXJzW2ldKHZhbHVlKQoJCQl9LAoJCQlwcm9taXNlOiBtLnByb3AoKQoJCX0KCQlvYmplY3QucHJvbWlzZS5yZXNvbHZlcnMgPSByZXNvbHZlcnMKCQlvYmplY3QucHJvbWlzZS50aGVuID0gZnVuY3Rpb24oc3VjY2VzcywgZXJyb3IpIHsKCQkJdmFyIG5leHQgPSBtLmRlZmVycmVkKCkKCQkJaWYgKCFzdWNjZXNzKSBzdWNjZXNzID0gaWRlbnRpdHkKCQkJaWYgKCFlcnJvcikgZXJyb3IgPSBpZGVudGl0eQoJCQlmdW5jdGlvbiBwdXNoKGxpc3QsIG1ldGhvZCwgY2FsbGJhY2spIHsKCQkJCWxpc3QucHVzaChmdW5jdGlvbih2YWx1ZSkgewoJCQkJCXRyeSB7CgkJCQkJCXZhciByZXN1bHQgPSBjYWxsYmFjayh2YWx1ZSkKCQkJCQkJaWYgKHJlc3VsdCAmJiB0eXBlb2YgcmVzdWx0LnRoZW4gPT0gImZ1bmN0aW9uIikgcmVzdWx0LnRoZW4obmV4dFttZXRob2RdLCBlcnJvcikKCQkJCQkJZWxzZSBuZXh0W21ldGhvZF0ocmVzdWx0ICE9PSB1bmRlZmluZWQgPyByZXN1bHQgOiB2YWx1ZSkKCQkJCQl9CgkJCQkJY2F0Y2ggKGUpIHsKCQkJCQkJaWYgKGUgaW5zdGFuY2VvZiBFcnJvciAmJiBlLmNvbnN0cnVjdG9yICE9PSBFcnJvcikgdGhyb3cgZQoJCQkJCQllbHNlIG5leHQucmVqZWN0KGUpCgkJCQkJfQoJCQkJfSkKCQkJfQoJCQlwdXNoKHJlc29sdmVycywgInJlc29sdmUiLCBzdWNjZXNzKQoJCQlwdXNoKHJlamVjdGVycywgInJlamVjdCIsIGVycm9yKQoJCQlyZXR1cm4gbmV4dC5wcm9taXNlCgkJfQoJCXJldHVybiBvYmplY3QKCX0KCW0uc3luYyA9IGZ1bmN0aW9uKGFyZ3MpIHsKCQl2YXIgbWV0aG9kID0gInJlc29sdmUiCgkJZnVuY3Rpb24gc3luY2hyb25pemVyKHJlc29sdmVkKSB7CgkJCXJldHVybiBmdW5jdGlvbih2YWx1ZSkgewoJCQkJcmVzdWx0cy5wdXNoKHZhbHVlKQoJCQkJaWYgKCFyZXNvbHZlZCkgbWV0aG9kID0gInJlamVjdCIKCQkJCWlmIChyZXN1bHRzLmxlbmd0aCA9PSBhcmdzLmxlbmd0aCkgewoJCQkJCWRlZmVycmVkLnByb21pc2UocmVzdWx0cykKCQkJCQlkZWZlcnJlZFttZXRob2RdKHJlc3VsdHMpCgkJCQl9CgkJCQlyZXR1cm4gdmFsdWUKCQkJfQoJCX0KCQkKCQl2YXIgZGVmZXJyZWQgPSBtLmRlZmVycmVkKCkKCQl2YXIgcmVzdWx0cyA9IFtdCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CgkJCWFyZ3NbaV0udGhlbihzeW5jaHJvbml6ZXIodHJ1ZSksIHN5bmNocm9uaXplcihmYWxzZSkpCgkJfQoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlCgl9CglmdW5jdGlvbiBpZGVudGl0eSh2YWx1ZSkge3JldHVybiB2YWx1ZX0KCglmdW5jdGlvbiBhamF4KG9wdGlvbnMpIHsKCQl2YXIgeGhyID0gd2luZG93LlhEb21haW5SZXF1ZXN0ID8gbmV3IHdpbmRvdy5YRG9tYWluUmVxdWVzdCA6IG5ldyB3aW5kb3cuWE1MSHR0cFJlcXVlc3QKCQl4aHIub3BlbihvcHRpb25zLm1ldGhvZCwgb3B0aW9ucy51cmwsIHRydWUsIG9wdGlvbnMudXNlciwgb3B0aW9ucy5wYXNzd29yZCkKCQl4aHIub25sb2FkID0gdHlwZW9mIG9wdGlvbnMub25sb2FkID09ICJmdW5jdGlvbiIgPyBvcHRpb25zLm9ubG9hZCA6IGZ1bmN0aW9uKCkge30KCQl4aHIub25lcnJvciA9IHR5cGVvZiBvcHRpb25zLm9uZXJyb3IgPT0gImZ1bmN0aW9uIiA/IG9wdGlvbnMub25lcnJvciA6IGZ1bmN0aW9uKCkge30KCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CgkJCWlmICh4aHIucmVhZHlTdGF0ZSA9PT0gNCAmJiB4aHIuc3RhdHVzID09PSAwKSB7CgkJCQl4aHIub25lcnJvcih7dHlwZTogImVycm9yIiwgdGFyZ2V0OiB4aHJ9KQoJCQl9CgkJfQoJCWlmICh0eXBlb2Ygb3B0aW9ucy5jb25maWcgPT0gImZ1bmN0aW9uIikgb3B0aW9ucy5jb25maWcoeGhyLCBvcHRpb25zKQoJCXhoci5zZW5kKG9wdGlvbnMuZGF0YSkKCQlyZXR1cm4geGhyCgl9CglmdW5jdGlvbiBxdWVyeXN0cmluZyhvYmplY3QsIHByZWZpeCkgewoJCXZhciBzdHIgPSBbXQoJCWZvcih2YXIgcHJvcCBpbiBvYmplY3QpIHsKCQkJdmFyIGtleSA9IHByZWZpeCA/IHByZWZpeCArICJbIiArIHByb3AgKyAiXSIgOiBwcm9wLCB2YWx1ZSA9IG9iamVjdFtwcm9wXQoJCQlzdHIucHVzaCh0eXBlb2YgdmFsdWUgPT0gIm9iamVjdCIgPyBxdWVyeXN0cmluZyh2YWx1ZSwga2V5KSA6IGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKSkKCQl9CgkJcmV0dXJuIHN0ci5qb2luKCImIikKCX0KCWZ1bmN0aW9uIGJpbmREYXRhKHhock9wdGlvbnMsIGRhdGEsIHNlcmlhbGl6ZSkgewoJCWlmIChkYXRhICYmIE9iamVjdC5rZXlzKGRhdGEpLmxlbmd0aCA+IDApIHsKCQkJaWYgKHhock9wdGlvbnMubWV0aG9kID09ICJHRVQiKSB7CgkJCQl4aHJPcHRpb25zLnVybCA9IHhock9wdGlvbnMudXJsICsgKHhock9wdGlvbnMudXJsLmluZGV4T2YoIj8iKSA8IDAgPyAiPyIgOiAiJiIpICsgcXVlcnlzdHJpbmcoZGF0YSkKCQkJfQoJCQllbHNlIHhock9wdGlvbnMuZGF0YSA9IHNlcmlhbGl6ZShkYXRhKQoJCX0KCQlyZXR1cm4geGhyT3B0aW9ucwoJfQoJZnVuY3Rpb24gcGFyYW1ldGVyaXplVXJsKHVybCwgZGF0YSkgewoJCXZhciB0b2tlbnMgPSB1cmwubWF0Y2goLzpbYS16XVx3Ky9naSkKCQlpZiAodG9rZW5zICYmIGRhdGEpIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspIHsKCQkJCXZhciBrZXkgPSB0b2tlbnNbaV0uc2xpY2UoMSkKCQkJCXVybCA9IHVybC5yZXBsYWNlKHRva2Vuc1tpXSwgZGF0YVtrZXldKQoJCQkJZGVsZXRlIGRhdGFba2V5XQoJCQl9CgkJfQoJCXJldHVybiB1cmwKCX0KCgltLnJlcXVlc3QgPSBmdW5jdGlvbih4aHJPcHRpb25zKSB7CgkJaWYgKHhock9wdGlvbnMuYmFja2dyb3VuZCAhPT0gdHJ1ZSkgbS5zdGFydENvbXB1dGF0aW9uKCkKCQl2YXIgZGVmZXJyZWQgPSBtLmRlZmVycmVkKCkKCQl2YXIgc2VyaWFsaXplID0geGhyT3B0aW9ucy5zZXJpYWxpemUgfHwgSlNPTi5zdHJpbmdpZnkKCQl2YXIgZGVzZXJpYWxpemUgPSB4aHJPcHRpb25zLmRlc2VyaWFsaXplIHx8IEpTT04ucGFyc2UKCQl2YXIgZXh0cmFjdCA9IHhock9wdGlvbnMuZXh0cmFjdCB8fCBmdW5jdGlvbih4aHIpIHsKCQkJcmV0dXJuIHhoci5yZXNwb25zZVRleHQubGVuZ3RoID09PSAwICYmIGRlc2VyaWFsaXplID09PSBKU09OLnBhcnNlID8gbnVsbCA6IHhoci5yZXNwb25zZVRleHQKCQl9CgkJeGhyT3B0aW9ucy51cmwgPSBwYXJhbWV0ZXJpemVVcmwoeGhyT3B0aW9ucy51cmwsIHhock9wdGlvbnMuZGF0YSkKCQl4aHJPcHRpb25zID0gYmluZERhdGEoeGhyT3B0aW9ucywgeGhyT3B0aW9ucy5kYXRhLCBzZXJpYWxpemUpCgkJeGhyT3B0aW9ucy5vbmxvYWQgPSB4aHJPcHRpb25zLm9uZXJyb3IgPSBmdW5jdGlvbihlKSB7CgkJCXZhciB1bndyYXAgPSAoZS50eXBlID09ICJsb2FkIiA/IHhock9wdGlvbnMudW53cmFwU3VjY2VzcyA6IHhock9wdGlvbnMudW53cmFwRXJyb3IpIHx8IGlkZW50aXR5CgkJCXZhciByZXNwb25zZSA9IHVud3JhcChkZXNlcmlhbGl6ZShleHRyYWN0KGUudGFyZ2V0LCB4aHJPcHRpb25zKSkpCgkJCWlmIChyZXNwb25zZSBpbnN0YW5jZW9mIEFycmF5ICYmIHhock9wdGlvbnMudHlwZSkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCByZXNwb25zZS5sZW5ndGg7IGkrKykgcmVzcG9uc2VbaV0gPSBuZXcgeGhyT3B0aW9ucy50eXBlKHJlc3BvbnNlW2ldKQoJCQl9CgkJCWVsc2UgaWYgKHhock9wdGlvbnMudHlwZSkgcmVzcG9uc2UgPSBuZXcgeGhyT3B0aW9ucy50eXBlKHJlc3BvbnNlKQoJCQlkZWZlcnJlZC5wcm9taXNlKHJlc3BvbnNlKQoJCQlkZWZlcnJlZFtlLnR5cGUgPT0gImxvYWQiID8gInJlc29sdmUiIDogInJlamVjdCJdKHJlc3BvbnNlKQoJCQlpZiAoeGhyT3B0aW9ucy5iYWNrZ3JvdW5kICE9PSB0cnVlKSBtLmVuZENvbXB1dGF0aW9uKCkKCQl9CgkJYWpheCh4aHJPcHRpb25zKQoJCWRlZmVycmVkLnByb21pc2UudGhlbiA9IHByb3BCaW5kZXIoZGVmZXJyZWQucHJvbWlzZSkKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZQoJfQoJZnVuY3Rpb24gcHJvcEJpbmRlcihwcm9taXNlKSB7CgkJdmFyIGJpbmQgPSBwcm9taXNlLnRoZW4KCQlyZXR1cm4gZnVuY3Rpb24oc3VjY2VzcywgZXJyb3IpIHsKCQkJdmFyIG5leHQgPSBiaW5kKGZ1bmN0aW9uKHZhbHVlKSB7cmV0dXJuIG5leHQoc3VjY2Vzcyh2YWx1ZSkpfSwgZnVuY3Rpb24odmFsdWUpIHtyZXR1cm4gbmV4dChlcnJvcih2YWx1ZSkpfSkKCQkJbmV4dC50aGVuID0gcHJvcEJpbmRlcihuZXh0KQoJCQlyZXR1cm4gbmV4dAoJCX0KCX0KCQoJLy90ZXN0aW5nIEFQSQoJbS5kZXBzID0gZnVuY3Rpb24obW9jaykge3JldHVybiB3aW5kb3cgPSBtb2NrfQoJLy9mb3IgaW50ZXJuYWwgdGVzdGluZyBvbmx5LCBkbyBub3QgdXNlIGBtLmRlcHMuZmFjdG9yeWAKCW0uZGVwcy5mYWN0b3J5ID0gYXBwCgkKCXJldHVybiBtCn0odGhpcykKCmlmICh0eXBlb2YgbW9kdWxlICE9ICJ1bmRlZmluZWQiICYmIG1vZHVsZSAhPT0gbnVsbCkgbW9kdWxlLmV4cG9ydHMgPSBtCmlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgZGVmaW5lKGZ1bmN0aW9uKCkge3JldHVybiBtfSkKCmZ1bmN0aW9uIHRlc3QoY29uZGl0aW9uKSB7Cgl0cnkge2lmICghY29uZGl0aW9uKCkpIHRocm93IG5ldyBFcnJvcn0KCWNhdGNoIChlKSB7Y29uc29sZS5lcnJvcihlKTt0ZXN0LmZhaWx1cmVzLnB1c2goY29uZGl0aW9uKX0KCXRlc3QudG90YWwrKwp9CnRlc3QudG90YWwgPSAwCnRlc3QuZmFpbHVyZXMgPSBbXQp0ZXN0LnByaW50ID0gZnVuY3Rpb24ocHJpbnQpIHsKCWZvciAodmFyIGkgPSAwOyBpIDwgdGVzdC5mYWlsdXJlcy5sZW5ndGg7IGkrKykgewoJCXByaW50KHRlc3QuZmFpbHVyZXNbaV0udG9TdHJpbmcoKSkKCX0KCXByaW50KCJ0ZXN0czogIiArIHRlc3QudG90YWwgKyAiXG5mYWlsdXJlczogIiArIHRlc3QuZmFpbHVyZXMubGVuZ3RoKQoJCglpZiAodGVzdC5mYWlsdXJlcy5sZW5ndGggPiAwKSB7CgkJdGhyb3cgbmV3IEVycm9yKHRlc3QuZmFpbHVyZXMubGVuZ3RoICsgIiB0ZXN0cyBkaWQgbm90IHBhc3MiKQoJfQp9Cgp2YXIgbW9jayA9IHt9Cm1vY2sud2luZG93ID0gbmV3IGZ1bmN0aW9uKCkgewoJdmFyIHdpbmRvdyA9IHt9Cgl3aW5kb3cuZG9jdW1lbnQgPSB7fQoJd2luZG93LmRvY3VtZW50LmNoaWxkTm9kZXMgPSBbXQoJd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgPSBmdW5jdGlvbih0YWcpIHsKCQlyZXR1cm4gewoJCQljaGlsZE5vZGVzOiBbXSwKCQkJbm9kZU5hbWU6IHRhZy50b1VwcGVyQ2FzZSgpLAoJCQlhcHBlbmRDaGlsZDogd2luZG93LmRvY3VtZW50LmFwcGVuZENoaWxkLAoJCQlyZW1vdmVDaGlsZDogd2luZG93LmRvY3VtZW50LnJlbW92ZUNoaWxkLAoJCQlyZXBsYWNlQ2hpbGQ6IHdpbmRvdy5kb2N1bWVudC5yZXBsYWNlQ2hpbGQsCgkJCWluc2VydEJlZm9yZTogZnVuY3Rpb24obm9kZSwgcmVmZXJlbmNlKSB7CgkJCQlub2RlLnBhcmVudE5vZGUgPSB0aGlzCgkJCQl2YXIgcmVmZXJlbmNlSW5kZXggPSB0aGlzLmNoaWxkTm9kZXMuaW5kZXhPZihyZWZlcmVuY2UpCgkJCQlpZiAocmVmZXJlbmNlSW5kZXggPCAwKSB0aGlzLmNoaWxkTm9kZXMucHVzaChub2RlKQoJCQkJZWxzZSB7CgkJCQkJdmFyIGluZGV4ID0gdGhpcy5jaGlsZE5vZGVzLmluZGV4T2Yobm9kZSkKCQkJCQl0aGlzLmNoaWxkTm9kZXMuc3BsaWNlKHJlZmVyZW5jZUluZGV4LCBpbmRleCA8IDAgPyAwIDogMSwgbm9kZSkKCQkJCX0KCQkJfSwKCQkJaW5zZXJ0QWRqYWNlbnRIVE1MOiBmdW5jdGlvbihwb3NpdGlvbiwgaHRtbCkgewoJCQkJLy90b2RvOiBhY2NlcHQgbWFya3VwCgkJCQlpZiAocG9zaXRpb24gPT0gImJlZm9yZWJlZ2luIikgewoJCQkJCXRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUod2luZG93LmRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGh0bWwpLCB0aGlzKQoJCQkJfQoJCQkJZWxzZSBpZiAocG9zaXRpb24gPT0gImJlZm9yZWVuZCIpIHsKCQkJCQl0aGlzLmFwcGVuZENoaWxkKHdpbmRvdy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShodG1sKSkKCQkJCX0KCQkJfSwKCQkJc2V0QXR0cmlidXRlOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewoJCQkJdGhpc1tuYW1lXSA9IHZhbHVlLnRvU3RyaW5nKCkKCQkJfSwKCQkJc2V0QXR0cmlidXRlTlM6IGZ1bmN0aW9uKG5hbWVzcGFjZSwgbmFtZSwgdmFsdWUpIHsKCQkJCXRoaXMubmFtZXNwYWNlVVJJID0gbmFtZXNwYWNlCgkJCQl0aGlzW25hbWVdID0gdmFsdWUudG9TdHJpbmcoKQoJCQl9LAoJCQlnZXRBdHRyaWJ1dGU6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CgkJCQlyZXR1cm4gdGhpc1tuYW1lXQoJCQl9CgkJfQoJfQoJd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyA9IGZ1bmN0aW9uKG5hbWVzcGFjZSwgdGFnKSB7CgkJdmFyIGVsZW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWcpCgkJZWxlbWVudC5uYW1lc3BhY2VVUkkgPSBuYW1lc3BhY2UKCQlyZXR1cm4gZWxlbWVudAoJfQoJd2luZG93LmRvY3VtZW50LmNyZWF0ZVRleHROb2RlID0gZnVuY3Rpb24odGV4dCkgewoJCXJldHVybiB7bm9kZVZhbHVlOiB0ZXh0LnRvU3RyaW5nKCl9Cgl9Cgl3aW5kb3cuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ID0gd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImh0bWwiKQoJd2luZG93LmRvY3VtZW50LnJlcGxhY2VDaGlsZCA9IGZ1bmN0aW9uKG5ld0NoaWxkLCBvbGRDaGlsZCkgewoJCXZhciBpbmRleCA9IHRoaXMuY2hpbGROb2Rlcy5pbmRleE9mKG9sZENoaWxkKQoJCWlmIChpbmRleCA+IC0xKSB0aGlzLmNoaWxkTm9kZXMuc3BsaWNlKGluZGV4LCAxLCBuZXdDaGlsZCkKCQllbHNlIHRoaXMuY2hpbGROb2Rlcy5wdXNoKG5ld0NoaWxkKQoJCW5ld0NoaWxkLnBhcmVudE5vZGUgPSB0aGlzCgkJb2xkQ2hpbGQucGFyZW50Tm9kZSA9IG51bGwKCX0KCXdpbmRvdy5kb2N1bWVudC5hcHBlbmRDaGlsZCA9IGZ1bmN0aW9uKGNoaWxkKSB7CgkJdmFyIGluZGV4ID0gdGhpcy5jaGlsZE5vZGVzLmluZGV4T2YoY2hpbGQpCgkJaWYgKGluZGV4ID4gLTEpIHRoaXMuY2hpbGROb2Rlcy5zcGxpY2UoaW5kZXgsIDEpCgkJdGhpcy5jaGlsZE5vZGVzLnB1c2goY2hpbGQpCgkJY2hpbGQucGFyZW50Tm9kZSA9IHRoaXMKCX0KCXdpbmRvdy5kb2N1bWVudC5yZW1vdmVDaGlsZCA9IGZ1bmN0aW9uKGNoaWxkKSB7CgkJdmFyIGluZGV4ID0gdGhpcy5jaGlsZE5vZGVzLmluZGV4T2YoY2hpbGQpCgkJdGhpcy5jaGlsZE5vZGVzLnNwbGljZShpbmRleCwgMSkKCQljaGlsZC5wYXJlbnROb2RlID0gbnVsbAoJfQoJd2luZG93LnBlcmZvcm1hbmNlID0gbmV3IGZ1bmN0aW9uICgpIHsKCQl2YXIgdGltZXN0YW1wID0gNTAKCQl0aGlzLiRlbGFwc2UgPSBmdW5jdGlvbihhbW91bnQpIHt0aW1lc3RhbXAgKz0gYW1vdW50fQoJCXRoaXMubm93ID0gZnVuY3Rpb24oKSB7cmV0dXJuIHRpbWVzdGFtcH0KCX0KCXdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IGZ1bmN0aW9uKCkge30KCXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSBmdW5jdGlvbihjYWxsYmFjaykge3dpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUuJGNhbGxiYWNrID0gY2FsbGJhY2t9Cgl3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lLiRyZXNvbHZlID0gZnVuY3Rpb24oKSB7CgkJaWYgKHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUuJGNhbGxiYWNrKSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lLiRjYWxsYmFjaygpCgkJd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZS4kY2FsbGJhY2sgPSBudWxsCgkJd2luZG93LnBlcmZvcm1hbmNlLiRlbGFwc2UoMjApCgl9Cgl3aW5kb3cuWE1MSHR0cFJlcXVlc3QgPSBuZXcgZnVuY3Rpb24oKSB7CgkJdmFyIHJlcXVlc3QgPSBmdW5jdGlvbigpIHsKCQkJdGhpcy5vcGVuID0gZnVuY3Rpb24obWV0aG9kLCB1cmwpIHsKCQkJCXRoaXMubWV0aG9kID0gbWV0aG9kCgkJCQl0aGlzLnVybCA9IHVybAoJCQl9CgkJCXRoaXMuc2VuZCA9IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5yZXNwb25zZVRleHQgPSBKU09OLnN0cmluZ2lmeSh0aGlzKQoJCQkJcmVxdWVzdC4kZXZlbnRzLnB1c2goe3R5cGU6ICJsb2FkIiwgdGFyZ2V0OiB0aGlzfSkKCQkJfQoJCX0KCQlyZXF1ZXN0LiRldmVudHMgPSBbXQoJCXJldHVybiByZXF1ZXN0Cgl9Cgl3aW5kb3cubG9jYXRpb24gPSB7c2VhcmNoOiAiIiwgcGF0aG5hbWU6ICIiLCBoYXNoOiAiIn0sCgl3aW5kb3cuaGlzdG9yeSA9IHt9Cgl3aW5kb3cuaGlzdG9yeS5wdXNoU3RhdGUgPSBmdW5jdGlvbihkYXRhLCB0aXRsZSwgdXJsKSB7CgkJd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gdXJsCgl9LAoJd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlID0gZnVuY3Rpb24oZGF0YSwgdGl0bGUsIHVybCkgewoJCXdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHVybAoJfQoJcmV0dXJuIHdpbmRvdwp9CmZ1bmN0aW9uIHRlc3RNaXRocmlsKG1vY2spIHsKCW0uZGVwcyhtb2NrKQoJCgkvL20KCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oImRpdiIpLnRhZyA9PT0gImRpdiJ9KQoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbSgiLmZvbyIpLnRhZyA9PT0gImRpdiJ9KQoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbSgiLmZvbyIpLmF0dHJzLmNsYXNzTmFtZSA9PT0gImZvbyJ9KQoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbSgiW3RpdGxlPWJhcl0iKS50YWcgPT09ICJkaXYifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oIlt0aXRsZT1iYXJdIikuYXR0cnMudGl0bGUgPT09ICJiYXIifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oIlt0aXRsZT1cJ2JhclwnXSIpLmF0dHJzLnRpdGxlID09PSAiYmFyIn0pCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJbdGl0bGU9XCJiYXJcIl0iKS5hdHRycy50aXRsZSA9PT0gImJhciJ9KQoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbSgiZGl2IiwgInRlc3QiKS5jaGlsZHJlbiA9PT0gInRlc3QifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oImRpdiIsIFsidGVzdCJdKS5jaGlsZHJlblswXSA9PT0gInRlc3QifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oImRpdiIsIHt0aXRsZTogImJhciJ9LCAidGVzdCIpLmF0dHJzLnRpdGxlID09PSAiYmFyIn0pCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJkaXYiLCB7dGl0bGU6ICJiYXIifSwgInRlc3QiKS5jaGlsZHJlbiA9PT0gInRlc3QifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oImRpdiIsIHt0aXRsZTogImJhciJ9LCBbInRlc3QiXSkuY2hpbGRyZW5bMF0gPT09ICJ0ZXN0In0pCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJkaXYiLCB7dGl0bGU6ICJiYXIifSwgbSgiZGl2IikpLmNoaWxkcmVuLnRhZyA9PT0gImRpdiJ9KQoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbSgiZGl2Iiwge3RpdGxlOiAiYmFyIn0sIFttKCJkaXYiKV0pLmNoaWxkcmVuWzBdLnRhZyA9PT0gImRpdiJ9KQoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbSgiZGl2IiwgWyJhIiwgImIiXSkuY2hpbGRyZW4ubGVuZ3RoID09PSAyfSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oImRpdiIsIFttKCJkaXYiKV0pLmNoaWxkcmVuWzBdLnRhZyA9PT0gImRpdiJ9KQoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbSgiZGl2IiwgbSgiZGl2IikpLmF0dHJzLnRhZyA9PT0gImRpdiJ9KSAvL3llcywgdGhpcyBpcyBleHBlY3RlZCBiZWhhdmlvcjogc2VlIG1ldGhvZCBzaWduYXR1cmUKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oImRpdiIsIFt1bmRlZmluZWRdKS50YWcgPT09ICJkaXYifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oImRpdiIsIFt7Zm9vOiAiYmFyIn1dKX0pIC8vYXMgbG9uZyBhcyBpdCBkb2Vzbid0IHRocm93IGVycm9ycywgaXQncyBmaW5lCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJzdmciLCBbbSgiZyIpXSl9KQoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbSgic3ZnIiwgW20oImFbaHJlZj0naHR0cDovL2dvb2dsZS5jb20nXSIpXSl9KQoKCS8vbS5tb2R1bGUKCXRlc3QoZnVuY3Rpb24oKSB7CgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKQoJCQoJCXZhciByb290MSA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLm1vZHVsZShyb290MSwgewoJCQljb250cm9sbGVyOiBmdW5jdGlvbigpIHt0aGlzLnZhbHVlID0gInRlc3QxIn0sCgkJCXZpZXc6IGZ1bmN0aW9uKGN0cmwpIHtyZXR1cm4gY3RybC52YWx1ZX0KCQl9KQoJCQoJCXZhciByb290MiA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLm1vZHVsZShyb290MiwgewoJCQljb250cm9sbGVyOiBmdW5jdGlvbigpIHt0aGlzLnZhbHVlID0gInRlc3QyIn0sCgkJCXZpZXc6IGZ1bmN0aW9uKGN0cmwpIHtyZXR1cm4gY3RybC52YWx1ZX0KCQl9KQoJCQoJCW1vY2sucmVxdWVzdEFuaW1hdGlvbkZyYW1lLiRyZXNvbHZlKCkKCQkKCQlyZXR1cm4gcm9vdDEuY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJ0ZXN0MSIgJiYgcm9vdDIuY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJ0ZXN0MiIKCX0pCgoJLy9tLndpdGhBdHRyCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciB2YWx1ZQoJCXZhciBoYW5kbGVyID0gbS53aXRoQXR0cigidGVzdCIsIGZ1bmN0aW9uKGRhdGEpIHt2YWx1ZSA9IGRhdGF9KQoJCWhhbmRsZXIoe2N1cnJlbnRUYXJnZXQ6IHt0ZXN0OiAiZm9vIn19KQoJCXJldHVybiB2YWx1ZSA9PT0gImZvbyIKCX0pCgoJLy9tLnRydXN0Cgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtLnRydXN0KCJ0ZXN0IikudmFsdWVPZigpID09PSAidGVzdCJ9KQoKCS8vbS5yZW5kZXIKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgInRlc3QiKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAidGVzdCIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oImRpdiIsIHtjbGFzczogImEifSkpCgkJdmFyIGVsZW1lbnRCZWZvcmUgPSByb290LmNoaWxkTm9kZXNbMF0KCQltLnJlbmRlcihyb290LCBtKCJkaXYiLCB7Y2xhc3M6ICJiIn0pKQoJCXZhciBlbGVtZW50QWZ0ZXIgPSByb290LmNoaWxkTm9kZXNbMF0KCQlyZXR1cm4gZWxlbWVudEJlZm9yZSA9PT0gZWxlbWVudEFmdGVyCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCIuYSIpKQoJCXZhciBlbGVtZW50QmVmb3JlID0gcm9vdC5jaGlsZE5vZGVzWzBdCgkJbS5yZW5kZXIocm9vdCwgbSgiLmIiKSkKCQl2YXIgZWxlbWVudEFmdGVyID0gcm9vdC5jaGlsZE5vZGVzWzBdCgkJcmV0dXJuIGVsZW1lbnRCZWZvcmUgPT09IGVsZW1lbnRBZnRlcgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgiZGl2Iiwge2lkOiAiYSJ9KSkKCQl2YXIgZWxlbWVudEJlZm9yZSA9IHJvb3QuY2hpbGROb2Rlc1swXQoJCW0ucmVuZGVyKHJvb3QsIG0oImRpdiIsIHt0aXRsZTogImIifSkpCgkJdmFyIGVsZW1lbnRBZnRlciA9IHJvb3QuY2hpbGROb2Rlc1swXQoJCXJldHVybiBlbGVtZW50QmVmb3JlICE9PSBlbGVtZW50QWZ0ZXIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNhIikpCgkJdmFyIGVsZW1lbnRCZWZvcmUgPSByb290LmNoaWxkTm9kZXNbMF0KCQltLnJlbmRlcihyb290LCBtKCJbdGl0bGU9Yl0iKSkKCQl2YXIgZWxlbWVudEFmdGVyID0gcm9vdC5jaGlsZE5vZGVzWzBdCgkJcmV0dXJuIGVsZW1lbnRCZWZvcmUgIT09IGVsZW1lbnRBZnRlcgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgiI2EiKSkKCQl2YXIgZWxlbWVudEJlZm9yZSA9IHJvb3QuY2hpbGROb2Rlc1swXQoJCW0ucmVuZGVyKHJvb3QsICJ0ZXN0IikKCQl2YXIgZWxlbWVudEFmdGVyID0gcm9vdC5jaGlsZE5vZGVzWzBdCgkJcmV0dXJuIGVsZW1lbnRCZWZvcmUgIT09IGVsZW1lbnRBZnRlcgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgiZGl2IiwgW3VuZGVmaW5lZF0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICIiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJzdmciLCBbbSgiZyIpXSkpCgkJdmFyIGcgPSByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXQoJCXJldHVybiBnLm5vZGVOYW1lID09PSAiRyIgJiYgZy5uYW1lc3BhY2VVUkkgPT0gImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgic3ZnIiwgW20oImFbaHJlZj0naHR0cDovL2dvb2dsZS5jb20nXSIpXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLm5vZGVOYW1lID09PSAiQSIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oImRpdi5jbGFzc25hbWUiLCBbbSgiYSIsIHtocmVmOiAiL2ZpcnN0In0pXSkpCgkJbS5yZW5kZXIocm9vdCwgbSgiZGl2IiwgW20oImEiLCB7aHJlZjogIi9zZWNvbmQifSldKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXMubGVuZ3RoID09IDEKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oInVsIiwgW20oImxpIildKSkKCQltLnJlbmRlcihyb290LCBtKCJ1bCIsIFttKCJsaSIpLCB1bmRlZmluZWRdKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMV0ubm9kZVZhbHVlID09PSAiIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgidWwiLCBbbSgibGkiKSwgbSgibGkiKV0pKQoJCW0ucmVuZGVyKHJvb3QsIG0oInVsIiwgW20oImxpIiksIHVuZGVmaW5lZF0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1sxXS5ub2RlVmFsdWUgPT09ICIiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJ1bCIsIFttKCJsaSIpXSkpCgkJbS5yZW5kZXIocm9vdCwgbSgidWwiLCBbdW5kZWZpbmVkXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gIiIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oInVsIiwgW20oImxpIildKSkKCQltLnJlbmRlcihyb290LCBtKCJ1bCIsIFt7fV0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlcy5sZW5ndGggPT09IDAKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oInVsIiwgW20oImxpIiwgW20oImEiKV0pXSkpCgkJbS5yZW5kZXIocm9vdCwgbSgidWwiLCBbe3N1YnRyZWU6ICJyZXRhaW4ifV0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLm5vZGVOYW1lID09PSAiQSIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy80MwoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oImEiLCB7Y29uZmlnOiBtLnJvdXRlfSwgInRlc3QiKSkKCQltLnJlbmRlcihyb290LCBtKCJhIiwge2NvbmZpZzogbS5yb3V0ZX0sICJ0ZXN0IikpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gInRlc3QiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvMjkKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQl2YXIgbGlzdCA9IFtmYWxzZSwgZmFsc2VdCgkJbS5yZW5kZXIocm9vdCwgbGlzdC5yZXZlcnNlKCkubWFwKGZ1bmN0aW9uKGZsYWcsIGluZGV4KSB7CgkJCXJldHVybiBtKCJpbnB1dFt0eXBlPWNoZWNrYm94XSIsIHtvbmNsaWNrOiBtLndpdGhBdHRyKCJjaGVja2VkIiwgZnVuY3Rpb24odmFsdWUpIHtsaXN0W2luZGV4XSA9IHZhbHVlfSksIGNoZWNrZWQ6IGZsYWd9KQoJCX0pKQoJCQoJCW1vY2suZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9IHJvb3QuY2hpbGROb2Rlc1swXQoJCXJvb3QuY2hpbGROb2Rlc1swXS5jaGVja2VkID0gdHJ1ZQoJCXJvb3QuY2hpbGROb2Rlc1swXS5vbmNsaWNrKHtjdXJyZW50VGFyZ2V0OiB7Y2hlY2tlZDogdHJ1ZX19KQoJCQoJCW0ucmVuZGVyKHJvb3QsIGxpc3QucmV2ZXJzZSgpLm1hcChmdW5jdGlvbihmbGFnLCBpbmRleCkgewoJCQlyZXR1cm4gbSgiaW5wdXRbdHlwZT1jaGVja2JveF0iLCB7b25jbGljazogbS53aXRoQXR0cigiY2hlY2tlZCIsIGZ1bmN0aW9uKHZhbHVlKSB7bGlzdFtpbmRleF0gPSB2YWx1ZX0pLCBjaGVja2VkOiBmbGFnfSkKCQl9KSkKCQkKCQltb2NrLmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPSBudWxsCgkJCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGVja2VkID09PSBmYWxzZSAmJiByb290LmNoaWxkTm9kZXNbMV0uY2hlY2tlZCA9PT0gdHJ1ZQoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzQ0ICgxKQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbbnVsbCwgbSgiI2JhciIpXSkpCgkJbS5yZW5kZXIocm9vdCwgbSgiI2ZvbyIsIFsidGVzdCIsIG0oIiNiYXIiKV0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJ0ZXN0IgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzQ0ICgyKQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbbnVsbCwgbSgiI2JhciIpXSkpCgkJbS5yZW5kZXIocm9vdCwgbSgiI2ZvbyIsIFttKCJkaXYiKSwgbSgiI2JhciIpXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLm5vZGVOYW1lID09PSAiRElWIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzQ0ICgzKQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbInRlc3QiLCBtKCIjYmFyIildKSkKCQltLnJlbmRlcihyb290LCBtKCIjZm9vIiwgW20oImRpdiIpLCBtKCIjYmFyIildKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0ubm9kZU5hbWUgPT09ICJESVYiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvNDQgKDQpCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgiI2ZvbyIsIFttKCJkaXYiKSwgbSgiI2JhciIpXSkpCgkJbS5yZW5kZXIocm9vdCwgbSgiI2ZvbyIsIFsidGVzdCIsIG0oIiNiYXIiKV0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJ0ZXN0IgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzQ0ICg1KQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbbSgiI2JhciIpXSkpCgkJbS5yZW5kZXIocm9vdCwgbSgiI2ZvbyIsIFttKCIjYmFyIiksIFttKCIjYmF6IildXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzFdLmlkID09PSAiYmF6IgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzQ4CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50CgkJbS5yZW5kZXIocm9vdCwgbSgiaHRtbCIsIFttKCIjZm9vIildKSkKCQl2YXIgcmVzdWx0ID0gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0uaWQgPT09ICJmb28iCgkJcm9vdC5jaGlsZE5vZGVzID0gW21vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaHRtbCIpXQoJCXJldHVybiByZXN1bHQKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy80OQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oImEiLCAidGVzdCIpKQoJCW0ucmVuZGVyKHJvb3QsIG0oImEuZm9vIiwgInRlc3QiKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAidGVzdCIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy80OQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oImEuZm9vIiwgInRlc3QiKSkKCQltLnJlbmRlcihyb290LCBtKCJhIiwgInRlc3QiKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAidGVzdCIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy80OQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oImEuZm9vIiwgInRlc3QiKSkKCQltLnJlbmRlcihyb290LCBtKCJhIiwgInRlc3QxIikpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gInRlc3QxIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzQ5CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgiYSIsICJ0ZXN0IikpCgkJbS5yZW5kZXIocm9vdCwgbSgiYSIsICJ0ZXN0MSIpKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJ0ZXN0MSIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy81MAoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbW20oImRpdiIsICJhIiksIG0oImRpdiIsICJiIildLCBtKCIjYmFyIildKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMV0uY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJiIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzUwCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgiI2ZvbyIsIFtbbSgiZGl2IiwgImEiKSwgbSgiZGl2IiwgImIiKV0sIG0oIiNiYXIiKV0pKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbW20oImRpdiIsICJhIiksIG0oImRpdiIsICJiIiksIG0oImRpdiIsICJjIildLCBtKCIjYmFyIildKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMl0uY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJjIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzUwCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgiI2ZvbyIsIFtbbSgiZGl2IiwgImEiKSwgbSgiZGl2IiwgImIiKV0sIFttKCJkaXYiLCAiYyIpLCBtKCJkaXYiLCAiZCIpXSwgbSgiI2JhciIpXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzNdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiZCIgJiYgcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbNF0uaWQgPT09ICJiYXIiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvNTAKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCIjZm9vIiwgW1ttKCJkaXYiLCAiYSIpLCBtKCJkaXYiLCAiYiIpXSwgInRlc3QiXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzFdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiYiIgJiYgcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMl0ubm9kZVZhbHVlID09PSAidGVzdCIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy81MAoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbWyJhIiwgImIiXSwgInRlc3QiXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzFdLm5vZGVWYWx1ZSA9PT0gImIiICYmIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzJdLm5vZGVWYWx1ZSA9PT0gInRlc3QiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvNTEKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJtYWluIiwgW20oImJ1dHRvbiIpLCBtKCJhcnRpY2xlIiwgW20oInNlY3Rpb24iKSwgbSgibmF2IildKV0pKQoJCW0ucmVuZGVyKHJvb3QsIG0oIm1haW4iLCBbbSgiYnV0dG9uIiksIG0oImFydGljbGUiLCBbbSgic3BhbiIpLCBtKCJuYXYiKV0pXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzFdLmNoaWxkTm9kZXNbMF0ubm9kZU5hbWUgPT09ICJTUEFOIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzUxCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgibWFpbiIsIFttKCJidXR0b24iKSwgbSgiYXJ0aWNsZSIsIFttKCJzZWN0aW9uIiksIG0oIm5hdiIpXSldKSkKCQltLnJlbmRlcihyb290LCBtKCJtYWluIiwgW20oImJ1dHRvbiIpLCBtKCJhcnRpY2xlIiwgWyJ0ZXN0IiwgbSgibmF2IildKV0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1sxXS5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gInRlc3QiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvNTEKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJtYWluIiwgW20oImJ1dHRvbiIpLCBtKCJhcnRpY2xlIiwgW20oInNlY3Rpb24iKSwgbSgibmF2IildKV0pKQoJCW0ucmVuZGVyKHJvb3QsIG0oIm1haW4iLCBbbSgiYnV0dG9uIiksIG0oImFydGljbGUiLCBbbS50cnVzdCgidGVzdCIpLCBtKCJuYXYiKV0pXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzFdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAidGVzdCIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy81NQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNhIikpCgkJdmFyIGVsZW1lbnRCZWZvcmUgPSByb290LmNoaWxkTm9kZXNbMF0KCQltLnJlbmRlcihyb290LCBtKCIjYiIpKQoJCXZhciBlbGVtZW50QWZ0ZXIgPSByb290LmNoaWxkTm9kZXNbMF0KCQlyZXR1cm4gZWxlbWVudEJlZm9yZSAhPT0gZWxlbWVudEFmdGVyCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvNTYKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBbbnVsbCwgImZvbyJdKQoJCW0ucmVuZGVyKHJvb3QsIFsiYmFyIl0pCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlcy5sZW5ndGggPT0gMQoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzU2CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgiZGl2IiwgImZvbyIpKQoJCXJldHVybiByb290LmNoaWxkTm9kZXMubGVuZ3RoID09IDEKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oImRpdiIsIFttKCJidXR0b24iKSwgbSgidWwiKV0pKQoJCXZhciB2YWx1ZUJlZm9yZSA9IHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLm5vZGVOYW1lCgkJbS5yZW5kZXIocm9vdCwgbSgiZGl2IiwgW3VuZGVmaW5lZCwgbSgidWwiKV0pKQoJCXZhciB2YWx1ZUFmdGVyID0gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlCgkJcmV0dXJuIHZhbHVlQmVmb3JlID09PSAiQlVUVE9OIiAmJiB2YWx1ZUFmdGVyID09PSAiIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgiZGl2IiwgW20oInVsIiksIHVuZGVmaW5lZF0pKQoJCXZhciB2YWx1ZUJlZm9yZTEgPSByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5ub2RlTmFtZQoJCXZhciB2YWx1ZUJlZm9yZTIgPSByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1sxXS5ub2RlVmFsdWUKCQltLnJlbmRlcihyb290LCBtKCJkaXYiLCBbdW5kZWZpbmVkLCBtKCJ1bCIpXSkpCgkJdmFyIHZhbHVlQWZ0ZXIxID0gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlCgkJdmFyIHZhbHVlQWZ0ZXIyID0gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMV0ubm9kZU5hbWUKCQlyZXR1cm4gdmFsdWVCZWZvcmUxID09PSAiVUwiICYmIHZhbHVlQWZ0ZXIxID09PSAiIiAmJiB2YWx1ZUJlZm9yZTIgPT09ICIiICYmIHZhbHVlQWZ0ZXIyID09PSAiVUwiCgl9KQoJLy9lbmQgbS5yZW5kZXIKCQoJLy9tLnJlZHJhdwoJdGVzdChmdW5jdGlvbigpIHsKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vc2V0dXAKCQl2YXIgY29udHJvbGxlcgoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ubW9kdWxlKHJvb3QsIHsKCQkJY29udHJvbGxlcjogZnVuY3Rpb24oKSB7Y29udHJvbGxlciA9IHRoaXN9LAoJCQl2aWV3OiBmdW5jdGlvbihjdHJsKSB7cmV0dXJuIGN0cmwudmFsdWV9CgkJfSkKCQljb250cm9sbGVyLnZhbHVlID0gImZvbyIKCQltLnJlZHJhdygpCgkJdmFyIHZhbHVlQmVmb3JlID0gcm9vdC5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkKCQltLnJlZHJhdygpCgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3RlYXJkb3duCgkJcmV0dXJuIHZhbHVlQmVmb3JlID09PSAiIiAmJiByb290LmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiZm9vIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3NldHVwCgkJdmFyIGNvdW50ID0gMAoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ubW9kdWxlKHJvb3QsIHsKCQkJY29udHJvbGxlcjogZnVuY3Rpb24oKSB7fSwKCQkJdmlldzogZnVuY3Rpb24oY3RybCkgewoJCQkJY291bnQrKwoJCQl9CgkJfSkKCQltLnJlZHJhdygpCgkJbS5yZWRyYXcoKQoJCW0ucmVkcmF3KCkKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApCgkJbS5yZWRyYXcoKQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy90ZWFyZG93bgoJCXJldHVybiBjb3VudCA9PT0gMgoJfSkKCgkvL20ucm91dGUKCXRlc3QoZnVuY3Rpb24oKSB7CgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3NldHVwCgkJbW9jay5sb2NhdGlvbi5zZWFyY2ggPSAiPyIKCQkKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJvdXRlLm1vZGUgPSAic2VhcmNoIgoJCW0ucm91dGUocm9vdCwgIi90ZXN0MSIsIHsKCQkJIi90ZXN0MSI6IHtjb250cm9sbGVyOiBmdW5jdGlvbigpIHt9LCB2aWV3OiBmdW5jdGlvbigpIHtyZXR1cm4gImZvbyJ9fQoJCX0pCgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3RlYXJkb3duCgkJcmV0dXJuIG1vY2subG9jYXRpb24uc2VhcmNoID09ICI/L3Rlc3QxIiAmJiByb290LmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiZm9vIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3NldHVwCgkJbW9jay5sb2NhdGlvbi5wYXRobmFtZSA9ICIvIgoJCQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucm91dGUubW9kZSA9ICJwYXRobmFtZSIKCQltLnJvdXRlKHJvb3QsICIvdGVzdDIiLCB7CgkJCSIvdGVzdDIiOiB7Y29udHJvbGxlcjogZnVuY3Rpb24oKSB7fSwgdmlldzogZnVuY3Rpb24oKSB7cmV0dXJuICJmb28ifX0KCQl9KQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy90ZWFyZG93bgoJCXJldHVybiBtb2NrLmxvY2F0aW9uLnBhdGhuYW1lID09ICIvdGVzdDIiICYmIHJvb3QuY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJmb28iCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vc2V0dXAKCQltb2NrLmxvY2F0aW9uLmhhc2ggPSAiIyIKCQkKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJvdXRlLm1vZGUgPSAiaGFzaCIKCQltLnJvdXRlKHJvb3QsICIvdGVzdDMiLCB7CgkJCSIvdGVzdDMiOiB7Y29udHJvbGxlcjogZnVuY3Rpb24oKSB7fSwgdmlldzogZnVuY3Rpb24oKSB7cmV0dXJuICJmb28ifX0KCQl9KQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy90ZWFyZG93bgoJCXJldHVybiBtb2NrLmxvY2F0aW9uLmhhc2ggPT0gIiMvdGVzdDMiICYmIHJvb3QuY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJmb28iCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vc2V0dXAKCQltb2NrLmxvY2F0aW9uLnNlYXJjaCA9ICI/IgoJCQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucm91dGUubW9kZSA9ICJzZWFyY2giCgkJbS5yb3V0ZShyb290LCAiL3Rlc3Q0L2ZvbyIsIHsKCQkJIi90ZXN0NC86dGVzdCI6IHtjb250cm9sbGVyOiBmdW5jdGlvbigpIHt9LCB2aWV3OiBmdW5jdGlvbigpIHtyZXR1cm4gbS5yb3V0ZS5wYXJhbSgidGVzdCIpfX0KCQl9KQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy90ZWFyZG93bgoJCXJldHVybiBtb2NrLmxvY2F0aW9uLnNlYXJjaCA9PSAiPy90ZXN0NC9mb28iICYmIHJvb3QuY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJmb28iCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vc2V0dXAKCQltb2NrLmxvY2F0aW9uLnNlYXJjaCA9ICI/IgoJCQoJCXZhciBtb2R1bGUgPSB7Y29udHJvbGxlcjogZnVuY3Rpb24oKSB7fSwgdmlldzogZnVuY3Rpb24oKSB7cmV0dXJuIG0ucm91dGUucGFyYW0oInRlc3QiKX19CgkJCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yb3V0ZS5tb2RlID0gInNlYXJjaCIKCQltLnJvdXRlKHJvb3QsICIvdGVzdDUvZm9vIiwgewoJCQkiLyI6IG1vZHVsZSwKCQkJIi90ZXN0NS86dGVzdCI6IG1vZHVsZQoJCX0pCgkJdmFyIHBhcmFtVmFsdWVCZWZvcmUgPSBtLnJvdXRlLnBhcmFtKCJ0ZXN0IikKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApCgkJbS5yb3V0ZSgiLyIpCgkJdmFyIHBhcmFtVmFsdWVBZnRlciA9IG0ucm91dGUucGFyYW0oInRlc3QiKQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy90ZWFyZG93bgoJCXJldHVybiBtb2NrLmxvY2F0aW9uLnNlYXJjaCA9PSAiPy8iICYmIHBhcmFtVmFsdWVCZWZvcmUgPT09ICJmb28iICYmIHBhcmFtVmFsdWVBZnRlciA9PT0gdW5kZWZpbmVkCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vc2V0dXAKCQltb2NrLmxvY2F0aW9uLnNlYXJjaCA9ICI/IgoJCQoJCXZhciBtb2R1bGUgPSB7Y29udHJvbGxlcjogZnVuY3Rpb24oKSB7fSwgdmlldzogZnVuY3Rpb24oKSB7cmV0dXJuIG0ucm91dGUucGFyYW0oImExIil9fQoJCQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucm91dGUubW9kZSA9ICJzZWFyY2giCgkJbS5yb3V0ZShyb290LCAiL3Rlc3Q2L2ZvbyIsIHsKCQkJIi8iOiBtb2R1bGUsCgkJCSIvdGVzdDYvOmExIjogbW9kdWxlCgkJfSkKCQl2YXIgcGFyYW1WYWx1ZUJlZm9yZSA9IG0ucm91dGUucGFyYW0oImExIikKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApCgkJbS5yb3V0ZSgiLyIpCgkJdmFyIHBhcmFtVmFsdWVBZnRlciA9IG0ucm91dGUucGFyYW0oImExIikKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vdGVhcmRvd24KCQlyZXR1cm4gbW9jay5sb2NhdGlvbi5zZWFyY2ggPT0gIj8vIiAmJiBwYXJhbVZhbHVlQmVmb3JlID09PSAiZm9vIiAmJiBwYXJhbVZhbHVlQWZ0ZXIgPT09IHVuZGVmaW5lZAoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzYxCgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3NldHVwCgkJbW9jay5sb2NhdGlvbi5zZWFyY2ggPSAiPyIKCQkKCQl2YXIgbW9kdWxlID0ge2NvbnRyb2xsZXI6IGZ1bmN0aW9uKCkge30sIHZpZXc6IGZ1bmN0aW9uKCkge3JldHVybiBtLnJvdXRlLnBhcmFtKCJhMSIpfX0KCQkKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJvdXRlLm1vZGUgPSAic2VhcmNoIgoJCW0ucm91dGUocm9vdCwgIi90ZXN0Ny9mb28iLCB7CgkJCSIvIjogbW9kdWxlLAoJCQkiL3Rlc3Q3LzphMSI6IG1vZHVsZQoJCX0pCgkJdmFyIHJvdXRlVmFsdWVCZWZvcmUgPSBtLnJvdXRlKCkKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApCgkJbS5yb3V0ZSgiLyIpCgkJdmFyIHJvdXRlVmFsdWVBZnRlciA9IG0ucm91dGUoKQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy90ZWFyZG93bgoJCXJldHVybiByb3V0ZVZhbHVlQmVmb3JlID09PSAiL3Rlc3Q3L2ZvbyIgJiYgcm91dGVWYWx1ZUFmdGVyID09PSAiLyIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy9zZXR1cAoJCW1vY2subG9jYXRpb24uc2VhcmNoID0gIj8iCgkJCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yb3V0ZS5tb2RlID0gInNlYXJjaCIKCQltLnJvdXRlKHJvb3QsICIvdGVzdDgvZm9vL1NFUC9iYXIvYmF6IiwgewoJCQkiL3Rlc3Q4Lzp0ZXN0L1NFUC86cGF0aC4uLiI6IHsKCQkJCWNvbnRyb2xsZXI6IGZ1bmN0aW9uKCkge30sCgkJCQl2aWV3OiBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gbS5yb3V0ZS5wYXJhbSgidGVzdCIpICsgIl8iICsgbS5yb3V0ZS5wYXJhbSgicGF0aCIpCgkJCQl9CgkJCX0KCQl9KQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy90ZWFyZG93bgoJCXJldHVybiBtb2NrLmxvY2F0aW9uLnNlYXJjaCA9PSAiPy90ZXN0OC9mb28vU0VQL2Jhci9iYXoiICYmIHJvb3QuY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJmb29fYmFyL2JheiIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy9zZXR1cAoJCW1vY2subG9jYXRpb24uc2VhcmNoID0gIj8iCgkJCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yb3V0ZS5tb2RlID0gInNlYXJjaCIKCQltLnJvdXRlKHJvb3QsICIvdGVzdDkvZm9vL2Jhci9TRVAvYmF6IiwgewoJCQkiL3Rlc3Q5Lzp0ZXN0Li4uL1NFUC86cGF0aCI6IHsKCQkJCWNvbnRyb2xsZXI6IGZ1bmN0aW9uKCkge30sCgkJCQl2aWV3OiBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gbS5yb3V0ZS5wYXJhbSgidGVzdCIpICsgIl8iICsgbS5yb3V0ZS5wYXJhbSgicGF0aCIpCgkJCQl9CgkJCX0KCQl9KQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy90ZWFyZG93bgoJCXJldHVybiBtb2NrLmxvY2F0aW9uLnNlYXJjaCA9PSAiPy90ZXN0OS9mb28vYmFyL1NFUC9iYXoiICYmIHJvb3QuY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJmb28vYmFyX2JheiIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy9zZXR1cAoJCW1vY2subG9jYXRpb24uc2VhcmNoID0gIj8iCgkJCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yb3V0ZS5tb2RlID0gInNlYXJjaCIKCQltLnJvdXRlKHJvb3QsICIvdGVzdDEwL2ZvbyUyMGJhciIsIHsKCQkJIi90ZXN0MTAvOnRlc3QiOiB7CgkJCQljb250cm9sbGVyOiBmdW5jdGlvbigpIHt9LAoJCQkJdmlldzogZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIG0ucm91dGUucGFyYW0oInRlc3QiKQoJCQkJfQoJCQl9CgkJfSkKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vdGVhcmRvd24KCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gImZvbyBiYXIiCgl9KQoJLy9lbmQgbS5yb3V0ZQoKCS8vbS5wcm9wCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciBwcm9wID0gbS5wcm9wKCJ0ZXN0IikKCQlyZXR1cm4gcHJvcCgpID09PSAidGVzdCIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciBwcm9wID0gbS5wcm9wKCJ0ZXN0IikKCQlwcm9wKCJmb28iKQoJCXJldHVybiBwcm9wKCkgPT09ICJmb28iCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcHJvcCA9IG0ucHJvcCgidGVzdCIpCgkJcmV0dXJuIEpTT04uc3RyaW5naWZ5KHByb3ApID09PSAnInRlc3QiJwoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIG9iaiA9IHtwcm9wOiBtLnByb3AoInRlc3QiKX0KCQlyZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqKSA9PT0gJ3sicHJvcCI6InRlc3QifScKCX0pCgoJLy9tLnJlcXVlc3QKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHByb3AgPSBtLnJlcXVlc3Qoe21ldGhvZDogIkdFVCIsIHVybDogInRlc3QifSkKCQl2YXIgZSA9IG1vY2suWE1MSHR0cFJlcXVlc3QuJGV2ZW50cy5wb3AoKQoJCWUudGFyZ2V0Lm9ubG9hZChlKQoJCXJldHVybiBwcm9wKCkubWV0aG9kID09PSAiR0VUIiAmJiBwcm9wKCkudXJsID09PSAidGVzdCIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciBwcm9wID0gbS5yZXF1ZXN0KHttZXRob2Q6ICJHRVQiLCB1cmw6ICJ0ZXN0In0pLnRoZW4oZnVuY3Rpb24odmFsdWUpIHtyZXR1cm4gImZvbyJ9KQoJCXZhciBlID0gbW9jay5YTUxIdHRwUmVxdWVzdC4kZXZlbnRzLnBvcCgpCgkJZS50YXJnZXQub25sb2FkKGUpCgkJcmV0dXJuIHByb3AoKSA9PT0gImZvbyIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciBwcm9wID0gbS5yZXF1ZXN0KHttZXRob2Q6ICJQT1NUIiwgdXJsOiAiaHR0cDovL2RvbWFpbi5jb206ODAiLCBkYXRhOiB7fX0pLnRoZW4oZnVuY3Rpb24odmFsdWUpIHtyZXR1cm4gdmFsdWV9KQoJCXZhciBlID0gbW9jay5YTUxIdHRwUmVxdWVzdC4kZXZlbnRzLnBvcCgpCgkJZS50YXJnZXQub25sb2FkKGUpCgkJcmV0dXJuIHByb3AoKS51cmwgPT09ICJodHRwOi8vZG9tYWluLmNvbTo4MCIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciBwcm9wID0gbS5yZXF1ZXN0KHttZXRob2Q6ICJQT1NUIiwgdXJsOiAiaHR0cDovL2RvbWFpbi5jb206ODAvOnRlc3QxIiwgZGF0YToge3Rlc3QxOiAiZm9vIn19KS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7cmV0dXJuIHZhbHVlfSkKCQl2YXIgZSA9IG1vY2suWE1MSHR0cFJlcXVlc3QuJGV2ZW50cy5wb3AoKQoJCWUudGFyZ2V0Lm9ubG9hZChlKQoJCXJldHVybiBwcm9wKCkudXJsID09PSAiaHR0cDovL2RvbWFpbi5jb206ODAvZm9vIgoJfSkKCgkvL20uZGVmZXJyZWQKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHZhbHVlCgkJdmFyIGRlZmVycmVkID0gbS5kZWZlcnJlZCgpCgkJZGVmZXJyZWQucHJvbWlzZS50aGVuKGZ1bmN0aW9uKGRhdGEpIHt2YWx1ZSA9IGRhdGF9KQoJCWRlZmVycmVkLnJlc29sdmUoInRlc3QiKQoJCXJldHVybiB2YWx1ZSA9PT0gInRlc3QiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgdmFsdWUKCQl2YXIgZGVmZXJyZWQgPSBtLmRlZmVycmVkKCkKCQlkZWZlcnJlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24oZGF0YSkge3JldHVybiAiZm9vIn0pLnRoZW4oZnVuY3Rpb24oZGF0YSkge3ZhbHVlID0gZGF0YX0pCgkJZGVmZXJyZWQucmVzb2x2ZSgidGVzdCIpCgkJcmV0dXJuIHZhbHVlID09PSAiZm9vIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHZhbHVlCgkJdmFyIGRlZmVycmVkID0gbS5kZWZlcnJlZCgpCgkJZGVmZXJyZWQucHJvbWlzZS50aGVuKG51bGwsIGZ1bmN0aW9uKGRhdGEpIHt2YWx1ZSA9IGRhdGF9KQoJCWRlZmVycmVkLnJlamVjdCgidGVzdCIpCgkJcmV0dXJuIHZhbHVlID09PSAidGVzdCIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciB2YWx1ZQoJCXZhciBkZWZlcnJlZCA9IG0uZGVmZXJyZWQoKQoJCWRlZmVycmVkLnByb21pc2UudGhlbihudWxsLCBmdW5jdGlvbihkYXRhKSB7cmV0dXJuICJmb28ifSkudGhlbihudWxsLCBmdW5jdGlvbihkYXRhKSB7dmFsdWUgPSBkYXRhfSkKCQlkZWZlcnJlZC5yZWplY3QoInRlc3QiKQoJCXJldHVybiB2YWx1ZSA9PT0gImZvbyIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciB2YWx1ZTEsIHZhbHVlMgoJCXZhciBkZWZlcnJlZCA9IG0uZGVmZXJyZWQoKQoJCWRlZmVycmVkLnByb21pc2UudGhlbihmdW5jdGlvbihkYXRhKSB7dGhyb3cgbmV3IEVycm9yfSkudGhlbihmdW5jdGlvbihkYXRhKSB7dmFsdWUxID0gMX0sIGZ1bmN0aW9uKGRhdGEpIHt2YWx1ZTIgPSBkYXRhfSkKCQlkZWZlcnJlZC5yZXNvbHZlKCJ0ZXN0IikKCQlyZXR1cm4gdmFsdWUxID09PSB1bmRlZmluZWQgJiYgdmFsdWUyIGluc3RhbmNlb2YgRXJyb3IKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciBkZWZlcnJlZDEgPSBtLmRlZmVycmVkKCkKCQl2YXIgZGVmZXJyZWQyID0gbS5kZWZlcnJlZCgpCgkJdmFyIHZhbHVlMSwgdmFsdWUyCgkJZGVmZXJyZWQxLnByb21pc2UudGhlbihmdW5jdGlvbihkYXRhKSB7CgkJCXZhbHVlMSA9IGRhdGEKCQkJcmV0dXJuIGRlZmVycmVkMi5wcm9taXNlCgkJfSkudGhlbihmdW5jdGlvbihkYXRhKSB7CgkJCXZhbHVlMiA9IGRhdGEKCQl9KQoJCWRlZmVycmVkMS5yZXNvbHZlKDEpCgkJZGVmZXJyZWQyLnJlc29sdmUoMikKCQlyZXR1cm4gdmFsdWUxID09PSAxICYmIHZhbHVlMiA9PT0gMgoJfSkKCgkvL20uc3luYwoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgdmFsdWUKCQl2YXIgZGVmZXJyZWQxID0gbS5kZWZlcnJlZCgpCgkJdmFyIGRlZmVycmVkMiA9IG0uZGVmZXJyZWQoKQoJCW0uc3luYyhbZGVmZXJyZWQxLnByb21pc2UsIGRlZmVycmVkMi5wcm9taXNlXSkudGhlbihmdW5jdGlvbihkYXRhKSB7dmFsdWUgPSBkYXRhfSkKCQlkZWZlcnJlZDEucmVzb2x2ZSgidGVzdCIpCgkJZGVmZXJyZWQyLnJlc29sdmUoImZvbyIpCgkJcmV0dXJuIHZhbHVlWzBdID09PSAidGVzdCIgJiYgdmFsdWVbMV0gPT09ICJmb28iCgl9KQoKCS8vbS5zdGFydENvbXB1dGF0aW9uL20uZW5kQ29tcHV0YXRpb24KCXRlc3QoZnVuY3Rpb24oKSB7CgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKQoJCQoJCXZhciBjb250cm9sbGVyCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5tb2R1bGUocm9vdCwgewoJCQljb250cm9sbGVyOiBmdW5jdGlvbigpIHtjb250cm9sbGVyID0gdGhpc30sCgkJCXZpZXc6IGZ1bmN0aW9uKGN0cmwpIHtyZXR1cm4gY3RybC52YWx1ZX0KCQl9KQoJCQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkKCQkKCQltLnN0YXJ0Q29tcHV0YXRpb24oKQoJCWNvbnRyb2xsZXIudmFsdWUgPSAiZm9vIgoJCW0uZW5kQ29tcHV0YXRpb24oKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiZm9vIgoJfSkKCQoJLy9jb25zb2xlLmxvZyBwcmVzZW5jZQoJdGVzdChmdW5jdGlvbigpIHsKCQlyZXR1cm4gbS5kZXBzLmZhY3RvcnkudG9TdHJpbmcoKS5pbmRleE9mKCJjb25zb2xlIikgPCAwCgl9KQp9CgovL21vY2tzCnRlc3RNaXRocmlsKG1vY2sud2luZG93KQoKdGVzdC5wcmludChjb25zb2xlLmxvZyk=",
                "body": "TWl0aHJpbCA9IG0gPSBuZXcgZnVuY3Rpb24gYXBwKHdpbmRvdykgewoJdmFyIHNlbGVjdG9yQ2FjaGUgPSB7fQoJdmFyIHR5cGUgPSB7fS50b1N0cmluZwoJdmFyIHBhcnNlciA9IC8oPzooXnwjfFwuKShbXiNcLlxbXF1dKykpfChcWy4rP1xdKS9nLCBhdHRyUGFyc2VyID0gL1xbKC4rPykoPzo9KCJ8J3wpKC4rPylcMik/XF0vCgkKCWZ1bmN0aW9uIG0oKSB7CgkJdmFyIGFyZ3MgPSBhcmd1bWVudHMKCQl2YXIgaGFzQXR0cnMgPSB0eXBlLmNhbGwoYXJnc1sxXSkgPT0gIltvYmplY3QgT2JqZWN0XSIKCQl2YXIgYXR0cnMgPSBoYXNBdHRycyA/IGFyZ3NbMV0gOiB7fQoJCXZhciBjbGFzc0F0dHJOYW1lID0gImNsYXNzIiBpbiBhdHRycyA/ICJjbGFzcyIgOiAiY2xhc3NOYW1lIgoJCXZhciBjZWxsID0gc2VsZWN0b3JDYWNoZVthcmdzWzBdXQoJCWlmIChjZWxsID09PSB1bmRlZmluZWQpIHsKCQkJc2VsZWN0b3JDYWNoZVthcmdzWzBdXSA9IGNlbGwgPSB7dGFnOiAiZGl2IiwgYXR0cnM6IHt9fQoJCQl2YXIgbWF0Y2gsIGNsYXNzZXMgPSBbXQoJCQl3aGlsZSAobWF0Y2ggPSBwYXJzZXIuZXhlYyhhcmdzWzBdKSkgewoJCQkJaWYgKG1hdGNoWzFdID09ICIiKSBjZWxsLnRhZyA9IG1hdGNoWzJdCgkJCQllbHNlIGlmIChtYXRjaFsxXSA9PSAiIyIpIGNlbGwuYXR0cnMuaWQgPSBtYXRjaFsyXQoJCQkJZWxzZSBpZiAobWF0Y2hbMV0gPT0gIi4iKSBjbGFzc2VzLnB1c2gobWF0Y2hbMl0pCgkJCQllbHNlIGlmIChtYXRjaFszXVswXSA9PSAiWyIpIHsKCQkJCQl2YXIgcGFpciA9IGF0dHJQYXJzZXIuZXhlYyhtYXRjaFszXSkKCQkJCQljZWxsLmF0dHJzW3BhaXJbMV1dID0gcGFpclszXSB8fCB0cnVlCgkJCQl9CgkJCX0KCQkJaWYgKGNsYXNzZXMubGVuZ3RoID4gMCkgY2VsbC5hdHRyc1tjbGFzc0F0dHJOYW1lXSA9IGNsYXNzZXMuam9pbigiICIpCgkJfQoJCWNlbGwgPSBjbG9uZShjZWxsKQoJCWNlbGwuYXR0cnMgPSBjbG9uZShjZWxsLmF0dHJzKQoJCWNlbGwuY2hpbGRyZW4gPSBoYXNBdHRycyA/IGFyZ3NbMl0gOiBhcmdzWzFdCgkJZm9yICh2YXIgYXR0ck5hbWUgaW4gYXR0cnMpIHsKCQkJaWYgKGF0dHJOYW1lID09IGNsYXNzQXR0ck5hbWUpIGNlbGwuYXR0cnNbYXR0ck5hbWVdID0gKGNlbGwuYXR0cnNbYXR0ck5hbWVdIHx8ICIiKSArICIgIiArIGF0dHJzW2F0dHJOYW1lXQoJCQllbHNlIGNlbGwuYXR0cnNbYXR0ck5hbWVdID0gYXR0cnNbYXR0ck5hbWVdCgkJfQoJCXJldHVybiBjZWxsCgl9CglmdW5jdGlvbiBidWlsZChwYXJlbnRFbGVtZW50LCBwYXJlbnRUYWcsIGRhdGEsIGNhY2hlZCwgc2hvdWxkUmVhdHRhY2gsIGluZGV4LCBlZGl0YWJsZSwgbmFtZXNwYWNlKSB7CgkJaWYgKGRhdGEgPT09IG51bGwgfHwgZGF0YSA9PT0gdW5kZWZpbmVkKSBkYXRhID0gIiIKCQlpZiAoZGF0YS5zdWJ0cmVlID09PSAicmV0YWluIikgcmV0dXJuCgkJCgkJdmFyIGNhY2hlZFR5cGUgPSB0eXBlLmNhbGwoY2FjaGVkKSwgZGF0YVR5cGUgPSB0eXBlLmNhbGwoZGF0YSkKCQlpZiAoY2FjaGVkVHlwZSAhPSBkYXRhVHlwZSkgewoJCQlpZiAoY2FjaGVkICE9PSBudWxsICYmIGNhY2hlZCAhPT0gdW5kZWZpbmVkKSBjbGVhcihjYWNoZWQubm9kZXMpCgkJCWNhY2hlZCA9IG5ldyBkYXRhLmNvbnN0cnVjdG9yCgkJCWNhY2hlZC5ub2RlcyA9IFtdCgkJfQoJCQoJCWlmIChkYXRhVHlwZSA9PSAiW29iamVjdCBBcnJheV0iKSB7CgkJCXZhciBub2RlcyA9IFtdLCBpbnRhY3QgPSBjYWNoZWQubGVuZ3RoID09PSBkYXRhLmxlbmd0aCwgc3ViQXJyYXlDb3VudCA9IDAKCQkJZm9yICh2YXIgaSA9IDAsIGNhY2hlQ291bnQgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQkJdmFyIGl0ZW0gPSBidWlsZChwYXJlbnRFbGVtZW50LCBudWxsLCBkYXRhW2ldLCBjYWNoZWRbY2FjaGVDb3VudF0sIHNob3VsZFJlYXR0YWNoLCBpbmRleCArIHN1YkFycmF5Q291bnQgfHwgc3ViQXJyYXlDb3VudCwgZWRpdGFibGUsIG5hbWVzcGFjZSkKCQkJCWlmIChpdGVtID09PSB1bmRlZmluZWQpIGNvbnRpbnVlCgkJCQlpZiAoIWl0ZW0ubm9kZXMuaW50YWN0KSBpbnRhY3QgPSBmYWxzZQoJCQkJc3ViQXJyYXlDb3VudCArPSBpdGVtIGluc3RhbmNlb2YgQXJyYXkgPyBpdGVtLmxlbmd0aCA6IDEKCQkJCWNhY2hlZFtjYWNoZUNvdW50KytdID0gaXRlbQoJCQl9CgkJCWlmICghaW50YWN0KSB7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIGlmIChjYWNoZWRbaV0gIT09IHVuZGVmaW5lZCkgbm9kZXMgPSBub2Rlcy5jb25jYXQoY2FjaGVkW2ldLm5vZGVzKQoJCQkJZm9yICh2YXIgaSA9IG5vZGVzLmxlbmd0aCwgbm9kZTsgbm9kZSA9IGNhY2hlZC5ub2Rlc1tpXTsgaSsrKSBpZiAobm9kZS5wYXJlbnROb2RlICE9PSBudWxsKSBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSkKCQkJCWZvciAodmFyIGkgPSBjYWNoZWQubm9kZXMubGVuZ3RoLCBub2RlOyBub2RlID0gbm9kZXNbaV07IGkrKykgaWYgKG5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgcGFyZW50RWxlbWVudC5hcHBlbmRDaGlsZChub2RlKQoJCQkJaWYgKGRhdGEubGVuZ3RoIDwgY2FjaGVkLmxlbmd0aCkgY2FjaGVkLmxlbmd0aCA9IGRhdGEubGVuZ3RoCgkJCQljYWNoZWQubm9kZXMgPSBub2RlcwoJCQl9CgkJfQoJCWVsc2UgaWYgKGRhdGFUeXBlID09ICJbb2JqZWN0IE9iamVjdF0iKSB7CgkJCWlmIChkYXRhLnRhZyAhPSBjYWNoZWQudGFnIHx8IE9iamVjdC5rZXlzKGRhdGEuYXR0cnMpLmpvaW4oKSAhPSBPYmplY3Qua2V5cyhjYWNoZWQuYXR0cnMpLmpvaW4oKSB8fCBkYXRhLmF0dHJzLmlkICE9IGNhY2hlZC5hdHRycy5pZCkgY2xlYXIoY2FjaGVkLm5vZGVzKQoJCQlpZiAodHlwZW9mIGRhdGEudGFnICE9ICJzdHJpbmciKSByZXR1cm4KCQkJCgkJCXZhciBub2RlLCBpc05ldyA9IGNhY2hlZC5ub2Rlcy5sZW5ndGggPT09IDAKCQkJaWYgKGRhdGEudGFnID09PSAic3ZnIikgbmFtZXNwYWNlID0gImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgoJCQlpZiAoaXNOZXcpIHsKCQkJCW5vZGUgPSBuYW1lc3BhY2UgPT09IHVuZGVmaW5lZCA/IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KGRhdGEudGFnKSA6IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMobmFtZXNwYWNlLCBkYXRhLnRhZykKCQkJCWNhY2hlZCA9IHsKCQkJCQl0YWc6IGRhdGEudGFnLAoJCQkJCWF0dHJzOiBzZXRBdHRyaWJ1dGVzKG5vZGUsIGRhdGEudGFnLCBkYXRhLmF0dHJzLCB7fSwgbmFtZXNwYWNlKSwKCQkJCQljaGlsZHJlbjogYnVpbGQobm9kZSwgZGF0YS50YWcsIGRhdGEuY2hpbGRyZW4sIGNhY2hlZC5jaGlsZHJlbiwgdHJ1ZSwgMCwgZGF0YS5hdHRycy5jb250ZW50ZWRpdGFibGUgPyBub2RlIDogZWRpdGFibGUsIG5hbWVzcGFjZSksCgkJCQkJbm9kZXM6IFtub2RlXQoJCQkJfQoJCQkJcGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUobm9kZSwgcGFyZW50RWxlbWVudC5jaGlsZE5vZGVzW2luZGV4XSB8fCBudWxsKQoJCQl9CgkJCWVsc2UgewoJCQkJbm9kZSA9IGNhY2hlZC5ub2Rlc1swXQoJCQkJc2V0QXR0cmlidXRlcyhub2RlLCBkYXRhLnRhZywgZGF0YS5hdHRycywgY2FjaGVkLmF0dHJzLCBuYW1lc3BhY2UpCgkJCQljYWNoZWQuY2hpbGRyZW4gPSBidWlsZChub2RlLCBkYXRhLnRhZywgZGF0YS5jaGlsZHJlbiwgY2FjaGVkLmNoaWxkcmVuLCBmYWxzZSwgMCwgZGF0YS5hdHRycy5jb250ZW50ZWRpdGFibGUgPyBub2RlIDogZWRpdGFibGUsIG5hbWVzcGFjZSkKCQkJCWNhY2hlZC5ub2Rlcy5pbnRhY3QgPSB0cnVlCgkJCQlpZiAoc2hvdWxkUmVhdHRhY2ggPT09IHRydWUpIHBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJfQoJCQlpZiAodHlwZS5jYWxsKGRhdGEuYXR0cnNbImNvbmZpZyJdKSA9PSAiW29iamVjdCBGdW5jdGlvbl0iKSBkYXRhLmF0dHJzWyJjb25maWciXShub2RlLCAhaXNOZXcpCgkJfQoJCWVsc2UgewoJCQl2YXIgbm9kZQoJCQlpZiAoY2FjaGVkLm5vZGVzLmxlbmd0aCA9PT0gMCkgewoJCQkJaWYgKGRhdGEuJHRydXN0ZWQpIHsKCQkJCQlub2RlID0gaW5qZWN0SFRNTChwYXJlbnRFbGVtZW50LCBpbmRleCwgZGF0YSkKCQkJCX0KCQkJCWVsc2UgewoJCQkJCW5vZGUgPSB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoZGF0YSkKCQkJCQlwYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShub2RlLCBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdIHx8IG51bGwpCgkJCQl9CgkJCQljYWNoZWQgPSAic3RyaW5nIG51bWJlciBib29sZWFuIi5pbmRleE9mKHR5cGVvZiBkYXRhKSA+IC0xID8gbmV3IGRhdGEuY29uc3RydWN0b3IoZGF0YSkgOiBkYXRhCgkJCQljYWNoZWQubm9kZXMgPSBbbm9kZV0KCQkJfQoJCQllbHNlIGlmIChjYWNoZWQudmFsdWVPZigpICE9PSBkYXRhLnZhbHVlT2YoKSB8fCBzaG91bGRSZWF0dGFjaCA9PT0gdHJ1ZSkgewoJCQkJaWYgKCFlZGl0YWJsZSB8fCBlZGl0YWJsZSAhPT0gd2luZG93LmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpIHsKCQkJCQlpZiAoZGF0YS4kdHJ1c3RlZCkgewoJCQkJCQl2YXIgY3VycmVudCA9IGNhY2hlZC5ub2Rlc1swXSwgbm9kZXMgPSBbY3VycmVudF0KCQkJCQkJaWYgKGN1cnJlbnQpIHsKCQkJCQkJCXdoaWxlIChjdXJyZW50ID0gY3VycmVudC5uZXh0U2libGluZykgbm9kZXMucHVzaChjdXJyZW50KQoJCQkJCQkJY2xlYXIobm9kZXMpCgkJCQkJCQlub2RlID0gaW5qZWN0SFRNTChwYXJlbnRFbGVtZW50LCBpbmRleCwgZGF0YSkKCQkJCQkJfQoJCQkJCQllbHNlIHBhcmVudEVsZW1lbnQuaW5uZXJIVE1MID0gZGF0YQoJCQkJCX0KCQkJCQllbHNlIHsKCQkJCQkJbm9kZSA9IGNhY2hlZC5ub2Rlc1swXQoJCQkJCQlpZiAocGFyZW50VGFnID09PSAidGV4dGFyZWEiKSBwYXJlbnRFbGVtZW50LnZhbHVlID0gZGF0YQoJCQkJCQllbHNlIGlmIChlZGl0YWJsZSkgZWRpdGFibGUuaW5uZXJIVE1MID0gZGF0YQoJCQkJCQllbHNlIHsKCQkJCQkJCXBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKG5vZGUsIHBhcmVudEVsZW1lbnQuY2hpbGROb2Rlc1tpbmRleF0gfHwgbnVsbCkKCQkJCQkJCW5vZGUubm9kZVZhbHVlID0gZGF0YQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQkJY2FjaGVkID0gbmV3IGRhdGEuY29uc3RydWN0b3IoZGF0YSkKCQkJCWNhY2hlZC5ub2RlcyA9IFtub2RlXQoJCQl9CgkJCWVsc2UgY2FjaGVkLm5vZGVzLmludGFjdCA9IHRydWUKCQl9CgkJCgkJcmV0dXJuIGNhY2hlZAoJfQoJZnVuY3Rpb24gc2V0QXR0cmlidXRlcyhub2RlLCB0YWcsIGRhdGFBdHRycywgY2FjaGVkQXR0cnMsIG5hbWVzcGFjZSkgewoJCWZvciAodmFyIGF0dHJOYW1lIGluIGRhdGFBdHRycykgewoJCQl2YXIgZGF0YUF0dHIgPSBkYXRhQXR0cnNbYXR0ck5hbWVdCgkJCXZhciBjYWNoZWRBdHRyID0gY2FjaGVkQXR0cnNbYXR0ck5hbWVdCgkJCWlmICghKGF0dHJOYW1lIGluIGNhY2hlZEF0dHJzKSB8fCAoY2FjaGVkQXR0ciAhPT0gZGF0YUF0dHIpIHx8IG5vZGUgPT09IHdpbmRvdy5kb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7CgkJCQljYWNoZWRBdHRyc1thdHRyTmFtZV0gPSBkYXRhQXR0cgoJCQkJaWYgKGF0dHJOYW1lID09PSAiY29uZmlnIikgY29udGludWUKCQkJCWVsc2UgaWYgKHR5cGVvZiBkYXRhQXR0ciA9PSAiZnVuY3Rpb24iICYmIGF0dHJOYW1lLmluZGV4T2YoIm9uIikgPT0gMCkgewoJCQkJCW5vZGVbYXR0ck5hbWVdID0gYXV0b3JlZHJhdyhkYXRhQXR0ciwgbm9kZSkKCQkJCX0KCQkJCWVsc2UgaWYgKGF0dHJOYW1lID09PSAic3R5bGUiKSB7CgkJCQkJZm9yICh2YXIgcnVsZSBpbiBkYXRhQXR0cikgewoJCQkJCQlpZiAoY2FjaGVkQXR0ciA9PT0gdW5kZWZpbmVkIHx8IGNhY2hlZEF0dHJbcnVsZV0gIT09IGRhdGFBdHRyW3J1bGVdKSBub2RlLnN0eWxlW3J1bGVdID0gZGF0YUF0dHJbcnVsZV0KCQkJCQl9CgkJCQl9CgkJCQllbHNlIGlmIChuYW1lc3BhY2UgIT09IHVuZGVmaW5lZCkgewoJCQkJCWlmIChhdHRyTmFtZSA9PT0gImhyZWYiKSBub2RlLnNldEF0dHJpYnV0ZU5TKCJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwgImhyZWYiLCBkYXRhQXR0cikKCQkJCQllbHNlIGlmIChhdHRyTmFtZSA9PT0gImNsYXNzTmFtZSIpIG5vZGUuc2V0QXR0cmlidXRlKCJjbGFzcyIsIGRhdGFBdHRyKQoJCQkJCWVsc2Ugbm9kZS5zZXRBdHRyaWJ1dGUoYXR0ck5hbWUsIGRhdGFBdHRyKQoJCQkJfQoJCQkJZWxzZSBpZiAoYXR0ck5hbWUgPT09ICJ2YWx1ZSIgJiYgdGFnID09PSAiaW5wdXQiKSB7CgkJCQkJaWYgKG5vZGUudmFsdWUgIT09IGRhdGFBdHRyKSBub2RlLnZhbHVlID0gZGF0YUF0dHIKCQkJCX0KCQkJCWVsc2UgaWYgKGF0dHJOYW1lIGluIG5vZGUgJiYgYXR0ck5hbWUgIT0gImxpc3QiKSBub2RlW2F0dHJOYW1lXSA9IGRhdGFBdHRyCgkJCQllbHNlIG5vZGUuc2V0QXR0cmlidXRlKGF0dHJOYW1lLCBkYXRhQXR0cikKCQkJfQoJCX0KCQlyZXR1cm4gY2FjaGVkQXR0cnMKCX0KCWZ1bmN0aW9uIGNsZWFyKG5vZGVzKSB7CgkJZm9yICh2YXIgaSA9IG5vZGVzLmxlbmd0aCAtIDE7IGkgPiAtMTsgaS0tKSBub2Rlc1tpXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKG5vZGVzW2ldKQoJCW5vZGVzLmxlbmd0aCA9IDAKCX0KCWZ1bmN0aW9uIGluamVjdEhUTUwocGFyZW50RWxlbWVudCwgaW5kZXgsIGRhdGEpIHsKCQl2YXIgbmV4dFNpYmxpbmcgPSBwYXJlbnRFbGVtZW50LmNoaWxkTm9kZXNbaW5kZXhdCgkJaWYgKG5leHRTaWJsaW5nKSBuZXh0U2libGluZy5pbnNlcnRBZGphY2VudEhUTUwoImJlZm9yZWJlZ2luIiwgZGF0YSkKCQllbHNlIHBhcmVudEVsZW1lbnQuaW5zZXJ0QWRqYWNlbnRIVE1MKCJiZWZvcmVlbmQiLCBkYXRhKQoJCXJldHVybiBuZXh0U2libGluZyA/IG5leHRTaWJsaW5nLnByZXZpb3VzU2libGluZyA6IHBhcmVudEVsZW1lbnQuZmlyc3RDaGlsZAoJfQoJZnVuY3Rpb24gY2xvbmUob2JqZWN0KSB7CgkJdmFyIHJlc3VsdCA9IHt9CgkJZm9yICh2YXIgcHJvcCBpbiBvYmplY3QpIHJlc3VsdFtwcm9wXSA9IG9iamVjdFtwcm9wXQoJCXJldHVybiByZXN1bHQKCX0KCWZ1bmN0aW9uIGF1dG9yZWRyYXcoY2FsbGJhY2ssIG9iamVjdCkgewoJCXJldHVybiBmdW5jdGlvbihlKSB7CgkJCW0uc3RhcnRDb21wdXRhdGlvbigpCgkJCXRyeSB7cmV0dXJuIGNhbGxiYWNrLmNhbGwob2JqZWN0LCBlKX0KCQkJZmluYWxseSB7bS5lbmRDb21wdXRhdGlvbigpfQoJCX0KCX0KCQoJdmFyIGh0bWwKCXZhciBkb2N1bWVudE5vZGUgPSB7CgkJaW5zZXJ0QWRqYWNlbnRIVE1MOiBmdW5jdGlvbihfLCBkYXRhKSB7CgkJCXdpbmRvdy5kb2N1bWVudC53cml0ZShkYXRhKQoJCQl3aW5kb3cuZG9jdW1lbnQuY2xvc2UoKQoJCX0sCgkJYXBwZW5kQ2hpbGQ6IGZ1bmN0aW9uKG5vZGUpIHsKCQkJaWYgKGh0bWwgPT09IHVuZGVmaW5lZCkgaHRtbCA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJodG1sIikKCQkJaWYgKG5vZGUubm9kZU5hbWUgPT0gIkhUTUwiKSBodG1sID0gbm9kZQoJCQllbHNlIGh0bWwuYXBwZW5kQ2hpbGQobm9kZSkKCQkJaWYgKHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgIT09IGh0bWwpIHsKCQkJCXdpbmRvdy5kb2N1bWVudC5yZXBsYWNlQ2hpbGQoaHRtbCwgd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkKCQkJfQoJCX0sCgkJaW5zZXJ0QmVmb3JlOiBmdW5jdGlvbihub2RlKSB7CgkJCXRoaXMuYXBwZW5kQ2hpbGQobm9kZSkKCQl9LAoJCWNoaWxkTm9kZXM6IFtdCgl9Cgl2YXIgbm9kZUNhY2hlID0gW10sIGNlbGxDYWNoZSA9IHt9CgltLnJlbmRlciA9IGZ1bmN0aW9uKHJvb3QsIGNlbGwpIHsKCQl2YXIgaW5kZXggPSBub2RlQ2FjaGUuaW5kZXhPZihyb290KQoJCXZhciBpZCA9IGluZGV4IDwgMCA/IG5vZGVDYWNoZS5wdXNoKHJvb3QpIC0gMSA6IGluZGV4CgkJdmFyIG5vZGUgPSByb290ID09IHdpbmRvdy5kb2N1bWVudCB8fCByb290ID09IHdpbmRvdy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgPyBkb2N1bWVudE5vZGUgOiByb290CgkJY2VsbENhY2hlW2lkXSA9IGJ1aWxkKG5vZGUsIG51bGwsIGNlbGwsIGNlbGxDYWNoZVtpZF0sIGZhbHNlLCAwLCBudWxsLCB1bmRlZmluZWQpCgl9CgkKCW0udHJ1c3QgPSBmdW5jdGlvbih2YWx1ZSkgewoJCXZhbHVlID0gbmV3IFN0cmluZyh2YWx1ZSkKCQl2YWx1ZS4kdHJ1c3RlZCA9IHRydWUKCQlyZXR1cm4gdmFsdWUKCX0KCQoJdmFyIHJvb3RzID0gW10sIG1vZHVsZXMgPSBbXSwgY29udHJvbGxlcnMgPSBbXSwgbm93ID0gMCwgbGFzdFJlZHJhdyA9IDAsIGxhc3RSZWRyYXdJZCA9IDAsIGNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IG51bGwKCW0ubW9kdWxlID0gZnVuY3Rpb24ocm9vdCwgbW9kdWxlKSB7CgkJbS5zdGFydENvbXB1dGF0aW9uKCkKCQl2YXIgaW5kZXggPSByb290cy5pbmRleE9mKHJvb3QpCgkJaWYgKGluZGV4IDwgMCkgaW5kZXggPSByb290cy5sZW5ndGgKCQlyb290c1tpbmRleF0gPSByb290CgkJbW9kdWxlc1tpbmRleF0gPSBtb2R1bGUKCQljb250cm9sbGVyc1tpbmRleF0gPSBuZXcgbW9kdWxlLmNvbnRyb2xsZXIKCQltLmVuZENvbXB1dGF0aW9uKCkKCX0KCW0ucmVkcmF3ID0gZnVuY3Rpb24oKSB7CgkJbm93ID0gd2luZG93LnBlcmZvcm1hbmNlICYmIHdpbmRvdy5wZXJmb3JtYW5jZS5ub3cgPyB3aW5kb3cucGVyZm9ybWFuY2Uubm93KCkgOiBuZXcgd2luZG93LkRhdGUoKS5nZXRUaW1lKCkKCQlpZiAobm93IC0gbGFzdFJlZHJhdyA+IDE2KSByZWRyYXcoKQoJCWVsc2UgewoJCQl2YXIgY2FuY2VsID0gd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8IHdpbmRvdy5jbGVhclRpbWVvdXQKCQkJdmFyIGRlZmVyID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCB3aW5kb3cuc2V0VGltZW91dAoJCQljYW5jZWwobGFzdFJlZHJhd0lkKQoJCQlsYXN0UmVkcmF3SWQgPSBkZWZlcihyZWRyYXcsIDApCgkJfQoJfQoJZnVuY3Rpb24gcmVkcmF3KCkgewoJCWZvciAodmFyIGkgPSAwOyBpIDwgcm9vdHMubGVuZ3RoOyBpKyspIHsKCQkJbS5yZW5kZXIocm9vdHNbaV0sIG1vZHVsZXNbaV0udmlldyhjb250cm9sbGVyc1tpXSkpCgkJfQoJCWlmIChjb21wdXRlUG9zdFJlZHJhd0hvb2spIHsKCQkJY29tcHV0ZVBvc3RSZWRyYXdIb29rKCkKCQkJY29tcHV0ZVBvc3RSZWRyYXdIb29rID0gbnVsbAoJCX0KCQlsYXN0UmVkcmF3ID0gbm93Cgl9CgkKCXZhciBwZW5kaW5nUmVxdWVzdHMgPSAwCgltLnN0YXJ0Q29tcHV0YXRpb24gPSBmdW5jdGlvbigpIHtwZW5kaW5nUmVxdWVzdHMrK30KCW0uZW5kQ29tcHV0YXRpb24gPSBmdW5jdGlvbigpIHsKCQlwZW5kaW5nUmVxdWVzdHMgPSBNYXRoLm1heChwZW5kaW5nUmVxdWVzdHMgLSAxLCAwKQoJCWlmIChwZW5kaW5nUmVxdWVzdHMgPT0gMCkgbS5yZWRyYXcoKQoJfQoJCgltLndpdGhBdHRyID0gZnVuY3Rpb24ocHJvcCwgd2l0aEF0dHJDYWxsYmFjaykgewoJCXJldHVybiBmdW5jdGlvbihlKSB7d2l0aEF0dHJDYWxsYmFjayhwcm9wIGluIGUuY3VycmVudFRhcmdldCA/IGUuY3VycmVudFRhcmdldFtwcm9wXSA6IGUuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUocHJvcCkpfQoJfQoJCgkvL3JvdXRpbmcKCXZhciBtb2RlcyA9IHtwYXRobmFtZTogIiIsIGhhc2g6ICIjIiwgc2VhcmNoOiAiPyJ9Cgl2YXIgcmVkaXJlY3QgPSBmdW5jdGlvbigpIHt9LCByb3V0ZVBhcmFtcyA9IHt9LCBjdXJyZW50Um91dGUKCW0ucm91dGUgPSBmdW5jdGlvbigpIHsKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGN1cnJlbnRSb3V0ZQoJCWVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDMpIHsKCQkJY3VycmVudFJvdXRlID0gd2luZG93LmxvY2F0aW9uW20ucm91dGUubW9kZV0uc2xpY2UobW9kZXNbbS5yb3V0ZS5tb2RlXS5sZW5ndGgpCgkJCXZhciByb290ID0gYXJndW1lbnRzWzBdLCBkZWZhdWx0Um91dGUgPSBhcmd1bWVudHNbMV0sIHJvdXRlciA9IGFyZ3VtZW50c1syXQoJCQlyZWRpcmVjdCA9IGZ1bmN0aW9uKHNvdXJjZSkgewoJCQkJdmFyIHBhdGggPSBzb3VyY2Uuc2xpY2UobW9kZXNbbS5yb3V0ZS5tb2RlXS5sZW5ndGgpCgkJCQlpZiAoIXJvdXRlQnlWYWx1ZShyb290LCByb3V0ZXIsIHBhdGgpKSB7CgkJCQkJbS5yb3V0ZShkZWZhdWx0Um91dGUsIHRydWUpCgkJCQl9CgkJCX0KCQkJdmFyIGxpc3RlbmVyID0gbS5yb3V0ZS5tb2RlID09ICJoYXNoIiA/ICJvbmhhc2hjaGFuZ2UiIDogIm9ucG9wc3RhdGUiCgkJCXdpbmRvd1tsaXN0ZW5lcl0gPSBmdW5jdGlvbigpIHsKCQkJCXJlZGlyZWN0KHdpbmRvdy5sb2NhdGlvblttLnJvdXRlLm1vZGVdKQoJCQl9CgkJCWNvbXB1dGVQb3N0UmVkcmF3SG9vayA9IHNjcm9sbFRvSGFzaAoJCQl3aW5kb3dbbGlzdGVuZXJdKCkKCQl9CgkJZWxzZSBpZiAoYXJndW1lbnRzWzBdLmFkZEV2ZW50TGlzdGVuZXIpIHsKCQkJdmFyIGVsZW1lbnQgPSBhcmd1bWVudHNbMF0KCQkJdmFyIGlzSW5pdGlhbGl6ZWQgPSBhcmd1bWVudHNbMV0KCQkJaWYgKGVsZW1lbnQuaHJlZi5pbmRleE9mKG1vZGVzW20ucm91dGUubW9kZV0pIDwgMCkgewoJCQkJZWxlbWVudC5ocmVmID0gbG9jYXRpb24ucGF0aG5hbWUgKyBtb2Rlc1ttLnJvdXRlLm1vZGVdICsgZWxlbWVudC5wYXRobmFtZQoJCQl9CgkJCWlmICghaXNJbml0aWFsaXplZCkgewoJCQkJZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJjbGljayIsIHJvdXRlVW5vYnRydXNpdmUpCgkJCQllbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgcm91dGVVbm9idHJ1c2l2ZSkKCQkJfQoJCX0KCQllbHNlIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09ICJzdHJpbmciKSB7CgkJCWN1cnJlbnRSb3V0ZSA9IGFyZ3VtZW50c1swXQoJCQl2YXIgc2hvdWxkUmVwbGFjZUhpc3RvcnlFbnRyeSA9IGFyZ3VtZW50c1sxXSA9PT0gdHJ1ZQoJCQlpZiAod2luZG93Lmhpc3RvcnkucHVzaFN0YXRlKSB7CgkJCQljb21wdXRlUG9zdFJlZHJhd0hvb2sgPSBmdW5jdGlvbigpIHsKCQkJCQl3aW5kb3cuaGlzdG9yeVtzaG91bGRSZXBsYWNlSGlzdG9yeUVudHJ5ID8gInJlcGxhY2VTdGF0ZSIgOiAicHVzaFN0YXRlIl0obnVsbCwgd2luZG93LmRvY3VtZW50LnRpdGxlLCBtb2Rlc1ttLnJvdXRlLm1vZGVdICsgY3VycmVudFJvdXRlKQoJCQkJCXNjcm9sbFRvSGFzaCgpCgkJCQl9CgkJCQlyZWRpcmVjdChtb2Rlc1ttLnJvdXRlLm1vZGVdICsgY3VycmVudFJvdXRlKQoJCQl9CgkJCWVsc2Ugd2luZG93LmxvY2F0aW9uW20ucm91dGUubW9kZV0gPSBjdXJyZW50Um91dGUKCQl9Cgl9CgltLnJvdXRlLnBhcmFtID0gZnVuY3Rpb24oa2V5KSB7cmV0dXJuIHJvdXRlUGFyYW1zW2tleV19CgltLnJvdXRlLm1vZGUgPSAic2VhcmNoIgoJZnVuY3Rpb24gcm91dGVCeVZhbHVlKHJvb3QsIHJvdXRlciwgcGF0aCkgewoJCXJvdXRlUGFyYW1zID0ge30KCQlmb3IgKHZhciByb3V0ZSBpbiByb3V0ZXIpIHsKCQkJaWYgKHJvdXRlID09IHBhdGgpIHJldHVybiAhdm9pZCBtLm1vZHVsZShyb290LCByb3V0ZXJbcm91dGVdKQoJCQkKCQkJdmFyIG1hdGNoZXIgPSBuZXcgUmVnRXhwKCJeIiArIHJvdXRlLnJlcGxhY2UoLzpbXlwvXSs/XC57M30vZywgIiguKj8pIikucmVwbGFjZSgvOlteXC9dKy9nLCAiKFteXFwvXSspIikgKyAiJCIpCgkJCQoJCQlpZiAobWF0Y2hlci50ZXN0KHBhdGgpKSB7CgkJCQlyZXR1cm4gIXZvaWQgcGF0aC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBrZXlzID0gcm91dGUubWF0Y2goLzpbXlwvXSsvZykKCQkJCQl2YXIgdmFsdWVzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEsIC0yKQoJCQkJCWZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgcm91dGVQYXJhbXNba2V5c1tpXS5yZXBsYWNlKC86fFwuL2csICIiKV0gPSBkZWNvZGVVUklDb21wb25lbnQodmFsdWVzW2ldKQoJCQkJCW0ubW9kdWxlKHJvb3QsIHJvdXRlcltyb3V0ZV0pCgkJCQl9KQoJCQl9CgkJfQoJfQoJZnVuY3Rpb24gcm91dGVVbm9idHJ1c2l2ZShlKSB7CgkJaWYgKGUuY3RybEtleSB8fCBlLm1ldGFLZXkgfHwgZS53aGljaCA9PSAyKSByZXR1cm4KCQllLnByZXZlbnREZWZhdWx0KCkKCQltLnJvdXRlKGUuY3VycmVudFRhcmdldFttLnJvdXRlLm1vZGVdLnNsaWNlKG1vZGVzW20ucm91dGUubW9kZV0ubGVuZ3RoKSkKCX0KCWZ1bmN0aW9uIHNjcm9sbFRvSGFzaCgpIHsKCQlpZiAobS5yb3V0ZS5tb2RlICE9ICJoYXNoIiAmJiB3aW5kb3cubG9jYXRpb24uaGFzaCkgd2luZG93LmxvY2F0aW9uLmhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaAoJfQoJCgkvL21vZGVsCgltLnByb3AgPSBmdW5jdGlvbihzdG9yZSkgewoJCXZhciBwcm9wID0gZnVuY3Rpb24oKSB7CgkJCWlmIChhcmd1bWVudHMubGVuZ3RoKSBzdG9yZSA9IGFyZ3VtZW50c1swXQoJCQlyZXR1cm4gc3RvcmUKCQl9CgkJcHJvcC50b0pTT04gPSBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHN0b3JlCgkJfQoJCXJldHVybiBwcm9wCgl9CgoJbS5kZWZlcnJlZCA9IGZ1bmN0aW9uKCkgewoJCXZhciByZXNvbHZlcnMgPSBbXSwgcmVqZWN0ZXJzID0gW10KCQl2YXIgb2JqZWN0ID0gewoJCQlyZXNvbHZlOiBmdW5jdGlvbih2YWx1ZSkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCByZXNvbHZlcnMubGVuZ3RoOyBpKyspIHJlc29sdmVyc1tpXSh2YWx1ZSkKCQkJfSwKCQkJcmVqZWN0OiBmdW5jdGlvbih2YWx1ZSkgewoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCByZWplY3RlcnMubGVuZ3RoOyBpKyspIHJlamVjdGVyc1tpXSh2YWx1ZSkKCQkJfSwKCQkJcHJvbWlzZTogbS5wcm9wKCkKCQl9CgkJb2JqZWN0LnByb21pc2UucmVzb2x2ZXJzID0gcmVzb2x2ZXJzCgkJb2JqZWN0LnByb21pc2UudGhlbiA9IGZ1bmN0aW9uKHN1Y2Nlc3MsIGVycm9yKSB7CgkJCXZhciBuZXh0ID0gbS5kZWZlcnJlZCgpCgkJCWlmICghc3VjY2Vzcykgc3VjY2VzcyA9IGlkZW50aXR5CgkJCWlmICghZXJyb3IpIGVycm9yID0gaWRlbnRpdHkKCQkJZnVuY3Rpb24gcHVzaChsaXN0LCBtZXRob2QsIGNhbGxiYWNrKSB7CgkJCQlsaXN0LnB1c2goZnVuY3Rpb24odmFsdWUpIHsKCQkJCQl0cnkgewoJCQkJCQl2YXIgcmVzdWx0ID0gY2FsbGJhY2sodmFsdWUpCgkJCQkJCWlmIChyZXN1bHQgJiYgdHlwZW9mIHJlc3VsdC50aGVuID09ICJmdW5jdGlvbiIpIHJlc3VsdC50aGVuKG5leHRbbWV0aG9kXSwgZXJyb3IpCgkJCQkJCWVsc2UgbmV4dFttZXRob2RdKHJlc3VsdCAhPT0gdW5kZWZpbmVkID8gcmVzdWx0IDogdmFsdWUpCgkJCQkJfQoJCQkJCWNhdGNoIChlKSB7CgkJCQkJCWlmIChlIGluc3RhbmNlb2YgRXJyb3IgJiYgZS5jb25zdHJ1Y3RvciAhPT0gRXJyb3IpIHRocm93IGUKCQkJCQkJZWxzZSBuZXh0LnJlamVjdChlKQoJCQkJCX0KCQkJCX0pCgkJCX0KCQkJcHVzaChyZXNvbHZlcnMsICJyZXNvbHZlIiwgc3VjY2VzcykKCQkJcHVzaChyZWplY3RlcnMsICJyZWplY3QiLCBlcnJvcikKCQkJcmV0dXJuIG5leHQucHJvbWlzZQoJCX0KCQlyZXR1cm4gb2JqZWN0Cgl9CgltLnN5bmMgPSBmdW5jdGlvbihhcmdzKSB7CgkJdmFyIG1ldGhvZCA9ICJyZXNvbHZlIgoJCWZ1bmN0aW9uIHN5bmNocm9uaXplcihyZXNvbHZlZCkgewoJCQlyZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKCQkJCXJlc3VsdHMucHVzaCh2YWx1ZSkKCQkJCWlmICghcmVzb2x2ZWQpIG1ldGhvZCA9ICJyZWplY3QiCgkJCQlpZiAocmVzdWx0cy5sZW5ndGggPT0gYXJncy5sZW5ndGgpIHsKCQkJCQlkZWZlcnJlZC5wcm9taXNlKHJlc3VsdHMpCgkJCQkJZGVmZXJyZWRbbWV0aG9kXShyZXN1bHRzKQoJCQkJfQoJCQkJcmV0dXJuIHZhbHVlCgkJCX0KCQl9CgkJCgkJdmFyIGRlZmVycmVkID0gbS5kZWZlcnJlZCgpCgkJdmFyIHJlc3VsdHMgPSBbXQoJCWZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewoJCQlhcmdzW2ldLnRoZW4oc3luY2hyb25pemVyKHRydWUpLCBzeW5jaHJvbml6ZXIoZmFsc2UpKQoJCX0KCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZQoJfQoJZnVuY3Rpb24gaWRlbnRpdHkodmFsdWUpIHtyZXR1cm4gdmFsdWV9CgoJZnVuY3Rpb24gYWpheChvcHRpb25zKSB7CgkJdmFyIHhociA9IHdpbmRvdy5YRG9tYWluUmVxdWVzdCA/IG5ldyB3aW5kb3cuWERvbWFpblJlcXVlc3QgOiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0CgkJeGhyLm9wZW4ob3B0aW9ucy5tZXRob2QsIG9wdGlvbnMudXJsLCB0cnVlLCBvcHRpb25zLnVzZXIsIG9wdGlvbnMucGFzc3dvcmQpCgkJeGhyLm9ubG9hZCA9IHR5cGVvZiBvcHRpb25zLm9ubG9hZCA9PSAiZnVuY3Rpb24iID8gb3B0aW9ucy5vbmxvYWQgOiBmdW5jdGlvbigpIHt9CgkJeGhyLm9uZXJyb3IgPSB0eXBlb2Ygb3B0aW9ucy5vbmVycm9yID09ICJmdW5jdGlvbiIgPyBvcHRpb25zLm9uZXJyb3IgOiBmdW5jdGlvbigpIHt9CgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQlpZiAoeGhyLnJlYWR5U3RhdGUgPT09IDQgJiYgeGhyLnN0YXR1cyA9PT0gMCkgewoJCQkJeGhyLm9uZXJyb3Ioe3R5cGU6ICJlcnJvciIsIHRhcmdldDogeGhyfSkKCQkJfQoJCX0KCQlpZiAodHlwZW9mIG9wdGlvbnMuY29uZmlnID09ICJmdW5jdGlvbiIpIG9wdGlvbnMuY29uZmlnKHhociwgb3B0aW9ucykKCQl4aHIuc2VuZChvcHRpb25zLmRhdGEpCgkJcmV0dXJuIHhocgoJfQoJZnVuY3Rpb24gcXVlcnlzdHJpbmcob2JqZWN0LCBwcmVmaXgpIHsKCQl2YXIgc3RyID0gW10KCQlmb3IodmFyIHByb3AgaW4gb2JqZWN0KSB7CgkJCXZhciBrZXkgPSBwcmVmaXggPyBwcmVmaXggKyAiWyIgKyBwcm9wICsgIl0iIDogcHJvcCwgdmFsdWUgPSBvYmplY3RbcHJvcF0KCQkJc3RyLnB1c2godHlwZW9mIHZhbHVlID09ICJvYmplY3QiID8gcXVlcnlzdHJpbmcodmFsdWUsIGtleSkgOiBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSkpCgkJfQoJCXJldHVybiBzdHIuam9pbigiJiIpCgl9CglmdW5jdGlvbiBiaW5kRGF0YSh4aHJPcHRpb25zLCBkYXRhLCBzZXJpYWxpemUpIHsKCQlpZiAoZGF0YSAmJiBPYmplY3Qua2V5cyhkYXRhKS5sZW5ndGggPiAwKSB7CgkJCWlmICh4aHJPcHRpb25zLm1ldGhvZCA9PSAiR0VUIikgewoJCQkJeGhyT3B0aW9ucy51cmwgPSB4aHJPcHRpb25zLnVybCArICh4aHJPcHRpb25zLnVybC5pbmRleE9mKCI/IikgPCAwID8gIj8iIDogIiYiKSArIHF1ZXJ5c3RyaW5nKGRhdGEpCgkJCX0KCQkJZWxzZSB4aHJPcHRpb25zLmRhdGEgPSBzZXJpYWxpemUoZGF0YSkKCQl9CgkJcmV0dXJuIHhock9wdGlvbnMKCX0KCWZ1bmN0aW9uIHBhcmFtZXRlcml6ZVVybCh1cmwsIGRhdGEpIHsKCQl2YXIgdG9rZW5zID0gdXJsLm1hdGNoKC86W2Etel1cdysvZ2kpCgkJaWYgKHRva2VucyAmJiBkYXRhKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7CgkJCQl2YXIga2V5ID0gdG9rZW5zW2ldLnNsaWNlKDEpCgkJCQl1cmwgPSB1cmwucmVwbGFjZSh0b2tlbnNbaV0sIGRhdGFba2V5XSkKCQkJCWRlbGV0ZSBkYXRhW2tleV0KCQkJfQoJCX0KCQlyZXR1cm4gdXJsCgl9CgoJbS5yZXF1ZXN0ID0gZnVuY3Rpb24oeGhyT3B0aW9ucykgewoJCWlmICh4aHJPcHRpb25zLmJhY2tncm91bmQgIT09IHRydWUpIG0uc3RhcnRDb21wdXRhdGlvbigpCgkJdmFyIGRlZmVycmVkID0gbS5kZWZlcnJlZCgpCgkJdmFyIHNlcmlhbGl6ZSA9IHhock9wdGlvbnMuc2VyaWFsaXplIHx8IEpTT04uc3RyaW5naWZ5CgkJdmFyIGRlc2VyaWFsaXplID0geGhyT3B0aW9ucy5kZXNlcmlhbGl6ZSB8fCBKU09OLnBhcnNlCgkJdmFyIGV4dHJhY3QgPSB4aHJPcHRpb25zLmV4dHJhY3QgfHwgZnVuY3Rpb24oeGhyKSB7CgkJCXJldHVybiB4aHIucmVzcG9uc2VUZXh0Lmxlbmd0aCA9PT0gMCAmJiBkZXNlcmlhbGl6ZSA9PT0gSlNPTi5wYXJzZSA/IG51bGwgOiB4aHIucmVzcG9uc2VUZXh0CgkJfQoJCXhock9wdGlvbnMudXJsID0gcGFyYW1ldGVyaXplVXJsKHhock9wdGlvbnMudXJsLCB4aHJPcHRpb25zLmRhdGEpCgkJeGhyT3B0aW9ucyA9IGJpbmREYXRhKHhock9wdGlvbnMsIHhock9wdGlvbnMuZGF0YSwgc2VyaWFsaXplKQoJCXhock9wdGlvbnMub25sb2FkID0geGhyT3B0aW9ucy5vbmVycm9yID0gZnVuY3Rpb24oZSkgewoJCQl2YXIgdW53cmFwID0gKGUudHlwZSA9PSAibG9hZCIgPyB4aHJPcHRpb25zLnVud3JhcFN1Y2Nlc3MgOiB4aHJPcHRpb25zLnVud3JhcEVycm9yKSB8fCBpZGVudGl0eQoJCQl2YXIgcmVzcG9uc2UgPSB1bndyYXAoZGVzZXJpYWxpemUoZXh0cmFjdChlLnRhcmdldCwgeGhyT3B0aW9ucykpKQoJCQlpZiAocmVzcG9uc2UgaW5zdGFuY2VvZiBBcnJheSAmJiB4aHJPcHRpb25zLnR5cGUpIHsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgcmVzcG9uc2UubGVuZ3RoOyBpKyspIHJlc3BvbnNlW2ldID0gbmV3IHhock9wdGlvbnMudHlwZShyZXNwb25zZVtpXSkKCQkJfQoJCQllbHNlIGlmICh4aHJPcHRpb25zLnR5cGUpIHJlc3BvbnNlID0gbmV3IHhock9wdGlvbnMudHlwZShyZXNwb25zZSkKCQkJZGVmZXJyZWQucHJvbWlzZShyZXNwb25zZSkKCQkJZGVmZXJyZWRbZS50eXBlID09ICJsb2FkIiA/ICJyZXNvbHZlIiA6ICJyZWplY3QiXShyZXNwb25zZSkKCQkJaWYgKHhock9wdGlvbnMuYmFja2dyb3VuZCAhPT0gdHJ1ZSkgbS5lbmRDb21wdXRhdGlvbigpCgkJfQoJCWFqYXgoeGhyT3B0aW9ucykKCQlkZWZlcnJlZC5wcm9taXNlLnRoZW4gPSBwcm9wQmluZGVyKGRlZmVycmVkLnByb21pc2UpCgkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UKCX0KCWZ1bmN0aW9uIHByb3BCaW5kZXIocHJvbWlzZSkgewoJCXZhciBiaW5kID0gcHJvbWlzZS50aGVuCgkJcmV0dXJuIGZ1bmN0aW9uKHN1Y2Nlc3MsIGVycm9yKSB7CgkJCXZhciBuZXh0ID0gYmluZChmdW5jdGlvbih2YWx1ZSkge3JldHVybiBuZXh0KHN1Y2Nlc3ModmFsdWUpKX0sIGZ1bmN0aW9uKHZhbHVlKSB7cmV0dXJuIG5leHQoZXJyb3IodmFsdWUpKX0pCgkJCW5leHQudGhlbiA9IHByb3BCaW5kZXIobmV4dCkKCQkJcmV0dXJuIG5leHQKCQl9Cgl9CgkKCS8vdGVzdGluZyBBUEkKCW0uZGVwcyA9IGZ1bmN0aW9uKG1vY2spIHtyZXR1cm4gd2luZG93ID0gbW9ja30KCS8vZm9yIGludGVybmFsIHRlc3Rpbmcgb25seSwgZG8gbm90IHVzZSBgbS5kZXBzLmZhY3RvcnlgCgltLmRlcHMuZmFjdG9yeSA9IGFwcAoJCglyZXR1cm4gbQp9KHRoaXMpCgppZiAodHlwZW9mIG1vZHVsZSAhPSAidW5kZWZpbmVkIiAmJiBtb2R1bGUgIT09IG51bGwpIG1vZHVsZS5leHBvcnRzID0gbQppZiAodHlwZW9mIGRlZmluZSA9PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIGRlZmluZShmdW5jdGlvbigpIHtyZXR1cm4gbX0pCgpmdW5jdGlvbiB0ZXN0KGNvbmRpdGlvbikgewoJdHJ5IHtpZiAoIWNvbmRpdGlvbigpKSB0aHJvdyBuZXcgRXJyb3J9CgljYXRjaCAoZSkge2NvbnNvbGUuZXJyb3IoZSk7dGVzdC5mYWlsdXJlcy5wdXNoKGNvbmRpdGlvbil9Cgl0ZXN0LnRvdGFsKysKfQp0ZXN0LnRvdGFsID0gMAp0ZXN0LmZhaWx1cmVzID0gW10KdGVzdC5wcmludCA9IGZ1bmN0aW9uKHByaW50KSB7Cglmb3IgKHZhciBpID0gMDsgaSA8IHRlc3QuZmFpbHVyZXMubGVuZ3RoOyBpKyspIHsKCQlwcmludCh0ZXN0LmZhaWx1cmVzW2ldLnRvU3RyaW5nKCkpCgl9CglwcmludCgidGVzdHM6ICIgKyB0ZXN0LnRvdGFsICsgIlxuZmFpbHVyZXM6ICIgKyB0ZXN0LmZhaWx1cmVzLmxlbmd0aCkKCQoJaWYgKHRlc3QuZmFpbHVyZXMubGVuZ3RoID4gMCkgewoJCXRocm93IG5ldyBFcnJvcih0ZXN0LmZhaWx1cmVzLmxlbmd0aCArICIgdGVzdHMgZGlkIG5vdCBwYXNzIikKCX0KfQoKdmFyIG1vY2sgPSB7fQptb2NrLndpbmRvdyA9IG5ldyBmdW5jdGlvbigpIHsKCXZhciB3aW5kb3cgPSB7fQoJd2luZG93LmRvY3VtZW50ID0ge30KCXdpbmRvdy5kb2N1bWVudC5jaGlsZE5vZGVzID0gW10KCXdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50ID0gZnVuY3Rpb24odGFnKSB7CgkJcmV0dXJuIHsKCQkJY2hpbGROb2RlczogW10sCgkJCW5vZGVOYW1lOiB0YWcudG9VcHBlckNhc2UoKSwKCQkJYXBwZW5kQ2hpbGQ6IHdpbmRvdy5kb2N1bWVudC5hcHBlbmRDaGlsZCwKCQkJcmVtb3ZlQ2hpbGQ6IHdpbmRvdy5kb2N1bWVudC5yZW1vdmVDaGlsZCwKCQkJcmVwbGFjZUNoaWxkOiB3aW5kb3cuZG9jdW1lbnQucmVwbGFjZUNoaWxkLAoJCQlpbnNlcnRCZWZvcmU6IGZ1bmN0aW9uKG5vZGUsIHJlZmVyZW5jZSkgewoJCQkJbm9kZS5wYXJlbnROb2RlID0gdGhpcwoJCQkJdmFyIHJlZmVyZW5jZUluZGV4ID0gdGhpcy5jaGlsZE5vZGVzLmluZGV4T2YocmVmZXJlbmNlKQoJCQkJaWYgKHJlZmVyZW5jZUluZGV4IDwgMCkgdGhpcy5jaGlsZE5vZGVzLnB1c2gobm9kZSkKCQkJCWVsc2UgewoJCQkJCXZhciBpbmRleCA9IHRoaXMuY2hpbGROb2Rlcy5pbmRleE9mKG5vZGUpCgkJCQkJdGhpcy5jaGlsZE5vZGVzLnNwbGljZShyZWZlcmVuY2VJbmRleCwgaW5kZXggPCAwID8gMCA6IDEsIG5vZGUpCgkJCQl9CgkJCX0sCgkJCWluc2VydEFkamFjZW50SFRNTDogZnVuY3Rpb24ocG9zaXRpb24sIGh0bWwpIHsKCQkJCS8vdG9kbzogYWNjZXB0IG1hcmt1cAoJCQkJaWYgKHBvc2l0aW9uID09ICJiZWZvcmViZWdpbiIpIHsKCQkJCQl0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHdpbmRvdy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShodG1sKSwgdGhpcykKCQkJCX0KCQkJCWVsc2UgaWYgKHBvc2l0aW9uID09ICJiZWZvcmVlbmQiKSB7CgkJCQkJdGhpcy5hcHBlbmRDaGlsZCh3aW5kb3cuZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoaHRtbCkpCgkJCQl9CgkJCX0sCgkJCXNldEF0dHJpYnV0ZTogZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKCQkJCXRoaXNbbmFtZV0gPSB2YWx1ZS50b1N0cmluZygpCgkJCX0sCgkJCXNldEF0dHJpYnV0ZU5TOiBmdW5jdGlvbihuYW1lc3BhY2UsIG5hbWUsIHZhbHVlKSB7CgkJCQl0aGlzLm5hbWVzcGFjZVVSSSA9IG5hbWVzcGFjZQoJCQkJdGhpc1tuYW1lXSA9IHZhbHVlLnRvU3RyaW5nKCkKCQkJfSwKCQkJZ2V0QXR0cmlidXRlOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewoJCQkJcmV0dXJuIHRoaXNbbmFtZV0KCQkJfQoJCX0KCX0KCXdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMgPSBmdW5jdGlvbihuYW1lc3BhY2UsIHRhZykgewoJCXZhciBlbGVtZW50ID0gd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnKQoJCWVsZW1lbnQubmFtZXNwYWNlVVJJID0gbmFtZXNwYWNlCgkJcmV0dXJuIGVsZW1lbnQKCX0KCXdpbmRvdy5kb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSA9IGZ1bmN0aW9uKHRleHQpIHsKCQlyZXR1cm4ge25vZGVWYWx1ZTogdGV4dC50b1N0cmluZygpfQoJfQoJd2luZG93LmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJodG1sIikKCXdpbmRvdy5kb2N1bWVudC5yZXBsYWNlQ2hpbGQgPSBmdW5jdGlvbihuZXdDaGlsZCwgb2xkQ2hpbGQpIHsKCQl2YXIgaW5kZXggPSB0aGlzLmNoaWxkTm9kZXMuaW5kZXhPZihvbGRDaGlsZCkKCQlpZiAoaW5kZXggPiAtMSkgdGhpcy5jaGlsZE5vZGVzLnNwbGljZShpbmRleCwgMSwgbmV3Q2hpbGQpCgkJZWxzZSB0aGlzLmNoaWxkTm9kZXMucHVzaChuZXdDaGlsZCkKCQluZXdDaGlsZC5wYXJlbnROb2RlID0gdGhpcwoJCW9sZENoaWxkLnBhcmVudE5vZGUgPSBudWxsCgl9Cgl3aW5kb3cuZG9jdW1lbnQuYXBwZW5kQ2hpbGQgPSBmdW5jdGlvbihjaGlsZCkgewoJCXZhciBpbmRleCA9IHRoaXMuY2hpbGROb2Rlcy5pbmRleE9mKGNoaWxkKQoJCWlmIChpbmRleCA+IC0xKSB0aGlzLmNoaWxkTm9kZXMuc3BsaWNlKGluZGV4LCAxKQoJCXRoaXMuY2hpbGROb2Rlcy5wdXNoKGNoaWxkKQoJCWNoaWxkLnBhcmVudE5vZGUgPSB0aGlzCgl9Cgl3aW5kb3cuZG9jdW1lbnQucmVtb3ZlQ2hpbGQgPSBmdW5jdGlvbihjaGlsZCkgewoJCXZhciBpbmRleCA9IHRoaXMuY2hpbGROb2Rlcy5pbmRleE9mKGNoaWxkKQoJCXRoaXMuY2hpbGROb2Rlcy5zcGxpY2UoaW5kZXgsIDEpCgkJY2hpbGQucGFyZW50Tm9kZSA9IG51bGwKCX0KCXdpbmRvdy5wZXJmb3JtYW5jZSA9IG5ldyBmdW5jdGlvbiAoKSB7CgkJdmFyIHRpbWVzdGFtcCA9IDUwCgkJdGhpcy4kZWxhcHNlID0gZnVuY3Rpb24oYW1vdW50KSB7dGltZXN0YW1wICs9IGFtb3VudH0KCQl0aGlzLm5vdyA9IGZ1bmN0aW9uKCkge3JldHVybiB0aW1lc3RhbXB9Cgl9Cgl3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSBmdW5jdGlvbigpIHt9Cgl3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gZnVuY3Rpb24oY2FsbGJhY2spIHt3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lLiRjYWxsYmFjayA9IGNhbGxiYWNrfQoJd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZS4kcmVzb2x2ZSA9IGZ1bmN0aW9uKCkgewoJCWlmICh3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lLiRjYWxsYmFjaykgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZS4kY2FsbGJhY2soKQoJCXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUuJGNhbGxiYWNrID0gbnVsbAoJCXdpbmRvdy5wZXJmb3JtYW5jZS4kZWxhcHNlKDIwKQoJfQoJd2luZG93LlhNTEh0dHBSZXF1ZXN0ID0gbmV3IGZ1bmN0aW9uKCkgewoJCXZhciByZXF1ZXN0ID0gZnVuY3Rpb24oKSB7CgkJCXRoaXMub3BlbiA9IGZ1bmN0aW9uKG1ldGhvZCwgdXJsKSB7CgkJCQl0aGlzLm1ldGhvZCA9IG1ldGhvZAoJCQkJdGhpcy51cmwgPSB1cmwKCQkJfQoJCQl0aGlzLnNlbmQgPSBmdW5jdGlvbigpIHsKCQkJCXRoaXMucmVzcG9uc2VUZXh0ID0gSlNPTi5zdHJpbmdpZnkodGhpcykKCQkJCXJlcXVlc3QuJGV2ZW50cy5wdXNoKHt0eXBlOiAibG9hZCIsIHRhcmdldDogdGhpc30pCgkJCX0KCQl9CgkJcmVxdWVzdC4kZXZlbnRzID0gW10KCQlyZXR1cm4gcmVxdWVzdAoJfQoJd2luZG93LmxvY2F0aW9uID0ge3NlYXJjaDogIiIsIHBhdGhuYW1lOiAiIiwgaGFzaDogIiJ9LAoJd2luZG93Lmhpc3RvcnkgPSB7fQoJd2luZG93Lmhpc3RvcnkucHVzaFN0YXRlID0gZnVuY3Rpb24oZGF0YSwgdGl0bGUsIHVybCkgewoJCXdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHVybAoJfSwKCXdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSA9IGZ1bmN0aW9uKGRhdGEsIHRpdGxlLCB1cmwpIHsKCQl3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgPSB3aW5kb3cubG9jYXRpb24uc2VhcmNoID0gd2luZG93LmxvY2F0aW9uLmhhc2ggPSB1cmwKCX0KCXJldHVybiB3aW5kb3cKfQpmdW5jdGlvbiB0ZXN0TWl0aHJpbChtb2NrKSB7CgltLmRlcHMobW9jaykKCQoJLy9tCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJkaXYiKS50YWcgPT09ICJkaXYifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oIi5mb28iKS50YWcgPT09ICJkaXYifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oIi5mb28iKS5hdHRycy5jbGFzc05hbWUgPT09ICJmb28ifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oIlt0aXRsZT1iYXJdIikudGFnID09PSAiZGl2In0pCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJbdGl0bGU9YmFyXSIpLmF0dHJzLnRpdGxlID09PSAiYmFyIn0pCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJbdGl0bGU9XCdiYXJcJ10iKS5hdHRycy50aXRsZSA9PT0gImJhciJ9KQoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbSgiW3RpdGxlPVwiYmFyXCJdIikuYXR0cnMudGl0bGUgPT09ICJiYXIifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oImRpdiIsICJ0ZXN0IikuY2hpbGRyZW4gPT09ICJ0ZXN0In0pCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJkaXYiLCBbInRlc3QiXSkuY2hpbGRyZW5bMF0gPT09ICJ0ZXN0In0pCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJkaXYiLCB7dGl0bGU6ICJiYXIifSwgInRlc3QiKS5hdHRycy50aXRsZSA9PT0gImJhciJ9KQoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbSgiZGl2Iiwge3RpdGxlOiAiYmFyIn0sICJ0ZXN0IikuY2hpbGRyZW4gPT09ICJ0ZXN0In0pCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJkaXYiLCB7dGl0bGU6ICJiYXIifSwgWyJ0ZXN0Il0pLmNoaWxkcmVuWzBdID09PSAidGVzdCJ9KQoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbSgiZGl2Iiwge3RpdGxlOiAiYmFyIn0sIG0oImRpdiIpKS5jaGlsZHJlbi50YWcgPT09ICJkaXYifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oImRpdiIsIHt0aXRsZTogImJhciJ9LCBbbSgiZGl2IildKS5jaGlsZHJlblswXS50YWcgPT09ICJkaXYifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oImRpdiIsIFsiYSIsICJiIl0pLmNoaWxkcmVuLmxlbmd0aCA9PT0gMn0pCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJkaXYiLCBbbSgiZGl2IildKS5jaGlsZHJlblswXS50YWcgPT09ICJkaXYifSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oImRpdiIsIG0oImRpdiIpKS5hdHRycy50YWcgPT09ICJkaXYifSkgLy95ZXMsIHRoaXMgaXMgZXhwZWN0ZWQgYmVoYXZpb3I6IHNlZSBtZXRob2Qgc2lnbmF0dXJlCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJkaXYiLCBbdW5kZWZpbmVkXSkudGFnID09PSAiZGl2In0pCgl0ZXN0KGZ1bmN0aW9uKCkge3JldHVybiBtKCJkaXYiLCBbe2ZvbzogImJhciJ9XSl9KSAvL2FzIGxvbmcgYXMgaXQgZG9lc24ndCB0aHJvdyBlcnJvcnMsIGl0J3MgZmluZQoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbSgic3ZnIiwgW20oImciKV0pfSkKCXRlc3QoZnVuY3Rpb24oKSB7cmV0dXJuIG0oInN2ZyIsIFttKCJhW2hyZWY9J2h0dHA6Ly9nb29nbGUuY29tJ10iKV0pfSkKCgkvL20ubW9kdWxlCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkKCQkKCQl2YXIgcm9vdDEgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5tb2R1bGUocm9vdDEsIHsKCQkJY29udHJvbGxlcjogZnVuY3Rpb24oKSB7dGhpcy52YWx1ZSA9ICJ0ZXN0MSJ9LAoJCQl2aWV3OiBmdW5jdGlvbihjdHJsKSB7cmV0dXJuIGN0cmwudmFsdWV9CgkJfSkKCQkKCQl2YXIgcm9vdDIgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5tb2R1bGUocm9vdDIsIHsKCQkJY29udHJvbGxlcjogZnVuY3Rpb24oKSB7dGhpcy52YWx1ZSA9ICJ0ZXN0MiJ9LAoJCQl2aWV3OiBmdW5jdGlvbihjdHJsKSB7cmV0dXJuIGN0cmwudmFsdWV9CgkJfSkKCQkKCQltb2NrLnJlcXVlc3RBbmltYXRpb25GcmFtZS4kcmVzb2x2ZSgpCgkJCgkJcmV0dXJuIHJvb3QxLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAidGVzdDEiICYmIHJvb3QyLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAidGVzdDIiCgl9KQoKCS8vbS53aXRoQXR0cgoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgdmFsdWUKCQl2YXIgaGFuZGxlciA9IG0ud2l0aEF0dHIoInRlc3QiLCBmdW5jdGlvbihkYXRhKSB7dmFsdWUgPSBkYXRhfSkKCQloYW5kbGVyKHtjdXJyZW50VGFyZ2V0OiB7dGVzdDogImZvbyJ9fSkKCQlyZXR1cm4gdmFsdWUgPT09ICJmb28iCgl9KQoKCS8vbS50cnVzdAoJdGVzdChmdW5jdGlvbigpIHtyZXR1cm4gbS50cnVzdCgidGVzdCIpLnZhbHVlT2YoKSA9PT0gInRlc3QifSkKCgkvL20ucmVuZGVyCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsICJ0ZXN0IikKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gInRlc3QiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJkaXYiLCB7Y2xhc3M6ICJhIn0pKQoJCXZhciBlbGVtZW50QmVmb3JlID0gcm9vdC5jaGlsZE5vZGVzWzBdCgkJbS5yZW5kZXIocm9vdCwgbSgiZGl2Iiwge2NsYXNzOiAiYiJ9KSkKCQl2YXIgZWxlbWVudEFmdGVyID0gcm9vdC5jaGlsZE5vZGVzWzBdCgkJcmV0dXJuIGVsZW1lbnRCZWZvcmUgPT09IGVsZW1lbnRBZnRlcgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgiLmEiKSkKCQl2YXIgZWxlbWVudEJlZm9yZSA9IHJvb3QuY2hpbGROb2Rlc1swXQoJCW0ucmVuZGVyKHJvb3QsIG0oIi5iIikpCgkJdmFyIGVsZW1lbnRBZnRlciA9IHJvb3QuY2hpbGROb2Rlc1swXQoJCXJldHVybiBlbGVtZW50QmVmb3JlID09PSBlbGVtZW50QWZ0ZXIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oImRpdiIsIHtpZDogImEifSkpCgkJdmFyIGVsZW1lbnRCZWZvcmUgPSByb290LmNoaWxkTm9kZXNbMF0KCQltLnJlbmRlcihyb290LCBtKCJkaXYiLCB7dGl0bGU6ICJiIn0pKQoJCXZhciBlbGVtZW50QWZ0ZXIgPSByb290LmNoaWxkTm9kZXNbMF0KCQlyZXR1cm4gZWxlbWVudEJlZm9yZSAhPT0gZWxlbWVudEFmdGVyCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCIjYSIpKQoJCXZhciBlbGVtZW50QmVmb3JlID0gcm9vdC5jaGlsZE5vZGVzWzBdCgkJbS5yZW5kZXIocm9vdCwgbSgiW3RpdGxlPWJdIikpCgkJdmFyIGVsZW1lbnRBZnRlciA9IHJvb3QuY2hpbGROb2Rlc1swXQoJCXJldHVybiBlbGVtZW50QmVmb3JlICE9PSBlbGVtZW50QWZ0ZXIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNhIikpCgkJdmFyIGVsZW1lbnRCZWZvcmUgPSByb290LmNoaWxkTm9kZXNbMF0KCQltLnJlbmRlcihyb290LCAidGVzdCIpCgkJdmFyIGVsZW1lbnRBZnRlciA9IHJvb3QuY2hpbGROb2Rlc1swXQoJCXJldHVybiBlbGVtZW50QmVmb3JlICE9PSBlbGVtZW50QWZ0ZXIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oImRpdiIsIFt1bmRlZmluZWRdKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgic3ZnIiwgW20oImciKV0pKQoJCXZhciBnID0gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0KCQlyZXR1cm4gZy5ub2RlTmFtZSA9PT0gIkciICYmIGcubmFtZXNwYWNlVVJJID09ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oInN2ZyIsIFttKCJhW2hyZWY9J2h0dHA6Ly9nb29nbGUuY29tJ10iKV0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5ub2RlTmFtZSA9PT0gIkEiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJkaXYuY2xhc3NuYW1lIiwgW20oImEiLCB7aHJlZjogIi9maXJzdCJ9KV0pKQoJCW0ucmVuZGVyKHJvb3QsIG0oImRpdiIsIFttKCJhIiwge2hyZWY6ICIvc2Vjb25kIn0pXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzLmxlbmd0aCA9PSAxCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJ1bCIsIFttKCJsaSIpXSkpCgkJbS5yZW5kZXIocm9vdCwgbSgidWwiLCBbbSgibGkiKSwgdW5kZWZpbmVkXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzFdLm5vZGVWYWx1ZSA9PT0gIiIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oInVsIiwgW20oImxpIiksIG0oImxpIildKSkKCQltLnJlbmRlcihyb290LCBtKCJ1bCIsIFttKCJsaSIpLCB1bmRlZmluZWRdKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMV0ubm9kZVZhbHVlID09PSAiIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgidWwiLCBbbSgibGkiKV0pKQoJCW0ucmVuZGVyKHJvb3QsIG0oInVsIiwgW3VuZGVmaW5lZF0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICIiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJ1bCIsIFttKCJsaSIpXSkpCgkJbS5yZW5kZXIocm9vdCwgbSgidWwiLCBbe31dKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXMubGVuZ3RoID09PSAwCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJ1bCIsIFttKCJsaSIsIFttKCJhIildKV0pKQoJCW0ucmVuZGVyKHJvb3QsIG0oInVsIiwgW3tzdWJ0cmVlOiAicmV0YWluIn1dKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5ub2RlTmFtZSA9PT0gIkEiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvNDMKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJhIiwge2NvbmZpZzogbS5yb3V0ZX0sICJ0ZXN0IikpCgkJbS5yZW5kZXIocm9vdCwgbSgiYSIsIHtjb25maWc6IG0ucm91dGV9LCAidGVzdCIpKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJ0ZXN0IgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzI5CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJdmFyIGxpc3QgPSBbZmFsc2UsIGZhbHNlXQoJCW0ucmVuZGVyKHJvb3QsIGxpc3QucmV2ZXJzZSgpLm1hcChmdW5jdGlvbihmbGFnLCBpbmRleCkgewoJCQlyZXR1cm4gbSgiaW5wdXRbdHlwZT1jaGVja2JveF0iLCB7b25jbGljazogbS53aXRoQXR0cigiY2hlY2tlZCIsIGZ1bmN0aW9uKHZhbHVlKSB7bGlzdFtpbmRleF0gPSB2YWx1ZX0pLCBjaGVja2VkOiBmbGFnfSkKCQl9KSkKCQkKCQltb2NrLmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPSByb290LmNoaWxkTm9kZXNbMF0KCQlyb290LmNoaWxkTm9kZXNbMF0uY2hlY2tlZCA9IHRydWUKCQlyb290LmNoaWxkTm9kZXNbMF0ub25jbGljayh7Y3VycmVudFRhcmdldDoge2NoZWNrZWQ6IHRydWV9fSkKCQkKCQltLnJlbmRlcihyb290LCBsaXN0LnJldmVyc2UoKS5tYXAoZnVuY3Rpb24oZmxhZywgaW5kZXgpIHsKCQkJcmV0dXJuIG0oImlucHV0W3R5cGU9Y2hlY2tib3hdIiwge29uY2xpY2s6IG0ud2l0aEF0dHIoImNoZWNrZWQiLCBmdW5jdGlvbih2YWx1ZSkge2xpc3RbaW5kZXhdID0gdmFsdWV9KSwgY2hlY2tlZDogZmxhZ30pCgkJfSkpCgkJCgkJbW9jay5kb2N1bWVudC5hY3RpdmVFbGVtZW50ID0gbnVsbAoJCQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hlY2tlZCA9PT0gZmFsc2UgJiYgcm9vdC5jaGlsZE5vZGVzWzFdLmNoZWNrZWQgPT09IHRydWUKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy80NCAoMSkKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCIjZm9vIiwgW251bGwsIG0oIiNiYXIiKV0pKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbInRlc3QiLCBtKCIjYmFyIildKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAidGVzdCIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy80NCAoMikKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCIjZm9vIiwgW251bGwsIG0oIiNiYXIiKV0pKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbbSgiZGl2IiksIG0oIiNiYXIiKV0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5ub2RlTmFtZSA9PT0gIkRJViIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy80NCAoMykKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCIjZm9vIiwgWyJ0ZXN0IiwgbSgiI2JhciIpXSkpCgkJbS5yZW5kZXIocm9vdCwgbSgiI2ZvbyIsIFttKCJkaXYiKSwgbSgiI2JhciIpXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLm5vZGVOYW1lID09PSAiRElWIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzQ0ICg0KQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbbSgiZGl2IiksIG0oIiNiYXIiKV0pKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbInRlc3QiLCBtKCIjYmFyIildKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAidGVzdCIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy80NCAoNSkKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCIjZm9vIiwgW20oIiNiYXIiKV0pKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbbSgiI2JhciIpLCBbbSgiI2JheiIpXV0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1sxXS5pZCA9PT0gImJheiIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy80OAoJCXZhciByb290ID0gbW9jay5kb2N1bWVudAoJCW0ucmVuZGVyKHJvb3QsIG0oImh0bWwiLCBbbSgiI2ZvbyIpXSkpCgkJdmFyIHJlc3VsdCA9IHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLmlkID09PSAiZm9vIgoJCXJvb3QuY2hpbGROb2RlcyA9IFttb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImh0bWwiKV0KCQlyZXR1cm4gcmVzdWx0Cgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvNDkKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJhIiwgInRlc3QiKSkKCQltLnJlbmRlcihyb290LCBtKCJhLmZvbyIsICJ0ZXN0IikpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gInRlc3QiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvNDkKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJhLmZvbyIsICJ0ZXN0IikpCgkJbS5yZW5kZXIocm9vdCwgbSgiYSIsICJ0ZXN0IikpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gInRlc3QiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvNDkKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJhLmZvbyIsICJ0ZXN0IikpCgkJbS5yZW5kZXIocm9vdCwgbSgiYSIsICJ0ZXN0MSIpKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJ0ZXN0MSIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy80OQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oImEiLCAidGVzdCIpKQoJCW0ucmVuZGVyKHJvb3QsIG0oImEiLCAidGVzdDEiKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAidGVzdDEiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvNTAKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCIjZm9vIiwgW1ttKCJkaXYiLCAiYSIpLCBtKCJkaXYiLCAiYiIpXSwgbSgiI2JhciIpXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzFdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiYiIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy81MAoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbW20oImRpdiIsICJhIiksIG0oImRpdiIsICJiIildLCBtKCIjYmFyIildKSkKCQltLnJlbmRlcihyb290LCBtKCIjZm9vIiwgW1ttKCJkaXYiLCAiYSIpLCBtKCJkaXYiLCAiYiIpLCBtKCJkaXYiLCAiYyIpXSwgbSgiI2JhciIpXSkpCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzJdLmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiYyIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy81MAoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIiNmb28iLCBbW20oImRpdiIsICJhIiksIG0oImRpdiIsICJiIildLCBbbSgiZGl2IiwgImMiKSwgbSgiZGl2IiwgImQiKV0sIG0oIiNiYXIiKV0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1szXS5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gImQiICYmIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzRdLmlkID09PSAiYmFyIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzUwCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgiI2ZvbyIsIFtbbSgiZGl2IiwgImEiKSwgbSgiZGl2IiwgImIiKV0sICJ0ZXN0Il0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1sxXS5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gImIiICYmIHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzJdLm5vZGVWYWx1ZSA9PT0gInRlc3QiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvNTAKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCIjZm9vIiwgW1siYSIsICJiIl0sICJ0ZXN0Il0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1sxXS5ub2RlVmFsdWUgPT09ICJiIiAmJiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1syXS5ub2RlVmFsdWUgPT09ICJ0ZXN0IgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzUxCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgibWFpbiIsIFttKCJidXR0b24iKSwgbSgiYXJ0aWNsZSIsIFttKCJzZWN0aW9uIiksIG0oIm5hdiIpXSldKSkKCQltLnJlbmRlcihyb290LCBtKCJtYWluIiwgW20oImJ1dHRvbiIpLCBtKCJhcnRpY2xlIiwgW20oInNwYW4iKSwgbSgibmF2IildKV0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1sxXS5jaGlsZE5vZGVzWzBdLm5vZGVOYW1lID09PSAiU1BBTiIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy81MQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oIm1haW4iLCBbbSgiYnV0dG9uIiksIG0oImFydGljbGUiLCBbbSgic2VjdGlvbiIpLCBtKCJuYXYiKV0pXSkpCgkJbS5yZW5kZXIocm9vdCwgbSgibWFpbiIsIFttKCJidXR0b24iKSwgbSgiYXJ0aWNsZSIsIFsidGVzdCIsIG0oIm5hdiIpXSldKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMV0uY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJ0ZXN0IgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzUxCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgbSgibWFpbiIsIFttKCJidXR0b24iKSwgbSgiYXJ0aWNsZSIsIFttKCJzZWN0aW9uIiksIG0oIm5hdiIpXSldKSkKCQltLnJlbmRlcihyb290LCBtKCJtYWluIiwgW20oImJ1dHRvbiIpLCBtKCJhcnRpY2xlIiwgW20udHJ1c3QoInRlc3QiKSwgbSgibmF2IildKV0pKQoJCXJldHVybiByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1sxXS5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gInRlc3QiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQkvL2h0dHBzOi8vZ2l0aHViLmNvbS9saG9yaWUvbWl0aHJpbC5qcy9pc3N1ZXMvNTUKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCIjYSIpKQoJCXZhciBlbGVtZW50QmVmb3JlID0gcm9vdC5jaGlsZE5vZGVzWzBdCgkJbS5yZW5kZXIocm9vdCwgbSgiI2IiKSkKCQl2YXIgZWxlbWVudEFmdGVyID0gcm9vdC5jaGlsZE5vZGVzWzBdCgkJcmV0dXJuIGVsZW1lbnRCZWZvcmUgIT09IGVsZW1lbnRBZnRlcgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJLy9odHRwczovL2dpdGh1Yi5jb20vbGhvcmllL21pdGhyaWwuanMvaXNzdWVzLzU2CgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yZW5kZXIocm9vdCwgW251bGwsICJmb28iXSkKCQltLnJlbmRlcihyb290LCBbImJhciJdKQoJCXJldHVybiByb290LmNoaWxkTm9kZXMubGVuZ3RoID09IDEKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy81NgoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oImRpdiIsICJmb28iKSkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzLmxlbmd0aCA9PSAxCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJlbmRlcihyb290LCBtKCJkaXYiLCBbbSgiYnV0dG9uIiksIG0oInVsIildKSkKCQl2YXIgdmFsdWVCZWZvcmUgPSByb290LmNoaWxkTm9kZXNbMF0uY2hpbGROb2Rlc1swXS5ub2RlTmFtZQoJCW0ucmVuZGVyKHJvb3QsIG0oImRpdiIsIFt1bmRlZmluZWQsIG0oInVsIildKSkKCQl2YXIgdmFsdWVBZnRlciA9IHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZQoJCXJldHVybiB2YWx1ZUJlZm9yZSA9PT0gIkJVVFRPTiIgJiYgdmFsdWVBZnRlciA9PT0gIiIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucmVuZGVyKHJvb3QsIG0oImRpdiIsIFttKCJ1bCIpLCB1bmRlZmluZWRdKSkKCQl2YXIgdmFsdWVCZWZvcmUxID0gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMF0ubm9kZU5hbWUKCQl2YXIgdmFsdWVCZWZvcmUyID0gcm9vdC5jaGlsZE5vZGVzWzBdLmNoaWxkTm9kZXNbMV0ubm9kZVZhbHVlCgkJbS5yZW5kZXIocm9vdCwgbSgiZGl2IiwgW3VuZGVmaW5lZCwgbSgidWwiKV0pKQoJCXZhciB2YWx1ZUFmdGVyMSA9IHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZQoJCXZhciB2YWx1ZUFmdGVyMiA9IHJvb3QuY2hpbGROb2Rlc1swXS5jaGlsZE5vZGVzWzFdLm5vZGVOYW1lCgkJcmV0dXJuIHZhbHVlQmVmb3JlMSA9PT0gIlVMIiAmJiB2YWx1ZUFmdGVyMSA9PT0gIiIgJiYgdmFsdWVCZWZvcmUyID09PSAiIiAmJiB2YWx1ZUFmdGVyMiA9PT0gIlVMIgoJfSkKCS8vZW5kIG0ucmVuZGVyCgkKCS8vbS5yZWRyYXcKCXRlc3QoZnVuY3Rpb24oKSB7CgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3NldHVwCgkJdmFyIGNvbnRyb2xsZXIKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLm1vZHVsZShyb290LCB7CgkJCWNvbnRyb2xsZXI6IGZ1bmN0aW9uKCkge2NvbnRyb2xsZXIgPSB0aGlzfSwKCQkJdmlldzogZnVuY3Rpb24oY3RybCkge3JldHVybiBjdHJsLnZhbHVlfQoJCX0pCgkJY29udHJvbGxlci52YWx1ZSA9ICJmb28iCgkJbS5yZWRyYXcoKQoJCXZhciB2YWx1ZUJlZm9yZSA9IHJvb3QuY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApCgkJbS5yZWRyYXcoKQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy90ZWFyZG93bgoJCXJldHVybiB2YWx1ZUJlZm9yZSA9PT0gIiIgJiYgcm9vdC5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gImZvbyIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy9zZXR1cAoJCXZhciBjb3VudCA9IDAKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLm1vZHVsZShyb290LCB7CgkJCWNvbnRyb2xsZXI6IGZ1bmN0aW9uKCkge30sCgkJCXZpZXc6IGZ1bmN0aW9uKGN0cmwpIHsKCQkJCWNvdW50KysKCQkJfQoJCX0pCgkJbS5yZWRyYXcoKQoJCW0ucmVkcmF3KCkKCQltLnJlZHJhdygpCgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKQoJCW0ucmVkcmF3KCkKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vdGVhcmRvd24KCQlyZXR1cm4gY291bnQgPT09IDIKCX0pCgoJLy9tLnJvdXRlCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy9zZXR1cAoJCW1vY2subG9jYXRpb24uc2VhcmNoID0gIj8iCgkJCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yb3V0ZS5tb2RlID0gInNlYXJjaCIKCQltLnJvdXRlKHJvb3QsICIvdGVzdDEiLCB7CgkJCSIvdGVzdDEiOiB7Y29udHJvbGxlcjogZnVuY3Rpb24oKSB7fSwgdmlldzogZnVuY3Rpb24oKSB7cmV0dXJuICJmb28ifX0KCQl9KQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy90ZWFyZG93bgoJCXJldHVybiBtb2NrLmxvY2F0aW9uLnNlYXJjaCA9PSAiPy90ZXN0MSIgJiYgcm9vdC5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gImZvbyIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy9zZXR1cAoJCW1vY2subG9jYXRpb24ucGF0aG5hbWUgPSAiLyIKCQkKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJvdXRlLm1vZGUgPSAicGF0aG5hbWUiCgkJbS5yb3V0ZShyb290LCAiL3Rlc3QyIiwgewoJCQkiL3Rlc3QyIjoge2NvbnRyb2xsZXI6IGZ1bmN0aW9uKCkge30sIHZpZXc6IGZ1bmN0aW9uKCkge3JldHVybiAiZm9vIn19CgkJfSkKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vdGVhcmRvd24KCQlyZXR1cm4gbW9jay5sb2NhdGlvbi5wYXRobmFtZSA9PSAiL3Rlc3QyIiAmJiByb290LmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiZm9vIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3NldHVwCgkJbW9jay5sb2NhdGlvbi5oYXNoID0gIiMiCgkJCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yb3V0ZS5tb2RlID0gImhhc2giCgkJbS5yb3V0ZShyb290LCAiL3Rlc3QzIiwgewoJCQkiL3Rlc3QzIjoge2NvbnRyb2xsZXI6IGZ1bmN0aW9uKCkge30sIHZpZXc6IGZ1bmN0aW9uKCkge3JldHVybiAiZm9vIn19CgkJfSkKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vdGVhcmRvd24KCQlyZXR1cm4gbW9jay5sb2NhdGlvbi5oYXNoID09ICIjL3Rlc3QzIiAmJiByb290LmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiZm9vIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3NldHVwCgkJbW9jay5sb2NhdGlvbi5zZWFyY2ggPSAiPyIKCQkKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJvdXRlLm1vZGUgPSAic2VhcmNoIgoJCW0ucm91dGUocm9vdCwgIi90ZXN0NC9mb28iLCB7CgkJCSIvdGVzdDQvOnRlc3QiOiB7Y29udHJvbGxlcjogZnVuY3Rpb24oKSB7fSwgdmlldzogZnVuY3Rpb24oKSB7cmV0dXJuIG0ucm91dGUucGFyYW0oInRlc3QiKX19CgkJfSkKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vdGVhcmRvd24KCQlyZXR1cm4gbW9jay5sb2NhdGlvbi5zZWFyY2ggPT0gIj8vdGVzdDQvZm9vIiAmJiByb290LmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiZm9vIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3NldHVwCgkJbW9jay5sb2NhdGlvbi5zZWFyY2ggPSAiPyIKCQkKCQl2YXIgbW9kdWxlID0ge2NvbnRyb2xsZXI6IGZ1bmN0aW9uKCkge30sIHZpZXc6IGZ1bmN0aW9uKCkge3JldHVybiBtLnJvdXRlLnBhcmFtKCJ0ZXN0Iil9fQoJCQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucm91dGUubW9kZSA9ICJzZWFyY2giCgkJbS5yb3V0ZShyb290LCAiL3Rlc3Q1L2ZvbyIsIHsKCQkJIi8iOiBtb2R1bGUsCgkJCSIvdGVzdDUvOnRlc3QiOiBtb2R1bGUKCQl9KQoJCXZhciBwYXJhbVZhbHVlQmVmb3JlID0gbS5yb3V0ZS5wYXJhbSgidGVzdCIpCgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKQoJCW0ucm91dGUoIi8iKQoJCXZhciBwYXJhbVZhbHVlQWZ0ZXIgPSBtLnJvdXRlLnBhcmFtKCJ0ZXN0IikKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vdGVhcmRvd24KCQlyZXR1cm4gbW9jay5sb2NhdGlvbi5zZWFyY2ggPT0gIj8vIiAmJiBwYXJhbVZhbHVlQmVmb3JlID09PSAiZm9vIiAmJiBwYXJhbVZhbHVlQWZ0ZXIgPT09IHVuZGVmaW5lZAoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3NldHVwCgkJbW9jay5sb2NhdGlvbi5zZWFyY2ggPSAiPyIKCQkKCQl2YXIgbW9kdWxlID0ge2NvbnRyb2xsZXI6IGZ1bmN0aW9uKCkge30sIHZpZXc6IGZ1bmN0aW9uKCkge3JldHVybiBtLnJvdXRlLnBhcmFtKCJhMSIpfX0KCQkKCQl2YXIgcm9vdCA9IG1vY2suZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikKCQltLnJvdXRlLm1vZGUgPSAic2VhcmNoIgoJCW0ucm91dGUocm9vdCwgIi90ZXN0Ni9mb28iLCB7CgkJCSIvIjogbW9kdWxlLAoJCQkiL3Rlc3Q2LzphMSI6IG1vZHVsZQoJCX0pCgkJdmFyIHBhcmFtVmFsdWVCZWZvcmUgPSBtLnJvdXRlLnBhcmFtKCJhMSIpCgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKQoJCW0ucm91dGUoIi8iKQoJCXZhciBwYXJhbVZhbHVlQWZ0ZXIgPSBtLnJvdXRlLnBhcmFtKCJhMSIpCgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3RlYXJkb3duCgkJcmV0dXJuIG1vY2subG9jYXRpb24uc2VhcmNoID09ICI/LyIgJiYgcGFyYW1WYWx1ZUJlZm9yZSA9PT0gImZvbyIgJiYgcGFyYW1WYWx1ZUFmdGVyID09PSB1bmRlZmluZWQKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCS8vaHR0cHM6Ly9naXRodWIuY29tL2xob3JpZS9taXRocmlsLmpzL2lzc3Vlcy82MQoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkgLy9zZXR1cAoJCW1vY2subG9jYXRpb24uc2VhcmNoID0gIj8iCgkJCgkJdmFyIG1vZHVsZSA9IHtjb250cm9sbGVyOiBmdW5jdGlvbigpIHt9LCB2aWV3OiBmdW5jdGlvbigpIHtyZXR1cm4gbS5yb3V0ZS5wYXJhbSgiYTEiKX19CgkJCgkJdmFyIHJvb3QgPSBtb2NrLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpCgkJbS5yb3V0ZS5tb2RlID0gInNlYXJjaCIKCQltLnJvdXRlKHJvb3QsICIvdGVzdDcvZm9vIiwgewoJCQkiLyI6IG1vZHVsZSwKCQkJIi90ZXN0Ny86YTEiOiBtb2R1bGUKCQl9KQoJCXZhciByb3V0ZVZhbHVlQmVmb3JlID0gbS5yb3V0ZSgpCgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKQoJCW0ucm91dGUoIi8iKQoJCXZhciByb3V0ZVZhbHVlQWZ0ZXIgPSBtLnJvdXRlKCkKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vdGVhcmRvd24KCQlyZXR1cm4gcm91dGVWYWx1ZUJlZm9yZSA9PT0gIi90ZXN0Ny9mb28iICYmIHJvdXRlVmFsdWVBZnRlciA9PT0gIi8iCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vc2V0dXAKCQltb2NrLmxvY2F0aW9uLnNlYXJjaCA9ICI/IgoJCQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucm91dGUubW9kZSA9ICJzZWFyY2giCgkJbS5yb3V0ZShyb290LCAiL3Rlc3Q4L2Zvby9TRVAvYmFyL2JheiIsIHsKCQkJIi90ZXN0OC86dGVzdC9TRVAvOnBhdGguLi4iOiB7CgkJCQljb250cm9sbGVyOiBmdW5jdGlvbigpIHt9LAoJCQkJdmlldzogZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIG0ucm91dGUucGFyYW0oInRlc3QiKSArICJfIiArIG0ucm91dGUucGFyYW0oInBhdGgiKQoJCQkJfQoJCQl9CgkJfSkKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vdGVhcmRvd24KCQlyZXR1cm4gbW9jay5sb2NhdGlvbi5zZWFyY2ggPT0gIj8vdGVzdDgvZm9vL1NFUC9iYXIvYmF6IiAmJiByb290LmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiZm9vX2Jhci9iYXoiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vc2V0dXAKCQltb2NrLmxvY2F0aW9uLnNlYXJjaCA9ICI/IgoJCQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucm91dGUubW9kZSA9ICJzZWFyY2giCgkJbS5yb3V0ZShyb290LCAiL3Rlc3Q5L2Zvby9iYXIvU0VQL2JheiIsIHsKCQkJIi90ZXN0OS86dGVzdC4uLi9TRVAvOnBhdGgiOiB7CgkJCQljb250cm9sbGVyOiBmdW5jdGlvbigpIHt9LAoJCQkJdmlldzogZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIG0ucm91dGUucGFyYW0oInRlc3QiKSArICJfIiArIG0ucm91dGUucGFyYW0oInBhdGgiKQoJCQkJfQoJCQl9CgkJfSkKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vdGVhcmRvd24KCQlyZXR1cm4gbW9jay5sb2NhdGlvbi5zZWFyY2ggPT0gIj8vdGVzdDkvZm9vL2Jhci9TRVAvYmF6IiAmJiByb290LmNoaWxkTm9kZXNbMF0ubm9kZVZhbHVlID09PSAiZm9vL2Jhcl9iYXoiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApIC8vc2V0dXAKCQltb2NrLmxvY2F0aW9uLnNlYXJjaCA9ICI/IgoJCQoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ucm91dGUubW9kZSA9ICJzZWFyY2giCgkJbS5yb3V0ZShyb290LCAiL3Rlc3QxMC9mb28lMjBiYXIiLCB7CgkJCSIvdGVzdDEwLzp0ZXN0IjogewoJCQkJY29udHJvbGxlcjogZnVuY3Rpb24oKSB7fSwKCQkJCXZpZXc6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBtLnJvdXRlLnBhcmFtKCJ0ZXN0IikKCQkJCX0KCQkJfQoJCX0pCgkJbW9jay5wZXJmb3JtYW5jZS4kZWxhcHNlKDUwKSAvL3RlYXJkb3duCgkJcmV0dXJuIHJvb3QuY2hpbGROb2Rlc1swXS5ub2RlVmFsdWUgPT09ICJmb28gYmFyIgoJfSkKCS8vZW5kIG0ucm91dGUKCgkvL20ucHJvcAoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcHJvcCA9IG0ucHJvcCgidGVzdCIpCgkJcmV0dXJuIHByb3AoKSA9PT0gInRlc3QiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcHJvcCA9IG0ucHJvcCgidGVzdCIpCgkJcHJvcCgiZm9vIikKCQlyZXR1cm4gcHJvcCgpID09PSAiZm9vIgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHByb3AgPSBtLnByb3AoInRlc3QiKQoJCXJldHVybiBKU09OLnN0cmluZ2lmeShwcm9wKSA9PT0gJyJ0ZXN0IicKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciBvYmogPSB7cHJvcDogbS5wcm9wKCJ0ZXN0Iil9CgkJcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaikgPT09ICd7InByb3AiOiJ0ZXN0In0nCgl9KQoKCS8vbS5yZXF1ZXN0Cgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciBwcm9wID0gbS5yZXF1ZXN0KHttZXRob2Q6ICJHRVQiLCB1cmw6ICJ0ZXN0In0pCgkJdmFyIGUgPSBtb2NrLlhNTEh0dHBSZXF1ZXN0LiRldmVudHMucG9wKCkKCQllLnRhcmdldC5vbmxvYWQoZSkKCQlyZXR1cm4gcHJvcCgpLm1ldGhvZCA9PT0gIkdFVCIgJiYgcHJvcCgpLnVybCA9PT0gInRlc3QiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcHJvcCA9IG0ucmVxdWVzdCh7bWV0aG9kOiAiR0VUIiwgdXJsOiAidGVzdCJ9KS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7cmV0dXJuICJmb28ifSkKCQl2YXIgZSA9IG1vY2suWE1MSHR0cFJlcXVlc3QuJGV2ZW50cy5wb3AoKQoJCWUudGFyZ2V0Lm9ubG9hZChlKQoJCXJldHVybiBwcm9wKCkgPT09ICJmb28iCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcHJvcCA9IG0ucmVxdWVzdCh7bWV0aG9kOiAiUE9TVCIsIHVybDogImh0dHA6Ly9kb21haW4uY29tOjgwIiwgZGF0YToge319KS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7cmV0dXJuIHZhbHVlfSkKCQl2YXIgZSA9IG1vY2suWE1MSHR0cFJlcXVlc3QuJGV2ZW50cy5wb3AoKQoJCWUudGFyZ2V0Lm9ubG9hZChlKQoJCXJldHVybiBwcm9wKCkudXJsID09PSAiaHR0cDovL2RvbWFpbi5jb206ODAiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgcHJvcCA9IG0ucmVxdWVzdCh7bWV0aG9kOiAiUE9TVCIsIHVybDogImh0dHA6Ly9kb21haW4uY29tOjgwLzp0ZXN0MSIsIGRhdGE6IHt0ZXN0MTogImZvbyJ9fSkudGhlbihmdW5jdGlvbih2YWx1ZSkge3JldHVybiB2YWx1ZX0pCgkJdmFyIGUgPSBtb2NrLlhNTEh0dHBSZXF1ZXN0LiRldmVudHMucG9wKCkKCQllLnRhcmdldC5vbmxvYWQoZSkKCQlyZXR1cm4gcHJvcCgpLnVybCA9PT0gImh0dHA6Ly9kb21haW4uY29tOjgwL2ZvbyIKCX0pCgoJLy9tLmRlZmVycmVkCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciB2YWx1ZQoJCXZhciBkZWZlcnJlZCA9IG0uZGVmZXJyZWQoKQoJCWRlZmVycmVkLnByb21pc2UudGhlbihmdW5jdGlvbihkYXRhKSB7dmFsdWUgPSBkYXRhfSkKCQlkZWZlcnJlZC5yZXNvbHZlKCJ0ZXN0IikKCQlyZXR1cm4gdmFsdWUgPT09ICJ0ZXN0IgoJfSkKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHZhbHVlCgkJdmFyIGRlZmVycmVkID0gbS5kZWZlcnJlZCgpCgkJZGVmZXJyZWQucHJvbWlzZS50aGVuKGZ1bmN0aW9uKGRhdGEpIHtyZXR1cm4gImZvbyJ9KS50aGVuKGZ1bmN0aW9uKGRhdGEpIHt2YWx1ZSA9IGRhdGF9KQoJCWRlZmVycmVkLnJlc29sdmUoInRlc3QiKQoJCXJldHVybiB2YWx1ZSA9PT0gImZvbyIKCX0pCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCXZhciB2YWx1ZQoJCXZhciBkZWZlcnJlZCA9IG0uZGVmZXJyZWQoKQoJCWRlZmVycmVkLnByb21pc2UudGhlbihudWxsLCBmdW5jdGlvbihkYXRhKSB7dmFsdWUgPSBkYXRhfSkKCQlkZWZlcnJlZC5yZWplY3QoInRlc3QiKQoJCXJldHVybiB2YWx1ZSA9PT0gInRlc3QiCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgdmFsdWUKCQl2YXIgZGVmZXJyZWQgPSBtLmRlZmVycmVkKCkKCQlkZWZlcnJlZC5wcm9taXNlLnRoZW4obnVsbCwgZnVuY3Rpb24oZGF0YSkge3JldHVybiAiZm9vIn0pLnRoZW4obnVsbCwgZnVuY3Rpb24oZGF0YSkge3ZhbHVlID0gZGF0YX0pCgkJZGVmZXJyZWQucmVqZWN0KCJ0ZXN0IikKCQlyZXR1cm4gdmFsdWUgPT09ICJmb28iCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgdmFsdWUxLCB2YWx1ZTIKCQl2YXIgZGVmZXJyZWQgPSBtLmRlZmVycmVkKCkKCQlkZWZlcnJlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24oZGF0YSkge3Rocm93IG5ldyBFcnJvcn0pLnRoZW4oZnVuY3Rpb24oZGF0YSkge3ZhbHVlMSA9IDF9LCBmdW5jdGlvbihkYXRhKSB7dmFsdWUyID0gZGF0YX0pCgkJZGVmZXJyZWQucmVzb2x2ZSgidGVzdCIpCgkJcmV0dXJuIHZhbHVlMSA9PT0gdW5kZWZpbmVkICYmIHZhbHVlMiBpbnN0YW5jZW9mIEVycm9yCgl9KQoJdGVzdChmdW5jdGlvbigpIHsKCQl2YXIgZGVmZXJyZWQxID0gbS5kZWZlcnJlZCgpCgkJdmFyIGRlZmVycmVkMiA9IG0uZGVmZXJyZWQoKQoJCXZhciB2YWx1ZTEsIHZhbHVlMgoJCWRlZmVycmVkMS5wcm9taXNlLnRoZW4oZnVuY3Rpb24oZGF0YSkgewoJCQl2YWx1ZTEgPSBkYXRhCgkJCXJldHVybiBkZWZlcnJlZDIucHJvbWlzZQoJCX0pLnRoZW4oZnVuY3Rpb24oZGF0YSkgewoJCQl2YWx1ZTIgPSBkYXRhCgkJfSkKCQlkZWZlcnJlZDEucmVzb2x2ZSgxKQoJCWRlZmVycmVkMi5yZXNvbHZlKDIpCgkJcmV0dXJuIHZhbHVlMSA9PT0gMSAmJiB2YWx1ZTIgPT09IDIKCX0pCgoJLy9tLnN5bmMKCXRlc3QoZnVuY3Rpb24oKSB7CgkJdmFyIHZhbHVlCgkJdmFyIGRlZmVycmVkMSA9IG0uZGVmZXJyZWQoKQoJCXZhciBkZWZlcnJlZDIgPSBtLmRlZmVycmVkKCkKCQltLnN5bmMoW2RlZmVycmVkMS5wcm9taXNlLCBkZWZlcnJlZDIucHJvbWlzZV0pLnRoZW4oZnVuY3Rpb24oZGF0YSkge3ZhbHVlID0gZGF0YX0pCgkJZGVmZXJyZWQxLnJlc29sdmUoInRlc3QiKQoJCWRlZmVycmVkMi5yZXNvbHZlKCJmb28iKQoJCXJldHVybiB2YWx1ZVswXSA9PT0gInRlc3QiICYmIHZhbHVlWzFdID09PSAiZm9vIgoJfSkKCgkvL20uc3RhcnRDb21wdXRhdGlvbi9tLmVuZENvbXB1dGF0aW9uCgl0ZXN0KGZ1bmN0aW9uKCkgewoJCW1vY2sucGVyZm9ybWFuY2UuJGVsYXBzZSg1MCkKCQkKCQl2YXIgY29udHJvbGxlcgoJCXZhciByb290ID0gbW9jay5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKQoJCW0ubW9kdWxlKHJvb3QsIHsKCQkJY29udHJvbGxlcjogZnVuY3Rpb24oKSB7Y29udHJvbGxlciA9IHRoaXN9LAoJCQl2aWV3OiBmdW5jdGlvbihjdHJsKSB7cmV0dXJuIGN0cmwudmFsdWV9CgkJfSkKCQkKCQltb2NrLnBlcmZvcm1hbmNlLiRlbGFwc2UoNTApCgkJCgkJbS5zdGFydENvbXB1dGF0aW9uKCkKCQljb250cm9sbGVyLnZhbHVlID0gImZvbyIKCQltLmVuZENvbXB1dGF0aW9uKCkKCQlyZXR1cm4gcm9vdC5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9PT0gImZvbyIKCX0pCgkKCS8vY29uc29sZS5sb2cgcHJlc2VuY2UKCXRlc3QoZnVuY3Rpb24oKSB7CgkJcmV0dXJuIG0uZGVwcy5mYWN0b3J5LnRvU3RyaW5nKCkuaW5kZXhPZigiY29uc29sZSIpIDwgMAoJfSkKfQoKLy9tb2Nrcwp0ZXN0TWl0aHJpbChtb2NrLndpbmRvdykKCnRlc3QucHJpbnQoY29uc29sZS5sb2cp",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 16:12:05 GMT",
                    "Content-Length": "44763",
                    "Date": "Fri, 07 Nov 2014 16:12:06 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}