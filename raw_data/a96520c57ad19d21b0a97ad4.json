{
    "url": "http://localhost:9999/Jalalhejazi/HTML5-SuperTemplate/public/SuperTemplate/js/SuperTemplate.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.location.search</b> and written to <b>history.pushState()</b> via the following statement:<ul><li>history.pushState(null, null, window.location.search + $(this).attr('href'));</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/Jalalhejazi/HTML5-SuperTemplate/public/SuperTemplate/js/SuperTemplate.js",
                "path": "/Jalalhejazi/HTML5-SuperTemplate/public/SuperTemplate/js/SuperTemplate.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9KYWxhbGhlamF6aS9IVE1MNS1TdXBlclRlbXBsYXRlL3B1YmxpYy9TdXBlclRlbXBsYXRlL2pzL1N1cGVyVGVtcGxhdGUuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTAzNjM2DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDAzOjI1OjI4IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwMzoyNToyNyBHTVQNCg0KLyoKCUhUTUw1IFN1cGVyVGVtcGxhdGUgYnkgSmFsYWwgSGVqYXppIDIwMTQgCglTdXBlclRlbXBsYXRlLmpzCiovCgpqUXVlcnkoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCQpIHsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoJCU1FTlUgRHJvcGRvd25zCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgICAkKCd1bC5tZW51JykuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAvLyBhZGQgdGhlIG1lbnUgdG9nZ2xlCiAgICAgICAgJCh0aGlzKS5wcmVwZW5kKCc8bGkgY2xhc3M9Im1lbnUtdG9nZ2xlIj48YSBocmVmPSIjIj48c3BhbiBjbGFzcz0iaWNvbiIgZGF0YS1pY29uPSJZIj48L3NwYW4+IE1lbnU8L2E+PC9saT4nKTsKCiAgICAgICAgLy8gZmluZCBtZW51IGl0ZW1zIHdpdGggY2hpbGRyZW4uCiAgICAgICAgJCh0aGlzKS5maW5kKCdsaScpLmhhcygndWwnKS5hZGRDbGFzcygnaGFzLW1lbnUnKQogICAgICAgICAgICAuZmluZCgnYTpmaXJzdCcpLmFwcGVuZCgnPHNwYW4gY2xhc3M9ImFycm93Ij4mbmJzcDs8L3NwYW4+Jyk7CiAgICB9KTsKCiAgICAkKCd1bC5tZW51IGxpJykuaG92ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICQodGhpcykuZmluZCgndWw6Zmlyc3QnKS5zdG9wKHRydWUsIHRydWUpLmZhZGVJbignZmFzdCcpOwogICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCdob3ZlcicpOwogICAgICAgIH0sCiAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICQodGhpcykuZmluZCgndWwnKS5zdG9wKHRydWUsIHRydWUpLmZhZGVPdXQoJ3Nsb3cnKTsKICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmVDbGFzcygnaG92ZXInKTsKICAgICAgICB9KTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoJCVNsaWRlc2hvdwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogICAgJCgnLnNsaWRlc2hvdycpLmJ4U2xpZGVyKHsKICAgICAgICBtb2RlOiAnaG9yaXpvbnRhbCcsIC8vICdob3Jpem9udGFsJywgJ3ZlcnRpY2FsJywgJ2ZhZGUnCiAgICAgICAgdmlkZW86IHRydWUsCiAgICAgICAgdXNlQ1NTOiB0cnVlLAogICAgICAgIHBhZ2VyOiB0cnVlLAogICAgICAgIHNwZWVkOiA1MDAsIC8vIHRyYW5zaXRpb24gdGltZQogICAgICAgIHN0YXJ0U2xpZGU6IDAsCiAgICAgICAgaW5maW5pdGVMb29wOiB0cnVlLAogICAgICAgIGNhcHRpb25zOiB0cnVlLAogICAgICAgIGFkYXB0aXZlSGVpZ2h0OiBmYWxzZSwKICAgICAgICB0b3VjaEVuYWJsZWQ6IHRydWUsCiAgICAgICAgcGF1c2U6IDQwMDAsCiAgICAgICAgYXV0b0NvbnRyb2xzOiBmYWxzZSwKICAgICAgICBjb250cm9sczogZmFsc2UsCiAgICAgICAgYXV0b1N0YXJ0OiB0cnVlLAogICAgICAgIGF1dG86IHRydWUKICAgIH0pOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkJRmFuY3lib3ggTGlnaHRib3gKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgICQoJy5nYWxsZXJ5JykuZWFjaChmdW5jdGlvbihpKSB7CiAgICAgICAgJCh0aGlzKS5maW5kKCdhJykuYXR0cigncmVsJywgJ2dhbGxlcnknICsgaSkKICAgICAgICAgICAgLmZhbmN5Ym94KHsKICAgICAgICAgICAgICAgIG92ZXJsYXlPcGFjaXR5OiAwLjIsCiAgICAgICAgICAgICAgICBvdmVybGF5Q29sb3I6ICcjMDAwJwogICAgICAgICAgICB9KTsKICAgIH0pOwoKICAgIC8vIGxpZ2h0Ym94IGxpbmtzCiAgICAkKCdhLmxpZ2h0Ym94JykuZmFuY3lib3goewogICAgICAgIG92ZXJsYXlPcGFjaXR5OiAwLjIsCiAgICAgICAgb3ZlcmxheUNvbG9yOiAnIzAwMCcKICAgIH0pOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkJVGFicwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogICAgLy8gdGFiIHNldHVwCiAgICAkKCcudGFiLWNvbnRlbnQnKS5hZGRDbGFzcygnY2xlYXJmaXgnKS5ub3QoJzpmaXJzdCcpLmhpZGUoKTsKICAgICQoJ3VsLnRhYnMnKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjdXJyZW50ID0gJCh0aGlzKS5maW5kKCdsaS5jdXJyZW50Jyk7CiAgICAgICAgaWYgKGN1cnJlbnQubGVuZ3RoIDwgMSkgewogICAgICAgICAgICAkKHRoaXMpLmZpbmQoJ2xpOmZpcnN0JykuYWRkQ2xhc3MoJ2N1cnJlbnQnKTsKICAgICAgICB9CiAgICAgICAgY3VycmVudCA9ICQodGhpcykuZmluZCgnbGkuY3VycmVudCBhJykuYXR0cignaHJlZicpOwogICAgICAgICQoY3VycmVudCkuc2hvdygpOwogICAgfSk7CgogICAgLy8gdGFiIGNsaWNrCiAgICAkKGRvY3VtZW50KS5vbignY2xpY2snLCAndWwudGFicyBhW2hyZWZePSIjIl0nLCBmdW5jdGlvbihlKSB7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZhciB0YWJzID0gJCh0aGlzKS5wYXJlbnRzKCd1bC50YWJzJykuZmluZCgnbGknKTsKICAgICAgICB2YXIgdGFiX25leHQgPSAkKHRoaXMpLmF0dHIoJ2hyZWYnKTsKICAgICAgICB2YXIgdGFiX2N1cnJlbnQgPSB0YWJzLmZpbHRlcignLmN1cnJlbnQnKS5maW5kKCdhJykuYXR0cignaHJlZicpOwogICAgICAgICQodGFiX2N1cnJlbnQpLmhpZGUoKTsKICAgICAgICB0YWJzLnJlbW92ZUNsYXNzKCdjdXJyZW50Jyk7CiAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5hZGRDbGFzcygnY3VycmVudCcpOwogICAgICAgICQodGFiX25leHQpLnNob3coKTsKICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZShudWxsLCBudWxsLCB3aW5kb3cubG9jYXRpb24uc2VhcmNoICsgJCh0aGlzKS5hdHRyKCdocmVmJykpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0pOwoKICAgIC8vIHRhYiBoYXNodGFnIGlkZW50aWZpY2F0aW9uIGFuZCBhdXRvLWZvY3VzCiAgICB2YXIgd2FudGVkVGFnID0gd2luZG93LmxvY2F0aW9uLmhhc2g7CiAgICBpZiAod2FudGVkVGFnICE9ICIiKSB7CiAgICAgICAgLy8gVGhpcyBjb2RlIGNhbiBhbmQgZG9lcyBmYWlsLCBoYXJkLCBraWxsaW5nIHRoZSBlbnRpcmUgYXBwLgogICAgICAgIC8vIEVzcC4gd2hlbiB1c2VkIHdpdGggdGhlIGpRdWVyeS5BZGRyZXNzIHByb2plY3QuCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGFsbFRhYnMgPSAkKCJ1bC50YWJzIGFbaHJlZl49IiArIHdhbnRlZFRhZyArICJdIikucGFyZW50cygndWwudGFicycpLmZpbmQoJ2xpJyk7CiAgICAgICAgICAgIHZhciBkZWZhdWx0VGFiID0gYWxsVGFicy5maWx0ZXIoJy5jdXJyZW50JykuZmluZCgnYScpLmF0dHIoJ2hyZWYnKTsKICAgICAgICAgICAgJChkZWZhdWx0VGFiKS5oaWRlKCk7CiAgICAgICAgICAgIGFsbFRhYnMucmVtb3ZlQ2xhc3MoJ2N1cnJlbnQnKTsKICAgICAgICAgICAgJCgidWwudGFicyBhW2hyZWZePSIgKyB3YW50ZWRUYWcgKyAiXSIpLnBhcmVudCgpLmFkZENsYXNzKCdjdXJyZW50Jyk7CiAgICAgICAgICAgICQoIiMiICsgd2FudGVkVGFnLnJlcGxhY2UoJyMnLCAnJykpLnNob3coKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIC8vIEkgaGF2ZSBubyBpZGVhIHdoYXQgdG8gZG8gaGVyZSwgc28gSSdtIGxlYXZpbmcgdGhpcyBmb3IgdGhlIG1haW50YWluZXIuCiAgICAgICAgfQogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkJSW1hZ2UgQ2FwdGlvbgoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogICAgJCgnaW1nLmNhcHRpb24nKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICQodGhpcykud3JhcCgnPGRpdiBjbGFzcz0iY2FwdGlvbiI+Jyk7CiAgICAgICAgJCh0aGlzKS5wYXJlbnRzKCdkaXYuY2FwdGlvbicpCiAgICAgICAgICAgIC5hdHRyKCdjbGFzcycsICdpbWctd3JhcCAnICsgJCh0aGlzKS5hdHRyKCdjbGFzcycpKTsKICAgICAgICBpZiAoJCh0aGlzKS5hdHRyKCd0aXRsZScpKSB7CiAgICAgICAgICAgICQodGhpcykucGFyZW50cygnZGl2LmNhcHRpb24nKQogICAgICAgICAgICAgICAgLmFwcGVuZCgnPHNwYW4+JyArICQodGhpcykuYXR0cigndGl0bGUnKSArICc8L3NwYW4+Jyk7CiAgICAgICAgfQogICAgfSk7CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCQlOb3RpY2UKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgICQoZG9jdW1lbnQpLm9uKCdjbGljaycsICcubm90aWNlIGFbY2xhc3NePSJpY29uLXJlbW92ZSJdJywgZnVuY3Rpb24oZSkgewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2YXIgbm90aWNlID0gJCh0aGlzKS5wYXJlbnRzKCcubm90aWNlJyk7CiAgICAgICAgJCh0aGlzKS5oaWRlKCk7CiAgICAgICAgbm90aWNlLmZhZGVPdXQoJ3Nsb3cnKTsKICAgIH0pOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkJVG9vbFRpcCAtIFRpcFRpcAoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8vIFN0YW5kYXJkIHRvb2x0aXAKICAgICQoJy50b29sdGlwLCAudG9vbHRpcC10b3AsIC50b29sdGlwLWJvdHRvbSwgLnRvb2x0aXAtcmlnaHQsIC50b29sdGlwLWxlZnQnKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIC8vIHZhcmlhYmxlcwogICAgICAgIHZhciB0cG9zID0gJ3RvcCc7CiAgICAgICAgdmFyIGNvbnRlbnQgPSAkKHRoaXMpLmF0dHIoJ3RpdGxlJyk7CiAgICAgICAgdmFyIGRhdGFDb250ZW50ID0gJCh0aGlzKS5hdHRyKCdkYXRhLWNvbnRlbnQnKTsKICAgICAgICB2YXIga2VlcEFsaXZlID0gZmFsc2U7CiAgICAgICAgdmFyIGFjdGlvbiA9ICdob3Zlcic7CiAgICAgICAgdmFyIGRlbGF5ID0gJCh0aGlzKS5hdHRyKCdkYXRhLWRlbGF5Jyk7CiAgICAgICAgaWYgKGRlbGF5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZGVsYXkgPSAxMDAwOwogICAgICAgIH0KCiAgICAgICAgLy8gcG9zaXRpb24KICAgICAgICBpZiAoJCh0aGlzKS5oYXNDbGFzcygndG9vbHRpcC10b3AnKSkgewogICAgICAgICAgICB0cG9zID0gJ3RvcCc7CiAgICAgICAgfQogICAgICAgIGlmICgkKHRoaXMpLmhhc0NsYXNzKCd0b29sdGlwLXJpZ2h0JykpIHsKICAgICAgICAgICAgdHBvcyA9ICdyaWdodCc7CiAgICAgICAgfQogICAgICAgIGlmICgkKHRoaXMpLmhhc0NsYXNzKCd0b29sdGlwLWJvdHRvbScpKSB7CiAgICAgICAgICAgIHRwb3MgPSAnYm90dG9tJzsKICAgICAgICB9CiAgICAgICAgaWYgKCQodGhpcykuaGFzQ2xhc3MoJ3Rvb2x0aXAtbGVmdCcpKSB7CiAgICAgICAgICAgIHRwb3MgPSAnbGVmdCc7CiAgICAgICAgfQoKICAgICAgICAvLyBjb250ZW50CiAgICAgICAgJCgnLnRvb2x0aXAtY29udGVudCcpLnJlbW92ZUNsYXNzKCdoaWRlJykud3JhcCgnPGRpdiBjbGFzcz0iaGlkZSI+PC9kaXY+Jyk7CiAgICAgICAgaWYgKGRhdGFDb250ZW50KSB7CiAgICAgICAgICAgIGNvbnRlbnQgPSAkKGRhdGFDb250ZW50KS5odG1sKCk7CiAgICAgICAgICAgIGtlZXBBbGl2ZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICAvLyBhY3Rpb24gKGhvdmVyIG9yIGNsaWNrKSBkZWZhdWx0cyB0byBob3ZlcgogICAgICAgIGlmICgkKHRoaXMpLmF0dHIoJ2RhdGEtYWN0aW9uJykgPT0gJ2NsaWNrJykgewogICAgICAgICAgICBhY3Rpb24gPSAnY2xpY2snOwogICAgICAgIH0KCiAgICAgICAgLy8gdG9vbHRpcAogICAgICAgICQodGhpcykuYXR0cigndGl0bGUnLCAnJykKICAgICAgICAgICAgLnRpcFRpcCh7CiAgICAgICAgICAgICAgICBkZWZhdWx0UG9zaXRpb246IHRwb3MsCiAgICAgICAgICAgICAgICBjb250ZW50OiBjb250ZW50LAogICAgICAgICAgICAgICAga2VlcEFsaXZlOiBrZWVwQWxpdmUsCiAgICAgICAgICAgICAgICBhY3RpdmF0aW9uOiBhY3Rpb24sCiAgICAgICAgICAgICAgICBkZWxheTogZGVsYXkKICAgICAgICAgICAgfSk7CiAgICB9KTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoJCVRhYmxlIFNvcnQKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgIC8vIGluaXQKICAgIHZhciBhQXNjID0gW107CiAgICAkKCd0YWJsZS5zb3J0YWJsZScpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgJCh0aGlzKS5maW5kKCd0aGVhZCB0aCcpLmVhY2goZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgICAgJCh0aGlzKS5hdHRyKCdyZWwnLCBpbmRleCk7CiAgICAgICAgfSk7CiAgICAgICAgJCh0aGlzKS5maW5kKCd0aCx0ZCcpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICQodGhpcykuYXR0cigndmFsdWUnLCAkKHRoaXMpLnRleHQoKSk7CiAgICAgICAgfSk7CiAgICB9KTsKCiAgICAvLyB0YWJsZSBjbGljawogICAgJChkb2N1bWVudCkub24oJ2NsaWNrJywgJ3RhYmxlLnNvcnRhYmxlIHRoZWFkIHRoJywgZnVuY3Rpb24oZSkgewogICAgICAgIC8vIHVwZGF0ZSBhcnJvdyBpY29uCiAgICAgICAgJCh0aGlzKS5wYXJlbnRzKCd0YWJsZS5zb3J0YWJsZScpLmZpbmQoJ3NwYW4uYXJyb3cnKS5yZW1vdmUoKTsKICAgICAgICAkKHRoaXMpLmFwcGVuZCgnPHNwYW4gY2xhc3M9ImFycm93Ij48L3NwYW4+Jyk7CgogICAgICAgIC8vIHNvcnQgZGlyZWN0aW9uCiAgICAgICAgdmFyIG5yID0gJCh0aGlzKS5hdHRyKCdyZWwnKTsKICAgICAgICBhQXNjW25yXSA9IGFBc2NbbnJdID09ICdhc2MnID8gJ2Rlc2MnIDogJ2FzYyc7CiAgICAgICAgaWYgKGFBc2NbbnJdID09ICdkZXNjJykgewogICAgICAgICAgICAkKHRoaXMpLmZpbmQoJ3NwYW4uYXJyb3cnKS5hZGRDbGFzcygndXAnKTsKICAgICAgICB9CgogICAgICAgIC8vIHNvcnQgcm93cwogICAgICAgIHZhciByb3dzID0gJCh0aGlzKS5wYXJlbnRzKCd0YWJsZS5zb3J0YWJsZScpLmZpbmQoJ3Rib2R5IHRyJyk7CiAgICAgICAgcm93cy50c29ydCgndGQ6ZXEoJyArIG5yICsgJyknLCB7CiAgICAgICAgICAgIG9yZGVyOiBhQXNjW25yXSwKICAgICAgICAgICAgYXR0cjogJ3ZhbHVlJwogICAgICAgIH0pOwoKICAgICAgICAvLyBmaXggcm93IGNsYXNzZXMKICAgICAgICByb3dzLnJlbW92ZUNsYXNzKCdhbHQgZmlyc3QgbGFzdCcpOwogICAgICAgIHZhciB0YWJsZSA9ICQodGhpcykucGFyZW50cygndGFibGUuc29ydGFibGUnKTsKICAgICAgICB0YWJsZS5maW5kKCd0cjpldmVuJykuYWRkQ2xhc3MoJ2FsdCcpOwogICAgICAgIHRhYmxlLmZpbmQoJ3RyOmZpcnN0JykuYWRkQ2xhc3MoJ2ZpcnN0Jyk7CiAgICAgICAgdGFibGUuZmluZCgndHI6bGFzdCcpLmFkZENsYXNzKCdsYXN0Jyk7CiAgICB9KTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoJCUNTUyBIZWxwZXJzCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgICAkKCdpbnB1dFt0eXBlPWNoZWNrYm94XScpLmFkZENsYXNzKCdjaGVja2JveCcpOwogICAgJCgnaW5wdXRbdHlwZT1yYWRpb10nKS5hZGRDbGFzcygncmFkaW8nKTsKICAgICQoJ2lucHV0W3R5cGU9ZmlsZV0nKS5hZGRDbGFzcygnZmlsZScpOwogICAgJCgnW2Rpc2FibGVkPWRpc2FibGVkXScpLmFkZENsYXNzKCdkaXNhYmxlZCcpOwogICAgJCgndGFibGUnKS5maW5kKCd0cjpldmVuJykuYWRkQ2xhc3MoJ2FsdCcpOwogICAgJCgndGFibGUnKS5maW5kKCd0cjpmaXJzdC1jaGlsZCcpLmFkZENsYXNzKCdmaXJzdCcpOwogICAgJCgndGFibGUnKS5maW5kKCd0cjpsYXN0LWNoaWxkJykuYWRkQ2xhc3MoJ2xhc3QnKTsKICAgICQoJ3VsJykuZmluZCgnbGk6Zmlyc3QtY2hpbGQnKS5hZGRDbGFzcygnZmlyc3QnKTsKICAgICQoJ3VsJykuZmluZCgnbGk6bGFzdC1jaGlsZCcpLmFkZENsYXNzKCdsYXN0Jyk7CiAgICAkKCdocicpLmJlZm9yZSgnPGRpdiBjbGFzcz0iY2xlYXIiPiZuYnNwOzwvZGl2PicpOwogICAgJCgnW2NsYXNzKj0iY29sXyJdJykuYWRkQ2xhc3MoJ2NvbHVtbicpOwogICAgJCgncHJlJykuYWRkQ2xhc3MoJ3ByZXR0eXByaW50Jyk7CiAgICBwcmV0dHlQcmludCgpOwoKfSk7CgovKgogKiBGYW5jeUJveCAtIGpRdWVyeSBQbHVnaW4KICogU2ltcGxlIGFuZCBmYW5jeSBsaWdodGJveCBhbHRlcm5hdGl2ZQogKgogKiBFeGFtcGxlcyBhbmQgZG9jdW1lbnRhdGlvbiBhdDogaHR0cDovL2ZhbmN5Ym94Lm5ldAogKgogKiBDb3B5cmlnaHQgKGMpIDIwMDggLSAyMDEwIEphbmlzIFNrYXJuZWxpcwogKiBUaGF0IHNhaWQsIGl0IGlzIGhhcmRseSBhIG9uZS1wZXJzb24gcHJvamVjdC4gTWFueSBwZW9wbGUgaGF2ZSBzdWJtaXR0ZWQgYnVncywgY29kZSwgYW5kIG9mZmVyZWQgdGhlaXIgYWR2aWNlIGZyZWVseS4gVGhlaXIgc3VwcG9ydCBpcyBncmVhdGx5IGFwcHJlY2lhdGVkLgogKgogKiBWZXJzaW9uOiAxLjMuNCAoMTEvMTEvMjAxMCkKICogUmVxdWlyZXM6IGpRdWVyeSB2MS4zKwogKgogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlczoKICogICBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAogKiAgIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9ncGwuaHRtbAogKi8KKGZ1bmN0aW9uKGEpIHsKICAgIHZhciBwLCB1LCB2LCBlLCBCLCBtLCBDLCBqLCB5LCB6LCBzID0gMCwKICAgICAgICBkID0ge30sIHEgPSBbXSwKICAgICAgICByID0gMCwKICAgICAgICBjID0ge30sIGsgPSBbXSwKICAgICAgICBFID0gbnVsbCwKICAgICAgICBuID0gbmV3IEltYWdlLAogICAgICAgIEggPSAvXC4oanBnfGdpZnxwbmd8Ym1wfGpwZWcpKC4qKT8kL2ksCiAgICAgICAgUyA9IC9bXlwuXVwuKHN3ZilccyokL2ksCiAgICAgICAgSSwgSiA9IDEsCiAgICAgICAgeCA9IDAsCiAgICAgICAgdyA9ICIiLAogICAgICAgIHQsIGcsIGwgPSAhMSwKICAgICAgICBBID0gYS5leHRlbmQoYSgiPGRpdi8+IilbMF0sIHsKICAgICAgICAgICAgcHJvcDogMAogICAgICAgIH0pLAogICAgICAgIEsgPSBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9tc2llIFs2XS9pKSAmJiAhd2luZG93LlhNTEh0dHBSZXF1ZXN0LAogICAgICAgIEwgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdS5oaWRlKCk7CiAgICAgICAgICAgIG4ub25lcnJvciA9IG4ub25sb2FkID0gbnVsbDsKICAgICAgICAgICAgRSAmJiBFLmFib3J0KCk7CiAgICAgICAgICAgIHAuZW1wdHkoKQogICAgICAgIH0sIE0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgITEgPT09IGQub25FcnJvcihxLCBzLCBkKSA/ICh1LmhpZGUoKSwgbCA9ICExKSA6IChkLnRpdGxlU2hvdyA9ICExLCBkLndpZHRoID0gImF1dG8iLCBkLmhlaWdodCA9ICJhdXRvIiwgcC5odG1sKCc8cCBpZD0iZmFuY3lib3gtZXJyb3IiPlRoZSByZXF1ZXN0ZWQgY29udGVudCBjYW5ub3QgYmUgbG9hZGVkLjxiciAvPlBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuPC9wPicpLAogICAgICAgICAgICAgICAgRCgpKQogICAgICAgIH0sIEcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGIgPSBxW3NdLAogICAgICAgICAgICAgICAgYywgZiwgZSwgZywgaywgajsKICAgICAgICAgICAgTCgpOwogICAgICAgICAgICBkID0gYS5leHRlbmQoe30sIGEuZm4uZmFuY3lib3guZGVmYXVsdHMsICJ1bmRlZmluZWQiID09IHR5cGVvZiBhKGIpLmRhdGEoImZhbmN5Ym94IikgPyBkIDogYShiKS5kYXRhKCJmYW5jeWJveCIpKTsKICAgICAgICAgICAgaiA9IGQub25TdGFydChxLCBzLCBkKTsKICAgICAgICAgICAgaWYgKCExID09PSBqKSBsID0gITE7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgIm9iamVjdCIgPT0gdHlwZW9mIGogJiYgKGQgPSBhLmV4dGVuZChkLCBqKSk7CiAgICAgICAgICAgICAgICBlID0gZC50aXRsZSB8fCAoYi5ub2RlTmFtZSA/IGEoYikuYXR0cigidGl0bGUiKSA6IGIudGl0bGUpIHx8ICIiOwogICAgICAgICAgICAgICAgYi5ub2RlTmFtZSAmJiAhZC5vcmlnICYmIChkLm9yaWcgPSBhKGIpLmNoaWxkcmVuKCJpbWc6Zmlyc3QiKS5sZW5ndGggPyBhKGIpLmNoaWxkcmVuKCJpbWc6Zmlyc3QiKSA6IGEoYikpOwogICAgICAgICAgICAgICAgIiIgPT09IGUgJiYgKGQub3JpZyAmJiBkLnRpdGxlRnJvbUFsdCkgJiYgKGUgPSBkLm9yaWcuYXR0cigiYWx0IikpOwogICAgICAgICAgICAgICAgYyA9IGQuaHJlZiB8fCAoYi5ub2RlTmFtZSA/IGEoYikuYXR0cigiaHJlZiIpIDogYi5ocmVmKSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKC9eKD86amF2YXNjcmlwdCkvaS50ZXN0KGMpIHx8CiAgICAgICAgICAgICAgICAgICAgIiMiID09IGMpIGMgPSBudWxsOwogICAgICAgICAgICAgICAgZC50eXBlID8gKGYgPSBkLnR5cGUsIGMgfHwgKGMgPSBkLmNvbnRlbnQpKSA6IGQuY29udGVudCA/IGYgPSAiaHRtbCIgOiBjICYmIChmID0gYy5tYXRjaChIKSA/ICJpbWFnZSIgOiBjLm1hdGNoKFMpID8gInN3ZiIgOiBhKGIpLmhhc0NsYXNzKCJpZnJhbWUiKSA/ICJpZnJhbWUiIDogMCA9PT0gYy5pbmRleE9mKCIjIikgPyAiaW5saW5lIiA6ICJhamF4Iik7CiAgICAgICAgICAgICAgICBpZiAoZikgc3dpdGNoICgiaW5saW5lIiA9PSBmICYmIChiID0gYy5zdWJzdHIoYy5pbmRleE9mKCIjIikpLCBmID0gMCA8IGEoYikubGVuZ3RoID8gImlubGluZSIgOiAiYWpheCIpLCBkLnR5cGUgPSBmLCBkLmhyZWYgPSBjLCBkLnRpdGxlID0gZSwgZC5hdXRvRGltZW5zaW9ucyAmJiAoImh0bWwiID09IGQudHlwZSB8fCAiaW5saW5lIiA9PSBkLnR5cGUgfHwgImFqYXgiID09IGQudHlwZSA/IChkLndpZHRoID0gImF1dG8iLCBkLmhlaWdodCA9ICJhdXRvIikgOiBkLmF1dG9EaW1lbnNpb25zID0gITEpLCBkLm1vZGFsICYmIChkLm92ZXJsYXlTaG93ID0gITAsIGQuaGlkZU9uT3ZlcmxheUNsaWNrID0gITEsIGQuaGlkZU9uQ29udGVudENsaWNrID0gITEsIGQuZW5hYmxlRXNjYXBlQnV0dG9uID0gITEsIGQuc2hvd0Nsb3NlQnV0dG9uID0gITEpLCBkLnBhZGRpbmcgPSBwYXJzZUludChkLnBhZGRpbmcsIDEwKSwgZC5tYXJnaW4gPSBwYXJzZUludChkLm1hcmdpbiwgMTApLCBwLmNzcygicGFkZGluZyIsIGQucGFkZGluZyArIGQubWFyZ2luKSwgYSgiLmZhbmN5Ym94LWlubGluZS10bXAiKS51bmJpbmQoImZhbmN5Ym94LWNhbmNlbCIpLmJpbmQoImZhbmN5Ym94LWNoYW5nZSIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGEodGhpcykucmVwbGFjZVdpdGgobS5jaGlsZHJlbigpKQogICAgICAgICAgICAgICAgfSksIGYpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICJodG1sIjoKICAgICAgICAgICAgICAgICAgICAgICAgcC5odG1sKGQuY29udGVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIEQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAiaW5saW5lIjoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEwID09PSBhKGIpLnBhcmVudCgpLmlzKCIjZmFuY3lib3gtY29udGVudCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsID0gITE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGEoJzxkaXYgY2xhc3M9ImZhbmN5Ym94LWlubGluZS10bXAiIC8+JykuaGlkZSgpLmluc2VydEJlZm9yZShhKGIpKS5iaW5kKCJmYW5jeWJveC1jbGVhbnVwIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhKHRoaXMpLnJlcGxhY2VXaXRoKG0uY2hpbGRyZW4oKSkKICAgICAgICAgICAgICAgICAgICAgICAgfSkuYmluZCgiZmFuY3lib3gtY2FuY2VsIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEodGhpcykucmVwbGFjZVdpdGgocC5jaGlsZHJlbigpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGEoYikuYXBwZW5kVG8ocCk7CiAgICAgICAgICAgICAgICAgICAgICAgIEQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAiaW1hZ2UiOgogICAgICAgICAgICAgICAgICAgICAgICBsID0gITE7CiAgICAgICAgICAgICAgICAgICAgICAgIGEuZmFuY3lib3guc2hvd0FjdGl2aXR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIG4gPSBuZXcgSW1hZ2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG4ub25lcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgTSgpCiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIG4ub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsID0gITA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuLm9uZXJyb3IgPSBuLm9ubG9hZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkLndpZHRoID0gbi53aWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGQuaGVpZ2h0ID0gbi5oZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhKCI8aW1nIC8+IikuYXR0cih7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICJmYW5jeWJveC1pbWciLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogbi5zcmMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWx0OiBkLnRpdGxlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5hcHBlbmRUbyhwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIE4oKQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBuLnNyYyA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgInN3ZiI6CiAgICAgICAgICAgICAgICAgICAgICAgIGQuc2Nyb2xsaW5nID0gIm5vIjsKICAgICAgICAgICAgICAgICAgICAgICAgZyA9ICc8b2JqZWN0IGNsYXNzaWQ9ImNsc2lkOkQyN0NEQjZFLUFFNkQtMTFjZi05NkI4LTQ0NDU1MzU0MDAwMCIgd2lkdGg9IicgKyBkLndpZHRoICsgJyIgaGVpZ2h0PSInICsgZC5oZWlnaHQgKyAnIj48cGFyYW0gbmFtZT0ibW92aWUiIHZhbHVlPSInICsgYyArICciPjwvcGFyYW0+JzsKICAgICAgICAgICAgICAgICAgICAgICAgayA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICBhLmVhY2goZC5zd2YsIGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGcgKz0gJzxwYXJhbSBuYW1lPSInICsgYSArICciIHZhbHVlPSInICsgYiArICciPjwvcGFyYW0+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGsgKz0gIiAiICsgYSArICc9IicgKyBiICsgJyInCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBnICs9ICc8ZW1iZWQgc3JjPSInICsgYyArICciIHR5cGU9ImFwcGxpY2F0aW9uL3gtc2hvY2t3YXZlLWZsYXNoIiB3aWR0aD0iJyArIGQud2lkdGggKyAnIiBoZWlnaHQ9IicgKyBkLmhlaWdodCArICciJyArIGsgKyAiPjwvZW1iZWQ+PC9vYmplY3Q+IjsKICAgICAgICAgICAgICAgICAgICAgICAgcC5odG1sKGcpOwogICAgICAgICAgICAgICAgICAgICAgICBEKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgImFqYXgiOgogICAgICAgICAgICAgICAgICAgICAgICBsID0gITE7CiAgICAgICAgICAgICAgICAgICAgICAgIGEuZmFuY3lib3guc2hvd0FjdGl2aXR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGQuYWpheC53aW4gPSBkLmFqYXguc3VjY2VzczsKICAgICAgICAgICAgICAgICAgICAgICAgRSA9IGEuYWpheChhLmV4dGVuZCh7fSwgZC5hamF4LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkLmFqYXguZGF0YSB8fCB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMCA8IGEuc3RhdHVzICYmIE0oKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGEsIGIsIGYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoMjAwID09ICgib2JqZWN0IiA9PSB0eXBlb2YgZiA/IGYgOiBFKS5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIGQuYWpheC53aW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGogPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGQuYWpheC53aW4oYywgYSwgYiwgZik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoITEgPT09IGopIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1LmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgaiB8fCAib2JqZWN0IiA9PSB0eXBlb2YgaikgYSA9IGoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLmh0bWwoYSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJpZnJhbWUiOgogICAgICAgICAgICAgICAgICAgICAgICBOKCkKICAgICAgICAgICAgICAgIH0gZWxzZSBNKCkKICAgICAgICAgICAgfQogICAgICAgIH0sIEQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGIgPSBkLndpZHRoLAogICAgICAgICAgICAgICAgYyA9IGQuaGVpZ2h0LAogICAgICAgICAgICAgICAgYiA9IC0xIDwgYi50b1N0cmluZygpLmluZGV4T2YoIiUiKSA/IHBhcnNlSW50KChhKHdpbmRvdykud2lkdGgoKSAtIDIgKiBkLm1hcmdpbikgKiBwYXJzZUZsb2F0KGIpIC8gMTAwLCAxMCkgKyAicHgiIDogImF1dG8iID09IGIgPyAiYXV0byIgOiBiICsgInB4IiwKICAgICAgICAgICAgICAgIGMgPSAtMSA8IGMudG9TdHJpbmcoKS5pbmRleE9mKCIlIikgPyBwYXJzZUludCgoYSh3aW5kb3cpLmhlaWdodCgpIC0gMiAqIGQubWFyZ2luKSAqIHBhcnNlRmxvYXQoYykgLyAxMDAsIDEwKSArICJweCIgOiAiYXV0byIgPT0gYyA/ICJhdXRvIiA6IGMgKyAicHgiOwogICAgICAgICAgICBwLndyYXBJbm5lcignPGRpdiBzdHlsZT0id2lkdGg6JyArIGIgKyAiO2hlaWdodDoiICsgYyArICI7b3ZlcmZsb3c6ICIgKyAoImF1dG8iID09CiAgICAgICAgICAgICAgICBkLnNjcm9sbGluZyA/ICJhdXRvIiA6ICJ5ZXMiID09IGQuc2Nyb2xsaW5nID8gInNjcm9sbCIgOiAiaGlkZGVuIikgKyAnO3Bvc2l0aW9uOnJlbGF0aXZlOyI+PC9kaXY+Jyk7CiAgICAgICAgICAgIGQud2lkdGggPSBwLndpZHRoKCk7CiAgICAgICAgICAgIGQuaGVpZ2h0ID0gcC5oZWlnaHQoKTsKICAgICAgICAgICAgTigpCiAgICAgICAgfSwgTiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYiwgaDsKICAgICAgICAgICAgdS5oaWRlKCk7CiAgICAgICAgICAgIGlmIChlLmlzKCI6dmlzaWJsZSIpICYmICExID09PSBjLm9uQ2xlYW51cChrLCByLCBjKSkgYS5ldmVudC50cmlnZ2VyKCJmYW5jeWJveC1jYW5jZWwiKSwgbCA9ICExOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGwgPSAhMDsKICAgICAgICAgICAgICAgIGEobS5hZGQodikpLnVuYmluZCgpOwogICAgICAgICAgICAgICAgYSh3aW5kb3cpLnVuYmluZCgicmVzaXplLmZiIHNjcm9sbC5mYiIpOwogICAgICAgICAgICAgICAgYShkb2N1bWVudCkudW5iaW5kKCJrZXlkb3duLmZiIik7CiAgICAgICAgICAgICAgICBlLmlzKCI6dmlzaWJsZSIpICYmICJvdXRzaWRlIiAhPT0gYy50aXRsZVBvc2l0aW9uICYmIGUuY3NzKCJoZWlnaHQiLCBlLmhlaWdodCgpKTsKICAgICAgICAgICAgICAgIGsgPSBxOwogICAgICAgICAgICAgICAgciA9IHM7CiAgICAgICAgICAgICAgICBjID0gZDsKICAgICAgICAgICAgICAgIGlmIChjLm92ZXJsYXlTaG93KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHYuY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgImJhY2tncm91bmQtY29sb3IiOiBjLm92ZXJsYXlDb2xvciwKICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogYy5vdmVybGF5T3BhY2l0eSwKICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yOiBjLmhpZGVPbk92ZXJsYXlDbGljayA/ICJwb2ludGVyIiA6ICJhdXRvIiwKICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBhKGRvY3VtZW50KS5oZWlnaHQoKQogICAgICAgICAgICAgICAgICAgIH0pLCAhdi5pcygiOnZpc2libGUiKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoSykgYSgic2VsZWN0Om5vdCgjZmFuY3lib3gtdG1wIHNlbGVjdCkiKS5maWx0ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gImhpZGRlbiIgIT09IHRoaXMuc3R5bGUudmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICB9KS5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJpbGl0eTogImhpZGRlbiIKICAgICAgICAgICAgICAgICAgICAgICAgfSkub25lKCJmYW5jeWJveC1jbGVhbnVwIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0eWxlLnZpc2liaWxpdHkgPSAiaW5oZXJpdCIKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHYuc2hvdygpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHYuaGlkZSgpOwogICAgICAgICAgICAgICAgYiA9IE8oKTsKICAgICAgICAgICAgICAgIHZhciBmID0ge30sIEYgPSBjLmF1dG9TY2FsZSwKICAgICAgICAgICAgICAgICAgICBuID0gMiAqIGMucGFkZGluZzsKICAgICAgICAgICAgICAgIGYud2lkdGggPSAtMSA8IGMud2lkdGgudG9TdHJpbmcoKS5pbmRleE9mKCIlIikgPyBwYXJzZUludChiWzBdICogcGFyc2VGbG9hdChjLndpZHRoKSAvIDEwMCwgMTApIDogYy53aWR0aCArIG47CiAgICAgICAgICAgICAgICBmLmhlaWdodCA9IC0xIDwgYy5oZWlnaHQudG9TdHJpbmcoKS5pbmRleE9mKCIlIikgPyBwYXJzZUludChiWzFdICoKICAgICAgICAgICAgICAgICAgICBwYXJzZUZsb2F0KGMuaGVpZ2h0KSAvIDEwMCwgMTApIDogYy5oZWlnaHQgKyBuOwogICAgICAgICAgICAgICAgaWYgKEYgJiYgKGYud2lkdGggPiBiWzBdIHx8IGYuaGVpZ2h0ID4gYlsxXSkpICJpbWFnZSIgPT0gZC50eXBlIHx8ICJzd2YiID09IGQudHlwZSA/IChGID0gYy53aWR0aCAvIGMuaGVpZ2h0LCBmLndpZHRoID4gYlswXSAmJiAoZi53aWR0aCA9IGJbMF0sIGYuaGVpZ2h0ID0gcGFyc2VJbnQoKGYud2lkdGggLSBuKSAvIEYgKyBuLCAxMCkpLCBmLmhlaWdodCA+IGJbMV0gJiYgKGYuaGVpZ2h0ID0gYlsxXSwgZi53aWR0aCA9IHBhcnNlSW50KChmLmhlaWdodCAtIG4pICogRiArIG4sIDEwKSkpIDogKGYud2lkdGggPSBNYXRoLm1pbihmLndpZHRoLCBiWzBdKSwgZi5oZWlnaHQgPSBNYXRoLm1pbihmLmhlaWdodCwgYlsxXSkpOwogICAgICAgICAgICAgICAgZi50b3AgPSBwYXJzZUludChNYXRoLm1heChiWzNdIC0gMjAsIGJbM10gKyAwLjUgKiAoYlsxXSAtIGYuaGVpZ2h0IC0gNDApKSwgMTApOwogICAgICAgICAgICAgICAgZi5sZWZ0ID0gcGFyc2VJbnQoTWF0aC5tYXgoYlsyXSAtIDIwLCBiWzJdICsgMC41ICogKGJbMF0gLSBmLndpZHRoIC0gNDApKSwgMTApOwogICAgICAgICAgICAgICAgZyA9IGY7CiAgICAgICAgICAgICAgICB3ID0gYy50aXRsZSB8fCAiIjsKICAgICAgICAgICAgICAgIHggPSAwOwogICAgICAgICAgICAgICAgai5lbXB0eSgpLnJlbW92ZUF0dHIoInN0eWxlIikucmVtb3ZlQ2xhc3MoKTsKICAgICAgICAgICAgICAgIGlmICghMSAhPT0gYy50aXRsZVNob3cgJiYgKHcgPSBhLmlzRnVuY3Rpb24oYy50aXRsZUZvcm1hdCkgPyBjLnRpdGxlRm9ybWF0KHcsIGssIHIsIGMpIDogdyAmJiB3Lmxlbmd0aCA/ICJmbG9hdCIgPT0gYy50aXRsZVBvc2l0aW9uID8gJzx0YWJsZSBpZD0iZmFuY3lib3gtdGl0bGUtZmxvYXQtd3JhcCIgY2VsbHBhZGRpbmc9IjAiIGNlbGxzcGFjaW5nPSIwIj48dHI+PHRkIGlkPSJmYW5jeWJveC10aXRsZS1mbG9hdC1sZWZ0Ij48L3RkPjx0ZCBpZD0iZmFuY3lib3gtdGl0bGUtZmxvYXQtbWFpbiI+JyArIHcgKyAnPC90ZD48dGQgaWQ9ImZhbmN5Ym94LXRpdGxlLWZsb2F0LXJpZ2h0Ij48L3RkPjwvdHI+PC90YWJsZT4nIDogJzxkaXYgaWQ9ImZhbmN5Ym94LXRpdGxlLScgKyBjLnRpdGxlUG9zaXRpb24gKyAnIj4nICsgdyArICI8L2Rpdj4iIDogITEpICYmICIiICE9PSB3KSBzd2l0Y2ggKGouYWRkQ2xhc3MoImZhbmN5Ym94LXRpdGxlLSIgKyBjLnRpdGxlUG9zaXRpb24pLmh0bWwodykuYXBwZW5kVG8oImJvZHkiKS5zaG93KCksIGMudGl0bGVQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgIGNhc2UgImluc2lkZSI6CiAgICAgICAgICAgICAgICAgICAgICAgIGouY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBnLndpZHRoIC0gMiAqIGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpbkxlZnQ6IGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpblJpZ2h0OiBjLnBhZGRpbmcKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHggPSBqLm91dGVySGVpZ2h0KCEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgai5hcHBlbmRUbyhCKTsKICAgICAgICAgICAgICAgICAgICAgICAgZy5oZWlnaHQgKz0geDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAib3ZlciI6CiAgICAgICAgICAgICAgICAgICAgICAgIGouY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpbkxlZnQ6IGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBnLndpZHRoIC0gMiAqIGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvdHRvbTogYy5wYWRkaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIH0pLmFwcGVuZFRvKEIpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJmbG9hdCI6CiAgICAgICAgICAgICAgICAgICAgICAgIGouY3NzKCJsZWZ0IiwgLTEgKiBwYXJzZUludCgoai53aWR0aCgpIC0gZy53aWR0aCAtIDQwKSAvIDIsIDEwKSkuYXBwZW5kVG8oZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGouY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBnLndpZHRoIC0gMiAqIGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmdMZWZ0OiBjLnBhZGRpbmcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nUmlnaHQ6IGMucGFkZGluZwogICAgICAgICAgICAgICAgICAgICAgICB9KS5hcHBlbmRUbyhlKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgai5oaWRlKCk7CiAgICAgICAgICAgICAgICBlLmlzKCI6dmlzaWJsZSIpID8gKGEoQy5hZGQoeSkuYWRkKHopKS5oaWRlKCksIGIgPSBlLnBvc2l0aW9uKCksIHQgPSB7CiAgICAgICAgICAgICAgICAgICAgdG9wOiBiLnRvcCwKICAgICAgICAgICAgICAgICAgICBsZWZ0OiBiLmxlZnQsCiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGUud2lkdGgoKSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IGUuaGVpZ2h0KCkKICAgICAgICAgICAgICAgIH0sIGggPSB0LndpZHRoID09IGcud2lkdGggJiYgdC5oZWlnaHQgPT0gZy5oZWlnaHQsIG0uZmFkZVRvKGMuY2hhbmdlRmFkZSwgMC4zLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBtLmh0bWwocC5jb250ZW50cygpKS5mYWRlVG8oYy5jaGFuZ2VGYWRlLCAxLCBQKQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgYS5ldmVudC50cmlnZ2VyKCJmYW5jeWJveC1jaGFuZ2UiKTsKICAgICAgICAgICAgICAgICAgICBtLmVtcHR5KCkucmVtb3ZlQXR0cigiZmlsdGVyIikuY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgImJvcmRlci13aWR0aCI6IGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGcud2lkdGggLSAyICogYy5wYWRkaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IGQuYXV0b0RpbWVuc2lvbnMgPyAiYXV0byIgOiBnLmhlaWdodCAtIHggLSAyICogYy5wYWRkaW5nCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaCA/IGIoKSA6IChBLnByb3AgPSAwLCBhKEEpLmFuaW1hdGUoewogICAgICAgICAgICAgICAgICAgICAgICBwcm9wOiAxCiAgICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogYy5jaGFuZ2VTcGVlZCwKICAgICAgICAgICAgICAgICAgICAgICAgZWFzaW5nOiBjLmVhc2luZ0NoYW5nZSwKICAgICAgICAgICAgICAgICAgICAgICAgc3RlcDogUSwKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6IGIKICAgICAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgICAgIH0pKSA6IChlLnJlbW92ZUF0dHIoInN0eWxlIiksIG0uY3NzKCJib3JkZXItd2lkdGgiLCBjLnBhZGRpbmcpLCAiZWxhc3RpYyIgPT0KICAgICAgICAgICAgICAgICAgICBjLnRyYW5zaXRpb25JbiA/ICh0ID0gUigpLCBtLmh0bWwocC5jb250ZW50cygpKSwgZS5zaG93KCksIGMub3BhY2l0eSAmJiAoZy5vcGFjaXR5ID0gMCksIEEucHJvcCA9IDAsIGEoQSkuYW5pbWF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb3A6IDEKICAgICAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBjLnNwZWVkSW4sCiAgICAgICAgICAgICAgICAgICAgICAgIGVhc2luZzogYy5lYXNpbmdJbiwKICAgICAgICAgICAgICAgICAgICAgICAgc3RlcDogUSwKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6IFAKICAgICAgICAgICAgICAgICAgICB9KSkgOiAoImluc2lkZSIgPT0gYy50aXRsZVBvc2l0aW9uICYmIDAgPCB4ICYmIGouc2hvdygpLCBtLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBnLndpZHRoIC0gMiAqIGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBkLmF1dG9EaW1lbnNpb25zID8gImF1dG8iIDogZy5oZWlnaHQgLSB4IC0gMiAqIGMucGFkZGluZwogICAgICAgICAgICAgICAgICAgIH0pLmh0bWwocC5jb250ZW50cygpKSwgZS5jc3MoZykuZmFkZUluKCJub25lIiA9PSBjLnRyYW5zaXRpb25JbiA/IDAgOiBjLnNwZWVkSW4sIFApKSkKICAgICAgICAgICAgfQogICAgICAgIH0sIFAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgYS5zdXBwb3J0Lm9wYWNpdHkgfHwgKG0uZ2V0KDApLnN0eWxlLnJlbW92ZUF0dHJpYnV0ZSgiZmlsdGVyIiksIGUuZ2V0KDApLnN0eWxlLnJlbW92ZUF0dHJpYnV0ZSgiZmlsdGVyIikpOwogICAgICAgICAgICBkLmF1dG9EaW1lbnNpb25zICYmCiAgICAgICAgICAgICAgICBtLmNzcygiaGVpZ2h0IiwgImF1dG8iKTsKICAgICAgICAgICAgZS5jc3MoImhlaWdodCIsICJhdXRvIik7CiAgICAgICAgICAgIHcgJiYgdy5sZW5ndGggJiYgai5zaG93KCk7CiAgICAgICAgICAgIGMuc2hvd0Nsb3NlQnV0dG9uICYmIEMuc2hvdygpOwogICAgICAgICAgICAoYy5lbmFibGVFc2NhcGVCdXR0b24gfHwgYy5lbmFibGVLZXlib2FyZE5hdikgJiYgYShkb2N1bWVudCkuYmluZCgia2V5ZG93bi5mYiIsIGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICAgIGlmICgyNyA9PSBiLmtleUNvZGUgJiYgYy5lbmFibGVFc2NhcGVCdXR0b24pIGIucHJldmVudERlZmF1bHQoKSwgYS5mYW5jeWJveC5jbG9zZSgpOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoKDM3ID09IGIua2V5Q29kZSB8fCAzOSA9PSBiLmtleUNvZGUpICYmIGMuZW5hYmxlS2V5Ym9hcmROYXYgJiYgIklOUFVUIiAhPT0gYi50YXJnZXQudGFnTmFtZSAmJiAiVEVYVEFSRUEiICE9PSBiLnRhcmdldC50YWdOYW1lICYmICJTRUxFQ1QiICE9PSBiLnRhcmdldC50YWdOYW1lKSBiLnByZXZlbnREZWZhdWx0KCksIGEuZmFuY3lib3hbMzcgPT0gYi5rZXlDb2RlID8gInByZXYiIDogIm5leHQiXSgpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjLnNob3dOYXZBcnJvd3MgPyAoKGMuY3ljbGljICYmIDEgPAogICAgICAgICAgICAgICAgay5sZW5ndGggfHwgMCAhPT0gcikgJiYgeS5zaG93KCksIChjLmN5Y2xpYyAmJiAxIDwgay5sZW5ndGggfHwgciAhPSBrLmxlbmd0aCAtIDEpICYmIHouc2hvdygpKSA6ICh5LmhpZGUoKSwgei5oaWRlKCkpOwogICAgICAgICAgICBjLmhpZGVPbkNvbnRlbnRDbGljayAmJiBtLmJpbmQoImNsaWNrIiwgYS5mYW5jeWJveC5jbG9zZSk7CiAgICAgICAgICAgIGMuaGlkZU9uT3ZlcmxheUNsaWNrICYmIHYuYmluZCgiY2xpY2siLCBhLmZhbmN5Ym94LmNsb3NlKTsKICAgICAgICAgICAgYSh3aW5kb3cpLmJpbmQoInJlc2l6ZS5mYiIsIGEuZmFuY3lib3gucmVzaXplKTsKICAgICAgICAgICAgYy5jZW50ZXJPblNjcm9sbCAmJiBhKHdpbmRvdykuYmluZCgic2Nyb2xsLmZiIiwgYS5mYW5jeWJveC5jZW50ZXIpOwogICAgICAgICAgICAiaWZyYW1lIiA9PSBjLnR5cGUgJiYgYSgnPGlmcmFtZSBpZD0iZmFuY3lib3gtZnJhbWUiIG5hbWU9ImZhbmN5Ym94LWZyYW1lJyArIChuZXcgRGF0ZSkuZ2V0VGltZSgpICsgJyIgZnJhbWVib3JkZXI9IjAiIGhzcGFjZT0iMCIgJyArIChuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9tc2llIFs2XS9pKSA/ICdhbGxvd3RyYW5zcGFyZW5jeT0idHJ1ZSIiJyA6CiAgICAgICAgICAgICAgICAiIikgKyAnIHNjcm9sbGluZz0iJyArIGQuc2Nyb2xsaW5nICsgJyIgc3JjPSInICsgYy5ocmVmICsgJyI+PC9pZnJhbWU+JykuYXBwZW5kVG8obSk7CiAgICAgICAgICAgIGUuc2hvdygpOwogICAgICAgICAgICBsID0gITE7CiAgICAgICAgICAgIGEuZmFuY3lib3guY2VudGVyKCk7CiAgICAgICAgICAgIGMub25Db21wbGV0ZShrLCByLCBjKTsKICAgICAgICAgICAgdmFyIGIsIGg7CiAgICAgICAgICAgIGsubGVuZ3RoIC0gMSA+IHIgJiYgKGIgPSBrW3IgKyAxXS5ocmVmLCAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIGIgJiYgYi5tYXRjaChIKSAmJiAoaCA9IG5ldyBJbWFnZSwgaC5zcmMgPSBiKSk7CiAgICAgICAgICAgIDAgPCByICYmIChiID0ga1tyIC0gMV0uaHJlZiwgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBiICYmIGIubWF0Y2goSCkgJiYgKGggPSBuZXcgSW1hZ2UsIGguc3JjID0gYikpCiAgICAgICAgfSwgUSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGEgPSB7CiAgICAgICAgICAgICAgICB3aWR0aDogcGFyc2VJbnQodC53aWR0aCArIChnLndpZHRoIC0gdC53aWR0aCkgKiBiLCAxMCksCiAgICAgICAgICAgICAgICBoZWlnaHQ6IHBhcnNlSW50KHQuaGVpZ2h0ICsgKGcuaGVpZ2h0IC0gdC5oZWlnaHQpICogYiwgMTApLAogICAgICAgICAgICAgICAgdG9wOiBwYXJzZUludCh0LnRvcCArIChnLnRvcCAtIHQudG9wKSAqIGIsIDEwKSwKICAgICAgICAgICAgICAgIGxlZnQ6IHBhcnNlSW50KHQubGVmdCArIChnLmxlZnQgLSB0LmxlZnQpICogYiwKICAgICAgICAgICAgICAgICAgICAxMCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBnLm9wYWNpdHkgJiYgKGEub3BhY2l0eSA9IDAuNSA+IGIgPyAwLjUgOiBiKTsKICAgICAgICAgICAgZS5jc3MoYSk7CiAgICAgICAgICAgIG0uY3NzKHsKICAgICAgICAgICAgICAgIHdpZHRoOiBhLndpZHRoIC0gMiAqIGMucGFkZGluZywKICAgICAgICAgICAgICAgIGhlaWdodDogYS5oZWlnaHQgLSB4ICogYiAtIDIgKiBjLnBhZGRpbmcKICAgICAgICAgICAgfSkKICAgICAgICB9LCBPID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBbYSh3aW5kb3cpLndpZHRoKCkgLSAyICogYy5tYXJnaW4sIGEod2luZG93KS5oZWlnaHQoKSAtIDIgKiBjLm1hcmdpbiwgYShkb2N1bWVudCkuc2Nyb2xsTGVmdCgpICsgYy5tYXJnaW4sIGEoZG9jdW1lbnQpLnNjcm9sbFRvcCgpICsgYy5tYXJnaW5dCiAgICAgICAgfSwgUiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYiA9IGQub3JpZyA/IGEoZC5vcmlnKSA6ICExLAogICAgICAgICAgICAgICAgaCA9IHt9OwogICAgICAgICAgICBiICYmIGIubGVuZ3RoID8gKGggPSBiLm9mZnNldCgpLCBoLnRvcCArPSBwYXJzZUludChiLmNzcygicGFkZGluZ1RvcCIpLCAxMCkgfHwgMCwgaC5sZWZ0ICs9IHBhcnNlSW50KGIuY3NzKCJwYWRkaW5nTGVmdCIpLCAxMCkgfHwgMCwgaC50b3AgKz0gcGFyc2VJbnQoYi5jc3MoImJvcmRlci10b3Atd2lkdGgiKSwgMTApIHx8IDAsIGgubGVmdCArPQogICAgICAgICAgICAgICAgcGFyc2VJbnQoYi5jc3MoImJvcmRlci1sZWZ0LXdpZHRoIiksIDEwKSB8fCAwLCBoLndpZHRoID0gYi53aWR0aCgpLCBoLmhlaWdodCA9IGIuaGVpZ2h0KCksIGggPSB7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGgud2lkdGggKyAyICogYy5wYWRkaW5nLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogaC5oZWlnaHQgKyAyICogYy5wYWRkaW5nLAogICAgICAgICAgICAgICAgICAgIHRvcDogaC50b3AgLSBjLnBhZGRpbmcgLSAyMCwKICAgICAgICAgICAgICAgICAgICBsZWZ0OiBoLmxlZnQgLSBjLnBhZGRpbmcgLSAyMAogICAgICAgICAgICAgICAgfSkgOiAoYiA9IE8oKSwgaCA9IHsKICAgICAgICAgICAgICAgIHdpZHRoOiAyICogYy5wYWRkaW5nLAogICAgICAgICAgICAgICAgaGVpZ2h0OiAyICogYy5wYWRkaW5nLAogICAgICAgICAgICAgICAgdG9wOiBwYXJzZUludChiWzNdICsgMC41ICogYlsxXSwgMTApLAogICAgICAgICAgICAgICAgbGVmdDogcGFyc2VJbnQoYlsyXSArIDAuNSAqIGJbMF0sIDEwKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGgKICAgICAgICB9LCBUID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHUuaXMoIjp2aXNpYmxlIikgPyAoYSgiZGl2IiwgdSkuY3NzKCJ0b3AiLCAtNDAgKiBKICsgInB4IiksIEogPSAoSiArIDEpICUgMTIpIDogY2xlYXJJbnRlcnZhbChJKQogICAgICAgIH07CiAgICBhLmZuLmZhbmN5Ym94ID0gZnVuY3Rpb24oYikgewogICAgICAgIGlmICghYSh0aGlzKS5sZW5ndGgpIHJldHVybiB0aGlzOwogICAgICAgIGEodGhpcykuZGF0YSgiZmFuY3lib3giLCBhLmV4dGVuZCh7fSwgYiwgYS5tZXRhZGF0YSA/CiAgICAgICAgICAgIGEodGhpcykubWV0YWRhdGEoKSA6IHt9KSkudW5iaW5kKCJjbGljay5mYiIpLmJpbmQoImNsaWNrLmZiIiwgZnVuY3Rpb24oYikgewogICAgICAgICAgICBiLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGwgfHwgKGwgPSAhMCwgYSh0aGlzKS5ibHVyKCksIHEgPSBbXSwgcyA9IDAsIGIgPSBhKHRoaXMpLmF0dHIoInJlbCIpIHx8ICIiLCAhYiB8fCAiIiA9PSBiIHx8ICJub2ZvbGxvdyIgPT09IGIgPyBxLnB1c2godGhpcykgOiAocSA9IGEoImFbcmVsPSIgKyBiICsgIl0sIGFyZWFbcmVsPSIgKyBiICsgIl0sIGltZ1tyZWw9IiArIGIgKyAiXSIpLCBzID0gcS5pbmRleCh0aGlzKSksIEcoKSkKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGhpcwogICAgfTsKICAgIGEuZmFuY3lib3ggPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgdmFyIGQ7CiAgICAgICAgaWYgKCFsKSB7CiAgICAgICAgICAgIGwgPSAhMDsKICAgICAgICAgICAgZCA9ICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgYyA/IGMgOiB7fTsKICAgICAgICAgICAgcSA9IFtdOwogICAgICAgICAgICBzID0gcGFyc2VJbnQoZC5pbmRleCwgMTApIHx8IDA7CiAgICAgICAgICAgIGlmIChhLmlzQXJyYXkoYikpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGUgPSAwLCBnID0gYi5sZW5ndGg7IGUgPCBnOyBlKyspICJvYmplY3QiID09IHR5cGVvZiBiW2VdID8gYShiW2VdKS5kYXRhKCJmYW5jeWJveCIsIGEuZXh0ZW5kKHt9LCBkLCBiW2VdKSkgOiBiW2VdID0KICAgICAgICAgICAgICAgICAgICBhKHt9KS5kYXRhKCJmYW5jeWJveCIsIGEuZXh0ZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudDogYltlXQogICAgICAgICAgICAgICAgICAgIH0sIGQpKTsKICAgICAgICAgICAgICAgIHEgPSBqUXVlcnkubWVyZ2UocSwgYikKICAgICAgICAgICAgfSBlbHNlICJvYmplY3QiID09IHR5cGVvZiBiID8gYShiKS5kYXRhKCJmYW5jeWJveCIsIGEuZXh0ZW5kKHt9LCBkLCBiKSkgOiBiID0gYSh7fSkuZGF0YSgiZmFuY3lib3giLCBhLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBjb250ZW50OiBiCiAgICAgICAgICAgIH0sIGQpKSwgcS5wdXNoKGIpOyBpZiAocyA+IHEubGVuZ3RoIHx8IDAgPiBzKSBzID0gMDsKICAgICAgICAgICAgRygpCiAgICAgICAgfQogICAgfTsKICAgIGEuZmFuY3lib3guc2hvd0FjdGl2aXR5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY2xlYXJJbnRlcnZhbChJKTsKICAgICAgICB1LnNob3coKTsKICAgICAgICBJID0gc2V0SW50ZXJ2YWwoVCwgNjYpCiAgICB9OwogICAgYS5mYW5jeWJveC5oaWRlQWN0aXZpdHkgPSBmdW5jdGlvbigpIHsKICAgICAgICB1LmhpZGUoKQogICAgfTsKICAgIGEuZmFuY3lib3gubmV4dCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBhLmZhbmN5Ym94LnBvcyhyICsgMSkKICAgIH07CiAgICBhLmZhbmN5Ym94LnByZXYgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYS5mYW5jeWJveC5wb3MociAtIDEpCiAgICB9OwogICAgYS5mYW5jeWJveC5wb3MgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgbCB8fCAoYiA9IHBhcnNlSW50KGIpLAogICAgICAgICAgICBxID0gaywgLTEgPCBiICYmIGIgPCBrLmxlbmd0aCA/IChzID0gYiwgRygpKSA6IGMuY3ljbGljICYmIDEgPCBrLmxlbmd0aCAmJiAocyA9IGIgPj0gay5sZW5ndGggPyAwIDogay5sZW5ndGggLSAxLCBHKCkpKQogICAgfTsKICAgIGEuZmFuY3lib3guY2FuY2VsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbCB8fCAobCA9ICEwLCBhLmV2ZW50LnRyaWdnZXIoImZhbmN5Ym94LWNhbmNlbCIpLCBMKCksIGQub25DYW5jZWwocSwgcywgZCksIGwgPSAhMSkKICAgIH07CiAgICBhLmZhbmN5Ym94LmNsb3NlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZnVuY3Rpb24gYigpIHsKICAgICAgICAgICAgdi5mYWRlT3V0KCJmYXN0Iik7CiAgICAgICAgICAgIGouZW1wdHkoKS5oaWRlKCk7CiAgICAgICAgICAgIGUuaGlkZSgpOwogICAgICAgICAgICBhLmV2ZW50LnRyaWdnZXIoImZhbmN5Ym94LWNsZWFudXAiKTsKICAgICAgICAgICAgbS5lbXB0eSgpOwogICAgICAgICAgICBjLm9uQ2xvc2VkKGssIHIsIGMpOwogICAgICAgICAgICBrID0gZCA9IFtdOwogICAgICAgICAgICByID0gcyA9IDA7CiAgICAgICAgICAgIGMgPSBkID0ge307CiAgICAgICAgICAgIGwgPSAhMQogICAgICAgIH0KICAgICAgICBpZiAoIWwgJiYgIWUuaXMoIjpoaWRkZW4iKSkKICAgICAgICAgICAgaWYgKGwgPSAhMCwgYyAmJiAhMSA9PT0gYy5vbkNsZWFudXAoaywgciwgYykpIGwgPSAhMTsKICAgICAgICAgICAgZWxzZQogICAgICAgIGlmIChMKCksIGEoQy5hZGQoeSkuYWRkKHopKS5oaWRlKCksIGEobS5hZGQodikpLnVuYmluZCgpLCBhKHdpbmRvdykudW5iaW5kKCJyZXNpemUuZmIgc2Nyb2xsLmZiIiksCiAgICAgICAgICAgIGEoZG9jdW1lbnQpLnVuYmluZCgia2V5ZG93bi5mYiIpLCBtLmZpbmQoImlmcmFtZSIpLmF0dHIoInNyYyIsIEsgJiYgL15odHRwcy9pLnRlc3Qod2luZG93LmxvY2F0aW9uLmhyZWYgfHwgIiIpID8gImphdmFzY3JpcHQ6dm9pZChmYWxzZSkiIDogImFib3V0OmJsYW5rIiksICJpbnNpZGUiICE9PSBjLnRpdGxlUG9zaXRpb24gJiYgai5lbXB0eSgpLCBlLnN0b3AoKSwgImVsYXN0aWMiID09IGMudHJhbnNpdGlvbk91dCkgewogICAgICAgICAgICB0ID0gUigpOwogICAgICAgICAgICB2YXIgaCA9IGUucG9zaXRpb24oKTsKICAgICAgICAgICAgZyA9IHsKICAgICAgICAgICAgICAgIHRvcDogaC50b3AsCiAgICAgICAgICAgICAgICBsZWZ0OiBoLmxlZnQsCiAgICAgICAgICAgICAgICB3aWR0aDogZS53aWR0aCgpLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBlLmhlaWdodCgpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGMub3BhY2l0eSAmJiAoZy5vcGFjaXR5ID0gMSk7CiAgICAgICAgICAgIGouZW1wdHkoKS5oaWRlKCk7CiAgICAgICAgICAgIEEucHJvcCA9IDE7CiAgICAgICAgICAgIGEoQSkuYW5pbWF0ZSh7CiAgICAgICAgICAgICAgICBwcm9wOiAwCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBjLnNwZWVkT3V0LAogICAgICAgICAgICAgICAgZWFzaW5nOiBjLmVhc2luZ091dCwKICAgICAgICAgICAgICAgIHN0ZXA6IFEsCiAgICAgICAgICAgICAgICBjb21wbGV0ZTogYgogICAgICAgICAgICB9KQogICAgICAgIH0gZWxzZSBlLmZhZGVPdXQoIm5vbmUiID09IGMudHJhbnNpdGlvbk91dCA/IDAgOiBjLnNwZWVkT3V0LCBiKQogICAgfTsKICAgIGEuZmFuY3lib3gucmVzaXplID0KICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdi5pcygiOnZpc2libGUiKSAmJiB2LmNzcygiaGVpZ2h0IiwgYShkb2N1bWVudCkuaGVpZ2h0KCkpOwogICAgICAgICAgICBhLmZhbmN5Ym94LmNlbnRlcighMCkKICAgIH07CiAgICBhLmZhbmN5Ym94LmNlbnRlciA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICB2YXIgYSwgZDsKICAgICAgICBpZiAoIWwgJiYgKGQgPSAhMCA9PT0gYiA/IDEgOiAwLCBhID0gTygpLCBkIHx8ICEoZS53aWR0aCgpID4gYVswXSB8fCBlLmhlaWdodCgpID4gYVsxXSkpKSBlLnN0b3AoKS5hbmltYXRlKHsKICAgICAgICAgICAgdG9wOiBwYXJzZUludChNYXRoLm1heChhWzNdIC0gMjAsIGFbM10gKyAwLjUgKiAoYVsxXSAtIG0uaGVpZ2h0KCkgLSA0MCkgLSBjLnBhZGRpbmcpKSwKICAgICAgICAgICAgbGVmdDogcGFyc2VJbnQoTWF0aC5tYXgoYVsyXSAtIDIwLCBhWzJdICsgMC41ICogKGFbMF0gLSBtLndpZHRoKCkgLSA0MCkgLSBjLnBhZGRpbmcpKQogICAgICAgIH0sICJudW1iZXIiID09IHR5cGVvZiBiID8gYiA6IDIwMCkKICAgIH07CiAgICBhLmZhbmN5Ym94LmluaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICBhKCIjZmFuY3lib3gtd3JhcCIpLmxlbmd0aCB8fCAoYSgiYm9keSIpLmFwcGVuZChwID0gYSgnPGRpdiBpZD0iZmFuY3lib3gtdG1wIj48L2Rpdj4nKSwgdSA9IGEoJzxkaXYgaWQ9ImZhbmN5Ym94LWxvYWRpbmciPjxkaXY+PC9kaXY+PC9kaXY+JyksCiAgICAgICAgICAgICAgICB2ID0gYSgnPGRpdiBpZD0iZmFuY3lib3gtb3ZlcmxheSI+PC9kaXY+JyksIGUgPSBhKCc8ZGl2IGlkPSJmYW5jeWJveC13cmFwIj48L2Rpdj4nKSksIEIgPSBhKCc8ZGl2IGlkPSJmYW5jeWJveC1vdXRlciI+PC9kaXY+JykuYXBwZW5kKCc8ZGl2IGNsYXNzPSJmYW5jeWJveC1iZyIgaWQ9ImZhbmN5Ym94LWJnLW4iPjwvZGl2PjxkaXYgY2xhc3M9ImZhbmN5Ym94LWJnIiBpZD0iZmFuY3lib3gtYmctbmUiPjwvZGl2PjxkaXYgY2xhc3M9ImZhbmN5Ym94LWJnIiBpZD0iZmFuY3lib3gtYmctZSI+PC9kaXY+PGRpdiBjbGFzcz0iZmFuY3lib3gtYmciIGlkPSJmYW5jeWJveC1iZy1zZSI+PC9kaXY+PGRpdiBjbGFzcz0iZmFuY3lib3gtYmciIGlkPSJmYW5jeWJveC1iZy1zIj48L2Rpdj48ZGl2IGNsYXNzPSJmYW5jeWJveC1iZyIgaWQ9ImZhbmN5Ym94LWJnLXN3Ij48L2Rpdj48ZGl2IGNsYXNzPSJmYW5jeWJveC1iZyIgaWQ9ImZhbmN5Ym94LWJnLXciPjwvZGl2PjxkaXYgY2xhc3M9ImZhbmN5Ym94LWJnIiBpZD0iZmFuY3lib3gtYmctbnciPjwvZGl2PicpLmFwcGVuZFRvKGUpLAogICAgICAgICAgICBCLmFwcGVuZChtID0gYSgnPGRpdiBpZD0iZmFuY3lib3gtY29udGVudCI+PC9kaXY+JyksIEMgPSBhKCc8YSBpZD0iZmFuY3lib3gtY2xvc2UiPjwvYT4nKSwgaiA9IGEoJzxkaXYgaWQ9ImZhbmN5Ym94LXRpdGxlIj48L2Rpdj4nKSwgeSA9IGEoJzxhIGhyZWY9ImphdmFzY3JpcHQ6OyIgaWQ9ImZhbmN5Ym94LWxlZnQiPjxzcGFuIGNsYXNzPSJmYW5jeS1pY28iIGlkPSJmYW5jeWJveC1sZWZ0LWljbyI+PC9zcGFuPjwvYT4nKSwgeiA9IGEoJzxhIGhyZWY9ImphdmFzY3JpcHQ6OyIgaWQ9ImZhbmN5Ym94LXJpZ2h0Ij48c3BhbiBjbGFzcz0iZmFuY3ktaWNvIiBpZD0iZmFuY3lib3gtcmlnaHQtaWNvIj48L3NwYW4+PC9hPicpKSwgQy5jbGljayhhLmZhbmN5Ym94LmNsb3NlKSwgdS5jbGljayhhLmZhbmN5Ym94LmNhbmNlbCksIHkuY2xpY2soZnVuY3Rpb24oYikgewogICAgICAgICAgICAgICAgYi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgYS5mYW5jeWJveC5wcmV2KCkKICAgICAgICAgICAgfSksIHouY2xpY2soZnVuY3Rpb24oYikgewogICAgICAgICAgICAgICAgYi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgYS5mYW5jeWJveC5uZXh0KCkKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIGEuZm4ubW91c2V3aGVlbCAmJiBlLmJpbmQoIm1vdXNld2hlZWwuZmIiLCBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgICAgICBpZiAobCkgYi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoMCA9PSBhKGIudGFyZ2V0KS5nZXQoMCkuY2xpZW50SGVpZ2h0IHx8IGEoYi50YXJnZXQpLmdldCgwKS5zY3JvbGxIZWlnaHQgPT09IGEoYi50YXJnZXQpLmdldCgwKS5jbGllbnRIZWlnaHQpIGIucHJldmVudERlZmF1bHQoKSwgYS5mYW5jeWJveFswIDwgYyA/ICJwcmV2IiA6ICJuZXh0Il0oKQogICAgICAgICAgICB9KSwgYS5zdXBwb3J0Lm9wYWNpdHkgfHwgZS5hZGRDbGFzcygiZmFuY3lib3gtaWUiKSwgSyAmJiAodS5hZGRDbGFzcygiZmFuY3lib3gtaWU2IiksIGUuYWRkQ2xhc3MoImZhbmN5Ym94LWllNiIpLCBhKCc8aWZyYW1lIGlkPSJmYW5jeWJveC1oaWRlLXNlbC1mcmFtZSIgc3JjPSInICsgKC9eaHR0cHMvaS50ZXN0KHdpbmRvdy5sb2NhdGlvbi5ocmVmIHx8ICIiKSA/ICJqYXZhc2NyaXB0OnZvaWQoZmFsc2UpIiA6ICJhYm91dDpibGFuayIpICsgJyIgc2Nyb2xsaW5nPSJubyIgYm9yZGVyPSIwIiBmcmFtZWJvcmRlcj0iMCIgdGFiaW5kZXg9Ii0xIj48L2lmcmFtZT4nKS5wcmVwZW5kVG8oQikpKQogICAgfTsKICAgIGEuZm4uZmFuY3lib3guZGVmYXVsdHMgPSB7CiAgICAgICAgcGFkZGluZzogMTAsCiAgICAgICAgbWFyZ2luOiA0MCwKICAgICAgICBvcGFjaXR5OiAhMSwKICAgICAgICBtb2RhbDogITEsCiAgICAgICAgY3ljbGljOiAhMSwKICAgICAgICBzY3JvbGxpbmc6ICJhdXRvIiwKICAgICAgICB3aWR0aDogNTYwLAogICAgICAgIGhlaWdodDogMzQwLAogICAgICAgIGF1dG9TY2FsZTogITAsCiAgICAgICAgYXV0b0RpbWVuc2lvbnM6ICEwLAogICAgICAgIGNlbnRlck9uU2Nyb2xsOiAhMSwKICAgICAgICBhamF4OiB7fSwKICAgICAgICBzd2Y6IHsKICAgICAgICAgICAgd21vZGU6ICJ0cmFuc3BhcmVudCIKICAgICAgICB9LAogICAgICAgIGhpZGVPbk92ZXJsYXlDbGljazogITAsCiAgICAgICAgaGlkZU9uQ29udGVudENsaWNrOiAhMSwKICAgICAgICBvdmVybGF5U2hvdzogITAsCiAgICAgICAgb3ZlcmxheU9wYWNpdHk6IDAuNywKICAgICAgICBvdmVybGF5Q29sb3I6ICIjNzc3IiwKICAgICAgICB0aXRsZVNob3c6ICEwLAogICAgICAgIHRpdGxlUG9zaXRpb246ICJmbG9hdCIsCiAgICAgICAgdGl0bGVGb3JtYXQ6IG51bGwsCiAgICAgICAgdGl0bGVGcm9tQWx0OiAhMSwKICAgICAgICB0cmFuc2l0aW9uSW46ICJmYWRlIiwKICAgICAgICB0cmFuc2l0aW9uT3V0OiAiZmFkZSIsCiAgICAgICAgc3BlZWRJbjogMzAwLAogICAgICAgIHNwZWVkT3V0OiAzMDAsCiAgICAgICAgY2hhbmdlU3BlZWQ6IDMwMCwKICAgICAgICBjaGFuZ2VGYWRlOiAiZmFzdCIsCiAgICAgICAgZWFzaW5nSW46ICJzd2luZyIsCiAgICAgICAgZWFzaW5nT3V0OiAic3dpbmciLAogICAgICAgIHNob3dDbG9zZUJ1dHRvbjogITAsCiAgICAgICAgc2hvd05hdkFycm93czogITAsCiAgICAgICAgZW5hYmxlRXNjYXBlQnV0dG9uOiAhMCwKICAgICAgICBlbmFibGVLZXlib2FyZE5hdjogITAsCiAgICAgICAgb25TdGFydDogZnVuY3Rpb24oKSB7fSwKICAgICAgICBvbkNhbmNlbDogZnVuY3Rpb24oKSB7fSwKICAgICAgICBvbkNvbXBsZXRlOiBmdW5jdGlvbigpIHt9LAogICAgICAgIG9uQ2xlYW51cDogZnVuY3Rpb24oKSB7fSwKICAgICAgICBvbkNsb3NlZDogZnVuY3Rpb24oKSB7fSwKICAgICAgICBvbkVycm9yOiBmdW5jdGlvbigpIHt9CiAgICB9OwogICAgYShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgYS5mYW5jeWJveC5pbml0KCkKICAgIH0pCn0pKGpRdWVyeSk7CgoKLyoKICogVGlwVGlwCiAqIENvcHlyaWdodCAyMDEwIERyZXcgV2lsc29uCiAqIHd3dy5kcmV3d2lsc29uLmNvbQogKiBjb2RlLmRyZXd3aWxzb24uY29tL2VudHJ5L3RpcHRpcC1qcXVlcnktcGx1Z2luCiAqCiAqIFZlcnNpb24gMS4zICAgLSAgIFVwZGF0ZWQ6IE1hci4gMjMsIDIwMTAKICoKICogVGhpcyBQbHVnLUluIHdpbGwgY3JlYXRlIGEgY3VzdG9tIHRvb2x0aXAgdG8gcmVwbGFjZSB0aGUgZGVmYXVsdAogKiBicm93c2VyIHRvb2x0aXAuIEl0IGlzIGV4dHJlbWVseSBsaWdodHdlaWdodCBhbmQgdmVyeSBzbWFydCBpbgogKiB0aGF0IGl0IGRldGVjdHMgdGhlIGVkZ2VzIG9mIHRoZSBicm93c2VyIHdpbmRvdyBhbmQgd2lsbCBtYWtlIHN1cmUKICogdGhlIHRvb2x0aXAgc3RheXMgd2l0aGluIHRoZSBjdXJyZW50IHdpbmRvdyBzaXplLiBBcyBhIHJlc3VsdCB0aGUKICogdG9vbHRpcCB3aWxsIGFkanVzdCBpdHNlbGYgdG8gYmUgZGlzcGxheWVkIGFib3ZlLCBiZWxvdywgdG8gdGhlIGxlZnQKICogb3IgdG8gdGhlIHJpZ2h0IGRlcGVuZGluZyBvbiB3aGF0IGlzIG5lY2Vzc2FyeSB0byBzdGF5IHdpdGhpbiB0aGUKICogYnJvd3NlciB3aW5kb3cuIEl0IGlzIGNvbXBsZXRlbHkgY3VzdG9taXphYmxlIGFzIHdlbGwgdmlhIENTUy4KICoKICogVGhpcyBUaXBUaXAgalF1ZXJ5IHBsdWctaW4gaXMgZHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXM6CiAqICAgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAKICogICBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWwKICovCihmdW5jdGlvbigkKSB7CiAgICAkLmZuLnRpcFRpcCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICB2YXIgZGVmYXVsdHMgPSB7CiAgICAgICAgICAgIGFjdGl2YXRpb246ICJob3ZlciIsCiAgICAgICAgICAgIGtlZXBBbGl2ZTogZmFsc2UsCiAgICAgICAgICAgIG1heFdpZHRoOiAiMjAwcHgiLAogICAgICAgICAgICBlZGdlT2Zmc2V0OiAzLAogICAgICAgICAgICBkZWZhdWx0UG9zaXRpb246ICJib3R0b20iLAogICAgICAgICAgICBkZWxheTogNDAwLAogICAgICAgICAgICBmYWRlSW46IDIwMCwKICAgICAgICAgICAgZmFkZU91dDogMjAwLAogICAgICAgICAgICBhdHRyaWJ1dGU6ICJ0aXRsZSIsCiAgICAgICAgICAgIGNvbnRlbnQ6IGZhbHNlLAogICAgICAgICAgICBlbnRlcjogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgZXhpdDogZnVuY3Rpb24oKSB7fQogICAgICAgIH07CiAgICAgICAgdmFyIG9wdHMgPSAkLmV4dGVuZChkZWZhdWx0cywgb3B0aW9ucyk7CiAgICAgICAgaWYgKCQoIiN0aXB0aXBfaG9sZGVyIikubGVuZ3RoIDw9IDApIHsKICAgICAgICAgICAgdmFyIHRpcHRpcF9ob2xkZXIgPSAkKCc8ZGl2IGlkPSJ0aXB0aXBfaG9sZGVyIiBzdHlsZT0ibWF4LXdpZHRoOicgKyBvcHRzLm1heFdpZHRoICsgJzsiPjwvZGl2PicpOwogICAgICAgICAgICB2YXIgdGlwdGlwX2NvbnRlbnQgPSAkKCc8ZGl2IGlkPSJ0aXB0aXBfY29udGVudCI+PC9kaXY+Jyk7CiAgICAgICAgICAgIHZhciB0aXB0aXBfYXJyb3cgPSAkKCc8ZGl2IGlkPSJ0aXB0aXBfYXJyb3ciPjwvZGl2PicpOwogICAgICAgICAgICAkKCJib2R5IikuYXBwZW5kKHRpcHRpcF9ob2xkZXIuaHRtbCh0aXB0aXBfY29udGVudCkucHJlcGVuZCh0aXB0aXBfYXJyb3cuaHRtbCgnPGRpdiBpZD0idGlwdGlwX2Fycm93X2lubmVyIj48L2Rpdj4nKSkpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHRpcHRpcF9ob2xkZXIgPSAkKCIjdGlwdGlwX2hvbGRlciIpOwogICAgICAgICAgICB2YXIgdGlwdGlwX2NvbnRlbnQgPSAkKCIjdGlwdGlwX2NvbnRlbnQiKTsKICAgICAgICAgICAgdmFyIHRpcHRpcF9hcnJvdyA9ICQoIiN0aXB0aXBfYXJyb3ciKQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgb3JnX2VsZW0gPSAkKHRoaXMpOwogICAgICAgICAgICBpZiAob3B0cy5jb250ZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgb3JnX3RpdGxlID0gb3B0cy5jb250ZW50CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgb3JnX3RpdGxlID0gb3JnX2VsZW0uYXR0cihvcHRzLmF0dHJpYnV0ZSkKICAgICAgICAgICAgfSBpZiAob3JnX3RpdGxlICE9ICIiKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wdHMuY29udGVudCkgewogICAgICAgICAgICAgICAgICAgIG9yZ19lbGVtLnJlbW92ZUF0dHIob3B0cy5hdHRyaWJ1dGUpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdGltZW91dCA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKG9wdHMuYWN0aXZhdGlvbiA9PSAiaG92ZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgb3JnX2VsZW0uaG92ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZV90aXB0aXAoKQogICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9wdHMua2VlcEFsaXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWFjdGl2ZV90aXB0aXAoKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHMua2VlcEFsaXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpcHRpcF9ob2xkZXIuaG92ZXIoZnVuY3Rpb24oKSB7fSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWFjdGl2ZV90aXB0aXAoKQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0cy5hY3RpdmF0aW9uID09ICJmb2N1cyIpIHsKICAgICAgICAgICAgICAgICAgICBvcmdfZWxlbS5mb2N1cyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlX3RpcHRpcCgpCiAgICAgICAgICAgICAgICAgICAgfSkuYmx1cihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVhY3RpdmVfdGlwdGlwKCkKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRzLmFjdGl2YXRpb24gPT0gImNsaWNrIikgewogICAgICAgICAgICAgICAgICAgIG9yZ19lbGVtLmNsaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVfdGlwdGlwKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0pLmhvdmVyKGZ1bmN0aW9uKCkge30sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9wdHMua2VlcEFsaXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWFjdGl2ZV90aXB0aXAoKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHMua2VlcEFsaXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpcHRpcF9ob2xkZXIuaG92ZXIoZnVuY3Rpb24oKSB7fSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWFjdGl2ZV90aXB0aXAoKQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhY3RpdmVfdGlwdGlwKCkgewogICAgICAgICAgICAgICAgICAgIG9wdHMuZW50ZXIuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgICAgICB0aXB0aXBfY29udGVudC5odG1sKG9yZ190aXRsZSk7CiAgICAgICAgICAgICAgICAgICAgdGlwdGlwX2hvbGRlci5oaWRlKCkucmVtb3ZlQXR0cigiY2xhc3MiKS5jc3MoIm1hcmdpbiIsICIwIik7CiAgICAgICAgICAgICAgICAgICAgdGlwdGlwX2Fycm93LnJlbW92ZUF0dHIoInN0eWxlIik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRvcCA9IHBhcnNlSW50KG9yZ19lbGVtLm9mZnNldCgpWyd0b3AnXSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxlZnQgPSBwYXJzZUludChvcmdfZWxlbS5vZmZzZXQoKVsnbGVmdCddKTsKICAgICAgICAgICAgICAgICAgICB2YXIgb3JnX3dpZHRoID0gcGFyc2VJbnQob3JnX2VsZW0ub3V0ZXJXaWR0aCgpKTsKICAgICAgICAgICAgICAgICAgICB2YXIgb3JnX2hlaWdodCA9IHBhcnNlSW50KG9yZ19lbGVtLm91dGVySGVpZ2h0KCkpOwogICAgICAgICAgICAgICAgICAgIHZhciB0aXBfdyA9IHRpcHRpcF9ob2xkZXIub3V0ZXJXaWR0aCgpOwogICAgICAgICAgICAgICAgICAgIHZhciB0aXBfaCA9IHRpcHRpcF9ob2xkZXIub3V0ZXJIZWlnaHQoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgd19jb21wYXJlID0gTWF0aC5yb3VuZCgob3JnX3dpZHRoIC0gdGlwX3cpIC8gMik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhfY29tcGFyZSA9IE1hdGgucm91bmQoKG9yZ19oZWlnaHQgLSB0aXBfaCkgLyAyKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbWFyZ19sZWZ0ID0gTWF0aC5yb3VuZChsZWZ0ICsgd19jb21wYXJlKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbWFyZ190b3AgPSBNYXRoLnJvdW5kKHRvcCArIG9yZ19oZWlnaHQgKyBvcHRzLmVkZ2VPZmZzZXQpOwogICAgICAgICAgICAgICAgICAgIHZhciB0X2NsYXNzID0gIiI7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFycm93X3RvcCA9ICIiOwogICAgICAgICAgICAgICAgICAgIHZhciBhcnJvd19sZWZ0ID0gTWF0aC5yb3VuZCh0aXBfdyAtIDEyKSAvIDI7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHMuZGVmYXVsdFBvc2l0aW9uID09ICJib3R0b20iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRfY2xhc3MgPSAiX2JvdHRvbSIKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wdHMuZGVmYXVsdFBvc2l0aW9uID09ICJ0b3AiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRfY2xhc3MgPSAiX3RvcCIKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wdHMuZGVmYXVsdFBvc2l0aW9uID09ICJsZWZ0IikgewogICAgICAgICAgICAgICAgICAgICAgICB0X2NsYXNzID0gIl9sZWZ0IgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0cy5kZWZhdWx0UG9zaXRpb24gPT0gInJpZ2h0IikgewogICAgICAgICAgICAgICAgICAgICAgICB0X2NsYXNzID0gIl9yaWdodCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIHJpZ2h0X2NvbXBhcmUgPSAod19jb21wYXJlICsgbGVmdCkgPCBwYXJzZUludCgkKHdpbmRvdykuc2Nyb2xsTGVmdCgpKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbGVmdF9jb21wYXJlID0gKHRpcF93ICsgbGVmdCkgPiBwYXJzZUludCgkKHdpbmRvdykud2lkdGgoKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKChyaWdodF9jb21wYXJlICYmIHdfY29tcGFyZSA8IDApIHx8ICh0X2NsYXNzID09ICJfcmlnaHQiICYmICFsZWZ0X2NvbXBhcmUpIHx8ICh0X2NsYXNzID09ICJfbGVmdCIgJiYgbGVmdCA8ICh0aXBfdyArIG9wdHMuZWRnZU9mZnNldCArIDUpKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0X2NsYXNzID0gIl9yaWdodCI7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycm93X3RvcCA9IE1hdGgucm91bmQodGlwX2ggLSAxMykgLyAyOwogICAgICAgICAgICAgICAgICAgICAgICBhcnJvd19sZWZ0ID0gLTEyOwogICAgICAgICAgICAgICAgICAgICAgICBtYXJnX2xlZnQgPSBNYXRoLnJvdW5kKGxlZnQgKyBvcmdfd2lkdGggKyBvcHRzLmVkZ2VPZmZzZXQpOwogICAgICAgICAgICAgICAgICAgICAgICBtYXJnX3RvcCA9IE1hdGgucm91bmQodG9wICsgaF9jb21wYXJlKQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGxlZnRfY29tcGFyZSAmJiB3X2NvbXBhcmUgPCAwKSB8fCAodF9jbGFzcyA9PSAiX2xlZnQiICYmICFyaWdodF9jb21wYXJlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0X2NsYXNzID0gIl9sZWZ0IjsKICAgICAgICAgICAgICAgICAgICAgICAgYXJyb3dfdG9wID0gTWF0aC5yb3VuZCh0aXBfaCAtIDEzKSAvIDI7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycm93X2xlZnQgPSBNYXRoLnJvdW5kKHRpcF93KTsKICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ19sZWZ0ID0gTWF0aC5yb3VuZChsZWZ0IC0gKHRpcF93ICsgb3B0cy5lZGdlT2Zmc2V0ICsgNSkpOwogICAgICAgICAgICAgICAgICAgICAgICBtYXJnX3RvcCA9IE1hdGgucm91bmQodG9wICsgaF9jb21wYXJlKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgdG9wX2NvbXBhcmUgPSAodG9wICsgb3JnX2hlaWdodCArIG9wdHMuZWRnZU9mZnNldCArIHRpcF9oICsgOCkgPiBwYXJzZUludCgkKHdpbmRvdykuaGVpZ2h0KCkgKyAkKHdpbmRvdykuc2Nyb2xsVG9wKCkpOwogICAgICAgICAgICAgICAgICAgIHZhciBib3R0b21fY29tcGFyZSA9ICgodG9wICsgb3JnX2hlaWdodCkgLSAob3B0cy5lZGdlT2Zmc2V0ICsgdGlwX2ggKyA4KSkgPCAwOwogICAgICAgICAgICAgICAgICAgIGlmICh0b3BfY29tcGFyZSB8fCAodF9jbGFzcyA9PSAiX2JvdHRvbSIgJiYgdG9wX2NvbXBhcmUpIHx8ICh0X2NsYXNzID09ICJfdG9wIiAmJiAhYm90dG9tX2NvbXBhcmUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0X2NsYXNzID09ICJfdG9wIiB8fCB0X2NsYXNzID09ICJfYm90dG9tIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdF9jbGFzcyA9ICJfdG9wIgogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdF9jbGFzcyA9IHRfY2xhc3MgKyAiX3RvcCIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhcnJvd190b3AgPSB0aXBfaDsKICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ190b3AgPSBNYXRoLnJvdW5kKHRvcCAtICh0aXBfaCArIDUgKyBvcHRzLmVkZ2VPZmZzZXQpKQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYm90dG9tX2NvbXBhcmUgfCAodF9jbGFzcyA9PSAiX3RvcCIgJiYgYm90dG9tX2NvbXBhcmUpIHx8ICh0X2NsYXNzID09ICJfYm90dG9tIiAmJiAhdG9wX2NvbXBhcmUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0X2NsYXNzID09ICJfdG9wIiB8fCB0X2NsYXNzID09ICJfYm90dG9tIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdF9jbGFzcyA9ICJfYm90dG9tIgogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdF9jbGFzcyA9IHRfY2xhc3MgKyAiX2JvdHRvbSIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhcnJvd190b3AgPSAtMTI7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdfdG9wID0gTWF0aC5yb3VuZCh0b3AgKyBvcmdfaGVpZ2h0ICsgb3B0cy5lZGdlT2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodF9jbGFzcyA9PSAiX3JpZ2h0X3RvcCIgfHwgdF9jbGFzcyA9PSAiX2xlZnRfdG9wIikgewogICAgICAgICAgICAgICAgICAgICAgICBtYXJnX3RvcCA9IG1hcmdfdG9wICsgNQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodF9jbGFzcyA9PSAiX3JpZ2h0X2JvdHRvbSIgfHwgdF9jbGFzcyA9PSAiX2xlZnRfYm90dG9tIikgewogICAgICAgICAgICAgICAgICAgICAgICBtYXJnX3RvcCA9IG1hcmdfdG9wIC0gNQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodF9jbGFzcyA9PSAiX2xlZnRfdG9wIiB8fCB0X2NsYXNzID09ICJfbGVmdF9ib3R0b20iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdfbGVmdCA9IG1hcmdfbGVmdCArIDUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGlwdGlwX2Fycm93LmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICJtYXJnaW4tbGVmdCI6IGFycm93X2xlZnQgKyAicHgiLAogICAgICAgICAgICAgICAgICAgICAgICAibWFyZ2luLXRvcCI6IGFycm93X3RvcCArICJweCIKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB0aXB0aXBfaG9sZGVyLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICJtYXJnaW4tbGVmdCI6IG1hcmdfbGVmdCArICJweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJtYXJnaW4tdG9wIjogbWFyZ190b3AgKyAicHgiCiAgICAgICAgICAgICAgICAgICAgfSkuYXR0cigiY2xhc3MiLCAidGlwIiArIHRfY2xhc3MpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGlwdGlwX2hvbGRlci5zdG9wKHRydWUsIHRydWUpLmZhZGVJbihvcHRzLmZhZGVJbikKICAgICAgICAgICAgICAgICAgICB9LCBvcHRzLmRlbGF5KQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGRlYWN0aXZlX3RpcHRpcCgpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmV4aXQuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGltZW91dCkgewogICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGlwdGlwX2hvbGRlci5mYWRlT3V0KG9wdHMuZmFkZU91dCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pCiAgICB9Cn0pKGpRdWVyeSk7CgovKiBUSU5ZIFNPUlQgKi8KKGZ1bmN0aW9uKGUpIHsKICAgIHZhciBhID0gZmFsc2UsCiAgICAgICAgZyA9IG51bGwsCiAgICAgICAgZiA9IHBhcnNlRmxvYXQsCiAgICAgICAgYiA9IC8oXGQrXC4/XGQqKSQvZzsKICAgIGUudGlueXNvcnQgPSB7CiAgICAgICAgaWQ6ICJUaW55U29ydCIsCiAgICAgICAgdmVyc2lvbjogIjEuMi4xOCIsCiAgICAgICAgY29weXJpZ2h0OiAiQ29weXJpZ2h0IChjKSAyMDA4LTIwMTIgUm9uIFZhbHN0YXIiLAogICAgICAgIHVyaTogImh0dHA6Ly90aW55c29ydC5zamVpdGkuY29tLyIsCiAgICAgICAgbGljZW5jZWQ6IHsKICAgICAgICAgICAgTUlUOiAiaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAiLAogICAgICAgICAgICBHUEw6ICJodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWwiCiAgICAgICAgfSwKICAgICAgICBkZWZhdWx0czogewogICAgICAgICAgICBvcmRlcjogImFzYyIsCiAgICAgICAgICAgIGF0dHI6IGcsCiAgICAgICAgICAgIGRhdGE6IGcsCiAgICAgICAgICAgIHVzZVZhbDogYSwKICAgICAgICAgICAgcGxhY2U6ICJzdGFydCIsCiAgICAgICAgICAgIHJldHVybnM6IGEsCiAgICAgICAgICAgIGNhc2VzOiBhLAogICAgICAgICAgICBmb3JjZVN0cmluZ3M6IGEsCiAgICAgICAgICAgIHNvcnRGdW5jdGlvbjogZwogICAgICAgIH0KICAgIH07CiAgICBlLmZuLmV4dGVuZCh7CiAgICAgICAgdGlueXNvcnQ6IGZ1bmN0aW9uKG0sIGgpIHsKICAgICAgICAgICAgaWYgKG0gJiYgdHlwZW9mKG0pICE9ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBoID0gbTsKICAgICAgICAgICAgICAgIG0gPSBnCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG4gPSBlLmV4dGVuZCh7fSwgZS50aW55c29ydC5kZWZhdWx0cywgaCksCiAgICAgICAgICAgICAgICBzLCBCID0gdGhpcywKICAgICAgICAgICAgICAgIHggPSBlKHRoaXMpLmxlbmd0aCwKICAgICAgICAgICAgICAgIEMgPSB7fSwgcCA9ICEoIW0gfHwgbSA9PSAiIiksCiAgICAgICAgICAgICAgICBxID0gIShuLmF0dHIgPT09IGcgfHwgbi5hdHRyID09ICIiKSwKICAgICAgICAgICAgICAgIHcgPSBuLmRhdGEgIT09IGcsCiAgICAgICAgICAgICAgICBqID0gcCAmJiBtWzBdID09ICI6IiwKICAgICAgICAgICAgICAgIGsgPSBqID8gQi5maWx0ZXIobSkgOiBCLAogICAgICAgICAgICAgICAgciA9IG4uc29ydEZ1bmN0aW9uLAogICAgICAgICAgICAgICAgdiA9IG4ub3JkZXIgPT0gImFzYyIgPyAxIDogLTEsCiAgICAgICAgICAgICAgICBsID0gW107CiAgICAgICAgICAgIGlmICghcikgewogICAgICAgICAgICAgICAgciA9IG4ub3JkZXIgPT0gInJhbmQiID8gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE1hdGgucmFuZG9tKCkgPCAwLjUgPyAxIDogLTEKICAgICAgICAgICAgICAgIH0gOiBmdW5jdGlvbihGLCBFKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSAhbi5jYXNlcyA/IGQoRi5zKSA6IEYucywKICAgICAgICAgICAgICAgICAgICAgICAgSyA9ICFuLmNhc2VzID8gZChFLnMpIDogRS5zOwogICAgICAgICAgICAgICAgICAgIGlmICghbi5mb3JjZVN0cmluZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIEggPSBpLm1hdGNoKGIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgRyA9IEsubWF0Y2goYik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChIICYmIEcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBKID0gaS5zdWJzdHIoMCwgaS5sZW5ndGggLSBIWzBdLmxlbmd0aCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSSA9IEsuc3Vic3RyKDAsIEsubGVuZ3RoIC0gR1swXS5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEogPT0gSSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSBmKEhbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEsgPSBmKEdbMF0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHYgKiAoaSA8IEsgPyAtMSA6IChpID4gSyA/IDEgOiAwKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBCLmVhY2goZnVuY3Rpb24oRywgSCkgewogICAgICAgICAgICAgICAgdmFyIEkgPSBlKEgpLAogICAgICAgICAgICAgICAgICAgIEUgPSBwID8gKGogPyBrLmZpbHRlcihIKSA6IEkuZmluZChtKSkgOiBJLAogICAgICAgICAgICAgICAgICAgIEogPSB3ID8gRS5kYXRhKG4uZGF0YSkgOiAocSA/IEUuYXR0cihuLmF0dHIpIDogKG4udXNlVmFsID8gRS52YWwoKSA6IEUudGV4dCgpKSksCiAgICAgICAgICAgICAgICAgICAgRiA9IEkucGFyZW50KCk7CiAgICAgICAgICAgICAgICBpZiAoIUNbRl0pIHsKICAgICAgICAgICAgICAgICAgICBDW0ZdID0gewogICAgICAgICAgICAgICAgICAgICAgICBzOiBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgbjogW10KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoRS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgQ1tGXS5zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBzOiBKLAogICAgICAgICAgICAgICAgICAgICAgICBlOiBJLAogICAgICAgICAgICAgICAgICAgICAgICBuOiBHCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgQ1tGXS5uLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBlOiBJLAogICAgICAgICAgICAgICAgICAgICAgICBuOiBHCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGZvciAocyBpbiBDKSB7CiAgICAgICAgICAgICAgICBDW3NdLnMuc29ydChyKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAocyBpbiBDKSB7CiAgICAgICAgICAgICAgICB2YXIgeSA9IENbc10sCiAgICAgICAgICAgICAgICAgICAgQSA9IFtdLAogICAgICAgICAgICAgICAgICAgIEQgPSB4LAogICAgICAgICAgICAgICAgICAgIHUgPSBbMCwgMF0sCiAgICAgICAgICAgICAgICAgICAgejsKICAgICAgICAgICAgICAgIHN3aXRjaCAobi5wbGFjZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgImZpcnN0IjoKICAgICAgICAgICAgICAgICAgICAgICAgZS5lYWNoKHkucywgZnVuY3Rpb24oRSwgRikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgRCA9IE1hdGgubWluKEQsIEYubikKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIm9yZyI6CiAgICAgICAgICAgICAgICAgICAgICAgIGUuZWFjaCh5LnMsIGZ1bmN0aW9uKEUsIEYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEEucHVzaChGLm4pCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICBEID0geS5uLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgRCA9IDAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAoeiA9IDA7IHogPCB4OyB6KyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbyA9IGMoQSwgeikgPyAhYSA6IHogPj0gRCAmJiB6IDwgRCArIHkucy5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgIHQgPSAobyA/IHkucyA6IHkubilbdVtvID8gMCA6IDFdXS5lOwogICAgICAgICAgICAgICAgICAgIHQucGFyZW50KCkuYXBwZW5kKHQpOwogICAgICAgICAgICAgICAgICAgIGlmIChvIHx8ICFuLnJldHVybnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbC5wdXNoKHQuZ2V0KDApKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB1W28gPyAwIDogMV0rKwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBCLnB1c2hTdGFjayhsKQogICAgICAgIH0KICAgIH0pOwoKICAgIGZ1bmN0aW9uIGQoaCkgewogICAgICAgIHJldHVybiBoICYmIGgudG9Mb3dlckNhc2UgPyBoLnRvTG93ZXJDYXNlKCkgOiBoCiAgICB9CgogICAgZnVuY3Rpb24gYyhqLCBtKSB7CiAgICAgICAgZm9yICh2YXIgayA9IDAsIGggPSBqLmxlbmd0aDsgayA8IGg7IGsrKykgewogICAgICAgICAgICBpZiAoaltrXSA9PSBtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIWEKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYQogICAgfQogICAgZS5mbi5UaW55U29ydCA9IGUuZm4uVGlueXNvcnQgPSBlLmZuLnRzb3J0ID0gZS5mbi50aW55c29ydAp9KShqUXVlcnkpOwoKLypnbG9iYWwgalF1ZXJ5ICovCi8qanNoaW50IG11bHRpc3RyOnRydWUgYnJvd3Nlcjp0cnVlICovCi8qIQogKiBGaXRWaWRzIDEuMAogKgogKiBDb3B5cmlnaHQgMjAxMSwgQ2hyaXMgQ295aWVyIC0gaHR0cDovL2Nzcy10cmlja3MuY29tICsgRGF2ZSBSdXBlcnQgLSBodHRwOi8vZGF2ZXJ1cGVydC5jb20KICogQ3JlZGl0IHRvIFRoaWVycnkgS29ibGVudHogLSBodHRwOi8vd3d3LmFsaXN0YXBhcnQuY29tL2FydGljbGVzL2NyZWF0aW5nLWludHJpbnNpYy1yYXRpb3MtZm9yLXZpZGVvLwogKiBSZWxlYXNlZCB1bmRlciB0aGUgV1RGUEwgbGljZW5zZSAtIGh0dHA6Ly9zYW0uem95Lm9yZy93dGZwbC8KICoKICogRGF0ZTogVGh1IFNlcHQgMDEgMTg6MDA6MDAgMjAxMSAtMDUwMAogKi8KCihmdW5jdGlvbigkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgICQuZm4uZml0VmlkcyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICB2YXIgc2V0dGluZ3MgPSB7CiAgICAgICAgICAgIGN1c3RvbVNlbGVjdG9yOiBudWxsCiAgICAgICAgfTsKCiAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgICAgICAgICByZWYgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYmFzZScpWzBdIHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKVswXTsKCiAgICAgICAgZGl2LmNsYXNzTmFtZSA9ICdmaXQtdmlkcy1zdHlsZSc7CiAgICAgICAgZGl2LmlubmVySFRNTCA9ICcmc2h5OzxzdHlsZT4gICAgICAgICBcCiAgICAgIC5mbHVpZC13aWR0aC12aWRlby13cmFwcGVyIHsgICAgICAgIFwKICAgICAgICAgd2lkdGg6IDEwMCU7ICAgICAgICAgICAgICAgICAgICAgXAogICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7ICAgICAgICAgICAgICBcCiAgICAgICAgIHBhZGRpbmc6IDA7ICAgICAgICAgICAgICAgICAgICAgIFwKICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgIC5mbHVpZC13aWR0aC12aWRlby13cmFwcGVyIGlmcmFtZSwgIFwKICAgICAgLmZsdWlkLXdpZHRoLXZpZGVvLXdyYXBwZXIgb2JqZWN0LCAgXAogICAgICAuZmx1aWQtd2lkdGgtdmlkZW8td3JhcHBlciBlbWJlZCB7ICBcCiAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgICAgICAgICAgICAgIFwKICAgICAgICAgdG9wOiAwOyAgICAgICAgICAgICAgICAgICAgICAgICAgXAogICAgICAgICBsZWZ0OiAwOyAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgIHdpZHRoOiAxMDAlOyAgICAgICAgICAgICAgICAgICAgIFwKICAgICAgICAgaGVpZ2h0OiAxMDAlOyAgICAgICAgICAgICAgICAgICAgXAogICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICA8L3N0eWxlPic7CgogICAgICAgIHJlZi5wYXJlbnROb2RlLmluc2VydEJlZm9yZShkaXYsIHJlZik7CgogICAgICAgIGlmIChvcHRpb25zKSB7CiAgICAgICAgICAgICQuZXh0ZW5kKHNldHRpbmdzLCBvcHRpb25zKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWxlY3RvcnMgPSBbCiAgICAgICAgICAgICAgICAiaWZyYW1lW3NyYyo9J3BsYXllci52aW1lby5jb20nXSIsCiAgICAgICAgICAgICAgICAiaWZyYW1lW3NyYyo9J3d3dy55b3V0dWJlLmNvbSddIiwKICAgICAgICAgICAgICAgICJpZnJhbWVbc3JjKj0nd3d3LmtpY2tzdGFydGVyLmNvbSddIiwKICAgICAgICAgICAgICAgICJvYmplY3QiLAogICAgICAgICAgICAgICAgImVtYmVkIgogICAgICAgICAgICBdOwoKICAgICAgICAgICAgaWYgKHNldHRpbmdzLmN1c3RvbVNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgICBzZWxlY3RvcnMucHVzaChzZXR0aW5ncy5jdXN0b21TZWxlY3Rvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciAkYWxsVmlkZW9zID0gJCh0aGlzKS5maW5kKHNlbGVjdG9ycy5qb2luKCcsJykpOwoKICAgICAgICAgICAgJGFsbFZpZGVvcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyICR0aGlzID0gJCh0aGlzKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2VtYmVkJyAmJiAkdGhpcy5wYXJlbnQoJ29iamVjdCcpLmxlbmd0aCB8fCAkdGhpcy5wYXJlbnQoJy5mbHVpZC13aWR0aC12aWRlby13cmFwcGVyJykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGhlaWdodCA9ICh0aGlzLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ29iamVjdCcgfHwgKCR0aGlzLmF0dHIoJ2hlaWdodCcpICYmICFpc05hTihwYXJzZUludCgkdGhpcy5hdHRyKCdoZWlnaHQnKSwgMTApKSkpID8gcGFyc2VJbnQoJHRoaXMuYXR0cignaGVpZ2h0JyksIDEwKSA6ICR0aGlzLmhlaWdodCgpLAogICAgICAgICAgICAgICAgICAgIHdpZHRoID0gIWlzTmFOKHBhcnNlSW50KCR0aGlzLmF0dHIoJ3dpZHRoJyksIDEwKSkgPyBwYXJzZUludCgkdGhpcy5hdHRyKCd3aWR0aCcpLCAxMCkgOiAkdGhpcy53aWR0aCgpLAogICAgICAgICAgICAgICAgICAgIGFzcGVjdFJhdGlvID0gaGVpZ2h0IC8gd2lkdGg7CiAgICAgICAgICAgICAgICBpZiAoISR0aGlzLmF0dHIoJ2lkJykpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmlkZW9JRCA9ICdmaXR2aWQnICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogOTk5OTk5KTsKICAgICAgICAgICAgICAgICAgICAkdGhpcy5hdHRyKCdpZCcsIHZpZGVvSUQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHRoaXMud3JhcCgnPGRpdiBjbGFzcz0iZmx1aWQtd2lkdGgtdmlkZW8td3JhcHBlciI+PC9kaXY+JykucGFyZW50KCcuZmx1aWQtd2lkdGgtdmlkZW8td3JhcHBlcicpLmNzcygncGFkZGluZy10b3AnLCAoYXNwZWN0UmF0aW8gKiAxMDApICsgIiUiKTsKICAgICAgICAgICAgICAgICR0aGlzLnJlbW92ZUF0dHIoJ2hlaWdodCcpLnJlbW92ZUF0dHIoJ3dpZHRoJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfTsKfSkoalF1ZXJ5KTsKCgovKioKICogQnhTbGlkZXIgdjQuMCAtIEZ1bGx5IGxvYWRlZCwgcmVzcG9uc2l2ZSBjb250ZW50IHNsaWRlcgogKiBodHRwOi8vYnhzbGlkZXIuY29tCiAqCiAqIENvcHlyaWdodCAyMDEyLCBTdGV2ZW4gV2FuZGVyc2tpIC0gaHR0cDovL3N0ZXZlbndhbmRlcnNraS5jb20gLSBodHRwOi8vYnhjcmVhdGl2ZS5jb20KICogV3JpdHRlbiB3aGlsZSBkcmlua2luZyBCZWxnaWFuIGFsZXMgYW5kIGxpc3RlbmluZyB0byBqYXp6CiAqCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBXVEZQTCBsaWNlbnNlIC0gaHR0cDovL3NhbS56b3kub3JnL3d0ZnBsLwogKi8KKGZ1bmN0aW9uKHQpIHsKICAgIHZhciBlID0ge30sIG4gPSB7CiAgICAgICAgICAgIG1vZGU6ICJob3Jpem9udGFsIiwKICAgICAgICAgICAgc2xpZGVTZWxlY3RvcjogIiIsCiAgICAgICAgICAgIGluZmluaXRlTG9vcDogITAsCiAgICAgICAgICAgIGhpZGVDb250cm9sT25FbmQ6ICExLAogICAgICAgICAgICBzcGVlZDogNTAwLAogICAgICAgICAgICBlYXNpbmc6IG51bGwsCiAgICAgICAgICAgIHNsaWRlTWFyZ2luOiAwLAogICAgICAgICAgICBzdGFydFNsaWRlOiAwLAogICAgICAgICAgICByYW5kb21TdGFydDogITEsCiAgICAgICAgICAgIGNhcHRpb25zOiAhMSwKICAgICAgICAgICAgdGlja2VyOiAhMSwKICAgICAgICAgICAgdGlja2VySG92ZXI6ICExLAogICAgICAgICAgICBhZGFwdGl2ZUhlaWdodDogITEsCiAgICAgICAgICAgIGFkYXB0aXZlSGVpZ2h0U3BlZWQ6IDUwMCwKICAgICAgICAgICAgdG91Y2hFbmFibGVkOiAhMCwKICAgICAgICAgICAgc3dpcGVUaHJlc2hvbGQ6IDUwLAogICAgICAgICAgICB2aWRlbzogITEsCiAgICAgICAgICAgIHVzZUNTUzogITAsCiAgICAgICAgICAgIHBhZ2VyOiAhMCwKICAgICAgICAgICAgcGFnZXJUeXBlOiAiZnVsbCIsCiAgICAgICAgICAgIHBhZ2VyU2hvcnRTZXBhcmF0b3I6ICIgLyAiLAogICAgICAgICAgICBwYWdlclNlbGVjdG9yOiBudWxsLAogICAgICAgICAgICBidWlsZFBhZ2VyOiBudWxsLAogICAgICAgICAgICBwYWdlckN1c3RvbTogbnVsbCwKICAgICAgICAgICAgY29udHJvbHM6ICEwLAogICAgICAgICAgICBuZXh0VGV4dDogIk5leHQiLAogICAgICAgICAgICBwcmV2VGV4dDogIlByZXYiLAogICAgICAgICAgICBuZXh0U2VsZWN0b3I6IG51bGwsCiAgICAgICAgICAgIHByZXZTZWxlY3RvcjogbnVsbCwKICAgICAgICAgICAgYXV0b0NvbnRyb2xzOiAhMSwKICAgICAgICAgICAgc3RhcnRUZXh0OiAiU3RhcnQiLAogICAgICAgICAgICBzdG9wVGV4dDogIlN0b3AiLAogICAgICAgICAgICBhdXRvQ29udHJvbHNDb21iaW5lOiAhMSwKICAgICAgICAgICAgYXV0b0NvbnRyb2xzU2VsZWN0b3I6IG51bGwsCiAgICAgICAgICAgIGF1dG86ICExLAogICAgICAgICAgICBwYXVzZTogNGUzLAogICAgICAgICAgICBhdXRvU3RhcnQ6ICEwLAogICAgICAgICAgICBhdXRvRGlyZWN0aW9uOiAibmV4dCIsCiAgICAgICAgICAgIGF1dG9Ib3ZlcjogITEsCiAgICAgICAgICAgIGF1dG9EZWxheTogMCwKICAgICAgICAgICAgbWluU2xpZGVzOiAxLAogICAgICAgICAgICBtYXhTbGlkZXM6IDEsCiAgICAgICAgICAgIG1vdmVTbGlkZXM6IDAsCiAgICAgICAgICAgIHNsaWRlV2lkdGg6IDAsCiAgICAgICAgICAgIG9uU2xpZGVyTG9hZDogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgb25TbGlkZUJlZm9yZTogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgb25TbGlkZUFmdGVyOiBmdW5jdGlvbigpIHt9LAogICAgICAgICAgICBvblNsaWRlTmV4dDogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgb25TbGlkZVByZXY6IGZ1bmN0aW9uKCkge30KICAgICAgICB9OwogICAgdC5mbi5ieFNsaWRlciA9IGZ1bmN0aW9uKHMpIHsKICAgICAgICBpZiAoMCAhPSB0aGlzLmxlbmd0aCkgewogICAgICAgICAgICBpZiAodGhpcy5sZW5ndGggPiAxKSByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdCh0aGlzKS5ieFNsaWRlcihzKQogICAgICAgICAgICB9KSwgdGhpczsKICAgICAgICAgICAgdmFyIG8gPSB7fSwgciA9IHRoaXM7CiAgICAgICAgICAgIGUuZWwgPSB0aGlzOwogICAgICAgICAgICB2YXIgYSA9IHQod2luZG93KS53aWR0aCgpLAogICAgICAgICAgICAgICAgbCA9IHQod2luZG93KS5oZWlnaHQoKSwKICAgICAgICAgICAgICAgIGQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBvLnNldHRpbmdzID0gdC5leHRlbmQoe30sIG4sIHMpLCBvLmNoaWxkcmVuID0gci5jaGlsZHJlbihvLnNldHRpbmdzLnNsaWRlU2VsZWN0b3IpLCBvLmNoaWxkcmVuLmxlbmd0aCA8IG8uc2V0dGluZ3MubWluU2xpZGVzICYmIChvLnNldHRpbmdzLm1pblNsaWRlcyA9IG8uY2hpbGRyZW4ubGVuZ3RoKSwgby5jaGlsZHJlbi5sZW5ndGggPCBvLnNldHRpbmdzLm1heFNsaWRlcyAmJiAoby5zZXR0aW5ncy5tYXhTbGlkZXMgPSBvLmNoaWxkcmVuLmxlbmd0aCksIG8uc2V0dGluZ3MucmFuZG9tU3RhcnQgJiYgKG8uc2V0dGluZ3Muc3RhcnRTbGlkZSA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIG8uY2hpbGRyZW4ubGVuZ3RoKSksIG8uYWN0aXZlID0gewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogby5zZXR0aW5ncy5zdGFydFNsaWRlCiAgICAgICAgICAgICAgICAgICAgfSwgby5jYXJvdXNlbCA9IG8uc2V0dGluZ3MubWluU2xpZGVzID4gMSB8fCBvLnNldHRpbmdzLm1heFNsaWRlcyA+IDEsIG8ubWluVGhyZXNob2xkID0gby5zZXR0aW5ncy5taW5TbGlkZXMgKiBvLnNldHRpbmdzLnNsaWRlV2lkdGggKyAoby5zZXR0aW5ncy5taW5TbGlkZXMgLSAxKSAqIG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4sIG8ubWF4VGhyZXNob2xkID0gby5zZXR0aW5ncy5tYXhTbGlkZXMgKiBvLnNldHRpbmdzLnNsaWRlV2lkdGggKyAoby5zZXR0aW5ncy5tYXhTbGlkZXMgLSAxKSAqIG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4sIG8ud29ya2luZyA9ICExLCBvLmNvbnRyb2xzID0ge30sIG8uaW50ZXJ2YWwgPSBudWxsLCBvLmFuaW1Qcm9wID0gInZlcnRpY2FsIiA9PSBvLnNldHRpbmdzLm1vZGUgPyAidG9wIiA6ICJsZWZ0Iiwgby51c2luZ0NTUyA9IG8uc2V0dGluZ3MudXNlQ1NTICYmICJmYWRlIiAhPSBvLnNldHRpbmdzLm1vZGUgJiYgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlID0gWyJXZWJraXRQZXJzcGVjdGl2ZSIsICJNb3pQZXJzcGVjdGl2ZSIsICJPUGVyc3BlY3RpdmUiLCAibXNQZXJzcGVjdGl2ZSJdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSB0LnN0eWxlW2VbaV1dKSByZXR1cm4gby5jc3NQcmVmaXggPSBlW2ldLnJlcGxhY2UoIlBlcnNwZWN0aXZlIiwgIiIpLnRvTG93ZXJDYXNlKCksIG8uYW5pbVByb3AgPSAiLSIgKyBvLmNzc1ByZWZpeCArICItdHJhbnNmb3JtIiwgITA7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhMQogICAgICAgICAgICAgICAgICAgIH0oKSwgInZlcnRpY2FsIiA9PSBvLnNldHRpbmdzLm1vZGUgJiYgKG8uc2V0dGluZ3MubWF4U2xpZGVzID0gby5zZXR0aW5ncy5taW5TbGlkZXMpLCBjKCkKICAgICAgICAgICAgICAgIH0sIGMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoci53cmFwKCc8ZGl2IGNsYXNzPSJieC13cmFwcGVyIj48ZGl2IGNsYXNzPSJieC12aWV3cG9ydCI+PC9kaXY+PC9kaXY+JyksIG8udmlld3BvcnQgPSByLnBhcmVudCgpLCBvLmxvYWRlciA9IHQoJzxkaXYgY2xhc3M9ImJ4LWxvYWRpbmciIC8+JyksIG8udmlld3BvcnQucHJlcGVuZChvLmxvYWRlciksIHIuY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6ICJob3Jpem9udGFsIiA9PSBvLnNldHRpbmdzLm1vZGUgPyAyMTUgKiBvLmNoaWxkcmVuLmxlbmd0aCArICIlIiA6ICJhdXRvIiwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIKICAgICAgICAgICAgICAgICAgICB9KSwgby51c2luZ0NTUyAmJiBvLnNldHRpbmdzLmVhc2luZyA/IHIuY3NzKCItIiArIG8uY3NzUHJlZml4ICsgIi10cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiIsIG8uc2V0dGluZ3MuZWFzaW5nKSA6IG8uc2V0dGluZ3MuZWFzaW5nIHx8IChvLnNldHRpbmdzLmVhc2luZyA9ICJzd2luZyIpLCBvLnZpZXdwb3J0LmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJmbG93OiAiaGlkZGVuIiwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIKICAgICAgICAgICAgICAgICAgICB9KSwgby5jaGlsZHJlbi5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICAiZmxvYXQiOiAiaG9yaXpvbnRhbCIgPT0gby5zZXR0aW5ncy5tb2RlID8gImxlZnQiIDogIm5vbmUiLAogICAgICAgICAgICAgICAgICAgICAgICBsaXN0U3R5bGU6ICJub25lIiwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIKICAgICAgICAgICAgICAgICAgICB9KSwgby5jaGlsZHJlbi53aWR0aChoKCkpLCAiaG9yaXpvbnRhbCIgPT0gby5zZXR0aW5ncy5tb2RlICYmIG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4gPiAwICYmIG8uY2hpbGRyZW4uY3NzKCJtYXJnaW5SaWdodCIsIG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4pLCAidmVydGljYWwiID09IG8uc2V0dGluZ3MubW9kZSAmJiBvLnNldHRpbmdzLnNsaWRlTWFyZ2luID4gMCAmJiBvLmNoaWxkcmVuLmNzcygibWFyZ2luQm90dG9tIiwgby5zZXR0aW5ncy5zbGlkZU1hcmdpbiksICJmYWRlIiA9PSBvLnNldHRpbmdzLm1vZGUgJiYgKG8uY2hpbGRyZW4uY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgIHpJbmRleDogMCwKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogIm5vbmUiCiAgICAgICAgICAgICAgICAgICAgfSksIG8uY2hpbGRyZW4uZXEoby5zZXR0aW5ncy5zdGFydFNsaWRlKS5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDUwLAogICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiYmxvY2siCiAgICAgICAgICAgICAgICAgICAgfSkpLCBvLmNvbnRyb2xzLmVsID0gdCgnPGRpdiBjbGFzcz0iYngtY29udHJvbHMiIC8+JyksIG8uc2V0dGluZ3MuY2FwdGlvbnMgJiYgVCgpLCBvLnNldHRpbmdzLmluZmluaXRlTG9vcCAmJiAiZmFkZSIgIT0gby5zZXR0aW5ncy5tb2RlICYmICFvLnNldHRpbmdzLnRpY2tlcikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZSA9ICJ2ZXJ0aWNhbCIgPT0gby5zZXR0aW5ncy5tb2RlID8gby5zZXR0aW5ncy5taW5TbGlkZXMgOiBvLnNldHRpbmdzLm1heFNsaWRlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSBvLmNoaWxkcmVuLnNsaWNlKDAsIGUpLmNsb25lKCkuYWRkQ2xhc3MoImJ4LWNsb25lIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuID0gby5jaGlsZHJlbi5zbGljZSgtZSkuY2xvbmUoKS5hZGRDbGFzcygiYngtY2xvbmUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgci5hcHBlbmQoaSkucHJlcGVuZChuKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBvLmFjdGl2ZS5sYXN0ID0gby5zZXR0aW5ncy5zdGFydFNsaWRlID09IHYoKSAtIDEsIG8uc2V0dGluZ3MudmlkZW8gJiYgci5maXRWaWRzKCksIG8uc2V0dGluZ3MudGlja2VyIHx8IChvLnNldHRpbmdzLnBhZ2VyICYmIFMoKSwgby5zZXR0aW5ncy5jb250cm9scyAmJiBiKCksIG8uc2V0dGluZ3MuYXV0byAmJiBvLnNldHRpbmdzLmF1dG9Db250cm9scyAmJiB3KCksIChvLnNldHRpbmdzLmNvbnRyb2xzIHx8IG8uc2V0dGluZ3MuYXV0b0NvbnRyb2xzIHx8IG8uc2V0dGluZ3MucGFnZXIpICYmIG8udmlld3BvcnQuYWZ0ZXIoby5jb250cm9scy5lbCkpLCByLmNoaWxkcmVuKCkuaW1hZ2VzTG9hZGVkKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBvLmxvYWRlci5yZW1vdmUoKSwgZigpLCAidmVydGljYWwiID09IG8uc2V0dGluZ3MubW9kZSAmJiAoby5zZXR0aW5ncy5hZGFwdGl2ZUhlaWdodCA9ICEwKSwgby52aWV3cG9ydC5oZWlnaHQoZygpKSwgby5zZXR0aW5ncy5vblNsaWRlckxvYWQoby5hY3RpdmUuaW5kZXgpLCBvLmluaXRpYWxpemVkID0gITAsIHQod2luZG93KS5iaW5kKCJyZXNpemUiLCBPKSwgby5zZXR0aW5ncy5hdXRvICYmIG8uc2V0dGluZ3MuYXV0b1N0YXJ0ICYmIEwoKSwgby5zZXR0aW5ncy50aWNrZXIgJiYgRCgpLCBvLnNldHRpbmdzLnBhZ2VyICYmIHkoby5zZXR0aW5ncy5zdGFydFNsaWRlKSwgby5zZXR0aW5ncy5jb250cm9scyAmJiBxKCksIG8uc2V0dGluZ3MudG91Y2hFbmFibGVkICYmICFvLnNldHRpbmdzLnRpY2tlciAmJiBIKCkKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfSwgZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBlID0gMCwKICAgICAgICAgICAgICAgICAgICAgICAgbiA9IHQoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoInZlcnRpY2FsIiA9PSBvLnNldHRpbmdzLm1vZGUgfHwgby5zZXR0aW5ncy5hZGFwdGl2ZUhlaWdodCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG8uY2Fyb3VzZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzID0gMSA9PSBvLnNldHRpbmdzLm1vdmVTbGlkZXMgPyBvLmFjdGl2ZS5pbmRleCA6IG8uYWN0aXZlLmluZGV4ICogcCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChuID0gby5jaGlsZHJlbi5lcShzKSwgaSA9IDE7IG8uc2V0dGluZ3MubWF4U2xpZGVzIC0gMSA+PSBpOyBpKyspIG4gPSBzICsgaSA+PSBvLmNoaWxkcmVuLmxlbmd0aCA/IG4uYWRkKG8uY2hpbGRyZW4uZXEoaSAtIDEpKSA6IG4uYWRkKG8uY2hpbGRyZW4uZXEocyArIGkpKQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgbiA9IG8uY2hpbGRyZW4uZXEoby5hY3RpdmUuaW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIG4gPSBvLmNoaWxkcmVuOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAidmVydGljYWwiID09IG8uc2V0dGluZ3MubW9kZSA/IChuLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGUgKz0gdCh0aGlzKS5vdXRlckhlaWdodCgpCiAgICAgICAgICAgICAgICAgICAgfSksIG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4gPiAwICYmIChlICs9IG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4gKiAoby5zZXR0aW5ncy5taW5TbGlkZXMgLSAxKSkpIDogZSA9IE1hdGgubWF4LmFwcGx5KE1hdGgsIG4ubWFwKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdCh0aGlzKS5vdXRlckhlaWdodCghMSkKICAgICAgICAgICAgICAgICAgICB9KS5nZXQoKSksIGUKICAgICAgICAgICAgICAgIH0sIGggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IG8uc2V0dGluZ3Muc2xpZGVXaWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgZSA9IG8udmlld3BvcnQud2lkdGgoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMCA9PSBvLnNldHRpbmdzLnNsaWRlV2lkdGggPyB0ID0gZSA6IGUgPiBvLm1heFRocmVzaG9sZCA/IHQgPSAoZSAtIG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4gKiAoby5zZXR0aW5ncy5tYXhTbGlkZXMgLSAxKSkgLyBvLnNldHRpbmdzLm1heFNsaWRlcyA6IG8ubWluVGhyZXNob2xkID4gZSAmJiAodCA9IChlIC0gby5zZXR0aW5ncy5zbGlkZU1hcmdpbiAqIChvLnNldHRpbmdzLm1pblNsaWRlcyAtIDEpKSAvIG8uc2V0dGluZ3MubWluU2xpZGVzKSwgdAogICAgICAgICAgICAgICAgfSwgdSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gMTsKICAgICAgICAgICAgICAgICAgICBpZiAoImhvcml6b250YWwiID09IG8uc2V0dGluZ3MubW9kZSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG8udmlld3BvcnQud2lkdGgoKSA8IG8ubWluVGhyZXNob2xkKSB0ID0gby5zZXR0aW5ncy5taW5TbGlkZXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBpZiAoby52aWV3cG9ydC53aWR0aCgpID4gby5tYXhUaHJlc2hvbGQpIHQgPSBvLnNldHRpbmdzLm1heFNsaWRlczsKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSBvLmNoaWxkcmVuLmZpcnN0KCkud2lkdGgoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdCA9IE1hdGguZmxvb3Ioby52aWV3cG9ydC53aWR0aCgpIC8gZSkKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgInZlcnRpY2FsIiA9PSBvLnNldHRpbmdzLm1vZGUgJiYgKHQgPSBvLnNldHRpbmdzLm1pblNsaWRlcyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHQKICAgICAgICAgICAgICAgIH0sIHYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKG8uc2V0dGluZ3MubW92ZVNsaWRlcyA+IDApCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvLnNldHRpbmdzLmluZmluaXRlTG9vcCkgdCA9IG8uY2hpbGRyZW4ubGVuZ3RoIC8gcCgpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBlID0gMCwgaSA9IDA7IG8uY2hpbGRyZW4ubGVuZ3RoID4gZTspKyt0LCBlID0gaSArIHUoKSwgaSArPSBvLnNldHRpbmdzLm1vdmVTbGlkZXMgPD0gdSgpID8gby5zZXR0aW5ncy5tb3ZlU2xpZGVzIDogdSgpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHQgPSBNYXRoLmNlaWwoby5jaGlsZHJlbi5sZW5ndGggLyB1KCkpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0CiAgICAgICAgICAgICAgICB9LCBwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG8uc2V0dGluZ3MubW92ZVNsaWRlcyA+IDAgJiYgby5zZXR0aW5ncy5tb3ZlU2xpZGVzIDw9IHUoKSA/IG8uc2V0dGluZ3MubW92ZVNsaWRlcyA6IHUoKQogICAgICAgICAgICAgICAgfSwgZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChvLmFjdGl2ZS5sYXN0ICYmICFvLnNldHRpbmdzLmluZmluaXRlTG9vcCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoImhvcml6b250YWwiID09IG8uc2V0dGluZ3MubW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSBvLmNoaWxkcmVuLmxhc3QoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlID0gdC5wb3NpdGlvbigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgeCgtKGUubGVmdCAtIChvLnZpZXdwb3J0LndpZHRoKCkgLSB0LndpZHRoKCkpKSwgInJlc2V0IiwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgidmVydGljYWwiID09IG8uc2V0dGluZ3MubW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSBvLmNoaWxkcmVuLmxlbmd0aCAtIG8uc2V0dGluZ3MubWluU2xpZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBvLmNoaWxkcmVuLmVxKGkpLnBvc2l0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4KC1lLnRvcCwgInJlc2V0IiwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlID0gby5jaGlsZHJlbi5lcShvLmFjdGl2ZS5pbmRleCAqIHAoKSkucG9zaXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgby5hY3RpdmUuaW5kZXggPT0gdigpIC0gMSAmJiAoby5hY3RpdmUubGFzdCA9ICEwKSwgdm9pZCAwICE9IGUgJiYgKCJob3Jpem9udGFsIiA9PSBvLnNldHRpbmdzLm1vZGUgPyB4KC1lLmxlZnQsICJyZXNldCIsIDApIDogInZlcnRpY2FsIiA9PSBvLnNldHRpbmdzLm1vZGUgJiYgeCgtZS50b3AsICJyZXNldCIsIDApKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHggPSBmdW5jdGlvbih0LCBlLCBpLCBuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG8udXNpbmdDU1MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHMgPSAidmVydGljYWwiID09IG8uc2V0dGluZ3MubW9kZSA/ICJ0cmFuc2xhdGUzZCgwLCAiICsgdCArICJweCwgMCkiIDogInRyYW5zbGF0ZTNkKCIgKyB0ICsgInB4LCAwLCAwKSI7CiAgICAgICAgICAgICAgICAgICAgICAgIHIuY3NzKCItIiArIG8uY3NzUHJlZml4ICsgIi10cmFuc2l0aW9uLWR1cmF0aW9uIiwgaSAvIDFlMyArICJzIiksICJzbGlkZSIgPT0gZSA/IChyLmNzcyhvLmFuaW1Qcm9wLCBzKSwgci5iaW5kKCJ0cmFuc2l0aW9uZW5kIHdlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQgTVNUcmFuc2l0aW9uRW5kIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByLnVuYmluZCgidHJhbnNpdGlvbmVuZCB3ZWJraXRUcmFuc2l0aW9uRW5kIG9UcmFuc2l0aW9uRW5kIE1TVHJhbnNpdGlvbkVuZCIpLCB6KCkKICAgICAgICAgICAgICAgICAgICAgICAgfSkpIDogInJlc2V0IiA9PSBlID8gci5jc3Moby5hbmltUHJvcCwgcykgOiAidGlja2VyIiA9PSBlICYmIChyLmNzcygiLSIgKyBvLmNzc1ByZWZpeCArICItdHJhbnNpdGlvbi10aW1pbmctZnVuY3Rpb24iLCAibGluZWFyIiksIHIuY3NzKG8uYW5pbVByb3AsIHMpLCByLmJpbmQoInRyYW5zaXRpb25lbmQgd2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCBNU1RyYW5zaXRpb25FbmQiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIudW5iaW5kKCJ0cmFuc2l0aW9uZW5kIHdlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQgTVNUcmFuc2l0aW9uRW5kIiksIHgobi5yZXNldFZhbHVlLCAicmVzZXQiLCAwKSwgSSgpCiAgICAgICAgICAgICAgICAgICAgICAgIH0pKQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGFbby5hbmltUHJvcF0gPSB0LCAic2xpZGUiID09IGUgPyByLmFuaW1hdGUoYSwgaSwgby5zZXR0aW5ncy5lYXNpbmcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeigpCiAgICAgICAgICAgICAgICAgICAgICAgIH0pIDogInJlc2V0IiA9PSBlID8gci5jc3Moby5hbmltUHJvcCwgdCkgOiAidGlja2VyIiA9PSBlICYmIHIuYW5pbWF0ZShhLCBzcGVlZCwgImxpbmVhciIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeChuLnJlc2V0VmFsdWUsICJyZXNldCIsIDApLCBJKCkKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBtID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSAiIjsKICAgICAgICAgICAgICAgICAgICBwYWdlclF0eSA9IHYoKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgcGFnZXJRdHkgPiBpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgby5zZXR0aW5ncy5idWlsZFBhZ2VyICYmIHQuaXNGdW5jdGlvbihvLnNldHRpbmdzLmJ1aWxkUGFnZXIpID8gKG4gPSBvLnNldHRpbmdzLmJ1aWxkUGFnZXIoaSksIG8ucGFnZXJFbC5hZGRDbGFzcygiYngtY3VzdG9tLXBhZ2VyIikpIDogKG4gPSBpICsgMSwgby5wYWdlckVsLmFkZENsYXNzKCJieC1kZWZhdWx0LXBhZ2VyIikpLCBlICs9ICc8ZGl2IGNsYXNzPSJieC1wYWdlci1pdGVtIj48YSBocmVmPSIiIGRhdGEtc2xpZGUtaW5kZXg9IicgKyBpICsgJyIgY2xhc3M9ImJ4LXBhZ2VyLWxpbmsiPicgKyBuICsgIjwvYT48L2Rpdj4iCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG8ucGFnZXJFbC5odG1sKGUpCiAgICAgICAgICAgICAgICB9LCBTID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgby5zZXR0aW5ncy5wYWdlckN1c3RvbSA/IG8ucGFnZXJFbCA9IHQoby5zZXR0aW5ncy5wYWdlckN1c3RvbSkgOiAoby5wYWdlckVsID0gdCgnPGRpdiBjbGFzcz0iYngtcGFnZXIiIC8+JyksIG8uc2V0dGluZ3MucGFnZXJTZWxlY3RvciA/IHQoby5zZXR0aW5ncy5wYWdlclNlbGVjdG9yKS5odG1sKG8ucGFnZXJFbCkgOiBvLmNvbnRyb2xzLmVsLmFkZENsYXNzKCJieC1oYXMtcGFnZXIiKS5hcHBlbmQoby5wYWdlckVsKSwgbSgpKSwgby5wYWdlckVsLmRlbGVnYXRlKCJhIiwgImNsaWNrIiwgaykKICAgICAgICAgICAgICAgIH0sIGIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBvLmNvbnRyb2xzLm5leHQgPSB0KCc8YSBjbGFzcz0iYngtbmV4dCIgaHJlZj0iIj4nICsgby5zZXR0aW5ncy5uZXh0VGV4dCArICI8L2E+IiksIG8uY29udHJvbHMucHJldiA9IHQoJzxhIGNsYXNzPSJieC1wcmV2IiBocmVmPSIiPicgKyBvLnNldHRpbmdzLnByZXZUZXh0ICsgIjwvYT4iKSwgby5jb250cm9scy5uZXh0LmJpbmQoImNsaWNrIiwgQyksIG8uY29udHJvbHMucHJldi5iaW5kKCJjbGljayIsIEUpLCBvLnNldHRpbmdzLm5leHRTZWxlY3RvciAmJiB0KG8uc2V0dGluZ3MubmV4dFNlbGVjdG9yKS5hcHBlbmQoby5jb250cm9scy5uZXh0KSwgby5zZXR0aW5ncy5wcmV2U2VsZWN0b3IgJiYgdChvLnNldHRpbmdzLnByZXZTZWxlY3RvcikuYXBwZW5kKG8uY29udHJvbHMucHJldiksIG8uc2V0dGluZ3MubmV4dFNlbGVjdG9yIHx8IG8uc2V0dGluZ3MucHJldlNlbGVjdG9yIHx8IChvLmNvbnRyb2xzLmRpcmVjdGlvbkVsID0gdCgnPGRpdiBjbGFzcz0iYngtY29udHJvbHMtZGlyZWN0aW9uIiAvPicpLCBvLmNvbnRyb2xzLmRpcmVjdGlvbkVsLmFwcGVuZChvLmNvbnRyb2xzLnByZXYpLmFwcGVuZChvLmNvbnRyb2xzLm5leHQpLCBvLmNvbnRyb2xzLmVsLmFkZENsYXNzKCJieC1oYXMtY29udHJvbHMtZGlyZWN0aW9uIikuYXBwZW5kKG8uY29udHJvbHMuZGlyZWN0aW9uRWwpKQogICAgICAgICAgICAgICAgfSwgdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIG8uY29udHJvbHMuc3RhcnQgPSB0KCc8ZGl2IGNsYXNzPSJieC1jb250cm9scy1hdXRvLWl0ZW0iPjxhIGNsYXNzPSJieC1zdGFydCIgaHJlZj0iIj4nICsgby5zZXR0aW5ncy5zdGFydFRleHQgKyAiPC9hPjwvZGl2PiIpLCBvLmNvbnRyb2xzLnN0b3AgPSB0KCc8ZGl2IGNsYXNzPSJieC1jb250cm9scy1hdXRvLWl0ZW0iPjxhIGNsYXNzPSJieC1zdG9wIiBocmVmPSIiPicgKyBvLnNldHRpbmdzLnN0b3BUZXh0ICsgIjwvYT48L2Rpdj4iKSwgby5jb250cm9scy5hdXRvRWwgPSB0KCc8ZGl2IGNsYXNzPSJieC1jb250cm9scy1hdXRvIiAvPicpLCBvLmNvbnRyb2xzLmF1dG9FbC5kZWxlZ2F0ZSgiLmJ4LXN0YXJ0IiwgImNsaWNrIiwgQSksIG8uY29udHJvbHMuYXV0b0VsLmRlbGVnYXRlKCIuYngtc3RvcCIsICJjbGljayIsIFApLCBvLnNldHRpbmdzLmF1dG9Db250cm9sc0NvbWJpbmUgPyBvLmNvbnRyb2xzLmF1dG9FbC5hcHBlbmQoby5jb250cm9scy5zdGFydCkgOiBvLmNvbnRyb2xzLmF1dG9FbC5hcHBlbmQoby5jb250cm9scy5zdGFydCkuYXBwZW5kKG8uY29udHJvbHMuc3RvcCksIG8uc2V0dGluZ3MuYXV0b0NvbnRyb2xzU2VsZWN0b3IgPyB0KG8uc2V0dGluZ3MuYXV0b0NvbnRyb2xzU2VsZWN0b3IpLmh0bWwoby5jb250cm9scy5hdXRvRWwpIDogby5jb250cm9scy5lbC5hZGRDbGFzcygiYngtaGFzLWNvbnRyb2xzLWF1dG8iKS5hcHBlbmQoby5jb250cm9scy5hdXRvRWwpLCBNKG8uc2V0dGluZ3MuYXV0b1N0YXJ0ID8gInN0b3AiIDogInN0YXJ0IikKICAgICAgICAgICAgICAgIH0sIFQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBvLmNoaWxkcmVuLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlID0gdCh0aGlzKS5maW5kKCJpbWc6Zmlyc3QiKS5hdHRyKCJ0aXRsZSIpOwogICAgICAgICAgICAgICAgICAgICAgICB2b2lkIDAgIT0gZSAmJiB0KHRoaXMpLmFwcGVuZCgnPGRpdiBjbGFzcz0iYngtY2FwdGlvbiI+PHNwYW4+JyArIGUgKyAiPC9zcGFuPjwvZGl2PiIpCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0sIEMgPSBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgby5zZXR0aW5ncy5hdXRvICYmIHIuc3RvcEF1dG8oKSwgci5nb1RvTmV4dFNsaWRlKCksIHQucHJldmVudERlZmF1bHQoKQogICAgICAgICAgICAgICAgfSwgRSA9IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICBvLnNldHRpbmdzLmF1dG8gJiYgci5zdG9wQXV0bygpLCByLmdvVG9QcmV2U2xpZGUoKSwgdC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgICAgICAgICB9LCBBID0gZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgIHIuc3RhcnRBdXRvKCksIHQucHJldmVudERlZmF1bHQoKQogICAgICAgICAgICAgICAgfSwgUCA9IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICByLnN0b3BBdXRvKCksIHQucHJldmVudERlZmF1bHQoKQogICAgICAgICAgICAgICAgfSwgayA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBvLnNldHRpbmdzLmF1dG8gJiYgci5zdG9wQXV0bygpOwogICAgICAgICAgICAgICAgICAgIHZhciBpID0gdChlLmN1cnJlbnRUYXJnZXQpLAogICAgICAgICAgICAgICAgICAgICAgICBuID0gcGFyc2VJbnQoaS5hdHRyKCJkYXRhLXNsaWRlLWluZGV4IikpOwogICAgICAgICAgICAgICAgICAgIG4gIT0gby5hY3RpdmUuaW5kZXggJiYgci5nb1RvU2xpZGUobiksIGUucHJldmVudERlZmF1bHQoKQogICAgICAgICAgICAgICAgfSwgeSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gInNob3J0IiA9PSBvLnNldHRpbmdzLnBhZ2VyVHlwZSA/IChvLnBhZ2VyRWwuaHRtbChlICsgMSArIG8uc2V0dGluZ3MucGFnZXJTaG9ydFNlcGFyYXRvciArIG8uY2hpbGRyZW4ubGVuZ3RoKSwgdm9pZCAwKSA6IChvLnBhZ2VyRWwuZmluZCgiYSIpLnJlbW92ZUNsYXNzKCJhY3RpdmUiKSwgby5wYWdlckVsLmVhY2goZnVuY3Rpb24oaSwgbikgewogICAgICAgICAgICAgICAgICAgICAgICB0KG4pLmZpbmQoImEiKS5lcShlKS5hZGRDbGFzcygiYWN0aXZlIikKICAgICAgICAgICAgICAgICAgICB9KSwgdm9pZCAwKQogICAgICAgICAgICAgICAgfSwgeiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChvLnNldHRpbmdzLmluZmluaXRlTG9vcCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdCA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICAwID09IG8uYWN0aXZlLmluZGV4ID8gdCA9IG8uY2hpbGRyZW4uZXEoMCkucG9zaXRpb24oKSA6IG8uYWN0aXZlLmluZGV4ID09IHYoKSAtIDEgJiYgby5jYXJvdXNlbCA/IHQgPSBvLmNoaWxkcmVuLmVxKCh2KCkgLSAxKSAqIHAoKSkucG9zaXRpb24oKSA6IG8uYWN0aXZlLmluZGV4ID09IG8uY2hpbGRyZW4ubGVuZ3RoIC0gMSAmJiAodCA9IG8uY2hpbGRyZW4uZXEoby5jaGlsZHJlbi5sZW5ndGggLSAxKS5wb3NpdGlvbigpKSwgImhvcml6b250YWwiID09IG8uc2V0dGluZ3MubW9kZSA/IHgoLXQubGVmdCwgInJlc2V0IiwgMCkgOiAidmVydGljYWwiID09IG8uc2V0dGluZ3MubW9kZSAmJiB4KC10LnRvcCwgInJlc2V0IiwgMCkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgby53b3JraW5nID0gITEsIG8uc2V0dGluZ3Mub25TbGlkZUFmdGVyKG8uY2hpbGRyZW4uZXEoby5hY3RpdmUuaW5kZXgpLCBvLm9sZEluZGV4LCBvLmFjdGl2ZS5pbmRleCkKICAgICAgICAgICAgICAgIH0sIE0gPSBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgby5zZXR0aW5ncy5hdXRvQ29udHJvbHNDb21iaW5lID8gby5jb250cm9scy5hdXRvRWwuaHRtbChvLmNvbnRyb2xzW3RdKSA6IChvLmNvbnRyb2xzLmF1dG9FbC5maW5kKCJhIikucmVtb3ZlQ2xhc3MoImFjdGl2ZSIpLCBvLmNvbnRyb2xzLmF1dG9FbC5maW5kKCJhOm5vdCguYngtIiArIHQgKyAiKSIpLmFkZENsYXNzKCJhY3RpdmUiKSkKICAgICAgICAgICAgICAgIH0sIHEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAhby5zZXR0aW5ncy5pbmZpbml0ZUxvb3AgJiYgby5zZXR0aW5ncy5oaWRlQ29udHJvbE9uRW5kICYmICgwID09IG8uYWN0aXZlLmluZGV4ID8gKG8uY29udHJvbHMucHJldi5hZGRDbGFzcygiZGlzYWJsZWQiKSwgby5jb250cm9scy5uZXh0LnJlbW92ZUNsYXNzKCJkaXNhYmxlZCIpKSA6IG8uYWN0aXZlLmluZGV4ID09IHYoKSAtIDEgPyAoby5jb250cm9scy5uZXh0LmFkZENsYXNzKCJkaXNhYmxlZCIpLCBvLmNvbnRyb2xzLnByZXYucmVtb3ZlQ2xhc3MoImRpc2FibGVkIikpIDogKG8uY29udHJvbHMucHJldi5yZW1vdmVDbGFzcygiZGlzYWJsZWQiKSwgby5jb250cm9scy5uZXh0LnJlbW92ZUNsYXNzKCJkaXNhYmxlZCIpKSkKICAgICAgICAgICAgICAgIH0sIEwgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBvLnNldHRpbmdzLmF1dG9EZWxheSA+IDAgPyBzZXRUaW1lb3V0KHIuc3RhcnRBdXRvLCBvLnNldHRpbmdzLmF1dG9EZWxheSkgOiByLnN0YXJ0QXV0bygpLCBvLnNldHRpbmdzLmF1dG9Ib3ZlciAmJiByLmhvdmVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBvLmludGVydmFsICYmIChyLnN0b3BBdXRvKCEwKSwgby5hdXRvUGF1c2VkID0gITApCiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG8uYXV0b1BhdXNlZCAmJiAoci5zdGFydEF1dG8oITApLCBvLmF1dG9QYXVzZWQgPSBudWxsKQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB9LCBEID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmICgibmV4dCIgPT0gby5zZXR0aW5ncy5hdXRvRGlyZWN0aW9uKSByLmFwcGVuZChvLmNoaWxkcmVuLmNsb25lKCkuYWRkQ2xhc3MoImJ4LWNsb25lIikpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByLnByZXBlbmQoby5jaGlsZHJlbi5jbG9uZSgpLmFkZENsYXNzKCJieC1jbG9uZSIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSBvLmNoaWxkcmVuLmZpcnN0KCkucG9zaXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgZSA9ICJob3Jpem9udGFsIiA9PSBvLnNldHRpbmdzLm1vZGUgPyAtaS5sZWZ0IDogLWkudG9wCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHgoZSwgInJlc2V0IiwgMCksIG8uc2V0dGluZ3MucGFnZXIgPSAhMSwgby5zZXR0aW5ncy5jb250cm9scyA9ICExLCBvLnNldHRpbmdzLmF1dG9Db250cm9scyA9ICExLCBvLnNldHRpbmdzLnRpY2tlckhvdmVyICYmICFvLnVzaW5nQ1NTICYmIG8udmlld3BvcnQuaG92ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHIuc3RvcCgpCiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgby5jaGlsZHJlbi5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZSArPSAiaG9yaXpvbnRhbCIgPT0gby5zZXR0aW5ncy5tb2RlID8gdCh0aGlzKS5vdXRlcldpZHRoKCEwKSA6IHQodGhpcykub3V0ZXJIZWlnaHQoITApCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IG8uc2V0dGluZ3Muc3BlZWQgLyBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbiA9ICJob3Jpem9udGFsIiA9PSBvLnNldHRpbmdzLm1vZGUgPyAibGVmdCIgOiAidG9wIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMgPSBpICogKGUgLSBNYXRoLmFicyhwYXJzZUludChyLmNzcyhuKSkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgSShzKQogICAgICAgICAgICAgICAgICAgIH0pLCBJKCkKICAgICAgICAgICAgICAgIH0sIEkgPSBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgc3BlZWQgPSB0ID8gdCA6IG8uc2V0dGluZ3Muc3BlZWQ7CiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogMAogICAgICAgICAgICAgICAgICAgIH0sIGkgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiAwCiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgIm5leHQiID09IG8uc2V0dGluZ3MuYXV0b0RpcmVjdGlvbiA/IGUgPSByLmZpbmQoIi5ieC1jbG9uZSIpLmZpcnN0KCkucG9zaXRpb24oKSA6IGkgPSBvLmNoaWxkcmVuLmZpcnN0KCkucG9zaXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbiA9ICJob3Jpem9udGFsIiA9PSBvLnNldHRpbmdzLm1vZGUgPyAtZS5sZWZ0IDogLWUudG9wLAogICAgICAgICAgICAgICAgICAgICAgICBzID0gImhvcml6b250YWwiID09IG8uc2V0dGluZ3MubW9kZSA/IC1pLmxlZnQgOiAtaS50b3AsCiAgICAgICAgICAgICAgICAgICAgICAgIGEgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNldFZhbHVlOiBzCiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgeChuLCAidGlja2VyIiwgc3BlZWQsIGEpCiAgICAgICAgICAgICAgICB9LCBIID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgby50b3VjaCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHg6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5OiAwCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGVuZDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeDogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHk6IDAKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIG8udmlld3BvcnQuYmluZCgidG91Y2hzdGFydCIsIFcpCiAgICAgICAgICAgICAgICB9LCBXID0gZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgIGlmIChvLndvcmtpbmcpIHQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgby50b3VjaC5vcmlnaW5hbFBvcyA9IHIucG9zaXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSB0Lm9yaWdpbmFsRXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIG8udG91Y2guc3RhcnQueCA9IGUuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVgsIG8udG91Y2guc3RhcnQueSA9IGUuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVksIG8udmlld3BvcnQuYmluZCgidG91Y2htb3ZlIiwgTiksIG8udmlld3BvcnQuYmluZCgidG91Y2hlbmQiLCBCKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIE4gPSBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQucHJldmVudERlZmF1bHQoKSwgImZhZGUiICE9IG8uc2V0dGluZ3MubW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZSA9IHQub3JpZ2luYWxFdmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoImhvcml6b250YWwiID09IG8uc2V0dGluZ3MubW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSBlLmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYIC0gby50b3VjaC5zdGFydC54OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSA9IG8udG91Y2gub3JpZ2luYWxQb3MubGVmdCArIG4KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWSAtIG8udG91Y2guc3RhcnQueTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSBvLnRvdWNoLm9yaWdpbmFsUG9zLnRvcCArIG4KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB4KGksICJyZXNldCIsIDApCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgQiA9IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICBvLnZpZXdwb3J0LnVuYmluZCgidG91Y2htb3ZlIiwgTik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSB0Lm9yaWdpbmFsRXZlbnQsCiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmIChvLnRvdWNoLmVuZC54ID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWCwgby50b3VjaC5lbmQueSA9IGUuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVksICJmYWRlIiA9PSBvLnNldHRpbmdzLm1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSBNYXRoLmFicyhvLnRvdWNoLnN0YXJ0LnggLSBvLnRvdWNoLmVuZC54KTsKICAgICAgICAgICAgICAgICAgICAgICAgbiA+PSBvLnNldHRpbmdzLnN3aXBlVGhyZXNob2xkICYmIChvLnRvdWNoLnN0YXJ0LnggPiBvLnRvdWNoLmVuZC54ID8gci5nb1RvTmV4dFNsaWRlKCkgOiByLmdvVG9QcmV2U2xpZGUoKSwgci5zdG9wQXV0bygpKQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgImhvcml6b250YWwiID09IG8uc2V0dGluZ3MubW9kZSA/IChuID0gby50b3VjaC5lbmQueCAtIG8udG91Y2guc3RhcnQueCwgaSA9IG8udG91Y2gub3JpZ2luYWxQb3MubGVmdCkgOiAobiA9IG8udG91Y2guZW5kLnkgLSBvLnRvdWNoLnN0YXJ0LnksIGkgPSBvLnRvdWNoLm9yaWdpbmFsUG9zLnRvcCksICFvLnNldHRpbmdzLmluZmluaXRlTG9vcCAmJiAoMCA9PSBvLmFjdGl2ZS5pbmRleCAmJiBuID4gMCB8fCBvLmFjdGl2ZS5sYXN0ICYmIDAgPiBuKSA/IHgoaSwgInJlc2V0IiwgMjAwKSA6IE1hdGguYWJzKG4pID49IG8uc2V0dGluZ3Muc3dpcGVUaHJlc2hvbGQgPyAoMCA+IG4gPyByLmdvVG9OZXh0U2xpZGUoKSA6IHIuZ29Ub1ByZXZTbGlkZSgpLCByLnN0b3BBdXRvKCkpIDogeChpLCAicmVzZXQiLCAyMDApCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG8udmlld3BvcnQudW5iaW5kKCJ0b3VjaGVuZCIsIEIpCiAgICAgICAgICAgICAgICB9LCBPID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSB0KHdpbmRvdykud2lkdGgoKSwKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IHQod2luZG93KS5oZWlnaHQoKTsKICAgICAgICAgICAgICAgICAgICAoYSAhPSBlIHx8IGwgIT0gaSkgJiYgKGEgPSBlLCBsID0gaSwgby5jaGlsZHJlbi5hZGQoci5maW5kKCIuYngtY2xvbmUiKSkud2lkdGgoaCgpKSwgby52aWV3cG9ydC5jc3MoImhlaWdodCIsIGcoKSksIG8uYWN0aXZlLmxhc3QgJiYgKG8uYWN0aXZlLmluZGV4ID0gdigpIC0gMSksIG8uYWN0aXZlLmluZGV4ID49IHYoKSAmJiAoby5hY3RpdmUubGFzdCA9ICEwKSwgby5zZXR0aW5ncy5wYWdlciAmJiAhby5zZXR0aW5ncy5wYWdlckN1c3RvbSAmJiAobSgpLCB5KG8uYWN0aXZlLmluZGV4KSksIG8uc2V0dGluZ3MudGlja2VyIHx8IGYoKSkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiByLmdvVG9TbGlkZSA9IGZ1bmN0aW9uKGUsIGkpIHsKICAgICAgICAgICAgICAgIGlmICghby53b3JraW5nICYmIG8uYWN0aXZlLmluZGV4ICE9IGUpCiAgICAgICAgICAgICAgICAgICAgaWYgKG8ud29ya2luZyA9ICEwLCBvLm9sZEluZGV4ID0gby5hY3RpdmUuaW5kZXgsIG8uYWN0aXZlLmluZGV4ID0gMCA+IGUgPyB2KCkgLSAxIDogZSA+PSB2KCkgPyAwIDogZSwgby5zZXR0aW5ncy5vblNsaWRlQmVmb3JlKG8uY2hpbGRyZW4uZXEoby5hY3RpdmUuaW5kZXgpLCBvLm9sZEluZGV4LCBvLmFjdGl2ZS5pbmRleCksICJuZXh0IiA9PSBpID8gby5zZXR0aW5ncy5vblNsaWRlTmV4dChvLmNoaWxkcmVuLmVxKG8uYWN0aXZlLmluZGV4KSwgby5vbGRJbmRleCwgby5hY3RpdmUuaW5kZXgpIDogInByZXYiID09IGkgJiYgby5zZXR0aW5ncy5vblNsaWRlUHJldihvLmNoaWxkcmVuLmVxKG8uYWN0aXZlLmluZGV4KSwgby5vbGRJbmRleCwgby5hY3RpdmUuaW5kZXgpLCBvLmFjdGl2ZS5sYXN0ID0gby5hY3RpdmUuaW5kZXggPj0gdigpIC0gMSwgby5zZXR0aW5ncy5wYWdlciAmJiB5KG8uYWN0aXZlLmluZGV4KSwgby5zZXR0aW5ncy5jb250cm9scyAmJiBxKCksICJmYWRlIiA9PSBvLnNldHRpbmdzLm1vZGUpIG8uc2V0dGluZ3MuYWRhcHRpdmVIZWlnaHQgJiYgby52aWV3cG9ydC5oZWlnaHQoKSAhPSBnKCkgJiYgby52aWV3cG9ydC5hbmltYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBnKCkKICAgICAgICAgICAgICAgICAgICB9LCBvLnNldHRpbmdzLmFkYXB0aXZlSGVpZ2h0U3BlZWQpLCBvLmNoaWxkcmVuLmZpbHRlcigiOnZpc2libGUiKS5mYWRlT3V0KG8uc2V0dGluZ3Muc3BlZWQpLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgIHpJbmRleDogMAogICAgICAgICAgICAgICAgICAgIH0pLCBvLmNoaWxkcmVuLmVxKG8uYWN0aXZlLmluZGV4KS5jc3MoInpJbmRleCIsIDUxKS5mYWRlSW4oby5zZXR0aW5ncy5zcGVlZCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQodGhpcykuY3NzKCJ6SW5kZXgiLCA1MCksIHooKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBvLnNldHRpbmdzLmFkYXB0aXZlSGVpZ2h0ICYmIG8udmlld3BvcnQuaGVpZ2h0KCkgIT0gZygpICYmIG8udmlld3BvcnQuYW5pbWF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IGcoKQogICAgICAgICAgICAgICAgICAgICAgICB9LCBvLnNldHRpbmdzLmFkYXB0aXZlSGVpZ2h0U3BlZWQpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiAwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW8uc2V0dGluZ3MuaW5maW5pdGVMb29wICYmIG8uY2Fyb3VzZWwgJiYgby5hY3RpdmUubGFzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgiaG9yaXpvbnRhbCIgPT0gby5zZXR0aW5ncy5tb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGEgPSBvLmNoaWxkcmVuLmVxKG8uY2hpbGRyZW4ubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IGEucG9zaXRpb24oKSwgbiA9IG8udmlld3BvcnQud2lkdGgoKSAtIGEud2lkdGgoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbCA9IG8uY2hpbGRyZW4ubGVuZ3RoIC0gby5zZXR0aW5ncy5taW5TbGlkZXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IG8uY2hpbGRyZW4uZXEobCkucG9zaXRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvLmNhcm91c2VsICYmIG8uYWN0aXZlLmxhc3QgJiYgInByZXYiID09IGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkID0gMSA9PSBvLnNldHRpbmdzLm1vdmVTbGlkZXMgPyBvLnNldHRpbmdzLm1heFNsaWRlcyAtIHAoKSA6ICh2KCkgLSAxKSAqIHAoKSAtIChvLmNoaWxkcmVuLmxlbmd0aCAtIG8uc2V0dGluZ3MubWF4U2xpZGVzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhID0gci5jaGlsZHJlbigiLmJ4LWNsb25lIikuZXEoZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzID0gYS5wb3NpdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIm5leHQiID09IGkgJiYgMCA9PSBvLmFjdGl2ZS5pbmRleCkgcyA9IHIuZmluZCgiLmJ4LWNsb25lIikuZXEoby5zZXR0aW5ncy5tYXhTbGlkZXMpLnBvc2l0aW9uKCksIG8uYWN0aXZlLmxhc3QgPSAhMTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoZSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IGUgKiBwKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzID0gby5jaGlsZHJlbi5lcShjKS5wb3NpdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGggPSAiaG9yaXpvbnRhbCIgPT0gby5zZXR0aW5ncy5tb2RlID8gLShzLmxlZnQgLSBuKSA6IC1zLnRvcDsKICAgICAgICAgICAgICAgICAgICAgICAgeChoLCAic2xpZGUiLCBvLnNldHRpbmdzLnNwZWVkKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgci5nb1RvTmV4dFNsaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoby5zZXR0aW5ncy5pbmZpbml0ZUxvb3AgfHwgIW8uYWN0aXZlLmxhc3QpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IG8uYWN0aXZlLmluZGV4ICsgMTsKICAgICAgICAgICAgICAgICAgICByLmdvVG9TbGlkZSh0LCAibmV4dCIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHIuZ29Ub1ByZXZTbGlkZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKG8uc2V0dGluZ3MuaW5maW5pdGVMb29wIHx8IDAgIT0gby5hY3RpdmUuaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IG8uYWN0aXZlLmluZGV4IC0gMTsKICAgICAgICAgICAgICAgICAgICByLmdvVG9TbGlkZSh0LCAicHJldiIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHIuc3RhcnRBdXRvID0gZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgby5pbnRlcnZhbCB8fCAoby5pbnRlcnZhbCA9IHNldEludGVydmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICJuZXh0IiA9PSBvLnNldHRpbmdzLmF1dG9EaXJlY3Rpb24gPyByLmdvVG9OZXh0U2xpZGUoKSA6IHIuZ29Ub1ByZXZTbGlkZSgpCiAgICAgICAgICAgICAgICB9LCBvLnNldHRpbmdzLnBhdXNlKSwgby5zZXR0aW5ncy5hdXRvQ29udHJvbHMgJiYgMSAhPSB0ICYmIE0oInN0b3AiKSkKICAgICAgICAgICAgfSwgci5zdG9wQXV0byA9IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgIG8uaW50ZXJ2YWwgJiYgKGNsZWFySW50ZXJ2YWwoby5pbnRlcnZhbCksIG8uaW50ZXJ2YWwgPSBudWxsLCBvLnNldHRpbmdzLmF1dG9Db250cm9scyAmJiAxICE9IHQgJiYgTSgic3RhcnQiKSkKICAgICAgICAgICAgfSwgci5nZXRDdXJyZW50U2xpZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvLmFjdGl2ZS5pbmRleAogICAgICAgICAgICB9LCByLmdldFNsaWRlQ291bnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvLmNoaWxkcmVuLmxlbmd0aAogICAgICAgICAgICB9LCByLmRlc3Ryb3lTbGlkZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIG8uaW5pdGlhbGl6ZWQgJiYgKG8uaW5pdGlhbGl6ZWQgPSAhMSwgdCgiLmJ4LWNsb25lIiwgdGhpcykucmVtb3ZlKCksIG8uY2hpbGRyZW4ucmVtb3ZlQXR0cigic3R5bGUiKSwgdGhpcy5yZW1vdmVBdHRyKCJzdHlsZSIpLnVud3JhcCgpLnVud3JhcCgpLCBvLmNvbnRyb2xzLmVsICYmIG8uY29udHJvbHMuZWwucmVtb3ZlKCksIG8uY29udHJvbHMubmV4dCAmJiBvLmNvbnRyb2xzLm5leHQucmVtb3ZlKCksIG8uY29udHJvbHMucHJldiAmJiBvLmNvbnRyb2xzLnByZXYucmVtb3ZlKCksIG8ucGFnZXJFbCAmJiBvLnBhZ2VyRWwucmVtb3ZlKCksIHQoIi5ieC1jYXB0aW9uIiwgdGhpcykucmVtb3ZlKCksIG8uY29udHJvbHMuYXV0b0VsICYmIG8uY29udHJvbHMuYXV0b0VsLnJlbW92ZSgpLCBjbGVhckludGVydmFsKG8uaW50ZXJ2YWwpLCB0KHdpbmRvdykudW5iaW5kKCJyZXNpemUiLCBPKSkKICAgICAgICAgICAgfSwgci5yZWxvYWRTbGlkZXIgPSBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICB2b2lkIDAgIT0gdCAmJiAocyA9IHQpLCByLmRlc3Ryb3lTbGlkZXIoKSwgZCgpCiAgICAgICAgICAgIH0sIGQoKSwgdGhpcwogICAgICAgIH0KICAgIH0KfSkoalF1ZXJ5KSwKZnVuY3Rpb24odCwgZSkgewogICAgdmFyIGkgPSAiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUFBQUFBQVAvLy95d0FBQUFBQVFBQkFBQUNBVXdBT3c9PSI7CiAgICB0LmZuLmltYWdlc0xvYWRlZCA9IGZ1bmN0aW9uKG4pIHsKICAgICAgICBmdW5jdGlvbiBzKCkgewogICAgICAgICAgICB2YXIgZSA9IHQoZyksCiAgICAgICAgICAgICAgICBpID0gdChoKTsKICAgICAgICAgICAgYSAmJiAoaC5sZW5ndGggPyBhLnJlamVjdChkLCBlLCBpKSA6IGEucmVzb2x2ZShkKSksIHQuaXNGdW5jdGlvbihuKSAmJiBuLmNhbGwociwgZCwgZSwgaSkKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG8oZSwgbikgewogICAgICAgICAgICBlLnNyYyA9PT0gaSB8fCAtMSAhPT0gdC5pbkFycmF5KGUsIGMpIHx8IChjLnB1c2goZSksIG4gPyBoLnB1c2goZSkgOiBnLnB1c2goZSksIHQuZGF0YShlLCAiaW1hZ2VzTG9hZGVkIiwgewogICAgICAgICAgICAgICAgaXNCcm9rZW46IG4sCiAgICAgICAgICAgICAgICBzcmM6IGUuc3JjCiAgICAgICAgICAgIH0pLCBsICYmIGEubm90aWZ5V2l0aCh0KGUpLCBbbiwgZCwgdChnKSwgdChoKV0pLCBkLmxlbmd0aCA9PT0gYy5sZW5ndGggJiYgKHNldFRpbWVvdXQocyksIGQudW5iaW5kKCIuaW1hZ2VzTG9hZGVkIikpKQogICAgICAgIH0KICAgICAgICB2YXIgciA9IHRoaXMsCiAgICAgICAgICAgIGEgPSB0LmlzRnVuY3Rpb24odC5EZWZlcnJlZCkgPyB0LkRlZmVycmVkKCkgOiAwLAogICAgICAgICAgICBsID0gdC5pc0Z1bmN0aW9uKGEubm90aWZ5KSwKICAgICAgICAgICAgZCA9IHIuZmluZCgiaW1nIikuYWRkKHIuZmlsdGVyKCJpbWciKSksCiAgICAgICAgICAgIGMgPSBbXSwKICAgICAgICAgICAgZyA9IFtdLAogICAgICAgICAgICBoID0gW107CiAgICAgICAgcmV0dXJuIHQuaXNQbGFpbk9iamVjdChuKSAmJiB0LmVhY2gobiwgZnVuY3Rpb24odCwgZSkgewogICAgICAgICAgICAiY2FsbGJhY2siID09PSB0ID8gbiA9IGUgOiBhICYmIGFbdF0oZSkKICAgICAgICB9KSwgZC5sZW5ndGggPyBkLmJpbmQoImxvYWQuaW1hZ2VzTG9hZGVkIGVycm9yLmltYWdlc0xvYWRlZCIsIGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgbyh0LnRhcmdldCwgImVycm9yIiA9PT0gdC50eXBlKQogICAgICAgIH0pLmVhY2goZnVuY3Rpb24obiwgcykgewogICAgICAgICAgICB2YXIgciA9IHMuc3JjLAogICAgICAgICAgICAgICAgYSA9IHQuZGF0YShzLCAiaW1hZ2VzTG9hZGVkIik7CiAgICAgICAgICAgIGEgJiYgYS5zcmMgPT09IHIgPyBvKHMsIGEuaXNCcm9rZW4pIDogcy5jb21wbGV0ZSAmJiBzLm5hdHVyYWxXaWR0aCAhPT0gZSA/IG8ocywgMCA9PT0gcy5uYXR1cmFsV2lkdGggfHwgMCA9PT0gcy5uYXR1cmFsSGVpZ2h0KSA6IChzLnJlYWR5U3RhdGUgfHwgcy5jb21wbGV0ZSkgJiYgKHMuc3JjID0gaSwgcy5zcmMgPSByKQogICAgICAgIH0pIDogcygpLCBhID8gYS5wcm9taXNlKHIpIDogcgogICAgfQp9KGpRdWVyeSk7CgoKLyoKCVByZXR0aWZ5IEpTCiovCnZhciBxID0gbnVsbDsKd2luZG93LlBSX1NIT1VMRF9VU0VfQ09OVElOVUFUSU9OID0gITA7CihmdW5jdGlvbigpIHsKICAgIGZ1bmN0aW9uIEwoYSkgewogICAgICAgIGZ1bmN0aW9uIG0oYSkgewogICAgICAgICAgICB2YXIgZiA9IGEuY2hhckNvZGVBdCgwKTsKICAgICAgICAgICAgaWYgKGYgIT09IDkyKSByZXR1cm4gZjsKICAgICAgICAgICAgdmFyIGIgPSBhLmNoYXJBdCgxKTsKICAgICAgICAgICAgcmV0dXJuIChmID0gcltiXSkgPyBmIDogIjAiIDw9IGIgJiYgYiA8PSAiNyIgPyBwYXJzZUludChhLnN1YnN0cmluZygxKSwgOCkgOiBiID09PSAidSIgfHwgYiA9PT0gIngiID8gcGFyc2VJbnQoYS5zdWJzdHJpbmcoMiksIDE2KSA6IGEuY2hhckNvZGVBdCgxKQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZShhKSB7CiAgICAgICAgICAgIGlmIChhIDwgMzIpIHJldHVybiAoYSA8IDE2ID8gIlxceDAiIDogIlxceCIpICsgYS50b1N0cmluZygxNik7CiAgICAgICAgICAgIGEgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGEpOwogICAgICAgICAgICBpZiAoYSA9PT0gIlxcIiB8fCBhID09PSAiLSIgfHwgYSA9PT0gIlsiIHx8IGEgPT09ICJdIikgYSA9ICJcXCIgKyBhOwogICAgICAgICAgICByZXR1cm4gYQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaChhKSB7CiAgICAgICAgICAgIGZvciAodmFyIGYgPSBhLnN1YnN0cmluZygxLCBhLmxlbmd0aCAtIDEpLm1hdGNoKC9cXHVbXGRBLUZhLWZdezR9fFxceFtcZEEtRmEtZl17Mn18XFxbMC0zXVswLTddezAsMn18XFxbMC03XXsxLDJ9fFxcW1xTXHNdfFteXFxdL2cpLCBhID0gW10sIGIgPSBbXSwgbyA9IGZbMF0gPT09ICJeIiwgYyA9IG8gPyAxIDogMCwgaSA9IGYubGVuZ3RoOyBjIDwgaTsgKytjKSB7CiAgICAgICAgICAgICAgICB2YXIgaiA9IGZbY107CiAgICAgICAgICAgICAgICBpZiAoL1xcW2Jkc3ddL2kudGVzdChqKSkgYS5wdXNoKGopOwogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGogPSBtKGopLAogICAgICAgICAgICAgICAgICAgICAgICBkOwogICAgICAgICAgICAgICAgICAgIGMgKyAyIDwgaSAmJiAiLSIgPT09IGZbYyArIDFdID8gKGQgPSBtKGZbYyArIDJdKSwgYyArPSAyKSA6IGQgPSBqOwogICAgICAgICAgICAgICAgICAgIGIucHVzaChbaiwgZF0pOwogICAgICAgICAgICAgICAgICAgIGQgPCA2NSB8fCBqID4gMTIyIHx8IChkIDwgNjUgfHwgaiA+IDkwIHx8IGIucHVzaChbTWF0aC5tYXgoNjUsIGopIHwgMzIsIE1hdGgubWluKGQsIDkwKSB8IDMyXSksIGQgPCA5NyB8fCBqID4gMTIyIHx8IGIucHVzaChbTWF0aC5tYXgoOTcsIGopICYgLTMzLCBNYXRoLm1pbihkLCAxMjIpICYgLTMzXSkpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYi5zb3J0KGZ1bmN0aW9uKGEsIGYpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhWzBdIC0gZlswXSB8fCBmWzFdIC0gYVsxXQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZiA9IFtdOwogICAgICAgICAgICBqID0gW05hTiwgTmFOXTsKICAgICAgICAgICAgZm9yIChjID0gMDsgYyA8IGIubGVuZ3RoOyArK2MpIGkgPSBiW2NdLCBpWzBdIDw9IGpbMV0gKyAxID8galsxXSA9IE1hdGgubWF4KGpbMV0sIGlbMV0pIDogZi5wdXNoKGogPSBpKTsKICAgICAgICAgICAgYiA9IFsiWyJdOwogICAgICAgICAgICBvICYmIGIucHVzaCgiXiIpOwogICAgICAgICAgICBiLnB1c2guYXBwbHkoYiwgYSk7CiAgICAgICAgICAgIGZvciAoYyA9IDA7IGMgPAogICAgICAgICAgICAgICAgZi5sZW5ndGg7ICsrYykgaSA9IGZbY10sIGIucHVzaChlKGlbMF0pKSwgaVsxXSA+IGlbMF0gJiYgKGlbMV0gKyAxID4gaVswXSAmJiBiLnB1c2goIi0iKSwgYi5wdXNoKGUoaVsxXSkpKTsKICAgICAgICAgICAgYi5wdXNoKCJdIik7CiAgICAgICAgICAgIHJldHVybiBiLmpvaW4oIiIpCiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB5KGEpIHsKICAgICAgICAgICAgZm9yICh2YXIgZiA9IGEuc291cmNlLm1hdGNoKC9cWyg/OlteXFxcXV18XFxbXFNcc10pKl18XFx1W1xkQS1GYS1mXXs0fXxcXHhbXGRBLUZhLWZdezJ9fFxcXGQrfFxcW15cZHV4XXxcKFw/WyE6PV18WygpXl18W14oKVtcXF5dKy9nKSwgYiA9IGYubGVuZ3RoLCBkID0gW10sIGMgPSAwLCBpID0gMDsgYyA8IGI7ICsrYykgewogICAgICAgICAgICAgICAgdmFyIGogPSBmW2NdOwogICAgICAgICAgICAgICAgaiA9PT0gIigiID8gKytpIDogIlxcIiA9PT0gai5jaGFyQXQoMCkgJiYgKGogPSArai5zdWJzdHJpbmcoMSkpICYmIGogPD0gaSAmJiAoZFtqXSA9IC0xKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoYyA9IDE7IGMgPCBkLmxlbmd0aDsgKytjKSAtIDEgPT09IGRbY10gJiYgKGRbY10gPSArK3QpOwogICAgICAgICAgICBmb3IgKGkgPSBjID0gMDsgYyA8IGI7ICsrYykgaiA9IGZbY10sIGogPT09ICIoIiA/ICgrK2ksIGRbaV0gPT09IHZvaWQgMCAmJiAoZltjXSA9ICIoPzoiKSkgOiAiXFwiID09PSBqLmNoYXJBdCgwKSAmJgogICAgICAgICAgICAgICAgKGogPSArai5zdWJzdHJpbmcoMSkpICYmIGogPD0gaSAmJiAoZltjXSA9ICJcXCIgKyBkW2ldKTsKICAgICAgICAgICAgZm9yIChpID0gYyA9IDA7IGMgPCBiOyArK2MpICJeIiA9PT0gZltjXSAmJiAiXiIgIT09IGZbYyArIDFdICYmIChmW2NdID0gIiIpOwogICAgICAgICAgICBpZiAoYS5pZ25vcmVDYXNlICYmIHMpCiAgICAgICAgICAgICAgICBmb3IgKGMgPSAwOyBjIDwgYjsgKytjKSBqID0gZltjXSwgYSA9IGouY2hhckF0KDApLCBqLmxlbmd0aCA+PSAyICYmIGEgPT09ICJbIiA/IGZbY10gPSBoKGopIDogYSAhPT0gIlxcIiAmJiAoZltjXSA9IGoucmVwbGFjZSgvW0EtWmEtel0vZywgZnVuY3Rpb24oYSkgewogICAgICAgICAgICAgICAgICAgIGEgPSBhLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJbIiArIFN0cmluZy5mcm9tQ2hhckNvZGUoYSAmIC0zMywgYSB8IDMyKSArICJdIgogICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICByZXR1cm4gZi5qb2luKCIiKQogICAgICAgIH0KICAgICAgICBmb3IgKHZhciB0ID0gMCwgcyA9ICExLCBsID0gITEsIHAgPSAwLCBkID0gYS5sZW5ndGg7IHAgPCBkOyArK3ApIHsKICAgICAgICAgICAgdmFyIGcgPSBhW3BdOwogICAgICAgICAgICBpZiAoZy5pZ25vcmVDYXNlKSBsID0gITA7CiAgICAgICAgICAgIGVsc2UgaWYgKC9bYS16XS9pLnRlc3QoZy5zb3VyY2UucmVwbGFjZSgvXFx1W1xkYS1mXXs0fXxcXHhbXGRhLWZdezJ9fFxcW15VWHV4XS9naSwgIiIpKSkgewogICAgICAgICAgICAgICAgcyA9ICEwOwogICAgICAgICAgICAgICAgbCA9ICExOwogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKHZhciByID0gewogICAgICAgICAgICBiOiA4LAogICAgICAgICAgICB0OiA5LAogICAgICAgICAgICBuOiAxMCwKICAgICAgICAgICAgdjogMTEsCiAgICAgICAgICAgIGY6IDEyLAogICAgICAgICAgICByOiAxMwogICAgICAgIH0sIG4gPSBbXSwgcCA9IDAsIGQgPSBhLmxlbmd0aDsgcCA8IGQ7ICsrcCkgewogICAgICAgICAgICBnID0gYVtwXTsKICAgICAgICAgICAgaWYgKGcuZ2xvYmFsIHx8IGcubXVsdGlsaW5lKSB0aHJvdyBFcnJvcigiIiArIGcpOwogICAgICAgICAgICBuLnB1c2goIig/OiIgKyB5KGcpICsgIikiKQogICAgICAgIH0KICAgICAgICByZXR1cm4gUmVnRXhwKG4uam9pbigifCIpLCBsID8gImdpIiA6ICJnIikKICAgIH0KCiAgICBmdW5jdGlvbiBNKGEpIHsKICAgICAgICBmdW5jdGlvbiBtKGEpIHsKICAgICAgICAgICAgc3dpdGNoIChhLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgaWYgKGUudGVzdChhLmNsYXNzTmFtZSkpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGcgPSBhLmZpcnN0Q2hpbGQ7IGc7IGcgPSBnLm5leHRTaWJsaW5nKSBtKGcpOwogICAgICAgICAgICAgICAgICAgIGcgPSBhLm5vZGVOYW1lOwogICAgICAgICAgICAgICAgICAgIGlmICgiQlIiID09PSBnIHx8ICJMSSIgPT09IGcpIGhbc10gPSAiXG4iLCB0W3MgPDwgMV0gPSB5KyssIHRbcysrIDw8IDEgfCAxXSA9IGE7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgICAgZyA9IGEubm9kZVZhbHVlLCBnLmxlbmd0aCAmJiAoZyA9IHAgPyBnLnJlcGxhY2UoL1xyXG4/L2csICJcbiIpIDogZy5yZXBsYWNlKC9bXHRcblxyIF0rL2csICIgIiksIGhbc10gPSBnLCB0W3MgPDwgMV0gPSB5LCB5ICs9IGcubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICB0W3MrKyA8PCAxIHwgMV0gPSBhKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBlID0gLyg/Ol58XHMpbm9jb2RlKD86XHN8JCkvLAogICAgICAgICAgICBoID0gW10sCiAgICAgICAgICAgIHkgPSAwLAogICAgICAgICAgICB0ID0gW10sCiAgICAgICAgICAgIHMgPSAwLAogICAgICAgICAgICBsOwogICAgICAgIGEuY3VycmVudFN0eWxlID8gbCA9IGEuY3VycmVudFN0eWxlLndoaXRlU3BhY2UgOiB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSAmJiAobCA9IGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoYSwgcSkuZ2V0UHJvcGVydHlWYWx1ZSgid2hpdGUtc3BhY2UiKSk7CiAgICAgICAgdmFyIHAgPSBsICYmICJwcmUiID09PSBsLnN1YnN0cmluZygwLCAzKTsKICAgICAgICBtKGEpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGE6IGguam9pbigiIikucmVwbGFjZSgvXG4kLywgIiIpLAogICAgICAgICAgICBjOiB0CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEIoYSwgbSwgZSwgaCkgewogICAgICAgIG0gJiYgKGEgPSB7CiAgICAgICAgICAgIGE6IG0sCiAgICAgICAgICAgIGQ6IGEKICAgICAgICB9LCBlKGEpLCBoLnB1c2guYXBwbHkoaCwgYS5lKSkKICAgIH0KCiAgICBmdW5jdGlvbiB4KGEsIG0pIHsKICAgICAgICBmdW5jdGlvbiBlKGEpIHsKICAgICAgICAgICAgZm9yICh2YXIgbCA9IGEuZCwgcCA9IFtsLCAicGxuIl0sIGQgPSAwLCBnID0gYS5hLm1hdGNoKHkpIHx8IFtdLCByID0ge30sIG4gPSAwLCB6ID0gZy5sZW5ndGg7IG4gPCB6OyArK24pIHsKICAgICAgICAgICAgICAgIHZhciBmID0gZ1tuXSwKICAgICAgICAgICAgICAgICAgICBiID0gcltmXSwKICAgICAgICAgICAgICAgICAgICBvID0gdm9pZCAwLAogICAgICAgICAgICAgICAgICAgIGM7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGIgPT09CiAgICAgICAgICAgICAgICAgICAgInN0cmluZyIpIGMgPSAhMTsKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBpID0gaFtmLmNoYXJBdCgwKV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGkpIG8gPSBmLm1hdGNoKGlbMV0pLCBiID0gaVswXTsKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjID0gMDsgYyA8IHQ7ICsrYykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpID0gbVtjXSwgbyA9IGYubWF0Y2goaVsxXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiID0gaVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBvIHx8IChiID0gInBsbiIpCiAgICAgICAgICAgICAgICAgICAgfSBpZiAoKGMgPSBiLmxlbmd0aCA+PSA1ICYmICJsYW5nLSIgPT09IGIuc3Vic3RyaW5nKDAsIDUpKSAmJiAhKG8gJiYgdHlwZW9mIG9bMV0gPT09ICJzdHJpbmciKSkgYyA9ICExLCBiID0gInNyYyI7CiAgICAgICAgICAgICAgICAgICAgYyB8fCAocltmXSA9IGIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpID0gZDsKICAgICAgICAgICAgICAgIGQgKz0gZi5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAoYykgewogICAgICAgICAgICAgICAgICAgIGMgPSBvWzFdOwogICAgICAgICAgICAgICAgICAgIHZhciBqID0gZi5pbmRleE9mKGMpLAogICAgICAgICAgICAgICAgICAgICAgICBrID0gaiArIGMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIG9bMl0gJiYgKGsgPSBmLmxlbmd0aCAtIG9bMl0ubGVuZ3RoLCBqID0gayAtIGMubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICBiID0gYi5zdWJzdHJpbmcoNSk7CiAgICAgICAgICAgICAgICAgICAgQihsICsgaSwgZi5zdWJzdHJpbmcoMCwgaiksIGUsIHApOwogICAgICAgICAgICAgICAgICAgIEIobCArIGkgKyBqLCBjLCBDKGIsIGMpLCBwKTsKICAgICAgICAgICAgICAgICAgICBCKGwgKyBpICsgaywgZi5zdWJzdHJpbmcoayksIGUsIHApCiAgICAgICAgICAgICAgICB9IGVsc2UgcC5wdXNoKGwgKyBpLCBiKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGEuZSA9IHAKICAgICAgICB9CiAgICAgICAgdmFyIGggPSB7fSwgeTsKICAgICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZvciAodmFyIGUgPSBhLmNvbmNhdChtKSwKICAgICAgICAgICAgICAgICAgICBsID0gW10sIHAgPSB7fSwgZCA9IDAsIGcgPSBlLmxlbmd0aDsgZCA8IGc7ICsrZCkgewogICAgICAgICAgICAgICAgdmFyIHIgPSBlW2RdLAogICAgICAgICAgICAgICAgICAgIG4gPSByWzNdOwogICAgICAgICAgICAgICAgaWYgKG4pCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IG4ubGVuZ3RoOyAtLWsgPj0gMDspIGhbbi5jaGFyQXQoayldID0gcjsKICAgICAgICAgICAgICAgIHIgPSByWzFdOwogICAgICAgICAgICAgICAgbiA9ICIiICsgcjsKICAgICAgICAgICAgICAgIHAuaGFzT3duUHJvcGVydHkobikgfHwgKGwucHVzaChyKSwgcFtuXSA9IHEpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgbC5wdXNoKC9bXFNcc10vKTsKICAgICAgICAgICAgeSA9IEwobCkKICAgICAgICB9KSgpOwogICAgICAgIHZhciB0ID0gbS5sZW5ndGg7CiAgICAgICAgcmV0dXJuIGUKICAgIH0KCiAgICBmdW5jdGlvbiB1KGEpIHsKICAgICAgICB2YXIgbSA9IFtdLAogICAgICAgICAgICBlID0gW107CiAgICAgICAgYS50cmlwbGVRdW90ZWRTdHJpbmdzID8gbS5wdXNoKFsic3RyIiwgL14oPzonJycoPzpbXidcXF18XFxbXFNcc118Jyc/KD89W14nXSkpKig/OicnJ3wkKXwiIiIoPzpbXiJcXF18XFxbXFNcc118IiI/KD89W14iXSkpKig/OiIiInwkKXwnKD86W14nXFxdfFxcW1xTXHNdKSooPzonfCQpfCIoPzpbXiJcXF18XFxbXFNcc10pKig/OiJ8JCkpLywgcSwgIidcIiJdKSA6IGEubXVsdGlMaW5lU3RyaW5ncyA/IG0ucHVzaChbInN0ciIsIC9eKD86Jyg/OlteJ1xcXXxcXFtcU1xzXSkqKD86J3wkKXwiKD86W14iXFxdfFxcW1xTXHNdKSooPzoifCQpfGAoPzpbXlxcYF18XFxbXFNcc10pKig/OmB8JCkpLywKICAgICAgICAgICAgcSwgIidcImAiCiAgICAgICAgXSkgOiBtLnB1c2goWyJzdHIiLCAvXig/OicoPzpbXlxuXHInXFxdfFxcLikqKD86J3wkKXwiKD86W15cblxyIlxcXXxcXC4pKig/OiJ8JCkpLywgcSwgIlwiJyJdKTsKICAgICAgICBhLnZlcmJhdGltU3RyaW5ncyAmJiBlLnB1c2goWyJzdHIiLCAvXkAiKD86W14iXXwiIikqKD86InwkKS8sIHFdKTsKICAgICAgICB2YXIgaCA9IGEuaGFzaENvbW1lbnRzOwogICAgICAgIGggJiYgKGEuY1N0eWxlQ29tbWVudHMgPyAoaCA+IDEgPyBtLnB1c2goWyJjb20iLCAvXiMoPzojIyg/OlteI118Iyg/ISMjKSkqKD86IyMjfCQpfC4qKS8sIHEsICIjIl0pIDogbS5wdXNoKFsiY29tIiwgL14jKD86KD86ZGVmaW5lfGVsaWZ8ZWxzZXxlbmRpZnxlcnJvcnxpZmRlZnxpbmNsdWRlfGlmbmRlZnxsaW5lfHByYWdtYXx1bmRlZnx3YXJuaW5nKVxifFteXG5ccl0qKS8sIHEsICIjIl0pLCBlLnB1c2goWyJzdHIiLCAvXjwoPzooPzooPzpcLlwuXC8pKnxcLz8pKD86W1x3LV0rKD86XC9bXHctXSspKyk/W1x3LV0rXC5ofFthLXpdXHcqKT4vLCBxXSkpIDogbS5wdXNoKFsiY29tIiwgL14jW15cblxyXSovLAogICAgICAgICAgICBxLCAiIyIKICAgICAgICBdKSk7CiAgICAgICAgYS5jU3R5bGVDb21tZW50cyAmJiAoZS5wdXNoKFsiY29tIiwgL15cL1wvW15cblxyXSovLCBxXSksIGUucHVzaChbImNvbSIsIC9eXC9cKltcU1xzXSo/KD86XCpcL3wkKS8sIHFdKSk7CiAgICAgICAgYS5yZWdleExpdGVyYWxzICYmIGUucHVzaChbImxhbmctcmVnZXgiLCAvXig/Ol5eXC4/fFshKy1dfCE9fCE9PXwjfCV8JT18JnwmJnwmJj18Jj18XCh8XCp8XCo9fFwrPXwsfC09fC0+fFwvfFwvPXw6fDo6fDt8PHw8PHw8PD18PD18PXw9PXw9PT18Pnw+PXw+Pnw+Pj18Pj4+fD4+Pj18Wz9AW15dfFxePXxcXlxefFxeXF49fHt8XHx8XHw9fFx8XHx8XHxcfD18fnxicmVha3xjYXNlfGNvbnRpbnVlfGRlbGV0ZXxkb3xlbHNlfGZpbmFsbHl8aW5zdGFuY2VvZnxyZXR1cm58dGhyb3d8dHJ5fHR5cGVvZilccyooXC8oPz1bXiovXSkoPzpbXi9bXFxdfFxcW1xTXHNdfFxbKD86W15cXFxdXXxcXFtcU1xzXSkqKD86XXwkKSkrXC8pL10pOwogICAgICAgIChoID0gYS50eXBlcykgJiYgZS5wdXNoKFsidHlwIiwgaF0pOwogICAgICAgIGEgPSAoIiIgKyBhLmtleXdvcmRzKS5yZXBsYWNlKC9eIHwgJC9nLAogICAgICAgICAgICAiIik7CiAgICAgICAgYS5sZW5ndGggJiYgZS5wdXNoKFsia3dkIiwgUmVnRXhwKCJeKD86IiArIGEucmVwbGFjZSgvW1xzLF0rL2csICJ8IikgKyAiKVxcYiIpLCBxXSk7CiAgICAgICAgbS5wdXNoKFsicGxuIiwgL15ccysvLCBxLCAiIFxyXG5cdFx4YTAiXSk7CiAgICAgICAgZS5wdXNoKFsibGl0IiwgL15AWyRfYS16XVtcdyRAXSovaSwgcV0sIFsidHlwIiwgL14oPzpbQF9dP1tBLVpdK1thLXpdW1x3JEBdKnxcdytfdFxiKS8sIHFdLCBbInBsbiIsIC9eWyRfYS16XVtcdyRAXSovaSwgcV0sIFsibGl0IiwgL14oPzoweFtcZGEtZl0rfCg/OlxkKD86X1xkKykqXGQqKD86XC5cZCopP3xcLlxkXCspKD86ZVsrLV0/XGQrKT8pW2Etel0qL2ksIHEsICIwMTIzNDU2Nzg5Il0sIFsicGxuIiwgL15cXFtcU1xzXT8vLCBxXSwgWyJwdW4iLCAvXi5bXlxzXHciLSQnLi9AXFxgXSovLCBxXSk7CiAgICAgICAgcmV0dXJuIHgobSwgZSkKICAgIH0KCiAgICBmdW5jdGlvbiBEKGEsIG0pIHsKICAgICAgICBmdW5jdGlvbiBlKGEpIHsKICAgICAgICAgICAgc3dpdGNoIChhLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgaWYgKGsudGVzdChhLmNsYXNzTmFtZSkpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGlmICgiQlIiID09PSBhLm5vZGVOYW1lKSBoKGEpLAogICAgICAgICAgICAgICAgICAgIGEucGFyZW50Tm9kZSAmJiBhLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGEgPSBhLmZpcnN0Q2hpbGQ7IGE7IGEgPSBhLm5leHRTaWJsaW5nKSBlKGEpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiID0gYS5ub2RlVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkID0gYi5tYXRjaCh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjID0gYi5zdWJzdHJpbmcoMCwgZC5pbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLm5vZGVWYWx1ZSA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYiA9IGIuc3Vic3RyaW5nKGQuaW5kZXggKyBkWzBdLmxlbmd0aCkpICYmIGEucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUocy5jcmVhdGVUZXh0Tm9kZShiKSwgYS5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoKGEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYyB8fCBhLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaChhKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIGIoYSwgZCkgewogICAgICAgICAgICAgICAgdmFyIGUgPSBkID8gYS5jbG9uZU5vZGUoITEpIDogYSwKICAgICAgICAgICAgICAgICAgICBmID0gYS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgaWYgKGYpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZiA9IGIoZiwgMSksCiAgICAgICAgICAgICAgICAgICAgICAgIGcgPSBhLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgIGYuYXBwZW5kQ2hpbGQoZSk7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaCA9IGc7IGg7IGggPSBnKSBnID0gaC5uZXh0U2libGluZywgZi5hcHBlbmRDaGlsZChoKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGUKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKDsgIWEubmV4dFNpYmxpbmc7KQogICAgICAgICAgICAgICAgaWYgKGEgPSBhLnBhcmVudE5vZGUsICFhKSByZXR1cm47CiAgICAgICAgICAgIGZvciAodmFyIGEgPSBiKGEubmV4dFNpYmxpbmcsIDApLCBlOwogICAgICAgICAgICAgICAgKGUgPSBhLnBhcmVudE5vZGUpICYmIGUubm9kZVR5cGUgPT09IDE7KSBhID0gZTsKICAgICAgICAgICAgZC5wdXNoKGEpCiAgICAgICAgfQogICAgICAgIHZhciBrID0gLyg/Ol58XHMpbm9jb2RlKD86XHN8JCkvLAogICAgICAgICAgICB0ID0gL1xyXG4/fFxuLywKICAgICAgICAgICAgcyA9IGEub3duZXJEb2N1bWVudCwKICAgICAgICAgICAgbDsKICAgICAgICBhLmN1cnJlbnRTdHlsZSA/IGwgPSBhLmN1cnJlbnRTdHlsZS53aGl0ZVNwYWNlIDogd2luZG93LmdldENvbXB1dGVkU3R5bGUgJiYgKGwgPSBzLmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoYSwgcSkuZ2V0UHJvcGVydHlWYWx1ZSgid2hpdGUtc3BhY2UiKSk7CiAgICAgICAgdmFyIHAgPSBsICYmICJwcmUiID09PSBsLnN1YnN0cmluZygwLCAzKTsKICAgICAgICBmb3IgKGwgPSBzLmNyZWF0ZUVsZW1lbnQoIkxJIik7IGEuZmlyc3RDaGlsZDspIGwuYXBwZW5kQ2hpbGQoYS5maXJzdENoaWxkKTsKICAgICAgICBmb3IgKHZhciBkID0gW2xdLCBnID0gMDsgZyA8IGQubGVuZ3RoOyArK2cpIGUoZFtnXSk7CiAgICAgICAgbSA9PT0gKG0gfCAwKSAmJiBkWzBdLnNldEF0dHJpYnV0ZSgidmFsdWUiLAogICAgICAgICAgICBtKTsKICAgICAgICB2YXIgciA9IHMuY3JlYXRlRWxlbWVudCgiT0wiKTsKICAgICAgICByLmNsYXNzTmFtZSA9ICJsaW5lbnVtcyI7CiAgICAgICAgZm9yICh2YXIgbiA9IE1hdGgubWF4KDAsIG0gLSAxIHwgMCkgfHwgMCwgZyA9IDAsIHogPSBkLmxlbmd0aDsgZyA8IHo7ICsrZykgbCA9IGRbZ10sIGwuY2xhc3NOYW1lID0gIkwiICsgKGcgKyBuKSAlIDEwLCBsLmZpcnN0Q2hpbGQgfHwgbC5hcHBlbmRDaGlsZChzLmNyZWF0ZVRleHROb2RlKCJceGEwIikpLCByLmFwcGVuZENoaWxkKGwpOwogICAgICAgIGEuYXBwZW5kQ2hpbGQocikKICAgIH0KCiAgICBmdW5jdGlvbiBrKGEsIG0pIHsKICAgICAgICBmb3IgKHZhciBlID0gbS5sZW5ndGg7IC0tZSA+PSAwOykgewogICAgICAgICAgICB2YXIgaCA9IG1bZV07CiAgICAgICAgICAgIEEuaGFzT3duUHJvcGVydHkoaCkgPyB3aW5kb3cuY29uc29sZSAmJiBjb25zb2xlLndhcm4oImNhbm5vdCBvdmVycmlkZSBsYW5ndWFnZSBoYW5kbGVyICVzIiwgaCkgOiBBW2hdID0gYQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBDKGEsIG0pIHsKICAgICAgICBpZiAoIWEgfHwgIUEuaGFzT3duUHJvcGVydHkoYSkpIGEgPSAvXlxzKjwvLnRlc3QobSkgPyAiZGVmYXVsdC1tYXJrdXAiIDogImRlZmF1bHQtY29kZSI7CiAgICAgICAgcmV0dXJuIEFbYV0KICAgIH0KCiAgICBmdW5jdGlvbiBFKGEpIHsKICAgICAgICB2YXIgbSA9CiAgICAgICAgICAgIGEuZzsKICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgZSA9IE0oYS5oKSwKICAgICAgICAgICAgICAgIGggPSBlLmE7CiAgICAgICAgICAgIGEuYSA9IGg7CiAgICAgICAgICAgIGEuYyA9IGUuYzsKICAgICAgICAgICAgYS5kID0gMDsKICAgICAgICAgICAgQyhtLCBoKShhKTsKICAgICAgICAgICAgdmFyIGsgPSAvXGJNU0lFXGIvLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCksCiAgICAgICAgICAgICAgICBtID0gL1xuL2csCiAgICAgICAgICAgICAgICB0ID0gYS5hLAogICAgICAgICAgICAgICAgcyA9IHQubGVuZ3RoLAogICAgICAgICAgICAgICAgZSA9IDAsCiAgICAgICAgICAgICAgICBsID0gYS5jLAogICAgICAgICAgICAgICAgcCA9IGwubGVuZ3RoLAogICAgICAgICAgICAgICAgaCA9IDAsCiAgICAgICAgICAgICAgICBkID0gYS5lLAogICAgICAgICAgICAgICAgZyA9IGQubGVuZ3RoLAogICAgICAgICAgICAgICAgYSA9IDA7CiAgICAgICAgICAgIGRbZ10gPSBzOwogICAgICAgICAgICB2YXIgciwgbjsKICAgICAgICAgICAgZm9yIChuID0gciA9IDA7IG4gPCBnOykgZFtuXSAhPT0gZFtuICsgMl0gPyAoZFtyKytdID0gZFtuKytdLCBkW3IrK10gPSBkW24rK10pIDogbiArPSAyOwogICAgICAgICAgICBnID0gcjsKICAgICAgICAgICAgZm9yIChuID0gciA9IDA7IG4gPCBnOykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgeiA9IGRbbl0sIGYgPSBkW24gKyAxXSwgYiA9IG4gKyAyOyBiICsgMiA8PSBnICYmIGRbYiArIDFdID09PSBmOykgYiArPSAyOwogICAgICAgICAgICAgICAgZFtyKytdID0gejsKICAgICAgICAgICAgICAgIGRbcisrXSA9IGY7CiAgICAgICAgICAgICAgICBuID0gYgogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoZC5sZW5ndGggPSByOyBoIDwgcDspIHsKICAgICAgICAgICAgICAgIHZhciBvID0gbFtoICsgMl0gfHwgcywKICAgICAgICAgICAgICAgICAgICBjID0gZFthICsgMl0gfHwgcywKICAgICAgICAgICAgICAgICAgICBiID0gTWF0aC5taW4obywgYyksCiAgICAgICAgICAgICAgICAgICAgaSA9IGxbaCArIDFdLAogICAgICAgICAgICAgICAgICAgIGo7CiAgICAgICAgICAgICAgICBpZiAoaS5ub2RlVHlwZSAhPT0gMSAmJiAoaiA9IHQuc3Vic3RyaW5nKGUsIGIpKSkgewogICAgICAgICAgICAgICAgICAgIGsgJiYgKGogPSBqLnJlcGxhY2UobSwgIlxyIikpOwogICAgICAgICAgICAgICAgICAgIGkubm9kZVZhbHVlID0KICAgICAgICAgICAgICAgICAgICAgICAgajsKICAgICAgICAgICAgICAgICAgICB2YXIgdSA9IGkub3duZXJEb2N1bWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHUuY3JlYXRlRWxlbWVudCgiU1BBTiIpOwogICAgICAgICAgICAgICAgICAgIHYuY2xhc3NOYW1lID0gZFthICsgMV07CiAgICAgICAgICAgICAgICAgICAgdmFyIHggPSBpLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgeC5yZXBsYWNlQ2hpbGQodiwgaSk7CiAgICAgICAgICAgICAgICAgICAgdi5hcHBlbmRDaGlsZChpKTsKICAgICAgICAgICAgICAgICAgICBlIDwgbyAmJiAobFtoICsgMV0gPSBpID0gdS5jcmVhdGVUZXh0Tm9kZSh0LnN1YnN0cmluZyhiLCBvKSksIHguaW5zZXJ0QmVmb3JlKGksIHYubmV4dFNpYmxpbmcpKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZSA9IGI7CiAgICAgICAgICAgICAgICBlID49IG8gJiYgKGggKz0gMik7CiAgICAgICAgICAgICAgICBlID49IGMgJiYgKGEgKz0gMikKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKHcpIHsKICAgICAgICAgICAgImNvbnNvbGUiIGluIHdpbmRvdyAmJiBjb25zb2xlLmxvZyh3ICYmIHcuc3RhY2sgPyB3LnN0YWNrIDogdykKICAgICAgICB9CiAgICB9CiAgICB2YXIgdiA9IFsiYnJlYWssY29udGludWUsZG8sZWxzZSxmb3IsaWYscmV0dXJuLHdoaWxlIl0sCiAgICAgICAgdyA9IFsKICAgICAgICAgICAgW3YsICJhdXRvLGNhc2UsY2hhcixjb25zdCxkZWZhdWx0LGRvdWJsZSxlbnVtLGV4dGVybixmbG9hdCxnb3RvLGludCxsb25nLHJlZ2lzdGVyLHNob3J0LHNpZ25lZCxzaXplb2Ysc3RhdGljLHN0cnVjdCxzd2l0Y2gsdHlwZWRlZix1bmlvbix1bnNpZ25lZCx2b2lkLHZvbGF0aWxlIl0sCiAgICAgICAgICAgICJjYXRjaCxjbGFzcyxkZWxldGUsZmFsc2UsaW1wb3J0LG5ldyxvcGVyYXRvcixwcml2YXRlLHByb3RlY3RlZCxwdWJsaWMsdGhpcyx0aHJvdyx0cnVlLHRyeSx0eXBlb2YiCiAgICAgICAgXSwKICAgICAgICBGID0gW3csICJhbGlnbm9mLGFsaWduX3VuaW9uLGFzbSxheGlvbSxib29sLGNvbmNlcHQsY29uY2VwdF9tYXAsY29uc3RfY2FzdCxjb25zdGV4cHIsZGVjbHR5cGUsZHluYW1pY19jYXN0LGV4cGxpY2l0LGV4cG9ydCxmcmllbmQsaW5saW5lLGxhdGVfY2hlY2ssbXV0YWJsZSxuYW1lc3BhY2UsbnVsbHB0cixyZWludGVycHJldF9jYXN0LHN0YXRpY19hc3NlcnQsc3RhdGljX2Nhc3QsdGVtcGxhdGUsdHlwZWlkLHR5cGVuYW1lLHVzaW5nLHZpcnR1YWwsd2hlcmUiXSwKICAgICAgICBHID0gW3csICJhYnN0cmFjdCxib29sZWFuLGJ5dGUsZXh0ZW5kcyxmaW5hbCxmaW5hbGx5LGltcGxlbWVudHMsaW1wb3J0LGluc3RhbmNlb2YsbnVsbCxuYXRpdmUscGFja2FnZSxzdHJpY3RmcCxzdXBlcixzeW5jaHJvbml6ZWQsdGhyb3dzLHRyYW5zaWVudCJdLAogICAgICAgIEggPSBbRywgImFzLGJhc2UsYnksY2hlY2tlZCxkZWNpbWFsLGRlbGVnYXRlLGRlc2NlbmRpbmcsZHluYW1pYyxldmVudCxmaXhlZCxmb3JlYWNoLGZyb20sZ3JvdXAsaW1wbGljaXQsaW4saW50ZXJmYWNlLGludGVybmFsLGludG8saXMsbG9jayxvYmplY3Qsb3V0LG92ZXJyaWRlLG9yZGVyYnkscGFyYW1zLHBhcnRpYWwscmVhZG9ubHkscmVmLHNieXRlLHNlYWxlZCxzdGFja2FsbG9jLHN0cmluZyxzZWxlY3QsdWludCx1bG9uZyx1bmNoZWNrZWQsdW5zYWZlLHVzaG9ydCx2YXIiXSwKICAgICAgICB3ID0gW3csICJkZWJ1Z2dlcixldmFsLGV4cG9ydCxmdW5jdGlvbixnZXQsbnVsbCxzZXQsdW5kZWZpbmVkLHZhcix3aXRoLEluZmluaXR5LE5hTiJdLAogICAgICAgIEkgPSBbdiwgImFuZCxhcyxhc3NlcnQsY2xhc3MsZGVmLGRlbCxlbGlmLGV4Y2VwdCxleGVjLGZpbmFsbHksZnJvbSxnbG9iYWwsaW1wb3J0LGluLGlzLGxhbWJkYSxub25sb2NhbCxub3Qsb3IscGFzcyxwcmludCxyYWlzZSx0cnksd2l0aCx5aWVsZCxGYWxzZSxUcnVlLE5vbmUiXSwKICAgICAgICBKID0gW3YsICJhbGlhcyxhbmQsYmVnaW4sY2FzZSxjbGFzcyxkZWYsZGVmaW5lZCxlbHNpZixlbmQsZW5zdXJlLGZhbHNlLGluLG1vZHVsZSxuZXh0LG5pbCxub3Qsb3IscmVkbyxyZXNjdWUscmV0cnksc2VsZixzdXBlcix0aGVuLHRydWUsdW5kZWYsdW5sZXNzLHVudGlsLHdoZW4seWllbGQsQkVHSU4sRU5EIl0sCiAgICAgICAgdiA9IFt2LCAiY2FzZSxkb25lLGVsaWYsZXNhYyxldmFsLGZpLGZ1bmN0aW9uLGluLGxvY2FsLHNldCx0aGVuLHVudGlsIl0sCiAgICAgICAgSyA9IC9eKERJUnxGSUxFfHZlY3RvcnwoZGV8cHJpb3JpdHlfKT9xdWV1ZXxsaXN0fHN0YWNrfChjb25zdF8pP2l0ZXJhdG9yfChtdWx0aSk/KHNldHxtYXApfGJpdHNldHx1PyhpbnR8ZmxvYXQpXGQqKS8sCiAgICAgICAgTiA9IC9cUy8sCiAgICAgICAgTyA9IHUoewogICAgICAgICAgICBrZXl3b3JkczogW0YsIEgsIHcsICJjYWxsZXIsZGVsZXRlLGRpZSxkbyxkdW1wLGVsc2lmLGV2YWwsZXhpdCxmb3JlYWNoLGZvcixnb3RvLGlmLGltcG9ydCxsYXN0LGxvY2FsLG15LG5leHQsbm8sb3VyLHByaW50LHBhY2thZ2UscmVkbyxyZXF1aXJlLHN1Yix1bmRlZix1bmxlc3MsdW50aWwsdXNlLHdhbnRhcnJheSx3aGlsZSxCRUdJTixFTkQiICsKICAgICAgICAgICAgICAgIEksIEosIHYKICAgICAgICAgICAgXSwKICAgICAgICAgICAgaGFzaENvbW1lbnRzOiAhMCwKICAgICAgICAgICAgY1N0eWxlQ29tbWVudHM6ICEwLAogICAgICAgICAgICBtdWx0aUxpbmVTdHJpbmdzOiAhMCwKICAgICAgICAgICAgcmVnZXhMaXRlcmFsczogITAKICAgICAgICB9KSwKICAgICAgICBBID0ge307CiAgICBrKE8sIFsiZGVmYXVsdC1jb2RlIl0pOwogICAgayh4KFtdLCBbCiAgICAgICAgWyJwbG4iLCAvXltePD9dKy9dLAogICAgICAgIFsiZGVjIiwgL148IVx3W14+XSooPzo+fCQpL10sCiAgICAgICAgWyJjb20iLCAvXjxcIS0tW1xTXHNdKj8oPzotLVw+fCQpL10sCiAgICAgICAgWyJsYW5nLSIsIC9ePFw/KFtcU1xzXSs/KSg/Olw/PnwkKS9dLAogICAgICAgIFsibGFuZy0iLCAvXjwlKFtcU1xzXSs/KSg/OiU+fCQpL10sCiAgICAgICAgWyJwdW4iLCAvXig/OjxbJT9dfFslP10+KS9dLAogICAgICAgIFsibGFuZy0iLCAvXjx4bXBcYltePl0qPihbXFNcc10rPyk8XC94bXBcYltePl0qPi9pXSwKICAgICAgICBbImxhbmctanMiLCAvXjxzY3JpcHRcYltePl0qPihbXFNcc10qPykoPFwvc2NyaXB0XGJbXj5dKj4pL2ldLAogICAgICAgIFsibGFuZy1jc3MiLCAvXjxzdHlsZVxiW14+XSo+KFtcU1xzXSo/KSg8XC9zdHlsZVxiW14+XSo+KS9pXSwKICAgICAgICBbImxhbmctaW4udGFnIiwgL14oPFwvP1thLXpdW148Pl0qPikvaV0KICAgIF0pLCBbImRlZmF1bHQtbWFya3VwIiwgImh0bSIsICJodG1sIiwgIm14bWwiLCAieGh0bWwiLCAieG1sIiwgInhzbCJdKTsKICAgIGsoeChbCiAgICAgICAgWyJwbG4iLCAvXlxzKy8sIHEsICIgXHRcclxuIl0sCiAgICAgICAgWyJhdHYiLCAvXig/OiJbXiJdKiI/fCdbXiddKic/KS8sIHEsICJcIiciXQogICAgXSwgWwogICAgICAgIFsidGFnIiwgL15ePFwvP1thLXpdKD86W1x3LS46XSpcdyk/fFwvPz4kL2ldLAogICAgICAgIFsiYXRuIiwgL14oPyFzdHlsZVtccz1dfG9uKVthLXpdKD86W1x3Oi1dKlx3KT8vaV0sCiAgICAgICAgWyJsYW5nLXVxLnZhbCIsIC9ePVxzKihbXlxzIic+XSooPzpbXlxzIicvPl18XC8oPz1ccykpKS9dLAogICAgICAgIFsicHVuIiwgL15bLzwtPl0rL10sCiAgICAgICAgWyJsYW5nLWpzIiwgL15vblx3K1xzKj1ccyoiKFteIl0rKSIvaV0sCiAgICAgICAgWyJsYW5nLWpzIiwgL15vblx3K1xzKj1ccyonKFteJ10rKScvaV0sCiAgICAgICAgWyJsYW5nLWpzIiwgL15vblx3K1xzKj1ccyooW15ccyInPl0rKS9pXSwKICAgICAgICBbImxhbmctY3NzIiwgL15zdHlsZVxzKj1ccyoiKFteIl0rKSIvaV0sCiAgICAgICAgWyJsYW5nLWNzcyIsIC9ec3R5bGVccyo9XHMqJyhbXiddKyknL2ldLAogICAgICAgIFsibGFuZy1jc3MiLAogICAgICAgICAgICAvXnN0eWxlXHMqPVxzKihbXlxzIic+XSspL2kKICAgICAgICBdCiAgICBdKSwgWyJpbi50YWciXSk7CiAgICBrKHgoW10sIFsKICAgICAgICBbImF0diIsIC9eW1xTXHNdKy9dCiAgICBdKSwgWyJ1cS52YWwiXSk7CiAgICBrKHUoewogICAgICAgIGtleXdvcmRzOiBGLAogICAgICAgIGhhc2hDb21tZW50czogITAsCiAgICAgICAgY1N0eWxlQ29tbWVudHM6ICEwLAogICAgICAgIHR5cGVzOiBLCiAgICB9KSwgWyJjIiwgImNjIiwgImNwcCIsICJjeHgiLCAiY3ljIiwgIm0iXSk7CiAgICBrKHUoewogICAgICAgIGtleXdvcmRzOiAibnVsbCx0cnVlLGZhbHNlIgogICAgfSksIFsianNvbiJdKTsKICAgIGsodSh7CiAgICAgICAga2V5d29yZHM6IEgsCiAgICAgICAgaGFzaENvbW1lbnRzOiAhMCwKICAgICAgICBjU3R5bGVDb21tZW50czogITAsCiAgICAgICAgdmVyYmF0aW1TdHJpbmdzOiAhMCwKICAgICAgICB0eXBlczogSwogICAgfSksIFsiY3MiXSk7CiAgICBrKHUoewogICAgICAgIGtleXdvcmRzOiBHLAogICAgICAgIGNTdHlsZUNvbW1lbnRzOiAhMAogICAgfSksIFsiamF2YSJdKTsKICAgIGsodSh7CiAgICAgICAga2V5d29yZHM6IHYsCiAgICAgICAgaGFzaENvbW1lbnRzOiAhMCwKICAgICAgICBtdWx0aUxpbmVTdHJpbmdzOiAhMAogICAgfSksIFsiYnNoIiwgImNzaCIsICJzaCJdKTsKICAgIGsodSh7CiAgICAgICAga2V5d29yZHM6IEksCiAgICAgICAgaGFzaENvbW1lbnRzOiAhMCwKICAgICAgICBtdWx0aUxpbmVTdHJpbmdzOiAhMCwKICAgICAgICB0cmlwbGVRdW90ZWRTdHJpbmdzOiAhMAogICAgfSksIFsiY3YiLCAicHkiXSk7CiAgICBrKHUoewogICAgICAgIGtleXdvcmRzOiAiY2FsbGVyLGRlbGV0ZSxkaWUsZG8sZHVtcCxlbHNpZixldmFsLGV4aXQsZm9yZWFjaCxmb3IsZ290byxpZixpbXBvcnQsbGFzdCxsb2NhbCxteSxuZXh0LG5vLG91cixwcmludCxwYWNrYWdlLHJlZG8scmVxdWlyZSxzdWIsdW5kZWYsdW5sZXNzLHVudGlsLHVzZSx3YW50YXJyYXksd2hpbGUsQkVHSU4sRU5EIiwKICAgICAgICBoYXNoQ29tbWVudHM6ICEwLAogICAgICAgIG11bHRpTGluZVN0cmluZ3M6ICEwLAogICAgICAgIHJlZ2V4TGl0ZXJhbHM6ICEwCiAgICB9KSwgWyJwZXJsIiwgInBsIiwgInBtIl0pOwogICAgayh1KHsKICAgICAgICBrZXl3b3JkczogSiwKICAgICAgICBoYXNoQ29tbWVudHM6ICEwLAogICAgICAgIG11bHRpTGluZVN0cmluZ3M6ICEwLAogICAgICAgIHJlZ2V4TGl0ZXJhbHM6ICEwCiAgICB9KSwgWyJyYiJdKTsKICAgIGsodSh7CiAgICAgICAga2V5d29yZHM6IHcsCiAgICAgICAgY1N0eWxlQ29tbWVudHM6ICEwLAogICAgICAgIHJlZ2V4TGl0ZXJhbHM6ICEwCiAgICB9KSwgWyJqcyJdKTsKICAgIGsodSh7CiAgICAgICAga2V5d29yZHM6ICJhbGwsYW5kLGJ5LGNhdGNoLGNsYXNzLGVsc2UsZXh0ZW5kcyxmYWxzZSxmaW5hbGx5LGZvcixpZixpbixpcyxpc250LGxvb3AsbmV3LG5vLG5vdCxudWxsLG9mLG9mZixvbixvcixyZXR1cm4sc3VwZXIsdGhlbix0cnVlLHRyeSx1bmxlc3MsdW50aWwsd2hlbix3aGlsZSx5ZXMiLAogICAgICAgIGhhc2hDb21tZW50czogMywKICAgICAgICBjU3R5bGVDb21tZW50czogITAsCiAgICAgICAgbXVsdGlsaW5lU3RyaW5nczogITAsCiAgICAgICAgdHJpcGxlUXVvdGVkU3RyaW5nczogITAsCiAgICAgICAgcmVnZXhMaXRlcmFsczogITAKICAgIH0pLCBbImNvZmZlZSJdKTsKICAgIGsoeChbXSwgWwogICAgICAgIFsic3RyIiwgL15bXFNcc10rL10KICAgIF0pLCBbInJlZ2V4Il0pOwogICAgd2luZG93LnByZXR0eVByaW50T25lID0gZnVuY3Rpb24oYSwgbSwgZSkgewogICAgICAgIHZhciBoID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiUFJFIik7CiAgICAgICAgaC5pbm5lckhUTUwgPSBhOwogICAgICAgIGUgJiYgRChoLCBlKTsKICAgICAgICBFKHsKICAgICAgICAgICAgZzogbSwKICAgICAgICAgICAgaTogZSwKICAgICAgICAgICAgaDogaAogICAgICAgIH0pOwogICAgICAgIHJldHVybiBoLmlubmVySFRNTAogICAgfTsKICAgIHdpbmRvdy5wcmV0dHlQcmludCA9IGZ1bmN0aW9uKGEpIHsKICAgICAgICBmdW5jdGlvbiBtKCkgewogICAgICAgICAgICBmb3IgKHZhciBlID0gd2luZG93LlBSX1NIT1VMRF9VU0VfQ09OVElOVUFUSU9OID8gbC5ub3coKSArIDI1MCA6IEluZmluaXR5OyBwIDwgaC5sZW5ndGggJiYgbC5ub3coKSA8IGU7IHArKykgewogICAgICAgICAgICAgICAgdmFyIG4gPSBoW3BdLAogICAgICAgICAgICAgICAgICAgIGsgPSBuLmNsYXNzTmFtZTsKICAgICAgICAgICAgICAgIGlmIChrLmluZGV4T2YoInByZXR0eXByaW50IikgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIHZhciBrID0gay5tYXRjaChnKSwKICAgICAgICAgICAgICAgICAgICAgICAgZiwgYjsKICAgICAgICAgICAgICAgICAgICBpZiAoYiA9ICFrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGIgPSBuOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBvID0gdm9pZCAwLCBjID0gYi5maXJzdENoaWxkOyBjOyBjID0gYy5uZXh0U2libGluZykgdmFyIGkgPSBjLm5vZGVUeXBlLAogICAgICAgICAgICAgICAgICAgICAgICBvID0gaSA9PT0gMSA/IG8gPyBiIDogYyA6IGkgPT09IDMgPyBOLnRlc3QoYy5ub2RlVmFsdWUpID8gYiA6IG8gOiBvOwogICAgICAgICAgICAgICAgICAgICAgICBiID0gKGYgPSBvID09PSBiID8gdm9pZCAwIDogbykgJiYgIkNPREUiID09PSBmLnRhZ05hbWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYiAmJiAoayA9IGYuY2xhc3NOYW1lLm1hdGNoKGcpKTsKICAgICAgICAgICAgICAgICAgICBrICYmIChrID0ga1sxXSk7CiAgICAgICAgICAgICAgICAgICAgYiA9ICExOwogICAgICAgICAgICAgICAgICAgIGZvciAobyA9IG4ucGFyZW50Tm9kZTsgbzsgbyA9IG8ucGFyZW50Tm9kZSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChvLnRhZ05hbWUgPT09ICJwcmUiIHx8IG8udGFnTmFtZSA9PT0gImNvZGUiIHx8IG8udGFnTmFtZSA9PT0gInhtcCIpICYmIG8uY2xhc3NOYW1lICYmIG8uY2xhc3NOYW1lLmluZGV4T2YoInByZXR0eXByaW50IikgPj0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYiA9ICEwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGIgfHwgKChiID0gKGIgPSBuLmNsYXNzTmFtZS5tYXRjaCgvXGJsaW5lbnVtc1xiKD86OihcZCspKT8vKSkgPyBiWzFdICYmIGJbMV0ubGVuZ3RoID8gK2JbMV0gOiAhMCA6ICExKSAmJiBEKG4sIGIpLCBkID0gewogICAgICAgICAgICAgICAgICAgICAgICBnOiBrLAogICAgICAgICAgICAgICAgICAgICAgICBoOiBuLAogICAgICAgICAgICAgICAgICAgICAgICBpOiBiCiAgICAgICAgICAgICAgICAgICAgfSwgRShkKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwIDwgaC5sZW5ndGggPyBzZXRUaW1lb3V0KG0sCiAgICAgICAgICAgICAgICAyNTApIDogYSAmJiBhKCkKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgZSA9IFtkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgicHJlIiksIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJjb2RlIiksIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ4bXAiKV0sIGggPSBbXSwgayA9IDA7IGsgPCBlLmxlbmd0aDsgKytrKQogICAgICAgICAgICBmb3IgKHZhciB0ID0gMCwgcyA9IGVba10ubGVuZ3RoOyB0IDwgczsgKyt0KSBoLnB1c2goZVtrXVt0XSk7CiAgICAgICAgdmFyIGUgPSBxLAogICAgICAgICAgICBsID0gRGF0ZTsKICAgICAgICBsLm5vdyB8fCAobCA9IHsKICAgICAgICAgICAgbm93OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiArbmV3IERhdGUKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBwID0gMCwKICAgICAgICAgICAgZCwgZyA9IC9cYmxhbmcoPzp1YWdlKT8tKFtcdy5dKykoPyFcUykvOwogICAgICAgIG0oKQogICAgfTsKICAgIHdpbmRvdy5QUiA9IHsKICAgICAgICBjcmVhdGVTaW1wbGVMZXhlcjogeCwKICAgICAgICByZWdpc3RlckxhbmdIYW5kbGVyOiBrLAogICAgICAgIHNvdXJjZURlY29yYXRvcjogdSwKICAgICAgICBQUl9BVFRSSUJfTkFNRTogImF0biIsCiAgICAgICAgUFJfQVRUUklCX1ZBTFVFOiAiYXR2IiwKICAgICAgICBQUl9DT01NRU5UOiAiY29tIiwKICAgICAgICBQUl9ERUNMQVJBVElPTjogImRlYyIsCiAgICAgICAgUFJfS0VZV09SRDogImt3ZCIsCiAgICAgICAgUFJfTElURVJBTDogImxpdCIsCiAgICAgICAgUFJfTk9DT0RFOiAibm9jb2RlIiwKICAgICAgICBQUl9QTEFJTjogInBsbiIsCiAgICAgICAgUFJfUFVOQ1RVQVRJT046ICJwdW4iLAogICAgICAgIFBSX1NPVVJDRTogInNyYyIsCiAgICAgICAgUFJfU1RSSU5HOiAic3RyIiwKICAgICAgICBQUl9UQUc6ICJ0YWciLAogICAgICAgIFBSX1RZUEU6ICJ0eXAiCiAgICB9Cn0pKCk7CgovKgogSFRNTDUgU2hpdiB2My42LjJwcmUgfCBAYWZhcmthcyBAamRhbHRvbiBAam9uX25lYWwgQHJlbSB8IE1JVC9HUEwyIExpY2Vuc2VkCiBVbmNvbXByZXNzZWQgc291cmNlOiBodHRwczovL2dpdGh1Yi5jb20vYUZhcmthcy9odG1sNXNoaXYKKi8KKGZ1bmN0aW9uKGwsIGYpIHsKICAgIGZ1bmN0aW9uIG0oKSB7CiAgICAgICAgdmFyIGEgPSBlLmVsZW1lbnRzOwogICAgICAgIHJldHVybiAic3RyaW5nIiA9PSB0eXBlb2YgYSA/IGEuc3BsaXQoIiAiKSA6IGEKICAgIH0KCiAgICBmdW5jdGlvbiBpKGEpIHsKICAgICAgICB2YXIgYiA9IG5bYVtvXV07CiAgICAgICAgYiB8fCAoYiA9IHt9LCBoKyssIGFbb10gPSBoLCBuW2hdID0gYik7CiAgICAgICAgcmV0dXJuIGIKICAgIH0KCiAgICBmdW5jdGlvbiBwKGEsIGIsIGMpIHsKICAgICAgICBiIHx8IChiID0gZik7CiAgICAgICAgaWYgKGcpIHJldHVybiBiLmNyZWF0ZUVsZW1lbnQoYSk7CiAgICAgICAgYyB8fCAoYyA9IGkoYikpOwogICAgICAgIGIgPSBjLmNhY2hlW2FdID8gYy5jYWNoZVthXS5jbG9uZU5vZGUoKSA6IHIudGVzdChhKSA/IChjLmNhY2hlW2FdID0gYy5jcmVhdGVFbGVtKGEpKS5jbG9uZU5vZGUoKSA6IGMuY3JlYXRlRWxlbShhKTsKICAgICAgICByZXR1cm4gYi5jYW5IYXZlQ2hpbGRyZW4gJiYgIXMudGVzdChhKSA/IGMuZnJhZy5hcHBlbmRDaGlsZChiKSA6IGIKICAgIH0KCiAgICBmdW5jdGlvbiB0KGEsIGIpIHsKICAgICAgICBpZiAoIWIuY2FjaGUpIGIuY2FjaGUgPSB7fSwgYi5jcmVhdGVFbGVtID0gYS5jcmVhdGVFbGVtZW50LCBiLmNyZWF0ZUZyYWcgPSBhLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQsIGIuZnJhZyA9IGIuY3JlYXRlRnJhZygpOwogICAgICAgIGEuY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgcmV0dXJuICFlLnNoaXZNZXRob2RzID8gYi5jcmVhdGVFbGVtKGMpIDogcChjLCBhLCBiKQogICAgICAgIH07CiAgICAgICAgYS5jcmVhdGVEb2N1bWVudEZyYWdtZW50ID0gRnVuY3Rpb24oImgsZiIsICJyZXR1cm4gZnVuY3Rpb24oKXt2YXIgbj1mLmNsb25lTm9kZSgpLGM9bi5jcmVhdGVFbGVtZW50O2guc2hpdk1ldGhvZHMmJigiICsgbSgpLmpvaW4oKS5yZXBsYWNlKC9cdysvZywgZnVuY3Rpb24oYSkgewogICAgICAgICAgICBiLmNyZWF0ZUVsZW0oYSk7CiAgICAgICAgICAgIGIuZnJhZy5jcmVhdGVFbGVtZW50KGEpOwogICAgICAgICAgICByZXR1cm4gJ2MoIicgKyBhICsgJyIpJwogICAgICAgIH0pICsgIik7cmV0dXJuIG59IikoZSwgYi5mcmFnKQogICAgfQoKICAgIGZ1bmN0aW9uIHEoYSkgewogICAgICAgIGEgfHwgKGEgPSBmKTsKICAgICAgICB2YXIgYiA9IGkoYSk7CiAgICAgICAgaWYgKGUuc2hpdkNTUyAmJiAhaiAmJiAhYi5oYXNDU1MpIHsKICAgICAgICAgICAgdmFyIGMsIGQgPSBhOwogICAgICAgICAgICBjID0gZC5jcmVhdGVFbGVtZW50KCJwIik7CiAgICAgICAgICAgIGQgPSBkLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF0gfHwgZC5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgIGMuaW5uZXJIVE1MID0gIng8c3R5bGU+YXJ0aWNsZSxhc2lkZSxmaWdjYXB0aW9uLGZpZ3VyZSxmb290ZXIsaGVhZGVyLGhncm91cCxtYWluLG5hdixzZWN0aW9ue2Rpc3BsYXk6YmxvY2t9bWFya3tiYWNrZ3JvdW5kOiNGRjA7Y29sb3I6IzAwMH08L3N0eWxlPiI7CiAgICAgICAgICAgIGMgPSBkLmluc2VydEJlZm9yZShjLmxhc3RDaGlsZCwgZC5maXJzdENoaWxkKTsKICAgICAgICAgICAgYi5oYXNDU1MgPSAhISBjCiAgICAgICAgfQogICAgICAgIGcgfHwgdChhLCBiKTsKICAgICAgICByZXR1cm4gYQogICAgfQogICAgdmFyIGsgPSBsLmh0bWw1IHx8IHt9LCBzID0gL148fF4oPzpidXR0b258bWFwfHNlbGVjdHx0ZXh0YXJlYXxvYmplY3R8aWZyYW1lfG9wdGlvbnxvcHRncm91cCkkL2ksCiAgICAgICAgciA9IC9eKD86YXxifGNvZGV8ZGl2fGZpZWxkc2V0fGgxfGgyfGgzfGg0fGg1fGg2fGl8bGFiZWx8bGl8b2x8cHxxfHNwYW58c3Ryb25nfHN0eWxlfHRhYmxlfHRib2R5fHRkfHRofHRyfHVsKSQvaSwKICAgICAgICBqLCBvID0gIl9odG1sNXNoaXYiLAogICAgICAgIGggPSAwLAogICAgICAgIG4gPSB7fSwgZzsKICAgIChmdW5jdGlvbigpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgYSA9IGYuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgICAgICAgICBhLmlubmVySFRNTCA9ICI8eHl6PjwveHl6PiI7CiAgICAgICAgICAgIGogPSAiaGlkZGVuIiBpbiBhOwogICAgICAgICAgICB2YXIgYjsKICAgICAgICAgICAgaWYgKCEoYiA9IDEgPT0gYS5jaGlsZE5vZGVzLmxlbmd0aCkpIHsKICAgICAgICAgICAgICAgIGYuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgICAgICAgICAgICAgdmFyIGMgPSBmLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgICAgIGIgPSAidW5kZWZpbmVkIiA9PSB0eXBlb2YgYy5jbG9uZU5vZGUgfHwKICAgICAgICAgICAgICAgICAgICAidW5kZWZpbmVkIiA9PSB0eXBlb2YgYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50IHx8ICJ1bmRlZmluZWQiID09IHR5cGVvZiBjLmNyZWF0ZUVsZW1lbnQKICAgICAgICAgICAgfQogICAgICAgICAgICBnID0gYgogICAgICAgIH0gY2F0Y2ggKGQpIHsKICAgICAgICAgICAgZyA9IGogPSAhMAogICAgICAgIH0KICAgIH0pKCk7CiAgICB2YXIgZSA9IHsKICAgICAgICBlbGVtZW50czogay5lbGVtZW50cyB8fCAiYWJiciBhcnRpY2xlIGFzaWRlIGF1ZGlvIGJkaSBjYW52YXMgZGF0YSBkYXRhbGlzdCBkZXRhaWxzIGZpZ2NhcHRpb24gZmlndXJlIGZvb3RlciBoZWFkZXIgaGdyb3VwIG1haW4gbWFyayBtZXRlciBuYXYgb3V0cHV0IHByb2dyZXNzIHNlY3Rpb24gc3VtbWFyeSB0aW1lIHZpZGVvIiwKICAgICAgICB2ZXJzaW9uOiAiMy42LjJwcmUiLAogICAgICAgIHNoaXZDU1M6ICExICE9PSBrLnNoaXZDU1MsCiAgICAgICAgc3VwcG9ydHNVbmtub3duRWxlbWVudHM6IGcsCiAgICAgICAgc2hpdk1ldGhvZHM6ICExICE9PSBrLnNoaXZNZXRob2RzLAogICAgICAgIHR5cGU6ICJkZWZhdWx0IiwKICAgICAgICBzaGl2RG9jdW1lbnQ6IHEsCiAgICAgICAgY3JlYXRlRWxlbWVudDogcCwKICAgICAgICBjcmVhdGVEb2N1bWVudEZyYWdtZW50OiBmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICAgIGEgfHwgKGEgPSBmKTsKICAgICAgICAgICAgaWYgKGcpIHJldHVybiBhLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgZm9yICh2YXIgYiA9IGIgfHwgaShhKSwgYyA9IGIuZnJhZy5jbG9uZU5vZGUoKSwgZCA9IDAsIGUgPSBtKCksIGggPSBlLmxlbmd0aDsgZCA8IGg7IGQrKykgYy5jcmVhdGVFbGVtZW50KGVbZF0pOwogICAgICAgICAgICByZXR1cm4gYwogICAgICAgIH0KICAgIH07CiAgICBsLmh0bWw1ID0gZTsKICAgIHEoZikKfSkodGhpcywgZG9jdW1lbnQpOw==",
                "body": "LyoKCUhUTUw1IFN1cGVyVGVtcGxhdGUgYnkgSmFsYWwgSGVqYXppIDIwMTQgCglTdXBlclRlbXBsYXRlLmpzCiovCgpqUXVlcnkoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uKCQpIHsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoJCU1FTlUgRHJvcGRvd25zCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgICAkKCd1bC5tZW51JykuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAvLyBhZGQgdGhlIG1lbnUgdG9nZ2xlCiAgICAgICAgJCh0aGlzKS5wcmVwZW5kKCc8bGkgY2xhc3M9Im1lbnUtdG9nZ2xlIj48YSBocmVmPSIjIj48c3BhbiBjbGFzcz0iaWNvbiIgZGF0YS1pY29uPSJZIj48L3NwYW4+IE1lbnU8L2E+PC9saT4nKTsKCiAgICAgICAgLy8gZmluZCBtZW51IGl0ZW1zIHdpdGggY2hpbGRyZW4uCiAgICAgICAgJCh0aGlzKS5maW5kKCdsaScpLmhhcygndWwnKS5hZGRDbGFzcygnaGFzLW1lbnUnKQogICAgICAgICAgICAuZmluZCgnYTpmaXJzdCcpLmFwcGVuZCgnPHNwYW4gY2xhc3M9ImFycm93Ij4mbmJzcDs8L3NwYW4+Jyk7CiAgICB9KTsKCiAgICAkKCd1bC5tZW51IGxpJykuaG92ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICQodGhpcykuZmluZCgndWw6Zmlyc3QnKS5zdG9wKHRydWUsIHRydWUpLmZhZGVJbignZmFzdCcpOwogICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCdob3ZlcicpOwogICAgICAgIH0sCiAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICQodGhpcykuZmluZCgndWwnKS5zdG9wKHRydWUsIHRydWUpLmZhZGVPdXQoJ3Nsb3cnKTsKICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmVDbGFzcygnaG92ZXInKTsKICAgICAgICB9KTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoJCVNsaWRlc2hvdwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogICAgJCgnLnNsaWRlc2hvdycpLmJ4U2xpZGVyKHsKICAgICAgICBtb2RlOiAnaG9yaXpvbnRhbCcsIC8vICdob3Jpem9udGFsJywgJ3ZlcnRpY2FsJywgJ2ZhZGUnCiAgICAgICAgdmlkZW86IHRydWUsCiAgICAgICAgdXNlQ1NTOiB0cnVlLAogICAgICAgIHBhZ2VyOiB0cnVlLAogICAgICAgIHNwZWVkOiA1MDAsIC8vIHRyYW5zaXRpb24gdGltZQogICAgICAgIHN0YXJ0U2xpZGU6IDAsCiAgICAgICAgaW5maW5pdGVMb29wOiB0cnVlLAogICAgICAgIGNhcHRpb25zOiB0cnVlLAogICAgICAgIGFkYXB0aXZlSGVpZ2h0OiBmYWxzZSwKICAgICAgICB0b3VjaEVuYWJsZWQ6IHRydWUsCiAgICAgICAgcGF1c2U6IDQwMDAsCiAgICAgICAgYXV0b0NvbnRyb2xzOiBmYWxzZSwKICAgICAgICBjb250cm9sczogZmFsc2UsCiAgICAgICAgYXV0b1N0YXJ0OiB0cnVlLAogICAgICAgIGF1dG86IHRydWUKICAgIH0pOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkJRmFuY3lib3ggTGlnaHRib3gKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgICQoJy5nYWxsZXJ5JykuZWFjaChmdW5jdGlvbihpKSB7CiAgICAgICAgJCh0aGlzKS5maW5kKCdhJykuYXR0cigncmVsJywgJ2dhbGxlcnknICsgaSkKICAgICAgICAgICAgLmZhbmN5Ym94KHsKICAgICAgICAgICAgICAgIG92ZXJsYXlPcGFjaXR5OiAwLjIsCiAgICAgICAgICAgICAgICBvdmVybGF5Q29sb3I6ICcjMDAwJwogICAgICAgICAgICB9KTsKICAgIH0pOwoKICAgIC8vIGxpZ2h0Ym94IGxpbmtzCiAgICAkKCdhLmxpZ2h0Ym94JykuZmFuY3lib3goewogICAgICAgIG92ZXJsYXlPcGFjaXR5OiAwLjIsCiAgICAgICAgb3ZlcmxheUNvbG9yOiAnIzAwMCcKICAgIH0pOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkJVGFicwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogICAgLy8gdGFiIHNldHVwCiAgICAkKCcudGFiLWNvbnRlbnQnKS5hZGRDbGFzcygnY2xlYXJmaXgnKS5ub3QoJzpmaXJzdCcpLmhpZGUoKTsKICAgICQoJ3VsLnRhYnMnKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjdXJyZW50ID0gJCh0aGlzKS5maW5kKCdsaS5jdXJyZW50Jyk7CiAgICAgICAgaWYgKGN1cnJlbnQubGVuZ3RoIDwgMSkgewogICAgICAgICAgICAkKHRoaXMpLmZpbmQoJ2xpOmZpcnN0JykuYWRkQ2xhc3MoJ2N1cnJlbnQnKTsKICAgICAgICB9CiAgICAgICAgY3VycmVudCA9ICQodGhpcykuZmluZCgnbGkuY3VycmVudCBhJykuYXR0cignaHJlZicpOwogICAgICAgICQoY3VycmVudCkuc2hvdygpOwogICAgfSk7CgogICAgLy8gdGFiIGNsaWNrCiAgICAkKGRvY3VtZW50KS5vbignY2xpY2snLCAndWwudGFicyBhW2hyZWZePSIjIl0nLCBmdW5jdGlvbihlKSB7CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIHZhciB0YWJzID0gJCh0aGlzKS5wYXJlbnRzKCd1bC50YWJzJykuZmluZCgnbGknKTsKICAgICAgICB2YXIgdGFiX25leHQgPSAkKHRoaXMpLmF0dHIoJ2hyZWYnKTsKICAgICAgICB2YXIgdGFiX2N1cnJlbnQgPSB0YWJzLmZpbHRlcignLmN1cnJlbnQnKS5maW5kKCdhJykuYXR0cignaHJlZicpOwogICAgICAgICQodGFiX2N1cnJlbnQpLmhpZGUoKTsKICAgICAgICB0YWJzLnJlbW92ZUNsYXNzKCdjdXJyZW50Jyk7CiAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5hZGRDbGFzcygnY3VycmVudCcpOwogICAgICAgICQodGFiX25leHQpLnNob3coKTsKICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZShudWxsLCBudWxsLCB3aW5kb3cubG9jYXRpb24uc2VhcmNoICsgJCh0aGlzKS5hdHRyKCdocmVmJykpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0pOwoKICAgIC8vIHRhYiBoYXNodGFnIGlkZW50aWZpY2F0aW9uIGFuZCBhdXRvLWZvY3VzCiAgICB2YXIgd2FudGVkVGFnID0gd2luZG93LmxvY2F0aW9uLmhhc2g7CiAgICBpZiAod2FudGVkVGFnICE9ICIiKSB7CiAgICAgICAgLy8gVGhpcyBjb2RlIGNhbiBhbmQgZG9lcyBmYWlsLCBoYXJkLCBraWxsaW5nIHRoZSBlbnRpcmUgYXBwLgogICAgICAgIC8vIEVzcC4gd2hlbiB1c2VkIHdpdGggdGhlIGpRdWVyeS5BZGRyZXNzIHByb2plY3QuCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGFsbFRhYnMgPSAkKCJ1bC50YWJzIGFbaHJlZl49IiArIHdhbnRlZFRhZyArICJdIikucGFyZW50cygndWwudGFicycpLmZpbmQoJ2xpJyk7CiAgICAgICAgICAgIHZhciBkZWZhdWx0VGFiID0gYWxsVGFicy5maWx0ZXIoJy5jdXJyZW50JykuZmluZCgnYScpLmF0dHIoJ2hyZWYnKTsKICAgICAgICAgICAgJChkZWZhdWx0VGFiKS5oaWRlKCk7CiAgICAgICAgICAgIGFsbFRhYnMucmVtb3ZlQ2xhc3MoJ2N1cnJlbnQnKTsKICAgICAgICAgICAgJCgidWwudGFicyBhW2hyZWZePSIgKyB3YW50ZWRUYWcgKyAiXSIpLnBhcmVudCgpLmFkZENsYXNzKCdjdXJyZW50Jyk7CiAgICAgICAgICAgICQoIiMiICsgd2FudGVkVGFnLnJlcGxhY2UoJyMnLCAnJykpLnNob3coKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIC8vIEkgaGF2ZSBubyBpZGVhIHdoYXQgdG8gZG8gaGVyZSwgc28gSSdtIGxlYXZpbmcgdGhpcyBmb3IgdGhlIG1haW50YWluZXIuCiAgICAgICAgfQogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkJSW1hZ2UgQ2FwdGlvbgoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwogICAgJCgnaW1nLmNhcHRpb24nKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICQodGhpcykud3JhcCgnPGRpdiBjbGFzcz0iY2FwdGlvbiI+Jyk7CiAgICAgICAgJCh0aGlzKS5wYXJlbnRzKCdkaXYuY2FwdGlvbicpCiAgICAgICAgICAgIC5hdHRyKCdjbGFzcycsICdpbWctd3JhcCAnICsgJCh0aGlzKS5hdHRyKCdjbGFzcycpKTsKICAgICAgICBpZiAoJCh0aGlzKS5hdHRyKCd0aXRsZScpKSB7CiAgICAgICAgICAgICQodGhpcykucGFyZW50cygnZGl2LmNhcHRpb24nKQogICAgICAgICAgICAgICAgLmFwcGVuZCgnPHNwYW4+JyArICQodGhpcykuYXR0cigndGl0bGUnKSArICc8L3NwYW4+Jyk7CiAgICAgICAgfQogICAgfSk7CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCQlOb3RpY2UKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgICQoZG9jdW1lbnQpLm9uKCdjbGljaycsICcubm90aWNlIGFbY2xhc3NePSJpY29uLXJlbW92ZSJdJywgZnVuY3Rpb24oZSkgewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB2YXIgbm90aWNlID0gJCh0aGlzKS5wYXJlbnRzKCcubm90aWNlJyk7CiAgICAgICAgJCh0aGlzKS5oaWRlKCk7CiAgICAgICAgbm90aWNlLmZhZGVPdXQoJ3Nsb3cnKTsKICAgIH0pOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgkJVG9vbFRpcCAtIFRpcFRpcAoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8vIFN0YW5kYXJkIHRvb2x0aXAKICAgICQoJy50b29sdGlwLCAudG9vbHRpcC10b3AsIC50b29sdGlwLWJvdHRvbSwgLnRvb2x0aXAtcmlnaHQsIC50b29sdGlwLWxlZnQnKS5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgIC8vIHZhcmlhYmxlcwogICAgICAgIHZhciB0cG9zID0gJ3RvcCc7CiAgICAgICAgdmFyIGNvbnRlbnQgPSAkKHRoaXMpLmF0dHIoJ3RpdGxlJyk7CiAgICAgICAgdmFyIGRhdGFDb250ZW50ID0gJCh0aGlzKS5hdHRyKCdkYXRhLWNvbnRlbnQnKTsKICAgICAgICB2YXIga2VlcEFsaXZlID0gZmFsc2U7CiAgICAgICAgdmFyIGFjdGlvbiA9ICdob3Zlcic7CiAgICAgICAgdmFyIGRlbGF5ID0gJCh0aGlzKS5hdHRyKCdkYXRhLWRlbGF5Jyk7CiAgICAgICAgaWYgKGRlbGF5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZGVsYXkgPSAxMDAwOwogICAgICAgIH0KCiAgICAgICAgLy8gcG9zaXRpb24KICAgICAgICBpZiAoJCh0aGlzKS5oYXNDbGFzcygndG9vbHRpcC10b3AnKSkgewogICAgICAgICAgICB0cG9zID0gJ3RvcCc7CiAgICAgICAgfQogICAgICAgIGlmICgkKHRoaXMpLmhhc0NsYXNzKCd0b29sdGlwLXJpZ2h0JykpIHsKICAgICAgICAgICAgdHBvcyA9ICdyaWdodCc7CiAgICAgICAgfQogICAgICAgIGlmICgkKHRoaXMpLmhhc0NsYXNzKCd0b29sdGlwLWJvdHRvbScpKSB7CiAgICAgICAgICAgIHRwb3MgPSAnYm90dG9tJzsKICAgICAgICB9CiAgICAgICAgaWYgKCQodGhpcykuaGFzQ2xhc3MoJ3Rvb2x0aXAtbGVmdCcpKSB7CiAgICAgICAgICAgIHRwb3MgPSAnbGVmdCc7CiAgICAgICAgfQoKICAgICAgICAvLyBjb250ZW50CiAgICAgICAgJCgnLnRvb2x0aXAtY29udGVudCcpLnJlbW92ZUNsYXNzKCdoaWRlJykud3JhcCgnPGRpdiBjbGFzcz0iaGlkZSI+PC9kaXY+Jyk7CiAgICAgICAgaWYgKGRhdGFDb250ZW50KSB7CiAgICAgICAgICAgIGNvbnRlbnQgPSAkKGRhdGFDb250ZW50KS5odG1sKCk7CiAgICAgICAgICAgIGtlZXBBbGl2ZSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICAvLyBhY3Rpb24gKGhvdmVyIG9yIGNsaWNrKSBkZWZhdWx0cyB0byBob3ZlcgogICAgICAgIGlmICgkKHRoaXMpLmF0dHIoJ2RhdGEtYWN0aW9uJykgPT0gJ2NsaWNrJykgewogICAgICAgICAgICBhY3Rpb24gPSAnY2xpY2snOwogICAgICAgIH0KCiAgICAgICAgLy8gdG9vbHRpcAogICAgICAgICQodGhpcykuYXR0cigndGl0bGUnLCAnJykKICAgICAgICAgICAgLnRpcFRpcCh7CiAgICAgICAgICAgICAgICBkZWZhdWx0UG9zaXRpb246IHRwb3MsCiAgICAgICAgICAgICAgICBjb250ZW50OiBjb250ZW50LAogICAgICAgICAgICAgICAga2VlcEFsaXZlOiBrZWVwQWxpdmUsCiAgICAgICAgICAgICAgICBhY3RpdmF0aW9uOiBhY3Rpb24sCiAgICAgICAgICAgICAgICBkZWxheTogZGVsYXkKICAgICAgICAgICAgfSk7CiAgICB9KTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoJCVRhYmxlIFNvcnQKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KICAgIC8vIGluaXQKICAgIHZhciBhQXNjID0gW107CiAgICAkKCd0YWJsZS5zb3J0YWJsZScpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgJCh0aGlzKS5maW5kKCd0aGVhZCB0aCcpLmVhY2goZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgICAgICAgJCh0aGlzKS5hdHRyKCdyZWwnLCBpbmRleCk7CiAgICAgICAgfSk7CiAgICAgICAgJCh0aGlzKS5maW5kKCd0aCx0ZCcpLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICQodGhpcykuYXR0cigndmFsdWUnLCAkKHRoaXMpLnRleHQoKSk7CiAgICAgICAgfSk7CiAgICB9KTsKCiAgICAvLyB0YWJsZSBjbGljawogICAgJChkb2N1bWVudCkub24oJ2NsaWNrJywgJ3RhYmxlLnNvcnRhYmxlIHRoZWFkIHRoJywgZnVuY3Rpb24oZSkgewogICAgICAgIC8vIHVwZGF0ZSBhcnJvdyBpY29uCiAgICAgICAgJCh0aGlzKS5wYXJlbnRzKCd0YWJsZS5zb3J0YWJsZScpLmZpbmQoJ3NwYW4uYXJyb3cnKS5yZW1vdmUoKTsKICAgICAgICAkKHRoaXMpLmFwcGVuZCgnPHNwYW4gY2xhc3M9ImFycm93Ij48L3NwYW4+Jyk7CgogICAgICAgIC8vIHNvcnQgZGlyZWN0aW9uCiAgICAgICAgdmFyIG5yID0gJCh0aGlzKS5hdHRyKCdyZWwnKTsKICAgICAgICBhQXNjW25yXSA9IGFBc2NbbnJdID09ICdhc2MnID8gJ2Rlc2MnIDogJ2FzYyc7CiAgICAgICAgaWYgKGFBc2NbbnJdID09ICdkZXNjJykgewogICAgICAgICAgICAkKHRoaXMpLmZpbmQoJ3NwYW4uYXJyb3cnKS5hZGRDbGFzcygndXAnKTsKICAgICAgICB9CgogICAgICAgIC8vIHNvcnQgcm93cwogICAgICAgIHZhciByb3dzID0gJCh0aGlzKS5wYXJlbnRzKCd0YWJsZS5zb3J0YWJsZScpLmZpbmQoJ3Rib2R5IHRyJyk7CiAgICAgICAgcm93cy50c29ydCgndGQ6ZXEoJyArIG5yICsgJyknLCB7CiAgICAgICAgICAgIG9yZGVyOiBhQXNjW25yXSwKICAgICAgICAgICAgYXR0cjogJ3ZhbHVlJwogICAgICAgIH0pOwoKICAgICAgICAvLyBmaXggcm93IGNsYXNzZXMKICAgICAgICByb3dzLnJlbW92ZUNsYXNzKCdhbHQgZmlyc3QgbGFzdCcpOwogICAgICAgIHZhciB0YWJsZSA9ICQodGhpcykucGFyZW50cygndGFibGUuc29ydGFibGUnKTsKICAgICAgICB0YWJsZS5maW5kKCd0cjpldmVuJykuYWRkQ2xhc3MoJ2FsdCcpOwogICAgICAgIHRhYmxlLmZpbmQoJ3RyOmZpcnN0JykuYWRkQ2xhc3MoJ2ZpcnN0Jyk7CiAgICAgICAgdGFibGUuZmluZCgndHI6bGFzdCcpLmFkZENsYXNzKCdsYXN0Jyk7CiAgICB9KTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoJCUNTUyBIZWxwZXJzCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCiAgICAkKCdpbnB1dFt0eXBlPWNoZWNrYm94XScpLmFkZENsYXNzKCdjaGVja2JveCcpOwogICAgJCgnaW5wdXRbdHlwZT1yYWRpb10nKS5hZGRDbGFzcygncmFkaW8nKTsKICAgICQoJ2lucHV0W3R5cGU9ZmlsZV0nKS5hZGRDbGFzcygnZmlsZScpOwogICAgJCgnW2Rpc2FibGVkPWRpc2FibGVkXScpLmFkZENsYXNzKCdkaXNhYmxlZCcpOwogICAgJCgndGFibGUnKS5maW5kKCd0cjpldmVuJykuYWRkQ2xhc3MoJ2FsdCcpOwogICAgJCgndGFibGUnKS5maW5kKCd0cjpmaXJzdC1jaGlsZCcpLmFkZENsYXNzKCdmaXJzdCcpOwogICAgJCgndGFibGUnKS5maW5kKCd0cjpsYXN0LWNoaWxkJykuYWRkQ2xhc3MoJ2xhc3QnKTsKICAgICQoJ3VsJykuZmluZCgnbGk6Zmlyc3QtY2hpbGQnKS5hZGRDbGFzcygnZmlyc3QnKTsKICAgICQoJ3VsJykuZmluZCgnbGk6bGFzdC1jaGlsZCcpLmFkZENsYXNzKCdsYXN0Jyk7CiAgICAkKCdocicpLmJlZm9yZSgnPGRpdiBjbGFzcz0iY2xlYXIiPiZuYnNwOzwvZGl2PicpOwogICAgJCgnW2NsYXNzKj0iY29sXyJdJykuYWRkQ2xhc3MoJ2NvbHVtbicpOwogICAgJCgncHJlJykuYWRkQ2xhc3MoJ3ByZXR0eXByaW50Jyk7CiAgICBwcmV0dHlQcmludCgpOwoKfSk7CgovKgogKiBGYW5jeUJveCAtIGpRdWVyeSBQbHVnaW4KICogU2ltcGxlIGFuZCBmYW5jeSBsaWdodGJveCBhbHRlcm5hdGl2ZQogKgogKiBFeGFtcGxlcyBhbmQgZG9jdW1lbnRhdGlvbiBhdDogaHR0cDovL2ZhbmN5Ym94Lm5ldAogKgogKiBDb3B5cmlnaHQgKGMpIDIwMDggLSAyMDEwIEphbmlzIFNrYXJuZWxpcwogKiBUaGF0IHNhaWQsIGl0IGlzIGhhcmRseSBhIG9uZS1wZXJzb24gcHJvamVjdC4gTWFueSBwZW9wbGUgaGF2ZSBzdWJtaXR0ZWQgYnVncywgY29kZSwgYW5kIG9mZmVyZWQgdGhlaXIgYWR2aWNlIGZyZWVseS4gVGhlaXIgc3VwcG9ydCBpcyBncmVhdGx5IGFwcHJlY2lhdGVkLgogKgogKiBWZXJzaW9uOiAxLjMuNCAoMTEvMTEvMjAxMCkKICogUmVxdWlyZXM6IGpRdWVyeSB2MS4zKwogKgogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlczoKICogICBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAogKiAgIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9ncGwuaHRtbAogKi8KKGZ1bmN0aW9uKGEpIHsKICAgIHZhciBwLCB1LCB2LCBlLCBCLCBtLCBDLCBqLCB5LCB6LCBzID0gMCwKICAgICAgICBkID0ge30sIHEgPSBbXSwKICAgICAgICByID0gMCwKICAgICAgICBjID0ge30sIGsgPSBbXSwKICAgICAgICBFID0gbnVsbCwKICAgICAgICBuID0gbmV3IEltYWdlLAogICAgICAgIEggPSAvXC4oanBnfGdpZnxwbmd8Ym1wfGpwZWcpKC4qKT8kL2ksCiAgICAgICAgUyA9IC9bXlwuXVwuKHN3ZilccyokL2ksCiAgICAgICAgSSwgSiA9IDEsCiAgICAgICAgeCA9IDAsCiAgICAgICAgdyA9ICIiLAogICAgICAgIHQsIGcsIGwgPSAhMSwKICAgICAgICBBID0gYS5leHRlbmQoYSgiPGRpdi8+IilbMF0sIHsKICAgICAgICAgICAgcHJvcDogMAogICAgICAgIH0pLAogICAgICAgIEsgPSBuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9tc2llIFs2XS9pKSAmJiAhd2luZG93LlhNTEh0dHBSZXF1ZXN0LAogICAgICAgIEwgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdS5oaWRlKCk7CiAgICAgICAgICAgIG4ub25lcnJvciA9IG4ub25sb2FkID0gbnVsbDsKICAgICAgICAgICAgRSAmJiBFLmFib3J0KCk7CiAgICAgICAgICAgIHAuZW1wdHkoKQogICAgICAgIH0sIE0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgITEgPT09IGQub25FcnJvcihxLCBzLCBkKSA/ICh1LmhpZGUoKSwgbCA9ICExKSA6IChkLnRpdGxlU2hvdyA9ICExLCBkLndpZHRoID0gImF1dG8iLCBkLmhlaWdodCA9ICJhdXRvIiwgcC5odG1sKCc8cCBpZD0iZmFuY3lib3gtZXJyb3IiPlRoZSByZXF1ZXN0ZWQgY29udGVudCBjYW5ub3QgYmUgbG9hZGVkLjxiciAvPlBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuPC9wPicpLAogICAgICAgICAgICAgICAgRCgpKQogICAgICAgIH0sIEcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGIgPSBxW3NdLAogICAgICAgICAgICAgICAgYywgZiwgZSwgZywgaywgajsKICAgICAgICAgICAgTCgpOwogICAgICAgICAgICBkID0gYS5leHRlbmQoe30sIGEuZm4uZmFuY3lib3guZGVmYXVsdHMsICJ1bmRlZmluZWQiID09IHR5cGVvZiBhKGIpLmRhdGEoImZhbmN5Ym94IikgPyBkIDogYShiKS5kYXRhKCJmYW5jeWJveCIpKTsKICAgICAgICAgICAgaiA9IGQub25TdGFydChxLCBzLCBkKTsKICAgICAgICAgICAgaWYgKCExID09PSBqKSBsID0gITE7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgIm9iamVjdCIgPT0gdHlwZW9mIGogJiYgKGQgPSBhLmV4dGVuZChkLCBqKSk7CiAgICAgICAgICAgICAgICBlID0gZC50aXRsZSB8fCAoYi5ub2RlTmFtZSA/IGEoYikuYXR0cigidGl0bGUiKSA6IGIudGl0bGUpIHx8ICIiOwogICAgICAgICAgICAgICAgYi5ub2RlTmFtZSAmJiAhZC5vcmlnICYmIChkLm9yaWcgPSBhKGIpLmNoaWxkcmVuKCJpbWc6Zmlyc3QiKS5sZW5ndGggPyBhKGIpLmNoaWxkcmVuKCJpbWc6Zmlyc3QiKSA6IGEoYikpOwogICAgICAgICAgICAgICAgIiIgPT09IGUgJiYgKGQub3JpZyAmJiBkLnRpdGxlRnJvbUFsdCkgJiYgKGUgPSBkLm9yaWcuYXR0cigiYWx0IikpOwogICAgICAgICAgICAgICAgYyA9IGQuaHJlZiB8fCAoYi5ub2RlTmFtZSA/IGEoYikuYXR0cigiaHJlZiIpIDogYi5ocmVmKSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKC9eKD86amF2YXNjcmlwdCkvaS50ZXN0KGMpIHx8CiAgICAgICAgICAgICAgICAgICAgIiMiID09IGMpIGMgPSBudWxsOwogICAgICAgICAgICAgICAgZC50eXBlID8gKGYgPSBkLnR5cGUsIGMgfHwgKGMgPSBkLmNvbnRlbnQpKSA6IGQuY29udGVudCA/IGYgPSAiaHRtbCIgOiBjICYmIChmID0gYy5tYXRjaChIKSA/ICJpbWFnZSIgOiBjLm1hdGNoKFMpID8gInN3ZiIgOiBhKGIpLmhhc0NsYXNzKCJpZnJhbWUiKSA/ICJpZnJhbWUiIDogMCA9PT0gYy5pbmRleE9mKCIjIikgPyAiaW5saW5lIiA6ICJhamF4Iik7CiAgICAgICAgICAgICAgICBpZiAoZikgc3dpdGNoICgiaW5saW5lIiA9PSBmICYmIChiID0gYy5zdWJzdHIoYy5pbmRleE9mKCIjIikpLCBmID0gMCA8IGEoYikubGVuZ3RoID8gImlubGluZSIgOiAiYWpheCIpLCBkLnR5cGUgPSBmLCBkLmhyZWYgPSBjLCBkLnRpdGxlID0gZSwgZC5hdXRvRGltZW5zaW9ucyAmJiAoImh0bWwiID09IGQudHlwZSB8fCAiaW5saW5lIiA9PSBkLnR5cGUgfHwgImFqYXgiID09IGQudHlwZSA/IChkLndpZHRoID0gImF1dG8iLCBkLmhlaWdodCA9ICJhdXRvIikgOiBkLmF1dG9EaW1lbnNpb25zID0gITEpLCBkLm1vZGFsICYmIChkLm92ZXJsYXlTaG93ID0gITAsIGQuaGlkZU9uT3ZlcmxheUNsaWNrID0gITEsIGQuaGlkZU9uQ29udGVudENsaWNrID0gITEsIGQuZW5hYmxlRXNjYXBlQnV0dG9uID0gITEsIGQuc2hvd0Nsb3NlQnV0dG9uID0gITEpLCBkLnBhZGRpbmcgPSBwYXJzZUludChkLnBhZGRpbmcsIDEwKSwgZC5tYXJnaW4gPSBwYXJzZUludChkLm1hcmdpbiwgMTApLCBwLmNzcygicGFkZGluZyIsIGQucGFkZGluZyArIGQubWFyZ2luKSwgYSgiLmZhbmN5Ym94LWlubGluZS10bXAiKS51bmJpbmQoImZhbmN5Ym94LWNhbmNlbCIpLmJpbmQoImZhbmN5Ym94LWNoYW5nZSIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGEodGhpcykucmVwbGFjZVdpdGgobS5jaGlsZHJlbigpKQogICAgICAgICAgICAgICAgfSksIGYpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICJodG1sIjoKICAgICAgICAgICAgICAgICAgICAgICAgcC5odG1sKGQuY29udGVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgIEQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAiaW5saW5lIjoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEwID09PSBhKGIpLnBhcmVudCgpLmlzKCIjZmFuY3lib3gtY29udGVudCIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsID0gITE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGEoJzxkaXYgY2xhc3M9ImZhbmN5Ym94LWlubGluZS10bXAiIC8+JykuaGlkZSgpLmluc2VydEJlZm9yZShhKGIpKS5iaW5kKCJmYW5jeWJveC1jbGVhbnVwIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhKHRoaXMpLnJlcGxhY2VXaXRoKG0uY2hpbGRyZW4oKSkKICAgICAgICAgICAgICAgICAgICAgICAgfSkuYmluZCgiZmFuY3lib3gtY2FuY2VsIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEodGhpcykucmVwbGFjZVdpdGgocC5jaGlsZHJlbigpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGEoYikuYXBwZW5kVG8ocCk7CiAgICAgICAgICAgICAgICAgICAgICAgIEQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAiaW1hZ2UiOgogICAgICAgICAgICAgICAgICAgICAgICBsID0gITE7CiAgICAgICAgICAgICAgICAgICAgICAgIGEuZmFuY3lib3guc2hvd0FjdGl2aXR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIG4gPSBuZXcgSW1hZ2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG4ub25lcnJvciA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgTSgpCiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIG4ub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsID0gITA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuLm9uZXJyb3IgPSBuLm9ubG9hZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkLndpZHRoID0gbi53aWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGQuaGVpZ2h0ID0gbi5oZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhKCI8aW1nIC8+IikuYXR0cih7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6ICJmYW5jeWJveC1pbWciLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogbi5zcmMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWx0OiBkLnRpdGxlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5hcHBlbmRUbyhwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIE4oKQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBuLnNyYyA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgInN3ZiI6CiAgICAgICAgICAgICAgICAgICAgICAgIGQuc2Nyb2xsaW5nID0gIm5vIjsKICAgICAgICAgICAgICAgICAgICAgICAgZyA9ICc8b2JqZWN0IGNsYXNzaWQ9ImNsc2lkOkQyN0NEQjZFLUFFNkQtMTFjZi05NkI4LTQ0NDU1MzU0MDAwMCIgd2lkdGg9IicgKyBkLndpZHRoICsgJyIgaGVpZ2h0PSInICsgZC5oZWlnaHQgKyAnIj48cGFyYW0gbmFtZT0ibW92aWUiIHZhbHVlPSInICsgYyArICciPjwvcGFyYW0+JzsKICAgICAgICAgICAgICAgICAgICAgICAgayA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICBhLmVhY2goZC5zd2YsIGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGcgKz0gJzxwYXJhbSBuYW1lPSInICsgYSArICciIHZhbHVlPSInICsgYiArICciPjwvcGFyYW0+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGsgKz0gIiAiICsgYSArICc9IicgKyBiICsgJyInCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBnICs9ICc8ZW1iZWQgc3JjPSInICsgYyArICciIHR5cGU9ImFwcGxpY2F0aW9uL3gtc2hvY2t3YXZlLWZsYXNoIiB3aWR0aD0iJyArIGQud2lkdGggKyAnIiBoZWlnaHQ9IicgKyBkLmhlaWdodCArICciJyArIGsgKyAiPjwvZW1iZWQ+PC9vYmplY3Q+IjsKICAgICAgICAgICAgICAgICAgICAgICAgcC5odG1sKGcpOwogICAgICAgICAgICAgICAgICAgICAgICBEKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgImFqYXgiOgogICAgICAgICAgICAgICAgICAgICAgICBsID0gITE7CiAgICAgICAgICAgICAgICAgICAgICAgIGEuZmFuY3lib3guc2hvd0FjdGl2aXR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGQuYWpheC53aW4gPSBkLmFqYXguc3VjY2VzczsKICAgICAgICAgICAgICAgICAgICAgICAgRSA9IGEuYWpheChhLmV4dGVuZCh7fSwgZC5hamF4LCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBkLmFqYXguZGF0YSB8fCB7fSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbihhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMCA8IGEuc3RhdHVzICYmIE0oKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGEsIGIsIGYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoMjAwID09ICgib2JqZWN0IiA9PSB0eXBlb2YgZiA/IGYgOiBFKS5zdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIGQuYWpheC53aW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGogPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGQuYWpheC53aW4oYywgYSwgYiwgZik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoITEgPT09IGopIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1LmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgaiB8fCAib2JqZWN0IiA9PSB0eXBlb2YgaikgYSA9IGoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLmh0bWwoYSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJpZnJhbWUiOgogICAgICAgICAgICAgICAgICAgICAgICBOKCkKICAgICAgICAgICAgICAgIH0gZWxzZSBNKCkKICAgICAgICAgICAgfQogICAgICAgIH0sIEQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGIgPSBkLndpZHRoLAogICAgICAgICAgICAgICAgYyA9IGQuaGVpZ2h0LAogICAgICAgICAgICAgICAgYiA9IC0xIDwgYi50b1N0cmluZygpLmluZGV4T2YoIiUiKSA/IHBhcnNlSW50KChhKHdpbmRvdykud2lkdGgoKSAtIDIgKiBkLm1hcmdpbikgKiBwYXJzZUZsb2F0KGIpIC8gMTAwLCAxMCkgKyAicHgiIDogImF1dG8iID09IGIgPyAiYXV0byIgOiBiICsgInB4IiwKICAgICAgICAgICAgICAgIGMgPSAtMSA8IGMudG9TdHJpbmcoKS5pbmRleE9mKCIlIikgPyBwYXJzZUludCgoYSh3aW5kb3cpLmhlaWdodCgpIC0gMiAqIGQubWFyZ2luKSAqIHBhcnNlRmxvYXQoYykgLyAxMDAsIDEwKSArICJweCIgOiAiYXV0byIgPT0gYyA/ICJhdXRvIiA6IGMgKyAicHgiOwogICAgICAgICAgICBwLndyYXBJbm5lcignPGRpdiBzdHlsZT0id2lkdGg6JyArIGIgKyAiO2hlaWdodDoiICsgYyArICI7b3ZlcmZsb3c6ICIgKyAoImF1dG8iID09CiAgICAgICAgICAgICAgICBkLnNjcm9sbGluZyA/ICJhdXRvIiA6ICJ5ZXMiID09IGQuc2Nyb2xsaW5nID8gInNjcm9sbCIgOiAiaGlkZGVuIikgKyAnO3Bvc2l0aW9uOnJlbGF0aXZlOyI+PC9kaXY+Jyk7CiAgICAgICAgICAgIGQud2lkdGggPSBwLndpZHRoKCk7CiAgICAgICAgICAgIGQuaGVpZ2h0ID0gcC5oZWlnaHQoKTsKICAgICAgICAgICAgTigpCiAgICAgICAgfSwgTiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYiwgaDsKICAgICAgICAgICAgdS5oaWRlKCk7CiAgICAgICAgICAgIGlmIChlLmlzKCI6dmlzaWJsZSIpICYmICExID09PSBjLm9uQ2xlYW51cChrLCByLCBjKSkgYS5ldmVudC50cmlnZ2VyKCJmYW5jeWJveC1jYW5jZWwiKSwgbCA9ICExOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGwgPSAhMDsKICAgICAgICAgICAgICAgIGEobS5hZGQodikpLnVuYmluZCgpOwogICAgICAgICAgICAgICAgYSh3aW5kb3cpLnVuYmluZCgicmVzaXplLmZiIHNjcm9sbC5mYiIpOwogICAgICAgICAgICAgICAgYShkb2N1bWVudCkudW5iaW5kKCJrZXlkb3duLmZiIik7CiAgICAgICAgICAgICAgICBlLmlzKCI6dmlzaWJsZSIpICYmICJvdXRzaWRlIiAhPT0gYy50aXRsZVBvc2l0aW9uICYmIGUuY3NzKCJoZWlnaHQiLCBlLmhlaWdodCgpKTsKICAgICAgICAgICAgICAgIGsgPSBxOwogICAgICAgICAgICAgICAgciA9IHM7CiAgICAgICAgICAgICAgICBjID0gZDsKICAgICAgICAgICAgICAgIGlmIChjLm92ZXJsYXlTaG93KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHYuY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgImJhY2tncm91bmQtY29sb3IiOiBjLm92ZXJsYXlDb2xvciwKICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogYy5vdmVybGF5T3BhY2l0eSwKICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yOiBjLmhpZGVPbk92ZXJsYXlDbGljayA/ICJwb2ludGVyIiA6ICJhdXRvIiwKICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBhKGRvY3VtZW50KS5oZWlnaHQoKQogICAgICAgICAgICAgICAgICAgIH0pLCAhdi5pcygiOnZpc2libGUiKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoSykgYSgic2VsZWN0Om5vdCgjZmFuY3lib3gtdG1wIHNlbGVjdCkiKS5maWx0ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gImhpZGRlbiIgIT09IHRoaXMuc3R5bGUudmlzaWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICB9KS5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJpbGl0eTogImhpZGRlbiIKICAgICAgICAgICAgICAgICAgICAgICAgfSkub25lKCJmYW5jeWJveC1jbGVhbnVwIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0eWxlLnZpc2liaWxpdHkgPSAiaW5oZXJpdCIKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHYuc2hvdygpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHYuaGlkZSgpOwogICAgICAgICAgICAgICAgYiA9IE8oKTsKICAgICAgICAgICAgICAgIHZhciBmID0ge30sIEYgPSBjLmF1dG9TY2FsZSwKICAgICAgICAgICAgICAgICAgICBuID0gMiAqIGMucGFkZGluZzsKICAgICAgICAgICAgICAgIGYud2lkdGggPSAtMSA8IGMud2lkdGgudG9TdHJpbmcoKS5pbmRleE9mKCIlIikgPyBwYXJzZUludChiWzBdICogcGFyc2VGbG9hdChjLndpZHRoKSAvIDEwMCwgMTApIDogYy53aWR0aCArIG47CiAgICAgICAgICAgICAgICBmLmhlaWdodCA9IC0xIDwgYy5oZWlnaHQudG9TdHJpbmcoKS5pbmRleE9mKCIlIikgPyBwYXJzZUludChiWzFdICoKICAgICAgICAgICAgICAgICAgICBwYXJzZUZsb2F0KGMuaGVpZ2h0KSAvIDEwMCwgMTApIDogYy5oZWlnaHQgKyBuOwogICAgICAgICAgICAgICAgaWYgKEYgJiYgKGYud2lkdGggPiBiWzBdIHx8IGYuaGVpZ2h0ID4gYlsxXSkpICJpbWFnZSIgPT0gZC50eXBlIHx8ICJzd2YiID09IGQudHlwZSA/IChGID0gYy53aWR0aCAvIGMuaGVpZ2h0LCBmLndpZHRoID4gYlswXSAmJiAoZi53aWR0aCA9IGJbMF0sIGYuaGVpZ2h0ID0gcGFyc2VJbnQoKGYud2lkdGggLSBuKSAvIEYgKyBuLCAxMCkpLCBmLmhlaWdodCA+IGJbMV0gJiYgKGYuaGVpZ2h0ID0gYlsxXSwgZi53aWR0aCA9IHBhcnNlSW50KChmLmhlaWdodCAtIG4pICogRiArIG4sIDEwKSkpIDogKGYud2lkdGggPSBNYXRoLm1pbihmLndpZHRoLCBiWzBdKSwgZi5oZWlnaHQgPSBNYXRoLm1pbihmLmhlaWdodCwgYlsxXSkpOwogICAgICAgICAgICAgICAgZi50b3AgPSBwYXJzZUludChNYXRoLm1heChiWzNdIC0gMjAsIGJbM10gKyAwLjUgKiAoYlsxXSAtIGYuaGVpZ2h0IC0gNDApKSwgMTApOwogICAgICAgICAgICAgICAgZi5sZWZ0ID0gcGFyc2VJbnQoTWF0aC5tYXgoYlsyXSAtIDIwLCBiWzJdICsgMC41ICogKGJbMF0gLSBmLndpZHRoIC0gNDApKSwgMTApOwogICAgICAgICAgICAgICAgZyA9IGY7CiAgICAgICAgICAgICAgICB3ID0gYy50aXRsZSB8fCAiIjsKICAgICAgICAgICAgICAgIHggPSAwOwogICAgICAgICAgICAgICAgai5lbXB0eSgpLnJlbW92ZUF0dHIoInN0eWxlIikucmVtb3ZlQ2xhc3MoKTsKICAgICAgICAgICAgICAgIGlmICghMSAhPT0gYy50aXRsZVNob3cgJiYgKHcgPSBhLmlzRnVuY3Rpb24oYy50aXRsZUZvcm1hdCkgPyBjLnRpdGxlRm9ybWF0KHcsIGssIHIsIGMpIDogdyAmJiB3Lmxlbmd0aCA/ICJmbG9hdCIgPT0gYy50aXRsZVBvc2l0aW9uID8gJzx0YWJsZSBpZD0iZmFuY3lib3gtdGl0bGUtZmxvYXQtd3JhcCIgY2VsbHBhZGRpbmc9IjAiIGNlbGxzcGFjaW5nPSIwIj48dHI+PHRkIGlkPSJmYW5jeWJveC10aXRsZS1mbG9hdC1sZWZ0Ij48L3RkPjx0ZCBpZD0iZmFuY3lib3gtdGl0bGUtZmxvYXQtbWFpbiI+JyArIHcgKyAnPC90ZD48dGQgaWQ9ImZhbmN5Ym94LXRpdGxlLWZsb2F0LXJpZ2h0Ij48L3RkPjwvdHI+PC90YWJsZT4nIDogJzxkaXYgaWQ9ImZhbmN5Ym94LXRpdGxlLScgKyBjLnRpdGxlUG9zaXRpb24gKyAnIj4nICsgdyArICI8L2Rpdj4iIDogITEpICYmICIiICE9PSB3KSBzd2l0Y2ggKGouYWRkQ2xhc3MoImZhbmN5Ym94LXRpdGxlLSIgKyBjLnRpdGxlUG9zaXRpb24pLmh0bWwodykuYXBwZW5kVG8oImJvZHkiKS5zaG93KCksIGMudGl0bGVQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgIGNhc2UgImluc2lkZSI6CiAgICAgICAgICAgICAgICAgICAgICAgIGouY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBnLndpZHRoIC0gMiAqIGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpbkxlZnQ6IGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpblJpZ2h0OiBjLnBhZGRpbmcKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHggPSBqLm91dGVySGVpZ2h0KCEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgai5hcHBlbmRUbyhCKTsKICAgICAgICAgICAgICAgICAgICAgICAgZy5oZWlnaHQgKz0geDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAib3ZlciI6CiAgICAgICAgICAgICAgICAgICAgICAgIGouY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpbkxlZnQ6IGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBnLndpZHRoIC0gMiAqIGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvdHRvbTogYy5wYWRkaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIH0pLmFwcGVuZFRvKEIpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJmbG9hdCI6CiAgICAgICAgICAgICAgICAgICAgICAgIGouY3NzKCJsZWZ0IiwgLTEgKiBwYXJzZUludCgoai53aWR0aCgpIC0gZy53aWR0aCAtIDQwKSAvIDIsIDEwKSkuYXBwZW5kVG8oZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGouY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBnLndpZHRoIC0gMiAqIGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmdMZWZ0OiBjLnBhZGRpbmcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nUmlnaHQ6IGMucGFkZGluZwogICAgICAgICAgICAgICAgICAgICAgICB9KS5hcHBlbmRUbyhlKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgai5oaWRlKCk7CiAgICAgICAgICAgICAgICBlLmlzKCI6dmlzaWJsZSIpID8gKGEoQy5hZGQoeSkuYWRkKHopKS5oaWRlKCksIGIgPSBlLnBvc2l0aW9uKCksIHQgPSB7CiAgICAgICAgICAgICAgICAgICAgdG9wOiBiLnRvcCwKICAgICAgICAgICAgICAgICAgICBsZWZ0OiBiLmxlZnQsCiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGUud2lkdGgoKSwKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IGUuaGVpZ2h0KCkKICAgICAgICAgICAgICAgIH0sIGggPSB0LndpZHRoID09IGcud2lkdGggJiYgdC5oZWlnaHQgPT0gZy5oZWlnaHQsIG0uZmFkZVRvKGMuY2hhbmdlRmFkZSwgMC4zLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBtLmh0bWwocC5jb250ZW50cygpKS5mYWRlVG8oYy5jaGFuZ2VGYWRlLCAxLCBQKQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgYS5ldmVudC50cmlnZ2VyKCJmYW5jeWJveC1jaGFuZ2UiKTsKICAgICAgICAgICAgICAgICAgICBtLmVtcHR5KCkucmVtb3ZlQXR0cigiZmlsdGVyIikuY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgImJvcmRlci13aWR0aCI6IGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGcud2lkdGggLSAyICogYy5wYWRkaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IGQuYXV0b0RpbWVuc2lvbnMgPyAiYXV0byIgOiBnLmhlaWdodCAtIHggLSAyICogYy5wYWRkaW5nCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaCA/IGIoKSA6IChBLnByb3AgPSAwLCBhKEEpLmFuaW1hdGUoewogICAgICAgICAgICAgICAgICAgICAgICBwcm9wOiAxCiAgICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogYy5jaGFuZ2VTcGVlZCwKICAgICAgICAgICAgICAgICAgICAgICAgZWFzaW5nOiBjLmVhc2luZ0NoYW5nZSwKICAgICAgICAgICAgICAgICAgICAgICAgc3RlcDogUSwKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6IGIKICAgICAgICAgICAgICAgICAgICB9KSkKICAgICAgICAgICAgICAgIH0pKSA6IChlLnJlbW92ZUF0dHIoInN0eWxlIiksIG0uY3NzKCJib3JkZXItd2lkdGgiLCBjLnBhZGRpbmcpLCAiZWxhc3RpYyIgPT0KICAgICAgICAgICAgICAgICAgICBjLnRyYW5zaXRpb25JbiA/ICh0ID0gUigpLCBtLmh0bWwocC5jb250ZW50cygpKSwgZS5zaG93KCksIGMub3BhY2l0eSAmJiAoZy5vcGFjaXR5ID0gMCksIEEucHJvcCA9IDAsIGEoQSkuYW5pbWF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb3A6IDEKICAgICAgICAgICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBjLnNwZWVkSW4sCiAgICAgICAgICAgICAgICAgICAgICAgIGVhc2luZzogYy5lYXNpbmdJbiwKICAgICAgICAgICAgICAgICAgICAgICAgc3RlcDogUSwKICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6IFAKICAgICAgICAgICAgICAgICAgICB9KSkgOiAoImluc2lkZSIgPT0gYy50aXRsZVBvc2l0aW9uICYmIDAgPCB4ICYmIGouc2hvdygpLCBtLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiBnLndpZHRoIC0gMiAqIGMucGFkZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBkLmF1dG9EaW1lbnNpb25zID8gImF1dG8iIDogZy5oZWlnaHQgLSB4IC0gMiAqIGMucGFkZGluZwogICAgICAgICAgICAgICAgICAgIH0pLmh0bWwocC5jb250ZW50cygpKSwgZS5jc3MoZykuZmFkZUluKCJub25lIiA9PSBjLnRyYW5zaXRpb25JbiA/IDAgOiBjLnNwZWVkSW4sIFApKSkKICAgICAgICAgICAgfQogICAgICAgIH0sIFAgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgYS5zdXBwb3J0Lm9wYWNpdHkgfHwgKG0uZ2V0KDApLnN0eWxlLnJlbW92ZUF0dHJpYnV0ZSgiZmlsdGVyIiksIGUuZ2V0KDApLnN0eWxlLnJlbW92ZUF0dHJpYnV0ZSgiZmlsdGVyIikpOwogICAgICAgICAgICBkLmF1dG9EaW1lbnNpb25zICYmCiAgICAgICAgICAgICAgICBtLmNzcygiaGVpZ2h0IiwgImF1dG8iKTsKICAgICAgICAgICAgZS5jc3MoImhlaWdodCIsICJhdXRvIik7CiAgICAgICAgICAgIHcgJiYgdy5sZW5ndGggJiYgai5zaG93KCk7CiAgICAgICAgICAgIGMuc2hvd0Nsb3NlQnV0dG9uICYmIEMuc2hvdygpOwogICAgICAgICAgICAoYy5lbmFibGVFc2NhcGVCdXR0b24gfHwgYy5lbmFibGVLZXlib2FyZE5hdikgJiYgYShkb2N1bWVudCkuYmluZCgia2V5ZG93bi5mYiIsIGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgICAgIGlmICgyNyA9PSBiLmtleUNvZGUgJiYgYy5lbmFibGVFc2NhcGVCdXR0b24pIGIucHJldmVudERlZmF1bHQoKSwgYS5mYW5jeWJveC5jbG9zZSgpOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoKDM3ID09IGIua2V5Q29kZSB8fCAzOSA9PSBiLmtleUNvZGUpICYmIGMuZW5hYmxlS2V5Ym9hcmROYXYgJiYgIklOUFVUIiAhPT0gYi50YXJnZXQudGFnTmFtZSAmJiAiVEVYVEFSRUEiICE9PSBiLnRhcmdldC50YWdOYW1lICYmICJTRUxFQ1QiICE9PSBiLnRhcmdldC50YWdOYW1lKSBiLnByZXZlbnREZWZhdWx0KCksIGEuZmFuY3lib3hbMzcgPT0gYi5rZXlDb2RlID8gInByZXYiIDogIm5leHQiXSgpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjLnNob3dOYXZBcnJvd3MgPyAoKGMuY3ljbGljICYmIDEgPAogICAgICAgICAgICAgICAgay5sZW5ndGggfHwgMCAhPT0gcikgJiYgeS5zaG93KCksIChjLmN5Y2xpYyAmJiAxIDwgay5sZW5ndGggfHwgciAhPSBrLmxlbmd0aCAtIDEpICYmIHouc2hvdygpKSA6ICh5LmhpZGUoKSwgei5oaWRlKCkpOwogICAgICAgICAgICBjLmhpZGVPbkNvbnRlbnRDbGljayAmJiBtLmJpbmQoImNsaWNrIiwgYS5mYW5jeWJveC5jbG9zZSk7CiAgICAgICAgICAgIGMuaGlkZU9uT3ZlcmxheUNsaWNrICYmIHYuYmluZCgiY2xpY2siLCBhLmZhbmN5Ym94LmNsb3NlKTsKICAgICAgICAgICAgYSh3aW5kb3cpLmJpbmQoInJlc2l6ZS5mYiIsIGEuZmFuY3lib3gucmVzaXplKTsKICAgICAgICAgICAgYy5jZW50ZXJPblNjcm9sbCAmJiBhKHdpbmRvdykuYmluZCgic2Nyb2xsLmZiIiwgYS5mYW5jeWJveC5jZW50ZXIpOwogICAgICAgICAgICAiaWZyYW1lIiA9PSBjLnR5cGUgJiYgYSgnPGlmcmFtZSBpZD0iZmFuY3lib3gtZnJhbWUiIG5hbWU9ImZhbmN5Ym94LWZyYW1lJyArIChuZXcgRGF0ZSkuZ2V0VGltZSgpICsgJyIgZnJhbWVib3JkZXI9IjAiIGhzcGFjZT0iMCIgJyArIChuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKC9tc2llIFs2XS9pKSA/ICdhbGxvd3RyYW5zcGFyZW5jeT0idHJ1ZSIiJyA6CiAgICAgICAgICAgICAgICAiIikgKyAnIHNjcm9sbGluZz0iJyArIGQuc2Nyb2xsaW5nICsgJyIgc3JjPSInICsgYy5ocmVmICsgJyI+PC9pZnJhbWU+JykuYXBwZW5kVG8obSk7CiAgICAgICAgICAgIGUuc2hvdygpOwogICAgICAgICAgICBsID0gITE7CiAgICAgICAgICAgIGEuZmFuY3lib3guY2VudGVyKCk7CiAgICAgICAgICAgIGMub25Db21wbGV0ZShrLCByLCBjKTsKICAgICAgICAgICAgdmFyIGIsIGg7CiAgICAgICAgICAgIGsubGVuZ3RoIC0gMSA+IHIgJiYgKGIgPSBrW3IgKyAxXS5ocmVmLCAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIGIgJiYgYi5tYXRjaChIKSAmJiAoaCA9IG5ldyBJbWFnZSwgaC5zcmMgPSBiKSk7CiAgICAgICAgICAgIDAgPCByICYmIChiID0ga1tyIC0gMV0uaHJlZiwgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBiICYmIGIubWF0Y2goSCkgJiYgKGggPSBuZXcgSW1hZ2UsIGguc3JjID0gYikpCiAgICAgICAgfSwgUSA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICAgICAgdmFyIGEgPSB7CiAgICAgICAgICAgICAgICB3aWR0aDogcGFyc2VJbnQodC53aWR0aCArIChnLndpZHRoIC0gdC53aWR0aCkgKiBiLCAxMCksCiAgICAgICAgICAgICAgICBoZWlnaHQ6IHBhcnNlSW50KHQuaGVpZ2h0ICsgKGcuaGVpZ2h0IC0gdC5oZWlnaHQpICogYiwgMTApLAogICAgICAgICAgICAgICAgdG9wOiBwYXJzZUludCh0LnRvcCArIChnLnRvcCAtIHQudG9wKSAqIGIsIDEwKSwKICAgICAgICAgICAgICAgIGxlZnQ6IHBhcnNlSW50KHQubGVmdCArIChnLmxlZnQgLSB0LmxlZnQpICogYiwKICAgICAgICAgICAgICAgICAgICAxMCkKICAgICAgICAgICAgfTsKICAgICAgICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBnLm9wYWNpdHkgJiYgKGEub3BhY2l0eSA9IDAuNSA+IGIgPyAwLjUgOiBiKTsKICAgICAgICAgICAgZS5jc3MoYSk7CiAgICAgICAgICAgIG0uY3NzKHsKICAgICAgICAgICAgICAgIHdpZHRoOiBhLndpZHRoIC0gMiAqIGMucGFkZGluZywKICAgICAgICAgICAgICAgIGhlaWdodDogYS5oZWlnaHQgLSB4ICogYiAtIDIgKiBjLnBhZGRpbmcKICAgICAgICAgICAgfSkKICAgICAgICB9LCBPID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBbYSh3aW5kb3cpLndpZHRoKCkgLSAyICogYy5tYXJnaW4sIGEod2luZG93KS5oZWlnaHQoKSAtIDIgKiBjLm1hcmdpbiwgYShkb2N1bWVudCkuc2Nyb2xsTGVmdCgpICsgYy5tYXJnaW4sIGEoZG9jdW1lbnQpLnNjcm9sbFRvcCgpICsgYy5tYXJnaW5dCiAgICAgICAgfSwgUiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgYiA9IGQub3JpZyA/IGEoZC5vcmlnKSA6ICExLAogICAgICAgICAgICAgICAgaCA9IHt9OwogICAgICAgICAgICBiICYmIGIubGVuZ3RoID8gKGggPSBiLm9mZnNldCgpLCBoLnRvcCArPSBwYXJzZUludChiLmNzcygicGFkZGluZ1RvcCIpLCAxMCkgfHwgMCwgaC5sZWZ0ICs9IHBhcnNlSW50KGIuY3NzKCJwYWRkaW5nTGVmdCIpLCAxMCkgfHwgMCwgaC50b3AgKz0gcGFyc2VJbnQoYi5jc3MoImJvcmRlci10b3Atd2lkdGgiKSwgMTApIHx8IDAsIGgubGVmdCArPQogICAgICAgICAgICAgICAgcGFyc2VJbnQoYi5jc3MoImJvcmRlci1sZWZ0LXdpZHRoIiksIDEwKSB8fCAwLCBoLndpZHRoID0gYi53aWR0aCgpLCBoLmhlaWdodCA9IGIuaGVpZ2h0KCksIGggPSB7CiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGgud2lkdGggKyAyICogYy5wYWRkaW5nLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogaC5oZWlnaHQgKyAyICogYy5wYWRkaW5nLAogICAgICAgICAgICAgICAgICAgIHRvcDogaC50b3AgLSBjLnBhZGRpbmcgLSAyMCwKICAgICAgICAgICAgICAgICAgICBsZWZ0OiBoLmxlZnQgLSBjLnBhZGRpbmcgLSAyMAogICAgICAgICAgICAgICAgfSkgOiAoYiA9IE8oKSwgaCA9IHsKICAgICAgICAgICAgICAgIHdpZHRoOiAyICogYy5wYWRkaW5nLAogICAgICAgICAgICAgICAgaGVpZ2h0OiAyICogYy5wYWRkaW5nLAogICAgICAgICAgICAgICAgdG9wOiBwYXJzZUludChiWzNdICsgMC41ICogYlsxXSwgMTApLAogICAgICAgICAgICAgICAgbGVmdDogcGFyc2VJbnQoYlsyXSArIDAuNSAqIGJbMF0sIDEwKQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGgKICAgICAgICB9LCBUID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHUuaXMoIjp2aXNpYmxlIikgPyAoYSgiZGl2IiwgdSkuY3NzKCJ0b3AiLCAtNDAgKiBKICsgInB4IiksIEogPSAoSiArIDEpICUgMTIpIDogY2xlYXJJbnRlcnZhbChJKQogICAgICAgIH07CiAgICBhLmZuLmZhbmN5Ym94ID0gZnVuY3Rpb24oYikgewogICAgICAgIGlmICghYSh0aGlzKS5sZW5ndGgpIHJldHVybiB0aGlzOwogICAgICAgIGEodGhpcykuZGF0YSgiZmFuY3lib3giLCBhLmV4dGVuZCh7fSwgYiwgYS5tZXRhZGF0YSA/CiAgICAgICAgICAgIGEodGhpcykubWV0YWRhdGEoKSA6IHt9KSkudW5iaW5kKCJjbGljay5mYiIpLmJpbmQoImNsaWNrLmZiIiwgZnVuY3Rpb24oYikgewogICAgICAgICAgICBiLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGwgfHwgKGwgPSAhMCwgYSh0aGlzKS5ibHVyKCksIHEgPSBbXSwgcyA9IDAsIGIgPSBhKHRoaXMpLmF0dHIoInJlbCIpIHx8ICIiLCAhYiB8fCAiIiA9PSBiIHx8ICJub2ZvbGxvdyIgPT09IGIgPyBxLnB1c2godGhpcykgOiAocSA9IGEoImFbcmVsPSIgKyBiICsgIl0sIGFyZWFbcmVsPSIgKyBiICsgIl0sIGltZ1tyZWw9IiArIGIgKyAiXSIpLCBzID0gcS5pbmRleCh0aGlzKSksIEcoKSkKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGhpcwogICAgfTsKICAgIGEuZmFuY3lib3ggPSBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgdmFyIGQ7CiAgICAgICAgaWYgKCFsKSB7CiAgICAgICAgICAgIGwgPSAhMDsKICAgICAgICAgICAgZCA9ICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgYyA/IGMgOiB7fTsKICAgICAgICAgICAgcSA9IFtdOwogICAgICAgICAgICBzID0gcGFyc2VJbnQoZC5pbmRleCwgMTApIHx8IDA7CiAgICAgICAgICAgIGlmIChhLmlzQXJyYXkoYikpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGUgPSAwLCBnID0gYi5sZW5ndGg7IGUgPCBnOyBlKyspICJvYmplY3QiID09IHR5cGVvZiBiW2VdID8gYShiW2VdKS5kYXRhKCJmYW5jeWJveCIsIGEuZXh0ZW5kKHt9LCBkLCBiW2VdKSkgOiBiW2VdID0KICAgICAgICAgICAgICAgICAgICBhKHt9KS5kYXRhKCJmYW5jeWJveCIsIGEuZXh0ZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudDogYltlXQogICAgICAgICAgICAgICAgICAgIH0sIGQpKTsKICAgICAgICAgICAgICAgIHEgPSBqUXVlcnkubWVyZ2UocSwgYikKICAgICAgICAgICAgfSBlbHNlICJvYmplY3QiID09IHR5cGVvZiBiID8gYShiKS5kYXRhKCJmYW5jeWJveCIsIGEuZXh0ZW5kKHt9LCBkLCBiKSkgOiBiID0gYSh7fSkuZGF0YSgiZmFuY3lib3giLCBhLmV4dGVuZCh7CiAgICAgICAgICAgICAgICBjb250ZW50OiBiCiAgICAgICAgICAgIH0sIGQpKSwgcS5wdXNoKGIpOyBpZiAocyA+IHEubGVuZ3RoIHx8IDAgPiBzKSBzID0gMDsKICAgICAgICAgICAgRygpCiAgICAgICAgfQogICAgfTsKICAgIGEuZmFuY3lib3guc2hvd0FjdGl2aXR5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY2xlYXJJbnRlcnZhbChJKTsKICAgICAgICB1LnNob3coKTsKICAgICAgICBJID0gc2V0SW50ZXJ2YWwoVCwgNjYpCiAgICB9OwogICAgYS5mYW5jeWJveC5oaWRlQWN0aXZpdHkgPSBmdW5jdGlvbigpIHsKICAgICAgICB1LmhpZGUoKQogICAgfTsKICAgIGEuZmFuY3lib3gubmV4dCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBhLmZhbmN5Ym94LnBvcyhyICsgMSkKICAgIH07CiAgICBhLmZhbmN5Ym94LnByZXYgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gYS5mYW5jeWJveC5wb3MociAtIDEpCiAgICB9OwogICAgYS5mYW5jeWJveC5wb3MgPSBmdW5jdGlvbihiKSB7CiAgICAgICAgbCB8fCAoYiA9IHBhcnNlSW50KGIpLAogICAgICAgICAgICBxID0gaywgLTEgPCBiICYmIGIgPCBrLmxlbmd0aCA/IChzID0gYiwgRygpKSA6IGMuY3ljbGljICYmIDEgPCBrLmxlbmd0aCAmJiAocyA9IGIgPj0gay5sZW5ndGggPyAwIDogay5sZW5ndGggLSAxLCBHKCkpKQogICAgfTsKICAgIGEuZmFuY3lib3guY2FuY2VsID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbCB8fCAobCA9ICEwLCBhLmV2ZW50LnRyaWdnZXIoImZhbmN5Ym94LWNhbmNlbCIpLCBMKCksIGQub25DYW5jZWwocSwgcywgZCksIGwgPSAhMSkKICAgIH07CiAgICBhLmZhbmN5Ym94LmNsb3NlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZnVuY3Rpb24gYigpIHsKICAgICAgICAgICAgdi5mYWRlT3V0KCJmYXN0Iik7CiAgICAgICAgICAgIGouZW1wdHkoKS5oaWRlKCk7CiAgICAgICAgICAgIGUuaGlkZSgpOwogICAgICAgICAgICBhLmV2ZW50LnRyaWdnZXIoImZhbmN5Ym94LWNsZWFudXAiKTsKICAgICAgICAgICAgbS5lbXB0eSgpOwogICAgICAgICAgICBjLm9uQ2xvc2VkKGssIHIsIGMpOwogICAgICAgICAgICBrID0gZCA9IFtdOwogICAgICAgICAgICByID0gcyA9IDA7CiAgICAgICAgICAgIGMgPSBkID0ge307CiAgICAgICAgICAgIGwgPSAhMQogICAgICAgIH0KICAgICAgICBpZiAoIWwgJiYgIWUuaXMoIjpoaWRkZW4iKSkKICAgICAgICAgICAgaWYgKGwgPSAhMCwgYyAmJiAhMSA9PT0gYy5vbkNsZWFudXAoaywgciwgYykpIGwgPSAhMTsKICAgICAgICAgICAgZWxzZQogICAgICAgIGlmIChMKCksIGEoQy5hZGQoeSkuYWRkKHopKS5oaWRlKCksIGEobS5hZGQodikpLnVuYmluZCgpLCBhKHdpbmRvdykudW5iaW5kKCJyZXNpemUuZmIgc2Nyb2xsLmZiIiksCiAgICAgICAgICAgIGEoZG9jdW1lbnQpLnVuYmluZCgia2V5ZG93bi5mYiIpLCBtLmZpbmQoImlmcmFtZSIpLmF0dHIoInNyYyIsIEsgJiYgL15odHRwcy9pLnRlc3Qod2luZG93LmxvY2F0aW9uLmhyZWYgfHwgIiIpID8gImphdmFzY3JpcHQ6dm9pZChmYWxzZSkiIDogImFib3V0OmJsYW5rIiksICJpbnNpZGUiICE9PSBjLnRpdGxlUG9zaXRpb24gJiYgai5lbXB0eSgpLCBlLnN0b3AoKSwgImVsYXN0aWMiID09IGMudHJhbnNpdGlvbk91dCkgewogICAgICAgICAgICB0ID0gUigpOwogICAgICAgICAgICB2YXIgaCA9IGUucG9zaXRpb24oKTsKICAgICAgICAgICAgZyA9IHsKICAgICAgICAgICAgICAgIHRvcDogaC50b3AsCiAgICAgICAgICAgICAgICBsZWZ0OiBoLmxlZnQsCiAgICAgICAgICAgICAgICB3aWR0aDogZS53aWR0aCgpLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBlLmhlaWdodCgpCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGMub3BhY2l0eSAmJiAoZy5vcGFjaXR5ID0gMSk7CiAgICAgICAgICAgIGouZW1wdHkoKS5oaWRlKCk7CiAgICAgICAgICAgIEEucHJvcCA9IDE7CiAgICAgICAgICAgIGEoQSkuYW5pbWF0ZSh7CiAgICAgICAgICAgICAgICBwcm9wOiAwCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBjLnNwZWVkT3V0LAogICAgICAgICAgICAgICAgZWFzaW5nOiBjLmVhc2luZ091dCwKICAgICAgICAgICAgICAgIHN0ZXA6IFEsCiAgICAgICAgICAgICAgICBjb21wbGV0ZTogYgogICAgICAgICAgICB9KQogICAgICAgIH0gZWxzZSBlLmZhZGVPdXQoIm5vbmUiID09IGMudHJhbnNpdGlvbk91dCA/IDAgOiBjLnNwZWVkT3V0LCBiKQogICAgfTsKICAgIGEuZmFuY3lib3gucmVzaXplID0KICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdi5pcygiOnZpc2libGUiKSAmJiB2LmNzcygiaGVpZ2h0IiwgYShkb2N1bWVudCkuaGVpZ2h0KCkpOwogICAgICAgICAgICBhLmZhbmN5Ym94LmNlbnRlcighMCkKICAgIH07CiAgICBhLmZhbmN5Ym94LmNlbnRlciA9IGZ1bmN0aW9uKGIpIHsKICAgICAgICB2YXIgYSwgZDsKICAgICAgICBpZiAoIWwgJiYgKGQgPSAhMCA9PT0gYiA/IDEgOiAwLCBhID0gTygpLCBkIHx8ICEoZS53aWR0aCgpID4gYVswXSB8fCBlLmhlaWdodCgpID4gYVsxXSkpKSBlLnN0b3AoKS5hbmltYXRlKHsKICAgICAgICAgICAgdG9wOiBwYXJzZUludChNYXRoLm1heChhWzNdIC0gMjAsIGFbM10gKyAwLjUgKiAoYVsxXSAtIG0uaGVpZ2h0KCkgLSA0MCkgLSBjLnBhZGRpbmcpKSwKICAgICAgICAgICAgbGVmdDogcGFyc2VJbnQoTWF0aC5tYXgoYVsyXSAtIDIwLCBhWzJdICsgMC41ICogKGFbMF0gLSBtLndpZHRoKCkgLSA0MCkgLSBjLnBhZGRpbmcpKQogICAgICAgIH0sICJudW1iZXIiID09IHR5cGVvZiBiID8gYiA6IDIwMCkKICAgIH07CiAgICBhLmZhbmN5Ym94LmluaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICBhKCIjZmFuY3lib3gtd3JhcCIpLmxlbmd0aCB8fCAoYSgiYm9keSIpLmFwcGVuZChwID0gYSgnPGRpdiBpZD0iZmFuY3lib3gtdG1wIj48L2Rpdj4nKSwgdSA9IGEoJzxkaXYgaWQ9ImZhbmN5Ym94LWxvYWRpbmciPjxkaXY+PC9kaXY+PC9kaXY+JyksCiAgICAgICAgICAgICAgICB2ID0gYSgnPGRpdiBpZD0iZmFuY3lib3gtb3ZlcmxheSI+PC9kaXY+JyksIGUgPSBhKCc8ZGl2IGlkPSJmYW5jeWJveC13cmFwIj48L2Rpdj4nKSksIEIgPSBhKCc8ZGl2IGlkPSJmYW5jeWJveC1vdXRlciI+PC9kaXY+JykuYXBwZW5kKCc8ZGl2IGNsYXNzPSJmYW5jeWJveC1iZyIgaWQ9ImZhbmN5Ym94LWJnLW4iPjwvZGl2PjxkaXYgY2xhc3M9ImZhbmN5Ym94LWJnIiBpZD0iZmFuY3lib3gtYmctbmUiPjwvZGl2PjxkaXYgY2xhc3M9ImZhbmN5Ym94LWJnIiBpZD0iZmFuY3lib3gtYmctZSI+PC9kaXY+PGRpdiBjbGFzcz0iZmFuY3lib3gtYmciIGlkPSJmYW5jeWJveC1iZy1zZSI+PC9kaXY+PGRpdiBjbGFzcz0iZmFuY3lib3gtYmciIGlkPSJmYW5jeWJveC1iZy1zIj48L2Rpdj48ZGl2IGNsYXNzPSJmYW5jeWJveC1iZyIgaWQ9ImZhbmN5Ym94LWJnLXN3Ij48L2Rpdj48ZGl2IGNsYXNzPSJmYW5jeWJveC1iZyIgaWQ9ImZhbmN5Ym94LWJnLXciPjwvZGl2PjxkaXYgY2xhc3M9ImZhbmN5Ym94LWJnIiBpZD0iZmFuY3lib3gtYmctbnciPjwvZGl2PicpLmFwcGVuZFRvKGUpLAogICAgICAgICAgICBCLmFwcGVuZChtID0gYSgnPGRpdiBpZD0iZmFuY3lib3gtY29udGVudCI+PC9kaXY+JyksIEMgPSBhKCc8YSBpZD0iZmFuY3lib3gtY2xvc2UiPjwvYT4nKSwgaiA9IGEoJzxkaXYgaWQ9ImZhbmN5Ym94LXRpdGxlIj48L2Rpdj4nKSwgeSA9IGEoJzxhIGhyZWY9ImphdmFzY3JpcHQ6OyIgaWQ9ImZhbmN5Ym94LWxlZnQiPjxzcGFuIGNsYXNzPSJmYW5jeS1pY28iIGlkPSJmYW5jeWJveC1sZWZ0LWljbyI+PC9zcGFuPjwvYT4nKSwgeiA9IGEoJzxhIGhyZWY9ImphdmFzY3JpcHQ6OyIgaWQ9ImZhbmN5Ym94LXJpZ2h0Ij48c3BhbiBjbGFzcz0iZmFuY3ktaWNvIiBpZD0iZmFuY3lib3gtcmlnaHQtaWNvIj48L3NwYW4+PC9hPicpKSwgQy5jbGljayhhLmZhbmN5Ym94LmNsb3NlKSwgdS5jbGljayhhLmZhbmN5Ym94LmNhbmNlbCksIHkuY2xpY2soZnVuY3Rpb24oYikgewogICAgICAgICAgICAgICAgYi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgYS5mYW5jeWJveC5wcmV2KCkKICAgICAgICAgICAgfSksIHouY2xpY2soZnVuY3Rpb24oYikgewogICAgICAgICAgICAgICAgYi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgYS5mYW5jeWJveC5uZXh0KCkKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIGEuZm4ubW91c2V3aGVlbCAmJiBlLmJpbmQoIm1vdXNld2hlZWwuZmIiLCBmdW5jdGlvbihiLCBjKSB7CiAgICAgICAgICAgICAgICBpZiAobCkgYi5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgZWxzZSBpZiAoMCA9PSBhKGIudGFyZ2V0KS5nZXQoMCkuY2xpZW50SGVpZ2h0IHx8IGEoYi50YXJnZXQpLmdldCgwKS5zY3JvbGxIZWlnaHQgPT09IGEoYi50YXJnZXQpLmdldCgwKS5jbGllbnRIZWlnaHQpIGIucHJldmVudERlZmF1bHQoKSwgYS5mYW5jeWJveFswIDwgYyA/ICJwcmV2IiA6ICJuZXh0Il0oKQogICAgICAgICAgICB9KSwgYS5zdXBwb3J0Lm9wYWNpdHkgfHwgZS5hZGRDbGFzcygiZmFuY3lib3gtaWUiKSwgSyAmJiAodS5hZGRDbGFzcygiZmFuY3lib3gtaWU2IiksIGUuYWRkQ2xhc3MoImZhbmN5Ym94LWllNiIpLCBhKCc8aWZyYW1lIGlkPSJmYW5jeWJveC1oaWRlLXNlbC1mcmFtZSIgc3JjPSInICsgKC9eaHR0cHMvaS50ZXN0KHdpbmRvdy5sb2NhdGlvbi5ocmVmIHx8ICIiKSA/ICJqYXZhc2NyaXB0OnZvaWQoZmFsc2UpIiA6ICJhYm91dDpibGFuayIpICsgJyIgc2Nyb2xsaW5nPSJubyIgYm9yZGVyPSIwIiBmcmFtZWJvcmRlcj0iMCIgdGFiaW5kZXg9Ii0xIj48L2lmcmFtZT4nKS5wcmVwZW5kVG8oQikpKQogICAgfTsKICAgIGEuZm4uZmFuY3lib3guZGVmYXVsdHMgPSB7CiAgICAgICAgcGFkZGluZzogMTAsCiAgICAgICAgbWFyZ2luOiA0MCwKICAgICAgICBvcGFjaXR5OiAhMSwKICAgICAgICBtb2RhbDogITEsCiAgICAgICAgY3ljbGljOiAhMSwKICAgICAgICBzY3JvbGxpbmc6ICJhdXRvIiwKICAgICAgICB3aWR0aDogNTYwLAogICAgICAgIGhlaWdodDogMzQwLAogICAgICAgIGF1dG9TY2FsZTogITAsCiAgICAgICAgYXV0b0RpbWVuc2lvbnM6ICEwLAogICAgICAgIGNlbnRlck9uU2Nyb2xsOiAhMSwKICAgICAgICBhamF4OiB7fSwKICAgICAgICBzd2Y6IHsKICAgICAgICAgICAgd21vZGU6ICJ0cmFuc3BhcmVudCIKICAgICAgICB9LAogICAgICAgIGhpZGVPbk92ZXJsYXlDbGljazogITAsCiAgICAgICAgaGlkZU9uQ29udGVudENsaWNrOiAhMSwKICAgICAgICBvdmVybGF5U2hvdzogITAsCiAgICAgICAgb3ZlcmxheU9wYWNpdHk6IDAuNywKICAgICAgICBvdmVybGF5Q29sb3I6ICIjNzc3IiwKICAgICAgICB0aXRsZVNob3c6ICEwLAogICAgICAgIHRpdGxlUG9zaXRpb246ICJmbG9hdCIsCiAgICAgICAgdGl0bGVGb3JtYXQ6IG51bGwsCiAgICAgICAgdGl0bGVGcm9tQWx0OiAhMSwKICAgICAgICB0cmFuc2l0aW9uSW46ICJmYWRlIiwKICAgICAgICB0cmFuc2l0aW9uT3V0OiAiZmFkZSIsCiAgICAgICAgc3BlZWRJbjogMzAwLAogICAgICAgIHNwZWVkT3V0OiAzMDAsCiAgICAgICAgY2hhbmdlU3BlZWQ6IDMwMCwKICAgICAgICBjaGFuZ2VGYWRlOiAiZmFzdCIsCiAgICAgICAgZWFzaW5nSW46ICJzd2luZyIsCiAgICAgICAgZWFzaW5nT3V0OiAic3dpbmciLAogICAgICAgIHNob3dDbG9zZUJ1dHRvbjogITAsCiAgICAgICAgc2hvd05hdkFycm93czogITAsCiAgICAgICAgZW5hYmxlRXNjYXBlQnV0dG9uOiAhMCwKICAgICAgICBlbmFibGVLZXlib2FyZE5hdjogITAsCiAgICAgICAgb25TdGFydDogZnVuY3Rpb24oKSB7fSwKICAgICAgICBvbkNhbmNlbDogZnVuY3Rpb24oKSB7fSwKICAgICAgICBvbkNvbXBsZXRlOiBmdW5jdGlvbigpIHt9LAogICAgICAgIG9uQ2xlYW51cDogZnVuY3Rpb24oKSB7fSwKICAgICAgICBvbkNsb3NlZDogZnVuY3Rpb24oKSB7fSwKICAgICAgICBvbkVycm9yOiBmdW5jdGlvbigpIHt9CiAgICB9OwogICAgYShkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgICAgICAgYS5mYW5jeWJveC5pbml0KCkKICAgIH0pCn0pKGpRdWVyeSk7CgoKLyoKICogVGlwVGlwCiAqIENvcHlyaWdodCAyMDEwIERyZXcgV2lsc29uCiAqIHd3dy5kcmV3d2lsc29uLmNvbQogKiBjb2RlLmRyZXd3aWxzb24uY29tL2VudHJ5L3RpcHRpcC1qcXVlcnktcGx1Z2luCiAqCiAqIFZlcnNpb24gMS4zICAgLSAgIFVwZGF0ZWQ6IE1hci4gMjMsIDIwMTAKICoKICogVGhpcyBQbHVnLUluIHdpbGwgY3JlYXRlIGEgY3VzdG9tIHRvb2x0aXAgdG8gcmVwbGFjZSB0aGUgZGVmYXVsdAogKiBicm93c2VyIHRvb2x0aXAuIEl0IGlzIGV4dHJlbWVseSBsaWdodHdlaWdodCBhbmQgdmVyeSBzbWFydCBpbgogKiB0aGF0IGl0IGRldGVjdHMgdGhlIGVkZ2VzIG9mIHRoZSBicm93c2VyIHdpbmRvdyBhbmQgd2lsbCBtYWtlIHN1cmUKICogdGhlIHRvb2x0aXAgc3RheXMgd2l0aGluIHRoZSBjdXJyZW50IHdpbmRvdyBzaXplLiBBcyBhIHJlc3VsdCB0aGUKICogdG9vbHRpcCB3aWxsIGFkanVzdCBpdHNlbGYgdG8gYmUgZGlzcGxheWVkIGFib3ZlLCBiZWxvdywgdG8gdGhlIGxlZnQKICogb3IgdG8gdGhlIHJpZ2h0IGRlcGVuZGluZyBvbiB3aGF0IGlzIG5lY2Vzc2FyeSB0byBzdGF5IHdpdGhpbiB0aGUKICogYnJvd3NlciB3aW5kb3cuIEl0IGlzIGNvbXBsZXRlbHkgY3VzdG9taXphYmxlIGFzIHdlbGwgdmlhIENTUy4KICoKICogVGhpcyBUaXBUaXAgalF1ZXJ5IHBsdWctaW4gaXMgZHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXM6CiAqICAgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAKICogICBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWwKICovCihmdW5jdGlvbigkKSB7CiAgICAkLmZuLnRpcFRpcCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICB2YXIgZGVmYXVsdHMgPSB7CiAgICAgICAgICAgIGFjdGl2YXRpb246ICJob3ZlciIsCiAgICAgICAgICAgIGtlZXBBbGl2ZTogZmFsc2UsCiAgICAgICAgICAgIG1heFdpZHRoOiAiMjAwcHgiLAogICAgICAgICAgICBlZGdlT2Zmc2V0OiAzLAogICAgICAgICAgICBkZWZhdWx0UG9zaXRpb246ICJib3R0b20iLAogICAgICAgICAgICBkZWxheTogNDAwLAogICAgICAgICAgICBmYWRlSW46IDIwMCwKICAgICAgICAgICAgZmFkZU91dDogMjAwLAogICAgICAgICAgICBhdHRyaWJ1dGU6ICJ0aXRsZSIsCiAgICAgICAgICAgIGNvbnRlbnQ6IGZhbHNlLAogICAgICAgICAgICBlbnRlcjogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgZXhpdDogZnVuY3Rpb24oKSB7fQogICAgICAgIH07CiAgICAgICAgdmFyIG9wdHMgPSAkLmV4dGVuZChkZWZhdWx0cywgb3B0aW9ucyk7CiAgICAgICAgaWYgKCQoIiN0aXB0aXBfaG9sZGVyIikubGVuZ3RoIDw9IDApIHsKICAgICAgICAgICAgdmFyIHRpcHRpcF9ob2xkZXIgPSAkKCc8ZGl2IGlkPSJ0aXB0aXBfaG9sZGVyIiBzdHlsZT0ibWF4LXdpZHRoOicgKyBvcHRzLm1heFdpZHRoICsgJzsiPjwvZGl2PicpOwogICAgICAgICAgICB2YXIgdGlwdGlwX2NvbnRlbnQgPSAkKCc8ZGl2IGlkPSJ0aXB0aXBfY29udGVudCI+PC9kaXY+Jyk7CiAgICAgICAgICAgIHZhciB0aXB0aXBfYXJyb3cgPSAkKCc8ZGl2IGlkPSJ0aXB0aXBfYXJyb3ciPjwvZGl2PicpOwogICAgICAgICAgICAkKCJib2R5IikuYXBwZW5kKHRpcHRpcF9ob2xkZXIuaHRtbCh0aXB0aXBfY29udGVudCkucHJlcGVuZCh0aXB0aXBfYXJyb3cuaHRtbCgnPGRpdiBpZD0idGlwdGlwX2Fycm93X2lubmVyIj48L2Rpdj4nKSkpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHRpcHRpcF9ob2xkZXIgPSAkKCIjdGlwdGlwX2hvbGRlciIpOwogICAgICAgICAgICB2YXIgdGlwdGlwX2NvbnRlbnQgPSAkKCIjdGlwdGlwX2NvbnRlbnQiKTsKICAgICAgICAgICAgdmFyIHRpcHRpcF9hcnJvdyA9ICQoIiN0aXB0aXBfYXJyb3ciKQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgb3JnX2VsZW0gPSAkKHRoaXMpOwogICAgICAgICAgICBpZiAob3B0cy5jb250ZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgb3JnX3RpdGxlID0gb3B0cy5jb250ZW50CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgb3JnX3RpdGxlID0gb3JnX2VsZW0uYXR0cihvcHRzLmF0dHJpYnV0ZSkKICAgICAgICAgICAgfSBpZiAob3JnX3RpdGxlICE9ICIiKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9wdHMuY29udGVudCkgewogICAgICAgICAgICAgICAgICAgIG9yZ19lbGVtLnJlbW92ZUF0dHIob3B0cy5hdHRyaWJ1dGUpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdGltZW91dCA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKG9wdHMuYWN0aXZhdGlvbiA9PSAiaG92ZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgb3JnX2VsZW0uaG92ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZV90aXB0aXAoKQogICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9wdHMua2VlcEFsaXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWFjdGl2ZV90aXB0aXAoKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHMua2VlcEFsaXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpcHRpcF9ob2xkZXIuaG92ZXIoZnVuY3Rpb24oKSB7fSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWFjdGl2ZV90aXB0aXAoKQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0cy5hY3RpdmF0aW9uID09ICJmb2N1cyIpIHsKICAgICAgICAgICAgICAgICAgICBvcmdfZWxlbS5mb2N1cyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlX3RpcHRpcCgpCiAgICAgICAgICAgICAgICAgICAgfSkuYmx1cihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVhY3RpdmVfdGlwdGlwKCkKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRzLmFjdGl2YXRpb24gPT0gImNsaWNrIikgewogICAgICAgICAgICAgICAgICAgIG9yZ19lbGVtLmNsaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVfdGlwdGlwKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0pLmhvdmVyKGZ1bmN0aW9uKCkge30sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9wdHMua2VlcEFsaXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWFjdGl2ZV90aXB0aXAoKQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHMua2VlcEFsaXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpcHRpcF9ob2xkZXIuaG92ZXIoZnVuY3Rpb24oKSB7fSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWFjdGl2ZV90aXB0aXAoKQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBhY3RpdmVfdGlwdGlwKCkgewogICAgICAgICAgICAgICAgICAgIG9wdHMuZW50ZXIuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgICAgICB0aXB0aXBfY29udGVudC5odG1sKG9yZ190aXRsZSk7CiAgICAgICAgICAgICAgICAgICAgdGlwdGlwX2hvbGRlci5oaWRlKCkucmVtb3ZlQXR0cigiY2xhc3MiKS5jc3MoIm1hcmdpbiIsICIwIik7CiAgICAgICAgICAgICAgICAgICAgdGlwdGlwX2Fycm93LnJlbW92ZUF0dHIoInN0eWxlIik7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRvcCA9IHBhcnNlSW50KG9yZ19lbGVtLm9mZnNldCgpWyd0b3AnXSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxlZnQgPSBwYXJzZUludChvcmdfZWxlbS5vZmZzZXQoKVsnbGVmdCddKTsKICAgICAgICAgICAgICAgICAgICB2YXIgb3JnX3dpZHRoID0gcGFyc2VJbnQob3JnX2VsZW0ub3V0ZXJXaWR0aCgpKTsKICAgICAgICAgICAgICAgICAgICB2YXIgb3JnX2hlaWdodCA9IHBhcnNlSW50KG9yZ19lbGVtLm91dGVySGVpZ2h0KCkpOwogICAgICAgICAgICAgICAgICAgIHZhciB0aXBfdyA9IHRpcHRpcF9ob2xkZXIub3V0ZXJXaWR0aCgpOwogICAgICAgICAgICAgICAgICAgIHZhciB0aXBfaCA9IHRpcHRpcF9ob2xkZXIub3V0ZXJIZWlnaHQoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgd19jb21wYXJlID0gTWF0aC5yb3VuZCgob3JnX3dpZHRoIC0gdGlwX3cpIC8gMik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhfY29tcGFyZSA9IE1hdGgucm91bmQoKG9yZ19oZWlnaHQgLSB0aXBfaCkgLyAyKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbWFyZ19sZWZ0ID0gTWF0aC5yb3VuZChsZWZ0ICsgd19jb21wYXJlKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbWFyZ190b3AgPSBNYXRoLnJvdW5kKHRvcCArIG9yZ19oZWlnaHQgKyBvcHRzLmVkZ2VPZmZzZXQpOwogICAgICAgICAgICAgICAgICAgIHZhciB0X2NsYXNzID0gIiI7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFycm93X3RvcCA9ICIiOwogICAgICAgICAgICAgICAgICAgIHZhciBhcnJvd19sZWZ0ID0gTWF0aC5yb3VuZCh0aXBfdyAtIDEyKSAvIDI7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHMuZGVmYXVsdFBvc2l0aW9uID09ICJib3R0b20iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRfY2xhc3MgPSAiX2JvdHRvbSIKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wdHMuZGVmYXVsdFBvc2l0aW9uID09ICJ0b3AiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRfY2xhc3MgPSAiX3RvcCIKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wdHMuZGVmYXVsdFBvc2l0aW9uID09ICJsZWZ0IikgewogICAgICAgICAgICAgICAgICAgICAgICB0X2NsYXNzID0gIl9sZWZ0IgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0cy5kZWZhdWx0UG9zaXRpb24gPT0gInJpZ2h0IikgewogICAgICAgICAgICAgICAgICAgICAgICB0X2NsYXNzID0gIl9yaWdodCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIHJpZ2h0X2NvbXBhcmUgPSAod19jb21wYXJlICsgbGVmdCkgPCBwYXJzZUludCgkKHdpbmRvdykuc2Nyb2xsTGVmdCgpKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbGVmdF9jb21wYXJlID0gKHRpcF93ICsgbGVmdCkgPiBwYXJzZUludCgkKHdpbmRvdykud2lkdGgoKSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKChyaWdodF9jb21wYXJlICYmIHdfY29tcGFyZSA8IDApIHx8ICh0X2NsYXNzID09ICJfcmlnaHQiICYmICFsZWZ0X2NvbXBhcmUpIHx8ICh0X2NsYXNzID09ICJfbGVmdCIgJiYgbGVmdCA8ICh0aXBfdyArIG9wdHMuZWRnZU9mZnNldCArIDUpKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0X2NsYXNzID0gIl9yaWdodCI7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycm93X3RvcCA9IE1hdGgucm91bmQodGlwX2ggLSAxMykgLyAyOwogICAgICAgICAgICAgICAgICAgICAgICBhcnJvd19sZWZ0ID0gLTEyOwogICAgICAgICAgICAgICAgICAgICAgICBtYXJnX2xlZnQgPSBNYXRoLnJvdW5kKGxlZnQgKyBvcmdfd2lkdGggKyBvcHRzLmVkZ2VPZmZzZXQpOwogICAgICAgICAgICAgICAgICAgICAgICBtYXJnX3RvcCA9IE1hdGgucm91bmQodG9wICsgaF9jb21wYXJlKQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGxlZnRfY29tcGFyZSAmJiB3X2NvbXBhcmUgPCAwKSB8fCAodF9jbGFzcyA9PSAiX2xlZnQiICYmICFyaWdodF9jb21wYXJlKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0X2NsYXNzID0gIl9sZWZ0IjsKICAgICAgICAgICAgICAgICAgICAgICAgYXJyb3dfdG9wID0gTWF0aC5yb3VuZCh0aXBfaCAtIDEzKSAvIDI7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycm93X2xlZnQgPSBNYXRoLnJvdW5kKHRpcF93KTsKICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ19sZWZ0ID0gTWF0aC5yb3VuZChsZWZ0IC0gKHRpcF93ICsgb3B0cy5lZGdlT2Zmc2V0ICsgNSkpOwogICAgICAgICAgICAgICAgICAgICAgICBtYXJnX3RvcCA9IE1hdGgucm91bmQodG9wICsgaF9jb21wYXJlKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgdG9wX2NvbXBhcmUgPSAodG9wICsgb3JnX2hlaWdodCArIG9wdHMuZWRnZU9mZnNldCArIHRpcF9oICsgOCkgPiBwYXJzZUludCgkKHdpbmRvdykuaGVpZ2h0KCkgKyAkKHdpbmRvdykuc2Nyb2xsVG9wKCkpOwogICAgICAgICAgICAgICAgICAgIHZhciBib3R0b21fY29tcGFyZSA9ICgodG9wICsgb3JnX2hlaWdodCkgLSAob3B0cy5lZGdlT2Zmc2V0ICsgdGlwX2ggKyA4KSkgPCAwOwogICAgICAgICAgICAgICAgICAgIGlmICh0b3BfY29tcGFyZSB8fCAodF9jbGFzcyA9PSAiX2JvdHRvbSIgJiYgdG9wX2NvbXBhcmUpIHx8ICh0X2NsYXNzID09ICJfdG9wIiAmJiAhYm90dG9tX2NvbXBhcmUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0X2NsYXNzID09ICJfdG9wIiB8fCB0X2NsYXNzID09ICJfYm90dG9tIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdF9jbGFzcyA9ICJfdG9wIgogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdF9jbGFzcyA9IHRfY2xhc3MgKyAiX3RvcCIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhcnJvd190b3AgPSB0aXBfaDsKICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ190b3AgPSBNYXRoLnJvdW5kKHRvcCAtICh0aXBfaCArIDUgKyBvcHRzLmVkZ2VPZmZzZXQpKQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYm90dG9tX2NvbXBhcmUgfCAodF9jbGFzcyA9PSAiX3RvcCIgJiYgYm90dG9tX2NvbXBhcmUpIHx8ICh0X2NsYXNzID09ICJfYm90dG9tIiAmJiAhdG9wX2NvbXBhcmUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0X2NsYXNzID09ICJfdG9wIiB8fCB0X2NsYXNzID09ICJfYm90dG9tIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdF9jbGFzcyA9ICJfYm90dG9tIgogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdF9jbGFzcyA9IHRfY2xhc3MgKyAiX2JvdHRvbSIKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhcnJvd190b3AgPSAtMTI7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdfdG9wID0gTWF0aC5yb3VuZCh0b3AgKyBvcmdfaGVpZ2h0ICsgb3B0cy5lZGdlT2Zmc2V0KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodF9jbGFzcyA9PSAiX3JpZ2h0X3RvcCIgfHwgdF9jbGFzcyA9PSAiX2xlZnRfdG9wIikgewogICAgICAgICAgICAgICAgICAgICAgICBtYXJnX3RvcCA9IG1hcmdfdG9wICsgNQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodF9jbGFzcyA9PSAiX3JpZ2h0X2JvdHRvbSIgfHwgdF9jbGFzcyA9PSAiX2xlZnRfYm90dG9tIikgewogICAgICAgICAgICAgICAgICAgICAgICBtYXJnX3RvcCA9IG1hcmdfdG9wIC0gNQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodF9jbGFzcyA9PSAiX2xlZnRfdG9wIiB8fCB0X2NsYXNzID09ICJfbGVmdF9ib3R0b20iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdfbGVmdCA9IG1hcmdfbGVmdCArIDUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGlwdGlwX2Fycm93LmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICJtYXJnaW4tbGVmdCI6IGFycm93X2xlZnQgKyAicHgiLAogICAgICAgICAgICAgICAgICAgICAgICAibWFyZ2luLXRvcCI6IGFycm93X3RvcCArICJweCIKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB0aXB0aXBfaG9sZGVyLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICJtYXJnaW4tbGVmdCI6IG1hcmdfbGVmdCArICJweCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJtYXJnaW4tdG9wIjogbWFyZ190b3AgKyAicHgiCiAgICAgICAgICAgICAgICAgICAgfSkuYXR0cigiY2xhc3MiLCAidGlwIiArIHRfY2xhc3MpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGlwdGlwX2hvbGRlci5zdG9wKHRydWUsIHRydWUpLmZhZGVJbihvcHRzLmZhZGVJbikKICAgICAgICAgICAgICAgICAgICB9LCBvcHRzLmRlbGF5KQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGRlYWN0aXZlX3RpcHRpcCgpIHsKICAgICAgICAgICAgICAgICAgICBvcHRzLmV4aXQuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGltZW91dCkgewogICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGlwdGlwX2hvbGRlci5mYWRlT3V0KG9wdHMuZmFkZU91dCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pCiAgICB9Cn0pKGpRdWVyeSk7CgovKiBUSU5ZIFNPUlQgKi8KKGZ1bmN0aW9uKGUpIHsKICAgIHZhciBhID0gZmFsc2UsCiAgICAgICAgZyA9IG51bGwsCiAgICAgICAgZiA9IHBhcnNlRmxvYXQsCiAgICAgICAgYiA9IC8oXGQrXC4/XGQqKSQvZzsKICAgIGUudGlueXNvcnQgPSB7CiAgICAgICAgaWQ6ICJUaW55U29ydCIsCiAgICAgICAgdmVyc2lvbjogIjEuMi4xOCIsCiAgICAgICAgY29weXJpZ2h0OiAiQ29weXJpZ2h0IChjKSAyMDA4LTIwMTIgUm9uIFZhbHN0YXIiLAogICAgICAgIHVyaTogImh0dHA6Ly90aW55c29ydC5zamVpdGkuY29tLyIsCiAgICAgICAgbGljZW5jZWQ6IHsKICAgICAgICAgICAgTUlUOiAiaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAiLAogICAgICAgICAgICBHUEw6ICJodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWwiCiAgICAgICAgfSwKICAgICAgICBkZWZhdWx0czogewogICAgICAgICAgICBvcmRlcjogImFzYyIsCiAgICAgICAgICAgIGF0dHI6IGcsCiAgICAgICAgICAgIGRhdGE6IGcsCiAgICAgICAgICAgIHVzZVZhbDogYSwKICAgICAgICAgICAgcGxhY2U6ICJzdGFydCIsCiAgICAgICAgICAgIHJldHVybnM6IGEsCiAgICAgICAgICAgIGNhc2VzOiBhLAogICAgICAgICAgICBmb3JjZVN0cmluZ3M6IGEsCiAgICAgICAgICAgIHNvcnRGdW5jdGlvbjogZwogICAgICAgIH0KICAgIH07CiAgICBlLmZuLmV4dGVuZCh7CiAgICAgICAgdGlueXNvcnQ6IGZ1bmN0aW9uKG0sIGgpIHsKICAgICAgICAgICAgaWYgKG0gJiYgdHlwZW9mKG0pICE9ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBoID0gbTsKICAgICAgICAgICAgICAgIG0gPSBnCiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG4gPSBlLmV4dGVuZCh7fSwgZS50aW55c29ydC5kZWZhdWx0cywgaCksCiAgICAgICAgICAgICAgICBzLCBCID0gdGhpcywKICAgICAgICAgICAgICAgIHggPSBlKHRoaXMpLmxlbmd0aCwKICAgICAgICAgICAgICAgIEMgPSB7fSwgcCA9ICEoIW0gfHwgbSA9PSAiIiksCiAgICAgICAgICAgICAgICBxID0gIShuLmF0dHIgPT09IGcgfHwgbi5hdHRyID09ICIiKSwKICAgICAgICAgICAgICAgIHcgPSBuLmRhdGEgIT09IGcsCiAgICAgICAgICAgICAgICBqID0gcCAmJiBtWzBdID09ICI6IiwKICAgICAgICAgICAgICAgIGsgPSBqID8gQi5maWx0ZXIobSkgOiBCLAogICAgICAgICAgICAgICAgciA9IG4uc29ydEZ1bmN0aW9uLAogICAgICAgICAgICAgICAgdiA9IG4ub3JkZXIgPT0gImFzYyIgPyAxIDogLTEsCiAgICAgICAgICAgICAgICBsID0gW107CiAgICAgICAgICAgIGlmICghcikgewogICAgICAgICAgICAgICAgciA9IG4ub3JkZXIgPT0gInJhbmQiID8gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE1hdGgucmFuZG9tKCkgPCAwLjUgPyAxIDogLTEKICAgICAgICAgICAgICAgIH0gOiBmdW5jdGlvbihGLCBFKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSAhbi5jYXNlcyA/IGQoRi5zKSA6IEYucywKICAgICAgICAgICAgICAgICAgICAgICAgSyA9ICFuLmNhc2VzID8gZChFLnMpIDogRS5zOwogICAgICAgICAgICAgICAgICAgIGlmICghbi5mb3JjZVN0cmluZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIEggPSBpLm1hdGNoKGIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgRyA9IEsubWF0Y2goYik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChIICYmIEcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBKID0gaS5zdWJzdHIoMCwgaS5sZW5ndGggLSBIWzBdLmxlbmd0aCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgSSA9IEsuc3Vic3RyKDAsIEsubGVuZ3RoIC0gR1swXS5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEogPT0gSSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSBmKEhbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEsgPSBmKEdbMF0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHYgKiAoaSA8IEsgPyAtMSA6IChpID4gSyA/IDEgOiAwKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBCLmVhY2goZnVuY3Rpb24oRywgSCkgewogICAgICAgICAgICAgICAgdmFyIEkgPSBlKEgpLAogICAgICAgICAgICAgICAgICAgIEUgPSBwID8gKGogPyBrLmZpbHRlcihIKSA6IEkuZmluZChtKSkgOiBJLAogICAgICAgICAgICAgICAgICAgIEogPSB3ID8gRS5kYXRhKG4uZGF0YSkgOiAocSA/IEUuYXR0cihuLmF0dHIpIDogKG4udXNlVmFsID8gRS52YWwoKSA6IEUudGV4dCgpKSksCiAgICAgICAgICAgICAgICAgICAgRiA9IEkucGFyZW50KCk7CiAgICAgICAgICAgICAgICBpZiAoIUNbRl0pIHsKICAgICAgICAgICAgICAgICAgICBDW0ZdID0gewogICAgICAgICAgICAgICAgICAgICAgICBzOiBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgbjogW10KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoRS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgQ1tGXS5zLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBzOiBKLAogICAgICAgICAgICAgICAgICAgICAgICBlOiBJLAogICAgICAgICAgICAgICAgICAgICAgICBuOiBHCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgQ1tGXS5uLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBlOiBJLAogICAgICAgICAgICAgICAgICAgICAgICBuOiBHCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGZvciAocyBpbiBDKSB7CiAgICAgICAgICAgICAgICBDW3NdLnMuc29ydChyKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAocyBpbiBDKSB7CiAgICAgICAgICAgICAgICB2YXIgeSA9IENbc10sCiAgICAgICAgICAgICAgICAgICAgQSA9IFtdLAogICAgICAgICAgICAgICAgICAgIEQgPSB4LAogICAgICAgICAgICAgICAgICAgIHUgPSBbMCwgMF0sCiAgICAgICAgICAgICAgICAgICAgejsKICAgICAgICAgICAgICAgIHN3aXRjaCAobi5wbGFjZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgImZpcnN0IjoKICAgICAgICAgICAgICAgICAgICAgICAgZS5lYWNoKHkucywgZnVuY3Rpb24oRSwgRikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgRCA9IE1hdGgubWluKEQsIEYubikKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgIm9yZyI6CiAgICAgICAgICAgICAgICAgICAgICAgIGUuZWFjaCh5LnMsIGZ1bmN0aW9uKEUsIEYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEEucHVzaChGLm4pCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJlbmQiOgogICAgICAgICAgICAgICAgICAgICAgICBEID0geS5uLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgRCA9IDAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAoeiA9IDA7IHogPCB4OyB6KyspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbyA9IGMoQSwgeikgPyAhYSA6IHogPj0gRCAmJiB6IDwgRCArIHkucy5sZW5ndGgsCiAgICAgICAgICAgICAgICAgICAgICAgIHQgPSAobyA/IHkucyA6IHkubilbdVtvID8gMCA6IDFdXS5lOwogICAgICAgICAgICAgICAgICAgIHQucGFyZW50KCkuYXBwZW5kKHQpOwogICAgICAgICAgICAgICAgICAgIGlmIChvIHx8ICFuLnJldHVybnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbC5wdXNoKHQuZ2V0KDApKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB1W28gPyAwIDogMV0rKwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBCLnB1c2hTdGFjayhsKQogICAgICAgIH0KICAgIH0pOwoKICAgIGZ1bmN0aW9uIGQoaCkgewogICAgICAgIHJldHVybiBoICYmIGgudG9Mb3dlckNhc2UgPyBoLnRvTG93ZXJDYXNlKCkgOiBoCiAgICB9CgogICAgZnVuY3Rpb24gYyhqLCBtKSB7CiAgICAgICAgZm9yICh2YXIgayA9IDAsIGggPSBqLmxlbmd0aDsgayA8IGg7IGsrKykgewogICAgICAgICAgICBpZiAoaltrXSA9PSBtKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIWEKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYQogICAgfQogICAgZS5mbi5UaW55U29ydCA9IGUuZm4uVGlueXNvcnQgPSBlLmZuLnRzb3J0ID0gZS5mbi50aW55c29ydAp9KShqUXVlcnkpOwoKLypnbG9iYWwgalF1ZXJ5ICovCi8qanNoaW50IG11bHRpc3RyOnRydWUgYnJvd3Nlcjp0cnVlICovCi8qIQogKiBGaXRWaWRzIDEuMAogKgogKiBDb3B5cmlnaHQgMjAxMSwgQ2hyaXMgQ295aWVyIC0gaHR0cDovL2Nzcy10cmlja3MuY29tICsgRGF2ZSBSdXBlcnQgLSBodHRwOi8vZGF2ZXJ1cGVydC5jb20KICogQ3JlZGl0IHRvIFRoaWVycnkgS29ibGVudHogLSBodHRwOi8vd3d3LmFsaXN0YXBhcnQuY29tL2FydGljbGVzL2NyZWF0aW5nLWludHJpbnNpYy1yYXRpb3MtZm9yLXZpZGVvLwogKiBSZWxlYXNlZCB1bmRlciB0aGUgV1RGUEwgbGljZW5zZSAtIGh0dHA6Ly9zYW0uem95Lm9yZy93dGZwbC8KICoKICogRGF0ZTogVGh1IFNlcHQgMDEgMTg6MDA6MDAgMjAxMSAtMDUwMAogKi8KCihmdW5jdGlvbigkKSB7CgogICAgInVzZSBzdHJpY3QiOwoKICAgICQuZm4uZml0VmlkcyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICB2YXIgc2V0dGluZ3MgPSB7CiAgICAgICAgICAgIGN1c3RvbVNlbGVjdG9yOiBudWxsCiAgICAgICAgfTsKCiAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgICAgICAgICByZWYgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYmFzZScpWzBdIHx8IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKVswXTsKCiAgICAgICAgZGl2LmNsYXNzTmFtZSA9ICdmaXQtdmlkcy1zdHlsZSc7CiAgICAgICAgZGl2LmlubmVySFRNTCA9ICcmc2h5OzxzdHlsZT4gICAgICAgICBcCiAgICAgIC5mbHVpZC13aWR0aC12aWRlby13cmFwcGVyIHsgICAgICAgIFwKICAgICAgICAgd2lkdGg6IDEwMCU7ICAgICAgICAgICAgICAgICAgICAgXAogICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7ICAgICAgICAgICAgICBcCiAgICAgICAgIHBhZGRpbmc6IDA7ICAgICAgICAgICAgICAgICAgICAgIFwKICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgIC5mbHVpZC13aWR0aC12aWRlby13cmFwcGVyIGlmcmFtZSwgIFwKICAgICAgLmZsdWlkLXdpZHRoLXZpZGVvLXdyYXBwZXIgb2JqZWN0LCAgXAogICAgICAuZmx1aWQtd2lkdGgtdmlkZW8td3JhcHBlciBlbWJlZCB7ICBcCiAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsgICAgICAgICAgICAgIFwKICAgICAgICAgdG9wOiAwOyAgICAgICAgICAgICAgICAgICAgICAgICAgXAogICAgICAgICBsZWZ0OiAwOyAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICAgICAgIHdpZHRoOiAxMDAlOyAgICAgICAgICAgICAgICAgICAgIFwKICAgICAgICAgaGVpZ2h0OiAxMDAlOyAgICAgICAgICAgICAgICAgICAgXAogICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcCiAgICA8L3N0eWxlPic7CgogICAgICAgIHJlZi5wYXJlbnROb2RlLmluc2VydEJlZm9yZShkaXYsIHJlZik7CgogICAgICAgIGlmIChvcHRpb25zKSB7CiAgICAgICAgICAgICQuZXh0ZW5kKHNldHRpbmdzLCBvcHRpb25zKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzZWxlY3RvcnMgPSBbCiAgICAgICAgICAgICAgICAiaWZyYW1lW3NyYyo9J3BsYXllci52aW1lby5jb20nXSIsCiAgICAgICAgICAgICAgICAiaWZyYW1lW3NyYyo9J3d3dy55b3V0dWJlLmNvbSddIiwKICAgICAgICAgICAgICAgICJpZnJhbWVbc3JjKj0nd3d3LmtpY2tzdGFydGVyLmNvbSddIiwKICAgICAgICAgICAgICAgICJvYmplY3QiLAogICAgICAgICAgICAgICAgImVtYmVkIgogICAgICAgICAgICBdOwoKICAgICAgICAgICAgaWYgKHNldHRpbmdzLmN1c3RvbVNlbGVjdG9yKSB7CiAgICAgICAgICAgICAgICBzZWxlY3RvcnMucHVzaChzZXR0aW5ncy5jdXN0b21TZWxlY3Rvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciAkYWxsVmlkZW9zID0gJCh0aGlzKS5maW5kKHNlbGVjdG9ycy5qb2luKCcsJykpOwoKICAgICAgICAgICAgJGFsbFZpZGVvcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyICR0aGlzID0gJCh0aGlzKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2VtYmVkJyAmJiAkdGhpcy5wYXJlbnQoJ29iamVjdCcpLmxlbmd0aCB8fCAkdGhpcy5wYXJlbnQoJy5mbHVpZC13aWR0aC12aWRlby13cmFwcGVyJykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGhlaWdodCA9ICh0aGlzLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ29iamVjdCcgfHwgKCR0aGlzLmF0dHIoJ2hlaWdodCcpICYmICFpc05hTihwYXJzZUludCgkdGhpcy5hdHRyKCdoZWlnaHQnKSwgMTApKSkpID8gcGFyc2VJbnQoJHRoaXMuYXR0cignaGVpZ2h0JyksIDEwKSA6ICR0aGlzLmhlaWdodCgpLAogICAgICAgICAgICAgICAgICAgIHdpZHRoID0gIWlzTmFOKHBhcnNlSW50KCR0aGlzLmF0dHIoJ3dpZHRoJyksIDEwKSkgPyBwYXJzZUludCgkdGhpcy5hdHRyKCd3aWR0aCcpLCAxMCkgOiAkdGhpcy53aWR0aCgpLAogICAgICAgICAgICAgICAgICAgIGFzcGVjdFJhdGlvID0gaGVpZ2h0IC8gd2lkdGg7CiAgICAgICAgICAgICAgICBpZiAoISR0aGlzLmF0dHIoJ2lkJykpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdmlkZW9JRCA9ICdmaXR2aWQnICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogOTk5OTk5KTsKICAgICAgICAgICAgICAgICAgICAkdGhpcy5hdHRyKCdpZCcsIHZpZGVvSUQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHRoaXMud3JhcCgnPGRpdiBjbGFzcz0iZmx1aWQtd2lkdGgtdmlkZW8td3JhcHBlciI+PC9kaXY+JykucGFyZW50KCcuZmx1aWQtd2lkdGgtdmlkZW8td3JhcHBlcicpLmNzcygncGFkZGluZy10b3AnLCAoYXNwZWN0UmF0aW8gKiAxMDApICsgIiUiKTsKICAgICAgICAgICAgICAgICR0aGlzLnJlbW92ZUF0dHIoJ2hlaWdodCcpLnJlbW92ZUF0dHIoJ3dpZHRoJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfTsKfSkoalF1ZXJ5KTsKCgovKioKICogQnhTbGlkZXIgdjQuMCAtIEZ1bGx5IGxvYWRlZCwgcmVzcG9uc2l2ZSBjb250ZW50IHNsaWRlcgogKiBodHRwOi8vYnhzbGlkZXIuY29tCiAqCiAqIENvcHlyaWdodCAyMDEyLCBTdGV2ZW4gV2FuZGVyc2tpIC0gaHR0cDovL3N0ZXZlbndhbmRlcnNraS5jb20gLSBodHRwOi8vYnhjcmVhdGl2ZS5jb20KICogV3JpdHRlbiB3aGlsZSBkcmlua2luZyBCZWxnaWFuIGFsZXMgYW5kIGxpc3RlbmluZyB0byBqYXp6CiAqCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBXVEZQTCBsaWNlbnNlIC0gaHR0cDovL3NhbS56b3kub3JnL3d0ZnBsLwogKi8KKGZ1bmN0aW9uKHQpIHsKICAgIHZhciBlID0ge30sIG4gPSB7CiAgICAgICAgICAgIG1vZGU6ICJob3Jpem9udGFsIiwKICAgICAgICAgICAgc2xpZGVTZWxlY3RvcjogIiIsCiAgICAgICAgICAgIGluZmluaXRlTG9vcDogITAsCiAgICAgICAgICAgIGhpZGVDb250cm9sT25FbmQ6ICExLAogICAgICAgICAgICBzcGVlZDogNTAwLAogICAgICAgICAgICBlYXNpbmc6IG51bGwsCiAgICAgICAgICAgIHNsaWRlTWFyZ2luOiAwLAogICAgICAgICAgICBzdGFydFNsaWRlOiAwLAogICAgICAgICAgICByYW5kb21TdGFydDogITEsCiAgICAgICAgICAgIGNhcHRpb25zOiAhMSwKICAgICAgICAgICAgdGlja2VyOiAhMSwKICAgICAgICAgICAgdGlja2VySG92ZXI6ICExLAogICAgICAgICAgICBhZGFwdGl2ZUhlaWdodDogITEsCiAgICAgICAgICAgIGFkYXB0aXZlSGVpZ2h0U3BlZWQ6IDUwMCwKICAgICAgICAgICAgdG91Y2hFbmFibGVkOiAhMCwKICAgICAgICAgICAgc3dpcGVUaHJlc2hvbGQ6IDUwLAogICAgICAgICAgICB2aWRlbzogITEsCiAgICAgICAgICAgIHVzZUNTUzogITAsCiAgICAgICAgICAgIHBhZ2VyOiAhMCwKICAgICAgICAgICAgcGFnZXJUeXBlOiAiZnVsbCIsCiAgICAgICAgICAgIHBhZ2VyU2hvcnRTZXBhcmF0b3I6ICIgLyAiLAogICAgICAgICAgICBwYWdlclNlbGVjdG9yOiBudWxsLAogICAgICAgICAgICBidWlsZFBhZ2VyOiBudWxsLAogICAgICAgICAgICBwYWdlckN1c3RvbTogbnVsbCwKICAgICAgICAgICAgY29udHJvbHM6ICEwLAogICAgICAgICAgICBuZXh0VGV4dDogIk5leHQiLAogICAgICAgICAgICBwcmV2VGV4dDogIlByZXYiLAogICAgICAgICAgICBuZXh0U2VsZWN0b3I6IG51bGwsCiAgICAgICAgICAgIHByZXZTZWxlY3RvcjogbnVsbCwKICAgICAgICAgICAgYXV0b0NvbnRyb2xzOiAhMSwKICAgICAgICAgICAgc3RhcnRUZXh0OiAiU3RhcnQiLAogICAgICAgICAgICBzdG9wVGV4dDogIlN0b3AiLAogICAgICAgICAgICBhdXRvQ29udHJvbHNDb21iaW5lOiAhMSwKICAgICAgICAgICAgYXV0b0NvbnRyb2xzU2VsZWN0b3I6IG51bGwsCiAgICAgICAgICAgIGF1dG86ICExLAogICAgICAgICAgICBwYXVzZTogNGUzLAogICAgICAgICAgICBhdXRvU3RhcnQ6ICEwLAogICAgICAgICAgICBhdXRvRGlyZWN0aW9uOiAibmV4dCIsCiAgICAgICAgICAgIGF1dG9Ib3ZlcjogITEsCiAgICAgICAgICAgIGF1dG9EZWxheTogMCwKICAgICAgICAgICAgbWluU2xpZGVzOiAxLAogICAgICAgICAgICBtYXhTbGlkZXM6IDEsCiAgICAgICAgICAgIG1vdmVTbGlkZXM6IDAsCiAgICAgICAgICAgIHNsaWRlV2lkdGg6IDAsCiAgICAgICAgICAgIG9uU2xpZGVyTG9hZDogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgb25TbGlkZUJlZm9yZTogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgb25TbGlkZUFmdGVyOiBmdW5jdGlvbigpIHt9LAogICAgICAgICAgICBvblNsaWRlTmV4dDogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgb25TbGlkZVByZXY6IGZ1bmN0aW9uKCkge30KICAgICAgICB9OwogICAgdC5mbi5ieFNsaWRlciA9IGZ1bmN0aW9uKHMpIHsKICAgICAgICBpZiAoMCAhPSB0aGlzLmxlbmd0aCkgewogICAgICAgICAgICBpZiAodGhpcy5sZW5ndGggPiAxKSByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdCh0aGlzKS5ieFNsaWRlcihzKQogICAgICAgICAgICB9KSwgdGhpczsKICAgICAgICAgICAgdmFyIG8gPSB7fSwgciA9IHRoaXM7CiAgICAgICAgICAgIGUuZWwgPSB0aGlzOwogICAgICAgICAgICB2YXIgYSA9IHQod2luZG93KS53aWR0aCgpLAogICAgICAgICAgICAgICAgbCA9IHQod2luZG93KS5oZWlnaHQoKSwKICAgICAgICAgICAgICAgIGQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBvLnNldHRpbmdzID0gdC5leHRlbmQoe30sIG4sIHMpLCBvLmNoaWxkcmVuID0gci5jaGlsZHJlbihvLnNldHRpbmdzLnNsaWRlU2VsZWN0b3IpLCBvLmNoaWxkcmVuLmxlbmd0aCA8IG8uc2V0dGluZ3MubWluU2xpZGVzICYmIChvLnNldHRpbmdzLm1pblNsaWRlcyA9IG8uY2hpbGRyZW4ubGVuZ3RoKSwgby5jaGlsZHJlbi5sZW5ndGggPCBvLnNldHRpbmdzLm1heFNsaWRlcyAmJiAoby5zZXR0aW5ncy5tYXhTbGlkZXMgPSBvLmNoaWxkcmVuLmxlbmd0aCksIG8uc2V0dGluZ3MucmFuZG9tU3RhcnQgJiYgKG8uc2V0dGluZ3Muc3RhcnRTbGlkZSA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIG8uY2hpbGRyZW4ubGVuZ3RoKSksIG8uYWN0aXZlID0gewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogby5zZXR0aW5ncy5zdGFydFNsaWRlCiAgICAgICAgICAgICAgICAgICAgfSwgby5jYXJvdXNlbCA9IG8uc2V0dGluZ3MubWluU2xpZGVzID4gMSB8fCBvLnNldHRpbmdzLm1heFNsaWRlcyA+IDEsIG8ubWluVGhyZXNob2xkID0gby5zZXR0aW5ncy5taW5TbGlkZXMgKiBvLnNldHRpbmdzLnNsaWRlV2lkdGggKyAoby5zZXR0aW5ncy5taW5TbGlkZXMgLSAxKSAqIG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4sIG8ubWF4VGhyZXNob2xkID0gby5zZXR0aW5ncy5tYXhTbGlkZXMgKiBvLnNldHRpbmdzLnNsaWRlV2lkdGggKyAoby5zZXR0aW5ncy5tYXhTbGlkZXMgLSAxKSAqIG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4sIG8ud29ya2luZyA9ICExLCBvLmNvbnRyb2xzID0ge30sIG8uaW50ZXJ2YWwgPSBudWxsLCBvLmFuaW1Qcm9wID0gInZlcnRpY2FsIiA9PSBvLnNldHRpbmdzLm1vZGUgPyAidG9wIiA6ICJsZWZ0Iiwgby51c2luZ0NTUyA9IG8uc2V0dGluZ3MudXNlQ1NTICYmICJmYWRlIiAhPSBvLnNldHRpbmdzLm1vZGUgJiYgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlID0gWyJXZWJraXRQZXJzcGVjdGl2ZSIsICJNb3pQZXJzcGVjdGl2ZSIsICJPUGVyc3BlY3RpdmUiLCAibXNQZXJzcGVjdGl2ZSJdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIGUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSB0LnN0eWxlW2VbaV1dKSByZXR1cm4gby5jc3NQcmVmaXggPSBlW2ldLnJlcGxhY2UoIlBlcnNwZWN0aXZlIiwgIiIpLnRvTG93ZXJDYXNlKCksIG8uYW5pbVByb3AgPSAiLSIgKyBvLmNzc1ByZWZpeCArICItdHJhbnNmb3JtIiwgITA7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAhMQogICAgICAgICAgICAgICAgICAgIH0oKSwgInZlcnRpY2FsIiA9PSBvLnNldHRpbmdzLm1vZGUgJiYgKG8uc2V0dGluZ3MubWF4U2xpZGVzID0gby5zZXR0aW5ncy5taW5TbGlkZXMpLCBjKCkKICAgICAgICAgICAgICAgIH0sIGMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoci53cmFwKCc8ZGl2IGNsYXNzPSJieC13cmFwcGVyIj48ZGl2IGNsYXNzPSJieC12aWV3cG9ydCI+PC9kaXY+PC9kaXY+JyksIG8udmlld3BvcnQgPSByLnBhcmVudCgpLCBvLmxvYWRlciA9IHQoJzxkaXYgY2xhc3M9ImJ4LWxvYWRpbmciIC8+JyksIG8udmlld3BvcnQucHJlcGVuZChvLmxvYWRlciksIHIuY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6ICJob3Jpem9udGFsIiA9PSBvLnNldHRpbmdzLm1vZGUgPyAyMTUgKiBvLmNoaWxkcmVuLmxlbmd0aCArICIlIiA6ICJhdXRvIiwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIKICAgICAgICAgICAgICAgICAgICB9KSwgby51c2luZ0NTUyAmJiBvLnNldHRpbmdzLmVhc2luZyA/IHIuY3NzKCItIiArIG8uY3NzUHJlZml4ICsgIi10cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiIsIG8uc2V0dGluZ3MuZWFzaW5nKSA6IG8uc2V0dGluZ3MuZWFzaW5nIHx8IChvLnNldHRpbmdzLmVhc2luZyA9ICJzd2luZyIpLCBvLnZpZXdwb3J0LmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJmbG93OiAiaGlkZGVuIiwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIKICAgICAgICAgICAgICAgICAgICB9KSwgby5jaGlsZHJlbi5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICAiZmxvYXQiOiAiaG9yaXpvbnRhbCIgPT0gby5zZXR0aW5ncy5tb2RlID8gImxlZnQiIDogIm5vbmUiLAogICAgICAgICAgICAgICAgICAgICAgICBsaXN0U3R5bGU6ICJub25lIiwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIKICAgICAgICAgICAgICAgICAgICB9KSwgby5jaGlsZHJlbi53aWR0aChoKCkpLCAiaG9yaXpvbnRhbCIgPT0gby5zZXR0aW5ncy5tb2RlICYmIG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4gPiAwICYmIG8uY2hpbGRyZW4uY3NzKCJtYXJnaW5SaWdodCIsIG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4pLCAidmVydGljYWwiID09IG8uc2V0dGluZ3MubW9kZSAmJiBvLnNldHRpbmdzLnNsaWRlTWFyZ2luID4gMCAmJiBvLmNoaWxkcmVuLmNzcygibWFyZ2luQm90dG9tIiwgby5zZXR0aW5ncy5zbGlkZU1hcmdpbiksICJmYWRlIiA9PSBvLnNldHRpbmdzLm1vZGUgJiYgKG8uY2hpbGRyZW4uY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgIHpJbmRleDogMCwKICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheTogIm5vbmUiCiAgICAgICAgICAgICAgICAgICAgfSksIG8uY2hpbGRyZW4uZXEoby5zZXR0aW5ncy5zdGFydFNsaWRlKS5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDUwLAogICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5OiAiYmxvY2siCiAgICAgICAgICAgICAgICAgICAgfSkpLCBvLmNvbnRyb2xzLmVsID0gdCgnPGRpdiBjbGFzcz0iYngtY29udHJvbHMiIC8+JyksIG8uc2V0dGluZ3MuY2FwdGlvbnMgJiYgVCgpLCBvLnNldHRpbmdzLmluZmluaXRlTG9vcCAmJiAiZmFkZSIgIT0gby5zZXR0aW5ncy5tb2RlICYmICFvLnNldHRpbmdzLnRpY2tlcikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZSA9ICJ2ZXJ0aWNhbCIgPT0gby5zZXR0aW5ncy5tb2RlID8gby5zZXR0aW5ncy5taW5TbGlkZXMgOiBvLnNldHRpbmdzLm1heFNsaWRlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSBvLmNoaWxkcmVuLnNsaWNlKDAsIGUpLmNsb25lKCkuYWRkQ2xhc3MoImJ4LWNsb25lIiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuID0gby5jaGlsZHJlbi5zbGljZSgtZSkuY2xvbmUoKS5hZGRDbGFzcygiYngtY2xvbmUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgci5hcHBlbmQoaSkucHJlcGVuZChuKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBvLmFjdGl2ZS5sYXN0ID0gby5zZXR0aW5ncy5zdGFydFNsaWRlID09IHYoKSAtIDEsIG8uc2V0dGluZ3MudmlkZW8gJiYgci5maXRWaWRzKCksIG8uc2V0dGluZ3MudGlja2VyIHx8IChvLnNldHRpbmdzLnBhZ2VyICYmIFMoKSwgby5zZXR0aW5ncy5jb250cm9scyAmJiBiKCksIG8uc2V0dGluZ3MuYXV0byAmJiBvLnNldHRpbmdzLmF1dG9Db250cm9scyAmJiB3KCksIChvLnNldHRpbmdzLmNvbnRyb2xzIHx8IG8uc2V0dGluZ3MuYXV0b0NvbnRyb2xzIHx8IG8uc2V0dGluZ3MucGFnZXIpICYmIG8udmlld3BvcnQuYWZ0ZXIoby5jb250cm9scy5lbCkpLCByLmNoaWxkcmVuKCkuaW1hZ2VzTG9hZGVkKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBvLmxvYWRlci5yZW1vdmUoKSwgZigpLCAidmVydGljYWwiID09IG8uc2V0dGluZ3MubW9kZSAmJiAoby5zZXR0aW5ncy5hZGFwdGl2ZUhlaWdodCA9ICEwKSwgby52aWV3cG9ydC5oZWlnaHQoZygpKSwgby5zZXR0aW5ncy5vblNsaWRlckxvYWQoby5hY3RpdmUuaW5kZXgpLCBvLmluaXRpYWxpemVkID0gITAsIHQod2luZG93KS5iaW5kKCJyZXNpemUiLCBPKSwgby5zZXR0aW5ncy5hdXRvICYmIG8uc2V0dGluZ3MuYXV0b1N0YXJ0ICYmIEwoKSwgby5zZXR0aW5ncy50aWNrZXIgJiYgRCgpLCBvLnNldHRpbmdzLnBhZ2VyICYmIHkoby5zZXR0aW5ncy5zdGFydFNsaWRlKSwgby5zZXR0aW5ncy5jb250cm9scyAmJiBxKCksIG8uc2V0dGluZ3MudG91Y2hFbmFibGVkICYmICFvLnNldHRpbmdzLnRpY2tlciAmJiBIKCkKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfSwgZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBlID0gMCwKICAgICAgICAgICAgICAgICAgICAgICAgbiA9IHQoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoInZlcnRpY2FsIiA9PSBvLnNldHRpbmdzLm1vZGUgfHwgby5zZXR0aW5ncy5hZGFwdGl2ZUhlaWdodCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG8uY2Fyb3VzZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzID0gMSA9PSBvLnNldHRpbmdzLm1vdmVTbGlkZXMgPyBvLmFjdGl2ZS5pbmRleCA6IG8uYWN0aXZlLmluZGV4ICogcCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChuID0gby5jaGlsZHJlbi5lcShzKSwgaSA9IDE7IG8uc2V0dGluZ3MubWF4U2xpZGVzIC0gMSA+PSBpOyBpKyspIG4gPSBzICsgaSA+PSBvLmNoaWxkcmVuLmxlbmd0aCA/IG4uYWRkKG8uY2hpbGRyZW4uZXEoaSAtIDEpKSA6IG4uYWRkKG8uY2hpbGRyZW4uZXEocyArIGkpKQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgbiA9IG8uY2hpbGRyZW4uZXEoby5hY3RpdmUuaW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIG4gPSBvLmNoaWxkcmVuOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAidmVydGljYWwiID09IG8uc2V0dGluZ3MubW9kZSA/IChuLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGUgKz0gdCh0aGlzKS5vdXRlckhlaWdodCgpCiAgICAgICAgICAgICAgICAgICAgfSksIG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4gPiAwICYmIChlICs9IG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4gKiAoby5zZXR0aW5ncy5taW5TbGlkZXMgLSAxKSkpIDogZSA9IE1hdGgubWF4LmFwcGx5KE1hdGgsIG4ubWFwKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdCh0aGlzKS5vdXRlckhlaWdodCghMSkKICAgICAgICAgICAgICAgICAgICB9KS5nZXQoKSksIGUKICAgICAgICAgICAgICAgIH0sIGggPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IG8uc2V0dGluZ3Muc2xpZGVXaWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgZSA9IG8udmlld3BvcnQud2lkdGgoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMCA9PSBvLnNldHRpbmdzLnNsaWRlV2lkdGggPyB0ID0gZSA6IGUgPiBvLm1heFRocmVzaG9sZCA/IHQgPSAoZSAtIG8uc2V0dGluZ3Muc2xpZGVNYXJnaW4gKiAoby5zZXR0aW5ncy5tYXhTbGlkZXMgLSAxKSkgLyBvLnNldHRpbmdzLm1heFNsaWRlcyA6IG8ubWluVGhyZXNob2xkID4gZSAmJiAodCA9IChlIC0gby5zZXR0aW5ncy5zbGlkZU1hcmdpbiAqIChvLnNldHRpbmdzLm1pblNsaWRlcyAtIDEpKSAvIG8uc2V0dGluZ3MubWluU2xpZGVzKSwgdAogICAgICAgICAgICAgICAgfSwgdSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gMTsKICAgICAgICAgICAgICAgICAgICBpZiAoImhvcml6b250YWwiID09IG8uc2V0dGluZ3MubW9kZSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG8udmlld3BvcnQud2lkdGgoKSA8IG8ubWluVGhyZXNob2xkKSB0ID0gby5zZXR0aW5ncy5taW5TbGlkZXM7CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBpZiAoby52aWV3cG9ydC53aWR0aCgpID4gby5tYXhUaHJlc2hvbGQpIHQgPSBvLnNldHRpbmdzLm1heFNsaWRlczsKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSBvLmNoaWxkcmVuLmZpcnN0KCkud2lkdGgoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdCA9IE1hdGguZmxvb3Ioby52aWV3cG9ydC53aWR0aCgpIC8gZSkKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgInZlcnRpY2FsIiA9PSBvLnNldHRpbmdzLm1vZGUgJiYgKHQgPSBvLnNldHRpbmdzLm1pblNsaWRlcyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHQKICAgICAgICAgICAgICAgIH0sIHYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKG8uc2V0dGluZ3MubW92ZVNsaWRlcyA+IDApCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvLnNldHRpbmdzLmluZmluaXRlTG9vcCkgdCA9IG8uY2hpbGRyZW4ubGVuZ3RoIC8gcCgpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBlID0gMCwgaSA9IDA7IG8uY2hpbGRyZW4ubGVuZ3RoID4gZTspKyt0LCBlID0gaSArIHUoKSwgaSArPSBvLnNldHRpbmdzLm1vdmVTbGlkZXMgPD0gdSgpID8gby5zZXR0aW5ncy5tb3ZlU2xpZGVzIDogdSgpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHQgPSBNYXRoLmNlaWwoby5jaGlsZHJlbi5sZW5ndGggLyB1KCkpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0CiAgICAgICAgICAgICAgICB9LCBwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG8uc2V0dGluZ3MubW92ZVNsaWRlcyA+IDAgJiYgby5zZXR0aW5ncy5tb3ZlU2xpZGVzIDw9IHUoKSA/IG8uc2V0dGluZ3MubW92ZVNsaWRlcyA6IHUoKQogICAgICAgICAgICAgICAgfSwgZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChvLmFjdGl2ZS5sYXN0ICYmICFvLnNldHRpbmdzLmluZmluaXRlTG9vcCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoImhvcml6b250YWwiID09IG8uc2V0dGluZ3MubW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSBvLmNoaWxkcmVuLmxhc3QoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlID0gdC5wb3NpdGlvbigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgeCgtKGUubGVmdCAtIChvLnZpZXdwb3J0LndpZHRoKCkgLSB0LndpZHRoKCkpKSwgInJlc2V0IiwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgidmVydGljYWwiID09IG8uc2V0dGluZ3MubW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSBvLmNoaWxkcmVuLmxlbmd0aCAtIG8uc2V0dGluZ3MubWluU2xpZGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSBvLmNoaWxkcmVuLmVxKGkpLnBvc2l0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4KC1lLnRvcCwgInJlc2V0IiwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlID0gby5jaGlsZHJlbi5lcShvLmFjdGl2ZS5pbmRleCAqIHAoKSkucG9zaXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgby5hY3RpdmUuaW5kZXggPT0gdigpIC0gMSAmJiAoby5hY3RpdmUubGFzdCA9ICEwKSwgdm9pZCAwICE9IGUgJiYgKCJob3Jpem9udGFsIiA9PSBvLnNldHRpbmdzLm1vZGUgPyB4KC1lLmxlZnQsICJyZXNldCIsIDApIDogInZlcnRpY2FsIiA9PSBvLnNldHRpbmdzLm1vZGUgJiYgeCgtZS50b3AsICJyZXNldCIsIDApKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIHggPSBmdW5jdGlvbih0LCBlLCBpLCBuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG8udXNpbmdDU1MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHMgPSAidmVydGljYWwiID09IG8uc2V0dGluZ3MubW9kZSA/ICJ0cmFuc2xhdGUzZCgwLCAiICsgdCArICJweCwgMCkiIDogInRyYW5zbGF0ZTNkKCIgKyB0ICsgInB4LCAwLCAwKSI7CiAgICAgICAgICAgICAgICAgICAgICAgIHIuY3NzKCItIiArIG8uY3NzUHJlZml4ICsgIi10cmFuc2l0aW9uLWR1cmF0aW9uIiwgaSAvIDFlMyArICJzIiksICJzbGlkZSIgPT0gZSA/IChyLmNzcyhvLmFuaW1Qcm9wLCBzKSwgci5iaW5kKCJ0cmFuc2l0aW9uZW5kIHdlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQgTVNUcmFuc2l0aW9uRW5kIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByLnVuYmluZCgidHJhbnNpdGlvbmVuZCB3ZWJraXRUcmFuc2l0aW9uRW5kIG9UcmFuc2l0aW9uRW5kIE1TVHJhbnNpdGlvbkVuZCIpLCB6KCkKICAgICAgICAgICAgICAgICAgICAgICAgfSkpIDogInJlc2V0IiA9PSBlID8gci5jc3Moby5hbmltUHJvcCwgcykgOiAidGlja2VyIiA9PSBlICYmIChyLmNzcygiLSIgKyBvLmNzc1ByZWZpeCArICItdHJhbnNpdGlvbi10aW1pbmctZnVuY3Rpb24iLCAibGluZWFyIiksIHIuY3NzKG8uYW5pbVByb3AsIHMpLCByLmJpbmQoInRyYW5zaXRpb25lbmQgd2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCBNU1RyYW5zaXRpb25FbmQiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIudW5iaW5kKCJ0cmFuc2l0aW9uZW5kIHdlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQgTVNUcmFuc2l0aW9uRW5kIiksIHgobi5yZXNldFZhbHVlLCAicmVzZXQiLCAwKSwgSSgpCiAgICAgICAgICAgICAgICAgICAgICAgIH0pKQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIGFbby5hbmltUHJvcF0gPSB0LCAic2xpZGUiID09IGUgPyByLmFuaW1hdGUoYSwgaSwgby5zZXR0aW5ncy5lYXNpbmcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeigpCiAgICAgICAgICAgICAgICAgICAgICAgIH0pIDogInJlc2V0IiA9PSBlID8gci5jc3Moby5hbmltUHJvcCwgdCkgOiAidGlja2VyIiA9PSBlICYmIHIuYW5pbWF0ZShhLCBzcGVlZCwgImxpbmVhciIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeChuLnJlc2V0VmFsdWUsICJyZXNldCIsIDApLCBJKCkKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBtID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSAiIjsKICAgICAgICAgICAgICAgICAgICBwYWdlclF0eSA9IHYoKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgcGFnZXJRdHkgPiBpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSAiIjsKICAgICAgICAgICAgICAgICAgICAgICAgby5zZXR0aW5ncy5idWlsZFBhZ2VyICYmIHQuaXNGdW5jdGlvbihvLnNldHRpbmdzLmJ1aWxkUGFnZXIpID8gKG4gPSBvLnNldHRpbmdzLmJ1aWxkUGFnZXIoaSksIG8ucGFnZXJFbC5hZGRDbGFzcygiYngtY3VzdG9tLXBhZ2VyIikpIDogKG4gPSBpICsgMSwgby5wYWdlckVsLmFkZENsYXNzKCJieC1kZWZhdWx0LXBhZ2VyIikpLCBlICs9ICc8ZGl2IGNsYXNzPSJieC1wYWdlci1pdGVtIj48YSBocmVmPSIiIGRhdGEtc2xpZGUtaW5kZXg9IicgKyBpICsgJyIgY2xhc3M9ImJ4LXBhZ2VyLWxpbmsiPicgKyBuICsgIjwvYT48L2Rpdj4iCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG8ucGFnZXJFbC5odG1sKGUpCiAgICAgICAgICAgICAgICB9LCBTID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgby5zZXR0aW5ncy5wYWdlckN1c3RvbSA/IG8ucGFnZXJFbCA9IHQoby5zZXR0aW5ncy5wYWdlckN1c3RvbSkgOiAoby5wYWdlckVsID0gdCgnPGRpdiBjbGFzcz0iYngtcGFnZXIiIC8+JyksIG8uc2V0dGluZ3MucGFnZXJTZWxlY3RvciA/IHQoby5zZXR0aW5ncy5wYWdlclNlbGVjdG9yKS5odG1sKG8ucGFnZXJFbCkgOiBvLmNvbnRyb2xzLmVsLmFkZENsYXNzKCJieC1oYXMtcGFnZXIiKS5hcHBlbmQoby5wYWdlckVsKSwgbSgpKSwgby5wYWdlckVsLmRlbGVnYXRlKCJhIiwgImNsaWNrIiwgaykKICAgICAgICAgICAgICAgIH0sIGIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBvLmNvbnRyb2xzLm5leHQgPSB0KCc8YSBjbGFzcz0iYngtbmV4dCIgaHJlZj0iIj4nICsgby5zZXR0aW5ncy5uZXh0VGV4dCArICI8L2E+IiksIG8uY29udHJvbHMucHJldiA9IHQoJzxhIGNsYXNzPSJieC1wcmV2IiBocmVmPSIiPicgKyBvLnNldHRpbmdzLnByZXZUZXh0ICsgIjwvYT4iKSwgby5jb250cm9scy5uZXh0LmJpbmQoImNsaWNrIiwgQyksIG8uY29udHJvbHMucHJldi5iaW5kKCJjbGljayIsIEUpLCBvLnNldHRpbmdzLm5leHRTZWxlY3RvciAmJiB0KG8uc2V0dGluZ3MubmV4dFNlbGVjdG9yKS5hcHBlbmQoby5jb250cm9scy5uZXh0KSwgby5zZXR0aW5ncy5wcmV2U2VsZWN0b3IgJiYgdChvLnNldHRpbmdzLnByZXZTZWxlY3RvcikuYXBwZW5kKG8uY29udHJvbHMucHJldiksIG8uc2V0dGluZ3MubmV4dFNlbGVjdG9yIHx8IG8uc2V0dGluZ3MucHJldlNlbGVjdG9yIHx8IChvLmNvbnRyb2xzLmRpcmVjdGlvbkVsID0gdCgnPGRpdiBjbGFzcz0iYngtY29udHJvbHMtZGlyZWN0aW9uIiAvPicpLCBvLmNvbnRyb2xzLmRpcmVjdGlvbkVsLmFwcGVuZChvLmNvbnRyb2xzLnByZXYpLmFwcGVuZChvLmNvbnRyb2xzLm5leHQpLCBvLmNvbnRyb2xzLmVsLmFkZENsYXNzKCJieC1oYXMtY29udHJvbHMtZGlyZWN0aW9uIikuYXBwZW5kKG8uY29udHJvbHMuZGlyZWN0aW9uRWwpKQogICAgICAgICAgICAgICAgfSwgdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIG8uY29udHJvbHMuc3RhcnQgPSB0KCc8ZGl2IGNsYXNzPSJieC1jb250cm9scy1hdXRvLWl0ZW0iPjxhIGNsYXNzPSJieC1zdGFydCIgaHJlZj0iIj4nICsgby5zZXR0aW5ncy5zdGFydFRleHQgKyAiPC9hPjwvZGl2PiIpLCBvLmNvbnRyb2xzLnN0b3AgPSB0KCc8ZGl2IGNsYXNzPSJieC1jb250cm9scy1hdXRvLWl0ZW0iPjxhIGNsYXNzPSJieC1zdG9wIiBocmVmPSIiPicgKyBvLnNldHRpbmdzLnN0b3BUZXh0ICsgIjwvYT48L2Rpdj4iKSwgby5jb250cm9scy5hdXRvRWwgPSB0KCc8ZGl2IGNsYXNzPSJieC1jb250cm9scy1hdXRvIiAvPicpLCBvLmNvbnRyb2xzLmF1dG9FbC5kZWxlZ2F0ZSgiLmJ4LXN0YXJ0IiwgImNsaWNrIiwgQSksIG8uY29udHJvbHMuYXV0b0VsLmRlbGVnYXRlKCIuYngtc3RvcCIsICJjbGljayIsIFApLCBvLnNldHRpbmdzLmF1dG9Db250cm9sc0NvbWJpbmUgPyBvLmNvbnRyb2xzLmF1dG9FbC5hcHBlbmQoby5jb250cm9scy5zdGFydCkgOiBvLmNvbnRyb2xzLmF1dG9FbC5hcHBlbmQoby5jb250cm9scy5zdGFydCkuYXBwZW5kKG8uY29udHJvbHMuc3RvcCksIG8uc2V0dGluZ3MuYXV0b0NvbnRyb2xzU2VsZWN0b3IgPyB0KG8uc2V0dGluZ3MuYXV0b0NvbnRyb2xzU2VsZWN0b3IpLmh0bWwoby5jb250cm9scy5hdXRvRWwpIDogby5jb250cm9scy5lbC5hZGRDbGFzcygiYngtaGFzLWNvbnRyb2xzLWF1dG8iKS5hcHBlbmQoby5jb250cm9scy5hdXRvRWwpLCBNKG8uc2V0dGluZ3MuYXV0b1N0YXJ0ID8gInN0b3AiIDogInN0YXJ0IikKICAgICAgICAgICAgICAgIH0sIFQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBvLmNoaWxkcmVuLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlID0gdCh0aGlzKS5maW5kKCJpbWc6Zmlyc3QiKS5hdHRyKCJ0aXRsZSIpOwogICAgICAgICAgICAgICAgICAgICAgICB2b2lkIDAgIT0gZSAmJiB0KHRoaXMpLmFwcGVuZCgnPGRpdiBjbGFzcz0iYngtY2FwdGlvbiI+PHNwYW4+JyArIGUgKyAiPC9zcGFuPjwvZGl2PiIpCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0sIEMgPSBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgby5zZXR0aW5ncy5hdXRvICYmIHIuc3RvcEF1dG8oKSwgci5nb1RvTmV4dFNsaWRlKCksIHQucHJldmVudERlZmF1bHQoKQogICAgICAgICAgICAgICAgfSwgRSA9IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICBvLnNldHRpbmdzLmF1dG8gJiYgci5zdG9wQXV0bygpLCByLmdvVG9QcmV2U2xpZGUoKSwgdC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgICAgICAgICB9LCBBID0gZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgIHIuc3RhcnRBdXRvKCksIHQucHJldmVudERlZmF1bHQoKQogICAgICAgICAgICAgICAgfSwgUCA9IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICByLnN0b3BBdXRvKCksIHQucHJldmVudERlZmF1bHQoKQogICAgICAgICAgICAgICAgfSwgayA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICBvLnNldHRpbmdzLmF1dG8gJiYgci5zdG9wQXV0bygpOwogICAgICAgICAgICAgICAgICAgIHZhciBpID0gdChlLmN1cnJlbnRUYXJnZXQpLAogICAgICAgICAgICAgICAgICAgICAgICBuID0gcGFyc2VJbnQoaS5hdHRyKCJkYXRhLXNsaWRlLWluZGV4IikpOwogICAgICAgICAgICAgICAgICAgIG4gIT0gby5hY3RpdmUuaW5kZXggJiYgci5nb1RvU2xpZGUobiksIGUucHJldmVudERlZmF1bHQoKQogICAgICAgICAgICAgICAgfSwgeSA9IGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gInNob3J0IiA9PSBvLnNldHRpbmdzLnBhZ2VyVHlwZSA/IChvLnBhZ2VyRWwuaHRtbChlICsgMSArIG8uc2V0dGluZ3MucGFnZXJTaG9ydFNlcGFyYXRvciArIG8uY2hpbGRyZW4ubGVuZ3RoKSwgdm9pZCAwKSA6IChvLnBhZ2VyRWwuZmluZCgiYSIpLnJlbW92ZUNsYXNzKCJhY3RpdmUiKSwgby5wYWdlckVsLmVhY2goZnVuY3Rpb24oaSwgbikgewogICAgICAgICAgICAgICAgICAgICAgICB0KG4pLmZpbmQoImEiKS5lcShlKS5hZGRDbGFzcygiYWN0aXZlIikKICAgICAgICAgICAgICAgICAgICB9KSwgdm9pZCAwKQogICAgICAgICAgICAgICAgfSwgeiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChvLnNldHRpbmdzLmluZmluaXRlTG9vcCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdCA9ICIiOwogICAgICAgICAgICAgICAgICAgICAgICAwID09IG8uYWN0aXZlLmluZGV4ID8gdCA9IG8uY2hpbGRyZW4uZXEoMCkucG9zaXRpb24oKSA6IG8uYWN0aXZlLmluZGV4ID09IHYoKSAtIDEgJiYgby5jYXJvdXNlbCA/IHQgPSBvLmNoaWxkcmVuLmVxKCh2KCkgLSAxKSAqIHAoKSkucG9zaXRpb24oKSA6IG8uYWN0aXZlLmluZGV4ID09IG8uY2hpbGRyZW4ubGVuZ3RoIC0gMSAmJiAodCA9IG8uY2hpbGRyZW4uZXEoby5jaGlsZHJlbi5sZW5ndGggLSAxKS5wb3NpdGlvbigpKSwgImhvcml6b250YWwiID09IG8uc2V0dGluZ3MubW9kZSA/IHgoLXQubGVmdCwgInJlc2V0IiwgMCkgOiAidmVydGljYWwiID09IG8uc2V0dGluZ3MubW9kZSAmJiB4KC10LnRvcCwgInJlc2V0IiwgMCkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgby53b3JraW5nID0gITEsIG8uc2V0dGluZ3Mub25TbGlkZUFmdGVyKG8uY2hpbGRyZW4uZXEoby5hY3RpdmUuaW5kZXgpLCBvLm9sZEluZGV4LCBvLmFjdGl2ZS5pbmRleCkKICAgICAgICAgICAgICAgIH0sIE0gPSBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgby5zZXR0aW5ncy5hdXRvQ29udHJvbHNDb21iaW5lID8gby5jb250cm9scy5hdXRvRWwuaHRtbChvLmNvbnRyb2xzW3RdKSA6IChvLmNvbnRyb2xzLmF1dG9FbC5maW5kKCJhIikucmVtb3ZlQ2xhc3MoImFjdGl2ZSIpLCBvLmNvbnRyb2xzLmF1dG9FbC5maW5kKCJhOm5vdCguYngtIiArIHQgKyAiKSIpLmFkZENsYXNzKCJhY3RpdmUiKSkKICAgICAgICAgICAgICAgIH0sIHEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAhby5zZXR0aW5ncy5pbmZpbml0ZUxvb3AgJiYgby5zZXR0aW5ncy5oaWRlQ29udHJvbE9uRW5kICYmICgwID09IG8uYWN0aXZlLmluZGV4ID8gKG8uY29udHJvbHMucHJldi5hZGRDbGFzcygiZGlzYWJsZWQiKSwgby5jb250cm9scy5uZXh0LnJlbW92ZUNsYXNzKCJkaXNhYmxlZCIpKSA6IG8uYWN0aXZlLmluZGV4ID09IHYoKSAtIDEgPyAoby5jb250cm9scy5uZXh0LmFkZENsYXNzKCJkaXNhYmxlZCIpLCBvLmNvbnRyb2xzLnByZXYucmVtb3ZlQ2xhc3MoImRpc2FibGVkIikpIDogKG8uY29udHJvbHMucHJldi5yZW1vdmVDbGFzcygiZGlzYWJsZWQiKSwgby5jb250cm9scy5uZXh0LnJlbW92ZUNsYXNzKCJkaXNhYmxlZCIpKSkKICAgICAgICAgICAgICAgIH0sIEwgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBvLnNldHRpbmdzLmF1dG9EZWxheSA+IDAgPyBzZXRUaW1lb3V0KHIuc3RhcnRBdXRvLCBvLnNldHRpbmdzLmF1dG9EZWxheSkgOiByLnN0YXJ0QXV0bygpLCBvLnNldHRpbmdzLmF1dG9Ib3ZlciAmJiByLmhvdmVyKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBvLmludGVydmFsICYmIChyLnN0b3BBdXRvKCEwKSwgby5hdXRvUGF1c2VkID0gITApCiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG8uYXV0b1BhdXNlZCAmJiAoci5zdGFydEF1dG8oITApLCBvLmF1dG9QYXVzZWQgPSBudWxsKQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB9LCBEID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmICgibmV4dCIgPT0gby5zZXR0aW5ncy5hdXRvRGlyZWN0aW9uKSByLmFwcGVuZChvLmNoaWxkcmVuLmNsb25lKCkuYWRkQ2xhc3MoImJ4LWNsb25lIikpOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByLnByZXBlbmQoby5jaGlsZHJlbi5jbG9uZSgpLmFkZENsYXNzKCJieC1jbG9uZSIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSBvLmNoaWxkcmVuLmZpcnN0KCkucG9zaXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgZSA9ICJob3Jpem9udGFsIiA9PSBvLnNldHRpbmdzLm1vZGUgPyAtaS5sZWZ0IDogLWkudG9wCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHgoZSwgInJlc2V0IiwgMCksIG8uc2V0dGluZ3MucGFnZXIgPSAhMSwgby5zZXR0aW5ncy5jb250cm9scyA9ICExLCBvLnNldHRpbmdzLmF1dG9Db250cm9scyA9ICExLCBvLnNldHRpbmdzLnRpY2tlckhvdmVyICYmICFvLnVzaW5nQ1NTICYmIG8udmlld3BvcnQuaG92ZXIoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHIuc3RvcCgpCiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgby5jaGlsZHJlbi5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZSArPSAiaG9yaXpvbnRhbCIgPT0gby5zZXR0aW5ncy5tb2RlID8gdCh0aGlzKS5vdXRlcldpZHRoKCEwKSA6IHQodGhpcykub3V0ZXJIZWlnaHQoITApCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IG8uc2V0dGluZ3Muc3BlZWQgLyBlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbiA9ICJob3Jpem9udGFsIiA9PSBvLnNldHRpbmdzLm1vZGUgPyAibGVmdCIgOiAidG9wIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMgPSBpICogKGUgLSBNYXRoLmFicyhwYXJzZUludChyLmNzcyhuKSkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgSShzKQogICAgICAgICAgICAgICAgICAgIH0pLCBJKCkKICAgICAgICAgICAgICAgIH0sIEkgPSBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgc3BlZWQgPSB0ID8gdCA6IG8uc2V0dGluZ3Muc3BlZWQ7CiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogMAogICAgICAgICAgICAgICAgICAgIH0sIGkgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiAwCiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgIm5leHQiID09IG8uc2V0dGluZ3MuYXV0b0RpcmVjdGlvbiA/IGUgPSByLmZpbmQoIi5ieC1jbG9uZSIpLmZpcnN0KCkucG9zaXRpb24oKSA6IGkgPSBvLmNoaWxkcmVuLmZpcnN0KCkucG9zaXRpb24oKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbiA9ICJob3Jpem9udGFsIiA9PSBvLnNldHRpbmdzLm1vZGUgPyAtZS5sZWZ0IDogLWUudG9wLAogICAgICAgICAgICAgICAgICAgICAgICBzID0gImhvcml6b250YWwiID09IG8uc2V0dGluZ3MubW9kZSA/IC1pLmxlZnQgOiAtaS50b3AsCiAgICAgICAgICAgICAgICAgICAgICAgIGEgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNldFZhbHVlOiBzCiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgeChuLCAidGlja2VyIiwgc3BlZWQsIGEpCiAgICAgICAgICAgICAgICB9LCBIID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgby50b3VjaCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHg6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5OiAwCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGVuZDogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeDogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHk6IDAKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sIG8udmlld3BvcnQuYmluZCgidG91Y2hzdGFydCIsIFcpCiAgICAgICAgICAgICAgICB9LCBXID0gZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgIGlmIChvLndvcmtpbmcpIHQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgby50b3VjaC5vcmlnaW5hbFBvcyA9IHIucG9zaXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSB0Lm9yaWdpbmFsRXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIG8udG91Y2guc3RhcnQueCA9IGUuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVgsIG8udG91Y2guc3RhcnQueSA9IGUuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVksIG8udmlld3BvcnQuYmluZCgidG91Y2htb3ZlIiwgTiksIG8udmlld3BvcnQuYmluZCgidG91Y2hlbmQiLCBCKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIE4gPSBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQucHJldmVudERlZmF1bHQoKSwgImZhZGUiICE9IG8uc2V0dGluZ3MubW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZSA9IHQub3JpZ2luYWxFdmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoImhvcml6b250YWwiID09IG8uc2V0dGluZ3MubW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSBlLmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYIC0gby50b3VjaC5zdGFydC54OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSA9IG8udG91Y2gub3JpZ2luYWxQb3MubGVmdCArIG4KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWSAtIG8udG91Y2guc3RhcnQueTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSBvLnRvdWNoLm9yaWdpbmFsUG9zLnRvcCArIG4KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB4KGksICJyZXNldCIsIDApCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgQiA9IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICBvLnZpZXdwb3J0LnVuYmluZCgidG91Y2htb3ZlIiwgTik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSB0Lm9yaWdpbmFsRXZlbnQsCiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmIChvLnRvdWNoLmVuZC54ID0gZS5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWCwgby50b3VjaC5lbmQueSA9IGUuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVksICJmYWRlIiA9PSBvLnNldHRpbmdzLm1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSBNYXRoLmFicyhvLnRvdWNoLnN0YXJ0LnggLSBvLnRvdWNoLmVuZC54KTsKICAgICAgICAgICAgICAgICAgICAgICAgbiA+PSBvLnNldHRpbmdzLnN3aXBlVGhyZXNob2xkICYmIChvLnRvdWNoLnN0YXJ0LnggPiBvLnRvdWNoLmVuZC54ID8gci5nb1RvTmV4dFNsaWRlKCkgOiByLmdvVG9QcmV2U2xpZGUoKSwgci5zdG9wQXV0bygpKQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgImhvcml6b250YWwiID09IG8uc2V0dGluZ3MubW9kZSA/IChuID0gby50b3VjaC5lbmQueCAtIG8udG91Y2guc3RhcnQueCwgaSA9IG8udG91Y2gub3JpZ2luYWxQb3MubGVmdCkgOiAobiA9IG8udG91Y2guZW5kLnkgLSBvLnRvdWNoLnN0YXJ0LnksIGkgPSBvLnRvdWNoLm9yaWdpbmFsUG9zLnRvcCksICFvLnNldHRpbmdzLmluZmluaXRlTG9vcCAmJiAoMCA9PSBvLmFjdGl2ZS5pbmRleCAmJiBuID4gMCB8fCBvLmFjdGl2ZS5sYXN0ICYmIDAgPiBuKSA/IHgoaSwgInJlc2V0IiwgMjAwKSA6IE1hdGguYWJzKG4pID49IG8uc2V0dGluZ3Muc3dpcGVUaHJlc2hvbGQgPyAoMCA+IG4gPyByLmdvVG9OZXh0U2xpZGUoKSA6IHIuZ29Ub1ByZXZTbGlkZSgpLCByLnN0b3BBdXRvKCkpIDogeChpLCAicmVzZXQiLCAyMDApCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG8udmlld3BvcnQudW5iaW5kKCJ0b3VjaGVuZCIsIEIpCiAgICAgICAgICAgICAgICB9LCBPID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSB0KHdpbmRvdykud2lkdGgoKSwKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IHQod2luZG93KS5oZWlnaHQoKTsKICAgICAgICAgICAgICAgICAgICAoYSAhPSBlIHx8IGwgIT0gaSkgJiYgKGEgPSBlLCBsID0gaSwgby5jaGlsZHJlbi5hZGQoci5maW5kKCIuYngtY2xvbmUiKSkud2lkdGgoaCgpKSwgby52aWV3cG9ydC5jc3MoImhlaWdodCIsIGcoKSksIG8uYWN0aXZlLmxhc3QgJiYgKG8uYWN0aXZlLmluZGV4ID0gdigpIC0gMSksIG8uYWN0aXZlLmluZGV4ID49IHYoKSAmJiAoby5hY3RpdmUubGFzdCA9ICEwKSwgby5zZXR0aW5ncy5wYWdlciAmJiAhby5zZXR0aW5ncy5wYWdlckN1c3RvbSAmJiAobSgpLCB5KG8uYWN0aXZlLmluZGV4KSksIG8uc2V0dGluZ3MudGlja2VyIHx8IGYoKSkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJldHVybiByLmdvVG9TbGlkZSA9IGZ1bmN0aW9uKGUsIGkpIHsKICAgICAgICAgICAgICAgIGlmICghby53b3JraW5nICYmIG8uYWN0aXZlLmluZGV4ICE9IGUpCiAgICAgICAgICAgICAgICAgICAgaWYgKG8ud29ya2luZyA9ICEwLCBvLm9sZEluZGV4ID0gby5hY3RpdmUuaW5kZXgsIG8uYWN0aXZlLmluZGV4ID0gMCA+IGUgPyB2KCkgLSAxIDogZSA+PSB2KCkgPyAwIDogZSwgby5zZXR0aW5ncy5vblNsaWRlQmVmb3JlKG8uY2hpbGRyZW4uZXEoby5hY3RpdmUuaW5kZXgpLCBvLm9sZEluZGV4LCBvLmFjdGl2ZS5pbmRleCksICJuZXh0IiA9PSBpID8gby5zZXR0aW5ncy5vblNsaWRlTmV4dChvLmNoaWxkcmVuLmVxKG8uYWN0aXZlLmluZGV4KSwgby5vbGRJbmRleCwgby5hY3RpdmUuaW5kZXgpIDogInByZXYiID09IGkgJiYgby5zZXR0aW5ncy5vblNsaWRlUHJldihvLmNoaWxkcmVuLmVxKG8uYWN0aXZlLmluZGV4KSwgby5vbGRJbmRleCwgby5hY3RpdmUuaW5kZXgpLCBvLmFjdGl2ZS5sYXN0ID0gby5hY3RpdmUuaW5kZXggPj0gdigpIC0gMSwgby5zZXR0aW5ncy5wYWdlciAmJiB5KG8uYWN0aXZlLmluZGV4KSwgby5zZXR0aW5ncy5jb250cm9scyAmJiBxKCksICJmYWRlIiA9PSBvLnNldHRpbmdzLm1vZGUpIG8uc2V0dGluZ3MuYWRhcHRpdmVIZWlnaHQgJiYgby52aWV3cG9ydC5oZWlnaHQoKSAhPSBnKCkgJiYgby52aWV3cG9ydC5hbmltYXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBnKCkKICAgICAgICAgICAgICAgICAgICB9LCBvLnNldHRpbmdzLmFkYXB0aXZlSGVpZ2h0U3BlZWQpLCBvLmNoaWxkcmVuLmZpbHRlcigiOnZpc2libGUiKS5mYWRlT3V0KG8uc2V0dGluZ3Muc3BlZWQpLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgIHpJbmRleDogMAogICAgICAgICAgICAgICAgICAgIH0pLCBvLmNoaWxkcmVuLmVxKG8uYWN0aXZlLmluZGV4KS5jc3MoInpJbmRleCIsIDUxKS5mYWRlSW4oby5zZXR0aW5ncy5zcGVlZCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQodGhpcykuY3NzKCJ6SW5kZXgiLCA1MCksIHooKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBvLnNldHRpbmdzLmFkYXB0aXZlSGVpZ2h0ICYmIG8udmlld3BvcnQuaGVpZ2h0KCkgIT0gZygpICYmIG8udmlld3BvcnQuYW5pbWF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IGcoKQogICAgICAgICAgICAgICAgICAgICAgICB9LCBvLnNldHRpbmdzLmFkYXB0aXZlSGVpZ2h0U3BlZWQpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wOiAwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW8uc2V0dGluZ3MuaW5maW5pdGVMb29wICYmIG8uY2Fyb3VzZWwgJiYgby5hY3RpdmUubGFzdCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgiaG9yaXpvbnRhbCIgPT0gby5zZXR0aW5ncy5tb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGEgPSBvLmNoaWxkcmVuLmVxKG8uY2hpbGRyZW4ubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IGEucG9zaXRpb24oKSwgbiA9IG8udmlld3BvcnQud2lkdGgoKSAtIGEud2lkdGgoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbCA9IG8uY2hpbGRyZW4ubGVuZ3RoIC0gby5zZXR0aW5ncy5taW5TbGlkZXM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IG8uY2hpbGRyZW4uZXEobCkucG9zaXRpb24oKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvLmNhcm91c2VsICYmIG8uYWN0aXZlLmxhc3QgJiYgInByZXYiID09IGkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkID0gMSA9PSBvLnNldHRpbmdzLm1vdmVTbGlkZXMgPyBvLnNldHRpbmdzLm1heFNsaWRlcyAtIHAoKSA6ICh2KCkgLSAxKSAqIHAoKSAtIChvLmNoaWxkcmVuLmxlbmd0aCAtIG8uc2V0dGluZ3MubWF4U2xpZGVzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhID0gci5jaGlsZHJlbigiLmJ4LWNsb25lIikuZXEoZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzID0gYS5wb3NpdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIm5leHQiID09IGkgJiYgMCA9PSBvLmFjdGl2ZS5pbmRleCkgcyA9IHIuZmluZCgiLmJ4LWNsb25lIikuZXEoby5zZXR0aW5ncy5tYXhTbGlkZXMpLnBvc2l0aW9uKCksIG8uYWN0aXZlLmxhc3QgPSAhMTsKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoZSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IGUgKiBwKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzID0gby5jaGlsZHJlbi5lcShjKS5wb3NpdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGggPSAiaG9yaXpvbnRhbCIgPT0gby5zZXR0aW5ncy5tb2RlID8gLShzLmxlZnQgLSBuKSA6IC1zLnRvcDsKICAgICAgICAgICAgICAgICAgICAgICAgeChoLCAic2xpZGUiLCBvLnNldHRpbmdzLnNwZWVkKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgci5nb1RvTmV4dFNsaWRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoby5zZXR0aW5ncy5pbmZpbml0ZUxvb3AgfHwgIW8uYWN0aXZlLmxhc3QpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IG8uYWN0aXZlLmluZGV4ICsgMTsKICAgICAgICAgICAgICAgICAgICByLmdvVG9TbGlkZSh0LCAibmV4dCIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHIuZ29Ub1ByZXZTbGlkZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKG8uc2V0dGluZ3MuaW5maW5pdGVMb29wIHx8IDAgIT0gby5hY3RpdmUuaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IG8uYWN0aXZlLmluZGV4IC0gMTsKICAgICAgICAgICAgICAgICAgICByLmdvVG9TbGlkZSh0LCAicHJldiIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHIuc3RhcnRBdXRvID0gZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgby5pbnRlcnZhbCB8fCAoby5pbnRlcnZhbCA9IHNldEludGVydmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICJuZXh0IiA9PSBvLnNldHRpbmdzLmF1dG9EaXJlY3Rpb24gPyByLmdvVG9OZXh0U2xpZGUoKSA6IHIuZ29Ub1ByZXZTbGlkZSgpCiAgICAgICAgICAgICAgICB9LCBvLnNldHRpbmdzLnBhdXNlKSwgby5zZXR0aW5ncy5hdXRvQ29udHJvbHMgJiYgMSAhPSB0ICYmIE0oInN0b3AiKSkKICAgICAgICAgICAgfSwgci5zdG9wQXV0byA9IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgIG8uaW50ZXJ2YWwgJiYgKGNsZWFySW50ZXJ2YWwoby5pbnRlcnZhbCksIG8uaW50ZXJ2YWwgPSBudWxsLCBvLnNldHRpbmdzLmF1dG9Db250cm9scyAmJiAxICE9IHQgJiYgTSgic3RhcnQiKSkKICAgICAgICAgICAgfSwgci5nZXRDdXJyZW50U2xpZGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvLmFjdGl2ZS5pbmRleAogICAgICAgICAgICB9LCByLmdldFNsaWRlQ291bnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvLmNoaWxkcmVuLmxlbmd0aAogICAgICAgICAgICB9LCByLmRlc3Ryb3lTbGlkZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIG8uaW5pdGlhbGl6ZWQgJiYgKG8uaW5pdGlhbGl6ZWQgPSAhMSwgdCgiLmJ4LWNsb25lIiwgdGhpcykucmVtb3ZlKCksIG8uY2hpbGRyZW4ucmVtb3ZlQXR0cigic3R5bGUiKSwgdGhpcy5yZW1vdmVBdHRyKCJzdHlsZSIpLnVud3JhcCgpLnVud3JhcCgpLCBvLmNvbnRyb2xzLmVsICYmIG8uY29udHJvbHMuZWwucmVtb3ZlKCksIG8uY29udHJvbHMubmV4dCAmJiBvLmNvbnRyb2xzLm5leHQucmVtb3ZlKCksIG8uY29udHJvbHMucHJldiAmJiBvLmNvbnRyb2xzLnByZXYucmVtb3ZlKCksIG8ucGFnZXJFbCAmJiBvLnBhZ2VyRWwucmVtb3ZlKCksIHQoIi5ieC1jYXB0aW9uIiwgdGhpcykucmVtb3ZlKCksIG8uY29udHJvbHMuYXV0b0VsICYmIG8uY29udHJvbHMuYXV0b0VsLnJlbW92ZSgpLCBjbGVhckludGVydmFsKG8uaW50ZXJ2YWwpLCB0KHdpbmRvdykudW5iaW5kKCJyZXNpemUiLCBPKSkKICAgICAgICAgICAgfSwgci5yZWxvYWRTbGlkZXIgPSBmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICB2b2lkIDAgIT0gdCAmJiAocyA9IHQpLCByLmRlc3Ryb3lTbGlkZXIoKSwgZCgpCiAgICAgICAgICAgIH0sIGQoKSwgdGhpcwogICAgICAgIH0KICAgIH0KfSkoalF1ZXJ5KSwKZnVuY3Rpb24odCwgZSkgewogICAgdmFyIGkgPSAiZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFJQUFBQUFBQVAvLy95d0FBQUFBQVFBQkFBQUNBVXdBT3c9PSI7CiAgICB0LmZuLmltYWdlc0xvYWRlZCA9IGZ1bmN0aW9uKG4pIHsKICAgICAgICBmdW5jdGlvbiBzKCkgewogICAgICAgICAgICB2YXIgZSA9IHQoZyksCiAgICAgICAgICAgICAgICBpID0gdChoKTsKICAgICAgICAgICAgYSAmJiAoaC5sZW5ndGggPyBhLnJlamVjdChkLCBlLCBpKSA6IGEucmVzb2x2ZShkKSksIHQuaXNGdW5jdGlvbihuKSAmJiBuLmNhbGwociwgZCwgZSwgaSkKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIG8oZSwgbikgewogICAgICAgICAgICBlLnNyYyA9PT0gaSB8fCAtMSAhPT0gdC5pbkFycmF5KGUsIGMpIHx8IChjLnB1c2goZSksIG4gPyBoLnB1c2goZSkgOiBnLnB1c2goZSksIHQuZGF0YShlLCAiaW1hZ2VzTG9hZGVkIiwgewogICAgICAgICAgICAgICAgaXNCcm9rZW46IG4sCiAgICAgICAgICAgICAgICBzcmM6IGUuc3JjCiAgICAgICAgICAgIH0pLCBsICYmIGEubm90aWZ5V2l0aCh0KGUpLCBbbiwgZCwgdChnKSwgdChoKV0pLCBkLmxlbmd0aCA9PT0gYy5sZW5ndGggJiYgKHNldFRpbWVvdXQocyksIGQudW5iaW5kKCIuaW1hZ2VzTG9hZGVkIikpKQogICAgICAgIH0KICAgICAgICB2YXIgciA9IHRoaXMsCiAgICAgICAgICAgIGEgPSB0LmlzRnVuY3Rpb24odC5EZWZlcnJlZCkgPyB0LkRlZmVycmVkKCkgOiAwLAogICAgICAgICAgICBsID0gdC5pc0Z1bmN0aW9uKGEubm90aWZ5KSwKICAgICAgICAgICAgZCA9IHIuZmluZCgiaW1nIikuYWRkKHIuZmlsdGVyKCJpbWciKSksCiAgICAgICAgICAgIGMgPSBbXSwKICAgICAgICAgICAgZyA9IFtdLAogICAgICAgICAgICBoID0gW107CiAgICAgICAgcmV0dXJuIHQuaXNQbGFpbk9iamVjdChuKSAmJiB0LmVhY2gobiwgZnVuY3Rpb24odCwgZSkgewogICAgICAgICAgICAiY2FsbGJhY2siID09PSB0ID8gbiA9IGUgOiBhICYmIGFbdF0oZSkKICAgICAgICB9KSwgZC5sZW5ndGggPyBkLmJpbmQoImxvYWQuaW1hZ2VzTG9hZGVkIGVycm9yLmltYWdlc0xvYWRlZCIsIGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgbyh0LnRhcmdldCwgImVycm9yIiA9PT0gdC50eXBlKQogICAgICAgIH0pLmVhY2goZnVuY3Rpb24obiwgcykgewogICAgICAgICAgICB2YXIgciA9IHMuc3JjLAogICAgICAgICAgICAgICAgYSA9IHQuZGF0YShzLCAiaW1hZ2VzTG9hZGVkIik7CiAgICAgICAgICAgIGEgJiYgYS5zcmMgPT09IHIgPyBvKHMsIGEuaXNCcm9rZW4pIDogcy5jb21wbGV0ZSAmJiBzLm5hdHVyYWxXaWR0aCAhPT0gZSA/IG8ocywgMCA9PT0gcy5uYXR1cmFsV2lkdGggfHwgMCA9PT0gcy5uYXR1cmFsSGVpZ2h0KSA6IChzLnJlYWR5U3RhdGUgfHwgcy5jb21wbGV0ZSkgJiYgKHMuc3JjID0gaSwgcy5zcmMgPSByKQogICAgICAgIH0pIDogcygpLCBhID8gYS5wcm9taXNlKHIpIDogcgogICAgfQp9KGpRdWVyeSk7CgoKLyoKCVByZXR0aWZ5IEpTCiovCnZhciBxID0gbnVsbDsKd2luZG93LlBSX1NIT1VMRF9VU0VfQ09OVElOVUFUSU9OID0gITA7CihmdW5jdGlvbigpIHsKICAgIGZ1bmN0aW9uIEwoYSkgewogICAgICAgIGZ1bmN0aW9uIG0oYSkgewogICAgICAgICAgICB2YXIgZiA9IGEuY2hhckNvZGVBdCgwKTsKICAgICAgICAgICAgaWYgKGYgIT09IDkyKSByZXR1cm4gZjsKICAgICAgICAgICAgdmFyIGIgPSBhLmNoYXJBdCgxKTsKICAgICAgICAgICAgcmV0dXJuIChmID0gcltiXSkgPyBmIDogIjAiIDw9IGIgJiYgYiA8PSAiNyIgPyBwYXJzZUludChhLnN1YnN0cmluZygxKSwgOCkgOiBiID09PSAidSIgfHwgYiA9PT0gIngiID8gcGFyc2VJbnQoYS5zdWJzdHJpbmcoMiksIDE2KSA6IGEuY2hhckNvZGVBdCgxKQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gZShhKSB7CiAgICAgICAgICAgIGlmIChhIDwgMzIpIHJldHVybiAoYSA8IDE2ID8gIlxceDAiIDogIlxceCIpICsgYS50b1N0cmluZygxNik7CiAgICAgICAgICAgIGEgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGEpOwogICAgICAgICAgICBpZiAoYSA9PT0gIlxcIiB8fCBhID09PSAiLSIgfHwgYSA9PT0gIlsiIHx8IGEgPT09ICJdIikgYSA9ICJcXCIgKyBhOwogICAgICAgICAgICByZXR1cm4gYQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaChhKSB7CiAgICAgICAgICAgIGZvciAodmFyIGYgPSBhLnN1YnN0cmluZygxLCBhLmxlbmd0aCAtIDEpLm1hdGNoKC9cXHVbXGRBLUZhLWZdezR9fFxceFtcZEEtRmEtZl17Mn18XFxbMC0zXVswLTddezAsMn18XFxbMC03XXsxLDJ9fFxcW1xTXHNdfFteXFxdL2cpLCBhID0gW10sIGIgPSBbXSwgbyA9IGZbMF0gPT09ICJeIiwgYyA9IG8gPyAxIDogMCwgaSA9IGYubGVuZ3RoOyBjIDwgaTsgKytjKSB7CiAgICAgICAgICAgICAgICB2YXIgaiA9IGZbY107CiAgICAgICAgICAgICAgICBpZiAoL1xcW2Jkc3ddL2kudGVzdChqKSkgYS5wdXNoKGopOwogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGogPSBtKGopLAogICAgICAgICAgICAgICAgICAgICAgICBkOwogICAgICAgICAgICAgICAgICAgIGMgKyAyIDwgaSAmJiAiLSIgPT09IGZbYyArIDFdID8gKGQgPSBtKGZbYyArIDJdKSwgYyArPSAyKSA6IGQgPSBqOwogICAgICAgICAgICAgICAgICAgIGIucHVzaChbaiwgZF0pOwogICAgICAgICAgICAgICAgICAgIGQgPCA2NSB8fCBqID4gMTIyIHx8IChkIDwgNjUgfHwgaiA+IDkwIHx8IGIucHVzaChbTWF0aC5tYXgoNjUsIGopIHwgMzIsIE1hdGgubWluKGQsIDkwKSB8IDMyXSksIGQgPCA5NyB8fCBqID4gMTIyIHx8IGIucHVzaChbTWF0aC5tYXgoOTcsIGopICYgLTMzLCBNYXRoLm1pbihkLCAxMjIpICYgLTMzXSkpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYi5zb3J0KGZ1bmN0aW9uKGEsIGYpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhWzBdIC0gZlswXSB8fCBmWzFdIC0gYVsxXQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZiA9IFtdOwogICAgICAgICAgICBqID0gW05hTiwgTmFOXTsKICAgICAgICAgICAgZm9yIChjID0gMDsgYyA8IGIubGVuZ3RoOyArK2MpIGkgPSBiW2NdLCBpWzBdIDw9IGpbMV0gKyAxID8galsxXSA9IE1hdGgubWF4KGpbMV0sIGlbMV0pIDogZi5wdXNoKGogPSBpKTsKICAgICAgICAgICAgYiA9IFsiWyJdOwogICAgICAgICAgICBvICYmIGIucHVzaCgiXiIpOwogICAgICAgICAgICBiLnB1c2guYXBwbHkoYiwgYSk7CiAgICAgICAgICAgIGZvciAoYyA9IDA7IGMgPAogICAgICAgICAgICAgICAgZi5sZW5ndGg7ICsrYykgaSA9IGZbY10sIGIucHVzaChlKGlbMF0pKSwgaVsxXSA+IGlbMF0gJiYgKGlbMV0gKyAxID4gaVswXSAmJiBiLnB1c2goIi0iKSwgYi5wdXNoKGUoaVsxXSkpKTsKICAgICAgICAgICAgYi5wdXNoKCJdIik7CiAgICAgICAgICAgIHJldHVybiBiLmpvaW4oIiIpCiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiB5KGEpIHsKICAgICAgICAgICAgZm9yICh2YXIgZiA9IGEuc291cmNlLm1hdGNoKC9cWyg/OlteXFxcXV18XFxbXFNcc10pKl18XFx1W1xkQS1GYS1mXXs0fXxcXHhbXGRBLUZhLWZdezJ9fFxcXGQrfFxcW15cZHV4XXxcKFw/WyE6PV18WygpXl18W14oKVtcXF5dKy9nKSwgYiA9IGYubGVuZ3RoLCBkID0gW10sIGMgPSAwLCBpID0gMDsgYyA8IGI7ICsrYykgewogICAgICAgICAgICAgICAgdmFyIGogPSBmW2NdOwogICAgICAgICAgICAgICAgaiA9PT0gIigiID8gKytpIDogIlxcIiA9PT0gai5jaGFyQXQoMCkgJiYgKGogPSArai5zdWJzdHJpbmcoMSkpICYmIGogPD0gaSAmJiAoZFtqXSA9IC0xKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoYyA9IDE7IGMgPCBkLmxlbmd0aDsgKytjKSAtIDEgPT09IGRbY10gJiYgKGRbY10gPSArK3QpOwogICAgICAgICAgICBmb3IgKGkgPSBjID0gMDsgYyA8IGI7ICsrYykgaiA9IGZbY10sIGogPT09ICIoIiA/ICgrK2ksIGRbaV0gPT09IHZvaWQgMCAmJiAoZltjXSA9ICIoPzoiKSkgOiAiXFwiID09PSBqLmNoYXJBdCgwKSAmJgogICAgICAgICAgICAgICAgKGogPSArai5zdWJzdHJpbmcoMSkpICYmIGogPD0gaSAmJiAoZltjXSA9ICJcXCIgKyBkW2ldKTsKICAgICAgICAgICAgZm9yIChpID0gYyA9IDA7IGMgPCBiOyArK2MpICJeIiA9PT0gZltjXSAmJiAiXiIgIT09IGZbYyArIDFdICYmIChmW2NdID0gIiIpOwogICAgICAgICAgICBpZiAoYS5pZ25vcmVDYXNlICYmIHMpCiAgICAgICAgICAgICAgICBmb3IgKGMgPSAwOyBjIDwgYjsgKytjKSBqID0gZltjXSwgYSA9IGouY2hhckF0KDApLCBqLmxlbmd0aCA+PSAyICYmIGEgPT09ICJbIiA/IGZbY10gPSBoKGopIDogYSAhPT0gIlxcIiAmJiAoZltjXSA9IGoucmVwbGFjZSgvW0EtWmEtel0vZywgZnVuY3Rpb24oYSkgewogICAgICAgICAgICAgICAgICAgIGEgPSBhLmNoYXJDb2RlQXQoMCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJbIiArIFN0cmluZy5mcm9tQ2hhckNvZGUoYSAmIC0zMywgYSB8IDMyKSArICJdIgogICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICByZXR1cm4gZi5qb2luKCIiKQogICAgICAgIH0KICAgICAgICBmb3IgKHZhciB0ID0gMCwgcyA9ICExLCBsID0gITEsIHAgPSAwLCBkID0gYS5sZW5ndGg7IHAgPCBkOyArK3ApIHsKICAgICAgICAgICAgdmFyIGcgPSBhW3BdOwogICAgICAgICAgICBpZiAoZy5pZ25vcmVDYXNlKSBsID0gITA7CiAgICAgICAgICAgIGVsc2UgaWYgKC9bYS16XS9pLnRlc3QoZy5zb3VyY2UucmVwbGFjZSgvXFx1W1xkYS1mXXs0fXxcXHhbXGRhLWZdezJ9fFxcW15VWHV4XS9naSwgIiIpKSkgewogICAgICAgICAgICAgICAgcyA9ICEwOwogICAgICAgICAgICAgICAgbCA9ICExOwogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKHZhciByID0gewogICAgICAgICAgICBiOiA4LAogICAgICAgICAgICB0OiA5LAogICAgICAgICAgICBuOiAxMCwKICAgICAgICAgICAgdjogMTEsCiAgICAgICAgICAgIGY6IDEyLAogICAgICAgICAgICByOiAxMwogICAgICAgIH0sIG4gPSBbXSwgcCA9IDAsIGQgPSBhLmxlbmd0aDsgcCA8IGQ7ICsrcCkgewogICAgICAgICAgICBnID0gYVtwXTsKICAgICAgICAgICAgaWYgKGcuZ2xvYmFsIHx8IGcubXVsdGlsaW5lKSB0aHJvdyBFcnJvcigiIiArIGcpOwogICAgICAgICAgICBuLnB1c2goIig/OiIgKyB5KGcpICsgIikiKQogICAgICAgIH0KICAgICAgICByZXR1cm4gUmVnRXhwKG4uam9pbigifCIpLCBsID8gImdpIiA6ICJnIikKICAgIH0KCiAgICBmdW5jdGlvbiBNKGEpIHsKICAgICAgICBmdW5jdGlvbiBtKGEpIHsKICAgICAgICAgICAgc3dpdGNoIChhLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgaWYgKGUudGVzdChhLmNsYXNzTmFtZSkpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGcgPSBhLmZpcnN0Q2hpbGQ7IGc7IGcgPSBnLm5leHRTaWJsaW5nKSBtKGcpOwogICAgICAgICAgICAgICAgICAgIGcgPSBhLm5vZGVOYW1lOwogICAgICAgICAgICAgICAgICAgIGlmICgiQlIiID09PSBnIHx8ICJMSSIgPT09IGcpIGhbc10gPSAiXG4iLCB0W3MgPDwgMV0gPSB5KyssIHRbcysrIDw8IDEgfCAxXSA9IGE7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgICAgZyA9IGEubm9kZVZhbHVlLCBnLmxlbmd0aCAmJiAoZyA9IHAgPyBnLnJlcGxhY2UoL1xyXG4/L2csICJcbiIpIDogZy5yZXBsYWNlKC9bXHRcblxyIF0rL2csICIgIiksIGhbc10gPSBnLCB0W3MgPDwgMV0gPSB5LCB5ICs9IGcubGVuZ3RoLAogICAgICAgICAgICAgICAgICAgICAgICB0W3MrKyA8PCAxIHwgMV0gPSBhKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBlID0gLyg/Ol58XHMpbm9jb2RlKD86XHN8JCkvLAogICAgICAgICAgICBoID0gW10sCiAgICAgICAgICAgIHkgPSAwLAogICAgICAgICAgICB0ID0gW10sCiAgICAgICAgICAgIHMgPSAwLAogICAgICAgICAgICBsOwogICAgICAgIGEuY3VycmVudFN0eWxlID8gbCA9IGEuY3VycmVudFN0eWxlLndoaXRlU3BhY2UgOiB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSAmJiAobCA9IGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoYSwgcSkuZ2V0UHJvcGVydHlWYWx1ZSgid2hpdGUtc3BhY2UiKSk7CiAgICAgICAgdmFyIHAgPSBsICYmICJwcmUiID09PSBsLnN1YnN0cmluZygwLCAzKTsKICAgICAgICBtKGEpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGE6IGguam9pbigiIikucmVwbGFjZSgvXG4kLywgIiIpLAogICAgICAgICAgICBjOiB0CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIEIoYSwgbSwgZSwgaCkgewogICAgICAgIG0gJiYgKGEgPSB7CiAgICAgICAgICAgIGE6IG0sCiAgICAgICAgICAgIGQ6IGEKICAgICAgICB9LCBlKGEpLCBoLnB1c2guYXBwbHkoaCwgYS5lKSkKICAgIH0KCiAgICBmdW5jdGlvbiB4KGEsIG0pIHsKICAgICAgICBmdW5jdGlvbiBlKGEpIHsKICAgICAgICAgICAgZm9yICh2YXIgbCA9IGEuZCwgcCA9IFtsLCAicGxuIl0sIGQgPSAwLCBnID0gYS5hLm1hdGNoKHkpIHx8IFtdLCByID0ge30sIG4gPSAwLCB6ID0gZy5sZW5ndGg7IG4gPCB6OyArK24pIHsKICAgICAgICAgICAgICAgIHZhciBmID0gZ1tuXSwKICAgICAgICAgICAgICAgICAgICBiID0gcltmXSwKICAgICAgICAgICAgICAgICAgICBvID0gdm9pZCAwLAogICAgICAgICAgICAgICAgICAgIGM7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGIgPT09CiAgICAgICAgICAgICAgICAgICAgInN0cmluZyIpIGMgPSAhMTsKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBpID0gaFtmLmNoYXJBdCgwKV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGkpIG8gPSBmLm1hdGNoKGlbMV0pLCBiID0gaVswXTsKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjID0gMDsgYyA8IHQ7ICsrYykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpID0gbVtjXSwgbyA9IGYubWF0Y2goaVsxXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiID0gaVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBvIHx8IChiID0gInBsbiIpCiAgICAgICAgICAgICAgICAgICAgfSBpZiAoKGMgPSBiLmxlbmd0aCA+PSA1ICYmICJsYW5nLSIgPT09IGIuc3Vic3RyaW5nKDAsIDUpKSAmJiAhKG8gJiYgdHlwZW9mIG9bMV0gPT09ICJzdHJpbmciKSkgYyA9ICExLCBiID0gInNyYyI7CiAgICAgICAgICAgICAgICAgICAgYyB8fCAocltmXSA9IGIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpID0gZDsKICAgICAgICAgICAgICAgIGQgKz0gZi5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAoYykgewogICAgICAgICAgICAgICAgICAgIGMgPSBvWzFdOwogICAgICAgICAgICAgICAgICAgIHZhciBqID0gZi5pbmRleE9mKGMpLAogICAgICAgICAgICAgICAgICAgICAgICBrID0gaiArIGMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIG9bMl0gJiYgKGsgPSBmLmxlbmd0aCAtIG9bMl0ubGVuZ3RoLCBqID0gayAtIGMubGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICBiID0gYi5zdWJzdHJpbmcoNSk7CiAgICAgICAgICAgICAgICAgICAgQihsICsgaSwgZi5zdWJzdHJpbmcoMCwgaiksIGUsIHApOwogICAgICAgICAgICAgICAgICAgIEIobCArIGkgKyBqLCBjLCBDKGIsIGMpLCBwKTsKICAgICAgICAgICAgICAgICAgICBCKGwgKyBpICsgaywgZi5zdWJzdHJpbmcoayksIGUsIHApCiAgICAgICAgICAgICAgICB9IGVsc2UgcC5wdXNoKGwgKyBpLCBiKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGEuZSA9IHAKICAgICAgICB9CiAgICAgICAgdmFyIGggPSB7fSwgeTsKICAgICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGZvciAodmFyIGUgPSBhLmNvbmNhdChtKSwKICAgICAgICAgICAgICAgICAgICBsID0gW10sIHAgPSB7fSwgZCA9IDAsIGcgPSBlLmxlbmd0aDsgZCA8IGc7ICsrZCkgewogICAgICAgICAgICAgICAgdmFyIHIgPSBlW2RdLAogICAgICAgICAgICAgICAgICAgIG4gPSByWzNdOwogICAgICAgICAgICAgICAgaWYgKG4pCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IG4ubGVuZ3RoOyAtLWsgPj0gMDspIGhbbi5jaGFyQXQoayldID0gcjsKICAgICAgICAgICAgICAgIHIgPSByWzFdOwogICAgICAgICAgICAgICAgbiA9ICIiICsgcjsKICAgICAgICAgICAgICAgIHAuaGFzT3duUHJvcGVydHkobikgfHwgKGwucHVzaChyKSwgcFtuXSA9IHEpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgbC5wdXNoKC9bXFNcc10vKTsKICAgICAgICAgICAgeSA9IEwobCkKICAgICAgICB9KSgpOwogICAgICAgIHZhciB0ID0gbS5sZW5ndGg7CiAgICAgICAgcmV0dXJuIGUKICAgIH0KCiAgICBmdW5jdGlvbiB1KGEpIHsKICAgICAgICB2YXIgbSA9IFtdLAogICAgICAgICAgICBlID0gW107CiAgICAgICAgYS50cmlwbGVRdW90ZWRTdHJpbmdzID8gbS5wdXNoKFsic3RyIiwgL14oPzonJycoPzpbXidcXF18XFxbXFNcc118Jyc/KD89W14nXSkpKig/OicnJ3wkKXwiIiIoPzpbXiJcXF18XFxbXFNcc118IiI/KD89W14iXSkpKig/OiIiInwkKXwnKD86W14nXFxdfFxcW1xTXHNdKSooPzonfCQpfCIoPzpbXiJcXF18XFxbXFNcc10pKig/OiJ8JCkpLywgcSwgIidcIiJdKSA6IGEubXVsdGlMaW5lU3RyaW5ncyA/IG0ucHVzaChbInN0ciIsIC9eKD86Jyg/OlteJ1xcXXxcXFtcU1xzXSkqKD86J3wkKXwiKD86W14iXFxdfFxcW1xTXHNdKSooPzoifCQpfGAoPzpbXlxcYF18XFxbXFNcc10pKig/OmB8JCkpLywKICAgICAgICAgICAgcSwgIidcImAiCiAgICAgICAgXSkgOiBtLnB1c2goWyJzdHIiLCAvXig/OicoPzpbXlxuXHInXFxdfFxcLikqKD86J3wkKXwiKD86W15cblxyIlxcXXxcXC4pKig/OiJ8JCkpLywgcSwgIlwiJyJdKTsKICAgICAgICBhLnZlcmJhdGltU3RyaW5ncyAmJiBlLnB1c2goWyJzdHIiLCAvXkAiKD86W14iXXwiIikqKD86InwkKS8sIHFdKTsKICAgICAgICB2YXIgaCA9IGEuaGFzaENvbW1lbnRzOwogICAgICAgIGggJiYgKGEuY1N0eWxlQ29tbWVudHMgPyAoaCA+IDEgPyBtLnB1c2goWyJjb20iLCAvXiMoPzojIyg/OlteI118Iyg/ISMjKSkqKD86IyMjfCQpfC4qKS8sIHEsICIjIl0pIDogbS5wdXNoKFsiY29tIiwgL14jKD86KD86ZGVmaW5lfGVsaWZ8ZWxzZXxlbmRpZnxlcnJvcnxpZmRlZnxpbmNsdWRlfGlmbmRlZnxsaW5lfHByYWdtYXx1bmRlZnx3YXJuaW5nKVxifFteXG5ccl0qKS8sIHEsICIjIl0pLCBlLnB1c2goWyJzdHIiLCAvXjwoPzooPzooPzpcLlwuXC8pKnxcLz8pKD86W1x3LV0rKD86XC9bXHctXSspKyk/W1x3LV0rXC5ofFthLXpdXHcqKT4vLCBxXSkpIDogbS5wdXNoKFsiY29tIiwgL14jW15cblxyXSovLAogICAgICAgICAgICBxLCAiIyIKICAgICAgICBdKSk7CiAgICAgICAgYS5jU3R5bGVDb21tZW50cyAmJiAoZS5wdXNoKFsiY29tIiwgL15cL1wvW15cblxyXSovLCBxXSksIGUucHVzaChbImNvbSIsIC9eXC9cKltcU1xzXSo/KD86XCpcL3wkKS8sIHFdKSk7CiAgICAgICAgYS5yZWdleExpdGVyYWxzICYmIGUucHVzaChbImxhbmctcmVnZXgiLCAvXig/Ol5eXC4/fFshKy1dfCE9fCE9PXwjfCV8JT18JnwmJnwmJj18Jj18XCh8XCp8XCo9fFwrPXwsfC09fC0+fFwvfFwvPXw6fDo6fDt8PHw8PHw8PD18PD18PXw9PXw9PT18Pnw+PXw+Pnw+Pj18Pj4+fD4+Pj18Wz9AW15dfFxePXxcXlxefFxeXF49fHt8XHx8XHw9fFx8XHx8XHxcfD18fnxicmVha3xjYXNlfGNvbnRpbnVlfGRlbGV0ZXxkb3xlbHNlfGZpbmFsbHl8aW5zdGFuY2VvZnxyZXR1cm58dGhyb3d8dHJ5fHR5cGVvZilccyooXC8oPz1bXiovXSkoPzpbXi9bXFxdfFxcW1xTXHNdfFxbKD86W15cXFxdXXxcXFtcU1xzXSkqKD86XXwkKSkrXC8pL10pOwogICAgICAgIChoID0gYS50eXBlcykgJiYgZS5wdXNoKFsidHlwIiwgaF0pOwogICAgICAgIGEgPSAoIiIgKyBhLmtleXdvcmRzKS5yZXBsYWNlKC9eIHwgJC9nLAogICAgICAgICAgICAiIik7CiAgICAgICAgYS5sZW5ndGggJiYgZS5wdXNoKFsia3dkIiwgUmVnRXhwKCJeKD86IiArIGEucmVwbGFjZSgvW1xzLF0rL2csICJ8IikgKyAiKVxcYiIpLCBxXSk7CiAgICAgICAgbS5wdXNoKFsicGxuIiwgL15ccysvLCBxLCAiIFxyXG5cdFx4YTAiXSk7CiAgICAgICAgZS5wdXNoKFsibGl0IiwgL15AWyRfYS16XVtcdyRAXSovaSwgcV0sIFsidHlwIiwgL14oPzpbQF9dP1tBLVpdK1thLXpdW1x3JEBdKnxcdytfdFxiKS8sIHFdLCBbInBsbiIsIC9eWyRfYS16XVtcdyRAXSovaSwgcV0sIFsibGl0IiwgL14oPzoweFtcZGEtZl0rfCg/OlxkKD86X1xkKykqXGQqKD86XC5cZCopP3xcLlxkXCspKD86ZVsrLV0/XGQrKT8pW2Etel0qL2ksIHEsICIwMTIzNDU2Nzg5Il0sIFsicGxuIiwgL15cXFtcU1xzXT8vLCBxXSwgWyJwdW4iLCAvXi5bXlxzXHciLSQnLi9AXFxgXSovLCBxXSk7CiAgICAgICAgcmV0dXJuIHgobSwgZSkKICAgIH0KCiAgICBmdW5jdGlvbiBEKGEsIG0pIHsKICAgICAgICBmdW5jdGlvbiBlKGEpIHsKICAgICAgICAgICAgc3dpdGNoIChhLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgaWYgKGsudGVzdChhLmNsYXNzTmFtZSkpIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGlmICgiQlIiID09PSBhLm5vZGVOYW1lKSBoKGEpLAogICAgICAgICAgICAgICAgICAgIGEucGFyZW50Tm9kZSAmJiBhLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGEgPSBhLmZpcnN0Q2hpbGQ7IGE7IGEgPSBhLm5leHRTaWJsaW5nKSBlKGEpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiID0gYS5ub2RlVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkID0gYi5tYXRjaCh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjID0gYi5zdWJzdHJpbmcoMCwgZC5pbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLm5vZGVWYWx1ZSA9IGM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYiA9IGIuc3Vic3RyaW5nKGQuaW5kZXggKyBkWzBdLmxlbmd0aCkpICYmIGEucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUocy5jcmVhdGVUZXh0Tm9kZShiKSwgYS5uZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoKGEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYyB8fCBhLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoYSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gaChhKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIGIoYSwgZCkgewogICAgICAgICAgICAgICAgdmFyIGUgPSBkID8gYS5jbG9uZU5vZGUoITEpIDogYSwKICAgICAgICAgICAgICAgICAgICBmID0gYS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgaWYgKGYpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZiA9IGIoZiwgMSksCiAgICAgICAgICAgICAgICAgICAgICAgIGcgPSBhLm5leHRTaWJsaW5nOwogICAgICAgICAgICAgICAgICAgIGYuYXBwZW5kQ2hpbGQoZSk7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaCA9IGc7IGg7IGggPSBnKSBnID0gaC5uZXh0U2libGluZywgZi5hcHBlbmRDaGlsZChoKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGUKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKDsgIWEubmV4dFNpYmxpbmc7KQogICAgICAgICAgICAgICAgaWYgKGEgPSBhLnBhcmVudE5vZGUsICFhKSByZXR1cm47CiAgICAgICAgICAgIGZvciAodmFyIGEgPSBiKGEubmV4dFNpYmxpbmcsIDApLCBlOwogICAgICAgICAgICAgICAgKGUgPSBhLnBhcmVudE5vZGUpICYmIGUubm9kZVR5cGUgPT09IDE7KSBhID0gZTsKICAgICAgICAgICAgZC5wdXNoKGEpCiAgICAgICAgfQogICAgICAgIHZhciBrID0gLyg/Ol58XHMpbm9jb2RlKD86XHN8JCkvLAogICAgICAgICAgICB0ID0gL1xyXG4/fFxuLywKICAgICAgICAgICAgcyA9IGEub3duZXJEb2N1bWVudCwKICAgICAgICAgICAgbDsKICAgICAgICBhLmN1cnJlbnRTdHlsZSA/IGwgPSBhLmN1cnJlbnRTdHlsZS53aGl0ZVNwYWNlIDogd2luZG93LmdldENvbXB1dGVkU3R5bGUgJiYgKGwgPSBzLmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUoYSwgcSkuZ2V0UHJvcGVydHlWYWx1ZSgid2hpdGUtc3BhY2UiKSk7CiAgICAgICAgdmFyIHAgPSBsICYmICJwcmUiID09PSBsLnN1YnN0cmluZygwLCAzKTsKICAgICAgICBmb3IgKGwgPSBzLmNyZWF0ZUVsZW1lbnQoIkxJIik7IGEuZmlyc3RDaGlsZDspIGwuYXBwZW5kQ2hpbGQoYS5maXJzdENoaWxkKTsKICAgICAgICBmb3IgKHZhciBkID0gW2xdLCBnID0gMDsgZyA8IGQubGVuZ3RoOyArK2cpIGUoZFtnXSk7CiAgICAgICAgbSA9PT0gKG0gfCAwKSAmJiBkWzBdLnNldEF0dHJpYnV0ZSgidmFsdWUiLAogICAgICAgICAgICBtKTsKICAgICAgICB2YXIgciA9IHMuY3JlYXRlRWxlbWVudCgiT0wiKTsKICAgICAgICByLmNsYXNzTmFtZSA9ICJsaW5lbnVtcyI7CiAgICAgICAgZm9yICh2YXIgbiA9IE1hdGgubWF4KDAsIG0gLSAxIHwgMCkgfHwgMCwgZyA9IDAsIHogPSBkLmxlbmd0aDsgZyA8IHo7ICsrZykgbCA9IGRbZ10sIGwuY2xhc3NOYW1lID0gIkwiICsgKGcgKyBuKSAlIDEwLCBsLmZpcnN0Q2hpbGQgfHwgbC5hcHBlbmRDaGlsZChzLmNyZWF0ZVRleHROb2RlKCJceGEwIikpLCByLmFwcGVuZENoaWxkKGwpOwogICAgICAgIGEuYXBwZW5kQ2hpbGQocikKICAgIH0KCiAgICBmdW5jdGlvbiBrKGEsIG0pIHsKICAgICAgICBmb3IgKHZhciBlID0gbS5sZW5ndGg7IC0tZSA+PSAwOykgewogICAgICAgICAgICB2YXIgaCA9IG1bZV07CiAgICAgICAgICAgIEEuaGFzT3duUHJvcGVydHkoaCkgPyB3aW5kb3cuY29uc29sZSAmJiBjb25zb2xlLndhcm4oImNhbm5vdCBvdmVycmlkZSBsYW5ndWFnZSBoYW5kbGVyICVzIiwgaCkgOiBBW2hdID0gYQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBDKGEsIG0pIHsKICAgICAgICBpZiAoIWEgfHwgIUEuaGFzT3duUHJvcGVydHkoYSkpIGEgPSAvXlxzKjwvLnRlc3QobSkgPyAiZGVmYXVsdC1tYXJrdXAiIDogImRlZmF1bHQtY29kZSI7CiAgICAgICAgcmV0dXJuIEFbYV0KICAgIH0KCiAgICBmdW5jdGlvbiBFKGEpIHsKICAgICAgICB2YXIgbSA9CiAgICAgICAgICAgIGEuZzsKICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgZSA9IE0oYS5oKSwKICAgICAgICAgICAgICAgIGggPSBlLmE7CiAgICAgICAgICAgIGEuYSA9IGg7CiAgICAgICAgICAgIGEuYyA9IGUuYzsKICAgICAgICAgICAgYS5kID0gMDsKICAgICAgICAgICAgQyhtLCBoKShhKTsKICAgICAgICAgICAgdmFyIGsgPSAvXGJNU0lFXGIvLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCksCiAgICAgICAgICAgICAgICBtID0gL1xuL2csCiAgICAgICAgICAgICAgICB0ID0gYS5hLAogICAgICAgICAgICAgICAgcyA9IHQubGVuZ3RoLAogICAgICAgICAgICAgICAgZSA9IDAsCiAgICAgICAgICAgICAgICBsID0gYS5jLAogICAgICAgICAgICAgICAgcCA9IGwubGVuZ3RoLAogICAgICAgICAgICAgICAgaCA9IDAsCiAgICAgICAgICAgICAgICBkID0gYS5lLAogICAgICAgICAgICAgICAgZyA9IGQubGVuZ3RoLAogICAgICAgICAgICAgICAgYSA9IDA7CiAgICAgICAgICAgIGRbZ10gPSBzOwogICAgICAgICAgICB2YXIgciwgbjsKICAgICAgICAgICAgZm9yIChuID0gciA9IDA7IG4gPCBnOykgZFtuXSAhPT0gZFtuICsgMl0gPyAoZFtyKytdID0gZFtuKytdLCBkW3IrK10gPSBkW24rK10pIDogbiArPSAyOwogICAgICAgICAgICBnID0gcjsKICAgICAgICAgICAgZm9yIChuID0gciA9IDA7IG4gPCBnOykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgeiA9IGRbbl0sIGYgPSBkW24gKyAxXSwgYiA9IG4gKyAyOyBiICsgMiA8PSBnICYmIGRbYiArIDFdID09PSBmOykgYiArPSAyOwogICAgICAgICAgICAgICAgZFtyKytdID0gejsKICAgICAgICAgICAgICAgIGRbcisrXSA9IGY7CiAgICAgICAgICAgICAgICBuID0gYgogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAoZC5sZW5ndGggPSByOyBoIDwgcDspIHsKICAgICAgICAgICAgICAgIHZhciBvID0gbFtoICsgMl0gfHwgcywKICAgICAgICAgICAgICAgICAgICBjID0gZFthICsgMl0gfHwgcywKICAgICAgICAgICAgICAgICAgICBiID0gTWF0aC5taW4obywgYyksCiAgICAgICAgICAgICAgICAgICAgaSA9IGxbaCArIDFdLAogICAgICAgICAgICAgICAgICAgIGo7CiAgICAgICAgICAgICAgICBpZiAoaS5ub2RlVHlwZSAhPT0gMSAmJiAoaiA9IHQuc3Vic3RyaW5nKGUsIGIpKSkgewogICAgICAgICAgICAgICAgICAgIGsgJiYgKGogPSBqLnJlcGxhY2UobSwgIlxyIikpOwogICAgICAgICAgICAgICAgICAgIGkubm9kZVZhbHVlID0KICAgICAgICAgICAgICAgICAgICAgICAgajsKICAgICAgICAgICAgICAgICAgICB2YXIgdSA9IGkub3duZXJEb2N1bWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHUuY3JlYXRlRWxlbWVudCgiU1BBTiIpOwogICAgICAgICAgICAgICAgICAgIHYuY2xhc3NOYW1lID0gZFthICsgMV07CiAgICAgICAgICAgICAgICAgICAgdmFyIHggPSBpLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgeC5yZXBsYWNlQ2hpbGQodiwgaSk7CiAgICAgICAgICAgICAgICAgICAgdi5hcHBlbmRDaGlsZChpKTsKICAgICAgICAgICAgICAgICAgICBlIDwgbyAmJiAobFtoICsgMV0gPSBpID0gdS5jcmVhdGVUZXh0Tm9kZSh0LnN1YnN0cmluZyhiLCBvKSksIHguaW5zZXJ0QmVmb3JlKGksIHYubmV4dFNpYmxpbmcpKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZSA9IGI7CiAgICAgICAgICAgICAgICBlID49IG8gJiYgKGggKz0gMik7CiAgICAgICAgICAgICAgICBlID49IGMgJiYgKGEgKz0gMikKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKHcpIHsKICAgICAgICAgICAgImNvbnNvbGUiIGluIHdpbmRvdyAmJiBjb25zb2xlLmxvZyh3ICYmIHcuc3RhY2sgPyB3LnN0YWNrIDogdykKICAgICAgICB9CiAgICB9CiAgICB2YXIgdiA9IFsiYnJlYWssY29udGludWUsZG8sZWxzZSxmb3IsaWYscmV0dXJuLHdoaWxlIl0sCiAgICAgICAgdyA9IFsKICAgICAgICAgICAgW3YsICJhdXRvLGNhc2UsY2hhcixjb25zdCxkZWZhdWx0LGRvdWJsZSxlbnVtLGV4dGVybixmbG9hdCxnb3RvLGludCxsb25nLHJlZ2lzdGVyLHNob3J0LHNpZ25lZCxzaXplb2Ysc3RhdGljLHN0cnVjdCxzd2l0Y2gsdHlwZWRlZix1bmlvbix1bnNpZ25lZCx2b2lkLHZvbGF0aWxlIl0sCiAgICAgICAgICAgICJjYXRjaCxjbGFzcyxkZWxldGUsZmFsc2UsaW1wb3J0LG5ldyxvcGVyYXRvcixwcml2YXRlLHByb3RlY3RlZCxwdWJsaWMsdGhpcyx0aHJvdyx0cnVlLHRyeSx0eXBlb2YiCiAgICAgICAgXSwKICAgICAgICBGID0gW3csICJhbGlnbm9mLGFsaWduX3VuaW9uLGFzbSxheGlvbSxib29sLGNvbmNlcHQsY29uY2VwdF9tYXAsY29uc3RfY2FzdCxjb25zdGV4cHIsZGVjbHR5cGUsZHluYW1pY19jYXN0LGV4cGxpY2l0LGV4cG9ydCxmcmllbmQsaW5saW5lLGxhdGVfY2hlY2ssbXV0YWJsZSxuYW1lc3BhY2UsbnVsbHB0cixyZWludGVycHJldF9jYXN0LHN0YXRpY19hc3NlcnQsc3RhdGljX2Nhc3QsdGVtcGxhdGUsdHlwZWlkLHR5cGVuYW1lLHVzaW5nLHZpcnR1YWwsd2hlcmUiXSwKICAgICAgICBHID0gW3csICJhYnN0cmFjdCxib29sZWFuLGJ5dGUsZXh0ZW5kcyxmaW5hbCxmaW5hbGx5LGltcGxlbWVudHMsaW1wb3J0LGluc3RhbmNlb2YsbnVsbCxuYXRpdmUscGFja2FnZSxzdHJpY3RmcCxzdXBlcixzeW5jaHJvbml6ZWQsdGhyb3dzLHRyYW5zaWVudCJdLAogICAgICAgIEggPSBbRywgImFzLGJhc2UsYnksY2hlY2tlZCxkZWNpbWFsLGRlbGVnYXRlLGRlc2NlbmRpbmcsZHluYW1pYyxldmVudCxmaXhlZCxmb3JlYWNoLGZyb20sZ3JvdXAsaW1wbGljaXQsaW4saW50ZXJmYWNlLGludGVybmFsLGludG8saXMsbG9jayxvYmplY3Qsb3V0LG92ZXJyaWRlLG9yZGVyYnkscGFyYW1zLHBhcnRpYWwscmVhZG9ubHkscmVmLHNieXRlLHNlYWxlZCxzdGFja2FsbG9jLHN0cmluZyxzZWxlY3QsdWludCx1bG9uZyx1bmNoZWNrZWQsdW5zYWZlLHVzaG9ydCx2YXIiXSwKICAgICAgICB3ID0gW3csICJkZWJ1Z2dlcixldmFsLGV4cG9ydCxmdW5jdGlvbixnZXQsbnVsbCxzZXQsdW5kZWZpbmVkLHZhcix3aXRoLEluZmluaXR5LE5hTiJdLAogICAgICAgIEkgPSBbdiwgImFuZCxhcyxhc3NlcnQsY2xhc3MsZGVmLGRlbCxlbGlmLGV4Y2VwdCxleGVjLGZpbmFsbHksZnJvbSxnbG9iYWwsaW1wb3J0LGluLGlzLGxhbWJkYSxub25sb2NhbCxub3Qsb3IscGFzcyxwcmludCxyYWlzZSx0cnksd2l0aCx5aWVsZCxGYWxzZSxUcnVlLE5vbmUiXSwKICAgICAgICBKID0gW3YsICJhbGlhcyxhbmQsYmVnaW4sY2FzZSxjbGFzcyxkZWYsZGVmaW5lZCxlbHNpZixlbmQsZW5zdXJlLGZhbHNlLGluLG1vZHVsZSxuZXh0LG5pbCxub3Qsb3IscmVkbyxyZXNjdWUscmV0cnksc2VsZixzdXBlcix0aGVuLHRydWUsdW5kZWYsdW5sZXNzLHVudGlsLHdoZW4seWllbGQsQkVHSU4sRU5EIl0sCiAgICAgICAgdiA9IFt2LCAiY2FzZSxkb25lLGVsaWYsZXNhYyxldmFsLGZpLGZ1bmN0aW9uLGluLGxvY2FsLHNldCx0aGVuLHVudGlsIl0sCiAgICAgICAgSyA9IC9eKERJUnxGSUxFfHZlY3RvcnwoZGV8cHJpb3JpdHlfKT9xdWV1ZXxsaXN0fHN0YWNrfChjb25zdF8pP2l0ZXJhdG9yfChtdWx0aSk/KHNldHxtYXApfGJpdHNldHx1PyhpbnR8ZmxvYXQpXGQqKS8sCiAgICAgICAgTiA9IC9cUy8sCiAgICAgICAgTyA9IHUoewogICAgICAgICAgICBrZXl3b3JkczogW0YsIEgsIHcsICJjYWxsZXIsZGVsZXRlLGRpZSxkbyxkdW1wLGVsc2lmLGV2YWwsZXhpdCxmb3JlYWNoLGZvcixnb3RvLGlmLGltcG9ydCxsYXN0LGxvY2FsLG15LG5leHQsbm8sb3VyLHByaW50LHBhY2thZ2UscmVkbyxyZXF1aXJlLHN1Yix1bmRlZix1bmxlc3MsdW50aWwsdXNlLHdhbnRhcnJheSx3aGlsZSxCRUdJTixFTkQiICsKICAgICAgICAgICAgICAgIEksIEosIHYKICAgICAgICAgICAgXSwKICAgICAgICAgICAgaGFzaENvbW1lbnRzOiAhMCwKICAgICAgICAgICAgY1N0eWxlQ29tbWVudHM6ICEwLAogICAgICAgICAgICBtdWx0aUxpbmVTdHJpbmdzOiAhMCwKICAgICAgICAgICAgcmVnZXhMaXRlcmFsczogITAKICAgICAgICB9KSwKICAgICAgICBBID0ge307CiAgICBrKE8sIFsiZGVmYXVsdC1jb2RlIl0pOwogICAgayh4KFtdLCBbCiAgICAgICAgWyJwbG4iLCAvXltePD9dKy9dLAogICAgICAgIFsiZGVjIiwgL148IVx3W14+XSooPzo+fCQpL10sCiAgICAgICAgWyJjb20iLCAvXjxcIS0tW1xTXHNdKj8oPzotLVw+fCQpL10sCiAgICAgICAgWyJsYW5nLSIsIC9ePFw/KFtcU1xzXSs/KSg/Olw/PnwkKS9dLAogICAgICAgIFsibGFuZy0iLCAvXjwlKFtcU1xzXSs/KSg/OiU+fCQpL10sCiAgICAgICAgWyJwdW4iLCAvXig/OjxbJT9dfFslP10+KS9dLAogICAgICAgIFsibGFuZy0iLCAvXjx4bXBcYltePl0qPihbXFNcc10rPyk8XC94bXBcYltePl0qPi9pXSwKICAgICAgICBbImxhbmctanMiLCAvXjxzY3JpcHRcYltePl0qPihbXFNcc10qPykoPFwvc2NyaXB0XGJbXj5dKj4pL2ldLAogICAgICAgIFsibGFuZy1jc3MiLCAvXjxzdHlsZVxiW14+XSo+KFtcU1xzXSo/KSg8XC9zdHlsZVxiW14+XSo+KS9pXSwKICAgICAgICBbImxhbmctaW4udGFnIiwgL14oPFwvP1thLXpdW148Pl0qPikvaV0KICAgIF0pLCBbImRlZmF1bHQtbWFya3VwIiwgImh0bSIsICJodG1sIiwgIm14bWwiLCAieGh0bWwiLCAieG1sIiwgInhzbCJdKTsKICAgIGsoeChbCiAgICAgICAgWyJwbG4iLCAvXlxzKy8sIHEsICIgXHRcclxuIl0sCiAgICAgICAgWyJhdHYiLCAvXig/OiJbXiJdKiI/fCdbXiddKic/KS8sIHEsICJcIiciXQogICAgXSwgWwogICAgICAgIFsidGFnIiwgL15ePFwvP1thLXpdKD86W1x3LS46XSpcdyk/fFwvPz4kL2ldLAogICAgICAgIFsiYXRuIiwgL14oPyFzdHlsZVtccz1dfG9uKVthLXpdKD86W1x3Oi1dKlx3KT8vaV0sCiAgICAgICAgWyJsYW5nLXVxLnZhbCIsIC9ePVxzKihbXlxzIic+XSooPzpbXlxzIicvPl18XC8oPz1ccykpKS9dLAogICAgICAgIFsicHVuIiwgL15bLzwtPl0rL10sCiAgICAgICAgWyJsYW5nLWpzIiwgL15vblx3K1xzKj1ccyoiKFteIl0rKSIvaV0sCiAgICAgICAgWyJsYW5nLWpzIiwgL15vblx3K1xzKj1ccyonKFteJ10rKScvaV0sCiAgICAgICAgWyJsYW5nLWpzIiwgL15vblx3K1xzKj1ccyooW15ccyInPl0rKS9pXSwKICAgICAgICBbImxhbmctY3NzIiwgL15zdHlsZVxzKj1ccyoiKFteIl0rKSIvaV0sCiAgICAgICAgWyJsYW5nLWNzcyIsIC9ec3R5bGVccyo9XHMqJyhbXiddKyknL2ldLAogICAgICAgIFsibGFuZy1jc3MiLAogICAgICAgICAgICAvXnN0eWxlXHMqPVxzKihbXlxzIic+XSspL2kKICAgICAgICBdCiAgICBdKSwgWyJpbi50YWciXSk7CiAgICBrKHgoW10sIFsKICAgICAgICBbImF0diIsIC9eW1xTXHNdKy9dCiAgICBdKSwgWyJ1cS52YWwiXSk7CiAgICBrKHUoewogICAgICAgIGtleXdvcmRzOiBGLAogICAgICAgIGhhc2hDb21tZW50czogITAsCiAgICAgICAgY1N0eWxlQ29tbWVudHM6ICEwLAogICAgICAgIHR5cGVzOiBLCiAgICB9KSwgWyJjIiwgImNjIiwgImNwcCIsICJjeHgiLCAiY3ljIiwgIm0iXSk7CiAgICBrKHUoewogICAgICAgIGtleXdvcmRzOiAibnVsbCx0cnVlLGZhbHNlIgogICAgfSksIFsianNvbiJdKTsKICAgIGsodSh7CiAgICAgICAga2V5d29yZHM6IEgsCiAgICAgICAgaGFzaENvbW1lbnRzOiAhMCwKICAgICAgICBjU3R5bGVDb21tZW50czogITAsCiAgICAgICAgdmVyYmF0aW1TdHJpbmdzOiAhMCwKICAgICAgICB0eXBlczogSwogICAgfSksIFsiY3MiXSk7CiAgICBrKHUoewogICAgICAgIGtleXdvcmRzOiBHLAogICAgICAgIGNTdHlsZUNvbW1lbnRzOiAhMAogICAgfSksIFsiamF2YSJdKTsKICAgIGsodSh7CiAgICAgICAga2V5d29yZHM6IHYsCiAgICAgICAgaGFzaENvbW1lbnRzOiAhMCwKICAgICAgICBtdWx0aUxpbmVTdHJpbmdzOiAhMAogICAgfSksIFsiYnNoIiwgImNzaCIsICJzaCJdKTsKICAgIGsodSh7CiAgICAgICAga2V5d29yZHM6IEksCiAgICAgICAgaGFzaENvbW1lbnRzOiAhMCwKICAgICAgICBtdWx0aUxpbmVTdHJpbmdzOiAhMCwKICAgICAgICB0cmlwbGVRdW90ZWRTdHJpbmdzOiAhMAogICAgfSksIFsiY3YiLCAicHkiXSk7CiAgICBrKHUoewogICAgICAgIGtleXdvcmRzOiAiY2FsbGVyLGRlbGV0ZSxkaWUsZG8sZHVtcCxlbHNpZixldmFsLGV4aXQsZm9yZWFjaCxmb3IsZ290byxpZixpbXBvcnQsbGFzdCxsb2NhbCxteSxuZXh0LG5vLG91cixwcmludCxwYWNrYWdlLHJlZG8scmVxdWlyZSxzdWIsdW5kZWYsdW5sZXNzLHVudGlsLHVzZSx3YW50YXJyYXksd2hpbGUsQkVHSU4sRU5EIiwKICAgICAgICBoYXNoQ29tbWVudHM6ICEwLAogICAgICAgIG11bHRpTGluZVN0cmluZ3M6ICEwLAogICAgICAgIHJlZ2V4TGl0ZXJhbHM6ICEwCiAgICB9KSwgWyJwZXJsIiwgInBsIiwgInBtIl0pOwogICAgayh1KHsKICAgICAgICBrZXl3b3JkczogSiwKICAgICAgICBoYXNoQ29tbWVudHM6ICEwLAogICAgICAgIG11bHRpTGluZVN0cmluZ3M6ICEwLAogICAgICAgIHJlZ2V4TGl0ZXJhbHM6ICEwCiAgICB9KSwgWyJyYiJdKTsKICAgIGsodSh7CiAgICAgICAga2V5d29yZHM6IHcsCiAgICAgICAgY1N0eWxlQ29tbWVudHM6ICEwLAogICAgICAgIHJlZ2V4TGl0ZXJhbHM6ICEwCiAgICB9KSwgWyJqcyJdKTsKICAgIGsodSh7CiAgICAgICAga2V5d29yZHM6ICJhbGwsYW5kLGJ5LGNhdGNoLGNsYXNzLGVsc2UsZXh0ZW5kcyxmYWxzZSxmaW5hbGx5LGZvcixpZixpbixpcyxpc250LGxvb3AsbmV3LG5vLG5vdCxudWxsLG9mLG9mZixvbixvcixyZXR1cm4sc3VwZXIsdGhlbix0cnVlLHRyeSx1bmxlc3MsdW50aWwsd2hlbix3aGlsZSx5ZXMiLAogICAgICAgIGhhc2hDb21tZW50czogMywKICAgICAgICBjU3R5bGVDb21tZW50czogITAsCiAgICAgICAgbXVsdGlsaW5lU3RyaW5nczogITAsCiAgICAgICAgdHJpcGxlUXVvdGVkU3RyaW5nczogITAsCiAgICAgICAgcmVnZXhMaXRlcmFsczogITAKICAgIH0pLCBbImNvZmZlZSJdKTsKICAgIGsoeChbXSwgWwogICAgICAgIFsic3RyIiwgL15bXFNcc10rL10KICAgIF0pLCBbInJlZ2V4Il0pOwogICAgd2luZG93LnByZXR0eVByaW50T25lID0gZnVuY3Rpb24oYSwgbSwgZSkgewogICAgICAgIHZhciBoID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiUFJFIik7CiAgICAgICAgaC5pbm5lckhUTUwgPSBhOwogICAgICAgIGUgJiYgRChoLCBlKTsKICAgICAgICBFKHsKICAgICAgICAgICAgZzogbSwKICAgICAgICAgICAgaTogZSwKICAgICAgICAgICAgaDogaAogICAgICAgIH0pOwogICAgICAgIHJldHVybiBoLmlubmVySFRNTAogICAgfTsKICAgIHdpbmRvdy5wcmV0dHlQcmludCA9IGZ1bmN0aW9uKGEpIHsKICAgICAgICBmdW5jdGlvbiBtKCkgewogICAgICAgICAgICBmb3IgKHZhciBlID0gd2luZG93LlBSX1NIT1VMRF9VU0VfQ09OVElOVUFUSU9OID8gbC5ub3coKSArIDI1MCA6IEluZmluaXR5OyBwIDwgaC5sZW5ndGggJiYgbC5ub3coKSA8IGU7IHArKykgewogICAgICAgICAgICAgICAgdmFyIG4gPSBoW3BdLAogICAgICAgICAgICAgICAgICAgIGsgPSBuLmNsYXNzTmFtZTsKICAgICAgICAgICAgICAgIGlmIChrLmluZGV4T2YoInByZXR0eXByaW50IikgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIHZhciBrID0gay5tYXRjaChnKSwKICAgICAgICAgICAgICAgICAgICAgICAgZiwgYjsKICAgICAgICAgICAgICAgICAgICBpZiAoYiA9ICFrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGIgPSBuOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBvID0gdm9pZCAwLCBjID0gYi5maXJzdENoaWxkOyBjOyBjID0gYy5uZXh0U2libGluZykgdmFyIGkgPSBjLm5vZGVUeXBlLAogICAgICAgICAgICAgICAgICAgICAgICBvID0gaSA9PT0gMSA/IG8gPyBiIDogYyA6IGkgPT09IDMgPyBOLnRlc3QoYy5ub2RlVmFsdWUpID8gYiA6IG8gOiBvOwogICAgICAgICAgICAgICAgICAgICAgICBiID0gKGYgPSBvID09PSBiID8gdm9pZCAwIDogbykgJiYgIkNPREUiID09PSBmLnRhZ05hbWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYiAmJiAoayA9IGYuY2xhc3NOYW1lLm1hdGNoKGcpKTsKICAgICAgICAgICAgICAgICAgICBrICYmIChrID0ga1sxXSk7CiAgICAgICAgICAgICAgICAgICAgYiA9ICExOwogICAgICAgICAgICAgICAgICAgIGZvciAobyA9IG4ucGFyZW50Tm9kZTsgbzsgbyA9IG8ucGFyZW50Tm9kZSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChvLnRhZ05hbWUgPT09ICJwcmUiIHx8IG8udGFnTmFtZSA9PT0gImNvZGUiIHx8IG8udGFnTmFtZSA9PT0gInhtcCIpICYmIG8uY2xhc3NOYW1lICYmIG8uY2xhc3NOYW1lLmluZGV4T2YoInByZXR0eXByaW50IikgPj0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYiA9ICEwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGIgfHwgKChiID0gKGIgPSBuLmNsYXNzTmFtZS5tYXRjaCgvXGJsaW5lbnVtc1xiKD86OihcZCspKT8vKSkgPyBiWzFdICYmIGJbMV0ubGVuZ3RoID8gK2JbMV0gOiAhMCA6ICExKSAmJiBEKG4sIGIpLCBkID0gewogICAgICAgICAgICAgICAgICAgICAgICBnOiBrLAogICAgICAgICAgICAgICAgICAgICAgICBoOiBuLAogICAgICAgICAgICAgICAgICAgICAgICBpOiBiCiAgICAgICAgICAgICAgICAgICAgfSwgRShkKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwIDwgaC5sZW5ndGggPyBzZXRUaW1lb3V0KG0sCiAgICAgICAgICAgICAgICAyNTApIDogYSAmJiBhKCkKICAgICAgICB9CiAgICAgICAgZm9yICh2YXIgZSA9IFtkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgicHJlIiksIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJjb2RlIiksIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ4bXAiKV0sIGggPSBbXSwgayA9IDA7IGsgPCBlLmxlbmd0aDsgKytrKQogICAgICAgICAgICBmb3IgKHZhciB0ID0gMCwgcyA9IGVba10ubGVuZ3RoOyB0IDwgczsgKyt0KSBoLnB1c2goZVtrXVt0XSk7CiAgICAgICAgdmFyIGUgPSBxLAogICAgICAgICAgICBsID0gRGF0ZTsKICAgICAgICBsLm5vdyB8fCAobCA9IHsKICAgICAgICAgICAgbm93OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiArbmV3IERhdGUKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBwID0gMCwKICAgICAgICAgICAgZCwgZyA9IC9cYmxhbmcoPzp1YWdlKT8tKFtcdy5dKykoPyFcUykvOwogICAgICAgIG0oKQogICAgfTsKICAgIHdpbmRvdy5QUiA9IHsKICAgICAgICBjcmVhdGVTaW1wbGVMZXhlcjogeCwKICAgICAgICByZWdpc3RlckxhbmdIYW5kbGVyOiBrLAogICAgICAgIHNvdXJjZURlY29yYXRvcjogdSwKICAgICAgICBQUl9BVFRSSUJfTkFNRTogImF0biIsCiAgICAgICAgUFJfQVRUUklCX1ZBTFVFOiAiYXR2IiwKICAgICAgICBQUl9DT01NRU5UOiAiY29tIiwKICAgICAgICBQUl9ERUNMQVJBVElPTjogImRlYyIsCiAgICAgICAgUFJfS0VZV09SRDogImt3ZCIsCiAgICAgICAgUFJfTElURVJBTDogImxpdCIsCiAgICAgICAgUFJfTk9DT0RFOiAibm9jb2RlIiwKICAgICAgICBQUl9QTEFJTjogInBsbiIsCiAgICAgICAgUFJfUFVOQ1RVQVRJT046ICJwdW4iLAogICAgICAgIFBSX1NPVVJDRTogInNyYyIsCiAgICAgICAgUFJfU1RSSU5HOiAic3RyIiwKICAgICAgICBQUl9UQUc6ICJ0YWciLAogICAgICAgIFBSX1RZUEU6ICJ0eXAiCiAgICB9Cn0pKCk7CgovKgogSFRNTDUgU2hpdiB2My42LjJwcmUgfCBAYWZhcmthcyBAamRhbHRvbiBAam9uX25lYWwgQHJlbSB8IE1JVC9HUEwyIExpY2Vuc2VkCiBVbmNvbXByZXNzZWQgc291cmNlOiBodHRwczovL2dpdGh1Yi5jb20vYUZhcmthcy9odG1sNXNoaXYKKi8KKGZ1bmN0aW9uKGwsIGYpIHsKICAgIGZ1bmN0aW9uIG0oKSB7CiAgICAgICAgdmFyIGEgPSBlLmVsZW1lbnRzOwogICAgICAgIHJldHVybiAic3RyaW5nIiA9PSB0eXBlb2YgYSA/IGEuc3BsaXQoIiAiKSA6IGEKICAgIH0KCiAgICBmdW5jdGlvbiBpKGEpIHsKICAgICAgICB2YXIgYiA9IG5bYVtvXV07CiAgICAgICAgYiB8fCAoYiA9IHt9LCBoKyssIGFbb10gPSBoLCBuW2hdID0gYik7CiAgICAgICAgcmV0dXJuIGIKICAgIH0KCiAgICBmdW5jdGlvbiBwKGEsIGIsIGMpIHsKICAgICAgICBiIHx8IChiID0gZik7CiAgICAgICAgaWYgKGcpIHJldHVybiBiLmNyZWF0ZUVsZW1lbnQoYSk7CiAgICAgICAgYyB8fCAoYyA9IGkoYikpOwogICAgICAgIGIgPSBjLmNhY2hlW2FdID8gYy5jYWNoZVthXS5jbG9uZU5vZGUoKSA6IHIudGVzdChhKSA/IChjLmNhY2hlW2FdID0gYy5jcmVhdGVFbGVtKGEpKS5jbG9uZU5vZGUoKSA6IGMuY3JlYXRlRWxlbShhKTsKICAgICAgICByZXR1cm4gYi5jYW5IYXZlQ2hpbGRyZW4gJiYgIXMudGVzdChhKSA/IGMuZnJhZy5hcHBlbmRDaGlsZChiKSA6IGIKICAgIH0KCiAgICBmdW5jdGlvbiB0KGEsIGIpIHsKICAgICAgICBpZiAoIWIuY2FjaGUpIGIuY2FjaGUgPSB7fSwgYi5jcmVhdGVFbGVtID0gYS5jcmVhdGVFbGVtZW50LCBiLmNyZWF0ZUZyYWcgPSBhLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQsIGIuZnJhZyA9IGIuY3JlYXRlRnJhZygpOwogICAgICAgIGEuY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uKGMpIHsKICAgICAgICAgICAgcmV0dXJuICFlLnNoaXZNZXRob2RzID8gYi5jcmVhdGVFbGVtKGMpIDogcChjLCBhLCBiKQogICAgICAgIH07CiAgICAgICAgYS5jcmVhdGVEb2N1bWVudEZyYWdtZW50ID0gRnVuY3Rpb24oImgsZiIsICJyZXR1cm4gZnVuY3Rpb24oKXt2YXIgbj1mLmNsb25lTm9kZSgpLGM9bi5jcmVhdGVFbGVtZW50O2guc2hpdk1ldGhvZHMmJigiICsgbSgpLmpvaW4oKS5yZXBsYWNlKC9cdysvZywgZnVuY3Rpb24oYSkgewogICAgICAgICAgICBiLmNyZWF0ZUVsZW0oYSk7CiAgICAgICAgICAgIGIuZnJhZy5jcmVhdGVFbGVtZW50KGEpOwogICAgICAgICAgICByZXR1cm4gJ2MoIicgKyBhICsgJyIpJwogICAgICAgIH0pICsgIik7cmV0dXJuIG59IikoZSwgYi5mcmFnKQogICAgfQoKICAgIGZ1bmN0aW9uIHEoYSkgewogICAgICAgIGEgfHwgKGEgPSBmKTsKICAgICAgICB2YXIgYiA9IGkoYSk7CiAgICAgICAgaWYgKGUuc2hpdkNTUyAmJiAhaiAmJiAhYi5oYXNDU1MpIHsKICAgICAgICAgICAgdmFyIGMsIGQgPSBhOwogICAgICAgICAgICBjID0gZC5jcmVhdGVFbGVtZW50KCJwIik7CiAgICAgICAgICAgIGQgPSBkLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF0gfHwgZC5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgIGMuaW5uZXJIVE1MID0gIng8c3R5bGU+YXJ0aWNsZSxhc2lkZSxmaWdjYXB0aW9uLGZpZ3VyZSxmb290ZXIsaGVhZGVyLGhncm91cCxtYWluLG5hdixzZWN0aW9ue2Rpc3BsYXk6YmxvY2t9bWFya3tiYWNrZ3JvdW5kOiNGRjA7Y29sb3I6IzAwMH08L3N0eWxlPiI7CiAgICAgICAgICAgIGMgPSBkLmluc2VydEJlZm9yZShjLmxhc3RDaGlsZCwgZC5maXJzdENoaWxkKTsKICAgICAgICAgICAgYi5oYXNDU1MgPSAhISBjCiAgICAgICAgfQogICAgICAgIGcgfHwgdChhLCBiKTsKICAgICAgICByZXR1cm4gYQogICAgfQogICAgdmFyIGsgPSBsLmh0bWw1IHx8IHt9LCBzID0gL148fF4oPzpidXR0b258bWFwfHNlbGVjdHx0ZXh0YXJlYXxvYmplY3R8aWZyYW1lfG9wdGlvbnxvcHRncm91cCkkL2ksCiAgICAgICAgciA9IC9eKD86YXxifGNvZGV8ZGl2fGZpZWxkc2V0fGgxfGgyfGgzfGg0fGg1fGg2fGl8bGFiZWx8bGl8b2x8cHxxfHNwYW58c3Ryb25nfHN0eWxlfHRhYmxlfHRib2R5fHRkfHRofHRyfHVsKSQvaSwKICAgICAgICBqLCBvID0gIl9odG1sNXNoaXYiLAogICAgICAgIGggPSAwLAogICAgICAgIG4gPSB7fSwgZzsKICAgIChmdW5jdGlvbigpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgYSA9IGYuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgICAgICAgICBhLmlubmVySFRNTCA9ICI8eHl6PjwveHl6PiI7CiAgICAgICAgICAgIGogPSAiaGlkZGVuIiBpbiBhOwogICAgICAgICAgICB2YXIgYjsKICAgICAgICAgICAgaWYgKCEoYiA9IDEgPT0gYS5jaGlsZE5vZGVzLmxlbmd0aCkpIHsKICAgICAgICAgICAgICAgIGYuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgICAgICAgICAgICAgdmFyIGMgPSBmLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgICAgIGIgPSAidW5kZWZpbmVkIiA9PSB0eXBlb2YgYy5jbG9uZU5vZGUgfHwKICAgICAgICAgICAgICAgICAgICAidW5kZWZpbmVkIiA9PSB0eXBlb2YgYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50IHx8ICJ1bmRlZmluZWQiID09IHR5cGVvZiBjLmNyZWF0ZUVsZW1lbnQKICAgICAgICAgICAgfQogICAgICAgICAgICBnID0gYgogICAgICAgIH0gY2F0Y2ggKGQpIHsKICAgICAgICAgICAgZyA9IGogPSAhMAogICAgICAgIH0KICAgIH0pKCk7CiAgICB2YXIgZSA9IHsKICAgICAgICBlbGVtZW50czogay5lbGVtZW50cyB8fCAiYWJiciBhcnRpY2xlIGFzaWRlIGF1ZGlvIGJkaSBjYW52YXMgZGF0YSBkYXRhbGlzdCBkZXRhaWxzIGZpZ2NhcHRpb24gZmlndXJlIGZvb3RlciBoZWFkZXIgaGdyb3VwIG1haW4gbWFyayBtZXRlciBuYXYgb3V0cHV0IHByb2dyZXNzIHNlY3Rpb24gc3VtbWFyeSB0aW1lIHZpZGVvIiwKICAgICAgICB2ZXJzaW9uOiAiMy42LjJwcmUiLAogICAgICAgIHNoaXZDU1M6ICExICE9PSBrLnNoaXZDU1MsCiAgICAgICAgc3VwcG9ydHNVbmtub3duRWxlbWVudHM6IGcsCiAgICAgICAgc2hpdk1ldGhvZHM6ICExICE9PSBrLnNoaXZNZXRob2RzLAogICAgICAgIHR5cGU6ICJkZWZhdWx0IiwKICAgICAgICBzaGl2RG9jdW1lbnQ6IHEsCiAgICAgICAgY3JlYXRlRWxlbWVudDogcCwKICAgICAgICBjcmVhdGVEb2N1bWVudEZyYWdtZW50OiBmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICAgIGEgfHwgKGEgPSBmKTsKICAgICAgICAgICAgaWYgKGcpIHJldHVybiBhLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgICAgICAgZm9yICh2YXIgYiA9IGIgfHwgaShhKSwgYyA9IGIuZnJhZy5jbG9uZU5vZGUoKSwgZCA9IDAsIGUgPSBtKCksIGggPSBlLmxlbmd0aDsgZCA8IGg7IGQrKykgYy5jcmVhdGVFbGVtZW50KGVbZF0pOwogICAgICAgICAgICByZXR1cm4gYwogICAgICAgIH0KICAgIH07CiAgICBsLmh0bWw1ID0gZTsKICAgIHEoZikKfSkodGhpcywgZG9jdW1lbnQpOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 03:25:27 GMT",
                    "Content-Length": "103636",
                    "Date": "Fri, 07 Nov 2014 03:25:28 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}