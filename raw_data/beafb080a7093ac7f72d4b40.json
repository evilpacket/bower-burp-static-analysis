{
    "url": "http://localhost:9999/CloudKidStudio/CloudKidOS/dist/cloudkid-os-createjs.debug.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Client-side JSON injection (DOM-based)",
    "issueType": 2098032,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based JSON injection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and incorporates this into a string that is parsed as a JSON data structure and then processed by the application. An attacker may be able to use this behavior to construct a URL which, if visited by another application user, will cause arbitrary JSON data to be processed. Depending on the purpose for which this data is used, it may be possible to subvert the application's logic, or cause unintended actions on behalf of the user.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based JSON injection vulnerabilities is not to parse as JSON any string containing data that originated from an untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from modifying the JSON structure in inappropriate ways. This may involve strict validation of specific items to ensure they do not contain any characters that may interfere with the structure of the JSON when it is parsed.",
    "issueDetail": "The application may be vulnerable to DOM-based client-side JSON injection. Data is read from <b>document.cookie</b> and written to <b>JSON.parse()</b> via the following statements:<ul><li>var c, nameEQ = name + \"=\", ca = document.cookie.split(\";\"), i = 0;</li><li>c = ca[i]</li><li>return JSON.parse(unescape(c.substring(nameEQ.length, c.length)));</li></ul>Because the data originates from a cookie, the application's behavior is not trivial to exploit in an attack against another user. Typically, you will need to find a means of setting an arbitrary cookie value in the victim's browser in order to exploit the vulnerability. Applications often contain \"cookie-forcing\" conditions which make this possible, and such a condition in any related domain or subdomain can potentially be used for this purpose. Nonetheless, this limitation somewhat mitigates the impact of the vulnerability. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/CloudKidStudio/CloudKidOS/dist/cloudkid-os-createjs.debug.js",
                "path": "/CloudKidStudio/CloudKidOS/dist/cloudkid-os-createjs.debug.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9DbG91ZEtpZFN0dWRpby9DbG91ZEtpZE9TL2Rpc3QvY2xvdWRraWQtb3MtY3JlYXRlanMuZGVidWcuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTk5MTMNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTU6Mzk6MzQgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDE1OjM5OjMwIEdNVA0KDQohZnVuY3Rpb24odW5kZWZpbmVkKSB7CiAgICB2YXIgT1MgPSBmdW5jdGlvbigpIHt9LCBwID0gT1MucHJvdG90eXBlID0gbmV3IGNyZWF0ZWpzLkNvbnRhaW5lcigpLCBfcGF1c2VkID0gITEsIF9pc1JlYWR5ID0gITEsIF9mcmFtZXJhdGUgPSBudWxsLCBfbGFzdEZyYW1lVGltZSA9IDAsIF9sYXN0RlBTVXBkYXRlVGltZSA9IDAsIF9mcmFtZXJhdGVWYWx1ZSA9IG51bGwsIF9mcmFtZUNvdW50ID0gMCwgX3RpY2tDYWxsYmFjayA9IG51bGwsIF9pbnN0YW5jZSA9IG51bGwsIF90aWNrSWQgPSAtMSwgX3VzZVJBRiA9ICExLCBfZnBzID0gMCwgX21zUGVyRnJhbWUgPSAwOwogICAgT1MuVkVSU0lPTiA9ICIxLjEuMjciLCBwLkNvbnRhaW5lcl9pbml0aWFsaXplID0gcC5pbml0aWFsaXplLCBwLnN0YWdlID0gbnVsbCwgCiAgICBwLl9hcHAgPSBudWxsLCBwLm9wdGlvbnMgPSBudWxsLCBwLl91cGRhdGVGdW5jdGlvbnMgPSB7fSwgT1MuaW5pdCA9IGZ1bmN0aW9uKHN0YWdlTmFtZSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiBfaW5zdGFuY2UgfHwgKERlYnVnLmxvZygiQ3JlYXRpbmcgdGhlIHNpbmdsZXRvbiBpbnN0YW5jZSBvZiBPUyIpLCBfaW5zdGFuY2UgPSBuZXcgT1MoKSwgCiAgICAgICAgX2luc3RhbmNlLmluaXRpYWxpemUoc3RhZ2VOYW1lLCBvcHRpb25zKSksIF9pbnN0YW5jZTsKICAgIH0sIHAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKHN0YWdlTmFtZSwgb3B0aW9ucykgewogICAgICAgIHRoaXMuQ29udGFpbmVyX2luaXRpYWxpemUoKSwgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fSwgdGhpcy5vcHRpb25zLnBhcnNlUXVlcnlTdHJpbmcgIT09IHVuZGVmaW5lZCAmJiAodGhpcy5vcHRpb25zID0gcGFyc2VRdWVyeVN0cmluZ1BhcmFtcyh0aGlzLm9wdGlvbnMpKSwgCiAgICAgICAgdGhpcy5vcHRpb25zLmRlYnVnICE9PSB1bmRlZmluZWQgJiYgKERlYnVnLmVuYWJsZWQgPSB0aGlzLm9wdGlvbnMuZGVidWcgPT09ICEwIHx8ICJ0cnVlIiA9PT0gdGhpcy5vcHRpb25zLmRlYnVnKSwgCiAgICAgICAgdGhpcy5vcHRpb25zLm1pbkxvZ0xldmVsICE9PSB1bmRlZmluZWQgJiYgKERlYnVnLm1pbkxvZ0xldmVsID0gcGFyc2VJbnQodGhpcy5vcHRpb25zLm1pbkxvZ0xldmVsLCAxMCkpLCAKICAgICAgICAic3RyaW5nIiA9PSB0eXBlb2YgdGhpcy5vcHRpb25zLmlwICYmIERlYnVnLmNvbm5lY3QodGhpcy5vcHRpb25zLmlwKTsKICAgICAgICB2YXIgbG9hZGVyID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5pdCgpOwogICAgICAgIHRoaXMuc3RhZ2UgPSBuZXcgY3JlYXRlanMuU3RhZ2Uoc3RhZ2VOYW1lKSwgdGhpcy5zdGFnZS5uYW1lID0gImNsb3Vka2lkLk9TIiwgdGhpcy5zdGFnZS5jYW52YXMub25tb3VzZWRvd24gPSBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9OwogICAgICAgIHZhciBtb3VzZU92ZXJSYXRlID0gdGhpcy5vcHRpb25zLm1vdXNlT3ZlclJhdGUgPSB0aGlzLm9wdGlvbnMubW91c2VPdmVyUmF0ZSB8fCAzMDsKICAgICAgICB0aGlzLnN0YWdlLmVuYWJsZU1vdXNlT3Zlcihtb3VzZU92ZXJSYXRlKSwgdGhpcy5zdGFnZS5hZGRDaGlsZCh0aGlzKSwgdGhpcy52aXNpYmxlTGlzdGVuZXIgPSB0aGlzLm9uV2luZG93VmlzaWJpbGl0eUNoYW5nZWQuYmluZCh0aGlzKSwgCiAgICAgICAgYWRkUGFnZUhpZGVMaXN0ZW5lcih0aGlzLnZpc2libGVMaXN0ZW5lcik7CiAgICAgICAgdmFyIHRvdWNoRGV2aWNlID0gd2luZG93Lmhhc093blByb3BlcnR5KCJvbnRvdWNoc3RhcnQiKTsKICAgICAgICAtMSA9PSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJNU0lFIDEwLjAiKSB8fCB0b3VjaERldmljZSA/IGNyZWF0ZWpzLlRvdWNoLmVuYWJsZSh0aGlzLnN0YWdlKSA6IERlYnVnLmxvZygiSUUxMCBEZXNrdG9wIiksIAogICAgICAgIHRoaXMuc3RhZ2UuYXV0b0NsZWFyID0gISF0aGlzLm9wdGlvbnMuY2xlYXJWaWV3IHx8ICExLCB0aGlzLm9wdGlvbnMuc2hvd0ZyYW1lcmF0ZSAmJiAoX2ZyYW1lcmF0ZSA9IG5ldyBjcmVhdGVqcy5UZXh0KCIiLCAiMTBweCBBcmlhbCIsICIjMDAwIiksIAogICAgICAgIF9mcmFtZXJhdGUuc3Ryb2tlID0gewogICAgICAgICAgICB3aWR0aDogMiwKICAgICAgICAgICAgY29sb3I6ICIjZmZmZmZmIgogICAgICAgIH0sIF9mcmFtZXJhdGUueCA9IF9mcmFtZXJhdGUueSA9IDUsIHRoaXMuYWRkQ2hpbGQoX2ZyYW1lcmF0ZSkpLCB0aGlzLnN0YWdlLnVwZGF0ZSgpOwogICAgICAgIGlmIChfdGlja0NhbGxiYWNrID0gdGhpcy50aWNrLmJpbmQodGhpcyksIF91c2VSQUYgPSB0aGlzLm9wdGlvbnMucmFmIHx8ICExLCB0aGlzLmZwcyA9IHRoaXMub3B0aW9ucy5mcHMgfHwgNjAsIAogICAgICAgIHRoaXMucmVtb3ZlQXBwKCksIHRoaXMub3B0aW9ucy52ZXJzaW9uc0ZpbGUgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBfaXNSZWFkeSA9ICExOwogICAgICAgICAgICB2YXIgb3MgPSB0aGlzOwogICAgICAgICAgICBsb2FkZXIuY2FjaGVNYW5hZ2VyLmFkZFZlcnNpb25zRmlsZSh0aGlzLm9wdGlvbnMudmVyc2lvbnNGaWxlLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIF9pc1JlYWR5ID0gITAsIG9zLl9hcHAgJiYgKG9zLmFkZENoaWxkQXQob3MuX2FwcCwgMCksIG9zLl9hcHAuaW5pdCgpLCBvcy5yZXN1bWUoKSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBfaXNSZWFkeSA9ICEwOwogICAgfTsKICAgIHZhciBoaWRkZW4gPSBudWxsLCBldnRNYXAgPSBudWxsLCB2ID0gInZpc2libGUiLCBoID0gImhpZGRlbiIsIGFkZFBhZ2VIaWRlTGlzdGVuZXIgPSBmdW5jdGlvbihsaXN0ZW5lcikgewogICAgICAgIGhpZGRlbiA9ICJoaWRkZW4iLCBoaWRkZW4gaW4gZG9jdW1lbnQgPyBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJ2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpIDogKGhpZGRlbiA9ICJtb3pIaWRkZW4iKSBpbiBkb2N1bWVudCA/IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1venZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcikgOiAoaGlkZGVuID0gIndlYmtpdEhpZGRlbiIpIGluIGRvY3VtZW50ID8gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigid2Via2l0dmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKSA6IChoaWRkZW4gPSAibXNIaWRkZW4iKSBpbiBkb2N1bWVudCA/IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1zdmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKSA6ICJvbmZvY3VzaW4iIGluIGRvY3VtZW50ID8gKGV2dE1hcCA9IHsKICAgICAgICAgICAgZm9jdXNpbjogdiwKICAgICAgICAgICAgZm9jdXNvdXQ6IGgKICAgICAgICB9LCBkb2N1bWVudC5vbmZvY3VzaW4gPSBkb2N1bWVudC5vbmZvY3Vzb3V0ID0gbGlzdGVuZXIpIDogKGV2dE1hcCA9IHsKICAgICAgICAgICAgZm9jdXM6IHYsCiAgICAgICAgICAgIHBhZ2VzaG93OiB2LAogICAgICAgICAgICBibHVyOiBoLAogICAgICAgICAgICBwYWdlaGlkZTogaAogICAgICAgIH0sIHdpbmRvdy5vbnBhZ2VzaG93ID0gd2luZG93Lm9ucGFnZWhpZGUgPSB3aW5kb3cub25mb2N1cyA9IHdpbmRvdy5vbmJsdXIgPSBsaXN0ZW5lcik7CiAgICB9LCByZW1vdmVQYWdlSGlkZUxpc3RlbmVyID0gZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgICB2YXIgaGlkZGVuID0gImhpZGRlbiI7CiAgICAgICAgaGlkZGVuIGluIGRvY3VtZW50ID8gZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigidmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKSA6IChoaWRkZW4gPSAibW96SGlkZGVuIikgaW4gZG9jdW1lbnQgPyBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3p2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpIDogKGhpZGRlbiA9ICJ3ZWJraXRIaWRkZW4iKSBpbiBkb2N1bWVudCA/IGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIndlYmtpdHZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcikgOiAoaGlkZGVuID0gIm1zSGlkZGVuIikgaW4gZG9jdW1lbnQgJiYgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibXN2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpLCAKICAgICAgICBkb2N1bWVudC5vbmZvY3VzaW4gPSBkb2N1bWVudC5vbmZvY3Vzb3V0ID0gbnVsbCwgd2luZG93Lm9ucGFnZXNob3cgPSB3aW5kb3cub25wYWdlaGlkZSA9IHdpbmRvdy5vbmZvY3VzID0gd2luZG93Lm9uYmx1ciA9IG51bGw7CiAgICB9OwogICAgcC5vbldpbmRvd1Zpc2liaWxpdHlDaGFuZ2VkID0gZnVuY3Rpb24oZXZ0KSB7CiAgICAgICAgdmFyIHYgPSAidmlzaWJsZSIsIGggPSAiaGlkZGVuIjsKICAgICAgICBldnQgPSBldnQgfHwgd2luZG93LmV2ZW50OwogICAgICAgIHZhciB2YWx1ZTsKICAgICAgICB2YWx1ZSA9IGV2dE1hcCA/IGV2dE1hcFtldnQudHlwZV0gOiBkb2N1bWVudFtoaWRkZW5dID8gaCA6IHYsIHZhbHVlID09IGggPyB0aGlzLnBhdXNlKCkgOiB0aGlzLnJlc3VtZSgpOwogICAgfTsKICAgIHZhciBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zID0gZnVuY3Rpb24ob3V0cHV0KSB7CiAgICAgICAgdmFyIGhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZiwgcXVlc3Rpb25NYXJrID0gaHJlZi5pbmRleE9mKCI/Iik7CiAgICAgICAgaWYgKC0xID09IHF1ZXN0aW9uTWFyaykgcmV0dXJuIG91dHB1dDsKICAgICAgICB2YXIgdmFycyA9IDAgPiBxdWVzdGlvbk1hcmsgPyAiIiA6IGhyZWYuc3Vic3RyKHF1ZXN0aW9uTWFyayArIDEpLCBwb3VuZCA9IHZhcnMuaW5kZXhPZigiIyIpOwogICAgICAgIHZhcnMgPSAwID4gcG91bmQgPyB2YXJzIDogdmFycy5zdWJzdHJpbmcoMCwgcG91bmQpOwogICAgICAgIGZvciAodmFyIG15VmFyLCBzcGxpdEZsYXNoVmFycyA9IHZhcnMuc3BsaXQoIiYiKSwgaSA9IDA7IGkgPCBzcGxpdEZsYXNoVmFycy5sZW5ndGg7IGkrKykgbXlWYXIgPSBzcGxpdEZsYXNoVmFyc1tpXS5zcGxpdCgiPSIpLCAKICAgICAgICBEZWJ1Zy5sb2cobXlWYXJbMF0gKyAiIC0+ICIgKyBteVZhclsxXSksIG91dHB1dFtteVZhclswXV0gPSBteVZhclsxXTsKICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgfTsKICAgIHAucGF1c2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAtMSAhPSBfdGlja0lkICYmIChfdXNlUkFGID8gd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lICYmIGNhbmNlbEFuaW1hdGlvbkZyYW1lKF90aWNrSWQpIDogY2xlYXJUaW1lb3V0KF90aWNrSWQpLCAKICAgICAgICBfdGlja0lkID0gLTEpLCBfcGF1c2VkID0gITA7CiAgICB9OwogICAgdmFyIG5vd0Z1bmMgPSB3aW5kb3cucGVyZm9ybWFuY2UgJiYgKHBlcmZvcm1hbmNlLm5vdyB8fCBwZXJmb3JtYW5jZS5tb3pOb3cgfHwgcGVyZm9ybWFuY2UubXNOb3cgfHwgcGVyZm9ybWFuY2Uub05vdyB8fCBwZXJmb3JtYW5jZS53ZWJraXROb3cpOwogICAgbm93RnVuYyA9IG5vd0Z1bmMgPyBub3dGdW5jLmJpbmQocGVyZm9ybWFuY2UpIDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgfSwgcC5nZXRUaW1lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5vd0Z1bmMoKTsKICAgIH0sIHAucmVzdW1lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgX3BhdXNlZCA9ICExLCAtMSA9PSBfdGlja0lkICYmIChfdGlja0lkID0gX3VzZVJBRiA/IHJlcXVlc3RBbmltRnJhbWUoX3RpY2tDYWxsYmFjaykgOiBzZXRUYXJnZXRlZFRpbWVvdXQoX3RpY2tDYWxsYmFjaykpLCAKICAgICAgICBfbGFzdEZQU1VwZGF0ZVRpbWUgPSBfbGFzdEZyYW1lVGltZSA9IHRoaXMuZ2V0VGltZSgpOwogICAgfSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJmcHMiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIF9mcHM7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICJudW1iZXIiID09IHR5cGVvZiB2YWx1ZSAmJiAoX2ZwcyA9IHZhbHVlLCBfbXNQZXJGcmFtZSA9IDFlMyAvIF9mcHMgfCAwKTsKICAgICAgICB9CiAgICB9KSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJzdGFnZVdpZHRoIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBfaW5zdGFuY2Uuc3RhZ2UuY2FudmFzLndpZHRoOwogICAgICAgIH0KICAgIH0pLCBPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInN0YWdlSGVpZ2h0IiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBfaW5zdGFuY2Uuc3RhZ2UuY2FudmFzLmhlaWdodDsKICAgICAgICB9CiAgICB9KTsKICAgIHZhciBzZXRUYXJnZXRlZFRpbWVvdXQgPSBmdW5jdGlvbihjYWxsYmFjaywgdGltZUluRnJhbWUpIHsKICAgICAgICB2YXIgdGltZVRvQ2FsbCA9IDA7CiAgICAgICAgcmV0dXJuIHRpbWVJbkZyYW1lICYmICh0aW1lVG9DYWxsID0gTWF0aC5tYXgoMCwgX21zUGVyRnJhbWUgLSB0aW1lSW5GcmFtZSkpLCBzZXRUaW1lb3V0KGNhbGxiYWNrLCB0aW1lVG9DYWxsKTsKICAgIH07CiAgICBwLnJlbW92ZUFwcCA9IGZ1bmN0aW9uKGRlc3Ryb3lpbmcpIHsKICAgICAgICB2YXIgcmVtb3ZlZCA9ICExLCBzdGFnZSA9IHRoaXMuc3RhZ2U7CiAgICAgICAgcmV0dXJuIHRoaXMuX2FwcCAmJiAodGhpcy5jb250YWlucyh0aGlzLl9hcHApICYmIHRoaXMucmVtb3ZlQ2hpbGQodGhpcy5fYXBwKSwgc3RhZ2UucmVtb3ZlQWxsQ2hpbGRyZW4oKSwgCiAgICAgICAgdGhpcy5fYXBwLmRlc3Ryb3koKSwgcmVtb3ZlZCA9ICEwKSwgdGhpcy5fYXBwID0gbnVsbCwgdGhpcy5wYXVzZSgpLCBkZXN0cm95aW5nIHx8IChzdGFnZS5hZGRDaGlsZCh0aGlzKSwgCiAgICAgICAgX2ZyYW1lcmF0ZSAmJiAoX2ZyYW1lcmF0ZS50ZXh0ID0gIkZQUzogMC4wMDAiKSwgX2xhc3RGcmFtZVRpbWUgPSBfbGFzdEZQU1VwZGF0ZVRpbWUgPSBfZnJhbWVyYXRlVmFsdWUgPSBfZnJhbWVDb3VudCA9IDAsIAogICAgICAgIHRoaXMuc3RhZ2UudXBkYXRlKCkpLCByZW1vdmVkOwogICAgfSwgcC5hZGRBcHAgPSBmdW5jdGlvbihhcHApIHsKICAgICAgICBpZiAodGhpcy5yZW1vdmVBcHAoKSwgIShhcHAgaW5zdGFuY2VvZiBjbG91ZGtpZC5BcHBsaWNhdGlvbikpIHRocm93IG5ldyBFcnJvcigiQ2FuIG9ubHkgb2JqZWN0cyB0aGF0IGluaGVyaXQgY2xvdWRraWQuQXBwbGljYXRpb24iKTsKICAgICAgICB0aGlzLl9hcHAgPSBhcHAsIF9pc1JlYWR5ICYmICh0aGlzLmFkZENoaWxkQXQoYXBwLCAwKSwgdGhpcy5fYXBwLmluaXQoKSwgdGhpcy5yZXN1bWUoKSk7CiAgICB9LCBwLmdldEFwcCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLl9hcHA7CiAgICB9LCBwLmFkZFVwZGF0ZUNhbGxiYWNrID0gZnVuY3Rpb24oYWxpYXMsIGYpIHsKICAgICAgICB0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdID09PSB1bmRlZmluZWQgJiYgKHRoaXMuX3VwZGF0ZUZ1bmN0aW9uc1thbGlhc10gPSBmKTsKICAgIH0sIHAucmVtb3ZlVXBkYXRlQ2FsbGJhY2sgPSBmdW5jdGlvbihhbGlhcykgewogICAgICAgIHRoaXMuX3VwZGF0ZUZ1bmN0aW9uc1thbGlhc10gIT09IHVuZGVmaW5lZCAmJiBkZWxldGUgdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXTsKICAgIH0sIHAudGljayA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChfcGF1c2VkKSByZXR1cm4gdm9pZCAoX3RpY2tJZCA9IC0xKTsKICAgICAgICB2YXIgbm93ID0gdGhpcy5nZXRUaW1lKCksIGRUaW1lID0gbm93IC0gX2xhc3RGcmFtZVRpbWU7CiAgICAgICAgaWYgKF9mcmFtZXJhdGUgJiYgX2ZyYW1lcmF0ZS52aXNpYmxlKSB7CiAgICAgICAgICAgIF9mcmFtZUNvdW50Kys7CiAgICAgICAgICAgIHZhciBlbGFwc2VkID0gbm93IC0gX2xhc3RGUFNVcGRhdGVUaW1lOwogICAgICAgICAgICBlbGFwc2VkID4gMWUzICYmIChfZnJhbWVyYXRlVmFsdWUgPSAxZTMgLyBlbGFwc2VkICogX2ZyYW1lQ291bnQsIF9mcmFtZXJhdGUudGV4dCA9ICJGUFM6ICIgKyBNYXRoLnJvdW5kKDFlMyAqIF9mcmFtZXJhdGVWYWx1ZSkgLyAxZTMsIAogICAgICAgICAgICBfbGFzdEZQU1VwZGF0ZVRpbWUgPSBub3csIF9mcmFtZUNvdW50ID0gMCk7CiAgICAgICAgfQogICAgICAgIF9sYXN0RnJhbWVUaW1lID0gbm93LCB0aGlzLl9hcHAgJiYgdGhpcy5fYXBwLnVwZGF0ZShkVGltZSk7CiAgICAgICAgZm9yICh2YXIgYWxpYXMgaW4gdGhpcy5fdXBkYXRlRnVuY3Rpb25zKSB0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdKGRUaW1lKTsKICAgICAgICB0aGlzLnN0YWdlLnVwZGF0ZShkVGltZSksIF90aWNrSWQgPSBfdXNlUkFGID8gcmVxdWVzdEFuaW1GcmFtZShfdGlja0NhbGxiYWNrKSA6IHNldFRhcmdldGVkVGltZW91dChfdGlja0NhbGxiYWNrLCB0aGlzLmdldFRpbWUoKSAtIF9sYXN0RnJhbWVUaW1lKTsKICAgIH0sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzdGFnZSA9IHRoaXMuc3RhZ2UsIG1sID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5zdGFuY2U7CiAgICAgICAgdGhpcy5wYXVzZSgpLCB0aGlzLnJlbW92ZUFwcCghMCksIF9pbnN0YW5jZSA9IG51bGwsIGNyZWF0ZWpzLlRvdWNoLmRpc2FibGUoc3RhZ2UpLCAKICAgICAgICBzdGFnZS5lbmFibGVNb3VzZU92ZXIoLTEpLCBzdGFnZS5lbmFibGVET01FdmVudHMoITEpLCBtbC5kZXN0cm95KCksIHRoaXMuc3RhZ2UgPSBudWxsLCAKICAgICAgICB0aGlzLl91cGRhdGVGdW5jdGlvbnMgPSBudWxsLCByZW1vdmVQYWdlSGlkZUxpc3RlbmVyKHRoaXMudmlzaWJsZUxpc3RlbmVyKTsKICAgIH0sIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShPUywgImluc3RhbmNlIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghX2luc3RhbmNlKSB0aHJvdyAiQ2FsbCBjbG91ZGtpZC5PUy5pbml0KGNhbnZhc0lkKSI7CiAgICAgICAgICAgIHJldHVybiBfaW5zdGFuY2U7CiAgICAgICAgfQogICAgfSksIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5PUyA9IE9TOwp9KCksIGZ1bmN0aW9uKHdpbmRvdykgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIEZ1bmN0aW9uVXRpbHMgPSB7fTsKICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kIHx8IChGdW5jdGlvblV0aWxzLmJpbmQgPSBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCA9IGZ1bmN0aW9uKHRoYXQpIHsKICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpczsKICAgICAgICBpZiAoImZ1bmN0aW9uIiAhPSB0eXBlb2YgdGFyZ2V0KSB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCBib3VuZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcyBpbnN0YW5jZW9mIGJvdW5kKSB7CiAgICAgICAgICAgICAgICB2YXIgRiA9IGZ1bmN0aW9uKCkge307CiAgICAgICAgICAgICAgICBGLnByb3RvdHlwZSA9IHRhcmdldC5wcm90b3R5cGU7CiAgICAgICAgICAgICAgICB2YXIgc2VsZiA9IG5ldyBGKCksIHJlc3VsdCA9IHRhcmdldC5hcHBseShzZWxmLCBhcmdzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0KHJlc3VsdCkgPT09IHJlc3VsdCA/IHJlc3VsdCA6IHNlbGY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRhcmdldC5hcHBseSh0aGF0LCBhcmdzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgICAgfTsKICAgICAgICByZXR1cm4gYm91bmQ7CiAgICB9KTsKICAgIGZvciAodmFyIGxhc3RUaW1lID0gMCwgdmVuZG9ycyA9IFsgIm1zIiwgIm1veiIsICJ3ZWJraXQiLCAibyIgXSwgeCA9IDA7IHggPCB2ZW5kb3JzLmxlbmd0aCAmJiAhd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZTsgKyt4KSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gd2luZG93W3ZlbmRvcnNbeF0gKyAiUmVxdWVzdEFuaW1hdGlvbkZyYW1lIl0sIAogICAgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gd2luZG93W3ZlbmRvcnNbeF0gKyAiQ2FuY2VsQW5pbWF0aW9uRnJhbWUiXSB8fCB3aW5kb3dbdmVuZG9yc1t4XSArICJDYW5jZWxSZXF1ZXN0QW5pbWF0aW9uRnJhbWUiXTsKICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgKHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgIHZhciBjdXJyVGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLCB0aW1lVG9DYWxsID0gTWF0aC5tYXgoMCwgMTYgLSAoY3VyclRpbWUgLSBsYXN0VGltZSkpLCBpZCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjYWxsYmFjayhjdXJyVGltZSArIHRpbWVUb0NhbGwpOwogICAgICAgIH0sIHRpbWVUb0NhbGwpOwogICAgICAgIHJldHVybiBsYXN0VGltZSA9IGN1cnJUaW1lICsgdGltZVRvQ2FsbCwgaWQ7CiAgICB9LCB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwgKHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KGlkKTsKICAgIH0pKSwgRnVuY3Rpb25VdGlscy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lLCB3aW5kb3cucmVxdWVzdEFuaW1GcmFtZSA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUsIAogICAgRnVuY3Rpb25VdGlscy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLkZ1bmN0aW9uVXRpbHMgPSBGdW5jdGlvblV0aWxzOwp9KHdpbmRvdyksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIEJpdG1hcFV0aWxzID0ge307CiAgICBCaXRtYXBVdGlscy5sb2FkU3ByaXRlU2hlZXQgPSBmdW5jdGlvbihmcmFtZURpY3QsIHNwcml0ZXNoZWV0SW1hZ2UsIHNjYWxlKSB7CiAgICAgICAgc2NhbGUgPiAwIHx8IChzY2FsZSA9IDEpOwogICAgICAgIGZvciAodmFyIGtleSBpbiBmcmFtZURpY3QpIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gZnJhbWVEaWN0W2tleV0sIGluZGV4ID0ga2V5LmluZGV4T2YoIi4iKTsKICAgICAgICAgICAgaW5kZXggPiAwICYmIChrZXkgPSBrZXkuc3Vic3RyaW5nKDAsIGluZGV4KSk7CiAgICAgICAgICAgIHZhciBiaXRtYXAgPSBsaWJba2V5XSwgbmV3Qml0bWFwID0gbGliW2tleV0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGNyZWF0ZWpzLkNvbnRhaW5lci5jYWxsKHRoaXMpOwogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbmV3IGNyZWF0ZWpzLkJpdG1hcCh0aGlzLl9pbWFnZSk7CiAgICAgICAgICAgICAgICB0aGlzLmFkZENoaWxkKGNoaWxkKSwgY2hpbGQuc291cmNlUmVjdCA9IHRoaXMuX2ZyYW1lUmVjdDsKICAgICAgICAgICAgICAgIHZhciBzID0gdGhpcy5fc2NhbGU7CiAgICAgICAgICAgICAgICBjaGlsZC5zZXRUcmFuc2Zvcm0odGhpcy5fZnJhbWVPZmZzZXRYICogcywgdGhpcy5fZnJhbWVPZmZzZXRZICogcywgcywgcyk7CiAgICAgICAgICAgIH0sIHAgPSBuZXdCaXRtYXAucHJvdG90eXBlID0gbmV3IGNyZWF0ZWpzLkNvbnRhaW5lcigpOwogICAgICAgICAgICBwLl9pbWFnZSA9IHNwcml0ZXNoZWV0SW1hZ2UsIHAuX3NjYWxlID0gc2NhbGU7CiAgICAgICAgICAgIHZhciBmcmFtZVJlY3QgPSBmcmFtZS5mcmFtZTsKICAgICAgICAgICAgcC5fZnJhbWVSZWN0ID0gbmV3IGNyZWF0ZWpzLlJlY3RhbmdsZShmcmFtZVJlY3QueCwgZnJhbWVSZWN0LnksIGZyYW1lUmVjdC53LCBmcmFtZVJlY3QuaCksIAogICAgICAgICAgICBmcmFtZS50cmltbWVkID8gKHAuX2ZyYW1lT2Zmc2V0WCA9IGZyYW1lLnNwcml0ZVNvdXJjZVNpemUueCwgcC5fZnJhbWVPZmZzZXRZID0gZnJhbWUuc3ByaXRlU291cmNlU2l6ZS55KSA6IHAuX2ZyYW1lT2Zmc2V0WCA9IHAuX2ZyYW1lT2Zmc2V0WSA9IDAsIAogICAgICAgICAgICBwLm5vbWluYWxCb3VuZHMgPSBiaXRtYXAgJiYgYml0bWFwLnByb3RvdHlwZS5ub21pbmFsQm91bmRzID8gYml0bWFwLnByb3RvdHlwZS5ub21pbmFsQm91bmRzIDogbmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCAwLCBmcmFtZS5zb3VyY2VTaXplLncsIGZyYW1lLnNvdXJjZVNpemUuaCk7CiAgICAgICAgfQogICAgfSwgQml0bWFwVXRpbHMucmVwbGFjZVdpdGhTY2FsZWRCaXRtYXAgPSBmdW5jdGlvbihpZE9yRGljdCwgc2NhbGUpIHsKICAgICAgICBpZiAoMSAhPSBzY2FsZSAmJiBzY2FsZSA+IDApIHsKICAgICAgICAgICAgdmFyIGtleSwgYml0bWFwLCBuZXdCaXRtYXAsIHA7CiAgICAgICAgICAgIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgaWRPckRpY3QpIGtleSA9IGlkT3JEaWN0LCBiaXRtYXAgPSBsaWJba2V5XSwgYml0bWFwICYmIChuZXdCaXRtYXAgPSBsaWJba2V5XSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY3JlYXRlanMuQ29udGFpbmVyLmNhbGwodGhpcyk7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBuZXcgdGhpcy5fb2xkQk0oKTsKICAgICAgICAgICAgICAgIHRoaXMuYWRkQ2hpbGQoY2hpbGQpLCBjaGlsZC5zZXRUcmFuc2Zvcm0oMCwgMCwgdGhpcy5fc2NhbGUsIHRoaXMuX3NjYWxlKTsKICAgICAgICAgICAgfSwgcCA9IG5ld0JpdG1hcC5wcm90b3R5cGUgPSBuZXcgY3JlYXRlanMuQ29udGFpbmVyKCksIHAuX29sZEJNID0gYml0bWFwLCBwLl9zY2FsZSA9IHNjYWxlLCAKICAgICAgICAgICAgcC5ub21pbmFsQm91bmRzID0gYml0bWFwLnByb3RvdHlwZS5ub21pbmFsQm91bmRzKTsgZWxzZSBmb3IgKGtleSBpbiBpZE9yRGljdCkgYml0bWFwID0gbGliW2tleV0sIAogICAgICAgICAgICBiaXRtYXAgJiYgKG5ld0JpdG1hcCA9IGxpYltrZXldID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjcmVhdGVqcy5Db250YWluZXIuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5ldyB0aGlzLl9vbGRCTSgpOwogICAgICAgICAgICAgICAgdGhpcy5hZGRDaGlsZChjaGlsZCksIGNoaWxkLnNldFRyYW5zZm9ybSgwLCAwLCB0aGlzLl9zY2FsZSwgdGhpcy5fc2NhbGUpOwogICAgICAgICAgICB9LCBwID0gbmV3Qml0bWFwLnByb3RvdHlwZSA9IG5ldyBjcmVhdGVqcy5Db250YWluZXIoKSwgcC5fb2xkQk0gPSBiaXRtYXAsIHAuX3NjYWxlID0gc2NhbGUsIAogICAgICAgICAgICBwLm5vbWluYWxCb3VuZHMgPSBiaXRtYXAucHJvdG90eXBlLm5vbWluYWxCb3VuZHMpOwogICAgICAgIH0KICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5CaXRtYXBVdGlscyA9IEJpdG1hcFV0aWxzOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFNhdmVkRGF0YSA9IHt9LCBXRUJfU1RPUkFHRV9TVVBQT1JUID0gInVuZGVmaW5lZCIgIT0gdHlwZW9mIHdpbmRvdy5TdG9yYWdlLCBFUkFTRV9DT09LSUUgPSAtMTsKICAgIGlmIChXRUJfU1RPUkFHRV9TVVBQT1JUKSB0cnkgewogICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJMU19URVNUIiwgInRlc3QiKSwgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oIkxTX1RFU1QiKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBXRUJfU1RPUkFHRV9TVVBQT1JUID0gITE7CiAgICB9CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2F2ZWREYXRhLCAidXNlV2ViU3RvcmFnZSIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gV0VCX1NUT1JBR0VfU1VQUE9SVDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICYmICJ1bmRlZmluZWQiICE9IHR5cGVvZiB3aW5kb3cuU3RvcmFnZSkgdHJ5IHsKICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJMU19URVNUIiwgInRlc3QiKSwgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oIkxTX1RFU1QiKSwgV0VCX1NUT1JBR0VfU1VQUE9SVCA9ICEwOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBXRUJfU1RPUkFHRV9TVVBQT1JUID0gITE7CiAgICAgICAgICAgIH0gZWxzZSBXRUJfU1RPUkFHRV9TVVBQT1JUID0gITE7CiAgICAgICAgfQogICAgfSksIFNhdmVkRGF0YS5yZW1vdmUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgV0VCX1NUT1JBR0VfU1VQUE9SVCA/IChsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShuYW1lKSwgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbShuYW1lKSkgOiBTYXZlZERhdGEud3JpdGUobmFtZSwgIiIsIEVSQVNFX0NPT0tJRSk7CiAgICB9LCBTYXZlZERhdGEud3JpdGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgdGVtcE9ubHkpIHsKICAgICAgICBpZiAoV0VCX1NUT1JBR0VfU1VQUE9SVCkgdGVtcE9ubHkgPyBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKG5hbWUsIEpTT04uc3RyaW5naWZ5KHZhbHVlKSkgOiBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShuYW1lLCBKU09OLnN0cmluZ2lmeSh2YWx1ZSkpOyBlbHNlIHsKICAgICAgICAgICAgdmFyIGV4cGlyZXM7CiAgICAgICAgICAgIGV4cGlyZXMgPSB0ZW1wT25seSA/IHRlbXBPbmx5ICE9PSBFUkFTRV9DT09LSUUgPyAiIiA6ICI7IGV4cGlyZXM9VGh1LCAwMSBKYW4gMTk3MCAwMDowMDowMCBHTVQiIDogIjsgZXhwaXJlcz0iICsgbmV3IERhdGUoMjE0NzQ4MzY0NmUzKS50b0dNVFN0cmluZygpLCAKICAgICAgICAgICAgZG9jdW1lbnQuY29va2llID0gbmFtZSArICI9IiArIGVzY2FwZShKU09OLnN0cmluZ2lmeSh2YWx1ZSkpICsgZXhwaXJlcyArICI7IHBhdGg9LyI7CiAgICAgICAgfQogICAgfSwgU2F2ZWREYXRhLnJlYWQgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgaWYgKFdFQl9TVE9SQUdFX1NVUFBPUlQpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0obmFtZSkgfHwgc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShuYW1lKTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlID8gSlNPTi5wYXJzZSh2YWx1ZSkgOiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYywgbmFtZUVRID0gbmFtZSArICI9IiwgY2EgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoIjsiKSwgaSA9IDA7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGZvciAoYyA9IGNhW2ldOyAiICIgPT0gYy5jaGFyQXQoMCk7ICkgYyA9IGMuc3Vic3RyaW5nKDEsIGMubGVuZ3RoKTsKICAgICAgICAgICAgaWYgKDAgPT09IGMuaW5kZXhPZihuYW1lRVEpKSByZXR1cm4gSlNPTi5wYXJzZSh1bmVzY2FwZShjLnN1YnN0cmluZyhuYW1lRVEubGVuZ3RoLCBjLmxlbmd0aCkpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuU2F2ZWREYXRhID0gU2F2ZWREYXRhOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgd2luZG93LlVSTCA9IHdpbmRvdy5VUkwgfHwgd2luZG93LndlYmtpdFVSTCwgd2luZG93LkJsb2JCdWlsZGVyID0gd2luZG93LkJsb2JCdWlsZGVyIHx8IHdpbmRvdy5XZWJLaXRCbG9iQnVpbGRlciB8fCB3aW5kb3cuTW96QmxvYkJ1aWxkZXI7CiAgICB2YXIgV29ya2VyID0ge307CiAgICBXb3JrZXIuaW5pdCA9IGZ1bmN0aW9uKGNvZGVTdHJpbmcpIHsKICAgICAgICBpZiAoIXdpbmRvdy5VUkwgfHwgIXdpbmRvdy5Xb3JrZXIpIHJldHVybiBuZXcgRmFsbGJhY2tXb3JrZXIoY29kZVN0cmluZyk7CiAgICAgICAgdmFyIGJsb2I7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYmxvYiA9IG5ldyBCbG9iKFsgY29kZVN0cmluZyBdLCB7CiAgICAgICAgICAgICAgICB0eXBlOiAiYXBwbGljYXRpb24vamF2YXNjcmlwdCIKICAgICAgICAgICAgfSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBpZiAoIXdpbmRvdy5CbG9iQnVpbGRlcikgcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGJsb2IgPSBuZXcgQmxvYkJ1aWxkZXIoKSwgYmxvYi5hcHBlbmQoY29kZVN0cmluZyksIGJsb2IgPSBibG9iLmdldEJsb2IoKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRmFsbGJhY2tXb3JrZXIoY29kZVN0cmluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFibG9iKSByZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciB3b3JrZXIgPSBuZXcgV29ya2VyKFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYikpOwogICAgICAgICAgICByZXR1cm4gd29ya2VyOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsKICAgICAgICB9CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuY3JlYXRlV29ya2VyID0gV29ya2VyLmluaXQsIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5Xb3JrZXIgPSBXb3JrZXI7CiAgICB2YXIgU3ViV29ya2VyID0gZnVuY3Rpb24oY29kZVN0cmluZywgcGFyZW50KSB7CiAgICAgICAgdGhpcy5fd1BhcmVudCA9IHBhcmVudCwgZXZhbChjb2RlU3RyaW5nKTsKICAgIH0sIHAgPSBTdWJXb3JrZXIucHJvdG90eXBlOwogICAgcC5vbm1lc3NhZ2UgPSBudWxsLCBwLl93UGFyZW50ID0gbnVsbCwgcC5wb3N0TWVzc2FnZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy5fd1BhcmVudDsKICAgICAgICBzZXRUaW1lb3V0KHBhcmVudC5vbm1lc3NhZ2UuYmluZChwYXJlbnQsIHsKICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgIH0pLCAxKTsKICAgIH07CiAgICB2YXIgRmFsbGJhY2tXb3JrZXIgPSBmdW5jdGlvbihjb2RlU3RyaW5nKSB7CiAgICAgICAgdGhpcy5fd0NoaWxkID0gbmV3IFN1Yldvcmtlcihjb2RlU3RyaW5nLCB0aGlzKTsKICAgIH07CiAgICBwID0gRmFsbGJhY2tXb3JrZXIucHJvdG90eXBlLCBwLnBvc3RNZXNzYWdlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICAgIHZhciBjaGlsZCA9IHRoaXMuX3dDaGlsZDsKICAgICAgICBzZXRUaW1lb3V0KGNoaWxkLm9ubWVzc2FnZS5iaW5kKGNoaWxkLCB7CiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICB9KSwgMSk7CiAgICB9LCBwLnRlcm1pbmF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMub25tZXNzYWdlID0gbnVsbDsKICAgICAgICB2YXIgY2hpbGQgPSB0aGlzLl93Q2hpbGQ7CiAgICAgICAgY2hpbGQuX3dQYXJlbnQgPSBudWxsLCBjaGlsZC5vbm1lc3NhZ2UgPSBudWxsLCB0aGlzLl93Q2hpbGQgPSBudWxsOwogICAgfSwgcC5vbm1lc3NhZ2UgPSBudWxsLCBwLl93Q2hpbGQgPSBudWxsOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIENvbWJpbmVkQ2FsbGJhY2sgPSBmdW5jdGlvbihjYWxsLCBvYmosIHByb3AsIGNhbGxQcm9wKSB7CiAgICAgICAgb2JqW3Byb3BdID8gb2JqW2NhbGxQcm9wXSA9IGNhbGwgOiBjYWxsKCk7CiAgICB9OwogICAgQ29tYmluZWRDYWxsYmFjay5jcmVhdGUgPSBmdW5jdGlvbihjYWxsLCBvYmosIHByb3AsIGNhbGxQcm9wKSB7CiAgICAgICAgcmV0dXJuIENvbWJpbmVkQ2FsbGJhY2suYmluZCh0aGlzLCBjYWxsLCBvYmosIHByb3AsIGNhbGxQcm9wKTsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5Db21iaW5lZENhbGxiYWNrID0gQ29tYmluZWRDYWxsYmFjazsKfSgpLCBmdW5jdGlvbih1bmRlZmluZWQpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBORVhUX0lEID0gMCwgRGVsYXllZENhbGwgPSBmdW5jdGlvbihjYWxsYmFjaywgZGVsYXksIHJlcGVhdCwgYXV0b0Rlc3Ryb3kpIHsKICAgICAgICB0aGlzLl9jYWxsYmFjayA9IGNhbGxiYWNrLCB0aGlzLl9kZWxheSA9IGRlbGF5LCB0aGlzLl90aW1lciA9IGRlbGF5LCB0aGlzLl9yZXBlYXQgPSAhIXJlcGVhdCwgCiAgICAgICAgdGhpcy5fYXV0b0Rlc3Ryb3kgPSBhdXRvRGVzdHJveSA9PT0gdW5kZWZpbmVkID8gITAgOiAhIWF1dG9EZXN0cm95LCB0aGlzLl91cGRhdGVJZCA9ICJEZWxheWVkQ2FsbCMiICsgKytORVhUX0lELCAKICAgICAgICB0aGlzLl9wYXVzZWQgPSAhMSwgdGhpcy5fdXBkYXRlID0gdGhpcy5fdXBkYXRlLmJpbmQodGhpcyksIGNsb3Vka2lkLk9TLmluc3RhbmNlLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpOwogICAgfSwgcCA9IERlbGF5ZWRDYWxsLnByb3RvdHlwZTsKICAgIHAuX3VwZGF0ZSA9IGZ1bmN0aW9uKGVsYXBzZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY2FsbGJhY2sgPyAodGhpcy5fdGltZXIgLT0gZWxhcHNlZCwgdm9pZCAodGhpcy5fdGltZXIgPD0gMCAmJiAodGhpcy5fY2FsbGJhY2soKSwgCiAgICAgICAgdGhpcy5fcmVwZWF0ID8gdGhpcy5fdGltZXIgKz0gdGhpcy5fZGVsYXkgOiB0aGlzLl9hdXRvRGVzdHJveSA/IHRoaXMuZGVzdHJveSgpIDogY2xvdWRraWQuT1MuaW5zdGFuY2UucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpKSkpIDogdm9pZCB0aGlzLmRlc3Ryb3koKTsKICAgIH0sIHAucmVzdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLl9jYWxsYmFjaykgewogICAgICAgICAgICB2YXIgb3MgPSBjbG91ZGtpZC5PUy5pbnN0YW5jZTsKICAgICAgICAgICAgb3MuYWRkVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQsIHRoaXMuX3VwZGF0ZSksIHRoaXMuX3RpbWVyID0gdGhpcy5fZGVsYXksIHRoaXMuX3BhdXNlZCA9ICExOwogICAgICAgIH0KICAgIH0sIHAuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNsb3Vka2lkLk9TLmluc3RhbmNlLnJlbW92ZVVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkKSwgdGhpcy5fcGF1c2VkID0gITE7CiAgICB9LCBPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInBhdXNlZCIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcGF1c2VkOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBpZiAodGhpcy5fY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIHZhciBvcyA9IGNsb3Vka2lkLk9TLmluc3RhbmNlOwogICAgICAgICAgICAgICAgdGhpcy5fcGF1c2VkICYmICF2YWx1ZSA/ICh0aGlzLl9wYXVzZWQgPSAhMSwgb3MuaGFzVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpIHx8IG9zLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpKSA6IHZhbHVlICYmIG9zLmhhc1VwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkKSAmJiAodGhpcy5fcGF1c2VkID0gITAsIAogICAgICAgICAgICAgICAgb3MucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICBjbG91ZGtpZC5PUy5pbnN0YW5jZS5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCksIHRoaXMuX2NhbGxiYWNrID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5EZWxheWVkQ2FsbCA9IERlbGF5ZWRDYWxsOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIHAsIEFwcGxpY2F0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5pbml0aWFsaXplKCk7CiAgICB9OwogICAgcCA9IEFwcGxpY2F0aW9uLnByb3RvdHlwZSA9IG5ldyBjcmVhdGVqcy5Db250YWluZXIoKSwgcC5pbml0ID0gZnVuY3Rpb24oKSB7fSwgcC51cGRhdGUgPSBmdW5jdGlvbigpIHt9LCAKICAgIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkge30sIHAucmVzaXplID0gZnVuY3Rpb24oKSB7fSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLkFwcGxpY2F0aW9uID0gQXBwbGljYXRpb247Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgTG9hZGVyUXVldWVJdGVtID0gZnVuY3Rpb24oKSB7fSwgcCA9IExvYWRlclF1ZXVlSXRlbS5wcm90b3R5cGU7CiAgICBMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfSElHSCA9IDEsIExvYWRlclF1ZXVlSXRlbS5QUklPUklUWV9OT1JNQUwgPSAwLCBMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTE9XID0gLTEsIAogICAgcC51cmwgPSBudWxsLCBwLmRhdGEgPSBudWxsLCBwLmNhbGxiYWNrID0gbnVsbCwgcC5wcmlvcml0eSA9IDAsIHAucHJvZ3Jlc3MgPSAwLCAKICAgIHAudXBkYXRlQ2FsbGJhY2sgPSBudWxsLCBwLl9ib3VuZEZhaWwgPSBudWxsLCBwLl9ib3VuZFByb2dyZXNzID0gbnVsbCwgcC5fYm91bmRDb21wbGV0ZSA9IG51bGwsIAogICAgcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAiW0xvYWRlclF1ZXVlSXRlbSh1cmw6JyIgKyB0aGlzLnVybCArICInLCBwcmlvcml0eToiICsgdGhpcy5wcmlvcml0eSArICIpXSI7CiAgICB9LCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmNhbGxiYWNrID0gbnVsbCwgdGhpcy51cGRhdGVDYWxsYmFjayA9IG51bGwsIHRoaXMuZGF0YSA9IG51bGwsIHRoaXMuX2JvdW5kRmFpbCA9IG51bGwsIAogICAgICAgIHRoaXMuX2JvdW5kUHJvZ3Jlc3MgPSBudWxsLCB0aGlzLl9ib3VuZENvbXBsZXRlID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5Mb2FkZXJRdWV1ZUl0ZW0gPSBMb2FkZXJRdWV1ZUl0ZW07Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgTWVkaWFMb2FkZXIgPSBmdW5jdGlvbigpIHt9LCBwID0gTWVkaWFMb2FkZXIucHJvdG90eXBlOwogICAgTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbnVsbDsKICAgIHZhciBxdWV1ZSA9IG51bGwsIHF1ZXVlSXRlbXMgPSBudWxsLCBsb2FkZXJzID0gbnVsbCwgcWlQb29sID0gbnVsbCwgbG9hZGVyUG9vbCA9IG51bGwsIHJlc3VsdFBvb2wgPSBudWxsLCBudW1Mb2FkcyA9IDAsIHJldHJpZXMgPSBudWxsOwogICAgcC5fY2FuTG9hZCA9ICEwLCBwLm1heFNpbXVsdGFuZW91c0xvYWRzID0gMiwgcC5jYWNoZU1hbmFnZXIgPSBudWxsLCBNZWRpYUxvYWRlci5pbml0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIE1lZGlhTG9hZGVyLl9pbnN0YW5jZSB8fCAoTWVkaWFMb2FkZXIuX2luc3RhbmNlID0gbmV3IE1lZGlhTG9hZGVyKCksIE1lZGlhTG9hZGVyLl9pbnN0YW5jZS5faW5pdGlhbGl6ZSgpKSwgCiAgICAgICAgTWVkaWFMb2FkZXIuX2luc3RhbmNlOwogICAgfSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KE1lZGlhTG9hZGVyLCAiaW5zdGFuY2UiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCFNZWRpYUxvYWRlci5faW5zdGFuY2UpIHRocm93ICJDYWxsIGNsb3Vka2lkLk1lZGlhTG9hZGVyLmluaXQoKSI7CiAgICAgICAgICAgIHJldHVybiBNZWRpYUxvYWRlci5faW5zdGFuY2U7CiAgICAgICAgfQogICAgfSksIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBpLCBsZW4sIGtleSwgYXJyID0gdGhpcy5xdWV1ZTsKICAgICAgICBpZiAoYXJyKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGFyci5sZW5ndGg7IGkgPiBpOyArK2kpIGFycltpXS5kZXN0cm95KCk7CiAgICAgICAgICAgIGZvciAoYXJyID0gcWlQb29sLCBpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA+IGk7ICsraSkgYXJyW2ldLmRlc3Ryb3koKTsKICAgICAgICAgICAgZm9yIChhcnIgPSByZXN1bHRQb29sLCBpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA+IGk7ICsraSkgYXJyW2ldLmRlc3Ryb3koKTsKICAgICAgICAgICAgZm9yIChrZXkgaW4gbG9hZGVycykgcXVldWVJdGVtc1trZXldLmRlc3Ryb3koKSwgbG9hZGVyc1trZXldLmNsb3NlKCk7CiAgICAgICAgfQogICAgICAgIE1lZGlhTG9hZGVyLl9pbnN0YW5jZSA9IG51bGwsIHRoaXMuY2FjaGVNYW5hZ2VyICYmIHRoaXMuY2FjaGVNYW5hZ2VyLmRlc3Ryb3koKSwgCiAgICAgICAgdGhpcy5jYWNoZU1hbmFnZXIgPSBudWxsLCBxdWV1ZSA9IG51bGwsIHJlc3VsdFBvb2wgPSBudWxsLCBsb2FkZXJQb29sID0gbnVsbCwgcWlQb29sID0gbnVsbCwgCiAgICAgICAgcXVldWVJdGVtcyA9IG51bGwsIHJldHJpZXMgPSBudWxsLCBsb2FkZXJzID0gbnVsbDsKICAgIH0sIHAuX2luaXRpYWxpemUgPSBmdW5jdGlvbigpIHsKICAgICAgICBxaVBvb2wgPSBbXSwgbG9hZGVyUG9vbCA9IFtdLCByZXN1bHRQb29sID0gW10sIHF1ZXVlID0gW10sIHF1ZXVlSXRlbXMgPSB7fSwgbG9hZGVycyA9IHt9LCAKICAgICAgICByZXRyaWVzID0ge30sIHRoaXMuY2FjaGVNYW5hZ2VyID0gbmV3IGNsb3Vka2lkLkNhY2hlTWFuYWdlcigpOwogICAgfSwgcC5sb2FkID0gZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgdXBkYXRlQ2FsbGJhY2ssIHByaW9yaXR5LCBkYXRhKSB7CiAgICAgICAgdmFyIHFpID0gdGhpcy5fZ2V0UUkoKSwgYmFzZVBhdGggPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5vcHRpb25zLmJhc2VQYXRoOwogICAgICAgIHZvaWQgMCAhPT0gYmFzZVBhdGggJiYgL15odHRwKHMpP1w6Ly50ZXN0KHVybCkgPT09ICExICYmIC0xID09IHVybC5zZWFyY2goYmFzZVBhdGgpICYmIChxaS5iYXNlUGF0aCA9IGJhc2VQYXRoKSwgCiAgICAgICAgcWkudXJsID0gdXJsLCBxaS5jYWxsYmFjayA9IGNhbGxiYWNrLCBxaS51cGRhdGVDYWxsYmFjayA9IHVwZGF0ZUNhbGxiYWNrIHx8IG51bGwsIAogICAgICAgIHFpLnByaW9yaXR5ID0gcHJpb3JpdHkgfHwgY2xvdWRraWQuTG9hZGVyUXVldWVJdGVtLlBSSU9SSVRZX05PUk1BTCwgcWkuZGF0YSA9IGRhdGEgfHwgbnVsbCwgCiAgICAgICAgcXVldWUucHVzaChxaSksIHF1ZXVlLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgICByZXR1cm4gYS5wcmlvcml0eSAtIGIucHJpb3JpdHk7CiAgICAgICAgfSksIHRoaXMuX3RyeU5leHRMb2FkKCk7CiAgICB9LCBwLl9vbkxvYWRGYWlsZWQgPSBmdW5jdGlvbihxaSwgZXZlbnQpIHsKICAgICAgICBEZWJ1Zy5lcnJvcigiVW5hYmxlIHRvIGxvYWQgZmlsZTogIiArIHFpLnVybCArICIgLSByZWFzb246ICIgKyBldmVudC5lcnJvcik7CiAgICAgICAgdmFyIGxvYWRlciA9IGxvYWRlcnNbcWkudXJsXTsKICAgICAgICBsb2FkZXIucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMoKSwgbG9hZGVyLmNsb3NlKCksIHRoaXMuX3Bvb2xMb2FkZXIobG9hZGVyKSwgZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXSwgCiAgICAgICAgZGVsZXRlIGxvYWRlcnNbcWkudXJsXSwgcmV0cmllc1txaS51cmxdID8gcmV0cmllc1txaS51cmxdKysgOiByZXRyaWVzW3FpLnVybF0gPSAxLCAKICAgICAgICByZXRyaWVzW3FpLnVybF0gPiAzID8gdGhpcy5fbG9hZERvbmUocWksIG51bGwpIDogKG51bUxvYWRzLS0sIHF1ZXVlLnB1c2gocWkpLCB0aGlzLl90cnlOZXh0TG9hZCgpKTsKICAgIH0sIHAuX29uTG9hZFByb2dyZXNzID0gZnVuY3Rpb24ocWksIGV2ZW50KSB7CiAgICAgICAgcWkucHJvZ3Jlc3MgPSBldmVudC5wcm9ncmVzcywgcWkudXBkYXRlQ2FsbGJhY2sgJiYgcWkudXBkYXRlQ2FsbGJhY2socWkucHJvZ3Jlc3MpOwogICAgfSwgcC5fb25Mb2FkQ29tcGxldGVkID0gZnVuY3Rpb24ocWksIGV2KSB7CiAgICAgICAgRGVidWcubG9nKCJGaWxlIGxvYWRlZCBzdWNjZXNzZnVsbHkgZnJvbSAiICsgcWkudXJsKTsKICAgICAgICB2YXIgbG9hZGVyID0gbG9hZGVyc1txaS51cmxdOwogICAgICAgIGxvYWRlci5yZW1vdmVBbGxFdmVudExpc3RlbmVycygpLCBsb2FkZXIuY2xvc2UoKSwgdGhpcy5fcG9vbExvYWRlcihsb2FkZXIpLCBkZWxldGUgcXVldWVJdGVtc1txaS51cmxdLCAKICAgICAgICBkZWxldGUgbG9hZGVyc1txaS51cmxdLCB0aGlzLl9sb2FkRG9uZShxaSwgdGhpcy5fZ2V0UmVzdWx0KGV2LnJlc3VsdCwgcWkudXJsLCBsb2FkZXIpKTsKICAgIH0sIHAuX3RyeU5leHRMb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCEobnVtTG9hZHMgPiB0aGlzLm1heFNpbXVsdGFuZW91c0xvYWRzIC0gMSB8fCAwID09PSBxdWV1ZS5sZW5ndGgpKSB7CiAgICAgICAgICAgIG51bUxvYWRzKys7CiAgICAgICAgICAgIHZhciBxaSA9IHF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgICAgIERlYnVnLmxvZygiQXR0ZW1wdGluZyB0byBsb2FkIGZpbGUgJyIgKyBxaS51cmwgKyAiJyIpLCBxdWV1ZUl0ZW1zW3FpLnVybF0gPSBxaTsKICAgICAgICAgICAgdmFyIGxvYWRlciA9IHRoaXMuX2dldExvYWRlcihxaS5iYXNlUGF0aCk7CiAgICAgICAgICAgIGxvYWRlcnNbcWkudXJsXSA9IGxvYWRlciwgbG9hZGVyLmFkZEV2ZW50TGlzdGVuZXIoImZpbGVsb2FkIiwgcWkuX2JvdW5kQ29tcGxldGUpLCAKICAgICAgICAgICAgbG9hZGVyLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIiwgcWkuX2JvdW5kRmFpbCksIGxvYWRlci5hZGRFdmVudExpc3RlbmVyKCJmaWxlcHJvZ3Jlc3MiLCBxaS5fYm91bmRQcm9ncmVzcyk7CiAgICAgICAgICAgIHZhciB1cmwgPSB0aGlzLmNhY2hlTWFuYWdlci5wcmVwYXJlKHFpLnVybCk7CiAgICAgICAgICAgIGxvYWRlci5sb2FkRmlsZShxaS5kYXRhID8gewogICAgICAgICAgICAgICAgaWQ6IHFpLmRhdGEuaWQsCiAgICAgICAgICAgICAgICBzcmM6IHVybCwKICAgICAgICAgICAgICAgIGRhdGE6IHFpLmRhdGEKICAgICAgICAgICAgfSA6IHVybCk7CiAgICAgICAgfQogICAgfSwgcC5fbG9hZERvbmUgPSBmdW5jdGlvbihxaSwgcmVzdWx0KSB7CiAgICAgICAgbnVtTG9hZHMtLSwgcWkuZGF0YSAmJiByZXN1bHQgJiYgKHJlc3VsdC5pZCA9IHFpLmRhdGEuaWQpLCBxaS5jYWxsYmFjayhyZXN1bHQpLCAKICAgICAgICB0aGlzLl9wb29sUUkocWkpLCB0aGlzLl90cnlOZXh0TG9hZCgpOwogICAgfSwgcC5jYW5jZWwgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICB2YXIgcWkgPSBxdWV1ZUl0ZW1zW3VybF0sIGxvYWRlciA9IGxvYWRlcnNbdXJsXTsKICAgICAgICBpZiAocWkgJiYgbG9hZGVyKSByZXR1cm4gbG9hZGVyLmNsb3NlKCksIGRlbGV0ZSBsb2FkZXJzW3VybF0sIGRlbGV0ZSBxdWV1ZUl0ZW1zW3FpLnVybF0sIAogICAgICAgIG51bUxvYWRzLS0sIHRoaXMuX3Bvb2xMb2FkZXIobG9hZGVyKSwgdGhpcy5fcG9vbFFJKHFpKSwgITA7CiAgICAgICAgZm9yIChpID0gMCwgbGVuID0gcXVldWUubGVuZ3RoOyBsZW4gPiBpOyBpKyspIGlmIChxaSA9IHF1ZXVlW2ldLCBxaS51cmwgPT0gdXJsKSByZXR1cm4gcXVldWUuc3BsaWNlKGksIDEpLCAKICAgICAgICB0aGlzLl9wb29sUUkocWkpLCAhMDsKICAgICAgICByZXR1cm4gITE7CiAgICB9LCBwLl9nZXRRSSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBydG47CiAgICAgICAgcmV0dXJuIHFpUG9vbC5sZW5ndGggPyBydG4gPSBxaVBvb2wucG9wKCkgOiAocnRuID0gbmV3IGNsb3Vka2lkLkxvYWRlclF1ZXVlSXRlbSgpLCAKICAgICAgICBydG4uX2JvdW5kRmFpbCA9IHRoaXMuX29uTG9hZEZhaWxlZC5iaW5kKHRoaXMsIHJ0biksIHJ0bi5fYm91bmRQcm9ncmVzcyA9IHRoaXMuX29uTG9hZFByb2dyZXNzLmJpbmQodGhpcywgcnRuKSwgCiAgICAgICAgcnRuLl9ib3VuZENvbXBsZXRlID0gdGhpcy5fb25Mb2FkQ29tcGxldGVkLmJpbmQodGhpcywgcnRuKSksIHJ0bjsKICAgIH0sIHAuX3Bvb2xRSSA9IGZ1bmN0aW9uKHFpKSB7CiAgICAgICAgcWlQb29sLnB1c2gocWkpLCBxaS5jYWxsYmFjayA9IHFpLnVwZGF0ZUNhbGxiYWNrID0gcWkuZGF0YSA9IHFpLnVybCA9IG51bGwsIHFpLnByb2dyZXNzID0gMDsKICAgIH0sIHAuX2dldExvYWRlciA9IGZ1bmN0aW9uKGJhc2VQYXRoKSB7CiAgICAgICAgdmFyIHJ0bjsKICAgICAgICByZXR1cm4gbG9hZGVyUG9vbC5sZW5ndGggPyAocnRuID0gbG9hZGVyUG9vbC5wb3AoKSwgcnRuLl9iYXNlUGF0aCA9IGJhc2VQYXRoKSA6IHJ0biA9IG5ldyBjcmVhdGVqcy5Mb2FkUXVldWUoITAsIGJhc2VQYXRoKSwgCiAgICAgICAgY3JlYXRlanMuU291bmQgJiYgcnRuLmluc3RhbGxQbHVnaW4oY3JlYXRlanMuU291bmQpLCBydG47CiAgICB9LCBwLl9wb29sTG9hZGVyID0gZnVuY3Rpb24obG9hZGVyKSB7CiAgICAgICAgbG9hZGVyLnJlbW92ZUFsbCgpLCBsb2FkZXJQb29sLnB1c2gobG9hZGVyKTsKICAgIH0sIHAuX2dldFJlc3VsdCA9IGZ1bmN0aW9uKHJlc3VsdCwgdXJsLCBsb2FkZXIpIHsKICAgICAgICB2YXIgcnRuOwogICAgICAgIHJldHVybiByZXN1bHRQb29sLmxlbmd0aCA/IChydG4gPSByZXN1bHRQb29sLnBvcCgpLCBydG4uY29udGVudCA9IHJlc3VsdCwgcnRuLnVybCA9IHVybCwgCiAgICAgICAgcnRuLmxvYWRlciA9IGxvYWRlcikgOiBydG4gPSBuZXcgY2xvdWRraWQuTWVkaWFMb2FkZXJSZXN1bHQocmVzdWx0LCB1cmwsIGxvYWRlciksIAogICAgICAgIHJ0bjsKICAgIH0sIHAuX3Bvb2xSZXN1bHQgPSBmdW5jdGlvbihyZXN1bHQpIHsKICAgICAgICByZXN1bHQuY29udGVudCA9IHJlc3VsdC51cmwgPSByZXN1bHQubG9hZGVyID0gcmVzdWx0LmlkID0gbnVsbCwgcmVzdWx0UG9vbC5wdXNoKHJlc3VsdCk7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuTWVkaWFMb2FkZXIgPSBNZWRpYUxvYWRlcjsKfSgpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBNZWRpYUxvYWRlclJlc3VsdCA9IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCwgbG9hZGVyKSB7CiAgICAgICAgdGhpcy5jb250ZW50ID0gY29udGVudCwgdGhpcy51cmwgPSB1cmwsIHRoaXMubG9hZGVyID0gbG9hZGVyOwogICAgfSwgcCA9IE1lZGlhTG9hZGVyUmVzdWx0LnByb3RvdHlwZTsKICAgIHAuY29udGVudCA9IG51bGwsIHAudXJsID0gbnVsbCwgcC5sb2FkZXIgPSBudWxsLCBwLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICJbTWVkaWFMb2FkZXJSZXN1bHQoJyIgKyB0aGlzLnVybCArICInKV0iOwogICAgfSwgcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5jYWxsYmFjayA9IG51bGwsIHRoaXMudXJsID0gbnVsbCwgdGhpcy5jb250ZW50ID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5NZWRpYUxvYWRlclJlc3VsdCA9IE1lZGlhTG9hZGVyUmVzdWx0Owp9KCksIGZ1bmN0aW9uKHVuZGVmaW5lZCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIENhY2hlTWFuYWdlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgfSwgcCA9IENhY2hlTWFuYWdlci5wcm90b3R5cGUgPSB7fTsKICAgIHAuX3ZlcnNpb25zID0gbnVsbCwgcC5jYWNoZUJ1c3QgPSAhMSwgcC5pbml0aWFsaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fdmVyc2lvbnMgPSBbXTsKICAgICAgICB2YXIgY2IgPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5vcHRpb25zLmNhY2hlQnVzdDsKICAgICAgICB0aGlzLmNhY2hlQnVzdCA9IGNiID8gInRydWUiID09PSBjYiB8fCBjYiA9PT0gITAgOiAhMSwgdGhpcy5jYWNoZUJ1c3QgJiYgRGVidWcubG9nKCJDYWNoZUJ1c3QgYWxsIGZpbGVzIGlzIG9uLiIpOwogICAgfSwgcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fdmVyc2lvbnMgPSBudWxsOwogICAgfSwgcC5hZGRWZXJzaW9uc0ZpbGUgPSBmdW5jdGlvbih1cmwsIGNhbGxiYWNrLCBiYXNlVXJsKSB7CiAgICAgICAgRGVidWcuYXNzZXJ0KC9eLipcLnR4dCQvLnRlc3QodXJsKSwgIlRoZSB2ZXJzaW9ucyBmaWxlIG11c3QgYmUgYSAqLnR4dCBmaWxlIik7CiAgICAgICAgdmFyIG1sID0gY2xvdWRraWQuTWVkaWFMb2FkZXIuaW5zdGFuY2U7CiAgICAgICAgaWYgKHRoaXMuY2FjaGVCdXN0KSByZXR1cm4gdm9pZCAoY2FsbGJhY2sgJiYgY2FsbGJhY2soKSk7CiAgICAgICAgdGhpcy5hZGRWZXJzaW9uKHVybCwgTWF0aC5yb3VuZCgxZTUgKiBNYXRoLnJhbmRvbSgpKSk7CiAgICAgICAgdmFyIGNtID0gdGhpczsKICAgICAgICBtbC5sb2FkKHVybCwgZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmNvbnRlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBpLCBwYXJ0cywgbGluZXMgPSByZXN1bHQuY29udGVudC5yZXBsYWNlKC9cci9nLCAiIikuc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGluZXMubGVuZ3RoOyBpKyspIGxpbmVzW2ldICYmIChwYXJ0cyA9IGxpbmVzW2ldLnNwbGl0KCIgIiksIDIgPT0gcGFydHMubGVuZ3RoICYmIGNtLmFkZFZlcnNpb24oKGJhc2VVcmwgfHwgIiIpICsgcGFydHNbMF0sIHBhcnRzWzFdKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soKTsKICAgICAgICB9KTsKICAgIH0sIHAuYWRkVmVyc2lvbiA9IGZ1bmN0aW9uKHVybCwgdmVyc2lvbikgewogICAgICAgIHZhciB2ZXIgPSB0aGlzLl9nZXRWZXJzaW9uQnlVcmwodXJsKTsKICAgICAgICB2ZXIgfHwgdGhpcy5fdmVyc2lvbnMucHVzaCh7CiAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICB2ZXJzaW9uOiB2ZXJzaW9uCiAgICAgICAgfSk7CiAgICB9LCBwLl9nZXRWZXJzaW9uQnlVcmwgPSBmdW5jdGlvbih1cmwpIHsKICAgICAgICB2YXIgaSwgbGVuID0gdGhpcy5fdmVyc2lvbnMubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDA7IGxlbiA+IGk7IGkrKykgaWYgKHVybCA9PSB0aGlzLl92ZXJzaW9uc1tpXS51cmwpIHJldHVybiB0aGlzLl92ZXJzaW9uc1tpXTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sIHAucHJlcGFyZSA9IGZ1bmN0aW9uKHVybCwgYXBwbHlCYXNlUGF0aCkgewogICAgICAgIHZhciB2ZXIgPSB0aGlzLl9nZXRWZXJzaW9uQnlVcmwodXJsKTsKICAgICAgICBpZiAodGhpcy5jYWNoZUJ1c3QgJiYgLyhcP3xcJiljYlw9WzAtOV0qLy50ZXN0KHVybCkgPT09ICExID8gKHRoaXMuX2NiVmFsIHx8ICh0aGlzLl9jYlZhbCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLnRvU3RyaW5nKCkpLCAKICAgICAgICB1cmwgPSB1cmwgKyAodXJsLmluZGV4T2YoIj8iKSA8IDAgPyAiPyIgOiAiJiIpICsgImNiPSIgKyB0aGlzLl9jYlZhbCkgOiB2ZXIgJiYgLyhcP3xcJil2XD1bMC05XSovLnRlc3QodXJsKSA9PT0gITEgJiYgKHVybCA9IHVybCArICh1cmwuaW5kZXhPZigiPyIpIDwgMCA/ICI/IiA6ICImIikgKyAidj0iICsgdmVyLnZlcnNpb24pLCAKICAgICAgICBhcHBseUJhc2VQYXRoKSB7CiAgICAgICAgICAgIHZhciBiYXNlUGF0aCA9IGNsb3Vka2lkLk9TLmluc3RhbmNlLm9wdGlvbnMuYmFzZVBhdGg7CiAgICAgICAgICAgIC9eaHR0cChzKT9cOi8udGVzdCh1cmwpID09PSAhMSAmJiBiYXNlUGF0aCAhPT0gdW5kZWZpbmVkICYmIC0xID09IHVybC5zZWFyY2goYmFzZVBhdGgpICYmICh1cmwgPSBiYXNlUGF0aCArIHVybCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB1cmw7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuQ2FjaGVNYW5hZ2VyID0gQ2FjaGVNYW5hZ2VyOwp9KCksIGZ1bmN0aW9uKHVuZGVmaW5lZCkgewogICAgInVzZSBzdHJpY3QiOwogICAgZnVuY3Rpb24gY2xvbmUob2JqKSB7CiAgICAgICAgaWYgKCFvYmogfHwgIm9iamVjdCIgIT0gdHlwZW9mIG9iaikgcmV0dXJuIG51bGw7CiAgICAgICAgdmFyIGNvcHkgPSBvYmouY29uc3RydWN0b3IoKTsKICAgICAgICBmb3IgKHZhciBhdHRyIGluIG9iaikgb2JqLmhhc093blByb3BlcnR5KGF0dHIpICYmIChjb3B5W2F0dHJdID0gb2JqW2F0dHJdKTsKICAgICAgICByZXR1cm4gY29weTsKICAgIH0KICAgIHZhciBCdXR0b24gPSBmdW5jdGlvbihpbWFnZVNldHRpbmdzLCBsYWJlbCwgZW5hYmxlZCkgewogICAgICAgIGltYWdlU2V0dGluZ3MgJiYgdGhpcy5pbml0aWFsaXplKGltYWdlU2V0dGluZ3MsIGxhYmVsLCBlbmFibGVkKTsKICAgIH0sIHAgPSBCdXR0b24ucHJvdG90eXBlID0gbmV3IGNyZWF0ZWpzLkNvbnRhaW5lcigpLCBzID0gY3JlYXRlanMuQ29udGFpbmVyLnByb3RvdHlwZTsKICAgIHAuYmFjayA9IG51bGwsIHAubGFiZWwgPSBudWxsLCBwLl9vdmVyQ0IgPSBudWxsLCBwLl9vdXRDQiA9IG51bGwsIHAuX2Rvd25DQiA9IG51bGwsIAogICAgcC5fdXBDQiA9IG51bGwsIHAuX2NsaWNrQ0IgPSBudWxsLCBwLl9zdGF0ZUZsYWdzID0gbnVsbCwgcC5fc3RhdGVQcmlvcml0eSA9IG51bGwsIAogICAgcC5fc3RhdGVEYXRhID0gbnVsbCwgcC5fd2lkdGggPSAwLCBwLl9oZWlnaHQgPSAwLCBwLl9vZmZzZXQgPSBudWxsLCBCdXR0b24uQlVUVE9OX1BSRVNTID0gImJ1dHRvblByZXNzIjsKICAgIHZhciBSRVNFUlZFRF9TVEFURVMgPSBbICJkaXNhYmxlZCIsICJlbmFibGVkIiwgInVwIiwgIm92ZXIiLCAiZG93biIgXSwgREVGQVVMVF9QUklPUklUWSA9IFsgImRpc2FibGVkIiwgImRvd24iLCAib3ZlciIsICJ1cCIgXTsKICAgIHAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKGltYWdlU2V0dGluZ3MsIGxhYmVsLCBlbmFibGVkKSB7CiAgICAgICAgcy5pbml0aWFsaXplLmNhbGwodGhpcyksIHRoaXMubW91c2VDaGlsZHJlbiA9ICExLCB0aGlzLl9kb3duQ0IgPSB0aGlzLl9vbk1vdXNlRG93bi5iaW5kKHRoaXMpLCAKICAgICAgICB0aGlzLl91cENCID0gdGhpcy5fb25Nb3VzZVVwLmJpbmQodGhpcyksIHRoaXMuX292ZXJDQiA9IHRoaXMuX29uTW91c2VPdmVyLmJpbmQodGhpcyksIAogICAgICAgIHRoaXMuX291dENCID0gdGhpcy5fb25Nb3VzZU91dC5iaW5kKHRoaXMpLCB0aGlzLl9jbGlja0NCID0gdGhpcy5fb25DbGljay5iaW5kKHRoaXMpOwogICAgICAgIHZhciBfc3RhdGVEYXRhID0gdGhpcy5fc3RhdGVEYXRhID0ge307CiAgICAgICAgdGhpcy5fc3RhdGVGbGFncyA9IHt9LCB0aGlzLl9vZmZzZXQgPSBuZXcgY3JlYXRlanMuUG9pbnQoKTsKICAgICAgICB2YXIgbGFiZWxEYXRhOwogICAgICAgIGxhYmVsICYmIChsYWJlbERhdGEgPSBjbG9uZShsYWJlbCksIGRlbGV0ZSBsYWJlbERhdGEudGV4dCwgbGFiZWxEYXRhLnggPT09IHVuZGVmaW5lZCAmJiAobGFiZWxEYXRhLnggPSAiY2VudGVyIiksIAogICAgICAgIGxhYmVsRGF0YS55ID09PSB1bmRlZmluZWQgJiYgKGxhYmVsRGF0YS55ID0gImNlbnRlciIpKTsKICAgICAgICB2YXIgaW1hZ2UsIHdpZHRoLCBoZWlnaHQsIGksIHN0YXRlOwogICAgICAgIGlmIChpbWFnZVNldHRpbmdzLmltYWdlKSB7CiAgICAgICAgICAgIGZvciAoaW1hZ2UgPSBpbWFnZVNldHRpbmdzLmltYWdlLCB0aGlzLl9zdGF0ZVByaW9yaXR5ID0gaW1hZ2VTZXR0aW5ncy5wcmlvcml0eSB8fCBERUZBVUxUX1BSSU9SSVRZLCAKICAgICAgICAgICAgaSA9IHRoaXMuX3N0YXRlUHJpb3JpdHkubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgICAgICAgIHN0YXRlID0gdGhpcy5fc3RhdGVQcmlvcml0eVtpXSwgdGhpcy5fYWRkUHJvcGVydHkoc3RhdGUpLCAiZGlzYWJsZWQiICE9IHN0YXRlICYmICJ1cCIgIT0gc3RhdGUgJiYgKHRoaXMuX3N0YXRlRmxhZ3Nbc3RhdGVdID0gITEpOwogICAgICAgICAgICAgICAgdmFyIGlucHV0RGF0YSA9IGltYWdlU2V0dGluZ3Nbc3RhdGVdOwogICAgICAgICAgICAgICAgaWYgKF9zdGF0ZURhdGFbc3RhdGVdID0gaW5wdXREYXRhID8gY2xvbmUoaW5wdXREYXRhKSA6IF9zdGF0ZURhdGEudXAsIGxhYmVsKSBpZiAoaW5wdXREYXRhICYmIGlucHV0RGF0YS5sYWJlbCkgewogICAgICAgICAgICAgICAgICAgIGlucHV0RGF0YSA9IGlucHV0RGF0YS5sYWJlbDsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RhdGVMYWJlbCA9IF9zdGF0ZURhdGFbc3RhdGVdLmxhYmVsID0ge307CiAgICAgICAgICAgICAgICAgICAgc3RhdGVMYWJlbC5mb250ID0gaW5wdXREYXRhLmZvbnQgfHwgbGFiZWxEYXRhLmZvbnQsIHN0YXRlTGFiZWwuY29sb3IgPSBpbnB1dERhdGEuY29sb3IgfHwgbGFiZWxEYXRhLmNvbG9yLCAKICAgICAgICAgICAgICAgICAgICBzdGF0ZUxhYmVsLnN0cm9rZSA9IGlucHV0RGF0YS5oYXNPd25Qcm9wZXJ0eSgic3Ryb2tlIikgPyBpbnB1dERhdGEuc3Ryb2tlIDogbGFiZWxEYXRhLnN0cm9rZSwgCiAgICAgICAgICAgICAgICAgICAgc3RhdGVMYWJlbC5zaGFkb3cgPSBpbnB1dERhdGEuaGFzT3duUHJvcGVydHkoInNoYWRvdyIpID8gaW5wdXREYXRhLnNoYWRvdyA6IGxhYmVsRGF0YS5zaGFkb3csIAogICAgICAgICAgICAgICAgICAgIHN0YXRlTGFiZWwudGV4dEJhc2VsaW5lID0gaW5wdXREYXRhLnRleHRCYXNlbGluZSB8fCBsYWJlbERhdGEudGV4dEJhc2VsaW5lLCBzdGF0ZUxhYmVsLnggPSBpbnB1dERhdGEueCB8fCBsYWJlbERhdGEueCwgCiAgICAgICAgICAgICAgICAgICAgc3RhdGVMYWJlbC55ID0gaW5wdXREYXRhLnkgfHwgbGFiZWxEYXRhLnk7CiAgICAgICAgICAgICAgICB9IGVsc2UgX3N0YXRlRGF0YVtzdGF0ZV0ubGFiZWwgPSBsYWJlbERhdGE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKF9zdGF0ZURhdGEudXAudHJpbSkgewogICAgICAgICAgICAgICAgdmFyIHVwVHJpbSA9IF9zdGF0ZURhdGEudXAudHJpbTsKICAgICAgICAgICAgICAgIHdpZHRoID0gdXBUcmltLndpZHRoLCBoZWlnaHQgPSB1cFRyaW0uaGVpZ2h0OwogICAgICAgICAgICB9IGVsc2Ugd2lkdGggPSBfc3RhdGVEYXRhLnVwLnNyYy53aWR0aCwgaGVpZ2h0ID0gX3N0YXRlRGF0YS51cC5zcmMuaGVpZ2h0OwogICAgICAgICAgICBfc3RhdGVEYXRhLnVwIHx8IChEZWJ1Zy5lcnJvcigiQnV0dG9uIGxhY2tzIGFuIHVwIHN0YXRlISBUaGlzIGlzIGEgc2VyaW91cyBwcm9ibGVtISBJbnB1dCBkYXRhIGZvbGxvd3M6IiksIAogICAgICAgICAgICBEZWJ1Zy5lcnJvcihpbWFnZVNldHRpbmdzKSksIF9zdGF0ZURhdGEub3ZlciB8fCAoX3N0YXRlRGF0YS5vdmVyID0gX3N0YXRlRGF0YS51cCksIAogICAgICAgICAgICBfc3RhdGVEYXRhLmRvd24gfHwgKF9zdGF0ZURhdGEuZG93biA9IF9zdGF0ZURhdGEudXApLCBfc3RhdGVEYXRhLmRpc2FibGVkIHx8IChfc3RhdGVEYXRhLmRpc2FibGVkID0gX3N0YXRlRGF0YS51cCksIAogICAgICAgICAgICBpbWFnZVNldHRpbmdzLm9mZnNldCA/ICh0aGlzLl9vZmZzZXQueCA9IGltYWdlU2V0dGluZ3Mub2Zmc2V0LngsIHRoaXMuX29mZnNldC55ID0gaW1hZ2VTZXR0aW5ncy5vZmZzZXQueSkgOiB0aGlzLl9vZmZzZXQueCA9IHRoaXMuX29mZnNldC55ID0gMDsKICAgICAgICB9IGVsc2UgaW1hZ2UgPSBpbWFnZVNldHRpbmdzLCB3aWR0aCA9IGltYWdlLndpZHRoLCBoZWlnaHQgPSBpbWFnZS5oZWlnaHQgLyAzLCB0aGlzLl9zdGF0ZVByaW9yaXR5ID0gREVGQVVMVF9QUklPUklUWSwgCiAgICAgICAgX3N0YXRlRGF0YS5kaXNhYmxlZCA9IF9zdGF0ZURhdGEudXAgPSB7CiAgICAgICAgICAgIHNyYzogbmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCAwLCB3aWR0aCwgaGVpZ2h0KQogICAgICAgIH0sIF9zdGF0ZURhdGEub3ZlciA9IHsKICAgICAgICAgICAgc3JjOiBuZXcgY3JlYXRlanMuUmVjdGFuZ2xlKDAsIGhlaWdodCwgd2lkdGgsIGhlaWdodCkKICAgICAgICB9LCBfc3RhdGVEYXRhLmRvd24gPSB7CiAgICAgICAgICAgIHNyYzogbmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCAyICogaGVpZ2h0LCB3aWR0aCwgaGVpZ2h0KQogICAgICAgIH0sIGxhYmVsRGF0YSAmJiAoX3N0YXRlRGF0YS51cC5sYWJlbCA9IF9zdGF0ZURhdGEub3Zlci5sYWJlbCA9IF9zdGF0ZURhdGEuZG93bi5sYWJlbCA9IF9zdGF0ZURhdGEuZGlzYWJsZWQubGFiZWwgPSBsYWJlbERhdGEpLCAKICAgICAgICB0aGlzLl9vZmZzZXQueCA9IHRoaXMuX29mZnNldC55ID0gMDsKICAgICAgICB0aGlzLmJhY2sgPSBuZXcgY3JlYXRlanMuQml0bWFwKGltYWdlKSwgdGhpcy5hZGRDaGlsZCh0aGlzLmJhY2spLCB0aGlzLl93aWR0aCA9IHdpZHRoLCAKICAgICAgICB0aGlzLl9oZWlnaHQgPSBoZWlnaHQsIGxhYmVsICYmICh0aGlzLmxhYmVsID0gbmV3IGNyZWF0ZWpzLlRleHQobGFiZWwudGV4dCB8fCAiIiwgX3N0YXRlRGF0YS51cC5sYWJlbC5mb250LCBfc3RhdGVEYXRhLnVwLmxhYmVsLmNvbG9yKSwgCiAgICAgICAgdGhpcy5hZGRDaGlsZCh0aGlzLmxhYmVsKSksIHRoaXMuZW5hYmxlZCA9IGVuYWJsZWQgPT09IHVuZGVmaW5lZCA/ICEwIDogISFlbmFibGVkOwogICAgfSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJ3aWR0aCIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fd2lkdGggKiB0aGlzLnNjYWxlWDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5zY2FsZVggPSB2YWx1ZSAvIHRoaXMuX3dpZHRoOwogICAgICAgIH0KICAgIH0pLCBPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgImhlaWdodCIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faGVpZ2h0ICogdGhpcy5zY2FsZVk7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuc2NhbGVZID0gdmFsdWUgLyB0aGlzLl9oZWlnaHQ7CiAgICAgICAgfQogICAgfSksIHAuc2V0VGV4dCA9IGZ1bmN0aW9uKHRleHQpIHsKICAgICAgICBpZiAodGhpcy5sYWJlbCkgewogICAgICAgICAgICB0aGlzLmxhYmVsLnRleHQgPSB0ZXh0OwogICAgICAgICAgICBmb3IgKHZhciBkYXRhLCBpID0gMDsgaSA8IHRoaXMuX3N0YXRlUHJpb3JpdHkubGVuZ3RoOyArK2kpIGlmICh0aGlzLl9zdGF0ZUZsYWdzW3RoaXMuX3N0YXRlUHJpb3JpdHlbaV1dKSB7CiAgICAgICAgICAgICAgICBkYXRhID0gdGhpcy5fc3RhdGVEYXRhW3RoaXMuX3N0YXRlUHJpb3JpdHlbaV1dOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGF0YSB8fCAoZGF0YSA9IHRoaXMuX3N0YXRlRGF0YS51cCksIGRhdGEgPSBkYXRhLmxhYmVsLCB0aGlzLmxhYmVsLnggPSAiY2VudGVyIiA9PSBkYXRhLnggPyAuNSAqICh0aGlzLl93aWR0aCAtIHRoaXMubGFiZWwuZ2V0TWVhc3VyZWRXaWR0aCgpKSArIHRoaXMuX29mZnNldC54IDogZGF0YS54ICsgdGhpcy5fb2Zmc2V0LngsIAogICAgICAgICAgICB0aGlzLmxhYmVsLnkgPSAiY2VudGVyIiA9PSBkYXRhLnkgPyAuNSAqIHRoaXMuX2hlaWdodCArIHRoaXMuX29mZnNldC55IDogZGF0YS55ICsgdGhpcy5fb2Zmc2V0Lnk7CiAgICAgICAgfQogICAgfSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJlbmFibGVkIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAhdGhpcy5fc3RhdGVGbGFncy5kaXNhYmxlZDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5fc3RhdGVGbGFncy5kaXNhYmxlZCA9ICF2YWx1ZSwgdmFsdWUgPyAodGhpcy5jdXJzb3IgPSAicG9pbnRlciIsIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgdGhpcy5fZG93bkNCKSwgCiAgICAgICAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcigibW91c2VvdmVyIiwgdGhpcy5fb3ZlckNCKSwgdGhpcy5hZGRFdmVudExpc3RlbmVyKCJtb3VzZW91dCIsIHRoaXMuX291dENCKSkgOiAodGhpcy5jdXJzb3IgPSBudWxsLCAKICAgICAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCB0aGlzLl9kb3duQ0IpLCB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlb3ZlciIsIHRoaXMuX292ZXJDQiksIAogICAgICAgICAgICB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlb3V0IiwgdGhpcy5fb3V0Q0IpLCB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoInByZXNzdXAiLCB0aGlzLl91cENCKSwgCiAgICAgICAgICAgIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLl9jbGlja0NCKSwgdGhpcy5fc3RhdGVGbGFncy5kb3duID0gdGhpcy5fc3RhdGVGbGFncy5vdmVyID0gITEpLCAKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUoKTsKICAgICAgICB9CiAgICB9KSwgcC5fYWRkUHJvcGVydHkgPSBmdW5jdGlvbihwcm9wZXJ0eU5hbWUpIHsKICAgICAgICBSRVNFUlZFRF9TVEFURVMuaW5kZXhPZihwcm9wZXJ0eU5hbWUpID49IDAgfHwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwgewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXRlRmxhZ3NbcHJvcGVydHlOYW1lXTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhdGVGbGFnc1twcm9wZXJ0eU5hbWVdID0gdmFsdWUsIHRoaXMuX3VwZGF0ZVN0YXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sIHAuX3VwZGF0ZVN0YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuYmFjaykgewogICAgICAgICAgICBmb3IgKHZhciBkYXRhLCBpID0gMDsgaSA8IHRoaXMuX3N0YXRlUHJpb3JpdHkubGVuZ3RoOyArK2kpIGlmICh0aGlzLl9zdGF0ZUZsYWdzW3RoaXMuX3N0YXRlUHJpb3JpdHlbaV1dKSB7CiAgICAgICAgICAgICAgICBkYXRhID0gdGhpcy5fc3RhdGVEYXRhW3RoaXMuX3N0YXRlUHJpb3JpdHlbaV1dOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGF0YSB8fCAoZGF0YSA9IHRoaXMuX3N0YXRlRGF0YS51cCksIHRoaXMuYmFjay5zb3VyY2VSZWN0ID0gZGF0YS5zcmMsIGRhdGEudHJpbSA/ICh0aGlzLmJhY2sueCA9IGRhdGEudHJpbS54ICsgdGhpcy5fb2Zmc2V0LngsIAogICAgICAgICAgICB0aGlzLmJhY2sueSA9IGRhdGEudHJpbS55ICsgdGhpcy5fb2Zmc2V0LnkpIDogKHRoaXMuYmFjay54ID0gdGhpcy5fb2Zmc2V0LngsIHRoaXMuYmFjay55ID0gdGhpcy5fb2Zmc2V0LnkpLCAKICAgICAgICAgICAgdGhpcy5sYWJlbCAmJiAoZGF0YSA9IGRhdGEubGFiZWwsIHRoaXMubGFiZWwudGV4dEJhc2VsaW5lID0gZGF0YS50ZXh0QmFzZWxpbmUgfHwgIm1pZGRsZSIsIAogICAgICAgICAgICB0aGlzLmxhYmVsLnN0cm9rZSA9IGRhdGEuc3Ryb2tlLCB0aGlzLmxhYmVsLnNoYWRvdyA9IGRhdGEuc2hhZG93LCB0aGlzLmxhYmVsLmZvbnQgPSBkYXRhLmZvbnQsIAogICAgICAgICAgICB0aGlzLmxhYmVsLmNvbG9yID0gZGF0YS5jb2xvciB8fCAiIzAwMCIsIHRoaXMubGFiZWwueCA9ICJjZW50ZXIiID09IGRhdGEueCA/IC41ICogKHRoaXMuX3dpZHRoIC0gdGhpcy5sYWJlbC5nZXRNZWFzdXJlZFdpZHRoKCkpICsgdGhpcy5fb2Zmc2V0LnggOiBkYXRhLnggKyB0aGlzLl9vZmZzZXQueCwgCiAgICAgICAgICAgIHRoaXMubGFiZWwueSA9ICJjZW50ZXIiID09IGRhdGEueSA/IC41ICogdGhpcy5faGVpZ2h0ICsgdGhpcy5fb2Zmc2V0LnkgOiBkYXRhLnkgKyB0aGlzLl9vZmZzZXQueSk7CiAgICAgICAgfQogICAgfSwgcC5fb25Nb3VzZURvd24gPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoInByZXNzdXAiLCB0aGlzLl91cENCKSwgdGhpcy5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuX2NsaWNrQ0IpLCAKICAgICAgICB0aGlzLl9zdGF0ZUZsYWdzLmRvd24gPSAhMCwgdGhpcy5fdXBkYXRlU3RhdGUoKTsKICAgIH0sIHAuX29uTW91c2VVcCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3N1cCIsIHRoaXMuX3VwQ0IpLCB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5fY2xpY2tDQiksIAogICAgICAgIHRoaXMuX3N0YXRlRmxhZ3MuZG93biA9ICExLCB0aGlzLl91cGRhdGVTdGF0ZSgpOwogICAgfSwgcC5fb25DbGljayA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChuZXcgY3JlYXRlanMuRXZlbnQoQnV0dG9uLkJVVFRPTl9QUkVTUykpOwogICAgfSwgcC5fb25Nb3VzZU92ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl9zdGF0ZUZsYWdzLm92ZXIgPSAhMCwgdGhpcy5fdXBkYXRlU3RhdGUoKTsKICAgIH0sIHAuX29uTW91c2VPdXQgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLl9zdGF0ZUZsYWdzLm92ZXIgPSAhMSwgdGhpcy5fdXBkYXRlU3RhdGUoKTsKICAgIH0sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucmVtb3ZlQWxsQ2hpbGRyZW4oKSwgdGhpcy5yZW1vdmVBbGxFdmVudExpc3RlbmVycygpLCB0aGlzLl9kb3duQ0IgPSBudWxsLCB0aGlzLl91cENCID0gbnVsbCwgCiAgICAgICAgdGhpcy5fb3ZlckNCID0gbnVsbCwgdGhpcy5fb3V0Q0IgPSBudWxsLCB0aGlzLmJhY2sgPSBudWxsLCB0aGlzLmxhYmVsID0gbnVsbCwgdGhpcy5fc3RhdGVQcmlvcml0eSA9IG51bGwsIAogICAgICAgIHRoaXMuX3N0YXRlRmxhZ3MgPSBudWxsLCB0aGlzLl9zdGF0ZURhdGEgPSBudWxsOwogICAgfSwgQnV0dG9uLmdlbmVyYXRlRGVmYXVsdFN0YXRlcyA9IGZ1bmN0aW9uKGltYWdlLCBkaXNhYmxlZFNldHRpbmdzLCBoaWdobGlnaHRTZXR0aW5ncykgewogICAgICAgIHZhciBidXR0b25XaWR0aCA9IGltYWdlLndpZHRoLCBidXR0b25IZWlnaHQgPSBpbWFnZS5oZWlnaHQgLyAzLCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKSwgd2lkdGggPSBidXR0b25XaWR0aCwgaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0OwogICAgICAgIGRpc2FibGVkU2V0dGluZ3MgJiYgKGhlaWdodCArPSBidXR0b25IZWlnaHQpLCBoaWdobGlnaHRTZXR0aW5ncyAmJiAod2lkdGggKz0gMiAqIGhpZ2hsaWdodFNldHRpbmdzLnNpemUsIAogICAgICAgIGhlaWdodCArPSBidXR0b25IZWlnaHQgKyAyICogaGlnaGxpZ2h0U2V0dGluZ3Muc2l6ZSksIGNhbnZhcy53aWR0aCA9IHdpZHRoLCBjYW52YXMuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHZhciBjb250ZXh0ID0gY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICAgICAgY29udGV4dC5kcmF3SW1hZ2UoaW1hZ2UsIDAsIDApOwogICAgICAgIHZhciBvdXRwdXQgPSB7CiAgICAgICAgICAgIGltYWdlOiBjYW52YXMsCiAgICAgICAgICAgIHVwOiB7CiAgICAgICAgICAgICAgICBzcmM6IG5ldyBjcmVhdGVqcy5SZWN0YW5nbGUoMCwgMCwgYnV0dG9uV2lkdGgsIGJ1dHRvbkhlaWdodCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb3ZlcjogewogICAgICAgICAgICAgICAgc3JjOiBuZXcgY3JlYXRlanMuUmVjdGFuZ2xlKDAsIGJ1dHRvbkhlaWdodCwgYnV0dG9uV2lkdGgsIGJ1dHRvbkhlaWdodCkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZG93bjogewogICAgICAgICAgICAgICAgc3JjOiBuZXcgY3JlYXRlanMuUmVjdGFuZ2xlKDAsIDIgKiBidXR0b25IZWlnaHQsIGJ1dHRvbldpZHRoLCBidXR0b25IZWlnaHQpCiAgICAgICAgICAgIH0KICAgICAgICB9LCBkcmF3aW5nQml0bWFwID0gbmV3IGNyZWF0ZWpzLkJpdG1hcChpbWFnZSk7CiAgICAgICAgZHJhd2luZ0JpdG1hcC5zb3VyY2VSZWN0ID0gb3V0cHV0LnVwLnNyYzsKICAgICAgICB2YXIgbmV4dFkgPSBpbWFnZS5oZWlnaHQ7CiAgICAgICAgaWYgKGRpc2FibGVkU2V0dGluZ3MpIHsKICAgICAgICAgICAgY29udGV4dC5zYXZlKCksIGNvbnRleHQudHJhbnNsYXRlKDAsIG5leHRZKTsKICAgICAgICAgICAgdmFyIG1hdHJpeCA9IG5ldyBjcmVhdGVqcy5Db2xvck1hdHJpeCgpOwogICAgICAgICAgICBkaXNhYmxlZFNldHRpbmdzLnNhdHVyYXRpb24gIT09IHVuZGVmaW5lZCAmJiBtYXRyaXguYWRqdXN0U2F0dXJhdGlvbihkaXNhYmxlZFNldHRpbmdzLnNhdHVyYXRpb24pLCAKICAgICAgICAgICAgZGlzYWJsZWRTZXR0aW5ncy5icmlnaHRuZXNzICE9PSB1bmRlZmluZWQgJiYgbWF0cml4LmFkanVzdEJyaWdodG5lc3MoMi41NSAqIGRpc2FibGVkU2V0dGluZ3MuYnJpZ2h0bmVzcyksIAogICAgICAgICAgICBkaXNhYmxlZFNldHRpbmdzLmNvbnRyYXN0ICE9PSB1bmRlZmluZWQgJiYgbWF0cml4LmFkanVzdENvbnRyYXN0KGRpc2FibGVkU2V0dGluZ3MuY29udHJhc3QpLCAKICAgICAgICAgICAgZHJhd2luZ0JpdG1hcC5maWx0ZXJzID0gWyBuZXcgY3JlYXRlanMuQ29sb3JNYXRyaXhGaWx0ZXIobWF0cml4KSBdLCBkcmF3aW5nQml0bWFwLmNhY2hlKDAsIDAsIG91dHB1dC51cC5zcmMud2lkdGgsIG91dHB1dC51cC5zcmMuaGVpZ2h0KSwgCiAgICAgICAgICAgIGRyYXdpbmdCaXRtYXAuZHJhdyhjb250ZXh0KSwgb3V0cHV0LmRpc2FibGVkID0gewogICAgICAgICAgICAgICAgc3JjOiBuZXcgY3JlYXRlanMuUmVjdGFuZ2xlKDAsIG5leHRZLCBidXR0b25XaWR0aCwgMCB8IGJ1dHRvbkhlaWdodCkKICAgICAgICAgICAgfSwgbmV4dFkgKz0gYnV0dG9uSGVpZ2h0LCBjb250ZXh0LnJlc3RvcmUoKTsKICAgICAgICB9CiAgICAgICAgaWYgKGhpZ2hsaWdodFNldHRpbmdzKSB7CiAgICAgICAgICAgIGNvbnRleHQuc2F2ZSgpOwogICAgICAgICAgICB2YXIgaGlnaGxpZ2h0U3RhdGVXaWR0aCA9IGJ1dHRvbldpZHRoICsgMiAqIGhpZ2hsaWdodFNldHRpbmdzLnNpemUsIGhpZ2hsaWdodFN0YXRlSGVpZ2h0ID0gYnV0dG9uSGVpZ2h0ICsgMiAqIGhpZ2hsaWdodFNldHRpbmdzLnNpemU7CiAgICAgICAgICAgIGRyYXdpbmdCaXRtYXAuZmlsdGVycyA9IFsgbmV3IGNyZWF0ZWpzLkNvbG9yRmlsdGVyKDAsIDAsIDAsIDEsIGhpZ2hsaWdodFNldHRpbmdzLnJlZCwgaGlnaGxpZ2h0U2V0dGluZ3MuZ3JlZW4sIGhpZ2hsaWdodFNldHRpbmdzLmJsdWUsIGhpZ2hsaWdodFNldHRpbmdzLmFscGhhICE9PSB1bmRlZmluZWQgPyAtMjU1ICsgaGlnaGxpZ2h0U2V0dGluZ3MuYWxwaGEgOiAwKSBdLCAKICAgICAgICAgICAgZHJhd2luZ0JpdG1hcC5zY2FsZVggPSBoaWdobGlnaHRTdGF0ZVdpZHRoIC8gYnV0dG9uV2lkdGgsIGRyYXdpbmdCaXRtYXAuc2NhbGVZID0gaGlnaGxpZ2h0U3RhdGVIZWlnaHQgLyBidXR0b25IZWlnaHQsIAogICAgICAgICAgICBkcmF3aW5nQml0bWFwLnggPSAwLCBkcmF3aW5nQml0bWFwLnkgPSBuZXh0WSwgZHJhd2luZ0JpdG1hcC5jYWNoZSgwLCAwLCBoaWdobGlnaHRTdGF0ZVdpZHRoLCBoaWdobGlnaHRTdGF0ZUhlaWdodCksIAogICAgICAgICAgICBkcmF3aW5nQml0bWFwLnVwZGF0ZUNvbnRleHQoY29udGV4dCksIGRyYXdpbmdCaXRtYXAuZHJhdyhjb250ZXh0KSwgY29udGV4dC5yZXN0b3JlKCksIAogICAgICAgICAgICBkcmF3aW5nQml0bWFwLnNjYWxlWCA9IGRyYXdpbmdCaXRtYXAuc2NhbGVZID0gMSwgZHJhd2luZ0JpdG1hcC54ID0gaGlnaGxpZ2h0U2V0dGluZ3Muc2l6ZSwgCiAgICAgICAgICAgIGRyYXdpbmdCaXRtYXAueSA9IG5leHRZICsgaGlnaGxpZ2h0U2V0dGluZ3Muc2l6ZSwgZHJhd2luZ0JpdG1hcC5maWx0ZXJzID0gbnVsbCwgCiAgICAgICAgICAgIGRyYXdpbmdCaXRtYXAudW5jYWNoZSgpLCBkcmF3aW5nQml0bWFwLnVwZGF0ZUNvbnRleHQoY29udGV4dCksIGRyYXdpbmdCaXRtYXAuZHJhdyhjb250ZXh0KTsKICAgICAgICAgICAgdmFyIHRyaW0gPSBuZXcgY3JlYXRlanMuUmVjdGFuZ2xlKGhpZ2hsaWdodFNldHRpbmdzLnNpemUsIGhpZ2hsaWdodFNldHRpbmdzLnNpemUsIGhpZ2hsaWdodFN0YXRlV2lkdGgsIGhpZ2hsaWdodFN0YXRlSGVpZ2h0KTsKICAgICAgICAgICAgb3V0cHV0LnVwLnRyaW0gPSB0cmltLCBvdXRwdXQub3Zlci50cmltID0gdHJpbSwgb3V0cHV0LmRvd24udHJpbSA9IHRyaW0sIG91dHB1dC5kaXNhYmxlZCAmJiAob3V0cHV0LmRpc2FibGVkLnRyaW0gPSB0cmltKSwgCiAgICAgICAgICAgIG91dHB1dC5oaWdobGlnaHRlZCA9IHsKICAgICAgICAgICAgICAgIHNyYzogbmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCBuZXh0WSwgMCB8IGhpZ2hsaWdodFN0YXRlV2lkdGgsIDAgfCBoaWdobGlnaHRTdGF0ZUhlaWdodCkKICAgICAgICAgICAgfSwgb3V0cHV0LnByaW9yaXR5ID0gREVGQVVMVF9QUklPUklUWS5zbGljZSgpLCBvdXRwdXQucHJpb3JpdHkudW5zaGlmdCgiaGlnaGxpZ2h0ZWQiKSwgCiAgICAgICAgICAgIG91dHB1dC5vZmZzZXQgPSB7CiAgICAgICAgICAgICAgICB4OiAtaGlnaGxpZ2h0U2V0dGluZ3Muc2l6ZSwKICAgICAgICAgICAgICAgIHk6IC1oaWdobGlnaHRTZXR0aW5ncy5zaXplCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuQnV0dG9uID0gQnV0dG9uOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIERyYWdNYW5hZ2VyID0gZnVuY3Rpb24oc3RhcnRDYWxsYmFjaywgZW5kQ2FsbGJhY2spIHsKICAgICAgICB0aGlzLmluaXRpYWxpemUoc3RhcnRDYWxsYmFjaywgZW5kQ2FsbGJhY2spOwogICAgfSwgcCA9IERyYWdNYW5hZ2VyLnByb3RvdHlwZSA9IHt9OwogICAgcC5kcmFnZ2VkT2JqID0gbnVsbCwgcC5kcmFnU3RhcnRUaHJlc2hvbGQgPSAyMCwgcC5tb3VzZURvd25TdGFnZVBvcyA9IG51bGwsIHAubW91c2VEb3duT2JqUG9zID0gbnVsbCwgCiAgICBwLmFsbG93U3RpY2t5Q2xpY2sgPSAhMCwgcC5pc1RvdWNoTW92ZSA9ICExLCBwLmlzSGVsZERyYWcgPSAhMSwgcC5pc1N0aWNreUNsaWNrID0gITEsIAogICAgcC5zbmFwU2V0dGluZ3MgPSBudWxsLCBwLl90aGVTdGFnZSA9IG51bGwsIHAuX2RyYWdPZmZzZXQgPSBudWxsLCBwLl9kcmFnU3RhcnRDYWxsYmFjayA9IG51bGwsIAogICAgcC5fZHJhZ0VuZENhbGxiYWNrID0gbnVsbCwgcC5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2sgPSBudWxsLCBwLl90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjayA9IG51bGwsIAogICAgcC5fc3RhZ2VNb3VzZVVwQ2FsbGJhY2sgPSBudWxsLCBwLl9kcmFnZ2FibGVPYmplY3RzID0gbnVsbCwgcC5fdXBkYXRlQ2FsbGJhY2sgPSBudWxsLCAKICAgIHAuX2hlbHBlclBvaW50ID0gbnVsbCwgcC5pbml0aWFsaXplID0gZnVuY3Rpb24oc3RhcnRDYWxsYmFjaywgZW5kQ2FsbGJhY2spIHsKICAgICAgICB0aGlzLl91cGRhdGVDYWxsYmFjayA9IHRoaXMuX3VwZGF0ZU9ialBvc2l0aW9uLmJpbmQodGhpcyksIHRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrID0gdGhpcy5fdHJpZ2dlckhlbGREcmFnLmJpbmQodGhpcyksIAogICAgICAgIHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrID0gdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrLmJpbmQodGhpcyksIHRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrID0gdGhpcy5fc3RvcERyYWcuYmluZCh0aGlzKSwgCiAgICAgICAgdGhpcy5fdGhlU3RhZ2UgPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5zdGFnZSwgdGhpcy5fZHJhZ1N0YXJ0Q2FsbGJhY2sgPSBzdGFydENhbGxiYWNrLCAKICAgICAgICB0aGlzLl9kcmFnRW5kQ2FsbGJhY2sgPSBlbmRDYWxsYmFjaywgdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cyA9IFtdLCB0aGlzLm1vdXNlRG93blN0YWdlUG9zID0gewogICAgICAgICAgICB4OiAwLAogICAgICAgICAgICB5OiAwCiAgICAgICAgfSwgdGhpcy5tb3VzZURvd25PYmpQb3MgPSB7CiAgICAgICAgICAgIHg6IDAsCiAgICAgICAgICAgIHk6IDAKICAgICAgICB9OwogICAgfSwgcC5zdGFydERyYWcgPSBmdW5jdGlvbihvYmplY3QsIGV2KSB7CiAgICAgICAgdGhpcy5fb2JqTW91c2VEb3duKGV2LCBvYmplY3QpOwogICAgfSwgcC5fb2JqTW91c2VEb3duID0gZnVuY3Rpb24oZXYsIG9iaikgewogICAgICAgIG51bGwgPT09IHRoaXMuZHJhZ2dlZE9iaiAmJiAodGhpcy5kcmFnZ2VkT2JqID0gb2JqLCBjcmVhdGVqcy5Ud2Vlbi5yZW1vdmVUd2VlbnMob2JqKSwgCiAgICAgICAgdGhpcy5fZHJhZ09mZnNldCA9IHRoaXMuZHJhZ2dlZE9iai5wYXJlbnQuZ2xvYmFsVG9Mb2NhbChldiA/IGV2LnN0YWdlWCA6IDAsIGV2ID8gZXYuc3RhZ2VZIDogMCksIAogICAgICAgIHRoaXMuX2RyYWdPZmZzZXQueCAtPSBvYmoueCwgdGhpcy5fZHJhZ09mZnNldC55IC09IG9iai55LCB0aGlzLm1vdXNlRG93bk9ialBvcy54ID0gb2JqLngsIAogICAgICAgIHRoaXMubW91c2VEb3duT2JqUG9zLnkgPSBvYmoueSwgZXYgPyAodGhpcy5fdGhlU3RhZ2UuX2dldFBvaW50ZXJEYXRhKGV2LnBvaW50ZXJJRCkudGFyZ2V0ID0gb2JqLCAKICAgICAgICB0aGlzLmFsbG93U3RpY2t5Q2xpY2sgJiYgInRvdWNoc3RhcnQiICE9IGV2Lm5hdGl2ZUV2ZW50LnR5cGUgPyAodGhpcy5tb3VzZURvd25TdGFnZVBvcy54ID0gZXYuc3RhZ2VYLCAKICAgICAgICB0aGlzLm1vdXNlRG93blN0YWdlUG9zLnkgPSBldi5zdGFnZVksIG9iai5hZGRFdmVudExpc3RlbmVyKCJwcmVzc21vdmUiLCB0aGlzLl90cmlnZ2VySGVsZERyYWdDYWxsYmFjayksIAogICAgICAgIG9iai5hZGRFdmVudExpc3RlbmVyKCJwcmVzc3VwIiwgdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2spKSA6ICh0aGlzLm1vdXNlRG93blN0YWdlUG9zLnggPSBldi5zdGFnZVgsIAogICAgICAgIHRoaXMubW91c2VEb3duU3RhZ2VQb3MueSA9IGV2LnN0YWdlWSwgdGhpcy5pc1RvdWNoTW92ZSA9ICJ0b3VjaHN0YXJ0IiA9PSBldi5uYXRpdmVFdmVudC50eXBlLCAKICAgICAgICB0aGlzLmlzSGVsZERyYWcgPSAhMCwgdGhpcy5fc3RhcnREcmFnKCkpKSA6ICh0aGlzLmlzSGVsZERyYWcgPSAhMCwgdGhpcy5fc3RhcnREcmFnKCkpKTsKICAgIH0sIHAuX3RyaWdnZXJTdGlja3lDbGljayA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaXNTdGlja3lDbGljayA9ICEwLCB0aGlzLmRyYWdnZWRPYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3Ntb3ZlIiwgdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2spLCAKICAgICAgICB0aGlzLmRyYWdnZWRPYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3N1cCIsIHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrKSwgCiAgICAgICAgdGhpcy5fc3RhcnREcmFnKCk7CiAgICB9LCBwLl90cmlnZ2VySGVsZERyYWcgPSBmdW5jdGlvbihldikgewogICAgICAgIHZhciB4RGlmZiA9IGV2LnN0YWdlWCAtIHRoaXMubW91c2VEb3duU3RhZ2VQb3MueCwgeURpZmYgPSBldi5zdGFnZVkgLSB0aGlzLm1vdXNlRG93blN0YWdlUG9zLnk7CiAgICAgICAgeERpZmYgKiB4RGlmZiArIHlEaWZmICogeURpZmYgPj0gdGhpcy5kcmFnU3RhcnRUaHJlc2hvbGQgKiB0aGlzLmRyYWdTdGFydFRocmVzaG9sZCAmJiAodGhpcy5pc0hlbGREcmFnID0gITAsIAogICAgICAgIHRoaXMuZHJhZ2dlZE9iai5yZW1vdmVFdmVudExpc3RlbmVyKCJwcmVzc21vdmUiLCB0aGlzLl90cmlnZ2VySGVsZERyYWdDYWxsYmFjayksIAogICAgICAgIHRoaXMuZHJhZ2dlZE9iai5yZW1vdmVFdmVudExpc3RlbmVyKCJwcmVzc3VwIiwgdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2spLCAKICAgICAgICB0aGlzLl9zdGFydERyYWcoKSk7CiAgICB9LCBwLl9zdGFydERyYWcgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc3RhZ2UgPSB0aGlzLl90aGVTdGFnZTsKICAgICAgICBzdGFnZS5yZW1vdmVFdmVudExpc3RlbmVyKCJzdGFnZW1vdXNlbW92ZSIsIHRoaXMuX3VwZGF0ZUNhbGxiYWNrKSwgc3RhZ2UuYWRkRXZlbnRMaXN0ZW5lcigic3RhZ2Vtb3VzZW1vdmUiLCB0aGlzLl91cGRhdGVDYWxsYmFjayksIAogICAgICAgIHN0YWdlLnJlbW92ZUV2ZW50TGlzdGVuZXIoInN0YWdlbW91c2V1cCIsIHRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrKSwgc3RhZ2UuYWRkRXZlbnRMaXN0ZW5lcigic3RhZ2Vtb3VzZXVwIiwgdGhpcy5fc3RhZ2VNb3VzZVVwQ2FsbGJhY2spLCAKICAgICAgICB0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayh0aGlzLmRyYWdnZWRPYmopOwogICAgfSwgcC5zdG9wRHJhZyA9IGZ1bmN0aW9uKGRvQ2FsbGJhY2spIHsKICAgICAgICB0aGlzLl9zdG9wRHJhZyhudWxsLCBkb0NhbGxiYWNrID09PSAhMCk7CiAgICB9LCBwLl9zdG9wRHJhZyA9IGZ1bmN0aW9uKGV2LCBkb0NhbGxiYWNrKSB7CiAgICAgICAgdmFyIG9iaiA9IHRoaXMuZHJhZ2dlZE9iajsKICAgICAgICBvYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3Ntb3ZlIiwgdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2spLCBvYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3N1cCIsIHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrKSwgCiAgICAgICAgdGhpcy5fdGhlU3RhZ2UucmVtb3ZlRXZlbnRMaXN0ZW5lcigic3RhZ2Vtb3VzZW1vdmUiLCB0aGlzLl91cGRhdGVDYWxsYmFjayksIHRoaXMuX3RoZVN0YWdlLnJlbW92ZUV2ZW50TGlzdGVuZXIoInN0YWdlbW91c2V1cCIsIHRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrKSwgCiAgICAgICAgdGhpcy5kcmFnZ2VkT2JqID0gbnVsbCwgdGhpcy5pc1RvdWNoTW92ZSA9ICExLCB0aGlzLmlzU3RpY2t5Q2xpY2sgPSAhMSwgdGhpcy5pc0hlbGRNb3ZlID0gITEsIAogICAgICAgIGRvQ2FsbGJhY2sgIT09ICExICYmIHRoaXMuX2RyYWdFbmRDYWxsYmFjayhvYmopOwogICAgfSwgcC5fdXBkYXRlT2JqUG9zaXRpb24gPSBmdW5jdGlvbihlKSB7CiAgICAgICAgaWYgKHRoaXMuaXNUb3VjaE1vdmUgfHwgdGhpcy5fdGhlU3RhZ2UubW91c2VJbkJvdW5kcykgewogICAgICAgICAgICB2YXIgZHJhZ2dlZE9iaiA9IHRoaXMuZHJhZ2dlZE9iaiwgbW91c2VQb3MgPSBkcmFnZ2VkT2JqLnBhcmVudC5nbG9iYWxUb0xvY2FsKGUuc3RhZ2VYLCBlLnN0YWdlWSwgdGhpcy5faGVscGVyUG9pbnQpLCBib3VuZHMgPSBkcmFnZ2VkT2JqLl9kcmFnQm91bmRzOwogICAgICAgICAgICBpZiAoZHJhZ2dlZE9iai54ID0gY2xhbXAobW91c2VQb3MueCAtIHRoaXMuX2RyYWdPZmZzZXQueCwgYm91bmRzLngsIGJvdW5kcy5yaWdodCksIAogICAgICAgICAgICBkcmFnZ2VkT2JqLnkgPSBjbGFtcChtb3VzZVBvcy55IC0gdGhpcy5fZHJhZ09mZnNldC55LCBib3VuZHMueSwgYm91bmRzLmJvdHRvbSksIAogICAgICAgICAgICB0aGlzLnNuYXBTZXR0aW5ncykgc3dpdGNoICh0aGlzLnNuYXBTZXR0aW5ncy5tb2RlKSB7CiAgICAgICAgICAgICAgY2FzZSAicG9pbnRzIjoKICAgICAgICAgICAgICAgIHRoaXMuX2hhbmRsZVBvaW50U25hcChtb3VzZVBvcyk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgY2FzZSAiZ3JpZCI6CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgY2FzZSAibGluZSI6ICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIHAuX2hhbmRsZVBvaW50U25hcCA9IGZ1bmN0aW9uKGxvY2FsTW91c2VQb3MpIHsKICAgICAgICBmb3IgKHZhciBzbmFwU2V0dGluZ3MgPSB0aGlzLnNuYXBTZXR0aW5ncywgbWluRGlzdFNxID0gc25hcFNldHRpbmdzLmRpc3QgKiBzbmFwU2V0dGluZ3MuZGlzdCwgcG9pbnRzID0gc25hcFNldHRpbmdzLnBvaW50cywgb2JqWCA9IGxvY2FsTW91c2VQb3MueCAtIHRoaXMuX2RyYWdPZmZzZXQueCwgb2JqWSA9IGxvY2FsTW91c2VQb3MueSAtIHRoaXMuX2RyYWdPZmZzZXQueSwgbGVhc3REaXN0ID0gLTEsIGNsb3Nlc3RQb2ludCA9IG51bGwsIGkgPSBwb2ludHMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICAgICAgdmFyIHAgPSBwb2ludHNbaV0sIGRpc3RTcSA9IGRpc3RTcXVhcmVkKG9ialgsIG9ialksIHAueCwgcC55KTsKICAgICAgICAgICAgbWluRGlzdFNxID49IGRpc3RTcSAmJiAobGVhc3REaXN0ID4gZGlzdFNxIHx8IC0xID09IGxlYXN0RGlzdCkgJiYgKGxlYXN0RGlzdCA9IGRpc3RTcSwgCiAgICAgICAgICAgIGNsb3Nlc3RQb2ludCA9IHApOwogICAgICAgIH0KICAgICAgICBjbG9zZXN0UG9pbnQgJiYgKHRoaXMuZHJhZ2dlZE9iai54ID0gY2xvc2VzdFBvaW50LngsIHRoaXMuZHJhZ2dlZE9iai55ID0gY2xvc2VzdFBvaW50LnkpOwogICAgfTsKICAgIHZhciBkaXN0U3F1YXJlZCA9IGZ1bmN0aW9uKHgxLCB5MSwgeDIsIHkyKSB7CiAgICAgICAgdmFyIHhEaWZmID0geDEgLSB4MiwgeURpZmYgPSB5MSAtIHkyOwogICAgICAgIHJldHVybiB4RGlmZiAqIHhEaWZmICsgeURpZmYgKiB5RGlmZjsKICAgIH0sIGNsYW1wID0gZnVuY3Rpb24oeCwgYSwgYikgewogICAgICAgIHJldHVybiBhID4geCA/IGEgOiB4ID4gYiA/IGIgOiB4OwogICAgfSwgZW5hYmxlRHJhZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgdGhpcy5fb25Nb3VzZURvd25MaXN0ZW5lciksIHRoaXMuY3Vyc29yID0gInBvaW50ZXIiOwogICAgfSwgZGlzYWJsZURyYWcgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIHRoaXMuX29uTW91c2VEb3duTGlzdGVuZXIpLCB0aGlzLmN1cnNvciA9IG51bGw7CiAgICB9LCBfb25Nb3VzZURvd24gPSBmdW5jdGlvbihldikgewogICAgICAgIHRoaXMuX2RyYWdNYW4uX29iak1vdXNlRG93bihldiwgdGhpcyk7CiAgICB9OwogICAgcC5hZGRPYmplY3QgPSBmdW5jdGlvbihvYmosIGJvdW5kcykgewogICAgICAgIGJvdW5kcyB8fCAoYm91bmRzID0gewogICAgICAgICAgICB4OiAwLAogICAgICAgICAgICB5OiAwLAogICAgICAgICAgICB3aWR0aDogdGhpcy5fdGhlU3RhZ2UuY2FudmFzLndpZHRoLAogICAgICAgICAgICBoZWlnaHQ6IHRoaXMuX3RoZVN0YWdlLmNhbnZhcy5oZWlnaHQKICAgICAgICB9KSwgYm91bmRzLnJpZ2h0ID0gYm91bmRzLnggKyBib3VuZHMud2lkdGgsIGJvdW5kcy5ib3R0b20gPSBib3VuZHMueSArIGJvdW5kcy5oZWlnaHQsIAogICAgICAgIG9iai5fZHJhZ0JvdW5kcyA9IGJvdW5kcywgdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5pbmRleE9mKG9iaikgPj0gMCB8fCAob2JqLmVuYWJsZURyYWcgPSBlbmFibGVEcmFnLCAKICAgICAgICBvYmouZGlzYWJsZURyYWcgPSBkaXNhYmxlRHJhZywgb2JqLl9vbk1vdXNlRG93bkxpc3RlbmVyID0gX29uTW91c2VEb3duLmJpbmQob2JqKSwgCiAgICAgICAgb2JqLl9kcmFnTWFuID0gdGhpcywgdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5wdXNoKG9iaikpOwogICAgfSwgcC5yZW1vdmVPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgICAgICBvYmouZGlzYWJsZURyYWcoKSwgZGVsZXRlIG9iai5lbmFibGVEcmFnLCBkZWxldGUgb2JqLmRpc2FibGVEcmFnLCBkZWxldGUgb2JqLl9vbk1vdXNlRG93bkxpc3RlbmVyLCAKICAgICAgICBkZWxldGUgb2JqLl9kcmFnTWFuLCBkZWxldGUgb2JqLl9kcmFnQm91bmRzOwogICAgICAgIHZhciBpbmRleCA9IHRoaXMuX2RyYWdnYWJsZU9iamVjdHMuaW5kZXhPZihvYmopOwogICAgICAgIGluZGV4ID49IDAgJiYgdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgfSwgcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgbnVsbCAhPT0gdGhpcy5kcmFnZ2VkT2JqICYmICh0aGlzLmRyYWdnZWRPYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3Ntb3ZlIiwgdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2spLCAKICAgICAgICB0aGlzLmRyYWdnZWRPYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3N1cCIsIHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrKSwgCiAgICAgICAgdGhpcy5fdGhlU3RhZ2UucmVtb3ZlRXZlbnRMaXN0ZW5lcigic3RhZ2Vtb3VzZW1vdmUiLCB0aGlzLl91cGRhdGVDYWxsYmFjayksIHRoaXMuZHJhZ2dlZE9iaiA9IG51bGwpLCAKICAgICAgICB0aGlzLl91cGRhdGVDYWxsYmFjayA9IG51bGwsIHRoaXMuX2RyYWdTdGFydENhbGxiYWNrID0gbnVsbCwgdGhpcy5fZHJhZ0VuZENhbGxiYWNrID0gbnVsbCwgCiAgICAgICAgdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2sgPSBudWxsLCB0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjayA9IG51bGwsIHRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrID0gbnVsbCwgCiAgICAgICAgdGhpcy5fdGhlU3RhZ2UgPSBudWxsOwogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLl9kcmFnZ2FibGVPYmplY3RzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICAgIHZhciBvYmogPSB0aGlzLl9kcmFnZ2FibGVPYmplY3RzW2ldOwogICAgICAgICAgICBvYmouZGlzYWJsZURyYWcoKSwgZGVsZXRlIG9iai5lbmFibGVEcmFnLCBkZWxldGUgb2JqLmRpc2FibGVEcmFnLCBkZWxldGUgb2JqLl9vbk1vdXNlRG93bkxpc3RlbmVyLCAKICAgICAgICAgICAgZGVsZXRlIG9iai5fZHJhZ01hbiwgZGVsZXRlIG9iai5fZHJhZ0JvdW5kczsKICAgICAgICB9CiAgICAgICAgdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cyA9IG51bGwsIHRoaXMuX2hlbHBlclBvaW50ID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5EcmFnTWFuYWdlciA9IERyYWdNYW5hZ2VyOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFBvc2l0aW9uZXIgPSBmdW5jdGlvbigpIHt9OwogICAgUG9zaXRpb25lci5wcm90b3R5cGUgPSB7fSwgUG9zaXRpb25lci5wb3NpdGlvbkl0ZW1zID0gZnVuY3Rpb24ocGFyZW50LCBpdGVtU2V0dGluZ3MpIHsKICAgICAgICB2YXIgcm90LCBwdDsKICAgICAgICBmb3IgKHZhciBpTmFtZSBpbiBpdGVtU2V0dGluZ3MpIHsKICAgICAgICAgICAgdmFyIGl0ZW0gPSBwYXJlbnRbaU5hbWVdOwogICAgICAgICAgICBpZiAoaXRlbSkgewogICAgICAgICAgICAgICAgdmFyIHNldHRpbmcgPSBpdGVtU2V0dGluZ3NbaU5hbWVdOwogICAgICAgICAgICAgICAgaWYgKGl0ZW0ueCA9IHNldHRpbmcueCwgaXRlbS55ID0gc2V0dGluZy55LCBwdCA9IHNldHRpbmcuc2NhbGUsIHB0ICYmIChpdGVtLnNjYWxlWCAqPSBwdC54LCAKICAgICAgICAgICAgICAgIGl0ZW0uc2NhbGVZICo9IHB0LnkpLCBwdCA9IHNldHRpbmcucGl2b3QsIHB0ICYmIChpdGVtLnJlZ1ggPSBwdC54LCBpdGVtLnJlZ1kgPSBwdC55KSwgCiAgICAgICAgICAgICAgICByb3QgPSBzZXR0aW5nLnJvdGF0aW9uLCByb3QgJiYgKGl0ZW0ucm90YXRpb24gPSByb3QpLCBzZXR0aW5nLmhpdEFyZWEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaGl0QXJlYSA9IHNldHRpbmcuaGl0QXJlYTsKICAgICAgICAgICAgICAgICAgICBpdGVtLmhpdFNoYXBlID0gUG9zaXRpb25lci5nZW5lcmF0ZUhpdEFyZWEoaGl0QXJlYSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBEZWJ1Zy5lcnJvcigiY291bGQgbm90IGZpbmQgb2JqZWN0ICciICsgaU5hbWUgKyAiJyIpOwogICAgICAgIH0KICAgIH0sIFBvc2l0aW9uZXIuZ2VuZXJhdGVIaXRBcmVhID0gZnVuY3Rpb24oaGl0QXJlYSwgc2NhbGUpIHsKICAgICAgICBzY2FsZSB8fCAoc2NhbGUgPSAxKTsKICAgICAgICB2YXIgbGlicmFyeTsKICAgICAgICBpZiAobGlicmFyeSA9IHdpbmRvdy5jcmVhdGVqcywgaXNBcnJheShoaXRBcmVhKSkgewogICAgICAgICAgICBpZiAoMSA9PSBzY2FsZSkgcmV0dXJuIG5ldyBsaWJyYXJ5LlBvbHlnb24oaGl0QXJlYSk7CiAgICAgICAgICAgIGZvciAodmFyIHRlbXAgPSBbXSwgaSA9IDAsIGxlbiA9IGhpdEFyZWEubGVuZ3RoOyBsZW4gPiBpOyArK2kpIHRlbXAucHVzaChuZXcgbGlicmFyeS5Qb2ludChoaXRBcmVhW2ldLnggKiBzY2FsZSwgaGl0QXJlYVtpXS55ICogc2NhbGUpKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBsaWJyYXJ5LlBvbHlnb24odGVtcCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAicmVjdCIgIT0gaGl0QXJlYS50eXBlICYmIGhpdEFyZWEudHlwZSA/ICJlbGxpcHNlIiA9PSBoaXRBcmVhLnR5cGUgPyBuZXcgbGlicmFyeS5FbGxpcHNlKChoaXRBcmVhLnggLSAuNSAqIGhpdEFyZWEudykgKiBzY2FsZSwgKGhpdEFyZWEueSAtIC41ICogaGl0QXJlYS5oKSAqIHNjYWxlLCBoaXRBcmVhLncgKiBzY2FsZSwgaGl0QXJlYS5oICogc2NhbGUpIDogImNpcmNsZSIgPT0gaGl0QXJlYS50eXBlID8gbmV3IGxpYnJhcnkuQ2lyY2xlKGhpdEFyZWEueCAqIHNjYWxlLCBoaXRBcmVhLnkgKiBzY2FsZSwgaGl0QXJlYS5yICogc2NhbGUpIDogInNlY3RvciIgPT0gaGl0QXJlYS50eXBlID8gbmV3IGxpYnJhcnkuU2VjdG9yKGhpdEFyZWEueCAqIHNjYWxlLCBoaXRBcmVhLnkgKiBzY2FsZSwgaGl0QXJlYS5yICogc2NhbGUsIGhpdEFyZWEuc3RhcnQsIGhpdEFyZWEuZW5kKSA6IG51bGwgOiBuZXcgbGlicmFyeS5SZWN0YW5nbGUoaGl0QXJlYS54ICogc2NhbGUsIGhpdEFyZWEueSAqIHNjYWxlLCBoaXRBcmVhLncgKiBzY2FsZSwgaGl0QXJlYS5oICogc2NhbGUpOwogICAgfTsKICAgIHZhciBpc0FycmF5ID0gZnVuY3Rpb24obykgewogICAgICAgIHJldHVybiAiW29iamVjdCBBcnJheV0iID09PSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobyk7CiAgICB9OwogICAgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLlBvc2l0aW9uZXIgPSBQb3NpdGlvbmVyOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFNjcmVlblNldHRpbmdzID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCwgcHBpKSB7CiAgICAgICAgdGhpcy53aWR0aCA9IHdpZHRoLCB0aGlzLmhlaWdodCA9IGhlaWdodCwgdGhpcy5wcGkgPSBwcGk7CiAgICB9OwogICAgU2NyZWVuU2V0dGluZ3MucHJvdG90eXBlID0ge30sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5TY3JlZW5TZXR0aW5ncyA9IFNjcmVlblNldHRpbmdzOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFVJU2NhbGVyLCBVSUVsZW1lbnQgPSBmdW5jdGlvbihpdGVtLCBzZXR0aW5ncywgZGVzaWduZWRTY3JlZW4pIHsKICAgICAgICBzd2l0Y2ggKFVJU2NhbGVyID0gY2xvdWRraWQuVUlTY2FsZXIsIHRoaXMuX2l0ZW0gPSBpdGVtLCB0aGlzLl9zZXR0aW5ncyA9IHNldHRpbmdzLCAKICAgICAgICB0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IGRlc2lnbmVkU2NyZWVuLCB0aGlzLm9yaWdTY2FsZVggPSBpdGVtLnNjYWxlWCwgdGhpcy5vcmlnU2NhbGVZID0gaXRlbS5zY2FsZVksIAogICAgICAgIHRoaXMub3JpZ1dpZHRoID0gaXRlbS53aWR0aCwgdGhpcy5vcmlnQm91bmRzID0gewogICAgICAgICAgICB4OiAwLAogICAgICAgICAgICB5OiAwLAogICAgICAgICAgICB3aWR0aDogaXRlbS53aWR0aCwKICAgICAgICAgICAgaGVpZ2h0OiBpdGVtLmhlaWdodAogICAgICAgIH0sIHRoaXMub3JpZ0JvdW5kcy5yaWdodCA9IHRoaXMub3JpZ0JvdW5kcy54ICsgdGhpcy5vcmlnQm91bmRzLndpZHRoLCB0aGlzLm9yaWdCb3VuZHMuYm90dG9tID0gdGhpcy5vcmlnQm91bmRzLnkgKyB0aGlzLm9yaWdCb3VuZHMuaGVpZ2h0LCAKICAgICAgICBzZXR0aW5ncy52ZXJ0QWxpZ24pIHsKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fVE9QOgogICAgICAgICAgICB0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gaXRlbS55ICsgdGhpcy5vcmlnQm91bmRzLnk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOgogICAgICAgICAgICB0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gLjUgKiBkZXNpZ25lZFNjcmVlbi5oZWlnaHQgLSBpdGVtLnk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fQk9UVE9NOgogICAgICAgICAgICB0aGlzLm9yaWdNYXJnaW5WZXJ0ID0gZGVzaWduZWRTY3JlZW4uaGVpZ2h0IC0gKGl0ZW0ueSArIHRoaXMub3JpZ0JvdW5kcy5ib3R0b20pOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKHNldHRpbmdzLmhvcmlBbGlnbikgewogICAgICAgICAgY2FzZSBVSVNjYWxlci5BTElHTl9MRUZUOgogICAgICAgICAgICB0aGlzLm9yaWdNYXJnaW5Ib3JpID0gaXRlbS54ICsgdGhpcy5vcmlnQm91bmRzLng7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOgogICAgICAgICAgICB0aGlzLm9yaWdNYXJnaW5Ib3JpID0gLjUgKiBkZXNpZ25lZFNjcmVlbi53aWR0aCAtIGl0ZW0ueDsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSBVSVNjYWxlci5BTElHTl9SSUdIVDoKICAgICAgICAgICAgdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGRlc2lnbmVkU2NyZWVuLndpZHRoIC0gKGl0ZW0ueCArIHRoaXMub3JpZ0JvdW5kcy5yaWdodCk7CiAgICAgICAgfQogICAgfSwgcCA9IFVJRWxlbWVudC5wcm90b3R5cGUgPSB7fTsKICAgIHAub3JpZ01hcmdpbkhvcmkgPSAwLCBwLm9yaWdNYXJnaW5WZXJ0ID0gMCwgcC5vcmlnV2lkdGggPSAwLCBwLm9yaWdTY2FsZVggPSAwLCBwLm9yaWdTY2FsZVkgPSAwLCAKICAgIHAub3JpZ0JvdW5kcyA9IG51bGwsIHAuX3NldHRpbmdzID0gbnVsbCwgcC5faXRlbSA9IG51bGwsIHAuX2Rlc2lnbmVkU2NyZWVuID0gbnVsbCwgCiAgICBwLnJlc2l6ZSA9IGZ1bmN0aW9uKG5ld1NjcmVlbikgewogICAgICAgIHZhciBvdmVyYWxsU2NhbGUgPSBuZXdTY3JlZW4uaGVpZ2h0IC8gdGhpcy5fZGVzaWduZWRTY3JlZW4uaGVpZ2h0LCBwcGlTY2FsZSA9IG5ld1NjcmVlbi5wcGkgLyB0aGlzLl9kZXNpZ25lZFNjcmVlbi5wcGksIGxldHRlckJveFdpZHRoID0gKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2Rlc2lnbmVkU2NyZWVuLndpZHRoICogb3ZlcmFsbFNjYWxlKSAvIDIsIGl0ZW1TY2FsZSA9IG92ZXJhbGxTY2FsZSAvIHBwaVNjYWxlOwogICAgICAgIHRoaXMuX3NldHRpbmdzLm1pblNjYWxlICYmIGl0ZW1TY2FsZSA8IHRoaXMuX3NldHRpbmdzLm1pblNjYWxlID8gaXRlbVNjYWxlID0gdGhpcy5fc2V0dGluZ3MubWluU2NhbGUgOiB0aGlzLl9zZXR0aW5ncy5tYXhTY2FsZSAmJiBpdGVtU2NhbGUgPiB0aGlzLl9zZXR0aW5ncy5tYXhTY2FsZSAmJiAoaXRlbVNjYWxlID0gdGhpcy5fc2V0dGluZ3MubWF4U2NhbGUpLCAKICAgICAgICBpdGVtU2NhbGUgKj0gcHBpU2NhbGUsIHRoaXMuX2l0ZW0uc2NhbGVYID0gdGhpcy5vcmlnU2NhbGVYICogaXRlbVNjYWxlLCB0aGlzLl9pdGVtLnNjYWxlWSA9IHRoaXMub3JpZ1NjYWxlWSAqIGl0ZW1TY2FsZTsKICAgICAgICB2YXIgbTsKICAgICAgICBzd2l0Y2ggKG0gPSB0aGlzLm9yaWdNYXJnaW5WZXJ0ICogb3ZlcmFsbFNjYWxlLCB0aGlzLl9zZXR0aW5ncy52ZXJ0QWxpZ24pIHsKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fVE9QOgogICAgICAgICAgICB0aGlzLl9pdGVtLnkgPSBtIC0gdGhpcy5vcmlnQm91bmRzLnkgKiBpdGVtU2NhbGU7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOgogICAgICAgICAgICB0aGlzLl9pdGVtLnkgPSAuNSAqIG5ld1NjcmVlbi5oZWlnaHQgLSBtOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0JPVFRPTToKICAgICAgICAgICAgdGhpcy5faXRlbS55ID0gbmV3U2NyZWVuLmhlaWdodCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMuYm90dG9tICogaXRlbVNjYWxlOwogICAgICAgIH0KICAgICAgICBzd2l0Y2ggKG0gPSB0aGlzLm9yaWdNYXJnaW5Ib3JpICogb3ZlcmFsbFNjYWxlLCB0aGlzLl9zZXR0aW5ncy5ob3JpQWxpZ24pIHsKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fTEVGVDoKICAgICAgICAgICAgdGhpcy5faXRlbS54ID0gdGhpcy5fc2V0dGluZ3MudGl0bGVTYWZlID8gbGV0dGVyQm94V2lkdGggKyBtIC0gdGhpcy5vcmlnQm91bmRzLnggKiBpdGVtU2NhbGUgOiBtIC0gdGhpcy5vcmlnQm91bmRzLnggKiBpdGVtU2NhbGU7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fQ0VOVEVSOgogICAgICAgICAgICB0aGlzLl9pdGVtLnggPSB0aGlzLl9zZXR0aW5ncy5jZW50ZXJlZEhvcml6b250YWxseSA/IC41ICogKG5ld1NjcmVlbi53aWR0aCAtIHRoaXMuX2l0ZW0ud2lkdGgpIDogLjUgKiBuZXdTY3JlZW4ud2lkdGggLSBtOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX1JJR0hUOgogICAgICAgICAgICB0aGlzLl9pdGVtLnggPSB0aGlzLl9zZXR0aW5ncy50aXRsZVNhZmUgPyBuZXdTY3JlZW4ud2lkdGggLSBsZXR0ZXJCb3hXaWR0aCAtIG0gLSB0aGlzLm9yaWdCb3VuZHMucmlnaHQgKiBpdGVtU2NhbGUgOiBuZXdTY3JlZW4ud2lkdGggLSBtIC0gdGhpcy5vcmlnQm91bmRzLnJpZ2h0ICogaXRlbVNjYWxlOwogICAgICAgIH0KICAgIH0sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMub3JpZ0JvdW5kcyA9IG51bGwsIHRoaXMuX2l0ZW0gPSBudWxsLCB0aGlzLl9zZXR0aW5ncyA9IG51bGwsIHRoaXMuX2Rlc2lnbmVkU2NyZWVuID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5VSUVsZW1lbnQgPSBVSUVsZW1lbnQ7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgVUlFbGVtZW50U2V0dGluZ3MgPSBmdW5jdGlvbigpIHt9LCBwID0gVUlFbGVtZW50U2V0dGluZ3MucHJvdG90eXBlID0ge307CiAgICBwLnZlcnRBbGlnbiA9IG51bGwsIHAuaG9yaUFsaWduID0gbnVsbCwgcC50aXRsZVNhZmUgPSAhMSwgcC5tYXhTY2FsZSA9IDEsIHAubWluU2NhbGUgPSAxLCAKICAgIHAuY2VudGVyZWRIb3Jpem9udGFsbHkgPSAhMSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLlVJRWxlbWVudFNldHRpbmdzID0gVUlFbGVtZW50U2V0dGluZ3M7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgVUlFbGVtZW50U2V0dGluZ3MgPSBjbG91ZGtpZC5VSUVsZW1lbnRTZXR0aW5ncywgVUlFbGVtZW50ID0gY2xvdWRraWQuVUlFbGVtZW50LCBTY3JlZW5TZXR0aW5ncyA9IGNsb3Vka2lkLlNjcmVlblNldHRpbmdzLCBVSVNjYWxlciA9IGZ1bmN0aW9uKHBhcmVudCwgZGVzaWduZWRXaWR0aCwgZGVzaWduZWRIZWlnaHQsIGRlc2lnbmVkUFBJKSB7CiAgICAgICAgdGhpcy5fcGFyZW50ID0gcGFyZW50LCB0aGlzLl9pdGVtcyA9IFtdLCB0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG5ldyBTY3JlZW5TZXR0aW5ncyhkZXNpZ25lZFdpZHRoLCBkZXNpZ25lZEhlaWdodCwgZGVzaWduZWRQUEkpOwogICAgfSwgcCA9IFVJU2NhbGVyLnByb3RvdHlwZSA9IHt9LCBjdXJyZW50U2NyZWVuID0gbmV3IFNjcmVlblNldHRpbmdzKDAsIDAsIDApLCBpbml0aWFsaXplZCA9ICExOwogICAgcC5fcGFyZW50ID0gbnVsbCwgcC5fZGVzaWduZWRTY3JlZW4gPSBudWxsLCBwLl9pdGVtcyA9IG51bGwsIFVJU2NhbGVyLkFMSUdOX1RPUCA9ICJ0b3AiLCAKICAgIFVJU2NhbGVyLkFMSUdOX0JPVFRPTSA9ICJib3R0b20iLCBVSVNjYWxlci5BTElHTl9MRUZUID0gImxlZnQiLCBVSVNjYWxlci5BTElHTl9SSUdIVCA9ICJyaWdodCIsIAogICAgVUlTY2FsZXIuQUxJR05fQ0VOVEVSID0gImNlbnRlciIsIFVJU2NhbGVyLmZyb21KU09OID0gZnVuY3Rpb24ocGFyZW50LCBqc29uU2V0dGluZ3MsIGpzb25JdGVtcywgaW1tZWRpYXRlRGVzdHJveSkgewogICAgICAgICJib29sZWFuIiAhPSB0eXBlb2YgaW1tZWRpYXRlRGVzdHJveSAmJiAoaW1tZWRpYXRlRGVzdHJveSA9ICEwKTsKICAgICAgICB2YXIgaXRlbSwgaSwgYWxpZ24sIHZlcnRBbGlnbiwgaG9yaUFsaWduLCBzY2FsZXIgPSBuZXcgVUlTY2FsZXIocGFyZW50LCBqc29uU2V0dGluZ3MuZGVzaWduZWRXaWR0aCwganNvblNldHRpbmdzLmRlc2lnbmVkSGVpZ2h0LCBqc29uU2V0dGluZ3MuZGVzaWduZWRQUEkpOwogICAgICAgIGZvciAoaSBpbiBqc29uSXRlbXMpIGl0ZW0gPSBqc29uSXRlbXNbaV0sIGl0ZW0uYWxpZ24gPyAoYWxpZ24gPSBpdGVtLmFsaWduLnNwbGl0KCItIiksIAogICAgICAgIHZlcnRBbGlnbiA9IGFsaWduWzBdLCBob3JpQWxpZ24gPSBhbGlnblsxXSkgOiAodmVydEFsaWduID0gQUxJR05fQ0VOVEVSLCBob3JpQWxpZ24gPSBBTElHTl9DRU5URVIpLCAKICAgICAgICBzY2FsZXIuYWRkKHBhcmVudFtpXSwgdmVydEFsaWduLCBob3JpQWxpZ24sIGl0ZW0udGl0bGVTYWZlIHx8ICExLCBpdGVtLm1pblNjYWxlIHx8IDAvMCwgaXRlbS5tYXhTY2FsZSB8fCAwLzAsIGl0ZW0uY2VudGVyZWRIb3Jpem9udGFsbHkgfHwgITEpOwogICAgICAgIHJldHVybiBzY2FsZXIucmVzaXplKCksIGltbWVkaWF0ZURlc3Ryb3kgJiYgc2NhbGVyLmRlc3Ryb3koKSwgc2NhbGVyOwogICAgfSwgVUlTY2FsZXIuaW5pdCA9IGZ1bmN0aW9uKHNjcmVlbldpZHRoLCBzY3JlZW5IZWlnaHQsIHNjcmVlblBQSSkgewogICAgICAgIGN1cnJlbnRTY3JlZW4ud2lkdGggPSBzY3JlZW5XaWR0aCwgY3VycmVudFNjcmVlbi5oZWlnaHQgPSBzY3JlZW5IZWlnaHQsIGN1cnJlbnRTY3JlZW4ucHBpID0gc2NyZWVuUFBJLCAKICAgICAgICBpbml0aWFsaXplZCA9ICEwOwogICAgfSwgcC5nZXRTY2FsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBjdXJyZW50U2NyZWVuLmhlaWdodCAvIHRoaXMuX2Rlc2lnbmVkU2NyZWVuLmhlaWdodDsKICAgIH0sIHAuYWRkID0gZnVuY3Rpb24oaXRlbSwgdmVydEFsaWduLCBob3JpQWxpZ24sIHRpdGxlU2FmZSwgbWluU2NhbGUsIG1heFNjYWxlLCBjZW50ZXJlZEhvcml6b250YWxseSkgewogICAgICAgIHZhciBzID0gbmV3IFVJRWxlbWVudFNldHRpbmdzKCk7CiAgICAgICAgcy52ZXJ0QWxpZ24gPSB2ZXJ0QWxpZ24gfHwgVUlTY2FsZXIuQUxJR05fQ0VOVEVSLCBzLmhvcmlBbGlnbiA9IGhvcmlBbGlnbiB8fCBVSVNjYWxlci5BTElHTl9DRU5URVIsIAogICAgICAgIHMudGl0bGVTYWZlID0gImJvb2xlYW4iICE9IHR5cGVvZiB0aXRsZVNhZmUgPyAhMSA6IHRpdGxlU2FmZSwgcy5tYXhTY2FsZSA9ICJudW1iZXIiICE9IHR5cGVvZiBtYXhTY2FsZSA/IDAvMCA6IG1heFNjYWxlLCAKICAgICAgICBzLm1pblNjYWxlID0gIm51bWJlciIgIT0gdHlwZW9mIG1pblNjYWxlID8gMC8wIDogbWluU2NhbGUsIHMuY2VudGVyZWRIb3Jpem9udGFsbHkgPSBjZW50ZXJlZEhvcml6b250YWxseSB8fCAhMSwgCiAgICAgICAgdGhpcy5faXRlbXMucHVzaChuZXcgVUlFbGVtZW50KGl0ZW0sIHMsIHRoaXMuX2Rlc2lnbmVkU2NyZWVuKSk7CiAgICB9LCBVSVNjYWxlci5yZXNpemVCYWNrZ3JvdW5kID0gZnVuY3Rpb24oYml0bWFwKSB7CiAgICAgICAgaWYgKGluaXRpYWxpemVkKSB7CiAgICAgICAgICAgIHZhciBoLCB3LCBzY2FsZTsKICAgICAgICAgICAgaCA9IGJpdG1hcC5pbWFnZS5oZWlnaHQsIHcgPSBiaXRtYXAuaW1hZ2Uud2lkdGgsIHNjYWxlID0gY3VycmVudFNjcmVlbi5oZWlnaHQgLyBoLCAKICAgICAgICAgICAgYml0bWFwLnNjYWxlWCA9IGJpdG1hcC5zY2FsZVkgPSBzY2FsZSwgYml0bWFwLnggPSAuNSAqIChjdXJyZW50U2NyZWVuLndpZHRoIC0gdyAqIHNjYWxlKTsKICAgICAgICB9CiAgICB9LCBVSVNjYWxlci5yZXNpemVCYWNrZ3JvdW5kcyA9IGZ1bmN0aW9uKGJpdG1hcHMpIHsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gYml0bWFwcy5sZW5ndGg7IGxlbiA+IGk7ICsraSkgVUlTY2FsZXIucmVzaXplQmFja2dyb3VuZChiaXRtYXBzW2ldKTsKICAgIH0sIHAucmVzaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuX2l0ZW1zLmxlbmd0aCA+IDApIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLl9pdGVtcy5sZW5ndGg7IGxlbiA+IGk7ICsraSkgdGhpcy5faXRlbXNbaV0ucmVzaXplKGN1cnJlbnRTY3JlZW4pOwogICAgfSwgcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuX2l0ZW1zLmxlbmd0aCA+IDApIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLl9pdGVtcy5sZW5ndGg7IGxlbiA+IGk7ICsraSkgdGhpcy5faXRlbXNbaV0uZGVzdHJveSgpOwogICAgICAgIHRoaXMuX3BhcmVudCA9IG51bGwsIHRoaXMuX2Rlc2lnbmVkU2NyZWVuID0gbnVsbCwgdGhpcy5faXRlbXMgPSBudWxsOwogICAgfSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLlVJU2NhbGVyID0gVUlTY2FsZXI7Cn0oKTs=",
                "body": "IWZ1bmN0aW9uKHVuZGVmaW5lZCkgewogICAgdmFyIE9TID0gZnVuY3Rpb24oKSB7fSwgcCA9IE9TLnByb3RvdHlwZSA9IG5ldyBjcmVhdGVqcy5Db250YWluZXIoKSwgX3BhdXNlZCA9ICExLCBfaXNSZWFkeSA9ICExLCBfZnJhbWVyYXRlID0gbnVsbCwgX2xhc3RGcmFtZVRpbWUgPSAwLCBfbGFzdEZQU1VwZGF0ZVRpbWUgPSAwLCBfZnJhbWVyYXRlVmFsdWUgPSBudWxsLCBfZnJhbWVDb3VudCA9IDAsIF90aWNrQ2FsbGJhY2sgPSBudWxsLCBfaW5zdGFuY2UgPSBudWxsLCBfdGlja0lkID0gLTEsIF91c2VSQUYgPSAhMSwgX2ZwcyA9IDAsIF9tc1BlckZyYW1lID0gMDsKICAgIE9TLlZFUlNJT04gPSAiMS4xLjI3IiwgcC5Db250YWluZXJfaW5pdGlhbGl6ZSA9IHAuaW5pdGlhbGl6ZSwgcC5zdGFnZSA9IG51bGwsIAogICAgcC5fYXBwID0gbnVsbCwgcC5vcHRpb25zID0gbnVsbCwgcC5fdXBkYXRlRnVuY3Rpb25zID0ge30sIE9TLmluaXQgPSBmdW5jdGlvbihzdGFnZU5hbWUsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gX2luc3RhbmNlIHx8IChEZWJ1Zy5sb2coIkNyZWF0aW5nIHRoZSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgT1MiKSwgX2luc3RhbmNlID0gbmV3IE9TKCksIAogICAgICAgIF9pbnN0YW5jZS5pbml0aWFsaXplKHN0YWdlTmFtZSwgb3B0aW9ucykpLCBfaW5zdGFuY2U7CiAgICB9LCBwLmluaXRpYWxpemUgPSBmdW5jdGlvbihzdGFnZU5hbWUsIG9wdGlvbnMpIHsKICAgICAgICB0aGlzLkNvbnRhaW5lcl9pbml0aWFsaXplKCksIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge30sIHRoaXMub3B0aW9ucy5wYXJzZVF1ZXJ5U3RyaW5nICE9PSB1bmRlZmluZWQgJiYgKHRoaXMub3B0aW9ucyA9IHBhcnNlUXVlcnlTdHJpbmdQYXJhbXModGhpcy5vcHRpb25zKSksIAogICAgICAgIHRoaXMub3B0aW9ucy5kZWJ1ZyAhPT0gdW5kZWZpbmVkICYmIChEZWJ1Zy5lbmFibGVkID0gdGhpcy5vcHRpb25zLmRlYnVnID09PSAhMCB8fCAidHJ1ZSIgPT09IHRoaXMub3B0aW9ucy5kZWJ1ZyksIAogICAgICAgIHRoaXMub3B0aW9ucy5taW5Mb2dMZXZlbCAhPT0gdW5kZWZpbmVkICYmIChEZWJ1Zy5taW5Mb2dMZXZlbCA9IHBhcnNlSW50KHRoaXMub3B0aW9ucy5taW5Mb2dMZXZlbCwgMTApKSwgCiAgICAgICAgInN0cmluZyIgPT0gdHlwZW9mIHRoaXMub3B0aW9ucy5pcCAmJiBEZWJ1Zy5jb25uZWN0KHRoaXMub3B0aW9ucy5pcCk7CiAgICAgICAgdmFyIGxvYWRlciA9IGNsb3Vka2lkLk1lZGlhTG9hZGVyLmluaXQoKTsKICAgICAgICB0aGlzLnN0YWdlID0gbmV3IGNyZWF0ZWpzLlN0YWdlKHN0YWdlTmFtZSksIHRoaXMuc3RhZ2UubmFtZSA9ICJjbG91ZGtpZC5PUyIsIHRoaXMuc3RhZ2UuY2FudmFzLm9ubW91c2Vkb3duID0gZnVuY3Rpb24oZSkgewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfTsKICAgICAgICB2YXIgbW91c2VPdmVyUmF0ZSA9IHRoaXMub3B0aW9ucy5tb3VzZU92ZXJSYXRlID0gdGhpcy5vcHRpb25zLm1vdXNlT3ZlclJhdGUgfHwgMzA7CiAgICAgICAgdGhpcy5zdGFnZS5lbmFibGVNb3VzZU92ZXIobW91c2VPdmVyUmF0ZSksIHRoaXMuc3RhZ2UuYWRkQ2hpbGQodGhpcyksIHRoaXMudmlzaWJsZUxpc3RlbmVyID0gdGhpcy5vbldpbmRvd1Zpc2liaWxpdHlDaGFuZ2VkLmJpbmQodGhpcyksIAogICAgICAgIGFkZFBhZ2VIaWRlTGlzdGVuZXIodGhpcy52aXNpYmxlTGlzdGVuZXIpOwogICAgICAgIHZhciB0b3VjaERldmljZSA9IHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgib250b3VjaHN0YXJ0Iik7CiAgICAgICAgLTEgPT0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiTVNJRSAxMC4wIikgfHwgdG91Y2hEZXZpY2UgPyBjcmVhdGVqcy5Ub3VjaC5lbmFibGUodGhpcy5zdGFnZSkgOiBEZWJ1Zy5sb2coIklFMTAgRGVza3RvcCIpLCAKICAgICAgICB0aGlzLnN0YWdlLmF1dG9DbGVhciA9ICEhdGhpcy5vcHRpb25zLmNsZWFyVmlldyB8fCAhMSwgdGhpcy5vcHRpb25zLnNob3dGcmFtZXJhdGUgJiYgKF9mcmFtZXJhdGUgPSBuZXcgY3JlYXRlanMuVGV4dCgiIiwgIjEwcHggQXJpYWwiLCAiIzAwMCIpLCAKICAgICAgICBfZnJhbWVyYXRlLnN0cm9rZSA9IHsKICAgICAgICAgICAgd2lkdGg6IDIsCiAgICAgICAgICAgIGNvbG9yOiAiI2ZmZmZmZiIKICAgICAgICB9LCBfZnJhbWVyYXRlLnggPSBfZnJhbWVyYXRlLnkgPSA1LCB0aGlzLmFkZENoaWxkKF9mcmFtZXJhdGUpKSwgdGhpcy5zdGFnZS51cGRhdGUoKTsKICAgICAgICBpZiAoX3RpY2tDYWxsYmFjayA9IHRoaXMudGljay5iaW5kKHRoaXMpLCBfdXNlUkFGID0gdGhpcy5vcHRpb25zLnJhZiB8fCAhMSwgdGhpcy5mcHMgPSB0aGlzLm9wdGlvbnMuZnBzIHx8IDYwLCAKICAgICAgICB0aGlzLnJlbW92ZUFwcCgpLCB0aGlzLm9wdGlvbnMudmVyc2lvbnNGaWxlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgX2lzUmVhZHkgPSAhMTsKICAgICAgICAgICAgdmFyIG9zID0gdGhpczsKICAgICAgICAgICAgbG9hZGVyLmNhY2hlTWFuYWdlci5hZGRWZXJzaW9uc0ZpbGUodGhpcy5vcHRpb25zLnZlcnNpb25zRmlsZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBfaXNSZWFkeSA9ICEwLCBvcy5fYXBwICYmIChvcy5hZGRDaGlsZEF0KG9zLl9hcHAsIDApLCBvcy5fYXBwLmluaXQoKSwgb3MucmVzdW1lKCkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgX2lzUmVhZHkgPSAhMDsKICAgIH07CiAgICB2YXIgaGlkZGVuID0gbnVsbCwgZXZ0TWFwID0gbnVsbCwgdiA9ICJ2aXNpYmxlIiwgaCA9ICJoaWRkZW4iLCBhZGRQYWdlSGlkZUxpc3RlbmVyID0gZnVuY3Rpb24obGlzdGVuZXIpIHsKICAgICAgICBoaWRkZW4gPSAiaGlkZGVuIiwgaGlkZGVuIGluIGRvY3VtZW50ID8gZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigidmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKSA6IChoaWRkZW4gPSAibW96SGlkZGVuIikgaW4gZG9jdW1lbnQgPyBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJtb3p2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpIDogKGhpZGRlbiA9ICJ3ZWJraXRIaWRkZW4iKSBpbiBkb2N1bWVudCA/IGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIndlYmtpdHZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcikgOiAoaGlkZGVuID0gIm1zSGlkZGVuIikgaW4gZG9jdW1lbnQgPyBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJtc3Zpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcikgOiAib25mb2N1c2luIiBpbiBkb2N1bWVudCA/IChldnRNYXAgPSB7CiAgICAgICAgICAgIGZvY3VzaW46IHYsCiAgICAgICAgICAgIGZvY3Vzb3V0OiBoCiAgICAgICAgfSwgZG9jdW1lbnQub25mb2N1c2luID0gZG9jdW1lbnQub25mb2N1c291dCA9IGxpc3RlbmVyKSA6IChldnRNYXAgPSB7CiAgICAgICAgICAgIGZvY3VzOiB2LAogICAgICAgICAgICBwYWdlc2hvdzogdiwKICAgICAgICAgICAgYmx1cjogaCwKICAgICAgICAgICAgcGFnZWhpZGU6IGgKICAgICAgICB9LCB3aW5kb3cub25wYWdlc2hvdyA9IHdpbmRvdy5vbnBhZ2VoaWRlID0gd2luZG93Lm9uZm9jdXMgPSB3aW5kb3cub25ibHVyID0gbGlzdGVuZXIpOwogICAgfSwgcmVtb3ZlUGFnZUhpZGVMaXN0ZW5lciA9IGZ1bmN0aW9uKGxpc3RlbmVyKSB7CiAgICAgICAgdmFyIGhpZGRlbiA9ICJoaWRkZW4iOwogICAgICAgIGhpZGRlbiBpbiBkb2N1bWVudCA/IGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoInZpc2liaWxpdHljaGFuZ2UiLCBsaXN0ZW5lcikgOiAoaGlkZGVuID0gIm1vekhpZGRlbiIpIGluIGRvY3VtZW50ID8gZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW96dmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKSA6IChoaWRkZW4gPSAid2Via2l0SGlkZGVuIikgaW4gZG9jdW1lbnQgPyBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJ3ZWJraXR2aXNpYmlsaXR5Y2hhbmdlIiwgbGlzdGVuZXIpIDogKGhpZGRlbiA9ICJtc0hpZGRlbiIpIGluIGRvY3VtZW50ICYmIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1zdmlzaWJpbGl0eWNoYW5nZSIsIGxpc3RlbmVyKSwgCiAgICAgICAgZG9jdW1lbnQub25mb2N1c2luID0gZG9jdW1lbnQub25mb2N1c291dCA9IG51bGwsIHdpbmRvdy5vbnBhZ2VzaG93ID0gd2luZG93Lm9ucGFnZWhpZGUgPSB3aW5kb3cub25mb2N1cyA9IHdpbmRvdy5vbmJsdXIgPSBudWxsOwogICAgfTsKICAgIHAub25XaW5kb3dWaXNpYmlsaXR5Q2hhbmdlZCA9IGZ1bmN0aW9uKGV2dCkgewogICAgICAgIHZhciB2ID0gInZpc2libGUiLCBoID0gImhpZGRlbiI7CiAgICAgICAgZXZ0ID0gZXZ0IHx8IHdpbmRvdy5ldmVudDsKICAgICAgICB2YXIgdmFsdWU7CiAgICAgICAgdmFsdWUgPSBldnRNYXAgPyBldnRNYXBbZXZ0LnR5cGVdIDogZG9jdW1lbnRbaGlkZGVuXSA/IGggOiB2LCB2YWx1ZSA9PSBoID8gdGhpcy5wYXVzZSgpIDogdGhpcy5yZXN1bWUoKTsKICAgIH07CiAgICB2YXIgcGFyc2VRdWVyeVN0cmluZ1BhcmFtcyA9IGZ1bmN0aW9uKG91dHB1dCkgewogICAgICAgIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWYsIHF1ZXN0aW9uTWFyayA9IGhyZWYuaW5kZXhPZigiPyIpOwogICAgICAgIGlmICgtMSA9PSBxdWVzdGlvbk1hcmspIHJldHVybiBvdXRwdXQ7CiAgICAgICAgdmFyIHZhcnMgPSAwID4gcXVlc3Rpb25NYXJrID8gIiIgOiBocmVmLnN1YnN0cihxdWVzdGlvbk1hcmsgKyAxKSwgcG91bmQgPSB2YXJzLmluZGV4T2YoIiMiKTsKICAgICAgICB2YXJzID0gMCA+IHBvdW5kID8gdmFycyA6IHZhcnMuc3Vic3RyaW5nKDAsIHBvdW5kKTsKICAgICAgICBmb3IgKHZhciBteVZhciwgc3BsaXRGbGFzaFZhcnMgPSB2YXJzLnNwbGl0KCImIiksIGkgPSAwOyBpIDwgc3BsaXRGbGFzaFZhcnMubGVuZ3RoOyBpKyspIG15VmFyID0gc3BsaXRGbGFzaFZhcnNbaV0uc3BsaXQoIj0iKSwgCiAgICAgICAgRGVidWcubG9nKG15VmFyWzBdICsgIiAtPiAiICsgbXlWYXJbMV0pLCBvdXRwdXRbbXlWYXJbMF1dID0gbXlWYXJbMV07CiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH07CiAgICBwLnBhdXNlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgLTEgIT0gX3RpY2tJZCAmJiAoX3VzZVJBRiA/IHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSAmJiBjYW5jZWxBbmltYXRpb25GcmFtZShfdGlja0lkKSA6IGNsZWFyVGltZW91dChfdGlja0lkKSwgCiAgICAgICAgX3RpY2tJZCA9IC0xKSwgX3BhdXNlZCA9ICEwOwogICAgfTsKICAgIHZhciBub3dGdW5jID0gd2luZG93LnBlcmZvcm1hbmNlICYmIChwZXJmb3JtYW5jZS5ub3cgfHwgcGVyZm9ybWFuY2UubW96Tm93IHx8IHBlcmZvcm1hbmNlLm1zTm93IHx8IHBlcmZvcm1hbmNlLm9Ob3cgfHwgcGVyZm9ybWFuY2Uud2Via2l0Tm93KTsKICAgIG5vd0Z1bmMgPSBub3dGdW5jID8gbm93RnVuYy5iaW5kKHBlcmZvcm1hbmNlKSA6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIH0sIHAuZ2V0VGltZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBub3dGdW5jKCk7CiAgICB9LCBwLnJlc3VtZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIF9wYXVzZWQgPSAhMSwgLTEgPT0gX3RpY2tJZCAmJiAoX3RpY2tJZCA9IF91c2VSQUYgPyByZXF1ZXN0QW5pbUZyYW1lKF90aWNrQ2FsbGJhY2spIDogc2V0VGFyZ2V0ZWRUaW1lb3V0KF90aWNrQ2FsbGJhY2spKSwgCiAgICAgICAgX2xhc3RGUFNVcGRhdGVUaW1lID0gX2xhc3RGcmFtZVRpbWUgPSB0aGlzLmdldFRpbWUoKTsKICAgIH0sIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAiZnBzIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBfZnBzOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAibnVtYmVyIiA9PSB0eXBlb2YgdmFsdWUgJiYgKF9mcHMgPSB2YWx1ZSwgX21zUGVyRnJhbWUgPSAxZTMgLyBfZnBzIHwgMCk7CiAgICAgICAgfQogICAgfSksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAic3RhZ2VXaWR0aCIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gX2luc3RhbmNlLnN0YWdlLmNhbnZhcy53aWR0aDsKICAgICAgICB9CiAgICB9KSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJzdGFnZUhlaWdodCIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gX2luc3RhbmNlLnN0YWdlLmNhbnZhcy5oZWlnaHQ7CiAgICAgICAgfQogICAgfSk7CiAgICB2YXIgc2V0VGFyZ2V0ZWRUaW1lb3V0ID0gZnVuY3Rpb24oY2FsbGJhY2ssIHRpbWVJbkZyYW1lKSB7CiAgICAgICAgdmFyIHRpbWVUb0NhbGwgPSAwOwogICAgICAgIHJldHVybiB0aW1lSW5GcmFtZSAmJiAodGltZVRvQ2FsbCA9IE1hdGgubWF4KDAsIF9tc1BlckZyYW1lIC0gdGltZUluRnJhbWUpKSwgc2V0VGltZW91dChjYWxsYmFjaywgdGltZVRvQ2FsbCk7CiAgICB9OwogICAgcC5yZW1vdmVBcHAgPSBmdW5jdGlvbihkZXN0cm95aW5nKSB7CiAgICAgICAgdmFyIHJlbW92ZWQgPSAhMSwgc3RhZ2UgPSB0aGlzLnN0YWdlOwogICAgICAgIHJldHVybiB0aGlzLl9hcHAgJiYgKHRoaXMuY29udGFpbnModGhpcy5fYXBwKSAmJiB0aGlzLnJlbW92ZUNoaWxkKHRoaXMuX2FwcCksIHN0YWdlLnJlbW92ZUFsbENoaWxkcmVuKCksIAogICAgICAgIHRoaXMuX2FwcC5kZXN0cm95KCksIHJlbW92ZWQgPSAhMCksIHRoaXMuX2FwcCA9IG51bGwsIHRoaXMucGF1c2UoKSwgZGVzdHJveWluZyB8fCAoc3RhZ2UuYWRkQ2hpbGQodGhpcyksIAogICAgICAgIF9mcmFtZXJhdGUgJiYgKF9mcmFtZXJhdGUudGV4dCA9ICJGUFM6IDAuMDAwIiksIF9sYXN0RnJhbWVUaW1lID0gX2xhc3RGUFNVcGRhdGVUaW1lID0gX2ZyYW1lcmF0ZVZhbHVlID0gX2ZyYW1lQ291bnQgPSAwLCAKICAgICAgICB0aGlzLnN0YWdlLnVwZGF0ZSgpKSwgcmVtb3ZlZDsKICAgIH0sIHAuYWRkQXBwID0gZnVuY3Rpb24oYXBwKSB7CiAgICAgICAgaWYgKHRoaXMucmVtb3ZlQXBwKCksICEoYXBwIGluc3RhbmNlb2YgY2xvdWRraWQuQXBwbGljYXRpb24pKSB0aHJvdyBuZXcgRXJyb3IoIkNhbiBvbmx5IG9iamVjdHMgdGhhdCBpbmhlcml0IGNsb3Vka2lkLkFwcGxpY2F0aW9uIik7CiAgICAgICAgdGhpcy5fYXBwID0gYXBwLCBfaXNSZWFkeSAmJiAodGhpcy5hZGRDaGlsZEF0KGFwcCwgMCksIHRoaXMuX2FwcC5pbml0KCksIHRoaXMucmVzdW1lKCkpOwogICAgfSwgcC5nZXRBcHAgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYXBwOwogICAgfSwgcC5hZGRVcGRhdGVDYWxsYmFjayA9IGZ1bmN0aW9uKGFsaWFzLCBmKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXSA9PT0gdW5kZWZpbmVkICYmICh0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdID0gZik7CiAgICB9LCBwLnJlbW92ZVVwZGF0ZUNhbGxiYWNrID0gZnVuY3Rpb24oYWxpYXMpIHsKICAgICAgICB0aGlzLl91cGRhdGVGdW5jdGlvbnNbYWxpYXNdICE9PSB1bmRlZmluZWQgJiYgZGVsZXRlIHRoaXMuX3VwZGF0ZUZ1bmN0aW9uc1thbGlhc107CiAgICB9LCBwLnRpY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoX3BhdXNlZCkgcmV0dXJuIHZvaWQgKF90aWNrSWQgPSAtMSk7CiAgICAgICAgdmFyIG5vdyA9IHRoaXMuZ2V0VGltZSgpLCBkVGltZSA9IG5vdyAtIF9sYXN0RnJhbWVUaW1lOwogICAgICAgIGlmIChfZnJhbWVyYXRlICYmIF9mcmFtZXJhdGUudmlzaWJsZSkgewogICAgICAgICAgICBfZnJhbWVDb3VudCsrOwogICAgICAgICAgICB2YXIgZWxhcHNlZCA9IG5vdyAtIF9sYXN0RlBTVXBkYXRlVGltZTsKICAgICAgICAgICAgZWxhcHNlZCA+IDFlMyAmJiAoX2ZyYW1lcmF0ZVZhbHVlID0gMWUzIC8gZWxhcHNlZCAqIF9mcmFtZUNvdW50LCBfZnJhbWVyYXRlLnRleHQgPSAiRlBTOiAiICsgTWF0aC5yb3VuZCgxZTMgKiBfZnJhbWVyYXRlVmFsdWUpIC8gMWUzLCAKICAgICAgICAgICAgX2xhc3RGUFNVcGRhdGVUaW1lID0gbm93LCBfZnJhbWVDb3VudCA9IDApOwogICAgICAgIH0KICAgICAgICBfbGFzdEZyYW1lVGltZSA9IG5vdywgdGhpcy5fYXBwICYmIHRoaXMuX2FwcC51cGRhdGUoZFRpbWUpOwogICAgICAgIGZvciAodmFyIGFsaWFzIGluIHRoaXMuX3VwZGF0ZUZ1bmN0aW9ucykgdGhpcy5fdXBkYXRlRnVuY3Rpb25zW2FsaWFzXShkVGltZSk7CiAgICAgICAgdGhpcy5zdGFnZS51cGRhdGUoZFRpbWUpLCBfdGlja0lkID0gX3VzZVJBRiA/IHJlcXVlc3RBbmltRnJhbWUoX3RpY2tDYWxsYmFjaykgOiBzZXRUYXJnZXRlZFRpbWVvdXQoX3RpY2tDYWxsYmFjaywgdGhpcy5nZXRUaW1lKCkgLSBfbGFzdEZyYW1lVGltZSk7CiAgICB9LCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgc3RhZ2UgPSB0aGlzLnN0YWdlLCBtbCA9IGNsb3Vka2lkLk1lZGlhTG9hZGVyLmluc3RhbmNlOwogICAgICAgIHRoaXMucGF1c2UoKSwgdGhpcy5yZW1vdmVBcHAoITApLCBfaW5zdGFuY2UgPSBudWxsLCBjcmVhdGVqcy5Ub3VjaC5kaXNhYmxlKHN0YWdlKSwgCiAgICAgICAgc3RhZ2UuZW5hYmxlTW91c2VPdmVyKC0xKSwgc3RhZ2UuZW5hYmxlRE9NRXZlbnRzKCExKSwgbWwuZGVzdHJveSgpLCB0aGlzLnN0YWdlID0gbnVsbCwgCiAgICAgICAgdGhpcy5fdXBkYXRlRnVuY3Rpb25zID0gbnVsbCwgcmVtb3ZlUGFnZUhpZGVMaXN0ZW5lcih0aGlzLnZpc2libGVMaXN0ZW5lcik7CiAgICB9LCBPYmplY3QuZGVmaW5lUHJvcGVydHkoT1MsICJpbnN0YW5jZSIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIV9pbnN0YW5jZSkgdGhyb3cgIkNhbGwgY2xvdWRraWQuT1MuaW5pdChjYW52YXNJZCkiOwogICAgICAgICAgICByZXR1cm4gX2luc3RhbmNlOwogICAgICAgIH0KICAgIH0pLCBuYW1lc3BhY2UoImNsb3Vka2lkIikuT1MgPSBPUzsKfSgpLCBmdW5jdGlvbih3aW5kb3cpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBGdW5jdGlvblV0aWxzID0ge307CiAgICBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCB8fCAoRnVuY3Rpb25VdGlscy5iaW5kID0gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgPSBmdW5jdGlvbih0aGF0KSB7CiAgICAgICAgdmFyIHRhcmdldCA9IHRoaXM7CiAgICAgICAgaWYgKCJmdW5jdGlvbiIgIT0gdHlwZW9mIHRhcmdldCkgdGhyb3cgbmV3IFR5cGVFcnJvcigpOwogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgYm91bmQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkgewogICAgICAgICAgICAgICAgdmFyIEYgPSBmdW5jdGlvbigpIHt9OwogICAgICAgICAgICAgICAgRi5wcm90b3R5cGUgPSB0YXJnZXQucHJvdG90eXBlOwogICAgICAgICAgICAgICAgdmFyIHNlbGYgPSBuZXcgRigpLCByZXN1bHQgPSB0YXJnZXQuYXBwbHkoc2VsZiwgYXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgICAgICAgcmV0dXJuIE9iamVjdChyZXN1bHQpID09PSByZXN1bHQgPyByZXN1bHQgOiBzZWxmOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0YXJnZXQuYXBwbHkodGhhdCwgYXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGJvdW5kOwogICAgfSk7CiAgICBmb3IgKHZhciBsYXN0VGltZSA9IDAsIHZlbmRvcnMgPSBbICJtcyIsICJtb3oiLCAid2Via2l0IiwgIm8iIF0sIHggPSAwOyB4IDwgdmVuZG9ycy5sZW5ndGggJiYgIXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWU7ICsreCkgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IHdpbmRvd1t2ZW5kb3JzW3hdICsgIlJlcXVlc3RBbmltYXRpb25GcmFtZSJdLCAKICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IHdpbmRvd1t2ZW5kb3JzW3hdICsgIkNhbmNlbEFuaW1hdGlvbkZyYW1lIl0gfHwgd2luZG93W3ZlbmRvcnNbeF0gKyAiQ2FuY2VsUmVxdWVzdEFuaW1hdGlvbkZyYW1lIl07CiAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8ICh3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICB2YXIgY3VyclRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSwgdGltZVRvQ2FsbCA9IE1hdGgubWF4KDAsIDE2IC0gKGN1cnJUaW1lIC0gbGFzdFRpbWUpKSwgaWQgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FsbGJhY2soY3VyclRpbWUgKyB0aW1lVG9DYWxsKTsKICAgICAgICB9LCB0aW1lVG9DYWxsKTsKICAgICAgICByZXR1cm4gbGFzdFRpbWUgPSBjdXJyVGltZSArIHRpbWVUb0NhbGwsIGlkOwogICAgfSwgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lIHx8ICh3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSBmdW5jdGlvbihpZCkgewogICAgICAgIGNsZWFyVGltZW91dChpZCk7CiAgICB9KSksIEZ1bmN0aW9uVXRpbHMucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSwgd2luZG93LnJlcXVlc3RBbmltRnJhbWUgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lLCAKICAgIEZ1bmN0aW9uVXRpbHMuY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUsIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5GdW5jdGlvblV0aWxzID0gRnVuY3Rpb25VdGlsczsKfSh3aW5kb3cpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBCaXRtYXBVdGlscyA9IHt9OwogICAgQml0bWFwVXRpbHMubG9hZFNwcml0ZVNoZWV0ID0gZnVuY3Rpb24oZnJhbWVEaWN0LCBzcHJpdGVzaGVldEltYWdlLCBzY2FsZSkgewogICAgICAgIHNjYWxlID4gMCB8fCAoc2NhbGUgPSAxKTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZnJhbWVEaWN0KSB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IGZyYW1lRGljdFtrZXldLCBpbmRleCA9IGtleS5pbmRleE9mKCIuIik7CiAgICAgICAgICAgIGluZGV4ID4gMCAmJiAoa2V5ID0ga2V5LnN1YnN0cmluZygwLCBpbmRleCkpOwogICAgICAgICAgICB2YXIgYml0bWFwID0gbGliW2tleV0sIG5ld0JpdG1hcCA9IGxpYltrZXldID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjcmVhdGVqcy5Db250YWluZXIuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5ldyBjcmVhdGVqcy5CaXRtYXAodGhpcy5faW1hZ2UpOwogICAgICAgICAgICAgICAgdGhpcy5hZGRDaGlsZChjaGlsZCksIGNoaWxkLnNvdXJjZVJlY3QgPSB0aGlzLl9mcmFtZVJlY3Q7CiAgICAgICAgICAgICAgICB2YXIgcyA9IHRoaXMuX3NjYWxlOwogICAgICAgICAgICAgICAgY2hpbGQuc2V0VHJhbnNmb3JtKHRoaXMuX2ZyYW1lT2Zmc2V0WCAqIHMsIHRoaXMuX2ZyYW1lT2Zmc2V0WSAqIHMsIHMsIHMpOwogICAgICAgICAgICB9LCBwID0gbmV3Qml0bWFwLnByb3RvdHlwZSA9IG5ldyBjcmVhdGVqcy5Db250YWluZXIoKTsKICAgICAgICAgICAgcC5faW1hZ2UgPSBzcHJpdGVzaGVldEltYWdlLCBwLl9zY2FsZSA9IHNjYWxlOwogICAgICAgICAgICB2YXIgZnJhbWVSZWN0ID0gZnJhbWUuZnJhbWU7CiAgICAgICAgICAgIHAuX2ZyYW1lUmVjdCA9IG5ldyBjcmVhdGVqcy5SZWN0YW5nbGUoZnJhbWVSZWN0LngsIGZyYW1lUmVjdC55LCBmcmFtZVJlY3QudywgZnJhbWVSZWN0LmgpLCAKICAgICAgICAgICAgZnJhbWUudHJpbW1lZCA/IChwLl9mcmFtZU9mZnNldFggPSBmcmFtZS5zcHJpdGVTb3VyY2VTaXplLngsIHAuX2ZyYW1lT2Zmc2V0WSA9IGZyYW1lLnNwcml0ZVNvdXJjZVNpemUueSkgOiBwLl9mcmFtZU9mZnNldFggPSBwLl9mcmFtZU9mZnNldFkgPSAwLCAKICAgICAgICAgICAgcC5ub21pbmFsQm91bmRzID0gYml0bWFwICYmIGJpdG1hcC5wcm90b3R5cGUubm9taW5hbEJvdW5kcyA/IGJpdG1hcC5wcm90b3R5cGUubm9taW5hbEJvdW5kcyA6IG5ldyBjcmVhdGVqcy5SZWN0YW5nbGUoMCwgMCwgZnJhbWUuc291cmNlU2l6ZS53LCBmcmFtZS5zb3VyY2VTaXplLmgpOwogICAgICAgIH0KICAgIH0sIEJpdG1hcFV0aWxzLnJlcGxhY2VXaXRoU2NhbGVkQml0bWFwID0gZnVuY3Rpb24oaWRPckRpY3QsIHNjYWxlKSB7CiAgICAgICAgaWYgKDEgIT0gc2NhbGUgJiYgc2NhbGUgPiAwKSB7CiAgICAgICAgICAgIHZhciBrZXksIGJpdG1hcCwgbmV3Qml0bWFwLCBwOwogICAgICAgICAgICBpZiAoInN0cmluZyIgPT0gdHlwZW9mIGlkT3JEaWN0KSBrZXkgPSBpZE9yRGljdCwgYml0bWFwID0gbGliW2tleV0sIGJpdG1hcCAmJiAobmV3Qml0bWFwID0gbGliW2tleV0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGNyZWF0ZWpzLkNvbnRhaW5lci5jYWxsKHRoaXMpOwogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbmV3IHRoaXMuX29sZEJNKCk7CiAgICAgICAgICAgICAgICB0aGlzLmFkZENoaWxkKGNoaWxkKSwgY2hpbGQuc2V0VHJhbnNmb3JtKDAsIDAsIHRoaXMuX3NjYWxlLCB0aGlzLl9zY2FsZSk7CiAgICAgICAgICAgIH0sIHAgPSBuZXdCaXRtYXAucHJvdG90eXBlID0gbmV3IGNyZWF0ZWpzLkNvbnRhaW5lcigpLCBwLl9vbGRCTSA9IGJpdG1hcCwgcC5fc2NhbGUgPSBzY2FsZSwgCiAgICAgICAgICAgIHAubm9taW5hbEJvdW5kcyA9IGJpdG1hcC5wcm90b3R5cGUubm9taW5hbEJvdW5kcyk7IGVsc2UgZm9yIChrZXkgaW4gaWRPckRpY3QpIGJpdG1hcCA9IGxpYltrZXldLCAKICAgICAgICAgICAgYml0bWFwICYmIChuZXdCaXRtYXAgPSBsaWJba2V5XSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY3JlYXRlanMuQ29udGFpbmVyLmNhbGwodGhpcyk7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBuZXcgdGhpcy5fb2xkQk0oKTsKICAgICAgICAgICAgICAgIHRoaXMuYWRkQ2hpbGQoY2hpbGQpLCBjaGlsZC5zZXRUcmFuc2Zvcm0oMCwgMCwgdGhpcy5fc2NhbGUsIHRoaXMuX3NjYWxlKTsKICAgICAgICAgICAgfSwgcCA9IG5ld0JpdG1hcC5wcm90b3R5cGUgPSBuZXcgY3JlYXRlanMuQ29udGFpbmVyKCksIHAuX29sZEJNID0gYml0bWFwLCBwLl9zY2FsZSA9IHNjYWxlLCAKICAgICAgICAgICAgcC5ub21pbmFsQm91bmRzID0gYml0bWFwLnByb3RvdHlwZS5ub21pbmFsQm91bmRzKTsKICAgICAgICB9CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuQml0bWFwVXRpbHMgPSBCaXRtYXBVdGlsczsKfSgpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBTYXZlZERhdGEgPSB7fSwgV0VCX1NUT1JBR0VfU1VQUE9SVCA9ICJ1bmRlZmluZWQiICE9IHR5cGVvZiB3aW5kb3cuU3RvcmFnZSwgRVJBU0VfQ09PS0lFID0gLTE7CiAgICBpZiAoV0VCX1NUT1JBR0VfU1VQUE9SVCkgdHJ5IHsKICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiTFNfVEVTVCIsICJ0ZXN0IiksIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJMU19URVNUIik7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgV0VCX1NUT1JBR0VfU1VQUE9SVCA9ICExOwogICAgfQogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFNhdmVkRGF0YSwgInVzZVdlYlN0b3JhZ2UiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIFdFQl9TVE9SQUdFX1NVUFBPUlQ7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiAidW5kZWZpbmVkIiAhPSB0eXBlb2Ygd2luZG93LlN0b3JhZ2UpIHRyeSB7CiAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiTFNfVEVTVCIsICJ0ZXN0IiksIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCJMU19URVNUIiksIFdFQl9TVE9SQUdFX1NVUFBPUlQgPSAhMDsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgV0VCX1NUT1JBR0VfU1VQUE9SVCA9ICExOwogICAgICAgICAgICB9IGVsc2UgV0VCX1NUT1JBR0VfU1VQUE9SVCA9ICExOwogICAgICAgIH0KICAgIH0pLCBTYXZlZERhdGEucmVtb3ZlID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgIFdFQl9TVE9SQUdFX1NVUFBPUlQgPyAobG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0obmFtZSksIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0obmFtZSkpIDogU2F2ZWREYXRhLndyaXRlKG5hbWUsICIiLCBFUkFTRV9DT09LSUUpOwogICAgfSwgU2F2ZWREYXRhLndyaXRlID0gZnVuY3Rpb24obmFtZSwgdmFsdWUsIHRlbXBPbmx5KSB7CiAgICAgICAgaWYgKFdFQl9TVE9SQUdFX1NVUFBPUlQpIHRlbXBPbmx5ID8gc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShuYW1lLCBKU09OLnN0cmluZ2lmeSh2YWx1ZSkpIDogbG9jYWxTdG9yYWdlLnNldEl0ZW0obmFtZSwgSlNPTi5zdHJpbmdpZnkodmFsdWUpKTsgZWxzZSB7CiAgICAgICAgICAgIHZhciBleHBpcmVzOwogICAgICAgICAgICBleHBpcmVzID0gdGVtcE9ubHkgPyB0ZW1wT25seSAhPT0gRVJBU0VfQ09PS0lFID8gIiIgOiAiOyBleHBpcmVzPVRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UIiA6ICI7IGV4cGlyZXM9IiArIG5ldyBEYXRlKDIxNDc0ODM2NDZlMykudG9HTVRTdHJpbmcoKSwgCiAgICAgICAgICAgIGRvY3VtZW50LmNvb2tpZSA9IG5hbWUgKyAiPSIgKyBlc2NhcGUoSlNPTi5zdHJpbmdpZnkodmFsdWUpKSArIGV4cGlyZXMgKyAiOyBwYXRoPS8iOwogICAgICAgIH0KICAgIH0sIFNhdmVkRGF0YS5yZWFkID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgIGlmIChXRUJfU1RPUkFHRV9TVVBQT1JUKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKG5hbWUpIHx8IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0obmFtZSk7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA/IEpTT04ucGFyc2UodmFsdWUpIDogbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGMsIG5hbWVFUSA9IG5hbWUgKyAiPSIsIGNhID0gZG9jdW1lbnQuY29va2llLnNwbGl0KCI7IiksIGkgPSAwOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBjYS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBmb3IgKGMgPSBjYVtpXTsgIiAiID09IGMuY2hhckF0KDApOyApIGMgPSBjLnN1YnN0cmluZygxLCBjLmxlbmd0aCk7CiAgICAgICAgICAgIGlmICgwID09PSBjLmluZGV4T2YobmFtZUVRKSkgcmV0dXJuIEpTT04ucGFyc2UodW5lc2NhcGUoYy5zdWJzdHJpbmcobmFtZUVRLmxlbmd0aCwgYy5sZW5ndGgpKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLlNhdmVkRGF0YSA9IFNhdmVkRGF0YTsKfSgpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHdpbmRvdy5VUkwgPSB3aW5kb3cuVVJMIHx8IHdpbmRvdy53ZWJraXRVUkwsIHdpbmRvdy5CbG9iQnVpbGRlciA9IHdpbmRvdy5CbG9iQnVpbGRlciB8fCB3aW5kb3cuV2ViS2l0QmxvYkJ1aWxkZXIgfHwgd2luZG93Lk1vekJsb2JCdWlsZGVyOwogICAgdmFyIFdvcmtlciA9IHt9OwogICAgV29ya2VyLmluaXQgPSBmdW5jdGlvbihjb2RlU3RyaW5nKSB7CiAgICAgICAgaWYgKCF3aW5kb3cuVVJMIHx8ICF3aW5kb3cuV29ya2VyKSByZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwogICAgICAgIHZhciBibG9iOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGJsb2IgPSBuZXcgQmxvYihbIGNvZGVTdHJpbmcgXSwgewogICAgICAgICAgICAgICAgdHlwZTogImFwcGxpY2F0aW9uL2phdmFzY3JpcHQiCiAgICAgICAgICAgIH0pOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaWYgKCF3aW5kb3cuQmxvYkJ1aWxkZXIpIHJldHVybiBuZXcgRmFsbGJhY2tXb3JrZXIoY29kZVN0cmluZyk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBibG9iID0gbmV3IEJsb2JCdWlsZGVyKCksIGJsb2IuYXBwZW5kKGNvZGVTdHJpbmcpLCBibG9iID0gYmxvYi5nZXRCbG9iKCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEZhbGxiYWNrV29ya2VyKGNvZGVTdHJpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghYmxvYikgcmV0dXJuIG5ldyBGYWxsYmFja1dvcmtlcihjb2RlU3RyaW5nKTsKICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgd29ya2VyID0gbmV3IFdvcmtlcihVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpKTsKICAgICAgICAgICAgcmV0dXJuIHdvcmtlcjsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgRmFsbGJhY2tXb3JrZXIoY29kZVN0cmluZyk7CiAgICAgICAgfQogICAgfSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLmNyZWF0ZVdvcmtlciA9IFdvcmtlci5pbml0LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuV29ya2VyID0gV29ya2VyOwogICAgdmFyIFN1YldvcmtlciA9IGZ1bmN0aW9uKGNvZGVTdHJpbmcsIHBhcmVudCkgewogICAgICAgIHRoaXMuX3dQYXJlbnQgPSBwYXJlbnQsIGV2YWwoY29kZVN0cmluZyk7CiAgICB9LCBwID0gU3ViV29ya2VyLnByb3RvdHlwZTsKICAgIHAub25tZXNzYWdlID0gbnVsbCwgcC5fd1BhcmVudCA9IG51bGwsIHAucG9zdE1lc3NhZ2UgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMuX3dQYXJlbnQ7CiAgICAgICAgc2V0VGltZW91dChwYXJlbnQub25tZXNzYWdlLmJpbmQocGFyZW50LCB7CiAgICAgICAgICAgIGRhdGE6IGRhdGEKICAgICAgICB9KSwgMSk7CiAgICB9OwogICAgdmFyIEZhbGxiYWNrV29ya2VyID0gZnVuY3Rpb24oY29kZVN0cmluZykgewogICAgICAgIHRoaXMuX3dDaGlsZCA9IG5ldyBTdWJXb3JrZXIoY29kZVN0cmluZywgdGhpcyk7CiAgICB9OwogICAgcCA9IEZhbGxiYWNrV29ya2VyLnByb3RvdHlwZSwgcC5wb3N0TWVzc2FnZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICB2YXIgY2hpbGQgPSB0aGlzLl93Q2hpbGQ7CiAgICAgICAgc2V0VGltZW91dChjaGlsZC5vbm1lc3NhZ2UuYmluZChjaGlsZCwgewogICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgfSksIDEpOwogICAgfSwgcC50ZXJtaW5hdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLm9ubWVzc2FnZSA9IG51bGw7CiAgICAgICAgdmFyIGNoaWxkID0gdGhpcy5fd0NoaWxkOwogICAgICAgIGNoaWxkLl93UGFyZW50ID0gbnVsbCwgY2hpbGQub25tZXNzYWdlID0gbnVsbCwgdGhpcy5fd0NoaWxkID0gbnVsbDsKICAgIH0sIHAub25tZXNzYWdlID0gbnVsbCwgcC5fd0NoaWxkID0gbnVsbDsKfSgpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBDb21iaW5lZENhbGxiYWNrID0gZnVuY3Rpb24oY2FsbCwgb2JqLCBwcm9wLCBjYWxsUHJvcCkgewogICAgICAgIG9ialtwcm9wXSA/IG9ialtjYWxsUHJvcF0gPSBjYWxsIDogY2FsbCgpOwogICAgfTsKICAgIENvbWJpbmVkQ2FsbGJhY2suY3JlYXRlID0gZnVuY3Rpb24oY2FsbCwgb2JqLCBwcm9wLCBjYWxsUHJvcCkgewogICAgICAgIHJldHVybiBDb21iaW5lZENhbGxiYWNrLmJpbmQodGhpcywgY2FsbCwgb2JqLCBwcm9wLCBjYWxsUHJvcCk7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuQ29tYmluZWRDYWxsYmFjayA9IENvbWJpbmVkQ2FsbGJhY2s7Cn0oKSwgZnVuY3Rpb24odW5kZWZpbmVkKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgTkVYVF9JRCA9IDAsIERlbGF5ZWRDYWxsID0gZnVuY3Rpb24oY2FsbGJhY2ssIGRlbGF5LCByZXBlYXQsIGF1dG9EZXN0cm95KSB7CiAgICAgICAgdGhpcy5fY2FsbGJhY2sgPSBjYWxsYmFjaywgdGhpcy5fZGVsYXkgPSBkZWxheSwgdGhpcy5fdGltZXIgPSBkZWxheSwgdGhpcy5fcmVwZWF0ID0gISFyZXBlYXQsIAogICAgICAgIHRoaXMuX2F1dG9EZXN0cm95ID0gYXV0b0Rlc3Ryb3kgPT09IHVuZGVmaW5lZCA/ICEwIDogISFhdXRvRGVzdHJveSwgdGhpcy5fdXBkYXRlSWQgPSAiRGVsYXllZENhbGwjIiArICsrTkVYVF9JRCwgCiAgICAgICAgdGhpcy5fcGF1c2VkID0gITEsIHRoaXMuX3VwZGF0ZSA9IHRoaXMuX3VwZGF0ZS5iaW5kKHRoaXMpLCBjbG91ZGtpZC5PUy5pbnN0YW5jZS5hZGRVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCwgdGhpcy5fdXBkYXRlKTsKICAgIH0sIHAgPSBEZWxheWVkQ2FsbC5wcm90b3R5cGU7CiAgICBwLl91cGRhdGUgPSBmdW5jdGlvbihlbGFwc2VkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NhbGxiYWNrID8gKHRoaXMuX3RpbWVyIC09IGVsYXBzZWQsIHZvaWQgKHRoaXMuX3RpbWVyIDw9IDAgJiYgKHRoaXMuX2NhbGxiYWNrKCksIAogICAgICAgIHRoaXMuX3JlcGVhdCA/IHRoaXMuX3RpbWVyICs9IHRoaXMuX2RlbGF5IDogdGhpcy5fYXV0b0Rlc3Ryb3kgPyB0aGlzLmRlc3Ryb3koKSA6IGNsb3Vka2lkLk9TLmluc3RhbmNlLnJlbW92ZVVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkKSkpKSA6IHZvaWQgdGhpcy5kZXN0cm95KCk7CiAgICB9LCBwLnJlc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5fY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIG9zID0gY2xvdWRraWQuT1MuaW5zdGFuY2U7CiAgICAgICAgICAgIG9zLmFkZFVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkLCB0aGlzLl91cGRhdGUpLCB0aGlzLl90aW1lciA9IHRoaXMuX2RlbGF5LCB0aGlzLl9wYXVzZWQgPSAhMTsKICAgICAgICB9CiAgICB9LCBwLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgICBjbG91ZGtpZC5PUy5pbnN0YW5jZS5yZW1vdmVVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCksIHRoaXMuX3BhdXNlZCA9ICExOwogICAgfSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJwYXVzZWQiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BhdXNlZDsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2NhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB2YXIgb3MgPSBjbG91ZGtpZC5PUy5pbnN0YW5jZTsKICAgICAgICAgICAgICAgIHRoaXMuX3BhdXNlZCAmJiAhdmFsdWUgPyAodGhpcy5fcGF1c2VkID0gITEsIG9zLmhhc1VwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkKSB8fCBvcy5hZGRVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCwgdGhpcy5fdXBkYXRlKSkgOiB2YWx1ZSAmJiBvcy5oYXNVcGRhdGVDYWxsYmFjayh0aGlzLl91cGRhdGVJZCkgJiYgKHRoaXMuX3BhdXNlZCA9ICEwLCAKICAgICAgICAgICAgICAgIG9zLnJlbW92ZVVwZGF0ZUNhbGxiYWNrKHRoaXMuX3VwZGF0ZUlkKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwgcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY2xvdWRraWQuT1MuaW5zdGFuY2UucmVtb3ZlVXBkYXRlQ2FsbGJhY2sodGhpcy5fdXBkYXRlSWQpLCB0aGlzLl9jYWxsYmFjayA9IG51bGw7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuRGVsYXllZENhbGwgPSBEZWxheWVkQ2FsbDsKfSgpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBwLCBBcHBsaWNhdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgfTsKICAgIHAgPSBBcHBsaWNhdGlvbi5wcm90b3R5cGUgPSBuZXcgY3JlYXRlanMuQ29udGFpbmVyKCksIHAuaW5pdCA9IGZ1bmN0aW9uKCkge30sIHAudXBkYXRlID0gZnVuY3Rpb24oKSB7fSwgCiAgICBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHt9LCBwLnJlc2l6ZSA9IGZ1bmN0aW9uKCkge30sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5BcHBsaWNhdGlvbiA9IEFwcGxpY2F0aW9uOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIExvYWRlclF1ZXVlSXRlbSA9IGZ1bmN0aW9uKCkge30sIHAgPSBMb2FkZXJRdWV1ZUl0ZW0ucHJvdG90eXBlOwogICAgTG9hZGVyUXVldWVJdGVtLlBSSU9SSVRZX0hJR0ggPSAxLCBMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTk9STUFMID0gMCwgTG9hZGVyUXVldWVJdGVtLlBSSU9SSVRZX0xPVyA9IC0xLCAKICAgIHAudXJsID0gbnVsbCwgcC5kYXRhID0gbnVsbCwgcC5jYWxsYmFjayA9IG51bGwsIHAucHJpb3JpdHkgPSAwLCBwLnByb2dyZXNzID0gMCwgCiAgICBwLnVwZGF0ZUNhbGxiYWNrID0gbnVsbCwgcC5fYm91bmRGYWlsID0gbnVsbCwgcC5fYm91bmRQcm9ncmVzcyA9IG51bGwsIHAuX2JvdW5kQ29tcGxldGUgPSBudWxsLCAKICAgIHAudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gIltMb2FkZXJRdWV1ZUl0ZW0odXJsOiciICsgdGhpcy51cmwgKyAiJywgcHJpb3JpdHk6IiArIHRoaXMucHJpb3JpdHkgKyAiKV0iOwogICAgfSwgcC5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5jYWxsYmFjayA9IG51bGwsIHRoaXMudXBkYXRlQ2FsbGJhY2sgPSBudWxsLCB0aGlzLmRhdGEgPSBudWxsLCB0aGlzLl9ib3VuZEZhaWwgPSBudWxsLCAKICAgICAgICB0aGlzLl9ib3VuZFByb2dyZXNzID0gbnVsbCwgdGhpcy5fYm91bmRDb21wbGV0ZSA9IG51bGw7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuTG9hZGVyUXVldWVJdGVtID0gTG9hZGVyUXVldWVJdGVtOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIE1lZGlhTG9hZGVyID0gZnVuY3Rpb24oKSB7fSwgcCA9IE1lZGlhTG9hZGVyLnByb3RvdHlwZTsKICAgIE1lZGlhTG9hZGVyLl9pbnN0YW5jZSA9IG51bGw7CiAgICB2YXIgcXVldWUgPSBudWxsLCBxdWV1ZUl0ZW1zID0gbnVsbCwgbG9hZGVycyA9IG51bGwsIHFpUG9vbCA9IG51bGwsIGxvYWRlclBvb2wgPSBudWxsLCByZXN1bHRQb29sID0gbnVsbCwgbnVtTG9hZHMgPSAwLCByZXRyaWVzID0gbnVsbDsKICAgIHAuX2NhbkxvYWQgPSAhMCwgcC5tYXhTaW11bHRhbmVvdXNMb2FkcyA9IDIsIHAuY2FjaGVNYW5hZ2VyID0gbnVsbCwgTWVkaWFMb2FkZXIuaW5pdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBNZWRpYUxvYWRlci5faW5zdGFuY2UgfHwgKE1lZGlhTG9hZGVyLl9pbnN0YW5jZSA9IG5ldyBNZWRpYUxvYWRlcigpLCBNZWRpYUxvYWRlci5faW5zdGFuY2UuX2luaXRpYWxpemUoKSksIAogICAgICAgIE1lZGlhTG9hZGVyLl9pbnN0YW5jZTsKICAgIH0sIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShNZWRpYUxvYWRlciwgImluc3RhbmNlIiwgewogICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICghTWVkaWFMb2FkZXIuX2luc3RhbmNlKSB0aHJvdyAiQ2FsbCBjbG91ZGtpZC5NZWRpYUxvYWRlci5pbml0KCkiOwogICAgICAgICAgICByZXR1cm4gTWVkaWFMb2FkZXIuX2luc3RhbmNlOwogICAgICAgIH0KICAgIH0pLCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgaSwgbGVuLCBrZXksIGFyciA9IHRoaXMucXVldWU7CiAgICAgICAgaWYgKGFycikgewogICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpID4gaTsgKytpKSBhcnJbaV0uZGVzdHJveSgpOwogICAgICAgICAgICBmb3IgKGFyciA9IHFpUG9vbCwgaSA9IDAsIGxlbiA9IGFyci5sZW5ndGg7IGkgPiBpOyArK2kpIGFycltpXS5kZXN0cm95KCk7CiAgICAgICAgICAgIGZvciAoYXJyID0gcmVzdWx0UG9vbCwgaSA9IDAsIGxlbiA9IGFyci5sZW5ndGg7IGkgPiBpOyArK2kpIGFycltpXS5kZXN0cm95KCk7CiAgICAgICAgICAgIGZvciAoa2V5IGluIGxvYWRlcnMpIHF1ZXVlSXRlbXNba2V5XS5kZXN0cm95KCksIGxvYWRlcnNba2V5XS5jbG9zZSgpOwogICAgICAgIH0KICAgICAgICBNZWRpYUxvYWRlci5faW5zdGFuY2UgPSBudWxsLCB0aGlzLmNhY2hlTWFuYWdlciAmJiB0aGlzLmNhY2hlTWFuYWdlci5kZXN0cm95KCksIAogICAgICAgIHRoaXMuY2FjaGVNYW5hZ2VyID0gbnVsbCwgcXVldWUgPSBudWxsLCByZXN1bHRQb29sID0gbnVsbCwgbG9hZGVyUG9vbCA9IG51bGwsIHFpUG9vbCA9IG51bGwsIAogICAgICAgIHF1ZXVlSXRlbXMgPSBudWxsLCByZXRyaWVzID0gbnVsbCwgbG9hZGVycyA9IG51bGw7CiAgICB9LCBwLl9pbml0aWFsaXplID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcWlQb29sID0gW10sIGxvYWRlclBvb2wgPSBbXSwgcmVzdWx0UG9vbCA9IFtdLCBxdWV1ZSA9IFtdLCBxdWV1ZUl0ZW1zID0ge30sIGxvYWRlcnMgPSB7fSwgCiAgICAgICAgcmV0cmllcyA9IHt9LCB0aGlzLmNhY2hlTWFuYWdlciA9IG5ldyBjbG91ZGtpZC5DYWNoZU1hbmFnZXIoKTsKICAgIH0sIHAubG9hZCA9IGZ1bmN0aW9uKHVybCwgY2FsbGJhY2ssIHVwZGF0ZUNhbGxiYWNrLCBwcmlvcml0eSwgZGF0YSkgewogICAgICAgIHZhciBxaSA9IHRoaXMuX2dldFFJKCksIGJhc2VQYXRoID0gY2xvdWRraWQuT1MuaW5zdGFuY2Uub3B0aW9ucy5iYXNlUGF0aDsKICAgICAgICB2b2lkIDAgIT09IGJhc2VQYXRoICYmIC9eaHR0cChzKT9cOi8udGVzdCh1cmwpID09PSAhMSAmJiAtMSA9PSB1cmwuc2VhcmNoKGJhc2VQYXRoKSAmJiAocWkuYmFzZVBhdGggPSBiYXNlUGF0aCksIAogICAgICAgIHFpLnVybCA9IHVybCwgcWkuY2FsbGJhY2sgPSBjYWxsYmFjaywgcWkudXBkYXRlQ2FsbGJhY2sgPSB1cGRhdGVDYWxsYmFjayB8fCBudWxsLCAKICAgICAgICBxaS5wcmlvcml0eSA9IHByaW9yaXR5IHx8IGNsb3Vka2lkLkxvYWRlclF1ZXVlSXRlbS5QUklPUklUWV9OT1JNQUwsIHFpLmRhdGEgPSBkYXRhIHx8IG51bGwsIAogICAgICAgIHF1ZXVlLnB1c2gocWkpLCBxdWV1ZS5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEucHJpb3JpdHkgLSBiLnByaW9yaXR5OwogICAgICAgIH0pLCB0aGlzLl90cnlOZXh0TG9hZCgpOwogICAgfSwgcC5fb25Mb2FkRmFpbGVkID0gZnVuY3Rpb24ocWksIGV2ZW50KSB7CiAgICAgICAgRGVidWcuZXJyb3IoIlVuYWJsZSB0byBsb2FkIGZpbGU6ICIgKyBxaS51cmwgKyAiIC0gcmVhc29uOiAiICsgZXZlbnQuZXJyb3IpOwogICAgICAgIHZhciBsb2FkZXIgPSBsb2FkZXJzW3FpLnVybF07CiAgICAgICAgbG9hZGVyLnJlbW92ZUFsbEV2ZW50TGlzdGVuZXJzKCksIGxvYWRlci5jbG9zZSgpLCB0aGlzLl9wb29sTG9hZGVyKGxvYWRlciksIGRlbGV0ZSBxdWV1ZUl0ZW1zW3FpLnVybF0sIAogICAgICAgIGRlbGV0ZSBsb2FkZXJzW3FpLnVybF0sIHJldHJpZXNbcWkudXJsXSA/IHJldHJpZXNbcWkudXJsXSsrIDogcmV0cmllc1txaS51cmxdID0gMSwgCiAgICAgICAgcmV0cmllc1txaS51cmxdID4gMyA/IHRoaXMuX2xvYWREb25lKHFpLCBudWxsKSA6IChudW1Mb2Fkcy0tLCBxdWV1ZS5wdXNoKHFpKSwgdGhpcy5fdHJ5TmV4dExvYWQoKSk7CiAgICB9LCBwLl9vbkxvYWRQcm9ncmVzcyA9IGZ1bmN0aW9uKHFpLCBldmVudCkgewogICAgICAgIHFpLnByb2dyZXNzID0gZXZlbnQucHJvZ3Jlc3MsIHFpLnVwZGF0ZUNhbGxiYWNrICYmIHFpLnVwZGF0ZUNhbGxiYWNrKHFpLnByb2dyZXNzKTsKICAgIH0sIHAuX29uTG9hZENvbXBsZXRlZCA9IGZ1bmN0aW9uKHFpLCBldikgewogICAgICAgIERlYnVnLmxvZygiRmlsZSBsb2FkZWQgc3VjY2Vzc2Z1bGx5IGZyb20gIiArIHFpLnVybCk7CiAgICAgICAgdmFyIGxvYWRlciA9IGxvYWRlcnNbcWkudXJsXTsKICAgICAgICBsb2FkZXIucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMoKSwgbG9hZGVyLmNsb3NlKCksIHRoaXMuX3Bvb2xMb2FkZXIobG9hZGVyKSwgZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXSwgCiAgICAgICAgZGVsZXRlIGxvYWRlcnNbcWkudXJsXSwgdGhpcy5fbG9hZERvbmUocWksIHRoaXMuX2dldFJlc3VsdChldi5yZXN1bHQsIHFpLnVybCwgbG9hZGVyKSk7CiAgICB9LCBwLl90cnlOZXh0TG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghKG51bUxvYWRzID4gdGhpcy5tYXhTaW11bHRhbmVvdXNMb2FkcyAtIDEgfHwgMCA9PT0gcXVldWUubGVuZ3RoKSkgewogICAgICAgICAgICBudW1Mb2FkcysrOwogICAgICAgICAgICB2YXIgcWkgPSBxdWV1ZS5zaGlmdCgpOwogICAgICAgICAgICBEZWJ1Zy5sb2coIkF0dGVtcHRpbmcgdG8gbG9hZCBmaWxlICciICsgcWkudXJsICsgIiciKSwgcXVldWVJdGVtc1txaS51cmxdID0gcWk7CiAgICAgICAgICAgIHZhciBsb2FkZXIgPSB0aGlzLl9nZXRMb2FkZXIocWkuYmFzZVBhdGgpOwogICAgICAgICAgICBsb2FkZXJzW3FpLnVybF0gPSBsb2FkZXIsIGxvYWRlci5hZGRFdmVudExpc3RlbmVyKCJmaWxlbG9hZCIsIHFpLl9ib3VuZENvbXBsZXRlKSwgCiAgICAgICAgICAgIGxvYWRlci5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsIHFpLl9ib3VuZEZhaWwpLCBsb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcigiZmlsZXByb2dyZXNzIiwgcWkuX2JvdW5kUHJvZ3Jlc3MpOwogICAgICAgICAgICB2YXIgdXJsID0gdGhpcy5jYWNoZU1hbmFnZXIucHJlcGFyZShxaS51cmwpOwogICAgICAgICAgICBsb2FkZXIubG9hZEZpbGUocWkuZGF0YSA/IHsKICAgICAgICAgICAgICAgIGlkOiBxaS5kYXRhLmlkLAogICAgICAgICAgICAgICAgc3JjOiB1cmwsCiAgICAgICAgICAgICAgICBkYXRhOiBxaS5kYXRhCiAgICAgICAgICAgIH0gOiB1cmwpOwogICAgICAgIH0KICAgIH0sIHAuX2xvYWREb25lID0gZnVuY3Rpb24ocWksIHJlc3VsdCkgewogICAgICAgIG51bUxvYWRzLS0sIHFpLmRhdGEgJiYgcmVzdWx0ICYmIChyZXN1bHQuaWQgPSBxaS5kYXRhLmlkKSwgcWkuY2FsbGJhY2socmVzdWx0KSwgCiAgICAgICAgdGhpcy5fcG9vbFFJKHFpKSwgdGhpcy5fdHJ5TmV4dExvYWQoKTsKICAgIH0sIHAuY2FuY2VsID0gZnVuY3Rpb24odXJsKSB7CiAgICAgICAgdmFyIHFpID0gcXVldWVJdGVtc1t1cmxdLCBsb2FkZXIgPSBsb2FkZXJzW3VybF07CiAgICAgICAgaWYgKHFpICYmIGxvYWRlcikgcmV0dXJuIGxvYWRlci5jbG9zZSgpLCBkZWxldGUgbG9hZGVyc1t1cmxdLCBkZWxldGUgcXVldWVJdGVtc1txaS51cmxdLCAKICAgICAgICBudW1Mb2Fkcy0tLCB0aGlzLl9wb29sTG9hZGVyKGxvYWRlciksIHRoaXMuX3Bvb2xRSShxaSksICEwOwogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IHF1ZXVlLmxlbmd0aDsgbGVuID4gaTsgaSsrKSBpZiAocWkgPSBxdWV1ZVtpXSwgcWkudXJsID09IHVybCkgcmV0dXJuIHF1ZXVlLnNwbGljZShpLCAxKSwgCiAgICAgICAgdGhpcy5fcG9vbFFJKHFpKSwgITA7CiAgICAgICAgcmV0dXJuICExOwogICAgfSwgcC5fZ2V0UUkgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgcnRuOwogICAgICAgIHJldHVybiBxaVBvb2wubGVuZ3RoID8gcnRuID0gcWlQb29sLnBvcCgpIDogKHJ0biA9IG5ldyBjbG91ZGtpZC5Mb2FkZXJRdWV1ZUl0ZW0oKSwgCiAgICAgICAgcnRuLl9ib3VuZEZhaWwgPSB0aGlzLl9vbkxvYWRGYWlsZWQuYmluZCh0aGlzLCBydG4pLCBydG4uX2JvdW5kUHJvZ3Jlc3MgPSB0aGlzLl9vbkxvYWRQcm9ncmVzcy5iaW5kKHRoaXMsIHJ0biksIAogICAgICAgIHJ0bi5fYm91bmRDb21wbGV0ZSA9IHRoaXMuX29uTG9hZENvbXBsZXRlZC5iaW5kKHRoaXMsIHJ0bikpLCBydG47CiAgICB9LCBwLl9wb29sUUkgPSBmdW5jdGlvbihxaSkgewogICAgICAgIHFpUG9vbC5wdXNoKHFpKSwgcWkuY2FsbGJhY2sgPSBxaS51cGRhdGVDYWxsYmFjayA9IHFpLmRhdGEgPSBxaS51cmwgPSBudWxsLCBxaS5wcm9ncmVzcyA9IDA7CiAgICB9LCBwLl9nZXRMb2FkZXIgPSBmdW5jdGlvbihiYXNlUGF0aCkgewogICAgICAgIHZhciBydG47CiAgICAgICAgcmV0dXJuIGxvYWRlclBvb2wubGVuZ3RoID8gKHJ0biA9IGxvYWRlclBvb2wucG9wKCksIHJ0bi5fYmFzZVBhdGggPSBiYXNlUGF0aCkgOiBydG4gPSBuZXcgY3JlYXRlanMuTG9hZFF1ZXVlKCEwLCBiYXNlUGF0aCksIAogICAgICAgIGNyZWF0ZWpzLlNvdW5kICYmIHJ0bi5pbnN0YWxsUGx1Z2luKGNyZWF0ZWpzLlNvdW5kKSwgcnRuOwogICAgfSwgcC5fcG9vbExvYWRlciA9IGZ1bmN0aW9uKGxvYWRlcikgewogICAgICAgIGxvYWRlci5yZW1vdmVBbGwoKSwgbG9hZGVyUG9vbC5wdXNoKGxvYWRlcik7CiAgICB9LCBwLl9nZXRSZXN1bHQgPSBmdW5jdGlvbihyZXN1bHQsIHVybCwgbG9hZGVyKSB7CiAgICAgICAgdmFyIHJ0bjsKICAgICAgICByZXR1cm4gcmVzdWx0UG9vbC5sZW5ndGggPyAocnRuID0gcmVzdWx0UG9vbC5wb3AoKSwgcnRuLmNvbnRlbnQgPSByZXN1bHQsIHJ0bi51cmwgPSB1cmwsIAogICAgICAgIHJ0bi5sb2FkZXIgPSBsb2FkZXIpIDogcnRuID0gbmV3IGNsb3Vka2lkLk1lZGlhTG9hZGVyUmVzdWx0KHJlc3VsdCwgdXJsLCBsb2FkZXIpLCAKICAgICAgICBydG47CiAgICB9LCBwLl9wb29sUmVzdWx0ID0gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICAgICAgcmVzdWx0LmNvbnRlbnQgPSByZXN1bHQudXJsID0gcmVzdWx0LmxvYWRlciA9IHJlc3VsdC5pZCA9IG51bGwsIHJlc3VsdFBvb2wucHVzaChyZXN1bHQpOwogICAgfSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLk1lZGlhTG9hZGVyID0gTWVkaWFMb2FkZXI7Cn0oKSwgZnVuY3Rpb24oKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgTWVkaWFMb2FkZXJSZXN1bHQgPSBmdW5jdGlvbihjb250ZW50LCB1cmwsIGxvYWRlcikgewogICAgICAgIHRoaXMuY29udGVudCA9IGNvbnRlbnQsIHRoaXMudXJsID0gdXJsLCB0aGlzLmxvYWRlciA9IGxvYWRlcjsKICAgIH0sIHAgPSBNZWRpYUxvYWRlclJlc3VsdC5wcm90b3R5cGU7CiAgICBwLmNvbnRlbnQgPSBudWxsLCBwLnVybCA9IG51bGwsIHAubG9hZGVyID0gbnVsbCwgcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAiW01lZGlhTG9hZGVyUmVzdWx0KCciICsgdGhpcy51cmwgKyAiJyldIjsKICAgIH0sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuY2FsbGJhY2sgPSBudWxsLCB0aGlzLnVybCA9IG51bGwsIHRoaXMuY29udGVudCA9IG51bGw7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuTWVkaWFMb2FkZXJSZXN1bHQgPSBNZWRpYUxvYWRlclJlc3VsdDsKfSgpLCBmdW5jdGlvbih1bmRlZmluZWQpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBDYWNoZU1hbmFnZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmluaXRpYWxpemUoKTsKICAgIH0sIHAgPSBDYWNoZU1hbmFnZXIucHJvdG90eXBlID0ge307CiAgICBwLl92ZXJzaW9ucyA9IG51bGwsIHAuY2FjaGVCdXN0ID0gITEsIHAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuX3ZlcnNpb25zID0gW107CiAgICAgICAgdmFyIGNiID0gY2xvdWRraWQuT1MuaW5zdGFuY2Uub3B0aW9ucy5jYWNoZUJ1c3Q7CiAgICAgICAgdGhpcy5jYWNoZUJ1c3QgPSBjYiA/ICJ0cnVlIiA9PT0gY2IgfHwgY2IgPT09ICEwIDogITEsIHRoaXMuY2FjaGVCdXN0ICYmIERlYnVnLmxvZygiQ2FjaGVCdXN0IGFsbCBmaWxlcyBpcyBvbi4iKTsKICAgIH0sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuX3ZlcnNpb25zID0gbnVsbDsKICAgIH0sIHAuYWRkVmVyc2lvbnNGaWxlID0gZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgYmFzZVVybCkgewogICAgICAgIERlYnVnLmFzc2VydCgvXi4qXC50eHQkLy50ZXN0KHVybCksICJUaGUgdmVyc2lvbnMgZmlsZSBtdXN0IGJlIGEgKi50eHQgZmlsZSIpOwogICAgICAgIHZhciBtbCA9IGNsb3Vka2lkLk1lZGlhTG9hZGVyLmluc3RhbmNlOwogICAgICAgIGlmICh0aGlzLmNhY2hlQnVzdCkgcmV0dXJuIHZvaWQgKGNhbGxiYWNrICYmIGNhbGxiYWNrKCkpOwogICAgICAgIHRoaXMuYWRkVmVyc2lvbih1cmwsIE1hdGgucm91bmQoMWU1ICogTWF0aC5yYW5kb20oKSkpOwogICAgICAgIHZhciBjbSA9IHRoaXM7CiAgICAgICAgbWwubG9hZCh1cmwsIGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC5jb250ZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgaSwgcGFydHMsIGxpbmVzID0gcmVzdWx0LmNvbnRlbnQucmVwbGFjZSgvXHIvZywgIiIpLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSBsaW5lc1tpXSAmJiAocGFydHMgPSBsaW5lc1tpXS5zcGxpdCgiICIpLCAyID09IHBhcnRzLmxlbmd0aCAmJiBjbS5hZGRWZXJzaW9uKChiYXNlVXJsIHx8ICIiKSArIHBhcnRzWzBdLCBwYXJ0c1sxXSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKCk7CiAgICAgICAgfSk7CiAgICB9LCBwLmFkZFZlcnNpb24gPSBmdW5jdGlvbih1cmwsIHZlcnNpb24pIHsKICAgICAgICB2YXIgdmVyID0gdGhpcy5fZ2V0VmVyc2lvbkJ5VXJsKHVybCk7CiAgICAgICAgdmVyIHx8IHRoaXMuX3ZlcnNpb25zLnB1c2goewogICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgdmVyc2lvbjogdmVyc2lvbgogICAgICAgIH0pOwogICAgfSwgcC5fZ2V0VmVyc2lvbkJ5VXJsID0gZnVuY3Rpb24odXJsKSB7CiAgICAgICAgdmFyIGksIGxlbiA9IHRoaXMuX3ZlcnNpb25zLmxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwOyBsZW4gPiBpOyBpKyspIGlmICh1cmwgPT0gdGhpcy5fdmVyc2lvbnNbaV0udXJsKSByZXR1cm4gdGhpcy5fdmVyc2lvbnNbaV07CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LCBwLnByZXBhcmUgPSBmdW5jdGlvbih1cmwsIGFwcGx5QmFzZVBhdGgpIHsKICAgICAgICB2YXIgdmVyID0gdGhpcy5fZ2V0VmVyc2lvbkJ5VXJsKHVybCk7CiAgICAgICAgaWYgKHRoaXMuY2FjaGVCdXN0ICYmIC8oXD98XCYpY2JcPVswLTldKi8udGVzdCh1cmwpID09PSAhMSA/ICh0aGlzLl9jYlZhbCB8fCAodGhpcy5fY2JWYWwgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKS50b1N0cmluZygpKSwgCiAgICAgICAgdXJsID0gdXJsICsgKHVybC5pbmRleE9mKCI/IikgPCAwID8gIj8iIDogIiYiKSArICJjYj0iICsgdGhpcy5fY2JWYWwpIDogdmVyICYmIC8oXD98XCYpdlw9WzAtOV0qLy50ZXN0KHVybCkgPT09ICExICYmICh1cmwgPSB1cmwgKyAodXJsLmluZGV4T2YoIj8iKSA8IDAgPyAiPyIgOiAiJiIpICsgInY9IiArIHZlci52ZXJzaW9uKSwgCiAgICAgICAgYXBwbHlCYXNlUGF0aCkgewogICAgICAgICAgICB2YXIgYmFzZVBhdGggPSBjbG91ZGtpZC5PUy5pbnN0YW5jZS5vcHRpb25zLmJhc2VQYXRoOwogICAgICAgICAgICAvXmh0dHAocyk/XDovLnRlc3QodXJsKSA9PT0gITEgJiYgYmFzZVBhdGggIT09IHVuZGVmaW5lZCAmJiAtMSA9PSB1cmwuc2VhcmNoKGJhc2VQYXRoKSAmJiAodXJsID0gYmFzZVBhdGggKyB1cmwpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdXJsOwogICAgfSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLkNhY2hlTWFuYWdlciA9IENhY2hlTWFuYWdlcjsKfSgpLCBmdW5jdGlvbih1bmRlZmluZWQpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGZ1bmN0aW9uIGNsb25lKG9iaikgewogICAgICAgIGlmICghb2JqIHx8ICJvYmplY3QiICE9IHR5cGVvZiBvYmopIHJldHVybiBudWxsOwogICAgICAgIHZhciBjb3B5ID0gb2JqLmNvbnN0cnVjdG9yKCk7CiAgICAgICAgZm9yICh2YXIgYXR0ciBpbiBvYmopIG9iai5oYXNPd25Qcm9wZXJ0eShhdHRyKSAmJiAoY29weVthdHRyXSA9IG9ialthdHRyXSk7CiAgICAgICAgcmV0dXJuIGNvcHk7CiAgICB9CiAgICB2YXIgQnV0dG9uID0gZnVuY3Rpb24oaW1hZ2VTZXR0aW5ncywgbGFiZWwsIGVuYWJsZWQpIHsKICAgICAgICBpbWFnZVNldHRpbmdzICYmIHRoaXMuaW5pdGlhbGl6ZShpbWFnZVNldHRpbmdzLCBsYWJlbCwgZW5hYmxlZCk7CiAgICB9LCBwID0gQnV0dG9uLnByb3RvdHlwZSA9IG5ldyBjcmVhdGVqcy5Db250YWluZXIoKSwgcyA9IGNyZWF0ZWpzLkNvbnRhaW5lci5wcm90b3R5cGU7CiAgICBwLmJhY2sgPSBudWxsLCBwLmxhYmVsID0gbnVsbCwgcC5fb3ZlckNCID0gbnVsbCwgcC5fb3V0Q0IgPSBudWxsLCBwLl9kb3duQ0IgPSBudWxsLCAKICAgIHAuX3VwQ0IgPSBudWxsLCBwLl9jbGlja0NCID0gbnVsbCwgcC5fc3RhdGVGbGFncyA9IG51bGwsIHAuX3N0YXRlUHJpb3JpdHkgPSBudWxsLCAKICAgIHAuX3N0YXRlRGF0YSA9IG51bGwsIHAuX3dpZHRoID0gMCwgcC5faGVpZ2h0ID0gMCwgcC5fb2Zmc2V0ID0gbnVsbCwgQnV0dG9uLkJVVFRPTl9QUkVTUyA9ICJidXR0b25QcmVzcyI7CiAgICB2YXIgUkVTRVJWRURfU1RBVEVTID0gWyAiZGlzYWJsZWQiLCAiZW5hYmxlZCIsICJ1cCIsICJvdmVyIiwgImRvd24iIF0sIERFRkFVTFRfUFJJT1JJVFkgPSBbICJkaXNhYmxlZCIsICJkb3duIiwgIm92ZXIiLCAidXAiIF07CiAgICBwLmluaXRpYWxpemUgPSBmdW5jdGlvbihpbWFnZVNldHRpbmdzLCBsYWJlbCwgZW5hYmxlZCkgewogICAgICAgIHMuaW5pdGlhbGl6ZS5jYWxsKHRoaXMpLCB0aGlzLm1vdXNlQ2hpbGRyZW4gPSAhMSwgdGhpcy5fZG93bkNCID0gdGhpcy5fb25Nb3VzZURvd24uYmluZCh0aGlzKSwgCiAgICAgICAgdGhpcy5fdXBDQiA9IHRoaXMuX29uTW91c2VVcC5iaW5kKHRoaXMpLCB0aGlzLl9vdmVyQ0IgPSB0aGlzLl9vbk1vdXNlT3Zlci5iaW5kKHRoaXMpLCAKICAgICAgICB0aGlzLl9vdXRDQiA9IHRoaXMuX29uTW91c2VPdXQuYmluZCh0aGlzKSwgdGhpcy5fY2xpY2tDQiA9IHRoaXMuX29uQ2xpY2suYmluZCh0aGlzKTsKICAgICAgICB2YXIgX3N0YXRlRGF0YSA9IHRoaXMuX3N0YXRlRGF0YSA9IHt9OwogICAgICAgIHRoaXMuX3N0YXRlRmxhZ3MgPSB7fSwgdGhpcy5fb2Zmc2V0ID0gbmV3IGNyZWF0ZWpzLlBvaW50KCk7CiAgICAgICAgdmFyIGxhYmVsRGF0YTsKICAgICAgICBsYWJlbCAmJiAobGFiZWxEYXRhID0gY2xvbmUobGFiZWwpLCBkZWxldGUgbGFiZWxEYXRhLnRleHQsIGxhYmVsRGF0YS54ID09PSB1bmRlZmluZWQgJiYgKGxhYmVsRGF0YS54ID0gImNlbnRlciIpLCAKICAgICAgICBsYWJlbERhdGEueSA9PT0gdW5kZWZpbmVkICYmIChsYWJlbERhdGEueSA9ICJjZW50ZXIiKSk7CiAgICAgICAgdmFyIGltYWdlLCB3aWR0aCwgaGVpZ2h0LCBpLCBzdGF0ZTsKICAgICAgICBpZiAoaW1hZ2VTZXR0aW5ncy5pbWFnZSkgewogICAgICAgICAgICBmb3IgKGltYWdlID0gaW1hZ2VTZXR0aW5ncy5pbWFnZSwgdGhpcy5fc3RhdGVQcmlvcml0eSA9IGltYWdlU2V0dGluZ3MucHJpb3JpdHkgfHwgREVGQVVMVF9QUklPUklUWSwgCiAgICAgICAgICAgIGkgPSB0aGlzLl9zdGF0ZVByaW9yaXR5Lmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICAgICAgICBzdGF0ZSA9IHRoaXMuX3N0YXRlUHJpb3JpdHlbaV0sIHRoaXMuX2FkZFByb3BlcnR5KHN0YXRlKSwgImRpc2FibGVkIiAhPSBzdGF0ZSAmJiAidXAiICE9IHN0YXRlICYmICh0aGlzLl9zdGF0ZUZsYWdzW3N0YXRlXSA9ICExKTsKICAgICAgICAgICAgICAgIHZhciBpbnB1dERhdGEgPSBpbWFnZVNldHRpbmdzW3N0YXRlXTsKICAgICAgICAgICAgICAgIGlmIChfc3RhdGVEYXRhW3N0YXRlXSA9IGlucHV0RGF0YSA/IGNsb25lKGlucHV0RGF0YSkgOiBfc3RhdGVEYXRhLnVwLCBsYWJlbCkgaWYgKGlucHV0RGF0YSAmJiBpbnB1dERhdGEubGFiZWwpIHsKICAgICAgICAgICAgICAgICAgICBpbnB1dERhdGEgPSBpbnB1dERhdGEubGFiZWw7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlTGFiZWwgPSBfc3RhdGVEYXRhW3N0YXRlXS5sYWJlbCA9IHt9OwogICAgICAgICAgICAgICAgICAgIHN0YXRlTGFiZWwuZm9udCA9IGlucHV0RGF0YS5mb250IHx8IGxhYmVsRGF0YS5mb250LCBzdGF0ZUxhYmVsLmNvbG9yID0gaW5wdXREYXRhLmNvbG9yIHx8IGxhYmVsRGF0YS5jb2xvciwgCiAgICAgICAgICAgICAgICAgICAgc3RhdGVMYWJlbC5zdHJva2UgPSBpbnB1dERhdGEuaGFzT3duUHJvcGVydHkoInN0cm9rZSIpID8gaW5wdXREYXRhLnN0cm9rZSA6IGxhYmVsRGF0YS5zdHJva2UsIAogICAgICAgICAgICAgICAgICAgIHN0YXRlTGFiZWwuc2hhZG93ID0gaW5wdXREYXRhLmhhc093blByb3BlcnR5KCJzaGFkb3ciKSA/IGlucHV0RGF0YS5zaGFkb3cgOiBsYWJlbERhdGEuc2hhZG93LCAKICAgICAgICAgICAgICAgICAgICBzdGF0ZUxhYmVsLnRleHRCYXNlbGluZSA9IGlucHV0RGF0YS50ZXh0QmFzZWxpbmUgfHwgbGFiZWxEYXRhLnRleHRCYXNlbGluZSwgc3RhdGVMYWJlbC54ID0gaW5wdXREYXRhLnggfHwgbGFiZWxEYXRhLngsIAogICAgICAgICAgICAgICAgICAgIHN0YXRlTGFiZWwueSA9IGlucHV0RGF0YS55IHx8IGxhYmVsRGF0YS55OwogICAgICAgICAgICAgICAgfSBlbHNlIF9zdGF0ZURhdGFbc3RhdGVdLmxhYmVsID0gbGFiZWxEYXRhOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChfc3RhdGVEYXRhLnVwLnRyaW0pIHsKICAgICAgICAgICAgICAgIHZhciB1cFRyaW0gPSBfc3RhdGVEYXRhLnVwLnRyaW07CiAgICAgICAgICAgICAgICB3aWR0aCA9IHVwVHJpbS53aWR0aCwgaGVpZ2h0ID0gdXBUcmltLmhlaWdodDsKICAgICAgICAgICAgfSBlbHNlIHdpZHRoID0gX3N0YXRlRGF0YS51cC5zcmMud2lkdGgsIGhlaWdodCA9IF9zdGF0ZURhdGEudXAuc3JjLmhlaWdodDsKICAgICAgICAgICAgX3N0YXRlRGF0YS51cCB8fCAoRGVidWcuZXJyb3IoIkJ1dHRvbiBsYWNrcyBhbiB1cCBzdGF0ZSEgVGhpcyBpcyBhIHNlcmlvdXMgcHJvYmxlbSEgSW5wdXQgZGF0YSBmb2xsb3dzOiIpLCAKICAgICAgICAgICAgRGVidWcuZXJyb3IoaW1hZ2VTZXR0aW5ncykpLCBfc3RhdGVEYXRhLm92ZXIgfHwgKF9zdGF0ZURhdGEub3ZlciA9IF9zdGF0ZURhdGEudXApLCAKICAgICAgICAgICAgX3N0YXRlRGF0YS5kb3duIHx8IChfc3RhdGVEYXRhLmRvd24gPSBfc3RhdGVEYXRhLnVwKSwgX3N0YXRlRGF0YS5kaXNhYmxlZCB8fCAoX3N0YXRlRGF0YS5kaXNhYmxlZCA9IF9zdGF0ZURhdGEudXApLCAKICAgICAgICAgICAgaW1hZ2VTZXR0aW5ncy5vZmZzZXQgPyAodGhpcy5fb2Zmc2V0LnggPSBpbWFnZVNldHRpbmdzLm9mZnNldC54LCB0aGlzLl9vZmZzZXQueSA9IGltYWdlU2V0dGluZ3Mub2Zmc2V0LnkpIDogdGhpcy5fb2Zmc2V0LnggPSB0aGlzLl9vZmZzZXQueSA9IDA7CiAgICAgICAgfSBlbHNlIGltYWdlID0gaW1hZ2VTZXR0aW5ncywgd2lkdGggPSBpbWFnZS53aWR0aCwgaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0IC8gMywgdGhpcy5fc3RhdGVQcmlvcml0eSA9IERFRkFVTFRfUFJJT1JJVFksIAogICAgICAgIF9zdGF0ZURhdGEuZGlzYWJsZWQgPSBfc3RhdGVEYXRhLnVwID0gewogICAgICAgICAgICBzcmM6IG5ldyBjcmVhdGVqcy5SZWN0YW5nbGUoMCwgMCwgd2lkdGgsIGhlaWdodCkKICAgICAgICB9LCBfc3RhdGVEYXRhLm92ZXIgPSB7CiAgICAgICAgICAgIHNyYzogbmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCBoZWlnaHQsIHdpZHRoLCBoZWlnaHQpCiAgICAgICAgfSwgX3N0YXRlRGF0YS5kb3duID0gewogICAgICAgICAgICBzcmM6IG5ldyBjcmVhdGVqcy5SZWN0YW5nbGUoMCwgMiAqIGhlaWdodCwgd2lkdGgsIGhlaWdodCkKICAgICAgICB9LCBsYWJlbERhdGEgJiYgKF9zdGF0ZURhdGEudXAubGFiZWwgPSBfc3RhdGVEYXRhLm92ZXIubGFiZWwgPSBfc3RhdGVEYXRhLmRvd24ubGFiZWwgPSBfc3RhdGVEYXRhLmRpc2FibGVkLmxhYmVsID0gbGFiZWxEYXRhKSwgCiAgICAgICAgdGhpcy5fb2Zmc2V0LnggPSB0aGlzLl9vZmZzZXQueSA9IDA7CiAgICAgICAgdGhpcy5iYWNrID0gbmV3IGNyZWF0ZWpzLkJpdG1hcChpbWFnZSksIHRoaXMuYWRkQ2hpbGQodGhpcy5iYWNrKSwgdGhpcy5fd2lkdGggPSB3aWR0aCwgCiAgICAgICAgdGhpcy5faGVpZ2h0ID0gaGVpZ2h0LCBsYWJlbCAmJiAodGhpcy5sYWJlbCA9IG5ldyBjcmVhdGVqcy5UZXh0KGxhYmVsLnRleHQgfHwgIiIsIF9zdGF0ZURhdGEudXAubGFiZWwuZm9udCwgX3N0YXRlRGF0YS51cC5sYWJlbC5jb2xvciksIAogICAgICAgIHRoaXMuYWRkQ2hpbGQodGhpcy5sYWJlbCkpLCB0aGlzLmVuYWJsZWQgPSBlbmFibGVkID09PSB1bmRlZmluZWQgPyAhMCA6ICEhZW5hYmxlZDsKICAgIH0sIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAid2lkdGgiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dpZHRoICogdGhpcy5zY2FsZVg7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuc2NhbGVYID0gdmFsdWUgLyB0aGlzLl93aWR0aDsKICAgICAgICB9CiAgICB9KSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJoZWlnaHQiLCB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2hlaWdodCAqIHRoaXMuc2NhbGVZOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICB0aGlzLnNjYWxlWSA9IHZhbHVlIC8gdGhpcy5faGVpZ2h0OwogICAgICAgIH0KICAgIH0pLCBwLnNldFRleHQgPSBmdW5jdGlvbih0ZXh0KSB7CiAgICAgICAgaWYgKHRoaXMubGFiZWwpIHsKICAgICAgICAgICAgdGhpcy5sYWJlbC50ZXh0ID0gdGV4dDsKICAgICAgICAgICAgZm9yICh2YXIgZGF0YSwgaSA9IDA7IGkgPCB0aGlzLl9zdGF0ZVByaW9yaXR5Lmxlbmd0aDsgKytpKSBpZiAodGhpcy5fc3RhdGVGbGFnc1t0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXSkgewogICAgICAgICAgICAgICAgZGF0YSA9IHRoaXMuX3N0YXRlRGF0YVt0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRhdGEgfHwgKGRhdGEgPSB0aGlzLl9zdGF0ZURhdGEudXApLCBkYXRhID0gZGF0YS5sYWJlbCwgdGhpcy5sYWJlbC54ID0gImNlbnRlciIgPT0gZGF0YS54ID8gLjUgKiAodGhpcy5fd2lkdGggLSB0aGlzLmxhYmVsLmdldE1lYXN1cmVkV2lkdGgoKSkgKyB0aGlzLl9vZmZzZXQueCA6IGRhdGEueCArIHRoaXMuX29mZnNldC54LCAKICAgICAgICAgICAgdGhpcy5sYWJlbC55ID0gImNlbnRlciIgPT0gZGF0YS55ID8gLjUgKiB0aGlzLl9oZWlnaHQgKyB0aGlzLl9vZmZzZXQueSA6IGRhdGEueSArIHRoaXMuX29mZnNldC55OwogICAgICAgIH0KICAgIH0sIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAiZW5hYmxlZCIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIXRoaXMuX3N0YXRlRmxhZ3MuZGlzYWJsZWQ7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuX3N0YXRlRmxhZ3MuZGlzYWJsZWQgPSAhdmFsdWUsIHZhbHVlID8gKHRoaXMuY3Vyc29yID0gInBvaW50ZXIiLCB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIHRoaXMuX2Rvd25DQiksIAogICAgICAgICAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlb3ZlciIsIHRoaXMuX292ZXJDQiksIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcigibW91c2VvdXQiLCB0aGlzLl9vdXRDQikpIDogKHRoaXMuY3Vyc29yID0gbnVsbCwgCiAgICAgICAgICAgIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgdGhpcy5fZG93bkNCKSwgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZW92ZXIiLCB0aGlzLl9vdmVyQ0IpLCAKICAgICAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZW91dCIsIHRoaXMuX291dENCKSwgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCJwcmVzc3VwIiwgdGhpcy5fdXBDQiksIAogICAgICAgICAgICB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoImNsaWNrIiwgdGhpcy5fY2xpY2tDQiksIHRoaXMuX3N0YXRlRmxhZ3MuZG93biA9IHRoaXMuX3N0YXRlRmxhZ3Mub3ZlciA9ICExKSwgCiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlKCk7CiAgICAgICAgfQogICAgfSksIHAuX2FkZFByb3BlcnR5ID0gZnVuY3Rpb24ocHJvcGVydHlOYW1lKSB7CiAgICAgICAgUkVTRVJWRURfU1RBVEVTLmluZGV4T2YocHJvcGVydHlOYW1lKSA+PSAwIHx8IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdGF0ZUZsYWdzW3Byb3BlcnR5TmFtZV07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXRlRmxhZ3NbcHJvcGVydHlOYW1lXSA9IHZhbHVlLCB0aGlzLl91cGRhdGVTdGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9LCBwLl91cGRhdGVTdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmJhY2spIHsKICAgICAgICAgICAgZm9yICh2YXIgZGF0YSwgaSA9IDA7IGkgPCB0aGlzLl9zdGF0ZVByaW9yaXR5Lmxlbmd0aDsgKytpKSBpZiAodGhpcy5fc3RhdGVGbGFnc1t0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXSkgewogICAgICAgICAgICAgICAgZGF0YSA9IHRoaXMuX3N0YXRlRGF0YVt0aGlzLl9zdGF0ZVByaW9yaXR5W2ldXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRhdGEgfHwgKGRhdGEgPSB0aGlzLl9zdGF0ZURhdGEudXApLCB0aGlzLmJhY2suc291cmNlUmVjdCA9IGRhdGEuc3JjLCBkYXRhLnRyaW0gPyAodGhpcy5iYWNrLnggPSBkYXRhLnRyaW0ueCArIHRoaXMuX29mZnNldC54LCAKICAgICAgICAgICAgdGhpcy5iYWNrLnkgPSBkYXRhLnRyaW0ueSArIHRoaXMuX29mZnNldC55KSA6ICh0aGlzLmJhY2sueCA9IHRoaXMuX29mZnNldC54LCB0aGlzLmJhY2sueSA9IHRoaXMuX29mZnNldC55KSwgCiAgICAgICAgICAgIHRoaXMubGFiZWwgJiYgKGRhdGEgPSBkYXRhLmxhYmVsLCB0aGlzLmxhYmVsLnRleHRCYXNlbGluZSA9IGRhdGEudGV4dEJhc2VsaW5lIHx8ICJtaWRkbGUiLCAKICAgICAgICAgICAgdGhpcy5sYWJlbC5zdHJva2UgPSBkYXRhLnN0cm9rZSwgdGhpcy5sYWJlbC5zaGFkb3cgPSBkYXRhLnNoYWRvdywgdGhpcy5sYWJlbC5mb250ID0gZGF0YS5mb250LCAKICAgICAgICAgICAgdGhpcy5sYWJlbC5jb2xvciA9IGRhdGEuY29sb3IgfHwgIiMwMDAiLCB0aGlzLmxhYmVsLnggPSAiY2VudGVyIiA9PSBkYXRhLnggPyAuNSAqICh0aGlzLl93aWR0aCAtIHRoaXMubGFiZWwuZ2V0TWVhc3VyZWRXaWR0aCgpKSArIHRoaXMuX29mZnNldC54IDogZGF0YS54ICsgdGhpcy5fb2Zmc2V0LngsIAogICAgICAgICAgICB0aGlzLmxhYmVsLnkgPSAiY2VudGVyIiA9PSBkYXRhLnkgPyAuNSAqIHRoaXMuX2hlaWdodCArIHRoaXMuX29mZnNldC55IDogZGF0YS55ICsgdGhpcy5fb2Zmc2V0LnkpOwogICAgICAgIH0KICAgIH0sIHAuX29uTW91c2VEb3duID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5hZGRFdmVudExpc3RlbmVyKCJwcmVzc3VwIiwgdGhpcy5fdXBDQiksIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCB0aGlzLl9jbGlja0NCKSwgCiAgICAgICAgdGhpcy5fc3RhdGVGbGFncy5kb3duID0gITAsIHRoaXMuX3VwZGF0ZVN0YXRlKCk7CiAgICB9LCBwLl9vbk1vdXNlVXAgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIoInByZXNzdXAiLCB0aGlzLl91cENCKSwgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCJjbGljayIsIHRoaXMuX2NsaWNrQ0IpLCAKICAgICAgICB0aGlzLl9zdGF0ZUZsYWdzLmRvd24gPSAhMSwgdGhpcy5fdXBkYXRlU3RhdGUoKTsKICAgIH0sIHAuX29uQ2xpY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmRpc3BhdGNoRXZlbnQobmV3IGNyZWF0ZWpzLkV2ZW50KEJ1dHRvbi5CVVRUT05fUFJFU1MpKTsKICAgIH0sIHAuX29uTW91c2VPdmVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fc3RhdGVGbGFncy5vdmVyID0gITAsIHRoaXMuX3VwZGF0ZVN0YXRlKCk7CiAgICB9LCBwLl9vbk1vdXNlT3V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fc3RhdGVGbGFncy5vdmVyID0gITEsIHRoaXMuX3VwZGF0ZVN0YXRlKCk7CiAgICB9LCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLnJlbW92ZUFsbENoaWxkcmVuKCksIHRoaXMucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMoKSwgdGhpcy5fZG93bkNCID0gbnVsbCwgdGhpcy5fdXBDQiA9IG51bGwsIAogICAgICAgIHRoaXMuX292ZXJDQiA9IG51bGwsIHRoaXMuX291dENCID0gbnVsbCwgdGhpcy5iYWNrID0gbnVsbCwgdGhpcy5sYWJlbCA9IG51bGwsIHRoaXMuX3N0YXRlUHJpb3JpdHkgPSBudWxsLCAKICAgICAgICB0aGlzLl9zdGF0ZUZsYWdzID0gbnVsbCwgdGhpcy5fc3RhdGVEYXRhID0gbnVsbDsKICAgIH0sIEJ1dHRvbi5nZW5lcmF0ZURlZmF1bHRTdGF0ZXMgPSBmdW5jdGlvbihpbWFnZSwgZGlzYWJsZWRTZXR0aW5ncywgaGlnaGxpZ2h0U2V0dGluZ3MpIHsKICAgICAgICB2YXIgYnV0dG9uV2lkdGggPSBpbWFnZS53aWR0aCwgYnV0dG9uSGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0IC8gMywgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIiksIHdpZHRoID0gYnV0dG9uV2lkdGgsIGhlaWdodCA9IGltYWdlLmhlaWdodDsKICAgICAgICBkaXNhYmxlZFNldHRpbmdzICYmIChoZWlnaHQgKz0gYnV0dG9uSGVpZ2h0KSwgaGlnaGxpZ2h0U2V0dGluZ3MgJiYgKHdpZHRoICs9IDIgKiBoaWdobGlnaHRTZXR0aW5ncy5zaXplLCAKICAgICAgICBoZWlnaHQgKz0gYnV0dG9uSGVpZ2h0ICsgMiAqIGhpZ2hsaWdodFNldHRpbmdzLnNpemUpLCBjYW52YXMud2lkdGggPSB3aWR0aCwgY2FudmFzLmhlaWdodCA9IGhlaWdodDsKICAgICAgICB2YXIgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgICAgIGNvbnRleHQuZHJhd0ltYWdlKGltYWdlLCAwLCAwKTsKICAgICAgICB2YXIgb3V0cHV0ID0gewogICAgICAgICAgICBpbWFnZTogY2FudmFzLAogICAgICAgICAgICB1cDogewogICAgICAgICAgICAgICAgc3JjOiBuZXcgY3JlYXRlanMuUmVjdGFuZ2xlKDAsIDAsIGJ1dHRvbldpZHRoLCBidXR0b25IZWlnaHQpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG92ZXI6IHsKICAgICAgICAgICAgICAgIHNyYzogbmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCBidXR0b25IZWlnaHQsIGJ1dHRvbldpZHRoLCBidXR0b25IZWlnaHQpCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRvd246IHsKICAgICAgICAgICAgICAgIHNyYzogbmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCAyICogYnV0dG9uSGVpZ2h0LCBidXR0b25XaWR0aCwgYnV0dG9uSGVpZ2h0KQogICAgICAgICAgICB9CiAgICAgICAgfSwgZHJhd2luZ0JpdG1hcCA9IG5ldyBjcmVhdGVqcy5CaXRtYXAoaW1hZ2UpOwogICAgICAgIGRyYXdpbmdCaXRtYXAuc291cmNlUmVjdCA9IG91dHB1dC51cC5zcmM7CiAgICAgICAgdmFyIG5leHRZID0gaW1hZ2UuaGVpZ2h0OwogICAgICAgIGlmIChkaXNhYmxlZFNldHRpbmdzKSB7CiAgICAgICAgICAgIGNvbnRleHQuc2F2ZSgpLCBjb250ZXh0LnRyYW5zbGF0ZSgwLCBuZXh0WSk7CiAgICAgICAgICAgIHZhciBtYXRyaXggPSBuZXcgY3JlYXRlanMuQ29sb3JNYXRyaXgoKTsKICAgICAgICAgICAgZGlzYWJsZWRTZXR0aW5ncy5zYXR1cmF0aW9uICE9PSB1bmRlZmluZWQgJiYgbWF0cml4LmFkanVzdFNhdHVyYXRpb24oZGlzYWJsZWRTZXR0aW5ncy5zYXR1cmF0aW9uKSwgCiAgICAgICAgICAgIGRpc2FibGVkU2V0dGluZ3MuYnJpZ2h0bmVzcyAhPT0gdW5kZWZpbmVkICYmIG1hdHJpeC5hZGp1c3RCcmlnaHRuZXNzKDIuNTUgKiBkaXNhYmxlZFNldHRpbmdzLmJyaWdodG5lc3MpLCAKICAgICAgICAgICAgZGlzYWJsZWRTZXR0aW5ncy5jb250cmFzdCAhPT0gdW5kZWZpbmVkICYmIG1hdHJpeC5hZGp1c3RDb250cmFzdChkaXNhYmxlZFNldHRpbmdzLmNvbnRyYXN0KSwgCiAgICAgICAgICAgIGRyYXdpbmdCaXRtYXAuZmlsdGVycyA9IFsgbmV3IGNyZWF0ZWpzLkNvbG9yTWF0cml4RmlsdGVyKG1hdHJpeCkgXSwgZHJhd2luZ0JpdG1hcC5jYWNoZSgwLCAwLCBvdXRwdXQudXAuc3JjLndpZHRoLCBvdXRwdXQudXAuc3JjLmhlaWdodCksIAogICAgICAgICAgICBkcmF3aW5nQml0bWFwLmRyYXcoY29udGV4dCksIG91dHB1dC5kaXNhYmxlZCA9IHsKICAgICAgICAgICAgICAgIHNyYzogbmV3IGNyZWF0ZWpzLlJlY3RhbmdsZSgwLCBuZXh0WSwgYnV0dG9uV2lkdGgsIDAgfCBidXR0b25IZWlnaHQpCiAgICAgICAgICAgIH0sIG5leHRZICs9IGJ1dHRvbkhlaWdodCwgY29udGV4dC5yZXN0b3JlKCk7CiAgICAgICAgfQogICAgICAgIGlmIChoaWdobGlnaHRTZXR0aW5ncykgewogICAgICAgICAgICBjb250ZXh0LnNhdmUoKTsKICAgICAgICAgICAgdmFyIGhpZ2hsaWdodFN0YXRlV2lkdGggPSBidXR0b25XaWR0aCArIDIgKiBoaWdobGlnaHRTZXR0aW5ncy5zaXplLCBoaWdobGlnaHRTdGF0ZUhlaWdodCA9IGJ1dHRvbkhlaWdodCArIDIgKiBoaWdobGlnaHRTZXR0aW5ncy5zaXplOwogICAgICAgICAgICBkcmF3aW5nQml0bWFwLmZpbHRlcnMgPSBbIG5ldyBjcmVhdGVqcy5Db2xvckZpbHRlcigwLCAwLCAwLCAxLCBoaWdobGlnaHRTZXR0aW5ncy5yZWQsIGhpZ2hsaWdodFNldHRpbmdzLmdyZWVuLCBoaWdobGlnaHRTZXR0aW5ncy5ibHVlLCBoaWdobGlnaHRTZXR0aW5ncy5hbHBoYSAhPT0gdW5kZWZpbmVkID8gLTI1NSArIGhpZ2hsaWdodFNldHRpbmdzLmFscGhhIDogMCkgXSwgCiAgICAgICAgICAgIGRyYXdpbmdCaXRtYXAuc2NhbGVYID0gaGlnaGxpZ2h0U3RhdGVXaWR0aCAvIGJ1dHRvbldpZHRoLCBkcmF3aW5nQml0bWFwLnNjYWxlWSA9IGhpZ2hsaWdodFN0YXRlSGVpZ2h0IC8gYnV0dG9uSGVpZ2h0LCAKICAgICAgICAgICAgZHJhd2luZ0JpdG1hcC54ID0gMCwgZHJhd2luZ0JpdG1hcC55ID0gbmV4dFksIGRyYXdpbmdCaXRtYXAuY2FjaGUoMCwgMCwgaGlnaGxpZ2h0U3RhdGVXaWR0aCwgaGlnaGxpZ2h0U3RhdGVIZWlnaHQpLCAKICAgICAgICAgICAgZHJhd2luZ0JpdG1hcC51cGRhdGVDb250ZXh0KGNvbnRleHQpLCBkcmF3aW5nQml0bWFwLmRyYXcoY29udGV4dCksIGNvbnRleHQucmVzdG9yZSgpLCAKICAgICAgICAgICAgZHJhd2luZ0JpdG1hcC5zY2FsZVggPSBkcmF3aW5nQml0bWFwLnNjYWxlWSA9IDEsIGRyYXdpbmdCaXRtYXAueCA9IGhpZ2hsaWdodFNldHRpbmdzLnNpemUsIAogICAgICAgICAgICBkcmF3aW5nQml0bWFwLnkgPSBuZXh0WSArIGhpZ2hsaWdodFNldHRpbmdzLnNpemUsIGRyYXdpbmdCaXRtYXAuZmlsdGVycyA9IG51bGwsIAogICAgICAgICAgICBkcmF3aW5nQml0bWFwLnVuY2FjaGUoKSwgZHJhd2luZ0JpdG1hcC51cGRhdGVDb250ZXh0KGNvbnRleHQpLCBkcmF3aW5nQml0bWFwLmRyYXcoY29udGV4dCk7CiAgICAgICAgICAgIHZhciB0cmltID0gbmV3IGNyZWF0ZWpzLlJlY3RhbmdsZShoaWdobGlnaHRTZXR0aW5ncy5zaXplLCBoaWdobGlnaHRTZXR0aW5ncy5zaXplLCBoaWdobGlnaHRTdGF0ZVdpZHRoLCBoaWdobGlnaHRTdGF0ZUhlaWdodCk7CiAgICAgICAgICAgIG91dHB1dC51cC50cmltID0gdHJpbSwgb3V0cHV0Lm92ZXIudHJpbSA9IHRyaW0sIG91dHB1dC5kb3duLnRyaW0gPSB0cmltLCBvdXRwdXQuZGlzYWJsZWQgJiYgKG91dHB1dC5kaXNhYmxlZC50cmltID0gdHJpbSksIAogICAgICAgICAgICBvdXRwdXQuaGlnaGxpZ2h0ZWQgPSB7CiAgICAgICAgICAgICAgICBzcmM6IG5ldyBjcmVhdGVqcy5SZWN0YW5nbGUoMCwgbmV4dFksIDAgfCBoaWdobGlnaHRTdGF0ZVdpZHRoLCAwIHwgaGlnaGxpZ2h0U3RhdGVIZWlnaHQpCiAgICAgICAgICAgIH0sIG91dHB1dC5wcmlvcml0eSA9IERFRkFVTFRfUFJJT1JJVFkuc2xpY2UoKSwgb3V0cHV0LnByaW9yaXR5LnVuc2hpZnQoImhpZ2hsaWdodGVkIiksIAogICAgICAgICAgICBvdXRwdXQub2Zmc2V0ID0gewogICAgICAgICAgICAgICAgeDogLWhpZ2hsaWdodFNldHRpbmdzLnNpemUsCiAgICAgICAgICAgICAgICB5OiAtaGlnaGxpZ2h0U2V0dGluZ3Muc2l6ZQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgfSwgbmFtZXNwYWNlKCJjbG91ZGtpZCIpLkJ1dHRvbiA9IEJ1dHRvbjsKfSgpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBEcmFnTWFuYWdlciA9IGZ1bmN0aW9uKHN0YXJ0Q2FsbGJhY2ssIGVuZENhbGxiYWNrKSB7CiAgICAgICAgdGhpcy5pbml0aWFsaXplKHN0YXJ0Q2FsbGJhY2ssIGVuZENhbGxiYWNrKTsKICAgIH0sIHAgPSBEcmFnTWFuYWdlci5wcm90b3R5cGUgPSB7fTsKICAgIHAuZHJhZ2dlZE9iaiA9IG51bGwsIHAuZHJhZ1N0YXJ0VGhyZXNob2xkID0gMjAsIHAubW91c2VEb3duU3RhZ2VQb3MgPSBudWxsLCBwLm1vdXNlRG93bk9ialBvcyA9IG51bGwsIAogICAgcC5hbGxvd1N0aWNreUNsaWNrID0gITAsIHAuaXNUb3VjaE1vdmUgPSAhMSwgcC5pc0hlbGREcmFnID0gITEsIHAuaXNTdGlja3lDbGljayA9ICExLCAKICAgIHAuc25hcFNldHRpbmdzID0gbnVsbCwgcC5fdGhlU3RhZ2UgPSBudWxsLCBwLl9kcmFnT2Zmc2V0ID0gbnVsbCwgcC5fZHJhZ1N0YXJ0Q2FsbGJhY2sgPSBudWxsLCAKICAgIHAuX2RyYWdFbmRDYWxsYmFjayA9IG51bGwsIHAuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrID0gbnVsbCwgcC5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2sgPSBudWxsLCAKICAgIHAuX3N0YWdlTW91c2VVcENhbGxiYWNrID0gbnVsbCwgcC5fZHJhZ2dhYmxlT2JqZWN0cyA9IG51bGwsIHAuX3VwZGF0ZUNhbGxiYWNrID0gbnVsbCwgCiAgICBwLl9oZWxwZXJQb2ludCA9IG51bGwsIHAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKHN0YXJ0Q2FsbGJhY2ssIGVuZENhbGxiYWNrKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlQ2FsbGJhY2sgPSB0aGlzLl91cGRhdGVPYmpQb3NpdGlvbi5iaW5kKHRoaXMpLCB0aGlzLl90cmlnZ2VySGVsZERyYWdDYWxsYmFjayA9IHRoaXMuX3RyaWdnZXJIZWxkRHJhZy5iaW5kKHRoaXMpLCAKICAgICAgICB0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjayA9IHRoaXMuX3RyaWdnZXJTdGlja3lDbGljay5iaW5kKHRoaXMpLCB0aGlzLl9zdGFnZU1vdXNlVXBDYWxsYmFjayA9IHRoaXMuX3N0b3BEcmFnLmJpbmQodGhpcyksIAogICAgICAgIHRoaXMuX3RoZVN0YWdlID0gY2xvdWRraWQuT1MuaW5zdGFuY2Uuc3RhZ2UsIHRoaXMuX2RyYWdTdGFydENhbGxiYWNrID0gc3RhcnRDYWxsYmFjaywgCiAgICAgICAgdGhpcy5fZHJhZ0VuZENhbGxiYWNrID0gZW5kQ2FsbGJhY2ssIHRoaXMuX2RyYWdnYWJsZU9iamVjdHMgPSBbXSwgdGhpcy5tb3VzZURvd25TdGFnZVBvcyA9IHsKICAgICAgICAgICAgeDogMCwKICAgICAgICAgICAgeTogMAogICAgICAgIH0sIHRoaXMubW91c2VEb3duT2JqUG9zID0gewogICAgICAgICAgICB4OiAwLAogICAgICAgICAgICB5OiAwCiAgICAgICAgfTsKICAgIH0sIHAuc3RhcnREcmFnID0gZnVuY3Rpb24ob2JqZWN0LCBldikgewogICAgICAgIHRoaXMuX29iak1vdXNlRG93bihldiwgb2JqZWN0KTsKICAgIH0sIHAuX29iak1vdXNlRG93biA9IGZ1bmN0aW9uKGV2LCBvYmopIHsKICAgICAgICBudWxsID09PSB0aGlzLmRyYWdnZWRPYmogJiYgKHRoaXMuZHJhZ2dlZE9iaiA9IG9iaiwgY3JlYXRlanMuVHdlZW4ucmVtb3ZlVHdlZW5zKG9iaiksIAogICAgICAgIHRoaXMuX2RyYWdPZmZzZXQgPSB0aGlzLmRyYWdnZWRPYmoucGFyZW50Lmdsb2JhbFRvTG9jYWwoZXYgPyBldi5zdGFnZVggOiAwLCBldiA/IGV2LnN0YWdlWSA6IDApLCAKICAgICAgICB0aGlzLl9kcmFnT2Zmc2V0LnggLT0gb2JqLngsIHRoaXMuX2RyYWdPZmZzZXQueSAtPSBvYmoueSwgdGhpcy5tb3VzZURvd25PYmpQb3MueCA9IG9iai54LCAKICAgICAgICB0aGlzLm1vdXNlRG93bk9ialBvcy55ID0gb2JqLnksIGV2ID8gKHRoaXMuX3RoZVN0YWdlLl9nZXRQb2ludGVyRGF0YShldi5wb2ludGVySUQpLnRhcmdldCA9IG9iaiwgCiAgICAgICAgdGhpcy5hbGxvd1N0aWNreUNsaWNrICYmICJ0b3VjaHN0YXJ0IiAhPSBldi5uYXRpdmVFdmVudC50eXBlID8gKHRoaXMubW91c2VEb3duU3RhZ2VQb3MueCA9IGV2LnN0YWdlWCwgCiAgICAgICAgdGhpcy5tb3VzZURvd25TdGFnZVBvcy55ID0gZXYuc3RhZ2VZLCBvYmouYWRkRXZlbnRMaXN0ZW5lcigicHJlc3Ntb3ZlIiwgdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2spLCAKICAgICAgICBvYmouYWRkRXZlbnRMaXN0ZW5lcigicHJlc3N1cCIsIHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrKSkgOiAodGhpcy5tb3VzZURvd25TdGFnZVBvcy54ID0gZXYuc3RhZ2VYLCAKICAgICAgICB0aGlzLm1vdXNlRG93blN0YWdlUG9zLnkgPSBldi5zdGFnZVksIHRoaXMuaXNUb3VjaE1vdmUgPSAidG91Y2hzdGFydCIgPT0gZXYubmF0aXZlRXZlbnQudHlwZSwgCiAgICAgICAgdGhpcy5pc0hlbGREcmFnID0gITAsIHRoaXMuX3N0YXJ0RHJhZygpKSkgOiAodGhpcy5pc0hlbGREcmFnID0gITAsIHRoaXMuX3N0YXJ0RHJhZygpKSk7CiAgICB9LCBwLl90cmlnZ2VyU3RpY2t5Q2xpY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmlzU3RpY2t5Q2xpY2sgPSAhMCwgdGhpcy5kcmFnZ2VkT2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIoInByZXNzbW92ZSIsIHRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrKSwgCiAgICAgICAgdGhpcy5kcmFnZ2VkT2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIoInByZXNzdXAiLCB0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjayksIAogICAgICAgIHRoaXMuX3N0YXJ0RHJhZygpOwogICAgfSwgcC5fdHJpZ2dlckhlbGREcmFnID0gZnVuY3Rpb24oZXYpIHsKICAgICAgICB2YXIgeERpZmYgPSBldi5zdGFnZVggLSB0aGlzLm1vdXNlRG93blN0YWdlUG9zLngsIHlEaWZmID0gZXYuc3RhZ2VZIC0gdGhpcy5tb3VzZURvd25TdGFnZVBvcy55OwogICAgICAgIHhEaWZmICogeERpZmYgKyB5RGlmZiAqIHlEaWZmID49IHRoaXMuZHJhZ1N0YXJ0VGhyZXNob2xkICogdGhpcy5kcmFnU3RhcnRUaHJlc2hvbGQgJiYgKHRoaXMuaXNIZWxkRHJhZyA9ICEwLCAKICAgICAgICB0aGlzLmRyYWdnZWRPYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3Ntb3ZlIiwgdGhpcy5fdHJpZ2dlckhlbGREcmFnQ2FsbGJhY2spLCAKICAgICAgICB0aGlzLmRyYWdnZWRPYmoucmVtb3ZlRXZlbnRMaXN0ZW5lcigicHJlc3N1cCIsIHRoaXMuX3RyaWdnZXJTdGlja3lDbGlja0NhbGxiYWNrKSwgCiAgICAgICAgdGhpcy5fc3RhcnREcmFnKCkpOwogICAgfSwgcC5fc3RhcnREcmFnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHN0YWdlID0gdGhpcy5fdGhlU3RhZ2U7CiAgICAgICAgc3RhZ2UucmVtb3ZlRXZlbnRMaXN0ZW5lcigic3RhZ2Vtb3VzZW1vdmUiLCB0aGlzLl91cGRhdGVDYWxsYmFjayksIHN0YWdlLmFkZEV2ZW50TGlzdGVuZXIoInN0YWdlbW91c2Vtb3ZlIiwgdGhpcy5fdXBkYXRlQ2FsbGJhY2spLCAKICAgICAgICBzdGFnZS5yZW1vdmVFdmVudExpc3RlbmVyKCJzdGFnZW1vdXNldXAiLCB0aGlzLl9zdGFnZU1vdXNlVXBDYWxsYmFjayksIHN0YWdlLmFkZEV2ZW50TGlzdGVuZXIoInN0YWdlbW91c2V1cCIsIHRoaXMuX3N0YWdlTW91c2VVcENhbGxiYWNrKSwgCiAgICAgICAgdGhpcy5fZHJhZ1N0YXJ0Q2FsbGJhY2sodGhpcy5kcmFnZ2VkT2JqKTsKICAgIH0sIHAuc3RvcERyYWcgPSBmdW5jdGlvbihkb0NhbGxiYWNrKSB7CiAgICAgICAgdGhpcy5fc3RvcERyYWcobnVsbCwgZG9DYWxsYmFjayA9PT0gITApOwogICAgfSwgcC5fc3RvcERyYWcgPSBmdW5jdGlvbihldiwgZG9DYWxsYmFjaykgewogICAgICAgIHZhciBvYmogPSB0aGlzLmRyYWdnZWRPYmo7CiAgICAgICAgb2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIoInByZXNzbW92ZSIsIHRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrKSwgb2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIoInByZXNzdXAiLCB0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjayksIAogICAgICAgIHRoaXMuX3RoZVN0YWdlLnJlbW92ZUV2ZW50TGlzdGVuZXIoInN0YWdlbW91c2Vtb3ZlIiwgdGhpcy5fdXBkYXRlQ2FsbGJhY2spLCB0aGlzLl90aGVTdGFnZS5yZW1vdmVFdmVudExpc3RlbmVyKCJzdGFnZW1vdXNldXAiLCB0aGlzLl9zdGFnZU1vdXNlVXBDYWxsYmFjayksIAogICAgICAgIHRoaXMuZHJhZ2dlZE9iaiA9IG51bGwsIHRoaXMuaXNUb3VjaE1vdmUgPSAhMSwgdGhpcy5pc1N0aWNreUNsaWNrID0gITEsIHRoaXMuaXNIZWxkTW92ZSA9ICExLCAKICAgICAgICBkb0NhbGxiYWNrICE9PSAhMSAmJiB0aGlzLl9kcmFnRW5kQ2FsbGJhY2sob2JqKTsKICAgIH0sIHAuX3VwZGF0ZU9ialBvc2l0aW9uID0gZnVuY3Rpb24oZSkgewogICAgICAgIGlmICh0aGlzLmlzVG91Y2hNb3ZlIHx8IHRoaXMuX3RoZVN0YWdlLm1vdXNlSW5Cb3VuZHMpIHsKICAgICAgICAgICAgdmFyIGRyYWdnZWRPYmogPSB0aGlzLmRyYWdnZWRPYmosIG1vdXNlUG9zID0gZHJhZ2dlZE9iai5wYXJlbnQuZ2xvYmFsVG9Mb2NhbChlLnN0YWdlWCwgZS5zdGFnZVksIHRoaXMuX2hlbHBlclBvaW50KSwgYm91bmRzID0gZHJhZ2dlZE9iai5fZHJhZ0JvdW5kczsKICAgICAgICAgICAgaWYgKGRyYWdnZWRPYmoueCA9IGNsYW1wKG1vdXNlUG9zLnggLSB0aGlzLl9kcmFnT2Zmc2V0LngsIGJvdW5kcy54LCBib3VuZHMucmlnaHQpLCAKICAgICAgICAgICAgZHJhZ2dlZE9iai55ID0gY2xhbXAobW91c2VQb3MueSAtIHRoaXMuX2RyYWdPZmZzZXQueSwgYm91bmRzLnksIGJvdW5kcy5ib3R0b20pLCAKICAgICAgICAgICAgdGhpcy5zbmFwU2V0dGluZ3MpIHN3aXRjaCAodGhpcy5zbmFwU2V0dGluZ3MubW9kZSkgewogICAgICAgICAgICAgIGNhc2UgInBvaW50cyI6CiAgICAgICAgICAgICAgICB0aGlzLl9oYW5kbGVQb2ludFNuYXAobW91c2VQb3MpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgImdyaWQiOgogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgIGNhc2UgImxpbmUiOiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LCBwLl9oYW5kbGVQb2ludFNuYXAgPSBmdW5jdGlvbihsb2NhbE1vdXNlUG9zKSB7CiAgICAgICAgZm9yICh2YXIgc25hcFNldHRpbmdzID0gdGhpcy5zbmFwU2V0dGluZ3MsIG1pbkRpc3RTcSA9IHNuYXBTZXR0aW5ncy5kaXN0ICogc25hcFNldHRpbmdzLmRpc3QsIHBvaW50cyA9IHNuYXBTZXR0aW5ncy5wb2ludHMsIG9ialggPSBsb2NhbE1vdXNlUG9zLnggLSB0aGlzLl9kcmFnT2Zmc2V0LngsIG9ialkgPSBsb2NhbE1vdXNlUG9zLnkgLSB0aGlzLl9kcmFnT2Zmc2V0LnksIGxlYXN0RGlzdCA9IC0xLCBjbG9zZXN0UG9pbnQgPSBudWxsLCBpID0gcG9pbnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgICAgIHZhciBwID0gcG9pbnRzW2ldLCBkaXN0U3EgPSBkaXN0U3F1YXJlZChvYmpYLCBvYmpZLCBwLngsIHAueSk7CiAgICAgICAgICAgIG1pbkRpc3RTcSA+PSBkaXN0U3EgJiYgKGxlYXN0RGlzdCA+IGRpc3RTcSB8fCAtMSA9PSBsZWFzdERpc3QpICYmIChsZWFzdERpc3QgPSBkaXN0U3EsIAogICAgICAgICAgICBjbG9zZXN0UG9pbnQgPSBwKTsKICAgICAgICB9CiAgICAgICAgY2xvc2VzdFBvaW50ICYmICh0aGlzLmRyYWdnZWRPYmoueCA9IGNsb3Nlc3RQb2ludC54LCB0aGlzLmRyYWdnZWRPYmoueSA9IGNsb3Nlc3RQb2ludC55KTsKICAgIH07CiAgICB2YXIgZGlzdFNxdWFyZWQgPSBmdW5jdGlvbih4MSwgeTEsIHgyLCB5MikgewogICAgICAgIHZhciB4RGlmZiA9IHgxIC0geDIsIHlEaWZmID0geTEgLSB5MjsKICAgICAgICByZXR1cm4geERpZmYgKiB4RGlmZiArIHlEaWZmICogeURpZmY7CiAgICB9LCBjbGFtcCA9IGZ1bmN0aW9uKHgsIGEsIGIpIHsKICAgICAgICByZXR1cm4gYSA+IHggPyBhIDogeCA+IGIgPyBiIDogeDsKICAgIH0sIGVuYWJsZURyYWcgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIHRoaXMuX29uTW91c2VEb3duTGlzdGVuZXIpLCB0aGlzLmN1cnNvciA9ICJwb2ludGVyIjsKICAgIH0sIGRpc2FibGVEcmFnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCB0aGlzLl9vbk1vdXNlRG93bkxpc3RlbmVyKSwgdGhpcy5jdXJzb3IgPSBudWxsOwogICAgfSwgX29uTW91c2VEb3duID0gZnVuY3Rpb24oZXYpIHsKICAgICAgICB0aGlzLl9kcmFnTWFuLl9vYmpNb3VzZURvd24oZXYsIHRoaXMpOwogICAgfTsKICAgIHAuYWRkT2JqZWN0ID0gZnVuY3Rpb24ob2JqLCBib3VuZHMpIHsKICAgICAgICBib3VuZHMgfHwgKGJvdW5kcyA9IHsKICAgICAgICAgICAgeDogMCwKICAgICAgICAgICAgeTogMCwKICAgICAgICAgICAgd2lkdGg6IHRoaXMuX3RoZVN0YWdlLmNhbnZhcy53aWR0aCwKICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLl90aGVTdGFnZS5jYW52YXMuaGVpZ2h0CiAgICAgICAgfSksIGJvdW5kcy5yaWdodCA9IGJvdW5kcy54ICsgYm91bmRzLndpZHRoLCBib3VuZHMuYm90dG9tID0gYm91bmRzLnkgKyBib3VuZHMuaGVpZ2h0LCAKICAgICAgICBvYmouX2RyYWdCb3VuZHMgPSBib3VuZHMsIHRoaXMuX2RyYWdnYWJsZU9iamVjdHMuaW5kZXhPZihvYmopID49IDAgfHwgKG9iai5lbmFibGVEcmFnID0gZW5hYmxlRHJhZywgCiAgICAgICAgb2JqLmRpc2FibGVEcmFnID0gZGlzYWJsZURyYWcsIG9iai5fb25Nb3VzZURvd25MaXN0ZW5lciA9IF9vbk1vdXNlRG93bi5iaW5kKG9iaiksIAogICAgICAgIG9iai5fZHJhZ01hbiA9IHRoaXMsIHRoaXMuX2RyYWdnYWJsZU9iamVjdHMucHVzaChvYmopKTsKICAgIH0sIHAucmVtb3ZlT2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgb2JqLmRpc2FibGVEcmFnKCksIGRlbGV0ZSBvYmouZW5hYmxlRHJhZywgZGVsZXRlIG9iai5kaXNhYmxlRHJhZywgZGVsZXRlIG9iai5fb25Nb3VzZURvd25MaXN0ZW5lciwgCiAgICAgICAgZGVsZXRlIG9iai5fZHJhZ01hbiwgZGVsZXRlIG9iai5fZHJhZ0JvdW5kczsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLl9kcmFnZ2FibGVPYmplY3RzLmluZGV4T2Yob2JqKTsKICAgICAgICBpbmRleCA+PSAwICYmIHRoaXMuX2RyYWdnYWJsZU9iamVjdHMuc3BsaWNlKGluZGV4LCAxKTsKICAgIH0sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIG51bGwgIT09IHRoaXMuZHJhZ2dlZE9iaiAmJiAodGhpcy5kcmFnZ2VkT2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIoInByZXNzbW92ZSIsIHRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrKSwgCiAgICAgICAgdGhpcy5kcmFnZ2VkT2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIoInByZXNzdXAiLCB0aGlzLl90cmlnZ2VyU3RpY2t5Q2xpY2tDYWxsYmFjayksIAogICAgICAgIHRoaXMuX3RoZVN0YWdlLnJlbW92ZUV2ZW50TGlzdGVuZXIoInN0YWdlbW91c2Vtb3ZlIiwgdGhpcy5fdXBkYXRlQ2FsbGJhY2spLCB0aGlzLmRyYWdnZWRPYmogPSBudWxsKSwgCiAgICAgICAgdGhpcy5fdXBkYXRlQ2FsbGJhY2sgPSBudWxsLCB0aGlzLl9kcmFnU3RhcnRDYWxsYmFjayA9IG51bGwsIHRoaXMuX2RyYWdFbmRDYWxsYmFjayA9IG51bGwsIAogICAgICAgIHRoaXMuX3RyaWdnZXJIZWxkRHJhZ0NhbGxiYWNrID0gbnVsbCwgdGhpcy5fdHJpZ2dlclN0aWNreUNsaWNrQ2FsbGJhY2sgPSBudWxsLCB0aGlzLl9zdGFnZU1vdXNlVXBDYWxsYmFjayA9IG51bGwsIAogICAgICAgIHRoaXMuX3RoZVN0YWdlID0gbnVsbDsKICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5fZHJhZ2dhYmxlT2JqZWN0cy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewogICAgICAgICAgICB2YXIgb2JqID0gdGhpcy5fZHJhZ2dhYmxlT2JqZWN0c1tpXTsKICAgICAgICAgICAgb2JqLmRpc2FibGVEcmFnKCksIGRlbGV0ZSBvYmouZW5hYmxlRHJhZywgZGVsZXRlIG9iai5kaXNhYmxlRHJhZywgZGVsZXRlIG9iai5fb25Nb3VzZURvd25MaXN0ZW5lciwgCiAgICAgICAgICAgIGRlbGV0ZSBvYmouX2RyYWdNYW4sIGRlbGV0ZSBvYmouX2RyYWdCb3VuZHM7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2RyYWdnYWJsZU9iamVjdHMgPSBudWxsLCB0aGlzLl9oZWxwZXJQb2ludCA9IG51bGw7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuRHJhZ01hbmFnZXIgPSBEcmFnTWFuYWdlcjsKfSgpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBQb3NpdGlvbmVyID0gZnVuY3Rpb24oKSB7fTsKICAgIFBvc2l0aW9uZXIucHJvdG90eXBlID0ge30sIFBvc2l0aW9uZXIucG9zaXRpb25JdGVtcyA9IGZ1bmN0aW9uKHBhcmVudCwgaXRlbVNldHRpbmdzKSB7CiAgICAgICAgdmFyIHJvdCwgcHQ7CiAgICAgICAgZm9yICh2YXIgaU5hbWUgaW4gaXRlbVNldHRpbmdzKSB7CiAgICAgICAgICAgIHZhciBpdGVtID0gcGFyZW50W2lOYW1lXTsKICAgICAgICAgICAgaWYgKGl0ZW0pIHsKICAgICAgICAgICAgICAgIHZhciBzZXR0aW5nID0gaXRlbVNldHRpbmdzW2lOYW1lXTsKICAgICAgICAgICAgICAgIGlmIChpdGVtLnggPSBzZXR0aW5nLngsIGl0ZW0ueSA9IHNldHRpbmcueSwgcHQgPSBzZXR0aW5nLnNjYWxlLCBwdCAmJiAoaXRlbS5zY2FsZVggKj0gcHQueCwgCiAgICAgICAgICAgICAgICBpdGVtLnNjYWxlWSAqPSBwdC55KSwgcHQgPSBzZXR0aW5nLnBpdm90LCBwdCAmJiAoaXRlbS5yZWdYID0gcHQueCwgaXRlbS5yZWdZID0gcHQueSksIAogICAgICAgICAgICAgICAgcm90ID0gc2V0dGluZy5yb3RhdGlvbiwgcm90ICYmIChpdGVtLnJvdGF0aW9uID0gcm90KSwgc2V0dGluZy5oaXRBcmVhKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhpdEFyZWEgPSBzZXR0aW5nLmhpdEFyZWE7CiAgICAgICAgICAgICAgICAgICAgaXRlbS5oaXRTaGFwZSA9IFBvc2l0aW9uZXIuZ2VuZXJhdGVIaXRBcmVhKGhpdEFyZWEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgRGVidWcuZXJyb3IoImNvdWxkIG5vdCBmaW5kIG9iamVjdCAnIiArIGlOYW1lICsgIiciKTsKICAgICAgICB9CiAgICB9LCBQb3NpdGlvbmVyLmdlbmVyYXRlSGl0QXJlYSA9IGZ1bmN0aW9uKGhpdEFyZWEsIHNjYWxlKSB7CiAgICAgICAgc2NhbGUgfHwgKHNjYWxlID0gMSk7CiAgICAgICAgdmFyIGxpYnJhcnk7CiAgICAgICAgaWYgKGxpYnJhcnkgPSB3aW5kb3cuY3JlYXRlanMsIGlzQXJyYXkoaGl0QXJlYSkpIHsKICAgICAgICAgICAgaWYgKDEgPT0gc2NhbGUpIHJldHVybiBuZXcgbGlicmFyeS5Qb2x5Z29uKGhpdEFyZWEpOwogICAgICAgICAgICBmb3IgKHZhciB0ZW1wID0gW10sIGkgPSAwLCBsZW4gPSBoaXRBcmVhLmxlbmd0aDsgbGVuID4gaTsgKytpKSB0ZW1wLnB1c2gobmV3IGxpYnJhcnkuUG9pbnQoaGl0QXJlYVtpXS54ICogc2NhbGUsIGhpdEFyZWFbaV0ueSAqIHNjYWxlKSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgbGlicmFyeS5Qb2x5Z29uKHRlbXApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gInJlY3QiICE9IGhpdEFyZWEudHlwZSAmJiBoaXRBcmVhLnR5cGUgPyAiZWxsaXBzZSIgPT0gaGl0QXJlYS50eXBlID8gbmV3IGxpYnJhcnkuRWxsaXBzZSgoaGl0QXJlYS54IC0gLjUgKiBoaXRBcmVhLncpICogc2NhbGUsIChoaXRBcmVhLnkgLSAuNSAqIGhpdEFyZWEuaCkgKiBzY2FsZSwgaGl0QXJlYS53ICogc2NhbGUsIGhpdEFyZWEuaCAqIHNjYWxlKSA6ICJjaXJjbGUiID09IGhpdEFyZWEudHlwZSA/IG5ldyBsaWJyYXJ5LkNpcmNsZShoaXRBcmVhLnggKiBzY2FsZSwgaGl0QXJlYS55ICogc2NhbGUsIGhpdEFyZWEuciAqIHNjYWxlKSA6ICJzZWN0b3IiID09IGhpdEFyZWEudHlwZSA/IG5ldyBsaWJyYXJ5LlNlY3RvcihoaXRBcmVhLnggKiBzY2FsZSwgaGl0QXJlYS55ICogc2NhbGUsIGhpdEFyZWEuciAqIHNjYWxlLCBoaXRBcmVhLnN0YXJ0LCBoaXRBcmVhLmVuZCkgOiBudWxsIDogbmV3IGxpYnJhcnkuUmVjdGFuZ2xlKGhpdEFyZWEueCAqIHNjYWxlLCBoaXRBcmVhLnkgKiBzY2FsZSwgaGl0QXJlYS53ICogc2NhbGUsIGhpdEFyZWEuaCAqIHNjYWxlKTsKICAgIH07CiAgICB2YXIgaXNBcnJheSA9IGZ1bmN0aW9uKG8pIHsKICAgICAgICByZXR1cm4gIltvYmplY3QgQXJyYXldIiA9PT0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG8pOwogICAgfTsKICAgIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5Qb3NpdGlvbmVyID0gUG9zaXRpb25lcjsKfSgpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBTY3JlZW5TZXR0aW5ncyA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQsIHBwaSkgewogICAgICAgIHRoaXMud2lkdGggPSB3aWR0aCwgdGhpcy5oZWlnaHQgPSBoZWlnaHQsIHRoaXMucHBpID0gcHBpOwogICAgfTsKICAgIFNjcmVlblNldHRpbmdzLnByb3RvdHlwZSA9IHt9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuU2NyZWVuU2V0dGluZ3MgPSBTY3JlZW5TZXR0aW5nczsKfSgpLCBmdW5jdGlvbigpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBVSVNjYWxlciwgVUlFbGVtZW50ID0gZnVuY3Rpb24oaXRlbSwgc2V0dGluZ3MsIGRlc2lnbmVkU2NyZWVuKSB7CiAgICAgICAgc3dpdGNoIChVSVNjYWxlciA9IGNsb3Vka2lkLlVJU2NhbGVyLCB0aGlzLl9pdGVtID0gaXRlbSwgdGhpcy5fc2V0dGluZ3MgPSBzZXR0aW5ncywgCiAgICAgICAgdGhpcy5fZGVzaWduZWRTY3JlZW4gPSBkZXNpZ25lZFNjcmVlbiwgdGhpcy5vcmlnU2NhbGVYID0gaXRlbS5zY2FsZVgsIHRoaXMub3JpZ1NjYWxlWSA9IGl0ZW0uc2NhbGVZLCAKICAgICAgICB0aGlzLm9yaWdXaWR0aCA9IGl0ZW0ud2lkdGgsIHRoaXMub3JpZ0JvdW5kcyA9IHsKICAgICAgICAgICAgeDogMCwKICAgICAgICAgICAgeTogMCwKICAgICAgICAgICAgd2lkdGg6IGl0ZW0ud2lkdGgsCiAgICAgICAgICAgIGhlaWdodDogaXRlbS5oZWlnaHQKICAgICAgICB9LCB0aGlzLm9yaWdCb3VuZHMucmlnaHQgPSB0aGlzLm9yaWdCb3VuZHMueCArIHRoaXMub3JpZ0JvdW5kcy53aWR0aCwgdGhpcy5vcmlnQm91bmRzLmJvdHRvbSA9IHRoaXMub3JpZ0JvdW5kcy55ICsgdGhpcy5vcmlnQm91bmRzLmhlaWdodCwgCiAgICAgICAgc2V0dGluZ3MudmVydEFsaWduKSB7CiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX1RPUDoKICAgICAgICAgICAgdGhpcy5vcmlnTWFyZ2luVmVydCA9IGl0ZW0ueSArIHRoaXMub3JpZ0JvdW5kcy55OwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKICAgICAgICAgICAgdGhpcy5vcmlnTWFyZ2luVmVydCA9IC41ICogZGVzaWduZWRTY3JlZW4uaGVpZ2h0IC0gaXRlbS55OwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0JPVFRPTToKICAgICAgICAgICAgdGhpcy5vcmlnTWFyZ2luVmVydCA9IGRlc2lnbmVkU2NyZWVuLmhlaWdodCAtIChpdGVtLnkgKyB0aGlzLm9yaWdCb3VuZHMuYm90dG9tKTsKICAgICAgICB9CiAgICAgICAgc3dpdGNoIChzZXR0aW5ncy5ob3JpQWxpZ24pIHsKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fTEVGVDoKICAgICAgICAgICAgdGhpcy5vcmlnTWFyZ2luSG9yaSA9IGl0ZW0ueCArIHRoaXMub3JpZ0JvdW5kcy54OwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKICAgICAgICAgICAgdGhpcy5vcmlnTWFyZ2luSG9yaSA9IC41ICogZGVzaWduZWRTY3JlZW4ud2lkdGggLSBpdGVtLng7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgVUlTY2FsZXIuQUxJR05fUklHSFQ6CiAgICAgICAgICAgIHRoaXMub3JpZ01hcmdpbkhvcmkgPSBkZXNpZ25lZFNjcmVlbi53aWR0aCAtIChpdGVtLnggKyB0aGlzLm9yaWdCb3VuZHMucmlnaHQpOwogICAgICAgIH0KICAgIH0sIHAgPSBVSUVsZW1lbnQucHJvdG90eXBlID0ge307CiAgICBwLm9yaWdNYXJnaW5Ib3JpID0gMCwgcC5vcmlnTWFyZ2luVmVydCA9IDAsIHAub3JpZ1dpZHRoID0gMCwgcC5vcmlnU2NhbGVYID0gMCwgcC5vcmlnU2NhbGVZID0gMCwgCiAgICBwLm9yaWdCb3VuZHMgPSBudWxsLCBwLl9zZXR0aW5ncyA9IG51bGwsIHAuX2l0ZW0gPSBudWxsLCBwLl9kZXNpZ25lZFNjcmVlbiA9IG51bGwsIAogICAgcC5yZXNpemUgPSBmdW5jdGlvbihuZXdTY3JlZW4pIHsKICAgICAgICB2YXIgb3ZlcmFsbFNjYWxlID0gbmV3U2NyZWVuLmhlaWdodCAvIHRoaXMuX2Rlc2lnbmVkU2NyZWVuLmhlaWdodCwgcHBpU2NhbGUgPSBuZXdTY3JlZW4ucHBpIC8gdGhpcy5fZGVzaWduZWRTY3JlZW4ucHBpLCBsZXR0ZXJCb3hXaWR0aCA9IChuZXdTY3JlZW4ud2lkdGggLSB0aGlzLl9kZXNpZ25lZFNjcmVlbi53aWR0aCAqIG92ZXJhbGxTY2FsZSkgLyAyLCBpdGVtU2NhbGUgPSBvdmVyYWxsU2NhbGUgLyBwcGlTY2FsZTsKICAgICAgICB0aGlzLl9zZXR0aW5ncy5taW5TY2FsZSAmJiBpdGVtU2NhbGUgPCB0aGlzLl9zZXR0aW5ncy5taW5TY2FsZSA/IGl0ZW1TY2FsZSA9IHRoaXMuX3NldHRpbmdzLm1pblNjYWxlIDogdGhpcy5fc2V0dGluZ3MubWF4U2NhbGUgJiYgaXRlbVNjYWxlID4gdGhpcy5fc2V0dGluZ3MubWF4U2NhbGUgJiYgKGl0ZW1TY2FsZSA9IHRoaXMuX3NldHRpbmdzLm1heFNjYWxlKSwgCiAgICAgICAgaXRlbVNjYWxlICo9IHBwaVNjYWxlLCB0aGlzLl9pdGVtLnNjYWxlWCA9IHRoaXMub3JpZ1NjYWxlWCAqIGl0ZW1TY2FsZSwgdGhpcy5faXRlbS5zY2FsZVkgPSB0aGlzLm9yaWdTY2FsZVkgKiBpdGVtU2NhbGU7CiAgICAgICAgdmFyIG07CiAgICAgICAgc3dpdGNoIChtID0gdGhpcy5vcmlnTWFyZ2luVmVydCAqIG92ZXJhbGxTY2FsZSwgdGhpcy5fc2V0dGluZ3MudmVydEFsaWduKSB7CiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX1RPUDoKICAgICAgICAgICAgdGhpcy5faXRlbS55ID0gbSAtIHRoaXMub3JpZ0JvdW5kcy55ICogaXRlbVNjYWxlOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKICAgICAgICAgICAgdGhpcy5faXRlbS55ID0gLjUgKiBuZXdTY3JlZW4uaGVpZ2h0IC0gbTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSBVSVNjYWxlci5BTElHTl9CT1RUT006CiAgICAgICAgICAgIHRoaXMuX2l0ZW0ueSA9IG5ld1NjcmVlbi5oZWlnaHQgLSBtIC0gdGhpcy5vcmlnQm91bmRzLmJvdHRvbSAqIGl0ZW1TY2FsZTsKICAgICAgICB9CiAgICAgICAgc3dpdGNoIChtID0gdGhpcy5vcmlnTWFyZ2luSG9yaSAqIG92ZXJhbGxTY2FsZSwgdGhpcy5fc2V0dGluZ3MuaG9yaUFsaWduKSB7CiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0xFRlQ6CiAgICAgICAgICAgIHRoaXMuX2l0ZW0ueCA9IHRoaXMuX3NldHRpbmdzLnRpdGxlU2FmZSA/IGxldHRlckJveFdpZHRoICsgbSAtIHRoaXMub3JpZ0JvdW5kcy54ICogaXRlbVNjYWxlIDogbSAtIHRoaXMub3JpZ0JvdW5kcy54ICogaXRlbVNjYWxlOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIFVJU2NhbGVyLkFMSUdOX0NFTlRFUjoKICAgICAgICAgICAgdGhpcy5faXRlbS54ID0gdGhpcy5fc2V0dGluZ3MuY2VudGVyZWRIb3Jpem9udGFsbHkgPyAuNSAqIChuZXdTY3JlZW4ud2lkdGggLSB0aGlzLl9pdGVtLndpZHRoKSA6IC41ICogbmV3U2NyZWVuLndpZHRoIC0gbTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSBVSVNjYWxlci5BTElHTl9SSUdIVDoKICAgICAgICAgICAgdGhpcy5faXRlbS54ID0gdGhpcy5fc2V0dGluZ3MudGl0bGVTYWZlID8gbmV3U2NyZWVuLndpZHRoIC0gbGV0dGVyQm94V2lkdGggLSBtIC0gdGhpcy5vcmlnQm91bmRzLnJpZ2h0ICogaXRlbVNjYWxlIDogbmV3U2NyZWVuLndpZHRoIC0gbSAtIHRoaXMub3JpZ0JvdW5kcy5yaWdodCAqIGl0ZW1TY2FsZTsKICAgICAgICB9CiAgICB9LCBwLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLm9yaWdCb3VuZHMgPSBudWxsLCB0aGlzLl9pdGVtID0gbnVsbCwgdGhpcy5fc2V0dGluZ3MgPSBudWxsLCB0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG51bGw7CiAgICB9LCBuYW1lc3BhY2UoImNsb3Vka2lkIikuVUlFbGVtZW50ID0gVUlFbGVtZW50Owp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFVJRWxlbWVudFNldHRpbmdzID0gZnVuY3Rpb24oKSB7fSwgcCA9IFVJRWxlbWVudFNldHRpbmdzLnByb3RvdHlwZSA9IHt9OwogICAgcC52ZXJ0QWxpZ24gPSBudWxsLCBwLmhvcmlBbGlnbiA9IG51bGwsIHAudGl0bGVTYWZlID0gITEsIHAubWF4U2NhbGUgPSAxLCBwLm1pblNjYWxlID0gMSwgCiAgICBwLmNlbnRlcmVkSG9yaXpvbnRhbGx5ID0gITEsIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5VSUVsZW1lbnRTZXR0aW5ncyA9IFVJRWxlbWVudFNldHRpbmdzOwp9KCksIGZ1bmN0aW9uKCkgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIFVJRWxlbWVudFNldHRpbmdzID0gY2xvdWRraWQuVUlFbGVtZW50U2V0dGluZ3MsIFVJRWxlbWVudCA9IGNsb3Vka2lkLlVJRWxlbWVudCwgU2NyZWVuU2V0dGluZ3MgPSBjbG91ZGtpZC5TY3JlZW5TZXR0aW5ncywgVUlTY2FsZXIgPSBmdW5jdGlvbihwYXJlbnQsIGRlc2lnbmVkV2lkdGgsIGRlc2lnbmVkSGVpZ2h0LCBkZXNpZ25lZFBQSSkgewogICAgICAgIHRoaXMuX3BhcmVudCA9IHBhcmVudCwgdGhpcy5faXRlbXMgPSBbXSwgdGhpcy5fZGVzaWduZWRTY3JlZW4gPSBuZXcgU2NyZWVuU2V0dGluZ3MoZGVzaWduZWRXaWR0aCwgZGVzaWduZWRIZWlnaHQsIGRlc2lnbmVkUFBJKTsKICAgIH0sIHAgPSBVSVNjYWxlci5wcm90b3R5cGUgPSB7fSwgY3VycmVudFNjcmVlbiA9IG5ldyBTY3JlZW5TZXR0aW5ncygwLCAwLCAwKSwgaW5pdGlhbGl6ZWQgPSAhMTsKICAgIHAuX3BhcmVudCA9IG51bGwsIHAuX2Rlc2lnbmVkU2NyZWVuID0gbnVsbCwgcC5faXRlbXMgPSBudWxsLCBVSVNjYWxlci5BTElHTl9UT1AgPSAidG9wIiwgCiAgICBVSVNjYWxlci5BTElHTl9CT1RUT00gPSAiYm90dG9tIiwgVUlTY2FsZXIuQUxJR05fTEVGVCA9ICJsZWZ0IiwgVUlTY2FsZXIuQUxJR05fUklHSFQgPSAicmlnaHQiLCAKICAgIFVJU2NhbGVyLkFMSUdOX0NFTlRFUiA9ICJjZW50ZXIiLCBVSVNjYWxlci5mcm9tSlNPTiA9IGZ1bmN0aW9uKHBhcmVudCwganNvblNldHRpbmdzLCBqc29uSXRlbXMsIGltbWVkaWF0ZURlc3Ryb3kpIHsKICAgICAgICAiYm9vbGVhbiIgIT0gdHlwZW9mIGltbWVkaWF0ZURlc3Ryb3kgJiYgKGltbWVkaWF0ZURlc3Ryb3kgPSAhMCk7CiAgICAgICAgdmFyIGl0ZW0sIGksIGFsaWduLCB2ZXJ0QWxpZ24sIGhvcmlBbGlnbiwgc2NhbGVyID0gbmV3IFVJU2NhbGVyKHBhcmVudCwganNvblNldHRpbmdzLmRlc2lnbmVkV2lkdGgsIGpzb25TZXR0aW5ncy5kZXNpZ25lZEhlaWdodCwganNvblNldHRpbmdzLmRlc2lnbmVkUFBJKTsKICAgICAgICBmb3IgKGkgaW4ganNvbkl0ZW1zKSBpdGVtID0ganNvbkl0ZW1zW2ldLCBpdGVtLmFsaWduID8gKGFsaWduID0gaXRlbS5hbGlnbi5zcGxpdCgiLSIpLCAKICAgICAgICB2ZXJ0QWxpZ24gPSBhbGlnblswXSwgaG9yaUFsaWduID0gYWxpZ25bMV0pIDogKHZlcnRBbGlnbiA9IEFMSUdOX0NFTlRFUiwgaG9yaUFsaWduID0gQUxJR05fQ0VOVEVSKSwgCiAgICAgICAgc2NhbGVyLmFkZChwYXJlbnRbaV0sIHZlcnRBbGlnbiwgaG9yaUFsaWduLCBpdGVtLnRpdGxlU2FmZSB8fCAhMSwgaXRlbS5taW5TY2FsZSB8fCAwLzAsIGl0ZW0ubWF4U2NhbGUgfHwgMC8wLCBpdGVtLmNlbnRlcmVkSG9yaXpvbnRhbGx5IHx8ICExKTsKICAgICAgICByZXR1cm4gc2NhbGVyLnJlc2l6ZSgpLCBpbW1lZGlhdGVEZXN0cm95ICYmIHNjYWxlci5kZXN0cm95KCksIHNjYWxlcjsKICAgIH0sIFVJU2NhbGVyLmluaXQgPSBmdW5jdGlvbihzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0LCBzY3JlZW5QUEkpIHsKICAgICAgICBjdXJyZW50U2NyZWVuLndpZHRoID0gc2NyZWVuV2lkdGgsIGN1cnJlbnRTY3JlZW4uaGVpZ2h0ID0gc2NyZWVuSGVpZ2h0LCBjdXJyZW50U2NyZWVuLnBwaSA9IHNjcmVlblBQSSwgCiAgICAgICAgaW5pdGlhbGl6ZWQgPSAhMDsKICAgIH0sIHAuZ2V0U2NhbGUgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gY3VycmVudFNjcmVlbi5oZWlnaHQgLyB0aGlzLl9kZXNpZ25lZFNjcmVlbi5oZWlnaHQ7CiAgICB9LCBwLmFkZCA9IGZ1bmN0aW9uKGl0ZW0sIHZlcnRBbGlnbiwgaG9yaUFsaWduLCB0aXRsZVNhZmUsIG1pblNjYWxlLCBtYXhTY2FsZSwgY2VudGVyZWRIb3Jpem9udGFsbHkpIHsKICAgICAgICB2YXIgcyA9IG5ldyBVSUVsZW1lbnRTZXR0aW5ncygpOwogICAgICAgIHMudmVydEFsaWduID0gdmVydEFsaWduIHx8IFVJU2NhbGVyLkFMSUdOX0NFTlRFUiwgcy5ob3JpQWxpZ24gPSBob3JpQWxpZ24gfHwgVUlTY2FsZXIuQUxJR05fQ0VOVEVSLCAKICAgICAgICBzLnRpdGxlU2FmZSA9ICJib29sZWFuIiAhPSB0eXBlb2YgdGl0bGVTYWZlID8gITEgOiB0aXRsZVNhZmUsIHMubWF4U2NhbGUgPSAibnVtYmVyIiAhPSB0eXBlb2YgbWF4U2NhbGUgPyAwLzAgOiBtYXhTY2FsZSwgCiAgICAgICAgcy5taW5TY2FsZSA9ICJudW1iZXIiICE9IHR5cGVvZiBtaW5TY2FsZSA/IDAvMCA6IG1pblNjYWxlLCBzLmNlbnRlcmVkSG9yaXpvbnRhbGx5ID0gY2VudGVyZWRIb3Jpem9udGFsbHkgfHwgITEsIAogICAgICAgIHRoaXMuX2l0ZW1zLnB1c2gobmV3IFVJRWxlbWVudChpdGVtLCBzLCB0aGlzLl9kZXNpZ25lZFNjcmVlbikpOwogICAgfSwgVUlTY2FsZXIucmVzaXplQmFja2dyb3VuZCA9IGZ1bmN0aW9uKGJpdG1hcCkgewogICAgICAgIGlmIChpbml0aWFsaXplZCkgewogICAgICAgICAgICB2YXIgaCwgdywgc2NhbGU7CiAgICAgICAgICAgIGggPSBiaXRtYXAuaW1hZ2UuaGVpZ2h0LCB3ID0gYml0bWFwLmltYWdlLndpZHRoLCBzY2FsZSA9IGN1cnJlbnRTY3JlZW4uaGVpZ2h0IC8gaCwgCiAgICAgICAgICAgIGJpdG1hcC5zY2FsZVggPSBiaXRtYXAuc2NhbGVZID0gc2NhbGUsIGJpdG1hcC54ID0gLjUgKiAoY3VycmVudFNjcmVlbi53aWR0aCAtIHcgKiBzY2FsZSk7CiAgICAgICAgfQogICAgfSwgVUlTY2FsZXIucmVzaXplQmFja2dyb3VuZHMgPSBmdW5jdGlvbihiaXRtYXBzKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGJpdG1hcHMubGVuZ3RoOyBsZW4gPiBpOyArK2kpIFVJU2NhbGVyLnJlc2l6ZUJhY2tncm91bmQoYml0bWFwc1tpXSk7CiAgICB9LCBwLnJlc2l6ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLl9pdGVtcy5sZW5ndGggPiAwKSBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5faXRlbXMubGVuZ3RoOyBsZW4gPiBpOyArK2kpIHRoaXMuX2l0ZW1zW2ldLnJlc2l6ZShjdXJyZW50U2NyZWVuKTsKICAgIH0sIHAuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aGlzLl9pdGVtcy5sZW5ndGggPiAwKSBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5faXRlbXMubGVuZ3RoOyBsZW4gPiBpOyArK2kpIHRoaXMuX2l0ZW1zW2ldLmRlc3Ryb3koKTsKICAgICAgICB0aGlzLl9wYXJlbnQgPSBudWxsLCB0aGlzLl9kZXNpZ25lZFNjcmVlbiA9IG51bGwsIHRoaXMuX2l0ZW1zID0gbnVsbDsKICAgIH0sIG5hbWVzcGFjZSgiY2xvdWRraWQiKS5VSVNjYWxlciA9IFVJU2NhbGVyOwp9KCk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 15:39:30 GMT",
                    "Content-Length": "59913",
                    "Date": "Thu, 06 Nov 2014 15:39:34 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}