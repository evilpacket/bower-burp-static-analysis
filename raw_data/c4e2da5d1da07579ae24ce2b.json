{
    "url": "http://localhost:9999/decojs/DecoJS/Dist/deco.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>document.location.href</b> and written to <b>the 'after()' function of JQuery</b> via the following statement:<ul><li>var path = _.after(document.location.href, '#');</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/decojs/DecoJS/Dist/deco.js",
                "path": "/decojs/DecoJS/Dist/deco.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kZWNvanMvRGVjb0pTL0Rpc3QvZGVjby5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzUyOTkNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMjA6MTU6NDYgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDIwOjE1OjQ2IEdNVA0KDQpkZWZpbmUoJ2RlY28vdXRpbHMnLFtdLCBmdW5jdGlvbigpewogIHJldHVybiB7CiAgICAKICAgIHRvQXJyYXk6IGZ1bmN0aW9uKG9iail7CiAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAvLyBpdGVyYXRlIGJhY2t3YXJkcyBlbnN1cmluZyB0aGF0IGxlbmd0aCBpcyBhbiBVSW50MzIKICAgICAgZm9yICh2YXIgaSA9IG9iai5sZW5ndGggPj4+IDA7IGktLTspIHsgCiAgICAgICAgYXJyYXlbaV0gPSBvYmpbaV07CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5OwogICAgfSwKICAgIAogICAgZXh0ZW5kOiBmdW5jdGlvbihkc3QsIHNyYyl7CiAgICAgIHNyYyA9IHNyYyB8fCB7fTsKICAgICAgZHN0ID0gZHN0IHx8IHt9OwogICAgICBmb3IodmFyIGkgaW4gc3JjKXsKICAgICAgICBkc3RbaV0gPSBzcmNbaV07CiAgICAgIH0KICAgICAgcmV0dXJuIGRzdDsKICAgIH0sCiAgICAKICAgIGluaGVyaXRzRnJvbTogZnVuY3Rpb24obyl7CiAgICAgIGZ1bmN0aW9uIEYoKSB7fQogICAgICBGLnByb3RvdHlwZSA9IG8ucHJvdG90eXBlOwoKICAgICAgcmV0dXJuIG5ldyBGKCk7CiAgICB9LAogICAgCiAgICBhcnJheVRvT2JqZWN0OiBmdW5jdGlvbihhcnJheSwgZnVuYyl7CiAgICAgIHJldHVybiBhcnJheS5yZWR1Y2UoZnVuY3Rpb24oY29sbGVjdGlvbiwgaXRlbSl7CiAgICAgICAgZnVuYyhpdGVtLCBjb2xsZWN0aW9uKTsKICAgICAgICByZXR1cm4gY29sbGVjdGlvbjsKICAgICAgfSwge30pOwogICAgfSwKICAgIAogICAgdHJpbTogZnVuY3Rpb24od29yZCwgY2hhcmFjdGVyKXsKICAgICAgd2hpbGUod29yZC5jaGFyQXQoMCkgPT0gY2hhcmFjdGVyKSB3b3JkID0gd29yZC5zdWJzdHIoMSk7CiAgICAgIHdoaWxlKHdvcmQuY2hhckF0KHdvcmQubGVuZ3RoIC0gMSkgPT0gY2hhcmFjdGVyKSB3b3JkID0gd29yZC5zdWJzdHIoMCwgd29yZC5sZW5ndGggLSAxKTsKICAgICAgcmV0dXJuIHdvcmQ7CiAgICB9LAogICAgCiAgICBhZnRlcjogZnVuY3Rpb24od29yZCwgY2hhcmFjdGVyKXsKICAgICAgdmFyIGluZGV4ID0gd29yZC5pbmRleE9mKGNoYXJhY3Rlcik7CiAgICAgIGlmKGluZGV4IDwgMCl7CiAgICAgICAgcmV0dXJuICIiOwogICAgICB9ZWxzZXsKICAgICAgICByZXR1cm4gd29yZC5zdWJzdHIoaW5kZXgrMSk7CiAgICAgIH0KICAgIH0sCiAgICAKICAgIHBvcFRhaWw6IGZ1bmN0aW9uKGFycmF5KXsKICAgICAgcmV0dXJuIGFycmF5LnNsaWNlKDAsIC0xKTsKICAgIH0sCiAgICAKICAgIHN0YXJ0c1dpdGg6IGZ1bmN0aW9uKHdvcmQsIGNoYXJhY3Rlcil7CiAgICAgIHJldHVybiB3b3JkLmNoYXJBdCgwKSA9PT0gY2hhcmFjdGVyOwogICAgfSwKICAgIAogICAgZW5kc1dpdGg6IGZ1bmN0aW9uKHdvcmQsIGNoYXJhY3Rlcil7CiAgICAgIHJldHVybiB3b3JkLmNoYXJBdCh3b3JkLmxlbmd0aCAtIDEpID09PSBjaGFyYWN0ZXI7CiAgICB9LAogICAgCiAgICBhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbihlbGVtZW50LCBldmVudCwgbGlzdGVuZXIsIGJ1YmJsZSl7CiAgICAgIGlmKCdhZGRFdmVudExpc3RlbmVyJyBpbiBlbGVtZW50KXsKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyLCBidWJibGUpOwogICAgICB9ZWxzZXsKICAgICAgICBlbGVtZW50LmF0dGFjaEV2ZW50KCJvbiIrZXZlbnQsIGxpc3RlbmVyKTsgICAgCiAgICAgIH0KICAgIH0KICB9Owp9KTsKCmRlZmluZSgnZGVjby9xdmMvRXhlY3V0YWJsZVJlc3VsdCcsWyJkZWNvL3V0aWxzIl0sIGZ1bmN0aW9uKHV0aWxzKXsKICBmdW5jdGlvbiBFeGVjdXRhYmxlUmVzdWx0KHJlc3VsdCl7CiAgICAKICAgIHRoaXMuc3VjY2VzcyA9IGZhbHNlOwogICAgdGhpcy52YWxpZCA9IGZhbHNlOwogICAgdGhpcy5yZXN1bHQgPSBudWxsOwogICAgdGhpcy5leGNlcHRpb24gPSBudWxsOwogICAgdGhpcy52aW9sYXRpb25zID0gW107CiAgCiAgICB1dGlscy5leHRlbmQodGhpcywgcmVzdWx0KTsKICAKICB9OwogIAogIHJldHVybiBFeGVjdXRhYmxlUmVzdWx0Owp9KTsKZGVmaW5lKCdkZWNvL3F2Yy9Db25zdHJhaW50JyxbXSwgZnVuY3Rpb24oKXsKICAKICBmdW5jdGlvbiBDb25zdHJhaW50KHR5cGUsIGF0dHJpYnV0ZXMpeyAgICAKICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICB0aGlzLmF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzOwogICAgdGhpcy5tZXNzYWdlID0gYXR0cmlidXRlcy5tZXNzYWdlOwogICAgCiAgICAKICAgIHRoaXMuaW5pdCh0eXBlKTsKICB9CiAgICAKICBDb25zdHJhaW50LnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24odHlwZSl7CiAgICByZXF1aXJlKFsiZGVjby9xdmMvY29uc3RyYWludHMvIiArIHR5cGVdLCBmdW5jdGlvbihUZXN0ZXIpewogICAgICB2YXIgdGVzdGVyID0gbmV3IFRlc3Rlcih0aGlzLmF0dHJpYnV0ZXMpOwogICAgICB0aGlzLnZhbGlkYXRlID0gdGVzdGVyLmlzVmFsaWQuYmluZCh0ZXN0ZXIpOwogICAgfS5iaW5kKHRoaXMpKTsKICB9OwogIAogIENvbnN0cmFpbnQucHJvdG90eXBlLnZhbGlkYXRlID0gZnVuY3Rpb24odmFsdWUpewogICAgcmV0dXJuIHRydWU7Ly9yZWFsIHRlc3Qgbm90IGxvYWRlZCB5ZXQKICB9OwogIAogIAogIHJldHVybiBDb25zdHJhaW50Owp9KTsKZGVmaW5lKCdkZWNvL3F2Yy9WYWxpZGF0b3InLFsKICAiZGVjby9xdmMvQ29uc3RyYWludCIsIAogICJrbm9ja291dCIKXSwgZnVuY3Rpb24oCiAgQ29uc3RyYWludCwgCiAga28KKXsKCiAgZnVuY3Rpb24gaW50ZXJwb2xhdGUobWVzc2FnZSwgYXR0cmlidXRlcywgdmFsdWUsIG5hbWUsIHBhdGgpewogICAgcmV0dXJuIG1lc3NhZ2UucmVwbGFjZSgvXHsoW159XSspXH0vZywgZnVuY3Rpb24obWF0Y2gsIGtleSl7CiAgICAgIGlmKGtleSA9PSAidmFsdWUiKSByZXR1cm4gdmFsdWU7CiAgICAgIGlmKGtleSA9PSAidGhpcy5uYW1lIikgcmV0dXJuIG5hbWU7CiAgICAgIGlmKGtleSA9PSAidGhpcy5wYXRoIikgcmV0dXJuIHBhdGg7CiAgICAgIGlmKGtleSBpbiBhdHRyaWJ1dGVzKSByZXR1cm4gYXR0cmlidXRlc1trZXldOwogICAgICByZXR1cm4gbWF0Y2g7CiAgICB9KTsKICB9CiAgCgogIGZ1bmN0aW9uIFZhbGlkYXRvcih0YXJnZXQsIG9wdGlvbnMpewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgCiAgICB0aGlzLmNvbnN0cmFpbnRzID0gW107CiAgICAKICAgIHRoaXMuaXNWYWxpZCA9IGtvLm9ic2VydmFibGUodHJ1ZSk7CiAgICB0aGlzLm1lc3NhZ2UgPSBrby5vYnNlcnZhYmxlKCIiKTsKCiAgICB0aGlzLm5hbWUgPSBvcHRpb25zICYmIG9wdGlvbnMubmFtZTsKICAgIHRoaXMucGF0aCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5wYXRoOwogIH0KICAKICBWYWxpZGF0b3IucHJvdG90eXBlLnNldENvbnN0cmFpbnRzID0gZnVuY3Rpb24oY29uc3RyYWludHMpewogICAgdGhpcy5jb25zdHJhaW50cyA9IGNvbnN0cmFpbnRzLm1hcChmdW5jdGlvbihjb25zdHJhaW50KXsKICAgICAgcmV0dXJuIG5ldyBDb25zdHJhaW50KGNvbnN0cmFpbnQubmFtZSwgY29uc3RyYWludC5hdHRyaWJ1dGVzKTsKICAgIH0pOwogIH07CiAgCiAgVmFsaWRhdG9yLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uKCl7CiAgICB0aGlzLmlzVmFsaWQodHJ1ZSk7CiAgICB0aGlzLm1lc3NhZ2UoIiIpOwogIH07CiAgCiAgVmFsaWRhdG9yLnByb3RvdHlwZS52YWxpZGF0ZSA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgIGlmKHRoaXMuY29uc3RyYWludHMubGVuZ3RoID09IDApewogICAgICB0aGlzLnJlc2V0KCk7CiAgICB9ZWxzZSBpZih0aGlzLmNvbnN0cmFpbnRzLmV2ZXJ5KGZ1bmN0aW9uIChjb25zdHJhaW50KSB7CiAgICAgIGlmKGNvbnN0cmFpbnQudmFsaWRhdGUodmFsdWUpKXsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfWVsc2V7CiAgICAgICAgdGhpcy5pc1ZhbGlkKGZhbHNlKTsKICAgICAgICB0aGlzLm1lc3NhZ2UoaW50ZXJwb2xhdGUoY29uc3RyYWludC5tZXNzYWdlLCBjb25zdHJhaW50LmF0dHJpYnV0ZXMsIHZhbHVlLCB0aGlzLm5hbWUsIHRoaXMucGF0aCkpOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfS5iaW5kKHRoaXMpKSl7CiAgICAgIHRoaXMuaXNWYWxpZCh0cnVlKTsKICAgICAgdGhpcy5tZXNzYWdlKCIiKTsKICAgIH0KICB9OwogIAogIHJldHVybiBWYWxpZGF0b3I7Cn0pOwpkZWZpbmUoJ2RlY28vcXZjL2tvRXh0ZW5zaW9ucycsWyJkZWNvL3F2Yy9WYWxpZGF0b3IiLCAia25vY2tvdXQiXSwgZnVuY3Rpb24oVmFsaWRhdG9yLCBrbyl7CgogIGlmIChrbyAhPSBudWxsKSB7CiAgICBrby5iaW5kaW5nSGFuZGxlcnMudmFsaWRhdGlvbk1lc3NhZ2VGb3IgPSB7CiAgICAgIGluaXQ6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nc0FjY2Vzc29yLCB2aWV3TW9kZWwpIHsKICAgICAgICB2YXIgdmFsdWUgPSB2YWx1ZUFjY2Vzc29yKCk7CiAgICAgICAgdmFyIHZhbGlkYXRvciA9IHZhbHVlLnZhbGlkYXRvcjsKICAgICAgICBpZiAodmFsaWRhdG9yKSB7CiAgICAgICAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlKGVsZW1lbnQsIHsgaGlkZGVuOiB2YWxpZGF0b3IuaXNWYWxpZCwgdGV4dDogdmFsaWRhdG9yLm1lc3NhZ2UgfSwgdmFsaWRhdG9yKTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgIHZhciBhdHRyaWJ1dGVzID0gQXJyYXkucHJvdG90eXBlLnJlZHVjZS5jYWxsKGVsZW1lbnQuYXR0cmlidXRlcywgZnVuY3Rpb24ocyxlKXtyZXR1cm4gcysiICIrZS5sb2NhbE5hbWUrIj1cIiIrZS52YWx1ZSsiXCIifSwgIiIpOwogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDb3VsZCBub3QgYmluZCBgdmFsaWRhdGlvbk1lc3NhZ2VGb3JgIHRvIHZhbHVlIG9uIGVsZW1lbnQgPCIrZWxlbWVudC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgKyBhdHRyaWJ1dGVzICsiPiIpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIAogICAga28uZXh0ZW5kZXJzLnZhbGlkYXRpb24gPSBmdW5jdGlvbiAodGFyZ2V0LCBvcHRpb25zKSB7CiAgICAgIHRhcmdldC52YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKHRhcmdldCwgb3B0aW9ucyk7CiAgICAgIHRhcmdldC5zdWJzY3JpYmUoZnVuY3Rpb24gKG5ld1ZhbHVlKSB7CiAgICAgICAgdGFyZ2V0LnZhbGlkYXRvci52YWxpZGF0ZShuZXdWYWx1ZSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfTsKICAgIAogICAga28uYmluZGluZ0hhbmRsZXJzLmNvbW1hbmQgPSBrby5iaW5kaW5nSGFuZGxlcnMucXVlcnkgPSB7CiAgICAgIGluaXQ6IGZ1bmN0aW9uIChlbGVtZW50LCB2YWx1ZUFjY2Vzc29yLCBhbGxCaW5kaW5nQWNjZXNzb3IsIHZpZXdNb2RlbCkgewogICAgICAgIGtvLmFwcGx5QmluZGluZ3NUb05vZGUoZWxlbWVudCwgeyBjbGljazogdmFsdWVBY2Nlc3NvcigpIH0sIHZpZXdNb2RlbCk7CiAgICAgIH0KICAgIH07CiAgfQogIAoKfSk7CmRlZmluZSgnZGVjby9xdmMvVmFsaWRhdGFibGUnLFsKICAiZGVjby91dGlscyIsIAogICJkZWNvL3F2Yy9WYWxpZGF0b3IiLCAKICAia25vY2tvdXQiLCAKICAiZGVjby9xdmMva29FeHRlbnNpb25zIgpdLCBmdW5jdGlvbigKICB1dGlscywgCiAgVmFsaWRhdG9yLCAKICBrbwopewogIAogIGZ1bmN0aW9uIFZhbGlkYXRhYmxlKG5hbWUsIHBhcmFtZXRlcnMsIGNvbnN0cmFpbnRSZXNvbHZlcil7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAKICAgIHRoaXMudmFsaWRhdG9yID0gbmV3IFZhbGlkYXRvcigpOwogICAgdGhpcy52YWxpZGF0YWJsZUZpZWxkcyA9IFtdOwogICAgdGhpcy52YWxpZGF0YWJsZVBhcmFtZXRlcnMgPSBwYXJhbWV0ZXJzOwogICAgCiAgICAKICAgIGluaXQ6IHsKICAgICAgcmVjdXJzaXZseUV4dGVuZFBhcmFtZXRlcnMoc2VsZi52YWxpZGF0YWJsZVBhcmFtZXRlcnMsIHNlbGYudmFsaWRhdGFibGVGaWVsZHMsIFtdKTsKICAgICAgaWYoY29uc3RyYWludFJlc29sdmVyKQogICAgICAgIGNvbnN0cmFpbnRSZXNvbHZlci5hcHBseVZhbGlkYXRpb25Db25zdHJhaW50cyhuYW1lLCBzZWxmKTsKICAgIH0KICB9CiAgCiAgVmFsaWRhdGFibGUucHJvdG90eXBlLmlzVmFsaWQgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy52YWxpZGF0YWJsZUZpZWxkcy5ldmVyeShmdW5jdGlvbihjb25zdHJhaW50KXsKICAgICAgcmV0dXJuIGNvbnN0cmFpbnQudmFsaWRhdG9yICYmIGNvbnN0cmFpbnQudmFsaWRhdG9yLmlzVmFsaWQoKTsKICAgIH0pICYmIHRoaXMudmFsaWRhdG9yLmlzVmFsaWQoKTsKICB9OwogICAgCiAgVmFsaWRhdGFibGUucHJvdG90eXBlLmFwcGx5VmlvbGF0aW9ucyA9IGZ1bmN0aW9uKHZpb2xhdGlvbnMpewogICAgdmlvbGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHZpb2xhdGlvbil7CiAgICAgIHZhciBtZXNzYWdlID0gdmlvbGF0aW9uLm1lc3NhZ2U7CiAgICAgIHZhciBmaWVsZE5hbWUgPSB2aW9sYXRpb24uZmllbGROYW1lOwogICAgICBpZiAoZmllbGROYW1lLmxlbmd0aCA+IDApIHsKICAgICAgICAvL29uZSBvZiB0aGUgZmllbGRzIHZpb2xhdGVzIGEgY29uc3RyYWludAogICAgICAgIGFwcGx5VmlvbGF0aW9uTWVzc2FnZVRvRmllbGQodGhpcy52YWxpZGF0YWJsZVBhcmFtZXRlcnMsIGZpZWxkTmFtZSwgbWVzc2FnZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy90aGUgdmFsaWRhdGFibGUgdmlvbGF0ZXMgYSBjb25zdHJhaW50CiAgICAgICAgYXBwbHlWaW9sYXRpb25NZXNzYWdlVG9WYWxpZGF0YWJsZSh0aGlzLCBtZXNzYWdlKTsKICAgICAgfQogICAgfS5iaW5kKHRoaXMpKTsKICB9OwogIAogIFZhbGlkYXRhYmxlLnByb3RvdHlwZS5hcHBseUNvbnN0cmFpbnRzID0gZnVuY3Rpb24oZmllbGRzKXsKICAgIHZhciBwYXJhbWV0ZXJzID0gdGhpcy52YWxpZGF0YWJsZVBhcmFtZXRlcnM7CiAgICAKICAgIGZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uKGZpZWxkKXsKICAgICAgdmFyIGZpZWxkTmFtZSA9IGZpZWxkLm5hbWU7CiAgICAgIHZhciBjb25zdHJhaW50cyA9IGZpZWxkLmNvbnN0cmFpbnRzOwoKICAgICAgaWYoY29uc3RyYWludHMgPT0gbnVsbCB8fCBjb25zdHJhaW50cy5sZW5ndGggPT0gMCkKICAgICAgICByZXR1cm47CiAgICAgIAogICAgICB2YXIgb2JqZWN0ID0gZmluZEZpZWxkKGZpZWxkTmFtZSwgcGFyYW1ldGVycywgIkVycm9yIGFwcGx5aW5nIGNvbnN0cmFpbnRzIHRvIGZpZWxkIik7CiAgICAgIAogICAgICBpZiAoa28uaXNPYnNlcnZhYmxlKG9iamVjdCkgJiYgInZhbGlkYXRvciIgaW4gb2JqZWN0KSB7CiAgICAgICAgb2JqZWN0LnZhbGlkYXRvci5zZXRDb25zdHJhaW50cyhjb25zdHJhaW50cyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFcnJvciBhcHBseWluZyBjb25zdHJhaW50cyB0byBmaWVsZDogIiArIGZpZWxkTmFtZSArICJcbiIgKwogICAgICAgICAgIkl0IGlzIG5vdCBhbiBvYnNlcnZhYmxlIG9yIGlzIG5vdCBleHRlbmRlZCB3aXRoIGEgdmFsaWRhdG9yLiBcbiIgKwogICAgICAgICAgZmllbGROYW1lICsgIj1gIiArIGtvLnRvSlNPTihvYmplY3QpICsgImAiKTsKICAgICAgfQogICAgfSk7CiAgfTsKICAKICBWYWxpZGF0YWJsZS5wcm90b3R5cGUudmFsaWRhdGUgPSBmdW5jdGlvbigpewogICAgdGhpcy52YWxpZGF0b3IudmFsaWRhdGUodHJ1ZSk7CiAgICBpZiAodGhpcy52YWxpZGF0b3IuaXNWYWxpZCgpKSB7CiAgICAgIHRoaXMudmFsaWRhdGFibGVGaWVsZHMuZm9yRWFjaChmdW5jdGlvbihjb25zdHJhaW50KXsKICAgICAgICB2YXIgdmFsaWRhdG9yID0gY29uc3RyYWludC52YWxpZGF0b3I7CiAgICAgICAgaWYgKHZhbGlkYXRvcikgewogICAgICAgICAgdmFsaWRhdG9yLnZhbGlkYXRlKGNvbnN0cmFpbnQoKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9OwogIAogIFZhbGlkYXRhYmxlLnByb3RvdHlwZS5jbGVhclZhbGlkYXRpb25NZXNzYWdlcyA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMudmFsaWRhdG9yLnJlc2V0KCk7CiAgICB0aGlzLnZhbGlkYXRhYmxlRmllbGRzLmZvckVhY2goZnVuY3Rpb24oY29uc3RyYWludCl7CiAgICAgIHZhciB2YWxpZGF0b3IgPSBjb25zdHJhaW50LnZhbGlkYXRvcjsKICAgICAgaWYgKHZhbGlkYXRvcikgewogICAgICAgIHZhbGlkYXRvci5yZXNldCgpOwogICAgICB9CiAgICB9KTsKICB9OwogIAogIAogIAogIGZ1bmN0aW9uIHJlY3Vyc2l2bHlFeHRlbmRQYXJhbWV0ZXJzKHBhcmFtZXRlcnMsIHZhbGlkYXRhYmxlRmllbGRzLCBwYXJlbnRzKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gcGFyYW1ldGVycykgewogICAgICB2YXIgcHJvcGVydHkgPSBwYXJhbWV0ZXJzW2tleV07CiAgICAgIHZhciBwYXRoID0gcGFyZW50cy5jb25jYXQoW2tleV0pOwogICAgICBpZiAoa28uaXNPYnNlcnZhYmxlKHByb3BlcnR5KSkgewogICAgICAgIHByb3BlcnR5LmV4dGVuZCh7CiAgICAgICAgICB2YWxpZGF0aW9uOiB7CiAgICAgICAgICAgIG5hbWU6a2V5LAogICAgICAgICAgICBwYXRoOnBhdGguam9pbigiLiIpCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFsaWRhdGFibGVGaWVsZHMucHVzaChwcm9wZXJ0eSk7CiAgICAgIH0KICAgICAgcHJvcGVydHkgPSBrby51dGlscy51bndyYXBPYnNlcnZhYmxlKHByb3BlcnR5KTsKICAgICAgaWYgKHR5cGVvZiBwcm9wZXJ0eSA9PT0gIm9iamVjdCIpIHsKICAgICAgICByZWN1cnNpdmx5RXh0ZW5kUGFyYW1ldGVycyhwcm9wZXJ0eSwgdmFsaWRhdGFibGVGaWVsZHMsIHBhdGgpOwogICAgICB9CiAgICB9CiAgfQoKCiAgZnVuY3Rpb24gZmluZEZpZWxkKGZpZWxkUGF0aCwgcGFyYW1ldGVycywgZXJyb3JNZXNzYWdlKXsKICAgIHJldHVybiBmaWVsZFBhdGguc3BsaXQoIi4iKS5yZWR1Y2UoZnVuY3Rpb24ob2JqZWN0LCBuYW1lKXsKICAgICAgdmFyIHBhdGggPSBvYmplY3QucGF0aDsKICAgICAgdmFyIGZpZWxkID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShvYmplY3QuZmllbGQpOwogICAgICBpZiAobmFtZSBpbiBmaWVsZCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBmaWVsZDogZmllbGRbbmFtZV0sCiAgICAgICAgICBwYXRoOiBwYXRoICsgIi4iICsgbmFtZQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTWVzc2FnZSArICI6ICIgKyBmaWVsZFBhdGggKyAiXG4iICsKICAgICAgICAgIG5hbWUgKyAiIGlzIG5vdCBhIG1lbWJlciBvZiAiICsgcGF0aCArICJcbiIgKwogICAgICAgICAgcGF0aCArICIgPSBgIiArIGtvLnRvSlNPTihmaWVsZCkgKyAiYCIpOwogICAgICB9CiAgICB9LCB7CiAgICAgIGZpZWxkOiBwYXJhbWV0ZXJzLAogICAgICBwYXRoOiAicGFyYW1ldGVycyIKICAgIH0pLmZpZWxkOwogIH0KCgoKICAKICBmdW5jdGlvbiBhcHBseVZpb2xhdGlvbk1lc3NhZ2VUb0ZpZWxkKHBhcmFtZXRlcnMsIGZpZWxkUGF0aCwgbWVzc2FnZSkgewogICAgdmFyIG9iamVjdCA9IGZpbmRGaWVsZChmaWVsZFBhdGgsIHBhcmFtZXRlcnMsICJFcnJvciBhcHBseWluZyB2aW9sYXRpb24iKTsKICAgIAogICAgaWYgKHR5cGVvZiBtZXNzYWdlID09PSAic3RyaW5nIiAmJiAidmFsaWRhdG9yIiBpbiBvYmplY3QpIHsKICAgICAgb2JqZWN0LnZhbGlkYXRvci5pc1ZhbGlkKGZhbHNlKTsKICAgICAgb2JqZWN0LnZhbGlkYXRvci5tZXNzYWdlKG1lc3NhZ2UpOwogICAgfWVsc2V7CiAgICAgIHRocm93IG5ldyBFcnJvcigiRXJyb3IgYXBwbHlpbmcgdmlvbGF0aW9uXG4iK2ZpZWxkUGF0aCsiIGlzIG5vdCB2YWxpZGF0YWJsZVxuaXQgc2hvdWxkIGJlIGFuIG9ic2VydmFibGUiKTsKICAgIH0KICB9OwoKICBmdW5jdGlvbiBhcHBseVZpb2xhdGlvbk1lc3NhZ2VUb1ZhbGlkYXRhYmxlKHZhbGlkYXRhYmxlLCBtZXNzYWdlKSB7CiAgICB2YWxpZGF0YWJsZS52YWxpZGF0b3IuaXNWYWxpZChmYWxzZSk7CiAgICB2YXIgb2xkTWVzc2FnZSA9IHZhbGlkYXRhYmxlLnZhbGlkYXRvci5tZXNzYWdlKCk7CiAgICB2YXIgbmV3TWVzc2FnZSA9IG9sZE1lc3NhZ2UubGVuZ3RoID09IDAgPyBtZXNzYWdlIDogb2xkTWVzc2FnZSArICIsICIgKyBtZXNzYWdlOwogICAgdmFsaWRhdGFibGUudmFsaWRhdG9yLm1lc3NhZ2UobmV3TWVzc2FnZSk7CiAgfTsKICAKICAKICAKICByZXR1cm4gVmFsaWRhdGFibGU7Cn0pOwpkZWZpbmUoJ2RlY28vcXZjL0V4ZWN1dGFibGUnLFsKICAiZGVjby9xdmMvRXhlY3V0YWJsZVJlc3VsdCIsIAogICJkZWNvL3F2Yy9WYWxpZGF0YWJsZSIsIAogICJkZWNvL3V0aWxzIiwgCiAgImtub2Nrb3V0IgpdLCBmdW5jdGlvbigKICBFeGVjdXRhYmxlUmVzdWx0LCAKICBWYWxpZGF0YWJsZSwgCiAgdXRpbHMsIAogIGtvKXsKCiAgZnVuY3Rpb24gRXhlY3V0YWJsZShuYW1lLCB0eXBlLCBwYXJhbWV0ZXJzLCBjYWxsYmFja3MsIHF2Yyl7ICAgIAogICAgVmFsaWRhdGFibGUuY2FsbCh0aGlzLCBuYW1lLCBwYXJhbWV0ZXJzLCBxdmMuY29uc3RyYWludFJlc29sdmVyKQogICAgCiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgdGhpcy50eXBlID0gdHlwZTsKICAgIHRoaXMucXZjID0gcXZjOwogICAgdGhpcy5pc0J1c3kgPSBrby5vYnNlcnZhYmxlKGZhbHNlKTsKICAgIHRoaXMuaGFzRXJyb3IgPSBrby5vYnNlcnZhYmxlKGZhbHNlKTsKICAgIHRoaXMucmVzdWx0ID0gbmV3IEV4ZWN1dGFibGVSZXN1bHQoKTsKICAgIAogICAgdGhpcy5wYXJhbWV0ZXJzID0gT2JqZWN0LnNlYWwocGFyYW1ldGVycyk7CiAgICB0aGlzLmNhbGxiYWNrcyA9IHV0aWxzLmV4dGVuZCh7CiAgICAgIGJlZm9yZUV4ZWN1dGU6IGZ1bmN0aW9uICgpIHt9LAogICAgICBjYW5FeGVjdXRlOiBmdW5jdGlvbigpe3JldHVybiB0cnVlO30sCiAgICAgIGVycm9yOiBmdW5jdGlvbiAoKSB7fSwKICAgICAgc3VjY2VzczogZnVuY3Rpb24gKCkge30sCiAgICAgIHJlc3VsdDogZnVuY3Rpb24oKXt9LAogICAgICBjb21wbGV0ZTogZnVuY3Rpb24gKCkge30sCiAgICAgIGludmFsaWQ6IGZ1bmN0aW9uKCkge30KICAgIH0sIGNhbGxiYWNrcyk7CiAgfQogICAgCiAgRXhlY3V0YWJsZS5wcm90b3R5cGUgPSB1dGlscy5pbmhlcml0c0Zyb20oVmFsaWRhdGFibGUpOwogICAgCiAgRXhlY3V0YWJsZS5wcm90b3R5cGUuZXhlY3V0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLm9uQmVmb3JlRXhlY3V0ZSgpID09PSBmYWxzZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLnF2Yy5leGVjdXRlKHRoaXMpOwogIH07CgogIEV4ZWN1dGFibGUucHJvdG90eXBlLm9uQmVmb3JlRXhlY3V0ZSA9IGZ1bmN0aW9uICgpIHsKCiAgICBpZiAodGhpcy5pc0J1c3koKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgdGhpcy5oYXNFcnJvcihmYWxzZSk7CgogICAgdGhpcy5jYWxsYmFja3MuYmVmb3JlRXhlY3V0ZSgpOwoKICAgIHRoaXMudmFsaWRhdGUoKTsKICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgdGhpcy5jYWxsYmFja3MuaW52YWxpZCgpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKHRoaXMuY2FsbGJhY2tzLmNhbkV4ZWN1dGUoKSA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdGhpcy5pc0J1c3kodHJ1ZSk7CgogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgRXhlY3V0YWJsZS5wcm90b3R5cGUub25FcnJvciA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuaGFzRXJyb3IodHJ1ZSk7CiAgICBpZigidmlvbGF0aW9ucyIgaW4gdGhpcy5yZXN1bHQgJiYgdGhpcy5yZXN1bHQudmlvbGF0aW9ucyAhPSBudWxsKQogICAgICB0aGlzLmFwcGx5VmlvbGF0aW9ucyh0aGlzLnJlc3VsdC52aW9sYXRpb25zKTsKICAgIHRoaXMuY2FsbGJhY2tzLmVycm9yKHRoaXMucmVzdWx0KTsKICB9OwoKICBFeGVjdXRhYmxlLnByb3RvdHlwZS5vblN1Y2Nlc3MgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmhhc0Vycm9yKGZhbHNlKTsKICAgIHRoaXMuY2xlYXJWYWxpZGF0aW9uTWVzc2FnZXMoKTsKICAgIHRoaXMuY2FsbGJhY2tzLnN1Y2Nlc3ModGhpcy5yZXN1bHQpOwogICAgdGhpcy5jYWxsYmFja3MucmVzdWx0KHRoaXMucmVzdWx0LnJlc3VsdCk7CiAgfTsKCiAgRXhlY3V0YWJsZS5wcm90b3R5cGUub25Db21wbGV0ZSA9IGZ1bmN0aW9uICgpIHsKICAgIGlmICghdGhpcy5oYXNFcnJvcigpKSB7CiAgICAgIHRoaXMuY2FsbGJhY2tzLmNvbXBsZXRlKHRoaXMucmVzdWx0KTsKICAgICAgdGhpcy5jbGVhclZhbGlkYXRpb25NZXNzYWdlcygpOwogICAgfQogICAgdGhpcy5pc0J1c3koZmFsc2UpOwogIH07CiAgCiAgRXhlY3V0YWJsZS5Db21tYW5kID0gImNvbW1hbmQiOwogIEV4ZWN1dGFibGUuUXVlcnkgPSAicXVlcnkiOwogIAogIHJldHVybiBFeGVjdXRhYmxlOwp9KTsKZGVmaW5lKCdkZWNvL2FqYXgnLFtdLCBmdW5jdGlvbigpewogIGZ1bmN0aW9uIGRhdGFUb1BhcmFtcyhkYXRhKXsKICAgIHZhciBwYXJhbXMgPSBbXQogICAgZm9yKHZhciBrZXkgaW4gZGF0YSl7CiAgICAgIHZhciB2YWx1ZSA9IGRhdGFba2V5XTsKICAgICAgcGFyYW1zLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpKTsKICAgIH0KICAgIHJldHVybiBwYXJhbXMuam9pbigiJiIpOwogIH0KCiAgZnVuY3Rpb24gYWRkUGFyYW1Ub1VybCh1cmwsIG5hbWUsIHZhbHVlKXsKICAgIHJldHVybiB1cmwgKyAodXJsLm1hdGNoKC9cPy8pID8gKHVybC5tYXRjaCgvJiQvKSA/ICIiIDogIiYiKSA6ICI/IikgKyBlbmNvZGVVUklDb21wb25lbnQobmFtZSkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpOwogIH0KCiAgZnVuY3Rpb24gYWRkUGFyYW1zVG9VcmwodXJsLCBkYXRhKXsKICAgIHZhciBwYXJhbXMgPSBkYXRhVG9QYXJhbXMoZGF0YSk7CiAgICByZXR1cm4gdXJsICsgKHVybC5tYXRjaCgvXD8vKSA/ICh1cmwubWF0Y2goLyYkLykgPyAiIiA6IChwYXJhbXMubGVuZ3RoID4gMCA/ICImIiA6ICIiKSkgOiAiPyIpICsgcGFyYW1zOwogIH0KCiAgZnVuY3Rpb24gYWRkVG9QYXRoKHVybCwgc2VnbWVudCl7CiAgICByZXR1cm4gdXJsICsgKHVybC5tYXRjaCgvXC8kLykgPyAiIiA6ICIvIikgKyBzZWdtZW50OwogIH0KCiAgZnVuY3Rpb24gY2FjaGVCdXN0KHVybCl7CiAgICByZXR1cm4gYWRkUGFyYW1Ub1VybCh1cmwsICJjYWNoZUtleSIsIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSpNYXRoLnBvdygyLDUzKSkpOwogIH0KCiAgZnVuY3Rpb24gYWpheCh1cmwsIG9iamVjdCwgbWV0aG9kLCBjYWxsYmFjayl7CiAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAKICAgIHZhciBpc1Bvc3QgPSAobWV0aG9kID09PSAiUE9TVCIpOwogICAgdmFyIGRhdGEgPSBudWxsOwogICAgCiAgICBpZihvYmplY3QpewoKICAgICAgaWYoaXNQb3N0KXsKICAgICAgICBkYXRhID0gZGF0YVRvUGFyYW1zKG9iamVjdCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdXJsID0gYWRkUGFyYW1zVG9VcmwodXJsLCBvYmplY3QpOwogICAgICB9CiAgICB9CiAgICAKICAgIGlmKGlzUG9zdCl7CiAgICAgIHVybCA9IGNhY2hlQnVzdCh1cmwpOwogICAgfQoKICAgIHhoci5vcGVuKG1ldGhvZCwgdXJsLCB0cnVlKTsKICAgIAogICAgaWYoaXNQb3N0ICYmIGRhdGEpewogICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcigiQ29udGVudC10eXBlIiwgImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIpOwogICAgfQogICAgCiAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1SZXF1ZXN0ZWQtV2l0aCcsICdYTUxIdHRwUmVxdWVzdCcpOwogICAgCiAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKXsKICAgICAgaWYoeGhyLnJlYWR5U3RhdGUgPT0gNCl7CiAgICAgICAgY2FsbGJhY2soeGhyKTsKICAgICAgfQogICAgfQogICAgCiAgICB4aHIuc2VuZChkYXRhKTsKICAgIHJldHVybiB4aHI7CiAgfQoKICBhamF4LmFkZFBhcmFtVG9VcmwgPSBhZGRQYXJhbVRvVXJsOwogIGFqYXguYWRkUGFyYW1zVG9VcmwgPSBhZGRQYXJhbXNUb1VybDsKICBhamF4LmFkZFRvUGF0aCA9IGFkZFRvUGF0aDsKICBhamF4LmNhY2hlQnVzdCA9IGNhY2hlQnVzdDsKCgogIHJldHVybiBhamF4Owp9KTsKZGVmaW5lKCdkZWNvL3F2Yy9Db25zdHJhaW50UmVzb2x2ZXInLFtdLCBmdW5jdGlvbigpewoKICB2YXIgU1RBVEVfTE9BRElORyA9ICdsb2FkaW5nJzsKICB2YXIgU1RBVEVfTE9BREVEID0gJ2xvYWRlZCc7CgogIGZ1bmN0aW9uIGZpbmRDb25zdHJhaW50KG5hbWUsIGNvbnN0cmFpbnRzKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbnN0cmFpbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChjb25zdHJhaW50c1tpXS5uYW1lID09IG5hbWUpIHsKICAgICAgICByZXR1cm4gY29uc3RyYWludHNbaV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGNvbnN0cmFpbnRzTG9hZGVkKG5hbWUsIGZpZWxkcyl7CiAgICB2YXIgY29uc3RyYWludCA9IGZpbmRDb25zdHJhaW50KG5hbWUsIHRoaXMuY29uc3RyYWludHMpOwogICAgaWYoY29uc3RyYWludCl7CiAgICAgIGNvbnN0cmFpbnQudmFsaWRhdGFibGVzLmZvckVhY2goZnVuY3Rpb24odmFsaWRhdGFibGUpewogICAgICAgIHZhbGlkYXRhYmxlLmFwcGx5Q29uc3RyYWludHMoZmllbGRzKTsKICAgICAgfSk7CiAgICAgIGNvbnN0cmFpbnQuZmllbGRzID0gZmllbGRzOwogICAgICBjb25zdHJhaW50LnN0YXRlID0gU1RBVEVfTE9BREVEOwogICAgICBjb25zdHJhaW50LnZhbGlkYXRhYmxlcyA9IFtdOwogICAgfQogIH0KCgogIGZ1bmN0aW9uIENvbnN0cmFpbnRSZXNvbHZlcihxdmMpewogICAgdGhpcy5xdmMgPSBxdmM7CiAgICB0aGlzLmNvbnN0cmFpbnRzID0gW107CiAgfQogIAogIENvbnN0cmFpbnRSZXNvbHZlci5wcm90b3R5cGUuYXBwbHlWYWxpZGF0aW9uQ29uc3RyYWludHMgPSBmdW5jdGlvbihuYW1lLCB2YWxpZGF0YWJsZSl7CiAgICB2YXIgY29uc3RyYWludCA9IGZpbmRDb25zdHJhaW50KG5hbWUsIHRoaXMuY29uc3RyYWludHMpOwogICAgaWYoY29uc3RyYWludCA9PT0gZmFsc2UpewogICAgICB0aGlzLmNvbnN0cmFpbnRzLnB1c2goewogICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgc3RhdGU6IFNUQVRFX0xPQURJTkcsCiAgICAgICAgdmFsaWRhdGFibGVzOiBbdmFsaWRhdGFibGVdCiAgICAgIH0pOwogICAgICB0aGlzLnF2Yy5sb2FkQ29uc3RyYWludHMobmFtZSwgY29uc3RyYWludHNMb2FkZWQuYmluZCh0aGlzKSk7CiAgICB9ZWxzZXsKICAgICAgaWYoY29uc3RyYWludC5zdGF0ZSA9PT0gU1RBVEVfTE9BRElORyl7CiAgICAgICAgY29uc3RyYWludC52YWxpZGF0YWJsZXMucHVzaCh2YWxpZGF0YWJsZSk7CiAgICAgIH1lbHNlewogICAgICAgIHZhbGlkYXRhYmxlLmFwcGx5Q29uc3RyYWludHMoY29uc3RyYWludC5maWVsZHMpOwogICAgICB9CiAgICB9CiAgfTsKICAKICByZXR1cm4gQ29uc3RyYWludFJlc29sdmVyOwp9KTsKZGVmaW5lKCdkZWNvL2Vycm9ySGFuZGxlcicsW10sIGZ1bmN0aW9uKCl7CiAgcmV0dXJuIHsKICAgIG9uRXJyb3I6IGZ1bmN0aW9uKGVycm9yKXsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIHRocm93IGVycm9yOwogICAgICB9LDEpOwogICAgfQogIH07Cn0pOwpkZWZpbmUoJ2RlY28vcXZjJyxbCiAgImRlY28vcXZjL0V4ZWN1dGFibGUiLCAKICAiZGVjby9xdmMvRXhlY3V0YWJsZVJlc3VsdCIsIAogICJkZWNvL3V0aWxzIiwgCiAgImRlY28vYWpheCIsCiAgImRlY28vcXZjL0NvbnN0cmFpbnRSZXNvbHZlciIsCiAgImRlY28vZXJyb3JIYW5kbGVyIiwKICAia25vY2tvdXQiLCAKICAiZGVjby9xdmMva29FeHRlbnNpb25zIl0sIAogIGZ1bmN0aW9uKAogICAgRXhlY3V0YWJsZSwKICAgIEV4ZWN1dGFibGVSZXN1bHQsCiAgICB1dGlscywKICAgIGFqYXgsCiAgICBDb25zdHJhaW50UmVzb2x2ZXIsCiAgICBlcnJvckhhbmRsZXIsCiAgICBrbyl7CiAgCiAgZnVuY3Rpb24gUVZDKCl7CgogICAgdmFyIHF2YyA9IHRoaXM7CgogICAgdGhpcy5jb25zdHJhaW50UmVzb2x2ZXIgPSBuZXcgQ29uc3RyYWludFJlc29sdmVyKHF2Yyk7CgogICAgdGhpcy5leGVjdXRlID0gZnVuY3Rpb24oZXhlY3V0YWJsZSl7CiAgICAgIHZhciBwYXJhbWV0ZXJzID0ga28udG9KUyhleGVjdXRhYmxlLnBhcmFtZXRlcnMpOwogICAgICB2YXIgZGF0YSA9IHsKICAgICAgICBwYXJhbWV0ZXJzOiBKU09OLnN0cmluZ2lmeShwYXJhbWV0ZXJzKSwKICAgICAgICBjc3JmVG9rZW46IHF2Yy5jb25maWcuY3NyZgogICAgICB9OwogICAgICB2YXIgdXJsID0gYWpheC5hZGRUb1BhdGgocXZjLmNvbmZpZy5iYXNlVXJsLCBleGVjdXRhYmxlLnR5cGUgKyAiLyIgKyBleGVjdXRhYmxlLm5hbWUpOwogICAgICBhamF4KHVybCwgZGF0YSwgIlBPU1QiLCBmdW5jdGlvbiAoeGhyKSB7CiAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgZXhlY3V0YWJsZS5yZXN1bHQgPSBuZXcgRXhlY3V0YWJsZVJlc3VsdChKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQgfHwgInt9IikpOwogICAgICAgICAgaWYgKGV4ZWN1dGFibGUucmVzdWx0LnN1Y2Nlc3MgPT09IHRydWUpIHsKICAgICAgICAgICAgZXhlY3V0YWJsZS5vblN1Y2Nlc3MoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmKGV4ZWN1dGFibGUucmVzdWx0LmV4Y2VwdGlvbiAmJiBleGVjdXRhYmxlLnJlc3VsdC5leGNlcHRpb24ubWVzc2FnZSl7CiAgICAgICAgICAgICAgZXJyb3JIYW5kbGVyLm9uRXJyb3IoZXhlY3V0YWJsZS5yZXN1bHQuZXhjZXB0aW9uLm1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGV4ZWN1dGFibGUub25FcnJvcigpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBleGVjdXRhYmxlLnJlc3VsdCA9IG5ldyBFeGVjdXRhYmxlUmVzdWx0KHtleGNlcHRpb246IHttZXNzYWdlOiB4aHIucmVzcG9uc2VUZXh0LCBjYXVzZTogeGhyfX0pOwogICAgICAgICAgZXJyb3JIYW5kbGVyLm9uRXJyb3IoZXhlY3V0YWJsZS5yZXN1bHQuZXhjZXB0aW9uLm1lc3NhZ2UpOwogICAgICAgICAgZXhlY3V0YWJsZS5vbkVycm9yKCk7CiAgICAgICAgfQogICAgICAgIGV4ZWN1dGFibGUub25Db21wbGV0ZSgpOwogICAgICB9KTsKICAgIAogICAgfTsKICAgIAogICAgdGhpcy5sb2FkQ29uc3RyYWludHMgPSBmdW5jdGlvbihuYW1lLCBjYWxsYmFjayl7CiAgICAgIHZhciB1cmwgPSBhamF4LmFkZFRvUGF0aChxdmMuY29uZmlnLmJhc2VVcmwsICJjb25zdHJhaW50cy8iICsgbmFtZSk7CiAgICAgIGFqYXgodXJsLCBudWxsLCAiR0VUIiwgZnVuY3Rpb24oeGhyKXsKICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgICB0cnl7CiAgICAgICAgICAgIHZhciByZXNwb25zZSA9IEpTT04ucGFyc2UoeGhyLnJlc3BvbnNlVGV4dCB8fCAie1wicGFyYW1ldGVyc1wiOltdfSIpOwogICAgICAgICAgICBpZigicGFyYW1ldGVycyIgaW4gcmVzcG9uc2UgPT0gZmFsc2UpewogICAgICAgICAgICAgIHJlc3BvbnNlLnBhcmFtZXRlcnMgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZihyZXNwb25zZS5leGNlcHRpb24gJiYgcmVzcG9uc2UuZXhjZXB0aW9uLm1lc3NhZ2UpewogICAgICAgICAgICAgIGVycm9ySGFuZGxlci5vbkVycm9yKHJlc3BvbnNlLmV4Y2VwdGlvbi5tZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfWNhdGNoKGUpewogICAgICAgICAgICB2YXIgcmVzcG9uc2UgPSB7cGFyYW1ldGVyczogW119OwogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2sobmFtZSwgcmVzcG9uc2UucGFyYW1ldGVycyk7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICBlcnJvckhhbmRsZXIub25FcnJvcih4aHIucmVzcG9uc2VUZXh0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfTsKCiAgICAKICAgIHRoaXMuY29uZmlnID0gewogICAgICBiYXNlVXJsOiAiLyIsCiAgICAgIGNzcmY6ICIiCiAgICB9CiAgfTsKCiAgdmFyIHF2YyA9IG5ldyBRVkMoKTsKICAKICBmdW5jdGlvbiBjcmVhdGVFeGVjdXRhYmxlKG5hbWUsIHR5cGUsIHBhcmFtZXRlcnMsIGNhbGxiYWNrcyl7ICAKICAgIHZhciBleGVjdXRhYmxlID0gbmV3IEV4ZWN1dGFibGUobmFtZSwgdHlwZSwgcGFyYW1ldGVycyB8fCB7fSwgY2FsbGJhY2tzIHx8IHt9LCBxdmMpOwogICAgdmFyIGV4ZWN1dGUgPSBleGVjdXRhYmxlLmV4ZWN1dGUuYmluZChleGVjdXRhYmxlKTsKICAgIGV4ZWN1dGUuaXNWYWxpZCA9IGtvLmNvbXB1dGVkKGV4ZWN1dGFibGUuaXNWYWxpZCwgZXhlY3V0YWJsZSk7CiAgICBleGVjdXRlLmlzQnVzeSA9IGtvLmNvbXB1dGVkKGV4ZWN1dGFibGUuaXNCdXN5LCBleGVjdXRhYmxlKTsKICAgIGV4ZWN1dGUuaGFzRXJyb3IgPSBrby5jb21wdXRlZChleGVjdXRhYmxlLmhhc0Vycm9yLCBleGVjdXRhYmxlKTsKICAgIGV4ZWN1dGUuc3VjY2VzcyA9IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgZXhlY3V0YWJsZS5jYWxsYmFja3Muc3VjY2VzcyA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gZXhlY3V0ZTsKICAgIH07CiAgICBleGVjdXRlLmVycm9yID0gZnVuY3Rpb24oY2FsbGJhY2spewogICAgICBleGVjdXRhYmxlLmNhbGxiYWNrcy5lcnJvciA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gZXhlY3V0ZTsKICAgIH07CiAgICBleGVjdXRlLmludmFsaWQgPSBmdW5jdGlvbihjYWxsYmFjayl7CiAgICAgIGV4ZWN1dGFibGUuY2FsbGJhY2tzLmludmFsaWQgPSBjYWxsYmFjazsKICAgICAgcmV0dXJuIGV4ZWN1dGU7CiAgICB9OwogICAgZXhlY3V0ZS5iZWZvcmVFeGVjdXRlID0gZnVuY3Rpb24oY2FsbGJhY2spewogICAgICBleGVjdXRhYmxlLmNhbGxiYWNrcy5iZWZvcmVFeGVjdXRlID0gY2FsbGJhY2s7CiAgICAgIHJldHVybiBleGVjdXRlOwogICAgfTsKICAgIGV4ZWN1dGUuY2FuRXhlY3V0ZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgZXhlY3V0YWJsZS5jYWxsYmFja3MuY2FuRXhlY3V0ZSA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gZXhlY3V0ZTsKICAgIH07CiAgICBleGVjdXRlLnJlc3VsdCA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT0gMSl7CiAgICAgICAgZXhlY3V0YWJsZS5jYWxsYmFja3MucmVzdWx0ID0gYXJndW1lbnRzWzBdOwogICAgICAgIHJldHVybiBleGVjdXRlOwogICAgICB9CiAgICAgIHJldHVybiBleGVjdXRhYmxlLnJlc3VsdC5yZXN1bHQ7CiAgICB9OwogICAgZXhlY3V0ZS5jb21wbGV0ZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgZXhlY3V0YWJsZS5jYWxsYmFja3MuY29tcGxldGUgPSBjYWxsYmFjazsKICAgICAgcmV0dXJuIGV4ZWN1dGU7CiAgICB9OwogICAgZXhlY3V0ZS5jbGVhclZhbGlkYXRpb25NZXNzYWdlcyA9IGV4ZWN1dGFibGUuY2xlYXJWYWxpZGF0aW9uTWVzc2FnZXMuYmluZChleGVjdXRhYmxlKTsKICAgIGV4ZWN1dGUudmFsaWRhdG9yID0gZXhlY3V0YWJsZS52YWxpZGF0b3I7CiAgICBleGVjdXRlLnBhcmFtZXRlcnMgPSBleGVjdXRhYmxlLnBhcmFtZXRlcnM7CiAgICBleGVjdXRlLnZhbGlkYXRlID0gZXhlY3V0YWJsZS52YWxpZGF0ZS5iaW5kKGV4ZWN1dGFibGUpOwogICAgCiAgICByZXR1cm4gZXhlY3V0ZTsKICB9CiAgCiAgcmV0dXJuIHsKICAgIGNyZWF0ZUNvbW1hbmQ6IGZ1bmN0aW9uKG5hbWUsIHBhcmFtZXRlcnMsIGNhbGxiYWNrcyl7CiAgICAgIGlmKG5hbWUgPT0gbnVsbCB8fCBuYW1lLmxlbmd0aCA9PSAwKQogICAgICAgIHRocm93IG5ldyBFcnJvcigiQ29tbWFuZCBpcyBtaXNzaW5nIG5hbWVcbkEgY29tbWFuZCBtdXN0IGhhdmUgYSBuYW1lIVxudXNhZ2U6IGNyZWF0ZUNvbW1hbmQoJ25hbWUnLCBbcGFyYW1ldGVycywgY2FsbGJhY2tzXSkiKTsKICAgICAgcmV0dXJuIGNyZWF0ZUV4ZWN1dGFibGUobmFtZSwgRXhlY3V0YWJsZS5Db21tYW5kLCBwYXJhbWV0ZXJzLCBjYWxsYmFja3MpOwogICAgfSwKICAgIGNyZWF0ZVF1ZXJ5OiBmdW5jdGlvbihuYW1lLCBwYXJhbWV0ZXJzLCBjYWxsYmFja3MpewogICAgICBpZihuYW1lID09IG51bGwgfHwgbmFtZS5sZW5ndGggPT0gMCkKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlF1ZXJ5IGlzIG1pc3NpbmcgbmFtZVxuQSBxdWVyeSBtdXN0IGhhdmUgYSBuYW1lIVxudXNhZ2U6IGNyZWF0ZVF1ZXJ5KCduYW1lJywgW3BhcmFtZXRlcnMsIGNhbGxiYWNrc10pIik7CiAgICAgIHJldHVybiBjcmVhdGVFeGVjdXRhYmxlKG5hbWUsIEV4ZWN1dGFibGUuUXVlcnksIHBhcmFtZXRlcnMsIGNhbGxiYWNrcyk7CiAgICB9LAogICAgY29uZmlnOiBmdW5jdGlvbihjb25maWcpewogICAgICB1dGlscy5leHRlbmQocXZjLmNvbmZpZywgY29uZmlnKTsKICAgIH0KICB9Cn0pOwpkZWZpbmUoJ2RlY28vc3BhL091dGxldCcsWwogICJrbm9ja291dCIKXSwgZnVuY3Rpb24oCiAga28KKXsKCiAgZnVuY3Rpb24gT3V0bGV0KGVsZW1lbnQsIGRvY3VtZW50KXsKICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICB0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQgfHwgd2luZG93LmRvY3VtZW50OwogIH0KCiAgT3V0bGV0LnByb3RvdHlwZS5vdXRsZXRFeGlzdHMgPSBmdW5jdGlvbigpewogICAgcmV0dXJuIHRoaXMuZWxlbWVudCAhPSBudWxsOwogIH07CgogIE91dGxldC5wcm90b3R5cGUudW5sb2FkQ3VycmVudFBhZ2UgPSBmdW5jdGlvbigpewogICAga28uY2xlYW5Ob2RlKHRoaXMuZWxlbWVudCk7CiAgICB0aGlzLmVsZW1lbnQuaW5uZXJIVE1MID0gIiI7CiAgfTsKCiAgT3V0bGV0LnByb3RvdHlwZS5zZXRQYWdlQ29udGVudCA9IGZ1bmN0aW9uKGNvbnRlbnQpewogICAgdGhpcy5lbGVtZW50LmlubmVySFRNTCA9IGNvbnRlbnQ7CiAgfTsKCiAgT3V0bGV0LnByb3RvdHlwZS5nZXRQYWdlVGl0bGUgPSBmdW5jdGlvbigpewogICAgdmFyIHRpdGxlTWV0YVRhZyA9IHRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yKCJtZXRhW25hbWU9dGl0bGVdIik7CiAgICByZXR1cm4gKHRpdGxlTWV0YVRhZyAmJiB0aXRsZU1ldGFUYWcuZ2V0QXR0cmlidXRlKCJjb250ZW50IikpOwogIH07CgogIE91dGxldC5wcm90b3R5cGUuc2V0RG9jdW1lbnRUaXRsZSA9IGZ1bmN0aW9uKHRpdGxlKXsKICAgIHRoaXMuZG9jdW1lbnQudGl0bGUgPSB0aXRsZTsKICB9OwoKICBPdXRsZXQucHJvdG90eXBlLmV4dHJhY3RBbmRSdW5QYWdlSmF2YVNjcmlwdCA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgc2NyaXB0cyA9IHRoaXMuZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCJzY3JpcHRbdHlwZT0ndGV4dC9qYXZhc2NyaXB0J10iKTsKICAgIGZvcih2YXIgaT0wOyBpPHNjcmlwdHMubGVuZ3RoOyBpKyspewogICAgICBzY3JpcHRzW2ldLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2NyaXB0c1tpXSk7CiAgICAgIGlmKHNjcmlwdHNbaV0uaWQgPT09ICcnKSB0aHJvdyBuZXcgRXJyb3IoIlRoZSBzY3JpcHQgbXVzdCBoYXZlIGFuIGlkIik7CiAgICAgIGlmKHRoaXMuZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoc2NyaXB0c1tpXS5pZCkgPT0gbnVsbCl7CiAgICAgICAgdmFyIHNjcmlwdCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LmlkID0gc2NyaXB0c1tpXS5pZDsKICAgICAgICBzY3JpcHQudGV4dCA9IHNjcmlwdHNbaV0udGV4dENvbnRlbnQ7CiAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgndHlwZScsIHNjcmlwdHNbaV0uZ2V0QXR0cmlidXRlKCd0eXBlJykpOwogICAgICAgIHRoaXMuZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgICB9CiAgICB9CiAgfTsKCiAgT3V0bGV0LnByb3RvdHlwZS5pbmRpY2F0ZVBhZ2VJc0xvYWRpbmcgPSBmdW5jdGlvbigpewogICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSgiZGF0YS1sb2FkaW5nIiwgInRydWUiKTsKICB9OwoKICBPdXRsZXQucHJvdG90eXBlLnBhZ2VIYXNMb2FkZWQgPSBmdW5jdGlvbigpewogICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSgiZGF0YS1sb2FkaW5nIiwgImZhbHNlIik7CiAgfTsKCiAgcmV0dXJuIE91dGxldDsKCn0pOwpkZWZpbmUoJ2RlY28vc3BhL3doZW5Db250ZXh0JyxbCiAgCl0sIGZ1bmN0aW9uKAogIAopewoKICBmdW5jdGlvbiB1bnN1YnNjcmliZShldmVudCwgcmVhY3Rpb24pewogICAgZXZlbnQuZG9udChyZWFjdGlvbik7CiAgfQoKICBmdW5jdGlvbiBzdWJzY3JpYmUoZXZlbnQsIHJlYWN0aW9uKXsKICAgIGV2ZW50KHJlYWN0aW9uKTsKICAgIHJldHVybiBldmVudC5kb250LmJpbmQobnVsbCwgcmVhY3Rpb24pOwogIH0KCiAgZnVuY3Rpb24gd2hlblNvbWV0aGluZygpewogICAgaWYodGhpcy5kZXN0cm95ZWQpIHRocm93IG5ldyBFcnJvcigiVGhpcyBjb250ZXh0IGhhcyBiZWVuIGRlc3Ryb3llZCEiKTsKCiAgICBpZihhcmd1bWVudHMubGVuZ3RoID09IDApewogICAgICB2YXIgY2hpbGRDb250ZXh0ID0gY3JlYXRlQ29udGV4dCgpOwogICAgICB0aGlzLmNoaWxkQ29udGV4dHMucHVzaChjaGlsZENvbnRleHQpOwogICAgICByZXR1cm4gY2hpbGRDb250ZXh0LndoZW47CiAgICB9ZWxzZSBpZihhcmd1bWVudHMubGVuZ3RoID09IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gImZ1bmN0aW9uIil7CiAgICAgIHJldHVybiB7CiAgICAgICAgZG9udDogdW5zdWJzY3JpYmUuYmluZChudWxsLCBhcmd1bWVudHNbMF0pCiAgICAgIH0KICAgIH1lbHNlIGlmKGFyZ3VtZW50cy5sZW5ndGggPT0gMiAmJiB0eXBlb2YgYXJndW1lbnRzWzFdID09PSAiZnVuY3Rpb24iKXsKICAgICAgdGhpcy5ldmVudFN1YnNjcmliZXJzLnB1c2goc3Vic2NyaWJlKGFyZ3VtZW50c1swXSwgYXJndW1lbnRzWzFdKSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB0aGlzSXNEZXN0cm95ZWQocmVhY3Rpb24pewogICAgdGhpcy5vbkRlc3Ryb3lMaXN0ZW5lcnMucHVzaChyZWFjdGlvbik7CiAgfQoKICBmdW5jdGlvbiBkZXN0cm95Q2hpbGRDb250ZXh0cygpewogICAgdmFyIGNvbnRleHQ7CiAgICB3aGlsZShjb250ZXh0ID0gdGhpcy5jaGlsZENvbnRleHRzLnBvcCgpKQogICAgICBjb250ZXh0LmRlc3Ryb3lDb250ZXh0KCk7CiAgfQoKICBmdW5jdGlvbiBkZXN0cm95Q29udGV4dCgpewogICAgdmFyIHN1YnNjcmliZXIsIGxpc3RlbmVyLCBjb250ZXh0OwogICAgd2hpbGUoc3Vic2NyaWJlciA9IHRoaXMuZXZlbnRTdWJzY3JpYmVycy5wb3AoKSkKICAgICAgc3Vic2NyaWJlcigpOwogICAgd2hpbGUobGlzdGVuZXIgPSB0aGlzLm9uRGVzdHJveUxpc3RlbmVycy5wb3AoKSkKICAgICAgbGlzdGVuZXIoKTsKICAgIHdoaWxlKGNvbnRleHQgPSB0aGlzLmNoaWxkQ29udGV4dHMucG9wKCkpCiAgICAgIGNvbnRleHQuZGVzdHJveUNvbnRleHQoKTsKICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUNvbnRleHQoKXsKICAgIHZhciBjb250ZXh0ID0gewogICAgICBkZXN0cm95ZWQ6IGZhbHNlLAogICAgICBvbkRlc3Ryb3lMaXN0ZW5lcnM6IFtdLAogICAgICBjaGlsZENvbnRleHRzOiBbXSwKICAgICAgZXZlbnRTdWJzY3JpYmVyczogW10KICAgIH07CgogICAgdmFyIHdoZW4gPSB3aGVuU29tZXRoaW5nLmJpbmQoY29udGV4dCk7CgogICAgd2hlbi50aGlzSXNEZXN0cm95ZWQgPSB0aGlzSXNEZXN0cm95ZWQuYmluZChjb250ZXh0KTsKCiAgICB3aGVuLmRlc3Ryb3lDaGlsZENvbnRleHRzID0gZGVzdHJveUNoaWxkQ29udGV4dHMuYmluZChjb250ZXh0KTsKCiAgICByZXR1cm4gewogICAgICB3aGVuOiB3aGVuLAogICAgICBkZXN0cm95Q29udGV4dDogZGVzdHJveUNvbnRleHQuYmluZChjb250ZXh0KQogICAgfTsKICB9CgogIHJldHVybiBjcmVhdGVDb250ZXh0KCkud2hlbjsKfSk7CmRlZmluZSgnZGVjby9zcGEvYXBwbHlWaWV3TW9kZWxzJyxbCiAgImRlY28vdXRpbHMiLAogICJkZWNvL2Vycm9ySGFuZGxlciIsCiAgImtub2Nrb3V0IiwgCiAgIndoZW4iLCAKICAid2hlbi9jYWxsYmFja3MiCl0sIGZ1bmN0aW9uICgKICB1dGlscywgCiAgZXJyb3JIYW5kbGVyLAogIGtvLCAKICB3aGVuLCAKICBjYWxsYmFja3MKKSB7CgoKICBmdW5jdGlvbiBnZXRBdHRyaWJ1dGVzKHRhcmdldCl7CgogICAgdmFyIHZpZXdNb2RlbE5hbWUgPSB0YXJnZXQuZ2V0QXR0cmlidXRlKCJkYXRhLXZpZXdtb2RlbCIpOwogICAgdmFyIG1vZGVsID0gdGFyZ2V0LmdldEF0dHJpYnV0ZSgiZGF0YS1tb2RlbCIpOwogICAgaWYgKG1vZGVsICYmIG1vZGVsLmluZGV4T2YoInsiKSA9PSAwKSB7CiAgICAgIG1vZGVsID0gSlNPTi5wYXJzZShtb2RlbCk7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgdGFyZ2V0OiB0YXJnZXQsCiAgICAgIHZpZXdNb2RlbE5hbWU6IHZpZXdNb2RlbE5hbWUsCiAgICAgIG1vZGVsOiBtb2RlbAogICAgfTsKICB9CgoKICBmdW5jdGlvbiBsb2FkVmlld01vZGVsKGRhdGEpewoKICAgIHJldHVybiBjYWxsYmFja3MuY2FsbChyZXF1aXJlLCBbCiAgICAgIGRhdGEudmlld01vZGVsTmFtZQogICAgXSkudGhlbihmdW5jdGlvbihWaWV3TW9kZWwpewogICAgICBkYXRhLlZpZXdNb2RlbCA9IFZpZXdNb2RlbDsKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9LCBmdW5jdGlvbihlcnJvcil7CiAgICAgIGVycm9ySGFuZGxlci5vbkVycm9yKG5ldyBFcnJvcigiQ291bGQgbm90IGxvYWQgdGhlIGZvbGxvd2luZyBtb2R1bGVzOlxuIitlcnJvci5yZXF1aXJlTW9kdWxlcy5qb2luKCJcbiIpKSk7CiAgICAgIHJldHVybiBudWxsOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBhcHBseVZpZXdNb2RlbChzdWJzY3JpYmUsIGRhdGEpIHsKICAgIHRyeXsKICAgICAgdmFyIHZpZXdNb2RlbCA9IG5ldyBkYXRhLlZpZXdNb2RlbChkYXRhLm1vZGVsIHx8IHt9LCBzdWJzY3JpYmUpOwogICAgICBrby5hcHBseUJpbmRpbmdzKHZpZXdNb2RlbCwgZGF0YS50YXJnZXQpOwogICAgfWNhdGNoKGUpewogICAgICBlcnJvckhhbmRsZXIub25FcnJvcihlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHZpZXdNb2RlbExvYWRlZFN1Y2Nlc3NmdWxseShkYXRhKXsKICAgIHJldHVybiBkYXRhICE9IG51bGwgJiYgZGF0YS5WaWV3TW9kZWwgIT0gbnVsbDsKICB9CgogIHJldHVybiBmdW5jdGlvbiAoZG9tRWxlbWVudCwgc3Vic2NyaWJlKSB7CgogICAgZG9tRWxlbWVudCA9IGRvbUVsZW1lbnQgfHwgZG9jdW1lbnQuYm9keTsKCiAgICB2YXIgZWxlbWVudExpc3QgPSB1dGlscy50b0FycmF5KGRvbUVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgiKltkYXRhLXZpZXdtb2RlbF0iKSk7CgogICAgdmFyIHZpZXdNb2RlbHNMb2FkZWQgPSBlbGVtZW50TGlzdC5tYXAoZ2V0QXR0cmlidXRlcykubWFwKGxvYWRWaWV3TW9kZWwpOwoKICAgIHJldHVybiB3aGVuLmFsbCh2aWV3TW9kZWxzTG9hZGVkKS50aGVuKGZ1bmN0aW9uKGxpc3QpewogICAgICBsaXN0LmZpbHRlcih2aWV3TW9kZWxMb2FkZWRTdWNjZXNzZnVsbHkpLmZvckVhY2goYXBwbHlWaWV3TW9kZWwuYmluZChudWxsLCBzdWJzY3JpYmUpKQogICAgfSk7CiAgfTsKfSk7CmRlZmluZSgnZGVjby9zcGEvaGFzaE5hdmlnYXRpb24nLFsKICAiZGVjby91dGlscyIKXSxmdW5jdGlvbigKICBfCil7CgoKICAKICBmdW5jdGlvbiBuZXdQYXRoKGN1cnJlbnRQYXRoLCBsaW5rLCBpbmRleCl7CiAgICB2YXIgaXNSZWxhdGl2ZSA9IF8uc3RhcnRzV2l0aChsaW5rLCAnLycpID09PSBmYWxzZTsKICAgIHZhciBpc0ZvbGRlciA9IF8uZW5kc1dpdGgobGluaywgJy8nKTsKICAgIAogICAgaWYobGluayA9PT0gIi8iKXsKICAgICAgdmFyIHBhdGggPSBbXTsKICAgIH1lbHNlIGlmKGxpbmsgPT09ICIiKXsKICAgICAgdmFyIHBhdGggPSBbaW5kZXhdOwogICAgfWVsc2V7CiAgICAgIHZhciBwYXRoID0gXy50cmltKGxpbmssICIvIikuc3BsaXQoIi8iKTsKICAgIH0KCiAgICBpZihpc0ZvbGRlcil7CiAgICAgIHBhdGgucHVzaChpbmRleCk7CiAgICB9CiAgICBpZihpc1JlbGF0aXZlKXsKICAgICAgcGF0aCA9IF8ucG9wVGFpbChjdXJyZW50UGF0aCkuY29uY2F0KHBhdGgpOwogICAgfQoKICAgIHZhciBvdXQgPSBbXTsKCiAgICBmb3IodmFyIGkgPSBwYXRoLmxlbmd0aD4+PjA7IGktLTspewogICAgICBpZihwYXRoW2ldID09PSAiIil7CiAgICAgICAgY29udGludWU7CiAgICAgIH1lbHNlIGlmKHBhdGhbaV0gPT09ICIuIil7CiAgICAgICAgY29udGludWU7CiAgICAgIH1lbHNlIGlmKHBhdGhbaV0gPT09ICIuLiIpIHsKICAgICAgICBpLS07CiAgICAgIH1lbHNlewogICAgICAgIG91dC51bnNoaWZ0KHBhdGhbaV0pOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG91dDsKICB9CgogIGZ1bmN0aW9uIGhhc2hDaGFuZ2VkKGNvbmZpZywgb25QYWdlQ2hhbmdlZCwgZG9jdW1lbnQpewoKICAgIHZhciBwYXRoID0gXy5hZnRlcihkb2N1bWVudC5sb2NhdGlvbi5ocmVmLCAnIycpOwoKICAgIHZhciBpc1JlbGF0aXZlID0gXy5zdGFydHNXaXRoKHBhdGgsICcvJykgPT0gZmFsc2U7CiAgICB2YXIgaXNGb2xkZXIgPSBfLmVuZHNXaXRoKHBhdGgsICcvJyk7CgogICAgaWYoaXNSZWxhdGl2ZSB8fCBpc0ZvbGRlcil7CiAgICAgIHZhciBuZXdIYXNoID0gbmV3UGF0aCh0aGlzLmN1cnJlbnRQYXRoLCBwYXRoLCBjb25maWcuaW5kZXgpLmpvaW4oJy8nKTsKICAgICAgZG9jdW1lbnQubG9jYXRpb24ucmVwbGFjZSgiIy8iICsgbmV3SGFzaCk7CiAgICB9ZWxzZXsKICAgICAgdGhpcy5jdXJyZW50UGF0aCA9IG5ld1BhdGgodGhpcy5jdXJyZW50UGF0aCwgcGF0aCwgY29uZmlnLmluZGV4KTsKICAgICAgb25QYWdlQ2hhbmdlZCh0aGlzLmN1cnJlbnRQYXRoLmpvaW4oJy8nKSwgdGhpcy5jdXJyZW50UGF0aC5tYXAoZnVuY3Rpb24ocCl7cmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudChwKTt9KSk7CiAgICB9CgogIH0KICAKICBmdW5jdGlvbiBzdGFydEhhc2hOYXZpZ2F0aW9uKGNvbmZpZywgb25QYWdlQ2hhbmdlZCwgZG9jLCBnbG9iYWwpewogICAgZG9jID0gZG9jIHx8IGRvY3VtZW50OwogICAgZ2xvYmFsID0gZ2xvYmFsIHx8IHdpbmRvdzsKCiAgICB2YXIgc3RhdGUgPSB7CiAgICAgIGN1cnJlbnRQYXRoOiBbXQogICAgfTsKICAgIHZhciBvbkhhc2hDaGFuZ2VkID0gaGFzaENoYW5nZWQuYmluZChzdGF0ZSwgY29uZmlnLCBvblBhZ2VDaGFuZ2VkLCBkb2MpOwogICAgb25IYXNoQ2hhbmdlZCgpOwogICAgXy5hZGRFdmVudExpc3RlbmVyKGdsb2JhbCwgImhhc2hjaGFuZ2UiLCBvbkhhc2hDaGFuZ2VkLCBmYWxzZSk7CgogICAgcmV0dXJuIHsKICAgICAgc3RvcDogZnVuY3Rpb24oKXsKICAgICAgICBnbG9iYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiaGFzaGNoYW5nZSIsIG9uSGFzaENoYW5nZWQsIGZhbHNlKTsKICAgICAgfQogICAgfTsKICB9CgoKICByZXR1cm4gewogICAgc3RhcnQ6IHN0YXJ0SGFzaE5hdmlnYXRpb24KICB9OwoKfSk7CmRlZmluZSgnZGVjby9zcGEvUGFnZUxvYWRlcicsWwogICJkZWNvL2FqYXgiCl0sIGZ1bmN0aW9uKAogIGFqYXgKKXsKCiAgZnVuY3Rpb24gUGFnZUxvYWRlcihjb25maWcpewogICAgdGhpcy5wYXRoVG9VcmwgPSBjb25maWcgJiYgY29uZmlnLnBhdGhUb1VybCB8fCBmdW5jdGlvbihhKXsgcmV0dXJuIGE7IH07CiAgICB0aGlzLmNhY2hlID0gKGNvbmZpZyAmJiAnY2FjaGVQYWdlcycgaW4gY29uZmlnID8gY29uZmlnLmNhY2hlUGFnZXMgOiB0cnVlKTsKICAgIHRoaXMuY3VycmVudFhIUiA9IG51bGw7CiAgfQoKICBQYWdlTG9hZGVyLnByb3RvdHlwZS5sb2FkUGFnZSA9IGZ1bmN0aW9uKHBhdGgsIHJlc29sdmVyKXsKCiAgICB0aGlzLmFib3J0KCk7CgogICAgdmFyIHVybCA9IHRoaXMucGF0aFRvVXJsKHBhdGgpOwoKICAgIGlmKHRoaXMuY2FjaGUgPT09IGZhbHNlKQogICAgICB1cmwgPSBhamF4LmNhY2hlQnVzdCh1cmwpOwoKICAgIHRoaXMuY3VycmVudFhIUiA9IGFqYXgodXJsLCB7fSwgIkdFVCIsIGZ1bmN0aW9uKHhocil7CiAgICAgIGlmKHhoci5zdGF0dXMgPT09IDIwMCkKICAgICAgICByZXNvbHZlci5yZXNvbHZlKHhoci5yZXNwb25zZVRleHQpOwogICAgICBlbHNlCiAgICAgICAgcmVzb2x2ZXIucmVqZWN0KHtlcnJvcjogeGhyLnN0YXR1cywgY29udGVudDogeGhyLnJlc3BvbnNlVGV4dH0pOwogICAgfSk7CiAgfTsKCiAgUGFnZUxvYWRlci5wcm90b3R5cGUuYWJvcnQgPSBmdW5jdGlvbigpewogICAgaWYodGhpcy5jdXJyZW50WEhSICYmIHRoaXMuY3VycmVudFhIUi5yZWFkeVN0YXRlICE9PSA0KXsKICAgICAgdGhpcy5jdXJyZW50WEhSLmFib3J0KCk7CiAgICB9CiAgfTsKCiAgcmV0dXJuIFBhZ2VMb2FkZXI7Cn0pOwpkZWZpbmUoJ2RlY28vc3BhL1RlbXBsYXRlcycsWwogICJkZWNvL3NwYS9QYWdlTG9hZGVyIiwKICAiZGVjby91dGlscyIsCiAgIndoZW4iCl0sIGZ1bmN0aW9uKAogIFBhZ2VMb2FkZXIsCiAgdXRpbHMsCiAgd2hlbgopewoKICBmdW5jdGlvbiBkZWZhdWx0Q29uZmlnKCl7CiAgICByZXR1cm4gewogICAgICBwYXRoVG9Vcmw6IGZ1bmN0aW9uKGEpeyByZXR1cm4gYTsgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZmluZFRlbXBsYXRlc0luRG9jdW1lbnQoZG9jKXsKCiAgICB2YXIgbm9kZUxpc3QgPSBkb2MucXVlcnlTZWxlY3RvckFsbCgiW3R5cGU9J3RleHQvcGFnZS10ZW1wbGF0ZSddIik7CiAgICB2YXIgbm9kZXMgPSB1dGlscy50b0FycmF5KG5vZGVMaXN0KTsKICAgIHZhciB0ZW1wbGF0ZUxpc3QgPSBub2Rlcy5tYXAoZnVuY3Rpb24odGVtcGxhdGUpewogICAgICByZXR1cm4gewogICAgICAgIGlkOiB0ZW1wbGF0ZS5pZC50b0xvd2VyQ2FzZSgpLAogICAgICAgIGNvbnRlbnQ6IHRlbXBsYXRlLmlubmVySFRNTAogICAgICB9OwogICAgfSk7CgogICAgcmV0dXJuIHV0aWxzLmFycmF5VG9PYmplY3QodGVtcGxhdGVMaXN0LCBmdW5jdGlvbihpdGVtLCBvYmplY3QpewogICAgICBvYmplY3RbaXRlbS5pZF0gPSBpdGVtLmNvbnRlbnQ7CiAgICB9KTsKICB9CgoKICBmdW5jdGlvbiBUZW1wbGF0ZXMoZG9jdW1lbnQsIGNvbmZpZyl7CiAgICB0aGlzLnBhZ2VMb2FkZXIgPSBuZXcgUGFnZUxvYWRlcihjb25maWcgfHwgZGVmYXVsdENvbmZpZygpKTsKICAgIHRoaXMuY2FjaGVQYWdlcyA9IChjb25maWcgJiYgJ2NhY2hlUGFnZXMnIGluIGNvbmZpZyA/IGNvbmZpZy5jYWNoZVBhZ2VzIDogdHJ1ZSkKICAgIHRoaXMudGVtcGxhdGVzID0gZmluZFRlbXBsYXRlc0luRG9jdW1lbnQoZG9jdW1lbnQpOwogIH0KCiAgVGVtcGxhdGVzLnByb3RvdHlwZS5nZXRUZW1wbGF0ZSA9IGZ1bmN0aW9uKHBhdGgpewoKICAgIHRoaXMucGFnZUxvYWRlci5hYm9ydCgpOwoKICAgIHZhciBub3JtYWxpemVkUGF0aCA9IHBhdGgudG9Mb3dlckNhc2UoKTsKCiAgICBpZihub3JtYWxpemVkUGF0aCBpbiB0aGlzLnRlbXBsYXRlcyl7CiAgICAgIHJldHVybiB3aGVuLnJlc29sdmUodGhpcy50ZW1wbGF0ZXNbbm9ybWFsaXplZFBhdGhdKTsKICAgIH1lbHNlewogICAgICB2YXIgZGVmZXJyZWQgPSB3aGVuLmRlZmVyKCk7CgogICAgICB0aGlzLnBhZ2VMb2FkZXIubG9hZFBhZ2UocGF0aCwgZGVmZXJyZWQucmVzb2x2ZXIpOwogICAgICAKICAgICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2UudGhlbihmdW5jdGlvbihjb250ZW50KXsKICAgICAgICBpZih0aGlzLmNhY2hlUGFnZXMpCiAgICAgICAgICB0aGlzLnRlbXBsYXRlc1tub3JtYWxpemVkUGF0aF0gPSBjb250ZW50OwogICAgICAgIAogICAgICAgIHJldHVybiBjb250ZW50OwogICAgICB9LmJpbmQodGhpcyksIGZ1bmN0aW9uKG5vdEZvdW5kKXsKICAgICAgICB2YXIgZXJyb3JUZW1wbGF0ZSA9ICJlcnJvciIgKyBub3RGb3VuZC5lcnJvcjsKICAgICAgICBpZihlcnJvclRlbXBsYXRlIGluIHRoaXMudGVtcGxhdGVzKXsKICAgICAgICAgIHJldHVybiB0aGlzLnRlbXBsYXRlc1tlcnJvclRlbXBsYXRlXTsKICAgICAgICB9ZWxzZXsKICAgICAgICAgIHJldHVybiBub3RGb3VuZC5jb250ZW50OwogICAgICAgIH0KICAgICAgfS5iaW5kKHRoaXMpKTsKICAgIH0KICB9OwoKICByZXR1cm4gVGVtcGxhdGVzOwp9KTsKZGVmaW5lKCdkZWNvL3Byb2NsYWltV2hlbicsW10sIGZ1bmN0aW9uICgpIHsKCiAgZnVuY3Rpb24gcHVibGlzaChuYW1lLCBzdWJzY3JpYmVycywgZGF0YSkgewogICAgc3Vic2NyaWJlcnMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICBpdGVtLmFwcGx5KGl0ZW0sIGRhdGEpOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBzdWJzY3JpYmVUbyhuYW1lLCBzdWJzY3JpYmVycywgc3Vic2NyaWJlcikgewogICAgdmFyIGluZGV4ID0gc3Vic2NyaWJlcnMuaW5kZXhPZihzdWJzY3JpYmVyKTsKICAgIGlmKGluZGV4IDwgMCkKICAgICAgc3Vic2NyaWJlcnMucHVzaChzdWJzY3JpYmVyKTsKICAgIHJldHVybiBpbmRleCA8IDA7CiAgfQogIAogIGZ1bmN0aW9uIHVuc3Vic2NyaWJlRnJvbShuYW1lLCBzdWJzY3JpYmVycywgc3Vic2NyaWJlcil7CiAgICB2YXIgaW5kZXggPSBzdWJzY3JpYmVycy5pbmRleE9mKHN1YnNjcmliZXIpOwogICAgaWYoaW5kZXggPj0gMCkKICAgICAgc3Vic2NyaWJlcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgIHJldHVybiBpbmRleCA+PSAwOwogIH0KICBmdW5jdGlvbiBleHRlbmRFdmVudChuYW1lLCBldmVudCl7CiAgICBldmVudC5zdWJzY3JpYmVycyA9IFtdOwogICAgZXZlbnQuc3Vic2NyaWJlU3Vic2NyaWJlcnMgPSBbXTsKICAgIGV2ZW50LnVuc3Vic2NyaWJlU3Vic2NyaWJlcnMgPSBbXTsKCiAgICB2YXIgZXh0ZW5kZWRFdmVudCA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmKGFyZ3VtZW50cy5sZW5ndGggPT0gMSAmJiB0eXBlb2YgYXJndW1lbnRzWzBdID09PSAiZnVuY3Rpb24iKXsKICAgICAgICBpZihzdWJzY3JpYmVUbyhuYW1lLCBldmVudC5zdWJzY3JpYmVycywgYXJndW1lbnRzWzBdKSkKICAgICAgICAgIHB1Ymxpc2gobmFtZSsiLmlzU3Vic2NyaWJlZFRvIiwgZXZlbnQuc3Vic2NyaWJlU3Vic2NyaWJlcnMpOwogICAgICB9ZWxzZXsKICAgICAgICBwdWJsaXNoKG5hbWUsIGV2ZW50LnN1YnNjcmliZXJzLCBhcmd1bWVudHMpOwogICAgICB9CiAgICB9CgogICAgZXh0ZW5kZWRFdmVudC5kb250ID0gZnVuY3Rpb24oc3Vic2NyaWJlcil7CiAgICAgIGlmKHVuc3Vic2NyaWJlRnJvbShuYW1lLCBldmVudC5zdWJzY3JpYmVycywgc3Vic2NyaWJlcikpCiAgICAgICAgcHVibGlzaChuYW1lKyIuaXNVbnN1YnNjcmliZWRGcm9tIiwgZXZlbnQudW5zdWJzY3JpYmVTdWJzY3JpYmVycyk7CiAgICB9OwoKICAgIGV4dGVuZGVkRXZlbnQuaXNTdWJzY3JpYmVkVG8gPSBmdW5jdGlvbihzdWJzY3JpYmVyKXsKICAgICAgc3Vic2NyaWJlVG8obmFtZSsiLmlzU3Vic2NyaWJlZFRvIiwgZXZlbnQuc3Vic2NyaWJlU3Vic2NyaWJlcnMsIHN1YnNjcmliZXIpOwogICAgfTsKCiAgICBleHRlbmRlZEV2ZW50LmlzU3Vic2NyaWJlZFRvLmRvbnQgPSBmdW5jdGlvbihzdWJzY3JpYmVyKXsKICAgICAgdW5zdWJzY3JpYmVGcm9tKG5hbWUrIi5pc1N1YnNjcmliZWRUbyIsIGV2ZW50LnN1YnNjcmliZVN1YnNjcmliZXJzLCBzdWJzY3JpYmVyKTsKICAgIH07CgogICAgZXh0ZW5kZWRFdmVudC5pc1Vuc3Vic2NyaWJlZEZyb20gPSBmdW5jdGlvbihzdWJzY3JpYmVyKXsKICAgICAgc3Vic2NyaWJlVG8obmFtZSsiLmlzVW5zdWJzY3JpYmVkRnJvbSIsIGV2ZW50LnVuc3Vic2NyaWJlU3Vic2NyaWJlcnMsIHN1YnNjcmliZXIpOwogICAgfTsKCiAgICBleHRlbmRlZEV2ZW50LmlzVW5zdWJzY3JpYmVkRnJvbS5kb250ID0gZnVuY3Rpb24oc3Vic2NyaWJlcil7CiAgICAgIHVuc3Vic2NyaWJlRnJvbShuYW1lKyIuaXNVbnN1YnNjcmliZWRGcm9tIiwgZXZlbnQudW5zdWJzY3JpYmVTdWJzY3JpYmVycywgc3Vic2NyaWJlcik7CiAgICB9OwoKICAgIGV4dGVuZGVkRXZlbnQudG9TdHJpbmcgPSBmdW5jdGlvbigpewogICAgICByZXR1cm4gIltFdmVudCAiK25hbWUrIl0iOwogICAgfQoKICAgIHJldHVybiBleHRlbmRlZEV2ZW50OwogIH0KICAKICBmdW5jdGlvbiBleHRlbmQoZXZlbnRzKXsKICAgIGZvcih2YXIgaSBpbiBldmVudHMpewogICAgICBldmVudHNbaV0gPSBleHRlbmRFdmVudChpLCBldmVudHNbaV0pOwogICAgfQogICAgcmV0dXJuIGV2ZW50czsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZShhcmcxLCBhcmcyKXsKICAgIGlmKGFyZzIpCiAgICAgIHJldHVybiBleHRlbmRFdmVudChhcmcxLCBhcmcyKTsKICAgIGVsc2UKICAgICAgcmV0dXJuIGV4dGVuZEV2ZW50KCJhbm9ueW1vdXMgZXZlbnQiLCBhcmcxKQogIH0KCiAgcmV0dXJuIHsKICAgIGV4dGVuZDogZXh0ZW5kLAogICAgY3JlYXRlOiBjcmVhdGUKICB9OwogIAp9KTsKCmRlZmluZSgnZGVjby9ldmVudHMnLFsnZGVjby9wcm9jbGFpbVdoZW4nXSwgZnVuY3Rpb24ocHJvY2xhaW1XaGVuKXsKICByZXR1cm4gcHJvY2xhaW1XaGVuLmV4dGVuZCh7CiAgICB0aGVQYWdlSGFzQ2hhbmdlZDogZnVuY3Rpb24ocGF0aCwgc2VnbWVudHMsIHVybCl7IH0KICB9KTsKfSk7CmRlZmluZSgnZGVjby9zcGEnLFsKICAiZGVjby9zcGEvT3V0bGV0IiwKICAiZGVjby9zcGEvd2hlbkNvbnRleHQiLAogICJkZWNvL3NwYS9hcHBseVZpZXdNb2RlbHMiLAogICJkZWNvL3NwYS9oYXNoTmF2aWdhdGlvbiIsCiAgImRlY28vc3BhL1RlbXBsYXRlcyIsCiAgImRlY28vdXRpbHMiLAogICJkZWNvL2V2ZW50cyIKXSwgZnVuY3Rpb24oCiAgT3V0bGV0LAogIHdoZW5Db250ZXh0LAogIGFwcGx5Vmlld01vZGVscywKICBoYXNoTmF2aWdhdGlvbiwKICBUZW1wbGF0ZXMsCiAgdXRpbHMsCiAgcHJvY2xhaW0KKXsKCiAgdmFyIF9jb25maWcgPSB7CiAgICAgIGluZGV4OiAiaW5kZXgiCiAgICB9LAogICAgX2RvY3VtZW50LAogICAgX291dGxldCwKICAgIF9vcmlnaW5hbFRpdGxlLAogICAgX3RlbXBsYXRlcywKICAgIF93aGVuQ29udGV4dDsKCiAgZnVuY3Rpb24gYXBwbHlDb250ZW50KGNvbnRlbnQpewogICAgX291dGxldC51bmxvYWRDdXJyZW50UGFnZSgpOwogICAgX291dGxldC5zZXRQYWdlQ29udGVudChjb250ZW50KTsKICAgIF9vdXRsZXQuc2V0RG9jdW1lbnRUaXRsZShfb3V0bGV0LmdldFBhZ2VUaXRsZSgpIHx8IF9vcmlnaW5hbFRpdGxlKTsKICAgIF9vdXRsZXQuZXh0cmFjdEFuZFJ1blBhZ2VKYXZhU2NyaXB0KCk7CiAgICByZXR1cm4gYXBwbHlWaWV3TW9kZWxzKF9vdXRsZXQuZWxlbWVudCwgX3doZW5Db250ZXh0KCkpOwogIH0KCiAgZnVuY3Rpb24gcGFnZUNoYW5nZWQocGF0aCwgc2VnbWVudHMpewogICAgX291dGxldC5pbmRpY2F0ZVBhZ2VJc0xvYWRpbmcoKTsKICAgIF93aGVuQ29udGV4dC5kZXN0cm95Q2hpbGRDb250ZXh0cygpOwogICAgcmV0dXJuIF90ZW1wbGF0ZXMuZ2V0VGVtcGxhdGUocGF0aCkKICAgICAgLnRoZW4oYXBwbHlDb250ZW50KQogICAgICAudGhlbihmdW5jdGlvbigpewogICAgICAgIF9vdXRsZXQucGFnZUhhc0xvYWRlZCgpOwogICAgICAgIHByb2NsYWltLnRoZVBhZ2VIYXNDaGFuZ2VkKHBhdGgsIHNlZ21lbnRzLCBkb2N1bWVudC5sb2NhdGlvbikKICAgICAgfSk7CiAgfQoKICBmdW5jdGlvbiBzdGFydChjb25maWcsIGRvY3VtZW50KXsKICAgIF9kb2N1bWVudCA9IGRvY3VtZW50IHx8IHdpbmRvdy5kb2N1bWVudDsKICAgIF9jb25maWcgPSB1dGlscy5leHRlbmQoX2NvbmZpZywgY29uZmlnKTsKICAgIF9vdXRsZXQgPSBuZXcgT3V0bGV0KF9kb2N1bWVudC5xdWVyeVNlbGVjdG9yKCJbZGF0YS1vdXRsZXRdIiksIF9kb2N1bWVudCk7CiAgICBfb3JpZ2luYWxUaXRsZSA9IF9kb2N1bWVudC50aXRsZTsKICAgIF93aGVuQ29udGV4dCA9IHdoZW5Db250ZXh0KCk7CgogICAgcmV0dXJuIGFwcGx5Vmlld01vZGVscyhfZG9jdW1lbnQsIHdoZW5Db250ZXh0KCkpLnRoZW4oZnVuY3Rpb24oKXsKICAgICAgaWYoX291dGxldC5vdXRsZXRFeGlzdHMoKSl7CiAgICAgICAgX3RlbXBsYXRlcyA9IG5ldyBUZW1wbGF0ZXMoX2RvY3VtZW50LCBfY29uZmlnKTsKICAgICAgICBoYXNoTmF2aWdhdGlvbi5zdGFydChfY29uZmlnLCBwYWdlQ2hhbmdlZCwgX2RvY3VtZW50KTsKICAgICAgfQogICAgfSk7CiAgfQoKICByZXR1cm4gewogICAgc3RhcnQ6IHN0YXJ0CiAgfTsKfSk7CmRlZmluZSgnZGVjby9kZWNvJyxbCiAgJ2RlY28vcXZjJywKICAnZGVjby9zcGEnCl0sIGZ1bmN0aW9uKAogIHF2YywKICBzcGEKKXsKCiAgCgogIGZ1bmN0aW9uIGNvbmZpZyhjb25maWcpewoKICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTsKCiAgICB2YXIgc3BhQ29uZmlnID0gY29uZmlnLnNwYSB8fCB7fTsKICAgIHZhciBxdmNDb25maWcgPSBjb25maWcucXZjIHx8IHt9OwoKICAgIHF2Yy5jb25maWcocXZjQ29uZmlnKTsKCiAgICByZXR1cm4gewogICAgICBzdGFydDogc3BhLnN0YXJ0LmJpbmQobnVsbCwgc3BhQ29uZmlnLCBkb2N1bWVudCkKICAgIH0KICB9CiAgCiAgcmV0dXJuIHsKICAgIGNvbmZpZzogY29uZmlnCiAgfTsKCn0pOwpkZWZpbmUoJ2RlY28nLCBbJ2RlY28vZGVjbyddLCBmdW5jdGlvbiAobWFpbikgeyByZXR1cm4gbWFpbjsgfSk7CgpkZWZpbmUoJ2RlY28vcXZjL2NvbnN0cmFpbnRzL05vdEVtcHR5JyxbXSwgZnVuY3Rpb24oKXsKICBmdW5jdGlvbiBOb3RFbXB0eShhdHRyaWJ1dGVzKXsKICAgIAogIH0KICAKICBOb3RFbXB0eS5wcm90b3R5cGUuaXNWYWxpZCA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgIGlmKHZhbHVlID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgIGlmKHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIiAmJiB2YWx1ZS5sZW5ndGggPT0gMCkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIHRydWU7CiAgfTsKICAKICByZXR1cm4gTm90RW1wdHk7Cn0pOwpkZWZpbmUoJ2RlY28vcXZjL2NvbnN0cmFpbnRzL1BhdHRlcm4nLFtdLCBmdW5jdGlvbigpewogIGZ1bmN0aW9uIFBhdHRlcm4oYXR0cmlidXRlcyl7ICAgIAoKICAgIGF0dHJpYnV0ZXMuZmxhZ3MgPSBhdHRyaWJ1dGVzLmZsYWdzIHx8IFtdOwogICAgCiAgICB2YXIgZmxhZ3MgPSAnJzsKICAgIGlmKGF0dHJpYnV0ZXMuZmxhZ3MuaW5kZXhPZigiQ0FTRV9JTlNFTlNJVElWRSIpID49IDApIGZsYWdzICs9ICdpJzsKICAgIAogICAgdGhpcy5yZWdleCA9IG5ldyBSZWdFeHAoYXR0cmlidXRlcy5yZWdleHAsIGZsYWdzKTsKICB9CiAgCiAgCiAgUGF0dGVybi5wcm90b3R5cGUuaXNWYWxpZCA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgIAogICAgaWYodmFsdWUgPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgCiAgICB2YXIgcmVzdWx0ID0gdGhpcy5yZWdleC5leGVjKHZhbHVlKTsKICAgIAogICAgaWYocmVzdWx0ID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgIAogICAgcmV0dXJuIHJlc3VsdFswXSA9PSB2YWx1ZTsKICB9OwogIAogIAogIHJldHVybiBQYXR0ZXJuOwp9KTsKCi8vIyBzb3VyY2VNYXBwaW5nVVJMPWRlY28uanMubWFw",
                "body": "ZGVmaW5lKCdkZWNvL3V0aWxzJyxbXSwgZnVuY3Rpb24oKXsKICByZXR1cm4gewogICAgCiAgICB0b0FycmF5OiBmdW5jdGlvbihvYmopewogICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgLy8gaXRlcmF0ZSBiYWNrd2FyZHMgZW5zdXJpbmcgdGhhdCBsZW5ndGggaXMgYW4gVUludDMyCiAgICAgIGZvciAodmFyIGkgPSBvYmoubGVuZ3RoID4+PiAwOyBpLS07KSB7IAogICAgICAgIGFycmF5W2ldID0gb2JqW2ldOwogICAgICB9CiAgICAgIHJldHVybiBhcnJheTsKICAgIH0sCiAgICAKICAgIGV4dGVuZDogZnVuY3Rpb24oZHN0LCBzcmMpewogICAgICBzcmMgPSBzcmMgfHwge307CiAgICAgIGRzdCA9IGRzdCB8fCB7fTsKICAgICAgZm9yKHZhciBpIGluIHNyYyl7CiAgICAgICAgZHN0W2ldID0gc3JjW2ldOwogICAgICB9CiAgICAgIHJldHVybiBkc3Q7CiAgICB9LAogICAgCiAgICBpbmhlcml0c0Zyb206IGZ1bmN0aW9uKG8pewogICAgICBmdW5jdGlvbiBGKCkge30KICAgICAgRi5wcm90b3R5cGUgPSBvLnByb3RvdHlwZTsKCiAgICAgIHJldHVybiBuZXcgRigpOwogICAgfSwKICAgIAogICAgYXJyYXlUb09iamVjdDogZnVuY3Rpb24oYXJyYXksIGZ1bmMpewogICAgICByZXR1cm4gYXJyYXkucmVkdWNlKGZ1bmN0aW9uKGNvbGxlY3Rpb24sIGl0ZW0pewogICAgICAgIGZ1bmMoaXRlbSwgY29sbGVjdGlvbik7CiAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb247CiAgICAgIH0sIHt9KTsKICAgIH0sCiAgICAKICAgIHRyaW06IGZ1bmN0aW9uKHdvcmQsIGNoYXJhY3Rlcil7CiAgICAgIHdoaWxlKHdvcmQuY2hhckF0KDApID09IGNoYXJhY3Rlcikgd29yZCA9IHdvcmQuc3Vic3RyKDEpOwogICAgICB3aGlsZSh3b3JkLmNoYXJBdCh3b3JkLmxlbmd0aCAtIDEpID09IGNoYXJhY3Rlcikgd29yZCA9IHdvcmQuc3Vic3RyKDAsIHdvcmQubGVuZ3RoIC0gMSk7CiAgICAgIHJldHVybiB3b3JkOwogICAgfSwKICAgIAogICAgYWZ0ZXI6IGZ1bmN0aW9uKHdvcmQsIGNoYXJhY3Rlcil7CiAgICAgIHZhciBpbmRleCA9IHdvcmQuaW5kZXhPZihjaGFyYWN0ZXIpOwogICAgICBpZihpbmRleCA8IDApewogICAgICAgIHJldHVybiAiIjsKICAgICAgfWVsc2V7CiAgICAgICAgcmV0dXJuIHdvcmQuc3Vic3RyKGluZGV4KzEpOwogICAgICB9CiAgICB9LAogICAgCiAgICBwb3BUYWlsOiBmdW5jdGlvbihhcnJheSl7CiAgICAgIHJldHVybiBhcnJheS5zbGljZSgwLCAtMSk7CiAgICB9LAogICAgCiAgICBzdGFydHNXaXRoOiBmdW5jdGlvbih3b3JkLCBjaGFyYWN0ZXIpewogICAgICByZXR1cm4gd29yZC5jaGFyQXQoMCkgPT09IGNoYXJhY3RlcjsKICAgIH0sCiAgICAKICAgIGVuZHNXaXRoOiBmdW5jdGlvbih3b3JkLCBjaGFyYWN0ZXIpewogICAgICByZXR1cm4gd29yZC5jaGFyQXQod29yZC5sZW5ndGggLSAxKSA9PT0gY2hhcmFjdGVyOwogICAgfSwKICAgIAogICAgYWRkRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24oZWxlbWVudCwgZXZlbnQsIGxpc3RlbmVyLCBidWJibGUpewogICAgICBpZignYWRkRXZlbnRMaXN0ZW5lcicgaW4gZWxlbWVudCl7CiAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lciwgYnViYmxlKTsKICAgICAgfWVsc2V7CiAgICAgICAgZWxlbWVudC5hdHRhY2hFdmVudCgib24iK2V2ZW50LCBsaXN0ZW5lcik7ICAgIAogICAgICB9CiAgICB9CiAgfTsKfSk7CgpkZWZpbmUoJ2RlY28vcXZjL0V4ZWN1dGFibGVSZXN1bHQnLFsiZGVjby91dGlscyJdLCBmdW5jdGlvbih1dGlscyl7CiAgZnVuY3Rpb24gRXhlY3V0YWJsZVJlc3VsdChyZXN1bHQpewogICAgCiAgICB0aGlzLnN1Y2Nlc3MgPSBmYWxzZTsKICAgIHRoaXMudmFsaWQgPSBmYWxzZTsKICAgIHRoaXMucmVzdWx0ID0gbnVsbDsKICAgIHRoaXMuZXhjZXB0aW9uID0gbnVsbDsKICAgIHRoaXMudmlvbGF0aW9ucyA9IFtdOwogIAogICAgdXRpbHMuZXh0ZW5kKHRoaXMsIHJlc3VsdCk7CiAgCiAgfTsKICAKICByZXR1cm4gRXhlY3V0YWJsZVJlc3VsdDsKfSk7CmRlZmluZSgnZGVjby9xdmMvQ29uc3RyYWludCcsW10sIGZ1bmN0aW9uKCl7CiAgCiAgZnVuY3Rpb24gQ29uc3RyYWludCh0eXBlLCBhdHRyaWJ1dGVzKXsgICAgCiAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgIHRoaXMubWVzc2FnZSA9IGF0dHJpYnV0ZXMubWVzc2FnZTsKICAgIAogICAgCiAgICB0aGlzLmluaXQodHlwZSk7CiAgfQogICAgCiAgQ29uc3RyYWludC5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKHR5cGUpewogICAgcmVxdWlyZShbImRlY28vcXZjL2NvbnN0cmFpbnRzLyIgKyB0eXBlXSwgZnVuY3Rpb24oVGVzdGVyKXsKICAgICAgdmFyIHRlc3RlciA9IG5ldyBUZXN0ZXIodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgdGhpcy52YWxpZGF0ZSA9IHRlc3Rlci5pc1ZhbGlkLmJpbmQodGVzdGVyKTsKICAgIH0uYmluZCh0aGlzKSk7CiAgfTsKICAKICBDb25zdHJhaW50LnByb3RvdHlwZS52YWxpZGF0ZSA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgIHJldHVybiB0cnVlOy8vcmVhbCB0ZXN0IG5vdCBsb2FkZWQgeWV0CiAgfTsKICAKICAKICByZXR1cm4gQ29uc3RyYWludDsKfSk7CmRlZmluZSgnZGVjby9xdmMvVmFsaWRhdG9yJyxbCiAgImRlY28vcXZjL0NvbnN0cmFpbnQiLCAKICAia25vY2tvdXQiCl0sIGZ1bmN0aW9uKAogIENvbnN0cmFpbnQsIAogIGtvCil7CgogIGZ1bmN0aW9uIGludGVycG9sYXRlKG1lc3NhZ2UsIGF0dHJpYnV0ZXMsIHZhbHVlLCBuYW1lLCBwYXRoKXsKICAgIHJldHVybiBtZXNzYWdlLnJlcGxhY2UoL1x7KFtefV0rKVx9L2csIGZ1bmN0aW9uKG1hdGNoLCBrZXkpewogICAgICBpZihrZXkgPT0gInZhbHVlIikgcmV0dXJuIHZhbHVlOwogICAgICBpZihrZXkgPT0gInRoaXMubmFtZSIpIHJldHVybiBuYW1lOwogICAgICBpZihrZXkgPT0gInRoaXMucGF0aCIpIHJldHVybiBwYXRoOwogICAgICBpZihrZXkgaW4gYXR0cmlidXRlcykgcmV0dXJuIGF0dHJpYnV0ZXNba2V5XTsKICAgICAgcmV0dXJuIG1hdGNoOwogICAgfSk7CiAgfQogIAoKICBmdW5jdGlvbiBWYWxpZGF0b3IodGFyZ2V0LCBvcHRpb25zKXsKICAgIHZhciBzZWxmID0gdGhpczsKICAgIAogICAgdGhpcy5jb25zdHJhaW50cyA9IFtdOwogICAgCiAgICB0aGlzLmlzVmFsaWQgPSBrby5vYnNlcnZhYmxlKHRydWUpOwogICAgdGhpcy5tZXNzYWdlID0ga28ub2JzZXJ2YWJsZSgiIik7CgogICAgdGhpcy5uYW1lID0gb3B0aW9ucyAmJiBvcHRpb25zLm5hbWU7CiAgICB0aGlzLnBhdGggPSBvcHRpb25zICYmIG9wdGlvbnMucGF0aDsKICB9CiAgCiAgVmFsaWRhdG9yLnByb3RvdHlwZS5zZXRDb25zdHJhaW50cyA9IGZ1bmN0aW9uKGNvbnN0cmFpbnRzKXsKICAgIHRoaXMuY29uc3RyYWludHMgPSBjb25zdHJhaW50cy5tYXAoZnVuY3Rpb24oY29uc3RyYWludCl7CiAgICAgIHJldHVybiBuZXcgQ29uc3RyYWludChjb25zdHJhaW50Lm5hbWUsIGNvbnN0cmFpbnQuYXR0cmlidXRlcyk7CiAgICB9KTsKICB9OwogIAogIFZhbGlkYXRvci5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbigpewogICAgdGhpcy5pc1ZhbGlkKHRydWUpOwogICAgdGhpcy5tZXNzYWdlKCIiKTsKICB9OwogIAogIFZhbGlkYXRvci5wcm90b3R5cGUudmFsaWRhdGUgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICBpZih0aGlzLmNvbnN0cmFpbnRzLmxlbmd0aCA9PSAwKXsKICAgICAgdGhpcy5yZXNldCgpOwogICAgfWVsc2UgaWYodGhpcy5jb25zdHJhaW50cy5ldmVyeShmdW5jdGlvbiAoY29uc3RyYWludCkgewogICAgICBpZihjb25zdHJhaW50LnZhbGlkYXRlKHZhbHVlKSl7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH1lbHNlewogICAgICAgIHRoaXMuaXNWYWxpZChmYWxzZSk7CiAgICAgICAgdGhpcy5tZXNzYWdlKGludGVycG9sYXRlKGNvbnN0cmFpbnQubWVzc2FnZSwgY29uc3RyYWludC5hdHRyaWJ1dGVzLCB2YWx1ZSwgdGhpcy5uYW1lLCB0aGlzLnBhdGgpKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0uYmluZCh0aGlzKSkpewogICAgICB0aGlzLmlzVmFsaWQodHJ1ZSk7CiAgICAgIHRoaXMubWVzc2FnZSgiIik7CiAgICB9CiAgfTsKICAKICByZXR1cm4gVmFsaWRhdG9yOwp9KTsKZGVmaW5lKCdkZWNvL3F2Yy9rb0V4dGVuc2lvbnMnLFsiZGVjby9xdmMvVmFsaWRhdG9yIiwgImtub2Nrb3V0Il0sIGZ1bmN0aW9uKFZhbGlkYXRvciwga28pewoKICBpZiAoa28gIT0gbnVsbCkgewogICAga28uYmluZGluZ0hhbmRsZXJzLnZhbGlkYXRpb25NZXNzYWdlRm9yID0gewogICAgICBpbml0OiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ3NBY2Nlc3Nvciwgdmlld01vZGVsKSB7CiAgICAgICAgdmFyIHZhbHVlID0gdmFsdWVBY2Nlc3NvcigpOwogICAgICAgIHZhciB2YWxpZGF0b3IgPSB2YWx1ZS52YWxpZGF0b3I7CiAgICAgICAgaWYgKHZhbGlkYXRvcikgewogICAgICAgICAga28uYXBwbHlCaW5kaW5nc1RvTm9kZShlbGVtZW50LCB7IGhpZGRlbjogdmFsaWRhdG9yLmlzVmFsaWQsIHRleHQ6IHZhbGlkYXRvci5tZXNzYWdlIH0sIHZhbGlkYXRvcik7CiAgICAgICAgfWVsc2V7CiAgICAgICAgICB2YXIgYXR0cmlidXRlcyA9IEFycmF5LnByb3RvdHlwZS5yZWR1Y2UuY2FsbChlbGVtZW50LmF0dHJpYnV0ZXMsIGZ1bmN0aW9uKHMsZSl7cmV0dXJuIHMrIiAiK2UubG9jYWxOYW1lKyI9XCIiK2UudmFsdWUrIlwiIn0sICIiKTsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ291bGQgbm90IGJpbmQgYHZhbGlkYXRpb25NZXNzYWdlRm9yYCB0byB2YWx1ZSBvbiBlbGVtZW50IDwiK2VsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpICsgYXR0cmlidXRlcyArIj4iKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICAKICAgIGtvLmV4dGVuZGVycy52YWxpZGF0aW9uID0gZnVuY3Rpb24gKHRhcmdldCwgb3B0aW9ucykgewogICAgICB0YXJnZXQudmFsaWRhdG9yID0gbmV3IFZhbGlkYXRvcih0YXJnZXQsIG9wdGlvbnMpOwogICAgICB0YXJnZXQuc3Vic2NyaWJlKGZ1bmN0aW9uIChuZXdWYWx1ZSkgewogICAgICAgIHRhcmdldC52YWxpZGF0b3IudmFsaWRhdGUobmV3VmFsdWUpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH07CiAgICAKICAgIGtvLmJpbmRpbmdIYW5kbGVycy5jb21tYW5kID0ga28uYmluZGluZ0hhbmRsZXJzLnF1ZXJ5ID0gewogICAgICBpbml0OiBmdW5jdGlvbiAoZWxlbWVudCwgdmFsdWVBY2Nlc3NvciwgYWxsQmluZGluZ0FjY2Vzc29yLCB2aWV3TW9kZWwpIHsKICAgICAgICBrby5hcHBseUJpbmRpbmdzVG9Ob2RlKGVsZW1lbnQsIHsgY2xpY2s6IHZhbHVlQWNjZXNzb3IoKSB9LCB2aWV3TW9kZWwpOwogICAgICB9CiAgICB9OwogIH0KICAKCn0pOwpkZWZpbmUoJ2RlY28vcXZjL1ZhbGlkYXRhYmxlJyxbCiAgImRlY28vdXRpbHMiLCAKICAiZGVjby9xdmMvVmFsaWRhdG9yIiwgCiAgImtub2Nrb3V0IiwgCiAgImRlY28vcXZjL2tvRXh0ZW5zaW9ucyIKXSwgZnVuY3Rpb24oCiAgdXRpbHMsIAogIFZhbGlkYXRvciwgCiAga28KKXsKICAKICBmdW5jdGlvbiBWYWxpZGF0YWJsZShuYW1lLCBwYXJhbWV0ZXJzLCBjb25zdHJhaW50UmVzb2x2ZXIpewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgCiAgICB0aGlzLnZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3IoKTsKICAgIHRoaXMudmFsaWRhdGFibGVGaWVsZHMgPSBbXTsKICAgIHRoaXMudmFsaWRhdGFibGVQYXJhbWV0ZXJzID0gcGFyYW1ldGVyczsKICAgIAogICAgCiAgICBpbml0OiB7CiAgICAgIHJlY3Vyc2l2bHlFeHRlbmRQYXJhbWV0ZXJzKHNlbGYudmFsaWRhdGFibGVQYXJhbWV0ZXJzLCBzZWxmLnZhbGlkYXRhYmxlRmllbGRzLCBbXSk7CiAgICAgIGlmKGNvbnN0cmFpbnRSZXNvbHZlcikKICAgICAgICBjb25zdHJhaW50UmVzb2x2ZXIuYXBwbHlWYWxpZGF0aW9uQ29uc3RyYWludHMobmFtZSwgc2VsZik7CiAgICB9CiAgfQogIAogIFZhbGlkYXRhYmxlLnByb3RvdHlwZS5pc1ZhbGlkID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMudmFsaWRhdGFibGVGaWVsZHMuZXZlcnkoZnVuY3Rpb24oY29uc3RyYWludCl7CiAgICAgIHJldHVybiBjb25zdHJhaW50LnZhbGlkYXRvciAmJiBjb25zdHJhaW50LnZhbGlkYXRvci5pc1ZhbGlkKCk7CiAgICB9KSAmJiB0aGlzLnZhbGlkYXRvci5pc1ZhbGlkKCk7CiAgfTsKICAgIAogIFZhbGlkYXRhYmxlLnByb3RvdHlwZS5hcHBseVZpb2xhdGlvbnMgPSBmdW5jdGlvbih2aW9sYXRpb25zKXsKICAgIHZpb2xhdGlvbnMuZm9yRWFjaChmdW5jdGlvbih2aW9sYXRpb24pewogICAgICB2YXIgbWVzc2FnZSA9IHZpb2xhdGlvbi5tZXNzYWdlOwogICAgICB2YXIgZmllbGROYW1lID0gdmlvbGF0aW9uLmZpZWxkTmFtZTsKICAgICAgaWYgKGZpZWxkTmFtZS5sZW5ndGggPiAwKSB7CiAgICAgICAgLy9vbmUgb2YgdGhlIGZpZWxkcyB2aW9sYXRlcyBhIGNvbnN0cmFpbnQKICAgICAgICBhcHBseVZpb2xhdGlvbk1lc3NhZ2VUb0ZpZWxkKHRoaXMudmFsaWRhdGFibGVQYXJhbWV0ZXJzLCBmaWVsZE5hbWUsIG1lc3NhZ2UpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vdGhlIHZhbGlkYXRhYmxlIHZpb2xhdGVzIGEgY29uc3RyYWludAogICAgICAgIGFwcGx5VmlvbGF0aW9uTWVzc2FnZVRvVmFsaWRhdGFibGUodGhpcywgbWVzc2FnZSk7CiAgICAgIH0KICAgIH0uYmluZCh0aGlzKSk7CiAgfTsKICAKICBWYWxpZGF0YWJsZS5wcm90b3R5cGUuYXBwbHlDb25zdHJhaW50cyA9IGZ1bmN0aW9uKGZpZWxkcyl7CiAgICB2YXIgcGFyYW1ldGVycyA9IHRoaXMudmFsaWRhdGFibGVQYXJhbWV0ZXJzOwogICAgCiAgICBmaWVsZHMuZm9yRWFjaChmdW5jdGlvbihmaWVsZCl7CiAgICAgIHZhciBmaWVsZE5hbWUgPSBmaWVsZC5uYW1lOwogICAgICB2YXIgY29uc3RyYWludHMgPSBmaWVsZC5jb25zdHJhaW50czsKCiAgICAgIGlmKGNvbnN0cmFpbnRzID09IG51bGwgfHwgY29uc3RyYWludHMubGVuZ3RoID09IDApCiAgICAgICAgcmV0dXJuOwogICAgICAKICAgICAgdmFyIG9iamVjdCA9IGZpbmRGaWVsZChmaWVsZE5hbWUsIHBhcmFtZXRlcnMsICJFcnJvciBhcHBseWluZyBjb25zdHJhaW50cyB0byBmaWVsZCIpOwogICAgICAKICAgICAgaWYgKGtvLmlzT2JzZXJ2YWJsZShvYmplY3QpICYmICJ2YWxpZGF0b3IiIGluIG9iamVjdCkgewogICAgICAgIG9iamVjdC52YWxpZGF0b3Iuc2V0Q29uc3RyYWludHMoY29uc3RyYWludHMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiRXJyb3IgYXBwbHlpbmcgY29uc3RyYWludHMgdG8gZmllbGQ6ICIgKyBmaWVsZE5hbWUgKyAiXG4iICsKICAgICAgICAgICJJdCBpcyBub3QgYW4gb2JzZXJ2YWJsZSBvciBpcyBub3QgZXh0ZW5kZWQgd2l0aCBhIHZhbGlkYXRvci4gXG4iICsKICAgICAgICAgIGZpZWxkTmFtZSArICI9YCIgKyBrby50b0pTT04ob2JqZWN0KSArICJgIik7CiAgICAgIH0KICAgIH0pOwogIH07CiAgCiAgVmFsaWRhdGFibGUucHJvdG90eXBlLnZhbGlkYXRlID0gZnVuY3Rpb24oKXsKICAgIHRoaXMudmFsaWRhdG9yLnZhbGlkYXRlKHRydWUpOwogICAgaWYgKHRoaXMudmFsaWRhdG9yLmlzVmFsaWQoKSkgewogICAgICB0aGlzLnZhbGlkYXRhYmxlRmllbGRzLmZvckVhY2goZnVuY3Rpb24oY29uc3RyYWludCl7CiAgICAgICAgdmFyIHZhbGlkYXRvciA9IGNvbnN0cmFpbnQudmFsaWRhdG9yOwogICAgICAgIGlmICh2YWxpZGF0b3IpIHsKICAgICAgICAgIHZhbGlkYXRvci52YWxpZGF0ZShjb25zdHJhaW50KCkpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfTsKICAKICBWYWxpZGF0YWJsZS5wcm90b3R5cGUuY2xlYXJWYWxpZGF0aW9uTWVzc2FnZXMgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLnZhbGlkYXRvci5yZXNldCgpOwogICAgdGhpcy52YWxpZGF0YWJsZUZpZWxkcy5mb3JFYWNoKGZ1bmN0aW9uKGNvbnN0cmFpbnQpewogICAgICB2YXIgdmFsaWRhdG9yID0gY29uc3RyYWludC52YWxpZGF0b3I7CiAgICAgIGlmICh2YWxpZGF0b3IpIHsKICAgICAgICB2YWxpZGF0b3IucmVzZXQoKTsKICAgICAgfQogICAgfSk7CiAgfTsKICAKICAKICAKICBmdW5jdGlvbiByZWN1cnNpdmx5RXh0ZW5kUGFyYW1ldGVycyhwYXJhbWV0ZXJzLCB2YWxpZGF0YWJsZUZpZWxkcywgcGFyZW50cykgewogICAgZm9yICh2YXIga2V5IGluIHBhcmFtZXRlcnMpIHsKICAgICAgdmFyIHByb3BlcnR5ID0gcGFyYW1ldGVyc1trZXldOwogICAgICB2YXIgcGF0aCA9IHBhcmVudHMuY29uY2F0KFtrZXldKTsKICAgICAgaWYgKGtvLmlzT2JzZXJ2YWJsZShwcm9wZXJ0eSkpIHsKICAgICAgICBwcm9wZXJ0eS5leHRlbmQoewogICAgICAgICAgdmFsaWRhdGlvbjogewogICAgICAgICAgICBuYW1lOmtleSwKICAgICAgICAgICAgcGF0aDpwYXRoLmpvaW4oIi4iKQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhbGlkYXRhYmxlRmllbGRzLnB1c2gocHJvcGVydHkpOwogICAgICB9CiAgICAgIHByb3BlcnR5ID0ga28udXRpbHMudW53cmFwT2JzZXJ2YWJsZShwcm9wZXJ0eSk7CiAgICAgIGlmICh0eXBlb2YgcHJvcGVydHkgPT09ICJvYmplY3QiKSB7CiAgICAgICAgcmVjdXJzaXZseUV4dGVuZFBhcmFtZXRlcnMocHJvcGVydHksIHZhbGlkYXRhYmxlRmllbGRzLCBwYXRoKTsKICAgICAgfQogICAgfQogIH0KCgogIGZ1bmN0aW9uIGZpbmRGaWVsZChmaWVsZFBhdGgsIHBhcmFtZXRlcnMsIGVycm9yTWVzc2FnZSl7CiAgICByZXR1cm4gZmllbGRQYXRoLnNwbGl0KCIuIikucmVkdWNlKGZ1bmN0aW9uKG9iamVjdCwgbmFtZSl7CiAgICAgIHZhciBwYXRoID0gb2JqZWN0LnBhdGg7CiAgICAgIHZhciBmaWVsZCA9IGtvLnV0aWxzLnVud3JhcE9ic2VydmFibGUob2JqZWN0LmZpZWxkKTsKICAgICAgaWYgKG5hbWUgaW4gZmllbGQpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZmllbGQ6IGZpZWxkW25hbWVdLAogICAgICAgICAgcGF0aDogcGF0aCArICIuIiArIG5hbWUKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UgKyAiOiAiICsgZmllbGRQYXRoICsgIlxuIiArCiAgICAgICAgICBuYW1lICsgIiBpcyBub3QgYSBtZW1iZXIgb2YgIiArIHBhdGggKyAiXG4iICsKICAgICAgICAgIHBhdGggKyAiID0gYCIgKyBrby50b0pTT04oZmllbGQpICsgImAiKTsKICAgICAgfQogICAgfSwgewogICAgICBmaWVsZDogcGFyYW1ldGVycywKICAgICAgcGF0aDogInBhcmFtZXRlcnMiCiAgICB9KS5maWVsZDsKICB9CgoKCiAgCiAgZnVuY3Rpb24gYXBwbHlWaW9sYXRpb25NZXNzYWdlVG9GaWVsZChwYXJhbWV0ZXJzLCBmaWVsZFBhdGgsIG1lc3NhZ2UpIHsKICAgIHZhciBvYmplY3QgPSBmaW5kRmllbGQoZmllbGRQYXRoLCBwYXJhbWV0ZXJzLCAiRXJyb3IgYXBwbHlpbmcgdmlvbGF0aW9uIik7CiAgICAKICAgIGlmICh0eXBlb2YgbWVzc2FnZSA9PT0gInN0cmluZyIgJiYgInZhbGlkYXRvciIgaW4gb2JqZWN0KSB7CiAgICAgIG9iamVjdC52YWxpZGF0b3IuaXNWYWxpZChmYWxzZSk7CiAgICAgIG9iamVjdC52YWxpZGF0b3IubWVzc2FnZShtZXNzYWdlKTsKICAgIH1lbHNlewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkVycm9yIGFwcGx5aW5nIHZpb2xhdGlvblxuIitmaWVsZFBhdGgrIiBpcyBub3QgdmFsaWRhdGFibGVcbml0IHNob3VsZCBiZSBhbiBvYnNlcnZhYmxlIik7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gYXBwbHlWaW9sYXRpb25NZXNzYWdlVG9WYWxpZGF0YWJsZSh2YWxpZGF0YWJsZSwgbWVzc2FnZSkgewogICAgdmFsaWRhdGFibGUudmFsaWRhdG9yLmlzVmFsaWQoZmFsc2UpOwogICAgdmFyIG9sZE1lc3NhZ2UgPSB2YWxpZGF0YWJsZS52YWxpZGF0b3IubWVzc2FnZSgpOwogICAgdmFyIG5ld01lc3NhZ2UgPSBvbGRNZXNzYWdlLmxlbmd0aCA9PSAwID8gbWVzc2FnZSA6IG9sZE1lc3NhZ2UgKyAiLCAiICsgbWVzc2FnZTsKICAgIHZhbGlkYXRhYmxlLnZhbGlkYXRvci5tZXNzYWdlKG5ld01lc3NhZ2UpOwogIH07CiAgCiAgCiAgCiAgcmV0dXJuIFZhbGlkYXRhYmxlOwp9KTsKZGVmaW5lKCdkZWNvL3F2Yy9FeGVjdXRhYmxlJyxbCiAgImRlY28vcXZjL0V4ZWN1dGFibGVSZXN1bHQiLCAKICAiZGVjby9xdmMvVmFsaWRhdGFibGUiLCAKICAiZGVjby91dGlscyIsIAogICJrbm9ja291dCIKXSwgZnVuY3Rpb24oCiAgRXhlY3V0YWJsZVJlc3VsdCwgCiAgVmFsaWRhdGFibGUsIAogIHV0aWxzLCAKICBrbyl7CgogIGZ1bmN0aW9uIEV4ZWN1dGFibGUobmFtZSwgdHlwZSwgcGFyYW1ldGVycywgY2FsbGJhY2tzLCBxdmMpeyAgICAKICAgIFZhbGlkYXRhYmxlLmNhbGwodGhpcywgbmFtZSwgcGFyYW1ldGVycywgcXZjLmNvbnN0cmFpbnRSZXNvbHZlcikKICAgIAogICAgdGhpcy5uYW1lID0gbmFtZTsKICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICB0aGlzLnF2YyA9IHF2YzsKICAgIHRoaXMuaXNCdXN5ID0ga28ub2JzZXJ2YWJsZShmYWxzZSk7CiAgICB0aGlzLmhhc0Vycm9yID0ga28ub2JzZXJ2YWJsZShmYWxzZSk7CiAgICB0aGlzLnJlc3VsdCA9IG5ldyBFeGVjdXRhYmxlUmVzdWx0KCk7CiAgICAKICAgIHRoaXMucGFyYW1ldGVycyA9IE9iamVjdC5zZWFsKHBhcmFtZXRlcnMpOwogICAgdGhpcy5jYWxsYmFja3MgPSB1dGlscy5leHRlbmQoewogICAgICBiZWZvcmVFeGVjdXRlOiBmdW5jdGlvbiAoKSB7fSwKICAgICAgY2FuRXhlY3V0ZTogZnVuY3Rpb24oKXtyZXR1cm4gdHJ1ZTt9LAogICAgICBlcnJvcjogZnVuY3Rpb24gKCkge30sCiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uICgpIHt9LAogICAgICByZXN1bHQ6IGZ1bmN0aW9uKCl7fSwKICAgICAgY29tcGxldGU6IGZ1bmN0aW9uICgpIHt9LAogICAgICBpbnZhbGlkOiBmdW5jdGlvbigpIHt9CiAgICB9LCBjYWxsYmFja3MpOwogIH0KICAgIAogIEV4ZWN1dGFibGUucHJvdG90eXBlID0gdXRpbHMuaW5oZXJpdHNGcm9tKFZhbGlkYXRhYmxlKTsKICAgIAogIEV4ZWN1dGFibGUucHJvdG90eXBlLmV4ZWN1dGUgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAodGhpcy5vbkJlZm9yZUV4ZWN1dGUoKSA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5xdmMuZXhlY3V0ZSh0aGlzKTsKICB9OwoKICBFeGVjdXRhYmxlLnByb3RvdHlwZS5vbkJlZm9yZUV4ZWN1dGUgPSBmdW5jdGlvbiAoKSB7CgogICAgaWYgKHRoaXMuaXNCdXN5KCkpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHRoaXMuaGFzRXJyb3IoZmFsc2UpOwoKICAgIHRoaXMuY2FsbGJhY2tzLmJlZm9yZUV4ZWN1dGUoKTsKCiAgICB0aGlzLnZhbGlkYXRlKCk7CiAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgIHRoaXMuY2FsbGJhY2tzLmludmFsaWQoKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmICh0aGlzLmNhbGxiYWNrcy5jYW5FeGVjdXRlKCkgPT09IGZhbHNlKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHRoaXMuaXNCdXN5KHRydWUpOwoKICAgIHJldHVybiB0cnVlOwogIH07CgogIEV4ZWN1dGFibGUucHJvdG90eXBlLm9uRXJyb3IgPSBmdW5jdGlvbiAoKSB7CiAgICB0aGlzLmhhc0Vycm9yKHRydWUpOwogICAgaWYoInZpb2xhdGlvbnMiIGluIHRoaXMucmVzdWx0ICYmIHRoaXMucmVzdWx0LnZpb2xhdGlvbnMgIT0gbnVsbCkKICAgICAgdGhpcy5hcHBseVZpb2xhdGlvbnModGhpcy5yZXN1bHQudmlvbGF0aW9ucyk7CiAgICB0aGlzLmNhbGxiYWNrcy5lcnJvcih0aGlzLnJlc3VsdCk7CiAgfTsKCiAgRXhlY3V0YWJsZS5wcm90b3R5cGUub25TdWNjZXNzID0gZnVuY3Rpb24gKCkgewogICAgdGhpcy5oYXNFcnJvcihmYWxzZSk7CiAgICB0aGlzLmNsZWFyVmFsaWRhdGlvbk1lc3NhZ2VzKCk7CiAgICB0aGlzLmNhbGxiYWNrcy5zdWNjZXNzKHRoaXMucmVzdWx0KTsKICAgIHRoaXMuY2FsbGJhY2tzLnJlc3VsdCh0aGlzLnJlc3VsdC5yZXN1bHQpOwogIH07CgogIEV4ZWN1dGFibGUucHJvdG90eXBlLm9uQ29tcGxldGUgPSBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIXRoaXMuaGFzRXJyb3IoKSkgewogICAgICB0aGlzLmNhbGxiYWNrcy5jb21wbGV0ZSh0aGlzLnJlc3VsdCk7CiAgICAgIHRoaXMuY2xlYXJWYWxpZGF0aW9uTWVzc2FnZXMoKTsKICAgIH0KICAgIHRoaXMuaXNCdXN5KGZhbHNlKTsKICB9OwogIAogIEV4ZWN1dGFibGUuQ29tbWFuZCA9ICJjb21tYW5kIjsKICBFeGVjdXRhYmxlLlF1ZXJ5ID0gInF1ZXJ5IjsKICAKICByZXR1cm4gRXhlY3V0YWJsZTsKfSk7CmRlZmluZSgnZGVjby9hamF4JyxbXSwgZnVuY3Rpb24oKXsKICBmdW5jdGlvbiBkYXRhVG9QYXJhbXMoZGF0YSl7CiAgICB2YXIgcGFyYW1zID0gW10KICAgIGZvcih2YXIga2V5IGluIGRhdGEpewogICAgICB2YXIgdmFsdWUgPSBkYXRhW2tleV07CiAgICAgIHBhcmFtcy5wdXNoKGVuY29kZVVSSUNvbXBvbmVudChrZXkpICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKSk7CiAgICB9CiAgICByZXR1cm4gcGFyYW1zLmpvaW4oIiYiKTsKICB9CgogIGZ1bmN0aW9uIGFkZFBhcmFtVG9VcmwodXJsLCBuYW1lLCB2YWx1ZSl7CiAgICByZXR1cm4gdXJsICsgKHVybC5tYXRjaCgvXD8vKSA/ICh1cmwubWF0Y2goLyYkLykgPyAiIiA6ICImIikgOiAiPyIpICsgZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpICsgIj0iICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKICB9CgogIGZ1bmN0aW9uIGFkZFBhcmFtc1RvVXJsKHVybCwgZGF0YSl7CiAgICB2YXIgcGFyYW1zID0gZGF0YVRvUGFyYW1zKGRhdGEpOwogICAgcmV0dXJuIHVybCArICh1cmwubWF0Y2goL1w/LykgPyAodXJsLm1hdGNoKC8mJC8pID8gIiIgOiAocGFyYW1zLmxlbmd0aCA+IDAgPyAiJiIgOiAiIikpIDogIj8iKSArIHBhcmFtczsKICB9CgogIGZ1bmN0aW9uIGFkZFRvUGF0aCh1cmwsIHNlZ21lbnQpewogICAgcmV0dXJuIHVybCArICh1cmwubWF0Y2goL1wvJC8pID8gIiIgOiAiLyIpICsgc2VnbWVudDsKICB9CgogIGZ1bmN0aW9uIGNhY2hlQnVzdCh1cmwpewogICAgcmV0dXJuIGFkZFBhcmFtVG9VcmwodXJsLCAiY2FjaGVLZXkiLCBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkqTWF0aC5wb3coMiw1MykpKTsKICB9CgogIGZ1bmN0aW9uIGFqYXgodXJsLCBvYmplY3QsIG1ldGhvZCwgY2FsbGJhY2spewogICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgCiAgICB2YXIgaXNQb3N0ID0gKG1ldGhvZCA9PT0gIlBPU1QiKTsKICAgIHZhciBkYXRhID0gbnVsbDsKICAgIAogICAgaWYob2JqZWN0KXsKCiAgICAgIGlmKGlzUG9zdCl7CiAgICAgICAgZGF0YSA9IGRhdGFUb1BhcmFtcyhvYmplY3QpOwogICAgICB9IGVsc2UgewogICAgICAgIHVybCA9IGFkZFBhcmFtc1RvVXJsKHVybCwgb2JqZWN0KTsKICAgICAgfQogICAgfQogICAgCiAgICBpZihpc1Bvc3QpewogICAgICB1cmwgPSBjYWNoZUJ1c3QodXJsKTsKICAgIH0KCiAgICB4aHIub3BlbihtZXRob2QsIHVybCwgdHJ1ZSk7CiAgICAKICAgIGlmKGlzUG9zdCAmJiBkYXRhKXsKICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoIkNvbnRlbnQtdHlwZSIsICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiKTsKICAgIH0KICAgIAogICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtUmVxdWVzdGVkLVdpdGgnLCAnWE1MSHR0cFJlcXVlc3QnKTsKICAgIAogICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmKHhoci5yZWFkeVN0YXRlID09IDQpewogICAgICAgIGNhbGxiYWNrKHhocik7CiAgICAgIH0KICAgIH0KICAgIAogICAgeGhyLnNlbmQoZGF0YSk7CiAgICByZXR1cm4geGhyOwogIH0KCiAgYWpheC5hZGRQYXJhbVRvVXJsID0gYWRkUGFyYW1Ub1VybDsKICBhamF4LmFkZFBhcmFtc1RvVXJsID0gYWRkUGFyYW1zVG9Vcmw7CiAgYWpheC5hZGRUb1BhdGggPSBhZGRUb1BhdGg7CiAgYWpheC5jYWNoZUJ1c3QgPSBjYWNoZUJ1c3Q7CgoKICByZXR1cm4gYWpheDsKfSk7CmRlZmluZSgnZGVjby9xdmMvQ29uc3RyYWludFJlc29sdmVyJyxbXSwgZnVuY3Rpb24oKXsKCiAgdmFyIFNUQVRFX0xPQURJTkcgPSAnbG9hZGluZyc7CiAgdmFyIFNUQVRFX0xPQURFRCA9ICdsb2FkZWQnOwoKICBmdW5jdGlvbiBmaW5kQ29uc3RyYWludChuYW1lLCBjb25zdHJhaW50cykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb25zdHJhaW50cy5sZW5ndGg7IGkrKykgewogICAgICBpZiAoY29uc3RyYWludHNbaV0ubmFtZSA9PSBuYW1lKSB7CiAgICAgICAgcmV0dXJuIGNvbnN0cmFpbnRzW2ldOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBmdW5jdGlvbiBjb25zdHJhaW50c0xvYWRlZChuYW1lLCBmaWVsZHMpewogICAgdmFyIGNvbnN0cmFpbnQgPSBmaW5kQ29uc3RyYWludChuYW1lLCB0aGlzLmNvbnN0cmFpbnRzKTsKICAgIGlmKGNvbnN0cmFpbnQpewogICAgICBjb25zdHJhaW50LnZhbGlkYXRhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uKHZhbGlkYXRhYmxlKXsKICAgICAgICB2YWxpZGF0YWJsZS5hcHBseUNvbnN0cmFpbnRzKGZpZWxkcyk7CiAgICAgIH0pOwogICAgICBjb25zdHJhaW50LmZpZWxkcyA9IGZpZWxkczsKICAgICAgY29uc3RyYWludC5zdGF0ZSA9IFNUQVRFX0xPQURFRDsKICAgICAgY29uc3RyYWludC52YWxpZGF0YWJsZXMgPSBbXTsKICAgIH0KICB9CgoKICBmdW5jdGlvbiBDb25zdHJhaW50UmVzb2x2ZXIocXZjKXsKICAgIHRoaXMucXZjID0gcXZjOwogICAgdGhpcy5jb25zdHJhaW50cyA9IFtdOwogIH0KICAKICBDb25zdHJhaW50UmVzb2x2ZXIucHJvdG90eXBlLmFwcGx5VmFsaWRhdGlvbkNvbnN0cmFpbnRzID0gZnVuY3Rpb24obmFtZSwgdmFsaWRhdGFibGUpewogICAgdmFyIGNvbnN0cmFpbnQgPSBmaW5kQ29uc3RyYWludChuYW1lLCB0aGlzLmNvbnN0cmFpbnRzKTsKICAgIGlmKGNvbnN0cmFpbnQgPT09IGZhbHNlKXsKICAgICAgdGhpcy5jb25zdHJhaW50cy5wdXNoKHsKICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgIHN0YXRlOiBTVEFURV9MT0FESU5HLAogICAgICAgIHZhbGlkYXRhYmxlczogW3ZhbGlkYXRhYmxlXQogICAgICB9KTsKICAgICAgdGhpcy5xdmMubG9hZENvbnN0cmFpbnRzKG5hbWUsIGNvbnN0cmFpbnRzTG9hZGVkLmJpbmQodGhpcykpOwogICAgfWVsc2V7CiAgICAgIGlmKGNvbnN0cmFpbnQuc3RhdGUgPT09IFNUQVRFX0xPQURJTkcpewogICAgICAgIGNvbnN0cmFpbnQudmFsaWRhdGFibGVzLnB1c2godmFsaWRhdGFibGUpOwogICAgICB9ZWxzZXsKICAgICAgICB2YWxpZGF0YWJsZS5hcHBseUNvbnN0cmFpbnRzKGNvbnN0cmFpbnQuZmllbGRzKTsKICAgICAgfQogICAgfQogIH07CiAgCiAgcmV0dXJuIENvbnN0cmFpbnRSZXNvbHZlcjsKfSk7CmRlZmluZSgnZGVjby9lcnJvckhhbmRsZXInLFtdLCBmdW5jdGlvbigpewogIHJldHVybiB7CiAgICBvbkVycm9yOiBmdW5jdGlvbihlcnJvcil7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfSwxKTsKICAgIH0KICB9Owp9KTsKZGVmaW5lKCdkZWNvL3F2YycsWwogICJkZWNvL3F2Yy9FeGVjdXRhYmxlIiwgCiAgImRlY28vcXZjL0V4ZWN1dGFibGVSZXN1bHQiLCAKICAiZGVjby91dGlscyIsIAogICJkZWNvL2FqYXgiLAogICJkZWNvL3F2Yy9Db25zdHJhaW50UmVzb2x2ZXIiLAogICJkZWNvL2Vycm9ySGFuZGxlciIsCiAgImtub2Nrb3V0IiwgCiAgImRlY28vcXZjL2tvRXh0ZW5zaW9ucyJdLCAKICBmdW5jdGlvbigKICAgIEV4ZWN1dGFibGUsCiAgICBFeGVjdXRhYmxlUmVzdWx0LAogICAgdXRpbHMsCiAgICBhamF4LAogICAgQ29uc3RyYWludFJlc29sdmVyLAogICAgZXJyb3JIYW5kbGVyLAogICAga28pewogIAogIGZ1bmN0aW9uIFFWQygpewoKICAgIHZhciBxdmMgPSB0aGlzOwoKICAgIHRoaXMuY29uc3RyYWludFJlc29sdmVyID0gbmV3IENvbnN0cmFpbnRSZXNvbHZlcihxdmMpOwoKICAgIHRoaXMuZXhlY3V0ZSA9IGZ1bmN0aW9uKGV4ZWN1dGFibGUpewogICAgICB2YXIgcGFyYW1ldGVycyA9IGtvLnRvSlMoZXhlY3V0YWJsZS5wYXJhbWV0ZXJzKTsKICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgcGFyYW1ldGVyczogSlNPTi5zdHJpbmdpZnkocGFyYW1ldGVycyksCiAgICAgICAgY3NyZlRva2VuOiBxdmMuY29uZmlnLmNzcmYKICAgICAgfTsKICAgICAgdmFyIHVybCA9IGFqYXguYWRkVG9QYXRoKHF2Yy5jb25maWcuYmFzZVVybCwgZXhlY3V0YWJsZS50eXBlICsgIi8iICsgZXhlY3V0YWJsZS5uYW1lKTsKICAgICAgYWpheCh1cmwsIGRhdGEsICJQT1NUIiwgZnVuY3Rpb24gKHhocikgewogICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgIGV4ZWN1dGFibGUucmVzdWx0ID0gbmV3IEV4ZWN1dGFibGVSZXN1bHQoSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0IHx8ICJ7fSIpKTsKICAgICAgICAgIGlmIChleGVjdXRhYmxlLnJlc3VsdC5zdWNjZXNzID09PSB0cnVlKSB7CiAgICAgICAgICAgIGV4ZWN1dGFibGUub25TdWNjZXNzKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZihleGVjdXRhYmxlLnJlc3VsdC5leGNlcHRpb24gJiYgZXhlY3V0YWJsZS5yZXN1bHQuZXhjZXB0aW9uLm1lc3NhZ2UpewogICAgICAgICAgICAgIGVycm9ySGFuZGxlci5vbkVycm9yKGV4ZWN1dGFibGUucmVzdWx0LmV4Y2VwdGlvbi5tZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBleGVjdXRhYmxlLm9uRXJyb3IoKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZXhlY3V0YWJsZS5yZXN1bHQgPSBuZXcgRXhlY3V0YWJsZVJlc3VsdCh7ZXhjZXB0aW9uOiB7bWVzc2FnZTogeGhyLnJlc3BvbnNlVGV4dCwgY2F1c2U6IHhocn19KTsKICAgICAgICAgIGVycm9ySGFuZGxlci5vbkVycm9yKGV4ZWN1dGFibGUucmVzdWx0LmV4Y2VwdGlvbi5tZXNzYWdlKTsKICAgICAgICAgIGV4ZWN1dGFibGUub25FcnJvcigpOwogICAgICAgIH0KICAgICAgICBleGVjdXRhYmxlLm9uQ29tcGxldGUoKTsKICAgICAgfSk7CiAgICAKICAgIH07CiAgICAKICAgIHRoaXMubG9hZENvbnN0cmFpbnRzID0gZnVuY3Rpb24obmFtZSwgY2FsbGJhY2spewogICAgICB2YXIgdXJsID0gYWpheC5hZGRUb1BhdGgocXZjLmNvbmZpZy5iYXNlVXJsLCAiY29uc3RyYWludHMvIiArIG5hbWUpOwogICAgICBhamF4KHVybCwgbnVsbCwgIkdFVCIsIGZ1bmN0aW9uKHhocil7CiAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgdHJ5ewogICAgICAgICAgICB2YXIgcmVzcG9uc2UgPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQgfHwgIntcInBhcmFtZXRlcnNcIjpbXX0iKTsKICAgICAgICAgICAgaWYoInBhcmFtZXRlcnMiIGluIHJlc3BvbnNlID09IGZhbHNlKXsKICAgICAgICAgICAgICByZXNwb25zZS5wYXJhbWV0ZXJzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYocmVzcG9uc2UuZXhjZXB0aW9uICYmIHJlc3BvbnNlLmV4Y2VwdGlvbi5tZXNzYWdlKXsKICAgICAgICAgICAgICBlcnJvckhhbmRsZXIub25FcnJvcihyZXNwb25zZS5leGNlcHRpb24ubWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH1jYXRjaChlKXsKICAgICAgICAgICAgdmFyIHJlc3BvbnNlID0ge3BhcmFtZXRlcnM6IFtdfTsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrKG5hbWUsIHJlc3BvbnNlLnBhcmFtZXRlcnMpOwogICAgICAgIH1lbHNlewogICAgICAgICAgZXJyb3JIYW5kbGVyLm9uRXJyb3IoeGhyLnJlc3BvbnNlVGV4dCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH07CgogICAgCiAgICB0aGlzLmNvbmZpZyA9IHsKICAgICAgYmFzZVVybDogIi8iLAogICAgICBjc3JmOiAiIgogICAgfQogIH07CgogIHZhciBxdmMgPSBuZXcgUVZDKCk7CiAgCiAgZnVuY3Rpb24gY3JlYXRlRXhlY3V0YWJsZShuYW1lLCB0eXBlLCBwYXJhbWV0ZXJzLCBjYWxsYmFja3MpeyAgCiAgICB2YXIgZXhlY3V0YWJsZSA9IG5ldyBFeGVjdXRhYmxlKG5hbWUsIHR5cGUsIHBhcmFtZXRlcnMgfHwge30sIGNhbGxiYWNrcyB8fCB7fSwgcXZjKTsKICAgIHZhciBleGVjdXRlID0gZXhlY3V0YWJsZS5leGVjdXRlLmJpbmQoZXhlY3V0YWJsZSk7CiAgICBleGVjdXRlLmlzVmFsaWQgPSBrby5jb21wdXRlZChleGVjdXRhYmxlLmlzVmFsaWQsIGV4ZWN1dGFibGUpOwogICAgZXhlY3V0ZS5pc0J1c3kgPSBrby5jb21wdXRlZChleGVjdXRhYmxlLmlzQnVzeSwgZXhlY3V0YWJsZSk7CiAgICBleGVjdXRlLmhhc0Vycm9yID0ga28uY29tcHV0ZWQoZXhlY3V0YWJsZS5oYXNFcnJvciwgZXhlY3V0YWJsZSk7CiAgICBleGVjdXRlLnN1Y2Nlc3MgPSBmdW5jdGlvbihjYWxsYmFjayl7CiAgICAgIGV4ZWN1dGFibGUuY2FsbGJhY2tzLnN1Y2Nlc3MgPSBjYWxsYmFjazsKICAgICAgcmV0dXJuIGV4ZWN1dGU7CiAgICB9OwogICAgZXhlY3V0ZS5lcnJvciA9IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgZXhlY3V0YWJsZS5jYWxsYmFja3MuZXJyb3IgPSBjYWxsYmFjazsKICAgICAgcmV0dXJuIGV4ZWN1dGU7CiAgICB9OwogICAgZXhlY3V0ZS5pbnZhbGlkID0gZnVuY3Rpb24oY2FsbGJhY2spewogICAgICBleGVjdXRhYmxlLmNhbGxiYWNrcy5pbnZhbGlkID0gY2FsbGJhY2s7CiAgICAgIHJldHVybiBleGVjdXRlOwogICAgfTsKICAgIGV4ZWN1dGUuYmVmb3JlRXhlY3V0ZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgZXhlY3V0YWJsZS5jYWxsYmFja3MuYmVmb3JlRXhlY3V0ZSA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gZXhlY3V0ZTsKICAgIH07CiAgICBleGVjdXRlLmNhbkV4ZWN1dGUgPSBmdW5jdGlvbihjYWxsYmFjayl7CiAgICAgIGV4ZWN1dGFibGUuY2FsbGJhY2tzLmNhbkV4ZWN1dGUgPSBjYWxsYmFjazsKICAgICAgcmV0dXJuIGV4ZWN1dGU7CiAgICB9OwogICAgZXhlY3V0ZS5yZXN1bHQgPSBmdW5jdGlvbigpewogICAgICBpZihhcmd1bWVudHMubGVuZ3RoID09IDEpewogICAgICAgIGV4ZWN1dGFibGUuY2FsbGJhY2tzLnJlc3VsdCA9IGFyZ3VtZW50c1swXTsKICAgICAgICByZXR1cm4gZXhlY3V0ZTsKICAgICAgfQogICAgICByZXR1cm4gZXhlY3V0YWJsZS5yZXN1bHQucmVzdWx0OwogICAgfTsKICAgIGV4ZWN1dGUuY29tcGxldGUgPSBmdW5jdGlvbihjYWxsYmFjayl7CiAgICAgIGV4ZWN1dGFibGUuY2FsbGJhY2tzLmNvbXBsZXRlID0gY2FsbGJhY2s7CiAgICAgIHJldHVybiBleGVjdXRlOwogICAgfTsKICAgIGV4ZWN1dGUuY2xlYXJWYWxpZGF0aW9uTWVzc2FnZXMgPSBleGVjdXRhYmxlLmNsZWFyVmFsaWRhdGlvbk1lc3NhZ2VzLmJpbmQoZXhlY3V0YWJsZSk7CiAgICBleGVjdXRlLnZhbGlkYXRvciA9IGV4ZWN1dGFibGUudmFsaWRhdG9yOwogICAgZXhlY3V0ZS5wYXJhbWV0ZXJzID0gZXhlY3V0YWJsZS5wYXJhbWV0ZXJzOwogICAgZXhlY3V0ZS52YWxpZGF0ZSA9IGV4ZWN1dGFibGUudmFsaWRhdGUuYmluZChleGVjdXRhYmxlKTsKICAgIAogICAgcmV0dXJuIGV4ZWN1dGU7CiAgfQogIAogIHJldHVybiB7CiAgICBjcmVhdGVDb21tYW5kOiBmdW5jdGlvbihuYW1lLCBwYXJhbWV0ZXJzLCBjYWxsYmFja3MpewogICAgICBpZihuYW1lID09IG51bGwgfHwgbmFtZS5sZW5ndGggPT0gMCkKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNvbW1hbmQgaXMgbWlzc2luZyBuYW1lXG5BIGNvbW1hbmQgbXVzdCBoYXZlIGEgbmFtZSFcbnVzYWdlOiBjcmVhdGVDb21tYW5kKCduYW1lJywgW3BhcmFtZXRlcnMsIGNhbGxiYWNrc10pIik7CiAgICAgIHJldHVybiBjcmVhdGVFeGVjdXRhYmxlKG5hbWUsIEV4ZWN1dGFibGUuQ29tbWFuZCwgcGFyYW1ldGVycywgY2FsbGJhY2tzKTsKICAgIH0sCiAgICBjcmVhdGVRdWVyeTogZnVuY3Rpb24obmFtZSwgcGFyYW1ldGVycywgY2FsbGJhY2tzKXsKICAgICAgaWYobmFtZSA9PSBudWxsIHx8IG5hbWUubGVuZ3RoID09IDApCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJRdWVyeSBpcyBtaXNzaW5nIG5hbWVcbkEgcXVlcnkgbXVzdCBoYXZlIGEgbmFtZSFcbnVzYWdlOiBjcmVhdGVRdWVyeSgnbmFtZScsIFtwYXJhbWV0ZXJzLCBjYWxsYmFja3NdKSIpOwogICAgICByZXR1cm4gY3JlYXRlRXhlY3V0YWJsZShuYW1lLCBFeGVjdXRhYmxlLlF1ZXJ5LCBwYXJhbWV0ZXJzLCBjYWxsYmFja3MpOwogICAgfSwKICAgIGNvbmZpZzogZnVuY3Rpb24oY29uZmlnKXsKICAgICAgdXRpbHMuZXh0ZW5kKHF2Yy5jb25maWcsIGNvbmZpZyk7CiAgICB9CiAgfQp9KTsKZGVmaW5lKCdkZWNvL3NwYS9PdXRsZXQnLFsKICAia25vY2tvdXQiCl0sIGZ1bmN0aW9uKAogIGtvCil7CgogIGZ1bmN0aW9uIE91dGxldChlbGVtZW50LCBkb2N1bWVudCl7CiAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgdGhpcy5kb2N1bWVudCA9IGRvY3VtZW50IHx8IHdpbmRvdy5kb2N1bWVudDsKICB9CgogIE91dGxldC5wcm90b3R5cGUub3V0bGV0RXhpc3RzID0gZnVuY3Rpb24oKXsKICAgIHJldHVybiB0aGlzLmVsZW1lbnQgIT0gbnVsbDsKICB9OwoKICBPdXRsZXQucHJvdG90eXBlLnVubG9hZEN1cnJlbnRQYWdlID0gZnVuY3Rpb24oKXsKICAgIGtvLmNsZWFuTm9kZSh0aGlzLmVsZW1lbnQpOwogICAgdGhpcy5lbGVtZW50LmlubmVySFRNTCA9ICIiOwogIH07CgogIE91dGxldC5wcm90b3R5cGUuc2V0UGFnZUNvbnRlbnQgPSBmdW5jdGlvbihjb250ZW50KXsKICAgIHRoaXMuZWxlbWVudC5pbm5lckhUTUwgPSBjb250ZW50OwogIH07CgogIE91dGxldC5wcm90b3R5cGUuZ2V0UGFnZVRpdGxlID0gZnVuY3Rpb24oKXsKICAgIHZhciB0aXRsZU1ldGFUYWcgPSB0aGlzLmVsZW1lbnQucXVlcnlTZWxlY3RvcigibWV0YVtuYW1lPXRpdGxlXSIpOwogICAgcmV0dXJuICh0aXRsZU1ldGFUYWcgJiYgdGl0bGVNZXRhVGFnLmdldEF0dHJpYnV0ZSgiY29udGVudCIpKTsKICB9OwoKICBPdXRsZXQucHJvdG90eXBlLnNldERvY3VtZW50VGl0bGUgPSBmdW5jdGlvbih0aXRsZSl7CiAgICB0aGlzLmRvY3VtZW50LnRpdGxlID0gdGl0bGU7CiAgfTsKCiAgT3V0bGV0LnByb3RvdHlwZS5leHRyYWN0QW5kUnVuUGFnZUphdmFTY3JpcHQgPSBmdW5jdGlvbigpewogICAgdmFyIHNjcmlwdHMgPSB0aGlzLmVsZW1lbnQucXVlcnlTZWxlY3RvckFsbCgic2NyaXB0W3R5cGU9J3RleHQvamF2YXNjcmlwdCddIik7CiAgICBmb3IodmFyIGk9MDsgaTxzY3JpcHRzLmxlbmd0aDsgaSsrKXsKICAgICAgc2NyaXB0c1tpXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHNjcmlwdHNbaV0pOwogICAgICBpZihzY3JpcHRzW2ldLmlkID09PSAnJykgdGhyb3cgbmV3IEVycm9yKCJUaGUgc2NyaXB0IG11c3QgaGF2ZSBhbiBpZCIpOwogICAgICBpZih0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNjcmlwdHNbaV0uaWQpID09IG51bGwpewogICAgICAgIHZhciBzY3JpcHQgPSB0aGlzLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgICAgIHNjcmlwdC5pZCA9IHNjcmlwdHNbaV0uaWQ7CiAgICAgICAgc2NyaXB0LnRleHQgPSBzY3JpcHRzW2ldLnRleHRDb250ZW50OwogICAgICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCBzY3JpcHRzW2ldLmdldEF0dHJpYnV0ZSgndHlwZScpKTsKICAgICAgICB0aGlzLmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKICAgICAgfQogICAgfQogIH07CgogIE91dGxldC5wcm90b3R5cGUuaW5kaWNhdGVQYWdlSXNMb2FkaW5nID0gZnVuY3Rpb24oKXsKICAgIHRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUoImRhdGEtbG9hZGluZyIsICJ0cnVlIik7CiAgfTsKCiAgT3V0bGV0LnByb3RvdHlwZS5wYWdlSGFzTG9hZGVkID0gZnVuY3Rpb24oKXsKICAgIHRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUoImRhdGEtbG9hZGluZyIsICJmYWxzZSIpOwogIH07CgogIHJldHVybiBPdXRsZXQ7Cgp9KTsKZGVmaW5lKCdkZWNvL3NwYS93aGVuQ29udGV4dCcsWwogIApdLCBmdW5jdGlvbigKICAKKXsKCiAgZnVuY3Rpb24gdW5zdWJzY3JpYmUoZXZlbnQsIHJlYWN0aW9uKXsKICAgIGV2ZW50LmRvbnQocmVhY3Rpb24pOwogIH0KCiAgZnVuY3Rpb24gc3Vic2NyaWJlKGV2ZW50LCByZWFjdGlvbil7CiAgICBldmVudChyZWFjdGlvbik7CiAgICByZXR1cm4gZXZlbnQuZG9udC5iaW5kKG51bGwsIHJlYWN0aW9uKTsKICB9CgogIGZ1bmN0aW9uIHdoZW5Tb21ldGhpbmcoKXsKICAgIGlmKHRoaXMuZGVzdHJveWVkKSB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgY29udGV4dCBoYXMgYmVlbiBkZXN0cm95ZWQhIik7CgogICAgaWYoYXJndW1lbnRzLmxlbmd0aCA9PSAwKXsKICAgICAgdmFyIGNoaWxkQ29udGV4dCA9IGNyZWF0ZUNvbnRleHQoKTsKICAgICAgdGhpcy5jaGlsZENvbnRleHRzLnB1c2goY2hpbGRDb250ZXh0KTsKICAgICAgcmV0dXJuIGNoaWxkQ29udGV4dC53aGVuOwogICAgfWVsc2UgaWYoYXJndW1lbnRzLmxlbmd0aCA9PSAxICYmIHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICJmdW5jdGlvbiIpewogICAgICByZXR1cm4gewogICAgICAgIGRvbnQ6IHVuc3Vic2NyaWJlLmJpbmQobnVsbCwgYXJndW1lbnRzWzBdKQogICAgICB9CiAgICB9ZWxzZSBpZihhcmd1bWVudHMubGVuZ3RoID09IDIgJiYgdHlwZW9mIGFyZ3VtZW50c1sxXSA9PT0gImZ1bmN0aW9uIil7CiAgICAgIHRoaXMuZXZlbnRTdWJzY3JpYmVycy5wdXNoKHN1YnNjcmliZShhcmd1bWVudHNbMF0sIGFyZ3VtZW50c1sxXSkpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gdGhpc0lzRGVzdHJveWVkKHJlYWN0aW9uKXsKICAgIHRoaXMub25EZXN0cm95TGlzdGVuZXJzLnB1c2gocmVhY3Rpb24pOwogIH0KCiAgZnVuY3Rpb24gZGVzdHJveUNoaWxkQ29udGV4dHMoKXsKICAgIHZhciBjb250ZXh0OwogICAgd2hpbGUoY29udGV4dCA9IHRoaXMuY2hpbGRDb250ZXh0cy5wb3AoKSkKICAgICAgY29udGV4dC5kZXN0cm95Q29udGV4dCgpOwogIH0KCiAgZnVuY3Rpb24gZGVzdHJveUNvbnRleHQoKXsKICAgIHZhciBzdWJzY3JpYmVyLCBsaXN0ZW5lciwgY29udGV4dDsKICAgIHdoaWxlKHN1YnNjcmliZXIgPSB0aGlzLmV2ZW50U3Vic2NyaWJlcnMucG9wKCkpCiAgICAgIHN1YnNjcmliZXIoKTsKICAgIHdoaWxlKGxpc3RlbmVyID0gdGhpcy5vbkRlc3Ryb3lMaXN0ZW5lcnMucG9wKCkpCiAgICAgIGxpc3RlbmVyKCk7CiAgICB3aGlsZShjb250ZXh0ID0gdGhpcy5jaGlsZENvbnRleHRzLnBvcCgpKQogICAgICBjb250ZXh0LmRlc3Ryb3lDb250ZXh0KCk7CiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWU7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVDb250ZXh0KCl7CiAgICB2YXIgY29udGV4dCA9IHsKICAgICAgZGVzdHJveWVkOiBmYWxzZSwKICAgICAgb25EZXN0cm95TGlzdGVuZXJzOiBbXSwKICAgICAgY2hpbGRDb250ZXh0czogW10sCiAgICAgIGV2ZW50U3Vic2NyaWJlcnM6IFtdCiAgICB9OwoKICAgIHZhciB3aGVuID0gd2hlblNvbWV0aGluZy5iaW5kKGNvbnRleHQpOwoKICAgIHdoZW4udGhpc0lzRGVzdHJveWVkID0gdGhpc0lzRGVzdHJveWVkLmJpbmQoY29udGV4dCk7CgogICAgd2hlbi5kZXN0cm95Q2hpbGRDb250ZXh0cyA9IGRlc3Ryb3lDaGlsZENvbnRleHRzLmJpbmQoY29udGV4dCk7CgogICAgcmV0dXJuIHsKICAgICAgd2hlbjogd2hlbiwKICAgICAgZGVzdHJveUNvbnRleHQ6IGRlc3Ryb3lDb250ZXh0LmJpbmQoY29udGV4dCkKICAgIH07CiAgfQoKICByZXR1cm4gY3JlYXRlQ29udGV4dCgpLndoZW47Cn0pOwpkZWZpbmUoJ2RlY28vc3BhL2FwcGx5Vmlld01vZGVscycsWwogICJkZWNvL3V0aWxzIiwKICAiZGVjby9lcnJvckhhbmRsZXIiLAogICJrbm9ja291dCIsIAogICJ3aGVuIiwgCiAgIndoZW4vY2FsbGJhY2tzIgpdLCBmdW5jdGlvbiAoCiAgdXRpbHMsIAogIGVycm9ySGFuZGxlciwKICBrbywgCiAgd2hlbiwgCiAgY2FsbGJhY2tzCikgewoKCiAgZnVuY3Rpb24gZ2V0QXR0cmlidXRlcyh0YXJnZXQpewoKICAgIHZhciB2aWV3TW9kZWxOYW1lID0gdGFyZ2V0LmdldEF0dHJpYnV0ZSgiZGF0YS12aWV3bW9kZWwiKTsKICAgIHZhciBtb2RlbCA9IHRhcmdldC5nZXRBdHRyaWJ1dGUoImRhdGEtbW9kZWwiKTsKICAgIGlmIChtb2RlbCAmJiBtb2RlbC5pbmRleE9mKCJ7IikgPT0gMCkgewogICAgICBtb2RlbCA9IEpTT04ucGFyc2UobW9kZWwpOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIHRhcmdldDogdGFyZ2V0LAogICAgICB2aWV3TW9kZWxOYW1lOiB2aWV3TW9kZWxOYW1lLAogICAgICBtb2RlbDogbW9kZWwKICAgIH07CiAgfQoKCiAgZnVuY3Rpb24gbG9hZFZpZXdNb2RlbChkYXRhKXsKCiAgICByZXR1cm4gY2FsbGJhY2tzLmNhbGwocmVxdWlyZSwgWwogICAgICBkYXRhLnZpZXdNb2RlbE5hbWUKICAgIF0pLnRoZW4oZnVuY3Rpb24oVmlld01vZGVsKXsKICAgICAgZGF0YS5WaWV3TW9kZWwgPSBWaWV3TW9kZWw7CiAgICAgIHJldHVybiBkYXRhOwogICAgfSwgZnVuY3Rpb24oZXJyb3IpewogICAgICBlcnJvckhhbmRsZXIub25FcnJvcihuZXcgRXJyb3IoIkNvdWxkIG5vdCBsb2FkIHRoZSBmb2xsb3dpbmcgbW9kdWxlczpcbiIrZXJyb3IucmVxdWlyZU1vZHVsZXMuam9pbigiXG4iKSkpOwogICAgICByZXR1cm4gbnVsbDsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gYXBwbHlWaWV3TW9kZWwoc3Vic2NyaWJlLCBkYXRhKSB7CiAgICB0cnl7CiAgICAgIHZhciB2aWV3TW9kZWwgPSBuZXcgZGF0YS5WaWV3TW9kZWwoZGF0YS5tb2RlbCB8fCB7fSwgc3Vic2NyaWJlKTsKICAgICAga28uYXBwbHlCaW5kaW5ncyh2aWV3TW9kZWwsIGRhdGEudGFyZ2V0KTsKICAgIH1jYXRjaChlKXsKICAgICAgZXJyb3JIYW5kbGVyLm9uRXJyb3IoZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB2aWV3TW9kZWxMb2FkZWRTdWNjZXNzZnVsbHkoZGF0YSl7CiAgICByZXR1cm4gZGF0YSAhPSBudWxsICYmIGRhdGEuVmlld01vZGVsICE9IG51bGw7CiAgfQoKICByZXR1cm4gZnVuY3Rpb24gKGRvbUVsZW1lbnQsIHN1YnNjcmliZSkgewoKICAgIGRvbUVsZW1lbnQgPSBkb21FbGVtZW50IHx8IGRvY3VtZW50LmJvZHk7CgogICAgdmFyIGVsZW1lbnRMaXN0ID0gdXRpbHMudG9BcnJheShkb21FbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIipbZGF0YS12aWV3bW9kZWxdIikpOwoKICAgIHZhciB2aWV3TW9kZWxzTG9hZGVkID0gZWxlbWVudExpc3QubWFwKGdldEF0dHJpYnV0ZXMpLm1hcChsb2FkVmlld01vZGVsKTsKCiAgICByZXR1cm4gd2hlbi5hbGwodmlld01vZGVsc0xvYWRlZCkudGhlbihmdW5jdGlvbihsaXN0KXsKICAgICAgbGlzdC5maWx0ZXIodmlld01vZGVsTG9hZGVkU3VjY2Vzc2Z1bGx5KS5mb3JFYWNoKGFwcGx5Vmlld01vZGVsLmJpbmQobnVsbCwgc3Vic2NyaWJlKSkKICAgIH0pOwogIH07Cn0pOwpkZWZpbmUoJ2RlY28vc3BhL2hhc2hOYXZpZ2F0aW9uJyxbCiAgImRlY28vdXRpbHMiCl0sZnVuY3Rpb24oCiAgXwopewoKCiAgCiAgZnVuY3Rpb24gbmV3UGF0aChjdXJyZW50UGF0aCwgbGluaywgaW5kZXgpewogICAgdmFyIGlzUmVsYXRpdmUgPSBfLnN0YXJ0c1dpdGgobGluaywgJy8nKSA9PT0gZmFsc2U7CiAgICB2YXIgaXNGb2xkZXIgPSBfLmVuZHNXaXRoKGxpbmssICcvJyk7CiAgICAKICAgIGlmKGxpbmsgPT09ICIvIil7CiAgICAgIHZhciBwYXRoID0gW107CiAgICB9ZWxzZSBpZihsaW5rID09PSAiIil7CiAgICAgIHZhciBwYXRoID0gW2luZGV4XTsKICAgIH1lbHNlewogICAgICB2YXIgcGF0aCA9IF8udHJpbShsaW5rLCAiLyIpLnNwbGl0KCIvIik7CiAgICB9CgogICAgaWYoaXNGb2xkZXIpewogICAgICBwYXRoLnB1c2goaW5kZXgpOwogICAgfQogICAgaWYoaXNSZWxhdGl2ZSl7CiAgICAgIHBhdGggPSBfLnBvcFRhaWwoY3VycmVudFBhdGgpLmNvbmNhdChwYXRoKTsKICAgIH0KCiAgICB2YXIgb3V0ID0gW107CgogICAgZm9yKHZhciBpID0gcGF0aC5sZW5ndGg+Pj4wOyBpLS07KXsKICAgICAgaWYocGF0aFtpXSA9PT0gIiIpewogICAgICAgIGNvbnRpbnVlOwogICAgICB9ZWxzZSBpZihwYXRoW2ldID09PSAiLiIpewogICAgICAgIGNvbnRpbnVlOwogICAgICB9ZWxzZSBpZihwYXRoW2ldID09PSAiLi4iKSB7CiAgICAgICAgaS0tOwogICAgICB9ZWxzZXsKICAgICAgICBvdXQudW5zaGlmdChwYXRoW2ldKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBvdXQ7CiAgfQoKICBmdW5jdGlvbiBoYXNoQ2hhbmdlZChjb25maWcsIG9uUGFnZUNoYW5nZWQsIGRvY3VtZW50KXsKCiAgICB2YXIgcGF0aCA9IF8uYWZ0ZXIoZG9jdW1lbnQubG9jYXRpb24uaHJlZiwgJyMnKTsKCiAgICB2YXIgaXNSZWxhdGl2ZSA9IF8uc3RhcnRzV2l0aChwYXRoLCAnLycpID09IGZhbHNlOwogICAgdmFyIGlzRm9sZGVyID0gXy5lbmRzV2l0aChwYXRoLCAnLycpOwoKICAgIGlmKGlzUmVsYXRpdmUgfHwgaXNGb2xkZXIpewogICAgICB2YXIgbmV3SGFzaCA9IG5ld1BhdGgodGhpcy5jdXJyZW50UGF0aCwgcGF0aCwgY29uZmlnLmluZGV4KS5qb2luKCcvJyk7CiAgICAgIGRvY3VtZW50LmxvY2F0aW9uLnJlcGxhY2UoIiMvIiArIG5ld0hhc2gpOwogICAgfWVsc2V7CiAgICAgIHRoaXMuY3VycmVudFBhdGggPSBuZXdQYXRoKHRoaXMuY3VycmVudFBhdGgsIHBhdGgsIGNvbmZpZy5pbmRleCk7CiAgICAgIG9uUGFnZUNoYW5nZWQodGhpcy5jdXJyZW50UGF0aC5qb2luKCcvJyksIHRoaXMuY3VycmVudFBhdGgubWFwKGZ1bmN0aW9uKHApe3JldHVybiBkZWNvZGVVUklDb21wb25lbnQocCk7fSkpOwogICAgfQoKICB9CiAgCiAgZnVuY3Rpb24gc3RhcnRIYXNoTmF2aWdhdGlvbihjb25maWcsIG9uUGFnZUNoYW5nZWQsIGRvYywgZ2xvYmFsKXsKICAgIGRvYyA9IGRvYyB8fCBkb2N1bWVudDsKICAgIGdsb2JhbCA9IGdsb2JhbCB8fCB3aW5kb3c7CgogICAgdmFyIHN0YXRlID0gewogICAgICBjdXJyZW50UGF0aDogW10KICAgIH07CiAgICB2YXIgb25IYXNoQ2hhbmdlZCA9IGhhc2hDaGFuZ2VkLmJpbmQoc3RhdGUsIGNvbmZpZywgb25QYWdlQ2hhbmdlZCwgZG9jKTsKICAgIG9uSGFzaENoYW5nZWQoKTsKICAgIF8uYWRkRXZlbnRMaXN0ZW5lcihnbG9iYWwsICJoYXNoY2hhbmdlIiwgb25IYXNoQ2hhbmdlZCwgZmFsc2UpOwoKICAgIHJldHVybiB7CiAgICAgIHN0b3A6IGZ1bmN0aW9uKCl7CiAgICAgICAgZ2xvYmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoImhhc2hjaGFuZ2UiLCBvbkhhc2hDaGFuZ2VkLCBmYWxzZSk7CiAgICAgIH0KICAgIH07CiAgfQoKCiAgcmV0dXJuIHsKICAgIHN0YXJ0OiBzdGFydEhhc2hOYXZpZ2F0aW9uCiAgfTsKCn0pOwpkZWZpbmUoJ2RlY28vc3BhL1BhZ2VMb2FkZXInLFsKICAiZGVjby9hamF4IgpdLCBmdW5jdGlvbigKICBhamF4Cil7CgogIGZ1bmN0aW9uIFBhZ2VMb2FkZXIoY29uZmlnKXsKICAgIHRoaXMucGF0aFRvVXJsID0gY29uZmlnICYmIGNvbmZpZy5wYXRoVG9VcmwgfHwgZnVuY3Rpb24oYSl7IHJldHVybiBhOyB9OwogICAgdGhpcy5jYWNoZSA9IChjb25maWcgJiYgJ2NhY2hlUGFnZXMnIGluIGNvbmZpZyA/IGNvbmZpZy5jYWNoZVBhZ2VzIDogdHJ1ZSk7CiAgICB0aGlzLmN1cnJlbnRYSFIgPSBudWxsOwogIH0KCiAgUGFnZUxvYWRlci5wcm90b3R5cGUubG9hZFBhZ2UgPSBmdW5jdGlvbihwYXRoLCByZXNvbHZlcil7CgogICAgdGhpcy5hYm9ydCgpOwoKICAgIHZhciB1cmwgPSB0aGlzLnBhdGhUb1VybChwYXRoKTsKCiAgICBpZih0aGlzLmNhY2hlID09PSBmYWxzZSkKICAgICAgdXJsID0gYWpheC5jYWNoZUJ1c3QodXJsKTsKCiAgICB0aGlzLmN1cnJlbnRYSFIgPSBhamF4KHVybCwge30sICJHRVQiLCBmdW5jdGlvbih4aHIpewogICAgICBpZih4aHIuc3RhdHVzID09PSAyMDApCiAgICAgICAgcmVzb2x2ZXIucmVzb2x2ZSh4aHIucmVzcG9uc2VUZXh0KTsKICAgICAgZWxzZQogICAgICAgIHJlc29sdmVyLnJlamVjdCh7ZXJyb3I6IHhoci5zdGF0dXMsIGNvbnRlbnQ6IHhoci5yZXNwb25zZVRleHR9KTsKICAgIH0pOwogIH07CgogIFBhZ2VMb2FkZXIucHJvdG90eXBlLmFib3J0ID0gZnVuY3Rpb24oKXsKICAgIGlmKHRoaXMuY3VycmVudFhIUiAmJiB0aGlzLmN1cnJlbnRYSFIucmVhZHlTdGF0ZSAhPT0gNCl7CiAgICAgIHRoaXMuY3VycmVudFhIUi5hYm9ydCgpOwogICAgfQogIH07CgogIHJldHVybiBQYWdlTG9hZGVyOwp9KTsKZGVmaW5lKCdkZWNvL3NwYS9UZW1wbGF0ZXMnLFsKICAiZGVjby9zcGEvUGFnZUxvYWRlciIsCiAgImRlY28vdXRpbHMiLAogICJ3aGVuIgpdLCBmdW5jdGlvbigKICBQYWdlTG9hZGVyLAogIHV0aWxzLAogIHdoZW4KKXsKCiAgZnVuY3Rpb24gZGVmYXVsdENvbmZpZygpewogICAgcmV0dXJuIHsKICAgICAgcGF0aFRvVXJsOiBmdW5jdGlvbihhKXsgcmV0dXJuIGE7IH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGZpbmRUZW1wbGF0ZXNJbkRvY3VtZW50KGRvYyl7CgogICAgdmFyIG5vZGVMaXN0ID0gZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoIlt0eXBlPSd0ZXh0L3BhZ2UtdGVtcGxhdGUnXSIpOwogICAgdmFyIG5vZGVzID0gdXRpbHMudG9BcnJheShub2RlTGlzdCk7CiAgICB2YXIgdGVtcGxhdGVMaXN0ID0gbm9kZXMubWFwKGZ1bmN0aW9uKHRlbXBsYXRlKXsKICAgICAgcmV0dXJuIHsKICAgICAgICBpZDogdGVtcGxhdGUuaWQudG9Mb3dlckNhc2UoKSwKICAgICAgICBjb250ZW50OiB0ZW1wbGF0ZS5pbm5lckhUTUwKICAgICAgfTsKICAgIH0pOwoKICAgIHJldHVybiB1dGlscy5hcnJheVRvT2JqZWN0KHRlbXBsYXRlTGlzdCwgZnVuY3Rpb24oaXRlbSwgb2JqZWN0KXsKICAgICAgb2JqZWN0W2l0ZW0uaWRdID0gaXRlbS5jb250ZW50OwogICAgfSk7CiAgfQoKCiAgZnVuY3Rpb24gVGVtcGxhdGVzKGRvY3VtZW50LCBjb25maWcpewogICAgdGhpcy5wYWdlTG9hZGVyID0gbmV3IFBhZ2VMb2FkZXIoY29uZmlnIHx8IGRlZmF1bHRDb25maWcoKSk7CiAgICB0aGlzLmNhY2hlUGFnZXMgPSAoY29uZmlnICYmICdjYWNoZVBhZ2VzJyBpbiBjb25maWcgPyBjb25maWcuY2FjaGVQYWdlcyA6IHRydWUpCiAgICB0aGlzLnRlbXBsYXRlcyA9IGZpbmRUZW1wbGF0ZXNJbkRvY3VtZW50KGRvY3VtZW50KTsKICB9CgogIFRlbXBsYXRlcy5wcm90b3R5cGUuZ2V0VGVtcGxhdGUgPSBmdW5jdGlvbihwYXRoKXsKCiAgICB0aGlzLnBhZ2VMb2FkZXIuYWJvcnQoKTsKCiAgICB2YXIgbm9ybWFsaXplZFBhdGggPSBwYXRoLnRvTG93ZXJDYXNlKCk7CgogICAgaWYobm9ybWFsaXplZFBhdGggaW4gdGhpcy50ZW1wbGF0ZXMpewogICAgICByZXR1cm4gd2hlbi5yZXNvbHZlKHRoaXMudGVtcGxhdGVzW25vcm1hbGl6ZWRQYXRoXSk7CiAgICB9ZWxzZXsKICAgICAgdmFyIGRlZmVycmVkID0gd2hlbi5kZWZlcigpOwoKICAgICAgdGhpcy5wYWdlTG9hZGVyLmxvYWRQYWdlKHBhdGgsIGRlZmVycmVkLnJlc29sdmVyKTsKICAgICAgCiAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlLnRoZW4oZnVuY3Rpb24oY29udGVudCl7CiAgICAgICAgaWYodGhpcy5jYWNoZVBhZ2VzKQogICAgICAgICAgdGhpcy50ZW1wbGF0ZXNbbm9ybWFsaXplZFBhdGhdID0gY29udGVudDsKICAgICAgICAKICAgICAgICByZXR1cm4gY29udGVudDsKICAgICAgfS5iaW5kKHRoaXMpLCBmdW5jdGlvbihub3RGb3VuZCl7CiAgICAgICAgdmFyIGVycm9yVGVtcGxhdGUgPSAiZXJyb3IiICsgbm90Rm91bmQuZXJyb3I7CiAgICAgICAgaWYoZXJyb3JUZW1wbGF0ZSBpbiB0aGlzLnRlbXBsYXRlcyl7CiAgICAgICAgICByZXR1cm4gdGhpcy50ZW1wbGF0ZXNbZXJyb3JUZW1wbGF0ZV07CiAgICAgICAgfWVsc2V7CiAgICAgICAgICByZXR1cm4gbm90Rm91bmQuY29udGVudDsKICAgICAgICB9CiAgICAgIH0uYmluZCh0aGlzKSk7CiAgICB9CiAgfTsKCiAgcmV0dXJuIFRlbXBsYXRlczsKfSk7CmRlZmluZSgnZGVjby9wcm9jbGFpbVdoZW4nLFtdLCBmdW5jdGlvbiAoKSB7CgogIGZ1bmN0aW9uIHB1Ymxpc2gobmFtZSwgc3Vic2NyaWJlcnMsIGRhdGEpIHsKICAgIHN1YnNjcmliZXJzLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgaXRlbS5hcHBseShpdGVtLCBkYXRhKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gc3Vic2NyaWJlVG8obmFtZSwgc3Vic2NyaWJlcnMsIHN1YnNjcmliZXIpIHsKICAgIHZhciBpbmRleCA9IHN1YnNjcmliZXJzLmluZGV4T2Yoc3Vic2NyaWJlcik7CiAgICBpZihpbmRleCA8IDApCiAgICAgIHN1YnNjcmliZXJzLnB1c2goc3Vic2NyaWJlcik7CiAgICByZXR1cm4gaW5kZXggPCAwOwogIH0KICAKICBmdW5jdGlvbiB1bnN1YnNjcmliZUZyb20obmFtZSwgc3Vic2NyaWJlcnMsIHN1YnNjcmliZXIpewogICAgdmFyIGluZGV4ID0gc3Vic2NyaWJlcnMuaW5kZXhPZihzdWJzY3JpYmVyKTsKICAgIGlmKGluZGV4ID49IDApCiAgICAgIHN1YnNjcmliZXJzLnNwbGljZShpbmRleCwgMSk7CiAgICByZXR1cm4gaW5kZXggPj0gMDsKICB9CiAgZnVuY3Rpb24gZXh0ZW5kRXZlbnQobmFtZSwgZXZlbnQpewogICAgZXZlbnQuc3Vic2NyaWJlcnMgPSBbXTsKICAgIGV2ZW50LnN1YnNjcmliZVN1YnNjcmliZXJzID0gW107CiAgICBldmVudC51bnN1YnNjcmliZVN1YnNjcmliZXJzID0gW107CgogICAgdmFyIGV4dGVuZGVkRXZlbnQgPSBmdW5jdGlvbigpewogICAgICBpZihhcmd1bWVudHMubGVuZ3RoID09IDEgJiYgdHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gImZ1bmN0aW9uIil7CiAgICAgICAgaWYoc3Vic2NyaWJlVG8obmFtZSwgZXZlbnQuc3Vic2NyaWJlcnMsIGFyZ3VtZW50c1swXSkpCiAgICAgICAgICBwdWJsaXNoKG5hbWUrIi5pc1N1YnNjcmliZWRUbyIsIGV2ZW50LnN1YnNjcmliZVN1YnNjcmliZXJzKTsKICAgICAgfWVsc2V7CiAgICAgICAgcHVibGlzaChuYW1lLCBldmVudC5zdWJzY3JpYmVycywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfQoKICAgIGV4dGVuZGVkRXZlbnQuZG9udCA9IGZ1bmN0aW9uKHN1YnNjcmliZXIpewogICAgICBpZih1bnN1YnNjcmliZUZyb20obmFtZSwgZXZlbnQuc3Vic2NyaWJlcnMsIHN1YnNjcmliZXIpKQogICAgICAgIHB1Ymxpc2gobmFtZSsiLmlzVW5zdWJzY3JpYmVkRnJvbSIsIGV2ZW50LnVuc3Vic2NyaWJlU3Vic2NyaWJlcnMpOwogICAgfTsKCiAgICBleHRlbmRlZEV2ZW50LmlzU3Vic2NyaWJlZFRvID0gZnVuY3Rpb24oc3Vic2NyaWJlcil7CiAgICAgIHN1YnNjcmliZVRvKG5hbWUrIi5pc1N1YnNjcmliZWRUbyIsIGV2ZW50LnN1YnNjcmliZVN1YnNjcmliZXJzLCBzdWJzY3JpYmVyKTsKICAgIH07CgogICAgZXh0ZW5kZWRFdmVudC5pc1N1YnNjcmliZWRUby5kb250ID0gZnVuY3Rpb24oc3Vic2NyaWJlcil7CiAgICAgIHVuc3Vic2NyaWJlRnJvbShuYW1lKyIuaXNTdWJzY3JpYmVkVG8iLCBldmVudC5zdWJzY3JpYmVTdWJzY3JpYmVycywgc3Vic2NyaWJlcik7CiAgICB9OwoKICAgIGV4dGVuZGVkRXZlbnQuaXNVbnN1YnNjcmliZWRGcm9tID0gZnVuY3Rpb24oc3Vic2NyaWJlcil7CiAgICAgIHN1YnNjcmliZVRvKG5hbWUrIi5pc1Vuc3Vic2NyaWJlZEZyb20iLCBldmVudC51bnN1YnNjcmliZVN1YnNjcmliZXJzLCBzdWJzY3JpYmVyKTsKICAgIH07CgogICAgZXh0ZW5kZWRFdmVudC5pc1Vuc3Vic2NyaWJlZEZyb20uZG9udCA9IGZ1bmN0aW9uKHN1YnNjcmliZXIpewogICAgICB1bnN1YnNjcmliZUZyb20obmFtZSsiLmlzVW5zdWJzY3JpYmVkRnJvbSIsIGV2ZW50LnVuc3Vic2NyaWJlU3Vic2NyaWJlcnMsIHN1YnNjcmliZXIpOwogICAgfTsKCiAgICBleHRlbmRlZEV2ZW50LnRvU3RyaW5nID0gZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuICJbRXZlbnQgIituYW1lKyJdIjsKICAgIH0KCiAgICByZXR1cm4gZXh0ZW5kZWRFdmVudDsKICB9CiAgCiAgZnVuY3Rpb24gZXh0ZW5kKGV2ZW50cyl7CiAgICBmb3IodmFyIGkgaW4gZXZlbnRzKXsKICAgICAgZXZlbnRzW2ldID0gZXh0ZW5kRXZlbnQoaSwgZXZlbnRzW2ldKTsKICAgIH0KICAgIHJldHVybiBldmVudHM7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGUoYXJnMSwgYXJnMil7CiAgICBpZihhcmcyKQogICAgICByZXR1cm4gZXh0ZW5kRXZlbnQoYXJnMSwgYXJnMik7CiAgICBlbHNlCiAgICAgIHJldHVybiBleHRlbmRFdmVudCgiYW5vbnltb3VzIGV2ZW50IiwgYXJnMSkKICB9CgogIHJldHVybiB7CiAgICBleHRlbmQ6IGV4dGVuZCwKICAgIGNyZWF0ZTogY3JlYXRlCiAgfTsKICAKfSk7CgpkZWZpbmUoJ2RlY28vZXZlbnRzJyxbJ2RlY28vcHJvY2xhaW1XaGVuJ10sIGZ1bmN0aW9uKHByb2NsYWltV2hlbil7CiAgcmV0dXJuIHByb2NsYWltV2hlbi5leHRlbmQoewogICAgdGhlUGFnZUhhc0NoYW5nZWQ6IGZ1bmN0aW9uKHBhdGgsIHNlZ21lbnRzLCB1cmwpeyB9CiAgfSk7Cn0pOwpkZWZpbmUoJ2RlY28vc3BhJyxbCiAgImRlY28vc3BhL091dGxldCIsCiAgImRlY28vc3BhL3doZW5Db250ZXh0IiwKICAiZGVjby9zcGEvYXBwbHlWaWV3TW9kZWxzIiwKICAiZGVjby9zcGEvaGFzaE5hdmlnYXRpb24iLAogICJkZWNvL3NwYS9UZW1wbGF0ZXMiLAogICJkZWNvL3V0aWxzIiwKICAiZGVjby9ldmVudHMiCl0sIGZ1bmN0aW9uKAogIE91dGxldCwKICB3aGVuQ29udGV4dCwKICBhcHBseVZpZXdNb2RlbHMsCiAgaGFzaE5hdmlnYXRpb24sCiAgVGVtcGxhdGVzLAogIHV0aWxzLAogIHByb2NsYWltCil7CgogIHZhciBfY29uZmlnID0gewogICAgICBpbmRleDogImluZGV4IgogICAgfSwKICAgIF9kb2N1bWVudCwKICAgIF9vdXRsZXQsCiAgICBfb3JpZ2luYWxUaXRsZSwKICAgIF90ZW1wbGF0ZXMsCiAgICBfd2hlbkNvbnRleHQ7CgogIGZ1bmN0aW9uIGFwcGx5Q29udGVudChjb250ZW50KXsKICAgIF9vdXRsZXQudW5sb2FkQ3VycmVudFBhZ2UoKTsKICAgIF9vdXRsZXQuc2V0UGFnZUNvbnRlbnQoY29udGVudCk7CiAgICBfb3V0bGV0LnNldERvY3VtZW50VGl0bGUoX291dGxldC5nZXRQYWdlVGl0bGUoKSB8fCBfb3JpZ2luYWxUaXRsZSk7CiAgICBfb3V0bGV0LmV4dHJhY3RBbmRSdW5QYWdlSmF2YVNjcmlwdCgpOwogICAgcmV0dXJuIGFwcGx5Vmlld01vZGVscyhfb3V0bGV0LmVsZW1lbnQsIF93aGVuQ29udGV4dCgpKTsKICB9CgogIGZ1bmN0aW9uIHBhZ2VDaGFuZ2VkKHBhdGgsIHNlZ21lbnRzKXsKICAgIF9vdXRsZXQuaW5kaWNhdGVQYWdlSXNMb2FkaW5nKCk7CiAgICBfd2hlbkNvbnRleHQuZGVzdHJveUNoaWxkQ29udGV4dHMoKTsKICAgIHJldHVybiBfdGVtcGxhdGVzLmdldFRlbXBsYXRlKHBhdGgpCiAgICAgIC50aGVuKGFwcGx5Q29udGVudCkKICAgICAgLnRoZW4oZnVuY3Rpb24oKXsKICAgICAgICBfb3V0bGV0LnBhZ2VIYXNMb2FkZWQoKTsKICAgICAgICBwcm9jbGFpbS50aGVQYWdlSGFzQ2hhbmdlZChwYXRoLCBzZWdtZW50cywgZG9jdW1lbnQubG9jYXRpb24pCiAgICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gc3RhcnQoY29uZmlnLCBkb2N1bWVudCl7CiAgICBfZG9jdW1lbnQgPSBkb2N1bWVudCB8fCB3aW5kb3cuZG9jdW1lbnQ7CiAgICBfY29uZmlnID0gdXRpbHMuZXh0ZW5kKF9jb25maWcsIGNvbmZpZyk7CiAgICBfb3V0bGV0ID0gbmV3IE91dGxldChfZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiW2RhdGEtb3V0bGV0XSIpLCBfZG9jdW1lbnQpOwogICAgX29yaWdpbmFsVGl0bGUgPSBfZG9jdW1lbnQudGl0bGU7CiAgICBfd2hlbkNvbnRleHQgPSB3aGVuQ29udGV4dCgpOwoKICAgIHJldHVybiBhcHBseVZpZXdNb2RlbHMoX2RvY3VtZW50LCB3aGVuQ29udGV4dCgpKS50aGVuKGZ1bmN0aW9uKCl7CiAgICAgIGlmKF9vdXRsZXQub3V0bGV0RXhpc3RzKCkpewogICAgICAgIF90ZW1wbGF0ZXMgPSBuZXcgVGVtcGxhdGVzKF9kb2N1bWVudCwgX2NvbmZpZyk7CiAgICAgICAgaGFzaE5hdmlnYXRpb24uc3RhcnQoX2NvbmZpZywgcGFnZUNoYW5nZWQsIF9kb2N1bWVudCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgcmV0dXJuIHsKICAgIHN0YXJ0OiBzdGFydAogIH07Cn0pOwpkZWZpbmUoJ2RlY28vZGVjbycsWwogICdkZWNvL3F2YycsCiAgJ2RlY28vc3BhJwpdLCBmdW5jdGlvbigKICBxdmMsCiAgc3BhCil7CgogIAoKICBmdW5jdGlvbiBjb25maWcoY29uZmlnKXsKCiAgICBjb25maWcgPSBjb25maWcgfHwge307CgogICAgdmFyIHNwYUNvbmZpZyA9IGNvbmZpZy5zcGEgfHwge307CiAgICB2YXIgcXZjQ29uZmlnID0gY29uZmlnLnF2YyB8fCB7fTsKCiAgICBxdmMuY29uZmlnKHF2Y0NvbmZpZyk7CgogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IHNwYS5zdGFydC5iaW5kKG51bGwsIHNwYUNvbmZpZywgZG9jdW1lbnQpCiAgICB9CiAgfQogIAogIHJldHVybiB7CiAgICBjb25maWc6IGNvbmZpZwogIH07Cgp9KTsKZGVmaW5lKCdkZWNvJywgWydkZWNvL2RlY28nXSwgZnVuY3Rpb24gKG1haW4pIHsgcmV0dXJuIG1haW47IH0pOwoKZGVmaW5lKCdkZWNvL3F2Yy9jb25zdHJhaW50cy9Ob3RFbXB0eScsW10sIGZ1bmN0aW9uKCl7CiAgZnVuY3Rpb24gTm90RW1wdHkoYXR0cmlidXRlcyl7CiAgICAKICB9CiAgCiAgTm90RW1wdHkucHJvdG90eXBlLmlzVmFsaWQgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICBpZih2YWx1ZSA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICBpZih0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIgJiYgdmFsdWUubGVuZ3RoID09IDApIHJldHVybiBmYWxzZTsKICAgIHJldHVybiB0cnVlOwogIH07CiAgCiAgcmV0dXJuIE5vdEVtcHR5Owp9KTsKZGVmaW5lKCdkZWNvL3F2Yy9jb25zdHJhaW50cy9QYXR0ZXJuJyxbXSwgZnVuY3Rpb24oKXsKICBmdW5jdGlvbiBQYXR0ZXJuKGF0dHJpYnV0ZXMpeyAgICAKCiAgICBhdHRyaWJ1dGVzLmZsYWdzID0gYXR0cmlidXRlcy5mbGFncyB8fCBbXTsKICAgIAogICAgdmFyIGZsYWdzID0gJyc7CiAgICBpZihhdHRyaWJ1dGVzLmZsYWdzLmluZGV4T2YoIkNBU0VfSU5TRU5TSVRJVkUiKSA+PSAwKSBmbGFncyArPSAnaSc7CiAgICAKICAgIHRoaXMucmVnZXggPSBuZXcgUmVnRXhwKGF0dHJpYnV0ZXMucmVnZXhwLCBmbGFncyk7CiAgfQogIAogIAogIFBhdHRlcm4ucHJvdG90eXBlLmlzVmFsaWQgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICAKICAgIGlmKHZhbHVlID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgIAogICAgdmFyIHJlc3VsdCA9IHRoaXMucmVnZXguZXhlYyh2YWx1ZSk7CiAgICAKICAgIGlmKHJlc3VsdCA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICAKICAgIHJldHVybiByZXN1bHRbMF0gPT0gdmFsdWU7CiAgfTsKICAKICAKICByZXR1cm4gUGF0dGVybjsKfSk7CgovLyMgc291cmNlTWFwcGluZ1VSTD1kZWNvLmpzLm1hcA==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 20:15:46 GMT",
                    "Content-Length": "35299",
                    "Date": "Thu, 06 Nov 2014 20:15:46 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}