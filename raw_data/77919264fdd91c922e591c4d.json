{
    "url": "http://localhost:9999/niklasvh/feedback.js/examples/js/html2canvas.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>window.location.href</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>link.href = window.location.href;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/niklasvh/feedback.js/examples/js/html2canvas.js",
                "path": "/niklasvh/feedback.js/examples/js/html2canvas.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9uaWtsYXN2aC9mZWVkYmFjay5qcy9leGFtcGxlcy9qcy9odG1sMmNhbnZhcy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTA3MzIwDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDAwOjEwOjE4IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwMDoxMDoxOCBHTVQNCg0KLyoqCiAgQGxpY2Vuc2UgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogIGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmgKCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UKICovCihmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQpewoKLyoKICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPgogIENvcHlyaWdodCAoYykgMjAxMSBOaWtsYXMgdm9uIEhlcnR6ZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aAoKICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQogKi8KInVzZSBzdHJpY3QiOwoKdmFyIF9odG1sMmNhbnZhcyA9IHt9LApwcmV2aW91c0VsZW1lbnQsCmNvbXB1dGVkQ1NTLApodG1sMmNhbnZhczsKCgpmdW5jdGlvbiBoMmNsb2coYSkgewogICAgaWYgKF9odG1sMmNhbnZhcy5sb2dnaW5nICYmIHdpbmRvdy5jb25zb2xlICYmIHdpbmRvdy5jb25zb2xlLmxvZykgewogICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhhKTsKICAgIH0KfQoKX2h0bWwyY2FudmFzLlV0aWwgPSB7fTsKCl9odG1sMmNhbnZhcy5VdGlsLmJhY2tncm91bmRJbWFnZSA9IGZ1bmN0aW9uIChzcmMpIHsKCiAgICBpZiAoL2RhdGE6aW1hZ2VcLy4qO2Jhc2U2NCwvaS50ZXN0KCBzcmMgKSB8fCAvXigtd2Via2l0fC1tb3p8bGluZWFyLWdyYWRpZW50fC1vLSkvLnRlc3QoIHNyYyApKSB7CiAgICAgICAgcmV0dXJuIHNyYzsKICAgIH0KCiAgICBpZiAoc3JjLnRvTG93ZXJDYXNlKCkuc3Vic3RyKCAwLCA1ICkgPT09ICd1cmwoIicpIHsKICAgICAgICBzcmMgPSBzcmMuc3Vic3RyKCA1ICk7CiAgICAgICAgc3JjID0gc3JjLnN1YnN0ciggMCwgc3JjLmxlbmd0aCAtIDIgKTsKICAgIH0gZWxzZSB7CiAgICAgICAgc3JjID0gc3JjLnN1YnN0ciggNCApOwogICAgICAgIHNyYyA9IHNyYy5zdWJzdHIoIDAsIHNyYy5sZW5ndGggLSAxICk7CiAgICB9CgogICAgcmV0dXJuIHNyYzsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyA9IGZ1bmN0aW9uIGdldEJvdW5kcyAoZWwpIHsKICAgIHZhciBjbGllbnRSZWN0LAogICAgYm91bmRzID0ge307CgogICAgaWYgKGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCl7CiAgICAgICAgY2xpZW50UmVjdCA9IGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKCiAgICAgICAgLy8gVE9ETyBhZGQgc2Nyb2xsIHBvc2l0aW9uIHRvIGJvdW5kcywgc28gbm8gc2Nyb2xsaW5nIG9mIHdpbmRvdyBuZWNlc3NhcnkKICAgICAgICBib3VuZHMudG9wID0gY2xpZW50UmVjdC50b3A7CiAgICAgICAgYm91bmRzLmJvdHRvbSA9IGNsaWVudFJlY3QuYm90dG9tIHx8IChjbGllbnRSZWN0LnRvcCArIGNsaWVudFJlY3QuaGVpZ2h0KTsKICAgICAgICBib3VuZHMubGVmdCA9IGNsaWVudFJlY3QubGVmdDsKCiAgICAgICAgLy8gb2xkZXIgSUUgZG9lc24ndCBoYXZlIHdpZHRoL2hlaWdodCwgYnV0IHRvcC9ib3R0b20gaW5zdGVhZAogICAgICAgIGJvdW5kcy53aWR0aCA9IGNsaWVudFJlY3Qud2lkdGggfHwgKGNsaWVudFJlY3QucmlnaHQgLSBjbGllbnRSZWN0LmxlZnQpOwogICAgICAgIGJvdW5kcy5oZWlnaHQgPSBjbGllbnRSZWN0LmhlaWdodCB8fCAoY2xpZW50UmVjdC5ib3R0b20gLSBjbGllbnRSZWN0LnRvcCk7CgogICAgICAgIHJldHVybiBib3VuZHM7CgogICAgfQp9OwoKX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTID0gZnVuY3Rpb24gKGVsLCBhdHRyaWJ1dGUpIHsKICAgIC8vIHJldHVybiAkKGVsKS5jc3MoYXR0cmlidXRlKTsKCiAgICB2YXIgdmFsOwoKICAgIGZ1bmN0aW9uIHRvUFgoIGF0dHJpYnV0ZSwgdmFsICkgewogICAgICAgIHZhciByc0xlZnQgPSBlbC5ydW50aW1lU3R5bGUgJiYgZWwucnVudGltZVN0eWxlWyBhdHRyaWJ1dGUgXSwKICAgICAgICBsZWZ0LAogICAgICAgIHN0eWxlID0gZWwuc3R5bGU7CgogICAgICAgIC8vIENoZWNrIGlmIHdlIGFyZSBub3QgZGVhbGluZyB3aXRoIHBpeGVscywgKE9wZXJhIGhhcyBpc3N1ZXMgd2l0aCB0aGlzKQogICAgICAgIC8vIFBvcnRlZCBmcm9tIGpRdWVyeSBjc3MuanMKICAgICAgICAvLyBGcm9tIHRoZSBhd2Vzb21lIGhhY2sgYnkgRGVhbiBFZHdhcmRzCiAgICAgICAgLy8gaHR0cDovL2VyaWsuZWFlLm5ldC9hcmNoaXZlcy8yMDA3LzA3LzI3LzE4LjU0LjE1LyNjb21tZW50LTEwMjI5MQoKICAgICAgICAvLyBJZiB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgcmVndWxhciBwaXhlbCBudW1iZXIKICAgICAgICAvLyBidXQgYSBudW1iZXIgdGhhdCBoYXMgYSB3ZWlyZCBlbmRpbmcsIHdlIG5lZWQgdG8gY29udmVydCBpdCB0byBwaXhlbHMKCiAgICAgICAgaWYgKCAhL14tP1swLTldK1wuP1swLTldKig/OnB4KT8kL2kudGVzdCggdmFsICkgJiYgL14tP1xkLy50ZXN0KCB2YWwgKSApIHsKCiAgICAgICAgICAgIC8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKICAgICAgICAgICAgbGVmdCA9IHN0eWxlLmxlZnQ7CgogICAgICAgICAgICAvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CiAgICAgICAgICAgIGlmICggcnNMZWZ0ICkgewogICAgICAgICAgICAgICAgZWwucnVudGltZVN0eWxlLmxlZnQgPSBlbC5jdXJyZW50U3R5bGUubGVmdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdHlsZS5sZWZ0ID0gYXR0cmlidXRlID09PSAiZm9udFNpemUiID8gIjFlbSIgOiAodmFsIHx8IDApOwogICAgICAgICAgICB2YWwgPSBzdHlsZS5waXhlbExlZnQgKyAicHgiOwoKICAgICAgICAgICAgLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwogICAgICAgICAgICBzdHlsZS5sZWZ0ID0gbGVmdDsKICAgICAgICAgICAgaWYgKCByc0xlZnQgKSB7CiAgICAgICAgICAgICAgICBlbC5ydW50aW1lU3R5bGUubGVmdCA9IHJzTGVmdDsKICAgICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIGlmICghL14odGhpbnxtZWRpdW18dGhpY2spJC9pLnRlc3QoIHZhbCApKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHBhcnNlRmxvYXQoIHZhbCApKSArICJweCI7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsOwoKICAgIH0KCgogICAgaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsKICAgICAgICBpZiAoIHByZXZpb3VzRWxlbWVudCAhPT0gZWwgKSB7CiAgICAgICAgICAgIGNvbXB1dGVkQ1NTID0gZG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgbnVsbCk7CiAgICAgICAgfQogICAgICAgIHZhbCA9IGNvbXB1dGVkQ1NTWyBhdHRyaWJ1dGUgXTsKCiAgICAgICAgaWYgKCBhdHRyaWJ1dGUgPT09ICJiYWNrZ3JvdW5kUG9zaXRpb24iICkgewoKICAgICAgICAgICAgdmFsID0gKHZhbC5zcGxpdCgiLCIpWzBdIHx8ICIwIDAiKS5zcGxpdCgiICIpOwoKICAgICAgICAgICAgdmFsWyAwIF0gPSAoIHZhbFswXS5pbmRleE9mKCAiJSIgKSA9PT0gLTEgKSA/IHRvUFgoICBhdHRyaWJ1dGUgKyAiWCIsIHZhbFsgMCBdICkgOiB2YWxbIDAgXTsKICAgICAgICAgICAgdmFsWyAxIF0gPSAoIHZhbFsxXSA9PT0gdW5kZWZpbmVkICkgPyB2YWxbMF0gOiB2YWxbMV07IC8vIElFIDkgZG9lc24ndCByZXR1cm4gZG91YmxlIGRpZ2l0IGFsd2F5cwogICAgICAgICAgICB2YWxbIDEgXSA9ICggdmFsWzFdLmluZGV4T2YoICIlIiApID09PSAtMSApID8gdG9QWCggIGF0dHJpYnV0ZSArICJZIiwgdmFsWyAxIF0gKSA6IHZhbFsgMSBdOwogICAgICAgIH0gZWxzZSBpZiAoIC9ib3JkZXIoVG9wfEJvdHRvbSkoTGVmdHxSaWdodClSYWRpdXMvLnRlc3QoIGF0dHJpYnV0ZSkgKSB7CiAgICAgICAgICAgIHZhciBhcnIgPSB2YWwuc3BsaXQoIiAiKTsKICAgICAgICAgICAgaWYgKCBhcnIubGVuZ3RoIDw9IDEgKSB7CiAgICAgICAgICAgICAgICBhcnJbIDEgXSA9IGFyclsgMCBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFyclsgMCBdID0gcGFyc2VJbnQoIGFyclsgMCBdLCAxMCApOwogICAgICAgICAgICBhcnJbIDEgXSA9IHBhcnNlSW50KCBhcnJbIDEgXSwgMTAgKTsKICAgICAgICAgICAgdmFsID0gYXJyOwogICAgICAgIH0KCiAgICB9IGVsc2UgaWYgKCBlbC5jdXJyZW50U3R5bGUgKSB7CiAgICAgICAgLy8gSUUgOT4KICAgICAgICBpZiAoYXR0cmlidXRlID09PSAiYmFja2dyb3VuZFBvc2l0aW9uIikgewogICAgICAgICAgICAvLyBPbGRlciBJRSB1c2VzIC14IGFuZCAteQogICAgICAgICAgICB2YWwgPSBbIHRvUFgoICBhdHRyaWJ1dGUgKyAiWCIsIGVsLmN1cnJlbnRTdHlsZVsgYXR0cmlidXRlICsgIlgiIF0gICksIHRvUFgoICBhdHRyaWJ1dGUgKyAiWSIsIGVsLmN1cnJlbnRTdHlsZVsgYXR0cmlidXRlICsgIlkiIF0gICkgXTsKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgdmFsID0gdG9QWCggIGF0dHJpYnV0ZSwgZWwuY3VycmVudFN0eWxlWyBhdHRyaWJ1dGUgXSAgKTsKCiAgICAgICAgICAgIGlmICgvXihib3JkZXIpL2kudGVzdCggYXR0cmlidXRlICkgJiYgL14obWVkaXVtfHRoaW58dGhpY2spJC9pLnRlc3QoIHZhbCApKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHZhbCkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgInRoaW4iOgogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAiMXB4IjsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAibWVkaXVtIjoKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gIjBweCI7IC8vIHRoaXMgaXMgd3JvbmcsIGl0IHNob3VsZCBiZSAzcHggYnV0IElFIHVzZXMgbWVkaXVtIGZvciBubyBib3JkZXIgYXMgd2VsbC4uIFRPRE8gZmluZCBhIHdvcmsgYXJvdW5kCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgInRoaWNrIjoKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gIjVweCI7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKCgogICAgfQoKCgoKICAgIHJldHVybiB2YWw7CgoKCi8vcmV0dXJuICQoZWwpLmNzcyhhdHRyaWJ1dGUpOwoKCn07CgoKX2h0bWwyY2FudmFzLlV0aWwuQmFja2dyb3VuZFBvc2l0aW9uID0gZnVuY3Rpb24gKCBlbCwgYm91bmRzLCBpbWFnZSApIHsKICAgIC8vIFRPRE8gYWRkIHN1cHBvcnQgZm9yIG11bHRpIGltYWdlIGJhY2tncm91bmRzCgogICAgdmFyIGJncG9zaXRpb24gPSAgX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTKCBlbCwgImJhY2tncm91bmRQb3NpdGlvbiIgKSAsCiAgICB0b3BQb3MsCiAgICBsZWZ0LAogICAgcGVyY2VudGFnZSwKICAgIHZhbDsKCiAgICBpZiAoYmdwb3NpdGlvbi5sZW5ndGggPT09IDEpewogICAgICAgIHZhbCA9IGJncG9zaXRpb247CgogICAgICAgIGJncG9zaXRpb24gPSBbXTsKCiAgICAgICAgYmdwb3NpdGlvblswXSA9IHZhbDsKICAgICAgICBiZ3Bvc2l0aW9uWzFdID0gdmFsOwogICAgfQoKCgogICAgaWYgKGJncG9zaXRpb25bMF0udG9TdHJpbmcoKS5pbmRleE9mKCIlIikgIT09IC0xKXsKICAgICAgICBwZXJjZW50YWdlID0gKHBhcnNlRmxvYXQoYmdwb3NpdGlvblswXSkvMTAwKTsKICAgICAgICBsZWZ0ID0gICgoYm91bmRzLndpZHRoICogcGVyY2VudGFnZSktKGltYWdlLndpZHRoKnBlcmNlbnRhZ2UpKTsKCiAgICB9ZWxzZXsKICAgICAgICBsZWZ0ID0gcGFyc2VJbnQoYmdwb3NpdGlvblswXSwxMCk7CiAgICB9CgogICAgaWYgKGJncG9zaXRpb25bMV0udG9TdHJpbmcoKS5pbmRleE9mKCIlIikgIT09IC0xKXsKCiAgICAgICAgcGVyY2VudGFnZSA9IChwYXJzZUZsb2F0KGJncG9zaXRpb25bMV0pLzEwMCk7CiAgICAgICAgdG9wUG9zID0gICgoYm91bmRzLmhlaWdodCAqIHBlcmNlbnRhZ2UpLShpbWFnZS5oZWlnaHQqcGVyY2VudGFnZSkpOwogICAgfWVsc2V7CiAgICAgICAgdG9wUG9zID0gcGFyc2VJbnQoYmdwb3NpdGlvblsxXSwxMCk7CiAgICB9CgoKCgogICAgcmV0dXJuIHsKICAgICAgICB0b3A6IHRvcFBvcywKICAgICAgICBsZWZ0OiBsZWZ0CiAgICB9OwoKfTsKCl9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZCA9IGZ1bmN0aW9uIChvcHRpb25zLCBkZWZhdWx0cykgewogICAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgIGRlZmF1bHRzW2tleV0gPSBvcHRpb25zW2tleV07CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGRlZmF1bHRzOwp9OwoKCi8qCiAqIERlcml2ZWQgZnJvbSBqUXVlcnkuY29udGVudHMoKQogKiBDb3B5cmlnaHQgMjAxMCwgSm9obiBSZXNpZwogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KX2h0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4gPSBmdW5jdGlvbiggZWxlbSApIHsKCgogICAgdmFyIGNoaWxkcmVuOwogICAgdHJ5IHsKCiAgICAgICAgY2hpbGRyZW4gPSAoZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICJJRlJBTUUiKSA/CiAgICAgICAgZWxlbS5jb250ZW50RG9jdW1lbnQgfHwgZWxlbS5jb250ZW50V2luZG93LmRvY3VtZW50IDogKGZ1bmN0aW9uKCBhcnJheSApewogICAgICAgICAgICB2YXIgcmV0ID0gW107CgogICAgICAgICAgICBpZiAoIGFycmF5ICE9PSBudWxsICkgewoKICAgICAgICAgICAgICAgIChmdW5jdGlvbiggZmlyc3QsIHNlY29uZCApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IGZpcnN0Lmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICBqID0gMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCB0eXBlb2Ygc2Vjb25kLmxlbmd0aCA9PT0gIm51bWJlciIgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIHZhciBsID0gc2Vjb25kLmxlbmd0aDsgaiA8IGw7IGorKyApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0WyBpKysgXSA9IHNlY29uZFsgaiBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICggc2Vjb25kW2pdICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGorKyBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmaXJzdC5sZW5ndGggPSBpOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmlyc3Q7CiAgICAgICAgICAgICAgICB9KSggcmV0LCBhcnJheSApOwoKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9KSggZWxlbS5jaGlsZE5vZGVzICk7CgogICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4gZmFpbGVkIHdpdGggZXhjZXB0aW9uOiAiICsgZXgubWVzc2FnZSk7CiAgICAgICAgY2hpbGRyZW4gPSBbXTsKICAgIH0KICAgIHJldHVybiBjaGlsZHJlbjsKfTsKCi8qCiAgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogIGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmgKCiAgQ29udHJpYnV0b3Iocyk6CiAgICAgIE5pa2xhcyB2b24gSGVydHplbiA8aHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aD4KICAgICAgQW5kcsOpIEZpZWRsZXIgICAgICA8aHR0cDovL3d3dy50d2l0dGVyLmNvbS9zb25uZW5raXN0ZT4KCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UKICovCgooZnVuY3Rpb24oKXsKCl9odG1sMmNhbnZhcy5HZW5lcmF0ZSA9IHt9OwoKdmFyIHJlR3JhZGllbnRzID0gWwogICAgL14oLXdlYmtpdC1saW5lYXItZ3JhZGllbnQpXCgoW2EtelxzXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgICAvXigtby1saW5lYXItZ3JhZGllbnQpXCgoW2EtelxzXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgICAvXigtd2Via2l0LWdyYWRpZW50KVwoKGxpbmVhcnxyYWRpYWwpLFxzKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPyksXHMoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKShbXHdcZFwuXHMsJVwoXCktXSspXCkkLywKICAgIC9eKC1tb3otbGluZWFyLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgICAvXigtd2Via2l0LXJhZGlhbC1ncmFkaWVudClcKCgoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKSxccyhcdyspXHMoW2Etei1dKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAgIC9eKC1tb3otcmFkaWFsLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpLFxzKFx3Kylccz8oW2Etei1dKikoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAgIC9eKC1vLXJhZGlhbC1ncmFkaWVudClcKCgoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKSxccyhcdyspXHMoW2Etei1dKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLwpdOwoKLyoKICogVE9ETzogQWRkIElFMTAgdmVuZG9yIHByZWZpeCAoLW1zKSBzdXBwb3J0CiAqIFRPRE86IEFkZCBXM0MgZ3JhZGllbnQgKGxpbmVhci1ncmFkaWVudCkgc3VwcG9ydAogKiBUT0RPOiBBZGQgb2xkIFdlYmtpdCAtd2Via2l0LWdyYWRpZW50KHJhZGlhbCwgLi4uKSBzdXBwb3J0CiAqIFRPRE86IE1heWJlIHNvbWUgUmVnRXhwIG9wdGltaXphdGlvbnMgYXJlIHBvc3NpYmxlIDtvKQogKi8KX2h0bWwyY2FudmFzLkdlbmVyYXRlLnBhcnNlR3JhZGllbnQgPSBmdW5jdGlvbihjc3MsIGJvdW5kcykgewogICAgdmFyIGdyYWRpZW50LCBpLCBsZW4gPSByZUdyYWRpZW50cy5sZW5ndGgsIG0xLCBzdG9wLCBtMiwgbTJMZW4sIHN0ZXAsIG0zOwoKICAgIGZvcihpID0gMDsgaSA8IGxlbjsgaSs9MSl7CiAgICAgICAgbTEgPSBjc3MubWF0Y2gocmVHcmFkaWVudHNbaV0pOwogICAgICAgIGlmKG0xKSBicmVhazsKICAgIH0KCiAgICBpZihtMSkgewogICAgICAgIHN3aXRjaChtMVsxXSkgewogICAgICAgICAgICBjYXNlICctd2Via2l0LWxpbmVhci1ncmFkaWVudCc6CiAgICAgICAgICAgIGNhc2UgJy1vLWxpbmVhci1ncmFkaWVudCc6CgogICAgICAgICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2xpbmVhcicsCiAgICAgICAgICAgICAgICAgICAgeDA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgeTA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgeDE6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgeTE6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzCiAgICAgICAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC9cdysvZyk7CiAgICAgICAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2gobTJbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RvcCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxID0gYm91bmRzLmhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdyaWdodCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDAgPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2JvdHRvbSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSBib3VuZHMuaGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdsZWZ0JzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihncmFkaWVudC54MCA9PT0gbnVsbCAmJiBncmFkaWVudC54MSA9PT0gbnVsbCl7IC8vIGNlbnRlcgogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngwID0gZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGggLyAyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoZ3JhZGllbnQueTAgPT09IG51bGwgJiYgZ3JhZGllbnQueTEgPT09IG51bGwpeyAvLyBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MCA9IGdyYWRpZW50LnkxID0gYm91bmRzLmhlaWdodCAvIDI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMKICAgICAgICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSg/OiV8cHgpKT8pKy9nKTsKICAgICAgICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7CiAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglfHB4KT8vKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbMl0pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbM10gPT09ICclJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBweCAtIHN0dXBpZCBvcGVyYQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgLz0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCA9IGkgKiBzdGVwOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnLXdlYmtpdC1ncmFkaWVudCc6CgogICAgICAgICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogbTFbMl0gPT09ICdyYWRpYWwnID8gJ2NpcmNsZScgOiBtMVsyXSwgLy8gVE9ETzogQWRkIHJhZGlhbCBncmFkaWVudCBzdXBwb3J0IGZvciBvbGRlciBtb3ppbGxhIGRlZmluaXRpb25zCiAgICAgICAgICAgICAgICAgICAgeDA6IDAsCiAgICAgICAgICAgICAgICAgICAgeTA6IDAsCiAgICAgICAgICAgICAgICAgICAgeDE6IDAsCiAgICAgICAgICAgICAgICAgICAgeTE6IDAsCiAgICAgICAgICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzCiAgICAgICAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8sXHMoXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsKICAgICAgICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MCA9IChtMlsxXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAobTJbMl0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSA9IChtMlszXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgPSAobTJbNF0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBnZXQgY29sb3JzIGFuZCBzdG9wcwogICAgICAgICAgICAgICAgbTIgPSBtMVs0XS5tYXRjaCgvKCg/OmZyb218dG98Y29sb3Itc3RvcClcKCg/OlswLTlcLl0rLFxzKT8oPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKVwpKSsvZyk7CiAgICAgICAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oZnJvbXx0b3xjb2xvci1zdG9wKVwoKFswLTlcLl0rKT8oPzosXHMpPygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlcKS8pOwogICAgICAgICAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG0zWzFdID09PSAnZnJvbScpIHN0b3AgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG0zWzFdID09PSAndG8nKSBzdG9wID0gMS4wOwogICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IG0zWzNdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcDogc3RvcAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJy1tb3otbGluZWFyLWdyYWRpZW50JzoKCiAgICAgICAgICAgICAgICBncmFkaWVudCA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAnbGluZWFyJywKICAgICAgICAgICAgICAgICAgICB4MDogMCwKICAgICAgICAgICAgICAgICAgICB5MDogMCwKICAgICAgICAgICAgICAgICAgICB4MTogMCwKICAgICAgICAgICAgICAgICAgICB5MTogMCwKICAgICAgICAgICAgICAgICAgICBjb2xvclN0b3BzOiBbXQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBnZXQgY29vcmRpbmF0ZXMKICAgICAgICAgICAgICAgIG0yID0gbTFbMl0ubWF0Y2goLyhcZHsxLDN9KSU/XHMoXGR7MSwzfSklPy8pOwoKICAgICAgICAgICAgICAgIC8vIG0yWzFdID09IDAlICAgLT4gbGVmdAogICAgICAgICAgICAgICAgLy8gbTJbMV0gPT0gNTAlICAtPiBjZW50ZXIKICAgICAgICAgICAgICAgIC8vIG0yWzFdID09IDEwMCUgLT4gcmlnaHQKCiAgICAgICAgICAgICAgICAvLyBtMlsyXSA9PSAwJSAgIC0+IHRvcAogICAgICAgICAgICAgICAgLy8gbTJbMl0gPT0gNTAlICAtPiBjZW50ZXIKICAgICAgICAgICAgICAgIC8vIG0yWzJdID09IDEwMCUgLT4gYm90dG9tCgogICAgICAgICAgICAgICAgaWYobTIpewogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngwID0gKG0yWzFdICogYm91bmRzLndpZHRoKSAvIDEwMDsKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MCA9IChtMlsyXSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOwogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxID0gYm91bmRzLndpZHRoIC0gZ3JhZGllbnQueDA7CiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgPSBib3VuZHMuaGVpZ2h0IC0gZ3JhZGllbnQueTA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMKICAgICAgICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSUpPykrL2cpOwogICAgICAgICAgICAgICAgaWYobTIpewogICAgICAgICAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIHN0ZXAgPSAxIC8gTWF0aC5tYXgobTJMZW4gLSAxLCAxKTsKICAgICAgICAgICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7CiAgICAgICAgICAgICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlccyooXGR7MSwzfSk/KCUpPy8pOwogICAgICAgICAgICAgICAgICAgICAgICBpZihtM1syXSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihtM1szXSl7IC8vIHBlcmNlbnRhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wIC89IDEwMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgPSBpICogc3RlcDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IG0zWzFdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcDogc3RvcAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJy13ZWJraXQtcmFkaWFsLWdyYWRpZW50JzoKICAgICAgICAgICAgY2FzZSAnLW1vei1yYWRpYWwtZ3JhZGllbnQnOgogICAgICAgICAgICBjYXNlICctby1yYWRpYWwtZ3JhZGllbnQnOgoKICAgICAgICAgICAgICAgIGdyYWRpZW50ID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICdjaXJjbGUnLAogICAgICAgICAgICAgICAgICAgIHgwOiAwLAogICAgICAgICAgICAgICAgICAgIHkwOiAwLAogICAgICAgICAgICAgICAgICAgIHgxOiBib3VuZHMud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgeTE6IGJvdW5kcy5oZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgY3g6IDAsCiAgICAgICAgICAgICAgICAgICAgY3k6IDAsCiAgICAgICAgICAgICAgICAgICAgcng6IDAsCiAgICAgICAgICAgICAgICAgICAgcnk6IDAsCiAgICAgICAgICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gY2VudGVyCiAgICAgICAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsKICAgICAgICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCA9IChtMlsxXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3kgPSAobTJbMl0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBzaXplCiAgICAgICAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC9cdysvKTsKICAgICAgICAgICAgICAgIG0zID0gbTFbNF0ubWF0Y2goL1thLXotXSovKTsKICAgICAgICAgICAgICAgIGlmKG0yICYmIG0zKXsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2gobTNbMF0pewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdmYXJ0aGVzdC1jb3JuZXInOgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjb3Zlcic6IC8vIGlzIGVxdWl2YWxlbnQgdG8gZmFydGhlc3QtY29ybmVyCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJyc6IC8vIG1vemlsbGEgcmVtb3ZlcyAiY292ZXIiIGZyb20gZGVmaW5pdGlvbiA6KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJyID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1heCh0bCwgdHIsIGJyLCBibCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY2xvc2VzdC1jb3JuZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJyID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1pbih0bCwgdHIsIGJyLCBibCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZmFydGhlc3Qtc2lkZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihtMlswXSA9PT0gJ2NpcmNsZScpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1heCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIGVsbGlwc2UKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQudHlwZSA9IG0yWzBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IE1hdGgubWF4KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnkgPSBNYXRoLm1heCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Nsb3Nlc3Qtc2lkZSc6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2NvbnRhaW4nOiAvLyBpcyBlcXVpdmFsZW50IHRvIGNsb3Nlc3Qtc2lkZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobTJbMF0gPT09ICdjaXJjbGUnKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5taW4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBlbGxpcHNlCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnR5cGUgPSBtMlswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBNYXRoLm1pbigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ5ID0gTWF0aC5taW4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogYWRkIHN1cHBvcnQgZm9yICIzMHB4IDQwcHgiIHNpemVzICh3ZWJraXQgb25seSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gY29sb3Igc3RvcHMKICAgICAgICAgICAgICAgIG0yID0gbTFbNV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSg/OiV8cHgpKT8pKy9nKTsKICAgICAgICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7CiAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglfHB4KT8vKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbMl0pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbM10gPT09ICclJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBweCAtIHN0dXBpZCBvcGVyYQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgLz0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCA9IGkgKiBzdGVwOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZ3JhZGllbnQ7Cn07CgpfaHRtbDJjYW52YXMuR2VuZXJhdGUuR3JhZGllbnQgPSBmdW5jdGlvbihzcmMsIGJvdW5kcykgewogICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAogICAgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyksCiAgICBncmFkaWVudCwgZ3JhZCwgaSwgbGVuLCBpbWc7CgogICAgY2FudmFzLndpZHRoID0gYm91bmRzLndpZHRoOwogICAgY2FudmFzLmhlaWdodCA9IGJvdW5kcy5oZWlnaHQ7CgogICAgLy8gVE9ETzogYWRkIHN1cHBvcnQgZm9yIG11bHRpIGRlZmluZWQgYmFja2dyb3VuZCBncmFkaWVudHMgKGxpa2UgcmFkaWFsIGdyYWRpZW50IGV4YW1wbGUgaW4gYmFja2dyb3VuZC5odG1sKQogICAgZ3JhZGllbnQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUucGFyc2VHcmFkaWVudChzcmMsIGJvdW5kcyk7CgogICAgaW1nID0gbmV3IEltYWdlKCk7CgogICAgaWYoZ3JhZGllbnQpewogICAgICAgIGlmKGdyYWRpZW50LnR5cGUgPT09ICdsaW5lYXInKXsKICAgICAgICAgICAgZ3JhZCA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudChncmFkaWVudC54MCwgZ3JhZGllbnQueTAsIGdyYWRpZW50LngxLCBncmFkaWVudC55MSk7CgogICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBncmFkaWVudC5jb2xvclN0b3BzLmxlbmd0aDsgaSA8IGxlbjsgaSs9MSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBncmFkLmFkZENvbG9yU3RvcChncmFkaWVudC5jb2xvclN0b3BzW2ldLnN0b3AsIGdyYWRpZW50LmNvbG9yU3RvcHNbaV0uY29sb3IpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgIGgyY2xvZyhbJ2ZhaWxlZCB0byBhZGQgY29sb3Igc3RvcDogJywgZSwgJzsgdHJpZWQgdG8gYWRkOiAnLCBncmFkaWVudC5jb2xvclN0b3BzW2ldLCAnOyBzdG9wOiAnLCBpLCAnOyBpbjogJywgc3JjXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBncmFkOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0KTsKCiAgICAgICAgICAgIGltZy5zcmMgPSBjYW52YXMudG9EYXRhVVJMKCk7CiAgICAgICAgfSBlbHNlIGlmKGdyYWRpZW50LnR5cGUgPT09ICdjaXJjbGUnKXsKCiAgICAgICAgICAgIGdyYWQgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoZ3JhZGllbnQuY3gsIGdyYWRpZW50LmN5LCAwLCBncmFkaWVudC5jeCwgZ3JhZGllbnQuY3ksIGdyYWRpZW50LnJ4KTsKCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGdyYWRpZW50LmNvbG9yU3RvcHMubGVuZ3RoOyBpIDwgbGVuOyBpKz0xKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGdyYWQuYWRkQ29sb3JTdG9wKGdyYWRpZW50LmNvbG9yU3RvcHNbaV0uc3RvcCwgZ3JhZGllbnQuY29sb3JTdG9wc1tpXS5jb2xvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgaDJjbG9nKFsnZmFpbGVkIHRvIGFkZCBjb2xvciBzdG9wOiAnLCBlLCAnOyB0cmllZCB0byBhZGQ6ICcsIGdyYWRpZW50LmNvbG9yU3RvcHNbaV0sICc7IHN0b3A6ICcsIGksICc7IGluOiAnLCBzcmNdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWQ7CiAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQpOwoKICAgICAgICAgICAgaW1nLnNyYyA9IGNhbnZhcy50b0RhdGFVUkwoKTsKICAgICAgICB9IGVsc2UgaWYoZ3JhZGllbnQudHlwZSA9PT0gJ2VsbGlwc2UnKXsKCiAgICAgICAgICAgIC8vIGRyYXcgY2lyY2xlCiAgICAgICAgICAgIHZhciBjYW52YXNSYWRpYWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSwKICAgICAgICAgICAgICAgIGN0eFJhZGlhbCA9IGNhbnZhc1JhZGlhbC5nZXRDb250ZXh0KCcyZCcpLAogICAgICAgICAgICAgICAgcmkgPSBNYXRoLm1heChncmFkaWVudC5yeCwgZ3JhZGllbnQucnkpLAogICAgICAgICAgICAgICAgZGkgPSByaSAqIDIsIGltZ1JhZGlhbDsKCiAgICAgICAgICAgIGNhbnZhc1JhZGlhbC53aWR0aCA9IGNhbnZhc1JhZGlhbC5oZWlnaHQgPSBkaTsKCiAgICAgICAgICAgIGdyYWQgPSBjdHhSYWRpYWwuY3JlYXRlUmFkaWFsR3JhZGllbnQoZ3JhZGllbnQucngsIGdyYWRpZW50LnJ5LCAwLCBncmFkaWVudC5yeCwgZ3JhZGllbnQucnksIHJpKTsKCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGdyYWRpZW50LmNvbG9yU3RvcHMubGVuZ3RoOyBpIDwgbGVuOyBpKz0xKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGdyYWQuYWRkQ29sb3JTdG9wKGdyYWRpZW50LmNvbG9yU3RvcHNbaV0uc3RvcCwgZ3JhZGllbnQuY29sb3JTdG9wc1tpXS5jb2xvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgaDJjbG9nKFsnZmFpbGVkIHRvIGFkZCBjb2xvciBzdG9wOiAnLCBlLCAnOyB0cmllZCB0byBhZGQ6ICcsIGdyYWRpZW50LmNvbG9yU3RvcHNbaV0sICc7IHN0b3A6ICcsIGksICc7IGluOiAnLCBzcmNdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY3R4UmFkaWFsLmZpbGxTdHlsZSA9IGdyYWQ7CiAgICAgICAgICAgIGN0eFJhZGlhbC5maWxsUmVjdCgwLCAwLCBkaSwgZGkpOwoKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWRpZW50LmNvbG9yU3RvcHNbaSAtIDFdLmNvbG9yOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsKCiAgICAgICAgICAgIGltZ1JhZGlhbCA9IG5ldyBJbWFnZSgpOwogICAgICAgICAgICBpbWdSYWRpYWwub25sb2FkID0gZnVuY3Rpb24oKSB7IC8vIHdhaXQgdW50aWwgdGhlIGltYWdlIGlzIGZpbGxlZAoKICAgICAgICAgICAgICAgIC8vIHRyYW5zZm9ybSBjaXJjbGUgdG8gZWxsaXBzZQogICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWdSYWRpYWwsIGdyYWRpZW50LmN4IC0gZ3JhZGllbnQucngsIGdyYWRpZW50LmN5IC0gZ3JhZGllbnQucnksIDIgKiBncmFkaWVudC5yeCwgMiAqIGdyYWRpZW50LnJ5KTsKCiAgICAgICAgICAgICAgICBpbWcuc3JjID0gY2FudmFzLnRvRGF0YVVSTCgpOwoKICAgICAgICAgICAgfQogICAgICAgICAgICBpbWdSYWRpYWwuc3JjID0gY2FudmFzUmFkaWFsLnRvRGF0YVVSTCgpOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gaW1nOwp9OwoKX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RBbHBoYSA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgdmFyIHRtcCA9ICIiLAogICAgbW9kdWx1czsKCiAgICBkbyB7CiAgICAgICAgbW9kdWx1cyA9IG51bWJlciAlIDI2OwogICAgICAgIHRtcCA9IFN0cmluZy5mcm9tQ2hhckNvZGUoKG1vZHVsdXMpICsgNjQpICsgdG1wOwogICAgICAgIG51bWJlciA9IG51bWJlciAvIDI2OwogICAgfXdoaWxlKChudW1iZXIqMjYpID4gMjYpOwoKICAgIHJldHVybiB0bXA7Cn07CgpfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdFJvbWFuID0gZnVuY3Rpb24obnVtYmVyKSB7CiAgICB2YXIgcm9tYW5BcnJheSA9IFsiTSIsICJDTSIsICJEIiwgIkNEIiwgIkMiLCAiWEMiLCAiTCIsICJYTCIsICJYIiwgIklYIiwgIlYiLCAiSVYiLCAiSSJdLAogICAgZGVjaW1hbCA9IFsxMDAwLCA5MDAsIDUwMCwgNDAwLCAxMDAsIDkwLCA1MCwgNDAsIDEwLCA5LCA1LCA0LCAxXSwKICAgIHJvbWFuID0gIiIsCiAgICB2LAogICAgbGVuID0gcm9tYW5BcnJheS5sZW5ndGg7CgogICAgaWYgKG51bWJlciA8PSAwIHx8IG51bWJlciA+PSA0MDAwKSB7CiAgICAgICAgcmV0dXJuIG51bWJlcjsKICAgIH0KCiAgICBmb3IgKHY9MDsgdiA8IGxlbjsgdis9MSkgewogICAgICAgIHdoaWxlIChudW1iZXIgPj0gZGVjaW1hbFt2XSkgewogICAgICAgICAgICBudW1iZXIgLT0gZGVjaW1hbFt2XTsKICAgICAgICAgICAgcm9tYW4gKz0gcm9tYW5BcnJheVt2XTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJvbWFuOwoKfTsKCn0pKCk7Ci8qCiAgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogIGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmgKCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UKICovCgovKgogKiAgTmV3IGZ1bmN0aW9uIGZvciB0cmF2ZXJzaW5nIGVsZW1lbnRzCiAqLwoKX2h0bWwyY2FudmFzLlBhcnNlID0gZnVuY3Rpb24gKCBpbWFnZXMsIG9wdGlvbnMgKSB7CiAgICB3aW5kb3cuc2Nyb2xsKDAsMCk7CgogICAgdmFyIHN1cHBvcnQgPSB7CiAgICAgICAgcmFuZ2VCb3VuZHM6IGZhbHNlLAogICAgICAgIHN2Z1JlbmRlcmluZzogb3B0aW9ucy5zdmdSZW5kZXJpbmcgJiYgKGZ1bmN0aW9uKCApewogICAgICAgICAgICB2YXIgaW1nID0gbmV3IEltYWdlKCksCiAgICAgICAgICAgIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpLAogICAgICAgICAgICBjdHggPSAoY2FudmFzLmdldENvbnRleHQgPT09IHVuZGVmaW5lZCkgPyBmYWxzZSA6IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgICAgICAgICBpZiAoY3R4ID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgLy8gYnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgY2FudmFzLCBnb29kIGx1Y2sgc3VwcG9ydGluZyBTVkcgb24gY2FudmFzCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FudmFzLndpZHRoID0gY2FudmFzLmhlaWdodCA9IDEwOwogICAgICAgICAgICBpbWcuc3JjID0gWwogICAgICAgICAgICAiZGF0YTppbWFnZS9zdmcreG1sLCIsCiAgICAgICAgICAgICI8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJz4iLAogICAgICAgICAgICAiPGZvcmVpZ25PYmplY3Qgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJz4iLAogICAgICAgICAgICAiPGRpdiB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCcgc3R5bGU9J3dpZHRoOjEwO2hlaWdodDoxMDsnPiIsCiAgICAgICAgICAgICJzdXAiLAogICAgICAgICAgICAiPC9kaXY+IiwKICAgICAgICAgICAgIjwvZm9yZWlnbk9iamVjdD4iLAogICAgICAgICAgICAiPC9zdmc+IgogICAgICAgICAgICBdLmpvaW4oIiIpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDAsIDApOwogICAgICAgICAgICAgICAgY2FudmFzLnRvRGF0YVVSTCgpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBoMmNsb2coJ2h0bWwyY2FudmFzOiBQYXJzZTogU1ZHIHBvd2VyZWQgcmVuZGVyaW5nIGF2YWlsYWJsZScpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgICAgfSkoKQogICAgfSwKICAgIGVsZW1lbnQgPSAoKCBvcHRpb25zLmVsZW1lbnRzID09PSB1bmRlZmluZWQgKSA/IGRvY3VtZW50LmJvZHkgOiBvcHRpb25zLmVsZW1lbnRzWzBdKSwgLy8gc2VsZWN0IGJvZHkgYnkgZGVmYXVsdAogICAgbmVlZFJlb3JkZXIgPSBmYWxzZSwKICAgIG51bURyYXdzID0gMCwKICAgIGZvbnREYXRhID0ge30sCiAgICBkb2MgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQsCiAgICBpZ25vcmVFbGVtZW50c1JlZ0V4cCA9IG5ldyBSZWdFeHAoIigiICsgb3B0aW9ucy5pZ25vcmVFbGVtZW50cyArICIpIiksCiAgICBib2R5ID0gZG9jLmJvZHksCiAgICByLAogICAgdGVzdEVsZW1lbnQsCiAgICByYW5nZUJvdW5kcywKICAgIHJhbmdlSGVpZ2h0LAogICAgc3RhY2ssCiAgICBjdHgsCiAgICBkb2NEaW0sCiAgICBpLAogICAgY2hpbGRyZW4sCiAgICBjaGlsZHJlbkxlbjsKCgogICAgZnVuY3Rpb24gZG9jU2l6ZSgpewoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB3aWR0aDogTWF0aC5tYXgoCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5zY3JvbGxXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxXaWR0aCksCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5vZmZzZXRXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5vZmZzZXRXaWR0aCksCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5jbGllbnRXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCkKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgIGhlaWdodDogTWF0aC5tYXgoCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5zY3JvbGxIZWlnaHQsIGRvYy5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsSGVpZ2h0KSwKICAgICAgICAgICAgICAgIE1hdGgubWF4KGRvYy5ib2R5Lm9mZnNldEhlaWdodCwgZG9jLmRvY3VtZW50RWxlbWVudC5vZmZzZXRIZWlnaHQpLAogICAgICAgICAgICAgICAgTWF0aC5tYXgoZG9jLmJvZHkuY2xpZW50SGVpZ2h0LCBkb2MuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkKICAgICAgICAgICAgICAgICkKICAgICAgICB9OwoKICAgIH0KCiAgICBpbWFnZXMgPSBpbWFnZXMgfHwge307CgogICAgLy8gVGVzdCB3aGV0aGVyIHdlIGNhbiB1c2UgcmFuZ2VzIHRvIG1lYXN1cmUgYm91bmRpbmcgYm94ZXMKICAgIC8vIE9wZXJhIGRvZXNuJ3QgcHJvdmlkZSB2YWxpZCBib3VuZHMuaGVpZ2h0L2JvdHRvbSBldmVuIHRob3VnaCBpdCBzdXBwb3J0cyB0aGUgbWV0aG9kLgoKCiAgICBpZiAoZG9jLmNyZWF0ZVJhbmdlKSB7CiAgICAgICAgciA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgICAgIC8vdGhpcy5zdXBwb3J0LnJhbmdlQm91bmRzID0gbmV3IEJvb2xlYW4oci5nZXRCb3VuZGluZ0NsaWVudFJlY3QpOwogICAgICAgIGlmIChyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCl7CiAgICAgICAgICAgIHRlc3RFbGVtZW50ID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2JvdW5kdGVzdCcpOwogICAgICAgICAgICB0ZXN0RWxlbWVudC5zdHlsZS5oZWlnaHQgPSAiMTIzcHgiOwogICAgICAgICAgICB0ZXN0RWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICAgICAgYm9keS5hcHBlbmRDaGlsZCh0ZXN0RWxlbWVudCk7CgogICAgICAgICAgICByLnNlbGVjdE5vZGUodGVzdEVsZW1lbnQpOwogICAgICAgICAgICByYW5nZUJvdW5kcyA9IHIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgICAgIHJhbmdlSGVpZ2h0ID0gcmFuZ2VCb3VuZHMuaGVpZ2h0OwoKICAgICAgICAgICAgaWYgKHJhbmdlSGVpZ2h0ID09PSAxMjMpIHsKICAgICAgICAgICAgICAgIHN1cHBvcnQucmFuZ2VCb3VuZHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJvZHkucmVtb3ZlQ2hpbGQodGVzdEVsZW1lbnQpOwoKCiAgICAgICAgfQoKICAgIH0KCgogICAgLyoKICAgIHZhciByb290U3RhY2sgPSBuZXcgdGhpcy5zdG9yYWdlQ29udGV4dCgkKGRvY3VtZW50KS53aWR0aCgpLCQoZG9jdW1lbnQpLmhlaWdodCgpKTsKICAgIHJvb3RTdGFjay5vcGFjaXR5ID0gdGhpcy5nZXRDU1ModGhpcy5lbGVtZW50LCJvcGFjaXR5Iik7CiAgICB2YXIgc3RhY2sgPSB0aGlzLm5ld0VsZW1lbnQodGhpcy5lbGVtZW50LHJvb3RTdGFjayk7CgoKICAgIHRoaXMucGFyc2VFbGVtZW50KHRoaXMuZWxlbWVudCxzdGFjayk7CiAgICAgKi8KCgoKCiAgICB2YXIgZ2V0Q1NTID0gX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTOwogICAgZnVuY3Rpb24gZ2V0Q1NTSW50KGVsZW1lbnQsIGF0dHJpYnV0ZSkgewogICAgICAgIHZhciB2YWwgPSBwYXJzZUludChnZXRDU1MoZWxlbWVudCwgYXR0cmlidXRlKSwgMTApOwogICAgICAgIHJldHVybiAoaXNOYU4odmFsKSkgPyAwIDogdmFsOyAvLyBib3JkZXJzIGluIG9sZCBJRSBhcmUgdGhyb3dpbmcgJ21lZGl1bScgZm9yIGRlbW8uaHRtbAogICAgfQoKICAgIC8vIERyYXdpbmcgYSByZWN0YW5nbGUKICAgIGZ1bmN0aW9uIHJlbmRlclJlY3QgKGN0eCwgeCwgeSwgdywgaCwgYmdjb2xvcikgewogICAgICAgIGlmICggYmdjb2xvciAhPT0gInRyYW5zcGFyZW50IiApewogICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoImZpbGxTdHlsZSIsIGJnY29sb3IpOwogICAgICAgICAgICBjdHguZmlsbFJlY3QgKHgsIHksIHcsIGgpOwogICAgICAgICAgICBudW1EcmF3cys9MTsKICAgICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIHRleHRUcmFuc2Zvcm0gKHRleHQsIHRyYW5zZm9ybSkgewogICAgICAgIHN3aXRjaCh0cmFuc2Zvcm0pewogICAgICAgICAgICBjYXNlICJsb3dlcmNhc2UiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRleHQudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAgIGNhc2UgImNhcGl0YWxpemUiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSggLyhefFxzfDp8LXxcKHxcKSkoW2Etel0pL2cgLCBmdW5jdGlvbiAobSwgcDEsIHAyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG0ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcDEgKyBwMi50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gKTsKCiAgICAgICAgICAgIGNhc2UgInVwcGVyY2FzZSI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGV4dC50b1VwcGVyQ2FzZSgpOwoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiB0ZXh0OwoKICAgICAgICB9CgogICAgfQoKICAgIGZ1bmN0aW9uIHRyaW1UZXh0ICh0ZXh0KSB7CiAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSgvXlxzKi9nLCAiIikucmVwbGFjZSgvXHMqJC9nLCAiIik7CiAgICB9CgogICAgZnVuY3Rpb24gZm9udE1ldHJpY3MgKGZvbnQsIGZvbnRTaXplKSB7CgogICAgICAgIGlmIChmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGZvbnREYXRhW2ZvbnQgKyAiLSIgKyBmb250U2l6ZV07CiAgICAgICAgfQoKCiAgICAgICAgdmFyIGNvbnRhaW5lciA9IGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKSwKICAgICAgICBpbWcgPSBkb2MuY3JlYXRlRWxlbWVudCgnaW1nJyksCiAgICAgICAgc3BhbiA9IGRvYy5jcmVhdGVFbGVtZW50KCdzcGFuJyksCiAgICAgICAgYmFzZWxpbmUsCiAgICAgICAgbWlkZGxlLAogICAgICAgIG1ldHJpY3NPYmo7CgoKICAgICAgICBjb250YWluZXIuc3R5bGUudmlzaWJpbGl0eSA9ICJoaWRkZW4iOwogICAgICAgIGNvbnRhaW5lci5zdHlsZS5mb250RmFtaWx5ID0gZm9udDsKICAgICAgICBjb250YWluZXIuc3R5bGUuZm9udFNpemUgPSBmb250U2l6ZTsKICAgICAgICBjb250YWluZXIuc3R5bGUubWFyZ2luID0gMDsKICAgICAgICBjb250YWluZXIuc3R5bGUucGFkZGluZyA9IDA7CgogICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTsKCgoKICAgICAgICAvLyBodHRwOi8vcHJvYmFibHlwcm9ncmFtbWluZy5jb20vMjAwOS8wMy8xNS90aGUtdGluaWVzdC1naWYtZXZlciAoaGFuZHRpbnl3aGl0ZS5naWYpCiAgICAgICAgaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQkFQLy8vd0FBQUN3QUFBQUFBUUFCQUFBQ0FrUUJBRHM9IjsKICAgICAgICBpbWcud2lkdGggPSAxOwogICAgICAgIGltZy5oZWlnaHQgPSAxOwoKICAgICAgICBpbWcuc3R5bGUubWFyZ2luID0gMDsKICAgICAgICBpbWcuc3R5bGUucGFkZGluZyA9IDA7CiAgICAgICAgaW1nLnN0eWxlLnZlcnRpY2FsQWxpZ24gPSAiYmFzZWxpbmUiOwoKICAgICAgICBzcGFuLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250OwogICAgICAgIHNwYW4uc3R5bGUuZm9udFNpemUgPSBmb250U2l6ZTsKICAgICAgICBzcGFuLnN0eWxlLm1hcmdpbiA9IDA7CiAgICAgICAgc3Bhbi5zdHlsZS5wYWRkaW5nID0gMDsKCgoKCiAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUoJ0hpZGRlbiBUZXh0JykpOwogICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChzcGFuKTsKICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoaW1nKTsKICAgICAgICBiYXNlbGluZSA9IChpbWcub2Zmc2V0VG9wIC0gc3Bhbi5vZmZzZXRUb3ApICsgMTsKCiAgICAgICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKHNwYW4pOwogICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUoJ0hpZGRlbiBUZXh0JykpOwoKICAgICAgICBjb250YWluZXIuc3R5bGUubGluZUhlaWdodCA9ICJub3JtYWwiOwogICAgICAgIGltZy5zdHlsZS52ZXJ0aWNhbEFsaWduID0gInN1cGVyIjsKCiAgICAgICAgbWlkZGxlID0gKGltZy5vZmZzZXRUb3AtY29udGFpbmVyLm9mZnNldFRvcCkgKyAxOwogICAgICAgIG1ldHJpY3NPYmogPSB7CiAgICAgICAgICAgIGJhc2VsaW5lOiBiYXNlbGluZSwKICAgICAgICAgICAgbGluZVdpZHRoOiAxLAogICAgICAgICAgICBtaWRkbGU6IG1pZGRsZQogICAgICAgIH07CgoKICAgICAgICBmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdID0gbWV0cmljc09iajsKCiAgICAgICAgYm9keS5yZW1vdmVDaGlsZChjb250YWluZXIpOwoKICAgICAgICByZXR1cm4gbWV0cmljc09iajsKCiAgICB9CgoKICAgIGZ1bmN0aW9uIGRyYXdUZXh0KGN1cnJlbnRUZXh0LCB4LCB5LCBjdHgpewogICAgICAgIGlmICh0cmltVGV4dChjdXJyZW50VGV4dCkubGVuZ3RoPjApIHsKICAgICAgICAgICAgY3R4LmZpbGxUZXh0KGN1cnJlbnRUZXh0LHgseSk7CiAgICAgICAgICAgIG51bURyYXdzKz0xOwogICAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gcmVuZGVyVGV4dChlbCwgdGV4dE5vZGUsIHN0YWNrKSB7CiAgICAgICAgdmFyIGN0eCA9IHN0YWNrLmN0eCwKICAgICAgICBmYW1pbHkgPSBnZXRDU1MoZWwsICJmb250RmFtaWx5IiksCiAgICAgICAgc2l6ZSA9IGdldENTUyhlbCwgImZvbnRTaXplIiksCiAgICAgICAgY29sb3IgPSBnZXRDU1MoZWwsICJjb2xvciIpLAogICAgICAgIHRleHRfZGVjb3JhdGlvbiA9IGdldENTUyhlbCwgInRleHREZWNvcmF0aW9uIiksCiAgICAgICAgdGV4dF9hbGlnbiA9IGdldENTUyhlbCwgInRleHRBbGlnbiIpLAogICAgICAgIGxldHRlcl9zcGFjaW5nID0gZ2V0Q1NTKGVsLCAibGV0dGVyU3BhY2luZyIpLAogICAgICAgIGJvdW5kcywKICAgICAgICB0ZXh0LAogICAgICAgIG1ldHJpY3MsCiAgICAgICAgcmVuZGVyTGlzdCwKICAgICAgICBsaXN0TGVuLAogICAgICAgIGJvbGQgPSBnZXRDU1MoZWwsICJmb250V2VpZ2h0IiksCiAgICAgICAgZm9udF9zdHlsZSA9IGdldENTUyhlbCwgImZvbnRTdHlsZSIpLAogICAgICAgIGZvbnRfdmFyaWFudCA9IGdldENTUyhlbCwgImZvbnRWYXJpYW50IiksCiAgICAgICAgYWxpZ24gPSBmYWxzZSwKICAgICAgICBuZXdUZXh0Tm9kZSwKICAgICAgICB0ZXh0VmFsdWUsCiAgICAgICAgdGV4dE9mZnNldCA9IDAsCiAgICAgICAgb2xkVGV4dE5vZGUsCiAgICAgICAgYywKICAgICAgICByYW5nZSwKICAgICAgICBwYXJlbnQsCiAgICAgICAgd3JhcEVsZW1lbnQsCiAgICAgICAgYmFja3VwVGV4dDsKCiAgICAgICAgLy8gYXBwbHkgdGV4dC10cmFuc2Zvcm06YXRpb24gdG8gdGhlIHRleHQKCgoKICAgICAgICB0ZXh0Tm9kZS5ub2RlVmFsdWUgPSB0ZXh0VHJhbnNmb3JtKHRleHROb2RlLm5vZGVWYWx1ZSwgZ2V0Q1NTKGVsLCAidGV4dFRyYW5zZm9ybSIpKTsKICAgICAgICB0ZXh0ID0gdHJpbVRleHQodGV4dE5vZGUubm9kZVZhbHVlKTsKCiAgICAgICAgaWYgKHRleHQubGVuZ3RoPjApewoKICAgICAgICAgICAgaWYgKHRleHRfZGVjb3JhdGlvbiAhPT0gIm5vbmUiKXsKICAgICAgICAgICAgICAgIG1ldHJpY3MgPSBmb250TWV0cmljcyhmYW1pbHksIHNpemUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0ZXh0X2FsaWduID0gdGV4dF9hbGlnbi5yZXBsYWNlKFsiLXdlYmtpdC1hdXRvIl0sWyJhdXRvIl0pOwoKICAgICAgICAgICAgaWYgKG9wdGlvbnMubGV0dGVyUmVuZGVyaW5nID09PSBmYWxzZSAmJiAvXihsZWZ0fHJpZ2h0fGp1c3RpZnl8YXV0bykkLy50ZXN0KHRleHRfYWxpZ24pICYmIC9eKG5vcm1hbHxub25lKSQvLnRlc3QobGV0dGVyX3NwYWNpbmcpKXsKICAgICAgICAgICAgICAgIC8vIHRoaXMuc2V0Q29udGV4dFZhcmlhYmxlKGN0eCwidGV4dEFsaWduIix0ZXh0X2FsaWduKTsKICAgICAgICAgICAgICAgIHJlbmRlckxpc3QgPSB0ZXh0Tm9kZS5ub2RlVmFsdWUuc3BsaXQoLyhcYnwgKS8pOwoKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAvLyAgdGhpcy5zZXRDb250ZXh0VmFyaWFibGUoY3R4LCJ0ZXh0QWxpZ24iLCJsZWZ0Iik7CiAgICAgICAgICAgICAgICByZW5kZXJMaXN0ID0gdGV4dE5vZGUubm9kZVZhbHVlLnNwbGl0KCIiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dpdGNoKHBhcnNlSW50KGJvbGQsIDEwKSl7CiAgICAgICAgICAgICAgICBjYXNlIDQwMToKICAgICAgICAgICAgICAgICAgICBib2xkID0gImJvbGQiOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA0MDA6CiAgICAgICAgICAgICAgICAgICAgYm9sZCA9ICJub3JtYWwiOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoImZpbGxTdHlsZSIsIGNvbG9yKTsKCiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgbmVlZCB0byBiZSBkZWZpbmVkIGluIHRoZSBvcmRlciBhcyBkZWZpbmVkIGluIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL2ZvbnRzLmh0bWwjZm9udC1zaG9ydGhhbmQKICAgICAgICAgICAgICB0byBwcm9wZXJseSB3b3JrIGluIEZpcmVmb3gKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSgiZm9udCIsIGZvbnRfc3R5bGUrICIgIiArIGZvbnRfdmFyaWFudCAgKyAiICIgKyBib2xkICsgIiAiICsgc2l6ZSArICIgIiArIGZhbWlseSk7CgogICAgICAgICAgICBpZiAoYWxpZ24pewogICAgICAgICAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJ0ZXh0QWxpZ24iLCAicmlnaHQiKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoInRleHRBbGlnbiIsICJsZWZ0Iik7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvKgogICAgICAgIGlmIChzdGFjay5jbGlwKXsKICAgICAgICBjdHgucmVjdCAoc3RhY2suY2xpcC5sZWZ0LCBzdGFjay5jbGlwLnRvcCwgc3RhY2suY2xpcC53aWR0aCwgc3RhY2suY2xpcC5oZWlnaHQpOwogICAgICAgIGN0eC5jbGlwKCk7CiAgICAgICAgfQogICAgICAgICAgICAgKi8KCgogICAgICAgICAgICBvbGRUZXh0Tm9kZSA9IHRleHROb2RlOwoKCiAgICAgICAgICAgIGZvciAoIGM9MCwgbGlzdExlbiA9IHJlbmRlckxpc3QubGVuZ3RoOyBjIDwgbGlzdExlbjsgYys9MSApIHsKICAgICAgICAgICAgICAgIHRleHRWYWx1ZSA9IG51bGw7CgoKCiAgICAgICAgICAgICAgICBpZiAoc3VwcG9ydC5yYW5nZUJvdW5kcyl7CiAgICAgICAgICAgICAgICAgICAgLy8gZ2V0Qm91bmRpbmdDbGllbnRSZWN0IGlzIHN1cHBvcnRlZCBmb3IgcmFuZ2VzCiAgICAgICAgICAgICAgICAgICAgaWYgKHRleHRfZGVjb3JhdGlvbiAhPT0gIm5vbmUiIHx8IHRyaW1UZXh0KHJlbmRlckxpc3RbY10pLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0VmFsdWUgPSByZW5kZXJMaXN0W2NdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9jLmNyZWF0ZVJhbmdlKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlID0gZG9jLmNyZWF0ZVJhbmdlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQodGV4dE5vZGUsIHRleHRPZmZzZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kKHRleHROb2RlLCB0ZXh0T2Zmc2V0ICsgdGV4dFZhbHVlLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyBhZGQgSUUgc3VwcG9ydAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSBib2R5LmNyZWF0ZVRleHRSYW5nZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmFuZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IHJhbmdlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIC8vIGl0IGlzbid0IHN1cHBvcnRlZCwgc28gbGV0J3Mgd3JhcCBpdCBpbnNpZGUgYW4gZWxlbWVudCBpbnN0ZWFkIGFuZCBnZXQgdGhlIGJvdW5kcyB0aGVyZQoKICAgICAgICAgICAgICAgICAgICAvLyBJRSA5IGJ1ZwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2xkVGV4dE5vZGUubm9kZVZhbHVlICE9PSAic3RyaW5nIiApewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIG5ld1RleHROb2RlID0gb2xkVGV4dE5vZGUuc3BsaXRUZXh0KHJlbmRlckxpc3RbY10ubGVuZ3RoKTsKCiAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gb2xkVGV4dE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICB3cmFwRWxlbWVudCA9IGRvYy5jcmVhdGVFbGVtZW50KCd3cmFwcGVyJyk7CiAgICAgICAgICAgICAgICAgICAgYmFja3VwVGV4dCA9IG9sZFRleHROb2RlLmNsb25lTm9kZSh0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgd3JhcEVsZW1lbnQuYXBwZW5kQ2hpbGQob2xkVGV4dE5vZGUuY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKHdyYXBFbGVtZW50LCBvbGRUZXh0Tm9kZSk7CgogICAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IF9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyh3cmFwRWxlbWVudCk7CgogICAgICAgICAgICAgICAgICAgIHRleHRWYWx1ZSA9IG9sZFRleHROb2RlLm5vZGVWYWx1ZTsKCiAgICAgICAgICAgICAgICAgICAgb2xkVGV4dE5vZGUgPSBuZXdUZXh0Tm9kZTsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKGJhY2t1cFRleHQsIHdyYXBFbGVtZW50KTsKCgogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0ZXh0VmFsdWUgIT09IG51bGwpewogICAgICAgICAgICAgICAgICAgIGRyYXdUZXh0KHRleHRWYWx1ZSwgYm91bmRzLmxlZnQsIGJvdW5kcy5ib3R0b20sIGN0eCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc3dpdGNoKHRleHRfZGVjb3JhdGlvbikgewogICAgICAgICAgICAgICAgICAgIGNhc2UgInVuZGVybGluZSI6CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERyYXdzIGEgbGluZSBhdCB0aGUgYmFzZWxpbmUgb2YgdGhlIGZvbnQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyBBcyBzb21lIGJyb3dzZXJzIGRpc3BsYXkgdGhlIGxpbmUgYXMgbW9yZSB0aGFuIDFweCBpZiB0aGUgZm9udC1zaXplIGlzIGJpZywgbmVlZCB0byB0YWtlIHRoYXQgaW50byBhY2NvdW50IGJvdGggaW4gcG9zaXRpb24gYW5kIHNpemUKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyUmVjdChjdHgsIGJvdW5kcy5sZWZ0LCBNYXRoLnJvdW5kKGJvdW5kcy50b3AgKyBtZXRyaWNzLmJhc2VsaW5lICsgbWV0cmljcy5saW5lV2lkdGgpLCBib3VuZHMud2lkdGgsIDEsIGNvbG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAib3ZlcmxpbmUiOgogICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJSZWN0KGN0eCwgYm91bmRzLmxlZnQsIGJvdW5kcy50b3AsIGJvdW5kcy53aWR0aCwgMSwgY29sb3IpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJsaW5lLXRocm91Z2giOgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPIHRyeSBhbmQgZmluZCBleGFjdCBwb3NpdGlvbiBmb3IgbGluZS10aHJvdWdoCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlclJlY3QoY3R4LCBib3VuZHMubGVmdCwgTWF0aC5jZWlsKGJvdW5kcy50b3AgKyBtZXRyaWNzLm1pZGRsZSArIG1ldHJpY3MubGluZVdpZHRoKSwgYm91bmRzLndpZHRoLCAxLCBjb2xvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIH0KCgoKCgogICAgICAgICAgICAgICAgdGV4dE9mZnNldCArPSByZW5kZXJMaXN0W2NdLmxlbmd0aDsKCiAgICAgICAgICAgIH0KCgoKICAgICAgICB9CgogICAgfQoKICAgIGZ1bmN0aW9uIGxpc3RQb3NpdGlvbiAoZWxlbWVudCwgdmFsKSB7CiAgICAgICAgdmFyIGJvdW5kRWxlbWVudCA9IGRvYy5jcmVhdGVFbGVtZW50KCAiYm91bmRlbGVtZW50IiApLAogICAgICAgIHR5cGUsCiAgICAgICAgYm91bmRzOwoKICAgICAgICBib3VuZEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJpbmxpbmUiOwogICAgICAgIC8vYm91bmRFbGVtZW50LnN0eWxlLndpZHRoID0gIjFweCI7CiAgICAgICAgLy9ib3VuZEVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gIjFweCI7CgogICAgICAgIHR5cGUgPSBlbGVtZW50LnN0eWxlLmxpc3RTdHlsZVR5cGU7CiAgICAgICAgZWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlID0gIm5vbmUiOwoKICAgICAgICBib3VuZEVsZW1lbnQuYXBwZW5kQ2hpbGQoIGRvYy5jcmVhdGVUZXh0Tm9kZSggdmFsICkgKTsKCgogICAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKGJvdW5kRWxlbWVudCwgZWxlbWVudC5maXJzdENoaWxkKTsKCgogICAgICAgIGJvdW5kcyA9IF9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyggYm91bmRFbGVtZW50ICk7CiAgICAgICAgZWxlbWVudC5yZW1vdmVDaGlsZCggYm91bmRFbGVtZW50ICk7CiAgICAgICAgZWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlID0gdHlwZTsKICAgICAgICByZXR1cm4gYm91bmRzOwoKICAgIH0KICAgIAoKICAgIAogICAgZnVuY3Rpb24gZWxlbWVudEluZGV4KCBlbCApIHsKICAgICAgICB2YXIgaSA9IC0xLAogICAgICAgIGNvdW50ID0gMSwKICAgICAgICBjaGlsZHMgPSBlbC5wYXJlbnROb2RlLmNoaWxkTm9kZXM7CgogICAgICAgIGlmICggZWwucGFyZW50Tm9kZSApIHsKICAgICAgICAgICAgd2hpbGUoIGNoaWxkc1sgKytpIF0gIT09IGVsICkgewogICAgICAgICAgICAgICAgaWYgKCBjaGlsZHNbIGkgXS5ub2RlVHlwZSA9PT0gMSApIHsKICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3VudDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgCiAgICB9CgogICAgZnVuY3Rpb24gcmVuZGVyTGlzdEl0ZW0oZWxlbWVudCwgc3RhY2ssIGVsQm91bmRzKSB7CgoKICAgICAgICB2YXIgcG9zaXRpb24gPSBnZXRDU1MoZWxlbWVudCwgImxpc3RTdHlsZVBvc2l0aW9uIiksCiAgICAgICAgeCwKICAgICAgICB5LAogICAgICAgIHR5cGUgPSBnZXRDU1MoZWxlbWVudCwgImxpc3RTdHlsZVR5cGUiKSwKICAgICAgICBjdXJyZW50SW5kZXgsCiAgICAgICAgdGV4dCwKICAgICAgICBsaXN0Qm91bmRzLAogICAgICAgIGJvbGQgPSBnZXRDU1MoZWxlbWVudCwgImZvbnRXZWlnaHQiKTsKCiAgICAgICAgaWYgKC9eKGRlY2ltYWx8ZGVjaW1hbC1sZWFkaW5nLXplcm98dXBwZXItYWxwaGF8dXBwZXItbGF0aW58dXBwZXItcm9tYW58bG93ZXItYWxwaGF8bG93ZXItZ3JlZWt8bG93ZXItbGF0aW58bG93ZXItcm9tYW4pJC9pLnRlc3QodHlwZSkpIHsKCiAgICAgICAgICAgIGN1cnJlbnRJbmRleCA9IGVsZW1lbnRJbmRleCggZWxlbWVudCApOwoKICAgICAgICAgICAgc3dpdGNoKHR5cGUpewogICAgICAgICAgICAgICAgY2FzZSAiZGVjaW1hbCI6CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IGN1cnJlbnRJbmRleDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImRlY2ltYWwtbGVhZGluZy16ZXJvIjoKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEluZGV4LnRvU3RyaW5nKCkubGVuZ3RoID09PSAxKXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IGN1cnJlbnRJbmRleCA9ICIwIiArIGN1cnJlbnRJbmRleC50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gY3VycmVudEluZGV4LnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidXBwZXItcm9tYW4iOgogICAgICAgICAgICAgICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdFJvbWFuKCBjdXJyZW50SW5kZXggKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImxvd2VyLXJvbWFuIjoKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RSb21hbiggY3VycmVudEluZGV4ICkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImxvd2VyLWFscGhhIjoKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RBbHBoYSggY3VycmVudEluZGV4ICkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInVwcGVyLWFscGhhIjoKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RBbHBoYSggY3VycmVudEluZGV4ICk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICB0ZXh0ICs9ICIuICI7CiAgICAgICAgICAgIGxpc3RCb3VuZHMgPSBsaXN0UG9zaXRpb24oZWxlbWVudCwgdGV4dCk7CgoKCiAgICAgICAgICAgIHN3aXRjaChib2xkKXsKICAgICAgICAgICAgICAgIGNhc2UgNDAxOgogICAgICAgICAgICAgICAgICAgIGJvbGQgPSAiYm9sZCI7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgICAgICBib2xkID0gIm5vcm1hbCI7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCgoKCiAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSggImZpbGxTdHlsZSIsIGdldENTUyhlbGVtZW50LCAiY29sb3IiKSApOwogICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoICJmb250IiwgZ2V0Q1NTKGVsZW1lbnQsICJmb250VmFyaWFudCIpICsgIiAiICsgYm9sZCArICIgIiArIGdldENTUyhlbGVtZW50LCAiZm9udFN0eWxlIikgKyAiICIgKyBnZXRDU1MoZWxlbWVudCwgImZvbnRTaXplIikgKyAiICIgKyBnZXRDU1MoZWxlbWVudCwgImZvbnRGYW1pbHkiKSApOwoKCiAgICAgICAgICAgIGlmICggcG9zaXRpb24gPT09ICJpbnNpZGUiICkgewogICAgICAgICAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJ0ZXh0QWxpZ24iLCAibGVmdCIpOwogICAgICAgICAgICAgICAgLy8gICB0aGlzLnNldEZvbnQoc3RhY2suY3R4LCBlbGVtZW50LCBmYWxzZSk7CiAgICAgICAgICAgICAgICB4ID0gZWxCb3VuZHMubGVmdDsKCiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgIFRPRE8gcmVhbGx5IG5lZWQgdG8gZmlndXJlIG91dCBzb21lIG1vcmUgYWNjdXJhdGUgd2F5IHRvIHRyeSBhbmQgZmluZCB0aGUgcG9zaXRpb24uCiAgICAgICAgICAgICAgICAgYXMgZGVmaW5lZCBpbiBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9nZW5lcmF0ZS5odG1sI3Byb3BkZWYtbGlzdC1zdHlsZS1wb3NpdGlvbiwgaXQgZG9lcyBub3QgZXZlbiBoYXZlIGEgc3BlY2lmaWVkICJjb3JyZWN0IiBwb3NpdGlvbiwgc28gZWFjaCBicm93c2VyCiAgICAgICAgICAgICAgICAgbWF5IGRpc3BsYXkgaXQgd2hhdGV2ZXIgd2F5IGl0IGZlZWxzIGxpa2UuCiAgICAgICAgICAgICAgICAgIlRoZSBwb3NpdGlvbiBvZiB0aGUgbGlzdC1pdGVtIG1hcmtlciBhZGphY2VudCB0byBmbG9hdHMgaXMgdW5kZWZpbmVkIGluIENTUyAyLjEuIENTUyAyLjEgZG9lcyBub3Qgc3BlY2lmeSB0aGUgcHJlY2lzZSBsb2NhdGlvbiBvZiB0aGUgbWFya2VyIGJveCBvciBpdHMgcG9zaXRpb24gaW4gdGhlIHBhaW50aW5nIG9yZGVyIgoKICAgICAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSgidGV4dEFsaWduIiwgInJpZ2h0Iik7CiAgICAgICAgICAgICAgICAvLyAgdGhpcy5zZXRGb250KHN0YWNrLmN0eCwgZWxlbWVudCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB4ID0gZWxCb3VuZHMubGVmdCAtIDEwOwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHkgPSBsaXN0Qm91bmRzLmJvdHRvbTsKCiAgICAgICAgICAgIGRyYXdUZXh0KHRleHQsIHgsIHksIGN0eCk7CgoKICAgICAgICB9CgoKICAgIH0KCiAgICBmdW5jdGlvbiBsb2FkSW1hZ2UgKHNyYyl7CiAgICAgICAgdmFyIGltZyA9IGltYWdlc1tzcmNdOwogICAgICAgIGlmIChpbWcgJiYgaW1nLnN1Y2NlZWRlZCA9PT0gdHJ1ZSkgewogICAgICAgICAgICByZXR1cm4gaW1nLmltZzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKCgoKCgogICAgZnVuY3Rpb24gY2xpcEJvdW5kcyhzcmMsIGRzdCl7CgogICAgICAgIHZhciB4ID0gTWF0aC5tYXgoc3JjLmxlZnQsIGRzdC5sZWZ0KSwKICAgICAgICB5ID0gTWF0aC5tYXgoc3JjLnRvcCwgZHN0LnRvcCksCiAgICAgICAgeDIgPSBNYXRoLm1pbigoc3JjLmxlZnQgKyBzcmMud2lkdGgpLCAoZHN0LmxlZnQgKyBkc3Qud2lkdGgpKSwKICAgICAgICB5MiA9IE1hdGgubWluKChzcmMudG9wICsgc3JjLmhlaWdodCksIChkc3QudG9wICsgZHN0LmhlaWdodCkpOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBsZWZ0OngsCiAgICAgICAgICAgIHRvcDp5LAogICAgICAgICAgICB3aWR0aDp4Mi14LAogICAgICAgICAgICBoZWlnaHQ6eTIteQogICAgICAgIH07CgogICAgfQoKICAgIGZ1bmN0aW9uIHNldFooekluZGV4LCBwYXJlbnRaKXsKICAgICAgICAvLyBUT0RPIGZpeCBzdGF0aWMgZWxlbWVudHMgb3ZlcmxhcHBpbmcgcmVsYXRpdmUvYWJzb2x1dGUgZWxlbWVudHMgdW5kZXIgc2FtZSBzdGFjaywgaWYgdGhleSBhcmUgZGVmaW5lZCBhZnRlciB0aGVtCiAgICAgICAgdmFyIG5ld0NvbnRleHQ7CiAgICAgICAgaWYgKCFwYXJlbnRaKXsKICAgICAgICAgICAgbmV3Q29udGV4dCA9IGgyY3pDb250ZXh0KDApOwogICAgICAgICAgICByZXR1cm4gbmV3Q29udGV4dDsKICAgICAgICB9CgogICAgICAgIGlmICh6SW5kZXggIT09ICJhdXRvIil7CiAgICAgICAgICAgIG5lZWRSZW9yZGVyID0gdHJ1ZTsKICAgICAgICAgICAgbmV3Q29udGV4dCA9IGgyY3pDb250ZXh0KHpJbmRleCk7CiAgICAgICAgICAgIHBhcmVudFouY2hpbGRyZW4ucHVzaChuZXdDb250ZXh0KTsKICAgICAgICAgICAgcmV0dXJuIG5ld0NvbnRleHQ7CgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHBhcmVudFo7CgogICAgfQoKICAgIGZ1bmN0aW9uIHJlbmRlckJvcmRlcnMoZWwsIGN0eCwgYm91bmRzLCBjbGlwKXsKCiAgICAgICAgLyoKICAgICAgICAgKiAgVE9ETyBhZGQgc3VwcG9ydCBmb3IgZGlmZmVyZW50IGJvcmRlci1zdHlsZSdzIHRoYW4gc29saWQKICAgICAgICAgKi8KCiAgICAgICAgdmFyIHggPSBib3VuZHMubGVmdCwKICAgICAgICB5ID0gYm91bmRzLnRvcCwKICAgICAgICB3ID0gYm91bmRzLndpZHRoLAogICAgICAgIGggPSBib3VuZHMuaGVpZ2h0LAogICAgICAgIGJvcmRlclNpZGUsCiAgICAgICAgYm9yZGVyRGF0YSwKICAgICAgICBieCwKICAgICAgICBieSwKICAgICAgICBidywKICAgICAgICBiaCwKICAgICAgICBydywKICAgICAgICBpLAogICAgICAgIGJvcmRlckFyZ3MsCiAgICAgICAgYm9yZGVyQm91bmRzLAogICAgICAgIGJvcmRlcnMgPSAoZnVuY3Rpb24oZWwpewogICAgICAgICAgICB2YXIgYm9yZGVycyA9IFtdLAogICAgICAgICAgICBzaWRlcyA9IFsiVG9wIiwiUmlnaHQiLCJCb3R0b20iLCJMZWZ0Il0sCiAgICAgICAgICAgIHM7CgogICAgICAgICAgICBmb3IgKHMgPSAwOyBzIDwgNDsgcys9MSl7CiAgICAgICAgICAgICAgICBib3JkZXJzLnB1c2goewogICAgICAgICAgICAgICAgICAgIHdpZHRoOiBnZXRDU1NJbnQoZWwsICdib3JkZXInICsgc2lkZXNbc10gKyAnV2lkdGgnKSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogZ2V0Q1NTKGVsLCAnYm9yZGVyJyArIHNpZGVzW3NdICsgJ0NvbG9yJykKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYm9yZGVyczsKCiAgICAgICAgfShlbCkpLAogICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtYmFja2dyb3VuZC8jdGhlLWJvcmRlci1yYWRpdXMKICAgICAgICBib3JkZXJSYWRpdXMgPSAoZnVuY3Rpb24oIGVsICkgewogICAgICAgICAgICB2YXIgYm9yZGVycyA9IFtdLAogICAgICAgICAgICBzaWRlcyA9IFsiVG9wTGVmdCIsIlRvcFJpZ2h0IiwiQm90dG9tUmlnaHQiLCJCb3R0b21MZWZ0Il0sCiAgICAgICAgICAgIHM7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKHMgPSAwOyBzIDwgNDsgcys9MSl7CiAgICAgICAgICAgICAgICBib3JkZXJzLnB1c2goIGdldENTUyhlbCwgJ2JvcmRlcicgKyBzaWRlc1tzXSArICdSYWRpdXMnKSApOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYm9yZGVyczsKICAgICAgICB9KSggZWwgKTsKCgoKICAgICAgICBmb3IgKCBib3JkZXJTaWRlID0gMDsgYm9yZGVyU2lkZSA8IDQ7IGJvcmRlclNpZGUrPTEgKSB7CiAgICAgICAgICAgIGJvcmRlckRhdGEgPSBib3JkZXJzWyBib3JkZXJTaWRlIF07CiAgICAgICAgICAgIGJvcmRlckFyZ3MgPSBbXTsKICAgICAgICAgICAgaWYgKGJvcmRlckRhdGEud2lkdGg+MCl7CiAgICAgICAgICAgICAgICBieCA9IHg7CiAgICAgICAgICAgICAgICBieSA9IHk7CiAgICAgICAgICAgICAgICBidyA9IHc7CiAgICAgICAgICAgICAgICBiaCA9IGggLSAoYm9yZGVyc1syXS53aWR0aCk7CgogICAgICAgICAgICAgICAgc3dpdGNoKGJvcmRlclNpZGUpewogICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG9wIGJvcmRlcgogICAgICAgICAgICAgICAgICAgICAgICBiaCA9IGJvcmRlcnNbMF0ud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJsaW5lIiwgYngsIGJ5IF07ICAvLyB0b3AgbGVmdAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCArIGJ3LCBieSBdOyAvLyB0b3AgcmlnaHQKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJsaW5lIiwgYnggKyBidyAtIGJvcmRlcnNbIDEgXS53aWR0aCwgYnkgKyBiaCAgXTsgLy8gYm90dG9tIHJpZ2h0CiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIGJ4ICsgYm9yZGVyc1sgMyBdLndpZHRoLCBieSArIGJoIF07IC8vIGJvdHRvbSBsZWZ0CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJpZ2h0IGJvcmRlcgogICAgICAgICAgICAgICAgICAgICAgICBieCA9IHggKyB3IC0gKGJvcmRlcnNbMV0ud2lkdGgpOwogICAgICAgICAgICAgICAgICAgICAgICBidyA9IGJvcmRlcnNbMV0ud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJsaW5lIiwgYngsIGJ5ICsgYm9yZGVyc1sgMCBdLndpZHRoXTsgIC8vIHRvcCBsZWZ0CiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIGJ4ICsgYncsIGJ5IF07IC8vIHRvcCByaWdodAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCArIGJ3LCBieSArIGJoICsgYm9yZGVyc1sgMiBdLndpZHRoIF07IC8vIGJvdHRvbSByaWdodAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCwgYnkgKyBiaCBdOyAvLyBib3R0b20gbGVmdAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgICAgICAvLyBib3R0b20gYm9yZGVyCiAgICAgICAgICAgICAgICAgICAgICAgIGJ5ID0gKGJ5ICsgaCkgLSAoYm9yZGVyc1syXS53aWR0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJoID0gYm9yZGVyc1syXS53aWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgLyogICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvcCBsZWZ0CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggYm9yZGVyUmFkaXVzWyAzIF1bIDAgXSA+IDAgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnggKyBib3JkZXJzWyAzIF0ud2lkdGgsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnkgLSAoYm9yZGVyUmFkaXVzWyAzIF1bIDEgXSkgKyBib3JkZXJzWyAyIF0ud2lkdGgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07ICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJxdWFkcmF0aWNDdXJ2ZSIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnggKyBib3JkZXJzWyAzIF0ud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBieSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ4ICsgYm9yZGVyUmFkaXVzWyAzIF1bIDAgXSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBieSwgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdOyAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBydyA9ICggYm9yZGVyc1sgMyBdLndpZHRoID09PSAwICkgPyAxIDogYm9yZGVyc1sgMiBdLndpZHRoIC8gKGJvcmRlcnNbIDMgXS53aWR0aCArIGJvcmRlcnNbIDIgXS53aWR0aCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJsaW5lIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBieCArIChib3JkZXJSYWRpdXNbIDMgXVsgMCBdICogKCAxLXJ3ICkpLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5IC0gKGJvcmRlclJhZGl1c1sgMyBdWyAxIF0gLSBib3JkZXJzWyAyIF0ud2lkdGgpICsgKGJvcmRlclJhZGl1c1sgMyBdWyAxIF0gKiAoIDEtcncgKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07ICAKICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAicXVhZHJhdGljQ3VydmUiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ4ICsgYm9yZGVyc1sgMyBdLndpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBieCArIGJvcmRlcnNbIDMgXS53aWR0aCArIGJvcmRlclJhZGl1c1sgMyBdWyAwIF0sIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnksICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgXTsgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJiZXppZXJDdXJ2ZSIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnggKyAoYm9yZGVyUmFkaXVzWyAzIF1bIDAgXSAqICggMS1ydyApKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnggKyAoYm9yZGVyUmFkaXVzWyAzIF1bIDAgXSAqICggMS1ydyApKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnggKyBib3JkZXJzWyAzIF0ud2lkdGggKyBib3JkZXJSYWRpdXNbIDMgXVsgMCBdLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5LCAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07ICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCArIGJvcmRlcnNbIDMgXS53aWR0aCwgYnkgXTsgCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIGJ4ICsgYm9yZGVyc1sgMyBdLndpZHRoLCBieSBdOyAKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJsaW5lIiwgYnggKyBidyAtIGJvcmRlcnNbIDIgXS53aWR0aCwgYnkgXTsgLy8gdG9wIHJpZ2h0CiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIGJ4ICsgYncsIGJ5ICsgYmggXTsgLy8gYm90dG9tIHJpZ2h0CiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIGJ4LCBieSArIGJoIF07IC8vIGJvdHRvbSBsZWZ0CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxlZnQgYm9yZGVyCiAgICAgICAgICAgICAgICAgICAgICAgIGJ3ID0gYm9yZGVyc1szXS53aWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCwgYnkgXTsgIC8vIHRvcCBsZWZ0CiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIGJ4ICsgYncsIGJ5ICsgYm9yZGVyc1sgMCBdLndpZHRoIF07IC8vIHRvcCByaWdodAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCArIGJ3LCBieSArIGJoIF07IC8vIGJvdHRvbSByaWdodAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCwgYnkgKyBiaCArIGJvcmRlcnNbIDIgXS53aWR0aCBdOyAvLyBib3R0b20gbGVmdAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYm9yZGVyQm91bmRzID0gewogICAgICAgICAgICAgICAgICAgIGxlZnQ6YngsCiAgICAgICAgICAgICAgICAgICAgdG9wOmJ5LAogICAgICAgICAgICAgICAgICAgIHdpZHRoOiBidywKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6YmgKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKGNsaXApewogICAgICAgICAgICAgICAgICAgIGJvcmRlckJvdW5kcyA9IGNsaXBCb3VuZHMoYm9yZGVyQm91bmRzLCBjbGlwKTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgaWYgKCBib3JkZXJCb3VuZHMud2lkdGggPiAwICYmIGJvcmRlckJvdW5kcy5oZWlnaHQgPiAwICkgewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICggYm9yZGVyRGF0YS5jb2xvciAhPT0gInRyYW5zcGFyZW50IiApewogICAgICAgICAgICAgICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoICJmaWxsU3R5bGUiLCBib3JkZXJEYXRhLmNvbG9yICk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2hhcGUgPSBjdHguZHJhd1NoYXBlKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG51bUJvcmRlckFyZ3MgPSBib3JkZXJBcmdzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIGkgPSAwOyBpIDwgbnVtQm9yZGVyQXJnczsgaSsrICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGVbKCBpID09PSAwKSA/ICJtb3ZlVG8iIDogYm9yZGVyQXJnc1sgaSBdWyAwIF0gKyAiVG8iIF0uYXBwbHkoIG51bGwsIGJvcmRlckFyZ3NbIGkgXS5zbGljZSgxKSApOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBudW1EcmF3cys9MTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gIHJlbmRlclJlY3QoY3R4LCBieCwgYnksIGJvcmRlckJvdW5kcy53aWR0aCwgYm9yZGVyQm91bmRzLmhlaWdodCwgYm9yZGVyRGF0YS5jb2xvcik7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGJvcmRlcnM7CgogICAgfQoKCiAgICBmdW5jdGlvbiByZW5kZXJGb3JtVmFsdWUgKGVsLCBib3VuZHMsIHN0YWNrKXsKCiAgICAgICAgdmFyIHZhbHVlV3JhcCA9IGRvYy5jcmVhdGVFbGVtZW50KCd2YWx1ZXdyYXAnKSwKICAgICAgICBjc3NBcnIgPSBbJ2xpbmVIZWlnaHQnLCd0ZXh0QWxpZ24nLCdmb250RmFtaWx5JywnY29sb3InLCdmb250U2l6ZScsJ3BhZGRpbmdMZWZ0JywncGFkZGluZ1RvcCcsJ3dpZHRoJywnaGVpZ2h0JywnYm9yZGVyJywnYm9yZGVyTGVmdFdpZHRoJywnYm9yZGVyVG9wV2lkdGgnXSwKICAgICAgICBpLAogICAgICAgIHRleHRWYWx1ZSwKICAgICAgICB0ZXh0Tm9kZSwKICAgICAgICBhcnJMZW4sCiAgICAgICAgc3R5bGU7CgogICAgICAgIGZvciAoaSA9IDAsIGFyckxlbiA9IGNzc0Fyci5sZW5ndGg7IGkgPCBhcnJMZW47IGkrPTEpewogICAgICAgICAgICBzdHlsZSA9IGNzc0FycltpXTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB2YWx1ZVdyYXAuc3R5bGVbc3R5bGVdID0gZ2V0Q1NTKGVsLCBzdHlsZSk7CiAgICAgICAgICAgIH0gY2F0Y2goIGUgKSB7CiAgICAgICAgICAgICAgICAvLyBPbGRlciBJRSBoYXMgaXNzdWVzIHdpdGggImJvcmRlciIKICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IFBhcnNlOiBFeGNlcHRpb24gY2F1Z2h0IGluIHJlbmRlckZvcm1WYWx1ZTogIiArIGUubWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKICAgICAgICB2YWx1ZVdyYXAuc3R5bGUuYm9yZGVyQ29sb3IgPSAiYmxhY2siOwogICAgICAgIHZhbHVlV3JhcC5zdHlsZS5ib3JkZXJTdHlsZSA9ICJzb2xpZCI7CiAgICAgICAgdmFsdWVXcmFwLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgIHZhbHVlV3JhcC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICAgICAgaWYgKC9eKHN1Ym1pdHxyZXNldHxidXR0b258dGV4dHxwYXNzd29yZCkkLy50ZXN0KGVsLnR5cGUpIHx8IGVsLm5vZGVOYW1lID09PSAiU0VMRUNUIil7CiAgICAgICAgICAgIHZhbHVlV3JhcC5zdHlsZS5saW5lSGVpZ2h0ID0gZ2V0Q1NTKGVsLCAiaGVpZ2h0Iik7CiAgICAgICAgfQoKCiAgICAgICAgdmFsdWVXcmFwLnN0eWxlLnRvcCA9IGJvdW5kcy50b3AgKyAicHgiOwogICAgICAgIHZhbHVlV3JhcC5zdHlsZS5sZWZ0ID0gYm91bmRzLmxlZnQgKyAicHgiOwoKICAgICAgICBpZiAoZWwubm9kZU5hbWUgPT09ICJTRUxFQ1QiKXsKICAgICAgICAgICAgLy8gVE9ETyBpbmNyZWFzZSBhY2N1cmFjeSBvZiB0ZXh0IHBvc2l0aW9uCiAgICAgICAgICAgIHRleHRWYWx1ZSA9IGVsLm9wdGlvbnNbZWwuc2VsZWN0ZWRJbmRleF0udGV4dDsKICAgICAgICB9IGVsc2V7CiAgICAgICAgICAgIHRleHRWYWx1ZSA9IGVsLnZhbHVlOwogICAgICAgIH0KICAgICAgICB0ZXh0Tm9kZSA9IGRvYy5jcmVhdGVUZXh0Tm9kZSh0ZXh0VmFsdWUpOwoKICAgICAgICB2YWx1ZVdyYXAuYXBwZW5kQ2hpbGQodGV4dE5vZGUpOwogICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQodmFsdWVXcmFwKTsKCgogICAgICAgIHJlbmRlclRleHQoZWwsIHRleHROb2RlLCBzdGFjayk7CiAgICAgICAgYm9keS5yZW1vdmVDaGlsZCh2YWx1ZVdyYXApOwoKCgogICAgfQoKCgoKCiAgICBmdW5jdGlvbiByZW5kZXJJbWFnZSAoY3R4LCBpbWFnZSwgc3gsIHN5LCBzdywgc2gsIGR4LCBkeSwgZHcsIGRoKSB7CiAgICAgICAgY3R4LmRyYXdJbWFnZSgKICAgICAgICAgICAgaW1hZ2UsCiAgICAgICAgICAgIHN4LCAvL3N4CiAgICAgICAgICAgIHN5LCAvL3N5CiAgICAgICAgICAgIHN3LCAvL3N3CiAgICAgICAgICAgIHNoLCAvL3NoCiAgICAgICAgICAgIGR4LCAvL2R4CiAgICAgICAgICAgIGR5LCAvLyBkeQogICAgICAgICAgICBkdywgLy9kdwogICAgICAgICAgICBkaCAvL2RoCiAgICAgICAgICAgICk7CiAgICAgICAgbnVtRHJhd3MrPTE7CgogICAgfQoKCiAgICBmdW5jdGlvbiByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0IChjdHgsIGltYWdlLCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBlbHgsIGVseSl7CiAgICAgICAgdmFyIHNvdXJjZVggPSAwLAogICAgICAgIHNvdXJjZVk9MDsKICAgICAgICBpZiAoZWx4LXg+MCl7CiAgICAgICAgICAgIHNvdXJjZVggPSBlbHgteDsKICAgICAgICB9CgogICAgICAgIGlmIChlbHkteT4wKXsKICAgICAgICAgICAgc291cmNlWSA9IGVseS15OwogICAgICAgIH0KCiAgICAgICAgcmVuZGVySW1hZ2UoCiAgICAgICAgICAgIGN0eCwKICAgICAgICAgICAgaW1hZ2UsCiAgICAgICAgICAgIHNvdXJjZVgsIC8vIHNvdXJjZSBYCiAgICAgICAgICAgIHNvdXJjZVksIC8vIHNvdXJjZSBZCiAgICAgICAgICAgIHdpZHRoLXNvdXJjZVgsIC8vIHNvdXJjZSBXaWR0aAogICAgICAgICAgICBoZWlnaHQtc291cmNlWSwgLy8gc291cmNlIEhlaWdodAogICAgICAgICAgICB4K3NvdXJjZVgsIC8vIGRlc3RpbmF0aW9uIFgKICAgICAgICAgICAgeStzb3VyY2VZLCAvLyBkZXN0aW5hdGlvbiBZCiAgICAgICAgICAgIHdpZHRoLXNvdXJjZVgsIC8vIGRlc3RpbmF0aW9uIHdpZHRoCiAgICAgICAgICAgIGhlaWdodC1zb3VyY2VZIC8vIGRlc3RpbmF0aW9uIGhlaWdodAogICAgICAgICAgICApOwogICAgfQoKCiAgICBmdW5jdGlvbiByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0WSAoY3R4LCBpbWFnZSwgYmdwLCB4LCB5LCB3LCBoKXsKCiAgICAgICAgdmFyIGhlaWdodCwKICAgICAgICB3aWR0aCA9IE1hdGgubWluKGltYWdlLndpZHRoLHcpLGJneTsKCiAgICAgICAgYmdwLnRvcCA9IGJncC50b3AtTWF0aC5jZWlsKGJncC50b3AvaW1hZ2UuaGVpZ2h0KSppbWFnZS5oZWlnaHQ7CgoKICAgICAgICBmb3IoYmd5PSh5K2JncC50b3ApO2JneTxoK3k7KXsKCgogICAgICAgICAgICBpZiAoIE1hdGguZmxvb3IoYmd5K2ltYWdlLmhlaWdodCk+aCt5KXsKICAgICAgICAgICAgICAgIGhlaWdodCA9IChoK3kpLWJneTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBoZWlnaHQgPSBpbWFnZS5oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdChjdHgsaW1hZ2UseCtiZ3AubGVmdCxiZ3ksd2lkdGgsaGVpZ2h0LHgseSk7CgogICAgICAgICAgICBiZ3kgPSBNYXRoLmZsb29yKGJneStpbWFnZS5oZWlnaHQpOwoKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZFJlcGVhdFgoY3R4LCBpbWFnZSwgYmdwLCB4LCB5LCB3LCBoKXsKCiAgICAgICAgdmFyIGhlaWdodCA9IE1hdGgubWluKGltYWdlLmhlaWdodCxoKSwKICAgICAgICB3aWR0aCxiZ3g7CgoKICAgICAgICBiZ3AubGVmdCA9IGJncC5sZWZ0LU1hdGguY2VpbChiZ3AubGVmdC9pbWFnZS53aWR0aCkqaW1hZ2Uud2lkdGg7CgoKICAgICAgICBmb3IgKGJneD0oeCtiZ3AubGVmdCk7Ymd4PHcreDspIHsKCiAgICAgICAgICAgIGlmIChNYXRoLmZsb29yKGJneCtpbWFnZS53aWR0aCk+dyt4KXsKICAgICAgICAgICAgICAgIHdpZHRoID0gKHcreCktYmd4OwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHdpZHRoID0gaW1hZ2Uud2lkdGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlbmRlckJhY2tncm91bmRSZXBlYXQoY3R4LGltYWdlLGJneCwoeStiZ3AudG9wKSx3aWR0aCxoZWlnaHQseCx5KTsKCiAgICAgICAgICAgIGJneCA9IE1hdGguZmxvb3IoYmd4K2ltYWdlLndpZHRoKTsKCgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiByZW5kZXJCYWNrZ3JvdW5kKGVsLGJvdW5kcyxjdHgpewoKICAgICAgICAvLyBUT0RPIGFkZCBzdXBwb3J0IGZvciBtdWx0aSBiYWNrZ3JvdW5kLWltYWdlcwogICAgICAgIHZhciBiYWNrZ3JvdW5kX2ltYWdlID0gZ2V0Q1NTKGVsLCAiYmFja2dyb3VuZEltYWdlIiksCiAgICAgICAgYmFja2dyb3VuZF9yZXBlYXQgPSBnZXRDU1MoZWwsICJiYWNrZ3JvdW5kUmVwZWF0Iikuc3BsaXQoIiwiKVswXSwKICAgICAgICBpbWFnZSwKICAgICAgICBiZ3AsCiAgICAgICAgYmd5LAogICAgICAgIGJndywKICAgICAgICBiZ3N4LAogICAgICAgIGJnc3ksCiAgICAgICAgYmdkeCwKICAgICAgICBiZ2R5LAogICAgICAgIGJnaCwKICAgICAgICBoLAogICAgICAgIGhlaWdodCwKICAgICAgICBhZGQ7CgogICAgICAgIC8vICAgaWYgKHR5cGVvZiBiYWNrZ3JvdW5kX2ltYWdlICE9PSAidW5kZWZpbmVkIiAmJiAvXigxfG5vbmUpJC8udGVzdChiYWNrZ3JvdW5kX2ltYWdlKSA9PT0gZmFsc2UgJiYgL14oLXdlYmtpdHwtbW96fGxpbmVhci1ncmFkaWVudHwtby0pLy50ZXN0KGJhY2tncm91bmRfaW1hZ2UpPT09ZmFsc2UpewoKICAgICAgICBpZiAoICEvZGF0YTppbWFnZVwvLio7YmFzZTY0LC9pLnRlc3QoYmFja2dyb3VuZF9pbWFnZSkgJiYgIS9eKC13ZWJraXR8LW1venxsaW5lYXItZ3JhZGllbnR8LW8tKS8udGVzdChiYWNrZ3JvdW5kX2ltYWdlKSApIHsKICAgICAgICAgICAgYmFja2dyb3VuZF9pbWFnZSA9IGJhY2tncm91bmRfaW1hZ2Uuc3BsaXQoIiwiKVswXTsKICAgICAgICB9CgogICAgICAgIGlmICggdHlwZW9mIGJhY2tncm91bmRfaW1hZ2UgIT09ICJ1bmRlZmluZWQiICYmIC9eKDF8bm9uZSkkLy50ZXN0KCBiYWNrZ3JvdW5kX2ltYWdlICkgPT09IGZhbHNlICkgewogICAgICAgICAgICBiYWNrZ3JvdW5kX2ltYWdlID0gX2h0bWwyY2FudmFzLlV0aWwuYmFja2dyb3VuZEltYWdlKCBiYWNrZ3JvdW5kX2ltYWdlICk7CiAgICAgICAgICAgIGltYWdlID0gbG9hZEltYWdlKCBiYWNrZ3JvdW5kX2ltYWdlICk7CgoKICAgICAgICAgICAgYmdwID0gX2h0bWwyY2FudmFzLlV0aWwuQmFja2dyb3VuZFBvc2l0aW9uKGVsLCBib3VuZHMsIGltYWdlKTsKCiAgICAgICAgICAgIC8vIFRPRE8gYWRkIHN1cHBvcnQgZm9yIGJhY2tncm91bmQtb3JpZ2luCiAgICAgICAgICAgIGlmICggaW1hZ2UgKXsKICAgICAgICAgICAgICAgIHN3aXRjaCAoIGJhY2tncm91bmRfcmVwZWF0ICkgewoKICAgICAgICAgICAgICAgICAgICBjYXNlICJyZXBlYXQteCI6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckJhY2tncm91bmRSZXBlYXRYKCBjdHgsIGltYWdlLCBiZ3AsIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQgKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNhc2UgInJlcGVhdC15IjoKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdFkoIGN0eCwgaW1hZ2UsIGJncCwgYm91bmRzLmxlZnQsIGJvdW5kcy50b3AsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCApOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgY2FzZSAibm8tcmVwZWF0IjoKICAgICAgICAgICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyYXdCYWNrZ3JvdW5kUmVwZWF0KAogICAgICAgICAgICAgICAgICAgICAgICBjdHgsCiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLAogICAgICAgICAgICAgICAgICAgICAgICBiZ3AubGVmdCtib3VuZHMubGVmdCwgLy8gc3gKICAgICAgICAgICAgICAgICAgICAgICAgYmdwLnRvcCtib3VuZHMudG9wLCAvLyBzeQogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLm1pbihib3VuZHMud2lkdGgsaW1hZ2Uud2lkdGgpLAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLm1pbihib3VuZHMuaGVpZ2h0LGltYWdlLmhlaWdodCksCiAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcy5sZWZ0LAogICAgICAgICAgICAgICAgICAgICAgICBib3VuZHMudG9wCiAgICAgICAgICAgICAgICAgICAgICAgICk7Ki8KCgogICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBiZ3cgPSBib3VuZHMud2lkdGggLSBiZ3AubGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgYmdoID0gYm91bmRzLmhlaWdodCAtIGJncC50b3A7CiAgICAgICAgICAgICAgICAgICAgICAgIGJnc3ggPSBiZ3AubGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgYmdzeSA9IGJncC50b3A7CiAgICAgICAgICAgICAgICAgICAgICAgIGJnZHggPSBiZ3AubGVmdCtib3VuZHMubGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgYmdkeSA9IGJncC50b3ArYm91bmRzLnRvcDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICBiZ3cgPSBNYXRoLm1pbihiZ3csaW1hZ2Uud2lkdGgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyAgYmdoID0gTWF0aC5taW4oYmdoLGltYWdlLmhlaWdodCk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmdzeDwwKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnc3ggPSBNYXRoLmFicyhiZ3N4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnZHggKz0gYmdzeDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJndyA9IE1hdGgubWluKGJvdW5kcy53aWR0aCxpbWFnZS53aWR0aC1iZ3N4KTsKICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3cgPSBNYXRoLm1pbihiZ3csaW1hZ2Uud2lkdGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdzeCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZ3N5PDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdzeSA9IE1hdGguYWJzKGJnc3kpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdkeSArPSBiZ3N5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmdoID0gYmdoLWJnc3k7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ2ggPSBNYXRoLm1pbihib3VuZHMuaGVpZ2h0LGltYWdlLmhlaWdodC1iZ3N5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ2ggPSBNYXRoLm1pbihiZ2gsaW1hZ2UuaGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnc3kgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJnaD4wICYmIGJndyA+IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVySW1hZ2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnc3gsIC8vIHNvdXJjZSBYIDogMAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnc3ksIC8vIHNvdXJjZSBZIDogMTY5NQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJndywgLy8gc291cmNlIFdpZHRoIDogMTgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ2gsIC8vIHNvdXJjZSBIZWlnaHQgOiAxNjc3CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdkeCwgLy8gZGVzdGluYXRpb24gWCA6OTA2CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdkeSwgLy8gZGVzdGluYXRpb24gWSA6IDEwMjAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3csIC8vIGRlc3RpbmF0aW9uIHdpZHRoIDogMTgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ2ggLy8gZGVzdGluYXRpb24gaGVpZ2h0IDogMTY3NwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgoKCiAgICAgICAgICAgICAgICAgICAgICAgIGJncC50b3AgPSBiZ3AudG9wLU1hdGguY2VpbChiZ3AudG9wL2ltYWdlLmhlaWdodCkqaW1hZ2UuaGVpZ2h0OwoKCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihiZ3k9KGJvdW5kcy50b3ArYmdwLnRvcCk7Ymd5PGJvdW5kcy5oZWlnaHQrYm91bmRzLnRvcDspewoKCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaCA9IE1hdGgubWluKGltYWdlLmhlaWdodCwoYm91bmRzLmhlaWdodCtib3VuZHMudG9wKS1iZ3kpOwoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIE1hdGguZmxvb3IoYmd5K2ltYWdlLmhlaWdodCk+aCtiZ3kpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodCA9IChoK2JneSktYmd5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coaGVpZ2h0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmd5PGJvdW5kcy50b3ApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZCA9IGJvdW5kcy50b3AtYmd5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJneSA9IGJvdW5kcy50b3A7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0WChjdHgsaW1hZ2UsYmdwLGJvdW5kcy5sZWZ0LGJneSxib3VuZHMud2lkdGgsaGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhZGQ+MCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdwLnRvcCArPSBhZGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3kgPSBNYXRoLmZsb29yKGJneStpbWFnZS5oZWlnaHQpLWFkZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IEVycm9yIGxvYWRpbmcgYmFja2dyb3VuZDoiICsgYmFja2dyb3VuZF9pbWFnZSk7CiAgICAgICAgICAgIC8vY29uc29sZS5sb2coaW1hZ2VzKTsKICAgICAgICAgICAgfQoKICAgICAgICB9CiAgICB9CgoKCiAgICBmdW5jdGlvbiByZW5kZXJFbGVtZW50KGVsLCBwYXJlbnRTdGFjayl7CgogICAgICAgIHZhciBib3VuZHMgPSBfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMoZWwpLAogICAgICAgIHggPSBib3VuZHMubGVmdCwKICAgICAgICB5ID0gYm91bmRzLnRvcCwKICAgICAgICB3ID0gYm91bmRzLndpZHRoLAogICAgICAgIGggPSBib3VuZHMuaGVpZ2h0LAogICAgICAgIGltYWdlLAogICAgICAgIGJnY29sb3IgPSBnZXRDU1MoZWwsICJiYWNrZ3JvdW5kQ29sb3IiKSwKICAgICAgICBjc3NQb3NpdGlvbiA9IGdldENTUyhlbCwgInBvc2l0aW9uIiksCiAgICAgICAgemluZGV4LAogICAgICAgIG9wYWNpdHkgPSBnZXRDU1MoZWwsICJvcGFjaXR5IiksCiAgICAgICAgc3RhY2ssCiAgICAgICAgc3RhY2tMZW5ndGgsCiAgICAgICAgYm9yZGVycywKICAgICAgICBjdHgsCiAgICAgICAgYmdib3VuZHMsCiAgICAgICAgaW1nU3JjLAogICAgICAgIHBhZGRpbmdMZWZ0LAogICAgICAgIHBhZGRpbmdUb3AsCiAgICAgICAgcGFkZGluZ1JpZ2h0LAogICAgICAgIHBhZGRpbmdCb3R0b207CgogICAgICAgIGlmICghcGFyZW50U3RhY2spewogICAgICAgICAgICBkb2NEaW0gPSBkb2NTaXplKCk7CiAgICAgICAgICAgIHBhcmVudFN0YWNrID0gewogICAgICAgICAgICAgICAgb3BhY2l0eTogMQogICAgICAgICAgICB9OwogICAgICAgIH1lbHNlewogICAgICAgICAgICBkb2NEaW0gPSB7fTsKICAgICAgICB9CgoKICAgICAgICAvL3ZhciB6aW5kZXggPSB0aGlzLmZvcm1hdFoodGhpcy5nZXRDU1MoZWwsInpJbmRleCIpLGNzc1Bvc2l0aW9uLHBhcmVudFN0YWNrLnpJbmRleCxlbC5wYXJlbnROb2RlKTsKCiAgICAgICAgemluZGV4ID0gc2V0WiggZ2V0Q1NTKCBlbCwgInpJbmRleCIpLCBwYXJlbnRTdGFjay56SW5kZXggKTsKCgoKICAgICAgICBzdGFjayA9IHsKICAgICAgICAgICAgY3R4OiBoMmNSZW5kZXJDb250ZXh0KCBkb2NEaW0ud2lkdGggfHwgdyAsIGRvY0RpbS5oZWlnaHQgfHwgaCApLAogICAgICAgICAgICB6SW5kZXg6IHppbmRleCwKICAgICAgICAgICAgb3BhY2l0eTogb3BhY2l0eSAqIHBhcmVudFN0YWNrLm9wYWNpdHksCiAgICAgICAgICAgIGNzc1Bvc2l0aW9uOiBjc3NQb3NpdGlvbgogICAgICAgIH07CgoKCiAgICAgICAgLy8gVE9ETyBjb3JyZWN0IG92ZXJmbG93IGZvciBhYnNvbHV0ZSBjb250ZW50IHJlc2lkaW5nIHVuZGVyIGEgc3RhdGljIHBvc2l0aW9uCgogICAgICAgIGlmIChwYXJlbnRTdGFjay5jbGlwKXsKICAgICAgICAgICAgc3RhY2suY2xpcCA9IF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZCgge30sIHBhcmVudFN0YWNrLmNsaXAgKTsKICAgICAgICAvL3N0YWNrLmNsaXAgPSBwYXJlbnRTdGFjay5jbGlwOwogICAgICAgIC8vICAgc3RhY2suY2xpcC5oZWlnaHQgPSBzdGFjay5jbGlwLmhlaWdodCAtIHBhcmVudFN0YWNrLmJvcmRlcnNbMl0ud2lkdGg7CiAgICAgICAgfQoKCiAgICAgICAgaWYgKCBvcHRpb25zLnVzZU92ZXJmbG93ID09PSB0cnVlICYmIC8oaGlkZGVufHNjcm9sbHxhdXRvKS8udGVzdChnZXRDU1MoZWwsICJvdmVyZmxvdyIpKSA9PT0gdHJ1ZSAmJiAvKEJPRFkpL2kudGVzdChlbC5ub2RlTmFtZSkgPT09IGZhbHNlICl7CiAgICAgICAgICAgIGlmIChzdGFjay5jbGlwKXsKICAgICAgICAgICAgICAgIHN0YWNrLmNsaXAgPSBjbGlwQm91bmRzKHN0YWNrLmNsaXAsIGJvdW5kcyk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgc3RhY2suY2xpcCA9IGJvdW5kczsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIHN0YWNrTGVuZ3RoID0gIHppbmRleC5jaGlsZHJlbi5wdXNoKHN0YWNrKTsKCiAgICAgICAgY3R4ID0gemluZGV4LmNoaWxkcmVuW3N0YWNrTGVuZ3RoLTFdLmN0eDsKCiAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJnbG9iYWxBbHBoYSIsIHN0YWNrLm9wYWNpdHkpOwoKICAgICAgICAvLyBkcmF3IGVsZW1lbnQgYm9yZGVycwogICAgICAgIGJvcmRlcnMgPSByZW5kZXJCb3JkZXJzKGVsLCBjdHgsIGJvdW5kcywgZmFsc2UpOwogICAgICAgIHN0YWNrLmJvcmRlcnMgPSBib3JkZXJzOwoKCiAgICAgICAgLy8gbGV0J3MgbW9kaWZ5IGNsaXAgYXJlYSBmb3IgY2hpbGQgZWxlbWVudHMsIHNvIGJvcmRlcnMgZG9udCBnZXQgb3ZlcndyaXR0ZW4KCiAgICAgICAgLyoKICAgIGlmIChzdGFjay5jbGlwKXsKICAgICAgICBzdGFjay5jbGlwLndpZHRoID0gc3RhY2suY2xpcC53aWR0aC0oYm9yZGVyc1sxXS53aWR0aCk7CiAgICAgICAgc3RhY2suY2xpcC5oZWlnaHQgPSBzdGFjay5jbGlwLmhlaWdodC0oYm9yZGVyc1syXS53aWR0aCk7CiAgICB9CiAgICAgKi8KICAgICAgICBpZiAoaWdub3JlRWxlbWVudHNSZWdFeHAudGVzdChlbC5ub2RlTmFtZSkgJiYgb3B0aW9ucy5pZnJhbWVEZWZhdWx0ICE9PSAidHJhbnNwYXJlbnQiKXsKICAgICAgICAgICAgaWYgKG9wdGlvbnMuaWZyYW1lRGVmYXVsdCA9PT0gImRlZmF1bHQiKXsKICAgICAgICAgICAgICAgIGJnY29sb3IgPSAiI2VmZWZlZiI7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgYmdjb2xvciA9IG9wdGlvbnMuaWZyYW1lRGVmYXVsdDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gZHJhdyBiYXNlIGVsZW1lbnQgYmdjb2xvcgoKICAgICAgICBiZ2JvdW5kcyA9IHsKICAgICAgICAgICAgbGVmdDogeCArIGJvcmRlcnNbM10ud2lkdGgsCiAgICAgICAgICAgIHRvcDogeSArIGJvcmRlcnNbMF0ud2lkdGgsCiAgICAgICAgICAgIHdpZHRoOiB3IC0gKGJvcmRlcnNbMV0ud2lkdGggKyBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgICAgICAgaGVpZ2h0OiBoIC0gKGJvcmRlcnNbMF0ud2lkdGggKyBib3JkZXJzWzJdLndpZHRoKQogICAgICAgIH07CgogICAgICAgIC8vaWYgKHRoaXMud2l0aGluQm91bmRzKHN0YWNrLmNsaXAsYmdib3VuZHMpKXsKCiAgICAgICAgaWYgKHN0YWNrLmNsaXApewogICAgICAgICAgICBiZ2JvdW5kcyA9IGNsaXBCb3VuZHMoYmdib3VuZHMsIHN0YWNrLmNsaXApOwoKICAgICAgICAvL30KCiAgICAgICAgfQoKCiAgICAgICAgaWYgKGJnYm91bmRzLmhlaWdodCA+IDAgJiYgYmdib3VuZHMud2lkdGggPiAwKXsKICAgICAgICAgICAgcmVuZGVyUmVjdCgKICAgICAgICAgICAgICAgIGN0eCwKICAgICAgICAgICAgICAgIGJnYm91bmRzLmxlZnQsCiAgICAgICAgICAgICAgICBiZ2JvdW5kcy50b3AsCiAgICAgICAgICAgICAgICBiZ2JvdW5kcy53aWR0aCwKICAgICAgICAgICAgICAgIGJnYm91bmRzLmhlaWdodCwKICAgICAgICAgICAgICAgIGJnY29sb3IKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICByZW5kZXJCYWNrZ3JvdW5kKGVsLCBiZ2JvdW5kcywgY3R4KTsKICAgICAgICB9CgogICAgICAgIHN3aXRjaChlbC5ub2RlTmFtZSl7CiAgICAgICAgICAgIGNhc2UgIklNRyI6CiAgICAgICAgICAgICAgICBpbWdTcmMgPSBlbC5nZXRBdHRyaWJ1dGUoJ3NyYycpOwogICAgICAgICAgICAgICAgaW1hZ2UgPSBsb2FkSW1hZ2UoaW1nU3JjKTsKICAgICAgICAgICAgICAgIGlmIChpbWFnZSl7CgogICAgICAgICAgICAgICAgICAgIHBhZGRpbmdMZWZ0ID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ0xlZnQnKTsKICAgICAgICAgICAgICAgICAgICBwYWRkaW5nVG9wID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ1RvcCcpOwogICAgICAgICAgICAgICAgICAgIHBhZGRpbmdSaWdodCA9IGdldENTU0ludChlbCwgJ3BhZGRpbmdSaWdodCcpOwogICAgICAgICAgICAgICAgICAgIHBhZGRpbmdCb3R0b20gPSBnZXRDU1NJbnQoZWwsICdwYWRkaW5nQm90dG9tJyk7CgoKICAgICAgICAgICAgICAgICAgICByZW5kZXJJbWFnZSgKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LAogICAgICAgICAgICAgICAgICAgICAgICBpbWFnZSwKICAgICAgICAgICAgICAgICAgICAgICAgMCwgLy9zeAogICAgICAgICAgICAgICAgICAgICAgICAwLCAvL3N5CiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLndpZHRoLCAvL3N3CiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLmhlaWdodCwgLy9zaAogICAgICAgICAgICAgICAgICAgICAgICB4ICsgcGFkZGluZ0xlZnQgKyBib3JkZXJzWzNdLndpZHRoLCAvL2R4CiAgICAgICAgICAgICAgICAgICAgICAgIHkgKyBwYWRkaW5nVG9wICsgYm9yZGVyc1swXS53aWR0aCwgLy8gZHkKICAgICAgICAgICAgICAgICAgICAgICAgYm91bmRzLndpZHRoIC0gKGJvcmRlcnNbMV0ud2lkdGggKyBib3JkZXJzWzNdLndpZHRoICsgcGFkZGluZ0xlZnQgKyBwYWRkaW5nUmlnaHQpLCAvL2R3CiAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcy5oZWlnaHQgLSAoYm9yZGVyc1swXS53aWR0aCArIGJvcmRlcnNbMl0ud2lkdGggKyBwYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbSkgLy9kaAogICAgICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IEVycm9yIGxvYWRpbmcgPGltZz46IiArIGltZ1NyYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiSU5QVVQiOgogICAgICAgICAgICAgICAgLy8gVE9ETyBhZGQgYWxsIHJlbGV2YW50IHR5cGUncywgaS5lLiBIVE1MNSBuZXcgc3R1ZmYKICAgICAgICAgICAgICAgIC8vIHRvZG8gYWRkIHN1cHBvcnQgZm9yIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBmb3IgYnJvd3NlcnMgd2hpY2ggc3VwcG9ydCBpdAogICAgICAgICAgICAgICAgaWYgKC9eKHRleHR8dXJsfGVtYWlsfHN1Ym1pdHxidXR0b258cmVzZXQpJC8udGVzdChlbC50eXBlKSAmJiBlbC52YWx1ZS5sZW5ndGggPiAwKXsKCiAgICAgICAgICAgICAgICAgICAgcmVuZGVyRm9ybVZhbHVlKGVsLCBib3VuZHMsIHN0YWNrKTsKCgogICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICB0aGlzIGp1c3QgZG9lc24ndCB3b3JrIHdlbGwgZW5vdWdoCgogICAgICAgICAgICAgICAgdGhpcy5uZXdUZXh0KGVsLHsKICAgICAgICAgICAgICAgICAgICBub2RlVmFsdWU6ZWwudmFsdWUsCiAgICAgICAgICAgICAgICAgICAgc3BsaXRUZXh0OiBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGZvcm1WYWx1ZTp0cnVlCiAgICAgICAgICAgICAgICB9LHN0YWNrKTsKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIlRFWFRBUkVBIjoKICAgICAgICAgICAgICAgIGlmIChlbC52YWx1ZS5sZW5ndGggPiAwKXsKICAgICAgICAgICAgICAgICAgICByZW5kZXJGb3JtVmFsdWUoZWwsIGJvdW5kcywgc3RhY2spOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIlNFTEVDVCI6CiAgICAgICAgICAgICAgICBpZiAoZWwub3B0aW9ucy5sZW5ndGggPiAwKXsKICAgICAgICAgICAgICAgICAgICByZW5kZXJGb3JtVmFsdWUoZWwsIGJvdW5kcywgc3RhY2spOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIkxJIjoKICAgICAgICAgICAgICAgIHJlbmRlckxpc3RJdGVtKGVsLCBzdGFjaywgYmdib3VuZHMpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIkNBTlZBUyI6CiAgICAgICAgICAgICAgICBwYWRkaW5nTGVmdCA9IGdldENTU0ludChlbCwgJ3BhZGRpbmdMZWZ0Jyk7CiAgICAgICAgICAgICAgICBwYWRkaW5nVG9wID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ1RvcCcpOwogICAgICAgICAgICAgICAgcGFkZGluZ1JpZ2h0ID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ1JpZ2h0Jyk7CiAgICAgICAgICAgICAgICBwYWRkaW5nQm90dG9tID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ0JvdHRvbScpOwogICAgICAgICAgICAgICAgcmVuZGVySW1hZ2UoCiAgICAgICAgICAgICAgICAgICAgY3R4LAogICAgICAgICAgICAgICAgICAgIGVsLAogICAgICAgICAgICAgICAgICAgIDAsIC8vc3gKICAgICAgICAgICAgICAgICAgICAwLCAvL3N5CiAgICAgICAgICAgICAgICAgICAgZWwud2lkdGgsIC8vc3cKICAgICAgICAgICAgICAgICAgICBlbC5oZWlnaHQsIC8vc2gKICAgICAgICAgICAgICAgICAgICB4ICsgcGFkZGluZ0xlZnQgKyBib3JkZXJzWzNdLndpZHRoLCAvL2R4CiAgICAgICAgICAgICAgICAgICAgeSArIHBhZGRpbmdUb3AgKyBib3JkZXJzWzBdLndpZHRoLCAvLyBkeQogICAgICAgICAgICAgICAgICAgIGJvdW5kcy53aWR0aCAtIChib3JkZXJzWzFdLndpZHRoICsgYm9yZGVyc1szXS53aWR0aCArIHBhZGRpbmdMZWZ0ICsgcGFkZGluZ1JpZ2h0KSwgLy9kdwogICAgICAgICAgICAgICAgICAgIGJvdW5kcy5oZWlnaHQgLSAoYm9yZGVyc1swXS53aWR0aCArIGJvcmRlcnNbMl0ud2lkdGggKyBwYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbSkgLy9kaAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIHJldHVybiB6aW5kZXguY2hpbGRyZW5bc3RhY2tMZW5ndGggLSAxXTsKICAgIH0KCgoKICAgIGZ1bmN0aW9uIHBhcnNlRWxlbWVudCAoZWwsIHN0YWNrKSB7CgogICAgICAgIC8vIHNraXAgaGlkZGVuIGVsZW1lbnRzIGFuZCB0aGVpciBjaGlsZHJlbgogICAgICAgIGlmIChnZXRDU1MoZWwsICdkaXNwbGF5JykgIT09ICJub25lIiAmJiBnZXRDU1MoZWwsICd2aXNpYmlsaXR5JykgIT09ICJoaWRkZW4iICYmICFlbC5oYXNBdHRyaWJ1dGUoImRhdGEtaHRtbDJjYW52YXMtaWdub3JlIikgKSB7CgogICAgICAgICAgICBzdGFjayA9IHJlbmRlckVsZW1lbnQoZWwsIHN0YWNrKSB8fCBzdGFjazsKCiAgICAgICAgICAgIGN0eCA9IHN0YWNrLmN0eDsKCiAgICAgICAgICAgIGlmICggIWlnbm9yZUVsZW1lbnRzUmVnRXhwLnRlc3QoIGVsLm5vZGVOYW1lICkgKSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudENoaWxkcmVuID0gX2h0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4oIGVsICksCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICAgIGNoaWxkcmVuTGVuOwogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgY2hpbGRyZW5MZW4gPSBlbGVtZW50Q2hpbGRyZW4ubGVuZ3RoOyBpIDwgY2hpbGRyZW5MZW47IGkrPTEpIHsKICAgICAgICAgICAgICAgICAgICBub2RlID0gZWxlbWVudENoaWxkcmVuW2ldOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlRWxlbWVudChub2RlLCBzdGFjayk7CiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYgKCBub2RlLm5vZGVUeXBlID09PSAzICkgewogICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJUZXh0KGVsLCBub2RlLCBzdGFjayk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0KICAgICAgICB9IAogICAgfQoKICAgIHN0YWNrID0gcmVuZGVyRWxlbWVudChlbGVtZW50LCBudWxsKTsKCiAgICAvKgogICAgU1ZHIHBvd2VyZWQgSFRNTCByZW5kZXJpbmcsIG5vbi10YWludGVkIGNhbnZhcyBhdmFpbGFibGUgZnJvbSBGRiAxMSsgb253YXJkcwogKi8KCiAgICBpZiAoIHN1cHBvcnQuc3ZnUmVuZGVyaW5nICkgewogICAgICAgIChmdW5jdGlvbiggYm9keSApewogICAgICAgICAgICB2YXIgaW1nID0gbmV3IEltYWdlKCksCiAgICAgICAgICAgIHNpemUgPSAgZG9jU2l6ZSgpLAogICAgICAgICAgICBodG1sID0gIiI7CgogICAgICAgICAgICBmdW5jdGlvbiBwYXJzZURPTSggZWwgKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBfaHRtbDJjYW52YXMuVXRpbC5DaGlsZHJlbiggZWwgKSwKICAgICAgICAgICAgICAgIGxlbiA9IGNoaWxkcmVuLmxlbmd0aCwKICAgICAgICAgICAgICAgIGF0dHIsCiAgICAgICAgICAgICAgICBhLAogICAgICAgICAgICAgICAgYWxlbiwKICAgICAgICAgICAgICAgIGVsbSwKICAgICAgICAgICAgICAgIGk7CiAgICAgICAgICAgICAgICBmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSs9MSApIHsKICAgICAgICAgICAgICAgICAgICBlbG0gPSBjaGlsZHJlblsgaSBdOwogICAgICAgICAgICAgICAgICAgIGlmICggZWxtLm5vZGVUeXBlID09PSAzICkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBUZXh0IG5vZGUKCiAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgKz0gZWxtLm5vZGVWYWx1ZS5yZXBsYWNlKC9cPC9nLCImbHQ7IikucmVwbGFjZSgvXD4vZywiJmd0OyIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIGVsbS5ub2RlVHlwZSA9PT0gMSApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoICEvXihzY3JpcHR8bWV0YXx0aXRsZSkkLy50ZXN0KGVsbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKSApIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sICs9ICI8IiArIGVsbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFkZCBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIGVsbS5oYXNBdHRyaWJ1dGVzKCkgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ciA9IGVsbS5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsZW4gPSBhdHRyLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKCBhID0gMDsgYSA8IGFsZW47IGErPTEgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgKz0gIiAiICsgYXR0clsgYSBdLm5hbWUgKyAnPSInICsgYXR0clsgYSBdLnZhbHVlICsgJyInOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCArPSAnPic7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VET00oIGVsbSApOwoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sICs9ICI8LyIgKyBlbG0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSArICI+IjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CgogICAgICAgICAgICBwYXJzZURPTSggYm9keSApOwogICAgICAgICAgICBpbWcuc3JjID0gWwogICAgICAgICAgICAiZGF0YTppbWFnZS9zdmcreG1sLCIsCiAgICAgICAgICAgICI8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZycgdmVyc2lvbj0nMS4xJyB3aWR0aD0nIiArIHNpemUud2lkdGggKyAiJyBoZWlnaHQ9JyIgKyBzaXplLmhlaWdodCArICInPiIsCiAgICAgICAgICAgICI8Zm9yZWlnbk9iamVjdCB3aWR0aD0nIiArIHNpemUud2lkdGggKyAiJyBoZWlnaHQ9JyIgKyBzaXplLmhlaWdodCArICInPiIsCiAgICAgICAgICAgICI8aHRtbCB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCcgc3R5bGU9J21hcmdpbjowOyc+IiwKICAgICAgICAgICAgaHRtbC5yZXBsYWNlKC9cIy9nLCIlMjMiKSwKICAgICAgICAgICAgIjwvaHRtbD4iLAogICAgICAgICAgICAiPC9mb3JlaWduT2JqZWN0PiIsCiAgICAgICAgICAgICI8L3N2Zz4iCiAgICAgICAgICAgIF0uam9pbigiIik7CgoKCgogICAgICAgICAgICBpbWcub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzdGFjay5zdmdSZW5kZXIgPSBpbWc7CiAgICAgICAgICAgIH07CgogICAgICAgIH0pKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgKTsKCiAgICB9CgoKICAgIC8vIHBhcnNlIGV2ZXJ5IGNoaWxkIGVsZW1lbnQKICAgIGZvciAoaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZHJlbiwgY2hpbGRyZW5MZW4gPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBjaGlsZHJlbkxlbjsgaSs9MSl7CiAgICAgICAgcGFyc2VFbGVtZW50KGNoaWxkcmVuW2ldLCBzdGFjayk7CiAgICB9CgoKICAgIHN0YWNrLmJhY2tncm91bmRDb2xvciA9IGdldENTUyggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCAiYmFja2dyb3VuZENvbG9yIiApOwoKICAgIHJldHVybiBzdGFjazsKCn07CgpmdW5jdGlvbiBoMmN6Q29udGV4dCh6aW5kZXgpIHsKICAgIHJldHVybiB7CiAgICAgICAgemluZGV4OiB6aW5kZXgsCiAgICAgICAgY2hpbGRyZW46IFtdCiAgICB9Owp9CgovKgogIGh0bWwyY2FudmFzIHYwLjM0IDxodHRwOi8vaHRtbDJjYW52YXMuaGVydHplbi5jb20+CiAgQ29weXJpZ2h0IChjKSAyMDExIE5pa2xhcyB2b24gSGVydHplbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICBodHRwOi8vd3d3LnR3aXR0ZXIuY29tL25pa2xhc3ZoCgogIFJlbGVhc2VkIHVuZGVyIE1JVCBMaWNlbnNlCiAqLwoKX2h0bWwyY2FudmFzLlByZWxvYWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCiAgICB2YXIgaW1hZ2VzID0gewogICAgICAgIG51bUxvYWRlZDogMCwgICAvLyBhbHNvIGZhaWxlZCBhcmUgY291bnRlZCBoZXJlCiAgICAgICAgbnVtRmFpbGVkOiAwLAogICAgICAgIG51bVRvdGFsOiAwLAogICAgICAgIGNsZWFudXBEb25lOiBmYWxzZQogICAgfSwKICAgIHBhZ2VPcmlnaW4sCiAgICBtZXRob2RzLAogICAgaSwKICAgIGNvdW50ID0gMCwKICAgIGVsZW1lbnQgPSBvcHRpb25zLmVsZW1lbnRzWzBdIHx8IGRvY3VtZW50LmJvZHksCiAgICBkb2MgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQsCiAgICBkb21JbWFnZXMgPSBkb2MuaW1hZ2VzLCAvLyBUT0RPIHByb2JhYmx5IHNob3VsZCBsaW1pdCBpdCB0byBpbWFnZXMgcHJlc2VudCBpbiB0aGUgZWxlbWVudCBvbmx5CiAgICBpbWdMZW4gPSBkb21JbWFnZXMubGVuZ3RoLAogICAgbGluayA9IGRvYy5jcmVhdGVFbGVtZW50KCJhIiksCiAgICBzdXBwb3J0Q09SUyA9IChmdW5jdGlvbiggaW1nICl7CiAgICAgICAgcmV0dXJuIChpbWcuY3Jvc3NPcmlnaW4gIT09IHVuZGVmaW5lZCk7CiAgICB9KShuZXcgSW1hZ2UoKSksCiAgICB0aW1lb3V0VGltZXI7CgogICAgbGluay5ocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICBwYWdlT3JpZ2luICA9IGxpbmsucHJvdG9jb2wgKyBsaW5rLmhvc3Q7CgoKCgoKCiAgICBmdW5jdGlvbiBpc1NhbWVPcmlnaW4odXJsKXsKICAgICAgICBsaW5rLmhyZWYgPSB1cmw7CiAgICAgICAgbGluay5ocmVmID0gbGluay5ocmVmOyAvLyBZRVMsIEJFTElFVkUgSVQgT1IgTk9ULCB0aGF0IGlzIHJlcXVpcmVkIGZvciBJRTkgLSBodHRwOi8vanNmaWRkbGUubmV0L25pa2xhc3ZoLzJlNDhiLwogICAgICAgIHZhciBvcmlnaW4gPSBsaW5rLnByb3RvY29sICsgbGluay5ob3N0OwogICAgICAgIHJldHVybiAob3JpZ2luID09PSBwYWdlT3JpZ2luKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzdGFydCgpewogICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IHN0YXJ0OiBpbWFnZXM6ICIgKyBpbWFnZXMubnVtTG9hZGVkICsgIiAvICIgKyBpbWFnZXMubnVtVG90YWwgKyAiIChmYWlsZWQ6ICIgKyBpbWFnZXMubnVtRmFpbGVkICsgIikiKTsKICAgICAgICBpZiAoIWltYWdlcy5maXJzdFJ1biAmJiBpbWFnZXMubnVtTG9hZGVkID49IGltYWdlcy5udW1Ub3RhbCl7CiAgICAgICAgICAgIGgyY2xvZygiRmluaXNoZWQgbG9hZGluZyBpbWFnZXM6ICMgIiArIGltYWdlcy5udW1Ub3RhbCArICIgKGZhaWxlZDogIiArIGltYWdlcy5udW1GYWlsZWQgKyAiKSIpOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmNvbXBsZXRlID09PSAiZnVuY3Rpb24iKXsKICAgICAgICAgICAgICAgIG9wdGlvbnMuY29tcGxldGUoaW1hZ2VzKTsKICAgICAgICAgICAgfQoKICAgICAgICB9CiAgICB9CgogICAgLy8gVE9ETyBtb2RpZnkgcHJveHkgdG8gc2VydmUgaW1hZ2VzIHdpdGggQ09SUyBlbmFibGVkLCB3aGVyZSBhdmFpbGFibGUKICAgIGZ1bmN0aW9uIHByb3h5R2V0SW1hZ2UodXJsLCBpbWcsIGltYWdlT2JqKXsKICAgICAgICB2YXIgY2FsbGJhY2tfbmFtZSwKICAgICAgICBzY3JpcHRVcmwgPSBvcHRpb25zLnByb3h5LAogICAgICAgIHNjcmlwdDsKCiAgICAgICAgbGluay5ocmVmID0gdXJsOwogICAgICAgIHVybCA9IGxpbmsuaHJlZjsgLy8gd29yayBhcm91bmQgZm9yIHBhZ2VzIHdpdGggYmFzZSBocmVmPSIiIHNldCAtIFdBUk5JTkc6IHRoaXMgbWF5IGNoYW5nZSB0aGUgdXJsCgogICAgICAgIGNhbGxiYWNrX25hbWUgPSAnaHRtbDJjYW52YXNfJyArIChjb3VudCsrKTsKICAgICAgICBpbWFnZU9iai5jYWxsYmFja25hbWUgPSBjYWxsYmFja19uYW1lOwoKICAgICAgICBpZiAoc2NyaXB0VXJsLmluZGV4T2YoIj8iKSA+IC0xKSB7CiAgICAgICAgICAgIHNjcmlwdFVybCArPSAiJiI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2NyaXB0VXJsICs9ICI/IjsKICAgICAgICB9CiAgICAgICAgc2NyaXB0VXJsICs9ICd1cmw9JyArIGVuY29kZVVSSUNvbXBvbmVudCh1cmwpICsgJyZjYWxsYmFjaz0nICsgY2FsbGJhY2tfbmFtZTsKICAgICAgICBzY3JpcHQgPSBkb2MuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CgogICAgICAgIHdpbmRvd1tjYWxsYmFja19uYW1lXSA9IGZ1bmN0aW9uKGEpewogICAgICAgICAgICBpZiAoYS5zdWJzdHJpbmcoMCw2KSA9PT0gImVycm9yOiIpewogICAgICAgICAgICAgICAgaW1hZ2VPYmouc3VjY2VlZGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgICAgICAgICAgICBpbWFnZXMubnVtRmFpbGVkKys7CiAgICAgICAgICAgICAgICBzdGFydCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgICAgICAgICBpbWcuc3JjID0gYTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aW5kb3dbY2FsbGJhY2tfbmFtZV0gPSB1bmRlZmluZWQ7IC8vIHRvIHdvcmsgd2l0aCBJRTw5ICAvLyBOT1RFOiB0aGF0IHRoZSB1bmRlZmluZWQgY2FsbGJhY2sgcHJvcGVydHktbmFtZSBzdGlsbCBleGlzdHMgb24gdGhlIHdpbmRvdyBvYmplY3QgKGZvciBJRTw5KQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZGVsZXRlIHdpbmRvd1tjYWxsYmFja19uYW1lXTsgIC8vIGZvciBhbGwgYnJvd3NlciB0aGF0IHN1cHBvcnQgdGhpcwogICAgICAgICAgICB9IGNhdGNoKGV4KSB7fQogICAgICAgICAgICBzY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICAgICAgICBzY3JpcHQgPSBudWxsOwogICAgICAgICAgICBkZWxldGUgaW1hZ2VPYmouc2NyaXB0OwogICAgICAgICAgICBkZWxldGUgaW1hZ2VPYmouY2FsbGJhY2tuYW1lOwogICAgICAgIH07CgogICAgICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAidGV4dC9qYXZhc2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgic3JjIiwgc2NyaXB0VXJsKTsKICAgICAgICBpbWFnZU9iai5zY3JpcHQgPSBzY3JpcHQ7CiAgICAgICAgd2luZG93LmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCiAgICB9CgogICAgZnVuY3Rpb24gZ2V0SW1hZ2VzIChlbCkgewoKCgogICAgICAgIC8vIGlmICghdGhpcy5pZ25vcmVSZS50ZXN0KGVsLm5vZGVOYW1lKSl7CiAgICAgICAgLy8KICAgICAgICAKICAgICAgICB2YXIgY29udGVudHMgPSBfaHRtbDJjYW52YXMuVXRpbC5DaGlsZHJlbihlbCksCiAgICAgICAgaSwKICAgICAgICBiYWNrZ3JvdW5kX2ltYWdlLAogICAgICAgIHNyYywKICAgICAgICBpbWcsCiAgICAgICAgZWxOb2RlVHlwZSA9IGZhbHNlOwoKICAgICAgICAvLyBGaXJlZm94IGZhaWxzIHdpdGggcGVybWlzc2lvbiBkZW5pZWQgb24gcGFnZXMgd2l0aCBpZnJhbWVzCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGNvbnRlbnRzTGVuID0gY29udGVudHMubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGkgPSAwOyAgaSA8IGNvbnRlbnRzTGVuOyBpKz0xICl7CiAgICAgICAgICAgICAgICAvLyB2YXIgaWduUmUgPSBuZXcgUmVnRXhwKCIoIit0aGlzLmlnbm9yZUVsZW1lbnRzKyIpIik7CiAgICAgICAgICAgICAgICAvLyBpZiAoIWlnblJlLnRlc3QoZWxlbWVudC5ub2RlTmFtZSkpewogICAgICAgICAgICAgICAgZ2V0SW1hZ2VzKGNvbnRlbnRzW2ldKTsKICAgICAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjYXRjaCggZSApIHt9CgoKICAgICAgICAvLyB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZWxOb2RlVHlwZSA9IGVsLm5vZGVUeXBlOwogICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgIGVsTm9kZVR5cGUgPSBmYWxzZTsKICAgICAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogZmFpbGVkIHRvIGFjY2VzcyBzb21lIGVsZW1lbnQncyBub2RlVHlwZSAtIEV4Y2VwdGlvbjogIiArIGV4Lm1lc3NhZ2UpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGVsTm9kZVR5cGUgPT09IDEgfHwgZWxOb2RlVHlwZSA9PT0gdW5kZWZpbmVkKXsKCiAgICAgICAgICAgIC8vIG9wZXJhIHRocm93cyBleGNlcHRpb24gb24gZXh0ZXJuYWwtY29udGVudC5odG1sCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kX2ltYWdlID0gX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTKGVsLCAnYmFja2dyb3VuZEltYWdlJyk7CiAgICAgICAgICAgIH1jYXRjaChlKSB7CiAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBmYWlsZWQgdG8gZ2V0IGJhY2tncm91bmQtaW1hZ2UgLSBFeGNlcHRpb246ICIgKyBlLm1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICggYmFja2dyb3VuZF9pbWFnZSAmJiBiYWNrZ3JvdW5kX2ltYWdlICE9PSAiMSIgJiYgYmFja2dyb3VuZF9pbWFnZSAhPT0gIm5vbmUiICkgewoKICAgICAgICAgICAgICAgIC8vIFRPRE8gYWRkIG11bHRpIGltYWdlIGJhY2tncm91bmQgc3VwcG9ydAoKICAgICAgICAgICAgICAgIGlmICgvXigtd2Via2l0fC1vfC1tb3p8LW1zfGxpbmVhciktLy50ZXN0KCBiYWNrZ3JvdW5kX2ltYWdlICkpIHsKCiAgICAgICAgICAgICAgICAgICAgaW1nID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkdyYWRpZW50KCBiYWNrZ3JvdW5kX2ltYWdlLCBfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMoIGVsICkgKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCBpbWcgIT09IHVuZGVmaW5lZCApewogICAgICAgICAgICAgICAgICAgICAgICBpbWFnZXNbYmFja2dyb3VuZF9pbWFnZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWc6IGltZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2NlZWRlZDogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCgpOwoKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzcmMgPSBfaHRtbDJjYW52YXMuVXRpbC5iYWNrZ3JvdW5kSW1hZ2UoYmFja2dyb3VuZF9pbWFnZS5tYXRjaCgvZGF0YTppbWFnZVwvLio7YmFzZTY0LC9pKSA/IGJhY2tncm91bmRfaW1hZ2UgOiBiYWNrZ3JvdW5kX2ltYWdlLnNwbGl0KCIsIilbMF0pOwogICAgICAgICAgICAgICAgICAgIG1ldGhvZHMubG9hZEltYWdlKHNyYyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgaWYgKGJhY2tncm91bmRfaW1hZ2UgJiYgYmFja2dyb3VuZF9pbWFnZSAhPT0gIjEiICYmIGJhY2tncm91bmRfaW1hZ2UgIT09ICJub25lIiAmJiBiYWNrZ3JvdW5kX2ltYWdlLnN1YnN0cmluZygwLDcpICE9PSAiLXdlYmtpdCIgJiYgYmFja2dyb3VuZF9pbWFnZS5zdWJzdHJpbmcoMCwzKSE9PSAiLW8tIiAmJiBiYWNrZ3JvdW5kX2ltYWdlLnN1YnN0cmluZygwLDQpICE9PSAiLW1veiIpewogICAgICAgICAgICAgICAgLy8gVE9ETyBhZGQgbXVsdGkgaW1hZ2UgYmFja2dyb3VuZCBzdXBwb3J0CiAgICAgICAgICAgICAgICBzcmMgPSBfaHRtbDJjYW52YXMuVXRpbC5iYWNrZ3JvdW5kSW1hZ2UoYmFja2dyb3VuZF9pbWFnZS5zcGxpdCgiLCIpWzBdKTsKICAgICAgICAgICAgICAgIG1ldGhvZHMubG9hZEltYWdlKHNyYyk7ICAgICAgICAgICAgKi8KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKSB7CiAgICAgICAgaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIGltYWdlT2JqLnRpbWVyICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICAgICAgICAvLyBDT1JTIHN1Y2NlZWRlZAogICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCggaW1hZ2VPYmoudGltZXIgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICAgICAgICBpbWFnZU9iai5zdWNjZWVkZWQgPSB0cnVlOwogICAgICAgICAgICBpbWcub25lcnJvciA9IGltZy5vbmxvYWQgPSBudWxsOwogICAgICAgICAgICBzdGFydCgpOwogICAgICAgIH07CiAgICAgICAgaW1nLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIGlmIChpbWcuY3Jvc3NPcmlnaW4gPT09ICJhbm9ueW1vdXMiKSB7CiAgICAgICAgICAgICAgICAvLyBDT1JTIGZhaWxlZAogICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCggaW1hZ2VPYmoudGltZXIgKTsKCiAgICAgICAgICAgICAgICAvLyBsZXQncyB0cnkgd2l0aCBwcm94eSBpbnN0ZWFkCiAgICAgICAgICAgICAgICBpZiAoIG9wdGlvbnMucHJveHkgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNyYyA9IGltZy5zcmM7CiAgICAgICAgICAgICAgICAgICAgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgICAgICAgICAgICAgaW1hZ2VPYmouaW1nID0gaW1nOwogICAgICAgICAgICAgICAgICAgIGltZy5zcmMgPSBzcmM7CgogICAgICAgICAgICAgICAgICAgIHByb3h5R2V0SW1hZ2UoIGltZy5zcmMsIGltZywgaW1hZ2VPYmogKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgICAgICAgIGltYWdlcy5udW1GYWlsZWQrKzsKICAgICAgICAgICAgaW1hZ2VPYmouc3VjY2VlZGVkID0gZmFsc2U7CiAgICAgICAgICAgIGltZy5vbmVycm9yID0gaW1nLm9ubG9hZCA9IG51bGw7CiAgICAgICAgICAgIHN0YXJ0KCk7CgogICAgICAgIH07CgogICAgICAgIC8vIFRPRE8gT3BlcmEgaGFzIG5vIGxvYWQvZXJyb3IgZXZlbnQgZm9yIFNWRyBpbWFnZXMKCiAgICAgICAgLy8gT3BlcmEgbmluamEgb25sb2FkJ3MgY2FjaGVkIGltYWdlcwogICAgICAgIC8qCiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgaWYgKCBpbWcud2lkdGggIT09IDAgJiYgaW1hZ2VPYmouc3VjY2VlZGVkID09PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICAgICAgICBpbWcub25sb2FkKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LCAxMDApOyAvLyBuZWVkcyBhIHJlZmxvdyBmb3IgYmFzZTY0IGVuY29kZWQgaW1hZ2VzPyBpbnRlcmVzdGluZ2x5IHRpbWVvdXQgb2YgMCBkb2Vzbid0IHdvcmsgYnV0IDEgZG9lcy4KICAgICAgICAgKi8KICAgIH0KCgogICAgbWV0aG9kcyA9IHsKICAgICAgICBsb2FkSW1hZ2U6IGZ1bmN0aW9uKCBzcmMgKSB7CiAgICAgICAgICAgIHZhciBpbWcsIGltYWdlT2JqOwogICAgICAgICAgICBpZiAoIHNyYyAmJiBpbWFnZXNbc3JjXSA9PT0gdW5kZWZpbmVkICkgewogICAgICAgICAgICAgICAgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgICAgICAgICBpZiAoIHNyYy5tYXRjaCgvZGF0YTppbWFnZVwvLio7YmFzZTY0LC9pKSApIHsKICAgICAgICAgICAgICAgICAgICBpbWcuc3JjID0gc3JjLnJlcGxhY2UoL3VybFwoWyciXXswLH18WyciXXswLH1cKSQvaWcsICcnKTsKICAgICAgICAgICAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gewogICAgICAgICAgICAgICAgICAgICAgICBpbWc6IGltZwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7CiAgICAgICAgICAgICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBpc1NhbWVPcmlnaW4oIHNyYyApIHx8IG9wdGlvbnMuYWxsb3dUYWludCA9PT0gIHRydWUgKSB7CiAgICAgICAgICAgICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgaW1nOiBpbWcKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgICAgICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOwogICAgICAgICAgICAgICAgICAgIGltZy5zcmMgPSBzcmM7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBzdXBwb3J0Q09SUyAmJiAhb3B0aW9ucy5hbGxvd1RhaW50ICYmIG9wdGlvbnMudXNlQ09SUyApIHsKICAgICAgICAgICAgICAgICAgICAvLyBhdHRlbXB0IHRvIGxvYWQgd2l0aCBDT1JTCgogICAgICAgICAgICAgICAgICAgIGltZy5jcm9zc09yaWdpbiA9ICJhbm9ueW1vdXMiOwogICAgICAgICAgICAgICAgICAgIGltYWdlT2JqID0gaW1hZ2VzW3NyY10gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGltZzogaW1nCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgICAgICAgICAgICAgICBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKTsKICAgICAgICAgICAgICAgICAgICBpbWcuc3JjID0gc3JjOwoKICAgICAgICAgICAgICAgICAgICAvLyB3b3JrIGFyb3VuZCBmb3IgaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTgwMDI4CiAgICAgICAgICAgICAgICAgICAgaW1nLmN1c3RvbUNvbXBsZXRlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW1nLmNvbXBsZXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWVyID0gd2luZG93LnNldFRpbWVvdXQodGhpcy5pbWcuY3VzdG9tQ29tcGxldGUsIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmltZy5vbmVycm9yKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LmJpbmQoaW1hZ2VPYmopOwogICAgICAgICAgICAgICAgICAgIGltZy5jdXN0b21Db21wbGV0ZSgpOwoKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIG9wdGlvbnMucHJveHkgKSB7CiAgICAgICAgICAgICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgaW1nOiBpbWcKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgICAgICAgICAgIHByb3h5R2V0SW1hZ2UoIHNyYywgaW1nLCBpbWFnZU9iaiApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgIH0sCiAgICAgICAgY2xlYW51cERPTTogZnVuY3Rpb24oY2F1c2UpIHsKICAgICAgICAgICAgdmFyIGltZywgc3JjOwogICAgICAgICAgICBpZiAoIWltYWdlcy5jbGVhbnVwRG9uZSkgewogICAgICAgICAgICAgICAgaWYgKGNhdXNlICYmIHR5cGVvZiBjYXVzZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBDbGVhbnVwIGJlY2F1c2U6ICIgKyBjYXVzZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IENsZWFudXAgYWZ0ZXIgdGltZW91dDogIiArIG9wdGlvbnMudGltZW91dCArICIgbXMuIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yIChzcmMgaW4gaW1hZ2VzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGltYWdlcy5oYXNPd25Qcm9wZXJ0eShzcmMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGltZyA9IGltYWdlc1tzcmNdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGltZyA9PT0gIm9iamVjdCIgJiYgaW1nLmNhbGxiYWNrbmFtZSAmJiBpbWcuc3VjY2VlZGVkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhbmNlbCBwcm94eSBpbWFnZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3dbaW1nLmNhbGxiYWNrbmFtZV0gPSB1bmRlZmluZWQ7IC8vIHRvIHdvcmsgd2l0aCBJRTw5ICAvLyBOT1RFOiB0aGF0IHRoZSB1bmRlZmluZWQgY2FsbGJhY2sgcHJvcGVydHktbmFtZSBzdGlsbCBleGlzdHMgb24gdGhlIHdpbmRvdyBvYmplY3QgKGZvciBJRTw5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgd2luZG93W2ltZy5jYWxsYmFja25hbWVdOyAgLy8gZm9yIGFsbCBicm93c2VyIHRoYXQgc3VwcG9ydCB0aGlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGV4KSB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGltZy5zY3JpcHQgJiYgaW1nLnNjcmlwdC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1nLnNjcmlwdC5zZXRBdHRyaWJ1dGUoInNyYyIsICJhYm91dDpibGFuayIpOyAgLy8gdHJ5IHRvIGNhbmNlbCBydW5uaW5nIHJlcXVlc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWcuc2NyaXB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaW1nLnNjcmlwdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtRmFpbGVkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBDbGVhbmVkIHVwIGZhaWxlZCBpbWc6ICciICsgc3JjICsgIicgU3RlcHM6ICIgKyBpbWFnZXMubnVtTG9hZGVkICsgIiAvICIgKyBpbWFnZXMubnVtVG90YWwpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGNhbmNlbCBhbnkgcGVuZGluZyByZXF1ZXN0cwogICAgICAgICAgICAgICAgaWYod2luZG93LnN0b3AgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zdG9wKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYoZG9jdW1lbnQuZXhlY0NvbW1hbmQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJTdG9wIiwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmNsb3NlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5jbG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW1hZ2VzLmNsZWFudXBEb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICghKGNhdXNlICYmIHR5cGVvZiBjYXVzZSA9PT0gInN0cmluZyIpKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVuZGVyaW5nRG9uZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aW1lb3V0VGltZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGltZW91dFRpbWVyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9OwoKICAgIGlmIChvcHRpb25zLnRpbWVvdXQgPiAwKSB7CiAgICAgICAgdGltZW91dFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQobWV0aG9kcy5jbGVhbnVwRE9NLCBvcHRpb25zLnRpbWVvdXQpOwogICAgfQogICAgaDJjbG9nKCdodG1sMmNhbnZhczogUHJlbG9hZCBzdGFydHM6IGZpbmRpbmcgYmFja2dyb3VuZC1pbWFnZXMnKTsKICAgIGltYWdlcy5maXJzdFJ1biA9IHRydWU7CgogICAgZ2V0SW1hZ2VzKCBlbGVtZW50ICk7CgogICAgaDJjbG9nKCdodG1sMmNhbnZhczogUHJlbG9hZDogRmluZGluZyBpbWFnZXMnKTsKICAgIC8vIGxvYWQgPGltZz4gaW1hZ2VzCiAgICBmb3IgKGkgPSAwOyBpIDwgaW1nTGVuOyBpKz0xKXsKICAgICAgICBtZXRob2RzLmxvYWRJbWFnZSggZG9tSW1hZ2VzW2ldLmdldEF0dHJpYnV0ZSggInNyYyIgKSApOwogICAgfQoKICAgIGltYWdlcy5maXJzdFJ1biA9IGZhbHNlOwogICAgaDJjbG9nKCdodG1sMmNhbnZhczogUHJlbG9hZDogRG9uZS4nKTsKICAgIGlmICggaW1hZ2VzLm51bVRvdGFsID09PSBpbWFnZXMubnVtTG9hZGVkICkgewogICAgICAgIHN0YXJ0KCk7CiAgICB9CgogICAgcmV0dXJuIG1ldGhvZHM7Cgp9OwoKCgoKLyoKICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPgogIENvcHlyaWdodCAoYykgMjAxMSBOaWtsYXMgdm9uIEhlcnR6ZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aAoKICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQoqLwpmdW5jdGlvbiBoMmNSZW5kZXJDb250ZXh0KHdpZHRoLCBoZWlnaHQpIHsKICAgIHZhciBzdG9yYWdlID0gW107CiAgICByZXR1cm4gewogICAgICAgIHN0b3JhZ2U6IHN0b3JhZ2UsCiAgICAgICAgd2lkdGg6IHdpZHRoLAogICAgICAgIGhlaWdodDogaGVpZ2h0LAogICAgICAgIGZpbGxSZWN0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgICAgICAgICAgbmFtZTogImZpbGxSZWN0IiwKICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBkcmF3U2hhcGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgCiAgICAgICAgICAgIHZhciBzaGFwZSA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgICAgICAgICBuYW1lOiAiZHJhd1NoYXBlIiwKICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBzaGFwZQogICAgICAgICAgICB9KTsKICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgbW92ZVRvOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBzaGFwZS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogIm1vdmVUbyIsCiAgICAgICAgICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBsaW5lVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAibGluZVRvIiwKICAgICAgICAgICAgICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGJlemllckN1cnZlVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAiYmV6aWVyQ3VydmVUbyIsCiAgICAgICAgICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBxdWFkcmF0aWNDdXJ2ZVRvOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBzaGFwZS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogInF1YWRyYXRpY0N1cnZlVG8iLAogICAgICAgICAgICAgICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9LAogICAgICAgIGRyYXdJbWFnZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzdG9yYWdlLnB1c2goewogICAgICAgICAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICAgICAgICAgIG5hbWU6ICJkcmF3SW1hZ2UiLAogICAgICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGZpbGxUZXh0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgICAgICAgICAgbmFtZTogImZpbGxUZXh0IiwKICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBzZXRWYXJpYWJsZTogZnVuY3Rpb24gKHZhcmlhYmxlLCB2YWx1ZSkgewogICAgICAgICAgICBzdG9yYWdlLnB1c2goewogICAgICAgICAgICAgICAgdHlwZTogInZhcmlhYmxlIiwKICAgICAgICAgICAgICAgIG5hbWU6IHZhcmlhYmxlLAogICAgICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IHZhbHVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07Cn0KCi8qCiAgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogIGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmgKCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UKKi8KX2h0bWwyY2FudmFzLlJlbmRlcmVyID0gZnVuY3Rpb24ocGFyc2VRdWV1ZSwgb3B0aW9ucyl7CgoKICAgIHZhciBxdWV1ZSA9IFtdOwoKICAgIGZ1bmN0aW9uIHNvcnRaKHpTdGFjayl7CiAgICAgICAgdmFyIHN1YlN0YWNrcyA9IFtdLAogICAgICAgIHN0YWNrVmFsdWVzID0gW10sCiAgICAgICAgelN0YWNrQ2hpbGRyZW4gPSB6U3RhY2suY2hpbGRyZW4sCiAgICAgICAgcywKICAgICAgICBpLAogICAgICAgIHN0YWNrTGVuLAogICAgICAgIHpWYWx1ZSwKICAgICAgICB6TGVuLAogICAgICAgIHN0YWNrQ2hpbGQsCiAgICAgICAgYiwKICAgICAgICBzdWJTdGFja0xlbjsKCgogICAgICAgIGZvciAocyA9IDAsIHpMZW4gPSB6U3RhY2tDaGlsZHJlbi5sZW5ndGg7IHMgPCB6TGVuOyBzKz0xKXsKCiAgICAgICAgICAgIHN0YWNrQ2hpbGQgPSB6U3RhY2tDaGlsZHJlbltzXTsKCiAgICAgICAgICAgIGlmIChzdGFja0NoaWxkLmNoaWxkcmVuICYmIHN0YWNrQ2hpbGQuY2hpbGRyZW4ubGVuZ3RoID4gMCl7CiAgICAgICAgICAgICAgICBzdWJTdGFja3MucHVzaChzdGFja0NoaWxkKTsKICAgICAgICAgICAgICAgIHN0YWNrVmFsdWVzLnB1c2goc3RhY2tDaGlsZC56aW5kZXgpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2goc3RhY2tDaGlsZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICBzdGFja1ZhbHVlcy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEgLSBiOwogICAgICAgIH0pOwoKICAgICAgICBmb3IgKGkgPSAwLCBzdGFja0xlbiA9IHN0YWNrVmFsdWVzLmxlbmd0aDsgaSA8IHN0YWNrTGVuOyBpKz0xKXsKICAgICAgICAgICAgelZhbHVlID0gc3RhY2tWYWx1ZXNbaV07CiAgICAgICAgICAgIGZvciAoYiA9IDAsIHN1YlN0YWNrTGVuID0gc3ViU3RhY2tzLmxlbmd0aDsgYiA8PSBzdWJTdGFja0xlbjsgYis9MSl7CgogICAgICAgICAgICAgICAgaWYgKHN1YlN0YWNrc1tiXS56aW5kZXggPT09IHpWYWx1ZSl7CiAgICAgICAgICAgICAgICAgICAgc3RhY2tDaGlsZCA9IHN1YlN0YWNrcy5zcGxpY2UoYiwgMSk7CiAgICAgICAgICAgICAgICAgICAgc29ydFooc3RhY2tDaGlsZFswXSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0KCgogICAgc29ydFoocGFyc2VRdWV1ZS56SW5kZXgpOwogICAgaWYgKCB0eXBlb2Ygb3B0aW9ucy5fcmVuZGVyZXIuX2NyZWF0ZSAhPT0gImZ1bmN0aW9uIiApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcmVuZGVyZXIgZGVmaW5lZCIpOwogICAgfQogICAgcmV0dXJuIG9wdGlvbnMuX3JlbmRlcmVyLl9jcmVhdGUoIHBhcnNlUXVldWUsIG9wdGlvbnMsIGRvY3VtZW50LCBxdWV1ZSwgX2h0bWwyY2FudmFzICk7Cgp9OwoKLyoKICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPgogIENvcHlyaWdodCAoYykgMjAxMSBOaWtsYXMgdm9uIEhlcnR6ZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aAoKICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQoqLwoKCmh0bWwyY2FudmFzID0gZnVuY3Rpb24oIGVsZW1lbnRzLCBvcHRzICkgewoKICAgIHZhciBxdWV1ZSwKICAgIGNhbnZhcywKICAgIG9wdGlvbnMgPSB7CiAgICAgICAgLy8gZ2VuZXJhbAogICAgICAgIGxvZ2dpbmc6IGZhbHNlLAogICAgICAgIGVsZW1lbnRzOiBlbGVtZW50cywKCiAgICAgICAgLy8gcHJlbG9hZCBvcHRpb25zCiAgICAgICAgcHJveHk6ICJodHRwOi8vaHRtbDJjYW52YXMuYXBwc3BvdC5jb20vIiwKICAgICAgICB0aW1lb3V0OiAwLCAgICAvLyBubyB0aW1lb3V0CiAgICAgICAgdXNlQ09SUzogZmFsc2UsIC8vIHRyeSB0byBsb2FkIGltYWdlcyBhcyBDT1JTICh3aGVyZSBhdmFpbGFibGUpLCBiZWZvcmUgZmFsbGluZyBiYWNrIHRvIHByb3h5CiAgICAgICAgYWxsb3dUYWludDogZmFsc2UsIC8vIHdoZXRoZXIgdG8gYWxsb3cgaW1hZ2VzIHRvIHRhaW50IHRoZSBjYW52YXMsIHdvbid0IG5lZWQgcHJveHkgaWYgc2V0IHRvIHRydWUKCiAgICAgICAgLy8gcGFyc2Ugb3B0aW9ucwogICAgICAgIHN2Z1JlbmRlcmluZzogZmFsc2UsIC8vIHVzZSBzdmcgcG93ZXJlZCByZW5kZXJpbmcgd2hlcmUgYXZhaWxhYmxlIChGRjExKykKICAgICAgICBpZnJhbWVEZWZhdWx0OiAiZGVmYXVsdCIsCiAgICAgICAgaWdub3JlRWxlbWVudHM6ICJJRlJBTUV8T0JKRUNUfFBBUkFNIiwKICAgICAgICB1c2VPdmVyZmxvdzogdHJ1ZSwKICAgICAgICBsZXR0ZXJSZW5kZXJpbmc6IGZhbHNlLAoKICAgICAgICAvLyByZW5kZXIgb3B0aW9ucwoKICAgICAgICBmbGFzaGNhbnZhczogdW5kZWZpbmVkLCAvLyBwYXRoIHRvIGZsYXNoY2FudmFzCiAgICAgICAgd2lkdGg6IG51bGwsCiAgICAgICAgaGVpZ2h0OiBudWxsLAogICAgICAgIHRhaW50VGVzdDogdHJ1ZSwgLy8gZG8gYSB0YWludCB0ZXN0IHdpdGggYWxsIGltYWdlcyBiZWZvcmUgYXBwbHlpbmcgdG8gY2FudmFzCiAgICByZW5kZXJlcjogIkNhbnZhcyIKICAgIH0sIHJlbmRlcmVyOwoKICAgIG9wdGlvbnMgPSBfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQob3B0cywgb3B0aW9ucyk7CgogIGlmICh0eXBlb2Ygb3B0aW9ucy5yZW5kZXJlciA9PT0gInN0cmluZyIgJiYgX2h0bWwyY2FudmFzLlJlbmRlcmVyW29wdGlvbnMucmVuZGVyZXJdICE9PSB1bmRlZmluZWQpIHsKICAgIG9wdGlvbnMuX3JlbmRlcmVyID0gX2h0bWwyY2FudmFzLlJlbmRlcmVyW29wdGlvbnMucmVuZGVyZXJdKCBvcHRpb25zICk7CiAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucy5yZW5kZXJlciA9PT0gImZ1bmN0aW9uIikgewogICAgb3B0aW9ucy5fcmVuZGVyZXIgPSBvcHRpb25zLnJlbmRlcmVyKCBvcHRpb25zICk7CiAgfSBlbHNlIHsKICAgIHRocm93KCJVbmtub3duIHJlbmRlcmVyIik7CiAgfQoKICAgIF9odG1sMmNhbnZhcy5sb2dnaW5nID0gb3B0aW9ucy5sb2dnaW5nOwogICAgb3B0aW9ucy5jb21wbGV0ZSA9IGZ1bmN0aW9uKCBpbWFnZXMgKSB7CgogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnByZWxvYWRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpZiAoIG9wdGlvbnMub25wcmVsb2FkZWQoIGltYWdlcyApID09PSBmYWxzZSApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBxdWV1ZSA9IF9odG1sMmNhbnZhcy5QYXJzZSggaW1hZ2VzLCBvcHRpb25zICk7CgogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnBhcnNlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpZiAoIG9wdGlvbnMub25wYXJzZWQoIHF1ZXVlICkgPT09IGZhbHNlICkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjYW52YXMgPSBfaHRtbDJjYW52YXMuUmVuZGVyZXIoIHF1ZXVlLCBvcHRpb25zICk7CgogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnJlbmRlcmVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIG9wdGlvbnMub25yZW5kZXJlZCggY2FudmFzICk7CiAgICAgICAgfQoKCiAgICB9OwoKICAgIC8vIGZvciBwYWdlcyB3aXRob3V0IGltYWdlcywgd2Ugc3RpbGwgd2FudCB0aGlzIHRvIGJlIGFzeW5jLCBpLmUuIHJldHVybiBtZXRob2RzIGJlZm9yZSBleGVjdXRpbmcKICAgIHdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpewogICAgICAgIF9odG1sMmNhbnZhcy5QcmVsb2FkKCBvcHRpb25zICk7CiAgICB9LCAwICk7CgogICAgcmV0dXJuIHsKICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKCBxdWV1ZSwgb3B0cyApIHsKICAgICAgICAgICAgcmV0dXJuIF9odG1sMmNhbnZhcy5SZW5kZXJlciggcXVldWUsIF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKSApOwogICAgICAgIH0sCiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKCBpbWFnZXMsIG9wdHMgKSB7CiAgICAgICAgICAgIHJldHVybiBfaHRtbDJjYW52YXMuUGFyc2UoIGltYWdlcywgX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7CiAgICAgICAgfSwKICAgICAgICBwcmVsb2FkOiBmdW5jdGlvbiggb3B0cyApIHsKICAgICAgICAgICAgcmV0dXJuIF9odG1sMmNhbnZhcy5QcmVsb2FkKCBfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQob3B0cywgb3B0aW9ucykgKTsKICAgICAgICB9LAogICAgICAgIGxvZzogaDJjbG9nCiAgICB9Owp9OwoKaHRtbDJjYW52YXMubG9nID0gaDJjbG9nOyAvLyBmb3IgcmVuZGVyZXJzCmh0bWwyY2FudmFzLlJlbmRlcmVyID0gewogICAgQ2FudmFzOiB1bmRlZmluZWQgLy8gV2UgYXJlIGFzc3VtaW5nIHRoaXMgd2lsbCBiZSB1c2VkCn07CgovKgogIGh0bWwyY2FudmFzIHYwLjM0IDxodHRwOi8vaHRtbDJjYW52YXMuaGVydHplbi5jb20+CiAgQ29weXJpZ2h0IChjKSAyMDExIE5pa2xhcyB2b24gSGVydHplbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICBodHRwOi8vd3d3LnR3aXR0ZXIuY29tL25pa2xhc3ZoCgogIFJlbGVhc2VkIHVuZGVyIE1JVCBMaWNlbnNlCiovCgoKX2h0bWwyY2FudmFzLlJlbmRlcmVyLkNhbnZhcyA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgIHZhciBkb2MgPSBkb2N1bWVudCwKICAgIGNhbnZhcyA9IG9wdGlvbnMuY2FudmFzIHx8IGRvYy5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSwKICAgIHVzaW5nRmxhc2hjYW52YXMgPSBmYWxzZSwKICAgIF9jcmVhdGVDYWxsZWQgPSBmYWxzZSwKICAgIGNhbnZhc1JlYWR5VG9EcmF3ID0gZmFsc2UsCiAgICBtZXRob2RzLAogICAgZmxhc2hNYXhTaXplID0gMjg4MDsgLy8gZmxhc2ggYml0bWFwIGxpbWl0ZWQgdG8gMjg4MHgyODgwcHggLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8yMDMzNzkyL2FyZ3VtZW50ZXJyb3ItZXJyb3ItMjAxNS1pbnZhbGlkLWJpdG1hcGRhdGEKCgogICAgaWYgKGNhbnZhcy5nZXRDb250ZXh0KXsKICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBSZW5kZXJlcjogdXNpbmcgY2FudmFzIHJlbmRlcmVyIik7CiAgICAgICAgY2FudmFzUmVhZHlUb0RyYXcgPSB0cnVlOwogICAgfSBlbHNlIGlmICggb3B0aW9ucy5mbGFzaGNhbnZhcyAhPT0gdW5kZWZpbmVkICl7CiAgICAgICAgdXNpbmdGbGFzaGNhbnZhcyA9IHRydWU7CiAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogUmVuZGVyZXI6IGNhbnZhcyBub3QgYXZhaWxhYmxlLCB1c2luZyBmbGFzaGNhbnZhcyIpOwogICAgICAgIHZhciBzY3JpcHQgPSBkb2MuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LnNyYyA9IG9wdGlvbnMuZmxhc2hjYW52YXM7CgogICAgICAgIHNjcmlwdC5vbmxvYWQgPSAoZnVuY3Rpb24oc2NyaXB0LCBmdW5jKXsKICAgICAgICAgICAgdmFyIGludGVydmFsRnVuYzsKCiAgICAgICAgICAgIGlmIChzY3JpcHQub25sb2FkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIC8vIElFIGxhY2sgb2Ygc3VwcG9ydCBmb3Igc2NyaXB0IG9ubG9hZAoKICAgICAgICAgICAgICAgIGlmKCBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlICE9PSB1bmRlZmluZWQgKSB7CgogICAgICAgICAgICAgICAgICAgIGludGVydmFsRnVuYyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NyaXB0LnJlYWR5U3RhdGUgIT09ICJsb2FkZWQiICYmIHNjcmlwdC5yZWFkeVN0YXRlICE9PSAiY29tcGxldGUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dCggaW50ZXJ2YWxGdW5jLCAyNTAgKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpdCBpcyBsb2FkZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmMoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoIGludGVydmFsRnVuYywgMjUwICk7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBSZW5kZXJlcjogQ2FuJ3QgdHJhY2sgd2hlbiBmbGFzaGNhbnZhcyBpcyBsb2FkZWQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgICAgICAgfQoKICAgICAgICB9KShzY3JpcHQsIGZ1bmN0aW9uKCl7CgogICAgICAgICAgICBpZiAodHlwZW9mIHdpbmRvdy5GbGFzaENhbnZhcyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IFJlbmRlcmVyOiBGbGFzaGNhbnZhcyBpbml0aWFsaXplZCIpOwogICAgICAgICAgICAgICAgd2luZG93LkZsYXNoQ2FudmFzLmluaXRFbGVtZW50KCBjYW52YXMgKTsKCiAgICAgICAgICAgICAgICBjYW52YXNSZWFkeVRvRHJhdyA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoIF9jcmVhdGVDYWxsZWQgIT09IGZhbHNlICkgewogICAgICAgICAgICAgICAgICAgIG1ldGhvZHMuX2NyZWF0ZS5hcHBseSggbnVsbCwgX2NyZWF0ZUNhbGxlZCApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGRvYy5ib2R5LmFwcGVuZENoaWxkKCBzY3JpcHQgKTsKCiAgICB9CgogICAgbWV0aG9kcyA9IHsKICAgICAgICBfY3JlYXRlOiBmdW5jdGlvbiggelN0YWNrLCBvcHRpb25zLCBkb2MsIHF1ZXVlLCBfaHRtbDJjYW52YXMgKSB7CgogICAgICAgICAgICBpZiAoICFjYW52YXNSZWFkeVRvRHJhdyApIHsKICAgICAgICAgICAgICAgIF9jcmVhdGVDYWxsZWQgPSBhcmd1bWVudHM7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FudmFzOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIiksCiAgICAgICAgICAgIHN0b3JhZ2VDb250ZXh0LAogICAgICAgICAgICBpLAogICAgICAgICAgICBxdWV1ZUxlbiwKICAgICAgICAgICAgYSwKICAgICAgICAgICAgbmV3Q2FudmFzLAogICAgICAgICAgICBib3VuZHMsCiAgICAgICAgICAgIHRlc3RDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKSwKICAgICAgICAgICAgaGFzQ1RYID0gKCB0ZXN0Q2FudmFzLmdldENvbnRleHQgIT09IHVuZGVmaW5lZCApLAogICAgICAgICAgICBzdG9yYWdlTGVuLAogICAgICAgICAgICByZW5kZXJJdGVtLAogICAgICAgICAgICB0ZXN0Y3R4ID0gKCBoYXNDVFggKSA/IHRlc3RDYW52YXMuZ2V0Q29udGV4dCgiMmQiKSA6IHt9LAogICAgICAgICAgICBzYWZlSW1hZ2VzID0gW10sCiAgICAgICAgICAgIGZzdHlsZTsKCiAgICAgICAgICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy5zdHlsZS53aWR0aCA9ICghdXNpbmdGbGFzaGNhbnZhcykgPyBvcHRpb25zLndpZHRoIHx8IHpTdGFjay5jdHgud2lkdGggOiBNYXRoLm1pbihmbGFzaE1heFNpemUsIChvcHRpb25zLndpZHRoIHx8IHpTdGFjay5jdHgud2lkdGgpICk7CiAgICAgICAgICAgIGNhbnZhcy5oZWlnaHQgPSBjYW52YXMuc3R5bGUuaGVpZ2h0ID0gKCF1c2luZ0ZsYXNoY2FudmFzKSA/IG9wdGlvbnMuaGVpZ2h0IHx8IHpTdGFjay5jdHguaGVpZ2h0IDogTWF0aC5taW4oZmxhc2hNYXhTaXplLCAob3B0aW9ucy5oZWlnaHQgfHwgelN0YWNrLmN0eC5oZWlnaHQpICk7CgogICAgICAgICAgICBmc3R5bGUgPSBjdHguZmlsbFN0eWxlOwogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gelN0YWNrLmJhY2tncm91bmRDb2xvcjsKICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7CiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBmc3R5bGU7CgogICAgICAgICAgICBpZiAoIG9wdGlvbnMuc3ZnUmVuZGVyaW5nICYmIHpTdGFjay5zdmdSZW5kZXIgIT09IHVuZGVmaW5lZCApIHsKICAgICAgICAgICAgICAgIC8vIFRPRE86IGVuYWJsZSBhc3luYyByZW5kZXJpbmcgdG8gc3VwcG9ydCB0aGlzCiAgICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlKCB6U3RhY2suc3ZnUmVuZGVyLCAwLCAwICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKCBpID0gMCwgcXVldWVMZW4gPSBxdWV1ZS5sZW5ndGg7IGkgPCBxdWV1ZUxlbjsgaSs9MSApIHsKCiAgICAgICAgICAgICAgICAgICAgc3RvcmFnZUNvbnRleHQgPSBxdWV1ZS5zcGxpY2UoMCwgMSlbMF07CiAgICAgICAgICAgICAgICAgICAgc3RvcmFnZUNvbnRleHQuY2FudmFzUG9zaXRpb24gPSBzdG9yYWdlQ29udGV4dC5jYW52YXNQb3NpdGlvbiB8fCB7fTsKCiAgICAgICAgICAgICAgICAgICAgLy90aGlzLmNhbnZhc1JlbmRlckNvbnRleHQoc3RvcmFnZUNvbnRleHQscGFyZW50Y3R4KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gc2V0IGNvbW1vbiBzZXR0aW5ncyBmb3IgY2FudmFzCiAgICAgICAgICAgICAgICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICJib3R0b20iOwoKICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcmFnZUNvbnRleHQuY2xpcCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coc3RvcmFnZUNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgucmVjdChzdG9yYWdlQ29udGV4dC5jbGlwLmxlZnQsIHN0b3JhZ2VDb250ZXh0LmNsaXAudG9wLCBzdG9yYWdlQ29udGV4dC5jbGlwLndpZHRoLCBzdG9yYWdlQ29udGV4dC5jbGlwLmhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5jbGlwKCk7CgogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlKXsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoYSA9IDAsIHN0b3JhZ2VMZW4gPSBzdG9yYWdlQ29udGV4dC5jdHguc3RvcmFnZS5sZW5ndGg7IGEgPCBzdG9yYWdlTGVuOyBhKz0xKXsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJJdGVtID0gc3RvcmFnZUNvbnRleHQuY3R4LnN0b3JhZ2VbYV07CgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaChyZW5kZXJJdGVtLnR5cGUpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInZhcmlhYmxlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4W3JlbmRlckl0ZW0ubmFtZV0gPSByZW5kZXJJdGVtWydhcmd1bWVudHMnXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVuZGVySXRlbS5uYW1lID09PSAiZmlsbFJlY3QiKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF1c2luZ0ZsYXNoY2FudmFzIHx8IHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzBdICsgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bMl0gPCBmbGFzaE1heFNpemUgICYmIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzFdICsgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bM10gPCBmbGFzaE1heFNpemUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QuYXBwbHkoIGN0eCwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ10gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZW5kZXJJdGVtLm5hbWUgPT09ICJkcmF3U2hhcGUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICggZnVuY3Rpb24oIGFyZ3MgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpLCBsZW4gPSBhcmdzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4WyBhcmdzWyBpIF0ubmFtZSBdLmFwcGx5KCBjdHgsIGFyZ3NbIGkgXVsnYXJndW1lbnRzJ10gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSggcmVuZGVySXRlbVsnYXJndW1lbnRzJ10gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlbmRlckl0ZW0ubmFtZSA9PT0gImZpbGxUZXh0IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF1c2luZ0ZsYXNoY2FudmFzIHx8IHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzFdIDwgZmxhc2hNYXhTaXplICAmJiByZW5kZXJJdGVtWydhcmd1bWVudHMnXVsyXSA8IGZsYXNoTWF4U2l6ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5maWxsVGV4dC5hcHBseSggY3R4LCByZW5kZXJJdGVtWydhcmd1bWVudHMnXSApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlbmRlckl0ZW0ubmFtZSA9PT0gImRyYXdJbWFnZSIpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVuZGVySXRlbVsnYXJndW1lbnRzJ11bOF0gPiAwICYmIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzddKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIGhhc0NUWCAmJiBvcHRpb25zLnRhaW50VGVzdCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCBzYWZlSW1hZ2VzLmluZGV4T2YoIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWyAwIF0uc3JjICkgPT09IC0xICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGN0eC5kcmF3SW1hZ2UoIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWyAwIF0sIDAsIDAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGN0eC5nZXRJbWFnZURhdGEoIDAsIDAsIDEsIDEgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RDYW52YXMgPSBkb2MuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGN0eCA9IHRlc3RDYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlSW1hZ2VzLnB1c2goIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWyAwIF0uc3JjICk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UuYXBwbHkoIGN0eCwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ10gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LmNsaXApewogICAgICAgICAgICAgICAgICAgICAgICBjdHgucmVzdG9yZSgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IFJlbmRlcmVyOiBDYW52YXMgcmVuZGVyZXIgZG9uZSAtIHJldHVybmluZyBjYW52YXMgb2JqIik7CgogICAgICAgICAgICBxdWV1ZUxlbiA9IG9wdGlvbnMuZWxlbWVudHMubGVuZ3RoOwoKICAgICAgICAgICAgaWYgKHF1ZXVlTGVuID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZWxlbWVudHNbIDAgXSA9PT0gIm9iamVjdCIgJiYgb3B0aW9ucy5lbGVtZW50c1sgMCBdLm5vZGVOYW1lICE9PSAiQk9EWSIgJiYgdXNpbmdGbGFzaGNhbnZhcyA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAvLyBjcm9wIGltYWdlIHRvIHRoZSBib3VuZHMgb2Ygc2VsZWN0ZWQgKHNpbmdsZSkgZWxlbWVudAogICAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IF9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyggb3B0aW9ucy5lbGVtZW50c1sgMCBdICk7CiAgICAgICAgICAgICAgICAgICAgbmV3Q2FudmFzID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAgICAgICAgIG5ld0NhbnZhcy53aWR0aCA9IGJvdW5kcy53aWR0aDsKICAgICAgICAgICAgICAgICAgICBuZXdDYW52YXMuaGVpZ2h0ID0gYm91bmRzLmhlaWdodDsKICAgICAgICAgICAgICAgICAgICBjdHggPSBuZXdDYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKCiAgICAgICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZSggY2FudmFzLCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0LCAwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQgKTsKICAgICAgICAgICAgICAgICAgICBjYW52YXMgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXdDYW52YXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gLyplbHNlIHsKICAgICAgICAvLyBUT0RPIGNsaXAgYW5kIHJlc2l6ZSBtdWx0aXBsZSBlbGVtZW50cwoKICAgICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBxdWV1ZUxlbjsgaSs9MSApIHsKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmVsZW1lbnRzWyBpIF0gaW5zdGFuY2VvZiBFbGVtZW50KSB7CgogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAqLwoKCgogICAgICAgICAgICByZXR1cm4gY2FudmFzOwogICAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIG1ldGhvZHM7Cgp9OwoKLyoKICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPgogIENvcHlyaWdodCAoYykgMjAxMSBOaWtsYXMgdm9uIEhlcnR6ZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aAoKICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQoqLwoKCi8vIFdBUk5JTkcgVEhJUyBmaWxlIGlzIG91dGRhdGVkLCBhbmQgaGFzbid0IGJlZW4gdGVzdGVkIGluIHF1aXRlIGEgd2hpbGUKCl9odG1sMmNhbnZhcy5SZW5kZXJlci5TVkcgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICB2YXIgZG9jID0gZG9jdW1lbnQsCiAgICBzdmdOUyA9ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIsCiAgICBzdmcgPSBkb2MuY3JlYXRlRWxlbWVudE5TKHN2Z05TLCAic3ZnIiksCiAgICB4bGlua05TID0gImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgZGVmcyA9IGRvYy5jcmVhdGVFbGVtZW50TlMoc3ZnTlMsICJkZWZzIiksCiAgICBpLAogICAgYSwKICAgIHF1ZXVlTGVuLAogICAgc3RvcmFnZUxlbiwKICAgIHN0b3JhZ2VDb250ZXh0LAogICAgcmVuZGVySXRlbSwKICAgIGVsLAogICAgc2V0dGluZ3MgPSB7fSwKICAgIHRleHQsCiAgICBmb250U3R5bGUsCiAgICBjbGlwSWQgPSAwLAogICAgbWV0aG9kczsKCgogICAgbWV0aG9kcyA9IHsKICAgICAgICBfY3JlYXRlOiBmdW5jdGlvbiggelN0YWNrLCBvcHRpb25zLCBkb2MsIHF1ZXVlLCBfaHRtbDJjYW52YXMgKSB7CiAgICAgICAgICAgIHN2Zy5zZXRBdHRyaWJ1dGUoInZlcnNpb24iLCAiMS4xIik7CiAgICAgICAgICAgIHN2Zy5zZXRBdHRyaWJ1dGUoImJhc2VQcm9maWxlIiwgImZ1bGwiKTsKCiAgICAgICAgICAgIHN2Zy5zZXRBdHRyaWJ1dGUoInZpZXdCb3giLCAiMCAwICIgKyBNYXRoLm1heCh6U3RhY2suY3R4LndpZHRoLCBvcHRpb25zLndpZHRoKSArICIgIiArIE1hdGgubWF4KHpTdGFjay5jdHguaGVpZ2h0LCBvcHRpb25zLmhlaWdodCkpOwogICAgICAgICAgICBzdmcuc2V0QXR0cmlidXRlKCJ3aWR0aCIsIE1hdGgubWF4KHpTdGFjay5jdHgud2lkdGgsIG9wdGlvbnMud2lkdGgpICsgInB4Iik7CiAgICAgICAgICAgIHN2Zy5zZXRBdHRyaWJ1dGUoImhlaWdodCIsIE1hdGgubWF4KHpTdGFjay5jdHguaGVpZ2h0LCBvcHRpb25zLmhlaWdodCkgKyAicHgiKTsKICAgICAgICAgICAgc3ZnLnNldEF0dHJpYnV0ZSgicHJlc2VydmVBc3BlY3RSYXRpbyIsICJub25lIik7CiAgICAgICAgICAgIHN2Zy5hcHBlbmRDaGlsZChkZWZzKTsKCgoKICAgICAgICAgICAgZm9yIChpID0gMCwgcXVldWVMZW4gPSBxdWV1ZS5sZW5ndGg7IGkgPCBxdWV1ZUxlbjsgaSs9MSl7CgogICAgICAgICAgICAgICAgc3RvcmFnZUNvbnRleHQgPSBxdWV1ZS5zcGxpY2UoMCwgMSlbMF07CiAgICAgICAgICAgICAgICBzdG9yYWdlQ29udGV4dC5jYW52YXNQb3NpdGlvbiA9IHN0b3JhZ2VDb250ZXh0LmNhbnZhc1Bvc2l0aW9uIHx8IHt9OwoKICAgICAgICAgICAgICAgIC8vdGhpcy5jYW52YXNSZW5kZXJDb250ZXh0KHN0b3JhZ2VDb250ZXh0LHBhcmVudGN0eCk7CgoKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgIGlmIChzdG9yYWdlQ29udGV4dC5jbGlwKXsKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhzdG9yYWdlQ29udGV4dCk7CiAgICAgICAgICAgICAgICBjdHgucmVjdChzdG9yYWdlQ29udGV4dC5jbGlwLmxlZnQsIHN0b3JhZ2VDb250ZXh0LmNsaXAudG9wLCBzdG9yYWdlQ29udGV4dC5jbGlwLndpZHRoLCBzdG9yYWdlQ29udGV4dC5jbGlwLmhlaWdodCk7CiAgICAgICAgICAgICAgICBjdHguY2xpcCgpOwoKICAgICAgICAgICAgfSovCgogICAgICAgICAgICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlKXsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChhID0gMCwgc3RvcmFnZUxlbiA9IHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlLmxlbmd0aDsgYSA8IHN0b3JhZ2VMZW47IGErPTEpewoKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVySXRlbSA9IHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlW2FdOwoKCgogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2gocmVuZGVySXRlbS50eXBlKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInZhcmlhYmxlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXR0aW5nc1tyZW5kZXJJdGVtLm5hbWVdID0gcmVuZGVySXRlbVsnYXJndW1lbnRzJ107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlckl0ZW0ubmFtZSA9PT0gImZpbGxSZWN0IikgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwgPSBkb2MuY3JlYXRlRWxlbWVudE5TKHN2Z05TLCAicmVjdCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoIngiLCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVswXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgieSIsIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJ3aWR0aCIsIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJoZWlnaHQiLCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVszXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgiZmlsbCIsICBzZXR0aW5ncy5maWxsU3R5bGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdmcuYXBwZW5kQ2hpbGQoZWwpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYocmVuZGVySXRlbS5uYW1lID09PSAiZmlsbFRleHQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsID0gZG9jLmNyZWF0ZUVsZW1lbnROUyhzdmdOUywgInRleHQiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvbnRTdHlsZSA9IHNldHRpbmdzLmZvbnQuc3BsaXQoIiAiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlLmZvbnRWYXJpYW50ID0gZm9udFN0eWxlLnNwbGljZSgwLCAxKVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGUuZm9udFdlaWdodCA9IGZvbnRTdHlsZS5zcGxpY2UoMCwgMSlbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlLmZvbnRTdHlsZSA9IGZvbnRTdHlsZS5zcGxpY2UoMCwgMSlbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlLmZvbnRTaXplID0gZm9udFN0eWxlLnNwbGljZSgwLCAxKVswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgieCIsIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJ5IiwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bMl0gLSAocGFyc2VJbnQoZWwuc3R5bGUuZm9udFNpemUsIDEwKSArIDMpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgiZmlsbCIsIHNldHRpbmdzLmZpbGxTdHlsZSk7CgoKCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPIGdldCBwcm9wZXIgYmFzZWxpbmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGUuZG9taW5hbnRCYXNlbGluZSA9ICJ0ZXh0LWJlZm9yZS1lZGdlIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGUuZm9udEZhbWlseSA9IGZvbnRTdHlsZS5qb2luKCIgIik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gZG9jLmNyZWF0ZVRleHROb2RlKHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuYXBwZW5kQ2hpbGQodGV4dCk7CgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ZnLmFwcGVuZENoaWxkKGVsKTsKCgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYocmVuZGVySXRlbS5uYW1lID09PSAiZHJhd0ltYWdlIikgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzhdID4gMCAmJiByZW5kZXJJdGVtWydhcmd1bWVudHMnXVs3XSl7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyBjaGVjayB3aGV0aGVyIGV2ZW4gYW55IGNsaXBwaW5nIGlzIG5lY2Vzc2FyeSBmb3IgdGhpcyBwYXJ0aWN1bGFyIGltYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbCA9IGRvYy5jcmVhdGVFbGVtZW50TlMoc3ZnTlMsICJjbGlwUGF0aCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJpZCIsICJjbGlwSWQiICsgY2xpcElkKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gZG9jLmNyZWF0ZUVsZW1lbnROUyhzdmdOUywgInJlY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQuc2V0QXR0cmlidXRlKCJ4IiwgIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzVdICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnNldEF0dHJpYnV0ZSgieSIsIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzZdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnNldEF0dHJpYnV0ZSgid2lkdGgiLCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVszXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnNldEF0dHJpYnV0ZSgiaGVpZ2h0IiwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bNF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuYXBwZW5kQ2hpbGQodGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZzLmFwcGVuZENoaWxkKGVsKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbCA9IGRvYy5jcmVhdGVFbGVtZW50TlMoc3ZnTlMsICJpbWFnZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlTlMoeGxpbmtOUywgInhsaW5rOmhyZWYiLCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVswXS5zcmMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJ3aWR0aCIsIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzddKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgiaGVpZ2h0IiwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bOF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJ4IiwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bNV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJ5IiwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bNl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJjbGlwLXBhdGgiLCAidXJsKCNjbGlwSWQiICsgY2xpcElkICsgIikiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVsLnNldEF0dHJpYnV0ZSgieGxpbms6aHJlZiIsICk7CgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgicHJlc2VydmVBc3BlY3RSYXRpbyIsICJub25lIik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ZnLmFwcGVuZENoaWxkKGVsKTsKCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xpcElkICs9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJJdGVtWydhcmd1bWVudHMnXVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzFdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bMl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJJdGVtWydhcmd1bWVudHMnXVszXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzRdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bNV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJJdGVtWydhcmd1bWVudHMnXVs2XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bOF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKCiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgLyoKICAgICAgICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LmNsaXApewogICAgICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICAgICAgfQogICAgKi8KCgoKICAgICAgICAgICAgfQoKCgoKCgoKCgoKICAgICAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogUmVuZGVyZXI6IFNWRyBSZW5kZXJlciBkb25lIC0gcmV0dXJuaW5nIFNWRyBET00gb2JqIik7CgogICAgICAgICAgICByZXR1cm4gc3ZnOwogICAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIG1ldGhvZHM7CgoKfTsKCndpbmRvdy5odG1sMmNhbnZhcyA9IGh0bWwyY2FudmFzOwp9KHdpbmRvdywgZG9jdW1lbnQpKTsKCg==",
                "body": "LyoqCiAgQGxpY2Vuc2UgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogIGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmgKCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UKICovCihmdW5jdGlvbih3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQpewoKLyoKICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPgogIENvcHlyaWdodCAoYykgMjAxMSBOaWtsYXMgdm9uIEhlcnR6ZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aAoKICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQogKi8KInVzZSBzdHJpY3QiOwoKdmFyIF9odG1sMmNhbnZhcyA9IHt9LApwcmV2aW91c0VsZW1lbnQsCmNvbXB1dGVkQ1NTLApodG1sMmNhbnZhczsKCgpmdW5jdGlvbiBoMmNsb2coYSkgewogICAgaWYgKF9odG1sMmNhbnZhcy5sb2dnaW5nICYmIHdpbmRvdy5jb25zb2xlICYmIHdpbmRvdy5jb25zb2xlLmxvZykgewogICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhhKTsKICAgIH0KfQoKX2h0bWwyY2FudmFzLlV0aWwgPSB7fTsKCl9odG1sMmNhbnZhcy5VdGlsLmJhY2tncm91bmRJbWFnZSA9IGZ1bmN0aW9uIChzcmMpIHsKCiAgICBpZiAoL2RhdGE6aW1hZ2VcLy4qO2Jhc2U2NCwvaS50ZXN0KCBzcmMgKSB8fCAvXigtd2Via2l0fC1tb3p8bGluZWFyLWdyYWRpZW50fC1vLSkvLnRlc3QoIHNyYyApKSB7CiAgICAgICAgcmV0dXJuIHNyYzsKICAgIH0KCiAgICBpZiAoc3JjLnRvTG93ZXJDYXNlKCkuc3Vic3RyKCAwLCA1ICkgPT09ICd1cmwoIicpIHsKICAgICAgICBzcmMgPSBzcmMuc3Vic3RyKCA1ICk7CiAgICAgICAgc3JjID0gc3JjLnN1YnN0ciggMCwgc3JjLmxlbmd0aCAtIDIgKTsKICAgIH0gZWxzZSB7CiAgICAgICAgc3JjID0gc3JjLnN1YnN0ciggNCApOwogICAgICAgIHNyYyA9IHNyYy5zdWJzdHIoIDAsIHNyYy5sZW5ndGggLSAxICk7CiAgICB9CgogICAgcmV0dXJuIHNyYzsKfTsKCl9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyA9IGZ1bmN0aW9uIGdldEJvdW5kcyAoZWwpIHsKICAgIHZhciBjbGllbnRSZWN0LAogICAgYm91bmRzID0ge307CgogICAgaWYgKGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCl7CiAgICAgICAgY2xpZW50UmVjdCA9IGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKCiAgICAgICAgLy8gVE9ETyBhZGQgc2Nyb2xsIHBvc2l0aW9uIHRvIGJvdW5kcywgc28gbm8gc2Nyb2xsaW5nIG9mIHdpbmRvdyBuZWNlc3NhcnkKICAgICAgICBib3VuZHMudG9wID0gY2xpZW50UmVjdC50b3A7CiAgICAgICAgYm91bmRzLmJvdHRvbSA9IGNsaWVudFJlY3QuYm90dG9tIHx8IChjbGllbnRSZWN0LnRvcCArIGNsaWVudFJlY3QuaGVpZ2h0KTsKICAgICAgICBib3VuZHMubGVmdCA9IGNsaWVudFJlY3QubGVmdDsKCiAgICAgICAgLy8gb2xkZXIgSUUgZG9lc24ndCBoYXZlIHdpZHRoL2hlaWdodCwgYnV0IHRvcC9ib3R0b20gaW5zdGVhZAogICAgICAgIGJvdW5kcy53aWR0aCA9IGNsaWVudFJlY3Qud2lkdGggfHwgKGNsaWVudFJlY3QucmlnaHQgLSBjbGllbnRSZWN0LmxlZnQpOwogICAgICAgIGJvdW5kcy5oZWlnaHQgPSBjbGllbnRSZWN0LmhlaWdodCB8fCAoY2xpZW50UmVjdC5ib3R0b20gLSBjbGllbnRSZWN0LnRvcCk7CgogICAgICAgIHJldHVybiBib3VuZHM7CgogICAgfQp9OwoKX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTID0gZnVuY3Rpb24gKGVsLCBhdHRyaWJ1dGUpIHsKICAgIC8vIHJldHVybiAkKGVsKS5jc3MoYXR0cmlidXRlKTsKCiAgICB2YXIgdmFsOwoKICAgIGZ1bmN0aW9uIHRvUFgoIGF0dHJpYnV0ZSwgdmFsICkgewogICAgICAgIHZhciByc0xlZnQgPSBlbC5ydW50aW1lU3R5bGUgJiYgZWwucnVudGltZVN0eWxlWyBhdHRyaWJ1dGUgXSwKICAgICAgICBsZWZ0LAogICAgICAgIHN0eWxlID0gZWwuc3R5bGU7CgogICAgICAgIC8vIENoZWNrIGlmIHdlIGFyZSBub3QgZGVhbGluZyB3aXRoIHBpeGVscywgKE9wZXJhIGhhcyBpc3N1ZXMgd2l0aCB0aGlzKQogICAgICAgIC8vIFBvcnRlZCBmcm9tIGpRdWVyeSBjc3MuanMKICAgICAgICAvLyBGcm9tIHRoZSBhd2Vzb21lIGhhY2sgYnkgRGVhbiBFZHdhcmRzCiAgICAgICAgLy8gaHR0cDovL2VyaWsuZWFlLm5ldC9hcmNoaXZlcy8yMDA3LzA3LzI3LzE4LjU0LjE1LyNjb21tZW50LTEwMjI5MQoKICAgICAgICAvLyBJZiB3ZSdyZSBub3QgZGVhbGluZyB3aXRoIGEgcmVndWxhciBwaXhlbCBudW1iZXIKICAgICAgICAvLyBidXQgYSBudW1iZXIgdGhhdCBoYXMgYSB3ZWlyZCBlbmRpbmcsIHdlIG5lZWQgdG8gY29udmVydCBpdCB0byBwaXhlbHMKCiAgICAgICAgaWYgKCAhL14tP1swLTldK1wuP1swLTldKig/OnB4KT8kL2kudGVzdCggdmFsICkgJiYgL14tP1xkLy50ZXN0KCB2YWwgKSApIHsKCiAgICAgICAgICAgIC8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKICAgICAgICAgICAgbGVmdCA9IHN0eWxlLmxlZnQ7CgogICAgICAgICAgICAvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CiAgICAgICAgICAgIGlmICggcnNMZWZ0ICkgewogICAgICAgICAgICAgICAgZWwucnVudGltZVN0eWxlLmxlZnQgPSBlbC5jdXJyZW50U3R5bGUubGVmdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdHlsZS5sZWZ0ID0gYXR0cmlidXRlID09PSAiZm9udFNpemUiID8gIjFlbSIgOiAodmFsIHx8IDApOwogICAgICAgICAgICB2YWwgPSBzdHlsZS5waXhlbExlZnQgKyAicHgiOwoKICAgICAgICAgICAgLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwogICAgICAgICAgICBzdHlsZS5sZWZ0ID0gbGVmdDsKICAgICAgICAgICAgaWYgKCByc0xlZnQgKSB7CiAgICAgICAgICAgICAgICBlbC5ydW50aW1lU3R5bGUubGVmdCA9IHJzTGVmdDsKICAgICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIGlmICghL14odGhpbnxtZWRpdW18dGhpY2spJC9pLnRlc3QoIHZhbCApKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHBhcnNlRmxvYXQoIHZhbCApKSArICJweCI7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsOwoKICAgIH0KCgogICAgaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsKICAgICAgICBpZiAoIHByZXZpb3VzRWxlbWVudCAhPT0gZWwgKSB7CiAgICAgICAgICAgIGNvbXB1dGVkQ1NTID0gZG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgbnVsbCk7CiAgICAgICAgfQogICAgICAgIHZhbCA9IGNvbXB1dGVkQ1NTWyBhdHRyaWJ1dGUgXTsKCiAgICAgICAgaWYgKCBhdHRyaWJ1dGUgPT09ICJiYWNrZ3JvdW5kUG9zaXRpb24iICkgewoKICAgICAgICAgICAgdmFsID0gKHZhbC5zcGxpdCgiLCIpWzBdIHx8ICIwIDAiKS5zcGxpdCgiICIpOwoKICAgICAgICAgICAgdmFsWyAwIF0gPSAoIHZhbFswXS5pbmRleE9mKCAiJSIgKSA9PT0gLTEgKSA/IHRvUFgoICBhdHRyaWJ1dGUgKyAiWCIsIHZhbFsgMCBdICkgOiB2YWxbIDAgXTsKICAgICAgICAgICAgdmFsWyAxIF0gPSAoIHZhbFsxXSA9PT0gdW5kZWZpbmVkICkgPyB2YWxbMF0gOiB2YWxbMV07IC8vIElFIDkgZG9lc24ndCByZXR1cm4gZG91YmxlIGRpZ2l0IGFsd2F5cwogICAgICAgICAgICB2YWxbIDEgXSA9ICggdmFsWzFdLmluZGV4T2YoICIlIiApID09PSAtMSApID8gdG9QWCggIGF0dHJpYnV0ZSArICJZIiwgdmFsWyAxIF0gKSA6IHZhbFsgMSBdOwogICAgICAgIH0gZWxzZSBpZiAoIC9ib3JkZXIoVG9wfEJvdHRvbSkoTGVmdHxSaWdodClSYWRpdXMvLnRlc3QoIGF0dHJpYnV0ZSkgKSB7CiAgICAgICAgICAgIHZhciBhcnIgPSB2YWwuc3BsaXQoIiAiKTsKICAgICAgICAgICAgaWYgKCBhcnIubGVuZ3RoIDw9IDEgKSB7CiAgICAgICAgICAgICAgICBhcnJbIDEgXSA9IGFyclsgMCBdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFyclsgMCBdID0gcGFyc2VJbnQoIGFyclsgMCBdLCAxMCApOwogICAgICAgICAgICBhcnJbIDEgXSA9IHBhcnNlSW50KCBhcnJbIDEgXSwgMTAgKTsKICAgICAgICAgICAgdmFsID0gYXJyOwogICAgICAgIH0KCiAgICB9IGVsc2UgaWYgKCBlbC5jdXJyZW50U3R5bGUgKSB7CiAgICAgICAgLy8gSUUgOT4KICAgICAgICBpZiAoYXR0cmlidXRlID09PSAiYmFja2dyb3VuZFBvc2l0aW9uIikgewogICAgICAgICAgICAvLyBPbGRlciBJRSB1c2VzIC14IGFuZCAteQogICAgICAgICAgICB2YWwgPSBbIHRvUFgoICBhdHRyaWJ1dGUgKyAiWCIsIGVsLmN1cnJlbnRTdHlsZVsgYXR0cmlidXRlICsgIlgiIF0gICksIHRvUFgoICBhdHRyaWJ1dGUgKyAiWSIsIGVsLmN1cnJlbnRTdHlsZVsgYXR0cmlidXRlICsgIlkiIF0gICkgXTsKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgdmFsID0gdG9QWCggIGF0dHJpYnV0ZSwgZWwuY3VycmVudFN0eWxlWyBhdHRyaWJ1dGUgXSAgKTsKCiAgICAgICAgICAgIGlmICgvXihib3JkZXIpL2kudGVzdCggYXR0cmlidXRlICkgJiYgL14obWVkaXVtfHRoaW58dGhpY2spJC9pLnRlc3QoIHZhbCApKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHZhbCkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgInRoaW4iOgogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSAiMXB4IjsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAibWVkaXVtIjoKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gIjBweCI7IC8vIHRoaXMgaXMgd3JvbmcsIGl0IHNob3VsZCBiZSAzcHggYnV0IElFIHVzZXMgbWVkaXVtIGZvciBubyBib3JkZXIgYXMgd2VsbC4uIFRPRE8gZmluZCBhIHdvcmsgYXJvdW5kCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgInRoaWNrIjoKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gIjVweCI7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKCgogICAgfQoKCgoKICAgIHJldHVybiB2YWw7CgoKCi8vcmV0dXJuICQoZWwpLmNzcyhhdHRyaWJ1dGUpOwoKCn07CgoKX2h0bWwyY2FudmFzLlV0aWwuQmFja2dyb3VuZFBvc2l0aW9uID0gZnVuY3Rpb24gKCBlbCwgYm91bmRzLCBpbWFnZSApIHsKICAgIC8vIFRPRE8gYWRkIHN1cHBvcnQgZm9yIG11bHRpIGltYWdlIGJhY2tncm91bmRzCgogICAgdmFyIGJncG9zaXRpb24gPSAgX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTKCBlbCwgImJhY2tncm91bmRQb3NpdGlvbiIgKSAsCiAgICB0b3BQb3MsCiAgICBsZWZ0LAogICAgcGVyY2VudGFnZSwKICAgIHZhbDsKCiAgICBpZiAoYmdwb3NpdGlvbi5sZW5ndGggPT09IDEpewogICAgICAgIHZhbCA9IGJncG9zaXRpb247CgogICAgICAgIGJncG9zaXRpb24gPSBbXTsKCiAgICAgICAgYmdwb3NpdGlvblswXSA9IHZhbDsKICAgICAgICBiZ3Bvc2l0aW9uWzFdID0gdmFsOwogICAgfQoKCgogICAgaWYgKGJncG9zaXRpb25bMF0udG9TdHJpbmcoKS5pbmRleE9mKCIlIikgIT09IC0xKXsKICAgICAgICBwZXJjZW50YWdlID0gKHBhcnNlRmxvYXQoYmdwb3NpdGlvblswXSkvMTAwKTsKICAgICAgICBsZWZ0ID0gICgoYm91bmRzLndpZHRoICogcGVyY2VudGFnZSktKGltYWdlLndpZHRoKnBlcmNlbnRhZ2UpKTsKCiAgICB9ZWxzZXsKICAgICAgICBsZWZ0ID0gcGFyc2VJbnQoYmdwb3NpdGlvblswXSwxMCk7CiAgICB9CgogICAgaWYgKGJncG9zaXRpb25bMV0udG9TdHJpbmcoKS5pbmRleE9mKCIlIikgIT09IC0xKXsKCiAgICAgICAgcGVyY2VudGFnZSA9IChwYXJzZUZsb2F0KGJncG9zaXRpb25bMV0pLzEwMCk7CiAgICAgICAgdG9wUG9zID0gICgoYm91bmRzLmhlaWdodCAqIHBlcmNlbnRhZ2UpLShpbWFnZS5oZWlnaHQqcGVyY2VudGFnZSkpOwogICAgfWVsc2V7CiAgICAgICAgdG9wUG9zID0gcGFyc2VJbnQoYmdwb3NpdGlvblsxXSwxMCk7CiAgICB9CgoKCgogICAgcmV0dXJuIHsKICAgICAgICB0b3A6IHRvcFBvcywKICAgICAgICBsZWZ0OiBsZWZ0CiAgICB9OwoKfTsKCl9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZCA9IGZ1bmN0aW9uIChvcHRpb25zLCBkZWZhdWx0cykgewogICAgZm9yICh2YXIga2V5IGluIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgIGRlZmF1bHRzW2tleV0gPSBvcHRpb25zW2tleV07CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGRlZmF1bHRzOwp9OwoKCi8qCiAqIERlcml2ZWQgZnJvbSBqUXVlcnkuY29udGVudHMoKQogKiBDb3B5cmlnaHQgMjAxMCwgSm9obiBSZXNpZwogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKi8KX2h0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4gPSBmdW5jdGlvbiggZWxlbSApIHsKCgogICAgdmFyIGNoaWxkcmVuOwogICAgdHJ5IHsKCiAgICAgICAgY2hpbGRyZW4gPSAoZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvVXBwZXJDYXNlKCkgPT09ICJJRlJBTUUiKSA/CiAgICAgICAgZWxlbS5jb250ZW50RG9jdW1lbnQgfHwgZWxlbS5jb250ZW50V2luZG93LmRvY3VtZW50IDogKGZ1bmN0aW9uKCBhcnJheSApewogICAgICAgICAgICB2YXIgcmV0ID0gW107CgogICAgICAgICAgICBpZiAoIGFycmF5ICE9PSBudWxsICkgewoKICAgICAgICAgICAgICAgIChmdW5jdGlvbiggZmlyc3QsIHNlY29uZCApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IGZpcnN0Lmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICBqID0gMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCB0eXBlb2Ygc2Vjb25kLmxlbmd0aCA9PT0gIm51bWJlciIgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIHZhciBsID0gc2Vjb25kLmxlbmd0aDsgaiA8IGw7IGorKyApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0WyBpKysgXSA9IHNlY29uZFsgaiBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICggc2Vjb25kW2pdICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdFsgaSsrIF0gPSBzZWNvbmRbIGorKyBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmaXJzdC5sZW5ndGggPSBpOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmlyc3Q7CiAgICAgICAgICAgICAgICB9KSggcmV0LCBhcnJheSApOwoKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9KSggZWxlbS5jaGlsZE5vZGVzICk7CgogICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4gZmFpbGVkIHdpdGggZXhjZXB0aW9uOiAiICsgZXgubWVzc2FnZSk7CiAgICAgICAgY2hpbGRyZW4gPSBbXTsKICAgIH0KICAgIHJldHVybiBjaGlsZHJlbjsKfTsKCi8qCiAgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogIGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmgKCiAgQ29udHJpYnV0b3Iocyk6CiAgICAgIE5pa2xhcyB2b24gSGVydHplbiA8aHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aD4KICAgICAgQW5kcsOpIEZpZWRsZXIgICAgICA8aHR0cDovL3d3dy50d2l0dGVyLmNvbS9zb25uZW5raXN0ZT4KCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UKICovCgooZnVuY3Rpb24oKXsKCl9odG1sMmNhbnZhcy5HZW5lcmF0ZSA9IHt9OwoKdmFyIHJlR3JhZGllbnRzID0gWwogICAgL14oLXdlYmtpdC1saW5lYXItZ3JhZGllbnQpXCgoW2EtelxzXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgICAvXigtby1saW5lYXItZ3JhZGllbnQpXCgoW2EtelxzXSspKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgICAvXigtd2Via2l0LWdyYWRpZW50KVwoKGxpbmVhcnxyYWRpYWwpLFxzKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPyksXHMoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKShbXHdcZFwuXHMsJVwoXCktXSspXCkkLywKICAgIC9eKC1tb3otbGluZWFyLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpKFtcd1xkXC5ccywlXChcKV0rKVwpJC8sCiAgICAvXigtd2Via2l0LXJhZGlhbC1ncmFkaWVudClcKCgoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKSxccyhcdyspXHMoW2Etei1dKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAgIC9eKC1tb3otcmFkaWFsLWdyYWRpZW50KVwoKCg/OlxkezEsM30lPylccyg/OlxkezEsM30lPykpLFxzKFx3Kylccz8oW2Etei1dKikoW1x3XGRcLlxzLCVcKFwpXSspXCkkLywKICAgIC9eKC1vLXJhZGlhbC1ncmFkaWVudClcKCgoPzpcZHsxLDN9JT8pXHMoPzpcZHsxLDN9JT8pKSxccyhcdyspXHMoW2Etei1dKykoW1x3XGRcLlxzLCVcKFwpXSspXCkkLwpdOwoKLyoKICogVE9ETzogQWRkIElFMTAgdmVuZG9yIHByZWZpeCAoLW1zKSBzdXBwb3J0CiAqIFRPRE86IEFkZCBXM0MgZ3JhZGllbnQgKGxpbmVhci1ncmFkaWVudCkgc3VwcG9ydAogKiBUT0RPOiBBZGQgb2xkIFdlYmtpdCAtd2Via2l0LWdyYWRpZW50KHJhZGlhbCwgLi4uKSBzdXBwb3J0CiAqIFRPRE86IE1heWJlIHNvbWUgUmVnRXhwIG9wdGltaXphdGlvbnMgYXJlIHBvc3NpYmxlIDtvKQogKi8KX2h0bWwyY2FudmFzLkdlbmVyYXRlLnBhcnNlR3JhZGllbnQgPSBmdW5jdGlvbihjc3MsIGJvdW5kcykgewogICAgdmFyIGdyYWRpZW50LCBpLCBsZW4gPSByZUdyYWRpZW50cy5sZW5ndGgsIG0xLCBzdG9wLCBtMiwgbTJMZW4sIHN0ZXAsIG0zOwoKICAgIGZvcihpID0gMDsgaSA8IGxlbjsgaSs9MSl7CiAgICAgICAgbTEgPSBjc3MubWF0Y2gocmVHcmFkaWVudHNbaV0pOwogICAgICAgIGlmKG0xKSBicmVhazsKICAgIH0KCiAgICBpZihtMSkgewogICAgICAgIHN3aXRjaChtMVsxXSkgewogICAgICAgICAgICBjYXNlICctd2Via2l0LWxpbmVhci1ncmFkaWVudCc6CiAgICAgICAgICAgIGNhc2UgJy1vLWxpbmVhci1ncmFkaWVudCc6CgogICAgICAgICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2xpbmVhcicsCiAgICAgICAgICAgICAgICAgICAgeDA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgeTA6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgeDE6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgeTE6IG51bGwsCiAgICAgICAgICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzCiAgICAgICAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC9cdysvZyk7CiAgICAgICAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2gobTJbaV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3RvcCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxID0gYm91bmRzLmhlaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdyaWdodCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDAgPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2JvdHRvbSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSBib3VuZHMuaGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdsZWZ0JzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZihncmFkaWVudC54MCA9PT0gbnVsbCAmJiBncmFkaWVudC54MSA9PT0gbnVsbCl7IC8vIGNlbnRlcgogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngwID0gZ3JhZGllbnQueDEgPSBib3VuZHMud2lkdGggLyAyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYoZ3JhZGllbnQueTAgPT09IG51bGwgJiYgZ3JhZGllbnQueTEgPT09IG51bGwpeyAvLyBjZW50ZXIKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MCA9IGdyYWRpZW50LnkxID0gYm91bmRzLmhlaWdodCAvIDI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMKICAgICAgICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSg/OiV8cHgpKT8pKy9nKTsKICAgICAgICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7CiAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglfHB4KT8vKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbMl0pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbM10gPT09ICclJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBweCAtIHN0dXBpZCBvcGVyYQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgLz0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCA9IGkgKiBzdGVwOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSAnLXdlYmtpdC1ncmFkaWVudCc6CgogICAgICAgICAgICAgICAgZ3JhZGllbnQgPSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogbTFbMl0gPT09ICdyYWRpYWwnID8gJ2NpcmNsZScgOiBtMVsyXSwgLy8gVE9ETzogQWRkIHJhZGlhbCBncmFkaWVudCBzdXBwb3J0IGZvciBvbGRlciBtb3ppbGxhIGRlZmluaXRpb25zCiAgICAgICAgICAgICAgICAgICAgeDA6IDAsCiAgICAgICAgICAgICAgICAgICAgeTA6IDAsCiAgICAgICAgICAgICAgICAgICAgeDE6IDAsCiAgICAgICAgICAgICAgICAgICAgeTE6IDAsCiAgICAgICAgICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gZ2V0IGNvb3JkaW5hdGVzCiAgICAgICAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8sXHMoXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsKICAgICAgICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MCA9IChtMlsxXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTAgPSAobTJbMl0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSA9IChtMlszXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgPSAobTJbNF0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBnZXQgY29sb3JzIGFuZCBzdG9wcwogICAgICAgICAgICAgICAgbTIgPSBtMVs0XS5tYXRjaCgvKCg/OmZyb218dG98Y29sb3Itc3RvcClcKCg/OlswLTlcLl0rLFxzKT8oPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKVwpKSsvZyk7CiAgICAgICAgICAgICAgICBpZihtMil7CiAgICAgICAgICAgICAgICAgICAgbTJMZW4gPSBtMi5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oZnJvbXx0b3xjb2xvci1zdG9wKVwoKFswLTlcLl0rKT8oPzosXHMpPygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlcKS8pOwogICAgICAgICAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG0zWzFdID09PSAnZnJvbScpIHN0b3AgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKG0zWzFdID09PSAndG8nKSBzdG9wID0gMS4wOwogICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IG0zWzNdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcDogc3RvcAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJy1tb3otbGluZWFyLWdyYWRpZW50JzoKCiAgICAgICAgICAgICAgICBncmFkaWVudCA9IHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAnbGluZWFyJywKICAgICAgICAgICAgICAgICAgICB4MDogMCwKICAgICAgICAgICAgICAgICAgICB5MDogMCwKICAgICAgICAgICAgICAgICAgICB4MTogMCwKICAgICAgICAgICAgICAgICAgICB5MTogMCwKICAgICAgICAgICAgICAgICAgICBjb2xvclN0b3BzOiBbXQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBnZXQgY29vcmRpbmF0ZXMKICAgICAgICAgICAgICAgIG0yID0gbTFbMl0ubWF0Y2goLyhcZHsxLDN9KSU/XHMoXGR7MSwzfSklPy8pOwoKICAgICAgICAgICAgICAgIC8vIG0yWzFdID09IDAlICAgLT4gbGVmdAogICAgICAgICAgICAgICAgLy8gbTJbMV0gPT0gNTAlICAtPiBjZW50ZXIKICAgICAgICAgICAgICAgIC8vIG0yWzFdID09IDEwMCUgLT4gcmlnaHQKCiAgICAgICAgICAgICAgICAvLyBtMlsyXSA9PSAwJSAgIC0+IHRvcAogICAgICAgICAgICAgICAgLy8gbTJbMl0gPT0gNTAlICAtPiBjZW50ZXIKICAgICAgICAgICAgICAgIC8vIG0yWzJdID09IDEwMCUgLT4gYm90dG9tCgogICAgICAgICAgICAgICAgaWYobTIpewogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngwID0gKG0yWzFdICogYm91bmRzLndpZHRoKSAvIDEwMDsKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MCA9IChtMlsyXSAqIGJvdW5kcy5oZWlnaHQpIC8gMTAwOwogICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxID0gYm91bmRzLndpZHRoIC0gZ3JhZGllbnQueDA7CiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgPSBib3VuZHMuaGVpZ2h0IC0gZ3JhZGllbnQueTA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gZ2V0IGNvbG9ycyBhbmQgc3RvcHMKICAgICAgICAgICAgICAgIG0yID0gbTFbM10ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSUpPykrL2cpOwogICAgICAgICAgICAgICAgaWYobTIpewogICAgICAgICAgICAgICAgICAgIG0yTGVuID0gbTIubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIHN0ZXAgPSAxIC8gTWF0aC5tYXgobTJMZW4gLSAxLCAxKTsKICAgICAgICAgICAgICAgICAgICBmb3IoaSA9IDA7IGkgPCBtMkxlbjsgaSs9MSl7CiAgICAgICAgICAgICAgICAgICAgICAgIG0zID0gbTJbaV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSlccyooXGR7MSwzfSk/KCUpPy8pOwogICAgICAgICAgICAgICAgICAgICAgICBpZihtM1syXSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wID0gcGFyc2VGbG9hdChtM1syXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihtM1szXSl7IC8vIHBlcmNlbnRhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wIC89IDEwMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgPSBpICogc3RlcDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jb2xvclN0b3BzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sb3I6IG0zWzFdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcDogc3RvcAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgJy13ZWJraXQtcmFkaWFsLWdyYWRpZW50JzoKICAgICAgICAgICAgY2FzZSAnLW1vei1yYWRpYWwtZ3JhZGllbnQnOgogICAgICAgICAgICBjYXNlICctby1yYWRpYWwtZ3JhZGllbnQnOgoKICAgICAgICAgICAgICAgIGdyYWRpZW50ID0gewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICdjaXJjbGUnLAogICAgICAgICAgICAgICAgICAgIHgwOiAwLAogICAgICAgICAgICAgICAgICAgIHkwOiAwLAogICAgICAgICAgICAgICAgICAgIHgxOiBib3VuZHMud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgeTE6IGJvdW5kcy5oZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgY3g6IDAsCiAgICAgICAgICAgICAgICAgICAgY3k6IDAsCiAgICAgICAgICAgICAgICAgICAgcng6IDAsCiAgICAgICAgICAgICAgICAgICAgcnk6IDAsCiAgICAgICAgICAgICAgICAgICAgY29sb3JTdG9wczogW10KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gY2VudGVyCiAgICAgICAgICAgICAgICBtMiA9IG0xWzJdLm1hdGNoKC8oXGR7MSwzfSklP1xzKFxkezEsM30pJT8vKTsKICAgICAgICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCA9IChtMlsxXSAqIGJvdW5kcy53aWR0aCkgLyAxMDA7CiAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3kgPSAobTJbMl0gKiBib3VuZHMuaGVpZ2h0KSAvIDEwMDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBzaXplCiAgICAgICAgICAgICAgICBtMiA9IG0xWzNdLm1hdGNoKC9cdysvKTsKICAgICAgICAgICAgICAgIG0zID0gbTFbNF0ubWF0Y2goL1thLXotXSovKTsKICAgICAgICAgICAgICAgIGlmKG0yICYmIG0zKXsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2gobTNbMF0pewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdmYXJ0aGVzdC1jb3JuZXInOgogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjb3Zlcic6IC8vIGlzIGVxdWl2YWxlbnQgdG8gZmFydGhlc3QtY29ybmVyCiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJyc6IC8vIG1vemlsbGEgcmVtb3ZlcyAiY292ZXIiIGZyb20gZGVmaW5pdGlvbiA6KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJyID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1heCh0bCwgdHIsIGJyLCBibCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY2xvc2VzdC1jb3JuZXInOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LmN4LCAyKSArIE1hdGgucG93KGdyYWRpZW50LmN5LCAyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHIgPSBNYXRoLnNxcnQoTWF0aC5wb3coZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJyID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeSwgMikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJsID0gTWF0aC5zcXJ0KE1hdGgucG93KGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gsIDIpICsgTWF0aC5wb3coZ3JhZGllbnQuY3ksIDIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1pbih0bCwgdHIsIGJyLCBibCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZmFydGhlc3Qtc2lkZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihtMlswXSA9PT0gJ2NpcmNsZScpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ4ID0gZ3JhZGllbnQucnkgPSBNYXRoLm1heCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC54MSAtIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIGVsbGlwc2UKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQudHlwZSA9IG0yWzBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IE1hdGgubWF4KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnkgPSBNYXRoLm1heCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3ksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnkxIC0gZ3JhZGllbnQuY3kKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Nsb3Nlc3Qtc2lkZSc6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2NvbnRhaW4nOiAvLyBpcyBlcXVpdmFsZW50IHRvIGNsb3Nlc3Qtc2lkZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobTJbMF0gPT09ICdjaXJjbGUnKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5yeCA9IGdyYWRpZW50LnJ5ID0gTWF0aC5taW4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC5jeSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueDEgLSBncmFkaWVudC5jeCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQueTEgLSBncmFkaWVudC5jeQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBlbGxpcHNlCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnR5cGUgPSBtMlswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQucnggPSBNYXRoLm1pbigKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JhZGllbnQuY3gsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LngxIC0gZ3JhZGllbnQuY3gKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LnJ5ID0gTWF0aC5taW4oCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmN5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFkaWVudC55MSAtIGdyYWRpZW50LmN5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogYWRkIHN1cHBvcnQgZm9yICIzMHB4IDQwcHgiIHNpemVzICh3ZWJraXQgb25seSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gY29sb3Igc3RvcHMKICAgICAgICAgICAgICAgIG0yID0gbTFbNV0ubWF0Y2goLygoPzpyZ2J8cmdiYSlcKFxkezEsM30sXHNcZHsxLDN9LFxzXGR7MSwzfSg/Oixcc1swLTlcLl0rKT9cKSg/OlxzXGR7MSwzfSg/OiV8cHgpKT8pKy9nKTsKICAgICAgICAgICAgICAgIGlmKG0yKXsKICAgICAgICAgICAgICAgICAgICBtMkxlbiA9IG0yLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBzdGVwID0gMSAvIE1hdGgubWF4KG0yTGVuIC0gMSwgMSk7CiAgICAgICAgICAgICAgICAgICAgZm9yKGkgPSAwOyBpIDwgbTJMZW47IGkrPTEpewogICAgICAgICAgICAgICAgICAgICAgICBtMyA9IG0yW2ldLm1hdGNoKC8oKD86cmdifHJnYmEpXChcZHsxLDN9LFxzXGR7MSwzfSxcc1xkezEsM30oPzosXHNbMC05XC5dKyk/XCkpXHMqKFxkezEsM30pPyglfHB4KT8vKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbMl0pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCA9IHBhcnNlRmxvYXQobTNbMl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobTNbM10gPT09ICclJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCAvPSAxMDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBweCAtIHN0dXBpZCBvcGVyYQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0b3AgLz0gYm91bmRzLndpZHRoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCA9IGkgKiBzdGVwOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGdyYWRpZW50LmNvbG9yU3RvcHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvcjogbTNbMV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wOiBzdG9wCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZ3JhZGllbnQ7Cn07CgpfaHRtbDJjYW52YXMuR2VuZXJhdGUuR3JhZGllbnQgPSBmdW5jdGlvbihzcmMsIGJvdW5kcykgewogICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLAogICAgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyksCiAgICBncmFkaWVudCwgZ3JhZCwgaSwgbGVuLCBpbWc7CgogICAgY2FudmFzLndpZHRoID0gYm91bmRzLndpZHRoOwogICAgY2FudmFzLmhlaWdodCA9IGJvdW5kcy5oZWlnaHQ7CgogICAgLy8gVE9ETzogYWRkIHN1cHBvcnQgZm9yIG11bHRpIGRlZmluZWQgYmFja2dyb3VuZCBncmFkaWVudHMgKGxpa2UgcmFkaWFsIGdyYWRpZW50IGV4YW1wbGUgaW4gYmFja2dyb3VuZC5odG1sKQogICAgZ3JhZGllbnQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUucGFyc2VHcmFkaWVudChzcmMsIGJvdW5kcyk7CgogICAgaW1nID0gbmV3IEltYWdlKCk7CgogICAgaWYoZ3JhZGllbnQpewogICAgICAgIGlmKGdyYWRpZW50LnR5cGUgPT09ICdsaW5lYXInKXsKICAgICAgICAgICAgZ3JhZCA9IGN0eC5jcmVhdGVMaW5lYXJHcmFkaWVudChncmFkaWVudC54MCwgZ3JhZGllbnQueTAsIGdyYWRpZW50LngxLCBncmFkaWVudC55MSk7CgogICAgICAgICAgICBmb3IgKGkgPSAwLCBsZW4gPSBncmFkaWVudC5jb2xvclN0b3BzLmxlbmd0aDsgaSA8IGxlbjsgaSs9MSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBncmFkLmFkZENvbG9yU3RvcChncmFkaWVudC5jb2xvclN0b3BzW2ldLnN0b3AsIGdyYWRpZW50LmNvbG9yU3RvcHNbaV0uY29sb3IpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgIGgyY2xvZyhbJ2ZhaWxlZCB0byBhZGQgY29sb3Igc3RvcDogJywgZSwgJzsgdHJpZWQgdG8gYWRkOiAnLCBncmFkaWVudC5jb2xvclN0b3BzW2ldLCAnOyBzdG9wOiAnLCBpLCAnOyBpbjogJywgc3JjXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBncmFkOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0KTsKCiAgICAgICAgICAgIGltZy5zcmMgPSBjYW52YXMudG9EYXRhVVJMKCk7CiAgICAgICAgfSBlbHNlIGlmKGdyYWRpZW50LnR5cGUgPT09ICdjaXJjbGUnKXsKCiAgICAgICAgICAgIGdyYWQgPSBjdHguY3JlYXRlUmFkaWFsR3JhZGllbnQoZ3JhZGllbnQuY3gsIGdyYWRpZW50LmN5LCAwLCBncmFkaWVudC5jeCwgZ3JhZGllbnQuY3ksIGdyYWRpZW50LnJ4KTsKCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGdyYWRpZW50LmNvbG9yU3RvcHMubGVuZ3RoOyBpIDwgbGVuOyBpKz0xKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGdyYWQuYWRkQ29sb3JTdG9wKGdyYWRpZW50LmNvbG9yU3RvcHNbaV0uc3RvcCwgZ3JhZGllbnQuY29sb3JTdG9wc1tpXS5jb2xvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgaDJjbG9nKFsnZmFpbGVkIHRvIGFkZCBjb2xvciBzdG9wOiAnLCBlLCAnOyB0cmllZCB0byBhZGQ6ICcsIGdyYWRpZW50LmNvbG9yU3RvcHNbaV0sICc7IHN0b3A6ICcsIGksICc7IGluOiAnLCBzcmNdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWQ7CiAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQpOwoKICAgICAgICAgICAgaW1nLnNyYyA9IGNhbnZhcy50b0RhdGFVUkwoKTsKICAgICAgICB9IGVsc2UgaWYoZ3JhZGllbnQudHlwZSA9PT0gJ2VsbGlwc2UnKXsKCiAgICAgICAgICAgIC8vIGRyYXcgY2lyY2xlCiAgICAgICAgICAgIHZhciBjYW52YXNSYWRpYWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSwKICAgICAgICAgICAgICAgIGN0eFJhZGlhbCA9IGNhbnZhc1JhZGlhbC5nZXRDb250ZXh0KCcyZCcpLAogICAgICAgICAgICAgICAgcmkgPSBNYXRoLm1heChncmFkaWVudC5yeCwgZ3JhZGllbnQucnkpLAogICAgICAgICAgICAgICAgZGkgPSByaSAqIDIsIGltZ1JhZGlhbDsKCiAgICAgICAgICAgIGNhbnZhc1JhZGlhbC53aWR0aCA9IGNhbnZhc1JhZGlhbC5oZWlnaHQgPSBkaTsKCiAgICAgICAgICAgIGdyYWQgPSBjdHhSYWRpYWwuY3JlYXRlUmFkaWFsR3JhZGllbnQoZ3JhZGllbnQucngsIGdyYWRpZW50LnJ5LCAwLCBncmFkaWVudC5yeCwgZ3JhZGllbnQucnksIHJpKTsKCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGdyYWRpZW50LmNvbG9yU3RvcHMubGVuZ3RoOyBpIDwgbGVuOyBpKz0xKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGdyYWQuYWRkQ29sb3JTdG9wKGdyYWRpZW50LmNvbG9yU3RvcHNbaV0uc3RvcCwgZ3JhZGllbnQuY29sb3JTdG9wc1tpXS5jb2xvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgaDJjbG9nKFsnZmFpbGVkIHRvIGFkZCBjb2xvciBzdG9wOiAnLCBlLCAnOyB0cmllZCB0byBhZGQ6ICcsIGdyYWRpZW50LmNvbG9yU3RvcHNbaV0sICc7IHN0b3A6ICcsIGksICc7IGluOiAnLCBzcmNdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY3R4UmFkaWFsLmZpbGxTdHlsZSA9IGdyYWQ7CiAgICAgICAgICAgIGN0eFJhZGlhbC5maWxsUmVjdCgwLCAwLCBkaSwgZGkpOwoKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGdyYWRpZW50LmNvbG9yU3RvcHNbaSAtIDFdLmNvbG9yOwogICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsKCiAgICAgICAgICAgIGltZ1JhZGlhbCA9IG5ldyBJbWFnZSgpOwogICAgICAgICAgICBpbWdSYWRpYWwub25sb2FkID0gZnVuY3Rpb24oKSB7IC8vIHdhaXQgdW50aWwgdGhlIGltYWdlIGlzIGZpbGxlZAoKICAgICAgICAgICAgICAgIC8vIHRyYW5zZm9ybSBjaXJjbGUgdG8gZWxsaXBzZQogICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWdSYWRpYWwsIGdyYWRpZW50LmN4IC0gZ3JhZGllbnQucngsIGdyYWRpZW50LmN5IC0gZ3JhZGllbnQucnksIDIgKiBncmFkaWVudC5yeCwgMiAqIGdyYWRpZW50LnJ5KTsKCiAgICAgICAgICAgICAgICBpbWcuc3JjID0gY2FudmFzLnRvRGF0YVVSTCgpOwoKICAgICAgICAgICAgfQogICAgICAgICAgICBpbWdSYWRpYWwuc3JjID0gY2FudmFzUmFkaWFsLnRvRGF0YVVSTCgpOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gaW1nOwp9OwoKX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RBbHBoYSA9IGZ1bmN0aW9uKG51bWJlcikgewogICAgdmFyIHRtcCA9ICIiLAogICAgbW9kdWx1czsKCiAgICBkbyB7CiAgICAgICAgbW9kdWx1cyA9IG51bWJlciAlIDI2OwogICAgICAgIHRtcCA9IFN0cmluZy5mcm9tQ2hhckNvZGUoKG1vZHVsdXMpICsgNjQpICsgdG1wOwogICAgICAgIG51bWJlciA9IG51bWJlciAvIDI2OwogICAgfXdoaWxlKChudW1iZXIqMjYpID4gMjYpOwoKICAgIHJldHVybiB0bXA7Cn07CgpfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdFJvbWFuID0gZnVuY3Rpb24obnVtYmVyKSB7CiAgICB2YXIgcm9tYW5BcnJheSA9IFsiTSIsICJDTSIsICJEIiwgIkNEIiwgIkMiLCAiWEMiLCAiTCIsICJYTCIsICJYIiwgIklYIiwgIlYiLCAiSVYiLCAiSSJdLAogICAgZGVjaW1hbCA9IFsxMDAwLCA5MDAsIDUwMCwgNDAwLCAxMDAsIDkwLCA1MCwgNDAsIDEwLCA5LCA1LCA0LCAxXSwKICAgIHJvbWFuID0gIiIsCiAgICB2LAogICAgbGVuID0gcm9tYW5BcnJheS5sZW5ndGg7CgogICAgaWYgKG51bWJlciA8PSAwIHx8IG51bWJlciA+PSA0MDAwKSB7CiAgICAgICAgcmV0dXJuIG51bWJlcjsKICAgIH0KCiAgICBmb3IgKHY9MDsgdiA8IGxlbjsgdis9MSkgewogICAgICAgIHdoaWxlIChudW1iZXIgPj0gZGVjaW1hbFt2XSkgewogICAgICAgICAgICBudW1iZXIgLT0gZGVjaW1hbFt2XTsKICAgICAgICAgICAgcm9tYW4gKz0gcm9tYW5BcnJheVt2XTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJvbWFuOwoKfTsKCn0pKCk7Ci8qCiAgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogIGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmgKCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UKICovCgovKgogKiAgTmV3IGZ1bmN0aW9uIGZvciB0cmF2ZXJzaW5nIGVsZW1lbnRzCiAqLwoKX2h0bWwyY2FudmFzLlBhcnNlID0gZnVuY3Rpb24gKCBpbWFnZXMsIG9wdGlvbnMgKSB7CiAgICB3aW5kb3cuc2Nyb2xsKDAsMCk7CgogICAgdmFyIHN1cHBvcnQgPSB7CiAgICAgICAgcmFuZ2VCb3VuZHM6IGZhbHNlLAogICAgICAgIHN2Z1JlbmRlcmluZzogb3B0aW9ucy5zdmdSZW5kZXJpbmcgJiYgKGZ1bmN0aW9uKCApewogICAgICAgICAgICB2YXIgaW1nID0gbmV3IEltYWdlKCksCiAgICAgICAgICAgIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImNhbnZhcyIpLAogICAgICAgICAgICBjdHggPSAoY2FudmFzLmdldENvbnRleHQgPT09IHVuZGVmaW5lZCkgPyBmYWxzZSA6IGNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgICAgICAgICBpZiAoY3R4ID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgLy8gYnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgY2FudmFzLCBnb29kIGx1Y2sgc3VwcG9ydGluZyBTVkcgb24gY2FudmFzCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FudmFzLndpZHRoID0gY2FudmFzLmhlaWdodCA9IDEwOwogICAgICAgICAgICBpbWcuc3JjID0gWwogICAgICAgICAgICAiZGF0YTppbWFnZS9zdmcreG1sLCIsCiAgICAgICAgICAgICI8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJz4iLAogICAgICAgICAgICAiPGZvcmVpZ25PYmplY3Qgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJz4iLAogICAgICAgICAgICAiPGRpdiB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCcgc3R5bGU9J3dpZHRoOjEwO2hlaWdodDoxMDsnPiIsCiAgICAgICAgICAgICJzdXAiLAogICAgICAgICAgICAiPC9kaXY+IiwKICAgICAgICAgICAgIjwvZm9yZWlnbk9iamVjdD4iLAogICAgICAgICAgICAiPC9zdmc+IgogICAgICAgICAgICBdLmpvaW4oIiIpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDAsIDApOwogICAgICAgICAgICAgICAgY2FudmFzLnRvRGF0YVVSTCgpOwogICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBoMmNsb2coJ2h0bWwyY2FudmFzOiBQYXJzZTogU1ZHIHBvd2VyZWQgcmVuZGVyaW5nIGF2YWlsYWJsZScpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgICAgfSkoKQogICAgfSwKICAgIGVsZW1lbnQgPSAoKCBvcHRpb25zLmVsZW1lbnRzID09PSB1bmRlZmluZWQgKSA/IGRvY3VtZW50LmJvZHkgOiBvcHRpb25zLmVsZW1lbnRzWzBdKSwgLy8gc2VsZWN0IGJvZHkgYnkgZGVmYXVsdAogICAgbmVlZFJlb3JkZXIgPSBmYWxzZSwKICAgIG51bURyYXdzID0gMCwKICAgIGZvbnREYXRhID0ge30sCiAgICBkb2MgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQsCiAgICBpZ25vcmVFbGVtZW50c1JlZ0V4cCA9IG5ldyBSZWdFeHAoIigiICsgb3B0aW9ucy5pZ25vcmVFbGVtZW50cyArICIpIiksCiAgICBib2R5ID0gZG9jLmJvZHksCiAgICByLAogICAgdGVzdEVsZW1lbnQsCiAgICByYW5nZUJvdW5kcywKICAgIHJhbmdlSGVpZ2h0LAogICAgc3RhY2ssCiAgICBjdHgsCiAgICBkb2NEaW0sCiAgICBpLAogICAgY2hpbGRyZW4sCiAgICBjaGlsZHJlbkxlbjsKCgogICAgZnVuY3Rpb24gZG9jU2l6ZSgpewoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB3aWR0aDogTWF0aC5tYXgoCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5zY3JvbGxXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5zY3JvbGxXaWR0aCksCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5vZmZzZXRXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5vZmZzZXRXaWR0aCksCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5jbGllbnRXaWR0aCwgZG9jLmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCkKICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgIGhlaWdodDogTWF0aC5tYXgoCiAgICAgICAgICAgICAgICBNYXRoLm1heChkb2MuYm9keS5zY3JvbGxIZWlnaHQsIGRvYy5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsSGVpZ2h0KSwKICAgICAgICAgICAgICAgIE1hdGgubWF4KGRvYy5ib2R5Lm9mZnNldEhlaWdodCwgZG9jLmRvY3VtZW50RWxlbWVudC5vZmZzZXRIZWlnaHQpLAogICAgICAgICAgICAgICAgTWF0aC5tYXgoZG9jLmJvZHkuY2xpZW50SGVpZ2h0LCBkb2MuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkKICAgICAgICAgICAgICAgICkKICAgICAgICB9OwoKICAgIH0KCiAgICBpbWFnZXMgPSBpbWFnZXMgfHwge307CgogICAgLy8gVGVzdCB3aGV0aGVyIHdlIGNhbiB1c2UgcmFuZ2VzIHRvIG1lYXN1cmUgYm91bmRpbmcgYm94ZXMKICAgIC8vIE9wZXJhIGRvZXNuJ3QgcHJvdmlkZSB2YWxpZCBib3VuZHMuaGVpZ2h0L2JvdHRvbSBldmVuIHRob3VnaCBpdCBzdXBwb3J0cyB0aGUgbWV0aG9kLgoKCiAgICBpZiAoZG9jLmNyZWF0ZVJhbmdlKSB7CiAgICAgICAgciA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgICAgIC8vdGhpcy5zdXBwb3J0LnJhbmdlQm91bmRzID0gbmV3IEJvb2xlYW4oci5nZXRCb3VuZGluZ0NsaWVudFJlY3QpOwogICAgICAgIGlmIChyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCl7CiAgICAgICAgICAgIHRlc3RFbGVtZW50ID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2JvdW5kdGVzdCcpOwogICAgICAgICAgICB0ZXN0RWxlbWVudC5zdHlsZS5oZWlnaHQgPSAiMTIzcHgiOwogICAgICAgICAgICB0ZXN0RWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICAgICAgYm9keS5hcHBlbmRDaGlsZCh0ZXN0RWxlbWVudCk7CgogICAgICAgICAgICByLnNlbGVjdE5vZGUodGVzdEVsZW1lbnQpOwogICAgICAgICAgICByYW5nZUJvdW5kcyA9IHIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgICAgIHJhbmdlSGVpZ2h0ID0gcmFuZ2VCb3VuZHMuaGVpZ2h0OwoKICAgICAgICAgICAgaWYgKHJhbmdlSGVpZ2h0ID09PSAxMjMpIHsKICAgICAgICAgICAgICAgIHN1cHBvcnQucmFuZ2VCb3VuZHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJvZHkucmVtb3ZlQ2hpbGQodGVzdEVsZW1lbnQpOwoKCiAgICAgICAgfQoKICAgIH0KCgogICAgLyoKICAgIHZhciByb290U3RhY2sgPSBuZXcgdGhpcy5zdG9yYWdlQ29udGV4dCgkKGRvY3VtZW50KS53aWR0aCgpLCQoZG9jdW1lbnQpLmhlaWdodCgpKTsKICAgIHJvb3RTdGFjay5vcGFjaXR5ID0gdGhpcy5nZXRDU1ModGhpcy5lbGVtZW50LCJvcGFjaXR5Iik7CiAgICB2YXIgc3RhY2sgPSB0aGlzLm5ld0VsZW1lbnQodGhpcy5lbGVtZW50LHJvb3RTdGFjayk7CgoKICAgIHRoaXMucGFyc2VFbGVtZW50KHRoaXMuZWxlbWVudCxzdGFjayk7CiAgICAgKi8KCgoKCiAgICB2YXIgZ2V0Q1NTID0gX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTOwogICAgZnVuY3Rpb24gZ2V0Q1NTSW50KGVsZW1lbnQsIGF0dHJpYnV0ZSkgewogICAgICAgIHZhciB2YWwgPSBwYXJzZUludChnZXRDU1MoZWxlbWVudCwgYXR0cmlidXRlKSwgMTApOwogICAgICAgIHJldHVybiAoaXNOYU4odmFsKSkgPyAwIDogdmFsOyAvLyBib3JkZXJzIGluIG9sZCBJRSBhcmUgdGhyb3dpbmcgJ21lZGl1bScgZm9yIGRlbW8uaHRtbAogICAgfQoKICAgIC8vIERyYXdpbmcgYSByZWN0YW5nbGUKICAgIGZ1bmN0aW9uIHJlbmRlclJlY3QgKGN0eCwgeCwgeSwgdywgaCwgYmdjb2xvcikgewogICAgICAgIGlmICggYmdjb2xvciAhPT0gInRyYW5zcGFyZW50IiApewogICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoImZpbGxTdHlsZSIsIGJnY29sb3IpOwogICAgICAgICAgICBjdHguZmlsbFJlY3QgKHgsIHksIHcsIGgpOwogICAgICAgICAgICBudW1EcmF3cys9MTsKICAgICAgICB9CiAgICB9CgoKICAgIGZ1bmN0aW9uIHRleHRUcmFuc2Zvcm0gKHRleHQsIHRyYW5zZm9ybSkgewogICAgICAgIHN3aXRjaCh0cmFuc2Zvcm0pewogICAgICAgICAgICBjYXNlICJsb3dlcmNhc2UiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRleHQudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAgIGNhc2UgImNhcGl0YWxpemUiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSggLyhefFxzfDp8LXxcKHxcKSkoW2Etel0pL2cgLCBmdW5jdGlvbiAobSwgcDEsIHAyKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG0ubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcDEgKyBwMi50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gKTsKCiAgICAgICAgICAgIGNhc2UgInVwcGVyY2FzZSI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGV4dC50b1VwcGVyQ2FzZSgpOwoKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiB0ZXh0OwoKICAgICAgICB9CgogICAgfQoKICAgIGZ1bmN0aW9uIHRyaW1UZXh0ICh0ZXh0KSB7CiAgICAgICAgcmV0dXJuIHRleHQucmVwbGFjZSgvXlxzKi9nLCAiIikucmVwbGFjZSgvXHMqJC9nLCAiIik7CiAgICB9CgogICAgZnVuY3Rpb24gZm9udE1ldHJpY3MgKGZvbnQsIGZvbnRTaXplKSB7CgogICAgICAgIGlmIChmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGZvbnREYXRhW2ZvbnQgKyAiLSIgKyBmb250U2l6ZV07CiAgICAgICAgfQoKCiAgICAgICAgdmFyIGNvbnRhaW5lciA9IGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKSwKICAgICAgICBpbWcgPSBkb2MuY3JlYXRlRWxlbWVudCgnaW1nJyksCiAgICAgICAgc3BhbiA9IGRvYy5jcmVhdGVFbGVtZW50KCdzcGFuJyksCiAgICAgICAgYmFzZWxpbmUsCiAgICAgICAgbWlkZGxlLAogICAgICAgIG1ldHJpY3NPYmo7CgoKICAgICAgICBjb250YWluZXIuc3R5bGUudmlzaWJpbGl0eSA9ICJoaWRkZW4iOwogICAgICAgIGNvbnRhaW5lci5zdHlsZS5mb250RmFtaWx5ID0gZm9udDsKICAgICAgICBjb250YWluZXIuc3R5bGUuZm9udFNpemUgPSBmb250U2l6ZTsKICAgICAgICBjb250YWluZXIuc3R5bGUubWFyZ2luID0gMDsKICAgICAgICBjb250YWluZXIuc3R5bGUucGFkZGluZyA9IDA7CgogICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQoY29udGFpbmVyKTsKCgoKICAgICAgICAvLyBodHRwOi8vcHJvYmFibHlwcm9ncmFtbWluZy5jb20vMjAwOS8wMy8xNS90aGUtdGluaWVzdC1naWYtZXZlciAoaGFuZHRpbnl3aGl0ZS5naWYpCiAgICAgICAgaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQkFQLy8vd0FBQUN3QUFBQUFBUUFCQUFBQ0FrUUJBRHM9IjsKICAgICAgICBpbWcud2lkdGggPSAxOwogICAgICAgIGltZy5oZWlnaHQgPSAxOwoKICAgICAgICBpbWcuc3R5bGUubWFyZ2luID0gMDsKICAgICAgICBpbWcuc3R5bGUucGFkZGluZyA9IDA7CiAgICAgICAgaW1nLnN0eWxlLnZlcnRpY2FsQWxpZ24gPSAiYmFzZWxpbmUiOwoKICAgICAgICBzcGFuLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250OwogICAgICAgIHNwYW4uc3R5bGUuZm9udFNpemUgPSBmb250U2l6ZTsKICAgICAgICBzcGFuLnN0eWxlLm1hcmdpbiA9IDA7CiAgICAgICAgc3Bhbi5zdHlsZS5wYWRkaW5nID0gMDsKCgoKCiAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUoJ0hpZGRlbiBUZXh0JykpOwogICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChzcGFuKTsKICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoaW1nKTsKICAgICAgICBiYXNlbGluZSA9IChpbWcub2Zmc2V0VG9wIC0gc3Bhbi5vZmZzZXRUb3ApICsgMTsKCiAgICAgICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKHNwYW4pOwogICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChkb2MuY3JlYXRlVGV4dE5vZGUoJ0hpZGRlbiBUZXh0JykpOwoKICAgICAgICBjb250YWluZXIuc3R5bGUubGluZUhlaWdodCA9ICJub3JtYWwiOwogICAgICAgIGltZy5zdHlsZS52ZXJ0aWNhbEFsaWduID0gInN1cGVyIjsKCiAgICAgICAgbWlkZGxlID0gKGltZy5vZmZzZXRUb3AtY29udGFpbmVyLm9mZnNldFRvcCkgKyAxOwogICAgICAgIG1ldHJpY3NPYmogPSB7CiAgICAgICAgICAgIGJhc2VsaW5lOiBiYXNlbGluZSwKICAgICAgICAgICAgbGluZVdpZHRoOiAxLAogICAgICAgICAgICBtaWRkbGU6IG1pZGRsZQogICAgICAgIH07CgoKICAgICAgICBmb250RGF0YVtmb250ICsgIi0iICsgZm9udFNpemVdID0gbWV0cmljc09iajsKCiAgICAgICAgYm9keS5yZW1vdmVDaGlsZChjb250YWluZXIpOwoKICAgICAgICByZXR1cm4gbWV0cmljc09iajsKCiAgICB9CgoKICAgIGZ1bmN0aW9uIGRyYXdUZXh0KGN1cnJlbnRUZXh0LCB4LCB5LCBjdHgpewogICAgICAgIGlmICh0cmltVGV4dChjdXJyZW50VGV4dCkubGVuZ3RoPjApIHsKICAgICAgICAgICAgY3R4LmZpbGxUZXh0KGN1cnJlbnRUZXh0LHgseSk7CiAgICAgICAgICAgIG51bURyYXdzKz0xOwogICAgICAgIH0KICAgIH0KCgogICAgZnVuY3Rpb24gcmVuZGVyVGV4dChlbCwgdGV4dE5vZGUsIHN0YWNrKSB7CiAgICAgICAgdmFyIGN0eCA9IHN0YWNrLmN0eCwKICAgICAgICBmYW1pbHkgPSBnZXRDU1MoZWwsICJmb250RmFtaWx5IiksCiAgICAgICAgc2l6ZSA9IGdldENTUyhlbCwgImZvbnRTaXplIiksCiAgICAgICAgY29sb3IgPSBnZXRDU1MoZWwsICJjb2xvciIpLAogICAgICAgIHRleHRfZGVjb3JhdGlvbiA9IGdldENTUyhlbCwgInRleHREZWNvcmF0aW9uIiksCiAgICAgICAgdGV4dF9hbGlnbiA9IGdldENTUyhlbCwgInRleHRBbGlnbiIpLAogICAgICAgIGxldHRlcl9zcGFjaW5nID0gZ2V0Q1NTKGVsLCAibGV0dGVyU3BhY2luZyIpLAogICAgICAgIGJvdW5kcywKICAgICAgICB0ZXh0LAogICAgICAgIG1ldHJpY3MsCiAgICAgICAgcmVuZGVyTGlzdCwKICAgICAgICBsaXN0TGVuLAogICAgICAgIGJvbGQgPSBnZXRDU1MoZWwsICJmb250V2VpZ2h0IiksCiAgICAgICAgZm9udF9zdHlsZSA9IGdldENTUyhlbCwgImZvbnRTdHlsZSIpLAogICAgICAgIGZvbnRfdmFyaWFudCA9IGdldENTUyhlbCwgImZvbnRWYXJpYW50IiksCiAgICAgICAgYWxpZ24gPSBmYWxzZSwKICAgICAgICBuZXdUZXh0Tm9kZSwKICAgICAgICB0ZXh0VmFsdWUsCiAgICAgICAgdGV4dE9mZnNldCA9IDAsCiAgICAgICAgb2xkVGV4dE5vZGUsCiAgICAgICAgYywKICAgICAgICByYW5nZSwKICAgICAgICBwYXJlbnQsCiAgICAgICAgd3JhcEVsZW1lbnQsCiAgICAgICAgYmFja3VwVGV4dDsKCiAgICAgICAgLy8gYXBwbHkgdGV4dC10cmFuc2Zvcm06YXRpb24gdG8gdGhlIHRleHQKCgoKICAgICAgICB0ZXh0Tm9kZS5ub2RlVmFsdWUgPSB0ZXh0VHJhbnNmb3JtKHRleHROb2RlLm5vZGVWYWx1ZSwgZ2V0Q1NTKGVsLCAidGV4dFRyYW5zZm9ybSIpKTsKICAgICAgICB0ZXh0ID0gdHJpbVRleHQodGV4dE5vZGUubm9kZVZhbHVlKTsKCiAgICAgICAgaWYgKHRleHQubGVuZ3RoPjApewoKICAgICAgICAgICAgaWYgKHRleHRfZGVjb3JhdGlvbiAhPT0gIm5vbmUiKXsKICAgICAgICAgICAgICAgIG1ldHJpY3MgPSBmb250TWV0cmljcyhmYW1pbHksIHNpemUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0ZXh0X2FsaWduID0gdGV4dF9hbGlnbi5yZXBsYWNlKFsiLXdlYmtpdC1hdXRvIl0sWyJhdXRvIl0pOwoKICAgICAgICAgICAgaWYgKG9wdGlvbnMubGV0dGVyUmVuZGVyaW5nID09PSBmYWxzZSAmJiAvXihsZWZ0fHJpZ2h0fGp1c3RpZnl8YXV0bykkLy50ZXN0KHRleHRfYWxpZ24pICYmIC9eKG5vcm1hbHxub25lKSQvLnRlc3QobGV0dGVyX3NwYWNpbmcpKXsKICAgICAgICAgICAgICAgIC8vIHRoaXMuc2V0Q29udGV4dFZhcmlhYmxlKGN0eCwidGV4dEFsaWduIix0ZXh0X2FsaWduKTsKICAgICAgICAgICAgICAgIHJlbmRlckxpc3QgPSB0ZXh0Tm9kZS5ub2RlVmFsdWUuc3BsaXQoLyhcYnwgKS8pOwoKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAvLyAgdGhpcy5zZXRDb250ZXh0VmFyaWFibGUoY3R4LCJ0ZXh0QWxpZ24iLCJsZWZ0Iik7CiAgICAgICAgICAgICAgICByZW5kZXJMaXN0ID0gdGV4dE5vZGUubm9kZVZhbHVlLnNwbGl0KCIiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3dpdGNoKHBhcnNlSW50KGJvbGQsIDEwKSl7CiAgICAgICAgICAgICAgICBjYXNlIDQwMToKICAgICAgICAgICAgICAgICAgICBib2xkID0gImJvbGQiOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA0MDA6CiAgICAgICAgICAgICAgICAgICAgYm9sZCA9ICJub3JtYWwiOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoImZpbGxTdHlsZSIsIGNvbG9yKTsKCiAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgbmVlZCB0byBiZSBkZWZpbmVkIGluIHRoZSBvcmRlciBhcyBkZWZpbmVkIGluIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL2ZvbnRzLmh0bWwjZm9udC1zaG9ydGhhbmQKICAgICAgICAgICAgICB0byBwcm9wZXJseSB3b3JrIGluIEZpcmVmb3gKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSgiZm9udCIsIGZvbnRfc3R5bGUrICIgIiArIGZvbnRfdmFyaWFudCAgKyAiICIgKyBib2xkICsgIiAiICsgc2l6ZSArICIgIiArIGZhbWlseSk7CgogICAgICAgICAgICBpZiAoYWxpZ24pewogICAgICAgICAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJ0ZXh0QWxpZ24iLCAicmlnaHQiKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoInRleHRBbGlnbiIsICJsZWZ0Iik7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvKgogICAgICAgIGlmIChzdGFjay5jbGlwKXsKICAgICAgICBjdHgucmVjdCAoc3RhY2suY2xpcC5sZWZ0LCBzdGFjay5jbGlwLnRvcCwgc3RhY2suY2xpcC53aWR0aCwgc3RhY2suY2xpcC5oZWlnaHQpOwogICAgICAgIGN0eC5jbGlwKCk7CiAgICAgICAgfQogICAgICAgICAgICAgKi8KCgogICAgICAgICAgICBvbGRUZXh0Tm9kZSA9IHRleHROb2RlOwoKCiAgICAgICAgICAgIGZvciAoIGM9MCwgbGlzdExlbiA9IHJlbmRlckxpc3QubGVuZ3RoOyBjIDwgbGlzdExlbjsgYys9MSApIHsKICAgICAgICAgICAgICAgIHRleHRWYWx1ZSA9IG51bGw7CgoKCiAgICAgICAgICAgICAgICBpZiAoc3VwcG9ydC5yYW5nZUJvdW5kcyl7CiAgICAgICAgICAgICAgICAgICAgLy8gZ2V0Qm91bmRpbmdDbGllbnRSZWN0IGlzIHN1cHBvcnRlZCBmb3IgcmFuZ2VzCiAgICAgICAgICAgICAgICAgICAgaWYgKHRleHRfZGVjb3JhdGlvbiAhPT0gIm5vbmUiIHx8IHRyaW1UZXh0KHJlbmRlckxpc3RbY10pLmxlbmd0aCAhPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0VmFsdWUgPSByZW5kZXJMaXN0W2NdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG9jLmNyZWF0ZVJhbmdlKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlID0gZG9jLmNyZWF0ZVJhbmdlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0U3RhcnQodGV4dE5vZGUsIHRleHRPZmZzZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc2V0RW5kKHRleHROb2RlLCB0ZXh0T2Zmc2V0ICsgdGV4dFZhbHVlLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyBhZGQgSUUgc3VwcG9ydAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmFuZ2UgPSBib2R5LmNyZWF0ZVRleHRSYW5nZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmFuZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IHJhbmdlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIC8vIGl0IGlzbid0IHN1cHBvcnRlZCwgc28gbGV0J3Mgd3JhcCBpdCBpbnNpZGUgYW4gZWxlbWVudCBpbnN0ZWFkIGFuZCBnZXQgdGhlIGJvdW5kcyB0aGVyZQoKICAgICAgICAgICAgICAgICAgICAvLyBJRSA5IGJ1ZwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2xkVGV4dE5vZGUubm9kZVZhbHVlICE9PSAic3RyaW5nIiApewogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIG5ld1RleHROb2RlID0gb2xkVGV4dE5vZGUuc3BsaXRUZXh0KHJlbmRlckxpc3RbY10ubGVuZ3RoKTsKCiAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gb2xkVGV4dE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICB3cmFwRWxlbWVudCA9IGRvYy5jcmVhdGVFbGVtZW50KCd3cmFwcGVyJyk7CiAgICAgICAgICAgICAgICAgICAgYmFja3VwVGV4dCA9IG9sZFRleHROb2RlLmNsb25lTm9kZSh0cnVlKTsKCiAgICAgICAgICAgICAgICAgICAgd3JhcEVsZW1lbnQuYXBwZW5kQ2hpbGQob2xkVGV4dE5vZGUuY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKHdyYXBFbGVtZW50LCBvbGRUZXh0Tm9kZSk7CgogICAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IF9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyh3cmFwRWxlbWVudCk7CgogICAgICAgICAgICAgICAgICAgIHRleHRWYWx1ZSA9IG9sZFRleHROb2RlLm5vZGVWYWx1ZTsKCiAgICAgICAgICAgICAgICAgICAgb2xkVGV4dE5vZGUgPSBuZXdUZXh0Tm9kZTsKICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmVwbGFjZUNoaWxkKGJhY2t1cFRleHQsIHdyYXBFbGVtZW50KTsKCgogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0ZXh0VmFsdWUgIT09IG51bGwpewogICAgICAgICAgICAgICAgICAgIGRyYXdUZXh0KHRleHRWYWx1ZSwgYm91bmRzLmxlZnQsIGJvdW5kcy5ib3R0b20sIGN0eCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc3dpdGNoKHRleHRfZGVjb3JhdGlvbikgewogICAgICAgICAgICAgICAgICAgIGNhc2UgInVuZGVybGluZSI6CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERyYXdzIGEgbGluZSBhdCB0aGUgYmFzZWxpbmUgb2YgdGhlIGZvbnQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyBBcyBzb21lIGJyb3dzZXJzIGRpc3BsYXkgdGhlIGxpbmUgYXMgbW9yZSB0aGFuIDFweCBpZiB0aGUgZm9udC1zaXplIGlzIGJpZywgbmVlZCB0byB0YWtlIHRoYXQgaW50byBhY2NvdW50IGJvdGggaW4gcG9zaXRpb24gYW5kIHNpemUKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyUmVjdChjdHgsIGJvdW5kcy5sZWZ0LCBNYXRoLnJvdW5kKGJvdW5kcy50b3AgKyBtZXRyaWNzLmJhc2VsaW5lICsgbWV0cmljcy5saW5lV2lkdGgpLCBib3VuZHMud2lkdGgsIDEsIGNvbG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAib3ZlcmxpbmUiOgogICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJSZWN0KGN0eCwgYm91bmRzLmxlZnQsIGJvdW5kcy50b3AsIGJvdW5kcy53aWR0aCwgMSwgY29sb3IpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJsaW5lLXRocm91Z2giOgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPIHRyeSBhbmQgZmluZCBleGFjdCBwb3NpdGlvbiBmb3IgbGluZS10aHJvdWdoCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlclJlY3QoY3R4LCBib3VuZHMubGVmdCwgTWF0aC5jZWlsKGJvdW5kcy50b3AgKyBtZXRyaWNzLm1pZGRsZSArIG1ldHJpY3MubGluZVdpZHRoKSwgYm91bmRzLndpZHRoLCAxLCBjb2xvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgIH0KCgoKCgogICAgICAgICAgICAgICAgdGV4dE9mZnNldCArPSByZW5kZXJMaXN0W2NdLmxlbmd0aDsKCiAgICAgICAgICAgIH0KCgoKICAgICAgICB9CgogICAgfQoKICAgIGZ1bmN0aW9uIGxpc3RQb3NpdGlvbiAoZWxlbWVudCwgdmFsKSB7CiAgICAgICAgdmFyIGJvdW5kRWxlbWVudCA9IGRvYy5jcmVhdGVFbGVtZW50KCAiYm91bmRlbGVtZW50IiApLAogICAgICAgIHR5cGUsCiAgICAgICAgYm91bmRzOwoKICAgICAgICBib3VuZEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICJpbmxpbmUiOwogICAgICAgIC8vYm91bmRFbGVtZW50LnN0eWxlLndpZHRoID0gIjFweCI7CiAgICAgICAgLy9ib3VuZEVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gIjFweCI7CgogICAgICAgIHR5cGUgPSBlbGVtZW50LnN0eWxlLmxpc3RTdHlsZVR5cGU7CiAgICAgICAgZWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlID0gIm5vbmUiOwoKICAgICAgICBib3VuZEVsZW1lbnQuYXBwZW5kQ2hpbGQoIGRvYy5jcmVhdGVUZXh0Tm9kZSggdmFsICkgKTsKCgogICAgICAgIGVsZW1lbnQuaW5zZXJ0QmVmb3JlKGJvdW5kRWxlbWVudCwgZWxlbWVudC5maXJzdENoaWxkKTsKCgogICAgICAgIGJvdW5kcyA9IF9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyggYm91bmRFbGVtZW50ICk7CiAgICAgICAgZWxlbWVudC5yZW1vdmVDaGlsZCggYm91bmRFbGVtZW50ICk7CiAgICAgICAgZWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlID0gdHlwZTsKICAgICAgICByZXR1cm4gYm91bmRzOwoKICAgIH0KICAgIAoKICAgIAogICAgZnVuY3Rpb24gZWxlbWVudEluZGV4KCBlbCApIHsKICAgICAgICB2YXIgaSA9IC0xLAogICAgICAgIGNvdW50ID0gMSwKICAgICAgICBjaGlsZHMgPSBlbC5wYXJlbnROb2RlLmNoaWxkTm9kZXM7CgogICAgICAgIGlmICggZWwucGFyZW50Tm9kZSApIHsKICAgICAgICAgICAgd2hpbGUoIGNoaWxkc1sgKytpIF0gIT09IGVsICkgewogICAgICAgICAgICAgICAgaWYgKCBjaGlsZHNbIGkgXS5ub2RlVHlwZSA9PT0gMSApIHsKICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3VudDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgCiAgICB9CgogICAgZnVuY3Rpb24gcmVuZGVyTGlzdEl0ZW0oZWxlbWVudCwgc3RhY2ssIGVsQm91bmRzKSB7CgoKICAgICAgICB2YXIgcG9zaXRpb24gPSBnZXRDU1MoZWxlbWVudCwgImxpc3RTdHlsZVBvc2l0aW9uIiksCiAgICAgICAgeCwKICAgICAgICB5LAogICAgICAgIHR5cGUgPSBnZXRDU1MoZWxlbWVudCwgImxpc3RTdHlsZVR5cGUiKSwKICAgICAgICBjdXJyZW50SW5kZXgsCiAgICAgICAgdGV4dCwKICAgICAgICBsaXN0Qm91bmRzLAogICAgICAgIGJvbGQgPSBnZXRDU1MoZWxlbWVudCwgImZvbnRXZWlnaHQiKTsKCiAgICAgICAgaWYgKC9eKGRlY2ltYWx8ZGVjaW1hbC1sZWFkaW5nLXplcm98dXBwZXItYWxwaGF8dXBwZXItbGF0aW58dXBwZXItcm9tYW58bG93ZXItYWxwaGF8bG93ZXItZ3JlZWt8bG93ZXItbGF0aW58bG93ZXItcm9tYW4pJC9pLnRlc3QodHlwZSkpIHsKCiAgICAgICAgICAgIGN1cnJlbnRJbmRleCA9IGVsZW1lbnRJbmRleCggZWxlbWVudCApOwoKICAgICAgICAgICAgc3dpdGNoKHR5cGUpewogICAgICAgICAgICAgICAgY2FzZSAiZGVjaW1hbCI6CiAgICAgICAgICAgICAgICAgICAgdGV4dCA9IGN1cnJlbnRJbmRleDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImRlY2ltYWwtbGVhZGluZy16ZXJvIjoKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEluZGV4LnRvU3RyaW5nKCkubGVuZ3RoID09PSAxKXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IGN1cnJlbnRJbmRleCA9ICIwIiArIGN1cnJlbnRJbmRleC50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gY3VycmVudEluZGV4LnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidXBwZXItcm9tYW4iOgogICAgICAgICAgICAgICAgICAgIHRleHQgPSBfaHRtbDJjYW52YXMuR2VuZXJhdGUuTGlzdFJvbWFuKCBjdXJyZW50SW5kZXggKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImxvd2VyLXJvbWFuIjoKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RSb21hbiggY3VycmVudEluZGV4ICkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImxvd2VyLWFscGhhIjoKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RBbHBoYSggY3VycmVudEluZGV4ICkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInVwcGVyLWFscGhhIjoKICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkxpc3RBbHBoYSggY3VycmVudEluZGV4ICk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICB0ZXh0ICs9ICIuICI7CiAgICAgICAgICAgIGxpc3RCb3VuZHMgPSBsaXN0UG9zaXRpb24oZWxlbWVudCwgdGV4dCk7CgoKCiAgICAgICAgICAgIHN3aXRjaChib2xkKXsKICAgICAgICAgICAgICAgIGNhc2UgNDAxOgogICAgICAgICAgICAgICAgICAgIGJvbGQgPSAiYm9sZCI7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQwMDoKICAgICAgICAgICAgICAgICAgICBib2xkID0gIm5vcm1hbCI7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCgoKCiAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSggImZpbGxTdHlsZSIsIGdldENTUyhlbGVtZW50LCAiY29sb3IiKSApOwogICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoICJmb250IiwgZ2V0Q1NTKGVsZW1lbnQsICJmb250VmFyaWFudCIpICsgIiAiICsgYm9sZCArICIgIiArIGdldENTUyhlbGVtZW50LCAiZm9udFN0eWxlIikgKyAiICIgKyBnZXRDU1MoZWxlbWVudCwgImZvbnRTaXplIikgKyAiICIgKyBnZXRDU1MoZWxlbWVudCwgImZvbnRGYW1pbHkiKSApOwoKCiAgICAgICAgICAgIGlmICggcG9zaXRpb24gPT09ICJpbnNpZGUiICkgewogICAgICAgICAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJ0ZXh0QWxpZ24iLCAibGVmdCIpOwogICAgICAgICAgICAgICAgLy8gICB0aGlzLnNldEZvbnQoc3RhY2suY3R4LCBlbGVtZW50LCBmYWxzZSk7CiAgICAgICAgICAgICAgICB4ID0gZWxCb3VuZHMubGVmdDsKCiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgIFRPRE8gcmVhbGx5IG5lZWQgdG8gZmlndXJlIG91dCBzb21lIG1vcmUgYWNjdXJhdGUgd2F5IHRvIHRyeSBhbmQgZmluZCB0aGUgcG9zaXRpb24uCiAgICAgICAgICAgICAgICAgYXMgZGVmaW5lZCBpbiBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9nZW5lcmF0ZS5odG1sI3Byb3BkZWYtbGlzdC1zdHlsZS1wb3NpdGlvbiwgaXQgZG9lcyBub3QgZXZlbiBoYXZlIGEgc3BlY2lmaWVkICJjb3JyZWN0IiBwb3NpdGlvbiwgc28gZWFjaCBicm93c2VyCiAgICAgICAgICAgICAgICAgbWF5IGRpc3BsYXkgaXQgd2hhdGV2ZXIgd2F5IGl0IGZlZWxzIGxpa2UuCiAgICAgICAgICAgICAgICAgIlRoZSBwb3NpdGlvbiBvZiB0aGUgbGlzdC1pdGVtIG1hcmtlciBhZGphY2VudCB0byBmbG9hdHMgaXMgdW5kZWZpbmVkIGluIENTUyAyLjEuIENTUyAyLjEgZG9lcyBub3Qgc3BlY2lmeSB0aGUgcHJlY2lzZSBsb2NhdGlvbiBvZiB0aGUgbWFya2VyIGJveCBvciBpdHMgcG9zaXRpb24gaW4gdGhlIHBhaW50aW5nIG9yZGVyIgoKICAgICAgICAgICAgICAgIGN0eC5zZXRWYXJpYWJsZSgidGV4dEFsaWduIiwgInJpZ2h0Iik7CiAgICAgICAgICAgICAgICAvLyAgdGhpcy5zZXRGb250KHN0YWNrLmN0eCwgZWxlbWVudCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB4ID0gZWxCb3VuZHMubGVmdCAtIDEwOwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHkgPSBsaXN0Qm91bmRzLmJvdHRvbTsKCiAgICAgICAgICAgIGRyYXdUZXh0KHRleHQsIHgsIHksIGN0eCk7CgoKICAgICAgICB9CgoKICAgIH0KCiAgICBmdW5jdGlvbiBsb2FkSW1hZ2UgKHNyYyl7CiAgICAgICAgdmFyIGltZyA9IGltYWdlc1tzcmNdOwogICAgICAgIGlmIChpbWcgJiYgaW1nLnN1Y2NlZWRlZCA9PT0gdHJ1ZSkgewogICAgICAgICAgICByZXR1cm4gaW1nLmltZzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKCgoKCgogICAgZnVuY3Rpb24gY2xpcEJvdW5kcyhzcmMsIGRzdCl7CgogICAgICAgIHZhciB4ID0gTWF0aC5tYXgoc3JjLmxlZnQsIGRzdC5sZWZ0KSwKICAgICAgICB5ID0gTWF0aC5tYXgoc3JjLnRvcCwgZHN0LnRvcCksCiAgICAgICAgeDIgPSBNYXRoLm1pbigoc3JjLmxlZnQgKyBzcmMud2lkdGgpLCAoZHN0LmxlZnQgKyBkc3Qud2lkdGgpKSwKICAgICAgICB5MiA9IE1hdGgubWluKChzcmMudG9wICsgc3JjLmhlaWdodCksIChkc3QudG9wICsgZHN0LmhlaWdodCkpOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBsZWZ0OngsCiAgICAgICAgICAgIHRvcDp5LAogICAgICAgICAgICB3aWR0aDp4Mi14LAogICAgICAgICAgICBoZWlnaHQ6eTIteQogICAgICAgIH07CgogICAgfQoKICAgIGZ1bmN0aW9uIHNldFooekluZGV4LCBwYXJlbnRaKXsKICAgICAgICAvLyBUT0RPIGZpeCBzdGF0aWMgZWxlbWVudHMgb3ZlcmxhcHBpbmcgcmVsYXRpdmUvYWJzb2x1dGUgZWxlbWVudHMgdW5kZXIgc2FtZSBzdGFjaywgaWYgdGhleSBhcmUgZGVmaW5lZCBhZnRlciB0aGVtCiAgICAgICAgdmFyIG5ld0NvbnRleHQ7CiAgICAgICAgaWYgKCFwYXJlbnRaKXsKICAgICAgICAgICAgbmV3Q29udGV4dCA9IGgyY3pDb250ZXh0KDApOwogICAgICAgICAgICByZXR1cm4gbmV3Q29udGV4dDsKICAgICAgICB9CgogICAgICAgIGlmICh6SW5kZXggIT09ICJhdXRvIil7CiAgICAgICAgICAgIG5lZWRSZW9yZGVyID0gdHJ1ZTsKICAgICAgICAgICAgbmV3Q29udGV4dCA9IGgyY3pDb250ZXh0KHpJbmRleCk7CiAgICAgICAgICAgIHBhcmVudFouY2hpbGRyZW4ucHVzaChuZXdDb250ZXh0KTsKICAgICAgICAgICAgcmV0dXJuIG5ld0NvbnRleHQ7CgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHBhcmVudFo7CgogICAgfQoKICAgIGZ1bmN0aW9uIHJlbmRlckJvcmRlcnMoZWwsIGN0eCwgYm91bmRzLCBjbGlwKXsKCiAgICAgICAgLyoKICAgICAgICAgKiAgVE9ETyBhZGQgc3VwcG9ydCBmb3IgZGlmZmVyZW50IGJvcmRlci1zdHlsZSdzIHRoYW4gc29saWQKICAgICAgICAgKi8KCiAgICAgICAgdmFyIHggPSBib3VuZHMubGVmdCwKICAgICAgICB5ID0gYm91bmRzLnRvcCwKICAgICAgICB3ID0gYm91bmRzLndpZHRoLAogICAgICAgIGggPSBib3VuZHMuaGVpZ2h0LAogICAgICAgIGJvcmRlclNpZGUsCiAgICAgICAgYm9yZGVyRGF0YSwKICAgICAgICBieCwKICAgICAgICBieSwKICAgICAgICBidywKICAgICAgICBiaCwKICAgICAgICBydywKICAgICAgICBpLAogICAgICAgIGJvcmRlckFyZ3MsCiAgICAgICAgYm9yZGVyQm91bmRzLAogICAgICAgIGJvcmRlcnMgPSAoZnVuY3Rpb24oZWwpewogICAgICAgICAgICB2YXIgYm9yZGVycyA9IFtdLAogICAgICAgICAgICBzaWRlcyA9IFsiVG9wIiwiUmlnaHQiLCJCb3R0b20iLCJMZWZ0Il0sCiAgICAgICAgICAgIHM7CgogICAgICAgICAgICBmb3IgKHMgPSAwOyBzIDwgNDsgcys9MSl7CiAgICAgICAgICAgICAgICBib3JkZXJzLnB1c2goewogICAgICAgICAgICAgICAgICAgIHdpZHRoOiBnZXRDU1NJbnQoZWwsICdib3JkZXInICsgc2lkZXNbc10gKyAnV2lkdGgnKSwKICAgICAgICAgICAgICAgICAgICBjb2xvcjogZ2V0Q1NTKGVsLCAnYm9yZGVyJyArIHNpZGVzW3NdICsgJ0NvbG9yJykKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYm9yZGVyczsKCiAgICAgICAgfShlbCkpLAogICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL2NzczMtYmFja2dyb3VuZC8jdGhlLWJvcmRlci1yYWRpdXMKICAgICAgICBib3JkZXJSYWRpdXMgPSAoZnVuY3Rpb24oIGVsICkgewogICAgICAgICAgICB2YXIgYm9yZGVycyA9IFtdLAogICAgICAgICAgICBzaWRlcyA9IFsiVG9wTGVmdCIsIlRvcFJpZ2h0IiwiQm90dG9tUmlnaHQiLCJCb3R0b21MZWZ0Il0sCiAgICAgICAgICAgIHM7CiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgKHMgPSAwOyBzIDwgNDsgcys9MSl7CiAgICAgICAgICAgICAgICBib3JkZXJzLnB1c2goIGdldENTUyhlbCwgJ2JvcmRlcicgKyBzaWRlc1tzXSArICdSYWRpdXMnKSApOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gYm9yZGVyczsKICAgICAgICB9KSggZWwgKTsKCgoKICAgICAgICBmb3IgKCBib3JkZXJTaWRlID0gMDsgYm9yZGVyU2lkZSA8IDQ7IGJvcmRlclNpZGUrPTEgKSB7CiAgICAgICAgICAgIGJvcmRlckRhdGEgPSBib3JkZXJzWyBib3JkZXJTaWRlIF07CiAgICAgICAgICAgIGJvcmRlckFyZ3MgPSBbXTsKICAgICAgICAgICAgaWYgKGJvcmRlckRhdGEud2lkdGg+MCl7CiAgICAgICAgICAgICAgICBieCA9IHg7CiAgICAgICAgICAgICAgICBieSA9IHk7CiAgICAgICAgICAgICAgICBidyA9IHc7CiAgICAgICAgICAgICAgICBiaCA9IGggLSAoYm9yZGVyc1syXS53aWR0aCk7CgogICAgICAgICAgICAgICAgc3dpdGNoKGJvcmRlclNpZGUpewogICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG9wIGJvcmRlcgogICAgICAgICAgICAgICAgICAgICAgICBiaCA9IGJvcmRlcnNbMF0ud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJsaW5lIiwgYngsIGJ5IF07ICAvLyB0b3AgbGVmdAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCArIGJ3LCBieSBdOyAvLyB0b3AgcmlnaHQKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJsaW5lIiwgYnggKyBidyAtIGJvcmRlcnNbIDEgXS53aWR0aCwgYnkgKyBiaCAgXTsgLy8gYm90dG9tIHJpZ2h0CiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIGJ4ICsgYm9yZGVyc1sgMyBdLndpZHRoLCBieSArIGJoIF07IC8vIGJvdHRvbSBsZWZ0CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJpZ2h0IGJvcmRlcgogICAgICAgICAgICAgICAgICAgICAgICBieCA9IHggKyB3IC0gKGJvcmRlcnNbMV0ud2lkdGgpOwogICAgICAgICAgICAgICAgICAgICAgICBidyA9IGJvcmRlcnNbMV0ud2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJsaW5lIiwgYngsIGJ5ICsgYm9yZGVyc1sgMCBdLndpZHRoXTsgIC8vIHRvcCBsZWZ0CiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIGJ4ICsgYncsIGJ5IF07IC8vIHRvcCByaWdodAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCArIGJ3LCBieSArIGJoICsgYm9yZGVyc1sgMiBdLndpZHRoIF07IC8vIGJvdHRvbSByaWdodAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCwgYnkgKyBiaCBdOyAvLyBib3R0b20gbGVmdAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgICAgICAvLyBib3R0b20gYm9yZGVyCiAgICAgICAgICAgICAgICAgICAgICAgIGJ5ID0gKGJ5ICsgaCkgLSAoYm9yZGVyc1syXS53aWR0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJoID0gYm9yZGVyc1syXS53aWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgLyogICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvcCBsZWZ0CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggYm9yZGVyUmFkaXVzWyAzIF1bIDAgXSA+IDAgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnggKyBib3JkZXJzWyAzIF0ud2lkdGgsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnkgLSAoYm9yZGVyUmFkaXVzWyAzIF1bIDEgXSkgKyBib3JkZXJzWyAyIF0ud2lkdGgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07ICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJxdWFkcmF0aWNDdXJ2ZSIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnggKyBib3JkZXJzWyAzIF0ud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBieSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ4ICsgYm9yZGVyUmFkaXVzWyAzIF1bIDAgXSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBieSwgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdOyAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBydyA9ICggYm9yZGVyc1sgMyBdLndpZHRoID09PSAwICkgPyAxIDogYm9yZGVyc1sgMiBdLndpZHRoIC8gKGJvcmRlcnNbIDMgXS53aWR0aCArIGJvcmRlcnNbIDIgXS53aWR0aCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJsaW5lIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBieCArIChib3JkZXJSYWRpdXNbIDMgXVsgMCBdICogKCAxLXJ3ICkpLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5IC0gKGJvcmRlclJhZGl1c1sgMyBdWyAxIF0gLSBib3JkZXJzWyAyIF0ud2lkdGgpICsgKGJvcmRlclJhZGl1c1sgMyBdWyAxIF0gKiAoIDEtcncgKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07ICAKICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAicXVhZHJhdGljQ3VydmUiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ4ICsgYm9yZGVyc1sgMyBdLndpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBieCArIGJvcmRlcnNbIDMgXS53aWR0aCArIGJvcmRlclJhZGl1c1sgMyBdWyAwIF0sIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnksICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgXTsgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJiZXppZXJDdXJ2ZSIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnggKyAoYm9yZGVyUmFkaXVzWyAzIF1bIDAgXSAqICggMS1ydyApKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnggKyAoYm9yZGVyUmFkaXVzWyAzIF1bIDAgXSAqICggMS1ydyApKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnggKyBib3JkZXJzWyAzIF0ud2lkdGggKyBib3JkZXJSYWRpdXNbIDMgXVsgMCBdLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ5LCAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07ICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCArIGJvcmRlcnNbIDMgXS53aWR0aCwgYnkgXTsgCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIGJ4ICsgYm9yZGVyc1sgMyBdLndpZHRoLCBieSBdOyAKICAgICAgICAgICAgICAgICAgICAgICAgYm9yZGVyQXJnc1sgaSsrIF0gPSBbICJsaW5lIiwgYnggKyBidyAtIGJvcmRlcnNbIDIgXS53aWR0aCwgYnkgXTsgLy8gdG9wIHJpZ2h0CiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIGJ4ICsgYncsIGJ5ICsgYmggXTsgLy8gYm90dG9tIHJpZ2h0CiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIGJ4LCBieSArIGJoIF07IC8vIGJvdHRvbSBsZWZ0CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxlZnQgYm9yZGVyCiAgICAgICAgICAgICAgICAgICAgICAgIGJ3ID0gYm9yZGVyc1szXS53aWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCwgYnkgXTsgIC8vIHRvcCBsZWZ0CiAgICAgICAgICAgICAgICAgICAgICAgIGJvcmRlckFyZ3NbIGkrKyBdID0gWyAibGluZSIsIGJ4ICsgYncsIGJ5ICsgYm9yZGVyc1sgMCBdLndpZHRoIF07IC8vIHRvcCByaWdodAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCArIGJ3LCBieSArIGJoIF07IC8vIGJvdHRvbSByaWdodAogICAgICAgICAgICAgICAgICAgICAgICBib3JkZXJBcmdzWyBpKysgXSA9IFsgImxpbmUiLCBieCwgYnkgKyBiaCArIGJvcmRlcnNbIDIgXS53aWR0aCBdOyAvLyBib3R0b20gbGVmdAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYm9yZGVyQm91bmRzID0gewogICAgICAgICAgICAgICAgICAgIGxlZnQ6YngsCiAgICAgICAgICAgICAgICAgICAgdG9wOmJ5LAogICAgICAgICAgICAgICAgICAgIHdpZHRoOiBidywKICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6YmgKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKGNsaXApewogICAgICAgICAgICAgICAgICAgIGJvcmRlckJvdW5kcyA9IGNsaXBCb3VuZHMoYm9yZGVyQm91bmRzLCBjbGlwKTsKICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgaWYgKCBib3JkZXJCb3VuZHMud2lkdGggPiAwICYmIGJvcmRlckJvdW5kcy5oZWlnaHQgPiAwICkgewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICggYm9yZGVyRGF0YS5jb2xvciAhPT0gInRyYW5zcGFyZW50IiApewogICAgICAgICAgICAgICAgICAgICAgICBjdHguc2V0VmFyaWFibGUoICJmaWxsU3R5bGUiLCBib3JkZXJEYXRhLmNvbG9yICk7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2hhcGUgPSBjdHguZHJhd1NoYXBlKCksCiAgICAgICAgICAgICAgICAgICAgICAgIG51bUJvcmRlckFyZ3MgPSBib3JkZXJBcmdzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoIGkgPSAwOyBpIDwgbnVtQm9yZGVyQXJnczsgaSsrICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGVbKCBpID09PSAwKSA/ICJtb3ZlVG8iIDogYm9yZGVyQXJnc1sgaSBdWyAwIF0gKyAiVG8iIF0uYXBwbHkoIG51bGwsIGJvcmRlckFyZ3NbIGkgXS5zbGljZSgxKSApOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBudW1EcmF3cys9MTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gIHJlbmRlclJlY3QoY3R4LCBieCwgYnksIGJvcmRlckJvdW5kcy53aWR0aCwgYm9yZGVyQm91bmRzLmhlaWdodCwgYm9yZGVyRGF0YS5jb2xvcik7CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGJvcmRlcnM7CgogICAgfQoKCiAgICBmdW5jdGlvbiByZW5kZXJGb3JtVmFsdWUgKGVsLCBib3VuZHMsIHN0YWNrKXsKCiAgICAgICAgdmFyIHZhbHVlV3JhcCA9IGRvYy5jcmVhdGVFbGVtZW50KCd2YWx1ZXdyYXAnKSwKICAgICAgICBjc3NBcnIgPSBbJ2xpbmVIZWlnaHQnLCd0ZXh0QWxpZ24nLCdmb250RmFtaWx5JywnY29sb3InLCdmb250U2l6ZScsJ3BhZGRpbmdMZWZ0JywncGFkZGluZ1RvcCcsJ3dpZHRoJywnaGVpZ2h0JywnYm9yZGVyJywnYm9yZGVyTGVmdFdpZHRoJywnYm9yZGVyVG9wV2lkdGgnXSwKICAgICAgICBpLAogICAgICAgIHRleHRWYWx1ZSwKICAgICAgICB0ZXh0Tm9kZSwKICAgICAgICBhcnJMZW4sCiAgICAgICAgc3R5bGU7CgogICAgICAgIGZvciAoaSA9IDAsIGFyckxlbiA9IGNzc0Fyci5sZW5ndGg7IGkgPCBhcnJMZW47IGkrPTEpewogICAgICAgICAgICBzdHlsZSA9IGNzc0FycltpXTsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB2YWx1ZVdyYXAuc3R5bGVbc3R5bGVdID0gZ2V0Q1NTKGVsLCBzdHlsZSk7CiAgICAgICAgICAgIH0gY2F0Y2goIGUgKSB7CiAgICAgICAgICAgICAgICAvLyBPbGRlciBJRSBoYXMgaXNzdWVzIHdpdGggImJvcmRlciIKICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IFBhcnNlOiBFeGNlcHRpb24gY2F1Z2h0IGluIHJlbmRlckZvcm1WYWx1ZTogIiArIGUubWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKICAgICAgICB2YWx1ZVdyYXAuc3R5bGUuYm9yZGVyQ29sb3IgPSAiYmxhY2siOwogICAgICAgIHZhbHVlV3JhcC5zdHlsZS5ib3JkZXJTdHlsZSA9ICJzb2xpZCI7CiAgICAgICAgdmFsdWVXcmFwLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgIHZhbHVlV3JhcC5zdHlsZS5wb3NpdGlvbiA9ICJhYnNvbHV0ZSI7CiAgICAgICAgaWYgKC9eKHN1Ym1pdHxyZXNldHxidXR0b258dGV4dHxwYXNzd29yZCkkLy50ZXN0KGVsLnR5cGUpIHx8IGVsLm5vZGVOYW1lID09PSAiU0VMRUNUIil7CiAgICAgICAgICAgIHZhbHVlV3JhcC5zdHlsZS5saW5lSGVpZ2h0ID0gZ2V0Q1NTKGVsLCAiaGVpZ2h0Iik7CiAgICAgICAgfQoKCiAgICAgICAgdmFsdWVXcmFwLnN0eWxlLnRvcCA9IGJvdW5kcy50b3AgKyAicHgiOwogICAgICAgIHZhbHVlV3JhcC5zdHlsZS5sZWZ0ID0gYm91bmRzLmxlZnQgKyAicHgiOwoKICAgICAgICBpZiAoZWwubm9kZU5hbWUgPT09ICJTRUxFQ1QiKXsKICAgICAgICAgICAgLy8gVE9ETyBpbmNyZWFzZSBhY2N1cmFjeSBvZiB0ZXh0IHBvc2l0aW9uCiAgICAgICAgICAgIHRleHRWYWx1ZSA9IGVsLm9wdGlvbnNbZWwuc2VsZWN0ZWRJbmRleF0udGV4dDsKICAgICAgICB9IGVsc2V7CiAgICAgICAgICAgIHRleHRWYWx1ZSA9IGVsLnZhbHVlOwogICAgICAgIH0KICAgICAgICB0ZXh0Tm9kZSA9IGRvYy5jcmVhdGVUZXh0Tm9kZSh0ZXh0VmFsdWUpOwoKICAgICAgICB2YWx1ZVdyYXAuYXBwZW5kQ2hpbGQodGV4dE5vZGUpOwogICAgICAgIGJvZHkuYXBwZW5kQ2hpbGQodmFsdWVXcmFwKTsKCgogICAgICAgIHJlbmRlclRleHQoZWwsIHRleHROb2RlLCBzdGFjayk7CiAgICAgICAgYm9keS5yZW1vdmVDaGlsZCh2YWx1ZVdyYXApOwoKCgogICAgfQoKCgoKCiAgICBmdW5jdGlvbiByZW5kZXJJbWFnZSAoY3R4LCBpbWFnZSwgc3gsIHN5LCBzdywgc2gsIGR4LCBkeSwgZHcsIGRoKSB7CiAgICAgICAgY3R4LmRyYXdJbWFnZSgKICAgICAgICAgICAgaW1hZ2UsCiAgICAgICAgICAgIHN4LCAvL3N4CiAgICAgICAgICAgIHN5LCAvL3N5CiAgICAgICAgICAgIHN3LCAvL3N3CiAgICAgICAgICAgIHNoLCAvL3NoCiAgICAgICAgICAgIGR4LCAvL2R4CiAgICAgICAgICAgIGR5LCAvLyBkeQogICAgICAgICAgICBkdywgLy9kdwogICAgICAgICAgICBkaCAvL2RoCiAgICAgICAgICAgICk7CiAgICAgICAgbnVtRHJhd3MrPTE7CgogICAgfQoKCiAgICBmdW5jdGlvbiByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0IChjdHgsIGltYWdlLCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBlbHgsIGVseSl7CiAgICAgICAgdmFyIHNvdXJjZVggPSAwLAogICAgICAgIHNvdXJjZVk9MDsKICAgICAgICBpZiAoZWx4LXg+MCl7CiAgICAgICAgICAgIHNvdXJjZVggPSBlbHgteDsKICAgICAgICB9CgogICAgICAgIGlmIChlbHkteT4wKXsKICAgICAgICAgICAgc291cmNlWSA9IGVseS15OwogICAgICAgIH0KCiAgICAgICAgcmVuZGVySW1hZ2UoCiAgICAgICAgICAgIGN0eCwKICAgICAgICAgICAgaW1hZ2UsCiAgICAgICAgICAgIHNvdXJjZVgsIC8vIHNvdXJjZSBYCiAgICAgICAgICAgIHNvdXJjZVksIC8vIHNvdXJjZSBZCiAgICAgICAgICAgIHdpZHRoLXNvdXJjZVgsIC8vIHNvdXJjZSBXaWR0aAogICAgICAgICAgICBoZWlnaHQtc291cmNlWSwgLy8gc291cmNlIEhlaWdodAogICAgICAgICAgICB4K3NvdXJjZVgsIC8vIGRlc3RpbmF0aW9uIFgKICAgICAgICAgICAgeStzb3VyY2VZLCAvLyBkZXN0aW5hdGlvbiBZCiAgICAgICAgICAgIHdpZHRoLXNvdXJjZVgsIC8vIGRlc3RpbmF0aW9uIHdpZHRoCiAgICAgICAgICAgIGhlaWdodC1zb3VyY2VZIC8vIGRlc3RpbmF0aW9uIGhlaWdodAogICAgICAgICAgICApOwogICAgfQoKCiAgICBmdW5jdGlvbiByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0WSAoY3R4LCBpbWFnZSwgYmdwLCB4LCB5LCB3LCBoKXsKCiAgICAgICAgdmFyIGhlaWdodCwKICAgICAgICB3aWR0aCA9IE1hdGgubWluKGltYWdlLndpZHRoLHcpLGJneTsKCiAgICAgICAgYmdwLnRvcCA9IGJncC50b3AtTWF0aC5jZWlsKGJncC50b3AvaW1hZ2UuaGVpZ2h0KSppbWFnZS5oZWlnaHQ7CgoKICAgICAgICBmb3IoYmd5PSh5K2JncC50b3ApO2JneTxoK3k7KXsKCgogICAgICAgICAgICBpZiAoIE1hdGguZmxvb3IoYmd5K2ltYWdlLmhlaWdodCk+aCt5KXsKICAgICAgICAgICAgICAgIGhlaWdodCA9IChoK3kpLWJneTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICBoZWlnaHQgPSBpbWFnZS5oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdChjdHgsaW1hZ2UseCtiZ3AubGVmdCxiZ3ksd2lkdGgsaGVpZ2h0LHgseSk7CgogICAgICAgICAgICBiZ3kgPSBNYXRoLmZsb29yKGJneStpbWFnZS5oZWlnaHQpOwoKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcmVuZGVyQmFja2dyb3VuZFJlcGVhdFgoY3R4LCBpbWFnZSwgYmdwLCB4LCB5LCB3LCBoKXsKCiAgICAgICAgdmFyIGhlaWdodCA9IE1hdGgubWluKGltYWdlLmhlaWdodCxoKSwKICAgICAgICB3aWR0aCxiZ3g7CgoKICAgICAgICBiZ3AubGVmdCA9IGJncC5sZWZ0LU1hdGguY2VpbChiZ3AubGVmdC9pbWFnZS53aWR0aCkqaW1hZ2Uud2lkdGg7CgoKICAgICAgICBmb3IgKGJneD0oeCtiZ3AubGVmdCk7Ymd4PHcreDspIHsKCiAgICAgICAgICAgIGlmIChNYXRoLmZsb29yKGJneCtpbWFnZS53aWR0aCk+dyt4KXsKICAgICAgICAgICAgICAgIHdpZHRoID0gKHcreCktYmd4OwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHdpZHRoID0gaW1hZ2Uud2lkdGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlbmRlckJhY2tncm91bmRSZXBlYXQoY3R4LGltYWdlLGJneCwoeStiZ3AudG9wKSx3aWR0aCxoZWlnaHQseCx5KTsKCiAgICAgICAgICAgIGJneCA9IE1hdGguZmxvb3IoYmd4K2ltYWdlLndpZHRoKTsKCgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiByZW5kZXJCYWNrZ3JvdW5kKGVsLGJvdW5kcyxjdHgpewoKICAgICAgICAvLyBUT0RPIGFkZCBzdXBwb3J0IGZvciBtdWx0aSBiYWNrZ3JvdW5kLWltYWdlcwogICAgICAgIHZhciBiYWNrZ3JvdW5kX2ltYWdlID0gZ2V0Q1NTKGVsLCAiYmFja2dyb3VuZEltYWdlIiksCiAgICAgICAgYmFja2dyb3VuZF9yZXBlYXQgPSBnZXRDU1MoZWwsICJiYWNrZ3JvdW5kUmVwZWF0Iikuc3BsaXQoIiwiKVswXSwKICAgICAgICBpbWFnZSwKICAgICAgICBiZ3AsCiAgICAgICAgYmd5LAogICAgICAgIGJndywKICAgICAgICBiZ3N4LAogICAgICAgIGJnc3ksCiAgICAgICAgYmdkeCwKICAgICAgICBiZ2R5LAogICAgICAgIGJnaCwKICAgICAgICBoLAogICAgICAgIGhlaWdodCwKICAgICAgICBhZGQ7CgogICAgICAgIC8vICAgaWYgKHR5cGVvZiBiYWNrZ3JvdW5kX2ltYWdlICE9PSAidW5kZWZpbmVkIiAmJiAvXigxfG5vbmUpJC8udGVzdChiYWNrZ3JvdW5kX2ltYWdlKSA9PT0gZmFsc2UgJiYgL14oLXdlYmtpdHwtbW96fGxpbmVhci1ncmFkaWVudHwtby0pLy50ZXN0KGJhY2tncm91bmRfaW1hZ2UpPT09ZmFsc2UpewoKICAgICAgICBpZiAoICEvZGF0YTppbWFnZVwvLio7YmFzZTY0LC9pLnRlc3QoYmFja2dyb3VuZF9pbWFnZSkgJiYgIS9eKC13ZWJraXR8LW1venxsaW5lYXItZ3JhZGllbnR8LW8tKS8udGVzdChiYWNrZ3JvdW5kX2ltYWdlKSApIHsKICAgICAgICAgICAgYmFja2dyb3VuZF9pbWFnZSA9IGJhY2tncm91bmRfaW1hZ2Uuc3BsaXQoIiwiKVswXTsKICAgICAgICB9CgogICAgICAgIGlmICggdHlwZW9mIGJhY2tncm91bmRfaW1hZ2UgIT09ICJ1bmRlZmluZWQiICYmIC9eKDF8bm9uZSkkLy50ZXN0KCBiYWNrZ3JvdW5kX2ltYWdlICkgPT09IGZhbHNlICkgewogICAgICAgICAgICBiYWNrZ3JvdW5kX2ltYWdlID0gX2h0bWwyY2FudmFzLlV0aWwuYmFja2dyb3VuZEltYWdlKCBiYWNrZ3JvdW5kX2ltYWdlICk7CiAgICAgICAgICAgIGltYWdlID0gbG9hZEltYWdlKCBiYWNrZ3JvdW5kX2ltYWdlICk7CgoKICAgICAgICAgICAgYmdwID0gX2h0bWwyY2FudmFzLlV0aWwuQmFja2dyb3VuZFBvc2l0aW9uKGVsLCBib3VuZHMsIGltYWdlKTsKCiAgICAgICAgICAgIC8vIFRPRE8gYWRkIHN1cHBvcnQgZm9yIGJhY2tncm91bmQtb3JpZ2luCiAgICAgICAgICAgIGlmICggaW1hZ2UgKXsKICAgICAgICAgICAgICAgIHN3aXRjaCAoIGJhY2tncm91bmRfcmVwZWF0ICkgewoKICAgICAgICAgICAgICAgICAgICBjYXNlICJyZXBlYXQteCI6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckJhY2tncm91bmRSZXBlYXRYKCBjdHgsIGltYWdlLCBiZ3AsIGJvdW5kcy5sZWZ0LCBib3VuZHMudG9wLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQgKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgIGNhc2UgInJlcGVhdC15IjoKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyQmFja2dyb3VuZFJlcGVhdFkoIGN0eCwgaW1hZ2UsIGJncCwgYm91bmRzLmxlZnQsIGJvdW5kcy50b3AsIGJvdW5kcy53aWR0aCwgYm91bmRzLmhlaWdodCApOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgY2FzZSAibm8tcmVwZWF0IjoKICAgICAgICAgICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICAgICB0aGlzLmRyYXdCYWNrZ3JvdW5kUmVwZWF0KAogICAgICAgICAgICAgICAgICAgICAgICBjdHgsCiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLAogICAgICAgICAgICAgICAgICAgICAgICBiZ3AubGVmdCtib3VuZHMubGVmdCwgLy8gc3gKICAgICAgICAgICAgICAgICAgICAgICAgYmdwLnRvcCtib3VuZHMudG9wLCAvLyBzeQogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLm1pbihib3VuZHMud2lkdGgsaW1hZ2Uud2lkdGgpLAogICAgICAgICAgICAgICAgICAgICAgICBNYXRoLm1pbihib3VuZHMuaGVpZ2h0LGltYWdlLmhlaWdodCksCiAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcy5sZWZ0LAogICAgICAgICAgICAgICAgICAgICAgICBib3VuZHMudG9wCiAgICAgICAgICAgICAgICAgICAgICAgICk7Ki8KCgogICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBiZ3cgPSBib3VuZHMud2lkdGggLSBiZ3AubGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgYmdoID0gYm91bmRzLmhlaWdodCAtIGJncC50b3A7CiAgICAgICAgICAgICAgICAgICAgICAgIGJnc3ggPSBiZ3AubGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgYmdzeSA9IGJncC50b3A7CiAgICAgICAgICAgICAgICAgICAgICAgIGJnZHggPSBiZ3AubGVmdCtib3VuZHMubGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgYmdkeSA9IGJncC50b3ArYm91bmRzLnRvcDsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICBiZ3cgPSBNYXRoLm1pbihiZ3csaW1hZ2Uud2lkdGgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyAgYmdoID0gTWF0aC5taW4oYmdoLGltYWdlLmhlaWdodCk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmdzeDwwKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnc3ggPSBNYXRoLmFicyhiZ3N4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnZHggKz0gYmdzeDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJndyA9IE1hdGgubWluKGJvdW5kcy53aWR0aCxpbWFnZS53aWR0aC1iZ3N4KTsKICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3cgPSBNYXRoLm1pbihiZ3csaW1hZ2Uud2lkdGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdzeCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZ3N5PDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdzeSA9IE1hdGguYWJzKGJnc3kpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdkeSArPSBiZ3N5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmdoID0gYmdoLWJnc3k7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ2ggPSBNYXRoLm1pbihib3VuZHMuaGVpZ2h0LGltYWdlLmhlaWdodC1iZ3N5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ2ggPSBNYXRoLm1pbihiZ2gsaW1hZ2UuaGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnc3kgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJnaD4wICYmIGJndyA+IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVySW1hZ2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnc3gsIC8vIHNvdXJjZSBYIDogMAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJnc3ksIC8vIHNvdXJjZSBZIDogMTY5NQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJndywgLy8gc291cmNlIFdpZHRoIDogMTgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ2gsIC8vIHNvdXJjZSBIZWlnaHQgOiAxNjc3CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdkeCwgLy8gZGVzdGluYXRpb24gWCA6OTA2CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdkeSwgLy8gZGVzdGluYXRpb24gWSA6IDEwMjAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3csIC8vIGRlc3RpbmF0aW9uIHdpZHRoIDogMTgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ2ggLy8gZGVzdGluYXRpb24gaGVpZ2h0IDogMTY3NwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgoKCiAgICAgICAgICAgICAgICAgICAgICAgIGJncC50b3AgPSBiZ3AudG9wLU1hdGguY2VpbChiZ3AudG9wL2ltYWdlLmhlaWdodCkqaW1hZ2UuaGVpZ2h0OwoKCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihiZ3k9KGJvdW5kcy50b3ArYmdwLnRvcCk7Ymd5PGJvdW5kcy5oZWlnaHQrYm91bmRzLnRvcDspewoKCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaCA9IE1hdGgubWluKGltYWdlLmhlaWdodCwoYm91bmRzLmhlaWdodCtib3VuZHMudG9wKS1iZ3kpOwoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIE1hdGguZmxvb3IoYmd5K2ltYWdlLmhlaWdodCk+aCtiZ3kpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodCA9IChoK2JneSktYmd5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coaGVpZ2h0KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmd5PGJvdW5kcy50b3ApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZCA9IGJvdW5kcy50b3AtYmd5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJneSA9IGJvdW5kcy50b3A7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJCYWNrZ3JvdW5kUmVwZWF0WChjdHgsaW1hZ2UsYmdwLGJvdW5kcy5sZWZ0LGJneSxib3VuZHMud2lkdGgsaGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhZGQ+MCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdwLnRvcCArPSBhZGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZ3kgPSBNYXRoLmZsb29yKGJneStpbWFnZS5oZWlnaHQpLWFkZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IEVycm9yIGxvYWRpbmcgYmFja2dyb3VuZDoiICsgYmFja2dyb3VuZF9pbWFnZSk7CiAgICAgICAgICAgIC8vY29uc29sZS5sb2coaW1hZ2VzKTsKICAgICAgICAgICAgfQoKICAgICAgICB9CiAgICB9CgoKCiAgICBmdW5jdGlvbiByZW5kZXJFbGVtZW50KGVsLCBwYXJlbnRTdGFjayl7CgogICAgICAgIHZhciBib3VuZHMgPSBfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMoZWwpLAogICAgICAgIHggPSBib3VuZHMubGVmdCwKICAgICAgICB5ID0gYm91bmRzLnRvcCwKICAgICAgICB3ID0gYm91bmRzLndpZHRoLAogICAgICAgIGggPSBib3VuZHMuaGVpZ2h0LAogICAgICAgIGltYWdlLAogICAgICAgIGJnY29sb3IgPSBnZXRDU1MoZWwsICJiYWNrZ3JvdW5kQ29sb3IiKSwKICAgICAgICBjc3NQb3NpdGlvbiA9IGdldENTUyhlbCwgInBvc2l0aW9uIiksCiAgICAgICAgemluZGV4LAogICAgICAgIG9wYWNpdHkgPSBnZXRDU1MoZWwsICJvcGFjaXR5IiksCiAgICAgICAgc3RhY2ssCiAgICAgICAgc3RhY2tMZW5ndGgsCiAgICAgICAgYm9yZGVycywKICAgICAgICBjdHgsCiAgICAgICAgYmdib3VuZHMsCiAgICAgICAgaW1nU3JjLAogICAgICAgIHBhZGRpbmdMZWZ0LAogICAgICAgIHBhZGRpbmdUb3AsCiAgICAgICAgcGFkZGluZ1JpZ2h0LAogICAgICAgIHBhZGRpbmdCb3R0b207CgogICAgICAgIGlmICghcGFyZW50U3RhY2spewogICAgICAgICAgICBkb2NEaW0gPSBkb2NTaXplKCk7CiAgICAgICAgICAgIHBhcmVudFN0YWNrID0gewogICAgICAgICAgICAgICAgb3BhY2l0eTogMQogICAgICAgICAgICB9OwogICAgICAgIH1lbHNlewogICAgICAgICAgICBkb2NEaW0gPSB7fTsKICAgICAgICB9CgoKICAgICAgICAvL3ZhciB6aW5kZXggPSB0aGlzLmZvcm1hdFoodGhpcy5nZXRDU1MoZWwsInpJbmRleCIpLGNzc1Bvc2l0aW9uLHBhcmVudFN0YWNrLnpJbmRleCxlbC5wYXJlbnROb2RlKTsKCiAgICAgICAgemluZGV4ID0gc2V0WiggZ2V0Q1NTKCBlbCwgInpJbmRleCIpLCBwYXJlbnRTdGFjay56SW5kZXggKTsKCgoKICAgICAgICBzdGFjayA9IHsKICAgICAgICAgICAgY3R4OiBoMmNSZW5kZXJDb250ZXh0KCBkb2NEaW0ud2lkdGggfHwgdyAsIGRvY0RpbS5oZWlnaHQgfHwgaCApLAogICAgICAgICAgICB6SW5kZXg6IHppbmRleCwKICAgICAgICAgICAgb3BhY2l0eTogb3BhY2l0eSAqIHBhcmVudFN0YWNrLm9wYWNpdHksCiAgICAgICAgICAgIGNzc1Bvc2l0aW9uOiBjc3NQb3NpdGlvbgogICAgICAgIH07CgoKCiAgICAgICAgLy8gVE9ETyBjb3JyZWN0IG92ZXJmbG93IGZvciBhYnNvbHV0ZSBjb250ZW50IHJlc2lkaW5nIHVuZGVyIGEgc3RhdGljIHBvc2l0aW9uCgogICAgICAgIGlmIChwYXJlbnRTdGFjay5jbGlwKXsKICAgICAgICAgICAgc3RhY2suY2xpcCA9IF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZCgge30sIHBhcmVudFN0YWNrLmNsaXAgKTsKICAgICAgICAvL3N0YWNrLmNsaXAgPSBwYXJlbnRTdGFjay5jbGlwOwogICAgICAgIC8vICAgc3RhY2suY2xpcC5oZWlnaHQgPSBzdGFjay5jbGlwLmhlaWdodCAtIHBhcmVudFN0YWNrLmJvcmRlcnNbMl0ud2lkdGg7CiAgICAgICAgfQoKCiAgICAgICAgaWYgKCBvcHRpb25zLnVzZU92ZXJmbG93ID09PSB0cnVlICYmIC8oaGlkZGVufHNjcm9sbHxhdXRvKS8udGVzdChnZXRDU1MoZWwsICJvdmVyZmxvdyIpKSA9PT0gdHJ1ZSAmJiAvKEJPRFkpL2kudGVzdChlbC5ub2RlTmFtZSkgPT09IGZhbHNlICl7CiAgICAgICAgICAgIGlmIChzdGFjay5jbGlwKXsKICAgICAgICAgICAgICAgIHN0YWNrLmNsaXAgPSBjbGlwQm91bmRzKHN0YWNrLmNsaXAsIGJvdW5kcyk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgc3RhY2suY2xpcCA9IGJvdW5kczsKICAgICAgICAgICAgfQogICAgICAgIH0KCgogICAgICAgIHN0YWNrTGVuZ3RoID0gIHppbmRleC5jaGlsZHJlbi5wdXNoKHN0YWNrKTsKCiAgICAgICAgY3R4ID0gemluZGV4LmNoaWxkcmVuW3N0YWNrTGVuZ3RoLTFdLmN0eDsKCiAgICAgICAgY3R4LnNldFZhcmlhYmxlKCJnbG9iYWxBbHBoYSIsIHN0YWNrLm9wYWNpdHkpOwoKICAgICAgICAvLyBkcmF3IGVsZW1lbnQgYm9yZGVycwogICAgICAgIGJvcmRlcnMgPSByZW5kZXJCb3JkZXJzKGVsLCBjdHgsIGJvdW5kcywgZmFsc2UpOwogICAgICAgIHN0YWNrLmJvcmRlcnMgPSBib3JkZXJzOwoKCiAgICAgICAgLy8gbGV0J3MgbW9kaWZ5IGNsaXAgYXJlYSBmb3IgY2hpbGQgZWxlbWVudHMsIHNvIGJvcmRlcnMgZG9udCBnZXQgb3ZlcndyaXR0ZW4KCiAgICAgICAgLyoKICAgIGlmIChzdGFjay5jbGlwKXsKICAgICAgICBzdGFjay5jbGlwLndpZHRoID0gc3RhY2suY2xpcC53aWR0aC0oYm9yZGVyc1sxXS53aWR0aCk7CiAgICAgICAgc3RhY2suY2xpcC5oZWlnaHQgPSBzdGFjay5jbGlwLmhlaWdodC0oYm9yZGVyc1syXS53aWR0aCk7CiAgICB9CiAgICAgKi8KICAgICAgICBpZiAoaWdub3JlRWxlbWVudHNSZWdFeHAudGVzdChlbC5ub2RlTmFtZSkgJiYgb3B0aW9ucy5pZnJhbWVEZWZhdWx0ICE9PSAidHJhbnNwYXJlbnQiKXsKICAgICAgICAgICAgaWYgKG9wdGlvbnMuaWZyYW1lRGVmYXVsdCA9PT0gImRlZmF1bHQiKXsKICAgICAgICAgICAgICAgIGJnY29sb3IgPSAiI2VmZWZlZiI7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgYmdjb2xvciA9IG9wdGlvbnMuaWZyYW1lRGVmYXVsdDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gZHJhdyBiYXNlIGVsZW1lbnQgYmdjb2xvcgoKICAgICAgICBiZ2JvdW5kcyA9IHsKICAgICAgICAgICAgbGVmdDogeCArIGJvcmRlcnNbM10ud2lkdGgsCiAgICAgICAgICAgIHRvcDogeSArIGJvcmRlcnNbMF0ud2lkdGgsCiAgICAgICAgICAgIHdpZHRoOiB3IC0gKGJvcmRlcnNbMV0ud2lkdGggKyBib3JkZXJzWzNdLndpZHRoKSwKICAgICAgICAgICAgaGVpZ2h0OiBoIC0gKGJvcmRlcnNbMF0ud2lkdGggKyBib3JkZXJzWzJdLndpZHRoKQogICAgICAgIH07CgogICAgICAgIC8vaWYgKHRoaXMud2l0aGluQm91bmRzKHN0YWNrLmNsaXAsYmdib3VuZHMpKXsKCiAgICAgICAgaWYgKHN0YWNrLmNsaXApewogICAgICAgICAgICBiZ2JvdW5kcyA9IGNsaXBCb3VuZHMoYmdib3VuZHMsIHN0YWNrLmNsaXApOwoKICAgICAgICAvL30KCiAgICAgICAgfQoKCiAgICAgICAgaWYgKGJnYm91bmRzLmhlaWdodCA+IDAgJiYgYmdib3VuZHMud2lkdGggPiAwKXsKICAgICAgICAgICAgcmVuZGVyUmVjdCgKICAgICAgICAgICAgICAgIGN0eCwKICAgICAgICAgICAgICAgIGJnYm91bmRzLmxlZnQsCiAgICAgICAgICAgICAgICBiZ2JvdW5kcy50b3AsCiAgICAgICAgICAgICAgICBiZ2JvdW5kcy53aWR0aCwKICAgICAgICAgICAgICAgIGJnYm91bmRzLmhlaWdodCwKICAgICAgICAgICAgICAgIGJnY29sb3IKICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICByZW5kZXJCYWNrZ3JvdW5kKGVsLCBiZ2JvdW5kcywgY3R4KTsKICAgICAgICB9CgogICAgICAgIHN3aXRjaChlbC5ub2RlTmFtZSl7CiAgICAgICAgICAgIGNhc2UgIklNRyI6CiAgICAgICAgICAgICAgICBpbWdTcmMgPSBlbC5nZXRBdHRyaWJ1dGUoJ3NyYycpOwogICAgICAgICAgICAgICAgaW1hZ2UgPSBsb2FkSW1hZ2UoaW1nU3JjKTsKICAgICAgICAgICAgICAgIGlmIChpbWFnZSl7CgogICAgICAgICAgICAgICAgICAgIHBhZGRpbmdMZWZ0ID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ0xlZnQnKTsKICAgICAgICAgICAgICAgICAgICBwYWRkaW5nVG9wID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ1RvcCcpOwogICAgICAgICAgICAgICAgICAgIHBhZGRpbmdSaWdodCA9IGdldENTU0ludChlbCwgJ3BhZGRpbmdSaWdodCcpOwogICAgICAgICAgICAgICAgICAgIHBhZGRpbmdCb3R0b20gPSBnZXRDU1NJbnQoZWwsICdwYWRkaW5nQm90dG9tJyk7CgoKICAgICAgICAgICAgICAgICAgICByZW5kZXJJbWFnZSgKICAgICAgICAgICAgICAgICAgICAgICAgY3R4LAogICAgICAgICAgICAgICAgICAgICAgICBpbWFnZSwKICAgICAgICAgICAgICAgICAgICAgICAgMCwgLy9zeAogICAgICAgICAgICAgICAgICAgICAgICAwLCAvL3N5CiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLndpZHRoLCAvL3N3CiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLmhlaWdodCwgLy9zaAogICAgICAgICAgICAgICAgICAgICAgICB4ICsgcGFkZGluZ0xlZnQgKyBib3JkZXJzWzNdLndpZHRoLCAvL2R4CiAgICAgICAgICAgICAgICAgICAgICAgIHkgKyBwYWRkaW5nVG9wICsgYm9yZGVyc1swXS53aWR0aCwgLy8gZHkKICAgICAgICAgICAgICAgICAgICAgICAgYm91bmRzLndpZHRoIC0gKGJvcmRlcnNbMV0ud2lkdGggKyBib3JkZXJzWzNdLndpZHRoICsgcGFkZGluZ0xlZnQgKyBwYWRkaW5nUmlnaHQpLCAvL2R3CiAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kcy5oZWlnaHQgLSAoYm9yZGVyc1swXS53aWR0aCArIGJvcmRlcnNbMl0ud2lkdGggKyBwYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbSkgLy9kaAogICAgICAgICAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IEVycm9yIGxvYWRpbmcgPGltZz46IiArIGltZ1NyYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiSU5QVVQiOgogICAgICAgICAgICAgICAgLy8gVE9ETyBhZGQgYWxsIHJlbGV2YW50IHR5cGUncywgaS5lLiBIVE1MNSBuZXcgc3R1ZmYKICAgICAgICAgICAgICAgIC8vIHRvZG8gYWRkIHN1cHBvcnQgZm9yIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBmb3IgYnJvd3NlcnMgd2hpY2ggc3VwcG9ydCBpdAogICAgICAgICAgICAgICAgaWYgKC9eKHRleHR8dXJsfGVtYWlsfHN1Ym1pdHxidXR0b258cmVzZXQpJC8udGVzdChlbC50eXBlKSAmJiBlbC52YWx1ZS5sZW5ndGggPiAwKXsKCiAgICAgICAgICAgICAgICAgICAgcmVuZGVyRm9ybVZhbHVlKGVsLCBib3VuZHMsIHN0YWNrKTsKCgogICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgICAgICB0aGlzIGp1c3QgZG9lc24ndCB3b3JrIHdlbGwgZW5vdWdoCgogICAgICAgICAgICAgICAgdGhpcy5uZXdUZXh0KGVsLHsKICAgICAgICAgICAgICAgICAgICBub2RlVmFsdWU6ZWwudmFsdWUsCiAgICAgICAgICAgICAgICAgICAgc3BsaXRUZXh0OiBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGZvcm1WYWx1ZTp0cnVlCiAgICAgICAgICAgICAgICB9LHN0YWNrKTsKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIlRFWFRBUkVBIjoKICAgICAgICAgICAgICAgIGlmIChlbC52YWx1ZS5sZW5ndGggPiAwKXsKICAgICAgICAgICAgICAgICAgICByZW5kZXJGb3JtVmFsdWUoZWwsIGJvdW5kcywgc3RhY2spOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIlNFTEVDVCI6CiAgICAgICAgICAgICAgICBpZiAoZWwub3B0aW9ucy5sZW5ndGggPiAwKXsKICAgICAgICAgICAgICAgICAgICByZW5kZXJGb3JtVmFsdWUoZWwsIGJvdW5kcywgc3RhY2spOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIkxJIjoKICAgICAgICAgICAgICAgIHJlbmRlckxpc3RJdGVtKGVsLCBzdGFjaywgYmdib3VuZHMpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIkNBTlZBUyI6CiAgICAgICAgICAgICAgICBwYWRkaW5nTGVmdCA9IGdldENTU0ludChlbCwgJ3BhZGRpbmdMZWZ0Jyk7CiAgICAgICAgICAgICAgICBwYWRkaW5nVG9wID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ1RvcCcpOwogICAgICAgICAgICAgICAgcGFkZGluZ1JpZ2h0ID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ1JpZ2h0Jyk7CiAgICAgICAgICAgICAgICBwYWRkaW5nQm90dG9tID0gZ2V0Q1NTSW50KGVsLCAncGFkZGluZ0JvdHRvbScpOwogICAgICAgICAgICAgICAgcmVuZGVySW1hZ2UoCiAgICAgICAgICAgICAgICAgICAgY3R4LAogICAgICAgICAgICAgICAgICAgIGVsLAogICAgICAgICAgICAgICAgICAgIDAsIC8vc3gKICAgICAgICAgICAgICAgICAgICAwLCAvL3N5CiAgICAgICAgICAgICAgICAgICAgZWwud2lkdGgsIC8vc3cKICAgICAgICAgICAgICAgICAgICBlbC5oZWlnaHQsIC8vc2gKICAgICAgICAgICAgICAgICAgICB4ICsgcGFkZGluZ0xlZnQgKyBib3JkZXJzWzNdLndpZHRoLCAvL2R4CiAgICAgICAgICAgICAgICAgICAgeSArIHBhZGRpbmdUb3AgKyBib3JkZXJzWzBdLndpZHRoLCAvLyBkeQogICAgICAgICAgICAgICAgICAgIGJvdW5kcy53aWR0aCAtIChib3JkZXJzWzFdLndpZHRoICsgYm9yZGVyc1szXS53aWR0aCArIHBhZGRpbmdMZWZ0ICsgcGFkZGluZ1JpZ2h0KSwgLy9kdwogICAgICAgICAgICAgICAgICAgIGJvdW5kcy5oZWlnaHQgLSAoYm9yZGVyc1swXS53aWR0aCArIGJvcmRlcnNbMl0ud2lkdGggKyBwYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbSkgLy9kaAogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIHJldHVybiB6aW5kZXguY2hpbGRyZW5bc3RhY2tMZW5ndGggLSAxXTsKICAgIH0KCgoKICAgIGZ1bmN0aW9uIHBhcnNlRWxlbWVudCAoZWwsIHN0YWNrKSB7CgogICAgICAgIC8vIHNraXAgaGlkZGVuIGVsZW1lbnRzIGFuZCB0aGVpciBjaGlsZHJlbgogICAgICAgIGlmIChnZXRDU1MoZWwsICdkaXNwbGF5JykgIT09ICJub25lIiAmJiBnZXRDU1MoZWwsICd2aXNpYmlsaXR5JykgIT09ICJoaWRkZW4iICYmICFlbC5oYXNBdHRyaWJ1dGUoImRhdGEtaHRtbDJjYW52YXMtaWdub3JlIikgKSB7CgogICAgICAgICAgICBzdGFjayA9IHJlbmRlckVsZW1lbnQoZWwsIHN0YWNrKSB8fCBzdGFjazsKCiAgICAgICAgICAgIGN0eCA9IHN0YWNrLmN0eDsKCiAgICAgICAgICAgIGlmICggIWlnbm9yZUVsZW1lbnRzUmVnRXhwLnRlc3QoIGVsLm5vZGVOYW1lICkgKSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudENoaWxkcmVuID0gX2h0bWwyY2FudmFzLlV0aWwuQ2hpbGRyZW4oIGVsICksCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICAgIGNoaWxkcmVuTGVuOwogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgY2hpbGRyZW5MZW4gPSBlbGVtZW50Q2hpbGRyZW4ubGVuZ3RoOyBpIDwgY2hpbGRyZW5MZW47IGkrPTEpIHsKICAgICAgICAgICAgICAgICAgICBub2RlID0gZWxlbWVudENoaWxkcmVuW2ldOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnNlRWxlbWVudChub2RlLCBzdGFjayk7CiAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYgKCBub2RlLm5vZGVUeXBlID09PSAzICkgewogICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJUZXh0KGVsLCBub2RlLCBzdGFjayk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0KICAgICAgICB9IAogICAgfQoKICAgIHN0YWNrID0gcmVuZGVyRWxlbWVudChlbGVtZW50LCBudWxsKTsKCiAgICAvKgogICAgU1ZHIHBvd2VyZWQgSFRNTCByZW5kZXJpbmcsIG5vbi10YWludGVkIGNhbnZhcyBhdmFpbGFibGUgZnJvbSBGRiAxMSsgb253YXJkcwogKi8KCiAgICBpZiAoIHN1cHBvcnQuc3ZnUmVuZGVyaW5nICkgewogICAgICAgIChmdW5jdGlvbiggYm9keSApewogICAgICAgICAgICB2YXIgaW1nID0gbmV3IEltYWdlKCksCiAgICAgICAgICAgIHNpemUgPSAgZG9jU2l6ZSgpLAogICAgICAgICAgICBodG1sID0gIiI7CgogICAgICAgICAgICBmdW5jdGlvbiBwYXJzZURPTSggZWwgKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBfaHRtbDJjYW52YXMuVXRpbC5DaGlsZHJlbiggZWwgKSwKICAgICAgICAgICAgICAgIGxlbiA9IGNoaWxkcmVuLmxlbmd0aCwKICAgICAgICAgICAgICAgIGF0dHIsCiAgICAgICAgICAgICAgICBhLAogICAgICAgICAgICAgICAgYWxlbiwKICAgICAgICAgICAgICAgIGVsbSwKICAgICAgICAgICAgICAgIGk7CiAgICAgICAgICAgICAgICBmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSs9MSApIHsKICAgICAgICAgICAgICAgICAgICBlbG0gPSBjaGlsZHJlblsgaSBdOwogICAgICAgICAgICAgICAgICAgIGlmICggZWxtLm5vZGVUeXBlID09PSAzICkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBUZXh0IG5vZGUKCiAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgKz0gZWxtLm5vZGVWYWx1ZS5yZXBsYWNlKC9cPC9nLCImbHQ7IikucmVwbGFjZSgvXD4vZywiJmd0OyIpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIGVsbS5ub2RlVHlwZSA9PT0gMSApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoICEvXihzY3JpcHR8bWV0YXx0aXRsZSkkLy50ZXN0KGVsbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKSApIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sICs9ICI8IiArIGVsbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFkZCBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIGVsbS5oYXNBdHRyaWJ1dGVzKCkgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXR0ciA9IGVsbS5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsZW4gPSBhdHRyLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKCBhID0gMDsgYSA8IGFsZW47IGErPTEgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgKz0gIiAiICsgYXR0clsgYSBdLm5hbWUgKyAnPSInICsgYXR0clsgYSBdLnZhbHVlICsgJyInOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCArPSAnPic7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyc2VET00oIGVsbSApOwoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sICs9ICI8LyIgKyBlbG0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSArICI+IjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9CgogICAgICAgICAgICBwYXJzZURPTSggYm9keSApOwogICAgICAgICAgICBpbWcuc3JjID0gWwogICAgICAgICAgICAiZGF0YTppbWFnZS9zdmcreG1sLCIsCiAgICAgICAgICAgICI8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZycgdmVyc2lvbj0nMS4xJyB3aWR0aD0nIiArIHNpemUud2lkdGggKyAiJyBoZWlnaHQ9JyIgKyBzaXplLmhlaWdodCArICInPiIsCiAgICAgICAgICAgICI8Zm9yZWlnbk9iamVjdCB3aWR0aD0nIiArIHNpemUud2lkdGggKyAiJyBoZWlnaHQ9JyIgKyBzaXplLmhlaWdodCArICInPiIsCiAgICAgICAgICAgICI8aHRtbCB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCcgc3R5bGU9J21hcmdpbjowOyc+IiwKICAgICAgICAgICAgaHRtbC5yZXBsYWNlKC9cIy9nLCIlMjMiKSwKICAgICAgICAgICAgIjwvaHRtbD4iLAogICAgICAgICAgICAiPC9mb3JlaWduT2JqZWN0PiIsCiAgICAgICAgICAgICI8L3N2Zz4iCiAgICAgICAgICAgIF0uam9pbigiIik7CgoKCgogICAgICAgICAgICBpbWcub25sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBzdGFjay5zdmdSZW5kZXIgPSBpbWc7CiAgICAgICAgICAgIH07CgogICAgICAgIH0pKCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgKTsKCiAgICB9CgoKICAgIC8vIHBhcnNlIGV2ZXJ5IGNoaWxkIGVsZW1lbnQKICAgIGZvciAoaSA9IDAsIGNoaWxkcmVuID0gZWxlbWVudC5jaGlsZHJlbiwgY2hpbGRyZW5MZW4gPSBjaGlsZHJlbi5sZW5ndGg7IGkgPCBjaGlsZHJlbkxlbjsgaSs9MSl7CiAgICAgICAgcGFyc2VFbGVtZW50KGNoaWxkcmVuW2ldLCBzdGFjayk7CiAgICB9CgoKICAgIHN0YWNrLmJhY2tncm91bmRDb2xvciA9IGdldENTUyggZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCAiYmFja2dyb3VuZENvbG9yIiApOwoKICAgIHJldHVybiBzdGFjazsKCn07CgpmdW5jdGlvbiBoMmN6Q29udGV4dCh6aW5kZXgpIHsKICAgIHJldHVybiB7CiAgICAgICAgemluZGV4OiB6aW5kZXgsCiAgICAgICAgY2hpbGRyZW46IFtdCiAgICB9Owp9CgovKgogIGh0bWwyY2FudmFzIHYwLjM0IDxodHRwOi8vaHRtbDJjYW52YXMuaGVydHplbi5jb20+CiAgQ29weXJpZ2h0IChjKSAyMDExIE5pa2xhcyB2b24gSGVydHplbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICBodHRwOi8vd3d3LnR3aXR0ZXIuY29tL25pa2xhc3ZoCgogIFJlbGVhc2VkIHVuZGVyIE1JVCBMaWNlbnNlCiAqLwoKX2h0bWwyY2FudmFzLlByZWxvYWQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCiAgICB2YXIgaW1hZ2VzID0gewogICAgICAgIG51bUxvYWRlZDogMCwgICAvLyBhbHNvIGZhaWxlZCBhcmUgY291bnRlZCBoZXJlCiAgICAgICAgbnVtRmFpbGVkOiAwLAogICAgICAgIG51bVRvdGFsOiAwLAogICAgICAgIGNsZWFudXBEb25lOiBmYWxzZQogICAgfSwKICAgIHBhZ2VPcmlnaW4sCiAgICBtZXRob2RzLAogICAgaSwKICAgIGNvdW50ID0gMCwKICAgIGVsZW1lbnQgPSBvcHRpb25zLmVsZW1lbnRzWzBdIHx8IGRvY3VtZW50LmJvZHksCiAgICBkb2MgPSBlbGVtZW50Lm93bmVyRG9jdW1lbnQsCiAgICBkb21JbWFnZXMgPSBkb2MuaW1hZ2VzLCAvLyBUT0RPIHByb2JhYmx5IHNob3VsZCBsaW1pdCBpdCB0byBpbWFnZXMgcHJlc2VudCBpbiB0aGUgZWxlbWVudCBvbmx5CiAgICBpbWdMZW4gPSBkb21JbWFnZXMubGVuZ3RoLAogICAgbGluayA9IGRvYy5jcmVhdGVFbGVtZW50KCJhIiksCiAgICBzdXBwb3J0Q09SUyA9IChmdW5jdGlvbiggaW1nICl7CiAgICAgICAgcmV0dXJuIChpbWcuY3Jvc3NPcmlnaW4gIT09IHVuZGVmaW5lZCk7CiAgICB9KShuZXcgSW1hZ2UoKSksCiAgICB0aW1lb3V0VGltZXI7CgogICAgbGluay5ocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICBwYWdlT3JpZ2luICA9IGxpbmsucHJvdG9jb2wgKyBsaW5rLmhvc3Q7CgoKCgoKCiAgICBmdW5jdGlvbiBpc1NhbWVPcmlnaW4odXJsKXsKICAgICAgICBsaW5rLmhyZWYgPSB1cmw7CiAgICAgICAgbGluay5ocmVmID0gbGluay5ocmVmOyAvLyBZRVMsIEJFTElFVkUgSVQgT1IgTk9ULCB0aGF0IGlzIHJlcXVpcmVkIGZvciBJRTkgLSBodHRwOi8vanNmaWRkbGUubmV0L25pa2xhc3ZoLzJlNDhiLwogICAgICAgIHZhciBvcmlnaW4gPSBsaW5rLnByb3RvY29sICsgbGluay5ob3N0OwogICAgICAgIHJldHVybiAob3JpZ2luID09PSBwYWdlT3JpZ2luKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzdGFydCgpewogICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IHN0YXJ0OiBpbWFnZXM6ICIgKyBpbWFnZXMubnVtTG9hZGVkICsgIiAvICIgKyBpbWFnZXMubnVtVG90YWwgKyAiIChmYWlsZWQ6ICIgKyBpbWFnZXMubnVtRmFpbGVkICsgIikiKTsKICAgICAgICBpZiAoIWltYWdlcy5maXJzdFJ1biAmJiBpbWFnZXMubnVtTG9hZGVkID49IGltYWdlcy5udW1Ub3RhbCl7CiAgICAgICAgICAgIGgyY2xvZygiRmluaXNoZWQgbG9hZGluZyBpbWFnZXM6ICMgIiArIGltYWdlcy5udW1Ub3RhbCArICIgKGZhaWxlZDogIiArIGltYWdlcy5udW1GYWlsZWQgKyAiKSIpOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmNvbXBsZXRlID09PSAiZnVuY3Rpb24iKXsKICAgICAgICAgICAgICAgIG9wdGlvbnMuY29tcGxldGUoaW1hZ2VzKTsKICAgICAgICAgICAgfQoKICAgICAgICB9CiAgICB9CgogICAgLy8gVE9ETyBtb2RpZnkgcHJveHkgdG8gc2VydmUgaW1hZ2VzIHdpdGggQ09SUyBlbmFibGVkLCB3aGVyZSBhdmFpbGFibGUKICAgIGZ1bmN0aW9uIHByb3h5R2V0SW1hZ2UodXJsLCBpbWcsIGltYWdlT2JqKXsKICAgICAgICB2YXIgY2FsbGJhY2tfbmFtZSwKICAgICAgICBzY3JpcHRVcmwgPSBvcHRpb25zLnByb3h5LAogICAgICAgIHNjcmlwdDsKCiAgICAgICAgbGluay5ocmVmID0gdXJsOwogICAgICAgIHVybCA9IGxpbmsuaHJlZjsgLy8gd29yayBhcm91bmQgZm9yIHBhZ2VzIHdpdGggYmFzZSBocmVmPSIiIHNldCAtIFdBUk5JTkc6IHRoaXMgbWF5IGNoYW5nZSB0aGUgdXJsCgogICAgICAgIGNhbGxiYWNrX25hbWUgPSAnaHRtbDJjYW52YXNfJyArIChjb3VudCsrKTsKICAgICAgICBpbWFnZU9iai5jYWxsYmFja25hbWUgPSBjYWxsYmFja19uYW1lOwoKICAgICAgICBpZiAoc2NyaXB0VXJsLmluZGV4T2YoIj8iKSA+IC0xKSB7CiAgICAgICAgICAgIHNjcmlwdFVybCArPSAiJiI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2NyaXB0VXJsICs9ICI/IjsKICAgICAgICB9CiAgICAgICAgc2NyaXB0VXJsICs9ICd1cmw9JyArIGVuY29kZVVSSUNvbXBvbmVudCh1cmwpICsgJyZjYWxsYmFjaz0nICsgY2FsbGJhY2tfbmFtZTsKICAgICAgICBzY3JpcHQgPSBkb2MuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CgogICAgICAgIHdpbmRvd1tjYWxsYmFja19uYW1lXSA9IGZ1bmN0aW9uKGEpewogICAgICAgICAgICBpZiAoYS5zdWJzdHJpbmcoMCw2KSA9PT0gImVycm9yOiIpewogICAgICAgICAgICAgICAgaW1hZ2VPYmouc3VjY2VlZGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgICAgICAgICAgICBpbWFnZXMubnVtRmFpbGVkKys7CiAgICAgICAgICAgICAgICBzdGFydCgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgICAgICAgICBpbWcuc3JjID0gYTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aW5kb3dbY2FsbGJhY2tfbmFtZV0gPSB1bmRlZmluZWQ7IC8vIHRvIHdvcmsgd2l0aCBJRTw5ICAvLyBOT1RFOiB0aGF0IHRoZSB1bmRlZmluZWQgY2FsbGJhY2sgcHJvcGVydHktbmFtZSBzdGlsbCBleGlzdHMgb24gdGhlIHdpbmRvdyBvYmplY3QgKGZvciBJRTw5KQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZGVsZXRlIHdpbmRvd1tjYWxsYmFja19uYW1lXTsgIC8vIGZvciBhbGwgYnJvd3NlciB0aGF0IHN1cHBvcnQgdGhpcwogICAgICAgICAgICB9IGNhdGNoKGV4KSB7fQogICAgICAgICAgICBzY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpOwogICAgICAgICAgICBzY3JpcHQgPSBudWxsOwogICAgICAgICAgICBkZWxldGUgaW1hZ2VPYmouc2NyaXB0OwogICAgICAgICAgICBkZWxldGUgaW1hZ2VPYmouY2FsbGJhY2tuYW1lOwogICAgICAgIH07CgogICAgICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoInR5cGUiLCAidGV4dC9qYXZhc2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LnNldEF0dHJpYnV0ZSgic3JjIiwgc2NyaXB0VXJsKTsKICAgICAgICBpbWFnZU9iai5zY3JpcHQgPSBzY3JpcHQ7CiAgICAgICAgd2luZG93LmRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCiAgICB9CgogICAgZnVuY3Rpb24gZ2V0SW1hZ2VzIChlbCkgewoKCgogICAgICAgIC8vIGlmICghdGhpcy5pZ25vcmVSZS50ZXN0KGVsLm5vZGVOYW1lKSl7CiAgICAgICAgLy8KICAgICAgICAKICAgICAgICB2YXIgY29udGVudHMgPSBfaHRtbDJjYW52YXMuVXRpbC5DaGlsZHJlbihlbCksCiAgICAgICAgaSwKICAgICAgICBiYWNrZ3JvdW5kX2ltYWdlLAogICAgICAgIHNyYywKICAgICAgICBpbWcsCiAgICAgICAgZWxOb2RlVHlwZSA9IGZhbHNlOwoKICAgICAgICAvLyBGaXJlZm94IGZhaWxzIHdpdGggcGVybWlzc2lvbiBkZW5pZWQgb24gcGFnZXMgd2l0aCBpZnJhbWVzCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGNvbnRlbnRzTGVuID0gY29udGVudHMubGVuZ3RoOwogICAgICAgICAgICBmb3IgKGkgPSAwOyAgaSA8IGNvbnRlbnRzTGVuOyBpKz0xICl7CiAgICAgICAgICAgICAgICAvLyB2YXIgaWduUmUgPSBuZXcgUmVnRXhwKCIoIit0aGlzLmlnbm9yZUVsZW1lbnRzKyIpIik7CiAgICAgICAgICAgICAgICAvLyBpZiAoIWlnblJlLnRlc3QoZWxlbWVudC5ub2RlTmFtZSkpewogICAgICAgICAgICAgICAgZ2V0SW1hZ2VzKGNvbnRlbnRzW2ldKTsKICAgICAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjYXRjaCggZSApIHt9CgoKICAgICAgICAvLyB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZWxOb2RlVHlwZSA9IGVsLm5vZGVUeXBlOwogICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgIGVsTm9kZVR5cGUgPSBmYWxzZTsKICAgICAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogZmFpbGVkIHRvIGFjY2VzcyBzb21lIGVsZW1lbnQncyBub2RlVHlwZSAtIEV4Y2VwdGlvbjogIiArIGV4Lm1lc3NhZ2UpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGVsTm9kZVR5cGUgPT09IDEgfHwgZWxOb2RlVHlwZSA9PT0gdW5kZWZpbmVkKXsKCiAgICAgICAgICAgIC8vIG9wZXJhIHRocm93cyBleGNlcHRpb24gb24gZXh0ZXJuYWwtY29udGVudC5odG1sCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kX2ltYWdlID0gX2h0bWwyY2FudmFzLlV0aWwuZ2V0Q1NTKGVsLCAnYmFja2dyb3VuZEltYWdlJyk7CiAgICAgICAgICAgIH1jYXRjaChlKSB7CiAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBmYWlsZWQgdG8gZ2V0IGJhY2tncm91bmQtaW1hZ2UgLSBFeGNlcHRpb246ICIgKyBlLm1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICggYmFja2dyb3VuZF9pbWFnZSAmJiBiYWNrZ3JvdW5kX2ltYWdlICE9PSAiMSIgJiYgYmFja2dyb3VuZF9pbWFnZSAhPT0gIm5vbmUiICkgewoKICAgICAgICAgICAgICAgIC8vIFRPRE8gYWRkIG11bHRpIGltYWdlIGJhY2tncm91bmQgc3VwcG9ydAoKICAgICAgICAgICAgICAgIGlmICgvXigtd2Via2l0fC1vfC1tb3p8LW1zfGxpbmVhciktLy50ZXN0KCBiYWNrZ3JvdW5kX2ltYWdlICkpIHsKCiAgICAgICAgICAgICAgICAgICAgaW1nID0gX2h0bWwyY2FudmFzLkdlbmVyYXRlLkdyYWRpZW50KCBiYWNrZ3JvdW5kX2ltYWdlLCBfaHRtbDJjYW52YXMuVXRpbC5Cb3VuZHMoIGVsICkgKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCBpbWcgIT09IHVuZGVmaW5lZCApewogICAgICAgICAgICAgICAgICAgICAgICBpbWFnZXNbYmFja2dyb3VuZF9pbWFnZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWc6IGltZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2NlZWRlZDogdHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCgpOwoKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzcmMgPSBfaHRtbDJjYW52YXMuVXRpbC5iYWNrZ3JvdW5kSW1hZ2UoYmFja2dyb3VuZF9pbWFnZS5tYXRjaCgvZGF0YTppbWFnZVwvLio7YmFzZTY0LC9pKSA/IGJhY2tncm91bmRfaW1hZ2UgOiBiYWNrZ3JvdW5kX2ltYWdlLnNwbGl0KCIsIilbMF0pOwogICAgICAgICAgICAgICAgICAgIG1ldGhvZHMubG9hZEltYWdlKHNyYyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoKICAgICAgICAgICAgaWYgKGJhY2tncm91bmRfaW1hZ2UgJiYgYmFja2dyb3VuZF9pbWFnZSAhPT0gIjEiICYmIGJhY2tncm91bmRfaW1hZ2UgIT09ICJub25lIiAmJiBiYWNrZ3JvdW5kX2ltYWdlLnN1YnN0cmluZygwLDcpICE9PSAiLXdlYmtpdCIgJiYgYmFja2dyb3VuZF9pbWFnZS5zdWJzdHJpbmcoMCwzKSE9PSAiLW8tIiAmJiBiYWNrZ3JvdW5kX2ltYWdlLnN1YnN0cmluZygwLDQpICE9PSAiLW1veiIpewogICAgICAgICAgICAgICAgLy8gVE9ETyBhZGQgbXVsdGkgaW1hZ2UgYmFja2dyb3VuZCBzdXBwb3J0CiAgICAgICAgICAgICAgICBzcmMgPSBfaHRtbDJjYW52YXMuVXRpbC5iYWNrZ3JvdW5kSW1hZ2UoYmFja2dyb3VuZF9pbWFnZS5zcGxpdCgiLCIpWzBdKTsKICAgICAgICAgICAgICAgIG1ldGhvZHMubG9hZEltYWdlKHNyYyk7ICAgICAgICAgICAgKi8KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKSB7CiAgICAgICAgaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoIGltYWdlT2JqLnRpbWVyICE9PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICAgICAgICAvLyBDT1JTIHN1Y2NlZWRlZAogICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCggaW1hZ2VPYmoudGltZXIgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaW1hZ2VzLm51bUxvYWRlZCsrOwogICAgICAgICAgICBpbWFnZU9iai5zdWNjZWVkZWQgPSB0cnVlOwogICAgICAgICAgICBpbWcub25lcnJvciA9IGltZy5vbmxvYWQgPSBudWxsOwogICAgICAgICAgICBzdGFydCgpOwogICAgICAgIH07CiAgICAgICAgaW1nLm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIGlmIChpbWcuY3Jvc3NPcmlnaW4gPT09ICJhbm9ueW1vdXMiKSB7CiAgICAgICAgICAgICAgICAvLyBDT1JTIGZhaWxlZAogICAgICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCggaW1hZ2VPYmoudGltZXIgKTsKCiAgICAgICAgICAgICAgICAvLyBsZXQncyB0cnkgd2l0aCBwcm94eSBpbnN0ZWFkCiAgICAgICAgICAgICAgICBpZiAoIG9wdGlvbnMucHJveHkgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNyYyA9IGltZy5zcmM7CiAgICAgICAgICAgICAgICAgICAgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgICAgICAgICAgICAgaW1hZ2VPYmouaW1nID0gaW1nOwogICAgICAgICAgICAgICAgICAgIGltZy5zcmMgPSBzcmM7CgogICAgICAgICAgICAgICAgICAgIHByb3h5R2V0SW1hZ2UoIGltZy5zcmMsIGltZywgaW1hZ2VPYmogKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgICAgICAgIGltYWdlcy5udW1GYWlsZWQrKzsKICAgICAgICAgICAgaW1hZ2VPYmouc3VjY2VlZGVkID0gZmFsc2U7CiAgICAgICAgICAgIGltZy5vbmVycm9yID0gaW1nLm9ubG9hZCA9IG51bGw7CiAgICAgICAgICAgIHN0YXJ0KCk7CgogICAgICAgIH07CgogICAgICAgIC8vIFRPRE8gT3BlcmEgaGFzIG5vIGxvYWQvZXJyb3IgZXZlbnQgZm9yIFNWRyBpbWFnZXMKCiAgICAgICAgLy8gT3BlcmEgbmluamEgb25sb2FkJ3MgY2FjaGVkIGltYWdlcwogICAgICAgIC8qCiAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgaWYgKCBpbWcud2lkdGggIT09IDAgJiYgaW1hZ2VPYmouc3VjY2VlZGVkID09PSB1bmRlZmluZWQgKSB7CiAgICAgICAgICAgICAgICBpbWcub25sb2FkKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LCAxMDApOyAvLyBuZWVkcyBhIHJlZmxvdyBmb3IgYmFzZTY0IGVuY29kZWQgaW1hZ2VzPyBpbnRlcmVzdGluZ2x5IHRpbWVvdXQgb2YgMCBkb2Vzbid0IHdvcmsgYnV0IDEgZG9lcy4KICAgICAgICAgKi8KICAgIH0KCgogICAgbWV0aG9kcyA9IHsKICAgICAgICBsb2FkSW1hZ2U6IGZ1bmN0aW9uKCBzcmMgKSB7CiAgICAgICAgICAgIHZhciBpbWcsIGltYWdlT2JqOwogICAgICAgICAgICBpZiAoIHNyYyAmJiBpbWFnZXNbc3JjXSA9PT0gdW5kZWZpbmVkICkgewogICAgICAgICAgICAgICAgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgICAgICAgICBpZiAoIHNyYy5tYXRjaCgvZGF0YTppbWFnZVwvLio7YmFzZTY0LC9pKSApIHsKICAgICAgICAgICAgICAgICAgICBpbWcuc3JjID0gc3JjLnJlcGxhY2UoL3VybFwoWyciXXswLH18WyciXXswLH1cKSQvaWcsICcnKTsKICAgICAgICAgICAgICAgICAgICBpbWFnZU9iaiA9IGltYWdlc1tzcmNdID0gewogICAgICAgICAgICAgICAgICAgICAgICBpbWc6IGltZwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgaW1hZ2VzLm51bVRvdGFsKys7CiAgICAgICAgICAgICAgICAgICAgc2V0SW1hZ2VMb2FkSGFuZGxlcnMoaW1nLCBpbWFnZU9iaik7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBpc1NhbWVPcmlnaW4oIHNyYyApIHx8IG9wdGlvbnMuYWxsb3dUYWludCA9PT0gIHRydWUgKSB7CiAgICAgICAgICAgICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgaW1nOiBpbWcKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgICAgICAgICAgIHNldEltYWdlTG9hZEhhbmRsZXJzKGltZywgaW1hZ2VPYmopOwogICAgICAgICAgICAgICAgICAgIGltZy5zcmMgPSBzcmM7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBzdXBwb3J0Q09SUyAmJiAhb3B0aW9ucy5hbGxvd1RhaW50ICYmIG9wdGlvbnMudXNlQ09SUyApIHsKICAgICAgICAgICAgICAgICAgICAvLyBhdHRlbXB0IHRvIGxvYWQgd2l0aCBDT1JTCgogICAgICAgICAgICAgICAgICAgIGltZy5jcm9zc09yaWdpbiA9ICJhbm9ueW1vdXMiOwogICAgICAgICAgICAgICAgICAgIGltYWdlT2JqID0gaW1hZ2VzW3NyY10gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGltZzogaW1nCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtVG90YWwrKzsKICAgICAgICAgICAgICAgICAgICBzZXRJbWFnZUxvYWRIYW5kbGVycyhpbWcsIGltYWdlT2JqKTsKICAgICAgICAgICAgICAgICAgICBpbWcuc3JjID0gc3JjOwoKICAgICAgICAgICAgICAgICAgICAvLyB3b3JrIGFyb3VuZCBmb3IgaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTgwMDI4CiAgICAgICAgICAgICAgICAgICAgaW1nLmN1c3RvbUNvbXBsZXRlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW1nLmNvbXBsZXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbWVyID0gd2luZG93LnNldFRpbWVvdXQodGhpcy5pbWcuY3VzdG9tQ29tcGxldGUsIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmltZy5vbmVycm9yKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LmJpbmQoaW1hZ2VPYmopOwogICAgICAgICAgICAgICAgICAgIGltZy5jdXN0b21Db21wbGV0ZSgpOwoKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIG9wdGlvbnMucHJveHkgKSB7CiAgICAgICAgICAgICAgICAgICAgaW1hZ2VPYmogPSBpbWFnZXNbc3JjXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgaW1nOiBpbWcKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGltYWdlcy5udW1Ub3RhbCsrOwogICAgICAgICAgICAgICAgICAgIHByb3h5R2V0SW1hZ2UoIHNyYywgaW1nLCBpbWFnZU9iaiApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgIH0sCiAgICAgICAgY2xlYW51cERPTTogZnVuY3Rpb24oY2F1c2UpIHsKICAgICAgICAgICAgdmFyIGltZywgc3JjOwogICAgICAgICAgICBpZiAoIWltYWdlcy5jbGVhbnVwRG9uZSkgewogICAgICAgICAgICAgICAgaWYgKGNhdXNlICYmIHR5cGVvZiBjYXVzZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBDbGVhbnVwIGJlY2F1c2U6ICIgKyBjYXVzZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IENsZWFudXAgYWZ0ZXIgdGltZW91dDogIiArIG9wdGlvbnMudGltZW91dCArICIgbXMuIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yIChzcmMgaW4gaW1hZ2VzKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGltYWdlcy5oYXNPd25Qcm9wZXJ0eShzcmMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGltZyA9IGltYWdlc1tzcmNdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGltZyA9PT0gIm9iamVjdCIgJiYgaW1nLmNhbGxiYWNrbmFtZSAmJiBpbWcuc3VjY2VlZGVkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhbmNlbCBwcm94eSBpbWFnZSByZXF1ZXN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3dbaW1nLmNhbGxiYWNrbmFtZV0gPSB1bmRlZmluZWQ7IC8vIHRvIHdvcmsgd2l0aCBJRTw5ICAvLyBOT1RFOiB0aGF0IHRoZSB1bmRlZmluZWQgY2FsbGJhY2sgcHJvcGVydHktbmFtZSBzdGlsbCBleGlzdHMgb24gdGhlIHdpbmRvdyBvYmplY3QgKGZvciBJRTw5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgd2luZG93W2ltZy5jYWxsYmFja25hbWVdOyAgLy8gZm9yIGFsbCBicm93c2VyIHRoYXQgc3VwcG9ydCB0aGlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKGV4KSB7fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGltZy5zY3JpcHQgJiYgaW1nLnNjcmlwdC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1nLnNjcmlwdC5zZXRBdHRyaWJ1dGUoInNyYyIsICJhYm91dDpibGFuayIpOyAgLy8gdHJ5IHRvIGNhbmNlbCBydW5uaW5nIHJlcXVlc3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWcuc2NyaXB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaW1nLnNjcmlwdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtTG9hZGVkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWFnZXMubnVtRmFpbGVkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBDbGVhbmVkIHVwIGZhaWxlZCBpbWc6ICciICsgc3JjICsgIicgU3RlcHM6ICIgKyBpbWFnZXMubnVtTG9hZGVkICsgIiAvICIgKyBpbWFnZXMubnVtVG90YWwpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGNhbmNlbCBhbnkgcGVuZGluZyByZXF1ZXN0cwogICAgICAgICAgICAgICAgaWYod2luZG93LnN0b3AgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHdpbmRvdy5zdG9wKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYoZG9jdW1lbnQuZXhlY0NvbW1hbmQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKCJTdG9wIiwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmNsb3NlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5jbG9zZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW1hZ2VzLmNsZWFudXBEb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmICghKGNhdXNlICYmIHR5cGVvZiBjYXVzZSA9PT0gInN0cmluZyIpKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgcmVuZGVyaW5nRG9uZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICh0aW1lb3V0VGltZXIpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodGltZW91dFRpbWVyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9OwoKICAgIGlmIChvcHRpb25zLnRpbWVvdXQgPiAwKSB7CiAgICAgICAgdGltZW91dFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQobWV0aG9kcy5jbGVhbnVwRE9NLCBvcHRpb25zLnRpbWVvdXQpOwogICAgfQogICAgaDJjbG9nKCdodG1sMmNhbnZhczogUHJlbG9hZCBzdGFydHM6IGZpbmRpbmcgYmFja2dyb3VuZC1pbWFnZXMnKTsKICAgIGltYWdlcy5maXJzdFJ1biA9IHRydWU7CgogICAgZ2V0SW1hZ2VzKCBlbGVtZW50ICk7CgogICAgaDJjbG9nKCdodG1sMmNhbnZhczogUHJlbG9hZDogRmluZGluZyBpbWFnZXMnKTsKICAgIC8vIGxvYWQgPGltZz4gaW1hZ2VzCiAgICBmb3IgKGkgPSAwOyBpIDwgaW1nTGVuOyBpKz0xKXsKICAgICAgICBtZXRob2RzLmxvYWRJbWFnZSggZG9tSW1hZ2VzW2ldLmdldEF0dHJpYnV0ZSggInNyYyIgKSApOwogICAgfQoKICAgIGltYWdlcy5maXJzdFJ1biA9IGZhbHNlOwogICAgaDJjbG9nKCdodG1sMmNhbnZhczogUHJlbG9hZDogRG9uZS4nKTsKICAgIGlmICggaW1hZ2VzLm51bVRvdGFsID09PSBpbWFnZXMubnVtTG9hZGVkICkgewogICAgICAgIHN0YXJ0KCk7CiAgICB9CgogICAgcmV0dXJuIG1ldGhvZHM7Cgp9OwoKCgoKLyoKICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPgogIENvcHlyaWdodCAoYykgMjAxMSBOaWtsYXMgdm9uIEhlcnR6ZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aAoKICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQoqLwpmdW5jdGlvbiBoMmNSZW5kZXJDb250ZXh0KHdpZHRoLCBoZWlnaHQpIHsKICAgIHZhciBzdG9yYWdlID0gW107CiAgICByZXR1cm4gewogICAgICAgIHN0b3JhZ2U6IHN0b3JhZ2UsCiAgICAgICAgd2lkdGg6IHdpZHRoLAogICAgICAgIGhlaWdodDogaGVpZ2h0LAogICAgICAgIGZpbGxSZWN0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgICAgICAgICAgbmFtZTogImZpbGxSZWN0IiwKICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBkcmF3U2hhcGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgCiAgICAgICAgICAgIHZhciBzaGFwZSA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgc3RvcmFnZS5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6ICJmdW5jdGlvbiIsCiAgICAgICAgICAgICAgICBuYW1lOiAiZHJhd1NoYXBlIiwKICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBzaGFwZQogICAgICAgICAgICB9KTsKICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgbW92ZVRvOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBzaGFwZS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogIm1vdmVUbyIsCiAgICAgICAgICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBsaW5lVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAibGluZVRvIiwKICAgICAgICAgICAgICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGJlemllckN1cnZlVG86IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHNoYXBlLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAiYmV6aWVyQ3VydmVUbyIsCiAgICAgICAgICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBxdWFkcmF0aWNDdXJ2ZVRvOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBzaGFwZS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogInF1YWRyYXRpY0N1cnZlVG8iLAogICAgICAgICAgICAgICAgICAgICAgICAnYXJndW1lbnRzJzogYXJndW1lbnRzCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9LAogICAgICAgIGRyYXdJbWFnZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBzdG9yYWdlLnB1c2goewogICAgICAgICAgICAgICAgdHlwZTogImZ1bmN0aW9uIiwKICAgICAgICAgICAgICAgIG5hbWU6ICJkcmF3SW1hZ2UiLAogICAgICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IGFyZ3VtZW50cwogICAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIGZpbGxUZXh0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHN0b3JhZ2UucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiAiZnVuY3Rpb24iLAogICAgICAgICAgICAgICAgbmFtZTogImZpbGxUZXh0IiwKICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBhcmd1bWVudHMKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICBzZXRWYXJpYWJsZTogZnVuY3Rpb24gKHZhcmlhYmxlLCB2YWx1ZSkgewogICAgICAgICAgICBzdG9yYWdlLnB1c2goewogICAgICAgICAgICAgICAgdHlwZTogInZhcmlhYmxlIiwKICAgICAgICAgICAgICAgIG5hbWU6IHZhcmlhYmxlLAogICAgICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IHZhbHVlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH07Cn0KCi8qCiAgaHRtbDJjYW52YXMgdjAuMzQgPGh0dHA6Ly9odG1sMmNhbnZhcy5oZXJ0emVuLmNvbT4KICBDb3B5cmlnaHQgKGMpIDIwMTEgTmlrbGFzIHZvbiBIZXJ0emVuLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogIGh0dHA6Ly93d3cudHdpdHRlci5jb20vbmlrbGFzdmgKCiAgUmVsZWFzZWQgdW5kZXIgTUlUIExpY2Vuc2UKKi8KX2h0bWwyY2FudmFzLlJlbmRlcmVyID0gZnVuY3Rpb24ocGFyc2VRdWV1ZSwgb3B0aW9ucyl7CgoKICAgIHZhciBxdWV1ZSA9IFtdOwoKICAgIGZ1bmN0aW9uIHNvcnRaKHpTdGFjayl7CiAgICAgICAgdmFyIHN1YlN0YWNrcyA9IFtdLAogICAgICAgIHN0YWNrVmFsdWVzID0gW10sCiAgICAgICAgelN0YWNrQ2hpbGRyZW4gPSB6U3RhY2suY2hpbGRyZW4sCiAgICAgICAgcywKICAgICAgICBpLAogICAgICAgIHN0YWNrTGVuLAogICAgICAgIHpWYWx1ZSwKICAgICAgICB6TGVuLAogICAgICAgIHN0YWNrQ2hpbGQsCiAgICAgICAgYiwKICAgICAgICBzdWJTdGFja0xlbjsKCgogICAgICAgIGZvciAocyA9IDAsIHpMZW4gPSB6U3RhY2tDaGlsZHJlbi5sZW5ndGg7IHMgPCB6TGVuOyBzKz0xKXsKCiAgICAgICAgICAgIHN0YWNrQ2hpbGQgPSB6U3RhY2tDaGlsZHJlbltzXTsKCiAgICAgICAgICAgIGlmIChzdGFja0NoaWxkLmNoaWxkcmVuICYmIHN0YWNrQ2hpbGQuY2hpbGRyZW4ubGVuZ3RoID4gMCl7CiAgICAgICAgICAgICAgICBzdWJTdGFja3MucHVzaChzdGFja0NoaWxkKTsKICAgICAgICAgICAgICAgIHN0YWNrVmFsdWVzLnB1c2goc3RhY2tDaGlsZC56aW5kZXgpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHF1ZXVlLnB1c2goc3RhY2tDaGlsZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICBzdGFja1ZhbHVlcy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEgLSBiOwogICAgICAgIH0pOwoKICAgICAgICBmb3IgKGkgPSAwLCBzdGFja0xlbiA9IHN0YWNrVmFsdWVzLmxlbmd0aDsgaSA8IHN0YWNrTGVuOyBpKz0xKXsKICAgICAgICAgICAgelZhbHVlID0gc3RhY2tWYWx1ZXNbaV07CiAgICAgICAgICAgIGZvciAoYiA9IDAsIHN1YlN0YWNrTGVuID0gc3ViU3RhY2tzLmxlbmd0aDsgYiA8PSBzdWJTdGFja0xlbjsgYis9MSl7CgogICAgICAgICAgICAgICAgaWYgKHN1YlN0YWNrc1tiXS56aW5kZXggPT09IHpWYWx1ZSl7CiAgICAgICAgICAgICAgICAgICAgc3RhY2tDaGlsZCA9IHN1YlN0YWNrcy5zcGxpY2UoYiwgMSk7CiAgICAgICAgICAgICAgICAgICAgc29ydFooc3RhY2tDaGlsZFswXSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0KCgogICAgc29ydFoocGFyc2VRdWV1ZS56SW5kZXgpOwogICAgaWYgKCB0eXBlb2Ygb3B0aW9ucy5fcmVuZGVyZXIuX2NyZWF0ZSAhPT0gImZ1bmN0aW9uIiApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgcmVuZGVyZXIgZGVmaW5lZCIpOwogICAgfQogICAgcmV0dXJuIG9wdGlvbnMuX3JlbmRlcmVyLl9jcmVhdGUoIHBhcnNlUXVldWUsIG9wdGlvbnMsIGRvY3VtZW50LCBxdWV1ZSwgX2h0bWwyY2FudmFzICk7Cgp9OwoKLyoKICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPgogIENvcHlyaWdodCAoYykgMjAxMSBOaWtsYXMgdm9uIEhlcnR6ZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aAoKICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQoqLwoKCmh0bWwyY2FudmFzID0gZnVuY3Rpb24oIGVsZW1lbnRzLCBvcHRzICkgewoKICAgIHZhciBxdWV1ZSwKICAgIGNhbnZhcywKICAgIG9wdGlvbnMgPSB7CiAgICAgICAgLy8gZ2VuZXJhbAogICAgICAgIGxvZ2dpbmc6IGZhbHNlLAogICAgICAgIGVsZW1lbnRzOiBlbGVtZW50cywKCiAgICAgICAgLy8gcHJlbG9hZCBvcHRpb25zCiAgICAgICAgcHJveHk6ICJodHRwOi8vaHRtbDJjYW52YXMuYXBwc3BvdC5jb20vIiwKICAgICAgICB0aW1lb3V0OiAwLCAgICAvLyBubyB0aW1lb3V0CiAgICAgICAgdXNlQ09SUzogZmFsc2UsIC8vIHRyeSB0byBsb2FkIGltYWdlcyBhcyBDT1JTICh3aGVyZSBhdmFpbGFibGUpLCBiZWZvcmUgZmFsbGluZyBiYWNrIHRvIHByb3h5CiAgICAgICAgYWxsb3dUYWludDogZmFsc2UsIC8vIHdoZXRoZXIgdG8gYWxsb3cgaW1hZ2VzIHRvIHRhaW50IHRoZSBjYW52YXMsIHdvbid0IG5lZWQgcHJveHkgaWYgc2V0IHRvIHRydWUKCiAgICAgICAgLy8gcGFyc2Ugb3B0aW9ucwogICAgICAgIHN2Z1JlbmRlcmluZzogZmFsc2UsIC8vIHVzZSBzdmcgcG93ZXJlZCByZW5kZXJpbmcgd2hlcmUgYXZhaWxhYmxlIChGRjExKykKICAgICAgICBpZnJhbWVEZWZhdWx0OiAiZGVmYXVsdCIsCiAgICAgICAgaWdub3JlRWxlbWVudHM6ICJJRlJBTUV8T0JKRUNUfFBBUkFNIiwKICAgICAgICB1c2VPdmVyZmxvdzogdHJ1ZSwKICAgICAgICBsZXR0ZXJSZW5kZXJpbmc6IGZhbHNlLAoKICAgICAgICAvLyByZW5kZXIgb3B0aW9ucwoKICAgICAgICBmbGFzaGNhbnZhczogdW5kZWZpbmVkLCAvLyBwYXRoIHRvIGZsYXNoY2FudmFzCiAgICAgICAgd2lkdGg6IG51bGwsCiAgICAgICAgaGVpZ2h0OiBudWxsLAogICAgICAgIHRhaW50VGVzdDogdHJ1ZSwgLy8gZG8gYSB0YWludCB0ZXN0IHdpdGggYWxsIGltYWdlcyBiZWZvcmUgYXBwbHlpbmcgdG8gY2FudmFzCiAgICByZW5kZXJlcjogIkNhbnZhcyIKICAgIH0sIHJlbmRlcmVyOwoKICAgIG9wdGlvbnMgPSBfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQob3B0cywgb3B0aW9ucyk7CgogIGlmICh0eXBlb2Ygb3B0aW9ucy5yZW5kZXJlciA9PT0gInN0cmluZyIgJiYgX2h0bWwyY2FudmFzLlJlbmRlcmVyW29wdGlvbnMucmVuZGVyZXJdICE9PSB1bmRlZmluZWQpIHsKICAgIG9wdGlvbnMuX3JlbmRlcmVyID0gX2h0bWwyY2FudmFzLlJlbmRlcmVyW29wdGlvbnMucmVuZGVyZXJdKCBvcHRpb25zICk7CiAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucy5yZW5kZXJlciA9PT0gImZ1bmN0aW9uIikgewogICAgb3B0aW9ucy5fcmVuZGVyZXIgPSBvcHRpb25zLnJlbmRlcmVyKCBvcHRpb25zICk7CiAgfSBlbHNlIHsKICAgIHRocm93KCJVbmtub3duIHJlbmRlcmVyIik7CiAgfQoKICAgIF9odG1sMmNhbnZhcy5sb2dnaW5nID0gb3B0aW9ucy5sb2dnaW5nOwogICAgb3B0aW9ucy5jb21wbGV0ZSA9IGZ1bmN0aW9uKCBpbWFnZXMgKSB7CgogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnByZWxvYWRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpZiAoIG9wdGlvbnMub25wcmVsb2FkZWQoIGltYWdlcyApID09PSBmYWxzZSApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBxdWV1ZSA9IF9odG1sMmNhbnZhcy5QYXJzZSggaW1hZ2VzLCBvcHRpb25zICk7CgogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnBhcnNlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpZiAoIG9wdGlvbnMub25wYXJzZWQoIHF1ZXVlICkgPT09IGZhbHNlICkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjYW52YXMgPSBfaHRtbDJjYW52YXMuUmVuZGVyZXIoIHF1ZXVlLCBvcHRpb25zICk7CgogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbnJlbmRlcmVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIG9wdGlvbnMub25yZW5kZXJlZCggY2FudmFzICk7CiAgICAgICAgfQoKCiAgICB9OwoKICAgIC8vIGZvciBwYWdlcyB3aXRob3V0IGltYWdlcywgd2Ugc3RpbGwgd2FudCB0aGlzIHRvIGJlIGFzeW5jLCBpLmUuIHJldHVybiBtZXRob2RzIGJlZm9yZSBleGVjdXRpbmcKICAgIHdpbmRvdy5zZXRUaW1lb3V0KCBmdW5jdGlvbigpewogICAgICAgIF9odG1sMmNhbnZhcy5QcmVsb2FkKCBvcHRpb25zICk7CiAgICB9LCAwICk7CgogICAgcmV0dXJuIHsKICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKCBxdWV1ZSwgb3B0cyApIHsKICAgICAgICAgICAgcmV0dXJuIF9odG1sMmNhbnZhcy5SZW5kZXJlciggcXVldWUsIF9odG1sMmNhbnZhcy5VdGlsLkV4dGVuZChvcHRzLCBvcHRpb25zKSApOwogICAgICAgIH0sCiAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKCBpbWFnZXMsIG9wdHMgKSB7CiAgICAgICAgICAgIHJldHVybiBfaHRtbDJjYW52YXMuUGFyc2UoIGltYWdlcywgX2h0bWwyY2FudmFzLlV0aWwuRXh0ZW5kKG9wdHMsIG9wdGlvbnMpICk7CiAgICAgICAgfSwKICAgICAgICBwcmVsb2FkOiBmdW5jdGlvbiggb3B0cyApIHsKICAgICAgICAgICAgcmV0dXJuIF9odG1sMmNhbnZhcy5QcmVsb2FkKCBfaHRtbDJjYW52YXMuVXRpbC5FeHRlbmQob3B0cywgb3B0aW9ucykgKTsKICAgICAgICB9LAogICAgICAgIGxvZzogaDJjbG9nCiAgICB9Owp9OwoKaHRtbDJjYW52YXMubG9nID0gaDJjbG9nOyAvLyBmb3IgcmVuZGVyZXJzCmh0bWwyY2FudmFzLlJlbmRlcmVyID0gewogICAgQ2FudmFzOiB1bmRlZmluZWQgLy8gV2UgYXJlIGFzc3VtaW5nIHRoaXMgd2lsbCBiZSB1c2VkCn07CgovKgogIGh0bWwyY2FudmFzIHYwLjM0IDxodHRwOi8vaHRtbDJjYW52YXMuaGVydHplbi5jb20+CiAgQ29weXJpZ2h0IChjKSAyMDExIE5pa2xhcyB2b24gSGVydHplbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICBodHRwOi8vd3d3LnR3aXR0ZXIuY29tL25pa2xhc3ZoCgogIFJlbGVhc2VkIHVuZGVyIE1JVCBMaWNlbnNlCiovCgoKX2h0bWwyY2FudmFzLlJlbmRlcmVyLkNhbnZhcyA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgIHZhciBkb2MgPSBkb2N1bWVudCwKICAgIGNhbnZhcyA9IG9wdGlvbnMuY2FudmFzIHx8IGRvYy5jcmVhdGVFbGVtZW50KCdjYW52YXMnKSwKICAgIHVzaW5nRmxhc2hjYW52YXMgPSBmYWxzZSwKICAgIF9jcmVhdGVDYWxsZWQgPSBmYWxzZSwKICAgIGNhbnZhc1JlYWR5VG9EcmF3ID0gZmFsc2UsCiAgICBtZXRob2RzLAogICAgZmxhc2hNYXhTaXplID0gMjg4MDsgLy8gZmxhc2ggYml0bWFwIGxpbWl0ZWQgdG8gMjg4MHgyODgwcHggLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8yMDMzNzkyL2FyZ3VtZW50ZXJyb3ItZXJyb3ItMjAxNS1pbnZhbGlkLWJpdG1hcGRhdGEKCgogICAgaWYgKGNhbnZhcy5nZXRDb250ZXh0KXsKICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBSZW5kZXJlcjogdXNpbmcgY2FudmFzIHJlbmRlcmVyIik7CiAgICAgICAgY2FudmFzUmVhZHlUb0RyYXcgPSB0cnVlOwogICAgfSBlbHNlIGlmICggb3B0aW9ucy5mbGFzaGNhbnZhcyAhPT0gdW5kZWZpbmVkICl7CiAgICAgICAgdXNpbmdGbGFzaGNhbnZhcyA9IHRydWU7CiAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogUmVuZGVyZXI6IGNhbnZhcyBub3QgYXZhaWxhYmxlLCB1c2luZyBmbGFzaGNhbnZhcyIpOwogICAgICAgIHZhciBzY3JpcHQgPSBkb2MuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CiAgICAgICAgc2NyaXB0LnNyYyA9IG9wdGlvbnMuZmxhc2hjYW52YXM7CgogICAgICAgIHNjcmlwdC5vbmxvYWQgPSAoZnVuY3Rpb24oc2NyaXB0LCBmdW5jKXsKICAgICAgICAgICAgdmFyIGludGVydmFsRnVuYzsKCiAgICAgICAgICAgIGlmIChzY3JpcHQub25sb2FkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIC8vIElFIGxhY2sgb2Ygc3VwcG9ydCBmb3Igc2NyaXB0IG9ubG9hZAoKICAgICAgICAgICAgICAgIGlmKCBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlICE9PSB1bmRlZmluZWQgKSB7CgogICAgICAgICAgICAgICAgICAgIGludGVydmFsRnVuYyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NyaXB0LnJlYWR5U3RhdGUgIT09ICJsb2FkZWQiICYmIHNjcmlwdC5yZWFkeVN0YXRlICE9PSAiY29tcGxldGUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dCggaW50ZXJ2YWxGdW5jLCAyNTAgKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpdCBpcyBsb2FkZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmMoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoIGludGVydmFsRnVuYywgMjUwICk7CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBoMmNsb2coImh0bWwyY2FudmFzOiBSZW5kZXJlcjogQ2FuJ3QgdHJhY2sgd2hlbiBmbGFzaGNhbnZhcyBpcyBsb2FkZWQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgICAgICAgfQoKICAgICAgICB9KShzY3JpcHQsIGZ1bmN0aW9uKCl7CgogICAgICAgICAgICBpZiAodHlwZW9mIHdpbmRvdy5GbGFzaENhbnZhcyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IFJlbmRlcmVyOiBGbGFzaGNhbnZhcyBpbml0aWFsaXplZCIpOwogICAgICAgICAgICAgICAgd2luZG93LkZsYXNoQ2FudmFzLmluaXRFbGVtZW50KCBjYW52YXMgKTsKCiAgICAgICAgICAgICAgICBjYW52YXNSZWFkeVRvRHJhdyA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoIF9jcmVhdGVDYWxsZWQgIT09IGZhbHNlICkgewogICAgICAgICAgICAgICAgICAgIG1ldGhvZHMuX2NyZWF0ZS5hcHBseSggbnVsbCwgX2NyZWF0ZUNhbGxlZCApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGRvYy5ib2R5LmFwcGVuZENoaWxkKCBzY3JpcHQgKTsKCiAgICB9CgogICAgbWV0aG9kcyA9IHsKICAgICAgICBfY3JlYXRlOiBmdW5jdGlvbiggelN0YWNrLCBvcHRpb25zLCBkb2MsIHF1ZXVlLCBfaHRtbDJjYW52YXMgKSB7CgogICAgICAgICAgICBpZiAoICFjYW52YXNSZWFkeVRvRHJhdyApIHsKICAgICAgICAgICAgICAgIF9jcmVhdGVDYWxsZWQgPSBhcmd1bWVudHM7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FudmFzOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY3R4ID0gY2FudmFzLmdldENvbnRleHQoIjJkIiksCiAgICAgICAgICAgIHN0b3JhZ2VDb250ZXh0LAogICAgICAgICAgICBpLAogICAgICAgICAgICBxdWV1ZUxlbiwKICAgICAgICAgICAgYSwKICAgICAgICAgICAgbmV3Q2FudmFzLAogICAgICAgICAgICBib3VuZHMsCiAgICAgICAgICAgIHRlc3RDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKSwKICAgICAgICAgICAgaGFzQ1RYID0gKCB0ZXN0Q2FudmFzLmdldENvbnRleHQgIT09IHVuZGVmaW5lZCApLAogICAgICAgICAgICBzdG9yYWdlTGVuLAogICAgICAgICAgICByZW5kZXJJdGVtLAogICAgICAgICAgICB0ZXN0Y3R4ID0gKCBoYXNDVFggKSA/IHRlc3RDYW52YXMuZ2V0Q29udGV4dCgiMmQiKSA6IHt9LAogICAgICAgICAgICBzYWZlSW1hZ2VzID0gW10sCiAgICAgICAgICAgIGZzdHlsZTsKCiAgICAgICAgICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy5zdHlsZS53aWR0aCA9ICghdXNpbmdGbGFzaGNhbnZhcykgPyBvcHRpb25zLndpZHRoIHx8IHpTdGFjay5jdHgud2lkdGggOiBNYXRoLm1pbihmbGFzaE1heFNpemUsIChvcHRpb25zLndpZHRoIHx8IHpTdGFjay5jdHgud2lkdGgpICk7CiAgICAgICAgICAgIGNhbnZhcy5oZWlnaHQgPSBjYW52YXMuc3R5bGUuaGVpZ2h0ID0gKCF1c2luZ0ZsYXNoY2FudmFzKSA/IG9wdGlvbnMuaGVpZ2h0IHx8IHpTdGFjay5jdHguaGVpZ2h0IDogTWF0aC5taW4oZmxhc2hNYXhTaXplLCAob3B0aW9ucy5oZWlnaHQgfHwgelN0YWNrLmN0eC5oZWlnaHQpICk7CgogICAgICAgICAgICBmc3R5bGUgPSBjdHguZmlsbFN0eWxlOwogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gelN0YWNrLmJhY2tncm91bmRDb2xvcjsKICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7CiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBmc3R5bGU7CgogICAgICAgICAgICBpZiAoIG9wdGlvbnMuc3ZnUmVuZGVyaW5nICYmIHpTdGFjay5zdmdSZW5kZXIgIT09IHVuZGVmaW5lZCApIHsKICAgICAgICAgICAgICAgIC8vIFRPRE86IGVuYWJsZSBhc3luYyByZW5kZXJpbmcgdG8gc3VwcG9ydCB0aGlzCiAgICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlKCB6U3RhY2suc3ZnUmVuZGVyLCAwLCAwICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3IgKCBpID0gMCwgcXVldWVMZW4gPSBxdWV1ZS5sZW5ndGg7IGkgPCBxdWV1ZUxlbjsgaSs9MSApIHsKCiAgICAgICAgICAgICAgICAgICAgc3RvcmFnZUNvbnRleHQgPSBxdWV1ZS5zcGxpY2UoMCwgMSlbMF07CiAgICAgICAgICAgICAgICAgICAgc3RvcmFnZUNvbnRleHQuY2FudmFzUG9zaXRpb24gPSBzdG9yYWdlQ29udGV4dC5jYW52YXNQb3NpdGlvbiB8fCB7fTsKCiAgICAgICAgICAgICAgICAgICAgLy90aGlzLmNhbnZhc1JlbmRlckNvbnRleHQoc3RvcmFnZUNvbnRleHQscGFyZW50Y3R4KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gc2V0IGNvbW1vbiBzZXR0aW5ncyBmb3IgY2FudmFzCiAgICAgICAgICAgICAgICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICJib3R0b20iOwoKICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcmFnZUNvbnRleHQuY2xpcCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coc3RvcmFnZUNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICBjdHgucmVjdChzdG9yYWdlQ29udGV4dC5jbGlwLmxlZnQsIHN0b3JhZ2VDb250ZXh0LmNsaXAudG9wLCBzdG9yYWdlQ29udGV4dC5jbGlwLndpZHRoLCBzdG9yYWdlQ29udGV4dC5jbGlwLmhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5jbGlwKCk7CgogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlKXsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoYSA9IDAsIHN0b3JhZ2VMZW4gPSBzdG9yYWdlQ29udGV4dC5jdHguc3RvcmFnZS5sZW5ndGg7IGEgPCBzdG9yYWdlTGVuOyBhKz0xKXsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJJdGVtID0gc3RvcmFnZUNvbnRleHQuY3R4LnN0b3JhZ2VbYV07CgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaChyZW5kZXJJdGVtLnR5cGUpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInZhcmlhYmxlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4W3JlbmRlckl0ZW0ubmFtZV0gPSByZW5kZXJJdGVtWydhcmd1bWVudHMnXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiZnVuY3Rpb24iOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVuZGVySXRlbS5uYW1lID09PSAiZmlsbFJlY3QiKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF1c2luZ0ZsYXNoY2FudmFzIHx8IHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzBdICsgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bMl0gPCBmbGFzaE1heFNpemUgICYmIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzFdICsgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bM10gPCBmbGFzaE1heFNpemUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QuYXBwbHkoIGN0eCwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ10gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZW5kZXJJdGVtLm5hbWUgPT09ICJkcmF3U2hhcGUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICggZnVuY3Rpb24oIGFyZ3MgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpLCBsZW4gPSBhcmdzLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4WyBhcmdzWyBpIF0ubmFtZSBdLmFwcGx5KCBjdHgsIGFyZ3NbIGkgXVsnYXJndW1lbnRzJ10gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5maWxsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSggcmVuZGVySXRlbVsnYXJndW1lbnRzJ10gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlbmRlckl0ZW0ubmFtZSA9PT0gImZpbGxUZXh0IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF1c2luZ0ZsYXNoY2FudmFzIHx8IHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzFdIDwgZmxhc2hNYXhTaXplICAmJiByZW5kZXJJdGVtWydhcmd1bWVudHMnXVsyXSA8IGZsYXNoTWF4U2l6ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5maWxsVGV4dC5hcHBseSggY3R4LCByZW5kZXJJdGVtWydhcmd1bWVudHMnXSApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlbmRlckl0ZW0ubmFtZSA9PT0gImRyYXdJbWFnZSIpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVuZGVySXRlbVsnYXJndW1lbnRzJ11bOF0gPiAwICYmIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzddKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIGhhc0NUWCAmJiBvcHRpb25zLnRhaW50VGVzdCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCBzYWZlSW1hZ2VzLmluZGV4T2YoIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWyAwIF0uc3JjICkgPT09IC0xICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGN0eC5kcmF3SW1hZ2UoIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWyAwIF0sIDAsIDAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGN0eC5nZXRJbWFnZURhdGEoIDAsIDAsIDEsIDEgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlc3RDYW52YXMgPSBkb2MuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVzdGN0eCA9IHRlc3RDYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlSW1hZ2VzLnB1c2goIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWyAwIF0uc3JjICk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UuYXBwbHkoIGN0eCwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ10gKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LmNsaXApewogICAgICAgICAgICAgICAgICAgICAgICBjdHgucmVzdG9yZSgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGgyY2xvZygiaHRtbDJjYW52YXM6IFJlbmRlcmVyOiBDYW52YXMgcmVuZGVyZXIgZG9uZSAtIHJldHVybmluZyBjYW52YXMgb2JqIik7CgogICAgICAgICAgICBxdWV1ZUxlbiA9IG9wdGlvbnMuZWxlbWVudHMubGVuZ3RoOwoKICAgICAgICAgICAgaWYgKHF1ZXVlTGVuID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZWxlbWVudHNbIDAgXSA9PT0gIm9iamVjdCIgJiYgb3B0aW9ucy5lbGVtZW50c1sgMCBdLm5vZGVOYW1lICE9PSAiQk9EWSIgJiYgdXNpbmdGbGFzaGNhbnZhcyA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICAvLyBjcm9wIGltYWdlIHRvIHRoZSBib3VuZHMgb2Ygc2VsZWN0ZWQgKHNpbmdsZSkgZWxlbWVudAogICAgICAgICAgICAgICAgICAgIGJvdW5kcyA9IF9odG1sMmNhbnZhcy5VdGlsLkJvdW5kcyggb3B0aW9ucy5lbGVtZW50c1sgMCBdICk7CiAgICAgICAgICAgICAgICAgICAgbmV3Q2FudmFzID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgICAgICAgICAgICAgIG5ld0NhbnZhcy53aWR0aCA9IGJvdW5kcy53aWR0aDsKICAgICAgICAgICAgICAgICAgICBuZXdDYW52YXMuaGVpZ2h0ID0gYm91bmRzLmhlaWdodDsKICAgICAgICAgICAgICAgICAgICBjdHggPSBuZXdDYW52YXMuZ2V0Q29udGV4dCgiMmQiKTsKCiAgICAgICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZSggY2FudmFzLCBib3VuZHMubGVmdCwgYm91bmRzLnRvcCwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0LCAwLCAwLCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQgKTsKICAgICAgICAgICAgICAgICAgICBjYW52YXMgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXdDYW52YXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gLyplbHNlIHsKICAgICAgICAvLyBUT0RPIGNsaXAgYW5kIHJlc2l6ZSBtdWx0aXBsZSBlbGVtZW50cwoKICAgICAgICAgICAgZm9yICggaSA9IDA7IGkgPCBxdWV1ZUxlbjsgaSs9MSApIHsKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmVsZW1lbnRzWyBpIF0gaW5zdGFuY2VvZiBFbGVtZW50KSB7CgogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAqLwoKCgogICAgICAgICAgICByZXR1cm4gY2FudmFzOwogICAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIG1ldGhvZHM7Cgp9OwoKLyoKICBodG1sMmNhbnZhcyB2MC4zNCA8aHR0cDovL2h0bWwyY2FudmFzLmhlcnR6ZW4uY29tPgogIENvcHlyaWdodCAoYykgMjAxMSBOaWtsYXMgdm9uIEhlcnR6ZW4uIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAgaHR0cDovL3d3dy50d2l0dGVyLmNvbS9uaWtsYXN2aAoKICBSZWxlYXNlZCB1bmRlciBNSVQgTGljZW5zZQoqLwoKCi8vIFdBUk5JTkcgVEhJUyBmaWxlIGlzIG91dGRhdGVkLCBhbmQgaGFzbid0IGJlZW4gdGVzdGVkIGluIHF1aXRlIGEgd2hpbGUKCl9odG1sMmNhbnZhcy5SZW5kZXJlci5TVkcgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICB2YXIgZG9jID0gZG9jdW1lbnQsCiAgICBzdmdOUyA9ICJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIsCiAgICBzdmcgPSBkb2MuY3JlYXRlRWxlbWVudE5TKHN2Z05TLCAic3ZnIiksCiAgICB4bGlua05TID0gImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLAogICAgZGVmcyA9IGRvYy5jcmVhdGVFbGVtZW50TlMoc3ZnTlMsICJkZWZzIiksCiAgICBpLAogICAgYSwKICAgIHF1ZXVlTGVuLAogICAgc3RvcmFnZUxlbiwKICAgIHN0b3JhZ2VDb250ZXh0LAogICAgcmVuZGVySXRlbSwKICAgIGVsLAogICAgc2V0dGluZ3MgPSB7fSwKICAgIHRleHQsCiAgICBmb250U3R5bGUsCiAgICBjbGlwSWQgPSAwLAogICAgbWV0aG9kczsKCgogICAgbWV0aG9kcyA9IHsKICAgICAgICBfY3JlYXRlOiBmdW5jdGlvbiggelN0YWNrLCBvcHRpb25zLCBkb2MsIHF1ZXVlLCBfaHRtbDJjYW52YXMgKSB7CiAgICAgICAgICAgIHN2Zy5zZXRBdHRyaWJ1dGUoInZlcnNpb24iLCAiMS4xIik7CiAgICAgICAgICAgIHN2Zy5zZXRBdHRyaWJ1dGUoImJhc2VQcm9maWxlIiwgImZ1bGwiKTsKCiAgICAgICAgICAgIHN2Zy5zZXRBdHRyaWJ1dGUoInZpZXdCb3giLCAiMCAwICIgKyBNYXRoLm1heCh6U3RhY2suY3R4LndpZHRoLCBvcHRpb25zLndpZHRoKSArICIgIiArIE1hdGgubWF4KHpTdGFjay5jdHguaGVpZ2h0LCBvcHRpb25zLmhlaWdodCkpOwogICAgICAgICAgICBzdmcuc2V0QXR0cmlidXRlKCJ3aWR0aCIsIE1hdGgubWF4KHpTdGFjay5jdHgud2lkdGgsIG9wdGlvbnMud2lkdGgpICsgInB4Iik7CiAgICAgICAgICAgIHN2Zy5zZXRBdHRyaWJ1dGUoImhlaWdodCIsIE1hdGgubWF4KHpTdGFjay5jdHguaGVpZ2h0LCBvcHRpb25zLmhlaWdodCkgKyAicHgiKTsKICAgICAgICAgICAgc3ZnLnNldEF0dHJpYnV0ZSgicHJlc2VydmVBc3BlY3RSYXRpbyIsICJub25lIik7CiAgICAgICAgICAgIHN2Zy5hcHBlbmRDaGlsZChkZWZzKTsKCgoKICAgICAgICAgICAgZm9yIChpID0gMCwgcXVldWVMZW4gPSBxdWV1ZS5sZW5ndGg7IGkgPCBxdWV1ZUxlbjsgaSs9MSl7CgogICAgICAgICAgICAgICAgc3RvcmFnZUNvbnRleHQgPSBxdWV1ZS5zcGxpY2UoMCwgMSlbMF07CiAgICAgICAgICAgICAgICBzdG9yYWdlQ29udGV4dC5jYW52YXNQb3NpdGlvbiA9IHN0b3JhZ2VDb250ZXh0LmNhbnZhc1Bvc2l0aW9uIHx8IHt9OwoKICAgICAgICAgICAgICAgIC8vdGhpcy5jYW52YXNSZW5kZXJDb250ZXh0KHN0b3JhZ2VDb250ZXh0LHBhcmVudGN0eCk7CgoKICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgIGlmIChzdG9yYWdlQ29udGV4dC5jbGlwKXsKICAgICAgICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhzdG9yYWdlQ29udGV4dCk7CiAgICAgICAgICAgICAgICBjdHgucmVjdChzdG9yYWdlQ29udGV4dC5jbGlwLmxlZnQsIHN0b3JhZ2VDb250ZXh0LmNsaXAudG9wLCBzdG9yYWdlQ29udGV4dC5jbGlwLndpZHRoLCBzdG9yYWdlQ29udGV4dC5jbGlwLmhlaWdodCk7CiAgICAgICAgICAgICAgICBjdHguY2xpcCgpOwoKICAgICAgICAgICAgfSovCgogICAgICAgICAgICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlKXsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChhID0gMCwgc3RvcmFnZUxlbiA9IHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlLmxlbmd0aDsgYSA8IHN0b3JhZ2VMZW47IGErPTEpewoKICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVySXRlbSA9IHN0b3JhZ2VDb250ZXh0LmN0eC5zdG9yYWdlW2FdOwoKCgogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2gocmVuZGVySXRlbS50eXBlKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInZhcmlhYmxlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXR0aW5nc1tyZW5kZXJJdGVtLm5hbWVdID0gcmVuZGVySXRlbVsnYXJndW1lbnRzJ107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJmdW5jdGlvbiI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlckl0ZW0ubmFtZSA9PT0gImZpbGxSZWN0IikgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwgPSBkb2MuY3JlYXRlRWxlbWVudE5TKHN2Z05TLCAicmVjdCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGUoIngiLCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVswXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgieSIsIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJ3aWR0aCIsIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJoZWlnaHQiLCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVszXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgiZmlsbCIsICBzZXR0aW5ncy5maWxsU3R5bGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdmcuYXBwZW5kQ2hpbGQoZWwpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYocmVuZGVySXRlbS5uYW1lID09PSAiZmlsbFRleHQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsID0gZG9jLmNyZWF0ZUVsZW1lbnROUyhzdmdOUywgInRleHQiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvbnRTdHlsZSA9IHNldHRpbmdzLmZvbnQuc3BsaXQoIiAiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlLmZvbnRWYXJpYW50ID0gZm9udFN0eWxlLnNwbGljZSgwLCAxKVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGUuZm9udFdlaWdodCA9IGZvbnRTdHlsZS5zcGxpY2UoMCwgMSlbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlLmZvbnRTdHlsZSA9IGZvbnRTdHlsZS5zcGxpY2UoMCwgMSlbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlLmZvbnRTaXplID0gZm9udFN0eWxlLnNwbGljZSgwLCAxKVswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgieCIsIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzFdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJ5IiwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bMl0gLSAocGFyc2VJbnQoZWwuc3R5bGUuZm9udFNpemUsIDEwKSArIDMpKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgiZmlsbCIsIHNldHRpbmdzLmZpbGxTdHlsZSk7CgoKCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPIGdldCBwcm9wZXIgYmFzZWxpbmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGUuZG9taW5hbnRCYXNlbGluZSA9ICJ0ZXh0LWJlZm9yZS1lZGdlIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGUuZm9udEZhbWlseSA9IGZvbnRTdHlsZS5qb2luKCIgIik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gZG9jLmNyZWF0ZVRleHROb2RlKHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuYXBwZW5kQ2hpbGQodGV4dCk7CgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ZnLmFwcGVuZENoaWxkKGVsKTsKCgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYocmVuZGVySXRlbS5uYW1lID09PSAiZHJhd0ltYWdlIikgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzhdID4gMCAmJiByZW5kZXJJdGVtWydhcmd1bWVudHMnXVs3XSl7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyBjaGVjayB3aGV0aGVyIGV2ZW4gYW55IGNsaXBwaW5nIGlzIG5lY2Vzc2FyeSBmb3IgdGhpcyBwYXJ0aWN1bGFyIGltYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbCA9IGRvYy5jcmVhdGVFbGVtZW50TlMoc3ZnTlMsICJjbGlwUGF0aCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJpZCIsICJjbGlwSWQiICsgY2xpcElkKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gZG9jLmNyZWF0ZUVsZW1lbnROUyhzdmdOUywgInJlY3QiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQuc2V0QXR0cmlidXRlKCJ4IiwgIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzVdICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnNldEF0dHJpYnV0ZSgieSIsIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzZdKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnNldEF0dHJpYnV0ZSgid2lkdGgiLCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVszXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0LnNldEF0dHJpYnV0ZSgiaGVpZ2h0IiwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bNF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuYXBwZW5kQ2hpbGQodGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZzLmFwcGVuZENoaWxkKGVsKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbCA9IGRvYy5jcmVhdGVFbGVtZW50TlMoc3ZnTlMsICJpbWFnZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlTlMoeGxpbmtOUywgInhsaW5rOmhyZWYiLCByZW5kZXJJdGVtWydhcmd1bWVudHMnXVswXS5zcmMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJ3aWR0aCIsIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzddKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgiaGVpZ2h0IiwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bOF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJ4IiwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bNV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJ5IiwgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bNl0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2V0QXR0cmlidXRlKCJjbGlwLXBhdGgiLCAidXJsKCNjbGlwSWQiICsgY2xpcElkICsgIikiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVsLnNldEF0dHJpYnV0ZSgieGxpbms6aHJlZiIsICk7CgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZSgicHJlc2VydmVBc3BlY3RSYXRpbyIsICJub25lIik7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ZnLmFwcGVuZENoaWxkKGVsKTsKCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xpcElkICs9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJJdGVtWydhcmd1bWVudHMnXVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzFdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bMl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJJdGVtWydhcmd1bWVudHMnXVszXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzRdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bNV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJJdGVtWydhcmd1bWVudHMnXVs2XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckl0ZW1bJ2FyZ3VtZW50cyddWzddLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVySXRlbVsnYXJndW1lbnRzJ11bOF0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKCiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgLyoKICAgICAgICAgICAgaWYgKHN0b3JhZ2VDb250ZXh0LmNsaXApewogICAgICAgICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICAgICAgfQogICAgKi8KCgoKICAgICAgICAgICAgfQoKCgoKCgoKCgoKICAgICAgICAgICAgaDJjbG9nKCJodG1sMmNhbnZhczogUmVuZGVyZXI6IFNWRyBSZW5kZXJlciBkb25lIC0gcmV0dXJuaW5nIFNWRyBET00gb2JqIik7CgogICAgICAgICAgICByZXR1cm4gc3ZnOwogICAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIG1ldGhvZHM7CgoKfTsKCndpbmRvdy5odG1sMmNhbnZhcyA9IGh0bWwyY2FudmFzOwp9KHdpbmRvdywgZG9jdW1lbnQpKTsKCg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 00:10:18 GMT",
                    "Content-Length": "107320",
                    "Date": "Fri, 07 Nov 2014 00:10:18 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}